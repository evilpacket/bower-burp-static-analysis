{
    "url": "http://localhost:9999/Polymer/webcomponents.js/src/ShadowCSS/ShadowCSS.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Link manipulation (DOM-based)",
    "issueType": 5246976,
    "severity": "Low",
    "confidence": "Firm",
    "issueBackground": "DOM-based link manipulation vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this to a navigation target within the current page, such as a clickable link or the submission URL of a form. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will modify the target of links within the response. An attacker may be able to leverage this to perform various attacks, including:<ul><li>Causing the user to redirect to an arbitrary external URL, to facilitate a phishing attack.</li><li>Causing the user to submit sensitive form data to a server controlled by the attacker.</li><li>Causing the user to perform an unintended action within the application, by changing the file or query string associated with a link.</li><li>Bypassing browser anti-XSS defenses by injecting on-site links containing XSS exploits, since browser anti-XSS defenses typically do not operate on on-site links.</li></ul>",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based link manipulation vulnerabilities is not to dynamically set the target URLs of links or forms using data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing an arbitrary URL as a link target. In general, this is best achieved by using a whitelist of URLs that are permitted link targets, and strictly validating the target against this list before setting the link target.",
    "issueDetail": "The application may be vulnerable to DOM-based link manipulation. Data is read from <b>the 'baseURI' property of a DOM element</b> and written to <b>the 'href' property of a DOM element</b> via the following statement:<ul><li>base.href = document.baseURI;</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/Polymer/webcomponents.js/src/ShadowCSS/ShadowCSS.js",
                "path": "/Polymer/webcomponents.js/src/ShadowCSS/ShadowCSS.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9Qb2x5bWVyL3dlYmNvbXBvbmVudHMuanMvc3JjL1NoYWRvd0NTUy9TaGFkb3dDU1MuanMgSFRUUC8xLjENCkhvc3Q6IGxvY2FsaG9zdDo5OTk5DQoNCg==",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogMjYwMjQNCkFjY2VwdC1SYW5nZXM6IGJ5dGVzDQpDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2phdmFzY3JpcHQNCkRhdGU6IFN1biwgMDkgTm92IDIwMTQgMDI6MjE6MTMgR01UDQpMYXN0LU1vZGlmaWVkOiBTdW4sIDA5IE5vdiAyMDE0IDAyOjIxOjEzIEdNVA0KDQovKgogKiBDb3B5cmlnaHQgKGMpIDIwMTQgVGhlIFBvbHltZXIgUHJvamVjdCBBdXRob3JzLiBBbGwgcmlnaHRzIHJlc2VydmVkLgogKiBUaGlzIGNvZGUgbWF5IG9ubHkgYmUgdXNlZCB1bmRlciB0aGUgQlNEIHN0eWxlIGxpY2Vuc2UgZm91bmQgYXQgaHR0cDovL3BvbHltZXIuZ2l0aHViLmlvL0xJQ0VOU0UudHh0CiAqIFRoZSBjb21wbGV0ZSBzZXQgb2YgYXV0aG9ycyBtYXkgYmUgZm91bmQgYXQgaHR0cDovL3BvbHltZXIuZ2l0aHViLmlvL0FVVEhPUlMudHh0CiAqIFRoZSBjb21wbGV0ZSBzZXQgb2YgY29udHJpYnV0b3JzIG1heSBiZSBmb3VuZCBhdCBodHRwOi8vcG9seW1lci5naXRodWIuaW8vQ09OVFJJQlVUT1JTLnR4dAogKiBDb2RlIGRpc3RyaWJ1dGVkIGJ5IEdvb2dsZSBhcyBwYXJ0IG9mIHRoZSBwb2x5bWVyIHByb2plY3QgaXMgYWxzbwogKiBzdWJqZWN0IHRvIGFuIGFkZGl0aW9uYWwgSVAgcmlnaHRzIGdyYW50IGZvdW5kIGF0IGh0dHA6Ly9wb2x5bWVyLmdpdGh1Yi5pby9QQVRFTlRTLnR4dAogKi8KCi8qCiAgVGhpcyBpcyBhIGxpbWl0ZWQgc2hpbSBmb3IgU2hhZG93RE9NIGNzcyBzdHlsaW5nLgogIGh0dHBzOi8vZHZjcy53My5vcmcvaGcvd2ViY29tcG9uZW50cy9yYXctZmlsZS90aXAvc3BlYy9zaGFkb3cvaW5kZXguaHRtbCNzdHlsZXMKICAKICBUaGUgaW50ZW50aW9uIGhlcmUgaXMgdG8gc3VwcG9ydCBvbmx5IHRoZSBzdHlsaW5nIGZlYXR1cmVzIHdoaWNoIGNhbiBiZSAKICByZWxhdGl2ZWx5IHNpbXBseSBpbXBsZW1lbnRlZC4gVGhlIGdvYWwgaXMgdG8gYWxsb3cgdXNlcnMgdG8gYXZvaWQgdGhlIAogIG1vc3Qgb2J2aW91cyBwaXRmYWxscyBhbmQgZG8gc28gd2l0aG91dCBjb21wcm9taXNpbmcgcGVyZm9ybWFuY2Ugc2lnbmlmaWNhbnRseS4gCiAgRm9yIFNoYWRvd0RPTSBzdHlsaW5nIHRoYXQncyBub3QgY292ZXJlZCBoZXJlLCBhIHNldCBvZiBiZXN0IHByYWN0aWNlcwogIGNhbiBiZSBwcm92aWRlZCB0aGF0IHNob3VsZCBhbGxvdyB1c2VycyB0byBhY2NvbXBsaXNoIG1vcmUgY29tcGxleCBzdHlsaW5nLgoKICBUaGUgZm9sbG93aW5nIGlzIGEgbGlzdCBvZiBzcGVjaWZpYyBTaGFkb3dET00gc3R5bGluZyBmZWF0dXJlcyBhbmQgYSBicmllZgogIGRpc2N1c3Npb24gb2YgdGhlIGFwcHJvYWNoIHVzZWQgdG8gc2hpbS4KCiAgU2hpbW1lZCBmZWF0dXJlczoKCiAgKiA6aG9zdCwgOmhvc3QtY29udGV4dDogU2hhZG93RE9NIGFsbG93cyBzdHlsaW5nIG9mIHRoZSBzaGFkb3dSb290J3MgaG9zdAogIGVsZW1lbnQgdXNpbmcgdGhlIDpob3N0IHJ1bGUuIFRvIHNoaW0gdGhpcyBmZWF0dXJlLCB0aGUgOmhvc3Qgc3R5bGVzIGFyZSAKICByZWZvcm1hdHRlZCBhbmQgcHJlZml4ZWQgd2l0aCBhIGdpdmVuIHNjb3BlIG5hbWUgYW5kIHByb21vdGVkIHRvIGEgCiAgZG9jdW1lbnQgbGV2ZWwgc3R5bGVzaGVldC4KICBGb3IgZXhhbXBsZSwgZ2l2ZW4gYSBzY29wZSBuYW1lIG9mIC5mb28sIGEgcnVsZSBsaWtlIHRoaXM6CiAgCiAgICA6aG9zdCB7CiAgICAgICAgYmFja2dyb3VuZDogcmVkOwogICAgICB9CiAgICB9CiAgCiAgYmVjb21lczoKICAKICAgIC5mb28gewogICAgICBiYWNrZ3JvdW5kOiByZWQ7CiAgICB9CiAgCiAgKiBlbmNhcHN1bHRpb246IFN0eWxlcyBkZWZpbmVkIHdpdGhpbiBTaGFkb3dET00sIGFwcGx5IG9ubHkgdG8gCiAgZG9tIGluc2lkZSB0aGUgU2hhZG93RE9NLiBQb2x5bWVyIHVzZXMgb25lIG9mIHR3byB0ZWNobmlxdWVzIHRvIGltbGVtZW50CiAgdGhpcyBmZWF0dXJlLgogIAogIEJ5IGRlZmF1bHQsIHJ1bGVzIGFyZSBwcmVmaXhlZCB3aXRoIHRoZSBob3N0IGVsZW1lbnQgdGFnIG5hbWUgCiAgYXMgYSBkZXNjZW5kYW50IHNlbGVjdG9yLiBUaGlzIGVuc3VyZXMgc3R5bGluZyBkb2VzIG5vdCBsZWFrIG91dCBvZiB0aGUgJ3RvcCcKICBvZiB0aGUgZWxlbWVudCdzIFNoYWRvd0RPTS4gRm9yIGV4YW1wbGUsCgogIGRpdiB7CiAgICAgIGZvbnQtd2VpZ2h0OiBib2xkOwogICAgfQogIAogIGJlY29tZXM6CgogIHgtZm9vIGRpdiB7CiAgICAgIGZvbnQtd2VpZ2h0OiBib2xkOwogICAgfQogIAogIGJlY29tZXM6CgoKICBBbHRlcm5hdGl2ZWx5LCBpZiBXZWJDb21wb25lbnRzLlNoYWRvd0NTUy5zdHJpY3RTdHlsaW5nIGlzIHNldCB0byB0cnVlIHRoZW4gCiAgc2VsZWN0b3JzIGFyZSBzY29wZWQgYnkgYWRkaW5nIGFuIGF0dHJpYnV0ZSBzZWxlY3RvciBzdWZmaXggdG8gZWFjaAogIHNpbXBsZSBzZWxlY3RvciB0aGF0IGNvbnRhaW5zIHRoZSBob3N0IGVsZW1lbnQgdGFnIG5hbWUuIEVhY2ggZWxlbWVudCAKICBpbiB0aGUgZWxlbWVudCdzIFNoYWRvd0RPTSB0ZW1wbGF0ZSBpcyBhbHNvIGdpdmVuIHRoZSBzY29wZSBhdHRyaWJ1dGUuIAogIFRodXMsIHRoZXNlIHJ1bGVzIG1hdGNoIG9ubHkgZWxlbWVudHMgdGhhdCBoYXZlIHRoZSBzY29wZSBhdHRyaWJ1dGUuCiAgRm9yIGV4YW1wbGUsIGdpdmVuIGEgc2NvcGUgbmFtZSBvZiB4LWZvbywgYSBydWxlIGxpa2UgdGhpczoKICAKICAgIGRpdiB7CiAgICAgIGZvbnQtd2VpZ2h0OiBib2xkOwogICAgfQogIAogIGJlY29tZXM6CiAgCiAgICBkaXZbeC1mb29dIHsKICAgICAgZm9udC13ZWlnaHQ6IGJvbGQ7CiAgICB9CgogIE5vdGUgdGhhdCBlbGVtZW50cyB0aGF0IGFyZSBkeW5hbWljYWxseSBhZGRlZCB0byBhIHNjb3BlIG11c3QgaGF2ZSB0aGUgc2NvcGUKICBzZWxlY3RvciBhZGRlZCB0byB0aGVtIG1hbnVhbGx5LgoKICAqIHVwcGVyL2xvd2VyIGJvdW5kIGVuY2Fwc3VsYXRpb246IFN0eWxlcyB3aGljaCBhcmUgZGVmaW5lZCBvdXRzaWRlIGEKICBzaGFkb3dSb290IHNob3VsZCBub3QgY3Jvc3MgdGhlIFNoYWRvd0RPTSBib3VuZGFyeSBhbmQgc2hvdWxkIG5vdCBhcHBseQogIGluc2lkZSBhIHNoYWRvd1Jvb3QuCgogIFRoaXMgc3R5bGluZyBiZWhhdmlvciBpcyBub3QgZW11bGF0ZWQuIFNvbWUgcG9zc2libGUgd2F5cyB0byBkbyB0aGlzIHRoYXQgCiAgd2VyZSByZWplY3RlZCBkdWUgdG8gY29tcGxleGl0eSBhbmQvb3IgcGVyZm9ybWFuY2UgY29uY2VybnMgaW5jbHVkZTogKDEpIHJlc2V0CiAgZXZlcnkgcG9zc2libGUgcHJvcGVydHkgZm9yIGV2ZXJ5IHBvc3NpYmxlIHNlbGVjdG9yIGZvciBhIGdpdmVuIHNjb3BlIG5hbWU7CiAgKDIpIHJlLWltcGxlbWVudCBjc3MgaW4gamF2YXNjcmlwdC4KICAKICBBcyBhbiBhbHRlcm5hdGl2ZSwgdXNlcnMgc2hvdWxkIG1ha2Ugc3VyZSB0byB1c2Ugc2VsZWN0b3JzCiAgc3BlY2lmaWMgdG8gdGhlIHNjb3BlIGluIHdoaWNoIHRoZXkgYXJlIHdvcmtpbmcuCiAgCiAgKiA6OmRpc3RyaWJ1dGVkOiBUaGlzIGJlaGF2aW9yIGlzIG5vdCBlbXVsYXRlZC4gSXQncyBvZnRlbiBub3QgbmVjZXNzYXJ5CiAgdG8gc3R5bGUgdGhlIGNvbnRlbnRzIG9mIGEgc3BlY2lmaWMgaW5zZXJ0aW9uIHBvaW50IGFuZCBpbnN0ZWFkLCBkZXNjZW5kYW50cwogIG9mIHRoZSBob3N0IGVsZW1lbnQgY2FuIGJlIHN0eWxlZCBzZWxlY3RpdmVseS4gVXNlcnMgY2FuIGFsc28gY3JlYXRlIGFuIAogIGV4dHJhIG5vZGUgYXJvdW5kIGFuIGluc2VydGlvbiBwb2ludCBhbmQgc3R5bGUgdGhhdCBub2RlJ3MgY29udGVudHMKICB2aWEgZGVzY2VuZGVudCBzZWxlY3RvcnMuIEZvciBleGFtcGxlLCB3aXRoIGEgc2hhZG93Um9vdCBsaWtlIHRoaXM6CiAgCiAgICA8c3R5bGU+CiAgICAgIDo6Y29udGVudChkaXYpIHsKICAgICAgICBiYWNrZ3JvdW5kOiByZWQ7CiAgICAgIH0KICAgIDwvc3R5bGU+CiAgICA8Y29udGVudD48L2NvbnRlbnQ+CiAgCiAgY291bGQgYmVjb21lOgogIAogICAgPHN0eWxlPgogICAgICAvICpAcG9seWZpbGwgLmNvbnRlbnQtY29udGFpbmVyIGRpdiAqIC8gCiAgICAgIDo6Y29udGVudChkaXYpIHsKICAgICAgICBiYWNrZ3JvdW5kOiByZWQ7CiAgICAgIH0KICAgIDwvc3R5bGU+CiAgICA8ZGl2IGNsYXNzPSJjb250ZW50LWNvbnRhaW5lciI+CiAgICAgIDxjb250ZW50PjwvY29udGVudD4KICAgIDwvZGl2PgogIAogIE5vdGUgdGhlIHVzZSBvZiBAcG9seWZpbGwgaW4gdGhlIGNvbW1lbnQgYWJvdmUgYSBTaGFkb3dET00gc3BlY2lmaWMgc3R5bGUKICBkZWNsYXJhdGlvbi4gVGhpcyBpcyBhIGRpcmVjdGl2ZSB0byB0aGUgc3R5bGluZyBzaGltIHRvIHVzZSB0aGUgc2VsZWN0b3IgCiAgaW4gY29tbWVudHMgaW4gbGlldSBvZiB0aGUgbmV4dCBzZWxlY3RvciB3aGVuIHJ1bm5pbmcgdW5kZXIgcG9seWZpbGwuCiovCihmdW5jdGlvbihzY29wZSkgewoKdmFyIFNoYWRvd0NTUyA9IHsKICBzdHJpY3RTdHlsaW5nOiBmYWxzZSwKICByZWdpc3RyeToge30sCiAgLy8gU2hpbSBzdHlsZXMgZm9yIGEgZ2l2ZW4gcm9vdCBhc3NvY2lhdGVkIHdpdGggYSBuYW1lIGFuZCBleHRlbmRzTmFtZQogIC8vIDEuIGNhY2hlIHJvb3Qgc3R5bGVzIGJ5IG5hbWUKICAvLyAyLiBvcHRpb25hbGx5IHRhZyByb290IG5vZGVzIHdpdGggc2NvcGUgbmFtZQogIC8vIDMuIHNoaW0gcG9seWZpbGwgZGlyZWN0aXZlcyAvKiBAcG9seWZpbGwgKi8gYW5kIC8qIEBwb2x5ZmlsbC1ydWxlICovCiAgLy8gNC4gc2hpbSA6aG9zdCBhbmQgc2NvcGluZwogIHNoaW1TdHlsaW5nOiBmdW5jdGlvbihyb290LCBuYW1lLCBleHRlbmRzTmFtZSkgewogICAgdmFyIHNjb3BlU3R5bGVzID0gdGhpcy5wcmVwYXJlUm9vdChyb290LCBuYW1lLCBleHRlbmRzTmFtZSk7CiAgICB2YXIgdHlwZUV4dGVuc2lvbiA9IHRoaXMuaXNUeXBlRXh0ZW5zaW9uKGV4dGVuZHNOYW1lKTsKICAgIHZhciBzY29wZVNlbGVjdG9yID0gdGhpcy5tYWtlU2NvcGVTZWxlY3RvcihuYW1lLCB0eXBlRXh0ZW5zaW9uKTsKICAgIC8vIHVzZSBjYWNoaW5nIHRvIG1ha2Ugd29ya2luZyB3aXRoIHN0eWxlcyBub2RlcyBlYXNpZXIgYW5kIHRvIGZhY2lsaXRhdGUKICAgIC8vIGxvb2t1cCBvZiBleHRlbmRlZQogICAgdmFyIGNzc1RleHQgPSBzdHlsZXNUb0Nzc1RleHQoc2NvcGVTdHlsZXMsIHRydWUpOwogICAgY3NzVGV4dCA9IHRoaXMuc2NvcGVDc3NUZXh0KGNzc1RleHQsIHNjb3BlU2VsZWN0b3IpOwogICAgLy8gY2FjaGUgc2hpbW1lZCBjc3Mgb24gcm9vdCBmb3IgdXNlciBleHRlbnNpYmlsaXR5CiAgICBpZiAocm9vdCkgewogICAgICByb290LnNoaW1tZWRTdHlsZSA9IGNzc1RleHQ7CiAgICB9CiAgICAvLyBhZGQgc3R5bGUgdG8gZG9jdW1lbnQKICAgIHRoaXMuYWRkQ3NzVG9Eb2N1bWVudChjc3NUZXh0LCBuYW1lKTsKICB9LAogIC8qCiAgKiBTaGltIGEgc3R5bGUgZWxlbWVudCB3aXRoIHRoZSBnaXZlbiBzZWxlY3Rvci4gUmV0dXJucyBjc3NUZXh0IHRoYXQgY2FuCiAgKiBiZSBpbmNsdWRlZCBpbiB0aGUgZG9jdW1lbnQgdmlhIFdlYkNvbXBvbmVudHMuU2hhZG93Q1NTLmFkZENzc1RvRG9jdW1lbnQoY3NzKS4KICAqLwogIHNoaW1TdHlsZTogZnVuY3Rpb24oc3R5bGUsIHNlbGVjdG9yKSB7CiAgICByZXR1cm4gdGhpcy5zaGltQ3NzVGV4dChzdHlsZS50ZXh0Q29udGVudCwgc2VsZWN0b3IpOwogIH0sCiAgLyoKICAqIFNoaW0gc29tZSBjc3NUZXh0IHdpdGggdGhlIGdpdmVuIHNlbGVjdG9yLiBSZXR1cm5zIGNzc1RleHQgdGhhdCBjYW4KICAqIGJlIGluY2x1ZGVkIGluIHRoZSBkb2N1bWVudCB2aWEgV2ViQ29tcG9uZW50cy5TaGFkb3dDU1MuYWRkQ3NzVG9Eb2N1bWVudChjc3MpLgogICovCiAgc2hpbUNzc1RleHQ6IGZ1bmN0aW9uKGNzc1RleHQsIHNlbGVjdG9yKSB7CiAgICBjc3NUZXh0ID0gdGhpcy5pbnNlcnREaXJlY3RpdmVzKGNzc1RleHQpOwogICAgcmV0dXJuIHRoaXMuc2NvcGVDc3NUZXh0KGNzc1RleHQsIHNlbGVjdG9yKTsKICB9LAogIG1ha2VTY29wZVNlbGVjdG9yOiBmdW5jdGlvbihuYW1lLCB0eXBlRXh0ZW5zaW9uKSB7CiAgICBpZiAobmFtZSkgewogICAgICByZXR1cm4gdHlwZUV4dGVuc2lvbiA/ICdbaXM9JyArIG5hbWUgKyAnXScgOiBuYW1lOwogICAgfQogICAgcmV0dXJuICcnOwogIH0sCiAgaXNUeXBlRXh0ZW5zaW9uOiBmdW5jdGlvbihleHRlbmRzTmFtZSkgewogICAgcmV0dXJuIGV4dGVuZHNOYW1lICYmIGV4dGVuZHNOYW1lLmluZGV4T2YoJy0nKSA8IDA7CiAgfSwKICBwcmVwYXJlUm9vdDogZnVuY3Rpb24ocm9vdCwgbmFtZSwgZXh0ZW5kc05hbWUpIHsKICAgIHZhciBkZWYgPSB0aGlzLnJlZ2lzdGVyUm9vdChyb290LCBuYW1lLCBleHRlbmRzTmFtZSk7CiAgICB0aGlzLnJlcGxhY2VUZXh0SW5TdHlsZXMoZGVmLnJvb3RTdHlsZXMsIHRoaXMuaW5zZXJ0RGlyZWN0aXZlcyk7CiAgICAvLyByZW1vdmUgZXhpc3Rpbmcgc3R5bGUgZWxlbWVudHMKICAgIHRoaXMucmVtb3ZlU3R5bGVzKHJvb3QsIGRlZi5yb290U3R5bGVzKTsKICAgIC8vIGFwcGx5IHN0cmljdCBhdHRyCiAgICBpZiAodGhpcy5zdHJpY3RTdHlsaW5nKSB7CiAgICAgIHRoaXMuYXBwbHlTY29wZVRvQ29udGVudChyb290LCBuYW1lKTsKICAgIH0KICAgIHJldHVybiBkZWYuc2NvcGVTdHlsZXM7CiAgfSwKICByZW1vdmVTdHlsZXM6IGZ1bmN0aW9uKHJvb3QsIHN0eWxlcykgewogICAgZm9yICh2YXIgaT0wLCBsPXN0eWxlcy5sZW5ndGgsIHM7IChpPGwpICYmIChzPXN0eWxlc1tpXSk7IGkrKykgewogICAgICBzLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQocyk7CiAgICB9CiAgfSwKICByZWdpc3RlclJvb3Q6IGZ1bmN0aW9uKHJvb3QsIG5hbWUsIGV4dGVuZHNOYW1lKSB7CiAgICB2YXIgZGVmID0gdGhpcy5yZWdpc3RyeVtuYW1lXSA9IHsKICAgICAgcm9vdDogcm9vdCwKICAgICAgbmFtZTogbmFtZSwKICAgICAgZXh0ZW5kc05hbWU6IGV4dGVuZHNOYW1lCiAgICB9CiAgICB2YXIgc3R5bGVzID0gdGhpcy5maW5kU3R5bGVzKHJvb3QpOwogICAgZGVmLnJvb3RTdHlsZXMgPSBzdHlsZXM7CiAgICBkZWYuc2NvcGVTdHlsZXMgPSBkZWYucm9vdFN0eWxlczsKICAgIHZhciBleHRlbmRlZSA9IHRoaXMucmVnaXN0cnlbZGVmLmV4dGVuZHNOYW1lXTsKICAgIGlmIChleHRlbmRlZSkgewogICAgICBkZWYuc2NvcGVTdHlsZXMgPSBleHRlbmRlZS5zY29wZVN0eWxlcy5jb25jYXQoZGVmLnNjb3BlU3R5bGVzKTsKICAgIH0KICAgIHJldHVybiBkZWY7CiAgfSwKICBmaW5kU3R5bGVzOiBmdW5jdGlvbihyb290KSB7CiAgICBpZiAoIXJvb3QpIHsKICAgICAgcmV0dXJuIFtdOwogICAgfQogICAgdmFyIHN0eWxlcyA9IHJvb3QucXVlcnlTZWxlY3RvckFsbCgnc3R5bGUnKTsKICAgIHJldHVybiBBcnJheS5wcm90b3R5cGUuZmlsdGVyLmNhbGwoc3R5bGVzLCBmdW5jdGlvbihzKSB7CiAgICAgIHJldHVybiAhcy5oYXNBdHRyaWJ1dGUoTk9fU0hJTV9BVFRSSUJVVEUpOwogICAgfSk7CiAgfSwKICBhcHBseVNjb3BlVG9Db250ZW50OiBmdW5jdGlvbihyb290LCBuYW1lKSB7CiAgICBpZiAocm9vdCkgewogICAgICAvLyBhZGQgdGhlIG5hbWUgYXR0cmlidXRlIHRvIGVhY2ggbm9kZSBpbiByb290LgogICAgICBBcnJheS5wcm90b3R5cGUuZm9yRWFjaC5jYWxsKHJvb3QucXVlcnlTZWxlY3RvckFsbCgnKicpLAogICAgICAgICAgZnVuY3Rpb24obm9kZSkgewogICAgICAgICAgICBub2RlLnNldEF0dHJpYnV0ZShuYW1lLCAnJyk7CiAgICAgICAgICB9KTsKICAgICAgLy8gYW5kIHRlbXBsYXRlIGNvbnRlbnRzIHRvbwogICAgICBBcnJheS5wcm90b3R5cGUuZm9yRWFjaC5jYWxsKHJvb3QucXVlcnlTZWxlY3RvckFsbCgndGVtcGxhdGUnKSwKICAgICAgICAgIGZ1bmN0aW9uKHRlbXBsYXRlKSB7CiAgICAgICAgICAgIHRoaXMuYXBwbHlTY29wZVRvQ29udGVudCh0ZW1wbGF0ZS5jb250ZW50LCBuYW1lKTsKICAgICAgICAgIH0sCiAgICAgICAgICB0aGlzKTsKICAgIH0KICB9LAogIGluc2VydERpcmVjdGl2ZXM6IGZ1bmN0aW9uKGNzc1RleHQpIHsKICAgIGNzc1RleHQgPSB0aGlzLmluc2VydFBvbHlmaWxsRGlyZWN0aXZlc0luQ3NzVGV4dChjc3NUZXh0KTsKICAgIHJldHVybiB0aGlzLmluc2VydFBvbHlmaWxsUnVsZXNJbkNzc1RleHQoY3NzVGV4dCk7CiAgfSwKICAvKgogICAqIFByb2Nlc3Mgc3R5bGVzIHRvIGNvbnZlcnQgbmF0aXZlIFNoYWRvd0RPTSBydWxlcyB0aGF0IHdpbGwgdHJpcAogICAqIHVwIHRoZSBjc3MgcGFyc2VyOyB3ZSByZWx5IG9uIGRlY29yYXRpbmcgdGhlIHN0eWxlc2hlZXQgd2l0aCBpbmVydCBydWxlcy4KICAgKiAKICAgKiBGb3IgZXhhbXBsZSwgd2UgY29udmVydCB0aGlzIHJ1bGU6CiAgICogCiAgICogcG9seWZpbGwtbmV4dC1zZWxlY3RvciB7IGNvbnRlbnQ6ICc6aG9zdCBtZW51LWl0ZW0nOyB9CiAgICogOjpjb250ZW50IG1lbnUtaXRlbSB7CiAgICogCiAgICogdG8gdGhpczoKICAgKiAKICAgKiBzY29wZU5hbWUgbWVudS1pdGVtIHsKICAgKgogICoqLwogIGluc2VydFBvbHlmaWxsRGlyZWN0aXZlc0luQ3NzVGV4dDogZnVuY3Rpb24oY3NzVGV4dCkgewogICAgLy8gVE9ETyhzb3J2ZWxsKTogcmVtb3ZlIGVpdGhlciBjb250ZW50IG9yIGNvbW1lbnQKICAgIGNzc1RleHQgPSBjc3NUZXh0LnJlcGxhY2UoY3NzQ29tbWVudE5leHRTZWxlY3RvclJlLCBmdW5jdGlvbihtYXRjaCwgcDEpIHsKICAgICAgLy8gcmVtb3ZlIGVuZCBjb21tZW50IGRlbGltaXRlciBhbmQgYWRkIGJsb2NrIHN0YXJ0CiAgICAgIHJldHVybiBwMS5zbGljZSgwLCAtMikgKyAneyc7CiAgICB9KTsKICAgIHJldHVybiBjc3NUZXh0LnJlcGxhY2UoY3NzQ29udGVudE5leHRTZWxlY3RvclJlLCBmdW5jdGlvbihtYXRjaCwgcDEpIHsKICAgICAgcmV0dXJuIHAxICsgJyB7JzsKICAgIH0pOwogIH0sCiAgLyoKICAgKiBQcm9jZXNzIHN0eWxlcyB0byBhZGQgcnVsZXMgd2hpY2ggd2lsbCBvbmx5IGFwcGx5IHVuZGVyIHRoZSBwb2x5ZmlsbAogICAqIAogICAqIEZvciBleGFtcGxlLCB3ZSBjb252ZXJ0IHRoaXMgcnVsZToKICAgKiAKICAgKiBwb2x5ZmlsbC1ydWxlIHsKICAgKiAgIGNvbnRlbnQ6ICc6aG9zdCBtZW51LWl0ZW0nOwogICAqIC4uLgogICAqIH0KICAgKiAKICAgKiB0byB0aGlzOgogICAqIAogICAqIHNjb3BlTmFtZSBtZW51LWl0ZW0gey4uLn0KICAgKgogICoqLwogIGluc2VydFBvbHlmaWxsUnVsZXNJbkNzc1RleHQ6IGZ1bmN0aW9uKGNzc1RleHQpIHsKICAgIC8vIFRPRE8oc29ydmVsbCk6IHJlbW92ZSBlaXRoZXIgY29udGVudCBvciBjb21tZW50CiAgICBjc3NUZXh0ID0gY3NzVGV4dC5yZXBsYWNlKGNzc0NvbW1lbnRSdWxlUmUsIGZ1bmN0aW9uKG1hdGNoLCBwMSkgewogICAgICAvLyByZW1vdmUgZW5kIGNvbW1lbnQgZGVsaW1pdGVyCiAgICAgIHJldHVybiBwMS5zbGljZSgwLCAtMSk7CiAgICB9KTsKICAgIHJldHVybiBjc3NUZXh0LnJlcGxhY2UoY3NzQ29udGVudFJ1bGVSZSwgZnVuY3Rpb24obWF0Y2gsIHAxLCBwMiwgcDMpIHsKICAgICAgdmFyIHJ1bGUgPSBtYXRjaC5yZXBsYWNlKHAxLCAnJykucmVwbGFjZShwMiwgJycpOwogICAgICByZXR1cm4gcDMgKyBydWxlOwogICAgfSk7CiAgfSwKICAvKiBFbnN1cmUgc3R5bGVzIGFyZSBzY29wZWQuIFBzZXVkby1zY29waW5nIHRha2VzIGEgcnVsZSBsaWtlOgogICAqIAogICAqICAuZm9vIHsuLi4gfSAKICAgKiAgCiAgICogIGFuZCBjb252ZXJ0cyB0aGlzIHRvCiAgICogIAogICAqICBzY29wZU5hbWUgLmZvbyB7IC4uLiB9CiAgKi8KICBzY29wZUNzc1RleHQ6IGZ1bmN0aW9uKGNzc1RleHQsIHNjb3BlU2VsZWN0b3IpIHsKICAgIHZhciB1bnNjb3BlZCA9IHRoaXMuZXh0cmFjdFVuc2NvcGVkUnVsZXNGcm9tQ3NzVGV4dChjc3NUZXh0KTsKICAgIGNzc1RleHQgPSB0aGlzLmluc2VydFBvbHlmaWxsSG9zdEluQ3NzVGV4dChjc3NUZXh0KTsKICAgIGNzc1RleHQgPSB0aGlzLmNvbnZlcnRDb2xvbkhvc3QoY3NzVGV4dCk7CiAgICBjc3NUZXh0ID0gdGhpcy5jb252ZXJ0Q29sb25Ib3N0Q29udGV4dChjc3NUZXh0KTsKICAgIGNzc1RleHQgPSB0aGlzLmNvbnZlcnRTaGFkb3dET01TZWxlY3RvcnMoY3NzVGV4dCk7CiAgICBpZiAoc2NvcGVTZWxlY3RvcikgewogICAgICB2YXIgc2VsZiA9IHRoaXMsIGNzc1RleHQ7CiAgICAgIHdpdGhDc3NSdWxlcyhjc3NUZXh0LCBmdW5jdGlvbihydWxlcykgewogICAgICAgIGNzc1RleHQgPSBzZWxmLnNjb3BlUnVsZXMocnVsZXMsIHNjb3BlU2VsZWN0b3IpOwogICAgICB9KTsKCiAgICB9CiAgICBjc3NUZXh0ID0gY3NzVGV4dCArICdcbicgKyB1bnNjb3BlZDsKICAgIHJldHVybiBjc3NUZXh0LnRyaW0oKTsKICB9LAogIC8qCiAgICogUHJvY2VzcyBzdHlsZXMgdG8gYWRkIHJ1bGVzIHdoaWNoIHdpbGwgb25seSBhcHBseSB1bmRlciB0aGUgcG9seWZpbGwKICAgKiBhbmQgZG8gbm90IHByb2Nlc3MgdmlhIENTU09NLiAoQ1NTT00gaXMgZGVzdHJ1Y3RpdmUgdG8gcnVsZXMgb24gcmFyZSAKICAgKiBvY2Nhc2lvbnMsIGUuZy4gLXdlYmtpdC1jYWxjIG9uIFNhZmFyaS4pCiAgICogRm9yIGV4YW1wbGUsIHdlIGNvbnZlcnQgdGhpcyBydWxlOgogICAqIAogICAqIChjb21tZW50IHN0YXJ0KSBAcG9seWZpbGwtdW5zY29wZWQtcnVsZSBtZW51LWl0ZW0geyAKICAgKiAuLi4gfSAoY29tbWVudCBlbmQpCiAgICogCiAgICogdG8gdGhpczoKICAgKiAKICAgKiBtZW51LWl0ZW0gey4uLn0KICAgKgogICoqLwogIGV4dHJhY3RVbnNjb3BlZFJ1bGVzRnJvbUNzc1RleHQ6IGZ1bmN0aW9uKGNzc1RleHQpIHsKICAgIC8vIFRPRE8oc29ydmVsbCk6IHJlbW92ZSBlaXRoZXIgY29udGVudCBvciBjb21tZW50CiAgICB2YXIgciA9ICcnLCBtOwogICAgd2hpbGUgKG0gPSBjc3NDb21tZW50VW5zY29wZWRSdWxlUmUuZXhlYyhjc3NUZXh0KSkgewogICAgICByICs9IG1bMV0uc2xpY2UoMCwgLTEpICsgJ1xuXG4nOwogICAgfQogICAgd2hpbGUgKG0gPSBjc3NDb250ZW50VW5zY29wZWRSdWxlUmUuZXhlYyhjc3NUZXh0KSkgewogICAgICByICs9IG1bMF0ucmVwbGFjZShtWzJdLCAnJykucmVwbGFjZShtWzFdLCBtWzNdKSArICdcblxuJzsKICAgIH0KICAgIHJldHVybiByOwogIH0sCiAgLyoKICAgKiBjb252ZXJ0IGEgcnVsZSBsaWtlIDpob3N0KC5mb28pID4gLmJhciB7IH0KICAgKgogICAqIHRvCiAgICoKICAgKiBzY29wZU5hbWUuZm9vID4gLmJhcgogICovCiAgY29udmVydENvbG9uSG9zdDogZnVuY3Rpb24oY3NzVGV4dCkgewogICAgcmV0dXJuIHRoaXMuY29udmVydENvbG9uUnVsZShjc3NUZXh0LCBjc3NDb2xvbkhvc3RSZSwKICAgICAgICB0aGlzLmNvbG9uSG9zdFBhcnRSZXBsYWNlcik7CiAgfSwKICAvKgogICAqIGNvbnZlcnQgYSBydWxlIGxpa2UgOmhvc3QtY29udGV4dCguZm9vKSA+IC5iYXIgeyB9CiAgICoKICAgKiB0bwogICAqCiAgICogc2NvcGVOYW1lLmZvbyA+IC5iYXIsIC5mb28gc2NvcGVOYW1lID4gLmJhciB7IH0KICAgKiAKICAgKiBhbmQKICAgKgogICAqIDpob3N0LWNvbnRleHQoLmZvbzpob3N0KSAuYmFyIHsgLi4uIH0KICAgKiAKICAgKiB0bwogICAqIAogICAqIHNjb3BlTmFtZS5mb28gLmJhciB7IC4uLiB9CiAgKi8KICBjb252ZXJ0Q29sb25Ib3N0Q29udGV4dDogZnVuY3Rpb24oY3NzVGV4dCkgewogICAgcmV0dXJuIHRoaXMuY29udmVydENvbG9uUnVsZShjc3NUZXh0LCBjc3NDb2xvbkhvc3RDb250ZXh0UmUsCiAgICAgICAgdGhpcy5jb2xvbkhvc3RDb250ZXh0UGFydFJlcGxhY2VyKTsKICB9LAogIGNvbnZlcnRDb2xvblJ1bGU6IGZ1bmN0aW9uKGNzc1RleHQsIHJlZ0V4cCwgcGFydFJlcGxhY2VyKSB7CiAgICAvLyBwMSA9IDpob3N0LCBwMiA9IGNvbnRlbnRzIG9mICgpLCBwMyByZXN0IG9mIHJ1bGUKICAgIHJldHVybiBjc3NUZXh0LnJlcGxhY2UocmVnRXhwLCBmdW5jdGlvbihtLCBwMSwgcDIsIHAzKSB7CiAgICAgIHAxID0gcG9seWZpbGxIb3N0Tm9Db21iaW5hdG9yOwogICAgICBpZiAocDIpIHsKICAgICAgICB2YXIgcGFydHMgPSBwMi5zcGxpdCgnLCcpLCByID0gW107CiAgICAgICAgZm9yICh2YXIgaT0wLCBsPXBhcnRzLmxlbmd0aCwgcDsgKGk8bCkgJiYgKHA9cGFydHNbaV0pOyBpKyspIHsKICAgICAgICAgIHAgPSBwLnRyaW0oKTsKICAgICAgICAgIHIucHVzaChwYXJ0UmVwbGFjZXIocDEsIHAsIHAzKSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByLmpvaW4oJywnKTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gcDEgKyBwMzsKICAgICAgfQogICAgfSk7CiAgfSwKICBjb2xvbkhvc3RDb250ZXh0UGFydFJlcGxhY2VyOiBmdW5jdGlvbihob3N0LCBwYXJ0LCBzdWZmaXgpIHsKICAgIGlmIChwYXJ0Lm1hdGNoKHBvbHlmaWxsSG9zdCkpIHsKICAgICAgcmV0dXJuIHRoaXMuY29sb25Ib3N0UGFydFJlcGxhY2VyKGhvc3QsIHBhcnQsIHN1ZmZpeCk7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gaG9zdCArIHBhcnQgKyBzdWZmaXggKyAnLCAnICsgcGFydCArICcgJyArIGhvc3QgKyBzdWZmaXg7CiAgICB9CiAgfSwKICBjb2xvbkhvc3RQYXJ0UmVwbGFjZXI6IGZ1bmN0aW9uKGhvc3QsIHBhcnQsIHN1ZmZpeCkgewogICAgcmV0dXJuIGhvc3QgKyBwYXJ0LnJlcGxhY2UocG9seWZpbGxIb3N0LCAnJykgKyBzdWZmaXg7CiAgfSwKICAvKgogICAqIENvbnZlcnQgY29tYmluYXRvcnMgbGlrZSA6OnNoYWRvdyBhbmQgcHNldWRvLWVsZW1lbnRzIGxpa2UgOjpjb250ZW50CiAgICogYnkgcmVwbGFjaW5nIHdpdGggc3BhY2UuCiAgKi8KICBjb252ZXJ0U2hhZG93RE9NU2VsZWN0b3JzOiBmdW5jdGlvbihjc3NUZXh0KSB7CiAgICBmb3IgKHZhciBpPTA7IGkgPCBzaGFkb3dET01TZWxlY3RvcnNSZS5sZW5ndGg7IGkrKykgewogICAgICBjc3NUZXh0ID0gY3NzVGV4dC5yZXBsYWNlKHNoYWRvd0RPTVNlbGVjdG9yc1JlW2ldLCAnICcpOwogICAgfQogICAgcmV0dXJuIGNzc1RleHQ7CiAgfSwKICAvLyBjaGFuZ2UgYSBzZWxlY3RvciBsaWtlICdkaXYnIHRvICduYW1lIGRpdicKICBzY29wZVJ1bGVzOiBmdW5jdGlvbihjc3NSdWxlcywgc2NvcGVTZWxlY3RvcikgewogICAgdmFyIGNzc1RleHQgPSAnJzsKICAgIGlmIChjc3NSdWxlcykgewogICAgICBBcnJheS5wcm90b3R5cGUuZm9yRWFjaC5jYWxsKGNzc1J1bGVzLCBmdW5jdGlvbihydWxlKSB7CiAgICAgICAgaWYgKHJ1bGUuc2VsZWN0b3JUZXh0ICYmIChydWxlLnN0eWxlICYmIHJ1bGUuc3R5bGUuY3NzVGV4dCAhPT0gdW5kZWZpbmVkKSkgewogICAgICAgICAgY3NzVGV4dCArPSB0aGlzLnNjb3BlU2VsZWN0b3IocnVsZS5zZWxlY3RvclRleHQsIHNjb3BlU2VsZWN0b3IsIAogICAgICAgICAgICB0aGlzLnN0cmljdFN0eWxpbmcpICsgJyB7XG5cdCc7CiAgICAgICAgICBjc3NUZXh0ICs9IHRoaXMucHJvcGVydGllc0Zyb21SdWxlKHJ1bGUpICsgJ1xufVxuXG4nOwogICAgICAgIH0gZWxzZSBpZiAocnVsZS50eXBlID09PSBDU1NSdWxlLk1FRElBX1JVTEUpIHsKICAgICAgICAgIGNzc1RleHQgKz0gJ0BtZWRpYSAnICsgcnVsZS5tZWRpYS5tZWRpYVRleHQgKyAnIHtcbic7CiAgICAgICAgICBjc3NUZXh0ICs9IHRoaXMuc2NvcGVSdWxlcyhydWxlLmNzc1J1bGVzLCBzY29wZVNlbGVjdG9yKTsKICAgICAgICAgIGNzc1RleHQgKz0gJ1xufVxuXG4nOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAvLyBLRVlGUkFNRVNfUlVMRSBpbiBJRSB0aHJvd3Mgd2hlbiB3ZSBxdWVyeSBjc3NUZXh0CiAgICAgICAgICAvLyB3aGVuIGl0IGNvbnRhaW5zIGEgLXdlYmtpdC0gcHJvcGVydHkuCiAgICAgICAgICAvLyBpZiB0aGlzIGhhcHBlbnMsIHdlIGZhbGxiYWNrIHRvIGNvbnN0cnVjdGluZyB0aGUgcnVsZQogICAgICAgICAgLy8gZnJvbSB0aGUgQ1NTUnVsZVNldAogICAgICAgICAgLy8gaHR0cHM6Ly9jb25uZWN0Lm1pY3Jvc29mdC5jb20vSUUvZmVlZGJhY2tkZXRhaWwvdmlldy85NTU3MDMvYWNjZXNzaW5nLWNzc3RleHQtb2YtYS1rZXlmcmFtZS1ydWxlLXRoYXQtY29udGFpbnMtYS13ZWJraXQtcHJvcGVydHktdmlhLWNzc29tLWdlbmVyYXRlcy1leGNlcHRpb24KICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIGlmIChydWxlLmNzc1RleHQpIHsKICAgICAgICAgICAgICBjc3NUZXh0ICs9IHJ1bGUuY3NzVGV4dCArICdcblxuJzsKICAgICAgICAgICAgfQogICAgICAgICAgfSBjYXRjaCh4KSB7CiAgICAgICAgICAgIGlmIChydWxlLnR5cGUgPT09IENTU1J1bGUuS0VZRlJBTUVTX1JVTEUgJiYgcnVsZS5jc3NSdWxlcykgewogICAgICAgICAgICAgIGNzc1RleHQgKz0gdGhpcy5pZVNhZmVDc3NUZXh0RnJvbUtleUZyYW1lUnVsZShydWxlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwgdGhpcyk7CiAgICB9CiAgICByZXR1cm4gY3NzVGV4dDsKICB9LAogIGllU2FmZUNzc1RleHRGcm9tS2V5RnJhbWVSdWxlOiBmdW5jdGlvbihydWxlKSB7CiAgICB2YXIgY3NzVGV4dCA9ICdAa2V5ZnJhbWVzICcgKyBydWxlLm5hbWUgKyAnIHsnOwogICAgQXJyYXkucHJvdG90eXBlLmZvckVhY2guY2FsbChydWxlLmNzc1J1bGVzLCBmdW5jdGlvbihydWxlKSB7CiAgICAgIGNzc1RleHQgKz0gJyAnICsgcnVsZS5rZXlUZXh0ICsgJyB7JyArIHJ1bGUuc3R5bGUuY3NzVGV4dCArICd9JzsKICAgIH0pOwogICAgY3NzVGV4dCArPSAnIH0nOwogICAgcmV0dXJuIGNzc1RleHQ7CiAgfSwKICBzY29wZVNlbGVjdG9yOiBmdW5jdGlvbihzZWxlY3Rvciwgc2NvcGVTZWxlY3Rvciwgc3RyaWN0KSB7CiAgICB2YXIgciA9IFtdLCBwYXJ0cyA9IHNlbGVjdG9yLnNwbGl0KCcsJyk7CiAgICBwYXJ0cy5mb3JFYWNoKGZ1bmN0aW9uKHApIHsKICAgICAgcCA9IHAudHJpbSgpOwogICAgICBpZiAodGhpcy5zZWxlY3Rvck5lZWRzU2NvcGluZyhwLCBzY29wZVNlbGVjdG9yKSkgewogICAgICAgIHAgPSAoc3RyaWN0ICYmICFwLm1hdGNoKHBvbHlmaWxsSG9zdE5vQ29tYmluYXRvcikpID8gCiAgICAgICAgICAgIHRoaXMuYXBwbHlTdHJpY3RTZWxlY3RvclNjb3BlKHAsIHNjb3BlU2VsZWN0b3IpIDoKICAgICAgICAgICAgdGhpcy5hcHBseVNlbGVjdG9yU2NvcGUocCwgc2NvcGVTZWxlY3Rvcik7CiAgICAgIH0KICAgICAgci5wdXNoKHApOwogICAgfSwgdGhpcyk7CiAgICByZXR1cm4gci5qb2luKCcsICcpOwogIH0sCiAgc2VsZWN0b3JOZWVkc1Njb3Bpbmc6IGZ1bmN0aW9uKHNlbGVjdG9yLCBzY29wZVNlbGVjdG9yKSB7CiAgICBpZiAoQXJyYXkuaXNBcnJheShzY29wZVNlbGVjdG9yKSkgewogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIHZhciByZSA9IHRoaXMubWFrZVNjb3BlTWF0Y2hlcihzY29wZVNlbGVjdG9yKTsKICAgIHJldHVybiAhc2VsZWN0b3IubWF0Y2gocmUpOwogIH0sCiAgbWFrZVNjb3BlTWF0Y2hlcjogZnVuY3Rpb24oc2NvcGVTZWxlY3RvcikgewogICAgc2NvcGVTZWxlY3RvciA9IHNjb3BlU2VsZWN0b3IucmVwbGFjZSgvXFsvZywgJ1xcWycpLnJlcGxhY2UoL1xbL2csICdcXF0nKTsKICAgIHJldHVybiBuZXcgUmVnRXhwKCdeKCcgKyBzY29wZVNlbGVjdG9yICsgJyknICsgc2VsZWN0b3JSZVN1ZmZpeCwgJ20nKTsKICB9LAogIGFwcGx5U2VsZWN0b3JTY29wZTogZnVuY3Rpb24oc2VsZWN0b3IsIHNlbGVjdG9yU2NvcGUpIHsKICAgIHJldHVybiBBcnJheS5pc0FycmF5KHNlbGVjdG9yU2NvcGUpID8KICAgICAgICB0aGlzLmFwcGx5U2VsZWN0b3JTY29wZUxpc3Qoc2VsZWN0b3IsIHNlbGVjdG9yU2NvcGUpIDoKICAgICAgICB0aGlzLmFwcGx5U2ltcGxlU2VsZWN0b3JTY29wZShzZWxlY3Rvciwgc2VsZWN0b3JTY29wZSk7CiAgfSwKICAvLyBhcHBseSBhbiBhcnJheSBvZiBzZWxlY3RvcnMKICBhcHBseVNlbGVjdG9yU2NvcGVMaXN0OiBmdW5jdGlvbihzZWxlY3Rvciwgc2NvcGVTZWxlY3Rvckxpc3QpIHsKICAgIHZhciByID0gW107CiAgICBmb3IgKHZhciBpPTAsIHM7IChzPXNjb3BlU2VsZWN0b3JMaXN0W2ldKTsgaSsrKSB7CiAgICAgIHIucHVzaCh0aGlzLmFwcGx5U2ltcGxlU2VsZWN0b3JTY29wZShzZWxlY3RvciwgcykpOwogICAgfQogICAgcmV0dXJuIHIuam9pbignLCAnKTsKICB9LAogIC8vIHNjb3BlIHZpYSBuYW1lIGFuZCBbaXM9bmFtZV0KICBhcHBseVNpbXBsZVNlbGVjdG9yU2NvcGU6IGZ1bmN0aW9uKHNlbGVjdG9yLCBzY29wZVNlbGVjdG9yKSB7CiAgICBpZiAoc2VsZWN0b3IubWF0Y2gocG9seWZpbGxIb3N0UmUpKSB7CiAgICAgIHNlbGVjdG9yID0gc2VsZWN0b3IucmVwbGFjZShwb2x5ZmlsbEhvc3ROb0NvbWJpbmF0b3IsIHNjb3BlU2VsZWN0b3IpOwogICAgICByZXR1cm4gc2VsZWN0b3IucmVwbGFjZShwb2x5ZmlsbEhvc3RSZSwgc2NvcGVTZWxlY3RvciArICcgJyk7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gc2NvcGVTZWxlY3RvciArICcgJyArIHNlbGVjdG9yOwogICAgfQogIH0sCiAgLy8gcmV0dXJuIGEgc2VsZWN0b3Igd2l0aCBbbmFtZV0gc3VmZml4IG9uIGVhY2ggc2ltcGxlIHNlbGVjdG9yCiAgLy8gZS5nLiAuZm9vLmJhciA+IC56b3QgYmVjb21lcyAuZm9vW25hbWVdLmJhcltuYW1lXSA+IC56b3RbbmFtZV0KICBhcHBseVN0cmljdFNlbGVjdG9yU2NvcGU6IGZ1bmN0aW9uKHNlbGVjdG9yLCBzY29wZVNlbGVjdG9yKSB7CiAgICBzY29wZVNlbGVjdG9yID0gc2NvcGVTZWxlY3Rvci5yZXBsYWNlKC9cW2lzPShbXlxdXSopXF0vZywgJyQxJyk7CiAgICB2YXIgc3BsaXRzID0gWycgJywgJz4nLCAnKycsICd+J10sCiAgICAgIHNjb3BlZCA9IHNlbGVjdG9yLAogICAgICBhdHRyTmFtZSA9ICdbJyArIHNjb3BlU2VsZWN0b3IgKyAnXSc7CiAgICBzcGxpdHMuZm9yRWFjaChmdW5jdGlvbihzZXApIHsKICAgICAgdmFyIHBhcnRzID0gc2NvcGVkLnNwbGl0KHNlcCk7CiAgICAgIHNjb3BlZCA9IHBhcnRzLm1hcChmdW5jdGlvbihwKSB7CiAgICAgICAgLy8gcmVtb3ZlIDpob3N0IHNpbmNlIGl0IHNob3VsZCBiZSB1bm5lY2Vzc2FyeQogICAgICAgIHZhciB0ID0gcC50cmltKCkucmVwbGFjZShwb2x5ZmlsbEhvc3RSZSwgJycpOwogICAgICAgIGlmICh0ICYmIChzcGxpdHMuaW5kZXhPZih0KSA8IDApICYmICh0LmluZGV4T2YoYXR0ck5hbWUpIDwgMCkpIHsKICAgICAgICAgIHAgPSB0LnJlcGxhY2UoLyhbXjpdKikoOiopKC4qKS8sICckMScgKyBhdHRyTmFtZSArICckMiQzJykKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHA7CiAgICAgIH0pLmpvaW4oc2VwKTsKICAgIH0pOwogICAgcmV0dXJuIHNjb3BlZDsKICB9LAogIGluc2VydFBvbHlmaWxsSG9zdEluQ3NzVGV4dDogZnVuY3Rpb24oc2VsZWN0b3IpIHsKICAgIHJldHVybiBzZWxlY3Rvci5yZXBsYWNlKGNvbG9uSG9zdENvbnRleHRSZSwgcG9seWZpbGxIb3N0Q29udGV4dCkucmVwbGFjZSgKICAgICAgICBjb2xvbkhvc3RSZSwgcG9seWZpbGxIb3N0KTsKICB9LAogIHByb3BlcnRpZXNGcm9tUnVsZTogZnVuY3Rpb24ocnVsZSkgewogICAgdmFyIGNzc1RleHQgPSBydWxlLnN0eWxlLmNzc1RleHQ7CiAgICAvLyBUT0RPKHNvcnZlbGwpOiBTYWZhcmkgY3Nzb20gaW5jb3JyZWN0bHkgcmVtb3ZlcyBxdW90ZXMgZnJvbSB0aGUgY29udGVudAogICAgLy8gcHJvcGVydHkuIChodHRwczovL2J1Z3Mud2Via2l0Lm9yZy9zaG93X2J1Zy5jZ2k/aWQ9MTE4MDQ1KQogICAgLy8gZG9uJ3QgcmVwbGFjZSBhdHRyIHJ1bGVzCiAgICBpZiAocnVsZS5zdHlsZS5jb250ZW50ICYmICFydWxlLnN0eWxlLmNvbnRlbnQubWF0Y2goL1snIl0rfGF0dHIvKSkgewogICAgICBjc3NUZXh0ID0gY3NzVGV4dC5yZXBsYWNlKC9jb250ZW50OlteO10qOy9nLCAnY29udGVudDogXCcnICsgCiAgICAgICAgICBydWxlLnN0eWxlLmNvbnRlbnQgKyAnXCc7Jyk7CiAgICB9CiAgICAvLyBUT0RPKHNvcnZlbGwpOiB3ZSBjYW4gd29ya2Fyb3VuZCB0aGlzIGlzc3VlIGhlcmUsIGJ1dCB3ZSBuZWVkIGEgbGlzdAogICAgLy8gb2YgdHJvdWJsZXNvbWUgcHJvcGVydGllcyB0byBmaXggaHR0cHM6Ly9naXRodWIuY29tL1BvbHltZXIvcGxhdGZvcm0vaXNzdWVzLzUzCiAgICAvLwogICAgLy8gaW5oZXJpdCBydWxlcyBjYW4gYmUgb21pdHRlZCBmcm9tIGNzc1RleHQKICAgIC8vIFRPRE8oc29ydmVsbCk6IHJlbW92ZSB3aGVuIEJsaW5rIGJ1ZyBpcyBmaXhlZDoKICAgIC8vIGh0dHBzOi8vY29kZS5nb29nbGUuY29tL3AvY2hyb21pdW0vaXNzdWVzL2RldGFpbD9pZD0zNTgyNzMKICAgIHZhciBzdHlsZSA9IHJ1bGUuc3R5bGU7CiAgICBmb3IgKHZhciBpIGluIHN0eWxlKSB7CiAgICAgIGlmIChzdHlsZVtpXSA9PT0gJ2luaXRpYWwnKSB7CiAgICAgICAgY3NzVGV4dCArPSBpICsgJzogaW5pdGlhbDsgJzsKICAgICAgfQogICAgfQogICAgcmV0dXJuIGNzc1RleHQ7CiAgfSwKICByZXBsYWNlVGV4dEluU3R5bGVzOiBmdW5jdGlvbihzdHlsZXMsIGFjdGlvbikgewogICAgaWYgKHN0eWxlcyAmJiBhY3Rpb24pIHsKICAgICAgaWYgKCEoc3R5bGVzIGluc3RhbmNlb2YgQXJyYXkpKSB7CiAgICAgICAgc3R5bGVzID0gW3N0eWxlc107CiAgICAgIH0KICAgICAgQXJyYXkucHJvdG90eXBlLmZvckVhY2guY2FsbChzdHlsZXMsIGZ1bmN0aW9uKHMpIHsKICAgICAgICBzLnRleHRDb250ZW50ID0gYWN0aW9uLmNhbGwodGhpcywgcy50ZXh0Q29udGVudCk7CiAgICAgIH0sIHRoaXMpOwogICAgfQogIH0sCiAgYWRkQ3NzVG9Eb2N1bWVudDogZnVuY3Rpb24oY3NzVGV4dCwgbmFtZSkgewogICAgaWYgKGNzc1RleHQubWF0Y2goJ0BpbXBvcnQnKSkgewogICAgICBhZGRPd25TaGVldChjc3NUZXh0LCBuYW1lKTsKICAgIH0gZWxzZSB7CiAgICAgIGFkZENzc1RvRG9jdW1lbnQoY3NzVGV4dCk7CiAgICB9CiAgfQp9OwoKdmFyIHNlbGVjdG9yUmUgPSAvKFtee10qKSh7W1xzXFNdKj99KS9naW0sCiAgICBjc3NDb21tZW50UmUgPSAvXC9cKlteKl0qXCorKFteLypdW14qXSpcKispKlwvL2dpbSwKICAgIC8vIFRPRE8oc29ydmVsbCk6IHJlbW92ZSBlaXRoZXIgY29udGVudCBvciBjb21tZW50CiAgICBjc3NDb21tZW50TmV4dFNlbGVjdG9yUmUgPSAvXC9cKlxzKkBwb2x5ZmlsbCAoW14qXSpcKisoW14vKl1bXipdKlwqKykqXC8pKFtee10qPyl7L2dpbSwKICAgIGNzc0NvbnRlbnROZXh0U2VsZWN0b3JSZSA9IC9wb2x5ZmlsbC1uZXh0LXNlbGVjdG9yW159XSpjb250ZW50XDpbXHNdKj9bJyJdKC4qPylbJyJdWztcc10qfShbXntdKj8pey9naW0sICAKICAgIC8vIFRPRE8oc29ydmVsbCk6IHJlbW92ZSBlaXRoZXIgY29udGVudCBvciBjb21tZW50CiAgICBjc3NDb21tZW50UnVsZVJlID0gL1wvXCpcc0Bwb2x5ZmlsbC1ydWxlKFteKl0qXCorKFteLypdW14qXSpcKispKilcLy9naW0sCiAgICBjc3NDb250ZW50UnVsZVJlID0gLyhwb2x5ZmlsbC1ydWxlKVtefV0qKGNvbnRlbnRcOltcc10qWyciXSguKj8pWyciXSlbO1xzXSpbXn1dKn0vZ2ltLAogICAgLy8gVE9ETyhzb3J2ZWxsKTogcmVtb3ZlIGVpdGhlciBjb250ZW50IG9yIGNvbW1lbnQKICAgIGNzc0NvbW1lbnRVbnNjb3BlZFJ1bGVSZSA9IC9cL1wqXHNAcG9seWZpbGwtdW5zY29wZWQtcnVsZShbXipdKlwqKyhbXi8qXVteKl0qXCorKSopXC8vZ2ltLAogICAgY3NzQ29udGVudFVuc2NvcGVkUnVsZVJlID0gLyhwb2x5ZmlsbC11bnNjb3BlZC1ydWxlKVtefV0qKGNvbnRlbnRcOltcc10qWyciXSguKj8pWyciXSlbO1xzXSpbXn1dKn0vZ2ltLAogICAgY3NzUHNldWRvUmUgPSAvOjooeC1bXlxzeywoXSopL2dpbSwKICAgIGNzc1BhcnRSZSA9IC86OnBhcnRcKChbXildKilcKS9naW0sCiAgICAvLyBub3RlOiA6aG9zdCBwcmUtcHJvY2Vzc2VkIHRvIC1zaGFkb3djc3Nob3N0LgogICAgcG9seWZpbGxIb3N0ID0gJy1zaGFkb3djc3Nob3N0JywKICAgIC8vIG5vdGU6IDpob3N0LWNvbnRleHQgcHJlLXByb2Nlc3NlZCB0byAtc2hhZG93Y3NzaG9zdGNvbnRleHQuCiAgICBwb2x5ZmlsbEhvc3RDb250ZXh0ID0gJy1zaGFkb3djc3Njb250ZXh0JywKICAgIHBhcmVuU3VmZml4ID0gJykoPzpcXCgoJyArCiAgICAgICAgJyg/OlxcKFteKShdKlxcKXxbXikoXSopKz8nICsKICAgICAgICAnKVxcKSk/KFteLHtdKiknOwogICAgdmFyIGNzc0NvbG9uSG9zdFJlID0gbmV3IFJlZ0V4cCgnKCcgKyBwb2x5ZmlsbEhvc3QgKyBwYXJlblN1ZmZpeCwgJ2dpbScpLAogICAgY3NzQ29sb25Ib3N0Q29udGV4dFJlID0gbmV3IFJlZ0V4cCgnKCcgKyBwb2x5ZmlsbEhvc3RDb250ZXh0ICsgcGFyZW5TdWZmaXgsICdnaW0nKSwKICAgIHNlbGVjdG9yUmVTdWZmaXggPSAnKFs+XFxzfitcWy4sezpdW1xcc1xcU10qKT8kJywKICAgIGNvbG9uSG9zdFJlID0gL1w6aG9zdC9naW0sCiAgICBjb2xvbkhvc3RDb250ZXh0UmUgPSAvXDpob3N0LWNvbnRleHQvZ2ltLAogICAgLyogaG9zdCBuYW1lIHdpdGhvdXQgY29tYmluYXRvciAqLwogICAgcG9seWZpbGxIb3N0Tm9Db21iaW5hdG9yID0gcG9seWZpbGxIb3N0ICsgJy1uby1jb21iaW5hdG9yJywKICAgIHBvbHlmaWxsSG9zdFJlID0gbmV3IFJlZ0V4cChwb2x5ZmlsbEhvc3QsICdnaW0nKSwKICAgIHBvbHlmaWxsSG9zdENvbnRleHRSZSA9IG5ldyBSZWdFeHAocG9seWZpbGxIb3N0Q29udGV4dCwgJ2dpbScpLAogICAgc2hhZG93RE9NU2VsZWN0b3JzUmUgPSBbCiAgICAgIC9cXlxeL2csCiAgICAgIC9cXi9nLAogICAgICAvXC9zaGFkb3dcLy9nLAogICAgICAvXC9zaGFkb3ctZGVlcFwvL2csCiAgICAgIC86OnNoYWRvdy9nLAogICAgICAvXC9kZWVwXC8vZywKICAgICAgLzo6Y29udGVudC9nCiAgICBdOwoKZnVuY3Rpb24gc3R5bGVzVG9Dc3NUZXh0KHN0eWxlcywgcHJlc2VydmVDb21tZW50cykgewogIHZhciBjc3NUZXh0ID0gJyc7CiAgQXJyYXkucHJvdG90eXBlLmZvckVhY2guY2FsbChzdHlsZXMsIGZ1bmN0aW9uKHMpIHsKICAgIGNzc1RleHQgKz0gcy50ZXh0Q29udGVudCArICdcblxuJzsKICB9KTsKICAvLyBzdHJpcCBjb21tZW50cyBmb3IgZWFzaWVyIHByb2Nlc3NpbmcKICBpZiAoIXByZXNlcnZlQ29tbWVudHMpIHsKICAgIGNzc1RleHQgPSBjc3NUZXh0LnJlcGxhY2UoY3NzQ29tbWVudFJlLCAnJyk7CiAgfQogIHJldHVybiBjc3NUZXh0Owp9CgpmdW5jdGlvbiBjc3NUZXh0VG9TdHlsZShjc3NUZXh0KSB7CiAgdmFyIHN0eWxlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc3R5bGUnKTsKICBzdHlsZS50ZXh0Q29udGVudCA9IGNzc1RleHQ7CiAgcmV0dXJuIHN0eWxlOwp9CgpmdW5jdGlvbiBjc3NUb1J1bGVzKGNzc1RleHQpIHsKICB2YXIgc3R5bGUgPSBjc3NUZXh0VG9TdHlsZShjc3NUZXh0KTsKICBkb2N1bWVudC5oZWFkLmFwcGVuZENoaWxkKHN0eWxlKTsKICB2YXIgcnVsZXMgPSBbXTsKICBpZiAoc3R5bGUuc2hlZXQpIHsKICAgIC8vIFRPRE8oc29ydmVsbCk6IEZpcmVmb3ggdGhyb3dzIHdoZW4gYWNjZXNzaW5nIHRoZSBydWxlcyBvZiBhIHN0eWxlc2hlZXQKICAgIC8vIHdpdGggYW4gQGltcG9ydAogICAgLy8gaHR0cHM6Ly9idWd6aWxsYS5tb3ppbGxhLm9yZy9zaG93X2J1Zy5jZ2k/aWQ9NjI1MDEzCiAgICB0cnkgewogICAgICBydWxlcyA9IHN0eWxlLnNoZWV0LmNzc1J1bGVzOwogICAgfSBjYXRjaChlKSB7CiAgICAgIC8vCiAgICB9CiAgfSBlbHNlIHsKICAgIGNvbnNvbGUud2Fybignc2hlZXQgbm90IGZvdW5kJywgc3R5bGUpOwogIH0KICBzdHlsZS5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKHN0eWxlKTsKICByZXR1cm4gcnVsZXM7Cn0KCnZhciBmcmFtZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2lmcmFtZScpOwpmcmFtZS5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwoKZnVuY3Rpb24gaW5pdEZyYW1lKCkgewogIGZyYW1lLmluaXRpYWxpemVkID0gdHJ1ZTsKICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKGZyYW1lKTsKICB2YXIgZG9jID0gZnJhbWUuY29udGVudERvY3VtZW50OwogIHZhciBiYXNlID0gZG9jLmNyZWF0ZUVsZW1lbnQoJ2Jhc2UnKTsKICBiYXNlLmhyZWYgPSBkb2N1bWVudC5iYXNlVVJJOwogIGRvYy5oZWFkLmFwcGVuZENoaWxkKGJhc2UpOwp9CgpmdW5jdGlvbiBpbkZyYW1lKGZuKSB7CiAgaWYgKCFmcmFtZS5pbml0aWFsaXplZCkgewogICAgaW5pdEZyYW1lKCk7CiAgfQogIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoZnJhbWUpOwogIGZuKGZyYW1lLmNvbnRlbnREb2N1bWVudCk7CiAgZG9jdW1lbnQuYm9keS5yZW1vdmVDaGlsZChmcmFtZSk7Cn0KCi8vIFRPRE8oc29ydmVsbCk6IHVzZSBhbiBpZnJhbWUgaWYgdGhlIGNzc1RleHQgY29udGFpbnMgYW4gQGltcG9ydCB0byB3b3JrYXJvdW5kCi8vIGh0dHBzOi8vY29kZS5nb29nbGUuY29tL3AvY2hyb21pdW0vaXNzdWVzL2RldGFpbD9pZD0zNDUxMTQKdmFyIGlzQ2hyb21lID0gbmF2aWdhdG9yLnVzZXJBZ2VudC5tYXRjaCgnQ2hyb21lJyk7CmZ1bmN0aW9uIHdpdGhDc3NSdWxlcyhjc3NUZXh0LCBjYWxsYmFjaykgewogIGlmICghY2FsbGJhY2spIHsKICAgIHJldHVybjsKICB9CiAgdmFyIHJ1bGVzOwogIGlmIChjc3NUZXh0Lm1hdGNoKCdAaW1wb3J0JykgJiYgaXNDaHJvbWUpIHsKICAgIHZhciBzdHlsZSA9IGNzc1RleHRUb1N0eWxlKGNzc1RleHQpOwogICAgaW5GcmFtZShmdW5jdGlvbihkb2MpIHsKICAgICAgZG9jLmhlYWQuYXBwZW5kQ2hpbGQoc3R5bGUuaW1wbCk7CiAgICAgIHJ1bGVzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoc3R5bGUuc2hlZXQuY3NzUnVsZXMsIDApOwogICAgICBjYWxsYmFjayhydWxlcyk7CiAgICB9KTsKICB9IGVsc2UgewogICAgcnVsZXMgPSBjc3NUb1J1bGVzKGNzc1RleHQpOwogICAgY2FsbGJhY2socnVsZXMpOwogIH0KfQoKZnVuY3Rpb24gcnVsZXNUb0Nzcyhjc3NSdWxlcykgewogIGZvciAodmFyIGk9MCwgY3NzPVtdOyBpIDwgY3NzUnVsZXMubGVuZ3RoOyBpKyspIHsKICAgIGNzcy5wdXNoKGNzc1J1bGVzW2ldLmNzc1RleHQpOwogIH0KICByZXR1cm4gY3NzLmpvaW4oJ1xuXG4nKTsKfQoKZnVuY3Rpb24gYWRkQ3NzVG9Eb2N1bWVudChjc3NUZXh0KSB7CiAgaWYgKGNzc1RleHQpIHsKICAgIGdldFNoZWV0KCkuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoY3NzVGV4dCkpOwogIH0KfQoKZnVuY3Rpb24gYWRkT3duU2hlZXQoY3NzVGV4dCwgbmFtZSkgewogIHZhciBzdHlsZSA9IGNzc1RleHRUb1N0eWxlKGNzc1RleHQpOwogIHN0eWxlLnNldEF0dHJpYnV0ZShuYW1lLCAnJyk7CiAgc3R5bGUuc2V0QXR0cmlidXRlKFNISU1NRURfQVRUUklCVVRFLCAnJyk7CiAgZG9jdW1lbnQuaGVhZC5hcHBlbmRDaGlsZChzdHlsZSk7Cn0KCnZhciBTSElNX0FUVFJJQlVURSA9ICdzaGltLXNoYWRvd2RvbSc7CnZhciBTSElNTUVEX0FUVFJJQlVURSA9ICdzaGltLXNoYWRvd2RvbS1jc3MnOwp2YXIgTk9fU0hJTV9BVFRSSUJVVEUgPSAnbm8tc2hpbSc7Cgp2YXIgc2hlZXQ7CmZ1bmN0aW9uIGdldFNoZWV0KCkgewogIGlmICghc2hlZXQpIHsKICAgIHNoZWV0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgic3R5bGUiKTsKICAgIHNoZWV0LnNldEF0dHJpYnV0ZShTSElNTUVEX0FUVFJJQlVURSwgJycpOwogICAgc2hlZXRbU0hJTU1FRF9BVFRSSUJVVEVdID0gdHJ1ZTsKICB9CiAgcmV0dXJuIHNoZWV0Owp9CgovLyBhZGQgcG9seWZpbGwgc3R5bGVzaGVldCB0byBkb2N1bWVudAppZiAod2luZG93LlNoYWRvd0RPTVBvbHlmaWxsKSB7CiAgYWRkQ3NzVG9Eb2N1bWVudCgnc3R5bGUgeyBkaXNwbGF5OiBub25lICFpbXBvcnRhbnQ7IH1cbicpOwogIHZhciBkb2MgPSBTaGFkb3dET01Qb2x5ZmlsbC53cmFwKGRvY3VtZW50KTsKICB2YXIgaGVhZCA9IGRvYy5xdWVyeVNlbGVjdG9yKCdoZWFkJyk7CiAgaGVhZC5pbnNlcnRCZWZvcmUoZ2V0U2hlZXQoKSwgaGVhZC5jaGlsZE5vZGVzWzBdKTsKCiAgLy8gVE9ETyhzb3J2ZWxsKTogbW9ua2V5LXBhdGNoaW5nIEhUTUxJbXBvcnRzIGlzIGFidXNpdmU7CiAgLy8gY29uc2lkZXIgYSBiZXR0ZXIgc29sdXRpb24uCiAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignRE9NQ29udGVudExvYWRlZCcsIGZ1bmN0aW9uKCkgewogICAgdmFyIHVybFJlc29sdmVyID0gc2NvcGUudXJsUmVzb2x2ZXI7CiAgICAKICAgIGlmICh3aW5kb3cuSFRNTEltcG9ydHMgJiYgIUhUTUxJbXBvcnRzLnVzZU5hdGl2ZSkgewogICAgICB2YXIgU0hJTV9TSEVFVF9TRUxFQ1RPUiA9ICdsaW5rW3JlbD1zdHlsZXNoZWV0XScgKwogICAgICAgICAgJ1snICsgU0hJTV9BVFRSSUJVVEUgKyAnXSc7CiAgICAgIHZhciBTSElNX1NUWUxFX1NFTEVDVE9SID0gJ3N0eWxlWycgKyBTSElNX0FUVFJJQlVURSArICddJzsKICAgICAgSFRNTEltcG9ydHMuaW1wb3J0ZXIuZG9jdW1lbnRQcmVsb2FkU2VsZWN0b3JzICs9ICcsJyArIFNISU1fU0hFRVRfU0VMRUNUT1I7CiAgICAgIEhUTUxJbXBvcnRzLmltcG9ydGVyLmltcG9ydHNQcmVsb2FkU2VsZWN0b3JzICs9ICcsJyArIFNISU1fU0hFRVRfU0VMRUNUT1I7CgogICAgICBIVE1MSW1wb3J0cy5wYXJzZXIuZG9jdW1lbnRTZWxlY3RvcnMgPSBbCiAgICAgICAgSFRNTEltcG9ydHMucGFyc2VyLmRvY3VtZW50U2VsZWN0b3JzLAogICAgICAgIFNISU1fU0hFRVRfU0VMRUNUT1IsCiAgICAgICAgU0hJTV9TVFlMRV9TRUxFQ1RPUgogICAgICBdLmpvaW4oJywnKTsKICAKICAgICAgdmFyIG9yaWdpbmFsUGFyc2VHZW5lcmljID0gSFRNTEltcG9ydHMucGFyc2VyLnBhcnNlR2VuZXJpYzsKCiAgICAgIEhUTUxJbXBvcnRzLnBhcnNlci5wYXJzZUdlbmVyaWMgPSBmdW5jdGlvbihlbHQpIHsKICAgICAgICBpZiAoZWx0W1NISU1NRURfQVRUUklCVVRFXSkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICB2YXIgc3R5bGUgPSBlbHQuX19pbXBvcnRFbGVtZW50IHx8IGVsdDsKICAgICAgICBpZiAoIXN0eWxlLmhhc0F0dHJpYnV0ZShTSElNX0FUVFJJQlVURSkpIHsKICAgICAgICAgIG9yaWdpbmFsUGFyc2VHZW5lcmljLmNhbGwodGhpcywgZWx0KTsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgaWYgKGVsdC5fX3Jlc291cmNlKSB7CiAgICAgICAgICBzdHlsZSA9IGVsdC5vd25lckRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3N0eWxlJyk7CiAgICAgICAgICBzdHlsZS50ZXh0Q29udGVudCA9IGVsdC5fX3Jlc291cmNlOwogICAgICAgIH0KICAgICAgICAvLyByZWxheSBvbiBIVE1MSW1wb3J0cyBmb3IgcGF0aCBmaXh1cAogICAgICAgIEhUTUxJbXBvcnRzLnBhdGgucmVzb2x2ZVVybHNJblN0eWxlKHN0eWxlKTsKICAgICAgICBzdHlsZS50ZXh0Q29udGVudCA9IFNoYWRvd0NTUy5zaGltU3R5bGUoc3R5bGUpOwogICAgICAgIHN0eWxlLnJlbW92ZUF0dHJpYnV0ZShTSElNX0FUVFJJQlVURSwgJycpOwogICAgICAgIHN0eWxlLnNldEF0dHJpYnV0ZShTSElNTUVEX0FUVFJJQlVURSwgJycpOwogICAgICAgIHN0eWxlW1NISU1NRURfQVRUUklCVVRFXSA9IHRydWU7CiAgICAgICAgLy8gcGxhY2UgaW4gZG9jdW1lbnQKICAgICAgICBpZiAoc3R5bGUucGFyZW50Tm9kZSAhPT0gaGVhZCkgewogICAgICAgICAgLy8gcmVwbGFjZSBsaW5rcyBpbiBoZWFkCiAgICAgICAgICBpZiAoZWx0LnBhcmVudE5vZGUgPT09IGhlYWQpIHsKICAgICAgICAgICAgaGVhZC5yZXBsYWNlQ2hpbGQoc3R5bGUsIGVsdCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLmFkZEVsZW1lbnRUb0RvY3VtZW50KHN0eWxlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgc3R5bGUuX19pbXBvcnRQYXJzZWQgPSB0cnVlOwogICAgICAgIHRoaXMubWFya1BhcnNpbmdDb21wbGV0ZShlbHQpOwogICAgICAgIHRoaXMucGFyc2VOZXh0KCk7CiAgICAgIH0KCiAgICAgIHZhciBoYXNSZXNvdXJjZSA9IEhUTUxJbXBvcnRzLnBhcnNlci5oYXNSZXNvdXJjZTsKICAgICAgSFRNTEltcG9ydHMucGFyc2VyLmhhc1Jlc291cmNlID0gZnVuY3Rpb24obm9kZSkgewogICAgICAgIGlmIChub2RlLmxvY2FsTmFtZSA9PT0gJ2xpbmsnICYmIG5vZGUucmVsID09PSAnc3R5bGVzaGVldCcgJiYKICAgICAgICAgICAgbm9kZS5oYXNBdHRyaWJ1dGUoU0hJTV9BVFRSSUJVVEUpKSB7CiAgICAgICAgICByZXR1cm4gKG5vZGUuX19yZXNvdXJjZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJldHVybiBoYXNSZXNvdXJjZS5jYWxsKHRoaXMsIG5vZGUpOwogICAgICAgIH0KICAgICAgfQoKICAgIH0KICB9KTsKfQoKLy8gZXhwb3J0cwpzY29wZS5TaGFkb3dDU1MgPSBTaGFkb3dDU1M7Cgp9KSh3aW5kb3cuV2ViQ29tcG9uZW50cyk7Cg==",
                "body": "LyoKICogQ29weXJpZ2h0IChjKSAyMDE0IFRoZSBQb2x5bWVyIFByb2plY3QgQXV0aG9ycy4gQWxsIHJpZ2h0cyByZXNlcnZlZC4KICogVGhpcyBjb2RlIG1heSBvbmx5IGJlIHVzZWQgdW5kZXIgdGhlIEJTRCBzdHlsZSBsaWNlbnNlIGZvdW5kIGF0IGh0dHA6Ly9wb2x5bWVyLmdpdGh1Yi5pby9MSUNFTlNFLnR4dAogKiBUaGUgY29tcGxldGUgc2V0IG9mIGF1dGhvcnMgbWF5IGJlIGZvdW5kIGF0IGh0dHA6Ly9wb2x5bWVyLmdpdGh1Yi5pby9BVVRIT1JTLnR4dAogKiBUaGUgY29tcGxldGUgc2V0IG9mIGNvbnRyaWJ1dG9ycyBtYXkgYmUgZm91bmQgYXQgaHR0cDovL3BvbHltZXIuZ2l0aHViLmlvL0NPTlRSSUJVVE9SUy50eHQKICogQ29kZSBkaXN0cmlidXRlZCBieSBHb29nbGUgYXMgcGFydCBvZiB0aGUgcG9seW1lciBwcm9qZWN0IGlzIGFsc28KICogc3ViamVjdCB0byBhbiBhZGRpdGlvbmFsIElQIHJpZ2h0cyBncmFudCBmb3VuZCBhdCBodHRwOi8vcG9seW1lci5naXRodWIuaW8vUEFURU5UUy50eHQKICovCgovKgogIFRoaXMgaXMgYSBsaW1pdGVkIHNoaW0gZm9yIFNoYWRvd0RPTSBjc3Mgc3R5bGluZy4KICBodHRwczovL2R2Y3MudzMub3JnL2hnL3dlYmNvbXBvbmVudHMvcmF3LWZpbGUvdGlwL3NwZWMvc2hhZG93L2luZGV4Lmh0bWwjc3R5bGVzCiAgCiAgVGhlIGludGVudGlvbiBoZXJlIGlzIHRvIHN1cHBvcnQgb25seSB0aGUgc3R5bGluZyBmZWF0dXJlcyB3aGljaCBjYW4gYmUgCiAgcmVsYXRpdmVseSBzaW1wbHkgaW1wbGVtZW50ZWQuIFRoZSBnb2FsIGlzIHRvIGFsbG93IHVzZXJzIHRvIGF2b2lkIHRoZSAKICBtb3N0IG9idmlvdXMgcGl0ZmFsbHMgYW5kIGRvIHNvIHdpdGhvdXQgY29tcHJvbWlzaW5nIHBlcmZvcm1hbmNlIHNpZ25pZmljYW50bHkuIAogIEZvciBTaGFkb3dET00gc3R5bGluZyB0aGF0J3Mgbm90IGNvdmVyZWQgaGVyZSwgYSBzZXQgb2YgYmVzdCBwcmFjdGljZXMKICBjYW4gYmUgcHJvdmlkZWQgdGhhdCBzaG91bGQgYWxsb3cgdXNlcnMgdG8gYWNjb21wbGlzaCBtb3JlIGNvbXBsZXggc3R5bGluZy4KCiAgVGhlIGZvbGxvd2luZyBpcyBhIGxpc3Qgb2Ygc3BlY2lmaWMgU2hhZG93RE9NIHN0eWxpbmcgZmVhdHVyZXMgYW5kIGEgYnJpZWYKICBkaXNjdXNzaW9uIG9mIHRoZSBhcHByb2FjaCB1c2VkIHRvIHNoaW0uCgogIFNoaW1tZWQgZmVhdHVyZXM6CgogICogOmhvc3QsIDpob3N0LWNvbnRleHQ6IFNoYWRvd0RPTSBhbGxvd3Mgc3R5bGluZyBvZiB0aGUgc2hhZG93Um9vdCdzIGhvc3QKICBlbGVtZW50IHVzaW5nIHRoZSA6aG9zdCBydWxlLiBUbyBzaGltIHRoaXMgZmVhdHVyZSwgdGhlIDpob3N0IHN0eWxlcyBhcmUgCiAgcmVmb3JtYXR0ZWQgYW5kIHByZWZpeGVkIHdpdGggYSBnaXZlbiBzY29wZSBuYW1lIGFuZCBwcm9tb3RlZCB0byBhIAogIGRvY3VtZW50IGxldmVsIHN0eWxlc2hlZXQuCiAgRm9yIGV4YW1wbGUsIGdpdmVuIGEgc2NvcGUgbmFtZSBvZiAuZm9vLCBhIHJ1bGUgbGlrZSB0aGlzOgogIAogICAgOmhvc3QgewogICAgICAgIGJhY2tncm91bmQ6IHJlZDsKICAgICAgfQogICAgfQogIAogIGJlY29tZXM6CiAgCiAgICAuZm9vIHsKICAgICAgYmFja2dyb3VuZDogcmVkOwogICAgfQogIAogICogZW5jYXBzdWx0aW9uOiBTdHlsZXMgZGVmaW5lZCB3aXRoaW4gU2hhZG93RE9NLCBhcHBseSBvbmx5IHRvIAogIGRvbSBpbnNpZGUgdGhlIFNoYWRvd0RPTS4gUG9seW1lciB1c2VzIG9uZSBvZiB0d28gdGVjaG5pcXVlcyB0byBpbWxlbWVudAogIHRoaXMgZmVhdHVyZS4KICAKICBCeSBkZWZhdWx0LCBydWxlcyBhcmUgcHJlZml4ZWQgd2l0aCB0aGUgaG9zdCBlbGVtZW50IHRhZyBuYW1lIAogIGFzIGEgZGVzY2VuZGFudCBzZWxlY3Rvci4gVGhpcyBlbnN1cmVzIHN0eWxpbmcgZG9lcyBub3QgbGVhayBvdXQgb2YgdGhlICd0b3AnCiAgb2YgdGhlIGVsZW1lbnQncyBTaGFkb3dET00uIEZvciBleGFtcGxlLAoKICBkaXYgewogICAgICBmb250LXdlaWdodDogYm9sZDsKICAgIH0KICAKICBiZWNvbWVzOgoKICB4LWZvbyBkaXYgewogICAgICBmb250LXdlaWdodDogYm9sZDsKICAgIH0KICAKICBiZWNvbWVzOgoKCiAgQWx0ZXJuYXRpdmVseSwgaWYgV2ViQ29tcG9uZW50cy5TaGFkb3dDU1Muc3RyaWN0U3R5bGluZyBpcyBzZXQgdG8gdHJ1ZSB0aGVuIAogIHNlbGVjdG9ycyBhcmUgc2NvcGVkIGJ5IGFkZGluZyBhbiBhdHRyaWJ1dGUgc2VsZWN0b3Igc3VmZml4IHRvIGVhY2gKICBzaW1wbGUgc2VsZWN0b3IgdGhhdCBjb250YWlucyB0aGUgaG9zdCBlbGVtZW50IHRhZyBuYW1lLiBFYWNoIGVsZW1lbnQgCiAgaW4gdGhlIGVsZW1lbnQncyBTaGFkb3dET00gdGVtcGxhdGUgaXMgYWxzbyBnaXZlbiB0aGUgc2NvcGUgYXR0cmlidXRlLiAKICBUaHVzLCB0aGVzZSBydWxlcyBtYXRjaCBvbmx5IGVsZW1lbnRzIHRoYXQgaGF2ZSB0aGUgc2NvcGUgYXR0cmlidXRlLgogIEZvciBleGFtcGxlLCBnaXZlbiBhIHNjb3BlIG5hbWUgb2YgeC1mb28sIGEgcnVsZSBsaWtlIHRoaXM6CiAgCiAgICBkaXYgewogICAgICBmb250LXdlaWdodDogYm9sZDsKICAgIH0KICAKICBiZWNvbWVzOgogIAogICAgZGl2W3gtZm9vXSB7CiAgICAgIGZvbnQtd2VpZ2h0OiBib2xkOwogICAgfQoKICBOb3RlIHRoYXQgZWxlbWVudHMgdGhhdCBhcmUgZHluYW1pY2FsbHkgYWRkZWQgdG8gYSBzY29wZSBtdXN0IGhhdmUgdGhlIHNjb3BlCiAgc2VsZWN0b3IgYWRkZWQgdG8gdGhlbSBtYW51YWxseS4KCiAgKiB1cHBlci9sb3dlciBib3VuZCBlbmNhcHN1bGF0aW9uOiBTdHlsZXMgd2hpY2ggYXJlIGRlZmluZWQgb3V0c2lkZSBhCiAgc2hhZG93Um9vdCBzaG91bGQgbm90IGNyb3NzIHRoZSBTaGFkb3dET00gYm91bmRhcnkgYW5kIHNob3VsZCBub3QgYXBwbHkKICBpbnNpZGUgYSBzaGFkb3dSb290LgoKICBUaGlzIHN0eWxpbmcgYmVoYXZpb3IgaXMgbm90IGVtdWxhdGVkLiBTb21lIHBvc3NpYmxlIHdheXMgdG8gZG8gdGhpcyB0aGF0IAogIHdlcmUgcmVqZWN0ZWQgZHVlIHRvIGNvbXBsZXhpdHkgYW5kL29yIHBlcmZvcm1hbmNlIGNvbmNlcm5zIGluY2x1ZGU6ICgxKSByZXNldAogIGV2ZXJ5IHBvc3NpYmxlIHByb3BlcnR5IGZvciBldmVyeSBwb3NzaWJsZSBzZWxlY3RvciBmb3IgYSBnaXZlbiBzY29wZSBuYW1lOwogICgyKSByZS1pbXBsZW1lbnQgY3NzIGluIGphdmFzY3JpcHQuCiAgCiAgQXMgYW4gYWx0ZXJuYXRpdmUsIHVzZXJzIHNob3VsZCBtYWtlIHN1cmUgdG8gdXNlIHNlbGVjdG9ycwogIHNwZWNpZmljIHRvIHRoZSBzY29wZSBpbiB3aGljaCB0aGV5IGFyZSB3b3JraW5nLgogIAogICogOjpkaXN0cmlidXRlZDogVGhpcyBiZWhhdmlvciBpcyBub3QgZW11bGF0ZWQuIEl0J3Mgb2Z0ZW4gbm90IG5lY2Vzc2FyeQogIHRvIHN0eWxlIHRoZSBjb250ZW50cyBvZiBhIHNwZWNpZmljIGluc2VydGlvbiBwb2ludCBhbmQgaW5zdGVhZCwgZGVzY2VuZGFudHMKICBvZiB0aGUgaG9zdCBlbGVtZW50IGNhbiBiZSBzdHlsZWQgc2VsZWN0aXZlbHkuIFVzZXJzIGNhbiBhbHNvIGNyZWF0ZSBhbiAKICBleHRyYSBub2RlIGFyb3VuZCBhbiBpbnNlcnRpb24gcG9pbnQgYW5kIHN0eWxlIHRoYXQgbm9kZSdzIGNvbnRlbnRzCiAgdmlhIGRlc2NlbmRlbnQgc2VsZWN0b3JzLiBGb3IgZXhhbXBsZSwgd2l0aCBhIHNoYWRvd1Jvb3QgbGlrZSB0aGlzOgogIAogICAgPHN0eWxlPgogICAgICA6OmNvbnRlbnQoZGl2KSB7CiAgICAgICAgYmFja2dyb3VuZDogcmVkOwogICAgICB9CiAgICA8L3N0eWxlPgogICAgPGNvbnRlbnQ+PC9jb250ZW50PgogIAogIGNvdWxkIGJlY29tZToKICAKICAgIDxzdHlsZT4KICAgICAgLyAqQHBvbHlmaWxsIC5jb250ZW50LWNvbnRhaW5lciBkaXYgKiAvIAogICAgICA6OmNvbnRlbnQoZGl2KSB7CiAgICAgICAgYmFja2dyb3VuZDogcmVkOwogICAgICB9CiAgICA8L3N0eWxlPgogICAgPGRpdiBjbGFzcz0iY29udGVudC1jb250YWluZXIiPgogICAgICA8Y29udGVudD48L2NvbnRlbnQ+CiAgICA8L2Rpdj4KICAKICBOb3RlIHRoZSB1c2Ugb2YgQHBvbHlmaWxsIGluIHRoZSBjb21tZW50IGFib3ZlIGEgU2hhZG93RE9NIHNwZWNpZmljIHN0eWxlCiAgZGVjbGFyYXRpb24uIFRoaXMgaXMgYSBkaXJlY3RpdmUgdG8gdGhlIHN0eWxpbmcgc2hpbSB0byB1c2UgdGhlIHNlbGVjdG9yIAogIGluIGNvbW1lbnRzIGluIGxpZXUgb2YgdGhlIG5leHQgc2VsZWN0b3Igd2hlbiBydW5uaW5nIHVuZGVyIHBvbHlmaWxsLgoqLwooZnVuY3Rpb24oc2NvcGUpIHsKCnZhciBTaGFkb3dDU1MgPSB7CiAgc3RyaWN0U3R5bGluZzogZmFsc2UsCiAgcmVnaXN0cnk6IHt9LAogIC8vIFNoaW0gc3R5bGVzIGZvciBhIGdpdmVuIHJvb3QgYXNzb2NpYXRlZCB3aXRoIGEgbmFtZSBhbmQgZXh0ZW5kc05hbWUKICAvLyAxLiBjYWNoZSByb290IHN0eWxlcyBieSBuYW1lCiAgLy8gMi4gb3B0aW9uYWxseSB0YWcgcm9vdCBub2RlcyB3aXRoIHNjb3BlIG5hbWUKICAvLyAzLiBzaGltIHBvbHlmaWxsIGRpcmVjdGl2ZXMgLyogQHBvbHlmaWxsICovIGFuZCAvKiBAcG9seWZpbGwtcnVsZSAqLwogIC8vIDQuIHNoaW0gOmhvc3QgYW5kIHNjb3BpbmcKICBzaGltU3R5bGluZzogZnVuY3Rpb24ocm9vdCwgbmFtZSwgZXh0ZW5kc05hbWUpIHsKICAgIHZhciBzY29wZVN0eWxlcyA9IHRoaXMucHJlcGFyZVJvb3Qocm9vdCwgbmFtZSwgZXh0ZW5kc05hbWUpOwogICAgdmFyIHR5cGVFeHRlbnNpb24gPSB0aGlzLmlzVHlwZUV4dGVuc2lvbihleHRlbmRzTmFtZSk7CiAgICB2YXIgc2NvcGVTZWxlY3RvciA9IHRoaXMubWFrZVNjb3BlU2VsZWN0b3IobmFtZSwgdHlwZUV4dGVuc2lvbik7CiAgICAvLyB1c2UgY2FjaGluZyB0byBtYWtlIHdvcmtpbmcgd2l0aCBzdHlsZXMgbm9kZXMgZWFzaWVyIGFuZCB0byBmYWNpbGl0YXRlCiAgICAvLyBsb29rdXAgb2YgZXh0ZW5kZWUKICAgIHZhciBjc3NUZXh0ID0gc3R5bGVzVG9Dc3NUZXh0KHNjb3BlU3R5bGVzLCB0cnVlKTsKICAgIGNzc1RleHQgPSB0aGlzLnNjb3BlQ3NzVGV4dChjc3NUZXh0LCBzY29wZVNlbGVjdG9yKTsKICAgIC8vIGNhY2hlIHNoaW1tZWQgY3NzIG9uIHJvb3QgZm9yIHVzZXIgZXh0ZW5zaWJpbGl0eQogICAgaWYgKHJvb3QpIHsKICAgICAgcm9vdC5zaGltbWVkU3R5bGUgPSBjc3NUZXh0OwogICAgfQogICAgLy8gYWRkIHN0eWxlIHRvIGRvY3VtZW50CiAgICB0aGlzLmFkZENzc1RvRG9jdW1lbnQoY3NzVGV4dCwgbmFtZSk7CiAgfSwKICAvKgogICogU2hpbSBhIHN0eWxlIGVsZW1lbnQgd2l0aCB0aGUgZ2l2ZW4gc2VsZWN0b3IuIFJldHVybnMgY3NzVGV4dCB0aGF0IGNhbgogICogYmUgaW5jbHVkZWQgaW4gdGhlIGRvY3VtZW50IHZpYSBXZWJDb21wb25lbnRzLlNoYWRvd0NTUy5hZGRDc3NUb0RvY3VtZW50KGNzcykuCiAgKi8KICBzaGltU3R5bGU6IGZ1bmN0aW9uKHN0eWxlLCBzZWxlY3RvcikgewogICAgcmV0dXJuIHRoaXMuc2hpbUNzc1RleHQoc3R5bGUudGV4dENvbnRlbnQsIHNlbGVjdG9yKTsKICB9LAogIC8qCiAgKiBTaGltIHNvbWUgY3NzVGV4dCB3aXRoIHRoZSBnaXZlbiBzZWxlY3Rvci4gUmV0dXJucyBjc3NUZXh0IHRoYXQgY2FuCiAgKiBiZSBpbmNsdWRlZCBpbiB0aGUgZG9jdW1lbnQgdmlhIFdlYkNvbXBvbmVudHMuU2hhZG93Q1NTLmFkZENzc1RvRG9jdW1lbnQoY3NzKS4KICAqLwogIHNoaW1Dc3NUZXh0OiBmdW5jdGlvbihjc3NUZXh0LCBzZWxlY3RvcikgewogICAgY3NzVGV4dCA9IHRoaXMuaW5zZXJ0RGlyZWN0aXZlcyhjc3NUZXh0KTsKICAgIHJldHVybiB0aGlzLnNjb3BlQ3NzVGV4dChjc3NUZXh0LCBzZWxlY3Rvcik7CiAgfSwKICBtYWtlU2NvcGVTZWxlY3RvcjogZnVuY3Rpb24obmFtZSwgdHlwZUV4dGVuc2lvbikgewogICAgaWYgKG5hbWUpIHsKICAgICAgcmV0dXJuIHR5cGVFeHRlbnNpb24gPyAnW2lzPScgKyBuYW1lICsgJ10nIDogbmFtZTsKICAgIH0KICAgIHJldHVybiAnJzsKICB9LAogIGlzVHlwZUV4dGVuc2lvbjogZnVuY3Rpb24oZXh0ZW5kc05hbWUpIHsKICAgIHJldHVybiBleHRlbmRzTmFtZSAmJiBleHRlbmRzTmFtZS5pbmRleE9mKCctJykgPCAwOwogIH0sCiAgcHJlcGFyZVJvb3Q6IGZ1bmN0aW9uKHJvb3QsIG5hbWUsIGV4dGVuZHNOYW1lKSB7CiAgICB2YXIgZGVmID0gdGhpcy5yZWdpc3RlclJvb3Qocm9vdCwgbmFtZSwgZXh0ZW5kc05hbWUpOwogICAgdGhpcy5yZXBsYWNlVGV4dEluU3R5bGVzKGRlZi5yb290U3R5bGVzLCB0aGlzLmluc2VydERpcmVjdGl2ZXMpOwogICAgLy8gcmVtb3ZlIGV4aXN0aW5nIHN0eWxlIGVsZW1lbnRzCiAgICB0aGlzLnJlbW92ZVN0eWxlcyhyb290LCBkZWYucm9vdFN0eWxlcyk7CiAgICAvLyBhcHBseSBzdHJpY3QgYXR0cgogICAgaWYgKHRoaXMuc3RyaWN0U3R5bGluZykgewogICAgICB0aGlzLmFwcGx5U2NvcGVUb0NvbnRlbnQocm9vdCwgbmFtZSk7CiAgICB9CiAgICByZXR1cm4gZGVmLnNjb3BlU3R5bGVzOwogIH0sCiAgcmVtb3ZlU3R5bGVzOiBmdW5jdGlvbihyb290LCBzdHlsZXMpIHsKICAgIGZvciAodmFyIGk9MCwgbD1zdHlsZXMubGVuZ3RoLCBzOyAoaTxsKSAmJiAocz1zdHlsZXNbaV0pOyBpKyspIHsKICAgICAgcy5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKHMpOwogICAgfQogIH0sCiAgcmVnaXN0ZXJSb290OiBmdW5jdGlvbihyb290LCBuYW1lLCBleHRlbmRzTmFtZSkgewogICAgdmFyIGRlZiA9IHRoaXMucmVnaXN0cnlbbmFtZV0gPSB7CiAgICAgIHJvb3Q6IHJvb3QsCiAgICAgIG5hbWU6IG5hbWUsCiAgICAgIGV4dGVuZHNOYW1lOiBleHRlbmRzTmFtZQogICAgfQogICAgdmFyIHN0eWxlcyA9IHRoaXMuZmluZFN0eWxlcyhyb290KTsKICAgIGRlZi5yb290U3R5bGVzID0gc3R5bGVzOwogICAgZGVmLnNjb3BlU3R5bGVzID0gZGVmLnJvb3RTdHlsZXM7CiAgICB2YXIgZXh0ZW5kZWUgPSB0aGlzLnJlZ2lzdHJ5W2RlZi5leHRlbmRzTmFtZV07CiAgICBpZiAoZXh0ZW5kZWUpIHsKICAgICAgZGVmLnNjb3BlU3R5bGVzID0gZXh0ZW5kZWUuc2NvcGVTdHlsZXMuY29uY2F0KGRlZi5zY29wZVN0eWxlcyk7CiAgICB9CiAgICByZXR1cm4gZGVmOwogIH0sCiAgZmluZFN0eWxlczogZnVuY3Rpb24ocm9vdCkgewogICAgaWYgKCFyb290KSB7CiAgICAgIHJldHVybiBbXTsKICAgIH0KICAgIHZhciBzdHlsZXMgPSByb290LnF1ZXJ5U2VsZWN0b3JBbGwoJ3N0eWxlJyk7CiAgICByZXR1cm4gQXJyYXkucHJvdG90eXBlLmZpbHRlci5jYWxsKHN0eWxlcywgZnVuY3Rpb24ocykgewogICAgICByZXR1cm4gIXMuaGFzQXR0cmlidXRlKE5PX1NISU1fQVRUUklCVVRFKTsKICAgIH0pOwogIH0sCiAgYXBwbHlTY29wZVRvQ29udGVudDogZnVuY3Rpb24ocm9vdCwgbmFtZSkgewogICAgaWYgKHJvb3QpIHsKICAgICAgLy8gYWRkIHRoZSBuYW1lIGF0dHJpYnV0ZSB0byBlYWNoIG5vZGUgaW4gcm9vdC4KICAgICAgQXJyYXkucHJvdG90eXBlLmZvckVhY2guY2FsbChyb290LnF1ZXJ5U2VsZWN0b3JBbGwoJyonKSwKICAgICAgICAgIGZ1bmN0aW9uKG5vZGUpIHsKICAgICAgICAgICAgbm9kZS5zZXRBdHRyaWJ1dGUobmFtZSwgJycpOwogICAgICAgICAgfSk7CiAgICAgIC8vIGFuZCB0ZW1wbGF0ZSBjb250ZW50cyB0b28KICAgICAgQXJyYXkucHJvdG90eXBlLmZvckVhY2guY2FsbChyb290LnF1ZXJ5U2VsZWN0b3JBbGwoJ3RlbXBsYXRlJyksCiAgICAgICAgICBmdW5jdGlvbih0ZW1wbGF0ZSkgewogICAgICAgICAgICB0aGlzLmFwcGx5U2NvcGVUb0NvbnRlbnQodGVtcGxhdGUuY29udGVudCwgbmFtZSk7CiAgICAgICAgICB9LAogICAgICAgICAgdGhpcyk7CiAgICB9CiAgfSwKICBpbnNlcnREaXJlY3RpdmVzOiBmdW5jdGlvbihjc3NUZXh0KSB7CiAgICBjc3NUZXh0ID0gdGhpcy5pbnNlcnRQb2x5ZmlsbERpcmVjdGl2ZXNJbkNzc1RleHQoY3NzVGV4dCk7CiAgICByZXR1cm4gdGhpcy5pbnNlcnRQb2x5ZmlsbFJ1bGVzSW5Dc3NUZXh0KGNzc1RleHQpOwogIH0sCiAgLyoKICAgKiBQcm9jZXNzIHN0eWxlcyB0byBjb252ZXJ0IG5hdGl2ZSBTaGFkb3dET00gcnVsZXMgdGhhdCB3aWxsIHRyaXAKICAgKiB1cCB0aGUgY3NzIHBhcnNlcjsgd2UgcmVseSBvbiBkZWNvcmF0aW5nIHRoZSBzdHlsZXNoZWV0IHdpdGggaW5lcnQgcnVsZXMuCiAgICogCiAgICogRm9yIGV4YW1wbGUsIHdlIGNvbnZlcnQgdGhpcyBydWxlOgogICAqIAogICAqIHBvbHlmaWxsLW5leHQtc2VsZWN0b3IgeyBjb250ZW50OiAnOmhvc3QgbWVudS1pdGVtJzsgfQogICAqIDo6Y29udGVudCBtZW51LWl0ZW0gewogICAqIAogICAqIHRvIHRoaXM6CiAgICogCiAgICogc2NvcGVOYW1lIG1lbnUtaXRlbSB7CiAgICoKICAqKi8KICBpbnNlcnRQb2x5ZmlsbERpcmVjdGl2ZXNJbkNzc1RleHQ6IGZ1bmN0aW9uKGNzc1RleHQpIHsKICAgIC8vIFRPRE8oc29ydmVsbCk6IHJlbW92ZSBlaXRoZXIgY29udGVudCBvciBjb21tZW50CiAgICBjc3NUZXh0ID0gY3NzVGV4dC5yZXBsYWNlKGNzc0NvbW1lbnROZXh0U2VsZWN0b3JSZSwgZnVuY3Rpb24obWF0Y2gsIHAxKSB7CiAgICAgIC8vIHJlbW92ZSBlbmQgY29tbWVudCBkZWxpbWl0ZXIgYW5kIGFkZCBibG9jayBzdGFydAogICAgICByZXR1cm4gcDEuc2xpY2UoMCwgLTIpICsgJ3snOwogICAgfSk7CiAgICByZXR1cm4gY3NzVGV4dC5yZXBsYWNlKGNzc0NvbnRlbnROZXh0U2VsZWN0b3JSZSwgZnVuY3Rpb24obWF0Y2gsIHAxKSB7CiAgICAgIHJldHVybiBwMSArICcgeyc7CiAgICB9KTsKICB9LAogIC8qCiAgICogUHJvY2VzcyBzdHlsZXMgdG8gYWRkIHJ1bGVzIHdoaWNoIHdpbGwgb25seSBhcHBseSB1bmRlciB0aGUgcG9seWZpbGwKICAgKiAKICAgKiBGb3IgZXhhbXBsZSwgd2UgY29udmVydCB0aGlzIHJ1bGU6CiAgICogCiAgICogcG9seWZpbGwtcnVsZSB7CiAgICogICBjb250ZW50OiAnOmhvc3QgbWVudS1pdGVtJzsKICAgKiAuLi4KICAgKiB9CiAgICogCiAgICogdG8gdGhpczoKICAgKiAKICAgKiBzY29wZU5hbWUgbWVudS1pdGVtIHsuLi59CiAgICoKICAqKi8KICBpbnNlcnRQb2x5ZmlsbFJ1bGVzSW5Dc3NUZXh0OiBmdW5jdGlvbihjc3NUZXh0KSB7CiAgICAvLyBUT0RPKHNvcnZlbGwpOiByZW1vdmUgZWl0aGVyIGNvbnRlbnQgb3IgY29tbWVudAogICAgY3NzVGV4dCA9IGNzc1RleHQucmVwbGFjZShjc3NDb21tZW50UnVsZVJlLCBmdW5jdGlvbihtYXRjaCwgcDEpIHsKICAgICAgLy8gcmVtb3ZlIGVuZCBjb21tZW50IGRlbGltaXRlcgogICAgICByZXR1cm4gcDEuc2xpY2UoMCwgLTEpOwogICAgfSk7CiAgICByZXR1cm4gY3NzVGV4dC5yZXBsYWNlKGNzc0NvbnRlbnRSdWxlUmUsIGZ1bmN0aW9uKG1hdGNoLCBwMSwgcDIsIHAzKSB7CiAgICAgIHZhciBydWxlID0gbWF0Y2gucmVwbGFjZShwMSwgJycpLnJlcGxhY2UocDIsICcnKTsKICAgICAgcmV0dXJuIHAzICsgcnVsZTsKICAgIH0pOwogIH0sCiAgLyogRW5zdXJlIHN0eWxlcyBhcmUgc2NvcGVkLiBQc2V1ZG8tc2NvcGluZyB0YWtlcyBhIHJ1bGUgbGlrZToKICAgKiAKICAgKiAgLmZvbyB7Li4uIH0gCiAgICogIAogICAqICBhbmQgY29udmVydHMgdGhpcyB0bwogICAqICAKICAgKiAgc2NvcGVOYW1lIC5mb28geyAuLi4gfQogICovCiAgc2NvcGVDc3NUZXh0OiBmdW5jdGlvbihjc3NUZXh0LCBzY29wZVNlbGVjdG9yKSB7CiAgICB2YXIgdW5zY29wZWQgPSB0aGlzLmV4dHJhY3RVbnNjb3BlZFJ1bGVzRnJvbUNzc1RleHQoY3NzVGV4dCk7CiAgICBjc3NUZXh0ID0gdGhpcy5pbnNlcnRQb2x5ZmlsbEhvc3RJbkNzc1RleHQoY3NzVGV4dCk7CiAgICBjc3NUZXh0ID0gdGhpcy5jb252ZXJ0Q29sb25Ib3N0KGNzc1RleHQpOwogICAgY3NzVGV4dCA9IHRoaXMuY29udmVydENvbG9uSG9zdENvbnRleHQoY3NzVGV4dCk7CiAgICBjc3NUZXh0ID0gdGhpcy5jb252ZXJ0U2hhZG93RE9NU2VsZWN0b3JzKGNzc1RleHQpOwogICAgaWYgKHNjb3BlU2VsZWN0b3IpIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzLCBjc3NUZXh0OwogICAgICB3aXRoQ3NzUnVsZXMoY3NzVGV4dCwgZnVuY3Rpb24ocnVsZXMpIHsKICAgICAgICBjc3NUZXh0ID0gc2VsZi5zY29wZVJ1bGVzKHJ1bGVzLCBzY29wZVNlbGVjdG9yKTsKICAgICAgfSk7CgogICAgfQogICAgY3NzVGV4dCA9IGNzc1RleHQgKyAnXG4nICsgdW5zY29wZWQ7CiAgICByZXR1cm4gY3NzVGV4dC50cmltKCk7CiAgfSwKICAvKgogICAqIFByb2Nlc3Mgc3R5bGVzIHRvIGFkZCBydWxlcyB3aGljaCB3aWxsIG9ubHkgYXBwbHkgdW5kZXIgdGhlIHBvbHlmaWxsCiAgICogYW5kIGRvIG5vdCBwcm9jZXNzIHZpYSBDU1NPTS4gKENTU09NIGlzIGRlc3RydWN0aXZlIHRvIHJ1bGVzIG9uIHJhcmUgCiAgICogb2NjYXNpb25zLCBlLmcuIC13ZWJraXQtY2FsYyBvbiBTYWZhcmkuKQogICAqIEZvciBleGFtcGxlLCB3ZSBjb252ZXJ0IHRoaXMgcnVsZToKICAgKiAKICAgKiAoY29tbWVudCBzdGFydCkgQHBvbHlmaWxsLXVuc2NvcGVkLXJ1bGUgbWVudS1pdGVtIHsgCiAgICogLi4uIH0gKGNvbW1lbnQgZW5kKQogICAqIAogICAqIHRvIHRoaXM6CiAgICogCiAgICogbWVudS1pdGVtIHsuLi59CiAgICoKICAqKi8KICBleHRyYWN0VW5zY29wZWRSdWxlc0Zyb21Dc3NUZXh0OiBmdW5jdGlvbihjc3NUZXh0KSB7CiAgICAvLyBUT0RPKHNvcnZlbGwpOiByZW1vdmUgZWl0aGVyIGNvbnRlbnQgb3IgY29tbWVudAogICAgdmFyIHIgPSAnJywgbTsKICAgIHdoaWxlIChtID0gY3NzQ29tbWVudFVuc2NvcGVkUnVsZVJlLmV4ZWMoY3NzVGV4dCkpIHsKICAgICAgciArPSBtWzFdLnNsaWNlKDAsIC0xKSArICdcblxuJzsKICAgIH0KICAgIHdoaWxlIChtID0gY3NzQ29udGVudFVuc2NvcGVkUnVsZVJlLmV4ZWMoY3NzVGV4dCkpIHsKICAgICAgciArPSBtWzBdLnJlcGxhY2UobVsyXSwgJycpLnJlcGxhY2UobVsxXSwgbVszXSkgKyAnXG5cbic7CiAgICB9CiAgICByZXR1cm4gcjsKICB9LAogIC8qCiAgICogY29udmVydCBhIHJ1bGUgbGlrZSA6aG9zdCguZm9vKSA+IC5iYXIgeyB9CiAgICoKICAgKiB0bwogICAqCiAgICogc2NvcGVOYW1lLmZvbyA+IC5iYXIKICAqLwogIGNvbnZlcnRDb2xvbkhvc3Q6IGZ1bmN0aW9uKGNzc1RleHQpIHsKICAgIHJldHVybiB0aGlzLmNvbnZlcnRDb2xvblJ1bGUoY3NzVGV4dCwgY3NzQ29sb25Ib3N0UmUsCiAgICAgICAgdGhpcy5jb2xvbkhvc3RQYXJ0UmVwbGFjZXIpOwogIH0sCiAgLyoKICAgKiBjb252ZXJ0IGEgcnVsZSBsaWtlIDpob3N0LWNvbnRleHQoLmZvbykgPiAuYmFyIHsgfQogICAqCiAgICogdG8KICAgKgogICAqIHNjb3BlTmFtZS5mb28gPiAuYmFyLCAuZm9vIHNjb3BlTmFtZSA+IC5iYXIgeyB9CiAgICogCiAgICogYW5kCiAgICoKICAgKiA6aG9zdC1jb250ZXh0KC5mb286aG9zdCkgLmJhciB7IC4uLiB9CiAgICogCiAgICogdG8KICAgKiAKICAgKiBzY29wZU5hbWUuZm9vIC5iYXIgeyAuLi4gfQogICovCiAgY29udmVydENvbG9uSG9zdENvbnRleHQ6IGZ1bmN0aW9uKGNzc1RleHQpIHsKICAgIHJldHVybiB0aGlzLmNvbnZlcnRDb2xvblJ1bGUoY3NzVGV4dCwgY3NzQ29sb25Ib3N0Q29udGV4dFJlLAogICAgICAgIHRoaXMuY29sb25Ib3N0Q29udGV4dFBhcnRSZXBsYWNlcik7CiAgfSwKICBjb252ZXJ0Q29sb25SdWxlOiBmdW5jdGlvbihjc3NUZXh0LCByZWdFeHAsIHBhcnRSZXBsYWNlcikgewogICAgLy8gcDEgPSA6aG9zdCwgcDIgPSBjb250ZW50cyBvZiAoKSwgcDMgcmVzdCBvZiBydWxlCiAgICByZXR1cm4gY3NzVGV4dC5yZXBsYWNlKHJlZ0V4cCwgZnVuY3Rpb24obSwgcDEsIHAyLCBwMykgewogICAgICBwMSA9IHBvbHlmaWxsSG9zdE5vQ29tYmluYXRvcjsKICAgICAgaWYgKHAyKSB7CiAgICAgICAgdmFyIHBhcnRzID0gcDIuc3BsaXQoJywnKSwgciA9IFtdOwogICAgICAgIGZvciAodmFyIGk9MCwgbD1wYXJ0cy5sZW5ndGgsIHA7IChpPGwpICYmIChwPXBhcnRzW2ldKTsgaSsrKSB7CiAgICAgICAgICBwID0gcC50cmltKCk7CiAgICAgICAgICByLnB1c2gocGFydFJlcGxhY2VyKHAxLCBwLCBwMykpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gci5qb2luKCcsJyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIHAxICsgcDM7CiAgICAgIH0KICAgIH0pOwogIH0sCiAgY29sb25Ib3N0Q29udGV4dFBhcnRSZXBsYWNlcjogZnVuY3Rpb24oaG9zdCwgcGFydCwgc3VmZml4KSB7CiAgICBpZiAocGFydC5tYXRjaChwb2x5ZmlsbEhvc3QpKSB7CiAgICAgIHJldHVybiB0aGlzLmNvbG9uSG9zdFBhcnRSZXBsYWNlcihob3N0LCBwYXJ0LCBzdWZmaXgpOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIGhvc3QgKyBwYXJ0ICsgc3VmZml4ICsgJywgJyArIHBhcnQgKyAnICcgKyBob3N0ICsgc3VmZml4OwogICAgfQogIH0sCiAgY29sb25Ib3N0UGFydFJlcGxhY2VyOiBmdW5jdGlvbihob3N0LCBwYXJ0LCBzdWZmaXgpIHsKICAgIHJldHVybiBob3N0ICsgcGFydC5yZXBsYWNlKHBvbHlmaWxsSG9zdCwgJycpICsgc3VmZml4OwogIH0sCiAgLyoKICAgKiBDb252ZXJ0IGNvbWJpbmF0b3JzIGxpa2UgOjpzaGFkb3cgYW5kIHBzZXVkby1lbGVtZW50cyBsaWtlIDo6Y29udGVudAogICAqIGJ5IHJlcGxhY2luZyB3aXRoIHNwYWNlLgogICovCiAgY29udmVydFNoYWRvd0RPTVNlbGVjdG9yczogZnVuY3Rpb24oY3NzVGV4dCkgewogICAgZm9yICh2YXIgaT0wOyBpIDwgc2hhZG93RE9NU2VsZWN0b3JzUmUubGVuZ3RoOyBpKyspIHsKICAgICAgY3NzVGV4dCA9IGNzc1RleHQucmVwbGFjZShzaGFkb3dET01TZWxlY3RvcnNSZVtpXSwgJyAnKTsKICAgIH0KICAgIHJldHVybiBjc3NUZXh0OwogIH0sCiAgLy8gY2hhbmdlIGEgc2VsZWN0b3IgbGlrZSAnZGl2JyB0byAnbmFtZSBkaXYnCiAgc2NvcGVSdWxlczogZnVuY3Rpb24oY3NzUnVsZXMsIHNjb3BlU2VsZWN0b3IpIHsKICAgIHZhciBjc3NUZXh0ID0gJyc7CiAgICBpZiAoY3NzUnVsZXMpIHsKICAgICAgQXJyYXkucHJvdG90eXBlLmZvckVhY2guY2FsbChjc3NSdWxlcywgZnVuY3Rpb24ocnVsZSkgewogICAgICAgIGlmIChydWxlLnNlbGVjdG9yVGV4dCAmJiAocnVsZS5zdHlsZSAmJiBydWxlLnN0eWxlLmNzc1RleHQgIT09IHVuZGVmaW5lZCkpIHsKICAgICAgICAgIGNzc1RleHQgKz0gdGhpcy5zY29wZVNlbGVjdG9yKHJ1bGUuc2VsZWN0b3JUZXh0LCBzY29wZVNlbGVjdG9yLCAKICAgICAgICAgICAgdGhpcy5zdHJpY3RTdHlsaW5nKSArICcge1xuXHQnOwogICAgICAgICAgY3NzVGV4dCArPSB0aGlzLnByb3BlcnRpZXNGcm9tUnVsZShydWxlKSArICdcbn1cblxuJzsKICAgICAgICB9IGVsc2UgaWYgKHJ1bGUudHlwZSA9PT0gQ1NTUnVsZS5NRURJQV9SVUxFKSB7CiAgICAgICAgICBjc3NUZXh0ICs9ICdAbWVkaWEgJyArIHJ1bGUubWVkaWEubWVkaWFUZXh0ICsgJyB7XG4nOwogICAgICAgICAgY3NzVGV4dCArPSB0aGlzLnNjb3BlUnVsZXMocnVsZS5jc3NSdWxlcywgc2NvcGVTZWxlY3Rvcik7CiAgICAgICAgICBjc3NUZXh0ICs9ICdcbn1cblxuJzsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgLy8gS0VZRlJBTUVTX1JVTEUgaW4gSUUgdGhyb3dzIHdoZW4gd2UgcXVlcnkgY3NzVGV4dAogICAgICAgICAgLy8gd2hlbiBpdCBjb250YWlucyBhIC13ZWJraXQtIHByb3BlcnR5LgogICAgICAgICAgLy8gaWYgdGhpcyBoYXBwZW5zLCB3ZSBmYWxsYmFjayB0byBjb25zdHJ1Y3RpbmcgdGhlIHJ1bGUKICAgICAgICAgIC8vIGZyb20gdGhlIENTU1J1bGVTZXQKICAgICAgICAgIC8vIGh0dHBzOi8vY29ubmVjdC5taWNyb3NvZnQuY29tL0lFL2ZlZWRiYWNrZGV0YWlsL3ZpZXcvOTU1NzAzL2FjY2Vzc2luZy1jc3N0ZXh0LW9mLWEta2V5ZnJhbWUtcnVsZS10aGF0LWNvbnRhaW5zLWEtd2Via2l0LXByb3BlcnR5LXZpYS1jc3NvbS1nZW5lcmF0ZXMtZXhjZXB0aW9uCiAgICAgICAgICB0cnkgewogICAgICAgICAgICBpZiAocnVsZS5jc3NUZXh0KSB7CiAgICAgICAgICAgICAgY3NzVGV4dCArPSBydWxlLmNzc1RleHQgKyAnXG5cbic7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gY2F0Y2goeCkgewogICAgICAgICAgICBpZiAocnVsZS50eXBlID09PSBDU1NSdWxlLktFWUZSQU1FU19SVUxFICYmIHJ1bGUuY3NzUnVsZXMpIHsKICAgICAgICAgICAgICBjc3NUZXh0ICs9IHRoaXMuaWVTYWZlQ3NzVGV4dEZyb21LZXlGcmFtZVJ1bGUocnVsZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sIHRoaXMpOwogICAgfQogICAgcmV0dXJuIGNzc1RleHQ7CiAgfSwKICBpZVNhZmVDc3NUZXh0RnJvbUtleUZyYW1lUnVsZTogZnVuY3Rpb24ocnVsZSkgewogICAgdmFyIGNzc1RleHQgPSAnQGtleWZyYW1lcyAnICsgcnVsZS5uYW1lICsgJyB7JzsKICAgIEFycmF5LnByb3RvdHlwZS5mb3JFYWNoLmNhbGwocnVsZS5jc3NSdWxlcywgZnVuY3Rpb24ocnVsZSkgewogICAgICBjc3NUZXh0ICs9ICcgJyArIHJ1bGUua2V5VGV4dCArICcgeycgKyBydWxlLnN0eWxlLmNzc1RleHQgKyAnfSc7CiAgICB9KTsKICAgIGNzc1RleHQgKz0gJyB9JzsKICAgIHJldHVybiBjc3NUZXh0OwogIH0sCiAgc2NvcGVTZWxlY3RvcjogZnVuY3Rpb24oc2VsZWN0b3IsIHNjb3BlU2VsZWN0b3IsIHN0cmljdCkgewogICAgdmFyIHIgPSBbXSwgcGFydHMgPSBzZWxlY3Rvci5zcGxpdCgnLCcpOwogICAgcGFydHMuZm9yRWFjaChmdW5jdGlvbihwKSB7CiAgICAgIHAgPSBwLnRyaW0oKTsKICAgICAgaWYgKHRoaXMuc2VsZWN0b3JOZWVkc1Njb3BpbmcocCwgc2NvcGVTZWxlY3RvcikpIHsKICAgICAgICBwID0gKHN0cmljdCAmJiAhcC5tYXRjaChwb2x5ZmlsbEhvc3ROb0NvbWJpbmF0b3IpKSA/IAogICAgICAgICAgICB0aGlzLmFwcGx5U3RyaWN0U2VsZWN0b3JTY29wZShwLCBzY29wZVNlbGVjdG9yKSA6CiAgICAgICAgICAgIHRoaXMuYXBwbHlTZWxlY3RvclNjb3BlKHAsIHNjb3BlU2VsZWN0b3IpOwogICAgICB9CiAgICAgIHIucHVzaChwKTsKICAgIH0sIHRoaXMpOwogICAgcmV0dXJuIHIuam9pbignLCAnKTsKICB9LAogIHNlbGVjdG9yTmVlZHNTY29waW5nOiBmdW5jdGlvbihzZWxlY3Rvciwgc2NvcGVTZWxlY3RvcikgewogICAgaWYgKEFycmF5LmlzQXJyYXkoc2NvcGVTZWxlY3RvcikpIHsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICB2YXIgcmUgPSB0aGlzLm1ha2VTY29wZU1hdGNoZXIoc2NvcGVTZWxlY3Rvcik7CiAgICByZXR1cm4gIXNlbGVjdG9yLm1hdGNoKHJlKTsKICB9LAogIG1ha2VTY29wZU1hdGNoZXI6IGZ1bmN0aW9uKHNjb3BlU2VsZWN0b3IpIHsKICAgIHNjb3BlU2VsZWN0b3IgPSBzY29wZVNlbGVjdG9yLnJlcGxhY2UoL1xbL2csICdcXFsnKS5yZXBsYWNlKC9cWy9nLCAnXFxdJyk7CiAgICByZXR1cm4gbmV3IFJlZ0V4cCgnXignICsgc2NvcGVTZWxlY3RvciArICcpJyArIHNlbGVjdG9yUmVTdWZmaXgsICdtJyk7CiAgfSwKICBhcHBseVNlbGVjdG9yU2NvcGU6IGZ1bmN0aW9uKHNlbGVjdG9yLCBzZWxlY3RvclNjb3BlKSB7CiAgICByZXR1cm4gQXJyYXkuaXNBcnJheShzZWxlY3RvclNjb3BlKSA/CiAgICAgICAgdGhpcy5hcHBseVNlbGVjdG9yU2NvcGVMaXN0KHNlbGVjdG9yLCBzZWxlY3RvclNjb3BlKSA6CiAgICAgICAgdGhpcy5hcHBseVNpbXBsZVNlbGVjdG9yU2NvcGUoc2VsZWN0b3IsIHNlbGVjdG9yU2NvcGUpOwogIH0sCiAgLy8gYXBwbHkgYW4gYXJyYXkgb2Ygc2VsZWN0b3JzCiAgYXBwbHlTZWxlY3RvclNjb3BlTGlzdDogZnVuY3Rpb24oc2VsZWN0b3IsIHNjb3BlU2VsZWN0b3JMaXN0KSB7CiAgICB2YXIgciA9IFtdOwogICAgZm9yICh2YXIgaT0wLCBzOyAocz1zY29wZVNlbGVjdG9yTGlzdFtpXSk7IGkrKykgewogICAgICByLnB1c2godGhpcy5hcHBseVNpbXBsZVNlbGVjdG9yU2NvcGUoc2VsZWN0b3IsIHMpKTsKICAgIH0KICAgIHJldHVybiByLmpvaW4oJywgJyk7CiAgfSwKICAvLyBzY29wZSB2aWEgbmFtZSBhbmQgW2lzPW5hbWVdCiAgYXBwbHlTaW1wbGVTZWxlY3RvclNjb3BlOiBmdW5jdGlvbihzZWxlY3Rvciwgc2NvcGVTZWxlY3RvcikgewogICAgaWYgKHNlbGVjdG9yLm1hdGNoKHBvbHlmaWxsSG9zdFJlKSkgewogICAgICBzZWxlY3RvciA9IHNlbGVjdG9yLnJlcGxhY2UocG9seWZpbGxIb3N0Tm9Db21iaW5hdG9yLCBzY29wZVNlbGVjdG9yKTsKICAgICAgcmV0dXJuIHNlbGVjdG9yLnJlcGxhY2UocG9seWZpbGxIb3N0UmUsIHNjb3BlU2VsZWN0b3IgKyAnICcpOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIHNjb3BlU2VsZWN0b3IgKyAnICcgKyBzZWxlY3RvcjsKICAgIH0KICB9LAogIC8vIHJldHVybiBhIHNlbGVjdG9yIHdpdGggW25hbWVdIHN1ZmZpeCBvbiBlYWNoIHNpbXBsZSBzZWxlY3RvcgogIC8vIGUuZy4gLmZvby5iYXIgPiAuem90IGJlY29tZXMgLmZvb1tuYW1lXS5iYXJbbmFtZV0gPiAuem90W25hbWVdCiAgYXBwbHlTdHJpY3RTZWxlY3RvclNjb3BlOiBmdW5jdGlvbihzZWxlY3Rvciwgc2NvcGVTZWxlY3RvcikgewogICAgc2NvcGVTZWxlY3RvciA9IHNjb3BlU2VsZWN0b3IucmVwbGFjZSgvXFtpcz0oW15cXV0qKVxdL2csICckMScpOwogICAgdmFyIHNwbGl0cyA9IFsnICcsICc+JywgJysnLCAnfiddLAogICAgICBzY29wZWQgPSBzZWxlY3RvciwKICAgICAgYXR0ck5hbWUgPSAnWycgKyBzY29wZVNlbGVjdG9yICsgJ10nOwogICAgc3BsaXRzLmZvckVhY2goZnVuY3Rpb24oc2VwKSB7CiAgICAgIHZhciBwYXJ0cyA9IHNjb3BlZC5zcGxpdChzZXApOwogICAgICBzY29wZWQgPSBwYXJ0cy5tYXAoZnVuY3Rpb24ocCkgewogICAgICAgIC8vIHJlbW92ZSA6aG9zdCBzaW5jZSBpdCBzaG91bGQgYmUgdW5uZWNlc3NhcnkKICAgICAgICB2YXIgdCA9IHAudHJpbSgpLnJlcGxhY2UocG9seWZpbGxIb3N0UmUsICcnKTsKICAgICAgICBpZiAodCAmJiAoc3BsaXRzLmluZGV4T2YodCkgPCAwKSAmJiAodC5pbmRleE9mKGF0dHJOYW1lKSA8IDApKSB7CiAgICAgICAgICBwID0gdC5yZXBsYWNlKC8oW146XSopKDoqKSguKikvLCAnJDEnICsgYXR0ck5hbWUgKyAnJDIkMycpCiAgICAgICAgfQogICAgICAgIHJldHVybiBwOwogICAgICB9KS5qb2luKHNlcCk7CiAgICB9KTsKICAgIHJldHVybiBzY29wZWQ7CiAgfSwKICBpbnNlcnRQb2x5ZmlsbEhvc3RJbkNzc1RleHQ6IGZ1bmN0aW9uKHNlbGVjdG9yKSB7CiAgICByZXR1cm4gc2VsZWN0b3IucmVwbGFjZShjb2xvbkhvc3RDb250ZXh0UmUsIHBvbHlmaWxsSG9zdENvbnRleHQpLnJlcGxhY2UoCiAgICAgICAgY29sb25Ib3N0UmUsIHBvbHlmaWxsSG9zdCk7CiAgfSwKICBwcm9wZXJ0aWVzRnJvbVJ1bGU6IGZ1bmN0aW9uKHJ1bGUpIHsKICAgIHZhciBjc3NUZXh0ID0gcnVsZS5zdHlsZS5jc3NUZXh0OwogICAgLy8gVE9ETyhzb3J2ZWxsKTogU2FmYXJpIGNzc29tIGluY29ycmVjdGx5IHJlbW92ZXMgcXVvdGVzIGZyb20gdGhlIGNvbnRlbnQKICAgIC8vIHByb3BlcnR5LiAoaHR0cHM6Ly9idWdzLndlYmtpdC5vcmcvc2hvd19idWcuY2dpP2lkPTExODA0NSkKICAgIC8vIGRvbid0IHJlcGxhY2UgYXR0ciBydWxlcwogICAgaWYgKHJ1bGUuc3R5bGUuY29udGVudCAmJiAhcnVsZS5zdHlsZS5jb250ZW50Lm1hdGNoKC9bJyJdK3xhdHRyLykpIHsKICAgICAgY3NzVGV4dCA9IGNzc1RleHQucmVwbGFjZSgvY29udGVudDpbXjtdKjsvZywgJ2NvbnRlbnQ6IFwnJyArIAogICAgICAgICAgcnVsZS5zdHlsZS5jb250ZW50ICsgJ1wnOycpOwogICAgfQogICAgLy8gVE9ETyhzb3J2ZWxsKTogd2UgY2FuIHdvcmthcm91bmQgdGhpcyBpc3N1ZSBoZXJlLCBidXQgd2UgbmVlZCBhIGxpc3QKICAgIC8vIG9mIHRyb3VibGVzb21lIHByb3BlcnRpZXMgdG8gZml4IGh0dHBzOi8vZ2l0aHViLmNvbS9Qb2x5bWVyL3BsYXRmb3JtL2lzc3Vlcy81MwogICAgLy8KICAgIC8vIGluaGVyaXQgcnVsZXMgY2FuIGJlIG9taXR0ZWQgZnJvbSBjc3NUZXh0CiAgICAvLyBUT0RPKHNvcnZlbGwpOiByZW1vdmUgd2hlbiBCbGluayBidWcgaXMgZml4ZWQ6CiAgICAvLyBodHRwczovL2NvZGUuZ29vZ2xlLmNvbS9wL2Nocm9taXVtL2lzc3Vlcy9kZXRhaWw/aWQ9MzU4MjczCiAgICB2YXIgc3R5bGUgPSBydWxlLnN0eWxlOwogICAgZm9yICh2YXIgaSBpbiBzdHlsZSkgewogICAgICBpZiAoc3R5bGVbaV0gPT09ICdpbml0aWFsJykgewogICAgICAgIGNzc1RleHQgKz0gaSArICc6IGluaXRpYWw7ICc7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBjc3NUZXh0OwogIH0sCiAgcmVwbGFjZVRleHRJblN0eWxlczogZnVuY3Rpb24oc3R5bGVzLCBhY3Rpb24pIHsKICAgIGlmIChzdHlsZXMgJiYgYWN0aW9uKSB7CiAgICAgIGlmICghKHN0eWxlcyBpbnN0YW5jZW9mIEFycmF5KSkgewogICAgICAgIHN0eWxlcyA9IFtzdHlsZXNdOwogICAgICB9CiAgICAgIEFycmF5LnByb3RvdHlwZS5mb3JFYWNoLmNhbGwoc3R5bGVzLCBmdW5jdGlvbihzKSB7CiAgICAgICAgcy50ZXh0Q29udGVudCA9IGFjdGlvbi5jYWxsKHRoaXMsIHMudGV4dENvbnRlbnQpOwogICAgICB9LCB0aGlzKTsKICAgIH0KICB9LAogIGFkZENzc1RvRG9jdW1lbnQ6IGZ1bmN0aW9uKGNzc1RleHQsIG5hbWUpIHsKICAgIGlmIChjc3NUZXh0Lm1hdGNoKCdAaW1wb3J0JykpIHsKICAgICAgYWRkT3duU2hlZXQoY3NzVGV4dCwgbmFtZSk7CiAgICB9IGVsc2UgewogICAgICBhZGRDc3NUb0RvY3VtZW50KGNzc1RleHQpOwogICAgfQogIH0KfTsKCnZhciBzZWxlY3RvclJlID0gLyhbXntdKikoe1tcc1xTXSo/fSkvZ2ltLAogICAgY3NzQ29tbWVudFJlID0gL1wvXCpbXipdKlwqKyhbXi8qXVteKl0qXCorKSpcLy9naW0sCiAgICAvLyBUT0RPKHNvcnZlbGwpOiByZW1vdmUgZWl0aGVyIGNvbnRlbnQgb3IgY29tbWVudAogICAgY3NzQ29tbWVudE5leHRTZWxlY3RvclJlID0gL1wvXCpccypAcG9seWZpbGwgKFteKl0qXCorKFteLypdW14qXSpcKispKlwvKShbXntdKj8pey9naW0sCiAgICBjc3NDb250ZW50TmV4dFNlbGVjdG9yUmUgPSAvcG9seWZpbGwtbmV4dC1zZWxlY3RvcltefV0qY29udGVudFw6W1xzXSo/WyciXSguKj8pWyciXVs7XHNdKn0oW157XSo/KXsvZ2ltLCAgCiAgICAvLyBUT0RPKHNvcnZlbGwpOiByZW1vdmUgZWl0aGVyIGNvbnRlbnQgb3IgY29tbWVudAogICAgY3NzQ29tbWVudFJ1bGVSZSA9IC9cL1wqXHNAcG9seWZpbGwtcnVsZShbXipdKlwqKyhbXi8qXVteKl0qXCorKSopXC8vZ2ltLAogICAgY3NzQ29udGVudFJ1bGVSZSA9IC8ocG9seWZpbGwtcnVsZSlbXn1dKihjb250ZW50XDpbXHNdKlsnIl0oLio/KVsnIl0pWztcc10qW159XSp9L2dpbSwKICAgIC8vIFRPRE8oc29ydmVsbCk6IHJlbW92ZSBlaXRoZXIgY29udGVudCBvciBjb21tZW50CiAgICBjc3NDb21tZW50VW5zY29wZWRSdWxlUmUgPSAvXC9cKlxzQHBvbHlmaWxsLXVuc2NvcGVkLXJ1bGUoW14qXSpcKisoW14vKl1bXipdKlwqKykqKVwvL2dpbSwKICAgIGNzc0NvbnRlbnRVbnNjb3BlZFJ1bGVSZSA9IC8ocG9seWZpbGwtdW5zY29wZWQtcnVsZSlbXn1dKihjb250ZW50XDpbXHNdKlsnIl0oLio/KVsnIl0pWztcc10qW159XSp9L2dpbSwKICAgIGNzc1BzZXVkb1JlID0gLzo6KHgtW15cc3ssKF0qKS9naW0sCiAgICBjc3NQYXJ0UmUgPSAvOjpwYXJ0XCgoW14pXSopXCkvZ2ltLAogICAgLy8gbm90ZTogOmhvc3QgcHJlLXByb2Nlc3NlZCB0byAtc2hhZG93Y3NzaG9zdC4KICAgIHBvbHlmaWxsSG9zdCA9ICctc2hhZG93Y3NzaG9zdCcsCiAgICAvLyBub3RlOiA6aG9zdC1jb250ZXh0IHByZS1wcm9jZXNzZWQgdG8gLXNoYWRvd2Nzc2hvc3Rjb250ZXh0LgogICAgcG9seWZpbGxIb3N0Q29udGV4dCA9ICctc2hhZG93Y3NzY29udGV4dCcsCiAgICBwYXJlblN1ZmZpeCA9ICcpKD86XFwoKCcgKwogICAgICAgICcoPzpcXChbXikoXSpcXCl8W14pKF0qKSs/JyArCiAgICAgICAgJylcXCkpPyhbXix7XSopJzsKICAgIHZhciBjc3NDb2xvbkhvc3RSZSA9IG5ldyBSZWdFeHAoJygnICsgcG9seWZpbGxIb3N0ICsgcGFyZW5TdWZmaXgsICdnaW0nKSwKICAgIGNzc0NvbG9uSG9zdENvbnRleHRSZSA9IG5ldyBSZWdFeHAoJygnICsgcG9seWZpbGxIb3N0Q29udGV4dCArIHBhcmVuU3VmZml4LCAnZ2ltJyksCiAgICBzZWxlY3RvclJlU3VmZml4ID0gJyhbPlxcc34rXFsuLHs6XVtcXHNcXFNdKik/JCcsCiAgICBjb2xvbkhvc3RSZSA9IC9cOmhvc3QvZ2ltLAogICAgY29sb25Ib3N0Q29udGV4dFJlID0gL1w6aG9zdC1jb250ZXh0L2dpbSwKICAgIC8qIGhvc3QgbmFtZSB3aXRob3V0IGNvbWJpbmF0b3IgKi8KICAgIHBvbHlmaWxsSG9zdE5vQ29tYmluYXRvciA9IHBvbHlmaWxsSG9zdCArICctbm8tY29tYmluYXRvcicsCiAgICBwb2x5ZmlsbEhvc3RSZSA9IG5ldyBSZWdFeHAocG9seWZpbGxIb3N0LCAnZ2ltJyksCiAgICBwb2x5ZmlsbEhvc3RDb250ZXh0UmUgPSBuZXcgUmVnRXhwKHBvbHlmaWxsSG9zdENvbnRleHQsICdnaW0nKSwKICAgIHNoYWRvd0RPTVNlbGVjdG9yc1JlID0gWwogICAgICAvXF5cXi9nLAogICAgICAvXF4vZywKICAgICAgL1wvc2hhZG93XC8vZywKICAgICAgL1wvc2hhZG93LWRlZXBcLy9nLAogICAgICAvOjpzaGFkb3cvZywKICAgICAgL1wvZGVlcFwvL2csCiAgICAgIC86OmNvbnRlbnQvZwogICAgXTsKCmZ1bmN0aW9uIHN0eWxlc1RvQ3NzVGV4dChzdHlsZXMsIHByZXNlcnZlQ29tbWVudHMpIHsKICB2YXIgY3NzVGV4dCA9ICcnOwogIEFycmF5LnByb3RvdHlwZS5mb3JFYWNoLmNhbGwoc3R5bGVzLCBmdW5jdGlvbihzKSB7CiAgICBjc3NUZXh0ICs9IHMudGV4dENvbnRlbnQgKyAnXG5cbic7CiAgfSk7CiAgLy8gc3RyaXAgY29tbWVudHMgZm9yIGVhc2llciBwcm9jZXNzaW5nCiAgaWYgKCFwcmVzZXJ2ZUNvbW1lbnRzKSB7CiAgICBjc3NUZXh0ID0gY3NzVGV4dC5yZXBsYWNlKGNzc0NvbW1lbnRSZSwgJycpOwogIH0KICByZXR1cm4gY3NzVGV4dDsKfQoKZnVuY3Rpb24gY3NzVGV4dFRvU3R5bGUoY3NzVGV4dCkgewogIHZhciBzdHlsZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3N0eWxlJyk7CiAgc3R5bGUudGV4dENvbnRlbnQgPSBjc3NUZXh0OwogIHJldHVybiBzdHlsZTsKfQoKZnVuY3Rpb24gY3NzVG9SdWxlcyhjc3NUZXh0KSB7CiAgdmFyIHN0eWxlID0gY3NzVGV4dFRvU3R5bGUoY3NzVGV4dCk7CiAgZG9jdW1lbnQuaGVhZC5hcHBlbmRDaGlsZChzdHlsZSk7CiAgdmFyIHJ1bGVzID0gW107CiAgaWYgKHN0eWxlLnNoZWV0KSB7CiAgICAvLyBUT0RPKHNvcnZlbGwpOiBGaXJlZm94IHRocm93cyB3aGVuIGFjY2Vzc2luZyB0aGUgcnVsZXMgb2YgYSBzdHlsZXNoZWV0CiAgICAvLyB3aXRoIGFuIEBpbXBvcnQKICAgIC8vIGh0dHBzOi8vYnVnemlsbGEubW96aWxsYS5vcmcvc2hvd19idWcuY2dpP2lkPTYyNTAxMwogICAgdHJ5IHsKICAgICAgcnVsZXMgPSBzdHlsZS5zaGVldC5jc3NSdWxlczsKICAgIH0gY2F0Y2goZSkgewogICAgICAvLwogICAgfQogIH0gZWxzZSB7CiAgICBjb25zb2xlLndhcm4oJ3NoZWV0IG5vdCBmb3VuZCcsIHN0eWxlKTsKICB9CiAgc3R5bGUucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChzdHlsZSk7CiAgcmV0dXJuIHJ1bGVzOwp9Cgp2YXIgZnJhbWUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdpZnJhbWUnKTsKZnJhbWUuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKCmZ1bmN0aW9uIGluaXRGcmFtZSgpIHsKICBmcmFtZS5pbml0aWFsaXplZCA9IHRydWU7CiAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChmcmFtZSk7CiAgdmFyIGRvYyA9IGZyYW1lLmNvbnRlbnREb2N1bWVudDsKICB2YXIgYmFzZSA9IGRvYy5jcmVhdGVFbGVtZW50KCdiYXNlJyk7CiAgYmFzZS5ocmVmID0gZG9jdW1lbnQuYmFzZVVSSTsKICBkb2MuaGVhZC5hcHBlbmRDaGlsZChiYXNlKTsKfQoKZnVuY3Rpb24gaW5GcmFtZShmbikgewogIGlmICghZnJhbWUuaW5pdGlhbGl6ZWQpIHsKICAgIGluaXRGcmFtZSgpOwogIH0KICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKGZyYW1lKTsKICBmbihmcmFtZS5jb250ZW50RG9jdW1lbnQpOwogIGRvY3VtZW50LmJvZHkucmVtb3ZlQ2hpbGQoZnJhbWUpOwp9CgovLyBUT0RPKHNvcnZlbGwpOiB1c2UgYW4gaWZyYW1lIGlmIHRoZSBjc3NUZXh0IGNvbnRhaW5zIGFuIEBpbXBvcnQgdG8gd29ya2Fyb3VuZAovLyBodHRwczovL2NvZGUuZ29vZ2xlLmNvbS9wL2Nocm9taXVtL2lzc3Vlcy9kZXRhaWw/aWQ9MzQ1MTE0CnZhciBpc0Nocm9tZSA9IG5hdmlnYXRvci51c2VyQWdlbnQubWF0Y2goJ0Nocm9tZScpOwpmdW5jdGlvbiB3aXRoQ3NzUnVsZXMoY3NzVGV4dCwgY2FsbGJhY2spIHsKICBpZiAoIWNhbGxiYWNrKSB7CiAgICByZXR1cm47CiAgfQogIHZhciBydWxlczsKICBpZiAoY3NzVGV4dC5tYXRjaCgnQGltcG9ydCcpICYmIGlzQ2hyb21lKSB7CiAgICB2YXIgc3R5bGUgPSBjc3NUZXh0VG9TdHlsZShjc3NUZXh0KTsKICAgIGluRnJhbWUoZnVuY3Rpb24oZG9jKSB7CiAgICAgIGRvYy5oZWFkLmFwcGVuZENoaWxkKHN0eWxlLmltcGwpOwogICAgICBydWxlcyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKHN0eWxlLnNoZWV0LmNzc1J1bGVzLCAwKTsKICAgICAgY2FsbGJhY2socnVsZXMpOwogICAgfSk7CiAgfSBlbHNlIHsKICAgIHJ1bGVzID0gY3NzVG9SdWxlcyhjc3NUZXh0KTsKICAgIGNhbGxiYWNrKHJ1bGVzKTsKICB9Cn0KCmZ1bmN0aW9uIHJ1bGVzVG9Dc3MoY3NzUnVsZXMpIHsKICBmb3IgKHZhciBpPTAsIGNzcz1bXTsgaSA8IGNzc1J1bGVzLmxlbmd0aDsgaSsrKSB7CiAgICBjc3MucHVzaChjc3NSdWxlc1tpXS5jc3NUZXh0KTsKICB9CiAgcmV0dXJuIGNzcy5qb2luKCdcblxuJyk7Cn0KCmZ1bmN0aW9uIGFkZENzc1RvRG9jdW1lbnQoY3NzVGV4dCkgewogIGlmIChjc3NUZXh0KSB7CiAgICBnZXRTaGVldCgpLmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKGNzc1RleHQpKTsKICB9Cn0KCmZ1bmN0aW9uIGFkZE93blNoZWV0KGNzc1RleHQsIG5hbWUpIHsKICB2YXIgc3R5bGUgPSBjc3NUZXh0VG9TdHlsZShjc3NUZXh0KTsKICBzdHlsZS5zZXRBdHRyaWJ1dGUobmFtZSwgJycpOwogIHN0eWxlLnNldEF0dHJpYnV0ZShTSElNTUVEX0FUVFJJQlVURSwgJycpOwogIGRvY3VtZW50LmhlYWQuYXBwZW5kQ2hpbGQoc3R5bGUpOwp9Cgp2YXIgU0hJTV9BVFRSSUJVVEUgPSAnc2hpbS1zaGFkb3dkb20nOwp2YXIgU0hJTU1FRF9BVFRSSUJVVEUgPSAnc2hpbS1zaGFkb3dkb20tY3NzJzsKdmFyIE5PX1NISU1fQVRUUklCVVRFID0gJ25vLXNoaW0nOwoKdmFyIHNoZWV0OwpmdW5jdGlvbiBnZXRTaGVldCgpIHsKICBpZiAoIXNoZWV0KSB7CiAgICBzaGVldCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInN0eWxlIik7CiAgICBzaGVldC5zZXRBdHRyaWJ1dGUoU0hJTU1FRF9BVFRSSUJVVEUsICcnKTsKICAgIHNoZWV0W1NISU1NRURfQVRUUklCVVRFXSA9IHRydWU7CiAgfQogIHJldHVybiBzaGVldDsKfQoKLy8gYWRkIHBvbHlmaWxsIHN0eWxlc2hlZXQgdG8gZG9jdW1lbnQKaWYgKHdpbmRvdy5TaGFkb3dET01Qb2x5ZmlsbCkgewogIGFkZENzc1RvRG9jdW1lbnQoJ3N0eWxlIHsgZGlzcGxheTogbm9uZSAhaW1wb3J0YW50OyB9XG4nKTsKICB2YXIgZG9jID0gU2hhZG93RE9NUG9seWZpbGwud3JhcChkb2N1bWVudCk7CiAgdmFyIGhlYWQgPSBkb2MucXVlcnlTZWxlY3RvcignaGVhZCcpOwogIGhlYWQuaW5zZXJ0QmVmb3JlKGdldFNoZWV0KCksIGhlYWQuY2hpbGROb2Rlc1swXSk7CgogIC8vIFRPRE8oc29ydmVsbCk6IG1vbmtleS1wYXRjaGluZyBIVE1MSW1wb3J0cyBpcyBhYnVzaXZlOwogIC8vIGNvbnNpZGVyIGEgYmV0dGVyIHNvbHV0aW9uLgogIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ0RPTUNvbnRlbnRMb2FkZWQnLCBmdW5jdGlvbigpIHsKICAgIHZhciB1cmxSZXNvbHZlciA9IHNjb3BlLnVybFJlc29sdmVyOwogICAgCiAgICBpZiAod2luZG93LkhUTUxJbXBvcnRzICYmICFIVE1MSW1wb3J0cy51c2VOYXRpdmUpIHsKICAgICAgdmFyIFNISU1fU0hFRVRfU0VMRUNUT1IgPSAnbGlua1tyZWw9c3R5bGVzaGVldF0nICsKICAgICAgICAgICdbJyArIFNISU1fQVRUUklCVVRFICsgJ10nOwogICAgICB2YXIgU0hJTV9TVFlMRV9TRUxFQ1RPUiA9ICdzdHlsZVsnICsgU0hJTV9BVFRSSUJVVEUgKyAnXSc7CiAgICAgIEhUTUxJbXBvcnRzLmltcG9ydGVyLmRvY3VtZW50UHJlbG9hZFNlbGVjdG9ycyArPSAnLCcgKyBTSElNX1NIRUVUX1NFTEVDVE9SOwogICAgICBIVE1MSW1wb3J0cy5pbXBvcnRlci5pbXBvcnRzUHJlbG9hZFNlbGVjdG9ycyArPSAnLCcgKyBTSElNX1NIRUVUX1NFTEVDVE9SOwoKICAgICAgSFRNTEltcG9ydHMucGFyc2VyLmRvY3VtZW50U2VsZWN0b3JzID0gWwogICAgICAgIEhUTUxJbXBvcnRzLnBhcnNlci5kb2N1bWVudFNlbGVjdG9ycywKICAgICAgICBTSElNX1NIRUVUX1NFTEVDVE9SLAogICAgICAgIFNISU1fU1RZTEVfU0VMRUNUT1IKICAgICAgXS5qb2luKCcsJyk7CiAgCiAgICAgIHZhciBvcmlnaW5hbFBhcnNlR2VuZXJpYyA9IEhUTUxJbXBvcnRzLnBhcnNlci5wYXJzZUdlbmVyaWM7CgogICAgICBIVE1MSW1wb3J0cy5wYXJzZXIucGFyc2VHZW5lcmljID0gZnVuY3Rpb24oZWx0KSB7CiAgICAgICAgaWYgKGVsdFtTSElNTUVEX0FUVFJJQlVURV0pIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgdmFyIHN0eWxlID0gZWx0Ll9faW1wb3J0RWxlbWVudCB8fCBlbHQ7CiAgICAgICAgaWYgKCFzdHlsZS5oYXNBdHRyaWJ1dGUoU0hJTV9BVFRSSUJVVEUpKSB7CiAgICAgICAgICBvcmlnaW5hbFBhcnNlR2VuZXJpYy5jYWxsKHRoaXMsIGVsdCk7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGlmIChlbHQuX19yZXNvdXJjZSkgewogICAgICAgICAgc3R5bGUgPSBlbHQub3duZXJEb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzdHlsZScpOwogICAgICAgICAgc3R5bGUudGV4dENvbnRlbnQgPSBlbHQuX19yZXNvdXJjZTsKICAgICAgICB9CiAgICAgICAgLy8gcmVsYXkgb24gSFRNTEltcG9ydHMgZm9yIHBhdGggZml4dXAKICAgICAgICBIVE1MSW1wb3J0cy5wYXRoLnJlc29sdmVVcmxzSW5TdHlsZShzdHlsZSk7CiAgICAgICAgc3R5bGUudGV4dENvbnRlbnQgPSBTaGFkb3dDU1Muc2hpbVN0eWxlKHN0eWxlKTsKICAgICAgICBzdHlsZS5yZW1vdmVBdHRyaWJ1dGUoU0hJTV9BVFRSSUJVVEUsICcnKTsKICAgICAgICBzdHlsZS5zZXRBdHRyaWJ1dGUoU0hJTU1FRF9BVFRSSUJVVEUsICcnKTsKICAgICAgICBzdHlsZVtTSElNTUVEX0FUVFJJQlVURV0gPSB0cnVlOwogICAgICAgIC8vIHBsYWNlIGluIGRvY3VtZW50CiAgICAgICAgaWYgKHN0eWxlLnBhcmVudE5vZGUgIT09IGhlYWQpIHsKICAgICAgICAgIC8vIHJlcGxhY2UgbGlua3MgaW4gaGVhZAogICAgICAgICAgaWYgKGVsdC5wYXJlbnROb2RlID09PSBoZWFkKSB7CiAgICAgICAgICAgIGhlYWQucmVwbGFjZUNoaWxkKHN0eWxlLCBlbHQpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy5hZGRFbGVtZW50VG9Eb2N1bWVudChzdHlsZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHN0eWxlLl9faW1wb3J0UGFyc2VkID0gdHJ1ZTsKICAgICAgICB0aGlzLm1hcmtQYXJzaW5nQ29tcGxldGUoZWx0KTsKICAgICAgICB0aGlzLnBhcnNlTmV4dCgpOwogICAgICB9CgogICAgICB2YXIgaGFzUmVzb3VyY2UgPSBIVE1MSW1wb3J0cy5wYXJzZXIuaGFzUmVzb3VyY2U7CiAgICAgIEhUTUxJbXBvcnRzLnBhcnNlci5oYXNSZXNvdXJjZSA9IGZ1bmN0aW9uKG5vZGUpIHsKICAgICAgICBpZiAobm9kZS5sb2NhbE5hbWUgPT09ICdsaW5rJyAmJiBub2RlLnJlbCA9PT0gJ3N0eWxlc2hlZXQnICYmCiAgICAgICAgICAgIG5vZGUuaGFzQXR0cmlidXRlKFNISU1fQVRUUklCVVRFKSkgewogICAgICAgICAgcmV0dXJuIChub2RlLl9fcmVzb3VyY2UpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXR1cm4gaGFzUmVzb3VyY2UuY2FsbCh0aGlzLCBub2RlKTsKICAgICAgICB9CiAgICAgIH0KCiAgICB9CiAgfSk7Cn0KCi8vIGV4cG9ydHMKc2NvcGUuU2hhZG93Q1NTID0gU2hhZG93Q1NTOwoKfSkod2luZG93LldlYkNvbXBvbmVudHMpOwo=",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Sun, 09 Nov 2014 02:21:13 GMT",
                    "Content-Length": "26024",
                    "Date": "Sun, 09 Nov 2014 02:21:13 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}