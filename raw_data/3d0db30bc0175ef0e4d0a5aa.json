{
    "url": "http://localhost:9999/simsalabim/sisyphus/sisyphus.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Link manipulation (DOM-based)",
    "issueType": 5246976,
    "severity": "Low",
    "confidence": "Firm",
    "issueBackground": "DOM-based link manipulation vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this to a navigation target within the current page, such as a clickable link or the submission URL of a form. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will modify the target of links within the response. An attacker may be able to leverage this to perform various attacks, including:<ul><li>Causing the user to redirect to an arbitrary external URL, to facilitate a phishing attack.</li><li>Causing the user to submit sensitive form data to a server controlled by the attacker.</li><li>Causing the user to perform an unintended action within the application, by changing the file or query string associated with a link.</li><li>Bypassing browser anti-XSS defenses by injecting on-site links containing XSS exploits, since browser anti-XSS defenses typically do not operate on on-site links.</li></ul>",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based link manipulation vulnerabilities is not to dynamically set the target URLs of links or forms using data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing an arbitrary URL as a link target. In general, this is best achieved by using a whitelist of URLs that are permitted link targets, and strictly validating the target against this list before setting the link target.",
    "issueDetail": "The application may be vulnerable to DOM-based link manipulation. Data is read from <b>location.pathname</b> and written to <b>the 'href' property of a DOM element</b> via the following statement:<ul><li>this.href = location.hostname + location.pathname + location.search + location.hash;</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/simsalabim/sisyphus/sisyphus.js",
                "path": "/simsalabim/sisyphus/sisyphus.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9zaW1zYWxhYmltL3Npc3lwaHVzL3Npc3lwaHVzLmpzIEhUVFAvMS4xDQpIb3N0OiBsb2NhbGhvc3Q6OTk5OQ0KDQo=",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogMTUyNTANCkFjY2VwdC1SYW5nZXM6IGJ5dGVzDQpDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2phdmFzY3JpcHQNCkRhdGU6IFNhdCwgMDggTm92IDIwMTQgMDQ6NDY6MzkgR01UDQpMYXN0LU1vZGlmaWVkOiBTYXQsIDA4IE5vdiAyMDE0IDA0OjQ2OjM5IEdNVA0KDQovKioKICogUGx1Z2luIGRldmVsb3BlZCB0byBzYXZlIGh0bWwgZm9ybXMgZGF0YSB0byBMb2NhbFN0b3JhZ2UgdG8gcmVzdG9yZSB0aGVtIGFmdGVyIGJyb3dzZXIgY3Jhc2hlcywgdGFicyBjbG9zaW5ncwogKiBhbmQgb3RoZXIgZGlzYXN0ZXJzLgogKgogKiBAYXV0aG9yIEFsZXhhbmRlciBLYXVwYW5pbiA8a2F1cGFuaW5AZ21haWwuY29tPgogKi8KCiggZnVuY3Rpb24oICQgKSB7CgoJJC5mbi5zaXN5cGh1cyA9IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCXZhciBpZGVudGlmaWVyID0gJC5tYXAoIHRoaXMsIGZ1bmN0aW9uKCBvYmosIGkgKSB7CgkJCXJldHVybiAkKCBvYmogKS5hdHRyKCAiaWQiICkgKyAkKCBvYmogKS5hdHRyKCAibmFtZSIgKQoJCX0pLmpvaW4oKTsKCgkJdmFyIHNpc3lwaHVzID0gU2lzeXBodXMuZ2V0SW5zdGFuY2UoIGlkZW50aWZpZXIgKTsKCQlzaXN5cGh1cy5wcm90ZWN0KCB0aGlzLCBvcHRpb25zICk7CgkJcmV0dXJuIHNpc3lwaHVzOwoJfTsKCgl2YXIgYnJvd3NlclN0b3JhZ2UgPSB7fTsKCgkvKioKCSAqIENoZWNrIGlmIGxvY2FsIHN0b3JhZ2Ugb3Igb3RoZXIgYnJvd3NlciBzdG9yYWdlIGlzIGF2YWlsYWJsZQoJICoKCSAqIEByZXR1cm4gQm9vbGVhbgoJICovCglicm93c2VyU3RvcmFnZS5pc0F2YWlsYWJsZSA9IGZ1bmN0aW9uKCkgewoJCWlmICggdHlwZW9mICQualN0b3JhZ2UgPT09ICJvYmplY3QiICkgewoJCQlyZXR1cm4gdHJ1ZTsKCQl9CgkJdHJ5IHsKCQkJcmV0dXJuIGxvY2FsU3RvcmFnZS5nZXRJdGVtOwoJCX0gY2F0Y2ggKCBlICkgewoJCQlyZXR1cm4gZmFsc2U7CgkJfQoJfTsKCgkvKioKCSAqIFNldCBkYXRhIHRvIGJyb3dzZXIgc3RvcmFnZQoJICoKCSAqIEBwYXJhbSBbU3RyaW5nXSBrZXkKCSAqIEBwYXJhbSBbU3RyaW5nXSB2YWx1ZQoJICoKCSAqIEByZXR1cm4gQm9vbGVhbgoJICovCglicm93c2VyU3RvcmFnZS5zZXQgPSBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQlpZiAoIHR5cGVvZiAkLmpTdG9yYWdlID09PSAib2JqZWN0IiApIHsKCQkJJC5qU3RvcmFnZS5zZXQoIGtleSwgdmFsdWUgKyAiIiApOwoJCX0gZWxzZSB7CgkJCXRyeSB7CgkJCQlsb2NhbFN0b3JhZ2Uuc2V0SXRlbSgga2V5LCB2YWx1ZSArICIiICk7CgkJCX0gY2F0Y2ggKCBlICkgewoJCQkJLy9RVU9UQV9FWENFRURFRF9FUlIKCQkJfQoJCX0KCX07CgoJLyoqCgkgKiBHZXQgZGF0YSBmcm9tIGJyb3dzZXIgc3RvcmFnZSBieSBzcGVjaWZpZWQga2V5CgkgKgoJICogQHBhcmFtIFtTdHJpbmddIGtleQoJICoKCSAqIEByZXR1cm4gc3RyaW5nCgkgKi8KCWJyb3dzZXJTdG9yYWdlLmdldCA9IGZ1bmN0aW9uKCBrZXkgKSB7CgkJaWYgKCB0eXBlb2YgJC5qU3RvcmFnZSA9PT0gIm9iamVjdCIgKSB7CgkJCXZhciByZXN1bHQgPSAkLmpTdG9yYWdlLmdldCgga2V5ICk7CgkJCXJldHVybiByZXN1bHQgPyByZXN1bHQudG9TdHJpbmcoKSA6IHJlc3VsdDsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbG9jYWxTdG9yYWdlLmdldEl0ZW0oIGtleSApOwoJCX0KCX07CgoJLyoqCgkgKiBEZWxldGUgZGF0YSBmcm9tIGJyb3dzZXIgc3RvcmFnZSBieSBzcGVjaWZpZWQga2V5CgkgKgoJICogQHBhcmFtIFtTdHJpbmddIGtleQoJICoKCSAqIEByZXR1cm4gdm9pZAoJICovCglicm93c2VyU3RvcmFnZS5yZW1vdmUgPSBmdW5jdGlvbigga2V5ICkgewoJCWlmICggdHlwZW9mICQualN0b3JhZ2UgPT09ICJvYmplY3QiICkgewoJCQkkLmpTdG9yYWdlLmRlbGV0ZUtleSgga2V5ICk7CgkJfSBlbHNlIHsKCQkJbG9jYWxTdG9yYWdlLnJlbW92ZUl0ZW0oIGtleSApOwoJCX0KCX07CgoJU2lzeXBodXMgPSAoIGZ1bmN0aW9uKCkgewoJCXZhciBwYXJhbXMgPSB7CgkJCWluc3RhbnRpYXRlZDogW10sCgkJCXN0YXJ0ZWQ6IFtdCgkJfTsKCgkJZnVuY3Rpb24gaW5pdCAoKSB7CgoJCQlyZXR1cm4gewoJCQkJc2V0SW5zdGFuY2VJZGVudGlmaWVyOiBmdW5jdGlvbiggaWRlbnRpZmllciApIHsKCQkJCQl0aGlzLmlkZW50aWZpZXIgPSBpZGVudGlmaWVyCgkJCQl9LAoKCQkJCWdldEluc3RhbmNlSWRlbnRpZmllcjogZnVuY3Rpb24oKSB7CgkJCQkJcmV0dXJuIHRoaXMuaWRlbnRpZmllcjsKCQkJCX0sCgoJCQkJLyoqCgkJCQkgKiBTZXQgcGx1Z2luIGluaXRpYWwgb3B0aW9ucwoJCQkJICoKCQkJCSAqIEBwYXJhbSBbT2JqZWN0XSBvcHRpb25zCgkJCQkgKgoJCQkJICogQHJldHVybiB2b2lkCgkJCQkgKi8KCQkJCXNldEluaXRpYWxPcHRpb25zOiBmdW5jdGlvbiAoIG9wdGlvbnMgKSB7CgkJCQkJdmFyIGRlZmF1bHRzID0gewoJCQkJCQlleGNsdWRlRmllbGRzOiBbXSwKCQkJCQkJY3VzdG9tS2V5U3VmZml4OiAiIiwKCQkJCQkJbG9jYXRpb25CYXNlZDogZmFsc2UsCgkJCQkJCXRpbWVvdXQ6IDAsCgkJCQkJCWF1dG9SZWxlYXNlOiB0cnVlLAoJCQkJCQlvblNhdmU6IGZ1bmN0aW9uKCkge30sCgkJCQkJCW9uQmVmb3JlUmVzdG9yZTogZnVuY3Rpb24oKSB7fSwKCQkJCQkJb25SZXN0b3JlOiBmdW5jdGlvbigpIHt9LAoJCQkJCQlvblJlbGVhc2U6IGZ1bmN0aW9uKCkge30KCQkJCQl9OwoJCQkJCXRoaXMub3B0aW9ucyA9IHRoaXMub3B0aW9ucyB8fCAkLmV4dGVuZCggZGVmYXVsdHMsIG9wdGlvbnMgKTsKCQkJCQl0aGlzLmJyb3dzZXJTdG9yYWdlID0gYnJvd3NlclN0b3JhZ2U7CgkJCQl9LAoKCQkJCS8qKgoJCQkJICogU2V0IHBsdWdpbiBvcHRpb25zCgkJCQkgKgoJCQkJICogQHBhcmFtIFtPYmplY3RdIG9wdGlvbnMKCQkJCSAqCgkJCQkgKiBAcmV0dXJuIHZvaWQKCQkJCSAqLwoJCQkJc2V0T3B0aW9uczogZnVuY3Rpb24gKCBvcHRpb25zICkgewoJCQkJCXRoaXMub3B0aW9ucyA9IHRoaXMub3B0aW9ucyB8fCB0aGlzLnNldEluaXRpYWxPcHRpb25zKCBvcHRpb25zICk7CgkJCQkJdGhpcy5vcHRpb25zID0gJC5leHRlbmQoIHRoaXMub3B0aW9ucywgb3B0aW9ucyApOwoJCQkJfSwKCgkJCQkvKioKCQkJCSAqIFByb3RlY3Qgc3BlY2lmaWVkIGZvcm1zLCBzdG9yZSBpdCdzIGZpZWxkcyBkYXRhIHRvIGxvY2FsIHN0b3JhZ2UgYW5kIHJlc3RvcmUgdGhlbSBvbiBwYWdlIGxvYWQKCQkJCSAqCgkJCQkgKiBAcGFyYW0gW09iamVjdF0gdGFyZ2V0cwkJZm9ybXMgb2JqZWN0KHMpLCByZXN1bHQgb2YgalF1ZXJ5IHNlbGVjdG9yCgkJCQkgKiBAcGFyYW0gT2JqZWN0IG9wdGlvbnMJCQlwbHVnaW4gb3B0aW9ucwoJCQkJICoKCQkJCSAqIEByZXR1cm4gdm9pZAoJCQkJICovCgkJCQlwcm90ZWN0OiBmdW5jdGlvbiggdGFyZ2V0cywgb3B0aW9ucyApIHsKCQkJCQl0aGlzLnNldE9wdGlvbnMoIG9wdGlvbnMgKTsKCQkJCQl0YXJnZXRzID0gdGFyZ2V0cyB8fCB7fTsKCQkJCQl2YXIgc2VsZiA9IHRoaXM7CgkJCQkJdGhpcy50YXJnZXRzID0gdGhpcy50YXJnZXRzIHx8IFtdOwoJCQkJCWlmICggc2VsZi5vcHRpb25zLm5hbWUgKSB7CgkJCQkJCXRoaXMuaHJlZiA9IHNlbGYub3B0aW9ucy5uYW1lCgkJCQkJfSBlbHNlIHsKCQkJCQkJdGhpcy5ocmVmID0gbG9jYXRpb24uaG9zdG5hbWUgKyBsb2NhdGlvbi5wYXRobmFtZSArIGxvY2F0aW9uLnNlYXJjaCArIGxvY2F0aW9uLmhhc2g7CgkJCQkJfQoJCQkJCXRoaXMudGFyZ2V0cyA9ICQubWVyZ2UoIHRoaXMudGFyZ2V0cywgdGFyZ2V0cyApOwoJCQkJCXRoaXMudGFyZ2V0cyA9ICQudW5pcXVlKCB0aGlzLnRhcmdldHMgKTsKCQkJCQl0aGlzLnRhcmdldHMgPSAkKCB0aGlzLnRhcmdldHMgKTsKCQkJCQlpZiAoICEgdGhpcy5icm93c2VyU3RvcmFnZS5pc0F2YWlsYWJsZSgpICkgewoJCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQkJfQoKCQkJCQl2YXIgY2FsbGJhY2tfcmVzdWx0ID0gc2VsZi5vcHRpb25zLm9uQmVmb3JlUmVzdG9yZS5jYWxsKCBzZWxmICk7CgkJCQkJaWYgKCBjYWxsYmFja19yZXN1bHQgPT09IHVuZGVmaW5lZCB8fCBjYWxsYmFja19yZXN1bHQgKSB7CgkJCQkJCXNlbGYucmVzdG9yZUFsbERhdGEoKTsKCQkJCQl9CgoJCQkJCWlmICggdGhpcy5vcHRpb25zLmF1dG9SZWxlYXNlICkgewoJCQkJCQlzZWxmLmJpbmRSZWxlYXNlRGF0YSgpOwoJCQkJCX0KCgkJCQkJaWYgKCAhIHBhcmFtcy5zdGFydGVkWyB0aGlzLmdldEluc3RhbmNlSWRlbnRpZmllcigpIF0gKSB7CgkJCQkJCWlmICggc2VsZi5pc0NLRWRpdG9yUHJlc2VudCgpICkgewoJCQkJCQkJdmFyIGludGVydmFsSWQgPSBzZXRJbnRlcnZhbCggZnVuY3Rpb24oKSB7CgkJCQkJCQkJaWYgKENLRURJVE9SLmlzTG9hZGVkKSB7CgkJCQkJCQkJCWNsZWFySW50ZXJ2YWwoaW50ZXJ2YWxJZCk7CgkJCQkJCQkJCXNlbGYuYmluZFNhdmVEYXRhKCk7CgkJCQkJCQkJCXBhcmFtcy5zdGFydGVkWyBzZWxmLmdldEluc3RhbmNlSWRlbnRpZmllcigpIF0gPSB0cnVlOwoJCQkJCQkJCX0KCQkJCQkJCX0sIDEwMCk7CgkJCQkJCX0gZWxzZSB7CgkJCQkJCQlzZWxmLmJpbmRTYXZlRGF0YSgpOwoJCQkJCQkJcGFyYW1zLnN0YXJ0ZWRbIHNlbGYuZ2V0SW5zdGFuY2VJZGVudGlmaWVyKCkgXSA9IHRydWU7CgkJCQkJCX0KCQkJCQl9CgkJCQl9LAoKCQkJCWlzQ0tFZGl0b3JQcmVzZW50OiBmdW5jdGlvbigpIHsKCQkJCQlpZiAoIHRoaXMuaXNDS0VkaXRvckV4aXN0cygpICkgewoJCQkJCQlDS0VESVRPUi5pc0xvYWRlZCA9IGZhbHNlOwoJCQkJCQlDS0VESVRPUi5vbignaW5zdGFuY2VSZWFkeScsIGZ1bmN0aW9uKCkgewoJCQkJCQkJQ0tFRElUT1IuaXNMb2FkZWQgPSB0cnVlOwoJCQkJCQl9ICk7CgkJCQkJCXJldHVybiB0cnVlOwoJCQkJCX0gZWxzZSB7CgkJCQkJCXJldHVybiBmYWxzZTsKCQkJCQl9CgkJCQl9LAoKCQkJCWlzQ0tFZGl0b3JFeGlzdHM6IGZ1bmN0aW9uKCkgewoJCQkJCXJldHVybiB0eXBlb2YgQ0tFRElUT1IgIT0gInVuZGVmaW5lZCI7CgkJCQl9LAoKCQkJCWZpbmRGaWVsZHNUb1Byb3RlY3Q6IGZ1bmN0aW9uKCB0YXJnZXQgKSB7CgkJCQkJcmV0dXJuIHRhcmdldC5maW5kKCAiOmlucHV0IiApLm5vdCggIjpzdWJtaXQiICkubm90KCAiOnJlc2V0IiApLm5vdCggIjpidXR0b24iICkubm90KCAiOmZpbGUiICkubm90KCAiOnBhc3N3b3JkIiApLm5vdCggIjpkaXNhYmxlZCIgKS5ub3QoICJbcmVhZG9ubHldIiApOwoJCQkJfSwKCgkJCQkvKioKCQkJCSAqIEJpbmQgc2F2aW5nIGRhdGEKCQkJCSAqCgkJCQkgKiBAcmV0dXJuIHZvaWQKCQkJCSAqLwoJCQkJYmluZFNhdmVEYXRhOiBmdW5jdGlvbigpIHsKCQkJCQl2YXIgc2VsZiA9IHRoaXM7CgoJCQkJCWlmICggc2VsZi5vcHRpb25zLnRpbWVvdXQgKSB7CgkJCQkJCXNlbGYuc2F2ZURhdGFCeVRpbWVvdXQoKTsKCQkJCQl9CgoJCQkJCXNlbGYudGFyZ2V0cy5lYWNoKCBmdW5jdGlvbigpIHsKCQkJCQkJdmFyIHRhcmdldEZvcm1JZEFuZE5hbWUgPSAkKCB0aGlzICkuYXR0ciggImlkIiApICsgJCggdGhpcyApLmF0dHIoICJuYW1lIiApOwoJCQkJCQlzZWxmLmZpbmRGaWVsZHNUb1Byb3RlY3QoICQoIHRoaXMgKSApLmVhY2goIGZ1bmN0aW9uKCkgewoJCQkJCQkJaWYgKCAkLmluQXJyYXkoIHRoaXMsIHNlbGYub3B0aW9ucy5leGNsdWRlRmllbGRzICkgIT09IC0xICkgewoJCQkJCQkJCS8vIFJldHVybmluZyBub24tZmFsc2UgaXMgdGhlIHNhbWUgYXMgYSBjb250aW51ZSBzdGF0ZW1lbnQgaW4gYSBmb3IgbG9vcDsgaXQgd2lsbCBza2lwIGltbWVkaWF0ZWx5IHRvIHRoZSBuZXh0IGl0ZXJhdGlvbi4KCQkJCQkJCQlyZXR1cm4gdHJ1ZTsKCQkJCQkJCX0KCQkJCQkJCXZhciBmaWVsZCA9ICQoIHRoaXMgKTsKCQkJCQkJCXZhciBwcmVmaXggPSAoc2VsZi5vcHRpb25zLmxvY2F0aW9uQmFzZWQgPyBzZWxmLmhyZWYgOiAiIikgKyB0YXJnZXRGb3JtSWRBbmROYW1lICsgZmllbGQuYXR0ciggIm5hbWUiICkgKyBzZWxmLm9wdGlvbnMuY3VzdG9tS2V5U3VmZml4OwoJCQkJCQkJaWYgKCBmaWVsZC5pcyggIjp0ZXh0IiApIHx8IGZpZWxkLmlzKCAidGV4dGFyZWEiICkgKSB7CgkJCQkJCQkJaWYgKCAhIHNlbGYub3B0aW9ucy50aW1lb3V0ICkgewoJCQkJCQkJCQlzZWxmLmJpbmRTYXZlRGF0YUltbWVkaWF0ZWx5KCBmaWVsZCwgcHJlZml4ICk7CgkJCQkJCQkJfQoJCQkJCQkJfQoJCQkJCQkJc2VsZi5iaW5kU2F2ZURhdGFPbkNoYW5nZSggZmllbGQgKTsKCQkJCQkJfSApOwoJCQkJCX0gKTsKCQkJCX0sCgoJCQkJLyoqCgkJCQkgKiBTYXZlIGFsbCBwcm90ZWN0ZWQgZm9ybXMgZGF0YSB0byBMb2NhbCBTdG9yYWdlLgoJCQkJICogQ29tbW9uIG1ldGhvZCwgbmVjZXNzYXJ5IHRvIG5vdCBsZWFkIGFzdHJheSB1c2VyIGZpcmluZyAnZGF0YSBpcyBzYXZlZCcgd2hlbiBzZWxlY3QvY2hlY2tib3gvcmFkaW8KCQkJCSAqIGlzIGNoYW5nZWQgYW5kIHNhdmVkLCB3aGlsZSB0ZXh0IGZpZWxkIGRhdGEgaXMgc2F2ZWQgb25seSBieSB0aW1lb3V0CgkJCQkgKgoJCQkJICogQHJldHVybiB2b2lkCgkJCQkgKi8KCQkJCXNhdmVBbGxEYXRhOiBmdW5jdGlvbigpIHsKCQkJCQl2YXIgc2VsZiA9IHRoaXM7CgkJCQkJc2VsZi50YXJnZXRzLmVhY2goIGZ1bmN0aW9uKCkgewoJCQkJCQl2YXIgdGFyZ2V0Rm9ybUlkQW5kTmFtZSA9ICQoIHRoaXMgKS5hdHRyKCAiaWQiICkgKyAkKCB0aGlzICkuYXR0ciggIm5hbWUiICk7CgkJCQkJCXZhciBtdWx0aUNoZWNrYm94Q2FjaGUgPSB7fTsKCgkJCQkJCXNlbGYuZmluZEZpZWxkc1RvUHJvdGVjdCggJCggdGhpcykgKS5lYWNoKCBmdW5jdGlvbigpIHsKCQkJCQkJCXZhciBmaWVsZCA9ICQoIHRoaXMgKTsKCQkJCQkJCWlmICggJC5pbkFycmF5KCB0aGlzLCBzZWxmLm9wdGlvbnMuZXhjbHVkZUZpZWxkcyApICE9PSAtMSB8fCBmaWVsZC5hdHRyKCAibmFtZSIgKSA9PT0gdW5kZWZpbmVkICkgewoJCQkJCQkJCS8vIFJldHVybmluZyBub24tZmFsc2UgaXMgdGhlIHNhbWUgYXMgYSBjb250aW51ZSBzdGF0ZW1lbnQgaW4gYSBmb3IgbG9vcDsgaXQgd2lsbCBza2lwIGltbWVkaWF0ZWx5IHRvIHRoZSBuZXh0IGl0ZXJhdGlvbi4KCQkJCQkJCQlyZXR1cm4gdHJ1ZTsKCQkJCQkJCX0KCQkJCQkJCXZhciBwcmVmaXggPSAoc2VsZi5vcHRpb25zLmxvY2F0aW9uQmFzZWQgPyBzZWxmLmhyZWYgOiAiIikgKyB0YXJnZXRGb3JtSWRBbmROYW1lICsgZmllbGQuYXR0ciggIm5hbWUiICkgKyBzZWxmLm9wdGlvbnMuY3VzdG9tS2V5U3VmZml4OwoJCQkJCQkJdmFyIHZhbHVlID0gZmllbGQudmFsKCk7CgoJCQkJCQkJaWYgKCBmaWVsZC5pcygiOmNoZWNrYm94IikgKSB7CgkJCQkJCQkJaWYgKCBmaWVsZC5hdHRyKCAibmFtZSIgKS5pbmRleE9mKCAiWyIgKSAhPT0gLTEgKSB7CgkJCQkJCQkJCWlmICggbXVsdGlDaGVja2JveENhY2hlWyBmaWVsZC5hdHRyKCAibmFtZSIgKSBdID09PSB0cnVlICkgewoJCQkJCQkJCQkJcmV0dXJuOwoJCQkJCQkJCQl9CgkJCQkJCQkJCXZhbHVlID0gW107CgkJCQkJCQkJCSQoICJbbmFtZT0nIiArIGZpZWxkLmF0dHIoICJuYW1lIiApICsiJ106Y2hlY2tlZCIgKS5lYWNoKCBmdW5jdGlvbigpIHsKCQkJCQkJCQkJCXZhbHVlLnB1c2goICQoIHRoaXMgKS52YWwoKSApOwoJCQkJCQkJCQl9ICk7CgkJCQkJCQkJCW11bHRpQ2hlY2tib3hDYWNoZVsgZmllbGQuYXR0ciggIm5hbWUiICkgXSA9IHRydWU7CgkJCQkJCQkJfSBlbHNlIHsKCQkJCQkJCQkJdmFsdWUgPSBmaWVsZC5pcyggIjpjaGVja2VkIiApOwoJCQkJCQkJCX0KCQkJCQkJCQlzZWxmLnNhdmVUb0Jyb3dzZXJTdG9yYWdlKCBwcmVmaXgsIHZhbHVlLCBmYWxzZSApOwoJCQkJCQkJfSBlbHNlIGlmICggZmllbGQuaXMoICI6cmFkaW8iICkgKSB7CgkJCQkJCQkJaWYgKCBmaWVsZC5pcyggIjpjaGVja2VkIiApICkgewoJCQkJCQkJCQl2YWx1ZSA9IGZpZWxkLnZhbCgpOwoJCQkJCQkJCQlzZWxmLnNhdmVUb0Jyb3dzZXJTdG9yYWdlKCBwcmVmaXgsIHZhbHVlLCBmYWxzZSApOwoJCQkJCQkJCX0KCQkJCQkJCX0gZWxzZSB7CgkJCQkJCQkJaWYgKCBzZWxmLmlzQ0tFZGl0b3JFeGlzdHMoKSApIHsKCQkJCQkJCQkJdmFyIGVkaXRvcjsKCQkJCQkJCQkJaWYgKCBlZGl0b3IgPSBDS0VESVRPUi5pbnN0YW5jZXNbIGZpZWxkLmF0dHIoIm5hbWUiKSBdIHx8IENLRURJVE9SLmluc3RhbmNlc1sgZmllbGQuYXR0cigiaWQiKSBdICkgewoJCQkJCQkJCQkJZWRpdG9yLnVwZGF0ZUVsZW1lbnQoKTsKCQkJCQkJCQkJCXNlbGYuc2F2ZVRvQnJvd3NlclN0b3JhZ2UoIHByZWZpeCwgZmllbGQudmFsKCksIGZhbHNlKTsKCQkJCQkJCQkJfSBlbHNlIHsKCQkJCQkJCQkJCXNlbGYuc2F2ZVRvQnJvd3NlclN0b3JhZ2UoIHByZWZpeCwgdmFsdWUsIGZhbHNlICk7CgkJCQkJCQkJCX0KCQkJCQkJCQl9IGVsc2UgewoJCQkJCQkJCQlzZWxmLnNhdmVUb0Jyb3dzZXJTdG9yYWdlKCBwcmVmaXgsIHZhbHVlLCBmYWxzZSApOwoJCQkJCQkJCX0KCQkJCQkJCX0KCQkJCQkJfSApOwoJCQkJCX0gKTsKCQkJCQlzZWxmLm9wdGlvbnMub25TYXZlLmNhbGwoIHNlbGYgKTsKCQkJCX0sCgoJCQkJLyoqCgkJCQkgKiBSZXN0b3JlIGZvcm1zIGRhdGEgZnJvbSBMb2NhbCBTdG9yYWdlCgkJCQkgKgoJCQkJICogQHJldHVybiB2b2lkCgkJCQkgKi8KCQkJCXJlc3RvcmVBbGxEYXRhOiBmdW5jdGlvbigpIHsKCQkJCQl2YXIgc2VsZiA9IHRoaXM7CgkJCQkJdmFyIHJlc3RvcmVkID0gZmFsc2U7CgoJCQkJCXNlbGYudGFyZ2V0cy5lYWNoKCBmdW5jdGlvbigpIHsKCQkJCQkJdmFyIHRhcmdldCA9ICQoIHRoaXMgKTsKCQkJCQkJdmFyIHRhcmdldEZvcm1JZEFuZE5hbWUgPSAkKCB0aGlzICkuYXR0ciggImlkIiApICsgJCggdGhpcyApLmF0dHIoICJuYW1lIiApOwoKCQkJCQkJc2VsZi5maW5kRmllbGRzVG9Qcm90ZWN0KCB0YXJnZXQgKS5lYWNoKCBmdW5jdGlvbigpIHsKCQkJCQkJCWlmICggJC5pbkFycmF5KCB0aGlzLCBzZWxmLm9wdGlvbnMuZXhjbHVkZUZpZWxkcyApICE9PSAtMSApIHsKCQkJCQkJCQkvLyBSZXR1cm5pbmcgbm9uLWZhbHNlIGlzIHRoZSBzYW1lIGFzIGEgY29udGludWUgc3RhdGVtZW50IGluIGEgZm9yIGxvb3A7IGl0IHdpbGwgc2tpcCBpbW1lZGlhdGVseSB0byB0aGUgbmV4dCBpdGVyYXRpb24uCgkJCQkJCQkJcmV0dXJuIHRydWU7CgkJCQkJCQl9CgkJCQkJCQl2YXIgZmllbGQgPSAkKCB0aGlzICk7CgkJCQkJCQl2YXIgcHJlZml4ID0gKHNlbGYub3B0aW9ucy5sb2NhdGlvbkJhc2VkID8gc2VsZi5ocmVmIDogIiIpICsgdGFyZ2V0Rm9ybUlkQW5kTmFtZSArIGZpZWxkLmF0dHIoICJuYW1lIiApICsgc2VsZi5vcHRpb25zLmN1c3RvbUtleVN1ZmZpeDsKCQkJCQkJCXZhciByZXNxdWUgPSBzZWxmLmJyb3dzZXJTdG9yYWdlLmdldCggcHJlZml4ICk7CgkJCQkJCQlpZiAoIHJlc3F1ZSAhPT0gbnVsbCApIHsKCQkJCQkJCQlzZWxmLnJlc3RvcmVGaWVsZHNEYXRhKCBmaWVsZCwgcmVzcXVlICk7CgkJCQkJCQkJcmVzdG9yZWQgPSB0cnVlOwoJCQkJCQkJfQoJCQkJCQl9ICk7CgkJCQkJfSApOwoKCQkJCQlpZiAoIHJlc3RvcmVkICkgewoJCQkJCQlzZWxmLm9wdGlvbnMub25SZXN0b3JlLmNhbGwoIHNlbGYgKTsKCQkJCQl9CgkJCQl9LAoKCQkJCS8qKgoJCQkJICogUmVzdG9yZSBmb3JtIGZpZWxkIGRhdGEgZnJvbSBsb2NhbCBzdG9yYWdlCgkJCQkgKgoJCQkJICogQHBhcmFtIE9iamVjdCBmaWVsZAkJalF1ZXJ5IGZvcm0gZWxlbWVudCBvYmplY3QKCQkJCSAqIEBwYXJhbSBTdHJpbmcgcmVzcXVlCSBwcmV2aW91c2x5IHN0b3JlZCBmaWVsZHMgZGF0YQoJCQkJICoKCQkJCSAqIEByZXR1cm4gdm9pZAoJCQkJICovCgkJCQlyZXN0b3JlRmllbGRzRGF0YTogZnVuY3Rpb24oIGZpZWxkLCByZXNxdWUgKSB7CgkJCQkJaWYgKCBmaWVsZC5hdHRyKCAibmFtZSIgKSA9PT0gdW5kZWZpbmVkICkgewoJCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQkJfQoJCQkJCWlmICggZmllbGQuaXMoICI6Y2hlY2tib3giICkgJiYgcmVzcXVlICE9PSAiZmFsc2UiICYmIGZpZWxkLmF0dHIoICJuYW1lIiApLmluZGV4T2YoICJbIiApID09PSAtMSApIHsKCQkJCQkJZmllbGQuYXR0ciggImNoZWNrZWQiLCAiY2hlY2tlZCIgKTsKCQkJCQl9IGVsc2UgaWYoIGZpZWxkLmlzKCAiOmNoZWNrYm94IiApICYmIHJlc3F1ZSA9PT0gImZhbHNlIiAmJiBmaWVsZC5hdHRyKCAibmFtZSIgKS5pbmRleE9mKCAiWyIgKSA9PT0gLTEgKSB7CgkJCQkJCWZpZWxkLnJlbW92ZUF0dHIoICJjaGVja2VkIiApOwoJCQkJCX0gZWxzZSBpZiAoIGZpZWxkLmlzKCAiOnJhZGlvIiApICkgewoJCQkJCQlpZiAoIGZpZWxkLnZhbCgpID09PSByZXNxdWUgKSB7CgkJCQkJCQlmaWVsZC5hdHRyKCAiY2hlY2tlZCIsICJjaGVja2VkIiApOwoJCQkJCQl9CgkJCQkJfSBlbHNlIGlmICggZmllbGQuYXR0ciggIm5hbWUiICkuaW5kZXhPZiggIlsiICkgPT09IC0xICkgewoJCQkJCQlmaWVsZC52YWwoIHJlc3F1ZSApOwoJCQkJCX0gZWxzZSB7CgkJCQkJCXJlc3F1ZSA9IHJlc3F1ZS5zcGxpdCggIiwiICk7CgkJCQkJCWZpZWxkLnZhbCggcmVzcXVlICk7CgkJCQkJfQoJCQkJfSwKCgkJCQkvKioKCQkJCSAqIEJpbmQgaW1tZWRpYXRlIHNhdmluZyAob24gdHlwaW5nL2NoZWNraW5nL2NoYW5naW5nKSBmaWVsZCBkYXRhIHRvIGxvY2FsIHN0b3JhZ2Ugd2hlbiB1c2VyIGZpbGxzIGl0CgkJCQkgKgoJCQkJICogQHBhcmFtIE9iamVjdCBmaWVsZAkJalF1ZXJ5IGZvcm0gZWxlbWVudCBvYmplY3QKCQkJCSAqIEBwYXJhbSBTdHJpbmcgcHJlZml4CSBwcmVmaXggdXNlZCBhcyBrZXkgdG8gc3RvcmUgZGF0YSBpbiBsb2NhbCBzdG9yYWdlCgkJCQkgKgoJCQkJICogQHJldHVybiB2b2lkCgkJCQkgKi8KCQkJCWJpbmRTYXZlRGF0YUltbWVkaWF0ZWx5OiBmdW5jdGlvbiggZmllbGQsIHByZWZpeCApIHsKCQkJCQl2YXIgc2VsZiA9IHRoaXM7CgkJCQkJaWYgKCAnb25wcm9wZXJ0eWNoYW5nZScgaW4gZmllbGQgKSB7CgkJCQkJCWZpZWxkLmdldCgwKS5vbnByb3BlcnR5Y2hhbmdlID0gZnVuY3Rpb24oKSB7CgkJCQkJCQlzZWxmLnNhdmVUb0Jyb3dzZXJTdG9yYWdlKCBwcmVmaXgsIGZpZWxkLnZhbCgpICk7CgkJCQkJCX07CgkJCQkJfSBlbHNlIHsKCQkJCQkJZmllbGQuZ2V0KDApLm9uaW5wdXQgPSBmdW5jdGlvbigpIHsKCQkJCQkJCXNlbGYuc2F2ZVRvQnJvd3NlclN0b3JhZ2UoIHByZWZpeCwgZmllbGQudmFsKCkgKTsKCQkJCQkJfTsKCQkJCQl9CgkJCQkJaWYgKCB0aGlzLmlzQ0tFZGl0b3JFeGlzdHMoKSApIHsKCQkJCQkJdmFyIGVkaXRvcjsKCQkJCQkJaWYgKCBlZGl0b3IgPSBDS0VESVRPUi5pbnN0YW5jZXNbIGZpZWxkLmF0dHIoIm5hbWUiKSBdIHx8IENLRURJVE9SLmluc3RhbmNlc1sgZmllbGQuYXR0cigiaWQiKSBdICkgewoJCQkJCQkJZWRpdG9yLmRvY3VtZW50Lm9uKCAna2V5dXAnLCBmdW5jdGlvbigpIHsKCQkJCQkJCQllZGl0b3IudXBkYXRlRWxlbWVudCgpOwoJCQkJCQkJCXNlbGYuc2F2ZVRvQnJvd3NlclN0b3JhZ2UoIHByZWZpeCwgZmllbGQudmFsKCkgKTsKCQkJCQkJCX0gKTsKCQkJCQkJfQoJCQkJCX0KCQkJCX0sCgoJCQkJLyoqCgkJCQkgKiBTYXZlIGRhdGEgdG8gTG9jYWwgU3RvcmFnZSBhbmQgZmlyZSBjYWxsYmFjayBpZiBkZWZpbmVkCgkJCQkgKgoJCQkJICogQHBhcmFtIFN0cmluZyBrZXkKCQkJCSAqIEBwYXJhbSBTdHJpbmcgdmFsdWUKCQkJCSAqIEBwYXJhbSBCb29sZWFuIFt0cnVlXSBmaXJlQ2FsbGJhY2sKCQkJCSAqCgkJCQkgKiBAcmV0dXJuIHZvaWQKCQkJCSAqLwoJCQkJc2F2ZVRvQnJvd3NlclN0b3JhZ2U6IGZ1bmN0aW9uKCBrZXksIHZhbHVlLCBmaXJlQ2FsbGJhY2sgKSB7CgkJCQkJLy8gaWYgZmlyZUNhbGxiYWNrIGlzIHVuZGVmaW5lZCBpdCBzaG91bGQgYmUgdHJ1ZQoJCQkJCWZpcmVDYWxsYmFjayA9IGZpcmVDYWxsYmFjayA9PT0gdW5kZWZpbmVkID8gdHJ1ZSA6IGZpcmVDYWxsYmFjazsKCQkJCQl0aGlzLmJyb3dzZXJTdG9yYWdlLnNldCgga2V5LCB2YWx1ZSApOwoJCQkJCWlmICggZmlyZUNhbGxiYWNrICYmIHZhbHVlICE9PSAiIiApIHsKCQkJCQkJdGhpcy5vcHRpb25zLm9uU2F2ZS5jYWxsKCB0aGlzICk7CgkJCQkJfQoJCQkJfSwKCgkJCQkvKioKCQkJCSAqIEJpbmQgc2F2aW5nIGZpZWxkIGRhdGEgb24gY2hhbmdlCgkJCQkgKgoJCQkJICogQHBhcmFtIE9iamVjdCBmaWVsZAkJalF1ZXJ5IGZvcm0gZWxlbWVudCBvYmplY3QKCQkJCSAqCgkJCQkgKiBAcmV0dXJuIHZvaWQKCQkJCSAqLwoJCQkJYmluZFNhdmVEYXRhT25DaGFuZ2U6IGZ1bmN0aW9uKCBmaWVsZCApIHsKCQkJCQl2YXIgc2VsZiA9IHRoaXM7CgkJCQkJZmllbGQuY2hhbmdlKCBmdW5jdGlvbigpIHsKCQkJCQkJc2VsZi5zYXZlQWxsRGF0YSgpOwoJCQkJCX0gKTsKCQkJCX0sCgoJCQkJLyoqCgkJCQkgKiBTYXZpbmcgKGJ5IHRpbWVvdXQpIGZpZWxkIGRhdGEgdG8gbG9jYWwgc3RvcmFnZSB3aGVuIHVzZXIgZmlsbHMgaXQKCQkJCSAqCgkJCQkgKiBAcmV0dXJuIHZvaWQKCQkJCSAqLwoJCQkJc2F2ZURhdGFCeVRpbWVvdXQ6IGZ1bmN0aW9uKCkgewoJCQkJCXZhciBzZWxmID0gdGhpczsKCQkJCQl2YXIgdGFyZ2V0Rm9ybXMgPSBzZWxmLnRhcmdldHM7CgkJCQkJc2V0VGltZW91dCggKCBmdW5jdGlvbigpIHsKCQkJCQkJZnVuY3Rpb24gdGltZW91dCgpIHsKCQkJCQkJCXNlbGYuc2F2ZUFsbERhdGEoKTsKCQkJCQkJCXNldFRpbWVvdXQoIHRpbWVvdXQsIHNlbGYub3B0aW9ucy50aW1lb3V0ICogMTAwMCApOwoJCQkJCQl9CgkJCQkJCXJldHVybiB0aW1lb3V0OwoJCQkJCX0gKSggdGFyZ2V0Rm9ybXMgKSwgc2VsZi5vcHRpb25zLnRpbWVvdXQgKiAxMDAwICk7CgkJCQl9LAoKCQkJCS8qKgoJCQkJICogQmluZCByZWxlYXNlIGZvcm0gZmllbGRzIGRhdGEgZnJvbSBsb2NhbCBzdG9yYWdlIG9uIHN1Ym1pdC9yZXNldCBmb3JtCgkJCQkgKgoJCQkJICogQHJldHVybiB2b2lkCgkJCQkgKi8KCQkJCWJpbmRSZWxlYXNlRGF0YTogZnVuY3Rpb24oKSB7CgkJCQkJdmFyIHNlbGYgPSB0aGlzOwoJCQkJCXNlbGYudGFyZ2V0cy5lYWNoKCBmdW5jdGlvbigpIHsKCQkJCQkJdmFyIHRhcmdldCA9ICQoIHRoaXMgKTsKCQkJCQkJdmFyIGZvcm1JZEFuZE5hbWUgPSB0YXJnZXQuYXR0ciggImlkIiApICsgdGFyZ2V0LmF0dHIoICJuYW1lIiApOwoJCQkJCQkkKCB0aGlzICkuYmluZCggInN1Ym1pdCByZXNldCIsIGZ1bmN0aW9uKCkgewoJCQkJCQkJc2VsZi5yZWxlYXNlRGF0YSggZm9ybUlkQW5kTmFtZSwgc2VsZi5maW5kRmllbGRzVG9Qcm90ZWN0KCB0YXJnZXQgKSApOwoJCQkJCQl9ICk7CgkJCQkJfSApOwoJCQkJfSwKCgkJCQkvKioKCQkJCSAqIE1hbnVhbGx5IHJlbGVhc2UgZm9ybSBmaWVsZHMKCQkJCSAqCgkJCQkgKiBAcmV0dXJuIHZvaWQKCQkJCSAqLwoJCQkJbWFudWFsbHlSZWxlYXNlRGF0YTogZnVuY3Rpb24oKSB7CgkJCQkJdmFyIHNlbGYgPSB0aGlzOwoJCQkJCXNlbGYudGFyZ2V0cy5lYWNoKCBmdW5jdGlvbigpIHsKCQkJCQkJdmFyIHRhcmdldCA9ICQoIHRoaXMgKTsKCQkJCQkJdmFyIGZvcm1JZEFuZE5hbWUgPSB0YXJnZXQuYXR0ciggImlkIiApICsgdGFyZ2V0LmF0dHIoICJuYW1lIiApOwoJCQkJCQlzZWxmLnJlbGVhc2VEYXRhKCBmb3JtSWRBbmROYW1lLCBzZWxmLmZpbmRGaWVsZHNUb1Byb3RlY3QoIHRhcmdldCApICk7CgkJCQkJfSApOwoJCQkJfSwKCgkJCQkvKioKCQkJCSAqIEJpbmQgcmVsZWFzZSBmb3JtIGZpZWxkcyBkYXRhIGZyb20gbG9jYWwgc3RvcmFnZSBvbiBzdWJtaXQvcmVzZXR0IGZvcm0KCQkJCSAqCgkJCQkgKiBAcGFyYW0gU3RyaW5nIHRhcmdldEZvcm1JZEFuZE5hbWUJYSBmb3JtIGlkZW50aWZpZXIgY29uc2lzdHMgb2YgaXRzIGlkIGFuZCBuYW1lIGdsdWVkCgkJCQkgKiBAcGFyYW0gT2JqZWN0IGZpZWxkc1RvUHJvdGVjdAkJalF1ZXJ5IG9iamVjdCBjb250YWlucyBmb3JtIGZpZWxkcyB0byBwcm90ZWN0CgkJCQkgKgoJCQkJICogQHJldHVybiB2b2lkCgkJCQkgKi8KCQkJCXJlbGVhc2VEYXRhOiBmdW5jdGlvbiggdGFyZ2V0Rm9ybUlkQW5kTmFtZSwgZmllbGRzVG9Qcm90ZWN0ICkgewoJCQkJCXZhciByZWxlYXNlZCA9IGZhbHNlOwoJCQkJCXZhciBzZWxmID0gdGhpczsKCgkJCQkJLy8gUmVsZWFzZWQgZm9ybSwgYXJlIG5vdCBzdGFydGVkIGFueW1vcmUuIEZpeCBmb3IgYWpheCBsb2FkZWQgZm9ybXMuCgkJCQkJcGFyYW1zLnN0YXJ0ZWRbIHNlbGYuZ2V0SW5zdGFuY2VJZGVudGlmaWVyKCkgXSA9IGZhbHNlOwoKCQkJCQlmaWVsZHNUb1Byb3RlY3QuZWFjaCggZnVuY3Rpb24oKSB7CgkJCQkJCWlmICggJC5pbkFycmF5KCB0aGlzLCBzZWxmLm9wdGlvbnMuZXhjbHVkZUZpZWxkcyApICE9PSAtMSApIHsKCQkJCQkJCS8vIFJldHVybmluZyBub24tZmFsc2UgaXMgdGhlIHNhbWUgYXMgYSBjb250aW51ZSBzdGF0ZW1lbnQgaW4gYSBmb3IgbG9vcDsgaXQgd2lsbCBza2lwIGltbWVkaWF0ZWx5IHRvIHRoZSBuZXh0IGl0ZXJhdGlvbi4KCQkJCQkJCXJldHVybiB0cnVlOwoJCQkJCQl9CgkJCQkJCXZhciBmaWVsZCA9ICQoIHRoaXMgKTsKCQkJCQkJdmFyIHByZWZpeCA9IChzZWxmLm9wdGlvbnMubG9jYXRpb25CYXNlZCA/IHNlbGYuaHJlZiA6ICIiKSArIHRhcmdldEZvcm1JZEFuZE5hbWUgKyBmaWVsZC5hdHRyKCAibmFtZSIgKSArIHNlbGYub3B0aW9ucy5jdXN0b21LZXlTdWZmaXg7CgkJCQkJCXNlbGYuYnJvd3NlclN0b3JhZ2UucmVtb3ZlKCBwcmVmaXggKTsKCQkJCQkJcmVsZWFzZWQgPSB0cnVlOwoJCQkJCX0gKTsKCgkJCQkJaWYgKCByZWxlYXNlZCApIHsKCQkJCQkJc2VsZi5vcHRpb25zLm9uUmVsZWFzZS5jYWxsKCBzZWxmICk7CgkJCQkJfQoJCQkJfQoKCQkJfTsKCQl9CgoJCXJldHVybiB7CgkJCWdldEluc3RhbmNlOiBmdW5jdGlvbiggaWRlbnRpZmllciApIHsKCQkJCWlmICggISBwYXJhbXMuaW5zdGFudGlhdGVkWyBpZGVudGlmaWVyIF0gKSB7CgkJCQkJcGFyYW1zLmluc3RhbnRpYXRlZFsgaWRlbnRpZmllciBdID0gaW5pdCgpOwoJCQkJCXBhcmFtcy5pbnN0YW50aWF0ZWRbIGlkZW50aWZpZXIgXS5zZXRJbnN0YW5jZUlkZW50aWZpZXIoIGlkZW50aWZpZXIgKTsKCQkJCQlwYXJhbXMuaW5zdGFudGlhdGVkWyBpZGVudGlmaWVyIF0uc2V0SW5pdGlhbE9wdGlvbnMoKTsKCQkJCX0KCQkJCWlmICggaWRlbnRpZmllciApIHsKCQkJCQlyZXR1cm4gcGFyYW1zLmluc3RhbnRpYXRlZFsgaWRlbnRpZmllciBdOwoJCQkJfQoJCQkJcmV0dXJuIHBhcmFtcy5pbnN0YW50aWF0ZWRbIGlkZW50aWZpZXIgXTsKCQkJfSwKCgkJCWZyZWU6IGZ1bmN0aW9uKCkgewoJCQkJcGFyYW1zID0gewoJCQkJCWluc3RhbnRpYXRlZDogW10sCgkJCQkJc3RhcnRlZDogW10KCQkJCX07CgkJCQlyZXR1cm4gbnVsbDsKCQkJfSwKCQkJdmVyc2lvbjogJzEuMS4yJwoJCX07Cgl9ICkoKTsKfSApKCBqUXVlcnkgKTsK",
                "body": "LyoqCiAqIFBsdWdpbiBkZXZlbG9wZWQgdG8gc2F2ZSBodG1sIGZvcm1zIGRhdGEgdG8gTG9jYWxTdG9yYWdlIHRvIHJlc3RvcmUgdGhlbSBhZnRlciBicm93c2VyIGNyYXNoZXMsIHRhYnMgY2xvc2luZ3MKICogYW5kIG90aGVyIGRpc2FzdGVycy4KICoKICogQGF1dGhvciBBbGV4YW5kZXIgS2F1cGFuaW4gPGthdXBhbmluQGdtYWlsLmNvbT4KICovCgooIGZ1bmN0aW9uKCAkICkgewoKCSQuZm4uc2lzeXBodXMgPSBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQl2YXIgaWRlbnRpZmllciA9ICQubWFwKCB0aGlzLCBmdW5jdGlvbiggb2JqLCBpICkgewoJCQlyZXR1cm4gJCggb2JqICkuYXR0ciggImlkIiApICsgJCggb2JqICkuYXR0ciggIm5hbWUiICkKCQl9KS5qb2luKCk7CgoJCXZhciBzaXN5cGh1cyA9IFNpc3lwaHVzLmdldEluc3RhbmNlKCBpZGVudGlmaWVyICk7CgkJc2lzeXBodXMucHJvdGVjdCggdGhpcywgb3B0aW9ucyApOwoJCXJldHVybiBzaXN5cGh1czsKCX07CgoJdmFyIGJyb3dzZXJTdG9yYWdlID0ge307CgoJLyoqCgkgKiBDaGVjayBpZiBsb2NhbCBzdG9yYWdlIG9yIG90aGVyIGJyb3dzZXIgc3RvcmFnZSBpcyBhdmFpbGFibGUKCSAqCgkgKiBAcmV0dXJuIEJvb2xlYW4KCSAqLwoJYnJvd3NlclN0b3JhZ2UuaXNBdmFpbGFibGUgPSBmdW5jdGlvbigpIHsKCQlpZiAoIHR5cGVvZiAkLmpTdG9yYWdlID09PSAib2JqZWN0IiApIHsKCQkJcmV0dXJuIHRydWU7CgkJfQoJCXRyeSB7CgkJCXJldHVybiBsb2NhbFN0b3JhZ2UuZ2V0SXRlbTsKCQl9IGNhdGNoICggZSApIHsKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCX07CgoJLyoqCgkgKiBTZXQgZGF0YSB0byBicm93c2VyIHN0b3JhZ2UKCSAqCgkgKiBAcGFyYW0gW1N0cmluZ10ga2V5CgkgKiBAcGFyYW0gW1N0cmluZ10gdmFsdWUKCSAqCgkgKiBAcmV0dXJuIEJvb2xlYW4KCSAqLwoJYnJvd3NlclN0b3JhZ2Uuc2V0ID0gZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CgkJaWYgKCB0eXBlb2YgJC5qU3RvcmFnZSA9PT0gIm9iamVjdCIgKSB7CgkJCSQualN0b3JhZ2Uuc2V0KCBrZXksIHZhbHVlICsgIiIgKTsKCQl9IGVsc2UgewoJCQl0cnkgewoJCQkJbG9jYWxTdG9yYWdlLnNldEl0ZW0oIGtleSwgdmFsdWUgKyAiIiApOwoJCQl9IGNhdGNoICggZSApIHsKCQkJCS8vUVVPVEFfRVhDRUVERURfRVJSCgkJCX0KCQl9Cgl9OwoKCS8qKgoJICogR2V0IGRhdGEgZnJvbSBicm93c2VyIHN0b3JhZ2UgYnkgc3BlY2lmaWVkIGtleQoJICoKCSAqIEBwYXJhbSBbU3RyaW5nXSBrZXkKCSAqCgkgKiBAcmV0dXJuIHN0cmluZwoJICovCglicm93c2VyU3RvcmFnZS5nZXQgPSBmdW5jdGlvbigga2V5ICkgewoJCWlmICggdHlwZW9mICQualN0b3JhZ2UgPT09ICJvYmplY3QiICkgewoJCQl2YXIgcmVzdWx0ID0gJC5qU3RvcmFnZS5nZXQoIGtleSApOwoJCQlyZXR1cm4gcmVzdWx0ID8gcmVzdWx0LnRvU3RyaW5nKCkgOiByZXN1bHQ7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIGxvY2FsU3RvcmFnZS5nZXRJdGVtKCBrZXkgKTsKCQl9Cgl9OwoKCS8qKgoJICogRGVsZXRlIGRhdGEgZnJvbSBicm93c2VyIHN0b3JhZ2UgYnkgc3BlY2lmaWVkIGtleQoJICoKCSAqIEBwYXJhbSBbU3RyaW5nXSBrZXkKCSAqCgkgKiBAcmV0dXJuIHZvaWQKCSAqLwoJYnJvd3NlclN0b3JhZ2UucmVtb3ZlID0gZnVuY3Rpb24oIGtleSApIHsKCQlpZiAoIHR5cGVvZiAkLmpTdG9yYWdlID09PSAib2JqZWN0IiApIHsKCQkJJC5qU3RvcmFnZS5kZWxldGVLZXkoIGtleSApOwoJCX0gZWxzZSB7CgkJCWxvY2FsU3RvcmFnZS5yZW1vdmVJdGVtKCBrZXkgKTsKCQl9Cgl9OwoKCVNpc3lwaHVzID0gKCBmdW5jdGlvbigpIHsKCQl2YXIgcGFyYW1zID0gewoJCQlpbnN0YW50aWF0ZWQ6IFtdLAoJCQlzdGFydGVkOiBbXQoJCX07CgoJCWZ1bmN0aW9uIGluaXQgKCkgewoKCQkJcmV0dXJuIHsKCQkJCXNldEluc3RhbmNlSWRlbnRpZmllcjogZnVuY3Rpb24oIGlkZW50aWZpZXIgKSB7CgkJCQkJdGhpcy5pZGVudGlmaWVyID0gaWRlbnRpZmllcgoJCQkJfSwKCgkJCQlnZXRJbnN0YW5jZUlkZW50aWZpZXI6IGZ1bmN0aW9uKCkgewoJCQkJCXJldHVybiB0aGlzLmlkZW50aWZpZXI7CgkJCQl9LAoKCQkJCS8qKgoJCQkJICogU2V0IHBsdWdpbiBpbml0aWFsIG9wdGlvbnMKCQkJCSAqCgkJCQkgKiBAcGFyYW0gW09iamVjdF0gb3B0aW9ucwoJCQkJICoKCQkJCSAqIEByZXR1cm4gdm9pZAoJCQkJICovCgkJCQlzZXRJbml0aWFsT3B0aW9uczogZnVuY3Rpb24gKCBvcHRpb25zICkgewoJCQkJCXZhciBkZWZhdWx0cyA9IHsKCQkJCQkJZXhjbHVkZUZpZWxkczogW10sCgkJCQkJCWN1c3RvbUtleVN1ZmZpeDogIiIsCgkJCQkJCWxvY2F0aW9uQmFzZWQ6IGZhbHNlLAoJCQkJCQl0aW1lb3V0OiAwLAoJCQkJCQlhdXRvUmVsZWFzZTogdHJ1ZSwKCQkJCQkJb25TYXZlOiBmdW5jdGlvbigpIHt9LAoJCQkJCQlvbkJlZm9yZVJlc3RvcmU6IGZ1bmN0aW9uKCkge30sCgkJCQkJCW9uUmVzdG9yZTogZnVuY3Rpb24oKSB7fSwKCQkJCQkJb25SZWxlYXNlOiBmdW5jdGlvbigpIHt9CgkJCQkJfTsKCQkJCQl0aGlzLm9wdGlvbnMgPSB0aGlzLm9wdGlvbnMgfHwgJC5leHRlbmQoIGRlZmF1bHRzLCBvcHRpb25zICk7CgkJCQkJdGhpcy5icm93c2VyU3RvcmFnZSA9IGJyb3dzZXJTdG9yYWdlOwoJCQkJfSwKCgkJCQkvKioKCQkJCSAqIFNldCBwbHVnaW4gb3B0aW9ucwoJCQkJICoKCQkJCSAqIEBwYXJhbSBbT2JqZWN0XSBvcHRpb25zCgkJCQkgKgoJCQkJICogQHJldHVybiB2b2lkCgkJCQkgKi8KCQkJCXNldE9wdGlvbnM6IGZ1bmN0aW9uICggb3B0aW9ucyApIHsKCQkJCQl0aGlzLm9wdGlvbnMgPSB0aGlzLm9wdGlvbnMgfHwgdGhpcy5zZXRJbml0aWFsT3B0aW9ucyggb3B0aW9ucyApOwoJCQkJCXRoaXMub3B0aW9ucyA9ICQuZXh0ZW5kKCB0aGlzLm9wdGlvbnMsIG9wdGlvbnMgKTsKCQkJCX0sCgoJCQkJLyoqCgkJCQkgKiBQcm90ZWN0IHNwZWNpZmllZCBmb3Jtcywgc3RvcmUgaXQncyBmaWVsZHMgZGF0YSB0byBsb2NhbCBzdG9yYWdlIGFuZCByZXN0b3JlIHRoZW0gb24gcGFnZSBsb2FkCgkJCQkgKgoJCQkJICogQHBhcmFtIFtPYmplY3RdIHRhcmdldHMJCWZvcm1zIG9iamVjdChzKSwgcmVzdWx0IG9mIGpRdWVyeSBzZWxlY3RvcgoJCQkJICogQHBhcmFtIE9iamVjdCBvcHRpb25zCQkJcGx1Z2luIG9wdGlvbnMKCQkJCSAqCgkJCQkgKiBAcmV0dXJuIHZvaWQKCQkJCSAqLwoJCQkJcHJvdGVjdDogZnVuY3Rpb24oIHRhcmdldHMsIG9wdGlvbnMgKSB7CgkJCQkJdGhpcy5zZXRPcHRpb25zKCBvcHRpb25zICk7CgkJCQkJdGFyZ2V0cyA9IHRhcmdldHMgfHwge307CgkJCQkJdmFyIHNlbGYgPSB0aGlzOwoJCQkJCXRoaXMudGFyZ2V0cyA9IHRoaXMudGFyZ2V0cyB8fCBbXTsKCQkJCQlpZiAoIHNlbGYub3B0aW9ucy5uYW1lICkgewoJCQkJCQl0aGlzLmhyZWYgPSBzZWxmLm9wdGlvbnMubmFtZQoJCQkJCX0gZWxzZSB7CgkJCQkJCXRoaXMuaHJlZiA9IGxvY2F0aW9uLmhvc3RuYW1lICsgbG9jYXRpb24ucGF0aG5hbWUgKyBsb2NhdGlvbi5zZWFyY2ggKyBsb2NhdGlvbi5oYXNoOwoJCQkJCX0KCQkJCQl0aGlzLnRhcmdldHMgPSAkLm1lcmdlKCB0aGlzLnRhcmdldHMsIHRhcmdldHMgKTsKCQkJCQl0aGlzLnRhcmdldHMgPSAkLnVuaXF1ZSggdGhpcy50YXJnZXRzICk7CgkJCQkJdGhpcy50YXJnZXRzID0gJCggdGhpcy50YXJnZXRzICk7CgkJCQkJaWYgKCAhIHRoaXMuYnJvd3NlclN0b3JhZ2UuaXNBdmFpbGFibGUoKSApIHsKCQkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJCX0KCgkJCQkJdmFyIGNhbGxiYWNrX3Jlc3VsdCA9IHNlbGYub3B0aW9ucy5vbkJlZm9yZVJlc3RvcmUuY2FsbCggc2VsZiApOwoJCQkJCWlmICggY2FsbGJhY2tfcmVzdWx0ID09PSB1bmRlZmluZWQgfHwgY2FsbGJhY2tfcmVzdWx0ICkgewoJCQkJCQlzZWxmLnJlc3RvcmVBbGxEYXRhKCk7CgkJCQkJfQoKCQkJCQlpZiAoIHRoaXMub3B0aW9ucy5hdXRvUmVsZWFzZSApIHsKCQkJCQkJc2VsZi5iaW5kUmVsZWFzZURhdGEoKTsKCQkJCQl9CgoJCQkJCWlmICggISBwYXJhbXMuc3RhcnRlZFsgdGhpcy5nZXRJbnN0YW5jZUlkZW50aWZpZXIoKSBdICkgewoJCQkJCQlpZiAoIHNlbGYuaXNDS0VkaXRvclByZXNlbnQoKSApIHsKCQkJCQkJCXZhciBpbnRlcnZhbElkID0gc2V0SW50ZXJ2YWwoIGZ1bmN0aW9uKCkgewoJCQkJCQkJCWlmIChDS0VESVRPUi5pc0xvYWRlZCkgewoJCQkJCQkJCQljbGVhckludGVydmFsKGludGVydmFsSWQpOwoJCQkJCQkJCQlzZWxmLmJpbmRTYXZlRGF0YSgpOwoJCQkJCQkJCQlwYXJhbXMuc3RhcnRlZFsgc2VsZi5nZXRJbnN0YW5jZUlkZW50aWZpZXIoKSBdID0gdHJ1ZTsKCQkJCQkJCQl9CgkJCQkJCQl9LCAxMDApOwoJCQkJCQl9IGVsc2UgewoJCQkJCQkJc2VsZi5iaW5kU2F2ZURhdGEoKTsKCQkJCQkJCXBhcmFtcy5zdGFydGVkWyBzZWxmLmdldEluc3RhbmNlSWRlbnRpZmllcigpIF0gPSB0cnVlOwoJCQkJCQl9CgkJCQkJfQoJCQkJfSwKCgkJCQlpc0NLRWRpdG9yUHJlc2VudDogZnVuY3Rpb24oKSB7CgkJCQkJaWYgKCB0aGlzLmlzQ0tFZGl0b3JFeGlzdHMoKSApIHsKCQkJCQkJQ0tFRElUT1IuaXNMb2FkZWQgPSBmYWxzZTsKCQkJCQkJQ0tFRElUT1Iub24oJ2luc3RhbmNlUmVhZHknLCBmdW5jdGlvbigpIHsKCQkJCQkJCUNLRURJVE9SLmlzTG9hZGVkID0gdHJ1ZTsKCQkJCQkJfSApOwoJCQkJCQlyZXR1cm4gdHJ1ZTsKCQkJCQl9IGVsc2UgewoJCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQkJfQoJCQkJfSwKCgkJCQlpc0NLRWRpdG9yRXhpc3RzOiBmdW5jdGlvbigpIHsKCQkJCQlyZXR1cm4gdHlwZW9mIENLRURJVE9SICE9ICJ1bmRlZmluZWQiOwoJCQkJfSwKCgkJCQlmaW5kRmllbGRzVG9Qcm90ZWN0OiBmdW5jdGlvbiggdGFyZ2V0ICkgewoJCQkJCXJldHVybiB0YXJnZXQuZmluZCggIjppbnB1dCIgKS5ub3QoICI6c3VibWl0IiApLm5vdCggIjpyZXNldCIgKS5ub3QoICI6YnV0dG9uIiApLm5vdCggIjpmaWxlIiApLm5vdCggIjpwYXNzd29yZCIgKS5ub3QoICI6ZGlzYWJsZWQiICkubm90KCAiW3JlYWRvbmx5XSIgKTsKCQkJCX0sCgoJCQkJLyoqCgkJCQkgKiBCaW5kIHNhdmluZyBkYXRhCgkJCQkgKgoJCQkJICogQHJldHVybiB2b2lkCgkJCQkgKi8KCQkJCWJpbmRTYXZlRGF0YTogZnVuY3Rpb24oKSB7CgkJCQkJdmFyIHNlbGYgPSB0aGlzOwoKCQkJCQlpZiAoIHNlbGYub3B0aW9ucy50aW1lb3V0ICkgewoJCQkJCQlzZWxmLnNhdmVEYXRhQnlUaW1lb3V0KCk7CgkJCQkJfQoKCQkJCQlzZWxmLnRhcmdldHMuZWFjaCggZnVuY3Rpb24oKSB7CgkJCQkJCXZhciB0YXJnZXRGb3JtSWRBbmROYW1lID0gJCggdGhpcyApLmF0dHIoICJpZCIgKSArICQoIHRoaXMgKS5hdHRyKCAibmFtZSIgKTsKCQkJCQkJc2VsZi5maW5kRmllbGRzVG9Qcm90ZWN0KCAkKCB0aGlzICkgKS5lYWNoKCBmdW5jdGlvbigpIHsKCQkJCQkJCWlmICggJC5pbkFycmF5KCB0aGlzLCBzZWxmLm9wdGlvbnMuZXhjbHVkZUZpZWxkcyApICE9PSAtMSApIHsKCQkJCQkJCQkvLyBSZXR1cm5pbmcgbm9uLWZhbHNlIGlzIHRoZSBzYW1lIGFzIGEgY29udGludWUgc3RhdGVtZW50IGluIGEgZm9yIGxvb3A7IGl0IHdpbGwgc2tpcCBpbW1lZGlhdGVseSB0byB0aGUgbmV4dCBpdGVyYXRpb24uCgkJCQkJCQkJcmV0dXJuIHRydWU7CgkJCQkJCQl9CgkJCQkJCQl2YXIgZmllbGQgPSAkKCB0aGlzICk7CgkJCQkJCQl2YXIgcHJlZml4ID0gKHNlbGYub3B0aW9ucy5sb2NhdGlvbkJhc2VkID8gc2VsZi5ocmVmIDogIiIpICsgdGFyZ2V0Rm9ybUlkQW5kTmFtZSArIGZpZWxkLmF0dHIoICJuYW1lIiApICsgc2VsZi5vcHRpb25zLmN1c3RvbUtleVN1ZmZpeDsKCQkJCQkJCWlmICggZmllbGQuaXMoICI6dGV4dCIgKSB8fCBmaWVsZC5pcyggInRleHRhcmVhIiApICkgewoJCQkJCQkJCWlmICggISBzZWxmLm9wdGlvbnMudGltZW91dCApIHsKCQkJCQkJCQkJc2VsZi5iaW5kU2F2ZURhdGFJbW1lZGlhdGVseSggZmllbGQsIHByZWZpeCApOwoJCQkJCQkJCX0KCQkJCQkJCX0KCQkJCQkJCXNlbGYuYmluZFNhdmVEYXRhT25DaGFuZ2UoIGZpZWxkICk7CgkJCQkJCX0gKTsKCQkJCQl9ICk7CgkJCQl9LAoKCQkJCS8qKgoJCQkJICogU2F2ZSBhbGwgcHJvdGVjdGVkIGZvcm1zIGRhdGEgdG8gTG9jYWwgU3RvcmFnZS4KCQkJCSAqIENvbW1vbiBtZXRob2QsIG5lY2Vzc2FyeSB0byBub3QgbGVhZCBhc3RyYXkgdXNlciBmaXJpbmcgJ2RhdGEgaXMgc2F2ZWQnIHdoZW4gc2VsZWN0L2NoZWNrYm94L3JhZGlvCgkJCQkgKiBpcyBjaGFuZ2VkIGFuZCBzYXZlZCwgd2hpbGUgdGV4dCBmaWVsZCBkYXRhIGlzIHNhdmVkIG9ubHkgYnkgdGltZW91dAoJCQkJICoKCQkJCSAqIEByZXR1cm4gdm9pZAoJCQkJICovCgkJCQlzYXZlQWxsRGF0YTogZnVuY3Rpb24oKSB7CgkJCQkJdmFyIHNlbGYgPSB0aGlzOwoJCQkJCXNlbGYudGFyZ2V0cy5lYWNoKCBmdW5jdGlvbigpIHsKCQkJCQkJdmFyIHRhcmdldEZvcm1JZEFuZE5hbWUgPSAkKCB0aGlzICkuYXR0ciggImlkIiApICsgJCggdGhpcyApLmF0dHIoICJuYW1lIiApOwoJCQkJCQl2YXIgbXVsdGlDaGVja2JveENhY2hlID0ge307CgoJCQkJCQlzZWxmLmZpbmRGaWVsZHNUb1Byb3RlY3QoICQoIHRoaXMpICkuZWFjaCggZnVuY3Rpb24oKSB7CgkJCQkJCQl2YXIgZmllbGQgPSAkKCB0aGlzICk7CgkJCQkJCQlpZiAoICQuaW5BcnJheSggdGhpcywgc2VsZi5vcHRpb25zLmV4Y2x1ZGVGaWVsZHMgKSAhPT0gLTEgfHwgZmllbGQuYXR0ciggIm5hbWUiICkgPT09IHVuZGVmaW5lZCApIHsKCQkJCQkJCQkvLyBSZXR1cm5pbmcgbm9uLWZhbHNlIGlzIHRoZSBzYW1lIGFzIGEgY29udGludWUgc3RhdGVtZW50IGluIGEgZm9yIGxvb3A7IGl0IHdpbGwgc2tpcCBpbW1lZGlhdGVseSB0byB0aGUgbmV4dCBpdGVyYXRpb24uCgkJCQkJCQkJcmV0dXJuIHRydWU7CgkJCQkJCQl9CgkJCQkJCQl2YXIgcHJlZml4ID0gKHNlbGYub3B0aW9ucy5sb2NhdGlvbkJhc2VkID8gc2VsZi5ocmVmIDogIiIpICsgdGFyZ2V0Rm9ybUlkQW5kTmFtZSArIGZpZWxkLmF0dHIoICJuYW1lIiApICsgc2VsZi5vcHRpb25zLmN1c3RvbUtleVN1ZmZpeDsKCQkJCQkJCXZhciB2YWx1ZSA9IGZpZWxkLnZhbCgpOwoKCQkJCQkJCWlmICggZmllbGQuaXMoIjpjaGVja2JveCIpICkgewoJCQkJCQkJCWlmICggZmllbGQuYXR0ciggIm5hbWUiICkuaW5kZXhPZiggIlsiICkgIT09IC0xICkgewoJCQkJCQkJCQlpZiAoIG11bHRpQ2hlY2tib3hDYWNoZVsgZmllbGQuYXR0ciggIm5hbWUiICkgXSA9PT0gdHJ1ZSApIHsKCQkJCQkJCQkJCXJldHVybjsKCQkJCQkJCQkJfQoJCQkJCQkJCQl2YWx1ZSA9IFtdOwoJCQkJCQkJCQkkKCAiW25hbWU9JyIgKyBmaWVsZC5hdHRyKCAibmFtZSIgKSArIiddOmNoZWNrZWQiICkuZWFjaCggZnVuY3Rpb24oKSB7CgkJCQkJCQkJCQl2YWx1ZS5wdXNoKCAkKCB0aGlzICkudmFsKCkgKTsKCQkJCQkJCQkJfSApOwoJCQkJCQkJCQltdWx0aUNoZWNrYm94Q2FjaGVbIGZpZWxkLmF0dHIoICJuYW1lIiApIF0gPSB0cnVlOwoJCQkJCQkJCX0gZWxzZSB7CgkJCQkJCQkJCXZhbHVlID0gZmllbGQuaXMoICI6Y2hlY2tlZCIgKTsKCQkJCQkJCQl9CgkJCQkJCQkJc2VsZi5zYXZlVG9Ccm93c2VyU3RvcmFnZSggcHJlZml4LCB2YWx1ZSwgZmFsc2UgKTsKCQkJCQkJCX0gZWxzZSBpZiAoIGZpZWxkLmlzKCAiOnJhZGlvIiApICkgewoJCQkJCQkJCWlmICggZmllbGQuaXMoICI6Y2hlY2tlZCIgKSApIHsKCQkJCQkJCQkJdmFsdWUgPSBmaWVsZC52YWwoKTsKCQkJCQkJCQkJc2VsZi5zYXZlVG9Ccm93c2VyU3RvcmFnZSggcHJlZml4LCB2YWx1ZSwgZmFsc2UgKTsKCQkJCQkJCQl9CgkJCQkJCQl9IGVsc2UgewoJCQkJCQkJCWlmICggc2VsZi5pc0NLRWRpdG9yRXhpc3RzKCkgKSB7CgkJCQkJCQkJCXZhciBlZGl0b3I7CgkJCQkJCQkJCWlmICggZWRpdG9yID0gQ0tFRElUT1IuaW5zdGFuY2VzWyBmaWVsZC5hdHRyKCJuYW1lIikgXSB8fCBDS0VESVRPUi5pbnN0YW5jZXNbIGZpZWxkLmF0dHIoImlkIikgXSApIHsKCQkJCQkJCQkJCWVkaXRvci51cGRhdGVFbGVtZW50KCk7CgkJCQkJCQkJCQlzZWxmLnNhdmVUb0Jyb3dzZXJTdG9yYWdlKCBwcmVmaXgsIGZpZWxkLnZhbCgpLCBmYWxzZSk7CgkJCQkJCQkJCX0gZWxzZSB7CgkJCQkJCQkJCQlzZWxmLnNhdmVUb0Jyb3dzZXJTdG9yYWdlKCBwcmVmaXgsIHZhbHVlLCBmYWxzZSApOwoJCQkJCQkJCQl9CgkJCQkJCQkJfSBlbHNlIHsKCQkJCQkJCQkJc2VsZi5zYXZlVG9Ccm93c2VyU3RvcmFnZSggcHJlZml4LCB2YWx1ZSwgZmFsc2UgKTsKCQkJCQkJCQl9CgkJCQkJCQl9CgkJCQkJCX0gKTsKCQkJCQl9ICk7CgkJCQkJc2VsZi5vcHRpb25zLm9uU2F2ZS5jYWxsKCBzZWxmICk7CgkJCQl9LAoKCQkJCS8qKgoJCQkJICogUmVzdG9yZSBmb3JtcyBkYXRhIGZyb20gTG9jYWwgU3RvcmFnZQoJCQkJICoKCQkJCSAqIEByZXR1cm4gdm9pZAoJCQkJICovCgkJCQlyZXN0b3JlQWxsRGF0YTogZnVuY3Rpb24oKSB7CgkJCQkJdmFyIHNlbGYgPSB0aGlzOwoJCQkJCXZhciByZXN0b3JlZCA9IGZhbHNlOwoKCQkJCQlzZWxmLnRhcmdldHMuZWFjaCggZnVuY3Rpb24oKSB7CgkJCQkJCXZhciB0YXJnZXQgPSAkKCB0aGlzICk7CgkJCQkJCXZhciB0YXJnZXRGb3JtSWRBbmROYW1lID0gJCggdGhpcyApLmF0dHIoICJpZCIgKSArICQoIHRoaXMgKS5hdHRyKCAibmFtZSIgKTsKCgkJCQkJCXNlbGYuZmluZEZpZWxkc1RvUHJvdGVjdCggdGFyZ2V0ICkuZWFjaCggZnVuY3Rpb24oKSB7CgkJCQkJCQlpZiAoICQuaW5BcnJheSggdGhpcywgc2VsZi5vcHRpb25zLmV4Y2x1ZGVGaWVsZHMgKSAhPT0gLTEgKSB7CgkJCQkJCQkJLy8gUmV0dXJuaW5nIG5vbi1mYWxzZSBpcyB0aGUgc2FtZSBhcyBhIGNvbnRpbnVlIHN0YXRlbWVudCBpbiBhIGZvciBsb29wOyBpdCB3aWxsIHNraXAgaW1tZWRpYXRlbHkgdG8gdGhlIG5leHQgaXRlcmF0aW9uLgoJCQkJCQkJCXJldHVybiB0cnVlOwoJCQkJCQkJfQoJCQkJCQkJdmFyIGZpZWxkID0gJCggdGhpcyApOwoJCQkJCQkJdmFyIHByZWZpeCA9IChzZWxmLm9wdGlvbnMubG9jYXRpb25CYXNlZCA/IHNlbGYuaHJlZiA6ICIiKSArIHRhcmdldEZvcm1JZEFuZE5hbWUgKyBmaWVsZC5hdHRyKCAibmFtZSIgKSArIHNlbGYub3B0aW9ucy5jdXN0b21LZXlTdWZmaXg7CgkJCQkJCQl2YXIgcmVzcXVlID0gc2VsZi5icm93c2VyU3RvcmFnZS5nZXQoIHByZWZpeCApOwoJCQkJCQkJaWYgKCByZXNxdWUgIT09IG51bGwgKSB7CgkJCQkJCQkJc2VsZi5yZXN0b3JlRmllbGRzRGF0YSggZmllbGQsIHJlc3F1ZSApOwoJCQkJCQkJCXJlc3RvcmVkID0gdHJ1ZTsKCQkJCQkJCX0KCQkJCQkJfSApOwoJCQkJCX0gKTsKCgkJCQkJaWYgKCByZXN0b3JlZCApIHsKCQkJCQkJc2VsZi5vcHRpb25zLm9uUmVzdG9yZS5jYWxsKCBzZWxmICk7CgkJCQkJfQoJCQkJfSwKCgkJCQkvKioKCQkJCSAqIFJlc3RvcmUgZm9ybSBmaWVsZCBkYXRhIGZyb20gbG9jYWwgc3RvcmFnZQoJCQkJICoKCQkJCSAqIEBwYXJhbSBPYmplY3QgZmllbGQJCWpRdWVyeSBmb3JtIGVsZW1lbnQgb2JqZWN0CgkJCQkgKiBAcGFyYW0gU3RyaW5nIHJlc3F1ZQkgcHJldmlvdXNseSBzdG9yZWQgZmllbGRzIGRhdGEKCQkJCSAqCgkJCQkgKiBAcmV0dXJuIHZvaWQKCQkJCSAqLwoJCQkJcmVzdG9yZUZpZWxkc0RhdGE6IGZ1bmN0aW9uKCBmaWVsZCwgcmVzcXVlICkgewoJCQkJCWlmICggZmllbGQuYXR0ciggIm5hbWUiICkgPT09IHVuZGVmaW5lZCApIHsKCQkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJCX0KCQkJCQlpZiAoIGZpZWxkLmlzKCAiOmNoZWNrYm94IiApICYmIHJlc3F1ZSAhPT0gImZhbHNlIiAmJiBmaWVsZC5hdHRyKCAibmFtZSIgKS5pbmRleE9mKCAiWyIgKSA9PT0gLTEgKSB7CgkJCQkJCWZpZWxkLmF0dHIoICJjaGVja2VkIiwgImNoZWNrZWQiICk7CgkJCQkJfSBlbHNlIGlmKCBmaWVsZC5pcyggIjpjaGVja2JveCIgKSAmJiByZXNxdWUgPT09ICJmYWxzZSIgJiYgZmllbGQuYXR0ciggIm5hbWUiICkuaW5kZXhPZiggIlsiICkgPT09IC0xICkgewoJCQkJCQlmaWVsZC5yZW1vdmVBdHRyKCAiY2hlY2tlZCIgKTsKCQkJCQl9IGVsc2UgaWYgKCBmaWVsZC5pcyggIjpyYWRpbyIgKSApIHsKCQkJCQkJaWYgKCBmaWVsZC52YWwoKSA9PT0gcmVzcXVlICkgewoJCQkJCQkJZmllbGQuYXR0ciggImNoZWNrZWQiLCAiY2hlY2tlZCIgKTsKCQkJCQkJfQoJCQkJCX0gZWxzZSBpZiAoIGZpZWxkLmF0dHIoICJuYW1lIiApLmluZGV4T2YoICJbIiApID09PSAtMSApIHsKCQkJCQkJZmllbGQudmFsKCByZXNxdWUgKTsKCQkJCQl9IGVsc2UgewoJCQkJCQlyZXNxdWUgPSByZXNxdWUuc3BsaXQoICIsIiApOwoJCQkJCQlmaWVsZC52YWwoIHJlc3F1ZSApOwoJCQkJCX0KCQkJCX0sCgoJCQkJLyoqCgkJCQkgKiBCaW5kIGltbWVkaWF0ZSBzYXZpbmcgKG9uIHR5cGluZy9jaGVja2luZy9jaGFuZ2luZykgZmllbGQgZGF0YSB0byBsb2NhbCBzdG9yYWdlIHdoZW4gdXNlciBmaWxscyBpdAoJCQkJICoKCQkJCSAqIEBwYXJhbSBPYmplY3QgZmllbGQJCWpRdWVyeSBmb3JtIGVsZW1lbnQgb2JqZWN0CgkJCQkgKiBAcGFyYW0gU3RyaW5nIHByZWZpeAkgcHJlZml4IHVzZWQgYXMga2V5IHRvIHN0b3JlIGRhdGEgaW4gbG9jYWwgc3RvcmFnZQoJCQkJICoKCQkJCSAqIEByZXR1cm4gdm9pZAoJCQkJICovCgkJCQliaW5kU2F2ZURhdGFJbW1lZGlhdGVseTogZnVuY3Rpb24oIGZpZWxkLCBwcmVmaXggKSB7CgkJCQkJdmFyIHNlbGYgPSB0aGlzOwoJCQkJCWlmICggJ29ucHJvcGVydHljaGFuZ2UnIGluIGZpZWxkICkgewoJCQkJCQlmaWVsZC5nZXQoMCkub25wcm9wZXJ0eWNoYW5nZSA9IGZ1bmN0aW9uKCkgewoJCQkJCQkJc2VsZi5zYXZlVG9Ccm93c2VyU3RvcmFnZSggcHJlZml4LCBmaWVsZC52YWwoKSApOwoJCQkJCQl9OwoJCQkJCX0gZWxzZSB7CgkJCQkJCWZpZWxkLmdldCgwKS5vbmlucHV0ID0gZnVuY3Rpb24oKSB7CgkJCQkJCQlzZWxmLnNhdmVUb0Jyb3dzZXJTdG9yYWdlKCBwcmVmaXgsIGZpZWxkLnZhbCgpICk7CgkJCQkJCX07CgkJCQkJfQoJCQkJCWlmICggdGhpcy5pc0NLRWRpdG9yRXhpc3RzKCkgKSB7CgkJCQkJCXZhciBlZGl0b3I7CgkJCQkJCWlmICggZWRpdG9yID0gQ0tFRElUT1IuaW5zdGFuY2VzWyBmaWVsZC5hdHRyKCJuYW1lIikgXSB8fCBDS0VESVRPUi5pbnN0YW5jZXNbIGZpZWxkLmF0dHIoImlkIikgXSApIHsKCQkJCQkJCWVkaXRvci5kb2N1bWVudC5vbiggJ2tleXVwJywgZnVuY3Rpb24oKSB7CgkJCQkJCQkJZWRpdG9yLnVwZGF0ZUVsZW1lbnQoKTsKCQkJCQkJCQlzZWxmLnNhdmVUb0Jyb3dzZXJTdG9yYWdlKCBwcmVmaXgsIGZpZWxkLnZhbCgpICk7CgkJCQkJCQl9ICk7CgkJCQkJCX0KCQkJCQl9CgkJCQl9LAoKCQkJCS8qKgoJCQkJICogU2F2ZSBkYXRhIHRvIExvY2FsIFN0b3JhZ2UgYW5kIGZpcmUgY2FsbGJhY2sgaWYgZGVmaW5lZAoJCQkJICoKCQkJCSAqIEBwYXJhbSBTdHJpbmcga2V5CgkJCQkgKiBAcGFyYW0gU3RyaW5nIHZhbHVlCgkJCQkgKiBAcGFyYW0gQm9vbGVhbiBbdHJ1ZV0gZmlyZUNhbGxiYWNrCgkJCQkgKgoJCQkJICogQHJldHVybiB2b2lkCgkJCQkgKi8KCQkJCXNhdmVUb0Jyb3dzZXJTdG9yYWdlOiBmdW5jdGlvbigga2V5LCB2YWx1ZSwgZmlyZUNhbGxiYWNrICkgewoJCQkJCS8vIGlmIGZpcmVDYWxsYmFjayBpcyB1bmRlZmluZWQgaXQgc2hvdWxkIGJlIHRydWUKCQkJCQlmaXJlQ2FsbGJhY2sgPSBmaXJlQ2FsbGJhY2sgPT09IHVuZGVmaW5lZCA/IHRydWUgOiBmaXJlQ2FsbGJhY2s7CgkJCQkJdGhpcy5icm93c2VyU3RvcmFnZS5zZXQoIGtleSwgdmFsdWUgKTsKCQkJCQlpZiAoIGZpcmVDYWxsYmFjayAmJiB2YWx1ZSAhPT0gIiIgKSB7CgkJCQkJCXRoaXMub3B0aW9ucy5vblNhdmUuY2FsbCggdGhpcyApOwoJCQkJCX0KCQkJCX0sCgoJCQkJLyoqCgkJCQkgKiBCaW5kIHNhdmluZyBmaWVsZCBkYXRhIG9uIGNoYW5nZQoJCQkJICoKCQkJCSAqIEBwYXJhbSBPYmplY3QgZmllbGQJCWpRdWVyeSBmb3JtIGVsZW1lbnQgb2JqZWN0CgkJCQkgKgoJCQkJICogQHJldHVybiB2b2lkCgkJCQkgKi8KCQkJCWJpbmRTYXZlRGF0YU9uQ2hhbmdlOiBmdW5jdGlvbiggZmllbGQgKSB7CgkJCQkJdmFyIHNlbGYgPSB0aGlzOwoJCQkJCWZpZWxkLmNoYW5nZSggZnVuY3Rpb24oKSB7CgkJCQkJCXNlbGYuc2F2ZUFsbERhdGEoKTsKCQkJCQl9ICk7CgkJCQl9LAoKCQkJCS8qKgoJCQkJICogU2F2aW5nIChieSB0aW1lb3V0KSBmaWVsZCBkYXRhIHRvIGxvY2FsIHN0b3JhZ2Ugd2hlbiB1c2VyIGZpbGxzIGl0CgkJCQkgKgoJCQkJICogQHJldHVybiB2b2lkCgkJCQkgKi8KCQkJCXNhdmVEYXRhQnlUaW1lb3V0OiBmdW5jdGlvbigpIHsKCQkJCQl2YXIgc2VsZiA9IHRoaXM7CgkJCQkJdmFyIHRhcmdldEZvcm1zID0gc2VsZi50YXJnZXRzOwoJCQkJCXNldFRpbWVvdXQoICggZnVuY3Rpb24oKSB7CgkJCQkJCWZ1bmN0aW9uIHRpbWVvdXQoKSB7CgkJCQkJCQlzZWxmLnNhdmVBbGxEYXRhKCk7CgkJCQkJCQlzZXRUaW1lb3V0KCB0aW1lb3V0LCBzZWxmLm9wdGlvbnMudGltZW91dCAqIDEwMDAgKTsKCQkJCQkJfQoJCQkJCQlyZXR1cm4gdGltZW91dDsKCQkJCQl9ICkoIHRhcmdldEZvcm1zICksIHNlbGYub3B0aW9ucy50aW1lb3V0ICogMTAwMCApOwoJCQkJfSwKCgkJCQkvKioKCQkJCSAqIEJpbmQgcmVsZWFzZSBmb3JtIGZpZWxkcyBkYXRhIGZyb20gbG9jYWwgc3RvcmFnZSBvbiBzdWJtaXQvcmVzZXQgZm9ybQoJCQkJICoKCQkJCSAqIEByZXR1cm4gdm9pZAoJCQkJICovCgkJCQliaW5kUmVsZWFzZURhdGE6IGZ1bmN0aW9uKCkgewoJCQkJCXZhciBzZWxmID0gdGhpczsKCQkJCQlzZWxmLnRhcmdldHMuZWFjaCggZnVuY3Rpb24oKSB7CgkJCQkJCXZhciB0YXJnZXQgPSAkKCB0aGlzICk7CgkJCQkJCXZhciBmb3JtSWRBbmROYW1lID0gdGFyZ2V0LmF0dHIoICJpZCIgKSArIHRhcmdldC5hdHRyKCAibmFtZSIgKTsKCQkJCQkJJCggdGhpcyApLmJpbmQoICJzdWJtaXQgcmVzZXQiLCBmdW5jdGlvbigpIHsKCQkJCQkJCXNlbGYucmVsZWFzZURhdGEoIGZvcm1JZEFuZE5hbWUsIHNlbGYuZmluZEZpZWxkc1RvUHJvdGVjdCggdGFyZ2V0ICkgKTsKCQkJCQkJfSApOwoJCQkJCX0gKTsKCQkJCX0sCgoJCQkJLyoqCgkJCQkgKiBNYW51YWxseSByZWxlYXNlIGZvcm0gZmllbGRzCgkJCQkgKgoJCQkJICogQHJldHVybiB2b2lkCgkJCQkgKi8KCQkJCW1hbnVhbGx5UmVsZWFzZURhdGE6IGZ1bmN0aW9uKCkgewoJCQkJCXZhciBzZWxmID0gdGhpczsKCQkJCQlzZWxmLnRhcmdldHMuZWFjaCggZnVuY3Rpb24oKSB7CgkJCQkJCXZhciB0YXJnZXQgPSAkKCB0aGlzICk7CgkJCQkJCXZhciBmb3JtSWRBbmROYW1lID0gdGFyZ2V0LmF0dHIoICJpZCIgKSArIHRhcmdldC5hdHRyKCAibmFtZSIgKTsKCQkJCQkJc2VsZi5yZWxlYXNlRGF0YSggZm9ybUlkQW5kTmFtZSwgc2VsZi5maW5kRmllbGRzVG9Qcm90ZWN0KCB0YXJnZXQgKSApOwoJCQkJCX0gKTsKCQkJCX0sCgoJCQkJLyoqCgkJCQkgKiBCaW5kIHJlbGVhc2UgZm9ybSBmaWVsZHMgZGF0YSBmcm9tIGxvY2FsIHN0b3JhZ2Ugb24gc3VibWl0L3Jlc2V0dCBmb3JtCgkJCQkgKgoJCQkJICogQHBhcmFtIFN0cmluZyB0YXJnZXRGb3JtSWRBbmROYW1lCWEgZm9ybSBpZGVudGlmaWVyIGNvbnNpc3RzIG9mIGl0cyBpZCBhbmQgbmFtZSBnbHVlZAoJCQkJICogQHBhcmFtIE9iamVjdCBmaWVsZHNUb1Byb3RlY3QJCWpRdWVyeSBvYmplY3QgY29udGFpbnMgZm9ybSBmaWVsZHMgdG8gcHJvdGVjdAoJCQkJICoKCQkJCSAqIEByZXR1cm4gdm9pZAoJCQkJICovCgkJCQlyZWxlYXNlRGF0YTogZnVuY3Rpb24oIHRhcmdldEZvcm1JZEFuZE5hbWUsIGZpZWxkc1RvUHJvdGVjdCApIHsKCQkJCQl2YXIgcmVsZWFzZWQgPSBmYWxzZTsKCQkJCQl2YXIgc2VsZiA9IHRoaXM7CgoJCQkJCS8vIFJlbGVhc2VkIGZvcm0sIGFyZSBub3Qgc3RhcnRlZCBhbnltb3JlLiBGaXggZm9yIGFqYXggbG9hZGVkIGZvcm1zLgoJCQkJCXBhcmFtcy5zdGFydGVkWyBzZWxmLmdldEluc3RhbmNlSWRlbnRpZmllcigpIF0gPSBmYWxzZTsKCgkJCQkJZmllbGRzVG9Qcm90ZWN0LmVhY2goIGZ1bmN0aW9uKCkgewoJCQkJCQlpZiAoICQuaW5BcnJheSggdGhpcywgc2VsZi5vcHRpb25zLmV4Y2x1ZGVGaWVsZHMgKSAhPT0gLTEgKSB7CgkJCQkJCQkvLyBSZXR1cm5pbmcgbm9uLWZhbHNlIGlzIHRoZSBzYW1lIGFzIGEgY29udGludWUgc3RhdGVtZW50IGluIGEgZm9yIGxvb3A7IGl0IHdpbGwgc2tpcCBpbW1lZGlhdGVseSB0byB0aGUgbmV4dCBpdGVyYXRpb24uCgkJCQkJCQlyZXR1cm4gdHJ1ZTsKCQkJCQkJfQoJCQkJCQl2YXIgZmllbGQgPSAkKCB0aGlzICk7CgkJCQkJCXZhciBwcmVmaXggPSAoc2VsZi5vcHRpb25zLmxvY2F0aW9uQmFzZWQgPyBzZWxmLmhyZWYgOiAiIikgKyB0YXJnZXRGb3JtSWRBbmROYW1lICsgZmllbGQuYXR0ciggIm5hbWUiICkgKyBzZWxmLm9wdGlvbnMuY3VzdG9tS2V5U3VmZml4OwoJCQkJCQlzZWxmLmJyb3dzZXJTdG9yYWdlLnJlbW92ZSggcHJlZml4ICk7CgkJCQkJCXJlbGVhc2VkID0gdHJ1ZTsKCQkJCQl9ICk7CgoJCQkJCWlmICggcmVsZWFzZWQgKSB7CgkJCQkJCXNlbGYub3B0aW9ucy5vblJlbGVhc2UuY2FsbCggc2VsZiApOwoJCQkJCX0KCQkJCX0KCgkJCX07CgkJfQoKCQlyZXR1cm4gewoJCQlnZXRJbnN0YW5jZTogZnVuY3Rpb24oIGlkZW50aWZpZXIgKSB7CgkJCQlpZiAoICEgcGFyYW1zLmluc3RhbnRpYXRlZFsgaWRlbnRpZmllciBdICkgewoJCQkJCXBhcmFtcy5pbnN0YW50aWF0ZWRbIGlkZW50aWZpZXIgXSA9IGluaXQoKTsKCQkJCQlwYXJhbXMuaW5zdGFudGlhdGVkWyBpZGVudGlmaWVyIF0uc2V0SW5zdGFuY2VJZGVudGlmaWVyKCBpZGVudGlmaWVyICk7CgkJCQkJcGFyYW1zLmluc3RhbnRpYXRlZFsgaWRlbnRpZmllciBdLnNldEluaXRpYWxPcHRpb25zKCk7CgkJCQl9CgkJCQlpZiAoIGlkZW50aWZpZXIgKSB7CgkJCQkJcmV0dXJuIHBhcmFtcy5pbnN0YW50aWF0ZWRbIGlkZW50aWZpZXIgXTsKCQkJCX0KCQkJCXJldHVybiBwYXJhbXMuaW5zdGFudGlhdGVkWyBpZGVudGlmaWVyIF07CgkJCX0sCgoJCQlmcmVlOiBmdW5jdGlvbigpIHsKCQkJCXBhcmFtcyA9IHsKCQkJCQlpbnN0YW50aWF0ZWQ6IFtdLAoJCQkJCXN0YXJ0ZWQ6IFtdCgkJCQl9OwoJCQkJcmV0dXJuIG51bGw7CgkJCX0sCgkJCXZlcnNpb246ICcxLjEuMicKCQl9OwoJfSApKCk7Cn0gKSggalF1ZXJ5ICk7Cg==",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Sat, 08 Nov 2014 04:46:39 GMT",
                    "Content-Length": "15250",
                    "Date": "Sat, 08 Nov 2014 04:46:39 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}