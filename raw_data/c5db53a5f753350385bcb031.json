{
    "url": "http://localhost:9999/CloudKidStudio/CloudKidOS/dist/cloudkid-os-createjs.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Client-side JSON injection (DOM-based)",
    "issueType": 2098032,
    "severity": "Low",
    "confidence": "Firm",
    "issueBackground": "DOM-based JSON injection vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and incorporates this into a string that is parsed as a JSON data structure and then processed by the application. An attacker may be able to use this behavior to construct a URL which, if visited by another application user, will cause arbitrary JSON data to be processed. Depending on the purpose for which this data is used, it may be possible to subvert the application's logic, or cause unintended actions on behalf of the user.",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based JSON injection vulnerabilities is not to parse as JSON any string containing data that originated from an untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from modifying the JSON structure in inappropriate ways. This may involve strict validation of specific items to ensure they do not contain any characters that may interfere with the structure of the JSON when it is parsed.",
    "issueDetail": "The application may be vulnerable to DOM-based client-side JSON injection. Data is read from <b>document.cookie</b> and written to <b>JSON.parse()</b> via the following statements:<ul><li>var nameEQ = name + \"=\",     ca = document.cookie.split(';'),     i = 0, c;</li><li>c = ca[i];</li><li>return JSON.parse(unescape(c.substring(nameEQ.length,c.length)));</li></ul>Because the data originates from a cookie, the application's behavior is not trivial to exploit in an attack against another user. Typically, you will need to find a means of setting an arbitrary cookie value in the victim's browser in order to exploit the vulnerability. Applications often contain \"cookie-forcing\" conditions which make this possible, and such a condition in any related domain or subdomain can potentially be used for this purpose. Nonetheless, this limitation somewhat mitigates the impact of the vulnerability. ",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/CloudKidStudio/CloudKidOS/dist/cloudkid-os-createjs.js",
                "path": "/CloudKidStudio/CloudKidOS/dist/cloudkid-os-createjs.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9DbG91ZEtpZFN0dWRpby9DbG91ZEtpZE9TL2Rpc3QvY2xvdWRraWQtb3MtY3JlYXRlanMuanMgSFRUUC8xLjENCkhvc3Q6IGxvY2FsaG9zdDo5OTk5DQoNCg==",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogMTI1OTk4DQpBY2NlcHQtUmFuZ2VzOiBieXRlcw0KQ29udGVudC1UeXBlOiBhcHBsaWNhdGlvbi9qYXZhc2NyaXB0DQpEYXRlOiBUaHUsIDA2IE5vdiAyMDE0IDE1OjM5OjM0IEdNVA0KTGFzdC1Nb2RpZmllZDogVGh1LCAwNiBOb3YgMjAxNCAxNTozOTozMCBHTVQNCg0KLyoqCiogIEBtb2R1bGUgY2xvdWRraWQKKi8KKGZ1bmN0aW9uKHVuZGVmaW5lZCl7CgkKCS8qKgoJKiAgRGVzaWduZWQgdG8gbWltaWMgdGhlIGZlYXR1cmUtc2V0IG9mIHRoZSBDbG91ZEtpZE9TIGZvciBBUzMKCSogIFByb3ZpZGVzIGEgc3RhZ2luZyBmcmFtZXdvcmsgZm9yIG90aGVyIHRoaW5ncyB0byBsb2FkCgkqICBoYW5kbGVzIHRoZSBzdGFnZSBxdWVyeSBzdHJpbmcgcGFyYW1ldGVycywgcHJvdmlkZXMgZGVidWcgdG9vbHMsCgkqICBhcyB3ZWxsIGFzIGJyb3dzZXIgY2FjaGUtYnVzdGluZy4KCSoKCSogIEBjbGFzcyBPUwoJKiAgQGV4dGVuZHMgY3JlYXRlanMuQ29udGFpbmVyfFBJWEkuRGlzcGxheU9iamVjdENvbnRhaW5lcgoJKi8KCXZhciBPUyA9IGZ1bmN0aW9uKCl7fSwKCQoJLyoqCgkqIFRoZSBwcm90b3R5cGUgZXh0ZW5kcyB0aGUgZWFzZWxqcycgQ29udGFpbmVyIGNsYXNzCgkqIG9yIHRoZSBQSVhJLkRpc3BsYXlPYmplY3RDb250YWluZXIgY2xhc3MKCSogCgkqIEBwcml2YXRlCgkqIEBwcm9wZXJ0eSB7Y3JlYXRlanMuQ29udGFpbmVyfFBJWEkuRGlzcGxheU9iamVjdENvbnRhaW5lcn0gcAoJKi8KCXAgPSBPUy5wcm90b3R5cGUgPSAodHJ1ZSkgPyBuZXcgY3JlYXRlanMuQ29udGFpbmVyKCkgOiBPYmplY3QuY3JlYXRlKFBJWEkuRGlzcGxheU9iamVjdENvbnRhaW5lci5wcm90b3R5cGUpLAoJCgkvKioKCSogIEJvb2xlYW4gdG8ga2VlcCB0cmFjayBpZiB3ZSdyZSBwYXVzZWQKCSogIAoJKiAgQHByb3BlcnR5IHtib29sfSBfcGF1c2VkCgkqICBAcHJpdmF0ZQoJKi8KCV9wYXVzZWQgPSBmYWxzZSwKCQoJLyoqCgkqICBXaGVuIHRoZSBPUyBpcyByZWFkeSB0byB1c2UKCSogCgkqICBAcHJvcGVydHkge2Jvb2x9IF9pc1JlYWR5CgkqICBAcHJpdmF0ZQoJKi8KCV9pc1JlYWR5ID0gZmFsc2UsCgkKCS8qKgoJKiAgVGhlIGZyYW1lIHJhdGUgb2JqZWN0CgkqICBAcHJpdmF0ZQoJKiAgQHByb3BlcnR5IHtjcmVhdGVqcy5UZXh0fFBJWEkuVGV4dH0gX2ZyYW1lcmF0ZQoJKi8KCV9mcmFtZXJhdGUgPSBudWxsLAoJCgkvKioKCSogIFRoZSBudW1iZXIgb2YgbXMgc2luY2UgdGhlIGxhc3QgZnJhbWUgdXBkYXRlCgkqICBAcHJpdmF0ZQoJKiAgQHByb3BlcnR5IHtpbnR9IF9sYXN0RnJhbWVUaW1lCgkqLwoJX2xhc3RGcmFtZVRpbWUgPSAwLAoJCgkvKioKCSogIFRoZSBsYXN0IHRpbWUgc2luY2UgdGhlIGxhc3QgZnBzIHVwZGF0ZQoJKiAgQHByaXZhdGUKCSogIEBwcm9wZXJ0eSB7aW50fSBfbGFzdEZQU1VwZGF0ZVRpbWUKCSovCglfbGFzdEZQU1VwZGF0ZVRpbWUgPSAwLAoJCgkvKioKCSogIFRoZSBjYWxjdWxhdGVkIF9mcmFtZXJhdGUKCSogIEBwcml2YXRlCgkqICBAcHJvcGVydHkge051bWJlcn0gX2ZyYW1lcmF0ZVZhbHVlCgkqLwoJX2ZyYW1lcmF0ZVZhbHVlID0gbnVsbCwKCQoJLyoqCgkqICBUaGUgbnVtYmVyIG9mIGZyYW1lcyBzaW5jZSB0aGUgbGFzdCBmcHMgdXBkYXRlCgkqICBAcHJpdmF0ZQoJKiAgQHByb3BlcnR5IHtpbnR9IF9mcmFtZUNvdW50CgkqLwoJX2ZyYW1lQ291bnQgPSAwLAoJCgkvKioKCSoJVGhlIGJvdW5kIGNhbGxiYWNrIGZvciBsaXN0ZW5pbmcgdG8gdGljayBldmVudHMKCSoJQHByaXZhdGUKCSogICBAcHJvcGVydHkge0Z1bmN0aW9ufSBfdGlja0NhbGxiYWNrCgkqLwoJX3RpY2tDYWxsYmFjayA9IG51bGwsCgkKCS8qKgoJKiBSZWZlcmVuY2UgdG8gdGhlIHByaXZhdGUgaW5zdGFuY2Ugb2JqZWN0CgkqIAoJKiBAcHJvcGVydHkge09TfSBfaW5zdGFuY2UKCSogQHN0YXRpYwoJKiBAcHJvdGVjdGVkCgkqLwoJX2luc3RhbmNlID0gbnVsbCwKCQoJLyoqCgkqIFRoZSBpZCBvZiB0aGUgYWN0aXZlIHJlcXVlc3RBbmltYXRpb25GcmFtZSBvciBzZXRUaW1lb3V0IGNhbGwuCgkqCgkqIEBwcm9wZXJ0eSB7TnVtYmVyfSBfdGlja0lkCgkqIEBwcml2YXRlCgkqLwoJX3RpY2tJZCA9IC0xLAoJCgkvKioKCSogSWYgcmVxdWVzdGlvbkFuaW1hdGlvbkZyYW1lIHNob3VsZCBiZSB1c2VkCgkqCgkqIEBwcml2YXRlCgkqIEBwcm9wZXJ0eSB7Qm9vbH0gX3VzZVJBRgoJKiBAZGVmYXVsdCBmYWxzZQoJKi8KCV91c2VSQUYgPSBmYWxzZSwKCQoJLyoqIAoJKiBUaGUgY3VycmVudCBpbnRlcm5hbCBmcmFtZXMgcGVyIHNlY29uZAoJKgoJKiBAcHJvcGVydHkge051bWJlcn0gX2ZwcwoJKiBAcHJpdmF0ZQoJKi8KCV9mcHMgPSAwLAoJCgkvKioKCSogVGhlIG51bWJlciBvZiBtaWxsaXNlY29uZHMgcGVyIGZyYW1lCgkqCgkqIEBwcm9wZXJ0eSB7aW50fSBfbXNQZXJGcmFtZQoJKiBAcHJpdmF0ZQoJKi8KCV9tc1BlckZyYW1lID0gMDsKCQoJLyoqIAoJKiBUaGUgdmVyc2lvbiBudW1iZXIgCgkqIEBwdWJsaWMKCSogQHN0YXRpYwoJKiBAcHJvcGVydHkge1N0cmluZ30gVkVSU0lPTgoJKi8KCU9TLlZFUlNJT04gPSAiJHt2ZXJzaW9ufSI7CQoJCgkvKioKCSogUmVmZXJlbmNlIHRvIHRoZSBDb250YWluZXIgaW5pdGlhbGl6ZSgpCgkqIEBwcm90ZWN0ZWQKCSogQHByb3BlcnR5IHtGdW5jdGlvbn0gQ29udGFpbmVyX2luaXRpYWxpemUKCSovCglpZih0cnVlKQoJCXAuQ29udGFpbmVyX2luaXRpYWxpemUgPSBwLmluaXRpYWxpemU7CgkJCgkvKioKCSogUmVmZXJlbmNlIHRvIHRoZSBzdGFnZSBvYmplY3QKCSogCgkqIEBwcm9wZXJ0eSB7Y3JlYXRlanMuU3RhZ2V8UElYSS5TdGFnZX0gc3RhZ2UKCSogQHB1YmxpYwoJKi8KCXAuc3RhZ2UgPSBudWxsOwoJCgkvKioKCSogW1BpeGkgT25seV0gVGhlIHJlbmRlcmVyIHVzZWQgdG8gZHJhdyB0aGUgZnJhbWUuCgkqIAoJKiBAcHJvcGVydHkge1BJWEkuQ2FudmFzUmVuZGVyZXJ8UElYSS5XZWJHTFJlbmRlcmVyfSBfcmVuZGVyZXIgVGhlIFBpeGlKUyByZW5kZXJlci4KCSogQHByaXZhdGUKCSovCglpZihmYWxzZSkKCQlwLl9yZW5kZXJlciA9IG51bGw7CgkKCS8qKgoJKiBbUGl4aSBPbmx5XSBBIGRpdiB0aGF0IGNvbnRhaW5zIHRoZSBjYW52YXMsIHNvIHRoYXQgZ2FtZXMgY2FuIGxheWVyIGl0IHdpdGggb3RoZXIgY2FudmFzZXMgaWYgZGVzaXJlZC4KCSogCgkqIEBwcm9wZXJ0eSB7RE9NRWxlbWVudH0gY2FudmFzQ29udGFpbmVyCgkqIEBwdWJsaWMKCSovCglpZihmYWxzZSkKCQlwLmNhbnZhc0NvbnRhaW5lciA9IG51bGw7CgkKCS8qKgoJKiBSZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnQgYXBwbGljYXRpb24KCSogQHByb3RlY3RlZAoJKiBAcHJvcGVydHkge0FwcGxpY2F0aW9ufSBfYXBwCgkqLwoJcC5fYXBwID0gbnVsbDsKCQoJLyoqCgkqIFRoZSBjb2xsZWN0aW9uIG9mIHF1ZXJ5IHN0cmluZyBwYXJhbWV0ZXJzCgkqIEBwdWJsaWMKCSogQHByb3BlcnR5IHtEaWN0aW9uYXJ5fSBvcHRpb25zCgkqLwoJcC5vcHRpb25zID0gbnVsbDsKCQoJLyoqCgkqICBDb2xsZWN0aW9uIG9mIHVwZGF0ZSBmdW5jdGlvbnMKCSogIEBwcm90ZWN0ZWQKCSogIEBwcm9wZXJ0eSB7RGljdGlvbmFyeX0gX3VwZGF0ZUZ1bmN0aW9ucwoJKi8KCXAuX3VwZGF0ZUZ1bmN0aW9ucyA9IHt9OwoJCgkvKioKCSogIFN0YXRpYyBjb25zdHJ1Y3RvciBmb3Igc2V0dGluZyB1cCB0aGUgc3RhZ2UKCSogIAoJKiAgQGV4YW1wbGUKCQl2YXIgb3MgPSBjbG91ZGtpZC5PUy5pbml0KCJzdGFnZSIsIHsKCQkJc2hvd0ZyYW1lcmF0ZTogdHJ1ZSwKCQkJZnBzOiA2MCwKCQkJcGFyc2VRdWVyeVN0cmluZzogdHJ1ZSwKCQkJZGVidWc6IHRydWUKCQl9KTsKCQkKCQlvcy5hZGRBcHAobXlBcHBsaWNhdGlvbik7CgkqICAKCSogIEBtZXRob2QgaW5pdAoJKiAgQHN0YXRpYwoJKiAgQHB1YmxpYwoJKiAgQHBhcmFtIHtTdHJpbmd9IHN0YWdlTmFtZSBUaGUgc3RhZ2UgbmFtZSBzZWxlY3RvcgoJKiAgQHBhcmFtIHtEaWN0aW9uYXJ5fSBbb3B0aW9uc10gQWRkaXRpb25hbCBvcHRpb25zCgkqICBAcGFyYW0ge2ludH0gW29wdGlvbnMubW91c2VPdmVyUmF0ZT0zMF0gKENyZWF0ZUpTIG9ubHkpIHRoZSBmcmFtZXJhdGUgZm9yIG1vdXNlb3ZlciBlZmZlY3RzLCBoaWdoZXIgaXMgbW9yZSByZXNwb25zaXZlCgkqICBAcGFyYW0ge0Jvb2xlYW59IFtvcHRpb25zLmRlYnVnPWZhbHNlXSBJZiB3ZSBzaG91bGQgZW5hYmxlIHRoZSBEZWJ1ZyBjbGFzcyBmb3IgZG9pbmcgY29uc29sZSBhbmQgcmVtb3RlIGxvZ3MKCSogIEBwYXJhbSB7aW50fSBbb3B0aW9ucy5taW5Mb2dMZXZlbD0wXSBUaGUgbWluaW11bSBsb2cgbGV2ZWwgZm9yIHRoZSBEZWJ1ZyBjbGFzcywgZGVmYXVsdCBpcyBzaG93IGFsbCBzdGF0ZW1lbnRzLCB2YWx1ZXMgZnJvbSAwIChhbGwpLTQgKGVycm9ycyBvbmx5KQoJKiAgQHBhcmFtIHtTdHJpbmd9IFtvcHRpb25zLmlwPW51bGxdIFRoZSBJUCBhZGRyZXNzIGZvciBkb2luZyByZW1vdGUgZGVidWdnaW5nCgkqICBAcGFyYW0ge0Jvb2xlYW59IFtvcHRpb25zLnBhcnNlUXVlcnlTdHJpbmc9ZmFsc2VdIElmIHdlIHNob3VsZCBjb252ZXJ0IHRoZSBxdWVyeSBzdHJpbmcgaW50byBPUyBvcHRpb25zCgkqICBAcGFyYW0ge0Jvb2xlYW59IFtvcHRpb25zLnNob3dGcmFtZXJhdGU9ZmFsc2VdIFRvIGRpc3BsYXkgdGhlIGN1cnJlbnQgZnJhbWVyYXRlIGNvdW50ZXIKCSogIEBwYXJhbSB7Qm9vbGVhbn0gW29wdGlvbnMuY2xlYXJWaWV3PWZhbHNlXSBBdXRvIGNsZWFyIHRoZSBzdGFnZSByZW5kZXIKCSogIEBwYXJhbSB7aW50fSBbb3B0aW9ucy5iYWNrZ3JvdW5kQ29sb3I9MHgwMDAwMDBdIChQSVhJIG9ubHkpIFRoZSBiYWNrZ3JvdW5kIGNvbG9yIG9mIHRoZSBzdGFnZSBhcyBhIHVpbnQsIGUuZy4gMHhGRkZGRkYgZm9yIHdoaXRlLgoJKiAgQHBhcmFtIHtCb29sZWFufSBbb3B0aW9ucy5wcmVNdWx0QWxwaGE9ZmFsc2VdIChQSVhJIG9ubHkpIElmIHRoZSByZW5kZXJlciBpcyB0byB1c2UgcHJlIG11bHRpcGxpZWQgYWxwaGEgZm9yIGFsbCBpbWFnZXMuIFRoaXMgb25seSBhZmZlY3RzIHRoZSBXZWJHTCByZW5kZXJlci4KCSogIEBwYXJhbSB7Qm9vbGVhbn0gW29wdGlvbnMudHJhbnNwYXJlbnQ9ZmFsc2VdIChQSVhJIG9ubHkpIFRoZSBzdGFnZSBpcyB0cmFuc3BhcmVudAoJKiAgQHBhcmFtIHtpbnR9IFtvcHRpb25zLndpZHRoXSAoUElYSSBvbmx5KSBUaGUgd2lkdGggb2YgdGhlIHJlbmRlcmVyLCBkZWZhdWx0IGlzIHRoZSBjYW52YXMgd2lkdGgKCSogIEBwYXJhbSB7aW50fSBbb3B0aW9ucy5oZWlnaHRdIChQSVhJIG9ubHkpIFRoZSBoZWlnaHQgb2YgdGhlIHJlbmRlcmVyLCBkZWZhdWx0IGlzIHRoZSBjYW52YXMgaGVpZ2h0CgkqICBAcGFyYW0ge1N0cmluZ30gW29wdGlvbnMuZm9yY2VDb250ZXh0PW51bGxdIChQSVhJIG9ubHkpIFRoZSBzdGFnZSByZW5kZXJlciwgb3B0aW9ucyBhcmUgImNhbnZhczJkIiwgIndlYmdsIiBvciBudWxsLiBPbWl0dGluZyB0aGlzIChvciBudWxsKSB1c2VzIFdlYkdMIGlmIGF2YWlsYWJsZSwgYW5kIENhbnZhczJEIG90aGVyd2lzZS4KCSogIEBwYXJhbSB7Qm9vbGVhbn0gW29wdGlvbnMucmFmPWZhbHNlXSBVc2UgdGhlIHJlcXVlc3QgYW5pbWF0aW9uIGZyYW1lIGluc3RlYWQgb2YgYSBzZXRJbnRlcnZhbAoJKiAgQHBhcmFtIHtpbnR9IFtvcHRpb25zLmZwcz02MF0gU2V0IHRoZSBmcmFtZXJhdGUgCgkqICBAcGFyYW0ge1N0cmluZ30gW29wdGlvbnMudmVyc2lvbnNGaWxlXSBUaGUgdGV4dCBmaWVsZCB0byBzdG9yZSBjYWNoZS1idXN0aW5nIHZlcnNpb25zIGZvciBpbmRpdmlkdWFsIGZpbGVzCgkqICBAcGFyYW0ge1N0cmluZ30gW29wdGlvbnMuYmFzZVBhdGhdIFRoZSBiYXNlIHBhdGggdG8gbG9hZCBhbGwgZmlsZXMgZnJvbSAodXNlZnVsIGlmIHVzaW5nIGEgQ0ROKQoJKiAgQHBhcmFtIHtCb29sZWFufSBbb3B0aW9ucy5jYWNoZUJ1c3Q9ZmFsc2VdIElmIGFsbCBmaWxlIHJlcXVlc3RzIHdpdGggdGhlIE1lZGlhTG9hZGVyIHNob3VsZCBiZSBjYWNoZUJ1c3RlZCAoZS5nLiwgImZpbGUubXAzP2NiPTEyMzEyMyIpCgkqLwoJT1MuaW5pdCA9IGZ1bmN0aW9uKHN0YWdlTmFtZSwgb3B0aW9ucykKCXsKCQlpZiAoIV9pbnN0YW5jZSkKCQl7CgkJCWlmICh0cnVlKQoJCQl7CgkJCQlEZWJ1Zy5sb2coIkNyZWF0aW5nIHRoZSBzaW5nbGV0b24gaW5zdGFuY2Ugb2YgT1MiKTsKCQkJfQoJCQkKCQkJX2luc3RhbmNlID0gbmV3IE9TKCk7CgkJCV9pbnN0YW5jZS5pbml0aWFsaXplKHN0YWdlTmFtZSwgb3B0aW9ucyk7CgkJfQoJCXJldHVybiBfaW5zdGFuY2U7Cgl9OwoJCgkvKioKCSogIFRoZSBpbnRlcm5hbCBjb25zdHJ1Y3RvciBleHRlbmRzIENvbnRhaW5lciBjb25zdHJ1Y3RvcgoJKiAgQGNvbnN0cnVjdG9yCgkqICBAcHJvdGVjdGVkCgkqICBAbWV0aG9kIGluaXRpYWxpemUKCSogIEBwYXJhbSB7c3RyaW5nfSBzdGFnZU5hbWUgVGhlIHN0cmluZyBuYW1lIG9mIHRoZSBzdGFnZSBpZAoJKiAgQHBhcmFtIHtvYmplY3R9IFtvcHRpb25zXSBUaGUgb3B0aW9uYWwgb3B0aW9ucyB0byBzZXQsIHNlZSBPUy5pbml0KCkgZm9yIG1vcmUgaW5mb3JtYXRpb24gb24gdGhlIG9wdGlvbnMgdGhhdCBjYW4gYmUgc2V0LgoJKi8KCXAuaW5pdGlhbGl6ZSA9IGZ1bmN0aW9uKHN0YWdlTmFtZSwgb3B0aW9ucykKCXsKCQkvLyBDYWxsIHRoZSBzdXBlciBjb25zdHJ1Y3RvcgoJCWlmICh0cnVlKSB0aGlzLkNvbnRhaW5lcl9pbml0aWFsaXplKCk7CgkJaWYgKGZhbHNlKSBQSVhJLkRpc3BsYXlPYmplY3RDb250YWluZXIuY2FsbCh0aGlzKTsKCQkKCQkvLyBTZXR1cCB0aGUgb3B0aW9ucyBjb250YWluZXIKCQl0aGlzLm9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoJCQoJCS8vIFNlZSBpZiB3ZSBzaG91bGQgcGFyc2UgcXVlcnlzdHJpbmcKCQlpZiAodGhpcy5vcHRpb25zLnBhcnNlUXVlcnlTdHJpbmcgIT09IHVuZGVmaW5lZCkKCQkJdGhpcy5vcHRpb25zID0gcGFyc2VRdWVyeVN0cmluZ1BhcmFtcyh0aGlzLm9wdGlvbnMpOwoJCQoJCS8vIFR1cm4gb24gZGVidWdnaW5nCgkJaWYgKHRoaXMub3B0aW9ucy5kZWJ1ZyAhPT0gdW5kZWZpbmVkKQoJCQlEZWJ1Zy5lbmFibGVkID0gdGhpcy5vcHRpb25zLmRlYnVnID09PSB0cnVlIHx8IHRoaXMub3B0aW9ucy5kZWJ1ZyA9PT0gInRydWUiOwoJCQkKCQlpZiAodGhpcy5vcHRpb25zLm1pbkxvZ0xldmVsICE9PSB1bmRlZmluZWQpCgkJCURlYnVnLm1pbkxvZ0xldmVsID0gcGFyc2VJbnQodGhpcy5vcHRpb25zLm1pbkxvZ0xldmVsLCAxMCk7CgoJCS8vaWYgd2Ugd2VyZSBzdXBwbGllZCB3aXRoIGFuIElQIGFkZHJlc3MsIGNvbm5lY3QgdG8gaXQgd2l0aCB0aGUgRGVidWcgY2xhc3MgZm9yIGxvZ2dpbmcKCQlpZih0eXBlb2YgdGhpcy5vcHRpb25zLmlwID09ICJzdHJpbmciKQoJCQlEZWJ1Zy5jb25uZWN0KHRoaXMub3B0aW9ucy5pcCk7CgkKCQkvLyBTZXR1cCB0aGUgbWVkaWFsb2FkZXIKCQl2YXIgbG9hZGVyID0gY2xvdWRraWQuTWVkaWFMb2FkZXIuaW5pdCgpOwoJCQoJCS8vIFNldHVwIHRoZSBzdGFnZQoJCWlmKHRydWUpCgkJewoJCQl0aGlzLnN0YWdlID0gbmV3IGNyZWF0ZWpzLlN0YWdlKHN0YWdlTmFtZSk7CgkJCXRoaXMuc3RhZ2UubmFtZSA9ICJjbG91ZGtpZC5PUyI7CgkJCgkJCS8vIHByZXZlbnQgbW91c2UgZG93biB0dXJuaW5nIGludG8gY3Vyc29yCgkJCXRoaXMuc3RhZ2UuY2FudmFzLm9ubW91c2Vkb3duID0gZnVuY3Rpb24oZSkKCQkJewoJCQkJZS5wcmV2ZW50RGVmYXVsdCgpOwoJCQl9OwoKCQkJLy8gRW5hYmxlIHRoZSBtb3VzZW92ZXIgYnkgc2V0dGluZyB0aGUgZnJlcXVlbmN5CgkJCS8vIGlmIHdlIHNldCBtb3VzZU92ZXJSYXRlIDw9IDAsIHRoZW4gdHVybnMgb2ZmIG1vdXNlb3ZlciBlZmZlY3RzCgkJCXZhciBtb3VzZU92ZXJSYXRlID0gdGhpcy5vcHRpb25zLm1vdXNlT3ZlclJhdGUgPSB0aGlzLm9wdGlvbnMubW91c2VPdmVyUmF0ZSB8fCAzMDsKCQkJdGhpcy5zdGFnZS5lbmFibGVNb3VzZU92ZXIobW91c2VPdmVyUmF0ZSk7CgkJfQoJCQoJCWlmKGZhbHNlKQoJCXsKCQkJdGhpcy5zdGFnZSA9IG5ldyBQSVhJLlN0YWdlKHRoaXMub3B0aW9ucy5iYWNrZ3JvdW5kQ29sb3IgfHwgMCwgdHJ1ZSk7CgkJfQoJCXRoaXMuc3RhZ2UuYWRkQ2hpbGQodGhpcyk7CgkJCgkJLy9saXN0ZW4gZm9yIHdoZW4gdGhlIHBhZ2UgdmlzaWJpbGl0eSBjaGFuZ2VzIHNvIHdlIGNhbiBwYXVzZSBvdXIgdGltaW5ncwoJCXRoaXMudmlzaWJsZUxpc3RlbmVyID0gdGhpcy5vbldpbmRvd1Zpc2liaWxpdHlDaGFuZ2VkLmJpbmQodGhpcyk7CgkJYWRkUGFnZUhpZGVMaXN0ZW5lcih0aGlzLnZpc2libGVMaXN0ZW5lcik7CgkJCgkJaWYodHJ1ZSkKCQl7CgkJCS8vIFNldHVwIHRoZSB0b3VjaCBldmVudHMKCQkJdmFyIHRvdWNoRGV2aWNlPSh3aW5kb3cuaGFzT3duUHJvcGVydHkoJ29udG91Y2hzdGFydCcpKTsKCQkJCgkJCS8vSUUxMCBkb2Vzbid0IHNlbmQgbW91c2VvdmVyIGV2ZW50cyBwcm9wZXJseSBpZiB0b3VjaCBpcyBlbmFibGVkCgkJCWlmKHdpbmRvdy5uYXZpZ2F0b3IudXNlckFnZW50LmluZGV4T2YoIk1TSUUgMTAuMCIpICE9IC0xICYmICF0b3VjaERldmljZSkKCQkJewoJCQkJaWYgKHRydWUpIERlYnVnLmxvZygnSUUxMCBEZXNrdG9wJyk7CgkJCX0KCQkJZWxzZQoJCQkJY3JlYXRlanMuVG91Y2guZW5hYmxlKHRoaXMuc3RhZ2UpOwoKCQkJLy8gQ2xlYXIgdGhlIHN0YWdlCgkJCXRoaXMuc3RhZ2UuYXV0b0NsZWFyID0gISF0aGlzLm9wdGlvbnMuY2xlYXJWaWV3IHx8IGZhbHNlOwoJCQkKCQkJaWYodGhpcy5vcHRpb25zLnNob3dGcmFtZXJhdGUpCgkJCXsKCQkJCS8vIEFkZCB0aGUgZnJhbWUgcmF0ZSBvYmplY3QKCQkJCV9mcmFtZXJhdGUgPSBuZXcgY3JlYXRlanMuVGV4dCgnJywgJzEwcHggQXJpYWwnLCAnIzAwMCcpOwoJCQkJX2ZyYW1lcmF0ZS5zdHJva2UgPSB7d2lkdGg6MiwgY29sb3I6IiNmZmZmZmYifTsKCQkJCV9mcmFtZXJhdGUueCA9IF9mcmFtZXJhdGUueSA9IDU7CgkJCQl0aGlzLmFkZENoaWxkKF9mcmFtZXJhdGUpOwoJCQl9CgkJCQoJCQkvLyBJbml0aWFsIHJlbmRlcgoJCQl0aGlzLnN0YWdlLnVwZGF0ZSgpOwoJCX0KCQkKCQlpZihmYWxzZSkKCQl7CgkJCXZhciB0cmFuc3BhcmVudCA9ICEhdGhpcy5vcHRpb25zLnRyYW5zcGFyZW50IHx8IGZhbHNlOwoJCQl2YXIgcHJlTXVsdEFscGhhID0gISF0aGlzLm9wdGlvbnMucHJlTXVsdEFscGhhIHx8IGZhbHNlOwoKCQkJdGhpcy5jb250YWluZXJOYW1lID0gKHR5cGVvZiBzdGFnZU5hbWUgPT0gInN0cmluZyIpID8gc3RhZ2VOYW1lIDogc3RhZ2VOYW1lLmF0dHIoImlkIik7CgkJCXZhciBjb250YWluZXIgPSAodHlwZW9mIHN0YWdlTmFtZSA9PSAic3RyaW5nIikgPyBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChzdGFnZU5hbWUpIDogc3RhZ2VOYW1lOwoJCQl2YXIgY2FudmFzQ29udGFpbmVyID0gdGhpcy5jYW52YXNDb250YWluZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKCQkJY29udGFpbmVyLmFwcGVuZENoaWxkKGNhbnZhc0NvbnRhaW5lcik7CgkJCWNhbnZhc0NvbnRhaW5lci5pZCA9ICJDS09TIjsKCQkJCgkJCS8vY3JlYXRlIHRoZSByZW5kZXJlcmVyCgkJCXZhciB3aWR0aCA9IHRoaXMub3B0aW9ucy53aWR0aCB8fCBjb250YWluZXIuaW5uZXJXaWR0aDsKCQkJdmFyIGhlaWdodCA9IHRoaXMub3B0aW9ucy5oZWlnaHQgfHwgY29udGFpbmVyLmlubmVySGVpZ2h0OwoJCQlpZih0aGlzLm9wdGlvbnMuZm9yY2VDb250ZXh0ID09ICJjYW52YXMyZCIpCgkJCXsKCQkJCXRoaXMuX3JlbmRlcmVyID0gbmV3IFBJWEkuQ2FudmFzUmVuZGVyZXIoCgkJCQkJd2lkdGgsIAoJCQkJCWhlaWdodCwgCgkJCQkJbnVsbCwgCgkJCQkJdHJhbnNwYXJlbnQKCQkJCSk7CgkJCX0KCQkJZWxzZSBpZih0aGlzLm9wdGlvbnMuZm9yY2VDb250ZXh0ID09ICJ3ZWJnbCIpCgkJCXsKCQkJCXRoaXMuX3JlbmRlcmVyID0gbmV3IFBJWEkuV2ViR0xSZW5kZXJlcigKCQkJCQl3aWR0aCwgCgkJCQkJaGVpZ2h0LAoJCQkJCW51bGwsIAoJCQkJCXRyYW5zcGFyZW50LAoJCQkJCXByZU11bHRBbHBoYQoJCQkJKTsKCQkJfQoJCQllbHNlCgkJCXsKCQkJCXRoaXMuX3JlbmRlcmVyID0gUElYSS5hdXRvRGV0ZWN0UmVuZGVyZXIoCgkJCQkJd2lkdGgsIAoJCQkJCWhlaWdodCwKCQkJCQludWxsLCAKCQkJCQl0cmFuc3BhcmVudCwKCQkJCQlwcmVNdWx0QWxwaGEKCQkJCSk7CgkJCX0KCQkJY2FudmFzQ29udGFpbmVyLmFwcGVuZENoaWxkKHRoaXMuX3JlbmRlcmVyLnZpZXcpOwoJCQljYW52YXNDb250YWluZXIuc2V0QXR0cmlidXRlKCJzdHlsZSIsInBvc2l0aW9uOnJlbGF0aXZlO3dpZHRoOiIgKyB3aWR0aCArICJweDtoZWlnaHQ6IiArIGhlaWdodCArICJweCIpOwoJCQkKCQkJLy9IZXJlIGF0IENsb3VkS2lkLCB3ZSBhbHdheXMgaGF2ZSBhIGJpdG1hcCBiYWNrZ3JvdW5kLCBzbyB3ZSBjYW4gZ2V0IGJldHRlciBwZXJmb3JtYW5jZSBieSBub3QgY2xlYXJpbmcgdGhlIHJlbmRlciBhcmVhIGVhY2ggcmVuZGVyCgkJCXRoaXMuX3JlbmRlcmVyLmNsZWFyVmlldyA9ICEhdGhpcy5vcHRpb25zLmNsZWFyVmlldzsKCgkJCWlmKHRoaXMub3B0aW9ucy5zaG93RnJhbWVyYXRlKQoJCQl7CgkJCQkvLyBBZGQgdGhlIGZyYW1lIHJhdGUgb2JqZWN0CgkJCQlfZnJhbWVyYXRlID0gbmV3IFBJWEkuVGV4dCgnRlBTOiAwLjAwMCcsIHtmb250OicxMHB4IEFyaWFsJywgZmlsbDonYmxhY2snLCBzdHJva2U6J3doaXRlJywgc3Ryb2tlVGhpY2tuZXNzOjJ9KTsKCQkJCV9mcmFtZXJhdGUueCA9IF9mcmFtZXJhdGUueSA9IDU7CgkJCQl0aGlzLmFkZENoaWxkKF9mcmFtZXJhdGUpOwoJCQl9CgkJCQoJCQkvLyBJbml0aWFsIHJlbmRlcgoJCQl0aGlzLl9yZW5kZXJlci5yZW5kZXIodGhpcy5zdGFnZSk7CgkJfQoJCQoJCS8vc2V0IHVwIHRoZSB0aWNrIGNhbGxiYWNrCgkJX3RpY2tDYWxsYmFjayA9IHRoaXMudGljay5iaW5kKHRoaXMpOwoJCQoJCS8vIElmIHdlIHNob3VsZCB1c2UgcmVxdWVzdEFuaW1hdGlvbkZyYW1lIGluIHRoZSBicm93c2VyIGluc3RlYWQgb2Ygc2V0VGltZW91dAoJCV91c2VSQUYgPSB0aGlzLm9wdGlvbnMucmFmIHx8IGZhbHNlOwoJCQoJCS8vVGhlIGZwcyB0byB0YXJnZXQgLSBvbmx5IHVzZWQgaWYgbm90IHVzaW5nIHJlcXVlc3RBbmltYXRpb25GcmFtZQoJCXRoaXMuZnBzID0gdGhpcy5vcHRpb25zLmZwcyB8fCA2MDsKCgkJLy8gU2V0IHRoZSBhcHAgdG8gZGVmYXVsdAoJCXRoaXMucmVtb3ZlQXBwKCk7CgkJCgkJLy8gQ2hlY2sgdG8gc2VlIGlmIHdlIHNob3VsZCBsb2FkIGEgdmVyc2lvbnMgZmlsZQoJCS8vIFRoZSB2ZXJzaW9ucyBmaWxlIGtlZXBzIHRyYWNrIG9mIHRoZSBPUyB2ZXJzaW9uCgkJaWYgKHRoaXMub3B0aW9ucy52ZXJzaW9uc0ZpbGUgIT09IHVuZGVmaW5lZCkKCQl7CgkJCV9pc1JlYWR5ID0gZmFsc2U7CgkJCQoJCQl2YXIgb3MgPSB0aGlzOwoJCQkKCQkJLy8gVHJ5IHRvIGxvYWQgdGhlIGRlZmF1bHQgdmVyc2lvbnMgZmlsZQoJCQkvLyBjYWxsYmFjayBzaG91bGQgYmUgbWFkZSB3aXRoIGEgc2NvcGUgaW4gbWluZAoJCQlsb2FkZXIuY2FjaGVNYW5hZ2VyLmFkZFZlcnNpb25zRmlsZSgKCQkJCXRoaXMub3B0aW9ucy52ZXJzaW9uc0ZpbGUsIAoJCQkJZnVuY3Rpb24oKXsKCQkJCQkKCQkJCQlfaXNSZWFkeSA9IHRydWU7CgkJCQkJCgkJCQkJLy8gU29tZW9uZSBhZGRlZCBhbiBhcHBsaWNhdGlvbiBiZWZvcmUgdGhlIE9TIHdhcyByZWFkeQoJCQkJCS8vIGxldHMgaW5pdGlhbGl6ZSBpcyBub3cKCQkJCQlpZiAob3MuX2FwcCkKCQkJCQl7CgkJCQkJCW9zLmFkZENoaWxkQXQob3MuX2FwcCwgMCk7CgkJCQkJCW9zLl9hcHAuaW5pdCgpOwoJCQkJCQlvcy5yZXN1bWUoKTsKCQkJCQl9CgkJCQl9CgkJCSk7CgkJfQoJCWVsc2UKCQl7CgkJCV9pc1JlYWR5ID0gdHJ1ZTsKCQl9Cgl9OwoJCgl2YXIgaGlkZGVuID0gbnVsbDsvL25lZWRlZCBpbnNpZGUgdGhlIGV2ZW50IGxpc3RlbmVyIGFzIHdlbGwKCXZhciBldnRNYXAgPSBudWxsOwoJdmFyIHYgPSAndmlzaWJsZScsIGggPSAnaGlkZGVuJzsKCXZhciBhZGRQYWdlSGlkZUxpc3RlbmVyID0gZnVuY3Rpb24obGlzdGVuZXIpCgl7CgkJaGlkZGVuID0gImhpZGRlbiI7CgkJLy8gU3RhbmRhcmRzOgoJCWlmIChoaWRkZW4gaW4gZG9jdW1lbnQpCgkJCWRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoInZpc2liaWxpdHljaGFuZ2UiLCBsaXN0ZW5lcik7CgkJZWxzZSBpZiAoKGhpZGRlbiA9ICJtb3pIaWRkZW4iKSBpbiBkb2N1bWVudCkKCQkJZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigibW96dmlzaWJpbGl0eWNoYW5nZSIsIGxpc3RlbmVyKTsKCQllbHNlIGlmICgoaGlkZGVuID0gIndlYmtpdEhpZGRlbiIpIGluIGRvY3VtZW50KQoJCQlkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCJ3ZWJraXR2aXNpYmlsaXR5Y2hhbmdlIiwgbGlzdGVuZXIpOwoJCWVsc2UgaWYgKChoaWRkZW4gPSAibXNIaWRkZW4iKSBpbiBkb2N1bWVudCkKCQkJZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigibXN2aXNpYmlsaXR5Y2hhbmdlIiwgbGlzdGVuZXIpOwoJCWVsc2UgaWYgKCdvbmZvY3VzaW4nIGluIGRvY3VtZW50KS8vIElFIDkgYW5kIGxvd2VyOgoJCXsKCQkJZXZ0TWFwID0geyBmb2N1c2luOnYsIGZvY3Vzb3V0OmggfTsKCQkJZG9jdW1lbnQub25mb2N1c2luID0gZG9jdW1lbnQub25mb2N1c291dCA9IGxpc3RlbmVyOwoJCX0KCQllbHNlLy8gQWxsIG90aGVyczoKCQl7CgkJCWV2dE1hcCA9IHsgZm9jdXM6diwgcGFnZXNob3c6diwgYmx1cjpoLCBwYWdlaGlkZTpoIH07CgkJCXdpbmRvdy5vbnBhZ2VzaG93ID0gd2luZG93Lm9ucGFnZWhpZGUgPSB3aW5kb3cub25mb2N1cyA9IHdpbmRvdy5vbmJsdXIgPSBsaXN0ZW5lcjsKCQl9Cgl9OwoJCgl2YXIgcmVtb3ZlUGFnZUhpZGVMaXN0ZW5lciA9IGZ1bmN0aW9uKGxpc3RlbmVyKQoJewoJCXZhciBoaWRkZW4gPSAiaGlkZGVuIjsKCQlpZiAoaGlkZGVuIGluIGRvY3VtZW50KQoJCQlkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCJ2aXNpYmlsaXR5Y2hhbmdlIiwgbGlzdGVuZXIpOwoJCWVsc2UgaWYgKChoaWRkZW4gPSAibW96SGlkZGVuIikgaW4gZG9jdW1lbnQpCgkJCWRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoIm1venZpc2liaWxpdHljaGFuZ2UiLCBsaXN0ZW5lcik7CgkJZWxzZSBpZiAoKGhpZGRlbiA9ICJ3ZWJraXRIaWRkZW4iKSBpbiBkb2N1bWVudCkKCQkJZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcigid2Via2l0dmlzaWJpbGl0eWNoYW5nZSIsIGxpc3RlbmVyKTsKCQllbHNlIGlmICgoaGlkZGVuID0gIm1zSGlkZGVuIikgaW4gZG9jdW1lbnQpCgkJCWRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoIm1zdmlzaWJpbGl0eWNoYW5nZSIsIGxpc3RlbmVyKTsKCQlkb2N1bWVudC5vbmZvY3VzaW4gPSBkb2N1bWVudC5vbmZvY3Vzb3V0ID0gbnVsbDsKCQl3aW5kb3cub25wYWdlc2hvdyA9IHdpbmRvdy5vbnBhZ2VoaWRlID0gd2luZG93Lm9uZm9jdXMgPSB3aW5kb3cub25ibHVyID0gbnVsbDsKCX07CgoJcC5vbldpbmRvd1Zpc2liaWxpdHlDaGFuZ2VkID0gZnVuY3Rpb24oZXZ0KQoJewoJCXZhciB2ID0gJ3Zpc2libGUnLCBoID0gJ2hpZGRlbic7CgoJCWV2dCA9IGV2dCB8fCB3aW5kb3cuZXZlbnQ7CgkJdmFyIHZhbHVlOwoJCWlmIChldnRNYXApCgkJCXZhbHVlID0gZXZ0TWFwW2V2dC50eXBlXTsKCQllbHNlCgkJCXZhbHVlID0gZG9jdW1lbnRbaGlkZGVuXSA/IGggOiB2OwoJCWlmKHZhbHVlID09IGgpCgkJCXRoaXMucGF1c2UoKTsKCQllbHNlCgkJCXRoaXMucmVzdW1lKCk7Cgl9OwoJCgkvKioKCSogIERlZmluZSBhbGwgb2YgdGhlIHF1ZXJ5IHN0cmluZyBwYXJhbWV0ZXJzCgkqICBAcHJpdmF0ZQoJKiAgQG1ldGhvZCBwYXJzZVF1ZXJ5U3RyaW5nUGFyYW1zCgkqICBAcGFyYW0ge29iamVjdH0gb3V0cHV0IFRoZSBvYmplY3QgcmVmZXJlbmNlIHRvIHVwZGF0ZQoJKi8KCXZhciBwYXJzZVF1ZXJ5U3RyaW5nUGFyYW1zID0gZnVuY3Rpb24ob3V0cHV0KQoJewoJCXZhciBocmVmID0gd2luZG93LmxvY2F0aW9uLmhyZWY7CgkJdmFyIHF1ZXN0aW9uTWFyayA9IGhyZWYuaW5kZXhPZigiPyIpOwoJCWlmIChxdWVzdGlvbk1hcmsgPT0gLTEpIHJldHVybiBvdXRwdXQ7CgkJCgkJdmFyIHZhcnMgPSBxdWVzdGlvbk1hcmsgPCAwID8gJycgOiBocmVmLnN1YnN0cihxdWVzdGlvbk1hcmsrMSk7CgkJdmFyIHBvdW5kID0gdmFycy5pbmRleE9mKCcjJyk7CgkJdmFycyA9IHBvdW5kIDwgMCA/IHZhcnMgOiB2YXJzLnN1YnN0cmluZygwLCBwb3VuZCk7CgkJdmFyIHNwbGl0Rmxhc2hWYXJzID0gdmFycy5zcGxpdCgiJiIpOwoJCXZhciBteVZhcjsKCQlmb3IgKHZhciBpID0gMDsgaSA8IHNwbGl0Rmxhc2hWYXJzLmxlbmd0aDsgaSsrKQoJCXsKCQkJbXlWYXIgPSBzcGxpdEZsYXNoVmFyc1tpXS5zcGxpdCgiPSIpOwoJCQlpZiAodHJ1ZSkKCQkJewoJCQkJRGVidWcubG9nKG15VmFyWzBdICsgIiAtPiAiICsgbXlWYXJbMV0pOwoJCQl9CgkJCW91dHB1dFtteVZhclswXV0gPSBteVZhclsxXTsKCQl9CgkJcmV0dXJuIG91dHB1dDsKCX07CgkKCS8qKgoJKiAgUGF1c2UgdGhlIE9TIGFuZCBzdG9wIGZyYW1lIHVwZGF0ZXMKCSogIEBwdWJsaWMKCSogIEBtZXRob2QgcGF1c2UKCSovCglwLnBhdXNlID0gZnVuY3Rpb24oKQoJewoJCWlmKF90aWNrSWQgIT0gLTEpCgkJewoJCQlpZihfdXNlUkFGKQoJCQl7CgkJCQlpZih3aW5kb3cuY2FuY2VsQW5pbWF0aW9uRnJhbWUpCgkJCQkJY2FuY2VsQW5pbWF0aW9uRnJhbWUoX3RpY2tJZCk7CgkJCX0KCQkJZWxzZQoJCQkJY2xlYXJUaW1lb3V0KF90aWNrSWQpOwoJCQlfdGlja0lkID0gLTE7CgkJfQoJCV9wYXVzZWQgPSB0cnVlOwoJfTsKCQoJdmFyIG5vd0Z1bmMgPSB3aW5kb3cucGVyZm9ybWFuY2UgJiYgKHBlcmZvcm1hbmNlLm5vdyB8fCBwZXJmb3JtYW5jZS5tb3pOb3cgfHwgcGVyZm9ybWFuY2UubXNOb3cgfHwgcGVyZm9ybWFuY2Uub05vdyB8fCBwZXJmb3JtYW5jZS53ZWJraXROb3cpOwoJaWYobm93RnVuYykKCQlub3dGdW5jID0gbm93RnVuYy5iaW5kKHBlcmZvcm1hbmNlKTsKCWVsc2UKCQlub3dGdW5jID0gZnVuY3Rpb24oKSB7IHJldHVybiBuZXcgRGF0ZSgpLmdldFRpbWUoKTsgfTsvL2FwcGFyZW50bHkgaW4gQ2hyb21lIHRoaXMgaXMgZXh0cmVtZWx5IGluYWNjdXJhdGUgKHRyaXBsZSBmcmFtZXJhdGUgb3Igc29tZXRoaW5nIHNpbGx5KQoKCS8qKgoJKiAgR2V0cyB0aGUgY3VycmVudCB0aW1lIGluIG1pbGxpc2Vjb25kcyBmb3IgdGltaW5nIHB1cnBvc2VzCgkqICBAcHVibGljCgkqICBAbWV0aG9kIGdldFRpbWUKCSovCglwLmdldFRpbWUgPSBmdW5jdGlvbigpCgl7CgkJcmV0dXJuIG5vd0Z1bmMoKTsKCX07CgkKCS8qKgoJKiAgUmVzdW1lIHRoZSBPUyB1cGRhdGVzCgkqICBAcHVibGljCgkqICBAbWV0aG9kIHJlc3VtZQoJKi8KCXAucmVzdW1lID0gZnVuY3Rpb24oKQoJewoJCV9wYXVzZWQgPSBmYWxzZTsKCQkKCQlpZihfdGlja0lkID09IC0xKQoJCXsKCQkJX3RpY2tJZCA9IF91c2VSQUYgPyAKCQkJCXJlcXVlc3RBbmltRnJhbWUoX3RpY2tDYWxsYmFjayk6IAoJCQkJc2V0VGFyZ2V0ZWRUaW1lb3V0KF90aWNrQ2FsbGJhY2spOwoJCX0KCQlfbGFzdEZQU1VwZGF0ZVRpbWUgPSBfbGFzdEZyYW1lVGltZSA9IHRoaXMuZ2V0VGltZSgpOwoJfTsKCQoJLyoqCgkqIFRoZSBGUFMgdGhhdCB0aGUgT1MgaXMgdGFyZ2V0aW5nLgoJKiAKCSogQHByb3BlcnR5IHtOdW1iZXJ9IGZwcwoJKiBAcHVibGljCgkqLwoJT2JqZWN0LmRlZmluZVByb3BlcnR5KHAsICJmcHMiLCB7CgkJZ2V0OiBmdW5jdGlvbigpIHsgcmV0dXJuIF9mcHM7IH0sCgkJc2V0OiBmdW5jdGlvbih2YWx1ZSkgewoJCQlpZih0eXBlb2YgdmFsdWUgIT0gIm51bWJlciIpIHJldHVybjsKCQkJX2ZwcyA9IHZhbHVlOwoJCQlfbXNQZXJGcmFtZSA9ICgxMDAwIC8gX2ZwcykgfCAwOwoJCX0KCX0pOwoJCgkvKioKCSogIENvbnZlbmllbmNlIGZvciBhY2Nlc3NpbmcgdGhlIHN0YWdlJ3Mgd2lkdGgKCSogICAKCSogIEBwcm9wZXJ0eSB7TnVtYmVyfSBzdGFnZVdpZHRoCgkqICBAcHVibGljCgkqICBAcmVhZE9ubHkKCSovCglPYmplY3QuZGVmaW5lUHJvcGVydHkocCwgInN0YWdlV2lkdGgiLCB7CgkJZ2V0OiBmdW5jdGlvbigpewoJCQlpZiAodHJ1ZSkgcmV0dXJuIF9pbnN0YW5jZS5zdGFnZS5jYW52YXMud2lkdGg7CgkJCWlmIChmYWxzZSkgcmV0dXJuIF9pbnN0YW5jZS5fcmVuZGVyZXIudmlldy53aWR0aDsKCQl9Cgl9KTsKCQoJLyoqCgkqICBDb252ZW5pZW5jZSBmb3IgYWNjZXNzaW5nIHRoZSBzdGFnZSdzIGhlaWdodAoJKiAgIAoJKiAgQHByb3BlcnR5IHtOdW1iZXJ9IHN0YWdlSGVpZ2h0CgkqICBAcHVibGljCgkqICBAcmVhZE9ubHkKCSovCglPYmplY3QuZGVmaW5lUHJvcGVydHkocCwgInN0YWdlSGVpZ2h0IiwgewoJCWdldDogZnVuY3Rpb24oKXsKCQkJaWYgKHRydWUpIHJldHVybiBfaW5zdGFuY2Uuc3RhZ2UuY2FudmFzLmhlaWdodDsKCQkJaWYgKGZhbHNlKSByZXR1cm4gX2luc3RhbmNlLl9yZW5kZXJlci52aWV3LmhlaWdodDsKCQl9Cgl9KTsKCQoJdmFyIHNldFRhcmdldGVkVGltZW91dCA9IGZ1bmN0aW9uKGNhbGxiYWNrLCB0aW1lSW5GcmFtZSkKCXsKCQl2YXIgdGltZVRvQ2FsbCA9IDA7CgkJaWYodGltZUluRnJhbWUpCgkJCXRpbWVUb0NhbGwgPSBNYXRoLm1heCgwLCBfbXNQZXJGcmFtZSAtIHRpbWVJbkZyYW1lKTsvL3N1YnRyYWN0IHRoZSB0aW1lIHNwZW50IGluIHRoZSBmcmFtZSB0byBhY3R1YWxseSBoaXQgdGhlIHRhcmdldCBmcHMKCQlyZXR1cm4gc2V0VGltZW91dChjYWxsYmFjaywgdGltZVRvQ2FsbCk7Cgl9OwoJCgkvKioKCSogIFJlbW92ZSB0aGUgYXBwbGljYXRpb24KCSogIEBwdWJsaWMKCSogIEBtZXRob2QgcmVtb3ZlQXBwCgkqICBAcGFyYW0ge0Jvb2xlYW59IGRlc3Ryb3lpbmcgSWYgdGhlIE9TIGlzIGJlaW5nIGRlc3Ryb3llZCBhbmQgc2hvdWxkbid0IGJvdGhlciBydW5uaW5nIGFueSByZXNldHRpbmcgY29kZS4KCSogIEByZXR1cm4ge0Jvb2xlYW59IElmIGFuIGBBcHBsaWNhdGlvbmAgd2FzIHN1Y2Nlc3NmdWxseSByZW1vdmVkCgkqLwoJcC5yZW1vdmVBcHAgPSBmdW5jdGlvbihkZXN0cm95aW5nKQoJewoJCXZhciByZW1vdmVkID0gZmFsc2U7CgkJCgkJdmFyIHN0YWdlID0gdGhpcy5zdGFnZTsKCQlpZiAodGhpcy5fYXBwKQoJCXsKCQkJaWYodHJ1ZSkKCQkJewoJCQkJaWYodGhpcy5jb250YWlucyh0aGlzLl9hcHApKQoJCQkJCXRoaXMucmVtb3ZlQ2hpbGQodGhpcy5fYXBwKTsKCQkJCXN0YWdlLnJlbW92ZUFsbENoaWxkcmVuKCk7CgkJCX0KCQkJaWYoZmFsc2UpCgkJCXsKCQkJCWlmKHRoaXMuX2FwcC5wYXJlbnQgPT0gdGhpcykKCQkJCQl0aGlzLnJlbW92ZUNoaWxkKHRoaXMuX2FwcCk7CgkJCQlzdGFnZS5yZW1vdmVDaGlsZHJlbigpOwoJCQl9CgkJCXRoaXMuX2FwcC5kZXN0cm95KCk7CgkJCXJlbW92ZWQgPSB0cnVlOwoJCX0KCQl0aGlzLl9hcHAgPSBudWxsOwoJCQoJCS8vIFN0b3AgdGhlIHVwZGF0ZQoJCXRoaXMucGF1c2UoKTsKCQkJCQoJCWlmKCFkZXN0cm95aW5nKQoJCXsJCQkKCQkJc3RhZ2UuYWRkQ2hpbGQodGhpcyk7CgkJCWlmKF9mcmFtZXJhdGUpCgkJCXsKCQkJCS8vIFJlc2V0IHRoZSBmcmFtZXJhdGUKCQkJCV9mcmFtZXJhdGUudGV4dCA9ICJGUFM6IDAuMDAwIjsKCQkJfQoJCQkKCQkJLy8gSWdub3JlIHNwaWtlcyBpbiBmcmFtZSBjb3VudAoJCQlfbGFzdEZyYW1lVGltZSA9IF9sYXN0RlBTVXBkYXRlVGltZSA9IF9mcmFtZXJhdGVWYWx1ZSA9IF9mcmFtZUNvdW50ID0gMDsKCQkJCgkJCS8vIFVwZGF0ZSB0aGUgc3RhZ2UKCQkJaWYoZmFsc2UpIHRoaXMuX3JlbmRlcmVyLnJlbmRlcihzdGFnZSk7CgkJCWVsc2UgaWYodHJ1ZSkgdGhpcy5zdGFnZS51cGRhdGUoKTsKCQl9CgkJCgkJcmV0dXJuIHJlbW92ZWQ7Cgl9OwoJCgkvKioKCSogIEFkZCBhbiBhcHAgdG8gdGhpcyBkaXNwbGF5IGxpc3QKCSogIEBwdWJsaWMgCgkqICBAbWV0aG9kIGFkZEFwcAoJKiAgQHBhcmFtIHtBcHBsaWNhdGlvbn0gYXBwIFRoZSBhcHBsaWNhdGlvbiB0byBhZGQKCSovCglwLmFkZEFwcCA9IGZ1bmN0aW9uKGFwcCkKCXsKCQl0aGlzLnJlbW92ZUFwcCgpOwoJCWlmICghKGFwcCBpbnN0YW5jZW9mIGNsb3Vka2lkLkFwcGxpY2F0aW9uKSkKCQl7CgkJCXRocm93IG5ldyBFcnJvcigiQ2FuIG9ubHkgb2JqZWN0cyB0aGF0IGluaGVyaXQgY2xvdWRraWQuQXBwbGljYXRpb24iKTsKCQl9CgkJdGhpcy5fYXBwID0gYXBwOwoJCWlmIChfaXNSZWFkeSkKCQl7CgkJCXRoaXMuYWRkQ2hpbGRBdChhcHAsIDApOwoJCQl0aGlzLl9hcHAuaW5pdCgpOwoJCQl0aGlzLnJlc3VtZSgpOwoJCX0KCX07CgkKCS8qKgoJKiAgR2V0IHRoZSBjdXJyZW50IGFwcGxpY2F0aW9uCgkqICBAbWV0aG9kIGdldEFwcAoJKiAgQHB1YmxpYwoJKiAgQHJldHVybiB7QXBwbGljYXRpb259IFRoZSBjdXJyZW50IEFwcGxpY2F0aW9uLCBudWxsIGlmIG5vIGFwcGxpY2F0aW9uCgkqLwoJcC5nZXRBcHAgPSBmdW5jdGlvbigpCgl7CgkJcmV0dXJuIHRoaXMuX2FwcDsKCX07CgkKCS8qKgoJKiAgQWRkIGFuIHVwZGF0ZSBjYWxsYmFjaywgbXVzdCB0YWtlIGVsYXBzZWQgYXMgYSBwYXJhbWV0ZXIKCSogIEBtZXRob2QgYWRkVXBkYXRlQ2FsbGJhY2sKCSogIEBwdWJsaWMKCSogIEBwYXJhbSB7c3RyaW5nfSBhbGlhcyBBbiBhbGlhcyB0byBhc3NvY2lhdGUgd2l0aCB0aGlzIGNhbGxiYWNrCgkqICBAcGFyYW0ge2Z1bmN0aW9ufSBmIFRoZSBjYWxsYmFjayBmdW5jdGlvbgoJKi8KCXAuYWRkVXBkYXRlQ2FsbGJhY2sgPSBmdW5jdGlvbihhbGlhcywgZikKCXsKCQlpZiAodGhpcy5fdXBkYXRlRnVuY3Rpb25zW2FsaWFzXSA9PT0gdW5kZWZpbmVkKQoJCXsKCQkJdGhpcy5fdXBkYXRlRnVuY3Rpb25zW2FsaWFzXSA9IGY7CgkJfQkJCgl9OwoJCgkvKioKCSogIFJlbW92ZSBhbiB1cGRhdGUgY2FsbGJhY2ssIG11c3QgdGFrZSBlbGFwc2VkIGFzIGEgcGFyYW1ldGVyCgkqICBAcHVibGljCgkqICBAbWV0aG9kIHJlbW92ZVVwZGF0ZUNhbGxiYWNrCgkqICBAcGFyYW0ge3N0cmluZ30gYWxpYXMgVGhlIGNhbGxiYWNrIGZ1bmN0aW9uIGFsaWFzCgkqLwoJcC5yZW1vdmVVcGRhdGVDYWxsYmFjayA9IGZ1bmN0aW9uKGFsaWFzKQoJewoJCWlmICh0aGlzLl91cGRhdGVGdW5jdGlvbnNbYWxpYXNdICE9PSB1bmRlZmluZWQpCgkJewoJCQlkZWxldGUgdGhpcy5fdXBkYXRlRnVuY3Rpb25zW2FsaWFzXTsKCQl9Cgl9OwoJCgkvKioKCSogIENhbGxlZCBieSB0aGUgc3RhZ2UgbGlzdGVuZXIKCSogIEBwdWJsaWMKCSogIEBtZXRob2QgdGljawoJKi8KCXAudGljayA9IGZ1bmN0aW9uKCkKCXsKCQlpZiAoX3BhdXNlZCkKCQl7CgkJCV90aWNrSWQgPSAtMTsKCQkJcmV0dXJuOwoJCX0KCQkKCQl2YXIgbm93ID0gdGhpcy5nZXRUaW1lKCk7CgkJdmFyIGRUaW1lID0gbm93IC0gX2xhc3RGcmFtZVRpbWU7CgkJCgkJLy8gT25seSB1cGRhdGUgdGhlIGZyYW1lcmF0ZSBldmVyIHNlY29uZAoJCWlmKF9mcmFtZXJhdGUgJiYgX2ZyYW1lcmF0ZS52aXNpYmxlKQoJCXsKCQkJX2ZyYW1lQ291bnQrKzsKCQkJdmFyIGVsYXBzZWQgPSBub3cgLSBfbGFzdEZQU1VwZGF0ZVRpbWU7CgkJCWlmIChlbGFwc2VkID4gMTAwMCkKCQkJewoJCQkJX2ZyYW1lcmF0ZVZhbHVlID0gMTAwMCAvIGVsYXBzZWQgKiBfZnJhbWVDb3VudDsKCQkJCWlmKGZhbHNlKQoJCQkJCV9mcmFtZXJhdGUuc2V0VGV4dCgiRlBTOiAiICsgKE1hdGgucm91bmQoX2ZyYW1lcmF0ZVZhbHVlICogMTAwMCkgLyAxMDAwKSk7CgkJCQllbHNlIGlmKHRydWUpCgkJCQkJX2ZyYW1lcmF0ZS50ZXh0ID0gIkZQUzogIiArIChNYXRoLnJvdW5kKF9mcmFtZXJhdGVWYWx1ZSAqIDEwMDApIC8gMTAwMCk7CgkJCQlfbGFzdEZQU1VwZGF0ZVRpbWUgPSBub3c7CgkJCQlfZnJhbWVDb3VudCA9IDA7CgkJCX0KCQl9CgkJX2xhc3RGcmFtZVRpbWUgPSBub3c7CgkJCgkJLy91cGRhdGUgYXBwCQkJCQoJCWlmICh0aGlzLl9hcHApCgkJewoJCQl0aGlzLl9hcHAudXBkYXRlKGRUaW1lKTsKCQl9CgkJLy91cGRhdGUgb3RoZXIgZnVuY3Rpb25zCgkJZm9yKHZhciBhbGlhcyBpbiB0aGlzLl91cGRhdGVGdW5jdGlvbnMpCgkJewoJCQl0aGlzLl91cGRhdGVGdW5jdGlvbnNbYWxpYXNdKGRUaW1lKTsKCQl9CgkJLy9yZW5kZXIgc3RhZ2UKCQlpZiAoZmFsc2UpIHRoaXMuX3JlbmRlcmVyLnJlbmRlcih0aGlzLnN0YWdlKTsKCQlpZiAodHJ1ZSkgdGhpcy5zdGFnZS51cGRhdGUoZFRpbWUpOwoJCQoJCS8vcmVxdWVzdCB0aGUgbmV4dCBhbmltYXRpb24gZnJhbWUKCQlfdGlja0lkID0gX3VzZVJBRiA/IAoJCQlyZXF1ZXN0QW5pbUZyYW1lKF90aWNrQ2FsbGJhY2spIDogCgkJCXNldFRhcmdldGVkVGltZW91dChfdGlja0NhbGxiYWNrLCB0aGlzLmdldFRpbWUoKSAtIF9sYXN0RnJhbWVUaW1lKTsKCX07CgkKCS8qKgoJKiAgW1BJWEkgT25seV0gUmVzaXplcyB0aGUgcmVuZGVyZXIgYW5kIHRoZSBjYW52YXNDb250YWluZXIuCgkqICBAcHVibGljCgkqICBAbWV0aG9kIHJlc2l6ZQoJKi8KCWlmKGZhbHNlKQoJewoJCXAucmVzaXplID0gZnVuY3Rpb24od2lkdGgsIGhlaWdodCkKCQl7CgkJCXRoaXMuX3JlbmRlcmVyLnJlc2l6ZSh3aWR0aCwgaGVpZ2h0KTsKCQkJdGhpcy5jYW52YXNDb250YWluZXIuc2V0QXR0cmlidXRlKCJzdHlsZSIsInBvc2l0aW9uOnJlbGF0aXZlO3dpZHRoOiIgKyB3aWR0aCArICJweDtoZWlnaHQ6IiArIGhlaWdodCArICJweCIpOwoJCX07Cgl9CgkKCS8qKgoJKiAgRGVzdHJveSB0aGUgaW5zdGFuY2Ugb2YgdGhlIE9TLCBjYW4gaW5pdCBhZnRlciB0aGlzLAoJKiAgYWxzbyBkZXN0cm95cyB0aGUgYXBwbGljYXRpb24sIGlmIGFyb3VuZAoJKiAgQHB1YmxpYwoJKiAgQG1ldGhvZCBkZXN0cm95CgkqLwoJcC5kZXN0cm95ID0gZnVuY3Rpb24oKQoJewoJCXZhciBzdGFnZSA9IHRoaXMuc3RhZ2U7Ly9rZWVwIGEgcmVmZXJlbmNlIGZvciBsYXRlciBpbiBjYXNlIHRoZSBPUyBpcyByZW1vdmVkIGZyb20gdGhlIHN0YWdlCgkJCgkJdmFyIG1sID0gY2xvdWRraWQuTWVkaWFMb2FkZXIuaW5zdGFuY2U7CgkJdGhpcy5wYXVzZSgpOwoJCXRoaXMucmVtb3ZlQXBwKHRydWUpOwoJCV9pbnN0YW5jZSA9IG51bGw7CgkJCgkJaWYodHJ1ZSkKCQl7CgkJCWNyZWF0ZWpzLlRvdWNoLmRpc2FibGUoc3RhZ2UpOwoJCQlzdGFnZS5lbmFibGVNb3VzZU92ZXIoLTEpOy8vZGlzYWJsZSBtb3VzZW92ZXIgZXZlbnRzCgkJCXN0YWdlLmVuYWJsZURPTUV2ZW50cyhmYWxzZSk7CgkJfQoJCQoJCW1sLmRlc3Ryb3koKTsKCQl0aGlzLnN0YWdlID0gbnVsbDsKCQl0aGlzLl91cGRhdGVGdW5jdGlvbnMgPSBudWxsOwoJCXJlbW92ZVBhZ2VIaWRlTGlzdGVuZXIodGhpcy52aXNpYmxlTGlzdGVuZXIpOwoJCQoJCWlmKGZhbHNlKQoJCXsKCQkJdGhpcy5yZW1vdmVDaGlsZHJlbih0cnVlKTsKCQkJc3RhZ2UuZGVzdHJveSgpOwoJCQl0aGlzLl9yZW5kZXJlci5kZXN0cm95KCk7CgkJCXRoaXMuX3JlbmRlcmVyID0gbnVsbDsKCQkJdGhpcy5jYW52YXNDb250YWluZXIgPSBudWxsOwoJCX0KCX07CgkKCS8qKgoJKiAgU3RhdGljIGZ1bmN0aW9uIGZvciBnZXR0aW5nIHRoZSBzaW5nbGV0b24gaW5zdGFuY2UKCSogIEBzdGF0aWMKCSogIEByZWFkT25seQoJKiAgQHB1YmxpYwoJKiAgQGF0dHJpYnV0ZSBpbnN0YW5jZQoJKiAgQHR5cGUgT1MKCSovCglPYmplY3QuZGVmaW5lUHJvcGVydHkoT1MsICJpbnN0YW5jZSIsIHsKCQlnZXQ6ZnVuY3Rpb24oKQoJCXsKCQkJaWYgKCFfaW5zdGFuY2UpCgkJCXsKCQkJCXRocm93ICdDYWxsIGNsb3Vka2lkLk9TLmluaXQoY2FudmFzSWQpJzsKCQkJfQoJCQlyZXR1cm4gX2luc3RhbmNlOwoJCX0KCX0pOwoJCgkvLyBBZGQgdG8gdGhlIG5hbWUgc3BhY2UKCW5hbWVzcGFjZSgnY2xvdWRraWQnKS5PUyA9IE9TOwp9KCkpOwovKioKKiAgQG1vZHVsZSBjbG91ZGtpZAoqLwooZnVuY3Rpb24od2luZG93KXsKCQoJInVzZSBzdHJpY3QiOwoKCS8qKgoJKiAgW0NyZWF0ZUpTIG9ubHldIERlc2lnbmVkIHRvIHByb3ZpZGUgdXRpbGl0eSByZWxhdGVkIHRvIGZ1bmN0aW9ucyBhbmQgcG9seWZpbGxzCgkqICBAY2xhc3MgRnVuY3Rpb25VdGlscyAoQ3JlYXRlSlMpCgkqLwoJdmFyIEZ1bmN0aW9uVXRpbHMgPSB7fTsKCQoJLy8gSWYgdGhlcmUncyBhbHJlYWR5IGEgYmluZCwgaWdub3JlCglpZiAoIUZ1bmN0aW9uLnByb3RvdHlwZS5iaW5kKQoJewoJCS8qKgoJCSogIEFkZCB0aGUgYmluZCBmdW5jdGlvbmFsaXR5IHRvIHRoZSBGdW5jdGlvbiBwcm90b3R5cGUKCQkqICB0aGlzIGFsbG93cyBwYXNzaW5nIGEgcmVmZXJlbmNlIGluIHRoZSBmdW5jdGlvbiBjYWxsYmFjayAKCQkqCgkJKgl2YXIgY2FsbGJhY2sgPSBmdW5jdGlvbigpe307CgkJKgljbG91ZGtpZC5NZWRpYUxvYWRlci5pbnN0YW5jZS5sb2FkKCdzb21ldGhpbmcuanNvbicsIGNhbGxiYWNrLmJpbmQodGhpcykpOwoJCSoKCQkqICBAbWV0aG9kIGJpbmQKCQkqICBAc3RhdGljCgkJKiAgQHBhcmFtIHtmdW5jdGlvbn0gdGhhdCBUaGUgcmVmZXJlbmNlIHRvIHRoZSBmdW5jdGlvbgoJCSogIEByZXR1cm4ge2Z1bmN0aW9ufSBUaGUgYm91bmQgZnVuY3Rpb24KCQkqLwoJCUZ1bmN0aW9uVXRpbHMuYmluZCA9IEZ1bmN0aW9uLnByb3RvdHlwZS5iaW5kID0gZnVuY3Rpb24gYmluZCh0aGF0KSAKCQl7CgkJCXZhciB0YXJnZXQgPSB0aGlzOwoKCQkJaWYgKHR5cGVvZiB0YXJnZXQgIT0gImZ1bmN0aW9uIikgCgkJCXsKCQkJCXRocm93IG5ldyBUeXBlRXJyb3IoKTsKCQkJfQoKCQkJdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpLAoJCQlib3VuZCA9IGZ1bmN0aW9uKCkKCQkJewoJCQkJaWYgKHRoaXMgaW5zdGFuY2VvZiBib3VuZCkgCgkJCQl7CgkJCQkJdmFyIEYgPSBmdW5jdGlvbigpe307CgkJCQkJRi5wcm90b3R5cGUgPSB0YXJnZXQucHJvdG90eXBlOwoJCQkJCXZhciBzZWxmID0gbmV3IEYoKTsKCgkJCQkJdmFyIHJlc3VsdCA9IHRhcmdldC5hcHBseShzZWxmLCBhcmdzLmNvbmNhdChBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMpKSk7CgkJCQkKCQkJCQlpZiAoT2JqZWN0KHJlc3VsdCkgPT09IHJlc3VsdCkKCQkJCQl7CgkJCQkJCXJldHVybiByZXN1bHQ7CgkJCQkJfQoJCQkJCXJldHVybiBzZWxmOwoJCQkJfQoJCQkJZWxzZSAKCQkJCXsKCQkJCQlyZXR1cm4gdGFyZ2V0LmFwcGx5KHRoYXQsIGFyZ3MuY29uY2F0KEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cykpKTsKCQkJCX0KCQkJfTsKCQkJcmV0dXJuIGJvdW5kOwoJCX07Cgl9CgkKCS8vIGh0dHA6Ly9wYXVsaXJpc2guY29tLzIwMTEvcmVxdWVzdGFuaW1hdGlvbmZyYW1lLWZvci1zbWFydC1hbmltYXRpbmcvCgkvLyBodHRwOi8vbXkub3BlcmEuY29tL2Vtb2xsZXIvYmxvZy8yMDExLzEyLzIwL3JlcXVlc3RhbmltYXRpb25mcmFtZS1mb3Itc21hcnQtZXItYW5pbWF0aW5nCgkvLyByZXF1ZXN0QW5pbWF0aW9uRnJhbWUgcG9seWZpbGwgYnkgRXJpayBNPz9sbGVyLiBmaXhlcyBmcm9tIFBhdWwgSXJpc2ggYW5kIFRpbm8gWmlqZGVsCgkvLyBNSVQgbGljZW5zZQoKCXZhciBsYXN0VGltZSA9IDA7Cgl2YXIgdmVuZG9ycyA9IFsnbXMnLCAnbW96JywgJ3dlYmtpdCcsICdvJ107Cglmb3IodmFyIHggPSAwOyB4IDwgdmVuZG9ycy5sZW5ndGggJiYgIXdpbmRvdy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWU7ICsreCkKCXsKCQl3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lID0gd2luZG93W3ZlbmRvcnNbeF0rJ1JlcXVlc3RBbmltYXRpb25GcmFtZSddOwoJCXdpbmRvdy5jYW5jZWxBbmltYXRpb25GcmFtZSA9IHdpbmRvd1t2ZW5kb3JzW3hdKydDYW5jZWxBbmltYXRpb25GcmFtZSddIHx8IHdpbmRvd1t2ZW5kb3JzW3hdKydDYW5jZWxSZXF1ZXN0QW5pbWF0aW9uRnJhbWUnXTsKCX0KCgkvLyBDaGVjayBmb3IgdGhlIGFuaW1hdGlvbiBmcmFtZQoJaWYgKCF3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lKQoJewoJCS8vIENyZWF0ZSB0aGUgcG9seWZpbGwKCQl3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lID0gZnVuY3Rpb24oY2FsbGJhY2spCgkJewoJCQl2YXIgY3VyclRpbWUgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTsKCQkJdmFyIHRpbWVUb0NhbGwgPSBNYXRoLm1heCgwLCAxNiAtIChjdXJyVGltZSAtIGxhc3RUaW1lKSk7CgkJCXZhciBpZCA9IHdpbmRvdy5zZXRUaW1lb3V0KGZ1bmN0aW9uKCkgeyBjYWxsYmFjayhjdXJyVGltZSArIHRpbWVUb0NhbGwpOyB9LCB0aW1lVG9DYWxsKTsKCQkJbGFzdFRpbWUgPSBjdXJyVGltZSArIHRpbWVUb0NhbGw7CgkJCXJldHVybiBpZDsKCQl9OwoKCQkvLyBPbmx5IHNldCB0aGlzIHVwIGlmIHRoZSBjb3JyZXNwb25kaW5nIHJlcXVlc3RBbmltYXRpb25GcmFtZSB3YXMgc2V0IHVwCgkJaWYgKCF3aW5kb3cuY2FuY2VsQW5pbWF0aW9uRnJhbWUpCgkJewoJCQl3aW5kb3cuY2FuY2VsQW5pbWF0aW9uRnJhbWUgPSBmdW5jdGlvbihpZCkgewoJCQkJY2xlYXJUaW1lb3V0KGlkKTsKCQkJfTsKCQl9Cgl9CgoJLyoqCgkqICBBIHBvbHlmaWxsIGZvciByZXF1ZXN0QW5pbWF0aW9uRnJhbWUsIHRoaXMgYWxzbyBnZXRzIGFzc2lnbmVkIHRvIHRoZSB3aW5kb3cgaWYgaXQgZG9lc24ndCBleGlzdAoJKiAgYWxzbyB3aW5kb3cucmVxdWVzdEFuaW1GcmFtZSBpcyBhIHJlZHVuZGFudCBhbmQgc2hvcnQgd2F5IHRvIGFjY2VzcyB0aGlzIHByb3BlcnR5CgkqICBAc3RhdGljCgkqICBAbWV0aG9kIHJlcXVlc3RBbmltYXRpb25GcmFtZQoJKi8KCUZ1bmN0aW9uVXRpbHMucmVxdWVzdEFuaW1hdGlvbkZyYW1lID0gd2luZG93LnJlcXVlc3RBbmltYXRpb25GcmFtZTsKCXdpbmRvdy5yZXF1ZXN0QW5pbUZyYW1lID0gd2luZG93LnJlcXVlc3RBbmltYXRpb25GcmFtZTsKCgkvKioKCSogIEEgcG9seWZpbGwgZm9yIGNhbmNlbEFuaW1hdGlvbkZyYW1lLCB0aGlzIGFsc28gZ2V0cyBhc3NpZ25lZCB0byB0aGUgd2luZG93IGlmIGl0IGRvZXNuJ3QgZXhpc3QKCSogIEBzdGF0aWMKCSogIEBtZXRob2QgY2FuY2VsQW5pbWF0aW9uRnJhbWUKCSovCglGdW5jdGlvblV0aWxzLmNhbmNlbEFuaW1hdGlvbkZyYW1lID0gd2luZG93LmNhbmNlbEFuaW1hdGlvbkZyYW1lOwkKCgkvLyBBc3NpZ24gdG8gbmFtZXNwYWNlCgluYW1lc3BhY2UoJ2Nsb3Vka2lkJykuRnVuY3Rpb25VdGlscyA9IEZ1bmN0aW9uVXRpbHM7CgkKfSh3aW5kb3cpKTsKLyoqCiogIEBtb2R1bGUgY2xvdWRraWQKKi8KKGZ1bmN0aW9uKCkgewoKCSJ1c2Ugc3RyaWN0IjsKCgkvKioKCSogIFtDcmVhdGVKUyBvbmx5XSBEZXNpZ25lZCB0byBwcm92aWRlIHV0aWxpdHkgcmVsYXRlZCB0byBCaXRtYXBzLgoJKiAgQGNsYXNzIEJpdG1hcFV0aWxzIChDcmVhdGVKUykKCSovCgl2YXIgQml0bWFwVXRpbHMgPSB7fTsKCgkvKioKCSoJUmVwbGFjZXMgQml0bWFwcyBpbiB0aGUgZ2xvYmFsIGxpYiBkaWN0aW9uYXJ5IHdpdGggYSB2ZXJzaW9uIHRoYXQgcHVsbHMgdGhlIGltYWdlIGZyb20gYSBzcHJpdGVzaGVldC4KCSoKCSoJQG1ldGhvZCBsb2FkU3ByaXRlU2hlZXQKCSoJQHN0YXRpYwoJKglAcGFyYW0ge09iamVjdH0gZnJhbWVEaWN0IEEgZGljdGlvbmFyeSBvZiBmcmFtZSBpbmZvcm1hdGlvbiwgd2l0aCBmcmFtZSwgdHJpbW1lZCwgCgkqCQlhbmQgc3ByaXRlU291cmNlU2l6ZSBwcm9wZXJ0aWVzIChsaWtlIHRoZSBKU09OIGhhc2ggb3V0cHV0IGZyb20gVGV4dHVyZVBhY2tlcikuCgkqCUBwYXJhbSB7SW1hZ2V8SFRNTENhbnZhc0VsZW1lbnR9IHNwcml0ZXNoZWV0SW1hZ2UgVGhlIHNwcml0ZXNoZWV0IGltYWdlIHRoYXQgY29udGFpbnMgYWxsIG9mIHRoZSBmcmFtZXMuCgkqCUBwYXJhbSB7TnVtYmVyfSBbc2NhbGU9MV0gVGhlIHNjYWxlIHRvIGFwcGx5IHRvIGFsbCBzcHJpdGVzIGZyb20gdGhlIHNwcml0ZXNoZWV0LiAKCSoJCUZvciBleGFtcGxlLCBhIGhhbGYgc2l6ZWQgc3ByaXRlc2hlZXQgc2hvdWxkIGhhdmUgYSBzY2FsZSBvZiAyLgoJKi8KCUJpdG1hcFV0aWxzLmxvYWRTcHJpdGVTaGVldCA9IGZ1bmN0aW9uKGZyYW1lRGljdCwgc3ByaXRlc2hlZXRJbWFnZSwgc2NhbGUpCgl7CgkJaWYoc2NhbGUgPiAwKSAKCQl7CgkJCS8vIERvIG5vdGhpbmcKCQl9CgkJZWxzZQoJCXsKCQkJc2NhbGUgPSAxOy8vc2NhbGUgc2hvdWxkIGRlZmF1bHQgdG8gMQoJCX0KCgkJZm9yKHZhciBrZXkgaW4gZnJhbWVEaWN0KQoJCXsKCQkJdmFyIGZyYW1lID0gZnJhbWVEaWN0W2tleV07CgkJCXZhciBpbmRleCA9IGtleS5pbmRleE9mKCIuIik7CgkJCWlmKGluZGV4ID4gMCkKCQkJCWtleSA9IGtleS5zdWJzdHJpbmcoMCwgaW5kZXgpOy8vcmVtb3ZlIGFueSBmaWxlIGV4dGVuc2lvbiBmcm9tIHRoZSBmcmFtZSBpZAoJCQl2YXIgYml0bWFwID0gbGliW2tleV07CgkJCS8qIGpzaGludCBpZ25vcmU6c3RhcnQgKi8KCQkJdmFyIG5ld0JpdG1hcCA9IGxpYltrZXldID0gZnVuY3Rpb24oKQoJCQl7CgkJCQljcmVhdGVqcy5Db250YWluZXIuY2FsbCh0aGlzKTsKCQkJCXZhciBjaGlsZCA9IG5ldyBjcmVhdGVqcy5CaXRtYXAodGhpcy5faW1hZ2UpOwoJCQkJdGhpcy5hZGRDaGlsZChjaGlsZCk7CgkJCQljaGlsZC5zb3VyY2VSZWN0ID0gdGhpcy5fZnJhbWVSZWN0OwoJCQkJdmFyIHMgPSB0aGlzLl9zY2FsZTsKCQkJCWNoaWxkLnNldFRyYW5zZm9ybSh0aGlzLl9mcmFtZU9mZnNldFggKiBzLCB0aGlzLl9mcmFtZU9mZnNldFkgKiBzLCBzLCBzKTsKCQkJfTsKCQkJLyoganNoaW50IGlnbm9yZTplbmQgKi8KCQkJdmFyIHAgPSBuZXdCaXRtYXAucHJvdG90eXBlID0gbmV3IGNyZWF0ZWpzLkNvbnRhaW5lcigpOwoJCQlwLl9pbWFnZSA9IHNwcml0ZXNoZWV0SW1hZ2U7Ly9naXZlIGl0IGEgcmVmZXJlbmNlIHRvIHRoZSBzcHJpdGVzaGVldAoJCQlwLl9zY2FsZSA9IHNjYWxlOy8vdGVsbCBpdCB3aGF0IHNjYWxlIHRvIHVzZSBvbiB0aGUgQml0bWFwIHRvIGJyaW5nIGl0IHRvIG5vcm1hbCBzaXplCgkJCXZhciBmcmFtZVJlY3QgPSBmcmFtZS5mcmFtZTsKCQkJLy9zYXZlIHRoZSBzb3VyY2UgcmVjdGFuZ2xlIG9mIHRoZSBzcHJpdGUKCQkJcC5fZnJhbWVSZWN0ID0gbmV3IGNyZWF0ZWpzLlJlY3RhbmdsZShmcmFtZVJlY3QueCwgZnJhbWVSZWN0LnksIGZyYW1lUmVjdC53LCBmcmFtZVJlY3QuaCk7CgkJCS8vaWYgdGhlIHNwcml0ZSBpcyB0cmltbWVkLCB0aGVuIHNhdmUgdGhlIGFtb3VudCB0aGF0IHdhcyB0cmltbWVkIG9mZiB0aGUgbGVmdCBhbmQgdG9wIHNpZGVzCgkJCWlmKGZyYW1lLnRyaW1tZWQpCgkJCXsKCQkJCXAuX2ZyYW1lT2Zmc2V0WCA9IGZyYW1lLnNwcml0ZVNvdXJjZVNpemUueDsKCQkJCXAuX2ZyYW1lT2Zmc2V0WSA9IGZyYW1lLnNwcml0ZVNvdXJjZVNpemUueTsKCQkJfQoJCQllbHNlCgkJCQlwLl9mcmFtZU9mZnNldFggPSBwLl9mcmFtZU9mZnNldFkgPSAwOwoJCQlpZihiaXRtYXAgJiYgYml0bWFwLnByb3RvdHlwZS5ub21pbmFsQm91bmRzKQoJCQkJcC5ub21pbmFsQm91bmRzID0gYml0bWFwLnByb3RvdHlwZS5ub21pbmFsQm91bmRzOy8va2VlcCB0aGUgbm9taW5hbCBib3VuZHMgZnJvbSB0aGUgb3JpZ2luYWwgYml0bWFwLCBpZiBpdCBleGlzdGVkCgkJCWVsc2UKCQkJCXAubm9taW5hbEJvdW5kcyA9IG5ldyBjcmVhdGVqcy5SZWN0YW5nbGUoMCwgMCwgZnJhbWUuc291cmNlU2l6ZS53LCBmcmFtZS5zb3VyY2VTaXplLmgpOwoJCX0KCX07CgoJLyoqCgkqCVJlcGxhY2VzIEJpdG1hcHMgaW4gdGhlIGdsb2JhbCBsaWIgZGljdGlvbmFyeSB3aXRoIGEgdmVyc2lvbiB0aGF0IHVzZXMgYSBzY2FsZWQgYml0bWFwLCBzbyB5b3UgY2FuIGxvYWQgdXAKCSoJc21hbGxlciBiaXRtYXBzIGJlaGluZCB0aGUgc2NlbmVzIHRoYXQgYXJlIHNjYWxlZCBiYWNrIHVwIHRvIG5vcm1hbCBzaXplLgoJKgoJKglAbWV0aG9kIHJlcGxhY2VXaXRoU2NhbGVkQml0bWFwCgkqCUBzdGF0aWMKCSoJQHBhcmFtIHtTdHJpbmd8T2JqZWN0fSBpZE9yRGljdCBBIGRpY3Rpb25hcnkgb2YgQml0bWFwIGlkcyB0byByZXBsYWNlLCBvciBhIHNpbmdsZSBpZC4KCSoJQHBhcmFtIHtOdW1iZXJ9IFtzY2FsZV0gVGhlIHNjYWxlIHRvIGFwcGx5IHRvIHRoZSBpbWFnZShzKS4KCSovCglCaXRtYXBVdGlscy5yZXBsYWNlV2l0aFNjYWxlZEJpdG1hcCA9IGZ1bmN0aW9uKGlkT3JEaWN0LCBzY2FsZSkKCXsKCQkvL3NjYWxlIGlzIHJlcXVpcmVkLCBidXQgaXQgZG9lc24ndCBodXJ0IHRvIGNoZWNrIC0gYWxzbywgZG9uJ3QgYm90aGVyIGZvciBhIHNjYWxlIG9mIDEKCQlpZihzY2FsZSAhPSAxICYmIHNjYWxlID4gMCkgCgkJewoJCQkvLyBEbyBub3RoaW5nCgkJfQoJCWVsc2UKCQl7CgkJCXJldHVybjsKCQl9CgoJCXZhciBrZXksIGJpdG1hcCwgbmV3Qml0bWFwLCBwOwoJCWlmKHR5cGVvZiBpZE9yRGljdCA9PSAic3RyaW5nIikKCQl7CgkJCWtleSA9IGlkT3JEaWN0OwoJCQliaXRtYXAgPSBsaWJba2V5XTsKCQkJaWYoYml0bWFwKQoJCQl7CgkJCQkvKiBqc2hpbnQgaWdub3JlOnN0YXJ0ICovCgkJCQluZXdCaXRtYXAgPSBsaWJba2V5XSA9IGZ1bmN0aW9uKCkKCQkJCXsKCQkJCQljcmVhdGVqcy5Db250YWluZXIuY2FsbCh0aGlzKTsKCQkJCQl2YXIgY2hpbGQgPSBuZXcgdGhpcy5fb2xkQk0oKTsKCQkJCQl0aGlzLmFkZENoaWxkKGNoaWxkKTsKCQkJCQljaGlsZC5zZXRUcmFuc2Zvcm0oMCwgMCwgdGhpcy5fc2NhbGUsIHRoaXMuX3NjYWxlKTsKCQkJCX07CgkJCQkvKiBqc2hpbnQgaWdub3JlOmVuZCAqLwoJCQkJcCA9IG5ld0JpdG1hcC5wcm90b3R5cGUgPSBuZXcgY3JlYXRlanMuQ29udGFpbmVyKCk7CgkJCQlwLl9vbGRCTSA9IGJpdG1hcDsvL2dpdmUgaXQgYSByZWZlcmVuY2UgdG8gdGhlIEJpdG1hcAoJCQkJcC5fc2NhbGUgPSBzY2FsZTsvL3RlbGwgaXQgd2hhdCBzY2FsZSB0byB1c2Ugb24gdGhlIEJpdG1hcCB0byBicmluZyBpdCB0byBub3JtYWwgc2l6ZQoJCQkJcC5ub21pbmFsQm91bmRzID0gYml0bWFwLnByb3RvdHlwZS5ub21pbmFsQm91bmRzOy8va2VlcCB0aGUgbm9taW5hbCBib3VuZHMKCQkJfQoJCX0KCQllbHNlCgkJewoJCQlmb3Ioa2V5IGluIGlkT3JEaWN0KQoJCQl7CgkJCQliaXRtYXAgPSBsaWJba2V5XTsKCQkJCWlmKGJpdG1hcCkKCQkJCXsKCQkJCQkvKiBqc2hpbnQgaWdub3JlOnN0YXJ0ICovCgkJCQkJbmV3Qml0bWFwID0gbGliW2tleV0gPSBmdW5jdGlvbigpCgkJCQkJewoJCQkJCQljcmVhdGVqcy5Db250YWluZXIuY2FsbCh0aGlzKTsKCQkJCQkJdmFyIGNoaWxkID0gbmV3IHRoaXMuX29sZEJNKCk7CgkJCQkJCXRoaXMuYWRkQ2hpbGQoY2hpbGQpOwoJCQkJCQljaGlsZC5zZXRUcmFuc2Zvcm0oMCwgMCwgdGhpcy5fc2NhbGUsIHRoaXMuX3NjYWxlKTsKCQkJCQl9OwoJCQkJCS8qIGpzaGludCBpZ25vcmU6ZW5kICovCgkJCQkJcCA9IG5ld0JpdG1hcC5wcm90b3R5cGUgPSBuZXcgY3JlYXRlanMuQ29udGFpbmVyKCk7CgkJCQkJcC5fb2xkQk0gPSBiaXRtYXA7Ly9naXZlIGl0IGEgcmVmZXJlbmNlIHRvIHRoZSBCaXRtYXAKCQkJCQlwLl9zY2FsZSA9IHNjYWxlOy8vdGVsbCBpdCB3aGF0IHNjYWxlIHRvIHVzZSBvbiB0aGUgQml0bWFwIHRvIGJyaW5nIGl0IHRvIG5vcm1hbCBzaXplCgkJCQkJcC5ub21pbmFsQm91bmRzID0gYml0bWFwLnByb3RvdHlwZS5ub21pbmFsQm91bmRzOy8va2VlcCB0aGUgbm9taW5hbCBib3VuZHMKCQkJCX0KCQkJfQoJCX0KCX07CgoJbmFtZXNwYWNlKCdjbG91ZGtpZCcpLkJpdG1hcFV0aWxzID0gQml0bWFwVXRpbHM7Cn0oKSk7Ci8qKgoqICBAbW9kdWxlIGNsb3Vka2lkCiovCihmdW5jdGlvbigpewoJCgkidXNlIHN0cmljdCI7CgkKCS8qKiAKCSogIFRoZSBTYXZlZERhdGEgZnVuY3Rpb25zIHVzZSBsb2NhbFN0b3JhZ2UgYW5kIHNlc3Npb25TdG9yYWdlLCB3aXRoIGEgY29va2llIGZhbGxiYWNrLiAKCSoKCSogIEBjbGFzcyBTYXZlZERhdGEKCSovCgl2YXIgU2F2ZWREYXRhID0ge30sCgkKCS8qKiBBIGNvbnN0YW50IHRvIGRldGVybWluZSBpZiB3ZSBjYW4gdXNlIGxvY2FsU3RvcmFnZSBhbmQgc2Vzc2lvblN0b3JhZ2UgKi8KCVdFQl9TVE9SQUdFX1NVUFBPUlQgPSB0eXBlb2Yod2luZG93LlN0b3JhZ2UpICE9PSAidW5kZWZpbmVkIiwKCQoJLyoqIEEgY29uc3RhbnQgZm9yIGNvb2tpZSBmYWxsYmFjayBmb3IgU2F2ZWREYXRhLmNsZWFyKCkgKi8KCUVSQVNFX0NPT0tJRSA9IC0xOwoKCS8vaW4gaU9TLCBpZiB0aGUgdXNlciBpcyBpbiBQcml2YXRlIEJyb3dzaW5nLCB3cml0aW5nIHRvIGxvY2FsU3RvcmFnZSB0aHJvd3MgYW4gZXJyb3IuCglpZihXRUJfU1RPUkFHRV9TVVBQT1JUKQoJewoJCXRyeQoJCXsKCQkJbG9jYWxTdG9yYWdlLnNldEl0ZW0oIkxTX1RFU1QiLCAidGVzdCIpOwoJCQlsb2NhbFN0b3JhZ2UucmVtb3ZlSXRlbSgiTFNfVEVTVCIpOwoJCX0KCQljYXRjaChlKQoJCXsKCQkJV0VCX1NUT1JBR0VfU1VQUE9SVCA9IGZhbHNlOwoJCX0KCX0KCgkvKioKCSAqIElmIFNhdmVkRGF0YSB3aWxsIGJlIHVzaW5nIGxvY2FsU3RvcmFnZSBhbmQgc2Vzc2lvblN0b3JhZ2UuCgkgKiBAcHJvcGVydHkge0Jvb2xlYW59IHVzZVdlYlN0b3JhZ2UKCSAqIEBkZWZhdWx0ICB0cnVlCgkgKi8KCU9iamVjdC5kZWZpbmVQcm9wZXJ0eShTYXZlZERhdGEsICJ1c2VXZWJTdG9yYWdlIiwgewoJCWdldDogZnVuY3Rpb24oKSB7IHJldHVybiBXRUJfU1RPUkFHRV9TVVBQT1JUOyB9LAoJCXNldDogZnVuY3Rpb24odmFsdWUpCgkJewoJCQlpZih2YWx1ZSAmJiB0eXBlb2Yod2luZG93LlN0b3JhZ2UpICE9PSAidW5kZWZpbmVkIikKCQkJewoJCQkJdHJ5CgkJCQl7CgkJCQkJbG9jYWxTdG9yYWdlLnNldEl0ZW0oIkxTX1RFU1QiLCAidGVzdCIpOwoJCQkJCWxvY2FsU3RvcmFnZS5yZW1vdmVJdGVtKCJMU19URVNUIik7CgkJCQkJV0VCX1NUT1JBR0VfU1VQUE9SVCA9IHRydWU7CgkJCQl9CgkJCQljYXRjaChlKQoJCQkJewoJCQkJCVdFQl9TVE9SQUdFX1NVUFBPUlQgPSBmYWxzZTsKCQkJCX0KCQkJfQoJCQllbHNlCgkJCQlXRUJfU1RPUkFHRV9TVVBQT1JUID0gZmFsc2U7CgkJfQoJfSk7IAoJCgkvKiogCgkqICBSZW1vdmUgYSBzYXZlZCB2YXJpYWJsZSBieSBuYW1lLgoJKiAgQG1ldGhvZCByZW1vdmUKCSogIEBzdGF0aWMKCSogIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSBuYW1lIG9mIHRoZSB2YWx1ZSB0byByZW1vdmUKCSovCglTYXZlZERhdGEucmVtb3ZlID0gZnVuY3Rpb24obmFtZSkKCXsKCQlpZihXRUJfU1RPUkFHRV9TVVBQT1JUKQoJCXsKCQkJbG9jYWxTdG9yYWdlLnJlbW92ZUl0ZW0obmFtZSk7CgkJCXNlc3Npb25TdG9yYWdlLnJlbW92ZUl0ZW0obmFtZSk7CgkJfQoJCWVsc2UKCQkJU2F2ZWREYXRhLndyaXRlKG5hbWUsIiIsRVJBU0VfQ09PS0lFKTsKCX07CgkKCS8qKgoJKiAgU2F2ZSBhIHZhcmlhYmxlLgoJKiAgQG1ldGhvZCB3cml0ZQoJKiAgQHN0YXRpYwoJKiAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIG5hbWUgb2YgdGhlIHZhbHVlIHRvIHNhdmUKCSogIEBwYXJhbSB7bWl4ZWR9IHZhbHVlIFRoZSB2YWx1ZSB0byBzYXZlLiBUaGlzIHdpbGwgYmUgcnVuIHRocm91Z2ggSlNPTi5zdHJpbmdpZnkoKS4KCSogIEBwYXJhbSB7Qm9vbGVhbn0gW3RlbXBPbmx5PWZhbHNlXSBJZiB0aGUgdmFsdWUgc2hvdWxkIGJlIHNhdmVkIG9ubHkgaW4gdGhlIGN1cnJlbnQgYnJvd3NlciBzZXNzaW9uLgoJKi8KCVNhdmVkRGF0YS53cml0ZSA9IGZ1bmN0aW9uKG5hbWUsIHZhbHVlLCB0ZW1wT25seSkKCXsKCQlpZihXRUJfU1RPUkFHRV9TVVBQT1JUKQoJCXsKCQkJaWYodGVtcE9ubHkpCgkJCQlzZXNzaW9uU3RvcmFnZS5zZXRJdGVtKG5hbWUsIEpTT04uc3RyaW5naWZ5KHZhbHVlKSk7CgkJCWVsc2UKCQkJCWxvY2FsU3RvcmFnZS5zZXRJdGVtKG5hbWUsIEpTT04uc3RyaW5naWZ5KHZhbHVlKSk7CgkJfQoJCWVsc2UKCQl7CgkJCXZhciBleHBpcmVzOwoJCQlpZiAodGVtcE9ubHkpCgkJCXsKCQkJCWlmKHRlbXBPbmx5ICE9PSBFUkFTRV9DT09LSUUpCgkJCQkJZXhwaXJlcyA9ICIiOy8vcmVtb3ZlIHdoZW4gYnJvd3NlciBpcyBjbG9zZWQKCQkJCWVsc2UKCQkJCQlleHBpcmVzID0gIjsgZXhwaXJlcz1UaHUsIDAxIEphbiAxOTcwIDAwOjAwOjAwIEdNVCI7Ly9zYXZlIGNvb2tpZSBpbiB0aGUgcGFzdCBmb3IgaW1tZWRpYXRlIHJlbW92YWwKCQkJfQoJCQllbHNlCgkJCQlleHBpcmVzID0gIjsgZXhwaXJlcz0iK25ldyBEYXRlKDIxNDc0ODM2NDYwMDApLnRvR01UU3RyaW5nKCk7Ly9USEUgRU5EIE9GICgzMmJpdCBVTklYKSBUSU1FIQoJCQkJCgkJCWRvY3VtZW50LmNvb2tpZSA9IG5hbWUrIj0iK2VzY2FwZShKU09OLnN0cmluZ2lmeSh2YWx1ZSkpK2V4cGlyZXMrIjsgcGF0aD0vIjsKCQl9Cgl9OwoJCgkvKioKCSogIFJlYWQgdGhlIHZhbHVlIG9mIGEgc2F2ZWQgdmFyaWFibGUKCSogIEBtZXRob2QgcmVhZAoJKiAgQHN0YXRpYwoJKiAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIG5hbWUgb2YgdGhlIHZhcmlhYmxlCgkqICBAcmV0dXJuIHttaXhlZH0gVGhlIHZhbHVlIChydW4gdGhyb3VnaCBgSlNPTi5wYXJzZSgpYCkgb3IgbnVsbCBpZiBpdCBkb2Vzbid0IGV4aXN0CgkqLwoJU2F2ZWREYXRhLnJlYWQgPSBmdW5jdGlvbihuYW1lKQoJewoJCWlmKFdFQl9TVE9SQUdFX1NVUFBPUlQpCgkJewoJCQl2YXIgdmFsdWUgPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbShuYW1lKSB8fCBzZXNzaW9uU3RvcmFnZS5nZXRJdGVtKG5hbWUpOwoJCQlpZih2YWx1ZSkKCQkJCXJldHVybiBKU09OLnBhcnNlKHZhbHVlKTsKCQkJZWxzZQoJCQkJcmV0dXJuIG51bGw7CgkJfQoJCWVsc2UKCQl7CgkJCXZhciBuYW1lRVEgPSBuYW1lICsgIj0iLAoJCQkJY2EgPSBkb2N1bWVudC5jb29raWUuc3BsaXQoJzsnKSwKCQkJCWkgPSAwLCBjOwoJCQkJCgkJCWZvcihpPTA7aSA8IGNhLmxlbmd0aDtpKyspCgkJCXsKCQkJCWMgPSBjYVtpXTsKCQkJCXdoaWxlIChjLmNoYXJBdCgwKSA9PSAnICcpIGMgPSBjLnN1YnN0cmluZygxLGMubGVuZ3RoKTsKCQkJCWlmIChjLmluZGV4T2YobmFtZUVRKSA9PT0gMCkgcmV0dXJuIEpTT04ucGFyc2UodW5lc2NhcGUoYy5zdWJzdHJpbmcobmFtZUVRLmxlbmd0aCxjLmxlbmd0aCkpKTsKCQkJfQoJCQlyZXR1cm4gbnVsbDsKCQl9Cgl9OwoJCgkvLyBBc3NpZ24gdG8gdGhlIGdsb2JhbCBzcGFjZQoJbmFtZXNwYWNlKCdjbG91ZGtpZCcpLlNhdmVkRGF0YSA9IFNhdmVkRGF0YTsKCQp9KCkpOwovKioKKiAgQG1vZHVsZSBjbG91ZGtpZAoqLwooZnVuY3Rpb24oKXsKCQoJInVzZSBzdHJpY3QiOwoJCgkvLyBDb21iaW5lIHByZWZpeGVkIFVSTCBmb3IgY3JlYXRlT2JqZWN0VVJMIGZyb20gYmxvYnMuCgl3aW5kb3cuVVJMID0gd2luZG93LlVSTCB8fCB3aW5kb3cud2Via2l0VVJMOwoKCS8vIENvbWJpbmUgcHJlZml4ZWQgYmxvYiBidWlsZGVyCgl3aW5kb3cuQmxvYkJ1aWxkZXIgPSB3aW5kb3cuQmxvYkJ1aWxkZXIgfHwgd2luZG93LldlYktpdEJsb2JCdWlsZGVyIHx8IHdpbmRvdy5Nb3pCbG9iQnVpbGRlcjsKCgkvKioKCSogIFRoZSBXZWIgV29ya2VycyBzcGVjaWZpY2F0aW9uIGRlZmluZXMgYW4gQVBJIGZvciBzcGF3bmluZyBiYWNrZ3JvdW5kIHNjcmlwdHMgaW4geW91ciB3ZWIgCgkqICBhcHBsaWNhdGlvbi4gV2ViIFdvcmtlcnMgYWxsb3cgeW91IHRvIGRvIHRoaW5ncyBsaWtlIGZpcmUgdXAgbG9uZy1ydW5uaW5nIHNjcmlwdHMgdG8gCgkqICBoYW5kbGUgY29tcHV0YXRpb25hbGx5IGludGVuc2l2ZSB0YXNrcywgYnV0IHdpdGhvdXQgYmxvY2tpbmcgdGhlIFVJIG9yIG90aGVyIHNjcmlwdHMgCgkqICB0byBoYW5kbGUgdXNlciBpbnRlcmFjdGlvbnMuIEJlY2F1c2UgV29ya2VycyBhcmVuJ3QgYXZhaWxhYmxlIG9uIGFsbCBicm93c2Vycywgd2UgcHJvdmlkZQoJKiAgYSBoZWxwZnVsIHBvbHlmaWxsIGZvciBiYWNrd2FyZCBjb21wYXRpYmlsaXR5LgoJKgoJKgl2YXIgd29ya2VyQ29kZSA9ICJ0aGlzLmluaXRpYWxWYXJpYWJsZSA9IDEwOyIgKwoJKgkidGhpcy5vbm1lc3NhZ2UgPSBmdW5jdGlvbihldmVudCkiICsKCSoJInsiICsKCSoJCSJ2YXIgZGF0YSA9IGV2ZW50LmRhdGE7IiArCgkqCQkidmFyIHJldHVyblZhbCA9IHRoaXMuaW5pdGlhbFZhcmlhYmxlICsgZGF0YS5hZGRWYWx1ZTsiICsKCSoJCSJ0aGlzLnBvc3RNZXNzYWdlKHJldHVyblZhbCk7IiArCgkqCSJ9OyI7CgkqCgkqCS8vIENyZWF0ZSB0aGUgd29ya2VyCgkqCXZhciB3b3JrZXIgPSBjbG91ZGtpZC5Xb3JrZXIuaW5pdCh3b3JrZXJDb2RlKTsKCSoJd29ya2VyLm9ubWVzc2FnZSA9IGZ1bmN0aW9uKGUpIHsKCSoJCS8vIGUuZGF0YSBpcyB0aGUgcmV0dXJuVmFsCgkqCX07CgkqCQoJKgkvLyBTdGFydCB0aGUgd29ya2VyLgoJKgl3b3JrZXIucG9zdE1lc3NhZ2UoKTsgCgkqCgkqICBAY2xhc3MgV29ya2VyCgkqLwoJdmFyIFdvcmtlciA9IHt9OwoKCS8qKgoJKiAgSW5pdGlhbGl6ZSB0aGUgd29ya2VyLCB0aGlzIGlzIGhvdyB5b3UgY3JlYXRlIGEgV29ya2VyIG9yIEZhbGxiYWNrV29ya2VyIG9iamVjdC4KCSogIEBtZXRob2QgaW5pdAoJKiAgQHN0YXRpYwoJKiAgQHBhcmFtIHtTdHJpbmd9IGNvZGVTdHJpbmcgVGhlIGNvZGUgaW4gc3RyaW5nIGZvcm0gdG8gbWFrZSB0aGUgd29ya2VyIGZyb20uIEFzIGEgc3RyaW5nLCBmYWxsYmFjayBzdXBwb3J0IGlzIGVhc2llci4KCSogIEByZXR1cm4ge0ZhbGxiYWNrV29ya2VyfHdpbmRvdy5Xb3JrZXJ9IEVpdGhlciBhIFdlYiBXb3JrZXIgb3IgYSBmYWxsYmFjayB3aXRoIHRoZSBzYW1lIEFQSSB0byB1c2UuCgkqLwoJV29ya2VyLmluaXQgPSBmdW5jdGlvbihjb2RlU3RyaW5nKQoJewoJCWlmKCF3aW5kb3cuVVJMIHx8ICF3aW5kb3cuV29ya2VyKSByZXR1cm4gbmV3IEZhbGxiYWNrV29ya2VyKGNvZGVTdHJpbmcpOwoKCQl2YXIgYmxvYjsKCQl0cnkKCQl7CgkJCWJsb2IgPSBuZXcgQmxvYihbY29kZVN0cmluZ10sIHt0eXBlOiAnYXBwbGljYXRpb24vamF2YXNjcmlwdCd9KTsKCQl9CgkJY2F0Y2ggKGUpCgkJewoJCQkvLyB0cnkgQmFja3dhcmRzLWNvbXBhdGliaWxpdHkgd2l0aCBibG9iIGJ1aWxkZXJzCgkJCWlmKCF3aW5kb3cuQmxvYkJ1aWxkZXIpIHJldHVybiBuZXcgRmFsbGJhY2tXb3JrZXIoY29kZVN0cmluZyk7CgkJCXRyeQoJCQl7CgkJCQlibG9iID0gbmV3IEJsb2JCdWlsZGVyKCk7CgkJCQlibG9iLmFwcGVuZChjb2RlU3RyaW5nKTsKCQkJCWJsb2IgPSBibG9iLmdldEJsb2IoKTsKCQkJfQoJCQljYXRjaChlcnJvcikKCQkJewoJCQkJLy9ubyB3YXkgb2YgZ2VuZXJhdGluZyBhIGJsb2IgdG8gY3JlYXRlIHRoZSB3b3JrZXIgZnJvbQoJCQkJcmV0dXJuIG5ldyBGYWxsYmFja1dvcmtlcihjb2RlU3RyaW5nKTsKCQkJfQoJCX0KCQlpZighYmxvYikgcmV0dXJuIG5ldyBGYWxsYmFja1dvcmtlcihjb2RlU3RyaW5nKTsvL2lmIHNvbWVob3cgbm8gYmxvYiB3YXMgY3JlYXRlZCwgcmV0dXJuIGEgZmFsbGJhY2sgd29ya2VyCgkJdHJ5CgkJewoJCQkvL0lFIDEwIGFuZCAxMSwgd2hpbGUgc3VwcG9ydGluZyBCbG9iIGFuZCBXb3JrZXJzLCBzaG91bGQgdGhyb3cgYW4gZXJyb3IgaGVyZSwgc28gd2Ugc2hvdWxkIGNhdGNoIGl0IGFuZCBmYWxsIGJhY2sKCQkJdmFyIHdvcmtlciA9IG5ldyBXb3JrZXIoVVJMLmNyZWF0ZU9iamVjdFVSTChibG9iKSk7CgkJCXJldHVybiB3b3JrZXI7CgkJfQoJCWNhdGNoKGUpCgkJewoJCQkvL2Nhbid0IGNyZWF0ZSBhIHdvcmtlcgoJCQlyZXR1cm4gbmV3IEZhbGxiYWNrV29ya2VyKGNvZGVTdHJpbmcpOwoJCX0KCX07CgoJLy8gRGVwcmVjYXRlZCBpbXBsZW1lbnRhdGlvbgoJbmFtZXNwYWNlKCJjbG91ZGtpZCIpLmNyZWF0ZVdvcmtlciA9IFdvcmtlci5pbml0OwoKCS8vIEFzc2lnbiB0byBuYW1lc3BhY2UKCW5hbWVzcGFjZSgiY2xvdWRraWQiKS5Xb3JrZXIgPSBXb3JrZXI7CgkKCS8qKgoJKglJbnRlcm5hbCBjbGFzcyB0aGF0IHByZXRlbmRzIHRvIGJlIGEgV2ViIFdvcmtlcidzIGNvbnRleHQuCgkqCUBjbGFzcyBTdWJXb3JrZXIKCSoJQGNvbnN0cnVjdG9yCgkqCUBwYXJhbSB7U3RyaW5nfSBjb2RlU3RyaW5nIEEgc3RyaW5nIHRvIGV2YWx1YXRlIGludG8gd29ya2VyIGNvZGUuCgkqCUBwYXJhbSB7RmFsbGJhY2tXb3JrZXJ9IHBhcmVudCBUaGUgRmFsbGJhY2tXb3JrZXIgdGhhdCBvd25zIHRoaXMgU3ViV29ya2VyLgoJKi8KCXZhciBTdWJXb3JrZXIgPSBmdW5jdGlvbihjb2RlU3RyaW5nLCBwYXJlbnQpCgl7CgkJdGhpcy5fd1BhcmVudCA9IHBhcmVudDsKCQlldmFsKGNvZGVTdHJpbmcpOyAvLyBqc2hpbnQgaWdub3JlOmxpbmUKCX07CgoJdmFyIHAgPSBTdWJXb3JrZXIucHJvdG90eXBlOwoKCS8qKgoJKglzZWUgaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9XZWIvQVBJL1dvcmtlci5vbm1lc3NhZ2UKCSoJQHByb3BlcnR5IHtGdW5jdGlvbn0gb25tZXNzYWdlCgkqLwoJcC5vbm1lc3NhZ2UgPSBudWxsOwoKCS8qKgoJKglUaGUgRmFsbGJhY2tXb3JrZXIgdGhhdCBpcyBjb250cm9sbHMgYnkgdGhpcyBTdWJXb3JrZXIuCgkqCUBwcm9wZXJ0eSB7RmFsbGJhY2tXb3JrZXJ9IF93UGFyZW50CgkqCUBwcml2YXRlCgkqLwoJcC5fd1BhcmVudCA9IG51bGw7CgoJLyoqCgkqCVNlZSBodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL1dlYi9BUEkvV29ya2VyLnBvc3RNZXNzYWdlCgkqCUBtZXRob2QgcG9zdE1lc3NhZ2UKCSoJQHBhcmFtIHsqfSBkYXRhIFRoZSBkYXRhIHRvIHNlbmQuCgkqLwoJcC5wb3N0TWVzc2FnZSA9IGZ1bmN0aW9uKGRhdGEpCgl7CgkJdmFyIHBhcmVudCA9IHRoaXMuX3dQYXJlbnQ7CgkJc2V0VGltZW91dChwYXJlbnQub25tZXNzYWdlLmJpbmQocGFyZW50LCB7ZGF0YTpkYXRhfSksIDEpOwoJfTsKCQoJLyoqCgkqCUFuIGludGVybmFsIGNsYXNzIHRoYXQgZHVwbGljYXRlcyB0aGUgV29ya2VyIEFQSSBhcyBhIGZhbGxiYWNrIHdoZW4gV2ViV29ya2VycyBhcmUgbm90IHN1cHBvcnRlZC4KCSoJQGNsYXNzIEZhbGxiYWNrV29ya2VyCgkqCUBjb25zdHJ1Y3RvcgoJKglAcGFyYW0ge1N0cmluZ30gY29kZVN0cmluZyBBIHN0cmluZyB0byBldmFsdWF0ZSBpbnRvIHdvcmtlciBjb2RlLgoJKi8KCXZhciBGYWxsYmFja1dvcmtlciA9IGZ1bmN0aW9uKGNvZGVTdHJpbmcpCgl7CgkJdGhpcy5fd0NoaWxkID0gbmV3IFN1Yldvcmtlcihjb2RlU3RyaW5nLCB0aGlzKTsKCX07CgoJcCA9IEZhbGxiYWNrV29ya2VyLnByb3RvdHlwZTsKCgkvKioKCSoJU2VlIGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvV2ViL0FQSS9Xb3JrZXIucG9zdE1lc3NhZ2UKCSoJQG1ldGhvZCBwb3N0TWVzc2FnZQoJKglAcGFyYW0geyp9IGRhdGEgVGhlIGRhdGEgdG8gc2VuZC4KCSovCglwLnBvc3RNZXNzYWdlID0gZnVuY3Rpb24oZGF0YSkKCXsKCQl2YXIgY2hpbGQgPSB0aGlzLl93Q2hpbGQ7CgkJc2V0VGltZW91dChjaGlsZC5vbm1lc3NhZ2UuYmluZChjaGlsZCwge2RhdGE6ZGF0YX0pLCAxKTsKCX07CgoJLyoqCgkqCVNlZSBodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL1dlYi9BUEkvV29ya2VyLnRlcm1pbmF0ZQoJKglAbWV0aG9kIHRlcm1pbmF0ZQoJKi8KCXAudGVybWluYXRlID0gZnVuY3Rpb24oKQoJewoJCXRoaXMub25tZXNzYWdlID0gbnVsbDsKCQl2YXIgY2hpbGQgPSB0aGlzLl93Q2hpbGQ7CgkJY2hpbGQuX3dQYXJlbnQgPSBudWxsOwoJCWNoaWxkLm9ubWVzc2FnZSA9IG51bGw7CgkJdGhpcy5fd0NoaWxkID0gbnVsbDsKCX07CgoJLyoqCgkqCVNlZSBodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL1dlYi9BUEkvV29ya2VyLm9ubWVzc2FnZQoJKglAcHJvcGVydHkge0Z1bmN0aW9ufSBvbm1lc3NhZ2UKCSovCglwLm9ubWVzc2FnZSA9IG51bGw7CgkKCS8qKgoJKglUaGUgU3ViV29ya2VyIHRoYXQgaXMgY29udHJvbGxlZCBieSB0aGlzIEZhbGxiYWNrV29ya2VyLgoJKglAcHJvcGVydHkge1N1Yldvcmtlcn0gX3dDaGlsZAoJKglAcHJpdmF0ZQoJKi8KCXAuX3dDaGlsZCA9IG51bGw7CgkKfSgpKTsKLyoqCiogIEBtb2R1bGUgY2xvdWRraWQKKi8KKGZ1bmN0aW9uKCkgewoJCgkidXNlIHN0cmljdCI7CgoJLyoqCgkqICBBIGZ1bmN0aW9uIHRoYXQgaXMgdXNlZCBhcyBhIG5vcm1hbCBjYWxsYmFjaywgYnV0IGNoZWNrcyBhbiBvYmplY3QgZm9yIGEgcHJvcGVydHkgaW4gb3JkZXIgdG8gY29tYmluZSB0d28KCSogIGNhbGxiYWNrcyBpbnRvIG9uZS4gRm9yIGV4YW1wbGUgdXNhZ2U6CgkqCgkqICB2YXIgdm9QbGF5ZXIgPSBuZXcgY2xvdWRraWQuVk9QbGF5ZXIoKTsKCSogIHZhciBjYWxsYmFjayA9IGNsb3Vka2lkLkNvbWJpbmVkQ2FsbGJhY2suY3JlYXRlKG15RnVuYy5iaW5kKHRoaXMpLCB2b1BsYXllciwgInBsYXlpbmciLCAiX2NhbGxiYWNrIik7CgkqICBBbmltYXRvci5wbGF5KG15Q2xpcCwgIm15QW5pbSIsIGNhbGxiYWNrKTsKCSogIAoJKiAgSW4gdGhpcyBleGFtcGxlLCB3aGVuIEFuaW1hdG9yIGNhbGxzICdjYWxsYmFjaycsIGlmIHZvUGxheWVyWyJwbGF5aW5nIl0gaXMgZmFsc2UsICdteUZ1bmMnIGlzIGNhbGxlZCBpbW1lZGlhdGVseS4KCSogIElmIHZvUGxheWVyWyJwbGF5aW5nIl0gaXMgdHJ1ZSwgdGhlbiB2b1BsYXllclsiX2NhbGxiYWNrIl0gaXMgc2V0IHRvICdteUZ1bmMnIHNvIHRoYXQgaXQgd2lsbCBiZSBjYWxsZWQgd2hlbiB2b1BsYXllciBjb21wbGV0ZXMuCgkqICAKCSogIEBjbGFzcyBDb21iaW5lZENhbGxiYWNrCgkqICBAY29uc3RydWN0b3IKCSogIEBwYXJhbSB7ZnVuY3Rpb259IGNhbGwgVGhlIGNhbGxiYWNrIHRvIGNhbGwgd2hlbiBldmVyeXRoaW5nIGlzIGNvbXBsZXRlLgoJKiAgQHBhcmFtIHsqfSBvYmogVGhlIG9iamVjdCB0byBjaGVjayBhcyBhbiBhZGRpdGlvbmFsIGNvbXBsZXRpb24gZGVwZW5kZW5jeS4KCSogIEBwYXJhbSB7U3RyaW5nfSBwcm9wIFRoZSBwcm9wZXJ0eSB0byBjaGVjayBvbiBvYmouIElmIG9ialtwcm9wXSBpcyBmYWxzZSwgdGhlbiBpdCBpcyBjb25zaWRlcmVkIGNvbXBsZXRlLgoJKiAgQHBhcmFtIHtTdHJpbmd9IGNhbGxQcm9wIFRoZSBwcm9wZXJ0eSB0byBzZXQgb24gb2JqIGlmIG9ialtwcm9wXSBpcyB0cnVlIHdoZW4gdGhlIENvbWJpbmVkQ2FsbGJhY2sgaXMgY2FsbGVkLgoJKi8KCXZhciBDb21iaW5lZENhbGxiYWNrID0gZnVuY3Rpb24oY2FsbCwgb2JqLCBwcm9wLCBjYWxsUHJvcCkKCXsKCQlpZighb2JqW3Byb3BdKS8vYWNjZXB0IGFueXRoaW5nIHRoYXQgcmVzb2x2ZXMgdG8gZmFsc2U6IGVnIHZvUGxheWVyLnBsYXlpbmcgPT0gZmFsc2UKCQkJY2FsbCgpOwoJCWVsc2UKCQkJb2JqW2NhbGxQcm9wXSA9IGNhbGw7Cgl9OwoKCS8qKgoJKiAgQ3JlYXRlcyBhIENvbWJpbmVkQ2FsbGJhY2sgZm9yIHVzZS4KCSogIAoJKiAgQG1ldGhvZCBjcmVhdGUKCSogIEBzdGF0aWMKCSogIEBwYXJhbSB7ZnVuY3Rpb259IGNhbGwgVGhlIGNhbGxiYWNrIHRvIGNhbGwgd2hlbiBldmVyeXRoaW5nIGlzIGNvbXBsZXRlLgoJKiAgQHBhcmFtIHsqfSBvYmogVGhlIG9iamVjdCB0byBjaGVjayBhcyBhbiBhZGRpdGlvbmFsIGNvbXBsZXRpb24gZGVwZW5kZW5jeS4KCSogIEBwYXJhbSB7U3RyaW5nfSBwcm9wIFRoZSBwcm9wZXJ0eSB0byBjaGVjayBvbiBvYmouIElmIG9ialtwcm9wXSBpcyBmYWxzZSwgdGhlbiBpdCBpcyBjb25zaWRlcmVkIGNvbXBsZXRlLgoJKiAgQHBhcmFtIHtTdHJpbmd9IGNhbGxQcm9wIFRoZSBwcm9wZXJ0eSB0byBzZXQgb24gb2JqIGlmIG9ialtwcm9wXSBpcyB0cnVlIHdoZW4gdGhlIENvbWJpbmVkQ2FsbGJhY2sgaXMgY2FsbGVkLgoJKi8KCUNvbWJpbmVkQ2FsbGJhY2suY3JlYXRlID0gZnVuY3Rpb24oY2FsbCwgb2JqLCBwcm9wLCBjYWxsUHJvcCkKCXsKCQlyZXR1cm4gQ29tYmluZWRDYWxsYmFjay5iaW5kKHRoaXMsIGNhbGwsIG9iaiwgcHJvcCwgY2FsbFByb3ApOwoJfTsKCgluYW1lc3BhY2UoJ2Nsb3Vka2lkJykuQ29tYmluZWRDYWxsYmFjayA9IENvbWJpbmVkQ2FsbGJhY2s7Cn0oKSk7Ci8qKgoqICBAbW9kdWxlIGNsb3Vka2lkCiovCihmdW5jdGlvbih1bmRlZmluZWQpIHsKCgkidXNlIHN0cmljdCI7CgoJdmFyIE5FWFRfSUQgPSAwOwoKCS8qKgoJKiAgQSBjbGFzcyBmb3IgZGVsYXlpbmcgYSBjYWxsIHRocm91Z2ggdGhlIE9TLCBpbnN0ZWFkIG9mIHJlbHlpbmcgb24gc2V0SW50ZXJ2YWwoKSBvciBzZXRUaW1lb3V0KCkuCgkqIAoJKiAgQGNsYXNzIERlbGF5ZWRDYWxsCgkqICBAY29uc3RydWN0b3IKCSogIEBwYXJhbSB7ZnVuY3Rpb259IGNhbGxiYWNrIFRoZSBmdW5jdGlvbiB0byBjYWxsIHdoZW4gdGhlIGRlbGF5IGhhcyBjb21wbGV0ZWQuCgkqICBAcGFyYW0ge2ludH0gZGVsYXkgVGhlIHRpbWUgdG8gZGVsYXkgdGhlIGNhbGwsIGluIG1pbGxpc2Vjb25kcy4KCSogIEBwYXJhbSB7Qm9vbGVhbn0gcmVwZWF0PWZhbHNlIElmIHRoZSBEZWxheWVkQ2FsbCBzaG91bGQgYXV0b21hdGljYWxseSByZXBlYXQgaXRzZWxmIHdoZW4gY29tcGxldGVkLgoJKiAgQHBhcmFtIHtCb29sZWFufSBhdXRvRGVzdHJveT10cnVlIElmIHRoZSBEZWxheWVkQ2FsbCBzaG91bGQgY2xlYW4gaXRzZWxmIHVwIHdoZW4gY29tcGxldGVkLgoJKi8KCXZhciBEZWxheWVkQ2FsbCA9IGZ1bmN0aW9uKGNhbGxiYWNrLCBkZWxheSwgcmVwZWF0LCBhdXRvRGVzdHJveSkKCXsKCQkvKioKCQkqICBUaGUgZnVuY3Rpb24gdG8gY2FsbCB3aGVuIHRoZSBkZWxheSBpcyBjb21wbGV0ZWQuCgkJKiAgQHByaXZhdGUKCQkqICBAcHJvcGVydHkge2Z1bmN0aW9ufSBfY2FsbGJhY2sKCQkqLwoJCXRoaXMuX2NhbGxiYWNrID0gY2FsbGJhY2s7CgkJLyoqCgkJKiAgVGhlIGRlbGF5IHRpbWUsIGluIG1pbGxpc2Vjb25kcy4KCQkqICBAcHJpdmF0ZQoJCSogIEBwcm9wZXJ0eSB7aW50fSBfZGVsYXkKCQkqLwoJCXRoaXMuX2RlbGF5ID0gZGVsYXk7CgkJLyoqCgkJKiAgVGhlIHRpbWVyIGNvdW50aW5nIGRvd24gZnJvbSBfZGVsYXksIGluIG1pbGxpc2Vjb25kcy4KCQkqICBAcHJpdmF0ZQoJCSogIEBwcm9wZXJ0eSB7aW50fSBfdGltZXIKCQkqLwoJCXRoaXMuX3RpbWVyID0gZGVsYXk7CgkJLyoqCgkJKiAgSWYgdGhlIERlbGF5ZWRDYWxsIHNob3VsZCByZXBlYXQgaXRzZWxmIGF1dG9tYXRpY2FsbHkuCgkJKiAgQHByaXZhdGUKCQkqICBAcHJvcGVydHkge0Jvb2xlYW59IF9yZXBlYXQKCQkqICBAZGVmYXVsdCBmYWxzZQoJCSovCgkJdGhpcy5fcmVwZWF0ID0gISFyZXBlYXQ7CgkJLyoqCgkJKiAgSWYgdGhlIERlbGF5ZWRDYWxsIHNob3VsZCBkZXN0cm95IGl0c2VsZiBhZnRlciBjb21wbGV0aW5nCgkJKiAgQHByaXZhdGUKCQkqICBAcHJvcGVydHkge0Jvb2xlYW59IF9hdXRvRGVzdHJveQoJCSogIEBkZWZhdWx0IHRydWUKCQkqLwoJCXRoaXMuX2F1dG9EZXN0cm95ID0gYXV0b0Rlc3Ryb3kgPT09IHVuZGVmaW5lZCA/IHRydWUgOiAhIWF1dG9EZXN0cm95OwoJCS8qKgoJCSogIFRoZSB1bmlxdWUgSUQgdXNlZCBmb3IgdGhlIHVwZGF0ZSBjYWxsYmFjayBmb3IgdGhlIE9TLgoJCSogIEBwcml2YXRlCgkJKiAgQHByb3BlcnR5IHtTdHJpbmd9IF91cGRhdGVJZAoJCSovCgkJdGhpcy5fdXBkYXRlSWQgPSAiRGVsYXllZENhbGwjIiArICgrK05FWFRfSUQpOwoJCS8qKgoJCSogIElmIHRoZSBEZWxheWVkQ2FsbCBpcyBjdXJyZW50bHkgcGF1c2VkIChub3Qgc3RvcHBlZCkuCgkJKiAgQHByaXZhdGUKCQkqICBAcHJvcGVydHkge0Jvb2xlYW59IF9wYXVzZWQKCQkqLwoJCXRoaXMuX3BhdXNlZCA9IGZhbHNlOwoKCQkvL3NhdmUgYSBib3VuZCB2ZXJzaW9uIG9mIHRoZSB1cGRhdGUgZnVuY3Rpb24KCQl0aGlzLl91cGRhdGUgPSB0aGlzLl91cGRhdGUuYmluZCh0aGlzKTsKCQkvL3N0YXJ0IHRoZSBkZWxheQoJCWNsb3Vka2lkLk9TLmluc3RhbmNlLmFkZFVwZGF0ZUNhbGxiYWNrKHRoaXMuX3VwZGF0ZUlkLCB0aGlzLl91cGRhdGUpOwoJfTsKCgl2YXIgcCA9IERlbGF5ZWRDYWxsLnByb3RvdHlwZTsKCgkvKioKCSogIFRoZSBjYWxsYmFjayBzdXBwbGllZCB0byB0aGUgT1MgZm9yIGFuIHVwZGF0ZSBlYWNoIGZyYW1lLgoJKiAgQHByaXZhdGUKCSogIEBtZXRob2QgX3VwZGF0ZQoJKiAgQHBhcmFtIHtpbnR9IGVsYXBzZWQgVGhlIHRpbWUgZWxhcHNlZCBzaW5jZSB0aGUgcHJldmlvdXMgZnJhbWUuCgkqLwoJcC5fdXBkYXRlID0gZnVuY3Rpb24oZWxhcHNlZCkKCXsKCQlpZighdGhpcy5fY2FsbGJhY2spCgkJewoJCQl0aGlzLmRlc3Ryb3koKTsKCQkJcmV0dXJuOwoJCX0KCgkJdGhpcy5fdGltZXIgLT0gZWxhcHNlZDsKCQlpZih0aGlzLl90aW1lciA8PSAwKQoJCXsKCQkJdGhpcy5fY2FsbGJhY2soKTsKCQkJaWYodGhpcy5fcmVwZWF0KQoJCQkJdGhpcy5fdGltZXIgKz0gdGhpcy5fZGVsYXk7CgkJCWVsc2UgaWYodGhpcy5fYXV0b0Rlc3Ryb3kpCgkJCQl0aGlzLmRlc3Ryb3koKTsKCQkJZWxzZQoJCQkJY2xvdWRraWQuT1MuaW5zdGFuY2UucmVtb3ZlVXBkYXRlQ2FsbGJhY2sodGhpcy5fdXBkYXRlSWQpOwoJCX0KCX07CgoJLyoqCgkqICBSZXN0YXJ0cyB0aGUgRGVsYXllZENhbGwsIHdoZXRoZXIgaXQgaXMgcnVubmluZyBvciBub3QuCgkqICBAcHVibGljCgkqICBAbWV0aG9kIHJlc3RhcnQKCSovCglwLnJlc3RhcnQgPSBmdW5jdGlvbigpCgl7CgkJaWYoIXRoaXMuX2NhbGxiYWNrKSByZXR1cm47CgkJdmFyIG9zID0gY2xvdWRraWQuT1MuaW5zdGFuY2U7CgkJLy9jYW4ndCBhZGQgZHVwbGljYXRlcwoJCW9zLmFkZFVwZGF0ZUNhbGxiYWNrKHRoaXMuX3VwZGF0ZUlkLCB0aGlzLl91cGRhdGUpOwoJCXRoaXMuX3RpbWVyID0gdGhpcy5fZGVsYXk7CgkJdGhpcy5fcGF1c2VkID0gZmFsc2U7Cgl9OwoKCS8qKgoJKiAgU3RvcHMgdGhlIERlbGF5ZWRDYWxsLCB3aXRob3V0IGRlc3Ryb3lpbmcgaXQuCgkqICBAcHVibGljCgkqICBAbWV0aG9kIHN0b3AKCSovCglwLnN0b3AgPSBmdW5jdGlvbigpCgl7CgkJY2xvdWRraWQuT1MuaW5zdGFuY2UucmVtb3ZlVXBkYXRlQ2FsbGJhY2sodGhpcy5fdXBkYXRlSWQpOwoJCXRoaXMuX3BhdXNlZCA9IGZhbHNlOwoJfTsKCgkvKioKCSogIElmIHRoZSBEZWxheWVkQ2FsbCBpcyBwYXVzZWQgb3Igbm90LgoJKiAgQHB1YmxpYwoJKiAgQHByb3BlcnR5IHtCb29sZWFufSBwYXVzZWQKCSovCglPYmplY3QuZGVmaW5lUHJvcGVydHkocCwgInBhdXNlZCIsIHsKCQlnZXQ6IGZ1bmN0aW9uKCkgeyByZXR1cm4gdGhpcy5fcGF1c2VkOyB9LAoJCXNldDogZnVuY3Rpb24odmFsdWUpCgkJewoJCQlpZighdGhpcy5fY2FsbGJhY2spIHJldHVybjsKCQkJdmFyIG9zID0gY2xvdWRraWQuT1MuaW5zdGFuY2U7CgkJCWlmKHRoaXMuX3BhdXNlZCAmJiAhdmFsdWUpCgkJCXsKCQkJCXRoaXMuX3BhdXNlZCA9IGZhbHNlOwoJCQkJaWYoIW9zLmhhc1VwZGF0ZUNhbGxiYWNrKHRoaXMuX3VwZGF0ZUlkKSkKCQkJCQlvcy5hZGRVcGRhdGVDYWxsYmFjayh0aGlzLl91cGRhdGVJZCwgdGhpcy5fdXBkYXRlKTsKCQkJfQoJCQllbHNlIGlmKHZhbHVlKQoJCQl7CgkJCQlpZihvcy5oYXNVcGRhdGVDYWxsYmFjayh0aGlzLl91cGRhdGVJZCkpCgkJCQl7CgkJCQkJdGhpcy5fcGF1c2VkID0gdHJ1ZTsKCQkJCQlvcy5yZW1vdmVVcGRhdGVDYWxsYmFjayh0aGlzLl91cGRhdGVJZCk7CgkJCQl9CgkJCX0KCQl9Cgl9KTsKCgkvKioKCSogIFN0b3BzIGFuZCBjbGVhbnMgdXAgdGhlIERlbGF5ZWRDYWxsLiBEbyBub3QgdXNlIGl0IGFmdGVyIGNhbGxpbmcKCSogIGRlc3Ryb3koKS4KCSogIEBwdWJsaWMKCSogIEBtZXRob2QgZGVzdHJveQoJKi8KCXAuZGVzdHJveSA9IGZ1bmN0aW9uKCkKCXsKCQljbG91ZGtpZC5PUy5pbnN0YW5jZS5yZW1vdmVVcGRhdGVDYWxsYmFjayh0aGlzLl91cGRhdGVJZCk7CgkJdGhpcy5fY2FsbGJhY2sgPSBudWxsOwoJfTsKCgluYW1lc3BhY2UoJ2Nsb3Vka2lkJykuRGVsYXllZENhbGwgPSBEZWxheWVkQ2FsbDsKfSgpKTsKLyoqCiogIEBtb2R1bGUgY2xvdWRraWQKKi8KKGZ1bmN0aW9uKCl7CgkKCSJ1c2Ugc3RyaWN0IjsKCgkvKioKCSogIEFuIGFwcGxpY2F0aW9uIGlzIGFuIGFic3RyYWN0IGNsYXNzIHdoaWNoIGV4dGVuZHMgYGNyZWF0ZWpzLkNvbnRhaW5lcmAKCSogIGFuZCBpcyBtYW5hZ2VkIGJ5IHRoZSBgY2xvdWRraWQuT1NgCgkqCgkqICBAY2xhc3MgQXBwbGljYXRpb24KCSovCgl2YXIgQXBwbGljYXRpb24gPSBmdW5jdGlvbigpCgl7CgkJaWYodHJ1ZSkgCgkJewoJCQl0aGlzLmluaXRpYWxpemUoKTsKCQl9CQoJCWVsc2UgaWYoZmFsc2UpCgkJewoJCQlQSVhJLkRpc3BsYXlPYmplY3RDb250YWluZXIuY2FsbCh0aGlzKTsKCQl9CQoJfTsKCQoJLy8gU2hvcnRjdXQgcmVmZXJlbmNlIHRvIHRoZSBwcm90b3R5cGUKCXZhciBwOwoJCgkvLyBFeHRlbmRzIHRoZSBjb250YWluZXIKCWlmICh0cnVlKQoJewoJCXAgPSBBcHBsaWNhdGlvbi5wcm90b3R5cGUgPSBuZXcgY3JlYXRlanMuQ29udGFpbmVyKCk7Cgl9CgkvLyBFeHRlbmRzIHRoZSBQSVhJIGRpc3BsYXkgb2JqZWN0CgllbHNlIGlmIChmYWxzZSkKCXsKCQlwID0gQXBwbGljYXRpb24ucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShQSVhJLkRpc3BsYXlPYmplY3RDb250YWluZXIucHJvdG90eXBlKTsKCX0KCQkKCS8qKgoJKiBUaGUgYXBwbGljYXRpb24gaXMgcmVhZHkgdG8gdXNlLCBhZGRlZCB0byBzdGFnZQoJKgoJKiBAcHVibGljCgkqIEBtZXRob2QgaW5pdAoJKi8KCXAuaW5pdCA9IGZ1bmN0aW9uKCl7fTsKCQoJLyoqCgkqICBUaGUgdXBkYXRlZCBmdW5jdGlvbiBjYWxsZWQgYnkgdGhlIE9TCgkqICB0aGlzIGZ1bmN0aW9uIGlzIGltcGxlbWVudGF0aW9uLXNwZWNpZmljCgkqCgkqICBAcHVibGljCgkqICBAbWV0aG9kIHVwZGF0ZQoJKiAgQHBhcmFtIHtpbnR9IGVsYXBzZWQgVGhlIG51bWJlciBvZiBNUyBzaW5jZSB0aGUgbGFzdCBmcmFtZSB1cGRhdGUKCSovCglwLnVwZGF0ZSA9IGZ1bmN0aW9uKGVsYXBzZWQpe307CgkKCS8qKgoJKiBEZXN0cm95IHRoZSBhcHBsaWNhdGlvbiwgZG9uJ3QgdXNlIGFmdGVyIHRoaXMKCSogCgkqIEBwdWJsaWMKCSogQG1ldGhvZCBkZXN0cm95CgkqLwoJcC5kZXN0cm95ID0gZnVuY3Rpb24oKXt9OwoJCgkvKioKCSogIFJlc2l6ZSB0aGUgYXBwbGljYXRpb24KCSoKCSogQHB1YmxpYyAKCSogQG1ldGhvZCByZXNpemUKCSovCglwLnJlc2l6ZSA9IGZ1bmN0aW9uKCl7fTsKCQoJbmFtZXNwYWNlKCdjbG91ZGtpZCcpLkFwcGxpY2F0aW9uID0gQXBwbGljYXRpb247Cn0oKSk7Ci8qKgoqICBAbW9kdWxlIGNsb3Vka2lkCiovCihmdW5jdGlvbigpewoJCgkidXNlIHN0cmljdCI7CgoJLyoqCgkqICBSZXByZXNlbnRzIGEgc2luZ2xlIGl0ZW0gaW4gdGhlIGxvYWRlciBxdWV1ZSAKCSoKCSogIEBjbGFzcyBMb2FkZXJRdWV1ZUl0ZW0KCSovCgl2YXIgTG9hZGVyUXVldWVJdGVtID0gZnVuY3Rpb24oKXt9OwoJCgkvKiogUmVmZXJlbmNlIHRvIHRoZSBwcm90b3R5cGUgKi8KCXZhciBwID0gTG9hZGVyUXVldWVJdGVtLnByb3RvdHlwZTsKCQoJLyoqIAoJKiBIaWdoZXN0IHByaW9yaXR5CgkqIEBzdGF0aWMKCSogQHB1YmxpYwoJKiBAZmluYWwKCSogQHByb3BlcnR5IHtpbnR9IFBSSU9SSVRZX0hJR0gKCSovCglMb2FkZXJRdWV1ZUl0ZW0uUFJJT1JJVFlfSElHSCA9IDE7CgkKCS8qKiAKCSogTm9ybWFsIHByaW9yaXR5LCB0aGUgZGVmYXVsdAoJKiBAc3RhdGljCgkqIEBwdWJsaWMKCSogQGZpbmFsCgkqIEBwcm9wZXJ0eSB7aW50fSBQUklPUklUWV9OT1JNQUwKCSovCglMb2FkZXJRdWV1ZUl0ZW0uUFJJT1JJVFlfTk9STUFMID0gMDsKCQoJLyoqIAoJKiBMb3dlc3QgcHJpb3JpdHkKCSogQHN0YXRpYwoJKiBAcHVibGljCgkqIEBmaW5hbAoJKiBAcHJvcGVydHkge2ludH0gUFJJT1JJVFlfTE9XCgkqLwoJTG9hZGVyUXVldWVJdGVtLlBSSU9SSVRZX0xPVyA9IC0xOwoJCgkvKioKCSogIFRoZSB1cmwgb2YgdGhlIGxvYWQKCSogIEBwdWJsaWMKCSogIEBwcm9wZXJ0eSB7c3RyaW5nfSB1cmwKCSovCglwLnVybCA9IG51bGw7CgkKCS8qKgoJKiAgRGF0YSBhc3NvY2lhdGUgd2l0aCB0aGUgbG9hZAoJKiAgQHB1YmxpYwoJKiAgQHByb3BlcnR5IHsqfSBkYXRhCgkqLwoJcC5kYXRhID0gbnVsbDsKCQoJLyoqCgkqICBUaGUgY2FsbGJhY2sgZnVuY3Rpb24gb2YgdGhlIGxvYWQsIHRvIGNhbGwgd2hlbiAKCSogIHRoZSBsb2FkIGFzIGZpbmlzaGVkLCB0YWtlcyBvbmUgYXJndW1lbnQgYXMgcmVzdWx0CgkqICBAcHVibGljCgkqICBAcHJvcGVydHkge2Z1bmN0aW9ufSBjYWxsYmFjawoJKi8KCXAuY2FsbGJhY2sgPSBudWxsOwoJCgkvKioKCSogIFRoZSBwcmlvcml0eSBvZiB0aGlzIGl0ZW0KCSogIEBwcm9wZXJ0eSB7aW50fSBwcmlvcml0eQoJKiAgQHB1YmxpYwoJKi8KCXAucHJpb3JpdHkgPSAwOwoJCgkvKioKCSogIFRoZSBhbW91bnQgd2UndmUgbG9hZGVkIHNvIGZhciwgZnJvbSAwIHRvIDEKCSogIEBwdWJsaWMKCSogIEBwcm9wZXJ0eSB7TnVtYmVyfSBwcm9ncmVzcwoJKi8KCXAucHJvZ3Jlc3MgPSAwOwoJCgkvKioKCSogIFRoZSBwcm9ncmVzcyBjYWxsYmFjawoJKiAgQHB1YmxpYwoJKiAgQHByb3BydHkge2Z1bmN0aW9ufSB1cGRhdGVDYWxsYmFjawoJKi8KCXAudXBkYXRlQ2FsbGJhY2sgPSBudWxsOwoJCglwLl9ib3VuZEZhaWwgPSBudWxsOwoJcC5fYm91bmRQcm9ncmVzcyA9IG51bGw7CglwLl9ib3VuZENvbXBsZXRlID0gbnVsbDsKCQoJLyoqCgkqICBSZXByZXNlbnQgdGhpcyBvYmplY3QgYXMgYSBzdHJpbmcKCSogIEBwdWJsaWMKCSogIEBtZXRob2QgdG9TdHJpbmcKCSogIEByZXR1cm4ge3N0cmluZ30gVGhlIHN0cmluZyByZXByZXNlbnRhdGlvbiBvZiB0aGlzIG9iamVjdAoJKi8KCXAudG9TdHJpbmcgPSBmdW5jdGlvbigpCgl7CgkJcmV0dXJuICJbTG9hZGVyUXVldWVJdGVtKHVybDonIit0aGlzLnVybCsiJywgcHJpb3JpdHk6Iit0aGlzLnByaW9yaXR5KyIpXSI7Cgl9OwoJCgkvKioKCSogIERlc3Ryb3kgdGhpcyByZXN1bHQKCSogIEBwdWJsaWMKCSogIEBtZXRob2QgZGVzdHJveQoJKi8KCXAuZGVzdHJveSA9IGZ1bmN0aW9uKCkKCXsKCQl0aGlzLmNhbGxiYWNrID0gbnVsbDsKCQl0aGlzLnVwZGF0ZUNhbGxiYWNrID0gbnVsbDsKCQl0aGlzLmRhdGEgPSBudWxsOwoJCXRoaXMuX2JvdW5kRmFpbCA9IG51bGw7CgkJdGhpcy5fYm91bmRQcm9ncmVzcyA9IG51bGw7CgkJdGhpcy5fYm91bmRDb21wbGV0ZSA9IG51bGw7Cgl9OwoJCgkvLyBBc3NpZ24gdG8gdGhlIG5hbWUgc3BhY2UKCW5hbWVzcGFjZSgnY2xvdWRraWQnKS5Mb2FkZXJRdWV1ZUl0ZW0gPSBMb2FkZXJRdWV1ZUl0ZW07Cn0oKSk7Ci8qKgoqICBAbW9kdWxlIGNsb3Vka2lkCiovCihmdW5jdGlvbigpewoJCgkidXNlIHN0cmljdCI7CgkKCS8qKgoJKiAgVGhlIE1lZGlhbG9hZGVyIGlzIHRoZSBzaW5nbGV0b24gbG9hZGVyIGZvciBsb2FkaW5nIGFsbCBhc3NldHMKCSogIGluY2x1ZGluZyBpbWFnZXMsIGRhdGEsIGNvZGUgYW5kIHNvdW5kcy4gTWVkaWFMb2FkZXIgc3VwcG9ydHMgY2FjaGUtYnVzdGluZwoJKiAgaW4gdGhlIGJyb3dzZXIgdXNpbmcgZHluYW1pYyBxdWVyeSBzdHJpbmcgcGFyYW1ldGVycy4KCSogCgkqICBAY2xhc3MgTWVkaWFMb2FkZXIKCSovCgl2YXIgTWVkaWFMb2FkZXIgPSBmdW5jdGlvbigpe307CgkKCS8qKiBUaGUgcHJvdG90eXBlICovCgl2YXIgcCA9IE1lZGlhTG9hZGVyLnByb3RvdHlwZTsKCQoJLyoqCgkqIFJlZmVyZW5jZSB0byB0aGUgcHJpdmF0ZSBpbnN0YW5jZSBvYmplY3QKCSogQHN0YXRpYwoJKiBAcHJvdGVjdGVkCgkqLwoJTWVkaWFMb2FkZXIuX2luc3RhbmNlID0gbnVsbDsKCQoJLyoqCgkqICBUaGUgY29sbGVjdGlvbiBvZiBMb2FkZXJRdWV1ZUl0ZW1zCgkqICBAcHJpdmF0ZQoJKi8KCXZhciBxdWV1ZSA9IG51bGw7CgkKCS8qKgoJKiAgVGhlIGNvbGxlY3Rpb24gb2YgTG9hZGVyUXVldWVJdGVtcyBieSB1cmwKCSogIEBwcml2YXRlCgkqLwoJdmFyIHF1ZXVlSXRlbXMgPSBudWxsOwoJCgkvKioKCSogIFRoZSBjb2xsZWN0aW9uIG9mIGxvYWRlcnMKCSogIEBwcml2YXRlCgkqICBAcHJvcGVydHkge29iamVjdH0gbG9hZGVycwoJKi8KCXZhciBsb2FkZXJzID0gbnVsbDsKCQoJdmFyIHFpUG9vbCA9IG51bGw7Cgl2YXIgbG9hZGVyUG9vbCA9IG51bGw7Cgl2YXIgcmVzdWx0UG9vbCA9IG51bGw7CgkKCS8qKgoJKiAgVGhlIGN1cnJlbnQgbnVtYmVyIG9mIGl0ZW1zIGxvYWRpbmcKCSogIEBwcml2YXRlCgkqICBAcHJvcGVydHkge2ludH0gbnVtTG9hZHMKCSogIEBkZWZhdWx0IDAKCSovCgl2YXIgbnVtTG9hZHMgPSAwOwoJCgl2YXIgcmV0cmllcyA9IG51bGw7CgkKCS8qKgoJKiAgSWYgd2UgY2FuIGxvYWQKCSogIEBwcml2YXRlCgkqLwoJcC5fY2FuTG9hZCA9IHRydWU7CgkKCS8qKgoJKiAgVGhlIG1heGltdW0gbnVtYmVyIG9mIHNpbXVsYW5lb3VzIGxvYWRzCgkqICBAcHVibGljCgkqICBAcHJvcGVydHkge2ludH0gbWF4U2ltdWx0YW5lb3VzTG9hZHMKCSogIEBkZWZhdWx0IDIKCSovCglwLm1heFNpbXVsdGFuZW91c0xvYWRzID0gMjsKCQoJLyoqCgkqICBUaGUgcmVmZXJlbmNlIHRvIHRoZSBjYWNoZSBtYW5hZ2VyCgkqICBAcHVibGljCgkqICBAcHJvcGVydHkge2Nsb3Vka2lkLkNhY2hlTWFuYWdlcn0gY2FjaGVNYW5hZ2VyCgkqLwoJcC5jYWNoZU1hbmFnZXIgPSBudWxsOwoJCgkvKioKCSogIFN0YXRpYyBjb25zdHJ1Y3RvciBjcmVhdGluZyB0aGUgc2luZ2xldG9uCgkqICBAbWV0aG9kIGluaXQKCSogIEBzdGF0aWMKCSogIEBwdWJsaWMKCSovCglNZWRpYUxvYWRlci5pbml0ID0gZnVuY3Rpb24oKQoJewoJCWlmICghTWVkaWFMb2FkZXIuX2luc3RhbmNlKQoJCXsKCQkJTWVkaWFMb2FkZXIuX2luc3RhbmNlID0gbmV3IE1lZGlhTG9hZGVyKCk7CgkJCU1lZGlhTG9hZGVyLl9pbnN0YW5jZS5faW5pdGlhbGl6ZSgpOwoJCX0KCQlyZXR1cm4gTWVkaWFMb2FkZXIuX2luc3RhbmNlOwoJfTsKCQkKCS8qKgoJKiAgU3RhdGljIGZ1bmN0aW9uIGZvciBnZXR0aW5nIHRoZSBzaW5nbGV0b24gaW5zdGFuY2UKCSogIEBzdGF0aWMKCSogIEByZWFkT25seQoJKiAgQHB1YmxpYwoJKiAgQHByb3BlcnR5IHtjbG91ZGtpZC5PU30gaW5zdGFuY2UKCSovCglPYmplY3QuZGVmaW5lUHJvcGVydHkoTWVkaWFMb2FkZXIsICJpbnN0YW5jZSIsIHsKCQlnZXQ6ZnVuY3Rpb24oKQoJCXsKCQkJaWYgKCFNZWRpYUxvYWRlci5faW5zdGFuY2UpCgkJCXsKCQkJCXRocm93ICdDYWxsIGNsb3Vka2lkLk1lZGlhTG9hZGVyLmluaXQoKSc7CgkJCX0KCQkJcmV0dXJuIE1lZGlhTG9hZGVyLl9pbnN0YW5jZTsKCQl9Cgl9KTsKCQoJLyoqCgkqICBEZXN0cm95IHRoZSBNZWRpYUxvYWRlciBzaW5nbGV0b24sIGRvbid0IHVzZSBhZnRlciB0aGlzCgkqICBAcHVibGljCgkqICBAbWV0aG9kIGRlc3Ryb3kKCSovCglwLmRlc3Ryb3kgPSBmdW5jdGlvbigpCgl7CgkJdmFyIGksIGxlbiwga2V5LCBhcnIgPSB0aGlzLnF1ZXVlOwoJCWlmKGFycikKCQl7CgkJCWZvcihpID0gMCwgbGVuID0gYXJyLmxlbmd0aDsgaSA8IGk7ICsraSkKCQkJCWFycltpXS5kZXN0cm95KCk7CgkJCWFyciA9IHFpUG9vbDsKCQkJZm9yKGkgPSAwLCBsZW4gPSBhcnIubGVuZ3RoOyBpIDwgaTsgKytpKQoJCQkJYXJyW2ldLmRlc3Ryb3koKTsKCQkJYXJyID0gcmVzdWx0UG9vbDsKCQkJZm9yKGkgPSAwLCBsZW4gPSBhcnIubGVuZ3RoOyBpIDwgaTsgKytpKQoJCQkJYXJyW2ldLmRlc3Ryb3koKTsKCQkJZm9yKGtleSBpbiBsb2FkZXJzKQoJCQl7CgkJCQlxdWV1ZUl0ZW1zW2tleV0uZGVzdHJveSgpOwoJCQkJbG9hZGVyc1trZXldLmNsb3NlKCk7CgkJCX0KCQl9CgkJTWVkaWFMb2FkZXIuX2luc3RhbmNlID0gbnVsbDsKCQlpZiAodGhpcy5jYWNoZU1hbmFnZXIpCgkJCXRoaXMuY2FjaGVNYW5hZ2VyLmRlc3Ryb3koKTsKCQl0aGlzLmNhY2hlTWFuYWdlciA9IG51bGw7CgkJcXVldWUgPSBudWxsOwoJCXJlc3VsdFBvb2wgPSBudWxsOwoJCWxvYWRlclBvb2wgPSBudWxsOwoJCXFpUG9vbCA9IG51bGw7CgkJcXVldWVJdGVtcyA9IG51bGw7CgkJcmV0cmllcyA9IG51bGw7CgkJbG9hZGVycyA9IG51bGw7Cgl9OwoJCgkvKioKCSogIEluaXRpbGl6ZSB0aGUgb2JqZWN0CgkqICBAcHJvdGVjdGVkCgkqICBAbWV0aG9kIF9pbml0aWFsaXplCgkqLwoJcC5faW5pdGlhbGl6ZSA9IGZ1bmN0aW9uKCkKCXsKCQlxaVBvb2wgPSBbXTsKCQlsb2FkZXJQb29sID0gW107CgkJcmVzdWx0UG9vbCA9IFtdOwoJCXF1ZXVlID0gW107CgkJcXVldWVJdGVtcyA9IHt9OwoJCWxvYWRlcnMgPSB7fTsKCQlyZXRyaWVzID0ge307CgkJdGhpcy5jYWNoZU1hbmFnZXIgPSBuZXcgY2xvdWRraWQuQ2FjaGVNYW5hZ2VyKCk7Cgl9OwoJCgkvKioKCSogIExvYWQgYSBmaWxlIAoJKiAgQG1ldGhvZCBsb2FkCgkqICBAcHVibGljCgkqICBAcGFyYW0ge3N0cmluZ30gdXJsIFRoZSBmaWxlIHBhdGggdG8gbG9hZAoJKiAgQHBhcmFtIHtmdW5jdGlvbn0gY2FsbGJhY2sgVGhlIGNhbGxiYWNrIGZ1bmN0aW9uIHdoZW4gY29tcGxldGVkCgkqICBAcGFyYW0ge2Z1bmN0aW9uKn0gdXBkYXRlQ2FsbGJhY2sgVGhlIGNhbGxiYWNrIGZvciBsb2FkIHByb2dyZXNzIHVwZGF0ZSwgcGFzc2VzIDAtMSBhcyBwYXJhbQoJKiAgQHBhcmFtIHtpbnQqfSBwcmlvcml0eSBUaGUgcHJpb3JpdHkgb2YgdGhlIGxvYWQKCSogIEBwYXJhbSB7Kn0gZGF0YSBvcHRpb25hbCBkYXRhCgkqLwoJcC5sb2FkID0gZnVuY3Rpb24odXJsLCBjYWxsYmFjaywgdXBkYXRlQ2FsbGJhY2ssIHByaW9yaXR5LCBkYXRhKQoJewoJCXZhciBxaSA9IHRoaXMuX2dldFFJKCk7CgkJCgkJdmFyIGJhc2VQYXRoID0gY2xvdWRraWQuT1MuaW5zdGFuY2Uub3B0aW9ucy5iYXNlUGF0aDsKCQlpZiAoYmFzZVBhdGggIT09IHVuZGVmaW5lZCAmJiAvXmh0dHAocyk/XDovLnRlc3QodXJsKSA9PT0gZmFsc2UgJiYgdXJsLnNlYXJjaChiYXNlUGF0aCkgPT0gLTEpCgkJewoJCQlxaS5iYXNlUGF0aCA9IGJhc2VQYXRoOwoJCX0KCQkKCQlxaS51cmwgPSB1cmw7CgkJcWkuY2FsbGJhY2sgPSBjYWxsYmFjazsKCQlxaS51cGRhdGVDYWxsYmFjayA9IHVwZGF0ZUNhbGxiYWNrIHx8IG51bGw7CgkJcWkucHJpb3JpdHkgPSBwcmlvcml0eSB8fCBjbG91ZGtpZC5Mb2FkZXJRdWV1ZUl0ZW0uUFJJT1JJVFlfTk9STUFMOwoJCXFpLmRhdGEgPSBkYXRhIHx8IG51bGw7CgkJCgkJcXVldWUucHVzaChxaSk7CgkJCgkJLy8gU29yeSBieSBwcmlvcml0eQoJCXF1ZXVlLnNvcnQoZnVuY3Rpb24oYSwgYil7CgkJCXJldHVybiBhLnByaW9yaXR5IC0gYi5wcmlvcml0eTsKCQl9KTsKCQkKCQkvLyBUcnkgdG8gbG9hZCB0aGUgbmV4dCBxdWV1ZSBpdGVtCgkJdGhpcy5fdHJ5TmV4dExvYWQoKTsKCX07CgkKCS8qKgoJKiAgVGhlcmUgd2FzIGFuIGVycm9yIGxvYWRpbmcgdGhlIGZpbGUKCSogIEBwcml2YXRlCgkqICBAbWV0aG9kIF9vbkxvYWRGYWlsZWQKCSogIEBwYXJhbSB7Y2xvdWRraWQuTG9hZGVyUXVldWVJdGVtfSBxaSBUaGUgbG9hZGVyIHF1ZXVlIGl0ZW0KCSovCglwLl9vbkxvYWRGYWlsZWQgPSBmdW5jdGlvbihxaSwgZXZlbnQpCgl7CgkJRGVidWcuZXJyb3IoIlVuYWJsZSB0byBsb2FkIGZpbGU6ICIgKyBxaS51cmwgICsgIiAtIHJlYXNvbjogIiArIGV2ZW50LmVycm9yKTsKCQkKCQl2YXIgbG9hZGVyID0gbG9hZGVyc1txaS51cmxdOwoJCWxvYWRlci5yZW1vdmVBbGxFdmVudExpc3RlbmVycygpOwoJCWxvYWRlci5jbG9zZSgpOwoJCXRoaXMuX3Bvb2xMb2FkZXIobG9hZGVyKTsKCQkKCQlkZWxldGUgcXVldWVJdGVtc1txaS51cmxdOwoJCWRlbGV0ZSBsb2FkZXJzW3FpLnVybF07CgkJCgkJaWYocmV0cmllc1txaS51cmxdKQoJCQlyZXRyaWVzW3FpLnVybF0rKzsKCQllbHNlCgkJCXJldHJpZXNbcWkudXJsXSA9IDE7CgkJaWYocmV0cmllc1txaS51cmxdID4gMykKCQkJdGhpcy5fbG9hZERvbmUocWksIG51bGwpOwoJCWVsc2UKCQl7CgkJCW51bUxvYWRzLS07CgkJCXF1ZXVlLnB1c2gocWkpOwoJCQl0aGlzLl90cnlOZXh0TG9hZCgpOwoJCX0KCX07CgkKCS8qKgoJKiAgVGhlIGZpbGUgbG9hZCBwcm9ncmVzcyBldmVudAoJKiAgQG1ldGhvZCBfb25Mb2FkUHJvZ3Jlc3MKCSogIEBwcml2YXRlCgkqICBAcGFyYW0ge2Nsb3Vka2lkLkxvYWRlclF1ZXVlSXRlbX0gcWkgVGhlIGxvYWRlciBxdWV1ZSBpdGVtCgkqICBAcGFyYW0ge29iamVjdH0gZXZlbnQgVGhlIHByb2dyZXNzIGV2ZW50CgkqLwoJcC5fb25Mb2FkUHJvZ3Jlc3MgPSBmdW5jdGlvbihxaSwgZXZlbnQpCgl7CgkJcWkucHJvZ3Jlc3MgPSBldmVudC5wcm9ncmVzczsKCQlpZiAocWkudXBkYXRlQ2FsbGJhY2spewoJCQlxaS51cGRhdGVDYWxsYmFjayhxaS5wcm9ncmVzcyk7CgkJfQkKCX07CgkKCS8qKgoJKiAgVGhlIGZpbGUgd2FzIGxvYWRlZCBzdWNjZXNzZnVsbHkKCSogIEBwcml2YXRlCgkqICBAbWV0aG9kIF9vbkxvYWRDb21wbGV0ZWQKCSogIEBwYXJhbSB7Y2xvdWRraWQuTG9hZGVyUXVldWVJdGVtfSBxaSBUaGUgbG9hZGVyIHF1ZXVlIGl0ZW0KCSogIEBwYXJhbSB7b2JqZWN0fSBldiBUaGUgbG9hZCBldmVudAoJKi8KCXAuX29uTG9hZENvbXBsZXRlZCA9IGZ1bmN0aW9uKHFpLCBldikKCXsKCQlpZih0cnVlKQoJCXsKCQkJRGVidWcubG9nKCJGaWxlIGxvYWRlZCBzdWNjZXNzZnVsbHkgZnJvbSAiICsgcWkudXJsKTsKCQl9CgkJdmFyIGxvYWRlciA9IGxvYWRlcnNbcWkudXJsXTsKCQlsb2FkZXIucmVtb3ZlQWxsRXZlbnRMaXN0ZW5lcnMoKTsKCQlsb2FkZXIuY2xvc2UoKTsKCQl0aGlzLl9wb29sTG9hZGVyKGxvYWRlcik7CgkJCgkJZGVsZXRlIHF1ZXVlSXRlbXNbcWkudXJsXTsKCQlkZWxldGUgbG9hZGVyc1txaS51cmxdOwoJCXRoaXMuX2xvYWREb25lKHFpLCB0aGlzLl9nZXRSZXN1bHQoZXYucmVzdWx0LCBxaS51cmwsIGxvYWRlcikpOwoJfTsKCQoJLyoqCgkqICBBdHRlbXB0IHRvIGRvIHRoZSBuZXh0IGxvYWQKCSogIEBtZXRob2QgX3RyeU5leHRMb2FkCgkqICBAcHJpdmF0ZQoJKi8KCXAuX3RyeU5leHRMb2FkID0gZnVuY3Rpb24oKQoJewoJCWlmIChudW1Mb2FkcyA+IHRoaXMubWF4U2ltdWx0YW5lb3VzTG9hZHMgLSAxIHx8IHF1ZXVlLmxlbmd0aCA9PT0gMCkgcmV0dXJuOwoJCQoJCW51bUxvYWRzKys7CgkJCgkJdmFyIHFpID0gcXVldWUuc2hpZnQoKTsKCQkKCQlpZih0cnVlKQoJCXsKCQkJRGVidWcubG9nKCJBdHRlbXB0aW5nIHRvIGxvYWQgZmlsZSAnIiArIHFpLnVybCArICInIik7CgkJfQoJCQoJCXF1ZXVlSXRlbXNbcWkudXJsXSA9IHFpOwoJCQoJCXZhciBsb2FkZXIgPSB0aGlzLl9nZXRMb2FkZXIocWkuYmFzZVBhdGgpOwoJCQoJCS8vIEFkZCB0byB0aGUgbGlzdCBvZiBsb2FkZXJzCgkJbG9hZGVyc1txaS51cmxdID0gbG9hZGVyOwoJCQoJCWxvYWRlci5hZGRFdmVudExpc3RlbmVyKCJmaWxlbG9hZCIsIHFpLl9ib3VuZENvbXBsZXRlKTsKCQlsb2FkZXIuYWRkRXZlbnRMaXN0ZW5lcigiZXJyb3IiLCBxaS5fYm91bmRGYWlsKTsKCQlsb2FkZXIuYWRkRXZlbnRMaXN0ZW5lcigiZmlsZXByb2dyZXNzIiwgcWkuX2JvdW5kUHJvZ3Jlc3MpOwoJCXZhciB1cmwgPSB0aGlzLmNhY2hlTWFuYWdlci5wcmVwYXJlKHFpLnVybCk7CgkJbG9hZGVyLmxvYWRGaWxlKHFpLmRhdGEgPyB7aWQ6cWkuZGF0YS5pZCwgc3JjOnVybCwgZGF0YTpxaS5kYXRhfSA6IHVybCk7Cgl9OwoJCgkvKioKCSogIEFsZXJ0IHRoYXQgdGhlIGxvYWRpbmcgaXMgZmluaXNoZWQKCSogIEBwcml2YXRlIAoJKiAgQG1ldGhvZCBfbG9hZERvbmUKCSogIEBwYXJhbSB7Y2xvdWRraWQuTG9hZGVyUXVldWVJdGVtfSBxaSBUaGUgbG9hZGVyIHF1ZXVlIGl0ZW0KCSogIEBwYXJhbSB7b2JqZWN0fSByZXN1bHQgVGhlIGV2ZW50IGZyb20gcHJlbG9hZGpzIG9yIG51bGwKCSovCglwLl9sb2FkRG9uZSA9IGZ1bmN0aW9uKHFpLCByZXN1bHQpCgl7CgkJbnVtTG9hZHMtLTsKCQlpZihxaS5kYXRhICYmIHJlc3VsdCkvL2Egd2F5IHRvIGtlZXAgdHJhY2sgb2YgbG9hZCByZXN1bHRzIHdpdGhvdXQgZXhjZXNzaXZlIGZ1bmN0aW9uIGJpbmRpbmcKCQkJcmVzdWx0LmlkID0gcWkuZGF0YS5pZDsKCQlxaS5jYWxsYmFjayhyZXN1bHQpOwoJCS8vcWkuZGVzdHJveSgpOwoJCXRoaXMuX3Bvb2xRSShxaSk7CgkJdGhpcy5fdHJ5TmV4dExvYWQoKTsKCX07CgkKCS8qKgoJKiAgQ2FuY2VsIGEgbG9hZCB0aGF0J3MgY3VycmVudGx5IGluIHByb2dyZXNzCgkqICBAcHVibGljCgkqICBAbWV0aG9kIGNhbmNlbAoJKiAgQHBhcmFtIHtzdHJpbmd9IHVybCBUaGUgdXJsCgkqICBAcmV0dXJuIHtib29sfSBJZiBjYW5jZWxlZCByZXR1cm5zIHRydWUsIGZhbHNlIGlmIG5vdCBjYW5jZWxlZAoJKi8KCXAuY2FuY2VsID0gZnVuY3Rpb24odXJsKQoJewoJCXZhciBxaSA9IHF1ZXVlSXRlbXNbdXJsXTsKCQl2YXIgbG9hZGVyID0gbG9hZGVyc1t1cmxdOwoJCQoJCWlmIChxaSAmJiBsb2FkZXIpCgkJewoJCQlsb2FkZXIuY2xvc2UoKTsKCQkJZGVsZXRlIGxvYWRlcnNbdXJsXTsKCQkJZGVsZXRlIHF1ZXVlSXRlbXNbcWkudXJsXTsKCQkJbnVtTG9hZHMtLTsKCQkJdGhpcy5fcG9vbExvYWRlcihsb2FkZXIpOwoJCQl0aGlzLl9wb29sUUkocWkpOwoJCQlyZXR1cm4gdHJ1ZTsKCQl9CgkJCgkJZm9yKGkgPSAwLCBsZW4gPSBxdWV1ZS5sZW5ndGg7IGkgPCBsZW47IGkrKykKCQl7CgkJCXFpID0gcXVldWVbaV07CgkJCWlmIChxaS51cmwgPT0gdXJsKXsKCQkJCXF1ZXVlLnNwbGljZShpLCAxKTsKCQkJCXRoaXMuX3Bvb2xRSShxaSk7CgkJCQlyZXR1cm4gdHJ1ZTsKCQkJfQoJCX0KCQlyZXR1cm4gZmFsc2U7CQkKCX07CgkKCXAuX2dldFFJID0gZnVuY3Rpb24oKQoJewoJCXZhciBydG47CgkJaWYocWlQb29sLmxlbmd0aCkKCQkJcnRuID0gcWlQb29sLnBvcCgpOwoJCWVsc2UKCQl7CgkJCXJ0biA9IG5ldyBjbG91ZGtpZC5Mb2FkZXJRdWV1ZUl0ZW0oKTsKCQkJcnRuLl9ib3VuZEZhaWwgPSB0aGlzLl9vbkxvYWRGYWlsZWQuYmluZCh0aGlzLCBydG4pOwoJCQlydG4uX2JvdW5kUHJvZ3Jlc3MgPSB0aGlzLl9vbkxvYWRQcm9ncmVzcy5iaW5kKHRoaXMsIHJ0bik7CgkJCXJ0bi5fYm91bmRDb21wbGV0ZSA9IHRoaXMuX29uTG9hZENvbXBsZXRlZC5iaW5kKHRoaXMsIHJ0bik7CgkJfQoJCXJldHVybiBydG47Cgl9OwoJCglwLl9wb29sUUkgPSBmdW5jdGlvbihxaSkKCXsKCQlxaVBvb2wucHVzaChxaSk7CgkJcWkuY2FsbGJhY2sgPSBxaS51cGRhdGVDYWxsYmFjayA9IHFpLmRhdGEgPSBxaS51cmwgPSBudWxsOwoJCXFpLnByb2dyZXNzID0gMDsKCX07CgkKCXAuX2dldExvYWRlciA9IGZ1bmN0aW9uKGJhc2VQYXRoKQoJewoJCXZhciBydG47CgkJaWYobG9hZGVyUG9vbC5sZW5ndGgpCgkJewoJCQlydG4gPSBsb2FkZXJQb29sLnBvcCgpOwoJCQlydG4uX2Jhc2VQYXRoID0gYmFzZVBhdGg7Ly9hcHBhcmVudGx5IHRoZXkgbmVnbGVjdGVkIHRvIG1ha2UgdGhpcyBwdWJsaWMKCQl9CgkJZWxzZQoJCQlydG4gPSBuZXcgY3JlYXRlanMuTG9hZFF1ZXVlKHRydWUsIGJhc2VQYXRoKTsKCQkvL2FsbG93IHRoZSBsb2FkZXIgdG8gaGFuZGxlIHNvdW5kIGFzIHdlbGwKCQlpZihjcmVhdGVqcy5Tb3VuZCkKCQkJcnRuLmluc3RhbGxQbHVnaW4oY3JlYXRlanMuU291bmQpOwoJCXJldHVybiBydG47Cgl9OwoJCglwLl9wb29sTG9hZGVyID0gZnVuY3Rpb24obG9hZGVyKQoJewoJCWxvYWRlci5yZW1vdmVBbGwoKTsvL2NsZWFyIHRoZSBsb2FkZXIgZm9yIHJldXNlCgkJbG9hZGVyUG9vbC5wdXNoKGxvYWRlcik7Cgl9OwoJCglwLl9nZXRSZXN1bHQgPSBmdW5jdGlvbihyZXN1bHQsIHVybCwgbG9hZGVyKQoJewoJCXZhciBydG47CgkJaWYocmVzdWx0UG9vbC5sZW5ndGgpCgkJewoJCQlydG4gPSByZXN1bHRQb29sLnBvcCgpOwoJCQlydG4uY29udGVudCA9IHJlc3VsdDsKCQkJcnRuLnVybCA9IHVybDsKCQkJcnRuLmxvYWRlciA9IGxvYWRlcjsKCQl9CgkJZWxzZQoJCQlydG4gPSBuZXcgY2xvdWRraWQuTWVkaWFMb2FkZXJSZXN1bHQocmVzdWx0LCB1cmwsIGxvYWRlcik7CgkJcmV0dXJuIHJ0bjsKCX07CgkKCXAuX3Bvb2xSZXN1bHQgPSBmdW5jdGlvbihyZXN1bHQpCgl7CgkJcmVzdWx0LmNvbnRlbnQgPSByZXN1bHQudXJsID0gcmVzdWx0LmxvYWRlciA9IHJlc3VsdC5pZCA9IG51bGw7CgkJcmVzdWx0UG9vbC5wdXNoKHJlc3VsdCk7Cgl9OwoJCgluYW1lc3BhY2UoJ2Nsb3Vka2lkJykuTWVkaWFMb2FkZXIgPSBNZWRpYUxvYWRlcjsKfSgpKTsKLyoqCiogIEBtb2R1bGUgY2xvdWRraWQKKi8KKGZ1bmN0aW9uKCl7CgkKCSJ1c2Ugc3RyaWN0IjsKCgkvKioKCSogIFRoZSByZXR1cm4gcmVzdWx0IG9mIHRoZSBNZWRpYUxvYWRlciBsb2FkCgkqICBAY2xhc3MgTWVkaWFMb2FkZXJSZXN1bHQKCSogIEBjb25zdHJ1Y3RvcgoJKiAgQHBhcmFtIHsqfSBjb250ZW50IFRoZSBkeW5hbWljIGNvbnRlbnQgbG9hZGVkCgkqICBAcGFyYW0ge3N0cmluZ30gdXJsIFRoZSB1cmwgdGhhdCB3YXMgbG9hZGVkCgkqICBAcGFyYW0ge2NyZWF0ZWpzLkxvYWRRdWV1ZX0gbG9hZGVyIFRoZSBMb2FkUXVldWUgdGhhdCBwZXJmb3JtZWQgdGhlIGxvYWQKCSovCgl2YXIgTWVkaWFMb2FkZXJSZXN1bHQgPSBmdW5jdGlvbihjb250ZW50LCB1cmwsIGxvYWRlcikKCXsKCQl0aGlzLmNvbnRlbnQgPSBjb250ZW50OwoJCXRoaXMudXJsID0gdXJsOwoJCXRoaXMubG9hZGVyID0gbG9hZGVyOwoJfTsKCQoJLyoqIFJlZmVyZW5jZSB0byB0aGUgcHJvdG90eXBlICovCgl2YXIgcCA9IE1lZGlhTG9hZGVyUmVzdWx0LnByb3RvdHlwZTsKCQoJLyoqCgkqICBUaGUgY29udGVudHMgb2YgdGhlIGxvYWQKCSogIEBwdWJsaWMKCSogIEBwcm9wZXJ0eSB7Kn0gY29udGVudCAKCSovCglwLmNvbnRlbnQgPSBudWxsOwoJCgkvKioKCSogIFRoZSB1cmwgb2YgdGhlIGxvYWQKCSogIEBwdWJsaWMKCSogIEBwcm9wZXJ0eSB7c3RyaW5nfSB1cmwKCSovCglwLnVybCA9IG51bGw7CgkKCS8qKgoJKiAgUmVmZXJlbmNlIHRvIHRoZSBwcmVsb2FkZXIgb2JqZWN0CgkqICBAcHVibGljCgkqICBAcHJvcGVydHkge2NyZWF0ZWpzLkxvYWRlclF1ZXVlfSBsb2FkZXIKCSovCglwLmxvYWRlciA9IG51bGw7CgkKCS8qKgoJKiBBIHRvIHN0cmluZyBtZXRob2QKCSogQHB1YmxpYwoJKiBAbWV0aG9kIHRvU3RyaW5nCgkqIEByZXR1cm4ge3N0cmluZ30gQSBzdHJpbmcgcmVwIG9mIHRoZSBvYmplY3QKCSovCglwLnRvU3RyaW5nID0gZnVuY3Rpb24oKQoJewoJCXJldHVybiAiW01lZGlhTG9hZGVyUmVzdWx0KCciK3RoaXMudXJsKyInKV0iOwoJfTsKCQoJLyoqCgkqIERlc3Ryb3kgdGhpcyByZXN1bHQKCSogQHB1YmxpYwoJKiBAbWV0aG9kIGRlc3Ryb3kKCSovCglwLmRlc3Ryb3kgPSBmdW5jdGlvbigpCgl7CgkJdGhpcy5jYWxsYmFjayA9IG51bGw7CgkJdGhpcy51cmwgPSBudWxsOwoJCXRoaXMuY29udGVudCA9IG51bGw7Cgl9OwoJCgkvLyBBc3NpZ24gdG8gdGhlIG5hbWUgc3BhY2UKCW5hbWVzcGFjZSgnY2xvdWRraWQnKS5NZWRpYUxvYWRlclJlc3VsdCA9IE1lZGlhTG9hZGVyUmVzdWx0Owp9KCkpOwovKioKKiAgQG1vZHVsZSBjbG91ZGtpZAoqLwooZnVuY3Rpb24odW5kZWZpbmVkKXsKCQoJInVzZSBzdHJpY3QiOwoJCgkvKioKCSogIFVzZWQgZm9yIG1hbmFnaW5nIHRoZSBicm93c2VyIGNhY2hlIG9mIGxvYWRpbmcgZXh0ZXJuYWwgZWxlbWVudHMKCSogIGNhbiBlYXNpbHkgbG9hZCB2ZXJzaW9uIG1hbmlmZXN0IGFuZCBhcHBseSBpdCB0byB0aGUgbWVkaWEgbG9hZGVyCgkqICBzdXBwb3J0cyBjYWNoZSBidXN0aW5nIGFsbCBtZWRpYSBsb2FkIHJlcXVlc3RzCgkqICB1c2VzIHRoZSBxdWVyeSBzdHJpbmcgdG8gYnVzdCBicm93c2VyIHZlcnNpb25zLgoJKiAKCSogIEBjbGFzcyBDYWNoZU1hbmFnZXIKCSovCgl2YXIgQ2FjaGVNYW5hZ2VyID0gZnVuY3Rpb24oKQoJewoJCXRoaXMuaW5pdGlhbGl6ZSgpOwoJfTsKCQoJLyoqIEVhc3kgYWNjZXNzIHRvIHRoZSBwcm90b3R5cGUgKi8KCXZhciBwID0gQ2FjaGVNYW5hZ2VyLnByb3RvdHlwZSA9IHt9OwoJCgkvKioKCSogIFRoZSBjb2xsZWN0aW9uIG9mIHZlcnNpb24gbnVtYmVycwoJKiAgQHByb3RlY3RlZAoJKiAgQHByb3BlcnR5IHtEaWN0aW9uYXJ5fSBfdmVyc2lvbnMKCSovCglwLl92ZXJzaW9ucyA9IG51bGw7CgkKCS8qKgoJKiAgSWYgd2UgYXJlIHN1cHBvc2UgdG8gY2FjaGUgYnVzdCBldmVyeSBmaWxlCgkqICBAcHJvcGVydHkge2Jvb2x9IGNhY2hlQnVzdAoJKiAgQHB1YmxpYwoJKiAgQGRlZmF1bHQgZmFsc2UKCSovCglwLmNhY2hlQnVzdCA9IGZhbHNlOwoJCgkvKioKCSogVGhlIGNvbnN0cnVjdG9yIGZvciB0aGUgQ2FjaGUgbWFuYWdlcgoJKiBAcHVibGljCgkqIEBjb25zdHJ1Y3RvcgoJKiBAbWV0aG9kIGluaXRpYWxpemUKCSovCglwLmluaXRpYWxpemUgPSBmdW5jdGlvbigpCgl7CgkJdGhpcy5fdmVyc2lvbnMgPSBbXTsKCQkJCQoJCXZhciBjYiA9IGNsb3Vka2lkLk9TLmluc3RhbmNlLm9wdGlvbnMuY2FjaGVCdXN0OwoJCXRoaXMuY2FjaGVCdXN0ID0gY2IgPyAoY2IgPT09ICJ0cnVlIiB8fCBjYiA9PT0gdHJ1ZSkgOiBmYWxzZTsKCQkKCQlpZih0cnVlKQoJCXsKCQkJaWYgKHRoaXMuY2FjaGVCdXN0KSBEZWJ1Zy5sb2coIkNhY2hlQnVzdCBhbGwgZmlsZXMgaXMgb24uIik7CgkJfQoJfTsKCQoJLyoqCgkqICBEZXN0cm95IHRoZSBjYWNoZSBtYW5hZ2VyLCBkb24ndCB1c2UgYWZ0ZXIgdGhpcwoJKiAgQHB1YmxpYwoJKiAgQG1ldGhvZCBkZXN0cm95CgkqLwoJcC5kZXN0cm95ID0gZnVuY3Rpb24oKQoJewoJCXRoaXMuX3ZlcnNpb25zID0gbnVsbDsKCX07CgkKCS8qKgoJKiAgQWRkIHRoZSB2ZXJzaW9ucwoJKiAgQHB1YmxpYwoJKiAgQG1ldGhvZCBhZGRWZXJzaW9uc0ZpbGUKCSogIEBwYXJhbSB7c3RyaW5nfSB1cmwgVGhlIHVybCBvZiB0aGUgdmVyc2lvbnMgZmlsZQoJKiAgQHBhcmFtIHtmdW5jdGlvbn0gY2FsbGJhY2sgQ2FsbGJhY2sgd2hlbiB0aGUgdXJsIGhhcyBiZWVuIGxhb2RlZAoJKiAgQHBhcmFtIHtzdHJpbmd9IGJhc2VVcmwgQSBiYXNlIHVybCB0byBwcmVwZW5kIGFsbCBsaW5lcyBvZiB0aGUgZmlsZQoJKi8KCXAuYWRkVmVyc2lvbnNGaWxlID0gZnVuY3Rpb24odXJsLCBjYWxsYmFjaywgYmFzZVVybCkKCXsJCQoJCURlYnVnLmFzc2VydCgvXi4qXC50eHQkLy50ZXN0KHVybCksICJUaGUgdmVyc2lvbnMgZmlsZSBtdXN0IGJlIGEgKi50eHQgZmlsZSIpOwoJCQkJCgkJdmFyIG1sID0gY2xvdWRraWQuTWVkaWFMb2FkZXIuaW5zdGFuY2U7CgkJCgkJLy8gSWYgd2UgYWxyZWFkeSBjYWNoZSBidXN0aW5nLCB3ZSBjYW4gaWdub3JlIHRoaXMKCQlpZiAodGhpcy5jYWNoZUJ1c3QpCgkJewoJCQlpZiAoY2FsbGJhY2spIGNhbGxiYWNrKCk7CgkJCXJldHVybjsKCQl9CgkJCgkJLy8gQWRkIGEgcmFuZG9tIHZlcnNpb24gbnVtYmVyIHRvIG5ldmVyIGNhY2hlIHRoZSB0ZXh0IGZpbGUKCQl0aGlzLmFkZFZlcnNpb24odXJsLCBNYXRoLnJvdW5kKE1hdGgucmFuZG9tKCkqMTAwMDAwKSk7CgkJCgkJdmFyIGNtID0gdGhpczsKCQkKCQkvLyBMb2FkIHRoZSB2ZXJzaW9uCgkJbWwubG9hZCh1cmwsIAoJCQlmdW5jdGlvbihyZXN1bHQpCgkJCXsJCQkJCgkJCQkvLyBjaGVjayBmb3IgYSB2YWxpZCByZXN1bHQgY29udGVudAoJCQkJaWYgKHJlc3VsdCAmJiByZXN1bHQuY29udGVudCkKCQkJCXsKCQkJCQkvLyBSZW1vdmUgY2FycmFnZSByZXR1cm5zIGFuZCBzcGxpdCBvbiBuZXdsaW5lcwoJCQkJCXZhciBsaW5lcyA9IHJlc3VsdC5jb250ZW50LnJlcGxhY2UoL1xyL2csICcnKS5zcGxpdCgiXG4iKTsKCQkJCQl2YXIgaSwgcGFydHM7CgoJCQkJCS8vIEdvIGxpbmUgYnkgbGluZQoJCQkJCWZvcihpID0gMDsgaSA8IGxpbmVzLmxlbmd0aDsgaSsrKQoJCQkJCXsJCgkJCQkJCS8vIENoZWNrIGZvciBhIHZhbGlkIGxpbmUKCQkJCQkJaWYgKCFsaW5lc1tpXSkgY29udGludWU7CgoJCQkJCQkvLyBTcGxpdCBsaW5lcwoJCQkJCQlwYXJ0cyA9IGxpbmVzW2ldLnNwbGl0KCcgJyk7CgoJCQkJCQkvLyBBZGQgdGhlIHBhcnRzCgkJCQkJCWlmIChwYXJ0cy5sZW5ndGggIT0gMikgY29udGludWU7CgoJCQkJCQkvLyBBZGQgdGhlIHZlcnNpb25pbmcKCQkJCQkJY20uYWRkVmVyc2lvbigoYmFzZVVybCB8fCAiIikgKyBwYXJ0c1swXSwgcGFydHNbMV0pOwoJCQkJCX0KCQkJCX0KCQkJCWlmIChjYWxsYmFjaykgY2FsbGJhY2soKTsKCQkJfQoJCSk7Cgl9OwoJCgkvKioKCSogIEFkZCBhIHZlcnNpb24gbnVtYmVyIGZvciBhIGZpbGUKCSogIEBtZXRob2QgYWRkVmVyc2lvbgoJKiAgQHB1YmxpYwoJKiAgQHBhcmFtIHtzdHJpbmd9IHVybCBUaGUgdXJsIG9mIHRoZSBvYmplY3QKCSogIEBwYXJhbSB7c3RyaW5nfSB2ZXJzaW9uIFZlcnNpb24gbnVtYmVyIG9yIGhhcyBvZiBmaWxlCgkqLwoJcC5hZGRWZXJzaW9uID0gZnVuY3Rpb24odXJsLCB2ZXJzaW9uKQoJewoJCXZhciB2ZXIgPSB0aGlzLl9nZXRWZXJzaW9uQnlVcmwodXJsKTsKCQlpZiAoIXZlcikKCQkJdGhpcy5fdmVyc2lvbnMucHVzaCh7J3VybCc6IHVybCwgJ3ZlcnNpb24nOiB2ZXJzaW9ufSk7Cgl9OwoJCgkvKioKCSogIFNlYXJjaCBmb3IgYSB2ZXJzaW9uIG51bWJlciBieSB1cmwKCSogIEBtZXRob2QgX2dldFZlcnNpb25CeVVybAoJKiAgQHByaXZhdGUKCSogIEBwYXJhbSB7c3RyaW5nfSB1cmwgVGhlIHVybCB0byBzZWFyY2gKCSogIEByZXR1cm4ge3N0cmluZ30gVGhlIHZlcnNpb24gbnVtYmVyIGFzIGEgc3RyaW5nIG9yIG51bGwKCSovCglwLl9nZXRWZXJzaW9uQnlVcmwgPSBmdW5jdGlvbih1cmwpCgl7CgkJdmFyIGksIGxlbiA9IHRoaXMuX3ZlcnNpb25zLmxlbmd0aDsKCQlmb3IoaSA9IDA7IGkgPCBsZW47IGkrKykKCQl7CgkJCWlmICh1cmwgPT0gdGhpcy5fdmVyc2lvbnNbaV0udXJsKQoJCQl7CgkJCQlyZXR1cm4gdGhpcy5fdmVyc2lvbnNbaV07CgkJCX0KCQl9CgkJcmV0dXJuIG51bGw7Cgl9OwoJCgkvKioKCSogIFByZXBhcmUgYSBVUkwgd2l0aCB0aGUgbmVjZXNzYXJ5IGNhY2hlIGJ1c3RpbmcgYW5kL29yIHZlcnNpb25pbmcKCSogIGFzIHdlbGwgYXMgdGhlIGJhc2UgZGlyZWN0b3J5cgoJKiAgQHB1YmxpYwoJKiAgQG1ldGhvZCBwcmVwYXJlCgkqICBAcGFyYW0ge3N0cmluZ30gdXJsIFRoZSB1cmwgdG8gcHJlcGFyZQoJKiAgQHBhcmFtIHtib29sfSBhcHBseUJhc2VQYXRoIElmIHRoZSBnbG9iYWwgYmFzZSBwYXRoIHNob3VsZCBiZSBhcHBsaWVkIHRvIHRoZSB1cmwuIFRoaXMgZGVmYXVsdHMgdG8gZmFsc2UgYmVjYXVzZSBpdCBjYW4gCgkqCQkJCQkJCQlwb3RlbnRpYWxseSBpbnRlcmZlcmUgd2l0aCBsYXRlciByZWd1bGFyIGV4cHJlc3Npb24gY2hlY2tzLCBwYXJ0aWN1bGFybHkgd2l0aCBQcmVsb2FkSlMKCSogIEByZXR1cm4ge3N0cmluZ30gVGhlIGZpbmFsIHVybCB3aXRoIHZlcnNpb24vY2FjaGUgYW5kIGJhc2VQYXRoIGFkZGVkCgkqLwoJcC5wcmVwYXJlID0gZnVuY3Rpb24odXJsLCBhcHBseUJhc2VQYXRoKQoJewoJCXZhciB2ZXIgPSB0aGlzLl9nZXRWZXJzaW9uQnlVcmwodXJsKTsKCQkKCQlpZiAodGhpcy5jYWNoZUJ1c3QgJiYgLyhcP3xcJiljYlw9WzAtOV0qLy50ZXN0KHVybCkgPT09IGZhbHNlKQoJCXsKCQkJaWYoIXRoaXMuX2NiVmFsKQoJCQkJdGhpcy5fY2JWYWwgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKS50b1N0cmluZygpOwoJCQl1cmwgPSB1cmwgKyAodXJsLmluZGV4T2YoIj8iKSA8IDAgPyAiPyIgOiAiJiIpICsgImNiPSIgKyB0aGlzLl9jYlZhbDsKCQl9IAoJCWVsc2UgaWYgKHZlciAmJiAvKFw/fFwmKXZcPVswLTldKi8udGVzdCh1cmwpID09PSBmYWxzZSkKCQl7CgkJCXVybCA9IHVybCArICh1cmwuaW5kZXhPZigiPyIpIDwgMCA/ICI/IiA6ICImIikgKyAidj0iICsgdmVyLnZlcnNpb247CgkJfQoJCWlmKGFwcGx5QmFzZVBhdGgpCgkJewoJCQl2YXIgYmFzZVBhdGggPSBjbG91ZGtpZC5PUy5pbnN0YW5jZS5vcHRpb25zLmJhc2VQYXRoOwoJCQlpZiAoL15odHRwKHMpP1w6Ly50ZXN0KHVybCkgPT09IGZhbHNlICYmIGJhc2VQYXRoICE9PSB1bmRlZmluZWQgJiYgdXJsLnNlYXJjaChiYXNlUGF0aCkgPT0gLTEpCgkJCXsKCQkJCXVybCA9IGJhc2VQYXRoICsgdXJsOwoJCQl9CgkJfQoJCXJldHVybiB1cmw7Cgl9OwoJCgluYW1lc3BhY2UoJ2Nsb3Vka2lkJykuQ2FjaGVNYW5hZ2VyID0gQ2FjaGVNYW5hZ2VyOwoJCn0oKSk7Ci8qKgoqICBAbW9kdWxlIGNsb3Vka2lkCiovCihmdW5jdGlvbih1bmRlZmluZWQpIHsKCgkidXNlIHN0cmljdCI7CgkKCS8qKgoJKiAgQSBNdWx0aXB1cnBvc2UgYnV0dG9uIGNsYXNzLiBJdCBpcyBkZXNpZ25lZCB0byBoYXZlIG9uZSBpbWFnZSwgYW5kIGFuIG9wdGlvbmFsIHRleHQgbGFiZWwuCgkqICBUaGUgYnV0dG9uIGNhbiBiZSBhIG5vcm1hbCBidXR0b24gb3IgYSBzZWxlY3RhYmxlIGJ1dHRvbi4KCSogIFRoZSBidXR0b24gZnVuY3Rpb25zIHNpbWlsYXJseSB3aXRoIGJvdGggQ3JlYXRlSlMgYW5kIFBJWEksIGJ1dCBzbGlnaHRseSBkaWZmZXJlbnRseSBpbgoJKiAgaW5pdGlhbGl6YXRpb24gYW5kIGNhbGxiYWNrcy4gQWRkIGV2ZW50IGxpc3RlbmVycyBmb3IgY2xpY2sgYW5kIG1vdXNlb3ZlciB0byBrbm93IGFib3V0IAoJKiAgYnV0dG9uIGNsaWNrcyBhbmQgbW91c2Ugb3ZlcnMsIHJlc3BlY3RpdmVseS4KCSogCgkqICBAY2xhc3MgQnV0dG9uIChDcmVhdGVKUykKCSogIEBleHRlbmRzIGNyZWF0ZWpzLkNvbnRhaW5lcgoJKiAgQGNvbnN0cnVjdG9yCgkqICBAcGFyYW0ge09iamVjdHxJbWFnZXxIVE1MQ2FudmFzRWxlbWVudH0gW2ltYWdlU2V0dGluZ3NdIEluZm9ybWF0aW9uIGFib3V0IHRoZSBhcnQgdG8gYmUgdXNlZCBmb3IgYnV0dG9uIHN0YXRlcywgYXMgd2VsbCBhcyBpZiB0aGUgYnV0dG9uIGlzIHNlbGVjdGFibGUgb3Igbm90LgoJKiAgICAgICAgIElmIHRoaXMgaXMgYW4gSW1hZ2Ugb3IgQ2FudmFzIGVsZW1lbnQsIHRoZW4gdGhlIGJ1dHRvbiBhc3N1bWVzIHRoYXQgdGhlIGltYWdlIGlzIGZ1bGwgd2lkdGggYW5kIDMgaW1hZ2VzCgkqICAgICAgICAgdGFsbCwgaW4gdGhlIG9yZGVyICh0b3AgdG8gYm90dG9tKSB1cCwgb3ZlciwgZG93bi4gSWYgc28sIHRoZW4gdGhlIHByb3BlcnRpZXMgb2YgaW1hZ2VTZXR0aW5ncyBhcmUgaWdub3JlZC4KCSogIEBwYXJhbSB7SW1hZ2V8SFRNTENhbnZhc0VsZW1lbnR9IFtpbWFnZVNldHRpbmdzLmltYWdlXSBUaGUgaW1hZ2UgdG8gdXNlIGZvciBhbGwgb2YgdGhlIGJ1dHRvbiBzdGF0ZXMuCgkqICBAcGFyYW0ge0FycmF5fSBbaW1hZ2VTZXR0aW5ncy5wcmlvcml0eT1udWxsXSBUaGUgc3RhdGUgcHJpb3JpdHkgb3JkZXIuIElmIG9taXR0ZWQsIGRlZmF1bHRzIHRvIFsiZGlzYWJsZWQiLCAiZG93biIsICJvdmVyIiwgInVwIl0uCgkqICAgICAgICAgUHJldmlvdXMgdmVyc2lvbnMgb2YgQnV0dG9uIHVzZWQgYSBoYXJkIGNvZGVkIG9yZGVyOiBbImhpZ2hsaWdodGVkIiwgImRpc2FibGVkIiwgImRvd24iLCAib3ZlciIsICJzZWxlY3RlZCIsICJ1cCJdLgoJKiAgQHBhcmFtIHtPYmplY3R9IFtpbWFnZVNldHRpbmdzLnVwXSBUaGUgdmlzdWFsIGluZm9ybWF0aW9uIGFib3V0IHRoZSB1cCBzdGF0ZS4KCSogIEBwYXJhbSB7Y3JlYXRlanMuUmVjdGFuZ2xlfSBbaW1hZ2VTZXR0aW5ncy51cC5zcmNdIFRoZSBzb3VyY2VSZWN0IGZvciB0aGUgc3RhdGUgd2l0aGluIHRoZSBpbWFnZS4KCSogIEBwYXJhbSB7Y3JlYXRlanMuUmVjdGFuZ2xlfSBbaW1hZ2VTZXR0aW5ncy51cC50cmltPW51bGxdIFRyaW0gZGF0YSBhYm91dCB0aGUgc3RhdGUsIHdoZXJlIHggJiB5IGFyZSBob3cgbWFueSBwaXhlbHMgd2VyZSAKCSogICAgICAgICB0cmltbWVkIG9mZiB0aGUgbGVmdCBhbmQgcmlnaHQsIGFuZCBoZWlnaHQgJiB3aWR0aCBhcmUgdGhlIHVudHJpbW1lZCBzaXplIG9mIHRoZSBidXR0b24uCgkqICBAcGFyYW0ge09iamVjdH0gW2ltYWdlU2V0dGluZ3MudXAubGFiZWw9bnVsbF0gTGFiZWwgaW5mb3JtYXRpb24gc3BlY2lmaWMgdG8gdGhpcyBzdGF0ZS4gUHJvcGVydGllcyBvbiB0aGlzIHBhcmFtZXRlciBvdmVycmlkZSBkYXRhIAoJKiAgICAgICAgIGluIHRoZSBsYWJlbCBwYXJhbWV0ZXIgZm9yIHRoaXMgYnV0dG9uIHN0YXRlIG9ubHkuIEFsbCB2YWx1ZXMgZXhjZXB0ICJ0ZXh0IiBmcm9tIHRoZSBsYWJlbCBwYXJhbWV0ZXIgbWF5IGJlIG92ZXJyaWRkZW4uCgkqICBAcGFyYW0ge09iamVjdH0gW2ltYWdlU2V0dGluZ3Mub3Zlcj1udWxsXSBUaGUgdmlzdWFsIGluZm9ybWF0aW9uIGFib3V0IHRoZSBvdmVyIHN0YXRlLiBJZiBvbWl0dGVkLCB1c2VzIHRoZSB1cCBzdGF0ZS4KCSogIEBwYXJhbSB7Y3JlYXRlanMuUmVjdGFuZ2xlfSBbaW1hZ2VTZXR0aW5ncy5vdmVyLnNyY10gVGhlIHNvdXJjZVJlY3QgZm9yIHRoZSBzdGF0ZSB3aXRoaW4gdGhlIGltYWdlLgoJKiAgQHBhcmFtIHtjcmVhdGVqcy5SZWN0YW5nbGV9IFtpbWFnZVNldHRpbmdzLm92ZXIudHJpbT1udWxsXSBUcmltIGRhdGEgYWJvdXQgdGhlIHN0YXRlLCB3aGVyZSB4ICYgeSBhcmUgaG93IG1hbnkgcGl4ZWxzIHdlcmUgCgkqICAgICAgICAgdHJpbW1lZCBvZmYgdGhlIGxlZnQgYW5kIHJpZ2h0LCBhbmQgaGVpZ2h0ICYgd2lkdGggYXJlIHRoZSB1bnRyaW1tZWQgc2l6ZSBvZiB0aGUgYnV0dG9uLgoJKiAgQHBhcmFtIHtPYmplY3R9IFtpbWFnZVNldHRpbmdzLm92ZXIubGFiZWw9bnVsbF0gTGFiZWwgaW5mb3JtYXRpb24gc3BlY2lmaWMgdG8gdGhpcyBzdGF0ZS4gUHJvcGVydGllcyBvbiB0aGlzIHBhcmFtZXRlciBvdmVycmlkZSBkYXRhIAoJKiAgICAgICAgIGluIHRoZSBsYWJlbCBwYXJhbWV0ZXIgZm9yIHRoaXMgYnV0dG9uIHN0YXRlIG9ubHkuIEFsbCB2YWx1ZXMgZXhjZXB0ICJ0ZXh0IiBmcm9tIHRoZSBsYWJlbCBwYXJhbWV0ZXIgbWF5IGJlIG92ZXJyaWRkZW4uCgkqICBAcGFyYW0ge09iamVjdH0gW2ltYWdlU2V0dGluZ3MuZG93bj1udWxsXSBUaGUgdmlzdWFsIGluZm9ybWF0aW9uIGFib3V0IHRoZSBkb3duIHN0YXRlLiBJZiBvbWl0dGVkLCB1c2VzIHRoZSB1cCBzdGF0ZS4KCSogIEBwYXJhbSB7Y3JlYXRlanMuUmVjdGFuZ2xlfSBbaW1hZ2VTZXR0aW5ncy5kb3duLnNyY10gVGhlIHNvdXJjZVJlY3QgZm9yIHRoZSBzdGF0ZSB3aXRoaW4gdGhlIGltYWdlLgoJKiAgQHBhcmFtIHtjcmVhdGVqcy5SZWN0YW5nbGV9IFtpbWFnZVNldHRpbmdzLmRvd24udHJpbT1udWxsXSBUcmltIGRhdGEgYWJvdXQgdGhlIHN0YXRlLCB3aGVyZSB4ICYgeSBhcmUgaG93IG1hbnkgcGl4ZWxzIHdlcmUgCgkqICAgICAgICAgdHJpbW1lZCBvZmYgdGhlIGxlZnQgYW5kIHJpZ2h0LCBhbmQgaGVpZ2h0ICYgd2lkdGggYXJlIHRoZSB1bnRyaW1tZWQgc2l6ZSBvZiB0aGUgYnV0dG9uLgoJKiAgQHBhcmFtIHtPYmplY3R9IFtpbWFnZVNldHRpbmdzLmRvd24ubGFiZWw9bnVsbF0gTGFiZWwgaW5mb3JtYXRpb24gc3BlY2lmaWMgdG8gdGhpcyBzdGF0ZS4gUHJvcGVydGllcyBvbiB0aGlzIHBhcmFtZXRlciBvdmVycmlkZSBkYXRhIAoJKiAgICAgICAgIGluIHRoZSBsYWJlbCBwYXJhbWV0ZXIgZm9yIHRoaXMgYnV0dG9uIHN0YXRlIG9ubHkuIEFsbCB2YWx1ZXMgZXhjZXB0ICJ0ZXh0IiBmcm9tIHRoZSBsYWJlbCBwYXJhbWV0ZXIgbWF5IGJlIG92ZXJyaWRkZW4uCgkqICBAcGFyYW0ge09iamVjdH0gW2ltYWdlU2V0dGluZ3MuZGlzYWJsZWQ9bnVsbF0gVGhlIHZpc3VhbCBpbmZvcm1hdGlvbiBhYm91dCB0aGUgZGlzYWJsZWQgc3RhdGUuIElmIG9taXR0ZWQsIHVzZXMgdGhlIHVwIHN0YXRlLgoJKiAgQHBhcmFtIHtjcmVhdGVqcy5SZWN0YW5nbGV9IFtpbWFnZVNldHRpbmdzLmRpc2FibGVkLnNyY10gVGhlIHNvdXJjZVJlY3QgZm9yIHRoZSBzdGF0ZSB3aXRoaW4gdGhlIGltYWdlLgoJKiAgQHBhcmFtIHtjcmVhdGVqcy5SZWN0YW5nbGV9IFtpbWFnZVNldHRpbmdzLmRpc2FibGVkLnRyaW09bnVsbF0gVHJpbSBkYXRhIGFib3V0IHRoZSBzdGF0ZSwgd2hlcmUgeCAmIHkgYXJlIGhvdyBtYW55IHBpeGVscyB3ZXJlIAoJKiAgICAgICAgIHRyaW1tZWQgb2ZmIHRoZSBsZWZ0IGFuZCByaWdodCwgYW5kIGhlaWdodCAmIHdpZHRoIGFyZSB0aGUgdW50cmltbWVkIHNpemUgb2YgdGhlIGJ1dHRvbi4KCSogIEBwYXJhbSB7T2JqZWN0fSBbaW1hZ2VTZXR0aW5ncy5kaXNhYmxlZC5sYWJlbD1udWxsXSBMYWJlbCBpbmZvcm1hdGlvbiBzcGVjaWZpYyB0byB0aGlzIHN0YXRlLiBQcm9wZXJ0aWVzIG9uIHRoaXMgcGFyYW1ldGVyIG92ZXJyaWRlIAoJKiAgICAgICAgIGRhdGEgaW4gdGhlIGxhYmVsIHBhcmFtZXRlciBmb3IgdGhpcyBidXR0b24gc3RhdGUgb25seS4gQWxsIHZhbHVlcyBleGNlcHQgInRleHQiIGZyb20gdGhlIGxhYmVsIHBhcmFtZXRlciBtYXkgYmUgb3ZlcnJpZGRlbi4KCSogIEBwYXJhbSB7T2JqZWN0fSBbaW1hZ2VTZXR0aW5ncy48eW91ckN1c3RvbVN0YXRlPj1udWxsXSBUaGUgdmlzdWFsIGluZm9ybWF0aW9uIGFib3V0IGEgY3VzdG9tIHN0YXRlIGZvdW5kIGluIGltYWdlU2V0dGluZ3MucHJpb3JpdHkuCgkqICAgICAgICAgQW55IHN0YXRlIGFkZGVkIHRoaXMgd2F5IGhhcyBhIHByb3BlcnR5IG9mIHRoZSBzYW1lIG5hbWUgYWRkZWQgdG8gdGhlIGJ1dHRvbi4gRXhhbXBsZXMgb2YgcHJldmlvdXMgc3RhdGVzIHRoYXQgaGF2ZSBiZWVuCgkqICAgICAgICAgbW92ZWQgdG8gdGhpcyBzeXN0ZW0gYXJlICJzZWxlY3RlZCIgYW5kICJoaWdobGlnaHRlZCIuCgkqICBAcGFyYW0ge2NyZWF0ZWpzLlJlY3RhbmdsZX0gW2ltYWdlU2V0dGluZ3MuPHlvdXJDdXN0b21TdGF0ZT4uc3JjXSBUaGUgc291cmNlUmVjdCBmb3IgdGhlIHN0YXRlIHdpdGhpbiB0aGUgaW1hZ2UuCgkqICBAcGFyYW0ge2NyZWF0ZWpzLlJlY3RhbmdsZX0gW2ltYWdlU2V0dGluZ3MuPHlvdXJDdXN0b21TdGF0ZT4udHJpbT1udWxsXSBUcmltIGRhdGEgYWJvdXQgdGhlIHN0YXRlLCB3aGVyZSB4ICYgeSBhcmUgaG93IG1hbnkgcGl4ZWxzIAoJKiAgICAgICAgIHdlcmUgdHJpbW1lZCBvZmYgdGhlIGxlZnQgYW5kIHJpZ2h0LCBhbmQgaGVpZ2h0ICYgd2lkdGggYXJlIHRoZSB1bnRyaW1tZWQgc2l6ZSBvZiB0aGUgYnV0dG9uLgoJKiAgQHBhcmFtIHtPYmplY3R9IFtpbWFnZVNldHRpbmdzLjx5b3VyQ3VzdG9tU3RhdGU+LmxhYmVsPW51bGxdIExhYmVsIGluZm9ybWF0aW9uIHNwZWNpZmljIHRvIHRoaXMgc3RhdGUuIFByb3BlcnRpZXMgb24gdGhpcyBwYXJhbWV0ZXIgCgkqICAgICAgICAgb3ZlcnJpZGUgZGF0YSBpbiB0aGUgbGFiZWwgcGFyYW1ldGVyIGZvciB0aGlzIGJ1dHRvbiBzdGF0ZSBvbmx5LiBBbGwgdmFsdWVzIGV4Y2VwdCAidGV4dCIgZnJvbSB0aGUgbGFiZWwgcGFyYW1ldGVyIG1heSBiZQoJKiAgICAgICAgIG92ZXJyaWRkZW4uCgkqICBAcGFyYW0ge2NyZWF0ZWpzLlBvaW50fSBbaW1hZ2VTZXR0aW5ncy5vcmlnaW49bnVsbF0gQW4gb3B0aW9uYWwgb2Zmc2V0IGZvciBhbGwgYnV0dG9uIGdyYXBoaWNzLCBpbiBjYXNlIHlvdSB3YW50IGJ1dHRvbiAKCSogICAgICAgICBwb3NpdGlvbmluZyB0byBub3QgaW5jbHVkZSBhIGhpZ2hsaWdodCBnbG93LCBvciBhbnkgb3RoZXIgcmVhc29uIHlvdSB3b3VsZCB3YW50IHRvIG9mZnNldCB0aGUgYnV0dG9uIGFydCBhbmQgbGFiZWwuCgkqICBAcGFyYW0ge09iamVjdH0gW2xhYmVsPW51bGxdIEluZm9ybWF0aW9uIGFib3V0IHRoZSB0ZXh0IGxhYmVsIG9uIHRoZSBidXR0b24uIE9taXR0aW5nIHRoaXMgbWFrZXMgdGhlIGJ1dHRvbiBub3QgdXNlIGEgbGFiZWwuCgkqICBAcGFyYW0ge1N0cmluZ30gW2xhYmVsLnRleHRdIFRoZSB0ZXh0IHRvIGRpc3BsYXkgb24gdGhlIGxhYmVsLgoJKiAgQHBhcmFtIHtTdHJpbmd9IFtsYWJlbC5mb250XSBUaGUgZm9udCBuYW1lIGFuZCBzaXplIHRvIHVzZSBvbiB0aGUgbGFiZWwsIGFzIGNyZWF0ZWpzLlRleHQgZXhwZWN0cy4KCSogIEBwYXJhbSB7U3RyaW5nfSBbbGFiZWwuY29sb3JdIFRoZSBjb2xvciBvZiB0aGUgdGV4dCB0byB1c2Ugb24gdGhlIGxhYmVsLCBhcyBjcmVhdGVqcy5UZXh0IGV4cGVjdHMuCgkqICBAcGFyYW0ge1N0cmluZ30gW2xhYmVsLnRleHRCYXNlbGluZT0ibWlkZGxlIl0gVGhlIGJhc2VsaW5lIGZvciB0aGUgbGFiZWwgdGV4dCwgYXMgY3JlYXRlanMuVGV4dCBleHBlY3RzLgoJKiAgQHBhcmFtIHtPYmplY3R9IFtsYWJlbC5zdHJva2U9bnVsbF0gVGhlIHN0cm9rZSB0byB1c2UgZm9yIHRoZSBsYWJlbCB0ZXh0LCBpZiBkZXNpcmVkLCBhcyBjcmVhdGVqcy5UZXh0IChDbG91ZEtpZCBmb3JrIG9ubHkpIGV4cGVjdHMuCgkqICBAcGFyYW0ge2NyZWF0ZWpzLlNoYWRvd30gW2xhYmVsLnNoYWRvdz1udWxsXSBBIHNoYWRvdyBvYmplY3QgdG8gYXBwbHkgdG8gdGhlIGxhYmVsIHRleHQuCgkqICBAcGFyYW0ge1N0cmluZ3xOdW1iZXJ9IFtsYWJlbC54PSJjZW50ZXIiXSBBbiB4IHBvc2l0aW9uIHRvIHBsYWNlIHRoZSBsYWJlbCB0ZXh0IGF0IHJlbGF0aXZlIHRvIHRoZSBidXR0b24uIElmIG9taXR0ZWQsCgkqICAgICAgICAgImNlbnRlciIgaXMgdXNlZCwgd2hpY2ggYXR0ZW1wdHMgdG8gaG9yaXpvbnRhbGx5IGNlbnRlciB0aGUgbGFiZWwgb24gdGhlIGJ1dHRvbi4KCSogIEBwYXJhbSB7U3RyaW5nfE51bWJlcn0gW2xhYmVsLnk9ImNlbnRlciJdIEEgeSBwb3NpdGlvbiB0byBwbGFjZSB0aGUgbGFiZWwgdGV4dCBhdCByZWxhdGl2ZSB0byB0aGUgYnV0dG9uLiBJZiBvbWl0dGVkLAoJKiAgICAgICAgICJjZW50ZXIiIGlzIHVzZWQsIHdoaWNoIGF0dGVtcHRzIHRvIHZlcnRpY2FsbHkgY2VudGVyIHRoZSBsYWJlbCBvbiB0aGUgYnV0dG9uLiBUaGlzIG1heSBiZSB1bnJlbGlhYmxlIC0KCSogICAgICAgICBzZWUgZG9jdW1lbnRhdGlvbiBmb3IgY3JlYXRlanMuVGV4dC5nZXRNZWFzdXJlZExpbmVIZWlnaHQoKS4KCSogIEBwYXJhbSB7Qm9vbGVhbn0gW2VuYWJsZWQ9dHJ1ZV0gV2hldGhlciBvciBub3QgdGhlIGJ1dHRvbiBpcyBpbml0aWFsbHkgZW5hYmxlZC4KCSovCgl2YXIgQnV0dG9uID0gZnVuY3Rpb24oaW1hZ2VTZXR0aW5ncywgbGFiZWwsIGVuYWJsZWQpCgl7CgkJaWYoIWltYWdlU2V0dGluZ3MpIHJldHVybjsKCQl0aGlzLmluaXRpYWxpemUoaW1hZ2VTZXR0aW5ncywgbGFiZWwsIGVuYWJsZWQpOwoJfTsKCQoJLy8gRXh0ZW5kIENvbnRhaW5lcgoJdmFyIHAgPSBCdXR0b24ucHJvdG90eXBlID0gbmV3IGNyZWF0ZWpzLkNvbnRhaW5lcigpOwoJCgl2YXIgcyA9IGNyZWF0ZWpzLkNvbnRhaW5lci5wcm90b3R5cGU7Ly9zdXBlcgoJCgkvKioKCSogIFRoZSBzcHJpdGUgdGhhdCBpcyB0aGUgYm9keSBvZiB0aGUgYnV0dG9uLgoJKiAgVGhlIHR5cGUgb2YgdGhpcyBwcm9wZXJ0eSBpcyBkZXBlbmRlbnQgb24gd2hpY2ggdmVyc2lvbiBvZiB0aGUgT1MgbGlicmFyeSBpcyB1c2VkLgoJKiAgQHB1YmxpYwoJKiAgQHByb3BlcnR5IHtjcmVhdGVqcy5CaXRtYXB9IGJhY2sKCSogIEByZWFkT25seQoJKi8KCXAuYmFjayA9IG51bGw7CgoJLyoqCgkqICBUaGUgdGV4dCBmaWVsZCBvZiB0aGUgYnV0dG9uLiBUaGUgbGFiZWwgaXMgY2VudGVyZWQgYnkgYm90aCB3aWR0aCBhbmQgaGVpZ2h0IG9uIHRoZSBidXR0b24uCgkqICBUaGUgdHlwZSBvZiB0aGlzIHByb3BlcnR5IGlzIGRlcGVuZGVudCBvbiB3aGljaCB2ZXJzaW9uIG9mIHRoZSBPUyBsaWJyYXJ5IGlzIHVzZWQuCgkqICBAcHVibGljCgkqICBAcHJvcGVydHkge2NyZWF0ZWpzLlRleHR9IGxhYmVsCgkqICBAcmVhZE9ubHkKCSovCglwLmxhYmVsID0gbnVsbDsKCQoJLy89PT1jYWxsYmFja3MgZm9yIG1vdXNlL3RvdWNoIGV2ZW50cwoJLyoqCgkqIENhbGxiYWNrIGZvciBtb3VzZSBvdmVyLCBib3VuZCB0byB0aGlzIGJ1dHRvbi4KCSogQHByaXZhdGUKCSogQHByb3BlcnR5IHtGdW5jdGlvbn0gX292ZXJDQgoJKi8KCXAuX292ZXJDQiA9IG51bGw7CgoJLyoqCgkqIENhbGxiYWNrIGZvciBtb3VzZSBvdXQsIGJvdW5kIHRvIHRoaXMgYnV0dG9uLgoJKiBAcHJpdmF0ZQoJKiBAcHJvcGVydHkge0Z1bmN0aW9ufSBfb3V0Q0IKCSovCglwLl9vdXRDQiA9IG51bGw7CgoJLyoqCgkqIENhbGxiYWNrIGZvciBtb3VzZSBkb3duLCBib3VuZCB0byB0aGlzIGJ1dHRvbi4KCSogQHByaXZhdGUKCSogQHByb3BlcnR5IHtGdW5jdGlvbn0gX2Rvd25DQgoJKi8KCXAuX2Rvd25DQiA9IG51bGw7CgoJLyoqCgkqIENhbGxiYWNrIGZvciBwcmVzcyB1cCwgYm91bmQgdG8gdGhpcyBidXR0b24uCgkqIEBwcml2YXRlCgkqIEBwcm9wZXJ0eSB7RnVuY3Rpb259IF91cENCCgkqLwoJcC5fdXBDQiA9IG51bGw7CgoJLyoqCgkqIENhbGxiYWNrIGZvciBjbGljaywgYm91bmQgdG8gdGhpcyBidXR0b24uCgkqIEBwcml2YXRlCgkqIEBwcm9wZXJ0eSB7RnVuY3Rpb259IF9jbGlja0NCCgkqLwoJcC5fY2xpY2tDQiA9IG51bGw7CgkKCS8qKgoJKiBBIGRpY3Rpb25hcnkgb2Ygc3RhdGUgYm9vbGVhbnMsIGtleWVkIGJ5IHN0YXRlIG5hbWUuCgkqIEBwcml2YXRlCgkqIEBwcm9wZXJ0eSB7T2JqZWN0fSBfc3RhdGVGbGFncwoJKi8KCXAuX3N0YXRlRmxhZ3MgPSBudWxsOwoJLyoqCgkqIEFuIGFycmF5IG9mIHN0YXRlIG5hbWVzIChTdHJpbmdzKSwgaW4gdGhlaXIgb3JkZXIgb2YgcHJpb3JpdHkuCgkqIFRoZSBzdGFuZGFyZCBvcmRlciBwcmV2aW91c2x5IHdhcyBbImhpZ2hsaWdodGVkIiwgImRpc2FibGVkIiwgImRvd24iLCAib3ZlciIsICJzZWxlY3RlZCIsICJ1cCJdLgoJKiBAcHJpdmF0ZQoJKiBAcHJvcGVydHkge0FycmF5fSBfc3RhdGVQcmlvcml0eQoJKi8KCXAuX3N0YXRlUHJpb3JpdHkgPSBudWxsOwoJCgkvKioKCSogQSBkaWN0aW9uYXJ5IG9mIHN0YXRlIGdyYXBoaWMgZGF0YSwga2V5ZWQgYnkgc3RhdGUgbmFtZS4KCSogRWFjaCBvYmplY3QgY29udGFpbnMgdGhlIHNvdXJjZVJlY3QgKHNyYykgYW5kIG9wdGlvbmFsbHkgJ3RyaW0nLCBhbm90aGVyIFJlY3RhbmdsZS4KCSogQWRkaXRpb25hbGx5LCBlYWNoIG9iamVjdCB3aWxsIGNvbnRhaW4gYSAnbGFiZWwnIG9iamVjdCBpZiB0aGUgYnV0dG9uIGhhcyBhIHRleHQgbGFiZWwuCgkqIEBwcml2YXRlCgkqIEBwcm9wZXJ0eSB7T2JqZWN0fSBfc3RhdGVEYXRhCgkqLwoJcC5fc3RhdGVEYXRhID0gbnVsbDsKCgkvKioKCSogVGhlIHdpZHRoIG9mIHRoZSBidXR0b24gYXJ0LCBpbmRlcGVuZGVudCBvZiB0aGUgc2NhbGluZyBvZiB0aGUgYnV0dG9uIGl0c2VsZi4KCSogQHByaXZhdGUKCSogQHByb3BlcnR5IHtOdW1iZXJ9IF93aWR0aAoJKi8KCXAuX3dpZHRoID0gMDsKCgkvKioKCSogVGhlIGhlaWdodCBvZiB0aGUgYnV0dG9uIGFydCwgaW5kZXBlbmRlbnQgb2YgdGhlIHNjYWxpbmcgb2YgdGhlIGJ1dHRvbiBpdHNlbGYuCgkqIEBwcml2YXRlCgkqIEBwcm9wZXJ0eSB7TnVtYmVyfSBfaGVpZ2h0CgkqLwoJcC5faGVpZ2h0ID0gMDsKCgkvKioKCSogQW4gb2Zmc2V0IHRvIGJ1dHRvbiBwb3NpdGlvbmluZywgZ2VuZXJhbGx5IHVzZWQgdG8gYWRqdXN0IGZvciBhIGhpZ2hsaWdodCBhcm91bmQgdGhlIGJ1dHRvbi4KCSogQHByaXZhdGUKCSogQHByb3BlcnR5IHtjcmVhdGVqcy5Qb2ludH0gX29mZnNldAoJKi8KCXAuX29mZnNldCA9IG51bGw7CgkKCS8qKgoJKiBBbiBldmVudCBmb3Igd2hlbiB0aGUgYnV0dG9uIGlzIHByZXNzZWQgKHdoaWxlIGVuYWJsZWQpLgoJKiBAcHVibGljCgkqIEBzdGF0aWMKCSogQHByb3BlcnR5IHtTdHJpbmd9IEJVVFRPTl9QUkVTUwoJKi8KCUJ1dHRvbi5CVVRUT05fUFJFU1MgPSAiYnV0dG9uUHJlc3MiOwoJCgkvKgoJKiBBIGxpc3Qgb2Ygc3RhdGUgbmFtZXMgdGhhdCBzaG91bGQgbm90IGhhdmUgcHJvcGVydGllcyBhdXRvZ2VuZXJhdGVkLgoJKiBAcHJpdmF0ZQoJKiBAc3RhdGljCgkqIEBwcm9wZXJ0eSB7QXJyYXl9IFJFU0VSVkVEX1NUQVRFUwoJKi8KCXZhciBSRVNFUlZFRF9TVEFURVMgPSBbImRpc2FibGVkIiwgImVuYWJsZWQiLCAidXAiLCAib3ZlciIsICJkb3duIl07CgkvKgoJKiBBIHN0YXRlIHByaW9yaXR5IGxpc3QgdG8gdXNlIGFzIHRoZSBkZWZhdWx0LgoJKiBAcHJpdmF0ZQoJKiBAc3RhdGljCgkqIEBwcm9wZXJ0eSB7QXJyYXl9IERFRkFVTFRfUFJJT1JJVFkKCSovCgl2YXIgREVGQVVMVF9QUklPUklUWSA9IFsiZGlzYWJsZWQiLCAiZG93biIsICJvdmVyIiwgInVwIl07CgkKCS8qKiAKCSogIENvbnN0cnVjdG9yIGZvciB0aGUgYnV0dG9uIHdoZW4gdXNpbmcgQ3JlYXRlSlMuCgkqICBAbWV0aG9kIGluaXRpYWxpemUKCSogIEBwYXJhbSB7T2JqZWN0fEltYWdlfEhUTUxDYW52YXNFbGVtZW50fSBbaW1hZ2VTZXR0aW5nc10gU2VlIHRoZSBjb25zdHJ1Y3RvciBmb3IgbW9yZSBpbmZvcm1hdGlvbgoJKiAgQHBhcmFtIHtPYmplY3R9IFtsYWJlbD1udWxsXSBJbmZvcm1hdGlvbiBhYm91dCB0aGUgdGV4dCBsYWJlbCBvbiB0aGUgYnV0dG9uLiBPbWl0dGluZyB0aGlzIG1ha2VzIHRoZSBidXR0b24gbm90IHVzZSBhIGxhYmVsLgoJKiAgQHBhcmFtIHtCb29sZWFufSBbZW5hYmxlZD10cnVlXSBXaGV0aGVyIG9yIG5vdCB0aGUgYnV0dG9uIGlzIGluaXRpYWxseSBlbmFibGVkLgoJKi8KCXAuaW5pdGlhbGl6ZSA9IGZ1bmN0aW9uKGltYWdlU2V0dGluZ3MsIGxhYmVsLCBlbmFibGVkKQoJewoJCXMuaW5pdGlhbGl6ZS5jYWxsKHRoaXMpOwoKCQl0aGlzLm1vdXNlQ2hpbGRyZW4gPSBmYWxzZTsvL2lucHV0IGV2ZW50cyBzaG91bGQgaGF2ZSB0aGlzIGJ1dHRvbiBhcyBhIHRhcmdldCwgbm90IHRoZSBjaGlsZCBCaXRtYXAuCgkJCgkJdGhpcy5fZG93bkNCID0gdGhpcy5fb25Nb3VzZURvd24uYmluZCh0aGlzKTsKCQl0aGlzLl91cENCID0gdGhpcy5fb25Nb3VzZVVwLmJpbmQodGhpcyk7CgkJdGhpcy5fb3ZlckNCID0gdGhpcy5fb25Nb3VzZU92ZXIuYmluZCh0aGlzKTsKCQl0aGlzLl9vdXRDQiA9IHRoaXMuX29uTW91c2VPdXQuYmluZCh0aGlzKTsKCQl0aGlzLl9jbGlja0NCID0gdGhpcy5fb25DbGljay5iaW5kKHRoaXMpOwoJCQoJCXZhciBfc3RhdGVEYXRhID0gdGhpcy5fc3RhdGVEYXRhID0ge307CgkJdGhpcy5fc3RhdGVGbGFncyA9IHt9OwoJCXRoaXMuX29mZnNldCA9IG5ldyBjcmVhdGVqcy5Qb2ludCgpOwoJCQoJCS8vYSBjbG9uZSBvZiB0aGUgbGFiZWwgZGF0YSB0byB1c2UgYXMgYSBkZWZhdWx0IHZhbHVlLCB3aXRob3V0IGNoYW5naW5nIHRoZSBvcmlnaW5hbAoJCXZhciBsYWJlbERhdGE7CgkJaWYobGFiZWwpCgkJewoJCQlsYWJlbERhdGEgPSBjbG9uZShsYWJlbCk7CgkJCWRlbGV0ZSBsYWJlbERhdGEudGV4dDsKCQkJaWYobGFiZWxEYXRhLnggPT09IHVuZGVmaW5lZCkKCQkJCWxhYmVsRGF0YS54ID0gImNlbnRlciI7CgkJCWlmKGxhYmVsRGF0YS55ID09PSB1bmRlZmluZWQpCgkJCQlsYWJlbERhdGEueSA9ICJjZW50ZXIiOwoJCX0KCQkKCQl2YXIgaW1hZ2UsIHdpZHRoLCBoZWlnaHQsIGksIHN0YXRlOwoJCWlmKGltYWdlU2V0dGluZ3MuaW1hZ2UpLy9pcyBhIHNldHRpbmdzIG9iamVjdCB3aXRoIHJlY3RhbmdsZXMKCQl7CgkJCWltYWdlID0gaW1hZ2VTZXR0aW5ncy5pbWFnZTsKCQkJdGhpcy5fc3RhdGVQcmlvcml0eSA9IGltYWdlU2V0dGluZ3MucHJpb3JpdHkgfHwgREVGQVVMVF9QUklPUklUWTsKCQkJLy9lYWNoIHJlY3RzIG9iamVjdCBoYXMgYSBzcmMgcHJvcGVydHkgKGNyZWF0ZWpzLlJlY3RhbmdsZSksIGFuZCBvcHRpb25hbGx5IGEgdHJpbSByZWN0YW5nbGUKCQkJZm9yKGkgPSB0aGlzLl9zdGF0ZVByaW9yaXR5Lmxlbmd0aCAtIDE7IGkgPj0gMDsgLS1pKS8vc3RhcnQgYXQgdGhlIGVuZCB0byBzdGFydCBhdCB0aGUgdXAgc3RhdGUKCQkJewoJCQkJc3RhdGUgPSB0aGlzLl9zdGF0ZVByaW9yaXR5W2ldOwoJCQkJLy9zZXQgdXAgdGhlIHByb3BlcnR5IGZvciB0aGUgc3RhdGUgc28gaXQgY2FuIGJlIHNldCAtIHRoZSBmdW5jdGlvbiB3aWxsIGlnbm9yZSByZXNlcnZlZCBzdGF0ZXMKCQkJCXRoaXMuX2FkZFByb3BlcnR5KHN0YXRlKTsKCQkJCS8vc2V0IHRoZSBkZWZhdWx0IHZhbHVlIGZvciB0aGUgc3RhdGUgZmxhZwoJCQkJaWYoc3RhdGUgIT0gImRpc2FibGVkIiAmJiBzdGF0ZSAhPSAidXAiKQoJCQkJCXRoaXMuX3N0YXRlRmxhZ3Nbc3RhdGVdID0gZmFsc2U7CgkJCQl2YXIgaW5wdXREYXRhID0gaW1hZ2VTZXR0aW5nc1tzdGF0ZV07CgkJCQkvL2l0J3MgZXN0YWJsaXNoZWQgdGhhdCBvdmVyLCBkb3duLCBhbmQgcGFydGljdWxhcmx5IGRpc2FibGVkIGRlZmF1bHQgdG8gdGhlIHVwIHN0YXRlCgkJCQlfc3RhdGVEYXRhW3N0YXRlXSA9IGlucHV0RGF0YSA/IGNsb25lKGlucHV0RGF0YSkgOiBfc3RhdGVEYXRhLnVwOwoJCQkJLy9zZXQgdXAgdGhlIGxhYmVsIGluZm8gZm9yIHRoaXMgc3RhdGUKCQkJCWlmKGxhYmVsKQoJCQkJewoJCQkJCS8vaWYgdGhlcmUgaXMgYWN0dWFsIGxhYmVsIGRhdGEgZm9yIHRoaXMgc3RhdGUsIHVzZSB0aGF0CgkJCQkJaWYoaW5wdXREYXRhICYmIGlucHV0RGF0YS5sYWJlbCkKCQkJCQl7CgkJCQkJCWlucHV0RGF0YSA9IGlucHV0RGF0YS5sYWJlbDsKCQkJCQkJdmFyIHN0YXRlTGFiZWwgPSBfc3RhdGVEYXRhW3N0YXRlXS5sYWJlbCA9IHt9OwoJCQkJCQlzdGF0ZUxhYmVsLmZvbnQgPSBpbnB1dERhdGEuZm9udCB8fCBsYWJlbERhdGEuZm9udDsKCQkJCQkJc3RhdGVMYWJlbC5jb2xvciA9IGlucHV0RGF0YS5jb2xvciB8fCBsYWJlbERhdGEuY29sb3I7CgkJCQkJCXN0YXRlTGFiZWwuc3Ryb2tlID0gaW5wdXREYXRhLmhhc093blByb3BlcnR5KCJzdHJva2UiKSA/IGlucHV0RGF0YS5zdHJva2UgOiBsYWJlbERhdGEuc3Ryb2tlOwoJCQkJCQlzdGF0ZUxhYmVsLnNoYWRvdyA9IGlucHV0RGF0YS5oYXNPd25Qcm9wZXJ0eSgic2hhZG93IikgPyBpbnB1dERhdGEuc2hhZG93IDogbGFiZWxEYXRhLnNoYWRvdzsKCQkJCQkJc3RhdGVMYWJlbC50ZXh0QmFzZWxpbmUgPSBpbnB1dERhdGEudGV4dEJhc2VsaW5lIHx8IGxhYmVsRGF0YS50ZXh0QmFzZWxpbmU7CgkJCQkJCXN0YXRlTGFiZWwueCA9IGlucHV0RGF0YS54IHx8IGxhYmVsRGF0YS54OwoJCQkJCQlzdGF0ZUxhYmVsLnkgPSBpbnB1dERhdGEueSB8fCBsYWJlbERhdGEueTsKCQkJCQl9CgkJCQkJLy9vdGhlcndpc2UgdXNlIHRoZSBkZWZhdWx0CgkJCQkJZWxzZQoJCQkJCQlfc3RhdGVEYXRhW3N0YXRlXS5sYWJlbCA9IGxhYmVsRGF0YTsKCQkJCX0KCQkJfQoJCQlpZihfc3RhdGVEYXRhLnVwLnRyaW0pLy9pZiB0aGUgdGV4dHVyZSBpcyB0cmltbWVkLCB1c2UgdGhhdCBmb3IgdGhlIHNpemluZwoJCQl7CgkJCQl2YXIgdXBUcmltID0gX3N0YXRlRGF0YS51cC50cmltOwoJCQkJd2lkdGggPSB1cFRyaW0ud2lkdGg7CgkJCQloZWlnaHQgPSB1cFRyaW0uaGVpZ2h0OwoJCQl9CgkJCWVsc2UvL3RleHR1cmUgaXMgbm90IHRyaW1tZWQgYW5kIGlzIGZ1bGwgc2l6ZQoJCQl7CgkJCQl3aWR0aCA9IF9zdGF0ZURhdGEudXAuc3JjLndpZHRoOwoJCQkJaGVpZ2h0ID0gX3N0YXRlRGF0YS51cC5zcmMuaGVpZ2h0OwoJCQl9CgkJCS8vZW5zdXJlIHRoYXQgb3VyIHJlcXVpcmVkIHN0YXRlcyBleGlzdAoJCQlpZighX3N0YXRlRGF0YS51cCkKCQkJewoJCQkJRGVidWcuZXJyb3IoIkJ1dHRvbiBsYWNrcyBhbiB1cCBzdGF0ZSEgVGhpcyBpcyBhIHNlcmlvdXMgcHJvYmxlbSEgSW5wdXQgZGF0YSBmb2xsb3dzOiIpOwoJCQkJRGVidWcuZXJyb3IoaW1hZ2VTZXR0aW5ncyk7CgkJCX0KCQkJaWYoIV9zdGF0ZURhdGEub3ZlcikKCQkJCV9zdGF0ZURhdGEub3ZlciA9IF9zdGF0ZURhdGEudXA7CgkJCWlmKCFfc3RhdGVEYXRhLmRvd24pCgkJCQlfc3RhdGVEYXRhLmRvd24gPSBfc3RhdGVEYXRhLnVwOwoJCQlpZighX3N0YXRlRGF0YS5kaXNhYmxlZCkKCQkJCV9zdGF0ZURhdGEuZGlzYWJsZWQgPSBfc3RhdGVEYXRhLnVwOwoJCQkvL3NldCB1cCB0aGUgb2Zmc2V0CgkJCWlmKGltYWdlU2V0dGluZ3Mub2Zmc2V0KQoJCQl7CgkJCQl0aGlzLl9vZmZzZXQueCA9IGltYWdlU2V0dGluZ3Mub2Zmc2V0Lng7CgkJCQl0aGlzLl9vZmZzZXQueSA9IGltYWdlU2V0dGluZ3Mub2Zmc2V0Lnk7CgkJCX0KCQkJZWxzZQoJCQl7CgkJCQl0aGlzLl9vZmZzZXQueCA9IHRoaXMuX29mZnNldC55ID0gMDsKCQkJfQoJCX0KCQllbHNlLy9pbWFnZVNldHRpbmdzIGlzIGp1c3QgYW4gaW1hZ2UgdG8gdXNlIGRpcmVjdGx5IC0gdXNlIHRoZSBvbGQgc3RhY2tlZCBpbWFnZXMgbWV0aG9kCgkJewoJCQlpbWFnZSA9IGltYWdlU2V0dGluZ3M7CgkJCXdpZHRoID0gaW1hZ2Uud2lkdGg7CgkJCWhlaWdodCA9IGltYWdlLmhlaWdodCAvIDM7CgkJCXRoaXMuX3N0YXRlUHJpb3JpdHkgPSBERUZBVUxUX1BSSU9SSVRZOwoJCQlfc3RhdGVEYXRhLmRpc2FibGVkID0gX3N0YXRlRGF0YS51cCA9IHtzcmM6bmV3IGNyZWF0ZWpzLlJlY3RhbmdsZSgwLCAwLCB3aWR0aCwgaGVpZ2h0KX07CgkJCV9zdGF0ZURhdGEub3ZlciA9IHtzcmM6bmV3IGNyZWF0ZWpzLlJlY3RhbmdsZSgwLCBoZWlnaHQsIHdpZHRoLCBoZWlnaHQpfTsKCQkJX3N0YXRlRGF0YS5kb3duID0ge3NyYzpuZXcgY3JlYXRlanMuUmVjdGFuZ2xlKDAsIGhlaWdodCAqIDIsIHdpZHRoLCBoZWlnaHQpfTsKCQkJaWYobGFiZWxEYXRhKQoJCQl7CgkJCQlfc3RhdGVEYXRhLnVwLmxhYmVsID0gCgkJCQlfc3RhdGVEYXRhLm92ZXIubGFiZWwgPSAKCQkJCV9zdGF0ZURhdGEuZG93bi5sYWJlbCA9IAoJCQkJX3N0YXRlRGF0YS5kaXNhYmxlZC5sYWJlbCA9IGxhYmVsRGF0YTsKCQkJfQoJCQl0aGlzLl9vZmZzZXQueCA9IHRoaXMuX29mZnNldC55ID0gMDsKCQl9CgkJCgkJdGhpcy5iYWNrID0gbmV3IGNyZWF0ZWpzLkJpdG1hcChpbWFnZSk7CgkJdGhpcy5hZGRDaGlsZCh0aGlzLmJhY2spOwoJCXRoaXMuX3dpZHRoID0gd2lkdGg7CgkJdGhpcy5faGVpZ2h0ID0gaGVpZ2h0OwoJCQoJCWlmKGxhYmVsKQoJCXsKCQkJdGhpcy5sYWJlbCA9IG5ldyBjcmVhdGVqcy5UZXh0KGxhYmVsLnRleHQgfHwgIiIsIF9zdGF0ZURhdGEudXAubGFiZWwuZm9udCwgX3N0YXRlRGF0YS51cC5sYWJlbC5jb2xvcik7CgkJCXRoaXMuYWRkQ2hpbGQodGhpcy5sYWJlbCk7CgkJfQoJCQoJCS8vc2V0IHRoZSBidXR0b24gc3RhdGUgaW5pdGlhbGx5CgkJdGhpcy5lbmFibGVkID0gZW5hYmxlZCA9PT0gdW5kZWZpbmVkID8gdHJ1ZSA6ICEhZW5hYmxlZDsKCX07CgkKCS8qCgkqICBBIHNpbXBsZSBmdW5jdGlvbiBmb3IgbWFraW5nIGEgc2hhbGxvdyBjb3B5IG9mIGFuIG9iamVjdC4KCSovCglmdW5jdGlvbiBjbG9uZShvYmopCgl7CgkJaWYgKCFvYmogfHwgIm9iamVjdCIgIT0gdHlwZW9mIG9iaikgcmV0dXJuIG51bGw7CgkJdmFyIGNvcHkgPSBvYmouY29uc3RydWN0b3IoKTsKCQlmb3IgKHZhciBhdHRyIGluIG9iaikgewoJCQlpZiAob2JqLmhhc093blByb3BlcnR5KGF0dHIpKSBjb3B5W2F0dHJdID0gb2JqW2F0dHJdOwoJCX0KCQlyZXR1cm4gY29weTsKCX0KCQoJLyoqCgkqICBUaGUgd2lkdGggb2YgdGhlIGJ1dHRvbiwgYmFzZWQgb24gdGhlIHdpZHRoIG9mIGJhY2suIFRoaXMgdmFsdWUgaXMgYWZmZWN0ZWQgYnkgc2NhbGUuCgkqICBAcHJvcGVydHkge051bWJlcn0gd2lkdGgKCSovCglPYmplY3QuZGVmaW5lUHJvcGVydHkocCwgIndpZHRoIiwgewoJCWdldDpmdW5jdGlvbigpe3JldHVybiB0aGlzLl93aWR0aCAqIHRoaXMuc2NhbGVYO30sCgkJc2V0OmZ1bmN0aW9uKHZhbHVlKXsKCQkJdGhpcy5zY2FsZVggPSB2YWx1ZSAvIHRoaXMuX3dpZHRoOwoJCX0KCX0pOwoKCS8qKgoJKiAgVGhlIGhlaWdodCBvZiB0aGUgYnV0dG9uLCBiYXNlZCBvbiB0aGUgaGVpZ2h0IG9mIGJhY2suIFRoaXMgdmFsdWUgaXMgYWZmZWN0ZWQgYnkgc2NhbGUuCgkqICBAcHJvcGVydHkge051bWJlcn0gaGVpZ2h0CgkqLwoJT2JqZWN0LmRlZmluZVByb3BlcnR5KHAsICJoZWlnaHQiLCB7CgkJZ2V0OmZ1bmN0aW9uKCl7cmV0dXJuIHRoaXMuX2hlaWdodCAqIHRoaXMuc2NhbGVZO30sCgkJc2V0OmZ1bmN0aW9uKHZhbHVlKXsKCQkJdGhpcy5zY2FsZVkgPSB2YWx1ZSAvIHRoaXMuX2hlaWdodDsKCQl9Cgl9KTsKCQoJLyoqCgkqICBTZXRzIHRoZSB0ZXh0IG9mIHRoZSBsYWJlbC4gVGhpcyBkb2VzIG5vdGhpbmcgaWYgdGhlIGJ1dHRvbiB3YXMgbm90IGluaXRpYWxpemVkIHdpdGggYSBsYWJlbC4KCSogIEBwdWJsaWMKCSogIEBtZXRob2Qgc2V0VGV4dAoJKiAgQHBhcmFtIHtTdHJpbmd9IHRleHQgVGhlIHRleHQgdG8gc2V0IHRoZSBsYWJlbCB0by4KCSovCglwLnNldFRleHQgPSBmdW5jdGlvbih0ZXh0KQoJewoJCWlmKHRoaXMubGFiZWwpCgkJewoJCQl0aGlzLmxhYmVsLnRleHQgPSB0ZXh0OwoJCQl2YXIgZGF0YTsKCQkJZm9yKHZhciBpID0gMDsgaSA8IHRoaXMuX3N0YXRlUHJpb3JpdHkubGVuZ3RoOyArK2kpCgkJCXsKCQkJCWlmKHRoaXMuX3N0YXRlRmxhZ3NbdGhpcy5fc3RhdGVQcmlvcml0eVtpXV0pCgkJCQl7CgkJCQkJZGF0YSA9IHRoaXMuX3N0YXRlRGF0YVt0aGlzLl9zdGF0ZVByaW9yaXR5W2ldXTsKCQkJCQlicmVhazsKCQkJCX0KCQkJfQoJCQlpZighZGF0YSkKCQkJCWRhdGEgPSB0aGlzLl9zdGF0ZURhdGEudXA7CgkJCWRhdGEgPSBkYXRhLmxhYmVsOwoJCQlpZihkYXRhLnggPT0gImNlbnRlciIpCgkJCQl0aGlzLmxhYmVsLnggPSAodGhpcy5fd2lkdGggLSB0aGlzLmxhYmVsLmdldE1lYXN1cmVkV2lkdGgoKSkgKiAwLjUgKyB0aGlzLl9vZmZzZXQueDsKCQkJZWxzZQoJCQkJdGhpcy5sYWJlbC54ID0gZGF0YS54ICsgdGhpcy5fb2Zmc2V0Lng7CgkJCWlmKGRhdGEueSA9PSAiY2VudGVyIikKCQkJCXRoaXMubGFiZWwueSA9IHRoaXMuX2hlaWdodCAqIDAuNSArIHRoaXMuX29mZnNldC55OwoJCQllbHNlCgkJCQl0aGlzLmxhYmVsLnkgPSBkYXRhLnkgKyB0aGlzLl9vZmZzZXQueTsKCQl9Cgl9OwoJCgkvKioKCSogIFdoZXRoZXIgb3Igbm90IHRoZSBidXR0b24gaXMgZW5hYmxlZC4KCSogIEBwcm9wZXJ0eSB7Qm9vbGVhbn0gZW5hYmxlZAoJKiAgQGRlZmF1bHQgdHJ1ZQoJKi8KCU9iamVjdC5kZWZpbmVQcm9wZXJ0eShwLCAiZW5hYmxlZCIsIHsKCQlnZXQ6IGZ1bmN0aW9uKCkgeyByZXR1cm4gIXRoaXMuX3N0YXRlRmxhZ3MuZGlzYWJsZWQ7IH0sCgkJc2V0OiBmdW5jdGlvbih2YWx1ZSkKCQl7CgkJCXRoaXMuX3N0YXRlRmxhZ3MuZGlzYWJsZWQgPSAhdmFsdWU7CgkJCQoJCQlpZih2YWx1ZSkKCQkJewoJCQkJdGhpcy5jdXJzb3IgPSAncG9pbnRlcic7CgkJCQl0aGlzLmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlZG93bicsIHRoaXMuX2Rvd25DQik7CgkJCQl0aGlzLmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlb3ZlcicsIHRoaXMuX292ZXJDQik7CgkJCQl0aGlzLmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlb3V0JywgdGhpcy5fb3V0Q0IpOwoJCQl9CgkJCWVsc2UKCQkJewoJCQkJdGhpcy5jdXJzb3IgPSBudWxsOwoJCQkJdGhpcy5yZW1vdmVFdmVudExpc3RlbmVyKCdtb3VzZWRvd24nLCB0aGlzLl9kb3duQ0IpOwoJCQkJdGhpcy5yZW1vdmVFdmVudExpc3RlbmVyKCdtb3VzZW92ZXInLCB0aGlzLl9vdmVyQ0IpOwoJCQkJdGhpcy5yZW1vdmVFdmVudExpc3RlbmVyKCdtb3VzZW91dCcsIHRoaXMuX291dENCKTsKCQkJCXRoaXMucmVtb3ZlRXZlbnRMaXN0ZW5lcigncHJlc3N1cCcsIHRoaXMuX3VwQ0IpOwoJCQkJdGhpcy5yZW1vdmVFdmVudExpc3RlbmVyKCJjbGljayIsIHRoaXMuX2NsaWNrQ0IpOwoJCQkJdGhpcy5fc3RhdGVGbGFncy5kb3duID0gdGhpcy5fc3RhdGVGbGFncy5vdmVyID0gZmFsc2U7CgkJCX0KCQkJCgkJCXRoaXMuX3VwZGF0ZVN0YXRlKCk7CgkJfQoJfSk7CgkKCS8qKgoJKiAgQWRkcyBhIHByb3BlcnR5IHRvIHRoZSBidXR0b24uIFNldHRpbmcgdGhlIHByb3BlcnR5IHNldHMgdGhlIHZhbHVlIGluCgkqICBfc3RhdGVGbGFncyBhbmQgY2FsbHMgX3VwZGF0ZVN0YXRlKCkuCgkqICBAcHJpdmF0ZQoJKiAgQG1ldGhvZCBfYWRkUHJvcGVydHkKCSogIEBwYXJhbSB7U3RyaW5nfSBwcm9wZXJ0eU5hbWUgVGhlIHByb3BlcnR5IG5hbWUgdG8gYWRkIHRvIHRoZSBidXR0b24uCgkqLwoJcC5fYWRkUHJvcGVydHkgPSBmdW5jdGlvbihwcm9wZXJ0eU5hbWUpCgl7CgkJLy9jaGVjayB0byBtYWtlIHN1cmUgd2UgZG9uJ3QgYWRkIHJlc2VydmVkIG5hbWVzCgkJaWYoUkVTRVJWRURfU1RBVEVTLmluZGV4T2YocHJvcGVydHlOYW1lKSA+PSAwKSByZXR1cm47CgkJCgkJT2JqZWN0LmRlZmluZVByb3BlcnR5KHRoaXMsIHByb3BlcnR5TmFtZSwgewoJCQlnZXQ6IGZ1bmN0aW9uKCkgeyByZXR1cm4gdGhpcy5fc3RhdGVGbGFnc1twcm9wZXJ0eU5hbWVdOyB9LAoJCQlzZXQ6IGZ1bmN0aW9uKHZhbHVlKQoJCQl7CgkJCQl0aGlzLl9zdGF0ZUZsYWdzW3Byb3BlcnR5TmFtZV0gPSB2YWx1ZTsKCQkJCXRoaXMuX3VwZGF0ZVN0YXRlKCk7CgkJCX0KCQl9KTsKCX07CgkKCS8qKgoJKiAgVXBkYXRlcyBiYWNrIGJhc2VkIG9uIHRoZSBjdXJyZW50IGJ1dHRvbiBzdGF0ZS4KCSogIEBwcml2YXRlCgkqICBAbWV0aG9kIF91cGRhdGVTdGF0ZQoJKi8KCXAuX3VwZGF0ZVN0YXRlID0gZnVuY3Rpb24oKQoJewoJCWlmKCF0aGlzLmJhY2spIHJldHVybjsKCQl2YXIgZGF0YTsKCQkvL3VzZSB0aGUgaGlnaGVzdCBwcmlvcml0eSBzdGF0ZQoJCWZvcih2YXIgaSA9IDA7IGkgPCB0aGlzLl9zdGF0ZVByaW9yaXR5Lmxlbmd0aDsgKytpKQoJCXsKCQkJaWYodGhpcy5fc3RhdGVGbGFnc1t0aGlzLl9zdGF0ZVByaW9yaXR5W2ldXSkKCQkJewoJCQkJZGF0YSA9IHRoaXMuX3N0YXRlRGF0YVt0aGlzLl9zdGF0ZVByaW9yaXR5W2ldXTsKCQkJCWJyZWFrOwoJCQl9CgkJfQoJCS8vaWYgbm8gc3RhdGUgaXMgYWN0aXZlLCB1c2UgdGhlIHVwIHN0YXRlCgkJaWYoIWRhdGEpCgkJCWRhdGEgPSB0aGlzLl9zdGF0ZURhdGEudXA7CgkJdGhpcy5iYWNrLnNvdXJjZVJlY3QgPSBkYXRhLnNyYzsKCQkvL3Bvc2l0aW9uIHRoZSBidXR0b24gYmFjawoJCWlmKGRhdGEudHJpbSkKCQl7CgkJCXRoaXMuYmFjay54ID0gZGF0YS50cmltLnggKyB0aGlzLl9vZmZzZXQueDsKCQkJdGhpcy5iYWNrLnkgPSBkYXRhLnRyaW0ueSArIHRoaXMuX29mZnNldC55OwoJCX0KCQllbHNlCgkJewoJCQl0aGlzLmJhY2sueCA9IHRoaXMuX29mZnNldC54OwoJCQl0aGlzLmJhY2sueSA9IHRoaXMuX29mZnNldC55OwoJCX0KCQkvL2lmIHdlIGhhdmUgYSBsYWJlbCwgdXBkYXRlIHRoYXQgdG9vCgkJaWYodGhpcy5sYWJlbCkKCQl7CgkJCWRhdGEgPSBkYXRhLmxhYmVsOwoJCQkvL3VwZGF0ZSB0aGUgdGV4dCBwcm9wZXJ0aWVzCgkJCXRoaXMubGFiZWwudGV4dEJhc2VsaW5lID0gZGF0YS50ZXh0QmFzZWxpbmUgfHwgIm1pZGRsZSI7Ly9NaWRkbGUgaXMgZWFzeSB0byBjZW50ZXIKCQkJdGhpcy5sYWJlbC5zdHJva2UgPSBkYXRhLnN0cm9rZTsKCQkJdGhpcy5sYWJlbC5zaGFkb3cgPSBkYXRhLnNoYWRvdzsKCQkJdGhpcy5sYWJlbC5mb250ID0gZGF0YS5mb250OwoJCQl0aGlzLmxhYmVsLmNvbG9yID0gZGF0YS5jb2xvciB8fCAiIzAwMCI7Ly9kZWZhdWx0IGZvciBjcmVhdGVqcy5UZXh0CgkJCS8vcG9zaXRpb24gdGhlIHRleHQKCQkJaWYoZGF0YS54ID09ICJjZW50ZXIiKQoJCQkJdGhpcy5sYWJlbC54ID0gKHRoaXMuX3dpZHRoIC0gdGhpcy5sYWJlbC5nZXRNZWFzdXJlZFdpZHRoKCkpICogMC41ICsgdGhpcy5fb2Zmc2V0Lng7CgkJCWVsc2UKCQkJCXRoaXMubGFiZWwueCA9IGRhdGEueCArIHRoaXMuX29mZnNldC54OwoJCQlpZihkYXRhLnkgPT0gImNlbnRlciIpCgkJCQl0aGlzLmxhYmVsLnkgPSB0aGlzLl9oZWlnaHQgKiAwLjUgKyB0aGlzLl9vZmZzZXQueTsKCQkJZWxzZQoJCQkJdGhpcy5sYWJlbC55ID0gZGF0YS55ICsgdGhpcy5fb2Zmc2V0Lnk7CgkJfQoJfTsKCQoJLyoqCgkqICBUaGUgY2FsbGJhY2sgZm9yIHdoZW4gdGhlIGJ1dHRvbiByZWNlaXZlcyBhIG1vdXNlIGRvd24gZXZlbnQuCgkqICBAcHJpdmF0ZQoJKiAgQG1ldGhvZCBfb25Nb3VzZURvd24KCSovCglwLl9vbk1vdXNlRG93biA9IGZ1bmN0aW9uKGUpCgl7CgkJdGhpcy5hZGRFdmVudExpc3RlbmVyKCdwcmVzc3VwJywgdGhpcy5fdXBDQik7CgkJdGhpcy5hZGRFdmVudExpc3RlbmVyKCJjbGljayIsIHRoaXMuX2NsaWNrQ0IpOwoJCXRoaXMuX3N0YXRlRmxhZ3MuZG93biA9IHRydWU7CgkJdGhpcy5fdXBkYXRlU3RhdGUoKTsKCX07CgkKCS8qKgoJKiAgVGhlIGNhbGxiYWNrIGZvciB3aGVuIHRoZSBidXR0b24gZm9yIHdoZW4gdGhlIG1vdXNlL3RvdWNoIGlzIHJlbGVhc2VkIG9uIHRoZSBidXR0b24KCSogIC0gb25seSB3aGVuIHRoZSBidXR0b24gd2FzIGhlbGQgZG93biBpbml0aWFsbHkuCgkqICBAcHJpdmF0ZQoJKiAgQG1ldGhvZCBfb25Nb3VzZVVwCgkqLwoJcC5fb25Nb3VzZVVwID0gZnVuY3Rpb24oZSkKCXsKCQl0aGlzLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3ByZXNzdXAnLCB0aGlzLl91cENCKTsKCQl0aGlzLnJlbW92ZUV2ZW50TGlzdGVuZXIoImNsaWNrIiwgdGhpcy5fY2xpY2tDQik7CgkJdGhpcy5fc3RhdGVGbGFncy5kb3duID0gZmFsc2U7CgkJLy9pZiB0aGUgb3ZlciBmbGFnIGlzIHRydWUsIHRoZW4gdGhlIG1vdXNlIHdhcyByZWxlYXNlZCB3aGlsZSBvbiB0aGUgYnV0dG9uLCB0aHVzIGJlaW5nIGEgY2xpY2sKCQl0aGlzLl91cGRhdGVTdGF0ZSgpOwoJfTsKCgkvKioKCSogIFRoZSBjYWxsYmFjayBmb3Igd2hlbiB0aGUgYnV0dG9uIHRoZSBidXR0b24gaXMgY2xpY2tlZCBvciB0YXBwZWQgb24uIFRoaXMgaXMKCSogIHRoZSBtb3N0IHJlbGlhYmxlIHdheSBvZiBkZXRlY3RpbmcgbW91c2UgdXAvdG91Y2ggZW5kIGV2ZW50cyB0aGF0IGFyZSBvbiB0aGlzIGJ1dHRvbgoJKiAgd2hpbGUgbGV0dGluZyB0aGUgcHJlc3N1cCBldmVudCBoYW5kbGUgdGhlIG1vdXNlIHVwL3RvdWNoIGVuZHMgb24gYW5kIG91dHNpZGUgdGhlIGJ1dHRvbi4KCSogIEBwcml2YXRlCgkqICBAbWV0aG9kIF9vbkNsaWNrCgkqLwoJcC5fb25DbGljayA9IGZ1bmN0aW9uKGUpCgl7CgkJdGhpcy5kaXNwYXRjaEV2ZW50KG5ldyBjcmVhdGVqcy5FdmVudChCdXR0b24uQlVUVE9OX1BSRVNTKSk7Cgl9OwoJCgkvKioKCSogIFRoZSBjYWxsYmFjayBmb3Igd2hlbiB0aGUgYnV0dG9uIGlzIG1vdXNlZCBvdmVyLgoJKiAgQHByaXZhdGUKCSogIEBtZXRob2QgX29uTW91c2VPdmVyCgkqLwoJcC5fb25Nb3VzZU92ZXIgPSBmdW5jdGlvbihlKQoJewoJCXRoaXMuX3N0YXRlRmxhZ3Mub3ZlciA9IHRydWU7CgkJdGhpcy5fdXBkYXRlU3RhdGUoKTsKCX07CgkKCS8qKgoJKiAgVGhlIGNhbGxiYWNrIGZvciB3aGVuIHRoZSBtb3VzZSBsZWF2ZXMgdGhlIGJ1dHRvbiBhcmVhLgoJKiAgQHByaXZhdGUKCSogIEBtZXRob2QgX29uTW91c2VPdXQKCSovCglwLl9vbk1vdXNlT3V0ID0gZnVuY3Rpb24oZSkKCXsKCQl0aGlzLl9zdGF0ZUZsYWdzLm92ZXIgPSBmYWxzZTsKCQl0aGlzLl91cGRhdGVTdGF0ZSgpOwoJfTsKCQoJLyoqCgkqICBEZXN0cm95cyB0aGUgYnV0dG9uLgoJKiAgQHB1YmxpYwoJKiAgQG1ldGhvZCBkZXN0cm95CgkqLwoJcC5kZXN0cm95ID0gZnVuY3Rpb24oKQoJewoJCXRoaXMucmVtb3ZlQWxsQ2hpbGRyZW4oKTsKCQl0aGlzLnJlbW92ZUFsbEV2ZW50TGlzdGVuZXJzKCk7CgkJdGhpcy5fZG93bkNCID0gbnVsbDsKCQl0aGlzLl91cENCID0gbnVsbDsKCQl0aGlzLl9vdmVyQ0IgPSBudWxsOwoJCXRoaXMuX291dENCID0gbnVsbDsKCQl0aGlzLmJhY2sgPSBudWxsOwoJCXRoaXMubGFiZWwgPSBudWxsOwoJCXRoaXMuX3N0YXRlUHJpb3JpdHkgPSBudWxsOwoJCXRoaXMuX3N0YXRlRmxhZ3MgPSBudWxsOwoJCXRoaXMuX3N0YXRlRGF0YSA9IG51bGw7Cgl9OwoKCS8qKgoJKiAgR2VuZXJhdGVzIGEgZGVzYXR1cmF0ZWQgdXAgc3RhdGUgYXMgYSBkaXNhYmxlZCBzdGF0ZSwgYW5kIGFuIHVwZGF0ZSB3aXRoIGEgc29saWQgY29sb3JlZCBnbG93IGZvciBhIGhpZ2hsaWdodGVkIHN0YXRlLgoJKiAgQG1ldGhvZCBnZW5lcmF0ZURlZmF1bHRTdGF0ZXMKCSogIEBzdGF0aWMKCSogIEBwYXJhbSB7SW1hZ2V8SFRNTENhbnZhc0VsZW1lbnR9IGltYWdlIFRoZSBpbWFnZSB0byB1c2UgZm9yIGFsbCBvZiB0aGUgYnV0dG9uIHN0YXRlcywgaW4gdGhlIHN0YW5kYXJkIHVwL292ZXIvZG93biBmb3JtYXQuCgkqICBAcGFyYW0ge09iamVjdH0gW2Rpc2FibGVkU2V0dGluZ3NdIFRoZSBzZXR0aW5ncyBvYmplY3QgZm9yIHRoZSBkaXNhYmxlZCBzdGF0ZS4gSWYgb21pdHRlZCwgbm8gZGlzYWJsZWQgc3RhdGUgaXMgY3JlYXRlZC4KCSogIEBwYXJhbSB7TnVtYmVyfSBbZGlzYWJsZWRTZXR0aW5ncy5zYXR1cmF0aW9uXSBUaGUgc2F0dXJhdGlvbiBhZGp1c3RtZW50IGZvciB0aGUgZGlzYWJsZWQgc3RhdGUuIAoJKiAgICAgICAgIDEwMCBpcyBmdWxseSBzYXR1cmF0ZWQsIDAgaXMgdW5jaGFuZ2VkLCAtMTAwIGlzIGRlc2F0dXJhdGVkLgoJKiAgQHBhcmFtIHtOdW1iZXJ9IFtkaXNhYmxlZFNldHRpbmdzLmJyaWdodG5lc3NdIFRoZSBicmlnaHRuZXNzIGFkanVzdG1lbnQgZm9yIHRoZSBkaXNhYmxlZCBzdGF0ZS4gCgkqICAgICAgICAgMTAwIGlzIGZ1bGx5IGJyaWdodCwgMCBpcyB1bmNoYW5nZWQsIC0xMDAgaXMgY29tcGxldGVseSBkYXJrLgoJKiAgQHBhcmFtIHtOdW1iZXJ9IFtkaXNhYmxlZFNldHRpbmdzLmNvbnRyYXN0XSBUaGUgY29udHJhc3QgYWRqdXN0bWVudCBmb3IgdGhlIGRpc2FibGVkIHN0YXRlLiAKCSogICAgICAgICAxMDAgaXMgZnVsbCBjb250cmFzdCwgMCBpcyB1bmNoYW5nZWQsIC0xMDAgaXMgbm8gY29udHJhc3QuCgkqICBAcGFyYW0ge09iamVjdH0gW2hpZ2hsaWdodFNldHRpbmdzXSBUaGUgc2V0dGluZ3Mgb2JqZWN0IGZvciB0aGUgaGlnaGxpZ2h0IHN0YXRlLiBJZiBvbWl0dGVkLCBubyBzdGF0ZSBpcyBjcmVhdGVkLgoJKiAgQHBhcmFtIHtOdW1iZXJ9IFtoaWdobGlnaHRTZXR0aW5ncy5zaXplXSBIb3cgbWFueSBwaXhlbHMgdG8gbWFrZSB0aGUgZ2xvdywgZWcgOCBmb3IgYW4gOCBwaXhlbCBpbmNyZWFzZSBvbiBlYWNoIHNpZGUuCgkqICBAcGFyYW0ge051bWJlcn0gW2hpZ2hsaWdodFNldHRpbmdzLnJlZF0gVGhlIHJlZCB2YWx1ZSBmb3IgdGhlIGdsb3csIGZyb20gMCB0byAyNTUuCgkqICBAcGFyYW0ge051bWJlcn0gW2hpZ2hsaWdodFNldHRpbmdzLmdyZWVuXSBUaGUgZ3JlZW4gdmFsdWUgZm9yIHRoZSBnbG93LCBmcm9tIDAgdG8gMjU1LgoJKiAgQHBhcmFtIHtOdW1iZXJ9IFtoaWdobGlnaHRTZXR0aW5ncy5ibHVlXSBUaGUgYmx1ZSB2YWx1ZSBmb3IgdGhlIGdsb3csIGZyb20gMCB0byAyNTUuCgkqICBAcGFyYW0ge051bWJlcn0gW2hpZ2hsaWdodFNldHRpbmdzLmFscGhhXSBUaGUgYWxwaGEgdmFsdWUgZm9yIHRoZSBnbG93LCBmcm9tIDAgdG8gMjU1LCB3aXRoIDAgYmVpbmcgdHJhbnNwYXJlbnQgYW5kIDI1NSBmdWxseSBvcGFxdWUuCgkqLwoJQnV0dG9uLmdlbmVyYXRlRGVmYXVsdFN0YXRlcyA9IGZ1bmN0aW9uKGltYWdlLCBkaXNhYmxlZFNldHRpbmdzLCBoaWdobGlnaHRTZXR0aW5ncykKCXsKCQkvL2ZpZ3VyZSBvdXQgdGhlIG5vcm1hbCBidXR0b24gc2l6ZQoJCXZhciBidXR0b25XaWR0aCA9IGltYWdlLndpZHRoOwoJCXZhciBidXR0b25IZWlnaHQgPSBpbWFnZS5oZWlnaHQgLyAzOwoJCS8vY3JlYXRlIGEgY2FudmFzIGVsZW1lbnQgYW5kIHNpemUgaXQKCQl2YXIgY2FudmFzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiY2FudmFzIik7CgkJdmFyIHdpZHRoID0gYnV0dG9uV2lkdGg7CgkJdmFyIGhlaWdodCA9IGltYWdlLmhlaWdodDsKCQlpZihkaXNhYmxlZFNldHRpbmdzKQoJCXsKCQkJaGVpZ2h0ICs9IGJ1dHRvbkhlaWdodDsKCQl9CgkJaWYoaGlnaGxpZ2h0U2V0dGluZ3MpCgkJewoJCQl3aWR0aCArPSBoaWdobGlnaHRTZXR0aW5ncy5zaXplICogMjsKCQkJaGVpZ2h0ICs9IGJ1dHRvbkhlaWdodCArIGhpZ2hsaWdodFNldHRpbmdzLnNpemUgKiAyOwoJCX0KCQljYW52YXMud2lkdGggPSB3aWR0aDsKCQljYW52YXMuaGVpZ2h0ID0gaGVpZ2h0OwoJCS8vZ2V0IHRoZSBkcmF3aW5nIGNvbnRleHQKCQl2YXIgY29udGV4dCA9IGNhbnZhcy5nZXRDb250ZXh0KCIyZCIpOwoJCS8vZHJhdyB0aGUgaW1hZ2UgdG8gaXQKCQljb250ZXh0LmRyYXdJbWFnZShpbWFnZSwgMCwgMCk7CgkJLy9zdGFydCBzZXR0aW5nIHVwIHRoZSBvdXRwdXQKCQl2YXIgb3V0cHV0ID0gewoJCQlpbWFnZTogY2FudmFzLAoJCQl1cDp7IHNyYzpuZXcgY3JlYXRlanMuUmVjdGFuZ2xlKDAsIDAsIGJ1dHRvbldpZHRoLCBidXR0b25IZWlnaHQpIH0sCgkJCW92ZXI6eyBzcmM6bmV3IGNyZWF0ZWpzLlJlY3RhbmdsZSgwLCBidXR0b25IZWlnaHQsIGJ1dHRvbldpZHRoLCBidXR0b25IZWlnaHQpIH0sCgkJCWRvd246eyBzcmM6bmV3IGNyZWF0ZWpzLlJlY3RhbmdsZSgwLCBidXR0b25IZWlnaHQgKiAyLCBidXR0b25XaWR0aCwgYnV0dG9uSGVpZ2h0KSB9CgkJfTsKCQkvL3NldCB1cCBhIGJpdG1hcCB0byBkcmF3IG90aGVyIHN0YXRlcyB3aXRoCgkJdmFyIGRyYXdpbmdCaXRtYXAgPSBuZXcgY3JlYXRlanMuQml0bWFwKGltYWdlKTsKCQlkcmF3aW5nQml0bWFwLnNvdXJjZVJlY3QgPSBvdXRwdXQudXAuc3JjOwoJCS8vc2V0IHVwIGEgeSBwb3NpdGlvbiBmb3Igd2hlcmUgdGhlIG5leHQgc3RhdGUgc2hvdWxkIGdvIGluIHRoZSBjYW52YXMKCQl2YXIgbmV4dFkgPSBpbWFnZS5oZWlnaHQ7CgkJaWYoZGlzYWJsZWRTZXR0aW5ncykKCQl7CgkJCWNvbnRleHQuc2F2ZSgpOwoJCQkvL3Bvc2l0aW9uIHRoZSBidXR0b24gdG8gZHJhdwoJCQljb250ZXh0LnRyYW5zbGF0ZSgwLCBuZXh0WSk7CgkJCS8vc2V0IHVwIHRoZSBkZXNhdHVyYXRpb24gbWF0cml4CgkJCXZhciBtYXRyaXggPSBuZXcgY3JlYXRlanMuQ29sb3JNYXRyaXgoKTsKCQkJaWYoZGlzYWJsZWRTZXR0aW5ncy5zYXR1cmF0aW9uICE9PSB1bmRlZmluZWQpCgkJCQltYXRyaXguYWRqdXN0U2F0dXJhdGlvbihkaXNhYmxlZFNldHRpbmdzLnNhdHVyYXRpb24pOwoJCQlpZihkaXNhYmxlZFNldHRpbmdzLmJyaWdodG5lc3MgIT09IHVuZGVmaW5lZCkKCQkJCW1hdHJpeC5hZGp1c3RCcmlnaHRuZXNzKGRpc2FibGVkU2V0dGluZ3MuYnJpZ2h0bmVzcyAqIDIuNTUpOy8vY29udmVydCB0byBDcmVhdGVKUydzIC0yNTUtPjI1NSBzeXN0ZW0gZnJvbSAtMTAwLT4xMDAKCQkJaWYoZGlzYWJsZWRTZXR0aW5ncy5jb250cmFzdCAhPT0gdW5kZWZpbmVkKQoJCQkJbWF0cml4LmFkanVzdENvbnRyYXN0KGRpc2FibGVkU2V0dGluZ3MuY29udHJhc3QpOwoJCQlkcmF3aW5nQml0bWFwLmZpbHRlcnMgPSBbbmV3IGNyZWF0ZWpzLkNvbG9yTWF0cml4RmlsdGVyKG1hdHJpeCldOwoJCQkvL2RyYXcgdGhlIHN0YXRlCgkJCWRyYXdpbmdCaXRtYXAuY2FjaGUoMCwgMCwgb3V0cHV0LnVwLnNyYy53aWR0aCwgb3V0cHV0LnVwLnNyYy5oZWlnaHQpOwoJCQlkcmF3aW5nQml0bWFwLmRyYXcoY29udGV4dCk7CgkJCS8vdXBkYXRlIHRoZSBvdXRwdXQgd2l0aCB0aGUgc3RhdGUKCQkJb3V0cHV0LmRpc2FibGVkID0geyBzcmM6IG5ldyBjcmVhdGVqcy5SZWN0YW5nbGUoMCwgbmV4dFksIGJ1dHRvbldpZHRoLCBidXR0b25IZWlnaHQgfCAwKSB9OwoJCQluZXh0WSArPSBidXR0b25IZWlnaHQ7Ly9zZXQgdXAgdGhlIG5leHQgcG9zaXRpb24gZm9yIHRoZSBoaWdobGlnaHQgc3RhdGUsIGlmIHdlIGhhdmUgaXQKCQkJY29udGV4dC5yZXN0b3JlKCk7Ly9yZXNldCBhbnkgdHJhbnNmb3JtYXRpb25zCgkJfQoJCWlmKGhpZ2hsaWdodFNldHRpbmdzKQoJCXsKCQkJY29udGV4dC5zYXZlKCk7CgkJCS8vY2FsY3VsYXRlIHRoZSBzaXplIG9mIHRoaXMgc3RhdGUKCQkJdmFyIGhpZ2hsaWdodFN0YXRlV2lkdGggPSBidXR0b25XaWR0aCArIGhpZ2hsaWdodFNldHRpbmdzLnNpemUgKiAyOwoJCQl2YXIgaGlnaGxpZ2h0U3RhdGVIZWlnaHQgPSBidXR0b25IZWlnaHQgKyBoaWdobGlnaHRTZXR0aW5ncy5zaXplICogMjsKCQkJLy9zZXQgdXAgdGhlIGNvbG9yIGNoYW5naW5nIGZpbHRlcgoJCQlkcmF3aW5nQml0bWFwLmZpbHRlcnMgPSBbbmV3IGNyZWF0ZWpzLkNvbG9yRmlsdGVyKDAsMCwwLDEsIAoJCQkJLypyKi9oaWdobGlnaHRTZXR0aW5ncy5yZWQsIAoJCQkJLypnKi9oaWdobGlnaHRTZXR0aW5ncy5ncmVlbiwgCgkJCQkvKmIqL2hpZ2hsaWdodFNldHRpbmdzLmJsdWUsIAoJCQkJaGlnaGxpZ2h0U2V0dGluZ3MuYWxwaGEgIT09IHVuZGVmaW5lZCA/IC0yNTUgKyBoaWdobGlnaHRTZXR0aW5ncy5hbHBoYSA6IDApXTsKCQkJLy9zaXplIHRoZSBjb2xvcmVkIGhpZ2hsaWdodAoJCQlkcmF3aW5nQml0bWFwLnNjYWxlWCA9IChoaWdobGlnaHRTdGF0ZVdpZHRoKSAvIGJ1dHRvbldpZHRoOwoJCQlkcmF3aW5nQml0bWFwLnNjYWxlWSA9IChoaWdobGlnaHRTdGF0ZUhlaWdodCkgLyBidXR0b25IZWlnaHQ7CgkJCS8vcG9zaXRpb24gaXQKCQkJZHJhd2luZ0JpdG1hcC54ID0gMDsKCQkJZHJhd2luZ0JpdG1hcC55ID0gbmV4dFk7CgkJCS8vZHJhdyB0aGUgc3RhdGUKCQkJZHJhd2luZ0JpdG1hcC5jYWNoZSgwLCAwLCBoaWdobGlnaHRTdGF0ZVdpZHRoLCBoaWdobGlnaHRTdGF0ZUhlaWdodCk7CgkJCWRyYXdpbmdCaXRtYXAudXBkYXRlQ29udGV4dChjb250ZXh0KTsKCQkJZHJhd2luZ0JpdG1hcC5kcmF3KGNvbnRleHQpOwoJCQljb250ZXh0LnJlc3RvcmUoKTsvL3Jlc2V0IGFueSB0cmFuc2Zvcm1hdGlvbnMKCQkJLy9zaXplIGFuZCBwb3NpdGlvbiBpdCB0byBub3JtYWwKCQkJZHJhd2luZ0JpdG1hcC5zY2FsZVggPSBkcmF3aW5nQml0bWFwLnNjYWxlWSA9IDE7CgkJCWRyYXdpbmdCaXRtYXAueCA9IGhpZ2hsaWdodFNldHRpbmdzLnNpemU7CgkJCWRyYXdpbmdCaXRtYXAueSA9IG5leHRZICsgaGlnaGxpZ2h0U2V0dGluZ3Muc2l6ZTsKCQkJZHJhd2luZ0JpdG1hcC5maWx0ZXJzID0gbnVsbDsKCQkJZHJhd2luZ0JpdG1hcC51bmNhY2hlKCk7CgkJCS8vZHJhdyB0aGUgdXAgc3RhdGUgb3ZlciB0aGUgaGlnaGxpZ2h0IHN0YXRlIGdsb3cKCQkJZHJhd2luZ0JpdG1hcC51cGRhdGVDb250ZXh0KGNvbnRleHQpOwoJCQlkcmF3aW5nQml0bWFwLmRyYXcoY29udGV4dCk7CgkJCS8vc2V0IHVwIHRoZSB0cmltIHZhbHVlcyBmb3IgdGhlIG90aGVyIHN0YXRlcwoJCQl2YXIgdHJpbSA9IG5ldyBjcmVhdGVqcy5SZWN0YW5nbGUoCgkJCQloaWdobGlnaHRTZXR0aW5ncy5zaXplLCAKCQkJCWhpZ2hsaWdodFNldHRpbmdzLnNpemUsIAoJCQkJaGlnaGxpZ2h0U3RhdGVXaWR0aCwKCQkJCWhpZ2hsaWdodFN0YXRlSGVpZ2h0KTsKCQkJb3V0cHV0LnVwLnRyaW0gPSB0cmltOwoJCQlvdXRwdXQub3Zlci50cmltID0gdHJpbTsKCQkJb3V0cHV0LmRvd24udHJpbSA9IHRyaW07CgkJCWlmKG91dHB1dC5kaXNhYmxlZCkKCQkJCW91dHB1dC5kaXNhYmxlZC50cmltID0gdHJpbTsKCQkJLy9zZXQgdXAgdGhlIGhpZ2hsaWdodCBzdGF0ZSBmb3IgdGhlIGJ1dHRvbgoJCQlvdXRwdXQuaGlnaGxpZ2h0ZWQgPSB7CgkJCQlzcmM6bmV3IGNyZWF0ZWpzLlJlY3RhbmdsZSgwLCBuZXh0WSwgaGlnaGxpZ2h0U3RhdGVXaWR0aCB8IDAsIGhpZ2hsaWdodFN0YXRlSGVpZ2h0IHwgMCkKCQkJfTsKCQkJLy9zZXQgdXAgdGhlIHN0YXRlIHByaW9yaXR5IHRvIGluY2x1ZGUgdGhlIGhpZ2hsaWdodGVkIHN0YXRlCgkJCW91dHB1dC5wcmlvcml0eSA9IERFRkFVTFRfUFJJT1JJVFkuc2xpY2UoKTsKCQkJb3V0cHV0LnByaW9yaXR5LnVuc2hpZnQoImhpZ2hsaWdodGVkIik7CgkJCS8vYWRkIGluIGFuIG9mZnNldCB0byB0aGUgYnV0dG9uIHRvIGFjY291bnQgZm9yIHRoZSBoaWdobGlnaHQgZ2xvdyB3aXRob3V0IGFmZmVjdGluZyBidXR0b24gcG9zaXRpb25pbmcKCQkJb3V0cHV0Lm9mZnNldCA9IHt4OiAtaGlnaGxpZ2h0U2V0dGluZ3Muc2l6ZSwgeTogLWhpZ2hsaWdodFNldHRpbmdzLnNpemV9OwoJCX0KCQlyZXR1cm4gb3V0cHV0OwoJfTsKCgluYW1lc3BhY2UoJ2Nsb3Vka2lkJykuQnV0dG9uID0gQnV0dG9uOwp9KCkpOwovKioKKiAgQG1vZHVsZSBjbG91ZGtpZAoqLwooZnVuY3Rpb24oKSB7CgkKCSJ1c2Ugc3RyaWN0IjsKCQoJLyoqCgkqICBEcmFnIG1hbmFnZXIgaXMgcmVzcG9uc2libGUgZm9yIGhhbmRsaW5nIHRoZSBkcmFnZ2luZyBvZiBzdGFnZSBlbGVtZW50cy4KCSogIFN1cHBvcnRzIGNsaWNrLW4tc3RpY2sgKGNsaWNrIHRvIHN0YXJ0LCBtb3ZlIG1vdXNlLCBjbGljayB0byByZWxlYXNlKSBhbmQgY2xpY2stbi1kcmFnIChzdGFuZGFyZCBkcmFnZ2luZykgZnVuY3Rpb25hbGl0eS4KCSogIAoJKiAgQGNsYXNzIERyYWdNYW5hZ2VyIChDcmVhdGVKUykKCSogIEBjb25zdHJ1Y3RvcgoJKiAgQHBhcmFtIHtmdW5jdGlvbn0gc3RhcnRDYWxsYmFjayBUaGUgY2FsbGJhY2sgd2hlbiB3aGVuIHN0YXJ0aW5nCgkqICBAcGFyYW0ge2Z1bmN0aW9ufSBlbmRDYWxsYmFjayBUaGUgY2FsbGJhY2sgd2hlbiBlbmRpbmcKCSovCgl2YXIgRHJhZ01hbmFnZXIgPSBmdW5jdGlvbihzdGFydENhbGxiYWNrLCBlbmRDYWxsYmFjaykKCXsKCQl0aGlzLmluaXRpYWxpemUoc3RhcnRDYWxsYmFjaywgZW5kQ2FsbGJhY2spOwoJfTsKCQoJLyoqIFJlZmVyZW5jZSB0byB0aGUgZHJhZyBtYW5hZ2VyICovCgl2YXIgcCA9IERyYWdNYW5hZ2VyLnByb3RvdHlwZSA9IHt9OwoJCgkvKioKCSogVGhlIG9iamVjdCB0aGF0J3MgYmVpbmcgZHJhZ2dlZAoJKiBAcHVibGljCgkqIEByZWFkT25seQoJKiBAcHJvcGVydHkge2NyZWF0ZWpzLkRpc3BsYXlPYmplY3R9IGRyYWdnZWRPYmoKCSovCglwLmRyYWdnZWRPYmogPSBudWxsOwoJCgkvKioKCSogVGhlIHJhZGl1cyBpbiBwaXhlbCB0byBhbGxvdyBmb3IgZHJhZ2dpbmcsIG9yIGVsc2UgZG9lcyBzdGlja3kgY2xpY2sKCSogQHB1YmxpYwoJKiBAcHJvcGVydHkgZHJhZ1N0YXJ0VGhyZXNob2xkCgkqIEBkZWZhdWx0IDIwCgkqLwoJcC5kcmFnU3RhcnRUaHJlc2hvbGQgPSAyMDsKCQoJLyoqCgkqIFRoZSBwb3NpdGlvbiB4LCB5IG9mIHRoZSBtb3VzZSBkb3duIG9uIHRoZSBzdGFnZQoJKiBAcHJpdmF0ZQoJKiBAcHJvcGVydHkge29iamVjdH0gbW91c2VEb3duU3RhZ2VQb3MKCSovCglwLm1vdXNlRG93blN0YWdlUG9zID0gbnVsbDsKCgkvKioKCSogVGhlIHBvc2l0aW9uIHgsIHkgb2YgdGhlIG9iamVjdCB3aGVuIGludGVyYWN0aW9uIHdpdGggaXQgc3RhcnRlZC4KCSogQHByaXZhdGUKCSogQHByb3BlcnR5IHtvYmplY3R9IG1vdXNlRG93bk9ialBvcwoJKi8KCXAubW91c2VEb3duT2JqUG9zID0gbnVsbDsKCgkvKioKCSogSWYgc3RpY2t5IGNsaWNrIGRyYWdnaW5nIGlzIGFsbG93ZWQuCgkqIEBwdWJsaWMKCSogQHByb3BlcnR5IHtCb29sfSBhbGxvd1N0aWNreUNsaWNrCgkqIEBkZWZhdWx0IHRydWUKCSovCglwLmFsbG93U3RpY2t5Q2xpY2sgPSB0cnVlOwoJCgkvKioKCSogSXMgdGhlIG1vdmUgdG91Y2ggYmFzZWQKCSogQHB1YmxpYwoJKiBAcmVhZE9ubHkKCSogQHByb3BlcnR5IHtCb29sfSBpc1RvdWNoTW92ZQoJKiBAZGVmYXVsdCBmYWxzZQoJKi8KCXAuaXNUb3VjaE1vdmUgPSBmYWxzZTsKCQoJLyoqCgkqIElzIHRoZSBkcmFnIGJlaW5nIGhlbGQgb24gbW91c2UgZG93biAobm90IHN0aWNreSBjbGlja2luZykKCSogQHB1YmxpYwoJKiBAcmVhZE9ubHkKCSogQHByb3BlcnR5IHtCb29sfSBpc0hlbGREcmFnCgkqIEBkZWZhdWx0IGZhbHNlCgkqLwoJcC5pc0hlbGREcmFnID0gZmFsc2U7CgkKCS8qKgoJKiBJcyB0aGUgZHJhZyBhIHN0aWNreSBjbGlja2luZyAoY2xpY2sgb24gYSBpdGVtLCB0aGVuIG1vdXNlIHRoZSBtb3VzZSkKCSogQHB1YmxpYwoJKiBAcmVhZE9ubHkKCSogQHByb3BlcnR5IHtCb29sfSBpc1N0aWNreUNsaWNrCgkqIEBkZWZhdWx0IGZhbHNlCgkqLwoJcC5pc1N0aWNreUNsaWNrID0gZmFsc2U7CgoJLyoqCgkqIFNldHRpbmdzIGZvciBzbmFwcGluZy4KCSoKCSogIEZvcm1hdCBmb3Igc25hcHBpbmcgdG8gYSBsaXN0IG9mIHBvaW50czoKCSoJewoJKgkJbW9kZToicG9pbnRzIiwKCSoJCWRpc3Q6MjAsLy9zbmFwIHdoZW4gd2l0aGluIDIwIHBpeGVscy91bml0cwoJKgkJcG9pbnRzOlsKCSoJCQl7IHg6IDIwLCB5OjMwIH0sCgkqCQkJeyB4OiA1MCwgeToxMCB9CgkqCQldCgkqCX0KCSoKCSogQHB1YmxpYwoJKiBAcHJvcGVydHkge09iamVjdH0gc25hcFNldHRpbmdzCgkqIEBkZWZhdWx0IG51bGwKCSovCglwLnNuYXBTZXR0aW5ncyA9IG51bGw7CgkKCS8qKgoJKiBSZWZlcmVuY2UgdG8gdGhlIHN0YWdlCgkqIEBwcml2YXRlCgkqIEBwcm9wZXJ0eSB7Y3JlYXRlanNTdGFnZX0gX3RoZVN0YWdlCgkqLwoJcC5fdGhlU3RhZ2UgPSBudWxsOwoJCgkvKioKCSogVGhlIGxvY2FsIHRvIGdsb2JhbCBwb3NpdGlvbiBvZiB0aGUgZHJhZwoJKiBAcHJpdmF0ZQoJKiBAcHJvcGVydHkge2NyZWF0ZWpzLlBvaW50fSBfZHJhZ09mZnNldAoJKi8KCXAuX2RyYWdPZmZzZXQgPSBudWxsOwoJCgkvKioKCSogQ2FsbGJhY2sgd2hlbiB3ZSBzdGFydCBkcmFnZ2luZwoJKiBAcHJpdmF0ZQoJKiBAcHJvcGVydHkge0Z1bmN0aW9ufSBfZHJhZ1N0YXJ0Q2FsbGJhY2sKCSovCglwLl9kcmFnU3RhcnRDYWxsYmFjayA9IG51bGw7CgkKCS8qKgoJKiBDYWxsYmFjayB3aGVuIHdlIGFyZSBkb25lIGRyYWdnaW5nCgkqIEBwcml2YXRlCgkqIEBwcm9wZXJ0eSB7RnVuY3Rpb259IF9kcmFnRW5kQ2FsbGJhY2sKCSovCglwLl9kcmFnRW5kQ2FsbGJhY2sgPSBudWxsOwoJCgkvKioKCSogQ2FsbGJhY2sgdG8gdGVzdCBmb3IgdGhlIHN0YXJ0IGEgaGVsZCBkcmFnCgkqIEBwcml2YXRlCgkqIEBwcm9wZXJ0eSB7RnVuY3Rpb259IF90cmlnZ2VySGVsZERyYWdDYWxsYmFjawoJKi8KCXAuX3RyaWdnZXJIZWxkRHJhZ0NhbGxiYWNrID0gbnVsbDsKCQoJLyoqCgkqIENhbGxiYWNrIHRvIHN0YXJ0IGEgc3RpY2t5IGNsaWNrIGRyYWcKCSogQHByaXZhdGUKCSogQHByb3BlcnR5IHtGdW5jdGlvbn0gX3RyaWdnZXJTdGlja3lDbGlja0NhbGxiYWNrCgkqLwoJcC5fdHJpZ2dlclN0aWNreUNsaWNrQ2FsbGJhY2sgPSBudWxsOwoJCgkvKioKCSogQ2FsbGJhY2sgd2hlbiB3ZSBhcmUgZG9uZSB3aXRoIHRoZSBkcmFnCgkqIEBwcml2YXRlCgkqIEBwcm9wZXJ0eSB7RnVuY3Rpb259IF9zdGFnZU1vdXNlVXBDYWxsYmFjawoJKi8KCXAuX3N0YWdlTW91c2VVcENhbGxiYWNrID0gbnVsbDsKCQoJLyoqCgkqIFRoZSBjb2xsZWN0aW9uIG9mIGRyYWdnYWJsZSBvYmplY3RzCgkqIEBwcml2YXRlCgkqIEBwcm9wZXJ0eSB7QXJyYXl9IF9kcmFnZ2FibGVPYmplY3RzCgkqLwoJcC5fZHJhZ2dhYmxlT2JqZWN0cyA9IG51bGw7CgkJCgkvKioKCSogVGhlIGZ1bmN0aW9uIGNhbGwgd2hlbiB0aGUgbW91c2UvdG91Y2ggbW92ZXMKCSogQHByaXZhdGUKCSogQHByb3BlcnR5IHtmdW5jdGlvbn0gX3VwZGF0ZUNhbGxiYWNrIAoJKi8KCXAuX3VwZGF0ZUNhbGxiYWNrID0gbnVsbDsKCgkvKioKCSogQSBwb2ludCBmb3IgcmV1c2UgaW5zdGVhZCBvZiBsb3RzIG9mIG9iamVjdCBjcmVhdGlvbi4KCSogQHByaXZhdGUKCSogQHByb3BlcnR5IHtjcmVhdGVqcy5Qb2ludH0gX2hlbHBlclBvaW50IAoJKi8KCXAuX2hlbHBlclBvaW50ID0gbnVsbDsKCQoJLyoqIAoJKiBDb25zdHJ1Y3RvciAKCSogQG1ldGhvZCBpbml0aWFsaXplCgkqIEBjb25zdHJ1Y3RvcgoJKiBAcGFyYW0ge2Z1bmN0aW9ufSBzdGFydENhbGxiYWNrIFRoZSBjYWxsYmFjayB3aGVuIHdoZW4gc3RhcnRpbmcKCSogQHBhcmFtIHtmdW5jdGlvbn0gZW5kQ2FsbGJhY2sgVGhlIGNhbGxiYWNrIHdoZW4gZW5kaW5nCgkqLwoJcC5pbml0aWFsaXplID0gZnVuY3Rpb24oc3RhcnRDYWxsYmFjaywgZW5kQ2FsbGJhY2spCgl7CgkJdGhpcy5fdXBkYXRlQ2FsbGJhY2sgPSB0aGlzLl91cGRhdGVPYmpQb3NpdGlvbi5iaW5kKHRoaXMpOwoJCXRoaXMuX3RyaWdnZXJIZWxkRHJhZ0NhbGxiYWNrID0gdGhpcy5fdHJpZ2dlckhlbGREcmFnLmJpbmQodGhpcyk7CgkJdGhpcy5fdHJpZ2dlclN0aWNreUNsaWNrQ2FsbGJhY2sgPSB0aGlzLl90cmlnZ2VyU3RpY2t5Q2xpY2suYmluZCh0aGlzKTsKCQl0aGlzLl9zdGFnZU1vdXNlVXBDYWxsYmFjayA9IHRoaXMuX3N0b3BEcmFnLmJpbmQodGhpcyk7CgkJdGhpcy5fdGhlU3RhZ2UgPSBjbG91ZGtpZC5PUy5pbnN0YW5jZS5zdGFnZTsKCQl0aGlzLl9kcmFnU3RhcnRDYWxsYmFjayA9IHN0YXJ0Q2FsbGJhY2s7CgkJdGhpcy5fZHJhZ0VuZENhbGxiYWNrID0gZW5kQ2FsbGJhY2s7CgkJdGhpcy5fZHJhZ2dhYmxlT2JqZWN0cyA9IFtdOwoJCXRoaXMubW91c2VEb3duU3RhZ2VQb3MgPSB7eDowLCB5OjB9OwoJCXRoaXMubW91c2VEb3duT2JqUG9zID0ge3g6MCwgeTowfTsKCX07CgkKCS8qKgoJKglNYW51YWxseSBzdGFydHMgZHJhZ2dpbmcgYW4gb2JqZWN0LiBJZiBhIG1vdXNlIGRvd24gZXZlbnQgaXMgbm90IHN1cHBsaWVkIGFzIHRoZSBzZWNvbmQgYXJndW1lbnQsIGl0IAoJKiAgIGRlZmF1bHRzIHRvIGEgaGVsZCBkcmFnLCB0aGF0IGVuZHMgYXMgc29vbiBhcyB0aGUgbW91c2UgaXMgcmVsZWFzZWQuCgkqICBAbWV0aG9kIHN0YXJ0RHJhZwoJKiAgQHB1YmxpYwoJKiAgQHBhcmFtIHtjcmVhdGVqcy5EaXNwbGF5T2JqZWN0fSBvYmplY3QgVGhlIG9iamVjdCB0aGF0IHNob3VsZCBiZSBkcmFnZ2VkLgoJKiAgQHBhcmFtIHtjcmVhdGVqcy5Nb3VzZUV2ZW50fSBldiBBIG1vdXNlIGRvd24gZXZlbnQgdG8gbGlzdGVuIHRvIHRvIGRldGVybWluZSB3aGF0IHR5cGUgb2YgZHJhZyBzaG91bGQgYmUgdXNlZC4KCSovCglwLnN0YXJ0RHJhZyA9IGZ1bmN0aW9uKG9iamVjdCwgZXYpCgl7CgkJdGhpcy5fb2JqTW91c2VEb3duKGV2LCBvYmplY3QpOwoJfTsKCQoJLyoqCgkqIE1vdXNlIGRvd24gb24gYW4gb2JtZWN0CgkqICBAbWV0aG9kIF9vYmpNb3VzZURvd24KCSogIEBwcml2YXRlCgkqICBAcGFyYW0ge2NyZWF0ZWpzLk1vdXNlRXZlbnR9IGV2IEEgbW91c2UgZG93biBldmVudCB0byBsaXN0ZW4gdG8gdG8gZGV0ZXJtaW5lIHdoYXQgdHlwZSBvZiBkcmFnIHNob3VsZCBiZSB1c2VkLgoJKiAgQHBhcmFtIHtjcmVhdGVqcy5EaXNwbGF5T2JqZWN0fSBvYmplY3QgVGhlIG9iamVjdCB0aGF0IHNob3VsZCBiZSBkcmFnZ2VkLgoJKi8KCXAuX29iak1vdXNlRG93biA9IGZ1bmN0aW9uKGV2LCBvYmopCgl7CgkJLy8gaWYgd2UgYXJlIGRyYWdnaW5nIHNvbWV0aGluZywgdGhlbiBpZ25vcmUgYW55IG1vdXNlIGRvd25zCgkJLy8gdW50aWwgd2UgcmVsZWFzZSB0aGUgY3VycmVudGx5IGRyYWdnZWQgc3R1ZmYKCQlpZih0aGlzLmRyYWdnZWRPYmogIT09IG51bGwpIHJldHVybjsKCgkJdGhpcy5kcmFnZ2VkT2JqID0gb2JqOwoJCS8vc3RvcCBhbnkgYWN0aXZlIHR3ZWVucyBvbiB0aGUgb2JqZWN0LCBpbiBjYXNlIGl0IGlzIG1vdmluZyBhcm91bmQgb3Igc29tZXRoaW5nCgkJY3JlYXRlanMuVHdlZW4ucmVtb3ZlVHdlZW5zKG9iaik7CgkJCgkJLy9nZXQgdGhlIG1vdXNlIHBvc2l0aW9uIGluIGdsb2JhbCBzcGFjZSBhbmQgY29udmVydCBpdCB0byBwYXJlbnQgc3BhY2UKCQl0aGlzLl9kcmFnT2Zmc2V0ID0gdGhpcy5kcmFnZ2VkT2JqLnBhcmVudC5nbG9iYWxUb0xvY2FsKGV2ID8gZXYuc3RhZ2VYIDogMCwgZXYgPyBldi5zdGFnZVkgOiAwKTsKCQkKCQkvL21vdmUgdGhlIG9mZnNldCB0byByZXNwZWN0IHRoZSBvYmplY3QncyBjdXJyZW50IHBvc2l0aW9uCgkJdGhpcy5fZHJhZ09mZnNldC54IC09IG9iai54OwoJCXRoaXMuX2RyYWdPZmZzZXQueSAtPSBvYmoueTsKCgkJLy9zYXZlIHRoZSBwb3NpdGlvbiBvZiB0aGUgb2JqZWN0IGJlZm9yZSBkcmFnZ2luZyBiZWdhbiwgZm9yIGVhc3kgcmVzdG9yYXRpb24sIGlmIGRlc2lyZWQKCQl0aGlzLm1vdXNlRG93bk9ialBvcy54ID0gb2JqLng7CgkJdGhpcy5tb3VzZURvd25PYmpQb3MueSA9IG9iai55OwoJCQoJCWlmKCFldikvL2lmIHdlIGRvbid0IGdldCBhbiBldmVudCAobWFudWFsIGNhbGwgbmVnbGVjdGVkIHRvIHBhc3Mgb25lKSB0aGVuIGRlZmF1bHQgdG8gYSBoZWxkIGRyYWcKCQl7CgkJCXRoaXMuaXNIZWxkRHJhZyA9IHRydWU7CgkJCXRoaXMuX3N0YXJ0RHJhZygpOwoJCX0KCQllbHNlCgkJewoJCQkvL292ZXJyaWRlIHRoZSB0YXJnZXQgZm9yIHRoZSBtb3VzZWRvd24vdG91Y2hzdGFydCBldmVudCB0byBiZSB0aGlzIG9iamVjdCwgaW4gY2FzZSB3ZSBhcmUgZHJhZ2dpbmcgYSBjbG9uZWQgb2JqZWN0CgkJCXRoaXMuX3RoZVN0YWdlLl9nZXRQb2ludGVyRGF0YShldi5wb2ludGVySUQpLnRhcmdldCA9IG9iajsKCgkJCWlmKCF0aGlzLmFsbG93U3RpY2t5Q2xpY2sgfHwgZXYubmF0aXZlRXZlbnQudHlwZSA9PSAndG91Y2hzdGFydCcpLy9pZiBpdCBpcyBhIHRvdWNoIGV2ZW50LCBmb3JjZSBpdCB0byBiZSB0aGUgaGVsZCBkcmFnIHR5cGUKCQkJewoJCQkJdGhpcy5tb3VzZURvd25TdGFnZVBvcy54ID0gZXYuc3RhZ2VYOwoJCQkJdGhpcy5tb3VzZURvd25TdGFnZVBvcy55ID0gZXYuc3RhZ2VZOwoJCQkJdGhpcy5pc1RvdWNoTW92ZSA9IGV2Lm5hdGl2ZUV2ZW50LnR5cGUgPT0gJ3RvdWNoc3RhcnQnOwoJCQkJdGhpcy5pc0hlbGREcmFnID0gdHJ1ZTsKCQkJCXRoaXMuX3N0YXJ0RHJhZygpOwoJCQl9CgkJCWVsc2UvL290aGVyd2lzZSwgd2FpdCBmb3IgYSBtb3ZlbWVudCBvciBhIG1vdXNlIHVwIGluIG9yZGVyIHRvIGRvIGEgaGVsZCBkcmFnIG9yIGEgc3RpY2t5IGNsaWNrIGRyYWcKCQkJewoJCQkJdGhpcy5tb3VzZURvd25TdGFnZVBvcy54ID0gZXYuc3RhZ2VYOwoJCQkJdGhpcy5tb3VzZURvd25TdGFnZVBvcy55ID0gZXYuc3RhZ2VZOwoJCQkJb2JqLmFkZEV2ZW50TGlzdGVuZXIoInByZXNzbW92ZSIsIHRoaXMuX3RyaWdnZXJIZWxkRHJhZ0NhbGxiYWNrKTsKCQkJCW9iai5hZGRFdmVudExpc3RlbmVyKCJwcmVzc3VwIiwgdGhpcy5fdHJpZ2dlclN0aWNreUNsaWNrQ2FsbGJhY2spOwoJCQl9CgkJfQoJfTsKCQoJLyoqCgkqIFN0YXJ0IHRoZSBzdGlja3kgY2xpY2sKCSogQG1ldGhvZCBfdHJpZ2dlclN0aWNreUNsaWNrCgkqIEBwcml2YXRlCgkqLwoJcC5fdHJpZ2dlclN0aWNreUNsaWNrID0gZnVuY3Rpb24oKQoJewoJCXRoaXMuaXNTdGlja3lDbGljayA9IHRydWU7CgkJdGhpcy5kcmFnZ2VkT2JqLnJlbW92ZUV2ZW50TGlzdGVuZXIoInByZXNzbW92ZSIsIHRoaXMuX3RyaWdnZXJIZWxkRHJhZ0NhbGxiYWNrKTsKCQl0aGlzLmRyYWdnZWRPYmoucmVtb3ZlRXZlbnRMaXN0ZW5lcigicHJlc3N1cCIsIHRoaXMuX3RyaWdnZXJTdGlja3lDbGlja0NhbGxiYWNrKTsKCQl0aGlzLl9zdGFydERyYWcoKTsKCX07CgoJLyoqCgkqIFN0YXJ0IGhvbGQgZHJhZ2dpbmcKCSogQG1ldGhvZCBfdHJpZ2dlckhlbGREcmFnCgkqIEBwcml2YXRlCgkqIEBwYXJhbSB7Y3JlYXRlanMuTW91c2VFdmVudH0gZXYgVGhlIG1vdXNlIGRvd24gZXZlbnQKCSovCglwLl90cmlnZ2VySGVsZERyYWcgPSBmdW5jdGlvbihldikKCXsKCQl2YXIgeERpZmYgPSBldi5zdGFnZVggLSB0aGlzLm1vdXNlRG93blN0YWdlUG9zLng7CgkJdmFyIHlEaWZmID0gZXYuc3RhZ2VZIC0gdGhpcy5tb3VzZURvd25TdGFnZVBvcy55OwoJCWlmKHhEaWZmICogeERpZmYgKyB5RGlmZiAqIHlEaWZmID49IHRoaXMuZHJhZ1N0YXJ0VGhyZXNob2xkICogdGhpcy5kcmFnU3RhcnRUaHJlc2hvbGQpCgkJewoJCQl0aGlzLmlzSGVsZERyYWcgPSB0cnVlOwoJCQl0aGlzLmRyYWdnZWRPYmoucmVtb3ZlRXZlbnRMaXN0ZW5lcigicHJlc3Ntb3ZlIiwgdGhpcy5fdHJpZ2dlckhlbGREcmFnQ2FsbGJhY2spOwoJCQl0aGlzLmRyYWdnZWRPYmoucmVtb3ZlRXZlbnRMaXN0ZW5lcigicHJlc3N1cCIsIHRoaXMuX3RyaWdnZXJTdGlja3lDbGlja0NhbGxiYWNrKTsKCQkJdGhpcy5fc3RhcnREcmFnKCk7CgkJfQoJfTsKCgkvKioKCSogSW50ZXJuYWwgc3RhcnQgZHJhZ2dpbmcgb24gdGhlIHN0YWdlCgkqIEBtZXRob2QgX3N0YXJ0RHJhZwoJKiBAcHJpdmF0ZSAKCSovCglwLl9zdGFydERyYWcgPSBmdW5jdGlvbigpCgl7CgkJdmFyIHN0YWdlID0gdGhpcy5fdGhlU3RhZ2U7CgkJc3RhZ2UucmVtb3ZlRXZlbnRMaXN0ZW5lcigic3RhZ2Vtb3VzZW1vdmUiLCB0aGlzLl91cGRhdGVDYWxsYmFjayk7CgkJc3RhZ2UuYWRkRXZlbnRMaXN0ZW5lcigic3RhZ2Vtb3VzZW1vdmUiLCB0aGlzLl91cGRhdGVDYWxsYmFjayk7CgkJc3RhZ2UucmVtb3ZlRXZlbnRMaXN0ZW5lcigic3RhZ2Vtb3VzZXVwIiwgdGhpcy5fc3RhZ2VNb3VzZVVwQ2FsbGJhY2spOwoJCXN0YWdlLmFkZEV2ZW50TGlzdGVuZXIoInN0YWdlbW91c2V1cCIsIHRoaXMuX3N0YWdlTW91c2VVcENhbGxiYWNrKTsKCQkKCQl0aGlzLl9kcmFnU3RhcnRDYWxsYmFjayh0aGlzLmRyYWdnZWRPYmopOwoJfTsKCQoJLyoqCgkqIFN0b3BzIGRyYWdnaW5nIHRoZSBjdXJyZW50bHkgZHJhZ2dlZCBvYmplY3QuCgkqIEBwdWJsaWMKCSogQG1ldGhvZCBzdG9wRHJhZwoJKiBAcGFyYW0ge0Jvb2x9IGRvQ2FsbGJhY2sgSWYgdGhlIGRyYWcgZW5kIGNhbGxiYWNrIHNob3VsZCBiZSBjYWxsZWQuIERlZmF1bHQgaXMgZmFsc2UuCgkqLwoJcC5zdG9wRHJhZyA9IGZ1bmN0aW9uKGRvQ2FsbGJhY2spCgl7CgkJdGhpcy5fc3RvcERyYWcobnVsbCwgZG9DYWxsYmFjayA9PT0gdHJ1ZSk7Ly9wYXNzIHRydWUgaWYgaXQgd2FzIGV4cGxpY2l0bHkgcGFzc2VkIHRvIHVzLCBmYWxzZSBhbmQgdW5kZWZpbmVkIC0+IGZhbHNlCgl9OwoKCS8qKgoJKiBJbnRlcm5hbCBzdG9wIGRyYWdnaW5nIG9uIHRoZSBzdGFnZQoJKiBAbWV0aG9kIF9zdG9wRHJhZwoJKiBAcHJpdmF0ZSAKCSogQHBhcmFtIHtjcmVhdGVqcy5Nb3VzZUV2ZW50fSBldiBNb3VzZSB1cCBldmVudAoJKiBAcGFyYW0ge0Jvb2x9IGRvQ2FsbGJhY2sgSWYgd2Ugc2hvdWxkIGRvIHRoZSBjYWxsYmFjawoJKi8KCXAuX3N0b3BEcmFnID0gZnVuY3Rpb24oZXYsIGRvQ2FsbGJhY2spCgl7CgkJdmFyIG9iaiA9IHRoaXMuZHJhZ2dlZE9iajsKCQlvYmoucmVtb3ZlRXZlbnRMaXN0ZW5lcigicHJlc3Ntb3ZlIiwgdGhpcy5fdHJpZ2dlckhlbGREcmFnQ2FsbGJhY2spOwoJCW9iai5yZW1vdmVFdmVudExpc3RlbmVyKCJwcmVzc3VwIiwgdGhpcy5fdHJpZ2dlclN0aWNreUNsaWNrQ2FsbGJhY2spOwoJCXRoaXMuX3RoZVN0YWdlLnJlbW92ZUV2ZW50TGlzdGVuZXIoInN0YWdlbW91c2Vtb3ZlIiwgdGhpcy5fdXBkYXRlQ2FsbGJhY2spOwoJCXRoaXMuX3RoZVN0YWdlLnJlbW92ZUV2ZW50TGlzdGVuZXIoInN0YWdlbW91c2V1cCIsIHRoaXMuX3N0YWdlTW91c2VVcENhbGxiYWNrKTsKCQl0aGlzLmRyYWdnZWRPYmogPSBudWxsOwoJCXRoaXMuaXNUb3VjaE1vdmUgPSBmYWxzZTsKCQl0aGlzLmlzU3RpY2t5Q2xpY2sgPSBmYWxzZTsKCQl0aGlzLmlzSGVsZE1vdmUgPSBmYWxzZTsKCgkJaWYoZG9DYWxsYmFjayAhPT0gZmFsc2UpIC8vIHRydWUgb3IgdW5kZWZpbmVkCgkJCXRoaXMuX2RyYWdFbmRDYWxsYmFjayhvYmopOwoJfTsKCgkvKioKCSogVXBkYXRlIHRoZSBvYmplY3QgcG9zaXRpb24gYmFzZWQgb24gdGhlIG1vdXNlCgkqIEBtZXRob2QgX3VwZGF0ZU9ialBvc2l0aW9uCgkqIEBwcml2YXRlCgkqIEBwYXJhbSB7Y3JlYXRlanMuTW91c2VFdmVudH0gZSBNb3VzZSBtb3ZlIGV2ZW50CgkqLwoJcC5fdXBkYXRlT2JqUG9zaXRpb24gPSBmdW5jdGlvbihlKQoJewoJCWlmKCF0aGlzLmlzVG91Y2hNb3ZlICYmICF0aGlzLl90aGVTdGFnZS5tb3VzZUluQm91bmRzKSByZXR1cm47CgkJCgkJdmFyIGRyYWdnZWRPYmogPSB0aGlzLmRyYWdnZWRPYmo7CgkJdmFyIG1vdXNlUG9zID0gZHJhZ2dlZE9iai5wYXJlbnQuZ2xvYmFsVG9Mb2NhbChlLnN0YWdlWCwgZS5zdGFnZVksIHRoaXMuX2hlbHBlclBvaW50KTsKCQl2YXIgYm91bmRzID0gZHJhZ2dlZE9iai5fZHJhZ0JvdW5kczsKCQlkcmFnZ2VkT2JqLnggPSBjbGFtcChtb3VzZVBvcy54IC0gdGhpcy5fZHJhZ09mZnNldC54LCBib3VuZHMueCwgYm91bmRzLnJpZ2h0KTsKCQlkcmFnZ2VkT2JqLnkgPSBjbGFtcChtb3VzZVBvcy55IC0gdGhpcy5fZHJhZ09mZnNldC55LCBib3VuZHMueSwgYm91bmRzLmJvdHRvbSk7CgkJaWYodGhpcy5zbmFwU2V0dGluZ3MpCgkJewoJCQlzd2l0Y2godGhpcy5zbmFwU2V0dGluZ3MubW9kZSkKCQkJewoJCQkJY2FzZSAicG9pbnRzIjoKCQkJCQl0aGlzLl9oYW5kbGVQb2ludFNuYXAobW91c2VQb3MpOwoJCQkJCWJyZWFrOwoJCQkJY2FzZSAiZ3JpZCI6CgkJCQkJLy9ub3QgeWV0IGltcGxlbWVudGVkCgkJCQkJYnJlYWs7CgkJCQljYXNlICJsaW5lIjoKCQkJCQkvL25vdCB5ZXQgaW1wbGVtZW50ZWQKCQkJCQlicmVhazsKCQkJfQoJCX0KCX07CgoJLyoqCgkqIEhhbmRsZXMgc25hcHBpbmcgdGhlIGRyYWdnZWQgb2JqZWN0IHRvIHRoZSBuZWFyZXN0IGFtb25nIGEgbGlzdCBvZiBwb2ludHMKCSogQG1ldGhvZCBfaGFuZGxlUG9pbnRTbmFwCgkqIEBwcml2YXRlCgkqIEBwYXJhbSB7Y3JlYXRlanMuUG9pbnR9IGxvY2FsTW91c2VQb3MgVGhlIG1vdXNlIHBvc2l0aW9uIGluIHRoZSBzYW1lIHNwYWNlIGFzIHRoZSBkcmFnZ2VkIG9iamVjdC4KCSovCglwLl9oYW5kbGVQb2ludFNuYXAgPSBmdW5jdGlvbihsb2NhbE1vdXNlUG9zKQoJewoJCXZhciBzbmFwU2V0dGluZ3MgPSB0aGlzLnNuYXBTZXR0aW5nczsKCQl2YXIgbWluRGlzdFNxID0gc25hcFNldHRpbmdzLmRpc3QgKiBzbmFwU2V0dGluZ3MuZGlzdDsKCQl2YXIgcG9pbnRzID0gc25hcFNldHRpbmdzLnBvaW50czsKCQl2YXIgb2JqWCA9IGxvY2FsTW91c2VQb3MueCAtIHRoaXMuX2RyYWdPZmZzZXQueDsKCQl2YXIgb2JqWSA9IGxvY2FsTW91c2VQb3MueSAtIHRoaXMuX2RyYWdPZmZzZXQueTsKCQl2YXIgbGVhc3REaXN0ID0gLTE7CgkJdmFyIGNsb3Nlc3RQb2ludCA9IG51bGw7CgkJZm9yKHZhciBpID0gcG9pbnRzLmxlbmd0aCAtIDE7IGkgPj0gMDsgLS1pKQoJCXsKCQkJdmFyIHAgPSBwb2ludHNbaV07CgkJCXZhciBkaXN0U3EgPSBkaXN0U3F1YXJlZChvYmpYLCBvYmpZLCBwLngsIHAueSk7CgkJCWlmKGRpc3RTcSA8PSBtaW5EaXN0U3EgJiYgKGRpc3RTcSA8IGxlYXN0RGlzdCB8fCBsZWFzdERpc3QgPT0gLTEpKQoJCQl7CgkJCQlsZWFzdERpc3QgPSBkaXN0U3E7CgkJCQljbG9zZXN0UG9pbnQgPSBwOwoJCQl9CgkJfQoJCWlmKGNsb3Nlc3RQb2ludCkKCQl7CgkJCXRoaXMuZHJhZ2dlZE9iai54ID0gY2xvc2VzdFBvaW50Lng7CgkJCXRoaXMuZHJhZ2dlZE9iai55ID0gY2xvc2VzdFBvaW50Lnk7CgkJfQoJfTsKCgkvKgoJKiBTbWFsbCBkaXN0YW5jZSBzcXVhcmVkIGZ1bmN0aW9uCgkqLwoJdmFyIGRpc3RTcXVhcmVkID0gZnVuY3Rpb24oeDEsIHkxLCB4MiwgeTIpCgl7CgkJdmFyIHhEaWZmID0geDEgLSB4MjsKCQl2YXIgeURpZmYgPSB5MSAtIHkyOwoJCXJldHVybiB4RGlmZiAqIHhEaWZmICsgeURpZmYgKiB5RGlmZjsKCX07CgkKCS8qCgkqIFNpbXBsZSBjbGFtcCBmdW5jdGlvbgoJKi8KCXZhciBjbGFtcCA9IGZ1bmN0aW9uKHgsYSxiKQoJewoJCXJldHVybiAoeCA8IGEgPyBhIDogKHggPiBiID8gYiA6IHgpKTsKCX07CgkKCS8vPT09IEdpdmluZyBmdW5jdGlvbnMgYW5kIHByb3BlcnRpZXMgdG8gZHJhZ2dhYmxlIG9iamVjdHMgb2JqZWN0cwoJdmFyIGVuYWJsZURyYWcgPSBmdW5jdGlvbigpCgl7CgkJdGhpcy5hZGRFdmVudExpc3RlbmVyKCJtb3VzZWRvd24iLCB0aGlzLl9vbk1vdXNlRG93bkxpc3RlbmVyKTsKCQl0aGlzLmN1cnNvciA9ICJwb2ludGVyIjsKCX07CgkKCXZhciBkaXNhYmxlRHJhZyA9IGZ1bmN0aW9uKCkKCXsKCQl0aGlzLnJlbW92ZUV2ZW50TGlzdGVuZXIoIm1vdXNlZG93biIsIHRoaXMuX29uTW91c2VEb3duTGlzdGVuZXIpOwoJCXRoaXMuY3Vyc29yID0gbnVsbDsKCX07CgkKCXZhciBfb25Nb3VzZURvd24gPSBmdW5jdGlvbihldikKCXsKCQl0aGlzLl9kcmFnTWFuLl9vYmpNb3VzZURvd24oZXYsIHRoaXMpOwoJfTsKCQoJLyoqIAoJKiBBZGRzIHByb3BlcnRpZXMgYW5kIGZ1bmN0aW9ucyB0byB0aGUgb2JqZWN0IC0gdXNlIGVuYWJsZURyYWcoKSBhbmQgZGlzYWJsZURyYWcoKSBvbiAKCSogb2JqZWN0cyB0byBlbmFibGUvZGlzYWJsZSB0aGVtICh0aGV5IHN0YXJ0IG91dCBkaXNhYmxlZCkuIFByb3BlcnRpZXMgYWRkZWQgdG8gb2JqZWN0czoKCSogX2RyYWdCb3VuZHMgKFJlY3RhbmdsZSksIF9vbk1vdXNlRG93bkxpc3RlbmVyIChGdW5jdGlvbiksIF9kcmFnTWFuIChjbG91ZGtpZC5EcmFnTWFuYWdlcikgcmVmZXJlbmNlIHRvIHRoZSBEcmFnTWFuYWdlcgoJKiB0aGVzZSB3aWxsIG92ZXJyaWRlIGFueSBleGlzdGluZyBwcm9wZXJ0aWVzIG9mIHRoZSBzYW1lIG5hbWUKCSogQG1ldGhvZCBhZGRPYmplY3QKCSogQHB1YmxpYwoJKiBAcGFyYW0ge2NyZWF0ZWpzLkRpc3BsYXlPYmplY3R9IG9iaiBUaGUgZGlzcGxheSBvYmplY3QKCSogQHBhcmFtIHtjcmVhdGVqcy5SZWN0YW5nbGV9IGJvdW5kIFRoZSByZWN0YW5nbGUgYm91bmRzCgkqLwoJcC5hZGRPYmplY3QgPSBmdW5jdGlvbihvYmosIGJvdW5kcykKCXsKCQlpZighYm91bmRzKQoJCXsKCQkJYm91bmRzID0ge3g6MCwgeTowLCB3aWR0aDp0aGlzLl90aGVTdGFnZS5jYW52YXMud2lkdGgsIGhlaWdodDp0aGlzLl90aGVTdGFnZS5jYW52YXMuaGVpZ2h0fTsKCQl9CgkJYm91bmRzLnJpZ2h0ID0gYm91bmRzLnggKyBib3VuZHMud2lkdGg7CgkJYm91bmRzLmJvdHRvbSA9IGJvdW5kcy55ICsgYm91bmRzLmhlaWdodDsKCQlvYmouX2RyYWdCb3VuZHMgPSBib3VuZHM7CgkJaWYodGhpcy5fZHJhZ2dhYmxlT2JqZWN0cy5pbmRleE9mKG9iaikgPj0gMCkKCQl7CgkJCS8vZG9uJ3QgY2hhbmdlIGFueSBvZiB0aGUgZnVuY3Rpb25zIG9yIGFueXRoaW5nLCBqdXN0IHF1aXQgdGhlIGZ1bmN0aW9uIGFmdGVyIGhhdmluZyB1cGRhdGVkIHRoZSBib3VuZHMKCQkJcmV0dXJuOwoJCX0KCQlvYmouZW5hYmxlRHJhZyA9IGVuYWJsZURyYWc7CgkJb2JqLmRpc2FibGVEcmFnID0gZGlzYWJsZURyYWc7CgkJb2JqLl9vbk1vdXNlRG93bkxpc3RlbmVyID0gX29uTW91c2VEb3duLmJpbmQob2JqKTsKCQlvYmouX2RyYWdNYW4gPSB0aGlzOwoJCXRoaXMuX2RyYWdnYWJsZU9iamVjdHMucHVzaChvYmopOwoJfTsKCQoJLyoqIAoJKiBSZW1vdmVzIHByb3BlcnRpZXMgYW5kIGZ1bmN0aW9ucyBhZGRlZCBieSBhZGRPYmplY3QoKS4KCSogQHB1YmxpYwoJKiBAbWV0aG9kIHJlbW92ZU9iamVjdAoJKiBAcGFyYW0ge2NyZWF0ZWpzLkRpc3BsYXlPYmplY3R9IG9iaiBUaGUgZGlzcGxheSBvYmplY3QKCSovCglwLnJlbW92ZU9iamVjdCA9IGZ1bmN0aW9uKG9iaikKCXsKCQlvYmouZGlzYWJsZURyYWcoKTsKCQlkZWxldGUgb2JqLmVuYWJsZURyYWc7CgkJZGVsZXRlIG9iai5kaXNhYmxlRHJhZzsKCQlkZWxldGUgb2JqLl9vbk1vdXNlRG93bkxpc3RlbmVyOwoJCWRlbGV0ZSBvYmouX2RyYWdNYW47CgkJZGVsZXRlIG9iai5fZHJhZ0JvdW5kczsKCQl2YXIgaW5kZXggPSB0aGlzLl9kcmFnZ2FibGVPYmplY3RzLmluZGV4T2Yob2JqKTsKCQlpZihpbmRleCA+PSAwKQoJCQl0aGlzLl9kcmFnZ2FibGVPYmplY3RzLnNwbGljZShpbmRleCwgMSk7Cgl9OwoJCgkvKioKCSogIERlc3Ryb3kgdGhlIG1hbmFnZXIKCSogIEBwdWJsaWMKCSogIEBtZXRob2QgZGVzdHJveQoJKi8KCXAuZGVzdHJveSA9IGZ1bmN0aW9uKCkKCXsKCQlpZih0aGlzLmRyYWdnZWRPYmogIT09IG51bGwpCgkJewoJCQkvL2NsZWFuIHVwIGRyYWdnZWQgb2JqCgkJCXRoaXMuZHJhZ2dlZE9iai5yZW1vdmVFdmVudExpc3RlbmVyKCJwcmVzc21vdmUiLCB0aGlzLl90cmlnZ2VySGVsZERyYWdDYWxsYmFjayk7CgkJCXRoaXMuZHJhZ2dlZE9iai5yZW1vdmVFdmVudExpc3RlbmVyKCJwcmVzc3VwIiwgdGhpcy5fdHJpZ2dlclN0aWNreUNsaWNrQ2FsbGJhY2spOwoJCQl0aGlzLl90aGVTdGFnZS5yZW1vdmVFdmVudExpc3RlbmVyKCJzdGFnZW1vdXNlbW92ZSIsIHRoaXMuX3VwZGF0ZUNhbGxiYWNrKTsKCQkJdGhpcy5kcmFnZ2VkT2JqID0gbnVsbDsKCQl9CgkJdGhpcy5fdXBkYXRlQ2FsbGJhY2sgPSBudWxsOwoJCXRoaXMuX2RyYWdTdGFydENhbGxiYWNrID0gbnVsbDsKCQl0aGlzLl9kcmFnRW5kQ2FsbGJhY2sgPSBudWxsOwoJCXRoaXMuX3RyaWdnZXJIZWxkRHJhZ0NhbGxiYWNrID0gbnVsbDsKCQl0aGlzLl90cmlnZ2VyU3RpY2t5Q2xpY2tDYWxsYmFjayA9IG51bGw7CgkJdGhpcy5fc3RhZ2VNb3VzZVVwQ2FsbGJhY2sgPSBudWxsOwoJCXRoaXMuX3RoZVN0YWdlID0gbnVsbDsKCQlmb3IodmFyIGkgPSB0aGlzLl9kcmFnZ2FibGVPYmplY3RzLmxlbmd0aCAtIDE7IGkgPj0gMDsgLS1pKQoJCXsKCQkJdmFyIG9iaiA9IHRoaXMuX2RyYWdnYWJsZU9iamVjdHNbaV07CgkJCW9iai5kaXNhYmxlRHJhZygpOwoJCQlkZWxldGUgb2JqLmVuYWJsZURyYWc7CgkJCWRlbGV0ZSBvYmouZGlzYWJsZURyYWc7CgkJCWRlbGV0ZSBvYmouX29uTW91c2VEb3duTGlzdGVuZXI7CgkJCWRlbGV0ZSBvYmouX2RyYWdNYW47CgkJCWRlbGV0ZSBvYmouX2RyYWdCb3VuZHM7CgkJfQoJCXRoaXMuX2RyYWdnYWJsZU9iamVjdHMgPSBudWxsOwoJCXRoaXMuX2hlbHBlclBvaW50ID0gbnVsbDsKCX07CgkKCS8qKiBBc3NpZ24gdG8gdGhlIGdsb2JhbCBuYW1lc3BhY2UgKi8KCW5hbWVzcGFjZSgnY2xvdWRraWQnKS5EcmFnTWFuYWdlciA9IERyYWdNYW5hZ2VyOwp9KCkpOwooZnVuY3Rpb24oKSB7CgkKCSJ1c2Ugc3RyaWN0IjsKCQoJLyoqCgkqICBJbml0aWFsbHkgbGF5b3V0cyBhbGwgaW50ZXJmYWNlIGVsZW1lbnRzCgkqICBAbW9kdWxlIGNsb3Vka2lkCgkqICBAY2xhc3MgUG9zaXRpb25lcgoJKi8KCXZhciBQb3NpdGlvbmVyID0gZnVuY3Rpb24oKXt9OwoJCgkvLyBTZXQgdGhlIHByb3R5cGUKCVBvc2l0aW9uZXIucHJvdG90eXBlID0ge307CgkKCS8qKgoJKiAgSW5pdGlhbCBwb3NpdGlvbiBvZiBhbGwgbGF5b3V0IGl0ZW1zCgkqICBAbWV0aG9kIHBvc2l0aW9uSXRlbXMKCSogIEBzdGF0aWMKCSogIEBwYXJhbSB7Y3JlYXRlanMuRGlzcGxheU9iamVjdHxQSVhJLkRpc3BsYXlPYmplY3R9IHBhcmVudAoJKiAgQHBhcmFtIHtPYmplY3R9IGl0ZW1TZXR0aW5ncyBKU09OIGZvcm1hdCB3aXRoIHBvc2l0aW9uIGluZm9ybWF0aW9uCgkqLwoJUG9zaXRpb25lci5wb3NpdGlvbkl0ZW1zID0gZnVuY3Rpb24ocGFyZW50LCBpdGVtU2V0dGluZ3MpCgl7CgkJdmFyIHJvdCwgcHQsIGRlZ1RvUmFkOwoJCWlmKGZhbHNlKQoJCQlkZWdUb1JhZCA9IE1hdGguUEkgLyAxODA7CgkJZm9yKHZhciBpTmFtZSBpbiBpdGVtU2V0dGluZ3MpCgkJewoJCQl2YXIgaXRlbSA9IHBhcmVudFtpTmFtZV07CgkJCWlmKCFpdGVtKQoJCQl7CgkJCQlEZWJ1Zy5lcnJvcigiY291bGQgbm90IGZpbmQgb2JqZWN0ICciICsgIGlOYW1lICsgIiciKTsKCQkJCWNvbnRpbnVlOwoJCQl9CgkJCXZhciBzZXR0aW5nID0gaXRlbVNldHRpbmdzW2lOYW1lXTsKCQkJaWYoZmFsc2UpCgkJCXsKCQkJCWl0ZW0ucG9zaXRpb24ueCA9IHNldHRpbmcueDsKCQkJCWl0ZW0ucG9zaXRpb24ueSA9IHNldHRpbmcueTsKCQkJCXB0ID0gc2V0dGluZy5zY2FsZTsKCQkJCWlmKHB0KQoJCQkJewoJCQkJCWl0ZW0uc2NhbGUueCAqPSBwdC54OwoJCQkJCWl0ZW0uc2NhbGUueSAqPSBwdC55OwoJCQkJfQoJCQkJcHQgPSBzZXR0aW5nLnBpdm90OwoJCQkJaWYocHQpCgkJCQl7CgkJCQkJaXRlbS5waXZvdC54ID0gcHQueDsKCQkJCQlpdGVtLnBpdm90LnkgPSBwdC55OwoJCQkJfQoJCQkJcm90ID0gc2V0dGluZy5yb3RhdGlvbjsKCQkJCWlmKHJvdCkKCQkJCQlpdGVtLnJvdGF0aW9uID0gcm90ICogZGVnVG9SYWQ7Ly9QaXhpIHJvdGF0aW9ucyBhcmUgaW4gcmFkaWFucwoJCQl9CgkJCWVsc2UKCQkJewoJCQkJaXRlbS54ID0gc2V0dGluZy54OwoJCQkJaXRlbS55ID0gc2V0dGluZy55OwoJCQkJcHQgPSBzZXR0aW5nLnNjYWxlOwoJCQkJaWYocHQpCgkJCQl7CgkJCQkJaXRlbS5zY2FsZVggKj0gcHQueDsKCQkJCQlpdGVtLnNjYWxlWSAqPSBwdC55OwoJCQkJfQoJCQkJcHQgPSBzZXR0aW5nLnBpdm90OwoJCQkJaWYocHQpCgkJCQl7CgkJCQkJaXRlbS5yZWdYID0gcHQueDsKCQkJCQlpdGVtLnJlZ1kgPSBwdC55OwoJCQkJfQoJCQkJcm90ID0gc2V0dGluZy5yb3RhdGlvbjsKCQkJCWlmKHJvdCkKCQkJCQlpdGVtLnJvdGF0aW9uID0gcm90OwoJCQl9CgkJCS8vaXRlbS5uYW1lID0gaU5hbWU7CgkJCWlmKHNldHRpbmcuaGl0QXJlYSkKCQkJewoJCQkJdmFyIGhpdEFyZWEgPSBzZXR0aW5nLmhpdEFyZWE7CgkJCQlpZihmYWxzZSkKCQkJCXsKCQkJCQlpdGVtLmhpdEFyZWEgPSBQb3NpdGlvbmVyLmdlbmVyYXRlSGl0QXJlYShoaXRBcmVhKTsKCQkJCX0KCQkJCWVsc2UKCQkJCXsKCQkJCQlpdGVtLmhpdFNoYXBlID0gUG9zaXRpb25lci5nZW5lcmF0ZUhpdEFyZWEoaGl0QXJlYSk7CgkJCQl9CgkJCX0KCQl9Cgl9OwoJCgkvKioKCSogIENyZWF0ZSB0aGUgcG9seWdvbiBoaXQgYXJlYSBmb3IgaW50ZXJmYWNlIGVsZW1lbnRzCgkqICBAc3RhdGljCgkqICBAbWV0aG9kIGdlbmVyYXRlSGl0QXJlYQoJKiAgQHBhcmFtIHtPYmplY3R8QXJyYXl9IGhpdEFyZWEgT25lIG9mIHRoZSBmb2xsb3dpbmc6IDxici8+CgkqICAqIEFuIGFycmF5IG9mIHBvaW50cyBmb3IgYSBwb2x5Z29uLCBlLmcuIAoJKgoJKgkJW3t4OjAsIHk6MH0sIHt4OjAsIHk6MjB9LCB7eDoyMCwgeTowfV0KCSoKCSogICogQW4gb2JqZWN0IGRlc2NyaWJpbmcgYSByZWN0YW5nbGUsIGUuZy4KCSoKCSoJCXt0eXBlOiJyZWN0IiwgeDowLCB5OjAsIHc6MTAsIGg6MzB9CgkqCgkqICAqIEFuIG9iamVjdCBkZXNjcmliaW5nIGFuIGVsbGlwc2UsIHdoZXJlIHggYW5kIHkgYXJlIHRoZSBjZW50ZXIsIGUuZy4gCgkqCgkqCQl7dHlwZToiZWxsaXBzZSIsIHg6MCwgeTowLCB3OjEwLCBoOjMwfQoJKgoJKiAgKiBBbiBvYmplY3QgZGVzY3JpYmluZyBhIGNpcmNsZSwgd2hlcmUgeCBhbmQgeSBhcmUgdGhlIGNlbnRlciwgZS5nLgoJKgoJKgkJe3R5cGU6ImNpcmNsZSIsIHg6MCwgeTowLCByOjIwfQoJKiAgQHBhcmFtIHtOdW1iZXJ9IHNjYWxlPTEgVGhlIHNpemUgdG8gc2NhbGUgaGl0QXJlYSBieQoJKiAgQHJldHVybiB7T2JqZWN0fSBBIGdlb21ldHJpYyBzaGFwZSBvYmplY3QgZm9yIGhpdCB0ZXN0aW5nLCBlaXRoZXIgYSBQb2x5Z29uLCBSZWN0YW5nbGUsIEVsbGlwc2UsIG9yIENpcmNsZSwKCSogICAgICBkZXBlbmRpbmcgb24gdGhlIGhpdEFyZWEgb2JqZWN0LiBUaGUgc2hhcGUgd2lsbCBoYXZlIGEgY29udGFpbnMoKSBmdW5jdGlvbiBmb3IgaGl0IHRlc3RpbmcuCgkqLwoJUG9zaXRpb25lci5nZW5lcmF0ZUhpdEFyZWEgPSBmdW5jdGlvbihoaXRBcmVhLCBzY2FsZSkKCXsKCQlpZighc2NhbGUpCgkJCXNjYWxlID0gMTsKCQl2YXIgbGlicmFyeTsKCQlpZihmYWxzZSkKCQkJbGlicmFyeSA9IHdpbmRvdy5QSVhJOwoJCWVsc2UKCQkJbGlicmFyeSA9IHdpbmRvdy5jcmVhdGVqczsKCQlpZihpc0FycmF5KGhpdEFyZWEpKQoJCXsKCQkJaWYoc2NhbGUgPT0gMSkKCQkJCXJldHVybiBuZXcgbGlicmFyeS5Qb2x5Z29uKGhpdEFyZWEpOwoJCQllbHNlCgkJCXsKCQkJCXZhciB0ZW1wID0gW107CgkJCQlmb3IodmFyIGkgPSAwLCBsZW4gPSBoaXRBcmVhLmxlbmd0aDsgaSA8IGxlbjsgKytpKQoJCQkJewoJCQkJCXRlbXAucHVzaChuZXcgbGlicmFyeS5Qb2ludChoaXRBcmVhW2ldLnggKiBzY2FsZSwgaGl0QXJlYVtpXS55ICogc2NhbGUpKTsKCQkJCX0KCQkJCXJldHVybiBuZXcgbGlicmFyeS5Qb2x5Z29uKHRlbXApOwoJCQl9CgkJfQoJCWVsc2UgaWYoaGl0QXJlYS50eXBlID09ICJyZWN0IiB8fCAhaGl0QXJlYS50eXBlKQoJCQlyZXR1cm4gbmV3IGxpYnJhcnkuUmVjdGFuZ2xlKGhpdEFyZWEueCAqIHNjYWxlLCBoaXRBcmVhLnkgKiBzY2FsZSwgaGl0QXJlYS53ICogc2NhbGUsIGhpdEFyZWEuaCAqIHNjYWxlKTsKCQllbHNlIGlmKGhpdEFyZWEudHlwZSA9PSAiZWxsaXBzZSIpCgkJCXJldHVybiBuZXcgbGlicmFyeS5FbGxpcHNlKChoaXRBcmVhLnggLSBoaXRBcmVhLncgKiAwLjUpICogc2NhbGUsIChoaXRBcmVhLnkgLSBoaXRBcmVhLmggKiAwLjUpICogc2NhbGUsIGhpdEFyZWEudyAqIHNjYWxlLCBoaXRBcmVhLmggKiBzY2FsZSk7Ly9jb252ZXJ0IGNlbnRlciB0byB1cHBlciBsZWZ0IGNvcm5lcgoJCWVsc2UgaWYoaGl0QXJlYS50eXBlID09ICJjaXJjbGUiKQoJCQlyZXR1cm4gbmV3IGxpYnJhcnkuQ2lyY2xlKGhpdEFyZWEueCAqIHNjYWxlLCBoaXRBcmVhLnkgKiBzY2FsZSwgaGl0QXJlYS5yICogc2NhbGUpOy8veCAmIHkgYXJlIGNlbnRlciwgcGl4aSBkb2N1bWVudGF0aW9uIGxpZXMKCQllbHNlIGlmKGhpdEFyZWEudHlwZSA9PSAic2VjdG9yIikKCQkJcmV0dXJuIG5ldyBsaWJyYXJ5LlNlY3RvcihoaXRBcmVhLnggKiBzY2FsZSwgaGl0QXJlYS55ICogc2NhbGUsIGhpdEFyZWEuciAqIHNjYWxlLCBoaXRBcmVhLnN0YXJ0LCBoaXRBcmVhLmVuZCk7CgkJcmV0dXJuIG51bGw7Cgl9OwoKCXZhciBpc0FycmF5ID0gZnVuY3Rpb24obykKCXsKCQlyZXR1cm4gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKG8pID09PSAnW29iamVjdCBBcnJheV0nOwoJfTsKCQoJbmFtZXNwYWNlKCdjbG91ZGtpZCcpLlBvc2l0aW9uZXIgPSBQb3NpdGlvbmVyOwp9KCkpOwooZnVuY3Rpb24oKSB7CgkKCSJ1c2Ugc3RyaWN0IjsKCgkvKioKCSogICBPYmplY3QgdGhhdCBjb250YWlucyB0aGUgc2NyZWVuIHNldHRpbmdzIHRvIGhlbHAgc2NhbGluZwoJKiAgIEBtb2R1bGUgY2xvdWRraWQKCSogICBAY2xhc3MgU2NyZWVuU2V0dGluZ3MKCSogICBAY29uc3RydWN0b3IKCSogICBAcGFyYW0ge051bWJlcn0gd2lkdGggVGhlIHNjcmVlbiB3aWR0aCBpbiBwaXhlbHMKCSogICBAcGFyYW0ge051bWJlcn0gaGVpZ2h0IFRoZSBzY3JlZW4gaGVpZ2h0IGluIHBpeGVscwoJKiAgIEBwYXJhbSB7TnVtYmVyfSBwcGkgVGhlIHNjcmVlbiBwaXhlbCBkZW5zaXR5IChQUEkpCgkqLwoJdmFyIFNjcmVlblNldHRpbmdzID0gZnVuY3Rpb24od2lkdGgsIGhlaWdodCwgcHBpKQoJewoJCS8qKgoJCSogIFRoZSBzY3JlZW4gd2lkdGggaW4gcGl4ZWxzCgkJKiAgQHByb3BlcnR5IHtOdW1iZXJ9IHdpZHRoIAoJCSovCgkJdGhpcy53aWR0aCA9IHdpZHRoOwoKCQkvKioKCQkqICBUaGUgc2NyZWVuIGhlaWdodCBpbiBwaXhlbHMKCQkqICBAcHJvcGVydHkge051bWJlcn0gaGVpZ2h0IAoJCSovCgkJdGhpcy5oZWlnaHQgPSBoZWlnaHQ7CgoJCS8qKgoJCSogIFRoZSBzY3JlZW4gcGl4ZWwgZGVuc2l0eSAoUFBJKQoJCSogIEBwcm9wZXJ0eSB7TnVtYmVyfSBwcGkKCQkqLwoJCXRoaXMucHBpID0gcHBpOwoJfTsKCQoJLy8gU2V0IHRoZSBwcm90b3R5cGUKCVNjcmVlblNldHRpbmdzLnByb3RvdHlwZSA9IHt9OwoJCgkvLyBBc3NpZ24gdG8gbmFtZXNwYWNlCgluYW1lc3BhY2UoJ2Nsb3Vka2lkJykuU2NyZWVuU2V0dGluZ3MgPSBTY3JlZW5TZXR0aW5nczsKCn0oKSk7CihmdW5jdGlvbigpIHsKCgkidXNlIHN0cmljdCI7CgoJLy8gQ2xhc3MgaW1wb3J0cwoJdmFyIFVJU2NhbGVyOwoKCS8qKgoJKiAgIEEgc2luZ2xlIFVJIGl0ZW0gdGhhdCBuZWVkcyB0byBiZSByZXNpemVkCQoJKgoJKiAgIEBtb2R1bGUgY2xvdWRraWQKCSogICBAY2xhc3MgVUlFbGVtZW50CgkqCUBwYXJhbSB7Y3JlYXRlanMuRGlzcGxheU9iamVjdHxQSVhJLkRpc3BsYXlPYmplY3R9IGl0ZW0gVGhlIGl0ZW0gdG8gYWZmZWN0ICAKCSogICBAcGFyYW0ge1VJRWxlbWVudFNldHRpbmdzfSBzZXR0aW5ncyBUaGUgc2NhbGUgc2V0dGluZ3MKCSoJQHBhcmFtIHtTY3JlZW5TZXR0aW5nc30gZGVzaWduZWRTY3JlZW4gVGhlIG9yaWdpbmFsIHNjcmVlbiB0aGUgaXRlbSB3YXMgZGVzaWduZWQgZm9yCgkqLwoJdmFyIFVJRWxlbWVudCA9IGZ1bmN0aW9uKGl0ZW0sIHNldHRpbmdzLCBkZXNpZ25lZFNjcmVlbikKCXsKCQlVSVNjYWxlciA9IGNsb3Vka2lkLlVJU2NhbGVyOwoJCQoJCXRoaXMuX2l0ZW0gPSBpdGVtOwkJCQoJCXRoaXMuX3NldHRpbmdzID0gc2V0dGluZ3M7CgkJdGhpcy5fZGVzaWduZWRTY3JlZW4gPSBkZXNpZ25lZFNjcmVlbjsKCQkKCQlpZihmYWxzZSkKCQl7CgkJCXRoaXMub3JpZ1NjYWxlWCA9IGl0ZW0uc2NhbGUueDsJCgkJCXRoaXMub3JpZ1NjYWxlWSA9IGl0ZW0uc2NhbGUueTsKCQl9CgkJZWxzZQoJCXsKCQkJdGhpcy5vcmlnU2NhbGVYID0gaXRlbS5zY2FsZVg7CgkJCXRoaXMub3JpZ1NjYWxlWSA9IGl0ZW0uc2NhbGVZOwoJCX0KCgkJdGhpcy5vcmlnV2lkdGggPSBpdGVtLndpZHRoOwoKCQl0aGlzLm9yaWdCb3VuZHMgPSB7eDowLCB5OjAsIHdpZHRoOml0ZW0ud2lkdGgsIGhlaWdodDppdGVtLmhlaWdodH07CgkJdGhpcy5vcmlnQm91bmRzLnJpZ2h0ID0gdGhpcy5vcmlnQm91bmRzLnggKyB0aGlzLm9yaWdCb3VuZHMud2lkdGg7CgkJdGhpcy5vcmlnQm91bmRzLmJvdHRvbSA9IHRoaXMub3JpZ0JvdW5kcy55ICsgdGhpcy5vcmlnQm91bmRzLmhlaWdodDsKCQkKCQlzd2l0Y2goc2V0dGluZ3MudmVydEFsaWduKQoJCXsKCQkJY2FzZSBVSVNjYWxlci5BTElHTl9UT1A6CgkJCXsKCQkJCWlmKGZhbHNlKQoJCQkJCXRoaXMub3JpZ01hcmdpblZlcnQgPSBpdGVtLnBvc2l0aW9uLnkgKyB0aGlzLm9yaWdCb3VuZHMueTsKCQkJCWVsc2UKCQkJCQl0aGlzLm9yaWdNYXJnaW5WZXJ0ID0gaXRlbS55ICsgdGhpcy5vcmlnQm91bmRzLnk7CgkJCQlicmVhazsKCQkJfQoJCQljYXNlIFVJU2NhbGVyLkFMSUdOX0NFTlRFUjoKCQkJewoJCQkJaWYoZmFsc2UpCgkJCQkJdGhpcy5vcmlnTWFyZ2luVmVydCA9IGRlc2lnbmVkU2NyZWVuLmhlaWdodCAqIDAuNSAtIGl0ZW0ucG9zaXRpb24ueTsKCQkJCWVsc2UKCQkJCQl0aGlzLm9yaWdNYXJnaW5WZXJ0ID0gZGVzaWduZWRTY3JlZW4uaGVpZ2h0ICogMC41IC0gaXRlbS55OwoJCQkJYnJlYWs7CgkJCX0KCQkJY2FzZSBVSVNjYWxlci5BTElHTl9CT1RUT006CgkJCXsKCQkJCWlmKGZhbHNlKQoJCQkJCXRoaXMub3JpZ01hcmdpblZlcnQgPSBkZXNpZ25lZFNjcmVlbi5oZWlnaHQgLSAoaXRlbS5wb3NpdGlvbi55ICsgdGhpcy5vcmlnQm91bmRzLmJvdHRvbSk7CgkJCQllbHNlCgkJCQkJdGhpcy5vcmlnTWFyZ2luVmVydCA9IGRlc2lnbmVkU2NyZWVuLmhlaWdodCAtIChpdGVtLnkgKyB0aGlzLm9yaWdCb3VuZHMuYm90dG9tKTsKCQkJCWJyZWFrOwoJCQl9CgkJfQoKCQlzd2l0Y2goc2V0dGluZ3MuaG9yaUFsaWduKQoJCXsKCQkJY2FzZSBVSVNjYWxlci5BTElHTl9MRUZUOgoJCQl7CgkJCQlpZihmYWxzZSkKCQkJCQl0aGlzLm9yaWdNYXJnaW5Ib3JpID0gaXRlbS5wb3NpdGlvbi54ICsgdGhpcy5vcmlnQm91bmRzLng7CgkJCQllbHNlCgkJCQkJdGhpcy5vcmlnTWFyZ2luSG9yaSA9IGl0ZW0ueCArIHRoaXMub3JpZ0JvdW5kcy54OwoJCQkJYnJlYWs7CgkJCX0KCQkJY2FzZSBVSVNjYWxlci5BTElHTl9DRU5URVI6CgkJCXsKCQkJCWlmKGZhbHNlKQoJCQkJCXRoaXMub3JpZ01hcmdpbkhvcmkgPSBkZXNpZ25lZFNjcmVlbi53aWR0aCAqIDAuNSAtIGl0ZW0ucG9zaXRpb24ueDsKCQkJCWVsc2UKCQkJCQl0aGlzLm9yaWdNYXJnaW5Ib3JpID0gZGVzaWduZWRTY3JlZW4ud2lkdGggKiAwLjUgLSBpdGVtLng7CgkJCQlicmVhazsKCQkJfQoJCQljYXNlIFVJU2NhbGVyLkFMSUdOX1JJR0hUOgoJCQl7CgkJCQlpZihmYWxzZSkKCQkJCQl0aGlzLm9yaWdNYXJnaW5Ib3JpID0gZGVzaWduZWRTY3JlZW4ud2lkdGggLSAoaXRlbS5wb3NpdGlvbi54ICsgdGhpcy5vcmlnQm91bmRzLnJpZ2h0KTsKCQkJCWVsc2UKCQkJCQl0aGlzLm9yaWdNYXJnaW5Ib3JpID0gZGVzaWduZWRTY3JlZW4ud2lkdGggLSAoaXRlbS54ICsgdGhpcy5vcmlnQm91bmRzLnJpZ2h0KTsKCQkJCWJyZWFrOwoJCQl9CgkJfQoJfTsKCQoJdmFyIHAgPSBVSUVsZW1lbnQucHJvdG90eXBlID0ge307CgoJLyoqCgkqICBPcmlnaW5hbCBob3Jpem9udGFsIG1hcmdpbiBpbiBwaXhlbHMKCSogIEBwcm9wZXJ0eSB7TnVtYmVyfSBvcmlnTWFyZ2luSG9yaQoJKiAgQGRlZmF1bHQgMAoJKi8KCXAub3JpZ01hcmdpbkhvcmkgPSAwOwoKCS8qKgoJKiAgT3JpZ2luYWwgdmVydGljYWwgbWFyZ2luIGluIHBpeGVscwoJKiAgQHByb3BlcnR5IHtOdW1iZXJ9IG9yaWdNYXJnaW5WZXJ0CgkqICBAZGVmYXVsdCAwCgkqLwoJcC5vcmlnTWFyZ2luVmVydCA9IDA7CgoJLyoqIAoJKiAgT3JpZ2luYWwgd2lkdGggaW4gcGl4ZWxzIAoJKiAgQHByb3BlcnR5IHtOdW1iZXJ9IG9yaWdXaWR0aAoJKiAgQGRlZmF1bHQgMAoJKi8KCXAub3JpZ1dpZHRoID0gMDsKCgkvKioKCSogIE9yaWdpbmFsIFggc2NhbGUgb2YgdGhlIGl0ZW0KCSogIEBwcm9wZXJ0eSB7TnVtYmVyfSBvcmlnU2NhbGVYCgkqICBAZGVmYXVsdCAwCgkqLwoJcC5vcmlnU2NhbGVYID0gMDsKCgkvKioKCSogIFRoZSBvcmlnaW5hbCBZIHNjYWxlIG9mIHRoZSBpdGVtCgkqICBAcHJvcGVydHkge051bWJlcn0gb3JpZ1NjYWxlWQoJKiAgQGRlZmF1bHQgMAoJKi8KCXAub3JpZ1NjYWxlWSA9IDA7CgoJLyoqCgkqICBUaGUgb3JpZ2luYWwgYm91bmRzIG9mIHRoZSBpdGVtIHdpdGggeCwgeSwgcmlnaHQsIGJvdHRvbSwgd2lkdGgsIGhlaWdodCBwcm9wZXJ0aWVzLgoJKiAgVXNlZCB0byBkZXRlcm1pbmUgdGhlIGRpc3RhbmNlIHRvIGVhY2ggZWRnZSBvZiB0aGUgaXRlbSBmcm9tIGl0cyBvcmlnaW4KCSogIEBwcm9wZXJ0eSB7T2JqZWN0fSBvcmlnQm91bmRzCgkqLwoJcC5vcmlnQm91bmRzID0gbnVsbDsKCgkvKioKCSogIFRoZSByZWZlcmVuY2UgdG8gdGhlIHNjYWxlIHNldHRpbmdzCgkqICBAcHJpdmF0ZQoJKiAgQHByb3BlcnR5IHtVSUVsZW1lbnRTZXR0aW5nc30gX3NldHRpbmdzCgkqLwkKCXAuX3NldHRpbmdzID0gbnVsbDsKCQoJLyoqCgkqICBUaGUgcmVmZXJlbmNlIHRvIHRoZSBpbnRlcmZhY2UgaXRlbSB3ZSdyZSBzY2FsaW5nCgkqICBAcHJpdmF0ZQoJKiAgQHByb3BlcnR5IHtjcmVhdGVqcy5EaXNwbGF5T2JqZWN0fFBJWEkuRGlzcGxheU9iamVjdH0gX2l0ZW0KCSovCglwLl9pdGVtID0gbnVsbDsKCQoJLyoqCgkqICBUaGUgb3JpZ2luYWwgc2NyZWVuIHRoZSBpdGVtIHdhcyBkZXNpZ25lZCBmb3IKCSogIEBwcml2YXRlCgkqICBAcHJvcGVydHkge1NjcmVlblNldHRpbmdzfSBfZGVzaWduZWRTY3JlZW4KCSovCglwLl9kZXNpZ25lZFNjcmVlbiA9IG51bGw7CgkKCS8qKgoJKiAgQWRqdXN0IHRoZSBpdGVtIHNjYWxlIGFuZCBwb3NpdGlvbiwgdG8gcmVmbGVjdCBuZXcgc2NyZWVuCgkqICBAbWV0aG9kIHJlc2l6ZQoJKiAgQHBhcmFtIHtTY3JlZW5TZXR0aW5nc30gbmV3U2NyZWVuIFRoZSBjdXJyZW50IHNjcmVlbiBzZXR0aW5ncwoJKi8KCXAucmVzaXplID0gZnVuY3Rpb24obmV3U2NyZWVuKQoJewoJCXZhciBvdmVyYWxsU2NhbGUgPSBuZXdTY3JlZW4uaGVpZ2h0IC8gdGhpcy5fZGVzaWduZWRTY3JlZW4uaGVpZ2h0OwoJCXZhciBwcGlTY2FsZSA9IG5ld1NjcmVlbi5wcGkgLyB0aGlzLl9kZXNpZ25lZFNjcmVlbi5wcGk7CgkJdmFyIGxldHRlckJveFdpZHRoID0gKG5ld1NjcmVlbi53aWR0aCAtIHRoaXMuX2Rlc2lnbmVkU2NyZWVuLndpZHRoICogb3ZlcmFsbFNjYWxlKSAvIDI7CgoJCS8vIFNjYWxlIGl0ZW0gdG8gdGhlIG92ZXJhbGxTY2FsZSB0byBtYXRjaCByZXN0IG9mIHRoZSBhcHAsIAoJCS8vIHRoZW4gY2xhbXAgaXRzIHBoeXNpY2FsIHNpemUgYXMgc3BlY2lmaWVkIAoJCS8vIHRoZW4gc2V0IHRoZSBpdGVtJ3Mgc2NhbGUgdG8gYmUgY29ycmVjdCAtIHRoZSBzY3JlZW4gaXMgbm90IHNjYWxlZAoKCQkvL0Z1bGwgbWF0aDoKCQkvKnZhciBwaHlzaWNhbFNjYWxlOk51bWJlciA9IG92ZXJhbGxTY2FsZSAvIHBwaVNjYWxlOwoJCXZhciBpdGVtU2NhbGU6TnVtYmVyID0gTWF0aFV0aWxzLmNsYW1wKHBoeXNpY2FsU2NhbGUsIG1pblNjYWxlLCBtYXhTY2FsZSkgLyBwaHlzaWNhbFNjYWxlICogb3ZlcmFsbFNjYWxlOyovCgoJCS8vT3B0aW1pemVkIG1hdGg6CgkJdmFyIGl0ZW1TY2FsZSA9IG92ZXJhbGxTY2FsZSAvIHBwaVNjYWxlOwoJCWlmKHRoaXMuX3NldHRpbmdzLm1pblNjYWxlICYmIGl0ZW1TY2FsZSA8IHRoaXMuX3NldHRpbmdzLm1pblNjYWxlKQoJCQlpdGVtU2NhbGUgPSB0aGlzLl9zZXR0aW5ncy5taW5TY2FsZTsKCQllbHNlIGlmKHRoaXMuX3NldHRpbmdzLm1heFNjYWxlICYmIGl0ZW1TY2FsZSA+IHRoaXMuX3NldHRpbmdzLm1heFNjYWxlKQoJCQlpdGVtU2NhbGUgPSB0aGlzLl9zZXR0aW5ncy5tYXhTY2FsZTsKCQlpdGVtU2NhbGUgKj0gcHBpU2NhbGU7CgoJCWlmKGZhbHNlKQoJCXsKCQkJdGhpcy5faXRlbS5zY2FsZS54ID0gdGhpcy5vcmlnU2NhbGVYICogaXRlbVNjYWxlOwoJCQl0aGlzLl9pdGVtLnNjYWxlLnkgPSB0aGlzLm9yaWdTY2FsZVkgKiBpdGVtU2NhbGU7CgkJfQoJCWVsc2UKCQl7CgkJCXRoaXMuX2l0ZW0uc2NhbGVYID0gdGhpcy5vcmlnU2NhbGVYICogaXRlbVNjYWxlOwoJCQl0aGlzLl9pdGVtLnNjYWxlWSA9IHRoaXMub3JpZ1NjYWxlWSAqIGl0ZW1TY2FsZTsKCQl9CgoJCS8vIHBvc2l0aW9uaW5nCgkJdmFyIG07CgoJCS8vIHZlcnRpY2FsIG1vdmUKCQltID0gdGhpcy5vcmlnTWFyZ2luVmVydCAqIG92ZXJhbGxTY2FsZTsKCQkKCQkKCQlzd2l0Y2godGhpcy5fc2V0dGluZ3MudmVydEFsaWduKQoJCXsKCQkJY2FzZSBVSVNjYWxlci5BTElHTl9UT1A6CgkJCXsKCQkJCWlmKGZhbHNlKQoJCQkJCXRoaXMuX2l0ZW0ucG9zaXRpb24ueSA9IG0gLSB0aGlzLm9yaWdCb3VuZHMueSAqIGl0ZW1TY2FsZTsKCQkJCWVsc2UKCQkJCQl0aGlzLl9pdGVtLnkgPSBtIC0gdGhpcy5vcmlnQm91bmRzLnkgKiBpdGVtU2NhbGU7CgkJCQlicmVhazsKCQkJfQoJCQljYXNlIFVJU2NhbGVyLkFMSUdOX0NFTlRFUjoKCQkJewoJCQkJaWYoZmFsc2UpCgkJCQkJdGhpcy5faXRlbS5wb3NpdGlvbi55ID0gbmV3U2NyZWVuLmhlaWdodCAqIDAuNSAtIG07CgkJCQllbHNlCgkJCQkJdGhpcy5faXRlbS55ID0gbmV3U2NyZWVuLmhlaWdodCAqIDAuNSAtIG07CgkJCQlicmVhazsKCQkJfQoJCQljYXNlIFVJU2NhbGVyLkFMSUdOX0JPVFRPTToKCQkJewoJCQkJaWYoZmFsc2UpCgkJCQkJdGhpcy5faXRlbS5wb3NpdGlvbi55ID0gbmV3U2NyZWVuLmhlaWdodCAtIG0gLSB0aGlzLm9yaWdCb3VuZHMuYm90dG9tICogaXRlbVNjYWxlOwoJCQkJZWxzZQoJCQkJCXRoaXMuX2l0ZW0ueSA9IG5ld1NjcmVlbi5oZWlnaHQgLSBtIC0gdGhpcy5vcmlnQm91bmRzLmJvdHRvbSAqIGl0ZW1TY2FsZTsKCQkJCWJyZWFrOwoJCQl9CgkJfQoKCQkvLyBob3Jpem9udGFsIG1vdmUKCQltID0gdGhpcy5vcmlnTWFyZ2luSG9yaSAqIG92ZXJhbGxTY2FsZTsKCQkKCQlzd2l0Y2godGhpcy5fc2V0dGluZ3MuaG9yaUFsaWduKQoJCXsKCQkJY2FzZSBVSVNjYWxlci5BTElHTl9MRUZUOgoJCQl7CgkJCQlpZih0aGlzLl9zZXR0aW5ncy50aXRsZVNhZmUpCgkJCQl7CgkJCQkJaWYoZmFsc2UpCgkJCQkJCXRoaXMuX2l0ZW0ucG9zaXRpb24ueCA9IGxldHRlckJveFdpZHRoICsgbSAtIHRoaXMub3JpZ0JvdW5kcy54ICogaXRlbVNjYWxlOwoJCQkJCWVsc2UKCQkJCQkJdGhpcy5faXRlbS54ID0gbGV0dGVyQm94V2lkdGggKyBtIC0gdGhpcy5vcmlnQm91bmRzLnggKiBpdGVtU2NhbGU7CgkJCQl9CgkJCQllbHNlCgkJCQl7CgkJCQkJaWYoZmFsc2UpCgkJCQkJCXRoaXMuX2l0ZW0ucG9zaXRpb24ueCA9IG0gLSB0aGlzLm9yaWdCb3VuZHMueCAqIGl0ZW1TY2FsZTsKCQkJCQllbHNlCgkJCQkJCXRoaXMuX2l0ZW0ueCA9IG0gLSB0aGlzLm9yaWdCb3VuZHMueCAqIGl0ZW1TY2FsZTsKCQkJCX0KCQkJCWJyZWFrOwoJCQl9CgkJCWNhc2UgVUlTY2FsZXIuQUxJR05fQ0VOVEVSOgoJCQl7CgkJCQlpZih0aGlzLl9zZXR0aW5ncy5jZW50ZXJlZEhvcml6b250YWxseSkKCQkJCXsKCQkJCQlpZihmYWxzZSkKCQkJCQkJdGhpcy5faXRlbS5wb3NpdGlvbi54ID0gKG5ld1NjcmVlbi53aWR0aCAtIHRoaXMuX2l0ZW0ud2lkdGgpICogMC41OwoJCQkJCWVsc2UKCQkJCQkJdGhpcy5faXRlbS54ID0gKG5ld1NjcmVlbi53aWR0aCAtIHRoaXMuX2l0ZW0ud2lkdGgpICogMC41OwoJCQkJfQoJCQkJZWxzZQoJCQkJewoJCQkJCWlmKGZhbHNlKQoJCQkJCQl0aGlzLl9pdGVtLnBvc2l0aW9uLnggPSBuZXdTY3JlZW4ud2lkdGggKiAwLjUgLSBtOwoJCQkJCWVsc2UKCQkJCQkJdGhpcy5faXRlbS54ID0gbmV3U2NyZWVuLndpZHRoICogMC41IC0gbTsKCQkJCX0KCQkJCWJyZWFrOwoJCQl9CQoJCQljYXNlIFVJU2NhbGVyLkFMSUdOX1JJR0hUOgoJCQl7CgkJCQlpZih0aGlzLl9zZXR0aW5ncy50aXRsZVNhZmUpCgkJCQl7CgkJCQkJaWYoZmFsc2UpCgkJCQkJCXRoaXMuX2l0ZW0ucG9zaXRpb24ueCA9IG5ld1NjcmVlbi53aWR0aCAtIGxldHRlckJveFdpZHRoIC0gbSAtIHRoaXMub3JpZ0JvdW5kcy5yaWdodCAqIGl0ZW1TY2FsZTsKCQkJCQllbHNlCgkJCQkJCXRoaXMuX2l0ZW0ueCA9IG5ld1NjcmVlbi53aWR0aCAtIGxldHRlckJveFdpZHRoIC0gbSAtIHRoaXMub3JpZ0JvdW5kcy5yaWdodCAqIGl0ZW1TY2FsZTsKCQkJCX0KCQkJCWVsc2UKCQkJCXsKCQkJCQlpZihmYWxzZSkKCQkJCQkJdGhpcy5faXRlbS5wb3NpdGlvbi54ID0gbmV3U2NyZWVuLndpZHRoIC0gbSAtIHRoaXMub3JpZ0JvdW5kcy5yaWdodCAqIGl0ZW1TY2FsZTsKCQkJCQllbHNlCgkJCQkJCXRoaXMuX2l0ZW0ueCA9IG5ld1NjcmVlbi53aWR0aCAtIG0gLSB0aGlzLm9yaWdCb3VuZHMucmlnaHQgKiBpdGVtU2NhbGU7CgkJCQl9CgkJCQlicmVhazsKCQkJfQkJCgkJfQoJfTsKCQoJLyoqCgkqICBEZXN0cm95IHRoaXMgaXRlbSwgZG9uJ3QgdXNlIGFmdGVyIHRoaXMKCSogIEBtZXRob2QgZGVzdHJveQoJKi8KCXAuZGVzdHJveSA9IGZ1bmN0aW9uKCkKCXsKCQl0aGlzLm9yaWdCb3VuZHMgPSBudWxsOwoJCXRoaXMuX2l0ZW0gPSBudWxsOwoJCXRoaXMuX3NldHRpbmdzID0gbnVsbDsKCQl0aGlzLl9kZXNpZ25lZFNjcmVlbiA9IG51bGw7Cgl9OwoJCgluYW1lc3BhY2UoJ2Nsb3Vka2lkJykuVUlFbGVtZW50ID0gVUlFbGVtZW50Owp9KCkpOwooZnVuY3Rpb24oKSB7CgkKCSJ1c2Ugc3RyaWN0IjsKCgkvKioKCSogIFRoZSBVSSBJdGVtIFNldHRpbmdzIHdoaWNoIGlzIHRoZSBwb3NpdGlvbmluZyBzZXR0aW5ncyB1c2VkIHRvIGFkanVzdCBlYWNoIGVsZW1lbnQKCSogIEBtb2R1bGUgY2xvdWRraWQKCSogIEBjbGFzcyBVSUVsZW1lbnRTZXR0aW5ncwoJKi8KCXZhciBVSUVsZW1lbnRTZXR0aW5ncyA9IGZ1bmN0aW9uKCl7fTsKCQoJLy8gUmVmZXJlbmNlIHRvIHRoZSBwcm90b3R5cGUKCXZhciBwID0gVUlFbGVtZW50U2V0dGluZ3MucHJvdG90eXBlID0ge307CgkKCS8qKiAKCSogIFdoYXQgdmVydGljYWwgc2NyZWVuIGxvY2F0aW9uIHRoZSBpdGVtIHNob3VsZCBiZSBhbGlnbmVkIHRvOiAidG9wIiwgImNlbnRlciIsICJib3R0b20iCgkqICBAcHJvcGVydHkge1N0cmluZ30gdmVydEFsaWduCgkqLwoJcC52ZXJ0QWxpZ24gPSBudWxsOwoKCS8qKiAKCSogIFdoYXQgaG9yaXpvbnRhbCBzY3JlZW4gbG9jYXRpb24gdGhlIGl0ZW0gc2hvdWxkIGJlIGFsaWduZWQgdG86ICJsZWZ0IiwgImNlbnRlciIsICJyaWdodCIKCSogIEBwcm9wZXJ0eSB7U3RyaW5nfSBob3JpQWxpZ24KCSovCglwLmhvcmlBbGlnbiA9IG51bGw7CgoJLyoqIAoJKiAgSWYgdGhpcyBlbGVtZW50IHNob3VsZCBiZSBhbGlnbmVkIHRvIHRoZSB0aXRsZSBzYWZlIGFyZWEsIG5vdCB0aGUgYWN0dWFsIHNjcmVlbiAKCSogIEBwcm9wZXJ0eSB7Qm9vbGVhbn0gdGl0bGVTYWZlCgkqICBAZGVmYXVsdCBmYWxzZQoJKi8KCXAudGl0bGVTYWZlID0gZmFsc2U7CgoJLyoqIAoJKiAgTWF4aW11bSBzY2FsZSBhbGxvd2VkIGluIHBoeXNpY2FsIHNpemUgCgkqICBAcHJvcGVydHkge051bWJlcn0gbWF4U2NhbGUKCSogIEBkZWZhdWx0IDEKCSovCglwLm1heFNjYWxlID0gMTsKCgkvKiogCgkqICBNaW5pbXVtIHNjYWxlIGFsbG93ZWQgaW4gcGh5c2ljYWwgc2l6ZSAKCSogIEBwcm9wZXJ0eSB7TnVtYmVyfSBtaW5TY2FsZQoJKiAgQGRlZmF1bHQgMQoJKi8KCXAubWluU2NhbGUgPSAxOwoJCgkvKioKCSogIElmIHRoZSBVSSBlbGVtZW50IGlzIGNlbnRlcmVkIGhvcml6b250YWxseQoJKiAgQHByb3BlcnR5IHtCb29sZWFufSBjZW50ZXJlZEhvcml6b250YWxseQoJKiAgQGRlZmF1bHQgZmFsc2UKCSovCglwLmNlbnRlcmVkSG9yaXpvbnRhbGx5ID0gZmFsc2U7CgkKCW5hbWVzcGFjZSgnY2xvdWRraWQnKS5VSUVsZW1lbnRTZXR0aW5ncyA9IFVJRWxlbWVudFNldHRpbmdzOwp9KCkpOwooZnVuY3Rpb24oKSB7CgkKCSJ1c2Ugc3RyaWN0IjsKCgkvLyBDbGFzcyBpbXBvcnRzCgl2YXIgVUlFbGVtZW50U2V0dGluZ3MgPSBjbG91ZGtpZC5VSUVsZW1lbnRTZXR0aW5ncywKCQlVSUVsZW1lbnQgPSBjbG91ZGtpZC5VSUVsZW1lbnQsCgkJU2NyZWVuU2V0dGluZ3MgPSBjbG91ZGtpZC5TY3JlZW5TZXR0aW5nczsKCgkvKioKCSogICBUaGUgVUkgc2NhbGUgaXMgcmVzcG9uc2libGUgZm9yIHNjYWxpbmcgVUkgY29tcG9uZW50cwoJKiAgIHRvIGhlbHAgZWFzeSB0aGUgYnVyZGVuIG9mIGRpZmZlcmVudCBkZXZpY2UgYXNwZWN0IHJhdGlvcwoJKgoJKiAgQG1vZHVsZSBjbG91ZGtpZAoJKiAgQGNsYXNzIFVJU2NhbGVyCgkqICBAY29uc3RydWN0b3IKCSogIEBwYXJhbSB7Y3JlYXRlanMuRGlzcGxheU9iamVjdHxQSVhJLkRpc3BsYXlPYmplY3R9IHBhcmVudCBUaGUgVUkgZGlzcGxheSBjb250YWluZXIKCSogIEBwYXJhbSB7TnVtYmVyfSBkZXNpZ25lZFdpZHRoIFRoZSBkZXNpZ25lZCB3aWR0aCBvZiB0aGUgVUkKCSogIEBwYXJhbSB7TnVtYmVyfSBkZXNpZ25lZEhlaWdodCBUaGUgZGVzaWduZWQgaGVpZ2h0IG9mIHRoZSBVSQoJKiAgQHBhcmFtIHtOdW1iZXJ9IGRlc2lnbmVkUFBJIFRoZSBkZXNpZ25lZCBQUEkgb2YgdGhlIFVJCgkqLwoJdmFyIFVJU2NhbGVyID0gZnVuY3Rpb24ocGFyZW50LCBkZXNpZ25lZFdpZHRoLCBkZXNpZ25lZEhlaWdodCwgZGVzaWduZWRQUEkpCgl7CgkJdGhpcy5fcGFyZW50ID0gcGFyZW50OwoJCXRoaXMuX2l0ZW1zID0gW107CgkJdGhpcy5fZGVzaWduZWRTY3JlZW4gPSBuZXcgU2NyZWVuU2V0dGluZ3MoZGVzaWduZWRXaWR0aCwgZGVzaWduZWRIZWlnaHQsIGRlc2lnbmVkUFBJKTsKCX07CgkKCS8vIFJlZmVyZW5jZSB0byB0aGUgcHJvdG90eXBlCgl2YXIgcCA9IFVJU2NhbGVyLnByb3RvdHlwZSA9IHt9OwoJCQkJCgkvKiogCgkqICBUaGUgY3VycmVudCBzY3JlZW4gc2V0dGluZ3MgCgkqICBAcHJvcGVydHkge1NjcmVlblNldHRpbmdzfSBjdXJyZW50U2NyZWVuCgkqICBAc3RhdGljCgkqICBAcHJpdmF0ZQoJKi8KCXZhciBjdXJyZW50U2NyZWVuID0gbmV3IFNjcmVlblNldHRpbmdzKDAsIDAsIDApOwoJCgkvKiogCgkqICBJZiB0aGUgc2NyZWVuc2l6ZSBoYXMgYmVlbiBzZXQgCgkqICBAcHJvcGVydHkge0Jvb2xlYW59IGluaXRpYWxpemVkCgkqICBAc3RhdGljCgkqICBAcHJpdmF0ZQoJKi8KCXZhciBpbml0aWFsaXplZCA9IGZhbHNlOwoJCgkvKiogCgkqICBUaGUgVUkgZGlzcGxheSBvYmplY3QgdG8gdXBkYXRlIAoJKiAgQHByb3BlcnR5IHtjcmVhdGVqcy5EaXNwbGF5T2JqZWN0fFBJWEkuRGlzcGxheU9iamVjdH0gX3BhcmVudAoJKiAgQHByaXZhdGUKCSovCglwLl9wYXJlbnQgPSBudWxsOwoJCgkvKiogCgkqICBUaGUgc2NyZWVuIHNldHRpbmdzIG9iamVjdCwgY29udGFpbnMgaW5mb3JtYXRpb24gYWJvdXQgZGVzaWduZWQgc2l6ZSAKCSogIEBwcm9wZXJ0eSB7U2NyZWVuU2V0dGluZ3N9IF9kZXNpZ25lZFNjcmVlbgoJKiAgQHByaXZhdGUKCSovCglwLl9kZXNpZ25lZFNjcmVlbiA9IG51bGw7CgkKCS8qKiAKCSogIFRoZSBjb25maWd1cmF0aW9uIGZvciBlYWNoIGl0ZW1zCgkqICBAcHJvcGVydHkge0FycmF5fSBfaXRlbXMKCSogIEBwcml2YXRlCgkqLwoJcC5faXRlbXMgPSBudWxsOwoJCgkvKioKCSogIFZlcnRpY2FsbHkgYWxpZ24gdG8gdGhlIHRvcAoJKiAgQHByb3BlcnR5IHtTdHJpbmd9IEFMSUdOX1RPUAoJKiAgQHN0YXRpYwoJKiAgQGZpbmFsCgkqICBAcmVhZE9ubHkKCSogIEBkZWZhdWx0ICJ0b3AiCgkqLwoJVUlTY2FsZXIuQUxJR05fVE9QID0gInRvcCI7CgoJLyoqCgkqICBWZXJ0aWNhbGx5IGFsaWduIHRvIHRoZSBib3R0b20KCSogIEBwcm9wZXJ0eSB7U3RyaW5nfSBBTElHTl9CT1RUT00KCSogIEBzdGF0aWMKCSogIEBmaW5hbAoJKiAgQHJlYWRPbmx5CgkqICBAZGVmYXVsdCAiYm90dG9tIgoJKi8KCVVJU2NhbGVyLkFMSUdOX0JPVFRPTSA9ICJib3R0b20iOwoKCS8qKgoJKiAgSG9yaXpvbnRhbGx5IGFsaWduIHRvIHRoZSBsZWZ0CgkqICBAcHJvcGVydHkge1N0cmluZ30gQUxJR05fTEVGVAoJKiAgQHN0YXRpYwoJKiAgQGZpbmFsCgkqICBAcmVhZE9ubHkKCSogIEBkZWZhdWx0ICJsZWZ0IgoJKi8KCVVJU2NhbGVyLkFMSUdOX0xFRlQgPSAibGVmdCI7CgoJLyoqCgkqICBIb3Jpem9udGFsbHkgYWxpZ24gdG8gdGhlIHJpZ2h0CgkqICBAcHJvcGVydHkge1N0cmluZ30gQUxJR05fUklHSFQKCSogIEBzdGF0aWMKCSogIEBmaW5hbAoJKiAgQHJlYWRPbmx5CgkqICBAZGVmYXVsdCAicmlnaHQiCgkqLwoJVUlTY2FsZXIuQUxJR05fUklHSFQgPSAicmlnaHQiOwoKCS8qKgoJKiAgVmVydGljYWxseSBvciBob3Jpem9udGFsbHkgYWxpZ24gdG8gdGhlIGNlbnRlcgoJKiAgQHByb3BlcnR5IHtTdHJpbmd9IEFMSUdOX0NFTlRFUgoJKiAgQHN0YXRpYwoJKiAgQGZpbmFsCgkqICBAcmVhZE9ubHkKCSogIEBkZWZhdWx0ICJjZW50ZXIiCgkqLwoJVUlTY2FsZXIuQUxJR05fQ0VOVEVSID0gImNlbnRlciI7CgkKCS8qKgoJKiAgQ3JlYXRlIHRoZSBzY2FsZXIgZnJvbSBKU09OIGRhdGEKCSogIEBtZXRob2QgZnJvbUpTT04KCSogIEBzdGF0aWMKCSogIEBwYXJhbSB7Y3JlYXRlanMuRGlzcGxheU9iamVjdHxQSVhJLkRpc3BsYXlPYmplY3R9IHBhcmVudCBUaGUgVUkgZGlzcGxheSBjb250YWluZXIKCSogIEBwYXJhbSB7T2JqZWN0fSBqc29uU2V0dGluZ3MgVGhlIGpzb24gb2YgdGhlIGRlc2lnbmVkIHNldHRpbmdzIHtkZXNpZ25lZFdpZHRoOjgwMCwgZGVzaWduZWRIZWlnaHQ6NjAwLCBkZXNpZ25lZFBQSTo3Mn0KCSogIEBwYXJhbSB7T2JqZWN0fSBqc29uSXRlbXMgVGhlIGpzb24gaXRlbXMgb2JqZWN0IHdoZXJlIHRoZSBrZXlzIGFyZSB0aGUgbmFtZSBvZiB0aGUgcHJvcGVydHkgb24gdGhlIHBhcmVudCBhbmQgdGhlIHZhbHVlCgkqICAgICAgICAgaXMgYW4gb2JqZWN0IHdpdGgga2V5cyBvZiAidGl0bGVTYWZlIiwgIm1pblNjYWxlIiwgIm1heFNjYWxlIiwgImNlbnRlckhvcml6b250YWxseSIsICJhbGlnbiIKCSogIEBwYXJhbSB7Qm9vbGVhbn0gW2ltbWVkaWF0ZURlc3Ryb3k9dHJ1ZV0gSWYgd2Ugc2hvdWxkIGltbWVkaWF0ZWx5IGNsZWFudXAgdGhlIFVJU2NhbGVyIGFmdGVyIHNjYWxpbmcgaXRlbXMKCSogIEByZXR1cm4ge1VJU2NhbGVyfSBUaGUgc2NhbGVyIG9iamVjdCB0aGF0IGNhbiBiZSByZXVzZWQKCSovCglVSVNjYWxlci5mcm9tSlNPTiA9IGZ1bmN0aW9uKHBhcmVudCwganNvblNldHRpbmdzLCBqc29uSXRlbXMsIGltbWVkaWF0ZURlc3Ryb3kpCgl7CgkJaWYgKHR5cGVvZiBpbW1lZGlhdGVEZXN0cm95ICE9ICJib29sZWFuIikgaW1tZWRpYXRlRGVzdHJveSA9IHRydWU7CgkJCQoJCXZhciBzY2FsZXIgPSBuZXcgVUlTY2FsZXIoCgkJCXBhcmVudCwgCgkJCWpzb25TZXR0aW5ncy5kZXNpZ25lZFdpZHRoLAoJCQlqc29uU2V0dGluZ3MuZGVzaWduZWRIZWlnaHQsCgkJCWpzb25TZXR0aW5ncy5kZXNpZ25lZFBQSQoJCSk7CgkJCgkJLy8gVGVtcCB2YXJpYWJsZXMKCQl2YXIgaXRlbSwgaSwgYWxpZ24sIHZlcnRBbGlnbiwgaG9yaUFsaWduOwoJCQoJCS8vIExvb3AgdGhyb3VnaCBhbGwgdGhlIGl0ZW1zIGFuZCByZWdpc3RlcgoJCS8vIGVhY2ggZHBlbmRpbmcgb24gdGhlIHNldHRpbmdzCgkJZm9yKGkgaW4ganNvbkl0ZW1zKQoJCXsKCQkJaXRlbSA9IGpzb25JdGVtc1tpXTsKCQkJCgkJCWlmIChpdGVtLmFsaWduKQoJCQl7CgkJCQlhbGlnbiA9IGl0ZW0uYWxpZ24uc3BsaXQoIi0iKTsKCQkJCXZlcnRBbGlnbiA9IGFsaWduWzBdOwoJCQkJaG9yaUFsaWduID0gYWxpZ25bMV07CgkJCX0KCQkJZWxzZQoJCQl7CgkJCQl2ZXJ0QWxpZ24gPSBBTElHTl9DRU5URVI7CgkJCQlob3JpQWxpZ24gPSBBTElHTl9DRU5URVI7CgkJCX0KCQkJc2NhbGVyLmFkZCgKCQkJCXBhcmVudFtpXSwgCgkJCQl2ZXJ0QWxpZ24sCgkJCQlob3JpQWxpZ24sCgkJCQlpdGVtLnRpdGxlU2FmZSB8fCBmYWxzZSwKCQkJCWl0ZW0ubWluU2NhbGUgfHwgTmFOLAoJCQkJaXRlbS5tYXhTY2FsZSB8fCBOYU4sCgkJCQlpdGVtLmNlbnRlcmVkSG9yaXpvbnRhbGx5IHx8IGZhbHNlCgkJCSk7CgkJfQoJCQoJCS8vIFNjYWxlIHRoZSBpdGVtcwoJCXNjYWxlci5yZXNpemUoKTsKCQkKCQlpZiAoaW1tZWRpYXRlRGVzdHJveSkKCQl7CgkJCXNjYWxlci5kZXN0cm95KCk7CgkJfQoJCXJldHVybiBzY2FsZXI7Cgl9OwoJCgkvKioKCSogICBTZXQgdGhlIGN1cnJlbnQgc2NyZWVuIHNldHRpbmdzLiBJZiB0aGUgc3RhZ2Ugc2l6ZSBjaGFuZ2VzIGF0IGFsbCwgcmUtY2FsbCB0aGlzIGZ1bmN0aW9uCgkqICAgQG1ldGhvZCBpbml0CgkqICAgQHN0YXRpYwoJKiAgIEBwYXJhbSB7TnVtYmVyfSBzY3JlZW5XaWR0aCBUaGUgZnVsbHNjcmVlbiB3aWR0aAoJKiAgIEBwYXJhbSB7TnVtYmVyfSBzY3JlZW5IZWlnaHQgVGhlIGZ1bGxzY3JlZW4gaGVpZ2h0CgkqICAgQHBhcmFtIHtOdW1iZXJ9IHNjcmVlblBQSSBUaGUgc2NyZWVuIHJlc29sdXRpb24gZGVuc2l0eQoJKi8KCVVJU2NhbGVyLmluaXQgPSBmdW5jdGlvbihzY3JlZW5XaWR0aCwgc2NyZWVuSGVpZ2h0LCBzY3JlZW5QUEkpCgl7CgkJY3VycmVudFNjcmVlbi53aWR0aCA9IHNjcmVlbldpZHRoOwoJCWN1cnJlbnRTY3JlZW4uaGVpZ2h0ID0gc2NyZWVuSGVpZ2h0OwoJCWN1cnJlbnRTY3JlZW4ucHBpID0gc2NyZWVuUFBJOwoJCWluaXRpYWxpemVkID0gdHJ1ZTsKCX07CgoJLyoqCgkqICBHZXQgdGhlIGN1cnJlbnQgc2NhbGUgb2YgdGhlIHNjcmVlbgoJKiAgQG1ldGhvZCBnZXRTY2FsZQoJKiAgQHJldHVybiB7TnVtYmVyfSBUaGUgY3VycmVudCBzdGFnZSBzY2FsZQoJKi8KCXAuZ2V0U2NhbGUgPSBmdW5jdGlvbigpCgl7CgkJcmV0dXJuIGN1cnJlbnRTY3JlZW4uaGVpZ2h0IC8gdGhpcy5fZGVzaWduZWRTY3JlZW4uaGVpZ2h0OwoJfTsKCQoJLyoqCgkqICAgTWFudWFsbHkgYWRkIGFuIGl0ZW0gCgkqICAgQG1ldGhvZCBhZGQKCSogICBAcGFyYW0ge2NyZWF0ZWpzLkRpc3BsYXlPYmplY3R8UElYSS5EaXNwbGF5T2JqZWN0fSBpdGVtIFRoZSBkaXNwbGF5IG9iamVjdCBpdGVtIHRvIGFkZAoJKiAgIEBwYXJhbSB7U3RyaW5nfSBbdmVydEFsaWduPSJjZW50ZXIiXSBUaGUgdmVydGljYWwgYWxpZ24gb2YgdGhlIGl0ZW0gKGNlZmF1bHQgaXMgY2VudGVyKQoJKiAgIEBwYXJhbSB7U3RyaW5nfSBbaG9yaUFsaWduPSJjZW50ZXIiXSBUaGUgaG9yaXpvbnRhbCBhbGlnbiBvZiB0aGUgaXRlbSAoZGVmYXVsdCBpcyBjZW50ZXIpCgkqICAgQHBhcmFtIHtCb29sZWFufSBbdGl0bGVTYWZlPWZhbHNlXSBJZiB0aGUgaXRlbSBuZWVkcyB0byBiZSBpbiB0aGUgdGl0bGUgc2FmZSBhcmVhIChkZWZhdWx0IGlzIGZhbHNlKQoJKiAgIEBwYXJhbSB7TnVtYmVyfSBbbWluU2NhbGU9MV0gVGhlIG1pbmltdW0gc2NhbGUgYW1vdW50IChkZWZhdWx0LCBzY2FsZXMgdGhlIHNhbWUgc2l6ZSBhcyB0aGUgc3RhZ2UpCgkqICAgQHBhcmFtIHtOdW1iZXJ9IFttYXhTY2FsZT0xXSBUaGUgbWF4aW11bSBzY2FsZSBhbW91bnQgKGRlZmF1bHQsIHNjYWxlcyB0aGUgc2FtZSBzaXplIGFzIHRoZSBzdGFnZSkKCSogICBAcGFyYW0ge0Jvb2xlYW59IFtjZW50ZXJlZEhvcml6b250YWxseT1mYWxzZV0gTWFrZXMgc3VyZSB0aGF0IHRoZSBjZW50ZXIgb2YgdGhlIG9iamVjdCB3YXMgYXQgdGhlIGNlbnRlciBvZiB0aGUgc2NyZWVuLCBhc3N1bWluZyBhbiBvcmlnaW4gYXQgdGhlIHRvcCBsZWZ0IG9mIHRoZSBvYmplY3QKCSovCglwLmFkZCA9IGZ1bmN0aW9uKGl0ZW0sIHZlcnRBbGlnbiwgaG9yaUFsaWduLCB0aXRsZVNhZmUsIG1pblNjYWxlLCBtYXhTY2FsZSwgY2VudGVyZWRIb3Jpem9udGFsbHkpCgl7CgkJLy8gQ3JlYXRlIHRoZSBpdGVtIHNldHRpbmdzCgkJdmFyIHMgPSBuZXcgVUlFbGVtZW50U2V0dGluZ3MoKTsKCQkKCQlzLnZlcnRBbGlnbiA9IHZlcnRBbGlnbiB8fCBVSVNjYWxlci5BTElHTl9DRU5URVI7CgkJcy5ob3JpQWxpZ24gPSBob3JpQWxpZ24gfHwgVUlTY2FsZXIuQUxJR05fQ0VOVEVSOwoJCXMudGl0bGVTYWZlID0gKHR5cGVvZiB0aXRsZVNhZmUgIT0gImJvb2xlYW4iKSA/IGZhbHNlIDogdGl0bGVTYWZlOwoJCXMubWF4U2NhbGUgPSAodHlwZW9mIG1heFNjYWxlICE9ICJudW1iZXIiKSA/IE5hTiA6IG1heFNjYWxlOwoJCXMubWluU2NhbGUgPSAodHlwZW9mIG1pblNjYWxlICE9ICJudW1iZXIiKSA/IE5hTiA6IG1pblNjYWxlOwoJCXMuY2VudGVyZWRIb3Jpem9udGFsbHkgPSBjZW50ZXJlZEhvcml6b250YWxseSB8fCBmYWxzZTsKCQkJCQoJCXRoaXMuX2l0ZW1zLnB1c2gobmV3IFVJRWxlbWVudChpdGVtLCBzLCB0aGlzLl9kZXNpZ25lZFNjcmVlbikpOwoJfTsKCQoJLyoqCgkqICAgU2NhbGUgYSBzaW5nbGUgYmFja2dyb3VuZCBpbWFnZSBhY2NvcmRpbmcgdG8gdGhlIFVJU2NhbGVyLndpZHRoIGFuZCBoZWlnaHQKCSogICBAbWV0aG9kIHJlc2l6ZUJhY2tncm91bmQKCSogICBAc3RhdGljCgkqICAgQHBhcmFtIHtjcmVhdGVqcy5CaXRtYXB8UElYSS5CaXRtYXB9IFRoZSBiaXRtYXAgdG8gc2NhbGUKCSovCglVSVNjYWxlci5yZXNpemVCYWNrZ3JvdW5kID0gZnVuY3Rpb24oYml0bWFwKQoJewoJCWlmICghaW5pdGlhbGl6ZWQpIHJldHVybjsKCQkKCQl2YXIgaCwgdywgc2NhbGU7CgkJaWYoZmFsc2UpCgkJewoJCQloID0gYml0bWFwLmhlaWdodCAvIGJpdG1hcC5zY2FsZS55OwoJCQl3ID0gYml0bWFwLndpZHRoIC8gYml0bWFwLnNjYWxlLng7CgoJCQkvL3NjYWxlIHRoZSBiYWNrZ3JvdW5kCgkJCXNjYWxlID0gY3VycmVudFNjcmVlbi5oZWlnaHQgLyBoOwoJCQliaXRtYXAuc2NhbGUueCA9IGJpdG1hcC5zY2FsZS55ID0gc2NhbGU7CgkJCQoJCQkvL2NlbnRlciB0aGUgYmFja2dyb3VuZAoJCQliaXRtYXAucG9zaXRpb24ueCA9IChjdXJyZW50U2NyZWVuLndpZHRoIC0gYml0bWFwLndpZHRoKSAqIDAuNTsKCQl9CgkJZWxzZSBpZih0cnVlKQoJCXsKCQkJaCA9IGJpdG1hcC5pbWFnZS5oZWlnaHQ7CgkJCXcgPSBiaXRtYXAuaW1hZ2Uud2lkdGg7CgoJCQkvL3NjYWxlIHRoZSBiYWNrZ3JvdW5kCgkJCXNjYWxlID0gY3VycmVudFNjcmVlbi5oZWlnaHQgLyBoOwoJCQliaXRtYXAuc2NhbGVYID0gYml0bWFwLnNjYWxlWSA9IHNjYWxlOwoJCQkKCQkJLy9jZW50ZXIgdGhlIGJhY2tncm91bmQKCQkJYml0bWFwLnggPSAoY3VycmVudFNjcmVlbi53aWR0aCAtIHcgKiBzY2FsZSkgKiAwLjU7CgkJfQoJfTsKCQoJLyoqCgkqICBDb252ZW5pZW5jZSBmdW5jdGlvbiB0byBzY2FsZSBhIGNvbGxlY3Rpb24gb2YgYmFja2dyb3VuZHMKCSogIEBtZXRob2QgcmVzaXplQmFja2dyb3VuZHMKCSogIEBzdGF0aWMKCSogIEBwYXJhbSB7QXJyYXl9IGJpdG1hcHMgVGhlIGNvbGxlY3Rpb24gb2YgYml0bWFwIGltYWdlcwoJKi8KCVVJU2NhbGVyLnJlc2l6ZUJhY2tncm91bmRzID0gZnVuY3Rpb24oYml0bWFwcykKCXsKCQlmb3IodmFyIGkgPSAwLCBsZW4gPSBiaXRtYXBzLmxlbmd0aDsgaSA8IGxlbjsgKytpKQoJCXsKCQkJVUlTY2FsZXIucmVzaXplQmFja2dyb3VuZChiaXRtYXBzW2ldKTsKCQl9Cgl9OwoJCgkvKioKCSogIFNjYWxlIHRoZSBVSSBpdGVtcyB0aGF0IGhhdmUgYmVlbiByZWdpc3RlcmVkIHRvIHRoZSBjdXJyZW50IHNjcmVlbgoJKiAgQG1ldGhvZCByZXNpemUKCSovCglwLnJlc2l6ZSA9IGZ1bmN0aW9uKCkKCXsKCQlpZiAodGhpcy5faXRlbXMubGVuZ3RoID4gMCkKCQl7CgkJCWZvcih2YXIgaSA9IDAsIGxlbiA9IHRoaXMuX2l0ZW1zLmxlbmd0aDsgaSA8IGxlbjsgKytpKQoJCQl7CgkJCQl0aGlzLl9pdGVtc1tpXS5yZXNpemUoY3VycmVudFNjcmVlbik7CgkJCX0KCQl9Cgl9OwoJCgkvKioKCSogIERlc3Ryb3kgdGhlIHNjYWxlciBvYmplY3QKCSogIEBtZXRob2QgZGVzdHJveQoJKi8KCXAuZGVzdHJveSA9IGZ1bmN0aW9uKCkKCXsKCQlpZiAodGhpcy5faXRlbXMubGVuZ3RoID4gMCkKCQl7CgkJCWZvcih2YXIgaSA9IDAsIGxlbiA9IHRoaXMuX2l0ZW1zLmxlbmd0aDsgaSA8IGxlbjsgKytpKQoJCQl7CgkJCQl0aGlzLl9pdGVtc1tpXS5kZXN0cm95KCk7CgkJCX0KCQl9CgkJCgkJdGhpcy5fcGFyZW50ID0gbnVsbDsKCQl0aGlzLl9kZXNpZ25lZFNjcmVlbiA9IG51bGw7CgkJdGhpcy5faXRlbXMgPSBudWxsOwoJfTsKCQoJbmFtZXNwYWNlKCdjbG91ZGtpZCcpLlVJU2NhbGVyID0gVUlTY2FsZXI7Cn0oKSk7Cg==",
                "body": "LyoqCiogIEBtb2R1bGUgY2xvdWRraWQKKi8KKGZ1bmN0aW9uKHVuZGVmaW5lZCl7CgkKCS8qKgoJKiAgRGVzaWduZWQgdG8gbWltaWMgdGhlIGZlYXR1cmUtc2V0IG9mIHRoZSBDbG91ZEtpZE9TIGZvciBBUzMKCSogIFByb3ZpZGVzIGEgc3RhZ2luZyBmcmFtZXdvcmsgZm9yIG90aGVyIHRoaW5ncyB0byBsb2FkCgkqICBoYW5kbGVzIHRoZSBzdGFnZSBxdWVyeSBzdHJpbmcgcGFyYW1ldGVycywgcHJvdmlkZXMgZGVidWcgdG9vbHMsCgkqICBhcyB3ZWxsIGFzIGJyb3dzZXIgY2FjaGUtYnVzdGluZy4KCSoKCSogIEBjbGFzcyBPUwoJKiAgQGV4dGVuZHMgY3JlYXRlanMuQ29udGFpbmVyfFBJWEkuRGlzcGxheU9iamVjdENvbnRhaW5lcgoJKi8KCXZhciBPUyA9IGZ1bmN0aW9uKCl7fSwKCQoJLyoqCgkqIFRoZSBwcm90b3R5cGUgZXh0ZW5kcyB0aGUgZWFzZWxqcycgQ29udGFpbmVyIGNsYXNzCgkqIG9yIHRoZSBQSVhJLkRpc3BsYXlPYmplY3RDb250YWluZXIgY2xhc3MKCSogCgkqIEBwcml2YXRlCgkqIEBwcm9wZXJ0eSB7Y3JlYXRlanMuQ29udGFpbmVyfFBJWEkuRGlzcGxheU9iamVjdENvbnRhaW5lcn0gcAoJKi8KCXAgPSBPUy5wcm90b3R5cGUgPSAodHJ1ZSkgPyBuZXcgY3JlYXRlanMuQ29udGFpbmVyKCkgOiBPYmplY3QuY3JlYXRlKFBJWEkuRGlzcGxheU9iamVjdENvbnRhaW5lci5wcm90b3R5cGUpLAoJCgkvKioKCSogIEJvb2xlYW4gdG8ga2VlcCB0cmFjayBpZiB3ZSdyZSBwYXVzZWQKCSogIAoJKiAgQHByb3BlcnR5IHtib29sfSBfcGF1c2VkCgkqICBAcHJpdmF0ZQoJKi8KCV9wYXVzZWQgPSBmYWxzZSwKCQoJLyoqCgkqICBXaGVuIHRoZSBPUyBpcyByZWFkeSB0byB1c2UKCSogCgkqICBAcHJvcGVydHkge2Jvb2x9IF9pc1JlYWR5CgkqICBAcHJpdmF0ZQoJKi8KCV9pc1JlYWR5ID0gZmFsc2UsCgkKCS8qKgoJKiAgVGhlIGZyYW1lIHJhdGUgb2JqZWN0CgkqICBAcHJpdmF0ZQoJKiAgQHByb3BlcnR5IHtjcmVhdGVqcy5UZXh0fFBJWEkuVGV4dH0gX2ZyYW1lcmF0ZQoJKi8KCV9mcmFtZXJhdGUgPSBudWxsLAoJCgkvKioKCSogIFRoZSBudW1iZXIgb2YgbXMgc2luY2UgdGhlIGxhc3QgZnJhbWUgdXBkYXRlCgkqICBAcHJpdmF0ZQoJKiAgQHByb3BlcnR5IHtpbnR9IF9sYXN0RnJhbWVUaW1lCgkqLwoJX2xhc3RGcmFtZVRpbWUgPSAwLAoJCgkvKioKCSogIFRoZSBsYXN0IHRpbWUgc2luY2UgdGhlIGxhc3QgZnBzIHVwZGF0ZQoJKiAgQHByaXZhdGUKCSogIEBwcm9wZXJ0eSB7aW50fSBfbGFzdEZQU1VwZGF0ZVRpbWUKCSovCglfbGFzdEZQU1VwZGF0ZVRpbWUgPSAwLAoJCgkvKioKCSogIFRoZSBjYWxjdWxhdGVkIF9mcmFtZXJhdGUKCSogIEBwcml2YXRlCgkqICBAcHJvcGVydHkge051bWJlcn0gX2ZyYW1lcmF0ZVZhbHVlCgkqLwoJX2ZyYW1lcmF0ZVZhbHVlID0gbnVsbCwKCQoJLyoqCgkqICBUaGUgbnVtYmVyIG9mIGZyYW1lcyBzaW5jZSB0aGUgbGFzdCBmcHMgdXBkYXRlCgkqICBAcHJpdmF0ZQoJKiAgQHByb3BlcnR5IHtpbnR9IF9mcmFtZUNvdW50CgkqLwoJX2ZyYW1lQ291bnQgPSAwLAoJCgkvKioKCSoJVGhlIGJvdW5kIGNhbGxiYWNrIGZvciBsaXN0ZW5pbmcgdG8gdGljayBldmVudHMKCSoJQHByaXZhdGUKCSogICBAcHJvcGVydHkge0Z1bmN0aW9ufSBfdGlja0NhbGxiYWNrCgkqLwoJX3RpY2tDYWxsYmFjayA9IG51bGwsCgkKCS8qKgoJKiBSZWZlcmVuY2UgdG8gdGhlIHByaXZhdGUgaW5zdGFuY2Ugb2JqZWN0CgkqIAoJKiBAcHJvcGVydHkge09TfSBfaW5zdGFuY2UKCSogQHN0YXRpYwoJKiBAcHJvdGVjdGVkCgkqLwoJX2luc3RhbmNlID0gbnVsbCwKCQoJLyoqCgkqIFRoZSBpZCBvZiB0aGUgYWN0aXZlIHJlcXVlc3RBbmltYXRpb25GcmFtZSBvciBzZXRUaW1lb3V0IGNhbGwuCgkqCgkqIEBwcm9wZXJ0eSB7TnVtYmVyfSBfdGlja0lkCgkqIEBwcml2YXRlCgkqLwoJX3RpY2tJZCA9IC0xLAoJCgkvKioKCSogSWYgcmVxdWVzdGlvbkFuaW1hdGlvbkZyYW1lIHNob3VsZCBiZSB1c2VkCgkqCgkqIEBwcml2YXRlCgkqIEBwcm9wZXJ0eSB7Qm9vbH0gX3VzZVJBRgoJKiBAZGVmYXVsdCBmYWxzZQoJKi8KCV91c2VSQUYgPSBmYWxzZSwKCQoJLyoqIAoJKiBUaGUgY3VycmVudCBpbnRlcm5hbCBmcmFtZXMgcGVyIHNlY29uZAoJKgoJKiBAcHJvcGVydHkge051bWJlcn0gX2ZwcwoJKiBAcHJpdmF0ZQoJKi8KCV9mcHMgPSAwLAoJCgkvKioKCSogVGhlIG51bWJlciBvZiBtaWxsaXNlY29uZHMgcGVyIGZyYW1lCgkqCgkqIEBwcm9wZXJ0eSB7aW50fSBfbXNQZXJGcmFtZQoJKiBAcHJpdmF0ZQoJKi8KCV9tc1BlckZyYW1lID0gMDsKCQoJLyoqIAoJKiBUaGUgdmVyc2lvbiBudW1iZXIgCgkqIEBwdWJsaWMKCSogQHN0YXRpYwoJKiBAcHJvcGVydHkge1N0cmluZ30gVkVSU0lPTgoJKi8KCU9TLlZFUlNJT04gPSAiJHt2ZXJzaW9ufSI7CQoJCgkvKioKCSogUmVmZXJlbmNlIHRvIHRoZSBDb250YWluZXIgaW5pdGlhbGl6ZSgpCgkqIEBwcm90ZWN0ZWQKCSogQHByb3BlcnR5IHtGdW5jdGlvbn0gQ29udGFpbmVyX2luaXRpYWxpemUKCSovCglpZih0cnVlKQoJCXAuQ29udGFpbmVyX2luaXRpYWxpemUgPSBwLmluaXRpYWxpemU7CgkJCgkvKioKCSogUmVmZXJlbmNlIHRvIHRoZSBzdGFnZSBvYmplY3QKCSogCgkqIEBwcm9wZXJ0eSB7Y3JlYXRlanMuU3RhZ2V8UElYSS5TdGFnZX0gc3RhZ2UKCSogQHB1YmxpYwoJKi8KCXAuc3RhZ2UgPSBudWxsOwoJCgkvKioKCSogW1BpeGkgT25seV0gVGhlIHJlbmRlcmVyIHVzZWQgdG8gZHJhdyB0aGUgZnJhbWUuCgkqIAoJKiBAcHJvcGVydHkge1BJWEkuQ2FudmFzUmVuZGVyZXJ8UElYSS5XZWJHTFJlbmRlcmVyfSBfcmVuZGVyZXIgVGhlIFBpeGlKUyByZW5kZXJlci4KCSogQHByaXZhdGUKCSovCglpZihmYWxzZSkKCQlwLl9yZW5kZXJlciA9IG51bGw7CgkKCS8qKgoJKiBbUGl4aSBPbmx5XSBBIGRpdiB0aGF0IGNvbnRhaW5zIHRoZSBjYW52YXMsIHNvIHRoYXQgZ2FtZXMgY2FuIGxheWVyIGl0IHdpdGggb3RoZXIgY2FudmFzZXMgaWYgZGVzaXJlZC4KCSogCgkqIEBwcm9wZXJ0eSB7RE9NRWxlbWVudH0gY2FudmFzQ29udGFpbmVyCgkqIEBwdWJsaWMKCSovCglpZihmYWxzZSkKCQlwLmNhbnZhc0NvbnRhaW5lciA9IG51bGw7CgkKCS8qKgoJKiBSZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnQgYXBwbGljYXRpb24KCSogQHByb3RlY3RlZAoJKiBAcHJvcGVydHkge0FwcGxpY2F0aW9ufSBfYXBwCgkqLwoJcC5fYXBwID0gbnVsbDsKCQoJLyoqCgkqIFRoZSBjb2xsZWN0aW9uIG9mIHF1ZXJ5IHN0cmluZyBwYXJhbWV0ZXJzCgkqIEBwdWJsaWMKCSogQHByb3BlcnR5IHtEaWN0aW9uYXJ5fSBvcHRpb25zCgkqLwoJcC5vcHRpb25zID0gbnVsbDsKCQoJLyoqCgkqICBDb2xsZWN0aW9uIG9mIHVwZGF0ZSBmdW5jdGlvbnMKCSogIEBwcm90ZWN0ZWQKCSogIEBwcm9wZXJ0eSB7RGljdGlvbmFyeX0gX3VwZGF0ZUZ1bmN0aW9ucwoJKi8KCXAuX3VwZGF0ZUZ1bmN0aW9ucyA9IHt9OwoJCgkvKioKCSogIFN0YXRpYyBjb25zdHJ1Y3RvciBmb3Igc2V0dGluZyB1cCB0aGUgc3RhZ2UKCSogIAoJKiAgQGV4YW1wbGUKCQl2YXIgb3MgPSBjbG91ZGtpZC5PUy5pbml0KCJzdGFnZSIsIHsKCQkJc2hvd0ZyYW1lcmF0ZTogdHJ1ZSwKCQkJZnBzOiA2MCwKCQkJcGFyc2VRdWVyeVN0cmluZzogdHJ1ZSwKCQkJZGVidWc6IHRydWUKCQl9KTsKCQkKCQlvcy5hZGRBcHAobXlBcHBsaWNhdGlvbik7CgkqICAKCSogIEBtZXRob2QgaW5pdAoJKiAgQHN0YXRpYwoJKiAgQHB1YmxpYwoJKiAgQHBhcmFtIHtTdHJpbmd9IHN0YWdlTmFtZSBUaGUgc3RhZ2UgbmFtZSBzZWxlY3RvcgoJKiAgQHBhcmFtIHtEaWN0aW9uYXJ5fSBbb3B0aW9uc10gQWRkaXRpb25hbCBvcHRpb25zCgkqICBAcGFyYW0ge2ludH0gW29wdGlvbnMubW91c2VPdmVyUmF0ZT0zMF0gKENyZWF0ZUpTIG9ubHkpIHRoZSBmcmFtZXJhdGUgZm9yIG1vdXNlb3ZlciBlZmZlY3RzLCBoaWdoZXIgaXMgbW9yZSByZXNwb25zaXZlCgkqICBAcGFyYW0ge0Jvb2xlYW59IFtvcHRpb25zLmRlYnVnPWZhbHNlXSBJZiB3ZSBzaG91bGQgZW5hYmxlIHRoZSBEZWJ1ZyBjbGFzcyBmb3IgZG9pbmcgY29uc29sZSBhbmQgcmVtb3RlIGxvZ3MKCSogIEBwYXJhbSB7aW50fSBbb3B0aW9ucy5taW5Mb2dMZXZlbD0wXSBUaGUgbWluaW11bSBsb2cgbGV2ZWwgZm9yIHRoZSBEZWJ1ZyBjbGFzcywgZGVmYXVsdCBpcyBzaG93IGFsbCBzdGF0ZW1lbnRzLCB2YWx1ZXMgZnJvbSAwIChhbGwpLTQgKGVycm9ycyBvbmx5KQoJKiAgQHBhcmFtIHtTdHJpbmd9IFtvcHRpb25zLmlwPW51bGxdIFRoZSBJUCBhZGRyZXNzIGZvciBkb2luZyByZW1vdGUgZGVidWdnaW5nCgkqICBAcGFyYW0ge0Jvb2xlYW59IFtvcHRpb25zLnBhcnNlUXVlcnlTdHJpbmc9ZmFsc2VdIElmIHdlIHNob3VsZCBjb252ZXJ0IHRoZSBxdWVyeSBzdHJpbmcgaW50byBPUyBvcHRpb25zCgkqICBAcGFyYW0ge0Jvb2xlYW59IFtvcHRpb25zLnNob3dGcmFtZXJhdGU9ZmFsc2VdIFRvIGRpc3BsYXkgdGhlIGN1cnJlbnQgZnJhbWVyYXRlIGNvdW50ZXIKCSogIEBwYXJhbSB7Qm9vbGVhbn0gW29wdGlvbnMuY2xlYXJWaWV3PWZhbHNlXSBBdXRvIGNsZWFyIHRoZSBzdGFnZSByZW5kZXIKCSogIEBwYXJhbSB7aW50fSBbb3B0aW9ucy5iYWNrZ3JvdW5kQ29sb3I9MHgwMDAwMDBdIChQSVhJIG9ubHkpIFRoZSBiYWNrZ3JvdW5kIGNvbG9yIG9mIHRoZSBzdGFnZSBhcyBhIHVpbnQsIGUuZy4gMHhGRkZGRkYgZm9yIHdoaXRlLgoJKiAgQHBhcmFtIHtCb29sZWFufSBbb3B0aW9ucy5wcmVNdWx0QWxwaGE9ZmFsc2VdIChQSVhJIG9ubHkpIElmIHRoZSByZW5kZXJlciBpcyB0byB1c2UgcHJlIG11bHRpcGxpZWQgYWxwaGEgZm9yIGFsbCBpbWFnZXMuIFRoaXMgb25seSBhZmZlY3RzIHRoZSBXZWJHTCByZW5kZXJlci4KCSogIEBwYXJhbSB7Qm9vbGVhbn0gW29wdGlvbnMudHJhbnNwYXJlbnQ9ZmFsc2VdIChQSVhJIG9ubHkpIFRoZSBzdGFnZSBpcyB0cmFuc3BhcmVudAoJKiAgQHBhcmFtIHtpbnR9IFtvcHRpb25zLndpZHRoXSAoUElYSSBvbmx5KSBUaGUgd2lkdGggb2YgdGhlIHJlbmRlcmVyLCBkZWZhdWx0IGlzIHRoZSBjYW52YXMgd2lkdGgKCSogIEBwYXJhbSB7aW50fSBbb3B0aW9ucy5oZWlnaHRdIChQSVhJIG9ubHkpIFRoZSBoZWlnaHQgb2YgdGhlIHJlbmRlcmVyLCBkZWZhdWx0IGlzIHRoZSBjYW52YXMgaGVpZ2h0CgkqICBAcGFyYW0ge1N0cmluZ30gW29wdGlvbnMuZm9yY2VDb250ZXh0PW51bGxdIChQSVhJIG9ubHkpIFRoZSBzdGFnZSByZW5kZXJlciwgb3B0aW9ucyBhcmUgImNhbnZhczJkIiwgIndlYmdsIiBvciBudWxsLiBPbWl0dGluZyB0aGlzIChvciBudWxsKSB1c2VzIFdlYkdMIGlmIGF2YWlsYWJsZSwgYW5kIENhbnZhczJEIG90aGVyd2lzZS4KCSogIEBwYXJhbSB7Qm9vbGVhbn0gW29wdGlvbnMucmFmPWZhbHNlXSBVc2UgdGhlIHJlcXVlc3QgYW5pbWF0aW9uIGZyYW1lIGluc3RlYWQgb2YgYSBzZXRJbnRlcnZhbAoJKiAgQHBhcmFtIHtpbnR9IFtvcHRpb25zLmZwcz02MF0gU2V0IHRoZSBmcmFtZXJhdGUgCgkqICBAcGFyYW0ge1N0cmluZ30gW29wdGlvbnMudmVyc2lvbnNGaWxlXSBUaGUgdGV4dCBmaWVsZCB0byBzdG9yZSBjYWNoZS1idXN0aW5nIHZlcnNpb25zIGZvciBpbmRpdmlkdWFsIGZpbGVzCgkqICBAcGFyYW0ge1N0cmluZ30gW29wdGlvbnMuYmFzZVBhdGhdIFRoZSBiYXNlIHBhdGggdG8gbG9hZCBhbGwgZmlsZXMgZnJvbSAodXNlZnVsIGlmIHVzaW5nIGEgQ0ROKQoJKiAgQHBhcmFtIHtCb29sZWFufSBbb3B0aW9ucy5jYWNoZUJ1c3Q9ZmFsc2VdIElmIGFsbCBmaWxlIHJlcXVlc3RzIHdpdGggdGhlIE1lZGlhTG9hZGVyIHNob3VsZCBiZSBjYWNoZUJ1c3RlZCAoZS5nLiwgImZpbGUubXAzP2NiPTEyMzEyMyIpCgkqLwoJT1MuaW5pdCA9IGZ1bmN0aW9uKHN0YWdlTmFtZSwgb3B0aW9ucykKCXsKCQlpZiAoIV9pbnN0YW5jZSkKCQl7CgkJCWlmICh0cnVlKQoJCQl7CgkJCQlEZWJ1Zy5sb2coIkNyZWF0aW5nIHRoZSBzaW5nbGV0b24gaW5zdGFuY2Ugb2YgT1MiKTsKCQkJfQoJCQkKCQkJX2luc3RhbmNlID0gbmV3IE9TKCk7CgkJCV9pbnN0YW5jZS5pbml0aWFsaXplKHN0YWdlTmFtZSwgb3B0aW9ucyk7CgkJfQoJCXJldHVybiBfaW5zdGFuY2U7Cgl9OwoJCgkvKioKCSogIFRoZSBpbnRlcm5hbCBjb25zdHJ1Y3RvciBleHRlbmRzIENvbnRhaW5lciBjb25zdHJ1Y3RvcgoJKiAgQGNvbnN0cnVjdG9yCgkqICBAcHJvdGVjdGVkCgkqICBAbWV0aG9kIGluaXRpYWxpemUKCSogIEBwYXJhbSB7c3RyaW5nfSBzdGFnZU5hbWUgVGhlIHN0cmluZyBuYW1lIG9mIHRoZSBzdGFnZSBpZAoJKiAgQHBhcmFtIHtvYmplY3R9IFtvcHRpb25zXSBUaGUgb3B0aW9uYWwgb3B0aW9ucyB0byBzZXQsIHNlZSBPUy5pbml0KCkgZm9yIG1vcmUgaW5mb3JtYXRpb24gb24gdGhlIG9wdGlvbnMgdGhhdCBjYW4gYmUgc2V0LgoJKi8KCXAuaW5pdGlhbGl6ZSA9IGZ1bmN0aW9uKHN0YWdlTmFtZSwgb3B0aW9ucykKCXsKCQkvLyBDYWxsIHRoZSBzdXBlciBjb25zdHJ1Y3RvcgoJCWlmICh0cnVlKSB0aGlzLkNvbnRhaW5lcl9pbml0aWFsaXplKCk7CgkJaWYgKGZhbHNlKSBQSVhJLkRpc3BsYXlPYmplY3RDb250YWluZXIuY2FsbCh0aGlzKTsKCQkKCQkvLyBTZXR1cCB0aGUgb3B0aW9ucyBjb250YWluZXIKCQl0aGlzLm9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoJCQoJCS8vIFNlZSBpZiB3ZSBzaG91bGQgcGFyc2UgcXVlcnlzdHJpbmcKCQlpZiAodGhpcy5vcHRpb25zLnBhcnNlUXVlcnlTdHJpbmcgIT09IHVuZGVmaW5lZCkKCQkJdGhpcy5vcHRpb25zID0gcGFyc2VRdWVyeVN0cmluZ1BhcmFtcyh0aGlzLm9wdGlvbnMpOwoJCQoJCS8vIFR1cm4gb24gZGVidWdnaW5nCgkJaWYgKHRoaXMub3B0aW9ucy5kZWJ1ZyAhPT0gdW5kZWZpbmVkKQoJCQlEZWJ1Zy5lbmFibGVkID0gdGhpcy5vcHRpb25zLmRlYnVnID09PSB0cnVlIHx8IHRoaXMub3B0aW9ucy5kZWJ1ZyA9PT0gInRydWUiOwoJCQkKCQlpZiAodGhpcy5vcHRpb25zLm1pbkxvZ0xldmVsICE9PSB1bmRlZmluZWQpCgkJCURlYnVnLm1pbkxvZ0xldmVsID0gcGFyc2VJbnQodGhpcy5vcHRpb25zLm1pbkxvZ0xldmVsLCAxMCk7CgoJCS8vaWYgd2Ugd2VyZSBzdXBwbGllZCB3aXRoIGFuIElQIGFkZHJlc3MsIGNvbm5lY3QgdG8gaXQgd2l0aCB0aGUgRGVidWcgY2xhc3MgZm9yIGxvZ2dpbmcKCQlpZih0eXBlb2YgdGhpcy5vcHRpb25zLmlwID09ICJzdHJpbmciKQoJCQlEZWJ1Zy5jb25uZWN0KHRoaXMub3B0aW9ucy5pcCk7CgkKCQkvLyBTZXR1cCB0aGUgbWVkaWFsb2FkZXIKCQl2YXIgbG9hZGVyID0gY2xvdWRraWQuTWVkaWFMb2FkZXIuaW5pdCgpOwoJCQoJCS8vIFNldHVwIHRoZSBzdGFnZQoJCWlmKHRydWUpCgkJewoJCQl0aGlzLnN0YWdlID0gbmV3IGNyZWF0ZWpzLlN0YWdlKHN0YWdlTmFtZSk7CgkJCXRoaXMuc3RhZ2UubmFtZSA9ICJjbG91ZGtpZC5PUyI7CgkJCgkJCS8vIHByZXZlbnQgbW91c2UgZG93biB0dXJuaW5nIGludG8gY3Vyc29yCgkJCXRoaXMuc3RhZ2UuY2FudmFzLm9ubW91c2Vkb3duID0gZnVuY3Rpb24oZSkKCQkJewoJCQkJZS5wcmV2ZW50RGVmYXVsdCgpOwoJCQl9OwoKCQkJLy8gRW5hYmxlIHRoZSBtb3VzZW92ZXIgYnkgc2V0dGluZyB0aGUgZnJlcXVlbmN5CgkJCS8vIGlmIHdlIHNldCBtb3VzZU92ZXJSYXRlIDw9IDAsIHRoZW4gdHVybnMgb2ZmIG1vdXNlb3ZlciBlZmZlY3RzCgkJCXZhciBtb3VzZU92ZXJSYXRlID0gdGhpcy5vcHRpb25zLm1vdXNlT3ZlclJhdGUgPSB0aGlzLm9wdGlvbnMubW91c2VPdmVyUmF0ZSB8fCAzMDsKCQkJdGhpcy5zdGFnZS5lbmFibGVNb3VzZU92ZXIobW91c2VPdmVyUmF0ZSk7CgkJfQoJCQoJCWlmKGZhbHNlKQoJCXsKCQkJdGhpcy5zdGFnZSA9IG5ldyBQSVhJLlN0YWdlKHRoaXMub3B0aW9ucy5iYWNrZ3JvdW5kQ29sb3IgfHwgMCwgdHJ1ZSk7CgkJfQoJCXRoaXMuc3RhZ2UuYWRkQ2hpbGQodGhpcyk7CgkJCgkJLy9saXN0ZW4gZm9yIHdoZW4gdGhlIHBhZ2UgdmlzaWJpbGl0eSBjaGFuZ2VzIHNvIHdlIGNhbiBwYXVzZSBvdXIgdGltaW5ncwoJCXRoaXMudmlzaWJsZUxpc3RlbmVyID0gdGhpcy5vbldpbmRvd1Zpc2liaWxpdHlDaGFuZ2VkLmJpbmQodGhpcyk7CgkJYWRkUGFnZUhpZGVMaXN0ZW5lcih0aGlzLnZpc2libGVMaXN0ZW5lcik7CgkJCgkJaWYodHJ1ZSkKCQl7CgkJCS8vIFNldHVwIHRoZSB0b3VjaCBldmVudHMKCQkJdmFyIHRvdWNoRGV2aWNlPSh3aW5kb3cuaGFzT3duUHJvcGVydHkoJ29udG91Y2hzdGFydCcpKTsKCQkJCgkJCS8vSUUxMCBkb2Vzbid0IHNlbmQgbW91c2VvdmVyIGV2ZW50cyBwcm9wZXJseSBpZiB0b3VjaCBpcyBlbmFibGVkCgkJCWlmKHdpbmRvdy5uYXZpZ2F0b3IudXNlckFnZW50LmluZGV4T2YoIk1TSUUgMTAuMCIpICE9IC0xICYmICF0b3VjaERldmljZSkKCQkJewoJCQkJaWYgKHRydWUpIERlYnVnLmxvZygnSUUxMCBEZXNrdG9wJyk7CgkJCX0KCQkJZWxzZQoJCQkJY3JlYXRlanMuVG91Y2guZW5hYmxlKHRoaXMuc3RhZ2UpOwoKCQkJLy8gQ2xlYXIgdGhlIHN0YWdlCgkJCXRoaXMuc3RhZ2UuYXV0b0NsZWFyID0gISF0aGlzLm9wdGlvbnMuY2xlYXJWaWV3IHx8IGZhbHNlOwoJCQkKCQkJaWYodGhpcy5vcHRpb25zLnNob3dGcmFtZXJhdGUpCgkJCXsKCQkJCS8vIEFkZCB0aGUgZnJhbWUgcmF0ZSBvYmplY3QKCQkJCV9mcmFtZXJhdGUgPSBuZXcgY3JlYXRlanMuVGV4dCgnJywgJzEwcHggQXJpYWwnLCAnIzAwMCcpOwoJCQkJX2ZyYW1lcmF0ZS5zdHJva2UgPSB7d2lkdGg6MiwgY29sb3I6IiNmZmZmZmYifTsKCQkJCV9mcmFtZXJhdGUueCA9IF9mcmFtZXJhdGUueSA9IDU7CgkJCQl0aGlzLmFkZENoaWxkKF9mcmFtZXJhdGUpOwoJCQl9CgkJCQoJCQkvLyBJbml0aWFsIHJlbmRlcgoJCQl0aGlzLnN0YWdlLnVwZGF0ZSgpOwoJCX0KCQkKCQlpZihmYWxzZSkKCQl7CgkJCXZhciB0cmFuc3BhcmVudCA9ICEhdGhpcy5vcHRpb25zLnRyYW5zcGFyZW50IHx8IGZhbHNlOwoJCQl2YXIgcHJlTXVsdEFscGhhID0gISF0aGlzLm9wdGlvbnMucHJlTXVsdEFscGhhIHx8IGZhbHNlOwoKCQkJdGhpcy5jb250YWluZXJOYW1lID0gKHR5cGVvZiBzdGFnZU5hbWUgPT0gInN0cmluZyIpID8gc3RhZ2VOYW1lIDogc3RhZ2VOYW1lLmF0dHIoImlkIik7CgkJCXZhciBjb250YWluZXIgPSAodHlwZW9mIHN0YWdlTmFtZSA9PSAic3RyaW5nIikgPyBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChzdGFnZU5hbWUpIDogc3RhZ2VOYW1lOwoJCQl2YXIgY2FudmFzQ29udGFpbmVyID0gdGhpcy5jYW52YXNDb250YWluZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKCQkJY29udGFpbmVyLmFwcGVuZENoaWxkKGNhbnZhc0NvbnRhaW5lcik7CgkJCWNhbnZhc0NvbnRhaW5lci5pZCA9ICJDS09TIjsKCQkJCgkJCS8vY3JlYXRlIHRoZSByZW5kZXJlcmVyCgkJCXZhciB3aWR0aCA9IHRoaXMub3B0aW9ucy53aWR0aCB8fCBjb250YWluZXIuaW5uZXJXaWR0aDsKCQkJdmFyIGhlaWdodCA9IHRoaXMub3B0aW9ucy5oZWlnaHQgfHwgY29udGFpbmVyLmlubmVySGVpZ2h0OwoJCQlpZih0aGlzLm9wdGlvbnMuZm9yY2VDb250ZXh0ID09ICJjYW52YXMyZCIpCgkJCXsKCQkJCXRoaXMuX3JlbmRlcmVyID0gbmV3IFBJWEkuQ2FudmFzUmVuZGVyZXIoCgkJCQkJd2lkdGgsIAoJCQkJCWhlaWdodCwgCgkJCQkJbnVsbCwgCgkJCQkJdHJhbnNwYXJlbnQKCQkJCSk7CgkJCX0KCQkJZWxzZSBpZih0aGlzLm9wdGlvbnMuZm9yY2VDb250ZXh0ID09ICJ3ZWJnbCIpCgkJCXsKCQkJCXRoaXMuX3JlbmRlcmVyID0gbmV3IFBJWEkuV2ViR0xSZW5kZXJlcigKCQkJCQl3aWR0aCwgCgkJCQkJaGVpZ2h0LAoJCQkJCW51bGwsIAoJCQkJCXRyYW5zcGFyZW50LAoJCQkJCXByZU11bHRBbHBoYQoJCQkJKTsKCQkJfQoJCQllbHNlCgkJCXsKCQkJCXRoaXMuX3JlbmRlcmVyID0gUElYSS5hdXRvRGV0ZWN0UmVuZGVyZXIoCgkJCQkJd2lkdGgsIAoJCQkJCWhlaWdodCwKCQkJCQludWxsLCAKCQkJCQl0cmFuc3BhcmVudCwKCQkJCQlwcmVNdWx0QWxwaGEKCQkJCSk7CgkJCX0KCQkJY2FudmFzQ29udGFpbmVyLmFwcGVuZENoaWxkKHRoaXMuX3JlbmRlcmVyLnZpZXcpOwoJCQljYW52YXNDb250YWluZXIuc2V0QXR0cmlidXRlKCJzdHlsZSIsInBvc2l0aW9uOnJlbGF0aXZlO3dpZHRoOiIgKyB3aWR0aCArICJweDtoZWlnaHQ6IiArIGhlaWdodCArICJweCIpOwoJCQkKCQkJLy9IZXJlIGF0IENsb3VkS2lkLCB3ZSBhbHdheXMgaGF2ZSBhIGJpdG1hcCBiYWNrZ3JvdW5kLCBzbyB3ZSBjYW4gZ2V0IGJldHRlciBwZXJmb3JtYW5jZSBieSBub3QgY2xlYXJpbmcgdGhlIHJlbmRlciBhcmVhIGVhY2ggcmVuZGVyCgkJCXRoaXMuX3JlbmRlcmVyLmNsZWFyVmlldyA9ICEhdGhpcy5vcHRpb25zLmNsZWFyVmlldzsKCgkJCWlmKHRoaXMub3B0aW9ucy5zaG93RnJhbWVyYXRlKQoJCQl7CgkJCQkvLyBBZGQgdGhlIGZyYW1lIHJhdGUgb2JqZWN0CgkJCQlfZnJhbWVyYXRlID0gbmV3IFBJWEkuVGV4dCgnRlBTOiAwLjAwMCcsIHtmb250OicxMHB4IEFyaWFsJywgZmlsbDonYmxhY2snLCBzdHJva2U6J3doaXRlJywgc3Ryb2tlVGhpY2tuZXNzOjJ9KTsKCQkJCV9mcmFtZXJhdGUueCA9IF9mcmFtZXJhdGUueSA9IDU7CgkJCQl0aGlzLmFkZENoaWxkKF9mcmFtZXJhdGUpOwoJCQl9CgkJCQoJCQkvLyBJbml0aWFsIHJlbmRlcgoJCQl0aGlzLl9yZW5kZXJlci5yZW5kZXIodGhpcy5zdGFnZSk7CgkJfQoJCQoJCS8vc2V0IHVwIHRoZSB0aWNrIGNhbGxiYWNrCgkJX3RpY2tDYWxsYmFjayA9IHRoaXMudGljay5iaW5kKHRoaXMpOwoJCQoJCS8vIElmIHdlIHNob3VsZCB1c2UgcmVxdWVzdEFuaW1hdGlvbkZyYW1lIGluIHRoZSBicm93c2VyIGluc3RlYWQgb2Ygc2V0VGltZW91dAoJCV91c2VSQUYgPSB0aGlzLm9wdGlvbnMucmFmIHx8IGZhbHNlOwoJCQoJCS8vVGhlIGZwcyB0byB0YXJnZXQgLSBvbmx5IHVzZWQgaWYgbm90IHVzaW5nIHJlcXVlc3RBbmltYXRpb25GcmFtZQoJCXRoaXMuZnBzID0gdGhpcy5vcHRpb25zLmZwcyB8fCA2MDsKCgkJLy8gU2V0IHRoZSBhcHAgdG8gZGVmYXVsdAoJCXRoaXMucmVtb3ZlQXBwKCk7CgkJCgkJLy8gQ2hlY2sgdG8gc2VlIGlmIHdlIHNob3VsZCBsb2FkIGEgdmVyc2lvbnMgZmlsZQoJCS8vIFRoZSB2ZXJzaW9ucyBmaWxlIGtlZXBzIHRyYWNrIG9mIHRoZSBPUyB2ZXJzaW9uCgkJaWYgKHRoaXMub3B0aW9ucy52ZXJzaW9uc0ZpbGUgIT09IHVuZGVmaW5lZCkKCQl7CgkJCV9pc1JlYWR5ID0gZmFsc2U7CgkJCQoJCQl2YXIgb3MgPSB0aGlzOwoJCQkKCQkJLy8gVHJ5IHRvIGxvYWQgdGhlIGRlZmF1bHQgdmVyc2lvbnMgZmlsZQoJCQkvLyBjYWxsYmFjayBzaG91bGQgYmUgbWFkZSB3aXRoIGEgc2NvcGUgaW4gbWluZAoJCQlsb2FkZXIuY2FjaGVNYW5hZ2VyLmFkZFZlcnNpb25zRmlsZSgKCQkJCXRoaXMub3B0aW9ucy52ZXJzaW9uc0ZpbGUsIAoJCQkJZnVuY3Rpb24oKXsKCQkJCQkKCQkJCQlfaXNSZWFkeSA9IHRydWU7CgkJCQkJCgkJCQkJLy8gU29tZW9uZSBhZGRlZCBhbiBhcHBsaWNhdGlvbiBiZWZvcmUgdGhlIE9TIHdhcyByZWFkeQoJCQkJCS8vIGxldHMgaW5pdGlhbGl6ZSBpcyBub3cKCQkJCQlpZiAob3MuX2FwcCkKCQkJCQl7CgkJCQkJCW9zLmFkZENoaWxkQXQob3MuX2FwcCwgMCk7CgkJCQkJCW9zLl9hcHAuaW5pdCgpOwoJCQkJCQlvcy5yZXN1bWUoKTsKCQkJCQl9CgkJCQl9CgkJCSk7CgkJfQoJCWVsc2UKCQl7CgkJCV9pc1JlYWR5ID0gdHJ1ZTsKCQl9Cgl9OwoJCgl2YXIgaGlkZGVuID0gbnVsbDsvL25lZWRlZCBpbnNpZGUgdGhlIGV2ZW50IGxpc3RlbmVyIGFzIHdlbGwKCXZhciBldnRNYXAgPSBudWxsOwoJdmFyIHYgPSAndmlzaWJsZScsIGggPSAnaGlkZGVuJzsKCXZhciBhZGRQYWdlSGlkZUxpc3RlbmVyID0gZnVuY3Rpb24obGlzdGVuZXIpCgl7CgkJaGlkZGVuID0gImhpZGRlbiI7CgkJLy8gU3RhbmRhcmRzOgoJCWlmIChoaWRkZW4gaW4gZG9jdW1lbnQpCgkJCWRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoInZpc2liaWxpdHljaGFuZ2UiLCBsaXN0ZW5lcik7CgkJZWxzZSBpZiAoKGhpZGRlbiA9ICJtb3pIaWRkZW4iKSBpbiBkb2N1bWVudCkKCQkJZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigibW96dmlzaWJpbGl0eWNoYW5nZSIsIGxpc3RlbmVyKTsKCQllbHNlIGlmICgoaGlkZGVuID0gIndlYmtpdEhpZGRlbiIpIGluIGRvY3VtZW50KQoJCQlkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCJ3ZWJraXR2aXNpYmlsaXR5Y2hhbmdlIiwgbGlzdGVuZXIpOwoJCWVsc2UgaWYgKChoaWRkZW4gPSAibXNIaWRkZW4iKSBpbiBkb2N1bWVudCkKCQkJZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigibXN2aXNpYmlsaXR5Y2hhbmdlIiwgbGlzdGVuZXIpOwoJCWVsc2UgaWYgKCdvbmZvY3VzaW4nIGluIGRvY3VtZW50KS8vIElFIDkgYW5kIGxvd2VyOgoJCXsKCQkJZXZ0TWFwID0geyBmb2N1c2luOnYsIGZvY3Vzb3V0OmggfTsKCQkJZG9jdW1lbnQub25mb2N1c2luID0gZG9jdW1lbnQub25mb2N1c291dCA9IGxpc3RlbmVyOwoJCX0KCQllbHNlLy8gQWxsIG90aGVyczoKCQl7CgkJCWV2dE1hcCA9IHsgZm9jdXM6diwgcGFnZXNob3c6diwgYmx1cjpoLCBwYWdlaGlkZTpoIH07CgkJCXdpbmRvdy5vbnBhZ2VzaG93ID0gd2luZG93Lm9ucGFnZWhpZGUgPSB3aW5kb3cub25mb2N1cyA9IHdpbmRvdy5vbmJsdXIgPSBsaXN0ZW5lcjsKCQl9Cgl9OwoJCgl2YXIgcmVtb3ZlUGFnZUhpZGVMaXN0ZW5lciA9IGZ1bmN0aW9uKGxpc3RlbmVyKQoJewoJCXZhciBoaWRkZW4gPSAiaGlkZGVuIjsKCQlpZiAoaGlkZGVuIGluIGRvY3VtZW50KQoJCQlkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCJ2aXNpYmlsaXR5Y2hhbmdlIiwgbGlzdGVuZXIpOwoJCWVsc2UgaWYgKChoaWRkZW4gPSAibW96SGlkZGVuIikgaW4gZG9jdW1lbnQpCgkJCWRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoIm1venZpc2liaWxpdHljaGFuZ2UiLCBsaXN0ZW5lcik7CgkJZWxzZSBpZiAoKGhpZGRlbiA9ICJ3ZWJraXRIaWRkZW4iKSBpbiBkb2N1bWVudCkKCQkJZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcigid2Via2l0dmlzaWJpbGl0eWNoYW5nZSIsIGxpc3RlbmVyKTsKCQllbHNlIGlmICgoaGlkZGVuID0gIm1zSGlkZGVuIikgaW4gZG9jdW1lbnQpCgkJCWRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoIm1zdmlzaWJpbGl0eWNoYW5nZSIsIGxpc3RlbmVyKTsKCQlkb2N1bWVudC5vbmZvY3VzaW4gPSBkb2N1bWVudC5vbmZvY3Vzb3V0ID0gbnVsbDsKCQl3aW5kb3cub25wYWdlc2hvdyA9IHdpbmRvdy5vbnBhZ2VoaWRlID0gd2luZG93Lm9uZm9jdXMgPSB3aW5kb3cub25ibHVyID0gbnVsbDsKCX07CgoJcC5vbldpbmRvd1Zpc2liaWxpdHlDaGFuZ2VkID0gZnVuY3Rpb24oZXZ0KQoJewoJCXZhciB2ID0gJ3Zpc2libGUnLCBoID0gJ2hpZGRlbic7CgoJCWV2dCA9IGV2dCB8fCB3aW5kb3cuZXZlbnQ7CgkJdmFyIHZhbHVlOwoJCWlmIChldnRNYXApCgkJCXZhbHVlID0gZXZ0TWFwW2V2dC50eXBlXTsKCQllbHNlCgkJCXZhbHVlID0gZG9jdW1lbnRbaGlkZGVuXSA/IGggOiB2OwoJCWlmKHZhbHVlID09IGgpCgkJCXRoaXMucGF1c2UoKTsKCQllbHNlCgkJCXRoaXMucmVzdW1lKCk7Cgl9OwoJCgkvKioKCSogIERlZmluZSBhbGwgb2YgdGhlIHF1ZXJ5IHN0cmluZyBwYXJhbWV0ZXJzCgkqICBAcHJpdmF0ZQoJKiAgQG1ldGhvZCBwYXJzZVF1ZXJ5U3RyaW5nUGFyYW1zCgkqICBAcGFyYW0ge29iamVjdH0gb3V0cHV0IFRoZSBvYmplY3QgcmVmZXJlbmNlIHRvIHVwZGF0ZQoJKi8KCXZhciBwYXJzZVF1ZXJ5U3RyaW5nUGFyYW1zID0gZnVuY3Rpb24ob3V0cHV0KQoJewoJCXZhciBocmVmID0gd2luZG93LmxvY2F0aW9uLmhyZWY7CgkJdmFyIHF1ZXN0aW9uTWFyayA9IGhyZWYuaW5kZXhPZigiPyIpOwoJCWlmIChxdWVzdGlvbk1hcmsgPT0gLTEpIHJldHVybiBvdXRwdXQ7CgkJCgkJdmFyIHZhcnMgPSBxdWVzdGlvbk1hcmsgPCAwID8gJycgOiBocmVmLnN1YnN0cihxdWVzdGlvbk1hcmsrMSk7CgkJdmFyIHBvdW5kID0gdmFycy5pbmRleE9mKCcjJyk7CgkJdmFycyA9IHBvdW5kIDwgMCA/IHZhcnMgOiB2YXJzLnN1YnN0cmluZygwLCBwb3VuZCk7CgkJdmFyIHNwbGl0Rmxhc2hWYXJzID0gdmFycy5zcGxpdCgiJiIpOwoJCXZhciBteVZhcjsKCQlmb3IgKHZhciBpID0gMDsgaSA8IHNwbGl0Rmxhc2hWYXJzLmxlbmd0aDsgaSsrKQoJCXsKCQkJbXlWYXIgPSBzcGxpdEZsYXNoVmFyc1tpXS5zcGxpdCgiPSIpOwoJCQlpZiAodHJ1ZSkKCQkJewoJCQkJRGVidWcubG9nKG15VmFyWzBdICsgIiAtPiAiICsgbXlWYXJbMV0pOwoJCQl9CgkJCW91dHB1dFtteVZhclswXV0gPSBteVZhclsxXTsKCQl9CgkJcmV0dXJuIG91dHB1dDsKCX07CgkKCS8qKgoJKiAgUGF1c2UgdGhlIE9TIGFuZCBzdG9wIGZyYW1lIHVwZGF0ZXMKCSogIEBwdWJsaWMKCSogIEBtZXRob2QgcGF1c2UKCSovCglwLnBhdXNlID0gZnVuY3Rpb24oKQoJewoJCWlmKF90aWNrSWQgIT0gLTEpCgkJewoJCQlpZihfdXNlUkFGKQoJCQl7CgkJCQlpZih3aW5kb3cuY2FuY2VsQW5pbWF0aW9uRnJhbWUpCgkJCQkJY2FuY2VsQW5pbWF0aW9uRnJhbWUoX3RpY2tJZCk7CgkJCX0KCQkJZWxzZQoJCQkJY2xlYXJUaW1lb3V0KF90aWNrSWQpOwoJCQlfdGlja0lkID0gLTE7CgkJfQoJCV9wYXVzZWQgPSB0cnVlOwoJfTsKCQoJdmFyIG5vd0Z1bmMgPSB3aW5kb3cucGVyZm9ybWFuY2UgJiYgKHBlcmZvcm1hbmNlLm5vdyB8fCBwZXJmb3JtYW5jZS5tb3pOb3cgfHwgcGVyZm9ybWFuY2UubXNOb3cgfHwgcGVyZm9ybWFuY2Uub05vdyB8fCBwZXJmb3JtYW5jZS53ZWJraXROb3cpOwoJaWYobm93RnVuYykKCQlub3dGdW5jID0gbm93RnVuYy5iaW5kKHBlcmZvcm1hbmNlKTsKCWVsc2UKCQlub3dGdW5jID0gZnVuY3Rpb24oKSB7IHJldHVybiBuZXcgRGF0ZSgpLmdldFRpbWUoKTsgfTsvL2FwcGFyZW50bHkgaW4gQ2hyb21lIHRoaXMgaXMgZXh0cmVtZWx5IGluYWNjdXJhdGUgKHRyaXBsZSBmcmFtZXJhdGUgb3Igc29tZXRoaW5nIHNpbGx5KQoKCS8qKgoJKiAgR2V0cyB0aGUgY3VycmVudCB0aW1lIGluIG1pbGxpc2Vjb25kcyBmb3IgdGltaW5nIHB1cnBvc2VzCgkqICBAcHVibGljCgkqICBAbWV0aG9kIGdldFRpbWUKCSovCglwLmdldFRpbWUgPSBmdW5jdGlvbigpCgl7CgkJcmV0dXJuIG5vd0Z1bmMoKTsKCX07CgkKCS8qKgoJKiAgUmVzdW1lIHRoZSBPUyB1cGRhdGVzCgkqICBAcHVibGljCgkqICBAbWV0aG9kIHJlc3VtZQoJKi8KCXAucmVzdW1lID0gZnVuY3Rpb24oKQoJewoJCV9wYXVzZWQgPSBmYWxzZTsKCQkKCQlpZihfdGlja0lkID09IC0xKQoJCXsKCQkJX3RpY2tJZCA9IF91c2VSQUYgPyAKCQkJCXJlcXVlc3RBbmltRnJhbWUoX3RpY2tDYWxsYmFjayk6IAoJCQkJc2V0VGFyZ2V0ZWRUaW1lb3V0KF90aWNrQ2FsbGJhY2spOwoJCX0KCQlfbGFzdEZQU1VwZGF0ZVRpbWUgPSBfbGFzdEZyYW1lVGltZSA9IHRoaXMuZ2V0VGltZSgpOwoJfTsKCQoJLyoqCgkqIFRoZSBGUFMgdGhhdCB0aGUgT1MgaXMgdGFyZ2V0aW5nLgoJKiAKCSogQHByb3BlcnR5IHtOdW1iZXJ9IGZwcwoJKiBAcHVibGljCgkqLwoJT2JqZWN0LmRlZmluZVByb3BlcnR5KHAsICJmcHMiLCB7CgkJZ2V0OiBmdW5jdGlvbigpIHsgcmV0dXJuIF9mcHM7IH0sCgkJc2V0OiBmdW5jdGlvbih2YWx1ZSkgewoJCQlpZih0eXBlb2YgdmFsdWUgIT0gIm51bWJlciIpIHJldHVybjsKCQkJX2ZwcyA9IHZhbHVlOwoJCQlfbXNQZXJGcmFtZSA9ICgxMDAwIC8gX2ZwcykgfCAwOwoJCX0KCX0pOwoJCgkvKioKCSogIENvbnZlbmllbmNlIGZvciBhY2Nlc3NpbmcgdGhlIHN0YWdlJ3Mgd2lkdGgKCSogICAKCSogIEBwcm9wZXJ0eSB7TnVtYmVyfSBzdGFnZVdpZHRoCgkqICBAcHVibGljCgkqICBAcmVhZE9ubHkKCSovCglPYmplY3QuZGVmaW5lUHJvcGVydHkocCwgInN0YWdlV2lkdGgiLCB7CgkJZ2V0OiBmdW5jdGlvbigpewoJCQlpZiAodHJ1ZSkgcmV0dXJuIF9pbnN0YW5jZS5zdGFnZS5jYW52YXMud2lkdGg7CgkJCWlmIChmYWxzZSkgcmV0dXJuIF9pbnN0YW5jZS5fcmVuZGVyZXIudmlldy53aWR0aDsKCQl9Cgl9KTsKCQoJLyoqCgkqICBDb252ZW5pZW5jZSBmb3IgYWNjZXNzaW5nIHRoZSBzdGFnZSdzIGhlaWdodAoJKiAgIAoJKiAgQHByb3BlcnR5IHtOdW1iZXJ9IHN0YWdlSGVpZ2h0CgkqICBAcHVibGljCgkqICBAcmVhZE9ubHkKCSovCglPYmplY3QuZGVmaW5lUHJvcGVydHkocCwgInN0YWdlSGVpZ2h0IiwgewoJCWdldDogZnVuY3Rpb24oKXsKCQkJaWYgKHRydWUpIHJldHVybiBfaW5zdGFuY2Uuc3RhZ2UuY2FudmFzLmhlaWdodDsKCQkJaWYgKGZhbHNlKSByZXR1cm4gX2luc3RhbmNlLl9yZW5kZXJlci52aWV3LmhlaWdodDsKCQl9Cgl9KTsKCQoJdmFyIHNldFRhcmdldGVkVGltZW91dCA9IGZ1bmN0aW9uKGNhbGxiYWNrLCB0aW1lSW5GcmFtZSkKCXsKCQl2YXIgdGltZVRvQ2FsbCA9IDA7CgkJaWYodGltZUluRnJhbWUpCgkJCXRpbWVUb0NhbGwgPSBNYXRoLm1heCgwLCBfbXNQZXJGcmFtZSAtIHRpbWVJbkZyYW1lKTsvL3N1YnRyYWN0IHRoZSB0aW1lIHNwZW50IGluIHRoZSBmcmFtZSB0byBhY3R1YWxseSBoaXQgdGhlIHRhcmdldCBmcHMKCQlyZXR1cm4gc2V0VGltZW91dChjYWxsYmFjaywgdGltZVRvQ2FsbCk7Cgl9OwoJCgkvKioKCSogIFJlbW92ZSB0aGUgYXBwbGljYXRpb24KCSogIEBwdWJsaWMKCSogIEBtZXRob2QgcmVtb3ZlQXBwCgkqICBAcGFyYW0ge0Jvb2xlYW59IGRlc3Ryb3lpbmcgSWYgdGhlIE9TIGlzIGJlaW5nIGRlc3Ryb3llZCBhbmQgc2hvdWxkbid0IGJvdGhlciBydW5uaW5nIGFueSByZXNldHRpbmcgY29kZS4KCSogIEByZXR1cm4ge0Jvb2xlYW59IElmIGFuIGBBcHBsaWNhdGlvbmAgd2FzIHN1Y2Nlc3NmdWxseSByZW1vdmVkCgkqLwoJcC5yZW1vdmVBcHAgPSBmdW5jdGlvbihkZXN0cm95aW5nKQoJewoJCXZhciByZW1vdmVkID0gZmFsc2U7CgkJCgkJdmFyIHN0YWdlID0gdGhpcy5zdGFnZTsKCQlpZiAodGhpcy5fYXBwKQoJCXsKCQkJaWYodHJ1ZSkKCQkJewoJCQkJaWYodGhpcy5jb250YWlucyh0aGlzLl9hcHApKQoJCQkJCXRoaXMucmVtb3ZlQ2hpbGQodGhpcy5fYXBwKTsKCQkJCXN0YWdlLnJlbW92ZUFsbENoaWxkcmVuKCk7CgkJCX0KCQkJaWYoZmFsc2UpCgkJCXsKCQkJCWlmKHRoaXMuX2FwcC5wYXJlbnQgPT0gdGhpcykKCQkJCQl0aGlzLnJlbW92ZUNoaWxkKHRoaXMuX2FwcCk7CgkJCQlzdGFnZS5yZW1vdmVDaGlsZHJlbigpOwoJCQl9CgkJCXRoaXMuX2FwcC5kZXN0cm95KCk7CgkJCXJlbW92ZWQgPSB0cnVlOwoJCX0KCQl0aGlzLl9hcHAgPSBudWxsOwoJCQoJCS8vIFN0b3AgdGhlIHVwZGF0ZQoJCXRoaXMucGF1c2UoKTsKCQkJCQoJCWlmKCFkZXN0cm95aW5nKQoJCXsJCQkKCQkJc3RhZ2UuYWRkQ2hpbGQodGhpcyk7CgkJCWlmKF9mcmFtZXJhdGUpCgkJCXsKCQkJCS8vIFJlc2V0IHRoZSBmcmFtZXJhdGUKCQkJCV9mcmFtZXJhdGUudGV4dCA9ICJGUFM6IDAuMDAwIjsKCQkJfQoJCQkKCQkJLy8gSWdub3JlIHNwaWtlcyBpbiBmcmFtZSBjb3VudAoJCQlfbGFzdEZyYW1lVGltZSA9IF9sYXN0RlBTVXBkYXRlVGltZSA9IF9mcmFtZXJhdGVWYWx1ZSA9IF9mcmFtZUNvdW50ID0gMDsKCQkJCgkJCS8vIFVwZGF0ZSB0aGUgc3RhZ2UKCQkJaWYoZmFsc2UpIHRoaXMuX3JlbmRlcmVyLnJlbmRlcihzdGFnZSk7CgkJCWVsc2UgaWYodHJ1ZSkgdGhpcy5zdGFnZS51cGRhdGUoKTsKCQl9CgkJCgkJcmV0dXJuIHJlbW92ZWQ7Cgl9OwoJCgkvKioKCSogIEFkZCBhbiBhcHAgdG8gdGhpcyBkaXNwbGF5IGxpc3QKCSogIEBwdWJsaWMgCgkqICBAbWV0aG9kIGFkZEFwcAoJKiAgQHBhcmFtIHtBcHBsaWNhdGlvbn0gYXBwIFRoZSBhcHBsaWNhdGlvbiB0byBhZGQKCSovCglwLmFkZEFwcCA9IGZ1bmN0aW9uKGFwcCkKCXsKCQl0aGlzLnJlbW92ZUFwcCgpOwoJCWlmICghKGFwcCBpbnN0YW5jZW9mIGNsb3Vka2lkLkFwcGxpY2F0aW9uKSkKCQl7CgkJCXRocm93IG5ldyBFcnJvcigiQ2FuIG9ubHkgb2JqZWN0cyB0aGF0IGluaGVyaXQgY2xvdWRraWQuQXBwbGljYXRpb24iKTsKCQl9CgkJdGhpcy5fYXBwID0gYXBwOwoJCWlmIChfaXNSZWFkeSkKCQl7CgkJCXRoaXMuYWRkQ2hpbGRBdChhcHAsIDApOwoJCQl0aGlzLl9hcHAuaW5pdCgpOwoJCQl0aGlzLnJlc3VtZSgpOwoJCX0KCX07CgkKCS8qKgoJKiAgR2V0IHRoZSBjdXJyZW50IGFwcGxpY2F0aW9uCgkqICBAbWV0aG9kIGdldEFwcAoJKiAgQHB1YmxpYwoJKiAgQHJldHVybiB7QXBwbGljYXRpb259IFRoZSBjdXJyZW50IEFwcGxpY2F0aW9uLCBudWxsIGlmIG5vIGFwcGxpY2F0aW9uCgkqLwoJcC5nZXRBcHAgPSBmdW5jdGlvbigpCgl7CgkJcmV0dXJuIHRoaXMuX2FwcDsKCX07CgkKCS8qKgoJKiAgQWRkIGFuIHVwZGF0ZSBjYWxsYmFjaywgbXVzdCB0YWtlIGVsYXBzZWQgYXMgYSBwYXJhbWV0ZXIKCSogIEBtZXRob2QgYWRkVXBkYXRlQ2FsbGJhY2sKCSogIEBwdWJsaWMKCSogIEBwYXJhbSB7c3RyaW5nfSBhbGlhcyBBbiBhbGlhcyB0byBhc3NvY2lhdGUgd2l0aCB0aGlzIGNhbGxiYWNrCgkqICBAcGFyYW0ge2Z1bmN0aW9ufSBmIFRoZSBjYWxsYmFjayBmdW5jdGlvbgoJKi8KCXAuYWRkVXBkYXRlQ2FsbGJhY2sgPSBmdW5jdGlvbihhbGlhcywgZikKCXsKCQlpZiAodGhpcy5fdXBkYXRlRnVuY3Rpb25zW2FsaWFzXSA9PT0gdW5kZWZpbmVkKQoJCXsKCQkJdGhpcy5fdXBkYXRlRnVuY3Rpb25zW2FsaWFzXSA9IGY7CgkJfQkJCgl9OwoJCgkvKioKCSogIFJlbW92ZSBhbiB1cGRhdGUgY2FsbGJhY2ssIG11c3QgdGFrZSBlbGFwc2VkIGFzIGEgcGFyYW1ldGVyCgkqICBAcHVibGljCgkqICBAbWV0aG9kIHJlbW92ZVVwZGF0ZUNhbGxiYWNrCgkqICBAcGFyYW0ge3N0cmluZ30gYWxpYXMgVGhlIGNhbGxiYWNrIGZ1bmN0aW9uIGFsaWFzCgkqLwoJcC5yZW1vdmVVcGRhdGVDYWxsYmFjayA9IGZ1bmN0aW9uKGFsaWFzKQoJewoJCWlmICh0aGlzLl91cGRhdGVGdW5jdGlvbnNbYWxpYXNdICE9PSB1bmRlZmluZWQpCgkJewoJCQlkZWxldGUgdGhpcy5fdXBkYXRlRnVuY3Rpb25zW2FsaWFzXTsKCQl9Cgl9OwoJCgkvKioKCSogIENhbGxlZCBieSB0aGUgc3RhZ2UgbGlzdGVuZXIKCSogIEBwdWJsaWMKCSogIEBtZXRob2QgdGljawoJKi8KCXAudGljayA9IGZ1bmN0aW9uKCkKCXsKCQlpZiAoX3BhdXNlZCkKCQl7CgkJCV90aWNrSWQgPSAtMTsKCQkJcmV0dXJuOwoJCX0KCQkKCQl2YXIgbm93ID0gdGhpcy5nZXRUaW1lKCk7CgkJdmFyIGRUaW1lID0gbm93IC0gX2xhc3RGcmFtZVRpbWU7CgkJCgkJLy8gT25seSB1cGRhdGUgdGhlIGZyYW1lcmF0ZSBldmVyIHNlY29uZAoJCWlmKF9mcmFtZXJhdGUgJiYgX2ZyYW1lcmF0ZS52aXNpYmxlKQoJCXsKCQkJX2ZyYW1lQ291bnQrKzsKCQkJdmFyIGVsYXBzZWQgPSBub3cgLSBfbGFzdEZQU1VwZGF0ZVRpbWU7CgkJCWlmIChlbGFwc2VkID4gMTAwMCkKCQkJewoJCQkJX2ZyYW1lcmF0ZVZhbHVlID0gMTAwMCAvIGVsYXBzZWQgKiBfZnJhbWVDb3VudDsKCQkJCWlmKGZhbHNlKQoJCQkJCV9mcmFtZXJhdGUuc2V0VGV4dCgiRlBTOiAiICsgKE1hdGgucm91bmQoX2ZyYW1lcmF0ZVZhbHVlICogMTAwMCkgLyAxMDAwKSk7CgkJCQllbHNlIGlmKHRydWUpCgkJCQkJX2ZyYW1lcmF0ZS50ZXh0ID0gIkZQUzogIiArIChNYXRoLnJvdW5kKF9mcmFtZXJhdGVWYWx1ZSAqIDEwMDApIC8gMTAwMCk7CgkJCQlfbGFzdEZQU1VwZGF0ZVRpbWUgPSBub3c7CgkJCQlfZnJhbWVDb3VudCA9IDA7CgkJCX0KCQl9CgkJX2xhc3RGcmFtZVRpbWUgPSBub3c7CgkJCgkJLy91cGRhdGUgYXBwCQkJCQoJCWlmICh0aGlzLl9hcHApCgkJewoJCQl0aGlzLl9hcHAudXBkYXRlKGRUaW1lKTsKCQl9CgkJLy91cGRhdGUgb3RoZXIgZnVuY3Rpb25zCgkJZm9yKHZhciBhbGlhcyBpbiB0aGlzLl91cGRhdGVGdW5jdGlvbnMpCgkJewoJCQl0aGlzLl91cGRhdGVGdW5jdGlvbnNbYWxpYXNdKGRUaW1lKTsKCQl9CgkJLy9yZW5kZXIgc3RhZ2UKCQlpZiAoZmFsc2UpIHRoaXMuX3JlbmRlcmVyLnJlbmRlcih0aGlzLnN0YWdlKTsKCQlpZiAodHJ1ZSkgdGhpcy5zdGFnZS51cGRhdGUoZFRpbWUpOwoJCQoJCS8vcmVxdWVzdCB0aGUgbmV4dCBhbmltYXRpb24gZnJhbWUKCQlfdGlja0lkID0gX3VzZVJBRiA/IAoJCQlyZXF1ZXN0QW5pbUZyYW1lKF90aWNrQ2FsbGJhY2spIDogCgkJCXNldFRhcmdldGVkVGltZW91dChfdGlja0NhbGxiYWNrLCB0aGlzLmdldFRpbWUoKSAtIF9sYXN0RnJhbWVUaW1lKTsKCX07CgkKCS8qKgoJKiAgW1BJWEkgT25seV0gUmVzaXplcyB0aGUgcmVuZGVyZXIgYW5kIHRoZSBjYW52YXNDb250YWluZXIuCgkqICBAcHVibGljCgkqICBAbWV0aG9kIHJlc2l6ZQoJKi8KCWlmKGZhbHNlKQoJewoJCXAucmVzaXplID0gZnVuY3Rpb24od2lkdGgsIGhlaWdodCkKCQl7CgkJCXRoaXMuX3JlbmRlcmVyLnJlc2l6ZSh3aWR0aCwgaGVpZ2h0KTsKCQkJdGhpcy5jYW52YXNDb250YWluZXIuc2V0QXR0cmlidXRlKCJzdHlsZSIsInBvc2l0aW9uOnJlbGF0aXZlO3dpZHRoOiIgKyB3aWR0aCArICJweDtoZWlnaHQ6IiArIGhlaWdodCArICJweCIpOwoJCX07Cgl9CgkKCS8qKgoJKiAgRGVzdHJveSB0aGUgaW5zdGFuY2Ugb2YgdGhlIE9TLCBjYW4gaW5pdCBhZnRlciB0aGlzLAoJKiAgYWxzbyBkZXN0cm95cyB0aGUgYXBwbGljYXRpb24sIGlmIGFyb3VuZAoJKiAgQHB1YmxpYwoJKiAgQG1ldGhvZCBkZXN0cm95CgkqLwoJcC5kZXN0cm95ID0gZnVuY3Rpb24oKQoJewoJCXZhciBzdGFnZSA9IHRoaXMuc3RhZ2U7Ly9rZWVwIGEgcmVmZXJlbmNlIGZvciBsYXRlciBpbiBjYXNlIHRoZSBPUyBpcyByZW1vdmVkIGZyb20gdGhlIHN0YWdlCgkJCgkJdmFyIG1sID0gY2xvdWRraWQuTWVkaWFMb2FkZXIuaW5zdGFuY2U7CgkJdGhpcy5wYXVzZSgpOwoJCXRoaXMucmVtb3ZlQXBwKHRydWUpOwoJCV9pbnN0YW5jZSA9IG51bGw7CgkJCgkJaWYodHJ1ZSkKCQl7CgkJCWNyZWF0ZWpzLlRvdWNoLmRpc2FibGUoc3RhZ2UpOwoJCQlzdGFnZS5lbmFibGVNb3VzZU92ZXIoLTEpOy8vZGlzYWJsZSBtb3VzZW92ZXIgZXZlbnRzCgkJCXN0YWdlLmVuYWJsZURPTUV2ZW50cyhmYWxzZSk7CgkJfQoJCQoJCW1sLmRlc3Ryb3koKTsKCQl0aGlzLnN0YWdlID0gbnVsbDsKCQl0aGlzLl91cGRhdGVGdW5jdGlvbnMgPSBudWxsOwoJCXJlbW92ZVBhZ2VIaWRlTGlzdGVuZXIodGhpcy52aXNpYmxlTGlzdGVuZXIpOwoJCQoJCWlmKGZhbHNlKQoJCXsKCQkJdGhpcy5yZW1vdmVDaGlsZHJlbih0cnVlKTsKCQkJc3RhZ2UuZGVzdHJveSgpOwoJCQl0aGlzLl9yZW5kZXJlci5kZXN0cm95KCk7CgkJCXRoaXMuX3JlbmRlcmVyID0gbnVsbDsKCQkJdGhpcy5jYW52YXNDb250YWluZXIgPSBudWxsOwoJCX0KCX07CgkKCS8qKgoJKiAgU3RhdGljIGZ1bmN0aW9uIGZvciBnZXR0aW5nIHRoZSBzaW5nbGV0b24gaW5zdGFuY2UKCSogIEBzdGF0aWMKCSogIEByZWFkT25seQoJKiAgQHB1YmxpYwoJKiAgQGF0dHJpYnV0ZSBpbnN0YW5jZQoJKiAgQHR5cGUgT1MKCSovCglPYmplY3QuZGVmaW5lUHJvcGVydHkoT1MsICJpbnN0YW5jZSIsIHsKCQlnZXQ6ZnVuY3Rpb24oKQoJCXsKCQkJaWYgKCFfaW5zdGFuY2UpCgkJCXsKCQkJCXRocm93ICdDYWxsIGNsb3Vka2lkLk9TLmluaXQoY2FudmFzSWQpJzsKCQkJfQoJCQlyZXR1cm4gX2luc3RhbmNlOwoJCX0KCX0pOwoJCgkvLyBBZGQgdG8gdGhlIG5hbWUgc3BhY2UKCW5hbWVzcGFjZSgnY2xvdWRraWQnKS5PUyA9IE9TOwp9KCkpOwovKioKKiAgQG1vZHVsZSBjbG91ZGtpZAoqLwooZnVuY3Rpb24od2luZG93KXsKCQoJInVzZSBzdHJpY3QiOwoKCS8qKgoJKiAgW0NyZWF0ZUpTIG9ubHldIERlc2lnbmVkIHRvIHByb3ZpZGUgdXRpbGl0eSByZWxhdGVkIHRvIGZ1bmN0aW9ucyBhbmQgcG9seWZpbGxzCgkqICBAY2xhc3MgRnVuY3Rpb25VdGlscyAoQ3JlYXRlSlMpCgkqLwoJdmFyIEZ1bmN0aW9uVXRpbHMgPSB7fTsKCQoJLy8gSWYgdGhlcmUncyBhbHJlYWR5IGEgYmluZCwgaWdub3JlCglpZiAoIUZ1bmN0aW9uLnByb3RvdHlwZS5iaW5kKQoJewoJCS8qKgoJCSogIEFkZCB0aGUgYmluZCBmdW5jdGlvbmFsaXR5IHRvIHRoZSBGdW5jdGlvbiBwcm90b3R5cGUKCQkqICB0aGlzIGFsbG93cyBwYXNzaW5nIGEgcmVmZXJlbmNlIGluIHRoZSBmdW5jdGlvbiBjYWxsYmFjayAKCQkqCgkJKgl2YXIgY2FsbGJhY2sgPSBmdW5jdGlvbigpe307CgkJKgljbG91ZGtpZC5NZWRpYUxvYWRlci5pbnN0YW5jZS5sb2FkKCdzb21ldGhpbmcuanNvbicsIGNhbGxiYWNrLmJpbmQodGhpcykpOwoJCSoKCQkqICBAbWV0aG9kIGJpbmQKCQkqICBAc3RhdGljCgkJKiAgQHBhcmFtIHtmdW5jdGlvbn0gdGhhdCBUaGUgcmVmZXJlbmNlIHRvIHRoZSBmdW5jdGlvbgoJCSogIEByZXR1cm4ge2Z1bmN0aW9ufSBUaGUgYm91bmQgZnVuY3Rpb24KCQkqLwoJCUZ1bmN0aW9uVXRpbHMuYmluZCA9IEZ1bmN0aW9uLnByb3RvdHlwZS5iaW5kID0gZnVuY3Rpb24gYmluZCh0aGF0KSAKCQl7CgkJCXZhciB0YXJnZXQgPSB0aGlzOwoKCQkJaWYgKHR5cGVvZiB0YXJnZXQgIT0gImZ1bmN0aW9uIikgCgkJCXsKCQkJCXRocm93IG5ldyBUeXBlRXJyb3IoKTsKCQkJfQoKCQkJdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpLAoJCQlib3VuZCA9IGZ1bmN0aW9uKCkKCQkJewoJCQkJaWYgKHRoaXMgaW5zdGFuY2VvZiBib3VuZCkgCgkJCQl7CgkJCQkJdmFyIEYgPSBmdW5jdGlvbigpe307CgkJCQkJRi5wcm90b3R5cGUgPSB0YXJnZXQucHJvdG90eXBlOwoJCQkJCXZhciBzZWxmID0gbmV3IEYoKTsKCgkJCQkJdmFyIHJlc3VsdCA9IHRhcmdldC5hcHBseShzZWxmLCBhcmdzLmNvbmNhdChBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMpKSk7CgkJCQkKCQkJCQlpZiAoT2JqZWN0KHJlc3VsdCkgPT09IHJlc3VsdCkKCQkJCQl7CgkJCQkJCXJldHVybiByZXN1bHQ7CgkJCQkJfQoJCQkJCXJldHVybiBzZWxmOwoJCQkJfQoJCQkJZWxzZSAKCQkJCXsKCQkJCQlyZXR1cm4gdGFyZ2V0LmFwcGx5KHRoYXQsIGFyZ3MuY29uY2F0KEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cykpKTsKCQkJCX0KCQkJfTsKCQkJcmV0dXJuIGJvdW5kOwoJCX07Cgl9CgkKCS8vIGh0dHA6Ly9wYXVsaXJpc2guY29tLzIwMTEvcmVxdWVzdGFuaW1hdGlvbmZyYW1lLWZvci1zbWFydC1hbmltYXRpbmcvCgkvLyBodHRwOi8vbXkub3BlcmEuY29tL2Vtb2xsZXIvYmxvZy8yMDExLzEyLzIwL3JlcXVlc3RhbmltYXRpb25mcmFtZS1mb3Itc21hcnQtZXItYW5pbWF0aW5nCgkvLyByZXF1ZXN0QW5pbWF0aW9uRnJhbWUgcG9seWZpbGwgYnkgRXJpayBNPz9sbGVyLiBmaXhlcyBmcm9tIFBhdWwgSXJpc2ggYW5kIFRpbm8gWmlqZGVsCgkvLyBNSVQgbGljZW5zZQoKCXZhciBsYXN0VGltZSA9IDA7Cgl2YXIgdmVuZG9ycyA9IFsnbXMnLCAnbW96JywgJ3dlYmtpdCcsICdvJ107Cglmb3IodmFyIHggPSAwOyB4IDwgdmVuZG9ycy5sZW5ndGggJiYgIXdpbmRvdy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWU7ICsreCkKCXsKCQl3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lID0gd2luZG93W3ZlbmRvcnNbeF0rJ1JlcXVlc3RBbmltYXRpb25GcmFtZSddOwoJCXdpbmRvdy5jYW5jZWxBbmltYXRpb25GcmFtZSA9IHdpbmRvd1t2ZW5kb3JzW3hdKydDYW5jZWxBbmltYXRpb25GcmFtZSddIHx8IHdpbmRvd1t2ZW5kb3JzW3hdKydDYW5jZWxSZXF1ZXN0QW5pbWF0aW9uRnJhbWUnXTsKCX0KCgkvLyBDaGVjayBmb3IgdGhlIGFuaW1hdGlvbiBmcmFtZQoJaWYgKCF3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lKQoJewoJCS8vIENyZWF0ZSB0aGUgcG9seWZpbGwKCQl3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lID0gZnVuY3Rpb24oY2FsbGJhY2spCgkJewoJCQl2YXIgY3VyclRpbWUgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTsKCQkJdmFyIHRpbWVUb0NhbGwgPSBNYXRoLm1heCgwLCAxNiAtIChjdXJyVGltZSAtIGxhc3RUaW1lKSk7CgkJCXZhciBpZCA9IHdpbmRvdy5zZXRUaW1lb3V0KGZ1bmN0aW9uKCkgeyBjYWxsYmFjayhjdXJyVGltZSArIHRpbWVUb0NhbGwpOyB9LCB0aW1lVG9DYWxsKTsKCQkJbGFzdFRpbWUgPSBjdXJyVGltZSArIHRpbWVUb0NhbGw7CgkJCXJldHVybiBpZDsKCQl9OwoKCQkvLyBPbmx5IHNldCB0aGlzIHVwIGlmIHRoZSBjb3JyZXNwb25kaW5nIHJlcXVlc3RBbmltYXRpb25GcmFtZSB3YXMgc2V0IHVwCgkJaWYgKCF3aW5kb3cuY2FuY2VsQW5pbWF0aW9uRnJhbWUpCgkJewoJCQl3aW5kb3cuY2FuY2VsQW5pbWF0aW9uRnJhbWUgPSBmdW5jdGlvbihpZCkgewoJCQkJY2xlYXJUaW1lb3V0KGlkKTsKCQkJfTsKCQl9Cgl9CgoJLyoqCgkqICBBIHBvbHlmaWxsIGZvciByZXF1ZXN0QW5pbWF0aW9uRnJhbWUsIHRoaXMgYWxzbyBnZXRzIGFzc2lnbmVkIHRvIHRoZSB3aW5kb3cgaWYgaXQgZG9lc24ndCBleGlzdAoJKiAgYWxzbyB3aW5kb3cucmVxdWVzdEFuaW1GcmFtZSBpcyBhIHJlZHVuZGFudCBhbmQgc2hvcnQgd2F5IHRvIGFjY2VzcyB0aGlzIHByb3BlcnR5CgkqICBAc3RhdGljCgkqICBAbWV0aG9kIHJlcXVlc3RBbmltYXRpb25GcmFtZQoJKi8KCUZ1bmN0aW9uVXRpbHMucmVxdWVzdEFuaW1hdGlvbkZyYW1lID0gd2luZG93LnJlcXVlc3RBbmltYXRpb25GcmFtZTsKCXdpbmRvdy5yZXF1ZXN0QW5pbUZyYW1lID0gd2luZG93LnJlcXVlc3RBbmltYXRpb25GcmFtZTsKCgkvKioKCSogIEEgcG9seWZpbGwgZm9yIGNhbmNlbEFuaW1hdGlvbkZyYW1lLCB0aGlzIGFsc28gZ2V0cyBhc3NpZ25lZCB0byB0aGUgd2luZG93IGlmIGl0IGRvZXNuJ3QgZXhpc3QKCSogIEBzdGF0aWMKCSogIEBtZXRob2QgY2FuY2VsQW5pbWF0aW9uRnJhbWUKCSovCglGdW5jdGlvblV0aWxzLmNhbmNlbEFuaW1hdGlvbkZyYW1lID0gd2luZG93LmNhbmNlbEFuaW1hdGlvbkZyYW1lOwkKCgkvLyBBc3NpZ24gdG8gbmFtZXNwYWNlCgluYW1lc3BhY2UoJ2Nsb3Vka2lkJykuRnVuY3Rpb25VdGlscyA9IEZ1bmN0aW9uVXRpbHM7CgkKfSh3aW5kb3cpKTsKLyoqCiogIEBtb2R1bGUgY2xvdWRraWQKKi8KKGZ1bmN0aW9uKCkgewoKCSJ1c2Ugc3RyaWN0IjsKCgkvKioKCSogIFtDcmVhdGVKUyBvbmx5XSBEZXNpZ25lZCB0byBwcm92aWRlIHV0aWxpdHkgcmVsYXRlZCB0byBCaXRtYXBzLgoJKiAgQGNsYXNzIEJpdG1hcFV0aWxzIChDcmVhdGVKUykKCSovCgl2YXIgQml0bWFwVXRpbHMgPSB7fTsKCgkvKioKCSoJUmVwbGFjZXMgQml0bWFwcyBpbiB0aGUgZ2xvYmFsIGxpYiBkaWN0aW9uYXJ5IHdpdGggYSB2ZXJzaW9uIHRoYXQgcHVsbHMgdGhlIGltYWdlIGZyb20gYSBzcHJpdGVzaGVldC4KCSoKCSoJQG1ldGhvZCBsb2FkU3ByaXRlU2hlZXQKCSoJQHN0YXRpYwoJKglAcGFyYW0ge09iamVjdH0gZnJhbWVEaWN0IEEgZGljdGlvbmFyeSBvZiBmcmFtZSBpbmZvcm1hdGlvbiwgd2l0aCBmcmFtZSwgdHJpbW1lZCwgCgkqCQlhbmQgc3ByaXRlU291cmNlU2l6ZSBwcm9wZXJ0aWVzIChsaWtlIHRoZSBKU09OIGhhc2ggb3V0cHV0IGZyb20gVGV4dHVyZVBhY2tlcikuCgkqCUBwYXJhbSB7SW1hZ2V8SFRNTENhbnZhc0VsZW1lbnR9IHNwcml0ZXNoZWV0SW1hZ2UgVGhlIHNwcml0ZXNoZWV0IGltYWdlIHRoYXQgY29udGFpbnMgYWxsIG9mIHRoZSBmcmFtZXMuCgkqCUBwYXJhbSB7TnVtYmVyfSBbc2NhbGU9MV0gVGhlIHNjYWxlIHRvIGFwcGx5IHRvIGFsbCBzcHJpdGVzIGZyb20gdGhlIHNwcml0ZXNoZWV0LiAKCSoJCUZvciBleGFtcGxlLCBhIGhhbGYgc2l6ZWQgc3ByaXRlc2hlZXQgc2hvdWxkIGhhdmUgYSBzY2FsZSBvZiAyLgoJKi8KCUJpdG1hcFV0aWxzLmxvYWRTcHJpdGVTaGVldCA9IGZ1bmN0aW9uKGZyYW1lRGljdCwgc3ByaXRlc2hlZXRJbWFnZSwgc2NhbGUpCgl7CgkJaWYoc2NhbGUgPiAwKSAKCQl7CgkJCS8vIERvIG5vdGhpbmcKCQl9CgkJZWxzZQoJCXsKCQkJc2NhbGUgPSAxOy8vc2NhbGUgc2hvdWxkIGRlZmF1bHQgdG8gMQoJCX0KCgkJZm9yKHZhciBrZXkgaW4gZnJhbWVEaWN0KQoJCXsKCQkJdmFyIGZyYW1lID0gZnJhbWVEaWN0W2tleV07CgkJCXZhciBpbmRleCA9IGtleS5pbmRleE9mKCIuIik7CgkJCWlmKGluZGV4ID4gMCkKCQkJCWtleSA9IGtleS5zdWJzdHJpbmcoMCwgaW5kZXgpOy8vcmVtb3ZlIGFueSBmaWxlIGV4dGVuc2lvbiBmcm9tIHRoZSBmcmFtZSBpZAoJCQl2YXIgYml0bWFwID0gbGliW2tleV07CgkJCS8qIGpzaGludCBpZ25vcmU6c3RhcnQgKi8KCQkJdmFyIG5ld0JpdG1hcCA9IGxpYltrZXldID0gZnVuY3Rpb24oKQoJCQl7CgkJCQljcmVhdGVqcy5Db250YWluZXIuY2FsbCh0aGlzKTsKCQkJCXZhciBjaGlsZCA9IG5ldyBjcmVhdGVqcy5CaXRtYXAodGhpcy5faW1hZ2UpOwoJCQkJdGhpcy5hZGRDaGlsZChjaGlsZCk7CgkJCQljaGlsZC5zb3VyY2VSZWN0ID0gdGhpcy5fZnJhbWVSZWN0OwoJCQkJdmFyIHMgPSB0aGlzLl9zY2FsZTsKCQkJCWNoaWxkLnNldFRyYW5zZm9ybSh0aGlzLl9mcmFtZU9mZnNldFggKiBzLCB0aGlzLl9mcmFtZU9mZnNldFkgKiBzLCBzLCBzKTsKCQkJfTsKCQkJLyoganNoaW50IGlnbm9yZTplbmQgKi8KCQkJdmFyIHAgPSBuZXdCaXRtYXAucHJvdG90eXBlID0gbmV3IGNyZWF0ZWpzLkNvbnRhaW5lcigpOwoJCQlwLl9pbWFnZSA9IHNwcml0ZXNoZWV0SW1hZ2U7Ly9naXZlIGl0IGEgcmVmZXJlbmNlIHRvIHRoZSBzcHJpdGVzaGVldAoJCQlwLl9zY2FsZSA9IHNjYWxlOy8vdGVsbCBpdCB3aGF0IHNjYWxlIHRvIHVzZSBvbiB0aGUgQml0bWFwIHRvIGJyaW5nIGl0IHRvIG5vcm1hbCBzaXplCgkJCXZhciBmcmFtZVJlY3QgPSBmcmFtZS5mcmFtZTsKCQkJLy9zYXZlIHRoZSBzb3VyY2UgcmVjdGFuZ2xlIG9mIHRoZSBzcHJpdGUKCQkJcC5fZnJhbWVSZWN0ID0gbmV3IGNyZWF0ZWpzLlJlY3RhbmdsZShmcmFtZVJlY3QueCwgZnJhbWVSZWN0LnksIGZyYW1lUmVjdC53LCBmcmFtZVJlY3QuaCk7CgkJCS8vaWYgdGhlIHNwcml0ZSBpcyB0cmltbWVkLCB0aGVuIHNhdmUgdGhlIGFtb3VudCB0aGF0IHdhcyB0cmltbWVkIG9mZiB0aGUgbGVmdCBhbmQgdG9wIHNpZGVzCgkJCWlmKGZyYW1lLnRyaW1tZWQpCgkJCXsKCQkJCXAuX2ZyYW1lT2Zmc2V0WCA9IGZyYW1lLnNwcml0ZVNvdXJjZVNpemUueDsKCQkJCXAuX2ZyYW1lT2Zmc2V0WSA9IGZyYW1lLnNwcml0ZVNvdXJjZVNpemUueTsKCQkJfQoJCQllbHNlCgkJCQlwLl9mcmFtZU9mZnNldFggPSBwLl9mcmFtZU9mZnNldFkgPSAwOwoJCQlpZihiaXRtYXAgJiYgYml0bWFwLnByb3RvdHlwZS5ub21pbmFsQm91bmRzKQoJCQkJcC5ub21pbmFsQm91bmRzID0gYml0bWFwLnByb3RvdHlwZS5ub21pbmFsQm91bmRzOy8va2VlcCB0aGUgbm9taW5hbCBib3VuZHMgZnJvbSB0aGUgb3JpZ2luYWwgYml0bWFwLCBpZiBpdCBleGlzdGVkCgkJCWVsc2UKCQkJCXAubm9taW5hbEJvdW5kcyA9IG5ldyBjcmVhdGVqcy5SZWN0YW5nbGUoMCwgMCwgZnJhbWUuc291cmNlU2l6ZS53LCBmcmFtZS5zb3VyY2VTaXplLmgpOwoJCX0KCX07CgoJLyoqCgkqCVJlcGxhY2VzIEJpdG1hcHMgaW4gdGhlIGdsb2JhbCBsaWIgZGljdGlvbmFyeSB3aXRoIGEgdmVyc2lvbiB0aGF0IHVzZXMgYSBzY2FsZWQgYml0bWFwLCBzbyB5b3UgY2FuIGxvYWQgdXAKCSoJc21hbGxlciBiaXRtYXBzIGJlaGluZCB0aGUgc2NlbmVzIHRoYXQgYXJlIHNjYWxlZCBiYWNrIHVwIHRvIG5vcm1hbCBzaXplLgoJKgoJKglAbWV0aG9kIHJlcGxhY2VXaXRoU2NhbGVkQml0bWFwCgkqCUBzdGF0aWMKCSoJQHBhcmFtIHtTdHJpbmd8T2JqZWN0fSBpZE9yRGljdCBBIGRpY3Rpb25hcnkgb2YgQml0bWFwIGlkcyB0byByZXBsYWNlLCBvciBhIHNpbmdsZSBpZC4KCSoJQHBhcmFtIHtOdW1iZXJ9IFtzY2FsZV0gVGhlIHNjYWxlIHRvIGFwcGx5IHRvIHRoZSBpbWFnZShzKS4KCSovCglCaXRtYXBVdGlscy5yZXBsYWNlV2l0aFNjYWxlZEJpdG1hcCA9IGZ1bmN0aW9uKGlkT3JEaWN0LCBzY2FsZSkKCXsKCQkvL3NjYWxlIGlzIHJlcXVpcmVkLCBidXQgaXQgZG9lc24ndCBodXJ0IHRvIGNoZWNrIC0gYWxzbywgZG9uJ3QgYm90aGVyIGZvciBhIHNjYWxlIG9mIDEKCQlpZihzY2FsZSAhPSAxICYmIHNjYWxlID4gMCkgCgkJewoJCQkvLyBEbyBub3RoaW5nCgkJfQoJCWVsc2UKCQl7CgkJCXJldHVybjsKCQl9CgoJCXZhciBrZXksIGJpdG1hcCwgbmV3Qml0bWFwLCBwOwoJCWlmKHR5cGVvZiBpZE9yRGljdCA9PSAic3RyaW5nIikKCQl7CgkJCWtleSA9IGlkT3JEaWN0OwoJCQliaXRtYXAgPSBsaWJba2V5XTsKCQkJaWYoYml0bWFwKQoJCQl7CgkJCQkvKiBqc2hpbnQgaWdub3JlOnN0YXJ0ICovCgkJCQluZXdCaXRtYXAgPSBsaWJba2V5XSA9IGZ1bmN0aW9uKCkKCQkJCXsKCQkJCQljcmVhdGVqcy5Db250YWluZXIuY2FsbCh0aGlzKTsKCQkJCQl2YXIgY2hpbGQgPSBuZXcgdGhpcy5fb2xkQk0oKTsKCQkJCQl0aGlzLmFkZENoaWxkKGNoaWxkKTsKCQkJCQljaGlsZC5zZXRUcmFuc2Zvcm0oMCwgMCwgdGhpcy5fc2NhbGUsIHRoaXMuX3NjYWxlKTsKCQkJCX07CgkJCQkvKiBqc2hpbnQgaWdub3JlOmVuZCAqLwoJCQkJcCA9IG5ld0JpdG1hcC5wcm90b3R5cGUgPSBuZXcgY3JlYXRlanMuQ29udGFpbmVyKCk7CgkJCQlwLl9vbGRCTSA9IGJpdG1hcDsvL2dpdmUgaXQgYSByZWZlcmVuY2UgdG8gdGhlIEJpdG1hcAoJCQkJcC5fc2NhbGUgPSBzY2FsZTsvL3RlbGwgaXQgd2hhdCBzY2FsZSB0byB1c2Ugb24gdGhlIEJpdG1hcCB0byBicmluZyBpdCB0byBub3JtYWwgc2l6ZQoJCQkJcC5ub21pbmFsQm91bmRzID0gYml0bWFwLnByb3RvdHlwZS5ub21pbmFsQm91bmRzOy8va2VlcCB0aGUgbm9taW5hbCBib3VuZHMKCQkJfQoJCX0KCQllbHNlCgkJewoJCQlmb3Ioa2V5IGluIGlkT3JEaWN0KQoJCQl7CgkJCQliaXRtYXAgPSBsaWJba2V5XTsKCQkJCWlmKGJpdG1hcCkKCQkJCXsKCQkJCQkvKiBqc2hpbnQgaWdub3JlOnN0YXJ0ICovCgkJCQkJbmV3Qml0bWFwID0gbGliW2tleV0gPSBmdW5jdGlvbigpCgkJCQkJewoJCQkJCQljcmVhdGVqcy5Db250YWluZXIuY2FsbCh0aGlzKTsKCQkJCQkJdmFyIGNoaWxkID0gbmV3IHRoaXMuX29sZEJNKCk7CgkJCQkJCXRoaXMuYWRkQ2hpbGQoY2hpbGQpOwoJCQkJCQljaGlsZC5zZXRUcmFuc2Zvcm0oMCwgMCwgdGhpcy5fc2NhbGUsIHRoaXMuX3NjYWxlKTsKCQkJCQl9OwoJCQkJCS8qIGpzaGludCBpZ25vcmU6ZW5kICovCgkJCQkJcCA9IG5ld0JpdG1hcC5wcm90b3R5cGUgPSBuZXcgY3JlYXRlanMuQ29udGFpbmVyKCk7CgkJCQkJcC5fb2xkQk0gPSBiaXRtYXA7Ly9naXZlIGl0IGEgcmVmZXJlbmNlIHRvIHRoZSBCaXRtYXAKCQkJCQlwLl9zY2FsZSA9IHNjYWxlOy8vdGVsbCBpdCB3aGF0IHNjYWxlIHRvIHVzZSBvbiB0aGUgQml0bWFwIHRvIGJyaW5nIGl0IHRvIG5vcm1hbCBzaXplCgkJCQkJcC5ub21pbmFsQm91bmRzID0gYml0bWFwLnByb3RvdHlwZS5ub21pbmFsQm91bmRzOy8va2VlcCB0aGUgbm9taW5hbCBib3VuZHMKCQkJCX0KCQkJfQoJCX0KCX07CgoJbmFtZXNwYWNlKCdjbG91ZGtpZCcpLkJpdG1hcFV0aWxzID0gQml0bWFwVXRpbHM7Cn0oKSk7Ci8qKgoqICBAbW9kdWxlIGNsb3Vka2lkCiovCihmdW5jdGlvbigpewoJCgkidXNlIHN0cmljdCI7CgkKCS8qKiAKCSogIFRoZSBTYXZlZERhdGEgZnVuY3Rpb25zIHVzZSBsb2NhbFN0b3JhZ2UgYW5kIHNlc3Npb25TdG9yYWdlLCB3aXRoIGEgY29va2llIGZhbGxiYWNrLiAKCSoKCSogIEBjbGFzcyBTYXZlZERhdGEKCSovCgl2YXIgU2F2ZWREYXRhID0ge30sCgkKCS8qKiBBIGNvbnN0YW50IHRvIGRldGVybWluZSBpZiB3ZSBjYW4gdXNlIGxvY2FsU3RvcmFnZSBhbmQgc2Vzc2lvblN0b3JhZ2UgKi8KCVdFQl9TVE9SQUdFX1NVUFBPUlQgPSB0eXBlb2Yod2luZG93LlN0b3JhZ2UpICE9PSAidW5kZWZpbmVkIiwKCQoJLyoqIEEgY29uc3RhbnQgZm9yIGNvb2tpZSBmYWxsYmFjayBmb3IgU2F2ZWREYXRhLmNsZWFyKCkgKi8KCUVSQVNFX0NPT0tJRSA9IC0xOwoKCS8vaW4gaU9TLCBpZiB0aGUgdXNlciBpcyBpbiBQcml2YXRlIEJyb3dzaW5nLCB3cml0aW5nIHRvIGxvY2FsU3RvcmFnZSB0aHJvd3MgYW4gZXJyb3IuCglpZihXRUJfU1RPUkFHRV9TVVBQT1JUKQoJewoJCXRyeQoJCXsKCQkJbG9jYWxTdG9yYWdlLnNldEl0ZW0oIkxTX1RFU1QiLCAidGVzdCIpOwoJCQlsb2NhbFN0b3JhZ2UucmVtb3ZlSXRlbSgiTFNfVEVTVCIpOwoJCX0KCQljYXRjaChlKQoJCXsKCQkJV0VCX1NUT1JBR0VfU1VQUE9SVCA9IGZhbHNlOwoJCX0KCX0KCgkvKioKCSAqIElmIFNhdmVkRGF0YSB3aWxsIGJlIHVzaW5nIGxvY2FsU3RvcmFnZSBhbmQgc2Vzc2lvblN0b3JhZ2UuCgkgKiBAcHJvcGVydHkge0Jvb2xlYW59IHVzZVdlYlN0b3JhZ2UKCSAqIEBkZWZhdWx0ICB0cnVlCgkgKi8KCU9iamVjdC5kZWZpbmVQcm9wZXJ0eShTYXZlZERhdGEsICJ1c2VXZWJTdG9yYWdlIiwgewoJCWdldDogZnVuY3Rpb24oKSB7IHJldHVybiBXRUJfU1RPUkFHRV9TVVBQT1JUOyB9LAoJCXNldDogZnVuY3Rpb24odmFsdWUpCgkJewoJCQlpZih2YWx1ZSAmJiB0eXBlb2Yod2luZG93LlN0b3JhZ2UpICE9PSAidW5kZWZpbmVkIikKCQkJewoJCQkJdHJ5CgkJCQl7CgkJCQkJbG9jYWxTdG9yYWdlLnNldEl0ZW0oIkxTX1RFU1QiLCAidGVzdCIpOwoJCQkJCWxvY2FsU3RvcmFnZS5yZW1vdmVJdGVtKCJMU19URVNUIik7CgkJCQkJV0VCX1NUT1JBR0VfU1VQUE9SVCA9IHRydWU7CgkJCQl9CgkJCQljYXRjaChlKQoJCQkJewoJCQkJCVdFQl9TVE9SQUdFX1NVUFBPUlQgPSBmYWxzZTsKCQkJCX0KCQkJfQoJCQllbHNlCgkJCQlXRUJfU1RPUkFHRV9TVVBQT1JUID0gZmFsc2U7CgkJfQoJfSk7IAoJCgkvKiogCgkqICBSZW1vdmUgYSBzYXZlZCB2YXJpYWJsZSBieSBuYW1lLgoJKiAgQG1ldGhvZCByZW1vdmUKCSogIEBzdGF0aWMKCSogIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSBuYW1lIG9mIHRoZSB2YWx1ZSB0byByZW1vdmUKCSovCglTYXZlZERhdGEucmVtb3ZlID0gZnVuY3Rpb24obmFtZSkKCXsKCQlpZihXRUJfU1RPUkFHRV9TVVBQT1JUKQoJCXsKCQkJbG9jYWxTdG9yYWdlLnJlbW92ZUl0ZW0obmFtZSk7CgkJCXNlc3Npb25TdG9yYWdlLnJlbW92ZUl0ZW0obmFtZSk7CgkJfQoJCWVsc2UKCQkJU2F2ZWREYXRhLndyaXRlKG5hbWUsIiIsRVJBU0VfQ09PS0lFKTsKCX07CgkKCS8qKgoJKiAgU2F2ZSBhIHZhcmlhYmxlLgoJKiAgQG1ldGhvZCB3cml0ZQoJKiAgQHN0YXRpYwoJKiAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIG5hbWUgb2YgdGhlIHZhbHVlIHRvIHNhdmUKCSogIEBwYXJhbSB7bWl4ZWR9IHZhbHVlIFRoZSB2YWx1ZSB0byBzYXZlLiBUaGlzIHdpbGwgYmUgcnVuIHRocm91Z2ggSlNPTi5zdHJpbmdpZnkoKS4KCSogIEBwYXJhbSB7Qm9vbGVhbn0gW3RlbXBPbmx5PWZhbHNlXSBJZiB0aGUgdmFsdWUgc2hvdWxkIGJlIHNhdmVkIG9ubHkgaW4gdGhlIGN1cnJlbnQgYnJvd3NlciBzZXNzaW9uLgoJKi8KCVNhdmVkRGF0YS53cml0ZSA9IGZ1bmN0aW9uKG5hbWUsIHZhbHVlLCB0ZW1wT25seSkKCXsKCQlpZihXRUJfU1RPUkFHRV9TVVBQT1JUKQoJCXsKCQkJaWYodGVtcE9ubHkpCgkJCQlzZXNzaW9uU3RvcmFnZS5zZXRJdGVtKG5hbWUsIEpTT04uc3RyaW5naWZ5KHZhbHVlKSk7CgkJCWVsc2UKCQkJCWxvY2FsU3RvcmFnZS5zZXRJdGVtKG5hbWUsIEpTT04uc3RyaW5naWZ5KHZhbHVlKSk7CgkJfQoJCWVsc2UKCQl7CgkJCXZhciBleHBpcmVzOwoJCQlpZiAodGVtcE9ubHkpCgkJCXsKCQkJCWlmKHRlbXBPbmx5ICE9PSBFUkFTRV9DT09LSUUpCgkJCQkJZXhwaXJlcyA9ICIiOy8vcmVtb3ZlIHdoZW4gYnJvd3NlciBpcyBjbG9zZWQKCQkJCWVsc2UKCQkJCQlleHBpcmVzID0gIjsgZXhwaXJlcz1UaHUsIDAxIEphbiAxOTcwIDAwOjAwOjAwIEdNVCI7Ly9zYXZlIGNvb2tpZSBpbiB0aGUgcGFzdCBmb3IgaW1tZWRpYXRlIHJlbW92YWwKCQkJfQoJCQllbHNlCgkJCQlleHBpcmVzID0gIjsgZXhwaXJlcz0iK25ldyBEYXRlKDIxNDc0ODM2NDYwMDApLnRvR01UU3RyaW5nKCk7Ly9USEUgRU5EIE9GICgzMmJpdCBVTklYKSBUSU1FIQoJCQkJCgkJCWRvY3VtZW50LmNvb2tpZSA9IG5hbWUrIj0iK2VzY2FwZShKU09OLnN0cmluZ2lmeSh2YWx1ZSkpK2V4cGlyZXMrIjsgcGF0aD0vIjsKCQl9Cgl9OwoJCgkvKioKCSogIFJlYWQgdGhlIHZhbHVlIG9mIGEgc2F2ZWQgdmFyaWFibGUKCSogIEBtZXRob2QgcmVhZAoJKiAgQHN0YXRpYwoJKiAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIG5hbWUgb2YgdGhlIHZhcmlhYmxlCgkqICBAcmV0dXJuIHttaXhlZH0gVGhlIHZhbHVlIChydW4gdGhyb3VnaCBgSlNPTi5wYXJzZSgpYCkgb3IgbnVsbCBpZiBpdCBkb2Vzbid0IGV4aXN0CgkqLwoJU2F2ZWREYXRhLnJlYWQgPSBmdW5jdGlvbihuYW1lKQoJewoJCWlmKFdFQl9TVE9SQUdFX1NVUFBPUlQpCgkJewoJCQl2YXIgdmFsdWUgPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbShuYW1lKSB8fCBzZXNzaW9uU3RvcmFnZS5nZXRJdGVtKG5hbWUpOwoJCQlpZih2YWx1ZSkKCQkJCXJldHVybiBKU09OLnBhcnNlKHZhbHVlKTsKCQkJZWxzZQoJCQkJcmV0dXJuIG51bGw7CgkJfQoJCWVsc2UKCQl7CgkJCXZhciBuYW1lRVEgPSBuYW1lICsgIj0iLAoJCQkJY2EgPSBkb2N1bWVudC5jb29raWUuc3BsaXQoJzsnKSwKCQkJCWkgPSAwLCBjOwoJCQkJCgkJCWZvcihpPTA7aSA8IGNhLmxlbmd0aDtpKyspCgkJCXsKCQkJCWMgPSBjYVtpXTsKCQkJCXdoaWxlIChjLmNoYXJBdCgwKSA9PSAnICcpIGMgPSBjLnN1YnN0cmluZygxLGMubGVuZ3RoKTsKCQkJCWlmIChjLmluZGV4T2YobmFtZUVRKSA9PT0gMCkgcmV0dXJuIEpTT04ucGFyc2UodW5lc2NhcGUoYy5zdWJzdHJpbmcobmFtZUVRLmxlbmd0aCxjLmxlbmd0aCkpKTsKCQkJfQoJCQlyZXR1cm4gbnVsbDsKCQl9Cgl9OwoJCgkvLyBBc3NpZ24gdG8gdGhlIGdsb2JhbCBzcGFjZQoJbmFtZXNwYWNlKCdjbG91ZGtpZCcpLlNhdmVkRGF0YSA9IFNhdmVkRGF0YTsKCQp9KCkpOwovKioKKiAgQG1vZHVsZSBjbG91ZGtpZAoqLwooZnVuY3Rpb24oKXsKCQoJInVzZSBzdHJpY3QiOwoJCgkvLyBDb21iaW5lIHByZWZpeGVkIFVSTCBmb3IgY3JlYXRlT2JqZWN0VVJMIGZyb20gYmxvYnMuCgl3aW5kb3cuVVJMID0gd2luZG93LlVSTCB8fCB3aW5kb3cud2Via2l0VVJMOwoKCS8vIENvbWJpbmUgcHJlZml4ZWQgYmxvYiBidWlsZGVyCgl3aW5kb3cuQmxvYkJ1aWxkZXIgPSB3aW5kb3cuQmxvYkJ1aWxkZXIgfHwgd2luZG93LldlYktpdEJsb2JCdWlsZGVyIHx8IHdpbmRvdy5Nb3pCbG9iQnVpbGRlcjsKCgkvKioKCSogIFRoZSBXZWIgV29ya2VycyBzcGVjaWZpY2F0aW9uIGRlZmluZXMgYW4gQVBJIGZvciBzcGF3bmluZyBiYWNrZ3JvdW5kIHNjcmlwdHMgaW4geW91ciB3ZWIgCgkqICBhcHBsaWNhdGlvbi4gV2ViIFdvcmtlcnMgYWxsb3cgeW91IHRvIGRvIHRoaW5ncyBsaWtlIGZpcmUgdXAgbG9uZy1ydW5uaW5nIHNjcmlwdHMgdG8gCgkqICBoYW5kbGUgY29tcHV0YXRpb25hbGx5IGludGVuc2l2ZSB0YXNrcywgYnV0IHdpdGhvdXQgYmxvY2tpbmcgdGhlIFVJIG9yIG90aGVyIHNjcmlwdHMgCgkqICB0byBoYW5kbGUgdXNlciBpbnRlcmFjdGlvbnMuIEJlY2F1c2UgV29ya2VycyBhcmVuJ3QgYXZhaWxhYmxlIG9uIGFsbCBicm93c2Vycywgd2UgcHJvdmlkZQoJKiAgYSBoZWxwZnVsIHBvbHlmaWxsIGZvciBiYWNrd2FyZCBjb21wYXRpYmlsaXR5LgoJKgoJKgl2YXIgd29ya2VyQ29kZSA9ICJ0aGlzLmluaXRpYWxWYXJpYWJsZSA9IDEwOyIgKwoJKgkidGhpcy5vbm1lc3NhZ2UgPSBmdW5jdGlvbihldmVudCkiICsKCSoJInsiICsKCSoJCSJ2YXIgZGF0YSA9IGV2ZW50LmRhdGE7IiArCgkqCQkidmFyIHJldHVyblZhbCA9IHRoaXMuaW5pdGlhbFZhcmlhYmxlICsgZGF0YS5hZGRWYWx1ZTsiICsKCSoJCSJ0aGlzLnBvc3RNZXNzYWdlKHJldHVyblZhbCk7IiArCgkqCSJ9OyI7CgkqCgkqCS8vIENyZWF0ZSB0aGUgd29ya2VyCgkqCXZhciB3b3JrZXIgPSBjbG91ZGtpZC5Xb3JrZXIuaW5pdCh3b3JrZXJDb2RlKTsKCSoJd29ya2VyLm9ubWVzc2FnZSA9IGZ1bmN0aW9uKGUpIHsKCSoJCS8vIGUuZGF0YSBpcyB0aGUgcmV0dXJuVmFsCgkqCX07CgkqCQoJKgkvLyBTdGFydCB0aGUgd29ya2VyLgoJKgl3b3JrZXIucG9zdE1lc3NhZ2UoKTsgCgkqCgkqICBAY2xhc3MgV29ya2VyCgkqLwoJdmFyIFdvcmtlciA9IHt9OwoKCS8qKgoJKiAgSW5pdGlhbGl6ZSB0aGUgd29ya2VyLCB0aGlzIGlzIGhvdyB5b3UgY3JlYXRlIGEgV29ya2VyIG9yIEZhbGxiYWNrV29ya2VyIG9iamVjdC4KCSogIEBtZXRob2QgaW5pdAoJKiAgQHN0YXRpYwoJKiAgQHBhcmFtIHtTdHJpbmd9IGNvZGVTdHJpbmcgVGhlIGNvZGUgaW4gc3RyaW5nIGZvcm0gdG8gbWFrZSB0aGUgd29ya2VyIGZyb20uIEFzIGEgc3RyaW5nLCBmYWxsYmFjayBzdXBwb3J0IGlzIGVhc2llci4KCSogIEByZXR1cm4ge0ZhbGxiYWNrV29ya2VyfHdpbmRvdy5Xb3JrZXJ9IEVpdGhlciBhIFdlYiBXb3JrZXIgb3IgYSBmYWxsYmFjayB3aXRoIHRoZSBzYW1lIEFQSSB0byB1c2UuCgkqLwoJV29ya2VyLmluaXQgPSBmdW5jdGlvbihjb2RlU3RyaW5nKQoJewoJCWlmKCF3aW5kb3cuVVJMIHx8ICF3aW5kb3cuV29ya2VyKSByZXR1cm4gbmV3IEZhbGxiYWNrV29ya2VyKGNvZGVTdHJpbmcpOwoKCQl2YXIgYmxvYjsKCQl0cnkKCQl7CgkJCWJsb2IgPSBuZXcgQmxvYihbY29kZVN0cmluZ10sIHt0eXBlOiAnYXBwbGljYXRpb24vamF2YXNjcmlwdCd9KTsKCQl9CgkJY2F0Y2ggKGUpCgkJewoJCQkvLyB0cnkgQmFja3dhcmRzLWNvbXBhdGliaWxpdHkgd2l0aCBibG9iIGJ1aWxkZXJzCgkJCWlmKCF3aW5kb3cuQmxvYkJ1aWxkZXIpIHJldHVybiBuZXcgRmFsbGJhY2tXb3JrZXIoY29kZVN0cmluZyk7CgkJCXRyeQoJCQl7CgkJCQlibG9iID0gbmV3IEJsb2JCdWlsZGVyKCk7CgkJCQlibG9iLmFwcGVuZChjb2RlU3RyaW5nKTsKCQkJCWJsb2IgPSBibG9iLmdldEJsb2IoKTsKCQkJfQoJCQljYXRjaChlcnJvcikKCQkJewoJCQkJLy9ubyB3YXkgb2YgZ2VuZXJhdGluZyBhIGJsb2IgdG8gY3JlYXRlIHRoZSB3b3JrZXIgZnJvbQoJCQkJcmV0dXJuIG5ldyBGYWxsYmFja1dvcmtlcihjb2RlU3RyaW5nKTsKCQkJfQoJCX0KCQlpZighYmxvYikgcmV0dXJuIG5ldyBGYWxsYmFja1dvcmtlcihjb2RlU3RyaW5nKTsvL2lmIHNvbWVob3cgbm8gYmxvYiB3YXMgY3JlYXRlZCwgcmV0dXJuIGEgZmFsbGJhY2sgd29ya2VyCgkJdHJ5CgkJewoJCQkvL0lFIDEwIGFuZCAxMSwgd2hpbGUgc3VwcG9ydGluZyBCbG9iIGFuZCBXb3JrZXJzLCBzaG91bGQgdGhyb3cgYW4gZXJyb3IgaGVyZSwgc28gd2Ugc2hvdWxkIGNhdGNoIGl0IGFuZCBmYWxsIGJhY2sKCQkJdmFyIHdvcmtlciA9IG5ldyBXb3JrZXIoVVJMLmNyZWF0ZU9iamVjdFVSTChibG9iKSk7CgkJCXJldHVybiB3b3JrZXI7CgkJfQoJCWNhdGNoKGUpCgkJewoJCQkvL2Nhbid0IGNyZWF0ZSBhIHdvcmtlcgoJCQlyZXR1cm4gbmV3IEZhbGxiYWNrV29ya2VyKGNvZGVTdHJpbmcpOwoJCX0KCX07CgoJLy8gRGVwcmVjYXRlZCBpbXBsZW1lbnRhdGlvbgoJbmFtZXNwYWNlKCJjbG91ZGtpZCIpLmNyZWF0ZVdvcmtlciA9IFdvcmtlci5pbml0OwoKCS8vIEFzc2lnbiB0byBuYW1lc3BhY2UKCW5hbWVzcGFjZSgiY2xvdWRraWQiKS5Xb3JrZXIgPSBXb3JrZXI7CgkKCS8qKgoJKglJbnRlcm5hbCBjbGFzcyB0aGF0IHByZXRlbmRzIHRvIGJlIGEgV2ViIFdvcmtlcidzIGNvbnRleHQuCgkqCUBjbGFzcyBTdWJXb3JrZXIKCSoJQGNvbnN0cnVjdG9yCgkqCUBwYXJhbSB7U3RyaW5nfSBjb2RlU3RyaW5nIEEgc3RyaW5nIHRvIGV2YWx1YXRlIGludG8gd29ya2VyIGNvZGUuCgkqCUBwYXJhbSB7RmFsbGJhY2tXb3JrZXJ9IHBhcmVudCBUaGUgRmFsbGJhY2tXb3JrZXIgdGhhdCBvd25zIHRoaXMgU3ViV29ya2VyLgoJKi8KCXZhciBTdWJXb3JrZXIgPSBmdW5jdGlvbihjb2RlU3RyaW5nLCBwYXJlbnQpCgl7CgkJdGhpcy5fd1BhcmVudCA9IHBhcmVudDsKCQlldmFsKGNvZGVTdHJpbmcpOyAvLyBqc2hpbnQgaWdub3JlOmxpbmUKCX07CgoJdmFyIHAgPSBTdWJXb3JrZXIucHJvdG90eXBlOwoKCS8qKgoJKglzZWUgaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9XZWIvQVBJL1dvcmtlci5vbm1lc3NhZ2UKCSoJQHByb3BlcnR5IHtGdW5jdGlvbn0gb25tZXNzYWdlCgkqLwoJcC5vbm1lc3NhZ2UgPSBudWxsOwoKCS8qKgoJKglUaGUgRmFsbGJhY2tXb3JrZXIgdGhhdCBpcyBjb250cm9sbHMgYnkgdGhpcyBTdWJXb3JrZXIuCgkqCUBwcm9wZXJ0eSB7RmFsbGJhY2tXb3JrZXJ9IF93UGFyZW50CgkqCUBwcml2YXRlCgkqLwoJcC5fd1BhcmVudCA9IG51bGw7CgoJLyoqCgkqCVNlZSBodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL1dlYi9BUEkvV29ya2VyLnBvc3RNZXNzYWdlCgkqCUBtZXRob2QgcG9zdE1lc3NhZ2UKCSoJQHBhcmFtIHsqfSBkYXRhIFRoZSBkYXRhIHRvIHNlbmQuCgkqLwoJcC5wb3N0TWVzc2FnZSA9IGZ1bmN0aW9uKGRhdGEpCgl7CgkJdmFyIHBhcmVudCA9IHRoaXMuX3dQYXJlbnQ7CgkJc2V0VGltZW91dChwYXJlbnQub25tZXNzYWdlLmJpbmQocGFyZW50LCB7ZGF0YTpkYXRhfSksIDEpOwoJfTsKCQoJLyoqCgkqCUFuIGludGVybmFsIGNsYXNzIHRoYXQgZHVwbGljYXRlcyB0aGUgV29ya2VyIEFQSSBhcyBhIGZhbGxiYWNrIHdoZW4gV2ViV29ya2VycyBhcmUgbm90IHN1cHBvcnRlZC4KCSoJQGNsYXNzIEZhbGxiYWNrV29ya2VyCgkqCUBjb25zdHJ1Y3RvcgoJKglAcGFyYW0ge1N0cmluZ30gY29kZVN0cmluZyBBIHN0cmluZyB0byBldmFsdWF0ZSBpbnRvIHdvcmtlciBjb2RlLgoJKi8KCXZhciBGYWxsYmFja1dvcmtlciA9IGZ1bmN0aW9uKGNvZGVTdHJpbmcpCgl7CgkJdGhpcy5fd0NoaWxkID0gbmV3IFN1Yldvcmtlcihjb2RlU3RyaW5nLCB0aGlzKTsKCX07CgoJcCA9IEZhbGxiYWNrV29ya2VyLnByb3RvdHlwZTsKCgkvKioKCSoJU2VlIGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvV2ViL0FQSS9Xb3JrZXIucG9zdE1lc3NhZ2UKCSoJQG1ldGhvZCBwb3N0TWVzc2FnZQoJKglAcGFyYW0geyp9IGRhdGEgVGhlIGRhdGEgdG8gc2VuZC4KCSovCglwLnBvc3RNZXNzYWdlID0gZnVuY3Rpb24oZGF0YSkKCXsKCQl2YXIgY2hpbGQgPSB0aGlzLl93Q2hpbGQ7CgkJc2V0VGltZW91dChjaGlsZC5vbm1lc3NhZ2UuYmluZChjaGlsZCwge2RhdGE6ZGF0YX0pLCAxKTsKCX07CgoJLyoqCgkqCVNlZSBodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL1dlYi9BUEkvV29ya2VyLnRlcm1pbmF0ZQoJKglAbWV0aG9kIHRlcm1pbmF0ZQoJKi8KCXAudGVybWluYXRlID0gZnVuY3Rpb24oKQoJewoJCXRoaXMub25tZXNzYWdlID0gbnVsbDsKCQl2YXIgY2hpbGQgPSB0aGlzLl93Q2hpbGQ7CgkJY2hpbGQuX3dQYXJlbnQgPSBudWxsOwoJCWNoaWxkLm9ubWVzc2FnZSA9IG51bGw7CgkJdGhpcy5fd0NoaWxkID0gbnVsbDsKCX07CgoJLyoqCgkqCVNlZSBodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL1dlYi9BUEkvV29ya2VyLm9ubWVzc2FnZQoJKglAcHJvcGVydHkge0Z1bmN0aW9ufSBvbm1lc3NhZ2UKCSovCglwLm9ubWVzc2FnZSA9IG51bGw7CgkKCS8qKgoJKglUaGUgU3ViV29ya2VyIHRoYXQgaXMgY29udHJvbGxlZCBieSB0aGlzIEZhbGxiYWNrV29ya2VyLgoJKglAcHJvcGVydHkge1N1Yldvcmtlcn0gX3dDaGlsZAoJKglAcHJpdmF0ZQoJKi8KCXAuX3dDaGlsZCA9IG51bGw7CgkKfSgpKTsKLyoqCiogIEBtb2R1bGUgY2xvdWRraWQKKi8KKGZ1bmN0aW9uKCkgewoJCgkidXNlIHN0cmljdCI7CgoJLyoqCgkqICBBIGZ1bmN0aW9uIHRoYXQgaXMgdXNlZCBhcyBhIG5vcm1hbCBjYWxsYmFjaywgYnV0IGNoZWNrcyBhbiBvYmplY3QgZm9yIGEgcHJvcGVydHkgaW4gb3JkZXIgdG8gY29tYmluZSB0d28KCSogIGNhbGxiYWNrcyBpbnRvIG9uZS4gRm9yIGV4YW1wbGUgdXNhZ2U6CgkqCgkqICB2YXIgdm9QbGF5ZXIgPSBuZXcgY2xvdWRraWQuVk9QbGF5ZXIoKTsKCSogIHZhciBjYWxsYmFjayA9IGNsb3Vka2lkLkNvbWJpbmVkQ2FsbGJhY2suY3JlYXRlKG15RnVuYy5iaW5kKHRoaXMpLCB2b1BsYXllciwgInBsYXlpbmciLCAiX2NhbGxiYWNrIik7CgkqICBBbmltYXRvci5wbGF5KG15Q2xpcCwgIm15QW5pbSIsIGNhbGxiYWNrKTsKCSogIAoJKiAgSW4gdGhpcyBleGFtcGxlLCB3aGVuIEFuaW1hdG9yIGNhbGxzICdjYWxsYmFjaycsIGlmIHZvUGxheWVyWyJwbGF5aW5nIl0gaXMgZmFsc2UsICdteUZ1bmMnIGlzIGNhbGxlZCBpbW1lZGlhdGVseS4KCSogIElmIHZvUGxheWVyWyJwbGF5aW5nIl0gaXMgdHJ1ZSwgdGhlbiB2b1BsYXllclsiX2NhbGxiYWNrIl0gaXMgc2V0IHRvICdteUZ1bmMnIHNvIHRoYXQgaXQgd2lsbCBiZSBjYWxsZWQgd2hlbiB2b1BsYXllciBjb21wbGV0ZXMuCgkqICAKCSogIEBjbGFzcyBDb21iaW5lZENhbGxiYWNrCgkqICBAY29uc3RydWN0b3IKCSogIEBwYXJhbSB7ZnVuY3Rpb259IGNhbGwgVGhlIGNhbGxiYWNrIHRvIGNhbGwgd2hlbiBldmVyeXRoaW5nIGlzIGNvbXBsZXRlLgoJKiAgQHBhcmFtIHsqfSBvYmogVGhlIG9iamVjdCB0byBjaGVjayBhcyBhbiBhZGRpdGlvbmFsIGNvbXBsZXRpb24gZGVwZW5kZW5jeS4KCSogIEBwYXJhbSB7U3RyaW5nfSBwcm9wIFRoZSBwcm9wZXJ0eSB0byBjaGVjayBvbiBvYmouIElmIG9ialtwcm9wXSBpcyBmYWxzZSwgdGhlbiBpdCBpcyBjb25zaWRlcmVkIGNvbXBsZXRlLgoJKiAgQHBhcmFtIHtTdHJpbmd9IGNhbGxQcm9wIFRoZSBwcm9wZXJ0eSB0byBzZXQgb24gb2JqIGlmIG9ialtwcm9wXSBpcyB0cnVlIHdoZW4gdGhlIENvbWJpbmVkQ2FsbGJhY2sgaXMgY2FsbGVkLgoJKi8KCXZhciBDb21iaW5lZENhbGxiYWNrID0gZnVuY3Rpb24oY2FsbCwgb2JqLCBwcm9wLCBjYWxsUHJvcCkKCXsKCQlpZighb2JqW3Byb3BdKS8vYWNjZXB0IGFueXRoaW5nIHRoYXQgcmVzb2x2ZXMgdG8gZmFsc2U6IGVnIHZvUGxheWVyLnBsYXlpbmcgPT0gZmFsc2UKCQkJY2FsbCgpOwoJCWVsc2UKCQkJb2JqW2NhbGxQcm9wXSA9IGNhbGw7Cgl9OwoKCS8qKgoJKiAgQ3JlYXRlcyBhIENvbWJpbmVkQ2FsbGJhY2sgZm9yIHVzZS4KCSogIAoJKiAgQG1ldGhvZCBjcmVhdGUKCSogIEBzdGF0aWMKCSogIEBwYXJhbSB7ZnVuY3Rpb259IGNhbGwgVGhlIGNhbGxiYWNrIHRvIGNhbGwgd2hlbiBldmVyeXRoaW5nIGlzIGNvbXBsZXRlLgoJKiAgQHBhcmFtIHsqfSBvYmogVGhlIG9iamVjdCB0byBjaGVjayBhcyBhbiBhZGRpdGlvbmFsIGNvbXBsZXRpb24gZGVwZW5kZW5jeS4KCSogIEBwYXJhbSB7U3RyaW5nfSBwcm9wIFRoZSBwcm9wZXJ0eSB0byBjaGVjayBvbiBvYmouIElmIG9ialtwcm9wXSBpcyBmYWxzZSwgdGhlbiBpdCBpcyBjb25zaWRlcmVkIGNvbXBsZXRlLgoJKiAgQHBhcmFtIHtTdHJpbmd9IGNhbGxQcm9wIFRoZSBwcm9wZXJ0eSB0byBzZXQgb24gb2JqIGlmIG9ialtwcm9wXSBpcyB0cnVlIHdoZW4gdGhlIENvbWJpbmVkQ2FsbGJhY2sgaXMgY2FsbGVkLgoJKi8KCUNvbWJpbmVkQ2FsbGJhY2suY3JlYXRlID0gZnVuY3Rpb24oY2FsbCwgb2JqLCBwcm9wLCBjYWxsUHJvcCkKCXsKCQlyZXR1cm4gQ29tYmluZWRDYWxsYmFjay5iaW5kKHRoaXMsIGNhbGwsIG9iaiwgcHJvcCwgY2FsbFByb3ApOwoJfTsKCgluYW1lc3BhY2UoJ2Nsb3Vka2lkJykuQ29tYmluZWRDYWxsYmFjayA9IENvbWJpbmVkQ2FsbGJhY2s7Cn0oKSk7Ci8qKgoqICBAbW9kdWxlIGNsb3Vka2lkCiovCihmdW5jdGlvbih1bmRlZmluZWQpIHsKCgkidXNlIHN0cmljdCI7CgoJdmFyIE5FWFRfSUQgPSAwOwoKCS8qKgoJKiAgQSBjbGFzcyBmb3IgZGVsYXlpbmcgYSBjYWxsIHRocm91Z2ggdGhlIE9TLCBpbnN0ZWFkIG9mIHJlbHlpbmcgb24gc2V0SW50ZXJ2YWwoKSBvciBzZXRUaW1lb3V0KCkuCgkqIAoJKiAgQGNsYXNzIERlbGF5ZWRDYWxsCgkqICBAY29uc3RydWN0b3IKCSogIEBwYXJhbSB7ZnVuY3Rpb259IGNhbGxiYWNrIFRoZSBmdW5jdGlvbiB0byBjYWxsIHdoZW4gdGhlIGRlbGF5IGhhcyBjb21wbGV0ZWQuCgkqICBAcGFyYW0ge2ludH0gZGVsYXkgVGhlIHRpbWUgdG8gZGVsYXkgdGhlIGNhbGwsIGluIG1pbGxpc2Vjb25kcy4KCSogIEBwYXJhbSB7Qm9vbGVhbn0gcmVwZWF0PWZhbHNlIElmIHRoZSBEZWxheWVkQ2FsbCBzaG91bGQgYXV0b21hdGljYWxseSByZXBlYXQgaXRzZWxmIHdoZW4gY29tcGxldGVkLgoJKiAgQHBhcmFtIHtCb29sZWFufSBhdXRvRGVzdHJveT10cnVlIElmIHRoZSBEZWxheWVkQ2FsbCBzaG91bGQgY2xlYW4gaXRzZWxmIHVwIHdoZW4gY29tcGxldGVkLgoJKi8KCXZhciBEZWxheWVkQ2FsbCA9IGZ1bmN0aW9uKGNhbGxiYWNrLCBkZWxheSwgcmVwZWF0LCBhdXRvRGVzdHJveSkKCXsKCQkvKioKCQkqICBUaGUgZnVuY3Rpb24gdG8gY2FsbCB3aGVuIHRoZSBkZWxheSBpcyBjb21wbGV0ZWQuCgkJKiAgQHByaXZhdGUKCQkqICBAcHJvcGVydHkge2Z1bmN0aW9ufSBfY2FsbGJhY2sKCQkqLwoJCXRoaXMuX2NhbGxiYWNrID0gY2FsbGJhY2s7CgkJLyoqCgkJKiAgVGhlIGRlbGF5IHRpbWUsIGluIG1pbGxpc2Vjb25kcy4KCQkqICBAcHJpdmF0ZQoJCSogIEBwcm9wZXJ0eSB7aW50fSBfZGVsYXkKCQkqLwoJCXRoaXMuX2RlbGF5ID0gZGVsYXk7CgkJLyoqCgkJKiAgVGhlIHRpbWVyIGNvdW50aW5nIGRvd24gZnJvbSBfZGVsYXksIGluIG1pbGxpc2Vjb25kcy4KCQkqICBAcHJpdmF0ZQoJCSogIEBwcm9wZXJ0eSB7aW50fSBfdGltZXIKCQkqLwoJCXRoaXMuX3RpbWVyID0gZGVsYXk7CgkJLyoqCgkJKiAgSWYgdGhlIERlbGF5ZWRDYWxsIHNob3VsZCByZXBlYXQgaXRzZWxmIGF1dG9tYXRpY2FsbHkuCgkJKiAgQHByaXZhdGUKCQkqICBAcHJvcGVydHkge0Jvb2xlYW59IF9yZXBlYXQKCQkqICBAZGVmYXVsdCBmYWxzZQoJCSovCgkJdGhpcy5fcmVwZWF0ID0gISFyZXBlYXQ7CgkJLyoqCgkJKiAgSWYgdGhlIERlbGF5ZWRDYWxsIHNob3VsZCBkZXN0cm95IGl0c2VsZiBhZnRlciBjb21wbGV0aW5nCgkJKiAgQHByaXZhdGUKCQkqICBAcHJvcGVydHkge0Jvb2xlYW59IF9hdXRvRGVzdHJveQoJCSogIEBkZWZhdWx0IHRydWUKCQkqLwoJCXRoaXMuX2F1dG9EZXN0cm95ID0gYXV0b0Rlc3Ryb3kgPT09IHVuZGVmaW5lZCA/IHRydWUgOiAhIWF1dG9EZXN0cm95OwoJCS8qKgoJCSogIFRoZSB1bmlxdWUgSUQgdXNlZCBmb3IgdGhlIHVwZGF0ZSBjYWxsYmFjayBmb3IgdGhlIE9TLgoJCSogIEBwcml2YXRlCgkJKiAgQHByb3BlcnR5IHtTdHJpbmd9IF91cGRhdGVJZAoJCSovCgkJdGhpcy5fdXBkYXRlSWQgPSAiRGVsYXllZENhbGwjIiArICgrK05FWFRfSUQpOwoJCS8qKgoJCSogIElmIHRoZSBEZWxheWVkQ2FsbCBpcyBjdXJyZW50bHkgcGF1c2VkIChub3Qgc3RvcHBlZCkuCgkJKiAgQHByaXZhdGUKCQkqICBAcHJvcGVydHkge0Jvb2xlYW59IF9wYXVzZWQKCQkqLwoJCXRoaXMuX3BhdXNlZCA9IGZhbHNlOwoKCQkvL3NhdmUgYSBib3VuZCB2ZXJzaW9uIG9mIHRoZSB1cGRhdGUgZnVuY3Rpb24KCQl0aGlzLl91cGRhdGUgPSB0aGlzLl91cGRhdGUuYmluZCh0aGlzKTsKCQkvL3N0YXJ0IHRoZSBkZWxheQoJCWNsb3Vka2lkLk9TLmluc3RhbmNlLmFkZFVwZGF0ZUNhbGxiYWNrKHRoaXMuX3VwZGF0ZUlkLCB0aGlzLl91cGRhdGUpOwoJfTsKCgl2YXIgcCA9IERlbGF5ZWRDYWxsLnByb3RvdHlwZTsKCgkvKioKCSogIFRoZSBjYWxsYmFjayBzdXBwbGllZCB0byB0aGUgT1MgZm9yIGFuIHVwZGF0ZSBlYWNoIGZyYW1lLgoJKiAgQHByaXZhdGUKCSogIEBtZXRob2QgX3VwZGF0ZQoJKiAgQHBhcmFtIHtpbnR9IGVsYXBzZWQgVGhlIHRpbWUgZWxhcHNlZCBzaW5jZSB0aGUgcHJldmlvdXMgZnJhbWUuCgkqLwoJcC5fdXBkYXRlID0gZnVuY3Rpb24oZWxhcHNlZCkKCXsKCQlpZighdGhpcy5fY2FsbGJhY2spCgkJewoJCQl0aGlzLmRlc3Ryb3koKTsKCQkJcmV0dXJuOwoJCX0KCgkJdGhpcy5fdGltZXIgLT0gZWxhcHNlZDsKCQlpZih0aGlzLl90aW1lciA8PSAwKQoJCXsKCQkJdGhpcy5fY2FsbGJhY2soKTsKCQkJaWYodGhpcy5fcmVwZWF0KQoJCQkJdGhpcy5fdGltZXIgKz0gdGhpcy5fZGVsYXk7CgkJCWVsc2UgaWYodGhpcy5fYXV0b0Rlc3Ryb3kpCgkJCQl0aGlzLmRlc3Ryb3koKTsKCQkJZWxzZQoJCQkJY2xvdWRraWQuT1MuaW5zdGFuY2UucmVtb3ZlVXBkYXRlQ2FsbGJhY2sodGhpcy5fdXBkYXRlSWQpOwoJCX0KCX07CgoJLyoqCgkqICBSZXN0YXJ0cyB0aGUgRGVsYXllZENhbGwsIHdoZXRoZXIgaXQgaXMgcnVubmluZyBvciBub3QuCgkqICBAcHVibGljCgkqICBAbWV0aG9kIHJlc3RhcnQKCSovCglwLnJlc3RhcnQgPSBmdW5jdGlvbigpCgl7CgkJaWYoIXRoaXMuX2NhbGxiYWNrKSByZXR1cm47CgkJdmFyIG9zID0gY2xvdWRraWQuT1MuaW5zdGFuY2U7CgkJLy9jYW4ndCBhZGQgZHVwbGljYXRlcwoJCW9zLmFkZFVwZGF0ZUNhbGxiYWNrKHRoaXMuX3VwZGF0ZUlkLCB0aGlzLl91cGRhdGUpOwoJCXRoaXMuX3RpbWVyID0gdGhpcy5fZGVsYXk7CgkJdGhpcy5fcGF1c2VkID0gZmFsc2U7Cgl9OwoKCS8qKgoJKiAgU3RvcHMgdGhlIERlbGF5ZWRDYWxsLCB3aXRob3V0IGRlc3Ryb3lpbmcgaXQuCgkqICBAcHVibGljCgkqICBAbWV0aG9kIHN0b3AKCSovCglwLnN0b3AgPSBmdW5jdGlvbigpCgl7CgkJY2xvdWRraWQuT1MuaW5zdGFuY2UucmVtb3ZlVXBkYXRlQ2FsbGJhY2sodGhpcy5fdXBkYXRlSWQpOwoJCXRoaXMuX3BhdXNlZCA9IGZhbHNlOwoJfTsKCgkvKioKCSogIElmIHRoZSBEZWxheWVkQ2FsbCBpcyBwYXVzZWQgb3Igbm90LgoJKiAgQHB1YmxpYwoJKiAgQHByb3BlcnR5IHtCb29sZWFufSBwYXVzZWQKCSovCglPYmplY3QuZGVmaW5lUHJvcGVydHkocCwgInBhdXNlZCIsIHsKCQlnZXQ6IGZ1bmN0aW9uKCkgeyByZXR1cm4gdGhpcy5fcGF1c2VkOyB9LAoJCXNldDogZnVuY3Rpb24odmFsdWUpCgkJewoJCQlpZighdGhpcy5fY2FsbGJhY2spIHJldHVybjsKCQkJdmFyIG9zID0gY2xvdWRraWQuT1MuaW5zdGFuY2U7CgkJCWlmKHRoaXMuX3BhdXNlZCAmJiAhdmFsdWUpCgkJCXsKCQkJCXRoaXMuX3BhdXNlZCA9IGZhbHNlOwoJCQkJaWYoIW9zLmhhc1VwZGF0ZUNhbGxiYWNrKHRoaXMuX3VwZGF0ZUlkKSkKCQkJCQlvcy5hZGRVcGRhdGVDYWxsYmFjayh0aGlzLl91cGRhdGVJZCwgdGhpcy5fdXBkYXRlKTsKCQkJfQoJCQllbHNlIGlmKHZhbHVlKQoJCQl7CgkJCQlpZihvcy5oYXNVcGRhdGVDYWxsYmFjayh0aGlzLl91cGRhdGVJZCkpCgkJCQl7CgkJCQkJdGhpcy5fcGF1c2VkID0gdHJ1ZTsKCQkJCQlvcy5yZW1vdmVVcGRhdGVDYWxsYmFjayh0aGlzLl91cGRhdGVJZCk7CgkJCQl9CgkJCX0KCQl9Cgl9KTsKCgkvKioKCSogIFN0b3BzIGFuZCBjbGVhbnMgdXAgdGhlIERlbGF5ZWRDYWxsLiBEbyBub3QgdXNlIGl0IGFmdGVyIGNhbGxpbmcKCSogIGRlc3Ryb3koKS4KCSogIEBwdWJsaWMKCSogIEBtZXRob2QgZGVzdHJveQoJKi8KCXAuZGVzdHJveSA9IGZ1bmN0aW9uKCkKCXsKCQljbG91ZGtpZC5PUy5pbnN0YW5jZS5yZW1vdmVVcGRhdGVDYWxsYmFjayh0aGlzLl91cGRhdGVJZCk7CgkJdGhpcy5fY2FsbGJhY2sgPSBudWxsOwoJfTsKCgluYW1lc3BhY2UoJ2Nsb3Vka2lkJykuRGVsYXllZENhbGwgPSBEZWxheWVkQ2FsbDsKfSgpKTsKLyoqCiogIEBtb2R1bGUgY2xvdWRraWQKKi8KKGZ1bmN0aW9uKCl7CgkKCSJ1c2Ugc3RyaWN0IjsKCgkvKioKCSogIEFuIGFwcGxpY2F0aW9uIGlzIGFuIGFic3RyYWN0IGNsYXNzIHdoaWNoIGV4dGVuZHMgYGNyZWF0ZWpzLkNvbnRhaW5lcmAKCSogIGFuZCBpcyBtYW5hZ2VkIGJ5IHRoZSBgY2xvdWRraWQuT1NgCgkqCgkqICBAY2xhc3MgQXBwbGljYXRpb24KCSovCgl2YXIgQXBwbGljYXRpb24gPSBmdW5jdGlvbigpCgl7CgkJaWYodHJ1ZSkgCgkJewoJCQl0aGlzLmluaXRpYWxpemUoKTsKCQl9CQoJCWVsc2UgaWYoZmFsc2UpCgkJewoJCQlQSVhJLkRpc3BsYXlPYmplY3RDb250YWluZXIuY2FsbCh0aGlzKTsKCQl9CQoJfTsKCQoJLy8gU2hvcnRjdXQgcmVmZXJlbmNlIHRvIHRoZSBwcm90b3R5cGUKCXZhciBwOwoJCgkvLyBFeHRlbmRzIHRoZSBjb250YWluZXIKCWlmICh0cnVlKQoJewoJCXAgPSBBcHBsaWNhdGlvbi5wcm90b3R5cGUgPSBuZXcgY3JlYXRlanMuQ29udGFpbmVyKCk7Cgl9CgkvLyBFeHRlbmRzIHRoZSBQSVhJIGRpc3BsYXkgb2JqZWN0CgllbHNlIGlmIChmYWxzZSkKCXsKCQlwID0gQXBwbGljYXRpb24ucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShQSVhJLkRpc3BsYXlPYmplY3RDb250YWluZXIucHJvdG90eXBlKTsKCX0KCQkKCS8qKgoJKiBUaGUgYXBwbGljYXRpb24gaXMgcmVhZHkgdG8gdXNlLCBhZGRlZCB0byBzdGFnZQoJKgoJKiBAcHVibGljCgkqIEBtZXRob2QgaW5pdAoJKi8KCXAuaW5pdCA9IGZ1bmN0aW9uKCl7fTsKCQoJLyoqCgkqICBUaGUgdXBkYXRlZCBmdW5jdGlvbiBjYWxsZWQgYnkgdGhlIE9TCgkqICB0aGlzIGZ1bmN0aW9uIGlzIGltcGxlbWVudGF0aW9uLXNwZWNpZmljCgkqCgkqICBAcHVibGljCgkqICBAbWV0aG9kIHVwZGF0ZQoJKiAgQHBhcmFtIHtpbnR9IGVsYXBzZWQgVGhlIG51bWJlciBvZiBNUyBzaW5jZSB0aGUgbGFzdCBmcmFtZSB1cGRhdGUKCSovCglwLnVwZGF0ZSA9IGZ1bmN0aW9uKGVsYXBzZWQpe307CgkKCS8qKgoJKiBEZXN0cm95IHRoZSBhcHBsaWNhdGlvbiwgZG9uJ3QgdXNlIGFmdGVyIHRoaXMKCSogCgkqIEBwdWJsaWMKCSogQG1ldGhvZCBkZXN0cm95CgkqLwoJcC5kZXN0cm95ID0gZnVuY3Rpb24oKXt9OwoJCgkvKioKCSogIFJlc2l6ZSB0aGUgYXBwbGljYXRpb24KCSoKCSogQHB1YmxpYyAKCSogQG1ldGhvZCByZXNpemUKCSovCglwLnJlc2l6ZSA9IGZ1bmN0aW9uKCl7fTsKCQoJbmFtZXNwYWNlKCdjbG91ZGtpZCcpLkFwcGxpY2F0aW9uID0gQXBwbGljYXRpb247Cn0oKSk7Ci8qKgoqICBAbW9kdWxlIGNsb3Vka2lkCiovCihmdW5jdGlvbigpewoJCgkidXNlIHN0cmljdCI7CgoJLyoqCgkqICBSZXByZXNlbnRzIGEgc2luZ2xlIGl0ZW0gaW4gdGhlIGxvYWRlciBxdWV1ZSAKCSoKCSogIEBjbGFzcyBMb2FkZXJRdWV1ZUl0ZW0KCSovCgl2YXIgTG9hZGVyUXVldWVJdGVtID0gZnVuY3Rpb24oKXt9OwoJCgkvKiogUmVmZXJlbmNlIHRvIHRoZSBwcm90b3R5cGUgKi8KCXZhciBwID0gTG9hZGVyUXVldWVJdGVtLnByb3RvdHlwZTsKCQoJLyoqIAoJKiBIaWdoZXN0IHByaW9yaXR5CgkqIEBzdGF0aWMKCSogQHB1YmxpYwoJKiBAZmluYWwKCSogQHByb3BlcnR5IHtpbnR9IFBSSU9SSVRZX0hJR0gKCSovCglMb2FkZXJRdWV1ZUl0ZW0uUFJJT1JJVFlfSElHSCA9IDE7CgkKCS8qKiAKCSogTm9ybWFsIHByaW9yaXR5LCB0aGUgZGVmYXVsdAoJKiBAc3RhdGljCgkqIEBwdWJsaWMKCSogQGZpbmFsCgkqIEBwcm9wZXJ0eSB7aW50fSBQUklPUklUWV9OT1JNQUwKCSovCglMb2FkZXJRdWV1ZUl0ZW0uUFJJT1JJVFlfTk9STUFMID0gMDsKCQoJLyoqIAoJKiBMb3dlc3QgcHJpb3JpdHkKCSogQHN0YXRpYwoJKiBAcHVibGljCgkqIEBmaW5hbAoJKiBAcHJvcGVydHkge2ludH0gUFJJT1JJVFlfTE9XCgkqLwoJTG9hZGVyUXVldWVJdGVtLlBSSU9SSVRZX0xPVyA9IC0xOwoJCgkvKioKCSogIFRoZSB1cmwgb2YgdGhlIGxvYWQKCSogIEBwdWJsaWMKCSogIEBwcm9wZXJ0eSB7c3RyaW5nfSB1cmwKCSovCglwLnVybCA9IG51bGw7CgkKCS8qKgoJKiAgRGF0YSBhc3NvY2lhdGUgd2l0aCB0aGUgbG9hZAoJKiAgQHB1YmxpYwoJKiAgQHByb3BlcnR5IHsqfSBkYXRhCgkqLwoJcC5kYXRhID0gbnVsbDsKCQoJLyoqCgkqICBUaGUgY2FsbGJhY2sgZnVuY3Rpb24gb2YgdGhlIGxvYWQsIHRvIGNhbGwgd2hlbiAKCSogIHRoZSBsb2FkIGFzIGZpbmlzaGVkLCB0YWtlcyBvbmUgYXJndW1lbnQgYXMgcmVzdWx0CgkqICBAcHVibGljCgkqICBAcHJvcGVydHkge2Z1bmN0aW9ufSBjYWxsYmFjawoJKi8KCXAuY2FsbGJhY2sgPSBudWxsOwoJCgkvKioKCSogIFRoZSBwcmlvcml0eSBvZiB0aGlzIGl0ZW0KCSogIEBwcm9wZXJ0eSB7aW50fSBwcmlvcml0eQoJKiAgQHB1YmxpYwoJKi8KCXAucHJpb3JpdHkgPSAwOwoJCgkvKioKCSogIFRoZSBhbW91bnQgd2UndmUgbG9hZGVkIHNvIGZhciwgZnJvbSAwIHRvIDEKCSogIEBwdWJsaWMKCSogIEBwcm9wZXJ0eSB7TnVtYmVyfSBwcm9ncmVzcwoJKi8KCXAucHJvZ3Jlc3MgPSAwOwoJCgkvKioKCSogIFRoZSBwcm9ncmVzcyBjYWxsYmFjawoJKiAgQHB1YmxpYwoJKiAgQHByb3BydHkge2Z1bmN0aW9ufSB1cGRhdGVDYWxsYmFjawoJKi8KCXAudXBkYXRlQ2FsbGJhY2sgPSBudWxsOwoJCglwLl9ib3VuZEZhaWwgPSBudWxsOwoJcC5fYm91bmRQcm9ncmVzcyA9IG51bGw7CglwLl9ib3VuZENvbXBsZXRlID0gbnVsbDsKCQoJLyoqCgkqICBSZXByZXNlbnQgdGhpcyBvYmplY3QgYXMgYSBzdHJpbmcKCSogIEBwdWJsaWMKCSogIEBtZXRob2QgdG9TdHJpbmcKCSogIEByZXR1cm4ge3N0cmluZ30gVGhlIHN0cmluZyByZXByZXNlbnRhdGlvbiBvZiB0aGlzIG9iamVjdAoJKi8KCXAudG9TdHJpbmcgPSBmdW5jdGlvbigpCgl7CgkJcmV0dXJuICJbTG9hZGVyUXVldWVJdGVtKHVybDonIit0aGlzLnVybCsiJywgcHJpb3JpdHk6Iit0aGlzLnByaW9yaXR5KyIpXSI7Cgl9OwoJCgkvKioKCSogIERlc3Ryb3kgdGhpcyByZXN1bHQKCSogIEBwdWJsaWMKCSogIEBtZXRob2QgZGVzdHJveQoJKi8KCXAuZGVzdHJveSA9IGZ1bmN0aW9uKCkKCXsKCQl0aGlzLmNhbGxiYWNrID0gbnVsbDsKCQl0aGlzLnVwZGF0ZUNhbGxiYWNrID0gbnVsbDsKCQl0aGlzLmRhdGEgPSBudWxsOwoJCXRoaXMuX2JvdW5kRmFpbCA9IG51bGw7CgkJdGhpcy5fYm91bmRQcm9ncmVzcyA9IG51bGw7CgkJdGhpcy5fYm91bmRDb21wbGV0ZSA9IG51bGw7Cgl9OwoJCgkvLyBBc3NpZ24gdG8gdGhlIG5hbWUgc3BhY2UKCW5hbWVzcGFjZSgnY2xvdWRraWQnKS5Mb2FkZXJRdWV1ZUl0ZW0gPSBMb2FkZXJRdWV1ZUl0ZW07Cn0oKSk7Ci8qKgoqICBAbW9kdWxlIGNsb3Vka2lkCiovCihmdW5jdGlvbigpewoJCgkidXNlIHN0cmljdCI7CgkKCS8qKgoJKiAgVGhlIE1lZGlhbG9hZGVyIGlzIHRoZSBzaW5nbGV0b24gbG9hZGVyIGZvciBsb2FkaW5nIGFsbCBhc3NldHMKCSogIGluY2x1ZGluZyBpbWFnZXMsIGRhdGEsIGNvZGUgYW5kIHNvdW5kcy4gTWVkaWFMb2FkZXIgc3VwcG9ydHMgY2FjaGUtYnVzdGluZwoJKiAgaW4gdGhlIGJyb3dzZXIgdXNpbmcgZHluYW1pYyBxdWVyeSBzdHJpbmcgcGFyYW1ldGVycy4KCSogCgkqICBAY2xhc3MgTWVkaWFMb2FkZXIKCSovCgl2YXIgTWVkaWFMb2FkZXIgPSBmdW5jdGlvbigpe307CgkKCS8qKiBUaGUgcHJvdG90eXBlICovCgl2YXIgcCA9IE1lZGlhTG9hZGVyLnByb3RvdHlwZTsKCQoJLyoqCgkqIFJlZmVyZW5jZSB0byB0aGUgcHJpdmF0ZSBpbnN0YW5jZSBvYmplY3QKCSogQHN0YXRpYwoJKiBAcHJvdGVjdGVkCgkqLwoJTWVkaWFMb2FkZXIuX2luc3RhbmNlID0gbnVsbDsKCQoJLyoqCgkqICBUaGUgY29sbGVjdGlvbiBvZiBMb2FkZXJRdWV1ZUl0ZW1zCgkqICBAcHJpdmF0ZQoJKi8KCXZhciBxdWV1ZSA9IG51bGw7CgkKCS8qKgoJKiAgVGhlIGNvbGxlY3Rpb24gb2YgTG9hZGVyUXVldWVJdGVtcyBieSB1cmwKCSogIEBwcml2YXRlCgkqLwoJdmFyIHF1ZXVlSXRlbXMgPSBudWxsOwoJCgkvKioKCSogIFRoZSBjb2xsZWN0aW9uIG9mIGxvYWRlcnMKCSogIEBwcml2YXRlCgkqICBAcHJvcGVydHkge29iamVjdH0gbG9hZGVycwoJKi8KCXZhciBsb2FkZXJzID0gbnVsbDsKCQoJdmFyIHFpUG9vbCA9IG51bGw7Cgl2YXIgbG9hZGVyUG9vbCA9IG51bGw7Cgl2YXIgcmVzdWx0UG9vbCA9IG51bGw7CgkKCS8qKgoJKiAgVGhlIGN1cnJlbnQgbnVtYmVyIG9mIGl0ZW1zIGxvYWRpbmcKCSogIEBwcml2YXRlCgkqICBAcHJvcGVydHkge2ludH0gbnVtTG9hZHMKCSogIEBkZWZhdWx0IDAKCSovCgl2YXIgbnVtTG9hZHMgPSAwOwoJCgl2YXIgcmV0cmllcyA9IG51bGw7CgkKCS8qKgoJKiAgSWYgd2UgY2FuIGxvYWQKCSogIEBwcml2YXRlCgkqLwoJcC5fY2FuTG9hZCA9IHRydWU7CgkKCS8qKgoJKiAgVGhlIG1heGltdW0gbnVtYmVyIG9mIHNpbXVsYW5lb3VzIGxvYWRzCgkqICBAcHVibGljCgkqICBAcHJvcGVydHkge2ludH0gbWF4U2ltdWx0YW5lb3VzTG9hZHMKCSogIEBkZWZhdWx0IDIKCSovCglwLm1heFNpbXVsdGFuZW91c0xvYWRzID0gMjsKCQoJLyoqCgkqICBUaGUgcmVmZXJlbmNlIHRvIHRoZSBjYWNoZSBtYW5hZ2VyCgkqICBAcHVibGljCgkqICBAcHJvcGVydHkge2Nsb3Vka2lkLkNhY2hlTWFuYWdlcn0gY2FjaGVNYW5hZ2VyCgkqLwoJcC5jYWNoZU1hbmFnZXIgPSBudWxsOwoJCgkvKioKCSogIFN0YXRpYyBjb25zdHJ1Y3RvciBjcmVhdGluZyB0aGUgc2luZ2xldG9uCgkqICBAbWV0aG9kIGluaXQKCSogIEBzdGF0aWMKCSogIEBwdWJsaWMKCSovCglNZWRpYUxvYWRlci5pbml0ID0gZnVuY3Rpb24oKQoJewoJCWlmICghTWVkaWFMb2FkZXIuX2luc3RhbmNlKQoJCXsKCQkJTWVkaWFMb2FkZXIuX2luc3RhbmNlID0gbmV3IE1lZGlhTG9hZGVyKCk7CgkJCU1lZGlhTG9hZGVyLl9pbnN0YW5jZS5faW5pdGlhbGl6ZSgpOwoJCX0KCQlyZXR1cm4gTWVkaWFMb2FkZXIuX2luc3RhbmNlOwoJfTsKCQkKCS8qKgoJKiAgU3RhdGljIGZ1bmN0aW9uIGZvciBnZXR0aW5nIHRoZSBzaW5nbGV0b24gaW5zdGFuY2UKCSogIEBzdGF0aWMKCSogIEByZWFkT25seQoJKiAgQHB1YmxpYwoJKiAgQHByb3BlcnR5IHtjbG91ZGtpZC5PU30gaW5zdGFuY2UKCSovCglPYmplY3QuZGVmaW5lUHJvcGVydHkoTWVkaWFMb2FkZXIsICJpbnN0YW5jZSIsIHsKCQlnZXQ6ZnVuY3Rpb24oKQoJCXsKCQkJaWYgKCFNZWRpYUxvYWRlci5faW5zdGFuY2UpCgkJCXsKCQkJCXRocm93ICdDYWxsIGNsb3Vka2lkLk1lZGlhTG9hZGVyLmluaXQoKSc7CgkJCX0KCQkJcmV0dXJuIE1lZGlhTG9hZGVyLl9pbnN0YW5jZTsKCQl9Cgl9KTsKCQoJLyoqCgkqICBEZXN0cm95IHRoZSBNZWRpYUxvYWRlciBzaW5nbGV0b24sIGRvbid0IHVzZSBhZnRlciB0aGlzCgkqICBAcHVibGljCgkqICBAbWV0aG9kIGRlc3Ryb3kKCSovCglwLmRlc3Ryb3kgPSBmdW5jdGlvbigpCgl7CgkJdmFyIGksIGxlbiwga2V5LCBhcnIgPSB0aGlzLnF1ZXVlOwoJCWlmKGFycikKCQl7CgkJCWZvcihpID0gMCwgbGVuID0gYXJyLmxlbmd0aDsgaSA8IGk7ICsraSkKCQkJCWFycltpXS5kZXN0cm95KCk7CgkJCWFyciA9IHFpUG9vbDsKCQkJZm9yKGkgPSAwLCBsZW4gPSBhcnIubGVuZ3RoOyBpIDwgaTsgKytpKQoJCQkJYXJyW2ldLmRlc3Ryb3koKTsKCQkJYXJyID0gcmVzdWx0UG9vbDsKCQkJZm9yKGkgPSAwLCBsZW4gPSBhcnIubGVuZ3RoOyBpIDwgaTsgKytpKQoJCQkJYXJyW2ldLmRlc3Ryb3koKTsKCQkJZm9yKGtleSBpbiBsb2FkZXJzKQoJCQl7CgkJCQlxdWV1ZUl0ZW1zW2tleV0uZGVzdHJveSgpOwoJCQkJbG9hZGVyc1trZXldLmNsb3NlKCk7CgkJCX0KCQl9CgkJTWVkaWFMb2FkZXIuX2luc3RhbmNlID0gbnVsbDsKCQlpZiAodGhpcy5jYWNoZU1hbmFnZXIpCgkJCXRoaXMuY2FjaGVNYW5hZ2VyLmRlc3Ryb3koKTsKCQl0aGlzLmNhY2hlTWFuYWdlciA9IG51bGw7CgkJcXVldWUgPSBudWxsOwoJCXJlc3VsdFBvb2wgPSBudWxsOwoJCWxvYWRlclBvb2wgPSBudWxsOwoJCXFpUG9vbCA9IG51bGw7CgkJcXVldWVJdGVtcyA9IG51bGw7CgkJcmV0cmllcyA9IG51bGw7CgkJbG9hZGVycyA9IG51bGw7Cgl9OwoJCgkvKioKCSogIEluaXRpbGl6ZSB0aGUgb2JqZWN0CgkqICBAcHJvdGVjdGVkCgkqICBAbWV0aG9kIF9pbml0aWFsaXplCgkqLwoJcC5faW5pdGlhbGl6ZSA9IGZ1bmN0aW9uKCkKCXsKCQlxaVBvb2wgPSBbXTsKCQlsb2FkZXJQb29sID0gW107CgkJcmVzdWx0UG9vbCA9IFtdOwoJCXF1ZXVlID0gW107CgkJcXVldWVJdGVtcyA9IHt9OwoJCWxvYWRlcnMgPSB7fTsKCQlyZXRyaWVzID0ge307CgkJdGhpcy5jYWNoZU1hbmFnZXIgPSBuZXcgY2xvdWRraWQuQ2FjaGVNYW5hZ2VyKCk7Cgl9OwoJCgkvKioKCSogIExvYWQgYSBmaWxlIAoJKiAgQG1ldGhvZCBsb2FkCgkqICBAcHVibGljCgkqICBAcGFyYW0ge3N0cmluZ30gdXJsIFRoZSBmaWxlIHBhdGggdG8gbG9hZAoJKiAgQHBhcmFtIHtmdW5jdGlvbn0gY2FsbGJhY2sgVGhlIGNhbGxiYWNrIGZ1bmN0aW9uIHdoZW4gY29tcGxldGVkCgkqICBAcGFyYW0ge2Z1bmN0aW9uKn0gdXBkYXRlQ2FsbGJhY2sgVGhlIGNhbGxiYWNrIGZvciBsb2FkIHByb2dyZXNzIHVwZGF0ZSwgcGFzc2VzIDAtMSBhcyBwYXJhbQoJKiAgQHBhcmFtIHtpbnQqfSBwcmlvcml0eSBUaGUgcHJpb3JpdHkgb2YgdGhlIGxvYWQKCSogIEBwYXJhbSB7Kn0gZGF0YSBvcHRpb25hbCBkYXRhCgkqLwoJcC5sb2FkID0gZnVuY3Rpb24odXJsLCBjYWxsYmFjaywgdXBkYXRlQ2FsbGJhY2ssIHByaW9yaXR5LCBkYXRhKQoJewoJCXZhciBxaSA9IHRoaXMuX2dldFFJKCk7CgkJCgkJdmFyIGJhc2VQYXRoID0gY2xvdWRraWQuT1MuaW5zdGFuY2Uub3B0aW9ucy5iYXNlUGF0aDsKCQlpZiAoYmFzZVBhdGggIT09IHVuZGVmaW5lZCAmJiAvXmh0dHAocyk/XDovLnRlc3QodXJsKSA9PT0gZmFsc2UgJiYgdXJsLnNlYXJjaChiYXNlUGF0aCkgPT0gLTEpCgkJewoJCQlxaS5iYXNlUGF0aCA9IGJhc2VQYXRoOwoJCX0KCQkKCQlxaS51cmwgPSB1cmw7CgkJcWkuY2FsbGJhY2sgPSBjYWxsYmFjazsKCQlxaS51cGRhdGVDYWxsYmFjayA9IHVwZGF0ZUNhbGxiYWNrIHx8IG51bGw7CgkJcWkucHJpb3JpdHkgPSBwcmlvcml0eSB8fCBjbG91ZGtpZC5Mb2FkZXJRdWV1ZUl0ZW0uUFJJT1JJVFlfTk9STUFMOwoJCXFpLmRhdGEgPSBkYXRhIHx8IG51bGw7CgkJCgkJcXVldWUucHVzaChxaSk7CgkJCgkJLy8gU29yeSBieSBwcmlvcml0eQoJCXF1ZXVlLnNvcnQoZnVuY3Rpb24oYSwgYil7CgkJCXJldHVybiBhLnByaW9yaXR5IC0gYi5wcmlvcml0eTsKCQl9KTsKCQkKCQkvLyBUcnkgdG8gbG9hZCB0aGUgbmV4dCBxdWV1ZSBpdGVtCgkJdGhpcy5fdHJ5TmV4dExvYWQoKTsKCX07CgkKCS8qKgoJKiAgVGhlcmUgd2FzIGFuIGVycm9yIGxvYWRpbmcgdGhlIGZpbGUKCSogIEBwcml2YXRlCgkqICBAbWV0aG9kIF9vbkxvYWRGYWlsZWQKCSogIEBwYXJhbSB7Y2xvdWRraWQuTG9hZGVyUXVldWVJdGVtfSBxaSBUaGUgbG9hZGVyIHF1ZXVlIGl0ZW0KCSovCglwLl9vbkxvYWRGYWlsZWQgPSBmdW5jdGlvbihxaSwgZXZlbnQpCgl7CgkJRGVidWcuZXJyb3IoIlVuYWJsZSB0byBsb2FkIGZpbGU6ICIgKyBxaS51cmwgICsgIiAtIHJlYXNvbjogIiArIGV2ZW50LmVycm9yKTsKCQkKCQl2YXIgbG9hZGVyID0gbG9hZGVyc1txaS51cmxdOwoJCWxvYWRlci5yZW1vdmVBbGxFdmVudExpc3RlbmVycygpOwoJCWxvYWRlci5jbG9zZSgpOwoJCXRoaXMuX3Bvb2xMb2FkZXIobG9hZGVyKTsKCQkKCQlkZWxldGUgcXVldWVJdGVtc1txaS51cmxdOwoJCWRlbGV0ZSBsb2FkZXJzW3FpLnVybF07CgkJCgkJaWYocmV0cmllc1txaS51cmxdKQoJCQlyZXRyaWVzW3FpLnVybF0rKzsKCQllbHNlCgkJCXJldHJpZXNbcWkudXJsXSA9IDE7CgkJaWYocmV0cmllc1txaS51cmxdID4gMykKCQkJdGhpcy5fbG9hZERvbmUocWksIG51bGwpOwoJCWVsc2UKCQl7CgkJCW51bUxvYWRzLS07CgkJCXF1ZXVlLnB1c2gocWkpOwoJCQl0aGlzLl90cnlOZXh0TG9hZCgpOwoJCX0KCX07CgkKCS8qKgoJKiAgVGhlIGZpbGUgbG9hZCBwcm9ncmVzcyBldmVudAoJKiAgQG1ldGhvZCBfb25Mb2FkUHJvZ3Jlc3MKCSogIEBwcml2YXRlCgkqICBAcGFyYW0ge2Nsb3Vka2lkLkxvYWRlclF1ZXVlSXRlbX0gcWkgVGhlIGxvYWRlciBxdWV1ZSBpdGVtCgkqICBAcGFyYW0ge29iamVjdH0gZXZlbnQgVGhlIHByb2dyZXNzIGV2ZW50CgkqLwoJcC5fb25Mb2FkUHJvZ3Jlc3MgPSBmdW5jdGlvbihxaSwgZXZlbnQpCgl7CgkJcWkucHJvZ3Jlc3MgPSBldmVudC5wcm9ncmVzczsKCQlpZiAocWkudXBkYXRlQ2FsbGJhY2spewoJCQlxaS51cGRhdGVDYWxsYmFjayhxaS5wcm9ncmVzcyk7CgkJfQkKCX07CgkKCS8qKgoJKiAgVGhlIGZpbGUgd2FzIGxvYWRlZCBzdWNjZXNzZnVsbHkKCSogIEBwcml2YXRlCgkqICBAbWV0aG9kIF9vbkxvYWRDb21wbGV0ZWQKCSogIEBwYXJhbSB7Y2xvdWRraWQuTG9hZGVyUXVldWVJdGVtfSBxaSBUaGUgbG9hZGVyIHF1ZXVlIGl0ZW0KCSogIEBwYXJhbSB7b2JqZWN0fSBldiBUaGUgbG9hZCBldmVudAoJKi8KCXAuX29uTG9hZENvbXBsZXRlZCA9IGZ1bmN0aW9uKHFpLCBldikKCXsKCQlpZih0cnVlKQoJCXsKCQkJRGVidWcubG9nKCJGaWxlIGxvYWRlZCBzdWNjZXNzZnVsbHkgZnJvbSAiICsgcWkudXJsKTsKCQl9CgkJdmFyIGxvYWRlciA9IGxvYWRlcnNbcWkudXJsXTsKCQlsb2FkZXIucmVtb3ZlQWxsRXZlbnRMaXN0ZW5lcnMoKTsKCQlsb2FkZXIuY2xvc2UoKTsKCQl0aGlzLl9wb29sTG9hZGVyKGxvYWRlcik7CgkJCgkJZGVsZXRlIHF1ZXVlSXRlbXNbcWkudXJsXTsKCQlkZWxldGUgbG9hZGVyc1txaS51cmxdOwoJCXRoaXMuX2xvYWREb25lKHFpLCB0aGlzLl9nZXRSZXN1bHQoZXYucmVzdWx0LCBxaS51cmwsIGxvYWRlcikpOwoJfTsKCQoJLyoqCgkqICBBdHRlbXB0IHRvIGRvIHRoZSBuZXh0IGxvYWQKCSogIEBtZXRob2QgX3RyeU5leHRMb2FkCgkqICBAcHJpdmF0ZQoJKi8KCXAuX3RyeU5leHRMb2FkID0gZnVuY3Rpb24oKQoJewoJCWlmIChudW1Mb2FkcyA+IHRoaXMubWF4U2ltdWx0YW5lb3VzTG9hZHMgLSAxIHx8IHF1ZXVlLmxlbmd0aCA9PT0gMCkgcmV0dXJuOwoJCQoJCW51bUxvYWRzKys7CgkJCgkJdmFyIHFpID0gcXVldWUuc2hpZnQoKTsKCQkKCQlpZih0cnVlKQoJCXsKCQkJRGVidWcubG9nKCJBdHRlbXB0aW5nIHRvIGxvYWQgZmlsZSAnIiArIHFpLnVybCArICInIik7CgkJfQoJCQoJCXF1ZXVlSXRlbXNbcWkudXJsXSA9IHFpOwoJCQoJCXZhciBsb2FkZXIgPSB0aGlzLl9nZXRMb2FkZXIocWkuYmFzZVBhdGgpOwoJCQoJCS8vIEFkZCB0byB0aGUgbGlzdCBvZiBsb2FkZXJzCgkJbG9hZGVyc1txaS51cmxdID0gbG9hZGVyOwoJCQoJCWxvYWRlci5hZGRFdmVudExpc3RlbmVyKCJmaWxlbG9hZCIsIHFpLl9ib3VuZENvbXBsZXRlKTsKCQlsb2FkZXIuYWRkRXZlbnRMaXN0ZW5lcigiZXJyb3IiLCBxaS5fYm91bmRGYWlsKTsKCQlsb2FkZXIuYWRkRXZlbnRMaXN0ZW5lcigiZmlsZXByb2dyZXNzIiwgcWkuX2JvdW5kUHJvZ3Jlc3MpOwoJCXZhciB1cmwgPSB0aGlzLmNhY2hlTWFuYWdlci5wcmVwYXJlKHFpLnVybCk7CgkJbG9hZGVyLmxvYWRGaWxlKHFpLmRhdGEgPyB7aWQ6cWkuZGF0YS5pZCwgc3JjOnVybCwgZGF0YTpxaS5kYXRhfSA6IHVybCk7Cgl9OwoJCgkvKioKCSogIEFsZXJ0IHRoYXQgdGhlIGxvYWRpbmcgaXMgZmluaXNoZWQKCSogIEBwcml2YXRlIAoJKiAgQG1ldGhvZCBfbG9hZERvbmUKCSogIEBwYXJhbSB7Y2xvdWRraWQuTG9hZGVyUXVldWVJdGVtfSBxaSBUaGUgbG9hZGVyIHF1ZXVlIGl0ZW0KCSogIEBwYXJhbSB7b2JqZWN0fSByZXN1bHQgVGhlIGV2ZW50IGZyb20gcHJlbG9hZGpzIG9yIG51bGwKCSovCglwLl9sb2FkRG9uZSA9IGZ1bmN0aW9uKHFpLCByZXN1bHQpCgl7CgkJbnVtTG9hZHMtLTsKCQlpZihxaS5kYXRhICYmIHJlc3VsdCkvL2Egd2F5IHRvIGtlZXAgdHJhY2sgb2YgbG9hZCByZXN1bHRzIHdpdGhvdXQgZXhjZXNzaXZlIGZ1bmN0aW9uIGJpbmRpbmcKCQkJcmVzdWx0LmlkID0gcWkuZGF0YS5pZDsKCQlxaS5jYWxsYmFjayhyZXN1bHQpOwoJCS8vcWkuZGVzdHJveSgpOwoJCXRoaXMuX3Bvb2xRSShxaSk7CgkJdGhpcy5fdHJ5TmV4dExvYWQoKTsKCX07CgkKCS8qKgoJKiAgQ2FuY2VsIGEgbG9hZCB0aGF0J3MgY3VycmVudGx5IGluIHByb2dyZXNzCgkqICBAcHVibGljCgkqICBAbWV0aG9kIGNhbmNlbAoJKiAgQHBhcmFtIHtzdHJpbmd9IHVybCBUaGUgdXJsCgkqICBAcmV0dXJuIHtib29sfSBJZiBjYW5jZWxlZCByZXR1cm5zIHRydWUsIGZhbHNlIGlmIG5vdCBjYW5jZWxlZAoJKi8KCXAuY2FuY2VsID0gZnVuY3Rpb24odXJsKQoJewoJCXZhciBxaSA9IHF1ZXVlSXRlbXNbdXJsXTsKCQl2YXIgbG9hZGVyID0gbG9hZGVyc1t1cmxdOwoJCQoJCWlmIChxaSAmJiBsb2FkZXIpCgkJewoJCQlsb2FkZXIuY2xvc2UoKTsKCQkJZGVsZXRlIGxvYWRlcnNbdXJsXTsKCQkJZGVsZXRlIHF1ZXVlSXRlbXNbcWkudXJsXTsKCQkJbnVtTG9hZHMtLTsKCQkJdGhpcy5fcG9vbExvYWRlcihsb2FkZXIpOwoJCQl0aGlzLl9wb29sUUkocWkpOwoJCQlyZXR1cm4gdHJ1ZTsKCQl9CgkJCgkJZm9yKGkgPSAwLCBsZW4gPSBxdWV1ZS5sZW5ndGg7IGkgPCBsZW47IGkrKykKCQl7CgkJCXFpID0gcXVldWVbaV07CgkJCWlmIChxaS51cmwgPT0gdXJsKXsKCQkJCXF1ZXVlLnNwbGljZShpLCAxKTsKCQkJCXRoaXMuX3Bvb2xRSShxaSk7CgkJCQlyZXR1cm4gdHJ1ZTsKCQkJfQoJCX0KCQlyZXR1cm4gZmFsc2U7CQkKCX07CgkKCXAuX2dldFFJID0gZnVuY3Rpb24oKQoJewoJCXZhciBydG47CgkJaWYocWlQb29sLmxlbmd0aCkKCQkJcnRuID0gcWlQb29sLnBvcCgpOwoJCWVsc2UKCQl7CgkJCXJ0biA9IG5ldyBjbG91ZGtpZC5Mb2FkZXJRdWV1ZUl0ZW0oKTsKCQkJcnRuLl9ib3VuZEZhaWwgPSB0aGlzLl9vbkxvYWRGYWlsZWQuYmluZCh0aGlzLCBydG4pOwoJCQlydG4uX2JvdW5kUHJvZ3Jlc3MgPSB0aGlzLl9vbkxvYWRQcm9ncmVzcy5iaW5kKHRoaXMsIHJ0bik7CgkJCXJ0bi5fYm91bmRDb21wbGV0ZSA9IHRoaXMuX29uTG9hZENvbXBsZXRlZC5iaW5kKHRoaXMsIHJ0bik7CgkJfQoJCXJldHVybiBydG47Cgl9OwoJCglwLl9wb29sUUkgPSBmdW5jdGlvbihxaSkKCXsKCQlxaVBvb2wucHVzaChxaSk7CgkJcWkuY2FsbGJhY2sgPSBxaS51cGRhdGVDYWxsYmFjayA9IHFpLmRhdGEgPSBxaS51cmwgPSBudWxsOwoJCXFpLnByb2dyZXNzID0gMDsKCX07CgkKCXAuX2dldExvYWRlciA9IGZ1bmN0aW9uKGJhc2VQYXRoKQoJewoJCXZhciBydG47CgkJaWYobG9hZGVyUG9vbC5sZW5ndGgpCgkJewoJCQlydG4gPSBsb2FkZXJQb29sLnBvcCgpOwoJCQlydG4uX2Jhc2VQYXRoID0gYmFzZVBhdGg7Ly9hcHBhcmVudGx5IHRoZXkgbmVnbGVjdGVkIHRvIG1ha2UgdGhpcyBwdWJsaWMKCQl9CgkJZWxzZQoJCQlydG4gPSBuZXcgY3JlYXRlanMuTG9hZFF1ZXVlKHRydWUsIGJhc2VQYXRoKTsKCQkvL2FsbG93IHRoZSBsb2FkZXIgdG8gaGFuZGxlIHNvdW5kIGFzIHdlbGwKCQlpZihjcmVhdGVqcy5Tb3VuZCkKCQkJcnRuLmluc3RhbGxQbHVnaW4oY3JlYXRlanMuU291bmQpOwoJCXJldHVybiBydG47Cgl9OwoJCglwLl9wb29sTG9hZGVyID0gZnVuY3Rpb24obG9hZGVyKQoJewoJCWxvYWRlci5yZW1vdmVBbGwoKTsvL2NsZWFyIHRoZSBsb2FkZXIgZm9yIHJldXNlCgkJbG9hZGVyUG9vbC5wdXNoKGxvYWRlcik7Cgl9OwoJCglwLl9nZXRSZXN1bHQgPSBmdW5jdGlvbihyZXN1bHQsIHVybCwgbG9hZGVyKQoJewoJCXZhciBydG47CgkJaWYocmVzdWx0UG9vbC5sZW5ndGgpCgkJewoJCQlydG4gPSByZXN1bHRQb29sLnBvcCgpOwoJCQlydG4uY29udGVudCA9IHJlc3VsdDsKCQkJcnRuLnVybCA9IHVybDsKCQkJcnRuLmxvYWRlciA9IGxvYWRlcjsKCQl9CgkJZWxzZQoJCQlydG4gPSBuZXcgY2xvdWRraWQuTWVkaWFMb2FkZXJSZXN1bHQocmVzdWx0LCB1cmwsIGxvYWRlcik7CgkJcmV0dXJuIHJ0bjsKCX07CgkKCXAuX3Bvb2xSZXN1bHQgPSBmdW5jdGlvbihyZXN1bHQpCgl7CgkJcmVzdWx0LmNvbnRlbnQgPSByZXN1bHQudXJsID0gcmVzdWx0LmxvYWRlciA9IHJlc3VsdC5pZCA9IG51bGw7CgkJcmVzdWx0UG9vbC5wdXNoKHJlc3VsdCk7Cgl9OwoJCgluYW1lc3BhY2UoJ2Nsb3Vka2lkJykuTWVkaWFMb2FkZXIgPSBNZWRpYUxvYWRlcjsKfSgpKTsKLyoqCiogIEBtb2R1bGUgY2xvdWRraWQKKi8KKGZ1bmN0aW9uKCl7CgkKCSJ1c2Ugc3RyaWN0IjsKCgkvKioKCSogIFRoZSByZXR1cm4gcmVzdWx0IG9mIHRoZSBNZWRpYUxvYWRlciBsb2FkCgkqICBAY2xhc3MgTWVkaWFMb2FkZXJSZXN1bHQKCSogIEBjb25zdHJ1Y3RvcgoJKiAgQHBhcmFtIHsqfSBjb250ZW50IFRoZSBkeW5hbWljIGNvbnRlbnQgbG9hZGVkCgkqICBAcGFyYW0ge3N0cmluZ30gdXJsIFRoZSB1cmwgdGhhdCB3YXMgbG9hZGVkCgkqICBAcGFyYW0ge2NyZWF0ZWpzLkxvYWRRdWV1ZX0gbG9hZGVyIFRoZSBMb2FkUXVldWUgdGhhdCBwZXJmb3JtZWQgdGhlIGxvYWQKCSovCgl2YXIgTWVkaWFMb2FkZXJSZXN1bHQgPSBmdW5jdGlvbihjb250ZW50LCB1cmwsIGxvYWRlcikKCXsKCQl0aGlzLmNvbnRlbnQgPSBjb250ZW50OwoJCXRoaXMudXJsID0gdXJsOwoJCXRoaXMubG9hZGVyID0gbG9hZGVyOwoJfTsKCQoJLyoqIFJlZmVyZW5jZSB0byB0aGUgcHJvdG90eXBlICovCgl2YXIgcCA9IE1lZGlhTG9hZGVyUmVzdWx0LnByb3RvdHlwZTsKCQoJLyoqCgkqICBUaGUgY29udGVudHMgb2YgdGhlIGxvYWQKCSogIEBwdWJsaWMKCSogIEBwcm9wZXJ0eSB7Kn0gY29udGVudCAKCSovCglwLmNvbnRlbnQgPSBudWxsOwoJCgkvKioKCSogIFRoZSB1cmwgb2YgdGhlIGxvYWQKCSogIEBwdWJsaWMKCSogIEBwcm9wZXJ0eSB7c3RyaW5nfSB1cmwKCSovCglwLnVybCA9IG51bGw7CgkKCS8qKgoJKiAgUmVmZXJlbmNlIHRvIHRoZSBwcmVsb2FkZXIgb2JqZWN0CgkqICBAcHVibGljCgkqICBAcHJvcGVydHkge2NyZWF0ZWpzLkxvYWRlclF1ZXVlfSBsb2FkZXIKCSovCglwLmxvYWRlciA9IG51bGw7CgkKCS8qKgoJKiBBIHRvIHN0cmluZyBtZXRob2QKCSogQHB1YmxpYwoJKiBAbWV0aG9kIHRvU3RyaW5nCgkqIEByZXR1cm4ge3N0cmluZ30gQSBzdHJpbmcgcmVwIG9mIHRoZSBvYmplY3QKCSovCglwLnRvU3RyaW5nID0gZnVuY3Rpb24oKQoJewoJCXJldHVybiAiW01lZGlhTG9hZGVyUmVzdWx0KCciK3RoaXMudXJsKyInKV0iOwoJfTsKCQoJLyoqCgkqIERlc3Ryb3kgdGhpcyByZXN1bHQKCSogQHB1YmxpYwoJKiBAbWV0aG9kIGRlc3Ryb3kKCSovCglwLmRlc3Ryb3kgPSBmdW5jdGlvbigpCgl7CgkJdGhpcy5jYWxsYmFjayA9IG51bGw7CgkJdGhpcy51cmwgPSBudWxsOwoJCXRoaXMuY29udGVudCA9IG51bGw7Cgl9OwoJCgkvLyBBc3NpZ24gdG8gdGhlIG5hbWUgc3BhY2UKCW5hbWVzcGFjZSgnY2xvdWRraWQnKS5NZWRpYUxvYWRlclJlc3VsdCA9IE1lZGlhTG9hZGVyUmVzdWx0Owp9KCkpOwovKioKKiAgQG1vZHVsZSBjbG91ZGtpZAoqLwooZnVuY3Rpb24odW5kZWZpbmVkKXsKCQoJInVzZSBzdHJpY3QiOwoJCgkvKioKCSogIFVzZWQgZm9yIG1hbmFnaW5nIHRoZSBicm93c2VyIGNhY2hlIG9mIGxvYWRpbmcgZXh0ZXJuYWwgZWxlbWVudHMKCSogIGNhbiBlYXNpbHkgbG9hZCB2ZXJzaW9uIG1hbmlmZXN0IGFuZCBhcHBseSBpdCB0byB0aGUgbWVkaWEgbG9hZGVyCgkqICBzdXBwb3J0cyBjYWNoZSBidXN0aW5nIGFsbCBtZWRpYSBsb2FkIHJlcXVlc3RzCgkqICB1c2VzIHRoZSBxdWVyeSBzdHJpbmcgdG8gYnVzdCBicm93c2VyIHZlcnNpb25zLgoJKiAKCSogIEBjbGFzcyBDYWNoZU1hbmFnZXIKCSovCgl2YXIgQ2FjaGVNYW5hZ2VyID0gZnVuY3Rpb24oKQoJewoJCXRoaXMuaW5pdGlhbGl6ZSgpOwoJfTsKCQoJLyoqIEVhc3kgYWNjZXNzIHRvIHRoZSBwcm90b3R5cGUgKi8KCXZhciBwID0gQ2FjaGVNYW5hZ2VyLnByb3RvdHlwZSA9IHt9OwoJCgkvKioKCSogIFRoZSBjb2xsZWN0aW9uIG9mIHZlcnNpb24gbnVtYmVycwoJKiAgQHByb3RlY3RlZAoJKiAgQHByb3BlcnR5IHtEaWN0aW9uYXJ5fSBfdmVyc2lvbnMKCSovCglwLl92ZXJzaW9ucyA9IG51bGw7CgkKCS8qKgoJKiAgSWYgd2UgYXJlIHN1cHBvc2UgdG8gY2FjaGUgYnVzdCBldmVyeSBmaWxlCgkqICBAcHJvcGVydHkge2Jvb2x9IGNhY2hlQnVzdAoJKiAgQHB1YmxpYwoJKiAgQGRlZmF1bHQgZmFsc2UKCSovCglwLmNhY2hlQnVzdCA9IGZhbHNlOwoJCgkvKioKCSogVGhlIGNvbnN0cnVjdG9yIGZvciB0aGUgQ2FjaGUgbWFuYWdlcgoJKiBAcHVibGljCgkqIEBjb25zdHJ1Y3RvcgoJKiBAbWV0aG9kIGluaXRpYWxpemUKCSovCglwLmluaXRpYWxpemUgPSBmdW5jdGlvbigpCgl7CgkJdGhpcy5fdmVyc2lvbnMgPSBbXTsKCQkJCQoJCXZhciBjYiA9IGNsb3Vka2lkLk9TLmluc3RhbmNlLm9wdGlvbnMuY2FjaGVCdXN0OwoJCXRoaXMuY2FjaGVCdXN0ID0gY2IgPyAoY2IgPT09ICJ0cnVlIiB8fCBjYiA9PT0gdHJ1ZSkgOiBmYWxzZTsKCQkKCQlpZih0cnVlKQoJCXsKCQkJaWYgKHRoaXMuY2FjaGVCdXN0KSBEZWJ1Zy5sb2coIkNhY2hlQnVzdCBhbGwgZmlsZXMgaXMgb24uIik7CgkJfQoJfTsKCQoJLyoqCgkqICBEZXN0cm95IHRoZSBjYWNoZSBtYW5hZ2VyLCBkb24ndCB1c2UgYWZ0ZXIgdGhpcwoJKiAgQHB1YmxpYwoJKiAgQG1ldGhvZCBkZXN0cm95CgkqLwoJcC5kZXN0cm95ID0gZnVuY3Rpb24oKQoJewoJCXRoaXMuX3ZlcnNpb25zID0gbnVsbDsKCX07CgkKCS8qKgoJKiAgQWRkIHRoZSB2ZXJzaW9ucwoJKiAgQHB1YmxpYwoJKiAgQG1ldGhvZCBhZGRWZXJzaW9uc0ZpbGUKCSogIEBwYXJhbSB7c3RyaW5nfSB1cmwgVGhlIHVybCBvZiB0aGUgdmVyc2lvbnMgZmlsZQoJKiAgQHBhcmFtIHtmdW5jdGlvbn0gY2FsbGJhY2sgQ2FsbGJhY2sgd2hlbiB0aGUgdXJsIGhhcyBiZWVuIGxhb2RlZAoJKiAgQHBhcmFtIHtzdHJpbmd9IGJhc2VVcmwgQSBiYXNlIHVybCB0byBwcmVwZW5kIGFsbCBsaW5lcyBvZiB0aGUgZmlsZQoJKi8KCXAuYWRkVmVyc2lvbnNGaWxlID0gZnVuY3Rpb24odXJsLCBjYWxsYmFjaywgYmFzZVVybCkKCXsJCQoJCURlYnVnLmFzc2VydCgvXi4qXC50eHQkLy50ZXN0KHVybCksICJUaGUgdmVyc2lvbnMgZmlsZSBtdXN0IGJlIGEgKi50eHQgZmlsZSIpOwoJCQkJCgkJdmFyIG1sID0gY2xvdWRraWQuTWVkaWFMb2FkZXIuaW5zdGFuY2U7CgkJCgkJLy8gSWYgd2UgYWxyZWFkeSBjYWNoZSBidXN0aW5nLCB3ZSBjYW4gaWdub3JlIHRoaXMKCQlpZiAodGhpcy5jYWNoZUJ1c3QpCgkJewoJCQlpZiAoY2FsbGJhY2spIGNhbGxiYWNrKCk7CgkJCXJldHVybjsKCQl9CgkJCgkJLy8gQWRkIGEgcmFuZG9tIHZlcnNpb24gbnVtYmVyIHRvIG5ldmVyIGNhY2hlIHRoZSB0ZXh0IGZpbGUKCQl0aGlzLmFkZFZlcnNpb24odXJsLCBNYXRoLnJvdW5kKE1hdGgucmFuZG9tKCkqMTAwMDAwKSk7CgkJCgkJdmFyIGNtID0gdGhpczsKCQkKCQkvLyBMb2FkIHRoZSB2ZXJzaW9uCgkJbWwubG9hZCh1cmwsIAoJCQlmdW5jdGlvbihyZXN1bHQpCgkJCXsJCQkJCgkJCQkvLyBjaGVjayBmb3IgYSB2YWxpZCByZXN1bHQgY29udGVudAoJCQkJaWYgKHJlc3VsdCAmJiByZXN1bHQuY29udGVudCkKCQkJCXsKCQkJCQkvLyBSZW1vdmUgY2FycmFnZSByZXR1cm5zIGFuZCBzcGxpdCBvbiBuZXdsaW5lcwoJCQkJCXZhciBsaW5lcyA9IHJlc3VsdC5jb250ZW50LnJlcGxhY2UoL1xyL2csICcnKS5zcGxpdCgiXG4iKTsKCQkJCQl2YXIgaSwgcGFydHM7CgoJCQkJCS8vIEdvIGxpbmUgYnkgbGluZQoJCQkJCWZvcihpID0gMDsgaSA8IGxpbmVzLmxlbmd0aDsgaSsrKQoJCQkJCXsJCgkJCQkJCS8vIENoZWNrIGZvciBhIHZhbGlkIGxpbmUKCQkJCQkJaWYgKCFsaW5lc1tpXSkgY29udGludWU7CgoJCQkJCQkvLyBTcGxpdCBsaW5lcwoJCQkJCQlwYXJ0cyA9IGxpbmVzW2ldLnNwbGl0KCcgJyk7CgoJCQkJCQkvLyBBZGQgdGhlIHBhcnRzCgkJCQkJCWlmIChwYXJ0cy5sZW5ndGggIT0gMikgY29udGludWU7CgoJCQkJCQkvLyBBZGQgdGhlIHZlcnNpb25pbmcKCQkJCQkJY20uYWRkVmVyc2lvbigoYmFzZVVybCB8fCAiIikgKyBwYXJ0c1swXSwgcGFydHNbMV0pOwoJCQkJCX0KCQkJCX0KCQkJCWlmIChjYWxsYmFjaykgY2FsbGJhY2soKTsKCQkJfQoJCSk7Cgl9OwoJCgkvKioKCSogIEFkZCBhIHZlcnNpb24gbnVtYmVyIGZvciBhIGZpbGUKCSogIEBtZXRob2QgYWRkVmVyc2lvbgoJKiAgQHB1YmxpYwoJKiAgQHBhcmFtIHtzdHJpbmd9IHVybCBUaGUgdXJsIG9mIHRoZSBvYmplY3QKCSogIEBwYXJhbSB7c3RyaW5nfSB2ZXJzaW9uIFZlcnNpb24gbnVtYmVyIG9yIGhhcyBvZiBmaWxlCgkqLwoJcC5hZGRWZXJzaW9uID0gZnVuY3Rpb24odXJsLCB2ZXJzaW9uKQoJewoJCXZhciB2ZXIgPSB0aGlzLl9nZXRWZXJzaW9uQnlVcmwodXJsKTsKCQlpZiAoIXZlcikKCQkJdGhpcy5fdmVyc2lvbnMucHVzaCh7J3VybCc6IHVybCwgJ3ZlcnNpb24nOiB2ZXJzaW9ufSk7Cgl9OwoJCgkvKioKCSogIFNlYXJjaCBmb3IgYSB2ZXJzaW9uIG51bWJlciBieSB1cmwKCSogIEBtZXRob2QgX2dldFZlcnNpb25CeVVybAoJKiAgQHByaXZhdGUKCSogIEBwYXJhbSB7c3RyaW5nfSB1cmwgVGhlIHVybCB0byBzZWFyY2gKCSogIEByZXR1cm4ge3N0cmluZ30gVGhlIHZlcnNpb24gbnVtYmVyIGFzIGEgc3RyaW5nIG9yIG51bGwKCSovCglwLl9nZXRWZXJzaW9uQnlVcmwgPSBmdW5jdGlvbih1cmwpCgl7CgkJdmFyIGksIGxlbiA9IHRoaXMuX3ZlcnNpb25zLmxlbmd0aDsKCQlmb3IoaSA9IDA7IGkgPCBsZW47IGkrKykKCQl7CgkJCWlmICh1cmwgPT0gdGhpcy5fdmVyc2lvbnNbaV0udXJsKQoJCQl7CgkJCQlyZXR1cm4gdGhpcy5fdmVyc2lvbnNbaV07CgkJCX0KCQl9CgkJcmV0dXJuIG51bGw7Cgl9OwoJCgkvKioKCSogIFByZXBhcmUgYSBVUkwgd2l0aCB0aGUgbmVjZXNzYXJ5IGNhY2hlIGJ1c3RpbmcgYW5kL29yIHZlcnNpb25pbmcKCSogIGFzIHdlbGwgYXMgdGhlIGJhc2UgZGlyZWN0b3J5cgoJKiAgQHB1YmxpYwoJKiAgQG1ldGhvZCBwcmVwYXJlCgkqICBAcGFyYW0ge3N0cmluZ30gdXJsIFRoZSB1cmwgdG8gcHJlcGFyZQoJKiAgQHBhcmFtIHtib29sfSBhcHBseUJhc2VQYXRoIElmIHRoZSBnbG9iYWwgYmFzZSBwYXRoIHNob3VsZCBiZSBhcHBsaWVkIHRvIHRoZSB1cmwuIFRoaXMgZGVmYXVsdHMgdG8gZmFsc2UgYmVjYXVzZSBpdCBjYW4gCgkqCQkJCQkJCQlwb3RlbnRpYWxseSBpbnRlcmZlcmUgd2l0aCBsYXRlciByZWd1bGFyIGV4cHJlc3Npb24gY2hlY2tzLCBwYXJ0aWN1bGFybHkgd2l0aCBQcmVsb2FkSlMKCSogIEByZXR1cm4ge3N0cmluZ30gVGhlIGZpbmFsIHVybCB3aXRoIHZlcnNpb24vY2FjaGUgYW5kIGJhc2VQYXRoIGFkZGVkCgkqLwoJcC5wcmVwYXJlID0gZnVuY3Rpb24odXJsLCBhcHBseUJhc2VQYXRoKQoJewoJCXZhciB2ZXIgPSB0aGlzLl9nZXRWZXJzaW9uQnlVcmwodXJsKTsKCQkKCQlpZiAodGhpcy5jYWNoZUJ1c3QgJiYgLyhcP3xcJiljYlw9WzAtOV0qLy50ZXN0KHVybCkgPT09IGZhbHNlKQoJCXsKCQkJaWYoIXRoaXMuX2NiVmFsKQoJCQkJdGhpcy5fY2JWYWwgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKS50b1N0cmluZygpOwoJCQl1cmwgPSB1cmwgKyAodXJsLmluZGV4T2YoIj8iKSA8IDAgPyAiPyIgOiAiJiIpICsgImNiPSIgKyB0aGlzLl9jYlZhbDsKCQl9IAoJCWVsc2UgaWYgKHZlciAmJiAvKFw/fFwmKXZcPVswLTldKi8udGVzdCh1cmwpID09PSBmYWxzZSkKCQl7CgkJCXVybCA9IHVybCArICh1cmwuaW5kZXhPZigiPyIpIDwgMCA/ICI/IiA6ICImIikgKyAidj0iICsgdmVyLnZlcnNpb247CgkJfQoJCWlmKGFwcGx5QmFzZVBhdGgpCgkJewoJCQl2YXIgYmFzZVBhdGggPSBjbG91ZGtpZC5PUy5pbnN0YW5jZS5vcHRpb25zLmJhc2VQYXRoOwoJCQlpZiAoL15odHRwKHMpP1w6Ly50ZXN0KHVybCkgPT09IGZhbHNlICYmIGJhc2VQYXRoICE9PSB1bmRlZmluZWQgJiYgdXJsLnNlYXJjaChiYXNlUGF0aCkgPT0gLTEpCgkJCXsKCQkJCXVybCA9IGJhc2VQYXRoICsgdXJsOwoJCQl9CgkJfQoJCXJldHVybiB1cmw7Cgl9OwoJCgluYW1lc3BhY2UoJ2Nsb3Vka2lkJykuQ2FjaGVNYW5hZ2VyID0gQ2FjaGVNYW5hZ2VyOwoJCn0oKSk7Ci8qKgoqICBAbW9kdWxlIGNsb3Vka2lkCiovCihmdW5jdGlvbih1bmRlZmluZWQpIHsKCgkidXNlIHN0cmljdCI7CgkKCS8qKgoJKiAgQSBNdWx0aXB1cnBvc2UgYnV0dG9uIGNsYXNzLiBJdCBpcyBkZXNpZ25lZCB0byBoYXZlIG9uZSBpbWFnZSwgYW5kIGFuIG9wdGlvbmFsIHRleHQgbGFiZWwuCgkqICBUaGUgYnV0dG9uIGNhbiBiZSBhIG5vcm1hbCBidXR0b24gb3IgYSBzZWxlY3RhYmxlIGJ1dHRvbi4KCSogIFRoZSBidXR0b24gZnVuY3Rpb25zIHNpbWlsYXJseSB3aXRoIGJvdGggQ3JlYXRlSlMgYW5kIFBJWEksIGJ1dCBzbGlnaHRseSBkaWZmZXJlbnRseSBpbgoJKiAgaW5pdGlhbGl6YXRpb24gYW5kIGNhbGxiYWNrcy4gQWRkIGV2ZW50IGxpc3RlbmVycyBmb3IgY2xpY2sgYW5kIG1vdXNlb3ZlciB0byBrbm93IGFib3V0IAoJKiAgYnV0dG9uIGNsaWNrcyBhbmQgbW91c2Ugb3ZlcnMsIHJlc3BlY3RpdmVseS4KCSogCgkqICBAY2xhc3MgQnV0dG9uIChDcmVhdGVKUykKCSogIEBleHRlbmRzIGNyZWF0ZWpzLkNvbnRhaW5lcgoJKiAgQGNvbnN0cnVjdG9yCgkqICBAcGFyYW0ge09iamVjdHxJbWFnZXxIVE1MQ2FudmFzRWxlbWVudH0gW2ltYWdlU2V0dGluZ3NdIEluZm9ybWF0aW9uIGFib3V0IHRoZSBhcnQgdG8gYmUgdXNlZCBmb3IgYnV0dG9uIHN0YXRlcywgYXMgd2VsbCBhcyBpZiB0aGUgYnV0dG9uIGlzIHNlbGVjdGFibGUgb3Igbm90LgoJKiAgICAgICAgIElmIHRoaXMgaXMgYW4gSW1hZ2Ugb3IgQ2FudmFzIGVsZW1lbnQsIHRoZW4gdGhlIGJ1dHRvbiBhc3N1bWVzIHRoYXQgdGhlIGltYWdlIGlzIGZ1bGwgd2lkdGggYW5kIDMgaW1hZ2VzCgkqICAgICAgICAgdGFsbCwgaW4gdGhlIG9yZGVyICh0b3AgdG8gYm90dG9tKSB1cCwgb3ZlciwgZG93bi4gSWYgc28sIHRoZW4gdGhlIHByb3BlcnRpZXMgb2YgaW1hZ2VTZXR0aW5ncyBhcmUgaWdub3JlZC4KCSogIEBwYXJhbSB7SW1hZ2V8SFRNTENhbnZhc0VsZW1lbnR9IFtpbWFnZVNldHRpbmdzLmltYWdlXSBUaGUgaW1hZ2UgdG8gdXNlIGZvciBhbGwgb2YgdGhlIGJ1dHRvbiBzdGF0ZXMuCgkqICBAcGFyYW0ge0FycmF5fSBbaW1hZ2VTZXR0aW5ncy5wcmlvcml0eT1udWxsXSBUaGUgc3RhdGUgcHJpb3JpdHkgb3JkZXIuIElmIG9taXR0ZWQsIGRlZmF1bHRzIHRvIFsiZGlzYWJsZWQiLCAiZG93biIsICJvdmVyIiwgInVwIl0uCgkqICAgICAgICAgUHJldmlvdXMgdmVyc2lvbnMgb2YgQnV0dG9uIHVzZWQgYSBoYXJkIGNvZGVkIG9yZGVyOiBbImhpZ2hsaWdodGVkIiwgImRpc2FibGVkIiwgImRvd24iLCAib3ZlciIsICJzZWxlY3RlZCIsICJ1cCJdLgoJKiAgQHBhcmFtIHtPYmplY3R9IFtpbWFnZVNldHRpbmdzLnVwXSBUaGUgdmlzdWFsIGluZm9ybWF0aW9uIGFib3V0IHRoZSB1cCBzdGF0ZS4KCSogIEBwYXJhbSB7Y3JlYXRlanMuUmVjdGFuZ2xlfSBbaW1hZ2VTZXR0aW5ncy51cC5zcmNdIFRoZSBzb3VyY2VSZWN0IGZvciB0aGUgc3RhdGUgd2l0aGluIHRoZSBpbWFnZS4KCSogIEBwYXJhbSB7Y3JlYXRlanMuUmVjdGFuZ2xlfSBbaW1hZ2VTZXR0aW5ncy51cC50cmltPW51bGxdIFRyaW0gZGF0YSBhYm91dCB0aGUgc3RhdGUsIHdoZXJlIHggJiB5IGFyZSBob3cgbWFueSBwaXhlbHMgd2VyZSAKCSogICAgICAgICB0cmltbWVkIG9mZiB0aGUgbGVmdCBhbmQgcmlnaHQsIGFuZCBoZWlnaHQgJiB3aWR0aCBhcmUgdGhlIHVudHJpbW1lZCBzaXplIG9mIHRoZSBidXR0b24uCgkqICBAcGFyYW0ge09iamVjdH0gW2ltYWdlU2V0dGluZ3MudXAubGFiZWw9bnVsbF0gTGFiZWwgaW5mb3JtYXRpb24gc3BlY2lmaWMgdG8gdGhpcyBzdGF0ZS4gUHJvcGVydGllcyBvbiB0aGlzIHBhcmFtZXRlciBvdmVycmlkZSBkYXRhIAoJKiAgICAgICAgIGluIHRoZSBsYWJlbCBwYXJhbWV0ZXIgZm9yIHRoaXMgYnV0dG9uIHN0YXRlIG9ubHkuIEFsbCB2YWx1ZXMgZXhjZXB0ICJ0ZXh0IiBmcm9tIHRoZSBsYWJlbCBwYXJhbWV0ZXIgbWF5IGJlIG92ZXJyaWRkZW4uCgkqICBAcGFyYW0ge09iamVjdH0gW2ltYWdlU2V0dGluZ3Mub3Zlcj1udWxsXSBUaGUgdmlzdWFsIGluZm9ybWF0aW9uIGFib3V0IHRoZSBvdmVyIHN0YXRlLiBJZiBvbWl0dGVkLCB1c2VzIHRoZSB1cCBzdGF0ZS4KCSogIEBwYXJhbSB7Y3JlYXRlanMuUmVjdGFuZ2xlfSBbaW1hZ2VTZXR0aW5ncy5vdmVyLnNyY10gVGhlIHNvdXJjZVJlY3QgZm9yIHRoZSBzdGF0ZSB3aXRoaW4gdGhlIGltYWdlLgoJKiAgQHBhcmFtIHtjcmVhdGVqcy5SZWN0YW5nbGV9IFtpbWFnZVNldHRpbmdzLm92ZXIudHJpbT1udWxsXSBUcmltIGRhdGEgYWJvdXQgdGhlIHN0YXRlLCB3aGVyZSB4ICYgeSBhcmUgaG93IG1hbnkgcGl4ZWxzIHdlcmUgCgkqICAgICAgICAgdHJpbW1lZCBvZmYgdGhlIGxlZnQgYW5kIHJpZ2h0LCBhbmQgaGVpZ2h0ICYgd2lkdGggYXJlIHRoZSB1bnRyaW1tZWQgc2l6ZSBvZiB0aGUgYnV0dG9uLgoJKiAgQHBhcmFtIHtPYmplY3R9IFtpbWFnZVNldHRpbmdzLm92ZXIubGFiZWw9bnVsbF0gTGFiZWwgaW5mb3JtYXRpb24gc3BlY2lmaWMgdG8gdGhpcyBzdGF0ZS4gUHJvcGVydGllcyBvbiB0aGlzIHBhcmFtZXRlciBvdmVycmlkZSBkYXRhIAoJKiAgICAgICAgIGluIHRoZSBsYWJlbCBwYXJhbWV0ZXIgZm9yIHRoaXMgYnV0dG9uIHN0YXRlIG9ubHkuIEFsbCB2YWx1ZXMgZXhjZXB0ICJ0ZXh0IiBmcm9tIHRoZSBsYWJlbCBwYXJhbWV0ZXIgbWF5IGJlIG92ZXJyaWRkZW4uCgkqICBAcGFyYW0ge09iamVjdH0gW2ltYWdlU2V0dGluZ3MuZG93bj1udWxsXSBUaGUgdmlzdWFsIGluZm9ybWF0aW9uIGFib3V0IHRoZSBkb3duIHN0YXRlLiBJZiBvbWl0dGVkLCB1c2VzIHRoZSB1cCBzdGF0ZS4KCSogIEBwYXJhbSB7Y3JlYXRlanMuUmVjdGFuZ2xlfSBbaW1hZ2VTZXR0aW5ncy5kb3duLnNyY10gVGhlIHNvdXJjZVJlY3QgZm9yIHRoZSBzdGF0ZSB3aXRoaW4gdGhlIGltYWdlLgoJKiAgQHBhcmFtIHtjcmVhdGVqcy5SZWN0YW5nbGV9IFtpbWFnZVNldHRpbmdzLmRvd24udHJpbT1udWxsXSBUcmltIGRhdGEgYWJvdXQgdGhlIHN0YXRlLCB3aGVyZSB4ICYgeSBhcmUgaG93IG1hbnkgcGl4ZWxzIHdlcmUgCgkqICAgICAgICAgdHJpbW1lZCBvZmYgdGhlIGxlZnQgYW5kIHJpZ2h0LCBhbmQgaGVpZ2h0ICYgd2lkdGggYXJlIHRoZSB1bnRyaW1tZWQgc2l6ZSBvZiB0aGUgYnV0dG9uLgoJKiAgQHBhcmFtIHtPYmplY3R9IFtpbWFnZVNldHRpbmdzLmRvd24ubGFiZWw9bnVsbF0gTGFiZWwgaW5mb3JtYXRpb24gc3BlY2lmaWMgdG8gdGhpcyBzdGF0ZS4gUHJvcGVydGllcyBvbiB0aGlzIHBhcmFtZXRlciBvdmVycmlkZSBkYXRhIAoJKiAgICAgICAgIGluIHRoZSBsYWJlbCBwYXJhbWV0ZXIgZm9yIHRoaXMgYnV0dG9uIHN0YXRlIG9ubHkuIEFsbCB2YWx1ZXMgZXhjZXB0ICJ0ZXh0IiBmcm9tIHRoZSBsYWJlbCBwYXJhbWV0ZXIgbWF5IGJlIG92ZXJyaWRkZW4uCgkqICBAcGFyYW0ge09iamVjdH0gW2ltYWdlU2V0dGluZ3MuZGlzYWJsZWQ9bnVsbF0gVGhlIHZpc3VhbCBpbmZvcm1hdGlvbiBhYm91dCB0aGUgZGlzYWJsZWQgc3RhdGUuIElmIG9taXR0ZWQsIHVzZXMgdGhlIHVwIHN0YXRlLgoJKiAgQHBhcmFtIHtjcmVhdGVqcy5SZWN0YW5nbGV9IFtpbWFnZVNldHRpbmdzLmRpc2FibGVkLnNyY10gVGhlIHNvdXJjZVJlY3QgZm9yIHRoZSBzdGF0ZSB3aXRoaW4gdGhlIGltYWdlLgoJKiAgQHBhcmFtIHtjcmVhdGVqcy5SZWN0YW5nbGV9IFtpbWFnZVNldHRpbmdzLmRpc2FibGVkLnRyaW09bnVsbF0gVHJpbSBkYXRhIGFib3V0IHRoZSBzdGF0ZSwgd2hlcmUgeCAmIHkgYXJlIGhvdyBtYW55IHBpeGVscyB3ZXJlIAoJKiAgICAgICAgIHRyaW1tZWQgb2ZmIHRoZSBsZWZ0IGFuZCByaWdodCwgYW5kIGhlaWdodCAmIHdpZHRoIGFyZSB0aGUgdW50cmltbWVkIHNpemUgb2YgdGhlIGJ1dHRvbi4KCSogIEBwYXJhbSB7T2JqZWN0fSBbaW1hZ2VTZXR0aW5ncy5kaXNhYmxlZC5sYWJlbD1udWxsXSBMYWJlbCBpbmZvcm1hdGlvbiBzcGVjaWZpYyB0byB0aGlzIHN0YXRlLiBQcm9wZXJ0aWVzIG9uIHRoaXMgcGFyYW1ldGVyIG92ZXJyaWRlIAoJKiAgICAgICAgIGRhdGEgaW4gdGhlIGxhYmVsIHBhcmFtZXRlciBmb3IgdGhpcyBidXR0b24gc3RhdGUgb25seS4gQWxsIHZhbHVlcyBleGNlcHQgInRleHQiIGZyb20gdGhlIGxhYmVsIHBhcmFtZXRlciBtYXkgYmUgb3ZlcnJpZGRlbi4KCSogIEBwYXJhbSB7T2JqZWN0fSBbaW1hZ2VTZXR0aW5ncy48eW91ckN1c3RvbVN0YXRlPj1udWxsXSBUaGUgdmlzdWFsIGluZm9ybWF0aW9uIGFib3V0IGEgY3VzdG9tIHN0YXRlIGZvdW5kIGluIGltYWdlU2V0dGluZ3MucHJpb3JpdHkuCgkqICAgICAgICAgQW55IHN0YXRlIGFkZGVkIHRoaXMgd2F5IGhhcyBhIHByb3BlcnR5IG9mIHRoZSBzYW1lIG5hbWUgYWRkZWQgdG8gdGhlIGJ1dHRvbi4gRXhhbXBsZXMgb2YgcHJldmlvdXMgc3RhdGVzIHRoYXQgaGF2ZSBiZWVuCgkqICAgICAgICAgbW92ZWQgdG8gdGhpcyBzeXN0ZW0gYXJlICJzZWxlY3RlZCIgYW5kICJoaWdobGlnaHRlZCIuCgkqICBAcGFyYW0ge2NyZWF0ZWpzLlJlY3RhbmdsZX0gW2ltYWdlU2V0dGluZ3MuPHlvdXJDdXN0b21TdGF0ZT4uc3JjXSBUaGUgc291cmNlUmVjdCBmb3IgdGhlIHN0YXRlIHdpdGhpbiB0aGUgaW1hZ2UuCgkqICBAcGFyYW0ge2NyZWF0ZWpzLlJlY3RhbmdsZX0gW2ltYWdlU2V0dGluZ3MuPHlvdXJDdXN0b21TdGF0ZT4udHJpbT1udWxsXSBUcmltIGRhdGEgYWJvdXQgdGhlIHN0YXRlLCB3aGVyZSB4ICYgeSBhcmUgaG93IG1hbnkgcGl4ZWxzIAoJKiAgICAgICAgIHdlcmUgdHJpbW1lZCBvZmYgdGhlIGxlZnQgYW5kIHJpZ2h0LCBhbmQgaGVpZ2h0ICYgd2lkdGggYXJlIHRoZSB1bnRyaW1tZWQgc2l6ZSBvZiB0aGUgYnV0dG9uLgoJKiAgQHBhcmFtIHtPYmplY3R9IFtpbWFnZVNldHRpbmdzLjx5b3VyQ3VzdG9tU3RhdGU+LmxhYmVsPW51bGxdIExhYmVsIGluZm9ybWF0aW9uIHNwZWNpZmljIHRvIHRoaXMgc3RhdGUuIFByb3BlcnRpZXMgb24gdGhpcyBwYXJhbWV0ZXIgCgkqICAgICAgICAgb3ZlcnJpZGUgZGF0YSBpbiB0aGUgbGFiZWwgcGFyYW1ldGVyIGZvciB0aGlzIGJ1dHRvbiBzdGF0ZSBvbmx5LiBBbGwgdmFsdWVzIGV4Y2VwdCAidGV4dCIgZnJvbSB0aGUgbGFiZWwgcGFyYW1ldGVyIG1heSBiZQoJKiAgICAgICAgIG92ZXJyaWRkZW4uCgkqICBAcGFyYW0ge2NyZWF0ZWpzLlBvaW50fSBbaW1hZ2VTZXR0aW5ncy5vcmlnaW49bnVsbF0gQW4gb3B0aW9uYWwgb2Zmc2V0IGZvciBhbGwgYnV0dG9uIGdyYXBoaWNzLCBpbiBjYXNlIHlvdSB3YW50IGJ1dHRvbiAKCSogICAgICAgICBwb3NpdGlvbmluZyB0byBub3QgaW5jbHVkZSBhIGhpZ2hsaWdodCBnbG93LCBvciBhbnkgb3RoZXIgcmVhc29uIHlvdSB3b3VsZCB3YW50IHRvIG9mZnNldCB0aGUgYnV0dG9uIGFydCBhbmQgbGFiZWwuCgkqICBAcGFyYW0ge09iamVjdH0gW2xhYmVsPW51bGxdIEluZm9ybWF0aW9uIGFib3V0IHRoZSB0ZXh0IGxhYmVsIG9uIHRoZSBidXR0b24uIE9taXR0aW5nIHRoaXMgbWFrZXMgdGhlIGJ1dHRvbiBub3QgdXNlIGEgbGFiZWwuCgkqICBAcGFyYW0ge1N0cmluZ30gW2xhYmVsLnRleHRdIFRoZSB0ZXh0IHRvIGRpc3BsYXkgb24gdGhlIGxhYmVsLgoJKiAgQHBhcmFtIHtTdHJpbmd9IFtsYWJlbC5mb250XSBUaGUgZm9udCBuYW1lIGFuZCBzaXplIHRvIHVzZSBvbiB0aGUgbGFiZWwsIGFzIGNyZWF0ZWpzLlRleHQgZXhwZWN0cy4KCSogIEBwYXJhbSB7U3RyaW5nfSBbbGFiZWwuY29sb3JdIFRoZSBjb2xvciBvZiB0aGUgdGV4dCB0byB1c2Ugb24gdGhlIGxhYmVsLCBhcyBjcmVhdGVqcy5UZXh0IGV4cGVjdHMuCgkqICBAcGFyYW0ge1N0cmluZ30gW2xhYmVsLnRleHRCYXNlbGluZT0ibWlkZGxlIl0gVGhlIGJhc2VsaW5lIGZvciB0aGUgbGFiZWwgdGV4dCwgYXMgY3JlYXRlanMuVGV4dCBleHBlY3RzLgoJKiAgQHBhcmFtIHtPYmplY3R9IFtsYWJlbC5zdHJva2U9bnVsbF0gVGhlIHN0cm9rZSB0byB1c2UgZm9yIHRoZSBsYWJlbCB0ZXh0LCBpZiBkZXNpcmVkLCBhcyBjcmVhdGVqcy5UZXh0IChDbG91ZEtpZCBmb3JrIG9ubHkpIGV4cGVjdHMuCgkqICBAcGFyYW0ge2NyZWF0ZWpzLlNoYWRvd30gW2xhYmVsLnNoYWRvdz1udWxsXSBBIHNoYWRvdyBvYmplY3QgdG8gYXBwbHkgdG8gdGhlIGxhYmVsIHRleHQuCgkqICBAcGFyYW0ge1N0cmluZ3xOdW1iZXJ9IFtsYWJlbC54PSJjZW50ZXIiXSBBbiB4IHBvc2l0aW9uIHRvIHBsYWNlIHRoZSBsYWJlbCB0ZXh0IGF0IHJlbGF0aXZlIHRvIHRoZSBidXR0b24uIElmIG9taXR0ZWQsCgkqICAgICAgICAgImNlbnRlciIgaXMgdXNlZCwgd2hpY2ggYXR0ZW1wdHMgdG8gaG9yaXpvbnRhbGx5IGNlbnRlciB0aGUgbGFiZWwgb24gdGhlIGJ1dHRvbi4KCSogIEBwYXJhbSB7U3RyaW5nfE51bWJlcn0gW2xhYmVsLnk9ImNlbnRlciJdIEEgeSBwb3NpdGlvbiB0byBwbGFjZSB0aGUgbGFiZWwgdGV4dCBhdCByZWxhdGl2ZSB0byB0aGUgYnV0dG9uLiBJZiBvbWl0dGVkLAoJKiAgICAgICAgICJjZW50ZXIiIGlzIHVzZWQsIHdoaWNoIGF0dGVtcHRzIHRvIHZlcnRpY2FsbHkgY2VudGVyIHRoZSBsYWJlbCBvbiB0aGUgYnV0dG9uLiBUaGlzIG1heSBiZSB1bnJlbGlhYmxlIC0KCSogICAgICAgICBzZWUgZG9jdW1lbnRhdGlvbiBmb3IgY3JlYXRlanMuVGV4dC5nZXRNZWFzdXJlZExpbmVIZWlnaHQoKS4KCSogIEBwYXJhbSB7Qm9vbGVhbn0gW2VuYWJsZWQ9dHJ1ZV0gV2hldGhlciBvciBub3QgdGhlIGJ1dHRvbiBpcyBpbml0aWFsbHkgZW5hYmxlZC4KCSovCgl2YXIgQnV0dG9uID0gZnVuY3Rpb24oaW1hZ2VTZXR0aW5ncywgbGFiZWwsIGVuYWJsZWQpCgl7CgkJaWYoIWltYWdlU2V0dGluZ3MpIHJldHVybjsKCQl0aGlzLmluaXRpYWxpemUoaW1hZ2VTZXR0aW5ncywgbGFiZWwsIGVuYWJsZWQpOwoJfTsKCQoJLy8gRXh0ZW5kIENvbnRhaW5lcgoJdmFyIHAgPSBCdXR0b24ucHJvdG90eXBlID0gbmV3IGNyZWF0ZWpzLkNvbnRhaW5lcigpOwoJCgl2YXIgcyA9IGNyZWF0ZWpzLkNvbnRhaW5lci5wcm90b3R5cGU7Ly9zdXBlcgoJCgkvKioKCSogIFRoZSBzcHJpdGUgdGhhdCBpcyB0aGUgYm9keSBvZiB0aGUgYnV0dG9uLgoJKiAgVGhlIHR5cGUgb2YgdGhpcyBwcm9wZXJ0eSBpcyBkZXBlbmRlbnQgb24gd2hpY2ggdmVyc2lvbiBvZiB0aGUgT1MgbGlicmFyeSBpcyB1c2VkLgoJKiAgQHB1YmxpYwoJKiAgQHByb3BlcnR5IHtjcmVhdGVqcy5CaXRtYXB9IGJhY2sKCSogIEByZWFkT25seQoJKi8KCXAuYmFjayA9IG51bGw7CgoJLyoqCgkqICBUaGUgdGV4dCBmaWVsZCBvZiB0aGUgYnV0dG9uLiBUaGUgbGFiZWwgaXMgY2VudGVyZWQgYnkgYm90aCB3aWR0aCBhbmQgaGVpZ2h0IG9uIHRoZSBidXR0b24uCgkqICBUaGUgdHlwZSBvZiB0aGlzIHByb3BlcnR5IGlzIGRlcGVuZGVudCBvbiB3aGljaCB2ZXJzaW9uIG9mIHRoZSBPUyBsaWJyYXJ5IGlzIHVzZWQuCgkqICBAcHVibGljCgkqICBAcHJvcGVydHkge2NyZWF0ZWpzLlRleHR9IGxhYmVsCgkqICBAcmVhZE9ubHkKCSovCglwLmxhYmVsID0gbnVsbDsKCQoJLy89PT1jYWxsYmFja3MgZm9yIG1vdXNlL3RvdWNoIGV2ZW50cwoJLyoqCgkqIENhbGxiYWNrIGZvciBtb3VzZSBvdmVyLCBib3VuZCB0byB0aGlzIGJ1dHRvbi4KCSogQHByaXZhdGUKCSogQHByb3BlcnR5IHtGdW5jdGlvbn0gX292ZXJDQgoJKi8KCXAuX292ZXJDQiA9IG51bGw7CgoJLyoqCgkqIENhbGxiYWNrIGZvciBtb3VzZSBvdXQsIGJvdW5kIHRvIHRoaXMgYnV0dG9uLgoJKiBAcHJpdmF0ZQoJKiBAcHJvcGVydHkge0Z1bmN0aW9ufSBfb3V0Q0IKCSovCglwLl9vdXRDQiA9IG51bGw7CgoJLyoqCgkqIENhbGxiYWNrIGZvciBtb3VzZSBkb3duLCBib3VuZCB0byB0aGlzIGJ1dHRvbi4KCSogQHByaXZhdGUKCSogQHByb3BlcnR5IHtGdW5jdGlvbn0gX2Rvd25DQgoJKi8KCXAuX2Rvd25DQiA9IG51bGw7CgoJLyoqCgkqIENhbGxiYWNrIGZvciBwcmVzcyB1cCwgYm91bmQgdG8gdGhpcyBidXR0b24uCgkqIEBwcml2YXRlCgkqIEBwcm9wZXJ0eSB7RnVuY3Rpb259IF91cENCCgkqLwoJcC5fdXBDQiA9IG51bGw7CgoJLyoqCgkqIENhbGxiYWNrIGZvciBjbGljaywgYm91bmQgdG8gdGhpcyBidXR0b24uCgkqIEBwcml2YXRlCgkqIEBwcm9wZXJ0eSB7RnVuY3Rpb259IF9jbGlja0NCCgkqLwoJcC5fY2xpY2tDQiA9IG51bGw7CgkKCS8qKgoJKiBBIGRpY3Rpb25hcnkgb2Ygc3RhdGUgYm9vbGVhbnMsIGtleWVkIGJ5IHN0YXRlIG5hbWUuCgkqIEBwcml2YXRlCgkqIEBwcm9wZXJ0eSB7T2JqZWN0fSBfc3RhdGVGbGFncwoJKi8KCXAuX3N0YXRlRmxhZ3MgPSBudWxsOwoJLyoqCgkqIEFuIGFycmF5IG9mIHN0YXRlIG5hbWVzIChTdHJpbmdzKSwgaW4gdGhlaXIgb3JkZXIgb2YgcHJpb3JpdHkuCgkqIFRoZSBzdGFuZGFyZCBvcmRlciBwcmV2aW91c2x5IHdhcyBbImhpZ2hsaWdodGVkIiwgImRpc2FibGVkIiwgImRvd24iLCAib3ZlciIsICJzZWxlY3RlZCIsICJ1cCJdLgoJKiBAcHJpdmF0ZQoJKiBAcHJvcGVydHkge0FycmF5fSBfc3RhdGVQcmlvcml0eQoJKi8KCXAuX3N0YXRlUHJpb3JpdHkgPSBudWxsOwoJCgkvKioKCSogQSBkaWN0aW9uYXJ5IG9mIHN0YXRlIGdyYXBoaWMgZGF0YSwga2V5ZWQgYnkgc3RhdGUgbmFtZS4KCSogRWFjaCBvYmplY3QgY29udGFpbnMgdGhlIHNvdXJjZVJlY3QgKHNyYykgYW5kIG9wdGlvbmFsbHkgJ3RyaW0nLCBhbm90aGVyIFJlY3RhbmdsZS4KCSogQWRkaXRpb25hbGx5LCBlYWNoIG9iamVjdCB3aWxsIGNvbnRhaW4gYSAnbGFiZWwnIG9iamVjdCBpZiB0aGUgYnV0dG9uIGhhcyBhIHRleHQgbGFiZWwuCgkqIEBwcml2YXRlCgkqIEBwcm9wZXJ0eSB7T2JqZWN0fSBfc3RhdGVEYXRhCgkqLwoJcC5fc3RhdGVEYXRhID0gbnVsbDsKCgkvKioKCSogVGhlIHdpZHRoIG9mIHRoZSBidXR0b24gYXJ0LCBpbmRlcGVuZGVudCBvZiB0aGUgc2NhbGluZyBvZiB0aGUgYnV0dG9uIGl0c2VsZi4KCSogQHByaXZhdGUKCSogQHByb3BlcnR5IHtOdW1iZXJ9IF93aWR0aAoJKi8KCXAuX3dpZHRoID0gMDsKCgkvKioKCSogVGhlIGhlaWdodCBvZiB0aGUgYnV0dG9uIGFydCwgaW5kZXBlbmRlbnQgb2YgdGhlIHNjYWxpbmcgb2YgdGhlIGJ1dHRvbiBpdHNlbGYuCgkqIEBwcml2YXRlCgkqIEBwcm9wZXJ0eSB7TnVtYmVyfSBfaGVpZ2h0CgkqLwoJcC5faGVpZ2h0ID0gMDsKCgkvKioKCSogQW4gb2Zmc2V0IHRvIGJ1dHRvbiBwb3NpdGlvbmluZywgZ2VuZXJhbGx5IHVzZWQgdG8gYWRqdXN0IGZvciBhIGhpZ2hsaWdodCBhcm91bmQgdGhlIGJ1dHRvbi4KCSogQHByaXZhdGUKCSogQHByb3BlcnR5IHtjcmVhdGVqcy5Qb2ludH0gX29mZnNldAoJKi8KCXAuX29mZnNldCA9IG51bGw7CgkKCS8qKgoJKiBBbiBldmVudCBmb3Igd2hlbiB0aGUgYnV0dG9uIGlzIHByZXNzZWQgKHdoaWxlIGVuYWJsZWQpLgoJKiBAcHVibGljCgkqIEBzdGF0aWMKCSogQHByb3BlcnR5IHtTdHJpbmd9IEJVVFRPTl9QUkVTUwoJKi8KCUJ1dHRvbi5CVVRUT05fUFJFU1MgPSAiYnV0dG9uUHJlc3MiOwoJCgkvKgoJKiBBIGxpc3Qgb2Ygc3RhdGUgbmFtZXMgdGhhdCBzaG91bGQgbm90IGhhdmUgcHJvcGVydGllcyBhdXRvZ2VuZXJhdGVkLgoJKiBAcHJpdmF0ZQoJKiBAc3RhdGljCgkqIEBwcm9wZXJ0eSB7QXJyYXl9IFJFU0VSVkVEX1NUQVRFUwoJKi8KCXZhciBSRVNFUlZFRF9TVEFURVMgPSBbImRpc2FibGVkIiwgImVuYWJsZWQiLCAidXAiLCAib3ZlciIsICJkb3duIl07CgkvKgoJKiBBIHN0YXRlIHByaW9yaXR5IGxpc3QgdG8gdXNlIGFzIHRoZSBkZWZhdWx0LgoJKiBAcHJpdmF0ZQoJKiBAc3RhdGljCgkqIEBwcm9wZXJ0eSB7QXJyYXl9IERFRkFVTFRfUFJJT1JJVFkKCSovCgl2YXIgREVGQVVMVF9QUklPUklUWSA9IFsiZGlzYWJsZWQiLCAiZG93biIsICJvdmVyIiwgInVwIl07CgkKCS8qKiAKCSogIENvbnN0cnVjdG9yIGZvciB0aGUgYnV0dG9uIHdoZW4gdXNpbmcgQ3JlYXRlSlMuCgkqICBAbWV0aG9kIGluaXRpYWxpemUKCSogIEBwYXJhbSB7T2JqZWN0fEltYWdlfEhUTUxDYW52YXNFbGVtZW50fSBbaW1hZ2VTZXR0aW5nc10gU2VlIHRoZSBjb25zdHJ1Y3RvciBmb3IgbW9yZSBpbmZvcm1hdGlvbgoJKiAgQHBhcmFtIHtPYmplY3R9IFtsYWJlbD1udWxsXSBJbmZvcm1hdGlvbiBhYm91dCB0aGUgdGV4dCBsYWJlbCBvbiB0aGUgYnV0dG9uLiBPbWl0dGluZyB0aGlzIG1ha2VzIHRoZSBidXR0b24gbm90IHVzZSBhIGxhYmVsLgoJKiAgQHBhcmFtIHtCb29sZWFufSBbZW5hYmxlZD10cnVlXSBXaGV0aGVyIG9yIG5vdCB0aGUgYnV0dG9uIGlzIGluaXRpYWxseSBlbmFibGVkLgoJKi8KCXAuaW5pdGlhbGl6ZSA9IGZ1bmN0aW9uKGltYWdlU2V0dGluZ3MsIGxhYmVsLCBlbmFibGVkKQoJewoJCXMuaW5pdGlhbGl6ZS5jYWxsKHRoaXMpOwoKCQl0aGlzLm1vdXNlQ2hpbGRyZW4gPSBmYWxzZTsvL2lucHV0IGV2ZW50cyBzaG91bGQgaGF2ZSB0aGlzIGJ1dHRvbiBhcyBhIHRhcmdldCwgbm90IHRoZSBjaGlsZCBCaXRtYXAuCgkJCgkJdGhpcy5fZG93bkNCID0gdGhpcy5fb25Nb3VzZURvd24uYmluZCh0aGlzKTsKCQl0aGlzLl91cENCID0gdGhpcy5fb25Nb3VzZVVwLmJpbmQodGhpcyk7CgkJdGhpcy5fb3ZlckNCID0gdGhpcy5fb25Nb3VzZU92ZXIuYmluZCh0aGlzKTsKCQl0aGlzLl9vdXRDQiA9IHRoaXMuX29uTW91c2VPdXQuYmluZCh0aGlzKTsKCQl0aGlzLl9jbGlja0NCID0gdGhpcy5fb25DbGljay5iaW5kKHRoaXMpOwoJCQoJCXZhciBfc3RhdGVEYXRhID0gdGhpcy5fc3RhdGVEYXRhID0ge307CgkJdGhpcy5fc3RhdGVGbGFncyA9IHt9OwoJCXRoaXMuX29mZnNldCA9IG5ldyBjcmVhdGVqcy5Qb2ludCgpOwoJCQoJCS8vYSBjbG9uZSBvZiB0aGUgbGFiZWwgZGF0YSB0byB1c2UgYXMgYSBkZWZhdWx0IHZhbHVlLCB3aXRob3V0IGNoYW5naW5nIHRoZSBvcmlnaW5hbAoJCXZhciBsYWJlbERhdGE7CgkJaWYobGFiZWwpCgkJewoJCQlsYWJlbERhdGEgPSBjbG9uZShsYWJlbCk7CgkJCWRlbGV0ZSBsYWJlbERhdGEudGV4dDsKCQkJaWYobGFiZWxEYXRhLnggPT09IHVuZGVmaW5lZCkKCQkJCWxhYmVsRGF0YS54ID0gImNlbnRlciI7CgkJCWlmKGxhYmVsRGF0YS55ID09PSB1bmRlZmluZWQpCgkJCQlsYWJlbERhdGEueSA9ICJjZW50ZXIiOwoJCX0KCQkKCQl2YXIgaW1hZ2UsIHdpZHRoLCBoZWlnaHQsIGksIHN0YXRlOwoJCWlmKGltYWdlU2V0dGluZ3MuaW1hZ2UpLy9pcyBhIHNldHRpbmdzIG9iamVjdCB3aXRoIHJlY3RhbmdsZXMKCQl7CgkJCWltYWdlID0gaW1hZ2VTZXR0aW5ncy5pbWFnZTsKCQkJdGhpcy5fc3RhdGVQcmlvcml0eSA9IGltYWdlU2V0dGluZ3MucHJpb3JpdHkgfHwgREVGQVVMVF9QUklPUklUWTsKCQkJLy9lYWNoIHJlY3RzIG9iamVjdCBoYXMgYSBzcmMgcHJvcGVydHkgKGNyZWF0ZWpzLlJlY3RhbmdsZSksIGFuZCBvcHRpb25hbGx5IGEgdHJpbSByZWN0YW5nbGUKCQkJZm9yKGkgPSB0aGlzLl9zdGF0ZVByaW9yaXR5Lmxlbmd0aCAtIDE7IGkgPj0gMDsgLS1pKS8vc3RhcnQgYXQgdGhlIGVuZCB0byBzdGFydCBhdCB0aGUgdXAgc3RhdGUKCQkJewoJCQkJc3RhdGUgPSB0aGlzLl9zdGF0ZVByaW9yaXR5W2ldOwoJCQkJLy9zZXQgdXAgdGhlIHByb3BlcnR5IGZvciB0aGUgc3RhdGUgc28gaXQgY2FuIGJlIHNldCAtIHRoZSBmdW5jdGlvbiB3aWxsIGlnbm9yZSByZXNlcnZlZCBzdGF0ZXMKCQkJCXRoaXMuX2FkZFByb3BlcnR5KHN0YXRlKTsKCQkJCS8vc2V0IHRoZSBkZWZhdWx0IHZhbHVlIGZvciB0aGUgc3RhdGUgZmxhZwoJCQkJaWYoc3RhdGUgIT0gImRpc2FibGVkIiAmJiBzdGF0ZSAhPSAidXAiKQoJCQkJCXRoaXMuX3N0YXRlRmxhZ3Nbc3RhdGVdID0gZmFsc2U7CgkJCQl2YXIgaW5wdXREYXRhID0gaW1hZ2VTZXR0aW5nc1tzdGF0ZV07CgkJCQkvL2l0J3MgZXN0YWJsaXNoZWQgdGhhdCBvdmVyLCBkb3duLCBhbmQgcGFydGljdWxhcmx5IGRpc2FibGVkIGRlZmF1bHQgdG8gdGhlIHVwIHN0YXRlCgkJCQlfc3RhdGVEYXRhW3N0YXRlXSA9IGlucHV0RGF0YSA/IGNsb25lKGlucHV0RGF0YSkgOiBfc3RhdGVEYXRhLnVwOwoJCQkJLy9zZXQgdXAgdGhlIGxhYmVsIGluZm8gZm9yIHRoaXMgc3RhdGUKCQkJCWlmKGxhYmVsKQoJCQkJewoJCQkJCS8vaWYgdGhlcmUgaXMgYWN0dWFsIGxhYmVsIGRhdGEgZm9yIHRoaXMgc3RhdGUsIHVzZSB0aGF0CgkJCQkJaWYoaW5wdXREYXRhICYmIGlucHV0RGF0YS5sYWJlbCkKCQkJCQl7CgkJCQkJCWlucHV0RGF0YSA9IGlucHV0RGF0YS5sYWJlbDsKCQkJCQkJdmFyIHN0YXRlTGFiZWwgPSBfc3RhdGVEYXRhW3N0YXRlXS5sYWJlbCA9IHt9OwoJCQkJCQlzdGF0ZUxhYmVsLmZvbnQgPSBpbnB1dERhdGEuZm9udCB8fCBsYWJlbERhdGEuZm9udDsKCQkJCQkJc3RhdGVMYWJlbC5jb2xvciA9IGlucHV0RGF0YS5jb2xvciB8fCBsYWJlbERhdGEuY29sb3I7CgkJCQkJCXN0YXRlTGFiZWwuc3Ryb2tlID0gaW5wdXREYXRhLmhhc093blByb3BlcnR5KCJzdHJva2UiKSA/IGlucHV0RGF0YS5zdHJva2UgOiBsYWJlbERhdGEuc3Ryb2tlOwoJCQkJCQlzdGF0ZUxhYmVsLnNoYWRvdyA9IGlucHV0RGF0YS5oYXNPd25Qcm9wZXJ0eSgic2hhZG93IikgPyBpbnB1dERhdGEuc2hhZG93IDogbGFiZWxEYXRhLnNoYWRvdzsKCQkJCQkJc3RhdGVMYWJlbC50ZXh0QmFzZWxpbmUgPSBpbnB1dERhdGEudGV4dEJhc2VsaW5lIHx8IGxhYmVsRGF0YS50ZXh0QmFzZWxpbmU7CgkJCQkJCXN0YXRlTGFiZWwueCA9IGlucHV0RGF0YS54IHx8IGxhYmVsRGF0YS54OwoJCQkJCQlzdGF0ZUxhYmVsLnkgPSBpbnB1dERhdGEueSB8fCBsYWJlbERhdGEueTsKCQkJCQl9CgkJCQkJLy9vdGhlcndpc2UgdXNlIHRoZSBkZWZhdWx0CgkJCQkJZWxzZQoJCQkJCQlfc3RhdGVEYXRhW3N0YXRlXS5sYWJlbCA9IGxhYmVsRGF0YTsKCQkJCX0KCQkJfQoJCQlpZihfc3RhdGVEYXRhLnVwLnRyaW0pLy9pZiB0aGUgdGV4dHVyZSBpcyB0cmltbWVkLCB1c2UgdGhhdCBmb3IgdGhlIHNpemluZwoJCQl7CgkJCQl2YXIgdXBUcmltID0gX3N0YXRlRGF0YS51cC50cmltOwoJCQkJd2lkdGggPSB1cFRyaW0ud2lkdGg7CgkJCQloZWlnaHQgPSB1cFRyaW0uaGVpZ2h0OwoJCQl9CgkJCWVsc2UvL3RleHR1cmUgaXMgbm90IHRyaW1tZWQgYW5kIGlzIGZ1bGwgc2l6ZQoJCQl7CgkJCQl3aWR0aCA9IF9zdGF0ZURhdGEudXAuc3JjLndpZHRoOwoJCQkJaGVpZ2h0ID0gX3N0YXRlRGF0YS51cC5zcmMuaGVpZ2h0OwoJCQl9CgkJCS8vZW5zdXJlIHRoYXQgb3VyIHJlcXVpcmVkIHN0YXRlcyBleGlzdAoJCQlpZighX3N0YXRlRGF0YS51cCkKCQkJewoJCQkJRGVidWcuZXJyb3IoIkJ1dHRvbiBsYWNrcyBhbiB1cCBzdGF0ZSEgVGhpcyBpcyBhIHNlcmlvdXMgcHJvYmxlbSEgSW5wdXQgZGF0YSBmb2xsb3dzOiIpOwoJCQkJRGVidWcuZXJyb3IoaW1hZ2VTZXR0aW5ncyk7CgkJCX0KCQkJaWYoIV9zdGF0ZURhdGEub3ZlcikKCQkJCV9zdGF0ZURhdGEub3ZlciA9IF9zdGF0ZURhdGEudXA7CgkJCWlmKCFfc3RhdGVEYXRhLmRvd24pCgkJCQlfc3RhdGVEYXRhLmRvd24gPSBfc3RhdGVEYXRhLnVwOwoJCQlpZighX3N0YXRlRGF0YS5kaXNhYmxlZCkKCQkJCV9zdGF0ZURhdGEuZGlzYWJsZWQgPSBfc3RhdGVEYXRhLnVwOwoJCQkvL3NldCB1cCB0aGUgb2Zmc2V0CgkJCWlmKGltYWdlU2V0dGluZ3Mub2Zmc2V0KQoJCQl7CgkJCQl0aGlzLl9vZmZzZXQueCA9IGltYWdlU2V0dGluZ3Mub2Zmc2V0Lng7CgkJCQl0aGlzLl9vZmZzZXQueSA9IGltYWdlU2V0dGluZ3Mub2Zmc2V0Lnk7CgkJCX0KCQkJZWxzZQoJCQl7CgkJCQl0aGlzLl9vZmZzZXQueCA9IHRoaXMuX29mZnNldC55ID0gMDsKCQkJfQoJCX0KCQllbHNlLy9pbWFnZVNldHRpbmdzIGlzIGp1c3QgYW4gaW1hZ2UgdG8gdXNlIGRpcmVjdGx5IC0gdXNlIHRoZSBvbGQgc3RhY2tlZCBpbWFnZXMgbWV0aG9kCgkJewoJCQlpbWFnZSA9IGltYWdlU2V0dGluZ3M7CgkJCXdpZHRoID0gaW1hZ2Uud2lkdGg7CgkJCWhlaWdodCA9IGltYWdlLmhlaWdodCAvIDM7CgkJCXRoaXMuX3N0YXRlUHJpb3JpdHkgPSBERUZBVUxUX1BSSU9SSVRZOwoJCQlfc3RhdGVEYXRhLmRpc2FibGVkID0gX3N0YXRlRGF0YS51cCA9IHtzcmM6bmV3IGNyZWF0ZWpzLlJlY3RhbmdsZSgwLCAwLCB3aWR0aCwgaGVpZ2h0KX07CgkJCV9zdGF0ZURhdGEub3ZlciA9IHtzcmM6bmV3IGNyZWF0ZWpzLlJlY3RhbmdsZSgwLCBoZWlnaHQsIHdpZHRoLCBoZWlnaHQpfTsKCQkJX3N0YXRlRGF0YS5kb3duID0ge3NyYzpuZXcgY3JlYXRlanMuUmVjdGFuZ2xlKDAsIGhlaWdodCAqIDIsIHdpZHRoLCBoZWlnaHQpfTsKCQkJaWYobGFiZWxEYXRhKQoJCQl7CgkJCQlfc3RhdGVEYXRhLnVwLmxhYmVsID0gCgkJCQlfc3RhdGVEYXRhLm92ZXIubGFiZWwgPSAKCQkJCV9zdGF0ZURhdGEuZG93bi5sYWJlbCA9IAoJCQkJX3N0YXRlRGF0YS5kaXNhYmxlZC5sYWJlbCA9IGxhYmVsRGF0YTsKCQkJfQoJCQl0aGlzLl9vZmZzZXQueCA9IHRoaXMuX29mZnNldC55ID0gMDsKCQl9CgkJCgkJdGhpcy5iYWNrID0gbmV3IGNyZWF0ZWpzLkJpdG1hcChpbWFnZSk7CgkJdGhpcy5hZGRDaGlsZCh0aGlzLmJhY2spOwoJCXRoaXMuX3dpZHRoID0gd2lkdGg7CgkJdGhpcy5faGVpZ2h0ID0gaGVpZ2h0OwoJCQoJCWlmKGxhYmVsKQoJCXsKCQkJdGhpcy5sYWJlbCA9IG5ldyBjcmVhdGVqcy5UZXh0KGxhYmVsLnRleHQgfHwgIiIsIF9zdGF0ZURhdGEudXAubGFiZWwuZm9udCwgX3N0YXRlRGF0YS51cC5sYWJlbC5jb2xvcik7CgkJCXRoaXMuYWRkQ2hpbGQodGhpcy5sYWJlbCk7CgkJfQoJCQoJCS8vc2V0IHRoZSBidXR0b24gc3RhdGUgaW5pdGlhbGx5CgkJdGhpcy5lbmFibGVkID0gZW5hYmxlZCA9PT0gdW5kZWZpbmVkID8gdHJ1ZSA6ICEhZW5hYmxlZDsKCX07CgkKCS8qCgkqICBBIHNpbXBsZSBmdW5jdGlvbiBmb3IgbWFraW5nIGEgc2hhbGxvdyBjb3B5IG9mIGFuIG9iamVjdC4KCSovCglmdW5jdGlvbiBjbG9uZShvYmopCgl7CgkJaWYgKCFvYmogfHwgIm9iamVjdCIgIT0gdHlwZW9mIG9iaikgcmV0dXJuIG51bGw7CgkJdmFyIGNvcHkgPSBvYmouY29uc3RydWN0b3IoKTsKCQlmb3IgKHZhciBhdHRyIGluIG9iaikgewoJCQlpZiAob2JqLmhhc093blByb3BlcnR5KGF0dHIpKSBjb3B5W2F0dHJdID0gb2JqW2F0dHJdOwoJCX0KCQlyZXR1cm4gY29weTsKCX0KCQoJLyoqCgkqICBUaGUgd2lkdGggb2YgdGhlIGJ1dHRvbiwgYmFzZWQgb24gdGhlIHdpZHRoIG9mIGJhY2suIFRoaXMgdmFsdWUgaXMgYWZmZWN0ZWQgYnkgc2NhbGUuCgkqICBAcHJvcGVydHkge051bWJlcn0gd2lkdGgKCSovCglPYmplY3QuZGVmaW5lUHJvcGVydHkocCwgIndpZHRoIiwgewoJCWdldDpmdW5jdGlvbigpe3JldHVybiB0aGlzLl93aWR0aCAqIHRoaXMuc2NhbGVYO30sCgkJc2V0OmZ1bmN0aW9uKHZhbHVlKXsKCQkJdGhpcy5zY2FsZVggPSB2YWx1ZSAvIHRoaXMuX3dpZHRoOwoJCX0KCX0pOwoKCS8qKgoJKiAgVGhlIGhlaWdodCBvZiB0aGUgYnV0dG9uLCBiYXNlZCBvbiB0aGUgaGVpZ2h0IG9mIGJhY2suIFRoaXMgdmFsdWUgaXMgYWZmZWN0ZWQgYnkgc2NhbGUuCgkqICBAcHJvcGVydHkge051bWJlcn0gaGVpZ2h0CgkqLwoJT2JqZWN0LmRlZmluZVByb3BlcnR5KHAsICJoZWlnaHQiLCB7CgkJZ2V0OmZ1bmN0aW9uKCl7cmV0dXJuIHRoaXMuX2hlaWdodCAqIHRoaXMuc2NhbGVZO30sCgkJc2V0OmZ1bmN0aW9uKHZhbHVlKXsKCQkJdGhpcy5zY2FsZVkgPSB2YWx1ZSAvIHRoaXMuX2hlaWdodDsKCQl9Cgl9KTsKCQoJLyoqCgkqICBTZXRzIHRoZSB0ZXh0IG9mIHRoZSBsYWJlbC4gVGhpcyBkb2VzIG5vdGhpbmcgaWYgdGhlIGJ1dHRvbiB3YXMgbm90IGluaXRpYWxpemVkIHdpdGggYSBsYWJlbC4KCSogIEBwdWJsaWMKCSogIEBtZXRob2Qgc2V0VGV4dAoJKiAgQHBhcmFtIHtTdHJpbmd9IHRleHQgVGhlIHRleHQgdG8gc2V0IHRoZSBsYWJlbCB0by4KCSovCglwLnNldFRleHQgPSBmdW5jdGlvbih0ZXh0KQoJewoJCWlmKHRoaXMubGFiZWwpCgkJewoJCQl0aGlzLmxhYmVsLnRleHQgPSB0ZXh0OwoJCQl2YXIgZGF0YTsKCQkJZm9yKHZhciBpID0gMDsgaSA8IHRoaXMuX3N0YXRlUHJpb3JpdHkubGVuZ3RoOyArK2kpCgkJCXsKCQkJCWlmKHRoaXMuX3N0YXRlRmxhZ3NbdGhpcy5fc3RhdGVQcmlvcml0eVtpXV0pCgkJCQl7CgkJCQkJZGF0YSA9IHRoaXMuX3N0YXRlRGF0YVt0aGlzLl9zdGF0ZVByaW9yaXR5W2ldXTsKCQkJCQlicmVhazsKCQkJCX0KCQkJfQoJCQlpZighZGF0YSkKCQkJCWRhdGEgPSB0aGlzLl9zdGF0ZURhdGEudXA7CgkJCWRhdGEgPSBkYXRhLmxhYmVsOwoJCQlpZihkYXRhLnggPT0gImNlbnRlciIpCgkJCQl0aGlzLmxhYmVsLnggPSAodGhpcy5fd2lkdGggLSB0aGlzLmxhYmVsLmdldE1lYXN1cmVkV2lkdGgoKSkgKiAwLjUgKyB0aGlzLl9vZmZzZXQueDsKCQkJZWxzZQoJCQkJdGhpcy5sYWJlbC54ID0gZGF0YS54ICsgdGhpcy5fb2Zmc2V0Lng7CgkJCWlmKGRhdGEueSA9PSAiY2VudGVyIikKCQkJCXRoaXMubGFiZWwueSA9IHRoaXMuX2hlaWdodCAqIDAuNSArIHRoaXMuX29mZnNldC55OwoJCQllbHNlCgkJCQl0aGlzLmxhYmVsLnkgPSBkYXRhLnkgKyB0aGlzLl9vZmZzZXQueTsKCQl9Cgl9OwoJCgkvKioKCSogIFdoZXRoZXIgb3Igbm90IHRoZSBidXR0b24gaXMgZW5hYmxlZC4KCSogIEBwcm9wZXJ0eSB7Qm9vbGVhbn0gZW5hYmxlZAoJKiAgQGRlZmF1bHQgdHJ1ZQoJKi8KCU9iamVjdC5kZWZpbmVQcm9wZXJ0eShwLCAiZW5hYmxlZCIsIHsKCQlnZXQ6IGZ1bmN0aW9uKCkgeyByZXR1cm4gIXRoaXMuX3N0YXRlRmxhZ3MuZGlzYWJsZWQ7IH0sCgkJc2V0OiBmdW5jdGlvbih2YWx1ZSkKCQl7CgkJCXRoaXMuX3N0YXRlRmxhZ3MuZGlzYWJsZWQgPSAhdmFsdWU7CgkJCQoJCQlpZih2YWx1ZSkKCQkJewoJCQkJdGhpcy5jdXJzb3IgPSAncG9pbnRlcic7CgkJCQl0aGlzLmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlZG93bicsIHRoaXMuX2Rvd25DQik7CgkJCQl0aGlzLmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlb3ZlcicsIHRoaXMuX292ZXJDQik7CgkJCQl0aGlzLmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlb3V0JywgdGhpcy5fb3V0Q0IpOwoJCQl9CgkJCWVsc2UKCQkJewoJCQkJdGhpcy5jdXJzb3IgPSBudWxsOwoJCQkJdGhpcy5yZW1vdmVFdmVudExpc3RlbmVyKCdtb3VzZWRvd24nLCB0aGlzLl9kb3duQ0IpOwoJCQkJdGhpcy5yZW1vdmVFdmVudExpc3RlbmVyKCdtb3VzZW92ZXInLCB0aGlzLl9vdmVyQ0IpOwoJCQkJdGhpcy5yZW1vdmVFdmVudExpc3RlbmVyKCdtb3VzZW91dCcsIHRoaXMuX291dENCKTsKCQkJCXRoaXMucmVtb3ZlRXZlbnRMaXN0ZW5lcigncHJlc3N1cCcsIHRoaXMuX3VwQ0IpOwoJCQkJdGhpcy5yZW1vdmVFdmVudExpc3RlbmVyKCJjbGljayIsIHRoaXMuX2NsaWNrQ0IpOwoJCQkJdGhpcy5fc3RhdGVGbGFncy5kb3duID0gdGhpcy5fc3RhdGVGbGFncy5vdmVyID0gZmFsc2U7CgkJCX0KCQkJCgkJCXRoaXMuX3VwZGF0ZVN0YXRlKCk7CgkJfQoJfSk7CgkKCS8qKgoJKiAgQWRkcyBhIHByb3BlcnR5IHRvIHRoZSBidXR0b24uIFNldHRpbmcgdGhlIHByb3BlcnR5IHNldHMgdGhlIHZhbHVlIGluCgkqICBfc3RhdGVGbGFncyBhbmQgY2FsbHMgX3VwZGF0ZVN0YXRlKCkuCgkqICBAcHJpdmF0ZQoJKiAgQG1ldGhvZCBfYWRkUHJvcGVydHkKCSogIEBwYXJhbSB7U3RyaW5nfSBwcm9wZXJ0eU5hbWUgVGhlIHByb3BlcnR5IG5hbWUgdG8gYWRkIHRvIHRoZSBidXR0b24uCgkqLwoJcC5fYWRkUHJvcGVydHkgPSBmdW5jdGlvbihwcm9wZXJ0eU5hbWUpCgl7CgkJLy9jaGVjayB0byBtYWtlIHN1cmUgd2UgZG9uJ3QgYWRkIHJlc2VydmVkIG5hbWVzCgkJaWYoUkVTRVJWRURfU1RBVEVTLmluZGV4T2YocHJvcGVydHlOYW1lKSA+PSAwKSByZXR1cm47CgkJCgkJT2JqZWN0LmRlZmluZVByb3BlcnR5KHRoaXMsIHByb3BlcnR5TmFtZSwgewoJCQlnZXQ6IGZ1bmN0aW9uKCkgeyByZXR1cm4gdGhpcy5fc3RhdGVGbGFnc1twcm9wZXJ0eU5hbWVdOyB9LAoJCQlzZXQ6IGZ1bmN0aW9uKHZhbHVlKQoJCQl7CgkJCQl0aGlzLl9zdGF0ZUZsYWdzW3Byb3BlcnR5TmFtZV0gPSB2YWx1ZTsKCQkJCXRoaXMuX3VwZGF0ZVN0YXRlKCk7CgkJCX0KCQl9KTsKCX07CgkKCS8qKgoJKiAgVXBkYXRlcyBiYWNrIGJhc2VkIG9uIHRoZSBjdXJyZW50IGJ1dHRvbiBzdGF0ZS4KCSogIEBwcml2YXRlCgkqICBAbWV0aG9kIF91cGRhdGVTdGF0ZQoJKi8KCXAuX3VwZGF0ZVN0YXRlID0gZnVuY3Rpb24oKQoJewoJCWlmKCF0aGlzLmJhY2spIHJldHVybjsKCQl2YXIgZGF0YTsKCQkvL3VzZSB0aGUgaGlnaGVzdCBwcmlvcml0eSBzdGF0ZQoJCWZvcih2YXIgaSA9IDA7IGkgPCB0aGlzLl9zdGF0ZVByaW9yaXR5Lmxlbmd0aDsgKytpKQoJCXsKCQkJaWYodGhpcy5fc3RhdGVGbGFnc1t0aGlzLl9zdGF0ZVByaW9yaXR5W2ldXSkKCQkJewoJCQkJZGF0YSA9IHRoaXMuX3N0YXRlRGF0YVt0aGlzLl9zdGF0ZVByaW9yaXR5W2ldXTsKCQkJCWJyZWFrOwoJCQl9CgkJfQoJCS8vaWYgbm8gc3RhdGUgaXMgYWN0aXZlLCB1c2UgdGhlIHVwIHN0YXRlCgkJaWYoIWRhdGEpCgkJCWRhdGEgPSB0aGlzLl9zdGF0ZURhdGEudXA7CgkJdGhpcy5iYWNrLnNvdXJjZVJlY3QgPSBkYXRhLnNyYzsKCQkvL3Bvc2l0aW9uIHRoZSBidXR0b24gYmFjawoJCWlmKGRhdGEudHJpbSkKCQl7CgkJCXRoaXMuYmFjay54ID0gZGF0YS50cmltLnggKyB0aGlzLl9vZmZzZXQueDsKCQkJdGhpcy5iYWNrLnkgPSBkYXRhLnRyaW0ueSArIHRoaXMuX29mZnNldC55OwoJCX0KCQllbHNlCgkJewoJCQl0aGlzLmJhY2sueCA9IHRoaXMuX29mZnNldC54OwoJCQl0aGlzLmJhY2sueSA9IHRoaXMuX29mZnNldC55OwoJCX0KCQkvL2lmIHdlIGhhdmUgYSBsYWJlbCwgdXBkYXRlIHRoYXQgdG9vCgkJaWYodGhpcy5sYWJlbCkKCQl7CgkJCWRhdGEgPSBkYXRhLmxhYmVsOwoJCQkvL3VwZGF0ZSB0aGUgdGV4dCBwcm9wZXJ0aWVzCgkJCXRoaXMubGFiZWwudGV4dEJhc2VsaW5lID0gZGF0YS50ZXh0QmFzZWxpbmUgfHwgIm1pZGRsZSI7Ly9NaWRkbGUgaXMgZWFzeSB0byBjZW50ZXIKCQkJdGhpcy5sYWJlbC5zdHJva2UgPSBkYXRhLnN0cm9rZTsKCQkJdGhpcy5sYWJlbC5zaGFkb3cgPSBkYXRhLnNoYWRvdzsKCQkJdGhpcy5sYWJlbC5mb250ID0gZGF0YS5mb250OwoJCQl0aGlzLmxhYmVsLmNvbG9yID0gZGF0YS5jb2xvciB8fCAiIzAwMCI7Ly9kZWZhdWx0IGZvciBjcmVhdGVqcy5UZXh0CgkJCS8vcG9zaXRpb24gdGhlIHRleHQKCQkJaWYoZGF0YS54ID09ICJjZW50ZXIiKQoJCQkJdGhpcy5sYWJlbC54ID0gKHRoaXMuX3dpZHRoIC0gdGhpcy5sYWJlbC5nZXRNZWFzdXJlZFdpZHRoKCkpICogMC41ICsgdGhpcy5fb2Zmc2V0Lng7CgkJCWVsc2UKCQkJCXRoaXMubGFiZWwueCA9IGRhdGEueCArIHRoaXMuX29mZnNldC54OwoJCQlpZihkYXRhLnkgPT0gImNlbnRlciIpCgkJCQl0aGlzLmxhYmVsLnkgPSB0aGlzLl9oZWlnaHQgKiAwLjUgKyB0aGlzLl9vZmZzZXQueTsKCQkJZWxzZQoJCQkJdGhpcy5sYWJlbC55ID0gZGF0YS55ICsgdGhpcy5fb2Zmc2V0Lnk7CgkJfQoJfTsKCQoJLyoqCgkqICBUaGUgY2FsbGJhY2sgZm9yIHdoZW4gdGhlIGJ1dHRvbiByZWNlaXZlcyBhIG1vdXNlIGRvd24gZXZlbnQuCgkqICBAcHJpdmF0ZQoJKiAgQG1ldGhvZCBfb25Nb3VzZURvd24KCSovCglwLl9vbk1vdXNlRG93biA9IGZ1bmN0aW9uKGUpCgl7CgkJdGhpcy5hZGRFdmVudExpc3RlbmVyKCdwcmVzc3VwJywgdGhpcy5fdXBDQik7CgkJdGhpcy5hZGRFdmVudExpc3RlbmVyKCJjbGljayIsIHRoaXMuX2NsaWNrQ0IpOwoJCXRoaXMuX3N0YXRlRmxhZ3MuZG93biA9IHRydWU7CgkJdGhpcy5fdXBkYXRlU3RhdGUoKTsKCX07CgkKCS8qKgoJKiAgVGhlIGNhbGxiYWNrIGZvciB3aGVuIHRoZSBidXR0b24gZm9yIHdoZW4gdGhlIG1vdXNlL3RvdWNoIGlzIHJlbGVhc2VkIG9uIHRoZSBidXR0b24KCSogIC0gb25seSB3aGVuIHRoZSBidXR0b24gd2FzIGhlbGQgZG93biBpbml0aWFsbHkuCgkqICBAcHJpdmF0ZQoJKiAgQG1ldGhvZCBfb25Nb3VzZVVwCgkqLwoJcC5fb25Nb3VzZVVwID0gZnVuY3Rpb24oZSkKCXsKCQl0aGlzLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3ByZXNzdXAnLCB0aGlzLl91cENCKTsKCQl0aGlzLnJlbW92ZUV2ZW50TGlzdGVuZXIoImNsaWNrIiwgdGhpcy5fY2xpY2tDQik7CgkJdGhpcy5fc3RhdGVGbGFncy5kb3duID0gZmFsc2U7CgkJLy9pZiB0aGUgb3ZlciBmbGFnIGlzIHRydWUsIHRoZW4gdGhlIG1vdXNlIHdhcyByZWxlYXNlZCB3aGlsZSBvbiB0aGUgYnV0dG9uLCB0aHVzIGJlaW5nIGEgY2xpY2sKCQl0aGlzLl91cGRhdGVTdGF0ZSgpOwoJfTsKCgkvKioKCSogIFRoZSBjYWxsYmFjayBmb3Igd2hlbiB0aGUgYnV0dG9uIHRoZSBidXR0b24gaXMgY2xpY2tlZCBvciB0YXBwZWQgb24uIFRoaXMgaXMKCSogIHRoZSBtb3N0IHJlbGlhYmxlIHdheSBvZiBkZXRlY3RpbmcgbW91c2UgdXAvdG91Y2ggZW5kIGV2ZW50cyB0aGF0IGFyZSBvbiB0aGlzIGJ1dHRvbgoJKiAgd2hpbGUgbGV0dGluZyB0aGUgcHJlc3N1cCBldmVudCBoYW5kbGUgdGhlIG1vdXNlIHVwL3RvdWNoIGVuZHMgb24gYW5kIG91dHNpZGUgdGhlIGJ1dHRvbi4KCSogIEBwcml2YXRlCgkqICBAbWV0aG9kIF9vbkNsaWNrCgkqLwoJcC5fb25DbGljayA9IGZ1bmN0aW9uKGUpCgl7CgkJdGhpcy5kaXNwYXRjaEV2ZW50KG5ldyBjcmVhdGVqcy5FdmVudChCdXR0b24uQlVUVE9OX1BSRVNTKSk7Cgl9OwoJCgkvKioKCSogIFRoZSBjYWxsYmFjayBmb3Igd2hlbiB0aGUgYnV0dG9uIGlzIG1vdXNlZCBvdmVyLgoJKiAgQHByaXZhdGUKCSogIEBtZXRob2QgX29uTW91c2VPdmVyCgkqLwoJcC5fb25Nb3VzZU92ZXIgPSBmdW5jdGlvbihlKQoJewoJCXRoaXMuX3N0YXRlRmxhZ3Mub3ZlciA9IHRydWU7CgkJdGhpcy5fdXBkYXRlU3RhdGUoKTsKCX07CgkKCS8qKgoJKiAgVGhlIGNhbGxiYWNrIGZvciB3aGVuIHRoZSBtb3VzZSBsZWF2ZXMgdGhlIGJ1dHRvbiBhcmVhLgoJKiAgQHByaXZhdGUKCSogIEBtZXRob2QgX29uTW91c2VPdXQKCSovCglwLl9vbk1vdXNlT3V0ID0gZnVuY3Rpb24oZSkKCXsKCQl0aGlzLl9zdGF0ZUZsYWdzLm92ZXIgPSBmYWxzZTsKCQl0aGlzLl91cGRhdGVTdGF0ZSgpOwoJfTsKCQoJLyoqCgkqICBEZXN0cm95cyB0aGUgYnV0dG9uLgoJKiAgQHB1YmxpYwoJKiAgQG1ldGhvZCBkZXN0cm95CgkqLwoJcC5kZXN0cm95ID0gZnVuY3Rpb24oKQoJewoJCXRoaXMucmVtb3ZlQWxsQ2hpbGRyZW4oKTsKCQl0aGlzLnJlbW92ZUFsbEV2ZW50TGlzdGVuZXJzKCk7CgkJdGhpcy5fZG93bkNCID0gbnVsbDsKCQl0aGlzLl91cENCID0gbnVsbDsKCQl0aGlzLl9vdmVyQ0IgPSBudWxsOwoJCXRoaXMuX291dENCID0gbnVsbDsKCQl0aGlzLmJhY2sgPSBudWxsOwoJCXRoaXMubGFiZWwgPSBudWxsOwoJCXRoaXMuX3N0YXRlUHJpb3JpdHkgPSBudWxsOwoJCXRoaXMuX3N0YXRlRmxhZ3MgPSBudWxsOwoJCXRoaXMuX3N0YXRlRGF0YSA9IG51bGw7Cgl9OwoKCS8qKgoJKiAgR2VuZXJhdGVzIGEgZGVzYXR1cmF0ZWQgdXAgc3RhdGUgYXMgYSBkaXNhYmxlZCBzdGF0ZSwgYW5kIGFuIHVwZGF0ZSB3aXRoIGEgc29saWQgY29sb3JlZCBnbG93IGZvciBhIGhpZ2hsaWdodGVkIHN0YXRlLgoJKiAgQG1ldGhvZCBnZW5lcmF0ZURlZmF1bHRTdGF0ZXMKCSogIEBzdGF0aWMKCSogIEBwYXJhbSB7SW1hZ2V8SFRNTENhbnZhc0VsZW1lbnR9IGltYWdlIFRoZSBpbWFnZSB0byB1c2UgZm9yIGFsbCBvZiB0aGUgYnV0dG9uIHN0YXRlcywgaW4gdGhlIHN0YW5kYXJkIHVwL292ZXIvZG93biBmb3JtYXQuCgkqICBAcGFyYW0ge09iamVjdH0gW2Rpc2FibGVkU2V0dGluZ3NdIFRoZSBzZXR0aW5ncyBvYmplY3QgZm9yIHRoZSBkaXNhYmxlZCBzdGF0ZS4gSWYgb21pdHRlZCwgbm8gZGlzYWJsZWQgc3RhdGUgaXMgY3JlYXRlZC4KCSogIEBwYXJhbSB7TnVtYmVyfSBbZGlzYWJsZWRTZXR0aW5ncy5zYXR1cmF0aW9uXSBUaGUgc2F0dXJhdGlvbiBhZGp1c3RtZW50IGZvciB0aGUgZGlzYWJsZWQgc3RhdGUuIAoJKiAgICAgICAgIDEwMCBpcyBmdWxseSBzYXR1cmF0ZWQsIDAgaXMgdW5jaGFuZ2VkLCAtMTAwIGlzIGRlc2F0dXJhdGVkLgoJKiAgQHBhcmFtIHtOdW1iZXJ9IFtkaXNhYmxlZFNldHRpbmdzLmJyaWdodG5lc3NdIFRoZSBicmlnaHRuZXNzIGFkanVzdG1lbnQgZm9yIHRoZSBkaXNhYmxlZCBzdGF0ZS4gCgkqICAgICAgICAgMTAwIGlzIGZ1bGx5IGJyaWdodCwgMCBpcyB1bmNoYW5nZWQsIC0xMDAgaXMgY29tcGxldGVseSBkYXJrLgoJKiAgQHBhcmFtIHtOdW1iZXJ9IFtkaXNhYmxlZFNldHRpbmdzLmNvbnRyYXN0XSBUaGUgY29udHJhc3QgYWRqdXN0bWVudCBmb3IgdGhlIGRpc2FibGVkIHN0YXRlLiAKCSogICAgICAgICAxMDAgaXMgZnVsbCBjb250cmFzdCwgMCBpcyB1bmNoYW5nZWQsIC0xMDAgaXMgbm8gY29udHJhc3QuCgkqICBAcGFyYW0ge09iamVjdH0gW2hpZ2hsaWdodFNldHRpbmdzXSBUaGUgc2V0dGluZ3Mgb2JqZWN0IGZvciB0aGUgaGlnaGxpZ2h0IHN0YXRlLiBJZiBvbWl0dGVkLCBubyBzdGF0ZSBpcyBjcmVhdGVkLgoJKiAgQHBhcmFtIHtOdW1iZXJ9IFtoaWdobGlnaHRTZXR0aW5ncy5zaXplXSBIb3cgbWFueSBwaXhlbHMgdG8gbWFrZSB0aGUgZ2xvdywgZWcgOCBmb3IgYW4gOCBwaXhlbCBpbmNyZWFzZSBvbiBlYWNoIHNpZGUuCgkqICBAcGFyYW0ge051bWJlcn0gW2hpZ2hsaWdodFNldHRpbmdzLnJlZF0gVGhlIHJlZCB2YWx1ZSBmb3IgdGhlIGdsb3csIGZyb20gMCB0byAyNTUuCgkqICBAcGFyYW0ge051bWJlcn0gW2hpZ2hsaWdodFNldHRpbmdzLmdyZWVuXSBUaGUgZ3JlZW4gdmFsdWUgZm9yIHRoZSBnbG93LCBmcm9tIDAgdG8gMjU1LgoJKiAgQHBhcmFtIHtOdW1iZXJ9IFtoaWdobGlnaHRTZXR0aW5ncy5ibHVlXSBUaGUgYmx1ZSB2YWx1ZSBmb3IgdGhlIGdsb3csIGZyb20gMCB0byAyNTUuCgkqICBAcGFyYW0ge051bWJlcn0gW2hpZ2hsaWdodFNldHRpbmdzLmFscGhhXSBUaGUgYWxwaGEgdmFsdWUgZm9yIHRoZSBnbG93LCBmcm9tIDAgdG8gMjU1LCB3aXRoIDAgYmVpbmcgdHJhbnNwYXJlbnQgYW5kIDI1NSBmdWxseSBvcGFxdWUuCgkqLwoJQnV0dG9uLmdlbmVyYXRlRGVmYXVsdFN0YXRlcyA9IGZ1bmN0aW9uKGltYWdlLCBkaXNhYmxlZFNldHRpbmdzLCBoaWdobGlnaHRTZXR0aW5ncykKCXsKCQkvL2ZpZ3VyZSBvdXQgdGhlIG5vcm1hbCBidXR0b24gc2l6ZQoJCXZhciBidXR0b25XaWR0aCA9IGltYWdlLndpZHRoOwoJCXZhciBidXR0b25IZWlnaHQgPSBpbWFnZS5oZWlnaHQgLyAzOwoJCS8vY3JlYXRlIGEgY2FudmFzIGVsZW1lbnQgYW5kIHNpemUgaXQKCQl2YXIgY2FudmFzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiY2FudmFzIik7CgkJdmFyIHdpZHRoID0gYnV0dG9uV2lkdGg7CgkJdmFyIGhlaWdodCA9IGltYWdlLmhlaWdodDsKCQlpZihkaXNhYmxlZFNldHRpbmdzKQoJCXsKCQkJaGVpZ2h0ICs9IGJ1dHRvbkhlaWdodDsKCQl9CgkJaWYoaGlnaGxpZ2h0U2V0dGluZ3MpCgkJewoJCQl3aWR0aCArPSBoaWdobGlnaHRTZXR0aW5ncy5zaXplICogMjsKCQkJaGVpZ2h0ICs9IGJ1dHRvbkhlaWdodCArIGhpZ2hsaWdodFNldHRpbmdzLnNpemUgKiAyOwoJCX0KCQljYW52YXMud2lkdGggPSB3aWR0aDsKCQljYW52YXMuaGVpZ2h0ID0gaGVpZ2h0OwoJCS8vZ2V0IHRoZSBkcmF3aW5nIGNvbnRleHQKCQl2YXIgY29udGV4dCA9IGNhbnZhcy5nZXRDb250ZXh0KCIyZCIpOwoJCS8vZHJhdyB0aGUgaW1hZ2UgdG8gaXQKCQljb250ZXh0LmRyYXdJbWFnZShpbWFnZSwgMCwgMCk7CgkJLy9zdGFydCBzZXR0aW5nIHVwIHRoZSBvdXRwdXQKCQl2YXIgb3V0cHV0ID0gewoJCQlpbWFnZTogY2FudmFzLAoJCQl1cDp7IHNyYzpuZXcgY3JlYXRlanMuUmVjdGFuZ2xlKDAsIDAsIGJ1dHRvbldpZHRoLCBidXR0b25IZWlnaHQpIH0sCgkJCW92ZXI6eyBzcmM6bmV3IGNyZWF0ZWpzLlJlY3RhbmdsZSgwLCBidXR0b25IZWlnaHQsIGJ1dHRvbldpZHRoLCBidXR0b25IZWlnaHQpIH0sCgkJCWRvd246eyBzcmM6bmV3IGNyZWF0ZWpzLlJlY3RhbmdsZSgwLCBidXR0b25IZWlnaHQgKiAyLCBidXR0b25XaWR0aCwgYnV0dG9uSGVpZ2h0KSB9CgkJfTsKCQkvL3NldCB1cCBhIGJpdG1hcCB0byBkcmF3IG90aGVyIHN0YXRlcyB3aXRoCgkJdmFyIGRyYXdpbmdCaXRtYXAgPSBuZXcgY3JlYXRlanMuQml0bWFwKGltYWdlKTsKCQlkcmF3aW5nQml0bWFwLnNvdXJjZVJlY3QgPSBvdXRwdXQudXAuc3JjOwoJCS8vc2V0IHVwIGEgeSBwb3NpdGlvbiBmb3Igd2hlcmUgdGhlIG5leHQgc3RhdGUgc2hvdWxkIGdvIGluIHRoZSBjYW52YXMKCQl2YXIgbmV4dFkgPSBpbWFnZS5oZWlnaHQ7CgkJaWYoZGlzYWJsZWRTZXR0aW5ncykKCQl7CgkJCWNvbnRleHQuc2F2ZSgpOwoJCQkvL3Bvc2l0aW9uIHRoZSBidXR0b24gdG8gZHJhdwoJCQljb250ZXh0LnRyYW5zbGF0ZSgwLCBuZXh0WSk7CgkJCS8vc2V0IHVwIHRoZSBkZXNhdHVyYXRpb24gbWF0cml4CgkJCXZhciBtYXRyaXggPSBuZXcgY3JlYXRlanMuQ29sb3JNYXRyaXgoKTsKCQkJaWYoZGlzYWJsZWRTZXR0aW5ncy5zYXR1cmF0aW9uICE9PSB1bmRlZmluZWQpCgkJCQltYXRyaXguYWRqdXN0U2F0dXJhdGlvbihkaXNhYmxlZFNldHRpbmdzLnNhdHVyYXRpb24pOwoJCQlpZihkaXNhYmxlZFNldHRpbmdzLmJyaWdodG5lc3MgIT09IHVuZGVmaW5lZCkKCQkJCW1hdHJpeC5hZGp1c3RCcmlnaHRuZXNzKGRpc2FibGVkU2V0dGluZ3MuYnJpZ2h0bmVzcyAqIDIuNTUpOy8vY29udmVydCB0byBDcmVhdGVKUydzIC0yNTUtPjI1NSBzeXN0ZW0gZnJvbSAtMTAwLT4xMDAKCQkJaWYoZGlzYWJsZWRTZXR0aW5ncy5jb250cmFzdCAhPT0gdW5kZWZpbmVkKQoJCQkJbWF0cml4LmFkanVzdENvbnRyYXN0KGRpc2FibGVkU2V0dGluZ3MuY29udHJhc3QpOwoJCQlkcmF3aW5nQml0bWFwLmZpbHRlcnMgPSBbbmV3IGNyZWF0ZWpzLkNvbG9yTWF0cml4RmlsdGVyKG1hdHJpeCldOwoJCQkvL2RyYXcgdGhlIHN0YXRlCgkJCWRyYXdpbmdCaXRtYXAuY2FjaGUoMCwgMCwgb3V0cHV0LnVwLnNyYy53aWR0aCwgb3V0cHV0LnVwLnNyYy5oZWlnaHQpOwoJCQlkcmF3aW5nQml0bWFwLmRyYXcoY29udGV4dCk7CgkJCS8vdXBkYXRlIHRoZSBvdXRwdXQgd2l0aCB0aGUgc3RhdGUKCQkJb3V0cHV0LmRpc2FibGVkID0geyBzcmM6IG5ldyBjcmVhdGVqcy5SZWN0YW5nbGUoMCwgbmV4dFksIGJ1dHRvbldpZHRoLCBidXR0b25IZWlnaHQgfCAwKSB9OwoJCQluZXh0WSArPSBidXR0b25IZWlnaHQ7Ly9zZXQgdXAgdGhlIG5leHQgcG9zaXRpb24gZm9yIHRoZSBoaWdobGlnaHQgc3RhdGUsIGlmIHdlIGhhdmUgaXQKCQkJY29udGV4dC5yZXN0b3JlKCk7Ly9yZXNldCBhbnkgdHJhbnNmb3JtYXRpb25zCgkJfQoJCWlmKGhpZ2hsaWdodFNldHRpbmdzKQoJCXsKCQkJY29udGV4dC5zYXZlKCk7CgkJCS8vY2FsY3VsYXRlIHRoZSBzaXplIG9mIHRoaXMgc3RhdGUKCQkJdmFyIGhpZ2hsaWdodFN0YXRlV2lkdGggPSBidXR0b25XaWR0aCArIGhpZ2hsaWdodFNldHRpbmdzLnNpemUgKiAyOwoJCQl2YXIgaGlnaGxpZ2h0U3RhdGVIZWlnaHQgPSBidXR0b25IZWlnaHQgKyBoaWdobGlnaHRTZXR0aW5ncy5zaXplICogMjsKCQkJLy9zZXQgdXAgdGhlIGNvbG9yIGNoYW5naW5nIGZpbHRlcgoJCQlkcmF3aW5nQml0bWFwLmZpbHRlcnMgPSBbbmV3IGNyZWF0ZWpzLkNvbG9yRmlsdGVyKDAsMCwwLDEsIAoJCQkJLypyKi9oaWdobGlnaHRTZXR0aW5ncy5yZWQsIAoJCQkJLypnKi9oaWdobGlnaHRTZXR0aW5ncy5ncmVlbiwgCgkJCQkvKmIqL2hpZ2hsaWdodFNldHRpbmdzLmJsdWUsIAoJCQkJaGlnaGxpZ2h0U2V0dGluZ3MuYWxwaGEgIT09IHVuZGVmaW5lZCA/IC0yNTUgKyBoaWdobGlnaHRTZXR0aW5ncy5hbHBoYSA6IDApXTsKCQkJLy9zaXplIHRoZSBjb2xvcmVkIGhpZ2hsaWdodAoJCQlkcmF3aW5nQml0bWFwLnNjYWxlWCA9IChoaWdobGlnaHRTdGF0ZVdpZHRoKSAvIGJ1dHRvbldpZHRoOwoJCQlkcmF3aW5nQml0bWFwLnNjYWxlWSA9IChoaWdobGlnaHRTdGF0ZUhlaWdodCkgLyBidXR0b25IZWlnaHQ7CgkJCS8vcG9zaXRpb24gaXQKCQkJZHJhd2luZ0JpdG1hcC54ID0gMDsKCQkJZHJhd2luZ0JpdG1hcC55ID0gbmV4dFk7CgkJCS8vZHJhdyB0aGUgc3RhdGUKCQkJZHJhd2luZ0JpdG1hcC5jYWNoZSgwLCAwLCBoaWdobGlnaHRTdGF0ZVdpZHRoLCBoaWdobGlnaHRTdGF0ZUhlaWdodCk7CgkJCWRyYXdpbmdCaXRtYXAudXBkYXRlQ29udGV4dChjb250ZXh0KTsKCQkJZHJhd2luZ0JpdG1hcC5kcmF3KGNvbnRleHQpOwoJCQljb250ZXh0LnJlc3RvcmUoKTsvL3Jlc2V0IGFueSB0cmFuc2Zvcm1hdGlvbnMKCQkJLy9zaXplIGFuZCBwb3NpdGlvbiBpdCB0byBub3JtYWwKCQkJZHJhd2luZ0JpdG1hcC5zY2FsZVggPSBkcmF3aW5nQml0bWFwLnNjYWxlWSA9IDE7CgkJCWRyYXdpbmdCaXRtYXAueCA9IGhpZ2hsaWdodFNldHRpbmdzLnNpemU7CgkJCWRyYXdpbmdCaXRtYXAueSA9IG5leHRZICsgaGlnaGxpZ2h0U2V0dGluZ3Muc2l6ZTsKCQkJZHJhd2luZ0JpdG1hcC5maWx0ZXJzID0gbnVsbDsKCQkJZHJhd2luZ0JpdG1hcC51bmNhY2hlKCk7CgkJCS8vZHJhdyB0aGUgdXAgc3RhdGUgb3ZlciB0aGUgaGlnaGxpZ2h0IHN0YXRlIGdsb3cKCQkJZHJhd2luZ0JpdG1hcC51cGRhdGVDb250ZXh0KGNvbnRleHQpOwoJCQlkcmF3aW5nQml0bWFwLmRyYXcoY29udGV4dCk7CgkJCS8vc2V0IHVwIHRoZSB0cmltIHZhbHVlcyBmb3IgdGhlIG90aGVyIHN0YXRlcwoJCQl2YXIgdHJpbSA9IG5ldyBjcmVhdGVqcy5SZWN0YW5nbGUoCgkJCQloaWdobGlnaHRTZXR0aW5ncy5zaXplLCAKCQkJCWhpZ2hsaWdodFNldHRpbmdzLnNpemUsIAoJCQkJaGlnaGxpZ2h0U3RhdGVXaWR0aCwKCQkJCWhpZ2hsaWdodFN0YXRlSGVpZ2h0KTsKCQkJb3V0cHV0LnVwLnRyaW0gPSB0cmltOwoJCQlvdXRwdXQub3Zlci50cmltID0gdHJpbTsKCQkJb3V0cHV0LmRvd24udHJpbSA9IHRyaW07CgkJCWlmKG91dHB1dC5kaXNhYmxlZCkKCQkJCW91dHB1dC5kaXNhYmxlZC50cmltID0gdHJpbTsKCQkJLy9zZXQgdXAgdGhlIGhpZ2hsaWdodCBzdGF0ZSBmb3IgdGhlIGJ1dHRvbgoJCQlvdXRwdXQuaGlnaGxpZ2h0ZWQgPSB7CgkJCQlzcmM6bmV3IGNyZWF0ZWpzLlJlY3RhbmdsZSgwLCBuZXh0WSwgaGlnaGxpZ2h0U3RhdGVXaWR0aCB8IDAsIGhpZ2hsaWdodFN0YXRlSGVpZ2h0IHwgMCkKCQkJfTsKCQkJLy9zZXQgdXAgdGhlIHN0YXRlIHByaW9yaXR5IHRvIGluY2x1ZGUgdGhlIGhpZ2hsaWdodGVkIHN0YXRlCgkJCW91dHB1dC5wcmlvcml0eSA9IERFRkFVTFRfUFJJT1JJVFkuc2xpY2UoKTsKCQkJb3V0cHV0LnByaW9yaXR5LnVuc2hpZnQoImhpZ2hsaWdodGVkIik7CgkJCS8vYWRkIGluIGFuIG9mZnNldCB0byB0aGUgYnV0dG9uIHRvIGFjY291bnQgZm9yIHRoZSBoaWdobGlnaHQgZ2xvdyB3aXRob3V0IGFmZmVjdGluZyBidXR0b24gcG9zaXRpb25pbmcKCQkJb3V0cHV0Lm9mZnNldCA9IHt4OiAtaGlnaGxpZ2h0U2V0dGluZ3Muc2l6ZSwgeTogLWhpZ2hsaWdodFNldHRpbmdzLnNpemV9OwoJCX0KCQlyZXR1cm4gb3V0cHV0OwoJfTsKCgluYW1lc3BhY2UoJ2Nsb3Vka2lkJykuQnV0dG9uID0gQnV0dG9uOwp9KCkpOwovKioKKiAgQG1vZHVsZSBjbG91ZGtpZAoqLwooZnVuY3Rpb24oKSB7CgkKCSJ1c2Ugc3RyaWN0IjsKCQoJLyoqCgkqICBEcmFnIG1hbmFnZXIgaXMgcmVzcG9uc2libGUgZm9yIGhhbmRsaW5nIHRoZSBkcmFnZ2luZyBvZiBzdGFnZSBlbGVtZW50cy4KCSogIFN1cHBvcnRzIGNsaWNrLW4tc3RpY2sgKGNsaWNrIHRvIHN0YXJ0LCBtb3ZlIG1vdXNlLCBjbGljayB0byByZWxlYXNlKSBhbmQgY2xpY2stbi1kcmFnIChzdGFuZGFyZCBkcmFnZ2luZykgZnVuY3Rpb25hbGl0eS4KCSogIAoJKiAgQGNsYXNzIERyYWdNYW5hZ2VyIChDcmVhdGVKUykKCSogIEBjb25zdHJ1Y3RvcgoJKiAgQHBhcmFtIHtmdW5jdGlvbn0gc3RhcnRDYWxsYmFjayBUaGUgY2FsbGJhY2sgd2hlbiB3aGVuIHN0YXJ0aW5nCgkqICBAcGFyYW0ge2Z1bmN0aW9ufSBlbmRDYWxsYmFjayBUaGUgY2FsbGJhY2sgd2hlbiBlbmRpbmcKCSovCgl2YXIgRHJhZ01hbmFnZXIgPSBmdW5jdGlvbihzdGFydENhbGxiYWNrLCBlbmRDYWxsYmFjaykKCXsKCQl0aGlzLmluaXRpYWxpemUoc3RhcnRDYWxsYmFjaywgZW5kQ2FsbGJhY2spOwoJfTsKCQoJLyoqIFJlZmVyZW5jZSB0byB0aGUgZHJhZyBtYW5hZ2VyICovCgl2YXIgcCA9IERyYWdNYW5hZ2VyLnByb3RvdHlwZSA9IHt9OwoJCgkvKioKCSogVGhlIG9iamVjdCB0aGF0J3MgYmVpbmcgZHJhZ2dlZAoJKiBAcHVibGljCgkqIEByZWFkT25seQoJKiBAcHJvcGVydHkge2NyZWF0ZWpzLkRpc3BsYXlPYmplY3R9IGRyYWdnZWRPYmoKCSovCglwLmRyYWdnZWRPYmogPSBudWxsOwoJCgkvKioKCSogVGhlIHJhZGl1cyBpbiBwaXhlbCB0byBhbGxvdyBmb3IgZHJhZ2dpbmcsIG9yIGVsc2UgZG9lcyBzdGlja3kgY2xpY2sKCSogQHB1YmxpYwoJKiBAcHJvcGVydHkgZHJhZ1N0YXJ0VGhyZXNob2xkCgkqIEBkZWZhdWx0IDIwCgkqLwoJcC5kcmFnU3RhcnRUaHJlc2hvbGQgPSAyMDsKCQoJLyoqCgkqIFRoZSBwb3NpdGlvbiB4LCB5IG9mIHRoZSBtb3VzZSBkb3duIG9uIHRoZSBzdGFnZQoJKiBAcHJpdmF0ZQoJKiBAcHJvcGVydHkge29iamVjdH0gbW91c2VEb3duU3RhZ2VQb3MKCSovCglwLm1vdXNlRG93blN0YWdlUG9zID0gbnVsbDsKCgkvKioKCSogVGhlIHBvc2l0aW9uIHgsIHkgb2YgdGhlIG9iamVjdCB3aGVuIGludGVyYWN0aW9uIHdpdGggaXQgc3RhcnRlZC4KCSogQHByaXZhdGUKCSogQHByb3BlcnR5IHtvYmplY3R9IG1vdXNlRG93bk9ialBvcwoJKi8KCXAubW91c2VEb3duT2JqUG9zID0gbnVsbDsKCgkvKioKCSogSWYgc3RpY2t5IGNsaWNrIGRyYWdnaW5nIGlzIGFsbG93ZWQuCgkqIEBwdWJsaWMKCSogQHByb3BlcnR5IHtCb29sfSBhbGxvd1N0aWNreUNsaWNrCgkqIEBkZWZhdWx0IHRydWUKCSovCglwLmFsbG93U3RpY2t5Q2xpY2sgPSB0cnVlOwoJCgkvKioKCSogSXMgdGhlIG1vdmUgdG91Y2ggYmFzZWQKCSogQHB1YmxpYwoJKiBAcmVhZE9ubHkKCSogQHByb3BlcnR5IHtCb29sfSBpc1RvdWNoTW92ZQoJKiBAZGVmYXVsdCBmYWxzZQoJKi8KCXAuaXNUb3VjaE1vdmUgPSBmYWxzZTsKCQoJLyoqCgkqIElzIHRoZSBkcmFnIGJlaW5nIGhlbGQgb24gbW91c2UgZG93biAobm90IHN0aWNreSBjbGlja2luZykKCSogQHB1YmxpYwoJKiBAcmVhZE9ubHkKCSogQHByb3BlcnR5IHtCb29sfSBpc0hlbGREcmFnCgkqIEBkZWZhdWx0IGZhbHNlCgkqLwoJcC5pc0hlbGREcmFnID0gZmFsc2U7CgkKCS8qKgoJKiBJcyB0aGUgZHJhZyBhIHN0aWNreSBjbGlja2luZyAoY2xpY2sgb24gYSBpdGVtLCB0aGVuIG1vdXNlIHRoZSBtb3VzZSkKCSogQHB1YmxpYwoJKiBAcmVhZE9ubHkKCSogQHByb3BlcnR5IHtCb29sfSBpc1N0aWNreUNsaWNrCgkqIEBkZWZhdWx0IGZhbHNlCgkqLwoJcC5pc1N0aWNreUNsaWNrID0gZmFsc2U7CgoJLyoqCgkqIFNldHRpbmdzIGZvciBzbmFwcGluZy4KCSoKCSogIEZvcm1hdCBmb3Igc25hcHBpbmcgdG8gYSBsaXN0IG9mIHBvaW50czoKCSoJewoJKgkJbW9kZToicG9pbnRzIiwKCSoJCWRpc3Q6MjAsLy9zbmFwIHdoZW4gd2l0aGluIDIwIHBpeGVscy91bml0cwoJKgkJcG9pbnRzOlsKCSoJCQl7IHg6IDIwLCB5OjMwIH0sCgkqCQkJeyB4OiA1MCwgeToxMCB9CgkqCQldCgkqCX0KCSoKCSogQHB1YmxpYwoJKiBAcHJvcGVydHkge09iamVjdH0gc25hcFNldHRpbmdzCgkqIEBkZWZhdWx0IG51bGwKCSovCglwLnNuYXBTZXR0aW5ncyA9IG51bGw7CgkKCS8qKgoJKiBSZWZlcmVuY2UgdG8gdGhlIHN0YWdlCgkqIEBwcml2YXRlCgkqIEBwcm9wZXJ0eSB7Y3JlYXRlanNTdGFnZX0gX3RoZVN0YWdlCgkqLwoJcC5fdGhlU3RhZ2UgPSBudWxsOwoJCgkvKioKCSogVGhlIGxvY2FsIHRvIGdsb2JhbCBwb3NpdGlvbiBvZiB0aGUgZHJhZwoJKiBAcHJpdmF0ZQoJKiBAcHJvcGVydHkge2NyZWF0ZWpzLlBvaW50fSBfZHJhZ09mZnNldAoJKi8KCXAuX2RyYWdPZmZzZXQgPSBudWxsOwoJCgkvKioKCSogQ2FsbGJhY2sgd2hlbiB3ZSBzdGFydCBkcmFnZ2luZwoJKiBAcHJpdmF0ZQoJKiBAcHJvcGVydHkge0Z1bmN0aW9ufSBfZHJhZ1N0YXJ0Q2FsbGJhY2sKCSovCglwLl9kcmFnU3RhcnRDYWxsYmFjayA9IG51bGw7CgkKCS8qKgoJKiBDYWxsYmFjayB3aGVuIHdlIGFyZSBkb25lIGRyYWdnaW5nCgkqIEBwcml2YXRlCgkqIEBwcm9wZXJ0eSB7RnVuY3Rpb259IF9kcmFnRW5kQ2FsbGJhY2sKCSovCglwLl9kcmFnRW5kQ2FsbGJhY2sgPSBudWxsOwoJCgkvKioKCSogQ2FsbGJhY2sgdG8gdGVzdCBmb3IgdGhlIHN0YXJ0IGEgaGVsZCBkcmFnCgkqIEBwcml2YXRlCgkqIEBwcm9wZXJ0eSB7RnVuY3Rpb259IF90cmlnZ2VySGVsZERyYWdDYWxsYmFjawoJKi8KCXAuX3RyaWdnZXJIZWxkRHJhZ0NhbGxiYWNrID0gbnVsbDsKCQoJLyoqCgkqIENhbGxiYWNrIHRvIHN0YXJ0IGEgc3RpY2t5IGNsaWNrIGRyYWcKCSogQHByaXZhdGUKCSogQHByb3BlcnR5IHtGdW5jdGlvbn0gX3RyaWdnZXJTdGlja3lDbGlja0NhbGxiYWNrCgkqLwoJcC5fdHJpZ2dlclN0aWNreUNsaWNrQ2FsbGJhY2sgPSBudWxsOwoJCgkvKioKCSogQ2FsbGJhY2sgd2hlbiB3ZSBhcmUgZG9uZSB3aXRoIHRoZSBkcmFnCgkqIEBwcml2YXRlCgkqIEBwcm9wZXJ0eSB7RnVuY3Rpb259IF9zdGFnZU1vdXNlVXBDYWxsYmFjawoJKi8KCXAuX3N0YWdlTW91c2VVcENhbGxiYWNrID0gbnVsbDsKCQoJLyoqCgkqIFRoZSBjb2xsZWN0aW9uIG9mIGRyYWdnYWJsZSBvYmplY3RzCgkqIEBwcml2YXRlCgkqIEBwcm9wZXJ0eSB7QXJyYXl9IF9kcmFnZ2FibGVPYmplY3RzCgkqLwoJcC5fZHJhZ2dhYmxlT2JqZWN0cyA9IG51bGw7CgkJCgkvKioKCSogVGhlIGZ1bmN0aW9uIGNhbGwgd2hlbiB0aGUgbW91c2UvdG91Y2ggbW92ZXMKCSogQHByaXZhdGUKCSogQHByb3BlcnR5IHtmdW5jdGlvbn0gX3VwZGF0ZUNhbGxiYWNrIAoJKi8KCXAuX3VwZGF0ZUNhbGxiYWNrID0gbnVsbDsKCgkvKioKCSogQSBwb2ludCBmb3IgcmV1c2UgaW5zdGVhZCBvZiBsb3RzIG9mIG9iamVjdCBjcmVhdGlvbi4KCSogQHByaXZhdGUKCSogQHByb3BlcnR5IHtjcmVhdGVqcy5Qb2ludH0gX2hlbHBlclBvaW50IAoJKi8KCXAuX2hlbHBlclBvaW50ID0gbnVsbDsKCQoJLyoqIAoJKiBDb25zdHJ1Y3RvciAKCSogQG1ldGhvZCBpbml0aWFsaXplCgkqIEBjb25zdHJ1Y3RvcgoJKiBAcGFyYW0ge2Z1bmN0aW9ufSBzdGFydENhbGxiYWNrIFRoZSBjYWxsYmFjayB3aGVuIHdoZW4gc3RhcnRpbmcKCSogQHBhcmFtIHtmdW5jdGlvbn0gZW5kQ2FsbGJhY2sgVGhlIGNhbGxiYWNrIHdoZW4gZW5kaW5nCgkqLwoJcC5pbml0aWFsaXplID0gZnVuY3Rpb24oc3RhcnRDYWxsYmFjaywgZW5kQ2FsbGJhY2spCgl7CgkJdGhpcy5fdXBkYXRlQ2FsbGJhY2sgPSB0aGlzLl91cGRhdGVPYmpQb3NpdGlvbi5iaW5kKHRoaXMpOwoJCXRoaXMuX3RyaWdnZXJIZWxkRHJhZ0NhbGxiYWNrID0gdGhpcy5fdHJpZ2dlckhlbGREcmFnLmJpbmQodGhpcyk7CgkJdGhpcy5fdHJpZ2dlclN0aWNreUNsaWNrQ2FsbGJhY2sgPSB0aGlzLl90cmlnZ2VyU3RpY2t5Q2xpY2suYmluZCh0aGlzKTsKCQl0aGlzLl9zdGFnZU1vdXNlVXBDYWxsYmFjayA9IHRoaXMuX3N0b3BEcmFnLmJpbmQodGhpcyk7CgkJdGhpcy5fdGhlU3RhZ2UgPSBjbG91ZGtpZC5PUy5pbnN0YW5jZS5zdGFnZTsKCQl0aGlzLl9kcmFnU3RhcnRDYWxsYmFjayA9IHN0YXJ0Q2FsbGJhY2s7CgkJdGhpcy5fZHJhZ0VuZENhbGxiYWNrID0gZW5kQ2FsbGJhY2s7CgkJdGhpcy5fZHJhZ2dhYmxlT2JqZWN0cyA9IFtdOwoJCXRoaXMubW91c2VEb3duU3RhZ2VQb3MgPSB7eDowLCB5OjB9OwoJCXRoaXMubW91c2VEb3duT2JqUG9zID0ge3g6MCwgeTowfTsKCX07CgkKCS8qKgoJKglNYW51YWxseSBzdGFydHMgZHJhZ2dpbmcgYW4gb2JqZWN0LiBJZiBhIG1vdXNlIGRvd24gZXZlbnQgaXMgbm90IHN1cHBsaWVkIGFzIHRoZSBzZWNvbmQgYXJndW1lbnQsIGl0IAoJKiAgIGRlZmF1bHRzIHRvIGEgaGVsZCBkcmFnLCB0aGF0IGVuZHMgYXMgc29vbiBhcyB0aGUgbW91c2UgaXMgcmVsZWFzZWQuCgkqICBAbWV0aG9kIHN0YXJ0RHJhZwoJKiAgQHB1YmxpYwoJKiAgQHBhcmFtIHtjcmVhdGVqcy5EaXNwbGF5T2JqZWN0fSBvYmplY3QgVGhlIG9iamVjdCB0aGF0IHNob3VsZCBiZSBkcmFnZ2VkLgoJKiAgQHBhcmFtIHtjcmVhdGVqcy5Nb3VzZUV2ZW50fSBldiBBIG1vdXNlIGRvd24gZXZlbnQgdG8gbGlzdGVuIHRvIHRvIGRldGVybWluZSB3aGF0IHR5cGUgb2YgZHJhZyBzaG91bGQgYmUgdXNlZC4KCSovCglwLnN0YXJ0RHJhZyA9IGZ1bmN0aW9uKG9iamVjdCwgZXYpCgl7CgkJdGhpcy5fb2JqTW91c2VEb3duKGV2LCBvYmplY3QpOwoJfTsKCQoJLyoqCgkqIE1vdXNlIGRvd24gb24gYW4gb2JtZWN0CgkqICBAbWV0aG9kIF9vYmpNb3VzZURvd24KCSogIEBwcml2YXRlCgkqICBAcGFyYW0ge2NyZWF0ZWpzLk1vdXNlRXZlbnR9IGV2IEEgbW91c2UgZG93biBldmVudCB0byBsaXN0ZW4gdG8gdG8gZGV0ZXJtaW5lIHdoYXQgdHlwZSBvZiBkcmFnIHNob3VsZCBiZSB1c2VkLgoJKiAgQHBhcmFtIHtjcmVhdGVqcy5EaXNwbGF5T2JqZWN0fSBvYmplY3QgVGhlIG9iamVjdCB0aGF0IHNob3VsZCBiZSBkcmFnZ2VkLgoJKi8KCXAuX29iak1vdXNlRG93biA9IGZ1bmN0aW9uKGV2LCBvYmopCgl7CgkJLy8gaWYgd2UgYXJlIGRyYWdnaW5nIHNvbWV0aGluZywgdGhlbiBpZ25vcmUgYW55IG1vdXNlIGRvd25zCgkJLy8gdW50aWwgd2UgcmVsZWFzZSB0aGUgY3VycmVudGx5IGRyYWdnZWQgc3R1ZmYKCQlpZih0aGlzLmRyYWdnZWRPYmogIT09IG51bGwpIHJldHVybjsKCgkJdGhpcy5kcmFnZ2VkT2JqID0gb2JqOwoJCS8vc3RvcCBhbnkgYWN0aXZlIHR3ZWVucyBvbiB0aGUgb2JqZWN0LCBpbiBjYXNlIGl0IGlzIG1vdmluZyBhcm91bmQgb3Igc29tZXRoaW5nCgkJY3JlYXRlanMuVHdlZW4ucmVtb3ZlVHdlZW5zKG9iaik7CgkJCgkJLy9nZXQgdGhlIG1vdXNlIHBvc2l0aW9uIGluIGdsb2JhbCBzcGFjZSBhbmQgY29udmVydCBpdCB0byBwYXJlbnQgc3BhY2UKCQl0aGlzLl9kcmFnT2Zmc2V0ID0gdGhpcy5kcmFnZ2VkT2JqLnBhcmVudC5nbG9iYWxUb0xvY2FsKGV2ID8gZXYuc3RhZ2VYIDogMCwgZXYgPyBldi5zdGFnZVkgOiAwKTsKCQkKCQkvL21vdmUgdGhlIG9mZnNldCB0byByZXNwZWN0IHRoZSBvYmplY3QncyBjdXJyZW50IHBvc2l0aW9uCgkJdGhpcy5fZHJhZ09mZnNldC54IC09IG9iai54OwoJCXRoaXMuX2RyYWdPZmZzZXQueSAtPSBvYmoueTsKCgkJLy9zYXZlIHRoZSBwb3NpdGlvbiBvZiB0aGUgb2JqZWN0IGJlZm9yZSBkcmFnZ2luZyBiZWdhbiwgZm9yIGVhc3kgcmVzdG9yYXRpb24sIGlmIGRlc2lyZWQKCQl0aGlzLm1vdXNlRG93bk9ialBvcy54ID0gb2JqLng7CgkJdGhpcy5tb3VzZURvd25PYmpQb3MueSA9IG9iai55OwoJCQoJCWlmKCFldikvL2lmIHdlIGRvbid0IGdldCBhbiBldmVudCAobWFudWFsIGNhbGwgbmVnbGVjdGVkIHRvIHBhc3Mgb25lKSB0aGVuIGRlZmF1bHQgdG8gYSBoZWxkIGRyYWcKCQl7CgkJCXRoaXMuaXNIZWxkRHJhZyA9IHRydWU7CgkJCXRoaXMuX3N0YXJ0RHJhZygpOwoJCX0KCQllbHNlCgkJewoJCQkvL292ZXJyaWRlIHRoZSB0YXJnZXQgZm9yIHRoZSBtb3VzZWRvd24vdG91Y2hzdGFydCBldmVudCB0byBiZSB0aGlzIG9iamVjdCwgaW4gY2FzZSB3ZSBhcmUgZHJhZ2dpbmcgYSBjbG9uZWQgb2JqZWN0CgkJCXRoaXMuX3RoZVN0YWdlLl9nZXRQb2ludGVyRGF0YShldi5wb2ludGVySUQpLnRhcmdldCA9IG9iajsKCgkJCWlmKCF0aGlzLmFsbG93U3RpY2t5Q2xpY2sgfHwgZXYubmF0aXZlRXZlbnQudHlwZSA9PSAndG91Y2hzdGFydCcpLy9pZiBpdCBpcyBhIHRvdWNoIGV2ZW50LCBmb3JjZSBpdCB0byBiZSB0aGUgaGVsZCBkcmFnIHR5cGUKCQkJewoJCQkJdGhpcy5tb3VzZURvd25TdGFnZVBvcy54ID0gZXYuc3RhZ2VYOwoJCQkJdGhpcy5tb3VzZURvd25TdGFnZVBvcy55ID0gZXYuc3RhZ2VZOwoJCQkJdGhpcy5pc1RvdWNoTW92ZSA9IGV2Lm5hdGl2ZUV2ZW50LnR5cGUgPT0gJ3RvdWNoc3RhcnQnOwoJCQkJdGhpcy5pc0hlbGREcmFnID0gdHJ1ZTsKCQkJCXRoaXMuX3N0YXJ0RHJhZygpOwoJCQl9CgkJCWVsc2UvL290aGVyd2lzZSwgd2FpdCBmb3IgYSBtb3ZlbWVudCBvciBhIG1vdXNlIHVwIGluIG9yZGVyIHRvIGRvIGEgaGVsZCBkcmFnIG9yIGEgc3RpY2t5IGNsaWNrIGRyYWcKCQkJewoJCQkJdGhpcy5tb3VzZURvd25TdGFnZVBvcy54ID0gZXYuc3RhZ2VYOwoJCQkJdGhpcy5tb3VzZURvd25TdGFnZVBvcy55ID0gZXYuc3RhZ2VZOwoJCQkJb2JqLmFkZEV2ZW50TGlzdGVuZXIoInByZXNzbW92ZSIsIHRoaXMuX3RyaWdnZXJIZWxkRHJhZ0NhbGxiYWNrKTsKCQkJCW9iai5hZGRFdmVudExpc3RlbmVyKCJwcmVzc3VwIiwgdGhpcy5fdHJpZ2dlclN0aWNreUNsaWNrQ2FsbGJhY2spOwoJCQl9CgkJfQoJfTsKCQoJLyoqCgkqIFN0YXJ0IHRoZSBzdGlja3kgY2xpY2sKCSogQG1ldGhvZCBfdHJpZ2dlclN0aWNreUNsaWNrCgkqIEBwcml2YXRlCgkqLwoJcC5fdHJpZ2dlclN0aWNreUNsaWNrID0gZnVuY3Rpb24oKQoJewoJCXRoaXMuaXNTdGlja3lDbGljayA9IHRydWU7CgkJdGhpcy5kcmFnZ2VkT2JqLnJlbW92ZUV2ZW50TGlzdGVuZXIoInByZXNzbW92ZSIsIHRoaXMuX3RyaWdnZXJIZWxkRHJhZ0NhbGxiYWNrKTsKCQl0aGlzLmRyYWdnZWRPYmoucmVtb3ZlRXZlbnRMaXN0ZW5lcigicHJlc3N1cCIsIHRoaXMuX3RyaWdnZXJTdGlja3lDbGlja0NhbGxiYWNrKTsKCQl0aGlzLl9zdGFydERyYWcoKTsKCX07CgoJLyoqCgkqIFN0YXJ0IGhvbGQgZHJhZ2dpbmcKCSogQG1ldGhvZCBfdHJpZ2dlckhlbGREcmFnCgkqIEBwcml2YXRlCgkqIEBwYXJhbSB7Y3JlYXRlanMuTW91c2VFdmVudH0gZXYgVGhlIG1vdXNlIGRvd24gZXZlbnQKCSovCglwLl90cmlnZ2VySGVsZERyYWcgPSBmdW5jdGlvbihldikKCXsKCQl2YXIgeERpZmYgPSBldi5zdGFnZVggLSB0aGlzLm1vdXNlRG93blN0YWdlUG9zLng7CgkJdmFyIHlEaWZmID0gZXYuc3RhZ2VZIC0gdGhpcy5tb3VzZURvd25TdGFnZVBvcy55OwoJCWlmKHhEaWZmICogeERpZmYgKyB5RGlmZiAqIHlEaWZmID49IHRoaXMuZHJhZ1N0YXJ0VGhyZXNob2xkICogdGhpcy5kcmFnU3RhcnRUaHJlc2hvbGQpCgkJewoJCQl0aGlzLmlzSGVsZERyYWcgPSB0cnVlOwoJCQl0aGlzLmRyYWdnZWRPYmoucmVtb3ZlRXZlbnRMaXN0ZW5lcigicHJlc3Ntb3ZlIiwgdGhpcy5fdHJpZ2dlckhlbGREcmFnQ2FsbGJhY2spOwoJCQl0aGlzLmRyYWdnZWRPYmoucmVtb3ZlRXZlbnRMaXN0ZW5lcigicHJlc3N1cCIsIHRoaXMuX3RyaWdnZXJTdGlja3lDbGlja0NhbGxiYWNrKTsKCQkJdGhpcy5fc3RhcnREcmFnKCk7CgkJfQoJfTsKCgkvKioKCSogSW50ZXJuYWwgc3RhcnQgZHJhZ2dpbmcgb24gdGhlIHN0YWdlCgkqIEBtZXRob2QgX3N0YXJ0RHJhZwoJKiBAcHJpdmF0ZSAKCSovCglwLl9zdGFydERyYWcgPSBmdW5jdGlvbigpCgl7CgkJdmFyIHN0YWdlID0gdGhpcy5fdGhlU3RhZ2U7CgkJc3RhZ2UucmVtb3ZlRXZlbnRMaXN0ZW5lcigic3RhZ2Vtb3VzZW1vdmUiLCB0aGlzLl91cGRhdGVDYWxsYmFjayk7CgkJc3RhZ2UuYWRkRXZlbnRMaXN0ZW5lcigic3RhZ2Vtb3VzZW1vdmUiLCB0aGlzLl91cGRhdGVDYWxsYmFjayk7CgkJc3RhZ2UucmVtb3ZlRXZlbnRMaXN0ZW5lcigic3RhZ2Vtb3VzZXVwIiwgdGhpcy5fc3RhZ2VNb3VzZVVwQ2FsbGJhY2spOwoJCXN0YWdlLmFkZEV2ZW50TGlzdGVuZXIoInN0YWdlbW91c2V1cCIsIHRoaXMuX3N0YWdlTW91c2VVcENhbGxiYWNrKTsKCQkKCQl0aGlzLl9kcmFnU3RhcnRDYWxsYmFjayh0aGlzLmRyYWdnZWRPYmopOwoJfTsKCQoJLyoqCgkqIFN0b3BzIGRyYWdnaW5nIHRoZSBjdXJyZW50bHkgZHJhZ2dlZCBvYmplY3QuCgkqIEBwdWJsaWMKCSogQG1ldGhvZCBzdG9wRHJhZwoJKiBAcGFyYW0ge0Jvb2x9IGRvQ2FsbGJhY2sgSWYgdGhlIGRyYWcgZW5kIGNhbGxiYWNrIHNob3VsZCBiZSBjYWxsZWQuIERlZmF1bHQgaXMgZmFsc2UuCgkqLwoJcC5zdG9wRHJhZyA9IGZ1bmN0aW9uKGRvQ2FsbGJhY2spCgl7CgkJdGhpcy5fc3RvcERyYWcobnVsbCwgZG9DYWxsYmFjayA9PT0gdHJ1ZSk7Ly9wYXNzIHRydWUgaWYgaXQgd2FzIGV4cGxpY2l0bHkgcGFzc2VkIHRvIHVzLCBmYWxzZSBhbmQgdW5kZWZpbmVkIC0+IGZhbHNlCgl9OwoKCS8qKgoJKiBJbnRlcm5hbCBzdG9wIGRyYWdnaW5nIG9uIHRoZSBzdGFnZQoJKiBAbWV0aG9kIF9zdG9wRHJhZwoJKiBAcHJpdmF0ZSAKCSogQHBhcmFtIHtjcmVhdGVqcy5Nb3VzZUV2ZW50fSBldiBNb3VzZSB1cCBldmVudAoJKiBAcGFyYW0ge0Jvb2x9IGRvQ2FsbGJhY2sgSWYgd2Ugc2hvdWxkIGRvIHRoZSBjYWxsYmFjawoJKi8KCXAuX3N0b3BEcmFnID0gZnVuY3Rpb24oZXYsIGRvQ2FsbGJhY2spCgl7CgkJdmFyIG9iaiA9IHRoaXMuZHJhZ2dlZE9iajsKCQlvYmoucmVtb3ZlRXZlbnRMaXN0ZW5lcigicHJlc3Ntb3ZlIiwgdGhpcy5fdHJpZ2dlckhlbGREcmFnQ2FsbGJhY2spOwoJCW9iai5yZW1vdmVFdmVudExpc3RlbmVyKCJwcmVzc3VwIiwgdGhpcy5fdHJpZ2dlclN0aWNreUNsaWNrQ2FsbGJhY2spOwoJCXRoaXMuX3RoZVN0YWdlLnJlbW92ZUV2ZW50TGlzdGVuZXIoInN0YWdlbW91c2Vtb3ZlIiwgdGhpcy5fdXBkYXRlQ2FsbGJhY2spOwoJCXRoaXMuX3RoZVN0YWdlLnJlbW92ZUV2ZW50TGlzdGVuZXIoInN0YWdlbW91c2V1cCIsIHRoaXMuX3N0YWdlTW91c2VVcENhbGxiYWNrKTsKCQl0aGlzLmRyYWdnZWRPYmogPSBudWxsOwoJCXRoaXMuaXNUb3VjaE1vdmUgPSBmYWxzZTsKCQl0aGlzLmlzU3RpY2t5Q2xpY2sgPSBmYWxzZTsKCQl0aGlzLmlzSGVsZE1vdmUgPSBmYWxzZTsKCgkJaWYoZG9DYWxsYmFjayAhPT0gZmFsc2UpIC8vIHRydWUgb3IgdW5kZWZpbmVkCgkJCXRoaXMuX2RyYWdFbmRDYWxsYmFjayhvYmopOwoJfTsKCgkvKioKCSogVXBkYXRlIHRoZSBvYmplY3QgcG9zaXRpb24gYmFzZWQgb24gdGhlIG1vdXNlCgkqIEBtZXRob2QgX3VwZGF0ZU9ialBvc2l0aW9uCgkqIEBwcml2YXRlCgkqIEBwYXJhbSB7Y3JlYXRlanMuTW91c2VFdmVudH0gZSBNb3VzZSBtb3ZlIGV2ZW50CgkqLwoJcC5fdXBkYXRlT2JqUG9zaXRpb24gPSBmdW5jdGlvbihlKQoJewoJCWlmKCF0aGlzLmlzVG91Y2hNb3ZlICYmICF0aGlzLl90aGVTdGFnZS5tb3VzZUluQm91bmRzKSByZXR1cm47CgkJCgkJdmFyIGRyYWdnZWRPYmogPSB0aGlzLmRyYWdnZWRPYmo7CgkJdmFyIG1vdXNlUG9zID0gZHJhZ2dlZE9iai5wYXJlbnQuZ2xvYmFsVG9Mb2NhbChlLnN0YWdlWCwgZS5zdGFnZVksIHRoaXMuX2hlbHBlclBvaW50KTsKCQl2YXIgYm91bmRzID0gZHJhZ2dlZE9iai5fZHJhZ0JvdW5kczsKCQlkcmFnZ2VkT2JqLnggPSBjbGFtcChtb3VzZVBvcy54IC0gdGhpcy5fZHJhZ09mZnNldC54LCBib3VuZHMueCwgYm91bmRzLnJpZ2h0KTsKCQlkcmFnZ2VkT2JqLnkgPSBjbGFtcChtb3VzZVBvcy55IC0gdGhpcy5fZHJhZ09mZnNldC55LCBib3VuZHMueSwgYm91bmRzLmJvdHRvbSk7CgkJaWYodGhpcy5zbmFwU2V0dGluZ3MpCgkJewoJCQlzd2l0Y2godGhpcy5zbmFwU2V0dGluZ3MubW9kZSkKCQkJewoJCQkJY2FzZSAicG9pbnRzIjoKCQkJCQl0aGlzLl9oYW5kbGVQb2ludFNuYXAobW91c2VQb3MpOwoJCQkJCWJyZWFrOwoJCQkJY2FzZSAiZ3JpZCI6CgkJCQkJLy9ub3QgeWV0IGltcGxlbWVudGVkCgkJCQkJYnJlYWs7CgkJCQljYXNlICJsaW5lIjoKCQkJCQkvL25vdCB5ZXQgaW1wbGVtZW50ZWQKCQkJCQlicmVhazsKCQkJfQoJCX0KCX07CgoJLyoqCgkqIEhhbmRsZXMgc25hcHBpbmcgdGhlIGRyYWdnZWQgb2JqZWN0IHRvIHRoZSBuZWFyZXN0IGFtb25nIGEgbGlzdCBvZiBwb2ludHMKCSogQG1ldGhvZCBfaGFuZGxlUG9pbnRTbmFwCgkqIEBwcml2YXRlCgkqIEBwYXJhbSB7Y3JlYXRlanMuUG9pbnR9IGxvY2FsTW91c2VQb3MgVGhlIG1vdXNlIHBvc2l0aW9uIGluIHRoZSBzYW1lIHNwYWNlIGFzIHRoZSBkcmFnZ2VkIG9iamVjdC4KCSovCglwLl9oYW5kbGVQb2ludFNuYXAgPSBmdW5jdGlvbihsb2NhbE1vdXNlUG9zKQoJewoJCXZhciBzbmFwU2V0dGluZ3MgPSB0aGlzLnNuYXBTZXR0aW5nczsKCQl2YXIgbWluRGlzdFNxID0gc25hcFNldHRpbmdzLmRpc3QgKiBzbmFwU2V0dGluZ3MuZGlzdDsKCQl2YXIgcG9pbnRzID0gc25hcFNldHRpbmdzLnBvaW50czsKCQl2YXIgb2JqWCA9IGxvY2FsTW91c2VQb3MueCAtIHRoaXMuX2RyYWdPZmZzZXQueDsKCQl2YXIgb2JqWSA9IGxvY2FsTW91c2VQb3MueSAtIHRoaXMuX2RyYWdPZmZzZXQueTsKCQl2YXIgbGVhc3REaXN0ID0gLTE7CgkJdmFyIGNsb3Nlc3RQb2ludCA9IG51bGw7CgkJZm9yKHZhciBpID0gcG9pbnRzLmxlbmd0aCAtIDE7IGkgPj0gMDsgLS1pKQoJCXsKCQkJdmFyIHAgPSBwb2ludHNbaV07CgkJCXZhciBkaXN0U3EgPSBkaXN0U3F1YXJlZChvYmpYLCBvYmpZLCBwLngsIHAueSk7CgkJCWlmKGRpc3RTcSA8PSBtaW5EaXN0U3EgJiYgKGRpc3RTcSA8IGxlYXN0RGlzdCB8fCBsZWFzdERpc3QgPT0gLTEpKQoJCQl7CgkJCQlsZWFzdERpc3QgPSBkaXN0U3E7CgkJCQljbG9zZXN0UG9pbnQgPSBwOwoJCQl9CgkJfQoJCWlmKGNsb3Nlc3RQb2ludCkKCQl7CgkJCXRoaXMuZHJhZ2dlZE9iai54ID0gY2xvc2VzdFBvaW50Lng7CgkJCXRoaXMuZHJhZ2dlZE9iai55ID0gY2xvc2VzdFBvaW50Lnk7CgkJfQoJfTsKCgkvKgoJKiBTbWFsbCBkaXN0YW5jZSBzcXVhcmVkIGZ1bmN0aW9uCgkqLwoJdmFyIGRpc3RTcXVhcmVkID0gZnVuY3Rpb24oeDEsIHkxLCB4MiwgeTIpCgl7CgkJdmFyIHhEaWZmID0geDEgLSB4MjsKCQl2YXIgeURpZmYgPSB5MSAtIHkyOwoJCXJldHVybiB4RGlmZiAqIHhEaWZmICsgeURpZmYgKiB5RGlmZjsKCX07CgkKCS8qCgkqIFNpbXBsZSBjbGFtcCBmdW5jdGlvbgoJKi8KCXZhciBjbGFtcCA9IGZ1bmN0aW9uKHgsYSxiKQoJewoJCXJldHVybiAoeCA8IGEgPyBhIDogKHggPiBiID8gYiA6IHgpKTsKCX07CgkKCS8vPT09IEdpdmluZyBmdW5jdGlvbnMgYW5kIHByb3BlcnRpZXMgdG8gZHJhZ2dhYmxlIG9iamVjdHMgb2JqZWN0cwoJdmFyIGVuYWJsZURyYWcgPSBmdW5jdGlvbigpCgl7CgkJdGhpcy5hZGRFdmVudExpc3RlbmVyKCJtb3VzZWRvd24iLCB0aGlzLl9vbk1vdXNlRG93bkxpc3RlbmVyKTsKCQl0aGlzLmN1cnNvciA9ICJwb2ludGVyIjsKCX07CgkKCXZhciBkaXNhYmxlRHJhZyA9IGZ1bmN0aW9uKCkKCXsKCQl0aGlzLnJlbW92ZUV2ZW50TGlzdGVuZXIoIm1vdXNlZG93biIsIHRoaXMuX29uTW91c2VEb3duTGlzdGVuZXIpOwoJCXRoaXMuY3Vyc29yID0gbnVsbDsKCX07CgkKCXZhciBfb25Nb3VzZURvd24gPSBmdW5jdGlvbihldikKCXsKCQl0aGlzLl9kcmFnTWFuLl9vYmpNb3VzZURvd24oZXYsIHRoaXMpOwoJfTsKCQoJLyoqIAoJKiBBZGRzIHByb3BlcnRpZXMgYW5kIGZ1bmN0aW9ucyB0byB0aGUgb2JqZWN0IC0gdXNlIGVuYWJsZURyYWcoKSBhbmQgZGlzYWJsZURyYWcoKSBvbiAKCSogb2JqZWN0cyB0byBlbmFibGUvZGlzYWJsZSB0aGVtICh0aGV5IHN0YXJ0IG91dCBkaXNhYmxlZCkuIFByb3BlcnRpZXMgYWRkZWQgdG8gb2JqZWN0czoKCSogX2RyYWdCb3VuZHMgKFJlY3RhbmdsZSksIF9vbk1vdXNlRG93bkxpc3RlbmVyIChGdW5jdGlvbiksIF9kcmFnTWFuIChjbG91ZGtpZC5EcmFnTWFuYWdlcikgcmVmZXJlbmNlIHRvIHRoZSBEcmFnTWFuYWdlcgoJKiB0aGVzZSB3aWxsIG92ZXJyaWRlIGFueSBleGlzdGluZyBwcm9wZXJ0aWVzIG9mIHRoZSBzYW1lIG5hbWUKCSogQG1ldGhvZCBhZGRPYmplY3QKCSogQHB1YmxpYwoJKiBAcGFyYW0ge2NyZWF0ZWpzLkRpc3BsYXlPYmplY3R9IG9iaiBUaGUgZGlzcGxheSBvYmplY3QKCSogQHBhcmFtIHtjcmVhdGVqcy5SZWN0YW5nbGV9IGJvdW5kIFRoZSByZWN0YW5nbGUgYm91bmRzCgkqLwoJcC5hZGRPYmplY3QgPSBmdW5jdGlvbihvYmosIGJvdW5kcykKCXsKCQlpZighYm91bmRzKQoJCXsKCQkJYm91bmRzID0ge3g6MCwgeTowLCB3aWR0aDp0aGlzLl90aGVTdGFnZS5jYW52YXMud2lkdGgsIGhlaWdodDp0aGlzLl90aGVTdGFnZS5jYW52YXMuaGVpZ2h0fTsKCQl9CgkJYm91bmRzLnJpZ2h0ID0gYm91bmRzLnggKyBib3VuZHMud2lkdGg7CgkJYm91bmRzLmJvdHRvbSA9IGJvdW5kcy55ICsgYm91bmRzLmhlaWdodDsKCQlvYmouX2RyYWdCb3VuZHMgPSBib3VuZHM7CgkJaWYodGhpcy5fZHJhZ2dhYmxlT2JqZWN0cy5pbmRleE9mKG9iaikgPj0gMCkKCQl7CgkJCS8vZG9uJ3QgY2hhbmdlIGFueSBvZiB0aGUgZnVuY3Rpb25zIG9yIGFueXRoaW5nLCBqdXN0IHF1aXQgdGhlIGZ1bmN0aW9uIGFmdGVyIGhhdmluZyB1cGRhdGVkIHRoZSBib3VuZHMKCQkJcmV0dXJuOwoJCX0KCQlvYmouZW5hYmxlRHJhZyA9IGVuYWJsZURyYWc7CgkJb2JqLmRpc2FibGVEcmFnID0gZGlzYWJsZURyYWc7CgkJb2JqLl9vbk1vdXNlRG93bkxpc3RlbmVyID0gX29uTW91c2VEb3duLmJpbmQob2JqKTsKCQlvYmouX2RyYWdNYW4gPSB0aGlzOwoJCXRoaXMuX2RyYWdnYWJsZU9iamVjdHMucHVzaChvYmopOwoJfTsKCQoJLyoqIAoJKiBSZW1vdmVzIHByb3BlcnRpZXMgYW5kIGZ1bmN0aW9ucyBhZGRlZCBieSBhZGRPYmplY3QoKS4KCSogQHB1YmxpYwoJKiBAbWV0aG9kIHJlbW92ZU9iamVjdAoJKiBAcGFyYW0ge2NyZWF0ZWpzLkRpc3BsYXlPYmplY3R9IG9iaiBUaGUgZGlzcGxheSBvYmplY3QKCSovCglwLnJlbW92ZU9iamVjdCA9IGZ1bmN0aW9uKG9iaikKCXsKCQlvYmouZGlzYWJsZURyYWcoKTsKCQlkZWxldGUgb2JqLmVuYWJsZURyYWc7CgkJZGVsZXRlIG9iai5kaXNhYmxlRHJhZzsKCQlkZWxldGUgb2JqLl9vbk1vdXNlRG93bkxpc3RlbmVyOwoJCWRlbGV0ZSBvYmouX2RyYWdNYW47CgkJZGVsZXRlIG9iai5fZHJhZ0JvdW5kczsKCQl2YXIgaW5kZXggPSB0aGlzLl9kcmFnZ2FibGVPYmplY3RzLmluZGV4T2Yob2JqKTsKCQlpZihpbmRleCA+PSAwKQoJCQl0aGlzLl9kcmFnZ2FibGVPYmplY3RzLnNwbGljZShpbmRleCwgMSk7Cgl9OwoJCgkvKioKCSogIERlc3Ryb3kgdGhlIG1hbmFnZXIKCSogIEBwdWJsaWMKCSogIEBtZXRob2QgZGVzdHJveQoJKi8KCXAuZGVzdHJveSA9IGZ1bmN0aW9uKCkKCXsKCQlpZih0aGlzLmRyYWdnZWRPYmogIT09IG51bGwpCgkJewoJCQkvL2NsZWFuIHVwIGRyYWdnZWQgb2JqCgkJCXRoaXMuZHJhZ2dlZE9iai5yZW1vdmVFdmVudExpc3RlbmVyKCJwcmVzc21vdmUiLCB0aGlzLl90cmlnZ2VySGVsZERyYWdDYWxsYmFjayk7CgkJCXRoaXMuZHJhZ2dlZE9iai5yZW1vdmVFdmVudExpc3RlbmVyKCJwcmVzc3VwIiwgdGhpcy5fdHJpZ2dlclN0aWNreUNsaWNrQ2FsbGJhY2spOwoJCQl0aGlzLl90aGVTdGFnZS5yZW1vdmVFdmVudExpc3RlbmVyKCJzdGFnZW1vdXNlbW92ZSIsIHRoaXMuX3VwZGF0ZUNhbGxiYWNrKTsKCQkJdGhpcy5kcmFnZ2VkT2JqID0gbnVsbDsKCQl9CgkJdGhpcy5fdXBkYXRlQ2FsbGJhY2sgPSBudWxsOwoJCXRoaXMuX2RyYWdTdGFydENhbGxiYWNrID0gbnVsbDsKCQl0aGlzLl9kcmFnRW5kQ2FsbGJhY2sgPSBudWxsOwoJCXRoaXMuX3RyaWdnZXJIZWxkRHJhZ0NhbGxiYWNrID0gbnVsbDsKCQl0aGlzLl90cmlnZ2VyU3RpY2t5Q2xpY2tDYWxsYmFjayA9IG51bGw7CgkJdGhpcy5fc3RhZ2VNb3VzZVVwQ2FsbGJhY2sgPSBudWxsOwoJCXRoaXMuX3RoZVN0YWdlID0gbnVsbDsKCQlmb3IodmFyIGkgPSB0aGlzLl9kcmFnZ2FibGVPYmplY3RzLmxlbmd0aCAtIDE7IGkgPj0gMDsgLS1pKQoJCXsKCQkJdmFyIG9iaiA9IHRoaXMuX2RyYWdnYWJsZU9iamVjdHNbaV07CgkJCW9iai5kaXNhYmxlRHJhZygpOwoJCQlkZWxldGUgb2JqLmVuYWJsZURyYWc7CgkJCWRlbGV0ZSBvYmouZGlzYWJsZURyYWc7CgkJCWRlbGV0ZSBvYmouX29uTW91c2VEb3duTGlzdGVuZXI7CgkJCWRlbGV0ZSBvYmouX2RyYWdNYW47CgkJCWRlbGV0ZSBvYmouX2RyYWdCb3VuZHM7CgkJfQoJCXRoaXMuX2RyYWdnYWJsZU9iamVjdHMgPSBudWxsOwoJCXRoaXMuX2hlbHBlclBvaW50ID0gbnVsbDsKCX07CgkKCS8qKiBBc3NpZ24gdG8gdGhlIGdsb2JhbCBuYW1lc3BhY2UgKi8KCW5hbWVzcGFjZSgnY2xvdWRraWQnKS5EcmFnTWFuYWdlciA9IERyYWdNYW5hZ2VyOwp9KCkpOwooZnVuY3Rpb24oKSB7CgkKCSJ1c2Ugc3RyaWN0IjsKCQoJLyoqCgkqICBJbml0aWFsbHkgbGF5b3V0cyBhbGwgaW50ZXJmYWNlIGVsZW1lbnRzCgkqICBAbW9kdWxlIGNsb3Vka2lkCgkqICBAY2xhc3MgUG9zaXRpb25lcgoJKi8KCXZhciBQb3NpdGlvbmVyID0gZnVuY3Rpb24oKXt9OwoJCgkvLyBTZXQgdGhlIHByb3R5cGUKCVBvc2l0aW9uZXIucHJvdG90eXBlID0ge307CgkKCS8qKgoJKiAgSW5pdGlhbCBwb3NpdGlvbiBvZiBhbGwgbGF5b3V0IGl0ZW1zCgkqICBAbWV0aG9kIHBvc2l0aW9uSXRlbXMKCSogIEBzdGF0aWMKCSogIEBwYXJhbSB7Y3JlYXRlanMuRGlzcGxheU9iamVjdHxQSVhJLkRpc3BsYXlPYmplY3R9IHBhcmVudAoJKiAgQHBhcmFtIHtPYmplY3R9IGl0ZW1TZXR0aW5ncyBKU09OIGZvcm1hdCB3aXRoIHBvc2l0aW9uIGluZm9ybWF0aW9uCgkqLwoJUG9zaXRpb25lci5wb3NpdGlvbkl0ZW1zID0gZnVuY3Rpb24ocGFyZW50LCBpdGVtU2V0dGluZ3MpCgl7CgkJdmFyIHJvdCwgcHQsIGRlZ1RvUmFkOwoJCWlmKGZhbHNlKQoJCQlkZWdUb1JhZCA9IE1hdGguUEkgLyAxODA7CgkJZm9yKHZhciBpTmFtZSBpbiBpdGVtU2V0dGluZ3MpCgkJewoJCQl2YXIgaXRlbSA9IHBhcmVudFtpTmFtZV07CgkJCWlmKCFpdGVtKQoJCQl7CgkJCQlEZWJ1Zy5lcnJvcigiY291bGQgbm90IGZpbmQgb2JqZWN0ICciICsgIGlOYW1lICsgIiciKTsKCQkJCWNvbnRpbnVlOwoJCQl9CgkJCXZhciBzZXR0aW5nID0gaXRlbVNldHRpbmdzW2lOYW1lXTsKCQkJaWYoZmFsc2UpCgkJCXsKCQkJCWl0ZW0ucG9zaXRpb24ueCA9IHNldHRpbmcueDsKCQkJCWl0ZW0ucG9zaXRpb24ueSA9IHNldHRpbmcueTsKCQkJCXB0ID0gc2V0dGluZy5zY2FsZTsKCQkJCWlmKHB0KQoJCQkJewoJCQkJCWl0ZW0uc2NhbGUueCAqPSBwdC54OwoJCQkJCWl0ZW0uc2NhbGUueSAqPSBwdC55OwoJCQkJfQoJCQkJcHQgPSBzZXR0aW5nLnBpdm90OwoJCQkJaWYocHQpCgkJCQl7CgkJCQkJaXRlbS5waXZvdC54ID0gcHQueDsKCQkJCQlpdGVtLnBpdm90LnkgPSBwdC55OwoJCQkJfQoJCQkJcm90ID0gc2V0dGluZy5yb3RhdGlvbjsKCQkJCWlmKHJvdCkKCQkJCQlpdGVtLnJvdGF0aW9uID0gcm90ICogZGVnVG9SYWQ7Ly9QaXhpIHJvdGF0aW9ucyBhcmUgaW4gcmFkaWFucwoJCQl9CgkJCWVsc2UKCQkJewoJCQkJaXRlbS54ID0gc2V0dGluZy54OwoJCQkJaXRlbS55ID0gc2V0dGluZy55OwoJCQkJcHQgPSBzZXR0aW5nLnNjYWxlOwoJCQkJaWYocHQpCgkJCQl7CgkJCQkJaXRlbS5zY2FsZVggKj0gcHQueDsKCQkJCQlpdGVtLnNjYWxlWSAqPSBwdC55OwoJCQkJfQoJCQkJcHQgPSBzZXR0aW5nLnBpdm90OwoJCQkJaWYocHQpCgkJCQl7CgkJCQkJaXRlbS5yZWdYID0gcHQueDsKCQkJCQlpdGVtLnJlZ1kgPSBwdC55OwoJCQkJfQoJCQkJcm90ID0gc2V0dGluZy5yb3RhdGlvbjsKCQkJCWlmKHJvdCkKCQkJCQlpdGVtLnJvdGF0aW9uID0gcm90OwoJCQl9CgkJCS8vaXRlbS5uYW1lID0gaU5hbWU7CgkJCWlmKHNldHRpbmcuaGl0QXJlYSkKCQkJewoJCQkJdmFyIGhpdEFyZWEgPSBzZXR0aW5nLmhpdEFyZWE7CgkJCQlpZihmYWxzZSkKCQkJCXsKCQkJCQlpdGVtLmhpdEFyZWEgPSBQb3NpdGlvbmVyLmdlbmVyYXRlSGl0QXJlYShoaXRBcmVhKTsKCQkJCX0KCQkJCWVsc2UKCQkJCXsKCQkJCQlpdGVtLmhpdFNoYXBlID0gUG9zaXRpb25lci5nZW5lcmF0ZUhpdEFyZWEoaGl0QXJlYSk7CgkJCQl9CgkJCX0KCQl9Cgl9OwoJCgkvKioKCSogIENyZWF0ZSB0aGUgcG9seWdvbiBoaXQgYXJlYSBmb3IgaW50ZXJmYWNlIGVsZW1lbnRzCgkqICBAc3RhdGljCgkqICBAbWV0aG9kIGdlbmVyYXRlSGl0QXJlYQoJKiAgQHBhcmFtIHtPYmplY3R8QXJyYXl9IGhpdEFyZWEgT25lIG9mIHRoZSBmb2xsb3dpbmc6IDxici8+CgkqICAqIEFuIGFycmF5IG9mIHBvaW50cyBmb3IgYSBwb2x5Z29uLCBlLmcuIAoJKgoJKgkJW3t4OjAsIHk6MH0sIHt4OjAsIHk6MjB9LCB7eDoyMCwgeTowfV0KCSoKCSogICogQW4gb2JqZWN0IGRlc2NyaWJpbmcgYSByZWN0YW5nbGUsIGUuZy4KCSoKCSoJCXt0eXBlOiJyZWN0IiwgeDowLCB5OjAsIHc6MTAsIGg6MzB9CgkqCgkqICAqIEFuIG9iamVjdCBkZXNjcmliaW5nIGFuIGVsbGlwc2UsIHdoZXJlIHggYW5kIHkgYXJlIHRoZSBjZW50ZXIsIGUuZy4gCgkqCgkqCQl7dHlwZToiZWxsaXBzZSIsIHg6MCwgeTowLCB3OjEwLCBoOjMwfQoJKgoJKiAgKiBBbiBvYmplY3QgZGVzY3JpYmluZyBhIGNpcmNsZSwgd2hlcmUgeCBhbmQgeSBhcmUgdGhlIGNlbnRlciwgZS5nLgoJKgoJKgkJe3R5cGU6ImNpcmNsZSIsIHg6MCwgeTowLCByOjIwfQoJKiAgQHBhcmFtIHtOdW1iZXJ9IHNjYWxlPTEgVGhlIHNpemUgdG8gc2NhbGUgaGl0QXJlYSBieQoJKiAgQHJldHVybiB7T2JqZWN0fSBBIGdlb21ldHJpYyBzaGFwZSBvYmplY3QgZm9yIGhpdCB0ZXN0aW5nLCBlaXRoZXIgYSBQb2x5Z29uLCBSZWN0YW5nbGUsIEVsbGlwc2UsIG9yIENpcmNsZSwKCSogICAgICBkZXBlbmRpbmcgb24gdGhlIGhpdEFyZWEgb2JqZWN0LiBUaGUgc2hhcGUgd2lsbCBoYXZlIGEgY29udGFpbnMoKSBmdW5jdGlvbiBmb3IgaGl0IHRlc3RpbmcuCgkqLwoJUG9zaXRpb25lci5nZW5lcmF0ZUhpdEFyZWEgPSBmdW5jdGlvbihoaXRBcmVhLCBzY2FsZSkKCXsKCQlpZighc2NhbGUpCgkJCXNjYWxlID0gMTsKCQl2YXIgbGlicmFyeTsKCQlpZihmYWxzZSkKCQkJbGlicmFyeSA9IHdpbmRvdy5QSVhJOwoJCWVsc2UKCQkJbGlicmFyeSA9IHdpbmRvdy5jcmVhdGVqczsKCQlpZihpc0FycmF5KGhpdEFyZWEpKQoJCXsKCQkJaWYoc2NhbGUgPT0gMSkKCQkJCXJldHVybiBuZXcgbGlicmFyeS5Qb2x5Z29uKGhpdEFyZWEpOwoJCQllbHNlCgkJCXsKCQkJCXZhciB0ZW1wID0gW107CgkJCQlmb3IodmFyIGkgPSAwLCBsZW4gPSBoaXRBcmVhLmxlbmd0aDsgaSA8IGxlbjsgKytpKQoJCQkJewoJCQkJCXRlbXAucHVzaChuZXcgbGlicmFyeS5Qb2ludChoaXRBcmVhW2ldLnggKiBzY2FsZSwgaGl0QXJlYVtpXS55ICogc2NhbGUpKTsKCQkJCX0KCQkJCXJldHVybiBuZXcgbGlicmFyeS5Qb2x5Z29uKHRlbXApOwoJCQl9CgkJfQoJCWVsc2UgaWYoaGl0QXJlYS50eXBlID09ICJyZWN0IiB8fCAhaGl0QXJlYS50eXBlKQoJCQlyZXR1cm4gbmV3IGxpYnJhcnkuUmVjdGFuZ2xlKGhpdEFyZWEueCAqIHNjYWxlLCBoaXRBcmVhLnkgKiBzY2FsZSwgaGl0QXJlYS53ICogc2NhbGUsIGhpdEFyZWEuaCAqIHNjYWxlKTsKCQllbHNlIGlmKGhpdEFyZWEudHlwZSA9PSAiZWxsaXBzZSIpCgkJCXJldHVybiBuZXcgbGlicmFyeS5FbGxpcHNlKChoaXRBcmVhLnggLSBoaXRBcmVhLncgKiAwLjUpICogc2NhbGUsIChoaXRBcmVhLnkgLSBoaXRBcmVhLmggKiAwLjUpICogc2NhbGUsIGhpdEFyZWEudyAqIHNjYWxlLCBoaXRBcmVhLmggKiBzY2FsZSk7Ly9jb252ZXJ0IGNlbnRlciB0byB1cHBlciBsZWZ0IGNvcm5lcgoJCWVsc2UgaWYoaGl0QXJlYS50eXBlID09ICJjaXJjbGUiKQoJCQlyZXR1cm4gbmV3IGxpYnJhcnkuQ2lyY2xlKGhpdEFyZWEueCAqIHNjYWxlLCBoaXRBcmVhLnkgKiBzY2FsZSwgaGl0QXJlYS5yICogc2NhbGUpOy8veCAmIHkgYXJlIGNlbnRlciwgcGl4aSBkb2N1bWVudGF0aW9uIGxpZXMKCQllbHNlIGlmKGhpdEFyZWEudHlwZSA9PSAic2VjdG9yIikKCQkJcmV0dXJuIG5ldyBsaWJyYXJ5LlNlY3RvcihoaXRBcmVhLnggKiBzY2FsZSwgaGl0QXJlYS55ICogc2NhbGUsIGhpdEFyZWEuciAqIHNjYWxlLCBoaXRBcmVhLnN0YXJ0LCBoaXRBcmVhLmVuZCk7CgkJcmV0dXJuIG51bGw7Cgl9OwoKCXZhciBpc0FycmF5ID0gZnVuY3Rpb24obykKCXsKCQlyZXR1cm4gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKG8pID09PSAnW29iamVjdCBBcnJheV0nOwoJfTsKCQoJbmFtZXNwYWNlKCdjbG91ZGtpZCcpLlBvc2l0aW9uZXIgPSBQb3NpdGlvbmVyOwp9KCkpOwooZnVuY3Rpb24oKSB7CgkKCSJ1c2Ugc3RyaWN0IjsKCgkvKioKCSogICBPYmplY3QgdGhhdCBjb250YWlucyB0aGUgc2NyZWVuIHNldHRpbmdzIHRvIGhlbHAgc2NhbGluZwoJKiAgIEBtb2R1bGUgY2xvdWRraWQKCSogICBAY2xhc3MgU2NyZWVuU2V0dGluZ3MKCSogICBAY29uc3RydWN0b3IKCSogICBAcGFyYW0ge051bWJlcn0gd2lkdGggVGhlIHNjcmVlbiB3aWR0aCBpbiBwaXhlbHMKCSogICBAcGFyYW0ge051bWJlcn0gaGVpZ2h0IFRoZSBzY3JlZW4gaGVpZ2h0IGluIHBpeGVscwoJKiAgIEBwYXJhbSB7TnVtYmVyfSBwcGkgVGhlIHNjcmVlbiBwaXhlbCBkZW5zaXR5IChQUEkpCgkqLwoJdmFyIFNjcmVlblNldHRpbmdzID0gZnVuY3Rpb24od2lkdGgsIGhlaWdodCwgcHBpKQoJewoJCS8qKgoJCSogIFRoZSBzY3JlZW4gd2lkdGggaW4gcGl4ZWxzCgkJKiAgQHByb3BlcnR5IHtOdW1iZXJ9IHdpZHRoIAoJCSovCgkJdGhpcy53aWR0aCA9IHdpZHRoOwoKCQkvKioKCQkqICBUaGUgc2NyZWVuIGhlaWdodCBpbiBwaXhlbHMKCQkqICBAcHJvcGVydHkge051bWJlcn0gaGVpZ2h0IAoJCSovCgkJdGhpcy5oZWlnaHQgPSBoZWlnaHQ7CgoJCS8qKgoJCSogIFRoZSBzY3JlZW4gcGl4ZWwgZGVuc2l0eSAoUFBJKQoJCSogIEBwcm9wZXJ0eSB7TnVtYmVyfSBwcGkKCQkqLwoJCXRoaXMucHBpID0gcHBpOwoJfTsKCQoJLy8gU2V0IHRoZSBwcm90b3R5cGUKCVNjcmVlblNldHRpbmdzLnByb3RvdHlwZSA9IHt9OwoJCgkvLyBBc3NpZ24gdG8gbmFtZXNwYWNlCgluYW1lc3BhY2UoJ2Nsb3Vka2lkJykuU2NyZWVuU2V0dGluZ3MgPSBTY3JlZW5TZXR0aW5nczsKCn0oKSk7CihmdW5jdGlvbigpIHsKCgkidXNlIHN0cmljdCI7CgoJLy8gQ2xhc3MgaW1wb3J0cwoJdmFyIFVJU2NhbGVyOwoKCS8qKgoJKiAgIEEgc2luZ2xlIFVJIGl0ZW0gdGhhdCBuZWVkcyB0byBiZSByZXNpemVkCQoJKgoJKiAgIEBtb2R1bGUgY2xvdWRraWQKCSogICBAY2xhc3MgVUlFbGVtZW50CgkqCUBwYXJhbSB7Y3JlYXRlanMuRGlzcGxheU9iamVjdHxQSVhJLkRpc3BsYXlPYmplY3R9IGl0ZW0gVGhlIGl0ZW0gdG8gYWZmZWN0ICAKCSogICBAcGFyYW0ge1VJRWxlbWVudFNldHRpbmdzfSBzZXR0aW5ncyBUaGUgc2NhbGUgc2V0dGluZ3MKCSoJQHBhcmFtIHtTY3JlZW5TZXR0aW5nc30gZGVzaWduZWRTY3JlZW4gVGhlIG9yaWdpbmFsIHNjcmVlbiB0aGUgaXRlbSB3YXMgZGVzaWduZWQgZm9yCgkqLwoJdmFyIFVJRWxlbWVudCA9IGZ1bmN0aW9uKGl0ZW0sIHNldHRpbmdzLCBkZXNpZ25lZFNjcmVlbikKCXsKCQlVSVNjYWxlciA9IGNsb3Vka2lkLlVJU2NhbGVyOwoJCQoJCXRoaXMuX2l0ZW0gPSBpdGVtOwkJCQoJCXRoaXMuX3NldHRpbmdzID0gc2V0dGluZ3M7CgkJdGhpcy5fZGVzaWduZWRTY3JlZW4gPSBkZXNpZ25lZFNjcmVlbjsKCQkKCQlpZihmYWxzZSkKCQl7CgkJCXRoaXMub3JpZ1NjYWxlWCA9IGl0ZW0uc2NhbGUueDsJCgkJCXRoaXMub3JpZ1NjYWxlWSA9IGl0ZW0uc2NhbGUueTsKCQl9CgkJZWxzZQoJCXsKCQkJdGhpcy5vcmlnU2NhbGVYID0gaXRlbS5zY2FsZVg7CgkJCXRoaXMub3JpZ1NjYWxlWSA9IGl0ZW0uc2NhbGVZOwoJCX0KCgkJdGhpcy5vcmlnV2lkdGggPSBpdGVtLndpZHRoOwoKCQl0aGlzLm9yaWdCb3VuZHMgPSB7eDowLCB5OjAsIHdpZHRoOml0ZW0ud2lkdGgsIGhlaWdodDppdGVtLmhlaWdodH07CgkJdGhpcy5vcmlnQm91bmRzLnJpZ2h0ID0gdGhpcy5vcmlnQm91bmRzLnggKyB0aGlzLm9yaWdCb3VuZHMud2lkdGg7CgkJdGhpcy5vcmlnQm91bmRzLmJvdHRvbSA9IHRoaXMub3JpZ0JvdW5kcy55ICsgdGhpcy5vcmlnQm91bmRzLmhlaWdodDsKCQkKCQlzd2l0Y2goc2V0dGluZ3MudmVydEFsaWduKQoJCXsKCQkJY2FzZSBVSVNjYWxlci5BTElHTl9UT1A6CgkJCXsKCQkJCWlmKGZhbHNlKQoJCQkJCXRoaXMub3JpZ01hcmdpblZlcnQgPSBpdGVtLnBvc2l0aW9uLnkgKyB0aGlzLm9yaWdCb3VuZHMueTsKCQkJCWVsc2UKCQkJCQl0aGlzLm9yaWdNYXJnaW5WZXJ0ID0gaXRlbS55ICsgdGhpcy5vcmlnQm91bmRzLnk7CgkJCQlicmVhazsKCQkJfQoJCQljYXNlIFVJU2NhbGVyLkFMSUdOX0NFTlRFUjoKCQkJewoJCQkJaWYoZmFsc2UpCgkJCQkJdGhpcy5vcmlnTWFyZ2luVmVydCA9IGRlc2lnbmVkU2NyZWVuLmhlaWdodCAqIDAuNSAtIGl0ZW0ucG9zaXRpb24ueTsKCQkJCWVsc2UKCQkJCQl0aGlzLm9yaWdNYXJnaW5WZXJ0ID0gZGVzaWduZWRTY3JlZW4uaGVpZ2h0ICogMC41IC0gaXRlbS55OwoJCQkJYnJlYWs7CgkJCX0KCQkJY2FzZSBVSVNjYWxlci5BTElHTl9CT1RUT006CgkJCXsKCQkJCWlmKGZhbHNlKQoJCQkJCXRoaXMub3JpZ01hcmdpblZlcnQgPSBkZXNpZ25lZFNjcmVlbi5oZWlnaHQgLSAoaXRlbS5wb3NpdGlvbi55ICsgdGhpcy5vcmlnQm91bmRzLmJvdHRvbSk7CgkJCQllbHNlCgkJCQkJdGhpcy5vcmlnTWFyZ2luVmVydCA9IGRlc2lnbmVkU2NyZWVuLmhlaWdodCAtIChpdGVtLnkgKyB0aGlzLm9yaWdCb3VuZHMuYm90dG9tKTsKCQkJCWJyZWFrOwoJCQl9CgkJfQoKCQlzd2l0Y2goc2V0dGluZ3MuaG9yaUFsaWduKQoJCXsKCQkJY2FzZSBVSVNjYWxlci5BTElHTl9MRUZUOgoJCQl7CgkJCQlpZihmYWxzZSkKCQkJCQl0aGlzLm9yaWdNYXJnaW5Ib3JpID0gaXRlbS5wb3NpdGlvbi54ICsgdGhpcy5vcmlnQm91bmRzLng7CgkJCQllbHNlCgkJCQkJdGhpcy5vcmlnTWFyZ2luSG9yaSA9IGl0ZW0ueCArIHRoaXMub3JpZ0JvdW5kcy54OwoJCQkJYnJlYWs7CgkJCX0KCQkJY2FzZSBVSVNjYWxlci5BTElHTl9DRU5URVI6CgkJCXsKCQkJCWlmKGZhbHNlKQoJCQkJCXRoaXMub3JpZ01hcmdpbkhvcmkgPSBkZXNpZ25lZFNjcmVlbi53aWR0aCAqIDAuNSAtIGl0ZW0ucG9zaXRpb24ueDsKCQkJCWVsc2UKCQkJCQl0aGlzLm9yaWdNYXJnaW5Ib3JpID0gZGVzaWduZWRTY3JlZW4ud2lkdGggKiAwLjUgLSBpdGVtLng7CgkJCQlicmVhazsKCQkJfQoJCQljYXNlIFVJU2NhbGVyLkFMSUdOX1JJR0hUOgoJCQl7CgkJCQlpZihmYWxzZSkKCQkJCQl0aGlzLm9yaWdNYXJnaW5Ib3JpID0gZGVzaWduZWRTY3JlZW4ud2lkdGggLSAoaXRlbS5wb3NpdGlvbi54ICsgdGhpcy5vcmlnQm91bmRzLnJpZ2h0KTsKCQkJCWVsc2UKCQkJCQl0aGlzLm9yaWdNYXJnaW5Ib3JpID0gZGVzaWduZWRTY3JlZW4ud2lkdGggLSAoaXRlbS54ICsgdGhpcy5vcmlnQm91bmRzLnJpZ2h0KTsKCQkJCWJyZWFrOwoJCQl9CgkJfQoJfTsKCQoJdmFyIHAgPSBVSUVsZW1lbnQucHJvdG90eXBlID0ge307CgoJLyoqCgkqICBPcmlnaW5hbCBob3Jpem9udGFsIG1hcmdpbiBpbiBwaXhlbHMKCSogIEBwcm9wZXJ0eSB7TnVtYmVyfSBvcmlnTWFyZ2luSG9yaQoJKiAgQGRlZmF1bHQgMAoJKi8KCXAub3JpZ01hcmdpbkhvcmkgPSAwOwoKCS8qKgoJKiAgT3JpZ2luYWwgdmVydGljYWwgbWFyZ2luIGluIHBpeGVscwoJKiAgQHByb3BlcnR5IHtOdW1iZXJ9IG9yaWdNYXJnaW5WZXJ0CgkqICBAZGVmYXVsdCAwCgkqLwoJcC5vcmlnTWFyZ2luVmVydCA9IDA7CgoJLyoqIAoJKiAgT3JpZ2luYWwgd2lkdGggaW4gcGl4ZWxzIAoJKiAgQHByb3BlcnR5IHtOdW1iZXJ9IG9yaWdXaWR0aAoJKiAgQGRlZmF1bHQgMAoJKi8KCXAub3JpZ1dpZHRoID0gMDsKCgkvKioKCSogIE9yaWdpbmFsIFggc2NhbGUgb2YgdGhlIGl0ZW0KCSogIEBwcm9wZXJ0eSB7TnVtYmVyfSBvcmlnU2NhbGVYCgkqICBAZGVmYXVsdCAwCgkqLwoJcC5vcmlnU2NhbGVYID0gMDsKCgkvKioKCSogIFRoZSBvcmlnaW5hbCBZIHNjYWxlIG9mIHRoZSBpdGVtCgkqICBAcHJvcGVydHkge051bWJlcn0gb3JpZ1NjYWxlWQoJKiAgQGRlZmF1bHQgMAoJKi8KCXAub3JpZ1NjYWxlWSA9IDA7CgoJLyoqCgkqICBUaGUgb3JpZ2luYWwgYm91bmRzIG9mIHRoZSBpdGVtIHdpdGggeCwgeSwgcmlnaHQsIGJvdHRvbSwgd2lkdGgsIGhlaWdodCBwcm9wZXJ0aWVzLgoJKiAgVXNlZCB0byBkZXRlcm1pbmUgdGhlIGRpc3RhbmNlIHRvIGVhY2ggZWRnZSBvZiB0aGUgaXRlbSBmcm9tIGl0cyBvcmlnaW4KCSogIEBwcm9wZXJ0eSB7T2JqZWN0fSBvcmlnQm91bmRzCgkqLwoJcC5vcmlnQm91bmRzID0gbnVsbDsKCgkvKioKCSogIFRoZSByZWZlcmVuY2UgdG8gdGhlIHNjYWxlIHNldHRpbmdzCgkqICBAcHJpdmF0ZQoJKiAgQHByb3BlcnR5IHtVSUVsZW1lbnRTZXR0aW5nc30gX3NldHRpbmdzCgkqLwkKCXAuX3NldHRpbmdzID0gbnVsbDsKCQoJLyoqCgkqICBUaGUgcmVmZXJlbmNlIHRvIHRoZSBpbnRlcmZhY2UgaXRlbSB3ZSdyZSBzY2FsaW5nCgkqICBAcHJpdmF0ZQoJKiAgQHByb3BlcnR5IHtjcmVhdGVqcy5EaXNwbGF5T2JqZWN0fFBJWEkuRGlzcGxheU9iamVjdH0gX2l0ZW0KCSovCglwLl9pdGVtID0gbnVsbDsKCQoJLyoqCgkqICBUaGUgb3JpZ2luYWwgc2NyZWVuIHRoZSBpdGVtIHdhcyBkZXNpZ25lZCBmb3IKCSogIEBwcml2YXRlCgkqICBAcHJvcGVydHkge1NjcmVlblNldHRpbmdzfSBfZGVzaWduZWRTY3JlZW4KCSovCglwLl9kZXNpZ25lZFNjcmVlbiA9IG51bGw7CgkKCS8qKgoJKiAgQWRqdXN0IHRoZSBpdGVtIHNjYWxlIGFuZCBwb3NpdGlvbiwgdG8gcmVmbGVjdCBuZXcgc2NyZWVuCgkqICBAbWV0aG9kIHJlc2l6ZQoJKiAgQHBhcmFtIHtTY3JlZW5TZXR0aW5nc30gbmV3U2NyZWVuIFRoZSBjdXJyZW50IHNjcmVlbiBzZXR0aW5ncwoJKi8KCXAucmVzaXplID0gZnVuY3Rpb24obmV3U2NyZWVuKQoJewoJCXZhciBvdmVyYWxsU2NhbGUgPSBuZXdTY3JlZW4uaGVpZ2h0IC8gdGhpcy5fZGVzaWduZWRTY3JlZW4uaGVpZ2h0OwoJCXZhciBwcGlTY2FsZSA9IG5ld1NjcmVlbi5wcGkgLyB0aGlzLl9kZXNpZ25lZFNjcmVlbi5wcGk7CgkJdmFyIGxldHRlckJveFdpZHRoID0gKG5ld1NjcmVlbi53aWR0aCAtIHRoaXMuX2Rlc2lnbmVkU2NyZWVuLndpZHRoICogb3ZlcmFsbFNjYWxlKSAvIDI7CgoJCS8vIFNjYWxlIGl0ZW0gdG8gdGhlIG92ZXJhbGxTY2FsZSB0byBtYXRjaCByZXN0IG9mIHRoZSBhcHAsIAoJCS8vIHRoZW4gY2xhbXAgaXRzIHBoeXNpY2FsIHNpemUgYXMgc3BlY2lmaWVkIAoJCS8vIHRoZW4gc2V0IHRoZSBpdGVtJ3Mgc2NhbGUgdG8gYmUgY29ycmVjdCAtIHRoZSBzY3JlZW4gaXMgbm90IHNjYWxlZAoKCQkvL0Z1bGwgbWF0aDoKCQkvKnZhciBwaHlzaWNhbFNjYWxlOk51bWJlciA9IG92ZXJhbGxTY2FsZSAvIHBwaVNjYWxlOwoJCXZhciBpdGVtU2NhbGU6TnVtYmVyID0gTWF0aFV0aWxzLmNsYW1wKHBoeXNpY2FsU2NhbGUsIG1pblNjYWxlLCBtYXhTY2FsZSkgLyBwaHlzaWNhbFNjYWxlICogb3ZlcmFsbFNjYWxlOyovCgoJCS8vT3B0aW1pemVkIG1hdGg6CgkJdmFyIGl0ZW1TY2FsZSA9IG92ZXJhbGxTY2FsZSAvIHBwaVNjYWxlOwoJCWlmKHRoaXMuX3NldHRpbmdzLm1pblNjYWxlICYmIGl0ZW1TY2FsZSA8IHRoaXMuX3NldHRpbmdzLm1pblNjYWxlKQoJCQlpdGVtU2NhbGUgPSB0aGlzLl9zZXR0aW5ncy5taW5TY2FsZTsKCQllbHNlIGlmKHRoaXMuX3NldHRpbmdzLm1heFNjYWxlICYmIGl0ZW1TY2FsZSA+IHRoaXMuX3NldHRpbmdzLm1heFNjYWxlKQoJCQlpdGVtU2NhbGUgPSB0aGlzLl9zZXR0aW5ncy5tYXhTY2FsZTsKCQlpdGVtU2NhbGUgKj0gcHBpU2NhbGU7CgoJCWlmKGZhbHNlKQoJCXsKCQkJdGhpcy5faXRlbS5zY2FsZS54ID0gdGhpcy5vcmlnU2NhbGVYICogaXRlbVNjYWxlOwoJCQl0aGlzLl9pdGVtLnNjYWxlLnkgPSB0aGlzLm9yaWdTY2FsZVkgKiBpdGVtU2NhbGU7CgkJfQoJCWVsc2UKCQl7CgkJCXRoaXMuX2l0ZW0uc2NhbGVYID0gdGhpcy5vcmlnU2NhbGVYICogaXRlbVNjYWxlOwoJCQl0aGlzLl9pdGVtLnNjYWxlWSA9IHRoaXMub3JpZ1NjYWxlWSAqIGl0ZW1TY2FsZTsKCQl9CgoJCS8vIHBvc2l0aW9uaW5nCgkJdmFyIG07CgoJCS8vIHZlcnRpY2FsIG1vdmUKCQltID0gdGhpcy5vcmlnTWFyZ2luVmVydCAqIG92ZXJhbGxTY2FsZTsKCQkKCQkKCQlzd2l0Y2godGhpcy5fc2V0dGluZ3MudmVydEFsaWduKQoJCXsKCQkJY2FzZSBVSVNjYWxlci5BTElHTl9UT1A6CgkJCXsKCQkJCWlmKGZhbHNlKQoJCQkJCXRoaXMuX2l0ZW0ucG9zaXRpb24ueSA9IG0gLSB0aGlzLm9yaWdCb3VuZHMueSAqIGl0ZW1TY2FsZTsKCQkJCWVsc2UKCQkJCQl0aGlzLl9pdGVtLnkgPSBtIC0gdGhpcy5vcmlnQm91bmRzLnkgKiBpdGVtU2NhbGU7CgkJCQlicmVhazsKCQkJfQoJCQljYXNlIFVJU2NhbGVyLkFMSUdOX0NFTlRFUjoKCQkJewoJCQkJaWYoZmFsc2UpCgkJCQkJdGhpcy5faXRlbS5wb3NpdGlvbi55ID0gbmV3U2NyZWVuLmhlaWdodCAqIDAuNSAtIG07CgkJCQllbHNlCgkJCQkJdGhpcy5faXRlbS55ID0gbmV3U2NyZWVuLmhlaWdodCAqIDAuNSAtIG07CgkJCQlicmVhazsKCQkJfQoJCQljYXNlIFVJU2NhbGVyLkFMSUdOX0JPVFRPTToKCQkJewoJCQkJaWYoZmFsc2UpCgkJCQkJdGhpcy5faXRlbS5wb3NpdGlvbi55ID0gbmV3U2NyZWVuLmhlaWdodCAtIG0gLSB0aGlzLm9yaWdCb3VuZHMuYm90dG9tICogaXRlbVNjYWxlOwoJCQkJZWxzZQoJCQkJCXRoaXMuX2l0ZW0ueSA9IG5ld1NjcmVlbi5oZWlnaHQgLSBtIC0gdGhpcy5vcmlnQm91bmRzLmJvdHRvbSAqIGl0ZW1TY2FsZTsKCQkJCWJyZWFrOwoJCQl9CgkJfQoKCQkvLyBob3Jpem9udGFsIG1vdmUKCQltID0gdGhpcy5vcmlnTWFyZ2luSG9yaSAqIG92ZXJhbGxTY2FsZTsKCQkKCQlzd2l0Y2godGhpcy5fc2V0dGluZ3MuaG9yaUFsaWduKQoJCXsKCQkJY2FzZSBVSVNjYWxlci5BTElHTl9MRUZUOgoJCQl7CgkJCQlpZih0aGlzLl9zZXR0aW5ncy50aXRsZVNhZmUpCgkJCQl7CgkJCQkJaWYoZmFsc2UpCgkJCQkJCXRoaXMuX2l0ZW0ucG9zaXRpb24ueCA9IGxldHRlckJveFdpZHRoICsgbSAtIHRoaXMub3JpZ0JvdW5kcy54ICogaXRlbVNjYWxlOwoJCQkJCWVsc2UKCQkJCQkJdGhpcy5faXRlbS54ID0gbGV0dGVyQm94V2lkdGggKyBtIC0gdGhpcy5vcmlnQm91bmRzLnggKiBpdGVtU2NhbGU7CgkJCQl9CgkJCQllbHNlCgkJCQl7CgkJCQkJaWYoZmFsc2UpCgkJCQkJCXRoaXMuX2l0ZW0ucG9zaXRpb24ueCA9IG0gLSB0aGlzLm9yaWdCb3VuZHMueCAqIGl0ZW1TY2FsZTsKCQkJCQllbHNlCgkJCQkJCXRoaXMuX2l0ZW0ueCA9IG0gLSB0aGlzLm9yaWdCb3VuZHMueCAqIGl0ZW1TY2FsZTsKCQkJCX0KCQkJCWJyZWFrOwoJCQl9CgkJCWNhc2UgVUlTY2FsZXIuQUxJR05fQ0VOVEVSOgoJCQl7CgkJCQlpZih0aGlzLl9zZXR0aW5ncy5jZW50ZXJlZEhvcml6b250YWxseSkKCQkJCXsKCQkJCQlpZihmYWxzZSkKCQkJCQkJdGhpcy5faXRlbS5wb3NpdGlvbi54ID0gKG5ld1NjcmVlbi53aWR0aCAtIHRoaXMuX2l0ZW0ud2lkdGgpICogMC41OwoJCQkJCWVsc2UKCQkJCQkJdGhpcy5faXRlbS54ID0gKG5ld1NjcmVlbi53aWR0aCAtIHRoaXMuX2l0ZW0ud2lkdGgpICogMC41OwoJCQkJfQoJCQkJZWxzZQoJCQkJewoJCQkJCWlmKGZhbHNlKQoJCQkJCQl0aGlzLl9pdGVtLnBvc2l0aW9uLnggPSBuZXdTY3JlZW4ud2lkdGggKiAwLjUgLSBtOwoJCQkJCWVsc2UKCQkJCQkJdGhpcy5faXRlbS54ID0gbmV3U2NyZWVuLndpZHRoICogMC41IC0gbTsKCQkJCX0KCQkJCWJyZWFrOwoJCQl9CQoJCQljYXNlIFVJU2NhbGVyLkFMSUdOX1JJR0hUOgoJCQl7CgkJCQlpZih0aGlzLl9zZXR0aW5ncy50aXRsZVNhZmUpCgkJCQl7CgkJCQkJaWYoZmFsc2UpCgkJCQkJCXRoaXMuX2l0ZW0ucG9zaXRpb24ueCA9IG5ld1NjcmVlbi53aWR0aCAtIGxldHRlckJveFdpZHRoIC0gbSAtIHRoaXMub3JpZ0JvdW5kcy5yaWdodCAqIGl0ZW1TY2FsZTsKCQkJCQllbHNlCgkJCQkJCXRoaXMuX2l0ZW0ueCA9IG5ld1NjcmVlbi53aWR0aCAtIGxldHRlckJveFdpZHRoIC0gbSAtIHRoaXMub3JpZ0JvdW5kcy5yaWdodCAqIGl0ZW1TY2FsZTsKCQkJCX0KCQkJCWVsc2UKCQkJCXsKCQkJCQlpZihmYWxzZSkKCQkJCQkJdGhpcy5faXRlbS5wb3NpdGlvbi54ID0gbmV3U2NyZWVuLndpZHRoIC0gbSAtIHRoaXMub3JpZ0JvdW5kcy5yaWdodCAqIGl0ZW1TY2FsZTsKCQkJCQllbHNlCgkJCQkJCXRoaXMuX2l0ZW0ueCA9IG5ld1NjcmVlbi53aWR0aCAtIG0gLSB0aGlzLm9yaWdCb3VuZHMucmlnaHQgKiBpdGVtU2NhbGU7CgkJCQl9CgkJCQlicmVhazsKCQkJfQkJCgkJfQoJfTsKCQoJLyoqCgkqICBEZXN0cm95IHRoaXMgaXRlbSwgZG9uJ3QgdXNlIGFmdGVyIHRoaXMKCSogIEBtZXRob2QgZGVzdHJveQoJKi8KCXAuZGVzdHJveSA9IGZ1bmN0aW9uKCkKCXsKCQl0aGlzLm9yaWdCb3VuZHMgPSBudWxsOwoJCXRoaXMuX2l0ZW0gPSBudWxsOwoJCXRoaXMuX3NldHRpbmdzID0gbnVsbDsKCQl0aGlzLl9kZXNpZ25lZFNjcmVlbiA9IG51bGw7Cgl9OwoJCgluYW1lc3BhY2UoJ2Nsb3Vka2lkJykuVUlFbGVtZW50ID0gVUlFbGVtZW50Owp9KCkpOwooZnVuY3Rpb24oKSB7CgkKCSJ1c2Ugc3RyaWN0IjsKCgkvKioKCSogIFRoZSBVSSBJdGVtIFNldHRpbmdzIHdoaWNoIGlzIHRoZSBwb3NpdGlvbmluZyBzZXR0aW5ncyB1c2VkIHRvIGFkanVzdCBlYWNoIGVsZW1lbnQKCSogIEBtb2R1bGUgY2xvdWRraWQKCSogIEBjbGFzcyBVSUVsZW1lbnRTZXR0aW5ncwoJKi8KCXZhciBVSUVsZW1lbnRTZXR0aW5ncyA9IGZ1bmN0aW9uKCl7fTsKCQoJLy8gUmVmZXJlbmNlIHRvIHRoZSBwcm90b3R5cGUKCXZhciBwID0gVUlFbGVtZW50U2V0dGluZ3MucHJvdG90eXBlID0ge307CgkKCS8qKiAKCSogIFdoYXQgdmVydGljYWwgc2NyZWVuIGxvY2F0aW9uIHRoZSBpdGVtIHNob3VsZCBiZSBhbGlnbmVkIHRvOiAidG9wIiwgImNlbnRlciIsICJib3R0b20iCgkqICBAcHJvcGVydHkge1N0cmluZ30gdmVydEFsaWduCgkqLwoJcC52ZXJ0QWxpZ24gPSBudWxsOwoKCS8qKiAKCSogIFdoYXQgaG9yaXpvbnRhbCBzY3JlZW4gbG9jYXRpb24gdGhlIGl0ZW0gc2hvdWxkIGJlIGFsaWduZWQgdG86ICJsZWZ0IiwgImNlbnRlciIsICJyaWdodCIKCSogIEBwcm9wZXJ0eSB7U3RyaW5nfSBob3JpQWxpZ24KCSovCglwLmhvcmlBbGlnbiA9IG51bGw7CgoJLyoqIAoJKiAgSWYgdGhpcyBlbGVtZW50IHNob3VsZCBiZSBhbGlnbmVkIHRvIHRoZSB0aXRsZSBzYWZlIGFyZWEsIG5vdCB0aGUgYWN0dWFsIHNjcmVlbiAKCSogIEBwcm9wZXJ0eSB7Qm9vbGVhbn0gdGl0bGVTYWZlCgkqICBAZGVmYXVsdCBmYWxzZQoJKi8KCXAudGl0bGVTYWZlID0gZmFsc2U7CgoJLyoqIAoJKiAgTWF4aW11bSBzY2FsZSBhbGxvd2VkIGluIHBoeXNpY2FsIHNpemUgCgkqICBAcHJvcGVydHkge051bWJlcn0gbWF4U2NhbGUKCSogIEBkZWZhdWx0IDEKCSovCglwLm1heFNjYWxlID0gMTsKCgkvKiogCgkqICBNaW5pbXVtIHNjYWxlIGFsbG93ZWQgaW4gcGh5c2ljYWwgc2l6ZSAKCSogIEBwcm9wZXJ0eSB7TnVtYmVyfSBtaW5TY2FsZQoJKiAgQGRlZmF1bHQgMQoJKi8KCXAubWluU2NhbGUgPSAxOwoJCgkvKioKCSogIElmIHRoZSBVSSBlbGVtZW50IGlzIGNlbnRlcmVkIGhvcml6b250YWxseQoJKiAgQHByb3BlcnR5IHtCb29sZWFufSBjZW50ZXJlZEhvcml6b250YWxseQoJKiAgQGRlZmF1bHQgZmFsc2UKCSovCglwLmNlbnRlcmVkSG9yaXpvbnRhbGx5ID0gZmFsc2U7CgkKCW5hbWVzcGFjZSgnY2xvdWRraWQnKS5VSUVsZW1lbnRTZXR0aW5ncyA9IFVJRWxlbWVudFNldHRpbmdzOwp9KCkpOwooZnVuY3Rpb24oKSB7CgkKCSJ1c2Ugc3RyaWN0IjsKCgkvLyBDbGFzcyBpbXBvcnRzCgl2YXIgVUlFbGVtZW50U2V0dGluZ3MgPSBjbG91ZGtpZC5VSUVsZW1lbnRTZXR0aW5ncywKCQlVSUVsZW1lbnQgPSBjbG91ZGtpZC5VSUVsZW1lbnQsCgkJU2NyZWVuU2V0dGluZ3MgPSBjbG91ZGtpZC5TY3JlZW5TZXR0aW5nczsKCgkvKioKCSogICBUaGUgVUkgc2NhbGUgaXMgcmVzcG9uc2libGUgZm9yIHNjYWxpbmcgVUkgY29tcG9uZW50cwoJKiAgIHRvIGhlbHAgZWFzeSB0aGUgYnVyZGVuIG9mIGRpZmZlcmVudCBkZXZpY2UgYXNwZWN0IHJhdGlvcwoJKgoJKiAgQG1vZHVsZSBjbG91ZGtpZAoJKiAgQGNsYXNzIFVJU2NhbGVyCgkqICBAY29uc3RydWN0b3IKCSogIEBwYXJhbSB7Y3JlYXRlanMuRGlzcGxheU9iamVjdHxQSVhJLkRpc3BsYXlPYmplY3R9IHBhcmVudCBUaGUgVUkgZGlzcGxheSBjb250YWluZXIKCSogIEBwYXJhbSB7TnVtYmVyfSBkZXNpZ25lZFdpZHRoIFRoZSBkZXNpZ25lZCB3aWR0aCBvZiB0aGUgVUkKCSogIEBwYXJhbSB7TnVtYmVyfSBkZXNpZ25lZEhlaWdodCBUaGUgZGVzaWduZWQgaGVpZ2h0IG9mIHRoZSBVSQoJKiAgQHBhcmFtIHtOdW1iZXJ9IGRlc2lnbmVkUFBJIFRoZSBkZXNpZ25lZCBQUEkgb2YgdGhlIFVJCgkqLwoJdmFyIFVJU2NhbGVyID0gZnVuY3Rpb24ocGFyZW50LCBkZXNpZ25lZFdpZHRoLCBkZXNpZ25lZEhlaWdodCwgZGVzaWduZWRQUEkpCgl7CgkJdGhpcy5fcGFyZW50ID0gcGFyZW50OwoJCXRoaXMuX2l0ZW1zID0gW107CgkJdGhpcy5fZGVzaWduZWRTY3JlZW4gPSBuZXcgU2NyZWVuU2V0dGluZ3MoZGVzaWduZWRXaWR0aCwgZGVzaWduZWRIZWlnaHQsIGRlc2lnbmVkUFBJKTsKCX07CgkKCS8vIFJlZmVyZW5jZSB0byB0aGUgcHJvdG90eXBlCgl2YXIgcCA9IFVJU2NhbGVyLnByb3RvdHlwZSA9IHt9OwoJCQkJCgkvKiogCgkqICBUaGUgY3VycmVudCBzY3JlZW4gc2V0dGluZ3MgCgkqICBAcHJvcGVydHkge1NjcmVlblNldHRpbmdzfSBjdXJyZW50U2NyZWVuCgkqICBAc3RhdGljCgkqICBAcHJpdmF0ZQoJKi8KCXZhciBjdXJyZW50U2NyZWVuID0gbmV3IFNjcmVlblNldHRpbmdzKDAsIDAsIDApOwoJCgkvKiogCgkqICBJZiB0aGUgc2NyZWVuc2l6ZSBoYXMgYmVlbiBzZXQgCgkqICBAcHJvcGVydHkge0Jvb2xlYW59IGluaXRpYWxpemVkCgkqICBAc3RhdGljCgkqICBAcHJpdmF0ZQoJKi8KCXZhciBpbml0aWFsaXplZCA9IGZhbHNlOwoJCgkvKiogCgkqICBUaGUgVUkgZGlzcGxheSBvYmplY3QgdG8gdXBkYXRlIAoJKiAgQHByb3BlcnR5IHtjcmVhdGVqcy5EaXNwbGF5T2JqZWN0fFBJWEkuRGlzcGxheU9iamVjdH0gX3BhcmVudAoJKiAgQHByaXZhdGUKCSovCglwLl9wYXJlbnQgPSBudWxsOwoJCgkvKiogCgkqICBUaGUgc2NyZWVuIHNldHRpbmdzIG9iamVjdCwgY29udGFpbnMgaW5mb3JtYXRpb24gYWJvdXQgZGVzaWduZWQgc2l6ZSAKCSogIEBwcm9wZXJ0eSB7U2NyZWVuU2V0dGluZ3N9IF9kZXNpZ25lZFNjcmVlbgoJKiAgQHByaXZhdGUKCSovCglwLl9kZXNpZ25lZFNjcmVlbiA9IG51bGw7CgkKCS8qKiAKCSogIFRoZSBjb25maWd1cmF0aW9uIGZvciBlYWNoIGl0ZW1zCgkqICBAcHJvcGVydHkge0FycmF5fSBfaXRlbXMKCSogIEBwcml2YXRlCgkqLwoJcC5faXRlbXMgPSBudWxsOwoJCgkvKioKCSogIFZlcnRpY2FsbHkgYWxpZ24gdG8gdGhlIHRvcAoJKiAgQHByb3BlcnR5IHtTdHJpbmd9IEFMSUdOX1RPUAoJKiAgQHN0YXRpYwoJKiAgQGZpbmFsCgkqICBAcmVhZE9ubHkKCSogIEBkZWZhdWx0ICJ0b3AiCgkqLwoJVUlTY2FsZXIuQUxJR05fVE9QID0gInRvcCI7CgoJLyoqCgkqICBWZXJ0aWNhbGx5IGFsaWduIHRvIHRoZSBib3R0b20KCSogIEBwcm9wZXJ0eSB7U3RyaW5nfSBBTElHTl9CT1RUT00KCSogIEBzdGF0aWMKCSogIEBmaW5hbAoJKiAgQHJlYWRPbmx5CgkqICBAZGVmYXVsdCAiYm90dG9tIgoJKi8KCVVJU2NhbGVyLkFMSUdOX0JPVFRPTSA9ICJib3R0b20iOwoKCS8qKgoJKiAgSG9yaXpvbnRhbGx5IGFsaWduIHRvIHRoZSBsZWZ0CgkqICBAcHJvcGVydHkge1N0cmluZ30gQUxJR05fTEVGVAoJKiAgQHN0YXRpYwoJKiAgQGZpbmFsCgkqICBAcmVhZE9ubHkKCSogIEBkZWZhdWx0ICJsZWZ0IgoJKi8KCVVJU2NhbGVyLkFMSUdOX0xFRlQgPSAibGVmdCI7CgoJLyoqCgkqICBIb3Jpem9udGFsbHkgYWxpZ24gdG8gdGhlIHJpZ2h0CgkqICBAcHJvcGVydHkge1N0cmluZ30gQUxJR05fUklHSFQKCSogIEBzdGF0aWMKCSogIEBmaW5hbAoJKiAgQHJlYWRPbmx5CgkqICBAZGVmYXVsdCAicmlnaHQiCgkqLwoJVUlTY2FsZXIuQUxJR05fUklHSFQgPSAicmlnaHQiOwoKCS8qKgoJKiAgVmVydGljYWxseSBvciBob3Jpem9udGFsbHkgYWxpZ24gdG8gdGhlIGNlbnRlcgoJKiAgQHByb3BlcnR5IHtTdHJpbmd9IEFMSUdOX0NFTlRFUgoJKiAgQHN0YXRpYwoJKiAgQGZpbmFsCgkqICBAcmVhZE9ubHkKCSogIEBkZWZhdWx0ICJjZW50ZXIiCgkqLwoJVUlTY2FsZXIuQUxJR05fQ0VOVEVSID0gImNlbnRlciI7CgkKCS8qKgoJKiAgQ3JlYXRlIHRoZSBzY2FsZXIgZnJvbSBKU09OIGRhdGEKCSogIEBtZXRob2QgZnJvbUpTT04KCSogIEBzdGF0aWMKCSogIEBwYXJhbSB7Y3JlYXRlanMuRGlzcGxheU9iamVjdHxQSVhJLkRpc3BsYXlPYmplY3R9IHBhcmVudCBUaGUgVUkgZGlzcGxheSBjb250YWluZXIKCSogIEBwYXJhbSB7T2JqZWN0fSBqc29uU2V0dGluZ3MgVGhlIGpzb24gb2YgdGhlIGRlc2lnbmVkIHNldHRpbmdzIHtkZXNpZ25lZFdpZHRoOjgwMCwgZGVzaWduZWRIZWlnaHQ6NjAwLCBkZXNpZ25lZFBQSTo3Mn0KCSogIEBwYXJhbSB7T2JqZWN0fSBqc29uSXRlbXMgVGhlIGpzb24gaXRlbXMgb2JqZWN0IHdoZXJlIHRoZSBrZXlzIGFyZSB0aGUgbmFtZSBvZiB0aGUgcHJvcGVydHkgb24gdGhlIHBhcmVudCBhbmQgdGhlIHZhbHVlCgkqICAgICAgICAgaXMgYW4gb2JqZWN0IHdpdGgga2V5cyBvZiAidGl0bGVTYWZlIiwgIm1pblNjYWxlIiwgIm1heFNjYWxlIiwgImNlbnRlckhvcml6b250YWxseSIsICJhbGlnbiIKCSogIEBwYXJhbSB7Qm9vbGVhbn0gW2ltbWVkaWF0ZURlc3Ryb3k9dHJ1ZV0gSWYgd2Ugc2hvdWxkIGltbWVkaWF0ZWx5IGNsZWFudXAgdGhlIFVJU2NhbGVyIGFmdGVyIHNjYWxpbmcgaXRlbXMKCSogIEByZXR1cm4ge1VJU2NhbGVyfSBUaGUgc2NhbGVyIG9iamVjdCB0aGF0IGNhbiBiZSByZXVzZWQKCSovCglVSVNjYWxlci5mcm9tSlNPTiA9IGZ1bmN0aW9uKHBhcmVudCwganNvblNldHRpbmdzLCBqc29uSXRlbXMsIGltbWVkaWF0ZURlc3Ryb3kpCgl7CgkJaWYgKHR5cGVvZiBpbW1lZGlhdGVEZXN0cm95ICE9ICJib29sZWFuIikgaW1tZWRpYXRlRGVzdHJveSA9IHRydWU7CgkJCQoJCXZhciBzY2FsZXIgPSBuZXcgVUlTY2FsZXIoCgkJCXBhcmVudCwgCgkJCWpzb25TZXR0aW5ncy5kZXNpZ25lZFdpZHRoLAoJCQlqc29uU2V0dGluZ3MuZGVzaWduZWRIZWlnaHQsCgkJCWpzb25TZXR0aW5ncy5kZXNpZ25lZFBQSQoJCSk7CgkJCgkJLy8gVGVtcCB2YXJpYWJsZXMKCQl2YXIgaXRlbSwgaSwgYWxpZ24sIHZlcnRBbGlnbiwgaG9yaUFsaWduOwoJCQoJCS8vIExvb3AgdGhyb3VnaCBhbGwgdGhlIGl0ZW1zIGFuZCByZWdpc3RlcgoJCS8vIGVhY2ggZHBlbmRpbmcgb24gdGhlIHNldHRpbmdzCgkJZm9yKGkgaW4ganNvbkl0ZW1zKQoJCXsKCQkJaXRlbSA9IGpzb25JdGVtc1tpXTsKCQkJCgkJCWlmIChpdGVtLmFsaWduKQoJCQl7CgkJCQlhbGlnbiA9IGl0ZW0uYWxpZ24uc3BsaXQoIi0iKTsKCQkJCXZlcnRBbGlnbiA9IGFsaWduWzBdOwoJCQkJaG9yaUFsaWduID0gYWxpZ25bMV07CgkJCX0KCQkJZWxzZQoJCQl7CgkJCQl2ZXJ0QWxpZ24gPSBBTElHTl9DRU5URVI7CgkJCQlob3JpQWxpZ24gPSBBTElHTl9DRU5URVI7CgkJCX0KCQkJc2NhbGVyLmFkZCgKCQkJCXBhcmVudFtpXSwgCgkJCQl2ZXJ0QWxpZ24sCgkJCQlob3JpQWxpZ24sCgkJCQlpdGVtLnRpdGxlU2FmZSB8fCBmYWxzZSwKCQkJCWl0ZW0ubWluU2NhbGUgfHwgTmFOLAoJCQkJaXRlbS5tYXhTY2FsZSB8fCBOYU4sCgkJCQlpdGVtLmNlbnRlcmVkSG9yaXpvbnRhbGx5IHx8IGZhbHNlCgkJCSk7CgkJfQoJCQoJCS8vIFNjYWxlIHRoZSBpdGVtcwoJCXNjYWxlci5yZXNpemUoKTsKCQkKCQlpZiAoaW1tZWRpYXRlRGVzdHJveSkKCQl7CgkJCXNjYWxlci5kZXN0cm95KCk7CgkJfQoJCXJldHVybiBzY2FsZXI7Cgl9OwoJCgkvKioKCSogICBTZXQgdGhlIGN1cnJlbnQgc2NyZWVuIHNldHRpbmdzLiBJZiB0aGUgc3RhZ2Ugc2l6ZSBjaGFuZ2VzIGF0IGFsbCwgcmUtY2FsbCB0aGlzIGZ1bmN0aW9uCgkqICAgQG1ldGhvZCBpbml0CgkqICAgQHN0YXRpYwoJKiAgIEBwYXJhbSB7TnVtYmVyfSBzY3JlZW5XaWR0aCBUaGUgZnVsbHNjcmVlbiB3aWR0aAoJKiAgIEBwYXJhbSB7TnVtYmVyfSBzY3JlZW5IZWlnaHQgVGhlIGZ1bGxzY3JlZW4gaGVpZ2h0CgkqICAgQHBhcmFtIHtOdW1iZXJ9IHNjcmVlblBQSSBUaGUgc2NyZWVuIHJlc29sdXRpb24gZGVuc2l0eQoJKi8KCVVJU2NhbGVyLmluaXQgPSBmdW5jdGlvbihzY3JlZW5XaWR0aCwgc2NyZWVuSGVpZ2h0LCBzY3JlZW5QUEkpCgl7CgkJY3VycmVudFNjcmVlbi53aWR0aCA9IHNjcmVlbldpZHRoOwoJCWN1cnJlbnRTY3JlZW4uaGVpZ2h0ID0gc2NyZWVuSGVpZ2h0OwoJCWN1cnJlbnRTY3JlZW4ucHBpID0gc2NyZWVuUFBJOwoJCWluaXRpYWxpemVkID0gdHJ1ZTsKCX07CgoJLyoqCgkqICBHZXQgdGhlIGN1cnJlbnQgc2NhbGUgb2YgdGhlIHNjcmVlbgoJKiAgQG1ldGhvZCBnZXRTY2FsZQoJKiAgQHJldHVybiB7TnVtYmVyfSBUaGUgY3VycmVudCBzdGFnZSBzY2FsZQoJKi8KCXAuZ2V0U2NhbGUgPSBmdW5jdGlvbigpCgl7CgkJcmV0dXJuIGN1cnJlbnRTY3JlZW4uaGVpZ2h0IC8gdGhpcy5fZGVzaWduZWRTY3JlZW4uaGVpZ2h0OwoJfTsKCQoJLyoqCgkqICAgTWFudWFsbHkgYWRkIGFuIGl0ZW0gCgkqICAgQG1ldGhvZCBhZGQKCSogICBAcGFyYW0ge2NyZWF0ZWpzLkRpc3BsYXlPYmplY3R8UElYSS5EaXNwbGF5T2JqZWN0fSBpdGVtIFRoZSBkaXNwbGF5IG9iamVjdCBpdGVtIHRvIGFkZAoJKiAgIEBwYXJhbSB7U3RyaW5nfSBbdmVydEFsaWduPSJjZW50ZXIiXSBUaGUgdmVydGljYWwgYWxpZ24gb2YgdGhlIGl0ZW0gKGNlZmF1bHQgaXMgY2VudGVyKQoJKiAgIEBwYXJhbSB7U3RyaW5nfSBbaG9yaUFsaWduPSJjZW50ZXIiXSBUaGUgaG9yaXpvbnRhbCBhbGlnbiBvZiB0aGUgaXRlbSAoZGVmYXVsdCBpcyBjZW50ZXIpCgkqICAgQHBhcmFtIHtCb29sZWFufSBbdGl0bGVTYWZlPWZhbHNlXSBJZiB0aGUgaXRlbSBuZWVkcyB0byBiZSBpbiB0aGUgdGl0bGUgc2FmZSBhcmVhIChkZWZhdWx0IGlzIGZhbHNlKQoJKiAgIEBwYXJhbSB7TnVtYmVyfSBbbWluU2NhbGU9MV0gVGhlIG1pbmltdW0gc2NhbGUgYW1vdW50IChkZWZhdWx0LCBzY2FsZXMgdGhlIHNhbWUgc2l6ZSBhcyB0aGUgc3RhZ2UpCgkqICAgQHBhcmFtIHtOdW1iZXJ9IFttYXhTY2FsZT0xXSBUaGUgbWF4aW11bSBzY2FsZSBhbW91bnQgKGRlZmF1bHQsIHNjYWxlcyB0aGUgc2FtZSBzaXplIGFzIHRoZSBzdGFnZSkKCSogICBAcGFyYW0ge0Jvb2xlYW59IFtjZW50ZXJlZEhvcml6b250YWxseT1mYWxzZV0gTWFrZXMgc3VyZSB0aGF0IHRoZSBjZW50ZXIgb2YgdGhlIG9iamVjdCB3YXMgYXQgdGhlIGNlbnRlciBvZiB0aGUgc2NyZWVuLCBhc3N1bWluZyBhbiBvcmlnaW4gYXQgdGhlIHRvcCBsZWZ0IG9mIHRoZSBvYmplY3QKCSovCglwLmFkZCA9IGZ1bmN0aW9uKGl0ZW0sIHZlcnRBbGlnbiwgaG9yaUFsaWduLCB0aXRsZVNhZmUsIG1pblNjYWxlLCBtYXhTY2FsZSwgY2VudGVyZWRIb3Jpem9udGFsbHkpCgl7CgkJLy8gQ3JlYXRlIHRoZSBpdGVtIHNldHRpbmdzCgkJdmFyIHMgPSBuZXcgVUlFbGVtZW50U2V0dGluZ3MoKTsKCQkKCQlzLnZlcnRBbGlnbiA9IHZlcnRBbGlnbiB8fCBVSVNjYWxlci5BTElHTl9DRU5URVI7CgkJcy5ob3JpQWxpZ24gPSBob3JpQWxpZ24gfHwgVUlTY2FsZXIuQUxJR05fQ0VOVEVSOwoJCXMudGl0bGVTYWZlID0gKHR5cGVvZiB0aXRsZVNhZmUgIT0gImJvb2xlYW4iKSA/IGZhbHNlIDogdGl0bGVTYWZlOwoJCXMubWF4U2NhbGUgPSAodHlwZW9mIG1heFNjYWxlICE9ICJudW1iZXIiKSA/IE5hTiA6IG1heFNjYWxlOwoJCXMubWluU2NhbGUgPSAodHlwZW9mIG1pblNjYWxlICE9ICJudW1iZXIiKSA/IE5hTiA6IG1pblNjYWxlOwoJCXMuY2VudGVyZWRIb3Jpem9udGFsbHkgPSBjZW50ZXJlZEhvcml6b250YWxseSB8fCBmYWxzZTsKCQkJCQoJCXRoaXMuX2l0ZW1zLnB1c2gobmV3IFVJRWxlbWVudChpdGVtLCBzLCB0aGlzLl9kZXNpZ25lZFNjcmVlbikpOwoJfTsKCQoJLyoqCgkqICAgU2NhbGUgYSBzaW5nbGUgYmFja2dyb3VuZCBpbWFnZSBhY2NvcmRpbmcgdG8gdGhlIFVJU2NhbGVyLndpZHRoIGFuZCBoZWlnaHQKCSogICBAbWV0aG9kIHJlc2l6ZUJhY2tncm91bmQKCSogICBAc3RhdGljCgkqICAgQHBhcmFtIHtjcmVhdGVqcy5CaXRtYXB8UElYSS5CaXRtYXB9IFRoZSBiaXRtYXAgdG8gc2NhbGUKCSovCglVSVNjYWxlci5yZXNpemVCYWNrZ3JvdW5kID0gZnVuY3Rpb24oYml0bWFwKQoJewoJCWlmICghaW5pdGlhbGl6ZWQpIHJldHVybjsKCQkKCQl2YXIgaCwgdywgc2NhbGU7CgkJaWYoZmFsc2UpCgkJewoJCQloID0gYml0bWFwLmhlaWdodCAvIGJpdG1hcC5zY2FsZS55OwoJCQl3ID0gYml0bWFwLndpZHRoIC8gYml0bWFwLnNjYWxlLng7CgoJCQkvL3NjYWxlIHRoZSBiYWNrZ3JvdW5kCgkJCXNjYWxlID0gY3VycmVudFNjcmVlbi5oZWlnaHQgLyBoOwoJCQliaXRtYXAuc2NhbGUueCA9IGJpdG1hcC5zY2FsZS55ID0gc2NhbGU7CgkJCQoJCQkvL2NlbnRlciB0aGUgYmFja2dyb3VuZAoJCQliaXRtYXAucG9zaXRpb24ueCA9IChjdXJyZW50U2NyZWVuLndpZHRoIC0gYml0bWFwLndpZHRoKSAqIDAuNTsKCQl9CgkJZWxzZSBpZih0cnVlKQoJCXsKCQkJaCA9IGJpdG1hcC5pbWFnZS5oZWlnaHQ7CgkJCXcgPSBiaXRtYXAuaW1hZ2Uud2lkdGg7CgoJCQkvL3NjYWxlIHRoZSBiYWNrZ3JvdW5kCgkJCXNjYWxlID0gY3VycmVudFNjcmVlbi5oZWlnaHQgLyBoOwoJCQliaXRtYXAuc2NhbGVYID0gYml0bWFwLnNjYWxlWSA9IHNjYWxlOwoJCQkKCQkJLy9jZW50ZXIgdGhlIGJhY2tncm91bmQKCQkJYml0bWFwLnggPSAoY3VycmVudFNjcmVlbi53aWR0aCAtIHcgKiBzY2FsZSkgKiAwLjU7CgkJfQoJfTsKCQoJLyoqCgkqICBDb252ZW5pZW5jZSBmdW5jdGlvbiB0byBzY2FsZSBhIGNvbGxlY3Rpb24gb2YgYmFja2dyb3VuZHMKCSogIEBtZXRob2QgcmVzaXplQmFja2dyb3VuZHMKCSogIEBzdGF0aWMKCSogIEBwYXJhbSB7QXJyYXl9IGJpdG1hcHMgVGhlIGNvbGxlY3Rpb24gb2YgYml0bWFwIGltYWdlcwoJKi8KCVVJU2NhbGVyLnJlc2l6ZUJhY2tncm91bmRzID0gZnVuY3Rpb24oYml0bWFwcykKCXsKCQlmb3IodmFyIGkgPSAwLCBsZW4gPSBiaXRtYXBzLmxlbmd0aDsgaSA8IGxlbjsgKytpKQoJCXsKCQkJVUlTY2FsZXIucmVzaXplQmFja2dyb3VuZChiaXRtYXBzW2ldKTsKCQl9Cgl9OwoJCgkvKioKCSogIFNjYWxlIHRoZSBVSSBpdGVtcyB0aGF0IGhhdmUgYmVlbiByZWdpc3RlcmVkIHRvIHRoZSBjdXJyZW50IHNjcmVlbgoJKiAgQG1ldGhvZCByZXNpemUKCSovCglwLnJlc2l6ZSA9IGZ1bmN0aW9uKCkKCXsKCQlpZiAodGhpcy5faXRlbXMubGVuZ3RoID4gMCkKCQl7CgkJCWZvcih2YXIgaSA9IDAsIGxlbiA9IHRoaXMuX2l0ZW1zLmxlbmd0aDsgaSA8IGxlbjsgKytpKQoJCQl7CgkJCQl0aGlzLl9pdGVtc1tpXS5yZXNpemUoY3VycmVudFNjcmVlbik7CgkJCX0KCQl9Cgl9OwoJCgkvKioKCSogIERlc3Ryb3kgdGhlIHNjYWxlciBvYmplY3QKCSogIEBtZXRob2QgZGVzdHJveQoJKi8KCXAuZGVzdHJveSA9IGZ1bmN0aW9uKCkKCXsKCQlpZiAodGhpcy5faXRlbXMubGVuZ3RoID4gMCkKCQl7CgkJCWZvcih2YXIgaSA9IDAsIGxlbiA9IHRoaXMuX2l0ZW1zLmxlbmd0aDsgaSA8IGxlbjsgKytpKQoJCQl7CgkJCQl0aGlzLl9pdGVtc1tpXS5kZXN0cm95KCk7CgkJCX0KCQl9CgkJCgkJdGhpcy5fcGFyZW50ID0gbnVsbDsKCQl0aGlzLl9kZXNpZ25lZFNjcmVlbiA9IG51bGw7CgkJdGhpcy5faXRlbXMgPSBudWxsOwoJfTsKCQoJbmFtZXNwYWNlKCdjbG91ZGtpZCcpLlVJU2NhbGVyID0gVUlTY2FsZXI7Cn0oKSk7Cg==",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Thu, 06 Nov 2014 15:39:30 GMT",
                    "Content-Length": "125998",
                    "Date": "Thu, 06 Nov 2014 15:39:34 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}