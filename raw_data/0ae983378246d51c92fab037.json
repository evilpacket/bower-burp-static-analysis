{
    "url": "http://localhost:9999/x-tag/view/demo/x-tag-components.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Cross-site scripting (DOM-based)",
    "issueType": 2097936,
    "severity": "High",
    "confidence": "Firm",
    "issueBackground": "DOM-based cross-site scripting vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this data into the HTML document in an unsafe way. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will cause JavaScript code supplied by the attacker to execute within the user's browser in the context of that user's session with the application.<br><br>The attacker-supplied code can perform a wide variety of actions, such as stealing the victim's session token or login credentials, performing arbitrary actions on the victim's behalf, and logging their keystrokes.<br><br>Users can be induced to visit the attacker's crafted URL in various ways, similar to the usual attack delivery vectors for reflected cross-site scripting vulnerabilities. ",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based cross-site scripting vulnerabilities is not to dynamically write data into the HTML document that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing script code into the document. In many cases, the relevant data can be validated on a whitelist basis, to allow only content that is known to be safe. In other cases, it will be necessary to sanitize or encode the data. This can be a complex task, and depending on the context that the data is to be inserted may need to involve a combination of JavaScript escaping, HTML encoding, and URL encoding, in the appropriate sequence.",
    "issueDetail": "The application may be vulnerable to DOM-based cross-site scripting. Data is read from <b>the 'baseURI' property of a DOM element</b> and written to <b>the 'setAttribute()' function of a DOM element</b> via the following statement:<ul><li>base.setAttribute('href', document.baseURI);</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/x-tag/view/demo/x-tag-components.js",
                "path": "/x-tag/view/demo/x-tag-components.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC94LXRhZy92aWV3L2RlbW8veC10YWctY29tcG9uZW50cy5qcyBIVFRQLzEuMQ0KSG9zdDogbG9jYWxob3N0Ojk5OTkNCg0K",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogNjY1OTMNCkFjY2VwdC1SYW5nZXM6IGJ5dGVzDQpDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2phdmFzY3JpcHQNCkRhdGU6IFN1biwgMDkgTm92IDIwMTQgMDM6NDc6NDEgR01UDQpMYXN0LU1vZGlmaWVkOiBTdW4sIDA5IE5vdiAyMDE0IDAzOjQ3OjQxIEdNVA0KDQovLyBXZSBkb24ndCB1c2UgdGhlIHBsYXRmb3JtIGJvb3RzdHJhcHBlciwgc28gZmFrZSB0aGlzIHN0dWZmLgoKd2luZG93LlBsYXRmb3JtID0ge307CnZhciBsb2dGbGFncyA9IHt9OwovKgogKiBDb3B5cmlnaHQgMjAxMiBUaGUgUG9seW1lciBBdXRob3JzLiBBbGwgcmlnaHRzIHJlc2VydmVkLgogKiBVc2Ugb2YgdGhpcyBzb3VyY2UgY29kZSBpcyBnb3ZlcmVuZWQgYnkgYSBCU0Qtc3R5bGUKICogbGljZW5zZSB0aGF0IGNhbiBiZSBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlLgogKi8KCi8vIFNpZGVUYWJsZSBpcyBhIHdlYWsgbWFwIHdoZXJlIHBvc3NpYmxlLiBJZiBXZWFrTWFwIGlzIG5vdCBhdmFpbGFibGUgdGhlCi8vIGFzc29jaWF0aW9uIGlzIHN0b3JlZCBhcyBhbiBleHBhbmRvIHByb3BlcnR5Lgp2YXIgU2lkZVRhYmxlOwovLyBUT0RPKGFydik6IFdlYWtNYXAgZG9lcyBub3QgYWxsb3cgZm9yIE5vZGUgZXRjIHRvIGJlIGtleXMgaW4gRmlyZWZveAppZiAodHlwZW9mIFdlYWtNYXAgIT09ICd1bmRlZmluZWQnICYmIG5hdmlnYXRvci51c2VyQWdlbnQuaW5kZXhPZignRmlyZWZveC8nKSA8IDApIHsKICBTaWRlVGFibGUgPSBXZWFrTWFwOwp9IGVsc2UgewogIChmdW5jdGlvbigpIHsKICAgIHZhciBkZWZpbmVQcm9wZXJ0eSA9IE9iamVjdC5kZWZpbmVQcm9wZXJ0eTsKICAgIHZhciBoYXNPd25Qcm9wZXJ0eSA9IE9iamVjdC5oYXNPd25Qcm9wZXJ0eTsKICAgIHZhciBjb3VudGVyID0gbmV3IERhdGUoKS5nZXRUaW1lKCkgJSAxZTk7CgogICAgU2lkZVRhYmxlID0gZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMubmFtZSA9ICdfX3N0JyArIChNYXRoLnJhbmRvbSgpICogMWU5ID4+PiAwKSArIChjb3VudGVyKysgKyAnX18nKTsKICAgIH07CgogICAgU2lkZVRhYmxlLnByb3RvdHlwZSA9IHsKICAgICAgc2V0OiBmdW5jdGlvbihrZXksIHZhbHVlKSB7CiAgICAgICAgZGVmaW5lUHJvcGVydHkoa2V5LCB0aGlzLm5hbWUsIHt2YWx1ZTogdmFsdWUsIHdyaXRhYmxlOiB0cnVlfSk7CiAgICAgIH0sCiAgICAgIGdldDogZnVuY3Rpb24oa2V5KSB7CiAgICAgICAgcmV0dXJuIGhhc093blByb3BlcnR5LmNhbGwoa2V5LCB0aGlzLm5hbWUpID8ga2V5W3RoaXMubmFtZV0gOiB1bmRlZmluZWQ7CiAgICAgIH0sCiAgICAgIGRlbGV0ZTogZnVuY3Rpb24oa2V5KSB7CiAgICAgICAgdGhpcy5zZXQoa2V5LCB1bmRlZmluZWQpOwogICAgICB9CiAgICB9CiAgfSkoKTsKfQoKLyoKICogQ29weXJpZ2h0IDIwMTMgVGhlIFBvbHltZXIgQXV0aG9ycy4gQWxsIHJpZ2h0cyByZXNlcnZlZC4KICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYSBCU0Qtc3R5bGUKICogbGljZW5zZSB0aGF0IGNhbiBiZSBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlLgogKi8KKGZ1bmN0aW9uKCkgewogIAogIC8vIHBvb3IgbWFuJ3MgYWRhcHRlciBmb3IgdGVtcGxhdGUuY29udGVudCBvbiB2YXJpb3VzIHBsYXRmb3JtIHNjZW5hcmlvcwogIHdpbmRvdy50ZW1wbGF0ZUNvbnRlbnQgPSB3aW5kb3cudGVtcGxhdGVDb250ZW50IHx8IGZ1bmN0aW9uKGluVGVtcGxhdGUpIHsKICAgIHJldHVybiBpblRlbXBsYXRlLmNvbnRlbnQ7CiAgfTsKCiAgLy8gc28gd2UgY2FuIGNhbGwgd3JhcC91bndyYXAgd2l0aG91dCB0ZXN0aW5nIGZvciBTaGFkb3dET01Qb2x5ZmlsbAoKICB3aW5kb3cud3JhcCA9IHdpbmRvdy51bndyYXAgPSBmdW5jdGlvbihuKXsKICAgIHJldHVybiBuOwogIH0KCiAgd2luZG93LmNyZWF0ZVNoYWRvd1Jvb3QgPSBmdW5jdGlvbihpbkVsZW1lbnQpIHsKICAgIHJldHVybiBpbkVsZW1lbnQud2Via2l0Q3JlYXRlU2hhZG93Um9vdCgpOwogIH07CgogIHdpbmRvdy50ZW1wbGF0ZUNvbnRlbnQgPSBmdW5jdGlvbihpblRlbXBsYXRlKSB7CiAgICAvLyBpZiBNRFYgZXhpc3RzLCBpdCBtYXkgbmVlZCB0byBib29zdHJhcCB0aGlzIHRlbXBsYXRlIHRvIHJldmVhbCBjb250ZW50CiAgICBpZiAod2luZG93LkhUTUxUZW1wbGF0ZUVsZW1lbnQgJiYgSFRNTFRlbXBsYXRlRWxlbWVudC5ib290c3RyYXApIHsKICAgICAgSFRNTFRlbXBsYXRlRWxlbWVudC5ib290c3RyYXAoaW5UZW1wbGF0ZSk7CiAgICB9CiAgICAvLyBmYWxsYmFjayB3aGVuIHRoZXJlIGlzIG5vIFNoYWRvdyBET00gcG9seWZpbGwsIG5vIE1EViBwb2x5ZmlsbCwgYW5kIG5vCiAgICAvLyBuYXRpdmUgdGVtcGxhdGUgc3VwcG9ydAogICAgaWYgKCFpblRlbXBsYXRlLmNvbnRlbnQgJiYgIWluVGVtcGxhdGUuX2NvbnRlbnQpIHsKICAgICAgdmFyIGZyYWcgPSBkb2N1bWVudC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCk7CiAgICAgIHdoaWxlIChpblRlbXBsYXRlLmZpcnN0Q2hpbGQpIHsKICAgICAgICBmcmFnLmFwcGVuZENoaWxkKGluVGVtcGxhdGUuZmlyc3RDaGlsZCk7CiAgICAgIH0KICAgICAgaW5UZW1wbGF0ZS5fY29udGVudCA9IGZyYWc7CiAgICB9CiAgICByZXR1cm4gaW5UZW1wbGF0ZS5jb250ZW50IHx8IGluVGVtcGxhdGUuX2NvbnRlbnQ7CiAgfTsKCn0pKCk7Ci8qCiAqIENvcHlyaWdodCAyMDEzIFRoZSBQb2x5bWVyIEF1dGhvcnMuIEFsbCByaWdodHMgcmVzZXJ2ZWQuCiAqIFVzZSBvZiB0aGlzIHNvdXJjZSBjb2RlIGlzIGdvdmVybmVkIGJ5IGEgQlNELXN0eWxlCiAqIGxpY2Vuc2UgdGhhdCBjYW4gYmUgZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZS4KICovCgooZnVuY3Rpb24oc2NvcGUpIHsKCi8vIE9sZCB2ZXJzaW9ucyBvZiBpT1MgZG8gbm90IGhhdmUgYmluZC4KCmlmICghRnVuY3Rpb24ucHJvdG90eXBlLmJpbmQpIHsKICBGdW5jdGlvbi5wcm90b3R5cGUuYmluZCA9IGZ1bmN0aW9uKHNjb3BlKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBhcmdzMiA9IGFyZ3Muc2xpY2UoKTsKICAgICAgYXJnczIucHVzaC5hcHBseShhcmdzMiwgYXJndW1lbnRzKTsKICAgICAgcmV0dXJuIHNlbGYuYXBwbHkoc2NvcGUsIGFyZ3MyKTsKICAgIH07CiAgfTsKfQoKLy8gbmFtZXNwYWNlIGFuIGltcG9ydCBmcm9tIEN1c3RvbUVsZW1lbnRzCi8vIFRPRE8oc2ptaWxlcyk6IGNsZWFuIHVwIHRoaXMgZ2xvYmFsCnNjb3BlLm1peGluID0gd2luZG93Lm1peGluOwoKfSkod2luZG93LlBsYXRmb3JtKTsKLy8gQ29weXJpZ2h0IDIwMTEgR29vZ2xlIEluYy4KLy8KLy8gTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlICJMaWNlbnNlIik7Ci8vIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS4KLy8gWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0Ci8vCi8vICAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjAKLy8KLy8gVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZQovLyBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiAiQVMgSVMiIEJBU0lTLAovLyBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC4KLy8gU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZAovLyBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4KCihmdW5jdGlvbihzY29wZSkgewoKICAndXNlIHN0cmljdCc7CgogIC8vIHBvbHlmaWxsIERPTVRva2VuTGlzdAogIC8vICogYWRkL3JlbW92ZTogYWxsb3cgdGhlc2UgbWV0aG9kcyB0byB0YWtlIG11bHRpcGxlIGNsYXNzTmFtZXMKICAvLyAqIHRvZ2dsZTogYWRkIGEgMm5kIGFyZ3VtZW50IHdoaWNoIGZvcmNlcyB0aGUgZ2l2ZW4gc3RhdGUgcmF0aGVyCiAgLy8gIHRoYW4gdG9nZ2xpbmcuCgogIHZhciBhZGQgPSBET01Ub2tlbkxpc3QucHJvdG90eXBlLmFkZDsKICB2YXIgcmVtb3ZlID0gRE9NVG9rZW5MaXN0LnByb3RvdHlwZS5yZW1vdmU7CiAgRE9NVG9rZW5MaXN0LnByb3RvdHlwZS5hZGQgPSBmdW5jdGlvbigpIHsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYXJndW1lbnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGFkZC5jYWxsKHRoaXMsIGFyZ3VtZW50c1tpXSk7CiAgICB9CiAgfTsKICBET01Ub2tlbkxpc3QucHJvdG90eXBlLnJlbW92ZSA9IGZ1bmN0aW9uKCkgewogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcmd1bWVudHMubGVuZ3RoOyBpKyspIHsKICAgICAgcmVtb3ZlLmNhbGwodGhpcywgYXJndW1lbnRzW2ldKTsKICAgIH0KICB9OwogIERPTVRva2VuTGlzdC5wcm90b3R5cGUudG9nZ2xlID0gZnVuY3Rpb24obmFtZSwgYm9vbCkgewogICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT0gMSkgewogICAgICBib29sID0gIXRoaXMuY29udGFpbnMobmFtZSk7CiAgICB9CiAgICBib29sID8gdGhpcy5hZGQobmFtZSkgOiB0aGlzLnJlbW92ZShuYW1lKTsKICB9OwogIERPTVRva2VuTGlzdC5wcm90b3R5cGUuc3dpdGNoID0gZnVuY3Rpb24ob2xkTmFtZSwgbmV3TmFtZSkgewogICAgb2xkTmFtZSAmJiB0aGlzLnJlbW92ZShvbGROYW1lKTsKICAgIG5ld05hbWUgJiYgdGhpcy5hZGQobmV3TmFtZSk7CiAgfTsKICAKICAvLyBtYWtlIGZvckVhY2ggd29yayBvbiBOb2RlTGlzdAoKICBOb2RlTGlzdC5wcm90b3R5cGUuZm9yRWFjaCA9IGZ1bmN0aW9uKGNiLCBjb250ZXh0KSB7CiAgICBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbCh0aGlzKS5mb3JFYWNoKGNiLCBjb250ZXh0KTsKICB9OwoKICBIVE1MQ29sbGVjdGlvbi5wcm90b3R5cGUuZm9yRWFjaCA9IGZ1bmN0aW9uKGNiLCBjb250ZXh0KSB7CiAgICBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbCh0aGlzKS5mb3JFYWNoKGNiLCBjb250ZXh0KTsKICB9OwoKICAvLyBwb2x5ZmlsbCBwZXJmb3JtYW5jZS5ub3cKCiAgaWYgKCF3aW5kb3cucGVyZm9ybWFuY2UpIHsKICAgIHZhciBzdGFydCA9IERhdGUubm93KCk7CiAgICAvLyBvbmx5IGF0IG1pbGxpc2Vjb25kIHByZWNpc2lvbgogICAgd2luZG93LnBlcmZvcm1hbmNlID0ge25vdzogZnVuY3Rpb24oKXsgcmV0dXJuIERhdGUubm93KCkgLSBzdGFydCB9fTsKICB9CgogIC8vIHBvbHlmaWxsIGZvciByZXF1ZXN0QW5pbWF0aW9uRnJhbWUKCiAgaWYgKCF3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lKSB7CiAgICB3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lID0gKGZ1bmN0aW9uKCkgewogICAgICB2YXIgbmF0aXZlUmFmID0gd2luZG93LndlYmtpdFJlcXVlc3RBbmltYXRpb25GcmFtZSB8fAogICAgICAgIHdpbmRvdy5tb3pSZXF1ZXN0QW5pbWF0aW9uRnJhbWU7CgogICAgICByZXR1cm4gbmF0aXZlUmFmID8KICAgICAgICBmdW5jdGlvbihjYWxsYmFjaykgewogICAgICAgICAgcmV0dXJuIG5hdGl2ZVJhZihmdW5jdGlvbigpIHsKICAgICAgICAgICAgY2FsbGJhY2socGVyZm9ybWFuY2Uubm93KCkpOwogICAgICAgICAgfSk7CiAgICAgICAgfSA6CiAgICAgICAgZnVuY3Rpb24oIGNhbGxiYWNrICl7CiAgICAgICAgICByZXR1cm4gd2luZG93LnNldFRpbWVvdXQoY2FsbGJhY2ssIDEwMDAgLyA2MCk7CiAgICAgICAgfTsKICAgIH0pKCk7CiAgfQoKICBpZiAoIXdpbmRvdy5jYW5jZWxBbmltYXRpb25GcmFtZSkgewogICAgd2luZG93LmNhbmNlbEFuaW1hdGlvbkZyYW1lID0gKGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gIHdpbmRvdy53ZWJraXRDYW5jZWxBbmltYXRpb25GcmFtZSB8fAogICAgICAgIHdpbmRvdy5tb3pDYW5jZWxBbmltYXRpb25GcmFtZSB8fAogICAgICAgIGZ1bmN0aW9uKGlkKSB7CiAgICAgICAgICBjbGVhclRpbWVvdXQoaWQpOwogICAgICAgIH07CiAgICB9KSgpOwogIH0KCiAgLy8gdXRpbGl0eQoKICBmdW5jdGlvbiBjcmVhdGVET00oaW5UYWdPck5vZGUsIGluSFRNTCwgaW5BdHRycykgewogICAgdmFyIGRvbSA9IHR5cGVvZiBpblRhZ09yTm9kZSA9PSAnc3RyaW5nJyA/IAogICAgICAgIGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoaW5UYWdPck5vZGUpIDogaW5UYWdPck5vZGUuY2xvbmVOb2RlKHRydWUpOwogICAgZG9tLmlubmVySFRNTCA9IGluSFRNTDsKICAgIGlmIChpbkF0dHJzKSB7CiAgICAgIGZvciAodmFyIG4gaW4gaW5BdHRycykgewogICAgICAgIGRvbS5zZXRBdHRyaWJ1dGUobiwgaW5BdHRyc1tuXSk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBkb207CiAgfQoKICAvLyBleHBvcnRzCgogIHNjb3BlLmNyZWF0ZURPTSA9IGNyZWF0ZURPTTsKCn0pKHdpbmRvdy5QbGF0Zm9ybSk7CgovKgogKiBDb3B5cmlnaHQgMjAxMyBUaGUgUG9seW1lciBBdXRob3JzLiBBbGwgcmlnaHRzIHJlc2VydmVkLgogKiBVc2Ugb2YgdGhpcyBzb3VyY2UgY29kZSBpcyBnb3Zlcm5lZCBieSBhIEJTRC1zdHlsZQogKiBsaWNlbnNlIHRoYXQgY2FuIGJlIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUuCiAqLwoKLy8gcG9vciBtYW4ncyBhZGFwdGVyIGZvciB0ZW1wbGF0ZS5jb250ZW50IG9uIHZhcmlvdXMgcGxhdGZvcm0gc2NlbmFyaW9zCndpbmRvdy50ZW1wbGF0ZUNvbnRlbnQgPSB3aW5kb3cudGVtcGxhdGVDb250ZW50IHx8IGZ1bmN0aW9uKGluVGVtcGxhdGUpIHsKICByZXR1cm4gaW5UZW1wbGF0ZS5jb250ZW50Owp9OwovKgogKiBDb3B5cmlnaHQgMjAxMyBUaGUgUG9seW1lciBBdXRob3JzLiBBbGwgcmlnaHRzIHJlc2VydmVkLgogKiBVc2Ugb2YgdGhpcyBzb3VyY2UgY29kZSBpcyBnb3Zlcm5lZCBieSBhIEJTRC1zdHlsZQogKiBsaWNlbnNlIHRoYXQgY2FuIGJlIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUuCiAqLwoKKGZ1bmN0aW9uKHNjb3BlKSB7CgppZiAoIXNjb3BlKSB7CiAgc2NvcGUgPSB3aW5kb3cuSFRNTEltcG9ydHMgPSB7ZmxhZ3M6e319Owp9Cgp2YXIgSU1QT1JUX0xJTktfVFlQRSA9ICdpbXBvcnQnOwoKLy8gaGlnaGxhbmRlciBvYmplY3QgcmVwcmVzZW50cyBhIHByaW1hcnkgZG9jdW1lbnQgKHRoZSBhcmd1bWVudCB0byAncGFyc2UnKQovLyBhdCB0aGUgcm9vdCBvZiBhIHRyZWUgb2YgZG9jdW1lbnRzCgp2YXIgaW1wb3J0ZXIgPSB7CiAgZG9jdW1lbnRzOiB7fSwKICBjYWNoZToge30sCiAgcHJlbG9hZFNlbGVjdG9yczogWwogICAgJ2xpbmtbcmVsPScgKyBJTVBPUlRfTElOS19UWVBFICsgJ10nLAogICAgJ3NjcmlwdFtzcmNdJywKICAgICdsaW5rW3JlbD1zdHlsZXNoZWV0XScKICBdLmpvaW4oJywnKSwKICBsb2FkOiBmdW5jdGlvbihpbkRvY3VtZW50LCBpbk5leHQpIHsKICAgIC8vIGNvbnN0cnVjdCBhIGxvYWRlciBpbnN0YW5jZQogICAgbG9hZGVyID0gbmV3IExvYWRlcihpbXBvcnRlci5sb2FkZWQsIGluTmV4dCk7CiAgICAvLyBhbGlhcyB0aGUgbG9hZGVyIGNhY2hlIChmb3IgZGVidWdnaW5nKQogICAgbG9hZGVyLmNhY2hlID0gaW1wb3J0ZXIuY2FjaGU7CiAgICAvLyBhZGQgbm9kZXMgZnJvbSBkb2N1bWVudCBpbnRvIGxvYWRlciBxdWV1ZQogICAgaW1wb3J0ZXIucHJlbG9hZChpbkRvY3VtZW50KTsKICB9LAogIHByZWxvYWQ6IGZ1bmN0aW9uKGluRG9jdW1lbnQpIHsKICAgIC8vIGFsbCBwcmVsb2FkYWJsZSBub2RlcyBpbiBpbkRvY3VtZW50CiAgICB2YXIgbm9kZXMgPSBpbkRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoaW1wb3J0ZXIucHJlbG9hZFNlbGVjdG9ycyk7CiAgICAvLyBvbmx5IGxvYWQgaW1wb3J0cyBmcm9tIHRoZSBtYWluIGRvY3VtZW50CiAgICAvLyBUT0RPKHNqbWlsZXMpOiBkbyB0aGlzIGJ5IGFsdGVyaW5nIHRoZSBzZWxlY3RvciBsaXN0IGluc3RlYWQKICAgIGlmIChpbkRvY3VtZW50ID09PSBkb2N1bWVudCkgewogICAgICBub2RlcyA9IEFycmF5LnByb3RvdHlwZS5maWx0ZXIuY2FsbChub2RlcywgZnVuY3Rpb24obikgewogICAgICAgIHJldHVybiBpc0RvY3VtZW50TGluayhuKTsKICAgICAgfSk7CiAgICB9CiAgICAvLyBhZGQgdGhlc2Ugbm9kZXMgdG8gbG9hZGVyJ3MgcXVldWUKICAgIGxvYWRlci5hZGROb2Rlcyhub2Rlcyk7CiAgfSwKICBsb2FkZWQ6IGZ1bmN0aW9uKGluVXJsLCBpbkVsdCwgaW5SZXNvdXJjZSkgewogICAgaWYgKGlzRG9jdW1lbnRMaW5rKGluRWx0KSkgewogICAgICB2YXIgZG9jdW1lbnQgPSBpbXBvcnRlci5kb2N1bWVudHNbaW5VcmxdOwogICAgICAvLyBpZiB3ZSd2ZSBuZXZlciBzZWVuIGEgZG9jdW1lbnQgYXQgdGhpcyB1cmwKICAgICAgaWYgKCFkb2N1bWVudCkgewogICAgICAgIC8vIGdlbmVyYXRlIGFuIEhUTUxEb2N1bWVudCBmcm9tIGRhdGEKICAgICAgICBkb2N1bWVudCA9IG1ha2VEb2N1bWVudChpblJlc291cmNlLCBpblVybCk7CiAgICAgICAgLy8gcmVzb2x2ZSByZXNvdXJjZSBwYXRocyByZWxhdGl2ZSB0byBob3N0IGRvY3VtZW50CiAgICAgICAgcGF0aC5yZXNvbHZlUGF0aHNJbkhUTUwoZG9jdW1lbnQpOwogICAgICAgIC8vIGNhY2hlIGRvY3VtZW50CiAgICAgICAgaW1wb3J0ZXIuZG9jdW1lbnRzW2luVXJsXSA9IGRvY3VtZW50OwogICAgICAgIC8vIGFkZCBub2RlcyBmcm9tIHRoaXMgZG9jdW1lbnQgdG8gdGhlIGxvYWRlciBxdWV1ZQogICAgICAgIGltcG9ydGVyLnByZWxvYWQoZG9jdW1lbnQpOwogICAgICB9CiAgICAgIC8vIHN0b3JlIGRvY3VtZW50IHJlc291cmNlCiAgICAgIGluRWx0LmNvbnRlbnQgPSBpbkVsdC5fX3Jlc291cmNlID0gZG9jdW1lbnQ7CiAgICB9IGVsc2UgewogICAgICBpbkVsdC5fX3Jlc291cmNlID0gaW5SZXNvdXJjZTsKICAgICAgLy8gcmVzb2x2ZSBzdHlsZXNoZWV0IHJlc291cmNlIHBhdGhzIHJlbGF0aXZlIHRvIGhvc3QgZG9jdW1lbnQKICAgICAgaWYgKGlzU3R5bGVzaGVldExpbmsoaW5FbHQpKSB7CiAgICAgICAgcGF0aC5yZXNvbHZlUGF0aHNJblN0eWxlc2hlZXQoaW5FbHQpOwogICAgICB9CiAgICB9CiAgfQp9OwoKZnVuY3Rpb24gaXNEb2N1bWVudExpbmsoaW5FbHQpIHsKICByZXR1cm4gaXNMaW5rUmVsKGluRWx0LCBJTVBPUlRfTElOS19UWVBFKTsKfQoKZnVuY3Rpb24gaXNTdHlsZXNoZWV0TGluayhpbkVsdCkgewogIHJldHVybiBpc0xpbmtSZWwoaW5FbHQsICdzdHlsZXNoZWV0Jyk7Cn0KCmZ1bmN0aW9uIGlzTGlua1JlbChpbkVsdCwgaW5SZWwpIHsKICByZXR1cm4gKGluRWx0LmxvY2FsTmFtZSA9PT0gJ2xpbmsnICYmIGluRWx0LmdldEF0dHJpYnV0ZSgncmVsJykgPT09IGluUmVsKTsKfQoKZnVuY3Rpb24gaW5NYWluRG9jdW1lbnQoaW5FbHQpIHsKICByZXR1cm4gaW5FbHQub3duZXJEb2N1bWVudCA9PT0gZG9jdW1lbnQgfHwKICAgIC8vIFRPRE8oc2ptaWxlcyk6IFNoYWRvd0RPTVBvbHlmaWxsIGludHJ1c2lvbgogICAgaW5FbHQub3duZXJEb2N1bWVudC5pbXBsID09PSBkb2N1bWVudDsKfQoKZnVuY3Rpb24gbWFrZURvY3VtZW50KGluSFRNTCwgaW5VcmwpIHsKICAvLyBjcmVhdGUgYSBuZXcgSFRNTCBkb2N1bWVudAogIHZhciBkb2MgPSBkb2N1bWVudC5pbXBsZW1lbnRhdGlvbi5jcmVhdGVIVE1MRG9jdW1lbnQoSU1QT1JUX0xJTktfVFlQRSk7CiAgLy8gY2FjaGUgdGhlIG5ldyBkb2N1bWVudCdzIHNvdXJjZSB1cmwKICBkb2MuX1VSTCA9IGluVXJsOwogIC8vIGVzdGFibGlzaCBhIHJlbGF0aXZlIHBhdGggdmlhIDxiYXNlPgogIHZhciBiYXNlID0gZG9jLmNyZWF0ZUVsZW1lbnQoJ2Jhc2UnKTsKICBiYXNlLnNldEF0dHJpYnV0ZSgnaHJlZicsIGRvY3VtZW50LmJhc2VVUkkpOwogIGRvYy5oZWFkLmFwcGVuZENoaWxkKGJhc2UpOwogIC8vIGluc3RhbGwgaHRtbAogIGRvYy5ib2R5LmlubmVySFRNTCA9IGluSFRNTDsKICByZXR1cm4gZG9jOwp9Cgp2YXIgbG9hZGVyOwoKdmFyIExvYWRlciA9IGZ1bmN0aW9uKGluT25Mb2FkLCBpbk9uQ29tcGxldGUpIHsKICB0aGlzLm9ubG9hZCA9IGluT25Mb2FkOwogIHRoaXMub25jb21wbGV0ZSA9IGluT25Db21wbGV0ZTsKICB0aGlzLmluZmxpZ2h0ID0gMDsKICB0aGlzLnBlbmRpbmcgPSB7fTsKICB0aGlzLmNhY2hlID0ge307Cn07CgpMb2FkZXIucHJvdG90eXBlID0gewogIGFkZE5vZGVzOiBmdW5jdGlvbihpbk5vZGVzKSB7CiAgICAvLyBudW1iZXIgb2YgdHJhbnNhY3Rpb25zIHRvIGNvbXBsZXRlCiAgICB0aGlzLmluZmxpZ2h0ICs9IGluTm9kZXMubGVuZ3RoOwogICAgLy8gY29tbWVuY2UgdHJhbnNhY3Rpb25zCiAgICBmb3JFYWNoKGluTm9kZXMsIHRoaXMucmVxdWlyZSwgdGhpcyk7CiAgICAvLyBhbnl0aGluZyB0byBkbz8KICAgIHRoaXMuY2hlY2tEb25lKCk7CiAgfSwKICByZXF1aXJlOiBmdW5jdGlvbihpbkVsdCkgewogICAgdmFyIHVybCA9IHBhdGgubm9kZVVybChpbkVsdCk7CiAgICAvLyBUT0RPKHNqbWlsZXMpOiBhZC1ob2MKICAgIGluRWx0Ll9fbm9kZVVybCA9IHVybDsKICAgIC8vIGRlZHVwbGljYXRpb24KICAgIGlmICghdGhpcy5kZWR1cGUodXJsLCBpbkVsdCkpIHsKICAgICAgLy8gZmV0Y2ggdGhpcyByZXNvdXJjZQogICAgICB0aGlzLmZldGNoKHVybCwgaW5FbHQpOwogICAgfQogIH0sCiAgZGVkdXBlOiBmdW5jdGlvbihpblVybCwgaW5FbHQpIHsKICAgIGlmICh0aGlzLnBlbmRpbmdbaW5VcmxdKSB7CiAgICAgIC8vIGFkZCB0byBsaXN0IG9mIG5vZGVzIHdhaXRpbmcgZm9yIGluVXJsCiAgICAgIHRoaXMucGVuZGluZ1tpblVybF0ucHVzaChpbkVsdCk7CiAgICAgIC8vIGRvbid0IG5lZWQgZmV0Y2gKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICBpZiAodGhpcy5jYWNoZVtpblVybF0pIHsKICAgICAgLy8gY29tcGxldGUgbG9hZCB1c2luZyBjYWNoZSBkYXRhCiAgICAgIHRoaXMub25sb2FkKGluVXJsLCBpbkVsdCwgbG9hZGVyLmNhY2hlW2luVXJsXSk7CiAgICAgIC8vIGZpbmlzaGVkIHRoaXMgdHJhbnNhY3Rpb24KICAgICAgdGhpcy50YWlsKCk7CiAgICAgIC8vIGRvbid0IG5lZWQgZmV0Y2gKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICAvLyBmaXJzdCBub2RlIHdhaXRpbmcgZm9yIGluVXJsCiAgICB0aGlzLnBlbmRpbmdbaW5VcmxdID0gW2luRWx0XTsKICAgIC8vIG5lZWQgZmV0Y2ggKG5vdCBhIGR1cGUpCiAgICByZXR1cm4gZmFsc2U7CiAgfSwKICBmZXRjaDogZnVuY3Rpb24oaW5VcmwsIGluRWx0KSB7CiAgICB4aHIubG9hZChpblVybCwgZnVuY3Rpb24oZXJyLCByZXNvdXJjZSkgewogICAgICB0aGlzLnJlY2VpdmUoaW5VcmwsIGluRWx0LCBlcnIsIHJlc291cmNlKTsKICAgIH0uYmluZCh0aGlzKSk7CiAgfSwKICByZWNlaXZlOiBmdW5jdGlvbihpblVybCwgaW5FbHQsIGluRXJyLCBpblJlc291cmNlKSB7CiAgICBpZiAoIWluRXJyKSB7CiAgICAgIGxvYWRlci5jYWNoZVtpblVybF0gPSBpblJlc291cmNlOwogICAgfQogICAgbG9hZGVyLnBlbmRpbmdbaW5VcmxdLmZvckVhY2goZnVuY3Rpb24oZSkgewogICAgICBpZiAoIWluRXJyKSB7CiAgICAgICAgdGhpcy5vbmxvYWQoaW5VcmwsIGUsIGluUmVzb3VyY2UpOwogICAgICB9CiAgICAgIHRoaXMudGFpbCgpOwogICAgfSwgdGhpcyk7CiAgICBsb2FkZXIucGVuZGluZ1tpblVybF0gPSBudWxsOwogIH0sCiAgdGFpbDogZnVuY3Rpb24oKSB7CiAgICAtLXRoaXMuaW5mbGlnaHQ7CiAgICB0aGlzLmNoZWNrRG9uZSgpOwogIH0sCiAgY2hlY2tEb25lOiBmdW5jdGlvbigpIHsKICAgIGlmICghdGhpcy5pbmZsaWdodCkgewogICAgICB0aGlzLm9uY29tcGxldGUoKTsKICAgIH0KICB9Cn07Cgp2YXIgcGF0aCA9IHsKICBub2RlVXJsOiBmdW5jdGlvbihpbk5vZGUpIHsKICAgIHJldHVybiBwYXRoLnJlc29sdmVVcmwocGF0aC5nZXREb2N1bWVudFVybChkb2N1bWVudCksIHBhdGguaHJlZk9yU3JjKGluTm9kZSkpOwogIH0sCiAgaHJlZk9yU3JjOiBmdW5jdGlvbihpbk5vZGUpIHsKICAgIHJldHVybiBpbk5vZGUuZ2V0QXR0cmlidXRlKCJocmVmIikgfHwgaW5Ob2RlLmdldEF0dHJpYnV0ZSgic3JjIik7CiAgfSwKICBkb2N1bWVudFVybEZyb21Ob2RlOiBmdW5jdGlvbihpbk5vZGUpIHsKICAgIHJldHVybiBwYXRoLmdldERvY3VtZW50VXJsKGluTm9kZS5vd25lckRvY3VtZW50KTsKICB9LAogIGdldERvY3VtZW50VXJsOiBmdW5jdGlvbihpbkRvY3VtZW50KSB7CiAgICB2YXIgdXJsID0gaW5Eb2N1bWVudCAmJgogICAgICAgIC8vIFRPRE8oc2ptaWxlcyk6IFNoYWRvd0RPTVBvbHlmaWxsIGludHJ1c2lvbgogICAgICAgIChpbkRvY3VtZW50Ll9VUkwgfHwgKGluRG9jdW1lbnQuaW1wbCAmJiBpbkRvY3VtZW50LmltcGwuX1VSTCkKICAgICAgICAgICAgfHwgaW5Eb2N1bWVudC5iYXNlVVJJIHx8IGluRG9jdW1lbnQuVVJMKQogICAgICAgICAgICAgICAgfHwgJyc7CiAgICAvLyB0YWtlIG9ubHkgdGhlIGxlZnQgc2lkZSBpZiB0aGVyZSBpcyBhICMKICAgIHJldHVybiB1cmwuc3BsaXQoJyMnKVswXTsKICB9LAogIHJlc29sdmVVcmw6IGZ1bmN0aW9uKGluQmFzZVVybCwgaW5VcmwsIGluUmVsYXRpdmVUb0RvY3VtZW50KSB7CiAgICBpZiAodGhpcy5pc0Fic1VybChpblVybCkpIHsKICAgICAgcmV0dXJuIGluVXJsOwogICAgfQogICAgdmFyIHVybCA9IHRoaXMuY29tcHJlc3NVcmwodGhpcy51cmxUb1BhdGgoaW5CYXNlVXJsKSArIGluVXJsKTsKICAgIGlmIChpblJlbGF0aXZlVG9Eb2N1bWVudCkgewogICAgICB1cmwgPSBwYXRoLm1ha2VSZWxQYXRoKHBhdGguZ2V0RG9jdW1lbnRVcmwoZG9jdW1lbnQpLCB1cmwpOwogICAgfQogICAgcmV0dXJuIHVybDsKICB9LAogIGlzQWJzVXJsOiBmdW5jdGlvbihpblVybCkgewogICAgcmV0dXJuIC8oXmRhdGE6KXwoXmh0dHBbc10/Oil8KF5cLykvLnRlc3QoaW5VcmwpOwogIH0sCiAgdXJsVG9QYXRoOiBmdW5jdGlvbihpbkJhc2VVcmwpIHsKICAgIHZhciBwYXJ0cyA9IGluQmFzZVVybC5zcGxpdCgiLyIpOwogICAgcGFydHMucG9wKCk7CiAgICBwYXJ0cy5wdXNoKCcnKTsKICAgIHJldHVybiBwYXJ0cy5qb2luKCIvIik7CiAgfSwKICBjb21wcmVzc1VybDogZnVuY3Rpb24oaW5VcmwpIHsKICAgIHZhciBwYXJ0cyA9IGluVXJsLnNwbGl0KCIvIik7CiAgICBmb3IgKHZhciBpPTAsIHA7IGk8cGFydHMubGVuZ3RoOyBpKyspIHsKICAgICAgcCA9IHBhcnRzW2ldOwogICAgICBpZiAocCA9PT0gIi4uIikgewogICAgICAgIHBhcnRzLnNwbGljZShpLTEsIDIpOwogICAgICAgIGkgLT0gMjsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHBhcnRzLmpvaW4oIi8iKTsKICB9LAogIC8vIG1ha2UgYSByZWxhdGl2ZSBwYXRoIGZyb20gc291cmNlIHRvIHRhcmdldAogIG1ha2VSZWxQYXRoOiBmdW5jdGlvbihpblNvdXJjZSwgaW5UYXJnZXQpIHsKICAgIHZhciBzLCB0OwogICAgcyA9IHRoaXMuY29tcHJlc3NVcmwoaW5Tb3VyY2UpLnNwbGl0KCIvIik7CiAgICB0ID0gdGhpcy5jb21wcmVzc1VybChpblRhcmdldCkuc3BsaXQoIi8iKTsKICAgIHdoaWxlIChzLmxlbmd0aCAmJiBzWzBdID09PSB0WzBdKXsKICAgICAgcy5zaGlmdCgpOwogICAgICB0LnNoaWZ0KCk7CiAgICB9CiAgICBmb3IodmFyIGkgPSAwLCBsID0gcy5sZW5ndGgtMTsgaSA8IGw7IGkrKykgewogICAgICB0LnVuc2hpZnQoIi4uIik7CiAgICB9CiAgICB2YXIgciA9IHQuam9pbigiLyIpOwogICAgcmV0dXJuIHI7CiAgfSwKICByZXNvbHZlUGF0aHNJbkhUTUw6IGZ1bmN0aW9uKGluUm9vdCkgewogICAgdmFyIGRvY1VybCA9IHBhdGguZG9jdW1lbnRVcmxGcm9tTm9kZShpblJvb3QuYm9keSk7CiAgICAvLyBUT0RPKHNvcnZlbGwpOiBNRFYgUG9seWZpbGwgSW50cnVzaW9uCiAgICBpZiAod2luZG93LkhUTUxUZW1wbGF0ZUVsZW1lbnQgJiYgSFRNTFRlbXBsYXRlRWxlbWVudC5ib290c3RyYXApIHsKICAgICAgSFRNTFRlbXBsYXRlRWxlbWVudC5ib290c3RyYXAoaW5Sb290KTsKICAgIH0KICAgIHZhciBub2RlID0gaW5Sb290LmJvZHk7CiAgICBwYXRoLl9yZXNvbHZlUGF0aHNJbkhUTUwobm9kZSwgZG9jVXJsKTsKICB9LAogIF9yZXNvbHZlUGF0aHNJbkhUTUw6IGZ1bmN0aW9uKGluUm9vdCwgaW5VcmwpIHsKICAgIHBhdGgucmVzb2x2ZUF0dHJpYnV0ZXMoaW5Sb290LCBpblVybCk7CiAgICBwYXRoLnJlc29sdmVTdHlsZUVsdHMoaW5Sb290LCBpblVybCk7CiAgICAvLyBoYW5kbGUgdGVtcGxhdGVzLCBpZiBzdXBwb3J0ZWQKICAgIGlmICh3aW5kb3cudGVtcGxhdGVDb250ZW50KSB7CiAgICAgIHZhciB0ZW1wbGF0ZXMgPSBpblJvb3QucXVlcnlTZWxlY3RvckFsbCgndGVtcGxhdGUnKTsKICAgICAgaWYgKHRlbXBsYXRlcykgewogICAgICAgIGZvckVhY2godGVtcGxhdGVzLCBmdW5jdGlvbih0KSB7CiAgICAgICAgICBwYXRoLl9yZXNvbHZlUGF0aHNJbkhUTUwodGVtcGxhdGVDb250ZW50KHQpLCBpblVybCk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0KICB9LAogIHJlc29sdmVQYXRoc0luU3R5bGVzaGVldDogZnVuY3Rpb24oaW5TaGVldCkgewogICAgdmFyIGRvY1VybCA9IHBhdGgubm9kZVVybChpblNoZWV0KTsKICAgIGluU2hlZXQuX19yZXNvdXJjZSA9IHBhdGgucmVzb2x2ZUNzc1RleHQoaW5TaGVldC5fX3Jlc291cmNlLCBkb2NVcmwpOwogIH0sCiAgcmVzb2x2ZVN0eWxlRWx0czogZnVuY3Rpb24oaW5Sb290LCBpblVybCkgewogICAgdmFyIHN0eWxlcyA9IGluUm9vdC5xdWVyeVNlbGVjdG9yQWxsKCdzdHlsZScpOwogICAgaWYgKHN0eWxlcykgewogICAgICBmb3JFYWNoKHN0eWxlcywgZnVuY3Rpb24oc3R5bGUpIHsKICAgICAgICBzdHlsZS50ZXh0Q29udGVudCA9IHBhdGgucmVzb2x2ZUNzc1RleHQoc3R5bGUudGV4dENvbnRlbnQsIGluVXJsKTsKICAgICAgfSk7CiAgICB9CiAgfSwKICByZXNvbHZlQ3NzVGV4dDogZnVuY3Rpb24oaW5Dc3NUZXh0LCBpbkJhc2VVcmwpIHsKICAgIHJldHVybiBpbkNzc1RleHQucmVwbGFjZSgvdXJsXChbXildKlwpL2csIGZ1bmN0aW9uKGluTWF0Y2gpIHsKICAgICAgLy8gZmluZCB0aGUgdXJsIHBhdGgsIGlnbm9yZSBxdW90ZXMgaW4gdXJsIHN0cmluZwogICAgICB2YXIgdXJsUGF0aCA9IGluTWF0Y2gucmVwbGFjZSgvWyInXS9nLCAiIikuc2xpY2UoNCwgLTEpOwogICAgICB1cmxQYXRoID0gcGF0aC5yZXNvbHZlVXJsKGluQmFzZVVybCwgdXJsUGF0aCwgdHJ1ZSk7CiAgICAgIHJldHVybiAidXJsKCIgKyB1cmxQYXRoICsgIikiOwogICAgfSk7CiAgfSwKICByZXNvbHZlQXR0cmlidXRlczogZnVuY3Rpb24oaW5Sb290LCBpblVybCkgewogICAgLy8gc2VhcmNoIGZvciBhdHRyaWJ1dGVzIHRoYXQgaG9zdCB1cmxzCiAgICB2YXIgbm9kZXMgPSBpblJvb3QgJiYgaW5Sb290LnF1ZXJ5U2VsZWN0b3JBbGwoVVJMX0FUVFJTX1NFTEVDVE9SKTsKICAgIGlmIChub2RlcykgewogICAgICBmb3JFYWNoKG5vZGVzLCBmdW5jdGlvbihuKSB7CiAgICAgICAgdGhpcy5yZXNvbHZlTm9kZUF0dHJpYnV0ZXMobiwgaW5VcmwpOwogICAgICB9LCB0aGlzKTsKICAgIH0KICB9LAogIHJlc29sdmVOb2RlQXR0cmlidXRlczogZnVuY3Rpb24oaW5Ob2RlLCBpblVybCkgewogICAgVVJMX0FUVFJTLmZvckVhY2goZnVuY3Rpb24odikgewogICAgICB2YXIgYXR0ciA9IGluTm9kZS5hdHRyaWJ1dGVzW3ZdOwogICAgICBpZiAoYXR0ciAmJiBhdHRyLnZhbHVlICYmCiAgICAgICAgIChhdHRyLnZhbHVlLnNlYXJjaChVUkxfVEVNUExBVEVfU0VBUkNIKSA8IDApKSB7CiAgICAgICAgdmFyIHVybFBhdGggPSBwYXRoLnJlc29sdmVVcmwoaW5VcmwsIGF0dHIudmFsdWUsIHRydWUpOwogICAgICAgIGF0dHIudmFsdWUgPSB1cmxQYXRoOwogICAgICB9CiAgICB9KTsKICB9Cn07Cgp2YXIgVVJMX0FUVFJTID0gWydocmVmJywgJ3NyYycsICdhY3Rpb24nXTsKdmFyIFVSTF9BVFRSU19TRUxFQ1RPUiA9ICdbJyArIFVSTF9BVFRSUy5qb2luKCddLFsnKSArICddJzsKdmFyIFVSTF9URU1QTEFURV9TRUFSQ0ggPSAne3suKn19JzsKCnZhciB4aHIgPSBzY29wZS54aHIgfHwgewogIGFzeW5jOiB0cnVlLAogIG9rOiBmdW5jdGlvbihpblJlcXVlc3QpIHsKICAgIHJldHVybiAoaW5SZXF1ZXN0LnN0YXR1cyA+PSAyMDAgJiYgaW5SZXF1ZXN0LnN0YXR1cyA8IDMwMCkKICAgICAgICB8fCAoaW5SZXF1ZXN0LnN0YXR1cyA9PT0gMzA0KQogICAgICAgIHx8IChpblJlcXVlc3Quc3RhdHVzID09PSAwKTsKICB9LAogIGxvYWQ6IGZ1bmN0aW9uKHVybCwgbmV4dCwgbmV4dENvbnRleHQpIHsKICAgIHZhciByZXF1ZXN0ID0gbmV3IFhNTEh0dHBSZXF1ZXN0KCk7CiAgICBpZiAoc2NvcGUuZmxhZ3MuZGVidWcgfHwgc2NvcGUuZmxhZ3MuYnVzdCkgewogICAgICB1cmwgKz0gJz8nICsgTWF0aC5yYW5kb20oKTsKICAgIH0KICAgIHJlcXVlc3Qub3BlbignR0VUJywgdXJsLCB4aHIuYXN5bmMpOwogICAgcmVxdWVzdC5hZGRFdmVudExpc3RlbmVyKCdyZWFkeXN0YXRlY2hhbmdlJywgZnVuY3Rpb24oZSkgewogICAgICBpZiAocmVxdWVzdC5yZWFkeVN0YXRlID09PSA0KSB7CiAgICAgICAgbmV4dC5jYWxsKG5leHRDb250ZXh0LCAheGhyLm9rKHJlcXVlc3QpICYmIHJlcXVlc3QsCiAgICAgICAgICByZXF1ZXN0LnJlc3BvbnNlLCB1cmwpOwogICAgICB9CiAgICB9KTsKICAgIHJlcXVlc3Quc2VuZCgpOwogIH0KfTsKCnZhciBmb3JFYWNoID0gQXJyYXkucHJvdG90eXBlLmZvckVhY2guY2FsbC5iaW5kKEFycmF5LnByb3RvdHlwZS5mb3JFYWNoKTsKCi8vIGV4cG9ydHMKCnNjb3BlLnhociA9IHhocjsKc2NvcGUuaW1wb3J0ZXIgPSBpbXBvcnRlcjsKc2NvcGUuZ2V0RG9jdW1lbnRVcmwgPSBwYXRoLmdldERvY3VtZW50VXJsOwoKLy8gYm9vdHN0cmFwCgovLyBJRSBzaGltIGZvciBDdXN0b21FdmVudAppZiAodHlwZW9mIHdpbmRvdy5DdXN0b21FdmVudCAhPT0gJ2Z1bmN0aW9uJykgewogIHdpbmRvdy5DdXN0b21FdmVudCA9IGZ1bmN0aW9uKGluVHlwZSkgewogICAgIHZhciBlID0gZG9jdW1lbnQuY3JlYXRlRXZlbnQoJ0hUTUxFdmVudHMnKTsKICAgICBlLmluaXRFdmVudChpblR5cGUsIHRydWUsIHRydWUpOwogICAgIHJldHVybiBlOwogIH07Cn0KCmRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ0RPTUNvbnRlbnRMb2FkZWQnLCBmdW5jdGlvbigpIHsKICAvLyBwcmVsb2FkIGRvY3VtZW50IHJlc291cmNlIHRyZWVzCiAgaW1wb3J0ZXIubG9hZChkb2N1bWVudCwgZnVuY3Rpb24oKSB7CiAgICAvLyBUT0RPKHNqbWlsZXMpOiBTaGFkb3dET00gcG9seWZpbGwgcG9sbHV0aW9uCiAgICB2YXIgZG9jID0gd2luZG93LlNoYWRvd0RPTVBvbHlmaWxsID8gU2hhZG93RE9NUG9seWZpbGwud3JhcChkb2N1bWVudCkKICAgICAgICA6IGRvY3VtZW50OwogICAgSFRNTEltcG9ydHMucmVhZHlUaW1lID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7CiAgICAvLyBzZW5kIEhUTUxJbXBvcnRzTG9hZGVkIHdoZW4gZmluaXNoZWQKICAgIGRvYy5ib2R5LmRpc3BhdGNoRXZlbnQoCiAgICAgIG5ldyBDdXN0b21FdmVudCgnSFRNTEltcG9ydHNMb2FkZWQnLCB7YnViYmxlczogdHJ1ZX0pCiAgICApOwogIH0pOwp9KTsKCn0pKHdpbmRvdy5IVE1MSW1wb3J0cyk7CgovKgogKiBDb3B5cmlnaHQgMjAxMyBUaGUgUG9seW1lciBBdXRob3JzLiBBbGwgcmlnaHRzIHJlc2VydmVkLgogKiBVc2Ugb2YgdGhpcyBzb3VyY2UgY29kZSBpcyBnb3Zlcm5lZCBieSBhIEJTRC1zdHlsZQogKiBsaWNlbnNlIHRoYXQgY2FuIGJlIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUuCiAqLwoKaWYgKCF3aW5kb3cuTXV0YXRpb25PYnNlcnZlcikgewogIHdpbmRvdy5NdXRhdGlvbk9ic2VydmVyID0gCiAgICAgIHdpbmRvdy5XZWJLaXRNdXRhdGlvbk9ic2VydmVyIHx8IAogICAgICB3aW5kb3cuSnNNdXRhdGlvbk9ic2VydmVyOwogIGlmICghTXV0YXRpb25PYnNlcnZlcikgewogICAgdGhyb3cgbmV3IEVycm9yKCJubyBtdXRhdGlvbiBvYnNlcnZlciBzdXBwb3J0Iik7CiAgfQp9CgovKgogKiBDb3B5cmlnaHQgMjAxMyBUaGUgUG9seW1lciBBdXRob3JzLiBBbGwgcmlnaHRzIHJlc2VydmVkLgogKiBVc2Ugb2YgdGhpcyBzb3VyY2UgY29kZSBpcyBnb3Zlcm5lZCBieSBhIEJTRC1zdHlsZQogKiBsaWNlbnNlIHRoYXQgY2FuIGJlIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUuCiAqLwoKLyoqCiAqIEltcGxlbWVudHMgYGRvY3VtZW50LnJlZ2lzdGVyYAogKiBAbW9kdWxlIEN1c3RvbUVsZW1lbnRzCiovCgovKioKICogUG9seWZpbGxlZCBleHRlbnNpb25zIHRvIHRoZSBgZG9jdW1lbnRgIG9iamVjdC4KICogQGNsYXNzIERvY3VtZW50CiovCgooZnVuY3Rpb24oc2NvcGUpIHsKCmlmICghc2NvcGUpIHsKICBzY29wZSA9IHdpbmRvdy5DdXN0b21FbGVtZW50cyA9IHtmbGFnczp7fX07Cn0KCi8vIG5hdGl2ZSBkb2N1bWVudC5yZWdpc3Rlcj8KCnNjb3BlLmhhc05hdGl2ZSA9IChkb2N1bWVudC53ZWJraXRSZWdpc3RlciB8fCBkb2N1bWVudC5yZWdpc3RlcikgJiYgc2NvcGUuZmxhZ3MucmVnaXN0ZXIgPT09ICduYXRpdmUnOwppZiAoc2NvcGUuaGFzTmF0aXZlKSB7CgogIC8vIG5vcm1hbGl6ZQogIGRvY3VtZW50LnJlZ2lzdGVyID0gZG9jdW1lbnQucmVnaXN0ZXIgfHwgZG9jdW1lbnQud2Via2l0UmVnaXN0ZXI7CgogIHZhciBub3AgPSBmdW5jdGlvbigpIHt9OwoKICAvLyBleHBvcnRzCiAgc2NvcGUucmVnaXN0cnkgPSB7fTsKICBzY29wZS51cGdyYWRlRWxlbWVudCA9IG5vcDsKCn0gZWxzZSB7CgovKioKICogUmVnaXN0ZXJzIGEgY3VzdG9tIHRhZyBuYW1lIHdpdGggdGhlIGRvY3VtZW50LgogKgogKiBXaGVuIGEgcmVnaXN0ZXJlZCBlbGVtZW50IGlzIGNyZWF0ZWQsIGEgYHJlYWR5Q2FsbGJhY2tgIG1ldGhvZCBpcyBjYWxsZWQKICogaW4gdGhlIHNjb3BlIG9mIHRoZSBlbGVtZW50LiBUaGUgYHJlYWR5Q2FsbGJhY2tgIG1ldGhvZCBjYW4gYmUgc3BlY2lmaWVkIG9uCiAqIGVpdGhlciBgaW5PcHRpb25zLnByb3RvdHlwZWAgb3IgYGluT3B0aW9ucy5saWZlY3ljbGVgIHdpdGggdGhlIGxhdHRlciB0YWtpbmcKICogcHJlY2VkZW5jZS4KICoKICogQG1ldGhvZCByZWdpc3RlcgogKiBAcGFyYW0ge1N0cmluZ30gaW5OYW1lIFRoZSB0YWcgbmFtZSB0byByZWdpc3Rlci4gTXVzdCBpbmNsdWRlIGEgZGFzaCAoJy0nKSwKICogICAgZm9yIGV4YW1wbGUgJ3gtY29tcG9uZW50Jy4KICogQHBhcmFtIHtPYmplY3R9IGluT3B0aW9ucwogKiAgICBAcGFyYW0ge1N0cmluZ30gW2luT3B0aW9ucy5leHRlbmRzXQogKiAgICAgIChfb2ZmIHNwZWNfKSBUYWcgbmFtZSBvZiBhbiBlbGVtZW50IHRvIGV4dGVuZCAob3IgYmxhbmsgZm9yIGEgbmV3CiAqICAgICAgZWxlbWVudCkuIFRoaXMgcGFyYW1ldGVyIGlzIG5vdCBwYXJ0IG9mIHRoZSBzcGVjaWZpY2F0aW9uLCBidXQgaW5zdGVhZAogKiAgICAgIGlzIGEgaGludCBmb3IgdGhlIHBvbHlmaWxsIGJlY2F1c2UgdGhlIGV4dGVuZGVlIGlzIGRpZmZpY3VsdCB0byBpbmZlci4KICogICAgICBSZW1lbWJlciB0aGF0IHRoZSBpbnB1dCBwcm90b3R5cGUgbXVzdCBjaGFpbiB0byB0aGUgZXh0ZW5kZWQgZWxlbWVudCdzCiAqICAgICAgcHJvdG90eXBlIChvciBIVE1MRWxlbWVudC5wcm90b3R5cGUpIHJlZ2FyZGxlc3Mgb2YgdGhlIHZhbHVlIG9mCiAqICAgICAgYGV4dGVuZHNgLgogKiAgICBAcGFyYW0ge09iamVjdH0gaW5PcHRpb25zLnByb3RvdHlwZSBUaGUgcHJvdG90eXBlIHRvIHVzZSBmb3IgdGhlIG5ldwogKiAgICAgIGVsZW1lbnQuIFRoZSBwcm90b3R5cGUgbXVzdCBpbmhlcml0IGZyb20gSFRNTEVsZW1lbnQuCiAqICAgIEBwYXJhbSB7T2JqZWN0fSBbaW5PcHRpb25zLmxpZmVjeWNsZV0KICogICAgICBDYWxsYmFja3MgdGhhdCBmaXJlIGF0IGltcG9ydGFudCBwaGFzZXMgaW4gdGhlIGxpZmUgb2YgdGhlIGN1c3RvbQogKiAgICAgIGVsZW1lbnQuCiAqCiAqIEBleGFtcGxlCiAqICAgICAgRmFuY3lCdXR0b24gPSBkb2N1bWVudC5yZWdpc3RlcigiZmFuY3ktYnV0dG9uIiwgewogKiAgICAgICAgZXh0ZW5kczogJ2J1dHRvbicsCiAqICAgICAgICBwcm90b3R5cGU6IE9iamVjdC5jcmVhdGUoSFRNTEJ1dHRvbkVsZW1lbnQucHJvdG90eXBlLCB7CiAqICAgICAgICAgIHJlYWR5Q2FsbGJhY2s6IHsKICogICAgICAgICAgICB2YWx1ZTogZnVuY3Rpb24oKSB7CiAqICAgICAgICAgICAgICBjb25zb2xlLmxvZygiYSBmYW5jeS1idXR0b24gd2FzIGNyZWF0ZWQiLAogKiAgICAgICAgICAgIH0KICogICAgICAgICAgfQogKiAgICAgICAgfSkKICogICAgICB9KTsKICogQHJldHVybiB7RnVuY3Rpb259IENvbnN0cnVjdG9yIGZvciB0aGUgbmV3bHkgcmVnaXN0ZXJlZCB0eXBlLgogKi8KZnVuY3Rpb24gcmVnaXN0ZXIoaW5OYW1lLCBpbk9wdGlvbnMpIHsKICAvL2NvbnNvbGUud2FybignZG9jdW1lbnQucmVnaXN0ZXIoIicgKyBpbk5hbWUgKyAnIiwgJywgaW5PcHRpb25zLCAnKScpOwogIC8vIGNvbnN0cnVjdCBhIGRlZmludGlvbiBvdXQgb2Ygb3B0aW9ucwogIC8vIFRPRE8oc2ptaWxlcyk6IHByb2JhYmx5IHNob3VsZCBjbG9uZSBpbk9wdGlvbnMgaW5zdGVhZCBvZiBtdXRhdGluZyBpdAogIHZhciBkZWZpbml0aW9uID0gaW5PcHRpb25zIHx8IHt9OwogIGlmICghaW5OYW1lKSB7CiAgICAvLyBUT0RPKHNqbWlsZXMpOiByZXBsYWNlIHdpdGggbW9yZSBhcHByb3ByaWF0ZSBlcnJvciAoRXJpayBjYW4gcHJvYmFibHkKICAgIC8vIG9mZmVyIGd1aWRhbmNlKQogICAgdGhyb3cgbmV3IEVycm9yKCdOYW1lIGFyZ3VtZW50IG11c3Qgbm90IGJlIGVtcHR5Jyk7CiAgfQogIC8vIHJlY29yZCBuYW1lCiAgZGVmaW5pdGlvbi5uYW1lID0gaW5OYW1lOwogIC8vIG11c3QgaGF2ZSBhIHByb3RvdHlwZSwgZGVmYXVsdCB0byBhbiBleHRlbnNpb24gb2YgSFRNTEVsZW1lbnQKICAvLyBUT0RPKHNqbWlsZXMpOiBwcm9iYWJseSBzaG91bGQgdGhyb3cgaWYgbm8gcHJvdG90eXBlLCBjaGVjayBzcGVjCiAgaWYgKCFkZWZpbml0aW9uLnByb3RvdHlwZSkgewogICAgLy8gVE9ETyhzam1pbGVzKTogcmVwbGFjZSB3aXRoIG1vcmUgYXBwcm9wcmlhdGUgZXJyb3IgKEVyaWsgY2FuIHByb2JhYmx5CiAgICAvLyBvZmZlciBndWlkYW5jZSkKICAgIHRocm93IG5ldyBFcnJvcignT3B0aW9ucyBtaXNzaW5nIHJlcXVpcmVkIHByb3RvdHlwZSBwcm9wZXJ0eScpOwogIH0KICAvLyBlbnN1cmUgYSBsaWZlY3ljbGUgb2JqZWN0IHNvIHdlIGRvbid0IGhhdmUgdG8gbnVsbCB0ZXN0IGl0CiAgZGVmaW5pdGlvbi5saWZlY3ljbGUgPSBkZWZpbml0aW9uLmxpZmVjeWNsZSB8fCB7fTsKICAvLyBidWlsZCBhIGxpc3Qgb2YgYW5jZXN0cmFsIGN1c3RvbSBlbGVtZW50cyAoZm9yIG5hdGl2ZSBiYXNlIGRldGVjdGlvbikKICAvLyBUT0RPKHNqbWlsZXMpOiB3ZSB1c2VkIHRvIG5lZWQgdG8gc3RvcmUgdGhpcywgYnV0IGN1cnJlbnQgY29kZSBvbmx5CiAgLy8gdXNlcyBpdCBpbiAncmVzb2x2ZVRhZ05hbWUnOiBpdCBzaG91bGQgcHJvYmFibHkgYmUgaW5saW5lZAogIGRlZmluaXRpb24uYW5jZXN0cnkgPSBhbmNlc3RyeShkZWZpbml0aW9uLmV4dGVuZHMpOwogIC8vIGV4dGVuc2lvbnMgb2YgbmF0aXZlIHNwZWNpYWxpemF0aW9ucyBvZiBIVE1MRWxlbWVudCByZXF1aXJlIGxvY2FsTmFtZQogIC8vIHRvIHJlbWFpbiBuYXRpdmUsIGFuZCB1c2Ugc2Vjb25kYXJ5ICdpcycgc3BlY2lmaWVyIGZvciBleHRlbnNpb24gdHlwZQogIHJlc29sdmVUYWdOYW1lKGRlZmluaXRpb24pOwogIC8vIHNvbWUgcGxhdGZvcm1zIHJlcXVpcmUgbW9kaWZpY2F0aW9ucyB0byB0aGUgdXNlci1zdXBwbGllZCBwcm90b3R5cGUKICAvLyBjaGFpbgogIHJlc29sdmVQcm90b3R5cGVDaGFpbihkZWZpbml0aW9uKTsKICAvLyBvdmVycmlkZXMgdG8gaW1wbGVtZW50IGF0dHJpYnV0ZUNoYW5nZWQgY2FsbGJhY2sKICBvdmVycmlkZUF0dHJpYnV0ZUFwaShkZWZpbml0aW9uLnByb3RvdHlwZSk7CiAgLy8gNy4xLjU6IFJlZ2lzdGVyIHRoZSBERUZJTklUSU9OIHdpdGggRE9DVU1FTlQKICByZWdpc3RlckRlZmluaXRpb24oaW5OYW1lLCBkZWZpbml0aW9uKTsKICAvLyA3LjEuNy4gUnVuIGN1c3RvbSBlbGVtZW50IGNvbnN0cnVjdG9yIGdlbmVyYXRpb24gYWxnb3JpdGhtIHdpdGggUFJPVE9UWVBFCiAgLy8gNy4xLjguIFJldHVybiB0aGUgb3V0cHV0IG9mIHRoZSBwcmV2aW91cyBzdGVwLgogIGRlZmluaXRpb24uY3RvciA9IGdlbmVyYXRlQ29uc3RydWN0b3IoZGVmaW5pdGlvbik7CiAgZGVmaW5pdGlvbi5jdG9yLnByb3RvdHlwZSA9IGRlZmluaXRpb24ucHJvdG90eXBlOwogIC8vIGZvcmNlIG91ciAuY29uc3RydWN0b3IgdG8gYmUgb3VyIGFjdHVhbCBjb25zdHJ1Y3RvcgogIGRlZmluaXRpb24ucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gZGVmaW5pdGlvbi5jdG9yOwogIC8vIGlmIGluaXRpYWwgcGFyc2luZyBpcyBjb21wbGV0ZQogIGlmIChzY29wZS5yZWFkeSkgewogICAgLy8gdXBncmFkZSBhbnkgcHJlLWV4aXN0aW5nIG5vZGVzIG9mIHRoaXMgdHlwZQogICAgc2NvcGUudXBncmFkZUFsbChkb2N1bWVudCk7CiAgfQogIHJldHVybiBkZWZpbml0aW9uLmN0b3I7Cn0KCmZ1bmN0aW9uIGFuY2VzdHJ5KGluRXh0ZW5kcykgewogIHZhciBleHRlbmRlZSA9IHJlZ2lzdHJ5W2luRXh0ZW5kc107CiAgaWYgKGV4dGVuZGVlKSB7CiAgICByZXR1cm4gYW5jZXN0cnkoZXh0ZW5kZWUuZXh0ZW5kcykuY29uY2F0KFtleHRlbmRlZV0pOwogIH0KICByZXR1cm4gW107Cn0KCmZ1bmN0aW9uIHJlc29sdmVUYWdOYW1lKGluRGVmaW5pdGlvbikgewogIC8vIGlmIHdlIGFyZSBleHBsaWNpdGx5IGV4dGVuZGluZyBzb21ldGhpbmcsIHRoYXQgdGhpbmcgaXMgb3VyCiAgLy8gYmFzZVRhZywgdW5sZXNzIGl0IHJlcHJlc2VudHMgYSBjdXN0b20gY29tcG9uZW50CiAgdmFyIGJhc2VUYWcgPSBpbkRlZmluaXRpb24uZXh0ZW5kczsKICAvLyBpZiBvdXIgYW5jZXN0cnkgaW5jbHVkZXMgY3VzdG9tIGNvbXBvbmVudHMsIHdlIG9ubHkgaGF2ZSBhCiAgLy8gYmFzZVRhZyBpZiBvbmUgb2YgdGhlbSBkb2VzCiAgZm9yICh2YXIgaT0wLCBhOyAoYT1pbkRlZmluaXRpb24uYW5jZXN0cnlbaV0pOyBpKyspIHsKICAgIGJhc2VUYWcgPSBhLmlzICYmIGEudGFnOwogIH0KICAvLyBvdXIgdGFnIGlzIG91ciBiYXNlVGFnLCBpZiBpdCBleGlzdHMsIGFuZCBvdGhlcndpc2UganVzdCBvdXIgbmFtZQogIGluRGVmaW5pdGlvbi50YWcgPSBiYXNlVGFnIHx8IGluRGVmaW5pdGlvbi5uYW1lOwogIGlmIChiYXNlVGFnKSB7CiAgICAvLyBpZiB0aGVyZSBpcyBhIGJhc2UgdGFnLCB1c2Ugc2Vjb25kYXJ5ICdpcycgc3BlY2lmaWVyCiAgICBpbkRlZmluaXRpb24uaXMgPSBpbkRlZmluaXRpb24ubmFtZTsKICB9Cn0KCmZ1bmN0aW9uIHJlc29sdmVQcm90b3R5cGVDaGFpbihpbkRlZmluaXRpb24pIHsKICAvLyBpZiB3ZSBkb24ndCBzdXBwb3J0IF9fcHJvdG9fXyB3ZSBuZWVkIHRvIGxvY2F0ZSB0aGUgbmF0aXZlIGxldmVsCiAgLy8gcHJvdG90eXBlIGZvciBwcmVjaXNlIG1peGluZyBpbgogIGlmICghT2JqZWN0Ll9fcHJvdG9fXykgewogICAgLy8gZGVmYXVsdCBwcm90b3R5cGUKICAgIHZhciBuYXRpdmUgPSBIVE1MRWxlbWVudC5wcm90b3R5cGU7CiAgICAvLyB3b3JrIG91dCBwcm90b3R5cGUgd2hlbiB1c2luZyB0eXBlLWV4dGVuc2lvbgogICAgaWYgKGluRGVmaW5pdGlvbi5pcykgewogICAgICB2YXIgaW5zdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoaW5EZWZpbml0aW9uLnRhZyk7CiAgICAgIG5hdGl2ZSA9IE9iamVjdC5nZXRQcm90b3R5cGVPZihpbnN0KTsKICAgIH0KICB9CiAgLy8gY2FjaGUgdGhpcyBpbiBjYXNlIG9mIG1peGluCiAgaW5EZWZpbml0aW9uLm5hdGl2ZSA9IG5hdGl2ZTsKfQoKLy8gU0VDVElPTiA0CgpmdW5jdGlvbiBpbnN0YW50aWF0ZShpbkRlZmluaXRpb24pIHsKICAvLyA0LmEuMS4gQ3JlYXRlIGEgbmV3IG9iamVjdCB0aGF0IGltcGxlbWVudHMgUFJPVE9UWVBFCiAgLy8gNC5hLjIuIExldCBFTEVNRU5UIGJ5IHRoaXMgbmV3IG9iamVjdAogIC8vCiAgLy8gdGhlIGN1c3RvbSBlbGVtZW50IGluc3RhbnRpYXRpb24gYWxnb3JpdGhtIG11c3QgYWxzbyBlbnN1cmUgdGhhdCB0aGUKICAvLyBvdXRwdXQgaXMgYSB2YWxpZCBET00gZWxlbWVudCB3aXRoIHRoZSBwcm9wZXIgd3JhcHBlciBpbiBwbGFjZS4KICAvLwogIHJldHVybiB1cGdyYWRlKGRvbUNyZWF0ZUVsZW1lbnQoaW5EZWZpbml0aW9uLnRhZyksIGluRGVmaW5pdGlvbik7Cn0KCmZ1bmN0aW9uIHVwZ3JhZGUoaW5FbGVtZW50LCBpbkRlZmluaXRpb24pIHsKICAvLyBzb21lIGRlZmluaXRpb25zIHNwZWNpZnkgYW4gJ2lzJyBhdHRyaWJ1dGUKICBpZiAoaW5EZWZpbml0aW9uLmlzKSB7CiAgICBpbkVsZW1lbnQuc2V0QXR0cmlidXRlKCdpcycsIGluRGVmaW5pdGlvbi5pcyk7CiAgfQogIC8vIG1ha2UgJ2VsZW1lbnQnIGltcGxlbWVudCBpbkRlZmluaXRpb24ucHJvdG90eXBlCiAgaW1wbGVtZW50KGluRWxlbWVudCwgaW5EZWZpbml0aW9uKTsKICAvLyBmbGFnIGFzIHVwZ3JhZGVkCiAgaW5FbGVtZW50Ll9fdXBncmFkZWRfXyA9IHRydWU7CiAgLy8gdGhlcmUgc2hvdWxkIG5ldmVyIGJlIGEgc2hhZG93IHJvb3Qgb24gaW5FbGVtZW50IGF0IHRoaXMgcG9pbnQKICAvLyB3ZSByZXF1aXJlIGNoaWxkIG5vZGVzIGJlIHVwZ3JhZGVkIGJlZm9yZSByZWFkeQogIHNjb3BlLnVwZ3JhZGVTdWJ0cmVlKGluRWxlbWVudCk7CiAgLy8gbGlmZWN5Y2xlIG1hbmFnZW1lbnQKICByZWFkeShpbkVsZW1lbnQpOwogIC8vIE9VVFBVVAogIHJldHVybiBpbkVsZW1lbnQ7Cn0KCmZ1bmN0aW9uIGltcGxlbWVudChpbkVsZW1lbnQsIGluRGVmaW5pdGlvbikgewogIC8vIHByb3RvdHlwZSBzd2l6emxpbmcgaXMgYmVzdAogIGlmIChPYmplY3QuX19wcm90b19fKSB7CiAgICBpbkVsZW1lbnQuX19wcm90b19fID0gaW5EZWZpbml0aW9uLnByb3RvdHlwZTsKICB9IGVsc2UgewogICAgLy8gd2hlcmUgYWJvdmUgd2UgY2FuIHJlLWFjcXVpcmUgaW5Qcm90b3R5cGUgdmlhCiAgICAvLyBnZXRQcm90b3R5cGVPZihFbGVtZW50KSwgd2UgY2Fubm90IGRvIHNvIHdoZW4KICAgIC8vIHdlIHVzZSBtaXhpbiwgc28gd2UgaW5zdGFsbCBhIG1hZ2ljIHJlZmVyZW5jZQogICAgY3VzdG9tTWl4aW4oaW5FbGVtZW50LCBpbkRlZmluaXRpb24ucHJvdG90eXBlLCBpbkRlZmluaXRpb24ubmF0aXZlKTsKICAgIGluRWxlbWVudC5fX3Byb3RvX18gPSBpbkRlZmluaXRpb24ucHJvdG90eXBlOwogIH0KfQoKZnVuY3Rpb24gY3VzdG9tTWl4aW4oaW5UYXJnZXQsIGluU3JjLCBpbk5hdGl2ZSkgewogIC8vIFRPRE8oc2ptaWxlcyk6ICd1c2VkJyBhbGxvd3MgdXMgdG8gb25seSBjb3B5IHRoZSAneW91bmdlc3QnIHZlcnNpb24gb2YKICAvLyBhbnkgcHJvcGVydHkuIFRoaXMgc2V0IHNob3VsZCBiZSBwcmVjYWxjdWxhdGVkLiBXZSBhbHNvIG5lZWQgdG8KICAvLyBjb25zaWRlciB0aGlzIGZvciBzdXBwb3J0aW5nICdzdXBlcicuCiAgdmFyIHVzZWQgPSB7fTsKICAvLyBzdGFydCB3aXRoIGluU3JjCiAgdmFyIHAgPSBpblNyYzsKICAvLyBzb21ldGltZXMgdGhlIGRlZmF1bHQgaXMgSFRNTFVua25vd25FbGVtZW50LnByb3RvdHlwZSBpbnN0ZWFkIG9mCiAgLy8gSFRNTEVsZW1lbnQucHJvdG90eXBlLCBzbyB3ZSBhZGQgYSB0ZXN0CiAgLy8gdGhlIGlkZWEgaXMgdG8gYXZvaWQgbWl4aW5nIGluIG5hdGl2ZSBwcm90b3R5cGVzLCBzbyBhZGRpbmcKICAvLyB0aGUgc2Vjb25kIHRlc3QgaXMgV0xPRwogIHdoaWxlIChwICE9PSBpbk5hdGl2ZSAmJiBwICE9PSBIVE1MVW5rbm93bkVsZW1lbnQucHJvdG90eXBlKSB7CiAgICB2YXIga2V5cyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eU5hbWVzKHApOwogICAgZm9yICh2YXIgaT0wLCBrOyBrPWtleXNbaV07IGkrKykgewogICAgICBpZiAoIXVzZWRba10pIHsKICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoaW5UYXJnZXQsIGssCiAgICAgICAgICAgIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IocCwgaykpOwogICAgICAgIHVzZWRba10gPSAxOwogICAgICB9CiAgICB9CiAgICBwID0gT2JqZWN0LmdldFByb3RvdHlwZU9mKHApOwogIH0KfQoKZnVuY3Rpb24gcmVhZHkoaW5FbGVtZW50KSB7CiAgLy8gaW52b2tlIHJlYWR5Q2FsbGJhY2sKICBpZiAoaW5FbGVtZW50LnJlYWR5Q2FsbGJhY2spIHsKICAgIGluRWxlbWVudC5yZWFkeUNhbGxiYWNrKCk7CiAgfQp9CgovLyBhdHRyaWJ1dGUgd2F0Y2hpbmcKCmZ1bmN0aW9uIG92ZXJyaWRlQXR0cmlidXRlQXBpKHByb3RvdHlwZSkgewogIC8vIG92ZXJyaWRlcyB0byBpbXBsZW1lbnQgY2FsbGJhY2tzCiAgLy8gVE9ETyhzam1pbGVzKTogc2hvdWxkIHN1cHBvcnQgYWNjZXNzIHZpYSAuYXR0cmlidXRlcyBOYW1lZE5vZGVNYXAKICAvLyBUT0RPKHNqbWlsZXMpOiBwcmVzZXJ2ZXMgdXNlciBkZWZpbmVkIG92ZXJyaWRlcywgaWYgYW55CiAgdmFyIHNldEF0dHJpYnV0ZSA9IHByb3RvdHlwZS5zZXRBdHRyaWJ1dGU7CiAgcHJvdG90eXBlLnNldEF0dHJpYnV0ZSA9IGZ1bmN0aW9uKG5hbWUsIHZhbHVlKSB7CiAgICBjaGFuZ2VBdHRyaWJ1dGUuY2FsbCh0aGlzLCBuYW1lLCB2YWx1ZSwgc2V0QXR0cmlidXRlKTsKICB9CiAgdmFyIHJlbW92ZUF0dHJpYnV0ZSA9IHByb3RvdHlwZS5yZW1vdmVBdHRyaWJ1dGU7CiAgcHJvdG90eXBlLnJlbW92ZUF0dHJpYnV0ZSA9IGZ1bmN0aW9uKG5hbWUsIHZhbHVlKSB7CiAgICBjaGFuZ2VBdHRyaWJ1dGUuY2FsbCh0aGlzLCBuYW1lLCB2YWx1ZSwgcmVtb3ZlQXR0cmlidXRlKTsKICB9Cn0KCmZ1bmN0aW9uIGNoYW5nZUF0dHJpYnV0ZShuYW1lLCB2YWx1ZSwgb3BlcmF0aW9uKSB7CiAgdmFyIG9sZFZhbHVlID0gdGhpcy5nZXRBdHRyaWJ1dGUobmFtZSk7CiAgb3BlcmF0aW9uLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgaWYgKHRoaXMuYXR0cmlidXRlQ2hhbmdlZENhbGxiYWNrIAogICAgICAmJiAodGhpcy5nZXRBdHRyaWJ1dGUobmFtZSkgIT09IG9sZFZhbHVlKSkgewogICAgdGhpcy5hdHRyaWJ1dGVDaGFuZ2VkQ2FsbGJhY2sobmFtZSwgb2xkVmFsdWUpOwogIH0KfQoKLy8gZWxlbWVudCByZWdpc3RyeSAobWFwcyB0YWcgbmFtZXMgdG8gZGVmaW5pdGlvbnMpCgp2YXIgcmVnaXN0cnkgPSB7fTsKCmZ1bmN0aW9uIHJlZ2lzdGVyRGVmaW5pdGlvbihpbk5hbWUsIGluRGVmaW5pdGlvbikgewogIHJlZ2lzdHJ5W2luTmFtZV0gPSBpbkRlZmluaXRpb247Cn0KCmZ1bmN0aW9uIGdlbmVyYXRlQ29uc3RydWN0b3IoaW5EZWZpbml0aW9uKSB7CiAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIGluc3RhbnRpYXRlKGluRGVmaW5pdGlvbik7CiAgfTsKfQoKZnVuY3Rpb24gY3JlYXRlRWxlbWVudChpblRhZykgewogIHZhciBkZWZpbml0aW9uID0gcmVnaXN0cnlbaW5UYWddOwogIGlmIChkZWZpbml0aW9uKSB7CiAgICByZXR1cm4gbmV3IGRlZmluaXRpb24uY3RvcigpOwogIH0KICByZXR1cm4gZG9tQ3JlYXRlRWxlbWVudChpblRhZyk7Cn0KCmZ1bmN0aW9uIHVwZ3JhZGVFbGVtZW50KGluRWxlbWVudCkgewogIGlmICghaW5FbGVtZW50Ll9fdXBncmFkZWRfXyAmJiAoaW5FbGVtZW50Lm5vZGVUeXBlID09PSBOb2RlLkVMRU1FTlRfTk9ERSkpIHsKICAgIHZhciB0eXBlID0gaW5FbGVtZW50LmdldEF0dHJpYnV0ZSgnaXMnKSB8fCBpbkVsZW1lbnQubG9jYWxOYW1lOwogICAgdmFyIGRlZmluaXRpb24gPSByZWdpc3RyeVt0eXBlXTsKICAgIHJldHVybiBkZWZpbml0aW9uICYmIHVwZ3JhZGUoaW5FbGVtZW50LCBkZWZpbml0aW9uKTsKICB9Cn0KCmZ1bmN0aW9uIGNsb25lTm9kZShkZWVwKSB7CiAgLy8gY2FsbCBvcmlnaW5hbCBjbG9uZQogIHZhciBuID0gZG9tQ2xvbmVOb2RlLmNhbGwodGhpcywgZGVlcCk7CiAgLy8gdXBncmFkZSB0aGUgZWxlbWVudCBhbmQgc3VidHJlZQogIHNjb3BlLnVwZ3JhZGVBbGwobik7CiAgcmV0dXJuIG47Cn0KLy8gY2FwdHVyZSBuYXRpdmUgY3JlYXRlRWxlbWVudCBiZWZvcmUgd2Ugb3ZlcnJpZGUgaXQKCnZhciBkb21DcmVhdGVFbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudC5iaW5kKGRvY3VtZW50KTsKCi8vIGNhcHR1cmUgbmF0aXZlIGNsb25lTm9kZSBiZWZvcmUgd2Ugb3ZlcnJpZGUgaXQKCnZhciBkb21DbG9uZU5vZGUgPSBOb2RlLnByb3RvdHlwZS5jbG9uZU5vZGU7CgovLyBleHBvcnRzCgpkb2N1bWVudC5yZWdpc3RlciA9IHJlZ2lzdGVyOwpkb2N1bWVudC5jcmVhdGVFbGVtZW50ID0gY3JlYXRlRWxlbWVudDsgLy8gb3ZlcnJpZGUKTm9kZS5wcm90b3R5cGUuY2xvbmVOb2RlID0gY2xvbmVOb2RlOyAvLyBvdmVycmlkZQoKc2NvcGUucmVnaXN0cnkgPSByZWdpc3RyeTsKCi8qKgogKiBVcGdyYWRlIGFuIGVsZW1lbnQgdG8gYSBjdXN0b20gZWxlbWVudC4gVXBncmFkaW5nIGFuIGVsZW1lbnQKICogY2F1c2VzIHRoZSBjdXN0b20gcHJvdG90eXBlIHRvIGJlIGFwcGxpZWQsIGFuIGBpc2AgYXR0cmlidXRlIAogKiB0byBiZSBhdHRhY2hlZCAoYXMgbmVlZGVkKSwgYW5kIGludm9jYXRpb24gb2YgdGhlIGByZWFkeUNhbGxiYWNrYC4KICogYHVwZ3JhZGVgIGRvZXMgbm90aGluZyBpZiB0aGUgZWxlbWVudCBpcyBhbHJlYWR5IHVwZ3JhZGVkLCBvcgogKiBpZiBpdCBtYXRjaGVzIG5vIHJlZ2lzdGVyZWQgY3VzdG9tIHRhZyBuYW1lLgogKgogKiBAbWV0aG9kIHVncHJhZGUKICogQHBhcmFtIHtFbGVtZW50fSBpbkVsZW1lbnQgVGhlIGVsZW1lbnQgdG8gdXBncmFkZS4KICogQHJldHVybiB7RWxlbWVudH0gVGhlIHVwZ3JhZGVkIGVsZW1lbnQuCiAqLwpzY29wZS51cGdyYWRlID0gdXBncmFkZUVsZW1lbnQ7Cgp9Cgp9KSh3aW5kb3cuQ3VzdG9tRWxlbWVudHMpOwoKIC8qCkNvcHlyaWdodCAyMDEzIFRoZSBQb2x5bWVyIEF1dGhvcnMuIEFsbCByaWdodHMgcmVzZXJ2ZWQuClVzZSBvZiB0aGlzIHNvdXJjZSBjb2RlIGlzIGdvdmVybmVkIGJ5IGEgQlNELXN0eWxlCmxpY2Vuc2UgdGhhdCBjYW4gYmUgZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZS4KKi8KCihmdW5jdGlvbihzY29wZSl7CgovKgppZiAoSFRNTEVsZW1lbnQucHJvdG90eXBlLndlYmtpdFNoYWRvd1Jvb3QpIHsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoSFRNTEVsZW1lbnQucHJvdG90eXBlLCAnc2hhZG93Um9vdCcsIHsKICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB0aGlzLndlYmtpdFNoYWRvd1Jvb3Q7CiAgICB9CiAgfTsKfQoqLwoKLy8gd2FsayB0aGUgc3VidHJlZSByb290ZWQgYXQgbm9kZSwgYXBwbHlpbmcgJ2ZpbmQoZWxlbWVudCwgZGF0YSknIGZ1bmN0aW9uIAovLyB0byBlYWNoIGVsZW1lbnQKLy8gaWYgJ2ZpbmQnIHJldHVybnMgdHJ1ZSBmb3IgJ2VsZW1lbnQnLCBkbyBub3Qgc2VhcmNoIGVsZW1lbnQncyBzdWJ0cmVlICAKZnVuY3Rpb24gZmluZEFsbChub2RlLCBmaW5kLCBkYXRhKSB7CiAgdmFyIGUgPSBub2RlLmZpcnN0RWxlbWVudENoaWxkOwogIGlmICghZSkgewogICAgZSA9IG5vZGUuZmlyc3RDaGlsZDsKICAgIHdoaWxlIChlICYmIGUubm9kZVR5cGUgIT09IE5vZGUuRUxFTUVOVF9OT0RFKSB7CiAgICAgIGUgPSBlLm5leHRTaWJsaW5nOwogICAgfQogIH0KICB3aGlsZSAoZSkgewogICAgaWYgKGZpbmQoZSwgZGF0YSkgIT09IHRydWUpIHsKICAgICAgZmluZEFsbChlLCBmaW5kLCBkYXRhKTsKICAgIH0KICAgIGUgPSBlLm5leHRFbGVtZW50U2libGluZzsKICB9CiAgcmV0dXJuIG51bGw7Cn0KCi8vIHdhbGsgdGhlIHN1YnRyZWUgcm9vdGVkIGF0IG5vZGUsIGluY2x1ZGluZyBkZXNjZW50IGludG8gc2hhZG93LXJvb3RzLCAKLy8gYXBwbHlpbmcgJ2NiJyB0byBlYWNoIGVsZW1lbnQKZnVuY3Rpb24gZm9yU3VidHJlZShub2RlLCBjYikgewogIC8vbG9nRmxhZ3MuZG9tICYmIG5vZGUuY2hpbGROb2RlcyAmJiBub2RlLmNoaWxkTm9kZXMubGVuZ3RoICYmIGNvbnNvbGUuZ3JvdXAoJ3N1YlRyZWU6ICcsIG5vZGUpOwogIGZpbmRBbGwobm9kZSwgZnVuY3Rpb24oZSkgewogICAgaWYgKGNiKGUpKSB7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQogICAgaWYgKGUud2Via2l0U2hhZG93Um9vdCkgewogICAgICBmb3JTdWJ0cmVlKGUud2Via2l0U2hhZG93Um9vdCwgY2IpOwogICAgfQogIH0pOwogIGlmIChub2RlLndlYmtpdFNoYWRvd1Jvb3QpIHsKICAgIGZvclN1YnRyZWUobm9kZS53ZWJraXRTaGFkb3dSb290LCBjYik7CiAgfQogIC8vbG9nRmxhZ3MuZG9tICYmIG5vZGUuY2hpbGROb2RlcyAmJiBub2RlLmNoaWxkTm9kZXMubGVuZ3RoICYmIGNvbnNvbGUuZ3JvdXBFbmQoKTsKfQoKLy8gbWFuYWdlIGxpZmVjeWNsZSBvbiBhZGRlZCBub2RlCmZ1bmN0aW9uIGFkZGVkKG5vZGUpIHsKICBpZiAodXBncmFkZShub2RlKSkgewogICAgaW5zZXJ0ZWROb2RlKG5vZGUpOwogICAgcmV0dXJuIHRydWU7IAogIH0KICBpbnNlcnRlZChub2RlKTsKfQoKLy8gbWFuYWdlIGxpZmVjeWNsZSBvbiBhZGRlZCBub2RlJ3Mgc3VidHJlZSBvbmx5CmZ1bmN0aW9uIGFkZGVkU3VidHJlZShub2RlKSB7CiAgZm9yU3VidHJlZShub2RlLCBmdW5jdGlvbihlKSB7CiAgICBpZiAoYWRkZWQoZSkpIHsKICAgICAgcmV0dXJuIHRydWU7IAogICAgfQogIH0pOwp9CgovLyBtYW5hZ2UgbGlmZWN5Y2xlIG9uIGFkZGVkIG5vZGUgYW5kIGl0J3Mgc3VidHJlZQpmdW5jdGlvbiBhZGRlZE5vZGUobm9kZSkgewogIHJldHVybiBhZGRlZChub2RlKSB8fCBhZGRlZFN1YnRyZWUobm9kZSk7Cn0KCi8vIHVwZ3JhZGUgY3VzdG9tIGVsZW1lbnRzIGF0IG5vZGUsIGlmIGFwcGxpY2FibGUKZnVuY3Rpb24gdXBncmFkZShub2RlKSB7CiAgaWYgKCFub2RlLl9fdXBncmFkZWRfXyAmJiBub2RlLm5vZGVUeXBlID09PSBOb2RlLkVMRU1FTlRfTk9ERSkgewogICAgdmFyIHR5cGUgPSBub2RlLmdldEF0dHJpYnV0ZSgnaXMnKSB8fCBub2RlLmxvY2FsTmFtZTsKICAgIHZhciBkZWZpbml0aW9uID0gc2NvcGUucmVnaXN0cnlbdHlwZV07CiAgICBpZiAoZGVmaW5pdGlvbikgewogICAgICBsb2dGbGFncy5kb20gJiYgY29uc29sZS5ncm91cCgndXBncmFkZTonLCBub2RlLmxvY2FsTmFtZSk7CiAgICAgIHNjb3BlLnVwZ3JhZGUobm9kZSk7CiAgICAgIGxvZ0ZsYWdzLmRvbSAmJiBjb25zb2xlLmdyb3VwRW5kKCk7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQogIH0KfQoKZnVuY3Rpb24gaW5zZXJ0ZWROb2RlKG5vZGUpIHsKICBpbnNlcnRlZChub2RlKTsKICBpZiAoaW5Eb2N1bWVudChub2RlKSkgewogICAgZm9yU3VidHJlZShub2RlLCBmdW5jdGlvbihlKSB7CiAgICAgIGluc2VydGVkKGUpOwogICAgfSk7CiAgfQp9CgovLyBUT0RPKHNqbWlsZXMpOiBpZiB0aGVyZSBhcmUgZGVzY2VudHMgaW50byB0cmVlcyB0aGF0IGNhbiBuZXZlciBoYXZlIGluRG9jdW1lbnQoKikgdHJ1ZSwgZml4IHRoaXMKCmZ1bmN0aW9uIGluc2VydGVkKGVsZW1lbnQpIHsKICAvLyBUT0RPKHNqbWlsZXMpOiBpdCdzIHBvc3NpYmxlIHdlIHdlcmUgaW5zZXJ0ZWQgYW5kIHJlbW92ZWQgaW4gdGhlIHNwYWNlCiAgLy8gb2Ygb25lIG1pY3JvdGFzaywgaW4gd2hpY2ggY2FzZSB3ZSB3b24ndCBiZSAnaW5Eb2N1bWVudCcgaGVyZQogIC8vIEJ1dCB0aGVyZSBhcmUgb3RoZXIgY2FzZXMgd2hlcmUgd2UgYXJlIHRlc3RpbmcgZm9yIGluc2VydGVkIHdpdGhvdXQKICAvLyBzcGVjaWZpYyBrbm93bGVkZ2Ugb2YgbXV0YXRpb25zLCBhbmQgbXVzdCB0ZXN0ICdpbkRvY3VtZW50JyB0byBkZXRlcm1pbmUKICAvLyB3aGV0aGVyIHRvIGNhbGwgaW5zZXJ0ZWQKICAvLyBJZiB3ZSBjYW4gZmFjdG9yIHRoZXNlIGNhc2VzIGludG8gc2VwYXJhdGUgY29kZSBwYXRocyB3ZSBjYW4gaGF2ZQogIC8vIGJldHRlciBkaWFnbm9zdGljcy4KICAvLyBUT0RPKHNqbWlsZXMpOiB3aGVuIGxvZ2dpbmcsIGRvIHdvcmsgb24gYWxsIGN1c3RvbSBlbGVtZW50cyBzbyB3ZSBjYW4KICAvLyB0cmFjayBiZWhhdmlvciBldmVuIHdoZW4gY2FsbGJhY2tzIG5vdCBkZWZpbmVkCiAgLy9jb25zb2xlLmxvZygnaW5zZXJ0ZWQ6ICcsIGVsZW1lbnQubG9jYWxOYW1lKTsKICBpZiAoZWxlbWVudC5pbnNlcnRlZENhbGxiYWNrIHx8IChlbGVtZW50Ll9fdXBncmFkZWRfXyAmJiBsb2dGbGFncy5kb20pKSB7CiAgICBsb2dGbGFncy5kb20gJiYgY29uc29sZS5ncm91cCgnaW5zZXJ0ZWQ6JywgZWxlbWVudC5sb2NhbE5hbWUpOwogICAgaWYgKGluRG9jdW1lbnQoZWxlbWVudCkpIHsKICAgICAgZWxlbWVudC5fX2luc2VydGVkID0gKGVsZW1lbnQuX19pbnNlcnRlZCB8fCAwKSArIDE7CiAgICAgIC8vIGlmIHdlIGFyZSBpbiBhICdyZW1vdmVkJyBzdGF0ZSwgYmx1bnRseSBhZGp1c3QgdG8gYW4gJ2luc2VydGVkJyBzdGF0ZQogICAgICBpZiAoZWxlbWVudC5fX2luc2VydGVkIDwgMSkgewogICAgICAgIGVsZW1lbnQuX19pbnNlcnRlZCA9IDE7CiAgICAgIH0KICAgICAgLy8gaWYgd2UgYXJlICdvdmVyIGluc2VydGVkJywgc3F1ZWxjaCB0aGUgY2FsbGJhY2sKICAgICAgaWYgKGVsZW1lbnQuX19pbnNlcnRlZCA+IDEpIHsKICAgICAgICBsb2dGbGFncy5kb20gJiYgY29uc29sZS53YXJuKCdpbnNlcnRlZDonLCBlbGVtZW50LmxvY2FsTmFtZSwKICAgICAgICAgICdpbnNlcnQvcmVtb3ZlIGNvdW50OicsIGVsZW1lbnQuX19pbnNlcnRlZCkKICAgICAgfSBlbHNlIGlmIChlbGVtZW50Lmluc2VydGVkQ2FsbGJhY2spIHsKICAgICAgICBsb2dGbGFncy5kb20gJiYgY29uc29sZS5sb2coJ2luc2VydGVkOicsIGVsZW1lbnQubG9jYWxOYW1lKTsKICAgICAgICBlbGVtZW50Lmluc2VydGVkQ2FsbGJhY2soKTsKICAgICAgfQogICAgfQogICAgbG9nRmxhZ3MuZG9tICYmIGNvbnNvbGUuZ3JvdXBFbmQoKTsKICB9Cn0KCmZ1bmN0aW9uIHJlbW92ZWROb2RlKG5vZGUpIHsKICByZW1vdmVkKG5vZGUpOwogIGZvclN1YnRyZWUobm9kZSwgZnVuY3Rpb24oZSkgewogICAgcmVtb3ZlZChlKTsKICB9KTsKfQoKZnVuY3Rpb24gcmVtb3ZlZChlbGVtZW50KSB7CiAgLy8gVE9ETyhzam1pbGVzKTogdGVtcG9yYXJ5OiBkbyB3b3JrIG9uIGFsbCBjdXN0b20gZWxlbWVudHMgc28gd2UgY2FuIHRyYWNrCiAgLy8gYmVoYXZpb3IgZXZlbiB3aGVuIGNhbGxiYWNrcyBub3QgZGVmaW5lZAogIGlmIChlbGVtZW50LnJlbW92ZWRDYWxsYmFjayB8fCAoZWxlbWVudC5fX3VwZ3JhZGVkX18gJiYgbG9nRmxhZ3MuZG9tKSkgewogICAgbG9nRmxhZ3MuZG9tICYmIGNvbnNvbGUubG9nKCdyZW1vdmVkOicsIGVsZW1lbnQubG9jYWxOYW1lKTsKICAgIGlmICghaW5Eb2N1bWVudChlbGVtZW50KSkgewogICAgICBlbGVtZW50Ll9faW5zZXJ0ZWQgPSAoZWxlbWVudC5fX2luc2VydGVkIHx8IDApIC0gMTsKICAgICAgLy8gaWYgd2UgYXJlIGluIGEgJ2luc2VydGVkJyBzdGF0ZSwgYmx1bnRseSBhZGp1c3QgdG8gYW4gJ3JlbW92ZWQnIHN0YXRlCiAgICAgIGlmIChlbGVtZW50Ll9faW5zZXJ0ZWQgPiAwKSB7CiAgICAgICAgZWxlbWVudC5fX2luc2VydGVkID0gMDsKICAgICAgfQogICAgICAvLyBpZiB3ZSBhcmUgJ292ZXIgcmVtb3ZlZCcsIHNxdWVsY2ggdGhlIGNhbGxiYWNrCiAgICAgIGlmIChlbGVtZW50Ll9faW5zZXJ0ZWQgPCAwKSB7CiAgICAgICAgbG9nRmxhZ3MuZG9tICYmIGNvbnNvbGUud2FybigncmVtb3ZlZDonLCBlbGVtZW50LmxvY2FsTmFtZSwKICAgICAgICAgICAgJ2luc2VydC9yZW1vdmUgY291bnQ6JywgZWxlbWVudC5fX2luc2VydGVkKQogICAgICB9IGVsc2UgaWYgKGVsZW1lbnQucmVtb3ZlZENhbGxiYWNrKSB7CiAgICAgICAgZWxlbWVudC5yZW1vdmVkQ2FsbGJhY2soKTsKICAgICAgfQogICAgfQogIH0KfQoKZnVuY3Rpb24gaW5Eb2N1bWVudChlbGVtZW50KSB7CiAgdmFyIHAgPSBlbGVtZW50OwogIHdoaWxlIChwKSB7CiAgICBpZiAocCA9PSBlbGVtZW50Lm93bmVyRG9jdW1lbnQpIHsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICBwID0gcC5wYXJlbnROb2RlIHx8IHAuaG9zdDsKICB9Cn0KCmZ1bmN0aW9uIHdhdGNoU2hhZG93KG5vZGUpIHsKICBpZiAobm9kZS53ZWJraXRTaGFkb3dSb290ICYmICFub2RlLndlYmtpdFNoYWRvd1Jvb3QuX193YXRjaGVkKSB7CiAgICBsb2dGbGFncy5kb20gJiYgY29uc29sZS5sb2coJ3dhdGNoaW5nIHNoYWRvdy1yb290IGZvcjogJywgbm9kZS5sb2NhbE5hbWUpOwogICAgb2JzZXJ2ZShub2RlLndlYmtpdFNoYWRvd1Jvb3QpOwogICAgbm9kZS53ZWJraXRTaGFkb3dSb290Ll9fd2F0Y2hlZCA9IHRydWU7CiAgfQp9CgpmdW5jdGlvbiB3YXRjaEFsbFNoYWRvd3Mobm9kZSkgewogIHdhdGNoU2hhZG93KG5vZGUpOwogIGZvclN1YnRyZWUobm9kZSwgZnVuY3Rpb24oZSkgewogICAgd2F0Y2hTaGFkb3cobm9kZSk7CiAgfSk7Cn0KCmZ1bmN0aW9uIGZpbHRlcihpbk5vZGUpIHsKICBzd2l0Y2ggKGluTm9kZS5sb2NhbE5hbWUpIHsKICAgIGNhc2UgJ3N0eWxlJzoKICAgIGNhc2UgJ3NjcmlwdCc6CiAgICBjYXNlICd0ZW1wbGF0ZSc6CiAgICBjYXNlIHVuZGVmaW5lZDoKICAgICAgcmV0dXJuIHRydWU7CiAgfQp9CgpmdW5jdGlvbiBoYW5kbGVyKG11dGF0aW9ucykgewogIC8vCiAgaWYgKGxvZ0ZsYWdzLmRvbSkgewogICAgdmFyIG14ID0gbXV0YXRpb25zWzBdOwogICAgaWYgKG14ICYmIG14LnR5cGUgPT09ICdjaGlsZExpc3QnICYmIG14LmFkZGVkTm9kZXMpIHsKICAgICAgICBpZiAobXguYWRkZWROb2RlcykgewogICAgICAgICAgdmFyIGQgPSBteC5hZGRlZE5vZGVzWzBdOwogICAgICAgICAgd2hpbGUgKGQgJiYgZCAhPT0gZG9jdW1lbnQgJiYgIWQuaG9zdCkgewogICAgICAgICAgICBkID0gZC5wYXJlbnROb2RlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHUgPSBkICYmIChkLlVSTCB8fCBkLl9VUkwgfHwgKGQuaG9zdCAmJiBkLmhvc3QubG9jYWxOYW1lKSkgfHwgJyc7CiAgICAgICAgICB1ID0gdS5zcGxpdCgnLz8nKS5zaGlmdCgpLnNwbGl0KCcvJykucG9wKCk7CiAgICAgICAgfQogICAgfQogICAgY29uc29sZS5ncm91cCgnbXV0YXRpb25zICglZCkgWyVzXScsIG11dGF0aW9ucy5sZW5ndGgsIHUgfHwgJycpOwogIH0KICAvLwogIG11dGF0aW9ucy5mb3JFYWNoKGZ1bmN0aW9uKG14KSB7CiAgICAvL2xvZ0ZsYWdzLmRvbSAmJiBjb25zb2xlLmdyb3VwKCdtdXRhdGlvbicpOwogICAgaWYgKG14LnR5cGUgPT09ICdjaGlsZExpc3QnKSB7CiAgICAgIGZvckVhY2gobXguYWRkZWROb2RlcywgZnVuY3Rpb24obikgewogICAgICAgIC8vbG9nRmxhZ3MuZG9tICYmIGNvbnNvbGUubG9nKG4ubG9jYWxOYW1lKTsKICAgICAgICBpZiAoZmlsdGVyKG4pKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIC8vIHdhdGNoIHNoYWRvdy1yb290cyBvbiBub2RlcyB0aGF0IGhhdmUgaGFkIHRoZW0gYXR0YWNoZWQgbWFudWFsbHkKICAgICAgICAvLyBUT0RPKHNqbWlsZXMpOiByZW1vdmUgaWYgY3JlYXRlU2hhZG93Um9vdCBpcyBvdmVycmlkZGVuCiAgICAgICAgLy8gVE9ETyhzam1pbGVzKTogcmVtb3ZlZCBhcyBhbiBvcHRpbWl6YXRpb24sIG1hbnVhbCBzaGFkb3cgcm9vdHMKICAgICAgICAvLyBtdXN0IGJlIHdhdGNoZWQgZXhwbGljaXRseQogICAgICAgIC8vd2F0Y2hBbGxTaGFkb3dzKG4pOwogICAgICAgIC8vIG5vZGVzIGFkZGVkIG1heSBuZWVkIGxpZmVjeWNsZSBtYW5hZ2VtZW50CiAgICAgICAgYWRkZWROb2RlKG4pOwogICAgICB9KTsKICAgICAgLy8gcmVtb3ZlZCBub2RlcyBtYXkgbmVlZCBsaWZlY3ljbGUgbWFuYWdlbWVudAogICAgICBmb3JFYWNoKG14LnJlbW92ZWROb2RlcywgZnVuY3Rpb24obikgewogICAgICAgIC8vbG9nRmxhZ3MuZG9tICYmIGNvbnNvbGUubG9nKG4ubG9jYWxOYW1lKTsKICAgICAgICBpZiAoZmlsdGVyKG4pKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHJlbW92ZWROb2RlKG4pOwogICAgICB9KTsKICAgIH0KICAgIC8vbG9nRmxhZ3MuZG9tICYmIGNvbnNvbGUuZ3JvdXBFbmQoKTsKICB9KTsKICBsb2dGbGFncy5kb20gJiYgY29uc29sZS5ncm91cEVuZCgpOwp9OwoKdmFyIG9ic2VydmVyID0gbmV3IE11dGF0aW9uT2JzZXJ2ZXIoaGFuZGxlcik7CgpmdW5jdGlvbiB0YWtlUmVjb3JkcygpIHsKICAvLyBUT0RPKHNqbWlsZXMpOiBhc2sgUmFmIHdoeSB3ZSBoYXZlIHRvIGNhbGwgaGFuZGxlciBvdXJzZWx2ZXMKICBoYW5kbGVyKG9ic2VydmVyLnRha2VSZWNvcmRzKCkpOwp9Cgp2YXIgZm9yRWFjaCA9IEFycmF5LnByb3RvdHlwZS5mb3JFYWNoLmNhbGwuYmluZChBcnJheS5wcm90b3R5cGUuZm9yRWFjaCk7CgpmdW5jdGlvbiBvYnNlcnZlKGluUm9vdCkgewogIG9ic2VydmVyLm9ic2VydmUoaW5Sb290LCB7Y2hpbGRMaXN0OiB0cnVlLCBzdWJ0cmVlOiB0cnVlfSk7Cn0KCmZ1bmN0aW9uIG9ic2VydmVEb2N1bWVudChkb2N1bWVudCkgewogIG9ic2VydmUoZG9jdW1lbnQpOwp9CgpmdW5jdGlvbiB1cGdyYWRlRG9jdW1lbnQoZG9jdW1lbnQpIHsKICBsb2dGbGFncy5kb20gJiYgY29uc29sZS5ncm91cCgndXBncmFkZURvY3VtZW50OiAnLCAoZG9jdW1lbnQuVVJMIHx8IGRvY3VtZW50Ll9VUkwgfHwgJycpLnNwbGl0KCcvJykucG9wKCkpOwogIGFkZGVkTm9kZShkb2N1bWVudCk7CiAgbG9nRmxhZ3MuZG9tICYmIGNvbnNvbGUuZ3JvdXBFbmQoKTsKfQoKLy8gZXhwb3J0cwoKc2NvcGUud2F0Y2hTaGFkb3cgPSB3YXRjaFNoYWRvdzsKc2NvcGUud2F0Y2hBbGxTaGFkb3dzID0gd2F0Y2hBbGxTaGFkb3dzOwoKc2NvcGUudXBncmFkZUFsbCA9IGFkZGVkTm9kZTsKc2NvcGUudXBncmFkZVN1YnRyZWUgPSBhZGRlZFN1YnRyZWU7CgpzY29wZS5vYnNlcnZlRG9jdW1lbnQgPSBvYnNlcnZlRG9jdW1lbnQ7CnNjb3BlLnVwZ3JhZGVEb2N1bWVudCA9IHVwZ3JhZGVEb2N1bWVudDsKCnNjb3BlLnRha2VSZWNvcmRzID0gdGFrZVJlY29yZHM7Cgp9KSh3aW5kb3cuQ3VzdG9tRWxlbWVudHMpOwoKLyoKICogQ29weXJpZ2h0IDIwMTMgVGhlIFBvbHltZXIgQXV0aG9ycy4gQWxsIHJpZ2h0cyByZXNlcnZlZC4KICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYSBCU0Qtc3R5bGUKICogbGljZW5zZSB0aGF0IGNhbiBiZSBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlLgogKi8KCihmdW5jdGlvbigpewogIAp2YXIgSFRNTEVsZW1lbnRFbGVtZW50ID0gZnVuY3Rpb24oaW5FbGVtZW50KSB7CiAgaW5FbGVtZW50LnJlZ2lzdGVyID0gSFRNTEVsZW1lbnRFbGVtZW50LnByb3RvdHlwZS5yZWdpc3RlcjsKICBwYXJzZUVsZW1lbnRFbGVtZW50KGluRWxlbWVudCk7CiAgcmV0dXJuIGluRWxlbWVudDsKfTsKCkhUTUxFbGVtZW50RWxlbWVudC5wcm90b3R5cGUgPSB7CiAgcmVnaXN0ZXI6IGZ1bmN0aW9uKGluTW9yZSkgewogICAgaWYgKGluTW9yZSkgewogICAgICB0aGlzLm9wdGlvbnMubGlmZWN5Y2xlID0gaW5Nb3JlLmxpZmVjeWNsZTsKICAgICAgaWYgKGluTW9yZS5wcm90b3R5cGUpIHsKICAgICAgICBtaXhpbih0aGlzLm9wdGlvbnMucHJvdG90eXBlLCBpbk1vcmUucHJvdG90eXBlKTsKICAgICAgfQogICAgfQogIH0KfTsKCmZ1bmN0aW9uIHBhcnNlRWxlbWVudEVsZW1lbnQoaW5FbGVtZW50KSB7CiAgLy8gb3B0aW9ucyB0byBnbGVhbiBmcm9tIGluRWxlbWVudCBhdHRyaWJ1dGVzCiAgdmFyIG9wdGlvbnMgPSB7CiAgICBuYW1lOiAnJywKICAgIGV4dGVuZHM6IG51bGwKICB9OwogIC8vIGdsZWFuIHRoZW0KICB0YWtlQXR0cmlidXRlcyhpbkVsZW1lbnQsIG9wdGlvbnMpOwogIC8vIGRlZmF1bHQgYmFzZQogIHZhciBiYXNlID0gSFRNTEVsZW1lbnQucHJvdG90eXBlOwogIC8vIG9wdGlvbmFsIHNwZWNpZmllZCBiYXNlCiAgaWYgKG9wdGlvbnMuZXh0ZW5kcykgewogICAgLy8gYnVpbGQgYW4gaW5zdGFuY2Ugb2Ygb3B0aW9ucy5leHRlbmRzCiAgICB2YXIgYXJjaGV0eXBlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChvcHRpb25zLmV4dGVuZHMpOwogICAgLy8gYWNxdWlyZSB0aGUgcHJvdG90eXBlCiAgICAvLyBUT0RPKHNqbWlsZXMpOiBfX3Byb3RvX18gbWF5IGJlIGhpbnRlZCBieSB0aGUgY3VzdG9tIGVsZW1lbnQKICAgIC8vIHN5c3RlbSBvbiBwbGF0Zm9ybXMgdGhhdCBkb24ndCBzdXBwb3J0IG5hdGl2ZSBfX3Byb3RvX18KICAgIC8vIG9uIHRob3NlIHBsYXRmb3JtcyB0aGUgQVBJIGlzIG1peGVkIGludG8gYXJjaGV0eXBlIGFuZCB0aGUKICAgIC8vIGVmZmVjdGl2ZSBiYXNlIGlzIG5vdCBhcmNoZXR5cGUncyByZWFsIHByb3RvdHlwZQogICAgYmFzZSA9IGFyY2hldHlwZS5fX3Byb3RvX18gfHwgT2JqZWN0LmdldFByb3RvdHlwZU9mKGFyY2hldHlwZSk7CiAgfQogIC8vIGV4dGVuZCBiYXNlCiAgb3B0aW9ucy5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKGJhc2UpOwogIC8vIGluc3RhbGwgb3B0aW9ucwogIGluRWxlbWVudC5vcHRpb25zID0gb3B0aW9uczsKICAvLyBsb2NhdGUgdXNlciBzY3JpcHQKICB2YXIgc2NyaXB0ID0gaW5FbGVtZW50LnF1ZXJ5U2VsZWN0b3IoJ3NjcmlwdCxzY3JpcHRzJyk7CiAgaWYgKHNjcmlwdCkgewogICAgLy8gZXhlY3V0ZSB1c2VyIHNjcmlwdCBpbiAnaW5FbGVtZW50JyBjb250ZXh0CiAgICBleGVjdXRlQ29tcG9uZW50U2NyaXB0KHNjcmlwdC50ZXh0Q29udGVudCwgaW5FbGVtZW50LCBvcHRpb25zLm5hbWUpOwogIH07CiAgLy8gcmVnaXN0ZXIgb3VyIG5ldyBlbGVtZW50CiAgdmFyIGN0b3IgPSBkb2N1bWVudC5yZWdpc3RlcihvcHRpb25zLm5hbWUsIG9wdGlvbnMpOwogIGluRWxlbWVudC5jdG9yID0gY3RvcjsKICAvLyBzdG9yZSBvcHRpb25hbCBjb25zdHJ1Y3RvciByZWZlcmVuY2UKICB2YXIgcmVmTmFtZSA9IGluRWxlbWVudC5nZXRBdHRyaWJ1dGUoJ2NvbnN0cnVjdG9yJyk7CiAgaWYgKHJlZk5hbWUpIHsKICAgIHdpbmRvd1tyZWZOYW1lXSA9IGN0b3I7CiAgfQp9CiAgCi8vIGVhY2ggcHJvcGVydHkgaW4gaW5EaWN0aW9uYXJ5IHRha2VzIGEgdmFsdWUKLy8gZnJvbSB0aGUgbWF0Y2hpbmcgYXR0cmlidXRlIGluIGluRWxlbWVudCwgaWYgYW55CmZ1bmN0aW9uIHRha2VBdHRyaWJ1dGVzKGluRWxlbWVudCwgaW5EaWN0aW9uYXJ5KSB7CiAgZm9yICh2YXIgbiBpbiBpbkRpY3Rpb25hcnkpIHsKICAgIHZhciBhID0gaW5FbGVtZW50LmF0dHJpYnV0ZXNbbl07CiAgICBpZiAoYSkgewogICAgICBpbkRpY3Rpb25hcnlbbl0gPSBhLnZhbHVlOwogICAgfQogIH0KfQoKLy8gaW52b2tlIGluU2NyaXB0IGluIGluQ29udGV4dCBzY29wZQpmdW5jdGlvbiBleGVjdXRlQ29tcG9uZW50U2NyaXB0KGluU2NyaXB0LCBpbkNvbnRleHQsIGluTmFtZSkgewogIC8vIHNldCAoaGlnaGxhbmRlcikgY29udGV4dAogIGNvbnRleHQgPSBpbkNvbnRleHQ7CiAgLy8gc291cmNlIGxvY2F0aW9uCiAgdmFyIG93bmVyID0gY29udGV4dC5vd25lckRvY3VtZW50OwogIHZhciB1cmwgPSAob3duZXIuX1VSTCB8fCBvd25lci5VUkwgfHwgb3duZXIuaW1wbCAKICAgICAgJiYgKG93bmVyLmltcGwuX1VSTCB8fCBvd25lci5pbXBsLlVSTCkpOwogIC8vIGVuc3VyZSB0aGUgY29tcG9uZW50IGhhcyBhIHVuaXF1ZSBzb3VyY2UgbWFwIHNvIGl0IGNhbiBiZSBkZWJ1Z2dlZAogIC8vIGlmIHRoZSBuYW1lIG1hdGNoZXMgdGhlIGZpbGVuYW1lIHBhcnQgb2YgdGhlIG93bmluZyBkb2N1bWVudCdzIHVybCwKICAvLyB1c2UgdGhpcywgb3RoZXJ3aXNlLCBhZGQgIjo8bmFtZT4iIHRvIHRoZSBkb2N1bWVudCB1cmwuCiAgdmFyIG1hdGNoID0gdXJsLm1hdGNoKC8uKlwvKFteLl0qKVsuXT8uKiQvKTsKICBpZiAobWF0Y2gpIHsKICAgIHZhciBuYW1lID0gbWF0Y2hbMV07CiAgICB1cmwgKz0gbmFtZSAhPSBpbk5hbWUgPyAnOicgKyBpbk5hbWUgOiAnJzsKICB9CiAgLy8gY29tcG9zZSBzY3JpcHQKICB2YXIgY29kZSA9ICJfX2NvbXBvbmVudFNjcmlwdCgnIgogICAgKyBpbk5hbWUKICAgICsgIicsIGZ1bmN0aW9uKCl7IgogICAgKyBpblNjcmlwdAogICAgKyAifSk7IgogICAgKyAiXG4vL0Agc291cmNlVVJMPSIgKyB1cmwgKyAiXG4iCiAgOwogIC8vIGluamVjdCBzY3JpcHQKICBldmFsKGNvZGUpOwp9Cgp2YXIgY29udGV4dDsKCi8vIGdsb2JhbCBuZWNlc3NhcnkgZm9yIHNjcmlwdCBpbmplY3Rpb24Kd2luZG93Ll9fY29tcG9uZW50U2NyaXB0ID0gZnVuY3Rpb24oaW5OYW1lLCBpbkZ1bmMpIHsKICBpbkZ1bmMuY2FsbChjb250ZXh0KTsKfTsKCi8vIHV0aWxpdHkKCi8vIGNvcHkgdG9wIGxldmVsIHByb3BlcnRpZXMgZnJvbSBwcm9wcyB0byBvYmoKZnVuY3Rpb24gbWl4aW4ob2JqLCBwcm9wcykgewogIG9iaiA9IG9iaiB8fCB7fTsKICB0cnkgewogICAgT2JqZWN0LmdldE93blByb3BlcnR5TmFtZXMocHJvcHMpLmZvckVhY2goZnVuY3Rpb24obikgewogICAgICB2YXIgcGQgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHByb3BzLCBuKTsKICAgICAgaWYgKHBkKSB7CiAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KG9iaiwgbiwgcGQpOwogICAgICB9CiAgICB9KTsKICB9IGNhdGNoKHgpIHsKICB9CiAgcmV0dXJuIG9iajsKfQoKLy8gZXhwb3J0cwoKd2luZG93LkhUTUxFbGVtZW50RWxlbWVudCA9IEhUTUxFbGVtZW50RWxlbWVudDsKCn0pKCk7CgovKgogKiBDb3B5cmlnaHQgMjAxMyBUaGUgUG9seW1lciBBdXRob3JzLiBBbGwgcmlnaHRzIHJlc2VydmVkLgogKiBVc2Ugb2YgdGhpcyBzb3VyY2UgY29kZSBpcyBnb3Zlcm5lZCBieSBhIEJTRC1zdHlsZQogKiBsaWNlbnNlIHRoYXQgY2FuIGJlIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUuCiAqLwoKKGZ1bmN0aW9uKCkgewoKdmFyIElNUE9SVF9MSU5LX1RZUEUgPSAnaW1wb3J0JzsKCi8vIGhpZ2hsYW5kZXIgb2JqZWN0IGZvciBwYXJzaW5nIGEgZG9jdW1lbnQgdHJlZQoKdmFyIGNvbXBvbmVudFBhcnNlciA9IHsKICBzZWxlY3RvcnM6IFsKICAgICdsaW5rW3JlbD0nICsgSU1QT1JUX0xJTktfVFlQRSArICddJywKICAgICdsaW5rW3JlbD1zdHlsZXNoZWV0XScsCiAgICAnc2NyaXB0W3NyY10nLAogICAgJ3NjcmlwdCcsCiAgICAnc3R5bGUnLAogICAgJ2VsZW1lbnQnCiAgXSwKICBtYXA6IHsKICAgIGxpbms6ICdwYXJzZUxpbmsnLAogICAgc2NyaXB0OiAncGFyc2VTY3JpcHQnLAogICAgZWxlbWVudDogJ3BhcnNlRWxlbWVudCcsCiAgICBzdHlsZTogJ3BhcnNlU3R5bGUnCiAgfSwKICBwYXJzZTogZnVuY3Rpb24oaW5Eb2N1bWVudCkgewogICAgaWYgKCFpbkRvY3VtZW50Ll9fcGFyc2VkKSB7CiAgICAgIC8vIG9ubHkgcGFyc2Ugb25jZQogICAgICBpbkRvY3VtZW50Ll9fcGFyc2VkID0gdHJ1ZTsKICAgICAgLy8gYWxsIHBhcnNhYmxlIGVsZW1lbnRzIGluIGluRG9jdW1lbnQgKGRlcHRoLWZpcnN0IHByZS1vcmRlciB0cmF2ZXJzYWwpCiAgICAgIHZhciBlbHRzID0gaW5Eb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKGNwLnNlbGVjdG9ycyk7CiAgICAgIC8vIGZvciBlYWNoIHBhcnNhYmxlIG5vZGUgdHlwZSwgY2FsbCB0aGUgbWFwcGVkIHBhcnNpbmcgbWV0aG9kCiAgICAgIGZvckVhY2goZWx0cywgZnVuY3Rpb24oZSkgewogICAgICAgIC8vY29uc29sZS5sb2cobWFwW2UubG9jYWxOYW1lXSArICI6IiwgcGF0aC5ub2RlVXJsKGUpKTsKICAgICAgICBjcFtjcC5tYXBbZS5sb2NhbE5hbWVdXShlKTsKICAgICAgfSk7CiAgICAgIC8vIHVwZ3JhZGUgYWxsIHVwZ3JhZGVhYmxlIHN0YXRpYyBlbGVtZW50cywgYW55dGhpbmcgZHluYW1pY2FsbHkKICAgICAgLy8gY3JlYXRlZCBzaG91bGQgYmUgY2F1Z2h0IGJ5IG9ic2VydmVyCiAgICAgIEN1c3RvbUVsZW1lbnRzLnVwZ3JhZGVEb2N1bWVudChpbkRvY3VtZW50KTsKICAgICAgLy8gb2JzZXJ2ZSBkb2N1bWVudCBmb3IgZG9tIGNoYW5nZXMKICAgICAgQ3VzdG9tRWxlbWVudHMub2JzZXJ2ZURvY3VtZW50KGluRG9jdW1lbnQpOwogICAgfQogIH0sCiAgcGFyc2VMaW5rOiBmdW5jdGlvbihpbkxpbmtFbHQpIHsKICAgIC8vIGltcG9ydHMKICAgIGlmIChpc0RvY3VtZW50TGluayhpbkxpbmtFbHQpKSB7CiAgICAgIGlmIChpbkxpbmtFbHQuY29udGVudCkgewogICAgICAgIGNwLnBhcnNlKGluTGlua0VsdC5jb250ZW50KTsKICAgICAgfQogICAgfSBlbHNlIGlmIChjYW5BZGRUb01haW5Eb3VtZW50KGluTGlua0VsdCkpIHsKICAgICAgZG9jdW1lbnQuaGVhZC5hcHBlbmRDaGlsZChpbkxpbmtFbHQpOwogICAgfQogIH0sCiAgcGFyc2VTY3JpcHQ6IGZ1bmN0aW9uKGluU2NyaXB0RWx0KSB7CiAgICBpZiAoY2FuQWRkVG9NYWluRG91bWVudChpblNjcmlwdEVsdCkpIHsKICAgICAgLy8gb3RoZXJ3aXNlLCBldmFsdWF0ZSBub3cKICAgICAgdmFyIGNvZGUgPSBpblNjcmlwdEVsdC5fX3Jlc291cmNlIHx8IGluU2NyaXB0RWx0LnRleHRDb250ZW50OwogICAgICBpZiAoY29kZSkgewogICAgICAgIGNvZGUgKz0gIlxuLy9AIHNvdXJjZVVSTD0iICsgaW5TY3JpcHRFbHQuX19ub2RlVXJsICsgIlxuIjsKICAgICAgICBldmFsLmNhbGwod2luZG93LCBjb2RlKTsKICAgICAgfQogICAgfQogIH0sCiAgcGFyc2VTdHlsZTogZnVuY3Rpb24oaW5TdHlsZUVsdCkgewogICAgaWYgKGNhbkFkZFRvTWFpbkRvdW1lbnQoaW5TdHlsZUVsdCkpIHsKICAgICAgZG9jdW1lbnQuaGVhZC5hcHBlbmRDaGlsZChpblN0eWxlRWx0KTsKICAgIH0KICB9LAogIHBhcnNlRWxlbWVudDogZnVuY3Rpb24oaW5FbGVtZW50RWx0KSB7CiAgICBuZXcgSFRNTEVsZW1lbnRFbGVtZW50KGluRWxlbWVudEVsdCk7CiAgfQp9OwoKdmFyIGNwID0gY29tcG9uZW50UGFyc2VyOwoKLy8gbm9kZXMgY2FuIGJlIG1vdmVkIHRvIHRoZSBtYWluIGRvY3VtZW50Ci8vIGlmIHRoZXkgYXJlIG5vdCBpbiB0aGUgbWFpbiBkb2N1bWVudCwgYXJlIG5vdCBjaGlsZHJlbiBvZiA8ZWxlbWVudD4KLy8gYW5kIGFyZSBpbiBhIHRyZWUgYXQgcGFyc2UgdGltZS4KZnVuY3Rpb24gY2FuQWRkVG9NYWluRG91bWVudChub2RlKSB7CiAgcmV0dXJuICFpbk1haW5Eb2N1bWVudChub2RlKQogICAgJiYgbm9kZS5wYXJlbnROb2RlCiAgICAmJiAhaXNFbGVtZW50RWxlbWVudENoaWxkKG5vZGUpOwp9CgpmdW5jdGlvbiBpbk1haW5Eb2N1bWVudChpbkVsdCkgewogIHJldHVybiBpbkVsdC5vd25lckRvY3VtZW50ID09PSBkb2N1bWVudCB8fAogICAgLy8gVE9ETyhzam1pbGVzKTogU2hhZG93RE9NUG9seWZpbGwgaW50cnVzaW9uCiAgICBpbkVsdC5vd25lckRvY3VtZW50LmltcGwgPT09IGRvY3VtZW50Owp9CgpmdW5jdGlvbiBpc0RvY3VtZW50TGluayhpbkVsdCkgewogIHJldHVybiAoaW5FbHQubG9jYWxOYW1lID09PSAnbGluaycKICAgICAgJiYgaW5FbHQuZ2V0QXR0cmlidXRlKCdyZWwnKSA9PT0gSU1QT1JUX0xJTktfVFlQRSk7Cn0KCmZ1bmN0aW9uIGlzRWxlbWVudEVsZW1lbnRDaGlsZChpbkVsdCkgewogIGlmIChpbkVsdC5wYXJlbnROb2RlICYmIGluRWx0LnBhcmVudE5vZGUubG9jYWxOYW1lID09PSAnZWxlbWVudCcpIHsKICAgIHJldHVybiB0cnVlOwogIH0KfQoKdmFyIGZvckVhY2ggPSBBcnJheS5wcm90b3R5cGUuZm9yRWFjaC5jYWxsLmJpbmQoQXJyYXkucHJvdG90eXBlLmZvckVhY2gpOwoKLy8gZXhwb3J0cwoKQ3VzdG9tRWxlbWVudHMucGFyc2VyID0gY29tcG9uZW50UGFyc2VyOwoKfSkoKTsKLyoKICogQ29weXJpZ2h0IDIwMTMgVGhlIFBvbHltZXIgQXV0aG9ycy4gQWxsIHJpZ2h0cyByZXNlcnZlZC4KICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYSBCU0Qtc3R5bGUKICogbGljZW5zZSB0aGF0IGNhbiBiZSBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlLgogKi8KKGZ1bmN0aW9uKCl7CgovLyBib290c3RyYXAgcGFyc2luZwoKLy8gSUUgc2hpbSBmb3IgQ3VzdG9tRXZlbnQKaWYgKHR5cGVvZiB3aW5kb3cuQ3VzdG9tRXZlbnQgIT09ICdmdW5jdGlvbicpIHsKICB3aW5kb3cuQ3VzdG9tRXZlbnQgPSBmdW5jdGlvbihpblR5cGUpIHsKICAgICB2YXIgZSA9IGRvY3VtZW50LmNyZWF0ZUV2ZW50KCdIVE1MRXZlbnRzJyk7CiAgICAgZS5pbml0RXZlbnQoaW5UeXBlLCB0cnVlLCB0cnVlKTsKICAgICByZXR1cm4gZTsKICB9Owp9CgpmdW5jdGlvbiBib290c3RyYXAoKSB7CiAgLy8gZ28gYXN5bmMgc28gY2FsbCBzdGFjayBjYW4gdW53aW5kCiAgc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgIC8vIHBhcnNlIGRvY3VtZW50CiAgICBDdXN0b21FbGVtZW50cy5wYXJzZXIucGFyc2UoZG9jdW1lbnQpOwogICAgLy8gc2V0IGludGVybmFsIGZsYWcKICAgIEN1c3RvbUVsZW1lbnRzLnJlYWR5ID0gdHJ1ZTsKICAgIEN1c3RvbUVsZW1lbnRzLnJlYWR5VGltZSA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpOwogICAgaWYgKHdpbmRvdy5IVE1MSW1wb3J0cykgewogICAgICBDdXN0b21FbGVtZW50cy5lbGFwc2VkID0gQ3VzdG9tRWxlbWVudHMucmVhZHlUaW1lIC0gSFRNTEltcG9ydHMucmVhZHlUaW1lOwogICAgfQogICAgLy8gbm90aWZ5IHN5c3RlbQogICAgZG9jdW1lbnQuYm9keS5kaXNwYXRjaEV2ZW50KAogICAgICBuZXcgQ3VzdG9tRXZlbnQoJ1dlYkNvbXBvbmVudHNSZWFkeScsIHtidWJibGVzOiB0cnVlfSkKICAgICk7CiAgfSwgMCk7Cn0KCi8vIFRPRE8oc2ptaWxlcyk6ICd3aW5kb3cnIGhhcyBubyB3cmFwcGFiaWxpdHkgdW5kZXIgU2hhZG93RE9NIHBvbHlmaWxsLCBzbwovLyB3ZSBhcmUgZm9yY2VkIHRvIHNwbGl0IGludG8gdHdvIHZlcnNpb25zCgppZiAod2luZG93LkhUTUxJbXBvcnRzKSB7CiAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignSFRNTEltcG9ydHNMb2FkZWQnLCBib290c3RyYXApOwp9IGVsc2UgewogIGlmIChkb2N1bWVudC5yZWFkeVN0YXRlID09PSAnY29tcGxldGUnIHx8IGRvY3VtZW50LnJlYWR5U3RhdGUgPT09ICdpbnRlcmFjdGl2ZScpIHsKICAgIGJvb3N0cmFwKCk7CiAgfSBlbHNlIHsKICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdET01Db250ZW50TG9hZGVkJywgYm9vdHN0cmFwKTsKICB9Cn0KCn0pKCk7CgovKgogKiBDb3B5cmlnaHQgMjAxMyBUaGUgUG9seW1lciBBdXRob3JzLiBBbGwgcmlnaHRzIHJlc2VydmVkLgogKiBVc2Ugb2YgdGhpcyBzb3VyY2UgY29kZSBpcyBnb3Zlcm5lZCBieSBhIEJTRC1zdHlsZQogKiBsaWNlbnNlIHRoYXQgY2FuIGJlIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUuCiAqLwooZnVuY3Rpb24oKSB7CgovLyBpbmplY3Qgc3R5bGUgc2hlZXQKdmFyIHN0eWxlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc3R5bGUnKTsKc3R5bGUudGV4dENvbnRlbnQgPSAnZWxlbWVudCB7ZGlzcGxheTogbm9uZTt9IC8qIGluamVjdGVkIGJ5IHBsYXRmb3JtLmpzICovJzsKdmFyIGhlYWQgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdoZWFkJyk7CmhlYWQuaW5zZXJ0QmVmb3JlKHN0eWxlLCBoZWFkLmZpcnN0Q2hpbGQpOwoKaWYgKHdpbmRvdy5TaGFkb3dET01Qb2x5ZmlsbCkgewoKICBmdW5jdGlvbiBub3AoKSB7fTsKCiAgLy8gZGlzYWJsZSBzaGFkb3cgZG9tIHdhdGNoaW5nCiAgQ3VzdG9tRWxlbWVudHMud2F0Y2hTaGFkb3cgPSBub3A7CiAgQ3VzdG9tRWxlbWVudHMud2F0Y2hBbGxTaGFkb3dzID0gbm9wOwoKICAvLyBlbnN1cmUgd3JhcHBlZCBpbnB1dHMgZm9yIHRoZXNlIGZ1bmN0aW9ucwogIHZhciBmbnMgPSBbJ3VwZ3JhZGVBbGwnLCAndXBncmFkZVN1YnRyZWUnLCAnb2JzZXJ2ZURvY3VtZW50JywKICAgICAgJ3VwZ3JhZGVEb2N1bWVudCddOwoKICAvLyBjYWNoZSBvcmlnaW5hbHMKICB2YXIgb3JpZ2luYWwgPSB7fTsKICBmbnMuZm9yRWFjaChmdW5jdGlvbihmbikgewogICAgb3JpZ2luYWxbZm5dID0gQ3VzdG9tRWxlbWVudHNbZm5dOwogIH0pOwoKICAvLyBvdmVycmlkZQogIGZucy5mb3JFYWNoKGZ1bmN0aW9uKGZuKSB7CiAgICBDdXN0b21FbGVtZW50c1tmbl0gPSBmdW5jdGlvbihpbk5vZGUpIHsKICAgICAgcmV0dXJuIG9yaWdpbmFsW2ZuXSh3cmFwKGluTm9kZSkpOwogICAgfTsKICB9KTsKCn0KCn0pKCk7CgooZnVuY3Rpb24gKCkgewoKLyoqKiBWYXJpYWJsZXMgKioqLwoKICB2YXIgd2luID0gd2luZG93LAogICAgZG9jID0gZG9jdW1lbnQsCiAgICBub29wID0gZnVuY3Rpb24oKXt9LAogICAgcmVnZXhQc2V1ZG9TcGxpdCA9IC8oXHcrKD86XChbXlwpXStcKSk/KS9nLAogICAgcmVnZXhQc2V1ZG9SZXBsYWNlID0gLyhcdyopKD86XCgoW15cKV0qKVwpKT8vLAogICAgcmVnZXhEaWdpdHMgPSAvKFxkKykvZywKICAgIGtleXBzZXVkbyA9IHsKICAgICAgYWN0aW9uOiBmdW5jdGlvbiAocHNldWRvLCBldmVudCkgewogICAgICAgIHJldHVybiBwc2V1ZG8udmFsdWUubWF0Y2gocmVnZXhEaWdpdHMpLmluZGV4T2YoU3RyaW5nKGV2ZW50LmtleUNvZGUpKSA+IC0xID09IChwc2V1ZG8ubmFtZSA9PSAna2V5cGFzcycpOwogICAgICB9CiAgICB9LAogICAgcHJlZml4ID0gKGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIHN0eWxlcyA9IHdpbi5nZXRDb21wdXRlZFN0eWxlKGRvYy5kb2N1bWVudEVsZW1lbnQsICcnKSwKICAgICAgICAgIHByZSA9IChBcnJheS5wcm90b3R5cGUuc2xpY2UKICAgICAgICAgICAgLmNhbGwoc3R5bGVzKQogICAgICAgICAgICAuam9pbignJykKICAgICAgICAgICAgLm1hdGNoKC8tKG1venx3ZWJraXR8bXMpLS8pIHx8IChzdHlsZXMuT0xpbmsgPT09ICcnICYmIFsnJywgJ28nXSkKICAgICAgICAgIClbMV07CiAgICAgIHJldHVybiB7CiAgICAgICAgZG9tOiBwcmUgPT0gJ21zJyA/IHByZS50b1VwcGVyQ2FzZSgpIDogcHJlLAogICAgICAgIGxvd2VyY2FzZTogcHJlLAogICAgICAgIGNzczogJy0nICsgcHJlICsgJy0nLAogICAgICAgIGpzOiBwcmVbMF0udG9VcHBlckNhc2UoKSArIHByZS5zdWJzdHIoMSkKICAgICAgfTsKCiAgICB9KSgpLAogICAgbWF0Y2hTZWxlY3RvciA9IEVsZW1lbnQucHJvdG90eXBlLm1hdGNoZXNTZWxlY3RvciB8fCBFbGVtZW50LnByb3RvdHlwZVtwcmVmaXgubG93ZXJjYXNlICsgJ01hdGNoZXNTZWxlY3RvciddOwoKLyoqKiBGdW5jdGlvbnMgKioqLwoKLy8gVXRpbGl0aWVzCgogIHZhciB0eXBlT2JqID0ge307CiAgZnVuY3Rpb24gdHlwZU9mKG9iaikgewogICAgcmV0dXJuIHR5cGVPYmoudG9TdHJpbmcuY2FsbChvYmopLm1hdGNoKC9ccyhbYS16QS1aXSspLylbMV0udG9Mb3dlckNhc2UoKTsKICB9CgogIGZ1bmN0aW9uIGNsb25lKGl0ZW0sIHR5cGUpewogICAgdmFyIGZuID0gY2xvbmVbdHlwZSB8fCB0eXBlT2YoaXRlbSldOwogICAgcmV0dXJuIGZuID8gZm4oaXRlbSkgOiBpdGVtOwogIH0KICAgIGNsb25lLm9iamVjdCA9IGZ1bmN0aW9uKHNyYyl7CiAgICAgIHZhciBvYmogPSB7fTsKICAgICAgZm9yICh2YXIga2V5IGluIHNyYykgb2JqW2tleV0gPSBjbG9uZShzcmNba2V5XSk7CiAgICAgIHJldHVybiBvYmo7CiAgICB9OwogICAgY2xvbmUuYXJyYXkgPSBmdW5jdGlvbihzcmMpewogICAgICB2YXIgaSA9IHNyYy5sZW5ndGgsIGFycmF5ID0gbmV3IEFycmF5KGkpOwogICAgICB3aGlsZSAoaS0tKSBhcnJheVtpXSA9IGNsb25lKHNyY1tpXSk7CiAgICAgIHJldHVybiBhcnJheTsKICAgIH07CgogIHZhciB1bnNsaWNlYWJsZSA9IFsnbnVtYmVyJywgJ2Jvb2xlYW4nLCAnc3RyaW5nJywgJ2Z1bmN0aW9uJ107CiAgZnVuY3Rpb24gdG9BcnJheShvYmopewogICAgcmV0dXJuIHVuc2xpY2VhYmxlLmluZGV4T2YodHlwZU9mKG9iaikpID09IC0xID8KICAgIEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKG9iaiwgMCkgOgogICAgW29ial07CiAgfQoKLy8gRE9NCiAgdmFyIHN0ciA9ICcnOwogIGZ1bmN0aW9uIHF1ZXJ5KGVsZW1lbnQsIHNlbGVjdG9yKXsKICAgIHJldHVybiAoc2VsZWN0b3IgfHwgc3RyKS5sZW5ndGggPyB0b0FycmF5KGVsZW1lbnQucXVlcnlTZWxlY3RvckFsbChzZWxlY3RvcikpIDogW107CiAgfQoKICBmdW5jdGlvbiBwYXJzZU11dGF0aW9ucyhlbGVtZW50LCBtdXRhdGlvbnMpIHsKICAgIHZhciBkaWZmID0geyBhZGRlZDogW10sIHJlbW92ZWQ6IFtdIH07CiAgICBtdXRhdGlvbnMuZm9yRWFjaChmdW5jdGlvbihyZWNvcmQpewogICAgICByZWNvcmQuX211dGF0aW9uID0gdHJ1ZTsKICAgICAgZm9yICh2YXIgeiBpbiBkaWZmKSB7CiAgICAgICAgdmFyIHR5cGUgPSBlbGVtZW50Ll9yZWNvcmRzWyh6ID09ICdhZGRlZCcpID8gJ2luc2VydGVkJyA6ICdyZW1vdmVkJ10sCiAgICAgICAgICBub2RlcyA9IHJlY29yZFt6ICsgJ05vZGVzJ10sIGxlbmd0aCA9IG5vZGVzLmxlbmd0aDsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbmd0aCAmJiBkaWZmW3pdLmluZGV4T2Yobm9kZXNbaV0pID09IC0xOyBpKyspewogICAgICAgICAgZGlmZlt6XS5wdXNoKG5vZGVzW2ldKTsKICAgICAgICAgIHR5cGUuZm9yRWFjaChmdW5jdGlvbihmbil7CiAgICAgICAgICAgIGZuKG5vZGVzW2ldLCByZWNvcmQpOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICB9CgovLyBNaXhpbnMKCiAgZnVuY3Rpb24gbWVyZ2VPbmUoc291cmNlLCBrZXksIGN1cnJlbnQpewogICAgdmFyIHR5cGUgPSB0eXBlT2YoY3VycmVudCk7CiAgICBpZiAodHlwZSA9PSAnb2JqZWN0JyAmJiB0eXBlT2Yoc291cmNlW2tleV0pID09ICdvYmplY3QnKSB4dGFnLm1lcmdlKHNvdXJjZVtrZXldLCBjdXJyZW50KTsKICAgIGVsc2Ugc291cmNlW2tleV0gPSBjbG9uZShjdXJyZW50LCB0eXBlKTsKICAgIHJldHVybiBzb3VyY2U7CiAgfQoKICBmdW5jdGlvbiBtZXJnZU1peGluKHR5cGUsIG1peGluLCBvcHRpb24pIHsKICAgIHZhciBvcmlnaW5hbCA9IHt9OwogICAgZm9yICh2YXIgbyBpbiBvcHRpb24pIG9yaWdpbmFsW28uc3BsaXQoJzonKVswXV0gPSB0cnVlOwogICAgZm9yICh2YXIgeCBpbiBtaXhpbikgaWYgKCFvcmlnaW5hbFt4LnNwbGl0KCc6JylbMF1dKSBvcHRpb25beF0gPSBtaXhpblt4XTsKICB9CgogIGZ1bmN0aW9uIGFwcGx5TWl4aW5zKHRhZykgewogICAgdGFnLm1peGlucy5mb3JFYWNoKGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgIHZhciBtaXhpbiA9IHh0YWcubWl4aW5zW25hbWVdOwogICAgICBmb3IgKHZhciB0eXBlIGluIG1peGluKSB7CiAgICAgICAgc3dpdGNoICh0eXBlKSB7CiAgICAgICAgICBjYXNlICdsaWZlY3ljbGUnOiBjYXNlICdtZXRob2RzJzoKICAgICAgICAgICAgbWVyZ2VNaXhpbih0eXBlLCBtaXhpblt0eXBlXSwgdGFnW3R5cGVdKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlICdhY2Nlc3NvcnMnOiBjYXNlICdwcm90b3R5cGUnOgogICAgICAgICAgICBmb3IgKHZhciB6IGluIG1peGluW3R5cGVdKSBtZXJnZU1peGluKHosIG1peGluW3R5cGVdLCB0YWcuYWNjZXNzb3JzKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlICdldmVudHMnOgogICAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuIHRhZzsKICB9CgovLyBFdmVudHMKCiAgZnVuY3Rpb24gdG91Y2hGaWx0ZXIoY3VzdG9tLCBldmVudCkgewogICAgaWYgKGN1c3RvbS5saXN0ZW5lci50b3VjaGVkKSByZXR1cm4gY3VzdG9tLmxpc3RlbmVyLnRvdWNoZWQgPSBmYWxzZTsKICAgIGVsc2UgewogICAgICBpZiAoZXZlbnQudHlwZS5tYXRjaCgndG91Y2gnKSkgY3VzdG9tLmxpc3RlbmVyLnRvdWNoZWQgPSB0cnVlOwogICAgfQogIH0KCiAgZnVuY3Rpb24gY3JlYXRlRmxvd0V2ZW50KHR5cGUpIHsKICAgIHZhciBmbG93ID0gdHlwZSA9PSAnb3Zlcic7CiAgICByZXR1cm4gewogICAgICBiYXNlOiAnT3ZlcmZsb3dFdmVudCcgaW4gd2luID8gJ292ZXJmbG93Y2hhbmdlZCcgOiB0eXBlICsgJ2Zsb3cnLAogICAgICBjb25kaXRpb246IGZ1bmN0aW9uIChjdXN0b20sIGV2ZW50KSB7CiAgICAgICAgZXZlbnQuZmxvdyA9IHR5cGU7CiAgICAgICAgcmV0dXJuIGV2ZW50LnR5cGUgPT0gKHR5cGUgKyAnZmxvdycpIHx8CiAgICAgICAgKChldmVudC5vcmllbnQgPT09IDAgJiYgZXZlbnQuaG9yaXpvbnRhbE92ZXJmbG93ID09IGZsb3cpIHx8CiAgICAgICAgKGV2ZW50Lm9yaWVudCA9PSAxICYmIGV2ZW50LnZlcnRpY2FsT3ZlcmZsb3cgPT0gZmxvdykgfHwKICAgICAgICAoZXZlbnQub3JpZW50ID09IDIgJiYgZXZlbnQuaG9yaXpvbnRhbE92ZXJmbG93ID09IGZsb3cgJiYgZXZlbnQudmVydGljYWxPdmVyZmxvdyA9PSBmbG93KSk7CiAgICAgIH0KICAgIH07CiAgfQoKLy8gQWNjZXNzb3JzCgogIGZ1bmN0aW9uIGdldEFyZ3MoYXR0ciwgdmFsdWUpewogICAgcmV0dXJuIHsKICAgICAgdmFsdWU6IGF0dHIuYm9vbGVhbiA/ICcnIDogdmFsdWUsCiAgICAgIG1ldGhvZDogYXR0ci5ib29sZWFuICYmICh2YWx1ZSA9PT0gZmFsc2UgfHwgdmFsdWUgPT09IG51bGwpID8gJ3JlbW92ZUF0dHJpYnV0ZScgOiAnc2V0QXR0cmlidXRlJwogICAgfTsKICB9CgogIGZ1bmN0aW9uIHNldEF0dHIoYXR0ciwgbmFtZSwgdmFsdWUpewogICAgdmFyIGFyZ3MgPSBnZXRBcmdzKGF0dHIsIHZhbHVlKTsKICAgIHRoaXNbYXJncy5tZXRob2RdKG5hbWUsIGFyZ3MudmFsdWUpOwogIH0KCiAgZnVuY3Rpb24gc3luY0F0dHIoYXR0ciwgbmFtZSwgdmFsdWUpewogICAgdmFyIGFyZ3MgPSBnZXRBcmdzKGF0dHIsIHZhbHVlKSwKICAgICAgICBub2RlcyA9IGF0dHIucHJvcGVydHkgPyBbdGhpcy54dGFnW2F0dHIucHJvcGVydHldXSA6IGF0dHIuc2VsZWN0b3IgPyB4dGFnLnF1ZXJ5KHRoaXMsIGF0dHIuc2VsZWN0b3IpIDogW10sCiAgICAgICAgaW5kZXggPSBub2Rlcy5sZW5ndGg7CiAgICB3aGlsZSAoaW5kZXgtLSkgbm9kZXNbaW5kZXhdW2FyZ3MubWV0aG9kXShuYW1lLCBhcmdzLnZhbHVlKTsKICB9CgogIGZ1bmN0aW9uIHdyYXBBdHRyKHRhZywgbWV0aG9kKXsKICAgIHZhciBvcmlnaW5hbCA9IHRhZy5wcm90b3R5cGVbbWV0aG9kXSB8fCBIVE1MRWxlbWVudC5wcm90b3R5cGVbbWV0aG9kXTsKICAgIHRhZy5wcm90b3R5cGVbbWV0aG9kXSA9IHsKICAgICAgd3JpdGFibGU6IHRydWUsCiAgICAgIGVudW1iZXJhYmxlOiB0cnVlLAogICAgICB2YWx1ZTogZnVuY3Rpb24gKG5hbWUsIHZhbHVlLCBza2lwKXsKICAgICAgICB2YXIgYXR0ciA9IHRhZy5hdHRyaWJ1dGVzW25hbWUudG9Mb3dlckNhc2UoKV07CiAgICAgICAgb3JpZ2luYWwuY2FsbCh0aGlzLCBuYW1lLCBhdHRyICYmIGF0dHIuYm9vbGVhbiA/ICcnIDogdmFsdWUpOwogICAgICAgIGlmIChhdHRyKSB7CiAgICAgICAgICBzeW5jQXR0ci5jYWxsKHRoaXMsIGF0dHIsIG5hbWUsIHZhbHVlKTsKICAgICAgICAgIGlmICghYXR0ci5za2lwICYmICF0aGlzLnh0YWcuX3NraXBBdHRyKSB7CiAgICAgICAgICAgIGF0dHIuc2V0dGVyLmNhbGwodGhpcywgYXR0ci5ib29sZWFuID8gbWV0aG9kID09ICdzZXRBdHRyaWJ1dGUnIDogdGhpcy5nZXRBdHRyaWJ1dGUobmFtZSkpOwogICAgICAgICAgfQogICAgICAgICAgZGVsZXRlIHRoaXMueHRhZy5fc2tpcEF0dHI7CiAgICAgICAgfQogICAgICB9CiAgICB9OwogIH0KCiAgZnVuY3Rpb24gYXR0YWNoUHJvcGVydGllcyh0YWcsIHByb3AsIHosIGFjY2Vzc29yLCBhdHRyLCBuYW1lKXsKICAgIHZhciBrZXkgPSB6LnNwbGl0KCc6JyksIHR5cGUgPSBrZXlbMF07CiAgICBpZiAodHlwZSA9PSAnZ2V0JykgewogICAgICBrZXlbMF0gPSBwcm9wOwogICAgICB0YWcucHJvdG90eXBlW3Byb3BdLmdldCA9IHh0YWcuYXBwbHlQc2V1ZG9zKGtleS5qb2luKCc6JyksIGFjY2Vzc29yW3pdLCB0YWcucHNldWRvcyk7CiAgICB9CiAgICBlbHNlIGlmICh0eXBlID09ICdzZXQnKSB7CiAgICAgIGtleVswXSA9IHByb3A7CiAgICAgIGlmIChhdHRyKSBhdHRyLnNldHRlciA9IGFjY2Vzc29yW3pdOwogICAgICB0YWcucHJvdG90eXBlW3Byb3BdLnNldCA9IHh0YWcuYXBwbHlQc2V1ZG9zKGtleS5qb2luKCc6JyksIGF0dHIgPyBmdW5jdGlvbih2YWx1ZSwgc2tpcCl7CiAgICAgICAgaWYgKCFza2lwICYmICFhdHRyLnNraXApIHsKICAgICAgICAgIHRoaXMueHRhZy5fc2tpcEF0dHIgPSB0cnVlOwogICAgICAgICAgc2V0QXR0ci5jYWxsKHRoaXMsIGF0dHIsIG5hbWUsIHZhbHVlKTsKICAgICAgICB9CiAgICAgICAgc3luY0F0dHIuY2FsbCh0aGlzLCBhdHRyLCBuYW1lLCB2YWx1ZSk7CiAgICAgICAgYWNjZXNzb3Jbel0uY2FsbCh0aGlzLCB2YWx1ZSk7CiAgICAgIH0gOiBhY2Nlc3Nvclt6XSwgdGFnLnBzZXVkb3MpOwogICAgfQogICAgZWxzZSB0YWcucHJvdG90eXBlW3Byb3BdW3pdID0gYWNjZXNzb3Jbel07CiAgfQoKICBmdW5jdGlvbiBwYXJzZUFjY2Vzc29yKHRhZywgcHJvcCl7CiAgICB0YWcucHJvdG90eXBlW3Byb3BdID0ge307CiAgICB2YXIgYWNjZXNzb3IgPSB0YWcuYWNjZXNzb3JzW3Byb3BdLAogICAgICAgIGF0dHIgPSBhY2Nlc3Nvci5hdHRyaWJ1dGUsCiAgICAgICAgbmFtZSA9IGF0dHIgJiYgYXR0ci5uYW1lID8gYXR0ci5uYW1lLnRvTG93ZXJDYXNlKCkgOiBwcm9wOwoKICAgIGlmIChhdHRyKSB0YWcuYXR0cmlidXRlc1tuYW1lXSA9IGF0dHI7CiAgICBmb3IgKHZhciB6IGluIGFjY2Vzc29yKSBhdHRhY2hQcm9wZXJ0aWVzKHRhZywgcHJvcCwgeiwgYWNjZXNzb3IsIGF0dHIsIG5hbWUpOwoKICAgIGlmIChhdHRyKSB7CiAgICAgIGlmICghdGFnLnByb3RvdHlwZVtwcm9wXS5nZXQpIHsKICAgICAgICB2YXIgbWV0aG9kID0gKGF0dHIuYm9vbGVhbiA/ICdoYXMnIDogJ2dldCcpICsgJ0F0dHJpYnV0ZSc7CiAgICAgICAgdGFnLnByb3RvdHlwZVtwcm9wXS5nZXQgPSBmdW5jdGlvbigpewogICAgICAgICAgcmV0dXJuIHRoaXNbbWV0aG9kXShuYW1lKTsKICAgICAgICB9OwogICAgICB9CiAgICAgIGlmICghdGFnLnByb3RvdHlwZVtwcm9wXS5zZXQpIHRhZy5wcm90b3R5cGVbcHJvcF0uc2V0ID0gZnVuY3Rpb24odmFsdWUpewogICAgICAgIHRoaXMueHRhZy5fc2tpcEF0dHIgPSB0cnVlOwogICAgICAgIHNldEF0dHIuY2FsbCh0aGlzLCBhdHRyLCBuYW1lLCB2YWx1ZSk7CiAgICAgIH07CiAgICB9CiAgfQoKLyoqKiBYLVRhZyBPYmplY3QgRGVmaW5pdGlvbiAqKiovCgogIHZhciB4dGFnID0gewogICAgdGFnczoge30sCiAgICBkZWZhdWx0T3B0aW9uczogewogICAgICBwc2V1ZG9zOiBbXSwKICAgICAgbWl4aW5zOiBbXSwKICAgICAgZXZlbnRzOiB7fSwKICAgICAgbWV0aG9kczoge30sCiAgICAgIGFjY2Vzc29yczoge30sCiAgICAgIGxpZmVjeWNsZToge30sCiAgICAgIGF0dHJpYnV0ZXM6IHt9LAogICAgICAncHJvdG90eXBlJzogewogICAgICAgIHh0YWc6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKXsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX194dGFnX18gPyB0aGlzLl9feHRhZ19fIDogKHRoaXMuX194dGFnX18gPSB7IGRhdGE6IHt9IH0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgIHJlZ2lzdGVyOiBmdW5jdGlvbiAobmFtZSwgb3B0aW9ucykgewogICAgICB2YXIgZWxlbWVudCwgX25hbWU7CiAgICAgIGlmICh0eXBlb2YgbmFtZSA9PSAnc3RyaW5nJykgewogICAgICAgIF9uYW1lID0gbmFtZS50b0xvd2VyQ2FzZSgpOwogICAgICB9IGVsc2UgaWYgKG5hbWUubm9kZU5hbWUgPT0gJ0VMRU1FTlQnKSB7CiAgICAgICAgZWxlbWVudCA9IG5hbWU7CiAgICAgICAgX25hbWUgPSBlbGVtZW50LmdldEF0dHJpYnV0ZSgnbmFtZScpLnRvTG93ZXJDYXNlKCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB2YXIgdGFnID0geHRhZy50YWdzW19uYW1lXSA9IGFwcGx5TWl4aW5zKHh0YWcubWVyZ2Uoe30sIHh0YWcuZGVmYXVsdE9wdGlvbnMsIG9wdGlvbnMpKTsKCiAgICAgIGZvciAodmFyIHogaW4gdGFnLmV2ZW50cykgdGFnLmV2ZW50c1t6XSA9IHh0YWcucGFyc2VFdmVudCh6LCB0YWcuZXZlbnRzW3pdKTsKICAgICAgZm9yICh6IGluIHRhZy5saWZlY3ljbGUpIHRhZy5saWZlY3ljbGVbei5zcGxpdCgnOicpWzBdXSA9IHh0YWcuYXBwbHlQc2V1ZG9zKHosIHRhZy5saWZlY3ljbGVbel0sIHRhZy5wc2V1ZG9zKTsKICAgICAgZm9yICh6IGluIHRhZy5tZXRob2RzKSB0YWcucHJvdG90eXBlW3ouc3BsaXQoJzonKVswXV0gPSB7IHZhbHVlOiB4dGFnLmFwcGx5UHNldWRvcyh6LCB0YWcubWV0aG9kc1t6XSwgdGFnLnBzZXVkb3MpLCBlbnVtZXJhYmxlOiB0cnVlIH07CiAgICAgIGZvciAoeiBpbiB0YWcuYWNjZXNzb3JzKSBwYXJzZUFjY2Vzc29yKHRhZywgeik7CgogICAgICB2YXIgcmVhZHkgPSB0YWcubGlmZWN5Y2xlLmNyZWF0ZWQgfHwgdGFnLmxpZmVjeWNsZS5yZWFkeTsKICAgICAgdGFnLnByb3RvdHlwZS5yZWFkeUNhbGxiYWNrID0gewogICAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgICAgdmFsdWU6IGZ1bmN0aW9uKCl7CiAgICAgICAgICB2YXIgZWxlbWVudCA9IHRoaXM7CiAgICAgICAgICB4dGFnLmFkZEV2ZW50cyh0aGlzLCB0YWcuZXZlbnRzKTsKICAgICAgICAgIHRhZy5taXhpbnMuZm9yRWFjaChmdW5jdGlvbihtaXhpbil7CiAgICAgICAgICAgIGlmICh4dGFnLm1peGluc1ttaXhpbl0uZXZlbnRzKSB4dGFnLmFkZEV2ZW50cyhlbGVtZW50LCB4dGFnLm1peGluc1ttaXhpbl0uZXZlbnRzKTsKICAgICAgICAgIH0pOwogICAgICAgICAgdmFyIG91dHB1dCA9IHJlYWR5ID8gcmVhZHkuYXBwbHkodGhpcywgdG9BcnJheShhcmd1bWVudHMpKSA6IG51bGw7CiAgICAgICAgICBmb3IgKHZhciBuYW1lIGluIHRhZy5hdHRyaWJ1dGVzKSB7CiAgICAgICAgICAgIHZhciBhdHRyID0gdGFnLmF0dHJpYnV0ZXNbbmFtZV0sCiAgICAgICAgICAgICAgICBoYXNBdHRyID0gdGhpcy5oYXNBdHRyaWJ1dGUobmFtZSksCiAgICAgICAgICAgICAgICB2YWx1ZSA9IGF0dHIuYm9vbGVhbiA/IGhhc0F0dHIgOiB0aGlzLmdldEF0dHJpYnV0ZShuYW1lKTsKICAgICAgICAgICAgaWYgKGF0dHIuYm9vbGVhbiB8fCBoYXNBdHRyKSB7CiAgICAgICAgICAgICAgc3luY0F0dHIuY2FsbCh0aGlzLCBhdHRyLCBuYW1lLCB2YWx1ZSk7CiAgICAgICAgICAgICAgaWYgKGF0dHIuc2V0dGVyKSBhdHRyLnNldHRlci5jYWxsKHRoaXMsIHZhbHVlLCB0cnVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdGFnLnBzZXVkb3MuZm9yRWFjaChmdW5jdGlvbihvYmopewogICAgICAgICAgICBvYmoub25BZGQuY2FsbChlbGVtZW50LCBvYmopOwogICAgICAgICAgfSk7CiAgICAgICAgICByZXR1cm4gb3V0cHV0OwogICAgICAgIH0KICAgICAgfTsKCiAgICAgIGlmICh0YWcubGlmZWN5Y2xlLmluc2VydGVkKSB0YWcucHJvdG90eXBlLmluc2VydGVkQ2FsbGJhY2sgPSB7IHZhbHVlOiB0YWcubGlmZWN5Y2xlLmluc2VydGVkLCBlbnVtZXJhYmxlOiB0cnVlIH07CiAgICAgIGlmICh0YWcubGlmZWN5Y2xlLnJlbW92ZWQpIHRhZy5wcm90b3R5cGUucmVtb3ZlZENhbGxiYWNrID0geyB2YWx1ZTogdGFnLmxpZmVjeWNsZS5yZW1vdmVkLCBlbnVtZXJhYmxlOiB0cnVlIH07CiAgICAgIGlmICh0YWcubGlmZWN5Y2xlLmF0dHJpYnV0ZUNoYW5nZWQpIHRhZy5wcm90b3R5cGUuYXR0cmlidXRlQ2hhbmdlZENhbGxiYWNrID0geyB2YWx1ZTogdGFnLmxpZmVjeWNsZS5hdHRyaWJ1dGVDaGFuZ2VkLCBlbnVtZXJhYmxlOiB0cnVlIH07CgogICAgICB3cmFwQXR0cih0YWcsICdzZXRBdHRyaWJ1dGUnKTsKICAgICAgd3JhcEF0dHIodGFnLCAncmVtb3ZlQXR0cmlidXRlJyk7CiAgICAgIAogICAgICBpZiAoZWxlbWVudCl7CiAgICAgICAgZWxlbWVudC5yZWdpc3Rlcih7CiAgICAgICAgICAncHJvdG90eXBlJzogT2JqZWN0LmNyZWF0ZShPYmplY3QucHJvdG90eXBlLCB0YWcucHJvdG90eXBlKQogICAgICAgIH0pOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBkb2MucmVnaXN0ZXIoX25hbWUsIHsKICAgICAgICAgICdleHRlbmRzJzogb3B0aW9uc1snZXh0ZW5kcyddLAogICAgICAgICAgJ3Byb3RvdHlwZSc6IE9iamVjdC5jcmVhdGUoT2JqZWN0LmNyZWF0ZSgob3B0aW9uc1snZXh0ZW5kcyddID8KICAgICAgICAgICAgZG9jdW1lbnQuY3JlYXRlRWxlbWVudChvcHRpb25zWydleHRlbmRzJ10pLmNvbnN0cnVjdG9yIDoKICAgICAgICAgICAgd2luLkhUTUxFbGVtZW50KS5wcm90b3R5cGUsIHRhZy5wcm90b3R5cGUpLCB0YWcucHJvdG90eXBlKQogICAgICAgIH0pOwogICAgICB9CiAgICB9LAoKICAgIC8qIEV4cG9zZWQgVmFyaWFibGVzICovCgogICAgbWl4aW5zOiB7fSwKICAgIHByZWZpeDogcHJlZml4LAogICAgY2FwdHVyZUV2ZW50czogWydmb2N1cycsICdibHVyJ10sCiAgICBjdXN0b21FdmVudHM6IHsKICAgICAgb3ZlcmZsb3c6IGNyZWF0ZUZsb3dFdmVudCgnb3ZlcicpLAogICAgICB1bmRlcmZsb3c6IGNyZWF0ZUZsb3dFdmVudCgndW5kZXInKSwKICAgICAgYW5pbWF0aW9uc3RhcnQ6IHsKICAgICAgICBiYXNlOiBbCiAgICAgICAgICAnYW5pbWF0aW9uc3RhcnQnLAogICAgICAgICAgJ29BbmltYXRpb25TdGFydCcsCiAgICAgICAgICAnTVNBbmltYXRpb25TdGFydCcsCiAgICAgICAgICAnd2Via2l0QW5pbWF0aW9uU3RhcnQnCiAgICAgICAgXQogICAgICB9LAogICAgICB0cmFuc2l0aW9uZW5kOiB7CiAgICAgICAgYmFzZTogWwogICAgICAgICAgJ3RyYW5zaXRpb25lbmQnLAogICAgICAgICAgJ29UcmFuc2l0aW9uRW5kJywKICAgICAgICAgICdNU1RyYW5zaXRpb25FbmQnLAogICAgICAgICAgJ3dlYmtpdFRyYW5zaXRpb25FbmQnCiAgICAgICAgXQogICAgICB9LAogICAgICB0YXA6IHsKICAgICAgICBiYXNlOiBbJ2NsaWNrJywgJ3RvdWNoZW5kJ10sCiAgICAgICAgY29uZGl0aW9uOiB0b3VjaEZpbHRlcgogICAgICB9LAogICAgICB0YXBzdGFydDogewogICAgICAgIGJhc2U6IFsnbW91c2Vkb3duJywgJ3RvdWNoc3RhcnQnXSwKICAgICAgICBjb25kaXRpb246IHRvdWNoRmlsdGVyCiAgICAgIH0sCiAgICAgIHRhcGVuZDogewogICAgICAgIGJhc2U6IFsnbW91c2V1cCcsICd0b3VjaGVuZCddLAogICAgICAgIGNvbmRpdGlvbjogdG91Y2hGaWx0ZXIKICAgICAgfSwKICAgICAgdGFwZW50ZXI6IHsKICAgICAgICBiYXNlOiBbJ21vdXNlb3ZlcicsICd0b3VjaGVudGVyJ10sCiAgICAgICAgY29uZGl0aW9uOiB0b3VjaEZpbHRlcgogICAgICB9LAogICAgICB0YXBsZWF2ZTogewogICAgICAgIGJhc2U6IFsnbW91c2VvdXQnLCAndG91Y2hsZWF2ZSddLAogICAgICAgIGNvbmRpdGlvbjogdG91Y2hGaWx0ZXIKICAgICAgfSwKICAgICAgdGFwbW92ZTogewogICAgICAgIGJhc2U6IFsnbW91c2Vtb3ZlJywgJ3RvdWNobW92ZSddLAogICAgICAgIGNvbmRpdGlvbjogdG91Y2hGaWx0ZXIKICAgICAgfQogICAgfSwKICAgIHBzZXVkb3M6IHsKICAgICAga2V5cGFzczoga2V5cHNldWRvLAogICAgICBrZXlmYWlsOiBrZXlwc2V1ZG8sCiAgICAgIGRlbGVnYXRlOiB7CiAgICAgICAgYWN0aW9uOiBmdW5jdGlvbiAocHNldWRvLCBldmVudCkgewogICAgICAgICAgdmFyIHRhcmdldCA9IHF1ZXJ5KHRoaXMsIHBzZXVkby52YWx1ZSkuZmlsdGVyKGZ1bmN0aW9uIChub2RlKSB7CiAgICAgICAgICAgIHJldHVybiBub2RlID09IGV2ZW50LnRhcmdldCB8fCBub2RlLmNvbnRhaW5zID8gbm9kZS5jb250YWlucyhldmVudC50YXJnZXQpIDogZmFsc2U7CiAgICAgICAgICB9KVswXTsKICAgICAgICAgIHJldHVybiB0YXJnZXQgPyBwc2V1ZG8ubGlzdGVuZXIgPSBwc2V1ZG8ubGlzdGVuZXIuYmluZCh0YXJnZXQpIDogZmFsc2U7CiAgICAgICAgfQogICAgICB9LAogICAgICBwcmV2ZW50YWJsZTogewogICAgICAgIGFjdGlvbjogZnVuY3Rpb24gKHBzZXVkbywgZXZlbnQpIHsKICAgICAgICAgIHJldHVybiAhZXZlbnQuZGVmYXVsdFByZXZlbnRlZDsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCgogICAgLyogVVRJTElUSUVTICovCgogICAgY2xvbmU6IGNsb25lLAogICAgdHlwZU9mOiB0eXBlT2YsCiAgICB0b0FycmF5OiB0b0FycmF5LAoKICAgIHdyYXA6IGZ1bmN0aW9uIChvcmlnaW5hbCwgZm4pIHsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKCl7CiAgICAgICAgdmFyIGFyZ3MgPSB0b0FycmF5KGFyZ3VtZW50cyksCiAgICAgICAgICByZXR1cm5lZCA9IG9yaWdpbmFsLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgICAgIHJldHVybiByZXR1cm5lZCA9PT0gZmFsc2UgPyBmYWxzZSA6IGZuLmFwcGx5KHRoaXMsIHR5cGVvZiByZXR1cm5lZCAhPSAndW5kZWZpbmVkJyA/IHRvQXJyYXkocmV0dXJuZWQpIDogYXJncyk7CiAgICAgIH07CiAgICB9LAoKICAgIG1lcmdlOiBmdW5jdGlvbihzb3VyY2UsIGssIHYpewogICAgICBpZiAodHlwZU9mKGspID09ICdzdHJpbmcnKSByZXR1cm4gbWVyZ2VPbmUoc291cmNlLCBrLCB2KTsKICAgICAgZm9yICh2YXIgaSA9IDEsIGwgPSBhcmd1bWVudHMubGVuZ3RoOyBpIDwgbDsgaSsrKXsKICAgICAgICB2YXIgb2JqZWN0ID0gYXJndW1lbnRzW2ldOwogICAgICAgIGZvciAodmFyIGtleSBpbiBvYmplY3QpIG1lcmdlT25lKHNvdXJjZSwga2V5LCBvYmplY3Rba2V5XSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHNvdXJjZTsKICAgIH0sCgogICAgLyogRE9NICovCgogICAgcXVlcnk6IHF1ZXJ5LAoKICAgIHNraXBUcmFuc2l0aW9uOiBmdW5jdGlvbihlbGVtZW50LCBmbiwgYmluZCl7CiAgICAgIHZhciBwcm9wID0gcHJlZml4LmpzICsgJ1RyYW5zaXRpb25Qcm9wZXJ0eSc7CiAgICAgIGVsZW1lbnQuc3R5bGVbcHJvcF0gPSBlbGVtZW50LnN0eWxlLnRyYW5zaXRpb25Qcm9wZXJ0eSA9ICdub25lJzsKICAgICAgeHRhZy5yZXF1ZXN0RnJhbWUoZnVuY3Rpb24oKXsKICAgICAgICB2YXIgY2FsbGJhY2s7CiAgICAgICAgaWYgKGZuKSBjYWxsYmFjayA9IGZuLmNhbGwoYmluZCk7CiAgICAgICAgeHRhZy5yZXF1ZXN0RnJhbWUoZnVuY3Rpb24oKXsKICAgICAgICAgIGVsZW1lbnQuc3R5bGVbcHJvcF0gPSBlbGVtZW50LnN0eWxlLnRyYW5zaXRpb25Qcm9wZXJ0eSA9ICcnOwogICAgICAgICAgaWYgKGNhbGxiYWNrKSB4dGFnLnJlcXVlc3RGcmFtZShjYWxsYmFjayk7CiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgfSwKCiAgICByZXF1ZXN0RnJhbWU6IChmdW5jdGlvbigpewogICAgICB2YXIgcmFmID0gd2luLnJlcXVlc3RBbmltYXRpb25GcmFtZSB8fAogICAgICAgIHdpbltwcmVmaXgubG93ZXJjYXNlICsgJ1JlcXVlc3RBbmltYXRpb25GcmFtZSddIHx8CiAgICAgICAgZnVuY3Rpb24oZm4peyByZXR1cm4gd2luLnNldFRpbWVvdXQoZm4sIDIwKTsgfTsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKGZuKXsKICAgICAgICByZXR1cm4gcmFmLmNhbGwod2luLCBmbik7CiAgICAgIH07CiAgICB9KSgpLAoKICAgIG1hdGNoU2VsZWN0b3I6IGZ1bmN0aW9uIChlbGVtZW50LCBzZWxlY3RvcikgewogICAgICByZXR1cm4gbWF0Y2hTZWxlY3Rvci5jYWxsKGVsZW1lbnQsIHNlbGVjdG9yKTsKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbiAoZWxlbWVudCwgbWV0aG9kLCB2YWx1ZSkgewogICAgICBlbGVtZW50W21ldGhvZF0gPSB2YWx1ZTsKICAgICAgaWYgKHdpbmRvdy5DdXN0b21FbGVtZW50cykgQ3VzdG9tRWxlbWVudHMudXBncmFkZUFsbChlbGVtZW50KTsKICAgIH0sCgogICAgaW5uZXJIVE1MOiBmdW5jdGlvbihlbCwgaHRtbCl7CiAgICAgIHh0YWcuc2V0KGVsLCAnaW5uZXJIVE1MJywgaHRtbCk7CiAgICB9LAoKICAgIGhhc0NsYXNzOiBmdW5jdGlvbiAoZWxlbWVudCwga2xhc3MpIHsKICAgICAgcmV0dXJuIGVsZW1lbnQuY2xhc3NOYW1lLnNwbGl0KCcgJykuaW5kZXhPZihrbGFzcy50cmltKCkpPi0xOwogICAgfSwKCiAgICBhZGRDbGFzczogZnVuY3Rpb24gKGVsZW1lbnQsIGtsYXNzKSB7CiAgICAgIHZhciBsaXN0ID0gZWxlbWVudC5jbGFzc05hbWUudHJpbSgpLnNwbGl0KCcgJyk7CiAgICAgIGtsYXNzLnRyaW0oKS5zcGxpdCgnICcpLmZvckVhY2goZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICBpZiAoIX5saXN0LmluZGV4T2YobmFtZSkpIGxpc3QucHVzaChuYW1lKTsKICAgICAgfSk7CiAgICAgIGVsZW1lbnQuY2xhc3NOYW1lID0gbGlzdC5qb2luKCcgJykudHJpbSgpOwogICAgICByZXR1cm4gZWxlbWVudDsKICAgIH0sCgogICAgcmVtb3ZlQ2xhc3M6IGZ1bmN0aW9uIChlbGVtZW50LCBrbGFzcykgewogICAgICB2YXIgY2xhc3NlcyA9IGtsYXNzLnRyaW0oKS5zcGxpdCgnICcpOwogICAgICBlbGVtZW50LmNsYXNzTmFtZSA9IGVsZW1lbnQuY2xhc3NOYW1lLnRyaW0oKS5zcGxpdCgnICcpLmZpbHRlcihmdW5jdGlvbiAobmFtZSkgewogICAgICAgIHJldHVybiBuYW1lICYmICF+Y2xhc3Nlcy5pbmRleE9mKG5hbWUpOwogICAgICB9KS5qb2luKCcgJyk7CiAgICAgIHJldHVybiBlbGVtZW50OwogICAgfSwKCiAgICB0b2dnbGVDbGFzczogZnVuY3Rpb24gKGVsZW1lbnQsIGtsYXNzKSB7CiAgICAgIHJldHVybiB4dGFnW3h0YWcuaGFzQ2xhc3MoZWxlbWVudCwga2xhc3MpID8gJ3JlbW92ZUNsYXNzJyA6ICdhZGRDbGFzcyddLmNhbGwobnVsbCwgZWxlbWVudCwga2xhc3MpOwoKICAgIH0sCgogICAgcXVlcnlDaGlsZHJlbjogZnVuY3Rpb24gKGVsZW1lbnQsIHNlbGVjdG9yKSB7CiAgICAgIHZhciBpZCA9IGVsZW1lbnQuaWQsCiAgICAgICAgZ3VpZCA9IGVsZW1lbnQuaWQgPSBpZCB8fCAneF8nICsgbmV3IERhdGUoKS5nZXRUaW1lKCksCiAgICAgICAgYXR0ciA9ICcjJyArIGd1aWQgKyAnID4gJzsKICAgICAgc2VsZWN0b3IgPSBhdHRyICsgKHNlbGVjdG9yICsgJycpLnJlcGxhY2UoJywnLCAnLCcgKyBhdHRyLCAnZycpOwogICAgICB2YXIgcmVzdWx0ID0gZWxlbWVudC5wYXJlbnROb2RlLnF1ZXJ5U2VsZWN0b3JBbGwoc2VsZWN0b3IpOwogICAgICBpZiAoIWlkKSBlbGVtZW50LnJlbW92ZUF0dHJpYnV0ZSgnaWQnKTsKICAgICAgcmV0dXJuIHRvQXJyYXkocmVzdWx0KTsKICAgIH0sCgogICAgY3JlYXRlRnJhZ21lbnQ6IGZ1bmN0aW9uKGNvbnRlbnQpIHsKICAgICAgdmFyIGZyYWcgPSBkb2MuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpOwogICAgICBpZiAoY29udGVudCkgewogICAgICAgIHZhciBkaXYgPSBmcmFnLmFwcGVuZENoaWxkKGRvYy5jcmVhdGVFbGVtZW50KCdkaXYnKSksCiAgICAgICAgICBub2RlcyA9IHRvQXJyYXkoY29udGVudC5ub2RlTmFtZSA/IGFyZ3VtZW50cyA6ICEoZGl2LmlubmVySFRNTCA9IGNvbnRlbnQpIHx8IGRpdi5jaGlsZHJlbiksCiAgICAgICAgICBsZW5ndGggPSBub2Rlcy5sZW5ndGgsCiAgICAgICAgICBpbmRleCA9IDA7CiAgICAgICAgd2hpbGUgKGluZGV4IDwgbGVuZ3RoKSBmcmFnLmluc2VydEJlZm9yZShub2Rlc1tpbmRleCsrXSwgZGl2KTsKICAgICAgICBmcmFnLnJlbW92ZUNoaWxkKGRpdik7CiAgICAgIH0KICAgICAgcmV0dXJuIGZyYWc7CiAgICB9LAoKICAgIG1hbmlwdWxhdGU6IGZ1bmN0aW9uKGVsZW1lbnQsIGZuKXsKICAgICAgdmFyIG5leHQgPSBlbGVtZW50Lm5leHRTaWJsaW5nLAogICAgICAgIHBhcmVudCA9IGVsZW1lbnQucGFyZW50Tm9kZSwKICAgICAgICBmcmFnID0gZG9jLmNyZWF0ZURvY3VtZW50RnJhZ21lbnQoKSwKICAgICAgICByZXR1cm5lZCA9IGZuLmNhbGwoZnJhZy5hcHBlbmRDaGlsZChlbGVtZW50KSwgZnJhZykgfHwgZWxlbWVudDsKICAgICAgaWYgKG5leHQpIHBhcmVudC5pbnNlcnRCZWZvcmUocmV0dXJuZWQsIG5leHQpOwogICAgICBlbHNlIHBhcmVudC5hcHBlbmRDaGlsZChyZXR1cm5lZCk7CiAgICB9LAoKICAgIC8qIFBTRVVET1MgKi8KCiAgICBhcHBseVBzZXVkb3M6IGZ1bmN0aW9uKGtleSwgZm4sIGVsZW1lbnQpIHsKICAgICAgdmFyIGxpc3RlbmVyID0gZm4sCiAgICAgICAgICBwc2V1ZG9zID0ge307CiAgICAgIGlmIChrZXkubWF0Y2goJzonKSkgewogICAgICAgIHZhciBzcGxpdCA9IGtleS5tYXRjaChyZWdleFBzZXVkb1NwbGl0KSwKICAgICAgICAgICAgaSA9IHNwbGl0Lmxlbmd0aDsKICAgICAgICB3aGlsZSAoLS1pKSB7CiAgICAgICAgICBzcGxpdFtpXS5yZXBsYWNlKHJlZ2V4UHNldWRvUmVwbGFjZSwgZnVuY3Rpb24gKG1hdGNoLCBuYW1lLCB2YWx1ZSkgewogICAgICAgICAgICB2YXIgcHNldWRvID0gcHNldWRvc1tpXSA9IE9iamVjdC5jcmVhdGUoeHRhZy5wc2V1ZG9zW25hbWVdKTsKICAgICAgICAgICAgICAgIHBzZXVkby5rZXkgPSBrZXk7CiAgICAgICAgICAgICAgICBwc2V1ZG8ubmFtZSA9IG5hbWU7CiAgICAgICAgICAgICAgICBwc2V1ZG8udmFsdWUgPSB2YWx1ZTsKICAgICAgICAgICAgaWYgKCFwc2V1ZG8pIHRocm93ICJwc2V1ZG8gbm90IGZvdW5kOiAiICsgbmFtZTsKICAgICAgICAgICAgdmFyIGxhc3QgPSBsaXN0ZW5lcjsKICAgICAgICAgICAgbGlzdGVuZXIgPSBmdW5jdGlvbigpewogICAgICAgICAgICAgIHZhciBhcmdzID0gdG9BcnJheShhcmd1bWVudHMpLAogICAgICAgICAgICAgICAgICBvYmogPSB7CiAgICAgICAgICAgICAgICAgICAga2V5OiBrZXksCiAgICAgICAgICAgICAgICAgICAgbmFtZTogbmFtZSwKICAgICAgICAgICAgICAgICAgICB2YWx1ZTogdmFsdWUsCiAgICAgICAgICAgICAgICAgICAgbGlzdGVuZXI6IGxhc3QKICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICBpZiAocHNldWRvLmFjdGlvbiAmJiBwc2V1ZG8uYWN0aW9uLmFwcGx5KHRoaXMsIFtvYmpdLmNvbmNhdChhcmdzKSkgPT09IGZhbHNlKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgcmV0dXJuIG9iai5saXN0ZW5lci5hcHBseSh0aGlzLCBhcmdzKTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgaWYgKGVsZW1lbnQgJiYgcHNldWRvLm9uQWRkKSB7CiAgICAgICAgICAgICAgaWYgKGVsZW1lbnQuZ2V0QXR0cmlidXRlKSB7CiAgICAgICAgICAgICAgICBwc2V1ZG8ub25BZGQuY2FsbChlbGVtZW50LCBwc2V1ZG8pOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBlbGVtZW50LnB1c2gocHNldWRvKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfQogICAgICBmb3IgKHZhciB6IGluIHBzZXVkb3MpIHsKICAgICAgICBpZiAocHNldWRvc1t6XS5vbkNvbXBpbGVkKSBsaXN0ZW5lciA9IHBzZXVkb3Nbel0ub25Db21waWxlZChsaXN0ZW5lciwgcHNldWRvc1t6XSk7CiAgICAgIH0KICAgICAgcmV0dXJuIGxpc3RlbmVyOwogICAgfSwKCiAgICByZW1vdmVQc2V1ZG9zOiBmdW5jdGlvbihlbGVtZW50LCBldmVudCl7CiAgICAgIGV2ZW50Ll9wc2V1ZG9zLmZvckVhY2goZnVuY3Rpb24ob2JqKXsKICAgICAgICBvYmoub25SZW1vdmUuY2FsbChlbGVtZW50LCBvYmopOwogICAgICB9KTsKICAgIH0sCgogIC8qKiogRXZlbnRzICoqKi8KCiAgICBwYXJzZUV2ZW50OiBmdW5jdGlvbih0eXBlLCBmbikgewogICAgICB2YXIgcHNldWRvcyA9IHR5cGUuc3BsaXQoJzonKSwKICAgICAgICBrZXkgPSBwc2V1ZG9zLnNoaWZ0KCksCiAgICAgICAgZXZlbnQgPSB4dGFnLm1lcmdlKHsKICAgICAgICAgIGJhc2U6IGtleSwKICAgICAgICAgIHBzZXVkb3M6ICcnLAogICAgICAgICAgX3BzZXVkb3M6IFtdLAogICAgICAgICAgb25BZGQ6IG5vb3AsCiAgICAgICAgICBvblJlbW92ZTogbm9vcCwKICAgICAgICAgIGNvbmRpdGlvbjogbm9vcAogICAgICAgIH0sIHh0YWcuY3VzdG9tRXZlbnRzW2tleV0gfHwge30pOwogICAgICBldmVudC50eXBlID0ga2V5ICsgKGV2ZW50LnBzZXVkb3MubGVuZ3RoID8gJzonICsgZXZlbnQucHNldWRvcyA6ICcnKSArIChwc2V1ZG9zLmxlbmd0aCA/ICc6JyArIHBzZXVkb3Muam9pbignOicpIDogJycpOwogICAgICBpZiAoZm4pIHsKICAgICAgICB2YXIgY2hhaW5lZCA9IHh0YWcuYXBwbHlQc2V1ZG9zKGV2ZW50LnR5cGUsIGZuLCBldmVudC5fcHNldWRvcyk7CiAgICAgICAgZXZlbnQubGlzdGVuZXIgPSBmdW5jdGlvbigpewogICAgICAgICAgdmFyIGFyZ3MgPSB0b0FycmF5KGFyZ3VtZW50cyk7CiAgICAgICAgICBpZiAoZXZlbnQuY29uZGl0aW9uLmFwcGx5KHRoaXMsIFtldmVudF0uY29uY2F0KGFyZ3MpKSA9PT0gZmFsc2UpIHJldHVybiBmYWxzZTsKICAgICAgICAgIHJldHVybiBjaGFpbmVkLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgICAgIH07CiAgICAgIH0KICAgICAgcmV0dXJuIGV2ZW50OwogICAgfSwKCiAgICBhZGRFdmVudDogZnVuY3Rpb24gKGVsZW1lbnQsIHR5cGUsIGZuKSB7CiAgICAgIHZhciBldmVudCA9ICh0eXBlb2YgZm4gPT0gJ2Z1bmN0aW9uJykgPyB4dGFnLnBhcnNlRXZlbnQodHlwZSwgZm4pIDogZm47CiAgICAgIGV2ZW50Lmxpc3RlbmVyLmV2ZW50ID0gZXZlbnQ7CiAgICAgIGV2ZW50Ll9wc2V1ZG9zLmZvckVhY2goZnVuY3Rpb24ob2JqKXsKICAgICAgICBvYmoub25BZGQuY2FsbChlbGVtZW50LCBvYmopOwogICAgICB9KTsKICAgICAgZXZlbnQub25BZGQuY2FsbChlbGVtZW50LCBldmVudCwgZXZlbnQubGlzdGVuZXIpOwogICAgICB0b0FycmF5KGV2ZW50LmJhc2UpLmZvckVhY2goZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIobmFtZSwgZXZlbnQubGlzdGVuZXIsIHh0YWcuY2FwdHVyZUV2ZW50cy5pbmRleE9mKG5hbWUpID4gLTEpOwogICAgICB9KTsKICAgICAgcmV0dXJuIGV2ZW50Lmxpc3RlbmVyOwogICAgfSwKCiAgICBhZGRFdmVudHM6IGZ1bmN0aW9uIChlbGVtZW50LCBldmVudHMpIHsKICAgICAgdmFyIGxpc3RlbmVycyA9IHt9OwogICAgICBmb3IgKHZhciB6IGluIGV2ZW50cykgewogICAgICAgIGxpc3RlbmVyc1t6XSA9IHh0YWcuYWRkRXZlbnQoZWxlbWVudCwgeiwgZXZlbnRzW3pdKTsKICAgICAgfQogICAgICByZXR1cm4gbGlzdGVuZXJzOwogICAgfSwKCiAgICByZW1vdmVFdmVudDogZnVuY3Rpb24gKGVsZW1lbnQsIHR5cGUsIGZuKSB7CiAgICAgIHZhciBldmVudCA9IGZuLmV2ZW50OwogICAgICBldmVudC5vblJlbW92ZS5jYWxsKGVsZW1lbnQsIGV2ZW50LCBmbik7CiAgICAgIHh0YWcucmVtb3ZlUHNldWRvcyhlbGVtZW50LCBldmVudCk7CiAgICAgIHRvQXJyYXkoZXZlbnQuYmFzZSkuZm9yRWFjaChmdW5jdGlvbiAobmFtZSkgewogICAgICAgIGVsZW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcihuYW1lLCBmbik7CiAgICAgIH0pOwogICAgfSwKCiAgICByZW1vdmVFdmVudHM6IGZ1bmN0aW9uKGVsZW1lbnQsIGxpc3RlbmVycyl7CiAgICAgIGZvciAodmFyIHogaW4gbGlzdGVuZXJzKSB4dGFnLnJlbW92ZUV2ZW50KGVsZW1lbnQsIHosIGxpc3RlbmVyc1t6XSk7CiAgICB9LAoKICAgIGZpcmVFdmVudDogZnVuY3Rpb24oZWxlbWVudCwgdHlwZSwgZGF0YSwgb3B0aW9ucyl7CiAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogICAgICB2YXIgZXZlbnQgPSBkb2MuY3JlYXRlRXZlbnQoJ0V2ZW50Jyk7CiAgICAgIGV2ZW50LmluaXRFdmVudCh0eXBlLCAnYnViYmxlcycgaW4gb3B0aW9ucyA/IG9wdGlvbnMuYnViYmxlcyA6IHRydWUsICdjYW5jZWxhYmxlJyBpbiBvcHRpb25zID8gb3B0aW9ucy5jYW5jZWxhYmxlIDogdHJ1ZSk7CiAgICAgIGZvciAodmFyIHogaW4gZGF0YSkgZXZlbnRbel0gPSBkYXRhW3pdOwogICAgICBlbGVtZW50LmRpc3BhdGNoRXZlbnQoZXZlbnQpOwogICAgfSwKCiAgICBhZGRPYnNlcnZlcjogZnVuY3Rpb24oZWxlbWVudCwgdHlwZSwgZm4pewogICAgICBpZiAoIWVsZW1lbnQuX3JlY29yZHMpIHsKICAgICAgICBlbGVtZW50Ll9yZWNvcmRzID0geyBpbnNlcnRlZDogW10sIHJlbW92ZWQ6IFtdIH07CiAgICAgICAgaWYgKG11dGF0aW9uKXsKICAgICAgICAgIGVsZW1lbnQuX29ic2VydmVyID0gbmV3IG11dGF0aW9uKGZ1bmN0aW9uKG11dGF0aW9ucykgewogICAgICAgICAgICBwYXJzZU11dGF0aW9ucyhlbGVtZW50LCBtdXRhdGlvbnMpOwogICAgICAgICAgfSk7CiAgICAgICAgICBlbGVtZW50Ll9vYnNlcnZlci5vYnNlcnZlKGVsZW1lbnQsIHsKICAgICAgICAgICAgc3VidHJlZTogdHJ1ZSwKICAgICAgICAgICAgY2hpbGRMaXN0OiB0cnVlLAogICAgICAgICAgICBhdHRyaWJ1dGVzOiAhdHJ1ZSwKICAgICAgICAgICAgY2hhcmFjdGVyRGF0YTogZmFsc2UKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBlbHNlIFsnSW5zZXJ0ZWQnLCAnUmVtb3ZlZCddLmZvckVhY2goZnVuY3Rpb24odHlwZSl7CiAgICAgICAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ0RPTU5vZGUnICsgdHlwZSwgZnVuY3Rpb24oZXZlbnQpewogICAgICAgICAgICBldmVudC5fbXV0YXRpb24gPSB0cnVlOwogICAgICAgICAgICBlbGVtZW50Ll9yZWNvcmRzW3R5cGUudG9Mb3dlckNhc2UoKV0uZm9yRWFjaChmdW5jdGlvbihmbil7CiAgICAgICAgICAgICAgZm4oZXZlbnQudGFyZ2V0LCBldmVudCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSwgZmFsc2UpOwogICAgICAgIH0pOwogICAgICB9CiAgICAgIGlmIChlbGVtZW50Ll9yZWNvcmRzW3R5cGVdLmluZGV4T2YoZm4pID09IC0xKSBlbGVtZW50Ll9yZWNvcmRzW3R5cGVdLnB1c2goZm4pOwogICAgfSwKCiAgICByZW1vdmVPYnNlcnZlcjogZnVuY3Rpb24oZWxlbWVudCwgdHlwZSwgZm4pewogICAgICB2YXIgb2JqID0gZWxlbWVudC5fcmVjb3JkczsKICAgICAgaWYgKG9iaiAmJiBmbil7CiAgICAgICAgb2JqW3R5cGVdLnNwbGljZShvYmpbdHlwZV0uaW5kZXhPZihmbiksIDEpOwogICAgICB9CiAgICAgIGVsc2V7CiAgICAgICAgb2JqW3R5cGVdID0gW107CiAgICAgIH0KICAgIH0KCiAgfTsKCiAgaWYgKHR5cGVvZiBkZWZpbmUgPT0gJ2Z1bmN0aW9uJyAmJiBkZWZpbmUuYW1kKSBkZWZpbmUoeHRhZyk7CiAgZWxzZSB3aW4ueHRhZyA9IHh0YWc7CgogIGRvYy5hZGRFdmVudExpc3RlbmVyKCdXZWJDb21wb25lbnRzUmVhZHknLCBmdW5jdGlvbigpewogICAgeHRhZy5maXJlRXZlbnQoZG9jLmJvZHksICdET01Db21wb25lbnRzTG9hZGVkJyk7CiAgfSk7Cgp9KSgpOw==",
                "body": "Ly8gV2UgZG9uJ3QgdXNlIHRoZSBwbGF0Zm9ybSBib290c3RyYXBwZXIsIHNvIGZha2UgdGhpcyBzdHVmZi4KCndpbmRvdy5QbGF0Zm9ybSA9IHt9Owp2YXIgbG9nRmxhZ3MgPSB7fTsKLyoKICogQ29weXJpZ2h0IDIwMTIgVGhlIFBvbHltZXIgQXV0aG9ycy4gQWxsIHJpZ2h0cyByZXNlcnZlZC4KICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJlbmVkIGJ5IGEgQlNELXN0eWxlCiAqIGxpY2Vuc2UgdGhhdCBjYW4gYmUgZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZS4KICovCgovLyBTaWRlVGFibGUgaXMgYSB3ZWFrIG1hcCB3aGVyZSBwb3NzaWJsZS4gSWYgV2Vha01hcCBpcyBub3QgYXZhaWxhYmxlIHRoZQovLyBhc3NvY2lhdGlvbiBpcyBzdG9yZWQgYXMgYW4gZXhwYW5kbyBwcm9wZXJ0eS4KdmFyIFNpZGVUYWJsZTsKLy8gVE9ETyhhcnYpOiBXZWFrTWFwIGRvZXMgbm90IGFsbG93IGZvciBOb2RlIGV0YyB0byBiZSBrZXlzIGluIEZpcmVmb3gKaWYgKHR5cGVvZiBXZWFrTWFwICE9PSAndW5kZWZpbmVkJyAmJiBuYXZpZ2F0b3IudXNlckFnZW50LmluZGV4T2YoJ0ZpcmVmb3gvJykgPCAwKSB7CiAgU2lkZVRhYmxlID0gV2Vha01hcDsKfSBlbHNlIHsKICAoZnVuY3Rpb24oKSB7CiAgICB2YXIgZGVmaW5lUHJvcGVydHkgPSBPYmplY3QuZGVmaW5lUHJvcGVydHk7CiAgICB2YXIgaGFzT3duUHJvcGVydHkgPSBPYmplY3QuaGFzT3duUHJvcGVydHk7CiAgICB2YXIgY291bnRlciA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpICUgMWU5OwoKICAgIFNpZGVUYWJsZSA9IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLm5hbWUgPSAnX19zdCcgKyAoTWF0aC5yYW5kb20oKSAqIDFlOSA+Pj4gMCkgKyAoY291bnRlcisrICsgJ19fJyk7CiAgICB9OwoKICAgIFNpZGVUYWJsZS5wcm90b3R5cGUgPSB7CiAgICAgIHNldDogZnVuY3Rpb24oa2V5LCB2YWx1ZSkgewogICAgICAgIGRlZmluZVByb3BlcnR5KGtleSwgdGhpcy5uYW1lLCB7dmFsdWU6IHZhbHVlLCB3cml0YWJsZTogdHJ1ZX0pOwogICAgICB9LAogICAgICBnZXQ6IGZ1bmN0aW9uKGtleSkgewogICAgICAgIHJldHVybiBoYXNPd25Qcm9wZXJ0eS5jYWxsKGtleSwgdGhpcy5uYW1lKSA/IGtleVt0aGlzLm5hbWVdIDogdW5kZWZpbmVkOwogICAgICB9LAogICAgICBkZWxldGU6IGZ1bmN0aW9uKGtleSkgewogICAgICAgIHRoaXMuc2V0KGtleSwgdW5kZWZpbmVkKTsKICAgICAgfQogICAgfQogIH0pKCk7Cn0KCi8qCiAqIENvcHlyaWdodCAyMDEzIFRoZSBQb2x5bWVyIEF1dGhvcnMuIEFsbCByaWdodHMgcmVzZXJ2ZWQuCiAqIFVzZSBvZiB0aGlzIHNvdXJjZSBjb2RlIGlzIGdvdmVybmVkIGJ5IGEgQlNELXN0eWxlCiAqIGxpY2Vuc2UgdGhhdCBjYW4gYmUgZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZS4KICovCihmdW5jdGlvbigpIHsKICAKICAvLyBwb29yIG1hbidzIGFkYXB0ZXIgZm9yIHRlbXBsYXRlLmNvbnRlbnQgb24gdmFyaW91cyBwbGF0Zm9ybSBzY2VuYXJpb3MKICB3aW5kb3cudGVtcGxhdGVDb250ZW50ID0gd2luZG93LnRlbXBsYXRlQ29udGVudCB8fCBmdW5jdGlvbihpblRlbXBsYXRlKSB7CiAgICByZXR1cm4gaW5UZW1wbGF0ZS5jb250ZW50OwogIH07CgogIC8vIHNvIHdlIGNhbiBjYWxsIHdyYXAvdW53cmFwIHdpdGhvdXQgdGVzdGluZyBmb3IgU2hhZG93RE9NUG9seWZpbGwKCiAgd2luZG93LndyYXAgPSB3aW5kb3cudW53cmFwID0gZnVuY3Rpb24obil7CiAgICByZXR1cm4gbjsKICB9CgogIHdpbmRvdy5jcmVhdGVTaGFkb3dSb290ID0gZnVuY3Rpb24oaW5FbGVtZW50KSB7CiAgICByZXR1cm4gaW5FbGVtZW50LndlYmtpdENyZWF0ZVNoYWRvd1Jvb3QoKTsKICB9OwoKICB3aW5kb3cudGVtcGxhdGVDb250ZW50ID0gZnVuY3Rpb24oaW5UZW1wbGF0ZSkgewogICAgLy8gaWYgTURWIGV4aXN0cywgaXQgbWF5IG5lZWQgdG8gYm9vc3RyYXAgdGhpcyB0ZW1wbGF0ZSB0byByZXZlYWwgY29udGVudAogICAgaWYgKHdpbmRvdy5IVE1MVGVtcGxhdGVFbGVtZW50ICYmIEhUTUxUZW1wbGF0ZUVsZW1lbnQuYm9vdHN0cmFwKSB7CiAgICAgIEhUTUxUZW1wbGF0ZUVsZW1lbnQuYm9vdHN0cmFwKGluVGVtcGxhdGUpOwogICAgfQogICAgLy8gZmFsbGJhY2sgd2hlbiB0aGVyZSBpcyBubyBTaGFkb3cgRE9NIHBvbHlmaWxsLCBubyBNRFYgcG9seWZpbGwsIGFuZCBubwogICAgLy8gbmF0aXZlIHRlbXBsYXRlIHN1cHBvcnQKICAgIGlmICghaW5UZW1wbGF0ZS5jb250ZW50ICYmICFpblRlbXBsYXRlLl9jb250ZW50KSB7CiAgICAgIHZhciBmcmFnID0gZG9jdW1lbnQuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpOwogICAgICB3aGlsZSAoaW5UZW1wbGF0ZS5maXJzdENoaWxkKSB7CiAgICAgICAgZnJhZy5hcHBlbmRDaGlsZChpblRlbXBsYXRlLmZpcnN0Q2hpbGQpOwogICAgICB9CiAgICAgIGluVGVtcGxhdGUuX2NvbnRlbnQgPSBmcmFnOwogICAgfQogICAgcmV0dXJuIGluVGVtcGxhdGUuY29udGVudCB8fCBpblRlbXBsYXRlLl9jb250ZW50OwogIH07Cgp9KSgpOwovKgogKiBDb3B5cmlnaHQgMjAxMyBUaGUgUG9seW1lciBBdXRob3JzLiBBbGwgcmlnaHRzIHJlc2VydmVkLgogKiBVc2Ugb2YgdGhpcyBzb3VyY2UgY29kZSBpcyBnb3Zlcm5lZCBieSBhIEJTRC1zdHlsZQogKiBsaWNlbnNlIHRoYXQgY2FuIGJlIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUuCiAqLwoKKGZ1bmN0aW9uKHNjb3BlKSB7CgovLyBPbGQgdmVyc2lvbnMgb2YgaU9TIGRvIG5vdCBoYXZlIGJpbmQuCgppZiAoIUZ1bmN0aW9uLnByb3RvdHlwZS5iaW5kKSB7CiAgRnVuY3Rpb24ucHJvdG90eXBlLmJpbmQgPSBmdW5jdGlvbihzY29wZSkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwogICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICB2YXIgYXJnczIgPSBhcmdzLnNsaWNlKCk7CiAgICAgIGFyZ3MyLnB1c2guYXBwbHkoYXJnczIsIGFyZ3VtZW50cyk7CiAgICAgIHJldHVybiBzZWxmLmFwcGx5KHNjb3BlLCBhcmdzMik7CiAgICB9OwogIH07Cn0KCi8vIG5hbWVzcGFjZSBhbiBpbXBvcnQgZnJvbSBDdXN0b21FbGVtZW50cwovLyBUT0RPKHNqbWlsZXMpOiBjbGVhbiB1cCB0aGlzIGdsb2JhbApzY29wZS5taXhpbiA9IHdpbmRvdy5taXhpbjsKCn0pKHdpbmRvdy5QbGF0Zm9ybSk7Ci8vIENvcHlyaWdodCAyMDExIEdvb2dsZSBJbmMuCi8vCi8vIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSAiTGljZW5zZSIpOwovLyB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuCi8vIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdAovLwovLyAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wCi8vCi8vIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmUKLy8gZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gIkFTIElTIiBCQVNJUywKLy8gV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuCi8vIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmQKLy8gbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuCgooZnVuY3Rpb24oc2NvcGUpIHsKCiAgJ3VzZSBzdHJpY3QnOwoKICAvLyBwb2x5ZmlsbCBET01Ub2tlbkxpc3QKICAvLyAqIGFkZC9yZW1vdmU6IGFsbG93IHRoZXNlIG1ldGhvZHMgdG8gdGFrZSBtdWx0aXBsZSBjbGFzc05hbWVzCiAgLy8gKiB0b2dnbGU6IGFkZCBhIDJuZCBhcmd1bWVudCB3aGljaCBmb3JjZXMgdGhlIGdpdmVuIHN0YXRlIHJhdGhlcgogIC8vICB0aGFuIHRvZ2dsaW5nLgoKICB2YXIgYWRkID0gRE9NVG9rZW5MaXN0LnByb3RvdHlwZS5hZGQ7CiAgdmFyIHJlbW92ZSA9IERPTVRva2VuTGlzdC5wcm90b3R5cGUucmVtb3ZlOwogIERPTVRva2VuTGlzdC5wcm90b3R5cGUuYWRkID0gZnVuY3Rpb24oKSB7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFyZ3VtZW50cy5sZW5ndGg7IGkrKykgewogICAgICBhZGQuY2FsbCh0aGlzLCBhcmd1bWVudHNbaV0pOwogICAgfQogIH07CiAgRE9NVG9rZW5MaXN0LnByb3RvdHlwZS5yZW1vdmUgPSBmdW5jdGlvbigpIHsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYXJndW1lbnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgIHJlbW92ZS5jYWxsKHRoaXMsIGFyZ3VtZW50c1tpXSk7CiAgICB9CiAgfTsKICBET01Ub2tlbkxpc3QucHJvdG90eXBlLnRvZ2dsZSA9IGZ1bmN0aW9uKG5hbWUsIGJvb2wpIHsKICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09IDEpIHsKICAgICAgYm9vbCA9ICF0aGlzLmNvbnRhaW5zKG5hbWUpOwogICAgfQogICAgYm9vbCA/IHRoaXMuYWRkKG5hbWUpIDogdGhpcy5yZW1vdmUobmFtZSk7CiAgfTsKICBET01Ub2tlbkxpc3QucHJvdG90eXBlLnN3aXRjaCA9IGZ1bmN0aW9uKG9sZE5hbWUsIG5ld05hbWUpIHsKICAgIG9sZE5hbWUgJiYgdGhpcy5yZW1vdmUob2xkTmFtZSk7CiAgICBuZXdOYW1lICYmIHRoaXMuYWRkKG5ld05hbWUpOwogIH07CiAgCiAgLy8gbWFrZSBmb3JFYWNoIHdvcmsgb24gTm9kZUxpc3QKCiAgTm9kZUxpc3QucHJvdG90eXBlLmZvckVhY2ggPSBmdW5jdGlvbihjYiwgY29udGV4dCkgewogICAgQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwodGhpcykuZm9yRWFjaChjYiwgY29udGV4dCk7CiAgfTsKCiAgSFRNTENvbGxlY3Rpb24ucHJvdG90eXBlLmZvckVhY2ggPSBmdW5jdGlvbihjYiwgY29udGV4dCkgewogICAgQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwodGhpcykuZm9yRWFjaChjYiwgY29udGV4dCk7CiAgfTsKCiAgLy8gcG9seWZpbGwgcGVyZm9ybWFuY2Uubm93CgogIGlmICghd2luZG93LnBlcmZvcm1hbmNlKSB7CiAgICB2YXIgc3RhcnQgPSBEYXRlLm5vdygpOwogICAgLy8gb25seSBhdCBtaWxsaXNlY29uZCBwcmVjaXNpb24KICAgIHdpbmRvdy5wZXJmb3JtYW5jZSA9IHtub3c6IGZ1bmN0aW9uKCl7IHJldHVybiBEYXRlLm5vdygpIC0gc3RhcnQgfX07CiAgfQoKICAvLyBwb2x5ZmlsbCBmb3IgcmVxdWVzdEFuaW1hdGlvbkZyYW1lCgogIGlmICghd2luZG93LnJlcXVlc3RBbmltYXRpb25GcmFtZSkgewogICAgd2luZG93LnJlcXVlc3RBbmltYXRpb25GcmFtZSA9IChmdW5jdGlvbigpIHsKICAgICAgdmFyIG5hdGl2ZVJhZiA9IHdpbmRvdy53ZWJraXRSZXF1ZXN0QW5pbWF0aW9uRnJhbWUgfHwKICAgICAgICB3aW5kb3cubW96UmVxdWVzdEFuaW1hdGlvbkZyYW1lOwoKICAgICAgcmV0dXJuIG5hdGl2ZVJhZiA/CiAgICAgICAgZnVuY3Rpb24oY2FsbGJhY2spIHsKICAgICAgICAgIHJldHVybiBuYXRpdmVSYWYoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGNhbGxiYWNrKHBlcmZvcm1hbmNlLm5vdygpKTsKICAgICAgICAgIH0pOwogICAgICAgIH0gOgogICAgICAgIGZ1bmN0aW9uKCBjYWxsYmFjayApewogICAgICAgICAgcmV0dXJuIHdpbmRvdy5zZXRUaW1lb3V0KGNhbGxiYWNrLCAxMDAwIC8gNjApOwogICAgICAgIH07CiAgICB9KSgpOwogIH0KCiAgaWYgKCF3aW5kb3cuY2FuY2VsQW5pbWF0aW9uRnJhbWUpIHsKICAgIHdpbmRvdy5jYW5jZWxBbmltYXRpb25GcmFtZSA9IChmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuICB3aW5kb3cud2Via2l0Q2FuY2VsQW5pbWF0aW9uRnJhbWUgfHwKICAgICAgICB3aW5kb3cubW96Q2FuY2VsQW5pbWF0aW9uRnJhbWUgfHwKICAgICAgICBmdW5jdGlvbihpZCkgewogICAgICAgICAgY2xlYXJUaW1lb3V0KGlkKTsKICAgICAgICB9OwogICAgfSkoKTsKICB9CgogIC8vIHV0aWxpdHkKCiAgZnVuY3Rpb24gY3JlYXRlRE9NKGluVGFnT3JOb2RlLCBpbkhUTUwsIGluQXR0cnMpIHsKICAgIHZhciBkb20gPSB0eXBlb2YgaW5UYWdPck5vZGUgPT0gJ3N0cmluZycgPyAKICAgICAgICBkb2N1bWVudC5jcmVhdGVFbGVtZW50KGluVGFnT3JOb2RlKSA6IGluVGFnT3JOb2RlLmNsb25lTm9kZSh0cnVlKTsKICAgIGRvbS5pbm5lckhUTUwgPSBpbkhUTUw7CiAgICBpZiAoaW5BdHRycykgewogICAgICBmb3IgKHZhciBuIGluIGluQXR0cnMpIHsKICAgICAgICBkb20uc2V0QXR0cmlidXRlKG4sIGluQXR0cnNbbl0pOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gZG9tOwogIH0KCiAgLy8gZXhwb3J0cwoKICBzY29wZS5jcmVhdGVET00gPSBjcmVhdGVET007Cgp9KSh3aW5kb3cuUGxhdGZvcm0pOwoKLyoKICogQ29weXJpZ2h0IDIwMTMgVGhlIFBvbHltZXIgQXV0aG9ycy4gQWxsIHJpZ2h0cyByZXNlcnZlZC4KICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYSBCU0Qtc3R5bGUKICogbGljZW5zZSB0aGF0IGNhbiBiZSBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlLgogKi8KCi8vIHBvb3IgbWFuJ3MgYWRhcHRlciBmb3IgdGVtcGxhdGUuY29udGVudCBvbiB2YXJpb3VzIHBsYXRmb3JtIHNjZW5hcmlvcwp3aW5kb3cudGVtcGxhdGVDb250ZW50ID0gd2luZG93LnRlbXBsYXRlQ29udGVudCB8fCBmdW5jdGlvbihpblRlbXBsYXRlKSB7CiAgcmV0dXJuIGluVGVtcGxhdGUuY29udGVudDsKfTsKLyoKICogQ29weXJpZ2h0IDIwMTMgVGhlIFBvbHltZXIgQXV0aG9ycy4gQWxsIHJpZ2h0cyByZXNlcnZlZC4KICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYSBCU0Qtc3R5bGUKICogbGljZW5zZSB0aGF0IGNhbiBiZSBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlLgogKi8KCihmdW5jdGlvbihzY29wZSkgewoKaWYgKCFzY29wZSkgewogIHNjb3BlID0gd2luZG93LkhUTUxJbXBvcnRzID0ge2ZsYWdzOnt9fTsKfQoKdmFyIElNUE9SVF9MSU5LX1RZUEUgPSAnaW1wb3J0JzsKCi8vIGhpZ2hsYW5kZXIgb2JqZWN0IHJlcHJlc2VudHMgYSBwcmltYXJ5IGRvY3VtZW50ICh0aGUgYXJndW1lbnQgdG8gJ3BhcnNlJykKLy8gYXQgdGhlIHJvb3Qgb2YgYSB0cmVlIG9mIGRvY3VtZW50cwoKdmFyIGltcG9ydGVyID0gewogIGRvY3VtZW50czoge30sCiAgY2FjaGU6IHt9LAogIHByZWxvYWRTZWxlY3RvcnM6IFsKICAgICdsaW5rW3JlbD0nICsgSU1QT1JUX0xJTktfVFlQRSArICddJywKICAgICdzY3JpcHRbc3JjXScsCiAgICAnbGlua1tyZWw9c3R5bGVzaGVldF0nCiAgXS5qb2luKCcsJyksCiAgbG9hZDogZnVuY3Rpb24oaW5Eb2N1bWVudCwgaW5OZXh0KSB7CiAgICAvLyBjb25zdHJ1Y3QgYSBsb2FkZXIgaW5zdGFuY2UKICAgIGxvYWRlciA9IG5ldyBMb2FkZXIoaW1wb3J0ZXIubG9hZGVkLCBpbk5leHQpOwogICAgLy8gYWxpYXMgdGhlIGxvYWRlciBjYWNoZSAoZm9yIGRlYnVnZ2luZykKICAgIGxvYWRlci5jYWNoZSA9IGltcG9ydGVyLmNhY2hlOwogICAgLy8gYWRkIG5vZGVzIGZyb20gZG9jdW1lbnQgaW50byBsb2FkZXIgcXVldWUKICAgIGltcG9ydGVyLnByZWxvYWQoaW5Eb2N1bWVudCk7CiAgfSwKICBwcmVsb2FkOiBmdW5jdGlvbihpbkRvY3VtZW50KSB7CiAgICAvLyBhbGwgcHJlbG9hZGFibGUgbm9kZXMgaW4gaW5Eb2N1bWVudAogICAgdmFyIG5vZGVzID0gaW5Eb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKGltcG9ydGVyLnByZWxvYWRTZWxlY3RvcnMpOwogICAgLy8gb25seSBsb2FkIGltcG9ydHMgZnJvbSB0aGUgbWFpbiBkb2N1bWVudAogICAgLy8gVE9ETyhzam1pbGVzKTogZG8gdGhpcyBieSBhbHRlcmluZyB0aGUgc2VsZWN0b3IgbGlzdCBpbnN0ZWFkCiAgICBpZiAoaW5Eb2N1bWVudCA9PT0gZG9jdW1lbnQpIHsKICAgICAgbm9kZXMgPSBBcnJheS5wcm90b3R5cGUuZmlsdGVyLmNhbGwobm9kZXMsIGZ1bmN0aW9uKG4pIHsKICAgICAgICByZXR1cm4gaXNEb2N1bWVudExpbmsobik7CiAgICAgIH0pOwogICAgfQogICAgLy8gYWRkIHRoZXNlIG5vZGVzIHRvIGxvYWRlcidzIHF1ZXVlCiAgICBsb2FkZXIuYWRkTm9kZXMobm9kZXMpOwogIH0sCiAgbG9hZGVkOiBmdW5jdGlvbihpblVybCwgaW5FbHQsIGluUmVzb3VyY2UpIHsKICAgIGlmIChpc0RvY3VtZW50TGluayhpbkVsdCkpIHsKICAgICAgdmFyIGRvY3VtZW50ID0gaW1wb3J0ZXIuZG9jdW1lbnRzW2luVXJsXTsKICAgICAgLy8gaWYgd2UndmUgbmV2ZXIgc2VlbiBhIGRvY3VtZW50IGF0IHRoaXMgdXJsCiAgICAgIGlmICghZG9jdW1lbnQpIHsKICAgICAgICAvLyBnZW5lcmF0ZSBhbiBIVE1MRG9jdW1lbnQgZnJvbSBkYXRhCiAgICAgICAgZG9jdW1lbnQgPSBtYWtlRG9jdW1lbnQoaW5SZXNvdXJjZSwgaW5VcmwpOwogICAgICAgIC8vIHJlc29sdmUgcmVzb3VyY2UgcGF0aHMgcmVsYXRpdmUgdG8gaG9zdCBkb2N1bWVudAogICAgICAgIHBhdGgucmVzb2x2ZVBhdGhzSW5IVE1MKGRvY3VtZW50KTsKICAgICAgICAvLyBjYWNoZSBkb2N1bWVudAogICAgICAgIGltcG9ydGVyLmRvY3VtZW50c1tpblVybF0gPSBkb2N1bWVudDsKICAgICAgICAvLyBhZGQgbm9kZXMgZnJvbSB0aGlzIGRvY3VtZW50IHRvIHRoZSBsb2FkZXIgcXVldWUKICAgICAgICBpbXBvcnRlci5wcmVsb2FkKGRvY3VtZW50KTsKICAgICAgfQogICAgICAvLyBzdG9yZSBkb2N1bWVudCByZXNvdXJjZQogICAgICBpbkVsdC5jb250ZW50ID0gaW5FbHQuX19yZXNvdXJjZSA9IGRvY3VtZW50OwogICAgfSBlbHNlIHsKICAgICAgaW5FbHQuX19yZXNvdXJjZSA9IGluUmVzb3VyY2U7CiAgICAgIC8vIHJlc29sdmUgc3R5bGVzaGVldCByZXNvdXJjZSBwYXRocyByZWxhdGl2ZSB0byBob3N0IGRvY3VtZW50CiAgICAgIGlmIChpc1N0eWxlc2hlZXRMaW5rKGluRWx0KSkgewogICAgICAgIHBhdGgucmVzb2x2ZVBhdGhzSW5TdHlsZXNoZWV0KGluRWx0KTsKICAgICAgfQogICAgfQogIH0KfTsKCmZ1bmN0aW9uIGlzRG9jdW1lbnRMaW5rKGluRWx0KSB7CiAgcmV0dXJuIGlzTGlua1JlbChpbkVsdCwgSU1QT1JUX0xJTktfVFlQRSk7Cn0KCmZ1bmN0aW9uIGlzU3R5bGVzaGVldExpbmsoaW5FbHQpIHsKICByZXR1cm4gaXNMaW5rUmVsKGluRWx0LCAnc3R5bGVzaGVldCcpOwp9CgpmdW5jdGlvbiBpc0xpbmtSZWwoaW5FbHQsIGluUmVsKSB7CiAgcmV0dXJuIChpbkVsdC5sb2NhbE5hbWUgPT09ICdsaW5rJyAmJiBpbkVsdC5nZXRBdHRyaWJ1dGUoJ3JlbCcpID09PSBpblJlbCk7Cn0KCmZ1bmN0aW9uIGluTWFpbkRvY3VtZW50KGluRWx0KSB7CiAgcmV0dXJuIGluRWx0Lm93bmVyRG9jdW1lbnQgPT09IGRvY3VtZW50IHx8CiAgICAvLyBUT0RPKHNqbWlsZXMpOiBTaGFkb3dET01Qb2x5ZmlsbCBpbnRydXNpb24KICAgIGluRWx0Lm93bmVyRG9jdW1lbnQuaW1wbCA9PT0gZG9jdW1lbnQ7Cn0KCmZ1bmN0aW9uIG1ha2VEb2N1bWVudChpbkhUTUwsIGluVXJsKSB7CiAgLy8gY3JlYXRlIGEgbmV3IEhUTUwgZG9jdW1lbnQKICB2YXIgZG9jID0gZG9jdW1lbnQuaW1wbGVtZW50YXRpb24uY3JlYXRlSFRNTERvY3VtZW50KElNUE9SVF9MSU5LX1RZUEUpOwogIC8vIGNhY2hlIHRoZSBuZXcgZG9jdW1lbnQncyBzb3VyY2UgdXJsCiAgZG9jLl9VUkwgPSBpblVybDsKICAvLyBlc3RhYmxpc2ggYSByZWxhdGl2ZSBwYXRoIHZpYSA8YmFzZT4KICB2YXIgYmFzZSA9IGRvYy5jcmVhdGVFbGVtZW50KCdiYXNlJyk7CiAgYmFzZS5zZXRBdHRyaWJ1dGUoJ2hyZWYnLCBkb2N1bWVudC5iYXNlVVJJKTsKICBkb2MuaGVhZC5hcHBlbmRDaGlsZChiYXNlKTsKICAvLyBpbnN0YWxsIGh0bWwKICBkb2MuYm9keS5pbm5lckhUTUwgPSBpbkhUTUw7CiAgcmV0dXJuIGRvYzsKfQoKdmFyIGxvYWRlcjsKCnZhciBMb2FkZXIgPSBmdW5jdGlvbihpbk9uTG9hZCwgaW5PbkNvbXBsZXRlKSB7CiAgdGhpcy5vbmxvYWQgPSBpbk9uTG9hZDsKICB0aGlzLm9uY29tcGxldGUgPSBpbk9uQ29tcGxldGU7CiAgdGhpcy5pbmZsaWdodCA9IDA7CiAgdGhpcy5wZW5kaW5nID0ge307CiAgdGhpcy5jYWNoZSA9IHt9Owp9OwoKTG9hZGVyLnByb3RvdHlwZSA9IHsKICBhZGROb2RlczogZnVuY3Rpb24oaW5Ob2RlcykgewogICAgLy8gbnVtYmVyIG9mIHRyYW5zYWN0aW9ucyB0byBjb21wbGV0ZQogICAgdGhpcy5pbmZsaWdodCArPSBpbk5vZGVzLmxlbmd0aDsKICAgIC8vIGNvbW1lbmNlIHRyYW5zYWN0aW9ucwogICAgZm9yRWFjaChpbk5vZGVzLCB0aGlzLnJlcXVpcmUsIHRoaXMpOwogICAgLy8gYW55dGhpbmcgdG8gZG8/CiAgICB0aGlzLmNoZWNrRG9uZSgpOwogIH0sCiAgcmVxdWlyZTogZnVuY3Rpb24oaW5FbHQpIHsKICAgIHZhciB1cmwgPSBwYXRoLm5vZGVVcmwoaW5FbHQpOwogICAgLy8gVE9ETyhzam1pbGVzKTogYWQtaG9jCiAgICBpbkVsdC5fX25vZGVVcmwgPSB1cmw7CiAgICAvLyBkZWR1cGxpY2F0aW9uCiAgICBpZiAoIXRoaXMuZGVkdXBlKHVybCwgaW5FbHQpKSB7CiAgICAgIC8vIGZldGNoIHRoaXMgcmVzb3VyY2UKICAgICAgdGhpcy5mZXRjaCh1cmwsIGluRWx0KTsKICAgIH0KICB9LAogIGRlZHVwZTogZnVuY3Rpb24oaW5VcmwsIGluRWx0KSB7CiAgICBpZiAodGhpcy5wZW5kaW5nW2luVXJsXSkgewogICAgICAvLyBhZGQgdG8gbGlzdCBvZiBub2RlcyB3YWl0aW5nIGZvciBpblVybAogICAgICB0aGlzLnBlbmRpbmdbaW5VcmxdLnB1c2goaW5FbHQpOwogICAgICAvLyBkb24ndCBuZWVkIGZldGNoCiAgICAgIHJldHVybiB0cnVlOwogICAgfQogICAgaWYgKHRoaXMuY2FjaGVbaW5VcmxdKSB7CiAgICAgIC8vIGNvbXBsZXRlIGxvYWQgdXNpbmcgY2FjaGUgZGF0YQogICAgICB0aGlzLm9ubG9hZChpblVybCwgaW5FbHQsIGxvYWRlci5jYWNoZVtpblVybF0pOwogICAgICAvLyBmaW5pc2hlZCB0aGlzIHRyYW5zYWN0aW9uCiAgICAgIHRoaXMudGFpbCgpOwogICAgICAvLyBkb24ndCBuZWVkIGZldGNoCiAgICAgIHJldHVybiB0cnVlOwogICAgfQogICAgLy8gZmlyc3Qgbm9kZSB3YWl0aW5nIGZvciBpblVybAogICAgdGhpcy5wZW5kaW5nW2luVXJsXSA9IFtpbkVsdF07CiAgICAvLyBuZWVkIGZldGNoIChub3QgYSBkdXBlKQogICAgcmV0dXJuIGZhbHNlOwogIH0sCiAgZmV0Y2g6IGZ1bmN0aW9uKGluVXJsLCBpbkVsdCkgewogICAgeGhyLmxvYWQoaW5VcmwsIGZ1bmN0aW9uKGVyciwgcmVzb3VyY2UpIHsKICAgICAgdGhpcy5yZWNlaXZlKGluVXJsLCBpbkVsdCwgZXJyLCByZXNvdXJjZSk7CiAgICB9LmJpbmQodGhpcykpOwogIH0sCiAgcmVjZWl2ZTogZnVuY3Rpb24oaW5VcmwsIGluRWx0LCBpbkVyciwgaW5SZXNvdXJjZSkgewogICAgaWYgKCFpbkVycikgewogICAgICBsb2FkZXIuY2FjaGVbaW5VcmxdID0gaW5SZXNvdXJjZTsKICAgIH0KICAgIGxvYWRlci5wZW5kaW5nW2luVXJsXS5mb3JFYWNoKGZ1bmN0aW9uKGUpIHsKICAgICAgaWYgKCFpbkVycikgewogICAgICAgIHRoaXMub25sb2FkKGluVXJsLCBlLCBpblJlc291cmNlKTsKICAgICAgfQogICAgICB0aGlzLnRhaWwoKTsKICAgIH0sIHRoaXMpOwogICAgbG9hZGVyLnBlbmRpbmdbaW5VcmxdID0gbnVsbDsKICB9LAogIHRhaWw6IGZ1bmN0aW9uKCkgewogICAgLS10aGlzLmluZmxpZ2h0OwogICAgdGhpcy5jaGVja0RvbmUoKTsKICB9LAogIGNoZWNrRG9uZTogZnVuY3Rpb24oKSB7CiAgICBpZiAoIXRoaXMuaW5mbGlnaHQpIHsKICAgICAgdGhpcy5vbmNvbXBsZXRlKCk7CiAgICB9CiAgfQp9OwoKdmFyIHBhdGggPSB7CiAgbm9kZVVybDogZnVuY3Rpb24oaW5Ob2RlKSB7CiAgICByZXR1cm4gcGF0aC5yZXNvbHZlVXJsKHBhdGguZ2V0RG9jdW1lbnRVcmwoZG9jdW1lbnQpLCBwYXRoLmhyZWZPclNyYyhpbk5vZGUpKTsKICB9LAogIGhyZWZPclNyYzogZnVuY3Rpb24oaW5Ob2RlKSB7CiAgICByZXR1cm4gaW5Ob2RlLmdldEF0dHJpYnV0ZSgiaHJlZiIpIHx8IGluTm9kZS5nZXRBdHRyaWJ1dGUoInNyYyIpOwogIH0sCiAgZG9jdW1lbnRVcmxGcm9tTm9kZTogZnVuY3Rpb24oaW5Ob2RlKSB7CiAgICByZXR1cm4gcGF0aC5nZXREb2N1bWVudFVybChpbk5vZGUub3duZXJEb2N1bWVudCk7CiAgfSwKICBnZXREb2N1bWVudFVybDogZnVuY3Rpb24oaW5Eb2N1bWVudCkgewogICAgdmFyIHVybCA9IGluRG9jdW1lbnQgJiYKICAgICAgICAvLyBUT0RPKHNqbWlsZXMpOiBTaGFkb3dET01Qb2x5ZmlsbCBpbnRydXNpb24KICAgICAgICAoaW5Eb2N1bWVudC5fVVJMIHx8IChpbkRvY3VtZW50LmltcGwgJiYgaW5Eb2N1bWVudC5pbXBsLl9VUkwpCiAgICAgICAgICAgIHx8IGluRG9jdW1lbnQuYmFzZVVSSSB8fCBpbkRvY3VtZW50LlVSTCkKICAgICAgICAgICAgICAgIHx8ICcnOwogICAgLy8gdGFrZSBvbmx5IHRoZSBsZWZ0IHNpZGUgaWYgdGhlcmUgaXMgYSAjCiAgICByZXR1cm4gdXJsLnNwbGl0KCcjJylbMF07CiAgfSwKICByZXNvbHZlVXJsOiBmdW5jdGlvbihpbkJhc2VVcmwsIGluVXJsLCBpblJlbGF0aXZlVG9Eb2N1bWVudCkgewogICAgaWYgKHRoaXMuaXNBYnNVcmwoaW5VcmwpKSB7CiAgICAgIHJldHVybiBpblVybDsKICAgIH0KICAgIHZhciB1cmwgPSB0aGlzLmNvbXByZXNzVXJsKHRoaXMudXJsVG9QYXRoKGluQmFzZVVybCkgKyBpblVybCk7CiAgICBpZiAoaW5SZWxhdGl2ZVRvRG9jdW1lbnQpIHsKICAgICAgdXJsID0gcGF0aC5tYWtlUmVsUGF0aChwYXRoLmdldERvY3VtZW50VXJsKGRvY3VtZW50KSwgdXJsKTsKICAgIH0KICAgIHJldHVybiB1cmw7CiAgfSwKICBpc0Fic1VybDogZnVuY3Rpb24oaW5VcmwpIHsKICAgIHJldHVybiAvKF5kYXRhOil8KF5odHRwW3NdPzopfCheXC8pLy50ZXN0KGluVXJsKTsKICB9LAogIHVybFRvUGF0aDogZnVuY3Rpb24oaW5CYXNlVXJsKSB7CiAgICB2YXIgcGFydHMgPSBpbkJhc2VVcmwuc3BsaXQoIi8iKTsKICAgIHBhcnRzLnBvcCgpOwogICAgcGFydHMucHVzaCgnJyk7CiAgICByZXR1cm4gcGFydHMuam9pbigiLyIpOwogIH0sCiAgY29tcHJlc3NVcmw6IGZ1bmN0aW9uKGluVXJsKSB7CiAgICB2YXIgcGFydHMgPSBpblVybC5zcGxpdCgiLyIpOwogICAgZm9yICh2YXIgaT0wLCBwOyBpPHBhcnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgIHAgPSBwYXJ0c1tpXTsKICAgICAgaWYgKHAgPT09ICIuLiIpIHsKICAgICAgICBwYXJ0cy5zcGxpY2UoaS0xLCAyKTsKICAgICAgICBpIC09IDI7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBwYXJ0cy5qb2luKCIvIik7CiAgfSwKICAvLyBtYWtlIGEgcmVsYXRpdmUgcGF0aCBmcm9tIHNvdXJjZSB0byB0YXJnZXQKICBtYWtlUmVsUGF0aDogZnVuY3Rpb24oaW5Tb3VyY2UsIGluVGFyZ2V0KSB7CiAgICB2YXIgcywgdDsKICAgIHMgPSB0aGlzLmNvbXByZXNzVXJsKGluU291cmNlKS5zcGxpdCgiLyIpOwogICAgdCA9IHRoaXMuY29tcHJlc3NVcmwoaW5UYXJnZXQpLnNwbGl0KCIvIik7CiAgICB3aGlsZSAocy5sZW5ndGggJiYgc1swXSA9PT0gdFswXSl7CiAgICAgIHMuc2hpZnQoKTsKICAgICAgdC5zaGlmdCgpOwogICAgfQogICAgZm9yKHZhciBpID0gMCwgbCA9IHMubGVuZ3RoLTE7IGkgPCBsOyBpKyspIHsKICAgICAgdC51bnNoaWZ0KCIuLiIpOwogICAgfQogICAgdmFyIHIgPSB0LmpvaW4oIi8iKTsKICAgIHJldHVybiByOwogIH0sCiAgcmVzb2x2ZVBhdGhzSW5IVE1MOiBmdW5jdGlvbihpblJvb3QpIHsKICAgIHZhciBkb2NVcmwgPSBwYXRoLmRvY3VtZW50VXJsRnJvbU5vZGUoaW5Sb290LmJvZHkpOwogICAgLy8gVE9ETyhzb3J2ZWxsKTogTURWIFBvbHlmaWxsIEludHJ1c2lvbgogICAgaWYgKHdpbmRvdy5IVE1MVGVtcGxhdGVFbGVtZW50ICYmIEhUTUxUZW1wbGF0ZUVsZW1lbnQuYm9vdHN0cmFwKSB7CiAgICAgIEhUTUxUZW1wbGF0ZUVsZW1lbnQuYm9vdHN0cmFwKGluUm9vdCk7CiAgICB9CiAgICB2YXIgbm9kZSA9IGluUm9vdC5ib2R5OwogICAgcGF0aC5fcmVzb2x2ZVBhdGhzSW5IVE1MKG5vZGUsIGRvY1VybCk7CiAgfSwKICBfcmVzb2x2ZVBhdGhzSW5IVE1MOiBmdW5jdGlvbihpblJvb3QsIGluVXJsKSB7CiAgICBwYXRoLnJlc29sdmVBdHRyaWJ1dGVzKGluUm9vdCwgaW5VcmwpOwogICAgcGF0aC5yZXNvbHZlU3R5bGVFbHRzKGluUm9vdCwgaW5VcmwpOwogICAgLy8gaGFuZGxlIHRlbXBsYXRlcywgaWYgc3VwcG9ydGVkCiAgICBpZiAod2luZG93LnRlbXBsYXRlQ29udGVudCkgewogICAgICB2YXIgdGVtcGxhdGVzID0gaW5Sb290LnF1ZXJ5U2VsZWN0b3JBbGwoJ3RlbXBsYXRlJyk7CiAgICAgIGlmICh0ZW1wbGF0ZXMpIHsKICAgICAgICBmb3JFYWNoKHRlbXBsYXRlcywgZnVuY3Rpb24odCkgewogICAgICAgICAgcGF0aC5fcmVzb2x2ZVBhdGhzSW5IVE1MKHRlbXBsYXRlQ29udGVudCh0KSwgaW5VcmwpOwogICAgICAgIH0pOwogICAgICB9CiAgICB9CiAgfSwKICByZXNvbHZlUGF0aHNJblN0eWxlc2hlZXQ6IGZ1bmN0aW9uKGluU2hlZXQpIHsKICAgIHZhciBkb2NVcmwgPSBwYXRoLm5vZGVVcmwoaW5TaGVldCk7CiAgICBpblNoZWV0Ll9fcmVzb3VyY2UgPSBwYXRoLnJlc29sdmVDc3NUZXh0KGluU2hlZXQuX19yZXNvdXJjZSwgZG9jVXJsKTsKICB9LAogIHJlc29sdmVTdHlsZUVsdHM6IGZ1bmN0aW9uKGluUm9vdCwgaW5VcmwpIHsKICAgIHZhciBzdHlsZXMgPSBpblJvb3QucXVlcnlTZWxlY3RvckFsbCgnc3R5bGUnKTsKICAgIGlmIChzdHlsZXMpIHsKICAgICAgZm9yRWFjaChzdHlsZXMsIGZ1bmN0aW9uKHN0eWxlKSB7CiAgICAgICAgc3R5bGUudGV4dENvbnRlbnQgPSBwYXRoLnJlc29sdmVDc3NUZXh0KHN0eWxlLnRleHRDb250ZW50LCBpblVybCk7CiAgICAgIH0pOwogICAgfQogIH0sCiAgcmVzb2x2ZUNzc1RleHQ6IGZ1bmN0aW9uKGluQ3NzVGV4dCwgaW5CYXNlVXJsKSB7CiAgICByZXR1cm4gaW5Dc3NUZXh0LnJlcGxhY2UoL3VybFwoW14pXSpcKS9nLCBmdW5jdGlvbihpbk1hdGNoKSB7CiAgICAgIC8vIGZpbmQgdGhlIHVybCBwYXRoLCBpZ25vcmUgcXVvdGVzIGluIHVybCBzdHJpbmcKICAgICAgdmFyIHVybFBhdGggPSBpbk1hdGNoLnJlcGxhY2UoL1siJ10vZywgIiIpLnNsaWNlKDQsIC0xKTsKICAgICAgdXJsUGF0aCA9IHBhdGgucmVzb2x2ZVVybChpbkJhc2VVcmwsIHVybFBhdGgsIHRydWUpOwogICAgICByZXR1cm4gInVybCgiICsgdXJsUGF0aCArICIpIjsKICAgIH0pOwogIH0sCiAgcmVzb2x2ZUF0dHJpYnV0ZXM6IGZ1bmN0aW9uKGluUm9vdCwgaW5VcmwpIHsKICAgIC8vIHNlYXJjaCBmb3IgYXR0cmlidXRlcyB0aGF0IGhvc3QgdXJscwogICAgdmFyIG5vZGVzID0gaW5Sb290ICYmIGluUm9vdC5xdWVyeVNlbGVjdG9yQWxsKFVSTF9BVFRSU19TRUxFQ1RPUik7CiAgICBpZiAobm9kZXMpIHsKICAgICAgZm9yRWFjaChub2RlcywgZnVuY3Rpb24obikgewogICAgICAgIHRoaXMucmVzb2x2ZU5vZGVBdHRyaWJ1dGVzKG4sIGluVXJsKTsKICAgICAgfSwgdGhpcyk7CiAgICB9CiAgfSwKICByZXNvbHZlTm9kZUF0dHJpYnV0ZXM6IGZ1bmN0aW9uKGluTm9kZSwgaW5VcmwpIHsKICAgIFVSTF9BVFRSUy5mb3JFYWNoKGZ1bmN0aW9uKHYpIHsKICAgICAgdmFyIGF0dHIgPSBpbk5vZGUuYXR0cmlidXRlc1t2XTsKICAgICAgaWYgKGF0dHIgJiYgYXR0ci52YWx1ZSAmJgogICAgICAgICAoYXR0ci52YWx1ZS5zZWFyY2goVVJMX1RFTVBMQVRFX1NFQVJDSCkgPCAwKSkgewogICAgICAgIHZhciB1cmxQYXRoID0gcGF0aC5yZXNvbHZlVXJsKGluVXJsLCBhdHRyLnZhbHVlLCB0cnVlKTsKICAgICAgICBhdHRyLnZhbHVlID0gdXJsUGF0aDsKICAgICAgfQogICAgfSk7CiAgfQp9OwoKdmFyIFVSTF9BVFRSUyA9IFsnaHJlZicsICdzcmMnLCAnYWN0aW9uJ107CnZhciBVUkxfQVRUUlNfU0VMRUNUT1IgPSAnWycgKyBVUkxfQVRUUlMuam9pbignXSxbJykgKyAnXSc7CnZhciBVUkxfVEVNUExBVEVfU0VBUkNIID0gJ3t7Lip9fSc7Cgp2YXIgeGhyID0gc2NvcGUueGhyIHx8IHsKICBhc3luYzogdHJ1ZSwKICBvazogZnVuY3Rpb24oaW5SZXF1ZXN0KSB7CiAgICByZXR1cm4gKGluUmVxdWVzdC5zdGF0dXMgPj0gMjAwICYmIGluUmVxdWVzdC5zdGF0dXMgPCAzMDApCiAgICAgICAgfHwgKGluUmVxdWVzdC5zdGF0dXMgPT09IDMwNCkKICAgICAgICB8fCAoaW5SZXF1ZXN0LnN0YXR1cyA9PT0gMCk7CiAgfSwKICBsb2FkOiBmdW5jdGlvbih1cmwsIG5leHQsIG5leHRDb250ZXh0KSB7CiAgICB2YXIgcmVxdWVzdCA9IG5ldyBYTUxIdHRwUmVxdWVzdCgpOwogICAgaWYgKHNjb3BlLmZsYWdzLmRlYnVnIHx8IHNjb3BlLmZsYWdzLmJ1c3QpIHsKICAgICAgdXJsICs9ICc/JyArIE1hdGgucmFuZG9tKCk7CiAgICB9CiAgICByZXF1ZXN0Lm9wZW4oJ0dFVCcsIHVybCwgeGhyLmFzeW5jKTsKICAgIHJlcXVlc3QuYWRkRXZlbnRMaXN0ZW5lcigncmVhZHlzdGF0ZWNoYW5nZScsIGZ1bmN0aW9uKGUpIHsKICAgICAgaWYgKHJlcXVlc3QucmVhZHlTdGF0ZSA9PT0gNCkgewogICAgICAgIG5leHQuY2FsbChuZXh0Q29udGV4dCwgIXhoci5vayhyZXF1ZXN0KSAmJiByZXF1ZXN0LAogICAgICAgICAgcmVxdWVzdC5yZXNwb25zZSwgdXJsKTsKICAgICAgfQogICAgfSk7CiAgICByZXF1ZXN0LnNlbmQoKTsKICB9Cn07Cgp2YXIgZm9yRWFjaCA9IEFycmF5LnByb3RvdHlwZS5mb3JFYWNoLmNhbGwuYmluZChBcnJheS5wcm90b3R5cGUuZm9yRWFjaCk7CgovLyBleHBvcnRzCgpzY29wZS54aHIgPSB4aHI7CnNjb3BlLmltcG9ydGVyID0gaW1wb3J0ZXI7CnNjb3BlLmdldERvY3VtZW50VXJsID0gcGF0aC5nZXREb2N1bWVudFVybDsKCi8vIGJvb3RzdHJhcAoKLy8gSUUgc2hpbSBmb3IgQ3VzdG9tRXZlbnQKaWYgKHR5cGVvZiB3aW5kb3cuQ3VzdG9tRXZlbnQgIT09ICdmdW5jdGlvbicpIHsKICB3aW5kb3cuQ3VzdG9tRXZlbnQgPSBmdW5jdGlvbihpblR5cGUpIHsKICAgICB2YXIgZSA9IGRvY3VtZW50LmNyZWF0ZUV2ZW50KCdIVE1MRXZlbnRzJyk7CiAgICAgZS5pbml0RXZlbnQoaW5UeXBlLCB0cnVlLCB0cnVlKTsKICAgICByZXR1cm4gZTsKICB9Owp9Cgpkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdET01Db250ZW50TG9hZGVkJywgZnVuY3Rpb24oKSB7CiAgLy8gcHJlbG9hZCBkb2N1bWVudCByZXNvdXJjZSB0cmVlcwogIGltcG9ydGVyLmxvYWQoZG9jdW1lbnQsIGZ1bmN0aW9uKCkgewogICAgLy8gVE9ETyhzam1pbGVzKTogU2hhZG93RE9NIHBvbHlmaWxsIHBvbGx1dGlvbgogICAgdmFyIGRvYyA9IHdpbmRvdy5TaGFkb3dET01Qb2x5ZmlsbCA/IFNoYWRvd0RPTVBvbHlmaWxsLndyYXAoZG9jdW1lbnQpCiAgICAgICAgOiBkb2N1bWVudDsKICAgIEhUTUxJbXBvcnRzLnJlYWR5VGltZSA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpOwogICAgLy8gc2VuZCBIVE1MSW1wb3J0c0xvYWRlZCB3aGVuIGZpbmlzaGVkCiAgICBkb2MuYm9keS5kaXNwYXRjaEV2ZW50KAogICAgICBuZXcgQ3VzdG9tRXZlbnQoJ0hUTUxJbXBvcnRzTG9hZGVkJywge2J1YmJsZXM6IHRydWV9KQogICAgKTsKICB9KTsKfSk7Cgp9KSh3aW5kb3cuSFRNTEltcG9ydHMpOwoKLyoKICogQ29weXJpZ2h0IDIwMTMgVGhlIFBvbHltZXIgQXV0aG9ycy4gQWxsIHJpZ2h0cyByZXNlcnZlZC4KICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYSBCU0Qtc3R5bGUKICogbGljZW5zZSB0aGF0IGNhbiBiZSBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlLgogKi8KCmlmICghd2luZG93Lk11dGF0aW9uT2JzZXJ2ZXIpIHsKICB3aW5kb3cuTXV0YXRpb25PYnNlcnZlciA9IAogICAgICB3aW5kb3cuV2ViS2l0TXV0YXRpb25PYnNlcnZlciB8fCAKICAgICAgd2luZG93LkpzTXV0YXRpb25PYnNlcnZlcjsKICBpZiAoIU11dGF0aW9uT2JzZXJ2ZXIpIHsKICAgIHRocm93IG5ldyBFcnJvcigibm8gbXV0YXRpb24gb2JzZXJ2ZXIgc3VwcG9ydCIpOwogIH0KfQoKLyoKICogQ29weXJpZ2h0IDIwMTMgVGhlIFBvbHltZXIgQXV0aG9ycy4gQWxsIHJpZ2h0cyByZXNlcnZlZC4KICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYSBCU0Qtc3R5bGUKICogbGljZW5zZSB0aGF0IGNhbiBiZSBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlLgogKi8KCi8qKgogKiBJbXBsZW1lbnRzIGBkb2N1bWVudC5yZWdpc3RlcmAKICogQG1vZHVsZSBDdXN0b21FbGVtZW50cwoqLwoKLyoqCiAqIFBvbHlmaWxsZWQgZXh0ZW5zaW9ucyB0byB0aGUgYGRvY3VtZW50YCBvYmplY3QuCiAqIEBjbGFzcyBEb2N1bWVudAoqLwoKKGZ1bmN0aW9uKHNjb3BlKSB7CgppZiAoIXNjb3BlKSB7CiAgc2NvcGUgPSB3aW5kb3cuQ3VzdG9tRWxlbWVudHMgPSB7ZmxhZ3M6e319Owp9CgovLyBuYXRpdmUgZG9jdW1lbnQucmVnaXN0ZXI/CgpzY29wZS5oYXNOYXRpdmUgPSAoZG9jdW1lbnQud2Via2l0UmVnaXN0ZXIgfHwgZG9jdW1lbnQucmVnaXN0ZXIpICYmIHNjb3BlLmZsYWdzLnJlZ2lzdGVyID09PSAnbmF0aXZlJzsKaWYgKHNjb3BlLmhhc05hdGl2ZSkgewoKICAvLyBub3JtYWxpemUKICBkb2N1bWVudC5yZWdpc3RlciA9IGRvY3VtZW50LnJlZ2lzdGVyIHx8IGRvY3VtZW50LndlYmtpdFJlZ2lzdGVyOwoKICB2YXIgbm9wID0gZnVuY3Rpb24oKSB7fTsKCiAgLy8gZXhwb3J0cwogIHNjb3BlLnJlZ2lzdHJ5ID0ge307CiAgc2NvcGUudXBncmFkZUVsZW1lbnQgPSBub3A7Cgp9IGVsc2UgewoKLyoqCiAqIFJlZ2lzdGVycyBhIGN1c3RvbSB0YWcgbmFtZSB3aXRoIHRoZSBkb2N1bWVudC4KICoKICogV2hlbiBhIHJlZ2lzdGVyZWQgZWxlbWVudCBpcyBjcmVhdGVkLCBhIGByZWFkeUNhbGxiYWNrYCBtZXRob2QgaXMgY2FsbGVkCiAqIGluIHRoZSBzY29wZSBvZiB0aGUgZWxlbWVudC4gVGhlIGByZWFkeUNhbGxiYWNrYCBtZXRob2QgY2FuIGJlIHNwZWNpZmllZCBvbgogKiBlaXRoZXIgYGluT3B0aW9ucy5wcm90b3R5cGVgIG9yIGBpbk9wdGlvbnMubGlmZWN5Y2xlYCB3aXRoIHRoZSBsYXR0ZXIgdGFraW5nCiAqIHByZWNlZGVuY2UuCiAqCiAqIEBtZXRob2QgcmVnaXN0ZXIKICogQHBhcmFtIHtTdHJpbmd9IGluTmFtZSBUaGUgdGFnIG5hbWUgdG8gcmVnaXN0ZXIuIE11c3QgaW5jbHVkZSBhIGRhc2ggKCctJyksCiAqICAgIGZvciBleGFtcGxlICd4LWNvbXBvbmVudCcuCiAqIEBwYXJhbSB7T2JqZWN0fSBpbk9wdGlvbnMKICogICAgQHBhcmFtIHtTdHJpbmd9IFtpbk9wdGlvbnMuZXh0ZW5kc10KICogICAgICAoX29mZiBzcGVjXykgVGFnIG5hbWUgb2YgYW4gZWxlbWVudCB0byBleHRlbmQgKG9yIGJsYW5rIGZvciBhIG5ldwogKiAgICAgIGVsZW1lbnQpLiBUaGlzIHBhcmFtZXRlciBpcyBub3QgcGFydCBvZiB0aGUgc3BlY2lmaWNhdGlvbiwgYnV0IGluc3RlYWQKICogICAgICBpcyBhIGhpbnQgZm9yIHRoZSBwb2x5ZmlsbCBiZWNhdXNlIHRoZSBleHRlbmRlZSBpcyBkaWZmaWN1bHQgdG8gaW5mZXIuCiAqICAgICAgUmVtZW1iZXIgdGhhdCB0aGUgaW5wdXQgcHJvdG90eXBlIG11c3QgY2hhaW4gdG8gdGhlIGV4dGVuZGVkIGVsZW1lbnQncwogKiAgICAgIHByb3RvdHlwZSAob3IgSFRNTEVsZW1lbnQucHJvdG90eXBlKSByZWdhcmRsZXNzIG9mIHRoZSB2YWx1ZSBvZgogKiAgICAgIGBleHRlbmRzYC4KICogICAgQHBhcmFtIHtPYmplY3R9IGluT3B0aW9ucy5wcm90b3R5cGUgVGhlIHByb3RvdHlwZSB0byB1c2UgZm9yIHRoZSBuZXcKICogICAgICBlbGVtZW50LiBUaGUgcHJvdG90eXBlIG11c3QgaW5oZXJpdCBmcm9tIEhUTUxFbGVtZW50LgogKiAgICBAcGFyYW0ge09iamVjdH0gW2luT3B0aW9ucy5saWZlY3ljbGVdCiAqICAgICAgQ2FsbGJhY2tzIHRoYXQgZmlyZSBhdCBpbXBvcnRhbnQgcGhhc2VzIGluIHRoZSBsaWZlIG9mIHRoZSBjdXN0b20KICogICAgICBlbGVtZW50LgogKgogKiBAZXhhbXBsZQogKiAgICAgIEZhbmN5QnV0dG9uID0gZG9jdW1lbnQucmVnaXN0ZXIoImZhbmN5LWJ1dHRvbiIsIHsKICogICAgICAgIGV4dGVuZHM6ICdidXR0b24nLAogKiAgICAgICAgcHJvdG90eXBlOiBPYmplY3QuY3JlYXRlKEhUTUxCdXR0b25FbGVtZW50LnByb3RvdHlwZSwgewogKiAgICAgICAgICByZWFkeUNhbGxiYWNrOiB7CiAqICAgICAgICAgICAgdmFsdWU6IGZ1bmN0aW9uKCkgewogKiAgICAgICAgICAgICAgY29uc29sZS5sb2coImEgZmFuY3ktYnV0dG9uIHdhcyBjcmVhdGVkIiwKICogICAgICAgICAgICB9CiAqICAgICAgICAgIH0KICogICAgICAgIH0pCiAqICAgICAgfSk7CiAqIEByZXR1cm4ge0Z1bmN0aW9ufSBDb25zdHJ1Y3RvciBmb3IgdGhlIG5ld2x5IHJlZ2lzdGVyZWQgdHlwZS4KICovCmZ1bmN0aW9uIHJlZ2lzdGVyKGluTmFtZSwgaW5PcHRpb25zKSB7CiAgLy9jb25zb2xlLndhcm4oJ2RvY3VtZW50LnJlZ2lzdGVyKCInICsgaW5OYW1lICsgJyIsICcsIGluT3B0aW9ucywgJyknKTsKICAvLyBjb25zdHJ1Y3QgYSBkZWZpbnRpb24gb3V0IG9mIG9wdGlvbnMKICAvLyBUT0RPKHNqbWlsZXMpOiBwcm9iYWJseSBzaG91bGQgY2xvbmUgaW5PcHRpb25zIGluc3RlYWQgb2YgbXV0YXRpbmcgaXQKICB2YXIgZGVmaW5pdGlvbiA9IGluT3B0aW9ucyB8fCB7fTsKICBpZiAoIWluTmFtZSkgewogICAgLy8gVE9ETyhzam1pbGVzKTogcmVwbGFjZSB3aXRoIG1vcmUgYXBwcm9wcmlhdGUgZXJyb3IgKEVyaWsgY2FuIHByb2JhYmx5CiAgICAvLyBvZmZlciBndWlkYW5jZSkKICAgIHRocm93IG5ldyBFcnJvcignTmFtZSBhcmd1bWVudCBtdXN0IG5vdCBiZSBlbXB0eScpOwogIH0KICAvLyByZWNvcmQgbmFtZQogIGRlZmluaXRpb24ubmFtZSA9IGluTmFtZTsKICAvLyBtdXN0IGhhdmUgYSBwcm90b3R5cGUsIGRlZmF1bHQgdG8gYW4gZXh0ZW5zaW9uIG9mIEhUTUxFbGVtZW50CiAgLy8gVE9ETyhzam1pbGVzKTogcHJvYmFibHkgc2hvdWxkIHRocm93IGlmIG5vIHByb3RvdHlwZSwgY2hlY2sgc3BlYwogIGlmICghZGVmaW5pdGlvbi5wcm90b3R5cGUpIHsKICAgIC8vIFRPRE8oc2ptaWxlcyk6IHJlcGxhY2Ugd2l0aCBtb3JlIGFwcHJvcHJpYXRlIGVycm9yIChFcmlrIGNhbiBwcm9iYWJseQogICAgLy8gb2ZmZXIgZ3VpZGFuY2UpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ09wdGlvbnMgbWlzc2luZyByZXF1aXJlZCBwcm90b3R5cGUgcHJvcGVydHknKTsKICB9CiAgLy8gZW5zdXJlIGEgbGlmZWN5Y2xlIG9iamVjdCBzbyB3ZSBkb24ndCBoYXZlIHRvIG51bGwgdGVzdCBpdAogIGRlZmluaXRpb24ubGlmZWN5Y2xlID0gZGVmaW5pdGlvbi5saWZlY3ljbGUgfHwge307CiAgLy8gYnVpbGQgYSBsaXN0IG9mIGFuY2VzdHJhbCBjdXN0b20gZWxlbWVudHMgKGZvciBuYXRpdmUgYmFzZSBkZXRlY3Rpb24pCiAgLy8gVE9ETyhzam1pbGVzKTogd2UgdXNlZCB0byBuZWVkIHRvIHN0b3JlIHRoaXMsIGJ1dCBjdXJyZW50IGNvZGUgb25seQogIC8vIHVzZXMgaXQgaW4gJ3Jlc29sdmVUYWdOYW1lJzogaXQgc2hvdWxkIHByb2JhYmx5IGJlIGlubGluZWQKICBkZWZpbml0aW9uLmFuY2VzdHJ5ID0gYW5jZXN0cnkoZGVmaW5pdGlvbi5leHRlbmRzKTsKICAvLyBleHRlbnNpb25zIG9mIG5hdGl2ZSBzcGVjaWFsaXphdGlvbnMgb2YgSFRNTEVsZW1lbnQgcmVxdWlyZSBsb2NhbE5hbWUKICAvLyB0byByZW1haW4gbmF0aXZlLCBhbmQgdXNlIHNlY29uZGFyeSAnaXMnIHNwZWNpZmllciBmb3IgZXh0ZW5zaW9uIHR5cGUKICByZXNvbHZlVGFnTmFtZShkZWZpbml0aW9uKTsKICAvLyBzb21lIHBsYXRmb3JtcyByZXF1aXJlIG1vZGlmaWNhdGlvbnMgdG8gdGhlIHVzZXItc3VwcGxpZWQgcHJvdG90eXBlCiAgLy8gY2hhaW4KICByZXNvbHZlUHJvdG90eXBlQ2hhaW4oZGVmaW5pdGlvbik7CiAgLy8gb3ZlcnJpZGVzIHRvIGltcGxlbWVudCBhdHRyaWJ1dGVDaGFuZ2VkIGNhbGxiYWNrCiAgb3ZlcnJpZGVBdHRyaWJ1dGVBcGkoZGVmaW5pdGlvbi5wcm90b3R5cGUpOwogIC8vIDcuMS41OiBSZWdpc3RlciB0aGUgREVGSU5JVElPTiB3aXRoIERPQ1VNRU5UCiAgcmVnaXN0ZXJEZWZpbml0aW9uKGluTmFtZSwgZGVmaW5pdGlvbik7CiAgLy8gNy4xLjcuIFJ1biBjdXN0b20gZWxlbWVudCBjb25zdHJ1Y3RvciBnZW5lcmF0aW9uIGFsZ29yaXRobSB3aXRoIFBST1RPVFlQRQogIC8vIDcuMS44LiBSZXR1cm4gdGhlIG91dHB1dCBvZiB0aGUgcHJldmlvdXMgc3RlcC4KICBkZWZpbml0aW9uLmN0b3IgPSBnZW5lcmF0ZUNvbnN0cnVjdG9yKGRlZmluaXRpb24pOwogIGRlZmluaXRpb24uY3Rvci5wcm90b3R5cGUgPSBkZWZpbml0aW9uLnByb3RvdHlwZTsKICAvLyBmb3JjZSBvdXIgLmNvbnN0cnVjdG9yIHRvIGJlIG91ciBhY3R1YWwgY29uc3RydWN0b3IKICBkZWZpbml0aW9uLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IGRlZmluaXRpb24uY3RvcjsKICAvLyBpZiBpbml0aWFsIHBhcnNpbmcgaXMgY29tcGxldGUKICBpZiAoc2NvcGUucmVhZHkpIHsKICAgIC8vIHVwZ3JhZGUgYW55IHByZS1leGlzdGluZyBub2RlcyBvZiB0aGlzIHR5cGUKICAgIHNjb3BlLnVwZ3JhZGVBbGwoZG9jdW1lbnQpOwogIH0KICByZXR1cm4gZGVmaW5pdGlvbi5jdG9yOwp9CgpmdW5jdGlvbiBhbmNlc3RyeShpbkV4dGVuZHMpIHsKICB2YXIgZXh0ZW5kZWUgPSByZWdpc3RyeVtpbkV4dGVuZHNdOwogIGlmIChleHRlbmRlZSkgewogICAgcmV0dXJuIGFuY2VzdHJ5KGV4dGVuZGVlLmV4dGVuZHMpLmNvbmNhdChbZXh0ZW5kZWVdKTsKICB9CiAgcmV0dXJuIFtdOwp9CgpmdW5jdGlvbiByZXNvbHZlVGFnTmFtZShpbkRlZmluaXRpb24pIHsKICAvLyBpZiB3ZSBhcmUgZXhwbGljaXRseSBleHRlbmRpbmcgc29tZXRoaW5nLCB0aGF0IHRoaW5nIGlzIG91cgogIC8vIGJhc2VUYWcsIHVubGVzcyBpdCByZXByZXNlbnRzIGEgY3VzdG9tIGNvbXBvbmVudAogIHZhciBiYXNlVGFnID0gaW5EZWZpbml0aW9uLmV4dGVuZHM7CiAgLy8gaWYgb3VyIGFuY2VzdHJ5IGluY2x1ZGVzIGN1c3RvbSBjb21wb25lbnRzLCB3ZSBvbmx5IGhhdmUgYQogIC8vIGJhc2VUYWcgaWYgb25lIG9mIHRoZW0gZG9lcwogIGZvciAodmFyIGk9MCwgYTsgKGE9aW5EZWZpbml0aW9uLmFuY2VzdHJ5W2ldKTsgaSsrKSB7CiAgICBiYXNlVGFnID0gYS5pcyAmJiBhLnRhZzsKICB9CiAgLy8gb3VyIHRhZyBpcyBvdXIgYmFzZVRhZywgaWYgaXQgZXhpc3RzLCBhbmQgb3RoZXJ3aXNlIGp1c3Qgb3VyIG5hbWUKICBpbkRlZmluaXRpb24udGFnID0gYmFzZVRhZyB8fCBpbkRlZmluaXRpb24ubmFtZTsKICBpZiAoYmFzZVRhZykgewogICAgLy8gaWYgdGhlcmUgaXMgYSBiYXNlIHRhZywgdXNlIHNlY29uZGFyeSAnaXMnIHNwZWNpZmllcgogICAgaW5EZWZpbml0aW9uLmlzID0gaW5EZWZpbml0aW9uLm5hbWU7CiAgfQp9CgpmdW5jdGlvbiByZXNvbHZlUHJvdG90eXBlQ2hhaW4oaW5EZWZpbml0aW9uKSB7CiAgLy8gaWYgd2UgZG9uJ3Qgc3VwcG9ydCBfX3Byb3RvX18gd2UgbmVlZCB0byBsb2NhdGUgdGhlIG5hdGl2ZSBsZXZlbAogIC8vIHByb3RvdHlwZSBmb3IgcHJlY2lzZSBtaXhpbmcgaW4KICBpZiAoIU9iamVjdC5fX3Byb3RvX18pIHsKICAgIC8vIGRlZmF1bHQgcHJvdG90eXBlCiAgICB2YXIgbmF0aXZlID0gSFRNTEVsZW1lbnQucHJvdG90eXBlOwogICAgLy8gd29yayBvdXQgcHJvdG90eXBlIHdoZW4gdXNpbmcgdHlwZS1leHRlbnNpb24KICAgIGlmIChpbkRlZmluaXRpb24uaXMpIHsKICAgICAgdmFyIGluc3QgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KGluRGVmaW5pdGlvbi50YWcpOwogICAgICBuYXRpdmUgPSBPYmplY3QuZ2V0UHJvdG90eXBlT2YoaW5zdCk7CiAgICB9CiAgfQogIC8vIGNhY2hlIHRoaXMgaW4gY2FzZSBvZiBtaXhpbgogIGluRGVmaW5pdGlvbi5uYXRpdmUgPSBuYXRpdmU7Cn0KCi8vIFNFQ1RJT04gNAoKZnVuY3Rpb24gaW5zdGFudGlhdGUoaW5EZWZpbml0aW9uKSB7CiAgLy8gNC5hLjEuIENyZWF0ZSBhIG5ldyBvYmplY3QgdGhhdCBpbXBsZW1lbnRzIFBST1RPVFlQRQogIC8vIDQuYS4yLiBMZXQgRUxFTUVOVCBieSB0aGlzIG5ldyBvYmplY3QKICAvLwogIC8vIHRoZSBjdXN0b20gZWxlbWVudCBpbnN0YW50aWF0aW9uIGFsZ29yaXRobSBtdXN0IGFsc28gZW5zdXJlIHRoYXQgdGhlCiAgLy8gb3V0cHV0IGlzIGEgdmFsaWQgRE9NIGVsZW1lbnQgd2l0aCB0aGUgcHJvcGVyIHdyYXBwZXIgaW4gcGxhY2UuCiAgLy8KICByZXR1cm4gdXBncmFkZShkb21DcmVhdGVFbGVtZW50KGluRGVmaW5pdGlvbi50YWcpLCBpbkRlZmluaXRpb24pOwp9CgpmdW5jdGlvbiB1cGdyYWRlKGluRWxlbWVudCwgaW5EZWZpbml0aW9uKSB7CiAgLy8gc29tZSBkZWZpbml0aW9ucyBzcGVjaWZ5IGFuICdpcycgYXR0cmlidXRlCiAgaWYgKGluRGVmaW5pdGlvbi5pcykgewogICAgaW5FbGVtZW50LnNldEF0dHJpYnV0ZSgnaXMnLCBpbkRlZmluaXRpb24uaXMpOwogIH0KICAvLyBtYWtlICdlbGVtZW50JyBpbXBsZW1lbnQgaW5EZWZpbml0aW9uLnByb3RvdHlwZQogIGltcGxlbWVudChpbkVsZW1lbnQsIGluRGVmaW5pdGlvbik7CiAgLy8gZmxhZyBhcyB1cGdyYWRlZAogIGluRWxlbWVudC5fX3VwZ3JhZGVkX18gPSB0cnVlOwogIC8vIHRoZXJlIHNob3VsZCBuZXZlciBiZSBhIHNoYWRvdyByb290IG9uIGluRWxlbWVudCBhdCB0aGlzIHBvaW50CiAgLy8gd2UgcmVxdWlyZSBjaGlsZCBub2RlcyBiZSB1cGdyYWRlZCBiZWZvcmUgcmVhZHkKICBzY29wZS51cGdyYWRlU3VidHJlZShpbkVsZW1lbnQpOwogIC8vIGxpZmVjeWNsZSBtYW5hZ2VtZW50CiAgcmVhZHkoaW5FbGVtZW50KTsKICAvLyBPVVRQVVQKICByZXR1cm4gaW5FbGVtZW50Owp9CgpmdW5jdGlvbiBpbXBsZW1lbnQoaW5FbGVtZW50LCBpbkRlZmluaXRpb24pIHsKICAvLyBwcm90b3R5cGUgc3dpenpsaW5nIGlzIGJlc3QKICBpZiAoT2JqZWN0Ll9fcHJvdG9fXykgewogICAgaW5FbGVtZW50Ll9fcHJvdG9fXyA9IGluRGVmaW5pdGlvbi5wcm90b3R5cGU7CiAgfSBlbHNlIHsKICAgIC8vIHdoZXJlIGFib3ZlIHdlIGNhbiByZS1hY3F1aXJlIGluUHJvdG90eXBlIHZpYQogICAgLy8gZ2V0UHJvdG90eXBlT2YoRWxlbWVudCksIHdlIGNhbm5vdCBkbyBzbyB3aGVuCiAgICAvLyB3ZSB1c2UgbWl4aW4sIHNvIHdlIGluc3RhbGwgYSBtYWdpYyByZWZlcmVuY2UKICAgIGN1c3RvbU1peGluKGluRWxlbWVudCwgaW5EZWZpbml0aW9uLnByb3RvdHlwZSwgaW5EZWZpbml0aW9uLm5hdGl2ZSk7CiAgICBpbkVsZW1lbnQuX19wcm90b19fID0gaW5EZWZpbml0aW9uLnByb3RvdHlwZTsKICB9Cn0KCmZ1bmN0aW9uIGN1c3RvbU1peGluKGluVGFyZ2V0LCBpblNyYywgaW5OYXRpdmUpIHsKICAvLyBUT0RPKHNqbWlsZXMpOiAndXNlZCcgYWxsb3dzIHVzIHRvIG9ubHkgY29weSB0aGUgJ3lvdW5nZXN0JyB2ZXJzaW9uIG9mCiAgLy8gYW55IHByb3BlcnR5LiBUaGlzIHNldCBzaG91bGQgYmUgcHJlY2FsY3VsYXRlZC4gV2UgYWxzbyBuZWVkIHRvCiAgLy8gY29uc2lkZXIgdGhpcyBmb3Igc3VwcG9ydGluZyAnc3VwZXInLgogIHZhciB1c2VkID0ge307CiAgLy8gc3RhcnQgd2l0aCBpblNyYwogIHZhciBwID0gaW5TcmM7CiAgLy8gc29tZXRpbWVzIHRoZSBkZWZhdWx0IGlzIEhUTUxVbmtub3duRWxlbWVudC5wcm90b3R5cGUgaW5zdGVhZCBvZgogIC8vIEhUTUxFbGVtZW50LnByb3RvdHlwZSwgc28gd2UgYWRkIGEgdGVzdAogIC8vIHRoZSBpZGVhIGlzIHRvIGF2b2lkIG1peGluZyBpbiBuYXRpdmUgcHJvdG90eXBlcywgc28gYWRkaW5nCiAgLy8gdGhlIHNlY29uZCB0ZXN0IGlzIFdMT0cKICB3aGlsZSAocCAhPT0gaW5OYXRpdmUgJiYgcCAhPT0gSFRNTFVua25vd25FbGVtZW50LnByb3RvdHlwZSkgewogICAgdmFyIGtleXMgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlOYW1lcyhwKTsKICAgIGZvciAodmFyIGk9MCwgazsgaz1rZXlzW2ldOyBpKyspIHsKICAgICAgaWYgKCF1c2VkW2tdKSB7CiAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGluVGFyZ2V0LCBrLAogICAgICAgICAgICBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHAsIGspKTsKICAgICAgICB1c2VkW2tdID0gMTsKICAgICAgfQogICAgfQogICAgcCA9IE9iamVjdC5nZXRQcm90b3R5cGVPZihwKTsKICB9Cn0KCmZ1bmN0aW9uIHJlYWR5KGluRWxlbWVudCkgewogIC8vIGludm9rZSByZWFkeUNhbGxiYWNrCiAgaWYgKGluRWxlbWVudC5yZWFkeUNhbGxiYWNrKSB7CiAgICBpbkVsZW1lbnQucmVhZHlDYWxsYmFjaygpOwogIH0KfQoKLy8gYXR0cmlidXRlIHdhdGNoaW5nCgpmdW5jdGlvbiBvdmVycmlkZUF0dHJpYnV0ZUFwaShwcm90b3R5cGUpIHsKICAvLyBvdmVycmlkZXMgdG8gaW1wbGVtZW50IGNhbGxiYWNrcwogIC8vIFRPRE8oc2ptaWxlcyk6IHNob3VsZCBzdXBwb3J0IGFjY2VzcyB2aWEgLmF0dHJpYnV0ZXMgTmFtZWROb2RlTWFwCiAgLy8gVE9ETyhzam1pbGVzKTogcHJlc2VydmVzIHVzZXIgZGVmaW5lZCBvdmVycmlkZXMsIGlmIGFueQogIHZhciBzZXRBdHRyaWJ1dGUgPSBwcm90b3R5cGUuc2V0QXR0cmlidXRlOwogIHByb3RvdHlwZS5zZXRBdHRyaWJ1dGUgPSBmdW5jdGlvbihuYW1lLCB2YWx1ZSkgewogICAgY2hhbmdlQXR0cmlidXRlLmNhbGwodGhpcywgbmFtZSwgdmFsdWUsIHNldEF0dHJpYnV0ZSk7CiAgfQogIHZhciByZW1vdmVBdHRyaWJ1dGUgPSBwcm90b3R5cGUucmVtb3ZlQXR0cmlidXRlOwogIHByb3RvdHlwZS5yZW1vdmVBdHRyaWJ1dGUgPSBmdW5jdGlvbihuYW1lLCB2YWx1ZSkgewogICAgY2hhbmdlQXR0cmlidXRlLmNhbGwodGhpcywgbmFtZSwgdmFsdWUsIHJlbW92ZUF0dHJpYnV0ZSk7CiAgfQp9CgpmdW5jdGlvbiBjaGFuZ2VBdHRyaWJ1dGUobmFtZSwgdmFsdWUsIG9wZXJhdGlvbikgewogIHZhciBvbGRWYWx1ZSA9IHRoaXMuZ2V0QXR0cmlidXRlKG5hbWUpOwogIG9wZXJhdGlvbi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIGlmICh0aGlzLmF0dHJpYnV0ZUNoYW5nZWRDYWxsYmFjayAKICAgICAgJiYgKHRoaXMuZ2V0QXR0cmlidXRlKG5hbWUpICE9PSBvbGRWYWx1ZSkpIHsKICAgIHRoaXMuYXR0cmlidXRlQ2hhbmdlZENhbGxiYWNrKG5hbWUsIG9sZFZhbHVlKTsKICB9Cn0KCi8vIGVsZW1lbnQgcmVnaXN0cnkgKG1hcHMgdGFnIG5hbWVzIHRvIGRlZmluaXRpb25zKQoKdmFyIHJlZ2lzdHJ5ID0ge307CgpmdW5jdGlvbiByZWdpc3RlckRlZmluaXRpb24oaW5OYW1lLCBpbkRlZmluaXRpb24pIHsKICByZWdpc3RyeVtpbk5hbWVdID0gaW5EZWZpbml0aW9uOwp9CgpmdW5jdGlvbiBnZW5lcmF0ZUNvbnN0cnVjdG9yKGluRGVmaW5pdGlvbikgewogIHJldHVybiBmdW5jdGlvbigpIHsKICAgIHJldHVybiBpbnN0YW50aWF0ZShpbkRlZmluaXRpb24pOwogIH07Cn0KCmZ1bmN0aW9uIGNyZWF0ZUVsZW1lbnQoaW5UYWcpIHsKICB2YXIgZGVmaW5pdGlvbiA9IHJlZ2lzdHJ5W2luVGFnXTsKICBpZiAoZGVmaW5pdGlvbikgewogICAgcmV0dXJuIG5ldyBkZWZpbml0aW9uLmN0b3IoKTsKICB9CiAgcmV0dXJuIGRvbUNyZWF0ZUVsZW1lbnQoaW5UYWcpOwp9CgpmdW5jdGlvbiB1cGdyYWRlRWxlbWVudChpbkVsZW1lbnQpIHsKICBpZiAoIWluRWxlbWVudC5fX3VwZ3JhZGVkX18gJiYgKGluRWxlbWVudC5ub2RlVHlwZSA9PT0gTm9kZS5FTEVNRU5UX05PREUpKSB7CiAgICB2YXIgdHlwZSA9IGluRWxlbWVudC5nZXRBdHRyaWJ1dGUoJ2lzJykgfHwgaW5FbGVtZW50LmxvY2FsTmFtZTsKICAgIHZhciBkZWZpbml0aW9uID0gcmVnaXN0cnlbdHlwZV07CiAgICByZXR1cm4gZGVmaW5pdGlvbiAmJiB1cGdyYWRlKGluRWxlbWVudCwgZGVmaW5pdGlvbik7CiAgfQp9CgpmdW5jdGlvbiBjbG9uZU5vZGUoZGVlcCkgewogIC8vIGNhbGwgb3JpZ2luYWwgY2xvbmUKICB2YXIgbiA9IGRvbUNsb25lTm9kZS5jYWxsKHRoaXMsIGRlZXApOwogIC8vIHVwZ3JhZGUgdGhlIGVsZW1lbnQgYW5kIHN1YnRyZWUKICBzY29wZS51cGdyYWRlQWxsKG4pOwogIHJldHVybiBuOwp9Ci8vIGNhcHR1cmUgbmF0aXZlIGNyZWF0ZUVsZW1lbnQgYmVmb3JlIHdlIG92ZXJyaWRlIGl0Cgp2YXIgZG9tQ3JlYXRlRWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQuYmluZChkb2N1bWVudCk7CgovLyBjYXB0dXJlIG5hdGl2ZSBjbG9uZU5vZGUgYmVmb3JlIHdlIG92ZXJyaWRlIGl0Cgp2YXIgZG9tQ2xvbmVOb2RlID0gTm9kZS5wcm90b3R5cGUuY2xvbmVOb2RlOwoKLy8gZXhwb3J0cwoKZG9jdW1lbnQucmVnaXN0ZXIgPSByZWdpc3RlcjsKZG9jdW1lbnQuY3JlYXRlRWxlbWVudCA9IGNyZWF0ZUVsZW1lbnQ7IC8vIG92ZXJyaWRlCk5vZGUucHJvdG90eXBlLmNsb25lTm9kZSA9IGNsb25lTm9kZTsgLy8gb3ZlcnJpZGUKCnNjb3BlLnJlZ2lzdHJ5ID0gcmVnaXN0cnk7CgovKioKICogVXBncmFkZSBhbiBlbGVtZW50IHRvIGEgY3VzdG9tIGVsZW1lbnQuIFVwZ3JhZGluZyBhbiBlbGVtZW50CiAqIGNhdXNlcyB0aGUgY3VzdG9tIHByb3RvdHlwZSB0byBiZSBhcHBsaWVkLCBhbiBgaXNgIGF0dHJpYnV0ZSAKICogdG8gYmUgYXR0YWNoZWQgKGFzIG5lZWRlZCksIGFuZCBpbnZvY2F0aW9uIG9mIHRoZSBgcmVhZHlDYWxsYmFja2AuCiAqIGB1cGdyYWRlYCBkb2VzIG5vdGhpbmcgaWYgdGhlIGVsZW1lbnQgaXMgYWxyZWFkeSB1cGdyYWRlZCwgb3IKICogaWYgaXQgbWF0Y2hlcyBubyByZWdpc3RlcmVkIGN1c3RvbSB0YWcgbmFtZS4KICoKICogQG1ldGhvZCB1Z3ByYWRlCiAqIEBwYXJhbSB7RWxlbWVudH0gaW5FbGVtZW50IFRoZSBlbGVtZW50IHRvIHVwZ3JhZGUuCiAqIEByZXR1cm4ge0VsZW1lbnR9IFRoZSB1cGdyYWRlZCBlbGVtZW50LgogKi8Kc2NvcGUudXBncmFkZSA9IHVwZ3JhZGVFbGVtZW50OwoKfQoKfSkod2luZG93LkN1c3RvbUVsZW1lbnRzKTsKCiAvKgpDb3B5cmlnaHQgMjAxMyBUaGUgUG9seW1lciBBdXRob3JzLiBBbGwgcmlnaHRzIHJlc2VydmVkLgpVc2Ugb2YgdGhpcyBzb3VyY2UgY29kZSBpcyBnb3Zlcm5lZCBieSBhIEJTRC1zdHlsZQpsaWNlbnNlIHRoYXQgY2FuIGJlIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUuCiovCgooZnVuY3Rpb24oc2NvcGUpewoKLyoKaWYgKEhUTUxFbGVtZW50LnByb3RvdHlwZS53ZWJraXRTaGFkb3dSb290KSB7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KEhUTUxFbGVtZW50LnByb3RvdHlwZSwgJ3NoYWRvd1Jvb3QnLCB7CiAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gdGhpcy53ZWJraXRTaGFkb3dSb290OwogICAgfQogIH07Cn0KKi8KCi8vIHdhbGsgdGhlIHN1YnRyZWUgcm9vdGVkIGF0IG5vZGUsIGFwcGx5aW5nICdmaW5kKGVsZW1lbnQsIGRhdGEpJyBmdW5jdGlvbiAKLy8gdG8gZWFjaCBlbGVtZW50Ci8vIGlmICdmaW5kJyByZXR1cm5zIHRydWUgZm9yICdlbGVtZW50JywgZG8gbm90IHNlYXJjaCBlbGVtZW50J3Mgc3VidHJlZSAgCmZ1bmN0aW9uIGZpbmRBbGwobm9kZSwgZmluZCwgZGF0YSkgewogIHZhciBlID0gbm9kZS5maXJzdEVsZW1lbnRDaGlsZDsKICBpZiAoIWUpIHsKICAgIGUgPSBub2RlLmZpcnN0Q2hpbGQ7CiAgICB3aGlsZSAoZSAmJiBlLm5vZGVUeXBlICE9PSBOb2RlLkVMRU1FTlRfTk9ERSkgewogICAgICBlID0gZS5uZXh0U2libGluZzsKICAgIH0KICB9CiAgd2hpbGUgKGUpIHsKICAgIGlmIChmaW5kKGUsIGRhdGEpICE9PSB0cnVlKSB7CiAgICAgIGZpbmRBbGwoZSwgZmluZCwgZGF0YSk7CiAgICB9CiAgICBlID0gZS5uZXh0RWxlbWVudFNpYmxpbmc7CiAgfQogIHJldHVybiBudWxsOwp9CgovLyB3YWxrIHRoZSBzdWJ0cmVlIHJvb3RlZCBhdCBub2RlLCBpbmNsdWRpbmcgZGVzY2VudCBpbnRvIHNoYWRvdy1yb290cywgCi8vIGFwcGx5aW5nICdjYicgdG8gZWFjaCBlbGVtZW50CmZ1bmN0aW9uIGZvclN1YnRyZWUobm9kZSwgY2IpIHsKICAvL2xvZ0ZsYWdzLmRvbSAmJiBub2RlLmNoaWxkTm9kZXMgJiYgbm9kZS5jaGlsZE5vZGVzLmxlbmd0aCAmJiBjb25zb2xlLmdyb3VwKCdzdWJUcmVlOiAnLCBub2RlKTsKICBmaW5kQWxsKG5vZGUsIGZ1bmN0aW9uKGUpIHsKICAgIGlmIChjYihlKSkgewogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIGlmIChlLndlYmtpdFNoYWRvd1Jvb3QpIHsKICAgICAgZm9yU3VidHJlZShlLndlYmtpdFNoYWRvd1Jvb3QsIGNiKTsKICAgIH0KICB9KTsKICBpZiAobm9kZS53ZWJraXRTaGFkb3dSb290KSB7CiAgICBmb3JTdWJ0cmVlKG5vZGUud2Via2l0U2hhZG93Um9vdCwgY2IpOwogIH0KICAvL2xvZ0ZsYWdzLmRvbSAmJiBub2RlLmNoaWxkTm9kZXMgJiYgbm9kZS5jaGlsZE5vZGVzLmxlbmd0aCAmJiBjb25zb2xlLmdyb3VwRW5kKCk7Cn0KCi8vIG1hbmFnZSBsaWZlY3ljbGUgb24gYWRkZWQgbm9kZQpmdW5jdGlvbiBhZGRlZChub2RlKSB7CiAgaWYgKHVwZ3JhZGUobm9kZSkpIHsKICAgIGluc2VydGVkTm9kZShub2RlKTsKICAgIHJldHVybiB0cnVlOyAKICB9CiAgaW5zZXJ0ZWQobm9kZSk7Cn0KCi8vIG1hbmFnZSBsaWZlY3ljbGUgb24gYWRkZWQgbm9kZSdzIHN1YnRyZWUgb25seQpmdW5jdGlvbiBhZGRlZFN1YnRyZWUobm9kZSkgewogIGZvclN1YnRyZWUobm9kZSwgZnVuY3Rpb24oZSkgewogICAgaWYgKGFkZGVkKGUpKSB7CiAgICAgIHJldHVybiB0cnVlOyAKICAgIH0KICB9KTsKfQoKLy8gbWFuYWdlIGxpZmVjeWNsZSBvbiBhZGRlZCBub2RlIGFuZCBpdCdzIHN1YnRyZWUKZnVuY3Rpb24gYWRkZWROb2RlKG5vZGUpIHsKICByZXR1cm4gYWRkZWQobm9kZSkgfHwgYWRkZWRTdWJ0cmVlKG5vZGUpOwp9CgovLyB1cGdyYWRlIGN1c3RvbSBlbGVtZW50cyBhdCBub2RlLCBpZiBhcHBsaWNhYmxlCmZ1bmN0aW9uIHVwZ3JhZGUobm9kZSkgewogIGlmICghbm9kZS5fX3VwZ3JhZGVkX18gJiYgbm9kZS5ub2RlVHlwZSA9PT0gTm9kZS5FTEVNRU5UX05PREUpIHsKICAgIHZhciB0eXBlID0gbm9kZS5nZXRBdHRyaWJ1dGUoJ2lzJykgfHwgbm9kZS5sb2NhbE5hbWU7CiAgICB2YXIgZGVmaW5pdGlvbiA9IHNjb3BlLnJlZ2lzdHJ5W3R5cGVdOwogICAgaWYgKGRlZmluaXRpb24pIHsKICAgICAgbG9nRmxhZ3MuZG9tICYmIGNvbnNvbGUuZ3JvdXAoJ3VwZ3JhZGU6Jywgbm9kZS5sb2NhbE5hbWUpOwogICAgICBzY29wZS51cGdyYWRlKG5vZGUpOwogICAgICBsb2dGbGFncy5kb20gJiYgY29uc29sZS5ncm91cEVuZCgpOwogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICB9Cn0KCmZ1bmN0aW9uIGluc2VydGVkTm9kZShub2RlKSB7CiAgaW5zZXJ0ZWQobm9kZSk7CiAgaWYgKGluRG9jdW1lbnQobm9kZSkpIHsKICAgIGZvclN1YnRyZWUobm9kZSwgZnVuY3Rpb24oZSkgewogICAgICBpbnNlcnRlZChlKTsKICAgIH0pOwogIH0KfQoKLy8gVE9ETyhzam1pbGVzKTogaWYgdGhlcmUgYXJlIGRlc2NlbnRzIGludG8gdHJlZXMgdGhhdCBjYW4gbmV2ZXIgaGF2ZSBpbkRvY3VtZW50KCopIHRydWUsIGZpeCB0aGlzCgpmdW5jdGlvbiBpbnNlcnRlZChlbGVtZW50KSB7CiAgLy8gVE9ETyhzam1pbGVzKTogaXQncyBwb3NzaWJsZSB3ZSB3ZXJlIGluc2VydGVkIGFuZCByZW1vdmVkIGluIHRoZSBzcGFjZQogIC8vIG9mIG9uZSBtaWNyb3Rhc2ssIGluIHdoaWNoIGNhc2Ugd2Ugd29uJ3QgYmUgJ2luRG9jdW1lbnQnIGhlcmUKICAvLyBCdXQgdGhlcmUgYXJlIG90aGVyIGNhc2VzIHdoZXJlIHdlIGFyZSB0ZXN0aW5nIGZvciBpbnNlcnRlZCB3aXRob3V0CiAgLy8gc3BlY2lmaWMga25vd2xlZGdlIG9mIG11dGF0aW9ucywgYW5kIG11c3QgdGVzdCAnaW5Eb2N1bWVudCcgdG8gZGV0ZXJtaW5lCiAgLy8gd2hldGhlciB0byBjYWxsIGluc2VydGVkCiAgLy8gSWYgd2UgY2FuIGZhY3RvciB0aGVzZSBjYXNlcyBpbnRvIHNlcGFyYXRlIGNvZGUgcGF0aHMgd2UgY2FuIGhhdmUKICAvLyBiZXR0ZXIgZGlhZ25vc3RpY3MuCiAgLy8gVE9ETyhzam1pbGVzKTogd2hlbiBsb2dnaW5nLCBkbyB3b3JrIG9uIGFsbCBjdXN0b20gZWxlbWVudHMgc28gd2UgY2FuCiAgLy8gdHJhY2sgYmVoYXZpb3IgZXZlbiB3aGVuIGNhbGxiYWNrcyBub3QgZGVmaW5lZAogIC8vY29uc29sZS5sb2coJ2luc2VydGVkOiAnLCBlbGVtZW50LmxvY2FsTmFtZSk7CiAgaWYgKGVsZW1lbnQuaW5zZXJ0ZWRDYWxsYmFjayB8fCAoZWxlbWVudC5fX3VwZ3JhZGVkX18gJiYgbG9nRmxhZ3MuZG9tKSkgewogICAgbG9nRmxhZ3MuZG9tICYmIGNvbnNvbGUuZ3JvdXAoJ2luc2VydGVkOicsIGVsZW1lbnQubG9jYWxOYW1lKTsKICAgIGlmIChpbkRvY3VtZW50KGVsZW1lbnQpKSB7CiAgICAgIGVsZW1lbnQuX19pbnNlcnRlZCA9IChlbGVtZW50Ll9faW5zZXJ0ZWQgfHwgMCkgKyAxOwogICAgICAvLyBpZiB3ZSBhcmUgaW4gYSAncmVtb3ZlZCcgc3RhdGUsIGJsdW50bHkgYWRqdXN0IHRvIGFuICdpbnNlcnRlZCcgc3RhdGUKICAgICAgaWYgKGVsZW1lbnQuX19pbnNlcnRlZCA8IDEpIHsKICAgICAgICBlbGVtZW50Ll9faW5zZXJ0ZWQgPSAxOwogICAgICB9CiAgICAgIC8vIGlmIHdlIGFyZSAnb3ZlciBpbnNlcnRlZCcsIHNxdWVsY2ggdGhlIGNhbGxiYWNrCiAgICAgIGlmIChlbGVtZW50Ll9faW5zZXJ0ZWQgPiAxKSB7CiAgICAgICAgbG9nRmxhZ3MuZG9tICYmIGNvbnNvbGUud2FybignaW5zZXJ0ZWQ6JywgZWxlbWVudC5sb2NhbE5hbWUsCiAgICAgICAgICAnaW5zZXJ0L3JlbW92ZSBjb3VudDonLCBlbGVtZW50Ll9faW5zZXJ0ZWQpCiAgICAgIH0gZWxzZSBpZiAoZWxlbWVudC5pbnNlcnRlZENhbGxiYWNrKSB7CiAgICAgICAgbG9nRmxhZ3MuZG9tICYmIGNvbnNvbGUubG9nKCdpbnNlcnRlZDonLCBlbGVtZW50LmxvY2FsTmFtZSk7CiAgICAgICAgZWxlbWVudC5pbnNlcnRlZENhbGxiYWNrKCk7CiAgICAgIH0KICAgIH0KICAgIGxvZ0ZsYWdzLmRvbSAmJiBjb25zb2xlLmdyb3VwRW5kKCk7CiAgfQp9CgpmdW5jdGlvbiByZW1vdmVkTm9kZShub2RlKSB7CiAgcmVtb3ZlZChub2RlKTsKICBmb3JTdWJ0cmVlKG5vZGUsIGZ1bmN0aW9uKGUpIHsKICAgIHJlbW92ZWQoZSk7CiAgfSk7Cn0KCmZ1bmN0aW9uIHJlbW92ZWQoZWxlbWVudCkgewogIC8vIFRPRE8oc2ptaWxlcyk6IHRlbXBvcmFyeTogZG8gd29yayBvbiBhbGwgY3VzdG9tIGVsZW1lbnRzIHNvIHdlIGNhbiB0cmFjawogIC8vIGJlaGF2aW9yIGV2ZW4gd2hlbiBjYWxsYmFja3Mgbm90IGRlZmluZWQKICBpZiAoZWxlbWVudC5yZW1vdmVkQ2FsbGJhY2sgfHwgKGVsZW1lbnQuX191cGdyYWRlZF9fICYmIGxvZ0ZsYWdzLmRvbSkpIHsKICAgIGxvZ0ZsYWdzLmRvbSAmJiBjb25zb2xlLmxvZygncmVtb3ZlZDonLCBlbGVtZW50LmxvY2FsTmFtZSk7CiAgICBpZiAoIWluRG9jdW1lbnQoZWxlbWVudCkpIHsKICAgICAgZWxlbWVudC5fX2luc2VydGVkID0gKGVsZW1lbnQuX19pbnNlcnRlZCB8fCAwKSAtIDE7CiAgICAgIC8vIGlmIHdlIGFyZSBpbiBhICdpbnNlcnRlZCcgc3RhdGUsIGJsdW50bHkgYWRqdXN0IHRvIGFuICdyZW1vdmVkJyBzdGF0ZQogICAgICBpZiAoZWxlbWVudC5fX2luc2VydGVkID4gMCkgewogICAgICAgIGVsZW1lbnQuX19pbnNlcnRlZCA9IDA7CiAgICAgIH0KICAgICAgLy8gaWYgd2UgYXJlICdvdmVyIHJlbW92ZWQnLCBzcXVlbGNoIHRoZSBjYWxsYmFjawogICAgICBpZiAoZWxlbWVudC5fX2luc2VydGVkIDwgMCkgewogICAgICAgIGxvZ0ZsYWdzLmRvbSAmJiBjb25zb2xlLndhcm4oJ3JlbW92ZWQ6JywgZWxlbWVudC5sb2NhbE5hbWUsCiAgICAgICAgICAgICdpbnNlcnQvcmVtb3ZlIGNvdW50OicsIGVsZW1lbnQuX19pbnNlcnRlZCkKICAgICAgfSBlbHNlIGlmIChlbGVtZW50LnJlbW92ZWRDYWxsYmFjaykgewogICAgICAgIGVsZW1lbnQucmVtb3ZlZENhbGxiYWNrKCk7CiAgICAgIH0KICAgIH0KICB9Cn0KCmZ1bmN0aW9uIGluRG9jdW1lbnQoZWxlbWVudCkgewogIHZhciBwID0gZWxlbWVudDsKICB3aGlsZSAocCkgewogICAgaWYgKHAgPT0gZWxlbWVudC5vd25lckRvY3VtZW50KSB7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQogICAgcCA9IHAucGFyZW50Tm9kZSB8fCBwLmhvc3Q7CiAgfQp9CgpmdW5jdGlvbiB3YXRjaFNoYWRvdyhub2RlKSB7CiAgaWYgKG5vZGUud2Via2l0U2hhZG93Um9vdCAmJiAhbm9kZS53ZWJraXRTaGFkb3dSb290Ll9fd2F0Y2hlZCkgewogICAgbG9nRmxhZ3MuZG9tICYmIGNvbnNvbGUubG9nKCd3YXRjaGluZyBzaGFkb3ctcm9vdCBmb3I6ICcsIG5vZGUubG9jYWxOYW1lKTsKICAgIG9ic2VydmUobm9kZS53ZWJraXRTaGFkb3dSb290KTsKICAgIG5vZGUud2Via2l0U2hhZG93Um9vdC5fX3dhdGNoZWQgPSB0cnVlOwogIH0KfQoKZnVuY3Rpb24gd2F0Y2hBbGxTaGFkb3dzKG5vZGUpIHsKICB3YXRjaFNoYWRvdyhub2RlKTsKICBmb3JTdWJ0cmVlKG5vZGUsIGZ1bmN0aW9uKGUpIHsKICAgIHdhdGNoU2hhZG93KG5vZGUpOwogIH0pOwp9CgpmdW5jdGlvbiBmaWx0ZXIoaW5Ob2RlKSB7CiAgc3dpdGNoIChpbk5vZGUubG9jYWxOYW1lKSB7CiAgICBjYXNlICdzdHlsZSc6CiAgICBjYXNlICdzY3JpcHQnOgogICAgY2FzZSAndGVtcGxhdGUnOgogICAgY2FzZSB1bmRlZmluZWQ6CiAgICAgIHJldHVybiB0cnVlOwogIH0KfQoKZnVuY3Rpb24gaGFuZGxlcihtdXRhdGlvbnMpIHsKICAvLwogIGlmIChsb2dGbGFncy5kb20pIHsKICAgIHZhciBteCA9IG11dGF0aW9uc1swXTsKICAgIGlmIChteCAmJiBteC50eXBlID09PSAnY2hpbGRMaXN0JyAmJiBteC5hZGRlZE5vZGVzKSB7CiAgICAgICAgaWYgKG14LmFkZGVkTm9kZXMpIHsKICAgICAgICAgIHZhciBkID0gbXguYWRkZWROb2Rlc1swXTsKICAgICAgICAgIHdoaWxlIChkICYmIGQgIT09IGRvY3VtZW50ICYmICFkLmhvc3QpIHsKICAgICAgICAgICAgZCA9IGQucGFyZW50Tm9kZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciB1ID0gZCAmJiAoZC5VUkwgfHwgZC5fVVJMIHx8IChkLmhvc3QgJiYgZC5ob3N0LmxvY2FsTmFtZSkpIHx8ICcnOwogICAgICAgICAgdSA9IHUuc3BsaXQoJy8/Jykuc2hpZnQoKS5zcGxpdCgnLycpLnBvcCgpOwogICAgICAgIH0KICAgIH0KICAgIGNvbnNvbGUuZ3JvdXAoJ211dGF0aW9ucyAoJWQpIFslc10nLCBtdXRhdGlvbnMubGVuZ3RoLCB1IHx8ICcnKTsKICB9CiAgLy8KICBtdXRhdGlvbnMuZm9yRWFjaChmdW5jdGlvbihteCkgewogICAgLy9sb2dGbGFncy5kb20gJiYgY29uc29sZS5ncm91cCgnbXV0YXRpb24nKTsKICAgIGlmIChteC50eXBlID09PSAnY2hpbGRMaXN0JykgewogICAgICBmb3JFYWNoKG14LmFkZGVkTm9kZXMsIGZ1bmN0aW9uKG4pIHsKICAgICAgICAvL2xvZ0ZsYWdzLmRvbSAmJiBjb25zb2xlLmxvZyhuLmxvY2FsTmFtZSk7CiAgICAgICAgaWYgKGZpbHRlcihuKSkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICAvLyB3YXRjaCBzaGFkb3ctcm9vdHMgb24gbm9kZXMgdGhhdCBoYXZlIGhhZCB0aGVtIGF0dGFjaGVkIG1hbnVhbGx5CiAgICAgICAgLy8gVE9ETyhzam1pbGVzKTogcmVtb3ZlIGlmIGNyZWF0ZVNoYWRvd1Jvb3QgaXMgb3ZlcnJpZGRlbgogICAgICAgIC8vIFRPRE8oc2ptaWxlcyk6IHJlbW92ZWQgYXMgYW4gb3B0aW1pemF0aW9uLCBtYW51YWwgc2hhZG93IHJvb3RzCiAgICAgICAgLy8gbXVzdCBiZSB3YXRjaGVkIGV4cGxpY2l0bHkKICAgICAgICAvL3dhdGNoQWxsU2hhZG93cyhuKTsKICAgICAgICAvLyBub2RlcyBhZGRlZCBtYXkgbmVlZCBsaWZlY3ljbGUgbWFuYWdlbWVudAogICAgICAgIGFkZGVkTm9kZShuKTsKICAgICAgfSk7CiAgICAgIC8vIHJlbW92ZWQgbm9kZXMgbWF5IG5lZWQgbGlmZWN5Y2xlIG1hbmFnZW1lbnQKICAgICAgZm9yRWFjaChteC5yZW1vdmVkTm9kZXMsIGZ1bmN0aW9uKG4pIHsKICAgICAgICAvL2xvZ0ZsYWdzLmRvbSAmJiBjb25zb2xlLmxvZyhuLmxvY2FsTmFtZSk7CiAgICAgICAgaWYgKGZpbHRlcihuKSkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICByZW1vdmVkTm9kZShuKTsKICAgICAgfSk7CiAgICB9CiAgICAvL2xvZ0ZsYWdzLmRvbSAmJiBjb25zb2xlLmdyb3VwRW5kKCk7CiAgfSk7CiAgbG9nRmxhZ3MuZG9tICYmIGNvbnNvbGUuZ3JvdXBFbmQoKTsKfTsKCnZhciBvYnNlcnZlciA9IG5ldyBNdXRhdGlvbk9ic2VydmVyKGhhbmRsZXIpOwoKZnVuY3Rpb24gdGFrZVJlY29yZHMoKSB7CiAgLy8gVE9ETyhzam1pbGVzKTogYXNrIFJhZiB3aHkgd2UgaGF2ZSB0byBjYWxsIGhhbmRsZXIgb3Vyc2VsdmVzCiAgaGFuZGxlcihvYnNlcnZlci50YWtlUmVjb3JkcygpKTsKfQoKdmFyIGZvckVhY2ggPSBBcnJheS5wcm90b3R5cGUuZm9yRWFjaC5jYWxsLmJpbmQoQXJyYXkucHJvdG90eXBlLmZvckVhY2gpOwoKZnVuY3Rpb24gb2JzZXJ2ZShpblJvb3QpIHsKICBvYnNlcnZlci5vYnNlcnZlKGluUm9vdCwge2NoaWxkTGlzdDogdHJ1ZSwgc3VidHJlZTogdHJ1ZX0pOwp9CgpmdW5jdGlvbiBvYnNlcnZlRG9jdW1lbnQoZG9jdW1lbnQpIHsKICBvYnNlcnZlKGRvY3VtZW50KTsKfQoKZnVuY3Rpb24gdXBncmFkZURvY3VtZW50KGRvY3VtZW50KSB7CiAgbG9nRmxhZ3MuZG9tICYmIGNvbnNvbGUuZ3JvdXAoJ3VwZ3JhZGVEb2N1bWVudDogJywgKGRvY3VtZW50LlVSTCB8fCBkb2N1bWVudC5fVVJMIHx8ICcnKS5zcGxpdCgnLycpLnBvcCgpKTsKICBhZGRlZE5vZGUoZG9jdW1lbnQpOwogIGxvZ0ZsYWdzLmRvbSAmJiBjb25zb2xlLmdyb3VwRW5kKCk7Cn0KCi8vIGV4cG9ydHMKCnNjb3BlLndhdGNoU2hhZG93ID0gd2F0Y2hTaGFkb3c7CnNjb3BlLndhdGNoQWxsU2hhZG93cyA9IHdhdGNoQWxsU2hhZG93czsKCnNjb3BlLnVwZ3JhZGVBbGwgPSBhZGRlZE5vZGU7CnNjb3BlLnVwZ3JhZGVTdWJ0cmVlID0gYWRkZWRTdWJ0cmVlOwoKc2NvcGUub2JzZXJ2ZURvY3VtZW50ID0gb2JzZXJ2ZURvY3VtZW50OwpzY29wZS51cGdyYWRlRG9jdW1lbnQgPSB1cGdyYWRlRG9jdW1lbnQ7CgpzY29wZS50YWtlUmVjb3JkcyA9IHRha2VSZWNvcmRzOwoKfSkod2luZG93LkN1c3RvbUVsZW1lbnRzKTsKCi8qCiAqIENvcHlyaWdodCAyMDEzIFRoZSBQb2x5bWVyIEF1dGhvcnMuIEFsbCByaWdodHMgcmVzZXJ2ZWQuCiAqIFVzZSBvZiB0aGlzIHNvdXJjZSBjb2RlIGlzIGdvdmVybmVkIGJ5IGEgQlNELXN0eWxlCiAqIGxpY2Vuc2UgdGhhdCBjYW4gYmUgZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZS4KICovCgooZnVuY3Rpb24oKXsKICAKdmFyIEhUTUxFbGVtZW50RWxlbWVudCA9IGZ1bmN0aW9uKGluRWxlbWVudCkgewogIGluRWxlbWVudC5yZWdpc3RlciA9IEhUTUxFbGVtZW50RWxlbWVudC5wcm90b3R5cGUucmVnaXN0ZXI7CiAgcGFyc2VFbGVtZW50RWxlbWVudChpbkVsZW1lbnQpOwogIHJldHVybiBpbkVsZW1lbnQ7Cn07CgpIVE1MRWxlbWVudEVsZW1lbnQucHJvdG90eXBlID0gewogIHJlZ2lzdGVyOiBmdW5jdGlvbihpbk1vcmUpIHsKICAgIGlmIChpbk1vcmUpIHsKICAgICAgdGhpcy5vcHRpb25zLmxpZmVjeWNsZSA9IGluTW9yZS5saWZlY3ljbGU7CiAgICAgIGlmIChpbk1vcmUucHJvdG90eXBlKSB7CiAgICAgICAgbWl4aW4odGhpcy5vcHRpb25zLnByb3RvdHlwZSwgaW5Nb3JlLnByb3RvdHlwZSk7CiAgICAgIH0KICAgIH0KICB9Cn07CgpmdW5jdGlvbiBwYXJzZUVsZW1lbnRFbGVtZW50KGluRWxlbWVudCkgewogIC8vIG9wdGlvbnMgdG8gZ2xlYW4gZnJvbSBpbkVsZW1lbnQgYXR0cmlidXRlcwogIHZhciBvcHRpb25zID0gewogICAgbmFtZTogJycsCiAgICBleHRlbmRzOiBudWxsCiAgfTsKICAvLyBnbGVhbiB0aGVtCiAgdGFrZUF0dHJpYnV0ZXMoaW5FbGVtZW50LCBvcHRpb25zKTsKICAvLyBkZWZhdWx0IGJhc2UKICB2YXIgYmFzZSA9IEhUTUxFbGVtZW50LnByb3RvdHlwZTsKICAvLyBvcHRpb25hbCBzcGVjaWZpZWQgYmFzZQogIGlmIChvcHRpb25zLmV4dGVuZHMpIHsKICAgIC8vIGJ1aWxkIGFuIGluc3RhbmNlIG9mIG9wdGlvbnMuZXh0ZW5kcwogICAgdmFyIGFyY2hldHlwZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQob3B0aW9ucy5leHRlbmRzKTsKICAgIC8vIGFjcXVpcmUgdGhlIHByb3RvdHlwZQogICAgLy8gVE9ETyhzam1pbGVzKTogX19wcm90b19fIG1heSBiZSBoaW50ZWQgYnkgdGhlIGN1c3RvbSBlbGVtZW50CiAgICAvLyBzeXN0ZW0gb24gcGxhdGZvcm1zIHRoYXQgZG9uJ3Qgc3VwcG9ydCBuYXRpdmUgX19wcm90b19fCiAgICAvLyBvbiB0aG9zZSBwbGF0Zm9ybXMgdGhlIEFQSSBpcyBtaXhlZCBpbnRvIGFyY2hldHlwZSBhbmQgdGhlCiAgICAvLyBlZmZlY3RpdmUgYmFzZSBpcyBub3QgYXJjaGV0eXBlJ3MgcmVhbCBwcm90b3R5cGUKICAgIGJhc2UgPSBhcmNoZXR5cGUuX19wcm90b19fIHx8IE9iamVjdC5nZXRQcm90b3R5cGVPZihhcmNoZXR5cGUpOwogIH0KICAvLyBleHRlbmQgYmFzZQogIG9wdGlvbnMucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShiYXNlKTsKICAvLyBpbnN0YWxsIG9wdGlvbnMKICBpbkVsZW1lbnQub3B0aW9ucyA9IG9wdGlvbnM7CiAgLy8gbG9jYXRlIHVzZXIgc2NyaXB0CiAgdmFyIHNjcmlwdCA9IGluRWxlbWVudC5xdWVyeVNlbGVjdG9yKCdzY3JpcHQsc2NyaXB0cycpOwogIGlmIChzY3JpcHQpIHsKICAgIC8vIGV4ZWN1dGUgdXNlciBzY3JpcHQgaW4gJ2luRWxlbWVudCcgY29udGV4dAogICAgZXhlY3V0ZUNvbXBvbmVudFNjcmlwdChzY3JpcHQudGV4dENvbnRlbnQsIGluRWxlbWVudCwgb3B0aW9ucy5uYW1lKTsKICB9OwogIC8vIHJlZ2lzdGVyIG91ciBuZXcgZWxlbWVudAogIHZhciBjdG9yID0gZG9jdW1lbnQucmVnaXN0ZXIob3B0aW9ucy5uYW1lLCBvcHRpb25zKTsKICBpbkVsZW1lbnQuY3RvciA9IGN0b3I7CiAgLy8gc3RvcmUgb3B0aW9uYWwgY29uc3RydWN0b3IgcmVmZXJlbmNlCiAgdmFyIHJlZk5hbWUgPSBpbkVsZW1lbnQuZ2V0QXR0cmlidXRlKCdjb25zdHJ1Y3RvcicpOwogIGlmIChyZWZOYW1lKSB7CiAgICB3aW5kb3dbcmVmTmFtZV0gPSBjdG9yOwogIH0KfQogIAovLyBlYWNoIHByb3BlcnR5IGluIGluRGljdGlvbmFyeSB0YWtlcyBhIHZhbHVlCi8vIGZyb20gdGhlIG1hdGNoaW5nIGF0dHJpYnV0ZSBpbiBpbkVsZW1lbnQsIGlmIGFueQpmdW5jdGlvbiB0YWtlQXR0cmlidXRlcyhpbkVsZW1lbnQsIGluRGljdGlvbmFyeSkgewogIGZvciAodmFyIG4gaW4gaW5EaWN0aW9uYXJ5KSB7CiAgICB2YXIgYSA9IGluRWxlbWVudC5hdHRyaWJ1dGVzW25dOwogICAgaWYgKGEpIHsKICAgICAgaW5EaWN0aW9uYXJ5W25dID0gYS52YWx1ZTsKICAgIH0KICB9Cn0KCi8vIGludm9rZSBpblNjcmlwdCBpbiBpbkNvbnRleHQgc2NvcGUKZnVuY3Rpb24gZXhlY3V0ZUNvbXBvbmVudFNjcmlwdChpblNjcmlwdCwgaW5Db250ZXh0LCBpbk5hbWUpIHsKICAvLyBzZXQgKGhpZ2hsYW5kZXIpIGNvbnRleHQKICBjb250ZXh0ID0gaW5Db250ZXh0OwogIC8vIHNvdXJjZSBsb2NhdGlvbgogIHZhciBvd25lciA9IGNvbnRleHQub3duZXJEb2N1bWVudDsKICB2YXIgdXJsID0gKG93bmVyLl9VUkwgfHwgb3duZXIuVVJMIHx8IG93bmVyLmltcGwgCiAgICAgICYmIChvd25lci5pbXBsLl9VUkwgfHwgb3duZXIuaW1wbC5VUkwpKTsKICAvLyBlbnN1cmUgdGhlIGNvbXBvbmVudCBoYXMgYSB1bmlxdWUgc291cmNlIG1hcCBzbyBpdCBjYW4gYmUgZGVidWdnZWQKICAvLyBpZiB0aGUgbmFtZSBtYXRjaGVzIHRoZSBmaWxlbmFtZSBwYXJ0IG9mIHRoZSBvd25pbmcgZG9jdW1lbnQncyB1cmwsCiAgLy8gdXNlIHRoaXMsIG90aGVyd2lzZSwgYWRkICI6PG5hbWU+IiB0byB0aGUgZG9jdW1lbnQgdXJsLgogIHZhciBtYXRjaCA9IHVybC5tYXRjaCgvLipcLyhbXi5dKilbLl0/LiokLyk7CiAgaWYgKG1hdGNoKSB7CiAgICB2YXIgbmFtZSA9IG1hdGNoWzFdOwogICAgdXJsICs9IG5hbWUgIT0gaW5OYW1lID8gJzonICsgaW5OYW1lIDogJyc7CiAgfQogIC8vIGNvbXBvc2Ugc2NyaXB0CiAgdmFyIGNvZGUgPSAiX19jb21wb25lbnRTY3JpcHQoJyIKICAgICsgaW5OYW1lCiAgICArICInLCBmdW5jdGlvbigpeyIKICAgICsgaW5TY3JpcHQKICAgICsgIn0pOyIKICAgICsgIlxuLy9AIHNvdXJjZVVSTD0iICsgdXJsICsgIlxuIgogIDsKICAvLyBpbmplY3Qgc2NyaXB0CiAgZXZhbChjb2RlKTsKfQoKdmFyIGNvbnRleHQ7CgovLyBnbG9iYWwgbmVjZXNzYXJ5IGZvciBzY3JpcHQgaW5qZWN0aW9uCndpbmRvdy5fX2NvbXBvbmVudFNjcmlwdCA9IGZ1bmN0aW9uKGluTmFtZSwgaW5GdW5jKSB7CiAgaW5GdW5jLmNhbGwoY29udGV4dCk7Cn07CgovLyB1dGlsaXR5CgovLyBjb3B5IHRvcCBsZXZlbCBwcm9wZXJ0aWVzIGZyb20gcHJvcHMgdG8gb2JqCmZ1bmN0aW9uIG1peGluKG9iaiwgcHJvcHMpIHsKICBvYmogPSBvYmogfHwge307CiAgdHJ5IHsKICAgIE9iamVjdC5nZXRPd25Qcm9wZXJ0eU5hbWVzKHByb3BzKS5mb3JFYWNoKGZ1bmN0aW9uKG4pIHsKICAgICAgdmFyIHBkID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihwcm9wcywgbik7CiAgICAgIGlmIChwZCkgewogICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShvYmosIG4sIHBkKTsKICAgICAgfQogICAgfSk7CiAgfSBjYXRjaCh4KSB7CiAgfQogIHJldHVybiBvYmo7Cn0KCi8vIGV4cG9ydHMKCndpbmRvdy5IVE1MRWxlbWVudEVsZW1lbnQgPSBIVE1MRWxlbWVudEVsZW1lbnQ7Cgp9KSgpOwoKLyoKICogQ29weXJpZ2h0IDIwMTMgVGhlIFBvbHltZXIgQXV0aG9ycy4gQWxsIHJpZ2h0cyByZXNlcnZlZC4KICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYSBCU0Qtc3R5bGUKICogbGljZW5zZSB0aGF0IGNhbiBiZSBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlLgogKi8KCihmdW5jdGlvbigpIHsKCnZhciBJTVBPUlRfTElOS19UWVBFID0gJ2ltcG9ydCc7CgovLyBoaWdobGFuZGVyIG9iamVjdCBmb3IgcGFyc2luZyBhIGRvY3VtZW50IHRyZWUKCnZhciBjb21wb25lbnRQYXJzZXIgPSB7CiAgc2VsZWN0b3JzOiBbCiAgICAnbGlua1tyZWw9JyArIElNUE9SVF9MSU5LX1RZUEUgKyAnXScsCiAgICAnbGlua1tyZWw9c3R5bGVzaGVldF0nLAogICAgJ3NjcmlwdFtzcmNdJywKICAgICdzY3JpcHQnLAogICAgJ3N0eWxlJywKICAgICdlbGVtZW50JwogIF0sCiAgbWFwOiB7CiAgICBsaW5rOiAncGFyc2VMaW5rJywKICAgIHNjcmlwdDogJ3BhcnNlU2NyaXB0JywKICAgIGVsZW1lbnQ6ICdwYXJzZUVsZW1lbnQnLAogICAgc3R5bGU6ICdwYXJzZVN0eWxlJwogIH0sCiAgcGFyc2U6IGZ1bmN0aW9uKGluRG9jdW1lbnQpIHsKICAgIGlmICghaW5Eb2N1bWVudC5fX3BhcnNlZCkgewogICAgICAvLyBvbmx5IHBhcnNlIG9uY2UKICAgICAgaW5Eb2N1bWVudC5fX3BhcnNlZCA9IHRydWU7CiAgICAgIC8vIGFsbCBwYXJzYWJsZSBlbGVtZW50cyBpbiBpbkRvY3VtZW50IChkZXB0aC1maXJzdCBwcmUtb3JkZXIgdHJhdmVyc2FsKQogICAgICB2YXIgZWx0cyA9IGluRG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbChjcC5zZWxlY3RvcnMpOwogICAgICAvLyBmb3IgZWFjaCBwYXJzYWJsZSBub2RlIHR5cGUsIGNhbGwgdGhlIG1hcHBlZCBwYXJzaW5nIG1ldGhvZAogICAgICBmb3JFYWNoKGVsdHMsIGZ1bmN0aW9uKGUpIHsKICAgICAgICAvL2NvbnNvbGUubG9nKG1hcFtlLmxvY2FsTmFtZV0gKyAiOiIsIHBhdGgubm9kZVVybChlKSk7CiAgICAgICAgY3BbY3AubWFwW2UubG9jYWxOYW1lXV0oZSk7CiAgICAgIH0pOwogICAgICAvLyB1cGdyYWRlIGFsbCB1cGdyYWRlYWJsZSBzdGF0aWMgZWxlbWVudHMsIGFueXRoaW5nIGR5bmFtaWNhbGx5CiAgICAgIC8vIGNyZWF0ZWQgc2hvdWxkIGJlIGNhdWdodCBieSBvYnNlcnZlcgogICAgICBDdXN0b21FbGVtZW50cy51cGdyYWRlRG9jdW1lbnQoaW5Eb2N1bWVudCk7CiAgICAgIC8vIG9ic2VydmUgZG9jdW1lbnQgZm9yIGRvbSBjaGFuZ2VzCiAgICAgIEN1c3RvbUVsZW1lbnRzLm9ic2VydmVEb2N1bWVudChpbkRvY3VtZW50KTsKICAgIH0KICB9LAogIHBhcnNlTGluazogZnVuY3Rpb24oaW5MaW5rRWx0KSB7CiAgICAvLyBpbXBvcnRzCiAgICBpZiAoaXNEb2N1bWVudExpbmsoaW5MaW5rRWx0KSkgewogICAgICBpZiAoaW5MaW5rRWx0LmNvbnRlbnQpIHsKICAgICAgICBjcC5wYXJzZShpbkxpbmtFbHQuY29udGVudCk7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAoY2FuQWRkVG9NYWluRG91bWVudChpbkxpbmtFbHQpKSB7CiAgICAgIGRvY3VtZW50LmhlYWQuYXBwZW5kQ2hpbGQoaW5MaW5rRWx0KTsKICAgIH0KICB9LAogIHBhcnNlU2NyaXB0OiBmdW5jdGlvbihpblNjcmlwdEVsdCkgewogICAgaWYgKGNhbkFkZFRvTWFpbkRvdW1lbnQoaW5TY3JpcHRFbHQpKSB7CiAgICAgIC8vIG90aGVyd2lzZSwgZXZhbHVhdGUgbm93CiAgICAgIHZhciBjb2RlID0gaW5TY3JpcHRFbHQuX19yZXNvdXJjZSB8fCBpblNjcmlwdEVsdC50ZXh0Q29udGVudDsKICAgICAgaWYgKGNvZGUpIHsKICAgICAgICBjb2RlICs9ICJcbi8vQCBzb3VyY2VVUkw9IiArIGluU2NyaXB0RWx0Ll9fbm9kZVVybCArICJcbiI7CiAgICAgICAgZXZhbC5jYWxsKHdpbmRvdywgY29kZSk7CiAgICAgIH0KICAgIH0KICB9LAogIHBhcnNlU3R5bGU6IGZ1bmN0aW9uKGluU3R5bGVFbHQpIHsKICAgIGlmIChjYW5BZGRUb01haW5Eb3VtZW50KGluU3R5bGVFbHQpKSB7CiAgICAgIGRvY3VtZW50LmhlYWQuYXBwZW5kQ2hpbGQoaW5TdHlsZUVsdCk7CiAgICB9CiAgfSwKICBwYXJzZUVsZW1lbnQ6IGZ1bmN0aW9uKGluRWxlbWVudEVsdCkgewogICAgbmV3IEhUTUxFbGVtZW50RWxlbWVudChpbkVsZW1lbnRFbHQpOwogIH0KfTsKCnZhciBjcCA9IGNvbXBvbmVudFBhcnNlcjsKCi8vIG5vZGVzIGNhbiBiZSBtb3ZlZCB0byB0aGUgbWFpbiBkb2N1bWVudAovLyBpZiB0aGV5IGFyZSBub3QgaW4gdGhlIG1haW4gZG9jdW1lbnQsIGFyZSBub3QgY2hpbGRyZW4gb2YgPGVsZW1lbnQ+Ci8vIGFuZCBhcmUgaW4gYSB0cmVlIGF0IHBhcnNlIHRpbWUuCmZ1bmN0aW9uIGNhbkFkZFRvTWFpbkRvdW1lbnQobm9kZSkgewogIHJldHVybiAhaW5NYWluRG9jdW1lbnQobm9kZSkKICAgICYmIG5vZGUucGFyZW50Tm9kZQogICAgJiYgIWlzRWxlbWVudEVsZW1lbnRDaGlsZChub2RlKTsKfQoKZnVuY3Rpb24gaW5NYWluRG9jdW1lbnQoaW5FbHQpIHsKICByZXR1cm4gaW5FbHQub3duZXJEb2N1bWVudCA9PT0gZG9jdW1lbnQgfHwKICAgIC8vIFRPRE8oc2ptaWxlcyk6IFNoYWRvd0RPTVBvbHlmaWxsIGludHJ1c2lvbgogICAgaW5FbHQub3duZXJEb2N1bWVudC5pbXBsID09PSBkb2N1bWVudDsKfQoKZnVuY3Rpb24gaXNEb2N1bWVudExpbmsoaW5FbHQpIHsKICByZXR1cm4gKGluRWx0LmxvY2FsTmFtZSA9PT0gJ2xpbmsnCiAgICAgICYmIGluRWx0LmdldEF0dHJpYnV0ZSgncmVsJykgPT09IElNUE9SVF9MSU5LX1RZUEUpOwp9CgpmdW5jdGlvbiBpc0VsZW1lbnRFbGVtZW50Q2hpbGQoaW5FbHQpIHsKICBpZiAoaW5FbHQucGFyZW50Tm9kZSAmJiBpbkVsdC5wYXJlbnROb2RlLmxvY2FsTmFtZSA9PT0gJ2VsZW1lbnQnKSB7CiAgICByZXR1cm4gdHJ1ZTsKICB9Cn0KCnZhciBmb3JFYWNoID0gQXJyYXkucHJvdG90eXBlLmZvckVhY2guY2FsbC5iaW5kKEFycmF5LnByb3RvdHlwZS5mb3JFYWNoKTsKCi8vIGV4cG9ydHMKCkN1c3RvbUVsZW1lbnRzLnBhcnNlciA9IGNvbXBvbmVudFBhcnNlcjsKCn0pKCk7Ci8qCiAqIENvcHlyaWdodCAyMDEzIFRoZSBQb2x5bWVyIEF1dGhvcnMuIEFsbCByaWdodHMgcmVzZXJ2ZWQuCiAqIFVzZSBvZiB0aGlzIHNvdXJjZSBjb2RlIGlzIGdvdmVybmVkIGJ5IGEgQlNELXN0eWxlCiAqIGxpY2Vuc2UgdGhhdCBjYW4gYmUgZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZS4KICovCihmdW5jdGlvbigpewoKLy8gYm9vdHN0cmFwIHBhcnNpbmcKCi8vIElFIHNoaW0gZm9yIEN1c3RvbUV2ZW50CmlmICh0eXBlb2Ygd2luZG93LkN1c3RvbUV2ZW50ICE9PSAnZnVuY3Rpb24nKSB7CiAgd2luZG93LkN1c3RvbUV2ZW50ID0gZnVuY3Rpb24oaW5UeXBlKSB7CiAgICAgdmFyIGUgPSBkb2N1bWVudC5jcmVhdGVFdmVudCgnSFRNTEV2ZW50cycpOwogICAgIGUuaW5pdEV2ZW50KGluVHlwZSwgdHJ1ZSwgdHJ1ZSk7CiAgICAgcmV0dXJuIGU7CiAgfTsKfQoKZnVuY3Rpb24gYm9vdHN0cmFwKCkgewogIC8vIGdvIGFzeW5jIHNvIGNhbGwgc3RhY2sgY2FuIHVud2luZAogIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAvLyBwYXJzZSBkb2N1bWVudAogICAgQ3VzdG9tRWxlbWVudHMucGFyc2VyLnBhcnNlKGRvY3VtZW50KTsKICAgIC8vIHNldCBpbnRlcm5hbCBmbGFnCiAgICBDdXN0b21FbGVtZW50cy5yZWFkeSA9IHRydWU7CiAgICBDdXN0b21FbGVtZW50cy5yZWFkeVRpbWUgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTsKICAgIGlmICh3aW5kb3cuSFRNTEltcG9ydHMpIHsKICAgICAgQ3VzdG9tRWxlbWVudHMuZWxhcHNlZCA9IEN1c3RvbUVsZW1lbnRzLnJlYWR5VGltZSAtIEhUTUxJbXBvcnRzLnJlYWR5VGltZTsKICAgIH0KICAgIC8vIG5vdGlmeSBzeXN0ZW0KICAgIGRvY3VtZW50LmJvZHkuZGlzcGF0Y2hFdmVudCgKICAgICAgbmV3IEN1c3RvbUV2ZW50KCdXZWJDb21wb25lbnRzUmVhZHknLCB7YnViYmxlczogdHJ1ZX0pCiAgICApOwogIH0sIDApOwp9CgovLyBUT0RPKHNqbWlsZXMpOiAnd2luZG93JyBoYXMgbm8gd3JhcHBhYmlsaXR5IHVuZGVyIFNoYWRvd0RPTSBwb2x5ZmlsbCwgc28KLy8gd2UgYXJlIGZvcmNlZCB0byBzcGxpdCBpbnRvIHR3byB2ZXJzaW9ucwoKaWYgKHdpbmRvdy5IVE1MSW1wb3J0cykgewogIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ0hUTUxJbXBvcnRzTG9hZGVkJywgYm9vdHN0cmFwKTsKfSBlbHNlIHsKICBpZiAoZG9jdW1lbnQucmVhZHlTdGF0ZSA9PT0gJ2NvbXBsZXRlJyB8fCBkb2N1bWVudC5yZWFkeVN0YXRlID09PSAnaW50ZXJhY3RpdmUnKSB7CiAgICBib29zdHJhcCgpOwogIH0gZWxzZSB7CiAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignRE9NQ29udGVudExvYWRlZCcsIGJvb3RzdHJhcCk7CiAgfQp9Cgp9KSgpOwoKLyoKICogQ29weXJpZ2h0IDIwMTMgVGhlIFBvbHltZXIgQXV0aG9ycy4gQWxsIHJpZ2h0cyByZXNlcnZlZC4KICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYSBCU0Qtc3R5bGUKICogbGljZW5zZSB0aGF0IGNhbiBiZSBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlLgogKi8KKGZ1bmN0aW9uKCkgewoKLy8gaW5qZWN0IHN0eWxlIHNoZWV0CnZhciBzdHlsZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3N0eWxlJyk7CnN0eWxlLnRleHRDb250ZW50ID0gJ2VsZW1lbnQge2Rpc3BsYXk6IG5vbmU7fSAvKiBpbmplY3RlZCBieSBwbGF0Zm9ybS5qcyAqLyc7CnZhciBoZWFkID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignaGVhZCcpOwpoZWFkLmluc2VydEJlZm9yZShzdHlsZSwgaGVhZC5maXJzdENoaWxkKTsKCmlmICh3aW5kb3cuU2hhZG93RE9NUG9seWZpbGwpIHsKCiAgZnVuY3Rpb24gbm9wKCkge307CgogIC8vIGRpc2FibGUgc2hhZG93IGRvbSB3YXRjaGluZwogIEN1c3RvbUVsZW1lbnRzLndhdGNoU2hhZG93ID0gbm9wOwogIEN1c3RvbUVsZW1lbnRzLndhdGNoQWxsU2hhZG93cyA9IG5vcDsKCiAgLy8gZW5zdXJlIHdyYXBwZWQgaW5wdXRzIGZvciB0aGVzZSBmdW5jdGlvbnMKICB2YXIgZm5zID0gWyd1cGdyYWRlQWxsJywgJ3VwZ3JhZGVTdWJ0cmVlJywgJ29ic2VydmVEb2N1bWVudCcsCiAgICAgICd1cGdyYWRlRG9jdW1lbnQnXTsKCiAgLy8gY2FjaGUgb3JpZ2luYWxzCiAgdmFyIG9yaWdpbmFsID0ge307CiAgZm5zLmZvckVhY2goZnVuY3Rpb24oZm4pIHsKICAgIG9yaWdpbmFsW2ZuXSA9IEN1c3RvbUVsZW1lbnRzW2ZuXTsKICB9KTsKCiAgLy8gb3ZlcnJpZGUKICBmbnMuZm9yRWFjaChmdW5jdGlvbihmbikgewogICAgQ3VzdG9tRWxlbWVudHNbZm5dID0gZnVuY3Rpb24oaW5Ob2RlKSB7CiAgICAgIHJldHVybiBvcmlnaW5hbFtmbl0od3JhcChpbk5vZGUpKTsKICAgIH07CiAgfSk7Cgp9Cgp9KSgpOwoKKGZ1bmN0aW9uICgpIHsKCi8qKiogVmFyaWFibGVzICoqKi8KCiAgdmFyIHdpbiA9IHdpbmRvdywKICAgIGRvYyA9IGRvY3VtZW50LAogICAgbm9vcCA9IGZ1bmN0aW9uKCl7fSwKICAgIHJlZ2V4UHNldWRvU3BsaXQgPSAvKFx3Kyg/OlwoW15cKV0rXCkpPykvZywKICAgIHJlZ2V4UHNldWRvUmVwbGFjZSA9IC8oXHcqKSg/OlwoKFteXCldKilcKSk/LywKICAgIHJlZ2V4RGlnaXRzID0gLyhcZCspL2csCiAgICBrZXlwc2V1ZG8gPSB7CiAgICAgIGFjdGlvbjogZnVuY3Rpb24gKHBzZXVkbywgZXZlbnQpIHsKICAgICAgICByZXR1cm4gcHNldWRvLnZhbHVlLm1hdGNoKHJlZ2V4RGlnaXRzKS5pbmRleE9mKFN0cmluZyhldmVudC5rZXlDb2RlKSkgPiAtMSA9PSAocHNldWRvLm5hbWUgPT0gJ2tleXBhc3MnKTsKICAgICAgfQogICAgfSwKICAgIHByZWZpeCA9IChmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBzdHlsZXMgPSB3aW4uZ2V0Q29tcHV0ZWRTdHlsZShkb2MuZG9jdW1lbnRFbGVtZW50LCAnJyksCiAgICAgICAgICBwcmUgPSAoQXJyYXkucHJvdG90eXBlLnNsaWNlCiAgICAgICAgICAgIC5jYWxsKHN0eWxlcykKICAgICAgICAgICAgLmpvaW4oJycpCiAgICAgICAgICAgIC5tYXRjaCgvLShtb3p8d2Via2l0fG1zKS0vKSB8fCAoc3R5bGVzLk9MaW5rID09PSAnJyAmJiBbJycsICdvJ10pCiAgICAgICAgICApWzFdOwogICAgICByZXR1cm4gewogICAgICAgIGRvbTogcHJlID09ICdtcycgPyBwcmUudG9VcHBlckNhc2UoKSA6IHByZSwKICAgICAgICBsb3dlcmNhc2U6IHByZSwKICAgICAgICBjc3M6ICctJyArIHByZSArICctJywKICAgICAgICBqczogcHJlWzBdLnRvVXBwZXJDYXNlKCkgKyBwcmUuc3Vic3RyKDEpCiAgICAgIH07CgogICAgfSkoKSwKICAgIG1hdGNoU2VsZWN0b3IgPSBFbGVtZW50LnByb3RvdHlwZS5tYXRjaGVzU2VsZWN0b3IgfHwgRWxlbWVudC5wcm90b3R5cGVbcHJlZml4Lmxvd2VyY2FzZSArICdNYXRjaGVzU2VsZWN0b3InXTsKCi8qKiogRnVuY3Rpb25zICoqKi8KCi8vIFV0aWxpdGllcwoKICB2YXIgdHlwZU9iaiA9IHt9OwogIGZ1bmN0aW9uIHR5cGVPZihvYmopIHsKICAgIHJldHVybiB0eXBlT2JqLnRvU3RyaW5nLmNhbGwob2JqKS5tYXRjaCgvXHMoW2EtekEtWl0rKS8pWzFdLnRvTG93ZXJDYXNlKCk7CiAgfQoKICBmdW5jdGlvbiBjbG9uZShpdGVtLCB0eXBlKXsKICAgIHZhciBmbiA9IGNsb25lW3R5cGUgfHwgdHlwZU9mKGl0ZW0pXTsKICAgIHJldHVybiBmbiA/IGZuKGl0ZW0pIDogaXRlbTsKICB9CiAgICBjbG9uZS5vYmplY3QgPSBmdW5jdGlvbihzcmMpewogICAgICB2YXIgb2JqID0ge307CiAgICAgIGZvciAodmFyIGtleSBpbiBzcmMpIG9ialtrZXldID0gY2xvbmUoc3JjW2tleV0pOwogICAgICByZXR1cm4gb2JqOwogICAgfTsKICAgIGNsb25lLmFycmF5ID0gZnVuY3Rpb24oc3JjKXsKICAgICAgdmFyIGkgPSBzcmMubGVuZ3RoLCBhcnJheSA9IG5ldyBBcnJheShpKTsKICAgICAgd2hpbGUgKGktLSkgYXJyYXlbaV0gPSBjbG9uZShzcmNbaV0pOwogICAgICByZXR1cm4gYXJyYXk7CiAgICB9OwoKICB2YXIgdW5zbGljZWFibGUgPSBbJ251bWJlcicsICdib29sZWFuJywgJ3N0cmluZycsICdmdW5jdGlvbiddOwogIGZ1bmN0aW9uIHRvQXJyYXkob2JqKXsKICAgIHJldHVybiB1bnNsaWNlYWJsZS5pbmRleE9mKHR5cGVPZihvYmopKSA9PSAtMSA/CiAgICBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChvYmosIDApIDoKICAgIFtvYmpdOwogIH0KCi8vIERPTQogIHZhciBzdHIgPSAnJzsKICBmdW5jdGlvbiBxdWVyeShlbGVtZW50LCBzZWxlY3Rvcil7CiAgICByZXR1cm4gKHNlbGVjdG9yIHx8IHN0cikubGVuZ3RoID8gdG9BcnJheShlbGVtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoc2VsZWN0b3IpKSA6IFtdOwogIH0KCiAgZnVuY3Rpb24gcGFyc2VNdXRhdGlvbnMoZWxlbWVudCwgbXV0YXRpb25zKSB7CiAgICB2YXIgZGlmZiA9IHsgYWRkZWQ6IFtdLCByZW1vdmVkOiBbXSB9OwogICAgbXV0YXRpb25zLmZvckVhY2goZnVuY3Rpb24ocmVjb3JkKXsKICAgICAgcmVjb3JkLl9tdXRhdGlvbiA9IHRydWU7CiAgICAgIGZvciAodmFyIHogaW4gZGlmZikgewogICAgICAgIHZhciB0eXBlID0gZWxlbWVudC5fcmVjb3Jkc1soeiA9PSAnYWRkZWQnKSA/ICdpbnNlcnRlZCcgOiAncmVtb3ZlZCddLAogICAgICAgICAgbm9kZXMgPSByZWNvcmRbeiArICdOb2RlcyddLCBsZW5ndGggPSBub2Rlcy5sZW5ndGg7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW5ndGggJiYgZGlmZlt6XS5pbmRleE9mKG5vZGVzW2ldKSA9PSAtMTsgaSsrKXsKICAgICAgICAgIGRpZmZbel0ucHVzaChub2Rlc1tpXSk7CiAgICAgICAgICB0eXBlLmZvckVhY2goZnVuY3Rpb24oZm4pewogICAgICAgICAgICBmbihub2Rlc1tpXSwgcmVjb3JkKTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgfQoKLy8gTWl4aW5zCgogIGZ1bmN0aW9uIG1lcmdlT25lKHNvdXJjZSwga2V5LCBjdXJyZW50KXsKICAgIHZhciB0eXBlID0gdHlwZU9mKGN1cnJlbnQpOwogICAgaWYgKHR5cGUgPT0gJ29iamVjdCcgJiYgdHlwZU9mKHNvdXJjZVtrZXldKSA9PSAnb2JqZWN0JykgeHRhZy5tZXJnZShzb3VyY2Vba2V5XSwgY3VycmVudCk7CiAgICBlbHNlIHNvdXJjZVtrZXldID0gY2xvbmUoY3VycmVudCwgdHlwZSk7CiAgICByZXR1cm4gc291cmNlOwogIH0KCiAgZnVuY3Rpb24gbWVyZ2VNaXhpbih0eXBlLCBtaXhpbiwgb3B0aW9uKSB7CiAgICB2YXIgb3JpZ2luYWwgPSB7fTsKICAgIGZvciAodmFyIG8gaW4gb3B0aW9uKSBvcmlnaW5hbFtvLnNwbGl0KCc6JylbMF1dID0gdHJ1ZTsKICAgIGZvciAodmFyIHggaW4gbWl4aW4pIGlmICghb3JpZ2luYWxbeC5zcGxpdCgnOicpWzBdXSkgb3B0aW9uW3hdID0gbWl4aW5beF07CiAgfQoKICBmdW5jdGlvbiBhcHBseU1peGlucyh0YWcpIHsKICAgIHRhZy5taXhpbnMuZm9yRWFjaChmdW5jdGlvbiAobmFtZSkgewogICAgICB2YXIgbWl4aW4gPSB4dGFnLm1peGluc1tuYW1lXTsKICAgICAgZm9yICh2YXIgdHlwZSBpbiBtaXhpbikgewogICAgICAgIHN3aXRjaCAodHlwZSkgewogICAgICAgICAgY2FzZSAnbGlmZWN5Y2xlJzogY2FzZSAnbWV0aG9kcyc6CiAgICAgICAgICAgIG1lcmdlTWl4aW4odHlwZSwgbWl4aW5bdHlwZV0sIHRhZ1t0eXBlXSk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSAnYWNjZXNzb3JzJzogY2FzZSAncHJvdG90eXBlJzoKICAgICAgICAgICAgZm9yICh2YXIgeiBpbiBtaXhpblt0eXBlXSkgbWVyZ2VNaXhpbih6LCBtaXhpblt0eXBlXSwgdGFnLmFjY2Vzc29ycyk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSAnZXZlbnRzJzoKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICAgIHJldHVybiB0YWc7CiAgfQoKLy8gRXZlbnRzCgogIGZ1bmN0aW9uIHRvdWNoRmlsdGVyKGN1c3RvbSwgZXZlbnQpIHsKICAgIGlmIChjdXN0b20ubGlzdGVuZXIudG91Y2hlZCkgcmV0dXJuIGN1c3RvbS5saXN0ZW5lci50b3VjaGVkID0gZmFsc2U7CiAgICBlbHNlIHsKICAgICAgaWYgKGV2ZW50LnR5cGUubWF0Y2goJ3RvdWNoJykpIGN1c3RvbS5saXN0ZW5lci50b3VjaGVkID0gdHJ1ZTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGNyZWF0ZUZsb3dFdmVudCh0eXBlKSB7CiAgICB2YXIgZmxvdyA9IHR5cGUgPT0gJ292ZXInOwogICAgcmV0dXJuIHsKICAgICAgYmFzZTogJ092ZXJmbG93RXZlbnQnIGluIHdpbiA/ICdvdmVyZmxvd2NoYW5nZWQnIDogdHlwZSArICdmbG93JywKICAgICAgY29uZGl0aW9uOiBmdW5jdGlvbiAoY3VzdG9tLCBldmVudCkgewogICAgICAgIGV2ZW50LmZsb3cgPSB0eXBlOwogICAgICAgIHJldHVybiBldmVudC50eXBlID09ICh0eXBlICsgJ2Zsb3cnKSB8fAogICAgICAgICgoZXZlbnQub3JpZW50ID09PSAwICYmIGV2ZW50Lmhvcml6b250YWxPdmVyZmxvdyA9PSBmbG93KSB8fAogICAgICAgIChldmVudC5vcmllbnQgPT0gMSAmJiBldmVudC52ZXJ0aWNhbE92ZXJmbG93ID09IGZsb3cpIHx8CiAgICAgICAgKGV2ZW50Lm9yaWVudCA9PSAyICYmIGV2ZW50Lmhvcml6b250YWxPdmVyZmxvdyA9PSBmbG93ICYmIGV2ZW50LnZlcnRpY2FsT3ZlcmZsb3cgPT0gZmxvdykpOwogICAgICB9CiAgICB9OwogIH0KCi8vIEFjY2Vzc29ycwoKICBmdW5jdGlvbiBnZXRBcmdzKGF0dHIsIHZhbHVlKXsKICAgIHJldHVybiB7CiAgICAgIHZhbHVlOiBhdHRyLmJvb2xlYW4gPyAnJyA6IHZhbHVlLAogICAgICBtZXRob2Q6IGF0dHIuYm9vbGVhbiAmJiAodmFsdWUgPT09IGZhbHNlIHx8IHZhbHVlID09PSBudWxsKSA/ICdyZW1vdmVBdHRyaWJ1dGUnIDogJ3NldEF0dHJpYnV0ZScKICAgIH07CiAgfQoKICBmdW5jdGlvbiBzZXRBdHRyKGF0dHIsIG5hbWUsIHZhbHVlKXsKICAgIHZhciBhcmdzID0gZ2V0QXJncyhhdHRyLCB2YWx1ZSk7CiAgICB0aGlzW2FyZ3MubWV0aG9kXShuYW1lLCBhcmdzLnZhbHVlKTsKICB9CgogIGZ1bmN0aW9uIHN5bmNBdHRyKGF0dHIsIG5hbWUsIHZhbHVlKXsKICAgIHZhciBhcmdzID0gZ2V0QXJncyhhdHRyLCB2YWx1ZSksCiAgICAgICAgbm9kZXMgPSBhdHRyLnByb3BlcnR5ID8gW3RoaXMueHRhZ1thdHRyLnByb3BlcnR5XV0gOiBhdHRyLnNlbGVjdG9yID8geHRhZy5xdWVyeSh0aGlzLCBhdHRyLnNlbGVjdG9yKSA6IFtdLAogICAgICAgIGluZGV4ID0gbm9kZXMubGVuZ3RoOwogICAgd2hpbGUgKGluZGV4LS0pIG5vZGVzW2luZGV4XVthcmdzLm1ldGhvZF0obmFtZSwgYXJncy52YWx1ZSk7CiAgfQoKICBmdW5jdGlvbiB3cmFwQXR0cih0YWcsIG1ldGhvZCl7CiAgICB2YXIgb3JpZ2luYWwgPSB0YWcucHJvdG90eXBlW21ldGhvZF0gfHwgSFRNTEVsZW1lbnQucHJvdG90eXBlW21ldGhvZF07CiAgICB0YWcucHJvdG90eXBlW21ldGhvZF0gPSB7CiAgICAgIHdyaXRhYmxlOiB0cnVlLAogICAgICBlbnVtYmVyYWJsZTogdHJ1ZSwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIChuYW1lLCB2YWx1ZSwgc2tpcCl7CiAgICAgICAgdmFyIGF0dHIgPSB0YWcuYXR0cmlidXRlc1tuYW1lLnRvTG93ZXJDYXNlKCldOwogICAgICAgIG9yaWdpbmFsLmNhbGwodGhpcywgbmFtZSwgYXR0ciAmJiBhdHRyLmJvb2xlYW4gPyAnJyA6IHZhbHVlKTsKICAgICAgICBpZiAoYXR0cikgewogICAgICAgICAgc3luY0F0dHIuY2FsbCh0aGlzLCBhdHRyLCBuYW1lLCB2YWx1ZSk7CiAgICAgICAgICBpZiAoIWF0dHIuc2tpcCAmJiAhdGhpcy54dGFnLl9za2lwQXR0cikgewogICAgICAgICAgICBhdHRyLnNldHRlci5jYWxsKHRoaXMsIGF0dHIuYm9vbGVhbiA/IG1ldGhvZCA9PSAnc2V0QXR0cmlidXRlJyA6IHRoaXMuZ2V0QXR0cmlidXRlKG5hbWUpKTsKICAgICAgICAgIH0KICAgICAgICAgIGRlbGV0ZSB0aGlzLnh0YWcuX3NraXBBdHRyOwogICAgICAgIH0KICAgICAgfQogICAgfTsKICB9CgogIGZ1bmN0aW9uIGF0dGFjaFByb3BlcnRpZXModGFnLCBwcm9wLCB6LCBhY2Nlc3NvciwgYXR0ciwgbmFtZSl7CiAgICB2YXIga2V5ID0gei5zcGxpdCgnOicpLCB0eXBlID0ga2V5WzBdOwogICAgaWYgKHR5cGUgPT0gJ2dldCcpIHsKICAgICAga2V5WzBdID0gcHJvcDsKICAgICAgdGFnLnByb3RvdHlwZVtwcm9wXS5nZXQgPSB4dGFnLmFwcGx5UHNldWRvcyhrZXkuam9pbignOicpLCBhY2Nlc3Nvclt6XSwgdGFnLnBzZXVkb3MpOwogICAgfQogICAgZWxzZSBpZiAodHlwZSA9PSAnc2V0JykgewogICAgICBrZXlbMF0gPSBwcm9wOwogICAgICBpZiAoYXR0cikgYXR0ci5zZXR0ZXIgPSBhY2Nlc3Nvclt6XTsKICAgICAgdGFnLnByb3RvdHlwZVtwcm9wXS5zZXQgPSB4dGFnLmFwcGx5UHNldWRvcyhrZXkuam9pbignOicpLCBhdHRyID8gZnVuY3Rpb24odmFsdWUsIHNraXApewogICAgICAgIGlmICghc2tpcCAmJiAhYXR0ci5za2lwKSB7CiAgICAgICAgICB0aGlzLnh0YWcuX3NraXBBdHRyID0gdHJ1ZTsKICAgICAgICAgIHNldEF0dHIuY2FsbCh0aGlzLCBhdHRyLCBuYW1lLCB2YWx1ZSk7CiAgICAgICAgfQogICAgICAgIHN5bmNBdHRyLmNhbGwodGhpcywgYXR0ciwgbmFtZSwgdmFsdWUpOwogICAgICAgIGFjY2Vzc29yW3pdLmNhbGwodGhpcywgdmFsdWUpOwogICAgICB9IDogYWNjZXNzb3Jbel0sIHRhZy5wc2V1ZG9zKTsKICAgIH0KICAgIGVsc2UgdGFnLnByb3RvdHlwZVtwcm9wXVt6XSA9IGFjY2Vzc29yW3pdOwogIH0KCiAgZnVuY3Rpb24gcGFyc2VBY2Nlc3Nvcih0YWcsIHByb3ApewogICAgdGFnLnByb3RvdHlwZVtwcm9wXSA9IHt9OwogICAgdmFyIGFjY2Vzc29yID0gdGFnLmFjY2Vzc29yc1twcm9wXSwKICAgICAgICBhdHRyID0gYWNjZXNzb3IuYXR0cmlidXRlLAogICAgICAgIG5hbWUgPSBhdHRyICYmIGF0dHIubmFtZSA/IGF0dHIubmFtZS50b0xvd2VyQ2FzZSgpIDogcHJvcDsKCiAgICBpZiAoYXR0cikgdGFnLmF0dHJpYnV0ZXNbbmFtZV0gPSBhdHRyOwogICAgZm9yICh2YXIgeiBpbiBhY2Nlc3NvcikgYXR0YWNoUHJvcGVydGllcyh0YWcsIHByb3AsIHosIGFjY2Vzc29yLCBhdHRyLCBuYW1lKTsKCiAgICBpZiAoYXR0cikgewogICAgICBpZiAoIXRhZy5wcm90b3R5cGVbcHJvcF0uZ2V0KSB7CiAgICAgICAgdmFyIG1ldGhvZCA9IChhdHRyLmJvb2xlYW4gPyAnaGFzJyA6ICdnZXQnKSArICdBdHRyaWJ1dGUnOwogICAgICAgIHRhZy5wcm90b3R5cGVbcHJvcF0uZ2V0ID0gZnVuY3Rpb24oKXsKICAgICAgICAgIHJldHVybiB0aGlzW21ldGhvZF0obmFtZSk7CiAgICAgICAgfTsKICAgICAgfQogICAgICBpZiAoIXRhZy5wcm90b3R5cGVbcHJvcF0uc2V0KSB0YWcucHJvdG90eXBlW3Byb3BdLnNldCA9IGZ1bmN0aW9uKHZhbHVlKXsKICAgICAgICB0aGlzLnh0YWcuX3NraXBBdHRyID0gdHJ1ZTsKICAgICAgICBzZXRBdHRyLmNhbGwodGhpcywgYXR0ciwgbmFtZSwgdmFsdWUpOwogICAgICB9OwogICAgfQogIH0KCi8qKiogWC1UYWcgT2JqZWN0IERlZmluaXRpb24gKioqLwoKICB2YXIgeHRhZyA9IHsKICAgIHRhZ3M6IHt9LAogICAgZGVmYXVsdE9wdGlvbnM6IHsKICAgICAgcHNldWRvczogW10sCiAgICAgIG1peGluczogW10sCiAgICAgIGV2ZW50czoge30sCiAgICAgIG1ldGhvZHM6IHt9LAogICAgICBhY2Nlc3NvcnM6IHt9LAogICAgICBsaWZlY3ljbGU6IHt9LAogICAgICBhdHRyaWJ1dGVzOiB7fSwKICAgICAgJ3Byb3RvdHlwZSc6IHsKICAgICAgICB4dGFnOiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCl7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9feHRhZ19fID8gdGhpcy5fX3h0YWdfXyA6ICh0aGlzLl9feHRhZ19fID0geyBkYXRhOiB7fSB9KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICByZWdpc3RlcjogZnVuY3Rpb24gKG5hbWUsIG9wdGlvbnMpIHsKICAgICAgdmFyIGVsZW1lbnQsIF9uYW1lOwogICAgICBpZiAodHlwZW9mIG5hbWUgPT0gJ3N0cmluZycpIHsKICAgICAgICBfbmFtZSA9IG5hbWUudG9Mb3dlckNhc2UoKTsKICAgICAgfSBlbHNlIGlmIChuYW1lLm5vZGVOYW1lID09ICdFTEVNRU5UJykgewogICAgICAgIGVsZW1lbnQgPSBuYW1lOwogICAgICAgIF9uYW1lID0gZWxlbWVudC5nZXRBdHRyaWJ1dGUoJ25hbWUnKS50b0xvd2VyQ2FzZSgpOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgdmFyIHRhZyA9IHh0YWcudGFnc1tfbmFtZV0gPSBhcHBseU1peGlucyh4dGFnLm1lcmdlKHt9LCB4dGFnLmRlZmF1bHRPcHRpb25zLCBvcHRpb25zKSk7CgogICAgICBmb3IgKHZhciB6IGluIHRhZy5ldmVudHMpIHRhZy5ldmVudHNbel0gPSB4dGFnLnBhcnNlRXZlbnQoeiwgdGFnLmV2ZW50c1t6XSk7CiAgICAgIGZvciAoeiBpbiB0YWcubGlmZWN5Y2xlKSB0YWcubGlmZWN5Y2xlW3ouc3BsaXQoJzonKVswXV0gPSB4dGFnLmFwcGx5UHNldWRvcyh6LCB0YWcubGlmZWN5Y2xlW3pdLCB0YWcucHNldWRvcyk7CiAgICAgIGZvciAoeiBpbiB0YWcubWV0aG9kcykgdGFnLnByb3RvdHlwZVt6LnNwbGl0KCc6JylbMF1dID0geyB2YWx1ZTogeHRhZy5hcHBseVBzZXVkb3MoeiwgdGFnLm1ldGhvZHNbel0sIHRhZy5wc2V1ZG9zKSwgZW51bWVyYWJsZTogdHJ1ZSB9OwogICAgICBmb3IgKHogaW4gdGFnLmFjY2Vzc29ycykgcGFyc2VBY2Nlc3Nvcih0YWcsIHopOwoKICAgICAgdmFyIHJlYWR5ID0gdGFnLmxpZmVjeWNsZS5jcmVhdGVkIHx8IHRhZy5saWZlY3ljbGUucmVhZHk7CiAgICAgIHRhZy5wcm90b3R5cGUucmVhZHlDYWxsYmFjayA9IHsKICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICAgIHZhbHVlOiBmdW5jdGlvbigpewogICAgICAgICAgdmFyIGVsZW1lbnQgPSB0aGlzOwogICAgICAgICAgeHRhZy5hZGRFdmVudHModGhpcywgdGFnLmV2ZW50cyk7CiAgICAgICAgICB0YWcubWl4aW5zLmZvckVhY2goZnVuY3Rpb24obWl4aW4pewogICAgICAgICAgICBpZiAoeHRhZy5taXhpbnNbbWl4aW5dLmV2ZW50cykgeHRhZy5hZGRFdmVudHMoZWxlbWVudCwgeHRhZy5taXhpbnNbbWl4aW5dLmV2ZW50cyk7CiAgICAgICAgICB9KTsKICAgICAgICAgIHZhciBvdXRwdXQgPSByZWFkeSA/IHJlYWR5LmFwcGx5KHRoaXMsIHRvQXJyYXkoYXJndW1lbnRzKSkgOiBudWxsOwogICAgICAgICAgZm9yICh2YXIgbmFtZSBpbiB0YWcuYXR0cmlidXRlcykgewogICAgICAgICAgICB2YXIgYXR0ciA9IHRhZy5hdHRyaWJ1dGVzW25hbWVdLAogICAgICAgICAgICAgICAgaGFzQXR0ciA9IHRoaXMuaGFzQXR0cmlidXRlKG5hbWUpLAogICAgICAgICAgICAgICAgdmFsdWUgPSBhdHRyLmJvb2xlYW4gPyBoYXNBdHRyIDogdGhpcy5nZXRBdHRyaWJ1dGUobmFtZSk7CiAgICAgICAgICAgIGlmIChhdHRyLmJvb2xlYW4gfHwgaGFzQXR0cikgewogICAgICAgICAgICAgIHN5bmNBdHRyLmNhbGwodGhpcywgYXR0ciwgbmFtZSwgdmFsdWUpOwogICAgICAgICAgICAgIGlmIChhdHRyLnNldHRlcikgYXR0ci5zZXR0ZXIuY2FsbCh0aGlzLCB2YWx1ZSwgdHJ1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHRhZy5wc2V1ZG9zLmZvckVhY2goZnVuY3Rpb24ob2JqKXsKICAgICAgICAgICAgb2JqLm9uQWRkLmNhbGwoZWxlbWVudCwgb2JqKTsKICAgICAgICAgIH0pOwogICAgICAgICAgcmV0dXJuIG91dHB1dDsKICAgICAgICB9CiAgICAgIH07CgogICAgICBpZiAodGFnLmxpZmVjeWNsZS5pbnNlcnRlZCkgdGFnLnByb3RvdHlwZS5pbnNlcnRlZENhbGxiYWNrID0geyB2YWx1ZTogdGFnLmxpZmVjeWNsZS5pbnNlcnRlZCwgZW51bWVyYWJsZTogdHJ1ZSB9OwogICAgICBpZiAodGFnLmxpZmVjeWNsZS5yZW1vdmVkKSB0YWcucHJvdG90eXBlLnJlbW92ZWRDYWxsYmFjayA9IHsgdmFsdWU6IHRhZy5saWZlY3ljbGUucmVtb3ZlZCwgZW51bWVyYWJsZTogdHJ1ZSB9OwogICAgICBpZiAodGFnLmxpZmVjeWNsZS5hdHRyaWJ1dGVDaGFuZ2VkKSB0YWcucHJvdG90eXBlLmF0dHJpYnV0ZUNoYW5nZWRDYWxsYmFjayA9IHsgdmFsdWU6IHRhZy5saWZlY3ljbGUuYXR0cmlidXRlQ2hhbmdlZCwgZW51bWVyYWJsZTogdHJ1ZSB9OwoKICAgICAgd3JhcEF0dHIodGFnLCAnc2V0QXR0cmlidXRlJyk7CiAgICAgIHdyYXBBdHRyKHRhZywgJ3JlbW92ZUF0dHJpYnV0ZScpOwogICAgICAKICAgICAgaWYgKGVsZW1lbnQpewogICAgICAgIGVsZW1lbnQucmVnaXN0ZXIoewogICAgICAgICAgJ3Byb3RvdHlwZSc6IE9iamVjdC5jcmVhdGUoT2JqZWN0LnByb3RvdHlwZSwgdGFnLnByb3RvdHlwZSkKICAgICAgICB9KTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gZG9jLnJlZ2lzdGVyKF9uYW1lLCB7CiAgICAgICAgICAnZXh0ZW5kcyc6IG9wdGlvbnNbJ2V4dGVuZHMnXSwKICAgICAgICAgICdwcm90b3R5cGUnOiBPYmplY3QuY3JlYXRlKE9iamVjdC5jcmVhdGUoKG9wdGlvbnNbJ2V4dGVuZHMnXSA/CiAgICAgICAgICAgIGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQob3B0aW9uc1snZXh0ZW5kcyddKS5jb25zdHJ1Y3RvciA6CiAgICAgICAgICAgIHdpbi5IVE1MRWxlbWVudCkucHJvdG90eXBlLCB0YWcucHJvdG90eXBlKSwgdGFnLnByb3RvdHlwZSkKICAgICAgICB9KTsKICAgICAgfQogICAgfSwKCiAgICAvKiBFeHBvc2VkIFZhcmlhYmxlcyAqLwoKICAgIG1peGluczoge30sCiAgICBwcmVmaXg6IHByZWZpeCwKICAgIGNhcHR1cmVFdmVudHM6IFsnZm9jdXMnLCAnYmx1ciddLAogICAgY3VzdG9tRXZlbnRzOiB7CiAgICAgIG92ZXJmbG93OiBjcmVhdGVGbG93RXZlbnQoJ292ZXInKSwKICAgICAgdW5kZXJmbG93OiBjcmVhdGVGbG93RXZlbnQoJ3VuZGVyJyksCiAgICAgIGFuaW1hdGlvbnN0YXJ0OiB7CiAgICAgICAgYmFzZTogWwogICAgICAgICAgJ2FuaW1hdGlvbnN0YXJ0JywKICAgICAgICAgICdvQW5pbWF0aW9uU3RhcnQnLAogICAgICAgICAgJ01TQW5pbWF0aW9uU3RhcnQnLAogICAgICAgICAgJ3dlYmtpdEFuaW1hdGlvblN0YXJ0JwogICAgICAgIF0KICAgICAgfSwKICAgICAgdHJhbnNpdGlvbmVuZDogewogICAgICAgIGJhc2U6IFsKICAgICAgICAgICd0cmFuc2l0aW9uZW5kJywKICAgICAgICAgICdvVHJhbnNpdGlvbkVuZCcsCiAgICAgICAgICAnTVNUcmFuc2l0aW9uRW5kJywKICAgICAgICAgICd3ZWJraXRUcmFuc2l0aW9uRW5kJwogICAgICAgIF0KICAgICAgfSwKICAgICAgdGFwOiB7CiAgICAgICAgYmFzZTogWydjbGljaycsICd0b3VjaGVuZCddLAogICAgICAgIGNvbmRpdGlvbjogdG91Y2hGaWx0ZXIKICAgICAgfSwKICAgICAgdGFwc3RhcnQ6IHsKICAgICAgICBiYXNlOiBbJ21vdXNlZG93bicsICd0b3VjaHN0YXJ0J10sCiAgICAgICAgY29uZGl0aW9uOiB0b3VjaEZpbHRlcgogICAgICB9LAogICAgICB0YXBlbmQ6IHsKICAgICAgICBiYXNlOiBbJ21vdXNldXAnLCAndG91Y2hlbmQnXSwKICAgICAgICBjb25kaXRpb246IHRvdWNoRmlsdGVyCiAgICAgIH0sCiAgICAgIHRhcGVudGVyOiB7CiAgICAgICAgYmFzZTogWydtb3VzZW92ZXInLCAndG91Y2hlbnRlciddLAogICAgICAgIGNvbmRpdGlvbjogdG91Y2hGaWx0ZXIKICAgICAgfSwKICAgICAgdGFwbGVhdmU6IHsKICAgICAgICBiYXNlOiBbJ21vdXNlb3V0JywgJ3RvdWNobGVhdmUnXSwKICAgICAgICBjb25kaXRpb246IHRvdWNoRmlsdGVyCiAgICAgIH0sCiAgICAgIHRhcG1vdmU6IHsKICAgICAgICBiYXNlOiBbJ21vdXNlbW92ZScsICd0b3VjaG1vdmUnXSwKICAgICAgICBjb25kaXRpb246IHRvdWNoRmlsdGVyCiAgICAgIH0KICAgIH0sCiAgICBwc2V1ZG9zOiB7CiAgICAgIGtleXBhc3M6IGtleXBzZXVkbywKICAgICAga2V5ZmFpbDoga2V5cHNldWRvLAogICAgICBkZWxlZ2F0ZTogewogICAgICAgIGFjdGlvbjogZnVuY3Rpb24gKHBzZXVkbywgZXZlbnQpIHsKICAgICAgICAgIHZhciB0YXJnZXQgPSBxdWVyeSh0aGlzLCBwc2V1ZG8udmFsdWUpLmZpbHRlcihmdW5jdGlvbiAobm9kZSkgewogICAgICAgICAgICByZXR1cm4gbm9kZSA9PSBldmVudC50YXJnZXQgfHwgbm9kZS5jb250YWlucyA/IG5vZGUuY29udGFpbnMoZXZlbnQudGFyZ2V0KSA6IGZhbHNlOwogICAgICAgICAgfSlbMF07CiAgICAgICAgICByZXR1cm4gdGFyZ2V0ID8gcHNldWRvLmxpc3RlbmVyID0gcHNldWRvLmxpc3RlbmVyLmJpbmQodGFyZ2V0KSA6IGZhbHNlOwogICAgICAgIH0KICAgICAgfSwKICAgICAgcHJldmVudGFibGU6IHsKICAgICAgICBhY3Rpb246IGZ1bmN0aW9uIChwc2V1ZG8sIGV2ZW50KSB7CiAgICAgICAgICByZXR1cm4gIWV2ZW50LmRlZmF1bHRQcmV2ZW50ZWQ7CiAgICAgICAgfQogICAgICB9CiAgICB9LAoKICAgIC8qIFVUSUxJVElFUyAqLwoKICAgIGNsb25lOiBjbG9uZSwKICAgIHR5cGVPZjogdHlwZU9mLAogICAgdG9BcnJheTogdG9BcnJheSwKCiAgICB3cmFwOiBmdW5jdGlvbiAob3JpZ2luYWwsIGZuKSB7CiAgICAgIHJldHVybiBmdW5jdGlvbigpewogICAgICAgIHZhciBhcmdzID0gdG9BcnJheShhcmd1bWVudHMpLAogICAgICAgICAgcmV0dXJuZWQgPSBvcmlnaW5hbC5hcHBseSh0aGlzLCBhcmdzKTsKICAgICAgICByZXR1cm4gcmV0dXJuZWQgPT09IGZhbHNlID8gZmFsc2UgOiBmbi5hcHBseSh0aGlzLCB0eXBlb2YgcmV0dXJuZWQgIT0gJ3VuZGVmaW5lZCcgPyB0b0FycmF5KHJldHVybmVkKSA6IGFyZ3MpOwogICAgICB9OwogICAgfSwKCiAgICBtZXJnZTogZnVuY3Rpb24oc291cmNlLCBrLCB2KXsKICAgICAgaWYgKHR5cGVPZihrKSA9PSAnc3RyaW5nJykgcmV0dXJuIG1lcmdlT25lKHNvdXJjZSwgaywgdik7CiAgICAgIGZvciAodmFyIGkgPSAxLCBsID0gYXJndW1lbnRzLmxlbmd0aDsgaSA8IGw7IGkrKyl7CiAgICAgICAgdmFyIG9iamVjdCA9IGFyZ3VtZW50c1tpXTsKICAgICAgICBmb3IgKHZhciBrZXkgaW4gb2JqZWN0KSBtZXJnZU9uZShzb3VyY2UsIGtleSwgb2JqZWN0W2tleV0pOwogICAgICB9CiAgICAgIHJldHVybiBzb3VyY2U7CiAgICB9LAoKICAgIC8qIERPTSAqLwoKICAgIHF1ZXJ5OiBxdWVyeSwKCiAgICBza2lwVHJhbnNpdGlvbjogZnVuY3Rpb24oZWxlbWVudCwgZm4sIGJpbmQpewogICAgICB2YXIgcHJvcCA9IHByZWZpeC5qcyArICdUcmFuc2l0aW9uUHJvcGVydHknOwogICAgICBlbGVtZW50LnN0eWxlW3Byb3BdID0gZWxlbWVudC5zdHlsZS50cmFuc2l0aW9uUHJvcGVydHkgPSAnbm9uZSc7CiAgICAgIHh0YWcucmVxdWVzdEZyYW1lKGZ1bmN0aW9uKCl7CiAgICAgICAgdmFyIGNhbGxiYWNrOwogICAgICAgIGlmIChmbikgY2FsbGJhY2sgPSBmbi5jYWxsKGJpbmQpOwogICAgICAgIHh0YWcucmVxdWVzdEZyYW1lKGZ1bmN0aW9uKCl7CiAgICAgICAgICBlbGVtZW50LnN0eWxlW3Byb3BdID0gZWxlbWVudC5zdHlsZS50cmFuc2l0aW9uUHJvcGVydHkgPSAnJzsKICAgICAgICAgIGlmIChjYWxsYmFjaykgeHRhZy5yZXF1ZXN0RnJhbWUoY2FsbGJhY2spOwogICAgICAgIH0pOwogICAgICB9KTsKICAgIH0sCgogICAgcmVxdWVzdEZyYW1lOiAoZnVuY3Rpb24oKXsKICAgICAgdmFyIHJhZiA9IHdpbi5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUgfHwKICAgICAgICB3aW5bcHJlZml4Lmxvd2VyY2FzZSArICdSZXF1ZXN0QW5pbWF0aW9uRnJhbWUnXSB8fAogICAgICAgIGZ1bmN0aW9uKGZuKXsgcmV0dXJuIHdpbi5zZXRUaW1lb3V0KGZuLCAyMCk7IH07CiAgICAgIHJldHVybiBmdW5jdGlvbihmbil7CiAgICAgICAgcmV0dXJuIHJhZi5jYWxsKHdpbiwgZm4pOwogICAgICB9OwogICAgfSkoKSwKCiAgICBtYXRjaFNlbGVjdG9yOiBmdW5jdGlvbiAoZWxlbWVudCwgc2VsZWN0b3IpIHsKICAgICAgcmV0dXJuIG1hdGNoU2VsZWN0b3IuY2FsbChlbGVtZW50LCBzZWxlY3Rvcik7CiAgICB9LAoKICAgIHNldDogZnVuY3Rpb24gKGVsZW1lbnQsIG1ldGhvZCwgdmFsdWUpIHsKICAgICAgZWxlbWVudFttZXRob2RdID0gdmFsdWU7CiAgICAgIGlmICh3aW5kb3cuQ3VzdG9tRWxlbWVudHMpIEN1c3RvbUVsZW1lbnRzLnVwZ3JhZGVBbGwoZWxlbWVudCk7CiAgICB9LAoKICAgIGlubmVySFRNTDogZnVuY3Rpb24oZWwsIGh0bWwpewogICAgICB4dGFnLnNldChlbCwgJ2lubmVySFRNTCcsIGh0bWwpOwogICAgfSwKCiAgICBoYXNDbGFzczogZnVuY3Rpb24gKGVsZW1lbnQsIGtsYXNzKSB7CiAgICAgIHJldHVybiBlbGVtZW50LmNsYXNzTmFtZS5zcGxpdCgnICcpLmluZGV4T2Yoa2xhc3MudHJpbSgpKT4tMTsKICAgIH0sCgogICAgYWRkQ2xhc3M6IGZ1bmN0aW9uIChlbGVtZW50LCBrbGFzcykgewogICAgICB2YXIgbGlzdCA9IGVsZW1lbnQuY2xhc3NOYW1lLnRyaW0oKS5zcGxpdCgnICcpOwogICAgICBrbGFzcy50cmltKCkuc3BsaXQoJyAnKS5mb3JFYWNoKGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgaWYgKCF+bGlzdC5pbmRleE9mKG5hbWUpKSBsaXN0LnB1c2gobmFtZSk7CiAgICAgIH0pOwogICAgICBlbGVtZW50LmNsYXNzTmFtZSA9IGxpc3Quam9pbignICcpLnRyaW0oKTsKICAgICAgcmV0dXJuIGVsZW1lbnQ7CiAgICB9LAoKICAgIHJlbW92ZUNsYXNzOiBmdW5jdGlvbiAoZWxlbWVudCwga2xhc3MpIHsKICAgICAgdmFyIGNsYXNzZXMgPSBrbGFzcy50cmltKCkuc3BsaXQoJyAnKTsKICAgICAgZWxlbWVudC5jbGFzc05hbWUgPSBlbGVtZW50LmNsYXNzTmFtZS50cmltKCkuc3BsaXQoJyAnKS5maWx0ZXIoZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICByZXR1cm4gbmFtZSAmJiAhfmNsYXNzZXMuaW5kZXhPZihuYW1lKTsKICAgICAgfSkuam9pbignICcpOwogICAgICByZXR1cm4gZWxlbWVudDsKICAgIH0sCgogICAgdG9nZ2xlQ2xhc3M6IGZ1bmN0aW9uIChlbGVtZW50LCBrbGFzcykgewogICAgICByZXR1cm4geHRhZ1t4dGFnLmhhc0NsYXNzKGVsZW1lbnQsIGtsYXNzKSA/ICdyZW1vdmVDbGFzcycgOiAnYWRkQ2xhc3MnXS5jYWxsKG51bGwsIGVsZW1lbnQsIGtsYXNzKTsKCiAgICB9LAoKICAgIHF1ZXJ5Q2hpbGRyZW46IGZ1bmN0aW9uIChlbGVtZW50LCBzZWxlY3RvcikgewogICAgICB2YXIgaWQgPSBlbGVtZW50LmlkLAogICAgICAgIGd1aWQgPSBlbGVtZW50LmlkID0gaWQgfHwgJ3hfJyArIG5ldyBEYXRlKCkuZ2V0VGltZSgpLAogICAgICAgIGF0dHIgPSAnIycgKyBndWlkICsgJyA+ICc7CiAgICAgIHNlbGVjdG9yID0gYXR0ciArIChzZWxlY3RvciArICcnKS5yZXBsYWNlKCcsJywgJywnICsgYXR0ciwgJ2cnKTsKICAgICAgdmFyIHJlc3VsdCA9IGVsZW1lbnQucGFyZW50Tm9kZS5xdWVyeVNlbGVjdG9yQWxsKHNlbGVjdG9yKTsKICAgICAgaWYgKCFpZCkgZWxlbWVudC5yZW1vdmVBdHRyaWJ1dGUoJ2lkJyk7CiAgICAgIHJldHVybiB0b0FycmF5KHJlc3VsdCk7CiAgICB9LAoKICAgIGNyZWF0ZUZyYWdtZW50OiBmdW5jdGlvbihjb250ZW50KSB7CiAgICAgIHZhciBmcmFnID0gZG9jLmNyZWF0ZURvY3VtZW50RnJhZ21lbnQoKTsKICAgICAgaWYgKGNvbnRlbnQpIHsKICAgICAgICB2YXIgZGl2ID0gZnJhZy5hcHBlbmRDaGlsZChkb2MuY3JlYXRlRWxlbWVudCgnZGl2JykpLAogICAgICAgICAgbm9kZXMgPSB0b0FycmF5KGNvbnRlbnQubm9kZU5hbWUgPyBhcmd1bWVudHMgOiAhKGRpdi5pbm5lckhUTUwgPSBjb250ZW50KSB8fCBkaXYuY2hpbGRyZW4pLAogICAgICAgICAgbGVuZ3RoID0gbm9kZXMubGVuZ3RoLAogICAgICAgICAgaW5kZXggPSAwOwogICAgICAgIHdoaWxlIChpbmRleCA8IGxlbmd0aCkgZnJhZy5pbnNlcnRCZWZvcmUobm9kZXNbaW5kZXgrK10sIGRpdik7CiAgICAgICAgZnJhZy5yZW1vdmVDaGlsZChkaXYpOwogICAgICB9CiAgICAgIHJldHVybiBmcmFnOwogICAgfSwKCiAgICBtYW5pcHVsYXRlOiBmdW5jdGlvbihlbGVtZW50LCBmbil7CiAgICAgIHZhciBuZXh0ID0gZWxlbWVudC5uZXh0U2libGluZywKICAgICAgICBwYXJlbnQgPSBlbGVtZW50LnBhcmVudE5vZGUsCiAgICAgICAgZnJhZyA9IGRvYy5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCksCiAgICAgICAgcmV0dXJuZWQgPSBmbi5jYWxsKGZyYWcuYXBwZW5kQ2hpbGQoZWxlbWVudCksIGZyYWcpIHx8IGVsZW1lbnQ7CiAgICAgIGlmIChuZXh0KSBwYXJlbnQuaW5zZXJ0QmVmb3JlKHJldHVybmVkLCBuZXh0KTsKICAgICAgZWxzZSBwYXJlbnQuYXBwZW5kQ2hpbGQocmV0dXJuZWQpOwogICAgfSwKCiAgICAvKiBQU0VVRE9TICovCgogICAgYXBwbHlQc2V1ZG9zOiBmdW5jdGlvbihrZXksIGZuLCBlbGVtZW50KSB7CiAgICAgIHZhciBsaXN0ZW5lciA9IGZuLAogICAgICAgICAgcHNldWRvcyA9IHt9OwogICAgICBpZiAoa2V5Lm1hdGNoKCc6JykpIHsKICAgICAgICB2YXIgc3BsaXQgPSBrZXkubWF0Y2gocmVnZXhQc2V1ZG9TcGxpdCksCiAgICAgICAgICAgIGkgPSBzcGxpdC5sZW5ndGg7CiAgICAgICAgd2hpbGUgKC0taSkgewogICAgICAgICAgc3BsaXRbaV0ucmVwbGFjZShyZWdleFBzZXVkb1JlcGxhY2UsIGZ1bmN0aW9uIChtYXRjaCwgbmFtZSwgdmFsdWUpIHsKICAgICAgICAgICAgdmFyIHBzZXVkbyA9IHBzZXVkb3NbaV0gPSBPYmplY3QuY3JlYXRlKHh0YWcucHNldWRvc1tuYW1lXSk7CiAgICAgICAgICAgICAgICBwc2V1ZG8ua2V5ID0ga2V5OwogICAgICAgICAgICAgICAgcHNldWRvLm5hbWUgPSBuYW1lOwogICAgICAgICAgICAgICAgcHNldWRvLnZhbHVlID0gdmFsdWU7CiAgICAgICAgICAgIGlmICghcHNldWRvKSB0aHJvdyAicHNldWRvIG5vdCBmb3VuZDogIiArIG5hbWU7CiAgICAgICAgICAgIHZhciBsYXN0ID0gbGlzdGVuZXI7CiAgICAgICAgICAgIGxpc3RlbmVyID0gZnVuY3Rpb24oKXsKICAgICAgICAgICAgICB2YXIgYXJncyA9IHRvQXJyYXkoYXJndW1lbnRzKSwKICAgICAgICAgICAgICAgICAgb2JqID0gewogICAgICAgICAgICAgICAgICAgIGtleToga2V5LAogICAgICAgICAgICAgICAgICAgIG5hbWU6IG5hbWUsCiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IHZhbHVlLAogICAgICAgICAgICAgICAgICAgIGxpc3RlbmVyOiBsYXN0CiAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgaWYgKHBzZXVkby5hY3Rpb24gJiYgcHNldWRvLmFjdGlvbi5hcHBseSh0aGlzLCBbb2JqXS5jb25jYXQoYXJncykpID09PSBmYWxzZSkgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgIHJldHVybiBvYmoubGlzdGVuZXIuYXBwbHkodGhpcywgYXJncyk7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGlmIChlbGVtZW50ICYmIHBzZXVkby5vbkFkZCkgewogICAgICAgICAgICAgIGlmIChlbGVtZW50LmdldEF0dHJpYnV0ZSkgewogICAgICAgICAgICAgICAgcHNldWRvLm9uQWRkLmNhbGwoZWxlbWVudCwgcHNldWRvKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZWxlbWVudC5wdXNoKHBzZXVkbyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0KICAgICAgZm9yICh2YXIgeiBpbiBwc2V1ZG9zKSB7CiAgICAgICAgaWYgKHBzZXVkb3Nbel0ub25Db21waWxlZCkgbGlzdGVuZXIgPSBwc2V1ZG9zW3pdLm9uQ29tcGlsZWQobGlzdGVuZXIsIHBzZXVkb3Nbel0pOwogICAgICB9CiAgICAgIHJldHVybiBsaXN0ZW5lcjsKICAgIH0sCgogICAgcmVtb3ZlUHNldWRvczogZnVuY3Rpb24oZWxlbWVudCwgZXZlbnQpewogICAgICBldmVudC5fcHNldWRvcy5mb3JFYWNoKGZ1bmN0aW9uKG9iail7CiAgICAgICAgb2JqLm9uUmVtb3ZlLmNhbGwoZWxlbWVudCwgb2JqKTsKICAgICAgfSk7CiAgICB9LAoKICAvKioqIEV2ZW50cyAqKiovCgogICAgcGFyc2VFdmVudDogZnVuY3Rpb24odHlwZSwgZm4pIHsKICAgICAgdmFyIHBzZXVkb3MgPSB0eXBlLnNwbGl0KCc6JyksCiAgICAgICAga2V5ID0gcHNldWRvcy5zaGlmdCgpLAogICAgICAgIGV2ZW50ID0geHRhZy5tZXJnZSh7CiAgICAgICAgICBiYXNlOiBrZXksCiAgICAgICAgICBwc2V1ZG9zOiAnJywKICAgICAgICAgIF9wc2V1ZG9zOiBbXSwKICAgICAgICAgIG9uQWRkOiBub29wLAogICAgICAgICAgb25SZW1vdmU6IG5vb3AsCiAgICAgICAgICBjb25kaXRpb246IG5vb3AKICAgICAgICB9LCB4dGFnLmN1c3RvbUV2ZW50c1trZXldIHx8IHt9KTsKICAgICAgZXZlbnQudHlwZSA9IGtleSArIChldmVudC5wc2V1ZG9zLmxlbmd0aCA/ICc6JyArIGV2ZW50LnBzZXVkb3MgOiAnJykgKyAocHNldWRvcy5sZW5ndGggPyAnOicgKyBwc2V1ZG9zLmpvaW4oJzonKSA6ICcnKTsKICAgICAgaWYgKGZuKSB7CiAgICAgICAgdmFyIGNoYWluZWQgPSB4dGFnLmFwcGx5UHNldWRvcyhldmVudC50eXBlLCBmbiwgZXZlbnQuX3BzZXVkb3MpOwogICAgICAgIGV2ZW50Lmxpc3RlbmVyID0gZnVuY3Rpb24oKXsKICAgICAgICAgIHZhciBhcmdzID0gdG9BcnJheShhcmd1bWVudHMpOwogICAgICAgICAgaWYgKGV2ZW50LmNvbmRpdGlvbi5hcHBseSh0aGlzLCBbZXZlbnRdLmNvbmNhdChhcmdzKSkgPT09IGZhbHNlKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICByZXR1cm4gY2hhaW5lZC5hcHBseSh0aGlzLCBhcmdzKTsKICAgICAgICB9OwogICAgICB9CiAgICAgIHJldHVybiBldmVudDsKICAgIH0sCgogICAgYWRkRXZlbnQ6IGZ1bmN0aW9uIChlbGVtZW50LCB0eXBlLCBmbikgewogICAgICB2YXIgZXZlbnQgPSAodHlwZW9mIGZuID09ICdmdW5jdGlvbicpID8geHRhZy5wYXJzZUV2ZW50KHR5cGUsIGZuKSA6IGZuOwogICAgICBldmVudC5saXN0ZW5lci5ldmVudCA9IGV2ZW50OwogICAgICBldmVudC5fcHNldWRvcy5mb3JFYWNoKGZ1bmN0aW9uKG9iail7CiAgICAgICAgb2JqLm9uQWRkLmNhbGwoZWxlbWVudCwgb2JqKTsKICAgICAgfSk7CiAgICAgIGV2ZW50Lm9uQWRkLmNhbGwoZWxlbWVudCwgZXZlbnQsIGV2ZW50Lmxpc3RlbmVyKTsKICAgICAgdG9BcnJheShldmVudC5iYXNlKS5mb3JFYWNoKGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKG5hbWUsIGV2ZW50Lmxpc3RlbmVyLCB4dGFnLmNhcHR1cmVFdmVudHMuaW5kZXhPZihuYW1lKSA+IC0xKTsKICAgICAgfSk7CiAgICAgIHJldHVybiBldmVudC5saXN0ZW5lcjsKICAgIH0sCgogICAgYWRkRXZlbnRzOiBmdW5jdGlvbiAoZWxlbWVudCwgZXZlbnRzKSB7CiAgICAgIHZhciBsaXN0ZW5lcnMgPSB7fTsKICAgICAgZm9yICh2YXIgeiBpbiBldmVudHMpIHsKICAgICAgICBsaXN0ZW5lcnNbel0gPSB4dGFnLmFkZEV2ZW50KGVsZW1lbnQsIHosIGV2ZW50c1t6XSk7CiAgICAgIH0KICAgICAgcmV0dXJuIGxpc3RlbmVyczsKICAgIH0sCgogICAgcmVtb3ZlRXZlbnQ6IGZ1bmN0aW9uIChlbGVtZW50LCB0eXBlLCBmbikgewogICAgICB2YXIgZXZlbnQgPSBmbi5ldmVudDsKICAgICAgZXZlbnQub25SZW1vdmUuY2FsbChlbGVtZW50LCBldmVudCwgZm4pOwogICAgICB4dGFnLnJlbW92ZVBzZXVkb3MoZWxlbWVudCwgZXZlbnQpOwogICAgICB0b0FycmF5KGV2ZW50LmJhc2UpLmZvckVhY2goZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICBlbGVtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIobmFtZSwgZm4pOwogICAgICB9KTsKICAgIH0sCgogICAgcmVtb3ZlRXZlbnRzOiBmdW5jdGlvbihlbGVtZW50LCBsaXN0ZW5lcnMpewogICAgICBmb3IgKHZhciB6IGluIGxpc3RlbmVycykgeHRhZy5yZW1vdmVFdmVudChlbGVtZW50LCB6LCBsaXN0ZW5lcnNbel0pOwogICAgfSwKCiAgICBmaXJlRXZlbnQ6IGZ1bmN0aW9uKGVsZW1lbnQsIHR5cGUsIGRhdGEsIG9wdGlvbnMpewogICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgICAgdmFyIGV2ZW50ID0gZG9jLmNyZWF0ZUV2ZW50KCdFdmVudCcpOwogICAgICBldmVudC5pbml0RXZlbnQodHlwZSwgJ2J1YmJsZXMnIGluIG9wdGlvbnMgPyBvcHRpb25zLmJ1YmJsZXMgOiB0cnVlLCAnY2FuY2VsYWJsZScgaW4gb3B0aW9ucyA/IG9wdGlvbnMuY2FuY2VsYWJsZSA6IHRydWUpOwogICAgICBmb3IgKHZhciB6IGluIGRhdGEpIGV2ZW50W3pdID0gZGF0YVt6XTsKICAgICAgZWxlbWVudC5kaXNwYXRjaEV2ZW50KGV2ZW50KTsKICAgIH0sCgogICAgYWRkT2JzZXJ2ZXI6IGZ1bmN0aW9uKGVsZW1lbnQsIHR5cGUsIGZuKXsKICAgICAgaWYgKCFlbGVtZW50Ll9yZWNvcmRzKSB7CiAgICAgICAgZWxlbWVudC5fcmVjb3JkcyA9IHsgaW5zZXJ0ZWQ6IFtdLCByZW1vdmVkOiBbXSB9OwogICAgICAgIGlmIChtdXRhdGlvbil7CiAgICAgICAgICBlbGVtZW50Ll9vYnNlcnZlciA9IG5ldyBtdXRhdGlvbihmdW5jdGlvbihtdXRhdGlvbnMpIHsKICAgICAgICAgICAgcGFyc2VNdXRhdGlvbnMoZWxlbWVudCwgbXV0YXRpb25zKTsKICAgICAgICAgIH0pOwogICAgICAgICAgZWxlbWVudC5fb2JzZXJ2ZXIub2JzZXJ2ZShlbGVtZW50LCB7CiAgICAgICAgICAgIHN1YnRyZWU6IHRydWUsCiAgICAgICAgICAgIGNoaWxkTGlzdDogdHJ1ZSwKICAgICAgICAgICAgYXR0cmlidXRlczogIXRydWUsCiAgICAgICAgICAgIGNoYXJhY3RlckRhdGE6IGZhbHNlCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgZWxzZSBbJ0luc2VydGVkJywgJ1JlbW92ZWQnXS5mb3JFYWNoKGZ1bmN0aW9uKHR5cGUpewogICAgICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCdET01Ob2RlJyArIHR5cGUsIGZ1bmN0aW9uKGV2ZW50KXsKICAgICAgICAgICAgZXZlbnQuX211dGF0aW9uID0gdHJ1ZTsKICAgICAgICAgICAgZWxlbWVudC5fcmVjb3Jkc1t0eXBlLnRvTG93ZXJDYXNlKCldLmZvckVhY2goZnVuY3Rpb24oZm4pewogICAgICAgICAgICAgIGZuKGV2ZW50LnRhcmdldCwgZXZlbnQpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0sIGZhbHNlKTsKICAgICAgICB9KTsKICAgICAgfQogICAgICBpZiAoZWxlbWVudC5fcmVjb3Jkc1t0eXBlXS5pbmRleE9mKGZuKSA9PSAtMSkgZWxlbWVudC5fcmVjb3Jkc1t0eXBlXS5wdXNoKGZuKTsKICAgIH0sCgogICAgcmVtb3ZlT2JzZXJ2ZXI6IGZ1bmN0aW9uKGVsZW1lbnQsIHR5cGUsIGZuKXsKICAgICAgdmFyIG9iaiA9IGVsZW1lbnQuX3JlY29yZHM7CiAgICAgIGlmIChvYmogJiYgZm4pewogICAgICAgIG9ialt0eXBlXS5zcGxpY2Uob2JqW3R5cGVdLmluZGV4T2YoZm4pLCAxKTsKICAgICAgfQogICAgICBlbHNlewogICAgICAgIG9ialt0eXBlXSA9IFtdOwogICAgICB9CiAgICB9CgogIH07CgogIGlmICh0eXBlb2YgZGVmaW5lID09ICdmdW5jdGlvbicgJiYgZGVmaW5lLmFtZCkgZGVmaW5lKHh0YWcpOwogIGVsc2Ugd2luLnh0YWcgPSB4dGFnOwoKICBkb2MuYWRkRXZlbnRMaXN0ZW5lcignV2ViQ29tcG9uZW50c1JlYWR5JywgZnVuY3Rpb24oKXsKICAgIHh0YWcuZmlyZUV2ZW50KGRvYy5ib2R5LCAnRE9NQ29tcG9uZW50c0xvYWRlZCcpOwogIH0pOwoKfSkoKTs=",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Sun, 09 Nov 2014 03:47:41 GMT",
                    "Content-Length": "66593",
                    "Date": "Sun, 09 Nov 2014 03:47:41 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}