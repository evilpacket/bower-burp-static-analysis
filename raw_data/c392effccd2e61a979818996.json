{
    "url": "http://localhost:9999/Solire/fullPage.js/jquery.fullPage.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Cross-site scripting (DOM-based)",
    "issueType": 2097936,
    "severity": "High",
    "confidence": "Firm",
    "issueBackground": "DOM-based cross-site scripting vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this data into the HTML document in an unsafe way. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will cause JavaScript code supplied by the attacker to execute within the user's browser in the context of that user's session with the application.<br><br>The attacker-supplied code can perform a wide variety of actions, such as stealing the victim's session token or login credentials, performing arbitrary actions on the victim's behalf, and logging their keystrokes.<br><br>Users can be induced to visit the attacker's crafted URL in various ways, similar to the usual attack delivery vectors for reflected cross-site scripting vulnerabilities. ",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based cross-site scripting vulnerabilities is not to dynamically write data into the HTML document that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing script code into the document. In many cases, the relevant data can be validated on a whitelist basis, to allow only content that is known to be safe. In other cases, it will be necessary to sanitize or encode the data. This can be a complex task, and depending on the context that the data is to be inserted may need to involve a combination of JavaScript escaping, HTML encoding, and URL encoding, in the appropriate sequence.",
    "issueDetail": "The application may be vulnerable to DOM-based cross-site scripting. Data is read from <b>window.location.hash</b> and written to <b>$()</b> via the following statements:<ul><li>var value =  window.location.hash.replace('#', '').split('/');</li><li>var section = value[0];</li><li>scrollPageAndSlide(section, slide);</li><li>var section = $('[data-anchor=\"'+destiny+'\"]');</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/Solire/fullPage.js/jquery.fullPage.js",
                "path": "/Solire/fullPage.js/jquery.fullPage.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9Tb2xpcmUvZnVsbFBhZ2UuanMvanF1ZXJ5LmZ1bGxQYWdlLmpzIEhUVFAvMS4xDQpIb3N0OiBsb2NhbGhvc3Q6OTk5OQ0KDQo=",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogNTQ1MTUNCkFjY2VwdC1SYW5nZXM6IGJ5dGVzDQpDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2phdmFzY3JpcHQNCkRhdGU6IEZyaSwgMDcgTm92IDIwMTQgMDE6NTk6NTIgR01UDQpMYXN0LU1vZGlmaWVkOiBGcmksIDA3IE5vdiAyMDE0IDAxOjU5OjUyIEdNVA0KDQovKioNCiAqIGZ1bGxQYWdlIDEuNy4yDQogKiBodHRwczovL2dpdGh1Yi5jb20vYWx2YXJvdHJpZ28vZnVsbFBhZ2UuanMNCiAqIE1JVCBsaWNlbnNlZA0KICoNCiAqIENvcHlyaWdodCAoQykgMjAxMyBhbHZhcm90cmlnby5jb20gLSBBIHByb2plY3QgYnkgQWx2YXJvIFRyaWdvDQogKi8NCg0KKGZ1bmN0aW9uKCQpIHsNCiAgICAkLmZuLmZ1bGxwYWdlID0gZnVuY3Rpb24ob3B0aW9ucykgew0KICAgICAgICAvLyBDcmVhdGUgc29tZSBkZWZhdWx0cywgZXh0ZW5kaW5nIHRoZW0gd2l0aCBhbnkgb3B0aW9ucyB0aGF0IHdlcmUgcHJvdmlkZWQNCiAgICAgICAgb3B0aW9ucyA9ICQuZXh0ZW5kKHsNCiAgICAgICAgICAgICdoYXNoQ2hhbmdlJyAgICAgICAgICAgIDogZmFsc2UsDQogICAgICAgICAgICAnaW5pdGlhbFNsaWRlJyAgICAgICAgICA6IDAsDQogICAgICAgICAgICAndmVydGljYWxDZW50ZXJlZCcgICAgICA6IHRydWUsDQogICAgICAgICAgICAncmVzaXplJyAgICAgICAgICAgICAgICA6IHRydWUsDQogICAgICAgICAgICAnc2xpZGVzQ29sb3InICAgICAgICAgICA6IFtdLA0KICAgICAgICAgICAgJ2FuY2hvcnMnICAgICAgICAgICAgICAgOiBbXSwNCiAgICAgICAgICAgICdzY3JvbGxpbmdTcGVlZCcgICAgICAgIDogNzAwLA0KICAgICAgICAgICAgJ2Vhc2luZycgICAgICAgICAgICAgICAgOiAnZWFzZUluUXVhcnQnLA0KICAgICAgICAgICAgJ21lbnUnICAgICAgICAgICAgICAgICAgOiBmYWxzZSwNCiAgICAgICAgICAgICduYXZpZ2F0aW9uJyAgICAgICAgICAgIDogZmFsc2UsDQogICAgICAgICAgICAnbmF2aWdhdGlvblBvc2l0aW9uJyAgICA6ICdyaWdodCcsDQogICAgICAgICAgICAnbmF2aWdhdGlvbkNvbG9yJyAgICAgICA6ICcjMDAwJywNCiAgICAgICAgICAgICduYXZpZ2F0aW9uVG9vbHRpcHMnICAgIDogW10sDQogICAgICAgICAgICAnc2xpZGVzTmF2aWdhdGlvbicgICAgICA6IGZhbHNlLA0KICAgICAgICAgICAgJ3NsaWRlc05hdlBvc2l0aW9uJyAgICAgOiAnYm90dG9tJywNCiAgICAgICAgICAgICdjb250cm9sQXJyb3dDb2xvcicgICAgIDogJyNmZmYnLA0KICAgICAgICAgICAgJ2xvb3BCb3R0b20nICAgICAgICAgICAgOiBmYWxzZSwNCiAgICAgICAgICAgICdsb29wVG9wJyAgICAgICAgICAgICAgIDogZmFsc2UsDQogICAgICAgICAgICAnbG9vcEhvcml6b250YWwnICAgICAgICA6IHRydWUsDQogICAgICAgICAgICAnYXV0b1Njcm9sbGluZycgICAgICAgICA6IHRydWUsDQogICAgICAgICAgICAnc2Nyb2xsT3ZlcmZsb3cnICAgICAgICA6IGZhbHNlLA0KICAgICAgICAgICAgJ2NzczMnICAgICAgICAgICAgICAgICAgOiBmYWxzZSwNCiAgICAgICAgICAgICdwYWRkaW5nVG9wJyAgICAgICAgICAgIDogMCwNCiAgICAgICAgICAgICdwYWRkaW5nQm90dG9tJyAgICAgICAgIDogMCwNCiAgICAgICAgICAgICdmaXhlZEVsZW1lbnRzJyAgICAgICAgIDogbnVsbCwNCiAgICAgICAgICAgICdub3JtYWxTY3JvbGxFbGVtZW50cycgIDogbnVsbCwNCiAgICAgICAgICAgICdrZXlib2FyZFNjcm9sbGluZycgICAgIDogdHJ1ZSwNCiAgICAgICAgICAgICd0b3VjaFNlbnNpdGl2aXR5JyAgICAgIDogNSwNCiAgICAgICAgICAgICdjb250aW51b3VzVmVydGljYWwnICAgIDogZmFsc2UsDQogICAgICAgICAgICAnYW5pbWF0ZUFuY2hvcicgICAgICAgICA6IHRydWUsDQoNCiAgICAgICAgICAgIC8vZXZlbnRzDQogICAgICAgICAgICAnYWZ0ZXJMb2FkJyAgICAgICAgICAgICA6IG51bGwsDQogICAgICAgICAgICAnb25MZWF2ZScgICAgICAgICAgICAgICA6IG51bGwsDQogICAgICAgICAgICAnYWZ0ZXJSZW5kZXInICAgICAgICAgICA6IG51bGwsDQogICAgICAgICAgICAnYWZ0ZXJTbGlkZUxvYWQnICAgICAgICA6IG51bGwsDQogICAgICAgICAgICAnb25TbGlkZUxlYXZlJyAgICAgICAgICA6IG51bGwNCiAgICAgICAgfSwgb3B0aW9ucyk7DQoNCiAgICAgICAgLy8gRGlzYWJsZSBtdXR1YWxseSBleGNsdXNpdmUgc2V0dGluZ3MNCiAgICAgICAgaWYgKG9wdGlvbnMuY29udGludW91c1ZlcnRpY2FsICYmDQogICAgICAgICAgICAob3B0aW9ucy5sb29wVG9wIHx8IG9wdGlvbnMubG9vcEJvdHRvbSkNCiAgICAgICAgKSB7DQogICAgICAgICAgICBvcHRpb25zLmNvbnRpbnVvdXNWZXJ0aWNhbCA9IGZhbHNlOw0KICAgICAgICAgICAgY29uc29sZSAmJiBjb25zb2xlLmxvZyAmJiBjb25zb2xlLmxvZygiT3B0aW9uIGxvb3BUb3AvbG9vcEJvdHRvbSBpcyBtdXR1YWxseSBleGNsdXNpdmUgd2l0aCBjb250aW51b3VzVmVydGljYWw7IGNvbnRpbnVvdXNWZXJ0aWNhbCBkaXNhYmxlZCIpOw0KICAgICAgICB9DQoNCiAgICAgICAgLy9EZWZpbmVzIHRoZSBkZWxheSB0byB0YWtlIHBsYWNlIGJlZm9yZSBiZWluZyBhYmxlIHRvIHNjcm9sbCB0byB0aGUgbmV4dCBzZWN0aW9uDQogICAgICAgIC8vQkUgQ0FSRUZVTCEgTm90IHJlY29tbWVuZWQgdG8gY2hhbmdlIGl0IHVuZGVyIDQwMCBmb3IgYSBnb29kIGJlaGF2aW9yIGluIGxhcHRvcHMgYW5kDQogICAgICAgIC8vQXBwbGUgZGV2aWNlcyAobGFwdG9wcywgbW91c2VzLi4uKQ0KICAgICAgICB2YXIgc2Nyb2xsRGVsYXkgPSA2MDA7DQoNCiAgICAgICAgJC5mbi5mdWxscGFnZS5zZXRBdXRvU2Nyb2xsaW5nID0gZnVuY3Rpb24odmFsdWUpew0KICAgICAgICAgICAgb3B0aW9ucy5hdXRvU2Nyb2xsaW5nID0gdmFsdWU7DQoNCiAgICAgICAgICAgIHZhciBlbGVtZW50ID0gJCgnLnNlY3Rpb24uYWN0aXZlJyk7DQoNCiAgICAgICAgICAgIGlmKG9wdGlvbnMuYXV0b1Njcm9sbGluZyl7DQogICAgICAgICAgICAgICAgJCgnaHRtbCwgYm9keScpLmNzcyh7DQogICAgICAgICAgICAgICAgICAgICdvdmVyZmxvdycgOiAnaGlkZGVuJywNCiAgICAgICAgICAgICAgICAgICAgJ2hlaWdodCcgOiAnMTAwJScNCiAgICAgICAgICAgICAgICB9KTsNCg0KICAgICAgICAgICAgICAgIGlmKGVsZW1lbnQubGVuZ3RoKXsNCiAgICAgICAgICAgICAgICAgICAgLy9tb3ZpbmcgdGhlIGNvbnRhaW5lciB1cA0KICAgICAgICAgICAgICAgICAgICBzaWxlbnRTY3JvbGwoZWxlbWVudC5wb3NpdGlvbigpLnRvcCk7DQogICAgICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICAkKCdodG1sLCBib2R5JykuY3NzKHsNCiAgICAgICAgICAgICAgICAgICAgJ292ZXJmbG93JyA6ICdhdXRvJywNCiAgICAgICAgICAgICAgICAgICAgJ2hlaWdodCcgOiAnYXV0bycNCiAgICAgICAgICAgICAgICB9KTsNCg0KICAgICAgICAgICAgICAgIHNpbGVudFNjcm9sbCgwKTsNCg0KICAgICAgICAgICAgICAgIC8vc2Nyb2xsaW5nIHRoZSBwYWdlIHRvIHRoZSBzZWN0aW9uIHdpdGggbm8gYW5pbWF0aW9uDQogICAgICAgICAgICAgICAgJCgnaHRtbCwgYm9keScpLnNjcm9sbFRvcChlbGVtZW50LnBvc2l0aW9uKCkudG9wKTsNCiAgICAgICAgICAgIH0NCg0KICAgICAgICB9Ow0KDQogICAgICAgIC8qKg0KICAgICAgICAqIERlZmluZXMgdGhlIHNjcm9sbGluZyBzcGVlZA0KICAgICAgICAqLw0KICAgICAgICAkLmZuLmZ1bGxwYWdlLnNldFNjcm9sbGluZ1NwZWVkID0gZnVuY3Rpb24odmFsdWUpew0KICAgICAgICAgICBvcHRpb25zLnNjcm9sbGluZ1NwZWVkID0gdmFsdWU7DQogICAgICAgIH07DQoNCiAgICAgICAgLyoqDQogICAgICAgICogQWRkcyBvciByZW1vdmUgdGhlIHBvc3NpYmxpdHkgb2Ygc2Nyb2xsaW5nIHRocm91Z2ggc2VjdGlvbnMgYnkgdXNpbmcgdGhlIG1vdXNlIHdoZWVsIG9yIHRoZSB0cmFja3BhZC4NCiAgICAgICAgKi8NCiAgICAgICAgJC5mbi5mdWxscGFnZS5zZXRNb3VzZVdoZWVsU2Nyb2xsaW5nID0gZnVuY3Rpb24gKHZhbHVlKXsNCiAgICAgICAgICAgIGlmKHZhbHVlKXsNCiAgICAgICAgICAgICAgICBhZGRNb3VzZVdoZWVsSGFuZGxlcigpOw0KICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgcmVtb3ZlTW91c2VXaGVlbEhhbmRsZXIoKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfTsNCg0KICAgICAgICAvKioNCiAgICAgICAgKiBBZGRzIG9yIHJlbW92ZSB0aGUgcG9zc2libGl0eSBvZiBzY3JvbGxpbmcgdGhyb3VnaCBzZWN0aW9ucyBieSB1c2luZyB0aGUgbW91c2Ugd2hlZWwvdHJhY2twYWQgb3IgdG91Y2ggZ2VzdHVyZXMuDQogICAgICAgICovDQogICAgICAgICQuZm4uZnVsbHBhZ2Uuc2V0QWxsb3dTY3JvbGxpbmcgPSBmdW5jdGlvbiAodmFsdWUpew0KICAgICAgICAgICAgaWYodmFsdWUpew0KICAgICAgICAgICAgICAgICQuZm4uZnVsbHBhZ2Uuc2V0TW91c2VXaGVlbFNjcm9sbGluZyh0cnVlKTsNCiAgICAgICAgICAgICAgICBhZGRUb3VjaEhhbmRsZXIoKTsNCiAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICQuZm4uZnVsbHBhZ2Uuc2V0TW91c2VXaGVlbFNjcm9sbGluZyhmYWxzZSk7DQogICAgICAgICAgICAgICAgcmVtb3ZlVG91Y2hIYW5kbGVyKCk7DQogICAgICAgICAgICB9DQogICAgICAgIH07DQoNCiAgICAgICAgLyoqDQogICAgICAgICogQWRkcyBvciByZW1vdmUgdGhlIHBvc3NpYmxpdHkgb2Ygc2Nyb2xsaW5nIHRocm91Z2ggc2VjdGlvbnMgYnkgdXNpbmcgdGhlIGtleWJvYXJkIGFycm93IGtleXMNCiAgICAgICAgKi8NCiAgICAgICAgJC5mbi5mdWxscGFnZS5zZXRLZXlib2FyZFNjcm9sbGluZyA9IGZ1bmN0aW9uICh2YWx1ZSl7DQogICAgICAgICAgICBvcHRpb25zLmtleWJvYXJkU2Nyb2xsaW5nID0gdmFsdWU7DQogICAgICAgIH07DQoNCiAgICAgICAgLy9mbGFnIHRvIGF2b2lkIHZlcnkgZmFzdCBzbGlkaW5nIGZvciBsYW5kc2NhcGUgc2xpZGVycw0KICAgICAgICB2YXIgc2xpZGVNb3ZpbmcgPSBmYWxzZTsNCg0KICAgICAgICB2YXIgaXNUYWJsZXQgPSBuYXZpZ2F0b3IudXNlckFnZW50Lm1hdGNoKC8oaVBob25lfGlQb2R8aVBhZHxBbmRyb2lkfEJsYWNrQmVycnl8V2luZG93cyBQaG9uZSkvKTsNCg0KICAgICAgICB2YXIgd2luZG93c0hlaWdodCA9ICQod2luZG93KS5oZWlnaHQoKTsNCiAgICAgICAgdmFyIGlzTW92aW5nID0gZmFsc2U7DQogICAgICAgIHZhciBpc1Jlc2l6aW5nID0gZmFsc2U7DQogICAgICAgIHZhciBsYXN0U2Nyb2xsZWREZXN0aW55Ow0KICAgICAgICB2YXIgbGFzdFNjcm9sbGVkU2xpZGU7DQoNCiAgICAgICAgJC5mbi5mdWxscGFnZS5zZXRBbGxvd1Njcm9sbGluZyh0cnVlKTsNCg0KICAgICAgICAvL2lmIGNzczMgaXMgbm90IHN1cHBvcnRlZCwgaXQgd2lsbCB1c2UgalF1ZXJ5IGFuaW1hdGlvbnMNCiAgICAgICAgaWYob3B0aW9ucy5jc3MzKXsNCiAgICAgICAgICAgIG9wdGlvbnMuY3NzMyA9IHN1cHBvcnQzZCgpOw0KICAgICAgICB9DQoNCiAgICAgICAgJCgnYm9keScpLndyYXBJbm5lcignPGRpdiBpZD0ic3VwZXJDb250YWluZXIiIC8+Jyk7DQoNCiAgICAgICAgLy9jcmVhdGluZyB0aGUgbmF2aWdhdGlvbiBkb3RzDQogICAgICAgIGlmIChvcHRpb25zLm5hdmlnYXRpb24pIHsNCiAgICAgICAgICAgICQoJ2JvZHknKS5hcHBlbmQoJzxkaXYgaWQ9ImZ1bGxQYWdlLW5hdiI+PHVsPjwvdWw+PC9kaXY+Jyk7DQogICAgICAgICAgICB2YXIgbmF2ID0gJCgnI2Z1bGxQYWdlLW5hdicpOw0KDQogICAgICAgICAgICBuYXYuY3NzKCdjb2xvcicsIG9wdGlvbnMubmF2aWdhdGlvbkNvbG9yKTsNCiAgICAgICAgICAgIG5hdi5hZGRDbGFzcyhvcHRpb25zLm5hdmlnYXRpb25Qb3NpdGlvbik7DQogICAgICAgIH0NCg0KICAgICAgICAkKCcuc2VjdGlvbicpLmVhY2goZnVuY3Rpb24oaW5kZXgpew0KICAgICAgICAgICAgdmFyIHNsaWRlcyA9ICQodGhpcykuZmluZCgnLnNsaWRlJyk7DQogICAgICAgICAgICB2YXIgbnVtU2xpZGVzID0gc2xpZGVzLmxlbmd0aDsNCg0KICAgICAgICAgICAgaWYgKGluZGV4ID09IG9wdGlvbnMuaW5pdGlhbFNsaWRlKXsNCiAgICAgICAgICAgICAgICAkKHRoaXMpLmFkZENsYXNzKCdhY3RpdmUnKTsNCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgJCh0aGlzKS5jc3MoJ2hlaWdodCcsIHdpbmRvd3NIZWlnaHQgKyAncHgnKTsNCg0KICAgICAgICAgICAgaWYob3B0aW9ucy5wYWRkaW5nVG9wIHx8IG9wdGlvbnMucGFkZGluZ0JvdHRvbSl7DQogICAgICAgICAgICAgICAgJCh0aGlzKS5jc3MoJ3BhZGRpbmcnLCBvcHRpb25zLnBhZGRpbmdUb3AgICsgJyAwICcgKyBvcHRpb25zLnBhZGRpbmdCb3R0b20gKyAnIDAnKTsNCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgaWYgKHR5cGVvZiBvcHRpb25zLnNsaWRlc0NvbG9yW2luZGV4XSAhPT0gICd1bmRlZmluZWQnKSB7DQogICAgICAgICAgICAgICAgJCh0aGlzKS5jc3MoJ2JhY2tncm91bmQtY29sb3InLCBvcHRpb25zLnNsaWRlc0NvbG9yW2luZGV4XSk7DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIGlmICh0eXBlb2Ygb3B0aW9ucy5hbmNob3JzW2luZGV4XSAhPT0gJ3VuZGVmaW5lZCcpIHsNCiAgICAgICAgICAgICAgICAkKHRoaXMpLmF0dHIoJ2RhdGEtYW5jaG9yJywgb3B0aW9ucy5hbmNob3JzW2luZGV4XSk7DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIGlmIChvcHRpb25zLm5hdmlnYXRpb24pIHsNCiAgICAgICAgICAgICAgICB2YXIgbGluayA9ICcnOw0KICAgICAgICAgICAgICAgIGlmKG9wdGlvbnMuYW5jaG9ycy5sZW5ndGgpew0KICAgICAgICAgICAgICAgICAgICBsaW5rID0gb3B0aW9ucy5hbmNob3JzW2luZGV4XTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgdmFyIHRvb2x0aXAgPSBvcHRpb25zLm5hdmlnYXRpb25Ub29sdGlwc1tpbmRleF07DQogICAgICAgICAgICAgICAgaWYodHlwZW9mIHRvb2x0aXAgPT09ICd1bmRlZmluZWQnKXsNCiAgICAgICAgICAgICAgICAgICAgdG9vbHRpcCA9ICcnOw0KICAgICAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgICAgIG5hdi5maW5kKCd1bCcpLmFwcGVuZCgnPGxpIGRhdGEtdG9vbHRpcD0iJyArIHRvb2x0aXAgKyAnIj48YSBocmVmPSIjJyArIGxpbmsgKyAnIj48c3Bhbj48L3NwYW4+PC9hPjwvbGk+Jyk7DQogICAgICAgICAgICB9DQoNCg0KICAgICAgICAgICAgLy8gaWYgdGhlcmUncyBhbnkgc2xpZGUNCiAgICAgICAgICAgIGlmIChudW1TbGlkZXMgPiAwKSB7DQogICAgICAgICAgICAgICAgdmFyIHNsaWRlcldpZHRoID0gbnVtU2xpZGVzICogMTAwOw0KICAgICAgICAgICAgICAgIHZhciBzbGlkZVdpZHRoID0gMTAwIC8gbnVtU2xpZGVzOw0KDQogICAgICAgICAgICAgICAgc2xpZGVzLndyYXBBbGwoJzxkaXYgY2xhc3M9InNsaWRlc0NvbnRhaW5lciIgLz4nKTsNCiAgICAgICAgICAgICAgICBzbGlkZXMucGFyZW50KCkud3JhcCgnPGRpdiBjbGFzcz0ic2xpZGVzIiAvPicpOw0KDQogICAgICAgICAgICAgICAgJCh0aGlzKS5maW5kKCcuc2xpZGVzQ29udGFpbmVyJykuY3NzKCd3aWR0aCcsIHNsaWRlcldpZHRoICsgJyUnKTsNCiAgICAgICAgICAgICAgICAkKHRoaXMpLmZpbmQoJy5zbGlkZXMnKS5hZnRlcignPGRpdiBjbGFzcz0iY29udHJvbEFycm93IHByZXYiPjwvZGl2PjxkaXYgY2xhc3M9ImNvbnRyb2xBcnJvdyBuZXh0Ij48L2Rpdj4nKTsNCg0KICAgICAgICAgICAgICAgIGlmKG9wdGlvbnMuY29udHJvbEFycm93Q29sb3IhPScjZmZmJyl7DQogICAgICAgICAgICAgICAgICAgICQodGhpcykuZmluZCgnLmNvbnRyb2xBcnJvdy5uZXh0JykuY3NzKCdib3JkZXItY29sb3InLCAndHJhbnNwYXJlbnQgdHJhbnNwYXJlbnQgdHJhbnNwYXJlbnQgJytvcHRpb25zLmNvbnRyb2xBcnJvd0NvbG9yKTsNCiAgICAgICAgICAgICAgICAgICAgJCh0aGlzKS5maW5kKCcuY29udHJvbEFycm93LnByZXYnKS5jc3MoJ2JvcmRlci1jb2xvcicsICd0cmFuc3BhcmVudCAnKyBvcHRpb25zLmNvbnRyb2xBcnJvd0NvbG9yICsgJyB0cmFuc3BhcmVudCB0cmFuc3BhcmVudCcpOw0KICAgICAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgICAgIGlmKCFvcHRpb25zLmxvb3BIb3Jpem9udGFsKXsNCiAgICAgICAgICAgICAgICAgICAgJCh0aGlzKS5maW5kKCcuY29udHJvbEFycm93LnByZXYnKS5oaWRlKCk7DQogICAgICAgICAgICAgICAgfQ0KDQoNCiAgICAgICAgICAgICAgICBpZihvcHRpb25zLnNsaWRlc05hdmlnYXRpb24pew0KICAgICAgICAgICAgICAgICAgICBhZGRTbGlkZXNOYXZpZ2F0aW9uKCQodGhpcyksIG51bVNsaWRlcyk7DQogICAgICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAgICAgc2xpZGVzLmVhY2goZnVuY3Rpb24oaW5kZXgpIHsNCiAgICAgICAgICAgICAgICAgICAgaWYoIWluZGV4KXsNCiAgICAgICAgICAgICAgICAgICAgICAgICQodGhpcykuYWRkQ2xhc3MoJ2FjdGl2ZScpOw0KICAgICAgICAgICAgICAgICAgICB9DQoNCiAgICAgICAgICAgICAgICAgICAgJCh0aGlzKS5jc3MoJ3dpZHRoJywgc2xpZGVXaWR0aCArICclJyk7DQoNCiAgICAgICAgICAgICAgICAgICAgaWYob3B0aW9ucy52ZXJ0aWNhbENlbnRlcmVkKXsNCiAgICAgICAgICAgICAgICAgICAgICAgIGFkZFRhYmxlQ2xhc3MoJCh0aGlzKSk7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9KTsNCiAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgIGlmKG9wdGlvbnMudmVydGljYWxDZW50ZXJlZCl7DQogICAgICAgICAgICAgICAgICAgIGFkZFRhYmxlQ2xhc3MoJCh0aGlzKSk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KDQoNCg0KDQogICAgICAgIH0pLnByb21pc2UoKS5kb25lKGZ1bmN0aW9uKCl7DQogICAgICAgICAgICAkLmZuLmZ1bGxwYWdlLnNldEF1dG9TY3JvbGxpbmcob3B0aW9ucy5hdXRvU2Nyb2xsaW5nKTsNCg0KICAgICAgICAgICAgJC5pc0Z1bmN0aW9uKCBvcHRpb25zLmFmdGVyUmVuZGVyICkgJiYgb3B0aW9ucy5hZnRlclJlbmRlci5jYWxsKCB0aGlzKTsNCg0KICAgICAgICAgICAgLy9maXhlZCBlbGVtZW50cyBuZWVkIHRvIGJlIG1vdmVkIG91dCBvZiB0aGUgcGx1Z2luIGNvbnRhaW5lciBkdWUgdG8gcHJvYmxlbXMgd2l0aCBDU1MzLg0KICAgICAgICAgICAgaWYob3B0aW9ucy5maXhlZEVsZW1lbnRzICYmIG9wdGlvbnMuY3NzMyl7DQogICAgICAgICAgICAgICAgJChvcHRpb25zLmZpeGVkRWxlbWVudHMpLmFwcGVuZFRvKCdib2R5Jyk7DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIC8vdmVydGljYWwgY2VudGVyZWQgb2YgdGhlIG5hdmlnYXRpb24gKyBmaXJzdCBidWxsZXQgYWN0aXZlDQogICAgICAgICAgICBpZihvcHRpb25zLm5hdmlnYXRpb24pew0KICAgICAgICAgICAgICAgIG5hdi5jc3MoJ21hcmdpbi10b3AnLCAnLScgKyAobmF2LmhlaWdodCgpLzIpICsgJ3B4Jyk7DQogICAgICAgICAgICAgICAgbmF2LmZpbmQoJ2xpJykuZmlyc3QoKS5maW5kKCdhJykuYWRkQ2xhc3MoJ2FjdGl2ZScpOw0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAvL21vdmluZyB0aGUgbWVudSBvdXRzaWRlIHRoZSBtYWluIGNvbnRhaW5lciAoYXZvaWQgcHJvYmxlbXMgd2l0aCBmaXhlZCBwb3NpdGlvbnMgd2hlbiB1c2luZyBDU1MzIHRyYW5mb3JtcykNCiAgICAgICAgICAgIGlmKG9wdGlvbnMubWVudSAmJiBvcHRpb25zLmNzczMpew0KICAgICAgICAgICAgICAgICQob3B0aW9ucy5tZW51KS5hcHBlbmRUbygnYm9keScpOw0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICBpZihvcHRpb25zLnNjcm9sbE92ZXJmbG93KXsNCiAgICAgICAgICAgICAgICAvL2FmdGVyIERPTSBhbmQgaW1hZ2VzIGFyZSBsb2FkZWQNCiAgICAgICAgICAgICAgICAkKHdpbmRvdykub24oJ2xvYWQnLCBmdW5jdGlvbigpIHsNCg0KICAgICAgICAgICAgICAgICAgICAkKCcuc2VjdGlvbicpLmVhY2goZnVuY3Rpb24oKXsNCiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBzbGlkZXMgPSAkKHRoaXMpLmZpbmQoJy5zbGlkZScpOw0KDQogICAgICAgICAgICAgICAgICAgICAgICBpZihzbGlkZXMubGVuZ3RoKXsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzbGlkZXMuZWFjaChmdW5jdGlvbigpew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjcmVhdGVTbGltU2Nyb2xsaW5nKCQodGhpcykpOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgY3JlYXRlU2xpbVNjcm9sbGluZygkKHRoaXMpKTsNCiAgICAgICAgICAgICAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgICAgICAgICB9KTsNCiAgICAgICAgICAgICAgICB9KTsNCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgaWYgKG9wdGlvbnMuaGFzaENoYW5nZSkgew0KICAgICAgICAgICAgICAgIC8vZ2V0dGluZyB0aGUgYW5jaG9yIGxpbmsgaW4gdGhlIFVSTCBhbmQgZGVsZXRpbmcgdGhlIGAjYA0KICAgICAgICAgICAgICAgIHZhciB2YWx1ZSA9ICB3aW5kb3cubG9jYXRpb24uaGFzaC5yZXBsYWNlKCcjJywgJycpLnNwbGl0KCcvJyk7DQogICAgICAgICAgICAgICAgdmFyIGRlc3RpbnkgPSB2YWx1ZVswXTsNCg0KICAgICAgICAgICAgICAgIGlmKGRlc3RpbnkubGVuZ3RoKXsNCiAgICAgICAgICAgICAgICAgICAgdmFyIHNlY3Rpb24gPSAkKCdbZGF0YS1hbmNob3I9IicrZGVzdGlueSsnIl0nKTsNCg0KICAgICAgICAgICAgICAgICAgICBpZighb3B0aW9ucy5hbmltYXRlQW5jaG9yICYmIHNlY3Rpb24ubGVuZ3RoKXsNCiAgICAgICAgICAgICAgICAgICAgICAgIHNpbGVudFNjcm9sbChzZWN0aW9uLnBvc2l0aW9uKCkudG9wKTsNCg0KICAgICAgICAgICAgICAgICAgICAgICAgLy91cGRhdGluZyB0aGUgYWN0aXZlIGNsYXNzDQogICAgICAgICAgICAgICAgICAgICAgICBzZWN0aW9uLmFkZENsYXNzKCdhY3RpdmUnKS5zaWJsaW5ncygpLnJlbW92ZUNsYXNzKCdhY3RpdmUnKTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgICAgICQod2luZG93KS5vbignbG9hZCcsIGZ1bmN0aW9uKCkgew0KICAgICAgICAgICAgICAgICAgICBzY3JvbGxUb0FuY2hvcigpOw0KICAgICAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9KTsNCg0KICAgICAgICB2YXIgc2Nyb2xsSWQ7DQogICAgICAgIHZhciBpc1Njcm9sbGluZyA9IGZhbHNlOw0KDQogICAgICAgIC8vd2hlbiBzY3JvbGxpbmcuLi4NCiAgICAgICAgJCh3aW5kb3cpLnNjcm9sbChmdW5jdGlvbihlKXsNCg0KICAgICAgICAgICAgaWYoIW9wdGlvbnMuYXV0b1Njcm9sbGluZyl7DQogICAgICAgICAgICAgICAgdmFyIGN1cnJlbnRTY3JvbGwgPSAkKHdpbmRvdykuc2Nyb2xsVG9wKCk7DQoNCiAgICAgICAgICAgICAgICB2YXIgc2Nyb2xsZWRTZWN0aW9ucyA9ICQoJy5zZWN0aW9uJykubWFwKGZ1bmN0aW9uKCl7DQogICAgICAgICAgICAgICAgICAgIGlmICgkKHRoaXMpLm9mZnNldCgpLnRvcCA8IChjdXJyZW50U2Nyb2xsICsgMTAwKSl7DQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJCh0aGlzKTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH0pOw0KDQogICAgICAgICAgICAgICAgLy9nZXRpbmcgdGhlIGxhc3Qgb25lLCB0aGUgY3VycmVudCBvbmUgb24gdGhlIHNjcmVlbg0KICAgICAgICAgICAgICAgIHZhciBjdXJyZW50U2VjdGlvbiA9IHNjcm9sbGVkU2VjdGlvbnNbc2Nyb2xsZWRTZWN0aW9ucy5sZW5ndGgtMV07DQoNCiAgICAgICAgICAgICAgICAvL2V4ZWN1dGluZyBvbmx5IG9uY2UgdGhlIGZpcnN0IHRpbWUgd2UgcmVhY2ggdGhlIHNlY3Rpb24NCiAgICAgICAgICAgICAgICBpZighY3VycmVudFNlY3Rpb24uaGFzQ2xhc3MoJ2FjdGl2ZScpKXsNCiAgICAgICAgICAgICAgICAgICAgaXNTY3JvbGxpbmcgPSB0cnVlOw0KDQogICAgICAgICAgICAgICAgICAgIHZhciB5TW92ZW1lbnQgPSBnZXRZbW92ZW1lbnQoY3VycmVudFNlY3Rpb24pOw0KDQogICAgICAgICAgICAgICAgICAgICQoJy5zZWN0aW9uLmFjdGl2ZScpLnJlbW92ZUNsYXNzKCdhY3RpdmUnKTsNCiAgICAgICAgICAgICAgICAgICAgY3VycmVudFNlY3Rpb24uYWRkQ2xhc3MoJ2FjdGl2ZScpOw0KDQogICAgICAgICAgICAgICAgICAgIHZhciBhbmNob3JMaW5rICA9IGN1cnJlbnRTZWN0aW9uLmRhdGEoJ2FuY2hvcicpOw0KICAgICAgICAgICAgICAgICAgICAkLmlzRnVuY3Rpb24oIG9wdGlvbnMub25MZWF2ZSApICYmIG9wdGlvbnMub25MZWF2ZS5jYWxsKCB0aGlzLCBjdXJyZW50U2VjdGlvbi5pbmRleCgnLnNlY3Rpb24nKSwgeU1vdmVtZW50KTsNCg0KICAgICAgICAgICAgICAgICAgICAkLmlzRnVuY3Rpb24oIG9wdGlvbnMuYWZ0ZXJMb2FkICkgJiYgb3B0aW9ucy5hZnRlckxvYWQuY2FsbCggdGhpcywgYW5jaG9yTGluaywgKGN1cnJlbnRTZWN0aW9uLmluZGV4KCcuc2VjdGlvbicpICsgMSkpOw0KDQogICAgICAgICAgICAgICAgICAgIGFjdGl2YXRlTWVudUVsZW1lbnQoYW5jaG9yTGluayk7DQogICAgICAgICAgICAgICAgICAgIGFjdGl2YXRlTmF2RG90cyhhbmNob3JMaW5rLCAwKTsNCg0KDQogICAgICAgICAgICAgICAgICAgIGlmKG9wdGlvbnMuYW5jaG9ycy5sZW5ndGggJiYgIWlzTW92aW5nICYmIG9wdGlvbnMuaGFzaENoYW5nZSl7DQogICAgICAgICAgICAgICAgICAgICAgICAvL25lZWRlZCB0byBlbnRlciBpbiBoYXNoQ2hhbmdlIGV2ZW50IHdoZW4gdXNpbmcgdGhlIG1lbnUgd2l0aCBhbmNob3IgbGlua3MNCiAgICAgICAgICAgICAgICAgICAgICAgIGxhc3RTY3JvbGxlZERlc3RpbnkgPSBhbmNob3JMaW5rOw0KDQogICAgICAgICAgICAgICAgICAgICAgICBsb2NhdGlvbi5oYXNoID0gYW5jaG9yTGluazsNCiAgICAgICAgICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAgICAgICAgIC8vc21hbGwgdGltZW91dCBpbiBvcmRlciB0byBhdm9pZCBlbnRlcmluZyBpbiBoYXNoQ2hhbmdlIGV2ZW50IHdoZW4gc2Nyb2xsaW5nIGlzIG5vdCBmaW5pc2hlZCB5ZXQNCiAgICAgICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHNjcm9sbElkKTsNCiAgICAgICAgICAgICAgICAgICAgc2Nyb2xsSWQgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCl7DQogICAgICAgICAgICAgICAgICAgICAgICBpc1Njcm9sbGluZyA9IGZhbHNlOw0KICAgICAgICAgICAgICAgICAgICB9LCAxMDApOw0KICAgICAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgfQ0KICAgICAgICB9KTsNCg0KDQoNCg0KICAgICAgICB2YXIgdG91Y2hTdGFydFkgPSAwOw0KICAgICAgICB2YXIgdG91Y2hTdGFydFggPSAwOw0KICAgICAgICB2YXIgdG91Y2hFbmRZID0gMDsNCiAgICAgICAgdmFyIHRvdWNoRW5kWCA9IDA7DQoNCiAgICAgICAgLyogRGV0ZWN0aW5nIHRvdWNoIGV2ZW50cw0KDQogICAgICAgICogQXMgd2UgYXJlIGNoYW5naW5nIHRoZSB0b3AgcHJvcGVydHkgb2YgdGhlIHBhZ2Ugb24gc2Nyb2xsaW5nLCB3ZSBjYW4gbm90IHVzZSB0aGUgdHJhZGl0aW9uYWwgd2F5IHRvIGRldGVjdCBpdC4NCiAgICAgICAgKiBUaGlzIHdheSwgdGhlIHRvdWNoc3RhcnQgYW5kIHRoZSB0b3VjaCBtb3ZlcyBzaG93cyBhbiBzbWFsbCBkaWZmZXJlbmNlIGJldHdlZW4gdGhlbSB3aGljaCBpcyB0aGUNCiAgICAgICAgKiB1c2VkIG9uZSB0byBkZXRlcm1pbmUgdGhlIGRpcmVjdGlvbi4NCiAgICAgICAgKi8NCiAgICAgICAgZnVuY3Rpb24gdG91Y2hNb3ZlSGFuZGxlcihldmVudCl7DQoNCiAgICAgICAgICAgIGlmKG9wdGlvbnMuYXV0b1Njcm9sbGluZyl7DQogICAgICAgICAgICAgICAgLy9wcmV2ZW50aW5nIHRoZSBlYXNpbmcgb24gaU9TIGRldmljZXMNCiAgICAgICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOw0KDQogICAgICAgICAgICAgICAgdmFyIGUgPSBldmVudC5vcmlnaW5hbEV2ZW50Ow0KDQogICAgICAgICAgICAgICAgdmFyIHRvdWNoTW92ZWQgPSBmYWxzZTsNCiAgICAgICAgICAgICAgICB2YXIgYWN0aXZlU2VjdGlvbiA9ICQoJy5zZWN0aW9uLmFjdGl2ZScpOw0KICAgICAgICAgICAgICAgIHZhciBzY3JvbGxhYmxlOw0KDQogICAgICAgICAgICAgICAgaWYgKCFpc01vdmluZyAmJiAhc2xpZGVNb3ZpbmcpIHsgLy9pZiB0aGVyZXMgYW55ICMNCiAgICAgICAgICAgICAgICAgICAgdmFyIHRvdWNoRXZlbnRzID0gZ2V0RXZlbnRzUGFnZShlKTsNCiAgICAgICAgICAgICAgICAgICAgdG91Y2hFbmRZID0gdG91Y2hFdmVudHNbJ3knXTsNCiAgICAgICAgICAgICAgICAgICAgdG91Y2hFbmRYID0gdG91Y2hFdmVudHNbJ3gnXTsNCg0KICAgICAgICAgICAgICAgICAgICAvL2lmIG1vdmVtZW50IGluIHRoZSBYIGF4eXMgaXMgZ3JlYXRlciB0aGFuIGluIHRoZSBZIGFuZCB0aGUgY3VycmVjdCBzZWN0aW9uIGhhcyBzbGlkZXMuLi4NCiAgICAgICAgICAgICAgICAgICAgaWYgKGFjdGl2ZVNlY3Rpb24uZmluZCgnLnNsaWRlcycpLmxlbmd0aCAmJiBNYXRoLmFicyh0b3VjaFN0YXJ0WCAtIHRvdWNoRW5kWCkgPiAoTWF0aC5hYnModG91Y2hTdGFydFkgLSB0b3VjaEVuZFkpKSkgew0KDQogICAgICAgICAgICAgICAgICAgICAgICAvL2lzIHRoZSBtb3ZlbWVudCBncmVhdGVyIHRoYW4gdGhlIG1pbmltdW0gcmVzaXN0YW5jZSB0byBzY3JvbGw/DQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnModG91Y2hTdGFydFggLSB0b3VjaEVuZFgpID4gKCQod2luZG93KS53aWR0aCgpIC8gMTAwICogb3B0aW9ucy50b3VjaFNlbnNpdGl2aXR5KSkgew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0b3VjaFN0YXJ0WCA+IHRvdWNoRW5kWCkgew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWN0aXZlU2VjdGlvbi5maW5kKCcuY29udHJvbEFycm93Lm5leHQ6dmlzaWJsZScpLnRyaWdnZXIoJ2NsaWNrJyk7DQoNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhY3RpdmVTZWN0aW9uLmZpbmQoJy5jb250cm9sQXJyb3cucHJldjp2aXNpYmxlJykudHJpZ2dlcignY2xpY2snKTsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgICAgICAgICAvL3ZlcnRpY2FsIHNjcm9sbGluZw0KICAgICAgICAgICAgICAgICAgICBlbHNlew0KICAgICAgICAgICAgICAgICAgICAgICAgLy9pZiB0aGVyZSBhcmUgbGFuZHNjYXBlIHNsaWRlcywgd2UgY2hlY2sgaWYgdGhlIHNjcm9sbGluZyBiYXIgaXMgaW4gdGhlIGN1cnJlbnQgb25lIG9yIG5vdA0KICAgICAgICAgICAgICAgICAgICAgICAgaWYoYWN0aXZlU2VjdGlvbi5maW5kKCcuc2xpZGVzJykubGVuZ3RoKXsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY3JvbGxhYmxlPSBhY3RpdmVTZWN0aW9uLmZpbmQoJy5zbGlkZS5hY3RpdmUnKS5maW5kKCcuc2Nyb2xsYWJsZScpOw0KICAgICAgICAgICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2Nyb2xsYWJsZSA9IGFjdGl2ZVNlY3Rpb24uZmluZCgnLnNjcm9sbGFibGUnKTsNCiAgICAgICAgICAgICAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgICAgICAgICAgICAgLy9pcyB0aGUgbW92ZW1lbnQgZ3JlYXRlciB0aGFuIHRoZSBtaW5pbXVtIHJlc2lzdGFuY2UgdG8gc2Nyb2xsPw0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKE1hdGguYWJzKHRvdWNoU3RhcnRZIC0gdG91Y2hFbmRZKSA+ICgkKHdpbmRvdykuaGVpZ2h0KCkgLyAxMDAgKiBvcHRpb25zLnRvdWNoU2Vuc2l0aXZpdHkpKSB7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRvdWNoU3RhcnRZID4gdG91Y2hFbmRZKSB7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKHNjcm9sbGFibGUubGVuZ3RoID4gMCApew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy9pcyB0aGUgc2Nyb2xsYmFyIGF0IHRoZSBlbmQgb2YgdGhlIHNjcm9sbD8NCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKGlzU2Nyb2xsZWQoJ2JvdHRvbScsIHNjcm9sbGFibGUpKXsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkLmZuLmZ1bGxwYWdlLm1vdmVTZWN0aW9uRG93bigpOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gbW92ZWQgZG93bg0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJC5mbi5mdWxscGFnZS5tb3ZlU2VjdGlvbkRvd24oKTsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodG91Y2hFbmRZID4gdG91Y2hTdGFydFkpIHsNCg0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihzY3JvbGxhYmxlLmxlbmd0aCA+IDApew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy9pcyB0aGUgc2Nyb2xsYmFyIGF0IHRoZSBzdGFydCBvZiB0aGUgc2Nyb2xsPw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoaXNTY3JvbGxlZCgndG9wJywgc2Nyb2xsYWJsZSkpew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICQuZm4uZnVsbHBhZ2UubW92ZVNlY3Rpb25VcCgpOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZXsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBtb3ZlZCB1cA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJC5mbi5mdWxscGFnZS5tb3ZlU2VjdGlvblVwKCk7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9DQogICAgICAgIH0NCg0KICAgICAgICBmdW5jdGlvbiB0b3VjaFN0YXJ0SGFuZGxlcihldmVudCl7DQoNCiAgICAgICAgICAgIGlmKG9wdGlvbnMuYXV0b1Njcm9sbGluZyl7DQogICAgICAgICAgICAgICAgdmFyIGUgPSBldmVudC5vcmlnaW5hbEV2ZW50Ow0KICAgICAgICAgICAgICAgIHZhciB0b3VjaEV2ZW50cyA9IGdldEV2ZW50c1BhZ2UoZSk7DQogICAgICAgICAgICAgICAgdG91Y2hTdGFydFkgPSB0b3VjaEV2ZW50c1sneSddOw0KICAgICAgICAgICAgICAgIHRvdWNoU3RhcnRYID0gdG91Y2hFdmVudHNbJ3gnXTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KDQoNCg0KICAgICAgICAvKioNCiAgICAgICAgICogRGV0ZWN0aW5nIG1vdXNld2hlZWwgc2Nyb2xsaW5nDQogICAgICAgICAqDQogICAgICAgICAqIGh0dHA6Ly9ibG9ncy5zaXRlcG9pbnRzdGF0aWMuY29tL2V4YW1wbGVzL3RlY2gvbW91c2Utd2hlZWwvaW5kZXguaHRtbA0KICAgICAgICAgKiBodHRwOi8vd3d3LnNpdGVwb2ludC5jb20vaHRtbDUtamF2YXNjcmlwdC1tb3VzZS13aGVlbC8NCiAgICAgICAgICovDQogICAgICAgIGZ1bmN0aW9uIE1vdXNlV2hlZWxIYW5kbGVyKGUpIHsNCiAgICAgICAgICAgIGlmKG9wdGlvbnMuYXV0b1Njcm9sbGluZyl7DQogICAgICAgICAgICAgICAgLy8gY3Jvc3MtYnJvd3NlciB3aGVlbCBkZWx0YQ0KICAgICAgICAgICAgICAgIGUgPSB3aW5kb3cuZXZlbnQgfHwgZTsNCiAgICAgICAgICAgICAgICB2YXIgZGVsdGEgPSBNYXRoLm1heCgtMSwgTWF0aC5taW4oMSwNCiAgICAgICAgICAgICAgICAgICAgICAgIChlLndoZWVsRGVsdGEgfHwgLWUuZGV0YWlsKSkpOw0KICAgICAgICAgICAgICAgIHZhciBzY3JvbGxhYmxlOw0KICAgICAgICAgICAgICAgIHZhciBhY3RpdmVTZWN0aW9uID0gJCgnLnNlY3Rpb24uYWN0aXZlJyk7DQoNCiAgICAgICAgICAgICAgICBpZiAoIWlzTW92aW5nKSB7IC8vaWYgdGhlcmVzIGFueSAjDQoNCiAgICAgICAgICAgICAgICAgICAgLy9pZiB0aGVyZSBhcmUgbGFuZHNjYXBlIHNsaWRlcywgd2UgY2hlY2sgaWYgdGhlIHNjcm9sbGluZyBiYXIgaXMgaW4gdGhlIGN1cnJlbnQgb25lIG9yIG5vdA0KICAgICAgICAgICAgICAgICAgICBpZihhY3RpdmVTZWN0aW9uLmZpbmQoJy5zbGlkZXMnKS5sZW5ndGgpew0KICAgICAgICAgICAgICAgICAgICAgICAgc2Nyb2xsYWJsZT0gYWN0aXZlU2VjdGlvbi5maW5kKCcuc2xpZGUuYWN0aXZlJykuZmluZCgnLnNjcm9sbGFibGUnKTsNCiAgICAgICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgICAgICBzY3JvbGxhYmxlID0gYWN0aXZlU2VjdGlvbi5maW5kKCcuc2Nyb2xsYWJsZScpOw0KICAgICAgICAgICAgICAgICAgICB9DQoNCiAgICAgICAgICAgICAgICAgICAgLy9zY3JvbGxpbmcgZG93bj8NCiAgICAgICAgICAgICAgICAgICAgaWYgKGRlbHRhIDwgMCkgew0KICAgICAgICAgICAgICAgICAgICAgICAgaWYoc2Nyb2xsYWJsZS5sZW5ndGggPiAwICl7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy9pcyB0aGUgc2Nyb2xsYmFyIGF0IHRoZSBlbmQgb2YgdGhlIHNjcm9sbD8NCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihpc1Njcm9sbGVkKCdib3R0b20nLCBzY3JvbGxhYmxlKSl7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICQuZm4uZnVsbHBhZ2UubW92ZVNlY3Rpb25Eb3duKCk7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOyAvL25vcm1hbCBzY3JvbGwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkLmZuLmZ1bGxwYWdlLm1vdmVTZWN0aW9uRG93bigpOw0KICAgICAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICB9DQoNCiAgICAgICAgICAgICAgICAgICAgLy9zY3JvbGxpbmcgdXA/DQogICAgICAgICAgICAgICAgICAgIGVsc2Ugew0KICAgICAgICAgICAgICAgICAgICAgICAgaWYoc2Nyb2xsYWJsZS5sZW5ndGggPiAwKXsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvL2lzIHRoZSBzY3JvbGxiYXIgYXQgdGhlIHN0YXJ0IG9mIHRoZSBzY3JvbGw/DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoaXNTY3JvbGxlZCgndG9wJywgc2Nyb2xsYWJsZSkpew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkLmZuLmZ1bGxwYWdlLm1vdmVTZWN0aW9uVXAoKTsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7IC8vbm9ybWFsIHNjcm9sbA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICQuZm4uZnVsbHBhZ2UubW92ZVNlY3Rpb25VcCgpOw0KICAgICAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQoNCg0KICAgICAgICAkLmZuLmZ1bGxwYWdlLm1vdmVTZWN0aW9uVXAgPSBmdW5jdGlvbigpew0KICAgICAgICAgICAgdmFyIHByZXYgPSAkKCcuc2VjdGlvbi5hY3RpdmUnKS5wcmV2KCcuc2VjdGlvbicpOw0KDQogICAgICAgICAgICAvL2xvb3BpbmcgdG8gdGhlIGJvdHRvbSBpZiB0aGVyZSdzIG5vIG1vcmUgc2VjdGlvbnMgYWJvdmUNCiAgICAgICAgICAgIGlmICghcHJldi5sZW5ndGggJiYgKG9wdGlvbnMubG9vcFRvcCB8fCBvcHRpb25zLmNvbnRpbnVvdXNWZXJ0aWNhbCkpIHsNCiAgICAgICAgICAgICAgICBwcmV2ID0gJCgnLnNlY3Rpb24nKS5sYXN0KCk7DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIGlmIChwcmV2Lmxlbmd0aCkgew0KICAgICAgICAgICAgICAgIHNjcm9sbFBhZ2UocHJldiwgbnVsbCwgdHJ1ZSk7DQogICAgICAgICAgICB9DQogICAgICAgIH07DQoNCiAgICAgICAgJC5mbi5mdWxscGFnZS5tb3ZlU2VjdGlvbkRvd24gPSBmdW5jdGlvbiAoKXsNCiAgICAgICAgICAgIHZhciBuZXh0ID0gJCgnLnNlY3Rpb24uYWN0aXZlJykubmV4dCgnLnNlY3Rpb24nKTsNCg0KICAgICAgICAgICAgLy9sb29waW5nIHRvIHRoZSB0b3AgaWYgdGhlcmUncyBubyBtb3JlIHNlY3Rpb25zIGJlbG93DQogICAgICAgICAgICBpZighbmV4dC5sZW5ndGggJiYNCiAgICAgICAgICAgICAgICAob3B0aW9ucy5sb29wQm90dG9tIHx8IG9wdGlvbnMuY29udGludW91c1ZlcnRpY2FsKSl7DQogICAgICAgICAgICAgICAgbmV4dCA9ICQoJy5zZWN0aW9uJykuZmlyc3QoKTsNCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgaWYobmV4dC5sZW5ndGggPiAwIHx8DQogICAgICAgICAgICAgICAgKCFuZXh0Lmxlbmd0aCAmJg0KICAgICAgICAgICAgICAgIChvcHRpb25zLmxvb3BCb3R0b20gfHwgb3B0aW9ucy5jb250aW51b3VzVmVydGljYWwpKSl7DQogICAgICAgICAgICAgICAgc2Nyb2xsUGFnZShuZXh0LCBudWxsLCBmYWxzZSk7DQogICAgICAgICAgICB9DQogICAgICAgIH07DQoNCiAgICAgICAgJC5mbi5mdWxscGFnZS5tb3ZlVG8gPSBmdW5jdGlvbiAoc2VjdGlvbiwgc2xpZGUpew0KICAgICAgICAgICAgdmFyIGRlc3RpbnkgPSAnJzsNCg0KICAgICAgICAgICAgaWYoaXNOYU4oc2VjdGlvbikpew0KICAgICAgICAgICAgICAgIGRlc3RpbnkgPSAkKCdbZGF0YS1hbmNob3I9Iicrc2VjdGlvbisnIl0nKTsNCiAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgIGRlc3RpbnkgPSAkKCcuc2VjdGlvbicpLmVxKCAoc2VjdGlvbiAtMSkgKTsNCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgaWYgKHNsaWRlICE9PSAndW5kZWZpbmVkJyl7DQogICAgICAgICAgICAgICAgc2Nyb2xsUGFnZUFuZFNsaWRlKHNlY3Rpb24sIHNsaWRlKTsNCiAgICAgICAgICAgIH1lbHNlIGlmKGRlc3RpbnkubGVuZ3RoID4gMCl7DQogICAgICAgICAgICAgICAgc2Nyb2xsUGFnZShkZXN0aW55KTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfTsNCg0KICAgICAgICBmdW5jdGlvbiBzY3JvbGxQYWdlKGVsZW1lbnQsIGNhbGxiYWNrLCBpc01vdmVtZW50VXApew0KICAgICAgICAgICAgdmFyIHNjcm9sbE9wdGlvbnMgPSB7fSwgc2Nyb2xsZWRFbGVtZW50Ow0KICAgICAgICAgICAgdmFyIGRlc3QgPSBlbGVtZW50LnBvc2l0aW9uKCk7DQogICAgICAgICAgICBpZih0eXBlb2YgZGVzdCA9PT0gInVuZGVmaW5lZCIpeyByZXR1cm47IH0gLy90aGVyZSdzIG5vIGVsZW1lbnQgdG8gc2Nyb2xsLCBsZWF2aW5nIHRoZSBmdW5jdGlvbg0KICAgICAgICAgICAgdmFyIGR0b3AgPSBkZXN0LnRvcDsNCiAgICAgICAgICAgIHZhciB5TW92ZW1lbnQgPSBnZXRZbW92ZW1lbnQoZWxlbWVudCk7DQogICAgICAgICAgICB2YXIgYW5jaG9yTGluayAgPSBlbGVtZW50LmRhdGEoJ2FuY2hvcicpOw0KICAgICAgICAgICAgdmFyIHNlY3Rpb25JbmRleCA9IGVsZW1lbnQuaW5kZXgoJy5zZWN0aW9uJyk7DQogICAgICAgICAgICB2YXIgYWN0aXZlU2xpZGUgPSBlbGVtZW50LmZpbmQoJy5zbGlkZS5hY3RpdmUnKTsNCiAgICAgICAgICAgIHZhciBhY3RpdmVTZWN0aW9uID0gJCgnLnNlY3Rpb24uYWN0aXZlJyk7DQoNCiAgICAgICAgICAgIGlmKGFjdGl2ZVNsaWRlLmxlbmd0aCl7DQogICAgICAgICAgICAgICAgdmFyIHNsaWRlQW5jaG9yTGluayA9IGFjdGl2ZVNsaWRlLmRhdGEoJ2FuY2hvcicpOw0KICAgICAgICAgICAgICAgIHZhciBzbGlkZUluZGV4ID0gYWN0aXZlU2xpZGUuaW5kZXgoKTsNCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgLy8gSWYgY29udGludW91c1ZlcnRpY2FsICYmIHdlIG5lZWQgdG8gd3JhcCBhcm91bmQNCiAgICAgICAgICAgIGlmIChvcHRpb25zLmF1dG9TY3JvbGxpbmcgJiYgb3B0aW9ucy5jb250aW51b3VzVmVydGljYWwgJiYgdHlwZW9mIChpc01vdmVtZW50VXApICE9PSAidW5kZWZpbmVkIiAmJg0KICAgICAgICAgICAgICAgICgoIWlzTW92ZW1lbnRVcCAmJiB5TW92ZW1lbnQgPT0gJ3VwJykgfHwgLy8gSW50ZW5kaW5nIHRvIHNjcm9sbCBkb3duIGJ1dCBhYm91dCB0byBnbyB1cCBvcg0KICAgICAgICAgICAgICAgIChpc01vdmVtZW50VXAgJiYgeU1vdmVtZW50ID09ICdkb3duJykpKSB7IC8vIGludGVuZGluZyB0byBzY3JvbGwgdXAgYnV0IGFib3V0IHRvIGdvIGRvd24NCg0KICAgICAgICAgICAgICAgIC8vIFNjcm9sbGluZyBkb3duDQogICAgICAgICAgICAgICAgaWYgKCFpc01vdmVtZW50VXApIHsNCiAgICAgICAgICAgICAgICAgICAgLy8gTW92ZSBhbGwgcHJldmlvdXMgc2VjdGlvbnMgdG8gYWZ0ZXIgdGhlIGFjdGl2ZSBzZWN0aW9uDQogICAgICAgICAgICAgICAgICAgICQoIi5zZWN0aW9uLmFjdGl2ZSIpLmFmdGVyKGFjdGl2ZVNlY3Rpb24ucHJldkFsbCgiLnNlY3Rpb24iKS5nZXQoKS5yZXZlcnNlKCkpOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICBlbHNlIHsgLy8gU2Nyb2xsaW5nIHVwDQogICAgICAgICAgICAgICAgICAgIC8vIE1vdmUgYWxsIG5leHQgc2VjdGlvbnMgdG8gYmVmb3JlIHRoZSBhY3RpdmUgc2VjdGlvbg0KICAgICAgICAgICAgICAgICAgICAkKCIuc2VjdGlvbi5hY3RpdmUiKS5iZWZvcmUoYWN0aXZlU2VjdGlvbi5uZXh0QWxsKCIuc2VjdGlvbiIpKTsNCiAgICAgICAgICAgICAgICB9DQoNCiAgICAgICAgICAgICAgICAvLyBNYWludGFpbiB0aGUgZGlzcGxheWVkIHBvc2l0aW9uIChub3cgdGhhdCB3ZSBjaGFuZ2VkIHRoZSBlbGVtZW50IG9yZGVyKQ0KICAgICAgICAgICAgICAgIHNpbGVudFNjcm9sbCgkKCcuc2VjdGlvbi5hY3RpdmUnKS5wb3NpdGlvbigpLnRvcCk7DQoNCiAgICAgICAgICAgICAgICAvLyBzYXZlIGZvciBsYXRlciB0aGUgZWxlbWVudHMgdGhhdCBzdGlsbCBuZWVkIHRvIGJlIHJlb3JkZXJlZA0KICAgICAgICAgICAgICAgIHZhciB3cmFwQXJvdW5kRWxlbWVudHMgPSBhY3RpdmVTZWN0aW9uOw0KDQogICAgICAgICAgICAgICAgLy8gUmVjYWxjdWxhdGUgYW5pbWF0aW9uIHZhcmlhYmxlcw0KICAgICAgICAgICAgICAgIGRlc3QgPSBlbGVtZW50LnBvc2l0aW9uKCk7DQogICAgICAgICAgICAgICAgZHRvcCA9IGRlc3QudG9wOw0KICAgICAgICAgICAgICAgIHlNb3ZlbWVudCA9IGdldFltb3ZlbWVudChlbGVtZW50KTsNCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgdmFyIGxlYXZpbmdTZWN0aW9uID0gYWN0aXZlU2VjdGlvbi5pbmRleCgnLnNlY3Rpb24nKSArIDE7DQoNCiAgICAgICAgICAgIGVsZW1lbnQuYWRkQ2xhc3MoJ2FjdGl2ZScpLnNpYmxpbmdzKCkucmVtb3ZlQ2xhc3MoJ2FjdGl2ZScpOw0KDQogICAgICAgICAgICAvL3ByZXZlbnRpbmcgZnJvbSBhY3RpdmF0aW5nIHRoZSBNb3VzZVdoZWVsSGFuZGxlciBldmVudA0KICAgICAgICAgICAgLy9tb3JlIHRoYW4gb25jZSBpZiB0aGUgcGFnZSBpcyBzY3JvbGxpbmcNCiAgICAgICAgICAgIGlzTW92aW5nID0gdHJ1ZTsNCg0KICAgICAgICAgICAgaWYodHlwZW9mIGFuY2hvckxpbmsgIT09ICd1bmRlZmluZWQnKXsNCiAgICAgICAgICAgICAgICBzZXRVUkxIYXNoKHNsaWRlSW5kZXgsIHNsaWRlQW5jaG9yTGluaywgYW5jaG9yTGluayk7DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIGlmKG9wdGlvbnMuYXV0b1Njcm9sbGluZyl7DQogICAgICAgICAgICAgICAgc2Nyb2xsT3B0aW9uc1sndG9wJ10gPSAtZHRvcDsNCiAgICAgICAgICAgICAgICBzY3JvbGxlZEVsZW1lbnQgPSAnI3N1cGVyQ29udGFpbmVyJzsNCiAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgIHNjcm9sbE9wdGlvbnNbJ3Njcm9sbFRvcCddID0gZHRvcDsNCiAgICAgICAgICAgICAgICBzY3JvbGxlZEVsZW1lbnQgPSAnaHRtbCwgYm9keSc7DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIC8vIEZpeCBzZWN0aW9uIG9yZGVyIGFmdGVyIGNvbnRpbnVvdXNWZXJ0aWNhbCBjaGFuZ2VzIGhhdmUgYmVlbiBhbmltYXRlZA0KICAgICAgICAgICAgdmFyIGNvbnRpbnVvdXNWZXJ0aWNhbEZpeFNlY3Rpb25PcmRlciA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgICAgICAgICAvLyBJZiBjb250aW51b3VzVmVydGljYWwgaXMgaW4gZWZmZWN0IChhbmQgYXV0b1Njcm9sbGluZyB3b3VsZCBhbHNvIGJlIGluIGVmZmVjdCB0aGVuKSwNCiAgICAgICAgICAgICAgICAvLyBmaW5pc2ggbW92aW5nIHRoZSBlbGVtZW50cyBhcm91bmQgc28gdGhlIGRpcmVjdCBuYXZpZ2F0aW9uIHdpbGwgZnVuY3Rpb24gbW9yZSBzaW1wbHkNCiAgICAgICAgICAgICAgICBpZiAoIXdyYXBBcm91bmRFbGVtZW50cyB8fCAhd3JhcEFyb3VuZEVsZW1lbnRzLmxlbmd0aCkgew0KICAgICAgICAgICAgICAgICAgICByZXR1cm47DQogICAgICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAgICAgaWYgKGlzTW92ZW1lbnRVcCkgew0KICAgICAgICAgICAgICAgICAgICAkKCcuc2VjdGlvbjpmaXJzdCcpLmJlZm9yZSh3cmFwQXJvdW5kRWxlbWVudHMpOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICBlbHNlIHsNCiAgICAgICAgICAgICAgICAgICAgJCgnLnNlY3Rpb246bGFzdCcpLmFmdGVyKHdyYXBBcm91bmRFbGVtZW50cyk7DQogICAgICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAgICAgc2lsZW50U2Nyb2xsKCQoJy5zZWN0aW9uLmFjdGl2ZScpLnBvc2l0aW9uKCkudG9wKTsNCiAgICAgICAgICAgIH07DQoNCg0KICAgICAgICAgICAgLy8gVXNlIENTUzMgdHJhbnNsYXRlIGZ1bmN0aW9uYWxpdHkgb3IuLi4NCiAgICAgICAgICAgIGlmIChvcHRpb25zLmNzczMgJiYgb3B0aW9ucy5hdXRvU2Nyb2xsaW5nKSB7DQogICAgICAgICAgICAgICAgLy9jYWxsYmFjayAob25MZWF2ZSkNCiAgICAgICAgICAgICAgICAkLmlzRnVuY3Rpb24ob3B0aW9ucy5vbkxlYXZlKSAmJiBvcHRpb25zLm9uTGVhdmUuY2FsbCh0aGlzLCBsZWF2aW5nU2VjdGlvbiwgeU1vdmVtZW50KTsNCg0KICAgICAgICAgICAgICAgIHZhciB0cmFuc2xhdGUzZCA9ICd0cmFuc2xhdGUzZCgwcHgsIC0nICsgZHRvcCArICdweCwgMHB4KSc7DQogICAgICAgICAgICAgICAgdHJhbnNmb3JtQ29udGFpbmVyKHRyYW5zbGF0ZTNkLCB0cnVlKTsNCg0KICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgew0KICAgICAgICAgICAgICAgICAgICAvL2ZpeCBzZWN0aW9uIG9yZGVyIGZyb20gY29udGludW91c1ZlcnRpY2FsDQogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVvdXNWZXJ0aWNhbEZpeFNlY3Rpb25PcmRlcigpOw0KDQogICAgICAgICAgICAgICAgICAgIC8vY2FsbGJhY2sgKGFmdGVyTG9hZCkNCiAgICAgICAgICAgICAgICAgICAgJC5pc0Z1bmN0aW9uKG9wdGlvbnMuYWZ0ZXJMb2FkKSAmJiBvcHRpb25zLmFmdGVyTG9hZC5jYWxsKHRoaXMsIGFuY2hvckxpbmssIChzZWN0aW9uSW5kZXggKyAxKSk7DQoNCiAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7DQogICAgICAgICAgICAgICAgICAgICAgICBpc01vdmluZyA9IGZhbHNlOw0KICAgICAgICAgICAgICAgICAgICAgICAgJC5pc0Z1bmN0aW9uKGNhbGxiYWNrKSAmJiBjYWxsYmFjay5jYWxsKHRoaXMpOw0KICAgICAgICAgICAgICAgICAgICB9LCBzY3JvbGxEZWxheSk7DQogICAgICAgICAgICAgICAgfSwgb3B0aW9ucy5zY3JvbGxpbmdTcGVlZCk7DQogICAgICAgICAgICB9IGVsc2UgeyAvLyAuLi4gdXNlIGpRdWVyeSBhbmltYXRlDQogICAgICAgICAgICAgICAgJC5pc0Z1bmN0aW9uKG9wdGlvbnMub25MZWF2ZSkgJiYgb3B0aW9ucy5vbkxlYXZlLmNhbGwodGhpcywgbGVhdmluZ1NlY3Rpb24sIHlNb3ZlbWVudCk7DQoNCiAgICAgICAgICAgICAgICAkKHNjcm9sbGVkRWxlbWVudCkuYW5pbWF0ZSgNCiAgICAgICAgICAgICAgICAgICAgc2Nyb2xsT3B0aW9ucw0KICAgICAgICAgICAgICAgICwgb3B0aW9ucy5zY3JvbGxpbmdTcGVlZCwgb3B0aW9ucy5lYXNpbmcsIGZ1bmN0aW9uICgpIHsNCiAgICAgICAgICAgICAgICAgICAgLy9maXggc2VjdGlvbiBvcmRlciBmcm9tIGNvbnRpbnVvdXNWZXJ0aWNhbA0KICAgICAgICAgICAgICAgICAgICBjb250aW51b3VzVmVydGljYWxGaXhTZWN0aW9uT3JkZXIoKTsNCg0KICAgICAgICAgICAgICAgICAgICAvL2NhbGxiYWNrIChhZnRlckxvYWQpDQogICAgICAgICAgICAgICAgICAgICQuaXNGdW5jdGlvbihvcHRpb25zLmFmdGVyTG9hZCkgJiYgb3B0aW9ucy5hZnRlckxvYWQuY2FsbCh0aGlzLCBhbmNob3JMaW5rLCAoc2VjdGlvbkluZGV4ICsgMSkpOw0KDQogICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgew0KICAgICAgICAgICAgICAgICAgICAgICAgaXNNb3ZpbmcgPSBmYWxzZTsNCiAgICAgICAgICAgICAgICAgICAgICAgICQuaXNGdW5jdGlvbihjYWxsYmFjaykgJiYgY2FsbGJhY2suY2FsbCh0aGlzKTsNCiAgICAgICAgICAgICAgICAgICAgfSwgc2Nyb2xsRGVsYXkpOw0KICAgICAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAvL2ZsYWcgdG8gYXZvaWQgY2FsbGluZ24gYHNjcm9sbFBhZ2UoKWAgdHdpY2UgaW4gY2FzZSBvZiB1c2luZyBhbmNob3IgbGlua3MNCiAgICAgICAgICAgIGxhc3RTY3JvbGxlZERlc3RpbnkgPSBhbmNob3JMaW5rOw0KDQogICAgICAgICAgICAvL2F2b2lkIGZpcmluZyBpdCB0d2ljZSAoYXMgaXQgZG9lcyBhbHNvIG9uIHNjcm9sbCkNCiAgICAgICAgICAgIGlmKG9wdGlvbnMuYXV0b1Njcm9sbGluZyl7DQogICAgICAgICAgICAgICAgYWN0aXZhdGVNZW51RWxlbWVudChhbmNob3JMaW5rKTsNCiAgICAgICAgICAgICAgICBhY3RpdmF0ZU5hdkRvdHMoYW5jaG9yTGluaywgc2VjdGlvbkluZGV4KTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KDQogICAgICAgIGZ1bmN0aW9uIHNjcm9sbFRvQW5jaG9yKCl7DQogICAgICAgICAgICAvL2dldHRpbmcgdGhlIGFuY2hvciBsaW5rIGluIHRoZSBVUkwgYW5kIGRlbGV0aW5nIHRoZSBgI2ANCiAgICAgICAgICAgIHZhciB2YWx1ZSA9ICB3aW5kb3cubG9jYXRpb24uaGFzaC5yZXBsYWNlKCcjJywgJycpLnNwbGl0KCcvJyk7DQogICAgICAgICAgICB2YXIgc2VjdGlvbiA9IHZhbHVlWzBdOw0KICAgICAgICAgICAgdmFyIHNsaWRlID0gdmFsdWVbMV07DQoNCiAgICAgICAgICAgIGlmKHNlY3Rpb24peyAgLy9pZiB0aGVyZXMgYW55ICMNCiAgICAgICAgICAgICAgICBzY3JvbGxQYWdlQW5kU2xpZGUoc2VjdGlvbiwgc2xpZGUpOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQoNCiAgICAgICAgLy9kZXRlY3RpbmcgYW55IGNoYW5nZSBvbiB0aGUgVVJMIHRvIHNjcm9sbCB0byB0aGUgZ2l2ZW4gYW5jaG9yIGxpbmsNCiAgICAgICAgLy8oYSB3YXkgdG8gZGV0ZWN0IGJhY2sgaGlzdG9yeSBidXR0b24gYXMgd2UgcGxheSB3aXRoIHRoZSBoYXNoZXMgb24gdGhlIFVSTCkNCiAgICAgICAgaWYgKG9wdGlvbnMuaGFzaENoYW5nZSkgew0KICAgICAgICAgICAgJCh3aW5kb3cpLm9uKCdoYXNoY2hhbmdlJyxmdW5jdGlvbigpew0KICAgICAgICAgICAgICAgIGlmKCFpc1Njcm9sbGluZyl7DQogICAgICAgICAgICAgICAgICAgIHZhciB2YWx1ZSA9ICB3aW5kb3cubG9jYXRpb24uaGFzaC5yZXBsYWNlKCcjJywgJycpLnNwbGl0KCcvJyk7DQogICAgICAgICAgICAgICAgICAgIHZhciBzZWN0aW9uID0gdmFsdWVbMF07DQogICAgICAgICAgICAgICAgICAgIHZhciBzbGlkZSA9IHZhbHVlWzFdOw0KDQogICAgICAgICAgICAgICAgICAgIC8vd2hlbiBtb3ZpbmcgdG8gYSBzbGlkZSBpbiB0aGUgZmlyc3Qgc2VjdGlvbiBmb3IgdGhlIGZpcnN0IHRpbWUgKGZpcnN0IHRpbWUgdG8gYWRkIGFuIGFuY2hvciB0byB0aGUgVVJMKQ0KICAgICAgICAgICAgICAgICAgICB2YXIgaXNGaXJzdFNsaWRlTW92ZSA9ICAodHlwZW9mIGxhc3RTY3JvbGxlZERlc3RpbnkgPT09ICd1bmRlZmluZWQnKTsNCiAgICAgICAgICAgICAgICAgICAgdmFyIGlzRmlyc3RTY3JvbGxNb3ZlID0gKHR5cGVvZiBsYXN0U2Nyb2xsZWREZXN0aW55ID09PSAndW5kZWZpbmVkJyAmJiB0eXBlb2Ygc2xpZGUgPT09ICd1bmRlZmluZWQnKTsNCg0KICAgICAgICAgICAgICAgICAgICAvKmluIG9yZGVyIHRvIGNhbGwgc2Nyb2xscGFnZSgpIG9ubHkgb25jZSBmb3IgZWFjaCBkZXN0aW5hdGlvbiBhdCBhIHRpbWUNCiAgICAgICAgICAgICAgICAgICAgSXQgaXMgY2FsbGVkIHR3aWNlIGZvciBlYWNoIHNjcm9sbCBvdGhlcndpc2UsIGFzIGluIGNhc2Ugb2YgdXNpbmcgYW5jaG9ybGlua3MgYGhhc2hDaGFuZ2VgDQogICAgICAgICAgICAgICAgICAgIGV2ZW50IGlzIGZpcmVkIG9uIGV2ZXJ5IHNjcm9sbCB0b28uKi8NCiAgICAgICAgICAgICAgICAgICAgaWYgKChzZWN0aW9uICYmIHNlY3Rpb24gIT09IGxhc3RTY3JvbGxlZERlc3RpbnkpICYmICFpc0ZpcnN0U2xpZGVNb3ZlIHx8IGlzRmlyc3RTY3JvbGxNb3ZlIHx8ICghc2xpZGVNb3ZpbmcgJiYgbGFzdFNjcm9sbGVkU2xpZGUgIT0gc2xpZGUgKSkgIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIHNjcm9sbFBhZ2VBbmRTbGlkZShzZWN0aW9uLCBzbGlkZSk7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIH0pOw0KICAgICAgICB9DQoNCg0KICAgICAgICAvKioNCiAgICAgICAgICogU2xpZGluZyB3aXRoIGFycm93IGtleXMsIGJvdGgsIHZlcnRpY2FsIGFuZCBob3Jpem9udGFsDQogICAgICAgICAqLw0KICAgICAgICAkKGRvY3VtZW50KS5rZXlkb3duKGZ1bmN0aW9uKGUpIHsNCiAgICAgICAgICAgIC8vTW92aW5nIHRoZSBtYWluIHBhZ2Ugd2l0aCB0aGUga2V5Ym9hcmQgYXJyb3dzIGlmIGtleWJvYXJkIHNjcm9sbGluZyBpcyBlbmFibGVkDQogICAgICAgICAgICBpZiAob3B0aW9ucy5rZXlib2FyZFNjcm9sbGluZyAmJiAhaXNNb3ZpbmcpIHsNCiAgICAgICAgICAgICAgICBzd2l0Y2ggKGUud2hpY2gpIHsNCiAgICAgICAgICAgICAgICAvL3VwDQogICAgICAgICAgICAgICAgY2FzZSAzODoNCiAgICAgICAgICAgICAgICBjYXNlIDMzOg0KICAgICAgICAgICAgICAgICAgICAkLmZuLmZ1bGxwYWdlLm1vdmVTZWN0aW9uVXAoKTsNCiAgICAgICAgICAgICAgICAgICAgYnJlYWs7DQoNCiAgICAgICAgICAgICAgICAvL2Rvd24NCiAgICAgICAgICAgICAgICBjYXNlIDQwOg0KICAgICAgICAgICAgICAgIGNhc2UgMzQ6DQogICAgICAgICAgICAgICAgICAgICQuZm4uZnVsbHBhZ2UubW92ZVNlY3Rpb25Eb3duKCk7DQogICAgICAgICAgICAgICAgICAgIGJyZWFrOw0KDQogICAgICAgICAgICAgICAgLy9sZWZ0DQogICAgICAgICAgICAgICAgY2FzZSAzNzoNCiAgICAgICAgICAgICAgICAgICAgJCgnLnNlY3Rpb24uYWN0aXZlJykuZmluZCgnLmNvbnRyb2xBcnJvdy5wcmV2OnZpc2libGUnKS50cmlnZ2VyKCdjbGljaycpOw0KICAgICAgICAgICAgICAgICAgICBicmVhazsNCg0KICAgICAgICAgICAgICAgIC8vcmlnaHQNCiAgICAgICAgICAgICAgICBjYXNlIDM5Og0KICAgICAgICAgICAgICAgICAgICAkKCcuc2VjdGlvbi5hY3RpdmUnKS5maW5kKCcuY29udHJvbEFycm93Lm5leHQ6dmlzaWJsZScpLnRyaWdnZXIoJ2NsaWNrJyk7DQogICAgICAgICAgICAgICAgICAgIGJyZWFrOw0KDQogICAgICAgICAgICAgICAgZGVmYXVsdDoNCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOyAvLyBleGl0IHRoaXMgaGFuZGxlciBmb3Igb3RoZXIga2V5cw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0NCiAgICAgICAgfSk7DQoNCiAgICAgICAgLy9uYXZpZ2F0aW9uIGFjdGlvbg0KICAgICAgICAkKGRvY3VtZW50KS5vbignY2xpY2snLCAnI2Z1bGxQYWdlLW5hdiBhJywgZnVuY3Rpb24oZSl7DQogICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7DQogICAgICAgICAgICB2YXIgaW5kZXggPSAkKHRoaXMpLnBhcmVudCgpLmluZGV4KCk7DQogICAgICAgICAgICBzY3JvbGxQYWdlKCQoJy5zZWN0aW9uJykuZXEoaW5kZXgpKTsNCiAgICAgICAgfSk7DQoNCiAgICAgICAgLy9uYXZpZ2F0aW9uIHRvb2x0aXBzDQogICAgICAgICQoZG9jdW1lbnQpLm9uKHsNCiAgICAgICAgICAgIG1vdXNlZW50ZXI6IGZ1bmN0aW9uKCl7DQogICAgICAgICAgICAgICAgdmFyIHRvb2x0aXAgPSAkKHRoaXMpLmRhdGEoJ3Rvb2x0aXAnKTsNCiAgICAgICAgICAgICAgICAkKCc8ZGl2IGNsYXNzPSJmdWxsUGFnZS10b29sdGlwICcgKyBvcHRpb25zLm5hdmlnYXRpb25Qb3NpdGlvbiArJyI+JyArIHRvb2x0aXAgKyAnPC9kaXY+JykuaGlkZSgpLmFwcGVuZFRvKCQodGhpcykpLmZhZGVJbigyMDApOw0KICAgICAgICAgICAgfSwNCiAgICAgICAgICAgIG1vdXNlbGVhdmU6IGZ1bmN0aW9uKCl7DQogICAgICAgICAgICAgICAgJCh0aGlzKS5maW5kKCcuZnVsbFBhZ2UtdG9vbHRpcCcpLmZhZGVPdXQoKS5yZW1vdmUoKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfSwgJyNmdWxsUGFnZS1uYXYgbGknKTsNCg0KDQogICAgICAgIGlmKG9wdGlvbnMubm9ybWFsU2Nyb2xsRWxlbWVudHMpew0KICAgICAgICAgICAgJChkb2N1bWVudCkub24oJ21vdXNlb3ZlcicsIG9wdGlvbnMubm9ybWFsU2Nyb2xsRWxlbWVudHMsIGZ1bmN0aW9uICgpIHsNCiAgICAgICAgICAgICAgICAkLmZuLmZ1bGxwYWdlLnNldE1vdXNlV2hlZWxTY3JvbGxpbmcoZmFsc2UpOw0KICAgICAgICAgICAgfSk7DQoNCiAgICAgICAgICAgICQoZG9jdW1lbnQpLm9uKCdtb3VzZW91dCcsIG9wdGlvbnMubm9ybWFsU2Nyb2xsRWxlbWVudHMsIGZ1bmN0aW9uKCl7DQogICAgICAgICAgICAgICAgJC5mbi5mdWxscGFnZS5zZXRNb3VzZVdoZWVsU2Nyb2xsaW5nKHRydWUpOw0KICAgICAgICAgICAgfSk7DQogICAgICAgIH0NCg0KICAgICAgICAvKioNCiAgICAgICAgICogU2Nyb2xsaW5nIGhvcml6b250YWxseSB3aGVuIGNsaWNraW5nIG9uIHRoZSBzbGlkZXIgY29udHJvbHMuDQogICAgICAgICAqLw0KICAgICAgICAkKCcuc2VjdGlvbicpLm9uKCdjbGljaycsICcuY29udHJvbEFycm93JywgZnVuY3Rpb24oKSB7DQogICAgICAgICAgICAvL25vdCB0aGF0IGZhc3QgbXkgZnJpZW5kISA6KQ0KICAgICAgICAgICAgaWYgKHNsaWRlTW92aW5nKSB7DQogICAgICAgICAgICAgICAgcmV0dXJuOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgc2xpZGVNb3ZpbmcgPSB0cnVlOw0KDQogICAgICAgICAgICB2YXIgc2xpZGVzID0gJCh0aGlzKS5jbG9zZXN0KCcuc2VjdGlvbicpLmZpbmQoJy5zbGlkZXMnKTsNCiAgICAgICAgICAgIHZhciBjdXJyZW50U2xpZGUgPSBzbGlkZXMuZmluZCgnLnNsaWRlLmFjdGl2ZScpOw0KICAgICAgICAgICAgdmFyIGRlc3RpbnkgPSBudWxsOw0KDQogICAgICAgICAgICBpZiAoJCh0aGlzKS5oYXNDbGFzcygncHJldicpKSB7DQogICAgICAgICAgICAgICAgZGVzdGlueSA9IGN1cnJlbnRTbGlkZS5wcmV2KCcuc2xpZGUnKTsNCiAgICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICAgICAgZGVzdGlueSA9IGN1cnJlbnRTbGlkZS5uZXh0KCcuc2xpZGUnKTsNCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgLy9pcyB0aGVyZSBpc24ndCBhIG5leHQgc2xpZGUgaW4gdGhlIHNlY3VlbmNlPw0KICAgICAgICAgICAgaWYoIWRlc3RpbnkubGVuZ3RoKSB7DQogICAgICAgICAgICAgICAgLy90byB0aGUgbGFzdA0KICAgICAgICAgICAgICAgIGlmICgkKHRoaXMpLmhhc0NsYXNzKCdwcmV2JykpIHsNCiAgICAgICAgICAgICAgICAgICAgZGVzdGlueSA9IGN1cnJlbnRTbGlkZS5zaWJsaW5ncygnOmxhc3QnKTsNCiAgICAgICAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgICAgICAgICBkZXN0aW55ID0gY3VycmVudFNsaWRlLnNpYmxpbmdzKCc6Zmlyc3QnKTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIGxhbmRzY2FwZVNjcm9sbChzbGlkZXMsIGRlc3RpbnkpOw0KICAgICAgICB9KTsNCg0KDQogICAgICAgIC8qKg0KICAgICAgICAgKiBTY3JvbGxpbmcgaG9yaXpvbnRhbGx5IHdoZW4gY2xpY2tpbmcgb24gdGhlIHNsaWRlciBjb250cm9scy4NCiAgICAgICAgICovDQogICAgICAgICQoJy5zZWN0aW9uJykub24oJ2NsaWNrJywgJy50b1NsaWRlJywgZnVuY3Rpb24oZSkgew0KICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOw0KDQogICAgICAgICAgICB2YXIgc2xpZGVzID0gJCh0aGlzKS5jbG9zZXN0KCcuc2VjdGlvbicpLmZpbmQoJy5zbGlkZXMnKTsNCiAgICAgICAgICAgIHZhciBjdXJyZW50U2xpZGUgPSBzbGlkZXMuZmluZCgnLnNsaWRlLmFjdGl2ZScpOw0KICAgICAgICAgICAgdmFyIGRlc3RpbnkgPSBudWxsOw0KDQogICAgICAgICAgICBkZXN0aW55ID0gc2xpZGVzLmZpbmQoJy5zbGlkZScpLmVxKCAoJCh0aGlzKS5kYXRhKCdpbmRleCcpIC0xKSApOw0KDQogICAgICAgICAgICBpZihkZXN0aW55Lmxlbmd0aCA+IDApew0KICAgICAgICAgICAgICAgIGxhbmRzY2FwZVNjcm9sbChzbGlkZXMsIGRlc3RpbnkpOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9KTsNCg0KICAgICAgICAvKioNCiAgICAgICAgKiBTY3JvbGxzIGhvcml6b250YWwgc2xpZGVycy4NCiAgICAgICAgKi8NCiAgICAgICAgZnVuY3Rpb24gbGFuZHNjYXBlU2Nyb2xsKHNsaWRlcywgZGVzdGlueSl7DQogICAgICAgICAgICB2YXIgZGVzdGlueVBvcyA9IGRlc3RpbnkucG9zaXRpb24oKTsNCiAgICAgICAgICAgIHZhciBzbGlkZXNDb250YWluZXIgPSBzbGlkZXMuZmluZCgnLnNsaWRlc0NvbnRhaW5lcicpLnBhcmVudCgpOw0KICAgICAgICAgICAgdmFyIHNsaWRlSW5kZXggPSBkZXN0aW55LmluZGV4KCk7DQogICAgICAgICAgICB2YXIgc2VjdGlvbiA9IHNsaWRlcy5jbG9zZXN0KCcuc2VjdGlvbicpOw0KICAgICAgICAgICAgdmFyIHNlY3Rpb25JbmRleCA9IHNlY3Rpb24uaW5kZXgoJy5zZWN0aW9uJyk7DQogICAgICAgICAgICB2YXIgYW5jaG9yTGluayA9IHNlY3Rpb24uZGF0YSgnYW5jaG9yJyk7DQogICAgICAgICAgICB2YXIgc2xpZGVzTmF2ID0gc2VjdGlvbi5maW5kKCcuZnVsbFBhZ2Utc2xpZGVzTmF2Jyk7DQogICAgICAgICAgICB2YXIgc2xpZGVBbmNob3IgPSBkZXN0aW55LmRhdGEoJ2FuY2hvcicpOw0KDQogICAgICAgICAgICAvL2NhY2hpbmcgdGhlIHZhbHVlIG9mIGlzUmVzaXppbmcgYXQgdGhlIG1vbW1lbnQgdGhlIGZ1bmN0aW9uIGlzIGNhbGxlZA0KICAgICAgICAgICAgLy9iZWNhdXNlIGl0IHdpbGwgYmUgY2hlY2tlZCBsYXRlciBpbnNpZGUgYSBzZXRUaW1lb3V0IGFuZCB0aGUgdmFsdWUgbWlnaHQgY2hhbmdlDQogICAgICAgICAgICB2YXIgbG9jYWxJc1Jlc2l6aW5nID0gaXNSZXNpemluZzsNCg0KICAgICAgICAgICAgaWYob3B0aW9ucy5vblNsaWRlTGVhdmUpew0KICAgICAgICAgICAgICAgIHZhciBwcmV2U2xpZGVJbmRleCA9IHNlY3Rpb24uZmluZCgnLnNsaWRlLmFjdGl2ZScpLmluZGV4KCk7DQogICAgICAgICAgICAgICAgdmFyIHhNb3ZlbWVudCA9IGdldFhtb3ZlbWVudChwcmV2U2xpZGVJbmRleCwgc2xpZGVJbmRleCk7DQoNCiAgICAgICAgICAgICAgICAvL2lmIHRoZSBzaXRlIGlzIG5vdCBqdXN0IHJlc2l6aW5nIGFuZCByZWFkanVzdGluZyB0aGUgc2xpZGVzDQogICAgICAgICAgICAgICAgaWYoIWxvY2FsSXNSZXNpemluZyl7DQogICAgICAgICAgICAgICAgICAgICQuaXNGdW5jdGlvbiggb3B0aW9ucy5vblNsaWRlTGVhdmUgKSAmJiBvcHRpb25zLm9uU2xpZGVMZWF2ZS5jYWxsKCB0aGlzLCBhbmNob3JMaW5rLCAoc2VjdGlvbkluZGV4ICsgMSksIHByZXZTbGlkZUluZGV4LCB4TW92ZW1lbnQpOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgZGVzdGlueS5hZGRDbGFzcygnYWN0aXZlJykuc2libGluZ3MoKS5yZW1vdmVDbGFzcygnYWN0aXZlJyk7DQoNCg0KICAgICAgICAgICAgaWYodHlwZW9mIHNsaWRlQW5jaG9yID09PSAndW5kZWZpbmVkJyl7DQogICAgICAgICAgICAgICAgc2xpZGVBbmNob3IgPSBzbGlkZUluZGV4Ow0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAvL29ubHkgY2hhbmdpbmcgdGhlIFVSTCBpZiB0aGUgc2xpZGVzIGFyZSBpbiB0aGUgY3VycmVudCBzZWN0aW9uIChub3QgZm9yIHJlc2l6ZSByZS1hZGp1c3RpbmcpDQogICAgICAgICAgICBpZihzZWN0aW9uLmhhc0NsYXNzKCdhY3RpdmUnKSl7DQoNCiAgICAgICAgICAgICAgICBpZighb3B0aW9ucy5sb29wSG9yaXpvbnRhbCl7DQogICAgICAgICAgICAgICAgICAgIC8vaGlkZGluZyBpdCBmb3IgdGhlIGZpc3Qgc2xpZGUsIHNob3dpbmcgZm9yIHRoZSByZXN0DQogICAgICAgICAgICAgICAgICAgIHNlY3Rpb24uZmluZCgnLmNvbnRyb2xBcnJvdy5wcmV2JykudG9nZ2xlKHNsaWRlSW5kZXghPTApOw0KDQogICAgICAgICAgICAgICAgICAgIC8vaGlkZGluZyBpdCBmb3IgdGhlIGxhc3Qgc2xpZGUsIHNob3dpbmcgZm9yIHRoZSByZXN0DQogICAgICAgICAgICAgICAgICAgIHNlY3Rpb24uZmluZCgnLmNvbnRyb2xBcnJvdy5uZXh0JykudG9nZ2xlKCFkZXN0aW55LmlzKCc6bGFzdC1jaGlsZCcpKTsNCiAgICAgICAgICAgICAgICB9DQoNCiAgICAgICAgICAgICAgICBzZXRVUkxIYXNoKHNsaWRlSW5kZXgsIHNsaWRlQW5jaG9yLCBhbmNob3JMaW5rKTsNCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgaWYob3B0aW9ucy5jc3MzKXsNCiAgICAgICAgICAgICAgICB2YXIgdHJhbnNsYXRlM2QgPSAndHJhbnNsYXRlM2QoLScgKyBkZXN0aW55UG9zLmxlZnQgKyAncHgsIDBweCwgMHB4KSc7DQoNCiAgICAgICAgICAgICAgICBzbGlkZXMuZmluZCgnLnNsaWRlc0NvbnRhaW5lcicpLmFkZENsYXNzKCdlYXNpbmcnKS5jc3Moew0KICAgICAgICAgICAgICAgICAgICAnLXdlYmtpdC10cmFuc2Zvcm0nOiB0cmFuc2xhdGUzZCwNCiAgICAgICAgICAgICAgICAgICAgJy1tb3otdHJhbnNmb3JtJzogdHJhbnNsYXRlM2QsDQogICAgICAgICAgICAgICAgICAgICctbXMtdHJhbnNmb3JtJzp0cmFuc2xhdGUzZCwNCiAgICAgICAgICAgICAgICAgICAgJ3RyYW5zZm9ybSc6IHRyYW5zbGF0ZTNkDQogICAgICAgICAgICAgICAgfSk7DQogICAgICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpew0KICAgICAgICAgICAgICAgICAgICAvL2lmIHRoZSBzaXRlIGlzIG5vdCBqdXN0IHJlc2l6aW5nIGFuZCByZWFkanVzdGluZyB0aGUgc2xpZGVzDQogICAgICAgICAgICAgICAgICAgIGlmKCFsb2NhbElzUmVzaXppbmcpew0KICAgICAgICAgICAgICAgICAgICAgICAgJC5pc0Z1bmN0aW9uKCBvcHRpb25zLmFmdGVyU2xpZGVMb2FkICkgJiYgb3B0aW9ucy5hZnRlclNsaWRlTG9hZC5jYWxsKCB0aGlzLCBhbmNob3JMaW5rLCAoc2VjdGlvbkluZGV4ICsgMSksIHNsaWRlQW5jaG9yLCBzbGlkZUluZGV4ICk7DQogICAgICAgICAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgICAgICAgICBzbGlkZU1vdmluZyA9IGZhbHNlOw0KICAgICAgICAgICAgICAgIH0sIG9wdGlvbnMuc2Nyb2xsaW5nU3BlZWQsIG9wdGlvbnMuZWFzaW5nKTsNCiAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgIHNsaWRlc0NvbnRhaW5lci5hbmltYXRlKHsNCiAgICAgICAgICAgICAgICAgICAgc2Nyb2xsTGVmdCA6IGRlc3RpbnlQb3MubGVmdA0KICAgICAgICAgICAgICAgIH0sIG9wdGlvbnMuc2Nyb2xsaW5nU3BlZWQsIG9wdGlvbnMuZWFzaW5nLCBmdW5jdGlvbigpIHsNCg0KICAgICAgICAgICAgICAgICAgICAvL2lmIHRoZSBzaXRlIGlzIG5vdCBqdXN0IHJlc2l6aW5nIGFuZCByZWFkanVzdGluZyB0aGUgc2xpZGVzDQogICAgICAgICAgICAgICAgICAgIGlmKCFsb2NhbElzUmVzaXppbmcpew0KICAgICAgICAgICAgICAgICAgICAgICAgJC5pc0Z1bmN0aW9uKCBvcHRpb25zLmFmdGVyU2xpZGVMb2FkICkgJiYgb3B0aW9ucy5hZnRlclNsaWRlTG9hZC5jYWxsKCB0aGlzLCBhbmNob3JMaW5rLCAoc2VjdGlvbkluZGV4ICsgMSksIHNsaWRlQW5jaG9yLCBzbGlkZUluZGV4KTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICAvL2xldHRpbmcgdGhlbSBzbGlkZSBhZ2Fpbg0KICAgICAgICAgICAgICAgICAgICBzbGlkZU1vdmluZyA9IGZhbHNlOw0KICAgICAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICBzbGlkZXNOYXYuZmluZCgnLmFjdGl2ZScpLnJlbW92ZUNsYXNzKCdhY3RpdmUnKTsNCiAgICAgICAgICAgIHNsaWRlc05hdi5maW5kKCdsaScpLmVxKHNsaWRlSW5kZXgpLmZpbmQoJ2EnKS5hZGRDbGFzcygnYWN0aXZlJyk7DQogICAgICAgIH0NCg0KDQogICAgICAgIGlmICghaXNUYWJsZXQpIHsNCiAgICAgICAgICAgIHZhciByZXNpemVJZDsNCg0KICAgICAgICAgICAgLy93aGVuIHJlc2l6aW5nIHRoZSBzaXRlLCB3ZSBhZGp1c3QgdGhlIGhlaWdodHMgb2YgdGhlIHNlY3Rpb25zDQogICAgICAgICAgICAkKHdpbmRvdykucmVzaXplKGZ1bmN0aW9uKCkgew0KICAgICAgICAgICAgICAgIC8vaW4gb3JkZXIgdG8gY2FsbCB0aGUgZnVuY3Rpb25zIG9ubHkgd2hlbiB0aGUgcmVzaXplIGlzIGZpbmlzaGVkDQogICAgICAgICAgICAgICAgLy9odHRwOi8vc3RhY2tvdmVyZmxvdy5jb20vcXVlc3Rpb25zLzQyOTg2MTIvanF1ZXJ5LWhvdy10by1jYWxsLXJlc2l6ZS1ldmVudC1vbmx5LW9uY2UtaXRzLWZpbmlzaGVkLXJlc2l6aW5nDQogICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHJlc2l6ZUlkKTsNCiAgICAgICAgICAgICAgICByZXNpemVJZCA9IHNldFRpbWVvdXQoZG9uZVJlc2l6aW5nLCA1MDApOw0KICAgICAgICAgICAgfSk7DQoNCiAgICAgICAgfQ0KICAgICAgICAkKHdpbmRvdykuYmluZCgnb3JpZW50YXRpb25jaGFuZ2UnLCBmdW5jdGlvbigpIHsNCiAgICAgICAgICAgIGRvbmVSZXNpemluZygpOw0KICAgICAgICB9KTsNCg0KICAgICAgICAvKioNCiAgICAgICAgICogV2hlbiByZXNpemluZyBpcyBmaW5pc2hlZCwgd2UgYWRqdXN0IHRoZSBzbGlkZXMgc2l6ZXMgYW5kIHBvc2l0aW9ucw0KICAgICAgICAgKi8NCiAgICAgICAgZnVuY3Rpb24gZG9uZVJlc2l6aW5nKCkgew0KICAgICAgICAgICAgaXNSZXNpemluZyA9IHRydWU7DQoNCiAgICAgICAgICAgIHZhciB3aW5kb3dzV2lkdGggPSAkKHdpbmRvdykud2lkdGgoKTsNCiAgICAgICAgICAgIHdpbmRvd3NIZWlnaHQgPSAkKHdpbmRvdykuaGVpZ2h0KCk7DQoNCiAgICAgICAgICAgIC8vdGV4dCBhbmQgaW1hZ2VzIHJlc2l6aW5nDQogICAgICAgICAgICBpZiAob3B0aW9ucy5yZXNpemUpIHsNCiAgICAgICAgICAgICAgICByZXNpemVNZSh3aW5kb3dzSGVpZ2h0LCB3aW5kb3dzV2lkdGgpOw0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAkKCcuc2VjdGlvbicpLmVhY2goZnVuY3Rpb24oKXsNCiAgICAgICAgICAgICAgICB2YXIgc2Nyb2xsSGVpZ2h0ID0gd2luZG93c0hlaWdodCAtIHBhcnNlSW50KCQodGhpcykuY3NzKCdwYWRkaW5nLWJvdHRvbScpKSAtIHBhcnNlSW50KCQodGhpcykuY3NzKCdwYWRkaW5nLXRvcCcpKTsNCg0KICAgICAgICAgICAgICAgIC8vcmVzaXppbmcgdGhlIHNjcm9sbGluZyBkaXZzDQogICAgICAgICAgICAgICAgaWYob3B0aW9ucy5zY3JvbGxPdmVyZmxvdyl7DQogICAgICAgICAgICAgICAgICAgIHZhciBzbGlkZXMgPSAkKHRoaXMpLmZpbmQoJy5zbGlkZScpOw0KDQogICAgICAgICAgICAgICAgICAgIGlmKHNsaWRlcy5sZW5ndGgpew0KICAgICAgICAgICAgICAgICAgICAgICAgc2xpZGVzLmVhY2goZnVuY3Rpb24oKXsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjcmVhdGVTbGltU2Nyb2xsaW5nKCQodGhpcykpOw0KICAgICAgICAgICAgICAgICAgICAgICAgfSk7DQogICAgICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICAgICAgY3JlYXRlU2xpbVNjcm9sbGluZygkKHRoaXMpKTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAgICAgLy9hZGp1c3RpbmcgdGhlIGhlaWdodCBvZiB0aGUgdGFibGUtY2VsbCBmb3IgSUUgYW5kIEZpcmVmb3gNCiAgICAgICAgICAgICAgICBpZihvcHRpb25zLnZlcnRpY2FsQ2VudGVyZWQpew0KICAgICAgICAgICAgICAgICAgICAkKHRoaXMpLmZpbmQoJy50YWJsZUNlbGwnKS5jc3MoJ2hlaWdodCcsIGdldFRhYmxlSGVpZ2h0KCQodGhpcykpICsgJ3B4Jyk7DQogICAgICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAgICAgJCh0aGlzKS5jc3MoJ2hlaWdodCcsIHdpbmRvd3NIZWlnaHQgKyAncHgnKTsNCg0KICAgICAgICAgICAgICAgIC8vYWRqdXN0aW5nIHRoZSBwb3NpdGlvbiBmbyB0aGUgRlVMTCBXSURUSCBzbGlkZXMuLi4NCiAgICAgICAgICAgICAgICB2YXIgc2xpZGVzID0gJCh0aGlzKS5maW5kKCcuc2xpZGVzJyk7DQogICAgICAgICAgICAgICAgaWYgKHNsaWRlcy5sZW5ndGgpIHsNCiAgICAgICAgICAgICAgICAgICAgbGFuZHNjYXBlU2Nyb2xsKHNsaWRlcywgc2xpZGVzLmZpbmQoJy5zbGlkZS5hY3RpdmUnKSk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfSk7DQoNCiAgICAgICAgICAgIC8vYWRqdXN0aW5nIHRoZSBwb3NpdGlvbiBmb3IgdGhlIGN1cnJlbnQgc2VjdGlvbg0KICAgICAgICAgICAgdmFyIGRlc3RpbnlQb3MgPSAkKCcuc2VjdGlvbi5hY3RpdmUnKS5wb3NpdGlvbigpOw0KDQogICAgICAgICAgICB2YXIgYWN0aXZlU2VjdGlvbiA9ICQoJy5zZWN0aW9uLmFjdGl2ZScpOw0KDQogICAgICAgICAgICAvL2lzbid0IGl0IHRoZSBmaXJzdCBzZWN0aW9uPw0KICAgICAgICAgICAgaWYoYWN0aXZlU2VjdGlvbi5pbmRleCgnLnNlY3Rpb24nKSl7DQogICAgICAgICAgICAgICAgc2Nyb2xsUGFnZShhY3RpdmVTZWN0aW9uKTsNCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgaXNSZXNpemluZyA9IGZhbHNlOw0KICAgICAgICB9DQoNCiAgICAgICAgLyoqDQogICAgICAgICAqIFJlc2l6aW5nIG9mIHRoZSBmb250IHNpemUgZGVwZW5kaW5nIG9uIHRoZSB3aW5kb3cgc2l6ZSBhcyB3ZWxsIGFzIHNvbWUgb2YgdGhlIGltYWdlcyBvbiB0aGUgc2l0ZS4NCiAgICAgICAgICovDQogICAgICAgIGZ1bmN0aW9uIHJlc2l6ZU1lKGRpc3BsYXlIZWlnaHQsIGRpc3BsYXlXaWR0aCkgew0KICAgICAgICAgICAgLy9TdGFuZGFyZCBoZWlnaHQsIGZvciB3aGljaCB0aGUgYm9keSBmb250IHNpemUgaXMgY29ycmVjdA0KICAgICAgICAgICAgdmFyIHByZWZlcnJlZEhlaWdodCA9IDgyNTsNCiAgICAgICAgICAgIHZhciB3aW5kb3dTaXplID0gZGlzcGxheUhlaWdodDsNCg0KICAgICAgICAgICAgLyogUHJvYmxlbSB0byBiZSBzb2x2ZWQNCg0KICAgICAgICAgICAgaWYgKGRpc3BsYXlIZWlnaHQgPCA4MjUpIHsNCiAgICAgICAgICAgICAgICB2YXIgcGVyY2VudGFnZSA9ICh3aW5kb3dTaXplICogMTAwKSAvIHByZWZlcnJlZEhlaWdodDsNCiAgICAgICAgICAgICAgICB2YXIgbmV3Rm9udFNpemUgPSBwZXJjZW50YWdlLnRvRml4ZWQoMik7DQoNCiAgICAgICAgICAgICAgICAkKCJpbWciKS5lYWNoKGZ1bmN0aW9uKCkgew0KICAgICAgICAgICAgICAgICAgICB2YXIgbmV3V2lkdGggPSAoKDgwICogcGVyY2VudGFnZSkgLyAxMDApLnRvRml4ZWQoMik7DQogICAgICAgICAgICAgICAgICAgICQodGhpcykuY3NzKCJ3aWR0aCIsIG5ld1dpZHRoICsgJyUnKTsNCiAgICAgICAgICAgICAgICB9KTsNCiAgICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICAgICAgJCgiaW1nIikuZWFjaChmdW5jdGlvbigpIHsNCiAgICAgICAgICAgICAgICAgICAgJCh0aGlzKS5jc3MoIndpZHRoIiwgJycpOw0KICAgICAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgfSovDQoNCiAgICAgICAgICAgIGlmIChkaXNwbGF5SGVpZ2h0IDwgODI1IHx8IGRpc3BsYXlXaWR0aCA8IDkwMCkgew0KICAgICAgICAgICAgICAgIGlmIChkaXNwbGF5V2lkdGggPCA5MDApIHsNCiAgICAgICAgICAgICAgICAgICAgd2luZG93U2l6ZSA9IGRpc3BsYXlXaWR0aDsNCiAgICAgICAgICAgICAgICAgICAgcHJlZmVycmVkSGVpZ2h0ID0gOTAwOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB2YXIgcGVyY2VudGFnZSA9ICh3aW5kb3dTaXplICogMTAwKSAvIHByZWZlcnJlZEhlaWdodDsNCiAgICAgICAgICAgICAgICB2YXIgbmV3Rm9udFNpemUgPSBwZXJjZW50YWdlLnRvRml4ZWQoMik7DQoNCiAgICAgICAgICAgICAgICAkKCJib2R5IikuY3NzKCJmb250LXNpemUiLCBuZXdGb250U2l6ZSArICclJyk7DQogICAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgICAgICQoImJvZHkiKS5jc3MoImZvbnQtc2l6ZSIsICcxMDAlJyk7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCg0KICAgICAgICAvKioNCiAgICAgICAgICogQWN0aXZhdGluZyB0aGUgd2Vic2l0ZSBuYXZpZ2F0aW9uIGRvdHMgYWNjb3JkaW5nIHRvIHRoZSBnaXZlbiBzbGlkZSBuYW1lLg0KICAgICAgICAgKi8NCiAgICAgICAgZnVuY3Rpb24gYWN0aXZhdGVOYXZEb3RzKG5hbWUsIHNlY3Rpb25JbmRleCl7DQogICAgICAgICAgICBpZihvcHRpb25zLm5hdmlnYXRpb24pew0KICAgICAgICAgICAgICAgICQoJyNmdWxsUGFnZS1uYXYnKS5maW5kKCcuYWN0aXZlJykucmVtb3ZlQ2xhc3MoJ2FjdGl2ZScpOw0KICAgICAgICAgICAgICAgIGlmKG5hbWUpew0KICAgICAgICAgICAgICAgICAgICAkKCcjZnVsbFBhZ2UtbmF2JykuZmluZCgnYVtocmVmPSIjJyArIG5hbWUgKyAnIl0nKS5hZGRDbGFzcygnYWN0aXZlJyk7DQogICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgICQoJyNmdWxsUGFnZS1uYXYnKS5maW5kKCdsaScpLmVxKHNlY3Rpb25JbmRleCkuZmluZCgnYScpLmFkZENsYXNzKCdhY3RpdmUnKTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9DQogICAgICAgIH0NCg0KICAgICAgICAvKioNCiAgICAgICAgICogQWN0aXZhdGluZyB0aGUgd2Vic2l0ZSBtYWluIG1lbnUgZWxlbWVudHMgYWNjb3JkaW5nIHRvIHRoZSBnaXZlbiBzbGlkZSBuYW1lLg0KICAgICAgICAgKi8NCiAgICAgICAgZnVuY3Rpb24gYWN0aXZhdGVNZW51RWxlbWVudChuYW1lKXsNCiAgICAgICAgICAgIGlmKG9wdGlvbnMubWVudSl7DQogICAgICAgICAgICAgICAgJChvcHRpb25zLm1lbnUpLmZpbmQoJy5hY3RpdmUnKS5yZW1vdmVDbGFzcygnYWN0aXZlJyk7DQogICAgICAgICAgICAgICAgJChvcHRpb25zLm1lbnUpLmZpbmQoJ1tkYXRhLW1lbnVhbmNob3I9IicrbmFtZSsnIl0nKS5hZGRDbGFzcygnYWN0aXZlJyk7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCg0KICAgICAgICAvKioNCiAgICAgICAgKiBSZXR1cm4gYSBib29sZWFuIGRlcGVuZGluZyBvbiB3aGV0aGVyIHRoZSBzY3JvbGxhYmxlIGVsZW1lbnQgaXMgYXQgdGhlIGVuZCBvciBhdCB0aGUgc3RhcnQgb2YgdGhlIHNjcm9sbGluZw0KICAgICAgICAqIGRlcGVuZGluZyBvbiB0aGUgZ2l2ZW4gdHlwZS4NCiAgICAgICAgKi8NCiAgICAgICAgZnVuY3Rpb24gaXNTY3JvbGxlZCh0eXBlLCBzY3JvbGxhYmxlKXsNCiAgICAgICAgICAgIGlmKHR5cGUgPT09ICd0b3AnKXsNCiAgICAgICAgICAgICAgICByZXR1cm4gIXNjcm9sbGFibGUuc2Nyb2xsVG9wKCk7DQogICAgICAgICAgICB9ZWxzZSBpZih0eXBlID09PSAnYm90dG9tJyl7DQogICAgICAgICAgICAgICAgcmV0dXJuIHNjcm9sbGFibGUuc2Nyb2xsVG9wKCkgKyBzY3JvbGxhYmxlLmlubmVySGVpZ2h0KCkgPj0gc2Nyb2xsYWJsZVswXS5zY3JvbGxIZWlnaHQ7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCg0KICAgICAgICAvKioNCiAgICAgICAgKiBSZXR1bnMgYHVwYCBvciBgZG93bmAgZGVwZW5kaW5nIG9uIHRoZSBzY3JvbGxpbmcgbW92ZW1lbnQgdG8gcmVhY2ggaXRzIGRlc3RpbmF0aW9uDQogICAgICAgICogZnJvbSB0aGUgY3VycmVudCBzZWN0aW9uLg0KICAgICAgICAqLw0KICAgICAgICBmdW5jdGlvbiBnZXRZbW92ZW1lbnQoZGVzdGlueSl7DQogICAgICAgICAgICB2YXIgZnJvbUluZGV4ID0gJCgnLnNlY3Rpb24uYWN0aXZlJykuaW5kZXgoJy5zZWN0aW9uJyk7DQogICAgICAgICAgICB2YXIgdG9JbmRleCA9IGRlc3RpbnkuaW5kZXgoJy5zZWN0aW9uJyk7DQoNCiAgICAgICAgICAgIGlmKGZyb21JbmRleCA+IHRvSW5kZXgpew0KICAgICAgICAgICAgICAgIHJldHVybiAndXAnOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgcmV0dXJuICdkb3duJzsNCiAgICAgICAgfQ0KDQogICAgICAgIC8qKg0KICAgICAgICAqIFJldHVucyBgcmlnaHRgIG9yIGBsZWZ0YCBkZXBlbmRpbmcgb24gdGhlIHNjcm9sbGluZyBtb3ZlbWVudCB0byByZWFjaCBpdHMgZGVzdGluYXRpb24NCiAgICAgICAgKiBmcm9tIHRoZSBjdXJyZW50IHNsaWRlLg0KICAgICAgICAqLw0KICAgICAgICBmdW5jdGlvbiBnZXRYbW92ZW1lbnQoZnJvbUluZGV4LCB0b0luZGV4KXsNCiAgICAgICAgICAgIGlmKGZyb21JbmRleCA+IHRvSW5kZXgpew0KICAgICAgICAgICAgICAgIHJldHVybiAnbGVmdCc7DQogICAgICAgICAgICB9DQogICAgICAgICAgICByZXR1cm4gJ3JpZ2h0JzsNCiAgICAgICAgfQ0KDQoNCiAgICAgICAgZnVuY3Rpb24gY3JlYXRlU2xpbVNjcm9sbGluZyhlbGVtZW50KXsNCiAgICAgICAgICAgIC8vbmVlZGVkIHRvIG1ha2UgYHNjcm9sbEhlaWdodGAgd29yayB1bmRlciBPcGVyYSAxMg0KICAgICAgICAgICAgZWxlbWVudC5jc3MoJ292ZXJmbG93JywgJ2hpZGRlbicpOw0KDQogICAgICAgICAgICAvL2luIGNhc2UgZWxlbWVudCBpcyBhIHNsaWRlDQogICAgICAgICAgICB2YXIgc2VjdGlvbiA9IGVsZW1lbnQuY2xvc2VzdCgnLnNlY3Rpb24nKTsNCiAgICAgICAgICAgIHZhciBzY3JvbGxhYmxlID0gZWxlbWVudC5maW5kKCcuc2Nyb2xsYWJsZScpOw0KDQogICAgICAgICAgICAvL2lmIHRoZXJlIHdhcyBzY3JvbGwsIHRoZSBjb250ZW50SGVpZ2h0IHdpbGwgYmUgdGhlIG9uZSBpbiB0aGUgc2Nyb2xsYWJsZSBzZWN0aW9uDQogICAgICAgICAgICBpZihzY3JvbGxhYmxlLmxlbmd0aCl7DQogICAgICAgICAgICAgICAgdmFyIGNvbnRlbnRIZWlnaHQgPSBlbGVtZW50LmZpbmQoJy5zY3JvbGxhYmxlJykuZ2V0KDApLnNjcm9sbEhlaWdodDsNCiAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgIHZhciBjb250ZW50SGVpZ2h0ID0gZWxlbWVudC5nZXQoMCkuc2Nyb2xsSGVpZ2h0Ow0KICAgICAgICAgICAgICAgIGlmKG9wdGlvbnMudmVydGljYWxDZW50ZXJlZCl7DQogICAgICAgICAgICAgICAgICAgIGNvbnRlbnRIZWlnaHQgPSBlbGVtZW50LmZpbmQoJy50YWJsZUNlbGwnKS5nZXQoMCkuc2Nyb2xsSGVpZ2h0Ow0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgdmFyIHNjcm9sbEhlaWdodCA9IHdpbmRvd3NIZWlnaHQgLSBwYXJzZUludChzZWN0aW9uLmNzcygncGFkZGluZy1ib3R0b20nKSkgLSBwYXJzZUludChzZWN0aW9uLmNzcygncGFkZGluZy10b3AnKSk7DQoNCiAgICAgICAgICAgIC8vbmVlZHMgc2Nyb2xsPw0KICAgICAgICAgICAgaWYgKCBjb250ZW50SGVpZ2h0ID4gc2Nyb2xsSGVpZ2h0KSB7DQogICAgICAgICAgICAgICAgLy93YXMgdGhlcmUgYWxyZWFkeSBhbiBzY3JvbGwgPyBVcGRhdGluZyBpdA0KICAgICAgICAgICAgICAgIGlmKHNjcm9sbGFibGUubGVuZ3RoKXsNCiAgICAgICAgICAgICAgICAgICAgc2Nyb2xsYWJsZS5jc3MoJ2hlaWdodCcsIHNjcm9sbEhlaWdodCArICdweCcpLnBhcmVudCgpLmNzcygnaGVpZ2h0Jywgc2Nyb2xsSGVpZ2h0ICsgJ3B4Jyk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIC8vY3JlYXRpbmcgdGhlIHNjcm9sbGluZw0KICAgICAgICAgICAgICAgIGVsc2V7DQogICAgICAgICAgICAgICAgICAgIGlmKG9wdGlvbnMudmVydGljYWxDZW50ZXJlZCl7DQogICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50LmZpbmQoJy50YWJsZUNlbGwnKS53cmFwSW5uZXIoJzxkaXYgY2xhc3M9InNjcm9sbGFibGUiIC8+Jyk7DQogICAgICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudC53cmFwSW5uZXIoJzxkaXYgY2xhc3M9InNjcm9sbGFibGUiIC8+Jyk7DQogICAgICAgICAgICAgICAgICAgIH0NCg0KDQogICAgICAgICAgICAgICAgICAgIGVsZW1lbnQuZmluZCgnLnNjcm9sbGFibGUnKS5zbGltU2Nyb2xsKHsNCiAgICAgICAgICAgICAgICAgICAgICAgIGhlaWdodDogc2Nyb2xsSGVpZ2h0ICsgJ3B4JywNCiAgICAgICAgICAgICAgICAgICAgICAgIHNpemU6ICcxMHB4JywNCiAgICAgICAgICAgICAgICAgICAgICAgIGFsd2F5c1Zpc2libGU6IHRydWUNCiAgICAgICAgICAgICAgICAgICAgfSk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAvL3JlbW92aW5nIHRoZSBzY3JvbGxpbmcgd2hlbiBpdCBpcyBub3QgbmVjZXNzYXJ5IGFueW1vcmUNCiAgICAgICAgICAgIGVsc2V7DQogICAgICAgICAgICAgICAgZWxlbWVudC5maW5kKCcuc2Nyb2xsYWJsZScpLmNoaWxkcmVuKCkuZmlyc3QoKS51bndyYXAoKS51bndyYXAoKTsNCiAgICAgICAgICAgICAgICBlbGVtZW50LmZpbmQoJy5zbGltU2Nyb2xsQmFyJykucmVtb3ZlKCk7DQogICAgICAgICAgICAgICAgZWxlbWVudC5maW5kKCcuc2xpbVNjcm9sbFJhaWwnKS5yZW1vdmUoKTsNCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgLy91bmRvDQogICAgICAgICAgICBlbGVtZW50LmNzcygnb3ZlcmZsb3cnLCAnJyk7DQogICAgICAgIH0NCg0KICAgICAgICBmdW5jdGlvbiBhZGRUYWJsZUNsYXNzKGVsZW1lbnQpew0KICAgICAgICAgICAgZWxlbWVudC5hZGRDbGFzcygndGFibGUnKS53cmFwSW5uZXIoJzxkaXYgY2xhc3M9InRhYmxlQ2VsbCIgc3R5bGU9ImhlaWdodDonICsgZ2V0VGFibGVIZWlnaHQoZWxlbWVudCkgKyAncHg7IiAvPicpOw0KICAgICAgICB9DQoNCiAgICAgICAgZnVuY3Rpb24gZ2V0VGFibGVIZWlnaHQoZWxlbWVudCl7DQogICAgICAgICAgICB2YXIgc2VjdGlvbkhlaWdodCA9IHdpbmRvd3NIZWlnaHQ7DQoNCiAgICAgICAgICAgIGlmKG9wdGlvbnMucGFkZGluZ1RvcCB8fCBvcHRpb25zLnBhZGRpbmdCb3R0b20pew0KICAgICAgICAgICAgICAgIHZhciBzZWN0aW9uID0gZWxlbWVudDsNCiAgICAgICAgICAgICAgICBpZighc2VjdGlvbi5oYXNDbGFzcygnc2VjdGlvbicpKXsNCiAgICAgICAgICAgICAgICAgICAgc2VjdGlvbiA9IGVsZW1lbnQuY2xvc2VzdCgnLnNlY3Rpb24nKTsNCiAgICAgICAgICAgICAgICB9DQoNCiAgICAgICAgICAgICAgICB2YXIgcGFkZGluZ3MgPSBwYXJzZUludChzZWN0aW9uLmNzcygncGFkZGluZy10b3AnKSkgKyBwYXJzZUludChzZWN0aW9uLmNzcygncGFkZGluZy1ib3R0b20nKSk7DQogICAgICAgICAgICAgICAgc2VjdGlvbkhlaWdodCA9ICh3aW5kb3dzSGVpZ2h0IC0gcGFkZGluZ3MpOw0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICByZXR1cm4gc2VjdGlvbkhlaWdodDsNCiAgICAgICAgfQ0KDQogICAgICAgIC8qKg0KICAgICAgICAqIEFkZHMgYSBjc3MzIHRyYW5zZm9ybSBwcm9wZXJ0eSB0byB0aGUgY29udGFpbmVyIGNsYXNzIHdpdGggb3Igd2l0aG91dCBhbmltYXRpb24gZGVwZW5kaW5nIG9uIHRoZSBhbmltYXRlZCBwYXJhbS4NCiAgICAgICAgKi8NCiAgICAgICAgZnVuY3Rpb24gdHJhbnNmb3JtQ29udGFpbmVyKHRyYW5zbGF0ZTNkLCBhbmltYXRlZCl7DQogICAgICAgICAgICAkKCcjc3VwZXJDb250YWluZXInKS50b2dnbGVDbGFzcygnZWFzaW5nJywgYW5pbWF0ZWQpOw0KDQogICAgICAgICAgICAkKCcjc3VwZXJDb250YWluZXInKS5jc3Moew0KICAgICAgICAgICAgICAgICctd2Via2l0LXRyYW5zZm9ybSc6IHRyYW5zbGF0ZTNkLA0KICAgICAgICAgICAgICAgICctbW96LXRyYW5zZm9ybSc6IHRyYW5zbGF0ZTNkLA0KICAgICAgICAgICAgICAgICctbXMtdHJhbnNmb3JtJzp0cmFuc2xhdGUzZCwNCiAgICAgICAgICAgICAgICAndHJhbnNmb3JtJzogdHJhbnNsYXRlM2QNCiAgICAgICAgICAgIH0pOw0KICAgICAgICB9DQoNCg0KICAgICAgICAvKioNCiAgICAgICAgKiBTY3JvbGxzIHRvIHRoZSBnaXZlbiBzZWN0aW9uIGFuZCBzbGlkZQ0KICAgICAgICAqLw0KICAgICAgICBmdW5jdGlvbiBzY3JvbGxQYWdlQW5kU2xpZGUoZGVzdGlueSwgc2xpZGUpew0KICAgICAgICAgICAgaWYgKHR5cGVvZiBzbGlkZSA9PT0gJ3VuZGVmaW5lZCcpIHsNCiAgICAgICAgICAgICAgICBzbGlkZSA9IDA7DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIGlmKGlzTmFOKGRlc3RpbnkpKXsNCiAgICAgICAgICAgICAgICB2YXIgc2VjdGlvbiA9ICQoJ1tkYXRhLWFuY2hvcj0iJytkZXN0aW55KyciXScpOw0KICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgdmFyIHNlY3Rpb24gPSAkKCcuc2VjdGlvbicpLmVxKCAoZGVzdGlueSAtMSkgKTsNCiAgICAgICAgICAgIH0NCg0KDQogICAgICAgICAgICAvL3dlIG5lZWQgdG8gc2Nyb2xsIHRvIHRoZSBzZWN0aW9uIGFuZCB0aGVuIHRvIHRoZSBzbGlkZQ0KICAgICAgICAgICAgaWYgKGRlc3RpbnkgIT09IGxhc3RTY3JvbGxlZERlc3RpbnkgJiYgIXNlY3Rpb24uaGFzQ2xhc3MoJ2FjdGl2ZScpKXsNCiAgICAgICAgICAgICAgICBzY3JvbGxQYWdlKHNlY3Rpb24sIGZ1bmN0aW9uKCl7DQogICAgICAgICAgICAgICAgICAgIHNjcm9sbFNsaWRlcihzZWN0aW9uLCBzbGlkZSkNCiAgICAgICAgICAgICAgICB9KTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIC8vaWYgd2Ugd2VyZSBhbHJlYWR5IGluIHRoZSBzZWN0aW9uDQogICAgICAgICAgICBlbHNlew0KICAgICAgICAgICAgICAgIHNjcm9sbFNsaWRlcihzZWN0aW9uLCBzbGlkZSk7DQogICAgICAgICAgICB9DQoNCiAgICAgICAgfQ0KDQogICAgICAgIC8qKg0KICAgICAgICAqIFNjcm9sbHMgdGhlIHNsaWRlciB0byB0aGUgZ2l2ZW4gc2xpZGUgZGVzdGluYXRpb24gZm9yIHRoZSBnaXZlbiBzZWN0aW9uDQogICAgICAgICovDQogICAgICAgIGZ1bmN0aW9uIHNjcm9sbFNsaWRlcihzZWN0aW9uLCBzbGlkZSl7DQogICAgICAgICAgICBpZih0eXBlb2Ygc2xpZGUgIT0gJ3VuZGVmaW5lZCcpew0KICAgICAgICAgICAgICAgIHZhciBzbGlkZXMgPSBzZWN0aW9uLmZpbmQoJy5zbGlkZXMnKTsNCiAgICAgICAgICAgICAgICB2YXIgZGVzdGlueSA9ICBzbGlkZXMuZmluZCgnW2RhdGEtYW5jaG9yPSInK3NsaWRlKyciXScpOw0KDQogICAgICAgICAgICAgICAgaWYoIWRlc3RpbnkubGVuZ3RoKXsNCiAgICAgICAgICAgICAgICAgICAgZGVzdGlueSA9IHNsaWRlcy5maW5kKCcuc2xpZGUnKS5lcShzbGlkZSk7DQogICAgICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAgICAgaWYoZGVzdGlueS5sZW5ndGgpew0KICAgICAgICAgICAgICAgICAgICBsYW5kc2NhcGVTY3JvbGwoc2xpZGVzLCBkZXN0aW55KTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9DQogICAgICAgIH0NCg0KICAgICAgICAvKioNCiAgICAgICAgKiBDcmVhdGVzIGEgbGFuZHNjYXBlIG5hdmlnYXRpb24gYmFyIHdpdGggZG90cyBmb3IgaG9yaXpvbnRhbCBzbGlkZXJzLg0KICAgICAgICAqLw0KICAgICAgICBmdW5jdGlvbiBhZGRTbGlkZXNOYXZpZ2F0aW9uKHNlY3Rpb24sIG51bVNsaWRlcyl7DQogICAgICAgICAgICBzZWN0aW9uLmFwcGVuZCgnPGRpdiBjbGFzcz0iZnVsbFBhZ2Utc2xpZGVzTmF2Ij48dWw+PC91bD48L2Rpdj4nKTsNCiAgICAgICAgICAgIHZhciBuYXYgPSBzZWN0aW9uLmZpbmQoJy5mdWxsUGFnZS1zbGlkZXNOYXYnKTsNCg0KICAgICAgICAgICAgLy90b3Agb3IgYm90dG9tDQogICAgICAgICAgICBuYXYuYWRkQ2xhc3Mob3B0aW9ucy5zbGlkZXNOYXZQb3NpdGlvbik7DQoNCiAgICAgICAgICAgIGZvcih2YXIgaT0wOyBpPCBudW1TbGlkZXM7IGkrKyl7DQogICAgICAgICAgICAgICAgbmF2LmZpbmQoJ3VsJykuYXBwZW5kKCc8bGk+PGEgaHJlZj0iIyI+PHNwYW4+PC9zcGFuPjwvYT48L2xpPicpOw0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAvL2NlbnRlcmluZyBpdA0KICAgICAgICAgICAgbmF2LmNzcygnbWFyZ2luLWxlZnQnLCAnLScgKyAobmF2LndpZHRoKCkvMikgKyAncHgnKTsNCg0KICAgICAgICAgICAgbmF2LmZpbmQoJ2xpJykuZmlyc3QoKS5maW5kKCdhJykuYWRkQ2xhc3MoJ2FjdGl2ZScpOw0KICAgICAgICB9DQoNCg0KICAgICAgICAvKioNCiAgICAgICAgKiBTZXRzIHRoZSBVUkwgaGFzaCBmb3IgYSBzZWN0aW9uIHdpdGggc2xpZGVzDQogICAgICAgICovDQogICAgICAgIGZ1bmN0aW9uIHNldFVSTEhhc2goc2xpZGVJbmRleCwgc2xpZGVBbmNob3IsIGFuY2hvckxpbmspew0KICAgICAgICAgICAgdmFyIHNlY3Rpb25IYXNoID0gJyc7DQoNCiAgICAgICAgICAgIGlmKG9wdGlvbnMuYW5jaG9ycy5sZW5ndGggJiYgb3B0aW9ucy5oYXNoQ2hhbmdlKXsNCg0KICAgICAgICAgICAgICAgIC8vaXNuJ3QgaXQgdGhlIGZpcnN0IHNsaWRlPw0KICAgICAgICAgICAgICAgIGlmKHNsaWRlSW5kZXgpew0KICAgICAgICAgICAgICAgICAgICBpZih0eXBlb2YgYW5jaG9yTGluayAhPT0gJ3VuZGVmaW5lZCcpew0KICAgICAgICAgICAgICAgICAgICAgICAgc2VjdGlvbkhhc2ggPSBhbmNob3JMaW5rOw0KICAgICAgICAgICAgICAgICAgICB9DQoNCiAgICAgICAgICAgICAgICAgICAgLy9zbGlkZSB3aXRob3V0IGFuY2hvciBsaW5rPyBXZSB0YWtlIHRoZSBpbmRleCBpbnN0ZWFkLg0KICAgICAgICAgICAgICAgICAgICBpZih0eXBlb2Ygc2xpZGVBbmNob3IgPT09ICd1bmRlZmluZWQnKXsNCiAgICAgICAgICAgICAgICAgICAgICAgIHNsaWRlQW5jaG9yID0gc2xpZGVJbmRleDsNCiAgICAgICAgICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAgICAgICAgIGxhc3RTY3JvbGxlZFNsaWRlID0gc2xpZGVBbmNob3I7DQogICAgICAgICAgICAgICAgICAgIGxvY2F0aW9uLmhhc2ggPSBzZWN0aW9uSGFzaCArICcvJyArIHNsaWRlQW5jaG9yOw0KDQogICAgICAgICAgICAgICAgLy9maXJzdCBzbGlkZSB3b24ndCBoYXZlIHNsaWRlIGFuY2hvciwganVzdCB0aGUgc2VjdGlvbiBvbmUNCiAgICAgICAgICAgICAgICB9ZWxzZSBpZih0eXBlb2Ygc2xpZGVJbmRleCAhPT0gJ3VuZGVmaW5lZCcpew0KICAgICAgICAgICAgICAgICAgICBsYXN0U2Nyb2xsZWRTbGlkZSA9IHNsaWRlQW5jaG9yOw0KICAgICAgICAgICAgICAgICAgICBsb2NhdGlvbi5oYXNoID0gYW5jaG9yTGluazsNCiAgICAgICAgICAgICAgICB9DQoNCiAgICAgICAgICAgICAgICAvL3NlY3Rpb24gd2l0aG91dCBzbGlkZXMNCiAgICAgICAgICAgICAgICBlbHNlew0KICAgICAgICAgICAgICAgICAgICBsb2NhdGlvbi5oYXNoID0gYW5jaG9yTGluazsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9DQogICAgICAgIH0NCg0KICAgICAgICAvKioNCiAgICAgICAgKiBTY3JvbGxzIHRoZSBzbGlkZXIgdG8gdGhlIGdpdmVuIHNsaWRlIGRlc3RpbmF0aW9uIGZvciB0aGUgZ2l2ZW4gc2VjdGlvbg0KICAgICAgICAqLw0KICAgICAgICAkKGRvY3VtZW50KS5vbignY2xpY2snLCAnLmZ1bGxQYWdlLXNsaWRlc05hdiBhJywgZnVuY3Rpb24oZSl7DQogICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7DQogICAgICAgICAgICB2YXIgc2xpZGVzID0gJCh0aGlzKS5jbG9zZXN0KCcuc2VjdGlvbicpLmZpbmQoJy5zbGlkZXMnKTsNCiAgICAgICAgICAgIHZhciBkZXN0aW55ID0gc2xpZGVzLmZpbmQoJy5zbGlkZScpLmVxKCQodGhpcykuY2xvc2VzdCgnbGknKS5pbmRleCgpKTsNCg0KICAgICAgICAgICAgbGFuZHNjYXBlU2Nyb2xsKHNsaWRlcywgZGVzdGlueSk7DQogICAgICAgIH0pOw0KDQoNCiAgICAgICAgLyoqDQogICAgICAgICogQ2hlY2tzIGZvciB0cmFuc2xhdGUzZCBzdXBwb3J0DQogICAgICAgICogQHJldHVybiBib29sZWFuDQogICAgICAgICogaHR0cDovL3N0YWNrb3ZlcmZsb3cuY29tL3F1ZXN0aW9ucy81NjYxNjcxL2RldGVjdGluZy10cmFuc2Zvcm0tdHJhbnNsYXRlM2Qtc3VwcG9ydA0KICAgICAgICAqLw0KICAgICAgICBmdW5jdGlvbiBzdXBwb3J0M2QoKSB7DQogICAgICAgICAgICB2YXIgZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdwJyksDQogICAgICAgICAgICAgICAgaGFzM2QsDQogICAgICAgICAgICAgICAgdHJhbnNmb3JtcyA9IHsNCiAgICAgICAgICAgICAgICAgICAgJ3dlYmtpdFRyYW5zZm9ybSc6Jy13ZWJraXQtdHJhbnNmb3JtJywNCiAgICAgICAgICAgICAgICAgICAgJ09UcmFuc2Zvcm0nOictby10cmFuc2Zvcm0nLA0KICAgICAgICAgICAgICAgICAgICAnbXNUcmFuc2Zvcm0nOictbXMtdHJhbnNmb3JtJywNCiAgICAgICAgICAgICAgICAgICAgJ01velRyYW5zZm9ybSc6Jy1tb3otdHJhbnNmb3JtJywNCiAgICAgICAgICAgICAgICAgICAgJ3RyYW5zZm9ybSc6J3RyYW5zZm9ybScNCiAgICAgICAgICAgICAgICB9Ow0KDQogICAgICAgICAgICAvLyBBZGQgaXQgdG8gdGhlIGJvZHkgdG8gZ2V0IHRoZSBjb21wdXRlZCBzdHlsZS4NCiAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuaW5zZXJ0QmVmb3JlKGVsLCBudWxsKTsNCg0KICAgICAgICAgICAgZm9yICh2YXIgdCBpbiB0cmFuc2Zvcm1zKSB7DQogICAgICAgICAgICAgICAgaWYgKGVsLnN0eWxlW3RdICE9PSB1bmRlZmluZWQpIHsNCiAgICAgICAgICAgICAgICAgICAgZWwuc3R5bGVbdF0gPSAidHJhbnNsYXRlM2QoMXB4LDFweCwxcHgpIjsNCiAgICAgICAgICAgICAgICAgICAgaGFzM2QgPSB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZShlbCkuZ2V0UHJvcGVydHlWYWx1ZSh0cmFuc2Zvcm1zW3RdKTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIGRvY3VtZW50LmJvZHkucmVtb3ZlQ2hpbGQoZWwpOw0KDQogICAgICAgICAgICByZXR1cm4gKGhhczNkICE9PSB1bmRlZmluZWQgJiYgaGFzM2QubGVuZ3RoID4gMCAmJiBoYXMzZCAhPT0gIm5vbmUiKTsNCiAgICAgICAgfQ0KDQoNCg0KICAgICAgICAvKioNCiAgICAgICAgKiBSZW1vdmVzIHRoZSBhdXRvIHNjcm9sbGluZyBhY3Rpb24gZmlyZWQgYnkgdGhlIG1vdXNlIHdoZWVsIGFuZCB0YWNrcGFkLg0KICAgICAgICAqIEFmdGVyIHRoaXMgZnVuY3Rpb24gaXMgY2FsbGVkLCB0aGUgbW91c2V3aGVlbCBhbmQgdHJhY2twYWQgbW92ZW1lbnRzIHdvbid0IHNjcm9sbCB0aHJvdWdoIHNlY3Rpb25zLg0KICAgICAgICAqLw0KICAgICAgICBmdW5jdGlvbiByZW1vdmVNb3VzZVdoZWVsSGFuZGxlcigpew0KICAgICAgICAgICAgaWYgKGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIpIHsNCiAgICAgICAgICAgICAgICBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCdtb3VzZXdoZWVsJywgTW91c2VXaGVlbEhhbmRsZXIsIGZhbHNlKTsgLy9JRTksIENocm9tZSwgU2FmYXJpLCBPcGVyDQogICAgICAgICAgICAgICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcignRE9NTW91c2VTY3JvbGwnLCBNb3VzZVdoZWVsSGFuZGxlciwgZmFsc2UpOyAvL0ZpcmVmb3gNCiAgICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICAgICAgZG9jdW1lbnQuZGV0YWNoRXZlbnQoIm9ubW91c2V3aGVlbCIsIE1vdXNlV2hlZWxIYW5kbGVyKTsgLy9JRSA2LzcvOA0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQoNCg0KICAgICAgICAvKioNCiAgICAgICAgKiBBZGRzIHRoZSBhdXRvIHNjcm9sbGluZyBhY3Rpb24gZm9yIHRoZSBtb3VzZSB3aGVlbCBhbmQgdGFja3BhZC4NCiAgICAgICAgKiBBZnRlciB0aGlzIGZ1bmN0aW9uIGlzIGNhbGxlZCwgdGhlIG1vdXNld2hlZWwgYW5kIHRyYWNrcGFkIG1vdmVtZW50cyB3aWxsIHNjcm9sbCB0aHJvdWdoIHNlY3Rpb25zDQogICAgICAgICovDQogICAgICAgIGZ1bmN0aW9uIGFkZE1vdXNlV2hlZWxIYW5kbGVyKCl7DQogICAgICAgICAgICBpZiAoZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcikgew0KICAgICAgICAgICAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoIm1vdXNld2hlZWwiLCBNb3VzZVdoZWVsSGFuZGxlciwgZmFsc2UpOyAvL0lFOSwgQ2hyb21lLCBTYWZhcmksIE9wZXINCiAgICAgICAgICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCJET01Nb3VzZVNjcm9sbCIsIE1vdXNlV2hlZWxIYW5kbGVyLCBmYWxzZSk7IC8vRmlyZWZveA0KICAgICAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgICAgICBkb2N1bWVudC5hdHRhY2hFdmVudCgib25tb3VzZXdoZWVsIiwgTW91c2VXaGVlbEhhbmRsZXIpOyAvL0lFIDYvNy84DQogICAgICAgICAgICB9DQogICAgICAgIH0NCg0KDQogICAgICAgIC8qKg0KICAgICAgICAqIEFkZHMgdGhlIHBvc3NpYmlsaXR5IHRvIGF1dG8gc2Nyb2xsIHRocm91Z2ggc2VjdGlvbnMgb24gdG91Y2ggZGV2aWNlcy4NCiAgICAgICAgKi8NCiAgICAgICAgZnVuY3Rpb24gYWRkVG91Y2hIYW5kbGVyKCl7DQogICAgICAgICAgICBpZihpc1RhYmxldCl7DQogICAgICAgICAgICAgICAgJChkb2N1bWVudCkub2ZmKCd0b3VjaHN0YXJ0IE1TUG9pbnRlckRvd24nKS5vbigndG91Y2hzdGFydCBNU1BvaW50ZXJEb3duJywgdG91Y2hTdGFydEhhbmRsZXIpOw0KICAgICAgICAgICAgICAgICQoZG9jdW1lbnQpLm9mZigndG91Y2htb3ZlIE1TUG9pbnRlck1vdmUnKS5vbigndG91Y2htb3ZlIE1TUG9pbnRlck1vdmUnLCB0b3VjaE1vdmVIYW5kbGVyKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KDQogICAgICAgIC8qKg0KICAgICAgICAqIFJlbW92ZXMgdGhlIGF1dG8gc2Nyb2xsaW5nIGZvciB0b3VjaCBkZXZpY2VzLg0KICAgICAgICAqLw0KICAgICAgICBmdW5jdGlvbiByZW1vdmVUb3VjaEhhbmRsZXIoKXsNCiAgICAgICAgICAgIGlmKGlzVGFibGV0KXsNCiAgICAgICAgICAgICAgICAkKGRvY3VtZW50KS5vZmYoJ3RvdWNoc3RhcnQgTVNQb2ludGVyRG93bicpOw0KICAgICAgICAgICAgICAgICQoZG9jdW1lbnQpLm9mZigndG91Y2htb3ZlIE1TUG9pbnRlck1vdmUnKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KDQogICAgICAgIC8qKg0KICAgICAgICAqIEdldHMgdGhlIHBhZ2VYIGFuZCBwYWdlWSBwcm9wZXJ0aWVzIGRlcGVuZGluZyBvbiB0aGUgYnJvd3Nlci4NCiAgICAgICAgKiBodHRwczovL2dpdGh1Yi5jb20vYWx2YXJvdHJpZ28vZnVsbFBhZ2UuanMvaXNzdWVzLzE5NCNpc3N1ZWNvbW1lbnQtMzQwNjk4NTQNCiAgICAgICAgKi8NCiAgICAgICAgZnVuY3Rpb24gZ2V0RXZlbnRzUGFnZShlKXsNCiAgICAgICAgICAgIHZhciBldmVudHMgPSBuZXcgQXJyYXkoKTsNCiAgICAgICAgICAgIGlmICh3aW5kb3cubmF2aWdhdG9yLm1zUG9pbnRlckVuYWJsZWQpew0KICAgICAgICAgICAgICAgIGV2ZW50c1sneSddID0gZS5wYWdlWTsNCiAgICAgICAgICAgICAgICBldmVudHNbJ3gnXSA9IGUucGFnZVg7DQogICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICBldmVudHNbJ3knXSA9IGUudG91Y2hlc1swXS5wYWdlWTsNCiAgICAgICAgICAgICAgICBldmVudHNbJ3gnXSA9ICBlLnRvdWNoZXNbMF0ucGFnZVg7DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIHJldHVybiBldmVudHM7DQogICAgICAgIH0NCg0KICAgICAgICBmdW5jdGlvbiBzaWxlbnRTY3JvbGwodG9wKXsNCiAgICAgICAgICAgIGlmIChvcHRpb25zLmNzczMpIHsNCiAgICAgICAgICAgICAgICB2YXIgdHJhbnNsYXRlM2QgPSAndHJhbnNsYXRlM2QoMHB4LCAtJyArIHRvcCArICdweCwgMHB4KSc7DQogICAgICAgICAgICAgICAgdHJhbnNmb3JtQ29udGFpbmVyKHRyYW5zbGF0ZTNkLCBmYWxzZSk7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBlbHNlIHsNCiAgICAgICAgICAgICAgICAkKCIjc3VwZXJDb250YWluZXIiKS5jc3MoInRvcCIsIC10b3ApOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQoNCiAgICB9Ow0KfSkoalF1ZXJ5KTsNCg==",
                "body": "LyoqDQogKiBmdWxsUGFnZSAxLjcuMg0KICogaHR0cHM6Ly9naXRodWIuY29tL2FsdmFyb3RyaWdvL2Z1bGxQYWdlLmpzDQogKiBNSVQgbGljZW5zZWQNCiAqDQogKiBDb3B5cmlnaHQgKEMpIDIwMTMgYWx2YXJvdHJpZ28uY29tIC0gQSBwcm9qZWN0IGJ5IEFsdmFybyBUcmlnbw0KICovDQoNCihmdW5jdGlvbigkKSB7DQogICAgJC5mbi5mdWxscGFnZSA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsNCiAgICAgICAgLy8gQ3JlYXRlIHNvbWUgZGVmYXVsdHMsIGV4dGVuZGluZyB0aGVtIHdpdGggYW55IG9wdGlvbnMgdGhhdCB3ZXJlIHByb3ZpZGVkDQogICAgICAgIG9wdGlvbnMgPSAkLmV4dGVuZCh7DQogICAgICAgICAgICAnaGFzaENoYW5nZScgICAgICAgICAgICA6IGZhbHNlLA0KICAgICAgICAgICAgJ2luaXRpYWxTbGlkZScgICAgICAgICAgOiAwLA0KICAgICAgICAgICAgJ3ZlcnRpY2FsQ2VudGVyZWQnICAgICAgOiB0cnVlLA0KICAgICAgICAgICAgJ3Jlc2l6ZScgICAgICAgICAgICAgICAgOiB0cnVlLA0KICAgICAgICAgICAgJ3NsaWRlc0NvbG9yJyAgICAgICAgICAgOiBbXSwNCiAgICAgICAgICAgICdhbmNob3JzJyAgICAgICAgICAgICAgIDogW10sDQogICAgICAgICAgICAnc2Nyb2xsaW5nU3BlZWQnICAgICAgICA6IDcwMCwNCiAgICAgICAgICAgICdlYXNpbmcnICAgICAgICAgICAgICAgIDogJ2Vhc2VJblF1YXJ0JywNCiAgICAgICAgICAgICdtZW51JyAgICAgICAgICAgICAgICAgIDogZmFsc2UsDQogICAgICAgICAgICAnbmF2aWdhdGlvbicgICAgICAgICAgICA6IGZhbHNlLA0KICAgICAgICAgICAgJ25hdmlnYXRpb25Qb3NpdGlvbicgICAgOiAncmlnaHQnLA0KICAgICAgICAgICAgJ25hdmlnYXRpb25Db2xvcicgICAgICAgOiAnIzAwMCcsDQogICAgICAgICAgICAnbmF2aWdhdGlvblRvb2x0aXBzJyAgICA6IFtdLA0KICAgICAgICAgICAgJ3NsaWRlc05hdmlnYXRpb24nICAgICAgOiBmYWxzZSwNCiAgICAgICAgICAgICdzbGlkZXNOYXZQb3NpdGlvbicgICAgIDogJ2JvdHRvbScsDQogICAgICAgICAgICAnY29udHJvbEFycm93Q29sb3InICAgICA6ICcjZmZmJywNCiAgICAgICAgICAgICdsb29wQm90dG9tJyAgICAgICAgICAgIDogZmFsc2UsDQogICAgICAgICAgICAnbG9vcFRvcCcgICAgICAgICAgICAgICA6IGZhbHNlLA0KICAgICAgICAgICAgJ2xvb3BIb3Jpem9udGFsJyAgICAgICAgOiB0cnVlLA0KICAgICAgICAgICAgJ2F1dG9TY3JvbGxpbmcnICAgICAgICAgOiB0cnVlLA0KICAgICAgICAgICAgJ3Njcm9sbE92ZXJmbG93JyAgICAgICAgOiBmYWxzZSwNCiAgICAgICAgICAgICdjc3MzJyAgICAgICAgICAgICAgICAgIDogZmFsc2UsDQogICAgICAgICAgICAncGFkZGluZ1RvcCcgICAgICAgICAgICA6IDAsDQogICAgICAgICAgICAncGFkZGluZ0JvdHRvbScgICAgICAgICA6IDAsDQogICAgICAgICAgICAnZml4ZWRFbGVtZW50cycgICAgICAgICA6IG51bGwsDQogICAgICAgICAgICAnbm9ybWFsU2Nyb2xsRWxlbWVudHMnICA6IG51bGwsDQogICAgICAgICAgICAna2V5Ym9hcmRTY3JvbGxpbmcnICAgICA6IHRydWUsDQogICAgICAgICAgICAndG91Y2hTZW5zaXRpdml0eScgICAgICA6IDUsDQogICAgICAgICAgICAnY29udGludW91c1ZlcnRpY2FsJyAgICA6IGZhbHNlLA0KICAgICAgICAgICAgJ2FuaW1hdGVBbmNob3InICAgICAgICAgOiB0cnVlLA0KDQogICAgICAgICAgICAvL2V2ZW50cw0KICAgICAgICAgICAgJ2FmdGVyTG9hZCcgICAgICAgICAgICAgOiBudWxsLA0KICAgICAgICAgICAgJ29uTGVhdmUnICAgICAgICAgICAgICAgOiBudWxsLA0KICAgICAgICAgICAgJ2FmdGVyUmVuZGVyJyAgICAgICAgICAgOiBudWxsLA0KICAgICAgICAgICAgJ2FmdGVyU2xpZGVMb2FkJyAgICAgICAgOiBudWxsLA0KICAgICAgICAgICAgJ29uU2xpZGVMZWF2ZScgICAgICAgICAgOiBudWxsDQogICAgICAgIH0sIG9wdGlvbnMpOw0KDQogICAgICAgIC8vIERpc2FibGUgbXV0dWFsbHkgZXhjbHVzaXZlIHNldHRpbmdzDQogICAgICAgIGlmIChvcHRpb25zLmNvbnRpbnVvdXNWZXJ0aWNhbCAmJg0KICAgICAgICAgICAgKG9wdGlvbnMubG9vcFRvcCB8fCBvcHRpb25zLmxvb3BCb3R0b20pDQogICAgICAgICkgew0KICAgICAgICAgICAgb3B0aW9ucy5jb250aW51b3VzVmVydGljYWwgPSBmYWxzZTsNCiAgICAgICAgICAgIGNvbnNvbGUgJiYgY29uc29sZS5sb2cgJiYgY29uc29sZS5sb2coIk9wdGlvbiBsb29wVG9wL2xvb3BCb3R0b20gaXMgbXV0dWFsbHkgZXhjbHVzaXZlIHdpdGggY29udGludW91c1ZlcnRpY2FsOyBjb250aW51b3VzVmVydGljYWwgZGlzYWJsZWQiKTsNCiAgICAgICAgfQ0KDQogICAgICAgIC8vRGVmaW5lcyB0aGUgZGVsYXkgdG8gdGFrZSBwbGFjZSBiZWZvcmUgYmVpbmcgYWJsZSB0byBzY3JvbGwgdG8gdGhlIG5leHQgc2VjdGlvbg0KICAgICAgICAvL0JFIENBUkVGVUwhIE5vdCByZWNvbW1lbmVkIHRvIGNoYW5nZSBpdCB1bmRlciA0MDAgZm9yIGEgZ29vZCBiZWhhdmlvciBpbiBsYXB0b3BzIGFuZA0KICAgICAgICAvL0FwcGxlIGRldmljZXMgKGxhcHRvcHMsIG1vdXNlcy4uLikNCiAgICAgICAgdmFyIHNjcm9sbERlbGF5ID0gNjAwOw0KDQogICAgICAgICQuZm4uZnVsbHBhZ2Uuc2V0QXV0b1Njcm9sbGluZyA9IGZ1bmN0aW9uKHZhbHVlKXsNCiAgICAgICAgICAgIG9wdGlvbnMuYXV0b1Njcm9sbGluZyA9IHZhbHVlOw0KDQogICAgICAgICAgICB2YXIgZWxlbWVudCA9ICQoJy5zZWN0aW9uLmFjdGl2ZScpOw0KDQogICAgICAgICAgICBpZihvcHRpb25zLmF1dG9TY3JvbGxpbmcpew0KICAgICAgICAgICAgICAgICQoJ2h0bWwsIGJvZHknKS5jc3Moew0KICAgICAgICAgICAgICAgICAgICAnb3ZlcmZsb3cnIDogJ2hpZGRlbicsDQogICAgICAgICAgICAgICAgICAgICdoZWlnaHQnIDogJzEwMCUnDQogICAgICAgICAgICAgICAgfSk7DQoNCiAgICAgICAgICAgICAgICBpZihlbGVtZW50Lmxlbmd0aCl7DQogICAgICAgICAgICAgICAgICAgIC8vbW92aW5nIHRoZSBjb250YWluZXIgdXANCiAgICAgICAgICAgICAgICAgICAgc2lsZW50U2Nyb2xsKGVsZW1lbnQucG9zaXRpb24oKS50b3ApOw0KICAgICAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgJCgnaHRtbCwgYm9keScpLmNzcyh7DQogICAgICAgICAgICAgICAgICAgICdvdmVyZmxvdycgOiAnYXV0bycsDQogICAgICAgICAgICAgICAgICAgICdoZWlnaHQnIDogJ2F1dG8nDQogICAgICAgICAgICAgICAgfSk7DQoNCiAgICAgICAgICAgICAgICBzaWxlbnRTY3JvbGwoMCk7DQoNCiAgICAgICAgICAgICAgICAvL3Njcm9sbGluZyB0aGUgcGFnZSB0byB0aGUgc2VjdGlvbiB3aXRoIG5vIGFuaW1hdGlvbg0KICAgICAgICAgICAgICAgICQoJ2h0bWwsIGJvZHknKS5zY3JvbGxUb3AoZWxlbWVudC5wb3NpdGlvbigpLnRvcCk7DQogICAgICAgICAgICB9DQoNCiAgICAgICAgfTsNCg0KICAgICAgICAvKioNCiAgICAgICAgKiBEZWZpbmVzIHRoZSBzY3JvbGxpbmcgc3BlZWQNCiAgICAgICAgKi8NCiAgICAgICAgJC5mbi5mdWxscGFnZS5zZXRTY3JvbGxpbmdTcGVlZCA9IGZ1bmN0aW9uKHZhbHVlKXsNCiAgICAgICAgICAgb3B0aW9ucy5zY3JvbGxpbmdTcGVlZCA9IHZhbHVlOw0KICAgICAgICB9Ow0KDQogICAgICAgIC8qKg0KICAgICAgICAqIEFkZHMgb3IgcmVtb3ZlIHRoZSBwb3NzaWJsaXR5IG9mIHNjcm9sbGluZyB0aHJvdWdoIHNlY3Rpb25zIGJ5IHVzaW5nIHRoZSBtb3VzZSB3aGVlbCBvciB0aGUgdHJhY2twYWQuDQogICAgICAgICovDQogICAgICAgICQuZm4uZnVsbHBhZ2Uuc2V0TW91c2VXaGVlbFNjcm9sbGluZyA9IGZ1bmN0aW9uICh2YWx1ZSl7DQogICAgICAgICAgICBpZih2YWx1ZSl7DQogICAgICAgICAgICAgICAgYWRkTW91c2VXaGVlbEhhbmRsZXIoKTsNCiAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgIHJlbW92ZU1vdXNlV2hlZWxIYW5kbGVyKCk7DQogICAgICAgICAgICB9DQogICAgICAgIH07DQoNCiAgICAgICAgLyoqDQogICAgICAgICogQWRkcyBvciByZW1vdmUgdGhlIHBvc3NpYmxpdHkgb2Ygc2Nyb2xsaW5nIHRocm91Z2ggc2VjdGlvbnMgYnkgdXNpbmcgdGhlIG1vdXNlIHdoZWVsL3RyYWNrcGFkIG9yIHRvdWNoIGdlc3R1cmVzLg0KICAgICAgICAqLw0KICAgICAgICAkLmZuLmZ1bGxwYWdlLnNldEFsbG93U2Nyb2xsaW5nID0gZnVuY3Rpb24gKHZhbHVlKXsNCiAgICAgICAgICAgIGlmKHZhbHVlKXsNCiAgICAgICAgICAgICAgICAkLmZuLmZ1bGxwYWdlLnNldE1vdXNlV2hlZWxTY3JvbGxpbmcodHJ1ZSk7DQogICAgICAgICAgICAgICAgYWRkVG91Y2hIYW5kbGVyKCk7DQogICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICAkLmZuLmZ1bGxwYWdlLnNldE1vdXNlV2hlZWxTY3JvbGxpbmcoZmFsc2UpOw0KICAgICAgICAgICAgICAgIHJlbW92ZVRvdWNoSGFuZGxlcigpOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9Ow0KDQogICAgICAgIC8qKg0KICAgICAgICAqIEFkZHMgb3IgcmVtb3ZlIHRoZSBwb3NzaWJsaXR5IG9mIHNjcm9sbGluZyB0aHJvdWdoIHNlY3Rpb25zIGJ5IHVzaW5nIHRoZSBrZXlib2FyZCBhcnJvdyBrZXlzDQogICAgICAgICovDQogICAgICAgICQuZm4uZnVsbHBhZ2Uuc2V0S2V5Ym9hcmRTY3JvbGxpbmcgPSBmdW5jdGlvbiAodmFsdWUpew0KICAgICAgICAgICAgb3B0aW9ucy5rZXlib2FyZFNjcm9sbGluZyA9IHZhbHVlOw0KICAgICAgICB9Ow0KDQogICAgICAgIC8vZmxhZyB0byBhdm9pZCB2ZXJ5IGZhc3Qgc2xpZGluZyBmb3IgbGFuZHNjYXBlIHNsaWRlcnMNCiAgICAgICAgdmFyIHNsaWRlTW92aW5nID0gZmFsc2U7DQoNCiAgICAgICAgdmFyIGlzVGFibGV0ID0gbmF2aWdhdG9yLnVzZXJBZ2VudC5tYXRjaCgvKGlQaG9uZXxpUG9kfGlQYWR8QW5kcm9pZHxCbGFja0JlcnJ5fFdpbmRvd3MgUGhvbmUpLyk7DQoNCiAgICAgICAgdmFyIHdpbmRvd3NIZWlnaHQgPSAkKHdpbmRvdykuaGVpZ2h0KCk7DQogICAgICAgIHZhciBpc01vdmluZyA9IGZhbHNlOw0KICAgICAgICB2YXIgaXNSZXNpemluZyA9IGZhbHNlOw0KICAgICAgICB2YXIgbGFzdFNjcm9sbGVkRGVzdGlueTsNCiAgICAgICAgdmFyIGxhc3RTY3JvbGxlZFNsaWRlOw0KDQogICAgICAgICQuZm4uZnVsbHBhZ2Uuc2V0QWxsb3dTY3JvbGxpbmcodHJ1ZSk7DQoNCiAgICAgICAgLy9pZiBjc3MzIGlzIG5vdCBzdXBwb3J0ZWQsIGl0IHdpbGwgdXNlIGpRdWVyeSBhbmltYXRpb25zDQogICAgICAgIGlmKG9wdGlvbnMuY3NzMyl7DQogICAgICAgICAgICBvcHRpb25zLmNzczMgPSBzdXBwb3J0M2QoKTsNCiAgICAgICAgfQ0KDQogICAgICAgICQoJ2JvZHknKS53cmFwSW5uZXIoJzxkaXYgaWQ9InN1cGVyQ29udGFpbmVyIiAvPicpOw0KDQogICAgICAgIC8vY3JlYXRpbmcgdGhlIG5hdmlnYXRpb24gZG90cw0KICAgICAgICBpZiAob3B0aW9ucy5uYXZpZ2F0aW9uKSB7DQogICAgICAgICAgICAkKCdib2R5JykuYXBwZW5kKCc8ZGl2IGlkPSJmdWxsUGFnZS1uYXYiPjx1bD48L3VsPjwvZGl2PicpOw0KICAgICAgICAgICAgdmFyIG5hdiA9ICQoJyNmdWxsUGFnZS1uYXYnKTsNCg0KICAgICAgICAgICAgbmF2LmNzcygnY29sb3InLCBvcHRpb25zLm5hdmlnYXRpb25Db2xvcik7DQogICAgICAgICAgICBuYXYuYWRkQ2xhc3Mob3B0aW9ucy5uYXZpZ2F0aW9uUG9zaXRpb24pOw0KICAgICAgICB9DQoNCiAgICAgICAgJCgnLnNlY3Rpb24nKS5lYWNoKGZ1bmN0aW9uKGluZGV4KXsNCiAgICAgICAgICAgIHZhciBzbGlkZXMgPSAkKHRoaXMpLmZpbmQoJy5zbGlkZScpOw0KICAgICAgICAgICAgdmFyIG51bVNsaWRlcyA9IHNsaWRlcy5sZW5ndGg7DQoNCiAgICAgICAgICAgIGlmIChpbmRleCA9PSBvcHRpb25zLmluaXRpYWxTbGlkZSl7DQogICAgICAgICAgICAgICAgJCh0aGlzKS5hZGRDbGFzcygnYWN0aXZlJyk7DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgICQodGhpcykuY3NzKCdoZWlnaHQnLCB3aW5kb3dzSGVpZ2h0ICsgJ3B4Jyk7DQoNCiAgICAgICAgICAgIGlmKG9wdGlvbnMucGFkZGluZ1RvcCB8fCBvcHRpb25zLnBhZGRpbmdCb3R0b20pew0KICAgICAgICAgICAgICAgICQodGhpcykuY3NzKCdwYWRkaW5nJywgb3B0aW9ucy5wYWRkaW5nVG9wICArICcgMCAnICsgb3B0aW9ucy5wYWRkaW5nQm90dG9tICsgJyAwJyk7DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIGlmICh0eXBlb2Ygb3B0aW9ucy5zbGlkZXNDb2xvcltpbmRleF0gIT09ICAndW5kZWZpbmVkJykgew0KICAgICAgICAgICAgICAgICQodGhpcykuY3NzKCdiYWNrZ3JvdW5kLWNvbG9yJywgb3B0aW9ucy5zbGlkZXNDb2xvcltpbmRleF0pOw0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICBpZiAodHlwZW9mIG9wdGlvbnMuYW5jaG9yc1tpbmRleF0gIT09ICd1bmRlZmluZWQnKSB7DQogICAgICAgICAgICAgICAgJCh0aGlzKS5hdHRyKCdkYXRhLWFuY2hvcicsIG9wdGlvbnMuYW5jaG9yc1tpbmRleF0pOw0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICBpZiAob3B0aW9ucy5uYXZpZ2F0aW9uKSB7DQogICAgICAgICAgICAgICAgdmFyIGxpbmsgPSAnJzsNCiAgICAgICAgICAgICAgICBpZihvcHRpb25zLmFuY2hvcnMubGVuZ3RoKXsNCiAgICAgICAgICAgICAgICAgICAgbGluayA9IG9wdGlvbnMuYW5jaG9yc1tpbmRleF07DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIHZhciB0b29sdGlwID0gb3B0aW9ucy5uYXZpZ2F0aW9uVG9vbHRpcHNbaW5kZXhdOw0KICAgICAgICAgICAgICAgIGlmKHR5cGVvZiB0b29sdGlwID09PSAndW5kZWZpbmVkJyl7DQogICAgICAgICAgICAgICAgICAgIHRvb2x0aXAgPSAnJzsNCiAgICAgICAgICAgICAgICB9DQoNCiAgICAgICAgICAgICAgICBuYXYuZmluZCgndWwnKS5hcHBlbmQoJzxsaSBkYXRhLXRvb2x0aXA9IicgKyB0b29sdGlwICsgJyI+PGEgaHJlZj0iIycgKyBsaW5rICsgJyI+PHNwYW4+PC9zcGFuPjwvYT48L2xpPicpOw0KICAgICAgICAgICAgfQ0KDQoNCiAgICAgICAgICAgIC8vIGlmIHRoZXJlJ3MgYW55IHNsaWRlDQogICAgICAgICAgICBpZiAobnVtU2xpZGVzID4gMCkgew0KICAgICAgICAgICAgICAgIHZhciBzbGlkZXJXaWR0aCA9IG51bVNsaWRlcyAqIDEwMDsNCiAgICAgICAgICAgICAgICB2YXIgc2xpZGVXaWR0aCA9IDEwMCAvIG51bVNsaWRlczsNCg0KICAgICAgICAgICAgICAgIHNsaWRlcy53cmFwQWxsKCc8ZGl2IGNsYXNzPSJzbGlkZXNDb250YWluZXIiIC8+Jyk7DQogICAgICAgICAgICAgICAgc2xpZGVzLnBhcmVudCgpLndyYXAoJzxkaXYgY2xhc3M9InNsaWRlcyIgLz4nKTsNCg0KICAgICAgICAgICAgICAgICQodGhpcykuZmluZCgnLnNsaWRlc0NvbnRhaW5lcicpLmNzcygnd2lkdGgnLCBzbGlkZXJXaWR0aCArICclJyk7DQogICAgICAgICAgICAgICAgJCh0aGlzKS5maW5kKCcuc2xpZGVzJykuYWZ0ZXIoJzxkaXYgY2xhc3M9ImNvbnRyb2xBcnJvdyBwcmV2Ij48L2Rpdj48ZGl2IGNsYXNzPSJjb250cm9sQXJyb3cgbmV4dCI+PC9kaXY+Jyk7DQoNCiAgICAgICAgICAgICAgICBpZihvcHRpb25zLmNvbnRyb2xBcnJvd0NvbG9yIT0nI2ZmZicpew0KICAgICAgICAgICAgICAgICAgICAkKHRoaXMpLmZpbmQoJy5jb250cm9sQXJyb3cubmV4dCcpLmNzcygnYm9yZGVyLWNvbG9yJywgJ3RyYW5zcGFyZW50IHRyYW5zcGFyZW50IHRyYW5zcGFyZW50ICcrb3B0aW9ucy5jb250cm9sQXJyb3dDb2xvcik7DQogICAgICAgICAgICAgICAgICAgICQodGhpcykuZmluZCgnLmNvbnRyb2xBcnJvdy5wcmV2JykuY3NzKCdib3JkZXItY29sb3InLCAndHJhbnNwYXJlbnQgJysgb3B0aW9ucy5jb250cm9sQXJyb3dDb2xvciArICcgdHJhbnNwYXJlbnQgdHJhbnNwYXJlbnQnKTsNCiAgICAgICAgICAgICAgICB9DQoNCiAgICAgICAgICAgICAgICBpZighb3B0aW9ucy5sb29wSG9yaXpvbnRhbCl7DQogICAgICAgICAgICAgICAgICAgICQodGhpcykuZmluZCgnLmNvbnRyb2xBcnJvdy5wcmV2JykuaGlkZSgpOw0KICAgICAgICAgICAgICAgIH0NCg0KDQogICAgICAgICAgICAgICAgaWYob3B0aW9ucy5zbGlkZXNOYXZpZ2F0aW9uKXsNCiAgICAgICAgICAgICAgICAgICAgYWRkU2xpZGVzTmF2aWdhdGlvbigkKHRoaXMpLCBudW1TbGlkZXMpOw0KICAgICAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgICAgIHNsaWRlcy5lYWNoKGZ1bmN0aW9uKGluZGV4KSB7DQogICAgICAgICAgICAgICAgICAgIGlmKCFpbmRleCl7DQogICAgICAgICAgICAgICAgICAgICAgICAkKHRoaXMpLmFkZENsYXNzKCdhY3RpdmUnKTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAgICAgICAgICQodGhpcykuY3NzKCd3aWR0aCcsIHNsaWRlV2lkdGggKyAnJScpOw0KDQogICAgICAgICAgICAgICAgICAgIGlmKG9wdGlvbnMudmVydGljYWxDZW50ZXJlZCl7DQogICAgICAgICAgICAgICAgICAgICAgICBhZGRUYWJsZUNsYXNzKCQodGhpcykpOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgfSk7DQogICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICBpZihvcHRpb25zLnZlcnRpY2FsQ2VudGVyZWQpew0KICAgICAgICAgICAgICAgICAgICBhZGRUYWJsZUNsYXNzKCQodGhpcykpOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0NCg0KDQoNCg0KICAgICAgICB9KS5wcm9taXNlKCkuZG9uZShmdW5jdGlvbigpew0KICAgICAgICAgICAgJC5mbi5mdWxscGFnZS5zZXRBdXRvU2Nyb2xsaW5nKG9wdGlvbnMuYXV0b1Njcm9sbGluZyk7DQoNCiAgICAgICAgICAgICQuaXNGdW5jdGlvbiggb3B0aW9ucy5hZnRlclJlbmRlciApICYmIG9wdGlvbnMuYWZ0ZXJSZW5kZXIuY2FsbCggdGhpcyk7DQoNCiAgICAgICAgICAgIC8vZml4ZWQgZWxlbWVudHMgbmVlZCB0byBiZSBtb3ZlZCBvdXQgb2YgdGhlIHBsdWdpbiBjb250YWluZXIgZHVlIHRvIHByb2JsZW1zIHdpdGggQ1NTMy4NCiAgICAgICAgICAgIGlmKG9wdGlvbnMuZml4ZWRFbGVtZW50cyAmJiBvcHRpb25zLmNzczMpew0KICAgICAgICAgICAgICAgICQob3B0aW9ucy5maXhlZEVsZW1lbnRzKS5hcHBlbmRUbygnYm9keScpOw0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAvL3ZlcnRpY2FsIGNlbnRlcmVkIG9mIHRoZSBuYXZpZ2F0aW9uICsgZmlyc3QgYnVsbGV0IGFjdGl2ZQ0KICAgICAgICAgICAgaWYob3B0aW9ucy5uYXZpZ2F0aW9uKXsNCiAgICAgICAgICAgICAgICBuYXYuY3NzKCdtYXJnaW4tdG9wJywgJy0nICsgKG5hdi5oZWlnaHQoKS8yKSArICdweCcpOw0KICAgICAgICAgICAgICAgIG5hdi5maW5kKCdsaScpLmZpcnN0KCkuZmluZCgnYScpLmFkZENsYXNzKCdhY3RpdmUnKTsNCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgLy9tb3ZpbmcgdGhlIG1lbnUgb3V0c2lkZSB0aGUgbWFpbiBjb250YWluZXIgKGF2b2lkIHByb2JsZW1zIHdpdGggZml4ZWQgcG9zaXRpb25zIHdoZW4gdXNpbmcgQ1NTMyB0cmFuZm9ybXMpDQogICAgICAgICAgICBpZihvcHRpb25zLm1lbnUgJiYgb3B0aW9ucy5jc3MzKXsNCiAgICAgICAgICAgICAgICAkKG9wdGlvbnMubWVudSkuYXBwZW5kVG8oJ2JvZHknKTsNCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgaWYob3B0aW9ucy5zY3JvbGxPdmVyZmxvdyl7DQogICAgICAgICAgICAgICAgLy9hZnRlciBET00gYW5kIGltYWdlcyBhcmUgbG9hZGVkDQogICAgICAgICAgICAgICAgJCh3aW5kb3cpLm9uKCdsb2FkJywgZnVuY3Rpb24oKSB7DQoNCiAgICAgICAgICAgICAgICAgICAgJCgnLnNlY3Rpb24nKS5lYWNoKGZ1bmN0aW9uKCl7DQogICAgICAgICAgICAgICAgICAgICAgICB2YXIgc2xpZGVzID0gJCh0aGlzKS5maW5kKCcuc2xpZGUnKTsNCg0KICAgICAgICAgICAgICAgICAgICAgICAgaWYoc2xpZGVzLmxlbmd0aCl7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2xpZGVzLmVhY2goZnVuY3Rpb24oKXsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3JlYXRlU2xpbVNjcm9sbGluZygkKHRoaXMpKTsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsNCiAgICAgICAgICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNyZWF0ZVNsaW1TY3JvbGxpbmcoJCh0aGlzKSk7DQogICAgICAgICAgICAgICAgICAgICAgICB9DQoNCiAgICAgICAgICAgICAgICAgICAgfSk7DQogICAgICAgICAgICAgICAgfSk7DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIGlmIChvcHRpb25zLmhhc2hDaGFuZ2UpIHsNCiAgICAgICAgICAgICAgICAvL2dldHRpbmcgdGhlIGFuY2hvciBsaW5rIGluIHRoZSBVUkwgYW5kIGRlbGV0aW5nIHRoZSBgI2ANCiAgICAgICAgICAgICAgICB2YXIgdmFsdWUgPSAgd2luZG93LmxvY2F0aW9uLmhhc2gucmVwbGFjZSgnIycsICcnKS5zcGxpdCgnLycpOw0KICAgICAgICAgICAgICAgIHZhciBkZXN0aW55ID0gdmFsdWVbMF07DQoNCiAgICAgICAgICAgICAgICBpZihkZXN0aW55Lmxlbmd0aCl7DQogICAgICAgICAgICAgICAgICAgIHZhciBzZWN0aW9uID0gJCgnW2RhdGEtYW5jaG9yPSInK2Rlc3RpbnkrJyJdJyk7DQoNCiAgICAgICAgICAgICAgICAgICAgaWYoIW9wdGlvbnMuYW5pbWF0ZUFuY2hvciAmJiBzZWN0aW9uLmxlbmd0aCl7DQogICAgICAgICAgICAgICAgICAgICAgICBzaWxlbnRTY3JvbGwoc2VjdGlvbi5wb3NpdGlvbigpLnRvcCk7DQoNCiAgICAgICAgICAgICAgICAgICAgICAgIC8vdXBkYXRpbmcgdGhlIGFjdGl2ZSBjbGFzcw0KICAgICAgICAgICAgICAgICAgICAgICAgc2VjdGlvbi5hZGRDbGFzcygnYWN0aXZlJykuc2libGluZ3MoKS5yZW1vdmVDbGFzcygnYWN0aXZlJyk7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9DQoNCiAgICAgICAgICAgICAgICAkKHdpbmRvdykub24oJ2xvYWQnLCBmdW5jdGlvbigpIHsNCiAgICAgICAgICAgICAgICAgICAgc2Nyb2xsVG9BbmNob3IoKTsNCiAgICAgICAgICAgICAgICB9KTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfSk7DQoNCiAgICAgICAgdmFyIHNjcm9sbElkOw0KICAgICAgICB2YXIgaXNTY3JvbGxpbmcgPSBmYWxzZTsNCg0KICAgICAgICAvL3doZW4gc2Nyb2xsaW5nLi4uDQogICAgICAgICQod2luZG93KS5zY3JvbGwoZnVuY3Rpb24oZSl7DQoNCiAgICAgICAgICAgIGlmKCFvcHRpb25zLmF1dG9TY3JvbGxpbmcpew0KICAgICAgICAgICAgICAgIHZhciBjdXJyZW50U2Nyb2xsID0gJCh3aW5kb3cpLnNjcm9sbFRvcCgpOw0KDQogICAgICAgICAgICAgICAgdmFyIHNjcm9sbGVkU2VjdGlvbnMgPSAkKCcuc2VjdGlvbicpLm1hcChmdW5jdGlvbigpew0KICAgICAgICAgICAgICAgICAgICBpZiAoJCh0aGlzKS5vZmZzZXQoKS50b3AgPCAoY3VycmVudFNjcm9sbCArIDEwMCkpew0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICQodGhpcyk7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9KTsNCg0KICAgICAgICAgICAgICAgIC8vZ2V0aW5nIHRoZSBsYXN0IG9uZSwgdGhlIGN1cnJlbnQgb25lIG9uIHRoZSBzY3JlZW4NCiAgICAgICAgICAgICAgICB2YXIgY3VycmVudFNlY3Rpb24gPSBzY3JvbGxlZFNlY3Rpb25zW3Njcm9sbGVkU2VjdGlvbnMubGVuZ3RoLTFdOw0KDQogICAgICAgICAgICAgICAgLy9leGVjdXRpbmcgb25seSBvbmNlIHRoZSBmaXJzdCB0aW1lIHdlIHJlYWNoIHRoZSBzZWN0aW9uDQogICAgICAgICAgICAgICAgaWYoIWN1cnJlbnRTZWN0aW9uLmhhc0NsYXNzKCdhY3RpdmUnKSl7DQogICAgICAgICAgICAgICAgICAgIGlzU2Nyb2xsaW5nID0gdHJ1ZTsNCg0KICAgICAgICAgICAgICAgICAgICB2YXIgeU1vdmVtZW50ID0gZ2V0WW1vdmVtZW50KGN1cnJlbnRTZWN0aW9uKTsNCg0KICAgICAgICAgICAgICAgICAgICAkKCcuc2VjdGlvbi5hY3RpdmUnKS5yZW1vdmVDbGFzcygnYWN0aXZlJyk7DQogICAgICAgICAgICAgICAgICAgIGN1cnJlbnRTZWN0aW9uLmFkZENsYXNzKCdhY3RpdmUnKTsNCg0KICAgICAgICAgICAgICAgICAgICB2YXIgYW5jaG9yTGluayAgPSBjdXJyZW50U2VjdGlvbi5kYXRhKCdhbmNob3InKTsNCiAgICAgICAgICAgICAgICAgICAgJC5pc0Z1bmN0aW9uKCBvcHRpb25zLm9uTGVhdmUgKSAmJiBvcHRpb25zLm9uTGVhdmUuY2FsbCggdGhpcywgY3VycmVudFNlY3Rpb24uaW5kZXgoJy5zZWN0aW9uJyksIHlNb3ZlbWVudCk7DQoNCiAgICAgICAgICAgICAgICAgICAgJC5pc0Z1bmN0aW9uKCBvcHRpb25zLmFmdGVyTG9hZCApICYmIG9wdGlvbnMuYWZ0ZXJMb2FkLmNhbGwoIHRoaXMsIGFuY2hvckxpbmssIChjdXJyZW50U2VjdGlvbi5pbmRleCgnLnNlY3Rpb24nKSArIDEpKTsNCg0KICAgICAgICAgICAgICAgICAgICBhY3RpdmF0ZU1lbnVFbGVtZW50KGFuY2hvckxpbmspOw0KICAgICAgICAgICAgICAgICAgICBhY3RpdmF0ZU5hdkRvdHMoYW5jaG9yTGluaywgMCk7DQoNCg0KICAgICAgICAgICAgICAgICAgICBpZihvcHRpb25zLmFuY2hvcnMubGVuZ3RoICYmICFpc01vdmluZyAmJiBvcHRpb25zLmhhc2hDaGFuZ2Upew0KICAgICAgICAgICAgICAgICAgICAgICAgLy9uZWVkZWQgdG8gZW50ZXIgaW4gaGFzaENoYW5nZSBldmVudCB3aGVuIHVzaW5nIHRoZSBtZW51IHdpdGggYW5jaG9yIGxpbmtzDQogICAgICAgICAgICAgICAgICAgICAgICBsYXN0U2Nyb2xsZWREZXN0aW55ID0gYW5jaG9yTGluazsNCg0KICAgICAgICAgICAgICAgICAgICAgICAgbG9jYXRpb24uaGFzaCA9IGFuY2hvckxpbms7DQogICAgICAgICAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgICAgICAgICAvL3NtYWxsIHRpbWVvdXQgaW4gb3JkZXIgdG8gYXZvaWQgZW50ZXJpbmcgaW4gaGFzaENoYW5nZSBldmVudCB3aGVuIHNjcm9sbGluZyBpcyBub3QgZmluaXNoZWQgeWV0DQogICAgICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dChzY3JvbGxJZCk7DQogICAgICAgICAgICAgICAgICAgIHNjcm9sbElkID0gc2V0VGltZW91dChmdW5jdGlvbigpew0KICAgICAgICAgICAgICAgICAgICAgICAgaXNTY3JvbGxpbmcgPSBmYWxzZTsNCiAgICAgICAgICAgICAgICAgICAgfSwgMTAwKTsNCiAgICAgICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIH0NCiAgICAgICAgfSk7DQoNCg0KDQoNCiAgICAgICAgdmFyIHRvdWNoU3RhcnRZID0gMDsNCiAgICAgICAgdmFyIHRvdWNoU3RhcnRYID0gMDsNCiAgICAgICAgdmFyIHRvdWNoRW5kWSA9IDA7DQogICAgICAgIHZhciB0b3VjaEVuZFggPSAwOw0KDQogICAgICAgIC8qIERldGVjdGluZyB0b3VjaCBldmVudHMNCg0KICAgICAgICAqIEFzIHdlIGFyZSBjaGFuZ2luZyB0aGUgdG9wIHByb3BlcnR5IG9mIHRoZSBwYWdlIG9uIHNjcm9sbGluZywgd2UgY2FuIG5vdCB1c2UgdGhlIHRyYWRpdGlvbmFsIHdheSB0byBkZXRlY3QgaXQuDQogICAgICAgICogVGhpcyB3YXksIHRoZSB0b3VjaHN0YXJ0IGFuZCB0aGUgdG91Y2ggbW92ZXMgc2hvd3MgYW4gc21hbGwgZGlmZmVyZW5jZSBiZXR3ZWVuIHRoZW0gd2hpY2ggaXMgdGhlDQogICAgICAgICogdXNlZCBvbmUgdG8gZGV0ZXJtaW5lIHRoZSBkaXJlY3Rpb24uDQogICAgICAgICovDQogICAgICAgIGZ1bmN0aW9uIHRvdWNoTW92ZUhhbmRsZXIoZXZlbnQpew0KDQogICAgICAgICAgICBpZihvcHRpb25zLmF1dG9TY3JvbGxpbmcpew0KICAgICAgICAgICAgICAgIC8vcHJldmVudGluZyB0aGUgZWFzaW5nIG9uIGlPUyBkZXZpY2VzDQogICAgICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsNCg0KICAgICAgICAgICAgICAgIHZhciBlID0gZXZlbnQub3JpZ2luYWxFdmVudDsNCg0KICAgICAgICAgICAgICAgIHZhciB0b3VjaE1vdmVkID0gZmFsc2U7DQogICAgICAgICAgICAgICAgdmFyIGFjdGl2ZVNlY3Rpb24gPSAkKCcuc2VjdGlvbi5hY3RpdmUnKTsNCiAgICAgICAgICAgICAgICB2YXIgc2Nyb2xsYWJsZTsNCg0KICAgICAgICAgICAgICAgIGlmICghaXNNb3ZpbmcgJiYgIXNsaWRlTW92aW5nKSB7IC8vaWYgdGhlcmVzIGFueSAjDQogICAgICAgICAgICAgICAgICAgIHZhciB0b3VjaEV2ZW50cyA9IGdldEV2ZW50c1BhZ2UoZSk7DQogICAgICAgICAgICAgICAgICAgIHRvdWNoRW5kWSA9IHRvdWNoRXZlbnRzWyd5J107DQogICAgICAgICAgICAgICAgICAgIHRvdWNoRW5kWCA9IHRvdWNoRXZlbnRzWyd4J107DQoNCiAgICAgICAgICAgICAgICAgICAgLy9pZiBtb3ZlbWVudCBpbiB0aGUgWCBheHlzIGlzIGdyZWF0ZXIgdGhhbiBpbiB0aGUgWSBhbmQgdGhlIGN1cnJlY3Qgc2VjdGlvbiBoYXMgc2xpZGVzLi4uDQogICAgICAgICAgICAgICAgICAgIGlmIChhY3RpdmVTZWN0aW9uLmZpbmQoJy5zbGlkZXMnKS5sZW5ndGggJiYgTWF0aC5hYnModG91Y2hTdGFydFggLSB0b3VjaEVuZFgpID4gKE1hdGguYWJzKHRvdWNoU3RhcnRZIC0gdG91Y2hFbmRZKSkpIHsNCg0KICAgICAgICAgICAgICAgICAgICAgICAgLy9pcyB0aGUgbW92ZW1lbnQgZ3JlYXRlciB0aGFuIHRoZSBtaW5pbXVtIHJlc2lzdGFuY2UgdG8gc2Nyb2xsPw0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKE1hdGguYWJzKHRvdWNoU3RhcnRYIC0gdG91Y2hFbmRYKSA+ICgkKHdpbmRvdykud2lkdGgoKSAvIDEwMCAqIG9wdGlvbnMudG91Y2hTZW5zaXRpdml0eSkpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodG91Y2hTdGFydFggPiB0b3VjaEVuZFgpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFjdGl2ZVNlY3Rpb24uZmluZCgnLmNvbnRyb2xBcnJvdy5uZXh0OnZpc2libGUnKS50cmlnZ2VyKCdjbGljaycpOw0KDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWN0aXZlU2VjdGlvbi5maW5kKCcuY29udHJvbEFycm93LnByZXY6dmlzaWJsZScpLnRyaWdnZXIoJ2NsaWNrJyk7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICB9DQoNCiAgICAgICAgICAgICAgICAgICAgLy92ZXJ0aWNhbCBzY3JvbGxpbmcNCiAgICAgICAgICAgICAgICAgICAgZWxzZXsNCiAgICAgICAgICAgICAgICAgICAgICAgIC8vaWYgdGhlcmUgYXJlIGxhbmRzY2FwZSBzbGlkZXMsIHdlIGNoZWNrIGlmIHRoZSBzY3JvbGxpbmcgYmFyIGlzIGluIHRoZSBjdXJyZW50IG9uZSBvciBub3QNCiAgICAgICAgICAgICAgICAgICAgICAgIGlmKGFjdGl2ZVNlY3Rpb24uZmluZCgnLnNsaWRlcycpLmxlbmd0aCl7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2Nyb2xsYWJsZT0gYWN0aXZlU2VjdGlvbi5maW5kKCcuc2xpZGUuYWN0aXZlJykuZmluZCgnLnNjcm9sbGFibGUnKTsNCiAgICAgICAgICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjcm9sbGFibGUgPSBhY3RpdmVTZWN0aW9uLmZpbmQoJy5zY3JvbGxhYmxlJyk7DQogICAgICAgICAgICAgICAgICAgICAgICB9DQoNCiAgICAgICAgICAgICAgICAgICAgICAgIC8vaXMgdGhlIG1vdmVtZW50IGdyZWF0ZXIgdGhhbiB0aGUgbWluaW11bSByZXNpc3RhbmNlIHRvIHNjcm9sbD8NCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChNYXRoLmFicyh0b3VjaFN0YXJ0WSAtIHRvdWNoRW5kWSkgPiAoJCh3aW5kb3cpLmhlaWdodCgpIC8gMTAwICogb3B0aW9ucy50b3VjaFNlbnNpdGl2aXR5KSkgew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0b3VjaFN0YXJ0WSA+IHRvdWNoRW5kWSkgew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihzY3JvbGxhYmxlLmxlbmd0aCA+IDAgKXsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vaXMgdGhlIHNjcm9sbGJhciBhdCB0aGUgZW5kIG9mIHRoZSBzY3JvbGw/DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihpc1Njcm9sbGVkKCdib3R0b20nLCBzY3JvbGxhYmxlKSl7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJC5mbi5mdWxscGFnZS5tb3ZlU2VjdGlvbkRvd24oKTsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIG1vdmVkIGRvd24NCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICQuZm4uZnVsbHBhZ2UubW92ZVNlY3Rpb25Eb3duKCk7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRvdWNoRW5kWSA+IHRvdWNoU3RhcnRZKSB7DQoNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoc2Nyb2xsYWJsZS5sZW5ndGggPiAwKXsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vaXMgdGhlIHNjcm9sbGJhciBhdCB0aGUgc3RhcnQgb2YgdGhlIHNjcm9sbD8NCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKGlzU2Nyb2xsZWQoJ3RvcCcsIHNjcm9sbGFibGUpKXsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkLmZuLmZ1bGxwYWdlLm1vdmVTZWN0aW9uVXAoKTsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2V7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gbW92ZWQgdXANCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICQuZm4uZnVsbHBhZ2UubW92ZVNlY3Rpb25VcCgpOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQoNCiAgICAgICAgZnVuY3Rpb24gdG91Y2hTdGFydEhhbmRsZXIoZXZlbnQpew0KDQogICAgICAgICAgICBpZihvcHRpb25zLmF1dG9TY3JvbGxpbmcpew0KICAgICAgICAgICAgICAgIHZhciBlID0gZXZlbnQub3JpZ2luYWxFdmVudDsNCiAgICAgICAgICAgICAgICB2YXIgdG91Y2hFdmVudHMgPSBnZXRFdmVudHNQYWdlKGUpOw0KICAgICAgICAgICAgICAgIHRvdWNoU3RhcnRZID0gdG91Y2hFdmVudHNbJ3knXTsNCiAgICAgICAgICAgICAgICB0b3VjaFN0YXJ0WCA9IHRvdWNoRXZlbnRzWyd4J107DQogICAgICAgICAgICB9DQogICAgICAgIH0NCg0KDQoNCiAgICAgICAgLyoqDQogICAgICAgICAqIERldGVjdGluZyBtb3VzZXdoZWVsIHNjcm9sbGluZw0KICAgICAgICAgKg0KICAgICAgICAgKiBodHRwOi8vYmxvZ3Muc2l0ZXBvaW50c3RhdGljLmNvbS9leGFtcGxlcy90ZWNoL21vdXNlLXdoZWVsL2luZGV4Lmh0bWwNCiAgICAgICAgICogaHR0cDovL3d3dy5zaXRlcG9pbnQuY29tL2h0bWw1LWphdmFzY3JpcHQtbW91c2Utd2hlZWwvDQogICAgICAgICAqLw0KICAgICAgICBmdW5jdGlvbiBNb3VzZVdoZWVsSGFuZGxlcihlKSB7DQogICAgICAgICAgICBpZihvcHRpb25zLmF1dG9TY3JvbGxpbmcpew0KICAgICAgICAgICAgICAgIC8vIGNyb3NzLWJyb3dzZXIgd2hlZWwgZGVsdGENCiAgICAgICAgICAgICAgICBlID0gd2luZG93LmV2ZW50IHx8IGU7DQogICAgICAgICAgICAgICAgdmFyIGRlbHRhID0gTWF0aC5tYXgoLTEsIE1hdGgubWluKDEsDQogICAgICAgICAgICAgICAgICAgICAgICAoZS53aGVlbERlbHRhIHx8IC1lLmRldGFpbCkpKTsNCiAgICAgICAgICAgICAgICB2YXIgc2Nyb2xsYWJsZTsNCiAgICAgICAgICAgICAgICB2YXIgYWN0aXZlU2VjdGlvbiA9ICQoJy5zZWN0aW9uLmFjdGl2ZScpOw0KDQogICAgICAgICAgICAgICAgaWYgKCFpc01vdmluZykgeyAvL2lmIHRoZXJlcyBhbnkgIw0KDQogICAgICAgICAgICAgICAgICAgIC8vaWYgdGhlcmUgYXJlIGxhbmRzY2FwZSBzbGlkZXMsIHdlIGNoZWNrIGlmIHRoZSBzY3JvbGxpbmcgYmFyIGlzIGluIHRoZSBjdXJyZW50IG9uZSBvciBub3QNCiAgICAgICAgICAgICAgICAgICAgaWYoYWN0aXZlU2VjdGlvbi5maW5kKCcuc2xpZGVzJykubGVuZ3RoKXsNCiAgICAgICAgICAgICAgICAgICAgICAgIHNjcm9sbGFibGU9IGFjdGl2ZVNlY3Rpb24uZmluZCgnLnNsaWRlLmFjdGl2ZScpLmZpbmQoJy5zY3JvbGxhYmxlJyk7DQogICAgICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICAgICAgc2Nyb2xsYWJsZSA9IGFjdGl2ZVNlY3Rpb24uZmluZCgnLnNjcm9sbGFibGUnKTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAgICAgICAgIC8vc2Nyb2xsaW5nIGRvd24/DQogICAgICAgICAgICAgICAgICAgIGlmIChkZWx0YSA8IDApIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHNjcm9sbGFibGUubGVuZ3RoID4gMCApew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vaXMgdGhlIHNjcm9sbGJhciBhdCB0aGUgZW5kIG9mIHRoZSBzY3JvbGw/DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoaXNTY3JvbGxlZCgnYm90dG9tJywgc2Nyb2xsYWJsZSkpew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkLmZuLmZ1bGxwYWdlLm1vdmVTZWN0aW9uRG93bigpOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsgLy9ub3JtYWwgc2Nyb2xsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgJC5mbi5mdWxscGFnZS5tb3ZlU2VjdGlvbkRvd24oKTsNCiAgICAgICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAgICAgICAgIC8vc2Nyb2xsaW5nIHVwPw0KICAgICAgICAgICAgICAgICAgICBlbHNlIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHNjcm9sbGFibGUubGVuZ3RoID4gMCl7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy9pcyB0aGUgc2Nyb2xsYmFyIGF0IHRoZSBzdGFydCBvZiB0aGUgc2Nyb2xsPw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKGlzU2Nyb2xsZWQoJ3RvcCcsIHNjcm9sbGFibGUpKXsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJC5mbi5mdWxscGFnZS5tb3ZlU2VjdGlvblVwKCk7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOyAvL25vcm1hbCBzY3JvbGwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkLmZuLmZ1bGxwYWdlLm1vdmVTZWN0aW9uVXAoKTsNCiAgICAgICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KDQoNCiAgICAgICAgJC5mbi5mdWxscGFnZS5tb3ZlU2VjdGlvblVwID0gZnVuY3Rpb24oKXsNCiAgICAgICAgICAgIHZhciBwcmV2ID0gJCgnLnNlY3Rpb24uYWN0aXZlJykucHJldignLnNlY3Rpb24nKTsNCg0KICAgICAgICAgICAgLy9sb29waW5nIHRvIHRoZSBib3R0b20gaWYgdGhlcmUncyBubyBtb3JlIHNlY3Rpb25zIGFib3ZlDQogICAgICAgICAgICBpZiAoIXByZXYubGVuZ3RoICYmIChvcHRpb25zLmxvb3BUb3AgfHwgb3B0aW9ucy5jb250aW51b3VzVmVydGljYWwpKSB7DQogICAgICAgICAgICAgICAgcHJldiA9ICQoJy5zZWN0aW9uJykubGFzdCgpOw0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICBpZiAocHJldi5sZW5ndGgpIHsNCiAgICAgICAgICAgICAgICBzY3JvbGxQYWdlKHByZXYsIG51bGwsIHRydWUpOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9Ow0KDQogICAgICAgICQuZm4uZnVsbHBhZ2UubW92ZVNlY3Rpb25Eb3duID0gZnVuY3Rpb24gKCl7DQogICAgICAgICAgICB2YXIgbmV4dCA9ICQoJy5zZWN0aW9uLmFjdGl2ZScpLm5leHQoJy5zZWN0aW9uJyk7DQoNCiAgICAgICAgICAgIC8vbG9vcGluZyB0byB0aGUgdG9wIGlmIHRoZXJlJ3Mgbm8gbW9yZSBzZWN0aW9ucyBiZWxvdw0KICAgICAgICAgICAgaWYoIW5leHQubGVuZ3RoICYmDQogICAgICAgICAgICAgICAgKG9wdGlvbnMubG9vcEJvdHRvbSB8fCBvcHRpb25zLmNvbnRpbnVvdXNWZXJ0aWNhbCkpew0KICAgICAgICAgICAgICAgIG5leHQgPSAkKCcuc2VjdGlvbicpLmZpcnN0KCk7DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIGlmKG5leHQubGVuZ3RoID4gMCB8fA0KICAgICAgICAgICAgICAgICghbmV4dC5sZW5ndGggJiYNCiAgICAgICAgICAgICAgICAob3B0aW9ucy5sb29wQm90dG9tIHx8IG9wdGlvbnMuY29udGludW91c1ZlcnRpY2FsKSkpew0KICAgICAgICAgICAgICAgIHNjcm9sbFBhZ2UobmV4dCwgbnVsbCwgZmFsc2UpOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9Ow0KDQogICAgICAgICQuZm4uZnVsbHBhZ2UubW92ZVRvID0gZnVuY3Rpb24gKHNlY3Rpb24sIHNsaWRlKXsNCiAgICAgICAgICAgIHZhciBkZXN0aW55ID0gJyc7DQoNCiAgICAgICAgICAgIGlmKGlzTmFOKHNlY3Rpb24pKXsNCiAgICAgICAgICAgICAgICBkZXN0aW55ID0gJCgnW2RhdGEtYW5jaG9yPSInK3NlY3Rpb24rJyJdJyk7DQogICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICBkZXN0aW55ID0gJCgnLnNlY3Rpb24nKS5lcSggKHNlY3Rpb24gLTEpICk7DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIGlmIChzbGlkZSAhPT0gJ3VuZGVmaW5lZCcpew0KICAgICAgICAgICAgICAgIHNjcm9sbFBhZ2VBbmRTbGlkZShzZWN0aW9uLCBzbGlkZSk7DQogICAgICAgICAgICB9ZWxzZSBpZihkZXN0aW55Lmxlbmd0aCA+IDApew0KICAgICAgICAgICAgICAgIHNjcm9sbFBhZ2UoZGVzdGlueSk7DQogICAgICAgICAgICB9DQogICAgICAgIH07DQoNCiAgICAgICAgZnVuY3Rpb24gc2Nyb2xsUGFnZShlbGVtZW50LCBjYWxsYmFjaywgaXNNb3ZlbWVudFVwKXsNCiAgICAgICAgICAgIHZhciBzY3JvbGxPcHRpb25zID0ge30sIHNjcm9sbGVkRWxlbWVudDsNCiAgICAgICAgICAgIHZhciBkZXN0ID0gZWxlbWVudC5wb3NpdGlvbigpOw0KICAgICAgICAgICAgaWYodHlwZW9mIGRlc3QgPT09ICJ1bmRlZmluZWQiKXsgcmV0dXJuOyB9IC8vdGhlcmUncyBubyBlbGVtZW50IHRvIHNjcm9sbCwgbGVhdmluZyB0aGUgZnVuY3Rpb24NCiAgICAgICAgICAgIHZhciBkdG9wID0gZGVzdC50b3A7DQogICAgICAgICAgICB2YXIgeU1vdmVtZW50ID0gZ2V0WW1vdmVtZW50KGVsZW1lbnQpOw0KICAgICAgICAgICAgdmFyIGFuY2hvckxpbmsgID0gZWxlbWVudC5kYXRhKCdhbmNob3InKTsNCiAgICAgICAgICAgIHZhciBzZWN0aW9uSW5kZXggPSBlbGVtZW50LmluZGV4KCcuc2VjdGlvbicpOw0KICAgICAgICAgICAgdmFyIGFjdGl2ZVNsaWRlID0gZWxlbWVudC5maW5kKCcuc2xpZGUuYWN0aXZlJyk7DQogICAgICAgICAgICB2YXIgYWN0aXZlU2VjdGlvbiA9ICQoJy5zZWN0aW9uLmFjdGl2ZScpOw0KDQogICAgICAgICAgICBpZihhY3RpdmVTbGlkZS5sZW5ndGgpew0KICAgICAgICAgICAgICAgIHZhciBzbGlkZUFuY2hvckxpbmsgPSBhY3RpdmVTbGlkZS5kYXRhKCdhbmNob3InKTsNCiAgICAgICAgICAgICAgICB2YXIgc2xpZGVJbmRleCA9IGFjdGl2ZVNsaWRlLmluZGV4KCk7DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIC8vIElmIGNvbnRpbnVvdXNWZXJ0aWNhbCAmJiB3ZSBuZWVkIHRvIHdyYXAgYXJvdW5kDQogICAgICAgICAgICBpZiAob3B0aW9ucy5hdXRvU2Nyb2xsaW5nICYmIG9wdGlvbnMuY29udGludW91c1ZlcnRpY2FsICYmIHR5cGVvZiAoaXNNb3ZlbWVudFVwKSAhPT0gInVuZGVmaW5lZCIgJiYNCiAgICAgICAgICAgICAgICAoKCFpc01vdmVtZW50VXAgJiYgeU1vdmVtZW50ID09ICd1cCcpIHx8IC8vIEludGVuZGluZyB0byBzY3JvbGwgZG93biBidXQgYWJvdXQgdG8gZ28gdXAgb3INCiAgICAgICAgICAgICAgICAoaXNNb3ZlbWVudFVwICYmIHlNb3ZlbWVudCA9PSAnZG93bicpKSkgeyAvLyBpbnRlbmRpbmcgdG8gc2Nyb2xsIHVwIGJ1dCBhYm91dCB0byBnbyBkb3duDQoNCiAgICAgICAgICAgICAgICAvLyBTY3JvbGxpbmcgZG93bg0KICAgICAgICAgICAgICAgIGlmICghaXNNb3ZlbWVudFVwKSB7DQogICAgICAgICAgICAgICAgICAgIC8vIE1vdmUgYWxsIHByZXZpb3VzIHNlY3Rpb25zIHRvIGFmdGVyIHRoZSBhY3RpdmUgc2VjdGlvbg0KICAgICAgICAgICAgICAgICAgICAkKCIuc2VjdGlvbi5hY3RpdmUiKS5hZnRlcihhY3RpdmVTZWN0aW9uLnByZXZBbGwoIi5zZWN0aW9uIikuZ2V0KCkucmV2ZXJzZSgpKTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgZWxzZSB7IC8vIFNjcm9sbGluZyB1cA0KICAgICAgICAgICAgICAgICAgICAvLyBNb3ZlIGFsbCBuZXh0IHNlY3Rpb25zIHRvIGJlZm9yZSB0aGUgYWN0aXZlIHNlY3Rpb24NCiAgICAgICAgICAgICAgICAgICAgJCgiLnNlY3Rpb24uYWN0aXZlIikuYmVmb3JlKGFjdGl2ZVNlY3Rpb24ubmV4dEFsbCgiLnNlY3Rpb24iKSk7DQogICAgICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAgICAgLy8gTWFpbnRhaW4gdGhlIGRpc3BsYXllZCBwb3NpdGlvbiAobm93IHRoYXQgd2UgY2hhbmdlZCB0aGUgZWxlbWVudCBvcmRlcikNCiAgICAgICAgICAgICAgICBzaWxlbnRTY3JvbGwoJCgnLnNlY3Rpb24uYWN0aXZlJykucG9zaXRpb24oKS50b3ApOw0KDQogICAgICAgICAgICAgICAgLy8gc2F2ZSBmb3IgbGF0ZXIgdGhlIGVsZW1lbnRzIHRoYXQgc3RpbGwgbmVlZCB0byBiZSByZW9yZGVyZWQNCiAgICAgICAgICAgICAgICB2YXIgd3JhcEFyb3VuZEVsZW1lbnRzID0gYWN0aXZlU2VjdGlvbjsNCg0KICAgICAgICAgICAgICAgIC8vIFJlY2FsY3VsYXRlIGFuaW1hdGlvbiB2YXJpYWJsZXMNCiAgICAgICAgICAgICAgICBkZXN0ID0gZWxlbWVudC5wb3NpdGlvbigpOw0KICAgICAgICAgICAgICAgIGR0b3AgPSBkZXN0LnRvcDsNCiAgICAgICAgICAgICAgICB5TW92ZW1lbnQgPSBnZXRZbW92ZW1lbnQoZWxlbWVudCk7DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIHZhciBsZWF2aW5nU2VjdGlvbiA9IGFjdGl2ZVNlY3Rpb24uaW5kZXgoJy5zZWN0aW9uJykgKyAxOw0KDQogICAgICAgICAgICBlbGVtZW50LmFkZENsYXNzKCdhY3RpdmUnKS5zaWJsaW5ncygpLnJlbW92ZUNsYXNzKCdhY3RpdmUnKTsNCg0KICAgICAgICAgICAgLy9wcmV2ZW50aW5nIGZyb20gYWN0aXZhdGluZyB0aGUgTW91c2VXaGVlbEhhbmRsZXIgZXZlbnQNCiAgICAgICAgICAgIC8vbW9yZSB0aGFuIG9uY2UgaWYgdGhlIHBhZ2UgaXMgc2Nyb2xsaW5nDQogICAgICAgICAgICBpc01vdmluZyA9IHRydWU7DQoNCiAgICAgICAgICAgIGlmKHR5cGVvZiBhbmNob3JMaW5rICE9PSAndW5kZWZpbmVkJyl7DQogICAgICAgICAgICAgICAgc2V0VVJMSGFzaChzbGlkZUluZGV4LCBzbGlkZUFuY2hvckxpbmssIGFuY2hvckxpbmspOw0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICBpZihvcHRpb25zLmF1dG9TY3JvbGxpbmcpew0KICAgICAgICAgICAgICAgIHNjcm9sbE9wdGlvbnNbJ3RvcCddID0gLWR0b3A7DQogICAgICAgICAgICAgICAgc2Nyb2xsZWRFbGVtZW50ID0gJyNzdXBlckNvbnRhaW5lcic7DQogICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICBzY3JvbGxPcHRpb25zWydzY3JvbGxUb3AnXSA9IGR0b3A7DQogICAgICAgICAgICAgICAgc2Nyb2xsZWRFbGVtZW50ID0gJ2h0bWwsIGJvZHknOw0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAvLyBGaXggc2VjdGlvbiBvcmRlciBhZnRlciBjb250aW51b3VzVmVydGljYWwgY2hhbmdlcyBoYXZlIGJlZW4gYW5pbWF0ZWQNCiAgICAgICAgICAgIHZhciBjb250aW51b3VzVmVydGljYWxGaXhTZWN0aW9uT3JkZXIgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgICAgICAgICAgLy8gSWYgY29udGludW91c1ZlcnRpY2FsIGlzIGluIGVmZmVjdCAoYW5kIGF1dG9TY3JvbGxpbmcgd291bGQgYWxzbyBiZSBpbiBlZmZlY3QgdGhlbiksDQogICAgICAgICAgICAgICAgLy8gZmluaXNoIG1vdmluZyB0aGUgZWxlbWVudHMgYXJvdW5kIHNvIHRoZSBkaXJlY3QgbmF2aWdhdGlvbiB3aWxsIGZ1bmN0aW9uIG1vcmUgc2ltcGx5DQogICAgICAgICAgICAgICAgaWYgKCF3cmFwQXJvdW5kRWxlbWVudHMgfHwgIXdyYXBBcm91bmRFbGVtZW50cy5sZW5ndGgpIHsNCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOw0KICAgICAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgICAgIGlmIChpc01vdmVtZW50VXApIHsNCiAgICAgICAgICAgICAgICAgICAgJCgnLnNlY3Rpb246Zmlyc3QnKS5iZWZvcmUod3JhcEFyb3VuZEVsZW1lbnRzKTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgZWxzZSB7DQogICAgICAgICAgICAgICAgICAgICQoJy5zZWN0aW9uOmxhc3QnKS5hZnRlcih3cmFwQXJvdW5kRWxlbWVudHMpOw0KICAgICAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgICAgIHNpbGVudFNjcm9sbCgkKCcuc2VjdGlvbi5hY3RpdmUnKS5wb3NpdGlvbigpLnRvcCk7DQogICAgICAgICAgICB9Ow0KDQoNCiAgICAgICAgICAgIC8vIFVzZSBDU1MzIHRyYW5zbGF0ZSBmdW5jdGlvbmFsaXR5IG9yLi4uDQogICAgICAgICAgICBpZiAob3B0aW9ucy5jc3MzICYmIG9wdGlvbnMuYXV0b1Njcm9sbGluZykgew0KICAgICAgICAgICAgICAgIC8vY2FsbGJhY2sgKG9uTGVhdmUpDQogICAgICAgICAgICAgICAgJC5pc0Z1bmN0aW9uKG9wdGlvbnMub25MZWF2ZSkgJiYgb3B0aW9ucy5vbkxlYXZlLmNhbGwodGhpcywgbGVhdmluZ1NlY3Rpb24sIHlNb3ZlbWVudCk7DQoNCiAgICAgICAgICAgICAgICB2YXIgdHJhbnNsYXRlM2QgPSAndHJhbnNsYXRlM2QoMHB4LCAtJyArIGR0b3AgKyAncHgsIDBweCknOw0KICAgICAgICAgICAgICAgIHRyYW5zZm9ybUNvbnRhaW5lcih0cmFuc2xhdGUzZCwgdHJ1ZSk7DQoNCiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsNCiAgICAgICAgICAgICAgICAgICAgLy9maXggc2VjdGlvbiBvcmRlciBmcm9tIGNvbnRpbnVvdXNWZXJ0aWNhbA0KICAgICAgICAgICAgICAgICAgICBjb250aW51b3VzVmVydGljYWxGaXhTZWN0aW9uT3JkZXIoKTsNCg0KICAgICAgICAgICAgICAgICAgICAvL2NhbGxiYWNrIChhZnRlckxvYWQpDQogICAgICAgICAgICAgICAgICAgICQuaXNGdW5jdGlvbihvcHRpb25zLmFmdGVyTG9hZCkgJiYgb3B0aW9ucy5hZnRlckxvYWQuY2FsbCh0aGlzLCBhbmNob3JMaW5rLCAoc2VjdGlvbkluZGV4ICsgMSkpOw0KDQogICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgew0KICAgICAgICAgICAgICAgICAgICAgICAgaXNNb3ZpbmcgPSBmYWxzZTsNCiAgICAgICAgICAgICAgICAgICAgICAgICQuaXNGdW5jdGlvbihjYWxsYmFjaykgJiYgY2FsbGJhY2suY2FsbCh0aGlzKTsNCiAgICAgICAgICAgICAgICAgICAgfSwgc2Nyb2xsRGVsYXkpOw0KICAgICAgICAgICAgICAgIH0sIG9wdGlvbnMuc2Nyb2xsaW5nU3BlZWQpOw0KICAgICAgICAgICAgfSBlbHNlIHsgLy8gLi4uIHVzZSBqUXVlcnkgYW5pbWF0ZQ0KICAgICAgICAgICAgICAgICQuaXNGdW5jdGlvbihvcHRpb25zLm9uTGVhdmUpICYmIG9wdGlvbnMub25MZWF2ZS5jYWxsKHRoaXMsIGxlYXZpbmdTZWN0aW9uLCB5TW92ZW1lbnQpOw0KDQogICAgICAgICAgICAgICAgJChzY3JvbGxlZEVsZW1lbnQpLmFuaW1hdGUoDQogICAgICAgICAgICAgICAgICAgIHNjcm9sbE9wdGlvbnMNCiAgICAgICAgICAgICAgICAsIG9wdGlvbnMuc2Nyb2xsaW5nU3BlZWQsIG9wdGlvbnMuZWFzaW5nLCBmdW5jdGlvbiAoKSB7DQogICAgICAgICAgICAgICAgICAgIC8vZml4IHNlY3Rpb24gb3JkZXIgZnJvbSBjb250aW51b3VzVmVydGljYWwNCiAgICAgICAgICAgICAgICAgICAgY29udGludW91c1ZlcnRpY2FsRml4U2VjdGlvbk9yZGVyKCk7DQoNCiAgICAgICAgICAgICAgICAgICAgLy9jYWxsYmFjayAoYWZ0ZXJMb2FkKQ0KICAgICAgICAgICAgICAgICAgICAkLmlzRnVuY3Rpb24ob3B0aW9ucy5hZnRlckxvYWQpICYmIG9wdGlvbnMuYWZ0ZXJMb2FkLmNhbGwodGhpcywgYW5jaG9yTGluaywgKHNlY3Rpb25JbmRleCArIDEpKTsNCg0KICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIGlzTW92aW5nID0gZmFsc2U7DQogICAgICAgICAgICAgICAgICAgICAgICAkLmlzRnVuY3Rpb24oY2FsbGJhY2spICYmIGNhbGxiYWNrLmNhbGwodGhpcyk7DQogICAgICAgICAgICAgICAgICAgIH0sIHNjcm9sbERlbGF5KTsNCiAgICAgICAgICAgICAgICB9KTsNCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgLy9mbGFnIHRvIGF2b2lkIGNhbGxpbmduIGBzY3JvbGxQYWdlKClgIHR3aWNlIGluIGNhc2Ugb2YgdXNpbmcgYW5jaG9yIGxpbmtzDQogICAgICAgICAgICBsYXN0U2Nyb2xsZWREZXN0aW55ID0gYW5jaG9yTGluazsNCg0KICAgICAgICAgICAgLy9hdm9pZCBmaXJpbmcgaXQgdHdpY2UgKGFzIGl0IGRvZXMgYWxzbyBvbiBzY3JvbGwpDQogICAgICAgICAgICBpZihvcHRpb25zLmF1dG9TY3JvbGxpbmcpew0KICAgICAgICAgICAgICAgIGFjdGl2YXRlTWVudUVsZW1lbnQoYW5jaG9yTGluayk7DQogICAgICAgICAgICAgICAgYWN0aXZhdGVOYXZEb3RzKGFuY2hvckxpbmssIHNlY3Rpb25JbmRleCk7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCg0KICAgICAgICBmdW5jdGlvbiBzY3JvbGxUb0FuY2hvcigpew0KICAgICAgICAgICAgLy9nZXR0aW5nIHRoZSBhbmNob3IgbGluayBpbiB0aGUgVVJMIGFuZCBkZWxldGluZyB0aGUgYCNgDQogICAgICAgICAgICB2YXIgdmFsdWUgPSAgd2luZG93LmxvY2F0aW9uLmhhc2gucmVwbGFjZSgnIycsICcnKS5zcGxpdCgnLycpOw0KICAgICAgICAgICAgdmFyIHNlY3Rpb24gPSB2YWx1ZVswXTsNCiAgICAgICAgICAgIHZhciBzbGlkZSA9IHZhbHVlWzFdOw0KDQogICAgICAgICAgICBpZihzZWN0aW9uKXsgIC8vaWYgdGhlcmVzIGFueSAjDQogICAgICAgICAgICAgICAgc2Nyb2xsUGFnZUFuZFNsaWRlKHNlY3Rpb24sIHNsaWRlKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KDQogICAgICAgIC8vZGV0ZWN0aW5nIGFueSBjaGFuZ2Ugb24gdGhlIFVSTCB0byBzY3JvbGwgdG8gdGhlIGdpdmVuIGFuY2hvciBsaW5rDQogICAgICAgIC8vKGEgd2F5IHRvIGRldGVjdCBiYWNrIGhpc3RvcnkgYnV0dG9uIGFzIHdlIHBsYXkgd2l0aCB0aGUgaGFzaGVzIG9uIHRoZSBVUkwpDQogICAgICAgIGlmIChvcHRpb25zLmhhc2hDaGFuZ2UpIHsNCiAgICAgICAgICAgICQod2luZG93KS5vbignaGFzaGNoYW5nZScsZnVuY3Rpb24oKXsNCiAgICAgICAgICAgICAgICBpZighaXNTY3JvbGxpbmcpew0KICAgICAgICAgICAgICAgICAgICB2YXIgdmFsdWUgPSAgd2luZG93LmxvY2F0aW9uLmhhc2gucmVwbGFjZSgnIycsICcnKS5zcGxpdCgnLycpOw0KICAgICAgICAgICAgICAgICAgICB2YXIgc2VjdGlvbiA9IHZhbHVlWzBdOw0KICAgICAgICAgICAgICAgICAgICB2YXIgc2xpZGUgPSB2YWx1ZVsxXTsNCg0KICAgICAgICAgICAgICAgICAgICAvL3doZW4gbW92aW5nIHRvIGEgc2xpZGUgaW4gdGhlIGZpcnN0IHNlY3Rpb24gZm9yIHRoZSBmaXJzdCB0aW1lIChmaXJzdCB0aW1lIHRvIGFkZCBhbiBhbmNob3IgdG8gdGhlIFVSTCkNCiAgICAgICAgICAgICAgICAgICAgdmFyIGlzRmlyc3RTbGlkZU1vdmUgPSAgKHR5cGVvZiBsYXN0U2Nyb2xsZWREZXN0aW55ID09PSAndW5kZWZpbmVkJyk7DQogICAgICAgICAgICAgICAgICAgIHZhciBpc0ZpcnN0U2Nyb2xsTW92ZSA9ICh0eXBlb2YgbGFzdFNjcm9sbGVkRGVzdGlueSA9PT0gJ3VuZGVmaW5lZCcgJiYgdHlwZW9mIHNsaWRlID09PSAndW5kZWZpbmVkJyk7DQoNCiAgICAgICAgICAgICAgICAgICAgLyppbiBvcmRlciB0byBjYWxsIHNjcm9sbHBhZ2UoKSBvbmx5IG9uY2UgZm9yIGVhY2ggZGVzdGluYXRpb24gYXQgYSB0aW1lDQogICAgICAgICAgICAgICAgICAgIEl0IGlzIGNhbGxlZCB0d2ljZSBmb3IgZWFjaCBzY3JvbGwgb3RoZXJ3aXNlLCBhcyBpbiBjYXNlIG9mIHVzaW5nIGFuY2hvcmxpbmtzIGBoYXNoQ2hhbmdlYA0KICAgICAgICAgICAgICAgICAgICBldmVudCBpcyBmaXJlZCBvbiBldmVyeSBzY3JvbGwgdG9vLiovDQogICAgICAgICAgICAgICAgICAgIGlmICgoc2VjdGlvbiAmJiBzZWN0aW9uICE9PSBsYXN0U2Nyb2xsZWREZXN0aW55KSAmJiAhaXNGaXJzdFNsaWRlTW92ZSB8fCBpc0ZpcnN0U2Nyb2xsTW92ZSB8fCAoIXNsaWRlTW92aW5nICYmIGxhc3RTY3JvbGxlZFNsaWRlICE9IHNsaWRlICkpICB7DQogICAgICAgICAgICAgICAgICAgICAgICBzY3JvbGxQYWdlQW5kU2xpZGUoc2VjdGlvbiwgc2xpZGUpOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICB9KTsNCiAgICAgICAgfQ0KDQoNCiAgICAgICAgLyoqDQogICAgICAgICAqIFNsaWRpbmcgd2l0aCBhcnJvdyBrZXlzLCBib3RoLCB2ZXJ0aWNhbCBhbmQgaG9yaXpvbnRhbA0KICAgICAgICAgKi8NCiAgICAgICAgJChkb2N1bWVudCkua2V5ZG93bihmdW5jdGlvbihlKSB7DQogICAgICAgICAgICAvL01vdmluZyB0aGUgbWFpbiBwYWdlIHdpdGggdGhlIGtleWJvYXJkIGFycm93cyBpZiBrZXlib2FyZCBzY3JvbGxpbmcgaXMgZW5hYmxlZA0KICAgICAgICAgICAgaWYgKG9wdGlvbnMua2V5Ym9hcmRTY3JvbGxpbmcgJiYgIWlzTW92aW5nKSB7DQogICAgICAgICAgICAgICAgc3dpdGNoIChlLndoaWNoKSB7DQogICAgICAgICAgICAgICAgLy91cA0KICAgICAgICAgICAgICAgIGNhc2UgMzg6DQogICAgICAgICAgICAgICAgY2FzZSAzMzoNCiAgICAgICAgICAgICAgICAgICAgJC5mbi5mdWxscGFnZS5tb3ZlU2VjdGlvblVwKCk7DQogICAgICAgICAgICAgICAgICAgIGJyZWFrOw0KDQogICAgICAgICAgICAgICAgLy9kb3duDQogICAgICAgICAgICAgICAgY2FzZSA0MDoNCiAgICAgICAgICAgICAgICBjYXNlIDM0Og0KICAgICAgICAgICAgICAgICAgICAkLmZuLmZ1bGxwYWdlLm1vdmVTZWN0aW9uRG93bigpOw0KICAgICAgICAgICAgICAgICAgICBicmVhazsNCg0KICAgICAgICAgICAgICAgIC8vbGVmdA0KICAgICAgICAgICAgICAgIGNhc2UgMzc6DQogICAgICAgICAgICAgICAgICAgICQoJy5zZWN0aW9uLmFjdGl2ZScpLmZpbmQoJy5jb250cm9sQXJyb3cucHJldjp2aXNpYmxlJykudHJpZ2dlcignY2xpY2snKTsNCiAgICAgICAgICAgICAgICAgICAgYnJlYWs7DQoNCiAgICAgICAgICAgICAgICAvL3JpZ2h0DQogICAgICAgICAgICAgICAgY2FzZSAzOToNCiAgICAgICAgICAgICAgICAgICAgJCgnLnNlY3Rpb24uYWN0aXZlJykuZmluZCgnLmNvbnRyb2xBcnJvdy5uZXh0OnZpc2libGUnKS50cmlnZ2VyKCdjbGljaycpOw0KICAgICAgICAgICAgICAgICAgICBicmVhazsNCg0KICAgICAgICAgICAgICAgIGRlZmF1bHQ6DQogICAgICAgICAgICAgICAgICAgIHJldHVybjsgLy8gZXhpdCB0aGlzIGhhbmRsZXIgZm9yIG90aGVyIGtleXMNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9DQogICAgICAgIH0pOw0KDQogICAgICAgIC8vbmF2aWdhdGlvbiBhY3Rpb24NCiAgICAgICAgJChkb2N1bWVudCkub24oJ2NsaWNrJywgJyNmdWxsUGFnZS1uYXYgYScsIGZ1bmN0aW9uKGUpew0KICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOw0KICAgICAgICAgICAgdmFyIGluZGV4ID0gJCh0aGlzKS5wYXJlbnQoKS5pbmRleCgpOw0KICAgICAgICAgICAgc2Nyb2xsUGFnZSgkKCcuc2VjdGlvbicpLmVxKGluZGV4KSk7DQogICAgICAgIH0pOw0KDQogICAgICAgIC8vbmF2aWdhdGlvbiB0b29sdGlwcw0KICAgICAgICAkKGRvY3VtZW50KS5vbih7DQogICAgICAgICAgICBtb3VzZWVudGVyOiBmdW5jdGlvbigpew0KICAgICAgICAgICAgICAgIHZhciB0b29sdGlwID0gJCh0aGlzKS5kYXRhKCd0b29sdGlwJyk7DQogICAgICAgICAgICAgICAgJCgnPGRpdiBjbGFzcz0iZnVsbFBhZ2UtdG9vbHRpcCAnICsgb3B0aW9ucy5uYXZpZ2F0aW9uUG9zaXRpb24gKyciPicgKyB0b29sdGlwICsgJzwvZGl2PicpLmhpZGUoKS5hcHBlbmRUbygkKHRoaXMpKS5mYWRlSW4oMjAwKTsNCiAgICAgICAgICAgIH0sDQogICAgICAgICAgICBtb3VzZWxlYXZlOiBmdW5jdGlvbigpew0KICAgICAgICAgICAgICAgICQodGhpcykuZmluZCgnLmZ1bGxQYWdlLXRvb2x0aXAnKS5mYWRlT3V0KCkucmVtb3ZlKCk7DQogICAgICAgICAgICB9DQogICAgICAgIH0sICcjZnVsbFBhZ2UtbmF2IGxpJyk7DQoNCg0KICAgICAgICBpZihvcHRpb25zLm5vcm1hbFNjcm9sbEVsZW1lbnRzKXsNCiAgICAgICAgICAgICQoZG9jdW1lbnQpLm9uKCdtb3VzZW92ZXInLCBvcHRpb25zLm5vcm1hbFNjcm9sbEVsZW1lbnRzLCBmdW5jdGlvbiAoKSB7DQogICAgICAgICAgICAgICAgJC5mbi5mdWxscGFnZS5zZXRNb3VzZVdoZWVsU2Nyb2xsaW5nKGZhbHNlKTsNCiAgICAgICAgICAgIH0pOw0KDQogICAgICAgICAgICAkKGRvY3VtZW50KS5vbignbW91c2VvdXQnLCBvcHRpb25zLm5vcm1hbFNjcm9sbEVsZW1lbnRzLCBmdW5jdGlvbigpew0KICAgICAgICAgICAgICAgICQuZm4uZnVsbHBhZ2Uuc2V0TW91c2VXaGVlbFNjcm9sbGluZyh0cnVlKTsNCiAgICAgICAgICAgIH0pOw0KICAgICAgICB9DQoNCiAgICAgICAgLyoqDQogICAgICAgICAqIFNjcm9sbGluZyBob3Jpem9udGFsbHkgd2hlbiBjbGlja2luZyBvbiB0aGUgc2xpZGVyIGNvbnRyb2xzLg0KICAgICAgICAgKi8NCiAgICAgICAgJCgnLnNlY3Rpb24nKS5vbignY2xpY2snLCAnLmNvbnRyb2xBcnJvdycsIGZ1bmN0aW9uKCkgew0KICAgICAgICAgICAgLy9ub3QgdGhhdCBmYXN0IG15IGZyaWVuZCEgOikNCiAgICAgICAgICAgIGlmIChzbGlkZU1vdmluZykgew0KICAgICAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIHNsaWRlTW92aW5nID0gdHJ1ZTsNCg0KICAgICAgICAgICAgdmFyIHNsaWRlcyA9ICQodGhpcykuY2xvc2VzdCgnLnNlY3Rpb24nKS5maW5kKCcuc2xpZGVzJyk7DQogICAgICAgICAgICB2YXIgY3VycmVudFNsaWRlID0gc2xpZGVzLmZpbmQoJy5zbGlkZS5hY3RpdmUnKTsNCiAgICAgICAgICAgIHZhciBkZXN0aW55ID0gbnVsbDsNCg0KICAgICAgICAgICAgaWYgKCQodGhpcykuaGFzQ2xhc3MoJ3ByZXYnKSkgew0KICAgICAgICAgICAgICAgIGRlc3RpbnkgPSBjdXJyZW50U2xpZGUucHJldignLnNsaWRlJyk7DQogICAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgICAgIGRlc3RpbnkgPSBjdXJyZW50U2xpZGUubmV4dCgnLnNsaWRlJyk7DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIC8vaXMgdGhlcmUgaXNuJ3QgYSBuZXh0IHNsaWRlIGluIHRoZSBzZWN1ZW5jZT8NCiAgICAgICAgICAgIGlmKCFkZXN0aW55Lmxlbmd0aCkgew0KICAgICAgICAgICAgICAgIC8vdG8gdGhlIGxhc3QNCiAgICAgICAgICAgICAgICBpZiAoJCh0aGlzKS5oYXNDbGFzcygncHJldicpKSB7DQogICAgICAgICAgICAgICAgICAgIGRlc3RpbnkgPSBjdXJyZW50U2xpZGUuc2libGluZ3MoJzpsYXN0Jyk7DQogICAgICAgICAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgICAgICAgICAgZGVzdGlueSA9IGN1cnJlbnRTbGlkZS5zaWJsaW5ncygnOmZpcnN0Jyk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICBsYW5kc2NhcGVTY3JvbGwoc2xpZGVzLCBkZXN0aW55KTsNCiAgICAgICAgfSk7DQoNCg0KICAgICAgICAvKioNCiAgICAgICAgICogU2Nyb2xsaW5nIGhvcml6b250YWxseSB3aGVuIGNsaWNraW5nIG9uIHRoZSBzbGlkZXIgY29udHJvbHMuDQogICAgICAgICAqLw0KICAgICAgICAkKCcuc2VjdGlvbicpLm9uKCdjbGljaycsICcudG9TbGlkZScsIGZ1bmN0aW9uKGUpIHsNCiAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTsNCg0KICAgICAgICAgICAgdmFyIHNsaWRlcyA9ICQodGhpcykuY2xvc2VzdCgnLnNlY3Rpb24nKS5maW5kKCcuc2xpZGVzJyk7DQogICAgICAgICAgICB2YXIgY3VycmVudFNsaWRlID0gc2xpZGVzLmZpbmQoJy5zbGlkZS5hY3RpdmUnKTsNCiAgICAgICAgICAgIHZhciBkZXN0aW55ID0gbnVsbDsNCg0KICAgICAgICAgICAgZGVzdGlueSA9IHNsaWRlcy5maW5kKCcuc2xpZGUnKS5lcSggKCQodGhpcykuZGF0YSgnaW5kZXgnKSAtMSkgKTsNCg0KICAgICAgICAgICAgaWYoZGVzdGlueS5sZW5ndGggPiAwKXsNCiAgICAgICAgICAgICAgICBsYW5kc2NhcGVTY3JvbGwoc2xpZGVzLCBkZXN0aW55KTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfSk7DQoNCiAgICAgICAgLyoqDQogICAgICAgICogU2Nyb2xscyBob3Jpem9udGFsIHNsaWRlcnMuDQogICAgICAgICovDQogICAgICAgIGZ1bmN0aW9uIGxhbmRzY2FwZVNjcm9sbChzbGlkZXMsIGRlc3Rpbnkpew0KICAgICAgICAgICAgdmFyIGRlc3RpbnlQb3MgPSBkZXN0aW55LnBvc2l0aW9uKCk7DQogICAgICAgICAgICB2YXIgc2xpZGVzQ29udGFpbmVyID0gc2xpZGVzLmZpbmQoJy5zbGlkZXNDb250YWluZXInKS5wYXJlbnQoKTsNCiAgICAgICAgICAgIHZhciBzbGlkZUluZGV4ID0gZGVzdGlueS5pbmRleCgpOw0KICAgICAgICAgICAgdmFyIHNlY3Rpb24gPSBzbGlkZXMuY2xvc2VzdCgnLnNlY3Rpb24nKTsNCiAgICAgICAgICAgIHZhciBzZWN0aW9uSW5kZXggPSBzZWN0aW9uLmluZGV4KCcuc2VjdGlvbicpOw0KICAgICAgICAgICAgdmFyIGFuY2hvckxpbmsgPSBzZWN0aW9uLmRhdGEoJ2FuY2hvcicpOw0KICAgICAgICAgICAgdmFyIHNsaWRlc05hdiA9IHNlY3Rpb24uZmluZCgnLmZ1bGxQYWdlLXNsaWRlc05hdicpOw0KICAgICAgICAgICAgdmFyIHNsaWRlQW5jaG9yID0gZGVzdGlueS5kYXRhKCdhbmNob3InKTsNCg0KICAgICAgICAgICAgLy9jYWNoaW5nIHRoZSB2YWx1ZSBvZiBpc1Jlc2l6aW5nIGF0IHRoZSBtb21tZW50IHRoZSBmdW5jdGlvbiBpcyBjYWxsZWQNCiAgICAgICAgICAgIC8vYmVjYXVzZSBpdCB3aWxsIGJlIGNoZWNrZWQgbGF0ZXIgaW5zaWRlIGEgc2V0VGltZW91dCBhbmQgdGhlIHZhbHVlIG1pZ2h0IGNoYW5nZQ0KICAgICAgICAgICAgdmFyIGxvY2FsSXNSZXNpemluZyA9IGlzUmVzaXppbmc7DQoNCiAgICAgICAgICAgIGlmKG9wdGlvbnMub25TbGlkZUxlYXZlKXsNCiAgICAgICAgICAgICAgICB2YXIgcHJldlNsaWRlSW5kZXggPSBzZWN0aW9uLmZpbmQoJy5zbGlkZS5hY3RpdmUnKS5pbmRleCgpOw0KICAgICAgICAgICAgICAgIHZhciB4TW92ZW1lbnQgPSBnZXRYbW92ZW1lbnQocHJldlNsaWRlSW5kZXgsIHNsaWRlSW5kZXgpOw0KDQogICAgICAgICAgICAgICAgLy9pZiB0aGUgc2l0ZSBpcyBub3QganVzdCByZXNpemluZyBhbmQgcmVhZGp1c3RpbmcgdGhlIHNsaWRlcw0KICAgICAgICAgICAgICAgIGlmKCFsb2NhbElzUmVzaXppbmcpew0KICAgICAgICAgICAgICAgICAgICAkLmlzRnVuY3Rpb24oIG9wdGlvbnMub25TbGlkZUxlYXZlICkgJiYgb3B0aW9ucy5vblNsaWRlTGVhdmUuY2FsbCggdGhpcywgYW5jaG9yTGluaywgKHNlY3Rpb25JbmRleCArIDEpLCBwcmV2U2xpZGVJbmRleCwgeE1vdmVtZW50KTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIGRlc3RpbnkuYWRkQ2xhc3MoJ2FjdGl2ZScpLnNpYmxpbmdzKCkucmVtb3ZlQ2xhc3MoJ2FjdGl2ZScpOw0KDQoNCiAgICAgICAgICAgIGlmKHR5cGVvZiBzbGlkZUFuY2hvciA9PT0gJ3VuZGVmaW5lZCcpew0KICAgICAgICAgICAgICAgIHNsaWRlQW5jaG9yID0gc2xpZGVJbmRleDsNCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgLy9vbmx5IGNoYW5naW5nIHRoZSBVUkwgaWYgdGhlIHNsaWRlcyBhcmUgaW4gdGhlIGN1cnJlbnQgc2VjdGlvbiAobm90IGZvciByZXNpemUgcmUtYWRqdXN0aW5nKQ0KICAgICAgICAgICAgaWYoc2VjdGlvbi5oYXNDbGFzcygnYWN0aXZlJykpew0KDQogICAgICAgICAgICAgICAgaWYoIW9wdGlvbnMubG9vcEhvcml6b250YWwpew0KICAgICAgICAgICAgICAgICAgICAvL2hpZGRpbmcgaXQgZm9yIHRoZSBmaXN0IHNsaWRlLCBzaG93aW5nIGZvciB0aGUgcmVzdA0KICAgICAgICAgICAgICAgICAgICBzZWN0aW9uLmZpbmQoJy5jb250cm9sQXJyb3cucHJldicpLnRvZ2dsZShzbGlkZUluZGV4IT0wKTsNCg0KICAgICAgICAgICAgICAgICAgICAvL2hpZGRpbmcgaXQgZm9yIHRoZSBsYXN0IHNsaWRlLCBzaG93aW5nIGZvciB0aGUgcmVzdA0KICAgICAgICAgICAgICAgICAgICBzZWN0aW9uLmZpbmQoJy5jb250cm9sQXJyb3cubmV4dCcpLnRvZ2dsZSghZGVzdGlueS5pcygnOmxhc3QtY2hpbGQnKSk7DQogICAgICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAgICAgc2V0VVJMSGFzaChzbGlkZUluZGV4LCBzbGlkZUFuY2hvciwgYW5jaG9yTGluayk7DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIGlmKG9wdGlvbnMuY3NzMyl7DQogICAgICAgICAgICAgICAgdmFyIHRyYW5zbGF0ZTNkID0gJ3RyYW5zbGF0ZTNkKC0nICsgZGVzdGlueVBvcy5sZWZ0ICsgJ3B4LCAwcHgsIDBweCknOw0KDQogICAgICAgICAgICAgICAgc2xpZGVzLmZpbmQoJy5zbGlkZXNDb250YWluZXInKS5hZGRDbGFzcygnZWFzaW5nJykuY3NzKHsNCiAgICAgICAgICAgICAgICAgICAgJy13ZWJraXQtdHJhbnNmb3JtJzogdHJhbnNsYXRlM2QsDQogICAgICAgICAgICAgICAgICAgICctbW96LXRyYW5zZm9ybSc6IHRyYW5zbGF0ZTNkLA0KICAgICAgICAgICAgICAgICAgICAnLW1zLXRyYW5zZm9ybSc6dHJhbnNsYXRlM2QsDQogICAgICAgICAgICAgICAgICAgICd0cmFuc2Zvcm0nOiB0cmFuc2xhdGUzZA0KICAgICAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKXsNCiAgICAgICAgICAgICAgICAgICAgLy9pZiB0aGUgc2l0ZSBpcyBub3QganVzdCByZXNpemluZyBhbmQgcmVhZGp1c3RpbmcgdGhlIHNsaWRlcw0KICAgICAgICAgICAgICAgICAgICBpZighbG9jYWxJc1Jlc2l6aW5nKXsNCiAgICAgICAgICAgICAgICAgICAgICAgICQuaXNGdW5jdGlvbiggb3B0aW9ucy5hZnRlclNsaWRlTG9hZCApICYmIG9wdGlvbnMuYWZ0ZXJTbGlkZUxvYWQuY2FsbCggdGhpcywgYW5jaG9yTGluaywgKHNlY3Rpb25JbmRleCArIDEpLCBzbGlkZUFuY2hvciwgc2xpZGVJbmRleCApOw0KICAgICAgICAgICAgICAgICAgICB9DQoNCiAgICAgICAgICAgICAgICAgICAgc2xpZGVNb3ZpbmcgPSBmYWxzZTsNCiAgICAgICAgICAgICAgICB9LCBvcHRpb25zLnNjcm9sbGluZ1NwZWVkLCBvcHRpb25zLmVhc2luZyk7DQogICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICBzbGlkZXNDb250YWluZXIuYW5pbWF0ZSh7DQogICAgICAgICAgICAgICAgICAgIHNjcm9sbExlZnQgOiBkZXN0aW55UG9zLmxlZnQNCiAgICAgICAgICAgICAgICB9LCBvcHRpb25zLnNjcm9sbGluZ1NwZWVkLCBvcHRpb25zLmVhc2luZywgZnVuY3Rpb24oKSB7DQoNCiAgICAgICAgICAgICAgICAgICAgLy9pZiB0aGUgc2l0ZSBpcyBub3QganVzdCByZXNpemluZyBhbmQgcmVhZGp1c3RpbmcgdGhlIHNsaWRlcw0KICAgICAgICAgICAgICAgICAgICBpZighbG9jYWxJc1Jlc2l6aW5nKXsNCiAgICAgICAgICAgICAgICAgICAgICAgICQuaXNGdW5jdGlvbiggb3B0aW9ucy5hZnRlclNsaWRlTG9hZCApICYmIG9wdGlvbnMuYWZ0ZXJTbGlkZUxvYWQuY2FsbCggdGhpcywgYW5jaG9yTGluaywgKHNlY3Rpb25JbmRleCArIDEpLCBzbGlkZUFuY2hvciwgc2xpZGVJbmRleCk7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgLy9sZXR0aW5nIHRoZW0gc2xpZGUgYWdhaW4NCiAgICAgICAgICAgICAgICAgICAgc2xpZGVNb3ZpbmcgPSBmYWxzZTsNCiAgICAgICAgICAgICAgICB9KTsNCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgc2xpZGVzTmF2LmZpbmQoJy5hY3RpdmUnKS5yZW1vdmVDbGFzcygnYWN0aXZlJyk7DQogICAgICAgICAgICBzbGlkZXNOYXYuZmluZCgnbGknKS5lcShzbGlkZUluZGV4KS5maW5kKCdhJykuYWRkQ2xhc3MoJ2FjdGl2ZScpOw0KICAgICAgICB9DQoNCg0KICAgICAgICBpZiAoIWlzVGFibGV0KSB7DQogICAgICAgICAgICB2YXIgcmVzaXplSWQ7DQoNCiAgICAgICAgICAgIC8vd2hlbiByZXNpemluZyB0aGUgc2l0ZSwgd2UgYWRqdXN0IHRoZSBoZWlnaHRzIG9mIHRoZSBzZWN0aW9ucw0KICAgICAgICAgICAgJCh3aW5kb3cpLnJlc2l6ZShmdW5jdGlvbigpIHsNCiAgICAgICAgICAgICAgICAvL2luIG9yZGVyIHRvIGNhbGwgdGhlIGZ1bmN0aW9ucyBvbmx5IHdoZW4gdGhlIHJlc2l6ZSBpcyBmaW5pc2hlZA0KICAgICAgICAgICAgICAgIC8vaHR0cDovL3N0YWNrb3ZlcmZsb3cuY29tL3F1ZXN0aW9ucy80Mjk4NjEyL2pxdWVyeS1ob3ctdG8tY2FsbC1yZXNpemUtZXZlbnQtb25seS1vbmNlLWl0cy1maW5pc2hlZC1yZXNpemluZw0KICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dChyZXNpemVJZCk7DQogICAgICAgICAgICAgICAgcmVzaXplSWQgPSBzZXRUaW1lb3V0KGRvbmVSZXNpemluZywgNTAwKTsNCiAgICAgICAgICAgIH0pOw0KDQogICAgICAgIH0NCiAgICAgICAgJCh3aW5kb3cpLmJpbmQoJ29yaWVudGF0aW9uY2hhbmdlJywgZnVuY3Rpb24oKSB7DQogICAgICAgICAgICBkb25lUmVzaXppbmcoKTsNCiAgICAgICAgfSk7DQoNCiAgICAgICAgLyoqDQogICAgICAgICAqIFdoZW4gcmVzaXppbmcgaXMgZmluaXNoZWQsIHdlIGFkanVzdCB0aGUgc2xpZGVzIHNpemVzIGFuZCBwb3NpdGlvbnMNCiAgICAgICAgICovDQogICAgICAgIGZ1bmN0aW9uIGRvbmVSZXNpemluZygpIHsNCiAgICAgICAgICAgIGlzUmVzaXppbmcgPSB0cnVlOw0KDQogICAgICAgICAgICB2YXIgd2luZG93c1dpZHRoID0gJCh3aW5kb3cpLndpZHRoKCk7DQogICAgICAgICAgICB3aW5kb3dzSGVpZ2h0ID0gJCh3aW5kb3cpLmhlaWdodCgpOw0KDQogICAgICAgICAgICAvL3RleHQgYW5kIGltYWdlcyByZXNpemluZw0KICAgICAgICAgICAgaWYgKG9wdGlvbnMucmVzaXplKSB7DQogICAgICAgICAgICAgICAgcmVzaXplTWUod2luZG93c0hlaWdodCwgd2luZG93c1dpZHRoKTsNCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgJCgnLnNlY3Rpb24nKS5lYWNoKGZ1bmN0aW9uKCl7DQogICAgICAgICAgICAgICAgdmFyIHNjcm9sbEhlaWdodCA9IHdpbmRvd3NIZWlnaHQgLSBwYXJzZUludCgkKHRoaXMpLmNzcygncGFkZGluZy1ib3R0b20nKSkgLSBwYXJzZUludCgkKHRoaXMpLmNzcygncGFkZGluZy10b3AnKSk7DQoNCiAgICAgICAgICAgICAgICAvL3Jlc2l6aW5nIHRoZSBzY3JvbGxpbmcgZGl2cw0KICAgICAgICAgICAgICAgIGlmKG9wdGlvbnMuc2Nyb2xsT3ZlcmZsb3cpew0KICAgICAgICAgICAgICAgICAgICB2YXIgc2xpZGVzID0gJCh0aGlzKS5maW5kKCcuc2xpZGUnKTsNCg0KICAgICAgICAgICAgICAgICAgICBpZihzbGlkZXMubGVuZ3RoKXsNCiAgICAgICAgICAgICAgICAgICAgICAgIHNsaWRlcy5lYWNoKGZ1bmN0aW9uKCl7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgY3JlYXRlU2xpbVNjcm9sbGluZygkKHRoaXMpKTsNCiAgICAgICAgICAgICAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICAgICAgICAgIGNyZWF0ZVNsaW1TY3JvbGxpbmcoJCh0aGlzKSk7DQogICAgICAgICAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgICAgIC8vYWRqdXN0aW5nIHRoZSBoZWlnaHQgb2YgdGhlIHRhYmxlLWNlbGwgZm9yIElFIGFuZCBGaXJlZm94DQogICAgICAgICAgICAgICAgaWYob3B0aW9ucy52ZXJ0aWNhbENlbnRlcmVkKXsNCiAgICAgICAgICAgICAgICAgICAgJCh0aGlzKS5maW5kKCcudGFibGVDZWxsJykuY3NzKCdoZWlnaHQnLCBnZXRUYWJsZUhlaWdodCgkKHRoaXMpKSArICdweCcpOw0KICAgICAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgICAgICQodGhpcykuY3NzKCdoZWlnaHQnLCB3aW5kb3dzSGVpZ2h0ICsgJ3B4Jyk7DQoNCiAgICAgICAgICAgICAgICAvL2FkanVzdGluZyB0aGUgcG9zaXRpb24gZm8gdGhlIEZVTEwgV0lEVEggc2xpZGVzLi4uDQogICAgICAgICAgICAgICAgdmFyIHNsaWRlcyA9ICQodGhpcykuZmluZCgnLnNsaWRlcycpOw0KICAgICAgICAgICAgICAgIGlmIChzbGlkZXMubGVuZ3RoKSB7DQogICAgICAgICAgICAgICAgICAgIGxhbmRzY2FwZVNjcm9sbChzbGlkZXMsIHNsaWRlcy5maW5kKCcuc2xpZGUuYWN0aXZlJykpOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0pOw0KDQogICAgICAgICAgICAvL2FkanVzdGluZyB0aGUgcG9zaXRpb24gZm9yIHRoZSBjdXJyZW50IHNlY3Rpb24NCiAgICAgICAgICAgIHZhciBkZXN0aW55UG9zID0gJCgnLnNlY3Rpb24uYWN0aXZlJykucG9zaXRpb24oKTsNCg0KICAgICAgICAgICAgdmFyIGFjdGl2ZVNlY3Rpb24gPSAkKCcuc2VjdGlvbi5hY3RpdmUnKTsNCg0KICAgICAgICAgICAgLy9pc24ndCBpdCB0aGUgZmlyc3Qgc2VjdGlvbj8NCiAgICAgICAgICAgIGlmKGFjdGl2ZVNlY3Rpb24uaW5kZXgoJy5zZWN0aW9uJykpew0KICAgICAgICAgICAgICAgIHNjcm9sbFBhZ2UoYWN0aXZlU2VjdGlvbik7DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIGlzUmVzaXppbmcgPSBmYWxzZTsNCiAgICAgICAgfQ0KDQogICAgICAgIC8qKg0KICAgICAgICAgKiBSZXNpemluZyBvZiB0aGUgZm9udCBzaXplIGRlcGVuZGluZyBvbiB0aGUgd2luZG93IHNpemUgYXMgd2VsbCBhcyBzb21lIG9mIHRoZSBpbWFnZXMgb24gdGhlIHNpdGUuDQogICAgICAgICAqLw0KICAgICAgICBmdW5jdGlvbiByZXNpemVNZShkaXNwbGF5SGVpZ2h0LCBkaXNwbGF5V2lkdGgpIHsNCiAgICAgICAgICAgIC8vU3RhbmRhcmQgaGVpZ2h0LCBmb3Igd2hpY2ggdGhlIGJvZHkgZm9udCBzaXplIGlzIGNvcnJlY3QNCiAgICAgICAgICAgIHZhciBwcmVmZXJyZWRIZWlnaHQgPSA4MjU7DQogICAgICAgICAgICB2YXIgd2luZG93U2l6ZSA9IGRpc3BsYXlIZWlnaHQ7DQoNCiAgICAgICAgICAgIC8qIFByb2JsZW0gdG8gYmUgc29sdmVkDQoNCiAgICAgICAgICAgIGlmIChkaXNwbGF5SGVpZ2h0IDwgODI1KSB7DQogICAgICAgICAgICAgICAgdmFyIHBlcmNlbnRhZ2UgPSAod2luZG93U2l6ZSAqIDEwMCkgLyBwcmVmZXJyZWRIZWlnaHQ7DQogICAgICAgICAgICAgICAgdmFyIG5ld0ZvbnRTaXplID0gcGVyY2VudGFnZS50b0ZpeGVkKDIpOw0KDQogICAgICAgICAgICAgICAgJCgiaW1nIikuZWFjaChmdW5jdGlvbigpIHsNCiAgICAgICAgICAgICAgICAgICAgdmFyIG5ld1dpZHRoID0gKCg4MCAqIHBlcmNlbnRhZ2UpIC8gMTAwKS50b0ZpeGVkKDIpOw0KICAgICAgICAgICAgICAgICAgICAkKHRoaXMpLmNzcygid2lkdGgiLCBuZXdXaWR0aCArICclJyk7DQogICAgICAgICAgICAgICAgfSk7DQogICAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgICAgICQoImltZyIpLmVhY2goZnVuY3Rpb24oKSB7DQogICAgICAgICAgICAgICAgICAgICQodGhpcykuY3NzKCJ3aWR0aCIsICcnKTsNCiAgICAgICAgICAgICAgICB9KTsNCiAgICAgICAgICAgIH0qLw0KDQogICAgICAgICAgICBpZiAoZGlzcGxheUhlaWdodCA8IDgyNSB8fCBkaXNwbGF5V2lkdGggPCA5MDApIHsNCiAgICAgICAgICAgICAgICBpZiAoZGlzcGxheVdpZHRoIDwgOTAwKSB7DQogICAgICAgICAgICAgICAgICAgIHdpbmRvd1NpemUgPSBkaXNwbGF5V2lkdGg7DQogICAgICAgICAgICAgICAgICAgIHByZWZlcnJlZEhlaWdodCA9IDkwMDsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgdmFyIHBlcmNlbnRhZ2UgPSAod2luZG93U2l6ZSAqIDEwMCkgLyBwcmVmZXJyZWRIZWlnaHQ7DQogICAgICAgICAgICAgICAgdmFyIG5ld0ZvbnRTaXplID0gcGVyY2VudGFnZS50b0ZpeGVkKDIpOw0KDQogICAgICAgICAgICAgICAgJCgiYm9keSIpLmNzcygiZm9udC1zaXplIiwgbmV3Rm9udFNpemUgKyAnJScpOw0KICAgICAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgICAgICAkKCJib2R5IikuY3NzKCJmb250LXNpemUiLCAnMTAwJScpOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQoNCiAgICAgICAgLyoqDQogICAgICAgICAqIEFjdGl2YXRpbmcgdGhlIHdlYnNpdGUgbmF2aWdhdGlvbiBkb3RzIGFjY29yZGluZyB0byB0aGUgZ2l2ZW4gc2xpZGUgbmFtZS4NCiAgICAgICAgICovDQogICAgICAgIGZ1bmN0aW9uIGFjdGl2YXRlTmF2RG90cyhuYW1lLCBzZWN0aW9uSW5kZXgpew0KICAgICAgICAgICAgaWYob3B0aW9ucy5uYXZpZ2F0aW9uKXsNCiAgICAgICAgICAgICAgICAkKCcjZnVsbFBhZ2UtbmF2JykuZmluZCgnLmFjdGl2ZScpLnJlbW92ZUNsYXNzKCdhY3RpdmUnKTsNCiAgICAgICAgICAgICAgICBpZihuYW1lKXsNCiAgICAgICAgICAgICAgICAgICAgJCgnI2Z1bGxQYWdlLW5hdicpLmZpbmQoJ2FbaHJlZj0iIycgKyBuYW1lICsgJyJdJykuYWRkQ2xhc3MoJ2FjdGl2ZScpOw0KICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICAkKCcjZnVsbFBhZ2UtbmF2JykuZmluZCgnbGknKS5lcShzZWN0aW9uSW5kZXgpLmZpbmQoJ2EnKS5hZGRDbGFzcygnYWN0aXZlJyk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQoNCiAgICAgICAgLyoqDQogICAgICAgICAqIEFjdGl2YXRpbmcgdGhlIHdlYnNpdGUgbWFpbiBtZW51IGVsZW1lbnRzIGFjY29yZGluZyB0byB0aGUgZ2l2ZW4gc2xpZGUgbmFtZS4NCiAgICAgICAgICovDQogICAgICAgIGZ1bmN0aW9uIGFjdGl2YXRlTWVudUVsZW1lbnQobmFtZSl7DQogICAgICAgICAgICBpZihvcHRpb25zLm1lbnUpew0KICAgICAgICAgICAgICAgICQob3B0aW9ucy5tZW51KS5maW5kKCcuYWN0aXZlJykucmVtb3ZlQ2xhc3MoJ2FjdGl2ZScpOw0KICAgICAgICAgICAgICAgICQob3B0aW9ucy5tZW51KS5maW5kKCdbZGF0YS1tZW51YW5jaG9yPSInK25hbWUrJyJdJykuYWRkQ2xhc3MoJ2FjdGl2ZScpOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQoNCiAgICAgICAgLyoqDQogICAgICAgICogUmV0dXJuIGEgYm9vbGVhbiBkZXBlbmRpbmcgb24gd2hldGhlciB0aGUgc2Nyb2xsYWJsZSBlbGVtZW50IGlzIGF0IHRoZSBlbmQgb3IgYXQgdGhlIHN0YXJ0IG9mIHRoZSBzY3JvbGxpbmcNCiAgICAgICAgKiBkZXBlbmRpbmcgb24gdGhlIGdpdmVuIHR5cGUuDQogICAgICAgICovDQogICAgICAgIGZ1bmN0aW9uIGlzU2Nyb2xsZWQodHlwZSwgc2Nyb2xsYWJsZSl7DQogICAgICAgICAgICBpZih0eXBlID09PSAndG9wJyl7DQogICAgICAgICAgICAgICAgcmV0dXJuICFzY3JvbGxhYmxlLnNjcm9sbFRvcCgpOw0KICAgICAgICAgICAgfWVsc2UgaWYodHlwZSA9PT0gJ2JvdHRvbScpew0KICAgICAgICAgICAgICAgIHJldHVybiBzY3JvbGxhYmxlLnNjcm9sbFRvcCgpICsgc2Nyb2xsYWJsZS5pbm5lckhlaWdodCgpID49IHNjcm9sbGFibGVbMF0uc2Nyb2xsSGVpZ2h0Ow0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQoNCiAgICAgICAgLyoqDQogICAgICAgICogUmV0dW5zIGB1cGAgb3IgYGRvd25gIGRlcGVuZGluZyBvbiB0aGUgc2Nyb2xsaW5nIG1vdmVtZW50IHRvIHJlYWNoIGl0cyBkZXN0aW5hdGlvbg0KICAgICAgICAqIGZyb20gdGhlIGN1cnJlbnQgc2VjdGlvbi4NCiAgICAgICAgKi8NCiAgICAgICAgZnVuY3Rpb24gZ2V0WW1vdmVtZW50KGRlc3Rpbnkpew0KICAgICAgICAgICAgdmFyIGZyb21JbmRleCA9ICQoJy5zZWN0aW9uLmFjdGl2ZScpLmluZGV4KCcuc2VjdGlvbicpOw0KICAgICAgICAgICAgdmFyIHRvSW5kZXggPSBkZXN0aW55LmluZGV4KCcuc2VjdGlvbicpOw0KDQogICAgICAgICAgICBpZihmcm9tSW5kZXggPiB0b0luZGV4KXsNCiAgICAgICAgICAgICAgICByZXR1cm4gJ3VwJzsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIHJldHVybiAnZG93bic7DQogICAgICAgIH0NCg0KICAgICAgICAvKioNCiAgICAgICAgKiBSZXR1bnMgYHJpZ2h0YCBvciBgbGVmdGAgZGVwZW5kaW5nIG9uIHRoZSBzY3JvbGxpbmcgbW92ZW1lbnQgdG8gcmVhY2ggaXRzIGRlc3RpbmF0aW9uDQogICAgICAgICogZnJvbSB0aGUgY3VycmVudCBzbGlkZS4NCiAgICAgICAgKi8NCiAgICAgICAgZnVuY3Rpb24gZ2V0WG1vdmVtZW50KGZyb21JbmRleCwgdG9JbmRleCl7DQogICAgICAgICAgICBpZihmcm9tSW5kZXggPiB0b0luZGV4KXsNCiAgICAgICAgICAgICAgICByZXR1cm4gJ2xlZnQnOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgcmV0dXJuICdyaWdodCc7DQogICAgICAgIH0NCg0KDQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZVNsaW1TY3JvbGxpbmcoZWxlbWVudCl7DQogICAgICAgICAgICAvL25lZWRlZCB0byBtYWtlIGBzY3JvbGxIZWlnaHRgIHdvcmsgdW5kZXIgT3BlcmEgMTINCiAgICAgICAgICAgIGVsZW1lbnQuY3NzKCdvdmVyZmxvdycsICdoaWRkZW4nKTsNCg0KICAgICAgICAgICAgLy9pbiBjYXNlIGVsZW1lbnQgaXMgYSBzbGlkZQ0KICAgICAgICAgICAgdmFyIHNlY3Rpb24gPSBlbGVtZW50LmNsb3Nlc3QoJy5zZWN0aW9uJyk7DQogICAgICAgICAgICB2YXIgc2Nyb2xsYWJsZSA9IGVsZW1lbnQuZmluZCgnLnNjcm9sbGFibGUnKTsNCg0KICAgICAgICAgICAgLy9pZiB0aGVyZSB3YXMgc2Nyb2xsLCB0aGUgY29udGVudEhlaWdodCB3aWxsIGJlIHRoZSBvbmUgaW4gdGhlIHNjcm9sbGFibGUgc2VjdGlvbg0KICAgICAgICAgICAgaWYoc2Nyb2xsYWJsZS5sZW5ndGgpew0KICAgICAgICAgICAgICAgIHZhciBjb250ZW50SGVpZ2h0ID0gZWxlbWVudC5maW5kKCcuc2Nyb2xsYWJsZScpLmdldCgwKS5zY3JvbGxIZWlnaHQ7DQogICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICB2YXIgY29udGVudEhlaWdodCA9IGVsZW1lbnQuZ2V0KDApLnNjcm9sbEhlaWdodDsNCiAgICAgICAgICAgICAgICBpZihvcHRpb25zLnZlcnRpY2FsQ2VudGVyZWQpew0KICAgICAgICAgICAgICAgICAgICBjb250ZW50SGVpZ2h0ID0gZWxlbWVudC5maW5kKCcudGFibGVDZWxsJykuZ2V0KDApLnNjcm9sbEhlaWdodDsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIHZhciBzY3JvbGxIZWlnaHQgPSB3aW5kb3dzSGVpZ2h0IC0gcGFyc2VJbnQoc2VjdGlvbi5jc3MoJ3BhZGRpbmctYm90dG9tJykpIC0gcGFyc2VJbnQoc2VjdGlvbi5jc3MoJ3BhZGRpbmctdG9wJykpOw0KDQogICAgICAgICAgICAvL25lZWRzIHNjcm9sbD8NCiAgICAgICAgICAgIGlmICggY29udGVudEhlaWdodCA+IHNjcm9sbEhlaWdodCkgew0KICAgICAgICAgICAgICAgIC8vd2FzIHRoZXJlIGFscmVhZHkgYW4gc2Nyb2xsID8gVXBkYXRpbmcgaXQNCiAgICAgICAgICAgICAgICBpZihzY3JvbGxhYmxlLmxlbmd0aCl7DQogICAgICAgICAgICAgICAgICAgIHNjcm9sbGFibGUuY3NzKCdoZWlnaHQnLCBzY3JvbGxIZWlnaHQgKyAncHgnKS5wYXJlbnQoKS5jc3MoJ2hlaWdodCcsIHNjcm9sbEhlaWdodCArICdweCcpOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAvL2NyZWF0aW5nIHRoZSBzY3JvbGxpbmcNCiAgICAgICAgICAgICAgICBlbHNlew0KICAgICAgICAgICAgICAgICAgICBpZihvcHRpb25zLnZlcnRpY2FsQ2VudGVyZWQpew0KICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5maW5kKCcudGFibGVDZWxsJykud3JhcElubmVyKCc8ZGl2IGNsYXNzPSJzY3JvbGxhYmxlIiAvPicpOw0KICAgICAgICAgICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnQud3JhcElubmVyKCc8ZGl2IGNsYXNzPSJzY3JvbGxhYmxlIiAvPicpOw0KICAgICAgICAgICAgICAgICAgICB9DQoNCg0KICAgICAgICAgICAgICAgICAgICBlbGVtZW50LmZpbmQoJy5zY3JvbGxhYmxlJykuc2xpbVNjcm9sbCh7DQogICAgICAgICAgICAgICAgICAgICAgICBoZWlnaHQ6IHNjcm9sbEhlaWdodCArICdweCcsDQogICAgICAgICAgICAgICAgICAgICAgICBzaXplOiAnMTBweCcsDQogICAgICAgICAgICAgICAgICAgICAgICBhbHdheXNWaXNpYmxlOiB0cnVlDQogICAgICAgICAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgLy9yZW1vdmluZyB0aGUgc2Nyb2xsaW5nIHdoZW4gaXQgaXMgbm90IG5lY2Vzc2FyeSBhbnltb3JlDQogICAgICAgICAgICBlbHNlew0KICAgICAgICAgICAgICAgIGVsZW1lbnQuZmluZCgnLnNjcm9sbGFibGUnKS5jaGlsZHJlbigpLmZpcnN0KCkudW53cmFwKCkudW53cmFwKCk7DQogICAgICAgICAgICAgICAgZWxlbWVudC5maW5kKCcuc2xpbVNjcm9sbEJhcicpLnJlbW92ZSgpOw0KICAgICAgICAgICAgICAgIGVsZW1lbnQuZmluZCgnLnNsaW1TY3JvbGxSYWlsJykucmVtb3ZlKCk7DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIC8vdW5kbw0KICAgICAgICAgICAgZWxlbWVudC5jc3MoJ292ZXJmbG93JywgJycpOw0KICAgICAgICB9DQoNCiAgICAgICAgZnVuY3Rpb24gYWRkVGFibGVDbGFzcyhlbGVtZW50KXsNCiAgICAgICAgICAgIGVsZW1lbnQuYWRkQ2xhc3MoJ3RhYmxlJykud3JhcElubmVyKCc8ZGl2IGNsYXNzPSJ0YWJsZUNlbGwiIHN0eWxlPSJoZWlnaHQ6JyArIGdldFRhYmxlSGVpZ2h0KGVsZW1lbnQpICsgJ3B4OyIgLz4nKTsNCiAgICAgICAgfQ0KDQogICAgICAgIGZ1bmN0aW9uIGdldFRhYmxlSGVpZ2h0KGVsZW1lbnQpew0KICAgICAgICAgICAgdmFyIHNlY3Rpb25IZWlnaHQgPSB3aW5kb3dzSGVpZ2h0Ow0KDQogICAgICAgICAgICBpZihvcHRpb25zLnBhZGRpbmdUb3AgfHwgb3B0aW9ucy5wYWRkaW5nQm90dG9tKXsNCiAgICAgICAgICAgICAgICB2YXIgc2VjdGlvbiA9IGVsZW1lbnQ7DQogICAgICAgICAgICAgICAgaWYoIXNlY3Rpb24uaGFzQ2xhc3MoJ3NlY3Rpb24nKSl7DQogICAgICAgICAgICAgICAgICAgIHNlY3Rpb24gPSBlbGVtZW50LmNsb3Nlc3QoJy5zZWN0aW9uJyk7DQogICAgICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAgICAgdmFyIHBhZGRpbmdzID0gcGFyc2VJbnQoc2VjdGlvbi5jc3MoJ3BhZGRpbmctdG9wJykpICsgcGFyc2VJbnQoc2VjdGlvbi5jc3MoJ3BhZGRpbmctYm90dG9tJykpOw0KICAgICAgICAgICAgICAgIHNlY3Rpb25IZWlnaHQgPSAod2luZG93c0hlaWdodCAtIHBhZGRpbmdzKTsNCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgcmV0dXJuIHNlY3Rpb25IZWlnaHQ7DQogICAgICAgIH0NCg0KICAgICAgICAvKioNCiAgICAgICAgKiBBZGRzIGEgY3NzMyB0cmFuc2Zvcm0gcHJvcGVydHkgdG8gdGhlIGNvbnRhaW5lciBjbGFzcyB3aXRoIG9yIHdpdGhvdXQgYW5pbWF0aW9uIGRlcGVuZGluZyBvbiB0aGUgYW5pbWF0ZWQgcGFyYW0uDQogICAgICAgICovDQogICAgICAgIGZ1bmN0aW9uIHRyYW5zZm9ybUNvbnRhaW5lcih0cmFuc2xhdGUzZCwgYW5pbWF0ZWQpew0KICAgICAgICAgICAgJCgnI3N1cGVyQ29udGFpbmVyJykudG9nZ2xlQ2xhc3MoJ2Vhc2luZycsIGFuaW1hdGVkKTsNCg0KICAgICAgICAgICAgJCgnI3N1cGVyQ29udGFpbmVyJykuY3NzKHsNCiAgICAgICAgICAgICAgICAnLXdlYmtpdC10cmFuc2Zvcm0nOiB0cmFuc2xhdGUzZCwNCiAgICAgICAgICAgICAgICAnLW1vei10cmFuc2Zvcm0nOiB0cmFuc2xhdGUzZCwNCiAgICAgICAgICAgICAgICAnLW1zLXRyYW5zZm9ybSc6dHJhbnNsYXRlM2QsDQogICAgICAgICAgICAgICAgJ3RyYW5zZm9ybSc6IHRyYW5zbGF0ZTNkDQogICAgICAgICAgICB9KTsNCiAgICAgICAgfQ0KDQoNCiAgICAgICAgLyoqDQogICAgICAgICogU2Nyb2xscyB0byB0aGUgZ2l2ZW4gc2VjdGlvbiBhbmQgc2xpZGUNCiAgICAgICAgKi8NCiAgICAgICAgZnVuY3Rpb24gc2Nyb2xsUGFnZUFuZFNsaWRlKGRlc3RpbnksIHNsaWRlKXsNCiAgICAgICAgICAgIGlmICh0eXBlb2Ygc2xpZGUgPT09ICd1bmRlZmluZWQnKSB7DQogICAgICAgICAgICAgICAgc2xpZGUgPSAwOw0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICBpZihpc05hTihkZXN0aW55KSl7DQogICAgICAgICAgICAgICAgdmFyIHNlY3Rpb24gPSAkKCdbZGF0YS1hbmNob3I9IicrZGVzdGlueSsnIl0nKTsNCiAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgIHZhciBzZWN0aW9uID0gJCgnLnNlY3Rpb24nKS5lcSggKGRlc3RpbnkgLTEpICk7DQogICAgICAgICAgICB9DQoNCg0KICAgICAgICAgICAgLy93ZSBuZWVkIHRvIHNjcm9sbCB0byB0aGUgc2VjdGlvbiBhbmQgdGhlbiB0byB0aGUgc2xpZGUNCiAgICAgICAgICAgIGlmIChkZXN0aW55ICE9PSBsYXN0U2Nyb2xsZWREZXN0aW55ICYmICFzZWN0aW9uLmhhc0NsYXNzKCdhY3RpdmUnKSl7DQogICAgICAgICAgICAgICAgc2Nyb2xsUGFnZShzZWN0aW9uLCBmdW5jdGlvbigpew0KICAgICAgICAgICAgICAgICAgICBzY3JvbGxTbGlkZXIoc2VjdGlvbiwgc2xpZGUpDQogICAgICAgICAgICAgICAgfSk7DQogICAgICAgICAgICB9DQogICAgICAgICAgICAvL2lmIHdlIHdlcmUgYWxyZWFkeSBpbiB0aGUgc2VjdGlvbg0KICAgICAgICAgICAgZWxzZXsNCiAgICAgICAgICAgICAgICBzY3JvbGxTbGlkZXIoc2VjdGlvbiwgc2xpZGUpOw0KICAgICAgICAgICAgfQ0KDQogICAgICAgIH0NCg0KICAgICAgICAvKioNCiAgICAgICAgKiBTY3JvbGxzIHRoZSBzbGlkZXIgdG8gdGhlIGdpdmVuIHNsaWRlIGRlc3RpbmF0aW9uIGZvciB0aGUgZ2l2ZW4gc2VjdGlvbg0KICAgICAgICAqLw0KICAgICAgICBmdW5jdGlvbiBzY3JvbGxTbGlkZXIoc2VjdGlvbiwgc2xpZGUpew0KICAgICAgICAgICAgaWYodHlwZW9mIHNsaWRlICE9ICd1bmRlZmluZWQnKXsNCiAgICAgICAgICAgICAgICB2YXIgc2xpZGVzID0gc2VjdGlvbi5maW5kKCcuc2xpZGVzJyk7DQogICAgICAgICAgICAgICAgdmFyIGRlc3RpbnkgPSAgc2xpZGVzLmZpbmQoJ1tkYXRhLWFuY2hvcj0iJytzbGlkZSsnIl0nKTsNCg0KICAgICAgICAgICAgICAgIGlmKCFkZXN0aW55Lmxlbmd0aCl7DQogICAgICAgICAgICAgICAgICAgIGRlc3RpbnkgPSBzbGlkZXMuZmluZCgnLnNsaWRlJykuZXEoc2xpZGUpOw0KICAgICAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgICAgIGlmKGRlc3RpbnkubGVuZ3RoKXsNCiAgICAgICAgICAgICAgICAgICAgbGFuZHNjYXBlU2Nyb2xsKHNsaWRlcywgZGVzdGlueSk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQoNCiAgICAgICAgLyoqDQogICAgICAgICogQ3JlYXRlcyBhIGxhbmRzY2FwZSBuYXZpZ2F0aW9uIGJhciB3aXRoIGRvdHMgZm9yIGhvcml6b250YWwgc2xpZGVycy4NCiAgICAgICAgKi8NCiAgICAgICAgZnVuY3Rpb24gYWRkU2xpZGVzTmF2aWdhdGlvbihzZWN0aW9uLCBudW1TbGlkZXMpew0KICAgICAgICAgICAgc2VjdGlvbi5hcHBlbmQoJzxkaXYgY2xhc3M9ImZ1bGxQYWdlLXNsaWRlc05hdiI+PHVsPjwvdWw+PC9kaXY+Jyk7DQogICAgICAgICAgICB2YXIgbmF2ID0gc2VjdGlvbi5maW5kKCcuZnVsbFBhZ2Utc2xpZGVzTmF2Jyk7DQoNCiAgICAgICAgICAgIC8vdG9wIG9yIGJvdHRvbQ0KICAgICAgICAgICAgbmF2LmFkZENsYXNzKG9wdGlvbnMuc2xpZGVzTmF2UG9zaXRpb24pOw0KDQogICAgICAgICAgICBmb3IodmFyIGk9MDsgaTwgbnVtU2xpZGVzOyBpKyspew0KICAgICAgICAgICAgICAgIG5hdi5maW5kKCd1bCcpLmFwcGVuZCgnPGxpPjxhIGhyZWY9IiMiPjxzcGFuPjwvc3Bhbj48L2E+PC9saT4nKTsNCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgLy9jZW50ZXJpbmcgaXQNCiAgICAgICAgICAgIG5hdi5jc3MoJ21hcmdpbi1sZWZ0JywgJy0nICsgKG5hdi53aWR0aCgpLzIpICsgJ3B4Jyk7DQoNCiAgICAgICAgICAgIG5hdi5maW5kKCdsaScpLmZpcnN0KCkuZmluZCgnYScpLmFkZENsYXNzKCdhY3RpdmUnKTsNCiAgICAgICAgfQ0KDQoNCiAgICAgICAgLyoqDQogICAgICAgICogU2V0cyB0aGUgVVJMIGhhc2ggZm9yIGEgc2VjdGlvbiB3aXRoIHNsaWRlcw0KICAgICAgICAqLw0KICAgICAgICBmdW5jdGlvbiBzZXRVUkxIYXNoKHNsaWRlSW5kZXgsIHNsaWRlQW5jaG9yLCBhbmNob3JMaW5rKXsNCiAgICAgICAgICAgIHZhciBzZWN0aW9uSGFzaCA9ICcnOw0KDQogICAgICAgICAgICBpZihvcHRpb25zLmFuY2hvcnMubGVuZ3RoICYmIG9wdGlvbnMuaGFzaENoYW5nZSl7DQoNCiAgICAgICAgICAgICAgICAvL2lzbid0IGl0IHRoZSBmaXJzdCBzbGlkZT8NCiAgICAgICAgICAgICAgICBpZihzbGlkZUluZGV4KXsNCiAgICAgICAgICAgICAgICAgICAgaWYodHlwZW9mIGFuY2hvckxpbmsgIT09ICd1bmRlZmluZWQnKXsNCiAgICAgICAgICAgICAgICAgICAgICAgIHNlY3Rpb25IYXNoID0gYW5jaG9yTGluazsNCiAgICAgICAgICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAgICAgICAgIC8vc2xpZGUgd2l0aG91dCBhbmNob3IgbGluaz8gV2UgdGFrZSB0aGUgaW5kZXggaW5zdGVhZC4NCiAgICAgICAgICAgICAgICAgICAgaWYodHlwZW9mIHNsaWRlQW5jaG9yID09PSAndW5kZWZpbmVkJyl7DQogICAgICAgICAgICAgICAgICAgICAgICBzbGlkZUFuY2hvciA9IHNsaWRlSW5kZXg7DQogICAgICAgICAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgICAgICAgICBsYXN0U2Nyb2xsZWRTbGlkZSA9IHNsaWRlQW5jaG9yOw0KICAgICAgICAgICAgICAgICAgICBsb2NhdGlvbi5oYXNoID0gc2VjdGlvbkhhc2ggKyAnLycgKyBzbGlkZUFuY2hvcjsNCg0KICAgICAgICAgICAgICAgIC8vZmlyc3Qgc2xpZGUgd29uJ3QgaGF2ZSBzbGlkZSBhbmNob3IsIGp1c3QgdGhlIHNlY3Rpb24gb25lDQogICAgICAgICAgICAgICAgfWVsc2UgaWYodHlwZW9mIHNsaWRlSW5kZXggIT09ICd1bmRlZmluZWQnKXsNCiAgICAgICAgICAgICAgICAgICAgbGFzdFNjcm9sbGVkU2xpZGUgPSBzbGlkZUFuY2hvcjsNCiAgICAgICAgICAgICAgICAgICAgbG9jYXRpb24uaGFzaCA9IGFuY2hvckxpbms7DQogICAgICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAgICAgLy9zZWN0aW9uIHdpdGhvdXQgc2xpZGVzDQogICAgICAgICAgICAgICAgZWxzZXsNCiAgICAgICAgICAgICAgICAgICAgbG9jYXRpb24uaGFzaCA9IGFuY2hvckxpbms7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQoNCiAgICAgICAgLyoqDQogICAgICAgICogU2Nyb2xscyB0aGUgc2xpZGVyIHRvIHRoZSBnaXZlbiBzbGlkZSBkZXN0aW5hdGlvbiBmb3IgdGhlIGdpdmVuIHNlY3Rpb24NCiAgICAgICAgKi8NCiAgICAgICAgJChkb2N1bWVudCkub24oJ2NsaWNrJywgJy5mdWxsUGFnZS1zbGlkZXNOYXYgYScsIGZ1bmN0aW9uKGUpew0KICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOw0KICAgICAgICAgICAgdmFyIHNsaWRlcyA9ICQodGhpcykuY2xvc2VzdCgnLnNlY3Rpb24nKS5maW5kKCcuc2xpZGVzJyk7DQogICAgICAgICAgICB2YXIgZGVzdGlueSA9IHNsaWRlcy5maW5kKCcuc2xpZGUnKS5lcSgkKHRoaXMpLmNsb3Nlc3QoJ2xpJykuaW5kZXgoKSk7DQoNCiAgICAgICAgICAgIGxhbmRzY2FwZVNjcm9sbChzbGlkZXMsIGRlc3RpbnkpOw0KICAgICAgICB9KTsNCg0KDQogICAgICAgIC8qKg0KICAgICAgICAqIENoZWNrcyBmb3IgdHJhbnNsYXRlM2Qgc3VwcG9ydA0KICAgICAgICAqIEByZXR1cm4gYm9vbGVhbg0KICAgICAgICAqIGh0dHA6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvNTY2MTY3MS9kZXRlY3RpbmctdHJhbnNmb3JtLXRyYW5zbGF0ZTNkLXN1cHBvcnQNCiAgICAgICAgKi8NCiAgICAgICAgZnVuY3Rpb24gc3VwcG9ydDNkKCkgew0KICAgICAgICAgICAgdmFyIGVsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgncCcpLA0KICAgICAgICAgICAgICAgIGhhczNkLA0KICAgICAgICAgICAgICAgIHRyYW5zZm9ybXMgPSB7DQogICAgICAgICAgICAgICAgICAgICd3ZWJraXRUcmFuc2Zvcm0nOictd2Via2l0LXRyYW5zZm9ybScsDQogICAgICAgICAgICAgICAgICAgICdPVHJhbnNmb3JtJzonLW8tdHJhbnNmb3JtJywNCiAgICAgICAgICAgICAgICAgICAgJ21zVHJhbnNmb3JtJzonLW1zLXRyYW5zZm9ybScsDQogICAgICAgICAgICAgICAgICAgICdNb3pUcmFuc2Zvcm0nOictbW96LXRyYW5zZm9ybScsDQogICAgICAgICAgICAgICAgICAgICd0cmFuc2Zvcm0nOid0cmFuc2Zvcm0nDQogICAgICAgICAgICAgICAgfTsNCg0KICAgICAgICAgICAgLy8gQWRkIGl0IHRvIHRoZSBib2R5IHRvIGdldCB0aGUgY29tcHV0ZWQgc3R5bGUuDQogICAgICAgICAgICBkb2N1bWVudC5ib2R5Lmluc2VydEJlZm9yZShlbCwgbnVsbCk7DQoNCiAgICAgICAgICAgIGZvciAodmFyIHQgaW4gdHJhbnNmb3Jtcykgew0KICAgICAgICAgICAgICAgIGlmIChlbC5zdHlsZVt0XSAhPT0gdW5kZWZpbmVkKSB7DQogICAgICAgICAgICAgICAgICAgIGVsLnN0eWxlW3RdID0gInRyYW5zbGF0ZTNkKDFweCwxcHgsMXB4KSI7DQogICAgICAgICAgICAgICAgICAgIGhhczNkID0gd2luZG93LmdldENvbXB1dGVkU3R5bGUoZWwpLmdldFByb3BlcnR5VmFsdWUodHJhbnNmb3Jtc1t0XSk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICBkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKGVsKTsNCg0KICAgICAgICAgICAgcmV0dXJuIChoYXMzZCAhPT0gdW5kZWZpbmVkICYmIGhhczNkLmxlbmd0aCA+IDAgJiYgaGFzM2QgIT09ICJub25lIik7DQogICAgICAgIH0NCg0KDQoNCiAgICAgICAgLyoqDQogICAgICAgICogUmVtb3ZlcyB0aGUgYXV0byBzY3JvbGxpbmcgYWN0aW9uIGZpcmVkIGJ5IHRoZSBtb3VzZSB3aGVlbCBhbmQgdGFja3BhZC4NCiAgICAgICAgKiBBZnRlciB0aGlzIGZ1bmN0aW9uIGlzIGNhbGxlZCwgdGhlIG1vdXNld2hlZWwgYW5kIHRyYWNrcGFkIG1vdmVtZW50cyB3b24ndCBzY3JvbGwgdGhyb3VnaCBzZWN0aW9ucy4NCiAgICAgICAgKi8NCiAgICAgICAgZnVuY3Rpb24gcmVtb3ZlTW91c2VXaGVlbEhhbmRsZXIoKXsNCiAgICAgICAgICAgIGlmIChkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKSB7DQogICAgICAgICAgICAgICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcignbW91c2V3aGVlbCcsIE1vdXNlV2hlZWxIYW5kbGVyLCBmYWxzZSk7IC8vSUU5LCBDaHJvbWUsIFNhZmFyaSwgT3Blcg0KICAgICAgICAgICAgICAgIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ0RPTU1vdXNlU2Nyb2xsJywgTW91c2VXaGVlbEhhbmRsZXIsIGZhbHNlKTsgLy9GaXJlZm94DQogICAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgICAgIGRvY3VtZW50LmRldGFjaEV2ZW50KCJvbm1vdXNld2hlZWwiLCBNb3VzZVdoZWVsSGFuZGxlcik7IC8vSUUgNi83LzgNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KDQoNCiAgICAgICAgLyoqDQogICAgICAgICogQWRkcyB0aGUgYXV0byBzY3JvbGxpbmcgYWN0aW9uIGZvciB0aGUgbW91c2Ugd2hlZWwgYW5kIHRhY2twYWQuDQogICAgICAgICogQWZ0ZXIgdGhpcyBmdW5jdGlvbiBpcyBjYWxsZWQsIHRoZSBtb3VzZXdoZWVsIGFuZCB0cmFja3BhZCBtb3ZlbWVudHMgd2lsbCBzY3JvbGwgdGhyb3VnaCBzZWN0aW9ucw0KICAgICAgICAqLw0KICAgICAgICBmdW5jdGlvbiBhZGRNb3VzZVdoZWVsSGFuZGxlcigpew0KICAgICAgICAgICAgaWYgKGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIpIHsNCiAgICAgICAgICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCJtb3VzZXdoZWVsIiwgTW91c2VXaGVlbEhhbmRsZXIsIGZhbHNlKTsgLy9JRTksIENocm9tZSwgU2FmYXJpLCBPcGVyDQogICAgICAgICAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigiRE9NTW91c2VTY3JvbGwiLCBNb3VzZVdoZWVsSGFuZGxlciwgZmFsc2UpOyAvL0ZpcmVmb3gNCiAgICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICAgICAgZG9jdW1lbnQuYXR0YWNoRXZlbnQoIm9ubW91c2V3aGVlbCIsIE1vdXNlV2hlZWxIYW5kbGVyKTsgLy9JRSA2LzcvOA0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQoNCg0KICAgICAgICAvKioNCiAgICAgICAgKiBBZGRzIHRoZSBwb3NzaWJpbGl0eSB0byBhdXRvIHNjcm9sbCB0aHJvdWdoIHNlY3Rpb25zIG9uIHRvdWNoIGRldmljZXMuDQogICAgICAgICovDQogICAgICAgIGZ1bmN0aW9uIGFkZFRvdWNoSGFuZGxlcigpew0KICAgICAgICAgICAgaWYoaXNUYWJsZXQpew0KICAgICAgICAgICAgICAgICQoZG9jdW1lbnQpLm9mZigndG91Y2hzdGFydCBNU1BvaW50ZXJEb3duJykub24oJ3RvdWNoc3RhcnQgTVNQb2ludGVyRG93bicsIHRvdWNoU3RhcnRIYW5kbGVyKTsNCiAgICAgICAgICAgICAgICAkKGRvY3VtZW50KS5vZmYoJ3RvdWNobW92ZSBNU1BvaW50ZXJNb3ZlJykub24oJ3RvdWNobW92ZSBNU1BvaW50ZXJNb3ZlJywgdG91Y2hNb3ZlSGFuZGxlcik7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCg0KICAgICAgICAvKioNCiAgICAgICAgKiBSZW1vdmVzIHRoZSBhdXRvIHNjcm9sbGluZyBmb3IgdG91Y2ggZGV2aWNlcy4NCiAgICAgICAgKi8NCiAgICAgICAgZnVuY3Rpb24gcmVtb3ZlVG91Y2hIYW5kbGVyKCl7DQogICAgICAgICAgICBpZihpc1RhYmxldCl7DQogICAgICAgICAgICAgICAgJChkb2N1bWVudCkub2ZmKCd0b3VjaHN0YXJ0IE1TUG9pbnRlckRvd24nKTsNCiAgICAgICAgICAgICAgICAkKGRvY3VtZW50KS5vZmYoJ3RvdWNobW92ZSBNU1BvaW50ZXJNb3ZlJyk7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCg0KICAgICAgICAvKioNCiAgICAgICAgKiBHZXRzIHRoZSBwYWdlWCBhbmQgcGFnZVkgcHJvcGVydGllcyBkZXBlbmRpbmcgb24gdGhlIGJyb3dzZXIuDQogICAgICAgICogaHR0cHM6Ly9naXRodWIuY29tL2FsdmFyb3RyaWdvL2Z1bGxQYWdlLmpzL2lzc3Vlcy8xOTQjaXNzdWVjb21tZW50LTM0MDY5ODU0DQogICAgICAgICovDQogICAgICAgIGZ1bmN0aW9uIGdldEV2ZW50c1BhZ2UoZSl7DQogICAgICAgICAgICB2YXIgZXZlbnRzID0gbmV3IEFycmF5KCk7DQogICAgICAgICAgICBpZiAod2luZG93Lm5hdmlnYXRvci5tc1BvaW50ZXJFbmFibGVkKXsNCiAgICAgICAgICAgICAgICBldmVudHNbJ3knXSA9IGUucGFnZVk7DQogICAgICAgICAgICAgICAgZXZlbnRzWyd4J10gPSBlLnBhZ2VYOw0KICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgZXZlbnRzWyd5J10gPSBlLnRvdWNoZXNbMF0ucGFnZVk7DQogICAgICAgICAgICAgICAgZXZlbnRzWyd4J10gPSAgZS50b3VjaGVzWzBdLnBhZ2VYOw0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICByZXR1cm4gZXZlbnRzOw0KICAgICAgICB9DQoNCiAgICAgICAgZnVuY3Rpb24gc2lsZW50U2Nyb2xsKHRvcCl7DQogICAgICAgICAgICBpZiAob3B0aW9ucy5jc3MzKSB7DQogICAgICAgICAgICAgICAgdmFyIHRyYW5zbGF0ZTNkID0gJ3RyYW5zbGF0ZTNkKDBweCwgLScgKyB0b3AgKyAncHgsIDBweCknOw0KICAgICAgICAgICAgICAgIHRyYW5zZm9ybUNvbnRhaW5lcih0cmFuc2xhdGUzZCwgZmFsc2UpOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgZWxzZSB7DQogICAgICAgICAgICAgICAgJCgiI3N1cGVyQ29udGFpbmVyIikuY3NzKCJ0b3AiLCAtdG9wKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KDQogICAgfTsNCn0pKGpRdWVyeSk7DQo=",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Fri, 07 Nov 2014 01:59:52 GMT",
                    "Content-Length": "54515",
                    "Date": "Fri, 07 Nov 2014 01:59:52 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}