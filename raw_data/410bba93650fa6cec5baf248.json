{
    "url": "http://localhost:9999/chrisjbaik/jquery-mobile/dist/jquery.mobile.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Link manipulation (DOM-based)",
    "issueType": 5246976,
    "severity": "Low",
    "confidence": "Firm",
    "issueBackground": "DOM-based link manipulation vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this to a navigation target within the current page, such as a clickable link or the submission URL of a form. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will modify the target of links within the response. An attacker may be able to leverage this to perform various attacks, including:<ul><li>Causing the user to redirect to an arbitrary external URL, to facilitate a phishing attack.</li><li>Causing the user to submit sensitive form data to a server controlled by the attacker.</li><li>Causing the user to perform an unintended action within the application, by changing the file or query string associated with a link.</li><li>Bypassing browser anti-XSS defenses by injecting on-site links containing XSS exploits, since browser anti-XSS defenses typically do not operate on on-site links.</li></ul>",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based link manipulation vulnerabilities is not to dynamically set the target URLs of links or forms using data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing an arbitrary URL as a link target. In general, this is best achieved by using a whitelist of URLs that are permitted link targets, and strictly validating the target against this list before setting the link target.",
    "issueDetail": "The application may be vulnerable to DOM-based link manipulation. Data is read from <b>location.pathname</b> and written to <b>the 'href' property of a DOM element</b> via the following statement:<ul><li>base[ 0 ].href = href || location.pathname;</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/chrisjbaik/jquery-mobile/dist/jquery.mobile.js",
                "path": "/chrisjbaik/jquery-mobile/dist/jquery.mobile.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9jaHJpc2piYWlrL2pxdWVyeS1tb2JpbGUvZGlzdC9qcXVlcnkubW9iaWxlLmpzIEhUVFAvMS4xDQpIb3N0OiBsb2NhbGhvc3Q6OTk5OQ0KDQo=",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogNDM5MjQ0DQpBY2NlcHQtUmFuZ2VzOiBieXRlcw0KQ29udGVudC1UeXBlOiBhcHBsaWNhdGlvbi9qYXZhc2NyaXB0DQpEYXRlOiBGcmksIDA3IE5vdiAyMDE0IDA2OjQ5OjEwIEdNVA0KTGFzdC1Nb2RpZmllZDogRnJpLCAwNyBOb3YgMjAxNCAwNjo0OTowOCBHTVQNCg0KLyohCiogalF1ZXJ5IE1vYmlsZSAxLjQuMHByZQoqIERhdGU6IFR1ZSBPY3QgMSAyMDEzIDE0OjQzOjMzIFVUQwoqIGh0dHA6Ly9qcXVlcnltb2JpbGUuY29tCioKKiBDb3B5cmlnaHQgMjAxMCwgMjAxMyBqUXVlcnkgRm91bmRhdGlvbiwgSW5jLiBhbmQgb3RoZXIgY29udHJpYnV0b3JzCiogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLgoqIGh0dHA6Ly9qcXVlcnkub3JnL2xpY2Vuc2UKKgoqLwoKCihmdW5jdGlvbiAoIHJvb3QsIGRvYywgZmFjdG9yeSApIHsKCWlmICggdHlwZW9mIGRlZmluZSA9PT0gImZ1bmN0aW9uIiAmJiBkZWZpbmUuYW1kICkgewoJCS8vIEFNRC4gUmVnaXN0ZXIgYXMgYW4gYW5vbnltb3VzIG1vZHVsZS4KCQlkZWZpbmUoIFsgImpxdWVyeSIgXSwgZnVuY3Rpb24gKCAkICkgewoJCQlmYWN0b3J5KCAkLCByb290LCBkb2MgKTsKCQkJcmV0dXJuICQubW9iaWxlOwoJCX0pOwoJfSBlbHNlIHsKCQkvLyBCcm93c2VyIGdsb2JhbHMKCQlmYWN0b3J5KCByb290LmpRdWVyeSwgcm9vdCwgZG9jICk7Cgl9Cn0oIHRoaXMsIGRvY3VtZW50LCBmdW5jdGlvbiAoIGpRdWVyeSwgd2luZG93LCBkb2N1bWVudCwgdW5kZWZpbmVkICkgewooZnVuY3Rpb24oICQgKSB7CgkkLm1vYmlsZSA9IHt9Owp9KCBqUXVlcnkgKSk7CihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgkkLmV4dGVuZCggJC5tb2JpbGUsIHsKCgkJLy8gVmVyc2lvbiBvZiB0aGUgalF1ZXJ5IE1vYmlsZSBGcmFtZXdvcmsKCQl2ZXJzaW9uOiAiMS40LjBwcmUiLAoKCQkvLyBEZXByZWNhdGVkIGFuZCBubyBsb25nZXIgdXNlZCBpbiAxLjQgcmVtb3ZlIGluIDEuNQoJCS8vIERlZmluZSB0aGUgdXJsIHBhcmFtZXRlciB1c2VkIGZvciByZWZlcmVuY2luZyB3aWRnZXQtZ2VuZXJhdGVkIHN1Yi1wYWdlcy4KCQkvLyBUcmFuc2xhdGVzIHRvIGV4YW1wbGUuaHRtbCZ1aS1wYWdlPXN1YnBhZ2VJZGVudGlmaWVyCgkJLy8gaGFzaCBzZWdtZW50IGJlZm9yZSAmdWktcGFnZT0gaXMgdXNlZCB0byBtYWtlIEFqYXggcmVxdWVzdAoJCXN1YlBhZ2VVcmxLZXk6ICJ1aS1wYWdlIiwKCgkJaGlkZVVybEJhcjogdHJ1ZSwKCgkJLy8gS2VlcG5hdGl2ZSBTZWxlY3RvcgoJCWtlZXBOYXRpdmU6ICI6anFtRGF0YShyb2xlPSdub25lJyksIDpqcW1EYXRhKHJvbGU9J25vanMnKSIsCgoJCS8vIERlcHJlY2F0ZWQgaW4gMS40IHJlbW92ZSBpbiAxLjUKCQkvLyBDbGFzcyBhc3NpZ25lZCB0byBwYWdlIGN1cnJlbnRseSBpbiB2aWV3LCBhbmQgZHVyaW5nIHRyYW5zaXRpb25zCgkJYWN0aXZlUGFnZUNsYXNzOiAidWktcGFnZS1hY3RpdmUiLAoKCQkvLyBEZXByZWNhdGVkIGluIDEuNCByZW1vdmUgaW4gMS41CgkJLy8gQ2xhc3MgdXNlZCBmb3IgImFjdGl2ZSIgYnV0dG9uIHN0YXRlLCBmcm9tIENTUyBmcmFtZXdvcmsKCQlhY3RpdmVCdG5DbGFzczogInVpLWJ0bi1hY3RpdmUiLAoKCQkvLyBEZXByZWNhdGVkIGluIDEuNCByZW1vdmUgaW4gMS41CgkJLy8gQ2xhc3MgdXNlZCBmb3IgImZvY3VzIiBmb3JtIGVsZW1lbnQgc3RhdGUsIGZyb20gQ1NTIGZyYW1ld29yawoJCWZvY3VzQ2xhc3M6ICJ1aS1mb2N1cyIsCgoJCS8vIEF1dG9tYXRpY2FsbHkgaGFuZGxlIGNsaWNrcyBhbmQgZm9ybSBzdWJtaXNzaW9ucyB0aHJvdWdoIEFqYXgsIHdoZW4gc2FtZS1kb21haW4KCQlhamF4RW5hYmxlZDogdHJ1ZSwKCgkJLy8gQXV0b21hdGljYWxseSBsb2FkIGFuZCBzaG93IHBhZ2VzIGJhc2VkIG9uIGxvY2F0aW9uLmhhc2gKCQloYXNoTGlzdGVuaW5nRW5hYmxlZDogdHJ1ZSwKCgkJLy8gZGlzYWJsZSB0byBwcmV2ZW50IGpxdWVyeSBmcm9tIGJvdGhlcmluZyB3aXRoIGxpbmtzCgkJbGlua0JpbmRpbmdFbmFibGVkOiB0cnVlLAoKCQkvLyBTZXQgZGVmYXVsdCBwYWdlIHRyYW5zaXRpb24gLSAnbm9uZScgZm9yIG5vIHRyYW5zaXRpb25zCgkJZGVmYXVsdFBhZ2VUcmFuc2l0aW9uOiAiZmFkZSIsCgoJCS8vIFNldCBtYXhpbXVtIHdpbmRvdyB3aWR0aCBmb3IgdHJhbnNpdGlvbnMgdG8gYXBwbHkgLSAnZmFsc2UnIGZvciBubyBsaW1pdAoJCW1heFRyYW5zaXRpb25XaWR0aDogZmFsc2UsCgoJCS8vIE1pbmltdW0gc2Nyb2xsIGRpc3RhbmNlIHRoYXQgd2lsbCBiZSByZW1lbWJlcmVkIHdoZW4gcmV0dXJuaW5nIHRvIGEgcGFnZQoJCS8vIERlcHJlY2F0ZWQgcmVtb3ZlIGluIDEuNSAKCQltaW5TY3JvbGxCYWNrOiAwLAoKCQkvLyBERVBSRUNBVEVEOiB0aGUgZm9sbG93aW5nIHByb3BlcnR5IGlzIG5vIGxvbmdlciBpbiB1c2UsIGJ1dCBkZWZpbmVkIHVudGlsIDIuMCB0byBwcmV2ZW50IGNvbmZsaWN0cwoJCXRvdWNoT3ZlcmZsb3dFbmFibGVkOiBmYWxzZSwKCgkJLy8gU2V0IGRlZmF1bHQgZGlhbG9nIHRyYW5zaXRpb24gLSAnbm9uZScgZm9yIG5vIHRyYW5zaXRpb25zCgkJZGVmYXVsdERpYWxvZ1RyYW5zaXRpb246ICJwb3AiLAoKCQkvLyBFcnJvciByZXNwb25zZSBtZXNzYWdlIC0gYXBwZWFycyB3aGVuIGFuIEFqYXggcGFnZSByZXF1ZXN0IGZhaWxzCgkJcGFnZUxvYWRFcnJvck1lc3NhZ2U6ICJFcnJvciBMb2FkaW5nIFBhZ2UiLAoKCQkvLyBGb3IgZXJyb3IgbWVzc2FnZXMsIHdoaWNoIHRoZW1lIGRvZXMgdGhlIGJveCB1c2VzPwoJCXBhZ2VMb2FkRXJyb3JNZXNzYWdlVGhlbWU6ICJhIiwKCgkJLy8gcmVwbGFjZSBjYWxscyB0byB3aW5kb3cuaGlzdG9yeS5iYWNrIHdpdGggcGhvbmVnYXBzIG5hdmlnYXRpb24gaGVscGVyCgkJLy8gd2hlcmUgaXQgaXMgcHJvdmlkZWQgb24gdGhlIHdpbmRvdyBvYmplY3QKCQlwaG9uZWdhcE5hdmlnYXRpb25FbmFibGVkOiBmYWxzZSwKCgkJLy9hdXRvbWF0aWNhbGx5IGluaXRpYWxpemUgdGhlIERPTSB3aGVuIGl0J3MgcmVhZHkKCQlhdXRvSW5pdGlhbGl6ZVBhZ2U6IHRydWUsCgoJCXB1c2hTdGF0ZUVuYWJsZWQ6IHRydWUsCgoJCS8vIGFsbG93cyB1c2VycyB0byBvcHQgaW4gdG8gaWdub3JpbmcgY29udGVudCBieSBtYXJraW5nIGEgcGFyZW50IGVsZW1lbnQgYXMKCQkvLyBkYXRhLWlnbm9yZWQKCQlpZ25vcmVDb250ZW50RW5hYmxlZDogZmFsc2UsCgoJCWJ1dHRvbk1hcmt1cDogewoJCQlob3ZlckRlbGF5OiAyMDAKCQl9LAoKCQkvLyBkaXNhYmxlIHRoZSBhbHRlcmF0aW9uIG9mIHRoZSBkeW5hbWljIGJhc2UgdGFnIG9yIGxpbmtzIGluIHRoZSBjYXNlCgkJLy8gdGhhdCBhIGR5bmFtaWMgYmFzZSB0YWcgaXNuJ3Qgc3VwcG9ydGVkCgkJZHluYW1pY0Jhc2VFbmFibGVkOiB0cnVlLAoKCQkvLyBkZWZhdWx0IHRoZSBwcm9wZXJ0eSB0byByZW1vdmUgZGVwZW5kZW5jeSBvbiBhc3NpZ25tZW50IGluIGluaXQgbW9kdWxlCgkJcGFnZUNvbnRhaW5lcjogJCgpLAoKCQkvL2VuYWJsZSBjcm9zcy1kb21haW4gcGFnZSBzdXBwb3J0CgkJYWxsb3dDcm9zc0RvbWFpblBhZ2VzOiBmYWxzZSwKCgkJZGlhbG9nSGFzaEtleTogIiZ1aS1zdGF0ZT1kaWFsb2ciCgl9KTsKfSkoIGpRdWVyeSwgdGhpcyApOwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCXZhciBuc05vcm1hbGl6ZURpY3QgPSB7fSwKCQlvbGRGaW5kID0gJC5maW5kLAoJCXJicmFjZSA9IC8oPzpce1tcc1xTXSpcfXxcW1tcc1xTXSpcXSkkLywKCQlqcW1EYXRhUkUgPSAvOmpxbURhdGFcKChbXildKilcKS9nOwoKCSQuZXh0ZW5kKCAkLm1vYmlsZSwgewoKCQkvLyBOYW1lc3BhY2UgdXNlZCBmcmFtZXdvcmstd2lkZSBmb3IgZGF0YS1hdHRycy4gRGVmYXVsdCBpcyBubyBuYW1lc3BhY2UKCgkJbnM6ICIiLAoKCQkvLyBSZXRyaWV2ZSBhbiBhdHRyaWJ1dGUgZnJvbSBhbiBlbGVtZW50IGFuZCBwZXJmb3JtIHNvbWUgbWFzc2FnaW5nIG9mIHRoZSB2YWx1ZQoKCQlnZXRBdHRyaWJ1dGU6IGZ1bmN0aW9uKCBlbGVtZW50LCBrZXkgKSB7CgkJCXZhciBkYXRhOwoKCQkJZWxlbWVudCA9IGVsZW1lbnQuanF1ZXJ5ID8gZWxlbWVudFswXSA6IGVsZW1lbnQ7CgoJCQlpZiggZWxlbWVudCAmJiBlbGVtZW50LmdldEF0dHJpYnV0ZSApewoJCQkJZGF0YSA9IGVsZW1lbnQuZ2V0QXR0cmlidXRlKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyBrZXkgKTsKCQkJfQoKCQkJLy8gQ29waWVkIGZyb20gY29yZSdzIHNyYy9kYXRhLmpzOmRhdGFBdHRyKCkKCQkJLy8gQ29udmVydCBmcm9tIGEgc3RyaW5nIHRvIGEgcHJvcGVyIGRhdGEgdHlwZQoJCQl0cnkgewoJCQkJZGF0YSA9IGRhdGEgPT09ICJ0cnVlIiA/IHRydWUgOgoJCQkJCWRhdGEgPT09ICJmYWxzZSIgPyBmYWxzZSA6CgkJCQkJZGF0YSA9PT0gIm51bGwiID8gbnVsbCA6CgkJCQkJLy8gT25seSBjb252ZXJ0IHRvIGEgbnVtYmVyIGlmIGl0IGRvZXNuJ3QgY2hhbmdlIHRoZSBzdHJpbmcKCQkJCQkrZGF0YSArICIiID09PSBkYXRhID8gK2RhdGEgOgoJCQkJCXJicmFjZS50ZXN0KCBkYXRhICkgPyBKU09OLnBhcnNlKCBkYXRhICkgOgoJCQkJCWRhdGE7CgkJCX0gY2F0Y2goIGVyciApIHt9CgoJCQlyZXR1cm4gZGF0YTsKCQl9LAoKCQkvLyBFeHBvc2Ugb3VyIGNhY2hlIGZvciB0ZXN0aW5nIHB1cnBvc2VzLgoJCW5zTm9ybWFsaXplRGljdDogbnNOb3JtYWxpemVEaWN0LAoKCQkvLyBUYWtlIGEgZGF0YSBhdHRyaWJ1dGUgcHJvcGVydHksIHByZXBlbmQgdGhlIG5hbWVzcGFjZQoJCS8vIGFuZCB0aGVuIGNhbWVsIGNhc2UgdGhlIGF0dHJpYnV0ZSBzdHJpbmcuIEFkZCB0aGUgcmVzdWx0CgkJLy8gdG8gb3VyIG5zTm9ybWFsaXplRGljdCBzbyB3ZSBkb24ndCBoYXZlIHRvIGRvIHRoaXMgYWdhaW4uCgkJbnNOb3JtYWxpemU6IGZ1bmN0aW9uKCBwcm9wICkgewoJCQlyZXR1cm4gbnNOb3JtYWxpemVEaWN0WyBwcm9wIF0gfHwKCQkJCSggbnNOb3JtYWxpemVEaWN0WyBwcm9wIF0gPSAkLmNhbWVsQ2FzZSggJC5tb2JpbGUubnMgKyBwcm9wICkgKTsKCQl9LAoKCQkvLyBGaW5kIHRoZSBjbG9zZXN0IGphdmFzY3JpcHQgcGFnZSBlbGVtZW50IHRvIGdhdGhlciBzZXR0aW5ncyBkYXRhIGpzcGVyZiB0ZXN0CgkJLy8gaHR0cDovL2pzcGVyZi5jb20vc2luZ2xlLWNvbXBsZXgtc2VsZWN0b3ItdnMtbWFueS1jb21wbGV4LXNlbGVjdG9ycy9lZGl0CgkJLy8gcG9zc2libHkgbmFpdmUsIGJ1dCBpdCBzaG93cyB0aGF0IHRoZSBwYXJzaW5nIG92ZXJoZWFkIGZvciAqanVzdCogdGhlIHBhZ2Ugc2VsZWN0b3IgdnMKCQkvLyB0aGUgcGFnZSBhbmQgZGlhbG9nIHNlbGVjdG9yIGlzIG5lZ2xpZ2FibGUuIFRoaXMgY291bGQgcHJvYmFibHkgYmUgc3BlZWQgdXAgYnkKCQkvLyBkb2luZyBhIHNpbWlsYXIgcGFyZW50IG5vZGUgdHJhdmVyc2FsIHRvIHRoZSBvbmUgZm91bmQgaW4gdGhlIGluaGVyaXRlZCB0aGVtZSBjb2RlIGFib3ZlCgkJY2xvc2VzdFBhZ2VEYXRhOiBmdW5jdGlvbiggJHRhcmdldCApIHsKCQkJcmV0dXJuICR0YXJnZXQKCQkJCS5jbG9zZXN0KCAiOmpxbURhdGEocm9sZT0ncGFnZScpLCA6anFtRGF0YShyb2xlPSdkaWFsb2cnKSIgKQoJCQkJLmRhdGEoICJtb2JpbGUtcGFnZSIgKTsKCQl9CgoJfSk7CgoJLy8gTW9iaWxlIHZlcnNpb24gb2YgZGF0YSBhbmQgcmVtb3ZlRGF0YSBhbmQgaGFzRGF0YSBtZXRob2RzCgkvLyBlbnN1cmVzIGFsbCBkYXRhIGlzIHNldCBhbmQgcmV0cmlldmVkIHVzaW5nIGpRdWVyeSBNb2JpbGUncyBkYXRhIG5hbWVzcGFjZQoJJC5mbi5qcW1EYXRhID0gZnVuY3Rpb24oIHByb3AsIHZhbHVlICkgewoJCXZhciByZXN1bHQ7CgkJaWYgKCB0eXBlb2YgcHJvcCAhPT0gInVuZGVmaW5lZCIgKSB7CgkJCWlmICggcHJvcCApIHsKCQkJCXByb3AgPSAkLm1vYmlsZS5uc05vcm1hbGl6ZSggcHJvcCApOwoJCQl9CgoJCQkvLyB1bmRlZmluZWQgaXMgcGVybWl0dGVkIGFzIGFuIGV4cGxpY2l0IGlucHV0IGZvciB0aGUgc2Vjb25kIHBhcmFtCgkJCS8vIGluIHRoaXMgY2FzZSBpdCByZXR1cm5zIHRoZSB2YWx1ZSBhbmQgZG9lcyBub3Qgc2V0IGl0IHRvIHVuZGVmaW5lZAoJCQlpZiAoIGFyZ3VtZW50cy5sZW5ndGggPCAyIHx8IHZhbHVlID09PSB1bmRlZmluZWQgKXsKCQkJCXJlc3VsdCA9IHRoaXMuZGF0YSggcHJvcCApOwoJCQl9IGVsc2UgewoJCQkJcmVzdWx0ID0gdGhpcy5kYXRhKCBwcm9wLCB2YWx1ZSApOwoJCQl9CgkJfQoJCXJldHVybiByZXN1bHQ7Cgl9OwoKCSQuanFtRGF0YSA9IGZ1bmN0aW9uKCBlbGVtLCBwcm9wLCB2YWx1ZSApIHsKCQl2YXIgcmVzdWx0OwoJCWlmICggdHlwZW9mIHByb3AgIT09ICJ1bmRlZmluZWQiICkgewoJCQlyZXN1bHQgPSAkLmRhdGEoIGVsZW0sIHByb3AgPyAkLm1vYmlsZS5uc05vcm1hbGl6ZSggcHJvcCApIDogcHJvcCwgdmFsdWUgKTsKCQl9CgkJcmV0dXJuIHJlc3VsdDsKCX07CgoJJC5mbi5qcW1SZW1vdmVEYXRhID0gZnVuY3Rpb24oIHByb3AgKSB7CgkJcmV0dXJuIHRoaXMucmVtb3ZlRGF0YSggJC5tb2JpbGUubnNOb3JtYWxpemUoIHByb3AgKSApOwoJfTsKCgkkLmpxbVJlbW92ZURhdGEgPSBmdW5jdGlvbiggZWxlbSwgcHJvcCApIHsKCQlyZXR1cm4gJC5yZW1vdmVEYXRhKCBlbGVtLCAkLm1vYmlsZS5uc05vcm1hbGl6ZSggcHJvcCApICk7Cgl9OwoKCSQuZmluZCA9IGZ1bmN0aW9uKCBzZWxlY3RvciwgY29udGV4dCwgcmV0LCBleHRyYSApIHsKCQlpZiAoIHNlbGVjdG9yLmluZGV4T2YoICI6anFtRGF0YSIgKSA+IC0xICkgewoJCQlzZWxlY3RvciA9IHNlbGVjdG9yLnJlcGxhY2UoIGpxbURhdGFSRSwgIltkYXRhLSIgKyAoICQubW9iaWxlLm5zIHx8ICIiICkgKyAiJDFdIiApOwoJCX0KCgkJcmV0dXJuIG9sZEZpbmQuY2FsbCggdGhpcywgc2VsZWN0b3IsIGNvbnRleHQsIHJldCwgZXh0cmEgKTsKCX07CgoJJC5leHRlbmQoICQuZmluZCwgb2xkRmluZCApOwoKfSkoIGpRdWVyeSwgdGhpcyApOwoKLyohCiAqIGpRdWVyeSBVSSBDb3JlIEBWRVJTSU9OCiAqIGh0dHA6Ly9qcXVlcnl1aS5jb20KICoKICogQ29weXJpZ2h0IDIwMTMgalF1ZXJ5IEZvdW5kYXRpb24gYW5kIG90aGVyIGNvbnRyaWJ1dG9ycwogKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuCiAqIGh0dHA6Ly9qcXVlcnkub3JnL2xpY2Vuc2UKICoKICogaHR0cDovL2FwaS5qcXVlcnl1aS5jb20vY2F0ZWdvcnkvdWktY29yZS8KICovCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKdmFyIHV1aWQgPSAwLAoJcnVuaXF1ZUlkID0gL151aS1pZC1cZCskLzsKCi8vICQudWkgbWlnaHQgZXhpc3QgZnJvbSBjb21wb25lbnRzIHdpdGggbm8gZGVwZW5kZW5jaWVzLCBlLmcuLCAkLnVpLnBvc2l0aW9uCiQudWkgPSAkLnVpIHx8IHt9OwoKJC5leHRlbmQoICQudWksIHsKCXZlcnNpb246ICJAVkVSU0lPTiIsCgoJa2V5Q29kZTogewoJCUJBQ0tTUEFDRTogOCwKCQlDT01NQTogMTg4LAoJCURFTEVURTogNDYsCgkJRE9XTjogNDAsCgkJRU5EOiAzNSwKCQlFTlRFUjogMTMsCgkJRVNDQVBFOiAyNywKCQlIT01FOiAzNiwKCQlMRUZUOiAzNywKCQlQQUdFX0RPV046IDM0LAoJCVBBR0VfVVA6IDMzLAoJCVBFUklPRDogMTkwLAoJCVJJR0hUOiAzOSwKCQlTUEFDRTogMzIsCgkJVEFCOiA5LAoJCVVQOiAzOAoJfQp9KTsKCi8vIHBsdWdpbnMKJC5mbi5leHRlbmQoewoJZm9jdXM6IChmdW5jdGlvbiggb3JpZyApIHsKCQlyZXR1cm4gZnVuY3Rpb24oIGRlbGF5LCBmbiApIHsKCQkJcmV0dXJuIHR5cGVvZiBkZWxheSA9PT0gIm51bWJlciIgPwoJCQkJdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJCXZhciBlbGVtID0gdGhpczsKCQkJCQlzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoJCQkJCQkkKCBlbGVtICkuZm9jdXMoKTsKCQkJCQkJaWYgKCBmbiApIHsKCQkJCQkJCWZuLmNhbGwoIGVsZW0gKTsKCQkJCQkJfQoJCQkJCX0sIGRlbGF5ICk7CgkJCQl9KSA6CgkJCQlvcmlnLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsKCQl9OwoJfSkoICQuZm4uZm9jdXMgKSwKCglzY3JvbGxQYXJlbnQ6IGZ1bmN0aW9uKCkgewoJCXZhciBzY3JvbGxQYXJlbnQ7CgkJaWYgKCgkLnVpLmllICYmICgvKHN0YXRpY3xyZWxhdGl2ZSkvKS50ZXN0KHRoaXMuY3NzKCJwb3NpdGlvbiIpKSkgfHwgKC9hYnNvbHV0ZS8pLnRlc3QodGhpcy5jc3MoInBvc2l0aW9uIikpKSB7CgkJCXNjcm9sbFBhcmVudCA9IHRoaXMucGFyZW50cygpLmZpbHRlcihmdW5jdGlvbigpIHsKCQkJCXJldHVybiAoLyhyZWxhdGl2ZXxhYnNvbHV0ZXxmaXhlZCkvKS50ZXN0KCQuY3NzKHRoaXMsInBvc2l0aW9uIikpICYmICgvKGF1dG98c2Nyb2xsKS8pLnRlc3QoJC5jc3ModGhpcywib3ZlcmZsb3ciKSskLmNzcyh0aGlzLCJvdmVyZmxvdy15IikrJC5jc3ModGhpcywib3ZlcmZsb3cteCIpKTsKCQkJfSkuZXEoMCk7CgkJfSBlbHNlIHsKCQkJc2Nyb2xsUGFyZW50ID0gdGhpcy5wYXJlbnRzKCkuZmlsdGVyKGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuICgvKGF1dG98c2Nyb2xsKS8pLnRlc3QoJC5jc3ModGhpcywib3ZlcmZsb3ciKSskLmNzcyh0aGlzLCJvdmVyZmxvdy15IikrJC5jc3ModGhpcywib3ZlcmZsb3cteCIpKTsKCQkJfSkuZXEoMCk7CgkJfQoKCQlyZXR1cm4gKCAvZml4ZWQvICkudGVzdCggdGhpcy5jc3MoICJwb3NpdGlvbiIpICkgfHwgIXNjcm9sbFBhcmVudC5sZW5ndGggPyAkKCB0aGlzWyAwIF0ub3duZXJEb2N1bWVudCB8fCBkb2N1bWVudCApIDogc2Nyb2xsUGFyZW50OwoJfSwKCgl1bmlxdWVJZDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJaWYgKCAhdGhpcy5pZCApIHsKCQkJCXRoaXMuaWQgPSAidWktaWQtIiArICgrK3V1aWQpOwoJCQl9CgkJfSk7Cgl9LAoKCXJlbW92ZVVuaXF1ZUlkOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQlpZiAoIHJ1bmlxdWVJZC50ZXN0KCB0aGlzLmlkICkgKSB7CgkJCQkkKCB0aGlzICkucmVtb3ZlQXR0ciggImlkIiApOwoJCQl9CgkJfSk7Cgl9Cn0pOwoKLy8gc2VsZWN0b3JzCmZ1bmN0aW9uIGZvY3VzYWJsZSggZWxlbWVudCwgaXNUYWJJbmRleE5vdE5hTiApIHsKCXZhciBtYXAsIG1hcE5hbWUsIGltZywKCQlub2RlTmFtZSA9IGVsZW1lbnQubm9kZU5hbWUudG9Mb3dlckNhc2UoKTsKCWlmICggImFyZWEiID09PSBub2RlTmFtZSApIHsKCQltYXAgPSBlbGVtZW50LnBhcmVudE5vZGU7CgkJbWFwTmFtZSA9IG1hcC5uYW1lOwoJCWlmICggIWVsZW1lbnQuaHJlZiB8fCAhbWFwTmFtZSB8fCBtYXAubm9kZU5hbWUudG9Mb3dlckNhc2UoKSAhPT0gIm1hcCIgKSB7CgkJCXJldHVybiBmYWxzZTsKCQl9CgkJaW1nID0gJCggImltZ1t1c2VtYXA9IyIgKyBtYXBOYW1lICsgIl0iIClbMF07CgkJcmV0dXJuICEhaW1nICYmIHZpc2libGUoIGltZyApOwoJfQoJcmV0dXJuICggL2lucHV0fHNlbGVjdHx0ZXh0YXJlYXxidXR0b258b2JqZWN0Ly50ZXN0KCBub2RlTmFtZSApID8KCQkhZWxlbWVudC5kaXNhYmxlZCA6CgkJImEiID09PSBub2RlTmFtZSA/CgkJCWVsZW1lbnQuaHJlZiB8fCBpc1RhYkluZGV4Tm90TmFOIDoKCQkJaXNUYWJJbmRleE5vdE5hTikgJiYKCQkvLyB0aGUgZWxlbWVudCBhbmQgYWxsIG9mIGl0cyBhbmNlc3RvcnMgbXVzdCBiZSB2aXNpYmxlCgkJdmlzaWJsZSggZWxlbWVudCApOwp9CgpmdW5jdGlvbiB2aXNpYmxlKCBlbGVtZW50ICkgewoJcmV0dXJuICQuZXhwci5maWx0ZXJzLnZpc2libGUoIGVsZW1lbnQgKSAmJgoJCSEkKCBlbGVtZW50ICkucGFyZW50cygpLmFkZEJhY2soKS5maWx0ZXIoZnVuY3Rpb24oKSB7CgkJCXJldHVybiAkLmNzcyggdGhpcywgInZpc2liaWxpdHkiICkgPT09ICJoaWRkZW4iOwoJCX0pLmxlbmd0aDsKfQoKJC5leHRlbmQoICQuZXhwclsgIjoiIF0sIHsKCWRhdGE6ICQuZXhwci5jcmVhdGVQc2V1ZG8gPwoJCSQuZXhwci5jcmVhdGVQc2V1ZG8oZnVuY3Rpb24oIGRhdGFOYW1lICkgewoJCQlyZXR1cm4gZnVuY3Rpb24oIGVsZW0gKSB7CgkJCQlyZXR1cm4gISEkLmRhdGEoIGVsZW0sIGRhdGFOYW1lICk7CgkJCX07CgkJfSkgOgoJCS8vIHN1cHBvcnQ6IGpRdWVyeSA8MS44CgkJZnVuY3Rpb24oIGVsZW0sIGksIG1hdGNoICkgewoJCQlyZXR1cm4gISEkLmRhdGEoIGVsZW0sIG1hdGNoWyAzIF0gKTsKCQl9LAoKCWZvY3VzYWJsZTogZnVuY3Rpb24oIGVsZW1lbnQgKSB7CgkJcmV0dXJuIGZvY3VzYWJsZSggZWxlbWVudCwgIWlzTmFOKCAkLmF0dHIoIGVsZW1lbnQsICJ0YWJpbmRleCIgKSApICk7Cgl9LAoKCXRhYmJhYmxlOiBmdW5jdGlvbiggZWxlbWVudCApIHsKCQl2YXIgdGFiSW5kZXggPSAkLmF0dHIoIGVsZW1lbnQsICJ0YWJpbmRleCIgKSwKCQkJaXNUYWJJbmRleE5hTiA9IGlzTmFOKCB0YWJJbmRleCApOwoJCXJldHVybiAoIGlzVGFiSW5kZXhOYU4gfHwgdGFiSW5kZXggPj0gMCApICYmIGZvY3VzYWJsZSggZWxlbWVudCwgIWlzVGFiSW5kZXhOYU4gKTsKCX0KfSk7CgovLyBzdXBwb3J0OiBqUXVlcnkgPDEuOAppZiAoICEkKCAiPGE+IiApLm91dGVyV2lkdGgoIDEgKS5qcXVlcnkgKSB7CgkkLmVhY2goIFsgIldpZHRoIiwgIkhlaWdodCIgXSwgZnVuY3Rpb24oIGksIG5hbWUgKSB7CgkJdmFyIHNpZGUgPSBuYW1lID09PSAiV2lkdGgiID8gWyAiTGVmdCIsICJSaWdodCIgXSA6IFsgIlRvcCIsICJCb3R0b20iIF0sCgkJCXR5cGUgPSBuYW1lLnRvTG93ZXJDYXNlKCksCgkJCW9yaWcgPSB7CgkJCQlpbm5lcldpZHRoOiAkLmZuLmlubmVyV2lkdGgsCgkJCQlpbm5lckhlaWdodDogJC5mbi5pbm5lckhlaWdodCwKCQkJCW91dGVyV2lkdGg6ICQuZm4ub3V0ZXJXaWR0aCwKCQkJCW91dGVySGVpZ2h0OiAkLmZuLm91dGVySGVpZ2h0CgkJCX07CgoJCWZ1bmN0aW9uIHJlZHVjZSggZWxlbSwgc2l6ZSwgYm9yZGVyLCBtYXJnaW4gKSB7CgkJCSQuZWFjaCggc2lkZSwgZnVuY3Rpb24oKSB7CgkJCQlzaXplIC09IHBhcnNlRmxvYXQoICQuY3NzKCBlbGVtLCAicGFkZGluZyIgKyB0aGlzICkgKSB8fCAwOwoJCQkJaWYgKCBib3JkZXIgKSB7CgkJCQkJc2l6ZSAtPSBwYXJzZUZsb2F0KCAkLmNzcyggZWxlbSwgImJvcmRlciIgKyB0aGlzICsgIldpZHRoIiApICkgfHwgMDsKCQkJCX0KCQkJCWlmICggbWFyZ2luICkgewoJCQkJCXNpemUgLT0gcGFyc2VGbG9hdCggJC5jc3MoIGVsZW0sICJtYXJnaW4iICsgdGhpcyApICkgfHwgMDsKCQkJCX0KCQkJfSk7CgkJCXJldHVybiBzaXplOwoJCX0KCgkJJC5mblsgImlubmVyIiArIG5hbWUgXSA9IGZ1bmN0aW9uKCBzaXplICkgewoJCQlpZiAoIHNpemUgPT09IHVuZGVmaW5lZCApIHsKCQkJCXJldHVybiBvcmlnWyAiaW5uZXIiICsgbmFtZSBdLmNhbGwoIHRoaXMgKTsKCQkJfQoKCQkJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJCSQoIHRoaXMgKS5jc3MoIHR5cGUsIHJlZHVjZSggdGhpcywgc2l6ZSApICsgInB4IiApOwoJCQl9KTsKCQl9OwoKCQkkLmZuWyAib3V0ZXIiICsgbmFtZV0gPSBmdW5jdGlvbiggc2l6ZSwgbWFyZ2luICkgewoJCQlpZiAoIHR5cGVvZiBzaXplICE9PSAibnVtYmVyIiApIHsKCQkJCXJldHVybiBvcmlnWyAib3V0ZXIiICsgbmFtZSBdLmNhbGwoIHRoaXMsIHNpemUgKTsKCQkJfQoKCQkJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJCSQoIHRoaXMpLmNzcyggdHlwZSwgcmVkdWNlKCB0aGlzLCBzaXplLCB0cnVlLCBtYXJnaW4gKSArICJweCIgKTsKCQkJfSk7CgkJfTsKCX0pOwp9CgovLyBzdXBwb3J0OiBqUXVlcnkgPDEuOAppZiAoICEkLmZuLmFkZEJhY2sgKSB7CgkkLmZuLmFkZEJhY2sgPSBmdW5jdGlvbiggc2VsZWN0b3IgKSB7CgkJcmV0dXJuIHRoaXMuYWRkKCBzZWxlY3RvciA9PSBudWxsID8KCQkJdGhpcy5wcmV2T2JqZWN0IDogdGhpcy5wcmV2T2JqZWN0LmZpbHRlciggc2VsZWN0b3IgKQoJCSk7Cgl9Owp9CgovLyBzdXBwb3J0OiBqUXVlcnkgMS42LjEsIDEuNi4yIChodHRwOi8vYnVncy5qcXVlcnkuY29tL3RpY2tldC85NDEzKQppZiAoICQoICI8YT4iICkuZGF0YSggImEtYiIsICJhIiApLnJlbW92ZURhdGEoICJhLWIiICkuZGF0YSggImEtYiIgKSApIHsKCSQuZm4ucmVtb3ZlRGF0YSA9IChmdW5jdGlvbiggcmVtb3ZlRGF0YSApIHsKCQlyZXR1cm4gZnVuY3Rpb24oIGtleSApIHsKCQkJaWYgKCBhcmd1bWVudHMubGVuZ3RoICkgewoJCQkJcmV0dXJuIHJlbW92ZURhdGEuY2FsbCggdGhpcywgJC5jYW1lbENhc2UoIGtleSApICk7CgkJCX0gZWxzZSB7CgkJCQlyZXR1cm4gcmVtb3ZlRGF0YS5jYWxsKCB0aGlzICk7CgkJCX0KCQl9OwoJfSkoICQuZm4ucmVtb3ZlRGF0YSApOwp9CgoKCgoKLy8gZGVwcmVjYXRlZAokLnVpLmllID0gISEvbXNpZSBbXHcuXSsvLmV4ZWMoIG5hdmlnYXRvci51c2VyQWdlbnQudG9Mb3dlckNhc2UoKSApOwoKJC5zdXBwb3J0LnNlbGVjdHN0YXJ0ID0gIm9uc2VsZWN0c3RhcnQiIGluIGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJkaXYiICk7CiQuZm4uZXh0ZW5kKHsKCWRpc2FibGVTZWxlY3Rpb246IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLmJpbmQoICggJC5zdXBwb3J0LnNlbGVjdHN0YXJ0ID8gInNlbGVjdHN0YXJ0IiA6ICJtb3VzZWRvd24iICkgKwoJCQkiLnVpLWRpc2FibGVTZWxlY3Rpb24iLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQl9KTsKCX0sCgoJZW5hYmxlU2VsZWN0aW9uOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy51bmJpbmQoICIudWktZGlzYWJsZVNlbGVjdGlvbiIgKTsKCX0sCgoJekluZGV4OiBmdW5jdGlvbiggekluZGV4ICkgewoJCWlmICggekluZGV4ICE9PSB1bmRlZmluZWQgKSB7CgkJCXJldHVybiB0aGlzLmNzcyggInpJbmRleCIsIHpJbmRleCApOwoJCX0KCgkJaWYgKCB0aGlzLmxlbmd0aCApIHsKCQkJdmFyIGVsZW0gPSAkKCB0aGlzWyAwIF0gKSwgcG9zaXRpb24sIHZhbHVlOwoJCQl3aGlsZSAoIGVsZW0ubGVuZ3RoICYmIGVsZW1bIDAgXSAhPT0gZG9jdW1lbnQgKSB7CgkJCQkvLyBJZ25vcmUgei1pbmRleCBpZiBwb3NpdGlvbiBpcyBzZXQgdG8gYSB2YWx1ZSB3aGVyZSB6LWluZGV4IGlzIGlnbm9yZWQgYnkgdGhlIGJyb3dzZXIKCQkJCS8vIFRoaXMgbWFrZXMgYmVoYXZpb3Igb2YgdGhpcyBmdW5jdGlvbiBjb25zaXN0ZW50IGFjcm9zcyBicm93c2VycwoJCQkJLy8gV2ViS2l0IGFsd2F5cyByZXR1cm5zIGF1dG8gaWYgdGhlIGVsZW1lbnQgaXMgcG9zaXRpb25lZAoJCQkJcG9zaXRpb24gPSBlbGVtLmNzcyggInBvc2l0aW9uIiApOwoJCQkJaWYgKCBwb3NpdGlvbiA9PT0gImFic29sdXRlIiB8fCBwb3NpdGlvbiA9PT0gInJlbGF0aXZlIiB8fCBwb3NpdGlvbiA9PT0gImZpeGVkIiApIHsKCQkJCQkvLyBJRSByZXR1cm5zIDAgd2hlbiB6SW5kZXggaXMgbm90IHNwZWNpZmllZAoJCQkJCS8vIG90aGVyIGJyb3dzZXJzIHJldHVybiBhIHN0cmluZwoJCQkJCS8vIHdlIGlnbm9yZSB0aGUgY2FzZSBvZiBuZXN0ZWQgZWxlbWVudHMgd2l0aCBhbiBleHBsaWNpdCB2YWx1ZSBvZiAwCgkJCQkJLy8gPGRpdiBzdHlsZT0iei1pbmRleDogLTEwOyI+PGRpdiBzdHlsZT0iei1pbmRleDogMDsiPjwvZGl2PjwvZGl2PgoJCQkJCXZhbHVlID0gcGFyc2VJbnQoIGVsZW0uY3NzKCAiekluZGV4IiApLCAxMCApOwoJCQkJCWlmICggIWlzTmFOKCB2YWx1ZSApICYmIHZhbHVlICE9PSAwICkgewoJCQkJCQlyZXR1cm4gdmFsdWU7CgkJCQkJfQoJCQkJfQoJCQkJZWxlbSA9IGVsZW0ucGFyZW50KCk7CgkJCX0KCQl9CgoJCXJldHVybiAwOwoJfQp9KTsKCi8vICQudWkucGx1Z2luIGlzIGRlcHJlY2F0ZWQuIFVzZSAkLndpZGdldCgpIGV4dGVuc2lvbnMgaW5zdGVhZC4KJC51aS5wbHVnaW4gPSB7CglhZGQ6IGZ1bmN0aW9uKCBtb2R1bGUsIG9wdGlvbiwgc2V0ICkgewoJCXZhciBpLAoJCQlwcm90byA9ICQudWlbIG1vZHVsZSBdLnByb3RvdHlwZTsKCQlmb3IgKCBpIGluIHNldCApIHsKCQkJcHJvdG8ucGx1Z2luc1sgaSBdID0gcHJvdG8ucGx1Z2luc1sgaSBdIHx8IFtdOwoJCQlwcm90by5wbHVnaW5zWyBpIF0ucHVzaCggWyBvcHRpb24sIHNldFsgaSBdIF0gKTsKCQl9Cgl9LAoJY2FsbDogZnVuY3Rpb24oIGluc3RhbmNlLCBuYW1lLCBhcmdzLCBhbGxvd0Rpc2Nvbm5lY3RlZCApIHsKCQl2YXIgaSwKCQkJc2V0ID0gaW5zdGFuY2UucGx1Z2luc1sgbmFtZSBdOwoKCQlpZiAoICFzZXQgKSB7CgkJCXJldHVybjsKCQl9CgoJCWlmICggIWFsbG93RGlzY29ubmVjdGVkICYmICggIWluc3RhbmNlLmVsZW1lbnRbIDAgXS5wYXJlbnROb2RlIHx8IGluc3RhbmNlLmVsZW1lbnRbIDAgXS5wYXJlbnROb2RlLm5vZGVUeXBlID09PSAxMSApICkgewoJCQlyZXR1cm47CgkJfQoKCQlmb3IgKCBpID0gMDsgaSA8IHNldC5sZW5ndGg7IGkrKyApIHsKCQkJaWYgKCBpbnN0YW5jZS5vcHRpb25zWyBzZXRbIGkgXVsgMCBdIF0gKSB7CgkJCQlzZXRbIGkgXVsgMSBdLmFwcGx5KCBpbnN0YW5jZS5lbGVtZW50LCBhcmdzICk7CgkJCX0KCQl9Cgl9Cn07Cgp9KSggalF1ZXJ5ICk7CihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgoJJC5leHRlbmQoICQubW9iaWxlLCB7CgkJLy8gZGVmaW5lIHRoZSB3aW5kb3cgYW5kIHRoZSBkb2N1bWVudCBvYmplY3RzCgkJd2luZG93OiAkKCB3aW5kb3cgKSwKCQlkb2N1bWVudDogJCggZG9jdW1lbnQgKSwKCgkJLy8gVE9ETzogUmVtb3ZlIGFuZCB1c2UgJC51aS5rZXlDb2RlIGRpcmVjdGx5CgkJa2V5Q29kZTogJC51aS5rZXlDb2RlLAoKCQkvLyBQbGFjZSB0byBzdG9yZSB2YXJpb3VzIHdpZGdldCBleHRlbnNpb25zCgkJYmVoYXZpb3JzOiB7fSwKCgkJLy8gU2Nyb2xsIHBhZ2UgdmVydGljYWxseTogc2Nyb2xsIHRvIDAgdG8gaGlkZSBpT1MgYWRkcmVzcyBiYXIsIG9yIHBhc3MgYSBZIHZhbHVlCgkJc2lsZW50U2Nyb2xsOiBmdW5jdGlvbiggeXBvcyApIHsKCQkJaWYgKCAkLnR5cGUoIHlwb3MgKSAhPT0gIm51bWJlciIgKSB7CgkJCQl5cG9zID0gJC5tb2JpbGUuZGVmYXVsdEhvbWVTY3JvbGw7CgkJCX0KCgkJCS8vIHByZXZlbnQgc2Nyb2xsc3RhcnQgYW5kIHNjcm9sbHN0b3AgZXZlbnRzCgkJCSQuZXZlbnQuc3BlY2lhbC5zY3JvbGxzdGFydC5lbmFibGVkID0gZmFsc2U7CgoJCQlzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoJCQkJd2luZG93LnNjcm9sbFRvKCAwLCB5cG9zICk7CgkJCQkkLm1vYmlsZS5kb2N1bWVudC50cmlnZ2VyKCAic2lsZW50c2Nyb2xsIiwgeyB4OiAwLCB5OiB5cG9zIH0pOwoJCQl9LCAyMCApOwoKCQkJc2V0VGltZW91dChmdW5jdGlvbigpIHsKCQkJCSQuZXZlbnQuc3BlY2lhbC5zY3JvbGxzdGFydC5lbmFibGVkID0gdHJ1ZTsKCQkJfSwgMTUwICk7CgkJfSwKCgkJZ2V0Q2xvc2VzdEJhc2VVcmw6IGZ1bmN0aW9uKCBlbGUgKQl7CgkJCS8vIEZpbmQgdGhlIGNsb3Nlc3QgcGFnZSBhbmQgZXh0cmFjdCBvdXQgaXRzIHVybC4KCQkJdmFyIHVybCA9ICQoIGVsZSApLmNsb3Nlc3QoICIudWktcGFnZSIgKS5qcW1EYXRhKCAidXJsIiApLAoJCQkJYmFzZSA9ICQubW9iaWxlLnBhdGguZG9jdW1lbnRCYXNlLmhyZWZOb0hhc2g7CgoJCQlpZiAoICEkLm1vYmlsZS5keW5hbWljQmFzZUVuYWJsZWQgfHwgIXVybCB8fCAhJC5tb2JpbGUucGF0aC5pc1BhdGgoIHVybCApICkgewoJCQkJdXJsID0gYmFzZTsKCQkJfQoKCQkJcmV0dXJuICQubW9iaWxlLnBhdGgubWFrZVVybEFic29sdXRlKCB1cmwsIGJhc2UgKTsKCQl9LAoJCXJlbW92ZUFjdGl2ZUxpbmtDbGFzczogZnVuY3Rpb24oIGZvcmNlUmVtb3ZhbCApIHsKCQkJaWYgKCAhISQubW9iaWxlLmFjdGl2ZUNsaWNrZWRMaW5rICYmCgkJCQkoICEkLm1vYmlsZS5hY3RpdmVDbGlja2VkTGluay5jbG9zZXN0KCAiLiIgKyAkLm1vYmlsZS5hY3RpdmVQYWdlQ2xhc3MgKS5sZW5ndGggfHwKCQkJCQlmb3JjZVJlbW92YWwgKSApIHsKCgkJCQkkLm1vYmlsZS5hY3RpdmVDbGlja2VkTGluay5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJfQoJCQkkLm1vYmlsZS5hY3RpdmVDbGlja2VkTGluayA9IG51bGw7CgkJfSwKCgkJLy8gREVQUkVDQVRFRCBpbiAxLjQKCQkvLyBGaW5kIHRoZSBjbG9zZXN0IHBhcmVudCB3aXRoIGEgdGhlbWUgY2xhc3Mgb24gaXQuIE5vdGUgdGhhdAoJCS8vIHdlIGFyZSBub3QgdXNpbmcgJC5mbi5jbG9zZXN0KCkgb24gcHVycG9zZSBoZXJlIGJlY2F1c2UgdGhpcwoJCS8vIG1ldGhvZCBnZXRzIGNhbGxlZCBxdWl0ZSBhIGJpdCBhbmQgd2UgbmVlZCBpdCB0byBiZSBhcyBmYXN0CgkJLy8gYXMgcG9zc2libGUuCgkJZ2V0SW5oZXJpdGVkVGhlbWU6IGZ1bmN0aW9uKCBlbCwgZGVmYXVsdFRoZW1lICkgewoJCQl2YXIgZSA9IGVsWyAwIF0sCgkJCQlsdHIgPSAiIiwKCQkJCXJlID0gL3VpLShiYXJ8Ym9keXxvdmVybGF5KS0oW2Etel0pXGIvLAoJCQkJYywgbTsKCQkJd2hpbGUgKCBlICkgewoJCQkJYyA9IGUuY2xhc3NOYW1lIHx8ICIiOwoJCQkJaWYgKCBjICYmICggbSA9IHJlLmV4ZWMoIGMgKSApICYmICggbHRyID0gbVsgMiBdICkgKSB7CgkJCQkJLy8gV2UgZm91bmQgYSBwYXJlbnQgd2l0aCBhIHRoZW1lIGNsYXNzCgkJCQkJLy8gb24gaXQgc28gYmFpbCBmcm9tIHRoaXMgbG9vcC4KCQkJCQlicmVhazsKCQkJCX0KCgkJCQllID0gZS5wYXJlbnROb2RlOwoJCQl9CgkJCS8vIFJldHVybiB0aGUgdGhlbWUgbGV0dGVyIHdlIGZvdW5kLCBpZiBub25lLCByZXR1cm4gdGhlCgkJCS8vIHNwZWNpZmllZCBkZWZhdWx0LgoJCQlyZXR1cm4gbHRyIHx8IGRlZmF1bHRUaGVtZSB8fCAiYSI7CgkJfSwKCgkJZW5oYW5jZWFibGU6IGZ1bmN0aW9uKCBlbGVtZW50cyApIHsKCQkJcmV0dXJuIHRoaXMuaGF2ZVBhcmVudHMoIGVsZW1lbnRzLCAiZW5oYW5jZSIgKTsKCQl9LAoKCQloaWphY2thYmxlOiBmdW5jdGlvbiggZWxlbWVudHMgKSB7CgkJCXJldHVybiB0aGlzLmhhdmVQYXJlbnRzKCBlbGVtZW50cywgImFqYXgiICk7CgkJfSwKCgkJaGF2ZVBhcmVudHM6IGZ1bmN0aW9uKCBlbGVtZW50cywgYXR0ciApIHsKCQkJaWYgKCAhJC5tb2JpbGUuaWdub3JlQ29udGVudEVuYWJsZWQgKSB7CgkJCQlyZXR1cm4gZWxlbWVudHM7CgkJCX0KCgkJCXZhciBjb3VudCA9IGVsZW1lbnRzLmxlbmd0aCwKCQkJCSRuZXdTZXQgPSAkKCksCgkJCQllLCAkZWxlbWVudCwgZXhjbHVkZWQsCgkJCQlpLCBjOwoKCQkJZm9yICggaSA9IDA7IGkgPCBjb3VudDsgaSsrICkgewoJCQkJJGVsZW1lbnQgPSBlbGVtZW50cy5lcSggaSApOwoJCQkJZXhjbHVkZWQgPSBmYWxzZTsKCQkJCWUgPSBlbGVtZW50c1sgaSBdOwoKCQkJCXdoaWxlICggZSApIHsKCQkJCQljID0gZS5nZXRBdHRyaWJ1dGUgPyBlLmdldEF0dHJpYnV0ZSggImRhdGEtIiArICQubW9iaWxlLm5zICsgYXR0ciApIDogIiI7CgoJCQkJCWlmICggYyA9PT0gImZhbHNlIiApIHsKCQkJCQkJZXhjbHVkZWQgPSB0cnVlOwoJCQkJCQlicmVhazsKCQkJCQl9CgoJCQkJCWUgPSBlLnBhcmVudE5vZGU7CgkJCQl9CgoJCQkJaWYgKCAhZXhjbHVkZWQgKSB7CgkJCQkJJG5ld1NldCA9ICRuZXdTZXQuYWRkKCAkZWxlbWVudCApOwoJCQkJfQoJCQl9CgoJCQlyZXR1cm4gJG5ld1NldDsKCQl9LAoKCQlnZXRTY3JlZW5IZWlnaHQ6IGZ1bmN0aW9uKCkgewoJCQkvLyBOYXRpdmUgaW5uZXJIZWlnaHQgcmV0dXJucyBtb3JlIGFjY3VyYXRlIHZhbHVlIGZvciB0aGlzIGFjcm9zcyBwbGF0Zm9ybXMsCgkJCS8vIGpRdWVyeSB2ZXJzaW9uIGlzIGhlcmUgYXMgYSBub3JtYWxpemVkIGZhbGxiYWNrIGZvciBwbGF0Zm9ybXMgbGlrZSBTeW1iaWFuCgkJCXJldHVybiB3aW5kb3cuaW5uZXJIZWlnaHQgfHwgJC5tb2JpbGUud2luZG93LmhlaWdodCgpOwoJCX0sCgoJCS8vc2ltcGx5IHNldCB0aGUgYWN0aXZlIHBhZ2UncyBtaW5pbXVtIGhlaWdodCB0byBzY3JlZW4gaGVpZ2h0LCBkZXBlbmRpbmcgb24gb3JpZW50YXRpb24KCQlyZXNldEFjdGl2ZVBhZ2VIZWlnaHQ6IGZ1bmN0aW9uKCBoZWlnaHQgKSB7CgkJCXZhciBwYWdlID0gJCggIi4iICsgJC5tb2JpbGUuYWN0aXZlUGFnZUNsYXNzICksCgkJCQlwYWdlSGVpZ2h0ID0gcGFnZS5oZWlnaHQoKSwKCQkJCXBhZ2VPdXRlckhlaWdodCA9IHBhZ2Uub3V0ZXJIZWlnaHQoIHRydWUgKTsKCgkJCWhlaWdodCA9ICggdHlwZW9mIGhlaWdodCA9PT0gIm51bWJlciIgKSA/IGhlaWdodCA6ICQubW9iaWxlLmdldFNjcmVlbkhlaWdodCgpOwoKCQkJcGFnZS5jc3MoICJtaW4taGVpZ2h0IiwgaGVpZ2h0IC0gKCBwYWdlT3V0ZXJIZWlnaHQgLSBwYWdlSGVpZ2h0ICkgKTsKCQl9LAoKCQlsb2FkaW5nOiBmdW5jdGlvbigpIHsKCQkJLy8gSWYgdGhpcyBpcyB0aGUgZmlyc3QgY2FsbCB0byB0aGlzIGZ1bmN0aW9uLCBpbnN0YW50aWF0ZSBhIGxvYWRlciB3aWRnZXQKCQkJdmFyIGxvYWRlciA9IHRoaXMubG9hZGluZy5fd2lkZ2V0IHx8ICQoICQubW9iaWxlLmxvYWRlci5wcm90b3R5cGUuZGVmYXVsdEh0bWwgKS5sb2FkZXIoKSwKCgkJCQkvLyBDYWxsIHRoZSBhcHByb3ByaWF0ZSBtZXRob2Qgb24gdGhlIGxvYWRlcgoJCQkJcmV0dXJuVmFsdWUgPSBsb2FkZXIubG9hZGVyLmFwcGx5KCBsb2FkZXIsIGFyZ3VtZW50cyApOwoKCQkJLy8gTWFrZSBzdXJlIHRoZSBsb2FkZXIgaXMgcmV0YWluZWQgZm9yIGZ1dHVyZSBjYWxscyB0byB0aGlzIGZ1bmN0aW9uLgoJCQl0aGlzLmxvYWRpbmcuX3dpZGdldCA9IGxvYWRlcjsKCgkJCXJldHVybiByZXR1cm5WYWx1ZTsKCQl9Cgl9KTsKCgkkLmFkZERlcGVuZGVudHMgPSBmdW5jdGlvbiggZWxlbSwgbmV3RGVwZW5kZW50cyApIHsKCQl2YXIgJGVsZW0gPSAkKCBlbGVtICksCgkJCWRlcGVuZGVudHMgPSAkZWxlbS5qcW1EYXRhKCAiZGVwZW5kZW50cyIgKSB8fCAkKCk7CgoJCSRlbGVtLmpxbURhdGEoICJkZXBlbmRlbnRzIiwgJCggZGVwZW5kZW50cyApLmFkZCggbmV3RGVwZW5kZW50cyApICk7Cgl9OwoKCS8vIHBsdWdpbnMKCSQuZm4uZXh0ZW5kKHsKCQlyZW1vdmVXaXRoRGVwZW5kZW50czogZnVuY3Rpb24oKSB7CgkJCSQucmVtb3ZlV2l0aERlcGVuZGVudHMoIHRoaXMgKTsKCQl9LAoKCQkvLyBFbmhhbmNlIGNoaWxkIGVsZW1lbnRzCgkJZW5oYW5jZVdpdGhpbjogZnVuY3Rpb24oKSB7CgkJCXZhciB3aWRnZXRFbGVtZW50cywKCQkJCXRoYXQgPSB0aGlzOwoKCQkJLy8gQWRkIG5vIGpzIGNsYXNzIHRvIGVsZW1lbnRzCgkJCWlmICggJC5tb2JpbGUubm9qcyApIHsKCQkJCSQubW9iaWxlLm5vanMoIHRoaXMgKTsKCQkJfQoKCQkJLy8gQmluZCBsaW5rcyBmb3IgYWpheCBuYXYKCQkJaWYgKCAkLm1vYmlsZS5saW5rcyApIHsKCQkJCSQubW9iaWxlLmxpbmtzKCB0aGlzICk7CgkJCX0KCgkJCS8vIERlZ3JhZGUgaW5wdXRzIGZvciBzdHlsZWluZwoJCQlpZiAoICQubW9iaWxlLmRlZ3JhZGVJbnB1dHNXaXRoaW4gKSB7CgkJCQkkLm1vYmlsZS5kZWdyYWRlSW5wdXRzV2l0aGluKCB0aGlzICk7CgkJCX0KCgkJCS8vIFJ1biBidXR0b25tYXJrdXAKCQkJaWYgKCAkLmZuLmJ1dHRvbk1hcmt1cCApIHsKCQkJCSQoICQuZm4uYnV0dG9uTWFya3VwLmluaXRTZWxlY3RvciApLmJ1dHRvbk1hcmt1cCgpOwoJCQl9CgoJCQkvLyBBZGQgY2xhc3NlcyBmb3IgZmllbGRDb250YWluCgkJCWlmICggJC5mbi5maWVsZGNvbnRhaW4gKSB7CgkJCQl0aGlzLmZpbmQoICI6anFtRGF0YShyb2xlPSdmaWVsZGNvbnRhaW4nKSIgKS5qcW1FbmhhbmNlYWJsZSgpLmZpZWxkY29udGFpbigpOwoJCQl9CgoJCQkvLyBFbmhhbmNlIHdpZGdldHMKCQkJJC5lYWNoKCAkLm1vYmlsZS53aWRnZXRzLCBmdW5jdGlvbiggbmFtZSwgY29uc3RydWN0b3IgKSB7CgoJCQkJLy8gSWYgaW5pdFNlbGVjdG9yIG5vdCBmYWxzZSBmaW5kIGVsZW1lbnRzCgkJCQlpZiAoIGNvbnN0cnVjdG9yLmluaXRTZWxlY3RvciApIHsKCgkJCQkJLy8gRmlsdGVyIGVsZW1lbnRzIHRoYXQgc2hvdWxkIG5vdCBiZSBlbmhhbmNlZCBiYXNlZCBvbiBwYXJlbnRzCgkJCQkJd2lkZ2V0RWxlbWVudHMgPSAkLm1vYmlsZS5lbmhhbmNlYWJsZSggdGhhdC5maW5kKCBjb25zdHJ1Y3Rvci5pbml0U2VsZWN0b3IgKSApOwoKCQkJCQkvLyBJZiBhbnkgbWF0Y2hpbmcgZWxlbWVudHMgcmVtYWluIGZpbHRlciBvbmVzIHdpdGgga2VlcE5hdGl2ZVNlbGVjdG9yCgkJCQkJaWYgKCB3aWRnZXRFbGVtZW50cy5sZW5ndGggKSB7CgoJCQkJCQkvLyAkLm1vYmlsZS5wYWdlLnByb3RvdHlwZS5rZWVwTmF0aXZlU2VsZWN0b3IgaXMgZGVwcmVjYXRlZCB0aGlzIGlzIGp1c3QgZm9yIGJhY2tjb21wYXQKCQkJCQkJLy8gU3dpdGNoIHRvICQubW9iaWxlLmtlZXBOYXRpdmUgaW4gMS41IHdoaWNoIGlzIGp1c3QgYSB2YWx1ZSBub3QgYSBmdW5jdGlvbgoJCQkJCQl3aWRnZXRFbGVtZW50cyA9IHdpZGdldEVsZW1lbnRzLm5vdCggJC5tb2JpbGUucGFnZS5wcm90b3R5cGUua2VlcE5hdGl2ZVNlbGVjdG9yKCkgKTsKCQkJCQl9CgoJCQkJCS8vIEVuaGFuY2Ugd2hhdGV2ZXIgaXMgbGVmdAoJCQkJCXdpZGdldEVsZW1lbnRzWyBjb25zdHJ1Y3Rvci5wcm90b3R5cGUud2lkZ2V0TmFtZSBdKCk7CgkJCQl9CgkJCX0pOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSwKCgkJYWRkRGVwZW5kZW50czogZnVuY3Rpb24oIG5ld0RlcGVuZGVudHMgKSB7CgkJCSQuYWRkRGVwZW5kZW50cyggdGhpcywgbmV3RGVwZW5kZW50cyApOwoJCX0sCgoJCS8vIG5vdGUgdGhhdCB0aGlzIGhlbHBlciBkb2Vzbid0IGF0dGVtcHQgdG8gaGFuZGxlIHRoZSBjYWxsYmFjawoJCS8vIG9yIHNldHRpbmcgb2YgYW4gaHRtbCBlbGVtZW50J3MgdGV4dCwgaXRzIG9ubHkgcHVycG9zZSBpcwoJCS8vIHRvIHJldHVybiB0aGUgaHRtbCBlbmNvZGVkIHZlcnNpb24gb2YgdGhlIHRleHQgaW4gYWxsIGNhc2VzLiAodGh1cyB0aGUgbmFtZSkKCQlnZXRFbmNvZGVkVGV4dDogZnVuY3Rpb24oKSB7CgkJCXJldHVybiAkKCAiPGE+IiApLnRleHQoIHRoaXMudGV4dCgpICkuaHRtbCgpOwoJCX0sCgoJCS8vIGZsdWVudCBoZWxwZXIgZnVuY3Rpb24gZm9yIHRoZSBtb2JpbGUgbmFtZXNwYWNlZCBlcXVpdmFsZW50CgkJanFtRW5oYW5jZWFibGU6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gJC5tb2JpbGUuZW5oYW5jZWFibGUoIHRoaXMgKTsKCQl9LAoKCQlqcW1IaWphY2thYmxlOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuICQubW9iaWxlLmhpamFja2FibGUoIHRoaXMgKTsKCQl9Cgl9KTsKCgkkLnJlbW92ZVdpdGhEZXBlbmRlbnRzID0gZnVuY3Rpb24oIG5hdGl2ZUVsZW1lbnQgKSB7CgkJdmFyIGVsZW1lbnQgPSAkKCBuYXRpdmVFbGVtZW50ICk7CgoJCSggZWxlbWVudC5qcW1EYXRhKCAiZGVwZW5kZW50cyIgKSB8fCAkKCkgKS5yZW1vdmUoKTsKCQllbGVtZW50LnJlbW92ZSgpOwoJfTsKCSQuYWRkRGVwZW5kZW50cyA9IGZ1bmN0aW9uKCBuYXRpdmVFbGVtZW50LCBuZXdEZXBlbmRlbnRzICkgewoJCXZhciBlbGVtZW50ID0gJCggbmF0aXZlRWxlbWVudCApLAoJCQlkZXBlbmRlbnRzID0gZWxlbWVudC5qcW1EYXRhKCAiZGVwZW5kZW50cyIgKSB8fCAkKCk7CgoJCWVsZW1lbnQuanFtRGF0YSggImRlcGVuZGVudHMiLCAkKCBkZXBlbmRlbnRzICkuYWRkKCBuZXdEZXBlbmRlbnRzICkgKTsKCX07CgoJJC5maW5kLm1hdGNoZXMgPSBmdW5jdGlvbiggZXhwciwgc2V0ICkgewoJCXJldHVybiAkLmZpbmQoIGV4cHIsIG51bGwsIG51bGwsIHNldCApOwoJfTsKCgkkLmZpbmQubWF0Y2hlc1NlbGVjdG9yID0gZnVuY3Rpb24oIG5vZGUsIGV4cHIgKSB7CgkJcmV0dXJuICQuZmluZCggZXhwciwgbnVsbCwgbnVsbCwgWyBub2RlIF0gKS5sZW5ndGggPiAwOwoJfTsKCn0pKCBqUXVlcnksIHRoaXMgKTsKCgovKiEKICogalF1ZXJ5IFVJIFdpZGdldCBAVkVSU0lPTgogKiBodHRwOi8vanF1ZXJ5dWkuY29tCiAqCiAqIENvcHlyaWdodCAyMDEzIGpRdWVyeSBGb3VuZGF0aW9uIGFuZCBvdGhlciBjb250cmlidXRvcnMKICogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLgogKiBodHRwOi8vanF1ZXJ5Lm9yZy9saWNlbnNlCiAqCiAqIGh0dHA6Ly9hcGkuanF1ZXJ5dWkuY29tL2pRdWVyeS53aWRnZXQvCiAqLwooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCnZhciB1dWlkID0gMCwKCXNsaWNlID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLAoJX2NsZWFuRGF0YSA9ICQuY2xlYW5EYXRhOwokLmNsZWFuRGF0YSA9IGZ1bmN0aW9uKCBlbGVtcyApIHsKCWZvciAoIHZhciBpID0gMCwgZWxlbTsgKGVsZW0gPSBlbGVtc1tpXSkgIT0gbnVsbDsgaSsrICkgewoJCXRyeSB7CgkJCSQoIGVsZW0gKS50cmlnZ2VySGFuZGxlciggInJlbW92ZSIgKTsKCQkvLyBodHRwOi8vYnVncy5qcXVlcnkuY29tL3RpY2tldC84MjM1CgkJfSBjYXRjaCggZSApIHt9Cgl9CglfY2xlYW5EYXRhKCBlbGVtcyApOwp9OwoKJC53aWRnZXQgPSBmdW5jdGlvbiggbmFtZSwgYmFzZSwgcHJvdG90eXBlICkgewoJdmFyIGZ1bGxOYW1lLCBleGlzdGluZ0NvbnN0cnVjdG9yLCBjb25zdHJ1Y3RvciwgYmFzZVByb3RvdHlwZSwKCQkvLyBwcm94aWVkUHJvdG90eXBlIGFsbG93cyB0aGUgcHJvdmlkZWQgcHJvdG90eXBlIHRvIHJlbWFpbiB1bm1vZGlmaWVkCgkJLy8gc28gdGhhdCBpdCBjYW4gYmUgdXNlZCBhcyBhIG1peGluIGZvciBtdWx0aXBsZSB3aWRnZXRzICgjODg3NikKCQlwcm94aWVkUHJvdG90eXBlID0ge30sCgkJbmFtZXNwYWNlID0gbmFtZS5zcGxpdCggIi4iIClbIDAgXTsKCgluYW1lID0gbmFtZS5zcGxpdCggIi4iIClbIDEgXTsKCWZ1bGxOYW1lID0gbmFtZXNwYWNlICsgIi0iICsgbmFtZTsKCglpZiAoICFwcm90b3R5cGUgKSB7CgkJcHJvdG90eXBlID0gYmFzZTsKCQliYXNlID0gJC5XaWRnZXQ7Cgl9CgoJLy8gY3JlYXRlIHNlbGVjdG9yIGZvciBwbHVnaW4KCSQuZXhwclsgIjoiIF1bIGZ1bGxOYW1lLnRvTG93ZXJDYXNlKCkgXSA9IGZ1bmN0aW9uKCBlbGVtICkgewoJCXJldHVybiAhISQuZGF0YSggZWxlbSwgZnVsbE5hbWUgKTsKCX07CgoJJFsgbmFtZXNwYWNlIF0gPSAkWyBuYW1lc3BhY2UgXSB8fCB7fTsKCWV4aXN0aW5nQ29uc3RydWN0b3IgPSAkWyBuYW1lc3BhY2UgXVsgbmFtZSBdOwoJY29uc3RydWN0b3IgPSAkWyBuYW1lc3BhY2UgXVsgbmFtZSBdID0gZnVuY3Rpb24oIG9wdGlvbnMsIGVsZW1lbnQgKSB7CgkJLy8gYWxsb3cgaW5zdGFudGlhdGlvbiB3aXRob3V0ICJuZXciIGtleXdvcmQKCQlpZiAoICF0aGlzLl9jcmVhdGVXaWRnZXQgKSB7CgkJCXJldHVybiBuZXcgY29uc3RydWN0b3IoIG9wdGlvbnMsIGVsZW1lbnQgKTsKCQl9CgoJCS8vIGFsbG93IGluc3RhbnRpYXRpb24gd2l0aG91dCBpbml0aWFsaXppbmcgZm9yIHNpbXBsZSBpbmhlcml0YW5jZQoJCS8vIG11c3QgdXNlICJuZXciIGtleXdvcmQgKHRoZSBjb2RlIGFib3ZlIGFsd2F5cyBwYXNzZXMgYXJncykKCQlpZiAoIGFyZ3VtZW50cy5sZW5ndGggKSB7CgkJCXRoaXMuX2NyZWF0ZVdpZGdldCggb3B0aW9ucywgZWxlbWVudCApOwoJCX0KCX07CgkvLyBleHRlbmQgd2l0aCB0aGUgZXhpc3RpbmcgY29uc3RydWN0b3IgdG8gY2Fycnkgb3ZlciBhbnkgc3RhdGljIHByb3BlcnRpZXMKCSQuZXh0ZW5kKCBjb25zdHJ1Y3RvciwgZXhpc3RpbmdDb25zdHJ1Y3RvciwgewoJCXZlcnNpb246IHByb3RvdHlwZS52ZXJzaW9uLAoJCS8vIGNvcHkgdGhlIG9iamVjdCB1c2VkIHRvIGNyZWF0ZSB0aGUgcHJvdG90eXBlIGluIGNhc2Ugd2UgbmVlZCB0bwoJCS8vIHJlZGVmaW5lIHRoZSB3aWRnZXQgbGF0ZXIKCQlfcHJvdG86ICQuZXh0ZW5kKCB7fSwgcHJvdG90eXBlICksCgkJLy8gdHJhY2sgd2lkZ2V0cyB0aGF0IGluaGVyaXQgZnJvbSB0aGlzIHdpZGdldCBpbiBjYXNlIHRoaXMgd2lkZ2V0IGlzCgkJLy8gcmVkZWZpbmVkIGFmdGVyIGEgd2lkZ2V0IGluaGVyaXRzIGZyb20gaXQKCQlfY2hpbGRDb25zdHJ1Y3RvcnM6IFtdCgl9KTsKCgliYXNlUHJvdG90eXBlID0gbmV3IGJhc2UoKTsKCS8vIHdlIG5lZWQgdG8gbWFrZSB0aGUgb3B0aW9ucyBoYXNoIGEgcHJvcGVydHkgZGlyZWN0bHkgb24gdGhlIG5ldyBpbnN0YW5jZQoJLy8gb3RoZXJ3aXNlIHdlJ2xsIG1vZGlmeSB0aGUgb3B0aW9ucyBoYXNoIG9uIHRoZSBwcm90b3R5cGUgdGhhdCB3ZSdyZQoJLy8gaW5oZXJpdGluZyBmcm9tCgliYXNlUHJvdG90eXBlLm9wdGlvbnMgPSAkLndpZGdldC5leHRlbmQoIHt9LCBiYXNlUHJvdG90eXBlLm9wdGlvbnMgKTsKCSQuZWFjaCggcHJvdG90eXBlLCBmdW5jdGlvbiggcHJvcCwgdmFsdWUgKSB7CgkJaWYgKCAhJC5pc0Z1bmN0aW9uKCB2YWx1ZSApICkgewoJCQlwcm94aWVkUHJvdG90eXBlWyBwcm9wIF0gPSB2YWx1ZTsKCQkJcmV0dXJuOwoJCX0KCQlwcm94aWVkUHJvdG90eXBlWyBwcm9wIF0gPSAoZnVuY3Rpb24oKSB7CgkJCXZhciBfc3VwZXIgPSBmdW5jdGlvbigpIHsKCQkJCQlyZXR1cm4gYmFzZS5wcm90b3R5cGVbIHByb3AgXS5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgkJCQl9LAoJCQkJX3N1cGVyQXBwbHkgPSBmdW5jdGlvbiggYXJncyApIHsKCQkJCQlyZXR1cm4gYmFzZS5wcm90b3R5cGVbIHByb3AgXS5hcHBseSggdGhpcywgYXJncyApOwoJCQkJfTsKCQkJcmV0dXJuIGZ1bmN0aW9uKCkgewoJCQkJdmFyIF9fc3VwZXIgPSB0aGlzLl9zdXBlciwKCQkJCQlfX3N1cGVyQXBwbHkgPSB0aGlzLl9zdXBlckFwcGx5LAoJCQkJCXJldHVyblZhbHVlOwoKCQkJCXRoaXMuX3N1cGVyID0gX3N1cGVyOwoJCQkJdGhpcy5fc3VwZXJBcHBseSA9IF9zdXBlckFwcGx5OwoKCQkJCXJldHVyblZhbHVlID0gdmFsdWUuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwoKCQkJCXRoaXMuX3N1cGVyID0gX19zdXBlcjsKCQkJCXRoaXMuX3N1cGVyQXBwbHkgPSBfX3N1cGVyQXBwbHk7CgoJCQkJcmV0dXJuIHJldHVyblZhbHVlOwoJCQl9OwoJCX0pKCk7Cgl9KTsKCWNvbnN0cnVjdG9yLnByb3RvdHlwZSA9ICQud2lkZ2V0LmV4dGVuZCggYmFzZVByb3RvdHlwZSwgewoJCS8vIFRPRE86IHJlbW92ZSBzdXBwb3J0IGZvciB3aWRnZXRFdmVudFByZWZpeAoJCS8vIGFsd2F5cyB1c2UgdGhlIG5hbWUgKyBhIGNvbG9uIGFzIHRoZSBwcmVmaXgsIGUuZy4sIGRyYWdnYWJsZTpzdGFydAoJCS8vIGRvbid0IHByZWZpeCBmb3Igd2lkZ2V0cyB0aGF0IGFyZW4ndCBET00tYmFzZWQKCQl3aWRnZXRFdmVudFByZWZpeDogZXhpc3RpbmdDb25zdHJ1Y3RvciA/IChiYXNlUHJvdG90eXBlLndpZGdldEV2ZW50UHJlZml4IHx8IG5hbWUpIDogbmFtZQoJfSwgcHJveGllZFByb3RvdHlwZSwgewoJCWNvbnN0cnVjdG9yOiBjb25zdHJ1Y3RvciwKCQluYW1lc3BhY2U6IG5hbWVzcGFjZSwKCQl3aWRnZXROYW1lOiBuYW1lLAoJCXdpZGdldEZ1bGxOYW1lOiBmdWxsTmFtZQoJfSk7CgoJLy8gSWYgdGhpcyB3aWRnZXQgaXMgYmVpbmcgcmVkZWZpbmVkIHRoZW4gd2UgbmVlZCB0byBmaW5kIGFsbCB3aWRnZXRzIHRoYXQKCS8vIGFyZSBpbmhlcml0aW5nIGZyb20gaXQgYW5kIHJlZGVmaW5lIGFsbCBvZiB0aGVtIHNvIHRoYXQgdGhleSBpbmhlcml0IGZyb20KCS8vIHRoZSBuZXcgdmVyc2lvbiBvZiB0aGlzIHdpZGdldC4gV2UncmUgZXNzZW50aWFsbHkgdHJ5aW5nIHRvIHJlcGxhY2Ugb25lCgkvLyBsZXZlbCBpbiB0aGUgcHJvdG90eXBlIGNoYWluLgoJaWYgKCBleGlzdGluZ0NvbnN0cnVjdG9yICkgewoJCSQuZWFjaCggZXhpc3RpbmdDb25zdHJ1Y3Rvci5fY2hpbGRDb25zdHJ1Y3RvcnMsIGZ1bmN0aW9uKCBpLCBjaGlsZCApIHsKCQkJdmFyIGNoaWxkUHJvdG90eXBlID0gY2hpbGQucHJvdG90eXBlOwoKCQkJLy8gcmVkZWZpbmUgdGhlIGNoaWxkIHdpZGdldCB1c2luZyB0aGUgc2FtZSBwcm90b3R5cGUgdGhhdCB3YXMKCQkJLy8gb3JpZ2luYWxseSB1c2VkLCBidXQgaW5oZXJpdCBmcm9tIHRoZSBuZXcgdmVyc2lvbiBvZiB0aGUgYmFzZQoJCQkkLndpZGdldCggY2hpbGRQcm90b3R5cGUubmFtZXNwYWNlICsgIi4iICsgY2hpbGRQcm90b3R5cGUud2lkZ2V0TmFtZSwgY29uc3RydWN0b3IsIGNoaWxkLl9wcm90byApOwoJCX0pOwoJCS8vIHJlbW92ZSB0aGUgbGlzdCBvZiBleGlzdGluZyBjaGlsZCBjb25zdHJ1Y3RvcnMgZnJvbSB0aGUgb2xkIGNvbnN0cnVjdG9yCgkJLy8gc28gdGhlIG9sZCBjaGlsZCBjb25zdHJ1Y3RvcnMgY2FuIGJlIGdhcmJhZ2UgY29sbGVjdGVkCgkJZGVsZXRlIGV4aXN0aW5nQ29uc3RydWN0b3IuX2NoaWxkQ29uc3RydWN0b3JzOwoJfSBlbHNlIHsKCQliYXNlLl9jaGlsZENvbnN0cnVjdG9ycy5wdXNoKCBjb25zdHJ1Y3RvciApOwoJfQoKCSQud2lkZ2V0LmJyaWRnZSggbmFtZSwgY29uc3RydWN0b3IgKTsKCglyZXR1cm4gY29uc3RydWN0b3I7Cn07CgokLndpZGdldC5leHRlbmQgPSBmdW5jdGlvbiggdGFyZ2V0ICkgewoJdmFyIGlucHV0ID0gc2xpY2UuY2FsbCggYXJndW1lbnRzLCAxICksCgkJaW5wdXRJbmRleCA9IDAsCgkJaW5wdXRMZW5ndGggPSBpbnB1dC5sZW5ndGgsCgkJa2V5LAoJCXZhbHVlOwoJZm9yICggOyBpbnB1dEluZGV4IDwgaW5wdXRMZW5ndGg7IGlucHV0SW5kZXgrKyApIHsKCQlmb3IgKCBrZXkgaW4gaW5wdXRbIGlucHV0SW5kZXggXSApIHsKCQkJdmFsdWUgPSBpbnB1dFsgaW5wdXRJbmRleCBdWyBrZXkgXTsKCQkJaWYgKCBpbnB1dFsgaW5wdXRJbmRleCBdLmhhc093blByb3BlcnR5KCBrZXkgKSAmJiB2YWx1ZSAhPT0gdW5kZWZpbmVkICkgewoJCQkJLy8gQ2xvbmUgb2JqZWN0cwoJCQkJaWYgKCAkLmlzUGxhaW5PYmplY3QoIHZhbHVlICkgKSB7CgkJCQkJdGFyZ2V0WyBrZXkgXSA9ICQuaXNQbGFpbk9iamVjdCggdGFyZ2V0WyBrZXkgXSApID8KCQkJCQkJJC53aWRnZXQuZXh0ZW5kKCB7fSwgdGFyZ2V0WyBrZXkgXSwgdmFsdWUgKSA6CgkJCQkJCS8vIERvbid0IGV4dGVuZCBzdHJpbmdzLCBhcnJheXMsIGV0Yy4gd2l0aCBvYmplY3RzCgkJCQkJCSQud2lkZ2V0LmV4dGVuZCgge30sIHZhbHVlICk7CgkJCQkvLyBDb3B5IGV2ZXJ5dGhpbmcgZWxzZSBieSByZWZlcmVuY2UKCQkJCX0gZWxzZSB7CgkJCQkJdGFyZ2V0WyBrZXkgXSA9IHZhbHVlOwoJCQkJfQoJCQl9CgkJfQoJfQoJcmV0dXJuIHRhcmdldDsKfTsKCiQud2lkZ2V0LmJyaWRnZSA9IGZ1bmN0aW9uKCBuYW1lLCBvYmplY3QgKSB7Cgl2YXIgZnVsbE5hbWUgPSBvYmplY3QucHJvdG90eXBlLndpZGdldEZ1bGxOYW1lIHx8IG5hbWU7CgkkLmZuWyBuYW1lIF0gPSBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQl2YXIgaXNNZXRob2RDYWxsID0gdHlwZW9mIG9wdGlvbnMgPT09ICJzdHJpbmciLAoJCQlhcmdzID0gc2xpY2UuY2FsbCggYXJndW1lbnRzLCAxICksCgkJCXJldHVyblZhbHVlID0gdGhpczsKCgkJLy8gYWxsb3cgbXVsdGlwbGUgaGFzaGVzIHRvIGJlIHBhc3NlZCBvbiBpbml0CgkJb3B0aW9ucyA9ICFpc01ldGhvZENhbGwgJiYgYXJncy5sZW5ndGggPwoJCQkkLndpZGdldC5leHRlbmQuYXBwbHkoIG51bGwsIFsgb3B0aW9ucyBdLmNvbmNhdChhcmdzKSApIDoKCQkJb3B0aW9uczsKCgkJaWYgKCBpc01ldGhvZENhbGwgKSB7CgkJCXRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJCXZhciBtZXRob2RWYWx1ZSwKCQkJCQlpbnN0YW5jZSA9ICQuZGF0YSggdGhpcywgZnVsbE5hbWUgKTsKCQkJCWlmICggb3B0aW9ucyA9PT0gImluc3RhbmNlIiApIHsKCQkJCQlyZXR1cm5WYWx1ZSA9IGluc3RhbmNlOwoJCQkJCXJldHVybiBmYWxzZTsKCQkJCX0KCQkJCWlmICggIWluc3RhbmNlICkgewoJCQkJCXJldHVybiAkLmVycm9yKCAiY2Fubm90IGNhbGwgbWV0aG9kcyBvbiAiICsgbmFtZSArICIgcHJpb3IgdG8gaW5pdGlhbGl6YXRpb247ICIgKwoJCQkJCQkiYXR0ZW1wdGVkIHRvIGNhbGwgbWV0aG9kICciICsgb3B0aW9ucyArICInIiApOwoJCQkJfQoJCQkJaWYgKCAhJC5pc0Z1bmN0aW9uKCBpbnN0YW5jZVtvcHRpb25zXSApIHx8IG9wdGlvbnMuY2hhckF0KCAwICkgPT09ICJfIiApIHsKCQkJCQlyZXR1cm4gJC5lcnJvciggIm5vIHN1Y2ggbWV0aG9kICciICsgb3B0aW9ucyArICInIGZvciAiICsgbmFtZSArICIgd2lkZ2V0IGluc3RhbmNlIiApOwoJCQkJfQoJCQkJbWV0aG9kVmFsdWUgPSBpbnN0YW5jZVsgb3B0aW9ucyBdLmFwcGx5KCBpbnN0YW5jZSwgYXJncyApOwoJCQkJaWYgKCBtZXRob2RWYWx1ZSAhPT0gaW5zdGFuY2UgJiYgbWV0aG9kVmFsdWUgIT09IHVuZGVmaW5lZCApIHsKCQkJCQlyZXR1cm5WYWx1ZSA9IG1ldGhvZFZhbHVlICYmIG1ldGhvZFZhbHVlLmpxdWVyeSA/CgkJCQkJCXJldHVyblZhbHVlLnB1c2hTdGFjayggbWV0aG9kVmFsdWUuZ2V0KCkgKSA6CgkJCQkJCW1ldGhvZFZhbHVlOwoJCQkJCXJldHVybiBmYWxzZTsKCQkJCX0KCQkJfSk7CgkJfSBlbHNlIHsKCQkJdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJdmFyIGluc3RhbmNlID0gJC5kYXRhKCB0aGlzLCBmdWxsTmFtZSApOwoJCQkJaWYgKCBpbnN0YW5jZSApIHsKCQkJCQlpbnN0YW5jZS5vcHRpb24oIG9wdGlvbnMgfHwge30gKS5faW5pdCgpOwoJCQkJfSBlbHNlIHsKCQkJCQkkLmRhdGEoIHRoaXMsIGZ1bGxOYW1lLCBuZXcgb2JqZWN0KCBvcHRpb25zLCB0aGlzICkgKTsKCQkJCX0KCQkJfSk7CgkJfQoKCQlyZXR1cm4gcmV0dXJuVmFsdWU7Cgl9Owp9OwoKJC5XaWRnZXQgPSBmdW5jdGlvbiggLyogb3B0aW9ucywgZWxlbWVudCAqLyApIHt9OwokLldpZGdldC5fY2hpbGRDb25zdHJ1Y3RvcnMgPSBbXTsKCiQuV2lkZ2V0LnByb3RvdHlwZSA9IHsKCXdpZGdldE5hbWU6ICJ3aWRnZXQiLAoJd2lkZ2V0RXZlbnRQcmVmaXg6ICIiLAoJZGVmYXVsdEVsZW1lbnQ6ICI8ZGl2PiIsCglvcHRpb25zOiB7CgkJZGlzYWJsZWQ6IGZhbHNlLAoKCQkvLyBjYWxsYmFja3MKCQljcmVhdGU6IG51bGwKCX0sCglfY3JlYXRlV2lkZ2V0OiBmdW5jdGlvbiggb3B0aW9ucywgZWxlbWVudCApIHsKCQllbGVtZW50ID0gJCggZWxlbWVudCB8fCB0aGlzLmRlZmF1bHRFbGVtZW50IHx8IHRoaXMgKVsgMCBdOwoJCXRoaXMuZWxlbWVudCA9ICQoIGVsZW1lbnQgKTsKCQl0aGlzLnV1aWQgPSB1dWlkKys7CgkJdGhpcy5ldmVudE5hbWVzcGFjZSA9ICIuIiArIHRoaXMud2lkZ2V0TmFtZSArIHRoaXMudXVpZDsKCQl0aGlzLm9wdGlvbnMgPSAkLndpZGdldC5leHRlbmQoIHt9LAoJCQl0aGlzLm9wdGlvbnMsCgkJCXRoaXMuX2dldENyZWF0ZU9wdGlvbnMoKSwKCQkJb3B0aW9ucyApOwoKCQl0aGlzLmJpbmRpbmdzID0gJCgpOwoJCXRoaXMuaG92ZXJhYmxlID0gJCgpOwoJCXRoaXMuZm9jdXNhYmxlID0gJCgpOwoKCQlpZiAoIGVsZW1lbnQgIT09IHRoaXMgKSB7CgkJCSQuZGF0YSggZWxlbWVudCwgdGhpcy53aWRnZXRGdWxsTmFtZSwgdGhpcyApOwoJCQl0aGlzLl9vbiggdHJ1ZSwgdGhpcy5lbGVtZW50LCB7CgkJCQlyZW1vdmU6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCQlpZiAoIGV2ZW50LnRhcmdldCA9PT0gZWxlbWVudCApIHsKCQkJCQkJdGhpcy5kZXN0cm95KCk7CgkJCQkJfQoJCQkJfQoJCQl9KTsKCQkJdGhpcy5kb2N1bWVudCA9ICQoIGVsZW1lbnQuc3R5bGUgPwoJCQkJLy8gZWxlbWVudCB3aXRoaW4gdGhlIGRvY3VtZW50CgkJCQllbGVtZW50Lm93bmVyRG9jdW1lbnQgOgoJCQkJLy8gZWxlbWVudCBpcyB3aW5kb3cgb3IgZG9jdW1lbnQKCQkJCWVsZW1lbnQuZG9jdW1lbnQgfHwgZWxlbWVudCApOwoJCQl0aGlzLndpbmRvdyA9ICQoIHRoaXMuZG9jdW1lbnRbMF0uZGVmYXVsdFZpZXcgfHwgdGhpcy5kb2N1bWVudFswXS5wYXJlbnRXaW5kb3cgKTsKCQl9CgoJCXRoaXMuX2NyZWF0ZSgpOwoJCXRoaXMuX3RyaWdnZXIoICJjcmVhdGUiLCBudWxsLCB0aGlzLl9nZXRDcmVhdGVFdmVudERhdGEoKSApOwoJCXRoaXMuX2luaXQoKTsKCX0sCglfZ2V0Q3JlYXRlT3B0aW9uczogJC5ub29wLAoJX2dldENyZWF0ZUV2ZW50RGF0YTogJC5ub29wLAoJX2NyZWF0ZTogJC5ub29wLAoJX2luaXQ6ICQubm9vcCwKCglkZXN0cm95OiBmdW5jdGlvbigpIHsKCQl0aGlzLl9kZXN0cm95KCk7CgkJLy8gd2UgY2FuIHByb2JhYmx5IHJlbW92ZSB0aGUgdW5iaW5kIGNhbGxzIGluIDIuMAoJCS8vIGFsbCBldmVudCBiaW5kaW5ncyBzaG91bGQgZ28gdGhyb3VnaCB0aGlzLl9vbigpCgkJdGhpcy5lbGVtZW50CgkJCS51bmJpbmQoIHRoaXMuZXZlbnROYW1lc3BhY2UgKQoJCQkucmVtb3ZlRGF0YSggdGhpcy53aWRnZXRGdWxsTmFtZSApCgkJCS8vIHN1cHBvcnQ6IGpxdWVyeSA8MS42LjMKCQkJLy8gaHR0cDovL2J1Z3MuanF1ZXJ5LmNvbS90aWNrZXQvOTQxMwoJCQkucmVtb3ZlRGF0YSggJC5jYW1lbENhc2UoIHRoaXMud2lkZ2V0RnVsbE5hbWUgKSApOwoJCXRoaXMud2lkZ2V0KCkKCQkJLnVuYmluZCggdGhpcy5ldmVudE5hbWVzcGFjZSApCgkJCS5yZW1vdmVBdHRyKCAiYXJpYS1kaXNhYmxlZCIgKQoJCQkucmVtb3ZlQ2xhc3MoCgkJCQl0aGlzLndpZGdldEZ1bGxOYW1lICsgIi1kaXNhYmxlZCAiICsKCQkJCSJ1aS1zdGF0ZS1kaXNhYmxlZCIgKTsKCgkJLy8gY2xlYW4gdXAgZXZlbnRzIGFuZCBzdGF0ZXMKCQl0aGlzLmJpbmRpbmdzLnVuYmluZCggdGhpcy5ldmVudE5hbWVzcGFjZSApOwoJCXRoaXMuaG92ZXJhYmxlLnJlbW92ZUNsYXNzKCAidWktc3RhdGUtaG92ZXIiICk7CgkJdGhpcy5mb2N1c2FibGUucmVtb3ZlQ2xhc3MoICJ1aS1zdGF0ZS1mb2N1cyIgKTsKCX0sCglfZGVzdHJveTogJC5ub29wLAoKCXdpZGdldDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuZWxlbWVudDsKCX0sCgoJb3B0aW9uOiBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQl2YXIgb3B0aW9ucyA9IGtleSwKCQkJcGFydHMsCgkJCWN1ck9wdGlvbiwKCQkJaTsKCgkJaWYgKCBhcmd1bWVudHMubGVuZ3RoID09PSAwICkgewoJCQkvLyBkb24ndCByZXR1cm4gYSByZWZlcmVuY2UgdG8gdGhlIGludGVybmFsIGhhc2gKCQkJcmV0dXJuICQud2lkZ2V0LmV4dGVuZCgge30sIHRoaXMub3B0aW9ucyApOwoJCX0KCgkJaWYgKCB0eXBlb2Yga2V5ID09PSAic3RyaW5nIiApIHsKCQkJLy8gaGFuZGxlIG5lc3RlZCBrZXlzLCBlLmcuLCAiZm9vLmJhciIgPT4geyBmb286IHsgYmFyOiBfX18gfSB9CgkJCW9wdGlvbnMgPSB7fTsKCQkJcGFydHMgPSBrZXkuc3BsaXQoICIuIiApOwoJCQlrZXkgPSBwYXJ0cy5zaGlmdCgpOwoJCQlpZiAoIHBhcnRzLmxlbmd0aCApIHsKCQkJCWN1ck9wdGlvbiA9IG9wdGlvbnNbIGtleSBdID0gJC53aWRnZXQuZXh0ZW5kKCB7fSwgdGhpcy5vcHRpb25zWyBrZXkgXSApOwoJCQkJZm9yICggaSA9IDA7IGkgPCBwYXJ0cy5sZW5ndGggLSAxOyBpKysgKSB7CgkJCQkJY3VyT3B0aW9uWyBwYXJ0c1sgaSBdIF0gPSBjdXJPcHRpb25bIHBhcnRzWyBpIF0gXSB8fCB7fTsKCQkJCQljdXJPcHRpb24gPSBjdXJPcHRpb25bIHBhcnRzWyBpIF0gXTsKCQkJCX0KCQkJCWtleSA9IHBhcnRzLnBvcCgpOwoJCQkJaWYgKCB2YWx1ZSA9PT0gdW5kZWZpbmVkICkgewoJCQkJCXJldHVybiBjdXJPcHRpb25bIGtleSBdID09PSB1bmRlZmluZWQgPyBudWxsIDogY3VyT3B0aW9uWyBrZXkgXTsKCQkJCX0KCQkJCWN1ck9wdGlvblsga2V5IF0gPSB2YWx1ZTsKCQkJfSBlbHNlIHsKCQkJCWlmICggdmFsdWUgPT09IHVuZGVmaW5lZCApIHsKCQkJCQlyZXR1cm4gdGhpcy5vcHRpb25zWyBrZXkgXSA9PT0gdW5kZWZpbmVkID8gbnVsbCA6IHRoaXMub3B0aW9uc1sga2V5IF07CgkJCQl9CgkJCQlvcHRpb25zWyBrZXkgXSA9IHZhbHVlOwoJCQl9CgkJfQoKCQl0aGlzLl9zZXRPcHRpb25zKCBvcHRpb25zICk7CgoJCXJldHVybiB0aGlzOwoJfSwKCV9zZXRPcHRpb25zOiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQl2YXIga2V5OwoKCQlmb3IgKCBrZXkgaW4gb3B0aW9ucyApIHsKCQkJdGhpcy5fc2V0T3B0aW9uKCBrZXksIG9wdGlvbnNbIGtleSBdICk7CgkJfQoKCQlyZXR1cm4gdGhpczsKCX0sCglfc2V0T3B0aW9uOiBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQl0aGlzLm9wdGlvbnNbIGtleSBdID0gdmFsdWU7CgoJCWlmICgga2V5ID09PSAiZGlzYWJsZWQiICkgewoJCQl0aGlzLndpZGdldCgpCgkJCQkudG9nZ2xlQ2xhc3MoIHRoaXMud2lkZ2V0RnVsbE5hbWUgKyAiLWRpc2FibGVkIiwgISF2YWx1ZSApOwoJCQl0aGlzLmhvdmVyYWJsZS5yZW1vdmVDbGFzcyggInVpLXN0YXRlLWhvdmVyIiApOwoJCQl0aGlzLmZvY3VzYWJsZS5yZW1vdmVDbGFzcyggInVpLXN0YXRlLWZvY3VzIiApOwoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWVuYWJsZTogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuX3NldE9wdGlvbnMoeyBkaXNhYmxlZDogZmFsc2UgfSk7Cgl9LAoJZGlzYWJsZTogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuX3NldE9wdGlvbnMoeyBkaXNhYmxlZDogdHJ1ZSB9KTsKCX0sCgoJX29uOiBmdW5jdGlvbiggc3VwcHJlc3NEaXNhYmxlZENoZWNrLCBlbGVtZW50LCBoYW5kbGVycyApIHsKCQl2YXIgZGVsZWdhdGVFbGVtZW50LAoJCQlpbnN0YW5jZSA9IHRoaXM7CgoJCS8vIG5vIHN1cHByZXNzRGlzYWJsZWRDaGVjayBmbGFnLCBzaHVmZmxlIGFyZ3VtZW50cwoJCWlmICggdHlwZW9mIHN1cHByZXNzRGlzYWJsZWRDaGVjayAhPT0gImJvb2xlYW4iICkgewoJCQloYW5kbGVycyA9IGVsZW1lbnQ7CgkJCWVsZW1lbnQgPSBzdXBwcmVzc0Rpc2FibGVkQ2hlY2s7CgkJCXN1cHByZXNzRGlzYWJsZWRDaGVjayA9IGZhbHNlOwoJCX0KCgkJLy8gbm8gZWxlbWVudCBhcmd1bWVudCwgc2h1ZmZsZSBhbmQgdXNlIHRoaXMuZWxlbWVudAoJCWlmICggIWhhbmRsZXJzICkgewoJCQloYW5kbGVycyA9IGVsZW1lbnQ7CgkJCWVsZW1lbnQgPSB0aGlzLmVsZW1lbnQ7CgkJCWRlbGVnYXRlRWxlbWVudCA9IHRoaXMud2lkZ2V0KCk7CgkJfSBlbHNlIHsKCQkJLy8gYWNjZXB0IHNlbGVjdG9ycywgRE9NIGVsZW1lbnRzCgkJCWVsZW1lbnQgPSBkZWxlZ2F0ZUVsZW1lbnQgPSAkKCBlbGVtZW50ICk7CgkJCXRoaXMuYmluZGluZ3MgPSB0aGlzLmJpbmRpbmdzLmFkZCggZWxlbWVudCApOwoJCX0KCgkJJC5lYWNoKCBoYW5kbGVycywgZnVuY3Rpb24oIGV2ZW50LCBoYW5kbGVyICkgewoJCQlmdW5jdGlvbiBoYW5kbGVyUHJveHkoKSB7CgkJCQkvLyBhbGxvdyB3aWRnZXRzIHRvIGN1c3RvbWl6ZSB0aGUgZGlzYWJsZWQgaGFuZGxpbmcKCQkJCS8vIC0gZGlzYWJsZWQgYXMgYW4gYXJyYXkgaW5zdGVhZCBvZiBib29sZWFuCgkJCQkvLyAtIGRpc2FibGVkIGNsYXNzIGFzIG1ldGhvZCBmb3IgZGlzYWJsaW5nIGluZGl2aWR1YWwgcGFydHMKCQkJCWlmICggIXN1cHByZXNzRGlzYWJsZWRDaGVjayAmJgoJCQkJCQkoIGluc3RhbmNlLm9wdGlvbnMuZGlzYWJsZWQgPT09IHRydWUgfHwKCQkJCQkJCSQoIHRoaXMgKS5oYXNDbGFzcyggInVpLXN0YXRlLWRpc2FibGVkIiApICkgKSB7CgkJCQkJcmV0dXJuOwoJCQkJfQoJCQkJcmV0dXJuICggdHlwZW9mIGhhbmRsZXIgPT09ICJzdHJpbmciID8gaW5zdGFuY2VbIGhhbmRsZXIgXSA6IGhhbmRsZXIgKQoJCQkJCS5hcHBseSggaW5zdGFuY2UsIGFyZ3VtZW50cyApOwoJCQl9CgoJCQkvLyBjb3B5IHRoZSBndWlkIHNvIGRpcmVjdCB1bmJpbmRpbmcgd29ya3MKCQkJaWYgKCB0eXBlb2YgaGFuZGxlciAhPT0gInN0cmluZyIgKSB7CgkJCQloYW5kbGVyUHJveHkuZ3VpZCA9IGhhbmRsZXIuZ3VpZCA9CgkJCQkJaGFuZGxlci5ndWlkIHx8IGhhbmRsZXJQcm94eS5ndWlkIHx8ICQuZ3VpZCsrOwoJCQl9CgoJCQl2YXIgbWF0Y2ggPSBldmVudC5tYXRjaCggL14oXHcrKVxzKiguKikkLyApLAoJCQkJZXZlbnROYW1lID0gbWF0Y2hbMV0gKyBpbnN0YW5jZS5ldmVudE5hbWVzcGFjZSwKCQkJCXNlbGVjdG9yID0gbWF0Y2hbMl07CgkJCWlmICggc2VsZWN0b3IgKSB7CgkJCQlkZWxlZ2F0ZUVsZW1lbnQuZGVsZWdhdGUoIHNlbGVjdG9yLCBldmVudE5hbWUsIGhhbmRsZXJQcm94eSApOwoJCQl9IGVsc2UgewoJCQkJZWxlbWVudC5iaW5kKCBldmVudE5hbWUsIGhhbmRsZXJQcm94eSApOwoJCQl9CgkJfSk7Cgl9LAoKCV9vZmY6IGZ1bmN0aW9uKCBlbGVtZW50LCBldmVudE5hbWUgKSB7CgkJZXZlbnROYW1lID0gKGV2ZW50TmFtZSB8fCAiIikuc3BsaXQoICIgIiApLmpvaW4oIHRoaXMuZXZlbnROYW1lc3BhY2UgKyAiICIgKSArIHRoaXMuZXZlbnROYW1lc3BhY2U7CgkJZWxlbWVudC51bmJpbmQoIGV2ZW50TmFtZSApLnVuZGVsZWdhdGUoIGV2ZW50TmFtZSApOwoJfSwKCglfZGVsYXk6IGZ1bmN0aW9uKCBoYW5kbGVyLCBkZWxheSApIHsKCQlmdW5jdGlvbiBoYW5kbGVyUHJveHkoKSB7CgkJCXJldHVybiAoIHR5cGVvZiBoYW5kbGVyID09PSAic3RyaW5nIiA/IGluc3RhbmNlWyBoYW5kbGVyIF0gOiBoYW5kbGVyICkKCQkJCS5hcHBseSggaW5zdGFuY2UsIGFyZ3VtZW50cyApOwoJCX0KCQl2YXIgaW5zdGFuY2UgPSB0aGlzOwoJCXJldHVybiBzZXRUaW1lb3V0KCBoYW5kbGVyUHJveHksIGRlbGF5IHx8IDAgKTsKCX0sCgoJX2hvdmVyYWJsZTogZnVuY3Rpb24oIGVsZW1lbnQgKSB7CgkJdGhpcy5ob3ZlcmFibGUgPSB0aGlzLmhvdmVyYWJsZS5hZGQoIGVsZW1lbnQgKTsKCQl0aGlzLl9vbiggZWxlbWVudCwgewoJCQltb3VzZWVudGVyOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkkKCBldmVudC5jdXJyZW50VGFyZ2V0ICkuYWRkQ2xhc3MoICJ1aS1zdGF0ZS1ob3ZlciIgKTsKCQkJfSwKCQkJbW91c2VsZWF2ZTogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJJCggZXZlbnQuY3VycmVudFRhcmdldCApLnJlbW92ZUNsYXNzKCAidWktc3RhdGUtaG92ZXIiICk7CgkJCX0KCQl9KTsKCX0sCgoJX2ZvY3VzYWJsZTogZnVuY3Rpb24oIGVsZW1lbnQgKSB7CgkJdGhpcy5mb2N1c2FibGUgPSB0aGlzLmZvY3VzYWJsZS5hZGQoIGVsZW1lbnQgKTsKCQl0aGlzLl9vbiggZWxlbWVudCwgewoJCQlmb2N1c2luOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkkKCBldmVudC5jdXJyZW50VGFyZ2V0ICkuYWRkQ2xhc3MoICJ1aS1zdGF0ZS1mb2N1cyIgKTsKCQkJfSwKCQkJZm9jdXNvdXQ6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCSQoIGV2ZW50LmN1cnJlbnRUYXJnZXQgKS5yZW1vdmVDbGFzcyggInVpLXN0YXRlLWZvY3VzIiApOwoJCQl9CgkJfSk7Cgl9LAoKCV90cmlnZ2VyOiBmdW5jdGlvbiggdHlwZSwgZXZlbnQsIGRhdGEgKSB7CgkJdmFyIHByb3AsIG9yaWcsCgkJCWNhbGxiYWNrID0gdGhpcy5vcHRpb25zWyB0eXBlIF07CgoJCWRhdGEgPSBkYXRhIHx8IHt9OwoJCWV2ZW50ID0gJC5FdmVudCggZXZlbnQgKTsKCQlldmVudC50eXBlID0gKCB0eXBlID09PSB0aGlzLndpZGdldEV2ZW50UHJlZml4ID8KCQkJdHlwZSA6CgkJCXRoaXMud2lkZ2V0RXZlbnRQcmVmaXggKyB0eXBlICkudG9Mb3dlckNhc2UoKTsKCQkvLyB0aGUgb3JpZ2luYWwgZXZlbnQgbWF5IGNvbWUgZnJvbSBhbnkgZWxlbWVudAoJCS8vIHNvIHdlIG5lZWQgdG8gcmVzZXQgdGhlIHRhcmdldCBvbiB0aGUgbmV3IGV2ZW50CgkJZXZlbnQudGFyZ2V0ID0gdGhpcy5lbGVtZW50WyAwIF07CgoJCS8vIGNvcHkgb3JpZ2luYWwgZXZlbnQgcHJvcGVydGllcyBvdmVyIHRvIHRoZSBuZXcgZXZlbnQKCQlvcmlnID0gZXZlbnQub3JpZ2luYWxFdmVudDsKCQlpZiAoIG9yaWcgKSB7CgkJCWZvciAoIHByb3AgaW4gb3JpZyApIHsKCQkJCWlmICggISggcHJvcCBpbiBldmVudCApICkgewoJCQkJCWV2ZW50WyBwcm9wIF0gPSBvcmlnWyBwcm9wIF07CgkJCQl9CgkJCX0KCQl9CgoJCXRoaXMuZWxlbWVudC50cmlnZ2VyKCBldmVudCwgZGF0YSApOwoJCXJldHVybiAhKCAkLmlzRnVuY3Rpb24oIGNhbGxiYWNrICkgJiYKCQkJY2FsbGJhY2suYXBwbHkoIHRoaXMuZWxlbWVudFswXSwgWyBldmVudCBdLmNvbmNhdCggZGF0YSApICkgPT09IGZhbHNlIHx8CgkJCWV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICk7Cgl9Cn07CgokLmVhY2goIHsgc2hvdzogImZhZGVJbiIsIGhpZGU6ICJmYWRlT3V0IiB9LCBmdW5jdGlvbiggbWV0aG9kLCBkZWZhdWx0RWZmZWN0ICkgewoJJC5XaWRnZXQucHJvdG90eXBlWyAiXyIgKyBtZXRob2QgXSA9IGZ1bmN0aW9uKCBlbGVtZW50LCBvcHRpb25zLCBjYWxsYmFjayApIHsKCQlpZiAoIHR5cGVvZiBvcHRpb25zID09PSAic3RyaW5nIiApIHsKCQkJb3B0aW9ucyA9IHsgZWZmZWN0OiBvcHRpb25zIH07CgkJfQoJCXZhciBoYXNPcHRpb25zLAoJCQllZmZlY3ROYW1lID0gIW9wdGlvbnMgPwoJCQkJbWV0aG9kIDoKCQkJCW9wdGlvbnMgPT09IHRydWUgfHwgdHlwZW9mIG9wdGlvbnMgPT09ICJudW1iZXIiID8KCQkJCQlkZWZhdWx0RWZmZWN0IDoKCQkJCQlvcHRpb25zLmVmZmVjdCB8fCBkZWZhdWx0RWZmZWN0OwoJCW9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoJCWlmICggdHlwZW9mIG9wdGlvbnMgPT09ICJudW1iZXIiICkgewoJCQlvcHRpb25zID0geyBkdXJhdGlvbjogb3B0aW9ucyB9OwoJCX0KCQloYXNPcHRpb25zID0gISQuaXNFbXB0eU9iamVjdCggb3B0aW9ucyApOwoJCW9wdGlvbnMuY29tcGxldGUgPSBjYWxsYmFjazsKCQlpZiAoIG9wdGlvbnMuZGVsYXkgKSB7CgkJCWVsZW1lbnQuZGVsYXkoIG9wdGlvbnMuZGVsYXkgKTsKCQl9CgkJaWYgKCBoYXNPcHRpb25zICYmICQuZWZmZWN0cyAmJiAkLmVmZmVjdHMuZWZmZWN0WyBlZmZlY3ROYW1lIF0gKSB7CgkJCWVsZW1lbnRbIG1ldGhvZCBdKCBvcHRpb25zICk7CgkJfSBlbHNlIGlmICggZWZmZWN0TmFtZSAhPT0gbWV0aG9kICYmIGVsZW1lbnRbIGVmZmVjdE5hbWUgXSApIHsKCQkJZWxlbWVudFsgZWZmZWN0TmFtZSBdKCBvcHRpb25zLmR1cmF0aW9uLCBvcHRpb25zLmVhc2luZywgY2FsbGJhY2sgKTsKCQl9IGVsc2UgewoJCQllbGVtZW50LnF1ZXVlKGZ1bmN0aW9uKCBuZXh0ICkgewoJCQkJJCggdGhpcyApWyBtZXRob2QgXSgpOwoJCQkJaWYgKCBjYWxsYmFjayApIHsKCQkJCQljYWxsYmFjay5jYWxsKCBlbGVtZW50WyAwIF0gKTsKCQkJCX0KCQkJCW5leHQoKTsKCQkJfSk7CgkJfQoJfTsKfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCnZhciByY2FwaXRhbHMgPSAvW0EtWl0vZywKCXJlcGxhY2VGdW5jdGlvbiA9IGZ1bmN0aW9uKCBjICkgewoJCXJldHVybiAiLSIgKyBjLnRvTG93ZXJDYXNlKCk7Cgl9OwoKJC5leHRlbmQoICQuV2lkZ2V0LnByb3RvdHlwZSwgewoJX2dldENyZWF0ZU9wdGlvbnM6IGZ1bmN0aW9uKCkgewoJCXZhciBvcHRpb24sIHZhbHVlLAoJCQllbGVtID0gdGhpcy5lbGVtZW50WyAwIF0sCgkJCW9wdGlvbnMgPSB7fTsKCgkJLy8KCQlpZiggISQubW9iaWxlLmdldEF0dHJpYnV0ZSggZWxlbSwgImRlZmF1bHRzIiApICl7CgkJCWZvciAoIG9wdGlvbiBpbiB0aGlzLm9wdGlvbnMgKSB7CgkJCQl2YWx1ZSA9ICQubW9iaWxlLmdldEF0dHJpYnV0ZSggZWxlbSwgb3B0aW9uLnJlcGxhY2UoIHJjYXBpdGFscywgcmVwbGFjZUZ1bmN0aW9uICkgKTsKCQkJCWlmICggdmFsdWUgIT0gbnVsbCApIHsKCQkJCQlvcHRpb25zWyBvcHRpb24gXSA9IHZhbHVlOwoJCQkJfQoJCQl9CgkJfQoKCQlyZXR1cm4gb3B0aW9uczsKCX0KfSk7CgovL1RPRE86IFJlbW92ZSBpbiAxLjUgZm9yIGJhY2tjb21wYXQgb25seQokLm1vYmlsZS53aWRnZXQgPSAkLldpZGdldDsKCn0pKCBqUXVlcnkgKTsKCgooZnVuY3Rpb24oICQgKSB7CgkvLyBUT0RPIG1vdmUgbG9hZGVyIGNsYXNzIGRvd24gaW50byB0aGUgd2lkZ2V0IHNldHRpbmdzCgl2YXIgbG9hZGVyQ2xhc3MgPSAidWktbG9hZGVyIiwgJGh0bWwgPSAkKCAiaHRtbCIgKTsKCgkkLndpZGdldCggIm1vYmlsZS5sb2FkZXIiLCB7CgkJLy8gTk9URSBpZiB0aGUgZ2xvYmFsIGNvbmZpZyBzZXR0aW5ncyBhcmUgZGVmaW5lZCB0aGV5IHdpbGwgb3ZlcnJpZGUgdGhlc2UKCQkvLyAgICAgIG9wdGlvbnMKCQlvcHRpb25zOiB7CgkJCS8vIHRoZSB0aGVtZSBmb3IgdGhlIGxvYWRpbmcgbWVzc2FnZQoJCQl0aGVtZTogImEiLAoKCQkJLy8gd2hldGhlciB0aGUgdGV4dCBpbiB0aGUgbG9hZGluZyBtZXNzYWdlIGlzIHNob3duCgkJCXRleHRWaXNpYmxlOiBmYWxzZSwKCgkJCS8vIGN1c3RvbSBodG1sIGZvciB0aGUgaW5uZXIgY29udGVudCBvZiB0aGUgbG9hZGluZyBtZXNzYWdlCgkJCWh0bWw6ICIiLAoKCQkJLy8gdGhlIHRleHQgdG8gYmUgZGlzcGxheWVkIHdoZW4gdGhlIHBvcHVwIGlzIHNob3duCgkJCXRleHQ6ICJsb2FkaW5nIgoJCX0sCgoJCWRlZmF1bHRIdG1sOiAiPGRpdiBjbGFzcz0nIiArIGxvYWRlckNsYXNzICsgIic+IiArCgkJCSI8c3BhbiBjbGFzcz0ndWktaWNvbi1sb2FkaW5nJz48L3NwYW4+IiArCgkJCSI8aDE+PC9oMT4iICsKCQkJIjwvZGl2PiIsCgoJCS8vIEZvciBub24tZml4ZWQgc3VwcG9ydGluIGJyb3dzZXJzLiBQb3NpdGlvbiBhdCB5IGNlbnRlciAoaWYgc2Nyb2xsVG9wIHN1cHBvcnRlZCksIGFib3ZlIHRoZSBhY3RpdmVCdG4gKGlmIGRlZmluZWQpLCBvciBqdXN0IDEwMHB4IGZyb20gdG9wCgkJZmFrZUZpeExvYWRlcjogZnVuY3Rpb24oKSB7CgkJCXZhciBhY3RpdmVCdG4gPSAkKCAiLiIgKyAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApLmZpcnN0KCk7CgoJCQl0aGlzLmVsZW1lbnQKCQkJCS5jc3MoewoJCQkJCXRvcDogJC5zdXBwb3J0LnNjcm9sbFRvcCAmJiB0aGlzLndpbmRvdy5zY3JvbGxUb3AoKSArIHRoaXMud2luZG93LmhlaWdodCgpIC8gMiB8fAoJCQkJCQlhY3RpdmVCdG4ubGVuZ3RoICYmIGFjdGl2ZUJ0bi5vZmZzZXQoKS50b3AgfHwgMTAwCgkJCQl9KTsKCQl9LAoKCQkvLyBjaGVjayBwb3NpdGlvbiBvZiBsb2FkZXIgdG8gc2VlIGlmIGl0IGFwcGVhcnMgdG8gYmUgImZpeGVkIiB0byBjZW50ZXIKCQkvLyBpZiBub3QsIHVzZSBhYnMgcG9zaXRpb25pbmcKCQljaGVja0xvYWRlclBvc2l0aW9uOiBmdW5jdGlvbigpIHsKCQkJdmFyIG9mZnNldCA9IHRoaXMuZWxlbWVudC5vZmZzZXQoKSwKCQkJCXNjcm9sbFRvcCA9IHRoaXMud2luZG93LnNjcm9sbFRvcCgpLAoJCQkJc2NyZWVuSGVpZ2h0ID0gJC5tb2JpbGUuZ2V0U2NyZWVuSGVpZ2h0KCk7CgoJCQlpZiAoIG9mZnNldC50b3AgPCBzY3JvbGxUb3AgfHwgKCBvZmZzZXQudG9wIC0gc2Nyb2xsVG9wICkgPiBzY3JlZW5IZWlnaHQgKSB7CgkJCQl0aGlzLmVsZW1lbnQuYWRkQ2xhc3MoICJ1aS1sb2FkZXItZmFrZWZpeCIgKTsKCQkJCXRoaXMuZmFrZUZpeExvYWRlcigpOwoJCQkJdGhpcy53aW5kb3cKCQkJCQkudW5iaW5kKCAic2Nyb2xsIiwgdGhpcy5jaGVja0xvYWRlclBvc2l0aW9uICkKCQkJCQkuYmluZCggInNjcm9sbCIsICQucHJveHkoIHRoaXMuZmFrZUZpeExvYWRlciwgdGhpcyApICk7CgkJCX0KCQl9LAoKCQlyZXNldEh0bWw6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLmVsZW1lbnQuaHRtbCggJCggdGhpcy5kZWZhdWx0SHRtbCApLmh0bWwoKSApOwoJCX0sCgoJCS8vIFR1cm4gb24vb2ZmIHBhZ2UgbG9hZGluZyBtZXNzYWdlLiBUaGVtZSBkb3VibGVzIGFzIGFuIG9iamVjdCBhcmd1bWVudAoJCS8vIHdpdGggdGhlIGZvbGxvd2luZyBzaGFwZTogeyB0aGVtZTogJycsIHRleHQ6ICcnLCBodG1sOiAnJywgdGV4dFZpc2libGU6ICcnIH0KCQkvLyBOT1RFIHRoYXQgdGhlICQubW9iaWxlLmxvYWRpbmcqIHNldHRpbmdzIGFuZCBwYXJhbXMgcGFzdCB0aGUgZmlyc3QgYXJlIGRlcHJlY2F0ZWQKCQkvLyBUT0RPIHN3ZWV0IGplc3VzIHdlIG5lZWQgdG8gYnJlYWsgc29tZSBvZiB0aGlzIG91dAoJCXNob3c6IGZ1bmN0aW9uKCB0aGVtZSwgbXNnVGV4dCwgdGV4dG9ubHkgKSB7CgkJCXZhciB0ZXh0VmlzaWJsZSwgbWVzc2FnZSwgbG9hZFNldHRpbmdzOwoKCQkJdGhpcy5yZXNldEh0bWwoKTsKCgkJCS8vIHVzZSB0aGUgcHJvdG90eXBlIG9wdGlvbnMgc28gdGhhdCBwZW9wbGUgY2FuIHNldCB0aGVtIGdsb2JhbGx5IGF0CgkJCS8vIG1vYmlsZSBpbml0LiBDb25zaXN0ZW5jeSwgaXQncyB3aGF0J3MgZm9yIGRpbm5lcgoJCQlpZiAoICQudHlwZSggdGhlbWUgKSA9PT0gIm9iamVjdCIgKSB7CgkJCQlsb2FkU2V0dGluZ3MgPSAkLmV4dGVuZCgge30sIHRoaXMub3B0aW9ucywgdGhlbWUgKTsKCgkJCQl0aGVtZSA9IGxvYWRTZXR0aW5ncy50aGVtZTsKCQkJfSBlbHNlIHsKCQkJCWxvYWRTZXR0aW5ncyA9IHRoaXMub3B0aW9uczsKCgkJCQkvLyBoZXJlIHdlIHByZWZlciB0aGUgdGhlbWUgdmFsdWUgcGFzc2VkIGFzIGEgc3RyaW5nIGFyZ3VtZW50LCB0aGVuCgkJCQkvLyB3ZSBwcmVmZXIgdGhlIGdsb2JhbCBvcHRpb24gYmVjYXVzZSB3ZSBjYW4ndCB1c2UgdW5kZWZpbmVkIGRlZmF1bHQKCQkJCS8vIHByb3RvdHlwZSBvcHRpb25zLCB0aGVuIHRoZSBwcm90b3R5cGUgb3B0aW9uCgkJCQl0aGVtZSA9IHRoZW1lIHx8IGxvYWRTZXR0aW5ncy50aGVtZTsKCQkJfQoKCQkJLy8gc2V0IHRoZSBtZXNzYWdlIHRleHQsIHByZWZlciB0aGUgcGFyYW0sIHRoZW4gdGhlIHNldHRpbmdzIG9iamVjdAoJCQkvLyB0aGVuIGxvYWRpbmcgbWVzc2FnZQoJCQltZXNzYWdlID0gbXNnVGV4dCB8fCAoIGxvYWRTZXR0aW5ncy50ZXh0ID09PSBmYWxzZSA/ICIiIDogbG9hZFNldHRpbmdzLnRleHQgKTsKCgkJCS8vIHByZXBhcmUgdGhlIGRvbQoJCQkkaHRtbC5hZGRDbGFzcyggInVpLWxvYWRpbmciICk7CgoJCQl0ZXh0VmlzaWJsZSA9IGxvYWRTZXR0aW5ncy50ZXh0VmlzaWJsZTsKCgkJCS8vIGFkZCB0aGUgcHJvcGVyIGNzcyBnaXZlbiB0aGUgb3B0aW9ucyAodGhlbWUsIHRleHQsIGV0YykKCQkJLy8gRm9yY2UgdGV4dCB2aXNpYmlsaXR5IGlmIHRoZSBzZWNvbmQgYXJndW1lbnQgd2FzIHN1cHBsaWVkLCBvcgoJCQkvLyBpZiB0aGUgdGV4dCB3YXMgZXhwbGljaXRseSBzZXQgaW4gdGhlIG9iamVjdCBhcmdzCgkJCXRoaXMuZWxlbWVudC5hdHRyKCJjbGFzcyIsIGxvYWRlckNsYXNzICsKCQkJCSIgdWktY29ybmVyLWFsbCB1aS1ib2R5LSIgKyB0aGVtZSArCgkJCQkiIHVpLWxvYWRlci0iICsgKCB0ZXh0VmlzaWJsZSB8fCBtc2dUZXh0IHx8IHRoZW1lLnRleHQgPyAidmVyYm9zZSIgOiAiZGVmYXVsdCIgKSArCgkJCQkoIGxvYWRTZXR0aW5ncy50ZXh0b25seSB8fCB0ZXh0b25seSA/ICIgdWktbG9hZGVyLXRleHRvbmx5IiA6ICIiICkgKTsKCgkJCS8vIFRPRE8gdmVyaWZ5IHRoYXQganF1ZXJ5LmZuLmh0bWwgaXMgb2sgdG8gdXNlIGluIGJvdGggY2FzZXMgaGVyZQoJCQkvLyAgICAgIHRoaXMgbWlnaHQgYmUgb3Zlcmx5IGRlZmVuc2l2ZSBpbiBwcmV2ZW50aW5nIHVua25vd2luZyB4c3MKCQkJLy8gaWYgdGhlIGh0bWwgYXR0cmlidXRlIGlzIGRlZmluZWQgb24gdGhlIGxvYWRpbmcgc2V0dGluZ3MsIHVzZSB0aGF0CgkJCS8vIG90aGVyd2lzZSB1c2UgdGhlIGZhbGxiYWNrcyBmcm9tIGFib3ZlCgkJCWlmICggbG9hZFNldHRpbmdzLmh0bWwgKSB7CgkJCQl0aGlzLmVsZW1lbnQuaHRtbCggbG9hZFNldHRpbmdzLmh0bWwgKTsKCQkJfSBlbHNlIHsKCQkJCXRoaXMuZWxlbWVudC5maW5kKCAiaDEiICkudGV4dCggbWVzc2FnZSApOwoJCQl9CgoJCQkvLyBhdHRhY2ggdGhlIGxvYWRlciB0byB0aGUgRE9NCgkJCXRoaXMuZWxlbWVudC5hcHBlbmRUbyggJC5tb2JpbGUucGFnZUNvbnRhaW5lciApOwoKCQkJLy8gY2hlY2sgdGhhdCB0aGUgbG9hZGVyIGlzIHZpc2libGUKCQkJdGhpcy5jaGVja0xvYWRlclBvc2l0aW9uKCk7CgoJCQkvLyBvbiBzY3JvbGwgY2hlY2sgdGhlIGxvYWRlciBwb3NpdGlvbgoJCQl0aGlzLndpbmRvdy5iaW5kKCAic2Nyb2xsIiwgJC5wcm94eSggdGhpcy5jaGVja0xvYWRlclBvc2l0aW9uLCB0aGlzICkgKTsKCQl9LAoKCQloaWRlOiBmdW5jdGlvbigpIHsKCQkJJGh0bWwucmVtb3ZlQ2xhc3MoICJ1aS1sb2FkaW5nIiApOwoKCQkJaWYgKCB0aGlzLm9wdGlvbnMudGV4dCApIHsKCQkJCXRoaXMuZWxlbWVudC5yZW1vdmVDbGFzcyggInVpLWxvYWRlci1mYWtlZml4IiApOwoJCQl9CgoJCQkkLm1vYmlsZS53aW5kb3cudW5iaW5kKCAic2Nyb2xsIiwgdGhpcy5mYWtlRml4TG9hZGVyICk7CgkJCSQubW9iaWxlLndpbmRvdy51bmJpbmQoICJzY3JvbGwiLCB0aGlzLmNoZWNrTG9hZGVyUG9zaXRpb24gKTsKCQl9Cgl9KTsKCn0pKGpRdWVyeSwgdGhpcyk7CgoKLy8gU2NyaXB0OiBqUXVlcnkgaGFzaGNoYW5nZSBldmVudAovLyAKLy8gKlZlcnNpb246IDEuMywgTGFzdCB1cGRhdGVkOiA3LzIxLzIwMTAqCi8vIAovLyBQcm9qZWN0IEhvbWUgLSBodHRwOi8vYmVuYWxtYW4uY29tL3Byb2plY3RzL2pxdWVyeS1oYXNoY2hhbmdlLXBsdWdpbi8KLy8gR2l0SHViICAgICAgIC0gaHR0cDovL2dpdGh1Yi5jb20vY293Ym95L2pxdWVyeS1oYXNoY2hhbmdlLwovLyBTb3VyY2UgICAgICAgLSBodHRwOi8vZ2l0aHViLmNvbS9jb3dib3kvanF1ZXJ5LWhhc2hjaGFuZ2UvcmF3L21hc3Rlci9qcXVlcnkuYmEtaGFzaGNoYW5nZS5qcwovLyAoTWluaWZpZWQpICAgLSBodHRwOi8vZ2l0aHViLmNvbS9jb3dib3kvanF1ZXJ5LWhhc2hjaGFuZ2UvcmF3L21hc3Rlci9qcXVlcnkuYmEtaGFzaGNoYW5nZS5taW4uanMgKDAuOGtiIGd6aXBwZWQpCi8vIAovLyBBYm91dDogTGljZW5zZQovLyAKLy8gQ29weXJpZ2h0IChjKSAyMDEwICJDb3dib3kiIEJlbiBBbG1hbiwKLy8gRHVhbCBsaWNlbnNlZCB1bmRlciB0aGUgTUlUIGFuZCBHUEwgbGljZW5zZXMuCi8vIGh0dHA6Ly9iZW5hbG1hbi5jb20vYWJvdXQvbGljZW5zZS8KLy8gCi8vIEFib3V0OiBFeGFtcGxlcwovLyAKLy8gVGhlc2Ugd29ya2luZyBleGFtcGxlcywgY29tcGxldGUgd2l0aCBmdWxseSBjb21tZW50ZWQgY29kZSwgaWxsdXN0cmF0ZSBhIGZldwovLyB3YXlzIGluIHdoaWNoIHRoaXMgcGx1Z2luIGNhbiBiZSB1c2VkLgovLyAKLy8gaGFzaGNoYW5nZSBldmVudCAtIGh0dHA6Ly9iZW5hbG1hbi5jb20vY29kZS9wcm9qZWN0cy9qcXVlcnktaGFzaGNoYW5nZS9leGFtcGxlcy9oYXNoY2hhbmdlLwovLyBkb2N1bWVudC5kb21haW4gLSBodHRwOi8vYmVuYWxtYW4uY29tL2NvZGUvcHJvamVjdHMvanF1ZXJ5LWhhc2hjaGFuZ2UvZXhhbXBsZXMvZG9jdW1lbnRfZG9tYWluLwovLyAKLy8gQWJvdXQ6IFN1cHBvcnQgYW5kIFRlc3RpbmcKLy8gCi8vIEluZm9ybWF0aW9uIGFib3V0IHdoYXQgdmVyc2lvbiBvciB2ZXJzaW9ucyBvZiBqUXVlcnkgdGhpcyBwbHVnaW4gaGFzIGJlZW4KLy8gdGVzdGVkIHdpdGgsIHdoYXQgYnJvd3NlcnMgaXQgaGFzIGJlZW4gdGVzdGVkIGluLCBhbmQgd2hlcmUgdGhlIHVuaXQgdGVzdHMKLy8gcmVzaWRlIChzbyB5b3UgY2FuIHRlc3QgaXQgeW91cnNlbGYpLgovLyAKLy8galF1ZXJ5IFZlcnNpb25zIC0gMS4yLjYsIDEuMy4yLCAxLjQuMSwgMS40LjIKLy8gQnJvd3NlcnMgVGVzdGVkIC0gSW50ZXJuZXQgRXhwbG9yZXIgNi04LCBGaXJlZm94IDItNCwgQ2hyb21lIDUtNiwgU2FmYXJpIDMuMi01LAovLyAgICAgICAgICAgICAgICAgICBPcGVyYSA5LjYtMTAuNjAsIGlQaG9uZSAzLjEsIEFuZHJvaWQgMS42LTIuMiwgQmxhY2tCZXJyeSA0LjYtNS4KLy8gVW5pdCBUZXN0cyAgICAgIC0gaHR0cDovL2JlbmFsbWFuLmNvbS9jb2RlL3Byb2plY3RzL2pxdWVyeS1oYXNoY2hhbmdlL3VuaXQvCi8vIAovLyBBYm91dDogS25vd24gaXNzdWVzCi8vIAovLyBXaGlsZSB0aGlzIGpRdWVyeSBoYXNoY2hhbmdlIGV2ZW50IGltcGxlbWVudGF0aW9uIGlzIHF1aXRlIHN0YWJsZSBhbmQKLy8gcm9idXN0LCB0aGVyZSBhcmUgYSBmZXcgdW5mb3J0dW5hdGUgYnJvd3NlciBidWdzIHN1cnJvdW5kaW5nIGV4cGVjdGVkCi8vIGhhc2hjaGFuZ2UgZXZlbnQtYmFzZWQgYmVoYXZpb3JzLCBpbmRlcGVuZGVudCBvZiBhbnkgSmF2YVNjcmlwdAovLyB3aW5kb3cub25oYXNoY2hhbmdlIGFic3RyYWN0aW9uLiBTZWUgdGhlIGZvbGxvd2luZyBleGFtcGxlcyBmb3IgbW9yZQovLyBpbmZvcm1hdGlvbjoKLy8gCi8vIENocm9tZTogQmFjayBCdXR0b24gLSBodHRwOi8vYmVuYWxtYW4uY29tL2NvZGUvcHJvamVjdHMvanF1ZXJ5LWhhc2hjaGFuZ2UvZXhhbXBsZXMvYnVnLWNocm9tZS1iYWNrLWJ1dHRvbi8KLy8gRmlyZWZveDogUmVtb3RlIFhNTEh0dHBSZXF1ZXN0IC0gaHR0cDovL2JlbmFsbWFuLmNvbS9jb2RlL3Byb2plY3RzL2pxdWVyeS1oYXNoY2hhbmdlL2V4YW1wbGVzL2J1Zy1maXJlZm94LXJlbW90ZS14aHIvCi8vIFdlYktpdDogQmFjayBCdXR0b24gaW4gYW4gSWZyYW1lIC0gaHR0cDovL2JlbmFsbWFuLmNvbS9jb2RlL3Byb2plY3RzL2pxdWVyeS1oYXNoY2hhbmdlL2V4YW1wbGVzL2J1Zy13ZWJraXQtaGFzaC1pZnJhbWUvCi8vIFNhZmFyaTogQmFjayBCdXR0b24gZnJvbSBhIGRpZmZlcmVudCBkb21haW4gLSBodHRwOi8vYmVuYWxtYW4uY29tL2NvZGUvcHJvamVjdHMvanF1ZXJ5LWhhc2hjaGFuZ2UvZXhhbXBsZXMvYnVnLXNhZmFyaS1iYWNrLWZyb20tZGlmZi1kb21haW4vCi8vIAovLyBBbHNvIG5vdGUgdGhhdCBzaG91bGQgYSBicm93c2VyIG5hdGl2ZWx5IHN1cHBvcnQgdGhlIHdpbmRvdy5vbmhhc2hjaGFuZ2UgCi8vIGV2ZW50LCBidXQgbm90IHJlcG9ydCB0aGF0IGl0IGRvZXMsIHRoZSBmYWxsYmFjayBwb2xsaW5nIGxvb3Agd2lsbCBiZSB1c2VkLgovLyAKLy8gQWJvdXQ6IFJlbGVhc2UgSGlzdG9yeQovLyAKLy8gMS4zICAgLSAoNy8yMS8yMDEwKSBSZW9yZ2FuaXplZCBJRTYvNyBJZnJhbWUgY29kZSB0byBtYWtlIGl0IG1vcmUKLy8gICAgICAgICAicmVtb3ZhYmxlIiBmb3IgbW9iaWxlLW9ubHkgZGV2ZWxvcG1lbnQuIEFkZGVkIElFNi83IGRvY3VtZW50LnRpdGxlCi8vICAgICAgICAgc3VwcG9ydC4gQXR0ZW1wdGVkIHRvIG1ha2UgSWZyYW1lIGFzIGhpZGRlbiBhcyBwb3NzaWJsZSBieSB1c2luZwovLyAgICAgICAgIHRlY2huaXF1ZXMgZnJvbSBodHRwOi8vd3d3LnBhY2llbGxvZ3JvdXAuY29tL2Jsb2cvP3A9NjA0LiBBZGRlZCAKLy8gICAgICAgICBzdXBwb3J0IGZvciB0aGUgInNob3J0Y3V0IiBmb3JtYXQgJCh3aW5kb3cpLmhhc2hjaGFuZ2UoIGZuICkgYW5kCi8vICAgICAgICAgJCh3aW5kb3cpLmhhc2hjaGFuZ2UoKSBsaWtlIGpRdWVyeSBwcm92aWRlcyBmb3IgYnVpbHQtaW4gZXZlbnRzLgovLyAgICAgICAgIFJlbmFtZWQgalF1ZXJ5Lmhhc2hjaGFuZ2VEZWxheSB0byA8alF1ZXJ5LmZuLmhhc2hjaGFuZ2UuZGVsYXk+IGFuZAovLyAgICAgICAgIGxvd2VyZWQgaXRzIGRlZmF1bHQgdmFsdWUgdG8gNTAuIEFkZGVkIDxqUXVlcnkuZm4uaGFzaGNoYW5nZS5kb21haW4+Ci8vICAgICAgICAgYW5kIDxqUXVlcnkuZm4uaGFzaGNoYW5nZS5zcmM+IHByb3BlcnRpZXMgcGx1cyBkb2N1bWVudC1kb21haW4uaHRtbAovLyAgICAgICAgIGZpbGUgdG8gYWRkcmVzcyBhY2Nlc3MgZGVuaWVkIGlzc3VlcyB3aGVuIHNldHRpbmcgZG9jdW1lbnQuZG9tYWluIGluCi8vICAgICAgICAgSUU2LzcuCi8vIDEuMiAgIC0gKDIvMTEvMjAxMCkgRml4ZWQgYSBidWcgd2hlcmUgY29taW5nIGJhY2sgdG8gYSBwYWdlIHVzaW5nIHRoaXMgcGx1Z2luCi8vICAgICAgICAgZnJvbSBhIHBhZ2Ugb24gYW5vdGhlciBkb21haW4gd291bGQgY2F1c2UgYW4gZXJyb3IgaW4gU2FmYXJpIDQuIEFsc28sCi8vICAgICAgICAgSUU2LzcgSWZyYW1lIGlzIG5vdyBpbnNlcnRlZCBhZnRlciB0aGUgYm9keSAodGhpcyBhY3R1YWxseSB3b3JrcyksCi8vICAgICAgICAgd2hpY2ggcHJldmVudHMgdGhlIHBhZ2UgZnJvbSBzY3JvbGxpbmcgd2hlbiB0aGUgZXZlbnQgaXMgZmlyc3QgYm91bmQuCi8vICAgICAgICAgRXZlbnQgY2FuIGFsc28gbm93IGJlIGJvdW5kIGJlZm9yZSBET00gcmVhZHksIGJ1dCBpdCB3b24ndCBiZSB1c2FibGUKLy8gICAgICAgICBiZWZvcmUgdGhlbiBpbiBJRTYvNy4KLy8gMS4xICAgLSAoMS8yMS8yMDEwKSBJbmNvcnBvcmF0ZWQgZG9jdW1lbnQuZG9jdW1lbnRNb2RlIHRlc3QgdG8gZml4IElFOCBidWcKLy8gICAgICAgICB3aGVyZSBicm93c2VyIHZlcnNpb24gaXMgaW5jb3JyZWN0bHkgcmVwb3J0ZWQgYXMgOC4wLCBkZXNwaXRlCi8vICAgICAgICAgaW5jbHVzaW9uIG9mIHRoZSBYLVVBLUNvbXBhdGlibGUgSUU9RW11bGF0ZUlFNyBtZXRhIHRhZy4KLy8gMS4wICAgLSAoMS85LzIwMTApIEluaXRpYWwgUmVsZWFzZS4gQnJva2Ugb3V0IHRoZSBqUXVlcnkgQkJRIGV2ZW50LnNwZWNpYWwKLy8gICAgICAgICB3aW5kb3cub25oYXNoY2hhbmdlIGZ1bmN0aW9uYWxpdHkgaW50byBhIHNlcGFyYXRlIHBsdWdpbiBmb3IgdXNlcnMKLy8gICAgICAgICB3aG8gd2FudCBqdXN0IHRoZSBiYXNpYyBldmVudCAmIGJhY2sgYnV0dG9uIHN1cHBvcnQsIHdpdGhvdXQgYWxsIHRoZQovLyAgICAgICAgIGV4dHJhIGF3ZXNvbWVuZXNzIHRoYXQgQkJRIHByb3ZpZGVzLiBUaGlzIHBsdWdpbiB3aWxsIGJlIGluY2x1ZGVkIGFzCi8vICAgICAgICAgcGFydCBvZiBqUXVlcnkgQkJRLCBidXQgYWxzbyBiZSBhdmFpbGFibGUgc2VwYXJhdGVseS4KCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CiAgLy8gUmV1c2VkIHN0cmluZy4KICB2YXIgc3RyX2hhc2hjaGFuZ2UgPSAnaGFzaGNoYW5nZScsCiAgICAKICAgIC8vIE1ldGhvZCAvIG9iamVjdCByZWZlcmVuY2VzLgogICAgZG9jID0gZG9jdW1lbnQsCiAgICBmYWtlX29uaGFzaGNoYW5nZSwKICAgIHNwZWNpYWwgPSAkLmV2ZW50LnNwZWNpYWwsCiAgICAKICAgIC8vIERvZXMgdGhlIGJyb3dzZXIgc3VwcG9ydCB3aW5kb3cub25oYXNoY2hhbmdlPyBOb3RlIHRoYXQgSUU4IHJ1bm5pbmcgaW4KICAgIC8vIElFNyBjb21wYXRpYmlsaXR5IG1vZGUgcmVwb3J0cyB0cnVlIGZvciAnb25oYXNoY2hhbmdlJyBpbiB3aW5kb3csIGV2ZW4KICAgIC8vIHRob3VnaCB0aGUgZXZlbnQgaXNuJ3Qgc3VwcG9ydGVkLCBzbyBhbHNvIHRlc3QgZG9jdW1lbnQuZG9jdW1lbnRNb2RlLgogICAgZG9jX21vZGUgPSBkb2MuZG9jdW1lbnRNb2RlLAogICAgc3VwcG9ydHNfb25oYXNoY2hhbmdlID0gJ29uJyArIHN0cl9oYXNoY2hhbmdlIGluIHdpbmRvdyAmJiAoIGRvY19tb2RlID09PSB1bmRlZmluZWQgfHwgZG9jX21vZGUgPiA3ICk7CiAgCiAgLy8gR2V0IGxvY2F0aW9uLmhhc2ggKG9yIHdoYXQgeW91J2QgZXhwZWN0IGxvY2F0aW9uLmhhc2ggdG8gYmUpIHNhbnMgYW55CiAgLy8gbGVhZGluZyAjLiBUaGFua3MgZm9yIG1ha2luZyB0aGlzIG5lY2Vzc2FyeSwgRmlyZWZveCEKICBmdW5jdGlvbiBnZXRfZnJhZ21lbnQoIHVybCApIHsKICAgIHVybCA9IHVybCB8fCBsb2NhdGlvbi5ocmVmOwogICAgcmV0dXJuICcjJyArIHVybC5yZXBsYWNlKCAvXlteI10qIz8oLiopJC8sICckMScgKTsKICB9OwogIAogIC8vIE1ldGhvZDogalF1ZXJ5LmZuLmhhc2hjaGFuZ2UKICAvLyAKICAvLyBCaW5kIGEgaGFuZGxlciB0byB0aGUgd2luZG93Lm9uaGFzaGNoYW5nZSBldmVudCBvciB0cmlnZ2VyIGFsbCBib3VuZAogIC8vIHdpbmRvdy5vbmhhc2hjaGFuZ2UgZXZlbnQgaGFuZGxlcnMuIFRoaXMgYmVoYXZpb3IgaXMgY29uc2lzdGVudCB3aXRoCiAgLy8galF1ZXJ5J3MgYnVpbHQtaW4gZXZlbnQgaGFuZGxlcnMuCiAgLy8gCiAgLy8gVXNhZ2U6CiAgLy8gCiAgLy8gPiBqUXVlcnkod2luZG93KS5oYXNoY2hhbmdlKCBbIGhhbmRsZXIgXSApOwogIC8vIAogIC8vIEFyZ3VtZW50czoKICAvLyAKICAvLyAgaGFuZGxlciAtIChGdW5jdGlvbikgT3B0aW9uYWwgaGFuZGxlciB0byBiZSBib3VuZCB0byB0aGUgaGFzaGNoYW5nZQogIC8vICAgIGV2ZW50LiBUaGlzIGlzIGEgInNob3J0Y3V0IiBmb3IgdGhlIG1vcmUgdmVyYm9zZSBmb3JtOgogIC8vICAgIGpRdWVyeSh3aW5kb3cpLmJpbmQoICdoYXNoY2hhbmdlJywgaGFuZGxlciApLiBJZiBoYW5kbGVyIGlzIG9taXR0ZWQsCiAgLy8gICAgYWxsIGJvdW5kIHdpbmRvdy5vbmhhc2hjaGFuZ2UgZXZlbnQgaGFuZGxlcnMgd2lsbCBiZSB0cmlnZ2VyZWQuIFRoaXMKICAvLyAgICBpcyBhIHNob3J0Y3V0IGZvciB0aGUgbW9yZSB2ZXJib3NlCiAgLy8gICAgalF1ZXJ5KHdpbmRvdykudHJpZ2dlciggJ2hhc2hjaGFuZ2UnICkuIFRoZXNlIGZvcm1zIGFyZSBkZXNjcmliZWQgaW4KICAvLyAgICB0aGUgPGhhc2hjaGFuZ2UgZXZlbnQ+IHNlY3Rpb24uCiAgLy8gCiAgLy8gUmV0dXJuczoKICAvLyAKICAvLyAgKGpRdWVyeSkgVGhlIGluaXRpYWwgalF1ZXJ5IGNvbGxlY3Rpb24gb2YgZWxlbWVudHMuCiAgCiAgLy8gQWxsb3cgdGhlICJzaG9ydGN1dCIgZm9ybWF0ICQoZWxlbSkuaGFzaGNoYW5nZSggZm4gKSBmb3IgYmluZGluZyBhbmQKICAvLyAkKGVsZW0pLmhhc2hjaGFuZ2UoKSBmb3IgdHJpZ2dlcmluZywgbGlrZSBqUXVlcnkgZG9lcyBmb3IgYnVpbHQtaW4gZXZlbnRzLgogICQuZm5bIHN0cl9oYXNoY2hhbmdlIF0gPSBmdW5jdGlvbiggZm4gKSB7CiAgICByZXR1cm4gZm4gPyB0aGlzLmJpbmQoIHN0cl9oYXNoY2hhbmdlLCBmbiApIDogdGhpcy50cmlnZ2VyKCBzdHJfaGFzaGNoYW5nZSApOwogIH07CiAgCiAgLy8gUHJvcGVydHk6IGpRdWVyeS5mbi5oYXNoY2hhbmdlLmRlbGF5CiAgLy8gCiAgLy8gVGhlIG51bWVyaWMgaW50ZXJ2YWwgKGluIG1pbGxpc2Vjb25kcykgYXQgd2hpY2ggdGhlIDxoYXNoY2hhbmdlIGV2ZW50PgogIC8vIHBvbGxpbmcgbG9vcCBleGVjdXRlcy4gRGVmYXVsdHMgdG8gNTAuCiAgCiAgLy8gUHJvcGVydHk6IGpRdWVyeS5mbi5oYXNoY2hhbmdlLmRvbWFpbgogIC8vIAogIC8vIElmIHlvdSdyZSBzZXR0aW5nIGRvY3VtZW50LmRvbWFpbiBpbiB5b3VyIEphdmFTY3JpcHQsIGFuZCB5b3Ugd2FudCBoYXNoCiAgLy8gaGlzdG9yeSB0byB3b3JrIGluIElFNi83LCBub3Qgb25seSBtdXN0IHRoaXMgcHJvcGVydHkgYmUgc2V0LCBidXQgeW91IG11c3QKICAvLyBhbHNvIHNldCBkb2N1bWVudC5kb21haW4gQkVGT1JFIGpRdWVyeSBpcyBsb2FkZWQgaW50byB0aGUgcGFnZS4gVGhpcwogIC8vIHByb3BlcnR5IGlzIG9ubHkgYXBwbGljYWJsZSBpZiB5b3UgYXJlIHN1cHBvcnRpbmcgSUU2LzcgKG9yIElFOCBvcGVyYXRpbmcKICAvLyBpbiAiSUU3IGNvbXBhdGliaWxpdHkiIG1vZGUpLgogIC8vIAogIC8vIEluIGFkZGl0aW9uLCB0aGUgPGpRdWVyeS5mbi5oYXNoY2hhbmdlLnNyYz4gcHJvcGVydHkgbXVzdCBiZSBzZXQgdG8gdGhlCiAgLy8gcGF0aCBvZiB0aGUgaW5jbHVkZWQgImRvY3VtZW50LWRvbWFpbi5odG1sIiBmaWxlLCB3aGljaCBjYW4gYmUgcmVuYW1lZCBvcgogIC8vIG1vZGlmaWVkIGlmIG5lY2Vzc2FyeSAobm90ZSB0aGF0IHRoZSBkb2N1bWVudC5kb21haW4gc3BlY2lmaWVkIG11c3QgYmUgdGhlCiAgLy8gc2FtZSBpbiBib3RoIHlvdXIgbWFpbiBKYXZhU2NyaXB0IGFzIHdlbGwgYXMgaW4gdGhpcyBmaWxlKS4KICAvLyAKICAvLyBVc2FnZToKICAvLyAKICAvLyBqUXVlcnkuZm4uaGFzaGNoYW5nZS5kb21haW4gPSBkb2N1bWVudC5kb21haW47CiAgCiAgLy8gUHJvcGVydHk6IGpRdWVyeS5mbi5oYXNoY2hhbmdlLnNyYwogIC8vIAogIC8vIElmLCBmb3Igc29tZSByZWFzb24sIHlvdSBuZWVkIHRvIHNwZWNpZnkgYW4gSWZyYW1lIHNyYyBmaWxlIChmb3IgZXhhbXBsZSwKICAvLyB3aGVuIHNldHRpbmcgZG9jdW1lbnQuZG9tYWluIGFzIGluIDxqUXVlcnkuZm4uaGFzaGNoYW5nZS5kb21haW4+KSwgeW91IGNhbgogIC8vIGRvIHNvIHVzaW5nIHRoaXMgcHJvcGVydHkuIE5vdGUgdGhhdCB3aGVuIHVzaW5nIHRoaXMgcHJvcGVydHksIGhpc3RvcnkKICAvLyB3b24ndCBiZSByZWNvcmRlZCBpbiBJRTYvNyB1bnRpbCB0aGUgSWZyYW1lIHNyYyBmaWxlIGxvYWRzLiBUaGlzIHByb3BlcnR5CiAgLy8gaXMgb25seSBhcHBsaWNhYmxlIGlmIHlvdSBhcmUgc3VwcG9ydGluZyBJRTYvNyAob3IgSUU4IG9wZXJhdGluZyBpbiAiSUU3CiAgLy8gY29tcGF0aWJpbGl0eSIgbW9kZSkuCiAgLy8gCiAgLy8gVXNhZ2U6CiAgLy8gCiAgLy8galF1ZXJ5LmZuLmhhc2hjaGFuZ2Uuc3JjID0gJ3BhdGgvdG8vZmlsZS5odG1sJzsKICAKICAkLmZuWyBzdHJfaGFzaGNoYW5nZSBdLmRlbGF5ID0gNTA7CiAgLyoKICAkLmZuWyBzdHJfaGFzaGNoYW5nZSBdLmRvbWFpbiA9IG51bGw7CiAgJC5mblsgc3RyX2hhc2hjaGFuZ2UgXS5zcmMgPSBudWxsOwogICovCiAgCiAgLy8gRXZlbnQ6IGhhc2hjaGFuZ2UgZXZlbnQKICAvLyAKICAvLyBGaXJlZCB3aGVuIGxvY2F0aW9uLmhhc2ggY2hhbmdlcy4gSW4gYnJvd3NlcnMgdGhhdCBzdXBwb3J0IGl0LCB0aGUgbmF0aXZlCiAgLy8gSFRNTDUgd2luZG93Lm9uaGFzaGNoYW5nZSBldmVudCBpcyB1c2VkLCBvdGhlcndpc2UgYSBwb2xsaW5nIGxvb3AgaXMKICAvLyBpbml0aWFsaXplZCwgcnVubmluZyBldmVyeSA8alF1ZXJ5LmZuLmhhc2hjaGFuZ2UuZGVsYXk+IG1pbGxpc2Vjb25kcyB0bwogIC8vIHNlZSBpZiB0aGUgaGFzaCBoYXMgY2hhbmdlZC4gSW4gSUU2LzcgKGFuZCBJRTggb3BlcmF0aW5nIGluICJJRTcKICAvLyBjb21wYXRpYmlsaXR5IiBtb2RlKSwgYSBoaWRkZW4gSWZyYW1lIGlzIGNyZWF0ZWQgdG8gYWxsb3cgdGhlIGJhY2sgYnV0dG9uCiAgLy8gYW5kIGhhc2gtYmFzZWQgaGlzdG9yeSB0byB3b3JrLgogIC8vIAogIC8vIFVzYWdlIGFzIGRlc2NyaWJlZCBpbiA8alF1ZXJ5LmZuLmhhc2hjaGFuZ2U+OgogIC8vIAogIC8vID4gLy8gQmluZCBhbiBldmVudCBoYW5kbGVyLgogIC8vID4galF1ZXJ5KHdpbmRvdykuaGFzaGNoYW5nZSggZnVuY3Rpb24oZSkgewogIC8vID4gICB2YXIgaGFzaCA9IGxvY2F0aW9uLmhhc2g7CiAgLy8gPiAgIC4uLgogIC8vID4gfSk7CiAgLy8gPiAKICAvLyA+IC8vIE1hbnVhbGx5IHRyaWdnZXIgdGhlIGV2ZW50IGhhbmRsZXIuCiAgLy8gPiBqUXVlcnkod2luZG93KS5oYXNoY2hhbmdlKCk7CiAgLy8gCiAgLy8gQSBtb3JlIHZlcmJvc2UgdXNhZ2UgdGhhdCBhbGxvd3MgZm9yIGV2ZW50IG5hbWVzcGFjaW5nOgogIC8vIAogIC8vID4gLy8gQmluZCBhbiBldmVudCBoYW5kbGVyLgogIC8vID4galF1ZXJ5KHdpbmRvdykuYmluZCggJ2hhc2hjaGFuZ2UnLCBmdW5jdGlvbihlKSB7CiAgLy8gPiAgIHZhciBoYXNoID0gbG9jYXRpb24uaGFzaDsKICAvLyA+ICAgLi4uCiAgLy8gPiB9KTsKICAvLyA+IAogIC8vID4gLy8gTWFudWFsbHkgdHJpZ2dlciB0aGUgZXZlbnQgaGFuZGxlci4KICAvLyA+IGpRdWVyeSh3aW5kb3cpLnRyaWdnZXIoICdoYXNoY2hhbmdlJyApOwogIC8vIAogIC8vIEFkZGl0aW9uYWwgTm90ZXM6CiAgLy8gCiAgLy8gKiBUaGUgcG9sbGluZyBsb29wIGFuZCBJZnJhbWUgYXJlIG5vdCBjcmVhdGVkIHVudGlsIGF0IGxlYXN0IG9uZSBoYW5kbGVyCiAgLy8gICBpcyBhY3R1YWxseSBib3VuZCB0byB0aGUgJ2hhc2hjaGFuZ2UnIGV2ZW50LgogIC8vICogSWYgeW91IG5lZWQgdGhlIGJvdW5kIGhhbmRsZXIocykgdG8gZXhlY3V0ZSBpbW1lZGlhdGVseSwgaW4gY2FzZXMgd2hlcmUKICAvLyAgIGEgbG9jYXRpb24uaGFzaCBleGlzdHMgb24gcGFnZSBsb2FkLCB2aWEgYm9va21hcmsgb3IgcGFnZSByZWZyZXNoIGZvcgogIC8vICAgZXhhbXBsZSwgdXNlIGpRdWVyeSh3aW5kb3cpLmhhc2hjaGFuZ2UoKSBvciB0aGUgbW9yZSB2ZXJib3NlIAogIC8vICAgalF1ZXJ5KHdpbmRvdykudHJpZ2dlciggJ2hhc2hjaGFuZ2UnICkuCiAgLy8gKiBUaGUgZXZlbnQgY2FuIGJlIGJvdW5kIGJlZm9yZSBET00gcmVhZHksIGJ1dCBzaW5jZSBpdCB3b24ndCBiZSB1c2FibGUKICAvLyAgIGJlZm9yZSB0aGVuIGluIElFNi83IChkdWUgdG8gdGhlIG5lY2Vzc2FyeSBJZnJhbWUpLCByZWNvbW1lbmRlZCB1c2FnZSBpcwogIC8vICAgdG8gYmluZCBpdCBpbnNpZGUgYSBET00gcmVhZHkgaGFuZGxlci4KICAKICAvLyBPdmVycmlkZSBleGlzdGluZyAkLmV2ZW50LnNwZWNpYWwuaGFzaGNoYW5nZSBtZXRob2RzIChhbGxvd2luZyB0aGlzIHBsdWdpbgogIC8vIHRvIGJlIGRlZmluZWQgYWZ0ZXIgalF1ZXJ5IEJCUSBpbiBCQlEncyBzb3VyY2UgY29kZSkuCiAgc3BlY2lhbFsgc3RyX2hhc2hjaGFuZ2UgXSA9ICQuZXh0ZW5kKCBzcGVjaWFsWyBzdHJfaGFzaGNoYW5nZSBdLCB7CiAgICAKICAgIC8vIENhbGxlZCBvbmx5IHdoZW4gdGhlIGZpcnN0ICdoYXNoY2hhbmdlJyBldmVudCBpcyBib3VuZCB0byB3aW5kb3cuCiAgICBzZXR1cDogZnVuY3Rpb24oKSB7CiAgICAgIC8vIElmIHdpbmRvdy5vbmhhc2hjaGFuZ2UgaXMgc3VwcG9ydGVkIG5hdGl2ZWx5LCB0aGVyZSdzIG5vdGhpbmcgdG8gZG8uLgogICAgICBpZiAoIHN1cHBvcnRzX29uaGFzaGNoYW5nZSApIHsgcmV0dXJuIGZhbHNlOyB9CiAgICAgIAogICAgICAvLyBPdGhlcndpc2UsIHdlIG5lZWQgdG8gY3JlYXRlIG91ciBvd24uIEFuZCB3ZSBkb24ndCB3YW50IHRvIGNhbGwgdGhpcwogICAgICAvLyB1bnRpbCB0aGUgdXNlciBiaW5kcyB0byB0aGUgZXZlbnQsIGp1c3QgaW4gY2FzZSB0aGV5IG5ldmVyIGRvLCBzaW5jZSBpdAogICAgICAvLyB3aWxsIGNyZWF0ZSBhIHBvbGxpbmcgbG9vcCBhbmQgcG9zc2libHkgZXZlbiBhIGhpZGRlbiBJZnJhbWUuCiAgICAgICQoIGZha2Vfb25oYXNoY2hhbmdlLnN0YXJ0ICk7CiAgICB9LAogICAgCiAgICAvLyBDYWxsZWQgb25seSB3aGVuIHRoZSBsYXN0ICdoYXNoY2hhbmdlJyBldmVudCBpcyB1bmJvdW5kIGZyb20gd2luZG93LgogICAgdGVhcmRvd246IGZ1bmN0aW9uKCkgewogICAgICAvLyBJZiB3aW5kb3cub25oYXNoY2hhbmdlIGlzIHN1cHBvcnRlZCBuYXRpdmVseSwgdGhlcmUncyBub3RoaW5nIHRvIGRvLi4KICAgICAgaWYgKCBzdXBwb3J0c19vbmhhc2hjaGFuZ2UgKSB7IHJldHVybiBmYWxzZTsgfQogICAgICAKICAgICAgLy8gT3RoZXJ3aXNlLCB3ZSBuZWVkIHRvIHN0b3Agb3VycyAoaWYgcG9zc2libGUpLgogICAgICAkKCBmYWtlX29uaGFzaGNoYW5nZS5zdG9wICk7CiAgICB9CiAgICAKICB9KTsKICAKICAvLyBmYWtlX29uaGFzaGNoYW5nZSBkb2VzIGFsbCB0aGUgd29yayBvZiB0cmlnZ2VyaW5nIHRoZSB3aW5kb3cub25oYXNoY2hhbmdlCiAgLy8gZXZlbnQgZm9yIGJyb3dzZXJzIHRoYXQgZG9uJ3QgbmF0aXZlbHkgc3VwcG9ydCBpdCwgaW5jbHVkaW5nIGNyZWF0aW5nIGEKICAvLyBwb2xsaW5nIGxvb3AgdG8gd2F0Y2ggZm9yIGhhc2ggY2hhbmdlcyBhbmQgaW4gSUUgNi83IGNyZWF0aW5nIGEgaGlkZGVuCiAgLy8gSWZyYW1lIHRvIGVuYWJsZSBiYWNrIGFuZCBmb3J3YXJkLgogIGZha2Vfb25oYXNoY2hhbmdlID0gKGZ1bmN0aW9uKCkgewogICAgdmFyIHNlbGYgPSB7fSwKICAgICAgdGltZW91dF9pZCwKICAgICAgCiAgICAgIC8vIFJlbWVtYmVyIHRoZSBpbml0aWFsIGhhc2ggc28gaXQgZG9lc24ndCBnZXQgdHJpZ2dlcmVkIGltbWVkaWF0ZWx5LgogICAgICBsYXN0X2hhc2ggPSBnZXRfZnJhZ21lbnQoKSwKICAgICAgCiAgICAgIGZuX3JldHZhbCA9IGZ1bmN0aW9uKCB2YWwgKSB7IHJldHVybiB2YWw7IH0sCiAgICAgIGhpc3Rvcnlfc2V0ID0gZm5fcmV0dmFsLAogICAgICBoaXN0b3J5X2dldCA9IGZuX3JldHZhbDsKICAgIAogICAgLy8gU3RhcnQgdGhlIHBvbGxpbmcgbG9vcC4KICAgIHNlbGYuc3RhcnQgPSBmdW5jdGlvbigpIHsKICAgICAgdGltZW91dF9pZCB8fCBwb2xsKCk7CiAgICB9OwogICAgCiAgICAvLyBTdG9wIHRoZSBwb2xsaW5nIGxvb3AuCiAgICBzZWxmLnN0b3AgPSBmdW5jdGlvbigpIHsKICAgICAgdGltZW91dF9pZCAmJiBjbGVhclRpbWVvdXQoIHRpbWVvdXRfaWQgKTsKICAgICAgdGltZW91dF9pZCA9IHVuZGVmaW5lZDsKICAgIH07CiAgICAKICAgIC8vIFRoaXMgcG9sbGluZyBsb29wIGNoZWNrcyBldmVyeSAkLmZuLmhhc2hjaGFuZ2UuZGVsYXkgbWlsbGlzZWNvbmRzIHRvIHNlZQogICAgLy8gaWYgbG9jYXRpb24uaGFzaCBoYXMgY2hhbmdlZCwgYW5kIHRyaWdnZXJzIHRoZSAnaGFzaGNoYW5nZScgZXZlbnQgb24KICAgIC8vIHdpbmRvdyB3aGVuIG5lY2Vzc2FyeS4KICAgIGZ1bmN0aW9uIHBvbGwoKSB7CiAgICAgIHZhciBoYXNoID0gZ2V0X2ZyYWdtZW50KCksCiAgICAgICAgaGlzdG9yeV9oYXNoID0gaGlzdG9yeV9nZXQoIGxhc3RfaGFzaCApOwogICAgICAKICAgICAgaWYgKCBoYXNoICE9PSBsYXN0X2hhc2ggKSB7CiAgICAgICAgaGlzdG9yeV9zZXQoIGxhc3RfaGFzaCA9IGhhc2gsIGhpc3RvcnlfaGFzaCApOwogICAgICAgIAogICAgICAgICQod2luZG93KS50cmlnZ2VyKCBzdHJfaGFzaGNoYW5nZSApOwogICAgICAgIAogICAgICB9IGVsc2UgaWYgKCBoaXN0b3J5X2hhc2ggIT09IGxhc3RfaGFzaCApIHsKICAgICAgICBsb2NhdGlvbi5ocmVmID0gbG9jYXRpb24uaHJlZi5yZXBsYWNlKCAvIy4qLywgJycgKSArIGhpc3RvcnlfaGFzaDsKICAgICAgfQogICAgICAKICAgICAgdGltZW91dF9pZCA9IHNldFRpbWVvdXQoIHBvbGwsICQuZm5bIHN0cl9oYXNoY2hhbmdlIF0uZGVsYXkgKTsKICAgIH07CiAgICAKICAgIC8vIHZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dgogICAgLy8gdnZ2dnZ2dnZ2dnZ2dnZ2dnZ2diBSRU1PVkUgSUYgTk9UIFNVUFBPUlRJTkcgSUU2LzcvOCB2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2CiAgICAvLyB2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnYKICAgIHdpbmRvdy5hdHRhY2hFdmVudCAmJiAhd2luZG93LmFkZEV2ZW50TGlzdGVuZXIgJiYgIXN1cHBvcnRzX29uaGFzaGNoYW5nZSAmJiAoZnVuY3Rpb24oKSB7CiAgICAgIC8vIE5vdCBvbmx5IGRvIElFNi83IG5lZWQgdGhlICJtYWdpY2FsIiBJZnJhbWUgdHJlYXRtZW50LCBidXQgc28gZG9lcyBJRTgKICAgICAgLy8gd2hlbiBydW5uaW5nIGluICJJRTcgY29tcGF0aWJpbGl0eSIgbW9kZS4KICAgICAgCiAgICAgIHZhciBpZnJhbWUsCiAgICAgICAgaWZyYW1lX3NyYzsKICAgICAgCiAgICAgIC8vIFdoZW4gdGhlIGV2ZW50IGlzIGJvdW5kIGFuZCBwb2xsaW5nIHN0YXJ0cyBpbiBJRSA2LzcsIGNyZWF0ZSBhIGhpZGRlbgogICAgICAvLyBJZnJhbWUgZm9yIGhpc3RvcnkgaGFuZGxpbmcuCiAgICAgIHNlbGYuc3RhcnQgPSBmdW5jdGlvbigpIHsKICAgICAgICBpZiAoICFpZnJhbWUgKSB7CiAgICAgICAgICBpZnJhbWVfc3JjID0gJC5mblsgc3RyX2hhc2hjaGFuZ2UgXS5zcmM7CiAgICAgICAgICBpZnJhbWVfc3JjID0gaWZyYW1lX3NyYyAmJiBpZnJhbWVfc3JjICsgZ2V0X2ZyYWdtZW50KCk7CiAgICAgICAgICAKICAgICAgICAgIC8vIENyZWF0ZSBoaWRkZW4gSWZyYW1lLiBBdHRlbXB0IHRvIG1ha2UgSWZyYW1lIGFzIGhpZGRlbiBhcyBwb3NzaWJsZQogICAgICAgICAgLy8gYnkgdXNpbmcgdGVjaG5pcXVlcyBmcm9tIGh0dHA6Ly93d3cucGFjaWVsbG9ncm91cC5jb20vYmxvZy8/cD02MDQuCiAgICAgICAgICBpZnJhbWUgPSAkKCc8aWZyYW1lIHRhYmluZGV4PSItMSIgdGl0bGU9ImVtcHR5Ii8+JykuaGlkZSgpCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBXaGVuIElmcmFtZSBoYXMgY29tcGxldGVseSBsb2FkZWQsIGluaXRpYWxpemUgdGhlIGhpc3RvcnkgYW5kCiAgICAgICAgICAgIC8vIHN0YXJ0IHBvbGxpbmcuCiAgICAgICAgICAgIC5vbmUoICdsb2FkJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgaWZyYW1lX3NyYyB8fCBoaXN0b3J5X3NldCggZ2V0X2ZyYWdtZW50KCkgKTsKICAgICAgICAgICAgICBwb2xsKCk7CiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBMb2FkIElmcmFtZSBzcmMgaWYgc3BlY2lmaWVkLCBvdGhlcndpc2Ugbm90aGluZy4KICAgICAgICAgICAgLmF0dHIoICdzcmMnLCBpZnJhbWVfc3JjIHx8ICdqYXZhc2NyaXB0OjAnICkKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEFwcGVuZCBJZnJhbWUgYWZ0ZXIgdGhlIGVuZCBvZiB0aGUgYm9keSB0byBwcmV2ZW50IHVubmVjZXNzYXJ5CiAgICAgICAgICAgIC8vIGluaXRpYWwgcGFnZSBzY3JvbGxpbmcgKHllcywgdGhpcyB3b3JrcykuCiAgICAgICAgICAgIC5pbnNlcnRBZnRlciggJ2JvZHknIClbMF0uY29udGVudFdpbmRvdzsKICAgICAgICAgIAogICAgICAgICAgLy8gV2hlbmV2ZXIgYGRvY3VtZW50LnRpdGxlYCBjaGFuZ2VzLCB1cGRhdGUgdGhlIElmcmFtZSdzIHRpdGxlIHRvCiAgICAgICAgICAvLyBwcmV0dGlmeSB0aGUgYmFjay9uZXh0IGhpc3RvcnkgbWVudSBlbnRyaWVzLiBTaW5jZSBJRSBzb21ldGltZXMKICAgICAgICAgIC8vIGVycm9ycyB3aXRoICJVbnNwZWNpZmllZCBlcnJvciIgdGhlIHZlcnkgZmlyc3QgdGltZSB0aGlzIGlzIHNldAogICAgICAgICAgLy8gKHllcywgdmVyeSB1c2VmdWwpIHdyYXAgdGhpcyB3aXRoIGEgdHJ5L2NhdGNoIGJsb2NrLgogICAgICAgICAgZG9jLm9ucHJvcGVydHljaGFuZ2UgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICBpZiAoIGV2ZW50LnByb3BlcnR5TmFtZSA9PT0gJ3RpdGxlJyApIHsKICAgICAgICAgICAgICAgIGlmcmFtZS5kb2N1bWVudC50aXRsZSA9IGRvYy50aXRsZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gY2F0Y2goZSkge30KICAgICAgICAgIH07CiAgICAgICAgICAKICAgICAgICB9CiAgICAgIH07CiAgICAgIAogICAgICAvLyBPdmVycmlkZSB0aGUgInN0b3AiIG1ldGhvZCBzaW5jZSBhbiBJRTYvNyBJZnJhbWUgd2FzIGNyZWF0ZWQuIEV2ZW4KICAgICAgLy8gaWYgdGhlcmUgYXJlIG5vIGxvbmdlciBhbnkgYm91bmQgZXZlbnQgaGFuZGxlcnMsIHRoZSBwb2xsaW5nIGxvb3AKICAgICAgLy8gaXMgc3RpbGwgbmVjZXNzYXJ5IGZvciBiYWNrL25leHQgdG8gd29yayBhdCBhbGwhCiAgICAgIHNlbGYuc3RvcCA9IGZuX3JldHZhbDsKICAgICAgCiAgICAgIC8vIEdldCBoaXN0b3J5IGJ5IGxvb2tpbmcgYXQgdGhlIGhpZGRlbiBJZnJhbWUncyBsb2NhdGlvbi5oYXNoLgogICAgICBoaXN0b3J5X2dldCA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBnZXRfZnJhZ21lbnQoIGlmcmFtZS5sb2NhdGlvbi5ocmVmICk7CiAgICAgIH07CiAgICAgIAogICAgICAvLyBTZXQgYSBuZXcgaGlzdG9yeSBpdGVtIGJ5IG9wZW5pbmcgYW5kIHRoZW4gY2xvc2luZyB0aGUgSWZyYW1lCiAgICAgIC8vIGRvY3VtZW50LCAqdGhlbiogc2V0dGluZyBpdHMgbG9jYXRpb24uaGFzaC4gSWYgZG9jdW1lbnQuZG9tYWluIGhhcwogICAgICAvLyBiZWVuIHNldCwgdXBkYXRlIHRoYXQgYXMgd2VsbC4KICAgICAgaGlzdG9yeV9zZXQgPSBmdW5jdGlvbiggaGFzaCwgaGlzdG9yeV9oYXNoICkgewogICAgICAgIHZhciBpZnJhbWVfZG9jID0gaWZyYW1lLmRvY3VtZW50LAogICAgICAgICAgZG9tYWluID0gJC5mblsgc3RyX2hhc2hjaGFuZ2UgXS5kb21haW47CiAgICAgICAgCiAgICAgICAgaWYgKCBoYXNoICE9PSBoaXN0b3J5X2hhc2ggKSB7CiAgICAgICAgICAvLyBVcGRhdGUgSWZyYW1lIHdpdGggYW55IGluaXRpYWwgYGRvY3VtZW50LnRpdGxlYCB0aGF0IG1pZ2h0IGJlIHNldC4KICAgICAgICAgIGlmcmFtZV9kb2MudGl0bGUgPSBkb2MudGl0bGU7CiAgICAgICAgICAKICAgICAgICAgIC8vIE9wZW5pbmcgdGhlIElmcmFtZSdzIGRvY3VtZW50IGFmdGVyIGl0IGhhcyBiZWVuIGNsb3NlZCBpcyB3aGF0CiAgICAgICAgICAvLyBhY3R1YWxseSBhZGRzIGEgaGlzdG9yeSBlbnRyeS4KICAgICAgICAgIGlmcmFtZV9kb2Mub3BlbigpOwogICAgICAgICAgCiAgICAgICAgICAvLyBTZXQgZG9jdW1lbnQuZG9tYWluIGZvciB0aGUgSWZyYW1lIGRvY3VtZW50IGFzIHdlbGwsIGlmIG5lY2Vzc2FyeS4KICAgICAgICAgIGRvbWFpbiAmJiBpZnJhbWVfZG9jLndyaXRlKCAnPHNjcmlwdD5kb2N1bWVudC5kb21haW49IicgKyBkb21haW4gKyAnIjxcL3NjcmlwdD4nICk7CiAgICAgICAgICAKICAgICAgICAgIGlmcmFtZV9kb2MuY2xvc2UoKTsKICAgICAgICAgIAogICAgICAgICAgLy8gVXBkYXRlIHRoZSBJZnJhbWUncyBoYXNoLCBmb3IgZ3JlYXQganVzdGljZS4KICAgICAgICAgIGlmcmFtZS5sb2NhdGlvbi5oYXNoID0gaGFzaDsKICAgICAgICB9CiAgICAgIH07CiAgICAgIAogICAgfSkoKTsKICAgIC8vIF5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXgogICAgLy8gXl5eXl5eXl5eXl5eXl5eXl5eXiBSRU1PVkUgSUYgTk9UIFNVUFBPUlRJTkcgSUU2LzcvOCBeXl5eXl5eXl5eXl5eXl5eXl5eCiAgICAvLyBeXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl4KICAgIAogICAgcmV0dXJuIHNlbGY7CiAgfSkoKTsKICAKfSkoalF1ZXJ5LHRoaXMpOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgoJLyohIG1hdGNoTWVkaWEoKSBwb2x5ZmlsbCAtIFRlc3QgYSBDU1MgbWVkaWEgdHlwZS9xdWVyeSBpbiBKUy4gQXV0aG9ycyAmIGNvcHlyaWdodCAoYykgMjAxMjogU2NvdHQgSmVobCwgUGF1bCBJcmlzaCwgTmljaG9sYXMgWmFrYXMuIER1YWwgTUlUL0JTRCBsaWNlbnNlICovCgl3aW5kb3cubWF0Y2hNZWRpYSA9IHdpbmRvdy5tYXRjaE1lZGlhIHx8IChmdW5jdGlvbiggZG9jLCB1bmRlZmluZWQgKSB7CgoJCQoKCQl2YXIgYm9vbCwKCQkJZG9jRWxlbSA9IGRvYy5kb2N1bWVudEVsZW1lbnQsCgkJCXJlZk5vZGUgPSBkb2NFbGVtLmZpcnN0RWxlbWVudENoaWxkIHx8IGRvY0VsZW0uZmlyc3RDaGlsZCwKCQkJLy8gZmFrZUJvZHkgcmVxdWlyZWQgZm9yIDxGRjQgd2hlbiBleGVjdXRlZCBpbiA8aGVhZD4KCQkJZmFrZUJvZHkgPSBkb2MuY3JlYXRlRWxlbWVudCggImJvZHkiICksCgkJCWRpdiA9IGRvYy5jcmVhdGVFbGVtZW50KCAiZGl2IiApOwoKCQlkaXYuaWQgPSAibXEtdGVzdC0xIjsKCQlkaXYuc3R5bGUuY3NzVGV4dCA9ICJwb3NpdGlvbjphYnNvbHV0ZTt0b3A6LTEwMGVtIjsKCQlmYWtlQm9keS5zdHlsZS5iYWNrZ3JvdW5kID0gIm5vbmUiOwoJCWZha2VCb2R5LmFwcGVuZENoaWxkKGRpdik7CgoJCXJldHVybiBmdW5jdGlvbihxKXsKCgkJCWRpdi5pbm5lckhUTUwgPSAiJnNoeTs8c3R5bGUgbWVkaWE9XCIiICsgcSArICJcIj4gI21xLXRlc3QtMSB7IHdpZHRoOiA0MnB4OyB9PC9zdHlsZT4iOwoKCQkJZG9jRWxlbS5pbnNlcnRCZWZvcmUoIGZha2VCb2R5LCByZWZOb2RlICk7CgkJCWJvb2wgPSBkaXYub2Zmc2V0V2lkdGggPT09IDQyOwoJCQlkb2NFbGVtLnJlbW92ZUNoaWxkKCBmYWtlQm9keSApOwoKCQkJcmV0dXJuIHsKCQkJCW1hdGNoZXM6IGJvb2wsCgkJCQltZWRpYTogcQoJCQl9OwoKCQl9OwoKCX0oIGRvY3VtZW50ICkpOwoKCS8vICQubW9iaWxlLm1lZGlhIHVzZXMgbWF0Y2hNZWRpYSB0byByZXR1cm4gYSBib29sZWFuLgoJJC5tb2JpbGUubWVkaWEgPSBmdW5jdGlvbiggcSApIHsKCQlyZXR1cm4gd2luZG93Lm1hdGNoTWVkaWEoIHEgKS5tYXRjaGVzOwoJfTsKCn0pKGpRdWVyeSk7CgoJKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgkJdmFyIHN1cHBvcnQgPSB7CgkJCXRvdWNoOiAib250b3VjaGVuZCIgaW4gZG9jdW1lbnQKCQl9OwoKCQkkLm1vYmlsZS5zdXBwb3J0ID0gJC5tb2JpbGUuc3VwcG9ydCB8fCB7fTsKCQkkLmV4dGVuZCggJC5zdXBwb3J0LCBzdXBwb3J0ICk7CgkJJC5leHRlbmQoICQubW9iaWxlLnN1cHBvcnQsIHN1cHBvcnQgKTsKCX0oIGpRdWVyeSApKTsKCgkoZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCQkkLmV4dGVuZCggJC5zdXBwb3J0LCB7CgkJCW9yaWVudGF0aW9uOiAib3JpZW50YXRpb24iIGluIHdpbmRvdyAmJiAib25vcmllbnRhdGlvbmNoYW5nZSIgaW4gd2luZG93CgkJfSk7Cgl9KCBqUXVlcnkgKSk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCi8vIHRoeCBNb2Rlcm5penIKZnVuY3Rpb24gcHJvcEV4aXN0cyggcHJvcCApIHsKCXZhciB1Y19wcm9wID0gcHJvcC5jaGFyQXQoIDAgKS50b1VwcGVyQ2FzZSgpICsgcHJvcC5zdWJzdHIoIDEgKSwKCQlwcm9wcyA9ICggcHJvcCArICIgIiArIHZlbmRvcnMuam9pbiggdWNfcHJvcCArICIgIiApICsgdWNfcHJvcCApLnNwbGl0KCAiICIgKSwKCQl2OwoKCWZvciAoIHYgaW4gcHJvcHMgKSB7CgkJaWYgKCBmYkNTU1sgcHJvcHNbIHYgXSBdICE9PSB1bmRlZmluZWQgKSB7CgkJCXJldHVybiB0cnVlOwoJCX0KCX0KfQoKdmFyIGZha2VCb2R5ID0gJCggIjxib2R5PiIgKS5wcmVwZW5kVG8oICJodG1sIiApLAoJZmJDU1MgPSBmYWtlQm9keVsgMCBdLnN0eWxlLAoJdmVuZG9ycyA9IFsgIldlYmtpdCIsICJNb3oiLCAiTyIgXSwKCXdlYm9zID0gInBhbG1HZXRSZXNvdXJjZSIgaW4gd2luZG93LCAvL29ubHkgdXNlZCB0byBydWxlIG91dCBzY3JvbGxUb3AKCW9wZXJhID0gd2luZG93Lm9wZXJhLAoJb3BlcmFtaW5pID0gd2luZG93Lm9wZXJhbWluaSAmJiAoe30pLnRvU3RyaW5nLmNhbGwoIHdpbmRvdy5vcGVyYW1pbmkgKSA9PT0gIltvYmplY3QgT3BlcmFNaW5pXSIsCgliYiA9IHdpbmRvdy5ibGFja2JlcnJ5ICYmICFwcm9wRXhpc3RzKCAiLXdlYmtpdC10cmFuc2Zvcm0iICksIC8vb25seSB1c2VkIHRvIHJ1bGUgb3V0IGJveCBzaGFkb3csIGFzIGl0J3MgZmlsbGVkIG9wYXF1ZSBvbiBCQiA1IGFuZCBsb3dlcgoJbm9raWFMVEU3XzM7CgoKZnVuY3Rpb24gdmFsaWRTdHlsZSggcHJvcCwgdmFsdWUsIGNoZWNrX3ZlbmQgKSB7Cgl2YXIgZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImRpdiIgKSwKCQl1YyA9IGZ1bmN0aW9uKCB0eHQgKSB7CgkJCXJldHVybiB0eHQuY2hhckF0KCAwICkudG9VcHBlckNhc2UoKSArIHR4dC5zdWJzdHIoIDEgKTsKCQl9LAoJCXZlbmRfcHJlZiA9IGZ1bmN0aW9uKCB2ZW5kICkgewoJCQlpZiAoIHZlbmQgPT09ICIiICkgewoJCQkJcmV0dXJuICIiOwoJCQl9IGVsc2UgewoJCQkJcmV0dXJuICAiLSIgKyB2ZW5kLmNoYXJBdCggMCApLnRvTG93ZXJDYXNlKCkgKyB2ZW5kLnN1YnN0ciggMSApICsgIi0iOwoJCQl9CgkJfSwKCQljaGVja19zdHlsZSA9IGZ1bmN0aW9uKCB2ZW5kICkgewoJCQl2YXIgdmVuZF9wcm9wID0gdmVuZF9wcmVmKCB2ZW5kICkgKyBwcm9wICsgIjogIiArIHZhbHVlICsgIjsiLAoJCQkJdWNfdmVuZCA9IHVjKCB2ZW5kICksCgkJCQlwcm9wU3R5bGUgPSB1Y192ZW5kICsgKCB1Y192ZW5kID09PSAiIiA/IHByb3AgOiB1YyggcHJvcCApICk7CgoJCQlkaXYuc2V0QXR0cmlidXRlKCAic3R5bGUiLCB2ZW5kX3Byb3AgKTsKCgkJCWlmICggISFkaXYuc3R5bGVbIHByb3BTdHlsZSBdICkgewoJCQkJcmV0ID0gdHJ1ZTsKCQkJfQoJCX0sCgkJY2hlY2tfdmVuZHMgPSBjaGVja192ZW5kID8gY2hlY2tfdmVuZCA6IHZlbmRvcnMsCgkJaSwgcmV0OwoKCWZvciggaSA9IDA7IGkgPCBjaGVja192ZW5kcy5sZW5ndGg7IGkrKyApIHsKCQljaGVja19zdHlsZSggY2hlY2tfdmVuZHNbaV0gKTsKCX0KCXJldHVybiAhIXJldDsKfQoKLy8gaW5saW5lIFNWRyBzdXBwb3J0IHRlc3QKZnVuY3Rpb24gaW5saW5lU1ZHKCkgewoJLy8gVGhhbmtzIE1vZGVybml6ciAmIEVyaWsgRGFobHN0cm9tCgl2YXIgdyA9IHdpbmRvdywKCQlzdmcgPSAhIXcuZG9jdW1lbnQuY3JlYXRlRWxlbWVudE5TICYmICEhdy5kb2N1bWVudC5jcmVhdGVFbGVtZW50TlMoICJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIsICJzdmciICkuY3JlYXRlU1ZHUmVjdCAmJiAhKCB3Lm9wZXJhICYmIG5hdmlnYXRvci51c2VyQWdlbnQuaW5kZXhPZiggIkNocm9tZSIgKSA9PT0gLTEgKSwKCQlzdXBwb3J0ID0gZnVuY3Rpb24oIGRhdGEgKSB7CgkJCWlmICggISggZGF0YSAmJiBzdmcgKSApIHsKCQkJCSQoICJodG1sIiApLmFkZENsYXNzKCAidWktbm9zdmciICk7CgkJCX0KCQl9LAoJCWltZyA9IG5ldyB3LkltYWdlKCk7CgoJaW1nLm9uZXJyb3IgPSBmdW5jdGlvbigpIHsKCQlzdXBwb3J0KCBmYWxzZSApOwoJfTsKCWltZy5vbmxvYWQgPSBmdW5jdGlvbigpIHsKCQlzdXBwb3J0KCBpbWcud2lkdGggPT09IDEgJiYgaW1nLmhlaWdodCA9PT0gMSApOwoJfTsKCWltZy5zcmMgPSAiZGF0YTppbWFnZS9naWY7YmFzZTY0LFIwbEdPRGxoQVFBQkFJQUFBQUFBQVAvLy95d0FBQUFBQVFBQkFBQUNBVXdBT3c9PSI7Cn0KCmZ1bmN0aW9uIHRyYW5zZm9ybTNkVGVzdCgpIHsKCXZhciBtcVByb3AgPSAidHJhbnNmb3JtLTNkIiwKCQkvLyBCZWNhdXNlIHRoZSBgdHJhbnNsYXRlM2RgIHRlc3QgYmVsb3cgdGhyb3dzIGZhbHNlIHBvc2l0aXZlcyBpbiBBbmRyb2lkOgoJCXJldCA9ICQubW9iaWxlLm1lZGlhKCAiKC0iICsgdmVuZG9ycy5qb2luKCAiLSIgKyBtcVByb3AgKyAiKSwoLSIgKSArICItIiArIG1xUHJvcCArICIpLCgiICsgbXFQcm9wICsgIikiICksCgkJZWwsIHRyYW5zZm9ybXMsIHQ7CgoJaWYgKCByZXQgKSB7CgkJcmV0dXJuICEhcmV0OwoJfQoKCWVsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImRpdiIgKTsKCXRyYW5zZm9ybXMgPSB7CgkJLy8gV2XigJlyZSBvbWl0dGluZyBPcGVyYSBmb3IgdGhlIHRpbWUgYmVpbmc7IE1TIHVzZXMgdW5wcmVmaXhlZC4KCQkiTW96VHJhbnNmb3JtIjogIi1tb3otdHJhbnNmb3JtIiwKCQkidHJhbnNmb3JtIjogInRyYW5zZm9ybSIKCX07CgoJZmFrZUJvZHkuYXBwZW5kKCBlbCApOwoKCWZvciAoIHQgaW4gdHJhbnNmb3JtcyApIHsKCQlpZiAoIGVsLnN0eWxlWyB0IF0gIT09IHVuZGVmaW5lZCApewoJCQllbC5zdHlsZVsgdCBdID0gInRyYW5zbGF0ZTNkKCAxMDBweCwgMXB4LCAxcHggKSI7CgkJCXJldCA9IHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKCBlbCApLmdldFByb3BlcnR5VmFsdWUoIHRyYW5zZm9ybXNbIHQgXSApOwoJCX0KCX0KCXJldHVybiAoICEhcmV0ICYmIHJldCAhPT0gIm5vbmUiICk7Cn0KCi8vIFRlc3QgZm9yIGR5bmFtaWMtdXBkYXRpbmcgYmFzZSB0YWcgc3VwcG9ydCAoIGFsbG93cyB1cyB0byBhdm9pZCBocmVmLHNyYyBhdHRyIHJld3JpdGluZyApCmZ1bmN0aW9uIGJhc2VUYWdUZXN0KCkgewoJdmFyIGZhdXhCYXNlID0gbG9jYXRpb24ucHJvdG9jb2wgKyAiLy8iICsgbG9jYXRpb24uaG9zdCArIGxvY2F0aW9uLnBhdGhuYW1lICsgInVpLWRpci8iLAoJCWJhc2UgPSAkKCAiaGVhZCBiYXNlIiApLAoJCWZhdXhFbGUgPSBudWxsLAoJCWhyZWYgPSAiIiwKCQlsaW5rLCByZWJhc2U7CgoJaWYgKCAhYmFzZS5sZW5ndGggKSB7CgkJYmFzZSA9IGZhdXhFbGUgPSAkKCAiPGJhc2U+IiwgeyAiaHJlZiI6IGZhdXhCYXNlIH0pLmFwcGVuZFRvKCAiaGVhZCIgKTsKCX0gZWxzZSB7CgkJaHJlZiA9IGJhc2UuYXR0ciggImhyZWYiICk7Cgl9CgoJbGluayA9ICQoICI8YSBocmVmPSd0ZXN0dXJsJyAvPiIgKS5wcmVwZW5kVG8oIGZha2VCb2R5ICk7CglyZWJhc2UgPSBsaW5rWyAwIF0uaHJlZjsKCWJhc2VbIDAgXS5ocmVmID0gaHJlZiB8fCBsb2NhdGlvbi5wYXRobmFtZTsKCglpZiAoIGZhdXhFbGUgKSB7CgkJZmF1eEVsZS5yZW1vdmUoKTsKCX0KCXJldHVybiByZWJhc2UuaW5kZXhPZiggZmF1eEJhc2UgKSA9PT0gMDsKfQoKLy8gVGhhbmtzIE1vZGVybml6cgpmdW5jdGlvbiBjc3NQb2ludGVyRXZlbnRzVGVzdCgpIHsKCXZhciBlbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggIngiICksCgkJZG9jdW1lbnRFbGVtZW50ID0gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LAoJCWdldENvbXB1dGVkU3R5bGUgPSB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZSwKCQlzdXBwb3J0czsKCglpZiAoICEoICJwb2ludGVyRXZlbnRzIiBpbiBlbGVtZW50LnN0eWxlICkgKSB7CgkJcmV0dXJuIGZhbHNlOwoJfQoKCWVsZW1lbnQuc3R5bGUucG9pbnRlckV2ZW50cyA9ICJhdXRvIjsKCWVsZW1lbnQuc3R5bGUucG9pbnRlckV2ZW50cyA9ICJ4IjsKCWRvY3VtZW50RWxlbWVudC5hcHBlbmRDaGlsZCggZWxlbWVudCApOwoJc3VwcG9ydHMgPSBnZXRDb21wdXRlZFN0eWxlICYmCglnZXRDb21wdXRlZFN0eWxlKCBlbGVtZW50LCAiIiApLnBvaW50ZXJFdmVudHMgPT09ICJhdXRvIjsKCWRvY3VtZW50RWxlbWVudC5yZW1vdmVDaGlsZCggZWxlbWVudCApOwoJcmV0dXJuICEhc3VwcG9ydHM7Cn0KCmZ1bmN0aW9uIGJvdW5kaW5nUmVjdCgpIHsKCXZhciBkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiZGl2IiApOwoJcmV0dXJuIHR5cGVvZiBkaXYuZ2V0Qm91bmRpbmdDbGllbnRSZWN0ICE9PSAidW5kZWZpbmVkIjsKfQoKLy8gbm9uLVVBLWJhc2VkIElFIHZlcnNpb24gY2hlY2sgYnkgSmFtZXMgUGFkb2xzZXksIG1vZGlmaWVkIGJ5IGpkYWx0b24gLSBmcm9tIGh0dHA6Ly9naXN0LmdpdGh1Yi5jb20vNTI3NjgzCi8vIGFsbG93cyBmb3IgaW5jbHVzaW9uIG9mIElFIDYrLCBpbmNsdWRpbmcgV2luZG93cyBNb2JpbGUgNwokLmV4dGVuZCggJC5tb2JpbGUsIHsgYnJvd3Nlcjoge30gfSApOwokLm1vYmlsZS5icm93c2VyLm9sZElFID0gKGZ1bmN0aW9uKCkgewoJdmFyIHYgPSAzLAoJCWRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJkaXYiICksCgkJYSA9IGRpdi5hbGwgfHwgW107CgoJZG8gewoJCWRpdi5pbm5lckhUTUwgPSAiPCEtLVtpZiBndCBJRSAiICsgKCArK3YgKSArICJdPjxicj48IVtlbmRpZl0tLT4iOwoJfSB3aGlsZSggYVswXSApOwoKCXJldHVybiB2ID4gNCA/IHYgOiAhdjsKfSkoKTsKCmZ1bmN0aW9uIGZpeGVkUG9zaXRpb24oKSB7Cgl2YXIgdyA9IHdpbmRvdywKCQl1YSA9IG5hdmlnYXRvci51c2VyQWdlbnQsCgkJcGxhdGZvcm0gPSBuYXZpZ2F0b3IucGxhdGZvcm0sCgkJLy8gUmVuZGVyaW5nIGVuZ2luZSBpcyBXZWJraXQsIGFuZCBjYXB0dXJlIG1ham9yIHZlcnNpb24KCQl3a21hdGNoID0gdWEubWF0Y2goIC9BcHBsZVdlYktpdFwvKFswLTldKykvICksCgkJd2t2ZXJzaW9uID0gISF3a21hdGNoICYmIHdrbWF0Y2hbIDEgXSwKCQlmZm1hdGNoID0gdWEubWF0Y2goIC9GZW5uZWNcLyhbMC05XSspLyApLAoJCWZmdmVyc2lvbiA9ICEhZmZtYXRjaCAmJiBmZm1hdGNoWyAxIF0sCgkJb3BlcmFtbW9iaWxlbWF0Y2ggPSB1YS5tYXRjaCggL09wZXJhIE1vYmlcLyhbMC05XSspLyApLAoJCW9tdmVyc2lvbiA9ICEhb3BlcmFtbW9iaWxlbWF0Y2ggJiYgb3BlcmFtbW9iaWxlbWF0Y2hbIDEgXTsKCglpZiAoCgkJLy8gaU9TIDQuMyBhbmQgb2xkZXIgOiBQbGF0Zm9ybSBpcyBpUGhvbmUvUGFkL1RvdWNoIGFuZCBXZWJraXQgdmVyc2lvbiBpcyBsZXNzIHRoYW4gNTM0IChpb3M1KQoJCSggKCBwbGF0Zm9ybS5pbmRleE9mKCAiaVBob25lIiApID4gLTEgfHwgcGxhdGZvcm0uaW5kZXhPZiggImlQYWQiICkgPiAtMSAgfHwgcGxhdGZvcm0uaW5kZXhPZiggImlQb2QiICkgPiAtMSApICYmIHdrdmVyc2lvbiAmJiB3a3ZlcnNpb24gPCA1MzQgKSB8fAoJCS8vIE9wZXJhIE1pbmkKCQkoIHcub3BlcmFtaW5pICYmICh7fSkudG9TdHJpbmcuY2FsbCggdy5vcGVyYW1pbmkgKSA9PT0gIltvYmplY3QgT3BlcmFNaW5pXSIgKSB8fAoJCSggb3BlcmFtbW9iaWxlbWF0Y2ggJiYgb212ZXJzaW9uIDwgNzQ1OCApCXx8CgkJLy9BbmRyb2lkIGx0ZSAyLjE6IFBsYXRmb3JtIGlzIEFuZHJvaWQgYW5kIFdlYmtpdCB2ZXJzaW9uIGlzIGxlc3MgdGhhbiA1MzMgKEFuZHJvaWQgMi4yKQoJCSggdWEuaW5kZXhPZiggIkFuZHJvaWQiICkgPiAtMSAmJiB3a3ZlcnNpb24gJiYgd2t2ZXJzaW9uIDwgNTMzICkgfHwKCQkvLyBGaXJlZm94IE1vYmlsZSBiZWZvcmUgNi4wIC0KCQkoIGZmdmVyc2lvbiAmJiBmZnZlcnNpb24gPCA2ICkgfHwKCQkvLyBXZWJPUyBsZXNzIHRoYW4gMwoJCSggInBhbG1HZXRSZXNvdXJjZSIgaW4gd2luZG93ICYmIHdrdmVyc2lvbiAmJiB3a3ZlcnNpb24gPCA1MzQgKQl8fAoJCS8vIE1lZUdvCgkJKCB1YS5pbmRleE9mKCAiTWVlR28iICkgPiAtMSAmJiB1YS5pbmRleE9mKCAiTm9raWFCcm93c2VyLzguNS4wIiApID4gLTEgKSApIHsKCQlyZXR1cm4gZmFsc2U7Cgl9CgoJcmV0dXJuIHRydWU7Cn0KCiQuZXh0ZW5kKCAkLnN1cHBvcnQsIHsKCWNzc1RyYW5zaXRpb25zOiAiV2ViS2l0VHJhbnNpdGlvbkV2ZW50IiBpbiB3aW5kb3cgfHwKCQl2YWxpZFN0eWxlKCAidHJhbnNpdGlvbiIsICJoZWlnaHQgMTAwbXMgbGluZWFyIiwgWyAiV2Via2l0IiwgIk1veiIsICIiIF0gKSAmJgoJCSEkLm1vYmlsZS5icm93c2VyLm9sZElFICYmICFvcGVyYSwKCgkvLyBOb3RlLCBDaHJvbWUgZm9yIGlPUyBoYXMgYW4gZXh0cmVtZWx5IHF1aXJreSBpbXBsZW1lbnRhdGlvbiBvZiBwb3BzdGF0ZS4KCS8vIFdlJ3ZlIGNob3NlbiB0byB0YWtlIHRoZSBzaG9ydGVzdCBwYXRoIHRvIGEgYnVnIGZpeCBoZXJlIGZvciBpc3N1ZSAjNTQyNgoJLy8gU2VlIHRoZSBmb2xsb3dpbmcgbGluayBmb3IgaW5mb3JtYXRpb24gYWJvdXQgdGhlIHJlZ2V4IGNob3NlbgoJLy8gaHR0cHM6Ly9kZXZlbG9wZXJzLmdvb2dsZS5jb20vY2hyb21lL21vYmlsZS9kb2NzL3VzZXItYWdlbnQjY2hyb21lX2Zvcl9pb3NfdXNlci1hZ2VudAoJcHVzaFN0YXRlOiAicHVzaFN0YXRlIiBpbiBoaXN0b3J5ICYmCgkJInJlcGxhY2VTdGF0ZSIgaW4gaGlzdG9yeSAmJgoJCS8vIFdoZW4gcnVubmluZyBpbnNpZGUgYSBGRiBpZnJhbWUsIGNhbGxpbmcgcmVwbGFjZVN0YXRlIGNhdXNlcyBhbiBlcnJvcgoJCSEoIHdpbmRvdy5uYXZpZ2F0b3IudXNlckFnZW50LmluZGV4T2YoICJGaXJlZm94IiApID49IDAgJiYgd2luZG93LnRvcCAhPT0gd2luZG93ICkgJiYKCQkoIHdpbmRvdy5uYXZpZ2F0b3IudXNlckFnZW50LnNlYXJjaCgvQ3JpT1MvKSA9PT0gLTEgKSwKCgltZWRpYXF1ZXJ5OiAkLm1vYmlsZS5tZWRpYSggIm9ubHkgYWxsIiApLAoJY3NzUHNldWRvRWxlbWVudDogISFwcm9wRXhpc3RzKCAiY29udGVudCIgKSwKCXRvdWNoT3ZlcmZsb3c6ICEhcHJvcEV4aXN0cyggIm92ZXJmbG93U2Nyb2xsaW5nIiApLAoJY3NzVHJhbnNmb3JtM2Q6IHRyYW5zZm9ybTNkVGVzdCgpLAoJY3NzQW5pbWF0aW9uczogISFwcm9wRXhpc3RzKCAiYW5pbWF0aW9uTmFtZSIgKSwKCWJveFNoYWRvdzogISFwcm9wRXhpc3RzKCAiYm94U2hhZG93IiApICYmICFiYiwKCWZpeGVkUG9zaXRpb246IGZpeGVkUG9zaXRpb24oKSwKCXNjcm9sbFRvcDogKCJwYWdlWE9mZnNldCIgaW4gd2luZG93IHx8CgkJInNjcm9sbFRvcCIgaW4gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50IHx8CgkJInNjcm9sbFRvcCIgaW4gZmFrZUJvZHlbIDAgXSkgJiYgIXdlYm9zICYmICFvcGVyYW1pbmksCgoJZHluYW1pY0Jhc2VUYWc6IGJhc2VUYWdUZXN0KCksCgljc3NQb2ludGVyRXZlbnRzOiBjc3NQb2ludGVyRXZlbnRzVGVzdCgpLAoJYm91bmRpbmdSZWN0OiBib3VuZGluZ1JlY3QoKSwKCWlubGluZVNWRzogaW5saW5lU1ZHCn0pOwoKZmFrZUJvZHkucmVtb3ZlKCk7CgoKLy8gJC5tb2JpbGUuYWpheEJsYWNrbGlzdCBpcyB1c2VkIHRvIG92ZXJyaWRlIGFqYXhFbmFibGVkIG9uIHBsYXRmb3JtcyB0aGF0IGhhdmUga25vd24gY29uZmxpY3RzIHdpdGggaGFzaCBoaXN0b3J5IHVwZGF0ZXMgKEJCNSwgU3ltYmlhbikKLy8gb3IgdGhhdCBnZW5lcmFsbHkgd29yayBiZXR0ZXIgYnJvd3NpbmcgaW4gcmVndWxhciBodHRwIGZvciBmdWxsIHBhZ2UgcmVmcmVzaGVzIChPcGVyYSBNaW5pKQovLyBOb3RlOiBUaGlzIGRldGVjdGlvbiBiZWxvdyBpcyB1c2VkIGFzIGEgbGFzdCByZXNvcnQuCi8vIFdlIHJlY29tbWVuZCBvbmx5IHVzaW5nIHRoZXNlIGRldGVjdGlvbiBtZXRob2RzIHdoZW4gYWxsIG90aGVyIG1vcmUgcmVsaWFibGUvZm9yd2FyZC1sb29raW5nIGFwcHJvYWNoZXMgYXJlIG5vdCBwb3NzaWJsZQpub2tpYUxURTdfMyA9IChmdW5jdGlvbigpIHsKCgl2YXIgdWEgPSB3aW5kb3cubmF2aWdhdG9yLnVzZXJBZ2VudDsKCgkvL1RoZSBmb2xsb3dpbmcgaXMgYW4gYXR0ZW1wdCB0byBtYXRjaCBOb2tpYSBicm93c2VycyB0aGF0IGFyZSBydW5uaW5nIFN5bWJpYW4vczYwLCB3aXRoIHdlYmtpdCwgdmVyc2lvbiA3LjMgb3Igb2xkZXIKCXJldHVybiB1YS5pbmRleE9mKCAiTm9raWEiICkgPiAtMSAmJgoJCQkoIHVhLmluZGV4T2YoICJTeW1iaWFuLzMiICkgPiAtMSB8fCB1YS5pbmRleE9mKCAiU2VyaWVzNjAvNSIgKSA+IC0xICkgJiYKCQkJdWEuaW5kZXhPZiggIkFwcGxlV2ViS2l0IiApID4gLTEgJiYKCQkJdWEubWF0Y2goIC8oQnJvd3Nlck5HfE5va2lhQnJvd3NlcilcLzdcLlswLTNdLyApOwp9KSgpOwoKLy8gU3VwcG9ydCBjb25kaXRpb25zIHRoYXQgbXVzdCBiZSBtZXQgaW4gb3JkZXIgdG8gcHJvY2VlZAovLyBkZWZhdWx0IGVuaGFuY2VkIHF1YWxpZmljYXRpb25zIGFyZSBtZWRpYSBxdWVyeSBzdXBwb3J0IE9SIElFIDcrCgokLm1vYmlsZS5ncmFkZUEgPSBmdW5jdGlvbigpIHsKCXJldHVybiAoICggJC5zdXBwb3J0Lm1lZGlhcXVlcnkgJiYgJC5zdXBwb3J0LmNzc1BzZXVkb0VsZW1lbnQgKSB8fCAkLm1vYmlsZS5icm93c2VyLm9sZElFICYmICQubW9iaWxlLmJyb3dzZXIub2xkSUUgPj0gOCApICYmICggJC5zdXBwb3J0LmJvdW5kaW5nUmVjdCB8fCAkLmZuLmpxdWVyeS5tYXRjaCgvMVwuWzAtNytdXC5bMC05K10/LykgIT09IG51bGwgKTsKfTsKCiQubW9iaWxlLmFqYXhCbGFja2xpc3QgPQoJCQkvLyBCbGFja0JlcnJ5IGJyb3dzZXJzLCBwcmUtd2Via2l0CgkJCXdpbmRvdy5ibGFja2JlcnJ5ICYmICF3aW5kb3cuV2ViS2l0UG9pbnQgfHwKCQkJLy8gT3BlcmEgTWluaQoJCQlvcGVyYW1pbmkgfHwKCQkJLy8gU3ltYmlhbiB3ZWJraXRzIHByZSA3LjMKCQkJbm9raWFMVEU3XzM7CgovLyBMYXN0bHksIHRoaXMgd29ya2Fyb3VuZCBpcyB0aGUgb25seSB3YXkgd2UndmUgZm91bmQgc28gZmFyIHRvIGdldCBwcmUgNy4zIFN5bWJpYW4gd2Via2l0IGRldmljZXMKLy8gdG8gcmVuZGVyIHRoZSBzdHlsZXNoZWV0cyB3aGVuIHRoZXkncmUgcmVmZXJlbmNlZCBiZWZvcmUgdGhpcyBzY3JpcHQsIGFzIHdlJ2QgcmVjb21tZW5kIGRvaW5nLgovLyBUaGlzIHNpbXBseSByZWFwcGVuZHMgdGhlIENTUyBpbiBwbGFjZSwgd2hpY2ggZm9yIHNvbWUgcmVhc29uIG1ha2VzIGl0IGFwcGx5CmlmICggbm9raWFMVEU3XzMgKSB7CgkkKGZ1bmN0aW9uKCkgewoJCSQoICJoZWFkIGxpbmtbcmVsPSdzdHlsZXNoZWV0J10iICkuYXR0ciggInJlbCIsICJhbHRlcm5hdGUgc3R5bGVzaGVldCIgKS5hdHRyKCAicmVsIiwgInN0eWxlc2hlZXQiICk7Cgl9KTsKfQoKLy8gRm9yIHJ1bGluZyBvdXQgc2hhZG93cyB2aWEgY3NzCmlmICggISQuc3VwcG9ydC5ib3hTaGFkb3cgKSB7CgkkKCAiaHRtbCIgKS5hZGRDbGFzcyggInVpLW5vYm94c2hhZG93IiApOwp9Cgp9KSggalF1ZXJ5ICk7CgoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7Cgl2YXIgJHdpbiA9ICQubW9iaWxlLndpbmRvdywgc2VsZiwKCQlkdW1teUZuVG9Jbml0TmF2aWdhdGUgPSBmdW5jdGlvbigpIHsKCQl9OwoKCSQuZXZlbnQuc3BlY2lhbC5iZWZvcmVuYXZpZ2F0ZSA9IHsKCQlzZXR1cDogZnVuY3Rpb24oKSB7CgkJCSR3aW4ub24oICJuYXZpZ2F0ZSIsIGR1bW15Rm5Ub0luaXROYXZpZ2F0ZSApOwoJCX0sCgoJCXRlYXJkb3duOiBmdW5jdGlvbigpIHsKCQkJJHdpbi5vZmYoICJuYXZpZ2F0ZSIsIGR1bW15Rm5Ub0luaXROYXZpZ2F0ZSApOwoJCX0KCX07CgoJJC5ldmVudC5zcGVjaWFsLm5hdmlnYXRlID0gc2VsZiA9IHsKCQlib3VuZDogZmFsc2UsCgoJCXB1c2hTdGF0ZUVuYWJsZWQ6IHRydWUsCgoJCW9yaWdpbmFsRXZlbnROYW1lOiB1bmRlZmluZWQsCgoJCS8vIElmIHB1c2hzdGF0ZSBzdXBwb3J0IGlzIHByZXNlbnQgYW5kIHB1c2ggc3RhdGUgc3VwcG9ydCBpcyBkZWZpbmVkIHRvCgkJLy8gYmUgdHJ1ZSBvbiB0aGUgbW9iaWxlIG5hbWVzcGFjZS4KCQlpc1B1c2hTdGF0ZUVuYWJsZWQ6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gJC5zdXBwb3J0LnB1c2hTdGF0ZSAmJgoJCQkJJC5tb2JpbGUucHVzaFN0YXRlRW5hYmxlZCA9PT0gdHJ1ZSAmJgoJCQkJdGhpcy5pc0hhc2hDaGFuZ2VFbmFibGVkKCk7CgkJfSwKCgkJLy8gISEgYXNzdW1lcyBtb2JpbGUgbmFtZXNwYWNlIGlzIHByZXNlbnQKCQlpc0hhc2hDaGFuZ2VFbmFibGVkOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuICQubW9iaWxlLmhhc2hMaXN0ZW5pbmdFbmFibGVkID09PSB0cnVlOwoJCX0sCgoJCS8vIFRPRE8gYSBsb3Qgb2YgZHVwbGljYXRpb24gYmV0d2VlbiBwb3BzdGF0ZSBhbmQgaGFzaGNoYW5nZQoJCXBvcHN0YXRlOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciBuZXdFdmVudCA9IG5ldyAkLkV2ZW50KCAibmF2aWdhdGUiICksCgkJCQliZWZvcmVOYXZpZ2F0ZSA9IG5ldyAkLkV2ZW50KCAiYmVmb3JlbmF2aWdhdGUiICksCgkJCQlzdGF0ZSA9IGV2ZW50Lm9yaWdpbmFsRXZlbnQuc3RhdGUgfHwge307CgoJCQliZWZvcmVOYXZpZ2F0ZS5vcmlnaW5hbEV2ZW50ID0gZXZlbnQ7CgkJCSR3aW4udHJpZ2dlciggYmVmb3JlTmF2aWdhdGUgKTsKCgkJCWlmICggYmVmb3JlTmF2aWdhdGUuaXNEZWZhdWx0UHJldmVudGVkKCkgKXsKCQkJCXJldHVybjsKCQkJfQoKCQkJaWYgKCBldmVudC5oaXN0b3J5U3RhdGUgKXsKCQkJCSQuZXh0ZW5kKHN0YXRlLCBldmVudC5oaXN0b3J5U3RhdGUpOwoJCQl9CgoJCQkvLyBNYWtlIHN1cmUgdGhlIG9yaWdpbmFsIGV2ZW50IGlzIHRyYWNrZWQgZm9yIHRoZSBlbmQKCQkJLy8gdXNlciB0byBpbnNwZWN0IGluY2FzZSB0aGV5IHdhbnQgdG8gZG8gc29tZXRoaW5nIHNwZWNpYWwKCQkJbmV3RXZlbnQub3JpZ2luYWxFdmVudCA9IGV2ZW50OwoKCQkJLy8gTk9URSB3ZSBsZXQgdGhlIGN1cnJlbnQgc3RhY2sgdW53aW5kIGJlY2F1c2UgYW55IGFzc2lnbm1lbnQgdG8KCQkJLy8gICAgICBsb2NhdGlvbi5oYXNoIHdpbGwgc3RvcCB0aGUgd29ybGQgYW5kIHJ1biB0aGlzIGV2ZW50IGhhbmRsZXIuIEJ5CgkJCS8vICAgICAgZG9pbmcgdGhpcyB3ZSBjcmVhdGUgYSBzaW1pbGFyIGJlaGF2aW9yIHRvIGhhc2hjaGFuZ2Ugb24gaGFzaAoJCQkvLyAgICAgIGFzc2lnbm1lbnQKCQkJc2V0VGltZW91dChmdW5jdGlvbigpIHsKCQkJCSR3aW4udHJpZ2dlciggbmV3RXZlbnQsIHsKCQkJCQlzdGF0ZTogc3RhdGUKCQkJCX0pOwoJCQl9LCAwKTsKCQl9LAoKCQloYXNoY2hhbmdlOiBmdW5jdGlvbiggZXZlbnQgLyosIGRhdGEgKi8gKSB7CgkJCXZhciBuZXdFdmVudCA9IG5ldyAkLkV2ZW50KCAibmF2aWdhdGUiICksCgkJCQliZWZvcmVOYXZpZ2F0ZSA9IG5ldyAkLkV2ZW50KCAiYmVmb3JlbmF2aWdhdGUiICk7CgoJCQliZWZvcmVOYXZpZ2F0ZS5vcmlnaW5hbEV2ZW50ID0gZXZlbnQ7CgkJCSR3aW4udHJpZ2dlciggYmVmb3JlTmF2aWdhdGUgKTsKCgkJCWlmICggYmVmb3JlTmF2aWdhdGUuaXNEZWZhdWx0UHJldmVudGVkKCkgKXsKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gTWFrZSBzdXJlIHRoZSBvcmlnaW5hbCBldmVudCBpcyB0cmFja2VkIGZvciB0aGUgZW5kCgkJCS8vIHVzZXIgdG8gaW5zcGVjdCBpbmNhc2UgdGhleSB3YW50IHRvIGRvIHNvbWV0aGluZyBzcGVjaWFsCgkJCW5ld0V2ZW50Lm9yaWdpbmFsRXZlbnQgPSBldmVudDsKCgkJCS8vIFRyaWdnZXIgdGhlIGhhc2hjaGFuZ2Ugd2l0aCBzdGF0ZSBwcm92aWRlZCBieSB0aGUgdXNlcgoJCQkvLyB0aGF0IGFsdGVyZWQgdGhlIGhhc2gKCQkJJHdpbi50cmlnZ2VyKCBuZXdFdmVudCwgewoJCQkJLy8gVXNlcnMgdGhhdCB3YW50IHRvIGZ1bGx5IG5vcm1hbGl6ZSB0aGUgdHdvIGV2ZW50cwoJCQkJLy8gd2lsbCBuZWVkIHRvIGRvIGhpc3RvcnkgbWFuYWdlbWVudCBkb3duIHRoZSBzdGFjayBhbmQKCQkJCS8vIGFkZCB0aGUgc3RhdGUgdG8gdGhlIGV2ZW50IGJlZm9yZSB0aGlzIGJpbmRpbmcgaXMgZmlyZWQKCQkJCS8vIFRPRE8gY29uc2lkZXIgYWxsb3dpbmcgZm9yIHRoZSBleHBsaWNpdCBhZGRpdGlvbiBvZiBjYWxsYmFja3MKCQkJCS8vICAgICAgdG8gYmUgZmlyZWQgYmVmb3JlIHRoaXMgdmFsdWUgaXMgc2V0IHRvIGF2b2lkIGV2ZW50IHRpbWluZyBpc3N1ZXMKCQkJCXN0YXRlOiBldmVudC5oYXNoY2hhbmdlU3RhdGUgfHwge30KCQkJfSk7CgkJfSwKCgkJLy8gVE9ETyBXZSByZWFsbHkgb25seSB3YW50IHRvIHNldCB0aGlzIHVwIG9uY2UKCQkvLyAgICAgIGJ1dCBJJ20gbm90IGNsZWFyIGlmIHRoZXJlJ3MgYSBiZXRlciB3YXkgdG8gYWNoaWV2ZQoJCS8vICAgICAgdGhpcyB3aXRoIHRoZSBqUXVlcnkgc3BlY2lhbCBldmVudCBzdHJ1Y3R1cmUKCQlzZXR1cDogZnVuY3Rpb24oIC8qIGRhdGEsIG5hbWVzcGFjZXMgKi8gKSB7CgkJCWlmICggc2VsZi5ib3VuZCApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJc2VsZi5ib3VuZCA9IHRydWU7CgoJCQlpZiAoIHNlbGYuaXNQdXNoU3RhdGVFbmFibGVkKCkgKSB7CgkJCQlzZWxmLm9yaWdpbmFsRXZlbnROYW1lID0gInBvcHN0YXRlIjsKCQkJCSR3aW4uYmluZCggInBvcHN0YXRlLm5hdmlnYXRlIiwgc2VsZi5wb3BzdGF0ZSApOwoJCQl9IGVsc2UgaWYgKCBzZWxmLmlzSGFzaENoYW5nZUVuYWJsZWQoKSApewoJCQkJc2VsZi5vcmlnaW5hbEV2ZW50TmFtZSA9ICJoYXNoY2hhbmdlIjsKCQkJCSR3aW4uYmluZCggImhhc2hjaGFuZ2UubmF2aWdhdGUiLCBzZWxmLmhhc2hjaGFuZ2UgKTsKCQkJfQoJCX0KCX07Cn0pKCBqUXVlcnkgKTsKCgoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgkJdmFyIHBhdGgsICRiYXNlLCBkaWFsb2dIYXNoS2V5ID0gIiZ1aS1zdGF0ZT1kaWFsb2ciOwoKCQkkLm1vYmlsZS5wYXRoID0gcGF0aCA9IHsKCQkJdWlTdGF0ZUtleTogIiZ1aS1zdGF0ZSIsCgoJCQkvLyBUaGlzIHNjYXJ5IGxvb2tpbmcgcmVndWxhciBleHByZXNzaW9uIHBhcnNlcyBhbiBhYnNvbHV0ZSBVUkwgb3IgaXRzIHJlbGF0aXZlCgkJCS8vIHZhcmlhbnRzIChwcm90b2NvbCwgc2l0ZSwgZG9jdW1lbnQsIHF1ZXJ5LCBhbmQgaGFzaCksIGludG8gdGhlIHZhcmlvdXMKCQkJLy8gY29tcG9uZW50cyAocHJvdG9jb2wsIGhvc3QsIHBhdGgsIHF1ZXJ5LCBmcmFnbWVudCwgZXRjIHRoYXQgbWFrZSB1cCB0aGUKCQkJLy8gVVJMIGFzIHdlbGwgYXMgc29tZSBvdGhlciBjb21tb25seSB1c2VkIHN1Yi1wYXJ0cy4gV2hlbiB1c2VkIHdpdGggUmVnRXhwLmV4ZWMoKQoJCQkvLyBvciBTdHJpbmcubWF0Y2gsIGl0IHBhcnNlcyB0aGUgVVJMIGludG8gYSByZXN1bHRzIGFycmF5IHRoYXQgbG9va3MgbGlrZSB0aGlzOgoJCQkvLwoJCQkvLyAgICAgWzBdOiBodHRwOi8vamJsYXM6cGFzc3dvcmRAbXljb21wYW55LmNvbTo4MDgwL21haWwvaW5ib3g/bXNnPTEyMzQmdHlwZT11bnJlYWQjbXNnLWNvbnRlbnQKCQkJLy8gICAgIFsxXTogaHR0cDovL2pibGFzOnBhc3N3b3JkQG15Y29tcGFueS5jb206ODA4MC9tYWlsL2luYm94P21zZz0xMjM0JnR5cGU9dW5yZWFkCgkJCS8vICAgICBbMl06IGh0dHA6Ly9qYmxhczpwYXNzd29yZEBteWNvbXBhbnkuY29tOjgwODAvbWFpbC9pbmJveAoJCQkvLyAgICAgWzNdOiBodHRwOi8vamJsYXM6cGFzc3dvcmRAbXljb21wYW55LmNvbTo4MDgwCgkJCS8vICAgICBbNF06IGh0dHA6CgkJCS8vICAgICBbNV06IC8vCgkJCS8vICAgICBbNl06IGpibGFzOnBhc3N3b3JkQG15Y29tcGFueS5jb206ODA4MAoJCQkvLyAgICAgWzddOiBqYmxhczpwYXNzd29yZAoJCQkvLyAgICAgWzhdOiBqYmxhcwoJCQkvLyAgICAgWzldOiBwYXNzd29yZAoJCQkvLyAgICBbMTBdOiBteWNvbXBhbnkuY29tOjgwODAKCQkJLy8gICAgWzExXTogbXljb21wYW55LmNvbQoJCQkvLyAgICBbMTJdOiA4MDgwCgkJCS8vICAgIFsxM106IC9tYWlsL2luYm94CgkJCS8vICAgIFsxNF06IC9tYWlsLwoJCQkvLyAgICBbMTVdOiBpbmJveAoJCQkvLyAgICBbMTZdOiA/bXNnPTEyMzQmdHlwZT11bnJlYWQKCQkJLy8gICAgWzE3XTogI21zZy1jb250ZW50CgkJCS8vCgkJCXVybFBhcnNlUkU6IC9eXHMqKCgoKFteOlwvI1w/XSs6KT8oPzooXC9cLykoKD86KChbXjpAXC8jXD9dKykoPzpcOihbXjpAXC8jXD9dKykpPylAKT8oKFteOlwvI1w/XF1cW10rfFxbW15cL1xdQCM/XStcXSkoPzpcOihbMC05XSspKT8pKT8pPyk/KChcLz8oPzpbXlwvXD8jXStcLyspKikoW15cPyNdKikpKT8oXD9bXiNdKyk/KSgjLiopPy8sCgoJCQkvLyBBYnN0cmFjdGlvbiB0byBhZGRyZXNzIHhzcyAoSXNzdWUgIzQ3ODcpIGJ5IHJlbW92aW5nIHRoZSBhdXRob3JpdHkgaW4KCQkJLy8gYnJvd3NlcnMgdGhhdCBhdXRvCWRlY29kZSBpdC4gQWxsIHJlZmVyZW5jZXMgdG8gbG9jYXRpb24uaHJlZiBzaG91bGQgYmUKCQkJLy8gcmVwbGFjZWQgd2l0aCBhIGNhbGwgdG8gdGhpcyBtZXRob2Qgc28gdGhhdCBpdCBjYW4gYmUgZGVhbHQgd2l0aCBwcm9wZXJseSBoZXJlCgkJCWdldExvY2F0aW9uOiBmdW5jdGlvbiggdXJsICkgewoJCQkJdmFyIHVyaSA9IHVybCA/IHRoaXMucGFyc2VVcmwoIHVybCApIDogbG9jYXRpb24sCgkJCQkJaGFzaCA9IHRoaXMucGFyc2VVcmwoIHVybCB8fCBsb2NhdGlvbi5ocmVmICkuaGFzaDsKCgkJCQkvLyBtaW1pYyB0aGUgYnJvd3NlciB3aXRoIGFuIGVtcHR5IHN0cmluZyB3aGVuIHRoZSBoYXNoIGlzIGVtcHR5CgkJCQloYXNoID0gaGFzaCA9PT0gIiMiID8gIiIgOiBoYXNoOwoKCQkJCS8vIE1ha2Ugc3VyZSB0byBwYXJzZSB0aGUgdXJsIG9yIHRoZSBsb2NhdGlvbiBvYmplY3QgZm9yIHRoZSBoYXNoIGJlY2F1c2UgdXNpbmcgbG9jYXRpb24uaGFzaAoJCQkJLy8gaXMgYXV0b2RlY29kZWQgaW4gZmlyZWZveCwgdGhlIHJlc3Qgb2YgdGhlIHVybCBzaG91bGQgYmUgZnJvbSB0aGUgb2JqZWN0IChsb2NhdGlvbiB1bmxlc3MKCQkJCS8vIHdlJ3JlIHRlc3RpbmcpIHRvIGF2b2lkIHRoZSBpbmNsdXNpb24gb2YgdGhlIGF1dGhvcml0eQoJCQkJcmV0dXJuIHVyaS5wcm90b2NvbCArICIvLyIgKyB1cmkuaG9zdCArIHVyaS5wYXRobmFtZSArIHVyaS5zZWFyY2ggKyBoYXNoOwoJCQl9LAoKCQkJLy9yZXR1cm4gdGhlIG9yaWdpbmFsIGRvY3VtZW50IHVybAoJCQlnZXREb2N1bWVudFVybDogZnVuY3Rpb24oIGFzUGFyc2VkT2JqZWN0ICkgewoJCQkJcmV0dXJuIGFzUGFyc2VkT2JqZWN0ID8gJC5leHRlbmQoIHt9LCBwYXRoLmRvY3VtZW50VXJsICkgOiBwYXRoLmRvY3VtZW50VXJsLmhyZWY7CgkJCX0sCgoJCQlwYXJzZUxvY2F0aW9uOiBmdW5jdGlvbigpIHsKCQkJCXJldHVybiB0aGlzLnBhcnNlVXJsKCB0aGlzLmdldExvY2F0aW9uKCkgKTsKCQkJfSwKCgkJCS8vUGFyc2UgYSBVUkwgaW50byBhIHN0cnVjdHVyZSB0aGF0IGFsbG93cyBlYXN5IGFjY2VzcyB0bwoJCQkvL2FsbCBvZiB0aGUgVVJMIGNvbXBvbmVudHMgYnkgbmFtZS4KCQkJcGFyc2VVcmw6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQkvLyBJZiB3ZSdyZSBwYXNzZWQgYW4gb2JqZWN0LCB3ZSdsbCBhc3N1bWUgdGhhdCBpdCBpcwoJCQkJLy8gYSBwYXJzZWQgdXJsIG9iamVjdCBhbmQganVzdCByZXR1cm4gaXQgYmFjayB0byB0aGUgY2FsbGVyLgoJCQkJaWYgKCAkLnR5cGUoIHVybCApID09PSAib2JqZWN0IiApIHsKCQkJCQlyZXR1cm4gdXJsOwoJCQkJfQoKCQkJCXZhciBtYXRjaGVzID0gcGF0aC51cmxQYXJzZVJFLmV4ZWMoIHVybCB8fCAiIiApIHx8IFtdOwoKCQkJCQkvLyBDcmVhdGUgYW4gb2JqZWN0IHRoYXQgYWxsb3dzIHRoZSBjYWxsZXIgdG8gYWNjZXNzIHRoZSBzdWItbWF0Y2hlcwoJCQkJCS8vIGJ5IG5hbWUuIE5vdGUgdGhhdCBJRSByZXR1cm5zIGFuIGVtcHR5IHN0cmluZyBpbnN0ZWFkIG9mIHVuZGVmaW5lZCwKCQkJCQkvLyBsaWtlIGFsbCBvdGhlciBicm93c2VycyBkbywgc28gd2Ugbm9ybWFsaXplIGV2ZXJ5dGhpbmcgc28gaXRzIGNvbnNpc3RlbnQKCQkJCQkvLyBubyBtYXR0ZXIgd2hhdCBicm93c2VyIHdlJ3JlIHJ1bm5pbmcgb24uCgkJCQkJcmV0dXJuIHsKCQkJCQkJaHJlZjogICAgICAgICBtYXRjaGVzWyAgMCBdIHx8ICIiLAoJCQkJCQlocmVmTm9IYXNoOiAgIG1hdGNoZXNbICAxIF0gfHwgIiIsCgkJCQkJCWhyZWZOb1NlYXJjaDogbWF0Y2hlc1sgIDIgXSB8fCAiIiwKCQkJCQkJZG9tYWluOiAgICAgICBtYXRjaGVzWyAgMyBdIHx8ICIiLAoJCQkJCQlwcm90b2NvbDogICAgIG1hdGNoZXNbICA0IF0gfHwgIiIsCgkJCQkJCWRvdWJsZVNsYXNoOiAgbWF0Y2hlc1sgIDUgXSB8fCAiIiwKCQkJCQkJYXV0aG9yaXR5OiAgICBtYXRjaGVzWyAgNiBdIHx8ICIiLAoJCQkJCQl1c2VybmFtZTogICAgIG1hdGNoZXNbICA4IF0gfHwgIiIsCgkJCQkJCXBhc3N3b3JkOiAgICAgbWF0Y2hlc1sgIDkgXSB8fCAiIiwKCQkJCQkJaG9zdDogICAgICAgICBtYXRjaGVzWyAxMCBdIHx8ICIiLAoJCQkJCQlob3N0bmFtZTogICAgIG1hdGNoZXNbIDExIF0gfHwgIiIsCgkJCQkJCXBvcnQ6ICAgICAgICAgbWF0Y2hlc1sgMTIgXSB8fCAiIiwKCQkJCQkJcGF0aG5hbWU6ICAgICBtYXRjaGVzWyAxMyBdIHx8ICIiLAoJCQkJCQlkaXJlY3Rvcnk6ICAgIG1hdGNoZXNbIDE0IF0gfHwgIiIsCgkJCQkJCWZpbGVuYW1lOiAgICAgbWF0Y2hlc1sgMTUgXSB8fCAiIiwKCQkJCQkJc2VhcmNoOiAgICAgICBtYXRjaGVzWyAxNiBdIHx8ICIiLAoJCQkJCQloYXNoOiAgICAgICAgIG1hdGNoZXNbIDE3IF0gfHwgIiIKCQkJCQl9OwoJCQl9LAoKCQkJLy9UdXJuIHJlbFBhdGggaW50byBhbiBhc2JvbHV0ZSBwYXRoLiBhYnNQYXRoIGlzCgkJCS8vYW4gb3B0aW9uYWwgYWJzb2x1dGUgcGF0aCB3aGljaCBkZXNjcmliZXMgd2hhdAoJCQkvL3JlbFBhdGggaXMgcmVsYXRpdmUgdG8uCgkJCW1ha2VQYXRoQWJzb2x1dGU6IGZ1bmN0aW9uKCByZWxQYXRoLCBhYnNQYXRoICkgewoJCQkJdmFyIGFic1N0YWNrLAoJCQkJCXJlbFN0YWNrLAoJCQkJCWksIGQ7CgoJCQkJaWYgKCByZWxQYXRoICYmIHJlbFBhdGguY2hhckF0KCAwICkgPT09ICIvIiApIHsKCQkJCQlyZXR1cm4gcmVsUGF0aDsKCQkJCX0KCgkJCQlyZWxQYXRoID0gcmVsUGF0aCB8fCAiIjsKCQkJCWFic1BhdGggPSBhYnNQYXRoID8gYWJzUGF0aC5yZXBsYWNlKCAvXlwvfChcL1teXC9dKnxbXlwvXSspJC9nLCAiIiApIDogIiI7CgoJCQkJYWJzU3RhY2sgPSBhYnNQYXRoID8gYWJzUGF0aC5zcGxpdCggIi8iICkgOiBbXTsKCQkJCXJlbFN0YWNrID0gcmVsUGF0aC5zcGxpdCggIi8iICk7CgoJCQkJZm9yICggaSA9IDA7IGkgPCByZWxTdGFjay5sZW5ndGg7IGkrKyApIHsKCQkJCQlkID0gcmVsU3RhY2tbIGkgXTsKCQkJCQlzd2l0Y2ggKCBkICkgewoJCQkJCQljYXNlICIuIjoKCQkJCQkJCWJyZWFrOwoJCQkJCQljYXNlICIuLiI6CgkJCQkJCQlpZiAoIGFic1N0YWNrLmxlbmd0aCApIHsKCQkJCQkJCQlhYnNTdGFjay5wb3AoKTsKCQkJCQkJCX0KCQkJCQkJCWJyZWFrOwoJCQkJCQlkZWZhdWx0OgoJCQkJCQkJYWJzU3RhY2sucHVzaCggZCApOwoJCQkJCQkJYnJlYWs7CgkJCQkJfQoJCQkJfQoJCQkJcmV0dXJuICIvIiArIGFic1N0YWNrLmpvaW4oICIvIiApOwoJCQl9LAoKCQkJLy9SZXR1cm5zIHRydWUgaWYgYm90aCB1cmxzIGhhdmUgdGhlIHNhbWUgZG9tYWluLgoJCQlpc1NhbWVEb21haW46IGZ1bmN0aW9uKCBhYnNVcmwxLCBhYnNVcmwyICkgewoJCQkJcmV0dXJuIHBhdGgucGFyc2VVcmwoIGFic1VybDEgKS5kb21haW4gPT09IHBhdGgucGFyc2VVcmwoIGFic1VybDIgKS5kb21haW47CgkJCX0sCgoJCQkvL1JldHVybnMgdHJ1ZSBmb3IgYW55IHJlbGF0aXZlIHZhcmlhbnQuCgkJCWlzUmVsYXRpdmVVcmw6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQkvLyBBbGwgcmVsYXRpdmUgVXJsIHZhcmlhbnRzIGhhdmUgb25lIHRoaW5nIGluIGNvbW1vbiwgbm8gcHJvdG9jb2wuCgkJCQlyZXR1cm4gcGF0aC5wYXJzZVVybCggdXJsICkucHJvdG9jb2wgPT09ICIiOwoJCQl9LAoKCQkJLy9SZXR1cm5zIHRydWUgZm9yIGFuIGFic29sdXRlIHVybC4KCQkJaXNBYnNvbHV0ZVVybDogZnVuY3Rpb24oIHVybCApIHsKCQkJCXJldHVybiBwYXRoLnBhcnNlVXJsKCB1cmwgKS5wcm90b2NvbCAhPT0gIiI7CgkJCX0sCgoJCQkvL1R1cm4gdGhlIHNwZWNpZmllZCByZWFsdGl2ZSBVUkwgaW50byBhbiBhYnNvbHV0ZSBvbmUuIFRoaXMgZnVuY3Rpb24KCQkJLy9jYW4gaGFuZGxlIGFsbCByZWxhdGl2ZSB2YXJpYW50cyAocHJvdG9jb2wsIHNpdGUsIGRvY3VtZW50LCBxdWVyeSwgZnJhZ21lbnQpLgoJCQltYWtlVXJsQWJzb2x1dGU6IGZ1bmN0aW9uKCByZWxVcmwsIGFic1VybCApIHsKCQkJCWlmICggIXBhdGguaXNSZWxhdGl2ZVVybCggcmVsVXJsICkgKSB7CgkJCQkJcmV0dXJuIHJlbFVybDsKCQkJCX0KCgkJCQlpZiAoIGFic1VybCA9PT0gdW5kZWZpbmVkICkgewoJCQkJCWFic1VybCA9IHRoaXMuZG9jdW1lbnRCYXNlOwoJCQkJfQoKCQkJCXZhciByZWxPYmogPSBwYXRoLnBhcnNlVXJsKCByZWxVcmwgKSwKCQkJCQlhYnNPYmogPSBwYXRoLnBhcnNlVXJsKCBhYnNVcmwgKSwKCQkJCQlwcm90b2NvbCA9IHJlbE9iai5wcm90b2NvbCB8fCBhYnNPYmoucHJvdG9jb2wsCgkJCQkJZG91YmxlU2xhc2ggPSByZWxPYmoucHJvdG9jb2wgPyByZWxPYmouZG91YmxlU2xhc2ggOiAoIHJlbE9iai5kb3VibGVTbGFzaCB8fCBhYnNPYmouZG91YmxlU2xhc2ggKSwKCQkJCQlhdXRob3JpdHkgPSByZWxPYmouYXV0aG9yaXR5IHx8IGFic09iai5hdXRob3JpdHksCgkJCQkJaGFzUGF0aCA9IHJlbE9iai5wYXRobmFtZSAhPT0gIiIsCgkJCQkJcGF0aG5hbWUgPSBwYXRoLm1ha2VQYXRoQWJzb2x1dGUoIHJlbE9iai5wYXRobmFtZSB8fCBhYnNPYmouZmlsZW5hbWUsIGFic09iai5wYXRobmFtZSApLAoJCQkJCXNlYXJjaCA9IHJlbE9iai5zZWFyY2ggfHwgKCAhaGFzUGF0aCAmJiBhYnNPYmouc2VhcmNoICkgfHwgIiIsCgkJCQkJaGFzaCA9IHJlbE9iai5oYXNoOwoKCQkJCXJldHVybiBwcm90b2NvbCArIGRvdWJsZVNsYXNoICsgYXV0aG9yaXR5ICsgcGF0aG5hbWUgKyBzZWFyY2ggKyBoYXNoOwoJCQl9LAoKCQkJLy9BZGQgc2VhcmNoIChha2EgcXVlcnkpIHBhcmFtcyB0byB0aGUgc3BlY2lmaWVkIHVybC4KCQkJYWRkU2VhcmNoUGFyYW1zOiBmdW5jdGlvbiggdXJsLCBwYXJhbXMgKSB7CgkJCQl2YXIgdSA9IHBhdGgucGFyc2VVcmwoIHVybCApLAoJCQkJCXAgPSAoIHR5cGVvZiBwYXJhbXMgPT09ICJvYmplY3QiICkgPyAkLnBhcmFtKCBwYXJhbXMgKSA6IHBhcmFtcywKCQkJCQlzID0gdS5zZWFyY2ggfHwgIj8iOwoJCQkJcmV0dXJuIHUuaHJlZk5vU2VhcmNoICsgcyArICggcy5jaGFyQXQoIHMubGVuZ3RoIC0gMSApICE9PSAiPyIgPyAiJiIgOiAiIiApICsgcCArICggdS5oYXNoIHx8ICIiICk7CgkJCX0sCgoJCQljb252ZXJ0VXJsVG9EYXRhVXJsOiBmdW5jdGlvbiggYWJzVXJsICkgewoJCQkJdmFyIHUgPSBwYXRoLnBhcnNlVXJsKCBhYnNVcmwgKTsKCQkJCWlmICggcGF0aC5pc0VtYmVkZGVkUGFnZSggdSApICkgewoJCQkJCS8vIEZvciBlbWJlZGRlZCBwYWdlcywgcmVtb3ZlIHRoZSBkaWFsb2cgaGFzaCBrZXkgYXMgaW4gZ2V0RmlsZVBhdGgoKSwKCQkJCQkvLyBhbmQgcmVtb3ZlIG90aGVyd2lzZSB0aGUgRGF0YSBVcmwgd29uJ3QgbWF0Y2ggdGhlIGlkIG9mIHRoZSBlbWJlZGRlZCBQYWdlLgoJCQkJCXJldHVybiB1Lmhhc2gKCQkJCQkJLnNwbGl0KCBkaWFsb2dIYXNoS2V5IClbMF0KCQkJCQkJLnJlcGxhY2UoIC9eIy8sICIiICkKCQkJCQkJLnJlcGxhY2UoIC9cPy4qJC8sICIiICk7CgkJCQl9IGVsc2UgaWYgKCBwYXRoLmlzU2FtZURvbWFpbiggdSwgdGhpcy5kb2N1bWVudEJhc2UgKSApIHsKCQkJCQlyZXR1cm4gdS5ocmVmTm9IYXNoLnJlcGxhY2UoIHRoaXMuZG9jdW1lbnRCYXNlLmRvbWFpbiwgIiIgKS5zcGxpdCggZGlhbG9nSGFzaEtleSApWzBdOwoJCQkJfQoKCQkJCXJldHVybiB3aW5kb3cuZGVjb2RlVVJJQ29tcG9uZW50KGFic1VybCk7CgkJCX0sCgoJCQkvL2dldCBwYXRoIGZyb20gY3VycmVudCBoYXNoLCBvciBmcm9tIGEgZmlsZSBwYXRoCgkJCWdldDogZnVuY3Rpb24oIG5ld1BhdGggKSB7CgkJCQlpZiAoIG5ld1BhdGggPT09IHVuZGVmaW5lZCApIHsKCQkJCQluZXdQYXRoID0gcGF0aC5wYXJzZUxvY2F0aW9uKCkuaGFzaDsKCQkJCX0KCQkJCXJldHVybiBwYXRoLnN0cmlwSGFzaCggbmV3UGF0aCApLnJlcGxhY2UoIC9bXlwvXSpcLlteXC8qXSskLywgIiIgKTsKCQkJfSwKCgkJCS8vc2V0IGxvY2F0aW9uIGhhc2ggdG8gcGF0aAoJCQlzZXQ6IGZ1bmN0aW9uKCBwYXRoICkgewoJCQkJbG9jYXRpb24uaGFzaCA9IHBhdGg7CgkJCX0sCgoJCQkvL3Rlc3QgaWYgYSBnaXZlbiB1cmwgKHN0cmluZykgaXMgYSBwYXRoCgkJCS8vTk9URSBtaWdodCBiZSBleGNlcHRpb25hbGx5IG5haXZlCgkJCWlzUGF0aDogZnVuY3Rpb24oIHVybCApIHsKCQkJCXJldHVybiAoIC9cLy8gKS50ZXN0KCB1cmwgKTsKCQkJfSwKCgkJCS8vcmV0dXJuIGEgdXJsIHBhdGggd2l0aCB0aGUgd2luZG93J3MgbG9jYXRpb24gcHJvdG9jb2wvaG9zdG5hbWUvcGF0aG5hbWUgcmVtb3ZlZAoJCQljbGVhbjogZnVuY3Rpb24oIHVybCApIHsKCQkJCXJldHVybiB1cmwucmVwbGFjZSggdGhpcy5kb2N1bWVudEJhc2UuZG9tYWluLCAiIiApOwoJCQl9LAoKCQkJLy9qdXN0IHJldHVybiB0aGUgdXJsIHdpdGhvdXQgYW4gaW5pdGlhbCAjCgkJCXN0cmlwSGFzaDogZnVuY3Rpb24oIHVybCApIHsKCQkJCXJldHVybiB1cmwucmVwbGFjZSggL14jLywgIiIgKTsKCQkJfSwKCgkJCXN0cmlwUXVlcnlQYXJhbXM6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQlyZXR1cm4gdXJsLnJlcGxhY2UoIC9cPy4qJC8sICIiICk7CgkJCX0sCgoJCQkvL3JlbW92ZSB0aGUgcHJlY2VkaW5nIGhhc2gsIGFueSBxdWVyeSBwYXJhbXMsIGFuZCBkaWFsb2cgbm90YXRpb25zCgkJCWNsZWFuSGFzaDogZnVuY3Rpb24oIGhhc2ggKSB7CgkJCQlyZXR1cm4gcGF0aC5zdHJpcEhhc2goIGhhc2gucmVwbGFjZSggL1w/LiokLywgIiIgKS5yZXBsYWNlKCBkaWFsb2dIYXNoS2V5LCAiIiApICk7CgkJCX0sCgoJCQlpc0hhc2hWYWxpZDogZnVuY3Rpb24oIGhhc2ggKSB7CgkJCQlyZXR1cm4gKCAvXiNbXiNdKyQvICkudGVzdCggaGFzaCApOwoJCQl9LAoKCQkJLy9jaGVjayB3aGV0aGVyIGEgdXJsIGlzIHJlZmVyZW5jaW5nIHRoZSBzYW1lIGRvbWFpbiwgb3IgYW4gZXh0ZXJuYWwgZG9tYWluIG9yIGRpZmZlcmVudCBwcm90b2NvbAoJCQkvL2NvdWxkIGJlIG1haWx0bywgZXRjCgkJCWlzRXh0ZXJuYWw6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQl2YXIgdSA9IHBhdGgucGFyc2VVcmwoIHVybCApOwoJCQkJcmV0dXJuIHUucHJvdG9jb2wgJiYgdS5kb21haW4gIT09IHRoaXMuZG9jdW1lbnRVcmwuZG9tYWluID8gdHJ1ZSA6IGZhbHNlOwoJCQl9LAoKCQkJaGFzUHJvdG9jb2w6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQlyZXR1cm4gKCAvXig6P1x3KzopLyApLnRlc3QoIHVybCApOwoJCQl9LAoKCQkJaXNFbWJlZGRlZFBhZ2U6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQl2YXIgdSA9IHBhdGgucGFyc2VVcmwoIHVybCApOwoKCQkJCS8vaWYgdGhlIHBhdGggaXMgYWJzb2x1dGUsIHRoZW4gd2UgbmVlZCB0byBjb21wYXJlIHRoZSB1cmwgYWdhaW5zdAoJCQkJLy9ib3RoIHRoZSB0aGlzLmRvY3VtZW50VXJsIGFuZCB0aGUgZG9jdW1lbnRCYXNlLiBUaGUgbWFpbiByZWFzb24gZm9yIHRoaXMKCQkJCS8vaXMgdGhhdCBsaW5rcyBlbWJlZGRlZCB3aXRoaW4gZXh0ZXJuYWwgZG9jdW1lbnRzIHdpbGwgcmVmZXIgdG8gdGhlCgkJCQkvL2FwcGxpY2F0aW9uIGRvY3VtZW50LCB3aGVyZWFzIGxpbmtzIGVtYmVkZGVkIHdpdGhpbiB0aGUgYXBwbGljYXRpb24KCQkJCS8vZG9jdW1lbnQgd2lsbCBiZSByZXNvbHZlZCBhZ2FpbnN0IHRoZSBkb2N1bWVudCBiYXNlLgoJCQkJaWYgKCB1LnByb3RvY29sICE9PSAiIiApIHsKCQkJCQlyZXR1cm4gKCAhdGhpcy5pc1BhdGgodS5oYXNoKSAmJiB1Lmhhc2ggJiYgKCB1LmhyZWZOb0hhc2ggPT09IHRoaXMuZG9jdW1lbnRVcmwuaHJlZk5vSGFzaCB8fCAoIHRoaXMuZG9jdW1lbnRCYXNlRGlmZmVycyAmJiB1LmhyZWZOb0hhc2ggPT09IHRoaXMuZG9jdW1lbnRCYXNlLmhyZWZOb0hhc2ggKSApICk7CgkJCQl9CgkJCQlyZXR1cm4gKCAvXiMvICkudGVzdCggdS5ocmVmICk7CgkJCX0sCgoJCQlzcXVhc2g6IGZ1bmN0aW9uKCB1cmwsIHJlc29sdXRpb25VcmwgKSB7CgkJCQl2YXIgaHJlZiwgY2xlYW5lZFVybCwgc2VhcmNoLCBzdGF0ZUluZGV4LAoJCQkJCWlzUGF0aCA9IHRoaXMuaXNQYXRoKCB1cmwgKSwKCQkJCQl1cmkgPSB0aGlzLnBhcnNlVXJsKCB1cmwgKSwKCQkJCQlwcmVzZXJ2ZWRIYXNoID0gdXJpLmhhc2gsCgkJCQkJdWlTdGF0ZSA9ICIiOwoKCQkJCS8vIHByb2R1Y2UgYSB1cmwgYWdhaW5zdCB3aGljaCB3ZSBjYW4gcmVzb2xlIHRoZSBwcm92aWRlZCBwYXRoCgkJCQlyZXNvbHV0aW9uVXJsID0gcmVzb2x1dGlvblVybCB8fCAocGF0aC5pc1BhdGgodXJsKSA/IHBhdGguZ2V0TG9jYXRpb24oKSA6IHBhdGguZ2V0RG9jdW1lbnRVcmwoKSk7CgoJCQkJLy8gSWYgdGhlIHVybCBpcyBhbnl0aGluZyBidXQgYSBzaW1wbGUgc3RyaW5nLCByZW1vdmUgYW55IHByZWNlZGluZyBoYXNoCgkJCQkvLyBlZyAjZm9vL2JhciAtPiBmb28vYmFyCgkJCQkvLyAgICAjZm9vIC0+ICNmb28KCQkJCWNsZWFuZWRVcmwgPSBpc1BhdGggPyBwYXRoLnN0cmlwSGFzaCggdXJsICkgOiB1cmw7CgoJCQkJLy8gSWYgdGhlIHVybCBpcyBhIGZ1bGwgdXJsIHdpdGggYSBoYXNoIGNoZWNrIGlmIHRoZSBwYXJzZWQgaGFzaCBpcyBhIHBhdGgKCQkJCS8vIGlmIGl0IGlzLCBzdHJpcCB0aGUgIywgYW5kIHVzZSBpdCBvdGhlcndpc2UgY29udGludWUgd2l0aG91dCBjaGFuZ2UKCQkJCWNsZWFuZWRVcmwgPSBwYXRoLmlzUGF0aCggdXJpLmhhc2ggKSA/IHBhdGguc3RyaXBIYXNoKCB1cmkuaGFzaCApIDogY2xlYW5lZFVybDsKCgkJCQkvLyBTcGxpdCB0aGUgVUkgU3RhdGUga2V5cyBvZmYgdGhlIGhyZWYKCQkJCXN0YXRlSW5kZXggPSBjbGVhbmVkVXJsLmluZGV4T2YoIHRoaXMudWlTdGF0ZUtleSApOwoKCQkJCS8vIHN0b3JlIHRoZSB1aSBzdGF0ZSBrZXlzIGZvciB1c2UKCQkJCWlmICggc3RhdGVJbmRleCA+IC0xICl7CgkJCQkJdWlTdGF0ZSA9IGNsZWFuZWRVcmwuc2xpY2UoIHN0YXRlSW5kZXggKTsKCQkJCQljbGVhbmVkVXJsID0gY2xlYW5lZFVybC5zbGljZSggMCwgc3RhdGVJbmRleCApOwoJCQkJfQoKCQkJCS8vIG1ha2UgdGhlIGNsZWFuZWRVcmwgYWJzb2x1dGUgcmVsYXRpdmUgdG8gdGhlIHJlc29sdXRpb24gdXJsCgkJCQlocmVmID0gcGF0aC5tYWtlVXJsQWJzb2x1dGUoIGNsZWFuZWRVcmwsIHJlc29sdXRpb25VcmwgKTsKCgkJCQkvLyBncmFiIHRoZSBzZWFyY2ggZnJvbSB0aGUgcmVzb2x2ZWQgdXJsIHNpbmNlIHBhcnNpbmcgZnJvbQoJCQkJLy8gdGhlIHBhc3NlZCB1cmwgbWF5IG5vdCB5aWVsZCB0aGUgY29ycmVjdCByZXN1bHQKCQkJCXNlYXJjaCA9IHRoaXMucGFyc2VVcmwoIGhyZWYgKS5zZWFyY2g7CgoJCQkJLy8gVE9ETyBhbGwgdGhpcyBjcmFwIGlzIHRlcnJpYmxlLCBjbGVhbiBpdCB1cAoJCQkJaWYgKCBpc1BhdGggKSB7CgkJCQkJLy8gcmVqZWN0IHRoZSBoYXNoIGlmIGl0J3MgYSBwYXRoIG9yIGl0J3MganVzdCBhIGRpYWxvZyBrZXkKCQkJCQlpZiAoIHBhdGguaXNQYXRoKCBwcmVzZXJ2ZWRIYXNoICkgfHwgcHJlc2VydmVkSGFzaC5yZXBsYWNlKCIjIiwgIiIpLmluZGV4T2YoIHRoaXMudWlTdGF0ZUtleSApID09PSAwKSB7CgkJCQkJCXByZXNlcnZlZEhhc2ggPSAiIjsKCQkJCQl9CgoJCQkJCS8vIEFwcGVuZCB0aGUgVUkgU3RhdGUga2V5cyB3aGVyZSBpdCBleGlzdHMgYW5kIGl0J3MgYmVlbiByZW1vdmVkCgkJCQkJLy8gZnJvbSB0aGUgdXJsCgkJCQkJaWYgKCB1aVN0YXRlICYmIHByZXNlcnZlZEhhc2guaW5kZXhPZiggdGhpcy51aVN0YXRlS2V5ICkgPT09IC0xKXsKCQkJCQkJcHJlc2VydmVkSGFzaCArPSB1aVN0YXRlOwoJCQkJCX0KCgkJCQkJLy8gbWFrZSBzdXJlIHRoYXQgcG91bmQgaXMgb24gdGhlIGZyb250IG9mIHRoZSBoYXNoCgkJCQkJaWYgKCBwcmVzZXJ2ZWRIYXNoLmluZGV4T2YoICIjIiApID09PSAtMSAmJiBwcmVzZXJ2ZWRIYXNoICE9PSAiIiApewoJCQkJCQlwcmVzZXJ2ZWRIYXNoID0gIiMiICsgcHJlc2VydmVkSGFzaDsKCQkJCQl9CgoJCQkJCS8vIHJlY29uc3RydWN0IGVhY2ggb2YgdGhlIHBpZWNlcyB3aXRoIHRoZSBuZXcgc2VhcmNoIHN0cmluZyBhbmQgaGFzaAoJCQkJCWhyZWYgPSBwYXRoLnBhcnNlVXJsKCBocmVmICk7CgkJCQkJaHJlZiA9IGhyZWYucHJvdG9jb2wgKyAiLy8iICsgaHJlZi5ob3N0ICsgaHJlZi5wYXRobmFtZSArIHNlYXJjaCArIHByZXNlcnZlZEhhc2g7CgkJCQl9IGVsc2UgewoJCQkJCWhyZWYgKz0gaHJlZi5pbmRleE9mKCAiIyIgKSA+IC0xID8gdWlTdGF0ZSA6ICIjIiArIHVpU3RhdGU7CgkJCQl9CgoJCQkJcmV0dXJuIGhyZWY7CgkJCX0sCgoJCQlpc1ByZXNlcnZhYmxlSGFzaDogZnVuY3Rpb24oIGhhc2ggKSB7CgkJCQlyZXR1cm4gaGFzaC5yZXBsYWNlKCAiIyIsICIiICkuaW5kZXhPZiggdGhpcy51aVN0YXRlS2V5ICkgPT09IDA7CgkJCX0sCgoJCQkvLyBFc2NhcGUgd2VpcmQgY2hhcmFjdGVycyBpbiB0aGUgaGFzaCBpZiBpdCBpcyB0byBiZSB1c2VkIGFzIGEgc2VsZWN0b3IKCQkJaGFzaFRvU2VsZWN0b3I6IGZ1bmN0aW9uKCBoYXNoICkgewoJCQkJdmFyIGhhc0hhc2ggPSAoIGhhc2guc3Vic3RyaW5nKCAwLCAxICkgPT09ICIjIiApOwoJCQkJaWYgKCBoYXNIYXNoICkgewoJCQkJCWhhc2ggPSBoYXNoLnN1YnN0cmluZyggMSApOwoJCQkJfQoJCQkJcmV0dXJuICggaGFzSGFzaCA/ICIjIiA6ICIiICkgKyBoYXNoLnJlcGxhY2UoIC8oWyEiIyQlJicoKSorLC4vOjs8PT4/QFtcXV5ge3x9fl0pL2csICJcXCQxIiApOwoJCQl9LAoKCQkJLy8gcmV0dXJuIHRoZSBzdWJzdHJpbmcgb2YgYSBmaWxlcGF0aCBiZWZvcmUgdGhlIHN1Yi1wYWdlIGtleSwgZm9yIG1ha2luZwoJCQkvLyBhIHNlcnZlciByZXF1ZXN0CgkJCWdldEZpbGVQYXRoOiBmdW5jdGlvbiggcGF0aCApIHsKCQkJCXZhciBzcGxpdGtleSA9ICImIiArICQubW9iaWxlLnN1YlBhZ2VVcmxLZXk7CgkJCQlyZXR1cm4gcGF0aCAmJiBwYXRoLnNwbGl0KCBzcGxpdGtleSApWzBdLnNwbGl0KCBkaWFsb2dIYXNoS2V5IClbMF07CgkJCX0sCgoJCQkvLyBjaGVjayBpZiB0aGUgc3BlY2lmaWVkIHVybCByZWZlcnMgdG8gdGhlIGZpcnN0IHBhZ2UgaW4gdGhlIG1haW4KCQkJLy8gYXBwbGljYXRpb24gZG9jdW1lbnQuCgkJCWlzRmlyc3RQYWdlVXJsOiBmdW5jdGlvbiggdXJsICkgewoJCQkJLy8gV2Ugb25seSBkZWFsIHdpdGggYWJzb2x1dGUgcGF0aHMuCgkJCQl2YXIgdSA9IHBhdGgucGFyc2VVcmwoIHBhdGgubWFrZVVybEFic29sdXRlKCB1cmwsIHRoaXMuZG9jdW1lbnRCYXNlICkgKSwKCgkJCQkJLy8gRG9lcyB0aGUgdXJsIGhhdmUgdGhlIHNhbWUgcGF0aCBhcyB0aGUgZG9jdW1lbnQ/CgkJCQkJc2FtZVBhdGggPSB1LmhyZWZOb0hhc2ggPT09IHRoaXMuZG9jdW1lbnRVcmwuaHJlZk5vSGFzaCB8fAoJCQkJCQkoIHRoaXMuZG9jdW1lbnRCYXNlRGlmZmVycyAmJgoJCQkJCQkJdS5ocmVmTm9IYXNoID09PSB0aGlzLmRvY3VtZW50QmFzZS5ocmVmTm9IYXNoICksCgoJCQkJCS8vIEdldCB0aGUgZmlyc3QgcGFnZSBlbGVtZW50LgoJCQkJCWZwID0gJC5tb2JpbGUuZmlyc3RQYWdlLAoKCQkJCQkvLyBHZXQgdGhlIGlkIG9mIHRoZSBmaXJzdCBwYWdlIGVsZW1lbnQgaWYgaXQgaGFzIG9uZS4KCQkJCQlmcElkID0gZnAgJiYgZnBbMF0gPyBmcFswXS5pZCA6IHVuZGVmaW5lZDsKCgkJCQkvLyBUaGUgdXJsIHJlZmVycyB0byB0aGUgZmlyc3QgcGFnZSBpZiB0aGUgcGF0aCBtYXRjaGVzIHRoZSBkb2N1bWVudCBhbmQKCQkJCS8vIGl0IGVpdGhlciBoYXMgbm8gaGFzaCB2YWx1ZSwgb3IgdGhlIGhhc2ggaXMgZXhhY3RseSBlcXVhbCB0byB0aGUgaWQKCQkJCS8vIG9mIHRoZSBmaXJzdCBwYWdlIGVsZW1lbnQuCgkJCQlyZXR1cm4gc2FtZVBhdGggJiYKCQkJCQkoICF1Lmhhc2ggfHwKCQkJCQkJdS5oYXNoID09PSAiIyIgfHwKCQkJCQkJKCBmcElkICYmIHUuaGFzaC5yZXBsYWNlKCAvXiMvLCAiIiApID09PSBmcElkICkgKTsKCQkJfSwKCgkJCS8vIFNvbWUgZW1iZWRkZWQgYnJvd3NlcnMsIGxpa2UgdGhlIHdlYiB2aWV3IGluIFBob25lIEdhcCwgYWxsb3cKCQkJLy8gY3Jvc3MtZG9tYWluIFhIUiByZXF1ZXN0cyBpZiB0aGUgZG9jdW1lbnQgZG9pbmcgdGhlIHJlcXVlc3Qgd2FzIGxvYWRlZAoJCQkvLyB2aWEgdGhlIGZpbGU6Ly8gcHJvdG9jb2wuIFRoaXMgaXMgdXN1YWxseSB0byBhbGxvdyB0aGUgYXBwbGljYXRpb24gdG8KCQkJLy8gInBob25lIGhvbWUiIGFuZCBmZXRjaCBhcHAgc3BlY2lmaWMgZGF0YS4gV2Ugbm9ybWFsbHkgbGV0IHRoZSBicm93c2VyCgkJCS8vIGhhbmRsZSBleHRlcm5hbC9jcm9zcy1kb21haW4gdXJscywgYnV0IGlmIHRoZSBhbGxvd0Nyb3NzRG9tYWluUGFnZXMKCQkJLy8gb3B0aW9uIGlzIHRydWUsIHdlIHdpbGwgYWxsb3cgY3Jvc3MtZG9tYWluIGh0dHAvaHR0cHMgcmVxdWVzdHMgdG8gZ28KCQkJLy8gdGhyb3VnaCBvdXIgcGFnZSBsb2FkaW5nIGxvZ2ljLgoJCQlpc1Blcm1pdHRlZENyb3NzRG9tYWluUmVxdWVzdDogZnVuY3Rpb24oIGRvY1VybCwgcmVxVXJsICkgewoJCQkJcmV0dXJuICQubW9iaWxlLmFsbG93Q3Jvc3NEb21haW5QYWdlcyAmJgoJCQkJCShkb2NVcmwucHJvdG9jb2wgPT09ICJmaWxlOiIgfHwgZG9jVXJsLnByb3RvY29sID09PSAiY29udGVudDoiKSAmJgoJCQkJCXJlcVVybC5zZWFyY2goIC9eaHR0cHM/Oi8gKSAhPT0gLTE7CgkJCX0KCQl9OwoKCQlwYXRoLmRvY3VtZW50VXJsID0gcGF0aC5wYXJzZUxvY2F0aW9uKCk7CgoJCSRiYXNlID0gJCggImhlYWQiICkuZmluZCggImJhc2UiICk7CgoJCXBhdGguZG9jdW1lbnRCYXNlID0gJGJhc2UubGVuZ3RoID8KCQkJcGF0aC5wYXJzZVVybCggcGF0aC5tYWtlVXJsQWJzb2x1dGUoICRiYXNlLmF0dHIoICJocmVmIiApLCBwYXRoLmRvY3VtZW50VXJsLmhyZWYgKSApIDoKCQkJcGF0aC5kb2N1bWVudFVybDsKCgkJcGF0aC5kb2N1bWVudEJhc2VEaWZmZXJzID0gKHBhdGguZG9jdW1lbnRVcmwuaHJlZk5vSGFzaCAhPT0gcGF0aC5kb2N1bWVudEJhc2UuaHJlZk5vSGFzaCk7CgoJCS8vcmV0dXJuIHRoZSBvcmlnaW5hbCBkb2N1bWVudCBiYXNlIHVybAoJCXBhdGguZ2V0RG9jdW1lbnRCYXNlID0gZnVuY3Rpb24oIGFzUGFyc2VkT2JqZWN0ICkgewoJCQlyZXR1cm4gYXNQYXJzZWRPYmplY3QgPyAkLmV4dGVuZCgge30sIHBhdGguZG9jdW1lbnRCYXNlICkgOiBwYXRoLmRvY3VtZW50QmFzZS5ocmVmOwoJCX07CgoJCS8vIERFUFJFQ0FURUQgYXMgb2YgMS40LjAgLSByZW1vdmUgaW4gMS41LjAKCQkkLmV4dGVuZCggJC5tb2JpbGUsIHsKCgkJCS8vcmV0dXJuIHRoZSBvcmlnaW5hbCBkb2N1bWVudCB1cmwKCQkJZ2V0RG9jdW1lbnRVcmw6IHBhdGguZ2V0RG9jdW1lbnRVcmwsCgoJCQkvL3JldHVybiB0aGUgb3JpZ2luYWwgZG9jdW1lbnQgYmFzZSB1cmwKCQkJZ2V0RG9jdW1lbnRCYXNlOiBwYXRoLmdldERvY3VtZW50QmFzZQoJCX0pOwp9KSggalF1ZXJ5ICk7CgoKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoJJC5tb2JpbGUuSGlzdG9yeSA9IGZ1bmN0aW9uKCBzdGFjaywgaW5kZXggKSB7CgkJdGhpcy5zdGFjayA9IHN0YWNrIHx8IFtdOwoJCXRoaXMuYWN0aXZlSW5kZXggPSBpbmRleCB8fCAwOwoJfTsKCgkkLmV4dGVuZCgkLm1vYmlsZS5IaXN0b3J5LnByb3RvdHlwZSwgewoJCWdldEFjdGl2ZTogZnVuY3Rpb24oKSB7CgkJCXJldHVybiB0aGlzLnN0YWNrWyB0aGlzLmFjdGl2ZUluZGV4IF07CgkJfSwKCgkJZ2V0TGFzdDogZnVuY3Rpb24oKSB7CgkJCXJldHVybiB0aGlzLnN0YWNrWyB0aGlzLnByZXZpb3VzSW5kZXggXTsKCQl9LAoKCQlnZXROZXh0OiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHRoaXMuc3RhY2tbIHRoaXMuYWN0aXZlSW5kZXggKyAxIF07CgkJfSwKCgkJZ2V0UHJldjogZnVuY3Rpb24oKSB7CgkJCXJldHVybiB0aGlzLnN0YWNrWyB0aGlzLmFjdGl2ZUluZGV4IC0gMSBdOwoJCX0sCgoJCS8vIGFkZE5ldyBpcyB1c2VkIHdoZW5ldmVyIGEgbmV3IHBhZ2UgaXMgYWRkZWQKCQlhZGQ6IGZ1bmN0aW9uKCB1cmwsIGRhdGEgKXsKCQkJZGF0YSA9IGRhdGEgfHwge307CgoJCQkvL2lmIHRoZXJlJ3MgZm9yd2FyZCBoaXN0b3J5LCB3aXBlIGl0CgkJCWlmICggdGhpcy5nZXROZXh0KCkgKSB7CgkJCQl0aGlzLmNsZWFyRm9yd2FyZCgpOwoJCQl9CgoJCQkvLyBpZiB0aGUgaGFzaCBpcyBpbmNsdWRlZCBpbiB0aGUgZGF0YSBtYWtlIHN1cmUgdGhlIHNoYXBlCgkJCS8vIGlzIGNvbnNpc3RlbnQgZm9yIGNvbXBhcmlzb24KCQkJaWYgKCBkYXRhLmhhc2ggJiYgZGF0YS5oYXNoLmluZGV4T2YoICIjIiApID09PSAtMSkgewoJCQkJZGF0YS5oYXNoID0gIiMiICsgZGF0YS5oYXNoOwoJCQl9CgoJCQlkYXRhLnVybCA9IHVybDsKCQkJdGhpcy5zdGFjay5wdXNoKCBkYXRhICk7CgkJCXRoaXMuYWN0aXZlSW5kZXggPSB0aGlzLnN0YWNrLmxlbmd0aCAtIDE7CgkJfSwKCgkJLy93aXBlIHVybHMgYWhlYWQgb2YgYWN0aXZlIGluZGV4CgkJY2xlYXJGb3J3YXJkOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5zdGFjayA9IHRoaXMuc3RhY2suc2xpY2UoIDAsIHRoaXMuYWN0aXZlSW5kZXggKyAxICk7CgkJfSwKCgkJZmluZDogZnVuY3Rpb24oIHVybCwgc3RhY2ssIGVhcmx5UmV0dXJuICkgewoJCQlzdGFjayA9IHN0YWNrIHx8IHRoaXMuc3RhY2s7CgoJCQl2YXIgZW50cnksIGksIGxlbmd0aCA9IHN0YWNrLmxlbmd0aCwgaW5kZXg7CgoJCQlmb3IgKCBpID0gMDsgaSA8IGxlbmd0aDsgaSsrICkgewoJCQkJZW50cnkgPSBzdGFja1tpXTsKCgkJCQlpZiAoIGRlY29kZVVSSUNvbXBvbmVudCh1cmwpID09PSBkZWNvZGVVUklDb21wb25lbnQoZW50cnkudXJsKSB8fAoJCQkJCWRlY29kZVVSSUNvbXBvbmVudCh1cmwpID09PSBkZWNvZGVVUklDb21wb25lbnQoZW50cnkuaGFzaCkgKSB7CgkJCQkJaW5kZXggPSBpOwoKCQkJCQlpZiAoIGVhcmx5UmV0dXJuICkgewoJCQkJCQlyZXR1cm4gaW5kZXg7CgkJCQkJfQoJCQkJfQoJCQl9CgoJCQlyZXR1cm4gaW5kZXg7CgkJfSwKCgkJY2xvc2VzdDogZnVuY3Rpb24oIHVybCApIHsKCQkJdmFyIGNsb3Nlc3QsIGEgPSB0aGlzLmFjdGl2ZUluZGV4OwoKCQkJLy8gRmlyc3QsIHRha2UgdGhlIHNsaWNlIG9mIHRoZSBoaXN0b3J5IHN0YWNrIGJlZm9yZSB0aGUgY3VycmVudCBpbmRleCBhbmQgc2VhcmNoCgkJCS8vIGZvciBhIHVybCBtYXRjaC4gSWYgb25lIGlzIGZvdW5kLCB3ZSdsbCBhdm9pZCBhdm9pZCBsb29raW5nIHRocm91Z2ggZm9yd2FyZCBoaXN0b3J5CgkJCS8vIE5PVEUgdGhlIHByZWZlcmVuY2UgZm9yIGJhY2t3YXJkIGhpc3RvcnkgbW92ZW1lbnQgaXMgZHJpdmVuIGJ5IHRoZSBmYWN0IHRoYXQKCQkJLy8gICAgICBtb3N0IG1vYmlsZSBicm93c2VycyBvbmx5IGhhdmUgYSBkZWRpY2F0ZWQgYmFjayBidXR0b24sIGFuZCB1c2VycyByYXJlbHkgdXNlCgkJCS8vICAgICAgdGhlIGZvcndhcmQgYnV0dG9uIGluIGRlc2t0b3AgYnJvd3NlciBhbnlob3cKCQkJY2xvc2VzdCA9IHRoaXMuZmluZCggdXJsLCB0aGlzLnN0YWNrLnNsaWNlKDAsIGEpICk7CgoJCQkvLyBJZiBub3RoaW5nIHdhcyBmb3VuZCBpbiBiYWNrd2FyZCBoaXN0b3J5IGNoZWNrIGZvcndhcmQuIFRoZSBgdHJ1ZWAKCQkJLy8gdmFsdWUgcGFzc2VkIGFzIHRoZSB0aGlyZCBwYXJhbWV0ZXIgY2F1c2VzIHRoZSBmaW5kIG1ldGhvZCB0byBicmVhawoJCQkvLyBvbiB0aGUgZmlyc3QgbWF0Y2ggaW4gdGhlIGZvcndhcmQgaGlzdG9yeSBzbGljZS4gVGhlIHN0YXJ0aW5nIGluZGV4CgkJCS8vIG9mIHRoZSBzbGljZSBtdXN0IHRoZW4gYmUgYWRkZWQgdG8gdGhlIHJlc3VsdCB0byBnZXQgdGhlIGVsZW1lbnQgaW5kZXgKCQkJLy8gaW4gdGhlIG9yaWdpbmFsIGhpc3Rvcnkgc3RhY2sgOiggOigKCQkJLy8KCQkJLy8gVE9ETyB0aGlzIGlzIGh5cGVyIGNvbmZ1c2luZyBhbmQgc2hvdWxkIGJlIGNsZWFuZWQgdXAgKHVnaCBzbyBiYWQpCgkJCWlmICggY2xvc2VzdCA9PT0gdW5kZWZpbmVkICkgewoJCQkJY2xvc2VzdCA9IHRoaXMuZmluZCggdXJsLCB0aGlzLnN0YWNrLnNsaWNlKGEpLCB0cnVlICk7CgkJCQljbG9zZXN0ID0gY2xvc2VzdCA9PT0gdW5kZWZpbmVkID8gY2xvc2VzdCA6IGNsb3Nlc3QgKyBhOwoJCQl9CgoJCQlyZXR1cm4gY2xvc2VzdDsKCQl9LAoKCQlkaXJlY3Q6IGZ1bmN0aW9uKCBvcHRzICkgewoJCQl2YXIgbmV3QWN0aXZlSW5kZXggPSB0aGlzLmNsb3Nlc3QoIG9wdHMudXJsICksIGEgPSB0aGlzLmFjdGl2ZUluZGV4OwoKCQkJLy8gc2F2ZSBuZXcgcGFnZSBpbmRleCwgbnVsbCBjaGVjayB0byBwcmV2ZW50IGZhbHNleSAwIHJlc3VsdAoJCQkvLyByZWNvcmQgdGhlIHByZXZpb3VzIGluZGV4IGZvciByZWZlcmVuY2UKCQkJaWYgKCBuZXdBY3RpdmVJbmRleCAhPT0gdW5kZWZpbmVkICkgewoJCQkJdGhpcy5hY3RpdmVJbmRleCA9IG5ld0FjdGl2ZUluZGV4OwoJCQkJdGhpcy5wcmV2aW91c0luZGV4ID0gYTsKCQkJfQoKCQkJLy8gaW52b2tlIGNhbGxiYWNrcyB3aGVyZSBhcHByb3ByaWF0ZQoJCQkvLwoJCQkvLyBUT0RPIHRoaXMgaXMgYWxzbyBjb252b2x1dGVkIGFuZCBjb25mdXNpbmcKCQkJaWYgKCBuZXdBY3RpdmVJbmRleCA8IGEgKSB7CgkJCQkoIG9wdHMucHJlc2VudCB8fCBvcHRzLmJhY2sgfHwgJC5ub29wICkoIHRoaXMuZ2V0QWN0aXZlKCksICJiYWNrIiApOwoJCQl9IGVsc2UgaWYgKCBuZXdBY3RpdmVJbmRleCA+IGEgKSB7CgkJCQkoIG9wdHMucHJlc2VudCB8fCBvcHRzLmZvcndhcmQgfHwgJC5ub29wICkoIHRoaXMuZ2V0QWN0aXZlKCksICJmb3J3YXJkIiApOwoJCQl9IGVsc2UgaWYgKCBuZXdBY3RpdmVJbmRleCA9PT0gdW5kZWZpbmVkICYmIG9wdHMubWlzc2luZyApewoJCQkJb3B0cy5taXNzaW5nKCB0aGlzLmdldEFjdGl2ZSgpICk7CgkJCX0KCQl9Cgl9KTsKfSkoIGpRdWVyeSApOwoKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoJdmFyIHBhdGggPSAkLm1vYmlsZS5wYXRoLAoJCWluaXRpYWxIcmVmID0gbG9jYXRpb24uaHJlZjsKCgkkLm1vYmlsZS5OYXZpZ2F0b3IgPSBmdW5jdGlvbiggaGlzdG9yeSApIHsKCQl0aGlzLmhpc3RvcnkgPSBoaXN0b3J5OwoJCXRoaXMuaWdub3JlSW5pdGlhbEhhc2hDaGFuZ2UgPSB0cnVlOwoKCQkkLm1vYmlsZS53aW5kb3cuYmluZCh7CgkJCSJwb3BzdGF0ZS5oaXN0b3J5IjogJC5wcm94eSggdGhpcy5wb3BzdGF0ZSwgdGhpcyApLAoJCQkiaGFzaGNoYW5nZS5oaXN0b3J5IjogJC5wcm94eSggdGhpcy5oYXNoY2hhbmdlLCB0aGlzICkKCQl9KTsKCX07CgoJJC5leHRlbmQoJC5tb2JpbGUuTmF2aWdhdG9yLnByb3RvdHlwZSwgewoJCXNxdWFzaDogZnVuY3Rpb24oIHVybCwgZGF0YSApIHsKCQkJdmFyIHN0YXRlLCBocmVmLCBoYXNoID0gcGF0aC5pc1BhdGgodXJsKSA/IHBhdGguc3RyaXBIYXNoKHVybCkgOiB1cmw7CgoJCQlocmVmID0gcGF0aC5zcXVhc2goIHVybCApOwoKCQkJLy8gbWFrZSBzdXJlIHRvIHByb3ZpZGUgdGhpcyBpbmZvcm1hdGlvbiB3aGVuIGl0IGlzbid0IGV4cGxpY2l0bHkgc2V0IGluIHRoZQoJCQkvLyBkYXRhIG9iamVjdCB0aGF0IHdhcyBwYXNzZWQgdG8gdGhlIHNxdWFzaCBtZXRob2QKCQkJc3RhdGUgPSAkLmV4dGVuZCh7CgkJCQloYXNoOiBoYXNoLAoJCQkJdXJsOiBocmVmCgkJCX0sIGRhdGEpOwoKCQkJLy8gcmVwbGFjZSB0aGUgY3VycmVudCB1cmwgd2l0aCB0aGUgbmV3IGhyZWYgYW5kIHN0b3JlIHRoZSBzdGF0ZQoJCQkvLyBOb3RlIHRoYXQgaW4gc29tZSBjYXNlcyB3ZSBtaWdodCBiZSByZXBsYWNpbmcgYW4gdXJsIHdpdGggdGhlCgkJCS8vIHNhbWUgdXJsLiBXZSBkbyB0aGlzIGFueXdheXMgYmVjYXVzZSB3ZSBuZWVkIHRvIG1ha2Ugc3VyZSB0aGF0CgkJCS8vIGFsbCBvZiBvdXIgaGlzdG9yeSBlbnRyaWVzIGhhdmUgYSBzdGF0ZSBvYmplY3QgYXNzb2NpYXRlZCB3aXRoCgkJCS8vIHRoZW0uIFRoaXMgYWxsb3dzIHVzIHRvIHdvcmsgYXJvdW5kIHRoZSBjYXNlIHdoZXJlICQubW9iaWxlLmJhY2soKQoJCQkvLyBpcyBjYWxsZWQgdG8gdHJhbnNpdGlvbiBmcm9tIGFuIGV4dGVybmFsIHBhZ2UgdG8gYW4gZW1iZWRkZWQgcGFnZS4KCQkJLy8gSW4gdGhhdCBwYXJ0aWN1bGFyIGNhc2UsIGEgaGFzaGNoYW5nZSBldmVudCBpcyAqTk9UKiBnZW5lcmF0ZWQgYnkgdGhlIGJyb3dzZXIuCgkJCS8vIEVuc3VyaW5nIGVhY2ggaGlzdG9yeSBlbnRyeSBoYXMgYSBzdGF0ZSBvYmplY3QgbWVhbnMgdGhhdCBvblBvcFN0YXRlKCkKCQkJLy8gd2lsbCBhbHdheXMgdHJpZ2dlciBvdXIgaGFzaGNoYW5nZSBjYWxsYmFjayBldmVuIHdoZW4gYSBoYXNoY2hhbmdlIGV2ZW50CgkJCS8vIGlzIG5vdCBmaXJlZC4KCQkJd2luZG93Lmhpc3RvcnkucmVwbGFjZVN0YXRlKCBzdGF0ZSwgc3RhdGUudGl0bGUgfHwgZG9jdW1lbnQudGl0bGUsIGhyZWYgKTsKCgkJCXJldHVybiBzdGF0ZTsKCQl9LAoKCQloYXNoOiBmdW5jdGlvbiggdXJsLCBocmVmICkgewoJCQl2YXIgcGFyc2VkLCBsb2MsIGhhc2gsIHJlc29sdmVkOwoKCQkJLy8gR3JhYiB0aGUgaGFzaCBmb3IgcmVjb3JkaW5nLiBJZiB0aGUgcGFzc2VkIHVybCBpcyBhIHBhdGgKCQkJLy8gd2UgdXNlZCB0aGUgcGFyc2VkIHZlcnNpb24gb2YgdGhlIHNxdWFzaGVkIHVybCB0byByZWNvbnN0cnVjdCwKCQkJLy8gb3RoZXJ3aXNlIHdlIGFzc3VtZSBpdCdzIGEgaGFzaCBhbmQgc3RvcmUgaXQgZGlyZWN0bHkKCQkJcGFyc2VkID0gcGF0aC5wYXJzZVVybCggdXJsICk7CgkJCWxvYyA9IHBhdGgucGFyc2VMb2NhdGlvbigpOwoKCQkJaWYgKCBsb2MucGF0aG5hbWUgKyBsb2Muc2VhcmNoID09PSBwYXJzZWQucGF0aG5hbWUgKyBwYXJzZWQuc2VhcmNoICkgewoJCQkJLy8gSWYgdGhlIHBhdGhuYW1lIGFuZCBzZWFyY2ggb2YgdGhlIHBhc3NlZCB1cmwgaXMgaWRlbnRpY2FsIHRvIHRoZSBjdXJyZW50IGxvYwoJCQkJLy8gdGhlbiB3ZSBtdXN0IHVzZSB0aGUgaGFzaC4gT3RoZXJ3aXNlIHRoZXJlIHdpbGwgYmUgbm8gZXZlbnQKCQkJCS8vIGVnLCB1cmwgPSAiL2Zvby9iYXI/YmF6I2JhbmciLCBsb2NhdGlvbi5ocmVmID0gImh0dHA6Ly9leGFtcGxlLmNvbS9mb28vYmFyP2JheiIKCQkJCWhhc2ggPSBwYXJzZWQuaGFzaCA/IHBhcnNlZC5oYXNoIDogcGFyc2VkLnBhdGhuYW1lICsgcGFyc2VkLnNlYXJjaDsKCQkJfSBlbHNlIGlmICggcGF0aC5pc1BhdGgodXJsKSApIHsKCQkJCXJlc29sdmVkID0gcGF0aC5wYXJzZVVybCggaHJlZiApOwoJCQkJLy8gSWYgdGhlIHBhc3NlZCB1cmwgaXMgYSBwYXRoLCBtYWtlIGl0IGRvbWFpbiByZWxhdGl2ZSBhbmQgcmVtb3ZlIGFueSB0cmFpbGluZyBoYXNoCgkJCQloYXNoID0gcmVzb2x2ZWQucGF0aG5hbWUgKyByZXNvbHZlZC5zZWFyY2ggKyAocGF0aC5pc1ByZXNlcnZhYmxlSGFzaCggcmVzb2x2ZWQuaGFzaCApPyByZXNvbHZlZC5oYXNoLnJlcGxhY2UoICIjIiwgIiIgKSA6ICIiKTsKCQkJfSBlbHNlIHsKCQkJCWhhc2ggPSB1cmw7CgkJCX0KCgkJCXJldHVybiBoYXNoOwoJCX0sCgoJCS8vIFRPRE8gcmVjb25zaWRlciBuYW1lCgkJZ286IGZ1bmN0aW9uKCB1cmwsIGRhdGEsIG5vRXZlbnRzICkgewoJCQl2YXIgc3RhdGUsIGhyZWYsIGhhc2gsIHBvcHN0YXRlRXZlbnQsCgkJCQlpc1BvcFN0YXRlRXZlbnQgPSAkLmV2ZW50LnNwZWNpYWwubmF2aWdhdGUuaXNQdXNoU3RhdGVFbmFibGVkKCk7CgoJCQkvLyBHZXQgdGhlIHVybCBhcyBpdCB3b3VsZCBsb29rIHNxdWFzaGVkIG9uIHRvIHRoZSBjdXJyZW50IHJlc29sdXRpb24gdXJsCgkJCWhyZWYgPSBwYXRoLnNxdWFzaCggdXJsICk7CgoJCQkvLyBzb3J0IG91dCB3aGF0IHRoZSBoYXNoIHNvdWxkIGJlIGZyb20gdGhlIHVybAoJCQloYXNoID0gdGhpcy5oYXNoKCB1cmwsIGhyZWYgKTsKCgkJCS8vIEhlcmUgd2UgcHJldmVudCB0aGUgbmV4dCBoYXNoIGNoYW5nZSBvciBwb3BzdGF0ZSBldmVudCBmcm9tIGRvaW5nIGFueQoJCQkvLyBoaXN0b3J5IG1hbmFnZW1lbnQuIEluIHRoZSBjYXNlIG9mIGhhc2hjaGFuZ2Ugd2UgZG9uJ3Qgc3dhbGxvdyBpdAoJCQkvLyBpZiB0aGVyZSB3aWxsIGJlIG5vIGhhc2hjaGFuZ2UgZmlyZWQgKHNpbmNlIHRoYXQgd29uJ3QgcmVzZXQgdGhlIHZhbHVlKQoJCQkvLyBhbmQgd2lsbCBzd2FsbG93IHRoZSBmb2xsb3dpbmcgaGFzaGNoYW5nZQoJCQlpZiAoIG5vRXZlbnRzICYmIGhhc2ggIT09IHBhdGguc3RyaXBIYXNoKHBhdGgucGFyc2VMb2NhdGlvbigpLmhhc2gpICkgewoJCQkJdGhpcy5wcmV2ZW50TmV4dEhhc2hDaGFuZ2UgPSBub0V2ZW50czsKCQkJfQoKCQkJLy8gSU1QT1JUQU5UIGluIHRoZSBjYXNlIHdoZXJlIHBvcHN0YXRlIGlzIHN1cHBvcnRlZCB0aGUgZXZlbnQgd2lsbCBiZSB0cmlnZ2VyZWQKCQkJLy8gICAgICBkaXJlY3RseSwgc3RvcHBpbmcgZnVydGhlciBleGVjdXRpb24gLSBpZSwgaW50ZXJ1cHRpbmcgdGhlIGZsb3cgb2YgdGhpcwoJCQkvLyAgICAgIG1ldGhvZCBjYWxsIHRvIGZpcmUgYmluZGluZ3MgYXQgdGhpcyBleHByZXNzaW9uLiBCZWxvdyB0aGUgbmF2aWdhdGUgbWV0aG9kCgkJCS8vICAgICAgdGhlcmUgaXMgYSBiaW5kaW5nIHRvIGNhdGNoIHRoaXMgZXZlbnQgYW5kIHN0b3AgaXRzIHByb3BhZ2F0aW9uLgoJCQkvLwoJCQkvLyAgICAgIFdlIHRoZW4gdHJpZ2dlciBhIG5ldyBwb3BzdGF0ZSBldmVudCBvbiB0aGUgd2luZG93IHdpdGggYSBudWxsIHN0YXRlCgkJCS8vICAgICAgc28gdGhhdCB0aGUgbmF2aWdhdGUgZXZlbnRzIGNhbiBjb25jbHVkZSB0aGVpciB3b3JrIHByb3Blcmx5CgkJCS8vCgkJCS8vIGlmIHRoZSB1cmwgaXMgYSBwYXRoIHdlIHdhbnQgdG8gcHJlc2VydmUgdGhlIHF1ZXJ5IHBhcmFtcyB0aGF0IGFyZSBhdmFpbGFibGUgb24KCQkJLy8gdGhlIGN1cnJlbnQgdXJsLgoJCQl0aGlzLnByZXZlbnRIYXNoQXNzaWduUG9wU3RhdGUgPSB0cnVlOwoJCQl3aW5kb3cubG9jYXRpb24uaGFzaCA9IGhhc2g7CgoJCQkvLyBJZiBwb3BzdGF0ZSBpcyBlbmFibGVkIGFuZCB0aGUgYnJvd3NlciB0cmlnZ2VycyBgcG9wc3RhdGVgIGV2ZW50cyB3aGVuIHRoZSBoYXNoCgkJCS8vIGlzIHNldCAodGhpcyBvZnRlbiBoYXBwZW5zIGltbWVkaWF0ZWx5IGluIGJyb3dzZXJzIGxpa2UgQ2hyb21lKSwgdGhlbiB0aGUKCQkJLy8gdGhpcyBmbGFnIHdpbGwgYmUgc2V0IHRvIGZhbHNlIGFscmVhZHkuIElmIGl0J3MgYSBicm93c2VyIHRoYXQgZG9lcyBub3QgdHJpZ2dlcgoJCQkvLyBhIGBwb3BzdGF0ZWAgb24gaGFzaCBhc3NpZ25lbWVudCBvciBgcmVwbGFjZVN0YXRlYCB0aGVuIHdlIG5lZWQgYXZvaWQgdGhlIGJyYW5jaAoJCQkvLyB0aGF0IHN3YWxsb3dzIHRoZSBldmVudCBjcmVhdGVkIGJ5IHRoZSBwb3BzdGF0ZSBnZW5lcmF0ZWQgYnkgdGhlIGhhc2ggYXNzaWdubWVudAoJCQkvLyBBdCB0aGUgdGltZSBvZiB0aGlzIHdyaXRpbmcgdGhpcyBoYXBwZW5zIHdpdGggT3BlcmEgMTIgYW5kIHNvbWUgdmVyc2lvbiBvZiBJRQoJCQl0aGlzLnByZXZlbnRIYXNoQXNzaWduUG9wU3RhdGUgPSBmYWxzZTsKCgkJCXN0YXRlID0gJC5leHRlbmQoewoJCQkJdXJsOiBocmVmLAoJCQkJaGFzaDogaGFzaCwKCQkJCXRpdGxlOiBkb2N1bWVudC50aXRsZQoJCQl9LCBkYXRhKTsKCgkJCWlmICggaXNQb3BTdGF0ZUV2ZW50ICkgewoJCQkJcG9wc3RhdGVFdmVudCA9IG5ldyAkLkV2ZW50KCAicG9wc3RhdGUiICk7CgkJCQlwb3BzdGF0ZUV2ZW50Lm9yaWdpbmFsRXZlbnQgPSB7CgkJCQkJdHlwZTogInBvcHN0YXRlIiwKCQkJCQlzdGF0ZTogbnVsbAoJCQkJfTsKCgkJCQl0aGlzLnNxdWFzaCggdXJsLCBzdGF0ZSApOwoKCQkJCS8vIFRyaWdnZXIgYSBuZXcgZmF1eCBwb3BzdGF0ZSBldmVudCB0byByZXBsYWNlIHRoZSBvbmUgdGhhdCB3ZQoJCQkJLy8gY2F1Z2h0IHRoYXQgd2FzIHRyaWdnZXJlZCBieSB0aGUgaGFzaCBzZXR0aW5nIGFib3ZlLgoJCQkJaWYgKCAhbm9FdmVudHMgKSB7CgkJCQkJdGhpcy5pZ25vcmVQb3BTdGF0ZSA9IHRydWU7CgkJCQkJJC5tb2JpbGUud2luZG93LnRyaWdnZXIoIHBvcHN0YXRlRXZlbnQgKTsKCQkJCX0KCQkJfQoKCQkJLy8gcmVjb3JkIHRoZSBoaXN0b3J5IGVudHJ5IHNvIHRoYXQgdGhlIGluZm9ybWF0aW9uIGNhbiBiZSBpbmNsdWRlZAoJCQkvLyBpbiBoYXNoY2hhbmdlIGV2ZW50IGRyaXZlbiBuYXZpZ2F0ZSBldmVudHMgaW4gYSBzaW1pbGFyIGZhc2hpb24gdG8KCQkJLy8gdGhlIHN0YXRlIHRoYXQncyBwcm92aWRlZCBieSBwb3BzdGF0ZQoJCQl0aGlzLmhpc3RvcnkuYWRkKCBzdGF0ZS51cmwsIHN0YXRlICk7CgkJfSwKCgoJCS8vIFRoaXMgYmluZGluZyBpcyBpbnRlbmRlZCB0byBjYXRjaCB0aGUgcG9wc3RhdGUgZXZlbnRzIHRoYXQgYXJlIGZpcmVkCgkJLy8gd2hlbiBleGVjdXRpb24gb2YgdGhlIGAkLm5hdmlnYXRlYCBtZXRob2Qgc3RvcHMgYXQgd2luZG93LmxvY2F0aW9uLmhhc2ggPSB1cmw7CgkJLy8gYW5kIGNvbXBsZXRlbHkgcHJldmVudCB0aGVtIGZyb20gcHJvcGFnYXRpbmcuIFRoZSBwb3BzdGF0ZSBldmVudCB3aWxsIHRoZW4gYmUKCQkvLyByZXRyaWdnZXJlZCBhZnRlciBleGVjdXRpb24gcmVzdW1lcwoJCS8vCgkJLy8gVE9ETyBncmFiIHRoZSBvcmlnaW5hbCBldmVudCBoZXJlIGFuZCB1c2UgaXQgZm9yIHRoZSBzeW50aGV0aWMgZXZlbnQgaW4gdGhlCgkJLy8gICAgICBzZWNvbmQgaGFsZiBvZiB0aGUgbmF2aWdhdGUgZXhlY3V0aW9uIHRoYXQgd2lsbCBmb2xsb3cgdGhpcyBiaW5kaW5nCgkJcG9wc3RhdGU6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdmFyIGhhc2gsIHN0YXRlOwoKCQkJLy8gUGFydGx5IHRvIHN1cHBvcnQgb3VyIHRlc3Qgc3VpdGUgd2hpY2ggbWFudWFsbHkgYWx0ZXJzIHRoZSBzdXBwb3J0CgkJCS8vIHZhbHVlIHRvIHRlc3QgaGFzaGNoYW5nZS4gUGFydGx5IHRvIHByZXZlbnQgYWxsIGFyb3VuZCB3ZWlyZG5lc3MKCQkJaWYgKCAhJC5ldmVudC5zcGVjaWFsLm5hdmlnYXRlLmlzUHVzaFN0YXRlRW5hYmxlZCgpICl7CgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIElmIHRoaXMgaXMgdGhlIHBvcHN0YXRlIHRyaWdnZXJlZCBieSB0aGUgYWN0dWFsIGFsdGVyYXRpb24gb2YgdGhlIGhhc2gKCQkJLy8gcHJldmVudCBpdCBjb21wbGV0ZWx5LiBIaXN0b3J5IGlzIHRyYWNrZWQgbWFudWFsbHkKCQkJaWYgKCB0aGlzLnByZXZlbnRIYXNoQXNzaWduUG9wU3RhdGUgKSB7CgkJCQl0aGlzLnByZXZlbnRIYXNoQXNzaWduUG9wU3RhdGUgPSBmYWxzZTsKCQkJCWV2ZW50LnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbigpOwoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBpZiB0aGlzIGlzIHRoZSBwb3BzdGF0ZSB0cmlnZ2VyZWQgYWZ0ZXIgdGhlIGByZXBsYWNlU3RhdGVgIGNhbGwgaW4gdGhlIGdvCgkJCS8vIG1ldGhvZCwgdGhlbiBzaW1wbHkgaWdub3JlIGl0LiBUaGUgaGlzdG9yeSBlbnRyeSBoYXMgYWxyZWFkeSBiZWVuIGNhcHR1cmVkCgkJCWlmICggdGhpcy5pZ25vcmVQb3BTdGF0ZSApIHsKCQkJCXRoaXMuaWdub3JlUG9wU3RhdGUgPSBmYWxzZTsKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gSWYgdGhlcmUgaXMgbm8gc3RhdGUsIGFuZCB0aGUgaGlzdG9yeSBzdGFjayBsZW5ndGggaXMgb25lIHdlcmUKCQkJLy8gcHJvYmFibHkgZ2V0dGluZyB0aGUgcGFnZSBsb2FkIHBvcHN0YXRlIGZpcmVkIGJ5IGJyb3dzZXJzIGxpa2UgY2hyb21lCgkJCS8vIGF2b2lkIGl0IGFuZCBzZXQgdGhlIG9uZSB0aW1lIGZsYWcgdG8gZmFsc2UuCgkJCS8vIFRPRE86IERvIHdlIHJlYWxseSBuZWVkIGFsbCB0aGVzZSBjb25kaXRpb25zPyBDb21wYXJpbmcgbG9jYXRpb24gaHJlZnMKCQkJLy8gc2hvdWxkIGJlIHN1ZmZpY2llbnQuCgkJCWlmICggIWV2ZW50Lm9yaWdpbmFsRXZlbnQuc3RhdGUgJiYKCQkJCXRoaXMuaGlzdG9yeS5zdGFjay5sZW5ndGggPT09IDEgJiYKCQkJCXRoaXMuaWdub3JlSW5pdGlhbEhhc2hDaGFuZ2UgKSB7CgkJCQl0aGlzLmlnbm9yZUluaXRpYWxIYXNoQ2hhbmdlID0gZmFsc2U7CgoJCQkJaWYgKCBsb2NhdGlvbi5ocmVmID09PSBpbml0aWFsSHJlZiApIHsKCQkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJCXJldHVybjsKCQkJCX0KCQkJfQoKCQkJLy8gYWNjb3VudCBmb3IgZGlyZWN0IG1hbmlwdWxhdGlvbiBvZiB0aGUgaGFzaC4gVGhhdCBpcywgd2Ugd2lsbCByZWNlaXZlIGEgcG9wc3RhdGUKCQkJLy8gd2hlbiB0aGUgaGFzaCBpcyBjaGFuZ2VkIGJ5IGFzc2lnbm1lbnQsIGFuZCBpdCB3b24ndCBoYXZlIGEgc3RhdGUgYXNzb2NpYXRlZC4gV2UKCQkJLy8gdGhlbiBuZWVkIHRvIHNxdWFzaCB0aGUgaGFzaC4gU2VlIGJlbG93IGZvciBoYW5kbGluZyBvZiBoYXNoIGFzc2lnbm1lbnQgdGhhdAoJCQkvLyBtYXRjaGVzIGFuIGV4aXN0aW5nIGhpc3RvcnkgZW50cnkKCQkJLy8gVE9ETyBpdCBtaWdodCBiZSBiZXR0ZXIgdG8gb25seSBhZGQgdG8gdGhlIGhpc3Rvcnkgc3RhY2sKCQkJLy8gICAgICB3aGVuIHRoZSBoYXNoIGlzIGFkamFjZW50IHRvIHRoZSBhY3RpdmUgaGlzdG9yeSBlbnRyeQoJCQloYXNoID0gcGF0aC5wYXJzZUxvY2F0aW9uKCkuaGFzaDsKCQkJaWYgKCAhZXZlbnQub3JpZ2luYWxFdmVudC5zdGF0ZSAmJiBoYXNoICkgewoJCQkJLy8gc3F1YXNoIHRoZSBoYXNoIHRoYXQncyBiZWVuIGFzc2lnbmVkIG9uIHRoZSBVUkwgd2l0aCByZXBsYWNlU3RhdGUKCQkJCS8vIGFsc28gZ3JhYiB0aGUgcmVzdWx0aW5nIHN0YXRlIG9iamVjdCBmb3Igc3RvcmFnZQoJCQkJc3RhdGUgPSB0aGlzLnNxdWFzaCggaGFzaCApOwoKCQkJCS8vIHJlY29yZCB0aGUgbmV3IGhhc2ggYXMgYW4gYWRkaXRpb25hbCBoaXN0b3J5IGVudHJ5CgkJCQkvLyB0byBtYXRjaCB0aGUgYnJvd3NlcidzIHRyZWF0bWVudCBvZiBoYXNoIGFzc2lnbm1lbnQKCQkJCXRoaXMuaGlzdG9yeS5hZGQoIHN0YXRlLnVybCwgc3RhdGUgKTsKCgkJCQkvLyBwYXNzIHRoZSBuZXdseSBjcmVhdGVkIHN0YXRlIGluZm9ybWF0aW9uCgkJCQkvLyBhbG9uZyB3aXRoIHRoZSBldmVudAoJCQkJZXZlbnQuaGlzdG9yeVN0YXRlID0gc3RhdGU7CgoJCQkJLy8gZG8gbm90IGFsdGVyIGhpc3RvcnksIHdlJ3ZlIGFkZGVkIGEgbmV3IGhpc3RvcnkgZW50cnkKCQkJCS8vIHNvIHdlIGtub3cgd2hlcmUgd2UgYXJlCgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIElmIGFsbCBlbHNlIGZhaWxzIHRoaXMgaXMgYSBwb3BzdGF0ZSB0aGF0IGNvbWVzIGZyb20gdGhlIGJhY2sgb3IgZm9yd2FyZCBidXR0b25zCgkJCS8vIG1ha2Ugc3VyZSB0byBzZXQgdGhlIHN0YXRlIG9mIG91ciBoaXN0b3J5IHN0YWNrIHByb3Blcmx5LCBhbmQgcmVjb3JkIHRoZSBkaXJlY3Rpb25hbGl0eQoJCQl0aGlzLmhpc3RvcnkuZGlyZWN0KHsKCQkJCXVybDogKGV2ZW50Lm9yaWdpbmFsRXZlbnQuc3RhdGUgfHwge30pLnVybCB8fCBoYXNoLAoKCQkJCS8vIFdoZW4gdGhlIHVybCBpcyBlaXRoZXIgZm9yd2FyZCBvciBiYWNrd2FyZCBpbiBoaXN0b3J5IGluY2x1ZGUgdGhlIGVudHJ5CgkJCQkvLyBhcyBkYXRhIG9uIHRoZSBldmVudCBvYmplY3QgZm9yIG1lcmdpbmcgYXMgZGF0YSBpbiB0aGUgbmF2aWdhdGUgZXZlbnQKCQkJCXByZXNlbnQ6IGZ1bmN0aW9uKCBoaXN0b3J5RW50cnksIGRpcmVjdGlvbiApIHsKCQkJCQkvLyBtYWtlIHN1cmUgdG8gY3JlYXRlIGEgbmV3IG9iamVjdCB0byBwYXNzIGRvd24gYXMgdGhlIG5hdmlnYXRlIGV2ZW50IGRhdGEKCQkJCQlldmVudC5oaXN0b3J5U3RhdGUgPSAkLmV4dGVuZCh7fSwgaGlzdG9yeUVudHJ5KTsKCQkJCQlldmVudC5oaXN0b3J5U3RhdGUuZGlyZWN0aW9uID0gZGlyZWN0aW9uOwoJCQkJfQoJCQl9KTsKCQl9LAoKCQkvLyBOT1RFIG11c3QgYmluZCBiZWZvcmUgYG5hdmlnYXRlYCBzcGVjaWFsIGV2ZW50IGhhc2hjaGFuZ2UgYmluZGluZyBvdGhlcndpc2UgdGhlCgkJLy8gICAgICBuYXZpZ2F0aW9uIGRhdGEgd29uJ3QgYmUgYXR0YWNoZWQgdG8gdGhlIGhhc2hjaGFuZ2UgZXZlbnQgaW4gdGltZSBmb3IgdGhvc2UKCQkvLyAgICAgIGJpbmRpbmdzIHRvIGF0dGFjaCBpdCB0byB0aGUgYG5hdmlnYXRlYCBzcGVjaWFsIGV2ZW50CgkJLy8gVE9ETyBhZGQgYSBjaGVjayBoZXJlIHRoYXQgYGhhc2hjaGFuZ2UubmF2aWdhdGVgIGlzIGJvdW5kIGFscmVhZHkgb3RoZXJ3aXNlIGl0J3MKCQkvLyAgICAgIGJyb2tlbiAoZXhjZXB0aW9uPykKCQloYXNoY2hhbmdlOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciBoaXN0b3J5LCBoYXNoOwoKCQkJLy8gSWYgaGFzaGNoYW5nZSBsaXN0ZW5pbmcgaXMgZXhwbGljaXRseSBkaXNhYmxlZCBvciBwdXNoc3RhdGUgaXMgc3VwcG9ydGVkCgkJCS8vIGF2b2lkIG1ha2luZyB1c2Ugb2YgdGhlIGhhc2hjaGFuZ2UgaGFuZGxlci4KCQkJaWYgKCEkLmV2ZW50LnNwZWNpYWwubmF2aWdhdGUuaXNIYXNoQ2hhbmdlRW5hYmxlZCgpIHx8CgkJCQkkLmV2ZW50LnNwZWNpYWwubmF2aWdhdGUuaXNQdXNoU3RhdGVFbmFibGVkKCkgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIE9uIG9jY2FzaW9uIGV4cGxpY2l0bHkgd2FudCB0byBwcmV2ZW50IHRoZSBuZXh0IGhhc2ggZnJvbSBwcm9wb2dhdGluZyBiZWNhdXNlIHdlIG9ubHkKCQkJLy8gd2l0aCB0byBhbHRlciB0aGUgdXJsIHRvIHJlcHJlc2VudCB0aGUgbmV3IHN0YXRlIGRvIHNvIGhlcmUKCQkJaWYgKCB0aGlzLnByZXZlbnROZXh0SGFzaENoYW5nZSApewoJCQkJdGhpcy5wcmV2ZW50TmV4dEhhc2hDaGFuZ2UgPSBmYWxzZTsKCQkJCWV2ZW50LnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbigpOwoJCQkJcmV0dXJuOwoJCQl9CgoJCQloaXN0b3J5ID0gdGhpcy5oaXN0b3J5OwoJCQloYXNoID0gcGF0aC5wYXJzZUxvY2F0aW9uKCkuaGFzaDsKCgkJCS8vIElmIHRoaXMgaXMgYSBoYXNoY2hhbmdlIGNhdXNlZCBieSB0aGUgYmFjayBvciBmb3J3YXJkIGJ1dHRvbgoJCQkvLyBtYWtlIHN1cmUgdG8gc2V0IHRoZSBzdGF0ZSBvZiBvdXIgaGlzdG9yeSBzdGFjayBwcm9wZXJseQoJCQl0aGlzLmhpc3RvcnkuZGlyZWN0KHsKCQkJCXVybDogaGFzaCwKCgkJCQkvLyBXaGVuIHRoZSB1cmwgaXMgZWl0aGVyIGZvcndhcmQgb3IgYmFja3dhcmQgaW4gaGlzdG9yeSBpbmNsdWRlIHRoZSBlbnRyeQoJCQkJLy8gYXMgZGF0YSBvbiB0aGUgZXZlbnQgb2JqZWN0IGZvciBtZXJnaW5nIGFzIGRhdGEgaW4gdGhlIG5hdmlnYXRlIGV2ZW50CgkJCQlwcmVzZW50OiBmdW5jdGlvbiggaGlzdG9yeUVudHJ5LCBkaXJlY3Rpb24gKSB7CgkJCQkJLy8gbWFrZSBzdXJlIHRvIGNyZWF0ZSBhIG5ldyBvYmplY3QgdG8gcGFzcyBkb3duIGFzIHRoZSBuYXZpZ2F0ZSBldmVudCBkYXRhCgkJCQkJZXZlbnQuaGFzaGNoYW5nZVN0YXRlID0gJC5leHRlbmQoe30sIGhpc3RvcnlFbnRyeSk7CgkJCQkJZXZlbnQuaGFzaGNoYW5nZVN0YXRlLmRpcmVjdGlvbiA9IGRpcmVjdGlvbjsKCQkJCX0sCgoJCQkJLy8gV2hlbiB3ZSBkb24ndCBmaW5kIGEgaGFzaCBpbiBvdXIgaGlzdG9yeSBjbGVhcmx5IHdlJ3JlIGFpbWluZyB0byBnbyB0aGVyZQoJCQkJLy8gcmVjb3JkIHRoZSBlbnRyeSBhcyBuZXcgZm9yIGZ1dHVyZSB0cmF2ZXJzYWwKCQkJCS8vCgkJCQkvLyBOT1RFIGl0J3Mgbm90IGVudGlyZWx5IGNsZWFyIHRoYXQgdGhpcyBpcyB0aGUgcmlnaHQgdGhpbmcgdG8gZG8gZ2l2ZW4gdGhhdCB3ZQoJCQkJLy8gICAgICBjYW4ndCBrbm93IHRoZSB1c2VycyBpbnRlbnRpb24uIEl0IG1pZ2h0IGJlIGJldHRlciB0byBleHBsaWNpdGx5IF9ub3RfCgkJCQkvLyAgICAgIHN1cHBvcnQgbG9jYXRpb24uaGFzaCBhc3NpZ25tZW50IGluIHByZWZlcmVuY2UgdG8gJC5uYXZpZ2F0ZSBjYWxscwoJCQkJLy8gVE9ETyBmaXJzdCBhcmcgdG8gYWRkIHNob3VsZCBiZSB0aGUgaHJlZiwgYnV0IGl0IGNhdXNlcyBpc3N1ZXMgaW4gaWRlbnRpZnlpbmcKCQkJCS8vICAgICAgZW1iZWRlZCBwYWdlcwoJCQkJbWlzc2luZzogZnVuY3Rpb24oKSB7CgkJCQkJaGlzdG9yeS5hZGQoIGhhc2gsIHsKCQkJCQkJaGFzaDogaGFzaCwKCQkJCQkJdGl0bGU6IGRvY3VtZW50LnRpdGxlCgkJCQkJfSk7CgkJCQl9CgkJCX0pOwoJCX0KCX0pOwp9KSggalF1ZXJ5ICk7CgoKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoJLy8gVE9ETyBjb25zaWRlciBxdWV1ZWluZyBuYXZpZ2F0aW9uIGFjdGl2aXR5IHVudGlsIHByZXZpb3VzIGFjdGl2aXRpZXMgaGF2ZSBjb21wbGV0ZWQKCS8vICAgICAgc28gdGhhdCBlbmQgdXNlcnMgZG9uJ3QgaGF2ZSB0byB0aGluayBhYm91dCBpdC4gUHVudGluZyBmb3Igbm93CgkvLyBUT0RPICEhIG1vdmUgdGhlIGV2ZW50IGJpbmRpbmdzIGludG8gY2FsbGJhY2tzIG9uIHRoZSBuYXZpZ2F0ZSBldmVudAoJJC5tb2JpbGUubmF2aWdhdGUgPSBmdW5jdGlvbiggdXJsLCBkYXRhLCBub0V2ZW50cyApIHsKCQkkLm1vYmlsZS5uYXZpZ2F0ZS5uYXZpZ2F0b3IuZ28oIHVybCwgZGF0YSwgbm9FdmVudHMgKTsKCX07CgoJLy8gZXhwb3NlIHRoZSBoaXN0b3J5IG9uIHRoZSBuYXZpZ2F0ZSBtZXRob2QgaW4gYW50aWNpcGF0aW9uIG9mIGZ1bGwgaW50ZWdyYXRpb24gd2l0aAoJLy8gZXhpc3RpbmcgbmF2aWdhdGlvbiBmdW5jdGlvbmFsdHkgdGhhdCBpcyB0aWdodGx5IGNvdXBsZWQgdG8gdGhlIGhpc3RvcnkgaW5mb3JtYXRpb24KCSQubW9iaWxlLm5hdmlnYXRlLmhpc3RvcnkgPSBuZXcgJC5tb2JpbGUuSGlzdG9yeSgpOwoKCS8vIGluc3RhbnRpYXRlIGFuIGluc3RhbmNlIG9mIHRoZSBuYXZpZ2F0b3IgZm9yIHVzZSB3aXRoaW4gdGhlICQubmF2aWdhdGUgbWV0aG9kCgkkLm1vYmlsZS5uYXZpZ2F0ZS5uYXZpZ2F0b3IgPSBuZXcgJC5tb2JpbGUuTmF2aWdhdG9yKCAkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5ICk7CgoJdmFyIGxvYyA9ICQubW9iaWxlLnBhdGgucGFyc2VMb2NhdGlvbigpOwoJJC5tb2JpbGUubmF2aWdhdGUuaGlzdG9yeS5hZGQoIGxvYy5ocmVmLCB7aGFzaDogbG9jLmhhc2h9ICk7Cn0pKCBqUXVlcnkgKTsKCgovLyBUaGlzIHBsdWdpbiBpcyBhbiBleHBlcmltZW50IGZvciBhYnN0cmFjdGluZyBhd2F5IHRoZSB0b3VjaCBhbmQgbW91c2UKLy8gZXZlbnRzIHNvIHRoYXQgZGV2ZWxvcGVycyBkb24ndCBoYXZlIHRvIHdvcnJ5IGFib3V0IHdoaWNoIG1ldGhvZCBvZiBpbnB1dAovLyB0aGUgZGV2aWNlIHRoZWlyIGRvY3VtZW50IGlzIGxvYWRlZCBvbiBzdXBwb3J0cy4KLy8KLy8gVGhlIGlkZWEgaGVyZSBpcyB0byBhbGxvdyB0aGUgZGV2ZWxvcGVyIHRvIHJlZ2lzdGVyIGxpc3RlbmVycyBmb3IgdGhlCi8vIGJhc2ljIG1vdXNlIGV2ZW50cywgc3VjaCBhcyBtb3VzZWRvd24sIG1vdXNlbW92ZSwgbW91c2V1cCwgYW5kIGNsaWNrLAovLyBhbmQgdGhlIHBsdWdpbiB3aWxsIHRha2UgY2FyZSBvZiByZWdpc3RlcmluZyB0aGUgY29ycmVjdCBsaXN0ZW5lcnMKLy8gYmVoaW5kIHRoZSBzY2VuZXMgdG8gaW52b2tlIHRoZSBsaXN0ZW5lciBhdCB0aGUgZmFzdGVzdCBwb3NzaWJsZSB0aW1lCi8vIGZvciB0aGF0IGRldmljZSwgd2hpbGUgc3RpbGwgcmV0YWluaW5nIHRoZSBvcmRlciBvZiBldmVudCBmaXJpbmcgaW4KLy8gdGhlIHRyYWRpdGlvbmFsIG1vdXNlIGVudmlyb25tZW50LCBzaG91bGQgbXVsdGlwbGUgaGFuZGxlcnMgYmUgcmVnaXN0ZXJlZAovLyBvbiB0aGUgc2FtZSBlbGVtZW50IGZvciBkaWZmZXJlbnQgZXZlbnRzLgovLwovLyBUaGUgY3VycmVudCB2ZXJzaW9uIGV4cG9zZXMgdGhlIGZvbGxvd2luZyB2aXJ0dWFsIGV2ZW50cyB0byBqUXVlcnkgYmluZCBtZXRob2RzOgovLyAidm1vdXNlb3ZlciB2bW91c2Vkb3duIHZtb3VzZW1vdmUgdm1vdXNldXAgdmNsaWNrIHZtb3VzZW91dCB2bW91c2VjYW5jZWwiCgooZnVuY3Rpb24oICQsIHdpbmRvdywgZG9jdW1lbnQsIHVuZGVmaW5lZCApIHsKCnZhciBkYXRhUHJvcGVydHlOYW1lID0gInZpcnR1YWxNb3VzZUJpbmRpbmdzIiwKCXRvdWNoVGFyZ2V0UHJvcGVydHlOYW1lID0gInZpcnR1YWxUb3VjaElEIiwKCXZpcnR1YWxFdmVudE5hbWVzID0gInZtb3VzZW92ZXIgdm1vdXNlZG93biB2bW91c2Vtb3ZlIHZtb3VzZXVwIHZjbGljayB2bW91c2VvdXQgdm1vdXNlY2FuY2VsIi5zcGxpdCggIiAiICksCgl0b3VjaEV2ZW50UHJvcHMgPSAiY2xpZW50WCBjbGllbnRZIHBhZ2VYIHBhZ2VZIHNjcmVlblggc2NyZWVuWSIuc3BsaXQoICIgIiApLAoJbW91c2VIb29rUHJvcHMgPSAkLmV2ZW50Lm1vdXNlSG9va3MgPyAkLmV2ZW50Lm1vdXNlSG9va3MucHJvcHMgOiBbXSwKCW1vdXNlRXZlbnRQcm9wcyA9ICQuZXZlbnQucHJvcHMuY29uY2F0KCBtb3VzZUhvb2tQcm9wcyApLAoJYWN0aXZlRG9jSGFuZGxlcnMgPSB7fSwKCXJlc2V0VGltZXJJRCA9IDAsCglzdGFydFggPSAwLAoJc3RhcnRZID0gMCwKCWRpZFNjcm9sbCA9IGZhbHNlLAoJY2xpY2tCbG9ja0xpc3QgPSBbXSwKCWJsb2NrTW91c2VUcmlnZ2VycyA9IGZhbHNlLAoJYmxvY2tUb3VjaFRyaWdnZXJzID0gZmFsc2UsCglldmVudENhcHR1cmVTdXBwb3J0ZWQgPSAiYWRkRXZlbnRMaXN0ZW5lciIgaW4gZG9jdW1lbnQsCgkkZG9jdW1lbnQgPSAkKCBkb2N1bWVudCApLAoJbmV4dFRvdWNoSUQgPSAxLAoJbGFzdFRvdWNoSUQgPSAwLCB0aHJlc2hvbGQsCglpOwoKJC52bW91c2UgPSB7Cgltb3ZlRGlzdGFuY2VUaHJlc2hvbGQ6IDEwLAoJY2xpY2tEaXN0YW5jZVRocmVzaG9sZDogMTAsCglyZXNldFRpbWVyRHVyYXRpb246IDE1MDAKfTsKCmZ1bmN0aW9uIGdldE5hdGl2ZUV2ZW50KCBldmVudCApIHsKCgl3aGlsZSAoIGV2ZW50ICYmIHR5cGVvZiBldmVudC5vcmlnaW5hbEV2ZW50ICE9PSAidW5kZWZpbmVkIiApIHsKCQlldmVudCA9IGV2ZW50Lm9yaWdpbmFsRXZlbnQ7Cgl9CglyZXR1cm4gZXZlbnQ7Cn0KCmZ1bmN0aW9uIGNyZWF0ZVZpcnR1YWxFdmVudCggZXZlbnQsIGV2ZW50VHlwZSApIHsKCgl2YXIgdCA9IGV2ZW50LnR5cGUsCgkJb2UsIHByb3BzLCBuZSwgcHJvcCwgY3QsIHRvdWNoLCBpLCBqLCBsZW47CgoJZXZlbnQgPSAkLkV2ZW50KCBldmVudCApOwoJZXZlbnQudHlwZSA9IGV2ZW50VHlwZTsKCglvZSA9IGV2ZW50Lm9yaWdpbmFsRXZlbnQ7Cglwcm9wcyA9ICQuZXZlbnQucHJvcHM7CgoJLy8gYWRkcmVzc2VzIHNlcGFyYXRpb24gb2YgJC5ldmVudC5wcm9wcyBpbiB0byAkLmV2ZW50Lm1vdXNlSG9vay5wcm9wcyBhbmQgSXNzdWUgMzI4MAoJLy8gaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnktbW9iaWxlL2lzc3Vlcy8zMjgwCglpZiAoIHQuc2VhcmNoKCAvXihtb3VzZXxjbGljaykvICkgPiAtMSApIHsKCQlwcm9wcyA9IG1vdXNlRXZlbnRQcm9wczsKCX0KCgkvLyBjb3B5IG9yaWdpbmFsIGV2ZW50IHByb3BlcnRpZXMgb3ZlciB0byB0aGUgbmV3IGV2ZW50CgkvLyB0aGlzIHdvdWxkIGhhcHBlbiBpZiB3ZSBjb3VsZCBjYWxsICQuZXZlbnQuZml4IGluc3RlYWQgb2YgJC5FdmVudAoJLy8gYnV0IHdlIGRvbid0IGhhdmUgYSB3YXkgdG8gZm9yY2UgYW4gZXZlbnQgdG8gYmUgZml4ZWQgbXVsdGlwbGUgdGltZXMKCWlmICggb2UgKSB7CgkJZm9yICggaSA9IHByb3BzLmxlbmd0aCwgcHJvcDsgaTsgKSB7CgkJCXByb3AgPSBwcm9wc1sgLS1pIF07CgkJCWV2ZW50WyBwcm9wIF0gPSBvZVsgcHJvcCBdOwoJCX0KCX0KCgkvLyBtYWtlIHN1cmUgdGhhdCBpZiB0aGUgbW91c2UgYW5kIGNsaWNrIHZpcnR1YWwgZXZlbnRzIGFyZSBnZW5lcmF0ZWQKCS8vIHdpdGhvdXQgYSAud2hpY2ggb25lIGlzIGRlZmluZWQKCWlmICggdC5zZWFyY2goL21vdXNlKGRvd258dXApfGNsaWNrLykgPiAtMSAmJiAhZXZlbnQud2hpY2ggKSB7CgkJZXZlbnQud2hpY2ggPSAxOwoJfQoKCWlmICggdC5zZWFyY2goL150b3VjaC8pICE9PSAtMSApIHsKCQluZSA9IGdldE5hdGl2ZUV2ZW50KCBvZSApOwoJCXQgPSBuZS50b3VjaGVzOwoJCWN0ID0gbmUuY2hhbmdlZFRvdWNoZXM7CgkJdG91Y2ggPSAoIHQgJiYgdC5sZW5ndGggKSA/IHRbMF0gOiAoICggY3QgJiYgY3QubGVuZ3RoICkgPyBjdFsgMCBdIDogdW5kZWZpbmVkICk7CgoJCWlmICggdG91Y2ggKSB7CgkJCWZvciAoIGogPSAwLCBsZW4gPSB0b3VjaEV2ZW50UHJvcHMubGVuZ3RoOyBqIDwgbGVuOyBqKyspIHsKCQkJCXByb3AgPSB0b3VjaEV2ZW50UHJvcHNbIGogXTsKCQkJCWV2ZW50WyBwcm9wIF0gPSB0b3VjaFsgcHJvcCBdOwoJCQl9CgkJfQoJfQoKCXJldHVybiBldmVudDsKfQoKZnVuY3Rpb24gZ2V0VmlydHVhbEJpbmRpbmdGbGFncyggZWxlbWVudCApIHsKCgl2YXIgZmxhZ3MgPSB7fSwKCQliLCBrOwoKCXdoaWxlICggZWxlbWVudCApIHsKCgkJYiA9ICQuZGF0YSggZWxlbWVudCwgZGF0YVByb3BlcnR5TmFtZSApOwoKCQlmb3IgKCAgayBpbiBiICkgewoJCQlpZiAoIGJbIGsgXSApIHsKCQkJCWZsYWdzWyBrIF0gPSBmbGFncy5oYXNWaXJ0dWFsQmluZGluZyA9IHRydWU7CgkJCX0KCQl9CgkJZWxlbWVudCA9IGVsZW1lbnQucGFyZW50Tm9kZTsKCX0KCXJldHVybiBmbGFnczsKfQoKZnVuY3Rpb24gZ2V0Q2xvc2VzdEVsZW1lbnRXaXRoVmlydHVhbEJpbmRpbmcoIGVsZW1lbnQsIGV2ZW50VHlwZSApIHsKCXZhciBiOwoJd2hpbGUgKCBlbGVtZW50ICkgewoKCQliID0gJC5kYXRhKCBlbGVtZW50LCBkYXRhUHJvcGVydHlOYW1lICk7CgoJCWlmICggYiAmJiAoICFldmVudFR5cGUgfHwgYlsgZXZlbnRUeXBlIF0gKSApIHsKCQkJcmV0dXJuIGVsZW1lbnQ7CgkJfQoJCWVsZW1lbnQgPSBlbGVtZW50LnBhcmVudE5vZGU7Cgl9CglyZXR1cm4gbnVsbDsKfQoKZnVuY3Rpb24gZW5hYmxlVG91Y2hCaW5kaW5ncygpIHsKCWJsb2NrVG91Y2hUcmlnZ2VycyA9IGZhbHNlOwp9CgpmdW5jdGlvbiBkaXNhYmxlVG91Y2hCaW5kaW5ncygpIHsKCWJsb2NrVG91Y2hUcmlnZ2VycyA9IHRydWU7Cn0KCmZ1bmN0aW9uIGVuYWJsZU1vdXNlQmluZGluZ3MoKSB7CglsYXN0VG91Y2hJRCA9IDA7CgljbGlja0Jsb2NrTGlzdC5sZW5ndGggPSAwOwoJYmxvY2tNb3VzZVRyaWdnZXJzID0gZmFsc2U7CgoJLy8gV2hlbiBtb3VzZSBiaW5kaW5ncyBhcmUgZW5hYmxlZCwgb3VyCgkvLyB0b3VjaCBiaW5kaW5ncyBhcmUgZGlzYWJsZWQuCglkaXNhYmxlVG91Y2hCaW5kaW5ncygpOwp9CgpmdW5jdGlvbiBkaXNhYmxlTW91c2VCaW5kaW5ncygpIHsKCS8vIFdoZW4gbW91c2UgYmluZGluZ3MgYXJlIGRpc2FibGVkLCBvdXIKCS8vIHRvdWNoIGJpbmRpbmdzIGFyZSBlbmFibGVkLgoJZW5hYmxlVG91Y2hCaW5kaW5ncygpOwp9CgpmdW5jdGlvbiBzdGFydFJlc2V0VGltZXIoKSB7CgljbGVhclJlc2V0VGltZXIoKTsKCXJlc2V0VGltZXJJRCA9IHNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCXJlc2V0VGltZXJJRCA9IDA7CgkJZW5hYmxlTW91c2VCaW5kaW5ncygpOwoJfSwgJC52bW91c2UucmVzZXRUaW1lckR1cmF0aW9uICk7Cn0KCmZ1bmN0aW9uIGNsZWFyUmVzZXRUaW1lcigpIHsKCWlmICggcmVzZXRUaW1lcklEICkgewoJCWNsZWFyVGltZW91dCggcmVzZXRUaW1lcklEICk7CgkJcmVzZXRUaW1lcklEID0gMDsKCX0KfQoKZnVuY3Rpb24gdHJpZ2dlclZpcnR1YWxFdmVudCggZXZlbnRUeXBlLCBldmVudCwgZmxhZ3MgKSB7Cgl2YXIgdmU7CgoJaWYgKCAoIGZsYWdzICYmIGZsYWdzWyBldmVudFR5cGUgXSApIHx8CgkJCQkoICFmbGFncyAmJiBnZXRDbG9zZXN0RWxlbWVudFdpdGhWaXJ0dWFsQmluZGluZyggZXZlbnQudGFyZ2V0LCBldmVudFR5cGUgKSApICkgewoKCQl2ZSA9IGNyZWF0ZVZpcnR1YWxFdmVudCggZXZlbnQsIGV2ZW50VHlwZSApOwoKCQkkKCBldmVudC50YXJnZXQpLnRyaWdnZXIoIHZlICk7Cgl9CgoJcmV0dXJuIHZlOwp9CgpmdW5jdGlvbiBtb3VzZUV2ZW50Q2FsbGJhY2soIGV2ZW50ICkgewoJdmFyIHRvdWNoSUQgPSAkLmRhdGEoIGV2ZW50LnRhcmdldCwgdG91Y2hUYXJnZXRQcm9wZXJ0eU5hbWUgKSwKCQl2ZTsKCglpZiAoICFibG9ja01vdXNlVHJpZ2dlcnMgJiYgKCAhbGFzdFRvdWNoSUQgfHwgbGFzdFRvdWNoSUQgIT09IHRvdWNoSUQgKSApIHsKCQl2ZSA9IHRyaWdnZXJWaXJ0dWFsRXZlbnQoICJ2IiArIGV2ZW50LnR5cGUsIGV2ZW50ICk7CgkJaWYgKCB2ZSApIHsKCQkJaWYgKCB2ZS5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCX0KCQkJaWYgKCB2ZS5pc1Byb3BhZ2F0aW9uU3RvcHBlZCgpICkgewoJCQkJZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7CgkJCX0KCQkJaWYgKCB2ZS5pc0ltbWVkaWF0ZVByb3BhZ2F0aW9uU3RvcHBlZCgpICkgewoJCQkJZXZlbnQuc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uKCk7CgkJCX0KCQl9Cgl9Cn0KCmZ1bmN0aW9uIGhhbmRsZVRvdWNoU3RhcnQoIGV2ZW50ICkgewoKCXZhciB0b3VjaGVzID0gZ2V0TmF0aXZlRXZlbnQoIGV2ZW50ICkudG91Y2hlcywKCQl0YXJnZXQsIGZsYWdzLCB0OwoKCWlmICggdG91Y2hlcyAmJiB0b3VjaGVzLmxlbmd0aCA9PT0gMSApIHsKCgkJdGFyZ2V0ID0gZXZlbnQudGFyZ2V0OwoJCWZsYWdzID0gZ2V0VmlydHVhbEJpbmRpbmdGbGFncyggdGFyZ2V0ICk7CgoJCWlmICggZmxhZ3MuaGFzVmlydHVhbEJpbmRpbmcgKSB7CgoJCQlsYXN0VG91Y2hJRCA9IG5leHRUb3VjaElEKys7CgkJCSQuZGF0YSggdGFyZ2V0LCB0b3VjaFRhcmdldFByb3BlcnR5TmFtZSwgbGFzdFRvdWNoSUQgKTsKCgkJCWNsZWFyUmVzZXRUaW1lcigpOwoKCQkJZGlzYWJsZU1vdXNlQmluZGluZ3MoKTsKCQkJZGlkU2Nyb2xsID0gZmFsc2U7CgoJCQl0ID0gZ2V0TmF0aXZlRXZlbnQoIGV2ZW50ICkudG91Y2hlc1sgMCBdOwoJCQlzdGFydFggPSB0LnBhZ2VYOwoJCQlzdGFydFkgPSB0LnBhZ2VZOwoKCQkJdHJpZ2dlclZpcnR1YWxFdmVudCggInZtb3VzZW92ZXIiLCBldmVudCwgZmxhZ3MgKTsKCQkJdHJpZ2dlclZpcnR1YWxFdmVudCggInZtb3VzZWRvd24iLCBldmVudCwgZmxhZ3MgKTsKCQl9Cgl9Cn0KCmZ1bmN0aW9uIGhhbmRsZVNjcm9sbCggZXZlbnQgKSB7CglpZiAoIGJsb2NrVG91Y2hUcmlnZ2VycyApIHsKCQlyZXR1cm47Cgl9CgoJaWYgKCAhZGlkU2Nyb2xsICkgewoJCXRyaWdnZXJWaXJ0dWFsRXZlbnQoICJ2bW91c2VjYW5jZWwiLCBldmVudCwgZ2V0VmlydHVhbEJpbmRpbmdGbGFncyggZXZlbnQudGFyZ2V0ICkgKTsKCX0KCglkaWRTY3JvbGwgPSB0cnVlOwoJc3RhcnRSZXNldFRpbWVyKCk7Cn0KCmZ1bmN0aW9uIGhhbmRsZVRvdWNoTW92ZSggZXZlbnQgKSB7CglpZiAoIGJsb2NrVG91Y2hUcmlnZ2VycyApIHsKCQlyZXR1cm47Cgl9CgoJdmFyIHQgPSBnZXROYXRpdmVFdmVudCggZXZlbnQgKS50b3VjaGVzWyAwIF0sCgkJZGlkQ2FuY2VsID0gZGlkU2Nyb2xsLAoJCW1vdmVUaHJlc2hvbGQgPSAkLnZtb3VzZS5tb3ZlRGlzdGFuY2VUaHJlc2hvbGQsCgkJZmxhZ3MgPSBnZXRWaXJ0dWFsQmluZGluZ0ZsYWdzKCBldmVudC50YXJnZXQgKTsKCgkJZGlkU2Nyb2xsID0gZGlkU2Nyb2xsIHx8CgkJCSggTWF0aC5hYnMoIHQucGFnZVggLSBzdGFydFggKSA+IG1vdmVUaHJlc2hvbGQgfHwKCQkJCU1hdGguYWJzKCB0LnBhZ2VZIC0gc3RhcnRZICkgPiBtb3ZlVGhyZXNob2xkICk7CgoKCWlmICggZGlkU2Nyb2xsICYmICFkaWRDYW5jZWwgKSB7CgkJdHJpZ2dlclZpcnR1YWxFdmVudCggInZtb3VzZWNhbmNlbCIsIGV2ZW50LCBmbGFncyApOwoJfQoKCXRyaWdnZXJWaXJ0dWFsRXZlbnQoICJ2bW91c2Vtb3ZlIiwgZXZlbnQsIGZsYWdzICk7CglzdGFydFJlc2V0VGltZXIoKTsKfQoKZnVuY3Rpb24gaGFuZGxlVG91Y2hFbmQoIGV2ZW50ICkgewoJaWYgKCBibG9ja1RvdWNoVHJpZ2dlcnMgKSB7CgkJcmV0dXJuOwoJfQoKCWRpc2FibGVUb3VjaEJpbmRpbmdzKCk7CgoJdmFyIGZsYWdzID0gZ2V0VmlydHVhbEJpbmRpbmdGbGFncyggZXZlbnQudGFyZ2V0ICksCgkJdmUsIHQ7Cgl0cmlnZ2VyVmlydHVhbEV2ZW50KCAidm1vdXNldXAiLCBldmVudCwgZmxhZ3MgKTsKCglpZiAoICFkaWRTY3JvbGwgKSB7CgkJdmUgPSB0cmlnZ2VyVmlydHVhbEV2ZW50KCAidmNsaWNrIiwgZXZlbnQsIGZsYWdzICk7CgkJaWYgKCB2ZSAmJiB2ZS5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJLy8gVGhlIHRhcmdldCBvZiB0aGUgbW91c2UgZXZlbnRzIHRoYXQgZm9sbG93IHRoZSB0b3VjaGVuZAoJCQkvLyBldmVudCBkb24ndCBuZWNlc3NhcmlseSBtYXRjaCB0aGUgdGFyZ2V0IHVzZWQgZHVyaW5nIHRoZQoJCQkvLyB0b3VjaC4gVGhpcyBtZWFucyB3ZSBuZWVkIHRvIHJlbHkgb24gY29vcmRpbmF0ZXMgZm9yIGJsb2NraW5nCgkJCS8vIGFueSBjbGljayB0aGF0IGlzIGdlbmVyYXRlZC4KCQkJdCA9IGdldE5hdGl2ZUV2ZW50KCBldmVudCApLmNoYW5nZWRUb3VjaGVzWyAwIF07CgkJCWNsaWNrQmxvY2tMaXN0LnB1c2goewoJCQkJdG91Y2hJRDogbGFzdFRvdWNoSUQsCgkJCQl4OiB0LmNsaWVudFgsCgkJCQl5OiB0LmNsaWVudFkKCQkJfSk7CgoJCQkvLyBQcmV2ZW50IGFueSBtb3VzZSBldmVudHMgdGhhdCBmb2xsb3cgZnJvbSB0cmlnZ2VyaW5nCgkJCS8vIHZpcnR1YWwgZXZlbnQgbm90aWZpY2F0aW9ucy4KCQkJYmxvY2tNb3VzZVRyaWdnZXJzID0gdHJ1ZTsKCQl9Cgl9Cgl0cmlnZ2VyVmlydHVhbEV2ZW50KCAidm1vdXNlb3V0IiwgZXZlbnQsIGZsYWdzKTsKCWRpZFNjcm9sbCA9IGZhbHNlOwoKCXN0YXJ0UmVzZXRUaW1lcigpOwp9CgpmdW5jdGlvbiBoYXNWaXJ0dWFsQmluZGluZ3MoIGVsZSApIHsKCXZhciBiaW5kaW5ncyA9ICQuZGF0YSggZWxlLCBkYXRhUHJvcGVydHlOYW1lICksCgkJazsKCglpZiAoIGJpbmRpbmdzICkgewoJCWZvciAoIGsgaW4gYmluZGluZ3MgKSB7CgkJCWlmICggYmluZGluZ3NbIGsgXSApIHsKCQkJCXJldHVybiB0cnVlOwoJCQl9CgkJfQoJfQoJcmV0dXJuIGZhbHNlOwp9CgpmdW5jdGlvbiBkdW1teU1vdXNlSGFuZGxlcigpIHt9CgpmdW5jdGlvbiBnZXRTcGVjaWFsRXZlbnRPYmplY3QoIGV2ZW50VHlwZSApIHsKCXZhciByZWFsVHlwZSA9IGV2ZW50VHlwZS5zdWJzdHIoIDEgKTsKCglyZXR1cm4gewoJCXNldHVwOiBmdW5jdGlvbigvKiBkYXRhLCBuYW1lc3BhY2UgKi8pIHsKCQkJLy8gSWYgdGhpcyBpcyB0aGUgZmlyc3QgdmlydHVhbCBtb3VzZSBiaW5kaW5nIGZvciB0aGlzIGVsZW1lbnQsCgkJCS8vIGFkZCBhIGJpbmRpbmdzIG9iamVjdCB0byBpdHMgZGF0YS4KCgkJCWlmICggIWhhc1ZpcnR1YWxCaW5kaW5ncyggdGhpcyApICkgewoJCQkJJC5kYXRhKCB0aGlzLCBkYXRhUHJvcGVydHlOYW1lLCB7fSApOwoJCQl9CgoJCQkvLyBJZiBzZXR1cCBpcyBjYWxsZWQsIHdlIGtub3cgaXQgaXMgdGhlIGZpcnN0IGJpbmRpbmcgZm9yIHRoaXMKCQkJLy8gZXZlbnRUeXBlLCBzbyBpbml0aWFsaXplIHRoZSBjb3VudCBmb3IgdGhlIGV2ZW50VHlwZSB0byB6ZXJvLgoJCQl2YXIgYmluZGluZ3MgPSAkLmRhdGEoIHRoaXMsIGRhdGFQcm9wZXJ0eU5hbWUgKTsKCQkJYmluZGluZ3NbIGV2ZW50VHlwZSBdID0gdHJ1ZTsKCgkJCS8vIElmIHRoaXMgaXMgdGhlIGZpcnN0IHZpcnR1YWwgbW91c2UgZXZlbnQgZm9yIHRoaXMgdHlwZSwKCQkJLy8gcmVnaXN0ZXIgYSBnbG9iYWwgaGFuZGxlciBvbiB0aGUgZG9jdW1lbnQuCgoJCQlhY3RpdmVEb2NIYW5kbGVyc1sgZXZlbnRUeXBlIF0gPSAoIGFjdGl2ZURvY0hhbmRsZXJzWyBldmVudFR5cGUgXSB8fCAwICkgKyAxOwoKCQkJaWYgKCBhY3RpdmVEb2NIYW5kbGVyc1sgZXZlbnRUeXBlIF0gPT09IDEgKSB7CgkJCQkkZG9jdW1lbnQuYmluZCggcmVhbFR5cGUsIG1vdXNlRXZlbnRDYWxsYmFjayApOwoJCQl9CgoJCQkvLyBTb21lIGJyb3dzZXJzLCBsaWtlIE9wZXJhIE1pbmksIHdvbid0IGRpc3BhdGNoIG1vdXNlL2NsaWNrIGV2ZW50cwoJCQkvLyBmb3IgZWxlbWVudHMgdW5sZXNzIHRoZXkgYWN0dWFsbHkgaGF2ZSBoYW5kbGVycyByZWdpc3RlcmVkIG9uIHRoZW0uCgkJCS8vIFRvIGdldCBhcm91bmQgdGhpcywgd2UgcmVnaXN0ZXIgZHVtbXkgaGFuZGxlcnMgb24gdGhlIGVsZW1lbnRzLgoKCQkJJCggdGhpcyApLmJpbmQoIHJlYWxUeXBlLCBkdW1teU1vdXNlSGFuZGxlciApOwoKCQkJLy8gRm9yIG5vdywgaWYgZXZlbnQgY2FwdHVyZSBpcyBub3Qgc3VwcG9ydGVkLCB3ZSByZWx5IG9uIG1vdXNlIGhhbmRsZXJzLgoJCQlpZiAoIGV2ZW50Q2FwdHVyZVN1cHBvcnRlZCApIHsKCQkJCS8vIElmIHRoaXMgaXMgdGhlIGZpcnN0IHZpcnR1YWwgbW91c2UgYmluZGluZyBmb3IgdGhlIGRvY3VtZW50LAoJCQkJLy8gcmVnaXN0ZXIgb3VyIHRvdWNoc3RhcnQgaGFuZGxlciBvbiB0aGUgZG9jdW1lbnQuCgoJCQkJYWN0aXZlRG9jSGFuZGxlcnNbICJ0b3VjaHN0YXJ0IiBdID0gKCBhY3RpdmVEb2NIYW5kbGVyc1sgInRvdWNoc3RhcnQiIF0gfHwgMCkgKyAxOwoKCQkJCWlmICggYWN0aXZlRG9jSGFuZGxlcnNbICJ0b3VjaHN0YXJ0IiBdID09PSAxICkgewoJCQkJCSRkb2N1bWVudC5iaW5kKCAidG91Y2hzdGFydCIsIGhhbmRsZVRvdWNoU3RhcnQgKQoJCQkJCQkuYmluZCggInRvdWNoZW5kIiwgaGFuZGxlVG91Y2hFbmQgKQoKCQkJCQkJLy8gT24gdG91Y2ggcGxhdGZvcm1zLCB0b3VjaGluZyB0aGUgc2NyZWVuIGFuZCB0aGVuIGRyYWdnaW5nIHlvdXIgZmluZ2VyCgkJCQkJCS8vIGNhdXNlcyB0aGUgd2luZG93IGNvbnRlbnQgdG8gc2Nyb2xsIGFmdGVyIHNvbWUgZGlzdGFuY2UgdGhyZXNob2xkIGlzCgkJCQkJCS8vIGV4Y2VlZGVkLiBPbiB0aGVzZSBwbGF0Zm9ybXMsIGEgc2Nyb2xsIHByZXZlbnRzIGEgY2xpY2sgZXZlbnQgZnJvbSBiZWluZwoJCQkJCQkvLyBkaXNwYXRjaGVkLCBhbmQgb24gc29tZSBwbGF0Zm9ybXMsIGV2ZW4gdGhlIHRvdWNoZW5kIGlzIHN1cHByZXNzZWQuIFRvCgkJCQkJCS8vIG1pbWljIHRoZSBzdXBwcmVzc2lvbiBvZiB0aGUgY2xpY2sgZXZlbnQsIHdlIG5lZWQgdG8gd2F0Y2ggZm9yIGEgc2Nyb2xsCgkJCQkJCS8vIGV2ZW50LiBVbmZvcnR1bmF0ZWx5LCBzb21lIHBsYXRmb3JtcyBsaWtlIGlPUyBkb24ndCBkaXNwYXRjaCBzY3JvbGwKCQkJCQkJLy8gZXZlbnRzIHVudGlsICpBRlRFUiogdGhlIHVzZXIgbGlmdHMgdGhlaXIgZmluZ2VyICh0b3VjaGVuZCkuIFRoaXMgbWVhbnMKCQkJCQkJLy8gd2UgbmVlZCB0byB3YXRjaCBib3RoIHNjcm9sbCBhbmQgdG91Y2htb3ZlIGV2ZW50cyB0byBmaWd1cmUgb3V0IHdoZXRoZXIKCQkJCQkJLy8gb3Igbm90IGEgc2Nyb2xsIGhhcHBlbmVucyBiZWZvcmUgdGhlIHRvdWNoZW5kIGV2ZW50IGlzIGZpcmVkLgoKCQkJCQkJLmJpbmQoICJ0b3VjaG1vdmUiLCBoYW5kbGVUb3VjaE1vdmUgKQoJCQkJCQkuYmluZCggInNjcm9sbCIsIGhhbmRsZVNjcm9sbCApOwoJCQkJfQoJCQl9CgkJfSwKCgkJdGVhcmRvd246IGZ1bmN0aW9uKC8qIGRhdGEsIG5hbWVzcGFjZSAqLykgewoJCQkvLyBJZiB0aGlzIGlzIHRoZSBsYXN0IHZpcnR1YWwgYmluZGluZyBmb3IgdGhpcyBldmVudFR5cGUsCgkJCS8vIHJlbW92ZSBpdHMgZ2xvYmFsIGhhbmRsZXIgZnJvbSB0aGUgZG9jdW1lbnQuCgoJCQktLWFjdGl2ZURvY0hhbmRsZXJzWyBldmVudFR5cGUgXTsKCgkJCWlmICggIWFjdGl2ZURvY0hhbmRsZXJzWyBldmVudFR5cGUgXSApIHsKCQkJCSRkb2N1bWVudC51bmJpbmQoIHJlYWxUeXBlLCBtb3VzZUV2ZW50Q2FsbGJhY2sgKTsKCQkJfQoKCQkJaWYgKCBldmVudENhcHR1cmVTdXBwb3J0ZWQgKSB7CgkJCQkvLyBJZiB0aGlzIGlzIHRoZSBsYXN0IHZpcnR1YWwgbW91c2UgYmluZGluZyBpbiBleGlzdGVuY2UsCgkJCQkvLyByZW1vdmUgb3VyIGRvY3VtZW50IHRvdWNoc3RhcnQgbGlzdGVuZXIuCgoJCQkJLS1hY3RpdmVEb2NIYW5kbGVyc1sgInRvdWNoc3RhcnQiIF07CgoJCQkJaWYgKCAhYWN0aXZlRG9jSGFuZGxlcnNbICJ0b3VjaHN0YXJ0IiBdICkgewoJCQkJCSRkb2N1bWVudC51bmJpbmQoICJ0b3VjaHN0YXJ0IiwgaGFuZGxlVG91Y2hTdGFydCApCgkJCQkJCS51bmJpbmQoICJ0b3VjaG1vdmUiLCBoYW5kbGVUb3VjaE1vdmUgKQoJCQkJCQkudW5iaW5kKCAidG91Y2hlbmQiLCBoYW5kbGVUb3VjaEVuZCApCgkJCQkJCS51bmJpbmQoICJzY3JvbGwiLCBoYW5kbGVTY3JvbGwgKTsKCQkJCX0KCQkJfQoKCQkJdmFyICR0aGlzID0gJCggdGhpcyApLAoJCQkJYmluZGluZ3MgPSAkLmRhdGEoIHRoaXMsIGRhdGFQcm9wZXJ0eU5hbWUgKTsKCgkJCS8vIHRlYXJkb3duIG1heSBiZSBjYWxsZWQgd2hlbiBhbiBlbGVtZW50IHdhcwoJCQkvLyByZW1vdmVkIGZyb20gdGhlIERPTS4gSWYgdGhpcyBpcyB0aGUgY2FzZSwKCQkJLy8galF1ZXJ5IGNvcmUgbWF5IGhhdmUgYWxyZWFkeSBzdHJpcHBlZCB0aGUgZWxlbWVudAoJCQkvLyBvZiBhbnkgZGF0YSBiaW5kaW5ncyBzbyB3ZSBuZWVkIHRvIGNoZWNrIGl0IGJlZm9yZQoJCQkvLyB1c2luZyBpdC4KCQkJaWYgKCBiaW5kaW5ncyApIHsKCQkJCWJpbmRpbmdzWyBldmVudFR5cGUgXSA9IGZhbHNlOwoJCQl9CgoJCQkvLyBVbnJlZ2lzdGVyIHRoZSBkdW1teSBldmVudCBoYW5kbGVyLgoKCQkJJHRoaXMudW5iaW5kKCByZWFsVHlwZSwgZHVtbXlNb3VzZUhhbmRsZXIgKTsKCgkJCS8vIElmIHRoaXMgaXMgdGhlIGxhc3QgdmlydHVhbCBtb3VzZSBiaW5kaW5nIG9uIHRoZQoJCQkvLyBlbGVtZW50LCByZW1vdmUgdGhlIGJpbmRpbmcgZGF0YSBmcm9tIHRoZSBlbGVtZW50LgoKCQkJaWYgKCAhaGFzVmlydHVhbEJpbmRpbmdzKCB0aGlzICkgKSB7CgkJCQkkdGhpcy5yZW1vdmVEYXRhKCBkYXRhUHJvcGVydHlOYW1lICk7CgkJCX0KCQl9Cgl9Owp9CgovLyBFeHBvc2Ugb3VyIGN1c3RvbSBldmVudHMgdG8gdGhlIGpRdWVyeSBiaW5kL3VuYmluZCBtZWNoYW5pc20uCgpmb3IgKCBpID0gMDsgaSA8IHZpcnR1YWxFdmVudE5hbWVzLmxlbmd0aDsgaSsrICkgewoJJC5ldmVudC5zcGVjaWFsWyB2aXJ0dWFsRXZlbnROYW1lc1sgaSBdIF0gPSBnZXRTcGVjaWFsRXZlbnRPYmplY3QoIHZpcnR1YWxFdmVudE5hbWVzWyBpIF0gKTsKfQoKLy8gQWRkIGEgY2FwdHVyZSBjbGljayBoYW5kbGVyIHRvIGJsb2NrIGNsaWNrcy4KLy8gTm90ZSB0aGF0IHdlIHJlcXVpcmUgZXZlbnQgY2FwdHVyZSBzdXBwb3J0IGZvciB0aGlzIHNvIGlmIHRoZSBkZXZpY2UKLy8gZG9lc24ndCBzdXBwb3J0IGl0LCB3ZSBwdW50IGZvciBub3cgYW5kIHJlbHkgc29sZWx5IG9uIG1vdXNlIGV2ZW50cy4KaWYgKCBldmVudENhcHR1cmVTdXBwb3J0ZWQgKSB7Cglkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCAiY2xpY2siLCBmdW5jdGlvbiggZSApIHsKCQl2YXIgY250ID0gY2xpY2tCbG9ja0xpc3QubGVuZ3RoLAoJCQl0YXJnZXQgPSBlLnRhcmdldCwKCQkJeCwgeSwgZWxlLCBpLCBvLCB0b3VjaElEOwoKCQlpZiAoIGNudCApIHsKCQkJeCA9IGUuY2xpZW50WDsKCQkJeSA9IGUuY2xpZW50WTsKCQkJdGhyZXNob2xkID0gJC52bW91c2UuY2xpY2tEaXN0YW5jZVRocmVzaG9sZDsKCgkJCS8vIFRoZSBpZGVhIGhlcmUgaXMgdG8gcnVuIHRocm91Z2ggdGhlIGNsaWNrQmxvY2tMaXN0IHRvIHNlZSBpZgoJCQkvLyB0aGUgY3VycmVudCBjbGljayBldmVudCBpcyBpbiB0aGUgcHJveGltaXR5IG9mIG9uZSBvZiBvdXIKCQkJLy8gdmNsaWNrIGV2ZW50cyB0aGF0IGhhZCBwcmV2ZW50RGVmYXVsdCgpIGNhbGxlZCBvbiBpdC4gSWYgd2UgZmluZAoJCQkvLyBvbmUsIHRoZW4gd2UgYmxvY2sgdGhlIGNsaWNrLgoJCQkvLwoJCQkvLyBXaHkgZG8gd2UgaGF2ZSB0byByZWx5IG9uIHByb3hpbWl0eT8KCQkJLy8KCQkJLy8gQmVjYXVzZSB0aGUgdGFyZ2V0IG9mIHRoZSB0b3VjaCBldmVudCB0aGF0IHRyaWdnZXJlZCB0aGUgdmNsaWNrCgkJCS8vIGNhbiBiZSBkaWZmZXJlbnQgZnJvbSB0aGUgdGFyZ2V0IG9mIHRoZSBjbGljayBldmVudCBzeW50aGVzaXplZAoJCQkvLyBieSB0aGUgYnJvd3Nlci4gVGhlIHRhcmdldCBvZiBhIG1vdXNlL2NsaWNrIGV2ZW50IHRoYXQgaXMgc3ludGVoc2l6ZWQKCQkJLy8gZnJvbSBhIHRvdWNoIGV2ZW50IHNlZW1zIHRvIGJlIGltcGxlbWVudGF0aW9uIHNwZWNpZmljLiBGb3IgZXhhbXBsZSwKCQkJLy8gc29tZSBicm93c2VycyB3aWxsIGZpcmUgbW91c2UvY2xpY2sgZXZlbnRzIGZvciBhIGxpbmsgdGhhdCBpcyBuZWFyCgkJCS8vIGEgdG91Y2ggZXZlbnQsIGV2ZW4gdGhvdWdoIHRoZSB0YXJnZXQgb2YgdGhlIHRvdWNoc3RhcnQvdG91Y2hlbmQgZXZlbnQKCQkJLy8gc2F5cyB0aGUgdXNlciB0b3VjaGVkIG91dHNpZGUgdGhlIGxpbmsuIEFsc28sIGl0IHNlZW1zIHRoYXQgd2l0aCBtb3N0CgkJCS8vIGJyb3dzZXJzLCB0aGUgdGFyZ2V0IG9mIHRoZSBtb3VzZS9jbGljayBldmVudCBpcyBub3QgY2FsY3VsYXRlZCB1bnRpbCB0aGUKCQkJLy8gdGltZSBpdCBpcyBkaXNwYXRjaGVkLCBzbyBpZiB5b3UgcmVwbGFjZSBhbiBlbGVtZW50IHRoYXQgeW91IHRvdWNoZWQKCQkJLy8gd2l0aCBhbm90aGVyIGVsZW1lbnQsIHRoZSB0YXJnZXQgb2YgdGhlIG1vdXNlL2NsaWNrIHdpbGwgYmUgdGhlIG5ldwoJCQkvLyBlbGVtZW50IHVuZGVybmVhdGggdGhhdCBwb2ludC4KCQkJLy8KCQkJLy8gQXNpZGUgZnJvbSBwcm94aW1pdHksIHdlIGFsc28gY2hlY2sgdG8gc2VlIGlmIHRoZSB0YXJnZXQgYW5kIGFueQoJCQkvLyBvZiBpdHMgYW5jZXN0b3JzIHdlcmUgdGhlIG9uZXMgdGhhdCBibG9ja2VkIGEgY2xpY2suIFRoaXMgaXMgbmVjZXNzYXJ5CgkJCS8vIGJlY2F1c2Ugb2YgdGhlIHN0cmFuZ2UgbW91c2UvY2xpY2sgdGFyZ2V0IGNhbGN1bGF0aW9uIGRvbmUgaW4gdGhlCgkJCS8vIEFuZHJvaWQgMi4xIGJyb3dzZXIsIHdoZXJlIGlmIHlvdSBjbGljayBvbiBhbiBlbGVtZW50LCBhbmQgdGhlcmUgaXMgYQoJCQkvLyBtb3VzZS9jbGljayBoYW5kbGVyIG9uIG9uZSBvZiBpdHMgYW5jZXN0b3JzLCB0aGUgdGFyZ2V0IHdpbGwgYmUgdGhlCgkJCS8vIGlubmVybW9zdCBjaGlsZCBvZiB0aGUgdG91Y2hlZCBlbGVtZW50LCBldmVuIGlmIHRoYXQgY2hpbGQgaXMgbm8gd2hlcmUKCQkJLy8gbmVhciB0aGUgcG9pbnQgb2YgdG91Y2guCgoJCQllbGUgPSB0YXJnZXQ7CgoJCQl3aGlsZSAoIGVsZSApIHsKCQkJCWZvciAoIGkgPSAwOyBpIDwgY250OyBpKysgKSB7CgkJCQkJbyA9IGNsaWNrQmxvY2tMaXN0WyBpIF07CgkJCQkJdG91Y2hJRCA9IDA7CgoJCQkJCWlmICggKCBlbGUgPT09IHRhcmdldCAmJiBNYXRoLmFicyggby54IC0geCApIDwgdGhyZXNob2xkICYmIE1hdGguYWJzKCBvLnkgLSB5ICkgPCB0aHJlc2hvbGQgKSB8fAoJCQkJCQkJCSQuZGF0YSggZWxlLCB0b3VjaFRhcmdldFByb3BlcnR5TmFtZSApID09PSBvLnRvdWNoSUQgKSB7CgkJCQkJCS8vIFhYWDogV2UgbWF5IHdhbnQgdG8gY29uc2lkZXIgcmVtb3ZpbmcgbWF0Y2hlcyBmcm9tIHRoZSBibG9jayBsaXN0CgkJCQkJCS8vICAgICAgaW5zdGVhZCBvZiB3YWl0aW5nIGZvciB0aGUgcmVzZXQgdGltZXIgdG8gZmlyZS4KCQkJCQkJZS5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJCQllLnN0b3BQcm9wYWdhdGlvbigpOwoJCQkJCQlyZXR1cm47CgkJCQkJfQoJCQkJfQoJCQkJZWxlID0gZWxlLnBhcmVudE5vZGU7CgkJCX0KCQl9Cgl9LCB0cnVlKTsKfQp9KSggalF1ZXJ5LCB3aW5kb3csIGRvY3VtZW50ICk7CgoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCXZhciAkZG9jdW1lbnQgPSAkKCBkb2N1bWVudCApLAoJCXN1cHBvcnRUb3VjaCA9ICQubW9iaWxlLnN1cHBvcnQudG91Y2gsCgkJc2Nyb2xsRXZlbnQgPSAidG91Y2htb3ZlIHNjcm9sbCIsCgkJdG91Y2hTdGFydEV2ZW50ID0gc3VwcG9ydFRvdWNoID8gInRvdWNoc3RhcnQiIDogIm1vdXNlZG93biIsCgkJdG91Y2hTdG9wRXZlbnQgPSBzdXBwb3J0VG91Y2ggPyAidG91Y2hlbmQiIDogIm1vdXNldXAiLAoJCXRvdWNoTW92ZUV2ZW50ID0gc3VwcG9ydFRvdWNoID8gInRvdWNobW92ZSIgOiAibW91c2Vtb3ZlIjsKCgkvLyBzZXR1cCBuZXcgZXZlbnQgc2hvcnRjdXRzCgkkLmVhY2goICggInRvdWNoc3RhcnQgdG91Y2htb3ZlIHRvdWNoZW5kICIgKwoJCSJ0YXAgdGFwaG9sZCAiICsKCQkic3dpcGUgc3dpcGVsZWZ0IHN3aXBlcmlnaHQgIiArCgkJInNjcm9sbHN0YXJ0IHNjcm9sbHN0b3AiICkuc3BsaXQoICIgIiApLCBmdW5jdGlvbiggaSwgbmFtZSApIHsKCgkJJC5mblsgbmFtZSBdID0gZnVuY3Rpb24oIGZuICkgewoJCQlyZXR1cm4gZm4gPyB0aGlzLmJpbmQoIG5hbWUsIGZuICkgOiB0aGlzLnRyaWdnZXIoIG5hbWUgKTsKCQl9OwoKCQkvLyBqUXVlcnkgPCAxLjgKCQlpZiAoICQuYXR0ckZuICkgewoJCQkkLmF0dHJGblsgbmFtZSBdID0gdHJ1ZTsKCQl9Cgl9KTsKCglmdW5jdGlvbiB0cmlnZ2VyQ3VzdG9tRXZlbnQoIG9iaiwgZXZlbnRUeXBlLCBldmVudCApIHsKCQl2YXIgb3JpZ2luYWxUeXBlID0gZXZlbnQudHlwZTsKCQlldmVudC50eXBlID0gZXZlbnRUeXBlOwoJCSQuZXZlbnQuZGlzcGF0Y2guY2FsbCggb2JqLCBldmVudCApOwoJCWV2ZW50LnR5cGUgPSBvcmlnaW5hbFR5cGU7Cgl9CgoJLy8gYWxzbyBoYW5kbGVzIHNjcm9sbHN0b3AKCSQuZXZlbnQuc3BlY2lhbC5zY3JvbGxzdGFydCA9IHsKCgkJZW5hYmxlZDogdHJ1ZSwKCQlzZXR1cDogZnVuY3Rpb24oKSB7CgoJCQl2YXIgdGhpc09iamVjdCA9IHRoaXMsCgkJCQkkdGhpcyA9ICQoIHRoaXNPYmplY3QgKSwKCQkJCXNjcm9sbGluZywKCQkJCXRpbWVyOwoKCQkJZnVuY3Rpb24gdHJpZ2dlciggZXZlbnQsIHN0YXRlICkgewoJCQkJc2Nyb2xsaW5nID0gc3RhdGU7CgkJCQl0cmlnZ2VyQ3VzdG9tRXZlbnQoIHRoaXNPYmplY3QsIHNjcm9sbGluZyA/ICJzY3JvbGxzdGFydCIgOiAic2Nyb2xsc3RvcCIsIGV2ZW50ICk7CgkJCX0KCgkJCS8vIGlQaG9uZSB0cmlnZ2VycyBzY3JvbGwgYWZ0ZXIgYSBzbWFsbCBkZWxheTsgdXNlIHRvdWNobW92ZSBpbnN0ZWFkCgkJCSR0aGlzLmJpbmQoIHNjcm9sbEV2ZW50LCBmdW5jdGlvbiggZXZlbnQgKSB7CgoJCQkJaWYgKCAhJC5ldmVudC5zcGVjaWFsLnNjcm9sbHN0YXJ0LmVuYWJsZWQgKSB7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICggIXNjcm9sbGluZyApIHsKCQkJCQl0cmlnZ2VyKCBldmVudCwgdHJ1ZSApOwoJCQkJfQoKCQkJCWNsZWFyVGltZW91dCggdGltZXIgKTsKCQkJCXRpbWVyID0gc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQkJdHJpZ2dlciggZXZlbnQsIGZhbHNlICk7CgkJCQl9LCA1MCApOwoJCQl9KTsKCQl9LAoJCXRlYXJkb3duOiBmdW5jdGlvbigpIHsKCQkJJCggdGhpcyApLnVuYmluZCggc2Nyb2xsRXZlbnQgKTsKCQl9Cgl9OwoKCS8vIGFsc28gaGFuZGxlcyB0YXBob2xkCgkkLmV2ZW50LnNwZWNpYWwudGFwID0gewoJCXRhcGhvbGRUaHJlc2hvbGQ6IDc1MCwKCQllbWl0VGFwT25UYXBob2xkOiB0cnVlLAoJCXNldHVwOiBmdW5jdGlvbigpIHsKCQkJdmFyIHRoaXNPYmplY3QgPSB0aGlzLAoJCQkJJHRoaXMgPSAkKCB0aGlzT2JqZWN0ICksCgkJCQlpc1RhcGhvbGQgPSBmYWxzZTsKCgkJCSR0aGlzLmJpbmQoICJ2bW91c2Vkb3duIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJaXNUYXBob2xkID0gZmFsc2U7CgkJCQlpZiAoIGV2ZW50LndoaWNoICYmIGV2ZW50LndoaWNoICE9PSAxICkgewoJCQkJCXJldHVybiBmYWxzZTsKCQkJCX0KCgkJCQl2YXIgb3JpZ1RhcmdldCA9IGV2ZW50LnRhcmdldCwKCQkJCQl0aW1lcjsKCgkJCQlmdW5jdGlvbiBjbGVhclRhcFRpbWVyKCkgewoJCQkJCWNsZWFyVGltZW91dCggdGltZXIgKTsKCQkJCX0KCgkJCQlmdW5jdGlvbiBjbGVhclRhcEhhbmRsZXJzKCkgewoJCQkJCWNsZWFyVGFwVGltZXIoKTsKCgkJCQkJJHRoaXMudW5iaW5kKCAidmNsaWNrIiwgY2xpY2tIYW5kbGVyICkKCQkJCQkJLnVuYmluZCggInZtb3VzZXVwIiwgY2xlYXJUYXBUaW1lciApOwoJCQkJCSRkb2N1bWVudC51bmJpbmQoICJ2bW91c2VjYW5jZWwiLCBjbGVhclRhcEhhbmRsZXJzICk7CgkJCQl9CgoJCQkJZnVuY3Rpb24gY2xpY2tIYW5kbGVyKCBldmVudCApIHsKCQkJCQljbGVhclRhcEhhbmRsZXJzKCk7CgoJCQkJCS8vIE9OTFkgdHJpZ2dlciBhICd0YXAnIGV2ZW50IGlmIHRoZSBzdGFydCB0YXJnZXQgaXMKCQkJCQkvLyB0aGUgc2FtZSBhcyB0aGUgc3RvcCB0YXJnZXQuCgkJCQkJaWYgKCAhaXNUYXBob2xkICYmIG9yaWdUYXJnZXQgPT09IGV2ZW50LnRhcmdldCApIHsKCQkJCQkJdHJpZ2dlckN1c3RvbUV2ZW50KCB0aGlzT2JqZWN0LCAidGFwIiwgZXZlbnQgKTsKCQkJCQl9IGVsc2UgaWYgKCBpc1RhcGhvbGQgKSB7CgkJCQkJCWV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOwoJCQkJCX0KCQkJCX0KCgkJCQkkdGhpcy5iaW5kKCAidm1vdXNldXAiLCBjbGVhclRhcFRpbWVyICkKCQkJCQkuYmluZCggInZjbGljayIsIGNsaWNrSGFuZGxlciApOwoJCQkJJGRvY3VtZW50LmJpbmQoICJ2bW91c2VjYW5jZWwiLCBjbGVhclRhcEhhbmRsZXJzICk7CgoJCQkJdGltZXIgPSBzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJCQlpZiAoICEkLmV2ZW50LnNwZWNpYWwudGFwLmVtaXRUYXBPblRhcGhvbGQgKSB7CgkJCQkJCWlzVGFwaG9sZCA9IHRydWU7CgkJCQkJfQoJCQkJCXRyaWdnZXJDdXN0b21FdmVudCggdGhpc09iamVjdCwgInRhcGhvbGQiLCAkLkV2ZW50KCAidGFwaG9sZCIsIHsgdGFyZ2V0OiBvcmlnVGFyZ2V0IH0gKSApOwoJCQkJfSwgJC5ldmVudC5zcGVjaWFsLnRhcC50YXBob2xkVGhyZXNob2xkICk7CgkJCX0pOwoJCX0sCgkJdGVhcmRvd246IGZ1bmN0aW9uKCkgewoJCQkkKCB0aGlzICkudW5iaW5kKCAidm1vdXNlZG93biIgKS51bmJpbmQoICJ2Y2xpY2siICkudW5iaW5kKCAidm1vdXNldXAiICk7CgkJCSRkb2N1bWVudC51bmJpbmQoICJ2bW91c2VjYW5jZWwiICk7CgkJfQoJfTsKCgkvLyBhbHNvIGhhbmRsZXMgc3dpcGVsZWZ0LCBzd2lwZXJpZ2h0CgkkLmV2ZW50LnNwZWNpYWwuc3dpcGUgPSB7CgkJc2Nyb2xsU3VwcmVzc2lvblRocmVzaG9sZDogMzAsIC8vIE1vcmUgdGhhbiB0aGlzIGhvcml6b250YWwgZGlzcGxhY2VtZW50LCBhbmQgd2Ugd2lsbCBzdXBwcmVzcyBzY3JvbGxpbmcuCgoJCWR1cmF0aW9uVGhyZXNob2xkOiAxMDAwLCAvLyBNb3JlIHRpbWUgdGhhbiB0aGlzLCBhbmQgaXQgaXNuJ3QgYSBzd2lwZS4KCgkJaG9yaXpvbnRhbERpc3RhbmNlVGhyZXNob2xkOiAzMCwgIC8vIFN3aXBlIGhvcml6b250YWwgZGlzcGxhY2VtZW50IG11c3QgYmUgbW9yZSB0aGFuIHRoaXMuCgoJCXZlcnRpY2FsRGlzdGFuY2VUaHJlc2hvbGQ6IDc1LCAgLy8gU3dpcGUgdmVydGljYWwgZGlzcGxhY2VtZW50IG11c3QgYmUgbGVzcyB0aGFuIHRoaXMuCgoJCXN0YXJ0OiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciBkYXRhID0gZXZlbnQub3JpZ2luYWxFdmVudC50b3VjaGVzID8KCQkJCQlldmVudC5vcmlnaW5hbEV2ZW50LnRvdWNoZXNbIDAgXSA6IGV2ZW50OwoJCQlyZXR1cm4gewoJCQkJCQl0aW1lOiAoIG5ldyBEYXRlKCkgKS5nZXRUaW1lKCksCgkJCQkJCWNvb3JkczogWyBkYXRhLnBhZ2VYLCBkYXRhLnBhZ2VZIF0sCgkJCQkJCW9yaWdpbjogJCggZXZlbnQudGFyZ2V0ICkKCQkJCQl9OwoJCX0sCgoJCXN0b3A6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdmFyIGRhdGEgPSBldmVudC5vcmlnaW5hbEV2ZW50LnRvdWNoZXMgPwoJCQkJCWV2ZW50Lm9yaWdpbmFsRXZlbnQudG91Y2hlc1sgMCBdIDogZXZlbnQ7CgkJCXJldHVybiB7CgkJCQkJCXRpbWU6ICggbmV3IERhdGUoKSApLmdldFRpbWUoKSwKCQkJCQkJY29vcmRzOiBbIGRhdGEucGFnZVgsIGRhdGEucGFnZVkgXQoJCQkJCX07CgkJfSwKCgkJaGFuZGxlU3dpcGU6IGZ1bmN0aW9uKCBzdGFydCwgc3RvcCwgdGhpc09iamVjdCwgb3JpZ1RhcmdldCApIHsKCQkJaWYgKCBzdG9wLnRpbWUgLSBzdGFydC50aW1lIDwgJC5ldmVudC5zcGVjaWFsLnN3aXBlLmR1cmF0aW9uVGhyZXNob2xkICYmCgkJCQlNYXRoLmFicyggc3RhcnQuY29vcmRzWyAwIF0gLSBzdG9wLmNvb3Jkc1sgMCBdICkgPiAkLmV2ZW50LnNwZWNpYWwuc3dpcGUuaG9yaXpvbnRhbERpc3RhbmNlVGhyZXNob2xkICYmCgkJCQlNYXRoLmFicyggc3RhcnQuY29vcmRzWyAxIF0gLSBzdG9wLmNvb3Jkc1sgMSBdICkgPCAkLmV2ZW50LnNwZWNpYWwuc3dpcGUudmVydGljYWxEaXN0YW5jZVRocmVzaG9sZCApIHsKCQkJCXZhciBkaXJlY3Rpb24gPSBzdGFydC5jb29yZHNbMF0gPiBzdG9wLmNvb3Jkc1sgMCBdID8gInN3aXBlbGVmdCIgOiAic3dpcGVyaWdodCI7CgoJCQkJdHJpZ2dlckN1c3RvbUV2ZW50KCB0aGlzT2JqZWN0LCAic3dpcGUiLCAkLkV2ZW50KCAic3dpcGUiLCB7IHRhcmdldDogb3JpZ1RhcmdldCwgc3dpcGVzdGFydDogc3RhcnQsIHN3aXBlc3RvcDogc3RvcCB9KSApOwoJCQkJdHJpZ2dlckN1c3RvbUV2ZW50KCB0aGlzT2JqZWN0LCBkaXJlY3Rpb24sJC5FdmVudCggZGlyZWN0aW9uLCB7IHRhcmdldDogb3JpZ1RhcmdldCwgc3dpcGVzdGFydDogc3RhcnQsIHN3aXBlc3RvcDogc3RvcCB9ICkgKTsKCQkJCXJldHVybiB0cnVlOwoJCQl9CgkJCXJldHVybiBmYWxzZTsKCgkJfSwKCgkJc2V0dXA6IGZ1bmN0aW9uKCkgewoJCQl2YXIgdGhpc09iamVjdCA9IHRoaXMsCgkJCQkkdGhpcyA9ICQoIHRoaXNPYmplY3QgKTsKCgkJCSR0aGlzLmJpbmQoIHRvdWNoU3RhcnRFdmVudCwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJdmFyIHN0b3AsCgkJCQkJc3RhcnQgPSAkLmV2ZW50LnNwZWNpYWwuc3dpcGUuc3RhcnQoIGV2ZW50ICksCgkJCQkJb3JpZ1RhcmdldCA9IGV2ZW50LnRhcmdldCwKCQkJCQllbWl0dGVkID0gZmFsc2U7CgoJCQkJZnVuY3Rpb24gbW92ZUhhbmRsZXIoIGV2ZW50ICkgewoJCQkJCWlmICggIXN0YXJ0ICkgewoJCQkJCQlyZXR1cm47CgkJCQkJfQoKCQkJCQlzdG9wID0gJC5ldmVudC5zcGVjaWFsLnN3aXBlLnN0b3AoIGV2ZW50ICk7CgkJCQkJaWYgKCAhZW1pdHRlZCApewoJCQkJCQllbWl0dGVkID0gJC5ldmVudC5zcGVjaWFsLnN3aXBlLmhhbmRsZVN3aXBlKCBzdGFydCwgc3RvcCwgdGhpc09iamVjdCwgb3JpZ1RhcmdldCApOwoJCQkJCX0KCQkJCQkvLyBwcmV2ZW50IHNjcm9sbGluZwoJCQkJCWlmICggTWF0aC5hYnMoIHN0YXJ0LmNvb3Jkc1sgMCBdIC0gc3RvcC5jb29yZHNbIDAgXSApID4gJC5ldmVudC5zcGVjaWFsLnN3aXBlLnNjcm9sbFN1cHJlc3Npb25UaHJlc2hvbGQgKSB7CgkJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQkJfQoJCQkJfQoKCQkJCSR0aGlzLmJpbmQoIHRvdWNoTW92ZUV2ZW50LCBtb3ZlSGFuZGxlciApCgkJCQkJLm9uZSggdG91Y2hTdG9wRXZlbnQsIGZ1bmN0aW9uKCkgewoJCQkJCQllbWl0dGVkID0gdHJ1ZTsKCQkJCQkJJHRoaXMudW5iaW5kKCB0b3VjaE1vdmVFdmVudCwgbW92ZUhhbmRsZXIgKTsKCQkJCX0pOwoJCQl9KTsKCQl9LAoKCQl0ZWFyZG93bjogZnVuY3Rpb24oKSB7CgkJCSQoIHRoaXMgKS51bmJpbmQoIHRvdWNoU3RhcnRFdmVudCApLnVuYmluZCggdG91Y2hNb3ZlRXZlbnQgKS51bmJpbmQoIHRvdWNoU3RvcEV2ZW50ICk7CgkJfQoJfTsKCSQuZWFjaCh7CgkJc2Nyb2xsc3RvcDogInNjcm9sbHN0YXJ0IiwKCQl0YXBob2xkOiAidGFwIiwKCQlzd2lwZWxlZnQ6ICJzd2lwZSIsCgkJc3dpcGVyaWdodDogInN3aXBlIgoJfSwgZnVuY3Rpb24oIGV2ZW50LCBzb3VyY2VFdmVudCApIHsKCgkJJC5ldmVudC5zcGVjaWFsWyBldmVudCBdID0gewoJCQlzZXR1cDogZnVuY3Rpb24oKSB7CgkJCQkkKCB0aGlzICkuYmluZCggc291cmNlRXZlbnQsICQubm9vcCApOwoJCQl9LAoJCQl0ZWFyZG93bjogZnVuY3Rpb24oKSB7CgkJCQkkKCB0aGlzICkudW5iaW5kKCBzb3VyY2VFdmVudCApOwoJCQl9CgkJfTsKCX0pOwoKfSkoIGpRdWVyeSwgdGhpcyApOwoKCgkvLyB0aHJvdHRsZWQgcmVzaXplIGV2ZW50CgkoZnVuY3Rpb24oICQgKSB7CgkJJC5ldmVudC5zcGVjaWFsLnRocm90dGxlZHJlc2l6ZSA9IHsKCQkJc2V0dXA6IGZ1bmN0aW9uKCkgewoJCQkJJCggdGhpcyApLmJpbmQoICJyZXNpemUiLCBoYW5kbGVyICk7CgkJCX0sCgkJCXRlYXJkb3duOiBmdW5jdGlvbigpIHsKCQkJCSQoIHRoaXMgKS51bmJpbmQoICJyZXNpemUiLCBoYW5kbGVyICk7CgkJCX0KCQl9OwoKCQl2YXIgdGhyb3R0bGUgPSAyNTAsCgkJCWhhbmRsZXIgPSBmdW5jdGlvbigpIHsKCQkJCWN1cnIgPSAoIG5ldyBEYXRlKCkgKS5nZXRUaW1lKCk7CgkJCQlkaWZmID0gY3VyciAtIGxhc3RDYWxsOwoKCQkJCWlmICggZGlmZiA+PSB0aHJvdHRsZSApIHsKCgkJCQkJbGFzdENhbGwgPSBjdXJyOwoJCQkJCSQoIHRoaXMgKS50cmlnZ2VyKCAidGhyb3R0bGVkcmVzaXplIiApOwoKCQkJCX0gZWxzZSB7CgoJCQkJCWlmICggaGVsZENhbGwgKSB7CgkJCQkJCWNsZWFyVGltZW91dCggaGVsZENhbGwgKTsKCQkJCQl9CgoJCQkJCS8vIFByb21pc2UgYSBoZWxkIGNhbGwgd2lsbCBzdGlsbCBleGVjdXRlCgkJCQkJaGVsZENhbGwgPSBzZXRUaW1lb3V0KCBoYW5kbGVyLCB0aHJvdHRsZSAtIGRpZmYgKTsKCQkJCX0KCQkJfSwKCQkJbGFzdENhbGwgPSAwLAoJCQloZWxkQ2FsbCwKCQkJY3VyciwKCQkJZGlmZjsKCX0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgd2luZG93ICkgewoJdmFyIHdpbiA9ICQoIHdpbmRvdyApLAoJCWV2ZW50X25hbWUgPSAib3JpZW50YXRpb25jaGFuZ2UiLAoJCWdldF9vcmllbnRhdGlvbiwKCQlsYXN0X29yaWVudGF0aW9uLAoJCWluaXRpYWxfb3JpZW50YXRpb25faXNfbGFuZHNjYXBlLAoJCWluaXRpYWxfb3JpZW50YXRpb25faXNfZGVmYXVsdCwKCQlwb3J0cmFpdF9tYXAgPSB7ICIwIjogdHJ1ZSwgIjE4MCI6IHRydWUgfSwKCQl3dywgd2gsIGxhbmRzY2FwZV90aHJlc2hvbGQ7CgoJLy8gSXQgc2VlbXMgdGhhdCBzb21lIGRldmljZS9icm93c2VyIHZlbmRvcnMgdXNlIHdpbmRvdy5vcmllbnRhdGlvbiB2YWx1ZXMgMCBhbmQgMTgwIHRvCgkvLyBkZW5vdGUgdGhlICJkZWZhdWx0IiBvcmllbnRhdGlvbi4gRm9yIGlPUyBkZXZpY2VzLCBhbmQgbW9zdCBvdGhlciBzbWFydC1waG9uZXMgdGVzdGVkLAoJLy8gdGhlIGRlZmF1bHQgb3JpZW50YXRpb24gaXMgYWx3YXlzICJwb3J0cmFpdCIsIGJ1dCBpbiBzb21lIEFuZHJvaWQgYW5kIFJJTSBiYXNlZCB0YWJsZXRzLAoJLy8gdGhlIGRlZmF1bHQgb3JpZW50YXRpb24gaXMgImxhbmRzY2FwZSIuIFRoZSBmb2xsb3dpbmcgY29kZSBhdHRlbXB0cyB0byB1c2UgdGhlIHdpbmRvdwoJLy8gZGltZW5zaW9ucyB0byBmaWd1cmUgb3V0IHdoYXQgdGhlIGN1cnJlbnQgb3JpZW50YXRpb24gaXMsIGFuZCB0aGVuIG1ha2VzIGFkanVzdG1lbnRzCgkvLyB0byB0aGUgdG8gdGhlIHBvcnRyYWl0X21hcCBpZiBuZWNlc3NhcnksIHNvIHRoYXQgd2UgY2FuIHByb3Blcmx5IGRlY29kZSB0aGUKCS8vIHdpbmRvdy5vcmllbnRhdGlvbiB2YWx1ZSB3aGVuZXZlciBnZXRfb3JpZW50YXRpb24oKSBpcyBjYWxsZWQuCgkvLwoJLy8gTm90ZSB0aGF0IHdlIHVzZWQgdG8gdXNlIGEgbWVkaWEgcXVlcnkgdG8gZmlndXJlIG91dCB3aGF0IHRoZSBvcmllbnRhdGlvbiB0aGUgYnJvd3NlcgoJLy8gdGhpbmtzIGl0IGlzIGluOgoJLy8KCS8vICAgICBpbml0aWFsX29yaWVudGF0aW9uX2lzX2xhbmRzY2FwZSA9ICQubW9iaWxlLm1lZGlhKCJhbGwgYW5kIChvcmllbnRhdGlvbjogbGFuZHNjYXBlKSIpOwoJLy8KCS8vIGJ1dCB0aGVyZSB3YXMgYW4gaVBob25lL2lQb2QgVG91Y2ggYnVnIGJlZ2lubmluZyB3aXRoIGlPUyA0LjIsIHVwIHRocm91Z2ggaU9TIDUuMSwKCS8vIHdoZXJlIHRoZSBicm93c2VyICpBTFdBWVMqIGFwcGxpZWQgdGhlIGxhbmRzY2FwZSBtZWRpYSBxdWVyeS4gVGhpcyBidWcgZG9lcyBub3QKCS8vIGhhcHBlbiBvbiBpUGFkLgoKCWlmICggJC5zdXBwb3J0Lm9yaWVudGF0aW9uICkgewoKCQkvLyBDaGVjayB0aGUgd2luZG93IHdpZHRoIGFuZCBoZWlnaHQgdG8gZmlndXJlIG91dCB3aGF0IHRoZSBjdXJyZW50IG9yaWVudGF0aW9uCgkJLy8gb2YgdGhlIGRldmljZSBpcyBhdCB0aGlzIG1vbWVudC4gTm90ZSB0aGF0IHdlJ3ZlIGluaXRpYWxpemVkIHRoZSBwb3J0cmFpdCBtYXAKCQkvLyB2YWx1ZXMgdG8gMCBhbmQgMTgwLCAqQU5EKiB3ZSBwdXJwb3NlbHkgY2hlY2sgZm9yIGxhbmRzY2FwZSBzbyB0aGF0IGlmIHdlIGd1ZXNzCgkJLy8gd3JvbmcsICwgd2UgZGVmYXVsdCB0byB0aGUgYXNzdW1wdGlvbiB0aGF0IHBvcnRyYWl0IGlzIHRoZSBkZWZhdWx0IG9yaWVudGF0aW9uLgoJCS8vIFdlIHVzZSBhIHRocmVzaG9sZCBjaGVjayBiZWxvdyBiZWNhdXNlIG9uIHNvbWUgcGxhdGZvcm1zIGxpa2UgaU9TLCB0aGUgaVBob25lCgkJLy8gZm9ybS1mYWN0b3IgY2FuIHJlcG9ydCBhIGxhcmdlciB3aWR0aCB0aGFuIGhlaWdodCBpZiB0aGUgdXNlciB0dXJucyBvbiB0aGUKCQkvLyBkZXZlbG9wZXIgY29uc29sZS4gVGhlIGFjdHVhbCB0aHJlc2hvbGQgdmFsdWUgaXMgc29tZXdoYXQgYXJiaXRyYXJ5LCB3ZSBqdXN0CgkJLy8gbmVlZCB0byBtYWtlIHN1cmUgaXQgaXMgbGFyZ2UgZW5vdWdoIHRvIGV4Y2x1ZGUgdGhlIGRldmVsb3BlciBjb25zb2xlIGNhc2UuCgoJCXd3ID0gd2luZG93LmlubmVyV2lkdGggfHwgd2luLndpZHRoKCk7CgkJd2ggPSB3aW5kb3cuaW5uZXJIZWlnaHQgfHwgd2luLmhlaWdodCgpOwoJCWxhbmRzY2FwZV90aHJlc2hvbGQgPSA1MDsKCgkJaW5pdGlhbF9vcmllbnRhdGlvbl9pc19sYW5kc2NhcGUgPSB3dyA+IHdoICYmICggd3cgLSB3aCApID4gbGFuZHNjYXBlX3RocmVzaG9sZDsKCgoJCS8vIE5vdyBjaGVjayB0byBzZWUgaWYgdGhlIGN1cnJlbnQgd2luZG93Lm9yaWVudGF0aW9uIGlzIDAgb3IgMTgwLgoJCWluaXRpYWxfb3JpZW50YXRpb25faXNfZGVmYXVsdCA9IHBvcnRyYWl0X21hcFsgd2luZG93Lm9yaWVudGF0aW9uIF07CgoJCS8vIElmIHRoZSBpbml0aWFsIG9yaWVudGF0aW9uIGlzIGxhbmRzY2FwZSwgYnV0IHdpbmRvdy5vcmllbnRhdGlvbiByZXBvcnRzIDAgb3IgMTgwLCAqT1IqCgkJLy8gaWYgdGhlIGluaXRpYWwgb3JpZW50YXRpb24gaXMgcG9ydHJhaXQsIGJ1dCB3aW5kb3cub3JpZW50YXRpb24gcmVwb3J0cyA5MCBvciAtOTAsIHdlCgkJLy8gbmVlZCB0byBmbGlwIG91ciBwb3J0cmFpdF9tYXAgdmFsdWVzIGJlY2F1c2UgbGFuZHNjYXBlIGlzIHRoZSBkZWZhdWx0IG9yaWVudGF0aW9uIGZvcgoJCS8vIHRoaXMgZGV2aWNlL2Jyb3dzZXIuCgkJaWYgKCAoIGluaXRpYWxfb3JpZW50YXRpb25faXNfbGFuZHNjYXBlICYmIGluaXRpYWxfb3JpZW50YXRpb25faXNfZGVmYXVsdCApIHx8ICggIWluaXRpYWxfb3JpZW50YXRpb25faXNfbGFuZHNjYXBlICYmICFpbml0aWFsX29yaWVudGF0aW9uX2lzX2RlZmF1bHQgKSApIHsKCQkJcG9ydHJhaXRfbWFwID0geyAiLTkwIjogdHJ1ZSwgIjkwIjogdHJ1ZSB9OwoJCX0KCX0KCgkkLmV2ZW50LnNwZWNpYWwub3JpZW50YXRpb25jaGFuZ2UgPSAkLmV4dGVuZCgge30sICQuZXZlbnQuc3BlY2lhbC5vcmllbnRhdGlvbmNoYW5nZSwgewoJCXNldHVwOiBmdW5jdGlvbigpIHsKCQkJLy8gSWYgdGhlIGV2ZW50IGlzIHN1cHBvcnRlZCBuYXRpdmVseSwgcmV0dXJuIGZhbHNlIHNvIHRoYXQgalF1ZXJ5CgkJCS8vIHdpbGwgYmluZCB0byB0aGUgZXZlbnQgdXNpbmcgRE9NIG1ldGhvZHMuCgkJCWlmICggJC5zdXBwb3J0Lm9yaWVudGF0aW9uICYmICEkLmV2ZW50LnNwZWNpYWwub3JpZW50YXRpb25jaGFuZ2UuZGlzYWJsZWQgKSB7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCgkJCS8vIEdldCB0aGUgY3VycmVudCBvcmllbnRhdGlvbiB0byBhdm9pZCBpbml0aWFsIGRvdWJsZS10cmlnZ2VyaW5nLgoJCQlsYXN0X29yaWVudGF0aW9uID0gZ2V0X29yaWVudGF0aW9uKCk7CgoJCQkvLyBCZWNhdXNlIHRoZSBvcmllbnRhdGlvbmNoYW5nZSBldmVudCBkb2Vzbid0IGV4aXN0LCBzaW11bGF0ZSB0aGUKCQkJLy8gZXZlbnQgYnkgdGVzdGluZyB3aW5kb3cgZGltZW5zaW9ucyBvbiByZXNpemUuCgkJCXdpbi5iaW5kKCAidGhyb3R0bGVkcmVzaXplIiwgaGFuZGxlciApOwoJCX0sCgkJdGVhcmRvd246IGZ1bmN0aW9uKCkgewoJCQkvLyBJZiB0aGUgZXZlbnQgaXMgbm90IHN1cHBvcnRlZCBuYXRpdmVseSwgcmV0dXJuIGZhbHNlIHNvIHRoYXQKCQkJLy8galF1ZXJ5IHdpbGwgdW5iaW5kIHRoZSBldmVudCB1c2luZyBET00gbWV0aG9kcy4KCQkJaWYgKCAkLnN1cHBvcnQub3JpZW50YXRpb24gJiYgISQuZXZlbnQuc3BlY2lhbC5vcmllbnRhdGlvbmNoYW5nZS5kaXNhYmxlZCApIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoKCQkJLy8gQmVjYXVzZSB0aGUgb3JpZW50YXRpb25jaGFuZ2UgZXZlbnQgZG9lc24ndCBleGlzdCwgdW5iaW5kIHRoZQoJCQkvLyByZXNpemUgZXZlbnQgaGFuZGxlci4KCQkJd2luLnVuYmluZCggInRocm90dGxlZHJlc2l6ZSIsIGhhbmRsZXIgKTsKCQl9LAoJCWFkZDogZnVuY3Rpb24oIGhhbmRsZU9iaiApIHsKCQkJLy8gU2F2ZSBhIHJlZmVyZW5jZSB0byB0aGUgYm91bmQgZXZlbnQgaGFuZGxlci4KCQkJdmFyIG9sZF9oYW5kbGVyID0gaGFuZGxlT2JqLmhhbmRsZXI7CgoKCQkJaGFuZGxlT2JqLmhhbmRsZXIgPSBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkvLyBNb2RpZnkgZXZlbnQgb2JqZWN0LCBhZGRpbmcgdGhlIC5vcmllbnRhdGlvbiBwcm9wZXJ0eS4KCQkJCWV2ZW50Lm9yaWVudGF0aW9uID0gZ2V0X29yaWVudGF0aW9uKCk7CgoJCQkJLy8gQ2FsbCB0aGUgb3JpZ2luYWxseS1ib3VuZCBldmVudCBoYW5kbGVyIGFuZCByZXR1cm4gaXRzIHJlc3VsdC4KCQkJCXJldHVybiBvbGRfaGFuZGxlci5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgkJCX07CgkJfQoJfSk7CgoJLy8gSWYgdGhlIGV2ZW50IGlzIG5vdCBzdXBwb3J0ZWQgbmF0aXZlbHksIHRoaXMgaGFuZGxlciB3aWxsIGJlIGJvdW5kIHRvCgkvLyB0aGUgd2luZG93IHJlc2l6ZSBldmVudCB0byBzaW11bGF0ZSB0aGUgb3JpZW50YXRpb25jaGFuZ2UgZXZlbnQuCglmdW5jdGlvbiBoYW5kbGVyKCkgewoJCS8vIEdldCB0aGUgY3VycmVudCBvcmllbnRhdGlvbi4KCQl2YXIgb3JpZW50YXRpb24gPSBnZXRfb3JpZW50YXRpb24oKTsKCgkJaWYgKCBvcmllbnRhdGlvbiAhPT0gbGFzdF9vcmllbnRhdGlvbiApIHsKCQkJLy8gVGhlIG9yaWVudGF0aW9uIGhhcyBjaGFuZ2VkLCBzbyB0cmlnZ2VyIHRoZSBvcmllbnRhdGlvbmNoYW5nZSBldmVudC4KCQkJbGFzdF9vcmllbnRhdGlvbiA9IG9yaWVudGF0aW9uOwoJCQl3aW4udHJpZ2dlciggZXZlbnRfbmFtZSApOwoJCX0KCX0KCgkvLyBHZXQgdGhlIGN1cnJlbnQgcGFnZSBvcmllbnRhdGlvbi4gVGhpcyBtZXRob2QgaXMgZXhwb3NlZCBwdWJsaWNseSwgc2hvdWxkIGl0CgkvLyBiZSBuZWVkZWQsIGFzIGpRdWVyeS5ldmVudC5zcGVjaWFsLm9yaWVudGF0aW9uY2hhbmdlLm9yaWVudGF0aW9uKCkKCSQuZXZlbnQuc3BlY2lhbC5vcmllbnRhdGlvbmNoYW5nZS5vcmllbnRhdGlvbiA9IGdldF9vcmllbnRhdGlvbiA9IGZ1bmN0aW9uKCkgewoJCXZhciBpc1BvcnRyYWl0ID0gdHJ1ZSwgZWxlbSA9IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudDsKCgkJLy8gcHJlZmVyIHdpbmRvdyBvcmllbnRhdGlvbiB0byB0aGUgY2FsY3VsYXRpb24gYmFzZWQgb24gc2NyZWVuc2l6ZSBhcwoJCS8vIHRoZSBhY3R1YWwgc2NyZWVuIHJlc2l6ZSB0YWtlcyBwbGFjZSBiZWZvcmUgb3IgYWZ0ZXIgdGhlIG9yaWVudGF0aW9uIGNoYW5nZSBldmVudAoJCS8vIGhhcyBiZWVuIGZpcmVkIGRlcGVuZGluZyBvbiBpbXBsZW1lbnRhdGlvbiAoZWcgYW5kcm9pZCAyLjMgaXMgYmVmb3JlLCBpcGhvbmUgYWZ0ZXIpLgoJCS8vIE1vcmUgdGVzdGluZyBpcyByZXF1aXJlZCB0byBkZXRlcm1pbmUgaWYgYSBtb3JlIHJlbGlhYmxlIG1ldGhvZCBvZiBkZXRlcm1pbmluZyB0aGUgbmV3IHNjcmVlbnNpemUKCQkvLyBpcyBwb3NzaWJsZSB3aGVuIG9yaWVudGF0aW9uY2hhbmdlIGlzIGZpcmVkLiAoZWcsIHVzZSBtZWRpYSBxdWVyaWVzICsgZWxlbWVudCArIG9wYWNpdHkpCgkJaWYgKCAkLnN1cHBvcnQub3JpZW50YXRpb24gKSB7CgkJCS8vIGlmIHRoZSB3aW5kb3cgb3JpZW50YXRpb24gcmVnaXN0ZXJzIGFzIDAgb3IgMTgwIGRlZ3JlZXMgcmVwb3J0CgkJCS8vIHBvcnRyYWl0LCBvdGhlcndpc2UgbGFuZHNjYXBlCgkJCWlzUG9ydHJhaXQgPSBwb3J0cmFpdF9tYXBbIHdpbmRvdy5vcmllbnRhdGlvbiBdOwoJCX0gZWxzZSB7CgkJCWlzUG9ydHJhaXQgPSBlbGVtICYmIGVsZW0uY2xpZW50V2lkdGggLyBlbGVtLmNsaWVudEhlaWdodCA8IDEuMTsKCQl9CgoJCXJldHVybiBpc1BvcnRyYWl0ID8gInBvcnRyYWl0IiA6ICJsYW5kc2NhcGUiOwoJfTsKCgkkLmZuWyBldmVudF9uYW1lIF0gPSBmdW5jdGlvbiggZm4gKSB7CgkJcmV0dXJuIGZuID8gdGhpcy5iaW5kKCBldmVudF9uYW1lLCBmbiApIDogdGhpcy50cmlnZ2VyKCBldmVudF9uYW1lICk7Cgl9OwoKCS8vIGpRdWVyeSA8IDEuOAoJaWYgKCAkLmF0dHJGbiApIHsKCQkkLmF0dHJGblsgZXZlbnRfbmFtZSBdID0gdHJ1ZTsKCX0KCn0oIGpRdWVyeSwgdGhpcyApKTsKCgoKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKCS8vIGV4aXN0aW5nIGJhc2UgdGFnPwoJdmFyIGJhc2VFbGVtZW50ID0gJCggImhlYWQiICkuY2hpbGRyZW4oICJiYXNlIiApLAoKCS8vIGJhc2UgZWxlbWVudCBtYW5hZ2VtZW50LCBkZWZpbmVkIGRlcGVuZGluZyBvbiBkeW5hbWljIGJhc2UgdGFnIHN1cHBvcnQKCS8vIFRPRE8gbW92ZSB0byBleHRlcm5hbCB3aWRnZXQKCWJhc2UgPSB7CgoJCS8vIGRlZmluZSBiYXNlIGVsZW1lbnQsIGZvciB1c2UgaW4gcm91dGluZyBhc3NldCB1cmxzIHRoYXQgYXJlIHJlZmVyZW5jZWQKCQkvLyBpbiBBamF4LXJlcXVlc3RlZCBtYXJrdXAKCQllbGVtZW50OiAoIGJhc2VFbGVtZW50Lmxlbmd0aCA/IGJhc2VFbGVtZW50IDoKCQkJJCggIjxiYXNlPiIsIHsgaHJlZjogJC5tb2JpbGUucGF0aC5kb2N1bWVudEJhc2UuaHJlZk5vSGFzaCB9ICkucHJlcGVuZFRvKCAkKCAiaGVhZCIgKSApICksCgoJCWxpbmtTZWxlY3RvcjogIltzcmNdLCBsaW5rW2hyZWZdLCBhW3JlbD0nZXh0ZXJuYWwnXSwgOmpxbURhdGEoYWpheD0nZmFsc2UnKSwgYVt0YXJnZXRdIiwKCgkJLy8gc2V0IHRoZSBnZW5lcmF0ZWQgQkFTRSBlbGVtZW50J3MgaHJlZiB0byBhIG5ldyBwYWdlJ3MgYmFzZSBwYXRoCgkJc2V0OiBmdW5jdGlvbiggaHJlZiApIHsKCgkJCS8vIHdlIHNob3VsZCBkbyBub3RoaW5nIGlmIHRoZSB1c2VyIHdhbnRzIHRvIG1hbmFnZSB0aGVpciB1cmwgYmFzZQoJCQkvLyBtYW51YWxseQoJCQlpZiAoICEkLm1vYmlsZS5keW5hbWljQmFzZUVuYWJsZWQgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIHdlIHNob3VsZCB1c2UgdGhlIGJhc2UgdGFnIGlmIHdlIGNhbiBtYW5pcHVsYXRlIGl0IGR5bmFtaWNhbGx5CgkJCWlmICggJC5zdXBwb3J0LmR5bmFtaWNCYXNlVGFnICkgewoJCQkJYmFzZS5lbGVtZW50LmF0dHIoICJocmVmIiwKCQkJCQkkLm1vYmlsZS5wYXRoLm1ha2VVcmxBYnNvbHV0ZSggaHJlZiwgJC5tb2JpbGUucGF0aC5kb2N1bWVudEJhc2UgKSApOwoJCQl9CgkJfSwKCgkJcmV3cml0ZTogZnVuY3Rpb24oIGhyZWYsIHBhZ2UgKSB7CgkJCXZhciBuZXdQYXRoID0gJC5tb2JpbGUucGF0aC5nZXQoIGhyZWYgKTsKCgkJCXBhZ2UuZmluZCggYmFzZS5saW5rU2VsZWN0b3IgKS5lYWNoKGZ1bmN0aW9uKCBpLCBsaW5rICkgewoJCQkJdmFyIHRoaXNBdHRyID0gJCggbGluayApLmlzKCAiW2hyZWZdIiApID8gImhyZWYiIDoKCQkJCQkkKCBsaW5rICkuaXMoICJbc3JjXSIgKSA/ICJzcmMiIDogImFjdGlvbiIsCgkJCQl0aGlzVXJsID0gJCggbGluayApLmF0dHIoIHRoaXNBdHRyICk7CgoJCQkJLy8gWFhYX2pibGFzOiBXZSBuZWVkIHRvIGZpeCB0aGlzIHNvIHRoYXQgaXQgcmVtb3ZlcyB0aGUgZG9jdW1lbnQKCQkJCS8vICAgICAgICAgICAgYmFzZSBVUkwsIGFuZCB0aGVuIHByZXBlbmRzIHdpdGggdGhlIG5ldyBwYWdlIFVSTC4KCQkJCS8vIGlmIGZ1bGwgcGF0aCBleGlzdHMgYW5kIGlzIHNhbWUsIGNob3AgaXQgLSBoZWxwcyBJRSBvdXQKCQkJCXRoaXNVcmwgPSB0aGlzVXJsLnJlcGxhY2UoIGxvY2F0aW9uLnByb3RvY29sICsgIi8vIiArCgkJCQkJbG9jYXRpb24uaG9zdCArIGxvY2F0aW9uLnBhdGhuYW1lLCAiIiApOwoKCQkJCWlmICggIS9eKFx3Kzp8I3xcLykvLnRlc3QoIHRoaXNVcmwgKSApIHsKCQkJCQkkKCBsaW5rICkuYXR0ciggdGhpc0F0dHIsIG5ld1BhdGggKyB0aGlzVXJsICk7CgkJCQl9CgkJCX0pOwoJCX0sCgoJCS8vIHNldCB0aGUgZ2VuZXJhdGVkIEJBU0UgZWxlbWVudCdzIGhyZWYgdG8gYSBuZXcgcGFnZSdzIGJhc2UgcGF0aAoJCXJlc2V0OiBmdW5jdGlvbigvKiBocmVmICovKSB7CgkJCWJhc2UuZWxlbWVudC5hdHRyKCAiaHJlZiIsICQubW9iaWxlLnBhdGguZG9jdW1lbnRCYXNlLmhyZWZOb1NlYXJjaCApOwoJCX0KCX07CgoJJC5tb2JpbGUuYmFzZSA9IGJhc2U7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKJC5tb2JpbGUud2lkZ2V0cyA9IHt9OwoKdmFyIG9yaWdpbmFsV2lkZ2V0ID0gJC53aWRnZXQsCgoJLy8gUmVjb3JkIHRoZSBvcmlnaW5hbCwgbm9uLW1vYmlsZWluaXQtbW9kaWZpZWQgdmVyc2lvbiBvZiAkLm1vYmlsZS5rZWVwTmF0aXZlCgkvLyBzbyB3ZSBjYW4gbGF0ZXIgZGV0ZXJtaW5lIHdoZXRoZXIgc29tZW9uZSBoYXMgbW9kaWZpZWQgJC5tb2JpbGUua2VlcE5hdGl2ZQoJa2VlcE5hdGl2ZUZhY3RvcnlEZWZhdWx0ID0gJC5tb2JpbGUua2VlcE5hdGl2ZTsKCiQud2lkZ2V0ID0gKGZ1bmN0aW9uKCBvcmlnICkgewoJcmV0dXJuIGZ1bmN0aW9uKCkgewoJCXZhciBjb25zdHJ1Y3RvciA9IG9yaWcuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApLAoJCQluYW1lID0gY29uc3RydWN0b3IucHJvdG90eXBlLndpZGdldE5hbWU7CgoJCWNvbnN0cnVjdG9yLmluaXRTZWxlY3RvciA9ICggKCBjb25zdHJ1Y3Rvci5wcm90b3R5cGUuaW5pdFNlbGVjdG9yICE9PSB1bmRlZmluZWQgKSA/CgkJCWNvbnN0cnVjdG9yLnByb3RvdHlwZS5pbml0U2VsZWN0b3IgOiAiOmpxbURhdGEocm9sZT0nIiArIG5hbWUgKyAiJykiICk7CgoJCSQubW9iaWxlLndpZGdldHNbIG5hbWUgXSA9IGNvbnN0cnVjdG9yOwoKCQlyZXR1cm4gY29uc3RydWN0b3I7Cgl9Owp9KSggJC53aWRnZXQgKTsKCi8vIE1ha2Ugc3VyZSAkLndpZGdldCBzdGlsbCBoYXMgYnJpZGdlIGFuZCBleHRlbmQgbWV0aG9kcwokLmV4dGVuZCggJC53aWRnZXQsIG9yaWdpbmFsV2lkZ2V0ICk7CgovLyBGb3IgYmFja2NvbXBhdCByZW1vdmUgaW4gMS41CiQubW9iaWxlLmRvY3VtZW50Lm9uKCAiY3JlYXRlIiwgZnVuY3Rpb24oIGV2ZW50ICl7CgkkKCBldmVudC50YXJnZXQgKS5lbmhhbmNlV2l0aGluKCk7Cn0pOwoKJC53aWRnZXQoICJtb2JpbGUucGFnZSIsIHsKCW9wdGlvbnM6IHsKCQl0aGVtZTogImEiLAoJCWRvbUNhY2hlOiBmYWxzZSwKCgkJLy8gRGVwcmVjYXRlZCBpbiAxLjQgcmVtb3ZlIGluIDEuNQoJCWtlZXBOYXRpdmVEZWZhdWx0OiAkLm1vYmlsZS5rZWVwTmF0aXZlLAoJCWNvbnRlbnRUaGVtZTogbnVsbCwKCQllbmhhbmNlZDogZmFsc2UKCX0sCgoJLy8gREVQUkVDQVRFRCBmb3IgPiAxLjQKCS8vIFRPRE8gcmVtb3ZlIGF0IDEuNQoJX2NyZWF0ZVdpZGdldDogZnVuY3Rpb24oKSB7CgkJJC5XaWRnZXQucHJvdG90eXBlLl9jcmVhdGVXaWRnZXQuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwoJCXRoaXMuX3RyaWdnZXIoICJpbml0IiApOwoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQkvLyBJZiBmYWxzZSBpcyByZXR1cm5lZCBieSB0aGUgY2FsbGJhY2tzIGRvIG5vdCBjcmVhdGUgdGhlIHBhZ2UKCQlpZiAoIHRoaXMuX3RyaWdnZXIoICJiZWZvcmVjcmVhdGUiICkgPT09IGZhbHNlICkgewoJCQlyZXR1cm4gZmFsc2U7CgkJfQoKCQlpZiAoICF0aGlzLm9wdGlvbnMuZW5oYW5jZWQgKSB7CgkJCXRoaXMuX2VuaGFuY2UoKTsKCQl9CgoJCXRoaXMuX29uKCB0aGlzLmVsZW1lbnQsIHsKCQkJcGFnZWJlZm9yZWhpZGU6ICJyZW1vdmVDb250YWluZXJCYWNrZ3JvdW5kIiwKCQkJcGFnZWJlZm9yZXNob3c6ICJfaGFuZGxlUGFnZUJlZm9yZVNob3ciCgkJfSk7CgoJCXRoaXMuZWxlbWVudC5lbmhhbmNlV2l0aGluKCk7CgkJLy8gRGlhbG9nIHdpZGdldCBpcyBkZXByZWNhdGVkIGluIDEuNCByZW1vdmUgdGhpcyBpbiAxLjUKCQlpZiggJC5tb2JpbGUuZ2V0QXR0cmlidXRlKCB0aGlzLmVsZW1lbnRbMF0sICJyb2xlIiApID09PSAiZGlhbG9nIiAmJiAkLm1vYmlsZS5kaWFsb2cgKXsKCQkJdGhpcy5lbGVtZW50LmRpYWxvZygpOwoJCX0KCX0sCgoJX2VuaGFuY2U6IGZ1bmN0aW9uICgpewoJCXZhciBhdHRyUHJlZml4ID0gImRhdGEtIiArICQubW9iaWxlLm5zLAoJCQlzZWxmID0gdGhpczsKCgkJaWYgKCB0aGlzLm9wdGlvbnMucm9sZSApIHsKCQkJdGhpcy5lbGVtZW50LmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyb2xlIiwgdGhpcy5vcHRpb25zLnJvbGUgKTsKCQl9CgoJCXRoaXMuZWxlbWVudAoJCQkuYXR0ciggInRhYmluZGV4IiwgIjAiICkKCQkJLmFkZENsYXNzKCAidWktcGFnZSB1aS1wYWdlLXRoZW1lLSIgKyB0aGlzLm9wdGlvbnMudGhlbWUgKTsKCgkJLy8gTWFuaXB1bGF0aW9uIG9mIGNvbnRlbnQgb3MgRGVwcmVjYXRlZCBhcyBvZiAxLjQgcmVtb3ZlIGluIDEuNQoJCXRoaXMuZWxlbWVudC5maW5kKCAiWyIgKyBhdHRyUHJlZml4ICsgInJvbGU9J2NvbnRlbnQnXSIgKS5lYWNoKCBmdW5jdGlvbigpIHsKCQkJdmFyICR0aGlzID0gJCggdGhpcyApLAoJCQkJdGhlbWUgPSB0aGlzLmdldEF0dHJpYnV0ZSggYXR0clByZWZpeCArICJ0aGVtZSIgKSB8fCB1bmRlZmluZWQ7CgkJCQlzZWxmLm9wdGlvbnMuY29udGVudFRoZW1lID0gdGhlbWUgfHwgc2VsZi5vcHRpb25zLmNvbnRlbnRUaGVtZSB8fCAoIHNlbGYub3B0aW9ucy5kaWFsb2cgJiYgc2VsZi5vcHRpb25zLnRoZW1lICkgfHwgKCBzZWxmLmVsZW1lbnQuanFtRGF0YSgicm9sZSIpID09PSAiZGlhbG9nIiAmJiAgc2VsZi5vcHRpb25zLnRoZW1lICk7CgkJCQkkdGhpcy5hZGRDbGFzcyggInVpLWNvbnRlbnQiICk7CgkJCQlpZiAoIHNlbGYub3B0aW9ucy5jb250ZW50VGhlbWUgKSB7CgkJCQkJJHRoaXMuYWRkQ2xhc3MoICJ1aS1ib2R5LSIgKyAoIHNlbGYub3B0aW9ucy5jb250ZW50VGhlbWUgKSApOwoJCQkJfQoJCQkJLy8gQWRkIEFSSUEgcm9sZQoJCQkJJHRoaXMuYXR0ciggInJvbGUiLCAibWFpbiIgKS5hZGRDbGFzcyggInVpLWNvbnRlbnQiICk7CgkJfSk7Cgl9LAoKCWJpbmRSZW1vdmU6IGZ1bmN0aW9uKCBjYWxsYmFjayApIHsKCQl2YXIgcGFnZSA9IHRoaXMuZWxlbWVudDsKCgkJLy8gd2hlbiBkb20gY2FjaGluZyBpcyBub3QgZW5hYmxlZCBvciB0aGUgcGFnZSBpcyBlbWJlZGRlZCBiaW5kIHRvIHJlbW92ZSB0aGUgcGFnZSBvbiBoaWRlCgkJaWYgKCAhcGFnZS5kYXRhKCAibW9iaWxlLXBhZ2UiICkub3B0aW9ucy5kb21DYWNoZSAmJgoJCQlwYWdlLmlzKCAiOmpxbURhdGEoZXh0ZXJuYWwtcGFnZT0ndHJ1ZScpIiApICkgewoKCQkJLy8gVE9ETyB1c2UgX29uIC0gdGhhdCBpcywgc29ydCBvdXQgd2h5IGl0IGRvZXNuJ3Qgd29yayBpbiB0aGlzIGNhc2UKCQkJcGFnZS5iaW5kKCAicGFnZWhpZGUucmVtb3ZlIiwgY2FsbGJhY2sgfHwgZnVuY3Rpb24oLyogZSAqLykgewoJCQkJdmFyICR0aGlzID0gJCggdGhpcyApLAoJCQkJCXByRXZlbnQgPSBuZXcgJC5FdmVudCggInBhZ2VyZW1vdmUiICk7CgoJCQkJJHRoaXMudHJpZ2dlciggcHJFdmVudCApOwoKCQkJCWlmICggIXByRXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKSB7CgkJCQkJJHRoaXMucmVtb3ZlV2l0aERlcGVuZGVudHMoKTsKCQkJCX0KCQkJfSk7CgkJfQoJfSwKCglfc2V0T3B0aW9uczogZnVuY3Rpb24oIG8gKSB7CgkJaWYgKCBvLnRoZW1lICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMuZWxlbWVudC5yZW1vdmVDbGFzcyggInVpLWJvZHktIiArIHRoaXMub3B0aW9ucy50aGVtZSApLmFkZENsYXNzKCAidWktYm9keS0iICsgby50aGVtZSApOwoJCX0KCgkJaWYgKCBvLmNvbnRlbnRUaGVtZSAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLmVsZW1lbnQuZmluZCggIltkYXRhLSIgKyAkLm1vYmlsZS5ucyArICI9J2NvbnRlbnQnXSIgKS5yZW1vdmVDbGFzcyggInVpLWJvZHktIiArIHRoaXMub3B0aW9ucy5jb250ZW50VGhlbWUgKQoJCQkJLmFkZENsYXNzKCAidWktYm9keS0iICsgby5jb250ZW50VGhlbWUgKTsKCQl9Cgl9LAoKCV9oYW5kbGVQYWdlQmVmb3JlU2hvdzogZnVuY3Rpb24oLyogZSAqLykgewoJCXRoaXMuc2V0Q29udGFpbmVyQmFja2dyb3VuZCgpOwoJfSwKCS8vIERlcHJlY2F0ZWQgaW4gMS40IHJlbW92ZSBpbiAxLjUKCXJlbW92ZUNvbnRhaW5lckJhY2tncm91bmQ6IGZ1bmN0aW9uKCkgewoJCXRoaXMuZWxlbWVudC5jbG9zZXN0KCAiOm1vYmlsZS1wYWdlY29udGFpbmVyIiApLnBhZ2Vjb250YWluZXIoeyAidGhlbWUiOiAibm9uZSIgfSk7Cgl9LAoJLy8gRGVwcmVjYXRlZCBpbiAxLjQgcmVtb3ZlIGluIDEuNQoJLy8gc2V0IHRoZSBwYWdlIGNvbnRhaW5lciBiYWNrZ3JvdW5kIHRvIHRoZSBwYWdlIHRoZW1lCglzZXRDb250YWluZXJCYWNrZ3JvdW5kOiBmdW5jdGlvbiggdGhlbWUgKSB7CgkJdGhpcy5lbGVtZW50LnBhcmVudCgpLnBhZ2Vjb250YWluZXIoIHsgInRoZW1lIjogdGhlbWUgfHwgdGhpcy5vcHRpb25zLnRoZW1lIH0gKTsKCX0sCgkvLyBEZXByZWNhdGVkIGluIDEuNCByZW1vdmUgaW4gMS41CglrZWVwTmF0aXZlU2VsZWN0b3I6IGZ1bmN0aW9uKCkgewoJCXZhciBvcHRpb25zID0gdGhpcy5vcHRpb25zLAoJCQlrZWVwTmF0aXZlID0gJC50cmltKCBvcHRpb25zLmtlZXBOYXRpdmUgfHwgIiIgKSwKCQkJZ2xvYmFsVmFsdWUgPSAkLnRyaW0oICQubW9iaWxlLmtlZXBOYXRpdmUgKSwKCQkJb3B0aW9uVmFsdWUgPSAkLnRyaW0oIG9wdGlvbnMua2VlcE5hdGl2ZURlZmF1bHQgKSwKCgkJCS8vIENoZWNrIGlmICQubW9iaWxlLmtlZXBOYXRpdmUgaGFzIGNoYW5nZWQgZnJvbSB0aGUgZmFjdG9yeSBkZWZhdWx0CgkJCW5ld0RlZmF1bHQgPSAoIGtlZXBOYXRpdmVGYWN0b3J5RGVmYXVsdCA9PT0gZ2xvYmFsVmFsdWUgPwoJCQkJIiIgOiBnbG9iYWxWYWx1ZSApLAoKCQkJLy8gSWYgJC5tb2JpbGUua2VlcE5hdGl2ZSBoYXMgbm90IGNoYW5nZWQsIHVzZSBvcHRpb25zLmtlZXBOYXRpdmVEZWZhdWx0CgkJCW9sZERlZmF1bHQgPSAoIG5ld0RlZmF1bHQgPT09ICIiID8gb3B0aW9uVmFsdWUgOiAiIiApOwoKCQkvLyBDb25jYXRlbmF0ZSBrZWVwTmF0aXZlIHNlbGVjdG9ycyBmcm9tIGFsbCBzb3VyY2VzIHdoZXJlIHRoZSB2YWx1ZSBoYXMKCQkvLyBjaGFuZ2VkIG9yLCBpZiBub3RoaW5nIGhhcyBjaGFuZ2VkLCByZXR1cm4gdGhlIGRlZmF1bHQKCQlyZXR1cm4gKCAoIGtlZXBOYXRpdmUgPyBbIGtlZXBOYXRpdmUgXSA6IFtdICkKCQkJLmNvbmNhdCggbmV3RGVmYXVsdCA/IFsgbmV3RGVmYXVsdCBdIDogW10gKQoJCQkuY29uY2F0KCBvbGREZWZhdWx0ID8gWyBvbGREZWZhdWx0IF0gOiBbXSApCgkJCS5qb2luKCAiLCAiICkgKTsKCX0KfSk7Cn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKCSQud2lkZ2V0KCAibW9iaWxlLnBhZ2Vjb250YWluZXIiLCB7CgkJb3B0aW9uczogewoJCQl0aGVtZTogImEiCgkJfSwKCgkJaW5pdFNlbGVjdG9yOiBmYWxzZSwKCgkJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJCXRoaXMuc2V0TGFzdFNjcm9sbEVuYWJsZWQgPSB0cnVlOwoKCQkJLy8gVE9ETyBjb25zaWRlciBtb3ZpbmcgdGhlIG5hdmlnYXRpb24gaGFuZGxlciBPVVQgb2Ygd2lkZ2V0IGludG8KCQkJLy8gICAgICBzb21lIG90aGVyIG9iamVjdCBhcyBnbHVlIGJldHdlZW4gdGhlIG5hdmlnYXRlIGV2ZW50IGFuZCB0aGUKCQkJLy8gICAgICBjb250ZW50IHdpZGdldCBsb2FkIGFuZCBjaGFuZ2UgbWV0aG9kcwoJCQl0aGlzLl9vbiggdGhpcy53aW5kb3csIHsgbmF2aWdhdGU6ICJfZmlsdGVyTmF2aWdhdGVFdmVudHMiIH0pOwoKCQkJdGhpcy5fb24oIHRoaXMud2luZG93LCB7CgkJCQkvLyBkaXNhYmxlIGFuIHNjcm9sbCBzZXR0aW5nIHdoZW4gYSBoYXNoY2hhbmdlIGhhcyBiZWVuIGZpcmVkLAoJCQkJLy8gdGhpcyBvbmx5IHdvcmtzIGJlY2F1c2UgdGhlIHJlY29yZGluZyBvZiB0aGUgc2Nyb2xsIHBvc2l0aW9uCgkJCQkvLyBpcyBkZWxheWVkIGZvciAxMDBtcyBhZnRlciB0aGUgYnJvd3NlciBtaWdodCBoYXZlIGNoYW5nZWQgdGhlCgkJCQkvLyBwb3NpdGlvbiBiZWNhdXNlIG9mIHRoZSBoYXNoY2hhbmdlCgkJCQluYXZpZ2F0ZTogIl9kaXNhYmxlUmVjb3JkU2Nyb2xsIiwKCgkJCQkvLyBiaW5kIHRvIHNjcm9sbHN0b3AgZm9yIHRoZSBmaXJzdCBwYWdlLCAicGFnZWNoYW5nZSIgd29uJ3QgYmUKCQkJCS8vIGZpcmVkIGluIHRoYXQgY2FzZQoJCQkJc2Nyb2xsc3RvcDogIl9kZWxheWVkUmVjb3JkU2Nyb2xsIgoJCQl9KTsKCgkJCS8vIFRPRE8gbW92ZSBmcm9tIHBhZ2UqIGV2ZW50cyB0byBjb250ZW50KiBldmVudHMKCQkJdGhpcy5fb24oeyBwYWdlY2hhbmdlOiAiX2FmdGVyQ29udGVudENoYW5nZSIgfSk7CgoJCQkvLyBoYW5kbGUgaW5pdGlhbCBoYXNoY2hhbmdlIGZyb20gY2hyb21lIDooCgkJCXRoaXMud2luZG93Lm9uZSggIm5hdmlnYXRlIiwgJC5wcm94eShmdW5jdGlvbigpIHsKCQkJCXRoaXMuc2V0TGFzdFNjcm9sbEVuYWJsZWQgPSB0cnVlOwoJCQl9LCB0aGlzKSk7CgkJfSwKCgkJX3NldE9wdGlvbnM6IGZ1bmN0aW9uKCBvcHRpb25zICl7CgkJCWlmICggb3B0aW9ucy50aGVtZSAhPT0gdW5kZWZpbmVkICYmIG9wdGlvbnMudGhlbWUgIT09ICJub25lIiApIHsKCQkJCXRoaXMuZWxlbWVudC5yZW1vdmVDbGFzcyggInVpLW92ZXJsYXktIiArIHRoaXMub3B0aW9ucy50aGVtZSApCgkJCQkJLmFkZENsYXNzKCAidWktb3ZlcmxheS0iICsgb3B0aW9ucy50aGVtZSApOwoJCQl9IGVsc2UgaWYgKCBvcHRpb25zLnRoZW1lICE9PSB1bmRlZmluZWQgKSB7CgkJCQl0aGlzLmVsZW1lbnQucmVtb3ZlQ2xhc3MoICJ1aS1vdmVybGF5LSIgKyB0aGlzLm9wdGlvbnMudGhlbWUgKTsKCQkJfQoKCQkJdGhpcy5fc3VwZXIoIG9wdGlvbnMgKTsKCQl9LAoKCQlfZGlzYWJsZVJlY29yZFNjcm9sbDogZnVuY3Rpb24oKSB7CgkJCXRoaXMuc2V0TGFzdFNjcm9sbEVuYWJsZWQgPSBmYWxzZTsKCQl9LAoKCQlfZW5hYmxlUmVjb3JkU2Nyb2xsOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5zZXRMYXN0U2Nyb2xsRW5hYmxlZCA9IHRydWU7CgkJfSwKCgkJLy8gVE9ETyBjb25zaWRlciB0aGUgbmFtZSBoZXJlLCBzaW5jZSBpdCdzIHB1cnBvc2Ugc3BlY2lmaWMKCQlfYWZ0ZXJDb250ZW50Q2hhbmdlOiBmdW5jdGlvbigpIHsKCQkJLy8gb25jZSB0aGUgcGFnZSBoYXMgY2hhbmdlZCwgcmUtZW5hYmxlIHRoZSBzY3JvbGwgcmVjb3JkaW5nCgkJCXRoaXMuc2V0TGFzdFNjcm9sbEVuYWJsZWQgPSB0cnVlOwoKCQkJLy8gcmVtb3ZlIGFueSBiaW5kaW5nIHRoYXQgcHJldmlvdXNseSBleGlzdGVkIG9uIHRoZSBnZXQgc2Nyb2xsCgkJCS8vIHdoaWNoIG1heSBvciBtYXkgbm90IGJlIGRpZmZlcmVudCB0aGFuIHRoZSBzY3JvbGwgZWxlbWVudAoJCQkvLyBkZXRlcm1pbmVkIGZvciB0aGlzIHBhZ2UgcHJldmlvdXNseQoJCQl0aGlzLl9vZmYoIHRoaXMud2luZG93LCAic2Nyb2xsc3RvcCIgKTsKCgkJCS8vIGRldGVybWluZSBhbmQgYmluZCB0byB0aGUgY3VycmVudCBzY29sbCBlbGVtZW50IHdoaWNoIG1heSBiZSB0aGUKCQkJLy8gd2luZG93IG9yIGluIHRoZSBjYXNlIG9mIHRvdWNoIG92ZXJmbG93IHRoZSBlbGVtZW50IHRvdWNoIG92ZXJmbG93CgkJCXRoaXMuX29uKCB0aGlzLndpbmRvdywgeyBzY3JvbGxzdG9wOiAiX2RlbGF5ZWRSZWNvcmRTY3JvbGwiIH0pOwoJCX0sCgoJCV9yZWNvcmRTY3JvbGw6IGZ1bmN0aW9uKCkgewoJCQkvLyB0aGlzIGJhcnJpZXIgcHJldmVudHMgc2V0dGluZyB0aGUgc2Nyb2xsIHZhbHVlIGJhc2VkIG9uCgkJCS8vIHRoZSBicm93c2VyIHNjcm9sbGluZyB0aGUgd2luZG93IGJhc2VkIG9uIGEgaGFzaGNoYW5nZQoJCQlpZiAoICF0aGlzLnNldExhc3RTY3JvbGxFbmFibGVkICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQl2YXIgYWN0aXZlID0gdGhpcy5fZ2V0QWN0aXZlSGlzdG9yeSgpLAoJCQkJY3VycmVudFNjcm9sbCwgbWluU2Nyb2xsLCBkZWZhdWx0U2Nyb2xsOwoKCQkJaWYgKCBhY3RpdmUgKSB7CgkJCQljdXJyZW50U2Nyb2xsID0gdGhpcy5fZ2V0U2Nyb2xsKCk7CgkJCQltaW5TY3JvbGwgPSB0aGlzLl9nZXRNaW5TY3JvbGwoKTsKCQkJCWRlZmF1bHRTY3JvbGwgPSB0aGlzLl9nZXREZWZhdWx0U2Nyb2xsKCk7CgoJCQkJLy8gU2V0IGFjdGl2ZSBwYWdlJ3MgbGFzdFNjcm9sbCBwcm9wLiBJZiB0aGUgbG9jYXRpb24gd2UncmUKCQkJCS8vIHNjcm9sbGluZyB0byBpcyBsZXNzIHRoYW4gbWluU2Nyb2xsQmFjaywgbGV0IGl0IGdvLgoJCQkJYWN0aXZlLmxhc3RTY3JvbGwgPSBjdXJyZW50U2Nyb2xsIDwgbWluU2Nyb2xsID8gZGVmYXVsdFNjcm9sbCA6IGN1cnJlbnRTY3JvbGw7CgkJCX0KCQl9LAoKCQlfZGVsYXllZFJlY29yZFNjcm9sbDogZnVuY3Rpb24oKSB7CgkJCXNldFRpbWVvdXQoICQucHJveHkodGhpcywgIl9yZWNvcmRTY3JvbGwiKSwgMTAwICk7CgkJfSwKCgkJX2dldFNjcm9sbDogZnVuY3Rpb24oKSB7CgkJCXJldHVybiB0aGlzLndpbmRvdy5zY3JvbGxUb3AoKTsKCQl9LAoKCQlfZ2V0TWluU2Nyb2xsOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuICQubW9iaWxlLm1pblNjcm9sbEJhY2s7CgkJfSwKCgkJX2dldERlZmF1bHRTY3JvbGw6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gJC5tb2JpbGUuZGVmYXVsdEhvbWVTY3JvbGw7CgkJfSwKCgkJX2ZpbHRlck5hdmlnYXRlRXZlbnRzOiBmdW5jdGlvbiggZSwgZGF0YSApIHsKCQkJdmFyIHVybDsKCgkJCWlmICggZS5vcmlnaW5hbEV2ZW50ICYmIGUub3JpZ2luYWxFdmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJdXJsID0gZS5vcmlnaW5hbEV2ZW50LnR5cGUuaW5kZXhPZiggImhhc2hjaGFuZ2UiICkgPiAtMSA/IGRhdGEuc3RhdGUuaGFzaCA6IGRhdGEuc3RhdGUudXJsOwoKCQkJaWYgKCAhdXJsICkgewoJCQkJdXJsID0gdGhpcy5fZ2V0SGFzaCgpOwoJCQl9CgoJCQlpZiAoICF1cmwgfHwgdXJsID09PSAiIyIgfHwgdXJsLmluZGV4T2YoICIjIiArICQubW9iaWxlLnBhdGgudWlTdGF0ZUtleSApID09PSAwICl7CgkJCQl1cmwgPSBsb2NhdGlvbi5ocmVmOwoJCQl9CgoJCQl0aGlzLl9oYW5kbGVOYXZpZ2F0ZSggdXJsLCBkYXRhLnN0YXRlICk7CgkJfSwKCgkJX2dldEhhc2g6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gJC5tb2JpbGUucGF0aC5wYXJzZUxvY2F0aW9uKCkuaGFzaDsKCQl9LAoKCQkvLyBUT0RPIGFjdGl2ZSBwYWdlIHNob3VsZCBiZSBtYW5hZ2VkIGJ5IHRoZSBjb250YWluZXIgKGllLCBpdCBzaG91bGQgYmUgYSBwcm9wZXJ0eSkKCQlnZXRBY3RpdmVQYWdlOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHRoaXMuYWN0aXZlUGFnZTsKCQl9LAoKCQkvLyBUT0RPIHRoZSBmaXJzdCBwYWdlIHNob3VsZCBiZSBhIHByb3BlcnR5IHNldCBkdXJpbmcgX2NyZWF0ZSB1c2luZyB0aGUgbG9naWMKCQkvLyAgICAgIHRoYXQgY3VycmVudGx5IHJlc2lkZXMgaW4gaW5pdAoJCV9nZXRJbml0aWFsQ29udGVudDogZnVuY3Rpb24oKSB7CgkJCXJldHVybiAkLm1vYmlsZS5maXJzdFBhZ2U7CgkJfSwKCgkJLy8gVE9ETyBlYWNoIGNvbnRlbnQgY29udGFpbmVyIHNob3VsZCBoYXZlIGEgaGlzdG9yeSBvYmplY3QKCQlfZ2V0SGlzdG9yeTogZnVuY3Rpb24oKSB7CgkJCXJldHVybiAkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5OwoJCX0sCgoJCS8vIFRPRE8gdXNlIF9nZXRIaXN0b3J5CgkJX2dldEFjdGl2ZUhpc3Rvcnk6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gJC5tb2JpbGUubmF2aWdhdGUuaGlzdG9yeS5nZXRBY3RpdmUoKTsKCQl9LAoKCQkvLyBUT0RPIHRoZSBkb2N1bWVudCBiYXNlIHNob3VsZCBiZSBkZXRlcm1pbmVkIGF0IGNyZWF0aW9uCgkJX2dldERvY3VtZW50QmFzZTogZnVuY3Rpb24oKSB7CgkJCXJldHVybiAkLm1vYmlsZS5wYXRoLmRvY3VtZW50QmFzZTsKCQl9LAoKCQlfYmFjazogZnVuY3Rpb24oKSB7CgkJCSQubW9iaWxlLmJhY2soKTsKCQl9LAoKCQlfZm9yd2FyZDogZnVuY3Rpb24oKSB7CgkJCXdpbmRvdy5oaXN0b3J5LmZvcndhcmQoKTsKCQl9LAoKCQkvLyBUT0RPIHJlbmFtZSBfaGFuZGxlRGVzdGluYXRpb24KCQlfaGFuZGxlRGVzdGluYXRpb246IGZ1bmN0aW9uKCB0byApIHsKCQkJdmFyIGhpc3Rvcnk7CgoJCQkvLyBjbGVhbiB0aGUgaGFzaCBmb3IgY29tcGFyaXNvbiBpZiBpdCdzIGEgdXJsCgkJCWlmICggJC50eXBlKHRvKSA9PT0gInN0cmluZyIgKSB7CgkJCQl0byA9ICQubW9iaWxlLnBhdGguc3RyaXBIYXNoKCB0byApOwoJCQl9CgoJCQlpZiAoIHRvICkgewoJCQkJaGlzdG9yeSA9IHRoaXMuX2dldEhpc3RvcnkoKTsKCgkJCQkvLyBBdCB0aGlzIHBvaW50LCAndG8nIGNhbiBiZSBvbmUgb2YgMyB0aGluZ3MsIGEgY2FjaGVkIHBhZ2UKCQkJCS8vIGVsZW1lbnQgZnJvbSBhIGhpc3Rvcnkgc3RhY2sgZW50cnksIGFuIGlkLCBvciBzaXRlLXJlbGF0aXZlIC8KCQkJCS8vIGFic29sdXRlIFVSTC4gSWYgJ3RvJyBpcyBhbiBpZCwgd2UgbmVlZCB0byByZXNvbHZlIGl0IGFnYWluc3QKCQkJCS8vIHRoZSBkb2N1bWVudEJhc2UsIG5vdCB0aGUgbG9jYXRpb24uaHJlZiwgc2luY2UgdGhlIGhhc2hjaGFuZ2UKCQkJCS8vIGNvdWxkJ3ZlIGJlZW4gdGhlIHJlc3VsdCBvZiBhIGZvcndhcmQvYmFja3dhcmQgbmF2aWdhdGlvbgoJCQkJLy8gdGhhdCBjcm9zc2VzIGZyb20gYW4gZXh0ZXJuYWwgcGFnZS9kaWFsb2cgdG8gYW4gaW50ZXJuYWwKCQkJCS8vIHBhZ2UvZGlhbG9nLgoJCQkJLy8KCQkJCS8vIFRPRE8gbW92ZSBjaGVjayB0byBoaXN0b3J5IG9iamVjdCBvciBwYXRoIG9iamVjdD8KCQkJCXRvID0gISQubW9iaWxlLnBhdGguaXNQYXRoKCB0byApID8gKCAkLm1vYmlsZS5wYXRoLm1ha2VVcmxBYnNvbHV0ZSggIiMiICsgdG8sIHRoaXMuX2dldERvY3VtZW50QmFzZSgpICkgKSA6IHRvOwoKCQkJCS8vIElmIHdlJ3JlIGFib3V0IHRvIGdvIHRvIGFuIGluaXRpYWwgVVJMIHRoYXQgY29udGFpbnMgYQoJCQkJLy8gcmVmZXJlbmNlIHRvIGEgbm9uLWV4aXN0ZW50IGludGVybmFsIHBhZ2UsIGdvIHRvIHRoZSBmaXJzdAoJCQkJLy8gcGFnZSBpbnN0ZWFkLiBXZSBrbm93IHRoYXQgdGhlIGluaXRpYWwgaGFzaCByZWZlcnMgdG8gYQoJCQkJLy8gbm9uLWV4aXN0ZW50IHBhZ2UsIGJlY2F1c2UgdGhlIGluaXRpYWwgaGFzaCBkaWQgbm90IGVuZAoJCQkJLy8gdXAgaW4gdGhlIGluaXRpYWwgaGlzdG9yeSBlbnRyeQoJCQkJLy8gVE9ETyBtb3ZlIGNoZWNrIHRvIGhpc3Rvcnkgb2JqZWN0PwoJCQkJaWYgKCB0byA9PT0gJC5tb2JpbGUucGF0aC5tYWtlVXJsQWJzb2x1dGUoICIjIiArIGhpc3RvcnkuaW5pdGlhbERzdCwgdGhpcy5fZ2V0RG9jdW1lbnRCYXNlKCkgKSAmJgoJCQkJCWhpc3Rvcnkuc3RhY2subGVuZ3RoICYmCgkJCQkJaGlzdG9yeS5zdGFja1swXS51cmwgIT09IGhpc3RvcnkuaW5pdGlhbERzdC5yZXBsYWNlKCAkLm1vYmlsZS5kaWFsb2dIYXNoS2V5LCAiIiApICkgewoJCQkJCXRvID0gdGhpcy5fZ2V0SW5pdGlhbENvbnRlbnQoKTsKCQkJCX0KCQkJfQoJCQlyZXR1cm4gdG8gfHwgdGhpcy5fZ2V0SW5pdGlhbENvbnRlbnQoKTsKCQl9LAoKCQlfaGFuZGxlRGlhbG9nOiBmdW5jdGlvbiggY2hhbmdlUGFnZU9wdGlvbnMsIGRhdGEgKSB7CgkJCXZhciB0bywgYWN0aXZlLCBhY3RpdmVDb250ZW50ID0gdGhpcy5nZXRBY3RpdmVQYWdlKCk7CgoJCQkvLyBJZiBjdXJyZW50IGFjdGl2ZSBwYWdlIGlzIG5vdCBhIGRpYWxvZyBza2lwIHRoZSBkaWFsb2cgYW5kIGNvbnRpbnVlCgkJCS8vIGluIHRoZSBzYW1lIGRpcmVjdGlvbgoJCQlpZiAoIGFjdGl2ZUNvbnRlbnQgJiYgIWFjdGl2ZUNvbnRlbnQuaGFzQ2xhc3MoICJ1aS1kaWFsb2ciICkgKSB7CgkJCQkvLyBkZXRlcm1pbmUgaWYgd2UncmUgaGVhZGluZyBmb3J3YXJkIG9yIGJhY2t3YXJkIGFuZCBjb250aW51ZQoJCQkJLy8gYWNjb3JkaW5nbHkgcGFzdCB0aGUgY3VycmVudCBkaWFsb2cKCQkJCWlmICggZGF0YS5kaXJlY3Rpb24gPT09ICJiYWNrIiApIHsKCQkJCQl0aGlzLl9iYWNrKCk7CgkJCQl9IGVsc2UgewoJCQkJCXRoaXMuX2ZvcndhcmQoKTsKCQkJCX0KCgkJCQkvLyBwcmV2ZW50IGNoYW5nZVBhZ2UgY2FsbAoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9IGVsc2UgewoJCQkJLy8gaWYgdGhlIGN1cnJlbnQgYWN0aXZlIHBhZ2UgaXMgYSBkaWFsb2cgYW5kIHdlJ3JlIG5hdmlnYXRpbmcKCQkJCS8vIHRvIGEgZGlhbG9nIHVzZSB0aGUgZGlhbG9nIG9iamVjdGVkIHNhdmVkIGluIHRoZSBzdGFjawoJCQkJdG8gPSBkYXRhLnBhZ2VVcmw7CgkJCQlhY3RpdmUgPSB0aGlzLl9nZXRBY3RpdmVIaXN0b3J5KCk7CgoJCQkJLy8gbWFrZSBzdXJlIHRvIHNldCB0aGUgcm9sZSwgdHJhbnNpdGlvbiBhbmQgcmV2ZXJzYWwKCQkJCS8vIGFzIG1vc3Qgb2YgdGhpcyBpcyBsb3N0IGJ5IHRoZSBkb21DYWNoZSBjbGVhbmluZwoJCQkJJC5leHRlbmQoIGNoYW5nZVBhZ2VPcHRpb25zLCB7CgkJCQkJcm9sZTogYWN0aXZlLnJvbGUsCgkJCQkJdHJhbnNpdGlvbjogYWN0aXZlLnRyYW5zaXRpb24sCgkJCQkJcmV2ZXJzZTogZGF0YS5kaXJlY3Rpb24gPT09ICJiYWNrIgoJCQkJfSk7CgkJCX0KCgkJCXJldHVybiB0bzsKCQl9LAoKCQlfaGFuZGxlTmF2aWdhdGU6IGZ1bmN0aW9uKCB1cmwsIGRhdGEgKSB7CgkJCS8vZmluZCBmaXJzdCBwYWdlIHZpYSBoYXNoCgkJCS8vIFRPRE8gc3RyaXBwaW5nIHRoZSBoYXNoIHR3aWNlIHdpdGggaGFuZGxlVXJsCgkJCXZhciB0byA9ICQubW9iaWxlLnBhdGguc3RyaXBIYXNoKCB1cmwgKSwgaGlzdG9yeSA9IHRoaXMuX2dldEhpc3RvcnkoKSwKCgkJCQkvLyB0cmFuc2l0aW9uIGlzIGZhbHNlIGlmIGl0J3MgdGhlIGZpcnN0IHBhZ2UsIHVuZGVmaW5lZAoJCQkJLy8gb3RoZXJ3aXNlIChhbmQgbWF5IGJlIG92ZXJyaWRkZW4gYnkgZGVmYXVsdCkKCQkJCXRyYW5zaXRpb24gPSBoaXN0b3J5LnN0YWNrLmxlbmd0aCA9PT0gMCA/ICJub25lIiA6IHVuZGVmaW5lZCwKCgkJCQkvLyBkZWZhdWx0IG9wdGlvbnMgZm9yIHRoZSBjaGFuZ1BhZ2UgY2FsbHMgbWFkZSBhZnRlciBleGFtaW5pbmcKCQkJCS8vIHRoZSBjdXJyZW50IHN0YXRlIG9mIHRoZSBwYWdlIGFuZCB0aGUgaGFzaCwgTk9URSB0aGF0IHRoZQoJCQkJLy8gdHJhbnNpdGlvbiBpcyBkZXJpdmVkIGZyb20gdGhlIHByZXZpb3VzIGhpc3RvcnkgZW50cnkKCQkJCWNoYW5nZVBhZ2VPcHRpb25zID0gewoJCQkJCWNoYW5nZUhhc2g6IGZhbHNlLAoJCQkJCWZyb21IYXNoQ2hhbmdlOiB0cnVlLAoJCQkJCXJldmVyc2U6IGRhdGEuZGlyZWN0aW9uID09PSAiYmFjayIKCQkJCX07CgoJCQkkLmV4dGVuZCggY2hhbmdlUGFnZU9wdGlvbnMsIGRhdGEsIHsKCQkJCXRyYW5zaXRpb246ICggaGlzdG9yeS5nZXRMYXN0KCkgfHwge30gKS50cmFuc2l0aW9uIHx8IHRyYW5zaXRpb24KCQkJfSk7CgoJCQkvLyBUT0RPIG1vdmUgdG8gX2hhbmRsZURlc3RpbmF0aW9uID8KCQkJLy8gSWYgdGhpcyBpc24ndCB0aGUgZmlyc3QgcGFnZSwgaWYgdGhlIGN1cnJlbnQgdXJsIGlzIGEgZGlhbG9nIGhhc2gKCQkJLy8ga2V5LCBhbmQgdGhlIGluaXRpYWwgZGVzdGluYXRpb24gaXNuJ3QgZXF1YWwgdG8gdGhlIGN1cnJlbnQgdGFyZ2V0CgkJCS8vIHBhZ2UsIHVzZSB0aGUgc3BlY2lhbCBkaWFsb2cgaGFuZGxpbmcKCQkJaWYgKCBoaXN0b3J5LmFjdGl2ZUluZGV4ID4gMCAmJgoJCQkJdG8uaW5kZXhPZiggJC5tb2JpbGUuZGlhbG9nSGFzaEtleSApID4gLTEgJiYKCQkJCWhpc3RvcnkuaW5pdGlhbERzdCAhPT0gdG8gKSB7CgoJCQkJdG8gPSB0aGlzLl9oYW5kbGVEaWFsb2coIGNoYW5nZVBhZ2VPcHRpb25zLCBkYXRhICk7CgoJCQkJaWYgKCB0byA9PT0gZmFsc2UgKSB7CgkJCQkJcmV0dXJuOwoJCQkJfQoJCQl9CgoJCQl0aGlzLl9jaGFuZ2VDb250ZW50KCB0aGlzLl9oYW5kbGVEZXN0aW5hdGlvbiggdG8gKSwgY2hhbmdlUGFnZU9wdGlvbnMgKTsKCQl9LAoKCQlfY2hhbmdlQ29udGVudDogZnVuY3Rpb24oIHRvLCBvcHRzICkgewoJCQkkLm1vYmlsZS5jaGFuZ2VQYWdlKCB0bywgb3B0cyApOwoJCX0sCgoJCV9nZXRCYXNlOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuICQubW9iaWxlLmJhc2U7CgkJfSwKCgkJX2dldE5zOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuICQubW9iaWxlLm5zOwoJCX0sCgoJCV9lbmhhbmNlOiBmdW5jdGlvbiggY29udGVudCwgcm9sZSApIHsKCQkJLy8gVE9ETyBjb25zaWRlciBzdXBwb3J0aW5nIGEgY3VzdG9tIGNhbGxiYWNrLCBhbmQgcGFzc2luZyBpbgoJCQkvLyB0aGUgc2V0dGluZ3Mgd2hpY2ggaW5jbHVkZXMgdGhlIHJvbGUKCQkJcmV0dXJuIGNvbnRlbnQucGFnZSh7IHJvbGU6IHJvbGUgfSk7CgkJfSwKCgkJX2luY2x1ZGU6IGZ1bmN0aW9uKCBwYWdlLCBzZXR0aW5ncyApIHsKCQkJLy8gYXBwZW5kIHRvIHBhZ2UgYW5kIGVuaGFuY2UKCQkJcGFnZS5hcHBlbmRUbyggdGhpcy5lbGVtZW50ICk7CgoJCQkvLyB1c2UgdGhlIHBhZ2Ugd2lkZ2V0IHRvIGVuaGFuY2UKCQkJdGhpcy5fZW5oYW5jZSggcGFnZSwgc2V0dGluZ3Mucm9sZSApOwoKCQkJLy8gcmVtb3ZlIHBhZ2Ugb24gaGlkZQoJCQlwYWdlLnBhZ2UoICJiaW5kUmVtb3ZlIiApOwoJCX0sCgoJCV9maW5kOiBmdW5jdGlvbiggYWJzVXJsICkgewoJCQkvLyBUT0RPIGNvbnNpZGVyIHN1cHBvcnRpbmcgYSBjdXN0b20gY2FsbGJhY2sKCQkJdmFyIGZpbGVVcmwgPSB0aGlzLl9jcmVhdGVGaWxlVXJsKCBhYnNVcmwgKSwKCQkJCWRhdGFVcmwgPSB0aGlzLl9jcmVhdGVEYXRhVXJsKCBhYnNVcmwgKSwKCQkJCXBhZ2UsIGluaXRpYWxDb250ZW50ID0gdGhpcy5fZ2V0SW5pdGlhbENvbnRlbnQoKTsKCgkJCS8vIENoZWNrIHRvIHNlZSBpZiB0aGUgcGFnZSBhbHJlYWR5IGV4aXN0cyBpbiB0aGUgRE9NLgoJCQkvLyBOT1RFIGRvIF9ub3RfIHVzZSB0aGUgOmpxbURhdGEgcHNldWRvIHNlbGVjdG9yIGJlY2F1c2UgcGFyZW50aGVzaXMKCQkJLy8gICAgICBhcmUgYSB2YWxpZCB1cmwgY2hhciBhbmQgaXQgYnJlYWtzIG9uIHRoZSBmaXJzdCBvY2N1cmVuY2UKCQkJcGFnZSA9IHRoaXMuZWxlbWVudAoJCQkJLmNoaWxkcmVuKCAiW2RhdGEtIiArIHRoaXMuX2dldE5zKCkgKyJ1cmw9JyIgKyBkYXRhVXJsICsgIiddIiApOwoKCQkJLy8gSWYgd2UgZmFpbGVkIHRvIGZpbmQgdGhlIHBhZ2UsIGNoZWNrIHRvIHNlZSBpZiB0aGUgdXJsIGlzIGEKCQkJLy8gcmVmZXJlbmNlIHRvIGFuIGVtYmVkZGVkIHBhZ2UuIElmIHNvLCBpdCBtYXkgaGF2ZSBiZWVuIGR5bmFtaWNhbGx5CgkJCS8vIGluamVjdGVkIGJ5IGEgZGV2ZWxvcGVyLCBpbiB3aGljaCBjYXNlIGl0IHdvdWxkIGJlIGxhY2tpbmcgYQoJCQkvLyBkYXRhLXVybCBhdHRyaWJ1dGUgYW5kIGluIG5lZWQgb2YgZW5oYW5jZW1lbnQuCgkJCWlmICggcGFnZS5sZW5ndGggPT09IDAgJiYgZGF0YVVybCAmJiAhJC5tb2JpbGUucGF0aC5pc1BhdGgoIGRhdGFVcmwgKSApIHsKCQkJCXBhZ2UgPSB0aGlzLmVsZW1lbnQuY2hpbGRyZW4oICQubW9iaWxlLnBhdGguaGFzaFRvU2VsZWN0b3IoIiMiICsgZGF0YVVybCkgKQoJCQkJCS5hdHRyKCAiZGF0YS0iICsgdGhpcy5fZ2V0TnMoKSArICJ1cmwiLCBkYXRhVXJsICkKCQkJCQkuanFtRGF0YSggInVybCIsIGRhdGFVcmwgKTsKCQkJfQoKCQkJLy8gSWYgd2UgZmFpbGVkIHRvIGZpbmQgYSBwYWdlIGluIHRoZSBET00sIGNoZWNrIHRoZSBVUkwgdG8gc2VlIGlmIGl0CgkJCS8vIHJlZmVycyB0byB0aGUgZmlyc3QgcGFnZSBpbiB0aGUgYXBwbGljYXRpb24uIEFsc28gY2hlY2sgdG8gbWFrZSBzdXJlCgkJCS8vIG91ciBjYWNoZWQtZmlyc3QtcGFnZSBpcyBhY3R1YWxseSBpbiB0aGUgRE9NLiBTb21lIHVzZXIgZGVwbG95ZWQKCQkJLy8gYXBwcyBhcmUgcHJ1bmluZyB0aGUgZmlyc3QgcGFnZSBmcm9tIHRoZSBET00gZm9yIHZhcmlvdXMgcmVhc29ucy4KCQkJLy8gV2UgY2hlY2sgZm9yIHRoaXMgY2FzZSBoZXJlIGJlY2F1c2Ugd2UgZG9uJ3Qgd2FudCBhIGZpcnN0LXBhZ2Ugd2l0aAoJCQkvLyBhbiBpZCBmYWxsaW5nIHRocm91Z2ggdG8gdGhlIG5vbi1leGlzdGVudCBlbWJlZGRlZCBwYWdlIGVycm9yIGNhc2UuCgkJCWlmICggcGFnZS5sZW5ndGggPT09IDAgJiYKCQkJCSQubW9iaWxlLnBhdGguaXNGaXJzdFBhZ2VVcmwoIGZpbGVVcmwgKSAmJgoJCQkJaW5pdGlhbENvbnRlbnQgJiYKCQkJCWluaXRpYWxDb250ZW50LnBhcmVudCgpLmxlbmd0aCApIHsKCQkJCXBhZ2UgPSAkKCBpbml0aWFsQ29udGVudCApOwoJCQl9CgoJCQlyZXR1cm4gcGFnZTsKCQl9LAoKCQlfZ2V0TG9hZGVyOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuICQubW9iaWxlLmxvYWRpbmcoKTsKCQl9LAoKCQlfc2hvd0xvYWRpbmc6IGZ1bmN0aW9uKCBkZWxheSwgdGhlbWUsIG1zZywgdGV4dG9ubHkgKSB7CgkJCS8vIFRoaXMgY29uZmlndXJhYmxlIHRpbWVvdXQgYWxsb3dzIGNhY2hlZCBwYWdlcyBhIGJyaWVmCgkJCS8vIGRlbGF5IHRvIGxvYWQgd2l0aG91dCBzaG93aW5nIGEgbWVzc2FnZQoJCQl0aGlzLl9sb2FkTXNnID0gc2V0VGltZW91dCgkLnByb3h5KGZ1bmN0aW9uKCkgewoJCQkJdGhpcy5fZ2V0TG9hZGVyKCkubG9hZGVyKCAic2hvdyIsIHRoZW1lLCBtc2csIHRleHRvbmx5ICk7CgkJCX0sIHRoaXMpLCBkZWxheSApOwoJCX0sCgoJCV9oaWRlTG9hZGluZzogZnVuY3Rpb24oKSB7CgkJCS8vIFN0b3AgbWVzc2FnZSBzaG93IHRpbWVyCgkJCWNsZWFyVGltZW91dCggdGhpcy5fbG9hZE1zZyApOwoKCQkJLy8gSGlkZSBsb2FkaW5nIG1lc3NhZ2UKCQkJdGhpcy5fZ2V0TG9hZGVyKCkubG9hZGVyKCAiaGlkZSIgKTsKCQl9LAoKCQlfc2hvd0Vycm9yOiBmdW5jdGlvbigpIHsKCQkJLy8gbWFrZSBzdXJlIHRvIHJlbW92ZSB0aGUgY3VycmVudCBsb2FkaW5nIG1lc3NhZ2UKCQkJdGhpcy5faGlkZUxvYWRpbmcoKTsKCgkJCS8vIHNob3cgdGhlIGVycm9yIG1lc3NhZ2UKCQkJdGhpcy5fc2hvd0xvYWRpbmcoIDAsICQubW9iaWxlLnBhZ2VMb2FkRXJyb3JNZXNzYWdlVGhlbWUsICQubW9iaWxlLnBhZ2VMb2FkRXJyb3JNZXNzYWdlLCB0cnVlICk7CgoJCQkvLyBoaWRlIHRoZSBlcnJvciBtZXNzYWdlIGFmdGVyIGEgZGVsYXkKCQkJLy8gVE9ETyBjb25maWd1cmF0aW9uCgkJCXNldFRpbWVvdXQoICQucHJveHkodGhpcywgIl9oaWRlTG9hZGluZyIpLCAxNTAwICk7CgkJfSwKCgkJX3BhcnNlOiBmdW5jdGlvbiggaHRtbCwgZmlsZVVybCApIHsKCQkJLy8gVE9ETyBjb25zaWRlciBhbGxvd2luZyBjdXN0b21pemF0aW9uIG9mIHRoaXMgbWV0aG9kLiBJdCdzIHZlcnkgSlFNIHNwZWNpZmljCgkJCXZhciBwYWdlLCBhbGwgPSAkKCAiPGRpdj48L2Rpdj4iICk7CgoJCQkvL3dvcmthcm91bmQgdG8gYWxsb3cgc2NyaXB0cyB0byBleGVjdXRlIHdoZW4gaW5jbHVkZWQgaW4gcGFnZSBkaXZzCgkJCWFsbC5nZXQoIDAgKS5pbm5lckhUTUwgPSBodG1sOwoKCQkJcGFnZSA9IGFsbC5maW5kKCAiOmpxbURhdGEocm9sZT0ncGFnZScpLCA6anFtRGF0YShyb2xlPSdkaWFsb2cnKSIgKS5maXJzdCgpOwoKCQkJLy9pZiBwYWdlIGVsZW0gY291bGRuJ3QgYmUgZm91bmQsIGNyZWF0ZSBvbmUgYW5kIGluc2VydCB0aGUgYm9keSBlbGVtZW50J3MgY29udGVudHMKCQkJaWYgKCAhcGFnZS5sZW5ndGggKSB7CgkJCQlwYWdlID0gJCggIjxkaXYgZGF0YS0iICsgdGhpcy5fZ2V0TnMoKSArICJyb2xlPSdwYWdlJz4iICsKCQkJCQkoIGh0bWwuc3BsaXQoIC88XC8/Ym9keVtePl0qPi9nbWkgKVsxXSB8fCAiIiApICsKCQkJCQkiPC9kaXY+IiApOwoJCQl9CgoJCQkvLyBUT0RPIHRhZ2dpbmcgYSBwYWdlIHdpdGggZXh0ZXJuYWwgdG8gbWFrZSBzdXJlIHRoYXQgZW1iZWRkZWQgcGFnZXMgYXJlbid0CgkJCS8vIHJlbW92ZWQgYnkgdGhlIHZhcmlvdXMgcGFnZSBoYW5kbGluZyBjb2RlIGlzIGJhZC4gSGF2aW5nIHBhZ2UgaGFuZGxpbmcgY29kZQoJCQkvLyBpbiBtYW55IHBsYWNlcyBpcyBiYWQuIFNvbHV0aW9ucyBwb3N0IDEuMAoJCQlwYWdlLmF0dHIoICJkYXRhLSIgKyB0aGlzLl9nZXROcygpICsgInVybCIsICQubW9iaWxlLnBhdGguY29udmVydFVybFRvRGF0YVVybChmaWxlVXJsKSApCgkJCQkuYXR0ciggImRhdGEtIiArIHRoaXMuX2dldE5zKCkgKyAiZXh0ZXJuYWwtcGFnZSIsIHRydWUgKTsKCgkJCXJldHVybiBwYWdlOwoJCX0sCgoJCV9zZXRMb2FkZWRUaXRsZTogZnVuY3Rpb24oIHBhZ2UsIGh0bWwgKSB7CgkJCS8vcGFnZSB0aXRsZSByZWdleHAKCQkJdmFyIG5ld1BhZ2VUaXRsZSA9IGh0bWwubWF0Y2goIC88dGl0bGVbXj5dKj4oW148XSopLyApICYmIFJlZ0V4cC4kMTsKCgkJCWlmICggbmV3UGFnZVRpdGxlICYmICFwYWdlLmpxbURhdGEoInRpdGxlIikgKSB7CgkJCQluZXdQYWdlVGl0bGUgPSAkKCAiPGRpdj4iICsgbmV3UGFnZVRpdGxlICsgIjwvZGl2PiIgKS50ZXh0KCk7CgkJCQlwYWdlLmpxbURhdGEoICJ0aXRsZSIsIG5ld1BhZ2VUaXRsZSApOwoJCQl9CgkJfSwKCgkJX2lzUmV3cml0YWJsZUJhc2VUYWc6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gJC5tb2JpbGUuZHluYW1pY0Jhc2VFbmFibGVkICYmICEkLnN1cHBvcnQuZHluYW1pY0Jhc2VUYWc7CgkJfSwKCgkJX2NyZWF0ZURhdGFVcmw6IGZ1bmN0aW9uKCBhYnNvbHV0ZVVybCApIHsKCQkJcmV0dXJuICQubW9iaWxlLnBhdGguY29udmVydFVybFRvRGF0YVVybCggYWJzb2x1dGVVcmwgKTsKCQl9LAoKCQlfY3JlYXRlRmlsZVVybDogZnVuY3Rpb24oIGFic29sdXRlVXJsICkgewoJCQlyZXR1cm4gJC5tb2JpbGUucGF0aC5nZXRGaWxlUGF0aCggYWJzb2x1dGVVcmwgKTsKCQl9LAoKCQlfdHJpZ2dlcldpdGhEZXByZWNhdGVkOiBmdW5jdGlvbiggbmFtZSwgZGF0YSwgcGFnZSApIHsKCQkJdmFyIGRlcHJlY2F0ZWRFdmVudCA9ICQuRXZlbnQoICJwYWdlIiArIG5hbWUgKSwKCQkJCW5ld0V2ZW50ID0gJC5FdmVudCggdGhpcy53aWRnZXROYW1lICsgbmFtZSApOwoKCQkJLy8gREVQUkVDQVRFRAoJCQkvLyB0cmlnZ2VyIHRoZSBvbGQgZGVwcmVjYXRlZCBldmVudCBvbiB0aGUgcGFnZSBpZiBpdCdzIHByb3ZpZGVkCgkJCSggcGFnZSB8fCB0aGlzLmVsZW1lbnQgKS50cmlnZ2VyKCBkZXByZWNhdGVkRXZlbnQsIGRhdGEgKTsKCgkJCS8vIHVzZSB0aGUgd2lkZ2V0IHRyaWdnZXIgbWV0aG9kIGZvciB0aGUgbmV3IGNvbnRlbnQqIGV2ZW50CgkJCXRoaXMuZWxlbWVudC50cmlnZ2VyKCBuZXdFdmVudCwgZGF0YSApOwoKCQkJcmV0dXJuIHsKCQkJCWRlcHJlY2F0ZWRFdmVudDogZGVwcmVjYXRlZEV2ZW50LAoJCQkJZXZlbnQ6IG5ld0V2ZW50CgkJCX07CgkJfSwKCgkJLy8gVE9ETyBpdCB3b3VsZCBiZSBuaWNlIHRvIHNwbGl0IHRoaXMgdXAgbW9yZSBidXQgZXZlcnl0aGluZyBhcHBlYXJzIHRvIGJlICJvbmUgb2ZmIgoJCS8vICAgICAgb3IgcmVxdWlyZSBvcmRlcmluZyBzdWNoIHRoYXQgb3RoZXIgYml0cyBhcmUgc3ByaW5rbGVkIGluIGJldHdlZW4gcGFydHMgdGhhdAoJCS8vICAgICAgY291bGQgYmUgYWJzdHJhY3RlZCBvdXQgYXMgYSBncm91cAoJCV9sb2FkU3VjY2VzczogZnVuY3Rpb24oIGFic1VybCwgdHJpZ2dlckRhdGEsIHNldHRpbmdzLCBkZWZlcnJlZCApIHsKCQkJdmFyIGZpbGVVcmwgPSB0aGlzLl9jcmVhdGVGaWxlVXJsKCBhYnNVcmwgKSwKCQkJCWRhdGFVcmwgPSB0aGlzLl9jcmVhdGVEYXRhVXJsKCBhYnNVcmwgKTsKCgkJCXJldHVybiAkLnByb3h5KGZ1bmN0aW9uKCBodG1sLCB0ZXh0U3RhdHVzLCB4aHIgKSB7CgkJCQkvL3ByZS1wYXJzZSBodG1sIHRvIGNoZWNrIGZvciBhIGRhdGEtdXJsLAoJCQkJLy91c2UgaXQgYXMgdGhlIG5ldyBmaWxlVXJsLCBiYXNlIHBhdGgsIGV0YwoJCQkJdmFyIGNvbnRlbnQsCgoJCQkJCS8vIFRPRE8gaGFuZGxlIGRpYWxvZ3MgYWdhaW4KCQkJCQlwYWdlRWxlbVJlZ2V4ID0gbmV3IFJlZ0V4cCggIig8W14+XStcXGJkYXRhLSIgKyB0aGlzLl9nZXROcygpICsgInJvbGU9W1wiJ10/cGFnZVtcIiddP1tePl0qPikiICksCgoJCQkJCWRhdGFVcmxSZWdleCA9IG5ldyBSZWdFeHAoICJcXGJkYXRhLSIgKyB0aGlzLl9nZXROcygpICsgInVybD1bXCInXT8oW15cIic+XSopW1wiJ10/IiApOwoKCQkJCS8vIGRhdGEtdXJsIG11c3QgYmUgcHJvdmlkZWQgZm9yIHRoZSBiYXNlIHRhZyBzbyByZXNvdXJjZSByZXF1ZXN0cwoJCQkJLy8gY2FuIGJlIGRpcmVjdGVkIHRvIHRoZSBjb3JyZWN0IHVybC4gbG9hZGluZyBpbnRvIGEgdGVtcHJvcmFyeQoJCQkJLy8gZWxlbWVudCBtYWtlcyB0aGVzZSByZXF1ZXN0cyBpbW1lZGlhdGVseQoJCQkJaWYgKCBwYWdlRWxlbVJlZ2V4LnRlc3QoIGh0bWwgKSAmJgoJCQkJCVJlZ0V4cC4kMSAmJgoJCQkJCWRhdGFVcmxSZWdleC50ZXN0KCBSZWdFeHAuJDEgKSAmJgoJCQkJCVJlZ0V4cC4kMSApIHsKCQkJCQlmaWxlVXJsID0gJC5tb2JpbGUucGF0aC5nZXRGaWxlUGF0aCggJCgiPGRpdj4iICsgUmVnRXhwLiQxICsgIjwvZGl2PiIpLnRleHQoKSApOwoJCQkJfQoKCQkJCS8vZG9udCB1cGRhdGUgdGhlIGJhc2UgdGFnIGlmIHdlIGFyZSBwcmVmZXRjaGluZwoJCQkJaWYgKCBzZXR0aW5ncy5wcmVmZXRjaCA9PT0gdW5kZWZpbmVkICl7CgkJCQkJdGhpcy5fZ2V0QmFzZSgpLnNldCggZmlsZVVybCApOwoJCQkJfQoKCQkJCWNvbnRlbnQgPSB0aGlzLl9wYXJzZSggaHRtbCwgZmlsZVVybCApOwoKCQkJCXRoaXMuX3NldExvYWRlZFRpdGxlKCBjb250ZW50LCBodG1sICk7CgoJCQkJLy8gcmV3cml0ZSBzcmMgYW5kIGhyZWYgYXR0cnMgdG8gdXNlIGEgYmFzZSB1cmwgaWYgdGhlIGJhc2UgdGFnIHdvbid0IHdvcmsKCQkJCWlmICggdGhpcy5faXNSZXdyaXRhYmxlQmFzZVRhZygpICYmIGNvbnRlbnQgKSB7CgkJCQkJdGhpcy5fZ2V0QmFzZSgpLnJld3JpdGUoIGZpbGVVcmwsIGNvbnRlbnQgKTsKCQkJCX0KCgkJCQl0aGlzLl9pbmNsdWRlKCBjb250ZW50LCBzZXR0aW5ncyApOwoKCQkJCS8vIEVuaGFuY2luZyB0aGUgY29udGVudCBtYXkgcmVzdWx0IGluIG5ldyBkaWFsb2dzL3N1YiBjb250ZW50IGJlaW5nIGluc2VydGVkCgkJCQkvLyBpbnRvIHRoZSBET00uIElmIHRoZSBvcmlnaW5hbCBhYnNVcmwgcmVmZXJzIHRvIGEgc3ViLWNvbnRlbnQsIHRoYXQgaXMgdGhlCgkJCQkvLyByZWFsIGNvbnRlbnQgd2UgYXJlIGludGVyZXN0ZWQgaW4uCgkJCQlpZiAoIGFic1VybC5pbmRleE9mKCAiJiIgKyAkLm1vYmlsZS5zdWJQYWdlVXJsS2V5ICkgPiAtMSApIHsKCQkJCQljb250ZW50ID0gdGhpcy5lbGVtZW50LmNoaWxkcmVuKCAiW2RhdGEtIiArIHRoaXMuX2dldE5zKCkgKyJ1cmw9JyIgKyBkYXRhVXJsICsgIiddIiApOwoJCQkJfQoKCQkJCS8vIFJlbW92ZSBsb2FkaW5nIG1lc3NhZ2UuCgkJCQlpZiAoIHNldHRpbmdzLnNob3dMb2FkTXNnICkgewoJCQkJCXRoaXMuX2hpZGVMb2FkaW5nKCk7CgkJCQl9CgoJCQkJLy8gQWRkIHRoZSBjb250ZW50IHJlZmVyZW5jZSBhbmQgeGhyIHRvIG91ciB0cmlnZ2VyRGF0YS4KCQkJCXRyaWdnZXJEYXRhLnhociA9IHhocjsKCQkJCXRyaWdnZXJEYXRhLnRleHRTdGF0dXMgPSB0ZXh0U3RhdHVzOwoKCQkJCS8vIERFUFJFQ0FURUQKCQkJCXRyaWdnZXJEYXRhLnBhZ2UgPSBjb250ZW50OwoKCQkJCXRyaWdnZXJEYXRhLmNvbnRlbnQgPSBjb250ZW50OwoKCQkJCS8vIExldCBsaXN0ZW5lcnMga25vdyB0aGUgY29udGVudCBsb2FkZWQgc3VjY2Vzc2Z1bGx5LgoJCQkJdGhpcy5fdHJpZ2dlcldpdGhEZXByZWNhdGVkKCAibG9hZCIsIHRyaWdnZXJEYXRhICk7CgoJCQkJZGVmZXJyZWQucmVzb2x2ZSggYWJzVXJsLCBzZXR0aW5ncywgY29udGVudCApOwoJCQl9LCB0aGlzKTsKCQl9LAoKCQlfbG9hZERlZmF1bHRzOiB7CgkJCXR5cGU6ICJnZXQiLAoJCQlkYXRhOiB1bmRlZmluZWQsCgoJCQkvLyBERVBSRUNBVEVECgkJCXJlbG9hZFBhZ2U6IGZhbHNlLAoKCQkJcmVsb2FkOiBmYWxzZSwKCgkJCS8vIEJ5IGRlZmF1bHQgd2UgcmVseSBvbiB0aGUgcm9sZSBkZWZpbmVkIGJ5IHRoZSBAZGF0YS1yb2xlIGF0dHJpYnV0ZS4KCQkJcm9sZTogdW5kZWZpbmVkLAoKCQkJc2hvd0xvYWRNc2c6IGZhbHNlLAoKCQkJLy8gVGhpcyBkZWxheSBhbGxvd3MgbG9hZHMgdGhhdCBwdWxsIGZyb20gYnJvd3NlciBjYWNoZSB0bwoJCQkvLyBvY2N1ciB3aXRob3V0IHNob3dpbmcgdGhlIGxvYWRpbmcgbWVzc2FnZS4KCQkJbG9hZE1zZ0RlbGF5OiA1MAoJCX0sCgoJCWxvYWQ6IGZ1bmN0aW9uKCB1cmwsIG9wdGlvbnMgKSB7CgkJCS8vIFRoaXMgZnVuY3Rpb24gdXNlcyBkZWZlcnJlZCBub3RpZmljYXRpb25zIHRvIGxldCBjYWxsZXJzCgkJCS8vIGtub3cgd2hlbiB0aGUgY29udGVudCBpcyBkb25lIGxvYWRpbmcsIG9yIGlmIGFuIGVycm9yIGhhcyBvY2N1cnJlZC4KCQkJdmFyIGRlZmVycmVkID0gKCBvcHRpb25zICYmIG9wdGlvbnMuZGVmZXJyZWQgKSB8fCAkLkRlZmVycmVkKCksCgoJCQkJLy8gVGhlIGRlZmF1bHQgbG9hZCBvcHRpb25zIHdpdGggb3ZlcnJpZGVzIHNwZWNpZmllZCBieSB0aGUgY2FsbGVyLgoJCQkJc2V0dGluZ3MgPSAkLmV4dGVuZCgge30sIHRoaXMuX2xvYWREZWZhdWx0cywgb3B0aW9ucyApLAoKCQkJCS8vIFRoZSBET00gZWxlbWVudCBmb3IgdGhlIGNvbnRlbnQgYWZ0ZXIgaXQgaGFzIGJlZW4gbG9hZGVkLgoJCQkJY29udGVudCA9IG51bGwsCgoJCQkJLy8gVGhlIGFic29sdXRlIHZlcnNpb24gb2YgdGhlIFVSTCBwYXNzZWQgaW50byB0aGUgZnVuY3Rpb24uIFRoaXMKCQkJCS8vIHZlcnNpb24gb2YgdGhlIFVSTCBtYXkgY29udGFpbiBkaWFsb2cvc3ViY29udGVudCBwYXJhbXMgaW4gaXQuCgkJCQlhYnNVcmwgPSAkLm1vYmlsZS5wYXRoLm1ha2VVcmxBYnNvbHV0ZSggdXJsLCB0aGlzLl9maW5kQmFzZVdpdGhEZWZhdWx0KCkgKSwKCQkJCWZpbGVVcmwsIGRhdGFVcmwsIHBibEV2ZW50LCB0cmlnZ2VyRGF0YTsKCgkJCS8vIERFUFJFQ0FURUQgcmVsb2FkUGFnZQoJCQlzZXR0aW5ncy5yZWxvYWQgPSBzZXR0aW5ncy5yZWxvYWRQYWdlOwoKCQkJLy8gSWYgdGhlIGNhbGxlciBwcm92aWRlZCBkYXRhLCBhbmQgd2UncmUgdXNpbmcgImdldCIgcmVxdWVzdCwKCQkJLy8gYXBwZW5kIHRoZSBkYXRhIHRvIHRoZSBVUkwuCgkJCWlmICggc2V0dGluZ3MuZGF0YSAmJiBzZXR0aW5ncy50eXBlID09PSAiZ2V0IiApIHsKCQkJCWFic1VybCA9ICQubW9iaWxlLnBhdGguYWRkU2VhcmNoUGFyYW1zKCBhYnNVcmwsIHNldHRpbmdzLmRhdGEgKTsKCQkJCXNldHRpbmdzLmRhdGEgPSB1bmRlZmluZWQ7CgkJCX0KCgkJCS8vIElmIHRoZSBjYWxsZXIgaXMgdXNpbmcgYSAicG9zdCIgcmVxdWVzdCwgcmVsb2FkIG11c3QgYmUgdHJ1ZQoJCQlpZiAoIHNldHRpbmdzLmRhdGEgJiYgc2V0dGluZ3MudHlwZSA9PT0gInBvc3QiICkgewoJCQkJc2V0dGluZ3MucmVsb2FkID0gdHJ1ZTsKCQkJfQoKCQkJLy8gVGhlIGFic29sdXRlIHZlcnNpb24gb2YgdGhlIFVSTCBtaW51cyBhbnkgZGlhbG9nL3N1YmNvbnRlbnQgcGFyYW1zLgoJCQkvLyBJbiBvdGhlcndvcmRzIHRoZSByZWFsIFVSTCBvZiB0aGUgY29udGVudCB0byBiZSBsb2FkZWQuCgkJCWZpbGVVcmwgPSB0aGlzLl9jcmVhdGVGaWxlVXJsKCBhYnNVcmwgKTsKCgkJCS8vIFRoZSB2ZXJzaW9uIG9mIHRoZSBVcmwgYWN0dWFsbHkgc3RvcmVkIGluIHRoZSBkYXRhLXVybCBhdHRyaWJ1dGUgb2YKCQkJLy8gdGhlIGNvbnRlbnQuIEZvciBlbWJlZGRlZCBjb250ZW50LCBpdCBpcyBqdXN0IHRoZSBpZCBvZiB0aGUgcGFnZS4gRm9yCgkJCS8vIGNvbnRlbnQgd2l0aGluIHRoZSBzYW1lIGRvbWFpbiBhcyB0aGUgZG9jdW1lbnQgYmFzZSwgaXQgaXMgdGhlIHNpdGUKCQkJLy8gcmVsYXRpdmUgcGF0aC4gRm9yIGNyb3NzLWRvbWFpbiBjb250ZW50IChQaG9uZSBHYXAgb25seSkgdGhlIGVudGlyZQoJCQkvLyBhYnNvbHV0ZSBVcmwgaXMgdXNlZCB0byBsb2FkIHRoZSBjb250ZW50LgoJCQlkYXRhVXJsID0gdGhpcy5fY3JlYXRlRGF0YVVybCggYWJzVXJsICk7CgoJCQljb250ZW50ID0gdGhpcy5fZmluZCggYWJzVXJsICk7CgoJCQkvLyBJZiBpdCBpc24ndCBhIHJlZmVyZW5jZSB0byB0aGUgZmlyc3QgY29udGVudCBhbmQgcmVmZXJzIHRvIG1pc3NpbmcKCQkJLy8gZW1iZWRkZWQgY29udGVudCByZWplY3QgdGhlIGRlZmVycmVkIGFuZCByZXR1cm4KCQkJaWYgKCBjb250ZW50Lmxlbmd0aCA9PT0gMCAmJgoJCQkJJC5tb2JpbGUucGF0aC5pc0VtYmVkZGVkUGFnZShmaWxlVXJsKSAmJgoJCQkJISQubW9iaWxlLnBhdGguaXNGaXJzdFBhZ2VVcmwoZmlsZVVybCkgKSB7CgkJCQlkZWZlcnJlZC5yZWplY3QoIGFic1VybCwgc2V0dGluZ3MgKTsKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gUmVzZXQgYmFzZSB0byB0aGUgZGVmYXVsdCBkb2N1bWVudCBiYXNlCgkJCS8vIFRPRE8gZmlndXJlIG91dCB3aHkgd2UgZG9lIHRoaXMKCQkJdGhpcy5fZ2V0QmFzZSgpLnJlc2V0KCk7CgoJCQkvLyBJZiB0aGUgY29udGVudCB3ZSBhcmUgaW50ZXJlc3RlZCBpbiBpcyBhbHJlYWR5IGluIHRoZSBET00sCgkJCS8vIGFuZCB0aGUgY2FsbGVyIGRpZCBub3QgaW5kaWNhdGUgdGhhdCB3ZSBzaG91bGQgZm9yY2UgYQoJCQkvLyByZWxvYWQgb2YgdGhlIGZpbGUsIHdlIGFyZSBkb25lLiBSZXNvbHZlIHRoZSBkZWZlcnJyZWQgc28gdGhhdAoJCQkvLyB1c2VycyBjYW4gYmluZCB0byAuZG9uZSBvbiB0aGUgcHJvbWlzZQoJCQlpZiAoIGNvbnRlbnQubGVuZ3RoICYmICFzZXR0aW5ncy5yZWxvYWQgKSB7CgkJCQl0aGlzLl9lbmhhbmNlKCBjb250ZW50LCBzZXR0aW5ncy5yb2xlICk7CgkJCQlkZWZlcnJlZC5yZXNvbHZlKCBhYnNVcmwsIHNldHRpbmdzLCBjb250ZW50ICk7CgoJCQkJLy9pZiB3ZSBhcmUgcmVsb2FkaW5nIHRoZSBjb250ZW50IG1ha2Ugc3VyZSB3ZSB1cGRhdGUKCQkJCS8vIHRoZSBiYXNlIGlmIGl0cyBub3QgYSBwcmVmZXRjaAoJCQkJaWYgKCAhc2V0dGluZ3MucHJlZmV0Y2ggKXsKCQkJCQl0aGlzLl9nZXRCYXNlKCkuc2V0KHVybCk7CgkJCQl9CgoJCQkJcmV0dXJuOwoJCQl9CgoJCQl0cmlnZ2VyRGF0YSA9IHsKCQkJCXVybDogdXJsLAoJCQkJYWJzVXJsOiBhYnNVcmwsCgkJCQlkYXRhVXJsOiBkYXRhVXJsLAoJCQkJZGVmZXJyZWQ6IGRlZmVycmVkLAoJCQkJb3B0aW9uczogc2V0dGluZ3MKCQkJfTsKCgkJCS8vIExldCBsaXN0ZW5lcnMga25vdyB3ZSdyZSBhYm91dCB0byBsb2FkIGNvbnRlbnQuCgkJCXBibEV2ZW50ID0gdGhpcy5fdHJpZ2dlcldpdGhEZXByZWNhdGVkKCAiYmVmb3JlbG9hZCIsIHRyaWdnZXJEYXRhICk7CgoJCQkvLyBJZiB0aGUgZGVmYXVsdCBiZWhhdmlvciBpcyBwcmV2ZW50ZWQsIHN0b3AgaGVyZSEKCQkJaWYgKCBwYmxFdmVudC5kZXByZWNhdGVkRXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgfHwKCQkJCXBibEV2ZW50LmV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQlpZiAoIHNldHRpbmdzLnNob3dMb2FkTXNnICkgewoJCQkJdGhpcy5fc2hvd0xvYWRpbmcoIHNldHRpbmdzLmxvYWRNc2dEZWxheSApOwoJCQl9CgoJCQkvLyBSZXNldCBiYXNlIHRvIHRoZSBkZWZhdWx0IGRvY3VtZW50IGJhc2UuCgkJCS8vIG9ubHkgcmVzZXQgaWYgd2UgYXJlIG5vdCBwcmVmZXRjaGluZwoJCQlpZiAoIHNldHRpbmdzLnByZWZldGNoID09PSB1bmRlZmluZWQgKSB7CgkJCQl0aGlzLl9nZXRCYXNlKCkucmVzZXQoKTsKCQkJfQoKCQkJaWYgKCAhKCAkLm1vYmlsZS5hbGxvd0Nyb3NzRG9tYWluUGFnZXMgfHwKCQkJCSQubW9iaWxlLnBhdGguaXNTYW1lRG9tYWluKCQubW9iaWxlLnBhdGguZG9jdW1lbnRVcmwsIGFic1VybCApICkgKSB7CgkJCQlkZWZlcnJlZC5yZWplY3QoIGFic1VybCwgc2V0dGluZ3MgKTsKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gTG9hZCB0aGUgbmV3IGNvbnRlbnQuCgkJCSQuYWpheCh7CgkJCQl1cmw6IGZpbGVVcmwsCgkJCQl0eXBlOiBzZXR0aW5ncy50eXBlLAoJCQkJZGF0YTogc2V0dGluZ3MuZGF0YSwKCQkJCWNvbnRlbnRUeXBlOiBzZXR0aW5ncy5jb250ZW50VHlwZSwKCQkJCWRhdGFUeXBlOiAiaHRtbCIsCgkJCQlzdWNjZXNzOiB0aGlzLl9sb2FkU3VjY2VzcyggYWJzVXJsLCB0cmlnZ2VyRGF0YSwgc2V0dGluZ3MsIGRlZmVycmVkICksCgkJCQllcnJvcjogdGhpcy5fbG9hZEVycm9yKCBhYnNVcmwsIHRyaWdnZXJEYXRhLCBzZXR0aW5ncywgZGVmZXJyZWQgKQoJCQl9KTsKCQl9LAoKCQlfbG9hZEVycm9yOiBmdW5jdGlvbiggYWJzVXJsLCB0cmlnZ2VyRGF0YSwgc2V0dGluZ3MsIGRlZmVycmVkICkgewoJCQlyZXR1cm4gJC5wcm94eShmdW5jdGlvbiggeGhyLCB0ZXh0U3RhdHVzLCBlcnJvclRocm93biApIHsKCQkJCS8vc2V0IGJhc2UgYmFjayB0byBjdXJyZW50IHBhdGgKCQkJCXRoaXMuX2dldEJhc2UoKS5zZXQoICQubW9iaWxlLnBhdGguZ2V0KCkgKTsKCgkJCQkvLyBBZGQgZXJyb3IgaW5mbyB0byBvdXIgdHJpZ2dlckRhdGEuCgkJCQl0cmlnZ2VyRGF0YS54aHIgPSB4aHI7CgkJCQl0cmlnZ2VyRGF0YS50ZXh0U3RhdHVzID0gdGV4dFN0YXR1czsKCQkJCXRyaWdnZXJEYXRhLmVycm9yVGhyb3duID0gZXJyb3JUaHJvd247CgoJCQkJLy8gTGV0IGxpc3RlbmVycyBrbm93IHRoZSBwYWdlIGxvYWQgZmFpbGVkLgoJCQkJdmFyIHBsZkV2ZW50ID0gdGhpcy5fdHJpZ2dlcldpdGhEZXByZWNhdGVkKCAibG9hZGZhaWxlZCIsIHRyaWdnZXJEYXRhICk7CgoJCQkJLy8gSWYgdGhlIGRlZmF1bHQgYmVoYXZpb3IgaXMgcHJldmVudGVkLCBzdG9wIGhlcmUhCgkJCQkvLyBOb3RlIHRoYXQgaXQgaXMgdGhlIHJlc3BvbnNpYmlsaXR5IG9mIHRoZSBsaXN0ZW5lci9oYW5kbGVyCgkJCQkvLyB0aGF0IGNhbGxlZCBwcmV2ZW50RGVmYXVsdCgpLCB0byByZXNvbHZlL3JlamVjdCB0aGUKCQkJCS8vIGRlZmVycmVkIG9iamVjdCB3aXRoaW4gdGhlIHRyaWdnZXJEYXRhLgoJCQkJaWYgKCBwbGZFdmVudC5kZXByZWNhdGVkRXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgfHwKCQkJCQlwbGZFdmVudC5ldmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJLy8gUmVtb3ZlIGxvYWRpbmcgbWVzc2FnZS4KCQkJCWlmICggc2V0dGluZ3Muc2hvd0xvYWRNc2cgKSB7CgkJCQkJdGhpcy5fc2hvd0Vycm9yKCk7CgkJCQl9CgoJCQkJZGVmZXJyZWQucmVqZWN0KCBhYnNVcmwsIHNldHRpbmdzICk7CgkJCX0sIHRoaXMpOwoJCX0sCgoJCV9nZXRUcmFuc2l0aW9uSGFuZGxlcjogZnVuY3Rpb24oIHRyYW5zaXRpb24gKSB7CgkJCXRyYW5zaXRpb24gPSAkLm1vYmlsZS5fbWF5YmVEZWdyYWRlVHJhbnNpdGlvbiggdHJhbnNpdGlvbiApOwoKCQkJLy9maW5kIHRoZSB0cmFuc2l0aW9uIGhhbmRsZXIgZm9yIHRoZSBzcGVjaWZpZWQgdHJhbnNpdGlvbi4gSWYgdGhlcmUKCQkJLy9pc24ndCBvbmUgaW4gb3VyIHRyYW5zaXRpb25IYW5kbGVycyBkaWN0aW9uYXJ5LCB1c2UgdGhlIGRlZmF1bHQgb25lLgoJCQkvL2NhbGwgdGhlIGhhbmRsZXIgaW1tZWRpYXRlbHkgdG8ga2ljay1vZmYgdGhlIHRyYW5zaXRpb24uCgkJCXJldHVybiAkLm1vYmlsZS50cmFuc2l0aW9uSGFuZGxlcnNbIHRyYW5zaXRpb24gXSB8fCAkLm1vYmlsZS5kZWZhdWx0VHJhbnNpdGlvbkhhbmRsZXI7CgkJfSwKCgkJLy8gVE9ETyBtb3ZlIGludG8gdHJhbnNpdGlvbiBoYW5kbGVycz8KCQlfdHJpZ2dlckNzc1RyYW5zaXRpb25FdmVudHM6IGZ1bmN0aW9uKCB0bywgZnJvbSwgcHJlZml4ICkgewoJCQlwcmVmaXggPSBwcmVmaXggfHwgIiI7CgoJCQkvLyBUT0RPIGRlY2lkZSBpZiB0aGVzZSBldmVudHMgc2hvdWxkIGluIGZhY3QgYmUgdHJpZ2dlcmVkIG9uIHRoZSBjb250YWluZXIKCQkJaWYgKCBmcm9tICkgewoJCQkJLy90cmlnZ2VyIGJlZm9yZSBzaG93L2hpZGUgZXZlbnRzCgkJCQkvLyBUT0RPIGRlcHJlY2F0ZSBuZXh0UGFnZSBpbiBmYXZvciBvZiBuZXh0CgkJCQl0aGlzLl90cmlnZ2VyV2l0aERlcHJlY2F0ZWQoIHByZWZpeCArICJoaWRlIiwgeyBuZXh0UGFnZTogdG8gfSwgZnJvbSApOwoJCQl9CgoJCQkvLyBUT0RPIGRlcHJlY2F0ZSBwcmV2UGFnZSBpbiBmYXZvciBvZiBwcmV2aW91cwoJCQl0aGlzLl90cmlnZ2VyV2l0aERlcHJlY2F0ZWQoIHByZWZpeCArICJzaG93IiwgeyBwcmV2UGFnZTogZnJvbSB8fCAkKCAiIiApIH0sIHRvICk7CgkJfSwKCgkJLy8gVE9ETyBtYWtlIHByaXZhdGUgb25jZSBjaGFuZ2UgaGFzIGJlZW4gZGVmaW5lZCBpbiB0aGUgd2lkZ2V0CgkJX2Nzc1RyYW5zaXRpb246IGZ1bmN0aW9uKCB0bywgZnJvbSwgb3B0aW9ucyApIHsKCQkJdmFyIHRyYW5zaXRpb24gPSBvcHRpb25zLnRyYW5zaXRpb24sCgkJCQlyZXZlcnNlID0gb3B0aW9ucy5yZXZlcnNlLAoJCQkJZGVmZXJyZWQgPSBvcHRpb25zLmRlZmVycmVkLAoJCQkJVHJhbnNpdGlvbkhhbmRsZXIsCgkJCQlwcm9taXNlOwoKCQkJdGhpcy5fdHJpZ2dlckNzc1RyYW5zaXRpb25FdmVudHMoIHRvLCBmcm9tLCAiYmVmb3JlIiApOwoKCQkJLy8gVE9ETyBwdXQgdGhpcyBpbiBhIGJpbmRpbmcgdG8gZXZlbnRzICpvdXRzaWRlKiB0aGUgd2lkZ2V0CgkJCXRoaXMuX2hpZGVMb2FkaW5nKCk7CgoJCQlUcmFuc2l0aW9uSGFuZGxlciA9IHRoaXMuX2dldFRyYW5zaXRpb25IYW5kbGVyKCB0cmFuc2l0aW9uICk7CgoJCQlwcm9taXNlID0gKCBuZXcgVHJhbnNpdGlvbkhhbmRsZXIoIHRyYW5zaXRpb24sIHJldmVyc2UsIHRvLCBmcm9tICkgKS50cmFuc2l0aW9uKCk7CgoJCQkvLyBUT0RPIHRlbXBvcmFyeSBhY2NvbW9kYXRpb24gb2YgYXJndW1lbnQgZGVmZXJyZWQKCQkJcHJvbWlzZS5kb25lKGZ1bmN0aW9uKCkgewoJCQkJZGVmZXJyZWQucmVzb2x2ZS5hcHBseSggZGVmZXJyZWQsIGFyZ3VtZW50cyApOwoJCQl9KTsKCgkJCXByb21pc2UuZG9uZSgkLnByb3h5KGZ1bmN0aW9uKCkgewoJCQkJdGhpcy5fdHJpZ2dlckNzc1RyYW5zaXRpb25FdmVudHMoIHRvLCBmcm9tICk7CgkJCX0sIHRoaXMpKTsKCQl9LAoKCQlfcmVsZWFzZVRyYW5zaXRpb25Mb2NrOiBmdW5jdGlvbigpIHsKCQkJLy9yZWxlYXNlIHRyYW5zaXRpb24gbG9jayBzbyBuYXZpZ2F0aW9uIGlzIGZyZWUgYWdhaW4KCQkJaXNQYWdlVHJhbnNpdGlvbmluZyA9IGZhbHNlOwoJCQlpZiAoIHBhZ2VUcmFuc2l0aW9uUXVldWUubGVuZ3RoID4gMCApIHsKCQkJCSQubW9iaWxlLmNoYW5nZVBhZ2UuYXBwbHkoIG51bGwsIHBhZ2VUcmFuc2l0aW9uUXVldWUucG9wKCkgKTsKCQkJfQoJCX0sCgoJCV9yZW1vdmVBY3RpdmVMaW5rQ2xhc3M6IGZ1bmN0aW9uKCBmb3JjZSApIHsKCQkJLy9jbGVhciBvdXQgdGhlIGFjdGl2ZSBidXR0b24gc3RhdGUKCQkJJC5tb2JpbGUucmVtb3ZlQWN0aXZlTGlua0NsYXNzKCBmb3JjZSApOwoJCX0sCgoJCV9sb2FkVXJsOiBmdW5jdGlvbiggdG8sIHRyaWdnZXJEYXRhLCBzZXR0aW5ncyApIHsKCQkJLy8gcHJlc2VydmUgdGhlIG9yaWdpbmFsIHRhcmdldCBhcyB0aGUgZGF0YVVybCB2YWx1ZSB3aWxsIGJlCgkJCS8vIHNpbXBsaWZpZWQgZWcsIHJlbW92aW5nIHVpLXN0YXRlLCBhbmQgcmVtb3ZpbmcgcXVlcnkgcGFyYW1zCgkJCS8vIGZyb20gdGhlIGhhc2ggdGhpcyBpcyBzbyB0aGF0IHVzZXJzIHdobyB3YW50IHRvIHVzZSBxdWVyeQoJCQkvLyBwYXJhbXMgaGF2ZSBhY2Nlc3MgdG8gdGhlbSBpbiB0aGUgZXZlbnQgYmluZGluZ3MgZm9yIHRoZSBwYWdlCgkJCS8vIGxpZmUgY3ljbGUgU2VlIGlzc3VlICM1MDg1CgkJCXNldHRpbmdzLnRhcmdldCA9IHRvOwoJCQlzZXR0aW5ncy5kZWZlcnJlZCA9ICQuRGVmZXJyZWQoKTsKCgkJCXRoaXMubG9hZCggdG8sIHNldHRpbmdzICk7CgoJCQlzZXR0aW5ncy5kZWZlcnJlZC5kb25lKCQucHJveHkoZnVuY3Rpb24oIHVybCwgb3B0aW9ucywgY29udGVudCApIHsKCQkJCWlzUGFnZVRyYW5zaXRpb25pbmcgPSBmYWxzZTsKCgkJCQkvLyBzdG9yZSB0aGUgb3JpZ2luYWwgYWJzb2x1dGUgdXJsIHNvIHRoYXQgaXQgY2FuIGJlIHByb3ZpZGVkCgkJCQkvLyB0byBldmVudHMgaW4gdGhlIHRyaWdnZXJEYXRhIG9mIHRoZSBzdWJzZXF1ZW50IGNoYW5nZVBhZ2UgY2FsbAoJCQkJb3B0aW9ucy5hYnNVcmwgPSB0cmlnZ2VyRGF0YS5hYnNVcmw7CgoJCQkJdGhpcy50cmFuc2l0aW9uKCBjb250ZW50LCB0cmlnZ2VyRGF0YSwgb3B0aW9ucyApOwoJCQl9LCB0aGlzKSk7CgoJCQlzZXR0aW5ncy5kZWZlcnJlZC5mYWlsKCQucHJveHkoZnVuY3Rpb24oLyogdXJsLCBvcHRpb25zICovKSB7CgkJCQl0aGlzLl9yZW1vdmVBY3RpdmVMaW5rQ2xhc3MoIHRydWUgKTsKCQkJCXRoaXMuX3JlbGVhc2VUcmFuc2l0aW9uTG9jaygpOwoJCQkJdGhpcy5fdHJpZ2dlcldpdGhEZXByZWNhdGVkKCAiY2hhbmdlZmFpbGVkIiwgdHJpZ2dlckRhdGEgKTsKCQkJfSwgdGhpcykpOwoJCX0sCgoJCV90cmlnZ2VyUGFnZUJlZm9yZUNoYW5nZTogZnVuY3Rpb24oIHRvLCB0cmlnZ2VyRGF0YSwgc2V0dGluZ3MgKSB7CgkJCXZhciBwYmNFdmVudCA9IG5ldyAkLkV2ZW50KCAicGFnZWJlZm9yZWNoYW5nZSIgKTsKCgkJCSQuZXh0ZW5kKHRyaWdnZXJEYXRhLCB7IHRvUGFnZTogdG8sIG9wdGlvbnM6IHNldHRpbmdzIH0pOwoKCQkJLy8gTk9URTogcHJlc2VydmUgdGhlIG9yaWdpbmFsIHRhcmdldCBhcyB0aGUgZGF0YVVybCB2YWx1ZSB3aWxsIGJlCgkJCS8vIHNpbXBsaWZpZWQgZWcsIHJlbW92aW5nIHVpLXN0YXRlLCBhbmQgcmVtb3ZpbmcgcXVlcnkgcGFyYW1zIGZyb20KCQkJLy8gdGhlIGhhc2ggdGhpcyBpcyBzbyB0aGF0IHVzZXJzIHdobyB3YW50IHRvIHVzZSBxdWVyeSBwYXJhbXMgaGF2ZQoJCQkvLyBhY2Nlc3MgdG8gdGhlbSBpbiB0aGUgZXZlbnQgYmluZGluZ3MgZm9yIHRoZSBwYWdlIGxpZmUgY3ljbGUKCQkJLy8gU2VlIGlzc3VlICM1MDg1CgkJCWlmICggJC50eXBlKHRvKSA9PT0gInN0cmluZyIgKSB7CgkJCQkvLyBpZiB0aGUgdG9QYWdlIGlzIGEgc3RyaW5nIHNpbXBseSBjb252ZXJ0IGl0CgkJCQl0cmlnZ2VyRGF0YS5hYnNVcmwgPSAkLm1vYmlsZS5wYXRoLm1ha2VVcmxBYnNvbHV0ZSggdG8sIHRoaXMuX2ZpbmRCYXNlV2l0aERlZmF1bHQoKSApOwoJCQl9IGVsc2UgewoJCQkJLy8gaWYgdGhlIHRvUGFnZSBpcyBhIGpRdWVyeSBvYmplY3QgZ3JhYiB0aGUgYWJzb2x1dGUgdXJsIHN0b3JlZAoJCQkJLy8gaW4gdGhlIGxvYWRQYWdlIGNhbGxiYWNrIHdoZXJlIGl0IGV4aXN0cwoJCQkJdHJpZ2dlckRhdGEuYWJzVXJsID0gc2V0dGluZ3MuYWJzVXJsOwoJCQl9CgoJCQkvLyBMZXQgbGlzdGVuZXJzIGtub3cgd2UncmUgYWJvdXQgdG8gY2hhbmdlIHRoZSBjdXJyZW50IHBhZ2UuCgkJCXRoaXMuZWxlbWVudC50cmlnZ2VyKCBwYmNFdmVudCwgdHJpZ2dlckRhdGEgKTsKCgkJCS8vIElmIHRoZSBkZWZhdWx0IGJlaGF2aW9yIGlzIHByZXZlbnRlZCwgc3RvcCBoZXJlIQoJCQlpZiAoIHBiY0V2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgoJCQlyZXR1cm4gdHJ1ZTsKCQl9LAoKCQljaGFuZ2U6IGZ1bmN0aW9uKCB0bywgb3B0aW9ucyApIHsKCQkJLy8gSWYgd2UgYXJlIGluIHRoZSBtaWRzdCBvZiBhIHRyYW5zaXRpb24sIHF1ZXVlIHRoZSBjdXJyZW50IHJlcXVlc3QuCgkJCS8vIFdlJ2xsIGNhbGwgY2hhbmdlUGFnZSgpIG9uY2Ugd2UncmUgZG9uZSB3aXRoIHRoZSBjdXJyZW50IHRyYW5zaXRpb24KCQkJLy8gdG8gc2VydmljZSB0aGUgcmVxdWVzdC4KCQkJaWYgKCBpc1BhZ2VUcmFuc2l0aW9uaW5nICkgewoJCQkJcGFnZVRyYW5zaXRpb25RdWV1ZS51bnNoaWZ0KCBhcmd1bWVudHMgKTsKCQkJCXJldHVybjsKCQkJfQoKCQkJdmFyIHNldHRpbmdzID0gJC5leHRlbmQoIHt9LCAkLm1vYmlsZS5jaGFuZ2VQYWdlLmRlZmF1bHRzLCBvcHRpb25zICksCgkJCQl0cmlnZ2VyRGF0YSA9IHt9OwoKCQkJLy8gTWFrZSBzdXJlIHdlIGhhdmUgYSBmcm9tUGFnZS4KCQkJc2V0dGluZ3MuZnJvbVBhZ2UgPSBzZXR0aW5ncy5mcm9tUGFnZSB8fCB0aGlzLmFjdGl2ZVBhZ2U7CgoJCQkvLyBpZiB0aGUgcGFnZSBiZWZvcmVjaGFuZ2UgZGVmYXVsdCBpcyBwcmV2ZW50ZWQgcmV0dXJuIGVhcmx5CgkJCWlmICggIXRoaXMuX3RyaWdnZXJQYWdlQmVmb3JlQ2hhbmdlKHRvLCB0cmlnZ2VyRGF0YSwgc2V0dGluZ3MpICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBXZSBhbGxvdyAicGFnZWJlZm9yZWNoYW5nZSIgb2JzZXJ2ZXJzIHRvIG1vZGlmeSB0aGUgdG8gaW4KCQkJLy8gdGhlIHRyaWdnZXIgZGF0YSB0byBhbGxvdyBmb3IgcmVkaXJlY3RzLiBNYWtlIHN1cmUgb3VyIHRvIGlzCgkJCS8vIHVwZGF0ZWQuIFdlIGFsc28gbmVlZCB0byByZS1ldmFsdWF0ZSB3aGV0aGVyIGl0IGlzIGEgc3RyaW5nLAoJCQkvLyBiZWNhdXNlIGFuIG9iamVjdCBjYW4gYWxzbyBiZSByZXBsYWNlZCBieSBhIHN0cmluZwoJCQl0byA9IHRyaWdnZXJEYXRhLnRvUGFnZTsKCgkJCS8vIElmIHRoZSBjYWxsZXIgcGFzc2VkIHVzIGEgdXJsLCBjYWxsIGxvYWRQYWdlKCkKCQkJLy8gdG8gbWFrZSBzdXJlIGl0IGlzIGxvYWRlZCBpbnRvIHRoZSBET00uIFdlJ2xsIGxpc3RlbgoJCQkvLyB0byB0aGUgcHJvbWlzZSBvYmplY3QgaXQgcmV0dXJucyBzbyB3ZSBrbm93IHdoZW4KCQkJLy8gaXQgaXMgZG9uZSBsb2FkaW5nIG9yIGlmIGFuIGVycm9yIG9jdXJyZWQuCgkJCWlmICggJC50eXBlKHRvKSA9PT0gInN0cmluZyIgKSB7CgkJCQkvLyBTZXQgdGhlIGlzUGFnZVRyYW5zaXRpb25pbmcgZmxhZyB0byBwcmV2ZW50IGFueSByZXF1ZXN0cyBmcm9tCgkJCQkvLyBlbnRlcmluZyB0aGlzIG1ldGhvZCB3aGlsZSB3ZSBhcmUgaW4gdGhlIG1pZHN0IG9mIGxvYWRpbmcgYSBwYWdlCgkJCQkvLyBvciB0cmFuc2l0aW9uaW5nLgoJCQkJaXNQYWdlVHJhbnNpdGlvbmluZyA9IHRydWU7CgoJCQkJdGhpcy5fbG9hZFVybCggdG8sIHRyaWdnZXJEYXRhLCBzZXR0aW5ncyApOwoJCQl9IGVsc2UgewoJCQkJdGhpcy50cmFuc2l0aW9uKCB0bywgdHJpZ2dlckRhdGEsIHNldHRpbmdzICk7CgkJCX0KCQl9LAoKCQl0cmFuc2l0aW9uOiBmdW5jdGlvbiggdG9QYWdlLCB0cmlnZ2VyRGF0YSwgc2V0dGluZ3MgKSB7CgkJCXZhciBmcm9tUGFnZSwgdXJsLCBwYWdlVXJsLCBmaWxlVXJsLAoJCQkJYWN0aXZlLCBhY3RpdmVJc0luaXRpYWxQYWdlLAoJCQkJaGlzdG9yeURpciwgcGFnZVRpdGxlLCBpc0RpYWxvZywKCQkJCWFscmVhZHlUaGVyZSwgbmV3UGFnZVRpdGxlLAoJCQkJcGFyYW1zLAljc3NUcmFuc2l0aW9uRGVmZXJyZWQsCgkJCQliZWZvcmVUcmFuc2l0aW9uOwoKCQkJLy8gSWYgd2UgYXJlIGluIHRoZSBtaWRzdCBvZiBhIHRyYW5zaXRpb24sIHF1ZXVlIHRoZSBjdXJyZW50IHJlcXVlc3QuCgkJCS8vIFdlJ2xsIGNhbGwgY2hhbmdlUGFnZSgpIG9uY2Ugd2UncmUgZG9uZSB3aXRoIHRoZSBjdXJyZW50IHRyYW5zaXRpb24KCQkJLy8gdG8gc2VydmljZSB0aGUgcmVxdWVzdC4KCQkJaWYgKCBpc1BhZ2VUcmFuc2l0aW9uaW5nICkgewoJCQkJLy8gbWFrZSBzdXJlIHRvIG9ubHkgcXVldWUgdGhlIHRvIGFuZCBzZXR0aW5ncyB2YWx1ZXMgc28gdGhlIGFyZ3VtZW50cwoJCQkJLy8gd29yayB3aXRoIGEgY2FsbCB0byB0aGUgY2hhbmdlIG1ldGhvZAoJCQkJcGFnZVRyYW5zaXRpb25RdWV1ZS51bnNoaWZ0KCBbdG9QYWdlLCBzZXR0aW5nc10gKTsKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gREVQUkVDQVRFRCAtIHRoaXMgY2FsbCBvbmx5LCBpbiBmYXZvciBvZiB0aGUgYmVmb3JlIHRyYW5zaXRpb24KCQkJLy8gaWYgdGhlIHBhZ2UgYmVmb3JlY2hhbmdlIGRlZmF1bHQgaXMgcHJldmVudGVkIHJldHVybiBlYXJseQoJCQlpZiAoICF0aGlzLl90cmlnZ2VyUGFnZUJlZm9yZUNoYW5nZSh0b1BhZ2UsIHRyaWdnZXJEYXRhLCBzZXR0aW5ncykgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIGlmIHRoZSAoY29udGVudHxwYWdlKWJlZm9yZXRyYW5zaXRpb24gZGVmYXVsdCBpcyBwcmV2ZW50ZWQgcmV0dXJuIGVhcmx5CgkJCS8vIE5vdGUsIHdlIGhhdmUgdG8gY2hlY2sgZm9yIGJvdGggdGhlIGRlcHJlY2F0ZWQgYW5kIG5ldyBldmVudHMKCQkJYmVmb3JlVHJhbnNpdGlvbiA9IHRoaXMuX3RyaWdnZXJXaXRoRGVwcmVjYXRlZCggImJlZm9yZXRyYW5zaXRpb24iLCB0cmlnZ2VyRGF0YSApOwoJCQlpZiAoYmVmb3JlVHJhbnNpdGlvbi5kZXByZWNhdGVkRXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgfHwKCQkJCWJlZm9yZVRyYW5zaXRpb24uZXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIFNldCB0aGUgaXNQYWdlVHJhbnNpdGlvbmluZyBmbGFnIHRvIHByZXZlbnQgYW55IHJlcXVlc3RzIGZyb20KCQkJLy8gZW50ZXJpbmcgdGhpcyBtZXRob2Qgd2hpbGUgd2UgYXJlIGluIHRoZSBtaWRzdCBvZiBsb2FkaW5nIGEgcGFnZQoJCQkvLyBvciB0cmFuc2l0aW9uaW5nLgoJCQlpc1BhZ2VUcmFuc2l0aW9uaW5nID0gdHJ1ZTsKCgkJCS8vIElmIHdlIGFyZSBnb2luZyB0byB0aGUgZmlyc3QtcGFnZSBvZiB0aGUgYXBwbGljYXRpb24sIHdlIG5lZWQgdG8gbWFrZQoJCQkvLyBzdXJlIHNldHRpbmdzLmRhdGFVcmwgaXMgc2V0IHRvIHRoZSBhcHBsaWNhdGlvbiBkb2N1bWVudCB1cmwuIFRoaXMgYWxsb3dzCgkJCS8vIHVzIHRvIGF2b2lkIGdlbmVyYXRpbmcgYSBkb2N1bWVudCB1cmwgd2l0aCBhbiBpZCBoYXNoIGluIHRoZSBjYXNlIHdoZXJlIHRoZQoJCQkvLyBmaXJzdC1wYWdlIG9mIHRoZSBkb2N1bWVudCBoYXMgYW4gaWQgYXR0cmlidXRlIHNwZWNpZmllZC4KCQkJaWYgKCB0b1BhZ2VbIDAgXSA9PT0gJC5tb2JpbGUuZmlyc3RQYWdlWyAwIF0gJiYgIXNldHRpbmdzLmRhdGFVcmwgKSB7CgkJCQlzZXR0aW5ncy5kYXRhVXJsID0gJC5tb2JpbGUucGF0aC5kb2N1bWVudFVybC5ocmVmTm9IYXNoOwoJCQl9CgoJCQkvLyBUaGUgY2FsbGVyIHBhc3NlZCB1cyBhIHJlYWwgcGFnZSBET00gZWxlbWVudC4gVXBkYXRlIG91cgoJCQkvLyBpbnRlcm5hbCBzdGF0ZSBhbmQgdGhlbiB0cmlnZ2VyIGEgdHJhbnNpdGlvbiB0byB0aGUgcGFnZS4KCQkJZnJvbVBhZ2UgPSBzZXR0aW5ncy5mcm9tUGFnZTsKCQkJdXJsID0gKCBzZXR0aW5ncy5kYXRhVXJsICYmICQubW9iaWxlLnBhdGguY29udmVydFVybFRvRGF0YVVybChzZXR0aW5ncy5kYXRhVXJsKSApIHx8CgkJCQl0b1BhZ2UuanFtRGF0YSggInVybCIgKTsKCgkJCS8vIFRoZSBwYWdlVXJsIHZhciBpcyB1c3VhbGx5IHRoZSBzYW1lIGFzIHVybCwgZXhjZXB0IHdoZW4gdXJsIGlzIG9ic2N1cmVkCgkJCS8vIGFzIGEgZGlhbG9nIHVybC4gcGFnZVVybCBhbHdheXMgY29udGFpbnMgdGhlIGZpbGUgcGF0aAoJCQlwYWdlVXJsID0gdXJsOwoJCQlmaWxlVXJsID0gJC5tb2JpbGUucGF0aC5nZXRGaWxlUGF0aCggdXJsICk7CgkJCWFjdGl2ZSA9ICQubW9iaWxlLm5hdmlnYXRlLmhpc3RvcnkuZ2V0QWN0aXZlKCk7CgkJCWFjdGl2ZUlzSW5pdGlhbFBhZ2UgPSAkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5LmFjdGl2ZUluZGV4ID09PSAwOwoJCQloaXN0b3J5RGlyID0gMDsKCQkJcGFnZVRpdGxlID0gZG9jdW1lbnQudGl0bGU7CgkJCWlzRGlhbG9nID0gKCBzZXR0aW5ncy5yb2xlID09PSAiZGlhbG9nIiB8fAoJCQkJdG9QYWdlLmpxbURhdGEoICJyb2xlIiApID09PSAiZGlhbG9nIiApICYmCgkJCQl0b1BhZ2UuanFtRGF0YSggImRpYWxvZyIgKSAhPT0gdHJ1ZTsKCgkJCS8vIEJ5IGRlZmF1bHQsIHdlIHByZXZlbnQgY2hhbmdlUGFnZSByZXF1ZXN0cyB3aGVuIHRoZSBmcm9tUGFnZSBhbmQgdG9QYWdlCgkJCS8vIGFyZSB0aGUgc2FtZSBlbGVtZW50LCBidXQgZm9sa3MgdGhhdCBnZW5lcmF0ZSBjb250ZW50CgkJCS8vIG1hbnVhbGx5L2R5bmFtaWNhbGx5IGFuZCByZXVzZSBwYWdlcyB3YW50IHRvIGJlIGFibGUgdG8gdHJhbnNpdGlvbiB0bwoJCQkvLyB0aGUgc2FtZSBwYWdlLiBUbyBhbGxvdyB0aGlzLCB0aGV5IHdpbGwgbmVlZCB0byBjaGFuZ2UgdGhlIGRlZmF1bHQKCQkJLy8gdmFsdWUgb2YgYWxsb3dTYW1lUGFnZVRyYW5zaXRpb24gdG8gdHJ1ZSwgKk9SKiwgcGFzcyBpdCBpbiBhcyBhbgoJCQkvLyBvcHRpb24gd2hlbiB0aGV5IG1hbnVhbGx5IGNhbGwgY2hhbmdlUGFnZSgpLiBJdCBzaG91bGQgYmUgbm90ZWQgdGhhdAoJCQkvLyBvdXIgZGVmYXVsdCB0cmFuc2l0aW9uIGFuaW1hdGlvbnMgYXNzdW1lIHRoYXQgdGhlIGZvcm1QYWdlIGFuZCB0b1BhZ2UKCQkJLy8gYXJlIGRpZmZlcmVudCBlbGVtZW50cywgc28gdGhleSBtYXkgYmVoYXZlIHVuZXhwZWN0ZWRseS4gSXQgaXMgdXAgdG8KCQkJLy8gdGhlIGRldmVsb3BlciB0aGF0IHR1cm5zIG9uIHRoZSBhbGxvd1NhbWVQYWdlVHJhbnNpdGlvbmEgb3B0aW9uIHRvCgkJCS8vIGVpdGhlciB0dXJuIG9mZiB0cmFuc2l0aW9uIGFuaW1hdGlvbnMsIG9yIG1ha2Ugc3VyZSB0aGF0IGFuIGFwcHJvcHJpYXRlCgkJCS8vIGFuaW1hdGlvbiB0cmFuc2l0aW9uIGlzIHVzZWQuCgkJCWlmICggZnJvbVBhZ2UgJiYgZnJvbVBhZ2VbMF0gPT09IHRvUGFnZVswXSAmJgoJCQkJIXNldHRpbmdzLmFsbG93U2FtZVBhZ2VUcmFuc2l0aW9uICkgewoKCQkJCWlzUGFnZVRyYW5zaXRpb25pbmcgPSBmYWxzZTsKCQkJCXRoaXMuX3RyaWdnZXJXaXRoRGVwcmVjYXRlZCggInRyYW5zaXRpb24iLCB0cmlnZ2VyRGF0YSApOwoJCQkJdGhpcy5lbGVtZW50LnRyaWdnZXIoICJwYWdlY2hhbmdlIiwgdHJpZ2dlckRhdGEgKTsKCgkJCQkvLyBFdmVuIGlmIHRoZXJlIGlzIG5vIHBhZ2UgY2hhbmdlIHRvIGJlIGRvbmUsIHdlIHNob3VsZCBrZWVwIHRoZQoJCQkJLy8gdXJsSGlzdG9yeSBpbiBzeW5jIHdpdGggdGhlIGhhc2ggY2hhbmdlcwoJCQkJaWYgKCBzZXR0aW5ncy5mcm9tSGFzaENoYW5nZSApIHsKCQkJCQkkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5LmRpcmVjdCh7IHVybDogdXJsIH0pOwoJCQkJfQoKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gV2UgbmVlZCB0byBtYWtlIHN1cmUgdGhlIHBhZ2Ugd2UgYXJlIGdpdmVuIGhhcyBhbHJlYWR5IGJlZW4gZW5oYW5jZWQuCgkJCXRvUGFnZS5wYWdlKHsgcm9sZTogc2V0dGluZ3Mucm9sZSB9KTsKCgkJCS8vIElmIHRoZSBjaGFuZ2VQYWdlIHJlcXVlc3Qgd2FzIHNlbnQgZnJvbSBhIGhhc2hDaGFuZ2UgZXZlbnQsIGNoZWNrIHRvCgkJCS8vIHNlZSBpZiB0aGUgcGFnZSBpcyBhbHJlYWR5IHdpdGhpbiB0aGUgdXJsSGlzdG9yeSBzdGFjay4gSWYgc28sIHdlJ2xsCgkJCS8vIGFzc3VtZSB0aGUgdXNlciBoaXQgdGhlIGZvcndhcmQvYmFjayBidXR0b24gYW5kIHdpbGwgdHJ5IHRvIG1hdGNoIHRoZQoJCQkvLyB0cmFuc2l0aW9uIGFjY29yZGluZ2x5LgoJCQlpZiAoIHNldHRpbmdzLmZyb21IYXNoQ2hhbmdlICkgewoJCQkJaGlzdG9yeURpciA9IHNldHRpbmdzLmRpcmVjdGlvbiA9PT0gImJhY2siID8gLTEgOiAxOwoJCQl9CgoJCQkvLyBLaWxsIHRoZSBrZXlib2FyZC4KCQkJLy8gWFhYX2pibGFzOiBXZSBuZWVkIHRvIHN0b3AgY3Jhd2xpbmcgdGhlIGVudGlyZSBkb2N1bWVudCB0byBraWxsIGZvY3VzLgoJCQkvLyAgICAgICAgICAgIEluc3RlYWQsIHdlIHNob3VsZCBiZSB0cmFja2luZyBmb2N1cyB3aXRoIGEgZGVsZWdhdGUoKQoJCQkvLyAgICAgICAgICAgIGhhbmRsZXIgc28gd2UgYWxyZWFkeSBoYXZlIHRoZSBlbGVtZW50IGluIGhhbmQgYXQgdGhpcwoJCQkvLyAgICAgICAgICAgIHBvaW50LgoJCQkvLyBXcmFwIHRoaXMgaW4gYSB0cnkvY2F0Y2ggYmxvY2sgc2luY2UgSUU5IHRocm93ICJVbnNwZWNpZmllZCBlcnJvciIgaWYKCQkJLy8gZG9jdW1lbnQuYWN0aXZlRWxlbWVudCBpcyB1bmRlZmluZWQgd2hlbiB3ZSBhcmUgaW4gYW4gSUZyYW1lLgoJCQl0cnkgewoJCQkJaWYgKCBkb2N1bWVudC5hY3RpdmVFbGVtZW50ICYmCgkJCQkJZG9jdW1lbnQuYWN0aXZlRWxlbWVudC5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpICE9PSAiYm9keSIgKSB7CgoJCQkJCSQoIGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQgKS5ibHVyKCk7CgkJCQl9IGVsc2UgewoJCQkJCSQoICJpbnB1dDpmb2N1cywgdGV4dGFyZWE6Zm9jdXMsIHNlbGVjdDpmb2N1cyIgKS5ibHVyKCk7CgkJCQl9CgkJCX0gY2F0Y2goIGUgKSB7fQoKCQkJLy8gUmVjb3JkIHdoZXRoZXIgd2UgYXJlIGF0IGEgcGxhY2UgaW4gaGlzdG9yeSB3aGVyZSBhIGRpYWxvZyB1c2VkIHRvIGJlIC0KCQkJLy8gaWYgc28sIGRvIG5vdCBhZGQgYSBuZXcgaGlzdG9yeSBlbnRyeSBhbmQgZG8gbm90IGNoYW5nZSB0aGUgaGFzaCBlaXRoZXIKCQkJYWxyZWFkeVRoZXJlID0gZmFsc2U7CgoJCQkvLyBJZiB3ZSdyZSBkaXNwbGF5aW5nIHRoZSBwYWdlIGFzIGEgZGlhbG9nLCB3ZSBkb24ndCB3YW50IHRoZSB1cmwKCQkJLy8gZm9yIHRoZSBkaWFsb2cgY29udGVudCB0byBiZSB1c2VkIGluIHRoZSBoYXNoLiBJbnN0ZWFkLCB3ZSB3YW50CgkJCS8vIHRvIGFwcGVuZCB0aGUgZGlhbG9nSGFzaEtleSB0byB0aGUgdXJsIG9mIHRoZSBjdXJyZW50IHBhZ2UuCgkJCWlmICggaXNEaWFsb2cgJiYgYWN0aXZlICkgewoJCQkJLy8gb24gdGhlIGluaXRpYWwgcGFnZSBsb2FkIGFjdGl2ZS51cmwgaXMgdW5kZWZpbmVkIGFuZCBpbiB0aGF0IGNhc2UKCQkJCS8vIHNob3VsZCBiZSBhbiBlbXB0eSBzdHJpbmcuIE1vdmluZyB0aGUgdW5kZWZpbmVkIC0+IGVtcHR5IHN0cmluZyBiYWNrCgkJCQkvLyBpbnRvIHVybEhpc3RvcnkuYWRkTmV3IHNlZW1lZCBpbXBydWRlbnQgZ2l2ZW4gdW5kZWZpbmVkIGJldHRlcgoJCQkJLy8gcmVwcmVzZW50cyB0aGUgdXJsIHN0YXRlCgoJCQkJLy8gSWYgd2UgYXJlIGF0IGEgcGxhY2UgaW4gaGlzdG9yeSB0aGF0IG9uY2UgYmVsb25nZWQgdG8gYSBkaWFsb2csIHJldXNlCgkJCQkvLyB0aGlzIHN0YXRlIHdpdGhvdXQgYWRkaW5nIHRvIHVybEhpc3RvcnkgYW5kIHdpdGhvdXQgbW9kaWZ5aW5nIHRoZQoJCQkJLy8gaGFzaC4gSG93ZXZlciwgaWYgYSBkaWFsb2cgaXMgYWxyZWFkeSBkaXNwbGF5ZWQgYXQgdGhpcyBwb2ludCwgYW5kCgkJCQkvLyB3ZSdyZSBhYm91dCB0byBkaXNwbGF5IGFub3RoZXIgZGlhbG9nLCB0aGVuIHdlIG11c3QgYWRkIGFub3RoZXIgaGFzaAoJCQkJLy8gYW5kIGhpc3RvcnkgZW50cnkgb24gdG9wIHNvIHRoYXQgb25lIG1heSBuYXZpZ2F0ZSBiYWNrIHRvIHRoZQoJCQkJLy8gb3JpZ2luYWwgZGlhbG9nCgkJCQlpZiAoIGFjdGl2ZS51cmwgJiYKCQkJCQlhY3RpdmUudXJsLmluZGV4T2YoICQubW9iaWxlLmRpYWxvZ0hhc2hLZXkgKSA+IC0xICYmCgkJCQkJdGhpcy5hY3RpdmVQYWdlICYmCgkJCQkJIXRoaXMuYWN0aXZlUGFnZS5oYXNDbGFzcyggInVpLWRpYWxvZyIgKSAmJgoJCQkJCSQubW9iaWxlLm5hdmlnYXRlLmhpc3RvcnkuYWN0aXZlSW5kZXggPiAwICkgewoKCQkJCQlzZXR0aW5ncy5jaGFuZ2VIYXNoID0gZmFsc2U7CgkJCQkJYWxyZWFkeVRoZXJlID0gdHJ1ZTsKCQkJCX0KCgkJCQkvLyBOb3JtYWxseSwgd2UgdGFjayBvbiBhIGRpYWxvZyBoYXNoIGtleSwgYnV0IGlmIHRoaXMgaXMgdGhlIGxvY2F0aW9uCgkJCQkvLyBvZiBhIHN0YWxlIGRpYWxvZywgd2UgcmV1c2UgdGhlIFVSTCBmcm9tIHRoZSBlbnRyeQoJCQkJdXJsID0gKCBhY3RpdmUudXJsIHx8ICIiICk7CgoJCQkJLy8gYWNjb3VudCBmb3IgYWJzb2x1dGUgdXJscyBpbnN0ZWFkIG9mIGp1c3QgcmVsYXRpdmUgdXJscyB1c2UgYXMgaGFzaGVzCgkJCQlpZiAoICFhbHJlYWR5VGhlcmUgJiYgdXJsLmluZGV4T2YoIiMiKSA+IC0xICkgewoJCQkJCXVybCArPSAkLm1vYmlsZS5kaWFsb2dIYXNoS2V5OwoJCQkJfSBlbHNlIHsKCQkJCQl1cmwgKz0gIiMiICsgJC5tb2JpbGUuZGlhbG9nSGFzaEtleTsKCQkJCX0KCgkJCQkvLyB0YWNrIG9uIGFub3RoZXIgZGlhbG9nSGFzaEtleSBpZiB0aGlzIGlzIHRoZSBzYW1lIGFzIHRoZSBpbml0aWFsIGhhc2gKCQkJCS8vIHRoaXMgbWFrZXMgc3VyZSB0aGF0IGEgaGlzdG9yeSBlbnRyeSBpcyBjcmVhdGVkIGZvciB0aGlzIGRpYWxvZwoJCQkJaWYgKCAkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5LmFjdGl2ZUluZGV4ID09PSAwICYmIHVybCA9PT0gJC5tb2JpbGUubmF2aWdhdGUuaGlzdG9yeS5pbml0aWFsRHN0ICkgewoJCQkJCXVybCArPSAkLm1vYmlsZS5kaWFsb2dIYXNoS2V5OwoJCQkJfQoJCQl9CgoJCQkvLyBpZiB0aXRsZSBlbGVtZW50IHdhc24ndCBmb3VuZCwgdHJ5IHRoZSBwYWdlIGRpdiBkYXRhIGF0dHIgdG9vCgkJCS8vIElmIHRoaXMgaXMgYSBkZWVwLWxpbmsgb3IgYSByZWxvYWQgKCBhY3RpdmUgPT09IHVuZGVmaW5lZCApIHRoZW4ganVzdAoJCQkvLyB1c2UgcGFnZVRpdGxlCgkJCW5ld1BhZ2VUaXRsZSA9ICggIWFjdGl2ZSApID8gcGFnZVRpdGxlIDogdG9QYWdlLmpxbURhdGEoICJ0aXRsZSIgKSB8fAoJCQkJdG9QYWdlLmNoaWxkcmVuKCAiOmpxbURhdGEocm9sZT0naGVhZGVyJykiICkuZmluZCggIi51aS10aXRsZSIgKS50ZXh0KCk7CgkJCWlmICggISFuZXdQYWdlVGl0bGUgJiYgcGFnZVRpdGxlID09PSBkb2N1bWVudC50aXRsZSApIHsKCQkJCXBhZ2VUaXRsZSA9IG5ld1BhZ2VUaXRsZTsKCQkJfQoJCQlpZiAoICF0b1BhZ2UuanFtRGF0YSggInRpdGxlIiApICkgewoJCQkJdG9QYWdlLmpxbURhdGEoICJ0aXRsZSIsIHBhZ2VUaXRsZSApOwoJCQl9CgoJCQkvLyBNYWtlIHN1cmUgd2UgaGF2ZSBhIHRyYW5zaXRpb24gZGVmaW5lZC4KCQkJc2V0dGluZ3MudHJhbnNpdGlvbiA9IHNldHRpbmdzLnRyYW5zaXRpb24gfHwKCQkJCSggKCBoaXN0b3J5RGlyICYmICFhY3RpdmVJc0luaXRpYWxQYWdlICkgPyBhY3RpdmUudHJhbnNpdGlvbiA6IHVuZGVmaW5lZCApIHx8CgkJCQkoIGlzRGlhbG9nID8gJC5tb2JpbGUuZGVmYXVsdERpYWxvZ1RyYW5zaXRpb24gOiAkLm1vYmlsZS5kZWZhdWx0UGFnZVRyYW5zaXRpb24gKTsKCgkJCS8vYWRkIHBhZ2UgdG8gaGlzdG9yeSBzdGFjayBpZiBpdCdzIG5vdCBiYWNrIG9yIGZvcndhcmQKCQkJaWYgKCAhaGlzdG9yeURpciAmJiBhbHJlYWR5VGhlcmUgKSB7CgkJCQkkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5LmdldEFjdGl2ZSgpLnBhZ2VVcmwgPSBwYWdlVXJsOwoJCQl9CgoJCQkvLyBTZXQgdGhlIGxvY2F0aW9uIGhhc2guCgkJCWlmICggdXJsICYmICFzZXR0aW5ncy5mcm9tSGFzaENoYW5nZSApIHsKCgkJCQkvLyByZWJ1aWxkaW5nIHRoZSBoYXNoIGhlcmUgc2luY2Ugd2UgbG9vc2UgaXQgZWFybGllciBvbgoJCQkJLy8gVE9ETyBwcmVzZXJ2ZSB0aGUgb3JpZ2luYWxseSBwYXNzZWQgaW4gcGF0aAoJCQkJaWYgKCAhJC5tb2JpbGUucGF0aC5pc1BhdGgoIHVybCApICYmIHVybC5pbmRleE9mKCAiIyIgKSA8IDAgKSB7CgkJCQkJdXJsID0gIiMiICsgdXJsOwoJCQkJfQoKCQkJCS8vIFRPRE8gdGhlIHByb3BlcnR5IG5hbWVzIGhlcmUgYXJlIGp1c3Qgc2lsbHkKCQkJCXBhcmFtcyA9IHsKCQkJCQl0cmFuc2l0aW9uOiBzZXR0aW5ncy50cmFuc2l0aW9uLAoJCQkJCXRpdGxlOiBwYWdlVGl0bGUsCgkJCQkJcGFnZVVybDogcGFnZVVybCwKCQkJCQlyb2xlOiBzZXR0aW5ncy5yb2xlCgkJCQl9OwoKCQkJCWlmICggc2V0dGluZ3MuY2hhbmdlSGFzaCAhPT0gZmFsc2UgJiYgJC5tb2JpbGUuaGFzaExpc3RlbmluZ0VuYWJsZWQgKSB7CgkJCQkJJC5tb2JpbGUubmF2aWdhdGUoIHVybCwgcGFyYW1zLCB0cnVlKTsKCQkJCX0gZWxzZSBpZiAoIHRvUGFnZVsgMCBdICE9PSAkLm1vYmlsZS5maXJzdFBhZ2VbIDAgXSApIHsKCQkJCQkkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5LmFkZCggdXJsLCBwYXJhbXMgKTsKCQkJCX0KCQkJfQoKCQkJLy9zZXQgcGFnZSB0aXRsZQoJCQlkb2N1bWVudC50aXRsZSA9IHBhZ2VUaXRsZTsKCgkJCS8vc2V0ICJ0b1BhZ2UiIGFzIGFjdGl2ZVBhZ2UgZGVwcmVjYXRlZCBpbiAxLjQgcmVtb3ZlIGluIDEuNQoJCQkkLm1vYmlsZS5hY3RpdmVQYWdlID0gdG9QYWdlOwoKCQkJLy9uZXcgd2F5IHRvIGhhbmRsZSBhY3RpdmVQYWdlCgkJCXRoaXMuYWN0aXZlUGFnZSA9IHRvUGFnZTsKCgkJCS8vIElmIHdlJ3JlIG5hdmlnYXRpbmcgYmFjayBpbiB0aGUgVVJMIGhpc3RvcnksIHNldCByZXZlcnNlIGFjY29yZGluZ2x5LgoJCQlzZXR0aW5ncy5yZXZlcnNlID0gc2V0dGluZ3MucmV2ZXJzZSB8fCBoaXN0b3J5RGlyIDwgMDsKCgkJCWNzc1RyYW5zaXRpb25EZWZlcnJlZCA9ICQuRGVmZXJyZWQoKTsKCgkJCXRoaXMuX2Nzc1RyYW5zaXRpb24odG9QYWdlLCBmcm9tUGFnZSwgewoJCQkJdHJhbnNpdGlvbjogc2V0dGluZ3MudHJhbnNpdGlvbiwKCQkJCXJldmVyc2U6IHNldHRpbmdzLnJldmVyc2UsCgkJCQlkZWZlcnJlZDogY3NzVHJhbnNpdGlvbkRlZmVycmVkCgkJCX0pOwoKCQkJY3NzVHJhbnNpdGlvbkRlZmVycmVkLmRvbmUoJC5wcm94eShmdW5jdGlvbiggbmFtZSwgcmV2ZXJzZSwgJHRvLCAkZnJvbSwgYWxyZWFkeUZvY3VzZWQgKSB7CgkJCQkkLm1vYmlsZS5yZW1vdmVBY3RpdmVMaW5rQ2xhc3MoKTsKCgkJCQkvL2lmIHRoZXJlJ3MgYSBkdXBsaWNhdGVDYWNoZWRQYWdlLCByZW1vdmUgaXQgZnJvbSB0aGUgRE9NIG5vdyB0aGF0IGl0J3MgaGlkZGVuCgkJCQlpZiAoIHNldHRpbmdzLmR1cGxpY2F0ZUNhY2hlZFBhZ2UgKSB7CgkJCQkJc2V0dGluZ3MuZHVwbGljYXRlQ2FjaGVkUGFnZS5yZW1vdmUoKTsKCQkJCX0KCgkJCQkvLyBkZXNwaXRlIHZpc2liaWxpdHk6IGhpZGRlbiBhZGRyZXNzZXMgaXNzdWUgIzI5NjUKCQkJCS8vIGh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5LW1vYmlsZS9pc3N1ZXMvMjk2NQoJCQkJaWYgKCAhYWxyZWFkeUZvY3VzZWQgKSB7CgkJCQkJJC5tb2JpbGUuZm9jdXNQYWdlKCB0b1BhZ2UgKTsKCQkJCX0KCgkJCQl0aGlzLl9yZWxlYXNlVHJhbnNpdGlvbkxvY2soKTsKCQkJCXRoaXMuZWxlbWVudC50cmlnZ2VyKCAicGFnZWNoYW5nZSIsIHRyaWdnZXJEYXRhICk7CgkJCQl0aGlzLl90cmlnZ2VyV2l0aERlcHJlY2F0ZWQoICJ0cmFuc2l0aW9uIiwgdHJpZ2dlckRhdGEgKTsKCQkJfSwgdGhpcykpOwoJCX0sCgoJCS8vIGRldGVybWluZSB0aGUgY3VycmVudCBiYXNlIHVybAoJCV9maW5kQmFzZVdpdGhEZWZhdWx0OiBmdW5jdGlvbigpIHsKCQkJdmFyIGNsb3Nlc3RCYXNlID0gKCB0aGlzLmFjdGl2ZVBhZ2UgJiYKCQkJJC5tb2JpbGUuZ2V0Q2xvc2VzdEJhc2VVcmwoIHRoaXMuYWN0aXZlUGFnZSApICk7CgkJcmV0dXJuIGNsb3Nlc3RCYXNlIHx8ICQubW9iaWxlLnBhdGguZG9jdW1lbnRCYXNlLmhyZWZOb0hhc2g7CgkJfQoJfSk7CgoJLy8gVGhlIGZvbGxvd2luZyBoYW5kbGVycyBzaG91bGQgYmUgYm91bmQgYWZ0ZXIgbW9iaWxlaW5pdCBoYXMgYmVlbiB0cmlnZ2VyZWQKCS8vIHRoZSBmb2xsb3dpbmcgZGVmZXJyZWQgaXMgcmVzb2x2ZWQgaW4gdGhlIGluaXQgZmlsZQoJJC5tb2JpbGUubmF2cmVhZHlEZWZlcnJlZCA9ICQuRGVmZXJyZWQoKTsKCgkvL3RoZXNlIHZhcmlhYmxlcyBtYWtlIGFsbCBwYWdlIGNvbnRhaW5lcnMgdXNlIHRoZSBzYW1lIHF1ZXVlIGFuZCBvbmx5IG5hdmlnYXRlIG9uZSBhdCBhIHRpbWUKCS8vIHF1ZXVlIHRvIGhvbGQgc2ltdWx0YW5pb3VzIHBhZ2UgdHJhbnNpdGlvbnMKCXZhciBwYWdlVHJhbnNpdGlvblF1ZXVlID0gW10sCgoJCS8vIGluZGljYXRlcyB3aGV0aGVyIG9yIG5vdCBwYWdlIGlzIGluIHByb2Nlc3Mgb2YgdHJhbnNpdGlvbmluZwoJCWlzUGFnZVRyYW5zaXRpb25pbmcgPSBmYWxzZTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKCQkvLyByZXNvbHZlZCBvbiBkb21yZWFkeQoJdmFyIGRvbXJlYWR5RGVmZXJyZWQgPSAkLkRlZmVycmVkKCksCgkJZG9jdW1lbnRVcmwgPSAkLm1vYmlsZS5wYXRoLmRvY3VtZW50VXJsLAoKCQkvLyB1c2VkIHRvIHRyYWNrIGxhc3QgdmNsaWNrZWQgZWxlbWVudCB0byBtYWtlIHN1cmUgaXRzIHZhbHVlIGlzIGFkZGVkIHRvIGZvcm0gZGF0YQoJCSRsYXN0VkNsaWNrZWQgPSBudWxsOwoKCS8qIEV2ZW50IEJpbmRpbmdzIC0gaGFzaGNoYW5nZSwgc3VibWl0LCBhbmQgY2xpY2sgKi8KCWZ1bmN0aW9uIGZpbmRDbG9zZXN0TGluayggZWxlICkJewoJCXdoaWxlICggZWxlICkgewoJCQkvLyBMb29rIGZvciB0aGUgY2xvc2VzdCBlbGVtZW50IHdpdGggYSBub2RlTmFtZSBvZiAiYSIuCgkJCS8vIE5vdGUgdGhhdCB3ZSBhcmUgY2hlY2tpbmcgaWYgd2UgaGF2ZSBhIHZhbGlkIG5vZGVOYW1lCgkJCS8vIGJlZm9yZSBhdHRlbXB0aW5nIHRvIGFjY2VzcyBpdC4gVGhpcyBpcyBiZWNhdXNlIHRoZQoJCQkvLyBub2RlIHdlIGdldCBjYWxsZWQgd2l0aCBjb3VsZCBoYXZlIG9yaWdpbmF0ZWQgZnJvbSB3aXRoaW4KCQkJLy8gYW4gZW1iZWRkZWQgU1ZHIGRvY3VtZW50IHdoZXJlIHNvbWUgc3ltYm9sIGluc3RhbmNlIGVsZW1lbnRzCgkJCS8vIGRvbid0IGhhdmUgbm9kZU5hbWUgZGVmaW5lZCBvbiB0aGVtLCBvciBzdHJpbmdzIGFyZSBvZiB0eXBlCgkJCS8vIFNWR0FuaW1hdGVkU3RyaW5nLgoJCQlpZiAoICggdHlwZW9mIGVsZS5ub2RlTmFtZSA9PT0gInN0cmluZyIgKSAmJiBlbGUubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gImEiICkgewoJCQkJYnJlYWs7CgkJCX0KCQkJZWxlID0gZWxlLnBhcmVudE5vZGU7CgkJfQoJCXJldHVybiBlbGU7Cgl9CgoJJC5tb2JpbGUubG9hZFBhZ2UgPSBmdW5jdGlvbiggdXJsLCBvcHRzICkgewoJCXZhciBjb250YWluZXI7CgoJCW9wdHMgPSBvcHRzIHx8IHt9OwoJCWNvbnRhaW5lciA9ICggb3B0cy5wYWdlQ29udGFpbmVyIHx8ICQubW9iaWxlLnBhZ2VDb250YWluZXIgKTsKCgkJLy8gY3JlYXRlIHRoZSBkZWZlcnJlZCB0aGF0IHdpbGwgYmUgc3VwcGxpZWQgdG8gbG9hZFBhZ2UgY2FsbGVycwoJCS8vIGFuZCByZXNvbHZlZCBieSB0aGUgY29udGVudCB3aWRnZXQncyBsb2FkIG1ldGhvZAoJCW9wdHMuZGVmZXJyZWQgPSAkLkRlZmVycmVkKCk7CgoJCS8vIFByZWZlcnJpbmcgdG8gYWxsb3cgZXhjZXB0aW9ucyBmb3IgdW5pbml0aWFsaXplZCBvcHRzLnBhZ2VDb250YWluZXIKCQkvLyB3aWRnZXRzIHNvIHdlIGtub3cgaWYgd2UgbmVlZCB0byBmb3JjZSBpbml0IGhlcmUgZm9yIHVzZXJzCgkJY29udGFpbmVyLnBhZ2Vjb250YWluZXIoICJsb2FkIiwgdXJsLCBvcHRzICk7CgoJCS8vIHByb3ZpZGUgdGhlIGRlZmVycmVkCgkJcmV0dXJuIG9wdHMuZGVmZXJyZWQucHJvbWlzZSgpOwoJfTsKCgkvL2RlZmluZSB2YXJzIGZvciBpbnRlcmFsIHVzZQoKCS8qIGludGVybmFsIHV0aWxpdHkgZnVuY3Rpb25zICovCgoJLy8gTk9URSBJc3N1ZSAjNDk1MCBBbmRyb2lkIHBob25lZ2FwIGRvZXNuJ3QgbmF2aWdhdGUgYmFjayBwcm9wZXJseQoJLy8gICAgICB3aGVuIGEgZnVsbCBwYWdlIHJlZnJlc2ggaGFzIHRha2VuIHBsYWNlLiBJdCBhcHBlYXJzIHRoYXQgaGFzaGNoYW5nZQoJLy8gICAgICBhbmQgcmVwbGFjZXN0YXRlIGhpc3RvcnkgYWx0ZXJhdGlvbnMgd29yayBmaW5lIGJ1dCB3ZSBuZWVkIHRvIHN1cHBvcnQKCS8vICAgICAgYm90aCBmb3JtcyBvZiBoaXN0b3J5IHRyYXZlcnNhbCBpbiBvdXIgY29kZSB0aGF0IHVzZXMgYmFja3dhcmQgaGlzdG9yeQoJLy8gICAgICBtb3ZlbWVudAoJJC5tb2JpbGUuYmFjayA9IGZ1bmN0aW9uKCkgewoJCXZhciBuYXYgPSB3aW5kb3cubmF2aWdhdG9yOwoKCQkvLyBpZiB0aGUgc2V0dGluZyBpcyBvbiBhbmQgdGhlIG5hdmlnYXRvciBvYmplY3QgaXMKCQkvLyBhdmFpbGFibGUgdXNlIHRoZSBwaG9uZWdhcCBuYXZpZ2F0aW9uIGNhcGFiaWxpdHkKCQlpZiAoIHRoaXMucGhvbmVnYXBOYXZpZ2F0aW9uRW5hYmxlZCAmJgoJCQluYXYgJiYKCQkJbmF2LmFwcCAmJgoJCQluYXYuYXBwLmJhY2tIaXN0b3J5ICl7CgkJCW5hdi5hcHAuYmFja0hpc3RvcnkoKTsKCQl9IGVsc2UgewoJCQl3aW5kb3cuaGlzdG9yeS5iYWNrKCk7CgkJfQoJfTsKCgkvL2RpcmVjdCBmb2N1cyB0byB0aGUgcGFnZSB0aXRsZSwgb3Igb3RoZXJ3aXNlIGZpcnN0IGZvY3VzYWJsZSBlbGVtZW50CgkkLm1vYmlsZS5mb2N1c1BhZ2UgPSBmdW5jdGlvbiAoIHBhZ2UgKSB7CgkJdmFyIGF1dG9mb2N1cyA9IHBhZ2UuZmluZCggIlthdXRvZm9jdXNdIiApLAoJCQlwYWdlVGl0bGUgPSBwYWdlLmZpbmQoICIudWktdGl0bGU6ZXEoMCkiICk7CgoJCWlmICggYXV0b2ZvY3VzLmxlbmd0aCApIHsKCQkJYXV0b2ZvY3VzLmZvY3VzKCk7CgkJCXJldHVybjsKCQl9CgoJCWlmICggcGFnZVRpdGxlLmxlbmd0aCApIHsKCQkJcGFnZVRpdGxlLmZvY3VzKCk7CgkJfSBlbHNlewoJCQlwYWdlLmZvY3VzKCk7CgkJfQoJfTsKCgkvLyBOby1vcCBpbXBsZW1lbnRhdGlvbiBvZiB0cmFuc2l0aW9uIGRlZ3JhZGF0aW9uCgkkLm1vYmlsZS5fbWF5YmVEZWdyYWRlVHJhbnNpdGlvbiA9ICQubW9iaWxlLl9tYXliZURlZ3JhZGVUcmFuc2l0aW9uIHx8IGZ1bmN0aW9uKCB0cmFuc2l0aW9uICkgewoJCXJldHVybiB0cmFuc2l0aW9uOwoJfTsKCgkvKiBleHBvc2VkICQubW9iaWxlIG1ldGhvZHMgKi8KCgkvL2FuaW1hdGlvbiBjb21wbGV0ZSBjYWxsYmFjawoJJC5mbi5hbmltYXRpb25Db21wbGV0ZSA9IGZ1bmN0aW9uKCBjYWxsYmFjayApIHsKCQlpZiAoICQuc3VwcG9ydC5jc3NUcmFuc2l0aW9ucyApIHsKCQkJcmV0dXJuICQoIHRoaXMgKS5vbmUoICJ3ZWJraXRBbmltYXRpb25FbmQgYW5pbWF0aW9uZW5kIiwgY2FsbGJhY2sgKTsKCQl9CgkJZWxzZXsKCQkJLy8gZGVmZXIgZXhlY3V0aW9uIGZvciBjb25zaXN0ZW5jeSBiZXR3ZWVuIHdlYmtpdC9ub24gd2Via2l0CgkJCXNldFRpbWVvdXQoIGNhbGxiYWNrLCAwICk7CgkJCXJldHVybiAkKCB0aGlzICk7CgkJfQoJfTsKCgkkLm1vYmlsZS5jaGFuZ2VQYWdlID0gZnVuY3Rpb24oIHRvLCBvcHRpb25zICkgewoJCSQubW9iaWxlLnBhZ2VDb250YWluZXIucGFnZWNvbnRhaW5lciggImNoYW5nZSIsIHRvLCBvcHRpb25zICk7Cgl9OwoKCSQubW9iaWxlLmNoYW5nZVBhZ2UuZGVmYXVsdHMgPSB7CgkJdHJhbnNpdGlvbjogdW5kZWZpbmVkLAoJCXJldmVyc2U6IGZhbHNlLAoJCWNoYW5nZUhhc2g6IHRydWUsCgkJZnJvbUhhc2hDaGFuZ2U6IGZhbHNlLAoJCXJvbGU6IHVuZGVmaW5lZCwgLy8gQnkgZGVmYXVsdCB3ZSByZWx5IG9uIHRoZSByb2xlIGRlZmluZWQgYnkgdGhlIEBkYXRhLXJvbGUgYXR0cmlidXRlLgoJCWR1cGxpY2F0ZUNhY2hlZFBhZ2U6IHVuZGVmaW5lZCwKCQlwYWdlQ29udGFpbmVyOiB1bmRlZmluZWQsCgkJc2hvd0xvYWRNc2c6IHRydWUsIC8vbG9hZGluZyBtZXNzYWdlIHNob3dzIGJ5IGRlZmF1bHQgd2hlbiBwYWdlcyBhcmUgYmVpbmcgZmV0Y2hlZCBkdXJpbmcgY2hhbmdlUGFnZQoJCWRhdGFVcmw6IHVuZGVmaW5lZCwKCQlmcm9tUGFnZTogdW5kZWZpbmVkLAoJCWFsbG93U2FtZVBhZ2VUcmFuc2l0aW9uOiBmYWxzZQoJfTsKCgkkLm1vYmlsZS5fcmVnaXN0ZXJJbnRlcm5hbEV2ZW50cyA9IGZ1bmN0aW9uKCkgewoJCXZhciBnZXRBamF4Rm9ybURhdGEgPSBmdW5jdGlvbiggJGZvcm0sIGNhbGN1bGF0ZU9ubHkgKSB7CgkJCXZhciB1cmwsIHJldCA9IHRydWUsIGZvcm1EYXRhLCB2Y2xpY2tlZE5hbWUsIG1ldGhvZDsKCQkJaWYgKCAhJC5tb2JpbGUuYWpheEVuYWJsZWQgfHwKCQkJCQkvLyB0ZXN0IHRoYXQgdGhlIGZvcm0gaXMsIGl0c2VsZiwgYWpheCBmYWxzZQoJCQkJCSRmb3JtLmlzKCAiOmpxbURhdGEoYWpheD0nZmFsc2UnKSIgKSB8fAoJCQkJCS8vIHRlc3QgdGhhdCAkLm1vYmlsZS5pZ25vcmVDb250ZW50RW5hYmxlZCBpcyBzZXQgYW5kCgkJCQkJLy8gdGhlIGZvcm0gb3Igb25lIG9mIGl0J3MgcGFyZW50cyBpcyBhamF4PWZhbHNlCgkJCQkJISRmb3JtLmpxbUhpamFja2FibGUoKS5sZW5ndGggfHwKCQkJCQkkZm9ybS5hdHRyKCAidGFyZ2V0IiApICkgewoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgoJCQl1cmwgPSAoICRsYXN0VkNsaWNrZWQgJiYgJGxhc3RWQ2xpY2tlZC5hdHRyKCAiZm9ybWFjdGlvbiIgKSApIHx8CgkJCQkkZm9ybS5hdHRyKCAiYWN0aW9uIiApOwoJCQltZXRob2QgPSAoICRmb3JtLmF0dHIoICJtZXRob2QiICkgfHwgImdldCIgKS50b0xvd2VyQ2FzZSgpOwoKCQkJLy8gSWYgbm8gYWN0aW9uIGlzIHNwZWNpZmllZCwgYnJvd3NlcnMgZGVmYXVsdCB0byB1c2luZyB0aGUKCQkJLy8gVVJMIG9mIHRoZSBkb2N1bWVudCBjb250YWluaW5nIHRoZSBmb3JtLiBTaW5jZSB3ZSBkeW5hbWljYWxseQoJCQkvLyBwdWxsIGluIHBhZ2VzIGZyb20gZXh0ZXJuYWwgZG9jdW1lbnRzLCB0aGUgZm9ybSBzaG91bGQgc3VibWl0CgkJCS8vIHRvIHRoZSBVUkwgZm9yIHRoZSBzb3VyY2UgZG9jdW1lbnQgb2YgdGhlIHBhZ2UgY29udGFpbmluZwoJCQkvLyB0aGUgZm9ybS4KCQkJaWYgKCAhdXJsICkgewoJCQkJLy8gR2V0IHRoZSBAZGF0YS11cmwgZm9yIHRoZSBwYWdlIGNvbnRhaW5pbmcgdGhlIGZvcm0uCgkJCQl1cmwgPSAkLm1vYmlsZS5nZXRDbG9zZXN0QmFzZVVybCggJGZvcm0gKTsKCgkJCQkvLyBOT1RFOiBJZiB0aGUgbWV0aG9kIGlzICJnZXQiLCB3ZSBuZWVkIHRvIHN0cmlwIG9mZiB0aGUgcXVlcnkgc3RyaW5nCgkJCQkvLyBiZWNhdXNlIGl0IHdpbGwgZ2V0IHJlcGxhY2VkIHdpdGggdGhlIG5ldyBmb3JtIGRhdGEuIFNlZSBpc3N1ZSAjNTcxMC4KCQkJCWlmICggbWV0aG9kID09PSAiZ2V0IiApIHsKCQkJCQl1cmwgPSAkLm1vYmlsZS5wYXRoLnBhcnNlVXJsKCB1cmwgKS5ocmVmTm9TZWFyY2g7CgkJCQl9CgoJCQkJaWYgKCB1cmwgPT09ICQubW9iaWxlLnBhdGguZG9jdW1lbnRCYXNlLmhyZWZOb0hhc2ggKSB7CgkJCQkJLy8gVGhlIHVybCB3ZSBnb3QgYmFjayBtYXRjaGVzIHRoZSBkb2N1bWVudCBiYXNlLAoJCQkJCS8vIHdoaWNoIG1lYW5zIHRoZSBwYWdlIG11c3QgYmUgYW4gaW50ZXJuYWwvZW1iZWRkZWQgcGFnZSwKCQkJCQkvLyBzbyBkZWZhdWx0IHRvIHVzaW5nIHRoZSBhY3R1YWwgZG9jdW1lbnQgdXJsIGFzIGEgYnJvd3NlcgoJCQkJCS8vIHdvdWxkLgoJCQkJCXVybCA9IGRvY3VtZW50VXJsLmhyZWZOb1NlYXJjaDsKCQkJCX0KCQkJfQoKCQkJdXJsID0gJC5tb2JpbGUucGF0aC5tYWtlVXJsQWJzb2x1dGUoICB1cmwsICQubW9iaWxlLmdldENsb3Nlc3RCYXNlVXJsKCAkZm9ybSApICk7CgoJCQlpZiAoICggJC5tb2JpbGUucGF0aC5pc0V4dGVybmFsKCB1cmwgKSAmJiAhJC5tb2JpbGUucGF0aC5pc1Blcm1pdHRlZENyb3NzRG9tYWluUmVxdWVzdCggZG9jdW1lbnRVcmwsIHVybCApICkgKSB7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCgkJCWlmICggIWNhbGN1bGF0ZU9ubHkgKSB7CgkJCQlmb3JtRGF0YSA9ICRmb3JtLnNlcmlhbGl6ZUFycmF5KCk7CgoJCQkJaWYgKCAkbGFzdFZDbGlja2VkICYmICRsYXN0VkNsaWNrZWRbIDAgXS5mb3JtID09PSAkZm9ybVsgMCBdICkgewoJCQkJCXZjbGlja2VkTmFtZSA9ICRsYXN0VkNsaWNrZWQuYXR0ciggIm5hbWUiICk7CgkJCQkJaWYgKCB2Y2xpY2tlZE5hbWUgKSB7CgkJCQkJCS8vIE1ha2Ugc3VyZSB0aGUgbGFzdCBjbGlja2VkIGVsZW1lbnQgaXMgaW5jbHVkZWQgaW4gdGhlIGZvcm0KCQkJCQkJJC5lYWNoKCBmb3JtRGF0YSwgZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CgkJCQkJCQlpZiAoIHZhbHVlLm5hbWUgPT09IHZjbGlja2VkTmFtZSApIHsKCQkJCQkJCQkvLyBVbnNldCB2Y2xpY2tlZE5hbWUgLSB3ZSd2ZSBmb3VuZCBpdCBpbiB0aGUgc2VyaWFsaXplZCBkYXRhIGFscmVhZHkKCQkJCQkJCQl2Y2xpY2tlZE5hbWUgPSAiIjsKCQkJCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQkJCQl9CgkJCQkJCX0pOwoJCQkJCQlpZiAoIHZjbGlja2VkTmFtZSApIHsKCQkJCQkJCWZvcm1EYXRhLnB1c2goIHsgbmFtZTogdmNsaWNrZWROYW1lLCB2YWx1ZTogJGxhc3RWQ2xpY2tlZC5hdHRyKCAidmFsdWUiICkgfSApOwoJCQkJCQl9CgkJCQkJfQoJCQkJfQoKCQkJCXJldCA9IHsKCQkJCQl1cmw6IHVybCwKCQkJCQlvcHRpb25zOiB7CgkJCQkJCXR5cGU6CQltZXRob2QsCgkJCQkJCWRhdGE6CQkkLnBhcmFtKCBmb3JtRGF0YSApLAoJCQkJCQl0cmFuc2l0aW9uOgkkZm9ybS5qcW1EYXRhKCAidHJhbnNpdGlvbiIgKSwKCQkJCQkJcmV2ZXJzZToJJGZvcm0uanFtRGF0YSggImRpcmVjdGlvbiIgKSA9PT0gInJldmVyc2UiLAoJCQkJCQlyZWxvYWRQYWdlOgl0cnVlCgkJCQkJfQoJCQkJfTsKCQkJfQoKCQkJcmV0dXJuIHJldDsKCQl9OwoKCQkvL2JpbmQgdG8gZm9ybSBzdWJtaXQgZXZlbnRzLCBoYW5kbGUgd2l0aCBBamF4CgkJJC5tb2JpbGUuZG9jdW1lbnQuZGVsZWdhdGUoICJmb3JtIiwgInN1Ym1pdCIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdmFyIGZvcm1EYXRhOwoKCQkJaWYgKCAhZXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKSB7CgkJCQlmb3JtRGF0YSA9IGdldEFqYXhGb3JtRGF0YSggJCggdGhpcyApICk7CgkJCQlpZiAoIGZvcm1EYXRhICkgewoJCQkJCSQubW9iaWxlLmNoYW5nZVBhZ2UoIGZvcm1EYXRhLnVybCwgZm9ybURhdGEub3B0aW9ucyApOwoJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQl9CgkJCX0KCQl9KTsKCgkJLy9hZGQgYWN0aXZlIHN0YXRlIG9uIHZjbGljawoJCSQubW9iaWxlLmRvY3VtZW50LmJpbmQoICJ2Y2xpY2siLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciAkYnRuLCBidG5FbHMsIHRhcmdldCA9IGV2ZW50LnRhcmdldCwgbmVlZENsb3Nlc3QgPSBmYWxzZTsKCQkJLy8gaWYgdGhpcyBpc24ndCBhIGxlZnQgY2xpY2sgd2UgZG9uJ3QgY2FyZS4gSXRzIGltcG9ydGFudCB0byBub3RlCgkJCS8vIHRoYXQgd2hlbiB0aGUgdmlydHVhbCBldmVudCBpcyBnZW5lcmF0ZWQgaXQgd2lsbCBjcmVhdGUgdGhlIHdoaWNoIGF0dHIKCQkJaWYgKCBldmVudC53aGljaCA+IDEgfHwgISQubW9iaWxlLmxpbmtCaW5kaW5nRW5hYmxlZCApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gUmVjb3JkIHRoYXQgdGhpcyBlbGVtZW50IHdhcyBjbGlja2VkLCBpbiBjYXNlIHdlIG5lZWQgaXQgZm9yIGNvcnJlY3QKCQkJLy8gZm9ybSBzdWJtaXNzaW9uIGR1cmluZyB0aGUgInN1Ym1pdCIgaGFuZGxlciBhYm92ZQoJCQkkbGFzdFZDbGlja2VkID0gJCggdGFyZ2V0ICk7CgoJCQkvLyBUcnkgdG8gZmluZCBhIHRhcmdldCBlbGVtZW50IHRvIHdoaWNoIHRoZSBhY3RpdmUgY2xhc3Mgd2lsbCBiZSBhcHBsaWVkCgkJCWlmICggJC5kYXRhKCB0YXJnZXQsICJtb2JpbGUtYnV0dG9uIiApICkgewoJCQkJLy8gSWYgdGhlIGZvcm0gd2lsbCBub3QgYmUgc3VibWl0dGVkIHZpYSBBSkFYLCBkbyBub3QgYWRkIGFjdGl2ZSBjbGFzcwoJCQkJaWYgKCAhZ2V0QWpheEZvcm1EYXRhKCAkKCB0YXJnZXQgKS5jbG9zZXN0KCAiZm9ybSIgKSwgdHJ1ZSApICkgewoJCQkJCXJldHVybjsKCQkJCX0KCQkJCS8vIFdlIHdpbGwgYXBwbHkgdGhlIGFjdGl2ZSBzdGF0ZSB0byB0aGlzIGJ1dHRvbiB3aWRnZXQgLSB0aGUgcGFyZW50CgkJCQkvLyBvZiB0aGUgaW5wdXQgdGhhdCB3YXMgY2xpY2tlZCB3aWxsIGhhdmUgdGhlIGFzc29jaWF0ZWQgZGF0YQoJCQkJaWYgKCB0YXJnZXQucGFyZW50Tm9kZSApIHsKCQkJCQl0YXJnZXQgPSB0YXJnZXQucGFyZW50Tm9kZTsKCQkJCX0KCQkJfSBlbHNlIHsKCQkJCXRhcmdldCA9IGZpbmRDbG9zZXN0TGluayggdGFyZ2V0ICk7CgkJCQlpZiAoICEoIHRhcmdldCAmJiAkLm1vYmlsZS5wYXRoLnBhcnNlVXJsKCB0YXJnZXQuZ2V0QXR0cmlidXRlKCAiaHJlZiIgKSB8fCAiIyIgKS5oYXNoICE9PSAiIyIgKSApIHsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJLy8gVE9ETyB0ZWFjaCAkLm1vYmlsZS5oaWphY2thYmxlIHRvIG9wZXJhdGUgb24gcmF3IGRvbSBlbGVtZW50cyBzbyB0aGUKCQkJCS8vIGxpbmsgd3JhcHBpbmcgY2FuIGJlIGF2b2lkZWQKCQkJCWlmICggISQoIHRhcmdldCApLmpxbUhpamFja2FibGUoKS5sZW5ndGggKSB7CgkJCQkJcmV0dXJuOwoJCQkJfQoJCQl9CgoJCQkvLyBBdm9pZCBjYWxsaW5nIC5jbG9zZXN0IGJ5IHVzaW5nIHRoZSBkYXRhIHNldCBkdXJpbmcgLmJ1dHRvbk1hcmt1cCgpCgkJCS8vIExpc3QgaXRlbXMgaGF2ZSB0aGUgYnV0dG9uIGRhdGEgaW4gdGhlIHBhcmVudCBvZiB0aGUgZWxlbWVudCBjbGlja2VkCgkJCWlmICggISF+dGFyZ2V0LmNsYXNzTmFtZS5pbmRleE9mKCAidWktbGluay1pbmhlcml0IiApICkgewoJCQkJaWYgKCB0YXJnZXQucGFyZW50Tm9kZSApIHsKCQkJCQlidG5FbHMgPSAkLmRhdGEoIHRhcmdldC5wYXJlbnROb2RlLCAiYnV0dG9uRWxlbWVudHMiICk7CgkJCQl9CgkJCS8vIE90aGVyd2lzZSwgbG9vayBmb3IgdGhlIGRhdGEgb24gdGhlIHRhcmdldCBpdHNlbGYKCQkJfSBlbHNlIHsKCQkJCWJ0bkVscyA9ICQuZGF0YSggdGFyZ2V0LCAiYnV0dG9uRWxlbWVudHMiICk7CgkJCX0KCQkJLy8gSWYgZm91bmQsIGdyYWIgdGhlIGJ1dHRvbidzIG91dGVyIGVsZW1lbnQKCQkJaWYgKCBidG5FbHMgKSB7CgkJCQl0YXJnZXQgPSBidG5FbHMub3V0ZXI7CgkJCX0gZWxzZSB7CgkJCQluZWVkQ2xvc2VzdCA9IHRydWU7CgkJCX0KCgkJCSRidG4gPSAkKCB0YXJnZXQgKTsKCQkJLy8gSWYgdGhlIG91dGVyIGVsZW1lbnQgd2Fzbid0IGZvdW5kIGJ5IHRoZSBvdXIgaGV1cmlzdGljcywgdXNlIC5jbG9zZXN0KCkKCQkJaWYgKCBuZWVkQ2xvc2VzdCApIHsKCQkJCSRidG4gPSAkYnRuLmNsb3Nlc3QoICIudWktYnRuIiApOwoJCQl9CgoJCQlpZiAoICRidG4ubGVuZ3RoID4gMCAmJgoJCQkJISggJGJ0bi5oYXNDbGFzcyggInVpLXN0YXRlLWRpc2FibGVkIiB8fAoKCQkJCQkvLyBERVBSRUNBVEVEIGFzIG9mIDEuNC4wIC0gcmVtb3ZlIGFmdGVyIDEuNC4wIHJlbGVhc2UKCQkJCQkvLyBvbmx5IHVpLXN0YXRlLWRpc2FibGVkIHNob3VsZCBiZSBwcmVzZW50IHRoZXJlYWZ0ZXIKCQkJCQkkYnRuLmhhc0NsYXNzKCAidWktZGlzYWJsZWQiICkgKSApICkgewoJCQkJJC5tb2JpbGUucmVtb3ZlQWN0aXZlTGlua0NsYXNzKCB0cnVlICk7CgkJCQkkLm1vYmlsZS5hY3RpdmVDbGlja2VkTGluayA9ICRidG47CgkJCQkkLm1vYmlsZS5hY3RpdmVDbGlja2VkTGluay5hZGRDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJfQoJCX0pOwoKCQkvLyBjbGljayByb3V0aW5nIC0gZGlyZWN0IHRvIEhUVFAgb3IgQWpheCwgYWNjb3JkaW5nbHkKCQkkLm1vYmlsZS5kb2N1bWVudC5iaW5kKCAiY2xpY2siLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCWlmICggISQubW9iaWxlLmxpbmtCaW5kaW5nRW5hYmxlZCB8fCBldmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJdmFyIGxpbmsgPSBmaW5kQ2xvc2VzdExpbmsoIGV2ZW50LnRhcmdldCApLAoJCQkJJGxpbmsgPSAkKCBsaW5rICksCgkJCQlodHRwQ2xlYW51cCwKCQkJCWJhc2VVcmwsIGhyZWYsCgkJCQl1c2VEZWZhdWx0VXJsSGFuZGxpbmcsIGlzRXh0ZXJuYWwsCgkJCQl0cmFuc2l0aW9uLCByZXZlcnNlLCByb2xlOwoKCQkJLy8gSWYgdGhlcmUgaXMgbm8gbGluayBhc3NvY2lhdGVkIHdpdGggdGhlIGNsaWNrIG9yIGl0cyBub3QgYSBsZWZ0CgkJCS8vIGNsaWNrIHdlIHdhbnQgdG8gaWdub3JlIHRoZSBjbGljawoJCQkvLyBUT0RPIHRlYWNoICQubW9iaWxlLmhpamFja2FibGUgdG8gb3BlcmF0ZSBvbiByYXcgZG9tIGVsZW1lbnRzIHNvIHRoZSBsaW5rIHdyYXBwaW5nCgkJCS8vIGNhbiBiZSBhdm9pZGVkCgkJCWlmICggIWxpbmsgfHwgZXZlbnQud2hpY2ggPiAxIHx8ICEkbGluay5qcW1IaWphY2thYmxlKCkubGVuZ3RoICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvL3JlbW92ZSBhY3RpdmUgbGluayBjbGFzcyBpZiBleHRlcm5hbCAodGhlbiBpdCB3b24ndCBiZSB0aGVyZSBpZiB5b3UgY29tZSBiYWNrKQoJCQlodHRwQ2xlYW51cCA9IGZ1bmN0aW9uKCkgewoJCQkJd2luZG93LnNldFRpbWVvdXQoZnVuY3Rpb24oKSB7ICQubW9iaWxlLnJlbW92ZUFjdGl2ZUxpbmtDbGFzcyggdHJ1ZSApOyB9LCAyMDAgKTsKCQkJfTsKCgkJCS8vaWYgdGhlcmUncyBhIGRhdGEtcmVsPWJhY2sgYXR0ciwgZ28gYmFjayBpbiBoaXN0b3J5CgkJCWlmICggJGxpbmsuaXMoICI6anFtRGF0YShyZWw9J2JhY2snKSIgKSApIHsKCQkJCSQubW9iaWxlLmJhY2soKTsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoKCQkJYmFzZVVybCA9ICQubW9iaWxlLmdldENsb3Nlc3RCYXNlVXJsKCAkbGluayApOwoKCQkJLy9nZXQgaHJlZiwgaWYgZGVmaW5lZCwgb3RoZXJ3aXNlIGRlZmF1bHQgdG8gZW1wdHkgaGFzaAoJCQlocmVmID0gJC5tb2JpbGUucGF0aC5tYWtlVXJsQWJzb2x1dGUoICRsaW5rLmF0dHIoICJocmVmIiApIHx8ICIjIiwgYmFzZVVybCApOwoKCQkJLy9pZiBhamF4IGlzIGRpc2FibGVkLCBleGl0IGVhcmx5CgkJCWlmICggISQubW9iaWxlLmFqYXhFbmFibGVkICYmICEkLm1vYmlsZS5wYXRoLmlzRW1iZWRkZWRQYWdlKCBocmVmICkgKSB7CgkJCQlodHRwQ2xlYW51cCgpOwoJCQkJLy91c2UgZGVmYXVsdCBjbGljayBoYW5kbGluZwoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBYWFhfamJsYXM6IElkZWFsbHkgbGlua3MgdG8gYXBwbGljYXRpb24gcGFnZXMgc2hvdWxkIGJlIHNwZWNpZmllZCBhcwoJCQkvLyAgICAgICAgICAgIGFuIHVybCB0byB0aGUgYXBwbGljYXRpb24gZG9jdW1lbnQgd2l0aCBhIGhhc2ggdGhhdCBpcyBlaXRoZXIKCQkJLy8gICAgICAgICAgICB0aGUgc2l0ZSByZWxhdGl2ZSBwYXRoIG9yIGlkIHRvIHRoZSBwYWdlLiBCdXQgc29tZSBvZiB0aGUKCQkJLy8gICAgICAgICAgICBpbnRlcm5hbCBjb2RlIHRoYXQgZHluYW1pY2FsbHkgZ2VuZXJhdGVzIHN1Yi1wYWdlcyBmb3IgbmVzdGVkCgkJCS8vICAgICAgICAgICAgbGlzdHMgYW5kIHNlbGVjdCBkaWFsb2dzLCBqdXN0IHdyaXRlIGEgaGFzaCBpbiB0aGUgbGluayB0aGV5CgkJCS8vICAgICAgICAgICAgY3JlYXRlLiBUaGlzIG1lYW5zIHRoZSBhY3R1YWwgVVJMIHBhdGggaXMgYmFzZWQgb24gd2hhdGV2ZXIKCQkJLy8gICAgICAgICAgICB0aGUgY3VycmVudCB2YWx1ZSBvZiB0aGUgYmFzZSB0YWcgaXMgYXQgdGhlIHRpbWUgdGhpcyBjb2RlCgkJCS8vICAgICAgICAgICAgaXMgY2FsbGVkLiBGb3Igbm93IHdlIGFyZSBqdXN0IGFzc3VtaW5nIHRoYXQgYW55IHVybCB3aXRoIGEKCQkJLy8gICAgICAgICAgICBoYXNoIGluIGl0IGlzIGFuIGFwcGxpY2F0aW9uIHBhZ2UgcmVmZXJlbmNlLgoJCQlpZiAoIGhyZWYuc2VhcmNoKCAiIyIgKSAhPT0gLTEgKSB7CgkJCQlocmVmID0gaHJlZi5yZXBsYWNlKCAvW14jXSojLywgIiIgKTsKCQkJCWlmICggIWhyZWYgKSB7CgkJCQkJLy9saW5rIHdhcyBhbiBlbXB0eSBoYXNoIG1lYW50IHB1cmVseQoJCQkJCS8vZm9yIGludGVyYWN0aW9uLCBzbyB3ZSBpZ25vcmUgaXQuCgkJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCQlyZXR1cm47CgkJCQl9IGVsc2UgaWYgKCAkLm1vYmlsZS5wYXRoLmlzUGF0aCggaHJlZiApICkgewoJCQkJCS8vd2UgaGF2ZSBhcGF0aCBzbyBtYWtlIGl0IHRoZSBocmVmIHdlIHdhbnQgdG8gbG9hZC4KCQkJCQlocmVmID0gJC5tb2JpbGUucGF0aC5tYWtlVXJsQWJzb2x1dGUoIGhyZWYsIGJhc2VVcmwgKTsKCQkJCX0gZWxzZSB7CgkJCQkJLy93ZSBoYXZlIGEgc2ltcGxlIGlkIHNvIHVzZSB0aGUgZG9jdW1lbnRVcmwgYXMgaXRzIGJhc2UuCgkJCQkJaHJlZiA9ICQubW9iaWxlLnBhdGgubWFrZVVybEFic29sdXRlKCAiIyIgKyBocmVmLCBkb2N1bWVudFVybC5ocmVmTm9IYXNoICk7CgkJCQl9CgkJCX0KCgkJCS8vIFNob3VsZCB3ZSBoYW5kbGUgdGhpcyBsaW5rLCBvciBsZXQgdGhlIGJyb3dzZXIgZGVhbCB3aXRoIGl0PwoJCQl1c2VEZWZhdWx0VXJsSGFuZGxpbmcgPSAkbGluay5pcyggIltyZWw9J2V4dGVybmFsJ10iICkgfHwgJGxpbmsuaXMoICI6anFtRGF0YShhamF4PSdmYWxzZScpIiApIHx8ICRsaW5rLmlzKCAiW3RhcmdldF0iICk7CgoJCQkvLyBTb21lIGVtYmVkZGVkIGJyb3dzZXJzLCBsaWtlIHRoZSB3ZWIgdmlldyBpbiBQaG9uZSBHYXAsIGFsbG93IGNyb3NzLWRvbWFpbiBYSFIKCQkJLy8gcmVxdWVzdHMgaWYgdGhlIGRvY3VtZW50IGRvaW5nIHRoZSByZXF1ZXN0IHdhcyBsb2FkZWQgdmlhIHRoZSBmaWxlOi8vIHByb3RvY29sLgoJCQkvLyBUaGlzIGlzIHVzdWFsbHkgdG8gYWxsb3cgdGhlIGFwcGxpY2F0aW9uIHRvICJwaG9uZSBob21lIiBhbmQgZmV0Y2ggYXBwIHNwZWNpZmljCgkJCS8vIGRhdGEuIFdlIG5vcm1hbGx5IGxldCB0aGUgYnJvd3NlciBoYW5kbGUgZXh0ZXJuYWwvY3Jvc3MtZG9tYWluIHVybHMsIGJ1dCBpZiB0aGUKCQkJLy8gYWxsb3dDcm9zc0RvbWFpblBhZ2VzIG9wdGlvbiBpcyB0cnVlLCB3ZSB3aWxsIGFsbG93IGNyb3NzLWRvbWFpbiBodHRwL2h0dHBzCgkJCS8vIHJlcXVlc3RzIHRvIGdvIHRocm91Z2ggb3VyIHBhZ2UgbG9hZGluZyBsb2dpYy4KCgkJCS8vY2hlY2sgZm9yIHByb3RvY29sIG9yIHJlbCBhbmQgaXRzIG5vdCBhbiBlbWJlZGRlZCBwYWdlCgkJCS8vVE9ETyBvdmVybGFwIGluIGxvZ2ljIGZyb20gaXNFeHRlcm5hbCwgcmVsPWV4dGVybmFsIGNoZWNrIHNob3VsZCBiZQoJCQkvLyAgICAgbW92ZWQgaW50byBtb3JlIGNvbXByZWhlbnNpdmUgaXNFeHRlcm5hbExpbmsKCQkJaXNFeHRlcm5hbCA9IHVzZURlZmF1bHRVcmxIYW5kbGluZyB8fCAoICQubW9iaWxlLnBhdGguaXNFeHRlcm5hbCggaHJlZiApICYmICEkLm1vYmlsZS5wYXRoLmlzUGVybWl0dGVkQ3Jvc3NEb21haW5SZXF1ZXN0KCBkb2N1bWVudFVybCwgaHJlZiApICk7CgoJCQlpZiAoIGlzRXh0ZXJuYWwgKSB7CgkJCQlodHRwQ2xlYW51cCgpOwoJCQkJLy91c2UgZGVmYXVsdCBjbGljayBoYW5kbGluZwoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvL3VzZSBhamF4CgkJCXRyYW5zaXRpb24gPSAkbGluay5qcW1EYXRhKCAidHJhbnNpdGlvbiIgKTsKCQkJcmV2ZXJzZSA9ICRsaW5rLmpxbURhdGEoICJkaXJlY3Rpb24iICkgPT09ICJyZXZlcnNlIiB8fAoJCQkJCQkvLyBkZXByZWNhdGVkIC0gcmVtb3ZlIGJ5IDEuMAoJCQkJCQkkbGluay5qcW1EYXRhKCAiYmFjayIgKTsKCgkJCS8vdGhpcyBtYXkgbmVlZCB0byBiZSBtb3JlIHNwZWNpZmljIGFzIHdlIHVzZSBkYXRhLXJlbCBtb3JlCgkJCXJvbGUgPSAkbGluay5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicmVsIiApIHx8IHVuZGVmaW5lZDsKCgkJCSQubW9iaWxlLmNoYW5nZVBhZ2UoIGhyZWYsIHsgdHJhbnNpdGlvbjogdHJhbnNpdGlvbiwgcmV2ZXJzZTogcmV2ZXJzZSwgcm9sZTogcm9sZSwgbGluazogJGxpbmsgfSApOwoJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCX0pOwoKCQkvL3ByZWZldGNoIHBhZ2VzIHdoZW4gYW5jaG9ycyB3aXRoIGRhdGEtcHJlZmV0Y2ggYXJlIGVuY291bnRlcmVkCgkJJC5tb2JpbGUuZG9jdW1lbnQuZGVsZWdhdGUoICIudWktcGFnZSIsICJwYWdlc2hvdy5wcmVmZXRjaCIsIGZ1bmN0aW9uKCkgewoJCQl2YXIgdXJscyA9IFtdOwoJCQkkKCB0aGlzICkuZmluZCggImE6anFtRGF0YShwcmVmZXRjaCkiICkuZWFjaChmdW5jdGlvbigpIHsKCQkJCXZhciAkbGluayA9ICQoIHRoaXMgKSwKCQkJCQl1cmwgPSAkbGluay5hdHRyKCAiaHJlZiIgKTsKCgkJCQlpZiAoIHVybCAmJiAkLmluQXJyYXkoIHVybCwgdXJscyApID09PSAtMSApIHsKCQkJCQl1cmxzLnB1c2goIHVybCApOwoKCQkJCQkkLm1vYmlsZS5sb2FkUGFnZSggdXJsLCB7IHJvbGU6ICRsaW5rLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyZWwiICkscHJlZmV0Y2g6IHRydWUgfSApOwoJCQkJfQoJCQl9KTsKCQl9KTsKCgkJLy8gVE9ETyBlbnN1cmUgdGhhdCB0aGUgbmF2aWdhdGUgYmluZGluZyBpbiB0aGUgY29udGVudCB3aWRnZXQgaGFwcGVucyBhdCB0aGUgcmlnaHQgdGltZQoJCSQubW9iaWxlLnBhZ2VDb250YWluZXIucGFnZWNvbnRhaW5lcigpOwoKCQkvL3NldCBwYWdlIG1pbi1oZWlnaHRzIHRvIGJlIGRldmljZSBzcGVjaWZpYwoJCSQubW9iaWxlLmRvY3VtZW50LmJpbmQoICJwYWdlc2hvdyIsICQubW9iaWxlLnJlc2V0QWN0aXZlUGFnZUhlaWdodCApOwoJCSQubW9iaWxlLndpbmRvdy5iaW5kKCAidGhyb3R0bGVkcmVzaXplIiwgJC5tb2JpbGUucmVzZXRBY3RpdmVQYWdlSGVpZ2h0ICk7CgoJfTsvL25hdnJlYWR5RGVmZXJyZWQgZG9uZSBjYWxsYmFjawoKCSQoIGZ1bmN0aW9uKCkgeyBkb21yZWFkeURlZmVycmVkLnJlc29sdmUoKTsgfSApOwoKCSQud2hlbiggZG9tcmVhZHlEZWZlcnJlZCwgJC5tb2JpbGUubmF2cmVhZHlEZWZlcnJlZCApLmRvbmUoIGZ1bmN0aW9uKCkgeyAkLm1vYmlsZS5fcmVnaXN0ZXJJbnRlcm5hbEV2ZW50cygpOyB9ICk7Cn0pKCBqUXVlcnkgKTsKCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKCS8vIFRPRE8gcmVtb3ZlIGRpcmVjdCByZWZlcmVuY2VzIHRvICQubW9iaWxlIGFuZCBwcm9wZXJ0aWVzLCB3ZSBzaG91bGQKCS8vICAgICAgZmF2b3IgaW5qZWN0aW9uIHdpdGggcGFyYW1zIHRvIHRoZSBjb25zdHJ1Y3RvcgoJJC5tb2JpbGUuVHJhbnNpdGlvbiA9IGZ1bmN0aW9uKCkgewoJCXRoaXMuaW5pdC5hcHBseSggdGhpcywgYXJndW1lbnRzICk7Cgl9OwoKCSQuZXh0ZW5kKCQubW9iaWxlLlRyYW5zaXRpb24ucHJvdG90eXBlLCB7CgkJdG9QcmVDbGFzczogIiB1aS1wYWdlLXByZS1pbiIsCgoJCWluaXQ6IGZ1bmN0aW9uKCBuYW1lLCByZXZlcnNlLCAkdG8sICRmcm9tICkgewoJCQkkLmV4dGVuZCh0aGlzLCB7CgkJCQluYW1lOiBuYW1lLAoJCQkJcmV2ZXJzZTogcmV2ZXJzZSwKCQkJCSR0bzogJHRvLAoJCQkJJGZyb206ICRmcm9tLAoJCQkJZGVmZXJyZWQ6IG5ldyAkLkRlZmVycmVkKCkKCQkJfSk7CgkJfSwKCgkJY2xlYW5Gcm9tOiBmdW5jdGlvbigpIHsKCQkJdGhpcy4kZnJvbQoJCQkJLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVQYWdlQ2xhc3MgKyAiIG91dCBpbiByZXZlcnNlICIgKyB0aGlzLm5hbWUgKQoJCQkJLmhlaWdodCggIiIgKTsKCQl9LAoKCQkvLyBOT1RFIG92ZXJyaWRkZW4gYnkgY2hpbGQgb2JqZWN0IHByb3RvdHlwZXMsIG5vb3AnZCBoZXJlIGFzIGRlZmF1bHRzCgkJYmVmb3JlRG9uZUluOiBmdW5jdGlvbigpIHt9LAoJCWJlZm9yZURvbmVPdXQ6IGZ1bmN0aW9uKCkge30sCgkJYmVmb3JlU3RhcnRPdXQ6IGZ1bmN0aW9uKCkge30sCgoJCWRvbmVJbjogZnVuY3Rpb24oKSB7CgkJCXRoaXMuYmVmb3JlRG9uZUluKCk7CgoJCQl0aGlzLiR0by5yZW1vdmVDbGFzcyggIm91dCBpbiByZXZlcnNlICIgKyB0aGlzLm5hbWUgKS5oZWlnaHQoICIiICk7CgoJCQl0aGlzLnRvZ2dsZVZpZXdwb3J0Q2xhc3MoKTsKCgkJCS8vIEluIHNvbWUgYnJvd3NlcnMgKGlPUzUpLCAzRCB0cmFuc2l0aW9ucyBibG9jayB0aGUgYWJpbGl0eSB0byBzY3JvbGwgdG8gdGhlIGRlc2lyZWQgbG9jYXRpb24gZHVyaW5nIHRyYW5zaXRpb24KCQkJLy8gVGhpcyBlbnN1cmVzIHdlIGp1bXAgdG8gdGhhdCBzcG90IGFmdGVyIHRoZSBmYWN0LCBpZiB3ZSBhcmVuJ3QgdGhlcmUgYWxyZWFkeS4KCQkJaWYgKCAkLm1vYmlsZS53aW5kb3cuc2Nyb2xsVG9wKCkgIT09IHRoaXMudG9TY3JvbGwgKSB7CgkJCQl0aGlzLnNjcm9sbFBhZ2UoKTsKCQkJfQoJCQlpZiggIXRoaXMuc2VxdWVudGlhbCApewoJCQkJdGhpcy4kdG8uYWRkQ2xhc3MoICQubW9iaWxlLmFjdGl2ZVBhZ2VDbGFzcyApOwoJCQl9CgkJCXRoaXMuZGVmZXJyZWQucmVzb2x2ZSggdGhpcy5uYW1lLCB0aGlzLnJldmVyc2UsIHRoaXMuJHRvLCB0aGlzLiRmcm9tLCB0cnVlICk7CgkJfSwKCgkJZG9uZU91dDogZnVuY3Rpb24oIHNjcmVlbkhlaWdodCwgcmV2ZXJzZUNsYXNzLCBub25lLCBwcmV2ZW50Rm9jdXMgKSB7CgkJCXRoaXMuYmVmb3JlRG9uZU91dCgpOwoJCQl0aGlzLnN0YXJ0SW4oIHNjcmVlbkhlaWdodCwgcmV2ZXJzZUNsYXNzLCBub25lLCBwcmV2ZW50Rm9jdXMgKTsKCQl9LAoKCQloaWRlSW46IGZ1bmN0aW9uKCBjYWxsYmFjayApIHsKCQkJLy8gUHJldmVudCBmbGlja2VyaW5nIGluIHBob25lZ2FwIGNvbnRhaW5lcjogc2VlIGNvbW1lbnRzIGF0ICM0MDI0IHJlZ2FyZGluZyBpT1MKCQkJdGhpcy4kdG8uY3NzKCAiei1pbmRleCIsIC0xMCApOwoJCQljYWxsYmFjay5jYWxsKCB0aGlzICk7CgkJCXRoaXMuJHRvLmNzcyggInotaW5kZXgiLCAiIiApOwoJCX0sCgoJCXNjcm9sbFBhZ2U6IGZ1bmN0aW9uKCkgewoJCQkvLyBCeSB1c2luZyBzY3JvbGxUbyBpbnN0ZWFkIG9mIHNpbGVudFNjcm9sbCwgd2UgY2FuIGtlZXAgdGhpbmdzIGJldHRlciBpbiBvcmRlcgoJCQkvLyBKdXN0IHRvIGJlIHByZWNhdXRpb3MsIGRpc2FibGUgc2Nyb2xsc3RhcnQgbGlzdGVuaW5nIGxpa2Ugc2lsZW50U2Nyb2xsIHdvdWxkCgkJCSQuZXZlbnQuc3BlY2lhbC5zY3JvbGxzdGFydC5lbmFibGVkID0gZmFsc2U7CgkJCS8vaWYgd2UgYXJlIGhpZGluZyB0aGUgdXJsIGJhciBvciB0aGUgcGFnZSB3YXMgcHJldmlvdXNseSBzY3JvbGxlZCBzY3JvbGwgdG8gaGlkZSBvciByZXR1cm4gdG8gcG9zaXRpb24KCQkJaWYgKCAkLm1vYmlsZS5oaWRlVXJsQmFyIHx8IHRoaXMudG9TY3JvbGwgIT09ICQubW9iaWxlLmRlZmF1bHRIb21lU2Nyb2xsICkgewoJCQkJd2luZG93LnNjcm9sbFRvKCAwLCB0aGlzLnRvU2Nyb2xsICk7CgkJCX0KCgkJCS8vIHJlZW5hYmxlIHNjcm9sbHN0YXJ0IGxpc3RlbmluZyBsaWtlIHNpbGVudFNjcm9sbCB3b3VsZAoJCQlzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJCSQuZXZlbnQuc3BlY2lhbC5zY3JvbGxzdGFydC5lbmFibGVkID0gdHJ1ZTsKCQkJfSwgMTUwICk7CgkJfSwKCgkJc3RhcnRJbjogZnVuY3Rpb24oIHNjcmVlbkhlaWdodCwgcmV2ZXJzZUNsYXNzLCBub25lLCBwcmV2ZW50Rm9jdXMgKSB7CgkJCXRoaXMuaGlkZUluKGZ1bmN0aW9uKCkgewoJCQkJdGhpcy4kdG8uYWRkQ2xhc3MoICQubW9iaWxlLmFjdGl2ZVBhZ2VDbGFzcyArIHRoaXMudG9QcmVDbGFzcyApOwoKCQkJCS8vIFNlbmQgZm9jdXMgdG8gcGFnZSBhcyBpdCBpcyBub3cgZGlzcGxheTogYmxvY2sKCQkJCWlmKCAhcHJldmVudEZvY3VzICl7CgkJCQkJJC5tb2JpbGUuZm9jdXNQYWdlKCB0aGlzLiR0byApOwoJCQkJfQoKCQkJCS8vIFNldCB0byBwYWdlIGhlaWdodAoJCQkJdGhpcy4kdG8uaGVpZ2h0KCBzY3JlZW5IZWlnaHQgKyB0aGlzLnRvU2Nyb2xsICk7CgogICAgICAgICAgICAgICAgaWYgKCAhbm9uZSApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNjcm9sbFBhZ2UoKTsKICAgICAgICAgICAgICAgIH0KCQkJfSk7CgoJCQlpZiAoICFub25lICkgewoJCQkJdGhpcy4kdG8uYW5pbWF0aW9uQ29tcGxldGUoICQucHJveHkoZnVuY3Rpb24oKSB7CgkJCQkJdGhpcy5kb25lSW4oKTsKCQkJCX0sIHRoaXMgKSk7CgkJCX0KCgkJCXRoaXMuJHRvCgkJCQkucmVtb3ZlQ2xhc3MoIHRoaXMudG9QcmVDbGFzcyApCgkJCQkuYWRkQ2xhc3MoIHRoaXMubmFtZSArICIgaW4gIiArIHJldmVyc2VDbGFzcyApOwoKCQkJaWYgKCBub25lICkgewoJCQkJdGhpcy5kb25lSW4oKTsKCQkJfQoKCQl9LAoKCQlzdGFydE91dDogZnVuY3Rpb24oIHNjcmVlbkhlaWdodCwgcmV2ZXJzZUNsYXNzLCBub25lICkgewoJCQl0aGlzLmJlZm9yZVN0YXJ0T3V0KCBzY3JlZW5IZWlnaHQsIHJldmVyc2VDbGFzcywgbm9uZSApOwoKCQkJLy8gU2V0IHRoZSBmcm9tIHBhZ2UncyBoZWlnaHQgYW5kIHN0YXJ0IGl0IHRyYW5zaXRpb25pbmcgb3V0CgkJCS8vIE5vdGU6IHNldHRpbmcgYW4gZXhwbGljaXQgaGVpZ2h0IGhlbHBzIGVsaW1pbmF0ZSB0aWxpbmcgaW4gdGhlIHRyYW5zaXRpb25zCgkJCXRoaXMuJGZyb20KCQkJCS5oZWlnaHQoIHNjcmVlbkhlaWdodCArICQubW9iaWxlLndpbmRvdy5zY3JvbGxUb3AoKSApCgkJCQkuYWRkQ2xhc3MoIHRoaXMubmFtZSArICIgb3V0IiArIHJldmVyc2VDbGFzcyApOwoJCX0sCgoKCQl0b2dnbGVWaWV3cG9ydENsYXNzOiBmdW5jdGlvbigpIHsKCQkJJC5tb2JpbGUucGFnZUNvbnRhaW5lci50b2dnbGVDbGFzcyggInVpLW1vYmlsZS12aWV3cG9ydC10cmFuc2l0aW9uaW5nIHZpZXdwb3J0LSIgKyB0aGlzLm5hbWUgKTsKCQl9LAoKCQl0cmFuc2l0aW9uOiBmdW5jdGlvbigpIHsKCQkJLy8gTk9URSBtYW55IG9mIHRoZXNlIGNvdWxkIGJlIGNhbGN1bGF0ZWQvcmVjb3JkZWQgaW4gdGhlIGNvbnN0cnVjdG9yLCBpdCdzIG15CgkJCS8vICAgICAgb3BpbmlvbiB0aGF0IGJpbmRpbmcgdGhlbSBhcyBsYXRlIGFzIHBvc3NpYmxlIGhhcyB2YWx1ZSB3aXRoIHJlZ2FyZHMgdG8KCQkJLy8gICAgICBiZXR0ZXIgdHJhbnNpdGlvbnMgd2l0aCBmZXdlciBidWdzLiBJZSwgaXQncyBub3QgZ3VhcmFudGVlZCB0aGF0IHRoZQoJCQkvLyAgICAgIG9iamVjdCB3aWxsIGJlIGNyZWF0ZWQgYW5kIHRyYW5zaXRpb24gd2lsbCBiZSBydW4gaW1tZWRpYXRlbHkgYWZ0ZXIgYXMKCQkJLy8gICAgICBpdCBpcyB0b2RheS4gU28gd2Ugd2FpdCB1bnRpbCB0cmFuc2l0aW9uIGlzIGludm9rZWQgdG8gZ2F0aGVyIHRoZSBmb2xsb3dpbmcKCQkJdmFyIHJldmVyc2VDbGFzcyA9IHRoaXMucmV2ZXJzZSA/ICIgcmV2ZXJzZSIgOiAiIiwKCQkJCXNjcmVlbkhlaWdodCA9ICQubW9iaWxlLmdldFNjcmVlbkhlaWdodCgpLAoJCQkJbWF4VHJhbnNpdGlvbk92ZXJyaWRlID0gJC5tb2JpbGUubWF4VHJhbnNpdGlvbldpZHRoICE9PSBmYWxzZSAmJiAkLm1vYmlsZS53aW5kb3cud2lkdGgoKSA+ICQubW9iaWxlLm1heFRyYW5zaXRpb25XaWR0aCwKCQkJCW5vbmUgPSAhJC5zdXBwb3J0LmNzc1RyYW5zaXRpb25zIHx8ICEkLnN1cHBvcnQuY3NzQW5pbWF0aW9ucyB8fCBtYXhUcmFuc2l0aW9uT3ZlcnJpZGUgfHwgIXRoaXMubmFtZSB8fCB0aGlzLm5hbWUgPT09ICJub25lIiB8fCBNYXRoLm1heCggJC5tb2JpbGUud2luZG93LnNjcm9sbFRvcCgpLCB0aGlzLnRvU2Nyb2xsICkgPiAkLm1vYmlsZS5nZXRNYXhTY3JvbGxGb3JUcmFuc2l0aW9uKCk7CgoJCQl0aGlzLnRvU2Nyb2xsID0gJC5tb2JpbGUubmF2aWdhdGUuaGlzdG9yeS5nZXRBY3RpdmUoKS5sYXN0U2Nyb2xsIHx8ICQubW9iaWxlLmRlZmF1bHRIb21lU2Nyb2xsOwoJCQl0aGlzLnRvZ2dsZVZpZXdwb3J0Q2xhc3MoKTsKCgkJCWlmICggdGhpcy4kZnJvbSAmJiAhbm9uZSApIHsKCQkJCXRoaXMuc3RhcnRPdXQoIHNjcmVlbkhlaWdodCwgcmV2ZXJzZUNsYXNzLCBub25lICk7CgkJCX0gZWxzZSB7CgkJCQl0aGlzLmRvbmVPdXQoIHNjcmVlbkhlaWdodCwgcmV2ZXJzZUNsYXNzLCBub25lLCB0cnVlICk7CgkJCX0KCgkJCXJldHVybiB0aGlzLmRlZmVycmVkLnByb21pc2UoKTsKCQl9Cgl9KTsKfSkoIGpRdWVyeSwgdGhpcyApOwoKCihmdW5jdGlvbiggJCApIHsKCgkkLm1vYmlsZS5TZXJpYWxUcmFuc2l0aW9uID0gZnVuY3Rpb24oKSB7CgkJdGhpcy5pbml0LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7Cgl9OwoKCSQuZXh0ZW5kKCQubW9iaWxlLlNlcmlhbFRyYW5zaXRpb24ucHJvdG90eXBlLCAkLm1vYmlsZS5UcmFuc2l0aW9uLnByb3RvdHlwZSwgewoJCXNlcXVlbnRpYWw6IHRydWUsCgoJCWJlZm9yZURvbmVPdXQ6IGZ1bmN0aW9uKCkgewoJCQlpZiAoIHRoaXMuJGZyb20gKSB7CgkJCQl0aGlzLmNsZWFuRnJvbSgpOwoJCQl9CgkJfSwKCgkJYmVmb3JlU3RhcnRPdXQ6IGZ1bmN0aW9uKCBzY3JlZW5IZWlnaHQsIHJldmVyc2VDbGFzcywgbm9uZSApIHsKCQkJdGhpcy4kZnJvbS5hbmltYXRpb25Db21wbGV0ZSgkLnByb3h5KGZ1bmN0aW9uKCkgewoJCQkJdGhpcy5kb25lT3V0KCBzY3JlZW5IZWlnaHQsIHJldmVyc2VDbGFzcywgbm9uZSApOwoJCQl9LCB0aGlzICkpOwoJCX0KCX0pOwoKfSkoIGpRdWVyeSApOwoKCihmdW5jdGlvbiggJCApIHsKCgkkLm1vYmlsZS5Db25jdXJyZW50VHJhbnNpdGlvbiA9IGZ1bmN0aW9uKCkgewoJCXRoaXMuaW5pdC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoJfTsKCgkkLmV4dGVuZCgkLm1vYmlsZS5Db25jdXJyZW50VHJhbnNpdGlvbi5wcm90b3R5cGUsICQubW9iaWxlLlRyYW5zaXRpb24ucHJvdG90eXBlLCB7CgkJc2VxdWVudGlhbDogZmFsc2UsCgoJCWJlZm9yZURvbmVJbjogZnVuY3Rpb24oKSB7CgkJCWlmICggdGhpcy4kZnJvbSApIHsKCQkJCXRoaXMuY2xlYW5Gcm9tKCk7CgkJCX0KCQl9LAoKCQliZWZvcmVTdGFydE91dDogZnVuY3Rpb24oIHNjcmVlbkhlaWdodCwgcmV2ZXJzZUNsYXNzLCBub25lICkgewoJCQl0aGlzLmRvbmVPdXQoIHNjcmVlbkhlaWdodCwgcmV2ZXJzZUNsYXNzLCBub25lICk7CgkJfQoJfSk7Cgp9KSggalF1ZXJ5ICk7CgoKKGZ1bmN0aW9uKCAkICkgewoKCS8vIGdlbmVyYXRlIHRoZSBoYW5kbGVycyBmcm9tIHRoZSBhYm92ZQoJdmFyIGRlZmF1bHRHZXRNYXhTY3JvbGxGb3JUcmFuc2l0aW9uID0gZnVuY3Rpb24oKSB7CgkJcmV0dXJuICQubW9iaWxlLmdldFNjcmVlbkhlaWdodCgpICogMzsKCX07CgoJLy90cmFuc2l0aW9uIGhhbmRsZXIgZGljdGlvbmFyeSBmb3IgM3JkIHBhcnR5IHRyYW5zaXRpb25zCgkkLm1vYmlsZS50cmFuc2l0aW9uSGFuZGxlcnMgPSB7CgkJInNlcXVlbnRpYWwiOiAkLm1vYmlsZS5TZXJpYWxUcmFuc2l0aW9uLAoJCSJzaW11bHRhbmVvdXMiOiAkLm1vYmlsZS5Db25jdXJyZW50VHJhbnNpdGlvbgoJfTsKCgkvLyBNYWtlIG91ciB0cmFuc2l0aW9uIGhhbmRsZXIgdGhlIHB1YmxpYyBkZWZhdWx0LgoJJC5tb2JpbGUuZGVmYXVsdFRyYW5zaXRpb25IYW5kbGVyID0gJC5tb2JpbGUudHJhbnNpdGlvbkhhbmRsZXJzLnNlcXVlbnRpYWw7CgoJJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrcyA9IHt9OwoKCS8vIElmIHRyYW5zaXRpb24gaXMgZGVmaW5lZCwgY2hlY2sgaWYgY3NzIDNEIHRyYW5zZm9ybXMgYXJlIHN1cHBvcnRlZCwgYW5kIGlmIG5vdCwgaWYgYSBmYWxsYmFjayBpcyBzcGVjaWZpZWQKCSQubW9iaWxlLl9tYXliZURlZ3JhZGVUcmFuc2l0aW9uID0gZnVuY3Rpb24oIHRyYW5zaXRpb24gKSB7CgkJaWYgKCB0cmFuc2l0aW9uICYmICEkLnN1cHBvcnQuY3NzVHJhbnNmb3JtM2QgJiYgJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrc1sgdHJhbnNpdGlvbiBdICkgewoJCQl0cmFuc2l0aW9uID0gJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrc1sgdHJhbnNpdGlvbiBdOwoJCX0KCgkJcmV0dXJuIHRyYW5zaXRpb247Cgl9OwoKCS8vIFNldCB0aGUgZ2V0TWF4U2Nyb2xsRm9yVHJhbnNpdGlvbiB0byBkZWZhdWx0IGlmIG5vIGltcGxlbWVudGF0aW9uIHdhcyBzZXQgYnkgdXNlcgoJJC5tb2JpbGUuZ2V0TWF4U2Nyb2xsRm9yVHJhbnNpdGlvbiA9ICQubW9iaWxlLmdldE1heFNjcm9sbEZvclRyYW5zaXRpb24gfHwgZGVmYXVsdEdldE1heFNjcm9sbEZvclRyYW5zaXRpb247Cgp9KSggalF1ZXJ5ICk7CgovKgoqIGZhbGxiYWNrIHRyYW5zaXRpb24gZm9yIGZsaXAgaW4gbm9uLTNEIHN1cHBvcnRpbmcgYnJvd3NlcnMgKHdoaWNoIHRlbmQgdG8gaGFuZGxlIGNvbXBsZXggdHJhbnNpdGlvbnMgcG9vcmx5IGluIGdlbmVyYWwKKi8KCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS50cmFuc2l0aW9uRmFsbGJhY2tzLmZsaXAgPSAiZmFkZSI7Cgp9KSggalF1ZXJ5LCB0aGlzICk7Ci8qCiogZmFsbGJhY2sgdHJhbnNpdGlvbiBmb3IgZmxvdyBpbiBub24tM0Qgc3VwcG9ydGluZyBicm93c2VycyAod2hpY2ggdGVuZCB0byBoYW5kbGUgY29tcGxleCB0cmFuc2l0aW9ucyBwb29ybHkgaW4gZ2VuZXJhbAoqLwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLnRyYW5zaXRpb25GYWxsYmFja3MuZmxvdyA9ICJmYWRlIjsKCn0pKCBqUXVlcnksIHRoaXMgKTsKLyoKKiBmYWxsYmFjayB0cmFuc2l0aW9uIGZvciBwb3AgaW4gbm9uLTNEIHN1cHBvcnRpbmcgYnJvd3NlcnMgKHdoaWNoIHRlbmQgdG8gaGFuZGxlIGNvbXBsZXggdHJhbnNpdGlvbnMgcG9vcmx5IGluIGdlbmVyYWwKKi8KCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS50cmFuc2l0aW9uRmFsbGJhY2tzLnBvcCA9ICJmYWRlIjsKCn0pKCBqUXVlcnksIHRoaXMgKTsKLyoKKiBmYWxsYmFjayB0cmFuc2l0aW9uIGZvciBzbGlkZSBpbiBub24tM0Qgc3VwcG9ydGluZyBicm93c2VycyAod2hpY2ggdGVuZCB0byBoYW5kbGUgY29tcGxleCB0cmFuc2l0aW9ucyBwb29ybHkgaW4gZ2VuZXJhbAoqLwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCi8vIFVzZSB0aGUgc2ltdWx0YW5lb3VzIHRyYW5zaXRpb25zIGhhbmRsZXIgZm9yIHNsaWRlIHRyYW5zaXRpb25zCiQubW9iaWxlLnRyYW5zaXRpb25IYW5kbGVycy5zbGlkZSA9ICQubW9iaWxlLnRyYW5zaXRpb25IYW5kbGVycy5zaW11bHRhbmVvdXM7CgovLyBTZXQgdGhlIHNsaWRlIHRyYW5zaXRpb25zJ3MgZmFsbGJhY2sgdG8gImZhZGUiCiQubW9iaWxlLnRyYW5zaXRpb25GYWxsYmFja3Muc2xpZGUgPSAiZmFkZSI7Cgp9KSggalF1ZXJ5LCB0aGlzICk7Ci8qCiogZmFsbGJhY2sgdHJhbnNpdGlvbiBmb3Igc2xpZGVkb3duIGluIG5vbi0zRCBzdXBwb3J0aW5nIGJyb3dzZXJzICh3aGljaCB0ZW5kIHRvIGhhbmRsZSBjb21wbGV4IHRyYW5zaXRpb25zIHBvb3JseSBpbiBnZW5lcmFsCiovCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrcy5zbGlkZWRvd24gPSAiZmFkZSI7Cgp9KSggalF1ZXJ5LCB0aGlzICk7Ci8qCiogZmFsbGJhY2sgdHJhbnNpdGlvbiBmb3Igc2xpZGVmYWRlIGluIG5vbi0zRCBzdXBwb3J0aW5nIGJyb3dzZXJzICh3aGljaCB0ZW5kIHRvIGhhbmRsZSBjb21wbGV4IHRyYW5zaXRpb25zIHBvb3JseSBpbiBnZW5lcmFsCiovCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKLy8gU2V0IHRoZSBzbGlkZSB0cmFuc2l0aW9ucydzIGZhbGxiYWNrIHRvICJmYWRlIgokLm1vYmlsZS50cmFuc2l0aW9uRmFsbGJhY2tzLnNsaWRlZmFkZSA9ICJmYWRlIjsKCn0pKCBqUXVlcnksIHRoaXMgKTsKLyoKKiBmYWxsYmFjayB0cmFuc2l0aW9uIGZvciBzbGlkZXVwIGluIG5vbi0zRCBzdXBwb3J0aW5nIGJyb3dzZXJzICh3aGljaCB0ZW5kIHRvIGhhbmRsZSBjb21wbGV4IHRyYW5zaXRpb25zIHBvb3JseSBpbiBnZW5lcmFsCiovCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrcy5zbGlkZXVwID0gImZhZGUiOwoKfSkoIGpRdWVyeSwgdGhpcyApOwovKgoqIGZhbGxiYWNrIHRyYW5zaXRpb24gZm9yIHR1cm4gaW4gbm9uLTNEIHN1cHBvcnRpbmcgYnJvd3NlcnMgKHdoaWNoIHRlbmQgdG8gaGFuZGxlIGNvbXBsZXggdHJhbnNpdGlvbnMgcG9vcmx5IGluIGdlbmVyYWwKKi8KCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS50cmFuc2l0aW9uRmFsbGJhY2tzLnR1cm4gPSAiZmFkZSI7Cgp9KSggalF1ZXJ5LCB0aGlzICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLmRlZ3JhZGVJbnB1dHMgPSB7Cgljb2xvcjogZmFsc2UsCglkYXRlOiBmYWxzZSwKCWRhdGV0aW1lOiBmYWxzZSwKCSJkYXRldGltZS1sb2NhbCI6IGZhbHNlLAoJZW1haWw6IGZhbHNlLAoJbW9udGg6IGZhbHNlLAoJbnVtYmVyOiBmYWxzZSwKCXJhbmdlOiAibnVtYmVyIiwKCXNlYXJjaDogInRleHQiLAoJdGVsOiBmYWxzZSwKCXRpbWU6IGZhbHNlLAoJdXJsOiBmYWxzZSwKCXdlZWs6IGZhbHNlCn07Ci8vIEJhY2tjb21wYXQgcmVtb3ZlIGluIDEuNQokLm1vYmlsZS5wYWdlLnByb3RvdHlwZS5vcHRpb25zLmRlZ3JhZGVJbnB1dHMgPSAkLm1vYmlsZS5kZWdyYWRlSW5wdXRzOwoKLy8gQXV0byBzZWxmLWluaXQgd2lkZ2V0cwokLm1vYmlsZS5kZWdyYWRlSW5wdXRzV2l0aGluID0gZnVuY3Rpb24oIHRhcmdldCApIHsKCgl0YXJnZXQgPSAkKCB0YXJnZXQgKTsKCgkvLyBEZWdyYWRlIGlucHV0cyB0byBhdm9pZCBwb29ybHkgaW1wbGVtZW50ZWQgbmF0aXZlIGZ1bmN0aW9uYWxpdHkKCXRhcmdldC5maW5kKCAiaW5wdXQiICkubm90KCAkLm1vYmlsZS5wYWdlLnByb3RvdHlwZS5rZWVwTmF0aXZlU2VsZWN0b3IoKSApLmVhY2goZnVuY3Rpb24oKSB7CgkJdmFyIGVsZW1lbnQgPSAkKCB0aGlzICksCgkJCXR5cGUgPSB0aGlzLmdldEF0dHJpYnV0ZSggInR5cGUiICksCgkJCW9wdFR5cGUgPSAkLm1vYmlsZS5kZWdyYWRlSW5wdXRzWyB0eXBlIF0gfHwgInRleHQiLAoJCQlodG1sLCBoYXNUeXBlLCBmaW5kc3RyLCByZXBzdHI7CgoJCWlmICggJC5tb2JpbGUuZGVncmFkZUlucHV0c1sgdHlwZSBdICkgewoJCQlodG1sID0gJCggIjxkaXY+IiApLmh0bWwoIGVsZW1lbnQuY2xvbmUoKSApLmh0bWwoKTsKCQkJLy8gSW4gSUUgYnJvd3NlcnMsIHRoZSB0eXBlIHNvbWV0aW1lcyBkb2Vzbid0IGV4aXN0IGluIHRoZSBjbG9uZWQgbWFya3VwLCBzbyB3ZSByZXBsYWNlIHRoZSBjbG9zaW5nIHRhZyBpbnN0ZWFkCgkJCWhhc1R5cGUgPSBodG1sLmluZGV4T2YoICIgdHlwZT0iICkgPiAtMTsKCQkJZmluZHN0ciA9IGhhc1R5cGUgPyAvXHMrdHlwZT1bIiddP1x3K1snIl0/LyA6IC9cLz8+LzsKCQkJcmVwc3RyID0gIiB0eXBlPVwiIiArIG9wdFR5cGUgKyAiXCIgZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidHlwZT1cIiIgKyB0eXBlICsgIlwiIiArICggaGFzVHlwZSA/ICIiIDogIj4iICk7CgoJCQllbGVtZW50LnJlcGxhY2VXaXRoKCBodG1sLnJlcGxhY2UoIGZpbmRzdHIsIHJlcHN0ciApICk7CgkJfQoJfSk7Cgp9OwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLnBhZ2UiLCAkLm1vYmlsZS5wYWdlLCB7CglvcHRpb25zOiB7CgoJCS8vIEFjY2VwdHMgbGVmdCwgcmlnaHQgYW5kIG5vbmUKCQljbG9zZUJ0bjogImxlZnQiLAoJCWNsb3NlQnRuVGV4dDogIkNsb3NlIiwKCQlvdmVybGF5VGhlbWU6ICJhIiwKCQljb3JuZXJzOiB0cnVlLAoJCWRpYWxvZzogZmFsc2UKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5fc3VwZXIoKTsKCQlpZiggdGhpcy5vcHRpb25zLmRpYWxvZyApewoKCQkJJC5leHRlbmQoIHRoaXMsIHsKCQkJCV9pc0Nsb3NlYWJsZTogZmFsc2UsCgkJCQlfaW5uZXI6IHRoaXMuZWxlbWVudC5jaGlsZHJlbigpLAoJCQkJX2hlYWRlckNsb3NlQnV0dG9uOiBudWxsCgkJCX0pOwoKCQkJaWYoICF0aGlzLm9wdGlvbnMuZW5oYW5jZWQgKSB7CgkJCQl0aGlzLl9zZXRDbG9zZUJ0biggdGhpcy5vcHRpb25zLmNsb3NlQnRuICk7CgkJCX0KCQl9Cgl9LAoKCV9lbmhhbmNlOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9zdXBlcigpOwoKCQkvLyBDbGFzcyB0aGUgbWFya3VwIGZvciBkaWFsb2cgc3R5bGluZyBhbmQgd3JhcCBpbnRlcmlvcgoJCWlmKCB0aGlzLm9wdGlvbnMuZGlhbG9nICl7CgkJCXRoaXMuZWxlbWVudC5hZGRDbGFzcyggInVpLWRpYWxvZyIgKQoJCQkJLndyYXBJbm5lciggJCggIjxkaXYvPiIsIHsKCgkJCQkJLy8gQVJJQSByb2xlCgkJCQkJInJvbGUiIDogImRpYWxvZyIsCgkJCQkJImNsYXNzIiA6ICJ1aS1kaWFsb2ctY29udGFpbiB1aS1vdmVybGF5LXNoYWRvdyIgKwoJCQkJCQkoIHRoaXMub3B0aW9ucy5jb3JuZXJzID8gIiB1aS1jb3JuZXItYWxsIiA6ICIiICkKCQkJCX0pKTsKCQl9Cgl9LAoKCV9zZXRPcHRpb25zOiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQl2YXIgY2xvc2VCdXR0b25Mb2NhdGlvbiwgY2xvc2VCdXR0b25UZXh0LAoJCQljdXJyZW50T3B0cyA9IHRoaXMub3B0aW9uczsKCgkJaWYgKCBvcHRpb25zLmNvcm5lcnMgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhpcy5faW5uZXIudG9nZ2xlQ2xhc3MoICJ1aS1jb3JuZXItYWxsIiwgISFvcHRpb25zLmNvcm5lcnMgKTsKCQl9CgoJCWlmICggb3B0aW9ucy5vdmVybGF5VGhlbWUgIT09IHVuZGVmaW5lZCApIHsKCQkJaWYgKCAkLm1vYmlsZS5hY3RpdmVQYWdlWyAwIF0gPT09IHRoaXMuZWxlbWVudFsgMCBdICkgewoJCQkJY3VycmVudE9wdHMub3ZlcmxheVRoZW1lID0gb3B0aW9ucy5vdmVybGF5VGhlbWU7CgkJCQl0aGlzLl9oYW5kbGVQYWdlQmVmb3JlU2hvdygpOwoJCQl9CgkJfQoKCQlpZiAoIG9wdGlvbnMuY2xvc2VCdG5UZXh0ICE9PSB1bmRlZmluZWQgKSB7CgkJCWNsb3NlQnV0dG9uTG9jYXRpb24gPSBjdXJyZW50T3B0cy5jbG9zZUJ0bjsKCQkJY2xvc2VCdXR0b25UZXh0ID0gb3B0aW9ucy5jbG9zZUJ0blRleHQ7CgkJfQoKCQlpZiAoIG9wdGlvbnMuY2xvc2VCdG4gIT09IHVuZGVmaW5lZCApIHsKCQkJY2xvc2VCdXR0b25Mb2NhdGlvbiA9IG9wdGlvbnMuY2xvc2VCdG47CgkJfQoKCQlpZiAoIGNsb3NlQnV0dG9uTG9jYXRpb24gKSB7CgkJCXRoaXMuX3NldENsb3NlQnRuKCBjbG9zZUJ1dHRvbkxvY2F0aW9uLCBjbG9zZUJ1dHRvblRleHQgKTsKCQl9CgoJCXRoaXMuX3N1cGVyKCBvcHRpb25zICk7Cgl9LAoKCV9oYW5kbGVQYWdlQmVmb3JlU2hvdzogZnVuY3Rpb24gKCkgewoJCWlmICggdGhpcy5vcHRpb25zLm92ZXJsYXlUaGVtZSAmJiB0aGlzLm9wdGlvbnMuZGlhbG9nICkgewoJCQl0aGlzLnJlbW92ZUNvbnRhaW5lckJhY2tncm91bmQoKTsKCQkJdGhpcy5zZXRDb250YWluZXJCYWNrZ3JvdW5kKCB0aGlzLm9wdGlvbnMub3ZlcmxheVRoZW1lICk7CgkJfSBlbHNlIHsKCQkJdGhpcy5fc3VwZXIoKTsKCQl9Cgl9LAoKCV9zZXRDbG9zZUJ0bjogZnVuY3Rpb24oIGxvY2F0aW9uLCB0ZXh0ICkgewoJCXZhciBkc3QsCgkJCWJ0biA9IHRoaXMuX2hlYWRlckNsb3NlQnV0dG9uOwoKCQkvLyBTYW5pdGl6ZSB2YWx1ZQoJCWxvY2F0aW9uID0gImxlZnQiID09PSBsb2NhdGlvbiA/ICJsZWZ0IiA6ICJyaWdodCIgPT09IGxvY2F0aW9uID8gInJpZ2h0IiA6ICJub25lIjsKCgkJaWYgKCAibm9uZSIgPT09IGxvY2F0aW9uICkgewoJCQlpZiAoIGJ0biApIHsKCQkJCWJ0bi5yZW1vdmUoKTsKCQkJCWJ0biA9IG51bGw7CgkJCX0KCQl9IGVsc2UgaWYgKCBidG4gKSB7CgkJCWJ0bi5yZW1vdmVDbGFzcyggInVpLWJ0bi1sZWZ0IHVpLWJ0bi1yaWdodCIgKS5hZGRDbGFzcyggInVpLWJ0bi0iICsgbG9jYXRpb24gKTsKCQkJaWYgKCB0ZXh0ICkgewoJCQkJYnRuLnRleHQoIHRleHQgKTsKCQkJfQoJCX0gZWxzZSB7CgkJCWRzdCA9IHRoaXMuX2lubmVyLmZpbmQoICI6anFtRGF0YShyb2xlPSdoZWFkZXInKSIgKS5maXJzdCgpOwoJCQlidG4gPSAkKCAiPGE+PC9hPiIsIHsKCQkJCQkicm9sZSI6ICJidXR0b24iLAoJCQkJCSJocmVmIjogIiMiLAoJCQkJCSJjbGFzcyI6ICJ1aS1idG4gdWktY29ybmVyLWFsbCB1aS1pY29uLWRlbGV0ZSB1aS1idG4taWNvbi1ub3RleHQgdWktYnRuLSIgKyBsb2NhdGlvbgoJCQkJfSkKCQkJCS50ZXh0KCB0ZXh0IHx8IHRoaXMub3B0aW9ucy5jbG9zZUJ0blRleHQgfHwgIiIgKQoJCQkJLnByZXBlbmRUbyggZHN0ICk7CgkJCXRoaXMuX29uKCBidG4sIHsgY2xpY2s6ICJjbG9zZSIgfSApOwoJCX0KCgkJdGhpcy5faGVhZGVyQ2xvc2VCdXR0b24gPSBidG47Cgl9LAoKCS8vIENsb3NlIG1ldGhvZCBnb2VzIGJhY2sgaW4gaGlzdG9yeQoJY2xvc2U6IGZ1bmN0aW9uKCkgewoJCXZhciBpZHgsIGRzdCwgaGlzdCA9ICQubW9iaWxlLm5hdmlnYXRlLmhpc3Rvcnk7CgoJCQlpZiAoICQubW9iaWxlLmhhc2hMaXN0ZW5pbmdFbmFibGVkICYmIGhpc3QuYWN0aXZlSW5kZXggPiAwICkgewoJCQkJJC5tb2JpbGUuYmFjaygpOwoJCQl9IGVsc2UgewoJCQkJaWR4ID0gTWF0aC5tYXgoIDAsIGhpc3QuYWN0aXZlSW5kZXggLSAxICk7CgkJCQlkc3QgPSBoaXN0LnN0YWNrWyBpZHggXS5wYWdlVXJsIHx8IGhpc3Quc3RhY2tbIGlkeCBdLnVybDsKCQkJCWhpc3QucHJldmlvdXNJbmRleCA9IGhpc3QuYWN0aXZlSW5kZXg7CgkJCQloaXN0LmFjdGl2ZUluZGV4ID0gaWR4OwoJCQkJaWYgKCAhJC5tb2JpbGUucGF0aC5pc1BhdGgoIGRzdCApICkgewoJCQkJCWRzdCA9ICQubW9iaWxlLnBhdGgubWFrZVVybEFic29sdXRlKCAiIyIgKyBkc3QgKTsKCQkJCX0KCgkJCQkkLm1vYmlsZS5jaGFuZ2VQYWdlKCBkc3QsIHsgZGlyZWN0aW9uOiAiYmFjayIsIGNoYW5nZUhhc2g6IGZhbHNlLCBmcm9tSGFzaENoYW5nZTogdHJ1ZSB9ICk7CgkJCX0KCX0KfSk7Cgp9KSggalF1ZXJ5LCB0aGlzICk7CgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUuZGlhbG9nIiwgewoJb3B0aW9uczogewoKCQkvLyBBY2NlcHRzIGxlZnQsIHJpZ2h0IGFuZCBub25lCgkJY2xvc2VCdG46ICJsZWZ0IiwKCQljbG9zZUJ0blRleHQ6ICJDbG9zZSIsCgkJb3ZlcmxheVRoZW1lOiAiYSIsCgkJY29ybmVyczogdHJ1ZQoJfSwKCgkvLyBPdmVycmlkZSB0aGUgdGhlbWUgc2V0IGJ5IHRoZSBwYWdlIHBsdWdpbiBvbiBwYWdlc2hvdwoJX2hhbmRsZVBhZ2VCZWZvcmVTaG93OiBmdW5jdGlvbigpIHsKCQl0aGlzLl9pc0Nsb3NlYWJsZSA9IHRydWU7CgkJaWYgKCB0aGlzLm9wdGlvbnMub3ZlcmxheVRoZW1lICkgewoJCQl0aGlzLmVsZW1lbnQKCQkJCS5wYWdlKCAicmVtb3ZlQ29udGFpbmVyQmFja2dyb3VuZCIgKQoJCQkJLnBhZ2UoICJzZXRDb250YWluZXJCYWNrZ3JvdW5kIiwgdGhpcy5vcHRpb25zLm92ZXJsYXlUaGVtZSApOwoJCX0KCX0sCgoJX2hhbmRsZVBhZ2VCZWZvcmVIaWRlOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9pc0Nsb3NlYWJsZSA9IGZhbHNlOwoJfSwKCgkvLyBjbGljayBhbmQgc3VibWl0IGV2ZW50czoKCS8vIC0gY2xpY2tzIGFuZCBzdWJtaXRzIHNob3VsZCB1c2UgdGhlIGNsb3NpbmcgdHJhbnNpdGlvbiB0aGF0IHRoZSBkaWFsb2cKCS8vICAgb3BlbmVkIHdpdGggdW5sZXNzIGEgZGF0YS10cmFuc2l0aW9uIGlzIHNwZWNpZmllZCBvbiB0aGUgbGluay9mb3JtCgkvLyAtIGlmIHRoZSBjbGljayB3YXMgb24gdGhlIGNsb3NlIGJ1dHRvbiwgb3IgdGhlIGxpbmsgaGFzIGEgZGF0YS1yZWw9ImJhY2siCgkvLyAgIGl0J2xsIGdvIGJhY2sgaW4gaGlzdG9yeSBuYXR1cmFsbHkKCV9oYW5kbGVWQ2xpY2tTdWJtaXQ6IGZ1bmN0aW9uKCBldmVudCApIHsKCQl2YXIgYXR0cnMsCgkJCSR0YXJnZXQgPSAkKCBldmVudC50YXJnZXQgKS5jbG9zZXN0KCBldmVudC50eXBlID09PSAidmNsaWNrIiA/ICJhIiA6ICJmb3JtIiApOwoKCQlpZiAoICR0YXJnZXQubGVuZ3RoICYmICEkdGFyZ2V0LmpxbURhdGEoICJ0cmFuc2l0aW9uIiApICkgewoJCQlhdHRycyA9IHt9OwoJCQlhdHRyc1sgImRhdGEtIiArICQubW9iaWxlLm5zICsgInRyYW5zaXRpb24iIF0gPQoJCQkJKCAkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5LmdldEFjdGl2ZSgpIHx8IHt9IClbICJ0cmFuc2l0aW9uIiBdIHx8CgkJCQkkLm1vYmlsZS5kZWZhdWx0RGlhbG9nVHJhbnNpdGlvbjsKCQkJYXR0cnNbICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJkaXJlY3Rpb24iIF0gPSAicmV2ZXJzZSI7CgkJCSR0YXJnZXQuYXR0ciggYXR0cnMgKTsKCQl9Cgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXZhciBlbGVtID0gdGhpcy5lbGVtZW50LAoJCQlvcHRzID0gdGhpcy5vcHRpb25zOwoKCQkvLyBDbGFzcyB0aGUgbWFya3VwIGZvciBkaWFsb2cgc3R5bGluZyBhbmQgd3JhcCBpbnRlcmlvcgoJCWVsZW0uYWRkQ2xhc3MoICJ1aS1kaWFsb2ciICkKCQkJLndyYXBJbm5lciggJCggIjxkaXYvPiIsIHsKCgkJCQkvLyBBUklBIHJvbGUKCQkJCSJyb2xlIiA6ICJkaWFsb2ciLAoJCQkJImNsYXNzIiA6ICJ1aS1kaWFsb2ctY29udGFpbiB1aS1vdmVybGF5LXNoYWRvdyIgKwoJCQkJCSggISFvcHRzLmNvcm5lcnMgPyAiIHVpLWNvcm5lci1hbGwiIDogIiIgKQoJCQl9KSk7CgoJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCV9pc0Nsb3NlYWJsZTogZmFsc2UsCgkJCV9pbm5lcjogZWxlbS5jaGlsZHJlbigpLAoJCQlfaGVhZGVyQ2xvc2VCdXR0b246IG51bGwKCQl9KTsKCgkJdGhpcy5fb24oIGVsZW0sIHsKCQkJdmNsaWNrOiAiX2hhbmRsZVZDbGlja1N1Ym1pdCIsCgkJCXN1Ym1pdDogIl9oYW5kbGVWQ2xpY2tTdWJtaXQiLAoJCQlwYWdlYmVmb3Jlc2hvdzogIl9oYW5kbGVQYWdlQmVmb3JlU2hvdyIsCgkJCXBhZ2ViZWZvcmVoaWRlOiAiX2hhbmRsZVBhZ2VCZWZvcmVIaWRlIgoJCX0pOwoKCQl0aGlzLl9zZXRDbG9zZUJ0biggb3B0cy5jbG9zZUJ0biApOwoJfSwKCglfc2V0T3B0aW9uczogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJdmFyIGNsb3NlQnV0dG9uTG9jYXRpb24sIGNsb3NlQnV0dG9uVGV4dCwKCQkJY3VycmVudE9wdHMgPSB0aGlzLm9wdGlvbnM7CgoJCWlmICggb3B0aW9ucy5jb3JuZXJzICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMuX2lubmVyLnRvZ2dsZUNsYXNzKCAidWktY29ybmVyLWFsbCIsICEhb3B0aW9ucy5jb3JuZXJzICk7CgkJfQoKCQlpZiAoIG9wdGlvbnMub3ZlcmxheVRoZW1lICE9PSB1bmRlZmluZWQgKSB7CgkJCWlmICggJC5tb2JpbGUuYWN0aXZlUGFnZVsgMCBdID09PSB0aGlzLmVsZW1lbnRbIDAgXSApIHsKCQkJCWN1cnJlbnRPcHRzLm92ZXJsYXlUaGVtZSA9IG9wdGlvbnMub3ZlcmxheVRoZW1lOwoJCQkJdGhpcy5faGFuZGxlUGFnZUJlZm9yZVNob3coKTsKCQkJfQoJCX0KCgkJaWYgKCBvcHRpb25zLmNsb3NlQnRuVGV4dCAhPT0gdW5kZWZpbmVkICkgewoJCQljbG9zZUJ1dHRvbkxvY2F0aW9uID0gY3VycmVudE9wdHMuY2xvc2VCdG47CgkJCWNsb3NlQnV0dG9uVGV4dCA9IG9wdGlvbnMuY2xvc2VCdG5UZXh0OwoJCX0KCgkJaWYgKCBvcHRpb25zLmNsb3NlQnRuICE9PSB1bmRlZmluZWQgKSB7CgkJCWNsb3NlQnV0dG9uTG9jYXRpb24gPSBvcHRpb25zLmNsb3NlQnRuOwoJCX0KCgkJaWYgKCBjbG9zZUJ1dHRvbkxvY2F0aW9uICkgewoJCQl0aGlzLl9zZXRDbG9zZUJ0biggY2xvc2VCdXR0b25Mb2NhdGlvbiwgY2xvc2VCdXR0b25UZXh0ICk7CgkJfQoKCQl0aGlzLl9zdXBlciggb3B0aW9ucyApOwoJfSwKCglfc2V0Q2xvc2VCdG46IGZ1bmN0aW9uKCBsb2NhdGlvbiwgdGV4dCApIHsKCQl2YXIgZHN0LAoJCQlidG4gPSB0aGlzLl9oZWFkZXJDbG9zZUJ1dHRvbjsKCgkJLy8gU2FuaXRpemUgdmFsdWUKCQlsb2NhdGlvbiA9ICJsZWZ0IiA9PT0gbG9jYXRpb24gPyAibGVmdCIgOiAicmlnaHQiID09PSBsb2NhdGlvbiA/ICJyaWdodCIgOiAibm9uZSI7CgoJCWlmICggIm5vbmUiID09PSBsb2NhdGlvbiApIHsKCQkJaWYgKCBidG4gKSB7CgkJCQlidG4ucmVtb3ZlKCk7CgkJCQlidG4gPSBudWxsOwoJCQl9CgkJfSBlbHNlIGlmICggYnRuICkgewoJCQlidG4ucmVtb3ZlQ2xhc3MoICJ1aS1idG4tbGVmdCB1aS1idG4tcmlnaHQiICkuYWRkQ2xhc3MoICJ1aS1idG4tIiArIGxvY2F0aW9uICk7CgkJCWlmICggdGV4dCApIHsKCQkJCWJ0bi50ZXh0KCB0ZXh0ICk7CgkJCX0KCQl9IGVsc2UgewoJCQlkc3QgPSB0aGlzLl9pbm5lci5maW5kKCAiOmpxbURhdGEocm9sZT0naGVhZGVyJykiICkuZmlyc3QoKTsKCQkJYnRuID0gJCggIjxhPjwvYT4iLCB7CgkJCQkJInJvbGUiOiAiYnV0dG9uIiwKCQkJCQkiaHJlZiI6ICIjIiwKCQkJCQkiY2xhc3MiOiAidWktYnRuIHVpLWNvcm5lci1hbGwgdWktaWNvbi1kZWxldGUgdWktYnRuLWljb24tbm90ZXh0IHVpLWJ0bi0iICsgbG9jYXRpb24KCQkJCX0pCgkJCQkudGV4dCggdGV4dCB8fCB0aGlzLm9wdGlvbnMuY2xvc2VCdG5UZXh0IHx8ICIiICkKCQkJCS5wcmVwZW5kVG8oIGRzdCApOwoJCQl0aGlzLl9vbiggYnRuLCB7IGNsaWNrOiAiY2xvc2UiIH0gKTsKCQl9CgoJCXRoaXMuX2hlYWRlckNsb3NlQnV0dG9uID0gYnRuOwoJfSwKCgkvLyBDbG9zZSBtZXRob2QgZ29lcyBiYWNrIGluIGhpc3RvcnkKCWNsb3NlOiBmdW5jdGlvbigpIHsKCQl2YXIgaWR4LCBkc3QsIGhpc3QgPSAkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5OwoKCQlpZiAoIHRoaXMuX2lzQ2xvc2VhYmxlICkgewoJCQl0aGlzLl9pc0Nsb3NlYWJsZSA9IGZhbHNlOwoJCQkvLyBJZiB0aGUgaGFzaCBsaXN0ZW5pbmcgaXMgZW5hYmxlZCBhbmQgdGhlcmUgaXMgYXQgbGVhc3Qgb25lIHByZWNlZGluZyBoaXN0b3J5CgkJCS8vIGVudHJ5IGl0J3Mgb2sgdG8gZ28gYmFjay4gSW5pdGlhbCBwYWdlcyB3aXRoIHRoZSBkaWFsb2cgaGFzaCBzdGF0ZSBhcmUgYW4gZXhhbXBsZQoJCQkvLyB3aGVyZSB0aGUgc3RhY2sgY2hlY2sgaXMgbmVjZXNzYXJ5CgkJCWlmICggJC5tb2JpbGUuaGFzaExpc3RlbmluZ0VuYWJsZWQgJiYgaGlzdC5hY3RpdmVJbmRleCA+IDAgKSB7CgkJCQkkLm1vYmlsZS5iYWNrKCk7CgkJCX0gZWxzZSB7CgkJCQlpZHggPSBNYXRoLm1heCggMCwgaGlzdC5hY3RpdmVJbmRleCAtIDEgKTsKCQkJCWRzdCA9IGhpc3Quc3RhY2tbIGlkeCBdLnBhZ2VVcmwgfHwgaGlzdC5zdGFja1sgaWR4IF0udXJsOwoJCQkJaGlzdC5wcmV2aW91c0luZGV4ID0gaGlzdC5hY3RpdmVJbmRleDsKCQkJCWhpc3QuYWN0aXZlSW5kZXggPSBpZHg7CgkJCQlpZiAoICEkLm1vYmlsZS5wYXRoLmlzUGF0aCggZHN0ICkgKSB7CgkJCQkJZHN0ID0gJC5tb2JpbGUucGF0aC5tYWtlVXJsQWJzb2x1dGUoICIjIiArIGRzdCApOwoJCQkJfQoKCQkJCSQubW9iaWxlLmNoYW5nZVBhZ2UoIGRzdCwgeyBkaXJlY3Rpb246ICJiYWNrIiwgY2hhbmdlSGFzaDogZmFsc2UsIGZyb21IYXNoQ2hhbmdlOiB0cnVlIH0gKTsKCQkJfQoJCX0KCX0KfSk7Cgp9KSggalF1ZXJ5LCB0aGlzICk7CihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKdmFyIHJJbml0aWFsTGV0dGVyID0gLyhbQS1aXSkvZzsKCiQud2lkZ2V0KCAibW9iaWxlLmNvbGxhcHNpYmxlIiwgewoJb3B0aW9uczogewoJCWVuaGFuY2VkOiBmYWxzZSwKCQlleHBhbmRDdWVUZXh0OiBudWxsLAoJCWNvbGxhcHNlQ3VlVGV4dDogbnVsbCwKCQljb2xsYXBzZWQ6IHRydWUsCgkJaGVhZGluZzogImgxLGgyLGgzLGg0LGg1LGg2LGxlZ2VuZCIsCgkJY29sbGFwc2VkSWNvbjogbnVsbCwKCQlleHBhbmRlZEljb246IG51bGwsCgkJaWNvbnBvczogbnVsbCwKCQl0aGVtZTogbnVsbCwKCQljb250ZW50VGhlbWU6IG51bGwsCgkJaW5zZXQ6IG51bGwsCgkJY29ybmVyczogbnVsbCwKCQltaW5pOiBudWxsCgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXZhciBlbGVtID0gdGhpcy5lbGVtZW50LAoJCQl1aSA9IHsKCQkJCWFjY29yZGlvbjogZWxlbQoJCQkJCS5jbG9zZXN0KCAiOmpxbURhdGEocm9sZT0nY29sbGFwc2libGUtc2V0JykiICsKCQkJCQkJKCAkLm1vYmlsZS5jb2xsYXBzaWJsZXNldCA/ICIsIDptb2JpbGUtY29sbGFwc2libGVzZXQiIDogIiIgKSApCgkJCQkJLmFkZENsYXNzKCAidWktY29sbGFwc2libGUtc2V0IiApCgkJCX07CgoJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCV91aTogdWkKCQl9KTsKCgkJaWYgKCB0aGlzLm9wdGlvbnMuZW5oYW5jZWQgKSB7CgkJCXVpLmhlYWRpbmcgPSAkKCAiLnVpLWNvbGxhcHNpYmxlLWhlYWRpbmciLCB0aGlzLmVsZW1lbnRbIDAgXSApOwoJCQl1aS5jb250ZW50ID0gdWkuaGVhZGluZy5uZXh0KCk7CgkJCXVpLmFuY2hvciA9ICQoICJhIiwgdWkuaGVhZGluZ1sgMCBdICkuZmlyc3QoKTsKCQkJdWkuc3RhdHVzID0gdWkuYW5jaG9yLmNoaWxkcmVuKCAiLnVpLWNvbGxhcHNpYmxlLWhlYWRpbmctc3RhdHVzIiApOwoJCX0gZWxzZSB7CgkJCXRoaXMuX2VuaGFuY2UoIGVsZW0sIHVpICk7CgkJfQoKCQl0aGlzLl9vbiggdWkuaGVhZGluZywgewoJCQkidGFwIjogZnVuY3Rpb24oKSB7CgkJCQl1aS5oZWFkaW5nLmZpbmQoICJhIiApLmZpcnN0KCkuYWRkQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCX0sCgoJCQkiY2xpY2siOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQl0aGlzLl9oYW5kbGVFeHBhbmRDb2xsYXBzZSggIXVpLmhlYWRpbmcuaGFzQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZS1oZWFkaW5nLWNvbGxhcHNlZCIgKSApOwoJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCWV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOwoJCQl9CgkJfSk7Cgl9LAoKCS8vIEFkanVzdCB0aGUga2V5cyBpbnNpZGUgb3B0aW9ucyBmb3IgaW5oZXJpdGVkIHZhbHVlcwoJX2dldE9wdGlvbnM6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCXZhciBrZXksCgkJCWFjY29yZGlvbiA9IHRoaXMuX3VpLmFjY29yZGlvbiwKCQkJYWNjb3JkaW9uV2lkZ2V0ID0gdGhpcy5fdWkuYWNjb3JkaW9uV2lkZ2V0OwoKCQkvLyBDb3B5IG9wdGlvbnMKCQlvcHRpb25zID0gJC5leHRlbmQoIHt9LCBvcHRpb25zICk7CgoJCWlmICggYWNjb3JkaW9uLmxlbmd0aCAmJiAhYWNjb3JkaW9uV2lkZ2V0ICkgewoJCQl0aGlzLl91aS5hY2NvcmRpb25XaWRnZXQgPQoJCQlhY2NvcmRpb25XaWRnZXQgPSBhY2NvcmRpb24uZGF0YSggIm1vYmlsZS1jb2xsYXBzaWJsZXNldCIgKTsKCQl9CgoJCWZvciAoIGtleSBpbiBvcHRpb25zICkgewoKCQkJLy8gUmV0cmlldmUgdGhlIG9wdGlvbiB2YWx1ZSBmaXJzdCBmcm9tIHRoZSBvcHRpb25zIG9iamVjdCBwYXNzZWQgaW4gYW5kLCBpZgoJCQkvLyBudWxsLCBmcm9tIHRoZSBwYXJlbnQgYWNjb3JkaW9uIG9yLCBpZiB0aGF0J3MgbnVsbCB0b28sIG9yIGlmIHRoZXJlJ3Mgbm8KCQkJLy8gcGFyZW50IGFjY29yZGlvbiwgdGhlbiBmcm9tIHRoZSBkZWZhdWx0cy4KCQkJb3B0aW9uc1sga2V5IF0gPQoJCQkJKCBvcHRpb25zWyBrZXkgXSAhPSBudWxsICkgPyBvcHRpb25zWyBrZXkgXSA6CgkJCQkoIGFjY29yZGlvbldpZGdldCApID8gYWNjb3JkaW9uV2lkZ2V0Lm9wdGlvbnNbIGtleSBdIDoKCQkJCWFjY29yZGlvbi5sZW5ndGggPyAkLm1vYmlsZS5nZXRBdHRyaWJ1dGUoIGFjY29yZGlvblsgMCBdLAoJCQkJCWtleS5yZXBsYWNlKCBySW5pdGlhbExldHRlciwgIi0kMSIgKS50b0xvd2VyQ2FzZSgpICk6CgkJCQludWxsOwoKCQkJaWYgKCBudWxsID09IG9wdGlvbnNbIGtleSBdICkgewoJCQkJb3B0aW9uc1sga2V5IF0gPSAkLm1vYmlsZS5jb2xsYXBzaWJsZS5kZWZhdWx0c1sga2V5IF07CgkJCX0KCQl9CgoJCXJldHVybiBvcHRpb25zOwoJfSwKCglfdGhlbWVDbGFzc0Zyb21PcHRpb246IGZ1bmN0aW9uKCBwcmVmaXgsIHZhbHVlICkgewoJCXJldHVybiAoIHZhbHVlID8gKCB2YWx1ZSA9PT0gIm5vbmUiID8gIiIgOiBwcmVmaXggKyB2YWx1ZSApIDogIiIgKTsKCX0sCgoJX2VuaGFuY2U6IGZ1bmN0aW9uKCBlbGVtLCB1aSApIHsKCQl2YXIgaWNvbmNsYXNzLAoJCQlvcHRzID0gdGhpcy5fZ2V0T3B0aW9ucyggdGhpcy5vcHRpb25zICksCgkJCWNvbnRlbnRUaGVtZUNsYXNzID0gdGhpcy5fdGhlbWVDbGFzc0Zyb21PcHRpb24oICJ1aS1ib2R5LSIsIG9wdHMuY29udGVudFRoZW1lICk7CgoJCWVsZW0uYWRkQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZSAiICsKCQkJKCBvcHRzLmluc2V0ID8gInVpLWNvbGxhcHNpYmxlLWluc2V0ICIgOiAiIiApICsKCQkJKCBvcHRzLmluc2V0ICYmIG9wdHMuY29ybmVycyA/ICJ1aS1jb3JuZXItYWxsICIgOiAiIiApICsKCQkJKCBjb250ZW50VGhlbWVDbGFzcyA/ICJ1aS1jb2xsYXBzaWJsZS10aGVtZWQtY29udGVudCAiIDogIiIgKSApOwoJCXVpLm9yaWdpbmFsSGVhZGluZyA9IGVsZW0uY2hpbGRyZW4oIHRoaXMub3B0aW9ucy5oZWFkaW5nICkuZmlyc3QoKSwKCQl1aS5jb250ZW50ID0gZWxlbQoJCQkud3JhcElubmVyKCAiPGRpdiAiICsKCQkJCSJjbGFzcz0ndWktY29sbGFwc2libGUtY29udGVudCAiICsKCQkJCWNvbnRlbnRUaGVtZUNsYXNzICsgIic+PC9kaXY+IiApCgkJCS5jaGlsZHJlbiggIi51aS1jb2xsYXBzaWJsZS1jb250ZW50IiApLAoJCXVpLmhlYWRpbmcgPSB1aS5vcmlnaW5hbEhlYWRpbmc7CgoJCS8vIFJlcGxhY2UgY29sbGFwc2libGVIZWFkaW5nIGlmIGl0J3MgYSBsZWdlbmQKCQlpZiAoIHVpLmhlYWRpbmcuaXMoICJsZWdlbmQiICkgKSB7CgkJCXVpLmhlYWRpbmcgPSAkKCAiPGRpdiByb2xlPSdoZWFkaW5nJz4iKyB1aS5oZWFkaW5nLmh0bWwoKSArIjwvZGl2PiIgKTsKCQkJdWkucGxhY2Vob2xkZXIgPSAkKCAiPGRpdj48IS0tIHBsYWNlaG9sZGVyIGZvciBsZWdlbmQgLS0+PC9kaXY+IiApLmluc2VydEJlZm9yZSggdWkub3JpZ2luYWxIZWFkaW5nICk7CgkJCXVpLm9yaWdpbmFsSGVhZGluZy5yZW1vdmUoKTsKCQl9CgoJCWljb25jbGFzcyA9ICggb3B0cy5jb2xsYXBzZWQgPyAoIG9wdHMuY29sbGFwc2VkSWNvbiA/ICJ1aS1pY29uLSIgKyBvcHRzLmNvbGxhcHNlZEljb24gOiAiIiApOgoJCQkoIG9wdHMuZXhwYW5kZWRJY29uID8gInVpLWljb24tIiArIG9wdHMuZXhwYW5kZWRJY29uIDogIiIgKSApOwoKCQl1aS5zdGF0dXMgPSAkKCAiPHNwYW4gY2xhc3M9J3VpLWNvbGxhcHNpYmxlLWhlYWRpbmctc3RhdHVzJz48L3NwYW4+IiApOwoJCXVpLmFuY2hvciA9IHVpLmhlYWRpbmcKCQkJLmRldGFjaCgpCgkJCS8vbW9kaWZ5IG1hcmt1cCAmIGF0dHJpYnV0ZXMKCQkJLmFkZENsYXNzKCAidWktY29sbGFwc2libGUtaGVhZGluZyIgKQoJCQkuYXBwZW5kKCB1aS5zdGF0dXMgKQoJCQkud3JhcElubmVyKCAiPGEgaHJlZj0nIycgY2xhc3M9J3VpLWNvbGxhcHNpYmxlLWhlYWRpbmctdG9nZ2xlJz48L2E+IiApCgkJCS5maW5kKCAiYSIgKQoJCQkJLmZpcnN0KCkKCQkJCS5hZGRDbGFzcyggInVpLWJ0biAiICsKCQkJCQkoIGljb25jbGFzcyA/IGljb25jbGFzcyArICIgIiA6ICIiICkgKwoJCQkJCSggaWNvbmNsYXNzID8gKCAidWktYnRuLWljb24tIiArCgkJCQkJCSggb3B0cy5pY29ucG9zID09PSAicmlnaHQiID8gInJpZ2h0IiA6ICJsZWZ0IiApICkgKwoJCQkJCQkiICIgOiAiIiApICsKCQkJCQl0aGlzLl90aGVtZUNsYXNzRnJvbU9wdGlvbiggInVpLWJ0bi0iLCBvcHRzLnRoZW1lICkgKyAiICIgKwoJCQkJCSggb3B0cy5taW5pID8gInVpLW1pbmkgIiA6ICIiICkgKTsKCgkJLy9kcm9wIGhlYWRpbmcgaW4gYmVmb3JlIGNvbnRlbnQKCQl1aS5oZWFkaW5nLmluc2VydEJlZm9yZSggdWkuY29udGVudCApOwoKCQl0aGlzLl9oYW5kbGVFeHBhbmRDb2xsYXBzZSggdGhpcy5vcHRpb25zLmNvbGxhcHNlZCApOwoKCQlyZXR1cm4gdWk7Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCXZhciBrZXksIG9wdGlvbnMgPSB7fTsKCgkJZm9yICgga2V5IGluICQubW9iaWxlLmNvbGxhcHNpYmxlLmRlZmF1bHRzICkgewoJCQlvcHRpb25zWyBrZXkgXSA9IHRoaXMub3B0aW9uc1sga2V5IF07CgkJfQoKCQl0aGlzLl9zZXRPcHRpb25zKCBvcHRpb25zICk7Cgl9LAoKCV9zZXRPcHRpb25zOiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQl2YXIgaXNDb2xsYXBzZWQsIG5ld1RoZW1lLCBvbGRUaGVtZSwgaGFzQ29ybmVycywKCQkJZWxlbSA9IHRoaXMuZWxlbWVudCwKCQkJY3VycmVudE9wdHMgPSB0aGlzLl9nZXRPcHRpb25zKCB0aGlzLm9wdGlvbnMgKSwKCQkJdWkgPSB0aGlzLl91aSwKCQkJYW5jaG9yID0gdWkuYW5jaG9yLAoJCQlzdGF0dXMgPSB1aS5zdGF0dXMsCgkJCW9wdHMgPSB0aGlzLl9nZXRPcHRpb25zKCBvcHRpb25zICk7CgoJCS8vIEZpcnN0IGFuZCBmb3JlbW9zdCB3ZSBuZWVkIHRvIG1ha2Ugc3VyZSB0aGUgY29sbGFwc2libGUgaXMgaW4gdGhlIHByb3BlcgoJCS8vIHN0YXRlLCBpbiBjYXNlIHNvbWVib2R5IGRlY2lkZWQgdG8gY2hhbmdlIHRoZSBjb2xsYXBzZWQgb3B0aW9uIGF0IHRoZQoJCS8vIHNhbWUgdGltZSBhcyBhbm90aGVyIG9wdGlvbgoJCWlmICggb3B0aW9ucy5jb2xsYXBzZWQgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhpcy5faGFuZGxlRXhwYW5kQ29sbGFwc2UoIG9wdGlvbnMuY29sbGFwc2VkICk7CgkJfQoKCQlpc0NvbGxhcHNlZCA9IGVsZW0uaGFzQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZS1jb2xsYXBzZWQiICk7CgoJCS8vIE9ubHkgb3B0aW9ucyByZWZlcnJpbmcgdG8gdGhlIGN1cnJlbnQgc3RhdGUgbmVlZCB0byBiZSBhcHBsaWVkIHJpZ2h0IGF3YXkKCQkvLyBJdCBpcyBlbm91Z2ggdG8gc3RvcmUgb3B0aW9ucyBjb3ZlcmluZyB0aGUgYWx0ZXJuYXRlIGluIHRoaXMub3B0aW9ucy4KCQlpZiAoIGlzQ29sbGFwc2VkICkgewoJCQlpZiAoIG9wdHMuZXhwYW5kQ3VlVGV4dCAhPT0gdW5kZWZpbmVkICkgewoJCQkJc3RhdHVzLnRleHQoIG9wdHMuZXhwYW5kQ3VlVGV4dCApOwoJCQl9CgkJCWlmICggb3B0cy5jb2xsYXBzZWRJY29uICE9PSB1bmRlZmluZWQgKSB7CgkJCQlpZiAoIGN1cnJlbnRPcHRzLmNvbGxhcHNlZEljb24gKSB7CgkJCQkJYW5jaG9yLnJlbW92ZUNsYXNzKCAidWktaWNvbi0iICsgY3VycmVudE9wdHMuY29sbGFwc2VkSWNvbiApOwoJCQkJfQoJCQkJaWYgKCBvcHRzLmNvbGxhcHNlZEljb24gKSB7CgkJCQkJYW5jaG9yLmFkZENsYXNzKCAidWktaWNvbi0iICsgb3B0cy5jb2xsYXBzZWRJY29uICk7CgkJCQl9CgkJCX0KCQl9IGVsc2UgewoJCQlpZiAoIG9wdHMuY29sbGFwc2VDdWVUZXh0ICE9PSB1bmRlZmluZWQgKSB7CgkJCQlzdGF0dXMudGV4dCggb3B0cy5jb2xsYXBzZUN1ZVRleHQgKTsKCQkJfQoJCQlpZiAoIG9wdHMuZXhwYW5kZWRJY29uICE9PSB1bmRlZmluZWQgKSB7CgkJCQlpZiAoIGN1cnJlbnRPcHRzLmV4cGFuZGVkSWNvbiApIHsKCQkJCQlhbmNob3IucmVtb3ZlQ2xhc3MoICJ1aS1pY29uLSIgKyBjdXJyZW50T3B0cy5leHBhbmRlZEljb24gKTsKCQkJCX0KCQkJCWlmICggb3B0cy5leHBhbmRlZEljb24gKSB7CgkJCQkJYW5jaG9yLmFkZENsYXNzKCAidWktaWNvbi0iICsgb3B0cy5leHBhbmRlZEljb24gKTsKCQkJCX0KCQkJfQoJCX0KCgkJaWYgKCBvcHRzLmljb25wb3MgIT09IHVuZGVmaW5lZCApIHsKCQkJYW5jaG9yLnJlbW92ZUNsYXNzKCAidWktYnRuLWljb24tIiArICggY3VycmVudE9wdHMuaWNvblBvcyA9PT0gInJpZ2h0IiA/ICJyaWdodCIgOiAibGVmdCIgKSApOwoJCQlhbmNob3IuYWRkQ2xhc3MoICJ1aS1idG4taWNvbi0iICsgKCBvcHRzLmljb25Qb3MgPT09ICJyaWdodCIgPyAicmlnaHQiIDogImxlZnQiICkgKTsKCQl9CgoJCWlmICggb3B0cy50aGVtZSAhPT0gdW5kZWZpbmVkICkgewoJCQlvbGRUaGVtZSA9IHRoaXMuX3RoZW1lQ2xhc3NGcm9tT3B0aW9uKCAidWktYnRuLSIsIGN1cnJlbnRPcHRzLnRoZW1lICk7CgkJCW5ld1RoZW1lID0gdGhpcy5fdGhlbWVDbGFzc0Zyb21PcHRpb24oICJ1aS1idG4tIiwgb3B0cy50aGVtZSApOwoJCQlhbmNob3IucmVtb3ZlQ2xhc3MoIG9sZFRoZW1lICkuYWRkQ2xhc3MoIG5ld1RoZW1lICk7CgkJfQoKCQlpZiAoIG9wdHMuY29udGVudFRoZW1lICE9PSB1bmRlZmluZWQgKSB7CgkJCW9sZFRoZW1lID0gdGhpcy5fdGhlbWVDbGFzc0Zyb21PcHRpb24oICJ1aS1ib2R5LSIsIGN1cnJlbnRPcHRzLnRoZW1lICk7CgkJCW5ld1RoZW1lID0gdGhpcy5fdGhlbWVDbGFzc0Zyb21PcHRpb24oICJ1aS1ib2R5LSIsIG9wdHMudGhlbWUgKTsKCQkJdWkuY29udGVudC5yZW1vdmVDbGFzcyggb2xkVGhlbWUgKS5hZGRDbGFzcyggbmV3VGhlbWUgKTsKCQl9CgoJCWlmICggb3B0cy5pbnNldCAhPT0gdW5kZWZpbmVkICkgewoJCQllbGVtLnRvZ2dsZUNsYXNzKCAidWktY29sbGFwc2libGUtaW5zZXQiLCBvcHRzLmluc2V0ICk7CgkJCWhhc0Nvcm5lcnMgPSAhISggb3B0cy5pbnNldCAmJiAoIG9wdHMuY29ybmVycyB8fCBjdXJyZW50T3B0cy5jb3JuZXJzICkgKTsKCQl9CgoJCWlmICggb3B0cy5jb3JuZXJzICE9PSB1bmRlZmluZWQgKSB7CgkJCWhhc0Nvcm5lcnMgPSAhISggb3B0cy5jb3JuZXJzICYmICggb3B0cy5pbnNldCB8fCBjdXJyZW50T3B0cy5pbnNldCApICk7CgkJfQoKCQlpZiAoIGhhc0Nvcm5lcnMgIT09IHVuZGVmaW5lZCApIHsKCQkJZWxlbS50b2dnbGVDbGFzcyggInVpLWNvcm5lci1hbGwiLCBoYXNDb3JuZXJzICk7CgkJfQoKCQlpZiAoIG9wdHMubWluaSAhPT0gdW5kZWZpbmVkICkgewoJCQlhbmNob3IudG9nZ2xlQ2xhc3MoICJ1aS1taW5pIiwgb3B0cy5taW5pICk7CgkJfQoKCQl0aGlzLl9zdXBlciggb3B0aW9ucyApOwoJfSwKCglfaGFuZGxlRXhwYW5kQ29sbGFwc2U6IGZ1bmN0aW9uKCBpc0NvbGxhcHNlICkgewoJCXZhciBvcHRzID0gdGhpcy5fZ2V0T3B0aW9ucyggdGhpcy5vcHRpb25zICksCgkJCXVpID0gdGhpcy5fdWk7CgoJCXVpLnN0YXR1cy50ZXh0KCBpc0NvbGxhcHNlID8gb3B0cy5leHBhbmRDdWVUZXh0IDogb3B0cy5jb2xsYXBzZUN1ZVRleHQgKTsKCQl1aS5oZWFkaW5nCgkJCS50b2dnbGVDbGFzcyggInVpLWNvbGxhcHNpYmxlLWhlYWRpbmctY29sbGFwc2VkIiwgaXNDb2xsYXBzZSApCgkJCS5maW5kKCAiYSIgKS5maXJzdCgpCgkJCS50b2dnbGVDbGFzcyggInVpLWljb24tIiArIG9wdHMuZXhwYW5kZWRJY29uLCAhaXNDb2xsYXBzZSApCgoJCQkvLyBsb2dpYyBvciBjYXVzZSBzYW1lIGljb24gZm9yIGV4cGFuZGVkL2NvbGxhcHNlZCBzdGF0ZSB3b3VsZCByZW1vdmUgdGhlIHVpLWljb24tY2xhc3MKCQkJLnRvZ2dsZUNsYXNzKCAidWktaWNvbi0iICsgb3B0cy5jb2xsYXBzZWRJY29uLCAoIGlzQ29sbGFwc2UgfHwgb3B0cy5leHBhbmRlZEljb24gPT09IG9wdHMuY29sbGFwc2VkSWNvbiApICkKCQkJLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoKCQl0aGlzLmVsZW1lbnQudG9nZ2xlQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZS1jb2xsYXBzZWQiLCBpc0NvbGxhcHNlICk7CgkJdWkuY29udGVudAoJCQkudG9nZ2xlQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZS1jb250ZW50LWNvbGxhcHNlZCIsIGlzQ29sbGFwc2UgKQoJCQkuYXR0ciggImFyaWEtaGlkZGVuIiwgaXNDb2xsYXBzZSApCgkJCS50cmlnZ2VyKCAidXBkYXRlbGF5b3V0IiApOwoJCXRoaXMub3B0aW9ucy5jb2xsYXBzZWQgPSBpc0NvbGxhcHNlOwoJCXRoaXMuX3RyaWdnZXIoIGlzQ29sbGFwc2UgPyAiY29sbGFwc2UiIDogImV4cGFuZCIgKTsKCX0sCgoJZXhwYW5kOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9oYW5kbGVFeHBhbmRDb2xsYXBzZSggZmFsc2UgKTsKCX0sCgoJY29sbGFwc2U6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX2hhbmRsZUV4cGFuZENvbGxhcHNlKCB0cnVlICk7Cgl9LAoKCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCQl2YXIgdWkgPSB0aGlzLl91aSwKCQkJb3B0cyA9IHRoaXMub3B0aW9uczsKCgkJaWYgKCBvcHRzLmVuaGFuY2VkICkgewoJCQlyZXR1cm47CgkJfQoKCQlpZiAoIHVpLnBsYWNlaG9sZGVyICkgewoJCQl1aS5vcmlnaW5hbEhlYWRpbmcuaW5zZXJ0QmVmb3JlKCB1aS5wbGFjZWhvbGRlciApOwoJCQl1aS5wbGFjZWhvbGRlci5yZW1vdmUoKTsKCQkJdWkuaGVhZGluZy5yZW1vdmUoKTsKCQl9IGVsc2UgewoJCQl1aS5zdGF0dXMucmVtb3ZlKCk7CgkJCXVpLmhlYWRpbmcKCQkJCS5yZW1vdmVDbGFzcyggInVpLWNvbGxhcHNpYmxlLWhlYWRpbmcgdWktY29sbGFwc2libGUtaGVhZGluZy1jb2xsYXBzZWQiICkKCQkJCS5jaGlsZHJlbigpCgkJCQkJLmNvbnRlbnRzKCkKCQkJCQkJLnVud3JhcCgpOwoJCX0KCgkJdWkuYW5jaG9yLmNvbnRlbnRzKCkudW53cmFwKCk7CgkJdWkuY29udGVudC5jb250ZW50cygpLnVud3JhcCgpOwoJCXRoaXMuZWxlbWVudAoJCQkucmVtb3ZlQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZSB1aS1jb2xsYXBzaWJsZS1jb2xsYXBzZWQgIiArCgkJCQkidWktY29sbGFwc2libGUtdGhlbWVkLWNvbnRlbnQgdWktY29sbGFwc2libGUtaW5zZXQgdWktY29ybmVyLWFsbCIgKTsKCX0KfSk7CgovLyBEZWZhdWx0cyB0byBiZSB1c2VkIGJ5IGFsbCBpbnN0YW5jZXMgb2YgY29sbGFwc2libGUgaWYgcGVyLWluc3RhbmNlIHZhbHVlcwovLyBhcmUgdW5zZXQgb3IgaWYgbm90aGluZyBpcyBzcGVjaWZpZWQgYnkgd2F5IG9mIGluaGVyaXRhbmNlIGZyb20gYW4gYWNjb3JkaW9uLgovLyBOb3RlIHRoYXQgdGhpcyBoYXNoIGRvZXMgbm90IGNvbnRhaW4gb3B0aW9ucyAiY29sbGFwc2VkIiBvciAiaGVhZGluZyIsCi8vIGJlY2F1c2UgdGhvc2UgYXJlIG5vdCBpbmhlcml0YWJsZS4KJC5tb2JpbGUuY29sbGFwc2libGUuZGVmYXVsdHMgPSB7CglleHBhbmRDdWVUZXh0OiAiIGNsaWNrIHRvIGV4cGFuZCBjb250ZW50cyIsCgljb2xsYXBzZUN1ZVRleHQ6ICIgY2xpY2sgdG8gY29sbGFwc2UgY29udGVudHMiLAoJY29sbGFwc2VkSWNvbjogInBsdXMiLAoJY29udGVudFRoZW1lOiAiaW5oZXJpdCIsCglleHBhbmRlZEljb246ICJtaW51cyIsCglpY29ucG9zOiAibGVmdCIsCglpbnNldDogdHJ1ZSwKCWNvcm5lcnM6IHRydWUsCgltaW5pOiBmYWxzZQp9OwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS5iZWhhdmlvcnMuYWRkRmlyc3RMYXN0Q2xhc3NlcyA9IHsKCV9nZXRWaXNpYmxlczogZnVuY3Rpb24oICRlbHMsIGNyZWF0ZSApIHsKCQl2YXIgdmlzaWJsZXM7CgoJCWlmICggY3JlYXRlICkgewoJCQl2aXNpYmxlcyA9ICRlbHMubm90KCAiLnVpLXNjcmVlbi1oaWRkZW4iICk7CgkJfSBlbHNlIHsKCQkJdmlzaWJsZXMgPSAkZWxzLmZpbHRlciggIjp2aXNpYmxlIiApOwoJCQlpZiAoIHZpc2libGVzLmxlbmd0aCA9PT0gMCApIHsKCQkJCXZpc2libGVzID0gJGVscy5ub3QoICIudWktc2NyZWVuLWhpZGRlbiIgKTsKCQkJfQoJCX0KCgkJcmV0dXJuIHZpc2libGVzOwoJfSwKCglfYWRkRmlyc3RMYXN0Q2xhc3NlczogZnVuY3Rpb24oICRlbHMsICR2aXNpYmxlcywgY3JlYXRlICkgewoJCSRlbHMucmVtb3ZlQ2xhc3MoICJ1aS1maXJzdC1jaGlsZCB1aS1sYXN0LWNoaWxkIiApOwoJCSR2aXNpYmxlcy5lcSggMCApLmFkZENsYXNzKCAidWktZmlyc3QtY2hpbGQiICkuZW5kKCkubGFzdCgpLmFkZENsYXNzKCAidWktbGFzdC1jaGlsZCIgKTsKCQlpZiAoICFjcmVhdGUgKSB7CgkJCXRoaXMuZWxlbWVudC50cmlnZ2VyKCAidXBkYXRlbGF5b3V0IiApOwoJCX0KCX0sCgoJX3JlbW92ZUZpcnN0TGFzdENsYXNzZXM6IGZ1bmN0aW9uKCAkZWxzICkgewoJCSRlbHMucmVtb3ZlQ2xhc3MoICJ1aS1maXJzdC1jaGlsZCB1aS1sYXN0LWNoaWxkIiApOwoJfQp9OwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7Cgp2YXIgY2hpbGRDb2xsYXBzaWJsZXNTZWxlY3RvciA9ICI6bW9iaWxlLWNvbGxhcHNpYmxlLCAiICsgJC5tb2JpbGUuY29sbGFwc2libGUuaW5pdFNlbGVjdG9yOwoKJC53aWRnZXQoICJtb2JpbGUuY29sbGFwc2libGVzZXQiLCAkLmV4dGVuZCggewoKCS8vIFRoZSBpbml0U2VsZWN0b3IgaXMgZGVwcmVjYXRlZCBhcyBvZiAxLjQuMC4gSW4gMS41LjAgd2Ugd2lsbCB1c2UKCS8vIDpqcW1EYXRhKHJvbGU9J2NvbGxhcHNpYmxlc2V0Jykgd2hpY2ggd2lsbCBhbGxvdyB1cyB0byBnZXQgcmlkIG9mIHRoZSBsaW5lCgkvLyBiZWxvdyBhbHRvZ2V0aGVyLCBiZWNhdXNlIHRoZSBhdXRvaW5pdCB3aWxsIGdlbmVyYXRlIHN1Y2ggYW4gaW5pdFNlbGVjdG9yCglpbml0U2VsZWN0b3I6ICI6anFtRGF0YShyb2xlPSdjb2xsYXBzaWJsZS1zZXQnKSw6anFtRGF0YShyb2xlPSdjb2xsYXBzaWJsZXNldCcpIiwKCglvcHRpb25zOiAkLmV4dGVuZCggewoJCWVuaGFuY2VkOiBmYWxzZSwKCX0sICQubW9iaWxlLmNvbGxhcHNpYmxlLmRlZmF1bHRzICksCgoJX2hhbmRsZUNvbGxhcHNpYmxlRXhwYW5kOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJdmFyIGNsb3Nlc3RDb2xsYXBzaWJsZSA9ICQoIGV2ZW50LnRhcmdldCApLmNsb3Nlc3QoICIudWktY29sbGFwc2libGUiICk7CgoJCWlmICggY2xvc2VzdENvbGxhcHNpYmxlLnBhcmVudCgpLmlzKCAiOm1vYmlsZS1jb2xsYXBzaWJsZXNldCwgOmpxbURhdGEocm9sZT0nY29sbGFwc2libGUtc2V0JykiICkgKSB7CgkJCWNsb3Nlc3RDb2xsYXBzaWJsZQoJCQkJLnNpYmxpbmdzKCAiLnVpLWNvbGxhcHNpYmxlOm5vdCgudWktY29sbGFwc2libGUtY29sbGFwc2VkKSIgKQoJCQkJLmNvbGxhcHNpYmxlKCAiY29sbGFwc2UiICk7CgkJfQoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl2YXIgZWxlbSA9IHRoaXMuZWxlbWVudCwKCQkJb3B0cyA9IHRoaXMub3B0aW9uczsKCgkJJC5leHRlbmQoIHRoaXMsIHsKCQkJX2NsYXNzZXM6ICIiCgkJfSk7CgoJCWlmICggIW9wdHMuZW5oYW5jZWQgKSB7CgkJCWVsZW0uYWRkQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZS1zZXQgIiArCgkJCQl0aGlzLl90aGVtZUNsYXNzRnJvbU9wdGlvbiggInVpLWdyb3VwLXRoZW1lLSIsIG9wdHMudGhlbWUgKSArICIgIiArCgkJCQkoIG9wdHMuY29ybmVycyAmJiBvcHRzLmluc2V0ID8gInVpLWNvcm5lci1hbGwgIiA6ICIiICkgKTsKCQkJdGhpcy5lbGVtZW50LmZpbmQoICQubW9iaWxlLmNvbGxhcHNpYmxlLmluaXRTZWxlY3RvciApLmNvbGxhcHNpYmxlKCk7CgkJfQoKCQl0aGlzLl9vbiggZWxlbSwgeyBjb2xsYXBzaWJsZWV4cGFuZDogIl9oYW5kbGVDb2xsYXBzaWJsZUV4cGFuZCIgfSApOwoJfSwKCglfdGhlbWVDbGFzc0Zyb21PcHRpb246IGZ1bmN0aW9uKCBwcmVmaXgsIHZhbHVlICkgewoJCXJldHVybiAoIHZhbHVlID8gKCB2YWx1ZSA9PT0gIm5vbmUiID8gIiIgOiBwcmVmaXggKyB2YWx1ZSApIDogIiIgKTsKCX0sCgoJX2luaXQ6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3JlZnJlc2goIHRydWUgKTsKCgkJLy8gQmVjYXVzZSB0aGUgY29ybmVycyBhcmUgaGFuZGxlZCBieSB0aGUgY29sbGFwc2libGUgaXRzZWxmIGFuZCB0aGUgZGVmYXVsdCBzdGF0ZSBpcyBjb2xsYXBzZWQKCQkvLyBUaGF0IHdhcyBjYXVzaW5nIGh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5LW1vYmlsZS9pc3N1ZXMvNDExNgoJCXRoaXMuZWxlbWVudAoJCQkuY2hpbGRyZW4oIGNoaWxkQ29sbGFwc2libGVzU2VsZWN0b3IgKQoJCQkuZmlsdGVyKCAiOmpxbURhdGEoY29sbGFwc2VkPSdmYWxzZScpIiApCgkJCS5jb2xsYXBzaWJsZSggImV4cGFuZCIgKTsKCX0sCgoJX3NldE9wdGlvbnM6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCXZhciByZXQsIGhhc0Nvcm5lcnMsCgkJCWVsZW0gPSB0aGlzLmVsZW1lbnQsCgkJCXRoZW1lQ2xhc3MgPSB0aGlzLl90aGVtZUNsYXNzRnJvbU9wdGlvbiggInVpLWdyb3VwLXRoZW1lLSIsIG9wdGlvbnMudGhlbWUgKTsKCgkJaWYgKCB0aGVtZUNsYXNzICkgewoJCQllbGVtCgkJCQkucmVtb3ZlQ2xhc3MoIHRoaXMuX3RoZW1lQ2xhc3NGcm9tT3B0aW9uKCAidWktZ3JvdXAtdGhlbWUtIiwgdGhpcy5vcHRpb25zLnRoZW1lICkgKQoJCQkJLmFkZENsYXNzKCB0aGVtZUNsYXNzICk7CgkJfQoKCQlpZiAoIG9wdGlvbnMuaW5zZXQgIT09IHVuZGVmaW5lZCApIHsKCQkJaGFzQ29ybmVycyA9ICEhKCBvcHRpb25zLmluc2V0ICYmICggb3B0aW9ucy5jb3JuZXJzIHx8IHRoaXMub3B0aW9ucy5jb3JuZXJzICkgKTsKCQl9CgoJCWlmICggb3B0aW9ucy5jb3JuZXJzICE9PSB1bmRlZmluZWQgKSB7CgkJCWhhc0Nvcm5lcnMgPSAhISggb3B0aW9ucy5jb3JuZXJzICYmICggb3B0aW9ucy5pbnNldCB8fCB0aGlzLm9wdGlvbnMuaW5zZXQgKSApOwoJCX0KCgkJaWYgKCBoYXNDb3JuZXJzICE9PSB1bmRlZmluZWQgKSB7CgkJCWVsZW0udG9nZ2xlQ2xhc3MoICJ1aS1jb3JuZXItYWxsIiwgaGFzQ29ybmVycyApOwoJCX0KCgkJcmV0ID0gdGhpcy5fc3VwZXIoIG9wdGlvbnMgKTsKCQl0aGlzLmVsZW1lbnQuY2hpbGRyZW4oICI6bW9iaWxlLWNvbGxhcHNpYmxlIiApLmNvbGxhcHNpYmxlKCAicmVmcmVzaCIgKTsKCQlyZXR1cm4gcmV0OwoJfSwKCglfZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJdmFyIGVsID0gdGhpcy5lbGVtZW50OwoKCQl0aGlzLl9yZW1vdmVGaXJzdExhc3RDbGFzc2VzKCBlbC5jaGlsZHJlbiggY2hpbGRDb2xsYXBzaWJsZXNTZWxlY3RvciApICk7CgkJZWwKCQkJLnJlbW92ZUNsYXNzKCAidWktY29sbGFwc2libGUtc2V0IHVpLWNvcm5lci1hbGwgIiArCgkJCQl0aGlzLl90aGVtZUNsYXNzRnJvbU9wdGlvbiggInVpLWdyb3VwLXRoZW1lIiwgdGhpcy5vcHRpb25zLnRoZW1lICkgKQoJCQkuY2hpbGRyZW4oICI6bW9iaWxlLWNvbGxhcHNpYmxlIiApCgkJCS5jb2xsYXBzaWJsZSggImRlc3Ryb3kiICk7Cgl9LAoKCV9yZWZyZXNoOiBmdW5jdGlvbiggY3JlYXRlICkgewoJCXZhciBjb2xsYXBzaWJsZXNJblNldCA9IHRoaXMuZWxlbWVudC5jaGlsZHJlbiggY2hpbGRDb2xsYXBzaWJsZXNTZWxlY3RvciApOwoKCQl0aGlzLmVsZW1lbnQuZmluZCggJC5tb2JpbGUuY29sbGFwc2libGUuaW5pdFNlbGVjdG9yICkubm90KCAiLnVpLWNvbGxhcHNpYmxlIiApLmNvbGxhcHNpYmxlKCk7CgoJCXRoaXMuX2FkZEZpcnN0TGFzdENsYXNzZXMoIGNvbGxhcHNpYmxlc0luU2V0LCB0aGlzLl9nZXRWaXNpYmxlcyggY29sbGFwc2libGVzSW5TZXQsIGNyZWF0ZSApLCBjcmVhdGUgKTsKCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJdGhpcy5fcmVmcmVzaCggZmFsc2UgKTsKCX0KfSwgJC5tb2JpbGUuYmVoYXZpb3JzLmFkZEZpcnN0TGFzdENsYXNzZXMgKSApOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgovLyBEZXByZWNhdGVkIGluIDEuNAokLmZuLmZpZWxkY29udGFpbiA9IGZ1bmN0aW9uKC8qIG9wdGlvbnMgKi8pIHsKCXJldHVybiB0aGlzLmFkZENsYXNzKCAidWktZmllbGQtY29udGFpbiIgKTsKfTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC5mbi5ncmlkID0gZnVuY3Rpb24oIG9wdGlvbnMgKSB7CglyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoKCQl2YXIgJHRoaXMgPSAkKCB0aGlzICksCgkJCW8gPSAkLmV4dGVuZCh7CgkJCQlncmlkOiBudWxsCgkJCX0sIG9wdGlvbnMgKSwKCQkJJGtpZHMgPSAkdGhpcy5jaGlsZHJlbigpLAoJCQlncmlkQ29scyA9IHsgc29sbzoxLCBhOjIsIGI6MywgYzo0LCBkOjUgfSwKCQkJZ3JpZCA9IG8uZ3JpZCwKCQkJaXRlcmF0b3IsCgkJCWxldHRlcjsKCgkJCWlmICggIWdyaWQgKSB7CgkJCQlpZiAoICRraWRzLmxlbmd0aCA8PSA1ICkgewoJCQkJCWZvciAoIGxldHRlciBpbiBncmlkQ29scyApIHsKCQkJCQkJaWYgKCBncmlkQ29sc1sgbGV0dGVyIF0gPT09ICRraWRzLmxlbmd0aCApIHsKCQkJCQkJCWdyaWQgPSBsZXR0ZXI7CgkJCQkJCX0KCQkJCQl9CgkJCQl9IGVsc2UgewoJCQkJCWdyaWQgPSAiYSI7CgkJCQkJJHRoaXMuYWRkQ2xhc3MoICJ1aS1ncmlkLWR1byIgKTsKCQkJCX0KCQkJfQoJCQlpdGVyYXRvciA9IGdyaWRDb2xzW2dyaWRdOwoKCQkkdGhpcy5hZGRDbGFzcyggInVpLWdyaWQtIiArIGdyaWQgKTsKCgkJJGtpZHMuZmlsdGVyKCAiOm50aC1jaGlsZCgiICsgaXRlcmF0b3IgKyAibisxKSIgKS5hZGRDbGFzcyggInVpLWJsb2NrLWEiICk7CgoJCWlmICggaXRlcmF0b3IgPiAxICkgewoJCQkka2lkcy5maWx0ZXIoICI6bnRoLWNoaWxkKCIgKyBpdGVyYXRvciArICJuKzIpIiApLmFkZENsYXNzKCAidWktYmxvY2stYiIgKTsKCQl9CgkJaWYgKCBpdGVyYXRvciA+IDIgKSB7CgkJCSRraWRzLmZpbHRlciggIjpudGgtY2hpbGQoIiArIGl0ZXJhdG9yICsgIm4rMykiICkuYWRkQ2xhc3MoICJ1aS1ibG9jay1jIiApOwoJCX0KCQlpZiAoIGl0ZXJhdG9yID4gMyApIHsKCQkJJGtpZHMuZmlsdGVyKCAiOm50aC1jaGlsZCgiICsgaXRlcmF0b3IgKyAibis0KSIgKS5hZGRDbGFzcyggInVpLWJsb2NrLWQiICk7CgkJfQoJCWlmICggaXRlcmF0b3IgPiA0ICkgewoJCQkka2lkcy5maWx0ZXIoICI6bnRoLWNoaWxkKCIgKyBpdGVyYXRvciArICJuKzUpIiApLmFkZENsYXNzKCAidWktYmxvY2stZSIgKTsKCQl9Cgl9KTsKfTsKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS5uYXZiYXIiLCB7CglvcHRpb25zOiB7CgkJaWNvbnBvczogInRvcCIsCgkJZ3JpZDogbnVsbAoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCgkJdmFyICRuYXZiYXIgPSB0aGlzLmVsZW1lbnQsCgkJCSRuYXZidG5zID0gJG5hdmJhci5maW5kKCAiYSIgKSwKCQkJaWNvbnBvcyA9ICRuYXZidG5zLmZpbHRlciggIjpqcW1EYXRhKGljb24pIiApLmxlbmd0aCA/IHRoaXMub3B0aW9ucy5pY29ucG9zIDogdW5kZWZpbmVkOwoKCQkkbmF2YmFyLmFkZENsYXNzKCAidWktbmF2YmFyIiApCgkJCS5hdHRyKCAicm9sZSIsICJuYXZpZ2F0aW9uIiApCgkJCS5maW5kKCAidWwiICkKCQkJLmpxbUVuaGFuY2VhYmxlKCkKCQkJLmdyaWQoeyBncmlkOiB0aGlzLm9wdGlvbnMuZ3JpZCB9KTsKCgkJJG5hdmJ0bnMKCQkJLmVhY2goIGZ1bmN0aW9uKCkgewoJCQkJdmFyIGljb24gPSAkLm1vYmlsZS5nZXRBdHRyaWJ1dGUoIHRoaXMsICJpY29uIiApLAoJCQkJCXRoZW1lID0gJC5tb2JpbGUuZ2V0QXR0cmlidXRlKCB0aGlzLCAidGhlbWUiICksCgkJCQkJY2xhc3NlcyA9ICJ1aS1idG4iOwoKCQkJCWlmICggdGhlbWUgKSB7CgkJCQkJY2xhc3NlcyArPSAiIHVpLWJ0bi0iICsgdGhlbWU7CgkJCQl9CgkJCQlpZiAoIGljb24gKSB7CgkJCQkJY2xhc3NlcyArPSAiIHVpLWljb24tIiArIGljb24gKyAiIHVpLWJ0bi1pY29uLSIgKyBpY29ucG9zOwoJCQkJfQoJCQkJJCggdGhpcyApLmFkZENsYXNzKCBjbGFzc2VzICk7CgkJCX0pOwoKCQkkbmF2YmFyLmRlbGVnYXRlKCAiYSIsICJ2Y2xpY2siLCBmdW5jdGlvbiggLyogZXZlbnQgKi8gKSB7CgkJCXZhciBhY3RpdmVCdG4gPSAkKCB0aGlzICk7CgoJCQlpZiAoICEoIGFjdGl2ZUJ0bi5oYXNDbGFzcyggInVpLXN0YXRlLWRpc2FibGVkIiApIHx8CgoJCQkJLy8gREVQUkVDQVRFRCBhcyBvZiAxLjQuMCAtIHJlbW92ZSBhZnRlciAxLjQuMCByZWxlYXNlCgkJCQkvLyBvbmx5IHVpLXN0YXRlLWRpc2FibGVkIHNob3VsZCBiZSBwcmVzZW50IHRoZXJlYWZ0ZXIKCQkJCWFjdGl2ZUJ0bi5oYXNDbGFzcyggInVpLWRpc2FibGVkIiApIHx8CgkJCQlhY3RpdmVCdG4uaGFzQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICkgKSApIHsKCgkJCQkkbmF2YnRucy5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJCWFjdGl2ZUJ0bi5hZGRDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCgkJCQkvLyBUaGUgY29kZSBiZWxvdyBpcyBhIHdvcmthcm91bmQgdG8gZml4ICMxMTgxCgkJCQkkKCBkb2N1bWVudCApLm9uZSggInBhZ2VoaWRlIiwgZnVuY3Rpb24oKSB7CgkJCQkJYWN0aXZlQnRuLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQkJfSk7CgkJCX0KCQl9KTsKCgkJLy8gQnV0dG9ucyBpbiB0aGUgbmF2YmFyIHdpdGggdWktc3RhdGUtcGVyc2lzdCBjbGFzcyBzaG91bGQgcmVnYWluIHRoZWlyIGFjdGl2ZSBzdGF0ZSBiZWZvcmUgcGFnZSBzaG93CgkJJG5hdmJhci5jbG9zZXN0KCAiLnVpLXBhZ2UiICkuYmluZCggInBhZ2ViZWZvcmVzaG93IiwgZnVuY3Rpb24oKSB7CgkJCSRuYXZidG5zLmZpbHRlciggIi51aS1zdGF0ZS1wZXJzaXN0IiApLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCX0pOwoJfQp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKdmFyIGdldEF0dHIgPSAkLm1vYmlsZS5nZXRBdHRyaWJ1dGU7CgokLndpZGdldCggIm1vYmlsZS5saXN0dmlldyIsICQuZXh0ZW5kKCB7CgoJb3B0aW9uczogewoJCXRoZW1lOiBudWxsLAoJCWNvdW50VGhlbWU6IG51bGwsIC8qIERlcHJlY2F0ZWQgaW4gMS40ICovCgkJZGl2aWRlclRoZW1lOiBudWxsLAoJCWljb246ICJjYXJhdC1yIiwKCQlzcGxpdEljb246ICJjYXJhdC1yIiwKCQlzcGxpdFRoZW1lOiBudWxsLAoJCWNvcm5lcnM6IHRydWUsCgkJc2hhZG93OiB0cnVlLAoJCWluc2V0OiBmYWxzZQoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl2YXIgdCA9IHRoaXMsCgkJCWxpc3R2aWV3Q2xhc3NlcyA9ICIiOwoKCQlsaXN0dmlld0NsYXNzZXMgKz0gdC5vcHRpb25zLmluc2V0ID8gIiB1aS1saXN0dmlldy1pbnNldCIgOiAiIjsKCgkJaWYgKCAhIXQub3B0aW9ucy5pbnNldCApIHsKCQkJbGlzdHZpZXdDbGFzc2VzICs9IHQub3B0aW9ucy5jb3JuZXJzID8gIiB1aS1jb3JuZXItYWxsIiA6ICIiOwoJCQlsaXN0dmlld0NsYXNzZXMgKz0gdC5vcHRpb25zLnNoYWRvdyA/ICIgdWktc2hhZG93IiA6ICIiOwoJCX0KCgkJLy8gY3JlYXRlIGxpc3R2aWV3IG1hcmt1cAoJCXQuZWxlbWVudC5hZGRDbGFzcyggIiB1aS1saXN0dmlldyIgKyBsaXN0dmlld0NsYXNzZXMgKTsKCgkJdC5yZWZyZXNoKCB0cnVlICk7Cgl9LAoKCS8vIFRPRE86IFJlbW92ZSBpbiAxLjUKCV9maW5kRmlyc3RFbGVtZW50QnlUYWdOYW1lOiBmdW5jdGlvbiggZWxlLCBuZXh0UHJvcCwgbGNOYW1lLCB1Y05hbWUgKSB7CgkJdmFyIGRpY3QgPSB7fTsKCQlkaWN0WyBsY05hbWUgXSA9IGRpY3RbIHVjTmFtZSBdID0gdHJ1ZTsKCQl3aGlsZSAoIGVsZSApIHsKCQkJaWYgKCBkaWN0WyBlbGUubm9kZU5hbWUgXSApIHsKCQkJCXJldHVybiBlbGU7CgkJCX0KCQkJZWxlID0gZWxlWyBuZXh0UHJvcCBdOwoJCX0KCQlyZXR1cm4gbnVsbDsKCX0sCgkvLyBUT0RPOiBSZW1vdmUgaW4gMS41CglfYWRkVGh1bWJDbGFzc2VzOiBmdW5jdGlvbiggY29udGFpbmVycyApIHsKCQl2YXIgaSwgaW1nLCBsZW4gPSBjb250YWluZXJzLmxlbmd0aDsKCQlmb3IgKCBpID0gMDsgaSA8IGxlbjsgaSsrICkgewoJCQlpbWcgPSAkKCB0aGlzLl9maW5kRmlyc3RFbGVtZW50QnlUYWdOYW1lKCBjb250YWluZXJzWyBpIF0uZmlyc3RDaGlsZCwgIm5leHRTaWJsaW5nIiwgImltZyIsICJJTUciICkgKTsKCQkJaWYgKCBpbWcubGVuZ3RoICkgewoJCQkJJCggdGhpcy5fZmluZEZpcnN0RWxlbWVudEJ5VGFnTmFtZSggaW1nWyAwIF0ucGFyZW50Tm9kZSwgInBhcmVudE5vZGUiLCAibGkiLCAiTEkiICkgKS5hZGRDbGFzcyggaW1nLmhhc0NsYXNzKCAidWktbGktaWNvbiIgKSA/ICJ1aS1saS1oYXMtaWNvbiIgOiAidWktbGktaGFzLXRodW1iIiApOwoJCQl9CgkJfQoJfSwKCglfZ2V0Q2hpbGRyZW5CeVRhZ05hbWU6IGZ1bmN0aW9uKCBlbGUsIGxjTmFtZSwgdWNOYW1lICkgewoJCXZhciByZXN1bHRzID0gW10sCgkJCWRpY3QgPSB7fTsKCQlkaWN0WyBsY05hbWUgXSA9IGRpY3RbIHVjTmFtZSBdID0gdHJ1ZTsKCQllbGUgPSBlbGUuZmlyc3RDaGlsZDsKCQl3aGlsZSAoIGVsZSApIHsKCQkJaWYgKCBkaWN0WyBlbGUubm9kZU5hbWUgXSApIHsKCQkJCXJlc3VsdHMucHVzaCggZWxlICk7CgkJCX0KCQkJZWxlID0gZWxlLm5leHRTaWJsaW5nOwoJCX0KCQlyZXR1cm4gJCggcmVzdWx0cyApOwoJfSwKCglfYmVmb3JlTGlzdHZpZXdSZWZyZXNoOiAkLm5vb3AsCglfYWZ0ZXJMaXN0dmlld1JlZnJlc2g6ICQubm9vcCwKCglyZWZyZXNoOiBmdW5jdGlvbiggY3JlYXRlICkgewoJCXZhciBidXR0b25DbGFzcywgcG9zLCBudW1saSwgaXRlbSwgaXRlbUNsYXNzLCBpdGVtVGhlbWUsIGl0ZW1JY29uLCBpY29uLCBhLAoJCQlpc0RpdmlkZXIsIHN0YXJ0Q291bnQsIG5ld1N0YXJ0Q291bnQsIHZhbHVlLCBsYXN0LCBzcGxpdHRoZW1lLCBzcGxpdFRoZW1lQ2xhc3MsIHNwbGl0aWNvbiwKCQkJYWx0QnV0dG9uQ2xhc3MsIGRpdmlkZXJUaGVtZSwgbGksCgkJCW8gPSB0aGlzLm9wdGlvbnMsCgkJCSRsaXN0ID0gdGhpcy5lbGVtZW50LAoJCQlvbCA9ICEhJC5ub2RlTmFtZSggJGxpc3RbIDAgXSwgIm9sIiApLAoJCQlzdGFydCA9ICRsaXN0LmF0dHIoICJzdGFydCIgKSwKCQkJaXRlbUNsYXNzRGljdCA9IHt9LAoJCQljb3VudEJ1YmJsZXMgPSAkbGlzdC5maW5kKCAiLnVpLWxpLWNvdW50IiApLAoJCQljb3VudFRoZW1lID0gZ2V0QXR0ciggJGxpc3RbIDAgXSwgImNvdW50dGhlbWUiICkgfHwgdGhpcy5vcHRpb25zLmNvdW50VGhlbWUsCgkJCWNvdW50VGhlbWVDbGFzcyA9IGNvdW50VGhlbWUgPyAidWktYm9keS0iICsgY291bnRUaGVtZSA6ICJ1aS1ib2R5LWluaGVyaXQiOwoKCQlpZiAoIG8udGhlbWUgKSB7CgkJCSRsaXN0LmFkZENsYXNzKCAidWktZ3JvdXAtdGhlbWUtIiArIG8udGhlbWUgKTsKCQl9CgoJCS8vIENoZWNrIGlmIGEgc3RhcnQgYXR0cmlidXRlIGhhcyBiZWVuIHNldCB3aGlsZSB0YWtpbmcgYSB2YWx1ZSBvZiAwIGludG8gYWNjb3VudAoJCWlmICggb2wgJiYgKCBzdGFydCB8fCBzdGFydCA9PT0gMCApICkgewoJCQlzdGFydENvdW50ID0gcGFyc2VJbnQoIHN0YXJ0LCAxMCApIC0gMTsKCQkJJGxpc3QuY3NzKCAiY291bnRlci1yZXNldCIsICJsaXN0bnVtYmVyaW5nICIgKyBzdGFydENvdW50ICk7CgkJfQoKCQl0aGlzLl9iZWZvcmVMaXN0dmlld1JlZnJlc2goKTsKCgkJbGkgPSB0aGlzLl9nZXRDaGlsZHJlbkJ5VGFnTmFtZSggJGxpc3RbIDAgXSwgImxpIiwgIkxJIiApOwoKCQlmb3IgKCBwb3MgPSAwLCBudW1saSA9IGxpLmxlbmd0aDsgcG9zIDwgbnVtbGk7IHBvcysrICkgewoJCQlpdGVtID0gbGkuZXEoIHBvcyApOwoJCQlpdGVtQ2xhc3MgPSAiIjsKCgkJCWlmICggY3JlYXRlIHx8IGl0ZW1bIDAgXS5jbGFzc05hbWUuc2VhcmNoKCAvXGJ1aS1saS1zdGF0aWNcYnxcYnVpLWxpLWRpdmlkZXJcYi8gKSA8IDAgKSB7CgkJCQlhID0gdGhpcy5fZ2V0Q2hpbGRyZW5CeVRhZ05hbWUoIGl0ZW1bIDAgXSwgImEiLCAiQSIgKTsKCQkJCWlzRGl2aWRlciA9ICggZ2V0QXR0ciggaXRlbVsgMCBdLCAicm9sZSIgKSA9PT0gImxpc3QtZGl2aWRlciIgKTsKCQkJCXZhbHVlID0gaXRlbS5hdHRyKCAidmFsdWUiICk7CgkJCQlpdGVtVGhlbWUgPSBnZXRBdHRyKCBpdGVtWyAwIF0sICJ0aGVtZSIgKTsKCgkJCQlpZiAoIGEubGVuZ3RoICYmIGFbIDAgXS5jbGFzc05hbWUuc2VhcmNoKCAvXGJ1aS1idG5cYi8gKSA8IDAgJiYgIWlzRGl2aWRlciApIHsKCQkJCQlpdGVtSWNvbiA9IGdldEF0dHIoIGl0ZW1bIDAgXSwgImljb24iICk7CgkJCQkJaWNvbiA9ICggaXRlbUljb24gPT09IGZhbHNlICkgPyBmYWxzZSA6ICggaXRlbUljb24gfHwgby5pY29uICk7CgoJCQkJCS8vIFRPRE86IFJlbW92ZSBpbiAxLjUgdG9nZXRoZXIgd2l0aCBsaW5rcy5qcyAobGlua3MuanMgLyAudWktbGluayBkZXByZWNhdGVkIGluIDEuNCkKCQkJCQlhLnJlbW92ZUNsYXNzKCAidWktbGluayIgKTsKCgkJCQkJYnV0dG9uQ2xhc3MgPSAidWktYnRuIjsKCgkJCQkJaWYgKCBpdGVtVGhlbWUgKSB7CgkJCQkJCWJ1dHRvbkNsYXNzICs9ICIgdWktYnRuLSIgKyBpdGVtVGhlbWU7CgkJCQkJfQoKCQkJCQlpZiAoIGEubGVuZ3RoID4gMSApIHsKCQkJCQkJaXRlbUNsYXNzID0gInVpLWxpLWhhcy1hbHQiOwoKCQkJCQkJbGFzdCA9IGEubGFzdCgpOwoJCQkJCQlzcGxpdHRoZW1lID0gZ2V0QXR0ciggbGFzdFsgMCBdLCAidGhlbWUiICkgfHwgby5zcGxpdFRoZW1lIHx8IGdldEF0dHIoIGl0ZW1bIDAgXSwgInRoZW1lIiwgdHJ1ZSApOwoJCQkJCQlzcGxpdFRoZW1lQ2xhc3MgPSBzcGxpdHRoZW1lID8gIiB1aS1idG4tIiArIHNwbGl0dGhlbWUgOiAiIjsKCQkJCQkJc3BsaXRpY29uID0gZ2V0QXR0ciggbGFzdFsgMCBdLCAiaWNvbiIgKSB8fCBnZXRBdHRyKCBpdGVtWyAwIF0sICJpY29uIiApIHx8IG8uc3BsaXRJY29uOwoJCQkJCQlhbHRCdXR0b25DbGFzcyA9ICJ1aS1idG4gdWktYnRuLWljb24tbm90ZXh0IHVpLWljb24tIiArIHNwbGl0aWNvbiArIHNwbGl0VGhlbWVDbGFzczsKCgkJCQkJCWxhc3QKCQkJCQkJCS5hdHRyKCAidGl0bGUiLCAkLnRyaW0oIGxhc3QuZ2V0RW5jb2RlZFRleHQoKSApICkKCQkJCQkJCS5hZGRDbGFzcyggYWx0QnV0dG9uQ2xhc3MgKQoJCQkJCQkJLmVtcHR5KCk7CgkJCQkJfSBlbHNlIGlmICggaWNvbiApIHsKCQkJCQkJYnV0dG9uQ2xhc3MgKz0gIiB1aS1idG4taWNvbi1yaWdodCB1aS1pY29uLSIgKyBpY29uOwoJCQkJCX0KCgkJCQkJYS5maXJzdCgpLmFkZENsYXNzKCBidXR0b25DbGFzcyApOwoJCQkJfSBlbHNlIGlmICggaXNEaXZpZGVyICkgewoJCQkJCWRpdmlkZXJUaGVtZSA9ICggZ2V0QXR0ciggaXRlbVsgMCBdLCAidGhlbWUiICkgfHwgby5kaXZpZGVyVGhlbWUgfHwgby50aGVtZSApOwoKCQkJCQlpdGVtQ2xhc3MgPSAidWktbGktZGl2aWRlciB1aS1iYXItIiArICggZGl2aWRlclRoZW1lID8gZGl2aWRlclRoZW1lIDogImluaGVyaXQiICk7CgoJCQkJCWl0ZW0uYXR0ciggInJvbGUiLCAiaGVhZGluZyIgKTsKCQkJCX0gZWxzZSBpZiAoIGEubGVuZ3RoIDw9IDAgKSB7CgkJCQkJaXRlbUNsYXNzID0gInVpLWxpLXN0YXRpYyB1aS1ib2R5LSIgKyAoIGl0ZW1UaGVtZSA/IGl0ZW1UaGVtZSA6ICJpbmhlcml0IiApOwoJCQkJfQoJCQkJaWYgKCBvbCAmJiB2YWx1ZSApIHsKCQkJCQluZXdTdGFydENvdW50ID0gcGFyc2VJbnQoIHZhbHVlICwgMTAgKSAtIDE7CgoJCQkJCWl0ZW0uY3NzKCAiY291bnRlci1yZXNldCIsICJsaXN0bnVtYmVyaW5nICIgKyBuZXdTdGFydENvdW50ICk7CgkJCQl9CgkJCX0KCgkJCS8vIEluc3RlYWQgb2Ygc2V0dGluZyBpdGVtIGNsYXNzIGRpcmVjdGx5IG9uIHRoZSBsaXN0IGl0ZW0KCQkJLy8gYXQgdGhpcyBwb2ludCBpbiB0aW1lLCBwdXNoIHRoZSBpdGVtIGludG8gYSBkaWN0aW9uYXJ5CgkJCS8vIHRoYXQgdGVsbHMgdXMgd2hhdCBjbGFzcyB0byBzZXQgb24gaXQgc28gd2UgY2FuIGRvIHRoaXMgYWZ0ZXIgdGhpcwoJCQkvLyBwcm9jZXNzaW5nIGxvb3AgaXMgZmluaXNoZWQuCgoJCQlpZiAoICFpdGVtQ2xhc3NEaWN0WyBpdGVtQ2xhc3MgXSApIHsKCQkJCWl0ZW1DbGFzc0RpY3RbIGl0ZW1DbGFzcyBdID0gW107CgkJCX0KCgkJCWl0ZW1DbGFzc0RpY3RbIGl0ZW1DbGFzcyBdLnB1c2goIGl0ZW1bIDAgXSApOwoJCX0KCgkJLy8gU2V0IHRoZSBhcHByb3ByaWF0ZSBsaXN0dmlldyBpdGVtIGNsYXNzZXMgb24gZWFjaCBsaXN0IGl0ZW0uCgkJLy8gVGhlIG1haW4gcmVhc29uIHdlIGRpZG4ndCBkbyB0aGlzCgkJLy8gaW4gdGhlIGZvci1sb29wIGFib3ZlIGlzIGJlY2F1c2Ugd2UgY2FuIGVsaW1pbmF0ZSBwZXItaXRlbSBmdW5jdGlvbiBvdmVyaGVhZAoJCS8vIGJ5IGNhbGxpbmcgYWRkQ2xhc3MoKSBhbmQgY2hpbGRyZW4oKSBvbmNlIG9yIHR3aWNlIGFmdGVyd2FyZHMuIFRoaXMKCQkvLyBjYW4gZ2l2ZSB1cyBhIHNpZ25pZmljYW50IGJvb3N0IG9uIHBsYXRmb3JtcyBsaWtlIFdQNy41LgoKCQlmb3IgKCBpdGVtQ2xhc3MgaW4gaXRlbUNsYXNzRGljdCApIHsKCQkJJCggaXRlbUNsYXNzRGljdFsgaXRlbUNsYXNzIF0gKS5hZGRDbGFzcyggaXRlbUNsYXNzICk7CgkJfQoKCQljb3VudEJ1YmJsZXMuZWFjaCggZnVuY3Rpb24oKSB7CgkJCSQoIHRoaXMgKS5jbG9zZXN0KCAibGkiICkuYWRkQ2xhc3MoICJ1aS1saS1oYXMtY291bnQiICk7CgkJfSk7CgkJaWYgKCBjb3VudFRoZW1lQ2xhc3MgKSB7CgkJCWNvdW50QnViYmxlcy5hZGRDbGFzcyggY291bnRUaGVtZUNsYXNzICk7CgkJfQoKCQkvLyBEZXByZWNhdGVkIGluIDEuNC4gRnJvbSAxLjUgeW91IGhhdmUgdG8gYWRkIGNsYXNzIHVpLWxpLWhhcy10aHVtYiBvciB1aS1saS1oYXMtaWNvbiB0byB0aGUgTEkuCgkJdGhpcy5fYWRkVGh1bWJDbGFzc2VzKCBsaSApOwoJCXRoaXMuX2FkZFRodW1iQ2xhc3NlcyggbGkuZmluZCggIi51aS1idG4iICkgKTsKCgkJdGhpcy5fYWZ0ZXJMaXN0dmlld1JlZnJlc2goKTsKCgkJdGhpcy5fYWRkRmlyc3RMYXN0Q2xhc3NlcyggbGksIHRoaXMuX2dldFZpc2libGVzKCBsaSwgY3JlYXRlICksIGNyZWF0ZSApOwoJfQp9LCAkLm1vYmlsZS5iZWhhdmlvcnMuYWRkRmlyc3RMYXN0Q2xhc3NlcyApICk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCi8vIFRPRE8gcmVuYW1lIGZpbHRlckNhbGxiYWNrL2RlcHJlY2F0ZSBhbmQgZGVmYXVsdCB0byB0aGUgaXRlbSBpdHNlbGYgYXMgdGhlIGZpcnN0IGFyZ3VtZW50CnZhciBkZWZhdWx0RmlsdGVyQ2FsbGJhY2sgPSBmdW5jdGlvbiggaW5kZXgsIHNlYXJjaFZhbHVlICkgewoJcmV0dXJuICggKCAiIiArICggJC5tb2JpbGUuZ2V0QXR0cmlidXRlKCB0aGlzLCAiZmlsdGVydGV4dCIgKSB8fCAkKCB0aGlzICkudGV4dCgpICkgKQoJCS50b0xvd2VyQ2FzZSgpLmluZGV4T2YoIHNlYXJjaFZhbHVlICkgPT09IC0xICk7Cn07CgokLndpZGdldCggIm1vYmlsZS5maWx0ZXJhYmxlIiwgewoKCWluaXRTZWxlY3RvcjogIjpqcW1EYXRhKGZpbHRlcj0ndHJ1ZScpIiwKCglvcHRpb25zOiB7CgkJZmlsdGVyUmV2ZWFsOiBmYWxzZSwKCQlmaWx0ZXJDYWxsYmFjazogZGVmYXVsdEZpbHRlckNhbGxiYWNrLAoJCWVuaGFuY2VkOiBmYWxzZSwKCQlpbnB1dDogbnVsbCwKCQljaGlsZHJlbjogIj4gbGksID4gb3B0aW9uLCA+IG9wdGdyb3VwIG9wdGlvbiwgPiB0Ym9keSB0ciwgPiAudWktY29udHJvbGdyb3VwLWNvbnRyb2xzID4gLnVpLWJ0biwgPiAudWktY29udHJvbGdyb3VwLWNvbnRyb2xzID4gLnVpLWNoZWNrYm94LCA+IC51aS1jb250cm9sZ3JvdXAtY29udHJvbHMgPiAudWktcmFkaW8iCgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXZhciBvcHRzID0gdGhpcy5vcHRpb25zOwoKCQkkLmV4dGVuZCggdGhpcywgewoJCQlfc2VhcmNoOiBudWxsLAoJCQlfdGltZXI6IDAKCQl9KTsKCgkJdGhpcy5fc2V0SW5wdXQoIG9wdHMuaW5wdXQgKTsKCQlpZiAoICFvcHRzLmVuaGFuY2VkICkgewoJCQl0aGlzLl9maWx0ZXJJdGVtcyggKCAoIHRoaXMuX3NlYXJjaCAmJiB0aGlzLl9zZWFyY2gudmFsKCkgKSB8fCAiIiApLnRvTG93ZXJDYXNlKCkgKTsKCQl9Cgl9LAoKCV9vbktleVVwOiBmdW5jdGlvbigpIHsKCQl2YXIgdmFsLCBsYXN0dmFsLAoJCQlzZWFyY2ggPSB0aGlzLl9zZWFyY2g7CgoJCWlmICggc2VhcmNoICkgewoJCQl2YWwgPSBzZWFyY2gudmFsKCkudG9Mb3dlckNhc2UoKSwKCQkJbGFzdHZhbCA9ICQubW9iaWxlLmdldEF0dHJpYnV0ZSggc2VhcmNoWyAwIF0sICJsYXN0dmFsIiApICsgIiI7CgoJCQlpZiAoIGxhc3R2YWwgJiYgbGFzdHZhbCA9PT0gdmFsICkgewoJCQkJLy8gRXhlY3V0ZSB0aGUgaGFuZGxlciBvbmx5IG9uY2UgcGVyIHZhbHVlIGNoYW5nZQoJCQkJcmV0dXJuOwoJCQl9CgoJCQlpZiAoIHRoaXMuX3RpbWVyICkgewoJCQkJd2luZG93LmNsZWFyVGltZW91dCggdGhpcy5fdGltZXIgKTsKCQkJCXRoaXMuX3RpbWVyID0gMDsKCQkJfQoKCQkJdGhpcy5fdGltZXIgPSB0aGlzLl9kZWxheSggZnVuY3Rpb24oKSB7CgkJCQl0aGlzLl90cmlnZ2VyKCAiYmVmb3JlZmlsdGVyIiwgImJlZm9yZWZpbHRlciIsIHsgaW5wdXQ6IHNlYXJjaCB9ICk7CgoJCQkJLy8gQ2hhbmdlIHZhbCBhcyBsYXN0dmFsIGZvciBuZXh0IGV4ZWN1dGlvbgoJCQkJc2VhcmNoWyAwIF0uc2V0QXR0cmlidXRlKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAibGFzdHZhbCIsIHZhbCApOwoKCQkJCXRoaXMuX2ZpbHRlckl0ZW1zKCB2YWwgKTsKCQkJCXRoaXMuX3RpbWVyID0gMDsKCQkJfSwgMjUwICk7CgkJfQoJfSwKCglfZ2V0RmlsdGVyYWJsZUl0ZW1zOiBmdW5jdGlvbigpIHsKCQl2YXIgZWxlbSA9IHRoaXMuZWxlbWVudCwKCQkJY2hpbGRyZW4gPSB0aGlzLm9wdGlvbnMuY2hpbGRyZW4sCgkJCWl0ZW1zID0gIWNoaWxkcmVuID8geyBsZW5ndGg6IDAgfToKCQkJCSQuaXNGdW5jdGlvbiggY2hpbGRyZW4gKSA/IGNoaWxkcmVuKCk6CgkJCQljaGlsZHJlbi5ub2RlTmFtZSA/ICQoIGNoaWxkcmVuICk6CgkJCQljaGlsZHJlbi5qcXVlcnkgPyBjaGlsZHJlbjoKCQkJCXRoaXMuZWxlbWVudC5maW5kKCBjaGlsZHJlbiApOwoKCQlpZiAoIGl0ZW1zLmxlbmd0aCA9PT0gMCApIHsKCQkJaXRlbXMgPSBlbGVtLmNoaWxkcmVuKCk7CgkJfQoKCQlyZXR1cm4gaXRlbXM7Cgl9LAoKCV9maWx0ZXJJdGVtczogZnVuY3Rpb24oIHZhbCApIHsKCQl2YXIgaWR4LCBjYWxsYmFjaywgbGVuZ3RoLCBkc3QsCgkJCXNob3cgPSBbXSwKCQkJaGlkZSA9IFtdLAoJCQlvcHRzID0gdGhpcy5vcHRpb25zLAoJCQlmaWx0ZXJJdGVtcyA9IHRoaXMuX2dldEZpbHRlcmFibGVJdGVtcygpOwoKCQlpZiAoIHZhbCAhPSBudWxsICkgewoJCQljYWxsYmFjayA9IG9wdHMuZmlsdGVyQ2FsbGJhY2sgfHwgZGVmYXVsdEZpbHRlckNhbGxiYWNrOwoJCQlsZW5ndGggPSBmaWx0ZXJJdGVtcy5sZW5ndGg7CgoJCQkvLyBQYXJ0aXRpb24gdGhlIGl0ZW1zIGludG8gdGhvc2UgdG8gYmUgaGlkZGVuIGFuZCB0aG9zZSB0byBiZSBzaG93bgoJCQlmb3IgKCBpZHggPSAwIDsgaWR4IDwgbGVuZ3RoIDsgaWR4KysgKSB7CgkJCQlkc3QgPSAoIGNhbGxiYWNrLmNhbGwoIGZpbHRlckl0ZW1zWyBpZHggXSwgaWR4LCB2YWwgKSApID8gaGlkZSA6IHNob3c7CgkJCQlkc3QucHVzaCggZmlsdGVySXRlbXNbIGlkeCBdICk7CgkJCX0KCQl9CgoJCS8vIElmIG5vdGhpbmcgaXMgaGlkZGVuLCB0aGVuIHRoZSBkZWNpc2lvbiB3aGV0aGVyIHRvIGhpZGUgb3Igc2hvdyB0aGUgaXRlbXMKCQkvLyBpcyBiYXNlZCBvbiB0aGUgImZpbHRlclJldmVhbCIgb3B0aW9uLgoJCWlmICggaGlkZS5sZW5ndGggPT09IDAgKSB7CgkJCWZpbHRlckl0ZW1zWyBvcHRzLmZpbHRlclJldmVhbCA/ICJhZGRDbGFzcyIgOiAicmVtb3ZlQ2xhc3MiIF0oICJ1aS1zY3JlZW4taGlkZGVuIiApOwoJCX0gZWxzZSB7CgkJCSQoIGhpZGUgKS5hZGRDbGFzcyggInVpLXNjcmVlbi1oaWRkZW4iICk7CgkJCSQoIHNob3cgKS5yZW1vdmVDbGFzcyggInVpLXNjcmVlbi1oaWRkZW4iICk7CgkJfQoKCQl0aGlzLl9yZWZyZXNoQ2hpbGRXaWRnZXQoKTsKCX0sCgoJLy8gVGhlIERlZmF1bHQgaW1wbGVtZW50YXRpb24gb2YgX3JlZnJlc2hDaGlsZFdpZGdldCBhdHRlbXB0cyB0byBjYWxsCgkvLyByZWZyZXNoIG9uIGNvbGxhcHNpYmxlc2V0LCBjb250cm9sZ3JvdXAsIHNlbGVjdG1lbnUsIG9yIGxpc3R2aWV3CglfcmVmcmVzaENoaWxkV2lkZ2V0OiBmdW5jdGlvbigpIHsKCQl2YXIgd2lkZ2V0LCBpZHgsCgkJCXJlY29nbml6ZWRXaWRnZXRzID0gWyAiY29sbGFwc2libGVzZXQiLCAic2VsZWN0bWVudSIsICJjb250cm9sZ3JvdXAiLCAibGlzdHZpZXciIF07CgoJCWZvciAoIGlkeCA9IHJlY29nbml6ZWRXaWRnZXRzLmxlbmd0aCAtIDEgOyBpZHggPiAtMSA7IGlkeC0tICkgewoJCQl3aWRnZXQgPSByZWNvZ25pemVkV2lkZ2V0c1sgaWR4IF07CgkJCWlmICggJC5tb2JpbGVbIHdpZGdldCBdICkgewoJCQkJd2lkZ2V0ID0gdGhpcy5lbGVtZW50LmRhdGEoICJtb2JpbGUtIiArIHdpZGdldCApOwoJCQkJaWYgKCB3aWRnZXQgJiYgJC5pc0Z1bmN0aW9uKCB3aWRnZXQucmVmcmVzaCApICkgewoJCQkJCXdpZGdldC5yZWZyZXNoKCk7CgkJCQl9CgkJCX0KCQl9Cgl9LAoKCS8vIFRPRE86IFdoZW4gdGhlIGlucHV0IGlzIG5vdCBpbnRlcm5hbCwgZG8gbm90IGV2ZW4gc3RvcmUgaXQgaW4gdGhpcy5fc2VhcmNoCglfc2V0SW5wdXQ6IGZ1bmN0aW9uICggc2VsZWN0b3IgKSB7CgkJdmFyIHNlYXJjaCA9IHRoaXMuX3NlYXJjaDsKCgkJLy8gU3RvcCBhIHBlbmRpbmcgZmlsdGVyIG9wZXJhdGlvbgoJCWlmICggdGhpcy5fdGltZXIgKSB7CgkJCXdpbmRvdy5jbGVhclRpbWVvdXQoIHRoaXMuX3RpbWVyICk7CgkJCXRoaXMuX3RpbWVyID0gMDsKCQl9CgoJCWlmICggc2VhcmNoICkgewoJCQl0aGlzLl9vZmYoIHNlYXJjaCwgImtleXVwIGNoYW5nZSBpbnB1dCIgKTsKCQkJc2VhcmNoID0gbnVsbDsKCQl9CgoJCWlmICggc2VsZWN0b3IgKSB7CgkJCXNlYXJjaCA9IHNlbGVjdG9yLmpxdWVyeSA/IHNlbGVjdG9yOgoJCQkJc2VsZWN0b3Iubm9kZU5hbWUgPyAkKCBzZWxlY3RvciApOgoJCQkJdGhpcy5kb2N1bWVudC5maW5kKCBzZWxlY3RvciApOwoKCQkJdGhpcy5fb24oIHNlYXJjaCwgewoJCQkJa2V5dXA6ICJfb25LZXlVcCIsCgkJCQljaGFuZ2U6ICJfb25LZXlVcCIsCgkJCQlpbnB1dDogIl9vbktleVVwIgoJCQl9KTsKCQl9CgoJCXRoaXMuX3NlYXJjaCA9IHNlYXJjaDsKCX0sCgoJX3NldE9wdGlvbnM6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCXZhciByZWZpbHRlciA9ICEoICggb3B0aW9ucy5maWx0ZXJSZXZlYWwgPT09IHVuZGVmaW5lZCApICYmCgkJCQkoIG9wdGlvbnMuZmlsdGVyQ2FsbGJhY2sgPT09IHVuZGVmaW5lZCApICYmCgkJCQkoIG9wdGlvbnMuY2hpbGRyZW4gPT09IHVuZGVmaW5lZCApICk7CgoJCXRoaXMuX3N1cGVyKCBvcHRpb25zICk7CgoJCWlmICggb3B0aW9ucy5pbnB1dCAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLl9zZXRJbnB1dCggb3B0aW9ucy5pbnB1dCApOwoJCQlyZWZpbHRlciA9IHRydWU7CgkJfQoKCQlpZiAoIHJlZmlsdGVyICkgewoJCQl0aGlzLnJlZnJlc2goKTsKCQl9Cgl9LAoKCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCQl2YXIgb3B0cyA9IHRoaXMub3B0aW9ucywKCQkJaXRlbXMgPSB0aGlzLl9nZXRGaWx0ZXJhYmxlSXRlbXMoKTsKCgkJaWYgKCBvcHRzLmVuaGFuY2VkICkgewoJCQlpdGVtcy50b2dnbGVDbGFzcyggInVpLXNjcmVlbi1oaWRkZW4iLCBvcHRzLmZpbHRlclJldmVhbCApOwoJCX0gZWxzZSB7CgkJCWl0ZW1zLnJlbW92ZUNsYXNzKCAidWktc2NyZWVuLWhpZGRlbiIgKTsKCQl9Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCWlmICggdGhpcy5fdGltZXIgKSB7CgkJCXdpbmRvdy5jbGVhclRpbWVvdXQoIHRoaXMuX3RpbWVyICk7CgkJCXRoaXMuX3RpbWVyID0gMDsKCQl9CgkJdGhpcy5fZmlsdGVySXRlbXMoICggKCB0aGlzLl9zZWFyY2ggJiYgdGhpcy5fc2VhcmNoLnZhbCgpICkgfHwgIiIgKS50b0xvd2VyQ2FzZSgpICk7Cgl9Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgovLyBDcmVhdGUgYSBmdW5jdGlvbiB0aGF0IHdpbGwgcmVwbGFjZSB0aGUgX3NldE9wdGlvbnMgZnVuY3Rpb24gb2YgYSB3aWRnZXQsCi8vIGFuZCB3aWxsIHBhc3MgdGhlIG9wdGlvbnMgb24gdG8gdGhlIGlucHV0IG9mIHRoZSBmaWx0ZXJhYmxlLgp2YXIgcmVwbGFjZVNldE9wdGlvbnMgPSBmdW5jdGlvbiggc2VsZiwgb3JpZyApIHsKCQlyZXR1cm4gZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJCW9yaWcuY2FsbCggdGhpcywgb3B0aW9ucyApOwoJCQlzZWxmLl9zeW5jVGV4dElucHV0T3B0aW9ucyggb3B0aW9ucyApOwoJCX07Cgl9LAoJckRpdmlkZXJMaXN0SXRlbSA9IC8oXnxccyl1aS1saS1kaXZpZGVyKFxzfCQpLywKCW9yaWdEZWZhdWx0RmlsdGVyQ2FsbGJhY2sgPSAkLm1vYmlsZS5maWx0ZXJhYmxlLnByb3RvdHlwZS5vcHRpb25zLmZpbHRlckNhbGxiYWNrOwoKLy8gT3ZlcnJpZGUgdGhlIGRlZmF1bHQgZmlsdGVyIGNhbGxiYWNrIHdpdGggb25lIHRoYXQgZG9lcyBub3QgaGlkZSBsaXN0IGRpdmlkZXJzCiQubW9iaWxlLmZpbHRlcmFibGUucHJvdG90eXBlLm9wdGlvbnMuZmlsdGVyQ2FsbGJhY2sgPSBmdW5jdGlvbiggaW5kZXgsIHNlYXJjaFZhbHVlICkgewoJcmV0dXJuICF0aGlzLmNsYXNzTmFtZS5tYXRjaCggckRpdmlkZXJMaXN0SXRlbSApICYmCgkJb3JpZ0RlZmF1bHRGaWx0ZXJDYWxsYmFjay5jYWxsKCB0aGlzLCBpbmRleCwgc2VhcmNoVmFsdWUgKTsKfTsKCiQud2lkZ2V0KCAibW9iaWxlLmZpbHRlcmFibGUiLCAkLm1vYmlsZS5maWx0ZXJhYmxlLCB7CglvcHRpb25zOiB7CgkJZmlsdGVyUGxhY2Vob2xkZXI6ICJGaWx0ZXIgaXRlbXMuLi4iLAoJCWZpbHRlclRoZW1lOiBudWxsCgl9LAoKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl2YXIgaWR4LCB3aWRnZXROYW1lLAoJCQllbGVtID0gdGhpcy5lbGVtZW50LAoJCQlyZWNvZ25pemVkV2lkZ2V0cyA9IFsgImNvbGxhcHNpYmxlc2V0IiwgInNlbGVjdG1lbnUiLCAiY29udHJvbGdyb3VwIiwgImxpc3R2aWV3IiBdLAoJCQljcmVhdGVIYW5kbGVycyA9IHt9OwoKCQl0aGlzLl9zdXBlcigpOwoKCQkkLmV4dGVuZCggdGhpcywgewoJCQlfd2lkZ2V0OiBudWxsCgkJfSk7CgoJCWZvciAoIGlkeCA9IHJlY29nbml6ZWRXaWRnZXRzLmxlbmd0aCAtIDEgOyBpZHggPiAtMSA7IGlkeC0tICkgewoJCQl3aWRnZXROYW1lID0gcmVjb2duaXplZFdpZGdldHNbIGlkeCBdOwoJCQlpZiAoICQubW9iaWxlWyB3aWRnZXROYW1lIF0gKSB7CgkJCQlpZiAoIHRoaXMuX3NldFdpZGdldCggZWxlbS5kYXRhKCAibW9iaWxlLSIgKyB3aWRnZXROYW1lICkgKSApIHsKCQkJCQlicmVhazsKCQkJCX0gZWxzZSB7CgkJCQkJY3JlYXRlSGFuZGxlcnNbIHdpZGdldE5hbWUgKyAiY3JlYXRlIiBdID0gIl9oYW5kbGVDcmVhdGUiOwoJCQkJfQoJCQl9CgkJfQoKCQlpZiAoICF0aGlzLl93aWRnZXQgKSB7CgkJCXRoaXMuX29uKCBlbGVtLCBjcmVhdGVIYW5kbGVycyApOwoJCX0KCX0sCgoJX2hhbmRsZUNyZWF0ZTogZnVuY3Rpb24oIGV2dCApIHsKCQl0aGlzLl9zZXRXaWRnZXQoIHRoaXMuZWxlbWVudC5kYXRhKCAibW9iaWxlLSIgKyBldnQudHlwZS5zdWJzdHJpbmcoIDAsIGV2dC50eXBlLmxlbmd0aCAtIDYgKSApICk7Cgl9LAoKCV9zZXRXaWRnZXQ6IGZ1bmN0aW9uKCB3aWRnZXQgKSB7CgkJaWYgKCAhdGhpcy5fd2lkZ2V0ICYmIHdpZGdldCApIHsKCQkJdGhpcy5fd2lkZ2V0ID0gd2lkZ2V0OwoJCQl0aGlzLl93aWRnZXQuX3NldE9wdGlvbnMgPSByZXBsYWNlU2V0T3B0aW9ucyggdGhpcywgdGhpcy5fd2lkZ2V0Ll9zZXRPcHRpb25zICk7CgkJfQoKCQlpZiAoICEhdGhpcy5fd2lkZ2V0ICkgewoJCQl0aGlzLl9zeW5jVGV4dElucHV0T3B0aW9ucyggdGhpcy5fd2lkZ2V0Lm9wdGlvbnMgKTsKCQkJaWYgKCB0aGlzLl93aWRnZXQud2lkZ2V0TmFtZSA9PT0gImxpc3R2aWV3IiApIHsKCQkJCXRoaXMuX3dpZGdldC5vcHRpb25zLmhpZGVkaXZpZGVycyA9IHRydWU7CgkJCQl0aGlzLl93aWRnZXQuZWxlbWVudC5saXN0dmlldyggInJlZnJlc2giICk7CgkJCX0KCQl9CgoJCXJldHVybiAhIXRoaXMuX3dpZGdldDsKCX0sCgoJX2lzU2VhcmNoSW50ZXJuYWw6IGZ1bmN0aW9uKCkgewoJCXJldHVybiAoIHRoaXMuX3NlYXJjaCAmJiB0aGlzLl9zZWFyY2guanFtRGF0YSggInVpLWZpbHRlcmFibGUtIiArIHRoaXMudXVpZCArICItaW50ZXJuYWwiICkgKTsKCX0sCgoJX3NldElucHV0OiBmdW5jdGlvbiggc2VsZWN0b3IgKSB7CgkJdmFyIG9wdHMgPSB0aGlzLm9wdGlvbnMsCgkJCXVwZGF0ZVBsYWNlaG9sZGVyID0gdHJ1ZSwKCQkJdGV4dGlucHV0T3B0cyA9IHt9OwoKCQlpZiAoICFzZWxlY3RvciApIHsKCQkJaWYgKCB0aGlzLl9pc1NlYXJjaEludGVybmFsKCkgKSB7CgoJCQkJLy8gSWdub3JlIHRoZSBjYWxsIHRvIHNldCBhIG5ldyBpbnB1dCBpZiB0aGUgc2VsZWN0b3IgZ29lcyB0byBmYWxzeSBhbmQKCQkJCS8vIHRoZSBjdXJyZW50IHRleHRpbnB1dCBpcyBhbHJlYWR5IG9mIHRoZSBpbnRlcm5hbGx5IGdlbmVyYXRlZCB2YXJpZXR5LgoJCQkJcmV0dXJuOwoJCQl9IGVsc2UgewoKCQkJCS8vIEdlbmVyYXRpbmcgYSBuZXcgdGV4dGlucHV0IHdpZGdldC4gTm8gbmVlZCB0byBzZXQgdGhlIHBsYWNlaG9sZGVyCgkJCQkvLyBmdXJ0aGVyIGRvd24gdGhlIGZ1bmN0aW9uLgoJCQkJdXBkYXRlUGxhY2Vob2xkZXIgPSBmYWxzZTsKCQkJCXNlbGVjdG9yID0gJCggIjxpbnB1dCAiICsKCQkJCQkiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidHlwZT0nc2VhcmNoJyAiICsKCQkJCQkicGxhY2Vob2xkZXI9JyIgKyBvcHRzLmZpbHRlclBsYWNlaG9sZGVyICsgIic+PC9pbnB1dD4iICkKCQkJCQkuanFtRGF0YSggInVpLWZpbHRlcmFibGUtIiArIHRoaXMudXVpZCArICItaW50ZXJuYWwiLCB0cnVlICk7CgkJCQkkKCAiPGZvcm0gY2xhc3M9J3VpLWZpbHRlcmFibGUnPjwvZm9ybT4iICkKCQkJCQkuYXBwZW5kKCBzZWxlY3RvciApCgkJCQkJLnN1Ym1pdCggZnVuY3Rpb24oIGV2dCApIHsKCQkJCQkJZXZ0LnByZXZlbnREZWZhdWx0KCk7CgkJCQkJCXNlbGVjdG9yLmJsdXIoKTsKCQkJCQl9KQoJCQkJCS5pbnNlcnRCZWZvcmUoIHRoaXMuZWxlbWVudCApOwoJCQkJaWYgKCAkLm1vYmlsZS50ZXh0aW5wdXQgKSB7CgkJCQkJaWYgKCB0aGlzLm9wdGlvbnMuZmlsdGVyVGhlbWUgIT0gbnVsbCApIHsKCQkJCQkJdGV4dGlucHV0T3B0c1sgInRoZW1lIiBdID0gb3B0cy5maWx0ZXJUaGVtZTsKCQkJCQl9CgoJCQkJCXNlbGVjdG9yLnRleHRpbnB1dCggdGV4dGlucHV0T3B0cyApOwoJCQkJfQoJCQl9CgkJfQoKCQl0aGlzLl9zdXBlciggc2VsZWN0b3IgKTsKCgkJaWYgKCB0aGlzLl9pc1NlYXJjaEludGVybmFsKCkgJiYgdXBkYXRlUGxhY2Vob2xkZXIgKSB7CgkJCXRoaXMuX3NlYXJjaC5hdHRyKCAicGxhY2Vob2xkZXIiLCB0aGlzLm9wdGlvbnMuZmlsdGVyUGxhY2Vob2xkZXIgKTsKCQl9Cgl9LAoKCV9zZXRPcHRpb25zOiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQl2YXIgcmV0ID0gdGhpcy5fc3VwZXIoIG9wdGlvbnMgKTsKCgkJLy8gTmVlZCB0byBzZXQgdGhlIGZpbHRlclBsYWNlaG9sZGVyIGFmdGVyIGhhdmluZyBlc3RhYmxpc2hlZCB0aGUgc2VhcmNoIGlucHV0CgkJaWYgKCBvcHRpb25zLmZpbHRlclBsYWNlaG9sZGVyICE9PSB1bmRlZmluZWQgKSB7CgkJCWlmICggdGhpcy5faXNTZWFyY2hJbnRlcm5hbCgpICkgewoJCQkJdGhpcy5fc2VhcmNoLmF0dHIoICJwbGFjZWhvbGRlciIsIG9wdGlvbnMuZmlsdGVyUGxhY2Vob2xkZXIgKTsKCQkJfQoJCX0KCgkJaWYgKCBvcHRpb25zLmZpbHRlclRoZW1lICE9PSB1bmRlZmluZWQgJiYgdGhpcy5fc2VhcmNoICYmICQubW9iaWxlLnRleHRpbnB1dCApIHsKCQkJdGhpcy5fc2VhcmNoLnRleHRpbnB1dCggIm9wdGlvbiIsICJ0aGVtZSIsIG9wdGlvbnMuZmlsdGVyVGhlbWUgKTsKCQl9CgoJCXJldHVybiByZXQ7Cgl9LAoKCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCQlpZiAoIHRoaXMuX2lzU2VhcmNoSW50ZXJuYWwoKSApIHsKCQkJdGhpcy5fc2VhcmNoLnJlbW92ZSgpOwoJCX0KCQl0aGlzLl9zdXBlcigpOwoJfSwKCglfc3luY1RleHRJbnB1dE9wdGlvbnM6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCXZhciBpZHgsCgkJCXRleHRpbnB1dE9wdGlvbnMgPSB7fTsKCgkJLy8gV2Ugb25seSBzeW5jIG9wdGlvbnMgaWYgdGhlIGZpbHRlcmFibGUncyB0ZXh0aW5wdXQgaXMgb2YgdGhlIGludGVybmFsbHkKCQkvLyBnZW5lcmF0ZWQgdmFyaWV0eSwgcmF0aGVyIHRoYW4gb25lIHNwZWNpZmllZCBieSB0aGUgdXNlci4KCQlpZiAoIHRoaXMuX2lzU2VhcmNoSW50ZXJuYWwoKSAmJiAkLm1vYmlsZS50ZXh0aW5wdXQgKSB7CgoJCQkvLyBBcHBseSBvbmx5IHRoZSBvcHRpb25zIHVuZGVyc3Rvb2QgYnkgdGV4dGlucHV0CgkJCWZvciAoIGlkeCBpbiAkLm1vYmlsZS50ZXh0aW5wdXQucHJvdG90eXBlLm9wdGlvbnMgKSB7CgkJCQlpZiAoIG9wdGlvbnNbIGlkeCBdICE9PSB1bmRlZmluZWQgKSB7CgkJCQkJaWYgKCBpZHggPT09ICJ0aGVtZSIgJiYgdGhpcy5vcHRpb25zLmZpbHRlclRoZW1lICE9IG51bGwgKSB7CgkJCQkJCXRleHRpbnB1dE9wdGlvbnNbIGlkeCBdID0gdGhpcy5vcHRpb25zLmZpbHRlclRoZW1lOwoJCQkJCX0gZWxzZSB7CgkJCQkJCXRleHRpbnB1dE9wdGlvbnNbIGlkeCBdID0gb3B0aW9uc1sgaWR4IF07CgkJCQkJfQoJCQkJfQoJCQl9CgkJCXRoaXMuX3NlYXJjaC50ZXh0aW5wdXQoICJvcHRpb24iLCB0ZXh0aW5wdXRPcHRpb25zICk7CgkJfQoJfQp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKZnVuY3Rpb24gZGVmYXVsdEF1dG9kaXZpZGVyc1NlbGVjdG9yKCBlbHQgKSB7CgkvLyBsb29rIGZvciB0aGUgdGV4dCBpbiB0aGUgZ2l2ZW4gZWxlbWVudAoJdmFyIHRleHQgPSAkLnRyaW0oIGVsdC50ZXh0KCkgKSB8fCBudWxsOwoKCWlmICggIXRleHQgKSB7CgkJcmV0dXJuIG51bGw7Cgl9CgoJLy8gY3JlYXRlIHRoZSB0ZXh0IGZvciB0aGUgZGl2aWRlciAoZmlyc3QgdXBwZXJjYXNlZCBsZXR0ZXIpCgl0ZXh0ID0gdGV4dC5zbGljZSggMCwgMSApLnRvVXBwZXJDYXNlKCk7CgoJcmV0dXJuIHRleHQ7Cn0KCiQud2lkZ2V0KCAibW9iaWxlLmxpc3R2aWV3IiwgJC5tb2JpbGUubGlzdHZpZXcsIHsKCW9wdGlvbnM6IHsKCQlhdXRvZGl2aWRlcnM6IGZhbHNlLAoJCWF1dG9kaXZpZGVyc1NlbGVjdG9yOiBkZWZhdWx0QXV0b2RpdmlkZXJzU2VsZWN0b3IKCX0sCgoJX2JlZm9yZUxpc3R2aWV3UmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJaWYgKCB0aGlzLm9wdGlvbnMuYXV0b2RpdmlkZXJzICkgewoJCQl0aGlzLl9yZXBsYWNlRGl2aWRlcnMoKTsKCQkJdGhpcy5fc3VwZXJBcHBseSggYXJndW1lbnRzICk7CgkJfQoJfSwKCglfcmVwbGFjZURpdmlkZXJzOiBmdW5jdGlvbigpIHsKCQl2YXIgaSwgbGlzLCBsaSwgZGl2aWRlclRleHQsCgkJCWxhc3REaXZpZGVyVGV4dCA9IG51bGwsCgkJCWxpc3QgPSB0aGlzLmVsZW1lbnQsCgkJCWRpdmlkZXI7CgoJCWxpc3QuY2hpbGRyZW4oICJsaTpqcW1EYXRhKHJvbGU9J2xpc3QtZGl2aWRlcicpIiApLnJlbW92ZSgpOwoKCQlsaXMgPSBsaXN0LmNoaWxkcmVuKCAibGkiICk7CgoJCWZvciAoIGkgPSAwOyBpIDwgbGlzLmxlbmd0aCA7IGkrKyApIHsKCQkJbGkgPSBsaXNbIGkgXTsKCQkJZGl2aWRlclRleHQgPSB0aGlzLm9wdGlvbnMuYXV0b2RpdmlkZXJzU2VsZWN0b3IoICQoIGxpICkgKTsKCgkJCWlmICggZGl2aWRlclRleHQgJiYgbGFzdERpdmlkZXJUZXh0ICE9PSBkaXZpZGVyVGV4dCApIHsKCQkJCWRpdmlkZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAibGkiICk7CgkJCQlkaXZpZGVyLmFwcGVuZENoaWxkKCBkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSggZGl2aWRlclRleHQgKSApOwoJCQkJZGl2aWRlci5zZXRBdHRyaWJ1dGUoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyb2xlIiwgImxpc3QtZGl2aWRlciIgKTsKCQkJCWxpLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKCBkaXZpZGVyLCBsaSApOwoJCQl9CgoJCQlsYXN0RGl2aWRlclRleHQgPSBkaXZpZGVyVGV4dDsKCQl9Cgl9Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7Cgp2YXIgcmRpdmlkZXIgPSAvKF58XHMpdWktbGktZGl2aWRlcigkfFxzKS8sCglyaGlkZGVuID0gLyhefFxzKXVpLXNjcmVlbi1oaWRkZW4oJHxccykvOwoKJC53aWRnZXQoICJtb2JpbGUubGlzdHZpZXciLCAkLm1vYmlsZS5saXN0dmlldywgewoJb3B0aW9uczogewoJCWhpZGVkaXZpZGVyczogZmFsc2UKCX0sCgoJX2FmdGVyTGlzdHZpZXdSZWZyZXNoOiBmdW5jdGlvbigpIHsKCQl2YXIgaXRlbXMsIGlkeCwgaXRlbSwgaGlkZURpdmlkZXIgPSB0cnVlOwoKCQl0aGlzLl9zdXBlckFwcGx5KCBhcmd1bWVudHMgKTsKCgkJaWYgKCB0aGlzLm9wdGlvbnMuaGlkZWRpdmlkZXJzICkgewoJCQlpdGVtcyA9IHRoaXMuX2dldENoaWxkcmVuQnlUYWdOYW1lKCB0aGlzLmVsZW1lbnRbIDAgXSwgImxpIiwgIkxJIiApOwoJCQlmb3IgKCBpZHggPSBpdGVtcy5sZW5ndGggLSAxIDsgaWR4ID4gLTEgOyBpZHgtLSApIHsKCQkJCWl0ZW0gPSBpdGVtc1sgaWR4IF07CgkJCQlpZiAoIGl0ZW0uY2xhc3NOYW1lLm1hdGNoKCByZGl2aWRlciApICkgewoJCQkJCWlmICggaGlkZURpdmlkZXIgKSB7CgkJCQkJCWl0ZW0uY2xhc3NOYW1lID0gaXRlbS5jbGFzc05hbWUgKyAiIHVpLXNjcmVlbi1oaWRkZW4iOwoJCQkJCX0KCQkJCQloaWRlRGl2aWRlciA9IHRydWU7CgkJCQl9IGVsc2UgewoJCQkJCWlmICggIWl0ZW0uY2xhc3NOYW1lLm1hdGNoKCByaGlkZGVuICkgKSB7CgkJCQkJCWhpZGVEaXZpZGVyID0gZmFsc2U7CgkJCQkJfQoJCQkJfQoJCQl9CgkJfQoJfQp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUubm9qcyA9IGZ1bmN0aW9uKCB0YXJnZXQgKSB7CgkkKCAiOmpxbURhdGEocm9sZT0nbm9qcycpIiwgdGFyZ2V0ICkuYWRkQ2xhc3MoICJ1aS1ub2pzIiApOwp9OwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS5iZWhhdmlvcnMuZm9ybVJlc2V0ID0gewoJX2hhbmRsZUZvcm1SZXNldDogZnVuY3Rpb24oKSB7CgkJdGhpcy5fb24oIHRoaXMuZWxlbWVudC5jbG9zZXN0KCAiZm9ybSIgKSwgewoJCQlyZXNldDogZnVuY3Rpb24oKSB7CgkJCQl0aGlzLl9kZWxheSggIl9yZXNldCIgKTsKCQkJfQoJCX0pOwoJfQp9OwoKfSkoIGpRdWVyeSApOwoKLyoKKiAiY2hlY2tib3hyYWRpbyIgcGx1Z2luCiovCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLmNoZWNrYm94cmFkaW8iLCAkLmV4dGVuZCggewoKCWluaXRTZWxlY3RvcjogImlucHV0Om5vdCggOmpxbURhdGEocm9sZT0nZmxpcHN3aXRjaCcgKSApW3R5cGU9J2NoZWNrYm94J10saW5wdXRbdHlwZT0ncmFkaW8nXTpub3QoIDpqcW1EYXRhKHJvbGU9J2ZsaXBzd2l0Y2gnICkpIiwKCglvcHRpb25zOiB7CgkJdGhlbWU6ICJpbmhlcml0IiwKCQltaW5pOiBmYWxzZSwKCQl3cmFwcGVyQ2xhc3M6IG51bGwsCgkJZW5oYW5jZWQ6IGZhbHNlLAoJCWljb25wb3M6ICJsZWZ0IgoKCX0sCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl2YXIgaW5wdXQgPSB0aGlzLmVsZW1lbnQsCgkJCW8gPSB0aGlzLm9wdGlvbnMsCgkJCWluaGVyaXRBdHRyID0gZnVuY3Rpb24oIGlucHV0LCBkYXRhQXR0ciApIHsKCQkJCXJldHVybiBpbnB1dC5qcW1EYXRhKCBkYXRhQXR0ciApIHx8CgkJCQkJaW5wdXQuY2xvc2VzdCggImZvcm0sIGZpZWxkc2V0IiApLmpxbURhdGEoIGRhdGFBdHRyICk7CgkJCX0sCgkJCS8vIE5PVEU6IFdpbmRvd3MgUGhvbmUgY291bGQgbm90IGZpbmQgdGhlIGxhYmVsIHRocm91Z2ggYSBzZWxlY3RvcgoJCQkvLyBmaWx0ZXIgd29ya3MgdGhvdWdoLgoJCQlwYXJlbnRMYWJlbCA9IGlucHV0LmNsb3Nlc3QoICJsYWJlbCIgKSwKCQkJbGFiZWwgPSBwYXJlbnRMYWJlbC5sZW5ndGggPyBwYXJlbnRMYWJlbCA6CgkJCQlpbnB1dAoJCQkJCS5jbG9zZXN0KCAiZm9ybSwgZmllbGRzZXQsIDpqcW1EYXRhKHJvbGU9J3BhZ2UnKSwgOmpxbURhdGEocm9sZT0nZGlhbG9nJykiICkKCQkJCQkuZmluZCggImxhYmVsIiApCgkJCQkJLmZpbHRlciggIltmb3I9JyIgKyAkLm1vYmlsZS5wYXRoLmhhc2hUb1NlbGVjdG9yKCBpbnB1dFswXS5pZCApICsgIiddIiApCgkJCQkJLmZpcnN0KCksCgkJCWlucHV0dHlwZSA9IGlucHV0WzBdLnR5cGUsCgkJCWNoZWNrZWRTdGF0ZSA9IGlucHV0dHlwZSArICItb24iLAoJCQl1bmNoZWNrZWRTdGF0ZSA9IGlucHV0dHlwZSArICItb2ZmIiwKCQkJY2hlY2tlZENsYXNzID0gInVpLSIgKyBjaGVja2VkU3RhdGUsCgkJCXVuY2hlY2tlZENsYXNzID0gInVpLSIgKyB1bmNoZWNrZWRTdGF0ZTsKCgkJaWYgKCBpbnB1dHR5cGUgIT09ICJjaGVja2JveCIgJiYgaW5wdXR0eXBlICE9PSAicmFkaW8iICkgewoJCQlyZXR1cm47CgkJfQoKCQlpZiAoIHRoaXMuZWxlbWVudFswXS5kaXNhYmxlZCApewoJCQl0aGlzLm9wdGlvbnMuZGlzYWJsZWQgPSB0cnVlOwoJCX0KCgkJby5pY29ucG9zID0gaW5oZXJpdEF0dHIoIGlucHV0LCAiaWNvbnBvcyIgKSB8fCBsYWJlbC5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAiaWNvbnBvcyIgKSB8fCBvLmljb25wb3MsCgoJCS8vIEVzdGFibGlzaCBvcHRpb25zCgkJby5taW5pID0gaW5oZXJpdEF0dHIoIGlucHV0LCAibWluaSIgKSB8fCBvLm1pbmk7CgoJCS8vIEV4cG9zZSBmb3Igb3RoZXIgbWV0aG9kcwoJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCWlucHV0OiBpbnB1dCwKCQkJbGFiZWw6IGxhYmVsLAoJCQlwYXJlbnRMYWJlbDogcGFyZW50TGFiZWwsCgkJCWlucHV0dHlwZTogaW5wdXR0eXBlLAoJCQljaGVja2VkQ2xhc3M6IGNoZWNrZWRDbGFzcywKCQkJdW5jaGVja2VkQ2xhc3M6IHVuY2hlY2tlZENsYXNzLAoJCQljaGVja2VkaWNvbjogY2hlY2tlZFN0YXRlLAoJCQl1bmNoZWNrZWRpY29uOiB1bmNoZWNrZWRTdGF0ZQoJCX0pOwoKCQlpZiAoICF0aGlzLm9wdGlvbnMuZW5oYW5jZWQgKSB7CgkJCXRoaXMuX2VuaGFuY2UoKTsKCQl9CgoJCXRoaXMuX29uKCBsYWJlbCwgewoJCQl2bW91c2VvdmVyOiAiX2hhbmRsZUxhYmVsVk1vdXNlT3ZlciIsCgkJCXZjbGljazogIl9oYW5kbGVMYWJlbFZDbGljayIKCQl9KTsKCgkJdGhpcy5fb24oIGlucHV0LCB7CgkJCXZtb3VzZWRvd246ICJfY2FjaGVWYWxzIiwKCQkJdmNsaWNrOiAiX2hhbmRsZUlucHV0VkNsaWNrIiwKCQkJZm9jdXM6ICJfaGFuZGxlSW5wdXRGb2N1cyIsCgkJCWJsdXI6ICJfaGFuZGxlSW5wdXRCbHVyIgoJCX0pOwoKCQl0aGlzLl9oYW5kbGVGb3JtUmVzZXQoKTsKCQl0aGlzLnJlZnJlc2goKTsKCX0sCgoJX2VuaGFuY2U6IGZ1bmN0aW9uKCkgewoJCXRoaXMubGFiZWwuYWRkQ2xhc3MoICJ1aS1idG4gdWktY29ybmVyLWFsbCIpOwoKCQlpZiggdGhpcy5wYXJlbnRMYWJlbC5sZW5ndGggPiAwICl7CgkJCXRoaXMuaW5wdXQuYWRkKCB0aGlzLmxhYmVsICkud3JhcEFsbCggdGhpcy5fd3JhcHBlcigpICk7CgkJfSBlbHNlIHsKCQkJLy90aGlzLmVsZW1lbnQucmVwbGFjZVdpdGgoIHRoaXMuaW5wdXQuYWRkKCB0aGlzLmxhYmVsICkud3JhcEFsbCggdGhpcy5fd3JhcHBlcigpICkgKTsKCQkJdGhpcy5lbGVtZW50LndyYXAoIHRoaXMuX3dyYXBwZXIoKSApOwoJCQl0aGlzLmVsZW1lbnQucGFyZW50KCkucHJlcGVuZCggdGhpcy5sYWJlbCApOwoJCX0KCQkKCQkvLyBXcmFwIHRoZSBpbnB1dCArIGxhYmVsIGluIGEgZGl2CgkJCgkJdGhpcy5fc2V0T3B0aW9ucyh7CgkJCSJ0aGVtZSI6IHRoaXMub3B0aW9ucy50aGVtZSwKCQkJImljb25wb3MiOiB0aGlzLm9wdGlvbnMuaWNvbnBvcywKCQkJIm1pbmkiOiB0aGlzLm9wdGlvbnMubWluaQoJCX0pOwoKCX0sCgoJX3dyYXBwZXI6IGZ1bmN0aW9uKCkgewoJCXJldHVybiAkKCAiPGRpdiBjbGFzcz0nIiAgKwoJCQkoIHRoaXMub3B0aW9ucy53cmFwcGVyQ2xhc3MgPyB0aGlzLm9wdGlvbnMud3JhcHBlckNsYXNzIDogIiIgKSArCgkJCSIgdWktIiArIHRoaXMuaW5wdXR0eXBlICsKCQkJKCB0aGlzLm9wdGlvbnMuZGlzYWJsZWQgPyAiIHVpLXN0YXRlLWRpc2FibGVkIiA6ICIiICkgKyAiJyA+IiApOwoJfSwKCglfaGFuZGxlSW5wdXRGb2N1czogZnVuY3Rpb24oKSB7CgkJdGhpcy5sYWJlbC5hZGRDbGFzcyggJC5tb2JpbGUuZm9jdXNDbGFzcyApOwoJfSwKCglfaGFuZGxlSW5wdXRCbHVyOiBmdW5jdGlvbigpIHsKCQl0aGlzLmxhYmVsLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5mb2N1c0NsYXNzICk7Cgl9LAoKCV9oYW5kbGVJbnB1dFZDbGljazogZnVuY3Rpb24oKSB7CgkJdmFyICR0aGlzID0gdGhpcy5lbGVtZW50OwoKCQkvLyBBZGRzIGNoZWNrZWQgYXR0cmlidXRlIHRvIGNoZWNrZWQgaW5wdXQgd2hlbiBrZXlib2FyZCBpcyB1c2VkCgkJaWYgKCAkdGhpcy5pcyggIjpjaGVja2VkIiApICkgewoKCQkJJHRoaXMucHJvcCggImNoZWNrZWQiLCB0cnVlKTsKCQkJdGhpcy5fZ2V0SW5wdXRTZXQoKS5ub3QoICR0aGlzICkucHJvcCggImNoZWNrZWQiLCBmYWxzZSApOwoJCX0gZWxzZSB7CgkJCSR0aGlzLnByb3AoICJjaGVja2VkIiwgZmFsc2UgKTsKCQl9CgoJCXRoaXMuX3VwZGF0ZUFsbCgpOwoJfSwKCglfaGFuZGxlTGFiZWxWTW91c2VPdmVyOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJaWYgKCB0aGlzLmxhYmVsLnBhcmVudCgpLmhhc0NsYXNzKCAidWktc3RhdGUtZGlzYWJsZWQiICkgKSB7CgkJCWV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOwoJCX0KCX0sCgoJX2hhbmRsZUxhYmVsVkNsaWNrOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJdmFyIGlucHV0ID0gdGhpcy5lbGVtZW50OwoKCQlpZiAoIGlucHV0LmlzKCAiOmRpc2FibGVkIiApICkgewoJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQlyZXR1cm47CgkJfQoKCQl0aGlzLl9jYWNoZVZhbHMoKTsKCgkJaW5wdXQucHJvcCggImNoZWNrZWQiLCB0aGlzLmlucHV0dHlwZSA9PT0gInJhZGlvIiAmJiB0cnVlIHx8ICFpbnB1dC5wcm9wKCAiY2hlY2tlZCIgKSApOwoKCQkvLyB0cmlnZ2VyIGNsaWNrIGhhbmRsZXIncyBib3VuZCBkaXJlY3RseSB0byB0aGUgaW5wdXQgYXMgYSBzdWJzdGl0dXRlIGZvcgoJCS8vIGhvdyBsYWJlbCBjbGlja3MgYmVoYXZlIG5vcm1hbGx5IGluIHRoZSBicm93c2VycwoJCS8vIFRPRE86IGl0IHdvdWxkIGJlIG5pY2UgdG8gbGV0IHRoZSBicm93c2VyJ3MgaGFuZGxlIHRoZSBjbGlja3MgYW5kIHBhc3MgdGhlbQoJCS8vICAgICAgIHRocm91Z2ggdG8gdGhlIGFzc29jaWF0ZSBpbnB1dC4gd2UgY2FuIHN3YWxsb3cgdGhhdCBjbGljayBhdCB0aGUgcGFyZW50CgkJLy8gICAgICAgd3JhcHBlciBlbGVtZW50IGxldmVsCgkJaW5wdXQudHJpZ2dlckhhbmRsZXIoICJjbGljayIgKTsKCgkJLy8gSW5wdXQgc2V0IGZvciBjb21tb24gcmFkaW8gYnV0dG9ucyB3aWxsIGNvbnRhaW4gYWxsIHRoZSByYWRpbwoJCS8vIGJ1dHRvbnMsIGJ1dCB3aWxsIG5vdCBmb3IgY2hlY2tib3hlcy4gY2xlYXJpbmcgdGhlIGNoZWNrZWQgc3RhdHVzCgkJLy8gb2Ygb3RoZXIgcmFkaW9zIGVuc3VyZXMgdGhlIGFjdGl2ZSBidXR0b24gc3RhdGUgaXMgYXBwbGllZCBwcm9wZXJseQoJCXRoaXMuX2dldElucHV0U2V0KCkubm90KCBpbnB1dCApLnByb3AoICJjaGVja2VkIiwgZmFsc2UgKTsKCgkJdGhpcy5fdXBkYXRlQWxsKCk7CgkJcmV0dXJuIGZhbHNlOwoJfSwKCglfY2FjaGVWYWxzOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9nZXRJbnB1dFNldCgpLmVhY2goIGZ1bmN0aW9uKCkgewoJCQkkKCB0aGlzICkuYXR0cigiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAiY2FjaGVWYWwiLCB0aGlzLmNoZWNrZWQgKTsKCQl9KTsKCX0sCgoJLy9yZXR1cm5zIGVpdGhlciBhIHNldCBvZiByYWRpb3Mgd2l0aCB0aGUgc2FtZSBuYW1lIGF0dHJpYnV0ZSwgb3IgYSBzaW5nbGUgY2hlY2tib3gKCV9nZXRJbnB1dFNldDogZnVuY3Rpb24oKSB7CgkJaWYgKCB0aGlzLmlucHV0dHlwZSA9PT0gImNoZWNrYm94IiApIHsKCQkJcmV0dXJuIHRoaXMuZWxlbWVudDsKCQl9CgoJCXJldHVybiB0aGlzLmVsZW1lbnQuY2xvc2VzdCggImZvcm0sIDpqcW1EYXRhKHJvbGU9J3BhZ2UnKSwgOmpxbURhdGEocm9sZT0nZGlhbG9nJykiICkKCQkJLmZpbmQoICJpbnB1dFtuYW1lPSciICsgdGhpcy5lbGVtZW50WyAwIF0ubmFtZSArICInXVt0eXBlPSciICsgdGhpcy5pbnB1dHR5cGUgKyAiJ10iICk7Cgl9LAoKCV91cGRhdGVBbGw6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpczsKCgkJdGhpcy5fZ2V0SW5wdXRTZXQoKS5lYWNoKCBmdW5jdGlvbigpIHsKCQkJdmFyICR0aGlzID0gJCggdGhpcyApOwoKCQkJaWYgKCB0aGlzLmNoZWNrZWQgfHwgc2VsZi5pbnB1dHR5cGUgPT09ICJjaGVja2JveCIgKSB7CgkJCQkkdGhpcy50cmlnZ2VyKCAiY2hhbmdlIiApOwoJCQl9CgkJfSkKCQkuY2hlY2tib3hyYWRpbyggInJlZnJlc2giICk7Cgl9LAoKCV9yZXNldDogZnVuY3Rpb24oKSB7CgkJdGhpcy5yZWZyZXNoKCk7Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCXZhciBpbnB1dCA9IHRoaXMuZWxlbWVudFsgMCBdLAoJCQlhY3RpdmUgPSAiICIgKyAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcywKCQkJaGFzSWNvbiA9ICggdGhpcy5lbGVtZW50LnBhcmVudHMoICIudWktY29udHJvbGdyb3VwLWhvcml6b250YWwiICkubGVuZ3RoID09PSAwICksCgkJCWNoZWNrZWRDbGFzcyA9IHRoaXMuY2hlY2tlZENsYXNzICsgKCBoYXNJY29uID8gIiIgOiBhY3RpdmUgKSwKCQkJbGFiZWwgPSB0aGlzLmxhYmVsOwoKCQlsYWJlbAoJCQkudG9nZ2xlQ2xhc3MoICJ1aS1pY29uLSIgKyB0aGlzLmNoZWNrZWRpY29uLCBpbnB1dC5jaGVja2VkICkKCQkJLnRvZ2dsZUNsYXNzKCAidWktaWNvbi0iICsgdGhpcy51bmNoZWNrZWRpY29uLCAhaW5wdXQuY2hlY2tlZCApOwoJCWlmICggaW5wdXQuY2hlY2tlZCApIHsKCQkJbGFiZWwucmVtb3ZlQ2xhc3MoIHRoaXMudW5jaGVja2VkQ2xhc3MgKyBhY3RpdmUgKS5hZGRDbGFzcyggY2hlY2tlZENsYXNzICk7CgkJfSBlbHNlIHsKCQkJbGFiZWwucmVtb3ZlQ2xhc3MoIGNoZWNrZWRDbGFzcyApLmFkZENsYXNzKCB0aGlzLnVuY2hlY2tlZENsYXNzICk7CgkJfQoJfSwKCgl3aWRnZXQ6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLmxhYmVsLnBhcmVudCgpOwoJfSwKCglfc2V0T3B0aW9uczogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJdmFyIGxhYmVsID0gdGhpcy5sYWJlbCwKCQkJY3VycmVudE9wdGlvbnMgPSB0aGlzLm9wdGlvbnM7CgoJCWlmICggb3B0aW9ucy5kaXNhYmxlZCAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLmlucHV0LnByb3AoICJkaXNhYmxlZCIsICEhb3B0aW9ucy5kaXNhYmxlZCApOwoJCQl0aGlzLndpZGdldCgpLnRvZ2dsZUNsYXNzKCAidWktc3RhdGUtZGlzYWJsZWQiLCAhIW9wdGlvbnMuZGlzYWJsZWQgKTsKCQl9CgkJaWYgKCBvcHRpb25zLm1pbmkgIT09IHVuZGVmaW5lZCApIHsKCQkJbGFiZWwucGFyZW50KCkudG9nZ2xlQ2xhc3MoICJ1aS1taW5pIiwgISFvcHRpb25zLm1pbmkgKTsKCQl9CgkJaWYgKCBvcHRpb25zLnRoZW1lICE9PSB1bmRlZmluZWQgKSB7CgkJCWxhYmVsCgkJCQkucmVtb3ZlQ2xhc3MoICJ1aS1idG4tIiArIGN1cnJlbnRPcHRpb25zLnRoZW1lICkKCQkJCS5hZGRDbGFzcyggInVpLWJ0bi0iICsgb3B0aW9ucy50aGVtZSApOwoJCX0KCQlpZiAoIG9wdGlvbnMud3JhcHBlckNsYXNzICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMud2lkZ2V0KCkKCQkJCS5yZW1vdmVDbGFzcyggY3VycmVudE9wdGlvbnMud3JhcHBlckNsYXNzICkKCQkJCS5hZGRDbGFzcyggb3B0aW9ucy53cmFwcGVyQ2xhc3MgKTsKCQl9CgkJaWYgKCBvcHRpb25zLmljb25wb3MgIT09IHVuZGVmaW5lZCAmJgoJCQkoIHRoaXMuZWxlbWVudC5wYXJlbnRzKCAiW2RhdGEtIiArICQubW9iaWxlLm5zICsgInR5cGU9J2hvcml6b250YWwnXSIgKS5sZW5ndGggPT09IDAgKSApIHsKCQkJbGFiZWwucmVtb3ZlQ2xhc3MoICJ1aS1idG4taWNvbi0iICsgY3VycmVudE9wdGlvbnMuaWNvbnBvcyApLmFkZENsYXNzKCAidWktYnRuLWljb24tIiArIG9wdGlvbnMuaWNvbnBvcyApOwoJCX0gZWxzZSBpZiAoIHRoaXMuZWxlbWVudC5wYXJlbnRzKCAiW2RhdGEtIiArICQubW9iaWxlLm5zICsgInR5cGU9J2hvcml6b250YWwnXSIgKS5sZW5ndGggIT09IDAgKXsKCQkJbGFiZWwucmVtb3ZlQ2xhc3MoICJ1aS1idG4taWNvbi0iICsgY3VycmVudE9wdGlvbnMuaWNvbnBvcyApOwoJCX0KCQl0aGlzLl9zdXBlciggb3B0aW9ucyApOwoJfQoKfSwgJC5tb2JpbGUuYmVoYXZpb3JzLmZvcm1SZXNldCApICk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLmJ1dHRvbiIsIHsKCglpbml0U2VsZWN0b3I6ICJpbnB1dFt0eXBlPSdidXR0b24nXSwgaW5wdXRbdHlwZT0nc3VibWl0J10sIGlucHV0W3R5cGU9J3Jlc2V0J10iLAoKCW9wdGlvbnM6IHsKCQl0aGVtZTogbnVsbCwKCQlpY29uOiBudWxsLAoJCWljb25wb3M6ICJsZWZ0IiwKCQlpY29uc2hhZG93OiBmYWxzZSwgLyogVE9ETzogRGVwcmVjYXRlZCBpbiAxLjQsIHJlbW92ZSBpbiAxLjUuICovCgkJY29ybmVyczogdHJ1ZSwKCQlzaGFkb3c6IHRydWUsCgkJaW5saW5lOiBudWxsLAoJCW1pbmk6IG51bGwsCgkJd3JhcHBlckNsYXNzOiBudWxsLAoJCWVuaGFuY2VkOiBmYWxzZQoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCgkJaWYgKCB0aGlzLmVsZW1lbnQuaXMoICI6ZGlzYWJsZWQiICkgKSB7CgkJCXRoaXMub3B0aW9ucy5kaXNhYmxlZCA9IHRydWU7CgkJfQoKCQlpZiAoICF0aGlzLm9wdGlvbnMuZW5oYW5jZWQgKSB7CgkJCXRoaXMuX2VuaGFuY2UoKTsKCQl9CgoJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCXdyYXBwZXI6IHRoaXMuZWxlbWVudC5wYXJlbnQoKQoJCX0pOwoKCQl0aGlzLl9vbiggewoJCQlmb2N1czogZnVuY3Rpb24oKSB7CgkJCQl0aGlzLndpZGdldCgpLmFkZENsYXNzKCAkLm1vYmlsZS5mb2N1c0NsYXNzICk7CgkJCX0sCgoJCQlibHVyOiBmdW5jdGlvbigpIHsKCQkJCXRoaXMud2lkZ2V0KCkucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmZvY3VzQ2xhc3MgKTsKCQkJfQoJCX0pOwoJCQoJCXRoaXMucmVmcmVzaCggdHJ1ZSApOwoJfSwKCglfZW5oYW5jZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5lbGVtZW50LndyYXAoIHRoaXMuX2J1dHRvbigpICk7Cgl9LAoKCV9idXR0b246IGZ1bmN0aW9uKCkgewoJCXZhciBvcHRpb25zID0gdGhpcy5vcHRpb25zOwoKCQlyZXR1cm4gJCgiPGRpdiBjbGFzcz0ndWktYnRuIHVpLWlucHV0LWJ0biIgKwoJCQkoIG9wdGlvbnMud3JhcHBlckNsYXNzID8gIiAiICsgb3B0aW9ucy53cmFwcGVyQ2xhc3MgOiAiIiApICsKCQkJKCBvcHRpb25zLnRoZW1lID8gIiB1aS1idG4tIiArIG9wdGlvbnMudGhlbWUgOiAiIiApICsKCQkJKCBvcHRpb25zLmNvcm5lcnMgPyAiIHVpLWNvcm5lci1hbGwiIDogIiIgKSArCgkJCSggb3B0aW9ucy5zaGFkb3cgPyAiIHVpLXNoYWRvdyIgOiAiIiApICsKCQkJKCBvcHRpb25zLmlubGluZSA/ICIgdWktYnRuLWlubGluZSIgOiAiIiApICsKCQkJKCBvcHRpb25zLm1pbmkgPyAiIHVpLW1pbmkiIDogIiIgKSArCgkJCSggb3B0aW9ucy5kaXNhYmxlZCA/ICIgdWktc3RhdGUtZGlzYWJsZWQiIDogIiIgKSArCgkJCSggKCBvcHRpb25zLmljb25wb3MgJiYgb3B0aW9ucy5pY29uICkgPwoJCQkJIiB1aS1idG4taWNvbi0iICsgb3B0aW9ucy5pY29ucG9zIDoKCQkJCSggb3B0aW9ucy5pY29uID8gIiB1aS1idG4taWNvbi1sZWZ0IiA6ICIiICkgKSArCgkJCSggb3B0aW9ucy5pY29uID8gIiB1aS1pY29uLSIgKyBvcHRpb25zLmljb24gOiAiIiApICsKCQkJIicgPiIgKyB0aGlzLmVsZW1lbnQudmFsKCkgKyAiPC9kaXY+Iik7Cgl9LAoKCXdpZGdldDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMud3JhcHBlcjsKCX0sCgoJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLmVsZW1lbnQuaW5zZXJ0QmVmb3JlKCB0aGlzLmJ1dHRvbiApOwoJCQl0aGlzLmJ1dHRvbi5yZW1vdmUoKTsKCX0sCgoJX3NldE9wdGlvbnM6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCXZhciBvdXRlciA9IHRoaXMud2lkZ2V0KCk7CgoJCWlmICggb3B0aW9ucy50aGVtZSAhPT0gdW5kZWZpbmVkICkgewoJCQlvdXRlcgoJCQkJLnJlbW92ZUNsYXNzKCB0aGlzLm9wdGlvbnMudGhlbWUgKQoJCQkJLmFkZENsYXNzKCAidWktYnRuLSIgKyBvcHRpb25zLnRoZW1lICk7CgkJfQoJCWlmICggb3B0aW9ucy5jb3JuZXJzICE9PSB1bmRlZmluZWQgKSB7CgkJCW91dGVyLnRvZ2dsZUNsYXNzKCAidWktY29ybmVyLWFsbCIsIG9wdGlvbnMuY29ybmVycyApOwoJCX0KCQlpZiAoIG9wdGlvbnMuc2hhZG93ICE9PSB1bmRlZmluZWQgKSB7CgkJCW91dGVyLnRvZ2dsZUNsYXNzKCAidWktc2hhZG93Iiwgb3B0aW9ucy5zaGFkb3cgKTsKCQl9CgkJaWYgKCBvcHRpb25zLmlubGluZSAhPT0gdW5kZWZpbmVkICkgewoJCQlvdXRlci50b2dnbGVDbGFzcyggInVpLWJ0bi1pbmxpbmUiLCBvcHRpb25zLmlubGluZSApOwoJCX0KCQlpZiAoIG9wdGlvbnMubWluaSAhPT0gdW5kZWZpbmVkICkgewoJCQlvdXRlci50b2dnbGVDbGFzcyggInVpLW1pbmkiLCBvcHRpb25zLm1pbmkgKTsKCQl9CgkJaWYgKCBvcHRpb25zLmljb25wb3MgIT09IHVuZGVmaW5lZCApIHsKCQkJb3V0ZXIucmVtb3ZlQ2xhc3MoICJ1aS1idG4taWNvbi0iICsgb3B0aW9ucy5pY29ucG9zICk7CgkJfQoJCWlmICggb3B0aW9ucy5pY29uICE9PSB1bmRlZmluZWQgKSB7CgkJCWlmICggIXRoaXMub3B0aW9ucy5pY29ucG9zICYmICFvcHRpb25zLmljb25wb3MgKSB7CgkJCQlvdXRlci50b2dnbGVDbGFzcyggInVpLWJ0bi1pY29uLWxlZnQiLCBvcHRpb25zLmljb24gKTsKCQkJfQoJCQlvdXRlcgoJCQkJLnJlbW92ZUNsYXNzKCAidWktaWNvbi0iICsgdGhpcy5vcHRpb25zLmljb24gKQoJCQkJLnRvZ2dsZUNsYXNzKCAidWktaWNvbi0iICsgb3B0aW9ucy5pY29uLCBvcHRpb25zLmljb24gKTsKCQl9CgkJaWYoIG9wdGlvbnMuZGlzYWJsZWQgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhpcy5lbGVtZW50LnByb3AoICJkaXNhYmxlZCIsIG9wdGlvbnMuZGlzYWJsZWQgKTsKCQkJb3V0ZXIudG9nZ2xlQ2xhc3MoICJ1aS1zdGF0ZS1kaXNhYmxlZCIsIG9wdGlvbnMuZGlzYWJsZWQgKTsKCQl9CgoJCXRoaXMuX3N1cGVyKCBvcHRpb25zICk7Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCBjcmVhdGUgKSB7CgkJaWYgKCB0aGlzLm9wdGlvbnMuaWNvbiAmJiB0aGlzLm9wdGlvbnMuaWNvbnBvcyA9PT0gIm5vdGV4dCIgJiYgdGhpcy5lbGVtZW50LmF0dHIoICJ0aXRsZSIgKSApIHsKCQkJdGhpcy5lbGVtZW50LmF0dHIoICJ0aXRsZSIsIHRoaXMuZWxlbWVudC52YWwoKSApOwoJCX0KCQlpZiAoICFjcmVhdGUgKSB7CgkJCXZhciBvcmlnaW5hbEVsZW1lbnQgPSB0aGlzLmVsZW1lbnQuZGV0YWNoKCk7CgkJCSQoIHRoaXMud3JhcHBlciApLnRleHQoIHRoaXMuZWxlbWVudC52YWwoKSApLmFwcGVuZCggb3JpZ2luYWxFbGVtZW50ICk7CgkJfQoJfQp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCApIHsKCXZhcgltZXRhID0gJCggIm1ldGFbbmFtZT12aWV3cG9ydF0iICksCgkJaW5pdGlhbENvbnRlbnQgPSBtZXRhLmF0dHIoICJjb250ZW50IiApLAoJCWRpc2FibGVkWm9vbSA9IGluaXRpYWxDb250ZW50ICsgIixtYXhpbXVtLXNjYWxlPTEsIHVzZXItc2NhbGFibGU9bm8iLAoJCWVuYWJsZWRab29tID0gaW5pdGlhbENvbnRlbnQgKyAiLG1heGltdW0tc2NhbGU9MTAsIHVzZXItc2NhbGFibGU9eWVzIiwKCQlkaXNhYmxlZEluaXRpYWxseSA9IC8odXNlci1zY2FsYWJsZVtcc10qPVtcc10qbm8pfChtYXhpbXVtLXNjYWxlW1xzXSo9W1xzXSoxKVskLFxzXS8udGVzdCggaW5pdGlhbENvbnRlbnQgKTsKCgkkLm1vYmlsZS56b29tID0gJC5leHRlbmQoIHt9LCB7CgkJZW5hYmxlZDogIWRpc2FibGVkSW5pdGlhbGx5LAoJCWxvY2tlZDogZmFsc2UsCgkJZGlzYWJsZTogZnVuY3Rpb24oIGxvY2sgKSB7CgkJCWlmICggIWRpc2FibGVkSW5pdGlhbGx5ICYmICEkLm1vYmlsZS56b29tLmxvY2tlZCApIHsKCQkJCW1ldGEuYXR0ciggImNvbnRlbnQiLCBkaXNhYmxlZFpvb20gKTsKCQkJCSQubW9iaWxlLnpvb20uZW5hYmxlZCA9IGZhbHNlOwoJCQkJJC5tb2JpbGUuem9vbS5sb2NrZWQgPSBsb2NrIHx8IGZhbHNlOwoJCQl9CgkJfSwKCQllbmFibGU6IGZ1bmN0aW9uKCB1bmxvY2sgKSB7CgkJCWlmICggIWRpc2FibGVkSW5pdGlhbGx5ICYmICggISQubW9iaWxlLnpvb20ubG9ja2VkIHx8IHVubG9jayA9PT0gdHJ1ZSApICkgewoJCQkJbWV0YS5hdHRyKCAiY29udGVudCIsIGVuYWJsZWRab29tICk7CgkJCQkkLm1vYmlsZS56b29tLmVuYWJsZWQgPSB0cnVlOwoJCQkJJC5tb2JpbGUuem9vbS5sb2NrZWQgPSBmYWxzZTsKCQkJfQoJCX0sCgkJcmVzdG9yZTogZnVuY3Rpb24oKSB7CgkJCWlmICggIWRpc2FibGVkSW5pdGlhbGx5ICkgewoJCQkJbWV0YS5hdHRyKCAiY29udGVudCIsIGluaXRpYWxDb250ZW50ICk7CgkJCQkkLm1vYmlsZS56b29tLmVuYWJsZWQgPSB0cnVlOwoJCQl9CgkJfQoJfSk7Cgp9KCBqUXVlcnkgKSk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLnRleHRpbnB1dCIsIHsKCWluaXRTZWxlY3RvcjogImlucHV0W3R5cGU9J3RleHQnXSwgaW5wdXRbdHlwZT0nc2VhcmNoJ10sIDpqcW1EYXRhKHR5cGU9J3NlYXJjaCcpLCBpbnB1dFt0eXBlPSdudW1iZXInXSwgOmpxbURhdGEodHlwZT0nbnVtYmVyJyksIGlucHV0W3R5cGU9J3Bhc3N3b3JkJ10sIGlucHV0W3R5cGU9J2VtYWlsJ10sIGlucHV0W3R5cGU9J3VybCddLCBpbnB1dFt0eXBlPSd0ZWwnXSwgdGV4dGFyZWEsIGlucHV0W3R5cGU9J3RpbWUnXSwgaW5wdXRbdHlwZT0nZGF0ZSddLCBpbnB1dFt0eXBlPSdtb250aCddLCBpbnB1dFt0eXBlPSd3ZWVrJ10sIGlucHV0W3R5cGU9J2RhdGV0aW1lJ10sIGlucHV0W3R5cGU9J2RhdGV0aW1lLWxvY2FsJ10sIGlucHV0W3R5cGU9J2NvbG9yJ10sIGlucHV0Om5vdChbdHlwZV0pLCBpbnB1dFt0eXBlPSdmaWxlJ10iLAoKCW9wdGlvbnM6IHsKCQl0aGVtZTogbnVsbCwKCQljb3JuZXJzOiB0cnVlLAoJCW1pbmk6IGZhbHNlLAoJCS8vIFRoaXMgb3B0aW9uIGRlZmF1bHRzIHRvIHRydWUgb24gaU9TIGRldmljZXMuCgkJcHJldmVudEZvY3VzWm9vbTogL2lQaG9uZXxpUGFkfGlQb2QvLnRlc3QoIG5hdmlnYXRvci5wbGF0Zm9ybSApICYmIG5hdmlnYXRvci51c2VyQWdlbnQuaW5kZXhPZiggIkFwcGxlV2ViS2l0IiApID4gLTEsCgkJd3JhcHBlckNsYXNzOiAiIiwKCQllbmhhbmNlZDogZmFsc2UKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgoJCXZhciBvcHRpb25zID0gdGhpcy5vcHRpb25zLAoJCQlpc1NlYXJjaCA9IHRoaXMuZWxlbWVudC5pcyggIlt0eXBlPSdzZWFyY2gnXSwgOmpxbURhdGEodHlwZT0nc2VhcmNoJykiICksCgkJCWlzVGV4dGFyZWEgPSB0aGlzLmVsZW1lbnRbIDAgXS50YWdOYW1lID09PSAiVEVYVEFSRUEiLAoJCQlpc1JhbmdlID0gdGhpcy5lbGVtZW50LmlzKCAiW2RhdGEtIiArICggJC5tb2JpbGUubnMgfHwgIiIgKSArICJ0eXBlPSdyYW5nZSddIiApLAoJCQlpbnB1dE5lZWRzV3JhcCA9ICggKHRoaXMuZWxlbWVudC5pcyggImlucHV0IiApIHx8CgkJCQl0aGlzLmVsZW1lbnQuaXMoICJbZGF0YS0iICsgKCAkLm1vYmlsZS5ucyB8fCAiIiApICsgInR5cGU9J3NlYXJjaCddIiApICkgJiYKCQkJCQkhaXNSYW5nZSApOwoJCQkKCQkkLmV4dGVuZCggdGhpcywgewoJCQljbGFzc2VzOiB0aGlzLl9jbGFzc2VzRnJvbU9wdGlvbnMoKSwKCQkJaXNTZWFyY2g6IGlzU2VhcmNoLAoJCQlpc1RleHRhcmVhOiBpc1RleHRhcmVhLAoJCQlpc1JhbmdlOiBpc1JhbmdlLAoJCQlpbnB1dE5lZWRzV3JhcDogaW5wdXROZWVkc1dyYXAKCQl9KTsKCgkJdGhpcy5fYXV0b0NvcnJlY3QoKTsKCgkJaWYgKCB0aGlzLmVsZW1lbnRbIDAgXS5kaXNhYmxlZCApIHsKCQkJb3B0aW9ucy5kaXNhYmxlZCA9IHRydWU7CgkJfQoKCQlpZiAoICFvcHRpb25zLmVuaGFuY2VkICkgewoJCQl0aGlzLl9lbmhhbmNlKCk7CgkJfQoKCQl0aGlzLl9vbiggewoJCQkiZm9jdXMiOiAiX2hhbmRsZUZvY3VzIiwKCQkJImJsdXIiOiAiX2hhbmRsZUJsdXIiCgkJfSk7CgoJfSwKCglyZWZyZXNoOiBmdW5jdGlvbigpIHsKCQl0aGlzLnNldE9wdGlvbnMoewoJCQkiZGlzYWJsZWQiIDogdGhpcy5lbGVtZW50LmlzKCAiOmRpc2FibGVkIiApCgkJfSk7Cgl9LAoKCV9lbmhhbmNlOiBmdW5jdGlvbigpIHsKCQl2YXIgZWxlbWVudENsYXNzZXMgPSBbXTsKCgkJaWYgKCB0aGlzLmlzVGV4dGFyZWEgKSB7CgkJCWVsZW1lbnRDbGFzc2VzLnB1c2goICJ1aS1pbnB1dC10ZXh0IiApOwoJCX0KCgkJaWYgKCB0aGlzLmlzVGV4dGFyZWEgfHwgdGhpcy5pc1JhbmdlICkgewoJCQllbGVtZW50Q2xhc3Nlcy5wdXNoKCAidWktc2hhZG93LWluc2V0IiApOwoJCX0KCgkJLy8ic2VhcmNoIiBhbmQgInRleHQiIGlucHV0IHdpZGdldHMKCQlpZiAoIHRoaXMuaW5wdXROZWVkc1dyYXAgKSB7CgkJCXRoaXMuZWxlbWVudC53cmFwKCB0aGlzLl93cmFwKCkgKTsKCQl9IGVsc2UgewoJCQllbGVtZW50Q2xhc3NlcyA9IGVsZW1lbnRDbGFzc2VzLmNvbmNhdCggdGhpcy5jbGFzc2VzICk7CgkJfQoKCQl0aGlzLmVsZW1lbnQuYWRkQ2xhc3MoIGVsZW1lbnRDbGFzc2VzLmpvaW4oICIgIiApICk7Cgl9LAoKCXdpZGdldDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuICggdGhpcy5pbnB1dE5lZWRzV3JhcCApID8gdGhpcy5lbGVtZW50LnBhcmVudCgpIDogdGhpcy5lbGVtZW50OwoJfSwKCglfY2xhc3Nlc0Zyb21PcHRpb25zOiBmdW5jdGlvbigpIHsKCQl2YXIgb3B0aW9ucyA9IHRoaXMub3B0aW9ucywKCQkJY2xhc3NlcyA9IFtdOwoKCQljbGFzc2VzLnB1c2goICJ1aS1ib2R5LSIgKyAoICggb3B0aW9ucy50aGVtZSA9PT0gbnVsbCApID8gImluaGVyaXQiIDogb3B0aW9ucy50aGVtZSApICk7CgkJaWYgKCBvcHRpb25zLmNvcm5lcnMgKSB7CgkJCWNsYXNzZXMucHVzaCggInVpLWNvcm5lci1hbGwiICk7CgkJfQoJCWlmICggb3B0aW9ucy5taW5pICkgewoJCQljbGFzc2VzLnB1c2goICJ1aS1taW5pIiApOwoJCX0KCQlpZiAoIG9wdGlvbnMuZGlzYWJsZWQgKSB7CgkJCWNsYXNzZXMucHVzaCggInVpLXN0YXRlLWRpc2FibGVkIiApOwoJCX0KCQlpZiAoIG9wdGlvbnMud3JhcHBlckNsYXNzICkgewoJCQljbGFzc2VzLnB1c2goIG9wdGlvbnMud3JhcHBlckNsYXNzICk7CgkJfQoKCQlyZXR1cm4gY2xhc3NlczsKCX0sCgoJX3dyYXA6IGZ1bmN0aW9uKCkgewoJCXJldHVybiAkKCAiPGRpdiBjbGFzcz0nIiArCgkJCSggdGhpcy5pc1NlYXJjaCA/ICJ1aS1pbnB1dC1zZWFyY2ggIiA6ICJ1aS1pbnB1dC10ZXh0ICIgKSArCgkJCXRoaXMuY2xhc3Nlcy5qb2luKCAiICIgKSArICIgIiArCgkJCSJ1aS1zaGFkb3ctaW5zZXQnPjwvZGl2PiIgKTsKCX0sCgoJX2F1dG9Db3JyZWN0OiBmdW5jdGlvbigpIHsKCQkvLyBYWFg6IFRlbXBvcmFyeSB3b3JrYXJvdW5kIGZvciBpc3N1ZSA3ODUgKEFwcGxlIGJ1ZyA4OTEwNTg5KS4KCQkvLyAgICAgIFR1cm4gb2ZmIGF1dG9jb3JyZWN0IGFuZCBhdXRvY29tcGxldGUgb24gbm9uLWlPUyA1IGRldmljZXMKCQkvLyAgICAgIHNpbmNlIHRoZSBwb3B1cCB0aGV5IHVzZSBjYW4ndCBiZSBkaXNtaXNzZWQgYnkgdGhlIHVzZXIuIE5vdGUKCQkvLyAgICAgIHRoYXQgd2UgdGVzdCBmb3IgdGhlIHByZXNlbmNlIG9mIHRoZSBmZWF0dXJlIGJ5IGxvb2tpbmcgZm9yCgkJLy8gICAgICB0aGUgYXV0b2NvcnJlY3QgcHJvcGVydHkgb24gdGhlIGlucHV0IGVsZW1lbnQuIFdlIGN1cnJlbnRseQoJCS8vICAgICAgaGF2ZSBubyB0ZXN0IGZvciBpT1MgNSBvciBuZXdlciBzbyB3ZSdyZSB0ZW1wb3JhcmlseSB1c2luZwoJCS8vICAgICAgdGhlIHRvdWNoT3ZlcmZsb3cgc3VwcG9ydCBmbGFnIGZvciBqUU0gMS4wLiBZZXMsIEkgZmVlbCBkaXJ0eS4KCQkvLyAgICAgIC0gamJsYXMKCQlpZiAoIHR5cGVvZiB0aGlzLmVsZW1lbnRbMF0uYXV0b2NvcnJlY3QgIT09ICJ1bmRlZmluZWQiICYmCgkJCSEkLnN1cHBvcnQudG91Y2hPdmVyZmxvdyApIHsKCgkJCS8vIFNldCB0aGUgYXR0cmlidXRlIGluc3RlYWQgb2YgdGhlIHByb3BlcnR5IGp1c3QgaW4gY2FzZSB0aGVyZQoJCQkvLyBpcyBjb2RlIHRoYXQgYXR0ZW1wdHMgdG8gbWFrZSBtb2RpZmljYXRpb25zIHZpYSBIVE1MLgoJCQl0aGlzLmVsZW1lbnRbMF0uc2V0QXR0cmlidXRlKCAiYXV0b2NvcnJlY3QiLCAib2ZmIiApOwoJCQl0aGlzLmVsZW1lbnRbMF0uc2V0QXR0cmlidXRlKCAiYXV0b2NvbXBsZXRlIiwgIm9mZiIgKTsKCQl9Cgl9LAoKCV9oYW5kbGVCbHVyOiBmdW5jdGlvbigpIHsKCQl0aGlzLndpZGdldCgpLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5mb2N1c0NsYXNzICk7CgkJaWYgKCB0aGlzLm9wdGlvbnMucHJldmVudEZvY3VzWm9vbSApIHsKCQkJJC5tb2JpbGUuem9vbS5lbmFibGUoIHRydWUgKTsKCQl9Cgl9LAoKCV9oYW5kbGVGb2N1czogZnVuY3Rpb24oKSB7CgkJLy8gSW4gbWFueSBzaXR1YXRpb25zLCBpT1Mgd2lsbCB6b29tIGludG8gdGhlIGlucHV0IHVwb24gdGFwLCB0aGlzCgkJLy8gcHJldmVudHMgdGhhdCBmcm9tIGhhcHBlbmluZwoJCWlmICggdGhpcy5vcHRpb25zLnByZXZlbnRGb2N1c1pvb20gKSB7CgkJCSQubW9iaWxlLnpvb20uZGlzYWJsZSggdHJ1ZSApOwoJCX0KCQl0aGlzLndpZGdldCgpLmFkZENsYXNzKCAkLm1vYmlsZS5mb2N1c0NsYXNzICk7Cgl9LAoKCV9zZXRPcHRpb25zOiBmdW5jdGlvbiAoIG9wdGlvbnMgKSB7CgkJdmFyIG91dGVyID0gdGhpcy53aWRnZXQoKTsKCgkJdGhpcy5fc3VwZXIoIG9wdGlvbnMgKTsKCgkJaWYgKCAhKCBvcHRpb25zLmRpc2FibGVkID09PSB1bmRlZmluZWQgJiYKCQkJb3B0aW9ucy5taW5pID09PSB1bmRlZmluZWQgJiYKCQkJb3B0aW9ucy5jb3JuZXJzID09PSB1bmRlZmluZWQgJiYKCQkJb3B0aW9ucy50aGVtZSA9PT0gdW5kZWZpbmVkICYmCgkJCW9wdGlvbnMud3JhcHBlckNsYXNzID09PSB1bmRlZmluZWQgKSApIHsKCgkJCW91dGVyLnJlbW92ZUNsYXNzKCB0aGlzLmNsYXNzZXMuam9pbiggIiAiICkgKTsKCQkJdGhpcy5jbGFzc2VzID0gdGhpcy5fY2xhc3Nlc0Zyb21PcHRpb25zKCk7CgkJCW91dGVyLmFkZENsYXNzKCB0aGlzLmNsYXNzZXMuam9pbiggIiAiICkgKTsKCQl9CgoJCWlmICggb3B0aW9ucy5kaXNhYmxlZCAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLmVsZW1lbnQucHJvcCggImRpc2FibGVkIiwgISFvcHRpb25zLmRpc2FibGVkICk7CgkJfQoJfSwKCglfZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJaWYgKCB0aGlzLm9wdGlvbnMuZW5oYW5jZWQgKSB7CgkJCXJldHVybjsKCQl9CgkJaWYgKCB0aGlzLmlucHV0TmVlZHNXcmFwICkgewoJCQl0aGlzLmVsZW1lbnQudW53cmFwKCk7CgkJfQoJCXRoaXMuZWxlbWVudC5yZW1vdmVDbGFzcyggInVpLWlucHV0LXRleHQgIiArIHRoaXMuY2xhc3Nlcy5qb2luKCAiICIgKSApOwoJfQp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUuc2xpZGVyIiwgJC5leHRlbmQoIHsKCWluaXRTZWxlY3RvcjogImlucHV0W3R5cGU9J3JhbmdlJ10sIDpqcW1EYXRhKHR5cGU9J3JhbmdlJyksIDpqcW1EYXRhKHJvbGU9J3NsaWRlcicpIiwKCgl3aWRnZXRFdmVudFByZWZpeDogInNsaWRlIiwKCglvcHRpb25zOiB7CgkJdGhlbWU6IG51bGwsCgkJdHJhY2tUaGVtZTogbnVsbCwKCQljb3JuZXJzOiB0cnVlLAoJCW1pbmk6IGZhbHNlLAoJCWhpZ2hsaWdodDogZmFsc2UKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgoJCS8vIFRPRE86IEVhY2ggb2YgdGhlc2Ugc2hvdWxkIGhhdmUgY29tbWVudHMgZXhwbGFpbiB3aGF0IHRoZXkncmUgZm9yCgkJdmFyIHNlbGYgPSB0aGlzLAoJCQljb250cm9sID0gdGhpcy5lbGVtZW50LAoJCQl0cmFja1RoZW1lID0gdGhpcy5vcHRpb25zLnRyYWNrVGhlbWUgfHwgJC5tb2JpbGUuZ2V0QXR0cmlidXRlKCBjb250cm9sWyAwIF0sICJ0aGVtZSIgKSwKCQkJdHJhY2tUaGVtZUNsYXNzID0gdHJhY2tUaGVtZSA/ICIgdWktYmFyLSIgKyB0cmFja1RoZW1lIDogIiB1aS1iYXItaW5oZXJpdCIsCgkJCWNvcm5lckNsYXNzID0gKCB0aGlzLm9wdGlvbnMuY29ybmVycyB8fCBjb250cm9sLmpxbURhdGEoICJjb3JuZXJzIiApICkgPyAiIHVpLWNvcm5lci1hbGwiIDogIiIsCgkJCW1pbmlDbGFzcyA9ICggdGhpcy5vcHRpb25zLm1pbmkgfHwgY29udHJvbC5qcW1EYXRhKCAibWluaSIgKSApID8gIiB1aS1taW5pIiA6ICIiLAoJCQljVHlwZSA9IGNvbnRyb2xbIDAgXS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpLAoJCQlpc1RvZ2dsZVN3aXRjaCA9ICggY1R5cGUgPT09ICJzZWxlY3QiICksCgkJCWlzUmFuZ2VzbGlkZXIgPSBjb250cm9sLnBhcmVudCgpLmlzKCAiOmpxbURhdGEocm9sZT0ncmFuZ2VzbGlkZXInKSIgKSwKCQkJc2VsZWN0Q2xhc3MgPSAoIGlzVG9nZ2xlU3dpdGNoICkgPyAidWktc2xpZGVyLXN3aXRjaCIgOiAiIiwKCQkJY29udHJvbElEID0gY29udHJvbC5hdHRyKCAiaWQiICksCgkJCSRsYWJlbCA9ICQoICJbZm9yPSciICsgY29udHJvbElEICsgIiddIiApLAoJCQlsYWJlbElEID0gJGxhYmVsLmF0dHIoICJpZCIgKSB8fCBjb250cm9sSUQgKyAiLWxhYmVsIiwKCQkJbWluID0gIWlzVG9nZ2xlU3dpdGNoID8gcGFyc2VGbG9hdCggY29udHJvbC5hdHRyKCAibWluIiApICkgOiAwLAoJCQltYXggPSAgIWlzVG9nZ2xlU3dpdGNoID8gcGFyc2VGbG9hdCggY29udHJvbC5hdHRyKCAibWF4IiApICkgOiBjb250cm9sLmZpbmQoICJvcHRpb24iICkubGVuZ3RoLTEsCgkJCXN0ZXAgPSB3aW5kb3cucGFyc2VGbG9hdCggY29udHJvbC5hdHRyKCAic3RlcCIgKSB8fCAxICksCgkJCWRvbUhhbmRsZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJhIiApLAoJCQloYW5kbGUgPSAkKCBkb21IYW5kbGUgKSwKCQkJZG9tU2xpZGVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImRpdiIgKSwKCQkJc2xpZGVyID0gJCggZG9tU2xpZGVyICksCgkJCXZhbHVlYmcgPSB0aGlzLm9wdGlvbnMuaGlnaGxpZ2h0ICYmICFpc1RvZ2dsZVN3aXRjaCA/IChmdW5jdGlvbigpIHsKCQkJCXZhciBiZyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJkaXYiICk7CgkJCQliZy5jbGFzc05hbWUgPSAidWktc2xpZGVyLWJnICIgKyAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzczsKCQkJCXJldHVybiAkKCBiZyApLnByZXBlbmRUbyggc2xpZGVyICk7CgkJCX0pKCkgOiBmYWxzZSwKCQkJb3B0aW9ucywKCQkJd3JhcHBlciwKCQkJaiwgbGVuZ3RoLAoJCQlpLCBvcHRpb25zQ291bnQsIG9yaWdUYWJJbmRleCwKCQkJc2lkZSwgYWN0aXZlQ2xhc3MsIHNsaWRlckltZzsKCgkJJGxhYmVsLmF0dHIoICJpZCIsIGxhYmVsSUQgKTsKCQl0aGlzLmlzVG9nZ2xlU3dpdGNoID0gaXNUb2dnbGVTd2l0Y2g7CgoJCWRvbUhhbmRsZS5zZXRBdHRyaWJ1dGUoICJocmVmIiwgIiMiICk7CgkJZG9tU2xpZGVyLnNldEF0dHJpYnV0ZSggInJvbGUiLCAiYXBwbGljYXRpb24iICk7CgkJZG9tU2xpZGVyLmNsYXNzTmFtZSA9IFsgdGhpcy5pc1RvZ2dsZVN3aXRjaCA/ICJ1aS1zbGlkZXIgdWktc2xpZGVyLXRyYWNrIHVpLXNoYWRvdy1pbnNldCAiIDogInVpLXNsaWRlci10cmFjayB1aS1zaGFkb3ctaW5zZXQgIiwgc2VsZWN0Q2xhc3MsIHRyYWNrVGhlbWVDbGFzcywgY29ybmVyQ2xhc3MsIG1pbmlDbGFzcyBdLmpvaW4oICIiICk7CgkJZG9tSGFuZGxlLmNsYXNzTmFtZSA9ICJ1aS1zbGlkZXItaGFuZGxlIjsKCQlkb21TbGlkZXIuYXBwZW5kQ2hpbGQoIGRvbUhhbmRsZSApOwoKCQloYW5kbGUuYXR0cih7CgkJCSJyb2xlIjogInNsaWRlciIsCgkJCSJhcmlhLXZhbHVlbWluIjogbWluLAoJCQkiYXJpYS12YWx1ZW1heCI6IG1heCwKCQkJImFyaWEtdmFsdWVub3ciOiB0aGlzLl92YWx1ZSgpLAoJCQkiYXJpYS12YWx1ZXRleHQiOiB0aGlzLl92YWx1ZSgpLAoJCQkidGl0bGUiOiB0aGlzLl92YWx1ZSgpLAoJCQkiYXJpYS1sYWJlbGxlZGJ5IjogbGFiZWxJRAoJCX0pOwoKCQkkLmV4dGVuZCggdGhpcywgewoJCQlzbGlkZXI6IHNsaWRlciwKCQkJaGFuZGxlOiBoYW5kbGUsCgkJCWNvbnRyb2w6IGNvbnRyb2wsCgkJCXR5cGU6IGNUeXBlLAoJCQlzdGVwOiBzdGVwLAoJCQltYXg6IG1heCwKCQkJbWluOiBtaW4sCgkJCXZhbHVlYmc6IHZhbHVlYmcsCgkJCWlzUmFuZ2VzbGlkZXI6IGlzUmFuZ2VzbGlkZXIsCgkJCWRyYWdnaW5nOiBmYWxzZSwKCQkJYmVmb3JlU3RhcnQ6IG51bGwsCgkJCXVzZXJNb2RpZmllZDogZmFsc2UsCgkJCW1vdXNlTW92ZWQ6IGZhbHNlCgkJfSk7CgoJCWlmICggaXNUb2dnbGVTd2l0Y2ggKSB7CgkJCS8vIFRPRE86IHJlc3RvcmUgb3JpZ2luYWwgdGFiaW5kZXggKGlmIGFueSkgaW4gYSBkZXN0cm95IG1ldGhvZAoJCQlvcmlnVGFiSW5kZXggPSBjb250cm9sLmF0dHIoICJ0YWJpbmRleCIgKTsKCQkJaWYgKCBvcmlnVGFiSW5kZXggKSB7CgkJCQloYW5kbGUuYXR0ciggInRhYmluZGV4Iiwgb3JpZ1RhYkluZGV4ICk7CgkJCX0KCQkJY29udHJvbC5hdHRyKCAidGFiaW5kZXgiLCAiLTEiICkuZm9jdXMoZnVuY3Rpb24oKSB7CgkJCQkkKCB0aGlzICkuYmx1cigpOwoJCQkJaGFuZGxlLmZvY3VzKCk7CgkJCX0pOwoKCQkJd3JhcHBlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJkaXYiICk7CgkJCXdyYXBwZXIuY2xhc3NOYW1lID0gInVpLXNsaWRlci1pbm5lcm9mZnNldCI7CgoJCQlmb3IgKCBqID0gMCwgbGVuZ3RoID0gZG9tU2xpZGVyLmNoaWxkTm9kZXMubGVuZ3RoOyBqIDwgbGVuZ3RoOyBqKysgKSB7CgkJCQl3cmFwcGVyLmFwcGVuZENoaWxkKCBkb21TbGlkZXIuY2hpbGROb2Rlc1tqXSApOwoJCQl9CgoJCQlkb21TbGlkZXIuYXBwZW5kQ2hpbGQoIHdyYXBwZXIgKTsKCgkJCS8vIHNsaWRlci53cmFwSW5uZXIoICI8ZGl2IGNsYXNzPSd1aS1zbGlkZXItaW5uZXJvZmZzZXQnPjwvZGl2PiIgKTsKCgkJCS8vIG1ha2UgdGhlIGhhbmRsZSBtb3ZlIHdpdGggYSBzbW9vdGggdHJhbnNpdGlvbgoJCQloYW5kbGUuYWRkQ2xhc3MoICJ1aS1zbGlkZXItaGFuZGxlLXNuYXBwaW5nIiApOwoKCQkJb3B0aW9ucyA9IGNvbnRyb2wuZmluZCggIm9wdGlvbiIgKTsKCgkJCWZvciAoIGkgPSAwLCBvcHRpb25zQ291bnQgPSBvcHRpb25zLmxlbmd0aDsgaSA8IG9wdGlvbnNDb3VudDsgaSsrICkgewoJCQkJc2lkZSA9ICFpID8gImIiIDogImEiOwoJCQkJYWN0aXZlQ2xhc3MgPSAhaSA/ICIiIDogIiAiICsgJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3M7CgkJCQlzbGlkZXJJbWcgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAic3BhbiIgKTsKCgkJCQlzbGlkZXJJbWcuY2xhc3NOYW1lID0gWyAidWktc2xpZGVyLWxhYmVsIHVpLXNsaWRlci1sYWJlbC0iLCBzaWRlLCBhY3RpdmVDbGFzcyBdLmpvaW4oICIiICk7CgkJCQlzbGlkZXJJbWcuc2V0QXR0cmlidXRlKCAicm9sZSIsICJpbWciICk7CgkJCQlzbGlkZXJJbWcuYXBwZW5kQ2hpbGQoIGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKCBvcHRpb25zW2ldLmlubmVySFRNTCApICk7CgkJCQkkKCBzbGlkZXJJbWcgKS5wcmVwZW5kVG8oIHNsaWRlciApOwoJCQl9CgoJCQlzZWxmLl9sYWJlbHMgPSAkKCAiLnVpLXNsaWRlci1sYWJlbCIsIHNsaWRlciApOwoKCQl9CgoJCS8vIG1vbml0b3IgdGhlIGlucHV0IGZvciB1cGRhdGVkIHZhbHVlcwoJCWNvbnRyb2wuYWRkQ2xhc3MoIGlzVG9nZ2xlU3dpdGNoID8gInVpLXNsaWRlci1zd2l0Y2giIDogInVpLXNsaWRlci1pbnB1dCIgKTsKCgkJdGhpcy5fb24oIGNvbnRyb2wsIHsKCQkJImNoYW5nZSI6ICJfY29udHJvbENoYW5nZSIsCgkJCSJrZXl1cCI6ICJfY29udHJvbEtleXVwIiwKCQkJImJsdXIiOiAiX2NvbnRyb2xCbHVyIiwKCQkJInZtb3VzZXVwIjogIl9jb250cm9sVk1vdXNlVXAiCgkJfSk7CgoJCXNsaWRlci5iaW5kKCAidm1vdXNlZG93biIsICQucHJveHkoIHRoaXMuX3NsaWRlclZNb3VzZURvd24sIHRoaXMgKSApCgkJCS5iaW5kKCAidmNsaWNrIiwgZmFsc2UgKTsKCgkJLy8gV2UgaGF2ZSB0byBpbnN0YW50aWF0ZSBhIG5ldyBmdW5jdGlvbiBvYmplY3QgZm9yIHRoZSB1bmJpbmQgdG8gd29yayBwcm9wZXJseQoJCS8vIHNpbmNlIHRoZSBtZXRob2QgaXRzZWxmIGlzIGRlZmluZWQgaW4gdGhlIHByb3RvdHlwZSAoY2F1c2luZyBpdCB0byB1bmJpbmQgZXZlcnl0aGluZykKCQl0aGlzLl9vbiggZG9jdW1lbnQsIHsgInZtb3VzZW1vdmUiOiAiX3ByZXZlbnREb2N1bWVudERyYWciIH0pOwoJCXRoaXMuX29uKCBzbGlkZXIuYWRkKCBkb2N1bWVudCApLCB7ICJ2bW91c2V1cCI6ICJfc2xpZGVyVk1vdXNlVXAiIH0pOwoKCQlzbGlkZXIuaW5zZXJ0QWZ0ZXIoIGNvbnRyb2wgKTsKCgkJLy8gd3JhcCBpbiBhIGRpdiBmb3Igc3R5bGluZyBwdXJwb3NlcwoJCWlmICggIWlzVG9nZ2xlU3dpdGNoICYmICFpc1Jhbmdlc2xpZGVyICkgewoJCQl3cmFwcGVyID0gdGhpcy5vcHRpb25zLm1pbmkgPyAiPGRpdiBjbGFzcz0ndWktc2xpZGVyIHVpLW1pbmknPiIgOiAiPGRpdiBjbGFzcz0ndWktc2xpZGVyJz4iOwoKCQkJY29udHJvbC5hZGQoIHNsaWRlciApLndyYXBBbGwoIHdyYXBwZXIgKTsKCQl9CgoJCS8vIGJpbmQgdGhlIGhhbmRsZSBldmVudCBjYWxsYmFja3MgYW5kIHNldCB0aGUgY29udGV4dCB0byB0aGUgd2lkZ2V0IGluc3RhbmNlCgkJdGhpcy5fb24oIHRoaXMuaGFuZGxlLCB7CgkJCSJ2bW91c2Vkb3duIjogIl9oYW5kbGVWTW91c2VEb3duIiwKCQkJImtleWRvd24iOiAiX2hhbmRsZUtleWRvd24iLAoJCQkia2V5dXAiOiAiX2hhbmRsZUtleXVwIgoJCX0pOwoKCQl0aGlzLmhhbmRsZS5iaW5kKCAidmNsaWNrIiwgZmFsc2UgKTsKCgkJdGhpcy5faGFuZGxlRm9ybVJlc2V0KCk7CgoJCXRoaXMucmVmcmVzaCggdW5kZWZpbmVkLCB1bmRlZmluZWQsIHRydWUgKTsKCX0sCgoJX3NldE9wdGlvbnM6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCWlmICggb3B0aW9ucy50aGVtZSAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLl9zZXRUaGVtZSggb3B0aW9ucy50aGVtZSApOwoJCX0KCgkJaWYgKCBvcHRpb25zLnRyYWNrVGhlbWUgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhpcy5fc2V0VHJhY2tUaGVtZSggb3B0aW9ucy50cmFja1RoZW1lICk7CgkJfQoKCQlpZiAoIG9wdGlvbnMuY29ybmVycyAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLl9zZXRDb3JuZXJzKCBvcHRpb25zLmNvcm5lcnMgKTsKCQl9CgoJCWlmICggb3B0aW9ucy5taW5pICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMuX3NldE1pbmkoIG9wdGlvbnMubWluaSApOwoJCX0KCgkJaWYgKCBvcHRpb25zLmhpZ2hsaWdodCAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLl9zZXRIaWdobGlnaHQoIG9wdGlvbnMuaGlnaGxpZ2h0ICk7CgkJfQoKCQlpZiAoIG9wdGlvbnMuZGlzYWJsZWQgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhpcy5fc2V0RGlzYWJsZWQoIG9wdGlvbnMuZGlzYWJsZWQgKTsKCQl9CgkJdGhpcy5fc3VwZXIoIG9wdGlvbnMgKTsKCX0sCgoJX2NvbnRyb2xDaGFuZ2U6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkvLyBpZiB0aGUgdXNlciBkcmFnZ2VkIHRoZSBoYW5kbGUsIHRoZSAiY2hhbmdlIiBldmVudCB3YXMgdHJpZ2dlcmVkIGZyb20gaW5zaWRlIHJlZnJlc2goKTsgZG9uJ3QgY2FsbCByZWZyZXNoKCkgYWdhaW4KCQlpZiAoIHRoaXMuX3RyaWdnZXIoICJjb250cm9sY2hhbmdlIiwgZXZlbnQgKSA9PT0gZmFsc2UgKSB7CgkJCXJldHVybiBmYWxzZTsKCQl9CgkJaWYgKCAhdGhpcy5tb3VzZU1vdmVkICkgewoJCQl0aGlzLnJlZnJlc2goIHRoaXMuX3ZhbHVlKCksIHRydWUgKTsKCQl9Cgl9LAoKCV9jb250cm9sS2V5dXA6IGZ1bmN0aW9uKC8qIGV2ZW50ICovKSB7IC8vIG5lY2Vzc2FyeT8KCQl0aGlzLnJlZnJlc2goIHRoaXMuX3ZhbHVlKCksIHRydWUsIHRydWUgKTsKCX0sCgoJX2NvbnRyb2xCbHVyOiBmdW5jdGlvbigvKiBldmVudCAqLykgewoJCXRoaXMucmVmcmVzaCggdGhpcy5fdmFsdWUoKSwgdHJ1ZSApOwoJfSwKCgkvLyBpdCBhcHBlYXJzIHRoZSBjbGlja2luZyB0aGUgdXAgYW5kIGRvd24gYnV0dG9ucyBpbiBjaHJvbWUgb24KCS8vIHJhbmdlL251bWJlciBpbnB1dHMgZG9lc24ndCB0cmlnZ2VyIGEgY2hhbmdlIHVudGlsIHRoZSBmaWVsZCBpcwoJLy8gYmx1cnJlZC4gSGVyZSB3ZSBjaGVjayB0aGlmIHRoZSB2YWx1ZSBoYXMgY2hhbmdlZCBhbmQgcmVmcmVzaAoJX2NvbnRyb2xWTW91c2VVcDogZnVuY3Rpb24oLyogZXZlbnQgKi8pIHsKCQl0aGlzLl9jaGVja2VkUmVmcmVzaCgpOwoJfSwKCgkvLyBOT1RFIGZvcmNlIGZvY3VzIG9uIGhhbmRsZQoJX2hhbmRsZVZNb3VzZURvd246IGZ1bmN0aW9uKC8qIGV2ZW50ICovKSB7CgkJdGhpcy5oYW5kbGUuZm9jdXMoKTsKCX0sCgoJX2hhbmRsZUtleWRvd246IGZ1bmN0aW9uKCBldmVudCApIHsKCQl2YXIgaW5kZXggPSB0aGlzLl92YWx1ZSgpOwoJCWlmICggdGhpcy5vcHRpb25zLmRpc2FibGVkICkgewoJCQlyZXR1cm47CgkJfQoKCQkvLyBJbiBhbGwgY2FzZXMgcHJldmVudCB0aGUgZGVmYXVsdCBhbmQgbWFyayB0aGUgaGFuZGxlIGFzIGFjdGl2ZQoJCXN3aXRjaCAoIGV2ZW50LmtleUNvZGUgKSB7CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5IT01FOgoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuRU5EOgoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuUEFHRV9VUDoKCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLlBBR0VfRE9XTjoKCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLlVQOgoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuUklHSFQ6CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5ET1dOOgoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuTEVGVDoKCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgoJCQkJaWYgKCAhdGhpcy5fa2V5U2xpZGluZyApIHsKCQkJCQl0aGlzLl9rZXlTbGlkaW5nID0gdHJ1ZTsKCQkJCQl0aGlzLmhhbmRsZS5hZGRDbGFzcyggInVpLXN0YXRlLWFjdGl2ZSIgKTsgLyogVE9ETzogV2UgZG9uJ3QgdXNlIHRoaXMgY2xhc3MgZm9yIHN0eWxpbmcuIERvIHdlIG5lZWQgdG8gYWRkIGl0PyAqLwoJCQkJfQoKCQkJCWJyZWFrOwoJCX0KCgkJLy8gbW92ZSB0aGUgc2xpZGVyIGFjY29yZGluZyB0byB0aGUga2V5cHJlc3MKCQlzd2l0Y2ggKCBldmVudC5rZXlDb2RlICkgewoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuSE9NRToKCQkJCXRoaXMucmVmcmVzaCggdGhpcy5taW4gKTsKCQkJCWJyZWFrOwoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuRU5EOgoJCQkJdGhpcy5yZWZyZXNoKCB0aGlzLm1heCApOwoJCQkJYnJlYWs7CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5QQUdFX1VQOgoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuVVA6CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5SSUdIVDoKCQkJCXRoaXMucmVmcmVzaCggaW5kZXggKyB0aGlzLnN0ZXAgKTsKCQkJCWJyZWFrOwoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuUEFHRV9ET1dOOgoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuRE9XTjoKCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLkxFRlQ6CgkJCQl0aGlzLnJlZnJlc2goIGluZGV4IC0gdGhpcy5zdGVwICk7CgkJCQlicmVhazsKCQl9Cgl9LCAvLyByZW1vdmUgYWN0aXZlIG1hcmsKCglfaGFuZGxlS2V5dXA6IGZ1bmN0aW9uKC8qIGV2ZW50ICovKSB7CgkJaWYgKCB0aGlzLl9rZXlTbGlkaW5nICkgewoJCQl0aGlzLl9rZXlTbGlkaW5nID0gZmFsc2U7CgkJCXRoaXMuaGFuZGxlLnJlbW92ZUNsYXNzKCAidWktc3RhdGUtYWN0aXZlIiApOyAvKiBTZWUgY29tbWVudCBhYm92ZS4gKi8KCQl9Cgl9LAoKCV9zbGlkZXJWTW91c2VEb3duOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJLy8gTk9URTogd2UgZG9uJ3QgZG8gdGhpcyBpbiByZWZyZXNoIGJlY2F1c2Ugd2Ugc3RpbGwgd2FudCB0bwoJCS8vICAgICAgIHN1cHBvcnQgcHJvZ3JhbW1hdGljIGFsdGVyYXRpb24gb2YgZGlzYWJsZWQgaW5wdXRzCgkJaWYgKCB0aGlzLm9wdGlvbnMuZGlzYWJsZWQgfHwgISggZXZlbnQud2hpY2ggPT09IDEgfHwgZXZlbnQud2hpY2ggPT09IDAgfHwgZXZlbnQud2hpY2ggPT09IHVuZGVmaW5lZCApICkgewoJCQlyZXR1cm4gZmFsc2U7CgkJfQoJCWlmICggdGhpcy5fdHJpZ2dlciggImJlZm9yZXN0YXJ0IiwgZXZlbnQgKSA9PT0gZmFsc2UgKSB7CgkJCXJldHVybiBmYWxzZTsKCQl9CgkJdGhpcy5kcmFnZ2luZyA9IHRydWU7CgkJdGhpcy51c2VyTW9kaWZpZWQgPSBmYWxzZTsKCQl0aGlzLm1vdXNlTW92ZWQgPSBmYWxzZTsKCgkJaWYgKCB0aGlzLmlzVG9nZ2xlU3dpdGNoICkgewoJCQl0aGlzLmJlZm9yZVN0YXJ0ID0gdGhpcy5lbGVtZW50WzBdLnNlbGVjdGVkSW5kZXg7CgkJfQoKCQl0aGlzLnJlZnJlc2goIGV2ZW50ICk7CgkJdGhpcy5fdHJpZ2dlciggInN0YXJ0IiApOwoJCXJldHVybiBmYWxzZTsKCX0sCgoJX3NsaWRlclZNb3VzZVVwOiBmdW5jdGlvbigpIHsKCQlpZiAoIHRoaXMuZHJhZ2dpbmcgKSB7CgkJCXRoaXMuZHJhZ2dpbmcgPSBmYWxzZTsKCgkJCWlmICggdGhpcy5pc1RvZ2dsZVN3aXRjaCApIHsKCQkJCS8vIG1ha2UgdGhlIGhhbmRsZSBtb3ZlIHdpdGggYSBzbW9vdGggdHJhbnNpdGlvbgoJCQkJdGhpcy5oYW5kbGUuYWRkQ2xhc3MoICJ1aS1zbGlkZXItaGFuZGxlLXNuYXBwaW5nIiApOwoKCQkJCWlmICggdGhpcy5tb3VzZU1vdmVkICkgewoJCQkJCS8vIHRoaXMgaXMgYSBkcmFnLCBjaGFuZ2UgdGhlIHZhbHVlIG9ubHkgaWYgdXNlciBkcmFnZ2VkIGVub3VnaAoJCQkJCWlmICggdGhpcy51c2VyTW9kaWZpZWQgKSB7CgkJCQkJCXRoaXMucmVmcmVzaCggdGhpcy5iZWZvcmVTdGFydCA9PT0gMCA/IDEgOiAwICk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJdGhpcy5yZWZyZXNoKCB0aGlzLmJlZm9yZVN0YXJ0ICk7CgkJCQkJfQoJCQkJfSBlbHNlIHsKCQkJCQkvLyB0aGlzIGlzIGp1c3QgYSBjbGljaywgY2hhbmdlIHRoZSB2YWx1ZQoJCQkJCXRoaXMucmVmcmVzaCggdGhpcy5iZWZvcmVTdGFydCA9PT0gMCA/IDEgOiAwICk7CgkJCQl9CgkJCX0KCgkJCXRoaXMubW91c2VNb3ZlZCA9IGZhbHNlOwoJCQl0aGlzLl90cmlnZ2VyKCAic3RvcCIgKTsKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCX0sCgoJX3ByZXZlbnREb2N1bWVudERyYWc6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJLy8gTk9URTogd2UgZG9uJ3QgZG8gdGhpcyBpbiByZWZyZXNoIGJlY2F1c2Ugd2Ugc3RpbGwgd2FudCB0bwoJCQkvLyAgICAgICBzdXBwb3J0IHByb2dyYW1tYXRpYyBhbHRlcmF0aW9uIG9mIGRpc2FibGVkIGlucHV0cwoJCQlpZiAoIHRoaXMuX3RyaWdnZXIoICJkcmFnIiwgZXZlbnQgKSA9PT0gZmFsc2UpIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoJCQlpZiAoIHRoaXMuZHJhZ2dpbmcgJiYgIXRoaXMub3B0aW9ucy5kaXNhYmxlZCApIHsKCgkJCQkvLyB0aGlzLm1vdXNlTW92ZWQgbXVzdCBiZSB1cGRhdGVkIGJlZm9yZSByZWZyZXNoKCkgYmVjYXVzZSBpdCB3aWxsIGJlIHVzZWQgaW4gdGhlIGNvbnRyb2wgImNoYW5nZSIgZXZlbnQKCQkJCXRoaXMubW91c2VNb3ZlZCA9IHRydWU7CgoJCQkJaWYgKCB0aGlzLmlzVG9nZ2xlU3dpdGNoICkgewoJCQkJCS8vIG1ha2UgdGhlIGhhbmRsZSBtb3ZlIGluIHN5bmMgd2l0aCB0aGUgbW91c2UKCQkJCQl0aGlzLmhhbmRsZS5yZW1vdmVDbGFzcyggInVpLXNsaWRlci1oYW5kbGUtc25hcHBpbmciICk7CgkJCQl9CgoJCQkJdGhpcy5yZWZyZXNoKCBldmVudCApOwoKCQkJCS8vIG9ubHkgYWZ0ZXIgcmVmcmVzaCgpIHlvdSBjYW4gY2FsY3VsYXRlIHRoaXMudXNlck1vZGlmaWVkCgkJCQl0aGlzLnVzZXJNb2RpZmllZCA9IHRoaXMuYmVmb3JlU3RhcnQgIT09IHRoaXMuZWxlbWVudFswXS5zZWxlY3RlZEluZGV4OwoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgkJfSwKCglfY2hlY2tlZFJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCWlmICggdGhpcy52YWx1ZSAhPT0gdGhpcy5fdmFsdWUoKSApIHsKCQkJdGhpcy5yZWZyZXNoKCB0aGlzLl92YWx1ZSgpICk7CgkJfQoJfSwKCglfdmFsdWU6IGZ1bmN0aW9uKCkgewoJCXJldHVybiAgdGhpcy5pc1RvZ2dsZVN3aXRjaCA/IHRoaXMuZWxlbWVudFswXS5zZWxlY3RlZEluZGV4IDogcGFyc2VGbG9hdCggdGhpcy5lbGVtZW50LnZhbCgpICkgOwoJfSwKCgoJX3Jlc2V0OiBmdW5jdGlvbigpIHsKCQl0aGlzLnJlZnJlc2goIHVuZGVmaW5lZCwgZmFsc2UsIHRydWUgKTsKCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oIHZhbCwgaXNmcm9tQ29udHJvbCwgcHJldmVudElucHV0VXBkYXRlICkgewoJCS8vIE5PVEU6IHdlIGRvbid0IHJldHVybiBoZXJlIGJlY2F1c2Ugd2Ugd2FudCB0byBzdXBwb3J0IHByb2dyYW1tYXRpYwoJCS8vICAgICAgIGFsdGVyYXRpb24gb2YgdGhlIGlucHV0IHZhbHVlLCB3aGljaCBzaG91bGQgc3RpbGwgdXBkYXRlIHRoZSBzbGlkZXIKCgkJdmFyIHNlbGYgPSB0aGlzLAoJCQlwYXJlbnRUaGVtZSA9ICQubW9iaWxlLmdldEF0dHJpYnV0ZSggdGhpcy5lbGVtZW50WyAwIF0sICJ0aGVtZSIgKSwKCQkJdGhlbWUgPSB0aGlzLm9wdGlvbnMudGhlbWUgfHwgcGFyZW50VGhlbWUsCgkJCXRoZW1lQ2xhc3MgPSAgdGhlbWUgPyAiIHVpLWJ0bi0iICsgdGhlbWUgOiAiIiwKCQkJdHJhY2tUaGVtZSA9IHRoaXMub3B0aW9ucy50cmFja1RoZW1lIHx8IHBhcmVudFRoZW1lLAoJCQl0cmFja1RoZW1lQ2xhc3MgPSB0cmFja1RoZW1lID8gIiB1aS1iYXItIiArIHRyYWNrVGhlbWUgOiAiIHVpLWJhci1pbmhlcml0IiwKCQkJY29ybmVyQ2xhc3MgPSB0aGlzLm9wdGlvbnMuY29ybmVycyA/ICIgdWktY29ybmVyLWFsbCIgOiAiIiwKCQkJbWluaUNsYXNzID0gdGhpcy5vcHRpb25zLm1pbmkgPyAiIHVpLW1pbmkiIDogIiIsCgkJCWxlZnQsIHdpZHRoLCBkYXRhLCB0b2wsCgkJCXB4U3RlcCwgcGVyY2VudCwKCQkJY29udHJvbCwgaXNJbnB1dCwgb3B0aW9uRWxlbWVudHMsIG1pbiwgbWF4LCBzdGVwLAoJCQluZXd2YWwsIHZhbE1vZFN0ZXAsIGFsaWduVmFsdWUsIHBlcmNlbnRQZXJTdGVwLAoJCQloYW5kbGVQZXJjZW50LCBhUGVyY2VudCwgYlBlcmNlbnQsCgkJCXZhbHVlQ2hhbmdlZDsKCgkJc2VsZi5zbGlkZXJbMF0uY2xhc3NOYW1lID0gWyB0aGlzLmlzVG9nZ2xlU3dpdGNoID8gInVpLXNsaWRlciB1aS1zbGlkZXItc3dpdGNoIHVpLXNsaWRlci10cmFjayB1aS1zaGFkb3ctaW5zZXQiIDogInVpLXNsaWRlci10cmFjayB1aS1zaGFkb3ctaW5zZXQiLCB0cmFja1RoZW1lQ2xhc3MsIGNvcm5lckNsYXNzLCBtaW5pQ2xhc3MgXS5qb2luKCAiIiApOwoJCWlmICggdGhpcy5vcHRpb25zLmRpc2FibGVkIHx8IHRoaXMuZWxlbWVudC5wcm9wKCAiZGlzYWJsZWQiICkgKSB7CgkJCXRoaXMuZGlzYWJsZSgpOwoJCX0KCgkJLy8gc2V0IHRoZSBzdG9yZWQgdmFsdWUgZm9yIGNvbXBhcmlzb24gbGF0ZXIKCQl0aGlzLnZhbHVlID0gdGhpcy5fdmFsdWUoKTsKCQlpZiAoIHRoaXMub3B0aW9ucy5oaWdobGlnaHQgJiYgIXRoaXMuaXNUb2dnbGVTd2l0Y2ggJiYgdGhpcy5zbGlkZXIuZmluZCggIi51aS1zbGlkZXItYmciICkubGVuZ3RoID09PSAwICkgewoJCQl0aGlzLnZhbHVlYmcgPSAoZnVuY3Rpb24oKSB7CgkJCQl2YXIgYmcgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiZGl2IiApOwoJCQkJYmcuY2xhc3NOYW1lID0gInVpLXNsaWRlci1iZyAiICsgJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3M7CgkJCQlyZXR1cm4gJCggYmcgKS5wcmVwZW5kVG8oIHNlbGYuc2xpZGVyICk7CgkJCX0pKCk7CgkJfQoJCXRoaXMuaGFuZGxlLmFkZENsYXNzKCAidWktYnRuIiArIHRoZW1lQ2xhc3MgKyAiIHVpLXNoYWRvdyIgKTsKCgkJY29udHJvbCA9IHRoaXMuZWxlbWVudDsKCQlpc0lucHV0ID0gIXRoaXMuaXNUb2dnbGVTd2l0Y2g7CgkJb3B0aW9uRWxlbWVudHMgPSBpc0lucHV0ID8gW10gOiBjb250cm9sLmZpbmQoICJvcHRpb24iICk7CgkJbWluID0gIGlzSW5wdXQgPyBwYXJzZUZsb2F0KCBjb250cm9sLmF0dHIoICJtaW4iICkgKSA6IDA7CgkJbWF4ID0gaXNJbnB1dCA/IHBhcnNlRmxvYXQoIGNvbnRyb2wuYXR0ciggIm1heCIgKSApIDogb3B0aW9uRWxlbWVudHMubGVuZ3RoIC0gMTsKCQlzdGVwID0gKCBpc0lucHV0ICYmIHBhcnNlRmxvYXQoIGNvbnRyb2wuYXR0ciggInN0ZXAiICkgKSA+IDAgKSA/IHBhcnNlRmxvYXQoIGNvbnRyb2wuYXR0ciggInN0ZXAiICkgKSA6IDE7CgoJCWlmICggdHlwZW9mIHZhbCA9PT0gIm9iamVjdCIgKSB7CgkJCWRhdGEgPSB2YWw7CgkJCS8vIGEgc2xpZ2h0IHRvbGVyYW5jZSBoZWxwZWQgZ2V0IHRvIHRoZSBlbmRzIG9mIHRoZSBzbGlkZXIKCQkJdG9sID0gODsKCgkJCWxlZnQgPSB0aGlzLnNsaWRlci5vZmZzZXQoKS5sZWZ0OwoJCQl3aWR0aCA9IHRoaXMuc2xpZGVyLndpZHRoKCk7CgkJCXB4U3RlcCA9IHdpZHRoLygobWF4LW1pbikvc3RlcCk7CgkJCWlmICggIXRoaXMuZHJhZ2dpbmcgfHwKCQkJCQlkYXRhLnBhZ2VYIDwgbGVmdCAtIHRvbCB8fAoJCQkJCWRhdGEucGFnZVggPiBsZWZ0ICsgd2lkdGggKyB0b2wgKSB7CgkJCQlyZXR1cm47CgkJCX0KCQkJaWYgKCBweFN0ZXAgPiAxICkgewoJCQkJcGVyY2VudCA9ICggKCBkYXRhLnBhZ2VYIC0gbGVmdCApIC8gd2lkdGggKSAqIDEwMDsKCQkJfSBlbHNlIHsKCQkJCXBlcmNlbnQgPSBNYXRoLnJvdW5kKCAoICggZGF0YS5wYWdlWCAtIGxlZnQgKSAvIHdpZHRoICkgKiAxMDAgKTsKCQkJfQoJCX0gZWxzZSB7CgkJCWlmICggdmFsID09IG51bGwgKSB7CgkJCQl2YWwgPSBpc0lucHV0ID8gcGFyc2VGbG9hdCggY29udHJvbC52YWwoKSB8fCAwICkgOiBjb250cm9sWzBdLnNlbGVjdGVkSW5kZXg7CgkJCX0KCQkJcGVyY2VudCA9ICggcGFyc2VGbG9hdCggdmFsICkgLSBtaW4gKSAvICggbWF4IC0gbWluICkgKiAxMDA7CgkJfQoKCQlpZiAoIGlzTmFOKCBwZXJjZW50ICkgKSB7CgkJCXJldHVybjsKCQl9CgoJCW5ld3ZhbCA9ICggcGVyY2VudCAvIDEwMCApICogKCBtYXggLSBtaW4gKSArIG1pbjsKCgkJLy9mcm9tIGpRdWVyeSBVSSBzbGlkZXIsIHRoZSBmb2xsb3dpbmcgc291cmNlIHdpbGwgcm91bmQgdG8gdGhlIG5lYXJlc3Qgc3RlcAoJCXZhbE1vZFN0ZXAgPSAoIG5ld3ZhbCAtIG1pbiApICUgc3RlcDsKCQlhbGlnblZhbHVlID0gbmV3dmFsIC0gdmFsTW9kU3RlcDsKCgkJaWYgKCBNYXRoLmFicyggdmFsTW9kU3RlcCApICogMiA+PSBzdGVwICkgewoJCQlhbGlnblZhbHVlICs9ICggdmFsTW9kU3RlcCA+IDAgKSA/IHN0ZXAgOiAoIC1zdGVwICk7CgkJfQoKCQlwZXJjZW50UGVyU3RlcCA9IDEwMC8oKG1heC1taW4pL3N0ZXApOwoJCS8vIFNpbmNlIEphdmFTY3JpcHQgaGFzIHByb2JsZW1zIHdpdGggbGFyZ2UgZmxvYXRzLCByb3VuZAoJCS8vIHRoZSBmaW5hbCB2YWx1ZSB0byA1IGRpZ2l0cyBhZnRlciB0aGUgZGVjaW1hbCBwb2ludCAoc2VlIGpRdWVyeVVJOiAjNDEyNCkKCQluZXd2YWwgPSBwYXJzZUZsb2F0KCBhbGlnblZhbHVlLnRvRml4ZWQoNSkgKTsKCgkJaWYgKCB0eXBlb2YgcHhTdGVwID09PSAidW5kZWZpbmVkIiApIHsKCQkJcHhTdGVwID0gd2lkdGggLyAoIChtYXgtbWluKSAvIHN0ZXAgKTsKCQl9CgkJaWYgKCBweFN0ZXAgPiAxICYmIGlzSW5wdXQgKSB7CgkJCXBlcmNlbnQgPSAoIG5ld3ZhbCAtIG1pbiApICogcGVyY2VudFBlclN0ZXAgKiAoIDEgLyBzdGVwICk7CgkJfQoJCWlmICggcGVyY2VudCA8IDAgKSB7CgkJCXBlcmNlbnQgPSAwOwoJCX0KCgkJaWYgKCBwZXJjZW50ID4gMTAwICkgewoJCQlwZXJjZW50ID0gMTAwOwoJCX0KCgkJaWYgKCBuZXd2YWwgPCBtaW4gKSB7CgkJCW5ld3ZhbCA9IG1pbjsKCQl9CgoJCWlmICggbmV3dmFsID4gbWF4ICkgewoJCQluZXd2YWwgPSBtYXg7CgkJfQoKCQl0aGlzLmhhbmRsZS5jc3MoICJsZWZ0IiwgcGVyY2VudCArICIlIiApOwoKCQl0aGlzLmhhbmRsZVswXS5zZXRBdHRyaWJ1dGUoICJhcmlhLXZhbHVlbm93IiwgaXNJbnB1dCA/IG5ld3ZhbCA6IG9wdGlvbkVsZW1lbnRzLmVxKCBuZXd2YWwgKS5hdHRyKCAidmFsdWUiICkgKTsKCgkJdGhpcy5oYW5kbGVbMF0uc2V0QXR0cmlidXRlKCAiYXJpYS12YWx1ZXRleHQiLCBpc0lucHV0ID8gbmV3dmFsIDogb3B0aW9uRWxlbWVudHMuZXEoIG5ld3ZhbCApLmdldEVuY29kZWRUZXh0KCkgKTsKCgkJdGhpcy5oYW5kbGVbMF0uc2V0QXR0cmlidXRlKCAidGl0bGUiLCBpc0lucHV0ID8gbmV3dmFsIDogb3B0aW9uRWxlbWVudHMuZXEoIG5ld3ZhbCApLmdldEVuY29kZWRUZXh0KCkgKTsKCgkJaWYgKCB0aGlzLnZhbHVlYmcgKSB7CgkJCXRoaXMudmFsdWViZy5jc3MoICJ3aWR0aCIsIHBlcmNlbnQgKyAiJSIgKTsKCQl9CgoJCS8vIGRyYWcgdGhlIGxhYmVsIHdpZHRocwoJCWlmICggdGhpcy5fbGFiZWxzICkgewoJCQloYW5kbGVQZXJjZW50ID0gdGhpcy5oYW5kbGUud2lkdGgoKSAvIHRoaXMuc2xpZGVyLndpZHRoKCkgKiAxMDA7CgkJCWFQZXJjZW50ID0gcGVyY2VudCAmJiBoYW5kbGVQZXJjZW50ICsgKCAxMDAgLSBoYW5kbGVQZXJjZW50ICkgKiBwZXJjZW50IC8gMTAwOwoJCQliUGVyY2VudCA9IHBlcmNlbnQgPT09IDEwMCA/IDAgOiBNYXRoLm1pbiggaGFuZGxlUGVyY2VudCArIDEwMCAtIGFQZXJjZW50LCAxMDAgKTsKCgkJCXRoaXMuX2xhYmVscy5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJdmFyIGFiID0gJCggdGhpcyApLmhhc0NsYXNzKCAidWktc2xpZGVyLWxhYmVsLWEiICk7CgkJCQkkKCB0aGlzICkud2lkdGgoICggYWIgPyBhUGVyY2VudCA6IGJQZXJjZW50ICApICsgIiUiICk7CgkJCX0pOwoJCX0KCgkJaWYgKCAhcHJldmVudElucHV0VXBkYXRlICkgewoJCQl2YWx1ZUNoYW5nZWQgPSBmYWxzZTsKCgkJCS8vIHVwZGF0ZSBjb250cm9sInMgdmFsdWUKCQkJaWYgKCBpc0lucHV0ICkgewoJCQkJdmFsdWVDaGFuZ2VkID0gY29udHJvbC52YWwoKSAhPT0gbmV3dmFsOwoJCQkJY29udHJvbC52YWwoIG5ld3ZhbCApOwoJCQl9IGVsc2UgewoJCQkJdmFsdWVDaGFuZ2VkID0gY29udHJvbFsgMCBdLnNlbGVjdGVkSW5kZXggIT09IG5ld3ZhbDsKCQkJCWNvbnRyb2xbIDAgXS5zZWxlY3RlZEluZGV4ID0gbmV3dmFsOwoJCQl9CgkJCWlmICggdGhpcy5fdHJpZ2dlciggImJlZm9yZWNoYW5nZSIsIHZhbCApID09PSBmYWxzZSkgewoJCQkJCXJldHVybiBmYWxzZTsKCQkJfQoJCQlpZiAoICFpc2Zyb21Db250cm9sICYmIHZhbHVlQ2hhbmdlZCApIHsKCQkJCWNvbnRyb2wudHJpZ2dlciggImNoYW5nZSIgKTsKCQkJfQoJCX0KCX0sCgoJX3NldEhpZ2hsaWdodDogZnVuY3Rpb24oIHZhbHVlICkgewoJCXZhbHVlID0gISF2YWx1ZTsKCQlpZiAoIHZhbHVlICkgewoJCQl0aGlzLm9wdGlvbnMuaGlnaGxpZ2h0ID0gISF2YWx1ZTsKCQkJdGhpcy5yZWZyZXNoKCk7CgkJfSBlbHNlIGlmICggdGhpcy52YWx1ZWJnICkgewoJCQl0aGlzLnZhbHVlYmcucmVtb3ZlKCk7CgkJCXRoaXMudmFsdWViZyA9IGZhbHNlOwoJCX0KCX0sCgoJX3NldFRoZW1lOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJdGhpcy5oYW5kbGUKCQkJLnJlbW92ZUNsYXNzKCAidWktYnRuLSIgKyB0aGlzLm9wdGlvbnMudGhlbWUgKQoJCQkuYWRkQ2xhc3MoICJ1aS1idG4tIiArIHZhbHVlICk7CgoJCXZhciBjdXJyZW50VGhlbWUgPSB0aGlzLm9wdGlvbnMudGhlbWUgPyB0aGlzLm9wdGlvbnMudGhlbWUgOiAiaW5oZXJpdCIsCgkJCW5ld1RoZW1lID0gdmFsdWUgPyB2YWx1ZSA6ICJpbmhlcml0IjsKCgkJdGhpcy5jb250cm9sCgkJCS5yZW1vdmVDbGFzcyggInVpLWJvZHktIiArIGN1cnJlbnRUaGVtZSApCgkJCS5hZGRDbGFzcyggInVpLWJvZHktIiArIG5ld1RoZW1lICk7Cgl9LAoKCV9zZXRUcmFja1RoZW1lOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJdmFyIGN1cnJlbnRUcmFja1RoZW1lID0gdGhpcy5vcHRpb25zLnRyYWNrVGhlbWUgPyB0aGlzLm9wdGlvbnMudHJhY2tUaGVtZSA6ICJpbmhlcml0IiwKCQkJbmV3VHJhY2tUaGVtZSA9IHZhbHVlID8gdmFsdWUgOiAiaW5oZXJpdCI7CgoJCXRoaXMuc2xpZGVyCgkJCS5yZW1vdmVDbGFzcyggInVpLWJvZHktIiArIGN1cnJlbnRUcmFja1RoZW1lICkKCQkJLmFkZENsYXNzKCAidWktYm9keS0iICsgbmV3VHJhY2tUaGVtZSApOwoJfSwKCglfc2V0TWluaTogZnVuY3Rpb24oIHZhbHVlICkgewoJCXZhbHVlID0gISF2YWx1ZTsKCQlpZiAoICF0aGlzLmlzVG9nZ2xlU3dpdGNoICYmICF0aGlzLmlzUmFuZ2VzbGlkZXIgKSB7CgkJCXRoaXMuc2xpZGVyLnBhcmVudCgpLnRvZ2dsZUNsYXNzKCAidWktbWluaSIsIHZhbHVlICk7CgkJCXRoaXMuZWxlbWVudC50b2dnbGVDbGFzcyggInVpLW1pbmkiLCB2YWx1ZSApOwoJCX0KCQl0aGlzLnNsaWRlci50b2dnbGVDbGFzcyggInVpLW1pbmkiLCB2YWx1ZSApOwoJfSwKCglfc2V0Q29ybmVyczogZnVuY3Rpb24oIHZhbHVlICkgewoJCXRoaXMuc2xpZGVyLnRvZ2dsZUNsYXNzKCAidWktY29ybmVyLWFsbCIsIHZhbHVlICk7CgoJCWlmICggIXRoaXMuaXNUb2dnbGVTd2l0Y2ggKSB7CgkJCXRoaXMuY29udHJvbC50b2dnbGVDbGFzcyggInVpLWNvcm5lci1hbGwiLCB2YWx1ZSApOwoJCX0KCX0sCgoJX3NldERpc2FibGVkOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJdmFsdWUgPSAhIXZhbHVlOwoJCXRoaXMuZWxlbWVudC5wcm9wKCAiZGlzYWJsZWQiLCB2YWx1ZSApOwoJCXRoaXMuc2xpZGVyLnRvZ2dsZUNsYXNzKCAidWktc3RhdGUtZGlzYWJsZWQiICkuYXR0ciggImFyaWEtZGlzYWJsZWQiLCB2YWx1ZSApOwoJfQoKfSwgJC5tb2JpbGUuYmVoYXZpb3JzLmZvcm1SZXNldCApICk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCnZhciBwb3B1cDsKCmZ1bmN0aW9uIGdldFBvcHVwKCkgewoJaWYgKCAhcG9wdXAgKSB7CgkJcG9wdXAgPSAkKCAiPGRpdj48L2Rpdj4iLCB7CgkJCSJjbGFzcyI6ICJ1aS1zbGlkZXItcG9wdXAgdWktc2hhZG93IHVpLWNvcm5lci1hbGwiCgkJfSk7Cgl9CglyZXR1cm4gcG9wdXAuY2xvbmUoKTsKfQoKJC53aWRnZXQoICJtb2JpbGUuc2xpZGVyIiwgJC5tb2JpbGUuc2xpZGVyLCB7CglvcHRpb25zOiB7CgkJcG9wdXBFbmFibGVkOiBmYWxzZSwKCQlzaG93VmFsdWU6IGZhbHNlCgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3N1cGVyKCk7CgoJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCV9jdXJyZW50VmFsdWU6IG51bGwsCgkJCV9wb3B1cDogbnVsbCwKCQkJX3BvcHVwVmlzaWJsZTogZmFsc2UKCQl9KTsKCgkJdGhpcy5fc2V0T3B0aW9uKCAicG9wdXBFbmFibGVkIiwgdGhpcy5vcHRpb25zLnBvcHVwRW5hYmxlZCApOwoKCQl0aGlzLl9vbiggdGhpcy5oYW5kbGUsIHsgInZtb3VzZWRvd24iIDogIl9zaG93UG9wdXAiIH0gKTsKCQl0aGlzLl9vbiggdGhpcy5zbGlkZXIuYWRkKCB0aGlzLmRvY3VtZW50ICksIHsgInZtb3VzZXVwIiA6ICJfaGlkZVBvcHVwIiB9ICk7CgkJdGhpcy5fcmVmcmVzaCgpOwoJfSwKCgkvLyBwb3NpdGlvbiB0aGUgcG9wdXAgY2VudGVyZWQgNXB4IGFib3ZlIHRoZSBoYW5kbGUKCV9wb3NpdGlvblBvcHVwOiBmdW5jdGlvbigpIHsKCQl2YXIgZHN0T2Zmc2V0ID0gdGhpcy5oYW5kbGUub2Zmc2V0KCk7CgoJCXRoaXMuX3BvcHVwLm9mZnNldCggewoJCQlsZWZ0OiBkc3RPZmZzZXQubGVmdCArICggdGhpcy5oYW5kbGUud2lkdGgoKSAtIHRoaXMuX3BvcHVwLndpZHRoKCkgKSAvIDIsCgkJCXRvcDogZHN0T2Zmc2V0LnRvcCAtIHRoaXMuX3BvcHVwLm91dGVySGVpZ2h0KCkgLSA1CgkJfSk7Cgl9LAoKCV9zZXRPcHRpb246IGZ1bmN0aW9uKCBrZXksIHZhbHVlICkgewoJCXRoaXMuX3N1cGVyKCBrZXksIHZhbHVlICk7CgoJCWlmICgga2V5ID09PSAic2hvd1ZhbHVlIiApIHsKCQkJdGhpcy5oYW5kbGUuaHRtbCggdmFsdWUgJiYgIXRoaXMub3B0aW9ucy5taW5pID8gdGhpcy5fdmFsdWUoKSA6ICIiICk7CgkJfSBlbHNlIGlmICgga2V5ID09PSAicG9wdXBFbmFibGVkIiApIHsKCQkJaWYgKCB2YWx1ZSAmJiAhdGhpcy5fcG9wdXAgKSB7CgkJCQl0aGlzLl9wb3B1cCA9IGdldFBvcHVwKCkKCQkJCQkuYWRkQ2xhc3MoICJ1aS1ib2R5LSIgKyAoIHRoaXMub3B0aW9ucy50aGVtZSB8fCAiYSIgKSApCgkJCQkJLmluc2VydEJlZm9yZSggdGhpcy5lbGVtZW50ICk7CgkJCX0KCQl9Cgl9LAoKCS8vIHNob3cgdmFsdWUgb24gdGhlIGhhbmRsZSBhbmQgaW4gcG9wdXAKCXJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3N1cGVyLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsKCQl0aGlzLl9yZWZyZXNoKCk7Cgl9LAoKCV9yZWZyZXNoOiBmdW5jdGlvbigpIHsKCQl2YXIgbyA9IHRoaXMub3B0aW9ucywgbmV3VmFsdWU7CgoJCWlmICggby5wb3B1cEVuYWJsZWQgKSB7CgkJCS8vIHJlbW92ZSB0aGUgdGl0bGUgYXR0cmlidXRlIGZyb20gdGhlIGhhbmRsZSAod2hpY2ggaXMKCQkJLy8gcmVzcG9uc2libGUgZm9yIHRoZSBhbm5veWluZyB0b29sdGlwKTsgTkIgd2UgaGF2ZQoJCQkvLyB0byBkbyBpdCBoZXJlIGFzIHRoZSBqcW0gc2xpZGVyIHNldHMgaXQgZXZlcnkgdGltZQoJCQkvLyB0aGUgc2xpZGVyJ3MgdmFsdWUgY2hhbmdlcyA6KAoJCQl0aGlzLmhhbmRsZS5yZW1vdmVBdHRyKCAidGl0bGUiICk7CgkJfQoKCQluZXdWYWx1ZSA9IHRoaXMuX3ZhbHVlKCk7CgkJaWYgKCBuZXdWYWx1ZSA9PT0gdGhpcy5fY3VycmVudFZhbHVlICkgewoJCQlyZXR1cm47CgkJfQoJCXRoaXMuX2N1cnJlbnRWYWx1ZSA9IG5ld1ZhbHVlOwoKCQlpZiAoIG8ucG9wdXBFbmFibGVkICYmIHRoaXMuX3BvcHVwICkgewoJCQl0aGlzLl9wb3NpdGlvblBvcHVwKCk7CgkJCXRoaXMuX3BvcHVwLmh0bWwoIG5ld1ZhbHVlICk7CgkJfSBlbHNlIGlmICggby5zaG93VmFsdWUgJiYgIXRoaXMub3B0aW9ucy5taW5pICkgewoJCQl0aGlzLmhhbmRsZS5odG1sKCBuZXdWYWx1ZSApOwoJCX0KCX0sCgoJX3Nob3dQb3B1cDogZnVuY3Rpb24oKSB7CgkJaWYgKCB0aGlzLm9wdGlvbnMucG9wdXBFbmFibGVkICYmICF0aGlzLl9wb3B1cFZpc2libGUgKSB7CgkJCXRoaXMuaGFuZGxlLmh0bWwoICIiICk7CgkJCXRoaXMuX3BvcHVwLnNob3coKTsKCQkJdGhpcy5fcG9zaXRpb25Qb3B1cCgpOwoJCQl0aGlzLl9wb3B1cFZpc2libGUgPSB0cnVlOwoJCX0KCX0sCgoJX2hpZGVQb3B1cDogZnVuY3Rpb24oKSB7CgkJdmFyIG8gPSB0aGlzLm9wdGlvbnM7CgoJCWlmICggby5wb3B1cEVuYWJsZWQgJiYgdGhpcy5fcG9wdXBWaXNpYmxlICkgewoJCQlpZiAoIG8uc2hvd1ZhbHVlICYmICFvLm1pbmkgKSB7CgkJCQl0aGlzLmhhbmRsZS5odG1sKCB0aGlzLl92YWx1ZSgpICk7CgkJCX0KCQkJdGhpcy5fcG9wdXAuaGlkZSgpOwoJCQl0aGlzLl9wb3B1cFZpc2libGUgPSBmYWxzZTsKCQl9Cgl9Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS5mbGlwc3dpdGNoIiwgJC5leHRlbmQoewoKCW9wdGlvbnM6IHsKCQlvblRleHQ6ICJPbiIsCgkJb2ZmVGV4dDogIk9mZiIsCgkJdGhlbWU6IG51bGwsCgkJZW5oYW5jZWQ6IGZhbHNlLAoJCXdyYXBwZXJDbGFzczogbnVsbCwKCQltaW5pOiBmYWxzZQoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQkJaWYgKCAhdGhpcy5vcHRpb25zLmVuaGFuY2VkICkgewoJCQkJdGhpcy5fZW5oYW5jZSgpOwoJCQl9IGVsc2UgewoJCQkJJC5leHRlbmQoIHRoaXMsIHsKCQkJCQlmbGlwc3dpdGNoOiB0aGlzLmVsZW1lbnQucGFyZW50KCksCgkJCQkJb246IHRoaXMuZWxlbWVudC5maW5kKCAiLnVpLWZsaXBzd2l0Y2gtb24iICkuZXEoIDAgKSwKCQkJCQlvZmY6IHRoaXMuZWxlbWVudC5maW5kKCAiLnVpLWZsaXBzd2l0Y2gtb2ZmIiApLmVxKDApLAoJCQkJCXR5cGU6IHRoaXMuZWxlbWVudC5nZXQoIDAgKS50YWdOYW1lCgkJCQl9KTsKCQkJfQoKCQkJaWYoIHRoaXMuZWxlbWVudC5pcyggIjpkaXNhYmxlZCIgKSApewoJCQkJdGhpcy5fc2V0T3B0aW9ucyh7CgkJCQkJImRpc2FibGVkIjogdHJ1ZQoJCQkJfSk7CgkJCX0KCgkJCXRoaXMuX29uKCB0aGlzLmZsaXBzd2l0Y2gsIHsKCQkJCSJjbGljayI6ICJfdG9nZ2xlIiwKCQkJCSJzd2lwZWxlZnQiOiAiX2xlZnQiLAoJCQkJInN3aXBlcmlnaHQiOiAiX3JpZ2h0IgoJCQl9KTsKCgkJCXRoaXMuX29uKCB0aGlzLm9uLCB7CgkJCQkia2V5ZG93biI6ICJfa2V5ZG93biIKCQkJfSk7Cgl9LAoKCXdpZGdldDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuZmxpcHN3aXRjaDsKCX0sCgoJX2xlZnQ6IGZ1bmN0aW9uKCkgewoJCXRoaXMuZmxpcHN3aXRjaC5yZW1vdmVDbGFzcyggInVpLWZsaXBzd2l0Y2gtYWN0aXZlIiApOwoJCWlmICggdGhpcy50eXBlID09PSAiU0VMRUNUIiApIHsKCQkJdGhpcy5lbGVtZW50LmdldCggMCApLnNlbGVjdGVkSW5kZXggPSAwOwoJCX0gZWxzZSB7CgkJCXRoaXMuZWxlbWVudC5wcm9wKCAiY2hlY2tlZCIsIHRydWUgKTsKCQl9CgkJdGhpcy5fdHJpZ2dlciggImNoYW5nZSIgKTsKCX0sCgoJX3JpZ2h0OiBmdW5jdGlvbigpIHsKCQl0aGlzLmZsaXBzd2l0Y2guYWRkQ2xhc3MoICJ1aS1mbGlwc3dpdGNoLWFjdGl2ZSIgKTsKCQlpZiAoIHRoaXMudHlwZSA9PT0gIlNFTEVDVCIgKSB7CgkJCXRoaXMuZWxlbWVudC5nZXQoIDAgKS5zZWxlY3RlZEluZGV4ID0gMTsKCQl9IGVsc2UgewoJCQl0aGlzLmVsZW1lbnQucHJvcCggImNoZWNrZWQiLCBmYWxzZSApOwoJCX0KCQl0aGlzLl90cmlnZ2VyKCAiY2hhbmdlIiApOwoJfSwKCglfZW5oYW5jZTogZnVuY3Rpb24oKSB7CgkJdmFyIGZsaXBzd2l0Y2ggPSAkKCAiPGRpdj4iICksCgkJCXRoZW1lID0gdGhpcy5vcHRpb25zLnRoZW1lID8gdGhpcy5vcHRpb25zLnRoZW1lIDogImluaGVyaXQiLAoJCQlvbiA9ICQoICI8c3BhbiB0YWJpbmRleD0nMSc+PC9zcGFuPiIgKSwKCQkJb2ZmID0gJCggIjxzcGFuPjwvc3Bhbj4iICksCgkJCXR5cGUgPSB0aGlzLmVsZW1lbnQuZ2V0KCAwICkudGFnTmFtZSwKCQkJb25UZXh0ID0gKCB0eXBlID09PSAiSU5QVVQiICkgPyB0aGlzLm9wdGlvbnMub25UZXh0IDogdGhpcy5lbGVtZW50LmZpbmQoICJvcHRpb24iICkuZXEoIDEgKS50ZXh0KCksCgkJCW9mZlRleHQgPSAoIHR5cGUgPT09ICJJTlBVVCIgKSA/IHRoaXMub3B0aW9ucy5vZmZUZXh0IDogdGhpcy5lbGVtZW50LmZpbmQoICJvcHRpb24iICkuZXEoIDAgKS50ZXh0KCk7CgoJCQlvbi5hZGRDbGFzcyggInVpLWZsaXBzd2l0Y2gtb24gdWktYnRuIHVpLXNoYWRvdyB1aS1idG4taW5oZXJpdCIgKS50ZXh0KCBvblRleHQgKTsKCQkJb2ZmLmFkZENsYXNzKCAidWktZmxpcHN3aXRjaC1vZmYiICkudGV4dCggb2ZmVGV4dCApOwoJCQkKCQkJZmxpcHN3aXRjaC5hZGRDbGFzcyggInVpLWZsaXBzd2l0Y2ggdWktc2hhZG93LWluc2V0IHVpLWNvcm5lci1hbGwgdWktYmFyLSIgKyB0aGVtZSArICIgIiArICggdGhpcy5vcHRpb25zLndyYXBwZXJDbGFzcyA/IHRoaXMub3B0aW9ucy53cmFwcGVyQ2xhc3MgOiAiIiApICsgIiAiICsgKCAoIHRoaXMuZWxlbWVudC5pcyggIjpjaGVja2VkIiApIHx8IHRoaXMuZWxlbWVudC5maW5kKCJvcHRpb24iKS5lcSgxKS5pcygiOnNlbGVjdGVkIikgKSA/ICJ1aS1mbGlwc3dpdGNoLWFjdGl2ZSIgOiAiIiApICsgKCB0aGlzLmVsZW1lbnQuaXMoIjpkaXNhYmxlZCIpID8gIiB1aS1zdGF0ZS1kaXNhYmxlZCI6ICIiKSArICggdGhpcy5vcHRpb25zLm1pbmkgPyAiIHVpLW1pbmkiOiAiIiApICkuYXBwZW5kKCBvbiwgb2ZmICk7CgkJCQoJCQl0aGlzLmVsZW1lbnQuYWRkQ2xhc3MoICJ1aS1mbGlwc3dpdGNoLWlucHV0IiApOwoJCQl0aGlzLmVsZW1lbnQuYWZ0ZXIoIGZsaXBzd2l0Y2ggKS5hcHBlbmRUbyggZmxpcHN3aXRjaCApOwoKCQkkLmV4dGVuZCggdGhpcywgewoJCQlmbGlwc3dpdGNoOiBmbGlwc3dpdGNoLAoJCQlvbjogb24sCgkJCW9mZjogb2ZmLAoJCQl0eXBlOiB0eXBlCgkJfSk7Cgl9LAoKCV9jaGFuZ2U6IGZ1bmN0aW9uKCkgewoJCXZhciBkaXJlY3Rpb247CgkJCgkJaWYgKCB0aGlzLnR5cGUgPT09ICJTRUxFQ1QiICkgewoJCQlkaXJlY3Rpb24gPSAoIHRoaXMuZWxlbWVudC5nZXQoIDAgKS5zZWxlY3RlZEluZGV4ID4gMCApPyAiX3JpZ2h0IjogIl9sZWZ0IjsKCQl9IGVsc2UgewoJCQlkaXJlY3Rpb24gPSB0aGlzLmVsZW1lbnQuaXMoICI6Y2hlY2tlZCIgKT8gIl9yaWdodCI6ICJfbGVmdCI7CgkJfQoJCXRoaXNbIGRpcmVjdGlvbiBdKCk7Cgl9LAoKCV90b2dnbGU6IGZ1bmN0aW9uKCkgewoJCXZhciBkaXJlY3Rpb24gPSB0aGlzLmZsaXBzd2l0Y2guaGFzQ2xhc3MoICJ1aS1mbGlwc3dpdGNoLWFjdGl2ZSIgKSA/ICJfbGVmdCIgOiAiX3JpZ2h0IjsKCQkKCQl0aGlzW2RpcmVjdGlvbl0oKTsKCX0sCgoJX2tleWRvd246IGZ1bmN0aW9uKCBlICkgewoJCWlmICggZS53aGljaCA9PT0gJC5tb2JpbGUua2V5Q29kZS5MRUZUICkgewoJCQl0aGlzLl9sZWZ0KCk7CgkJfSBlbHNlIGlmICggZS53aGljaCA9PT0gJC5tb2JpbGUua2V5Q29kZS5SSUdIVCApIHsKCQkJdGhpcy5fcmlnaHQoKTsKCQl9IGVsc2UgaWYgKCBlLndoaWNoID09PSAkLm1vYmlsZS5rZXlDb2RlLlNQQUNFICkgewoJCQl0aGlzLl90b2dnbGUoKTsKCQkJZS5wcmV2ZW50RGVmYXVsdCgpOwoJCX0KCX0sCgoJX3NldE9wdGlvbnM6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCWlmICggb3B0aW9ucy50aGVtZSAhPT0gdW5kZWZpbmVkICkgewoJCQl2YXIgY3VycmVudFRoZW1lID0gb3B0aW9ucy50aGVtZSA/IG9wdGlvbnMudGhlbWUgOiAiaW5oZXJpdCIsCgkJCQluZXdUaGVtZSA9IG9wdGlvbnMudGhlbWUgPyBvcHRpb25zLnRoZW1lIDogImluaGVyaXQiOwoKCQkJdGhpcy53aWRnZXQoKQoJCQkJLnJlbW92ZUNsYXNzKCAidWktYmFyLSIgKyBjdXJyZW50VGhlbWUgKQoJCQkJLmFkZENsYXNzKCAidWktYmFyLSIgKyBuZXdUaGVtZSApOwoJCX0KCQlpZiAoIG9wdGlvbnMub25UZXh0ICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMub24udGV4dCggb3B0aW9ucy5vblRleHQgKTsKCQl9CgkJaWYgKCBvcHRpb25zLm9mZlRleHQgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhpcy5vZmYudGV4dCggb3B0aW9ucy5vZmZUZXh0ICk7CgkJfQoJCWlmICggb3B0aW9ucy5kaXNhYmxlZCAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLndpZGdldCgpLnRvZ2dsZUNsYXNzKCAidWktc3RhdGUtZGlzYWJsZWQiLCBvcHRpb25zLmRpc2FibGVkICk7CgkJfQoJCWlmKCBvcHRpb25zLm1pbmkgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhpcy53aWRnZXQoKS50b2dnbGVDbGFzcyggInVpLW1pbmkiLCBvcHRpb25zLm1pbmkgKTsKCQl9CgkJCgkJdGhpcy5fc3VwZXIoIG9wdGlvbnMgKTsKCX0sCgoJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCWlmICggdGhpcy5vcHRpb25zLmVuaGFuY2VkICkgewoJCQlyZXR1cm47CgkJfQoJCXRoaXMub24ucmVtb3ZlKCk7CgkJdGhpcy5vZmYucmVtb3ZlKCk7CgkJdGhpcy5lbGVtZW50LnVud3JhcCgpOwoJCXRoaXMuZmxpcHN3aXRjaC5yZW1vdmUoKTsKCQl0aGlzLnJlbW92ZUNsYXNzKCAidWktZmxpcHN3aXRjaC1pbnB1dCIgKTsKCX0KCn0sICQubW9iaWxlLmJlaGF2aW9ycy5mb3JtUmVzZXQgKSApOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgkkLndpZGdldCggIm1vYmlsZS5yYW5nZXNsaWRlciIsICQuZXh0ZW5kKCB7CgoJCW9wdGlvbnM6IHsKCQkJdGhlbWU6IG51bGwsCgkJCXRyYWNrVGhlbWU6IG51bGwsCgkJCWNvcm5lcnM6IHRydWUsCgkJCW1pbmk6IGZhbHNlLAoJCQloaWdobGlnaHQ6IHRydWUKCQl9LAoKCQlfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQkJdmFyICRlbCA9IHRoaXMuZWxlbWVudCwKCQkJZWxDbGFzcyA9IHRoaXMub3B0aW9ucy5taW5pID8gInVpLXJhbmdlc2xpZGVyIHVpLW1pbmkiIDogInVpLXJhbmdlc2xpZGVyIiwKCQkJX2lucHV0Rmlyc3QgPSAkZWwuZmluZCggImlucHV0IiApLmZpcnN0KCksCgkJCV9pbnB1dExhc3QgPSAkZWwuZmluZCggImlucHV0IiApLmxhc3QoKSwKCQkJX2xhYmVsID0gJGVsLmZpbmQoICJsYWJlbCIgKS5maXJzdCgpLAoJCQlfc2xpZGVyRmlyc3QgPSAkLmRhdGEoIF9pbnB1dEZpcnN0LmdldCgwKSwgIm1vYmlsZS1zbGlkZXIiICkuc2xpZGVyLAoJCQlfc2xpZGVyTGFzdCA9ICQuZGF0YSggX2lucHV0TGFzdC5nZXQoMCksICJtb2JpbGUtc2xpZGVyIiApLnNsaWRlciwKCQkJZmlyc3RIYW5kbGUgPSAkLmRhdGEoIF9pbnB1dEZpcnN0LmdldCgwKSwgIm1vYmlsZS1zbGlkZXIiICkuaGFuZGxlLAoJCQlfc2xpZGVycyA9ICQoICI8ZGl2IGNsYXNzPSd1aS1yYW5nZXNsaWRlci1zbGlkZXJzJyAvPiIgKS5hcHBlbmRUbyggJGVsICk7CgoJCQlfaW5wdXRGaXJzdC5hZGRDbGFzcyggInVpLXJhbmdlc2xpZGVyLWZpcnN0IiApOwoJCQlfaW5wdXRMYXN0LmFkZENsYXNzKCAidWktcmFuZ2VzbGlkZXItbGFzdCIgKTsKCQkJJGVsLmFkZENsYXNzKCBlbENsYXNzICk7CgoJCQlfc2xpZGVyRmlyc3QuYXBwZW5kVG8oIF9zbGlkZXJzICk7CgkJCV9zbGlkZXJMYXN0LmFwcGVuZFRvKCBfc2xpZGVycyApOwoJCQlfbGFiZWwuaW5zZXJ0QmVmb3JlKCAkZWwgKTsKCQkJZmlyc3RIYW5kbGUucHJlcGVuZFRvKCBfc2xpZGVyTGFzdCApOwoKCQkJJC5leHRlbmQoIHRoaXMsIHsKCQkJCV9pbnB1dEZpcnN0OiBfaW5wdXRGaXJzdCwKCQkJCV9pbnB1dExhc3Q6IF9pbnB1dExhc3QsCgkJCQlfc2xpZGVyRmlyc3Q6IF9zbGlkZXJGaXJzdCwKCQkJCV9zbGlkZXJMYXN0OiBfc2xpZGVyTGFzdCwKCQkJCV9sYWJlbDogX2xhYmVsLAoJCQkJX3RhcmdldFZhbDogbnVsbCwKCQkJCV9zbGlkZXJUYXJnZXQ6IGZhbHNlLAoJCQkJX3NsaWRlcnM6IF9zbGlkZXJzLAoJCQkJX3Byb3h5OiBmYWxzZQoJCQl9KTsKCgkJCXRoaXMucmVmcmVzaCgpOwoJCQl0aGlzLl9vbiggdGhpcy5lbGVtZW50LmZpbmQoICJpbnB1dC51aS1zbGlkZXItaW5wdXQiICksIHsKCQkJCSJzbGlkZWJlZm9yZXN0YXJ0IjogIl9zbGlkZWJlZm9yZXN0YXJ0IiwKCQkJCSJzbGlkZXN0b3AiOiAiX3NsaWRlc3RvcCIsCgkJCQkic2xpZGVkcmFnIjogIl9zbGlkZWRyYWciLAoJCQkJInNsaWRlYmVmb3JlY2hhbmdlIjogIl9jaGFuZ2UiLAoJCQkJImJsdXIiOiAiX2NoYW5nZSIsCgkJCQkia2V5dXAiOiAiX2NoYW5nZSIKCQkJfSk7CgkJCXRoaXMuX29uKHsKCQkJCSJtb3VzZWRvd24iOiJfY2hhbmdlIgoJCQl9KTsKCQkJdGhpcy5fb24oIHRoaXMuZWxlbWVudC5jbG9zZXN0KCAiZm9ybSIgKSwgewoJCQkJInJlc2V0IjoiX2hhbmRsZVJlc2V0IgoJCQl9KTsKCQkJdGhpcy5fb24oIGZpcnN0SGFuZGxlLCB7CgkJCQkidm1vdXNlZG93biI6ICJfZHJhZ0ZpcnN0SGFuZGxlIgoJCQl9KTsKCQl9LAoJCV9oYW5kbGVSZXNldDogZnVuY3Rpb24oKSB7CgkJCXZhciBzZWxmID0gdGhpczsKCQkJLy93ZSBtdXN0IHdhaXQgZm9yIHRoZSBzdGFjayB0byB1bndpbmQgYmVmb3JlIHVwZGF0ZWluZyBvdGhlciB3aXNlIHNsaWRlcnMgd2lsbCBub3QgaGF2ZSB1cGRhdGVkIHlldAoJCQlzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJCXNlbGYuX3VwZGF0ZUhpZ2hsaWdodCgpOwoJCQl9LDApOwoJCX0sCgoJCV9kcmFnRmlyc3RIYW5kbGU6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJLy9pZiB0aGUgZmlyc3QgaGFuZGxlIGlzIGRyYWdnZWQgc2VuZCB0aGUgZXZlbnQgdG8gdGhlIGZpcnN0IHNsaWRlcgoJCQkkLmRhdGEoIHRoaXMuX2lucHV0Rmlyc3QuZ2V0KDApLCAibW9iaWxlLXNsaWRlciIgKS5kcmFnZ2luZyA9IHRydWU7CgkJCSQuZGF0YSggdGhpcy5faW5wdXRGaXJzdC5nZXQoMCksICJtb2JpbGUtc2xpZGVyIiApLnJlZnJlc2goIGV2ZW50ICk7CgkJCXJldHVybiBmYWxzZTsKCQl9LAoKCQlfc2xpZGVkcmFnOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciBmaXJzdCA9ICQoIGV2ZW50LnRhcmdldCApLmlzKCB0aGlzLl9pbnB1dEZpcnN0ICksCgkJCQlvdGhlclNsaWRlciA9ICggZmlyc3QgKSA/IHRoaXMuX2lucHV0TGFzdCA6IHRoaXMuX2lucHV0Rmlyc3Q7CgoJCQl0aGlzLl9zbGlkZXJUYXJnZXQgPSBmYWxzZTsKCQkJLy9pZiB0aGUgZHJhZyB3YXMgaW5pdGlhdGVkIG9uIGFuIGV4dHJlbWUgYW5kIHRoZSBvdGhlciBoYW5kbGUgaXMgZm9jdXNlZCBzZW5kIHRoZSBldmVudHMgdG8KCQkJLy90aGUgY2xvc2VzdCBoYW5kbGUKCQkJaWYgKCAoIHRoaXMuX3Byb3h5ID09PSAiZmlyc3QiICYmIGZpcnN0ICkgfHwgKCB0aGlzLl9wcm94eSA9PT0gImxhc3QiICYmICFmaXJzdCApICkgewoJCQkJJC5kYXRhKCBvdGhlclNsaWRlci5nZXQoMCksICJtb2JpbGUtc2xpZGVyIiApLmRyYWdnaW5nID0gdHJ1ZTsKCQkJCSQuZGF0YSggb3RoZXJTbGlkZXIuZ2V0KDApLCAibW9iaWxlLXNsaWRlciIgKS5yZWZyZXNoKCBldmVudCApOwoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgkJfSwKCgkJX3NsaWRlc3RvcDogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQl2YXIgZmlyc3QgPSAkKCBldmVudC50YXJnZXQgKS5pcyggdGhpcy5faW5wdXRGaXJzdCApOwoKCQkJdGhpcy5fcHJveHkgPSBmYWxzZTsKCQkJLy90aGlzIHN0b3BzIGRyYWdnaW5nIG9mIHRoZSBoYW5kbGUgYW5kIGJyaW5ncyB0aGUgYWN0aXZlIHRyYWNrIHRvIHRoZSBmcm9udAoJCQkvL3RoaXMgbWFrZXMgY2xpY2tzIG9uIHRoZSB0cmFjayBnbyB0aGUgdGhlIGxhc3QgaGFuZGxlIHVzZWQKCQkJdGhpcy5lbGVtZW50LmZpbmQoICJpbnB1dCIgKS50cmlnZ2VyKCAidm1vdXNldXAiICk7CgkJCXRoaXMuX3NsaWRlckZpcnN0LmNzcyggInotaW5kZXgiLCBmaXJzdCA/IDEgOiAiIiApOwoJCX0sCgoJCV9zbGlkZWJlZm9yZXN0YXJ0OiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXRoaXMuX3NsaWRlclRhcmdldCA9IGZhbHNlOwoJCQkvL2lmIHRoZSB0cmFjayBpcyB0aGUgdGFyZ2V0IHJlbWVtYmVyIHRoaXMgYW5kIHRoZSBvcmlnaW5hbCB2YWx1ZQoJCQlpZiAoICQoIGV2ZW50Lm9yaWdpbmFsRXZlbnQudGFyZ2V0ICkuaGFzQ2xhc3MoICJ1aS1zbGlkZXItdHJhY2siICkgKSB7CgkJCQl0aGlzLl9zbGlkZXJUYXJnZXQgPSB0cnVlOwoJCQkJdGhpcy5fdGFyZ2V0VmFsID0gJCggZXZlbnQudGFyZ2V0ICkudmFsKCk7CgkJCX0KCQl9LAoKCQlfc2V0T3B0aW9uczogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJCWlmICggb3B0aW9ucy50aGVtZSAhPT0gdW5kZWZpbmVkICkgewoJCQkJdGhpcy5fc2V0VGhlbWUoIG9wdGlvbnMudGhlbWUgKTsKCQkJfQoKCQkJaWYgKCBvcHRpb25zLnRyYWNrVGhlbWUgIT09IHVuZGVmaW5lZCApIHsKCQkJCXRoaXMuX3NldFRyYWNrVGhlbWUoIG9wdGlvbnMudHJhY2tUaGVtZSApOwoJCQl9CgoJCQlpZiAoIG9wdGlvbnMubWluaSAhPT0gdW5kZWZpbmVkICkgewoJCQkJdGhpcy5fc2V0TWluaSggb3B0aW9ucy5taW5pICk7CgkJCX0KCgkJCWlmICggb3B0aW9ucy5oaWdobGlnaHQgIT09IHVuZGVmaW5lZCApIHsKCQkJCXRoaXMuX3NldEhpZ2hsaWdodCggb3B0aW9ucy5oaWdobGlnaHQgKTsKCQkJfQoJCQl0aGlzLl9zdXBlciggb3B0aW9ucyApOwoJCQl0aGlzLnJlZnJlc2goKTsKCQl9LAoKCQlyZWZyZXNoOiBmdW5jdGlvbigpIHsKCQkJdmFyICRlbCA9IHRoaXMuZWxlbWVudCwKCQkJCW8gPSB0aGlzLm9wdGlvbnM7CgoJCQlpZiggdGhpcy5faW5wdXRGaXJzdC5pcyggIjpkaXNhYmxlZCIgKSB8fCB0aGlzLl9pbnB1dExhc3QuaXMoICI6ZGlzYWJsZWQiICkgKXsKCQkJCXRoaXMub3B0aW9ucy5kaXNhYmxlZCA9IHRydWU7CgkJCX0KCgkJCSRlbC5maW5kKCAiaW5wdXQiICkuc2xpZGVyKHsKCQkJCXRoZW1lOiBvLnRoZW1lLAoJCQkJdHJhY2tUaGVtZTogby50cmFja1RoZW1lLAoJCQkJZGlzYWJsZWQ6IG8uZGlzYWJsZWQsCgkJCQljb3JuZXJzOiBvLmNvcm5lcnMsCgkJCQltaW5pOiBvLm1pbmksCgkJCQloaWdobGlnaHQ6IG8uaGlnaGxpZ2h0CgkJCX0pLnNsaWRlciggInJlZnJlc2giICk7CgkJCXRoaXMuX3VwZGF0ZUhpZ2hsaWdodCgpOwoJCX0sCgoJCV9jaGFuZ2U6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJaWYgKCBldmVudC50eXBlID09PSAia2V5dXAiICkgewoJCQkJdGhpcy5fdXBkYXRlSGlnaGxpZ2h0KCk7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCgkJCXZhciBzZWxmID0gdGhpcywKCQkJCW1pbiA9IHBhcnNlRmxvYXQoIHRoaXMuX2lucHV0Rmlyc3QudmFsKCksIDEwICksCgkJCQltYXggPSBwYXJzZUZsb2F0KCB0aGlzLl9pbnB1dExhc3QudmFsKCksIDEwICksCgkJCQlmaXJzdCA9ICQoIGV2ZW50LnRhcmdldCApLmhhc0NsYXNzKCAidWktcmFuZ2VzbGlkZXItZmlyc3QiICksCgkJCQl0aGlzU2xpZGVyID0gZmlyc3QgPyB0aGlzLl9pbnB1dEZpcnN0IDogdGhpcy5faW5wdXRMYXN0LAoJCQkJb3RoZXJTbGlkZXIgPSBmaXJzdCA/IHRoaXMuX2lucHV0TGFzdCA6IHRoaXMuX2lucHV0Rmlyc3Q7CgoKCQkJaWYgKCAoIHRoaXMuX2lucHV0Rmlyc3QudmFsKCkgPiB0aGlzLl9pbnB1dExhc3QudmFsKCkgJiYgZXZlbnQudHlwZSA9PT0gIm1vdXNlZG93biIgJiYgISQoZXZlbnQudGFyZ2V0KS5oYXNDbGFzcygidWktc2xpZGVyLWhhbmRsZSIpKSApewoJCQkJdGhpc1NsaWRlci5ibHVyKCk7CgkJCX0gZWxzZSBpZiAoIGV2ZW50LnR5cGUgPT09ICJtb3VzZWRvd24iICl7CgkJCQlyZXR1cm47CgkJCX0KCQkJaWYgKCBtaW4gPiBtYXggJiYgIXRoaXMuX3NsaWRlclRhcmdldCApIHsKCQkJCS8vdGhpcyBwcmV2ZW50cyBtaW4gZnJvbSBiZWluZyBncmVhdGVyIHRoZW4gbWF4CgkJCQl0aGlzU2xpZGVyLnZhbCggZmlyc3QgPyBtYXg6IG1pbiApLnNsaWRlciggInJlZnJlc2giICk7CgkJCQl0aGlzLl90cmlnZ2VyKCAibm9ybWFsaXplIiApOwoJCQl9IGVsc2UgaWYgKCBtaW4gPiBtYXggKSB7CgkJCQkvL3RoaXMgbWFrZXMgaXQgc28gY2xpY2tzIG9uIHRoZSB0YXJnZXQgb24gZWl0aGVyIGV4dHJlbWUgZ28gdG8gdGhlIGNsb3Nlc3QgaGFuZGxlCgkJCQl0aGlzU2xpZGVyLnZhbCggdGhpcy5fdGFyZ2V0VmFsICkuc2xpZGVyKCAicmVmcmVzaCIgKTsKCgkJCQkvL1lvdSBtdXN0IHdhaXQgZm9yIHRoZSBzdGFjayB0byB1bndpbmQgc28gZmlyc3Qgc2xpZGVyIGlzIHVwZGF0ZWQgYmVmb3JlIHVwZGF0aW5nIHNlY29uZAoJCQkJc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQkJb3RoZXJTbGlkZXIudmFsKCBmaXJzdCA/IG1pbjogbWF4ICkuc2xpZGVyKCAicmVmcmVzaCIgKTsKCQkJCQkkLmRhdGEoIG90aGVyU2xpZGVyLmdldCgwKSwgIm1vYmlsZS1zbGlkZXIiICkuaGFuZGxlLmZvY3VzKCk7CgkJCQkJc2VsZi5fc2xpZGVyRmlyc3QuY3NzKCAiei1pbmRleCIsIGZpcnN0ID8gIiIgOiAxICk7CgkJCQkJc2VsZi5fdHJpZ2dlciggIm5vcm1hbGl6ZSIgKTsKCQkJCX0sIDAgKTsKCQkJCXRoaXMuX3Byb3h5ID0gKCBmaXJzdCApID8gImZpcnN0IiA6ICJsYXN0IjsKCQkJfQoJCQkvL2ZpeGVzIGlzc3VlIHdoZXJlIHdoZW4gYm90aCBfc2xpZGVycyBhcmUgYXQgbWluIHRoZXkgY2Fubm90IGJlIGFkanVzdGVkCgkJCWlmICggbWluID09PSBtYXggKSB7CgkJCQkkLmRhdGEoIHRoaXNTbGlkZXIuZ2V0KDApLCAibW9iaWxlLXNsaWRlciIgKS5oYW5kbGUuY3NzKCAiei1pbmRleCIsIDEgKTsKCQkJCSQuZGF0YSggb3RoZXJTbGlkZXIuZ2V0KDApLCAibW9iaWxlLXNsaWRlciIgKS5oYW5kbGUuY3NzKCAiei1pbmRleCIsIDAgKTsKCQkJfSBlbHNlIHsKCQkJCSQuZGF0YSggb3RoZXJTbGlkZXIuZ2V0KDApLCAibW9iaWxlLXNsaWRlciIgKS5oYW5kbGUuY3NzKCAiei1pbmRleCIsICIiICk7CgkJCQkkLmRhdGEoIHRoaXNTbGlkZXIuZ2V0KDApLCAibW9iaWxlLXNsaWRlciIgKS5oYW5kbGUuY3NzKCAiei1pbmRleCIsICIiICk7CgkJCX0KCgkJCXRoaXMuX3VwZGF0ZUhpZ2hsaWdodCgpOwoKCQkJaWYgKCBtaW4gPj0gbWF4ICkgewoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgkJfSwKCgkJX3VwZGF0ZUhpZ2hsaWdodDogZnVuY3Rpb24oKSB7CgkJCXZhciBtaW4gPSBwYXJzZUludCggJC5kYXRhKCB0aGlzLl9pbnB1dEZpcnN0LmdldCgwKSwgIm1vYmlsZS1zbGlkZXIiICkuaGFuZGxlLmdldCgwKS5zdHlsZS5sZWZ0LCAxMCApLAoJCQkJbWF4ID0gcGFyc2VJbnQoICQuZGF0YSggdGhpcy5faW5wdXRMYXN0LmdldCgwKSwgIm1vYmlsZS1zbGlkZXIiICkuaGFuZGxlLmdldCgwKS5zdHlsZS5sZWZ0LCAxMCApLAoJCQkJd2lkdGggPSAobWF4IC0gbWluKTsKCgkJCXRoaXMuZWxlbWVudC5maW5kKCAiLnVpLXNsaWRlci1iZyIgKS5jc3MoewoJCQkJIm1hcmdpbi1sZWZ0IjogbWluICsgIiUiLAoJCQkJIndpZHRoIjogd2lkdGggKyAiJSIKCQkJfSk7CgkJfSwKCgkJX3NldFRoZW1lOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJCXRoaXMuX2lucHV0Rmlyc3Quc2xpZGVyKCAib3B0aW9uIiwgInRoZW1lIiwgdmFsdWUgKTsKCQkJdGhpcy5faW5wdXRMYXN0LnNsaWRlciggIm9wdGlvbiIsICJ0aGVtZSIsIHZhbHVlICk7CgkJfSwKCgkJX3NldFRyYWNrVGhlbWU6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQkJdGhpcy5faW5wdXRGaXJzdC5zbGlkZXIoICJvcHRpb24iLCAidHJhY2tUaGVtZSIsIHZhbHVlICk7CgkJCXRoaXMuX2lucHV0TGFzdC5zbGlkZXIoICJvcHRpb24iLCAidHJhY2tUaGVtZSIsIHZhbHVlICk7CgkJfSwKCgkJX3NldE1pbmk6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQkJdGhpcy5faW5wdXRGaXJzdC5zbGlkZXIoICJvcHRpb24iLCAibWluaSIsIHZhbHVlICk7CgkJCXRoaXMuX2lucHV0TGFzdC5zbGlkZXIoICJvcHRpb24iLCAibWluaSIsIHZhbHVlICk7CgkJCXRoaXMuZWxlbWVudC50b2dnbGVDbGFzcyggInVpLW1pbmkiLCAhIXZhbHVlICk7CgkJfSwKCgkJX3NldEhpZ2hsaWdodDogZnVuY3Rpb24oIHZhbHVlICkgewoJCQl0aGlzLl9pbnB1dEZpcnN0LnNsaWRlciggIm9wdGlvbiIsICJoaWdobGlnaHQiLCB2YWx1ZSApOwoJCQl0aGlzLl9pbnB1dExhc3Quc2xpZGVyKCAib3B0aW9uIiwgImhpZ2hsaWdodCIsIHZhbHVlICk7CgkJfSwKCgkJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLl9sYWJlbC5wcmVwZW5kVG8oIHRoaXMuZWxlbWVudCApOwoJCQl0aGlzLmVsZW1lbnQucmVtb3ZlQ2xhc3MoICJ1aS1yYW5nZXNsaWRlciB1aS1taW5pIiApOwoJCQl0aGlzLl9pbnB1dEZpcnN0LmFmdGVyKCB0aGlzLl9zbGlkZXJGaXJzdCApOwoJCQl0aGlzLl9pbnB1dExhc3QuYWZ0ZXIoIHRoaXMuX3NsaWRlckxhc3QgKTsKCQkJdGhpcy5fc2xpZGVycy5yZW1vdmUoKTsKCQkJdGhpcy5lbGVtZW50LmZpbmQoICJpbnB1dCIgKS5yZW1vdmVDbGFzcyggInVpLXJhbmdlc2xpZGVyLWZpcnN0IHVpLXJhbmdlc2xpZGVyLWxhc3QiICkuc2xpZGVyKCAiZGVzdHJveSIgKTsKCQl9CgoJfSwgJC5tb2JpbGUuYmVoYXZpb3JzLmZvcm1SZXNldCApICk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCgkkLndpZGdldCggIm1vYmlsZS50ZXh0aW5wdXQiLCAkLm1vYmlsZS50ZXh0aW5wdXQsIHsKCQlvcHRpb25zOiB7CgkJCWNsZWFyQnRuOiBmYWxzZSwKCQkJY2xlYXJCdG5UZXh0OiAiQ2xlYXIgdGV4dCIKCQl9LAoKCQlfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5fc3VwZXIoKTsKCgkJCWlmICggISF0aGlzLm9wdGlvbnMuY2xlYXJCdG4gfHwgdGhpcy5pc1NlYXJjaCApewoJCQkJdGhpcy5fYWRkQ2xlYXJCdG4oKTsKCQkJfQoJCX0sCgoJCWNsZWFyQnV0dG9uOiBmdW5jdGlvbigpIHsKCgkJCXJldHVybiAkKCAiPGEgaHJlZj0nIycgY2xhc3M9J3VpLWlucHV0LWNsZWFyIHVpLWJ0biB1aS1pY29uLWRlbGV0ZSB1aS1idG4taWNvbi1ub3RleHQgdWktY29ybmVyLWFsbCIgKwogICAgIicgdGl0bGU9JyIgKyB0aGlzLm9wdGlvbnMuY2xlYXJCdG5UZXh0ICsgIic+IiArIHRoaXMub3B0aW9ucy5jbGVhckJ0blRleHQgKyAiPC9hPiIgKTsKCgkJfSwKCgkJX2NsZWFyQnRuQ2xpY2s6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdGhpcy5lbGVtZW50LnZhbCggIiIgKQoJCQkJCS5mb2N1cygpCgkJCQkJLnRyaWdnZXIoICJjaGFuZ2UiICk7CgoJCQl0aGlzLl9jbGVhckJ0bi5hZGRDbGFzcyggInVpLWlucHV0LWNsZWFyLWhpZGRlbiIgKTsKCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQl9LAoKCQlfYWRkQ2xlYXJCdG46IGZ1bmN0aW9uKCkgewoKCQkJaWYgKCAhdGhpcy5vcHRpb25zLmVuaGFuY2VkICkgewoJCQkJdGhpcy5fZW5oYW5jZUNsZWFyKCk7CgkJCX0KCgkJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCQlfY2xlYXJCdG46IHRoaXMud2lkZ2V0KCkuZmluZCgiYS51aS1pbnB1dC1jbGVhciIpCgkJCX0pOwoKCQkJdGhpcy5fYmluZENsZWFyRXZlbnRzKCk7CgoJCQl0aGlzLl90b2dnbGVDbGVhcigpOwoKCQl9LAoKCQlfZW5oYW5jZUNsZWFyOiBmdW5jdGlvbigpIHsKCgkJCXRoaXMuY2xlYXJCdXR0b24oKS5hcHBlbmRUbyggdGhpcy53aWRnZXQoKSApOwoJCQl0aGlzLndpZGdldCgpLmFkZENsYXNzKCAidWktaW5wdXQtaGFzLWNsZWFyIiApOwoKCQl9LAoKCQlfYmluZENsZWFyRXZlbnRzOiBmdW5jdGlvbigpIHsKCgkJCXRoaXMuX29uKCB0aGlzLl9jbGVhckJ0biwgewoJCQkJImNsaWNrIjogIl9jbGVhckJ0bkNsaWNrIgoJCQl9KTsKCgkJCXRoaXMuX29uKHsKCQkJCSJrZXl1cCI6ICJfdG9nZ2xlQ2xlYXIiLAoJCQkJImNoYW5nZSI6ICJfdG9nZ2xlQ2xlYXIiLAoJCQkJImlucHV0IjogIl90b2dnbGVDbGVhciIsCgkJCQkiZm9jdXMiOiAiX3RvZ2dsZUNsZWFyIiwKCQkJCSJibHVyIjogIl90b2dnbGVDbGVhciIsCgkJCQkiY3V0IjogIl90b2dnbGVDbGVhciIsCgkJCQkicGFzdGUiOiAiX3RvZ2dsZUNsZWFyIgoKCQkJfSk7CgoJCX0sCgoJCV91bmJpbmRDbGVhcjogZnVuY3Rpb24oKSB7CgkJCXRoaXMuX29mZiggdGhpcy5fY2xlYXJCdG4sICJjbGljayIpOwoJCQl0aGlzLl9vZmYoIHRoaXMuZWxlbWVudCwgImtleXVwIGNoYW5nZSBpbnB1dCBmb2N1cyBibHVyIGN1dCBwYXN0ZSIgKTsKCQl9LAoKCQlfc2V0T3B0aW9uczpmdW5jdGlvbiggb3B0aW9ucyApIHsKCQkJdGhpcy5fc3VwZXIoIG9wdGlvbnMgKTsKCgkJCWlmICggb3B0aW9ucy5jbGVhcmJ0biAhPT0gdW5kZWZpbmVkICYmICF0aGlzLmVsZW1lbnQuaXMoICJ0ZXh0YXJlYSwgOmpxbURhdGEodHlwZT0ncmFuZ2UnKSIgKSApIHsKCQkJCWlmICggb3B0aW9ucy5jbGVhckJ0biApewoJCQkJCXRoaXMuX2FkZENsZWFyQnRuKCk7CgkJCQl9IGVsc2UgewoJCQkJCXRoaXMuX2Rlc3Ryb3lDbGVhcigpOwoJCQkJfQoJCQl9CgoJCQlpZiAoIG9wdGlvbnMuY2xlYXJCdG5UZXh0ICE9PSB1bmRlZmluZWQgJiYgdGhpcy5fY2xlYXJCdG4gIT09IHVuZGVmaW5lZCApIHsKCQkJCXRoaXMuX2NsZWFyQnRuLnRleHQoIG9wdGlvbnMuY2xlYXJCdG5UZXh0ICk7CgkJCX0KCQl9LAoKCQlfdG9nZ2xlQ2xlYXI6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLl9kZWxheSggIl90b2dnbGVDbGVhckNsYXNzIiwgMCApOwoJCX0sCgoJCV90b2dnbGVDbGVhckNsYXNzOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5fY2xlYXJCdG4udG9nZ2xlQ2xhc3MoICJ1aS1pbnB1dC1jbGVhci1oaWRkZW4iLCAhdGhpcy5lbGVtZW50LnZhbCgpICk7CgkJfSwKCgkJX2Rlc3Ryb3lDbGVhcjogZnVuY3Rpb24oKSB7CgkJCXRoaXMuZWxlbWVudC5yZW1vdmVDbGFzcyggInVpLWlucHV0LWhhcy1jbGVhciIgKTsKCQkJdGhpcy5fdW5iaW5kQ2xlYXIoKS5fY2xlYXJCdG4ucmVtb3ZlKCk7CgkJfSwKCgkJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLl9zdXBlcigpOwoJCQl0aGlzLl9kZXN0cm95Q2xlYXIoKTsKCQl9CgoJfSk7CgoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgoJJC53aWRnZXQoICJtb2JpbGUudGV4dGlucHV0IiwgJC5tb2JpbGUudGV4dGlucHV0LCB7CgkJb3B0aW9uczogewoJCQlhdXRvZ3Jvdzp0cnVlLAoJCQlrZXl1cFRpbWVvdXRCdWZmZXI6IDEwMAoJCX0sCgoJCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLl9zdXBlcigpOwoKCQkJaWYgKCB0aGlzLm9wdGlvbnMuYXV0b2dyb3cgJiYgdGhpcy5pc1RleHRhcmVhICkgewoJCQkJdGhpcy5fYXV0b2dyb3coKTsKCQkJfQoJCX0sCgoJCV9hdXRvZ3JvdzogZnVuY3Rpb24oKSB7CgkJCXRoaXMuX29uKHsKCQkJCSJrZXl1cCI6ICJfdGltZW91dCIsCgkJCQkiY2hhbmdlIjogIl90aW1lb3V0IiwKCQkJCSJpbnB1dCI6ICJfdGltZW91dCIsCgkJCQkicGFzdGUiOiAiX3RpbWVvdXQiLAoJCQl9KTsKCgkJCS8vIEF0dGFjaCB0byB0aGUgdmFyaW91cyB5b3UtaGF2ZS1iZWNvbWUtdmlzaWJsZSBub3RpZmljYXRpb25zIHRoYXQgdGhlCgkJCS8vIHZhcmlvdXMgZnJhbWV3b3JrIGVsZW1lbnRzIGVtaXQuCgkJCS8vIFRPRE86IFJlbW92ZSBhbGwgYnV0IHRoZSB1cGRhdGVsYXlvdXQgaGFuZGxlciBvbmNlICM2NDI2IGlzIGZpeGVkLgoJCQl0aGlzLl9vbiggdHJ1ZSwgdGhpcy5kb2N1bWVudCwgewoKCQkJCS8vIFRPRE86IE1vdmUgdG8gbm9uLWRlcHJlY2F0ZWQgZXZlbnQKCQkJCSJwYWdlc2hvdyI6ICJfaGFuZGxlU2hvdyIsCgkJCQkicG9wdXBiZWZvcmVwb3NpdGlvbiI6ICJfaGFuZGxlU2hvdyIsCgkJCQkidXBkYXRlbGF5b3V0IjogIl9oYW5kbGVTaG93IiwKCQkJCSJwYW5lbG9wZW4iOiAiX2hhbmRsZVNob3ciCgkJCX0pOwoJCX0sCgoJCS8vIFN5bmNocm9ub3VzbHkgZml4IHRoZSB3aWRnZXQgaGVpZ2h0IGlmIHRoaXMgd2lkZ2V0J3MgcGFyZW50cyBhcmUgc3VjaAoJCS8vIHRoYXQgdGhleSBzaG93L2hpZGUgY29udGVudCBhdCBydW50aW1lLiBXZSBzdGlsbCBuZWVkIHRvIGNoZWNrIHdoZXRoZXIKCQkvLyB0aGUgd2lkZ2V0IGlzIGFjdHVhbGx5IHZpc2libGUgaW4gY2FzZSBpdCBpcyBjb250YWluZWQgaW5zaWRlIG11bHRpcGxlCgkJLy8gc3VjaCBjb250YWluZXJzLiBGb3IgZXhhbXBsZTogcGFuZWwgY29udGFpbnMgY29sbGFwc2libGUgY29udGFpbnMKCQkvLyBhdXRvZ3JvdyB0ZXh0aW5wdXQuIFRoZSBwYW5lbCBtYXkgZW1pdCAicGFuZWxvcGVuIiBpbmRpY2F0aW5nIHRoYXQgaXRzCgkJLy8gY29udGVudCBoYXMgYmVjb21lIHZpc2libGUsIGJ1dCB0aGUgY29sbGFwc2libGUgaXMgc3RpbGwgY29sbGFwc2VkLCBzbwoJCS8vIHRoZSBhdXRvZ3JvdyB0ZXh0YXJlYSBpcyBzdGlsbCBub3QgdmlzaWJsZS4KCQlfaGFuZGxlU2hvdzogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQlpZiAoICQuY29udGFpbnMoIGV2ZW50LnRhcmdldCwgdGhpcy5lbGVtZW50WyAwIF0gKSAmJgoJCQkJdGhpcy5lbGVtZW50LmlzKCAiOnZpc2libGUiICkgKSB7CgoJCQkJaWYgKCBldmVudC50eXBlICE9PSAicG9wdXBiZWZvcmVwb3NpdGlvbiIgKSB7CgkJCQkJdGhpcy5lbGVtZW50CgkJCQkJCS5hZGRDbGFzcyggInVpLXRleHRpbnB1dC1hdXRvZ3Jvdy1yZXNpemUiICkKCQkJCQkJLm9uZSggInRyYW5zaXRpb25lbmQgd2Via2l0VHJhbnNpdGlvbkVuZCBvVHJhbnNpdGlvbkVuZCIsCgkJCQkJCQkkLnByb3h5KCBmdW5jdGlvbigpIHsKCQkJCQkJCQl0aGlzLmVsZW1lbnQucmVtb3ZlQ2xhc3MoICJ1aS10ZXh0aW5wdXQtYXV0b2dyb3ctcmVzaXplIiApOwoJCQkJCQkJfSwgdGhpcyApICk7CgkJCQl9CgkJCQl0aGlzLl9wcmVwYXJlSGVpZ2h0VXBkYXRlKCk7CgkJCX0KCQl9LAoKCQlfdW5iaW5kQXV0b2dyb3c6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLl9vZmYoIHRoaXMuZWxlbWVudCwgImtleXVwIGNoYW5nZSBpbnB1dCBwYXN0ZSIgKTsKCQkJdGhpcy5fb2ZmKCB0aGlzLmRvY3VtZW50LAoJCQkJInBhZ2VzaG93IHBvcHVwYmVmb3JlcG9zaXRpb24gdXBkYXRlbGF5b3V0IHBhbmVsb3BlbiIgKTsKCQl9LAoKCQlrZXl1cFRpbWVvdXQ6IG51bGwsCgoJCV9wcmVwYXJlSGVpZ2h0VXBkYXRlOiBmdW5jdGlvbiggZGVsYXkgKSB7CgkJCWlmICggdGhpcy5rZXl1cFRpbWVvdXQgKSB7CgkJCQljbGVhclRpbWVvdXQoIHRoaXMua2V5dXBUaW1lb3V0ICk7CgkJCX0KCQkJaWYgKCBkZWxheSA9PT0gdW5kZWZpbmVkICkgewoJCQkJdGhpcy5fdXBkYXRlSGVpZ2h0KCk7CgkJCX0gZWxzZSB7CgkJCQl0aGlzLmtleXVwVGltZW91dCA9IHRoaXMuX2RlbGF5KCAiX3VwZGF0ZUhlaWdodCIsIGRlbGF5ICk7CgkJCX0KCQl9LAoKCQlfdGltZW91dDogZnVuY3Rpb24oKSB7CgkJCXRoaXMuX3ByZXBhcmVIZWlnaHRVcGRhdGUoIHRoaXMub3B0aW9ucy5rZXl1cFRpbWVvdXRCdWZmZXIgKTsKCQl9LAoKCQlfdXBkYXRlSGVpZ2h0OiBmdW5jdGlvbigpIHsKCgkJCXRoaXMua2V5dXBUaW1lb3V0ID0gMDsKCgkJCXRoaXMuZWxlbWVudC5jc3MoewoJCQkJImhlaWdodCI6IDAsCgkJCQkibWluLWhlaWdodCI6IDAsCgkJCQkibWF4LWhlaWdodCI6IDAKCQkJfSk7CgoJCQl2YXIgcGFkZGluZ1RvcCwgcGFkZGluZ0JvdHRvbSwgcGFkZGluZ0hlaWdodCwKCQkJCXNjcm9sbEhlaWdodCA9IHRoaXMuZWxlbWVudFsgMCBdLnNjcm9sbEhlaWdodCwKCQkJCWNsaWVudEhlaWdodCA9IHRoaXMuZWxlbWVudFsgMCBdLmNsaWVudEhlaWdodCwKCQkJCWJvcmRlclRvcCA9IHBhcnNlRmxvYXQoIHRoaXMuZWxlbWVudC5jc3MoICJib3JkZXItdG9wLXdpZHRoIiApICksCgkJCQlib3JkZXJCb3R0b20gPSBwYXJzZUZsb2F0KCB0aGlzLmVsZW1lbnQuY3NzKCAiYm9yZGVyLWJvdHRvbS13aWR0aCIgKSApLAoJCQkJYm9yZGVySGVpZ2h0ID0gYm9yZGVyVG9wICsgYm9yZGVyQm90dG9tLAoJCQkJaGVpZ2h0ID0gc2Nyb2xsSGVpZ2h0ICsgYm9yZGVySGVpZ2h0ICsgMTU7CgoJCQkvLyBJc3N1ZSA2MTc5OiBQYWRkaW5nIGlzIG5vdCBpbmNsdWRlZCBpbiBzY3JvbGxIZWlnaHQgYW5kCgkJCS8vIGNsaWVudEhlaWdodCBieSBGaXJlZm94IGlmIG5vIHNjcm9sbGJhciBpcyB2aXNpYmxlLiBCZWNhdXNlCgkJCS8vIHRleHRhcmVhcyB1c2UgdGhlIGJvcmRlci1ib3ggYm94LXNpemluZyBtb2RlbCwgcGFkZGluZyBzaG91bGQgYmUKCQkJLy8gaW5jbHVkZWQgaW4gdGhlIG5ldyAoYXNzaWduZWQpIGhlaWdodC4gQmVjYXVzZSB0aGUgaGVpZ2h0IGlzIHNldAoJCQkvLyB0byAwLCBjbGllbnRIZWlnaHQgPT0gMCBpbiBGaXJlZm94LiBUaGVyZWZvcmUsIHdlIGNhbiB1c2UgdGhpcyB0bwoJCQkvLyBjaGVjayBpZiBwYWRkaW5nIG11c3QgYmUgYWRkZWQuCgkJCWlmICggY2xpZW50SGVpZ2h0ID09PSAwICkgewoJCQkJcGFkZGluZ1RvcCA9IHBhcnNlRmxvYXQoIHRoaXMuZWxlbWVudC5jc3MoICJwYWRkaW5nLXRvcCIgKSApOwoJCQkJcGFkZGluZ0JvdHRvbSA9IHBhcnNlRmxvYXQoIHRoaXMuZWxlbWVudC5jc3MoICJwYWRkaW5nLWJvdHRvbSIgKSApOwoJCQkJcGFkZGluZ0hlaWdodCA9IHBhZGRpbmdUb3AgKyBwYWRkaW5nQm90dG9tOwoKCQkJCWhlaWdodCArPSBwYWRkaW5nSGVpZ2h0OwoJCQl9CgoJCQl0aGlzLmVsZW1lbnQuY3NzKHsKCQkJCSJoZWlnaHQiOiBoZWlnaHQsCgkJCQkibWluLWhlaWdodCI6ICIiLAoJCQkJIm1heC1oZWlnaHQiOiAiIgoJCQl9KTsKCQl9LAoKCQlyZWZyZXNoOiBmdW5jdGlvbigpIHsKCQkJaWYgKCB0aGlzLm9wdGlvbnMuYXV0b2dyb3cgJiYgdGhpcy5pc1RleHRhcmVhICkgewoJCQkJdGhpcy5fdXBkYXRlSGVpZ2h0KCk7CgkJCX0KCQl9LAoKCQlfc2V0T3B0aW9uczogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgoJCQl0aGlzLl9zdXBlciggb3B0aW9ucyApOwoKCQkJaWYgKCBvcHRpb25zLmF1dG9ncm93ICE9PSB1bmRlZmluZWQgJiYgdGhpcy5pc1RleHRhcmVhICkgewoJCQkJaWYgKCBvcHRpb25zLmF1dG9ncm93ICkgewoJCQkJCXRoaXMuX2F1dG9ncm93KCk7CgkJCQl9IGVsc2UgewoJCQkJCXRoaXMuX3VuYmluZEF1dG9ncm93KCk7CgkJCQl9CgkJCX0KCQl9CgoJfSk7Cn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUuc2VsZWN0bWVudSIsICQuZXh0ZW5kKCB7Cglpbml0U2VsZWN0b3I6ICJzZWxlY3Q6bm90KCA6anFtRGF0YShyb2xlPSdzbGlkZXInKSk6bm90KCA6anFtRGF0YShyb2xlPSdmbGlwc3dpdGNoJykgKSIsCgoJb3B0aW9uczogewoJCXRoZW1lOiBudWxsLAoJCWRpc2FibGVkOiBmYWxzZSwKCQlpY29uOiAiY2FyYXQtZCIsCgkJaWNvbnBvczogInJpZ2h0IiwKCQlpbmxpbmU6IGZhbHNlLAoJCWNvcm5lcnM6IHRydWUsCgkJc2hhZG93OiB0cnVlLAoJCWljb25zaGFkb3c6IGZhbHNlLCAvKiBUT0RPOiBEZXByZWNhdGVkIGluIDEuNCwgcmVtb3ZlIGluIDEuNS4gKi8KCQlvdmVybGF5VGhlbWU6IG51bGwsCgkJZGl2aWRlclRoZW1lOiBudWxsLAoJCWhpZGVQbGFjZWhvbGRlck1lbnVJdGVtczogdHJ1ZSwKCQljbG9zZVRleHQ6ICJDbG9zZSIsCgkJbmF0aXZlTWVudTogdHJ1ZSwKCQkvLyBUaGlzIG9wdGlvbiBkZWZhdWx0cyB0byB0cnVlIG9uIGlPUyBkZXZpY2VzLgoJCXByZXZlbnRGb2N1c1pvb206IC9pUGhvbmV8aVBhZHxpUG9kLy50ZXN0KCBuYXZpZ2F0b3IucGxhdGZvcm0gKSAmJiBuYXZpZ2F0b3IudXNlckFnZW50LmluZGV4T2YoICJBcHBsZVdlYktpdCIgKSA+IC0xLAoJCW1pbmk6IGZhbHNlCgl9LAoKCV9idXR0b246IGZ1bmN0aW9uKCkgewoJCXJldHVybiAkKCAiPGRpdi8+IiApOwoJfSwKCglfc2V0RGlzYWJsZWQ6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQl0aGlzLmVsZW1lbnQuYXR0ciggImRpc2FibGVkIiwgdmFsdWUgKTsKCQl0aGlzLmJ1dHRvbi5hdHRyKCAiYXJpYS1kaXNhYmxlZCIsIHZhbHVlICk7CgkJcmV0dXJuIHRoaXMuX3NldE9wdGlvbiggImRpc2FibGVkIiwgdmFsdWUgKTsKCX0sCgoJX2ZvY3VzQnV0dG9uIDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzOwoKCQlzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJc2VsZi5idXR0b24uZm9jdXMoKTsKCQl9LCA0MCk7Cgl9LAoKCV9zZWxlY3RPcHRpb25zOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5zZWxlY3QuZmluZCggIm9wdGlvbiIgKTsKCX0sCgoJLy8gc2V0dXAgaXRlbXMgdGhhdCBhcmUgZ2VuZXJhbGx5IG5lY2Vzc2FyeSBmb3Igc2VsZWN0IG1lbnUgZXh0ZW5zaW9uCglfcHJlRXh0ZW5zaW9uOiBmdW5jdGlvbigpIHsKCQl2YXIgaW5saW5lID0gdGhpcy5vcHRpb25zLmlubGluZSB8fCB0aGlzLmVsZW1lbnQuanFtRGF0YSggImlubGluZSIgKSwKCQkJbWluaSA9IHRoaXMub3B0aW9ucy5taW5pIHx8IHRoaXMuZWxlbWVudC5qcW1EYXRhKCAibWluaSIgKSwKCQkJY2xhc3NlcyA9ICIiOwoJCS8vIFRPRE86IFBvc3QgMS4xLS1vbmNlIHdlIGhhdmUgdGltZSB0byB0ZXN0IHRob3JvdWdobHktLWFueSBjbGFzc2VzIG1hbnVhbGx5IGFwcGxpZWQgdG8gdGhlIG9yaWdpbmFsIGVsZW1lbnQgc2hvdWxkIGJlIGNhcnJpZWQgb3ZlciB0byB0aGUgZW5oYW5jZWQgZWxlbWVudCwgd2l0aCBhbiBgLWVuaGFuY2VkYCBzdWZmaXguIFNlZSBodHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L2pxdWVyeS1tb2JpbGUvaXNzdWVzLzM1NzcKCQkvKiBpZiAoICRlbFswXS5jbGFzc05hbWUubGVuZ3RoICkgewoJCQljbGFzc2VzID0gJGVsWzBdLmNsYXNzTmFtZTsKCQl9ICovCgkJaWYgKCAhIX50aGlzLmVsZW1lbnRbMF0uY2xhc3NOYW1lLmluZGV4T2YoICJ1aS1idG4tbGVmdCIgKSApIHsKCQkJY2xhc3NlcyA9ICIgdWktYnRuLWxlZnQiOwoJCX0KCgkJaWYgKCAgISF+dGhpcy5lbGVtZW50WzBdLmNsYXNzTmFtZS5pbmRleE9mKCAidWktYnRuLXJpZ2h0IiApICkgewoJCQljbGFzc2VzID0gIiB1aS1idG4tcmlnaHQiOwoJCX0KCgkJaWYgKCBpbmxpbmUgKSB7CgkJCWNsYXNzZXMgKz0gIiB1aS1idG4taW5saW5lIjsKCQl9CgkJaWYgKCBtaW5pICkgewoJCQljbGFzc2VzICs9ICIgdWktbWluaSI7CgkJfQoKCQl0aGlzLnNlbGVjdCA9IHRoaXMuZWxlbWVudC5yZW1vdmVDbGFzcyggInVpLWJ0bi1sZWZ0IHVpLWJ0bi1yaWdodCIgKS53cmFwKCAiPGRpdiBjbGFzcz0ndWktc2VsZWN0IiArIGNsYXNzZXMgKyAiJz4iICk7CgkJdGhpcy5zZWxlY3RJZCAgPSB0aGlzLnNlbGVjdC5hdHRyKCAiaWQiICkgfHwgKCAic2VsZWN0LSIgKyB0aGlzLnV1aWQgKTsKCQl0aGlzLmJ1dHRvbklkID0gdGhpcy5zZWxlY3RJZCArICItYnV0dG9uIjsKCQl0aGlzLmxhYmVsID0gJCggImxhYmVsW2Zvcj0nIisgdGhpcy5zZWxlY3RJZCArIiddIiApOwoJCXRoaXMuaXNNdWx0aXBsZSA9IHRoaXMuc2VsZWN0WyAwIF0ubXVsdGlwbGU7Cgl9LAoKCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCQl2YXIgd3JhcHBlciA9IHRoaXMuZWxlbWVudC5wYXJlbnRzKCAiLnVpLXNlbGVjdCIgKTsKCQlpZiAoIHdyYXBwZXIubGVuZ3RoID4gMCApIHsKCQkJaWYgKCB3cmFwcGVyLmlzKCAiLnVpLWJ0bi1sZWZ0LCAudWktYnRuLXJpZ2h0IiApICkgewoJCQkJdGhpcy5lbGVtZW50LmFkZENsYXNzKCB3cmFwcGVyLmhhc0NsYXNzKCAidWktYnRuLWxlZnQiICkgPyAidWktYnRuLWxlZnQiIDogInVpLWJ0bi1yaWdodCIgKTsKCQkJfQoJCQl0aGlzLmVsZW1lbnQuaW5zZXJ0QWZ0ZXIoIHdyYXBwZXIgKTsKCQkJd3JhcHBlci5yZW1vdmUoKTsKCQl9Cgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3ByZUV4dGVuc2lvbigpOwoKCQl0aGlzLmJ1dHRvbiA9IHRoaXMuX2J1dHRvbigpOwoKCQl2YXIgc2VsZiA9IHRoaXMsCgoJCQlvcHRpb25zID0gdGhpcy5vcHRpb25zLAoKCQkJaWNvbnBvcyA9IG9wdGlvbnMuaWNvbiA/ICggb3B0aW9ucy5pY29ucG9zIHx8IHRoaXMuc2VsZWN0LmpxbURhdGEoICJpY29ucG9zIiApICkgOiBmYWxzZSwKCgkJCWJ1dHRvbiA9IHRoaXMuYnV0dG9uCgkJCQkuaW5zZXJ0QmVmb3JlKCB0aGlzLnNlbGVjdCApCgkJCQkuYXR0ciggImlkIiwgdGhpcy5idXR0b25JZCApCgkJCQkuYWRkQ2xhc3MoICJ1aS1idG4iICsKCQkJCQkoIG9wdGlvbnMuaWNvbiA/ICggIiB1aS1pY29uLSIgKyBvcHRpb25zLmljb24gKyAiIHVpLWJ0bi1pY29uLSIgKyBpY29ucG9zICsKCQkJCQkoIG9wdGlvbnMuaWNvbnNoYWRvdyA/ICIgdWktc2hhZG93LWljb24iIDogIiIgKSApIDoJIiIgKSArIC8qIFRPRE86IFJlbW92ZSBpbiAxLjUuICovCgkJCQkJKCBvcHRpb25zLnRoZW1lID8gIiB1aS1idG4tIiArIG9wdGlvbnMudGhlbWUgOiAiIiApICsKCQkJCQkoIG9wdGlvbnMuY29ybmVycyA/ICIgdWktY29ybmVyLWFsbCIgOiAiIiApICsKCQkJCQkoIG9wdGlvbnMuc2hhZG93ID8gIiB1aS1zaGFkb3ciIDogIiIgKSApOwoKCQl0aGlzLnNldEJ1dHRvblRleHQoKTsKCgkJLy8gT3BlcmEgZG9lcyBub3QgcHJvcGVybHkgc3VwcG9ydCBvcGFjaXR5IG9uIHNlbGVjdCBlbGVtZW50cwoJCS8vIEluIE1pbmksIGl0IGhpZGVzIHRoZSBlbGVtZW50LCBidXQgbm90IGl0cyB0ZXh0CgkJLy8gT24gdGhlIGRlc2t0b3AsaXQgc2VlbXMgdG8gZG8gdGhlIG9wcG9zaXRlCgkJLy8gZm9yIHRoZXNlIHJlYXNvbnMsIHVzaW5nIHRoZSBuYXRpdmVNZW51IG9wdGlvbiByZXN1bHRzIGluIGEgZnVsbCBuYXRpdmUgc2VsZWN0IGluIE9wZXJhCgkJaWYgKCBvcHRpb25zLm5hdGl2ZU1lbnUgJiYgd2luZG93Lm9wZXJhICYmIHdpbmRvdy5vcGVyYS52ZXJzaW9uICkgewoJCQlidXR0b24uYWRkQ2xhc3MoICJ1aS1zZWxlY3QtbmF0aXZlb25seSIgKTsKCQl9CgoJCS8vIEFkZCBjb3VudGVyIGZvciBtdWx0aSBzZWxlY3RzCgkJaWYgKCB0aGlzLmlzTXVsdGlwbGUgKSB7CgkJCXRoaXMuYnV0dG9uQ291bnQgPSAkKCAiPHNwYW4+IiApCgkJCQkuYWRkQ2xhc3MoICJ1aS1saS1jb3VudCB1aS1ib2R5LWluaGVyaXQiICkKCQkJCS5oaWRlKCkKCQkJCS5hcHBlbmRUbyggYnV0dG9uLmFkZENsYXNzKCAidWktbGktaGFzLWNvdW50IiApICk7CgkJfQoKCQkvLyBEaXNhYmxlIGlmIHNwZWNpZmllZAoJCWlmICggb3B0aW9ucy5kaXNhYmxlZCB8fCB0aGlzLmVsZW1lbnQuYXR0ciggImRpc2FibGVkIiApKSB7CgkJCXRoaXMuZGlzYWJsZSgpOwoJCX0KCgkJLy8gRXZlbnRzIG9uIG5hdGl2ZSBzZWxlY3QKCQl0aGlzLnNlbGVjdC5jaGFuZ2UoZnVuY3Rpb24oKSB7CgkJCXNlbGYucmVmcmVzaCgpOwoKCQkJaWYgKCAhIW9wdGlvbnMubmF0aXZlTWVudSApIHsKCQkJCXRoaXMuYmx1cigpOwoJCQl9CgkJfSk7CgoJCXRoaXMuX2hhbmRsZUZvcm1SZXNldCgpOwoKCQl0aGlzLl9vbiggdGhpcy5idXR0b24sIHsKCQkJa2V5ZG93bjogIl9oYW5kbGVLZXlkb3duIgoJCX0pOwoKCQl0aGlzLmJ1aWxkKCk7Cgl9LAoKCWJ1aWxkOiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXM7CgoJCXRoaXMuc2VsZWN0CgkJCS5hcHBlbmRUbyggc2VsZi5idXR0b24gKQoJCQkuYmluZCggInZtb3VzZWRvd24iLCBmdW5jdGlvbigpIHsKCQkJCS8vIEFkZCBhY3RpdmUgY2xhc3MgdG8gYnV0dG9uCgkJCQlzZWxmLmJ1dHRvbi5hZGRDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJfSkKCQkJLmJpbmQoICJmb2N1cyIsIGZ1bmN0aW9uKCkgewoJCQkJc2VsZi5idXR0b24uYWRkQ2xhc3MoICQubW9iaWxlLmZvY3VzQ2xhc3MgKTsKCQkJfSkKCQkJLmJpbmQoICJibHVyIiwgZnVuY3Rpb24oKSB7CgkJCQlzZWxmLmJ1dHRvbi5yZW1vdmVDbGFzcyggJC5tb2JpbGUuZm9jdXNDbGFzcyApOwoJCQl9KQoJCQkuYmluZCggImZvY3VzIHZtb3VzZW92ZXIiLCBmdW5jdGlvbigpIHsKCQkJCXNlbGYuYnV0dG9uLnRyaWdnZXIoICJ2bW91c2VvdmVyIiApOwoJCQl9KQoJCQkuYmluZCggInZtb3VzZW1vdmUiLCBmdW5jdGlvbigpIHsKCQkJCS8vIFJlbW92ZSBhY3RpdmUgY2xhc3Mgb24gc2Nyb2xsL3RvdWNobW92ZQoJCQkJc2VsZi5idXR0b24ucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCX0pCgkJCS5iaW5kKCAiY2hhbmdlIGJsdXIgdm1vdXNlb3V0IiwgZnVuY3Rpb24oKSB7CgkJCQlzZWxmLmJ1dHRvbi50cmlnZ2VyKCAidm1vdXNlb3V0IiApCgkJCQkJLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQl9KTsKCgkJLy8gSW4gbWFueSBzaXR1YXRpb25zLCBpT1Mgd2lsbCB6b29tIGludG8gdGhlIHNlbGVjdCB1cG9uIHRhcCwgdGhpcyBwcmV2ZW50cyB0aGF0IGZyb20gaGFwcGVuaW5nCgkJc2VsZi5idXR0b24uYmluZCggInZtb3VzZWRvd24iLCBmdW5jdGlvbigpIHsKCQkJaWYgKCBzZWxmLm9wdGlvbnMucHJldmVudEZvY3VzWm9vbSApIHsKCQkJCQkkLm1vYmlsZS56b29tLmRpc2FibGUoIHRydWUgKTsKCQkJfQoJCX0pOwoJCXNlbGYubGFiZWwuYmluZCggImNsaWNrIGZvY3VzIiwgZnVuY3Rpb24oKSB7CgkJCWlmICggc2VsZi5vcHRpb25zLnByZXZlbnRGb2N1c1pvb20gKSB7CgkJCQkJJC5tb2JpbGUuem9vbS5kaXNhYmxlKCB0cnVlICk7CgkJCX0KCQl9KTsKCQlzZWxmLnNlbGVjdC5iaW5kKCAiZm9jdXMiLCBmdW5jdGlvbigpIHsKCQkJaWYgKCBzZWxmLm9wdGlvbnMucHJldmVudEZvY3VzWm9vbSApIHsKCQkJCQkkLm1vYmlsZS56b29tLmRpc2FibGUoIHRydWUgKTsKCQkJfQoJCX0pOwoJCXNlbGYuYnV0dG9uLmJpbmQoICJtb3VzZXVwIiwgZnVuY3Rpb24oKSB7CgkJCWlmICggc2VsZi5vcHRpb25zLnByZXZlbnRGb2N1c1pvb20gKSB7CgkJCQlzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoJCQkJCSQubW9iaWxlLnpvb20uZW5hYmxlKCB0cnVlICk7CgkJCQl9LCAwICk7CgkJCX0KCQl9KTsKCQlzZWxmLnNlbGVjdC5iaW5kKCAiYmx1ciIsIGZ1bmN0aW9uKCkgewoJCQlpZiAoIHNlbGYub3B0aW9ucy5wcmV2ZW50Rm9jdXNab29tICkgewoJCQkJJC5tb2JpbGUuem9vbS5lbmFibGUoIHRydWUgKTsKCQkJfQoJCX0pOwoKCX0sCgoJc2VsZWN0ZWQ6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLl9zZWxlY3RPcHRpb25zKCkuZmlsdGVyKCAiOnNlbGVjdGVkIiApOwoJfSwKCglzZWxlY3RlZEluZGljZXM6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpczsKCgkJcmV0dXJuIHRoaXMuc2VsZWN0ZWQoKS5tYXAoZnVuY3Rpb24oKSB7CgkJCXJldHVybiBzZWxmLl9zZWxlY3RPcHRpb25zKCkuaW5kZXgoIHRoaXMgKTsKCQl9KS5nZXQoKTsKCX0sCgoJc2V0QnV0dG9uVGV4dDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzLAoJCQlzZWxlY3RlZCA9IHRoaXMuc2VsZWN0ZWQoKSwKCQkJdGV4dCA9IHRoaXMucGxhY2Vob2xkZXIsCgkJCXNwYW4gPSAkKCBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAic3BhbiIgKSApOwoKCQl0aGlzLmJ1dHRvbi5jaGlsZHJlbiggInNwYW4iICkubm90KCAiLnVpLWxpLWNvdW50IiApLnJlbW92ZSgpLmVuZCgpLmVuZCgpLnByZXBlbmQoIChmdW5jdGlvbigpIHsKCQkJaWYgKCBzZWxlY3RlZC5sZW5ndGggKSB7CgkJCQl0ZXh0ID0gc2VsZWN0ZWQubWFwKGZ1bmN0aW9uKCkgewoJCQkJCXJldHVybiAkKCB0aGlzICkudGV4dCgpOwoJCQkJfSkuZ2V0KCkuam9pbiggIiwgIiApOwoJCQl9IGVsc2UgewoJCQkJdGV4dCA9IHNlbGYucGxhY2Vob2xkZXI7CgkJCX0KCgkJCWlmICggdGV4dCApIHsKCQkJCXNwYW4udGV4dCggdGV4dCApOwoJCQl9IGVsc2UgewoJCQkJc3Bhbi5odG1sKCAiJm5ic3A7IiApOwoJCQl9CgoJCQkvLyBUT0RPIHBvc3NpYmx5IGFnZ3JlZ2F0ZSBtdWx0aXBsZSBzZWxlY3Qgb3B0aW9uIGNsYXNzZXMKCQkJcmV0dXJuIHNwYW4KCQkJCS5hZGRDbGFzcyggc2VsZi5zZWxlY3QuYXR0ciggImNsYXNzIiApICkKCQkJCS5hZGRDbGFzcyggc2VsZWN0ZWQuYXR0ciggImNsYXNzIiApICkKCQkJCS5yZW1vdmVDbGFzcyggInVpLXNjcmVlbi1oaWRkZW4iICk7CgkJfSkoKSk7Cgl9LAoKCXNldEJ1dHRvbkNvdW50OiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZWN0ZWQgPSB0aGlzLnNlbGVjdGVkKCk7CgoJCS8vIG11bHRpcGxlIGNvdW50IGluc2lkZSBidXR0b24KCQlpZiAoIHRoaXMuaXNNdWx0aXBsZSApIHsKCQkJdGhpcy5idXR0b25Db3VudFsgc2VsZWN0ZWQubGVuZ3RoID4gMSA/ICJzaG93IiA6ICJoaWRlIiBdKCkudGV4dCggc2VsZWN0ZWQubGVuZ3RoICk7CgkJfQoJfSwKCglfaGFuZGxlS2V5ZG93bjogZnVuY3Rpb24oIC8qIGV2ZW50ICovICkgewoJCXRoaXMuX2RlbGF5KCAiX3JlZnJlc2hCdXR0b24iICk7Cgl9LAoKCV9yZXNldDogZnVuY3Rpb24oKSB7CgkJdGhpcy5yZWZyZXNoKCk7Cgl9LAoKCV9yZWZyZXNoQnV0dG9uOiBmdW5jdGlvbigpIHsKCQl0aGlzLnNldEJ1dHRvblRleHQoKTsKCQl0aGlzLnNldEJ1dHRvbkNvdW50KCk7Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3JlZnJlc2hCdXR0b24oKTsKCX0sCgoJLy8gb3BlbiBhbmQgY2xvc2UgcHJlc2VydmVkIGluIG5hdGl2ZSBzZWxlY3RzCgkvLyB0byBzaW1wbGlmeSB1c2VycyBjb2RlIHdoZW4gbG9vcGluZyBvdmVyIHNlbGVjdHMKCW9wZW46ICQubm9vcCwKCWNsb3NlOiAkLm5vb3AsCgoJZGlzYWJsZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5fc2V0RGlzYWJsZWQoIHRydWUgKTsKCQl0aGlzLmJ1dHRvbi5hZGRDbGFzcyggInVpLXN0YXRlLWRpc2FibGVkIiApOwoJfSwKCgllbmFibGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3NldERpc2FibGVkKCBmYWxzZSApOwoJCXRoaXMuYnV0dG9uLnJlbW92ZUNsYXNzKCAidWktc3RhdGUtZGlzYWJsZWQiICk7Cgl9Cn0sICQubW9iaWxlLmJlaGF2aW9ycy5mb3JtUmVzZXQgKSApOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS5saW5rcyA9IGZ1bmN0aW9uKCB0YXJnZXQgKSB7CgoJLy9saW5rcyB3aXRoaW4gY29udGVudCBhcmVhcywgdGVzdHMgaW5jbHVkZWQgd2l0aCBwYWdlCgkkKCB0YXJnZXQgKQoJCS5maW5kKCAiYSIgKQoJCS5qcW1FbmhhbmNlYWJsZSgpCgkJLmZpbHRlciggIjpqcW1EYXRhKHJlbD0ncG9wdXAnKVtocmVmXVtocmVmIT0nJ10iICkKCQkuZWFjaCggZnVuY3Rpb24oKSB7CgkJCS8vIEFjY2Vzc2liaWxpdHkgaW5mbyBmb3IgcG9wdXBzCgkJCXZhciBlID0gdGhpcywKCQkJCWhyZWYgPSAkKCB0aGlzICkuYXR0ciggImhyZWYiICksCgkJCQlzZWwgPSAkLm1vYmlsZS5wYXRoLmhhc2hUb1NlbGVjdG9yKCBocmVmICksCgkJCQlpZHJlZiA9IGhyZWYuc3Vic3RyaW5nKCAxICk7CgoJCQllLnNldEF0dHJpYnV0ZSggImFyaWEtaGFzcG9wdXAiLCB0cnVlICk7CgkJCWUuc2V0QXR0cmlidXRlKCAiYXJpYS1vd25zIiwgaWRyZWYgKTsKCQkJZS5zZXRBdHRyaWJ1dGUoICJhcmlhLWV4cGFuZGVkIiwgZmFsc2UgKTsKCQkJJCggZG9jdW1lbnQgKQoJCQkJLm9uKCAicG9wdXBhZnRlcm9wZW4iLCBzZWwsIGZ1bmN0aW9uKCkgewoJCQkJCWUuc2V0QXR0cmlidXRlKCAiYXJpYS1leHBhbmRlZCIsIHRydWUgKTsKCQkJCX0pCgkJCQkub24oICJwb3B1cGFmdGVyY2xvc2UiLCBzZWwsIGZ1bmN0aW9uKCkgewoJCQkJCWUuc2V0QXR0cmlidXRlKCAiYXJpYS1leHBhbmRlZCIsIGZhbHNlICk7CgkJCQl9KTsKCQl9KQoJCS5lbmQoKQoJCS5ub3QoICIudWktYnRuLCA6anFtRGF0YShyb2xlPSdub25lJyksIDpqcW1EYXRhKHJvbGU9J25vanMnKSIgKQoJCS5hZGRDbGFzcyggInVpLWxpbmsiICk7Cgp9OwoKfSkoIGpRdWVyeSApOwoKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKZnVuY3Rpb24gZml0U2VnbWVudEluc2lkZVNlZ21lbnQoIHdpbmRvd1NpemUsIHNlZ21lbnRTaXplLCBvZmZzZXQsIGRlc2lyZWQgKSB7Cgl2YXIgcmV0dXJuVmFsdWUgPSBkZXNpcmVkOwoKCWlmICggd2luZG93U2l6ZSA8IHNlZ21lbnRTaXplICkgewoJCS8vIENlbnRlciBzZWdtZW50IGlmIGl0J3MgYmlnZ2VyIHRoYW4gdGhlIHdpbmRvdwoJCXJldHVyblZhbHVlID0gb2Zmc2V0ICsgKCB3aW5kb3dTaXplIC0gc2VnbWVudFNpemUgKSAvIDI7Cgl9IGVsc2UgewoJCS8vIE90aGVyd2lzZSBjZW50ZXIgaXQgYXQgdGhlIGRlc2lyZWQgY29vcmRpbmF0ZSB3aGlsZSBrZWVwaW5nIGl0IGNvbXBsZXRlbHkgaW5zaWRlIHRoZSB3aW5kb3cKCQlyZXR1cm5WYWx1ZSA9IE1hdGgubWluKCBNYXRoLm1heCggb2Zmc2V0LCBkZXNpcmVkIC0gc2VnbWVudFNpemUgLyAyICksIG9mZnNldCArIHdpbmRvd1NpemUgLSBzZWdtZW50U2l6ZSApOwoJfQoKCXJldHVybiByZXR1cm5WYWx1ZTsKfQoKZnVuY3Rpb24gZ2V0V2luZG93Q29vcmRpbmF0ZXMoIHRoZVdpbmRvdyApIHsKCXJldHVybiB7CgkJeDogdGhlV2luZG93LnNjcm9sbExlZnQoKSwKCQl5OiB0aGVXaW5kb3cuc2Nyb2xsVG9wKCksCgkJY3g6ICggdGhlV2luZG93WyAwIF0uaW5uZXJXaWR0aCB8fCB0aGVXaW5kb3cud2lkdGgoKSApLAoJCWN5OiAoIHRoZVdpbmRvd1sgMCBdLmlubmVySGVpZ2h0IHx8IHRoZVdpbmRvdy5oZWlnaHQoKSApCgl9Owp9CgokLndpZGdldCggIm1vYmlsZS5wb3B1cCIsIHsKCW9wdGlvbnM6IHsKCQl3cmFwcGVyQ2xhc3M6IG51bGwsCgkJdGhlbWU6IG51bGwsCgkJb3ZlcmxheVRoZW1lOiBudWxsLAoJCXNoYWRvdzogdHJ1ZSwKCQljb3JuZXJzOiB0cnVlLAoJCXRyYW5zaXRpb246ICJub25lIiwKCQlwb3NpdGlvblRvOiAib3JpZ2luIiwKCQl0b2xlcmFuY2U6IG51bGwsCgkJY2xvc2VMaW5rU2VsZWN0b3I6ICJhOmpxbURhdGEocmVsPSdiYWNrJykiLAoJCWNsb3NlTGlua0V2ZW50czogImNsaWNrLnBvcHVwIiwKCQluYXZpZ2F0ZUV2ZW50czogIm5hdmlnYXRlLnBvcHVwIiwKCQljbG9zZUV2ZW50czogIm5hdmlnYXRlLnBvcHVwIHBhZ2ViZWZvcmVjaGFuZ2UucG9wdXAiLAoJCWRpc21pc3NpYmxlOiB0cnVlLAoJCWVuaGFuY2VkOiBmYWxzZSwKCgkJLy8gTk9URSBXaW5kb3dzIFBob25lIDcgaGFzIGEgc2Nyb2xsIHBvc2l0aW9uIGNhY2hpbmcgaXNzdWUgdGhhdAoJCS8vICAgICAgcmVxdWlyZXMgdXMgdG8gZGlzYWJsZSBwb3B1cCBoaXN0b3J5IG1hbmFnZW1lbnQgYnkgZGVmYXVsdAoJCS8vICAgICAgaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnktbW9iaWxlL2lzc3Vlcy80Nzg0CgkJLy8KCQkvLyBOT1RFIHRoaXMgb3B0aW9uIGlzIG1vZGlmaWVkIGluIF9jcmVhdGUhCgkJaGlzdG9yeTogISQubW9iaWxlLmJyb3dzZXIub2xkSUUKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdmFyIHRoZUVsZW1lbnQgPSB0aGlzLmVsZW1lbnQsCgkJCW15SWQgPSB0aGVFbGVtZW50LmF0dHIoICJpZCIgKSwKCQkJY3VycmVudE9wdGlvbnMgPSB0aGlzLm9wdGlvbnM7CgoJCS8vIFdlIG5lZWQgdG8gYWRqdXN0IHRoZSBoaXN0b3J5IG9wdGlvbiB0byBiZSBmYWxzZSBpZiB0aGVyZSdzIG5vIEFKQVggbmF2LgoJCS8vIFdlIGNhbid0IGRvIGl0IGluIHRoZSBvcHRpb24gZGVjbGFyYXRpb25zIGJlY2F1c2UgdGhvc2UgYXJlIHJ1biBiZWZvcmUKCQkvLyBpdCBpcyBkZXRlcm1pbmVkIHdoZXRoZXIgdGhlcmUgc2hhbGwgYmUgQUpBWCBuYXYuCgkJY3VycmVudE9wdGlvbnMuaGlzdG9yeSA9IGN1cnJlbnRPcHRpb25zLmhpc3RvcnkgJiYgJC5tb2JpbGUuYWpheEVuYWJsZWQgJiYgJC5tb2JpbGUuaGFzaExpc3RlbmluZ0VuYWJsZWQ7CgoJCS8vIERlZmluZSBpbnN0YW5jZSB2YXJpYWJsZXMKCQkkLmV4dGVuZCggdGhpcywgewoJCQlfc2Nyb2xsVG9wOiAwLAoJCQlfcGFnZTogdGhlRWxlbWVudC5jbG9zZXN0KCAiLnVpLXBhZ2UiICksCgkJCV91aTogbnVsbCwKCQkJX2ZhbGxiYWNrVHJhbnNpdGlvbjogIiIsCgkJCV9jdXJyZW50VHJhbnNpdGlvbjogZmFsc2UsCgkJCV9wcmVyZXF1aXNpdGVzOiBudWxsLAoJCQlfaXNPcGVuOiBmYWxzZSwKCQkJX3RvbGVyYW5jZTogbnVsbCwKCQkJX3Jlc2l6ZURhdGE6IG51bGwsCgkJCV9pZ25vcmVSZXNpemVUbzogMCwKCQkJX29yaWVudGF0aW9uY2hhbmdlSW5Qcm9ncmVzczogZmFsc2UKCQl9KTsKCgkJaWYgKCB0aGlzLl9wYWdlLmxlbmd0aCA9PT0gMCApIHsKCQkJdGhpcy5fcGFnZSA9ICQoICJib2R5IiApOwoJCX0KCgkJaWYgKCBjdXJyZW50T3B0aW9ucy5lbmhhbmNlZCApIHsKCQkJdGhpcy5fdWkgPSB7CgkJCQljb250YWluZXI6IHRoZUVsZW1lbnQucGFyZW50KCksCgkJCQlzY3JlZW46IHRoZUVsZW1lbnQucGFyZW50KCkucHJldigpLAoJCQkJcGxhY2Vob2xkZXI6ICQoIHRoaXMuZG9jdW1lbnRbIDAgXS5nZXRFbGVtZW50QnlJZCggbXlJZCArICItcGxhY2Vob2xkZXIiICkgKQoJCQl9OwoJCX0gZWxzZSB7CgkJCXRoaXMuX3VpID0gdGhpcy5fZW5oYW5jZSggdGhlRWxlbWVudCwgbXlJZCApOwoJCQl0aGlzLl9hcHBseVRyYW5zaXRpb24oIGN1cnJlbnRPcHRpb25zLnRyYW5zaXRpb24gKTsKCQl9CgkJdGhpcwoJCQkuX3NldFRvbGVyYW5jZSggY3VycmVudE9wdGlvbnMudG9sZXJhbmNlICkKCQkJLl91aS5mb2N1c0VsZW1lbnQgPSB0aGlzLl91aS5jb250YWluZXI7CgoJCS8vIEV2ZW50IGhhbmRsZXJzCgkJdGhpcy5fb24oIHRoaXMuX3VpLnNjcmVlbiwgeyAidmNsaWNrIjogIl9lYXRFdmVudEFuZENsb3NlIiB9ICk7CgkJdGhpcy5fb24oIHRoaXMud2luZG93LCB7CgkJCW9yaWVudGF0aW9uY2hhbmdlOiAkLnByb3h5KCB0aGlzLCAiX2hhbmRsZVdpbmRvd09yaWVudGF0aW9uY2hhbmdlIiApLAoJCQlyZXNpemU6ICQucHJveHkoIHRoaXMsICJfaGFuZGxlV2luZG93UmVzaXplIiApLAoJCQlrZXl1cDogJC5wcm94eSggdGhpcywgIl9oYW5kbGVXaW5kb3dLZXlVcCIgKQoJCX0pOwoJCXRoaXMuX29uKCB0aGlzLmRvY3VtZW50LCB7ICJmb2N1c2luIjogIl9oYW5kbGVEb2N1bWVudEZvY3VzSW4iIH0gKTsKCX0sCgoJX2VuaGFuY2U6IGZ1bmN0aW9uKCB0aGVFbGVtZW50LCBteUlkICkgewoJCXZhciBjdXJyZW50T3B0aW9ucyA9IHRoaXMub3B0aW9ucywKCQkJd3JhcHBlckNsYXNzID0gY3VycmVudE9wdGlvbnMud3JhcHBlckNsYXNzLAoJCQl1aSA9IHsKCQkJCXNjcmVlbjogJCggIjxkaXYgY2xhc3M9J3VpLXNjcmVlbi1oaWRkZW4gdWktcG9wdXAtc2NyZWVuICIgKwoJCQkJdGhpcy5fdGhlbWVDbGFzc0Zyb21PcHRpb24oICJ1aS1vdmVybGF5LSIsIGN1cnJlbnRPcHRpb25zLm92ZXJsYXlUaGVtZSApICsgIic+PC9kaXY+IiApLAoJCQkJcGxhY2Vob2xkZXI6ICQoICI8ZGl2IHN0eWxlPSdkaXNwbGF5OiBub25lOyc+PCEtLSBwbGFjZWhvbGRlciAtLT48L2Rpdj4iICksCgkJCQljb250YWluZXI6ICQoICI8ZGl2IGNsYXNzPSd1aS1wb3B1cC1jb250YWluZXIgdWktcG9wdXAtaGlkZGVuIHVpLXBvcHVwLXRydW5jYXRlIiArCgkJCQkJKCB3cmFwcGVyQ2xhc3MgPyAoICIgIiArIHdyYXBwZXJDbGFzcyApIDogIiIgKSArICInPjwvZGl2PiIgKQoJCQl9LAoJCQlmcmFnbWVudCA9IHRoaXMuZG9jdW1lbnRbIDAgXS5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCk7CgoJCWZyYWdtZW50LmFwcGVuZENoaWxkKCB1aS5zY3JlZW5bIDAgXSApOwoJCWZyYWdtZW50LmFwcGVuZENoaWxkKCB1aS5jb250YWluZXJbIDAgXSApOwoKCQlpZiAoIG15SWQgKSB7CgkJCXVpLnNjcmVlbi5hdHRyKCAiaWQiLCBteUlkICsgIi1zY3JlZW4iICk7CgkJCXVpLmNvbnRhaW5lci5hdHRyKCAiaWQiLCBteUlkICsgIi1wb3B1cCIgKTsKCQkJdWkucGxhY2Vob2xkZXIKCQkJCS5hdHRyKCAiaWQiLCBteUlkICsgIi1wbGFjZWhvbGRlciIgKQoJCQkJLmh0bWwoICI8IS0tIHBsYWNlaG9sZGVyIGZvciAiICsgbXlJZCArICIgLS0+IiApOwoJCX0KCgkJLy8gQXBwbHkgdGhlIHByb3RvCgkJdGhpcy5fcGFnZVsgMCBdLmFwcGVuZENoaWxkKCBmcmFnbWVudCApOwoJCS8vIExlYXZlIGEgcGxhY2Vob2xkZXIgd2hlcmUgdGhlIGVsZW1lbnQgdXNlZCB0byBiZQoJCXVpLnBsYWNlaG9sZGVyLmluc2VydEFmdGVyKCB0aGVFbGVtZW50ICk7CgkJdGhlRWxlbWVudAoJCQkuZGV0YWNoKCkKCQkJLmFkZENsYXNzKCAidWktcG9wdXAgIiArCgkJCQl0aGlzLl90aGVtZUNsYXNzRnJvbU9wdGlvbiggInVpLWJvZHktIiwgY3VycmVudE9wdGlvbnMudGhlbWUgKSArICIgIiArCgkJCQkoIGN1cnJlbnRPcHRpb25zLnNoYWRvdyA/ICJ1aS1vdmVybGF5LXNoYWRvdyAiIDogIiIgKSArCgkJCQkoIGN1cnJlbnRPcHRpb25zLmNvcm5lcnMgPyAidWktY29ybmVyLWFsbCAiIDogIiIgKSApCgkJCS5hcHBlbmRUbyggdWkuY29udGFpbmVyICk7CgoJCXJldHVybiB1aTsKCX0sCgoJX2VhdEV2ZW50QW5kQ2xvc2U6IGZ1bmN0aW9uKCB0aGVFdmVudCApIHsKCQl0aGVFdmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCXRoZUV2ZW50LnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbigpOwoJCWlmICggdGhpcy5vcHRpb25zLmRpc21pc3NpYmxlICkgewoJCQl0aGlzLmNsb3NlKCk7CgkJfQoJCXJldHVybiBmYWxzZTsKCX0sCgoJLy8gTWFrZSBzdXJlIHRoZSBzY3JlZW4gc2l6ZSBpcyBpbmNyZWFzZWQgYmV5b25kIHRoZSBwYWdlIGhlaWdodCBpZiB0aGUgcG9wdXAncyBjYXVzZXMgdGhlIGRvY3VtZW50IHRvIGluY3JlYXNlIGluIGhlaWdodAoJX3Jlc2l6ZVNjcmVlbjogZnVuY3Rpb24oKSB7CgkJdmFyIHBvcHVwSGVpZ2h0ID0gdGhpcy5fdWkuY29udGFpbmVyLm91dGVySGVpZ2h0KCB0cnVlICk7CgoJCXRoaXMuX3VpLnNjcmVlbi5yZW1vdmVBdHRyKCAic3R5bGUiICk7CgkJaWYgKCBwb3B1cEhlaWdodCA+IHRoaXMuX3VpLnNjcmVlbi5oZWlnaHQoKSApIHsKCQkJdGhpcy5fdWkuc2NyZWVuLmhlaWdodCggcG9wdXBIZWlnaHQgKTsKCQl9Cgl9LAoKCV9oYW5kbGVXaW5kb3dLZXlVcDogZnVuY3Rpb24oIHRoZUV2ZW50ICkgewoJCWlmICggdGhpcy5faXNPcGVuICYmIHRoZUV2ZW50LmtleUNvZGUgPT09ICQubW9iaWxlLmtleUNvZGUuRVNDQVBFICkgewoJCQlyZXR1cm4gdGhpcy5fZWF0RXZlbnRBbmRDbG9zZSggdGhlRXZlbnQgKTsKCQl9Cgl9LAoKCV9leHBlY3RSZXNpemVFdmVudDogZnVuY3Rpb24oKSB7CgkJdmFyIHdpbmRvd0Nvb3JkaW5hdGVzID0gZ2V0V2luZG93Q29vcmRpbmF0ZXMoIHRoaXMud2luZG93ICk7CgoJCWlmICggdGhpcy5fcmVzaXplRGF0YSApIHsKCQkJaWYgKCB3aW5kb3dDb29yZGluYXRlcy54ID09PSB0aGlzLl9yZXNpemVEYXRhLndpbmRvd0Nvb3JkaW5hdGVzLnggJiYKCQkJCXdpbmRvd0Nvb3JkaW5hdGVzLnkgPT09IHRoaXMuX3Jlc2l6ZURhdGEud2luZG93Q29vcmRpbmF0ZXMueSAmJgoJCQkJd2luZG93Q29vcmRpbmF0ZXMuY3ggPT09IHRoaXMuX3Jlc2l6ZURhdGEud2luZG93Q29vcmRpbmF0ZXMuY3ggJiYKCQkJCXdpbmRvd0Nvb3JkaW5hdGVzLmN5ID09PSB0aGlzLl9yZXNpemVEYXRhLndpbmRvd0Nvb3JkaW5hdGVzLmN5ICkgewoJCQkJLy8gdGltZW91dCBub3QgcmVmcmVzaGVkCgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0gZWxzZSB7CgkJCQkvLyBjbGVhciBleGlzdGluZyB0aW1lb3V0IC0gaXQgd2lsbCBiZSByZWZyZXNoZWQgYmVsb3cKCQkJCWNsZWFyVGltZW91dCggdGhpcy5fcmVzaXplRGF0YS50aW1lb3V0SWQgKTsKCQkJfQoJCX0KCgkJdGhpcy5fcmVzaXplRGF0YSA9IHsKCQkJdGltZW91dElkOiB0aGlzLl9kZWxheSggIl9yZXNpemVUaW1lb3V0IiwgMjAwICksCgkJCXdpbmRvd0Nvb3JkaW5hdGVzOiB3aW5kb3dDb29yZGluYXRlcwoJCX07CgoJCXJldHVybiB0cnVlOwoJfSwKCglfcmVzaXplVGltZW91dDogZnVuY3Rpb24oKSB7CgkJaWYgKCB0aGlzLl9pc09wZW4gKSB7CgkJCWlmICggIXRoaXMuX2V4cGVjdFJlc2l6ZUV2ZW50KCkgKSB7CgkJCQlpZiAoIHRoaXMuX3VpLmNvbnRhaW5lci5oYXNDbGFzcyggInVpLXBvcHVwLWhpZGRlbiIgKSApIHsKCQkJCQkvLyBlZmZlY3RpdmVseSByYXBpZC1vcGVuIHRoZSBwb3B1cCB3aGlsZSBsZWF2aW5nIHRoZSBzY3JlZW4gaW50YWN0CgkJCQkJdGhpcy5fdWkuY29udGFpbmVyLnJlbW92ZUNsYXNzKCAidWktcG9wdXAtaGlkZGVuIHVpLXBvcHVwLXRydW5jYXRlIiApOwoJCQkJCXRoaXMucmVwb3NpdGlvbiggeyBwb3NpdGlvblRvOiAid2luZG93IiB9ICk7CgkJCQkJdGhpcy5faWdub3JlUmVzaXplRXZlbnRzKCk7CgkJCQl9CgoJCQkJdGhpcy5fcmVzaXplU2NyZWVuKCk7CgkJCQl0aGlzLl9yZXNpemVEYXRhID0gbnVsbDsKCQkJCXRoaXMuX29yaWVudGF0aW9uY2hhbmdlSW5Qcm9ncmVzcyA9IGZhbHNlOwoJCQl9CgkJfSBlbHNlIHsKCQkJdGhpcy5fcmVzaXplRGF0YSA9IG51bGw7CgkJCXRoaXMuX29yaWVudGF0aW9uY2hhbmdlSW5Qcm9ncmVzcyA9IGZhbHNlOwoJCX0KCX0sCgoJX3N0b3BJZ25vcmluZ1Jlc2l6ZUV2ZW50czogZnVuY3Rpb24oKSB7CgkJdGhpcy5faWdub3JlUmVzaXplVG8gPSAwOwoJfSwKCglfaWdub3JlUmVzaXplRXZlbnRzOiBmdW5jdGlvbigpIHsKCQlpZiAoIHRoaXMuX2lnbm9yZVJlc2l6ZVRvICkgewoJCQljbGVhclRpbWVvdXQoIHRoaXMuX2lnbm9yZVJlc2l6ZVRvICk7CgkJfQoJCXRoaXMuX2lnbm9yZVJlc2l6ZVRvID0gdGhpcy5fZGVsYXkoICJfc3RvcElnbm9yaW5nUmVzaXplRXZlbnRzIiwgMTAwMCApOwoJfSwKCglfaGFuZGxlV2luZG93UmVzaXplOiBmdW5jdGlvbigvKiB0aGVFdmVudCAqLykgewoJCWlmICggdGhpcy5faXNPcGVuICYmIHRoaXMuX2lnbm9yZVJlc2l6ZVRvID09PSAwICkgewoJCQlpZiAoICggdGhpcy5fZXhwZWN0UmVzaXplRXZlbnQoKSB8fCB0aGlzLl9vcmllbnRhdGlvbmNoYW5nZUluUHJvZ3Jlc3MgKSAmJgoJCQkJIXRoaXMuX3VpLmNvbnRhaW5lci5oYXNDbGFzcyggInVpLXBvcHVwLWhpZGRlbiIgKSApIHsKCQkJCS8vIGVmZmVjdGl2ZWx5IHJhcGlkLWNsb3NlIHRoZSBwb3B1cCB3aGlsZSBsZWF2aW5nIHRoZSBzY3JlZW4gaW50YWN0CgkJCQl0aGlzLl91aS5jb250YWluZXIKCQkJCQkuYWRkQ2xhc3MoICJ1aS1wb3B1cC1oaWRkZW4gdWktcG9wdXAtdHJ1bmNhdGUiICkKCQkJCQkucmVtb3ZlQXR0ciggInN0eWxlIiApOwoJCQl9CgkJfQoJfSwKCglfaGFuZGxlV2luZG93T3JpZW50YXRpb25jaGFuZ2U6IGZ1bmN0aW9uKC8qIHRoZUV2ZW50ICovKSB7CgkJaWYgKCAhdGhpcy5fb3JpZW50YXRpb25jaGFuZ2VJblByb2dyZXNzICYmIHRoaXMuX2lzT3BlbiAmJiB0aGlzLl9pZ25vcmVSZXNpemVUbyA9PT0gMCApIHsKCQkJdGhpcy5fZXhwZWN0UmVzaXplRXZlbnQoKTsKCQkJdGhpcy5fb3JpZW50YXRpb25jaGFuZ2VJblByb2dyZXNzID0gdHJ1ZTsKCQl9Cgl9LAoKCS8vIFdoZW4gdGhlIHBvcHVwIGlzIG9wZW4sIGF0dGVtcHRpbmcgdG8gZm9jdXMgb24gYW4gZWxlbWVudCB0aGF0IGlzIG5vdCBhCgkvLyBjaGlsZCBvZiB0aGUgcG9wdXAgd2lsbCByZWRpcmVjdCBmb2N1cyB0byB0aGUgcG9wdXAKCV9oYW5kbGVEb2N1bWVudEZvY3VzSW46IGZ1bmN0aW9uKCB0aGVFdmVudCApIHsKCQl2YXIgdGFyZ2V0LAoJCQl0YXJnZXRFbGVtZW50ID0gdGhlRXZlbnQudGFyZ2V0LAoJCQl1aSA9IHRoaXMuX3VpOwoKCQlpZiAoICF0aGlzLl9pc09wZW4gKSB7CgkJCXJldHVybjsKCQl9CgoJCWlmICggdGFyZ2V0RWxlbWVudCAhPT0gdWkuY29udGFpbmVyWyAwIF0gKSB7CgkJCXRhcmdldCA9ICQoIHRhcmdldEVsZW1lbnQgKTsKCQkJaWYgKCAwID09PSB0YXJnZXQucGFyZW50cygpLmZpbHRlciggdWkuY29udGFpbmVyWyAwIF0gKS5sZW5ndGggKSB7CgkJCQkkKCB0aGlzLmRvY3VtZW50WyAwIF0uYWN0aXZlRWxlbWVudCApLm9uZSggImZvY3VzIiwgZnVuY3Rpb24oLyogdGhlRXZlbnQgKi8pIHsKCQkJCQl0YXJnZXQuYmx1cigpOwoJCQkJfSk7CgkJCQl1aS5mb2N1c0VsZW1lbnQuZm9jdXMoKTsKCQkJCXRoZUV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQl0aGVFdmVudC5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24oKTsKCQkJCXJldHVybiBmYWxzZTsKCQkJfSBlbHNlIGlmICggdWkuZm9jdXNFbGVtZW50WyAwIF0gPT09IHVpLmNvbnRhaW5lclsgMCBdICkgewoJCQkJdWkuZm9jdXNFbGVtZW50ID0gdGFyZ2V0OwoJCQl9CgkJfQoKCQl0aGlzLl9pZ25vcmVSZXNpemVFdmVudHMoKTsKCX0sCgoJX3RoZW1lQ2xhc3NGcm9tT3B0aW9uOiBmdW5jdGlvbiggcHJlZml4LCB2YWx1ZSApIHsKCQlyZXR1cm4gKCB2YWx1ZSA/ICggdmFsdWUgPT09ICJub25lIiA/ICIiIDogKCBwcmVmaXggKyB2YWx1ZSApICkgOiAoIHByZWZpeCArICJpbmhlcml0IiApICk7Cgl9LAoKCV9hcHBseVRyYW5zaXRpb246IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQlpZiAoIHZhbHVlICkgewoJCQl0aGlzLl91aS5jb250YWluZXIucmVtb3ZlQ2xhc3MoIHRoaXMuX2ZhbGxiYWNrVHJhbnNpdGlvbiApOwoJCQlpZiAoIHZhbHVlICE9PSAibm9uZSIgKSB7CgkJCQl0aGlzLl9mYWxsYmFja1RyYW5zaXRpb24gPSAkLm1vYmlsZS5fbWF5YmVEZWdyYWRlVHJhbnNpdGlvbiggdmFsdWUgKTsKCQkJCWlmICggdGhpcy5fZmFsbGJhY2tUcmFuc2l0aW9uID09PSAibm9uZSIgKSB7CgkJCQkJdGhpcy5fZmFsbGJhY2tUcmFuc2l0aW9uID0gIiI7CgkJCQl9CgkJCQl0aGlzLl91aS5jb250YWluZXIuYWRkQ2xhc3MoIHRoaXMuX2ZhbGxiYWNrVHJhbnNpdGlvbiApOwoJCQl9CgkJfQoKCQlyZXR1cm4gdGhpczsKCX0sCgoJX3NldE9wdGlvbnM6IGZ1bmN0aW9uKCBuZXdPcHRpb25zICkgewoJCXZhciBjdXJyZW50T3B0aW9ucyA9IHRoaXMub3B0aW9ucywKCQkJdGhlRWxlbWVudCA9IHRoaXMuZWxlbWVudCwKCQkJc2NyZWVuID0gdGhpcy5fdWkuc2NyZWVuOwoKCQlpZiAoIG5ld09wdGlvbnMud3JhcHBlckNsYXNzICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMuX3VpLmNvbnRhaW5lcgoJCQkJLnJlbW92ZUNsYXNzKCBjdXJyZW50T3B0aW9ucy53cmFwcGVyQ2xhc3MgKQoJCQkJLmFkZENsYXNzKCBuZXdPcHRpb25zLndyYXBwZXJDbGFzcyApOwoJCX0KCgkJaWYgKCBuZXdPcHRpb25zLnRoZW1lICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoZUVsZW1lbnQKCQkJCS5yZW1vdmVDbGFzcyggdGhpcy5fdGhlbWVDbGFzc0Zyb21PcHRpb24oICJ1aS1ib2R5LSIsIGN1cnJlbnRPcHRpb25zLnRoZW1lICkgKQoJCQkJLmFkZENsYXNzKCB0aGlzLl90aGVtZUNsYXNzRnJvbU9wdGlvbiggInVpLWJvZHktIiwgbmV3T3B0aW9ucy50aGVtZSApICk7CgkJfQoKCQlpZiAoIG5ld09wdGlvbnMub3ZlcmxheVRoZW1lICE9PSB1bmRlZmluZWQgKSB7CgkJCXNjcmVlbgoJCQkJLnJlbW92ZUNsYXNzKCB0aGlzLl90aGVtZUNsYXNzRnJvbU9wdGlvbiggInVpLW92ZXJsYXktIiwgY3VycmVudE9wdGlvbnMub3ZlcmxheVRoZW1lICkgKQoJCQkJLmFkZENsYXNzKCB0aGlzLl90aGVtZUNsYXNzRnJvbU9wdGlvbiggInVpLW92ZXJsYXktIiwgbmV3T3B0aW9ucy5vdmVybGF5VGhlbWUgKSApOwoKCQkJaWYgKCB0aGlzLl9pc09wZW4gKSB7CgkJCQlzY3JlZW4uYWRkQ2xhc3MoICJpbiIgKTsKCQkJfQoJCX0KCgkJaWYgKCBuZXdPcHRpb25zLnNoYWRvdyAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGVFbGVtZW50LnRvZ2dsZUNsYXNzKCAidWktb3ZlcmxheS1zaGFkb3ciLCBuZXdPcHRpb25zLnNoYWRvdyApOwoJCX0KCgkJaWYgKCBuZXdPcHRpb25zLmNvcm5lcnMgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhlRWxlbWVudC50b2dnbGVDbGFzcyggInVpLWNvcm5lci1hbGwiLCBuZXdPcHRpb25zLmNvcm5lcnMgKTsKCQl9CgoJCWlmICggbmV3T3B0aW9ucy50cmFuc2l0aW9uICE9PSB1bmRlZmluZWQgKSB7CgkJCWlmICggIXRoaXMuX2N1cnJlbnRUcmFuc2l0aW9uICkgewoJCQkJdGhpcy5fYXBwbHlUcmFuc2l0aW9uKCBuZXdPcHRpb25zLnRyYW5zaXRpb24gKTsKCQkJfQoJCX0KCgkJaWYgKCBuZXdPcHRpb25zLnRvbGVyYW5jZSAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLl9zZXRUb2xlcmFuY2UoIG5ld09wdGlvbnMudG9sZXJhbmNlICk7CgkJfQoKCQlpZiAoIG5ld09wdGlvbnMuZGlzYWJsZWQgIT09IHVuZGVmaW5lZCApIHsKCQkJaWYgKCBuZXdPcHRpb25zLmRpc2FibGVkICkgewoJCQkJdGhpcy5jbG9zZSgpOwoJCQl9CgkJfQoKCQlyZXR1cm4gdGhpcy5fc3VwZXIoIG5ld09wdGlvbnMgKTsKCX0sCgoJX3NldFRvbGVyYW5jZTogZnVuY3Rpb24oIHZhbHVlICkgewoJCXZhciB0b2wgPSB7IHQ6IDMwLCByOiAxNSwgYjogMzAsIGw6IDE1IH0sCgkJCWFyOwoKCQlpZiAoIHZhbHVlICE9PSB1bmRlZmluZWQgKSB7CgkJCWFyID0gU3RyaW5nKCB2YWx1ZSApLnNwbGl0KCAiLCIgKTsKCgkJCSQuZWFjaCggYXIsIGZ1bmN0aW9uKCBpZHgsIHZhbCApIHsgYXJbIGlkeCBdID0gcGFyc2VJbnQoIHZhbCwgMTAgKTsgfSApOwoKCQkJc3dpdGNoKCBhci5sZW5ndGggKSB7CgkJCQkvLyBBbGwgdmFsdWVzIGFyZSB0byBiZSB0aGUgc2FtZQoJCQkJY2FzZSAxOgoJCQkJCWlmICggIWlzTmFOKCBhclsgMCBdICkgKSB7CgkJCQkJCXRvbC50ID0gdG9sLnIgPSB0b2wuYiA9IHRvbC5sID0gYXJbIDAgXTsKCQkJCQl9CgkJCQkJYnJlYWs7CgoJCQkJLy8gVGhlIGZpcnN0IHZhbHVlIGRlbm90ZXMgdG9wL2JvdHRvbSB0b2xlcmFuY2UsIGFuZCB0aGUgc2Vjb25kIHZhbHVlIGRlbm90ZXMgbGVmdC9yaWdodCB0b2xlcmFuY2UKCQkJCWNhc2UgMjoKCQkJCQlpZiAoICFpc05hTiggYXJbIDAgXSApICkgewoJCQkJCQl0b2wudCA9IHRvbC5iID0gYXJbIDAgXTsKCQkJCQl9CgkJCQkJaWYgKCAhaXNOYU4oIGFyWyAxIF0gKSApIHsKCQkJCQkJdG9sLmwgPSB0b2wuciA9IGFyWyAxIF07CgkJCQkJfQoJCQkJCWJyZWFrOwoKCQkJCS8vIFRoZSBhcnJheSBjb250YWlucyB2YWx1ZXMgaW4gdGhlIG9yZGVyIHRvcCwgcmlnaHQsIGJvdHRvbSwgbGVmdAoJCQkJY2FzZSA0OgoJCQkJCWlmICggIWlzTmFOKCBhclsgMCBdICkgKSB7CgkJCQkJCXRvbC50ID0gYXJbIDAgXTsKCQkJCQl9CgkJCQkJaWYgKCAhaXNOYU4oIGFyWyAxIF0gKSApIHsKCQkJCQkJdG9sLnIgPSBhclsgMSBdOwoJCQkJCX0KCQkJCQlpZiAoICFpc05hTiggYXJbIDIgXSApICkgewoJCQkJCQl0b2wuYiA9IGFyWyAyIF07CgkJCQkJfQoJCQkJCWlmICggIWlzTmFOKCBhclsgMyBdICkgKSB7CgkJCQkJCXRvbC5sID0gYXJbIDMgXTsKCQkJCQl9CgkJCQkJYnJlYWs7CgoJCQkJZGVmYXVsdDoKCQkJCQlicmVhazsKCQkJfQoJCX0KCgkJdGhpcy5fdG9sZXJhbmNlID0gdG9sOwoJCXJldHVybiB0aGlzOwoJfSwKCglfY2xhbXBQb3B1cFdpZHRoOiBmdW5jdGlvbiggaW5mb09ubHkgKSB7CgkJdmFyIG1lbnVTaXplLAoJCQl3aW5kb3dDb29yZGluYXRlcyA9IGdldFdpbmRvd0Nvb3JkaW5hdGVzKCB0aGlzLndpbmRvdyApLAoJCQkvLyByZWN0YW5nbGUgd2l0aGluIHdoaWNoIHRoZSBwb3B1cCBtdXN0IGZpdAoJCQlyZWN0YW5nbGUgPSB7CgkJCQl4OiB0aGlzLl90b2xlcmFuY2UubCwKCQkJCXk6IHdpbmRvd0Nvb3JkaW5hdGVzLnkgKyB0aGlzLl90b2xlcmFuY2UudCwKCQkJCWN4OiB3aW5kb3dDb29yZGluYXRlcy5jeCAtIHRoaXMuX3RvbGVyYW5jZS5sIC0gdGhpcy5fdG9sZXJhbmNlLnIsCgkJCQljeTogd2luZG93Q29vcmRpbmF0ZXMuY3kgLSB0aGlzLl90b2xlcmFuY2UudCAtIHRoaXMuX3RvbGVyYW5jZS5iCgkJCX07CgoJCWlmICggIWluZm9Pbmx5ICkgewoJCQkvLyBDbGFtcCB0aGUgd2lkdGggb2YgdGhlIG1lbnUgYmVmb3JlIGdyYWJiaW5nIGl0cyBzaXplCgkJCXRoaXMuX3VpLmNvbnRhaW5lci5jc3MoICJtYXgtd2lkdGgiLCByZWN0YW5nbGUuY3ggKTsKCQl9CgoJCW1lbnVTaXplID0gewoJCQljeDogdGhpcy5fdWkuY29udGFpbmVyLm91dGVyV2lkdGgoIHRydWUgKSwKCQkJY3k6IHRoaXMuX3VpLmNvbnRhaW5lci5vdXRlckhlaWdodCggdHJ1ZSApCgkJfTsKCgkJcmV0dXJuIHsgcmM6IHJlY3RhbmdsZSwgbWVudVNpemU6IG1lbnVTaXplIH07Cgl9LAoKCV9jYWxjdWxhdGVGaW5hbExvY2F0aW9uOiBmdW5jdGlvbiggZGVzaXJlZCwgY2xhbXBJbmZvICkgewoJCXZhciByZXR1cm5WYWx1ZSwKCQkJcmVjdGFuZ2xlID0gY2xhbXBJbmZvLnJjLAoJCQltZW51U2l6ZSA9IGNsYW1wSW5mby5tZW51U2l6ZTsKCgoJCS8vIENlbnRlciB0aGUgbWVudSBvdmVyIHRoZSBkZXNpcmVkIGNvb3JkaW5hdGVzLCB3aGlsZSBub3QgZ29pbmcgb3V0c2lkZQoJCS8vIHRoZSB3aW5kb3cgdG9sZXJhbmNlcy4gVGhpcyB3aWxsIGNlbnRlciB3cnQuIHRoZSB3aW5kb3cgaWYgdGhlIHBvcHVwIGlzCgkJLy8gdG9vIGxhcmdlLgoJCXJldHVyblZhbHVlID0gewoJCQlsZWZ0OiBmaXRTZWdtZW50SW5zaWRlU2VnbWVudCggcmVjdGFuZ2xlLmN4LCBtZW51U2l6ZS5jeCwgcmVjdGFuZ2xlLngsIGRlc2lyZWQueCApLAoJCQl0b3A6IGZpdFNlZ21lbnRJbnNpZGVTZWdtZW50KCByZWN0YW5nbGUuY3ksIG1lbnVTaXplLmN5LCByZWN0YW5nbGUueSwgZGVzaXJlZC55ICkKCQl9OwoKCQkvLyBNYWtlIHN1cmUgdGhlIHRvcCBvZiB0aGUgbWVudSBpcyB2aXNpYmxlCgkJcmV0dXJuVmFsdWUudG9wID0gTWF0aC5tYXgoIDAsIHJldHVyblZhbHVlLnRvcCApOwoKCQkvLyBJZiB0aGUgaGVpZ2h0IG9mIHRoZSBtZW51IGlzIHNtYWxsZXIgdGhhbiB0aGUgaGVpZ2h0IG9mIHRoZSBkb2N1bWVudAoJCS8vIGFsaWduIHRoZSBib3R0b20gd2l0aCB0aGUgYm90dG9tIG9mIHRoZSBkb2N1bWVudAoKCQlyZXR1cm5WYWx1ZS50b3AgLT0gTWF0aC5taW4oIHJldHVyblZhbHVlLnRvcCwKCQkJTWF0aC5tYXgoIDAsIHJldHVyblZhbHVlLnRvcCArIG1lbnVTaXplLmN5IC0gdGhpcy5kb2N1bWVudC5oZWlnaHQoKSApICk7CgoJCXJldHVybiByZXR1cm5WYWx1ZTsKCX0sCgoJLy8gVHJ5IGFuZCBjZW50ZXIgdGhlIG92ZXJsYXkgb3ZlciB0aGUgZ2l2ZW4gY29vcmRpbmF0ZXMKCV9wbGFjZW1lbnRDb29yZHM6IGZ1bmN0aW9uKCBkZXNpcmVkICkgewoJCXJldHVybiB0aGlzLl9jYWxjdWxhdGVGaW5hbExvY2F0aW9uKCBkZXNpcmVkLCB0aGlzLl9jbGFtcFBvcHVwV2lkdGgoKSApOwoJfSwKCglfY3JlYXRlUHJlcmVxdWlzaXRlczogZnVuY3Rpb24oIHNjcmVlblByZXJlcXVpc2l0ZSwgY29udGFpbmVyUHJlcmVxdWlzaXRlLCB3aGVuRG9uZSApIHsKCQl2YXIgcHJlcmVxdWlzaXRlcywKCQkJc2VsZiA9IHRoaXM7CgoJCS8vIEl0IGlzIGltcG9ydGFudCB0byBtYWludGFpbiBib3RoIHRoZSBsb2NhbCB2YXJpYWJsZSBwcmVyZXF1aXNpdGVzIGFuZAoJCS8vIHNlbGYuX3ByZXJlcXVpc2l0ZXMuIFRoZSBsb2NhbCB2YXJpYWJsZSByZW1haW5zIGluIHRoZSBjbG9zdXJlIG9mIHRoZQoJCS8vIGZ1bmN0aW9ucyB3aGljaCBjYWxsIHRoZSBjYWxsYmFja3MgcGFzc2VkIGluLiBUaGUgY29tcGFyaXNvbiBiZXR3ZWVuIHRoZQoJCS8vIGxvY2FsIHZhcmlhYmxlIGFuZCBzZWxmLl9wcmVyZXF1aXNpdGVzIGlzIG5lY2Vzc2FyeSwgYmVjYXVzZSBvbmNlIGEKCQkvLyBmdW5jdGlvbiBoYXMgYmVlbiBwYXNzZWQgdG8gLmFuaW1hdGlvbkNvbXBsZXRlKCkgaXQgd2lsbCBiZSBjYWxsZWQgbmV4dAoJCS8vIHRpbWUgYW4gYW5pbWF0aW9uIGNvbXBsZXRlcywgZXZlbiBpZiB0aGF0J3Mgbm90IHRoZSBhbmltYXRpb24gd2hvc2UgZW5kCgkJLy8gdGhlIGZ1bmN0aW9uIHdhcyBzdXBwb3NlZCB0byBjYXRjaCAoZm9yIGV4YW1wbGUsIGlmIGFuIGFib3J0IGhhcHBlbnMKCQkvLyBkdXJpbmcgdGhlIG9wZW5pbmcgYW5pbWF0aW9uLCB0aGUgLmFuaW1hdGlvbkNvbXBsZXRlIGhhbmRsZXIgaXMgbm90CgkJLy8gY2FsbGVkIGZvciB0aGF0IGFuaW1hdGlvbiBhbnltb3JlLCBidXQgdGhlIGhhbmRsZXIgcmVtYWlucyBhdHRhY2hlZCwgc28KCQkvLyBpdCBpcyBjYWxsZWQgdGhlIG5leHQgdGltZSB0aGUgcG9wdXAgaXMgb3BlbmVkIC0gbWFraW5nIGl0IHN0YWxlLgoJCS8vIENvbXBhcmluZyB0aGUgbG9jYWwgdmFyaWFibGUgcHJlcmVxdWlzaXRlcyB0byB0aGUgd2lkZ2V0LWxldmVsIHZhcmlhYmxlCgkJLy8gc2VsZi5fcHJlcmVxdWlzaXRlcyBlbnN1cmVzIHRoYXQgY2FsbGJhY2tzIHRyaWdnZXJlZCBieSBhIHN0YWxlCgkJLy8gLmFuaW1hdGlvbkNvbXBsZXRlIHdpbGwgYmUgaWdub3JlZC4KCgkJcHJlcmVxdWlzaXRlcyA9IHsKCQkJc2NyZWVuOiAkLkRlZmVycmVkKCksCgkJCWNvbnRhaW5lcjogJC5EZWZlcnJlZCgpCgkJfTsKCgkJcHJlcmVxdWlzaXRlcy5zY3JlZW4udGhlbiggZnVuY3Rpb24oKSB7CgkJCWlmICggcHJlcmVxdWlzaXRlcyA9PT0gc2VsZi5fcHJlcmVxdWlzaXRlcyApIHsKCQkJCXNjcmVlblByZXJlcXVpc2l0ZSgpOwoJCQl9CgkJfSk7CgoJCXByZXJlcXVpc2l0ZXMuY29udGFpbmVyLnRoZW4oIGZ1bmN0aW9uKCkgewoJCQlpZiAoIHByZXJlcXVpc2l0ZXMgPT09IHNlbGYuX3ByZXJlcXVpc2l0ZXMgKSB7CgkJCQljb250YWluZXJQcmVyZXF1aXNpdGUoKTsKCQkJfQoJCX0pOwoKCQkkLndoZW4oIHByZXJlcXVpc2l0ZXMuc2NyZWVuLCBwcmVyZXF1aXNpdGVzLmNvbnRhaW5lciApLmRvbmUoIGZ1bmN0aW9uKCkgewoJCQlpZiAoIHByZXJlcXVpc2l0ZXMgPT09IHNlbGYuX3ByZXJlcXVpc2l0ZXMgKSB7CgkJCQlzZWxmLl9wcmVyZXF1aXNpdGVzID0gbnVsbDsKCQkJCXdoZW5Eb25lKCk7CgkJCX0KCQl9KTsKCgkJc2VsZi5fcHJlcmVxdWlzaXRlcyA9IHByZXJlcXVpc2l0ZXM7Cgl9LAoKCV9hbmltYXRlOiBmdW5jdGlvbiggYXJncyApIHsKCQkvLyBOT1RFIGJlZm9yZSByZW1vdmluZyB0aGUgZGVmYXVsdCBhbmltYXRpb24gb2YgdGhlIHNjcmVlbgoJCS8vICAgICAgdGhpcyBoYWQgYW4gYW5pbWF0ZSBjYWxsYmFjayB0aGF0IHdvdWxkIHJlc29sdmUgdGhlIGRlZmVycmVkCgkJLy8gICAgICBub3cgdGhlIGRlZmVycmVkIGlzIHJlc29sdmVkIGltbWVkaWF0ZWx5CgkJLy8gVE9ETyByZW1vdmUgdGhlIGRlcGVuZGVuY3kgb24gdGhlIHNjcmVlbiBkZWZlcnJlZAoJCXRoaXMuX3VpLnNjcmVlbgoJCQkucmVtb3ZlQ2xhc3MoIGFyZ3MuY2xhc3NUb1JlbW92ZSApCgkJCS5hZGRDbGFzcyggYXJncy5zY3JlZW5DbGFzc1RvQWRkICk7CgoJCWFyZ3MucHJlcmVxdWlzaXRlcy5zY3JlZW4ucmVzb2x2ZSgpOwoKCQlpZiAoIGFyZ3MudHJhbnNpdGlvbiAmJiBhcmdzLnRyYW5zaXRpb24gIT09ICJub25lIiApIHsKCQkJaWYgKCBhcmdzLmFwcGx5VHJhbnNpdGlvbiApIHsKCQkJCXRoaXMuX2FwcGx5VHJhbnNpdGlvbiggYXJncy50cmFuc2l0aW9uICk7CgkJCX0KCQkJaWYgKCB0aGlzLl9mYWxsYmFja1RyYW5zaXRpb24gKSB7CgkJCQl0aGlzLl91aS5jb250YWluZXIKCQkJCQkuYW5pbWF0aW9uQ29tcGxldGUoICQucHJveHkoIGFyZ3MucHJlcmVxdWlzaXRlcy5jb250YWluZXIsICJyZXNvbHZlIiApICkKCQkJCQkuYWRkQ2xhc3MoIGFyZ3MuY29udGFpbmVyQ2xhc3NUb0FkZCApCgkJCQkJLnJlbW92ZUNsYXNzKCBhcmdzLmNsYXNzVG9SZW1vdmUgKTsKCQkJCXJldHVybjsKCQkJfQoJCX0KCQl0aGlzLl91aS5jb250YWluZXIucmVtb3ZlQ2xhc3MoIGFyZ3MuY2xhc3NUb1JlbW92ZSApOwoJCWFyZ3MucHJlcmVxdWlzaXRlcy5jb250YWluZXIucmVzb2x2ZSgpOwoJfSwKCgkvLyBUaGUgZGVzaXJlZCBjb29yZGluYXRlcyBwYXNzZWQgaW4gd2lsbCBiZSByZXR1cm5lZCB1bnRvdWNoZWQgaWYgbm8gcmVmZXJlbmNlIGVsZW1lbnQgY2FuIGJlIGlkZW50aWZpZWQgdmlhCgkvLyBkZXNpcmVkUG9zaXRpb24ucG9zaXRpb25Uby4gTmV2ZXJ0aGVsZXNzLCB0aGlzIGZ1bmN0aW9uIGVuc3VyZXMgdGhhdCBpdHMgcmV0dXJuIHZhbHVlIGFsd2F5cyBjb250YWlucyB2YWxpZAoJLy8geCBhbmQgeSBjb29yZGluYXRlcyBieSBzcGVjaWZ5aW5nIHRoZSBjZW50ZXIgbWlkZGxlIG9mIHRoZSB3aW5kb3cgaWYgdGhlIGNvb3JkaW5hdGVzIGFyZSBhYnNlbnQuCgkvLyBvcHRpb25zOiB7IHg6IGNvb3JkaW5hdGUsIHk6IGNvb3JkaW5hdGUsIHBvc2l0aW9uVG86IHN0cmluZzogIm9yaWdpbiIsICJ3aW5kb3ciLCBvciBqUXVlcnkgc2VsZWN0b3IKCV9kZXNpcmVkQ29vcmRzOiBmdW5jdGlvbiggb3Blbk9wdGlvbnMgKSB7CgkJdmFyIG9mZnNldCwKCQkJZHN0ID0gbnVsbCwKCQkJd2luZG93Q29vcmRpbmF0ZXMgPSBnZXRXaW5kb3dDb29yZGluYXRlcyggdGhpcy53aW5kb3cgKSwKCQkJeCA9IG9wZW5PcHRpb25zLngsCgkJCXkgPSBvcGVuT3B0aW9ucy55LAoJCQlwVG8gPSBvcGVuT3B0aW9ucy5wb3NpdGlvblRvOwoKCQkvLyBFc3RhYmxpc2ggd2hpY2ggZWxlbWVudCB3aWxsIHNlcnZlIGFzIHRoZSByZWZlcmVuY2UKCQlpZiAoIHBUbyAmJiBwVG8gIT09ICJvcmlnaW4iICkgewoJCQlpZiAoIHBUbyA9PT0gIndpbmRvdyIgKSB7CgkJCQl4ID0gd2luZG93Q29vcmRpbmF0ZXMuY3ggLyAyICsgd2luZG93Q29vcmRpbmF0ZXMueDsKCQkJCXkgPSB3aW5kb3dDb29yZGluYXRlcy5jeSAvIDIgKyB3aW5kb3dDb29yZGluYXRlcy55OwoJCQl9IGVsc2UgewoJCQkJdHJ5IHsKCQkJCQlkc3QgPSAkKCBwVG8gKTsKCQkJCX0gY2F0Y2goIGVyciApIHsKCQkJCQlkc3QgPSBudWxsOwoJCQkJfQoJCQkJaWYgKCBkc3QgKSB7CgkJCQkJZHN0LmZpbHRlciggIjp2aXNpYmxlIiApOwoJCQkJCWlmICggZHN0Lmxlbmd0aCA9PT0gMCApIHsKCQkJCQkJZHN0ID0gbnVsbDsKCQkJCQl9CgkJCQl9CgkJCX0KCQl9CgoJCS8vIElmIGFuIGVsZW1lbnQgd2FzIGZvdW5kLCBjZW50ZXIgb3ZlciBpdAoJCWlmICggZHN0ICkgewoJCQlvZmZzZXQgPSBkc3Qub2Zmc2V0KCk7CgkJCXggPSBvZmZzZXQubGVmdCArIGRzdC5vdXRlcldpZHRoKCkgLyAyOwoJCQl5ID0gb2Zmc2V0LnRvcCArIGRzdC5vdXRlckhlaWdodCgpIC8gMjsKCQl9CgoJCS8vIE1ha2Ugc3VyZSB4IGFuZCB5IGFyZSB2YWxpZCBudW1iZXJzIC0gY2VudGVyIG92ZXIgdGhlIHdpbmRvdwoJCWlmICggJC50eXBlKCB4ICkgIT09ICJudW1iZXIiIHx8IGlzTmFOKCB4ICkgKSB7CgkJCXggPSB3aW5kb3dDb29yZGluYXRlcy5jeCAvIDIgKyB3aW5kb3dDb29yZGluYXRlcy54OwoJCX0KCQlpZiAoICQudHlwZSggeSApICE9PSAibnVtYmVyIiB8fCBpc05hTiggeSApICkgewoJCQl5ID0gd2luZG93Q29vcmRpbmF0ZXMuY3kgLyAyICsgd2luZG93Q29vcmRpbmF0ZXMueTsKCQl9CgoJCXJldHVybiB7IHg6IHgsIHk6IHkgfTsKCX0sCgoJX3JlcG9zaXRpb246IGZ1bmN0aW9uKCBvcGVuT3B0aW9ucyApIHsKCQkvLyBXZSBvbmx5IGNhcmUgYWJvdXQgcG9zaXRpb24tcmVsYXRlZCBwYXJhbWV0ZXJzIGZvciByZXBvc2l0aW9uaW5nCgkJb3Blbk9wdGlvbnMgPSB7CgkJCXg6IG9wZW5PcHRpb25zLngsCgkJCXk6IG9wZW5PcHRpb25zLnksCgkJCXBvc2l0aW9uVG86IG9wZW5PcHRpb25zLnBvc2l0aW9uVG8KCQl9OwoJCXRoaXMuX3RyaWdnZXIoICJiZWZvcmVwb3NpdGlvbiIsIHVuZGVmaW5lZCwgb3Blbk9wdGlvbnMgKTsKCQl0aGlzLl91aS5jb250YWluZXIub2Zmc2V0KCB0aGlzLl9wbGFjZW1lbnRDb29yZHMoIHRoaXMuX2Rlc2lyZWRDb29yZHMoIG9wZW5PcHRpb25zICkgKSApOwoJfSwKCglyZXBvc2l0aW9uOiBmdW5jdGlvbiggb3Blbk9wdGlvbnMgKSB7CgkJaWYgKCB0aGlzLl9pc09wZW4gKSB7CgkJCXRoaXMuX3JlcG9zaXRpb24oIG9wZW5PcHRpb25zICk7CgkJfQoJfSwKCglfb3BlblByZXJlcXVpc2l0ZXNDb21wbGV0ZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5fdWkuY29udGFpbmVyLmFkZENsYXNzKCAidWktcG9wdXAtYWN0aXZlIiApOwoJCXRoaXMuX2lzT3BlbiA9IHRydWU7CgkJdGhpcy5fcmVzaXplU2NyZWVuKCk7CgkJdGhpcy5fdWkuY29udGFpbmVyLmF0dHIoICJ0YWJpbmRleCIsICIwIiApLmZvY3VzKCk7CgkJdGhpcy5faWdub3JlUmVzaXplRXZlbnRzKCk7CgkJdGhpcy5fdHJpZ2dlciggImFmdGVyb3BlbiIgKTsKCX0sCgoJX29wZW46IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCXZhciBvcGVuT3B0aW9ucyA9ICQuZXh0ZW5kKCB7fSwgdGhpcy5vcHRpb25zLCBvcHRpb25zICksCgkJCS8vIFRPRE8gbW92ZSBibGFja2xpc3QgdG8gcHJpdmF0ZSBtZXRob2QKCQkJYW5kcm9pZEJsYWNrbGlzdCA9ICggZnVuY3Rpb24oKSB7CgkJCQl2YXIgdWEgPSBuYXZpZ2F0b3IudXNlckFnZW50LAoJCQkJCS8vIFJlbmRlcmluZyBlbmdpbmUgaXMgV2Via2l0LCBhbmQgY2FwdHVyZSBtYWpvciB2ZXJzaW9uCgkJCQkJd2ttYXRjaCA9IHVhLm1hdGNoKCAvQXBwbGVXZWJLaXRcLyhbMC05XC5dKykvICksCgkJCQkJd2t2ZXJzaW9uID0gISF3a21hdGNoICYmIHdrbWF0Y2hbIDEgXSwKCQkJCQlhbmRyb2lkbWF0Y2ggPSB1YS5tYXRjaCggL0FuZHJvaWQgKFxkKyg/OlwuXGQrKSkvICksCgkJCQkJYW5kdmVyc2lvbiA9ICEhYW5kcm9pZG1hdGNoICYmIGFuZHJvaWRtYXRjaFsgMSBdLAoJCQkJCWNocm9tZW1hdGNoID0gdWEuaW5kZXhPZiggIkNocm9tZSIgKSA+IC0xOwoKCQkJCS8vIFBsYXRmb3JtIGlzIEFuZHJvaWQsIFdlYktpdCB2ZXJzaW9uIGlzIGdyZWF0ZXIgdGhhbiA1MzQuMTMgKCBBbmRyb2lkIDMuMi4xICkgYW5kIG5vdCBDaHJvbWUuCgkJCQlpZiAoIGFuZHJvaWRtYXRjaCAhPT0gbnVsbCAmJiBhbmR2ZXJzaW9uID09PSAiNC4wIiAmJiB3a3ZlcnNpb24gJiYgd2t2ZXJzaW9uID4gNTM0LjEzICYmICFjaHJvbWVtYXRjaCApIHsKCQkJCQlyZXR1cm4gdHJ1ZTsKCQkJCX0KCQkJCXJldHVybiBmYWxzZTsKCQkJfSgpKTsKCgkJLy8gQ291bnQgZG93biB0byB0cmlnZ2VyaW5nICJwb3B1cGFmdGVyb3BlbiIgLSB3ZSBoYXZlIHR3byBwcmVyZXF1aXNpdGVzOgoJCS8vIDEuIFRoZSBwb3B1cCB3aW5kb3cgYW5pbWF0aW9uIGNvbXBsZXRlcyAoY29udGFpbmVyKCkpCgkJLy8gMi4gVGhlIHNjcmVlbiBvcGFjaXR5IGFuaW1hdGlvbiBjb21wbGV0ZXMgKHNjcmVlbigpKQoJCXRoaXMuX2NyZWF0ZVByZXJlcXVpc2l0ZXMoCgkJCSQubm9vcCwKCQkJJC5ub29wLAoJCQkkLnByb3h5KCB0aGlzLCAiX29wZW5QcmVyZXF1aXNpdGVzQ29tcGxldGUiICkgKTsKCgkJdGhpcy5fY3VycmVudFRyYW5zaXRpb24gPSBvcGVuT3B0aW9ucy50cmFuc2l0aW9uOwoJCXRoaXMuX2FwcGx5VHJhbnNpdGlvbiggb3Blbk9wdGlvbnMudHJhbnNpdGlvbiApOwoKCQl0aGlzLl91aS5zY3JlZW4ucmVtb3ZlQ2xhc3MoICJ1aS1zY3JlZW4taGlkZGVuIiApOwoJCXRoaXMuX3VpLmNvbnRhaW5lci5yZW1vdmVDbGFzcyggInVpLXBvcHVwLXRydW5jYXRlIiApOwoKCQkvLyBHaXZlIGFwcGxpY2F0aW9ucyBhIGNoYW5jZSB0byBtb2RpZnkgdGhlIGNvbnRlbnRzIG9mIHRoZSBjb250YWluZXIgYmVmb3JlIGl0IGFwcGVhcnMKCQl0aGlzLl9yZXBvc2l0aW9uKCBvcGVuT3B0aW9ucyApOwoKCQl0aGlzLl91aS5jb250YWluZXIucmVtb3ZlQ2xhc3MoICJ1aS1wb3B1cC1oaWRkZW4iICk7CgoJCWlmICggdGhpcy5vcHRpb25zLm92ZXJsYXlUaGVtZSAmJiBhbmRyb2lkQmxhY2tsaXN0ICkgewoJCQkvKiBUT0RPOiBUaGUgbmF0aXZlIGJyb3dzZXIgb24gQW5kcm9pZCA0LjAuWCAoIkljZSBDcmVhbSBTYW5kd2ljaCIpIHN1ZmZlcnMgZnJvbSBhbiBpc3N1ZSB3aGVyZSB0aGUgcG9wdXAgb3ZlcmxheSBhcHBlYXJzIHRvIGJlIHotaW5kZXhlZCBhYm92ZSB0aGUgcG9wdXAgaXRzZWxmIHdoZW4gY2VydGFpbiBvdGhlciBzdHlsZXMgZXhpc3Qgb24gdGhlIHNhbWUgcGFnZSAtLSBuYW1lbHksIGFueSBlbGVtZW50IHNldCB0byBgcG9zaXRpb246IGZpeGVkYCBhbmQgY2VydGFpbiB0eXBlcyBvZiBpbnB1dC4gVGhlc2UgaXNzdWVzIGFyZSByZW1pbmlzY2VudCBvZiBwcmV2aW91c2x5IHVuY292ZXJlZCBidWdzIGluIG9sZGVyIHZlcnNpb25zIG9mIEFuZHJvaWQncyBuYXRpdmUgYnJvd3NlcjogaHR0cHM6Ly9naXRodWIuY29tL3Njb3R0amVobC9EZXZpY2UtQnVncy9pc3N1ZXMvMwoJCQlUaGlzIGZpeCBjbG9zZXMgdGhlIGZvbGxvd2luZyBidWdzICggSSB1c2UgImNsb3NlcyIgd2l0aCByZWx1Y3RhbmNlLCBhbmQgc3RyZXNzIHRoYXQgdGhpcyBpc3N1ZSBzaG91bGQgYmUgcmV2aXNpdGVkIGFzIHNvb24gYXMgcG9zc2libGUgKToKCQkJaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnktbW9iaWxlL2lzc3Vlcy80ODE2CgkJCWh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5LW1vYmlsZS9pc3N1ZXMvNDg0NAoJCQlodHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L2pxdWVyeS1tb2JpbGUvaXNzdWVzLzQ4NzQKCQkJKi8KCgkJCS8vIFRPRE8gc29ydCBvdXQgd2h5IHRoaXMuX3BhZ2UgaXNuJ3Qgd29ya2luZwoJCQl0aGlzLmVsZW1lbnQuY2xvc2VzdCggIi51aS1wYWdlIiApLmFkZENsYXNzKCAidWktcG9wdXAtb3BlbiIgKTsKCQl9CgkJdGhpcy5fYW5pbWF0ZSh7CgkJCWFkZGl0aW9uYWxDb25kaXRpb246IHRydWUsCgkJCXRyYW5zaXRpb246IG9wZW5PcHRpb25zLnRyYW5zaXRpb24sCgkJCWNsYXNzVG9SZW1vdmU6ICIiLAoJCQlzY3JlZW5DbGFzc1RvQWRkOiAiaW4iLAoJCQljb250YWluZXJDbGFzc1RvQWRkOiAiaW4iLAoJCQlhcHBseVRyYW5zaXRpb246IGZhbHNlLAoJCQlwcmVyZXF1aXNpdGVzOiB0aGlzLl9wcmVyZXF1aXNpdGVzCgkJfSk7Cgl9LAoKCV9jbG9zZVByZXJlcXVpc2l0ZVNjcmVlbjogZnVuY3Rpb24oKSB7CgkJdGhpcy5fdWkuc2NyZWVuCgkJCS5yZW1vdmVDbGFzcyggIm91dCIgKQoJCQkuYWRkQ2xhc3MoICJ1aS1zY3JlZW4taGlkZGVuIiApOwoJfSwKCglfY2xvc2VQcmVyZXF1aXNpdGVDb250YWluZXI6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3VpLmNvbnRhaW5lcgoJCQkucmVtb3ZlQ2xhc3MoICJyZXZlcnNlIG91dCIgKQoJCQkuYWRkQ2xhc3MoICJ1aS1wb3B1cC1oaWRkZW4gdWktcG9wdXAtdHJ1bmNhdGUiICkKCQkJLnJlbW92ZUF0dHIoICJzdHlsZSIgKTsKCX0sCgoJX2Nsb3NlUHJlcmVxdWlzaXRlc0RvbmU6IGZ1bmN0aW9uKCkgewoJCXZhciBjb250YWluZXIgPSB0aGlzLl91aS5jb250YWluZXI7CgoJCWNvbnRhaW5lci5yZW1vdmVBdHRyKCAidGFiaW5kZXgiICk7CgoJCS8vIHJlbW92ZSB0aGUgZ2xvYmFsIG11dGV4IGZvciBwb3B1cHMKCQkkLm1vYmlsZS5wb3B1cC5hY3RpdmUgPSB1bmRlZmluZWQ7CgoJCS8vIEJsdXIgZWxlbWVudHMgaW5zaWRlIHRoZSBjb250YWluZXIsIGluY2x1ZGluZyB0aGUgY29udGFpbmVyCgkJJCggIjpmb2N1cyIsIGNvbnRhaW5lclsgMCBdICkuYWRkKCBjb250YWluZXJbIDAgXSApLmJsdXIoKTsKCgkJLy8gYWxlcnQgdXNlcnMgdGhhdCB0aGUgcG9wdXAgaXMgY2xvc2VkCgkJdGhpcy5fdHJpZ2dlciggImFmdGVyY2xvc2UiICk7Cgl9LAoKCV9jbG9zZTogZnVuY3Rpb24oIGltbWVkaWF0ZSApIHsKCQl0aGlzLl91aS5jb250YWluZXIucmVtb3ZlQ2xhc3MoICJ1aS1wb3B1cC1hY3RpdmUiICk7CgkJdGhpcy5fcGFnZS5yZW1vdmVDbGFzcyggInVpLXBvcHVwLW9wZW4iICk7CgoJCXRoaXMuX2lzT3BlbiA9IGZhbHNlOwoKCQkvLyBDb3VudCBkb3duIHRvIHRyaWdnZXJpbmcgInBvcHVwYWZ0ZXJjbG9zZSIgLSB3ZSBoYXZlIHR3byBwcmVyZXF1aXNpdGVzOgoJCS8vIDEuIFRoZSBwb3B1cCB3aW5kb3cgcmV2ZXJzZSBhbmltYXRpb24gY29tcGxldGVzIChjb250YWluZXIoKSkKCQkvLyAyLiBUaGUgc2NyZWVuIG9wYWNpdHkgYW5pbWF0aW9uIGNvbXBsZXRlcyAoc2NyZWVuKCkpCgkJdGhpcy5fY3JlYXRlUHJlcmVxdWlzaXRlcygKCQkJJC5wcm94eSggdGhpcywgIl9jbG9zZVByZXJlcXVpc2l0ZVNjcmVlbiIgKSwKCQkJJC5wcm94eSggdGhpcywgIl9jbG9zZVByZXJlcXVpc2l0ZUNvbnRhaW5lciIgKSwKCQkJJC5wcm94eSggdGhpcywgIl9jbG9zZVByZXJlcXVpc2l0ZXNEb25lIiApICk7CgoJCXRoaXMuX2FuaW1hdGUoIHsKCQkJYWRkaXRpb25hbENvbmRpdGlvbjogdGhpcy5fdWkuc2NyZWVuLmhhc0NsYXNzKCAiaW4iICksCgkJCXRyYW5zaXRpb246ICggaW1tZWRpYXRlID8gIm5vbmUiIDogKCB0aGlzLl9jdXJyZW50VHJhbnNpdGlvbiApICksCgkJCWNsYXNzVG9SZW1vdmU6ICJpbiIsCgkJCXNjcmVlbkNsYXNzVG9BZGQ6ICJvdXQiLAoJCQljb250YWluZXJDbGFzc1RvQWRkOiAicmV2ZXJzZSBvdXQiLAoJCQlhcHBseVRyYW5zaXRpb246IHRydWUsCgkJCXByZXJlcXVpc2l0ZXM6IHRoaXMuX3ByZXJlcXVpc2l0ZXMKCQl9KTsKCX0sCgoJX3VuZW5oYW5jZTogZnVuY3Rpb24oKSB7CgkJaWYgKCB0aGlzLm9wdGlvbnMuZW5oYW5jZWQgKSB7CgkJCXJldHVybjsKCQl9CgoJCS8vIFB1dCB0aGUgZWxlbWVudCBiYWNrIHRvIHdoZXJlIHRoZSBwbGFjZWhvbGRlciB3YXMgYW5kIHJlbW92ZSB0aGUgInVpLXBvcHVwIiBjbGFzcwoJCXRoaXMuX3NldE9wdGlvbnMoIHsgdGhlbWU6ICQubW9iaWxlLnBvcHVwLnByb3RvdHlwZS5vcHRpb25zLnRoZW1lIH0gKTsKCQl0aGlzLmVsZW1lbnQKCQkJLy8gQ2Fubm90IGRpcmVjdGx5IGluc2VydEFmdGVyKCkgLSB3ZSBuZWVkIHRvIGRldGFjaCgpIGZpcnN0LCBiZWNhdXNlCgkJCS8vIGluc2VydEFmdGVyKCkgd2lsbCBkbyBub3RoaW5nIGlmIHRoZSBwYXlsb2FkIGRpdiB3YXMgbm90IGF0dGFjaGVkCgkJCS8vIHRvIHRoZSBET00gYXQgdGhlIHRpbWUgdGhlIHdpZGdldCB3YXMgY3JlYXRlZCwgYW5kIHNvIHRoZSBwYXlsb2FkCgkJCS8vIHdpbGwgcmVtYWluIGluc2lkZSB0aGUgY29udGFpbmVyIGV2ZW4gYWZ0ZXIgd2UgY2FsbCBpbnNlcnRBZnRlcigpLgoJCQkvLyBJZiB0aGF0IGhhcHBlbnMgYW5kIHdlIHJlbW92ZSB0aGUgY29udGFpbmVyIGEgZmV3IGxpbmVzIGJlbG93LCB3ZQoJCQkvLyB3aWxsIGNhdXNlIGFuIGluZmluaXRlIHJlY3Vyc2lvbiAtICM1MjQ0CgkJCS5kZXRhY2goKQoJCQkuaW5zZXJ0QWZ0ZXIoIHRoaXMuX3VpLnBsYWNlaG9sZGVyICkKCQkJLnJlbW92ZUNsYXNzKCAidWktcG9wdXAgdWktb3ZlcmxheS1zaGFkb3cgdWktY29ybmVyLWFsbCB1aS1ib2R5LWluaGVyaXQiICk7CgkJdGhpcy5fdWkuc2NyZWVuLnJlbW92ZSgpOwoJCXRoaXMuX3VpLmNvbnRhaW5lci5yZW1vdmUoKTsKCQl0aGlzLl91aS5wbGFjZWhvbGRlci5yZW1vdmUoKTsKCX0sCgoJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCWlmICggJC5tb2JpbGUucG9wdXAuYWN0aXZlID09PSB0aGlzICkgewoJCQl0aGlzLmVsZW1lbnQub25lKCAicG9wdXBhZnRlcmNsb3NlIiwgJC5wcm94eSggdGhpcywgIl91bmVuaGFuY2UiICkgKTsKCQkJdGhpcy5jbG9zZSgpOwoJCX0gZWxzZSB7CgkJCXRoaXMuX3VuZW5oYW5jZSgpOwoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9LAoKCV9jbG9zZVBvcHVwOiBmdW5jdGlvbiggdGhlRXZlbnQsIGRhdGEgKSB7CgkJdmFyIHBhcnNlZERzdCwgdG9VcmwsCgkJCWN1cnJlbnRPcHRpb25zID0gdGhpcy5vcHRpb25zLAoJCQlpbW1lZGlhdGUgPSBmYWxzZTsKCgkJaWYgKCAoIHRoZUV2ZW50ICYmIHRoZUV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICkgfHwgJC5tb2JpbGUucG9wdXAuYWN0aXZlICE9PSB0aGlzICkgewoJCQlyZXR1cm47CgkJfQoKCQkvLyByZXN0b3JlIGxvY2F0aW9uIG9uIHNjcmVlbgoJCXdpbmRvdy5zY3JvbGxUbyggMCwgdGhpcy5fc2Nyb2xsVG9wICk7CgoJCWlmICggdGhlRXZlbnQgJiYgdGhlRXZlbnQudHlwZSA9PT0gInBhZ2ViZWZvcmVjaGFuZ2UiICYmIGRhdGEgKSB7CgkJCS8vIERldGVybWluZSB3aGV0aGVyIHdlIG5lZWQgdG8gcmFwaWQtY2xvc2UgdGhlIHBvcHVwLCBvciB3aGV0aGVyIHdlIGNhbgoJCQkvLyB0YWtlIHRoZSB0aW1lIHRvIHJ1biB0aGUgY2xvc2luZyB0cmFuc2l0aW9uCgkJCWlmICggdHlwZW9mIGRhdGEudG9QYWdlID09PSAic3RyaW5nIiApIHsKCQkJCXBhcnNlZERzdCA9IGRhdGEudG9QYWdlOwoJCQl9IGVsc2UgewoJCQkJcGFyc2VkRHN0ID0gZGF0YS50b1BhZ2UuanFtRGF0YSggInVybCIgKTsKCQkJfQoJCQlwYXJzZWREc3QgPSAkLm1vYmlsZS5wYXRoLnBhcnNlVXJsKCBwYXJzZWREc3QgKTsKCQkJdG9VcmwgPSBwYXJzZWREc3QucGF0aG5hbWUgKyBwYXJzZWREc3Quc2VhcmNoICsgcGFyc2VkRHN0Lmhhc2g7CgoJCQlpZiAoIHRoaXMuX215VXJsICE9PSAkLm1vYmlsZS5wYXRoLm1ha2VVcmxBYnNvbHV0ZSggdG9VcmwgKSApIHsKCQkJCS8vIEdvaW5nIHRvIGEgZGlmZmVyZW50IHBhZ2UgLSBjbG9zZSBpbW1lZGlhdGVseQoJCQkJaW1tZWRpYXRlID0gdHJ1ZTsKCQkJfSBlbHNlIHsKCQkJCXRoZUV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCX0KCQl9CgoJCS8vIHJlbW92ZSBuYXYgYmluZGluZ3MKCQl0aGlzLndpbmRvdy5vZmYoIGN1cnJlbnRPcHRpb25zLmNsb3NlRXZlbnRzICk7CgkJLy8gdW5iaW5kIGNsaWNrIGhhbmRsZXJzIGFkZGVkIHdoZW4gaGlzdG9yeSBpcyBkaXNhYmxlZAoJCXRoaXMuZWxlbWVudC51bmRlbGVnYXRlKCBjdXJyZW50T3B0aW9ucy5jbG9zZUxpbmtTZWxlY3RvciwgY3VycmVudE9wdGlvbnMuY2xvc2VMaW5rRXZlbnRzICk7CgoJCXRoaXMuX2Nsb3NlKCBpbW1lZGlhdGUgKTsKCX0sCgoJLy8gYW55IG5hdmlnYXRpb24gZXZlbnQgYWZ0ZXIgYSBwb3B1cCBpcyBvcGVuZWQgc2hvdWxkIGNsb3NlIHRoZSBwb3B1cAoJLy8gTk9URSB0aGUgcGFnZWJlZm9yZWNoYW5nZSBpcyBib3VuZCB0byBjYXRjaCBuYXZpZ2F0aW9uIGV2ZW50cyB0aGF0IGRvbid0CgkvLyAgICAgIGFsdGVyIHRoZSB1cmwgKGVnLCBkaWFsb2dzIGZyb20gcG9wdXBzKQoJX2JpbmRDb250YWluZXJDbG9zZTogZnVuY3Rpb24oKSB7CgkJdGhpcy53aW5kb3cKCQkJLm9uKCB0aGlzLm9wdGlvbnMuY2xvc2VFdmVudHMsICQucHJveHkoIHRoaXMsICJfY2xvc2VQb3B1cCIgKSApOwoJfSwKCgl3aWRnZXQ6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLl91aS5jb250YWluZXI7Cgl9LAoKCS8vIFRPRE8gbm8gY2xlYXIgZGVsaW5pYXRpb24gb2Ygd2hhdCBzaG91bGQgYmUgaGVyZSBhbmQKCS8vIHdoYXQgc2hvdWxkIGJlIGluIF9vcGVuLiBTZWVtcyB0byBiZSAidmlzdWFsIiB2cyAiaGlzdG9yeSIgZm9yIG5vdwoJb3BlbjogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJdmFyIHVybCwgaGFzaGtleSwgYWN0aXZlUGFnZSwgY3VycmVudElzRGlhbG9nLCBoYXNIYXNoLCB1cmxIaXN0b3J5LAoJCQlzZWxmID0gdGhpcywKCQkJY3VycmVudE9wdGlvbnMgPSB0aGlzLm9wdGlvbnM7CgoJCS8vIG1ha2Ugc3VyZSBvcGVuIGlzIGlkZW1wb3RlbnQKCQlpZiAoICQubW9iaWxlLnBvcHVwLmFjdGl2ZSB8fCBjdXJyZW50T3B0aW9ucy5kaXNhYmxlZCApIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQkvLyBzZXQgdGhlIGdsb2JhbCBwb3B1cCBtdXRleAoJCSQubW9iaWxlLnBvcHVwLmFjdGl2ZSA9IHRoaXM7CgkJdGhpcy5fc2Nyb2xsVG9wID0gdGhpcy53aW5kb3cuc2Nyb2xsVG9wKCk7CgoJCS8vIGlmIGhpc3RvcnkgYWx0ZXJhdGlvbiBpcyBkaXNhYmxlZCBjbG9zZSBvbiBuYXZpZ2F0ZSBldmVudHMKCQkvLyBhbmQgbGVhdmUgdGhlIHVybCBhcyBpcwoJCWlmICggISggY3VycmVudE9wdGlvbnMuaGlzdG9yeSApICkgewoJCQlzZWxmLl9vcGVuKCBvcHRpb25zICk7CgkJCXNlbGYuX2JpbmRDb250YWluZXJDbG9zZSgpOwoKCQkJLy8gV2hlbiBoaXN0b3kgaXMgZGlzYWJsZWQgd2UgaGF2ZSB0byBncmFiIHRoZSBkYXRhLXJlbAoJCQkvLyBiYWNrIGxpbmsgY2xpY2tzIHNvIHdlIGNhbiBjbG9zZSB0aGUgcG9wdXAgaW5zdGVhZCBvZgoJCQkvLyByZWx5aW5nIG9uIGhpc3RvcnkgdG8gZG8gaXQgZm9yIHVzCgkJCXNlbGYuZWxlbWVudAoJCQkJLmRlbGVnYXRlKCBjdXJyZW50T3B0aW9ucy5jbG9zZUxpbmtTZWxlY3RvciwgY3VycmVudE9wdGlvbnMuY2xvc2VMaW5rRXZlbnRzLCBmdW5jdGlvbiggdGhlRXZlbnQgKSB7CgkJCQkJc2VsZi5jbG9zZSgpOwoJCQkJCXRoZUV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQl9KTsKCgkJCXJldHVybiB0aGlzOwoJCX0KCgkJLy8gY2FjaGUgc29tZSB2YWx1ZXMgZm9yIG1pbi9yZWFkYWJpbGl0eQoJCXVybEhpc3RvcnkgPSAkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5OwoJCWhhc2hrZXkgPSAkLm1vYmlsZS5kaWFsb2dIYXNoS2V5OwoJCWFjdGl2ZVBhZ2UgPSAkLm1vYmlsZS5hY3RpdmVQYWdlOwoJCWN1cnJlbnRJc0RpYWxvZyA9ICggYWN0aXZlUGFnZSA/IGFjdGl2ZVBhZ2UuaGFzQ2xhc3MoICJ1aS1kaWFsb2ciICkgOiBmYWxzZSApOwoJCXRoaXMuX215VXJsID0gdXJsID0gdXJsSGlzdG9yeS5nZXRBY3RpdmUoKS51cmw7CgkJaGFzSGFzaCA9ICggdXJsLmluZGV4T2YoIGhhc2hrZXkgKSA+IC0xICkgJiYgIWN1cnJlbnRJc0RpYWxvZyAmJiAoIHVybEhpc3RvcnkuYWN0aXZlSW5kZXggPiAwICk7CgoJCWlmICggaGFzSGFzaCApIHsKCQkJc2VsZi5fb3Blbiggb3B0aW9ucyApOwoJCQlzZWxmLl9iaW5kQ29udGFpbmVyQ2xvc2UoKTsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQkvLyBpZiB0aGUgY3VycmVudCB1cmwgaGFzIG5vIGRpYWxvZyBoYXNoIGtleSBwcm9jZWVkIGFzIG5vcm1hbAoJCS8vIG90aGVyd2lzZSwgaWYgdGhlIHBhZ2UgaXMgYSBkaWFsb2cgc2ltcGx5IHRhY2sgb24gdGhlIGhhc2gga2V5CgkJaWYgKCB1cmwuaW5kZXhPZiggaGFzaGtleSApID09PSAtMSAmJiAhY3VycmVudElzRGlhbG9nICl7CgkJCXVybCA9IHVybCArICh1cmwuaW5kZXhPZiggIiMiICkgPiAtMSA/IGhhc2hrZXkgOiAiIyIgKyBoYXNoa2V5KTsKCQl9IGVsc2UgewoJCQl1cmwgPSAkLm1vYmlsZS5wYXRoLnBhcnNlTG9jYXRpb24oKS5oYXNoICsgaGFzaGtleTsKCQl9CgoJCS8vIFRhY2sgb24gYW4gZXh0cmEgaGFzaGtleSBpZiB0aGlzIGlzIHRoZSBmaXJzdCBwYWdlIGFuZCB3ZSd2ZSBqdXN0IHJlY29uc3RydWN0ZWQgdGhlIGluaXRpYWwgaGFzaAoJCWlmICggdXJsSGlzdG9yeS5hY3RpdmVJbmRleCA9PT0gMCAmJiB1cmwgPT09IHVybEhpc3RvcnkuaW5pdGlhbERzdCApIHsKCQkJdXJsICs9IGhhc2hrZXk7CgkJfQoKCQkvLyBzd2FsbG93IHRoZSB0aGUgaW5pdGlhbCBuYXZpZ2F0aW9uIGV2ZW50LCBhbmQgYmluZCBmb3IgdGhlIG5leHQKCQl0aGlzLndpbmRvdy5vbmUoICJiZWZvcmVuYXZpZ2F0ZSIsIGZ1bmN0aW9uKCB0aGVFdmVudCApIHsKCQkJdGhlRXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJc2VsZi5fb3Blbiggb3B0aW9ucyApOwoJCQlzZWxmLl9iaW5kQ29udGFpbmVyQ2xvc2UoKTsKCQl9KTsKCgkJdGhpcy51cmxBbHRlcmVkID0gdHJ1ZTsKCQkkLm1vYmlsZS5uYXZpZ2F0ZSggdXJsLCB7IHJvbGU6ICJkaWFsb2ciIH0gKTsKCgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWNsb3NlOiBmdW5jdGlvbigpIHsKCQkvLyBtYWtlIHN1cmUgY2xvc2UgaXMgaWRlbXBvdGVudAoJCWlmICggJC5tb2JpbGUucG9wdXAuYWN0aXZlICE9PSB0aGlzICkgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCXRoaXMuX3Njcm9sbFRvcCA9IHRoaXMud2luZG93LnNjcm9sbFRvcCgpOwoKCQlpZiAoIHRoaXMub3B0aW9ucy5oaXN0b3J5ICYmIHRoaXMudXJsQWx0ZXJlZCApIHsKCQkJJC5tb2JpbGUuYmFjaygpOwoJCQl0aGlzLnVybEFsdGVyZWQgPSBmYWxzZTsKCQl9IGVsc2UgewoJCQkvLyBzaW11bGF0ZSB0aGUgbmF2IGJpbmRpbmdzIGhhdmluZyBmaXJlZAoJCQl0aGlzLl9jbG9zZVBvcHVwKCk7CgkJfQoKCQlyZXR1cm4gdGhpczsKCX0KfSk7CgoKLy8gVE9ETyB0aGlzIGNhbiBiZSBtb3ZlZCBpbnNpZGUgdGhlIHdpZGdldAokLm1vYmlsZS5wb3B1cC5oYW5kbGVMaW5rID0gZnVuY3Rpb24oICRsaW5rICkgewoJdmFyIG9mZnNldCwKCQlwYXRoID0gJC5tb2JpbGUucGF0aCwKCgkJLy8gTk9URSBtYWtlIHN1cmUgdG8gZ2V0IG9ubHkgdGhlIGhhc2ggZnJvbSB0aGUgaHJlZiBiZWNhdXNlIGllNyAod3A3KQoJCS8vICAgICAgcmV0dXJucyB0aGUgYWJzb2x1dGUgaHJlZiBpbiB0aGlzIGNhc2UgcnVpbmluZyB0aGUgZWxlbWVudCBzZWxlY3Rpb24KCQlwb3B1cCA9ICQoIHBhdGguaGFzaFRvU2VsZWN0b3IoIHBhdGgucGFyc2VVcmwoICRsaW5rLmF0dHIoICJocmVmIiApICkuaGFzaCApICkuZmlyc3QoKTsKCglpZiAoIHBvcHVwLmxlbmd0aCA+IDAgJiYgcG9wdXAuZGF0YSggIm1vYmlsZS1wb3B1cCIgKSApIHsKCQlvZmZzZXQgPSAkbGluay5vZmZzZXQoKTsKCQlwb3B1cC5wb3B1cCggIm9wZW4iLCB7CgkJCXg6IG9mZnNldC5sZWZ0ICsgJGxpbmsub3V0ZXJXaWR0aCgpIC8gMiwKCQkJeTogb2Zmc2V0LnRvcCArICRsaW5rLm91dGVySGVpZ2h0KCkgLyAyLAoJCQl0cmFuc2l0aW9uOiAkbGluay5qcW1EYXRhKCAidHJhbnNpdGlvbiIgKSwKCQkJcG9zaXRpb25UbzogJGxpbmsuanFtRGF0YSggInBvc2l0aW9uLXRvIiApCgkJfSk7Cgl9CgoJLy9yZW1vdmUgYWZ0ZXIgZGVsYXkKCXNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCSRsaW5rLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJfSwgMzAwICk7Cn07CgovLyBUT0RPIG1vdmUgaW5zaWRlIF9jcmVhdGUKJC5tb2JpbGUuZG9jdW1lbnQub24oICJwYWdlYmVmb3JlY2hhbmdlIiwgZnVuY3Rpb24oIHRoZUV2ZW50LCBkYXRhICkgewoJaWYgKCBkYXRhLm9wdGlvbnMucm9sZSA9PT0gInBvcHVwIiApIHsKCQkkLm1vYmlsZS5wb3B1cC5oYW5kbGVMaW5rKCBkYXRhLm9wdGlvbnMubGluayApOwoJCXRoZUV2ZW50LnByZXZlbnREZWZhdWx0KCk7Cgl9Cn0pOwoKfSkoIGpRdWVyeSApOwoKLyoKKiBjdXN0b20gInNlbGVjdG1lbnUiIHBsdWdpbgoqLwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7Cgp2YXIgdW5mb2N1c2FibGVJdGVtU2VsZWN0b3IgPSAiLnVpLWRpc2FibGVkLC51aS1zdGF0ZS1kaXNhYmxlZCwudWktbGktZGl2aWRlciwudWktc2NyZWVuLWhpZGRlbiw6anFtRGF0YShyb2xlPSdwbGFjZWhvbGRlcicpIiwKCWdvVG9BZGphY2VudEl0ZW0gPSBmdW5jdGlvbiggaXRlbSwgdGFyZ2V0LCBkaXJlY3Rpb24gKSB7CgkJdmFyIGFkamFjZW50ID0gaXRlbVsgZGlyZWN0aW9uICsgIkFsbCIgXSgpCgkJCS5ub3QoIHVuZm9jdXNhYmxlSXRlbVNlbGVjdG9yICkKCQkJLmZpcnN0KCk7CgoJCS8vIGlmIHRoZXJlJ3MgYSBwcmV2aW91cyBvcHRpb24sIGZvY3VzIGl0CgkJaWYgKCBhZGphY2VudC5sZW5ndGggKSB7CgkJCXRhcmdldAoJCQkJLmJsdXIoKQoJCQkJLmF0dHIoICJ0YWJpbmRleCIsICItMSIgKTsKCgkJCWFkamFjZW50LmZpbmQoICJhIiApLmZpcnN0KCkuZm9jdXMoKTsKCQl9Cgl9OwoKJC53aWRnZXQoICJtb2JpbGUuc2VsZWN0bWVudSIsICQubW9iaWxlLnNlbGVjdG1lbnUsIHsKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXZhciBvID0gdGhpcy5vcHRpb25zOwoKCQkvLyBDdXN0b20gc2VsZWN0cyBjYW5ub3QgZXhpc3QgaW5zaWRlIHBvcHVwcywgc28gcmV2ZXJ0IHRoZSAibmF0aXZlTWVudSIKCQkvLyBvcHRpb24gdG8gdHJ1ZSBpZiBhIHBhcmVudCBpcyBhIHBvcHVwCgkJby5uYXRpdmVNZW51ID0gby5uYXRpdmVNZW51IHx8ICggdGhpcy5lbGVtZW50LnBhcmVudHMoICI6anFtRGF0YShyb2xlPSdwb3B1cCcpLDptb2JpbGUtcG9wdXAiICkubGVuZ3RoID4gMCApOwoKCQlyZXR1cm4gdGhpcy5fc3VwZXIoKTsKCX0sCgoJX2hhbmRsZVNlbGVjdEZvY3VzOiBmdW5jdGlvbigpIHsKCQl0aGlzLmVsZW1lbnQuYmx1cigpOwoJCXRoaXMuYnV0dG9uLmZvY3VzKCk7Cgl9LAoKCV9oYW5kbGVLZXlkb3duOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJdGhpcy5fc3VwZXIoIGV2ZW50ICk7CgkJdGhpcy5faGFuZGxlQnV0dG9uVmNsaWNrS2V5ZG93biggZXZlbnQgKTsKCX0sCgoJX2hhbmRsZUJ1dHRvblZjbGlja0tleWRvd246IGZ1bmN0aW9uKCBldmVudCApIHsKCQlpZiAoIHRoaXMub3B0aW9ucy5kaXNhYmxlZCB8fCB0aGlzLmlzT3BlbiApIHsKCQkJcmV0dXJuOwoJCX0KCgkJaWYgKGV2ZW50LnR5cGUgPT09ICJ2Y2xpY2siIHx8CgkJCQlldmVudC5rZXlDb2RlICYmIChldmVudC5rZXlDb2RlID09PSAkLm1vYmlsZS5rZXlDb2RlLkVOVEVSIHx8IGV2ZW50LmtleUNvZGUgPT09ICQubW9iaWxlLmtleUNvZGUuU1BBQ0UpKSB7CgoJCQl0aGlzLl9kZWNpZGVGb3JtYXQoKTsKCQkJaWYgKCB0aGlzLm1lbnVUeXBlID09PSAib3ZlcmxheSIgKSB7CgkJCQl0aGlzLmJ1dHRvbi5hdHRyKCAiaHJlZiIsICIjIiArIHRoaXMucG9wdXBJZCApLmF0dHIoICJkYXRhLSIgKyAoICQubW9iaWxlLm5zIHx8ICIiICkgKyAicmVsIiwgInBvcHVwIiApOwoJCQl9IGVsc2UgewoJCQkJdGhpcy5idXR0b24uYXR0ciggImhyZWYiLCAiIyIgKyB0aGlzLmRpYWxvZ0lkICkuYXR0ciggImRhdGEtIiArICggJC5tb2JpbGUubnMgfHwgIiIgKSArICJyZWwiLCAiZGlhbG9nIiApOwoJCQl9CgkJCXRoaXMuaXNPcGVuID0gdHJ1ZTsKCQkJLy8gRG8gbm90IHByZXZlbnQgZGVmYXVsdCwgc28gdGhlIG5hdmlnYXRpb24gbWF5IGhhdmUgYSBjaGFuY2UgdG8gYWN0dWFsbHkgb3BlbiB0aGUgY2hvc2VuIGZvcm1hdAoJCX0KCX0sCgoJX2hhbmRsZUxpc3RGb2N1czogZnVuY3Rpb24oIGUgKSB7CgkJdmFyIHBhcmFtcyA9ICggZS50eXBlID09PSAiZm9jdXNpbiIgKSA/CgkJCXsgdGFiaW5kZXg6ICIwIiwgZXZlbnQ6ICJ2bW91c2VvdmVyIiB9OgoJCQl7IHRhYmluZGV4OiAiLTEiLCBldmVudDogInZtb3VzZW91dCIgfTsKCgkJJCggZS50YXJnZXQgKQoJCQkuYXR0ciggInRhYmluZGV4IiwgcGFyYW1zLnRhYmluZGV4ICkKCQkJLnRyaWdnZXIoIHBhcmFtcy5ldmVudCApOwoJfSwKCglfaGFuZGxlTGlzdEtleWRvd246IGZ1bmN0aW9uKCBldmVudCApIHsKCQl2YXIgdGFyZ2V0ID0gJCggZXZlbnQudGFyZ2V0ICksCgkJCWxpID0gdGFyZ2V0LmNsb3Nlc3QoICJsaSIgKTsKCgkJLy8gc3dpdGNoIGxvZ2ljIGJhc2VkIG9uIHdoaWNoIGtleSB3YXMgcHJlc3NlZAoJCXN3aXRjaCAoIGV2ZW50LmtleUNvZGUgKSB7CgkJCS8vIHVwIG9yIGxlZnQgYXJyb3cga2V5cwoJCWNhc2UgMzg6CgkJCWdvVG9BZGphY2VudEl0ZW0oIGxpLCB0YXJnZXQsICJwcmV2IiApOwoJCQlyZXR1cm4gZmFsc2U7CgkJCS8vIGRvd24gb3IgcmlnaHQgYXJyb3cga2V5cwoJCWNhc2UgNDA6CgkJCWdvVG9BZGphY2VudEl0ZW0oIGxpLCB0YXJnZXQsICJuZXh0IiApOwoJCQlyZXR1cm4gZmFsc2U7CgkJCS8vIElmIGVudGVyIG9yIHNwYWNlIGlzIHByZXNzZWQsIHRyaWdnZXIgY2xpY2sKCQljYXNlIDEzOgoJCWNhc2UgMzI6CgkJCXRhcmdldC50cmlnZ2VyKCAiY2xpY2siICk7CgkJCXJldHVybiBmYWxzZTsKCQl9Cgl9LAoKCV9oYW5kbGVNZW51UGFnZUhpZGU6IGZ1bmN0aW9uKCkgewoJCS8vIFRPRE8gY2VudHJhbGl6ZSBwYWdlIHJlbW92YWwgYmluZGluZyAvIGhhbmRsaW5nIGluIHRoZSBwYWdlIHBsdWdpbi4KCQkvLyBTdWdnZXN0aW9uIGZyb20gQGpibGFzIHRvIGRvIHJlZmNvdW50aW5nCgkJLy8KCQkvLyBUT0RPIGV4dHJlbWVseSBjb25mdXNpbmcgZGVwZW5kZW5jeSBvbiB0aGUgb3BlbiBtZXRob2Qgd2hlcmUgdGhlIHBhZ2VoaWRlLnJlbW92ZQoJCS8vIGJpbmRpbmdzIGFyZSBzdHJpcHBlZCB0byBwcmV2ZW50IHRoZSBwYXJlbnQgcGFnZSBmcm9tIGRpc2FwcGVhcmluZy4gVGhlIHdheQoJCS8vIHdlJ3JlIGtlZXBpbmcgcGFnZXMgaW4gdGhlIERPTSByaWdodCBub3cgc3Vja3MKCQkvLwoJCS8vIHJlYmluZCB0aGUgcGFnZSByZW1vdmUgdGhhdCB3YXMgdW5ib3VuZCBpbiB0aGUgb3BlbiBmdW5jdGlvbgoJCS8vIHRvIGFsbG93IGZvciB0aGUgcGFyZW50IHBhZ2UgcmVtb3ZhbCBmcm9tIGFjdGlvbnMgb3RoZXIgdGhhbiB0aGUgdXNlCgkJLy8gb2YgYSBkaWFsb2cgc2l6ZWQgY3VzdG9tIHNlbGVjdAoJCS8vCgkJLy8gZG9pbmcgdGhpcyBoZXJlIHByb3ZpZGVzIGZvciB0aGUgYmFjayBidXR0b24gb24gdGhlIGN1c3RvbSBzZWxlY3QgZGlhbG9nCgkJdGhpcy50aGlzUGFnZS5wYWdlKCAiYmluZFJlbW92ZSIgKTsKCX0sCgoJX2hhbmRsZUhlYWRlckNsb3NlQ2xpY2s6IGZ1bmN0aW9uKCkgewoJCWlmICggdGhpcy5tZW51VHlwZSA9PT0gIm92ZXJsYXkiICkgewoJCQl0aGlzLmNsb3NlKCk7CgkJCXJldHVybiBmYWxzZTsKCQl9Cgl9LAoKCWJ1aWxkOiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZWN0SWQsIHBvcHVwSWQsIGRpYWxvZ0lkLCBsYWJlbCwgdGhpc1BhZ2UsIGlzTXVsdGlwbGUsIG1lbnVJZCwgdGhlbWVBdHRyLCBvdmVybGF5VGhlbWVBdHRyLAoJCQlkaXZpZGVyVGhlbWVBdHRyLCBtZW51UGFnZSwgbGlzdGJveCwgbGlzdCwgaGVhZGVyLCBoZWFkZXJUaXRsZSwgbWVudVBhZ2VDb250ZW50LCBtZW51UGFnZUNsb3NlLCBoZWFkZXJDbG9zZSwgc2VsZiwKCQkJbyA9IHRoaXMub3B0aW9uczsKCgkJaWYgKCBvLm5hdGl2ZU1lbnUgKSB7CgkJCXJldHVybiB0aGlzLl9zdXBlcigpOwoJCX0KCgkJc2VsZiA9IHRoaXM7CgkJc2VsZWN0SWQgPSB0aGlzLnNlbGVjdElkOwoJCXBvcHVwSWQgPSBzZWxlY3RJZCArICItbGlzdGJveCI7CgkJZGlhbG9nSWQgPSBzZWxlY3RJZCArICItZGlhbG9nIjsKCQlsYWJlbCA9IHRoaXMubGFiZWw7CgkJdGhpc1BhZ2UgPSB0aGlzLmVsZW1lbnQuY2xvc2VzdCggIi51aS1wYWdlIiApOwoJCWlzTXVsdGlwbGUgPSB0aGlzLmVsZW1lbnRbIDAgXS5tdWx0aXBsZTsKCQltZW51SWQgPSBzZWxlY3RJZCArICItbWVudSI7CgkJdGhlbWVBdHRyID0gby50aGVtZSA/ICggIiBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJ0aGVtZT0nIiArIG8udGhlbWUgKyAiJyIgKSA6ICIiOwoJCW92ZXJsYXlUaGVtZUF0dHIgPSBvLm92ZXJsYXlUaGVtZSA/ICggIiBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJ0aGVtZT0nIiArIG8ub3ZlcmxheVRoZW1lICsgIiciICkgOiAiIjsKCQlkaXZpZGVyVGhlbWVBdHRyID0gKCBvLmRpdmlkZXJUaGVtZSAmJiBpc011bHRpcGxlICkgPyAoICIgZGF0YS0iICsgJC5tb2JpbGUubnMgKyAiZGl2aWRlci10aGVtZT0nIiArIG8uZGl2aWRlclRoZW1lICsgIiciICkgOiAiIjsKCQltZW51UGFnZSA9ICQoICI8ZGl2IGRhdGEtIiArICQubW9iaWxlLm5zICsgInJvbGU9J2RpYWxvZycgY2xhc3M9J3VpLXNlbGVjdG1lbnUnIGlkPSciICsgZGlhbG9nSWQgKyAiJyIgKyB0aGVtZUF0dHIgKyBvdmVybGF5VGhlbWVBdHRyICsgIj4iICsKCQkJIjxkaXYgZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicm9sZT0naGVhZGVyJz4iICsKCQkJIjxkaXYgY2xhc3M9J3VpLXRpdGxlJz4iICsgbGFiZWwuZ2V0RW5jb2RlZFRleHQoKSArICI8L2Rpdj4iKwoJCQkiPC9kaXY+IisKCQkJIjxkaXYgZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicm9sZT0nY29udGVudCc+PC9kaXY+IisKCQkJIjwvZGl2PiIgKTsKCQlsaXN0Ym94ID0gJCggIjxkaXYgaWQ9JyIgKyBwb3B1cElkICsgIicgY2xhc3M9J3VpLXNlbGVjdG1lbnUnPiIgKS5pbnNlcnRBZnRlciggdGhpcy5zZWxlY3QgKS5wb3B1cCh7IHRoZW1lOiBvLm92ZXJsYXlUaGVtZSB9KTsKCQlsaXN0ID0gJCggIjx1bCBjbGFzcz0ndWktc2VsZWN0bWVudS1saXN0JyBpZD0nIiArIG1lbnVJZCArICInIHJvbGU9J2xpc3Rib3gnIGFyaWEtbGFiZWxsZWRieT0nIiArIHRoaXMuYnV0dG9uSWQgKyAiJyIgKyB0aGVtZUF0dHIgKyBkaXZpZGVyVGhlbWVBdHRyICsgIj4iICkuYXBwZW5kVG8oIGxpc3Rib3ggKTsKCQloZWFkZXIgPSAkKCAiPGRpdiBjbGFzcz0ndWktaGVhZGVyIHVpLWJhci0iICsgKCBvLnRoZW1lID8gby50aGVtZSA6ICJpbmhlcml0IiApICsgIic+IiApLnByZXBlbmRUbyggbGlzdGJveCApOwoJCWhlYWRlclRpdGxlID0gJCggIjxoMSBjbGFzcz0ndWktdGl0bGUnPiIgKS5hcHBlbmRUbyggaGVhZGVyICk7CgoJCWlmICggdGhpcy5pc011bHRpcGxlICkgewoJCQloZWFkZXJDbG9zZSA9ICQoICI8YT4iLCB7CgkJCQkicm9sZSI6ICJidXR0b24iLAoJCQkJInRleHQiOiBvLmNsb3NlVGV4dCwKCQkJCSJocmVmIjogIiMiLAoJCQkJImNsYXNzIjogInVpLWJ0biB1aS1jb3JuZXItYWxsIHVpLWJ0bi1sZWZ0IHVpLWJ0bi1pY29uLW5vdGV4dCB1aS1pY29uLWRlbGV0ZSIKCQkJfSkuYXBwZW5kVG8oIGhlYWRlciApOwoJCX0KCgkJJC5leHRlbmQoIHRoaXMsIHsKCQkJc2VsZWN0SWQ6IHNlbGVjdElkLAoJCQltZW51SWQ6IG1lbnVJZCwKCQkJcG9wdXBJZDogcG9wdXBJZCwKCQkJZGlhbG9nSWQ6IGRpYWxvZ0lkLAoJCQl0aGlzUGFnZTogdGhpc1BhZ2UsCgkJCW1lbnVQYWdlOiBtZW51UGFnZSwKCQkJbGFiZWw6IGxhYmVsLAoJCQlpc011bHRpcGxlOiBpc011bHRpcGxlLAoJCQl0aGVtZTogby50aGVtZSwKCQkJbGlzdGJveDogbGlzdGJveCwKCQkJbGlzdDogbGlzdCwKCQkJaGVhZGVyOiBoZWFkZXIsCgkJCWhlYWRlclRpdGxlOiBoZWFkZXJUaXRsZSwKCQkJaGVhZGVyQ2xvc2U6IGhlYWRlckNsb3NlLAoJCQltZW51UGFnZUNvbnRlbnQ6IG1lbnVQYWdlQ29udGVudCwKCQkJbWVudVBhZ2VDbG9zZTogbWVudVBhZ2VDbG9zZSwKCQkJcGxhY2Vob2xkZXI6ICIiCgkJfSk7CgoJCS8vIENyZWF0ZSBsaXN0IGZyb20gc2VsZWN0LCB1cGRhdGUgc3RhdGUKCQl0aGlzLnJlZnJlc2goKTsKCgkJaWYgKCB0aGlzLl9vcmlnVGFiSW5kZXggPT09IHVuZGVmaW5lZCApIHsKCQkJLy8gTWFwIHVuZGVmaW5lZCB0byBmYWxzZSwgYmVjYXVzZSB0aGlzLl9vcmlnVGFiSW5kZXggPT09IHVuZGVmaW5lZAoJCQkvLyBpbmRpY2F0ZXMgdGhhdCB3ZSBoYXZlIG5vdCB5ZXQgY2hlY2tlZCB3aGV0aGVyIHRoZSBzZWxlY3QgaGFzCgkJCS8vIG9yaWdpbmFsbHkgaGFkIGEgdGFiaW5kZXggYXR0cmlidXRlLCB3aGVyZWFzIGZhbHNlIGluZGljYXRlcyB0aGF0CgkJCS8vIHdlIGhhdmUgY2hlY2tlZCB0aGUgc2VsZWN0IGZvciBzdWNoIGFuIGF0dHJpYnV0ZSwgYW5kIGhhdmUgZm91bmQKCQkJLy8gbm9uZSBwcmVzZW50LgoJCQl0aGlzLl9vcmlnVGFiSW5kZXggPSAoIHRoaXMuc2VsZWN0WyAwIF0uZ2V0QXR0cmlidXRlKCAidGFiaW5kZXgiICkgPT09IG51bGwgKSA/IGZhbHNlIDogdGhpcy5zZWxlY3QuYXR0ciggInRhYmluZGV4IiApOwoJCX0KCQl0aGlzLnNlbGVjdC5hdHRyKCAidGFiaW5kZXgiLCAiLTEiICk7CgkJdGhpcy5fb24oIHRoaXMuc2VsZWN0LCB7IGZvY3VzIDogIl9oYW5kbGVTZWxlY3RGb2N1cyIgfSApOwoKCQkvLyBCdXR0b24gZXZlbnRzCgkJdGhpcy5fb24oIHRoaXMuYnV0dG9uLCB7CgkJCXZjbGljazogIl9oYW5kbGVCdXR0b25WY2xpY2tLZXlkb3duIgoJCX0pOwoKCQkvLyBFdmVudHMgZm9yIGxpc3QgaXRlbXMKCQl0aGlzLmxpc3QuYXR0ciggInJvbGUiLCAibGlzdGJveCIgKTsKCQl0aGlzLl9vbiggdGhpcy5saXN0LCB7CgkJCWZvY3VzaW4gOiAiX2hhbmRsZUxpc3RGb2N1cyIsCgkJCWZvY3Vzb3V0IDogIl9oYW5kbGVMaXN0Rm9jdXMiLAoJCQlrZXlkb3duOiAiX2hhbmRsZUxpc3RLZXlkb3duIgoJCX0pOwoJCXRoaXMubGlzdAoJCQkuZGVsZWdhdGUoICJsaTpub3QoLnVpLWRpc2FibGVkLC51aS1zdGF0ZS1kaXNhYmxlZCwudWktbGktZGl2aWRlcikiLCAiY2xpY2siLCBmdW5jdGlvbiggZXZlbnQgKSB7CgoJCQkJLy8gaW5kZXggb2Ygb3B0aW9uIHRhZyB0byBiZSBzZWxlY3RlZAoJCQkJdmFyIG9sZEluZGV4ID0gc2VsZi5zZWxlY3RbIDAgXS5zZWxlY3RlZEluZGV4LAoJCQkJCW5ld0luZGV4ID0gJC5tb2JpbGUuZ2V0QXR0cmlidXRlKCB0aGlzLCAib3B0aW9uLWluZGV4IiApLAoJCQkJCW9wdGlvbiA9IHNlbGYuX3NlbGVjdE9wdGlvbnMoKS5lcSggbmV3SW5kZXggKVsgMCBdOwoKCQkJCS8vIHRvZ2dsZSBzZWxlY3RlZCBzdGF0dXMgb24gdGhlIHRhZyBmb3IgbXVsdGkgc2VsZWN0cwoJCQkJb3B0aW9uLnNlbGVjdGVkID0gc2VsZi5pc011bHRpcGxlID8gIW9wdGlvbi5zZWxlY3RlZCA6IHRydWU7CgoJCQkJLy8gdG9nZ2xlIGNoZWNrYm94IGNsYXNzIGZvciBtdWx0aXBsZSBzZWxlY3RzCgkJCQlpZiAoIHNlbGYuaXNNdWx0aXBsZSApIHsKCQkJCQkkKCB0aGlzICkuZmluZCggImEiICkKCQkJCQkJLnRvZ2dsZUNsYXNzKCAidWktaWNvbi1jaGVja2JveC1vbiIsIG9wdGlvbi5zZWxlY3RlZCApCgkJCQkJCS50b2dnbGVDbGFzcyggInVpLWljb24tY2hlY2tib3gtb2ZmIiwgIW9wdGlvbi5zZWxlY3RlZCApOwoJCQkJfQoKCQkJCS8vIHRyaWdnZXIgY2hhbmdlIGlmIHZhbHVlIGNoYW5nZWQKCQkJCWlmICggc2VsZi5pc011bHRpcGxlIHx8IG9sZEluZGV4ICE9PSBuZXdJbmRleCApIHsKCQkJCQlzZWxmLnNlbGVjdC50cmlnZ2VyKCAiY2hhbmdlIiApOwoJCQkJfQoKCQkJCS8vIGhpZGUgY3VzdG9tIHNlbGVjdCBmb3Igc2luZ2xlIHNlbGVjdHMgb25seSAtIG90aGVyd2lzZSBmb2N1cyBjbGlja2VkIGl0ZW0KCQkJCS8vIFdlIG5lZWQgdG8gZ3JhYiB0aGUgY2xpY2tlZCBpdGVtIHRoZSBoYXJkIHdheSwgYmVjYXVzZSB0aGUgbGlzdCBtYXkgaGF2ZSBiZWVuIHJlYnVpbHQKCQkJCWlmICggc2VsZi5pc011bHRpcGxlICkgewoJCQkJCXNlbGYubGlzdC5maW5kKCAibGk6bm90KC51aS1saS1kaXZpZGVyKSIgKS5lcSggbmV3SW5kZXggKQoJCQkJCQkuZmluZCggImEiICkuZmlyc3QoKS5mb2N1cygpOwoJCQkJfQoJCQkJZWxzZSB7CgkJCQkJc2VsZi5jbG9zZSgpOwoJCQkJfQoKCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCX0pOwoKCQkvLyBidXR0b24gcmVmb2N1cyBlbnN1cmVzIHByb3BlciBoZWlnaHQgY2FsY3VsYXRpb24KCQkvLyBieSByZW1vdmluZyB0aGUgaW5saW5lIHN0eWxlIGFuZCBlbnN1cmluZyBwYWdlIGluY2x1c2lvbgoJCXRoaXMuX29uKCB0aGlzLm1lbnVQYWdlLCB7IHBhZ2VoaWRlOiAiX2hhbmRsZU1lbnVQYWdlSGlkZSIgfSApOwoKCQkvLyBFdmVudHMgb24gdGhlIHBvcHVwCgkJdGhpcy5fb24oIHRoaXMubGlzdGJveCwgeyBwb3B1cGFmdGVyY2xvc2U6ICJjbG9zZSIgfSApOwoKCQkvLyBDbG9zZSBidXR0b24gb24gc21hbGwgb3ZlcmxheXMKCQlpZiAoIHRoaXMuaXNNdWx0aXBsZSApIHsKCQkJdGhpcy5fb24oIHRoaXMuaGVhZGVyQ2xvc2UsIHsgY2xpY2s6ICJfaGFuZGxlSGVhZGVyQ2xvc2VDbGljayIgfSApOwoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9LAoKCV9pc1JlYnVpbGRSZXF1aXJlZDogZnVuY3Rpb24oKSB7CgkJdmFyIGxpc3QgPSB0aGlzLmxpc3QuZmluZCggImxpIiApLAoJCQlvcHRpb25zID0gdGhpcy5fc2VsZWN0T3B0aW9ucygpLm5vdCggIi51aS1zY3JlZW4taGlkZGVuIiApOwoKCQkvLyBUT0RPIGV4Y2VlZGluZ2x5IG5haXZlIG1ldGhvZCB0byBkZXRlcm1pbmUgZGlmZmVyZW5jZQoJCS8vIGlnbm9yZXMgdmFsdWUgY2hhbmdlcyBldGMgaW4gZmF2b3Igb2YgYSBmb3JjZWRSZWJ1aWxkCgkJLy8gZnJvbSB0aGUgdXNlciBpbiB0aGUgcmVmcmVzaCBtZXRob2QKCQlyZXR1cm4gb3B0aW9ucy50ZXh0KCkgIT09IGxpc3QudGV4dCgpOwoJfSwKCglzZWxlY3RlZDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuX3NlbGVjdE9wdGlvbnMoKS5maWx0ZXIoICI6c2VsZWN0ZWQ6bm90KCA6anFtRGF0YShwbGFjZWhvbGRlcj0ndHJ1ZScpICkiICk7Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCBmb3JjZSApIHsKCQl2YXIgc2VsZiwgaW5kaWNlczsKCgkJaWYgKCB0aGlzLm9wdGlvbnMubmF0aXZlTWVudSApIHsKCQkJcmV0dXJuIHRoaXMuX3N1cGVyKCBmb3JjZSApOwoJCX0KCgkJc2VsZiA9IHRoaXM7CgkJaWYgKCBmb3JjZSB8fCB0aGlzLl9pc1JlYnVpbGRSZXF1aXJlZCgpICkgewoJCQlzZWxmLl9idWlsZExpc3QoKTsKCQl9CgoJCWluZGljZXMgPSB0aGlzLnNlbGVjdGVkSW5kaWNlcygpOwoKCQlzZWxmLnNldEJ1dHRvblRleHQoKTsKCQlzZWxmLnNldEJ1dHRvbkNvdW50KCk7CgoJCXNlbGYubGlzdC5maW5kKCAibGk6bm90KC51aS1saS1kaXZpZGVyKSIgKQoJCQkuZmluZCggImEiICkucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICkuZW5kKCkKCQkJLmF0dHIoICJhcmlhLXNlbGVjdGVkIiwgZmFsc2UgKQoJCQkuZWFjaChmdW5jdGlvbiggaSApIHsKCgkJCQlpZiAoICQuaW5BcnJheSggaSwgaW5kaWNlcyApID4gLTEgKSB7CgkJCQkJdmFyIGl0ZW0gPSAkKCB0aGlzICk7CgoJCQkJCS8vIEFyaWEgc2VsZWN0ZWQgYXR0cgoJCQkJCWl0ZW0uYXR0ciggImFyaWEtc2VsZWN0ZWQiLCB0cnVlICk7CgoJCQkJCS8vIE11bHRpcGxlIHNlbGVjdHM6IGFkZCB0aGUgIm9uIiBjaGVja2JveCBzdGF0ZSB0byB0aGUgaWNvbgoJCQkJCWlmICggc2VsZi5pc011bHRpcGxlICkgewoJCQkJCQlpdGVtLmZpbmQoICJhIiApLnJlbW92ZUNsYXNzKCAidWktaWNvbi1jaGVja2JveC1vZmYiICkuYWRkQ2xhc3MoICJ1aS1pY29uLWNoZWNrYm94LW9uIiApOwoJCQkJCX0gZWxzZSB7CgkJCQkJCWlmICggaXRlbS5oYXNDbGFzcyggInVpLXNjcmVlbi1oaWRkZW4iICkgKSB7CgkJCQkJCQlpdGVtLm5leHQoKS5maW5kKCAiYSIgKS5hZGRDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJCQkJfSBlbHNlIHsKCQkJCQkJCWl0ZW0uZmluZCggImEiICkuYWRkQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCQkJCX0KCQkJCQl9CgkJCQl9CgkJCX0pOwoJfSwKCgljbG9zZTogZnVuY3Rpb24oKSB7CgkJaWYgKCB0aGlzLm9wdGlvbnMuZGlzYWJsZWQgfHwgIXRoaXMuaXNPcGVuICkgewoJCQlyZXR1cm47CgkJfQoKCQl2YXIgc2VsZiA9IHRoaXM7CgoJCWlmICggc2VsZi5tZW51VHlwZSA9PT0gInBhZ2UiICkgewoJCQlzZWxmLm1lbnVQYWdlLmRpYWxvZyggImNsb3NlIiApOwoJCQlzZWxmLmxpc3QuYXBwZW5kVG8oIHNlbGYubGlzdGJveCApOwoJCX0gZWxzZSB7CgkJCXNlbGYubGlzdGJveC5wb3B1cCggImNsb3NlIiApOwoJCX0KCgkJc2VsZi5fZm9jdXNCdXR0b24oKTsKCQkvLyBhbGxvdyB0aGUgZGlhbG9nIHRvIGJlIGNsb3NlZCBhZ2FpbgoJCXNlbGYuaXNPcGVuID0gZmFsc2U7Cgl9LAoKCW9wZW46IGZ1bmN0aW9uKCkgewoJCXRoaXMuYnV0dG9uLmNsaWNrKCk7Cgl9LAoKCV9mb2N1c01lbnVJdGVtOiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZWN0b3IgPSB0aGlzLmxpc3QuZmluZCggImEuIiArICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJaWYgKCBzZWxlY3Rvci5sZW5ndGggPT09IDAgKSB7CgkJCXNlbGVjdG9yID0gdGhpcy5saXN0LmZpbmQoICJsaTpub3QoIiArIHVuZm9jdXNhYmxlSXRlbVNlbGVjdG9yICsgIikgYS51aS1idG4iICk7CgkJfQoJCXNlbGVjdG9yLmZpcnN0KCkuZm9jdXMoKTsKCX0sCgoJX2RlY2lkZUZvcm1hdDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzLAoJCQkkd2luZG93ID0gdGhpcy53aW5kb3csCgkJCXNlbGZMaXN0UGFyZW50ID0gc2VsZi5saXN0LnBhcmVudCgpLAoJCQltZW51SGVpZ2h0ID0gc2VsZkxpc3RQYXJlbnQub3V0ZXJIZWlnaHQoKSwKCQkJc2Nyb2xsVG9wID0gJHdpbmRvdy5zY3JvbGxUb3AoKSwKCQkJYnRuT2Zmc2V0ID0gc2VsZi5idXR0b24ub2Zmc2V0KCkudG9wLAoJCQlzY3JlZW5IZWlnaHQgPSAkd2luZG93LmhlaWdodCgpOwoKCQlpZiAoIG1lbnVIZWlnaHQgPiBzY3JlZW5IZWlnaHQgLSA4MCB8fCAhJC5zdXBwb3J0LnNjcm9sbFRvcCApIHsKCgkJCXNlbGYubWVudVBhZ2UuYXBwZW5kVG8oICQubW9iaWxlLnBhZ2VDb250YWluZXIgKS5wYWdlKCk7CgkJCXNlbGYubWVudVBhZ2VDb250ZW50ID0gc2VsZi5tZW51UGFnZS5maW5kKCAiLnVpLWNvbnRlbnQiICk7CgkJCXNlbGYubWVudVBhZ2VDbG9zZSA9IHNlbGYubWVudVBhZ2UuZmluZCggIi51aS1oZWFkZXIgYSIgKTsKCgkJCS8vIHByZXZlbnQgdGhlIHBhcmVudCBwYWdlIGZyb20gYmVpbmcgcmVtb3ZlZCBmcm9tIHRoZSBET00sCgkJCS8vIG90aGVyd2lzZSB0aGUgcmVzdWx0cyBvZiBzZWxlY3RpbmcgYSBsaXN0IGl0ZW0gaW4gdGhlIGRpYWxvZwoJCQkvLyBmYWxsIGludG8gYSBibGFjayBob2xlCgkJCXNlbGYudGhpc1BhZ2UudW5iaW5kKCAicGFnZWhpZGUucmVtb3ZlIiApOwoKCQkJLy9mb3IgV2ViT1MvT3BlcmEgTWluaSAoc2V0IGxhc3RzY3JvbGwgdXNpbmcgYnV0dG9uIG9mZnNldCkKCQkJaWYgKCBzY3JvbGxUb3AgPT09IDAgJiYgYnRuT2Zmc2V0ID4gc2NyZWVuSGVpZ2h0ICkgewoJCQkJc2VsZi50aGlzUGFnZS5vbmUoICJwYWdlaGlkZSIsIGZ1bmN0aW9uKCkgewoJCQkJCSQoIHRoaXMgKS5qcW1EYXRhKCAibGFzdFNjcm9sbCIsIGJ0bk9mZnNldCApOwoJCQkJfSk7CgkJCX0KCgkJCXNlbGYubWVudVBhZ2Uub25lKCB7CgkJCQlwYWdlc2hvdzogJC5wcm94eSggdGhpcywgIl9mb2N1c01lbnVJdGVtIiApLAoJCQkJcGFnZWhpZGU6ICQucHJveHkoIHRoaXMsICJjbG9zZSIgKQoJCQl9KTsKCgkJCXNlbGYubWVudVR5cGUgPSAicGFnZSI7CgkJCXNlbGYubWVudVBhZ2VDb250ZW50LmFwcGVuZCggc2VsZi5saXN0ICk7CgkJCXNlbGYubWVudVBhZ2UuZmluZCggImRpdiAudWktdGl0bGUiICkudGV4dCggc2VsZi5sYWJlbC50ZXh0KCkgKTsKCQl9IGVsc2UgewoJCQlzZWxmLm1lbnVUeXBlID0gIm92ZXJsYXkiOwoKCQkJc2VsZi5saXN0Ym94Lm9uZSggeyBwb3B1cGFmdGVyb3BlbjogJC5wcm94eSggdGhpcywgIl9mb2N1c01lbnVJdGVtIiApIH0gKTsKCQl9Cgl9LAoKCV9idWlsZExpc3Q6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpcywKCQkJbyA9IHRoaXMub3B0aW9ucywKCQkJcGxhY2Vob2xkZXIgPSB0aGlzLnBsYWNlaG9sZGVyLAoJCQluZWVkUGxhY2Vob2xkZXIgPSB0cnVlLAoJCQlkYXRhSWNvbiA9IHRoaXMuaXNNdWx0aXBsZSA/ICJjaGVja2JveC1vZmYiIDogImZhbHNlIiwKCQkJJG9wdGlvbnMsIG51bU9wdGlvbnMsIHNlbGVjdCwKCQkJZGF0YVByZWZpeCA9ICJkYXRhLSIgKyAkLm1vYmlsZS5ucywKCQkJZGF0YUluZGV4QXR0ciA9IGRhdGFQcmVmaXggKyAib3B0aW9uLWluZGV4IiwKCQkJZGF0YUljb25BdHRyID0gZGF0YVByZWZpeCArICJpY29uIiwKCQkJZGF0YVJvbGVBdHRyID0gZGF0YVByZWZpeCArICJyb2xlIiwKCQkJZGF0YVBsYWNlaG9sZGVyQXR0ciA9IGRhdGFQcmVmaXggKyAicGxhY2Vob2xkZXIiLAoJCQlmcmFnbWVudCA9IGRvY3VtZW50LmNyZWF0ZURvY3VtZW50RnJhZ21lbnQoKSwKCQkJaXNQbGFjZWhvbGRlckl0ZW0gPSBmYWxzZSwKCQkJb3B0R3JvdXAsCgkJCWksCgkJCW9wdGlvbiwgJG9wdGlvbiwgcGFyZW50LCB0ZXh0LCBhbmNob3IsIGNsYXNzZXMsCgkJCW9wdExhYmVsLCBkaXZpZGVyLCBpdGVtOwoKCQlzZWxmLmxpc3QuZW1wdHkoKS5maWx0ZXIoICIudWktbGlzdHZpZXciICkubGlzdHZpZXcoICJkZXN0cm95IiApOwoJCSRvcHRpb25zID0gdGhpcy5fc2VsZWN0T3B0aW9ucygpOwoJCW51bU9wdGlvbnMgPSAkb3B0aW9ucy5sZW5ndGg7CgkJc2VsZWN0ID0gdGhpcy5zZWxlY3RbIDAgXTsKCgkJZm9yICggaSA9IDA7IGkgPCBudW1PcHRpb25zO2krKywgaXNQbGFjZWhvbGRlckl0ZW0gPSBmYWxzZSkgewoJCQlvcHRpb24gPSAkb3B0aW9uc1tpXTsKCQkJJG9wdGlvbiA9ICQoIG9wdGlvbiApOwoKCQkJLy8gRG8gbm90IGNyZWF0ZSBvcHRpb25zIGJhc2VkIG9uIHVpLXNjcmVlbi1oaWRkZW4gc2VsZWN0IG9wdGlvbnMKCQkJaWYgKCAkb3B0aW9uLmhhc0NsYXNzKCAidWktc2NyZWVuLWhpZGRlbiIgKSApIHsKCQkJCWNvbnRpbnVlOwoJCQl9CgoJCQlwYXJlbnQgPSBvcHRpb24ucGFyZW50Tm9kZTsKCQkJdGV4dCA9ICRvcHRpb24udGV4dCgpOwoJCQlhbmNob3IgID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImEiICk7CgkJCWNsYXNzZXMgPSBbXTsKCgkJCWFuY2hvci5zZXRBdHRyaWJ1dGUoICJocmVmIiwgIiMiICk7CgkJCWFuY2hvci5hcHBlbmRDaGlsZCggZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoIHRleHQgKSApOwoKCQkJLy8gQXJlIHdlIGluc2lkZSBhbiBvcHRncm91cD8KCQkJaWYgKCBwYXJlbnQgIT09IHNlbGVjdCAmJiBwYXJlbnQubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gIm9wdGdyb3VwIiApIHsKCQkJCW9wdExhYmVsID0gcGFyZW50LmdldEF0dHJpYnV0ZSggImxhYmVsIiApOwoJCQkJaWYgKCBvcHRMYWJlbCAhPT0gb3B0R3JvdXAgKSB7CgkJCQkJZGl2aWRlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJsaSIgKTsKCQkJCQlkaXZpZGVyLnNldEF0dHJpYnV0ZSggZGF0YVJvbGVBdHRyLCAibGlzdC1kaXZpZGVyIiApOwoJCQkJCWRpdmlkZXIuc2V0QXR0cmlidXRlKCAicm9sZSIsICJvcHRpb24iICk7CgkJCQkJZGl2aWRlci5zZXRBdHRyaWJ1dGUoICJ0YWJpbmRleCIsICItMSIgKTsKCQkJCQlkaXZpZGVyLmFwcGVuZENoaWxkKCBkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSggb3B0TGFiZWwgKSApOwoJCQkJCWZyYWdtZW50LmFwcGVuZENoaWxkKCBkaXZpZGVyICk7CgkJCQkJb3B0R3JvdXAgPSBvcHRMYWJlbDsKCQkJCX0KCQkJfQoKCQkJaWYgKCBuZWVkUGxhY2Vob2xkZXIgJiYgKCAhb3B0aW9uLmdldEF0dHJpYnV0ZSggInZhbHVlIiApIHx8IHRleHQubGVuZ3RoID09PSAwIHx8ICRvcHRpb24uanFtRGF0YSggInBsYWNlaG9sZGVyIiApICkgKSB7CgkJCQluZWVkUGxhY2Vob2xkZXIgPSBmYWxzZTsKCQkJCWlzUGxhY2Vob2xkZXJJdGVtID0gdHJ1ZTsKCgkJCQkvLyBJZiB3ZSBoYXZlIGlkZW50aWZpZWQgYSBwbGFjZWhvbGRlciwgcmVjb3JkIHRoZSBmYWN0IHRoYXQgaXQgd2FzCgkJCQkvLyB1cyB3aG8gaGF2ZSBhZGRlZCB0aGUgcGxhY2Vob2xkZXIgdG8gdGhlIG9wdGlvbiBhbmQgbWFyayBpdAoJCQkJLy8gcmV0cm9hY3RpdmVseSBpbiB0aGUgc2VsZWN0IGFzIHdlbGwKCQkJCWlmICggbnVsbCA9PT0gb3B0aW9uLmdldEF0dHJpYnV0ZSggZGF0YVBsYWNlaG9sZGVyQXR0ciApICkgewoJCQkJCXRoaXMuX3JlbW92ZVBsYWNlaG9sZGVyQXR0ciA9IHRydWU7CgkJCQl9CgkJCQlvcHRpb24uc2V0QXR0cmlidXRlKCBkYXRhUGxhY2Vob2xkZXJBdHRyLCB0cnVlICk7CgkJCQlpZiAoIG8uaGlkZVBsYWNlaG9sZGVyTWVudUl0ZW1zICkgewoJCQkJCWNsYXNzZXMucHVzaCggInVpLXNjcmVlbi1oaWRkZW4iICk7CgkJCQl9CgkJCQlpZiAoIHBsYWNlaG9sZGVyICE9PSB0ZXh0ICkgewoJCQkJCXBsYWNlaG9sZGVyID0gc2VsZi5wbGFjZWhvbGRlciA9IHRleHQ7CgkJCQl9CgkJCX0KCgkJCWl0ZW0gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAibGkiICk7CgkJCWlmICggb3B0aW9uLmRpc2FibGVkICkgewoJCQkJY2xhc3Nlcy5wdXNoKCAidWktZGlzYWJsZWQiICk7CgkJCQlpdGVtLnNldEF0dHJpYnV0ZSggImFyaWEtZGlzYWJsZWQiLCB0cnVlICk7CgkJCX0KCQkJaXRlbS5zZXRBdHRyaWJ1dGUoIGRhdGFJbmRleEF0dHIsIGkgKTsKCQkJaXRlbS5zZXRBdHRyaWJ1dGUoIGRhdGFJY29uQXR0ciwgZGF0YUljb24gKTsKCQkJaWYgKCBpc1BsYWNlaG9sZGVySXRlbSApIHsKCQkJCWl0ZW0uc2V0QXR0cmlidXRlKCBkYXRhUGxhY2Vob2xkZXJBdHRyLCB0cnVlICk7CgkJCX0KCQkJaXRlbS5jbGFzc05hbWUgPSBjbGFzc2VzLmpvaW4oICIgIiApOwoJCQlpdGVtLnNldEF0dHJpYnV0ZSggInJvbGUiLCAib3B0aW9uIiApOwoJCQlhbmNob3Iuc2V0QXR0cmlidXRlKCAidGFiaW5kZXgiLCAiLTEiICk7CgkJCWl0ZW0uYXBwZW5kQ2hpbGQoIGFuY2hvciApOwoJCQlmcmFnbWVudC5hcHBlbmRDaGlsZCggaXRlbSApOwoJCX0KCgkJc2VsZi5saXN0WzBdLmFwcGVuZENoaWxkKCBmcmFnbWVudCApOwoKCQkvLyBIaWRlIGhlYWRlciBpZiBpdCdzIG5vdCBhIG11bHRpc2VsZWN0IGFuZCB0aGVyZSdzIG5vIHBsYWNlaG9sZGVyCgkJaWYgKCAhdGhpcy5pc011bHRpcGxlICYmICFwbGFjZWhvbGRlci5sZW5ndGggKSB7CgkJCXRoaXMuaGVhZGVyLmFkZENsYXNzKCAidWktc2NyZWVuLWhpZGRlbiIgKTsKCQl9IGVsc2UgewoJCQl0aGlzLmhlYWRlclRpdGxlLnRleHQoIHRoaXMucGxhY2Vob2xkZXIgKTsKCQl9CgoJCS8vIE5vdyBwb3B1bGF0ZWQsIGNyZWF0ZSBsaXN0dmlldwoJCXNlbGYubGlzdC5saXN0dmlldygpOwoJfSwKCglfYnV0dG9uOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5vcHRpb25zLm5hdGl2ZU1lbnUgPwoJCQl0aGlzLl9zdXBlcigpIDoKCQkJJCggIjxhPiIsIHsKCQkJCSJocmVmIjogIiMiLAoJCQkJInJvbGUiOiAiYnV0dG9uIiwKCQkJCS8vIFRPRE8gdmFsdWUgaXMgdW5kZWZpbmVkIGF0IGNyZWF0aW9uCgkJCQkiaWQiOiB0aGlzLmJ1dHRvbklkLAoJCQkJImFyaWEtaGFzcG9wdXAiOiAidHJ1ZSIsCgoJCQkJLy8gVE9ETyB2YWx1ZSBpcyB1bmRlZmluZWQgYXQgY3JlYXRpb24KCQkJCSJhcmlhLW93bnMiOiB0aGlzLm1lbnVJZAoJCQl9KTsKCX0sCgoJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoKCQlpZiAoICF0aGlzLm9wdGlvbnMubmF0aXZlTWVudSApIHsKCQkJdGhpcy5jbG9zZSgpOwoKCQkJLy8gUmVzdG9yZSB0aGUgdGFiaW5kZXggYXR0cmlidXRlIHRvIGl0cyBvcmlnaW5hbCB2YWx1ZQoJCQlpZiAoIHRoaXMuX29yaWdUYWJJbmRleCAhPT0gdW5kZWZpbmVkICkgewoJCQkJaWYgKCB0aGlzLl9vcmlnVGFiSW5kZXggIT09IGZhbHNlICkgewoJCQkJCXRoaXMuc2VsZWN0LmF0dHIoICJ0YWJpbmRleCIsIHRoaXMuX29yaWdUYWJJbmRleCApOwoJCQkJfSBlbHNlIHsKCQkJCQl0aGlzLnNlbGVjdC5yZW1vdmVBdHRyKCAidGFiaW5kZXgiICk7CgkJCQl9CgkJCX0KCgkJCS8vIFJlbW92ZSB0aGUgcGxhY2Vob2xkZXIgYXR0cmlidXRlIGlmIHdlIHdlcmUgdGhlIG9uZXMgdG8gYWRkIGl0CgkJCWlmICggdGhpcy5fcmVtb3ZlUGxhY2Vob2xkZXJBdHRyICkgewoJCQkJdGhpcy5fc2VsZWN0T3B0aW9ucygpLnJlbW92ZUF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJwbGFjZWhvbGRlciIgKTsKCQkJfQoKCQkJLy8gUmVtb3ZlIHRoZSBwb3B1cAoJCQl0aGlzLmxpc3Rib3gucmVtb3ZlKCk7CgoJCQkvLyBSZW1vdmUgdGhlIGRpYWxvZwoJCQl0aGlzLm1lbnVQYWdlLnJlbW92ZSgpOwoJCX0KCgkJLy8gQ2hhaW4gdXAKCQl0aGlzLl9zdXBlcigpOwoJfQp9KTsKCn0pKCBqUXVlcnkgKTsKCgovLyBidXR0b25NYXJrdXAgaXMgZGVwcmVjYXRlZCBhcyBvZiAxLjQuMCBhbmQgd2lsbCBiZSByZW1vdmVkIGluIDEuNS4wLgoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgoKLy8gR2VuZXJhbCBwb2xpY3k6IERvIG5vdCBhY2Nlc3MgZGF0YS0qIGF0dHJpYnV0ZXMgZXhjZXB0IGR1cmluZyBlbmhhbmNlbWVudC4KLy8gSW4gYWxsIG90aGVyIGNhc2VzIHdlIGRldGVybWluZSB0aGUgc3RhdGUgb2YgdGhlIGJ1dHRvbiBleGNsdXNpdmVseSBmcm9tIGl0cwovLyBjbGFzc05hbWUuIFRoYXQncyB3aHkgb3B0aW9uc1RvQ2xhc3NlcyBleHBlY3RzIGEgZnVsbCBjb21wbGVtZW50IG9mIG9wdGlvbnMsCi8vIGFuZCB0aGUgalF1ZXJ5IHBsdWdpbiBjb21wbGV0ZXMgdGhlIHNldCBvZiBvcHRpb25zIGZyb20gdGhlIGRlZmF1bHQgdmFsdWVzLgoKLy8gTWFwIGNsYXNzZXMgdG8gYnV0dG9uTWFya3VwIGJvb2xlYW4gb3B0aW9ucyAtIHVzZWQgaW4gY2xhc3NOYW1lVG9PcHRpb25zKCkKdmFyIHJldmVyc2VCb29sT3B0aW9uTWFwID0gewoJCSJ1aS1zaGFkb3ciIDogInNoYWRvdyIsCgkJInVpLWNvcm5lci1hbGwiIDogImNvcm5lcnMiLAoJCSJ1aS1idG4taW5saW5lIiA6ICJpbmxpbmUiLAoJCSJ1aS1zaGFkb3ctaWNvbiIgOiAiaWNvbnNoYWRvdyIsIC8qIFRPRE86IFJlbW92ZSBpbiAxLjUgKi8KCQkidWktbWluaSIgOiAibWluaSIKCX0sCglnZXRBdHRyRml4ZWQgPSBmdW5jdGlvbigpIHsKCQl2YXIgcmV0ID0gJC5tb2JpbGUuZ2V0QXR0cmlidXRlLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsKCgkJcmV0dXJuICggcmV0ID09IG51bGwgPyB1bmRlZmluZWQgOiByZXQgKTsKCX0sCgljYXBpdGFsTGV0dGVyc1JFID0gL1tBLVpdL2c7CgovLyBvcHRpb25zVG9DbGFzc2VzOgovLyBAb3B0aW9uczogQSBjb21wbGV0ZSBzZXQgb2Ygb3B0aW9ucyB0byBjb252ZXJ0IHRvIGNsYXNzIG5hbWVzLgovLyBAZXhpc3RpbmdDbGFzc2VzOiBleHRyYSBjbGFzc2VzIHRvIGFkZCB0byB0aGUgcmVzdWx0Ci8vCi8vIENvbnZlcnRzIEBvcHRpb25zIHRvIGJ1dHRvbk1hcmt1cCBjbGFzc2VzIGFuZCByZXR1cm5zIHRoZSByZXN1bHQgYXMgYW4gYXJyYXkKLy8gdGhhdCBjYW4gYmUgY29udmVydGVkIHRvIGFuIGVsZW1lbnQncyBjbGFzc05hbWUgd2l0aCAuam9pbiggIiAiICkuIEFsbAovLyBwb3NzaWJsZSBvcHRpb25zIG11c3QgYmUgc2V0IGluc2lkZSBAb3B0aW9ucy4gVXNlICQuZm4uYnV0dG9uTWFya3VwLmRlZmF1bHRzCi8vIHRvIGdldCBhIGNvbXBsZXRlIHNldCBhbmQgdXNlICQuZXh0ZW5kIHRvIG92ZXJyaWRlIHlvdXIgY2hvaWNlIG9mIG9wdGlvbnMKLy8gZnJvbSB0aGF0IHNldC4KZnVuY3Rpb24gb3B0aW9uc1RvQ2xhc3Nlcyggb3B0aW9ucywgZXhpc3RpbmdDbGFzc2VzICkgewoJdmFyIGNsYXNzZXMgPSBleGlzdGluZ0NsYXNzZXMgPyBleGlzdGluZ0NsYXNzZXMgOiBbXTsKCgkvLyBBZGQgY2xhc3NlcyB0byB0aGUgYXJyYXkgLSBmaXJzdCB1aS1idG4KCWNsYXNzZXMucHVzaCggInVpLWJ0biIgKTsKCgkvLyBJZiB0aGVyZSBpcyBhIHRoZW1lCglpZiAoIG9wdGlvbnMudGhlbWUgKSB7CgkJY2xhc3Nlcy5wdXNoKCAidWktYnRuLSIgKyBvcHRpb25zLnRoZW1lICk7Cgl9CgoJLy8gSWYgdGhlcmUncyBhbiBpY29uLCBhZGQgdGhlIGljb24tcmVsYXRlZCBjbGFzc2VzCglpZiAoIG9wdGlvbnMuaWNvbiApIHsKCQljbGFzc2VzID0gY2xhc3Nlcy5jb25jYXQoWwoJCQkidWktaWNvbi0iICsgb3B0aW9ucy5pY29uLAoJCQkidWktYnRuLWljb24tIiArIG9wdGlvbnMuaWNvbnBvcwoJCV0pOwoJCWlmICggb3B0aW9ucy5pY29uc2hhZG93ICkgewoJCQljbGFzc2VzLnB1c2goICJ1aS1zaGFkb3ctaWNvbiIgKTsgLyogVE9ETzogUmVtb3ZlIGluIDEuNSAqLwoJCX0KCX0KCgkvLyBBZGQgdGhlIGFwcHJvcHJpYXRlIGNsYXNzIGZvciBlYWNoIGJvb2xlYW4gb3B0aW9uCglpZiAoIG9wdGlvbnMuaW5saW5lICkgewoJCWNsYXNzZXMucHVzaCggInVpLWJ0bi1pbmxpbmUiICk7Cgl9CglpZiAoIG9wdGlvbnMuc2hhZG93ICkgewoJCWNsYXNzZXMucHVzaCggInVpLXNoYWRvdyIgKTsKCX0KCWlmICggb3B0aW9ucy5jb3JuZXJzICkgewoJCWNsYXNzZXMucHVzaCggInVpLWNvcm5lci1hbGwiICk7Cgl9CglpZiAoIG9wdGlvbnMubWluaSApIHsKCQljbGFzc2VzLnB1c2goICJ1aS1taW5pIiApOwoJfQoKCS8vIENyZWF0ZSBhIHN0cmluZyBmcm9tIHRoZSBhcnJheSBhbmQgcmV0dXJuIGl0CglyZXR1cm4gY2xhc3NlczsKfQoKLy8gY2xhc3NOYW1lVG9PcHRpb25zOgovLyBAY2xhc3NlczogQSBzdHJpbmcgY29udGFpbmluZyBhIC5jbGFzc05hbWUtc3R5bGUgc3BhY2Utc2VwYXJhdGVkIGNsYXNzIGxpc3QKLy8KLy8gTG9vcHMgb3ZlciBAY2xhc3NlcyBhbmQgY2FsY3VsYXRlcyBhbiBvcHRpb25zIG9iamVjdCBiYXNlZCBvbiB0aGUKLy8gYnV0dG9uTWFya3VwLXJlbGF0ZWQgY2xhc3NlcyBpdCBmaW5kcy4gSXQgcmVjb3JkcyB1bnJlY29nbml6ZWQgY2xhc3NlcyBpbiBhbgovLyBhcnJheS4KLy8KLy8gUmV0dXJuczogQW4gb2JqZWN0IGNvbnRhaW5pbmcgdGhlIGZvbGxvd2luZyBpdGVtczoKLy8KLy8gIm9wdGlvbnMiOiBidXR0b25NYXJrdXAgb3B0aW9ucyBmb3VuZCB0byBiZSBwcmVzZW50IGJlY2F1c2Ugb2YgdGhlCi8vIHByZXNlbmNlL2Fic2VuY2Ugb2YgY29ycmVzcG9uZGluZyBjbGFzc2VzCi8vCi8vICJ1bmtub3duQ2xhc3NlcyI6IGEgc3RyaW5nIGNvbnRhaW5pbmcgYWxsIHRoZSBub24tYnV0dG9uTWFya3VwLXJlbGF0ZWQKLy8gY2xhc3NlcyBmb3VuZCBpbiBAY2xhc3NlcwovLwovLyAiYWxyZWFkeUVuaGFuY2VkIjogQSBib29sZWFuIGluZGljYXRpbmcgd2hldGhlciB0aGUgdWktYnRuIGNsYXNzIHdhcyBhbW9uZwovLyB0aG9zZSBmb3VuZCB0byBiZSBwcmVzZW50CmZ1bmN0aW9uIGNsYXNzTmFtZVRvT3B0aW9ucyggY2xhc3NlcyApIHsKCXZhciBpZHgsIG1hcCwgdW5rbm93bkNsYXNzLAoJCWFscmVhZHlFbmhhbmNlZCA9IGZhbHNlLAoJCW5vSWNvbiA9IHRydWUsCgkJbyA9IHsKCQkJaWNvbjogIiIsCgkJCWlubGluZTogZmFsc2UsCgkJCXNoYWRvdzogZmFsc2UsCgkJCWNvcm5lcnM6IGZhbHNlLAoJCQlpY29uc2hhZG93OiBmYWxzZSwKCQkJbWluaTogZmFsc2UKCQl9LAoJCXVua25vd25DbGFzc2VzID0gW107CgoJY2xhc3NlcyA9IGNsYXNzZXMuc3BsaXQoICIgIiApOwoKCS8vIExvb3Agb3ZlciB0aGUgY2xhc3NlcwoJZm9yICggaWR4ID0gMCA7IGlkeCA8IGNsYXNzZXMubGVuZ3RoIDsgaWR4KysgKSB7CgoJCS8vIEFzc3VtZSBpdCdzIGFuIHVucmVjb2duaXplZCBjbGFzcwoJCXVua25vd25DbGFzcyA9IHRydWU7CgoJCS8vIFJlY29nbml6ZSBib29sZWFuIG9wdGlvbnMgZnJvbSB0aGUgcHJlc2VuY2Ugb2YgY2xhc3NlcwoJCW1hcCA9IHJldmVyc2VCb29sT3B0aW9uTWFwWyBjbGFzc2VzWyBpZHggXSBdOwoJCWlmICggbWFwICE9PSB1bmRlZmluZWQgKSB7CgkJCXVua25vd25DbGFzcyA9IGZhbHNlOwoJCQlvWyBtYXAgXSA9IHRydWU7CgoJCS8vIFJlY29nbml6ZSB0aGUgcHJlc2VuY2Ugb2YgYW4gaWNvbiBhbmQgZXN0YWJsaXNoIHRoZSBpY29uIHBvc2l0aW9uCgkJfSBlbHNlIGlmICggY2xhc3Nlc1sgaWR4IF0uaW5kZXhPZiggInVpLWJ0bi1pY29uLSIgKSA9PT0gMCApIHsKCQkJdW5rbm93bkNsYXNzID0gZmFsc2U7CgkJCW5vSWNvbiA9IGZhbHNlOwoJCQlvLmljb25wb3MgPSBjbGFzc2VzWyBpZHggXS5zdWJzdHJpbmcoIDEyICk7CgoJCS8vIEVzdGFibGlzaCB3aGljaCBpY29uIGlzIHByZXNlbnQKCQl9IGVsc2UgaWYgKCBjbGFzc2VzWyBpZHggXS5pbmRleE9mKCAidWktaWNvbi0iICkgPT09IDAgKSB7CgkJCXVua25vd25DbGFzcyA9IGZhbHNlOwoJCQlvLmljb24gPSBjbGFzc2VzWyBpZHggXS5zdWJzdHJpbmcoIDggKTsKCgkJLy8gRXN0YWJsaXNoIHRoZSB0aGVtZSAtIHRoaXMgcmVjb2duaXplcyBvbmUtbGV0dGVyIHRoZW1lIHN3YXRjaCBuYW1lcwoJCX0gZWxzZSBpZiAoIGNsYXNzZXNbIGlkeCBdLmluZGV4T2YoICJ1aS1idG4tIiApID09PSAwICYmIGNsYXNzZXNbIGlkeCBdLmxlbmd0aCA9PT0gOCApIHsKCQkJdW5rbm93bkNsYXNzID0gZmFsc2U7CgkJCW8udGhlbWUgPSBjbGFzc2VzWyBpZHggXS5zdWJzdHJpbmcoIDcgKTsKCgkJLy8gUmVjb2duaXplIHRoYXQgdGhpcyBlbGVtZW50IGhhcyBhbHJlYWR5IGJlZW4gYnV0dG9uTWFya3VwLWVuaGFuY2VkCgkJfSBlbHNlIGlmICggY2xhc3Nlc1sgaWR4IF0gPT09ICJ1aS1idG4iICkgewoJCQl1bmtub3duQ2xhc3MgPSBmYWxzZTsKCQkJYWxyZWFkeUVuaGFuY2VkID0gdHJ1ZTsKCQl9CgoJCS8vIElmIHRoaXMgY2xhc3MgaGFzIG5vdCBiZWVuIHJlY29nbml6ZWQsIGFkZCBpdCB0byB0aGUgbGlzdAoJCWlmICggdW5rbm93bkNsYXNzICkgewoJCQl1bmtub3duQ2xhc3Nlcy5wdXNoKCBjbGFzc2VzWyBpZHggXSApOwoJCX0KCX0KCgkvLyBJZiBhICJ1aS1idG4taWNvbi0qIiBpY29uIHBvc2l0aW9uIGNsYXNzIGlzIGFic2VudCB0aGVyZSBjYW5ub3QgYmUgYW4gaWNvbgoJaWYgKCBub0ljb24gKSB7CgkJby5pY29uID0gIiI7Cgl9CgoJcmV0dXJuIHsKCQlvcHRpb25zOiBvLAoJCXVua25vd25DbGFzc2VzOiB1bmtub3duQ2xhc3NlcywKCQlhbHJlYWR5RW5oYW5jZWQ6IGFscmVhZHlFbmhhbmNlZAoJfTsKfQoKZnVuY3Rpb24gY2FtZWxDYXNlMkh5cGhlbmF0ZWQoIGMgKSB7CglyZXR1cm4gIi0iICsgYy50b0xvd2VyQ2FzZSgpOwp9CgovLyAkLmZuLmJ1dHRvbk1hcmt1cDoKLy8gRE9NOiBnZXRzL3NldHMgLmNsYXNzTmFtZQovLwovLyBAb3B0aW9uczogb3B0aW9ucyB0byBhcHBseSB0byB0aGUgZWxlbWVudHMgaW4gdGhlIGpRdWVyeSBvYmplY3QKLy8gQG92ZXJ3cml0ZUNsYXNzZXM6IGJvb2xlYW4gaW5kaWNhdGluZyB3aGV0aGVyIHRvIGhvbm91ciBleGlzdGluZyBjbGFzc2VzCi8vCi8vIENhbGN1bGF0ZXMgdGhlIGNsYXNzZXMgdG8gYXBwbHkgdG8gdGhlIGVsZW1lbnRzIGluIHRoZSBqUXVlcnkgb2JqZWN0IGJhc2VkIG9uCi8vIHRoZSBvcHRpb25zIHBhc3NlZCBpbi4gSWYgQG92ZXJ3cml0ZUNsYXNzZXMgaXMgdHJ1ZSwgaXQgc2V0cyB0aGUgY2xhc3NOYW1lCi8vIHByb3BlcnR5IG9mIGVhY2ggZWxlbWVudCBpbiB0aGUgalF1ZXJ5IG9iamVjdCB0byB0aGUgYnV0dG9uTWFya3VwIGNsYXNzZXMKLy8gaXQgY2FsY3VsYXRlcyBiYXNlZCBvbiB0aGUgb3B0aW9ucyBwYXNzZWQgaW4uCi8vCi8vIElmIHlvdSB3aXNoIHRvIHByZXNlcnZlIGFueSBjbGFzc2VzIHRoYXQgYXJlIGFscmVhZHkgcHJlc2VudCBvbiB0aGUgZWxlbWVudHMKLy8gaW5zaWRlIHRoZSBqUXVlcnkgb2JqZWN0LCBpbmNsdWRpbmcgYnV0dG9uTWFya3VwLXJlbGF0ZWQgY2xhc3NlcyB0aGF0IHdlcmUKLy8gYWRkZWQgYnkgYSBwcmV2aW91cyBjYWxsIHRvICQuZm4uYnV0dG9uTWFya3VwKCkgb3IgZHVyaW5nIHBhZ2UgZW5oYW5jZW1lbnQKLy8gdGhlbiB5b3Ugc2hvdWxkIG9taXQgQG92ZXJ3cml0ZUNsYXNzZXMgb3Igc2V0IGl0IHRvIGZhbHNlLgokLmZuLmJ1dHRvbk1hcmt1cCA9IGZ1bmN0aW9uKCBvcHRpb25zLCBvdmVyd3JpdGVDbGFzc2VzICkgewoJdmFyIGlkeCwgZGF0YSwgZWwsIHJldHJpZXZlZE9wdGlvbnMsIG9wdGlvbktleSwKCQlkZWZhdWx0cyA9ICQuZm4uYnV0dG9uTWFya3VwLmRlZmF1bHRzOwoKCWZvciAoIGlkeCA9IDAgOyBpZHggPCB0aGlzLmxlbmd0aCA7IGlkeCsrICkgewoJCWVsID0gdGhpc1sgaWR4IF07CgkJZGF0YSA9IG92ZXJ3cml0ZUNsYXNzZXMgPwoKCQkJLy8gQXNzdW1lIHRoaXMgZWxlbWVudCBpcyBub3QgZW5oYW5jZWQgYW5kIGlnbm9yZSBpdHMgY2xhc3NlcwoJCQl7IGFscmVhZHlFbmhhbmNlZDogZmFsc2UsIHVua25vd25DbGFzc2VzOiBbXSB9IDoKCgkJCS8vIE90aGVyd2lzZSBhbmFseXplIGV4aXN0aW5nIGNsYXNzZXMgdG8gZXN0YWJsaXNoIGV4aXN0aW5nIG9wdGlvbnMgYW5kCgkJCS8vIGNsYXNzZXMKCQkJY2xhc3NOYW1lVG9PcHRpb25zKCBlbC5jbGFzc05hbWUgKTsKCgkJcmV0cmlldmVkT3B0aW9ucyA9ICQuZXh0ZW5kKCB7fSwKCgkJCS8vIElmIHRoZSBlbGVtZW50IGFscmVhZHkgaGFzIHRoZSBjbGFzcyB1aS1idG4sIHRoZW4gd2UgYXNzdW1lIHRoYXQKCQkJLy8gaXQgaGFzIHBhc3NlZCB0aHJvdWdoIGJ1dHRvbk1hcmt1cCBiZWZvcmUgLSBvdGhlcndpc2UsIHRoZSBvcHRpb25zCgkJCS8vIHJldHVybmVkIGJ5IGNsYXNzTmFtZVRvT3B0aW9ucyBkbyBub3QgY29ycmVjdGx5IHJlZmxlY3QgdGhlIHN0YXRlIG9mCgkJCS8vIHRoZSBlbGVtZW50CgkJCSggZGF0YS5hbHJlYWR5RW5oYW5jZWQgPyBkYXRhLm9wdGlvbnMgOiB7fSApLAoKCQkJLy8gRmluYWxseSwgYXBwbHkgdGhlIG9wdGlvbnMgcGFzc2VkIGluCgkJCW9wdGlvbnMgKTsKCgkJLy8gSWYgdGhpcyBpcyB0aGUgZmlyc3QgY2FsbCBvbiB0aGlzIGVsZW1lbnQsIHJldHJpZXZlIHJlbWFpbmluZyBvcHRpb25zCgkJLy8gZnJvbSB0aGUgZGF0YS1hdHRyaWJ1dGVzCgkJaWYgKCAhZGF0YS5hbHJlYWR5RW5oYW5jZWQgKSB7CgkJCWZvciAoIG9wdGlvbktleSBpbiBkZWZhdWx0cyApIHsKCQkJCWlmICggcmV0cmlldmVkT3B0aW9uc1sgb3B0aW9uS2V5IF0gPT09IHVuZGVmaW5lZCApIHsKCQkJCQlyZXRyaWV2ZWRPcHRpb25zWyBvcHRpb25LZXkgXSA9IGdldEF0dHJGaXhlZCggZWwsCgkJCQkJCW9wdGlvbktleS5yZXBsYWNlKCBjYXBpdGFsTGV0dGVyc1JFLCBjYW1lbENhc2UySHlwaGVuYXRlZCApCgkJCQkJKTsKCQkJCX0KCQkJfQoJCX0KCgkJZWwuY2xhc3NOYW1lID0gb3B0aW9uc1RvQ2xhc3NlcygKCgkJCS8vIE1lcmdlIGFsbCB0aGUgb3B0aW9ucyBhbmQgYXBwbHkgdGhlbSBhcyBjbGFzc2VzCgkJCSQuZXh0ZW5kKCB7fSwKCgkJCQkvLyBUaGUgZGVmYXVsdHMgZm9ybSB0aGUgYmFzaXMKCQkJCWRlZmF1bHRzLAoKCQkJCS8vIEFkZCB0aGUgY29tcHV0ZWQgb3B0aW9ucwoJCQkJcmV0cmlldmVkT3B0aW9ucwoJCQkpLAoKCQkJLy8gLi4uIGFuZCByZS1hcHBseSBhbnkgdW5yZWNvZ25pemVkIGNsYXNzZXMgdGhhdCB3ZXJlIGZvdW5kCgkJCWRhdGEudW5rbm93bkNsYXNzZXMgKS5qb2luKCAiICIgKTsKCQlpZiAoIGVsLnRhZ05hbWUudG9Mb3dlckNhc2UoKSAhPT0gImJ1dHRvbiIgKSB7CgkJCWVsLnNldEF0dHJpYnV0ZSggInJvbGUiLCAiYnV0dG9uIiApOwoJCX0KCX0KCglyZXR1cm4gdGhpczsKfTsKCi8vIGJ1dHRvbk1hcmt1cCBkZWZhdWx0cy4gVGhpcyBtdXN0IGJlIGEgY29tcGxldGUgc2V0LCBpLmUuLCBhIHZhbHVlIG11c3QgYmUKLy8gZ2l2ZW4gaGVyZSBmb3IgYWxsIHJlY29nbml6ZWQgb3B0aW9ucwokLmZuLmJ1dHRvbk1hcmt1cC5kZWZhdWx0cyA9IHsKCWljb246ICIiLAoJaWNvbnBvczogImxlZnQiLAoJdGhlbWU6IG51bGwsCglpbmxpbmU6IGZhbHNlLAoJc2hhZG93OiB0cnVlLAoJY29ybmVyczogdHJ1ZSwKCWljb25zaGFkb3c6IGZhbHNlLCAvKiBUT0RPOiBSZW1vdmUgaW4gMS41LiBPcHRpb24gZGVwcmVjYXRlZCBpbiAxLjQuICovCgltaW5pOiBmYWxzZQp9OwoKJC5leHRlbmQoICQuZm4uYnV0dG9uTWFya3VwLCB7Cglpbml0U2VsZWN0b3I6ICJhOmpxbURhdGEocm9sZT0nYnV0dG9uJyksIC51aS1iYXIgPiBhLCAudWktYmFyID4gOmpxbURhdGEocm9sZT0nY29udHJvbGdyb3VwJykgPiBhLCBidXR0b24iCn0pOwoKfSkoIGpRdWVyeSApOwoKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUuY29udHJvbGdyb3VwIiwgJC5leHRlbmQoIHsKCW9wdGlvbnM6IHsKCQllbmhhbmNlZDogZmFsc2UsCgkJdGhlbWU6IG51bGwsCgkJc2hhZG93OiBmYWxzZSwKCQljb3JuZXJzOiB0cnVlLAoJCWV4Y2x1ZGVJbnZpc2libGU6IHRydWUsCgkJdHlwZTogInZlcnRpY2FsIiwKCQltaW5pOiBmYWxzZQoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl2YXIgZWxlbSA9IHRoaXMuZWxlbWVudCwKCQkJb3B0cyA9IHRoaXMub3B0aW9uczsKCgkJLy8gUnVuIGJ1dHRvbm1hcmt1cAoJCWlmKCAkLmZuLmJ1dHRvbk1hcmt1cCApewoJCQl0aGlzLmVsZW1lbnQuZmluZCggJC5mbi5idXR0b25NYXJrdXAuaW5pdFNlbGVjdG9yICkuYnV0dG9uTWFya3VwKCk7CgkJfQoJCS8vIEVuaGFuY2UgY2hpbGQgd2lkZ2V0cwoJCSQuZWFjaCggdGhpcy5fY2hpbGRXaWRnZXRzLCAkLnByb3h5KCBmdW5jdGlvbiggbnVtYmVyLCB3aWRnZXROYW1lICkgewoJCQlpZiggJC5tb2JpbGVbIHdpZGdldE5hbWUgXSApIHsKCQkJCXRoaXMuZWxlbWVudC5maW5kKCAkLm1vYmlsZVsgd2lkZ2V0TmFtZSBdLmluaXRTZWxlY3RvciApWyB3aWRnZXROYW1lIF0oKTsKCQkJfQoJCX0sIHRoaXMgKSk7CgoJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCV91aTogbnVsbCwKCQkJX2luaXRpYWxSZWZyZXNoOiB0cnVlCgkJfSk7CgoJCWlmICggb3B0cy5lbmhhbmNlZCApIHsKCQkJdGhpcy5fdWkgPSB7CgkJCQlncm91cExlZ2VuZDogZWxlbS5jaGlsZHJlbiggIi51aS1jb250cm9sZ3JvdXAtbGFiZWwiICkuY2hpbGRyZW4oKSwKCQkJCWNoaWxkV3JhcHBlcjogZWxlbS5jaGlsZHJlbiggIi51aS1jb250cm9sZ3JvdXAtY29udHJvbHMiICkKCQkJfTsKCQl9IGVsc2UgewoJCQl0aGlzLl91aSA9IHRoaXMuX2VuaGFuY2UoKTsKCQl9CgkJCgl9LAoKCV9jaGlsZFdpZGdldHM6IFsgImNoZWNrYm94cmFkaW8iLCAic2VsZWN0bWVudSIsICJidXR0b24iIF0sCgoJX3RoZW1lQ2xhc3NGcm9tT3B0aW9uOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJcmV0dXJuICggdmFsdWUgPyAoIHZhbHVlID09PSAibm9uZSIgPyAiIiA6ICJ1aS1ncm91cC10aGVtZS0iICsgdmFsdWUgKSA6ICIiICk7Cgl9LAoKCV9lbmhhbmNlOiBmdW5jdGlvbigpIHsKCQl2YXIgZWxlbSA9IHRoaXMuZWxlbWVudCwKCQkJb3B0cyA9IHRoaXMub3B0aW9ucywKCQkJdWkgPSB7CgkJCQlncm91cExlZ2VuZDogZWxlbS5jaGlsZHJlbiggImxlZ2VuZCIgKSwKCQkJCWNoaWxkV3JhcHBlcjogZWxlbQoJCQkJCS5hZGRDbGFzcyggInVpLWNvbnRyb2xncm91cCAiICsKCQkJCQkJInVpLWNvbnRyb2xncm91cC0iICsKCQkJCQkJCSggb3B0cy50eXBlID09PSAiaG9yaXpvbnRhbCIgPyAiaG9yaXpvbnRhbCIgOiAidmVydGljYWwiICkgKyAiICIgKwoJCQkJCQl0aGlzLl90aGVtZUNsYXNzRnJvbU9wdGlvbiggb3B0cy50aGVtZSApICsgIiAiICsKCQkJCQkJKCBvcHRzLmNvcm5lcnMgPyAidWktY29ybmVyLWFsbCAiIDogIiIgKSArCgkJCQkJCSggb3B0cy5taW5pID8gInVpLW1pbmkgIiA6ICIiICkgKQoJCQkJCS53cmFwSW5uZXIoICI8ZGl2ICIgKwoJCQkJCQkiY2xhc3M9J3VpLWNvbnRyb2xncm91cC1jb250cm9scyAiICsKCQkJCQkJCSggb3B0cy5zaGFkb3cgPT09IHRydWUgPyAidWktc2hhZG93IiA6ICIiICkgKyAiJz48L2Rpdj4iICkKCQkJCQkuY2hpbGRyZW4oKQoJCQl9OwoKCQlpZiAoIHVpLmdyb3VwTGVnZW5kLmxlbmd0aCA+IDAgKSB7CgkJCSQoICI8ZGl2IHJvbGU9J2hlYWRpbmcnIGNsYXNzPSd1aS1jb250cm9sZ3JvdXAtbGFiZWwnPjwvZGl2PiIgKQoJCQkJLmFwcGVuZCggdWkuZ3JvdXBMZWdlbmQgKQoJCQkJLnByZXBlbmRUbyggZWxlbSApOwoJCX0KCgkJcmV0dXJuIHVpOwoJfSwKCglfaW5pdDogZnVuY3Rpb24oKSB7CgkJdGhpcy5yZWZyZXNoKCk7Cgl9LAoKCV9zZXRPcHRpb25zOiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQl2YXIgY2FsbFJlZnJlc2gsCgkJCWVsZW0gPSB0aGlzLmVsZW1lbnQ7CgoJCS8vIE11c3QgaGF2ZSBvbmUgb2YgaG9yaXpvbnRhbCBvciB2ZXJ0aWNhbAoJCWlmICggb3B0aW9ucy50eXBlICE9PSB1bmRlZmluZWQgKSB7CgkJCWVsZW0KCQkJCS5yZW1vdmVDbGFzcyggInVpLWNvbnRyb2xncm91cC1ob3Jpem9udGFsIHVpLWNvbnRyb2xncm91cC12ZXJ0aWNhbCIgKQoJCQkJLmFkZENsYXNzKCAidWktY29udHJvbGdyb3VwLSIgKyAoIG9wdGlvbnMudHlwZSA9PT0gImhvcml6b250YWwiID8gImhvcml6b250YWwiIDogInZlcnRpY2FsIiApICk7CgkJCWNhbGxSZWZyZXNoID0gdHJ1ZTsKCQl9CgoJCWlmICggb3B0aW9ucy50aGVtZSAhPT0gdW5kZWZpbmVkICkgewoJCQllbGVtCgkJCQkucmVtb3ZlQ2xhc3MoIHRoaXMuX3RoZW1lQ2xhc3NGcm9tT3B0aW9uKCB0aGlzLm9wdGlvbnMudGhlbWUgKSApCgkJCQkuYWRkQ2xhc3MoIHRoaXMuX3RoZW1lQ2xhc3NGcm9tT3B0aW9uKCBvcHRpb25zLnRoZW1lICkgKTsKCQl9CgoJCWlmICggb3B0aW9ucy5jb3JuZXJzICE9PSB1bmRlZmluZWQgKSB7CgkJCWVsZW0udG9nZ2xlQ2xhc3MoICJ1aS1jb3JuZXItYWxsIiwgb3B0aW9ucy5jb3JuZXJzICk7CgkJfQoKCQlpZiAoIG9wdGlvbnMubWluaSAhPT0gdW5kZWZpbmVkICkgewoJCQllbGVtLnRvZ2dsZUNsYXNzKCAidWktbWluaSIsIG9wdGlvbnMubWluaSApOwoJCX0KCgkJaWYgKCBvcHRpb25zLnNoYWRvdyAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLl91aS5jaGlsZFdyYXBwZXIudG9nZ2xlQ2xhc3MoICJ1aS1zaGFkb3ciLCBvcHRpb25zLnNoYWRvdyApOwoJCX0KCgkJaWYgKCBvcHRpb25zLmV4Y2x1ZGVJbnZpc2libGUgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhpcy5vcHRpb25zLmV4Y2x1ZGVJbnZpc2libGUgPSBvcHRpb25zLmV4Y2x1ZGVJbnZpc2libGU7CgkJCWNhbGxSZWZyZXNoID0gdHJ1ZTsKCQl9CgoJCWlmICggY2FsbFJlZnJlc2ggKSB7CgkJCXRoaXMucmVmcmVzaCgpOwoJCX0KCgkJcmV0dXJuIHRoaXMuX3N1cGVyKCBvcHRpb25zICk7Cgl9LAoKCWNvbnRhaW5lcjogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuX3VpLmNoaWxkV3JhcHBlcjsKCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJdmFyICRlbCA9IHRoaXMuY29udGFpbmVyKCksCgkJCWVscyA9ICRlbC5maW5kKCAiLnVpLWJ0biIgKS5ub3QoICIudWktc2xpZGVyLWhhbmRsZSIgKSwKCQkJY3JlYXRlID0gdGhpcy5faW5pdGlhbFJlZnJlc2g7CgkJaWYgKCAkLm1vYmlsZS5jaGVja2JveHJhZGlvICkgewoJCQkkZWwuZmluZCggIjptb2JpbGUtY2hlY2tib3hyYWRpbyIgKS5jaGVja2JveHJhZGlvKCAicmVmcmVzaCIgKTsKCQl9CgkJdGhpcy5fYWRkRmlyc3RMYXN0Q2xhc3NlcyggZWxzLAoJCQl0aGlzLm9wdGlvbnMuZXhjbHVkZUludmlzaWJsZSA/IHRoaXMuX2dldFZpc2libGVzKCBlbHMsIGNyZWF0ZSApIDogZWxzLAoJCQljcmVhdGUgKTsKCQl0aGlzLl9pbml0aWFsUmVmcmVzaCA9IGZhbHNlOwoJfSwKCgkvLyBDYXZlYXQ6IElmIHRoZSBsZWdlbmQgaXMgbm90IHRoZSBmaXJzdCBjaGlsZCBvZiB0aGUgY29udHJvbGdyb3VwIGF0IGVuaGFuY2UKCS8vIHRpbWUsIGl0IHdpbGwgYmUgYWZ0ZXIgX2Rlc3Ryb3koKS4KCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCQl2YXIgdWksIGJ1dHRvbnMsCgkJCW9wdHMgPSB0aGlzLm9wdGlvbnM7CgoJCWlmICggb3B0cy5lbmhhbmNlZCApIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQl1aSA9IHRoaXMuX3VpOwoJCWJ1dHRvbnMgPSB0aGlzLmVsZW1lbnQKCQkJLnJlbW92ZUNsYXNzKCAidWktY29udHJvbGdyb3VwICIgKwoJCQkJInVpLWNvbnRyb2xncm91cC1ob3Jpem9udGFsIHVpLWNvbnRyb2xncm91cC12ZXJ0aWNhbCB1aS1jb3JuZXItYWxsIHVpLW1pbmkgIiArCgkJCQl0aGlzLl90aGVtZUNsYXNzRnJvbU9wdGlvbiggb3B0cy50aGVtZSApICkKCQkJLmZpbmQoICIudWktYnRuIiApCgkJCS5ub3QoICIudWktc2xpZGVyLWhhbmRsZSIgKTsKCgkJdGhpcy5fcmVtb3ZlRmlyc3RMYXN0Q2xhc3NlcyggYnV0dG9ucyApOwoKCQl1aS5ncm91cExlZ2VuZC51bndyYXAoKTsKCQl1aS5jaGlsZFdyYXBwZXIuY2hpbGRyZW4oKS51bndyYXAoKTsKCX0KfSwgJC5tb2JpbGUuYmVoYXZpb3JzLmFkZEZpcnN0TGFzdENsYXNzZXMgKSApOwoKfSkoalF1ZXJ5KTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKCgkkLndpZGdldCggIm1vYmlsZS50b29sYmFyIiwgewoJCWluaXRTZWxlY3RvcjogIjpqcW1EYXRhKHJvbGU9J2Zvb3RlcicpLCA6anFtRGF0YShyb2xlPSdoZWFkZXInKSIsCgoJCW9wdGlvbnM6IHsKCQkJdGhlbWU6IG51bGwsCgkJCWFkZEJhY2tCdG46IGZhbHNlLAoJCQliYWNrQnRuVGhlbWU6IG51bGwsCgkJCWJhY2tCdG5UZXh0OiAiQmFjayIKCQl9LAoKCQlfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQkJdmFyIGxlZnRidG4sIHJpZ2h0YnRuLCBiYWNrQnRuLAoJCQkJcm9sZSA9ICB0aGlzLmVsZW1lbnQuaXMoICI6anFtRGF0YShyb2xlPSdoZWFkZXInKSIgKSA/ICJoZWFkZXIiIDogImZvb3RlciIsCgkJCQlwYWdlID0gdGhpcy5lbGVtZW50LmNsb3Nlc3QoICIudWktcGFnZSIgKTsKCQkJaWYgKCBwYWdlLmxlbmd0aCA9PT0gMCApewoJCQkJcGFnZSA9IGZhbHNlOwoJCQkJdGhpcy5fb24oIHRoaXMuZG9jdW1lbnQsIHsKCQkJCQkicGFnZXNob3ciOiAicmVmcmVzaCIKCQkJCX0pOwoJCQl9CgkJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCQlyb2xlOiByb2xlLAoJCQkJcGFnZTogcGFnZSwKCQkJCWxlZnRidG46IGxlZnRidG4sCgkJCQlyaWdodGJ0bjogcmlnaHRidG4sCgkJCQliYWNrQnRuOiBiYWNrQnRuCgkJCX0pOwoJCQl0aGlzLmVsZW1lbnQuYXR0ciggInJvbGUiLCByb2xlID09PSAiaGVhZGVyIiA/ICJiYW5uZXIiIDogImNvbnRlbnRpbmZvIiApLmFkZENsYXNzKCAidWktIiArIHJvbGUgKTsKCQkJdGhpcy5yZWZyZXNoKCk7CgkJCXRoaXMuX3NldE9wdGlvbnMoIHRoaXMub3B0aW9ucyApOwoJCX0sCgkJX3NldE9wdGlvbnM6IGZ1bmN0aW9uKCBvICkgewoJCQlpZiAoIG8uYWRkQmFja0J0biAhPT0gdW5kZWZpbmVkICkgewoJCQkJaWYgKCB0aGlzLm9wdGlvbnMuYWRkQmFja0J0biAmJgoJCQkJCXRoaXMucm9sZSA9PT0gImhlYWRlciIgJiYKCQkJCQkkKCAiLnVpLXBhZ2UiICkubGVuZ3RoID4gMSAmJgoJCQkJCXRoaXMucGFnZVsgMCBdLmdldEF0dHJpYnV0ZSggImRhdGEtIiArICQubW9iaWxlLm5zICsgInVybCIgKSAhPT0gJC5tb2JpbGUucGF0aC5zdHJpcEhhc2goIGxvY2F0aW9uLmhhc2ggKSAmJgoJCQkJCSF0aGlzLmxlZnRidG4gKSB7CgkJCQkJCXRoaXMuX2FkZEJhY2tCdXR0b24oKTsKCQkJCX0gZWxzZSB7CgkJCQkJdGhpcy5lbGVtZW50LmZpbmQoICIudWktdG9vbGJhci1iYWNrLWJ0biIgKS5yZW1vdmUoKTsKCQkJCX0KCQkJfQoJCQlpZiAoIG8uYmFja0J0blRoZW1lICE9PSB1bmRlZmluZWQgKSB7CgkJCQl0aGlzLmVsZW1lbnQKCQkJCQkuZmluZCggIi51aS10b29sYmFyLWJhY2stYnRuIiApCgkJCQkJLmFkZENsYXNzKCAidWktYnRuIHVpLWJ0bi0iICsgby5iYWNrQnRuVGhlbWUgKTsKCQkJfQoJCQlpZiAoIG8uYmFja0J0blRleHQgIT09IHVuZGVmaW5lZCApIHsKCQkJCXRoaXMuZWxlbWVudC5maW5kKCAiLnVpLXRvb2xiYXItYmFjay1idG4gLnVpLWJ0bi10ZXh0IiApLnRleHQoIG8uYmFja0J0blRleHQgKTsKCQkJfQoJCQlpZiAoIG8udGhlbWUgIT09IHVuZGVmaW5lZCApIHsKCQkJCXZhciBjdXJyZW50VGhlbWUgPSB0aGlzLm9wdGlvbnMudGhlbWUgPyB0aGlzLm9wdGlvbnMudGhlbWUgOiAiaW5oZXJpdCIsCgkJCQkJbmV3VGhlbWUgPSBvLnRoZW1lID8gby50aGVtZSA6ICJpbmhlcml0IjsKCgkJCQl0aGlzLmVsZW1lbnQucmVtb3ZlQ2xhc3MoICJ1aS1iYXItIiArIGN1cnJlbnRUaGVtZSApLmFkZENsYXNzKCAidWktYmFyLSIgKyBuZXdUaGVtZSApOwoJCQl9CgoJCQl0aGlzLl9zdXBlciggbyApOwoJCX0sCgkJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJCWlmICggdGhpcy5yb2xlID09PSAiaGVhZGVyIiApIHsKCQkJCXRoaXMuX2FkZEhlYWRlckJ1dHRvbkNsYXNzZXMoKTsKCQkJfQoJCQlpZiAoICF0aGlzLnBhZ2UgKSB7CgkJCQkkKCAiW2RhdGEtIisgJC5tb2JpbGUubnMgKyJyb2xlPSdwYWdlJ10iICkuY3NzKHsicG9zaXRpb24iOiJyZWxhdGl2ZSJ9KTsKCQkJCWlmICggdGhpcy5yb2xlID09PSAiZm9vdGVyIiApIHsKCQkJCQl0aGlzLmVsZW1lbnQuYXBwZW5kVG8oICJib2R5IiApOwoJCQkJfQoJCQl9CgkJCXRoaXMuX2FkZEhlYWRpbmdDbGFzc2VzKCk7CgkJCXRoaXMuX2J0bk1hcmt1cCgpOwoJCX0sCgkJLy8gRGVwcmVjYXRlZCBpbiAxLjQuIEFzIGZyb20gMS41IGRhdGEtcm9sZT0iYnV0dG9uIiBoYXMgdG8gYmUgcHJlc2VudCBpbiB0aGUgbWFya3VwLgoJCV9idG5NYXJrdXA6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLmVsZW1lbnQuY2hpbGRyZW4oICJhIiApLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyb2xlIiwgImJ1dHRvbiIgKTsKCQkJdGhpcy5lbGVtZW50LnRyaWdnZXIoICJjcmVhdGUiICk7CgkJfSwKCQlfYWRkSGVhZGVyQnV0dG9uQ2xhc3NlczogZnVuY3Rpb24oKSB7CgkJCXZhciAkaGVhZGVyYW5jaG9ycyA9IHRoaXMuZWxlbWVudC5jaGlsZHJlbiggImEsIGJ1dHRvbiIgKTsKCQkJdGhpcy5sZWZ0YnRuID0gJGhlYWRlcmFuY2hvcnMuaGFzQ2xhc3MoICJ1aS1idG4tbGVmdCIgKTsKCQkJdGhpcy5yaWdodGJ0biA9ICRoZWFkZXJhbmNob3JzLmhhc0NsYXNzKCAidWktYnRuLXJpZ2h0IiApOwoKCQkJdGhpcy5sZWZ0YnRuID0gdGhpcy5sZWZ0YnRuIHx8ICRoZWFkZXJhbmNob3JzLmVxKCAwICkubm90KCAiLnVpLWJ0bi1yaWdodCIgKS5hZGRDbGFzcyggInVpLWJ0bi1sZWZ0IiApLmxlbmd0aDsKCgkJCXRoaXMucmlnaHRidG4gPSB0aGlzLnJpZ2h0YnRuIHx8ICRoZWFkZXJhbmNob3JzLmVxKCAxICkuYWRkQ2xhc3MoICJ1aS1idG4tcmlnaHQiICkubGVuZ3RoOwoKCQl9LAoJCV9hZGRCYWNrQnV0dG9uOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5iYWNrQnRuID0gJCggIjxhIHJvbGU9J2J1dHRvbicgaHJlZj0namF2YXNjcmlwdDp2b2lkKDApOycgY2xhc3M9J3VpLWJ0bi1sZWZ0IHVpLXRvb2xiYXItYmFjay1idG4nIGRhdGEtIiArICQubW9iaWxlLm5zICsgInJlbD0nYmFjaycgZGF0YS0iICsgJC5tb2JpbGUubnMgKyAiaWNvbj0nY2FyYXQtbCc+IiArIHRoaXMub3B0aW9ucy5iYWNrQnRuVGV4dCArICI8L2E+IiApCgkJCQkJLy8gSWYgdGhlbWUgaXMgcHJvdmlkZWQsIG92ZXJyaWRlIGRlZmF1bHQgaW5oZXJpdGFuY2UKCQkJCQkuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgInRoZW1lIiwgdGhpcy5vcHRpb25zLmJhY2tCdG5UaGVtZSB8fCB0aGlzLm9wdGlvbnMudGhlbWUgKQoJCQkJCS5wcmVwZW5kVG8oIHRoaXMuZWxlbWVudCApOwoJCX0sCgkJX2FkZEhlYWRpbmdDbGFzc2VzOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5lbGVtZW50LmNoaWxkcmVuKCAiaDEsIGgyLCBoMywgaDQsIGg1LCBoNiIgKQoJCQkJLmFkZENsYXNzKCAidWktdGl0bGUiICkKCQkJCS8vIFJlZ2FyZGxlc3Mgb2YgaCBlbGVtZW50IG51bWJlciBpbiBzcmMsIGl0IGJlY29tZXMgaDEgZm9yIHRoZSBlbmhhbmNlZCBwYWdlCgkJCQkuYXR0cih7CgkJCQkJInJvbGUiOiAiaGVhZGluZyIsCgkJCQkJImFyaWEtbGV2ZWwiOiAiMSIKCQkJCX0pOwoJCX0KCX0pOwoJCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKCgkkLndpZGdldCggIm1vYmlsZS50b29sYmFyIiwgJC5tb2JpbGUudG9vbGJhciwgewoJCW9wdGlvbnM6IHsKCQkJcG9zaXRpb246bnVsbCwKCQkJdmlzaWJsZU9uUGFnZVNob3c6IHRydWUsCgkJCWRpc2FibGVQYWdlWm9vbTogdHJ1ZSwKCQkJdHJhbnNpdGlvbjogInNsaWRlIiwgLy9jYW4gYmUgbm9uZSwgZmFkZSwgc2xpZGUgKHNsaWRlIG1hcHMgdG8gc2xpZGV1cCBvciBzbGlkZWRvd24pCgkJCWZ1bGxzY3JlZW46IGZhbHNlLAoJCQl0YXBUb2dnbGU6IHRydWUsCgkJCXRhcFRvZ2dsZUJsYWNrbGlzdDogImEsIGJ1dHRvbiwgaW5wdXQsIHNlbGVjdCwgdGV4dGFyZWEsIC51aS1oZWFkZXItZml4ZWQsIC51aS1mb290ZXItZml4ZWQsIC51aS1mbGlwc3dpdGNoLCAudWktcG9wdXAsIC51aS1wYW5lbCwgLnVpLXBhbmVsLWRpc21pc3Mtb3BlbiIsCgkJCWhpZGVEdXJpbmdGb2N1czogImlucHV0LCB0ZXh0YXJlYSwgc2VsZWN0IiwKCQkJdXBkYXRlUGFnZVBhZGRpbmc6IHRydWUsCgkJCXRyYWNrUGVyc2lzdGVudFRvb2xiYXJzOiB0cnVlLAoKCQkJLy8gQnJvd3NlciBkZXRlY3Rpb24hIFdlZWVlLCBoZXJlIHdlIGdvLi4uCgkJCS8vIFVuZm9ydHVuYXRlbHksIHBvc2l0aW9uOmZpeGVkIGlzIGNvc3RseSwgbm90IHRvIG1lbnRpb24gcHJvYmFibHkgaW1wb3NzaWJsZSwgdG8gZmVhdHVyZS1kZXRlY3QgYWNjdXJhdGVseS4KCQkJLy8gU29tZSB0ZXN0cyBleGlzdCwgYnV0IHRoZXkgY3VycmVudGx5IHJldHVybiBmYWxzZSByZXN1bHRzIGluIGNyaXRpY2FsIGRldmljZXMgYW5kIGJyb3dzZXJzLCB3aGljaCBjb3VsZCBsZWFkIHRvIGEgYnJva2VuIGV4cGVyaWVuY2UuCgkJCS8vIFRlc3RpbmcgZml4ZWQgcG9zaXRpb25pbmcgaXMgYWxzbyBwcmV0dHkgb2J0cnVzaXZlIHRvIHBhZ2UgbG9hZCwgcmVxdWlyaW5nIGluamVjdGVkIGVsZW1lbnRzIGFuZCBzY3JvbGxpbmcgdGhlIHdpbmRvdwoJCQkvLyBUaGUgZm9sbG93aW5nIGZ1bmN0aW9uIHNlcnZlcyB0byBydWxlIG91dCBzb21lIHBvcHVsYXIgYnJvd3NlcnMgd2l0aCBrbm93biBmaXhlZC1wb3NpdGlvbmluZyBpc3N1ZXMKCQkJLy8gVGhpcyBpcyBhIHBsdWdpbiBvcHRpb24gbGlrZSBhbnkgb3RoZXIsIHNvIGZlZWwgZnJlZSB0byBpbXByb3ZlIG9yIG92ZXJ3cml0ZSBpdAoJCQlzdXBwb3J0QmxhY2tsaXN0OiBmdW5jdGlvbigpIHsKCQkJCXJldHVybiAhJC5zdXBwb3J0LmZpeGVkUG9zaXRpb247CgkJCX0KCQl9LAoKCQlfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5fc3VwZXIoKTsKCQkJaWYgKCB0aGlzLm9wdGlvbnMucG9zaXRpb24gPT09ICJmaXhlZCIgJiYgIXRoaXMub3B0aW9ucy5zdXBwb3J0QmxhY2tsaXN0KCkgKXsKCQkJCXRoaXMuX21ha2VGaXhlZCgpOwoJCQl9CgkJfSwKCgkJX21ha2VGaXhlZDogZnVuY3Rpb24oKXsKCQkJdGhpcy5lbGVtZW50LmFkZENsYXNzKCAidWktIisgdGhpcy5yb2xlICsiLWZpeGVkIiApOwoJCQl0aGlzLnVwZGF0ZVBhZ2VQYWRkaW5nKCk7CgkJCXRoaXMuX2FkZFRyYW5zaXRpb25DbGFzcygpOwoJCQl0aGlzLl9iaW5kUGFnZUV2ZW50cygpOwoJCQl0aGlzLl9iaW5kVG9nZ2xlSGFuZGxlcnMoKTsKCQkJdGhpcy5fc2V0T3B0aW9ucyggdGhpcy5vcHRpb25zICk7CgkJfSwKCgkJX3NldE9wdGlvbnM6IGZ1bmN0aW9uKCBvICl7CgkJCWlmKCBvLnBvc2l0aW9uID09PSAiZml4ZWQiICYmIHRoaXMub3B0aW9ucy5wb3NpdGlvbiAhPT0gImZpeGVkIiApIHsKCQkJCXRoaXMuX21ha2VGaXhlZCgpOwoJCQl9CgkJCWlmICggdGhpcy5vcHRpb25zLnBvc2l0aW9uID09PSAiZml4ZWQiICYmICF0aGlzLm9wdGlvbnMuc3VwcG9ydEJsYWNrbGlzdCgpICl7CgkJCQl2YXIgJHBhZ2UgPSAoICEhdGhpcy5wYWdlICk/IHRoaXMucGFnZTogKCAkKCIudWktcGFnZS1hY3RpdmUiKS5sZW5ndGggPiAwICk/ICQoIi51aS1wYWdlLWFjdGl2ZSIpOiAkKCIudWktcGFnZSIpLmVxKDApOwoKCQkJCWlmICggby5mdWxsc2NyZWVuICE9PSB1bmRlZmluZWQpewoJCQkJCWlmICggby5mdWxsc2NyZWVuICkgewoJCQkJCQl0aGlzLmVsZW1lbnQuYWRkQ2xhc3MoICJ1aS0iKyB0aGlzLnJvbGUgKyItZnVsbHNjcmVlbiIgKTsKCQkJCQkJJHBhZ2UuYWRkQ2xhc3MoICJ1aS1wYWdlLSIgKyB0aGlzLnJvbGUgKyAiLWZ1bGxzY3JlZW4iICk7CgkJCQkJfQoJCQkJCS8vIElmIG5vdCBmdWxsc2NyZWVuLCBhZGQgY2xhc3MgdG8gcGFnZSB0byBzZXQgdG9wIG9yIGJvdHRvbSBwYWRkaW5nCgkJCQkJZWxzZSB7CgkJCQkJCXRoaXMuZWxlbWVudC5yZW1vdmVDbGFzcyggInVpLSIrIHRoaXMucm9sZSArIi1mdWxsc2NyZWVuIiApOwoJCQkJCQkkcGFnZS5yZW1vdmVDbGFzcyggInVpLXBhZ2UtIiArIHRoaXMucm9sZSArICItZnVsbHNjcmVlbiIgKS5hZGRDbGFzcyggInVpLXBhZ2UtIiArIHRoaXMucm9sZSsgIi1maXhlZCIgKTsKCQkJCQl9CgkJCQl9CgkJCX0KCQkJdGhpcy5fc3VwZXIobyk7CgkJfSwKCgkJX2FkZFRyYW5zaXRpb25DbGFzczogZnVuY3Rpb24oKSB7CgkJCXZhciB0Y2xhc3MgPSB0aGlzLm9wdGlvbnMudHJhbnNpdGlvbjsKCgkJCWlmICggdGNsYXNzICYmIHRjbGFzcyAhPT0gIm5vbmUiICkgewoJCQkJLy8gdXNlIGFwcHJvcHJpYXRlIHNsaWRlIGZvciBoZWFkZXIgb3IgZm9vdGVyCgkJCQlpZiAoIHRjbGFzcyA9PT0gInNsaWRlIiApIHsKCQkJCQl0Y2xhc3MgPSB0aGlzLmVsZW1lbnQuaGFzQ2xhc3MoICJ1aS1oZWFkZXIiICkgPyAic2xpZGVkb3duIiA6ICJzbGlkZXVwIjsKCQkJCX0KCgkJCQl0aGlzLmVsZW1lbnQuYWRkQ2xhc3MoIHRjbGFzcyApOwoJCQl9CgkJfSwKCgkJX2JpbmRQYWdlRXZlbnRzOiBmdW5jdGlvbigpIHsKCQkJdmFyIHBhZ2UgPSAoICEhdGhpcy5wYWdlICk/IHRoaXMuZWxlbWVudC5jbG9zZXN0KCAiLnVpLXBhZ2UiICk6IHRoaXMuZG9jdW1lbnQ7CgkJCS8vcGFnZSBldmVudCBiaW5kaW5ncwoJCQkvLyBGaXhlZCB0b29sYmFycyByZXF1aXJlIHBhZ2Ugem9vbSB0byBiZSBkaXNhYmxlZCwgb3RoZXJ3aXNlIHVzYWJpbGl0eSBpc3N1ZXMgY3JvcCB1cAoJCQkvLyBUaGlzIG1ldGhvZCBpcyBtZWFudCB0byBkaXNhYmxlIHpvb20gd2hpbGUgYSBmaXhlZC1wb3NpdGlvbmVkIHRvb2xiYXIgcGFnZSBpcyB2aXNpYmxlCgkJCXRoaXMuX29uKCBwYWdlICwgewoJCQkJInBhZ2ViZWZvcmVzaG93IjogIl9oYW5kbGVQYWdlQmVmb3JlU2hvdyIsCgkJCQkid2Via2l0QW5pbWF0aW9uU3RhcnQiOiJfaGFuZGxlQW5pbWF0aW9uU3RhcnQiLAoJCQkJImFuaW1hdGlvbnN0YXJ0IjoiX2hhbmRsZUFuaW1hdGlvblN0YXJ0IiwKCQkJCSJ1cGRhdGVsYXlvdXQiOiAiX2hhbmRsZUFuaW1hdGlvblN0YXJ0IiwKCQkJCSJwYWdlc2hvdyI6ICJfaGFuZGxlUGFnZVNob3ciLAoJCQkJInBhZ2ViZWZvcmVoaWRlIjogIl9oYW5kbGVQYWdlQmVmb3JlSGlkZSIKCQkJfSk7CgkJfSwKCgkJX2hhbmRsZVBhZ2VCZWZvcmVTaG93OiBmdW5jdGlvbiggKSB7CgkJCXZhciBvID0gdGhpcy5vcHRpb25zOwoJCQlpZiAoIG8uZGlzYWJsZVBhZ2Vab29tICkgewoJCQkJJC5tb2JpbGUuem9vbS5kaXNhYmxlKCB0cnVlICk7CgkJCX0KCQkJaWYgKCAhby52aXNpYmxlT25QYWdlU2hvdyApIHsKCQkJCXRoaXMuaGlkZSggdHJ1ZSApOwoJCQl9CgkJfSwKCgkJX2hhbmRsZUFuaW1hdGlvblN0YXJ0OiBmdW5jdGlvbigpIHsKCQkJaWYgKCB0aGlzLm9wdGlvbnMudXBkYXRlUGFnZVBhZGRpbmcgKSB7CgkJCQl0aGlzLnVwZGF0ZVBhZ2VQYWRkaW5nKCAoICEhdGhpcy5wYWdlICk/IHRoaXMucGFnZTogIi51aS1wYWdlLWFjdGl2ZSIgKTsKCQkJfQoJCX0sCgoJCV9oYW5kbGVQYWdlU2hvdzogZnVuY3Rpb24oKSB7CgkJCXRoaXMudXBkYXRlUGFnZVBhZGRpbmcoICggISF0aGlzLnBhZ2UgKT8gdGhpcy5wYWdlOiAiLnVpLXBhZ2UtYWN0aXZlIiApOwoJCQlpZiAoIHRoaXMub3B0aW9ucy51cGRhdGVQYWdlUGFkZGluZyApIHsKCQkJCXRoaXMuX29uKCB0aGlzLndpbmRvdywgeyAidGhyb3R0bGVkcmVzaXplIjogInVwZGF0ZVBhZ2VQYWRkaW5nIiB9ICk7CgkJCX0KCQl9LAoKCQlfaGFuZGxlUGFnZUJlZm9yZUhpZGU6IGZ1bmN0aW9uKCBlLCB1aSApIHsKCQkJdmFyIG8gPSB0aGlzLm9wdGlvbnMsCgkJCQl0aGlzRm9vdGVyLCB0aGlzSGVhZGVyLCBuZXh0Rm9vdGVyLCBuZXh0SGVhZGVyOwoKCgkJCWlmICggby5kaXNhYmxlUGFnZVpvb20gKSB7CgkJCQkkLm1vYmlsZS56b29tLmVuYWJsZSggdHJ1ZSApOwoJCQl9CgkJCWlmICggby51cGRhdGVQYWdlUGFkZGluZyApIHsKCQkJCXRoaXMuX29mZiggdGhpcy53aW5kb3csICJ0aHJvdHRsZWRyZXNpemUiICk7CgkJCX0KCgkJCWlmICggby50cmFja1BlcnNpc3RlbnRUb29sYmFycyApIHsKCQkJCXRoaXNGb290ZXIgPSAkKCAiLnVpLWZvb3Rlci1maXhlZDpqcW1EYXRhKGlkKSIsIHRoaXMucGFnZSApOwoJCQkJdGhpc0hlYWRlciA9ICQoICIudWktaGVhZGVyLWZpeGVkOmpxbURhdGEoaWQpIiwgdGhpcy5wYWdlICk7CgkJCQluZXh0Rm9vdGVyID0gdGhpc0Zvb3Rlci5sZW5ndGggJiYgdWkubmV4dFBhZ2UgJiYgJCggIi51aS1mb290ZXItZml4ZWQ6anFtRGF0YShpZD0nIiArIHRoaXNGb290ZXIuanFtRGF0YSggImlkIiApICsgIicpIiwgdWkubmV4dFBhZ2UgKSB8fCAkKCk7CgkJCQluZXh0SGVhZGVyID0gdGhpc0hlYWRlci5sZW5ndGggJiYgdWkubmV4dFBhZ2UgJiYgJCggIi51aS1oZWFkZXItZml4ZWQ6anFtRGF0YShpZD0nIiArIHRoaXNIZWFkZXIuanFtRGF0YSggImlkIiApICsgIicpIiwgdWkubmV4dFBhZ2UgKSB8fCAkKCk7CgoJCQkJaWYgKCBuZXh0Rm9vdGVyLmxlbmd0aCB8fCBuZXh0SGVhZGVyLmxlbmd0aCApIHsKCgkJCQkJbmV4dEZvb3Rlci5hZGQoIG5leHRIZWFkZXIgKS5hcHBlbmRUbyggJC5tb2JpbGUucGFnZUNvbnRhaW5lciApOwoKCQkJCQl1aS5uZXh0UGFnZS5vbmUoICJwYWdlc2hvdyIsIGZ1bmN0aW9uKCkgewoJCQkJCQluZXh0SGVhZGVyLnByZXBlbmRUbyggdGhpcyApOwoJCQkJCQluZXh0Rm9vdGVyLmFwcGVuZFRvKCB0aGlzICk7CgkJCQkJfSk7CgkJCQl9CgkJCX0KCQl9LAoKCQlfdmlzaWJsZTogdHJ1ZSwKCgkJLy8gVGhpcyB3aWxsIHNldCB0aGUgY29udGVudCBlbGVtZW50J3MgdG9wIG9yIGJvdHRvbSBwYWRkaW5nIGVxdWFsIHRvIHRoZSB0b29sYmFyJ3MgaGVpZ2h0CgkJdXBkYXRlUGFnZVBhZGRpbmc6IGZ1bmN0aW9uKCB0YlBhZ2UgKSB7CgkJCXZhciAkZWwgPSB0aGlzLmVsZW1lbnQsCgkJCQloZWFkZXIgPSAoIHRoaXMucm9sZSA9PT0iaGVhZGVyIiApLAoJCQkJcG9zID0gcGFyc2VGbG9hdCggJGVsLmNzcyggaGVhZGVyID8gInRvcCIgOiAiYm90dG9tIiApICk7CgoJCQkvLyBUaGlzIGJlaGF2aW9yIG9ubHkgYXBwbGllcyB0byAiZml4ZWQiLCBub3QgImZ1bGxzY3JlZW4iCgkJCWlmICggdGhpcy5vcHRpb25zLmZ1bGxzY3JlZW4gKSB7IHJldHVybjsgfQoJCQkvLyB0YlBhZ2UgYXJndW1lbnQgY2FuIGJlIGEgUGFnZSBvYmplY3Qgb3IgYW4gZXZlbnQsIGlmIGNvbWluZyBmcm9tIHRocm90dGxlZCByZXNpemUuCgkJCXRiUGFnZSA9ICggdGJQYWdlICYmIHRiUGFnZS50eXBlID09PSB1bmRlZmluZWQgJiYgdGJQYWdlICkgfHwgdGhpcy5wYWdlIHx8ICRlbC5jbG9zZXN0KCAiLnVpLXBhZ2UiICk7CgkJCXRiUGFnZSA9ICggISF0aGlzLnBhZ2UgKT8gdGhpcy5wYWdlOiAiLnVpLXBhZ2UtYWN0aXZlIjsKCQkJJCggdGJQYWdlICkuY3NzKCAicGFkZGluZy0iICsgKCBoZWFkZXIgPyAidG9wIiA6ICJib3R0b20iICksICRlbC5vdXRlckhlaWdodCgpICsgcG9zICk7CgkJfSwKCgkJX3VzZVRyYW5zaXRpb246IGZ1bmN0aW9uKCBub3RyYW5zaXRpb24gKSB7CgkJCXZhciAkd2luID0gdGhpcy53aW5kb3csCgkJCQkkZWwgPSB0aGlzLmVsZW1lbnQsCgkJCQlzY3JvbGwgPSAkd2luLnNjcm9sbFRvcCgpLAoJCQkJZWxIZWlnaHQgPSAkZWwuaGVpZ2h0KCksCgkJCQlwSGVpZ2h0ID0gKCAhIXRoaXMucGFnZSApPyAkZWwuY2xvc2VzdCggIi51aS1wYWdlIiApLmhlaWdodCgpOiQoIi51aS1wYWdlLWFjdGl2ZSIpLmhlaWdodCgpLAoJCQkJdmlld3BvcnRIZWlnaHQgPSAkLm1vYmlsZS5nZXRTY3JlZW5IZWlnaHQoKTsKCgkJCXJldHVybiAhbm90cmFuc2l0aW9uICYmCgkJCQkoIHRoaXMub3B0aW9ucy50cmFuc2l0aW9uICYmIHRoaXMub3B0aW9ucy50cmFuc2l0aW9uICE9PSAibm9uZSIgJiYKCQkJCSgKCQkJCQkoIHRoaXMucm9sZSA9PT0gImhlYWRlciIgJiYgIXRoaXMub3B0aW9ucy5mdWxsc2NyZWVuICYmIHNjcm9sbCA+IGVsSGVpZ2h0ICkgfHwKCQkJCQkoIHRoaXMucm9sZSA9PT0gImZvb3RlciIgJiYgIXRoaXMub3B0aW9ucy5mdWxsc2NyZWVuICYmIHNjcm9sbCArIHZpZXdwb3J0SGVpZ2h0IDwgcEhlaWdodCAtIGVsSGVpZ2h0ICkKCQkJCSkgfHwgdGhpcy5vcHRpb25zLmZ1bGxzY3JlZW4KCQkJCSk7CgkJfSwKCgkJc2hvdzogZnVuY3Rpb24oIG5vdHJhbnNpdGlvbiApIHsKCQkJdmFyIGhpZGVDbGFzcyA9ICJ1aS1maXhlZC1oaWRkZW4iLAoJCQkJJGVsID0gdGhpcy5lbGVtZW50OwoKCQkJaWYgKCB0aGlzLl91c2VUcmFuc2l0aW9uKCBub3RyYW5zaXRpb24gKSApIHsKCQkJCSRlbAoJCQkJCS5yZW1vdmVDbGFzcyggIm91dCAiICsgaGlkZUNsYXNzICkKCQkJCQkuYWRkQ2xhc3MoICJpbiIgKQoJCQkJCS5hbmltYXRpb25Db21wbGV0ZShmdW5jdGlvbiAoKSB7CgkJCQkJCSRlbC5yZW1vdmVDbGFzcyggImluIiApOwoJCQkJCX0pOwoJCQl9CgkJCWVsc2UgewoJCQkJJGVsLnJlbW92ZUNsYXNzKCBoaWRlQ2xhc3MgKTsKCQkJfQoJCQl0aGlzLl92aXNpYmxlID0gdHJ1ZTsKCQl9LAoKCQloaWRlOiBmdW5jdGlvbiggbm90cmFuc2l0aW9uICkgewoJCQl2YXIgaGlkZUNsYXNzID0gInVpLWZpeGVkLWhpZGRlbiIsCgkJCQkkZWwgPSB0aGlzLmVsZW1lbnQsCgkJCQkvLyBpZiBpdCdzIGEgc2xpZGUgdHJhbnNpdGlvbiwgb3VyIG5ldyB0cmFuc2l0aW9ucyBuZWVkIHRoZSByZXZlcnNlIGNsYXNzIGFzIHdlbGwgdG8gc2xpZGUgb3V0d2FyZAoJCQkJb3V0Y2xhc3MgPSAib3V0IiArICggdGhpcy5vcHRpb25zLnRyYW5zaXRpb24gPT09ICJzbGlkZSIgPyAiIHJldmVyc2UiIDogIiIgKTsKCgkJCWlmICggdGhpcy5fdXNlVHJhbnNpdGlvbiggbm90cmFuc2l0aW9uICkgKSB7CgkJCQkkZWwKCQkJCQkuYWRkQ2xhc3MoIG91dGNsYXNzICkKCQkJCQkucmVtb3ZlQ2xhc3MoICJpbiIgKQoJCQkJCS5hbmltYXRpb25Db21wbGV0ZShmdW5jdGlvbigpIHsKCQkJCQkJJGVsLmFkZENsYXNzKCBoaWRlQ2xhc3MgKS5yZW1vdmVDbGFzcyggb3V0Y2xhc3MgKTsKCQkJCQl9KTsKCQkJfQoJCQllbHNlIHsKCQkJCSRlbC5hZGRDbGFzcyggaGlkZUNsYXNzICkucmVtb3ZlQ2xhc3MoIG91dGNsYXNzICk7CgkJCX0KCQkJdGhpcy5fdmlzaWJsZSA9IGZhbHNlOwoJCX0sCgoJCXRvZ2dsZTogZnVuY3Rpb24oKSB7CgkJCXRoaXNbIHRoaXMuX3Zpc2libGUgPyAiaGlkZSIgOiAic2hvdyIgXSgpOwoJCX0sCgoJCV9iaW5kVG9nZ2xlSGFuZGxlcnM6IGZ1bmN0aW9uKCkgewoJCQl2YXIgc2VsZiA9IHRoaXMsCgkJCQlvID0gc2VsZi5vcHRpb25zLAoJCQkJZGVsYXlTaG93LCBkZWxheUhpZGUsCgkJCQlpc1Zpc2libGUgPSB0cnVlLAoJCQkJcGFnZSA9ICggISF0aGlzLnBhZ2UgKT8gdGhpcy5wYWdlOiAkKCIudWktcGFnZSIpOwoKCQkJLy8gdGFwIHRvZ2dsZQoJCQlwYWdlCgkJCQkuYmluZCggInZjbGljayIsIGZ1bmN0aW9uKCBlICkgewoJCQkJCWlmICggby50YXBUb2dnbGUgJiYgISQoIGUudGFyZ2V0ICkuY2xvc2VzdCggby50YXBUb2dnbGVCbGFja2xpc3QgKS5sZW5ndGggKSB7CgkJCQkJCXNlbGYudG9nZ2xlKCk7CgkJCQkJfQoJCQkJfSkKCQkJCS5iaW5kKCAiZm9jdXNpbiBmb2N1c291dCIsIGZ1bmN0aW9uKCBlICkgewoJCQkJCS8vdGhpcyBoaWRlcyB0aGUgdG9vbGJhcnMgb24gYSBrZXlib2FyZCBwb3AgdG8gZ2l2ZSBtb3JlIHNjcmVlbiByb29tIGFuZCBwcmV2ZW50IGlvcyBidWcgd2hpY2gKCQkJCQkvL3Bvc2l0aW9ucyBmaXhlZCB0b29sYmFycyBpbiB0aGUgbWlkZGxlIG9mIHRoZSBzY3JlZW4gb24gcG9wIGlmIHRoZSBpbnB1dCBpcyBuZWFyIHRoZSB0b3Agb3IKCQkJCQkvL2JvdHRvbSBvZiB0aGUgc2NyZWVuIGFkZHJlc3NlcyBpc3N1ZXMgIzQ0MTAgRm9vdGVyIG5hdmJhciBtb3ZlcyB1cCB3aGVuIGNsaWNraW5nIG9uIGEgdGV4dGJveCBpbiBhbiBBbmRyb2lkIGVudmlyb25tZW50CgkJCQkJLy9hbmQgaXNzdWUgIzQxMTMgSGVhZGVyIGFuZCBmb290ZXIgY2hhbmdlIHRoZWlyIHBvc2l0aW9uIGFmdGVyIGtleWJvYXJkIHBvcHVwIC0gaU9TCgkJCQkJLy9hbmQgaXNzdWUgIzQ0MTAgRm9vdGVyIG5hdmJhciBtb3ZlcyB1cCB3aGVuIGNsaWNraW5nIG9uIGEgdGV4dGJveCBpbiBhbiBBbmRyb2lkIGVudmlyb25tZW50CgkJCQkJaWYgKCBzY3JlZW4ud2lkdGggPCAxMDI1ICYmICQoIGUudGFyZ2V0ICkuaXMoIG8uaGlkZUR1cmluZ0ZvY3VzICkgJiYgISQoIGUudGFyZ2V0ICkuY2xvc2VzdCggIi51aS1oZWFkZXItZml4ZWQsIC51aS1mb290ZXItZml4ZWQiICkubGVuZ3RoICkgewoJCQkJCQkvL0ZpeCBmb3IgaXNzdWUgIzQ3MjQgTW92aW5nIHRocm91Z2ggZm9ybSBpbiBNb2JpbGUgU2FmYXJpIHdpdGggIk5leHQiIGFuZCAiUHJldmlvdXMiIHN5c3RlbQoJCQkJCQkvL2NvbnRyb2xzIGNhdXNlcyBmaXhlZCBwb3NpdGlvbiwgdGFwLXRvZ2dsZSBmYWxzZSBIZWFkZXIgdG8gcmV2ZWFsIGl0c2VsZgoJCQkJCQkvLyBpc1Zpc2libGUgaW5zdGVhZCBvZiBzZWxmLl92aXNpYmxlIGJlY2F1c2UgdGhlIGZvY3VzaW4gYW5kIGZvY3Vzb3V0IGV2ZW50cyBmaXJlIHR3aWNlIGF0IHRoZSBzYW1lIHRpbWUKCQkJCQkJLy8gQWxzbyB1c2UgYSBkZWxheSBmb3IgaGlkaW5nIHRoZSB0b29sYmFycyBiZWNhdXNlIG9uIEFuZHJvaWQgbmF0aXZlIGJyb3dzZXIgZm9jdXNpbiBpcyBkaXJlY2x0eSBmb2xsb3dlZAoJCQkJCQkvLyBieSBhIGZvY3Vzb3V0IHdoZW4gYSBuYXRpdmUgc2VsZWN0cyBvcGVucyBhbmQgdGhlIG90aGVyIHdheSBhcm91bmQgd2hlbiBpdCBjbG9zZXMuCgkJCQkJCWlmICggZS50eXBlID09PSAiZm9jdXNvdXQiICYmICFpc1Zpc2libGUgKSB7CgkJCQkJCQlpc1Zpc2libGUgPSB0cnVlOwoJCQkJCQkJLy93YWl0IGZvciB0aGUgc3RhY2sgdG8gdW53aW5kIGFuZCBzZWUgaWYgd2UgaGF2ZSBqdW1wZWQgdG8gYW5vdGhlciBpbnB1dAoJCQkJCQkJY2xlYXJUaW1lb3V0KCBkZWxheUhpZGUgKTsKCQkJCQkJCWRlbGF5U2hvdyA9IHNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCQkJCQkJCXNlbGYuc2hvdygpOwoJCQkJCQkJfSwgMCApOwoJCQkJCQl9IGVsc2UgaWYgKCBlLnR5cGUgPT09ICJmb2N1c2luIiAmJiAhIWlzVmlzaWJsZSApIHsKCQkJCQkJCS8vaWYgd2UgaGF2ZSBqdW1wZWQgdG8gYW5vdGhlciBpbnB1dCBjbGVhciB0aGUgdGltZSBvdXQgdG8gY2FuY2VsIHRoZSBzaG93LgoJCQkJCQkJY2xlYXJUaW1lb3V0KCBkZWxheVNob3cgKTsKCQkJCQkJCWlzVmlzaWJsZSA9IGZhbHNlOwoJCQkJCQkJZGVsYXlIaWRlID0gc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQkJCQkJc2VsZi5oaWRlKCk7CgkJCQkJCQl9LCAwICk7CgkJCQkJCX0KCQkJCQl9CgkJCQl9KTsKCQl9LAoKCQlfZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJCXZhciAkZWwgPSB0aGlzLmVsZW1lbnQsCgkJCQloZWFkZXIgPSAkZWwuaGFzQ2xhc3MoICJ1aS1oZWFkZXIiICk7CgoJCQkkZWwuY2xvc2VzdCggIi51aS1wYWdlIiApLmNzcyggInBhZGRpbmctIiArICggaGVhZGVyID8gInRvcCIgOiAiYm90dG9tIiApLCAiIiApOwoJCQkkZWwucmVtb3ZlQ2xhc3MoICJ1aS1oZWFkZXItZml4ZWQgdWktZm9vdGVyLWZpeGVkIHVpLWhlYWRlci1mdWxsc2NyZWVuIHVpLWZvb3Rlci1mdWxsc2NyZWVuIGluIG91dCBmYWRlIHNsaWRlZG93biBzbGlkZXVwIHVpLWZpeGVkLWhpZGRlbiIgKTsKCQkJJGVsLmNsb3Nlc3QoICIudWktcGFnZSIgKS5yZW1vdmVDbGFzcyggInVpLXBhZ2UtaGVhZGVyLWZpeGVkIHVpLXBhZ2UtZm9vdGVyLWZpeGVkIHVpLXBhZ2UtaGVhZGVyLWZ1bGxzY3JlZW4gdWktcGFnZS1mb290ZXItZnVsbHNjcmVlbiIgKTsKCQl9CgoJfSk7Cn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoJJC53aWRnZXQoICJtb2JpbGUudG9vbGJhciIsICQubW9iaWxlLnRvb2xiYXIsIHsKCgkJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJCXRoaXMuX3N1cGVyKCk7CgkJfSwKCgkJX21ha2VGaXhlZDogZnVuY3Rpb24oKSB7CgkJCXRoaXMuX3N1cGVyKCk7CgkJCXRoaXMuX3dvcmthcm91bmRzKCk7CgkJfSwKCgkJLy9jaGVjayB0aGUgYnJvd3NlciBhbmQgdmVyc2lvbiBhbmQgcnVuIG5lZWRlZCB3b3JrYXJvdW5kcwoJCV93b3JrYXJvdW5kczogZnVuY3Rpb24oKSB7CgkJCXZhciB1YSA9IG5hdmlnYXRvci51c2VyQWdlbnQsCgkJCXBsYXRmb3JtID0gbmF2aWdhdG9yLnBsYXRmb3JtLAoJCQkvLyBSZW5kZXJpbmcgZW5naW5lIGlzIFdlYmtpdCwgYW5kIGNhcHR1cmUgbWFqb3IgdmVyc2lvbgoJCQl3a21hdGNoID0gdWEubWF0Y2goIC9BcHBsZVdlYktpdFwvKFswLTldKykvICksCgkJCXdrdmVyc2lvbiA9ICEhd2ttYXRjaCAmJiB3a21hdGNoWyAxIF0sCgkJCW9zID0gbnVsbCwKCQkJc2VsZiA9IHRoaXM7CgkJCS8vc2V0IHRoZSBvcyB3ZSBhcmUgd29ya2luZyBpbiBpZiBpdCBkb3NlbnQgbWF0Y2ggb25lIHdpdGggd29ya2Fyb3VuZHMgcmV0dXJuCgkJCWlmICggcGxhdGZvcm0uaW5kZXhPZiggImlQaG9uZSIgKSA+IC0xIHx8IHBsYXRmb3JtLmluZGV4T2YoICJpUGFkIiApID4gLTEgIHx8IHBsYXRmb3JtLmluZGV4T2YoICJpUG9kIiApID4gLTEgKSB7CgkJCQlvcyA9ICJpb3MiOwoJCQl9IGVsc2UgaWYgKCB1YS5pbmRleE9mKCAiQW5kcm9pZCIgKSA+IC0xICkgewoJCQkJb3MgPSAiYW5kcm9pZCI7CgkJCX0gZWxzZSB7CgkJCQlyZXR1cm47CgkJCX0KCQkJLy9jaGVjayBvcyB2ZXJzaW9uIGlmIGl0IGRvc2VudCBtYXRjaCBvbmUgd2l0aCB3b3JrYXJvdW5kcyByZXR1cm4KCQkJaWYgKCBvcyA9PT0gImlvcyIgKSB7CgkJCQkvL2lPUyAgd29ya2Fyb3VuZHMKCQkJCXNlbGYuX2JpbmRTY3JvbGxXb3JrYXJvdW5kKCk7CgkJCX0gZWxzZSBpZiAoIG9zID09PSAiYW5kcm9pZCIgJiYgd2t2ZXJzaW9uICYmIHdrdmVyc2lvbiA8IDUzNCApIHsKCQkJCS8vQW5kcm9pZCAyLjMgcnVuIGFsbCBBbmRyb2lkIDIuMyB3b3JrYXJvdW5kCgkJCQlzZWxmLl9iaW5kU2Nyb2xsV29ya2Fyb3VuZCgpOwoJCQkJc2VsZi5fYmluZExpc3RUaHVtYldvcmthcm91bmQoKTsKCQkJfSBlbHNlIHsKCQkJCXJldHVybjsKCQkJfQoJCX0sCgoJCS8vVXRpbGl0eSBjbGFzcyBmb3IgY2hlY2tpbmcgaGVhZGVyIGFuZCBmb290ZXIgcG9zaXRpb25zIHJlbGF0aXZlIHRvIHZpZXdwb3J0CgkJX3ZpZXdwb3J0T2Zmc2V0OiBmdW5jdGlvbigpIHsKCQkJdmFyICRlbCA9IHRoaXMuZWxlbWVudCwKCQkJCWhlYWRlciA9ICRlbC5oYXNDbGFzcyggInVpLWhlYWRlciIgKSwKCQkJCW9mZnNldCA9IE1hdGguYWJzKCAkZWwub2Zmc2V0KCkudG9wIC0gdGhpcy53aW5kb3cuc2Nyb2xsVG9wKCkgKTsKCQkJaWYgKCAhaGVhZGVyICkgewoJCQkJb2Zmc2V0ID0gTWF0aC5yb3VuZCggb2Zmc2V0IC0gdGhpcy53aW5kb3cuaGVpZ2h0KCkgKyAkZWwub3V0ZXJIZWlnaHQoKSApIC0gNjA7CgkJCX0KCQkJcmV0dXJuIG9mZnNldDsKCQl9LAoKCQkvL2JpbmQgZXZlbnRzIGZvciBfdHJpZ2dlclJlZHJhdygpIGZ1bmN0aW9uCgkJX2JpbmRTY3JvbGxXb3JrYXJvdW5kOiBmdW5jdGlvbigpIHsKCQkJdmFyIHNlbGYgPSB0aGlzOwoJCQkvL2JpbmQgdG8gc2Nyb2xsc3RvcCBhbmQgY2hlY2sgaWYgdGhlIHRvb2xiYXJzIGFyZSBjb3JyZWN0bHkgcG9zaXRpb25lZAoJCQl0aGlzLl9vbiggdGhpcy53aW5kb3csIHsgc2Nyb2xsc3RvcDogZnVuY3Rpb24oKSB7CgkJCQl2YXIgdmlld3BvcnRPZmZzZXQgPSBzZWxmLl92aWV3cG9ydE9mZnNldCgpOwoJCQkJLy9jaGVjayBpZiB0aGUgaGVhZGVyIGlzIHZpc2libGUgYW5kIGlmIGl0cyBpbiB0aGUgcmlnaHQgcGxhY2UKCQkJCWlmICggdmlld3BvcnRPZmZzZXQgPiAyICYmIHNlbGYuX3Zpc2libGUgKSB7CgkJCQkJc2VsZi5fdHJpZ2dlclJlZHJhdygpOwoJCQkJfQoJCQl9fSk7CgkJfSwKCgkJLy90aGlzIGFkZHJlc3NlcyBpc3N1ZSAjNDI1MCBQZXJzaXN0ZW50IGZvb3RlciBpbnN0YWJpbGl0eSBpbiB2MS4xIHdpdGggbG9uZyBzZWxlY3QgbGlzdHMgaW4gQW5kcm9pZCAyLjMuMwoJCS8vYW5kIGlzc3VlICMzNzQ4IEFuZHJvaWQgMi54OiBQYWdlIHRyYW5zaXRpb25zIGJyb2tlbiB3aGVuIGZpeGVkIHRvb2xiYXJzIHVzZWQKCQkvL3RoZSBhYnNvbHV0ZWx5IHBvc2l0aW9uZWQgdGh1bWJuYWlsIGluIGEgbGlzdCB2aWV3IGNhdXNlcyBwcm9ibGVtcyB3aXRoIGZpeGVkIHBvc2l0aW9uIGJ1dHRvbnMgYWJvdmUgaW4gYSBuYXYgYmFyCgkJLy9zZXR0aW5nIHRoZSBsaSdzIHRvIC13ZWJraXQtdHJhbnNmb3JtOnRyYW5zbGF0ZTNkKDAsMCwwKTsgc29sdmVzIHRoaXMgcHJvYmxlbSB0byBhdm9pZGUgcG90ZW50aWFsIGlzc3VlcyBpbiBvdGhlcgoJCS8vcGxhdGZvcm1zIHdlIHNjb3BlIHRoaXMgd2l0aCB0aGUgY2xhc3MgdWktYW5kcm9pZC0yeC1maXgKCQlfYmluZExpc3RUaHVtYldvcmthcm91bmQ6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLmVsZW1lbnQuY2xvc2VzdCggIi51aS1wYWdlIiApLmFkZENsYXNzKCAidWktYW5kcm9pZC0yeC1maXhlZCIgKTsKCQl9LAoJCS8vdGhpcyBhZGRyZXNzZXMgaXNzdWVzICM0MzM3IEZpeGVkIGhlYWRlciBwcm9ibGVtIGFmdGVyIHNjcm9sbGluZyBjb250ZW50IG9uIGlPUyBhbmQgQW5kcm9pZAoJCS8vYW5kIGRldmljZSBidWdzIHByb2plY3QgaXNzdWUgIzEgRm9ybSBlbGVtZW50cyBjYW4gbG9zZSBjbGljayBoaXQgYXJlYSBpbiBwb3NpdGlvbjogZml4ZWQgY29udGFpbmVycy4KCQkvL3RoaXMgYWxzbyBhZGRyZXNzZXMgbm90IG9uIGZpeGVkIHRvb2xiYXJzIHBhZ2UgaW4gZG9jcwoJCS8vYWRkaW5nIDFweCBvZiBwYWRkaW5nIHRvIHRoZSBib3R0b20gdGhlbiByZW1vdmluZyBpdCBjYXVzZXMgYSAicmVkcmF3IgoJCS8vd2hpY2ggcG9zaXRpb25zIHRoZSB0b29sYmFycyBjb3JyZWN0bHkgKHRoZXkgd2lsbCBhbHdheXMgYmUgdmlzdWFsbHkgY29ycmVjdCkKCQlfdHJpZ2dlclJlZHJhdzogZnVuY3Rpb24oKSB7CgkJCXZhciBwYWRkaW5nQm90dG9tID0gcGFyc2VGbG9hdCggJCggIi51aS1wYWdlLWFjdGl2ZSIgKS5jc3MoICJwYWRkaW5nLWJvdHRvbSIgKSApOwoJCQkvL3RyaWdnZXIgcGFnZSByZWRyYXcgdG8gZml4IGluY29ycmVjdGx5IHBvc2l0aW9uZWQgZml4ZWQgZWxlbWVudHMKCQkJJCggIi51aS1wYWdlLWFjdGl2ZSIgKS5jc3MoICJwYWRkaW5nLWJvdHRvbSIsICggcGFkZGluZ0JvdHRvbSArIDEgKSArICJweCIgKTsKCQkJLy9pZiB0aGUgcGFkZGluZyBpcyByZXNldCB3aXRoIG91dCBhIHRpbWVvdXQgdGhlIHJlcG9zaXRpb24gd2lsbCBub3Qgb2NjdXJlLgoJCQkvL3RoaXMgaXMgaW5kZXBlbmRhbnQgb2YgSlFNIHRoZSBicm93c2VyIHNlZW1zIHRvIG5lZWQgdGhlIHRpbWUgdG8gcmVhY3QuCgkJCXNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCQkJJCggIi51aS1wYWdlLWFjdGl2ZSIgKS5jc3MoICJwYWRkaW5nLWJvdHRvbSIsIHBhZGRpbmdCb3R0b20gKyAicHgiICk7CgkJCX0sIDAgKTsKCQl9LAoKCQlkZXN0cm95OiBmdW5jdGlvbigpIHsKCQkJdGhpcy5fc3VwZXIoKTsKCQkJLy9SZW1vdmUgdGhlIGNsYXNzIHdlIGFkZGVkIHRvIHRoZSBwYWdlIHByZXZpb3VzbHkgaW4gYW5kcm9pZCAyLngKCQkJdGhpcy5lbGVtZW50LmNsb3Nlc3QoICIudWktcGFnZS1hY3RpdmUiICkucmVtb3ZlQ2xhc3MoICJ1aS1hbmRyb2lkLTJ4LWZpeCIgKTsKCQl9Cgl9KTsKCn0pKCBqUXVlcnkgKTsKCgooIGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7Cgp2YXIgaWVIYWNrID0gKCAkLm1vYmlsZS5icm93c2VyLm9sZElFICYmICQubW9iaWxlLmJyb3dzZXIub2xkSUUgPD0gOCApLAoJdWlUZW1wbGF0ZSA9ICQoCgkJIjxkaXYgY2xhc3M9J3VpLXBvcHVwLWFycm93LWd1aWRlJz48L2Rpdj4iICsKCQkiPGRpdiBjbGFzcz0ndWktcG9wdXAtYXJyb3ctY29udGFpbmVyIiArICggaWVIYWNrID8gIiBpZSIgOiAiIiApICsgIic+IiArCgkJCSI8ZGl2IGNsYXNzPSd1aS1wb3B1cC1hcnJvdyc+IiArCgkJCQkiPGRpdiBjbGFzcz0ndWktcG9wdXAtYXJyb3ctYmFja2dyb3VuZCc+PC9kaXY+IiArCgkJCSI8L2Rpdj4iICsKCQkiPC9kaXY+IgoJKSwKCS8vIE5lZWRlZCBmb3IgdHJhbnNmb3JtaW5nIGNvb3JkaW5hdGVzIGZyb20gc2NyZWVuIHRvIGFycm93IGJhY2tncm91bmQKCXR4RmFjdG9yID0gTWF0aC5zcXJ0KCAyICkgLyAyOwoKZnVuY3Rpb24gZ2V0QXJyb3coKSB7Cgl2YXIgY2xvbmUgPSB1aVRlbXBsYXRlLmNsb25lKCksCgkJZ2QgPSBjbG9uZS5lcSggMCApLAoJCWN0ID0gY2xvbmUuZXEoIDEgKSwKCQlhciA9IGN0LmNoaWxkcmVuKCksCgkJYmcgPSBhci5jaGlsZHJlbigpOwoKCXJldHVybiB7IGFyRWxzOiBjdC5hZGQoIGdkICksIGdkOiBnZCwgY3Q6IGN0LCBhcjogYXIsIGJnOiBiZyB9Owp9CgokLndpZGdldCggIm1vYmlsZS5wb3B1cCIsICQubW9iaWxlLnBvcHVwLCB7CglvcHRpb25zOiB7CgoJCWFycm93OiAiIgoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl2YXIgYXIsCgkJCXJldCA9IHRoaXMuX3N1cGVyKCk7CgoJCWlmICggdGhpcy5vcHRpb25zLmFycm93ICkgewoJCQl0aGlzLl91aS5hcnJvdyA9IGFyID0gdGhpcy5fYWRkQXJyb3coKTsKCQl9CgoJCXJldHVybiByZXQ7Cgl9LAoKCV9hZGRBcnJvdzogZnVuY3Rpb24oKSB7CgkJdmFyIHRoZW1lLAoJCQlvcHRzID0gdGhpcy5vcHRpb25zLAoJCQlhciA9IGdldEFycm93KCk7CgoJCXRoZW1lID0gdGhpcy5fdGhlbWVDbGFzc0Zyb21PcHRpb24oICJ1aS1ib2R5LSIsIG9wdHMudGhlbWUgKTsKCQlhci5hci5hZGRDbGFzcyggdGhlbWUgKyAoIG9wdHMuc2hhZG93ID8gIiB1aS1vdmVybGF5LXNoYWRvdyIgOiAiIiApICk7CgkJYXIuYmcuYWRkQ2xhc3MoIHRoZW1lICk7CgkJYXIuYXJFbHMuaGlkZSgpLmFwcGVuZFRvKCB0aGlzLmVsZW1lbnQgKTsKCgkJcmV0dXJuIGFyOwoJfSwKCglfdW5lbmhhbmNlOiBmdW5jdGlvbigpIHsKCQl2YXIgYXIgPSB0aGlzLl91aS5hcnJvdzsKCgkJaWYgKCBhciApIHsKCQkJYXIuYXJFbHMucmVtb3ZlKCk7CgkJfQoKCQlyZXR1cm4gdGhpcy5fc3VwZXIoKTsKCX0sCgoJLy8gUHJldGVuZCB0byBzaG93IGFuIGFycm93IGRlc2NyaWJlZCBieSBAcCBhbmQgQGRpciBhbmQgY2FsY3VsYXRlIHRoZQoJLy8gZGlzdGFuY2UgZnJvbSB0aGUgZGVzaXJlZCBwb2ludC4gSWYgYSBiZXN0LWRpc3RhbmNlIGlzIHBhc3NlZCBpbiwgcmV0dXJuCgkvLyB0aGUgbWluaW11bSBvZiB0aGUgb25lIHBhc3NlZCBpbiBhbmQgdGhlIG9uZSBjYWxjdWxhdGVkLgoJX3RyeUFuQXJyb3c6IGZ1bmN0aW9uKCBwLCBkaXIsIGRlc2lyZWQsIHMsIGJlc3QgKSB7CgkJdmFyIHJlc3VsdCwgciwgZGlmZiwgZGVzaXJlZEZvckFycm93ID0ge30sIHRpcCA9IHt9OwoKCQkvLyBJZiB0aGUgYXJyb3cgaGFzIG5vIHdpZ2dsZSByb29tIGFsb25nIHRoZSBlZGdlIG9mIHRoZSBwb3B1cCwgaXQgY2Fubm90CgkJLy8gYmUgZGlzcGxheWVkIGFsb25nIHRoZSByZXF1ZXN0ZWQgZWRnZSB3aXRob3V0IGl0IHN0aWNraW5nIG91dC4KCQlpZiAoIHMuYXJGdWxsWyBwLmRpbUtleSBdID4gcy5ndWlkZURpbXNbIHAuZGltS2V5IF0gKSB7CgkJCXJldHVybiBiZXN0OwoJCX0KCgkJZGVzaXJlZEZvckFycm93WyBwLmZzdCBdID0gZGVzaXJlZFsgcC5mc3QgXSArCgkJCSggcy5hckhhbGZbIHAub0RpbUtleSBdICsgcy5tZW51SGFsZlsgcC5vRGltS2V5IF0gKSAqIHAub2Zmc2V0RmFjdG9yIC0KCQkJcy5jb250ZW50Qm94WyBwLmZzdCBdICsgKCBzLmNsYW1wSW5mby5tZW51U2l6ZVsgcC5vRGltS2V5IF0gLSBzLmNvbnRlbnRCb3hbIHAub0RpbUtleSBdICkgKiBwLmFycm93T2Zmc2V0RmFjdG9yOwoJCWRlc2lyZWRGb3JBcnJvd1sgcC5zbmQgXSA9IGRlc2lyZWRbIHAuc25kIF07CgoJCXJlc3VsdCA9IHMucmVzdWx0IHx8IHRoaXMuX2NhbGN1bGF0ZUZpbmFsTG9jYXRpb24oIGRlc2lyZWRGb3JBcnJvdywgcy5jbGFtcEluZm8gKTsKCQlyID0geyB4OiByZXN1bHQubGVmdCwgeTogcmVzdWx0LnRvcCB9OwoKCQl0aXBbIHAuZnN0IF0gPSByWyBwLmZzdCBdICsgcy5jb250ZW50Qm94WyBwLmZzdCBdICsgcC50aXBPZmZzZXQ7CgkJdGlwWyBwLnNuZCBdID0gTWF0aC5tYXgoIHJlc3VsdFsgcC5wcm9wIF0gKyBzLmd1aWRlT2Zmc2V0WyBwLnByb3AgXSArIHMuYXJIYWxmWyBwLmRpbUtleSBdLAoJCQlNYXRoLm1pbiggcmVzdWx0WyBwLnByb3AgXSArIHMuZ3VpZGVPZmZzZXRbIHAucHJvcCBdICsgcy5ndWlkZURpbXNbIHAuZGltS2V5IF0gLSBzLmFySGFsZlsgcC5kaW1LZXkgXSwKCQkJCWRlc2lyZWRbIHAuc25kIF0gKSApOwoKCQlkaWZmID0gTWF0aC5hYnMoIGRlc2lyZWQueCAtIHRpcC54ICkgKyBNYXRoLmFicyggZGVzaXJlZC55IC0gdGlwLnkgKTsKCQlpZiAoICFiZXN0IHx8IGRpZmYgPCBiZXN0LmRpZmYgKSB7CgkJCS8vIENvbnZlcnQgdGlwIG9mZnNldCB0byBjb29yZGluYXRlcyBpbnNpZGUgdGhlIHBvcHVwCgkJCXRpcFsgcC5zbmQgXSAtPSBzLmFySGFsZlsgcC5kaW1LZXkgXSArIHJlc3VsdFsgcC5wcm9wIF0gKyBzLmNvbnRlbnRCb3hbIHAuc25kIF07CgkJCWJlc3QgPSB7IGRpcjogZGlyLCBkaWZmOiBkaWZmLCByZXN1bHQ6IHJlc3VsdCwgcG9zUHJvcDogcC5wcm9wLCBwb3NWYWw6IHRpcFsgcC5zbmQgXSB9OwoJCX0KCgkJcmV0dXJuIGJlc3Q7Cgl9LAoKCV9nZXRQbGFjZW1lbnRTdGF0ZTogZnVuY3Rpb24oIGNsYW1wICkgewoJCXZhciBvZmZzZXQsIGdkT2Zmc2V0LAoJCQlhciA9IHRoaXMuX3VpLmFycm93LAoJCQlzdGF0ZSA9IHsKCQkJCWNsYW1wSW5mbzogdGhpcy5fY2xhbXBQb3B1cFdpZHRoKCAhY2xhbXAgKSwKCQkJCWFyRnVsbDogeyBjeDogYXIuY3Qud2lkdGgoKSwgY3k6IGFyLmN0LmhlaWdodCgpIH0sCgkJCQlndWlkZURpbXM6IHsgY3g6IGFyLmdkLndpZHRoKCksIGN5OiBhci5nZC5oZWlnaHQoKSB9LAoJCQkJZ3VpZGVPZmZzZXQ6IGFyLmdkLm9mZnNldCgpCgkJCX07CgoJCW9mZnNldCA9IHRoaXMuZWxlbWVudC5vZmZzZXQoKTsKCgkJYXIuZ2QuY3NzKCB7IGxlZnQ6IDAsIHRvcDogMCwgcmlnaHQ6IDAsIGJvdHRvbTogMCB9ICk7CgkJZ2RPZmZzZXQgPSBhci5nZC5vZmZzZXQoKTsKCQlzdGF0ZS5jb250ZW50Qm94ID0gewoJCQl4OiBnZE9mZnNldC5sZWZ0IC0gb2Zmc2V0LmxlZnQsCgkJCXk6IGdkT2Zmc2V0LnRvcCAtIG9mZnNldC50b3AsCgkJCWN4OiBhci5nZC53aWR0aCgpLAoJCQljeTogYXIuZ2QuaGVpZ2h0KCkKCQl9OwoJCWFyLmdkLnJlbW92ZUF0dHIoICJzdHlsZSIgKTsKCgkJLy8gVGhlIGFycm93IGJveCBtb3ZlcyBiZXR3ZWVuIGd1aWRlT2Zmc2V0IGFuZCBndWlkZU9mZnNldCArIGd1aWRlRGltcyAtIGFyRnVsbAoJCXN0YXRlLmd1aWRlT2Zmc2V0ID0geyBsZWZ0OiBzdGF0ZS5ndWlkZU9mZnNldC5sZWZ0IC0gb2Zmc2V0LmxlZnQsIHRvcDogc3RhdGUuZ3VpZGVPZmZzZXQudG9wIC0gb2Zmc2V0LnRvcCB9OwoJCXN0YXRlLmFySGFsZiA9IHsgY3g6IHN0YXRlLmFyRnVsbC5jeCAvIDIsIGN5OiBzdGF0ZS5hckZ1bGwuY3kgLyAyIH07CgkJc3RhdGUubWVudUhhbGYgPSB7IGN4OiBzdGF0ZS5jbGFtcEluZm8ubWVudVNpemUuY3ggLyAyLCBjeTogc3RhdGUuY2xhbXBJbmZvLm1lbnVTaXplLmN5IC8gMiB9OwoKCQlyZXR1cm4gc3RhdGU7Cgl9LAoKCV9wbGFjZW1lbnRDb29yZHM6IGZ1bmN0aW9uKCBkZXNpcmVkICkgewoJCXZhciBzdGF0ZSwgYmVzdCwgcGFyYW1zLCBiZ09mZnNldCwgZWxPZmZzZXQsIGRpZmYsIGJnUmVmLAoJCQlvcHRpb25WYWx1ZSA9IHRoaXMub3B0aW9ucy5hcnJvdywKCQkJYXIgPSB0aGlzLl91aS5hcnJvdzsKCgkJaWYgKCAhYXIgKSB7CgkJCXJldHVybiB0aGlzLl9zdXBlciggZGVzaXJlZCApOwoJCX0KCgkJYXIuYXJFbHMuc2hvdygpOwoKCQliZ1JlZiA9IHt9OwoJCXN0YXRlID0gdGhpcy5fZ2V0UGxhY2VtZW50U3RhdGUoIHRydWUgKTsKCQlwYXJhbXMgPSB7CgkJCSJsIjogeyBmc3Q6ICJ4Iiwgc25kOiAieSIsIHByb3A6ICJ0b3AiLCBkaW1LZXk6ICJjeSIsIG9EaW1LZXk6ICJjeCIsIG9mZnNldEZhY3RvcjogMSwgdGlwT2Zmc2V0OiAgLXN0YXRlLmFySGFsZi5jeCwgYXJyb3dPZmZzZXRGYWN0b3I6IDAgfSwKCQkJInIiOiB7IGZzdDogIngiLCBzbmQ6ICJ5IiwgcHJvcDogInRvcCIsIGRpbUtleTogImN5Iiwgb0RpbUtleTogImN4Iiwgb2Zmc2V0RmFjdG9yOiAtMSwgdGlwT2Zmc2V0OiBzdGF0ZS5hckhhbGYuY3ggKyBzdGF0ZS5jb250ZW50Qm94LmN4LCBhcnJvd09mZnNldEZhY3RvcjogMSB9LAoJCQkiYiI6IHsgZnN0OiAieSIsIHNuZDogIngiLCBwcm9wOiAibGVmdCIsIGRpbUtleTogImN4Iiwgb0RpbUtleTogImN5Iiwgb2Zmc2V0RmFjdG9yOiAtMSwgdGlwT2Zmc2V0OiBzdGF0ZS5hckhhbGYuY3kgKyBzdGF0ZS5jb250ZW50Qm94LmN5LCBhcnJvd09mZnNldEZhY3RvcjogMSB9LAoJCQkidCI6IHsgZnN0OiAieSIsIHNuZDogIngiLCBwcm9wOiAibGVmdCIsIGRpbUtleTogImN4Iiwgb0RpbUtleTogImN5Iiwgb2Zmc2V0RmFjdG9yOiAxLCB0aXBPZmZzZXQ6IC1zdGF0ZS5hckhhbGYuY3ksIGFycm93T2Zmc2V0RmFjdG9yOiAwIH0KCQl9OwoKCQkvLyBUcnkgZWFjaCBzaWRlIHNwZWNpZmllZCBpbiB0aGUgb3B0aW9ucyB0byBzZWUgb24gd2hpY2ggb25lIHRoZSBhcnJvdwoJCS8vIHNob3VsZCBiZSBwbGFjZWQgc3VjaCB0aGF0IHRoZSBkaXN0YW5jZSBiZXR3ZWVuIHRoZSB0aXAgb2YgdGhlIGFycm93IGFuZAoJCS8vIHRoZSBkZXNpcmVkIGNvb3JkaW5hdGVzIGlzIHRoZSBzaG9ydGVzdC4KCQkkLmVhY2goICggb3B0aW9uVmFsdWUgPT09IHRydWUgPyAibCx0LHIsYiIgOiBvcHRpb25WYWx1ZSApLnNwbGl0KCAiLCIgKSwKCQkJJC5wcm94eSggZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CgkJCQliZXN0ID0gdGhpcy5fdHJ5QW5BcnJvdyggcGFyYW1zWyB2YWx1ZSBdLCB2YWx1ZSwgZGVzaXJlZCwgc3RhdGUsIGJlc3QgKTsKCQkJfSwgdGhpcyApICk7CgoJCS8vIENvdWxkIG5vdCBwbGFjZSB0aGUgYXJyb3cgYWxvbmcgYW55IG9mIHRoZSBlZGdlcyAtIGJlaGF2ZSBhcyBpZiBzaG93aW5nCgkJLy8gdGhlIGFycm93IHdhcyB0dXJuZWQgb2ZmLgoJCWlmICggIWJlc3QgKSB7CgkJCWFyLmFyRWxzLmhpZGUoKTsKCQkJcmV0dXJuIHRoaXMuX3N1cGVyKCBkZXNpcmVkICk7CgkJfQoKCQkvLyBNb3ZlIHRoZSBhcnJvdyBpbnRvIHBsYWNlCgkJYXIuY3QKCQkJLnJlbW92ZUNsYXNzKCAidWktcG9wdXAtYXJyb3ctbCB1aS1wb3B1cC1hcnJvdy10IHVpLXBvcHVwLWFycm93LXIgdWktcG9wdXAtYXJyb3ctYiIgKQoJCQkuYWRkQ2xhc3MoICJ1aS1wb3B1cC1hcnJvdy0iICsgYmVzdC5kaXIgKQoJCQkucmVtb3ZlQXR0ciggInN0eWxlIiApLmNzcyggYmVzdC5wb3NQcm9wLCBiZXN0LnBvc1ZhbCApCgkJCS5zaG93KCk7CgoJCS8vIERvIG5vdCBtb3ZlL3NpemUgdGhlIGJhY2tncm91bmQgZGl2IG9uIElFLCBiZWNhdXNlIHdlIHVzZSB0aGUgYXJyb3cgZGl2IGZvciBiYWNrZ3JvdW5kIGFzIHdlbGwuCgkJaWYgKCAhaWVIYWNrICkgewoJCQllbE9mZnNldCA9IHRoaXMuZWxlbWVudC5vZmZzZXQoKTsKCQkJYmdSZWZbIHBhcmFtc1sgYmVzdC5kaXIgXS5mc3QgXSA9IGFyLmN0Lm9mZnNldCgpOwoJCQliZ1JlZlsgcGFyYW1zWyBiZXN0LmRpciBdLnNuZCBdID0gewoJCQkJbGVmdDogZWxPZmZzZXQubGVmdCArIHN0YXRlLmNvbnRlbnRCb3gueCwKCQkJCXRvcDogZWxPZmZzZXQudG9wICsgc3RhdGUuY29udGVudEJveC55CgkJCX07CgkJCWJnT2Zmc2V0ID0gYXIuYmcKCQkJCS5yZW1vdmVBdHRyKCAic3R5bGUiICkKCQkJCS5jc3MoICggImN4IiA9PT0gcGFyYW1zWyBiZXN0LmRpciBdLmRpbUtleSA/ICJ3aWR0aCIgOiAiaGVpZ2h0IiApLCBzdGF0ZS5jb250ZW50Qm94WyBwYXJhbXNbIGJlc3QuZGlyIF0uZGltS2V5IF0gKQoJCQkJLm9mZnNldCgpOwoJCQlkaWZmID0geyBkeDogYmdSZWYueC5sZWZ0IC0gYmdPZmZzZXQubGVmdCwgZHk6IGJnUmVmLnkudG9wIC0gYmdPZmZzZXQudG9wIH07CgkJCWFyLmJnLmNzcyggeyBsZWZ0OiB0eEZhY3RvciAqIGRpZmYuZHkgKyB0eEZhY3RvciAqIGRpZmYuZHgsIHRvcDogdHhGYWN0b3IgKiBkaWZmLmR5IC0gdHhGYWN0b3IgKiBkaWZmLmR4IH0gKTsKCQl9CgoJCXJldHVybiBiZXN0LnJlc3VsdDsKCX0sCgoJX3NldE9wdGlvbnM6IGZ1bmN0aW9uKCBvcHRzICkgewoJCXZhciBuZXdUaGVtZSwKCQkJb2xkVGhlbWUgPSB0aGlzLm9wdGlvbnMudGhlbWUsCgkJCWFyID0gdGhpcy5fdWkuYXJyb3csCgkJCXJldCA9IHRoaXMuX3N1cGVyKCBvcHRzICk7CgoJCWlmICggb3B0cy5hcnJvdyAhPT0gdW5kZWZpbmVkICkgewoJCQlpZiAoICFhciAmJiBvcHRzLmFycm93ICkgewoJCQkJdGhpcy5fdWkuYXJyb3cgPSB0aGlzLl9hZGRBcnJvdygpOwoKCQkJCS8vIEltcG9ydGFudCB0byByZXR1cm4gaGVyZSBzbyB3ZSBkb24ndCBzZXQgdGhlIHNhbWUgb3B0aW9ucyBhbGwgb3ZlcgoJCQkJLy8gYWdhaW4gYmVsb3cuCgkJCQlyZXR1cm47CgkJCX0gZWxzZSBpZiAoIGFyICYmICFvcHRzLmFycm93ICkgewoJCQkJYXIuYXJFbHMucmVtb3ZlKCk7CgkJCQl0aGlzLl91aS5hcnJvdyA9IG51bGw7CgkJCX0KCQl9CgoJCS8vIFJlYXNzaWduIHdpdGggcG90ZW50aWFsbHkgbmV3IGFycm93CgkJYXIgPSB0aGlzLl91aS5hcnJvdzsKCgkJaWYgKCBhciApIHsKCQkJaWYgKCBvcHRzLnRoZW1lICE9PSB1bmRlZmluZWQgKSB7CgkJCQlvbGRUaGVtZSA9IHRoaXMuX3RoZW1lQ2xhc3NGcm9tT3B0aW9uKCAidWktYm9keS0iLCBvbGRUaGVtZSApOwoJCQkJbmV3VGhlbWUgPSB0aGlzLl90aGVtZUNsYXNzRnJvbU9wdGlvbiggInVpLWJvZHktIiwgb3B0cy50aGVtZSApOwoJCQkJYXIuYXIucmVtb3ZlQ2xhc3MoIG9sZFRoZW1lICkuYWRkQ2xhc3MoIG5ld1RoZW1lICk7CgkJCQlhci5iZy5yZW1vdmVDbGFzcyggb2xkVGhlbWUgKS5hZGRDbGFzcyggbmV3VGhlbWUgKTsKCQkJfQoKCQkJaWYgKCBvcHRzLnNoYWRvdyAhPT0gdW5kZWZpbmVkICkgewoJCQkJYXIuYXIudG9nZ2xlQ2xhc3MoICJ1aS1vdmVybGF5LXNoYWRvdyIsIG9wdHMuc2hhZG93ICk7CgkJCX0KCQl9CgoJCXJldHVybiByZXQ7Cgl9LAoKCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCQl2YXIgYXIgPSB0aGlzLl91aS5hcnJvdzsKCgkJaWYgKCBhciApIHsKCQkJYXIuYXJFbHMucmVtb3ZlKCk7CgkJfQoKCQlyZXR1cm4gdGhpcy5fc3VwZXIoKTsKCX0KfSk7Cgp9KSggalF1ZXJ5ICk7CgoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS5wYW5lbCIsIHsKCW9wdGlvbnM6IHsKCQljbGFzc2VzOiB7CgkJCXBhbmVsOiAidWktcGFuZWwiLAoJCQlwYW5lbE9wZW46ICJ1aS1wYW5lbC1vcGVuIiwKCQkJcGFuZWxDbG9zZWQ6ICJ1aS1wYW5lbC1jbG9zZWQiLAoJCQlwYW5lbEZpeGVkOiAidWktcGFuZWwtZml4ZWQiLAoJCQlwYW5lbElubmVyOiAidWktcGFuZWwtaW5uZXIiLAoJCQltb2RhbDogInVpLXBhbmVsLWRpc21pc3MiLAoJCQltb2RhbE9wZW46ICJ1aS1wYW5lbC1kaXNtaXNzLW9wZW4iLAoJCQlwYWdlQ29udGFpbmVyOiAidWktcGFuZWwtcGFnZS1jb250YWluZXIiLAoJCQlwYWdlV3JhcHBlcjogInVpLXBhbmVsLXdyYXBwZXIiLAoJCQlwYWdlRml4ZWRUb29sYmFyOiAidWktcGFuZWwtZml4ZWQtdG9vbGJhciIsCgkJCXBhZ2VDb250ZW50UHJlZml4OiAidWktcGFuZWwtcGFnZS1jb250ZW50IiwgLyogVXNlZCBmb3Igd3JhcHBlciBhbmQgZml4ZWQgdG9vbGJhcnMgcG9zaXRpb24sIGRpc3BsYXkgYW5kIG9wZW4gY2xhc3Nlcy4gKi8KCQkJYW5pbWF0ZTogInVpLXBhbmVsLWFuaW1hdGUiCgkJfSwKCQlhbmltYXRlOiB0cnVlLAoJCXRoZW1lOiBudWxsLAoJCXBvc2l0aW9uOiAibGVmdCIsCgkJZGlzbWlzc2libGU6IHRydWUsCgkJZGlzcGxheTogInJldmVhbCIsIC8vYWNjZXB0cyByZXZlYWwsIHB1c2gsIG92ZXJsYXkKCQlzd2lwZUNsb3NlOiB0cnVlLAoJCXBvc2l0aW9uRml4ZWQ6IGZhbHNlCgl9LAoKCV9wYW5lbElEOiBudWxsLAoJX2Nsb3NlTGluazogbnVsbCwKCV9wYXJlbnRQYWdlOiBudWxsLAoJX3BhZ2U6IG51bGwsCglfbW9kYWw6IG51bGwsCglfcGFuZWxJbm5lcjogbnVsbCwKCV93cmFwcGVyOiBudWxsLAoJX2ZpeGVkVG9vbGJhcnM6IG51bGwsCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdmFyIGVsID0gdGhpcy5lbGVtZW50LAoJCQlwYXJlbnRQYWdlID0gZWwuY2xvc2VzdCggIjpqcW1EYXRhKHJvbGU9J3BhZ2UnKSIgKTsKCgkJLy8gZXhwb3NlIHNvbWUgcHJpdmF0ZSBwcm9wcyB0byBvdGhlciBtZXRob2RzCgkJJC5leHRlbmQoIHRoaXMsIHsKCQkJX3BhbmVsSUQ6IGVsLmF0dHIoICJpZCIgKSwKCQkJX2Nsb3NlTGluazogZWwuZmluZCggIjpqcW1EYXRhKHJlbD0nY2xvc2UnKSIgKSwKCQkJX3BhcmVudFBhZ2U6ICggcGFyZW50UGFnZS5sZW5ndGggPiAwICkgPyBwYXJlbnRQYWdlIDogZmFsc2UsCgkJCV9wYWdlOiB0aGlzLl9nZXRQYWdlLAoJCQlfcGFuZWxJbm5lcjogdGhpcy5fZ2V0UGFuZWxJbm5lcigpLAoJCQlfd3JhcHBlcjogdGhpcy5fZ2V0V3JhcHBlciwKCQkJX2ZpeGVkVG9vbGJhcnM6IHRoaXMuX2dldEZpeGVkVG9vbGJhcnMKCQl9KTsKCQkKCQl0aGlzLl9hZGRQYW5lbENsYXNzZXMoKTsKCgkJLy8gaWYgYW5pbWF0aW5nLCBhZGQgdGhlIGNsYXNzIHRvIGRvIHNvCgkJaWYgKCAkLnN1cHBvcnQuY3NzVHJhbnNmb3JtM2QgJiYgISF0aGlzLm9wdGlvbnMuYW5pbWF0ZSApIHsKCQkJdGhpcy5lbGVtZW50LmFkZENsYXNzKCB0aGlzLm9wdGlvbnMuY2xhc3Nlcy5hbmltYXRlICk7CgkJfQoKCQl0aGlzLl9iaW5kVXBkYXRlTGF5b3V0KCk7CgkJdGhpcy5fYmluZENsb3NlRXZlbnRzKCk7CgkJdGhpcy5fYmluZExpbmtMaXN0ZW5lcnMoKTsKCQl0aGlzLl9iaW5kUGFnZUV2ZW50cygpOwoKCQlpZiAoICEhdGhpcy5vcHRpb25zLmRpc21pc3NpYmxlICkgewoJCQl0aGlzLl9jcmVhdGVNb2RhbCgpOwoJCX0KCgkJdGhpcy5fYmluZFN3aXBlRXZlbnRzKCk7Cgl9LAoJCglfZ2V0UGFuZWxJbm5lcjogZnVuY3Rpb24oKSB7CgkJdmFyIHBhbmVsSW5uZXIgPSB0aGlzLmVsZW1lbnQuZmluZCggIi4iICsgdGhpcy5vcHRpb25zLmNsYXNzZXMucGFuZWxJbm5lciApOwoJCQoJCWlmICggcGFuZWxJbm5lci5sZW5ndGggPT09IDAgKSB7CgkJCXBhbmVsSW5uZXIgPSB0aGlzLmVsZW1lbnQuY2hpbGRyZW4oKS53cmFwQWxsKCAiPGRpdiBjbGFzcz0nIiArIHRoaXMub3B0aW9ucy5jbGFzc2VzLnBhbmVsSW5uZXIgKyAiJyAvPiIgKS5wYXJlbnQoKTsKCQl9CgkJCgkJcmV0dXJuIHBhbmVsSW5uZXI7Cgl9LAoJCglfY3JlYXRlTW9kYWw6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpcywKCQkJdGFyZ2V0ID0gc2VsZi5fcGFyZW50UGFnZSA/IHNlbGYuX3BhcmVudFBhZ2UucGFyZW50KCkgOiBzZWxmLmVsZW1lbnQucGFyZW50KCk7CgoJCXNlbGYuX21vZGFsID0gJCggIjxkaXYgY2xhc3M9JyIgKyBzZWxmLm9wdGlvbnMuY2xhc3Nlcy5tb2RhbCArICInIGRhdGEtcGFuZWxpZD0nIiArIHNlbGYuX3BhbmVsSUQgKyAiJz48L2Rpdj4iICkKCQkJLm9uKCAibW91c2Vkb3duIiwgZnVuY3Rpb24oKSB7CgkJCQlzZWxmLmNsb3NlKCk7CgkJCX0pCgkJCS5hcHBlbmRUbyggdGFyZ2V0ICk7Cgl9LAoJCglfZ2V0UGFnZTogZnVuY3Rpb24oKSB7CgkJdmFyIHBhZ2UgPSB0aGlzLl9wYXJlbnRQYWdlID8gdGhpcy5fcGFyZW50UGFnZSA6ICQoICIuIiArICQubW9iaWxlLmFjdGl2ZVBhZ2VDbGFzcyApOwoJCQoJCXJldHVybiBwYWdlOwoJfSwKCQoJX2dldFdyYXBwZXI6IGZ1bmN0aW9uKCkgewoJCXZhciB3cmFwcGVyID0gdGhpcy5fcGFnZSgpLmZpbmQoICIuIiArIHRoaXMub3B0aW9ucy5jbGFzc2VzLnBhZ2VXcmFwcGVyICk7CgoJCWlmICggd3JhcHBlci5sZW5ndGggPT09IDAgKSB7CgkJCXdyYXBwZXIgPSB0aGlzLl9wYWdlKCkuY2hpbGRyZW4oICIudWktaGVhZGVyOm5vdCg6anFtRGF0YShwb3NpdGlvbj0nZml4ZWQnKSksIC51aS1jb250ZW50Om5vdCg6anFtRGF0YShyb2xlPSdwb3B1cCcpKSwgLnVpLWZvb3Rlcjpub3QoOmpxbURhdGEocG9zaXRpb249J2ZpeGVkJykpIiApCgkJCQkud3JhcEFsbCggIjxkaXYgY2xhc3M9JyIgKyB0aGlzLm9wdGlvbnMuY2xhc3Nlcy5wYWdlV3JhcHBlciArICInPjwvZGl2PiIgKQoJCQkJLnBhcmVudCgpOwoJCX0KCgkJcmV0dXJuIHdyYXBwZXI7Cgl9LAoJCglfZ2V0Rml4ZWRUb29sYmFyczogZnVuY3Rpb24oKSB7CgkJdmFyIGV4dEZpeGVkVG9vbGJhcnMgPSAkKCAiYm9keSIgKS5jaGlsZHJlbiggIi51aS1oZWFkZXI6anFtRGF0YShwb3NpdGlvbj0nZml4ZWQnKSwgLnVpLWZvb3RlcjpqcW1EYXRhKHBvc2l0aW9uPSdmaXhlZCcpIiApLAoJCQlpbnRGaXhlZFRvb2xiYXJzID0gdGhpcy5fcGFnZSgpLmZpbmQoICIudWktaGVhZGVyOmpxbURhdGEocG9zaXRpb249J2ZpeGVkJyksIC51aS1mb290ZXI6anFtRGF0YShwb3NpdGlvbj0nZml4ZWQnKSIgKSwKCQkJZml4ZWRUb29sYmFycyA9IGV4dEZpeGVkVG9vbGJhcnMuYWRkKCBpbnRGaXhlZFRvb2xiYXJzICkuYWRkQ2xhc3MoIHRoaXMub3B0aW9ucy5jbGFzc2VzLnBhZ2VGaXhlZFRvb2xiYXIgKTsKCgkJcmV0dXJuIGZpeGVkVG9vbGJhcnM7Cgl9LAoKCV9nZXRQb3NEaXNwbGF5Q2xhc3NlczogZnVuY3Rpb24oIHByZWZpeCApIHsKCQlyZXR1cm4gcHJlZml4ICsgIi1wb3NpdGlvbi0iICsgdGhpcy5vcHRpb25zLnBvc2l0aW9uICsgIiAiICsgcHJlZml4ICsgIi1kaXNwbGF5LSIgKyB0aGlzLm9wdGlvbnMuZGlzcGxheTsKCX0sCgoJX2dldFBhbmVsQ2xhc3NlczogZnVuY3Rpb24oKSB7CgkJdmFyIHBhbmVsQ2xhc3NlcyA9IHRoaXMub3B0aW9ucy5jbGFzc2VzLnBhbmVsICsKCQkJIiAiICsgdGhpcy5fZ2V0UG9zRGlzcGxheUNsYXNzZXMoIHRoaXMub3B0aW9ucy5jbGFzc2VzLnBhbmVsICkgKwoJCQkiICIgKyB0aGlzLm9wdGlvbnMuY2xhc3Nlcy5wYW5lbENsb3NlZCArCgkJCSIgIiArICJ1aS1ib2R5LSIgKyAoIHRoaXMub3B0aW9ucy50aGVtZSA/IHRoaXMub3B0aW9ucy50aGVtZSA6ICJpbmhlcml0IiApOwoKCQlpZiAoICEhdGhpcy5vcHRpb25zLnBvc2l0aW9uRml4ZWQgKSB7CgkJCXBhbmVsQ2xhc3NlcyArPSAiICIgKyB0aGlzLm9wdGlvbnMuY2xhc3Nlcy5wYW5lbEZpeGVkOwoJCX0KCgkJcmV0dXJuIHBhbmVsQ2xhc3NlczsKCX0sCgoJX2FkZFBhbmVsQ2xhc3NlczogZnVuY3Rpb24oKSB7CgkJdGhpcy5lbGVtZW50LmFkZENsYXNzKCB0aGlzLl9nZXRQYW5lbENsYXNzZXMoKSApOwoJfSwKCglfYmluZENsb3NlRXZlbnRzOiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXM7CgoJCXNlbGYuX2Nsb3NlTGluay5vbiggImNsaWNrLnBhbmVsIiAsIGZ1bmN0aW9uKCBlICkgewoJCQllLnByZXZlbnREZWZhdWx0KCk7CgkJCXNlbGYuY2xvc2UoKTsKCQkJcmV0dXJuIGZhbHNlOwoJCX0pOwoJCXNlbGYuZWxlbWVudC5vbiggImNsaWNrLnBhbmVsIiAsICJhOmpxbURhdGEoYWpheD0nZmFsc2UnKSIsIGZ1bmN0aW9uKC8qIGUgKi8pIHsKCQkJc2VsZi5jbG9zZSgpOwoJCX0pOwoJfSwKCglfcG9zaXRpb25QYW5lbDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzLAoJCQlwYW5lbElubmVySGVpZ2h0ID0gc2VsZi5fcGFuZWxJbm5lci5vdXRlckhlaWdodCgpLAoJCQlleHBhbmQgPSBwYW5lbElubmVySGVpZ2h0ID4gJC5tb2JpbGUuZ2V0U2NyZWVuSGVpZ2h0KCk7CgoJCWlmICggZXhwYW5kIHx8ICFzZWxmLm9wdGlvbnMucG9zaXRpb25GaXhlZCApIHsKCQkJaWYgKCBleHBhbmQgKSB7CgkJCQlzZWxmLl91bmZpeFBhbmVsKCk7CgkJCQkkLm1vYmlsZS5yZXNldEFjdGl2ZVBhZ2VIZWlnaHQoIHBhbmVsSW5uZXJIZWlnaHQgKTsKCQkJfQoJCQl3aW5kb3cuc2Nyb2xsVG8oIDAsICQubW9iaWxlLmRlZmF1bHRIb21lU2Nyb2xsICk7CgkJfSBlbHNlIHsKCQkJc2VsZi5fZml4UGFuZWwoKTsKCQl9Cgl9LAoKCV9iaW5kRml4TGlzdGVuZXI6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX29uKCAkKCB3aW5kb3cgKSwgeyAidGhyb3R0bGVkcmVzaXplIjogIl9wb3NpdGlvblBhbmVsIiB9KTsKCX0sCgoJX3VuYmluZEZpeExpc3RlbmVyOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9vZmYoICQoIHdpbmRvdyApLCAidGhyb3R0bGVkcmVzaXplIiApOwoJfSwKCglfdW5maXhQYW5lbDogZnVuY3Rpb24oKSB7CgkJaWYgKCAhIXRoaXMub3B0aW9ucy5wb3NpdGlvbkZpeGVkICYmICQuc3VwcG9ydC5maXhlZFBvc2l0aW9uICkgewoJCQl0aGlzLmVsZW1lbnQucmVtb3ZlQ2xhc3MoIHRoaXMub3B0aW9ucy5jbGFzc2VzLnBhbmVsRml4ZWQgKTsKCQl9Cgl9LAoKCV9maXhQYW5lbDogZnVuY3Rpb24oKSB7CgkJaWYgKCAhIXRoaXMub3B0aW9ucy5wb3NpdGlvbkZpeGVkICYmICQuc3VwcG9ydC5maXhlZFBvc2l0aW9uICkgewoJCQl0aGlzLmVsZW1lbnQuYWRkQ2xhc3MoIHRoaXMub3B0aW9ucy5jbGFzc2VzLnBhbmVsRml4ZWQgKTsKCQl9Cgl9LAoKCV9iaW5kVXBkYXRlTGF5b3V0OiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXM7CgoJCXNlbGYuZWxlbWVudC5vbiggInVwZGF0ZWxheW91dCIsIGZ1bmN0aW9uKC8qIGUgKi8pIHsKCQkJaWYgKCBzZWxmLl9vcGVuICkgewoJCQkJc2VsZi5fcG9zaXRpb25QYW5lbCgpOwoJCQl9CgkJfSk7Cgl9LAoKCV9iaW5kTGlua0xpc3RlbmVyczogZnVuY3Rpb24oKSB7CgkJdGhpcy5fb24oICJib2R5IiwgewoJCQkiY2xpY2sgYSI6ICJfaGFuZGxlQ2xpY2siCgkJfSk7CgkJCgl9LAoKCV9oYW5kbGVDbGljazogZnVuY3Rpb24oIGUgKXsKCQlpZiAoICBlLmN1cnJlbnRUYXJnZXQuaHJlZi5zcGxpdCggIiMiIClbIDEgXSA9PT0gdGhpcy5fcGFuZWxJRCAmJiB0aGlzLl9wYW5lbElEICE9PSB1bmRlZmluZWQgKSB7CgkJCWUucHJldmVudERlZmF1bHQoKTsKCQkJdmFyIGxpbmsgPSAkKCBlLnRhcmdldCApOwoJCQlpZiAoIGxpbmsuaGFzQ2xhc3MoICJ1aS1idG4iICkgKSB7CgkJCQlsaW5rLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQkJdGhpcy5lbGVtZW50Lm9uZSggInBhbmVsb3BlbiBwYW5lbGNsb3NlIiwgZnVuY3Rpb24oKSB7CgkJCQkJbGluay5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJCX0pOwoJCQl9CgkJCXRoaXMudG9nZ2xlKCk7CgkJCXJldHVybiBmYWxzZTsKCQl9Cgl9LAoKCV9iaW5kU3dpcGVFdmVudHM6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpcywKCQkJYXJlYSA9IHNlbGYuX21vZGFsID8gc2VsZi5lbGVtZW50LmFkZCggc2VsZi5fbW9kYWwgKSA6IHNlbGYuZWxlbWVudDsKCgkJLy8gb24gc3dpcGUsIGNsb3NlIHRoZSBwYW5lbAoJCWlmICggISFzZWxmLm9wdGlvbnMuc3dpcGVDbG9zZSApIHsKCQkJaWYgKCBzZWxmLm9wdGlvbnMucG9zaXRpb24gPT09ICJsZWZ0IiApIHsKCQkJCWFyZWEub24oICJzd2lwZWxlZnQucGFuZWwiLCBmdW5jdGlvbigvKiBlICovKSB7CgkJCQkJc2VsZi5jbG9zZSgpOwoJCQkJfSk7CgkJCX0gZWxzZSB7CgkJCQlhcmVhLm9uKCAic3dpcGVyaWdodC5wYW5lbCIsIGZ1bmN0aW9uKC8qIGUgKi8pIHsKCQkJCQlzZWxmLmNsb3NlKCk7CgkJCQl9KTsKCQkJfQoJCX0KCX0sCgoJX2JpbmRQYWdlRXZlbnRzOiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXM7CgoJCXRoaXMuZG9jdW1lbnQKCQkJLy8gQ2xvc2UgdGhlIHBhbmVsIGlmIGFub3RoZXIgcGFuZWwgb24gdGhlIHBhZ2Ugb3BlbnMKCQkJLm9uKCAicGFuZWxiZWZvcmVvcGVuIiwgZnVuY3Rpb24oIGUgKSB7CgkJCQlpZiAoIHNlbGYuX29wZW4gJiYgZS50YXJnZXQgIT09IHNlbGYuZWxlbWVudFsgMCBdICkgewoJCQkJCXNlbGYuY2xvc2UoKTsKCQkJCX0KCQkJfSkKCQkJLy8gT24gZXNjYXBlLCBjbG9zZT8gbWlnaHQgbmVlZCB0byBoYXZlIGEgdGFyZ2V0IGNoZWNrIHRvby4uLgoJCQkub24oICJrZXl1cC5wYW5lbCIsIGZ1bmN0aW9uKCBlICkgewoJCQkJaWYgKCBlLmtleUNvZGUgPT09IDI3ICYmIHNlbGYuX29wZW4gKSB7CgkJCQkJc2VsZi5jbG9zZSgpOwoJCQkJfQoJCQl9KTsKCQkJCgkJLy8gQ2xlYW4gdXAgb3BlbiBwYW5lbHMgYWZ0ZXIgcGFnZSBoaWRlCgkJaWYgKCBzZWxmLl9wYXJlbnRQYWdlICkgewoJCQl0aGlzLmRvY3VtZW50Lm9uKCAicGFnZWhpZGUiLCAiOmpxbURhdGEocm9sZT0ncGFnZScpIiwgZnVuY3Rpb24oKSB7CgkJCQlpZiAoIHNlbGYuX29wZW4gKSB7CgkJCQkJc2VsZi5jbG9zZSggdHJ1ZSApOwoJCQkJfQoJCQl9KTsKCQl9IGVsc2UgewoJCQl0aGlzLmRvY3VtZW50Lm9uKCAicGFnZWJlZm9yZWhpZGUiLCBmdW5jdGlvbigpIHsKCQkJCWlmICggc2VsZi5fb3BlbiApIHsKCQkJCQlzZWxmLmNsb3NlKCB0cnVlICk7CgkJCQl9CgkJCX0pOwoJCX0KCX0sCgoJLy8gc3RhdGUgc3RvcmFnZSBvZiBvcGVuIG9yIGNsb3NlZAoJX29wZW46IGZhbHNlLAoJX3BhZ2VDb250ZW50T3BlbkNsYXNzZXM6IG51bGwsCglfbW9kYWxPcGVuQ2xhc3NlczogbnVsbCwKCglvcGVuOiBmdW5jdGlvbiggaW1tZWRpYXRlICkgewoJCWlmICggIXRoaXMuX29wZW4gKSB7CgkJCXZhciBzZWxmID0gdGhpcywKCQkJCW8gPSBzZWxmLm9wdGlvbnMsCgkJCQkKCQkJCV9vcGVuUGFuZWwgPSBmdW5jdGlvbigpIHsKCQkJCQlzZWxmLmRvY3VtZW50Lm9mZiggInBhbmVsY2xvc2UiICk7CgkJCQkJc2VsZi5fcGFnZSgpLmpxbURhdGEoICJwYW5lbCIsICJvcGVuIiApOwoJCQkJCQoJCQkJCWlmICggJC5zdXBwb3J0LmNzc1RyYW5zZm9ybTNkICYmICEhby5hbmltYXRlICYmIG8uZGlzcGxheSAhPT0gIm92ZXJsYXkiICkgewoJCQkJCQlzZWxmLl93cmFwcGVyKCkuYWRkQ2xhc3MoIG8uY2xhc3Nlcy5hbmltYXRlICk7CgkJCQkJCXNlbGYuX2ZpeGVkVG9vbGJhcnMoKS5hZGRDbGFzcyggby5jbGFzc2VzLmFuaW1hdGUgKTsKCQkJCQl9CgoJCQkJCWlmICggIWltbWVkaWF0ZSAmJiAkLnN1cHBvcnQuY3NzVHJhbnNmb3JtM2QgJiYgISFvLmFuaW1hdGUgKSB7CgkJCQkJCXNlbGYuZG9jdW1lbnQub24oIHNlbGYuX3RyYW5zaXRpb25FbmRFdmVudHMsIGNvbXBsZXRlICk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJc2V0VGltZW91dCggY29tcGxldGUsIDAgKTsKCQkJCQl9CgoJCQkJCWlmICggby50aGVtZSAmJiBvLmRpc3BsYXkgIT09ICJvdmVybGF5IiApIHsKCQkJCQkJc2VsZi5fcGFnZSgpLnBhcmVudCgpCgkJCQkJCQkuYWRkQ2xhc3MoIG8uY2xhc3Nlcy5wYWdlQ29udGFpbmVyICsgIi10aGVtZWQgIiArIG8uY2xhc3Nlcy5wYWdlQ29udGFpbmVyICsgIi0iICsgby50aGVtZSApOwoJCQkJCX0KCgkJCQkJc2VsZi5lbGVtZW50CgkJCQkJCS5yZW1vdmVDbGFzcyggby5jbGFzc2VzLnBhbmVsQ2xvc2VkICkKCQkJCQkJLmFkZENsYXNzKCBvLmNsYXNzZXMucGFuZWxPcGVuICk7CgoJCQkJCXNlbGYuX3Bvc2l0aW9uUGFuZWwoKTsKCgkJCQkJc2VsZi5fcGFnZUNvbnRlbnRPcGVuQ2xhc3NlcyA9IHNlbGYuX2dldFBvc0Rpc3BsYXlDbGFzc2VzKCBvLmNsYXNzZXMucGFnZUNvbnRlbnRQcmVmaXggKTsKCQkJCQkKCQkJCQlpZiAoIG8uZGlzcGxheSAhPT0gIm92ZXJsYXkiICkgewoJCQkJCQlzZWxmLl9wYWdlKCkucGFyZW50KCkuYWRkQ2xhc3MoIG8uY2xhc3Nlcy5wYWdlQ29udGFpbmVyICk7CgkJCQkJCXNlbGYuX3dyYXBwZXIoKS5hZGRDbGFzcyggc2VsZi5fcGFnZUNvbnRlbnRPcGVuQ2xhc3NlcyApOwoJCQkJCQlzZWxmLl9maXhlZFRvb2xiYXJzKCkuYWRkQ2xhc3MoIHNlbGYuX3BhZ2VDb250ZW50T3BlbkNsYXNzZXMgKTsKCQkJCQl9CgoJCQkJCXNlbGYuX21vZGFsT3BlbkNsYXNzZXMgPSBzZWxmLl9nZXRQb3NEaXNwbGF5Q2xhc3Nlcyggby5jbGFzc2VzLm1vZGFsICkgKyAiICIgKyBvLmNsYXNzZXMubW9kYWxPcGVuOwoJCQkJCWlmICggc2VsZi5fbW9kYWwgKSB7CgkJCQkJCXNlbGYuX21vZGFsCgkJCQkJCQkuYWRkQ2xhc3MoIHNlbGYuX21vZGFsT3BlbkNsYXNzZXMgKQoJCQkJCQkJLmhlaWdodCggTWF0aC5tYXgoIHNlbGYuX21vZGFsLmhlaWdodCgpLCBzZWxmLmRvY3VtZW50LmhlaWdodCgpICkgKTsKCQkJCQl9CgkJCQl9LAoJCQkJY29tcGxldGUgPSBmdW5jdGlvbigpIHsKCQkJCQlzZWxmLmRvY3VtZW50Lm9mZiggc2VsZi5fdHJhbnNpdGlvbkVuZEV2ZW50cywgY29tcGxldGUgKTsKCQkJCQkKCQkJCQlpZiAoIG8uZGlzcGxheSAhPT0gIm92ZXJsYXkiICkgewoJCQkJCQlzZWxmLl93cmFwcGVyKCkuYWRkQ2xhc3MoIG8uY2xhc3Nlcy5wYWdlQ29udGVudFByZWZpeCArICItb3BlbiIgKTsKCQkJCQkJc2VsZi5fZml4ZWRUb29sYmFycygpLmFkZENsYXNzKCBvLmNsYXNzZXMucGFnZUNvbnRlbnRQcmVmaXggKyAiLW9wZW4iICk7CgkJCQkJfQoKCQkJCQlzZWxmLl9iaW5kRml4TGlzdGVuZXIoKTsKCgkJCQkJc2VsZi5fdHJpZ2dlciggIm9wZW4iICk7CgkJCQl9OwoKCQkJc2VsZi5fdHJpZ2dlciggImJlZm9yZW9wZW4iICk7CgkJCQoJCQlpZiAoIHNlbGYuX3BhZ2UoKS5qcW1EYXRhKCAicGFuZWwiICkgPT09ICJvcGVuIiApIHsKCQkJCXNlbGYuZG9jdW1lbnQub24oICJwYW5lbGNsb3NlIiwgZnVuY3Rpb24oKSB7CgkJCQkJX29wZW5QYW5lbCgpOwoJCQkJfSk7CgkJCX0gZWxzZSB7CgkJCQlfb3BlblBhbmVsKCk7CgkJCX0KCgkJCXNlbGYuX29wZW4gPSB0cnVlOwoJCX0KCX0sCgoJY2xvc2U6IGZ1bmN0aW9uKCBpbW1lZGlhdGUgKSB7CgkJaWYgKCB0aGlzLl9vcGVuICkgewoJCQl2YXIgc2VsZiA9IHRoaXMsCgkJCQlvID0gdGhpcy5vcHRpb25zLAoJCQkJCgkJCQlfY2xvc2VQYW5lbCA9IGZ1bmN0aW9uKCkgewoJCQkJCWlmICggIWltbWVkaWF0ZSAmJiAkLnN1cHBvcnQuY3NzVHJhbnNmb3JtM2QgJiYgISFvLmFuaW1hdGUgKSB7CgkJCQkJCXNlbGYuZG9jdW1lbnQub24oIHNlbGYuX3RyYW5zaXRpb25FbmRFdmVudHMsIGNvbXBsZXRlICk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJc2V0VGltZW91dCggY29tcGxldGUsIDAgKTsKCQkJCQl9CgoJCQkJCXNlbGYuZWxlbWVudC5yZW1vdmVDbGFzcyggby5jbGFzc2VzLnBhbmVsT3BlbiApOwoJCQkJCQoJCQkJCWlmICggby5kaXNwbGF5ICE9PSAib3ZlcmxheSIgKSB7CgkJCQkJCXNlbGYuX3dyYXBwZXIoKS5yZW1vdmVDbGFzcyggc2VsZi5fcGFnZUNvbnRlbnRPcGVuQ2xhc3NlcyApOwoJCQkJCQlzZWxmLl9maXhlZFRvb2xiYXJzKCkucmVtb3ZlQ2xhc3MoIHNlbGYuX3BhZ2VDb250ZW50T3BlbkNsYXNzZXMgKTsKCQkJCQl9CgkJCQkJCgkJCQkJaWYgKCBzZWxmLl9tb2RhbCApIHsKCQkJCQkJc2VsZi5fbW9kYWwucmVtb3ZlQ2xhc3MoIHNlbGYuX21vZGFsT3BlbkNsYXNzZXMgKTsKCQkJCQl9CgkJCQl9LAoJCQkJY29tcGxldGUgPSBmdW5jdGlvbigpIHsKCQkJCQlzZWxmLmRvY3VtZW50Lm9mZiggc2VsZi5fdHJhbnNpdGlvbkVuZEV2ZW50cywgY29tcGxldGUgKTsKCQkJCQkKCQkJCQlpZiAoIG8udGhlbWUgJiYgby5kaXNwbGF5ICE9PSAib3ZlcmxheSIgKSB7CgkJCQkJCXNlbGYuX3BhZ2UoKS5wYXJlbnQoKS5yZW1vdmVDbGFzcyggby5jbGFzc2VzLnBhZ2VDb250YWluZXIgKyAiLXRoZW1lZCAiICsgby5jbGFzc2VzLnBhZ2VDb250YWluZXIgKyAiLSIgKyBvLnRoZW1lICk7CgkJCQkJfQoJCQkJCQkKCQkJCQlzZWxmLmVsZW1lbnQuYWRkQ2xhc3MoIG8uY2xhc3Nlcy5wYW5lbENsb3NlZCApOwoKCQkJCQlpZiAoIG8uZGlzcGxheSAhPT0gIm92ZXJsYXkiICkgewoJCQkJCQlzZWxmLl9wYWdlKCkucGFyZW50KCkucmVtb3ZlQ2xhc3MoIG8uY2xhc3Nlcy5wYWdlQ29udGFpbmVyICk7CgkJCQkJCXNlbGYuX3dyYXBwZXIoKS5yZW1vdmVDbGFzcyggby5jbGFzc2VzLnBhZ2VDb250ZW50UHJlZml4ICsgIi1vcGVuIiApOwoJCQkJCQlzZWxmLl9maXhlZFRvb2xiYXJzKCkucmVtb3ZlQ2xhc3MoIG8uY2xhc3Nlcy5wYWdlQ29udGVudFByZWZpeCArICItb3BlbiIgKTsKCQkJCQl9CgoJCQkJCWlmICggJC5zdXBwb3J0LmNzc1RyYW5zZm9ybTNkICYmICEhby5hbmltYXRlICYmIG8uZGlzcGxheSAhPT0gIm92ZXJsYXkiICkgewoJCQkJCQlzZWxmLl93cmFwcGVyKCkucmVtb3ZlQ2xhc3MoIG8uY2xhc3Nlcy5hbmltYXRlICk7CgkJCQkJCXNlbGYuX2ZpeGVkVG9vbGJhcnMoKS5yZW1vdmVDbGFzcyggby5jbGFzc2VzLmFuaW1hdGUgKTsKCQkJCQl9CgoJCQkJCXNlbGYuX2ZpeFBhbmVsKCk7CgkJCQkJc2VsZi5fdW5iaW5kRml4TGlzdGVuZXIoKTsKCQkJCQkkLm1vYmlsZS5yZXNldEFjdGl2ZVBhZ2VIZWlnaHQoKTsKCgkJCQkJc2VsZi5fcGFnZSgpLmpxbVJlbW92ZURhdGEoICJwYW5lbCIgKTsKCQkJCQkKCQkJCQlzZWxmLl90cmlnZ2VyKCAiY2xvc2UiICk7CgkJCQl9OwoKCQkJc2VsZi5fdHJpZ2dlciggImJlZm9yZWNsb3NlIiApOwoKCQkJX2Nsb3NlUGFuZWwoKTsKCgkJCXNlbGYuX29wZW4gPSBmYWxzZTsKCQl9Cgl9LAoKCXRvZ2dsZTogZnVuY3Rpb24oKSB7CgkJdGhpc1sgdGhpcy5fb3BlbiA/ICJjbG9zZSIgOiAib3BlbiIgXSgpOwoJfSwKCglfdHJhbnNpdGlvbkVuZEV2ZW50czogIndlYmtpdFRyYW5zaXRpb25FbmQgb1RyYW5zaXRpb25FbmQgb3RyYW5zaXRpb25lbmQgdHJhbnNpdGlvbmVuZCBtc1RyYW5zaXRpb25FbmQiLAoKCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCQl2YXIgbyA9IHRoaXMub3B0aW9ucywKCQkJbXVsdGlwbGVQYW5lbHMgPSAoICQoICJib2R5ID4gOm1vYmlsZS1wYW5lbCIgKS5sZW5ndGggKyAkLm1vYmlsZS5hY3RpdmVQYWdlLmZpbmQoICI6bW9iaWxlLXBhbmVsIiApLmxlbmd0aCApID4gMTsKCgkJaWYgKCBvLmRpc3BsYXkgIT09ICJvdmVybGF5IiApIHsKCQkJLy8gRGVzdHJveSB0aGUgd3JhcHBlciBldmVuIGlmIHRoZXJlIGFyZSBzdGlsbCBvdGhlciBwYW5lbHMsIGJlY2F1c2Ugd2UgZG9uJ3Qga25vdyBpZiB0aGV5IHVzZSBhIHdyYXBwZXIKCQkJdGhpcy5fd3JhcHBlcigpLmNoaWxkcmVuKCkudW53cmFwKCk7CgoJCQlpZiAoIHRoaXMuX29wZW4gKSB7CgkJCQkKCQkJCXRoaXMuX2ZpeGVkVG9vbGJhcnMoKS5yZW1vdmVDbGFzcyggby5jbGFzc2VzLnBhZ2VDb250ZW50UHJlZml4ICsgIi1vcGVuIiApOwoJCQkJCgkJCQlpZiAoICQuc3VwcG9ydC5jc3NUcmFuc2Zvcm0zZCAmJiAhIW8uYW5pbWF0ZSApIHsKCQkJCQl0aGlzLl9maXhlZFRvb2xiYXJzKCkucmVtb3ZlQ2xhc3MoIG8uY2xhc3Nlcy5hbmltYXRlICk7CgkJCQl9CgkJCQkKCQkJCXRoaXMuX3BhZ2UoKS5wYXJlbnQoKS5yZW1vdmVDbGFzcyggby5jbGFzc2VzLnBhZ2VDb250YWluZXIgKTsKCQkJCQoJCQkJaWYgKCBvLnRoZW1lICkgewoJCQkJCXRoaXMuX3BhZ2UoKS5wYXJlbnQoKS5yZW1vdmVDbGFzcyggby5jbGFzc2VzLnBhZ2VDb250YWluZXIgKyAiLXRoZW1lZCAiICsgby5jbGFzc2VzLnBhZ2VDb250YWluZXIgKyAiLSIgKyBvLnRoZW1lICk7CgkJCQl9CgkJCX0KCQl9CgoJCWlmICggIW11bHRpcGxlUGFuZWxzICkgewoKCQkJdGhpcy5kb2N1bWVudC5vZmYoICJwYW5lbG9wZW4gcGFuZWxjbG9zZSIgKTsKCQkJCgkJCWlmICggdGhpcy5fb3BlbiApIHsKCQkJCXRoaXMuZG9jdW1lbnQub2ZmKCB0aGlzLl90cmFuc2l0aW9uRW5kRXZlbnRzICk7CgkJCQkkLm1vYmlsZS5yZXNldEFjdGl2ZVBhZ2VIZWlnaHQoKTsKCQkJfQoJCX0KCQkKCQlpZiAoIHRoaXMuX29wZW4gKSB7CgkJCXRoaXMuX3BhZ2UoKS5qcW1SZW1vdmVEYXRhKCAicGFuZWwiICk7CgkJfQoJCQoJCXRoaXMuX3BhbmVsSW5uZXIuY2hpbGRyZW4oKS51bndyYXAoKTsKCgkJdGhpcy5lbGVtZW50CgkJCS5yZW1vdmVDbGFzcyggWyB0aGlzLl9nZXRQYW5lbENsYXNzZXMoKSwgby5jbGFzc2VzLnBhbmVsT3Blbiwgby5jbGFzc2VzLmFuaW1hdGUgXS5qb2luKCAiICIgKSApCgkJCS5vZmYoICJzd2lwZWxlZnQucGFuZWwgc3dpcGVyaWdodC5wYW5lbCIgKQoJCQkub2ZmKCAicGFuZWxiZWZvcmVvcGVuIiApCgkJCS5vZmYoICJwYW5lbGhpZGUiICkKCQkJLm9mZiggImtleXVwLnBhbmVsIiApCgkJCS5vZmYoICJ1cGRhdGVsYXlvdXQiICkKCQkJLm9mZiggdGhpcy5fdHJhbnNpdGlvbkVuZEV2ZW50cyApOwoKCQl0aGlzLl9jbG9zZUxpbmsub2ZmKCAiY2xpY2sucGFuZWwiICk7CgoJCWlmICggdGhpcy5fbW9kYWwgKSB7CgkJCXRoaXMuX21vZGFsLnJlbW92ZSgpOwoJCX0KCX0KfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLnRhYmxlIiwgewoJb3B0aW9uczogewoJCWNsYXNzZXM6IHsKCQkJdGFibGU6ICJ1aS10YWJsZSIKCQl9LAoJCWVuaGFuY2VkOiBmYWxzZQoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQlpZiAoICF0aGlzLm9wdGlvbnMuZW5oYW5jZWQgKSB7CgkJCXRoaXMuZWxlbWVudC5hZGRDbGFzcyggdGhpcy5vcHRpb25zLmNsYXNzZXMudGFibGUgKTsKCQl9CgoJCS8vIGV4dGVuZCBoZXJlLCBhc3NpZ24gb24gcmVmcmVzaCA+IF9zZXRIZWFkZXJzCgkJJC5leHRlbmQoIHRoaXMsIHsKCgkJCS8vIEV4cG9zZSBoZWFkZXJzIGFuZCBhbGxIZWFkZXJzIHByb3BlcnRpZXMgb24gdGhlIHdpZGdldAoJCQkvLyBoZWFkZXJzIHJlZmVyZW5jZXMgdGhlIFRIcyB3aXRoaW4gdGhlIGZpcnN0IFRSIGluIHRoZSB0YWJsZQoJCQloZWFkZXJzOiB1bmRlZmluZWQsCgoJCQkvLyBhbGxIZWFkZXJzIHJlZmVyZW5jZXMgaGVhZGVycywgcGx1cyBhbGwgVEhzIGluIHRoZSB0aGVhZCwgd2hpY2ggbWF5CgkJCS8vIGluY2x1ZGUgc2V2ZXJhbCByb3dzLCBvciBub3QKCQkJYWxsSGVhZGVyczogdW5kZWZpbmVkCgkJfSk7CgoJCXRoaXMuX3JlZnJlc2goIHRydWUgKTsKCX0sCgoJX3NldEhlYWRlcnM6IGZ1bmN0aW9uKCkgewoJCXZhciB0cnMgPSB0aGlzLmVsZW1lbnQuZmluZCggInRoZWFkIHRyIiApOwoKCQl0aGlzLmhlYWRlcnMgPSB0aGlzLmVsZW1lbnQuZmluZCggInRyOmVxKDApIiApLmNoaWxkcmVuKCk7CgkJdGhpcy5hbGxIZWFkZXJzID0gdGhpcy5oZWFkZXJzLmFkZCggdHJzLmNoaWxkcmVuKCkgKTsKCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJdGhpcy5fcmVmcmVzaCgpOwoJfSwKCglyZWJ1aWxkOiAkLm5vb3AsCgoJX3JlZnJlc2g6IGZ1bmN0aW9uKCAvKiBjcmVhdGUgKi8gKSB7CgkJdmFyIHRhYmxlID0gdGhpcy5lbGVtZW50LAoJCQl0cnMgPSB0YWJsZS5maW5kKCAidGhlYWQgdHIiICk7CgoJCS8vIHVwZGF0aW5nIGhlYWRlcnMgb24gcmVmcmVzaCAoZml4ZXMgIzU4ODApCgkJdGhpcy5fc2V0SGVhZGVycygpOwoKCQkvLyBJdGVyYXRlIG92ZXIgdGhlIHRycwoJCXRycy5lYWNoKCBmdW5jdGlvbigpIHsKCQkJdmFyIGNvbHVtbkNvdW50ID0gMDsKCgkJCS8vIEl0ZXJhdGUgb3ZlciB0aGUgY2hpbGRyZW4gb2YgdGhlIHRyCgkJCSQoIHRoaXMgKS5jaGlsZHJlbigpLmVhY2goIGZ1bmN0aW9uKCkgewoJCQkJdmFyIHNwYW4gPSBwYXJzZUludCggdGhpcy5nZXRBdHRyaWJ1dGUoICJjb2xzcGFuIiApLCAxMCApLAoJCQkJCXNlbGVjdG9yID0gIjpudGgtY2hpbGQoIiArICggY29sdW1uQ291bnQgKyAxICkgKyAiKSIsCgkJCQkJajsKCgkJCQl0aGlzLnNldEF0dHJpYnV0ZSggImRhdGEtIiArICQubW9iaWxlLm5zICsgImNvbHN0YXJ0IiwgY29sdW1uQ291bnQgKyAxICk7CgoJCQkJaWYgKCBzcGFuICkgewoJCQkJCWZvciggaiA9IDA7IGogPCBzcGFuIC0gMTsgaisrICkgewoJCQkJCQljb2x1bW5Db3VudCsrOwoJCQkJCQlzZWxlY3RvciArPSAiLCA6bnRoLWNoaWxkKCIgKyAoIGNvbHVtbkNvdW50ICsgMSApICsgIikiOwoJCQkJCX0KCQkJCX0KCgkJCQkvLyBTdG9yZSAiY2VsbHMiIGRhdGEgb24gaGVhZGVyIGFzIGEgcmVmZXJlbmNlIHRvIGFsbCBjZWxscyBpbiB0aGUgCgkJCQkvLyBzYW1lIGNvbHVtbiBhcyB0aGlzIFRICgkJCQkkKCB0aGlzICkuanFtRGF0YSggImNlbGxzIiwgdGFibGUuZmluZCggInRyIiApLm5vdCggdHJzLmVxKCAwICkgKS5ub3QoIHRoaXMgKS5jaGlsZHJlbiggc2VsZWN0b3IgKSApOwoKCQkJCWNvbHVtbkNvdW50Kys7CgkJCX0pOwoJCX0pOwoJfQp9KTsKCn0pKCBqUXVlcnkgKTsKCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLnRhYmxlIiwgJC5tb2JpbGUudGFibGUsIHsKCW9wdGlvbnM6IHsKCQltb2RlOiAiY29sdW1udG9nZ2xlIiwKCQljb2x1bW5CdG5UaGVtZTogbnVsbCwKCQljb2x1bW5Qb3B1cFRoZW1lOiBudWxsLAoJCWNvbHVtbkJ0blRleHQ6ICJDb2x1bW5zLi4uIiwKCQljbGFzc2VzOiAkLmV4dGVuZCggJC5tb2JpbGUudGFibGUucHJvdG90eXBlLm9wdGlvbnMuY2xhc3NlcywgewoJCQlwb3B1cDogInVpLXRhYmxlLWNvbHVtbnRvZ2dsZS1wb3B1cCIsCgkJCWNvbHVtbkJ0bjogInVpLXRhYmxlLWNvbHVtbnRvZ2dsZS1idG4iLAoJCQlwcmlvcml0eVByZWZpeDogInVpLXRhYmxlLXByaW9yaXR5LSIsCgkJCWNvbHVtblRvZ2dsZVRhYmxlOiAidWktdGFibGUtY29sdW1udG9nZ2xlIgoJCX0pCgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3N1cGVyKCk7CgoJCWlmKCB0aGlzLm9wdGlvbnMubW9kZSAhPT0gImNvbHVtbnRvZ2dsZSIgKSB7CgkJCXJldHVybjsKCQl9CgoJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCV9tZW51OiBudWxsCgkJfSk7CgoJCWlmKCB0aGlzLm9wdGlvbnMuZW5oYW5jZWQgKSB7CgkJCXRoaXMuX21lbnUgPSB0aGlzLmRvY3VtZW50LmZpbmQoIHRoaXMuX2lkKCkgKyAiLXBvcHVwIiApLmNoaWxkcmVuKCkuZmlyc3QoKTsKCQl9IGVsc2UgewoJCQl0aGlzLl9tZW51ID0gdGhpcy5fZW5oYW5jZUNvbFRvZ2dsZSgpOwoJCQl0aGlzLmVsZW1lbnQuYWRkQ2xhc3MoIHRoaXMub3B0aW9ucy5jbGFzc2VzLmNvbHVtblRvZ2dsZVRhYmxlICk7CgkJfQoKCQl0aGlzLl9zZXR1cEV2ZW50cygpOwoKCQl0aGlzLl9zZXRUb2dnbGVTdGF0ZSgpOwoJfSwKCglfaWQ6IGZ1bmN0aW9uKCkgewoJCXJldHVybiAoIHRoaXMuZWxlbWVudC5hdHRyKCAiaWQiICkgfHwgKCB0aGlzLndpZGdldE5hbWUgKyB0aGlzLnV1aWQgKSApOwoJfSwKCglfc2V0dXBFdmVudHM6IGZ1bmN0aW9uKCkgewoJCS8vTk9URTogaW5wdXRzIGFyZSBib3VuZCBpbiBiaW5kVG9nZ2xlcywKCQkvLyBzbyBpdCBjYW4gYmUgY2FsbGVkIG9uIHJlZnJlc2gsIHRvbwoKCQkvLyB1cGRhdGUgY29sdW1uIHRvZ2dsZXMgb24gcmVzaXplCgkJdGhpcy5fb24oIHRoaXMud2luZG93LCB7CgkJCXRocm90dGxlZHJlc2l6ZTogIl9zZXRUb2dnbGVTdGF0ZSIKCQl9KTsKCX0sCgoJX2JpbmRUb2dnbGVzOiBmdW5jdGlvbiggbWVudSApIHsKCQl2YXIgaW5wdXRzID0gbWVudS5maW5kKCAiaW5wdXQiICk7CgoJCXRoaXMuX29uKCBpbnB1dHMsIHsKCQkJY2hhbmdlOiAiX21lbnVJbnB1dENoYW5nZSIKCQl9KTsKCX0sCgoJX2FkZFRvZ2dsZXM6IGZ1bmN0aW9uKCBtZW51LCBrZWVwICkgewoJCXZhciBvcHRzID0gdGhpcy5vcHRpb25zOwoKCQkvLyBhbGxvdyB1cGRhdGUgb2YgbWVudSBvbiByZWZyZXNoIChmaXhlcyAjNTg4MCkKCQlpZiAoICFrZWVwICkgewoJCQltZW51LmVtcHR5KCk7CgkJfQoKCQkvLyBjcmVhdGUgdGhlIGhpZGUvc2hvdyB0b2dnbGVzCgkJdGhpcy5oZWFkZXJzLm5vdCggInRkIiApLmVhY2goIGZ1bmN0aW9uKCkgewoJCQl2YXIgaGVhZGVyID0gJCggdGhpcyApLAoJCQkJcHJpb3JpdHkgPSAkLm1vYmlsZS5nZXRBdHRyaWJ1dGUoIHRoaXMsICJwcmlvcml0eSIgKSwKCQkJCWNlbGxzID0gaGVhZGVyLmFkZCggaGVhZGVyLmpxbURhdGEoICJjZWxscyIgKSApOwoKCQkJaWYoIHByaW9yaXR5ICkgewoJCQkJY2VsbHMuYWRkQ2xhc3MoIG9wdHMuY2xhc3Nlcy5wcmlvcml0eVByZWZpeCArIHByaW9yaXR5ICk7CgoJCQkJaWYgKCAha2VlcCApIHsKCQkJCQkkKCI8bGFiZWw+PGlucHV0IHR5cGU9J2NoZWNrYm94JyBjaGVja2VkIC8+IiArCgkJCQkJCSggaGVhZGVyLmNoaWxkcmVuKCAiYWJiciIgKS5maXJzdCgpLmF0dHIoICJ0aXRsZSIgKSB8fAoJCQkJCQkJaGVhZGVyLnRleHQoKSApICsKCQkJCQkJIjwvbGFiZWw+IiApCgkJCQkJCS5hcHBlbmRUbyggbWVudSApCgkJCQkJCS5jaGlsZHJlbiggMCApCgkJCQkJCS5qcW1EYXRhKCAiY2VsbHMiLCBjZWxscyApCgkJCQkJCS5jaGVja2JveHJhZGlvKCB7CgkJCQkJCQl0aGVtZTogb3B0cy5jb2x1bW5Qb3B1cFRoZW1lCgkJCQkJCX0pOwoJCQkJfQoJCQl9CgkJfSk7CgoJCS8vIHNldCBiaW5kaW5ncyBoZXJlCgkJaWYgKCAha2VlcCApIHsKCQkJdGhpcy5fYmluZFRvZ2dsZXMoIG1lbnUgKTsKCQl9Cgl9LAoKCV9tZW51SW5wdXRDaGFuZ2U6IGZ1bmN0aW9uKCBldnQgKSB7CgkJdmFyIGlucHV0ID0gJCggZXZ0LnRhcmdldCApLAoJCQljaGVja2VkID0gaW5wdXRbIDAgXS5jaGVja2VkOwoKCQlpbnB1dC5qcW1EYXRhKCAiY2VsbHMiICkKCQkJLnRvZ2dsZUNsYXNzKCAidWktdGFibGUtY2VsbC1oaWRkZW4iLCAhY2hlY2tlZCApCgkJCS50b2dnbGVDbGFzcyggInVpLXRhYmxlLWNlbGwtdmlzaWJsZSIsIGNoZWNrZWQgKTsKCgkJaWYgKCBpbnB1dFsgMCBdLmdldEF0dHJpYnV0ZSggImxvY2tlZCIgKSApIHsKCQkJaW5wdXQucmVtb3ZlQXR0ciggImxvY2tlZCIgKTsKCgkJCXRoaXMuX3VubG9ja0NlbGxzKCBpbnB1dC5qcW1EYXRhKCAiY2VsbHMiICkgKTsKCQl9IGVsc2UgewoJCQlpbnB1dC5hdHRyKCAibG9ja2VkIiwgdHJ1ZSApOwoJCX0KCX0sCgoJX3VubG9ja0NlbGxzOiBmdW5jdGlvbiggY2VsbHMgKSB7CgkJLy8gYWxsb3cgaGlkZS9zaG93IHZpYSBDU1Mgb25seSA9IHJlbW92ZSBhbGwgdG9nZ2xlLWxvY2tzCgkJY2VsbHMucmVtb3ZlQ2xhc3MoICJ1aS10YWJsZS1jZWxsLWhpZGRlbiB1aS10YWJsZS1jZWxsLXZpc2libGUiKTsKCX0sCgoJX2VuaGFuY2VDb2xUb2dnbGU6IGZ1bmN0aW9uKCkgewoJCXZhciBpZCAsIG1lbnVCdXR0b24sIHBvcHVwLCBtZW51LAoJCQl0YWJsZSA9IHRoaXMuZWxlbWVudCwKCQkJb3B0cyA9IHRoaXMub3B0aW9ucywKCQkJbnMgPSAkLm1vYmlsZS5ucywKCQkJZnJhZ21lbnQgPSB0aGlzLmRvY3VtZW50WyAwIF0uY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpOwoKCQlpZCA9IHRoaXMuX2lkKCkgKyAiLXBvcHVwIjsKCQltZW51QnV0dG9uID0gJCggIjxhIHJvbGU9J2J1dHRvbicgaHJlZj0nIyIgKyBpZCArICInICIgKwoJCQkiY2xhc3M9JyIgKyBvcHRzLmNsYXNzZXMuY29sdW1uQnRuICsgIiB1aS1idG4gdWktYnRuLSIgKyAoIG9wdHMuY29sdW1uQnRuVGhlbWUgfHwgImEiICkgKyAiIHVpLWNvcm5lci1hbGwgdWktc2hhZG93IHVpLW1pbmknICIgKwoJCQkiZGF0YS0iICsgbnMgKyAicmVsPSdwb3B1cCcgIiArCgkJCSJkYXRhLSIgKyBucyArICJtaW5pPSd0cnVlJz4iICsgb3B0cy5jb2x1bW5CdG5UZXh0ICsgIjwvYT4iICk7CgkJcG9wdXAgPSAkKCAiPGRpdiBkYXRhLSIgKyBucyArICJyb2xlPSdwb3B1cCcgZGF0YS0iICsgbnMgKyAicm9sZT0nZmllbGRjb250YWluJyBjbGFzcz0nIiArIG9wdHMuY2xhc3Nlcy5wb3B1cCArICInIGlkPSciICsgaWQgKyAiJz48L2Rpdj4iICk7CgkJbWVudSA9ICQoICI8ZmllbGRzZXQgZGF0YS0iICsgbnMgKyAicm9sZT0nY29udHJvbGdyb3VwJz48L2ZpZWxkc2V0PiIgKTsKCgkJLy8gc2V0IGV4dGVuc2lvbiBoZXJlLCBzZW5kICJmYWxzZSIgdG8gdHJpZ2dlciBidWlsZC9yZWJ1aWxkCgkJdGhpcy5fYWRkVG9nZ2xlcyggbWVudSwgZmFsc2UgKTsKCgkJbWVudS5hcHBlbmRUbyggcG9wdXAgKTsKCgkJZnJhZ21lbnQuYXBwZW5kQ2hpbGQoIHBvcHVwWyAwIF0gKTsKCQlmcmFnbWVudC5hcHBlbmRDaGlsZCggbWVudUJ1dHRvblsgMCBdICk7CgkJdGFibGUuYmVmb3JlKCBmcmFnbWVudCApOwoKCQlwb3B1cC5wb3B1cCgpLmVuaGFuY2VXaXRoaW4oKTsKCgkJcmV0dXJuIG1lbnU7Cgl9LAoKCXJlYnVpbGQ6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3N1cGVyKCk7CgoJCWlmICggdGhpcy5vcHRpb25zLm1vZGUgPT09ICJjb2x1bW50b2dnbGUiICkgewoJCQkvLyBOT1RFOiByZWJ1aWxkIHBhc3NlcyAiZmFsc2UiLCB3aGlsZSByZWZyZXNoIHBhc3NlcyAidW5kZWZpbmVkIgoJCQkvLyBib3RoIHJlZnJlc2ggdGhlIHRhYmxlLCBidXQgaW5zaWRlIGFkZFRvZ2dsZXMsICFmYWxzZSB3aWxsIGJlIHRydWUsCgkJCS8vIHNvIGEgcmVidWlsZCBjYWxsIGNhbiBiZSBpbmRlbnRpZmllZAoJCQl0aGlzLl9yZWZyZXNoKCBmYWxzZSApOwoJCX0KCX0sCgoJX3JlZnJlc2g6IGZ1bmN0aW9uKCBjcmVhdGUgKSB7CgkJdGhpcy5fc3VwZXIoIGNyZWF0ZSApOwoKCQlpZiAoICFjcmVhdGUgJiYgdGhpcy5vcHRpb25zLm1vZGUgPT09ICJjb2x1bW50b2dnbGUiICkgewoJCQkvLyBjb2x1bW5zIG5vdCBiZWluZyByZXBsYWNlZCBtdXN0IGJlIGNsZWFyZWQgZnJvbSBpbnB1dCB0b2dnbGUtbG9ja3MKCQkJdGhpcy5fdW5sb2NrQ2VsbHMoIHRoaXMuYWxsSGVhZGVycyApOwoKCQkJLy8gdXBkYXRlIGNvbHVtbnRvZ2dsZXMgYW5kIGNlbGxzCgkJCXRoaXMuX2FkZFRvZ2dsZXMoIHRoaXMuX21lbnUsIGNyZWF0ZSApOwoKCQkJLy8gY2hlY2svdW5jaGVjawoJCQl0aGlzLl9zZXRUb2dnbGVTdGF0ZSgpOwoJCX0KCX0sCgoJX3NldFRvZ2dsZVN0YXRlOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9tZW51LmZpbmQoICJpbnB1dCIgKS5lYWNoKCBmdW5jdGlvbigpIHsKCQkJdmFyIGNoZWNrYm94ID0gJCggdGhpcyApOwoKCQkJdGhpcy5jaGVja2VkID0gY2hlY2tib3guanFtRGF0YSggImNlbGxzIiApLmVxKCAwICkuY3NzKCAiZGlzcGxheSIgKSA9PT0gInRhYmxlLWNlbGwiOwoJCQljaGVja2JveC5jaGVja2JveHJhZGlvKCAicmVmcmVzaCIgKTsKCQl9KTsKCX0sCgoJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3N1cGVyKCk7Cgl9Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS50YWJsZSIsICQubW9iaWxlLnRhYmxlLCB7CglvcHRpb25zOiB7CgkJbW9kZTogInJlZmxvdyIsCgkJY2xhc3NlczogJC5leHRlbmQoICQubW9iaWxlLnRhYmxlLnByb3RvdHlwZS5vcHRpb25zLmNsYXNzZXMsIHsKCQkJcmVmbG93VGFibGU6ICJ1aS10YWJsZS1yZWZsb3ciLAoJCQljZWxsTGFiZWxzOiAidWktdGFibGUtY2VsbC1sYWJlbCIKCQl9KQoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9zdXBlcigpOwoKCQkvLyBJZiBpdCdzIG5vdCByZWZsb3cgbW9kZSwgcmV0dXJuIGhlcmUuCgkJaWYoIHRoaXMub3B0aW9ucy5tb2RlICE9PSAicmVmbG93IiApIHsKCQkJcmV0dXJuOwoJCX0KCgkJaWYoICF0aGlzLm9wdGlvbnMuZW5oYW5jZWQgKSB7CgkJCXRoaXMuZWxlbWVudC5hZGRDbGFzcyggdGhpcy5vcHRpb25zLmNsYXNzZXMucmVmbG93VGFibGUgKTsKCgkJCXRoaXMuX3VwZGF0ZVJlZmxvdygpOwoJCX0KCX0sCgoJcmVidWlsZDogZnVuY3Rpb24oKSB7CgkJdGhpcy5fc3VwZXIoKTsKCgkJaWYgKCB0aGlzLm9wdGlvbnMubW9kZSA9PT0gInJlZmxvdyIgKSB7CgkJCXRoaXMuX3JlZnJlc2goIGZhbHNlICk7CgkJfQoJfSwKCglfcmVmcmVzaDogZnVuY3Rpb24oIGNyZWF0ZSApIHsKCQl0aGlzLl9zdXBlciggY3JlYXRlICk7CgkJaWYgKCAhY3JlYXRlICYmIHRoaXMub3B0aW9ucy5tb2RlID09PSAicmVmbG93IiApIHsKCQkJdGhpcy5fdXBkYXRlUmVmbG93KCApOwoJCX0KCX0sCgoJX3VwZGF0ZVJlZmxvdzogZnVuY3Rpb24oKSB7CgkJdmFyIHRhYmxlID0gdGhpcywKCQkJb3B0cyA9IHRoaXMub3B0aW9uczsKCgkJLy8gZ2V0IGhlYWRlcnMgaW4gcmV2ZXJzZSBvcmRlciBzbyB0aGF0IHRvcC1sZXZlbCBoZWFkZXJzIGFyZSBhcHBlbmRlZCBsYXN0CgkJJCggdGFibGUuYWxsSGVhZGVycy5nZXQoKS5yZXZlcnNlKCkgKS5lYWNoKCBmdW5jdGlvbigpIHsKCQkJdmFyIGNlbGxzID0gJCggdGhpcyApLmpxbURhdGEoICJjZWxscyIgKSwKCQkJCWNvbHN0YXJ0ID0gJC5tb2JpbGUuZ2V0QXR0cmlidXRlKCB0aGlzLCAiY29sc3RhcnQiICksCgkJCQloaWVyYXJjaHlDbGFzcyA9IGNlbGxzLm5vdCggdGhpcyApLmZpbHRlciggInRoZWFkIHRoIiApLmxlbmd0aCAmJiAiIHVpLXRhYmxlLWNlbGwtbGFiZWwtdG9wIiwKCQkJCXRleHQgPSAkKCB0aGlzICkudGV4dCgpLAoJCQkJaXRlcmF0aW9uLCBmaWx0ZXI7CgoJCQkJaWYgKCB0ZXh0ICE9PSAiIiAgKSB7CgoJCQkJCWlmKCBoaWVyYXJjaHlDbGFzcyApIHsKCQkJCQkJaXRlcmF0aW9uID0gcGFyc2VJbnQoIHRoaXMuZ2V0QXR0cmlidXRlKCAiY29sc3BhbiIgKSwgMTAgKTsKCQkJCQkJZmlsdGVyID0gIiI7CgoJCQkJCQlpZiAoIGl0ZXJhdGlvbiApewoJCQkJCQkJZmlsdGVyID0gInRkOm50aC1jaGlsZCgiKyBpdGVyYXRpb24gKyJuICsgIiArICggY29sc3RhcnQgKSArIikiOwoJCQkJCQl9CgoJCQkJCQl0YWJsZS5fYWRkTGFiZWxzKCBjZWxscy5maWx0ZXIoIGZpbHRlciApLCBvcHRzLmNsYXNzZXMuY2VsbExhYmVscyArIGhpZXJhcmNoeUNsYXNzLCB0ZXh0ICk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJdGFibGUuX2FkZExhYmVscyggY2VsbHMsIG9wdHMuY2xhc3Nlcy5jZWxsTGFiZWxzLCB0ZXh0ICk7CgkJCQkJfQoKCQkJCX0KCQl9KTsKCX0sCgoJX2FkZExhYmVsczogZnVuY3Rpb24oIGNlbGxzLCBsYWJlbCwgdGV4dCApIHsKCQkvLyAubm90IGZpeGVzICM2MDA2CgkJY2VsbHMubm90KCAiOmhhcyhiLiIgKyBsYWJlbCArICIpIiApLnByZXBlbmQoICI8YiBjbGFzcz0nIiArIGxhYmVsICsgIic+IiArIHRleHQgKyAiPC9iPiIgICk7Cgl9Cn0pOwoKfSkoIGpRdWVyeSApOwoKLyohCiAqIGpRdWVyeSBVSSBUYWJzIEBWRVJTSU9OCiAqIGh0dHA6Ly9qcXVlcnl1aS5jb20KICoKICogQ29weXJpZ2h0IDIwMTMgalF1ZXJ5IEZvdW5kYXRpb24gYW5kIG90aGVyIGNvbnRyaWJ1dG9ycwogKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuCiAqIGh0dHA6Ly9qcXVlcnkub3JnL2xpY2Vuc2UKICoKICogaHR0cDovL2FwaS5qcXVlcnl1aS5jb20vdGFicy8KICoKICogRGVwZW5kczoKICoJanF1ZXJ5LnVpLmNvcmUuanMKICoJanF1ZXJ5LnVpLndpZGdldC5qcwogKi8KKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7Cgp2YXIgdGFiSWQgPSAwLAoJcmhhc2ggPSAvIy4qJC87CgpmdW5jdGlvbiBnZXROZXh0VGFiSWQoKSB7CglyZXR1cm4gKyt0YWJJZDsKfQoKZnVuY3Rpb24gaXNMb2NhbCggYW5jaG9yICkgewoJcmV0dXJuIGFuY2hvci5oYXNoLmxlbmd0aCA+IDEgJiYKCQlkZWNvZGVVUklDb21wb25lbnQoIGFuY2hvci5ocmVmLnJlcGxhY2UoIHJoYXNoLCAiIiApICkgPT09CgkJCWRlY29kZVVSSUNvbXBvbmVudCggbG9jYXRpb24uaHJlZi5yZXBsYWNlKCByaGFzaCwgIiIgKSApOwp9CgokLndpZGdldCggInVpLnRhYnMiLCB7Cgl2ZXJzaW9uOiAiQFZFUlNJT04iLAoJZGVsYXk6IDMwMCwKCW9wdGlvbnM6IHsKCQlhY3RpdmU6IG51bGwsCgkJY29sbGFwc2libGU6IGZhbHNlLAoJCWV2ZW50OiAiY2xpY2siLAoJCWhlaWdodFN0eWxlOiAiY29udGVudCIsCgkJaGlkZTogbnVsbCwKCQlzaG93OiBudWxsLAoKCQkvLyBjYWxsYmFja3MKCQlhY3RpdmF0ZTogbnVsbCwKCQliZWZvcmVBY3RpdmF0ZTogbnVsbCwKCQliZWZvcmVMb2FkOiBudWxsLAoJCWxvYWQ6IG51bGwKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdmFyIHRoYXQgPSB0aGlzLAoJCQlvcHRpb25zID0gdGhpcy5vcHRpb25zOwoKCQl0aGlzLnJ1bm5pbmcgPSBmYWxzZTsKCgkJdGhpcy5lbGVtZW50CgkJCS5hZGRDbGFzcyggInVpLXRhYnMgdWktd2lkZ2V0IHVpLXdpZGdldC1jb250ZW50IHVpLWNvcm5lci1hbGwiICkKCQkJLnRvZ2dsZUNsYXNzKCAidWktdGFicy1jb2xsYXBzaWJsZSIsIG9wdGlvbnMuY29sbGFwc2libGUgKQoJCQkvLyBQcmV2ZW50IHVzZXJzIGZyb20gZm9jdXNpbmcgZGlzYWJsZWQgdGFicyB2aWEgY2xpY2sKCQkJLmRlbGVnYXRlKCAiLnVpLXRhYnMtbmF2ID4gbGkiLCAibW91c2Vkb3duIiArIHRoaXMuZXZlbnROYW1lc3BhY2UsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCWlmICggJCggdGhpcyApLmlzKCAiLnVpLXN0YXRlLWRpc2FibGVkIiApICkgewoJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQl9CgkJCX0pCgkJCS8vIHN1cHBvcnQ6IElFIDw5CgkJCS8vIFByZXZlbnRpbmcgdGhlIGRlZmF1bHQgYWN0aW9uIGluIG1vdXNlZG93biBkb2Vzbid0IHByZXZlbnQgSUUKCQkJLy8gZnJvbSBmb2N1c2luZyB0aGUgZWxlbWVudCwgc28gaWYgdGhlIGFuY2hvciBnZXRzIGZvY3VzZWQsIGJsdXIuCgkJCS8vIFdlIGRvbid0IGhhdmUgdG8gd29ycnkgYWJvdXQgZm9jdXNpbmcgdGhlIHByZXZpb3VzbHkgZm9jdXNlZAoJCQkvLyBlbGVtZW50IHNpbmNlIGNsaWNraW5nIG9uIGEgbm9uLWZvY3VzYWJsZSBlbGVtZW50IHNob3VsZCBmb2N1cwoJCQkvLyB0aGUgYm9keSBhbnl3YXkuCgkJCS5kZWxlZ2F0ZSggIi51aS10YWJzLWFuY2hvciIsICJmb2N1cyIgKyB0aGlzLmV2ZW50TmFtZXNwYWNlLCBmdW5jdGlvbigpIHsKCQkJCWlmICggJCggdGhpcyApLmNsb3Nlc3QoICJsaSIgKS5pcyggIi51aS1zdGF0ZS1kaXNhYmxlZCIgKSApIHsKCQkJCQl0aGlzLmJsdXIoKTsKCQkJCX0KCQkJfSk7CgoJCXRoaXMuX3Byb2Nlc3NUYWJzKCk7CgkJb3B0aW9ucy5hY3RpdmUgPSB0aGlzLl9pbml0aWFsQWN0aXZlKCk7CgoJCS8vIFRha2UgZGlzYWJsaW5nIHRhYnMgdmlhIGNsYXNzIGF0dHJpYnV0ZSBmcm9tIEhUTUwKCQkvLyBpbnRvIGFjY291bnQgYW5kIHVwZGF0ZSBvcHRpb24gcHJvcGVybHkuCgkJaWYgKCAkLmlzQXJyYXkoIG9wdGlvbnMuZGlzYWJsZWQgKSApIHsKCQkJb3B0aW9ucy5kaXNhYmxlZCA9ICQudW5pcXVlKCBvcHRpb25zLmRpc2FibGVkLmNvbmNhdCgKCQkJCSQubWFwKCB0aGlzLnRhYnMuZmlsdGVyKCAiLnVpLXN0YXRlLWRpc2FibGVkIiApLCBmdW5jdGlvbiggbGkgKSB7CgkJCQkJcmV0dXJuIHRoYXQudGFicy5pbmRleCggbGkgKTsKCQkJCX0pCgkJCSkgKS5zb3J0KCk7CgkJfQoKCQkvLyBjaGVjayBmb3IgbGVuZ3RoIGF2b2lkcyBlcnJvciB3aGVuIGluaXRpYWxpemluZyBlbXB0eSBsaXN0CgkJaWYgKCB0aGlzLm9wdGlvbnMuYWN0aXZlICE9PSBmYWxzZSAmJiB0aGlzLmFuY2hvcnMubGVuZ3RoICkgewoJCQl0aGlzLmFjdGl2ZSA9IHRoaXMuX2ZpbmRBY3RpdmUoIG9wdGlvbnMuYWN0aXZlICk7CgkJfSBlbHNlIHsKCQkJdGhpcy5hY3RpdmUgPSAkKCk7CgkJfQoKCQl0aGlzLl9yZWZyZXNoKCk7CgoJCWlmICggdGhpcy5hY3RpdmUubGVuZ3RoICkgewoJCQl0aGlzLmxvYWQoIG9wdGlvbnMuYWN0aXZlICk7CgkJfQoJfSwKCglfaW5pdGlhbEFjdGl2ZTogZnVuY3Rpb24oKSB7CgkJdmFyIGFjdGl2ZSA9IHRoaXMub3B0aW9ucy5hY3RpdmUsCgkJCWNvbGxhcHNpYmxlID0gdGhpcy5vcHRpb25zLmNvbGxhcHNpYmxlLAoJCQlsb2NhdGlvbkhhc2ggPSBsb2NhdGlvbi5oYXNoLnN1YnN0cmluZyggMSApOwoKCQlpZiAoIGFjdGl2ZSA9PT0gbnVsbCApIHsKCQkJLy8gY2hlY2sgdGhlIGZyYWdtZW50IGlkZW50aWZpZXIgaW4gdGhlIFVSTAoJCQlpZiAoIGxvY2F0aW9uSGFzaCApIHsKCQkJCXRoaXMudGFicy5lYWNoKGZ1bmN0aW9uKCBpLCB0YWIgKSB7CgkJCQkJaWYgKCAkKCB0YWIgKS5hdHRyKCAiYXJpYS1jb250cm9scyIgKSA9PT0gbG9jYXRpb25IYXNoICkgewoJCQkJCQlhY3RpdmUgPSBpOwoJCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQkJfQoJCQkJfSk7CgkJCX0KCgkJCS8vIGNoZWNrIGZvciBhIHRhYiBtYXJrZWQgYWN0aXZlIHZpYSBhIGNsYXNzCgkJCWlmICggYWN0aXZlID09PSBudWxsICkgewoJCQkJYWN0aXZlID0gdGhpcy50YWJzLmluZGV4KCB0aGlzLnRhYnMuZmlsdGVyKCAiLnVpLXRhYnMtYWN0aXZlIiApICk7CgkJCX0KCgkJCS8vIG5vIGFjdGl2ZSB0YWIsIHNldCB0byBmYWxzZQoJCQlpZiAoIGFjdGl2ZSA9PT0gbnVsbCB8fCBhY3RpdmUgPT09IC0xICkgewoJCQkJYWN0aXZlID0gdGhpcy50YWJzLmxlbmd0aCA/IDAgOiBmYWxzZTsKCQkJfQoJCX0KCgkJLy8gaGFuZGxlIG51bWJlcnM6IG5lZ2F0aXZlLCBvdXQgb2YgcmFuZ2UKCQlpZiAoIGFjdGl2ZSAhPT0gZmFsc2UgKSB7CgkJCWFjdGl2ZSA9IHRoaXMudGFicy5pbmRleCggdGhpcy50YWJzLmVxKCBhY3RpdmUgKSApOwoJCQlpZiAoIGFjdGl2ZSA9PT0gLTEgKSB7CgkJCQlhY3RpdmUgPSBjb2xsYXBzaWJsZSA/IGZhbHNlIDogMDsKCQkJfQoJCX0KCgkJLy8gZG9uJ3QgYWxsb3cgY29sbGFwc2libGU6IGZhbHNlIGFuZCBhY3RpdmU6IGZhbHNlCgkJaWYgKCAhY29sbGFwc2libGUgJiYgYWN0aXZlID09PSBmYWxzZSAmJiB0aGlzLmFuY2hvcnMubGVuZ3RoICkgewoJCQlhY3RpdmUgPSAwOwoJCX0KCgkJcmV0dXJuIGFjdGl2ZTsKCX0sCgoJX2dldENyZWF0ZUV2ZW50RGF0YTogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHsKCQkJdGFiOiB0aGlzLmFjdGl2ZSwKCQkJcGFuZWw6ICF0aGlzLmFjdGl2ZS5sZW5ndGggPyAkKCkgOiB0aGlzLl9nZXRQYW5lbEZvclRhYiggdGhpcy5hY3RpdmUgKQoJCX07Cgl9LAoKCV90YWJLZXlkb3duOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJdmFyIGZvY3VzZWRUYWIgPSAkKCB0aGlzLmRvY3VtZW50WzBdLmFjdGl2ZUVsZW1lbnQgKS5jbG9zZXN0KCAibGkiICksCgkJCXNlbGVjdGVkSW5kZXggPSB0aGlzLnRhYnMuaW5kZXgoIGZvY3VzZWRUYWIgKSwKCQkJZ29pbmdGb3J3YXJkID0gdHJ1ZTsKCgkJaWYgKCB0aGlzLl9oYW5kbGVQYWdlTmF2KCBldmVudCApICkgewoJCQlyZXR1cm47CgkJfQoKCQlzd2l0Y2ggKCBldmVudC5rZXlDb2RlICkgewoJCQljYXNlICQudWkua2V5Q29kZS5SSUdIVDoKCQkJY2FzZSAkLnVpLmtleUNvZGUuRE9XTjoKCQkJCXNlbGVjdGVkSW5kZXgrKzsKCQkJCWJyZWFrOwoJCQljYXNlICQudWkua2V5Q29kZS5VUDoKCQkJY2FzZSAkLnVpLmtleUNvZGUuTEVGVDoKCQkJCWdvaW5nRm9yd2FyZCA9IGZhbHNlOwoJCQkJc2VsZWN0ZWRJbmRleC0tOwoJCQkJYnJlYWs7CgkJCWNhc2UgJC51aS5rZXlDb2RlLkVORDoKCQkJCXNlbGVjdGVkSW5kZXggPSB0aGlzLmFuY2hvcnMubGVuZ3RoIC0gMTsKCQkJCWJyZWFrOwoJCQljYXNlICQudWkua2V5Q29kZS5IT01FOgoJCQkJc2VsZWN0ZWRJbmRleCA9IDA7CgkJCQlicmVhazsKCQkJY2FzZSAkLnVpLmtleUNvZGUuU1BBQ0U6CgkJCQkvLyBBY3RpdmF0ZSBvbmx5LCBubyBjb2xsYXBzaW5nCgkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJY2xlYXJUaW1lb3V0KCB0aGlzLmFjdGl2YXRpbmcgKTsKCQkJCXRoaXMuX2FjdGl2YXRlKCBzZWxlY3RlZEluZGV4ICk7CgkJCQlyZXR1cm47CgkJCWNhc2UgJC51aS5rZXlDb2RlLkVOVEVSOgoJCQkJLy8gVG9nZ2xlIChjYW5jZWwgZGVsYXllZCBhY3RpdmF0aW9uLCBhbGxvdyBjb2xsYXBzaW5nKQoJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCWNsZWFyVGltZW91dCggdGhpcy5hY3RpdmF0aW5nICk7CgkJCQkvLyBEZXRlcm1pbmUgaWYgd2Ugc2hvdWxkIGNvbGxhcHNlIG9yIGFjdGl2YXRlCgkJCQl0aGlzLl9hY3RpdmF0ZSggc2VsZWN0ZWRJbmRleCA9PT0gdGhpcy5vcHRpb25zLmFjdGl2ZSA/IGZhbHNlIDogc2VsZWN0ZWRJbmRleCApOwoJCQkJcmV0dXJuOwoJCQlkZWZhdWx0OgoJCQkJcmV0dXJuOwoJCX0KCgkJLy8gRm9jdXMgdGhlIGFwcHJvcHJpYXRlIHRhYiwgYmFzZWQgb24gd2hpY2gga2V5IHdhcyBwcmVzc2VkCgkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQljbGVhclRpbWVvdXQoIHRoaXMuYWN0aXZhdGluZyApOwoJCXNlbGVjdGVkSW5kZXggPSB0aGlzLl9mb2N1c05leHRUYWIoIHNlbGVjdGVkSW5kZXgsIGdvaW5nRm9yd2FyZCApOwoKCQkvLyBOYXZpZ2F0aW5nIHdpdGggY29udHJvbCBrZXkgd2lsbCBwcmV2ZW50IGF1dG9tYXRpYyBhY3RpdmF0aW9uCgkJaWYgKCAhZXZlbnQuY3RybEtleSApIHsKCQkJLy8gVXBkYXRlIGFyaWEtc2VsZWN0ZWQgaW1tZWRpYXRlbHkgc28gdGhhdCBBVCB0aGluayB0aGUgdGFiIGlzIGFscmVhZHkgc2VsZWN0ZWQuCgkJCS8vIE90aGVyd2lzZSBBVCBtYXkgY29uZnVzZSB0aGUgdXNlciBieSBzdGF0aW5nIHRoYXQgdGhleSBuZWVkIHRvIGFjdGl2YXRlIHRoZSB0YWIsCgkJCS8vIGJ1dCB0aGUgdGFiIHdpbGwgYWxyZWFkeSBiZSBhY3RpdmF0ZWQgYnkgdGhlIHRpbWUgdGhlIGFubm91bmNlbWVudCBmaW5pc2hlcy4KCQkJZm9jdXNlZFRhYi5hdHRyKCAiYXJpYS1zZWxlY3RlZCIsICJmYWxzZSIgKTsKCQkJdGhpcy50YWJzLmVxKCBzZWxlY3RlZEluZGV4ICkuYXR0ciggImFyaWEtc2VsZWN0ZWQiLCAidHJ1ZSIgKTsKCgkJCXRoaXMuYWN0aXZhdGluZyA9IHRoaXMuX2RlbGF5KGZ1bmN0aW9uKCkgewoJCQkJdGhpcy5vcHRpb24oICJhY3RpdmUiLCBzZWxlY3RlZEluZGV4ICk7CgkJCX0sIHRoaXMuZGVsYXkgKTsKCQl9Cgl9LAoKCV9wYW5lbEtleWRvd246IGZ1bmN0aW9uKCBldmVudCApIHsKCQlpZiAoIHRoaXMuX2hhbmRsZVBhZ2VOYXYoIGV2ZW50ICkgKSB7CgkJCXJldHVybjsKCQl9CgoJCS8vIEN0cmwrdXAgbW92ZXMgZm9jdXMgdG8gdGhlIGN1cnJlbnQgdGFiCgkJaWYgKCBldmVudC5jdHJsS2V5ICYmIGV2ZW50LmtleUNvZGUgPT09ICQudWkua2V5Q29kZS5VUCApIHsKCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJdGhpcy5hY3RpdmUuZm9jdXMoKTsKCQl9Cgl9LAoKCS8vIEFsdCtwYWdlIHVwL2Rvd24gbW92ZXMgZm9jdXMgdG8gdGhlIHByZXZpb3VzL25leHQgdGFiIChhbmQgYWN0aXZhdGVzKQoJX2hhbmRsZVBhZ2VOYXY6IGZ1bmN0aW9uKCBldmVudCApIHsKCQlpZiAoIGV2ZW50LmFsdEtleSAmJiBldmVudC5rZXlDb2RlID09PSAkLnVpLmtleUNvZGUuUEFHRV9VUCApIHsKCQkJdGhpcy5fYWN0aXZhdGUoIHRoaXMuX2ZvY3VzTmV4dFRhYiggdGhpcy5vcHRpb25zLmFjdGl2ZSAtIDEsIGZhbHNlICkgKTsKCQkJcmV0dXJuIHRydWU7CgkJfQoJCWlmICggZXZlbnQuYWx0S2V5ICYmIGV2ZW50LmtleUNvZGUgPT09ICQudWkua2V5Q29kZS5QQUdFX0RPV04gKSB7CgkJCXRoaXMuX2FjdGl2YXRlKCB0aGlzLl9mb2N1c05leHRUYWIoIHRoaXMub3B0aW9ucy5hY3RpdmUgKyAxLCB0cnVlICkgKTsKCQkJcmV0dXJuIHRydWU7CgkJfQoJfSwKCglfZmluZE5leHRUYWI6IGZ1bmN0aW9uKCBpbmRleCwgZ29pbmdGb3J3YXJkICkgewoJCXZhciBsYXN0VGFiSW5kZXggPSB0aGlzLnRhYnMubGVuZ3RoIC0gMTsKCgkJZnVuY3Rpb24gY29uc3RyYWluKCkgewoJCQlpZiAoIGluZGV4ID4gbGFzdFRhYkluZGV4ICkgewoJCQkJaW5kZXggPSAwOwoJCQl9CgkJCWlmICggaW5kZXggPCAwICkgewoJCQkJaW5kZXggPSBsYXN0VGFiSW5kZXg7CgkJCX0KCQkJcmV0dXJuIGluZGV4OwoJCX0KCgkJd2hpbGUgKCAkLmluQXJyYXkoIGNvbnN0cmFpbigpLCB0aGlzLm9wdGlvbnMuZGlzYWJsZWQgKSAhPT0gLTEgKSB7CgkJCWluZGV4ID0gZ29pbmdGb3J3YXJkID8gaW5kZXggKyAxIDogaW5kZXggLSAxOwoJCX0KCgkJcmV0dXJuIGluZGV4OwoJfSwKCglfZm9jdXNOZXh0VGFiOiBmdW5jdGlvbiggaW5kZXgsIGdvaW5nRm9yd2FyZCApIHsKCQlpbmRleCA9IHRoaXMuX2ZpbmROZXh0VGFiKCBpbmRleCwgZ29pbmdGb3J3YXJkICk7CgkJdGhpcy50YWJzLmVxKCBpbmRleCApLmZvY3VzKCk7CgkJcmV0dXJuIGluZGV4OwoJfSwKCglfc2V0T3B0aW9uOiBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQlpZiAoIGtleSA9PT0gImFjdGl2ZSIgKSB7CgkJCS8vIF9hY3RpdmF0ZSgpIHdpbGwgaGFuZGxlIGludmFsaWQgdmFsdWVzIGFuZCB1cGRhdGUgdGhpcy5vcHRpb25zCgkJCXRoaXMuX2FjdGl2YXRlKCB2YWx1ZSApOwoJCQlyZXR1cm47CgkJfQoKCQlpZiAoIGtleSA9PT0gImRpc2FibGVkIiApIHsKCQkJLy8gZG9uJ3QgdXNlIHRoZSB3aWRnZXQgZmFjdG9yeSdzIGRpc2FibGVkIGhhbmRsaW5nCgkJCXRoaXMuX3NldHVwRGlzYWJsZWQoIHZhbHVlICk7CgkJCXJldHVybjsKCQl9CgoJCXRoaXMuX3N1cGVyKCBrZXksIHZhbHVlKTsKCgkJaWYgKCBrZXkgPT09ICJjb2xsYXBzaWJsZSIgKSB7CgkJCXRoaXMuZWxlbWVudC50b2dnbGVDbGFzcyggInVpLXRhYnMtY29sbGFwc2libGUiLCB2YWx1ZSApOwoJCQkvLyBTZXR0aW5nIGNvbGxhcHNpYmxlOiBmYWxzZSB3aGlsZSBjb2xsYXBzZWQ7IG9wZW4gZmlyc3QgcGFuZWwKCQkJaWYgKCAhdmFsdWUgJiYgdGhpcy5vcHRpb25zLmFjdGl2ZSA9PT0gZmFsc2UgKSB7CgkJCQl0aGlzLl9hY3RpdmF0ZSggMCApOwoJCQl9CgkJfQoKCQlpZiAoIGtleSA9PT0gImV2ZW50IiApIHsKCQkJdGhpcy5fc2V0dXBFdmVudHMoIHZhbHVlICk7CgkJfQoKCQlpZiAoIGtleSA9PT0gImhlaWdodFN0eWxlIiApIHsKCQkJdGhpcy5fc2V0dXBIZWlnaHRTdHlsZSggdmFsdWUgKTsKCQl9Cgl9LAoKCV90YWJJZDogZnVuY3Rpb24oIHRhYiApIHsKCQlyZXR1cm4gdGFiLmF0dHIoICJhcmlhLWNvbnRyb2xzIiApIHx8ICJ1aS10YWJzLSIgKyBnZXROZXh0VGFiSWQoKTsKCX0sCgoJX3Nhbml0aXplU2VsZWN0b3I6IGZ1bmN0aW9uKCBoYXNoICkgewoJCXJldHVybiBoYXNoID8gaGFzaC5yZXBsYWNlKCAvWyEiJCUmJygpKissLlwvOjs8PT4/QFxbXF1cXmB7fH1+XS9nLCAiXFwkJiIgKSA6ICIiOwoJfSwKCglyZWZyZXNoOiBmdW5jdGlvbigpIHsKCQl2YXIgb3B0aW9ucyA9IHRoaXMub3B0aW9ucywKCQkJbGlzID0gdGhpcy50YWJsaXN0LmNoaWxkcmVuKCAiOmhhcyhhW2hyZWZdKSIgKTsKCgkJLy8gZ2V0IGRpc2FibGVkIHRhYnMgZnJvbSBjbGFzcyBhdHRyaWJ1dGUgZnJvbSBIVE1MCgkJLy8gdGhpcyB3aWxsIGdldCBjb252ZXJ0ZWQgdG8gYSBib29sZWFuIGlmIG5lZWRlZCBpbiBfcmVmcmVzaCgpCgkJb3B0aW9ucy5kaXNhYmxlZCA9ICQubWFwKCBsaXMuZmlsdGVyKCAiLnVpLXN0YXRlLWRpc2FibGVkIiApLCBmdW5jdGlvbiggdGFiICkgewoJCQlyZXR1cm4gbGlzLmluZGV4KCB0YWIgKTsKCQl9KTsKCgkJdGhpcy5fcHJvY2Vzc1RhYnMoKTsKCgkJLy8gd2FzIGNvbGxhcHNlZCBvciBubyB0YWJzCgkJaWYgKCBvcHRpb25zLmFjdGl2ZSA9PT0gZmFsc2UgfHwgIXRoaXMuYW5jaG9ycy5sZW5ndGggKSB7CgkJCW9wdGlvbnMuYWN0aXZlID0gZmFsc2U7CgkJCXRoaXMuYWN0aXZlID0gJCgpOwoJCS8vIHdhcyBhY3RpdmUsIGJ1dCBhY3RpdmUgdGFiIGlzIGdvbmUKCQl9IGVsc2UgaWYgKCB0aGlzLmFjdGl2ZS5sZW5ndGggJiYgISQuY29udGFpbnMoIHRoaXMudGFibGlzdFsgMCBdLCB0aGlzLmFjdGl2ZVsgMCBdICkgKSB7CgkJCS8vIGFsbCByZW1haW5pbmcgdGFicyBhcmUgZGlzYWJsZWQKCQkJaWYgKCB0aGlzLnRhYnMubGVuZ3RoID09PSBvcHRpb25zLmRpc2FibGVkLmxlbmd0aCApIHsKCQkJCW9wdGlvbnMuYWN0aXZlID0gZmFsc2U7CgkJCQl0aGlzLmFjdGl2ZSA9ICQoKTsKCQkJLy8gYWN0aXZhdGUgcHJldmlvdXMgdGFiCgkJCX0gZWxzZSB7CgkJCQl0aGlzLl9hY3RpdmF0ZSggdGhpcy5fZmluZE5leHRUYWIoIE1hdGgubWF4KCAwLCBvcHRpb25zLmFjdGl2ZSAtIDEgKSwgZmFsc2UgKSApOwoJCQl9CgkJLy8gd2FzIGFjdGl2ZSwgYWN0aXZlIHRhYiBzdGlsbCBleGlzdHMKCQl9IGVsc2UgewoJCQkvLyBtYWtlIHN1cmUgYWN0aXZlIGluZGV4IGlzIGNvcnJlY3QKCQkJb3B0aW9ucy5hY3RpdmUgPSB0aGlzLnRhYnMuaW5kZXgoIHRoaXMuYWN0aXZlICk7CgkJfQoKCQl0aGlzLl9yZWZyZXNoKCk7Cgl9LAoKCV9yZWZyZXNoOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9zZXR1cERpc2FibGVkKCB0aGlzLm9wdGlvbnMuZGlzYWJsZWQgKTsKCQl0aGlzLl9zZXR1cEV2ZW50cyggdGhpcy5vcHRpb25zLmV2ZW50ICk7CgkJdGhpcy5fc2V0dXBIZWlnaHRTdHlsZSggdGhpcy5vcHRpb25zLmhlaWdodFN0eWxlICk7CgoJCXRoaXMudGFicy5ub3QoIHRoaXMuYWN0aXZlICkuYXR0cih7CgkJCSJhcmlhLXNlbGVjdGVkIjogImZhbHNlIiwKCQkJdGFiSW5kZXg6IC0xCgkJfSk7CgkJdGhpcy5wYW5lbHMubm90KCB0aGlzLl9nZXRQYW5lbEZvclRhYiggdGhpcy5hY3RpdmUgKSApCgkJCS5oaWRlKCkKCQkJLmF0dHIoewoJCQkJImFyaWEtZXhwYW5kZWQiOiAiZmFsc2UiLAoJCQkJImFyaWEtaGlkZGVuIjogInRydWUiCgkJCX0pOwoKCQkvLyBNYWtlIHN1cmUgb25lIHRhYiBpcyBpbiB0aGUgdGFiIG9yZGVyCgkJaWYgKCAhdGhpcy5hY3RpdmUubGVuZ3RoICkgewoJCQl0aGlzLnRhYnMuZXEoIDAgKS5hdHRyKCAidGFiSW5kZXgiLCAwICk7CgkJfSBlbHNlIHsKCQkJdGhpcy5hY3RpdmUKCQkJCS5hZGRDbGFzcyggInVpLXRhYnMtYWN0aXZlIHVpLXN0YXRlLWFjdGl2ZSIgKQoJCQkJLmF0dHIoewoJCQkJCSJhcmlhLXNlbGVjdGVkIjogInRydWUiLAoJCQkJCXRhYkluZGV4OiAwCgkJCQl9KTsKCQkJdGhpcy5fZ2V0UGFuZWxGb3JUYWIoIHRoaXMuYWN0aXZlICkKCQkJCS5zaG93KCkKCQkJCS5hdHRyKHsKCQkJCQkiYXJpYS1leHBhbmRlZCI6ICJ0cnVlIiwKCQkJCQkiYXJpYS1oaWRkZW4iOiAiZmFsc2UiCgkJCQl9KTsKCQl9Cgl9LAoKCV9wcm9jZXNzVGFiczogZnVuY3Rpb24oKSB7CgkJdmFyIHRoYXQgPSB0aGlzOwoKCQl0aGlzLnRhYmxpc3QgPSB0aGlzLl9nZXRMaXN0KCkKCQkJLmFkZENsYXNzKCAidWktdGFicy1uYXYgdWktaGVscGVyLXJlc2V0IHVpLWhlbHBlci1jbGVhcmZpeCB1aS13aWRnZXQtaGVhZGVyIHVpLWNvcm5lci1hbGwiICkKCQkJLmF0dHIoICJyb2xlIiwgInRhYmxpc3QiICk7CgoJCXRoaXMudGFicyA9IHRoaXMudGFibGlzdC5maW5kKCAiPiBsaTpoYXMoYVtocmVmXSkiICkKCQkJLmFkZENsYXNzKCAidWktc3RhdGUtZGVmYXVsdCB1aS1jb3JuZXItdG9wIiApCgkJCS5hdHRyKHsKCQkJCXJvbGU6ICJ0YWIiLAoJCQkJdGFiSW5kZXg6IC0xCgkJCX0pOwoKCQl0aGlzLmFuY2hvcnMgPSB0aGlzLnRhYnMubWFwKGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuICQoICJhIiwgdGhpcyApWyAwIF07CgkJCX0pCgkJCS5hZGRDbGFzcyggInVpLXRhYnMtYW5jaG9yIiApCgkJCS5hdHRyKHsKCQkJCXJvbGU6ICJwcmVzZW50YXRpb24iLAoJCQkJdGFiSW5kZXg6IC0xCgkJCX0pOwoKCQl0aGlzLnBhbmVscyA9ICQoKTsKCgkJdGhpcy5hbmNob3JzLmVhY2goZnVuY3Rpb24oIGksIGFuY2hvciApIHsKCQkJdmFyIHNlbGVjdG9yLCBwYW5lbCwgcGFuZWxJZCwKCQkJCWFuY2hvcklkID0gJCggYW5jaG9yICkudW5pcXVlSWQoKS5hdHRyKCAiaWQiICksCgkJCQl0YWIgPSAkKCBhbmNob3IgKS5jbG9zZXN0KCAibGkiICksCgkJCQlvcmlnaW5hbEFyaWFDb250cm9scyA9IHRhYi5hdHRyKCAiYXJpYS1jb250cm9scyIgKTsKCgkJCS8vIGlubGluZSB0YWIKCQkJaWYgKCBpc0xvY2FsKCBhbmNob3IgKSApIHsKCQkJCXNlbGVjdG9yID0gYW5jaG9yLmhhc2g7CgkJCQlwYW5lbCA9IHRoYXQuZWxlbWVudC5maW5kKCB0aGF0Ll9zYW5pdGl6ZVNlbGVjdG9yKCBzZWxlY3RvciApICk7CgkJCS8vIHJlbW90ZSB0YWIKCQkJfSBlbHNlIHsKCQkJCXBhbmVsSWQgPSB0aGF0Ll90YWJJZCggdGFiICk7CgkJCQlzZWxlY3RvciA9ICIjIiArIHBhbmVsSWQ7CgkJCQlwYW5lbCA9IHRoYXQuZWxlbWVudC5maW5kKCBzZWxlY3RvciApOwoJCQkJaWYgKCAhcGFuZWwubGVuZ3RoICkgewoJCQkJCXBhbmVsID0gdGhhdC5fY3JlYXRlUGFuZWwoIHBhbmVsSWQgKTsKCQkJCQlwYW5lbC5pbnNlcnRBZnRlciggdGhhdC5wYW5lbHNbIGkgLSAxIF0gfHwgdGhhdC50YWJsaXN0ICk7CgkJCQl9CgkJCQlwYW5lbC5hdHRyKCAiYXJpYS1saXZlIiwgInBvbGl0ZSIgKTsKCQkJfQoKCQkJaWYgKCBwYW5lbC5sZW5ndGgpIHsKCQkJCXRoYXQucGFuZWxzID0gdGhhdC5wYW5lbHMuYWRkKCBwYW5lbCApOwoJCQl9CgkJCWlmICggb3JpZ2luYWxBcmlhQ29udHJvbHMgKSB7CgkJCQl0YWIuZGF0YSggInVpLXRhYnMtYXJpYS1jb250cm9scyIsIG9yaWdpbmFsQXJpYUNvbnRyb2xzICk7CgkJCX0KCQkJdGFiLmF0dHIoewoJCQkJImFyaWEtY29udHJvbHMiOiBzZWxlY3Rvci5zdWJzdHJpbmcoIDEgKSwKCQkJCSJhcmlhLWxhYmVsbGVkYnkiOiBhbmNob3JJZAoJCQl9KTsKCQkJcGFuZWwuYXR0ciggImFyaWEtbGFiZWxsZWRieSIsIGFuY2hvcklkICk7CgkJfSk7CgoJCXRoaXMucGFuZWxzCgkJCS5hZGRDbGFzcyggInVpLXRhYnMtcGFuZWwgdWktd2lkZ2V0LWNvbnRlbnQgdWktY29ybmVyLWJvdHRvbSIgKQoJCQkuYXR0ciggInJvbGUiLCAidGFicGFuZWwiICk7Cgl9LAoKCS8vIGFsbG93IG92ZXJyaWRpbmcgaG93IHRvIGZpbmQgdGhlIGxpc3QgZm9yIHJhcmUgdXNhZ2Ugc2NlbmFyaW9zICgjNzcxNSkKCV9nZXRMaXN0OiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5lbGVtZW50LmZpbmQoICJvbCx1bCIgKS5lcSggMCApOwoJfSwKCglfY3JlYXRlUGFuZWw6IGZ1bmN0aW9uKCBpZCApIHsKCQlyZXR1cm4gJCggIjxkaXY+IiApCgkJCS5hdHRyKCAiaWQiLCBpZCApCgkJCS5hZGRDbGFzcyggInVpLXRhYnMtcGFuZWwgdWktd2lkZ2V0LWNvbnRlbnQgdWktY29ybmVyLWJvdHRvbSIgKQoJCQkuZGF0YSggInVpLXRhYnMtZGVzdHJveSIsIHRydWUgKTsKCX0sCgoJX3NldHVwRGlzYWJsZWQ6IGZ1bmN0aW9uKCBkaXNhYmxlZCApIHsKCQlpZiAoICQuaXNBcnJheSggZGlzYWJsZWQgKSApIHsKCQkJaWYgKCAhZGlzYWJsZWQubGVuZ3RoICkgewoJCQkJZGlzYWJsZWQgPSBmYWxzZTsKCQkJfSBlbHNlIGlmICggZGlzYWJsZWQubGVuZ3RoID09PSB0aGlzLmFuY2hvcnMubGVuZ3RoICkgewoJCQkJZGlzYWJsZWQgPSB0cnVlOwoJCQl9CgkJfQoKCQkvLyBkaXNhYmxlIHRhYnMKCQlmb3IgKCB2YXIgaSA9IDAsIGxpOyAoIGxpID0gdGhpcy50YWJzWyBpIF0gKTsgaSsrICkgewoJCQlpZiAoIGRpc2FibGVkID09PSB0cnVlIHx8ICQuaW5BcnJheSggaSwgZGlzYWJsZWQgKSAhPT0gLTEgKSB7CgkJCQkkKCBsaSApCgkJCQkJLmFkZENsYXNzKCAidWktc3RhdGUtZGlzYWJsZWQiICkKCQkJCQkuYXR0ciggImFyaWEtZGlzYWJsZWQiLCAidHJ1ZSIgKTsKCQkJfSBlbHNlIHsKCQkJCSQoIGxpICkKCQkJCQkucmVtb3ZlQ2xhc3MoICJ1aS1zdGF0ZS1kaXNhYmxlZCIgKQoJCQkJCS5yZW1vdmVBdHRyKCAiYXJpYS1kaXNhYmxlZCIgKTsKCQkJfQoJCX0KCgkJdGhpcy5vcHRpb25zLmRpc2FibGVkID0gZGlzYWJsZWQ7Cgl9LAoKCV9zZXR1cEV2ZW50czogZnVuY3Rpb24oIGV2ZW50ICkgewoJCXZhciBldmVudHMgPSB7CgkJCWNsaWNrOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQl9CgkJfTsKCQlpZiAoIGV2ZW50ICkgewoJCQkkLmVhY2goIGV2ZW50LnNwbGl0KCIgIiksIGZ1bmN0aW9uKCBpbmRleCwgZXZlbnROYW1lICkgewoJCQkJZXZlbnRzWyBldmVudE5hbWUgXSA9ICJfZXZlbnRIYW5kbGVyIjsKCQkJfSk7CgkJfQoKCQl0aGlzLl9vZmYoIHRoaXMuYW5jaG9ycy5hZGQoIHRoaXMudGFicyApLmFkZCggdGhpcy5wYW5lbHMgKSApOwoJCXRoaXMuX29uKCB0aGlzLmFuY2hvcnMsIGV2ZW50cyApOwoJCXRoaXMuX29uKCB0aGlzLnRhYnMsIHsga2V5ZG93bjogIl90YWJLZXlkb3duIiB9ICk7CgkJdGhpcy5fb24oIHRoaXMucGFuZWxzLCB7IGtleWRvd246ICJfcGFuZWxLZXlkb3duIiB9ICk7CgoJCXRoaXMuX2ZvY3VzYWJsZSggdGhpcy50YWJzICk7CgkJdGhpcy5faG92ZXJhYmxlKCB0aGlzLnRhYnMgKTsKCX0sCgoJX3NldHVwSGVpZ2h0U3R5bGU6IGZ1bmN0aW9uKCBoZWlnaHRTdHlsZSApIHsKCQl2YXIgbWF4SGVpZ2h0LAoJCQlwYXJlbnQgPSB0aGlzLmVsZW1lbnQucGFyZW50KCk7CgoJCWlmICggaGVpZ2h0U3R5bGUgPT09ICJmaWxsIiApIHsKCQkJbWF4SGVpZ2h0ID0gcGFyZW50LmhlaWdodCgpOwoJCQltYXhIZWlnaHQgLT0gdGhpcy5lbGVtZW50Lm91dGVySGVpZ2h0KCkgLSB0aGlzLmVsZW1lbnQuaGVpZ2h0KCk7CgoJCQl0aGlzLmVsZW1lbnQuc2libGluZ3MoICI6dmlzaWJsZSIgKS5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJdmFyIGVsZW0gPSAkKCB0aGlzICksCgkJCQkJcG9zaXRpb24gPSBlbGVtLmNzcyggInBvc2l0aW9uIiApOwoKCQkJCWlmICggcG9zaXRpb24gPT09ICJhYnNvbHV0ZSIgfHwgcG9zaXRpb24gPT09ICJmaXhlZCIgKSB7CgkJCQkJcmV0dXJuOwoJCQkJfQoJCQkJbWF4SGVpZ2h0IC09IGVsZW0ub3V0ZXJIZWlnaHQoIHRydWUgKTsKCQkJfSk7CgoJCQl0aGlzLmVsZW1lbnQuY2hpbGRyZW4oKS5ub3QoIHRoaXMucGFuZWxzICkuZWFjaChmdW5jdGlvbigpIHsKCQkJCW1heEhlaWdodCAtPSAkKCB0aGlzICkub3V0ZXJIZWlnaHQoIHRydWUgKTsKCQkJfSk7CgoJCQl0aGlzLnBhbmVscy5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJJCggdGhpcyApLmhlaWdodCggTWF0aC5tYXgoIDAsIG1heEhlaWdodCAtCgkJCQkJJCggdGhpcyApLmlubmVySGVpZ2h0KCkgKyAkKCB0aGlzICkuaGVpZ2h0KCkgKSApOwoJCQl9KQoJCQkuY3NzKCAib3ZlcmZsb3ciLCAiYXV0byIgKTsKCQl9IGVsc2UgaWYgKCBoZWlnaHRTdHlsZSA9PT0gImF1dG8iICkgewoJCQltYXhIZWlnaHQgPSAwOwoJCQl0aGlzLnBhbmVscy5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJbWF4SGVpZ2h0ID0gTWF0aC5tYXgoIG1heEhlaWdodCwgJCggdGhpcyApLmhlaWdodCggIiIgKS5oZWlnaHQoKSApOwoJCQl9KS5oZWlnaHQoIG1heEhlaWdodCApOwoJCX0KCX0sCgoJX2V2ZW50SGFuZGxlcjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCXZhciBvcHRpb25zID0gdGhpcy5vcHRpb25zLAoJCQlhY3RpdmUgPSB0aGlzLmFjdGl2ZSwKCQkJYW5jaG9yID0gJCggZXZlbnQuY3VycmVudFRhcmdldCApLAoJCQl0YWIgPSBhbmNob3IuY2xvc2VzdCggImxpIiApLAoJCQljbGlja2VkSXNBY3RpdmUgPSB0YWJbIDAgXSA9PT0gYWN0aXZlWyAwIF0sCgkJCWNvbGxhcHNpbmcgPSBjbGlja2VkSXNBY3RpdmUgJiYgb3B0aW9ucy5jb2xsYXBzaWJsZSwKCQkJdG9TaG93ID0gY29sbGFwc2luZyA/ICQoKSA6IHRoaXMuX2dldFBhbmVsRm9yVGFiKCB0YWIgKSwKCQkJdG9IaWRlID0gIWFjdGl2ZS5sZW5ndGggPyAkKCkgOiB0aGlzLl9nZXRQYW5lbEZvclRhYiggYWN0aXZlICksCgkJCWV2ZW50RGF0YSA9IHsKCQkJCW9sZFRhYjogYWN0aXZlLAoJCQkJb2xkUGFuZWw6IHRvSGlkZSwKCQkJCW5ld1RhYjogY29sbGFwc2luZyA/ICQoKSA6IHRhYiwKCQkJCW5ld1BhbmVsOiB0b1Nob3cKCQkJfTsKCgkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCgkJaWYgKCB0YWIuaGFzQ2xhc3MoICJ1aS1zdGF0ZS1kaXNhYmxlZCIgKSB8fAoJCQkJLy8gdGFiIGlzIGFscmVhZHkgbG9hZGluZwoJCQkJdGFiLmhhc0NsYXNzKCAidWktdGFicy1sb2FkaW5nIiApIHx8CgkJCQkvLyBjYW4ndCBzd2l0Y2ggZHVybmluZyBhbiBhbmltYXRpb24KCQkJCXRoaXMucnVubmluZyB8fAoJCQkJLy8gY2xpY2sgb24gYWN0aXZlIGhlYWRlciwgYnV0IG5vdCBjb2xsYXBzaWJsZQoJCQkJKCBjbGlja2VkSXNBY3RpdmUgJiYgIW9wdGlvbnMuY29sbGFwc2libGUgKSB8fAoJCQkJLy8gYWxsb3cgY2FuY2VsaW5nIGFjdGl2YXRpb24KCQkJCSggdGhpcy5fdHJpZ2dlciggImJlZm9yZUFjdGl2YXRlIiwgZXZlbnQsIGV2ZW50RGF0YSApID09PSBmYWxzZSApICkgewoJCQlyZXR1cm47CgkJfQoKCQlvcHRpb25zLmFjdGl2ZSA9IGNvbGxhcHNpbmcgPyBmYWxzZSA6IHRoaXMudGFicy5pbmRleCggdGFiICk7CgoJCXRoaXMuYWN0aXZlID0gY2xpY2tlZElzQWN0aXZlID8gJCgpIDogdGFiOwoJCWlmICggdGhpcy54aHIgKSB7CgkJCXRoaXMueGhyLmFib3J0KCk7CgkJfQoKCQlpZiAoICF0b0hpZGUubGVuZ3RoICYmICF0b1Nob3cubGVuZ3RoICkgewoJCQkkLmVycm9yKCAialF1ZXJ5IFVJIFRhYnM6IE1pc21hdGNoaW5nIGZyYWdtZW50IGlkZW50aWZpZXIuIiApOwoJCX0KCgkJaWYgKCB0b1Nob3cubGVuZ3RoICkgewoJCQl0aGlzLmxvYWQoIHRoaXMudGFicy5pbmRleCggdGFiICksIGV2ZW50ICk7CgkJfQoJCXRoaXMuX3RvZ2dsZSggZXZlbnQsIGV2ZW50RGF0YSApOwoJfSwKCgkvLyBoYW5kbGVzIHNob3cvaGlkZSBmb3Igc2VsZWN0aW5nIHRhYnMKCV90b2dnbGU6IGZ1bmN0aW9uKCBldmVudCwgZXZlbnREYXRhICkgewoJCXZhciB0aGF0ID0gdGhpcywKCQkJdG9TaG93ID0gZXZlbnREYXRhLm5ld1BhbmVsLAoJCQl0b0hpZGUgPSBldmVudERhdGEub2xkUGFuZWw7CgoJCXRoaXMucnVubmluZyA9IHRydWU7CgoJCWZ1bmN0aW9uIGNvbXBsZXRlKCkgewoJCQl0aGF0LnJ1bm5pbmcgPSBmYWxzZTsKCQkJdGhhdC5fdHJpZ2dlciggImFjdGl2YXRlIiwgZXZlbnQsIGV2ZW50RGF0YSApOwoJCX0KCgkJZnVuY3Rpb24gc2hvdygpIHsKCQkJZXZlbnREYXRhLm5ld1RhYi5jbG9zZXN0KCAibGkiICkuYWRkQ2xhc3MoICJ1aS10YWJzLWFjdGl2ZSB1aS1zdGF0ZS1hY3RpdmUiICk7CgoJCQlpZiAoIHRvU2hvdy5sZW5ndGggJiYgdGhhdC5vcHRpb25zLnNob3cgKSB7CgkJCQl0aGF0Ll9zaG93KCB0b1Nob3csIHRoYXQub3B0aW9ucy5zaG93LCBjb21wbGV0ZSApOwoJCQl9IGVsc2UgewoJCQkJdG9TaG93LnNob3coKTsKCQkJCWNvbXBsZXRlKCk7CgkJCX0KCQl9CgoJCS8vIHN0YXJ0IG91dCBieSBoaWRpbmcsIHRoZW4gc2hvd2luZywgdGhlbiBjb21wbGV0aW5nCgkJaWYgKCB0b0hpZGUubGVuZ3RoICYmIHRoaXMub3B0aW9ucy5oaWRlICkgewoJCQl0aGlzLl9oaWRlKCB0b0hpZGUsIHRoaXMub3B0aW9ucy5oaWRlLCBmdW5jdGlvbigpIHsKCQkJCWV2ZW50RGF0YS5vbGRUYWIuY2xvc2VzdCggImxpIiApLnJlbW92ZUNsYXNzKCAidWktdGFicy1hY3RpdmUgdWktc3RhdGUtYWN0aXZlIiApOwoJCQkJc2hvdygpOwoJCQl9KTsKCQl9IGVsc2UgewoJCQlldmVudERhdGEub2xkVGFiLmNsb3Nlc3QoICJsaSIgKS5yZW1vdmVDbGFzcyggInVpLXRhYnMtYWN0aXZlIHVpLXN0YXRlLWFjdGl2ZSIgKTsKCQkJdG9IaWRlLmhpZGUoKTsKCQkJc2hvdygpOwoJCX0KCgkJdG9IaWRlLmF0dHIoewoJCQkiYXJpYS1leHBhbmRlZCI6ICJmYWxzZSIsCgkJCSJhcmlhLWhpZGRlbiI6ICJ0cnVlIgoJCX0pOwoJCWV2ZW50RGF0YS5vbGRUYWIuYXR0ciggImFyaWEtc2VsZWN0ZWQiLCAiZmFsc2UiICk7CgkJLy8gSWYgd2UncmUgc3dpdGNoaW5nIHRhYnMsIHJlbW92ZSB0aGUgb2xkIHRhYiBmcm9tIHRoZSB0YWIgb3JkZXIuCgkJLy8gSWYgd2UncmUgb3BlbmluZyBmcm9tIGNvbGxhcHNlZCBzdGF0ZSwgcmVtb3ZlIHRoZSBwcmV2aW91cyB0YWIgZnJvbSB0aGUgdGFiIG9yZGVyLgoJCS8vIElmIHdlJ3JlIGNvbGxhcHNpbmcsIHRoZW4ga2VlcCB0aGUgY29sbGFwc2luZyB0YWIgaW4gdGhlIHRhYiBvcmRlci4KCQlpZiAoIHRvU2hvdy5sZW5ndGggJiYgdG9IaWRlLmxlbmd0aCApIHsKCQkJZXZlbnREYXRhLm9sZFRhYi5hdHRyKCAidGFiSW5kZXgiLCAtMSApOwoJCX0gZWxzZSBpZiAoIHRvU2hvdy5sZW5ndGggKSB7CgkJCXRoaXMudGFicy5maWx0ZXIoZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gJCggdGhpcyApLmF0dHIoICJ0YWJJbmRleCIgKSA9PT0gMDsKCQkJfSkKCQkJLmF0dHIoICJ0YWJJbmRleCIsIC0xICk7CgkJfQoKCQl0b1Nob3cuYXR0cih7CgkJCSJhcmlhLWV4cGFuZGVkIjogInRydWUiLAoJCQkiYXJpYS1oaWRkZW4iOiAiZmFsc2UiCgkJfSk7CgkJZXZlbnREYXRhLm5ld1RhYi5hdHRyKHsKCQkJImFyaWEtc2VsZWN0ZWQiOiAidHJ1ZSIsCgkJCXRhYkluZGV4OiAwCgkJfSk7Cgl9LAoKCV9hY3RpdmF0ZTogZnVuY3Rpb24oIGluZGV4ICkgewoJCXZhciBhbmNob3IsCgkJCWFjdGl2ZSA9IHRoaXMuX2ZpbmRBY3RpdmUoIGluZGV4ICk7CgoJCS8vIHRyeWluZyB0byBhY3RpdmF0ZSB0aGUgYWxyZWFkeSBhY3RpdmUgcGFuZWwKCQlpZiAoIGFjdGl2ZVsgMCBdID09PSB0aGlzLmFjdGl2ZVsgMCBdICkgewoJCQlyZXR1cm47CgkJfQoKCQkvLyB0cnlpbmcgdG8gY29sbGFwc2UsIHNpbXVsYXRlIGEgY2xpY2sgb24gdGhlIGN1cnJlbnQgYWN0aXZlIGhlYWRlcgoJCWlmICggIWFjdGl2ZS5sZW5ndGggKSB7CgkJCWFjdGl2ZSA9IHRoaXMuYWN0aXZlOwoJCX0KCgkJYW5jaG9yID0gYWN0aXZlLmZpbmQoICIudWktdGFicy1hbmNob3IiIClbIDAgXTsKCQl0aGlzLl9ldmVudEhhbmRsZXIoewoJCQl0YXJnZXQ6IGFuY2hvciwKCQkJY3VycmVudFRhcmdldDogYW5jaG9yLAoJCQlwcmV2ZW50RGVmYXVsdDogJC5ub29wCgkJfSk7Cgl9LAoKCV9maW5kQWN0aXZlOiBmdW5jdGlvbiggaW5kZXggKSB7CgkJcmV0dXJuIGluZGV4ID09PSBmYWxzZSA/ICQoKSA6IHRoaXMudGFicy5lcSggaW5kZXggKTsKCX0sCgoJX2dldEluZGV4OiBmdW5jdGlvbiggaW5kZXggKSB7CgkJLy8gbWV0YS1mdW5jdGlvbiB0byBnaXZlIHVzZXJzIG9wdGlvbiB0byBwcm92aWRlIGEgaHJlZiBzdHJpbmcgaW5zdGVhZCBvZiBhIG51bWVyaWNhbCBpbmRleC4KCQlpZiAoIHR5cGVvZiBpbmRleCA9PT0gInN0cmluZyIgKSB7CgkJCWluZGV4ID0gdGhpcy5hbmNob3JzLmluZGV4KCB0aGlzLmFuY2hvcnMuZmlsdGVyKCAiW2hyZWYkPSciICsgaW5kZXggKyAiJ10iICkgKTsKCQl9CgoJCXJldHVybiBpbmRleDsKCX0sCgoJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCWlmICggdGhpcy54aHIgKSB7CgkJCXRoaXMueGhyLmFib3J0KCk7CgkJfQoKCQl0aGlzLmVsZW1lbnQucmVtb3ZlQ2xhc3MoICJ1aS10YWJzIHVpLXdpZGdldCB1aS13aWRnZXQtY29udGVudCB1aS1jb3JuZXItYWxsIHVpLXRhYnMtY29sbGFwc2libGUiICk7CgoJCXRoaXMudGFibGlzdAoJCQkucmVtb3ZlQ2xhc3MoICJ1aS10YWJzLW5hdiB1aS1oZWxwZXItcmVzZXQgdWktaGVscGVyLWNsZWFyZml4IHVpLXdpZGdldC1oZWFkZXIgdWktY29ybmVyLWFsbCIgKQoJCQkucmVtb3ZlQXR0ciggInJvbGUiICk7CgoJCXRoaXMuYW5jaG9ycwoJCQkucmVtb3ZlQ2xhc3MoICJ1aS10YWJzLWFuY2hvciIgKQoJCQkucmVtb3ZlQXR0ciggInJvbGUiICkKCQkJLnJlbW92ZUF0dHIoICJ0YWJJbmRleCIgKQoJCQkucmVtb3ZlVW5pcXVlSWQoKTsKCgkJdGhpcy50YWJzLmFkZCggdGhpcy5wYW5lbHMgKS5lYWNoKGZ1bmN0aW9uKCkgewoJCQlpZiAoICQuZGF0YSggdGhpcywgInVpLXRhYnMtZGVzdHJveSIgKSApIHsKCQkJCSQoIHRoaXMgKS5yZW1vdmUoKTsKCQkJfSBlbHNlIHsKCQkJCSQoIHRoaXMgKQoJCQkJCS5yZW1vdmVDbGFzcyggInVpLXN0YXRlLWRlZmF1bHQgdWktc3RhdGUtYWN0aXZlIHVpLXN0YXRlLWRpc2FibGVkICIgKwoJCQkJCQkidWktY29ybmVyLXRvcCB1aS1jb3JuZXItYm90dG9tIHVpLXdpZGdldC1jb250ZW50IHVpLXRhYnMtYWN0aXZlIHVpLXRhYnMtcGFuZWwiICkKCQkJCQkucmVtb3ZlQXR0ciggInRhYkluZGV4IiApCgkJCQkJLnJlbW92ZUF0dHIoICJhcmlhLWxpdmUiICkKCQkJCQkucmVtb3ZlQXR0ciggImFyaWEtYnVzeSIgKQoJCQkJCS5yZW1vdmVBdHRyKCAiYXJpYS1zZWxlY3RlZCIgKQoJCQkJCS5yZW1vdmVBdHRyKCAiYXJpYS1sYWJlbGxlZGJ5IiApCgkJCQkJLnJlbW92ZUF0dHIoICJhcmlhLWhpZGRlbiIgKQoJCQkJCS5yZW1vdmVBdHRyKCAiYXJpYS1leHBhbmRlZCIgKQoJCQkJCS5yZW1vdmVBdHRyKCAicm9sZSIgKTsKCQkJfQoJCX0pOwoKCQl0aGlzLnRhYnMuZWFjaChmdW5jdGlvbigpIHsKCQkJdmFyIGxpID0gJCggdGhpcyApLAoJCQkJcHJldiA9IGxpLmRhdGEoICJ1aS10YWJzLWFyaWEtY29udHJvbHMiICk7CgkJCWlmICggcHJldiApIHsKCQkJCWxpCgkJCQkJLmF0dHIoICJhcmlhLWNvbnRyb2xzIiwgcHJldiApCgkJCQkJLnJlbW92ZURhdGEoICJ1aS10YWJzLWFyaWEtY29udHJvbHMiICk7CgkJCX0gZWxzZSB7CgkJCQlsaS5yZW1vdmVBdHRyKCAiYXJpYS1jb250cm9scyIgKTsKCQkJfQoJCX0pOwoKCQl0aGlzLnBhbmVscy5zaG93KCk7CgoJCWlmICggdGhpcy5vcHRpb25zLmhlaWdodFN0eWxlICE9PSAiY29udGVudCIgKSB7CgkJCXRoaXMucGFuZWxzLmNzcyggImhlaWdodCIsICIiICk7CgkJfQoJfSwKCgllbmFibGU6IGZ1bmN0aW9uKCBpbmRleCApIHsKCQl2YXIgZGlzYWJsZWQgPSB0aGlzLm9wdGlvbnMuZGlzYWJsZWQ7CgkJaWYgKCBkaXNhYmxlZCA9PT0gZmFsc2UgKSB7CgkJCXJldHVybjsKCQl9CgoJCWlmICggaW5kZXggPT09IHVuZGVmaW5lZCApIHsKCQkJZGlzYWJsZWQgPSBmYWxzZTsKCQl9IGVsc2UgewoJCQlpbmRleCA9IHRoaXMuX2dldEluZGV4KCBpbmRleCApOwoJCQlpZiAoICQuaXNBcnJheSggZGlzYWJsZWQgKSApIHsKCQkJCWRpc2FibGVkID0gJC5tYXAoIGRpc2FibGVkLCBmdW5jdGlvbiggbnVtICkgewoJCQkJCXJldHVybiBudW0gIT09IGluZGV4ID8gbnVtIDogbnVsbDsKCQkJCX0pOwoJCQl9IGVsc2UgewoJCQkJZGlzYWJsZWQgPSAkLm1hcCggdGhpcy50YWJzLCBmdW5jdGlvbiggbGksIG51bSApIHsKCQkJCQlyZXR1cm4gbnVtICE9PSBpbmRleCA/IG51bSA6IG51bGw7CgkJCQl9KTsKCQkJfQoJCX0KCQl0aGlzLl9zZXR1cERpc2FibGVkKCBkaXNhYmxlZCApOwoJfSwKCglkaXNhYmxlOiBmdW5jdGlvbiggaW5kZXggKSB7CgkJdmFyIGRpc2FibGVkID0gdGhpcy5vcHRpb25zLmRpc2FibGVkOwoJCWlmICggZGlzYWJsZWQgPT09IHRydWUgKSB7CgkJCXJldHVybjsKCQl9CgoJCWlmICggaW5kZXggPT09IHVuZGVmaW5lZCApIHsKCQkJZGlzYWJsZWQgPSB0cnVlOwoJCX0gZWxzZSB7CgkJCWluZGV4ID0gdGhpcy5fZ2V0SW5kZXgoIGluZGV4ICk7CgkJCWlmICggJC5pbkFycmF5KCBpbmRleCwgZGlzYWJsZWQgKSAhPT0gLTEgKSB7CgkJCQlyZXR1cm47CgkJCX0KCQkJaWYgKCAkLmlzQXJyYXkoIGRpc2FibGVkICkgKSB7CgkJCQlkaXNhYmxlZCA9ICQubWVyZ2UoIFsgaW5kZXggXSwgZGlzYWJsZWQgKS5zb3J0KCk7CgkJCX0gZWxzZSB7CgkJCQlkaXNhYmxlZCA9IFsgaW5kZXggXTsKCQkJfQoJCX0KCQl0aGlzLl9zZXR1cERpc2FibGVkKCBkaXNhYmxlZCApOwoJfSwKCglsb2FkOiBmdW5jdGlvbiggaW5kZXgsIGV2ZW50ICkgewoJCWluZGV4ID0gdGhpcy5fZ2V0SW5kZXgoIGluZGV4ICk7CgkJdmFyIHRoYXQgPSB0aGlzLAoJCQl0YWIgPSB0aGlzLnRhYnMuZXEoIGluZGV4ICksCgkJCWFuY2hvciA9IHRhYi5maW5kKCAiLnVpLXRhYnMtYW5jaG9yIiApLAoJCQlwYW5lbCA9IHRoaXMuX2dldFBhbmVsRm9yVGFiKCB0YWIgKSwKCQkJZXZlbnREYXRhID0gewoJCQkJdGFiOiB0YWIsCgkJCQlwYW5lbDogcGFuZWwKCQkJfTsKCgkJLy8gbm90IHJlbW90ZQoJCWlmICggaXNMb2NhbCggYW5jaG9yWyAwIF0gKSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJdGhpcy54aHIgPSAkLmFqYXgoIHRoaXMuX2FqYXhTZXR0aW5ncyggYW5jaG9yLCBldmVudCwgZXZlbnREYXRhICkgKTsKCgkJLy8gc3VwcG9ydDogalF1ZXJ5IDwxLjgKCQkvLyBqUXVlcnkgPDEuOCByZXR1cm5zIGZhbHNlIGlmIHRoZSByZXF1ZXN0IGlzIGNhbmNlbGVkIGluIGJlZm9yZVNlbmQsCgkJLy8gYnV0IGFzIG9mIDEuOCwgJC5hamF4KCkgYWx3YXlzIHJldHVybnMgYSBqcVhIUiBvYmplY3QuCgkJaWYgKCB0aGlzLnhociAmJiB0aGlzLnhoci5zdGF0dXNUZXh0ICE9PSAiY2FuY2VsZWQiICkgewoJCQl0YWIuYWRkQ2xhc3MoICJ1aS10YWJzLWxvYWRpbmciICk7CgkJCXBhbmVsLmF0dHIoICJhcmlhLWJ1c3kiLCAidHJ1ZSIgKTsKCgkJCXRoaXMueGhyCgkJCQkuc3VjY2VzcyhmdW5jdGlvbiggcmVzcG9uc2UgKSB7CgkJCQkJLy8gc3VwcG9ydDogalF1ZXJ5IDwxLjgKCQkJCQkvLyBodHRwOi8vYnVncy5qcXVlcnkuY29tL3RpY2tldC8xMTc3OAoJCQkJCXNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CgkJCQkJCXBhbmVsLmh0bWwoIHJlc3BvbnNlICk7CgkJCQkJCXRoYXQuX3RyaWdnZXIoICJsb2FkIiwgZXZlbnQsIGV2ZW50RGF0YSApOwoJCQkJCX0sIDEgKTsKCQkJCX0pCgkJCQkuY29tcGxldGUoZnVuY3Rpb24oIGpxWEhSLCBzdGF0dXMgKSB7CgkJCQkJLy8gc3VwcG9ydDogalF1ZXJ5IDwxLjgKCQkJCQkvLyBodHRwOi8vYnVncy5qcXVlcnkuY29tL3RpY2tldC8xMTc3OAoJCQkJCXNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CgkJCQkJCWlmICggc3RhdHVzID09PSAiYWJvcnQiICkgewoJCQkJCQkJdGhhdC5wYW5lbHMuc3RvcCggZmFsc2UsIHRydWUgKTsKCQkJCQkJfQoKCQkJCQkJdGFiLnJlbW92ZUNsYXNzKCAidWktdGFicy1sb2FkaW5nIiApOwoJCQkJCQlwYW5lbC5yZW1vdmVBdHRyKCAiYXJpYS1idXN5IiApOwoKCQkJCQkJaWYgKCBqcVhIUiA9PT0gdGhhdC54aHIgKSB7CgkJCQkJCQlkZWxldGUgdGhhdC54aHI7CgkJCQkJCX0KCQkJCQl9LCAxICk7CgkJCQl9KTsKCQl9Cgl9LAoKCV9hamF4U2V0dGluZ3M6IGZ1bmN0aW9uKCBhbmNob3IsIGV2ZW50LCBldmVudERhdGEgKSB7CgkJdmFyIHRoYXQgPSB0aGlzOwoJCXJldHVybiB7CgkJCXVybDogYW5jaG9yLmF0dHIoICJocmVmIiApLAoJCQliZWZvcmVTZW5kOiBmdW5jdGlvbigganFYSFIsIHNldHRpbmdzICkgewoJCQkJcmV0dXJuIHRoYXQuX3RyaWdnZXIoICJiZWZvcmVMb2FkIiwgZXZlbnQsCgkJCQkJJC5leHRlbmQoIHsganFYSFIgOiBqcVhIUiwgYWpheFNldHRpbmdzOiBzZXR0aW5ncyB9LCBldmVudERhdGEgKSApOwoJCQl9CgkJfTsKCX0sCgoJX2dldFBhbmVsRm9yVGFiOiBmdW5jdGlvbiggdGFiICkgewoJCXZhciBpZCA9ICQoIHRhYiApLmF0dHIoICJhcmlhLWNvbnRyb2xzIiApOwoJCXJldHVybiB0aGlzLmVsZW1lbnQuZmluZCggdGhpcy5fc2FuaXRpemVTZWxlY3RvciggIiMiICsgaWQgKSApOwoJfQp9KTsKCn0pKCBqUXVlcnkgKTsKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHdpbmRvdyApIHsKCgkkLm1vYmlsZS5pb3NvcmllbnRhdGlvbmZpeEVuYWJsZWQgPSB0cnVlOwoKCS8vIFRoaXMgZml4IGFkZHJlc3NlcyBhbiBpT1MgYnVnLCBzbyByZXR1cm4gZWFybHkgaWYgdGhlIFVBIGNsYWltcyBpdCdzIHNvbWV0aGluZyBlbHNlLgoJdmFyIHVhID0gbmF2aWdhdG9yLnVzZXJBZ2VudCwKCQl6b29tLAoJCWV2dCwgeCwgeSwgeiwgYWlnOwoJaWYgKCAhKCAvaVBob25lfGlQYWR8aVBvZC8udGVzdCggbmF2aWdhdG9yLnBsYXRmb3JtICkgJiYgL09TIFsxLTVdX1swLTlfXSogbGlrZSBNYWMgT1MgWC9pLnRlc3QoIHVhICkgJiYgdWEuaW5kZXhPZiggIkFwcGxlV2ViS2l0IiApID4gLTEgKSApewoJCSQubW9iaWxlLmlvc29yaWVudGF0aW9uZml4RW5hYmxlZCA9IGZhbHNlOwoJCXJldHVybjsKCX0KCgl6b29tID0gJC5tb2JpbGUuem9vbTsKCglmdW5jdGlvbiBjaGVja1RpbHQoIGUgKSB7CgkJZXZ0ID0gZS5vcmlnaW5hbEV2ZW50OwoJCWFpZyA9IGV2dC5hY2NlbGVyYXRpb25JbmNsdWRpbmdHcmF2aXR5OwoKCQl4ID0gTWF0aC5hYnMoIGFpZy54ICk7CgkJeSA9IE1hdGguYWJzKCBhaWcueSApOwoJCXogPSBNYXRoLmFicyggYWlnLnogKTsKCgkJLy8gSWYgcG9ydHJhaXQgb3JpZW50YXRpb24gYW5kIGluIG9uZSBvZiB0aGUgZGFuZ2VyIHpvbmVzCgkJaWYgKCAhd2luZG93Lm9yaWVudGF0aW9uICYmICggeCA+IDcgfHwgKCAoIHogPiA2ICYmIHkgPCA4IHx8IHogPCA4ICYmIHkgPiA2ICkgJiYgeCA+IDUgKSApICkgewoJCQkJaWYgKCB6b29tLmVuYWJsZWQgKSB7CgkJCQkJem9vbS5kaXNhYmxlKCk7CgkJCQl9CgkJfQllbHNlIGlmICggIXpvb20uZW5hYmxlZCApIHsKCQkJCXpvb20uZW5hYmxlKCk7CgkJfQoJfQoKCSQubW9iaWxlLmRvY3VtZW50Lm9uKCAibW9iaWxlaW5pdCIsIGZ1bmN0aW9uKCkgewoJCWlmICggJC5tb2JpbGUuaW9zb3JpZW50YXRpb25maXhFbmFibGVkICl7CgkJCSQubW9iaWxlLndpbmRvdwoJCQkJLmJpbmQoICJvcmllbnRhdGlvbmNoYW5nZS5pb3NvcmllbnRhdGlvbmZpeCIsIHpvb20uZW5hYmxlICkKCQkJCS5iaW5kKCAiZGV2aWNlbW90aW9uLmlvc29yaWVudGF0aW9uZml4IiwgY2hlY2tUaWx0ICk7CgkJfQoJfSk7Cgp9KCBqUXVlcnksIHRoaXMgKSk7CgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoJdmFyCSRodG1sID0gJCggImh0bWwiICksCgkJJHdpbmRvdyA9ICQubW9iaWxlLndpbmRvdzsKCgkvL3JlbW92ZSBpbml0aWFsIGJ1aWxkIGNsYXNzIChvbmx5IHByZXNlbnQgb24gZmlyc3QgcGFnZXNob3cpCglmdW5jdGlvbiBoaWRlUmVuZGVyaW5nQ2xhc3MoKSB7CgkJJGh0bWwucmVtb3ZlQ2xhc3MoICJ1aS1tb2JpbGUtcmVuZGVyaW5nIiApOwoJfQoKCS8vIHRyaWdnZXIgbW9iaWxlaW5pdCBldmVudCAtIHVzZWZ1bCBob29rIGZvciBjb25maWd1cmluZyAkLm1vYmlsZSBzZXR0aW5ncyBiZWZvcmUgdGhleSdyZSB1c2VkCgkkKCB3aW5kb3cuZG9jdW1lbnQgKS50cmlnZ2VyKCAibW9iaWxlaW5pdCIgKTsKCgkvLyBzdXBwb3J0IGNvbmRpdGlvbnMKCS8vIGlmIGRldmljZSBzdXBwb3J0IGNvbmRpdGlvbihzKSBhcmVuJ3QgbWV0LCBsZWF2ZSB0aGluZ3MgYXMgdGhleSBhcmUgLT4gYSBiYXNpYywgdXNhYmxlIGV4cGVyaWVuY2UsCgkvLyBvdGhlcndpc2UsIHByb2NlZWQgd2l0aCB0aGUgZW5oYW5jZW1lbnRzCglpZiAoICEkLm1vYmlsZS5ncmFkZUEoKSApIHsKCQlyZXR1cm47Cgl9CgoJLy8gb3ZlcnJpZGUgYWpheEVuYWJsZWQgb24gcGxhdGZvcm1zIHRoYXQgaGF2ZSBrbm93biBjb25mbGljdHMgd2l0aCBoYXNoIGhpc3RvcnkgdXBkYXRlcwoJLy8gb3IgZ2VuZXJhbGx5IHdvcmsgYmV0dGVyIGJyb3dzaW5nIGluIHJlZ3VsYXIgaHR0cCBmb3IgZnVsbCBwYWdlIHJlZnJlc2hlcyAoQkI1LCBPcGVyYSBNaW5pKQoJaWYgKCAkLm1vYmlsZS5hamF4QmxhY2tsaXN0ICkgewoJCSQubW9iaWxlLmFqYXhFbmFibGVkID0gZmFsc2U7Cgl9CgoJLy8gQWRkIG1vYmlsZSwgaW5pdGlhbCBsb2FkICJyZW5kZXJpbmciIGNsYXNzZXMgdG8gZG9jRWwKCSRodG1sLmFkZENsYXNzKCAidWktbW9iaWxlIHVpLW1vYmlsZS1yZW5kZXJpbmciICk7CgoJLy8gVGhpcyBpcyBhIGZhbGxiYWNrLiBJZiBhbnl0aGluZyBnb2VzIHdyb25nIChKUyBlcnJvcnMsIGV0YyksIG9yIGV2ZW50cyBkb24ndCBmaXJlLAoJLy8gdGhpcyBlbnN1cmVzIHRoZSByZW5kZXJpbmcgY2xhc3MgaXMgcmVtb3ZlZCBhZnRlciA1IHNlY29uZHMsIHNvIGNvbnRlbnQgaXMgdmlzaWJsZSBhbmQgYWNjZXNzaWJsZQoJc2V0VGltZW91dCggaGlkZVJlbmRlcmluZ0NsYXNzLCA1MDAwICk7CgoJJC5leHRlbmQoICQubW9iaWxlLCB7CgkJLy8gZmluZCBhbmQgZW5oYW5jZSB0aGUgcGFnZXMgaW4gdGhlIGRvbSBhbmQgdHJhbnNpdGlvbiB0byB0aGUgZmlyc3QgcGFnZS4KCQlpbml0aWFsaXplUGFnZTogZnVuY3Rpb24oKSB7CgkJCS8vIGZpbmQgcHJlc2VudCBwYWdlcwoJCQl2YXIgcGF0aCA9ICQubW9iaWxlLnBhdGgsCgkJCQkkcGFnZXMgPSAkKCAiOmpxbURhdGEocm9sZT0ncGFnZScpLCA6anFtRGF0YShyb2xlPSdkaWFsb2cnKSIgKSwKCQkJCWhhc2ggPSBwYXRoLnN0cmlwSGFzaCggcGF0aC5zdHJpcFF1ZXJ5UGFyYW1zKHBhdGgucGFyc2VMb2NhdGlvbigpLmhhc2gpICksCgkJCQloYXNoUGFnZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCBoYXNoICk7CgoJCQkvLyBpZiBubyBwYWdlcyBhcmUgZm91bmQsIGNyZWF0ZSBvbmUgd2l0aCBib2R5J3MgaW5uZXIgaHRtbAoJCQlpZiAoICEkcGFnZXMubGVuZ3RoICkgewoJCQkJJHBhZ2VzID0gJCggImJvZHkiICkud3JhcElubmVyKCAiPGRpdiBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyb2xlPSdwYWdlJz48L2Rpdj4iICkuY2hpbGRyZW4oIDAgKTsKCQkJfQoKCQkJLy8gYWRkIGRpYWxvZ3MsIHNldCBkYXRhLXVybCBhdHRycwoJCQkkcGFnZXMuZWFjaChmdW5jdGlvbigpIHsKCQkJCXZhciAkdGhpcyA9ICQoIHRoaXMgKTsKCgkJCQkvLyB1bmxlc3MgdGhlIGRhdGEgdXJsIGlzIGFscmVhZHkgc2V0IHNldCBpdCB0byB0aGUgcGF0aG5hbWUKCQkJCWlmICggISR0aGlzWyAwIF0uZ2V0QXR0cmlidXRlKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidXJsIiApICkgewoJCQkJCSR0aGlzLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJ1cmwiLCAkdGhpcy5hdHRyKCAiaWQiICkgfHwgbG9jYXRpb24ucGF0aG5hbWUgKyBsb2NhdGlvbi5zZWFyY2ggKTsKCQkJCX0KCQkJfSk7CgoJCQkvLyBkZWZpbmUgZmlyc3QgcGFnZSBpbiBkb20gY2FzZSBvbmUgYmFja3Mgb3V0IHRvIHRoZSBkaXJlY3Rvcnkgcm9vdCAobm90IGFsd2F5cyB0aGUgZmlyc3QgcGFnZSB2aXNpdGVkLCBidXQgZGVmaW5lZCBhcyBmYWxsYmFjaykKCQkJJC5tb2JpbGUuZmlyc3RQYWdlID0gJHBhZ2VzLmZpcnN0KCk7CgoJCQkvLyBkZWZpbmUgcGFnZSBjb250YWluZXIKCQkJJC5tb2JpbGUucGFnZUNvbnRhaW5lciA9ICQubW9iaWxlLmZpcnN0UGFnZQoJCQkJLnBhcmVudCgpCgkJCQkuYWRkQ2xhc3MoICJ1aS1tb2JpbGUtdmlld3BvcnQiICkKCQkJCS5wYWdlY29udGFpbmVyKCk7CgoJCQkvLyBpbml0aWFsaXplIG5hdmlnYXRpb24gZXZlbnRzIG5vdywgYWZ0ZXIgbW9iaWxlaW5pdCBoYXMgb2NjdXJyZWQgYW5kIHRoZSBwYWdlIGNvbnRhaW5lcgoJCQkvLyBoYXMgYmVlbiBjcmVhdGVkIGJ1dCBiZWZvcmUgdGhlIHJlc3Qgb2YgdGhlIGxpYnJhcnkgaXMgYWxlcnRlZCB0byB0aGF0IGZhY3QKCQkJJC5tb2JpbGUubmF2cmVhZHlEZWZlcnJlZC5yZXNvbHZlKCk7CgoJCQkvLyBhbGVydCBsaXN0ZW5lcnMgdGhhdCB0aGUgcGFnZWNvbnRhaW5lciBoYXMgYmVlbiBkZXRlcm1pbmVkIGZvciBiaW5kaW5nCgkJCS8vIHRvIGV2ZW50cyB0cmlnZ2VyZWQgb24gaXQKCQkJJHdpbmRvdy50cmlnZ2VyKCAicGFnZWNvbnRhaW5lcmNyZWF0ZSIgKTsKCgkJCS8vIGN1ZSBwYWdlIGxvYWRpbmcgbWVzc2FnZQoJCQkkLm1vYmlsZS5sb2FkaW5nKCAic2hvdyIgKTsKCgkJCS8vcmVtb3ZlIGluaXRpYWwgYnVpbGQgY2xhc3MgKG9ubHkgcHJlc2VudCBvbiBmaXJzdCBwYWdlc2hvdykKCQkJaGlkZVJlbmRlcmluZ0NsYXNzKCk7CgoJCQkvLyBpZiBoYXNoY2hhbmdlIGxpc3RlbmluZyBpcyBkaXNhYmxlZCwgdGhlcmUncyBubyBoYXNoIGRlZXBsaW5rLAoJCQkvLyB0aGUgaGFzaCBpcyBub3QgdmFsaWQgKGNvbnRhaW5zIG1vcmUgdGhhbiBvbmUgIyBvciBkb2VzIG5vdCBzdGFydCB3aXRoICMpCgkJCS8vIG9yIHRoZXJlIGlzIG5vIHBhZ2Ugd2l0aCB0aGF0IGhhc2gsIGNoYW5nZSB0byB0aGUgZmlyc3QgcGFnZSBpbiB0aGUgRE9NCgkJCS8vIFJlbWVtYmVyLCBob3dldmVyLCB0aGF0IHRoZSBoYXNoIGNhbiBhbHNvIGJlIGEgcGF0aCEKCQkJaWYgKCAhICggJC5tb2JpbGUuaGFzaExpc3RlbmluZ0VuYWJsZWQgJiYKCQkJCSQubW9iaWxlLnBhdGguaXNIYXNoVmFsaWQoIGxvY2F0aW9uLmhhc2ggKSAmJgoJCQkJKCAkKCBoYXNoUGFnZSApLmlzKCAiOmpxbURhdGEocm9sZT0ncGFnZScpIiApIHx8CgkJCQkJJC5tb2JpbGUucGF0aC5pc1BhdGgoIGhhc2ggKSB8fAoJCQkJCWhhc2ggPT09ICQubW9iaWxlLmRpYWxvZ0hhc2hLZXkgKSApICkgewoKCQkJCS8vIFN0b3JlIHRoZSBpbml0aWFsIGRlc3RpbmF0aW9uCgkJCQlpZiAoICQubW9iaWxlLnBhdGguaXNIYXNoVmFsaWQoIGxvY2F0aW9uLmhhc2ggKSApIHsKCQkJCQkkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5LmluaXRpYWxEc3QgPSBoYXNoLnJlcGxhY2UoICIjIiwgIiIgKTsKCQkJCX0KCgkJCQkvLyBtYWtlIHN1cmUgdG8gc2V0IGluaXRpYWwgcG9wc3RhdGUgc3RhdGUgaWYgaXQgZXhpc3RzCgkJCQkvLyBzbyB0aGF0IG5hdmlnYXRpb24gYmFjayB0byB0aGUgaW5pdGlhbCBwYWdlIHdvcmtzIHByb3Blcmx5CgkJCQlpZiAoICQuZXZlbnQuc3BlY2lhbC5uYXZpZ2F0ZS5pc1B1c2hTdGF0ZUVuYWJsZWQoKSApIHsKCQkJCQkkLm1vYmlsZS5uYXZpZ2F0ZS5uYXZpZ2F0b3Iuc3F1YXNoKCBwYXRoLnBhcnNlTG9jYXRpb24oKS5ocmVmICk7CgkJCQl9CgoJCQkJJC5tb2JpbGUuY2hhbmdlUGFnZSggJC5tb2JpbGUuZmlyc3RQYWdlLCB7CgkJCQkJdHJhbnNpdGlvbjogIm5vbmUiLAoJCQkJCXJldmVyc2U6IHRydWUsCgkJCQkJY2hhbmdlSGFzaDogZmFsc2UsCgkJCQkJZnJvbUhhc2hDaGFuZ2U6IHRydWUKCQkJCX0pOwoJCQl9IGVsc2UgewoJCQkJLy8gdHJpZ2dlciBoYXNoY2hhbmdlIG9yIG5hdmlnYXRlIHRvIHNxdWFzaCBhbmQgcmVjb3JkIHRoZSBjb3JyZWN0CgkJCQkvLyBoaXN0b3J5IGVudHJ5IGZvciBhbiBpbml0aWFsIGhhc2ggcGF0aAoJCQkJaWYgKCAhJC5ldmVudC5zcGVjaWFsLm5hdmlnYXRlLmlzUHVzaFN0YXRlRW5hYmxlZCgpICkgewoJCQkJCSR3aW5kb3cudHJpZ2dlciggImhhc2hjaGFuZ2UiLCBbdHJ1ZV0gKTsKCQkJCX0gZWxzZSB7CgkJCQkJLy8gVE9ETyBmaWd1cmUgb3V0IGhvdyB0byBzaW1wbGlmeSB0aGlzIGludGVyYWN0aW9uIHdpdGggdGhlIGluaXRpYWwgaGlzdG9yeSBlbnRyeQoJCQkJCS8vIGF0IHRoZSBib3R0b20ganMvbmF2aWdhdGUvbmF2aWdhdGUuanMKCQkJCQkkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5LnN0YWNrID0gW107CgkJCQkJJC5tb2JpbGUubmF2aWdhdGUoICQubW9iaWxlLnBhdGguaXNQYXRoKCBsb2NhdGlvbi5oYXNoICkgPyBsb2NhdGlvbi5oYXNoIDogbG9jYXRpb24uaHJlZiApOwoJCQkJfQoJCQl9CgkJfQoJfSk7CgoJJChmdW5jdGlvbigpIHsKCQkvL1J1biBpbmxpbmVTVkcgc3VwcG9ydCB0ZXN0CgkJJC5zdXBwb3J0LmlubGluZVNWRygpOwoJCQoJCS8vIGNoZWNrIHdoaWNoIHNjcm9sbFRvcCB2YWx1ZSBzaG91bGQgYmUgdXNlZCBieSBzY3JvbGxpbmcgdG8gMSBpbW1lZGlhdGVseSBhdCBkb21yZWFkeQoJCS8vIHRoZW4gY2hlY2sgd2hhdCB0aGUgc2Nyb2xsIHRvcCBpcy4gQW5kcm9pZCB3aWxsIHJlcG9ydCAwLi4uIG90aGVycyAxCgkJLy8gbm90ZSB0aGF0IHRoaXMgaW5pdGlhbCBzY3JvbGwgd29uJ3QgaGlkZSB0aGUgYWRkcmVzcyBiYXIuIEl0J3MganVzdCBmb3IgdGhlIGNoZWNrLgoJCQoJCS8vIGhpZGUgaU9TIGJyb3dzZXIgY2hyb21lIG9uIGxvYWQgaWYgaGlkZVVybEJhciBpcyB0cnVlIHRoaXMgaXMgdG8gdHJ5IGFuZCBkbyBpdCBhcyBzb29uIGFzIHBvc3NpYmxlCgkJaWYgKCAkLm1vYmlsZS5oaWRlVXJsQmFyICkgewoJCQl3aW5kb3cuc2Nyb2xsVG8oIDAsIDEgKTsKCQl9CgoJCS8vIGlmIGRlZmF1bHRIb21lU2Nyb2xsIGhhc24ndCBiZWVuIHNldCB5ZXQsIHNlZSBpZiBzY3JvbGxUb3AgaXMgMQoJCS8vIGl0IHNob3VsZCBiZSAxIGluIG1vc3QgYnJvd3NlcnMsIGJ1dCBhbmRyb2lkIHRyZWF0cyAxIGFzIDAgKGZvciBoaWRpbmcgYWRkciBiYXIpCgkJLy8gc28gaWYgaXQncyAxLCB1c2UgMCBmcm9tIG5vdyBvbgoJCSQubW9iaWxlLmRlZmF1bHRIb21lU2Nyb2xsID0gKCAhJC5zdXBwb3J0LnNjcm9sbFRvcCB8fCAkLm1vYmlsZS53aW5kb3cuc2Nyb2xsVG9wKCkgPT09IDEgKSA/IDAgOiAxOwoKCQkvL2RvbS1yZWFkeSBpbml0cwoJCWlmICggJC5tb2JpbGUuYXV0b0luaXRpYWxpemVQYWdlICkgewoJCQkkLm1vYmlsZS5pbml0aWFsaXplUGFnZSgpOwoJCX0KCgkJLy8gd2luZG93IGxvYWQgZXZlbnQKCQkvLyBoaWRlIGlPUyBicm93c2VyIGNocm9tZSBvbiBsb2FkIGlmIGhpZGVVcmxCYXIgaXMgdHJ1ZSB0aGlzIGlzIGFzIGZhbGwgYmFjayBpbmNhc2Ugd2Ugd2VyZSB0b28gZWFybHkgYmVmb3JlCgkJaWYgKCAkLm1vYmlsZS5oaWRlVXJsQmFyICkgewoJCQkkd2luZG93LmxvYWQoICQubW9iaWxlLnNpbGVudFNjcm9sbCApOwoJCX0KCgkJaWYgKCAhJC5zdXBwb3J0LmNzc1BvaW50ZXJFdmVudHMgKSB7CgkJCS8vIElFIGFuZCBPcGVyYSBkb24ndCBzdXBwb3J0IENTUyBwb2ludGVyLWV2ZW50czogbm9uZSB0aGF0IHdlIHVzZSB0byBkaXNhYmxlIGxpbmstYmFzZWQgYnV0dG9ucwoJCQkvLyBieSBhZGRpbmcgdGhlICd1aS1kaXNhYmxlZCcgY2xhc3MgdG8gdGhlbS4gVXNpbmcgYSBKYXZhU2NyaXB0IHdvcmthcm91bmQgZm9yIHRob3NlIGJyb3dzZXIuCgkJCS8vIGh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5LW1vYmlsZS9pc3N1ZXMvMzU1OAoKCQkJLy8gREVQUkVDQVRFRCBhcyBvZiAxLjQuMCAtIHJlbW92ZSB1aS1kaXNhYmxlZCBhZnRlciAxLjQuMCByZWxlYXNlCgkJCS8vIG9ubHkgdWktc3RhdGUtZGlzYWJsZWQgc2hvdWxkIGJlIHByZXNlbnQgdGhlcmVhZnRlcgoJCQkkLm1vYmlsZS5kb2N1bWVudC5kZWxlZ2F0ZSggIi51aS1zdGF0ZS1kaXNhYmxlZCwudWktZGlzYWJsZWQiLCAidmNsaWNrIiwKCQkJCWZ1bmN0aW9uKCBlICkgewoJCQkJCWUucHJldmVudERlZmF1bHQoKTsKCQkJCQllLnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbigpOwoJCQkJfQoJCQkpOwoJCX0KCX0pOwp9KCBqUXVlcnksIHRoaXMgKSk7CgoKfSkpOwo=",
                "body": "LyohCiogalF1ZXJ5IE1vYmlsZSAxLjQuMHByZQoqIERhdGU6IFR1ZSBPY3QgMSAyMDEzIDE0OjQzOjMzIFVUQwoqIGh0dHA6Ly9qcXVlcnltb2JpbGUuY29tCioKKiBDb3B5cmlnaHQgMjAxMCwgMjAxMyBqUXVlcnkgRm91bmRhdGlvbiwgSW5jLiBhbmQgb3RoZXIgY29udHJpYnV0b3JzCiogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLgoqIGh0dHA6Ly9qcXVlcnkub3JnL2xpY2Vuc2UKKgoqLwoKCihmdW5jdGlvbiAoIHJvb3QsIGRvYywgZmFjdG9yeSApIHsKCWlmICggdHlwZW9mIGRlZmluZSA9PT0gImZ1bmN0aW9uIiAmJiBkZWZpbmUuYW1kICkgewoJCS8vIEFNRC4gUmVnaXN0ZXIgYXMgYW4gYW5vbnltb3VzIG1vZHVsZS4KCQlkZWZpbmUoIFsgImpxdWVyeSIgXSwgZnVuY3Rpb24gKCAkICkgewoJCQlmYWN0b3J5KCAkLCByb290LCBkb2MgKTsKCQkJcmV0dXJuICQubW9iaWxlOwoJCX0pOwoJfSBlbHNlIHsKCQkvLyBCcm93c2VyIGdsb2JhbHMKCQlmYWN0b3J5KCByb290LmpRdWVyeSwgcm9vdCwgZG9jICk7Cgl9Cn0oIHRoaXMsIGRvY3VtZW50LCBmdW5jdGlvbiAoIGpRdWVyeSwgd2luZG93LCBkb2N1bWVudCwgdW5kZWZpbmVkICkgewooZnVuY3Rpb24oICQgKSB7CgkkLm1vYmlsZSA9IHt9Owp9KCBqUXVlcnkgKSk7CihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgkkLmV4dGVuZCggJC5tb2JpbGUsIHsKCgkJLy8gVmVyc2lvbiBvZiB0aGUgalF1ZXJ5IE1vYmlsZSBGcmFtZXdvcmsKCQl2ZXJzaW9uOiAiMS40LjBwcmUiLAoKCQkvLyBEZXByZWNhdGVkIGFuZCBubyBsb25nZXIgdXNlZCBpbiAxLjQgcmVtb3ZlIGluIDEuNQoJCS8vIERlZmluZSB0aGUgdXJsIHBhcmFtZXRlciB1c2VkIGZvciByZWZlcmVuY2luZyB3aWRnZXQtZ2VuZXJhdGVkIHN1Yi1wYWdlcy4KCQkvLyBUcmFuc2xhdGVzIHRvIGV4YW1wbGUuaHRtbCZ1aS1wYWdlPXN1YnBhZ2VJZGVudGlmaWVyCgkJLy8gaGFzaCBzZWdtZW50IGJlZm9yZSAmdWktcGFnZT0gaXMgdXNlZCB0byBtYWtlIEFqYXggcmVxdWVzdAoJCXN1YlBhZ2VVcmxLZXk6ICJ1aS1wYWdlIiwKCgkJaGlkZVVybEJhcjogdHJ1ZSwKCgkJLy8gS2VlcG5hdGl2ZSBTZWxlY3RvcgoJCWtlZXBOYXRpdmU6ICI6anFtRGF0YShyb2xlPSdub25lJyksIDpqcW1EYXRhKHJvbGU9J25vanMnKSIsCgoJCS8vIERlcHJlY2F0ZWQgaW4gMS40IHJlbW92ZSBpbiAxLjUKCQkvLyBDbGFzcyBhc3NpZ25lZCB0byBwYWdlIGN1cnJlbnRseSBpbiB2aWV3LCBhbmQgZHVyaW5nIHRyYW5zaXRpb25zCgkJYWN0aXZlUGFnZUNsYXNzOiAidWktcGFnZS1hY3RpdmUiLAoKCQkvLyBEZXByZWNhdGVkIGluIDEuNCByZW1vdmUgaW4gMS41CgkJLy8gQ2xhc3MgdXNlZCBmb3IgImFjdGl2ZSIgYnV0dG9uIHN0YXRlLCBmcm9tIENTUyBmcmFtZXdvcmsKCQlhY3RpdmVCdG5DbGFzczogInVpLWJ0bi1hY3RpdmUiLAoKCQkvLyBEZXByZWNhdGVkIGluIDEuNCByZW1vdmUgaW4gMS41CgkJLy8gQ2xhc3MgdXNlZCBmb3IgImZvY3VzIiBmb3JtIGVsZW1lbnQgc3RhdGUsIGZyb20gQ1NTIGZyYW1ld29yawoJCWZvY3VzQ2xhc3M6ICJ1aS1mb2N1cyIsCgoJCS8vIEF1dG9tYXRpY2FsbHkgaGFuZGxlIGNsaWNrcyBhbmQgZm9ybSBzdWJtaXNzaW9ucyB0aHJvdWdoIEFqYXgsIHdoZW4gc2FtZS1kb21haW4KCQlhamF4RW5hYmxlZDogdHJ1ZSwKCgkJLy8gQXV0b21hdGljYWxseSBsb2FkIGFuZCBzaG93IHBhZ2VzIGJhc2VkIG9uIGxvY2F0aW9uLmhhc2gKCQloYXNoTGlzdGVuaW5nRW5hYmxlZDogdHJ1ZSwKCgkJLy8gZGlzYWJsZSB0byBwcmV2ZW50IGpxdWVyeSBmcm9tIGJvdGhlcmluZyB3aXRoIGxpbmtzCgkJbGlua0JpbmRpbmdFbmFibGVkOiB0cnVlLAoKCQkvLyBTZXQgZGVmYXVsdCBwYWdlIHRyYW5zaXRpb24gLSAnbm9uZScgZm9yIG5vIHRyYW5zaXRpb25zCgkJZGVmYXVsdFBhZ2VUcmFuc2l0aW9uOiAiZmFkZSIsCgoJCS8vIFNldCBtYXhpbXVtIHdpbmRvdyB3aWR0aCBmb3IgdHJhbnNpdGlvbnMgdG8gYXBwbHkgLSAnZmFsc2UnIGZvciBubyBsaW1pdAoJCW1heFRyYW5zaXRpb25XaWR0aDogZmFsc2UsCgoJCS8vIE1pbmltdW0gc2Nyb2xsIGRpc3RhbmNlIHRoYXQgd2lsbCBiZSByZW1lbWJlcmVkIHdoZW4gcmV0dXJuaW5nIHRvIGEgcGFnZQoJCS8vIERlcHJlY2F0ZWQgcmVtb3ZlIGluIDEuNSAKCQltaW5TY3JvbGxCYWNrOiAwLAoKCQkvLyBERVBSRUNBVEVEOiB0aGUgZm9sbG93aW5nIHByb3BlcnR5IGlzIG5vIGxvbmdlciBpbiB1c2UsIGJ1dCBkZWZpbmVkIHVudGlsIDIuMCB0byBwcmV2ZW50IGNvbmZsaWN0cwoJCXRvdWNoT3ZlcmZsb3dFbmFibGVkOiBmYWxzZSwKCgkJLy8gU2V0IGRlZmF1bHQgZGlhbG9nIHRyYW5zaXRpb24gLSAnbm9uZScgZm9yIG5vIHRyYW5zaXRpb25zCgkJZGVmYXVsdERpYWxvZ1RyYW5zaXRpb246ICJwb3AiLAoKCQkvLyBFcnJvciByZXNwb25zZSBtZXNzYWdlIC0gYXBwZWFycyB3aGVuIGFuIEFqYXggcGFnZSByZXF1ZXN0IGZhaWxzCgkJcGFnZUxvYWRFcnJvck1lc3NhZ2U6ICJFcnJvciBMb2FkaW5nIFBhZ2UiLAoKCQkvLyBGb3IgZXJyb3IgbWVzc2FnZXMsIHdoaWNoIHRoZW1lIGRvZXMgdGhlIGJveCB1c2VzPwoJCXBhZ2VMb2FkRXJyb3JNZXNzYWdlVGhlbWU6ICJhIiwKCgkJLy8gcmVwbGFjZSBjYWxscyB0byB3aW5kb3cuaGlzdG9yeS5iYWNrIHdpdGggcGhvbmVnYXBzIG5hdmlnYXRpb24gaGVscGVyCgkJLy8gd2hlcmUgaXQgaXMgcHJvdmlkZWQgb24gdGhlIHdpbmRvdyBvYmplY3QKCQlwaG9uZWdhcE5hdmlnYXRpb25FbmFibGVkOiBmYWxzZSwKCgkJLy9hdXRvbWF0aWNhbGx5IGluaXRpYWxpemUgdGhlIERPTSB3aGVuIGl0J3MgcmVhZHkKCQlhdXRvSW5pdGlhbGl6ZVBhZ2U6IHRydWUsCgoJCXB1c2hTdGF0ZUVuYWJsZWQ6IHRydWUsCgoJCS8vIGFsbG93cyB1c2VycyB0byBvcHQgaW4gdG8gaWdub3JpbmcgY29udGVudCBieSBtYXJraW5nIGEgcGFyZW50IGVsZW1lbnQgYXMKCQkvLyBkYXRhLWlnbm9yZWQKCQlpZ25vcmVDb250ZW50RW5hYmxlZDogZmFsc2UsCgoJCWJ1dHRvbk1hcmt1cDogewoJCQlob3ZlckRlbGF5OiAyMDAKCQl9LAoKCQkvLyBkaXNhYmxlIHRoZSBhbHRlcmF0aW9uIG9mIHRoZSBkeW5hbWljIGJhc2UgdGFnIG9yIGxpbmtzIGluIHRoZSBjYXNlCgkJLy8gdGhhdCBhIGR5bmFtaWMgYmFzZSB0YWcgaXNuJ3Qgc3VwcG9ydGVkCgkJZHluYW1pY0Jhc2VFbmFibGVkOiB0cnVlLAoKCQkvLyBkZWZhdWx0IHRoZSBwcm9wZXJ0eSB0byByZW1vdmUgZGVwZW5kZW5jeSBvbiBhc3NpZ25tZW50IGluIGluaXQgbW9kdWxlCgkJcGFnZUNvbnRhaW5lcjogJCgpLAoKCQkvL2VuYWJsZSBjcm9zcy1kb21haW4gcGFnZSBzdXBwb3J0CgkJYWxsb3dDcm9zc0RvbWFpblBhZ2VzOiBmYWxzZSwKCgkJZGlhbG9nSGFzaEtleTogIiZ1aS1zdGF0ZT1kaWFsb2ciCgl9KTsKfSkoIGpRdWVyeSwgdGhpcyApOwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCXZhciBuc05vcm1hbGl6ZURpY3QgPSB7fSwKCQlvbGRGaW5kID0gJC5maW5kLAoJCXJicmFjZSA9IC8oPzpce1tcc1xTXSpcfXxcW1tcc1xTXSpcXSkkLywKCQlqcW1EYXRhUkUgPSAvOmpxbURhdGFcKChbXildKilcKS9nOwoKCSQuZXh0ZW5kKCAkLm1vYmlsZSwgewoKCQkvLyBOYW1lc3BhY2UgdXNlZCBmcmFtZXdvcmstd2lkZSBmb3IgZGF0YS1hdHRycy4gRGVmYXVsdCBpcyBubyBuYW1lc3BhY2UKCgkJbnM6ICIiLAoKCQkvLyBSZXRyaWV2ZSBhbiBhdHRyaWJ1dGUgZnJvbSBhbiBlbGVtZW50IGFuZCBwZXJmb3JtIHNvbWUgbWFzc2FnaW5nIG9mIHRoZSB2YWx1ZQoKCQlnZXRBdHRyaWJ1dGU6IGZ1bmN0aW9uKCBlbGVtZW50LCBrZXkgKSB7CgkJCXZhciBkYXRhOwoKCQkJZWxlbWVudCA9IGVsZW1lbnQuanF1ZXJ5ID8gZWxlbWVudFswXSA6IGVsZW1lbnQ7CgoJCQlpZiggZWxlbWVudCAmJiBlbGVtZW50LmdldEF0dHJpYnV0ZSApewoJCQkJZGF0YSA9IGVsZW1lbnQuZ2V0QXR0cmlidXRlKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyBrZXkgKTsKCQkJfQoKCQkJLy8gQ29waWVkIGZyb20gY29yZSdzIHNyYy9kYXRhLmpzOmRhdGFBdHRyKCkKCQkJLy8gQ29udmVydCBmcm9tIGEgc3RyaW5nIHRvIGEgcHJvcGVyIGRhdGEgdHlwZQoJCQl0cnkgewoJCQkJZGF0YSA9IGRhdGEgPT09ICJ0cnVlIiA/IHRydWUgOgoJCQkJCWRhdGEgPT09ICJmYWxzZSIgPyBmYWxzZSA6CgkJCQkJZGF0YSA9PT0gIm51bGwiID8gbnVsbCA6CgkJCQkJLy8gT25seSBjb252ZXJ0IHRvIGEgbnVtYmVyIGlmIGl0IGRvZXNuJ3QgY2hhbmdlIHRoZSBzdHJpbmcKCQkJCQkrZGF0YSArICIiID09PSBkYXRhID8gK2RhdGEgOgoJCQkJCXJicmFjZS50ZXN0KCBkYXRhICkgPyBKU09OLnBhcnNlKCBkYXRhICkgOgoJCQkJCWRhdGE7CgkJCX0gY2F0Y2goIGVyciApIHt9CgoJCQlyZXR1cm4gZGF0YTsKCQl9LAoKCQkvLyBFeHBvc2Ugb3VyIGNhY2hlIGZvciB0ZXN0aW5nIHB1cnBvc2VzLgoJCW5zTm9ybWFsaXplRGljdDogbnNOb3JtYWxpemVEaWN0LAoKCQkvLyBUYWtlIGEgZGF0YSBhdHRyaWJ1dGUgcHJvcGVydHksIHByZXBlbmQgdGhlIG5hbWVzcGFjZQoJCS8vIGFuZCB0aGVuIGNhbWVsIGNhc2UgdGhlIGF0dHJpYnV0ZSBzdHJpbmcuIEFkZCB0aGUgcmVzdWx0CgkJLy8gdG8gb3VyIG5zTm9ybWFsaXplRGljdCBzbyB3ZSBkb24ndCBoYXZlIHRvIGRvIHRoaXMgYWdhaW4uCgkJbnNOb3JtYWxpemU6IGZ1bmN0aW9uKCBwcm9wICkgewoJCQlyZXR1cm4gbnNOb3JtYWxpemVEaWN0WyBwcm9wIF0gfHwKCQkJCSggbnNOb3JtYWxpemVEaWN0WyBwcm9wIF0gPSAkLmNhbWVsQ2FzZSggJC5tb2JpbGUubnMgKyBwcm9wICkgKTsKCQl9LAoKCQkvLyBGaW5kIHRoZSBjbG9zZXN0IGphdmFzY3JpcHQgcGFnZSBlbGVtZW50IHRvIGdhdGhlciBzZXR0aW5ncyBkYXRhIGpzcGVyZiB0ZXN0CgkJLy8gaHR0cDovL2pzcGVyZi5jb20vc2luZ2xlLWNvbXBsZXgtc2VsZWN0b3ItdnMtbWFueS1jb21wbGV4LXNlbGVjdG9ycy9lZGl0CgkJLy8gcG9zc2libHkgbmFpdmUsIGJ1dCBpdCBzaG93cyB0aGF0IHRoZSBwYXJzaW5nIG92ZXJoZWFkIGZvciAqanVzdCogdGhlIHBhZ2Ugc2VsZWN0b3IgdnMKCQkvLyB0aGUgcGFnZSBhbmQgZGlhbG9nIHNlbGVjdG9yIGlzIG5lZ2xpZ2FibGUuIFRoaXMgY291bGQgcHJvYmFibHkgYmUgc3BlZWQgdXAgYnkKCQkvLyBkb2luZyBhIHNpbWlsYXIgcGFyZW50IG5vZGUgdHJhdmVyc2FsIHRvIHRoZSBvbmUgZm91bmQgaW4gdGhlIGluaGVyaXRlZCB0aGVtZSBjb2RlIGFib3ZlCgkJY2xvc2VzdFBhZ2VEYXRhOiBmdW5jdGlvbiggJHRhcmdldCApIHsKCQkJcmV0dXJuICR0YXJnZXQKCQkJCS5jbG9zZXN0KCAiOmpxbURhdGEocm9sZT0ncGFnZScpLCA6anFtRGF0YShyb2xlPSdkaWFsb2cnKSIgKQoJCQkJLmRhdGEoICJtb2JpbGUtcGFnZSIgKTsKCQl9CgoJfSk7CgoJLy8gTW9iaWxlIHZlcnNpb24gb2YgZGF0YSBhbmQgcmVtb3ZlRGF0YSBhbmQgaGFzRGF0YSBtZXRob2RzCgkvLyBlbnN1cmVzIGFsbCBkYXRhIGlzIHNldCBhbmQgcmV0cmlldmVkIHVzaW5nIGpRdWVyeSBNb2JpbGUncyBkYXRhIG5hbWVzcGFjZQoJJC5mbi5qcW1EYXRhID0gZnVuY3Rpb24oIHByb3AsIHZhbHVlICkgewoJCXZhciByZXN1bHQ7CgkJaWYgKCB0eXBlb2YgcHJvcCAhPT0gInVuZGVmaW5lZCIgKSB7CgkJCWlmICggcHJvcCApIHsKCQkJCXByb3AgPSAkLm1vYmlsZS5uc05vcm1hbGl6ZSggcHJvcCApOwoJCQl9CgoJCQkvLyB1bmRlZmluZWQgaXMgcGVybWl0dGVkIGFzIGFuIGV4cGxpY2l0IGlucHV0IGZvciB0aGUgc2Vjb25kIHBhcmFtCgkJCS8vIGluIHRoaXMgY2FzZSBpdCByZXR1cm5zIHRoZSB2YWx1ZSBhbmQgZG9lcyBub3Qgc2V0IGl0IHRvIHVuZGVmaW5lZAoJCQlpZiAoIGFyZ3VtZW50cy5sZW5ndGggPCAyIHx8IHZhbHVlID09PSB1bmRlZmluZWQgKXsKCQkJCXJlc3VsdCA9IHRoaXMuZGF0YSggcHJvcCApOwoJCQl9IGVsc2UgewoJCQkJcmVzdWx0ID0gdGhpcy5kYXRhKCBwcm9wLCB2YWx1ZSApOwoJCQl9CgkJfQoJCXJldHVybiByZXN1bHQ7Cgl9OwoKCSQuanFtRGF0YSA9IGZ1bmN0aW9uKCBlbGVtLCBwcm9wLCB2YWx1ZSApIHsKCQl2YXIgcmVzdWx0OwoJCWlmICggdHlwZW9mIHByb3AgIT09ICJ1bmRlZmluZWQiICkgewoJCQlyZXN1bHQgPSAkLmRhdGEoIGVsZW0sIHByb3AgPyAkLm1vYmlsZS5uc05vcm1hbGl6ZSggcHJvcCApIDogcHJvcCwgdmFsdWUgKTsKCQl9CgkJcmV0dXJuIHJlc3VsdDsKCX07CgoJJC5mbi5qcW1SZW1vdmVEYXRhID0gZnVuY3Rpb24oIHByb3AgKSB7CgkJcmV0dXJuIHRoaXMucmVtb3ZlRGF0YSggJC5tb2JpbGUubnNOb3JtYWxpemUoIHByb3AgKSApOwoJfTsKCgkkLmpxbVJlbW92ZURhdGEgPSBmdW5jdGlvbiggZWxlbSwgcHJvcCApIHsKCQlyZXR1cm4gJC5yZW1vdmVEYXRhKCBlbGVtLCAkLm1vYmlsZS5uc05vcm1hbGl6ZSggcHJvcCApICk7Cgl9OwoKCSQuZmluZCA9IGZ1bmN0aW9uKCBzZWxlY3RvciwgY29udGV4dCwgcmV0LCBleHRyYSApIHsKCQlpZiAoIHNlbGVjdG9yLmluZGV4T2YoICI6anFtRGF0YSIgKSA+IC0xICkgewoJCQlzZWxlY3RvciA9IHNlbGVjdG9yLnJlcGxhY2UoIGpxbURhdGFSRSwgIltkYXRhLSIgKyAoICQubW9iaWxlLm5zIHx8ICIiICkgKyAiJDFdIiApOwoJCX0KCgkJcmV0dXJuIG9sZEZpbmQuY2FsbCggdGhpcywgc2VsZWN0b3IsIGNvbnRleHQsIHJldCwgZXh0cmEgKTsKCX07CgoJJC5leHRlbmQoICQuZmluZCwgb2xkRmluZCApOwoKfSkoIGpRdWVyeSwgdGhpcyApOwoKLyohCiAqIGpRdWVyeSBVSSBDb3JlIEBWRVJTSU9OCiAqIGh0dHA6Ly9qcXVlcnl1aS5jb20KICoKICogQ29weXJpZ2h0IDIwMTMgalF1ZXJ5IEZvdW5kYXRpb24gYW5kIG90aGVyIGNvbnRyaWJ1dG9ycwogKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuCiAqIGh0dHA6Ly9qcXVlcnkub3JnL2xpY2Vuc2UKICoKICogaHR0cDovL2FwaS5qcXVlcnl1aS5jb20vY2F0ZWdvcnkvdWktY29yZS8KICovCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKdmFyIHV1aWQgPSAwLAoJcnVuaXF1ZUlkID0gL151aS1pZC1cZCskLzsKCi8vICQudWkgbWlnaHQgZXhpc3QgZnJvbSBjb21wb25lbnRzIHdpdGggbm8gZGVwZW5kZW5jaWVzLCBlLmcuLCAkLnVpLnBvc2l0aW9uCiQudWkgPSAkLnVpIHx8IHt9OwoKJC5leHRlbmQoICQudWksIHsKCXZlcnNpb246ICJAVkVSU0lPTiIsCgoJa2V5Q29kZTogewoJCUJBQ0tTUEFDRTogOCwKCQlDT01NQTogMTg4LAoJCURFTEVURTogNDYsCgkJRE9XTjogNDAsCgkJRU5EOiAzNSwKCQlFTlRFUjogMTMsCgkJRVNDQVBFOiAyNywKCQlIT01FOiAzNiwKCQlMRUZUOiAzNywKCQlQQUdFX0RPV046IDM0LAoJCVBBR0VfVVA6IDMzLAoJCVBFUklPRDogMTkwLAoJCVJJR0hUOiAzOSwKCQlTUEFDRTogMzIsCgkJVEFCOiA5LAoJCVVQOiAzOAoJfQp9KTsKCi8vIHBsdWdpbnMKJC5mbi5leHRlbmQoewoJZm9jdXM6IChmdW5jdGlvbiggb3JpZyApIHsKCQlyZXR1cm4gZnVuY3Rpb24oIGRlbGF5LCBmbiApIHsKCQkJcmV0dXJuIHR5cGVvZiBkZWxheSA9PT0gIm51bWJlciIgPwoJCQkJdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJCXZhciBlbGVtID0gdGhpczsKCQkJCQlzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoJCQkJCQkkKCBlbGVtICkuZm9jdXMoKTsKCQkJCQkJaWYgKCBmbiApIHsKCQkJCQkJCWZuLmNhbGwoIGVsZW0gKTsKCQkJCQkJfQoJCQkJCX0sIGRlbGF5ICk7CgkJCQl9KSA6CgkJCQlvcmlnLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsKCQl9OwoJfSkoICQuZm4uZm9jdXMgKSwKCglzY3JvbGxQYXJlbnQ6IGZ1bmN0aW9uKCkgewoJCXZhciBzY3JvbGxQYXJlbnQ7CgkJaWYgKCgkLnVpLmllICYmICgvKHN0YXRpY3xyZWxhdGl2ZSkvKS50ZXN0KHRoaXMuY3NzKCJwb3NpdGlvbiIpKSkgfHwgKC9hYnNvbHV0ZS8pLnRlc3QodGhpcy5jc3MoInBvc2l0aW9uIikpKSB7CgkJCXNjcm9sbFBhcmVudCA9IHRoaXMucGFyZW50cygpLmZpbHRlcihmdW5jdGlvbigpIHsKCQkJCXJldHVybiAoLyhyZWxhdGl2ZXxhYnNvbHV0ZXxmaXhlZCkvKS50ZXN0KCQuY3NzKHRoaXMsInBvc2l0aW9uIikpICYmICgvKGF1dG98c2Nyb2xsKS8pLnRlc3QoJC5jc3ModGhpcywib3ZlcmZsb3ciKSskLmNzcyh0aGlzLCJvdmVyZmxvdy15IikrJC5jc3ModGhpcywib3ZlcmZsb3cteCIpKTsKCQkJfSkuZXEoMCk7CgkJfSBlbHNlIHsKCQkJc2Nyb2xsUGFyZW50ID0gdGhpcy5wYXJlbnRzKCkuZmlsdGVyKGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuICgvKGF1dG98c2Nyb2xsKS8pLnRlc3QoJC5jc3ModGhpcywib3ZlcmZsb3ciKSskLmNzcyh0aGlzLCJvdmVyZmxvdy15IikrJC5jc3ModGhpcywib3ZlcmZsb3cteCIpKTsKCQkJfSkuZXEoMCk7CgkJfQoKCQlyZXR1cm4gKCAvZml4ZWQvICkudGVzdCggdGhpcy5jc3MoICJwb3NpdGlvbiIpICkgfHwgIXNjcm9sbFBhcmVudC5sZW5ndGggPyAkKCB0aGlzWyAwIF0ub3duZXJEb2N1bWVudCB8fCBkb2N1bWVudCApIDogc2Nyb2xsUGFyZW50OwoJfSwKCgl1bmlxdWVJZDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJaWYgKCAhdGhpcy5pZCApIHsKCQkJCXRoaXMuaWQgPSAidWktaWQtIiArICgrK3V1aWQpOwoJCQl9CgkJfSk7Cgl9LAoKCXJlbW92ZVVuaXF1ZUlkOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQlpZiAoIHJ1bmlxdWVJZC50ZXN0KCB0aGlzLmlkICkgKSB7CgkJCQkkKCB0aGlzICkucmVtb3ZlQXR0ciggImlkIiApOwoJCQl9CgkJfSk7Cgl9Cn0pOwoKLy8gc2VsZWN0b3JzCmZ1bmN0aW9uIGZvY3VzYWJsZSggZWxlbWVudCwgaXNUYWJJbmRleE5vdE5hTiApIHsKCXZhciBtYXAsIG1hcE5hbWUsIGltZywKCQlub2RlTmFtZSA9IGVsZW1lbnQubm9kZU5hbWUudG9Mb3dlckNhc2UoKTsKCWlmICggImFyZWEiID09PSBub2RlTmFtZSApIHsKCQltYXAgPSBlbGVtZW50LnBhcmVudE5vZGU7CgkJbWFwTmFtZSA9IG1hcC5uYW1lOwoJCWlmICggIWVsZW1lbnQuaHJlZiB8fCAhbWFwTmFtZSB8fCBtYXAubm9kZU5hbWUudG9Mb3dlckNhc2UoKSAhPT0gIm1hcCIgKSB7CgkJCXJldHVybiBmYWxzZTsKCQl9CgkJaW1nID0gJCggImltZ1t1c2VtYXA9IyIgKyBtYXBOYW1lICsgIl0iIClbMF07CgkJcmV0dXJuICEhaW1nICYmIHZpc2libGUoIGltZyApOwoJfQoJcmV0dXJuICggL2lucHV0fHNlbGVjdHx0ZXh0YXJlYXxidXR0b258b2JqZWN0Ly50ZXN0KCBub2RlTmFtZSApID8KCQkhZWxlbWVudC5kaXNhYmxlZCA6CgkJImEiID09PSBub2RlTmFtZSA/CgkJCWVsZW1lbnQuaHJlZiB8fCBpc1RhYkluZGV4Tm90TmFOIDoKCQkJaXNUYWJJbmRleE5vdE5hTikgJiYKCQkvLyB0aGUgZWxlbWVudCBhbmQgYWxsIG9mIGl0cyBhbmNlc3RvcnMgbXVzdCBiZSB2aXNpYmxlCgkJdmlzaWJsZSggZWxlbWVudCApOwp9CgpmdW5jdGlvbiB2aXNpYmxlKCBlbGVtZW50ICkgewoJcmV0dXJuICQuZXhwci5maWx0ZXJzLnZpc2libGUoIGVsZW1lbnQgKSAmJgoJCSEkKCBlbGVtZW50ICkucGFyZW50cygpLmFkZEJhY2soKS5maWx0ZXIoZnVuY3Rpb24oKSB7CgkJCXJldHVybiAkLmNzcyggdGhpcywgInZpc2liaWxpdHkiICkgPT09ICJoaWRkZW4iOwoJCX0pLmxlbmd0aDsKfQoKJC5leHRlbmQoICQuZXhwclsgIjoiIF0sIHsKCWRhdGE6ICQuZXhwci5jcmVhdGVQc2V1ZG8gPwoJCSQuZXhwci5jcmVhdGVQc2V1ZG8oZnVuY3Rpb24oIGRhdGFOYW1lICkgewoJCQlyZXR1cm4gZnVuY3Rpb24oIGVsZW0gKSB7CgkJCQlyZXR1cm4gISEkLmRhdGEoIGVsZW0sIGRhdGFOYW1lICk7CgkJCX07CgkJfSkgOgoJCS8vIHN1cHBvcnQ6IGpRdWVyeSA8MS44CgkJZnVuY3Rpb24oIGVsZW0sIGksIG1hdGNoICkgewoJCQlyZXR1cm4gISEkLmRhdGEoIGVsZW0sIG1hdGNoWyAzIF0gKTsKCQl9LAoKCWZvY3VzYWJsZTogZnVuY3Rpb24oIGVsZW1lbnQgKSB7CgkJcmV0dXJuIGZvY3VzYWJsZSggZWxlbWVudCwgIWlzTmFOKCAkLmF0dHIoIGVsZW1lbnQsICJ0YWJpbmRleCIgKSApICk7Cgl9LAoKCXRhYmJhYmxlOiBmdW5jdGlvbiggZWxlbWVudCApIHsKCQl2YXIgdGFiSW5kZXggPSAkLmF0dHIoIGVsZW1lbnQsICJ0YWJpbmRleCIgKSwKCQkJaXNUYWJJbmRleE5hTiA9IGlzTmFOKCB0YWJJbmRleCApOwoJCXJldHVybiAoIGlzVGFiSW5kZXhOYU4gfHwgdGFiSW5kZXggPj0gMCApICYmIGZvY3VzYWJsZSggZWxlbWVudCwgIWlzVGFiSW5kZXhOYU4gKTsKCX0KfSk7CgovLyBzdXBwb3J0OiBqUXVlcnkgPDEuOAppZiAoICEkKCAiPGE+IiApLm91dGVyV2lkdGgoIDEgKS5qcXVlcnkgKSB7CgkkLmVhY2goIFsgIldpZHRoIiwgIkhlaWdodCIgXSwgZnVuY3Rpb24oIGksIG5hbWUgKSB7CgkJdmFyIHNpZGUgPSBuYW1lID09PSAiV2lkdGgiID8gWyAiTGVmdCIsICJSaWdodCIgXSA6IFsgIlRvcCIsICJCb3R0b20iIF0sCgkJCXR5cGUgPSBuYW1lLnRvTG93ZXJDYXNlKCksCgkJCW9yaWcgPSB7CgkJCQlpbm5lcldpZHRoOiAkLmZuLmlubmVyV2lkdGgsCgkJCQlpbm5lckhlaWdodDogJC5mbi5pbm5lckhlaWdodCwKCQkJCW91dGVyV2lkdGg6ICQuZm4ub3V0ZXJXaWR0aCwKCQkJCW91dGVySGVpZ2h0OiAkLmZuLm91dGVySGVpZ2h0CgkJCX07CgoJCWZ1bmN0aW9uIHJlZHVjZSggZWxlbSwgc2l6ZSwgYm9yZGVyLCBtYXJnaW4gKSB7CgkJCSQuZWFjaCggc2lkZSwgZnVuY3Rpb24oKSB7CgkJCQlzaXplIC09IHBhcnNlRmxvYXQoICQuY3NzKCBlbGVtLCAicGFkZGluZyIgKyB0aGlzICkgKSB8fCAwOwoJCQkJaWYgKCBib3JkZXIgKSB7CgkJCQkJc2l6ZSAtPSBwYXJzZUZsb2F0KCAkLmNzcyggZWxlbSwgImJvcmRlciIgKyB0aGlzICsgIldpZHRoIiApICkgfHwgMDsKCQkJCX0KCQkJCWlmICggbWFyZ2luICkgewoJCQkJCXNpemUgLT0gcGFyc2VGbG9hdCggJC5jc3MoIGVsZW0sICJtYXJnaW4iICsgdGhpcyApICkgfHwgMDsKCQkJCX0KCQkJfSk7CgkJCXJldHVybiBzaXplOwoJCX0KCgkJJC5mblsgImlubmVyIiArIG5hbWUgXSA9IGZ1bmN0aW9uKCBzaXplICkgewoJCQlpZiAoIHNpemUgPT09IHVuZGVmaW5lZCApIHsKCQkJCXJldHVybiBvcmlnWyAiaW5uZXIiICsgbmFtZSBdLmNhbGwoIHRoaXMgKTsKCQkJfQoKCQkJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJCSQoIHRoaXMgKS5jc3MoIHR5cGUsIHJlZHVjZSggdGhpcywgc2l6ZSApICsgInB4IiApOwoJCQl9KTsKCQl9OwoKCQkkLmZuWyAib3V0ZXIiICsgbmFtZV0gPSBmdW5jdGlvbiggc2l6ZSwgbWFyZ2luICkgewoJCQlpZiAoIHR5cGVvZiBzaXplICE9PSAibnVtYmVyIiApIHsKCQkJCXJldHVybiBvcmlnWyAib3V0ZXIiICsgbmFtZSBdLmNhbGwoIHRoaXMsIHNpemUgKTsKCQkJfQoKCQkJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJCSQoIHRoaXMpLmNzcyggdHlwZSwgcmVkdWNlKCB0aGlzLCBzaXplLCB0cnVlLCBtYXJnaW4gKSArICJweCIgKTsKCQkJfSk7CgkJfTsKCX0pOwp9CgovLyBzdXBwb3J0OiBqUXVlcnkgPDEuOAppZiAoICEkLmZuLmFkZEJhY2sgKSB7CgkkLmZuLmFkZEJhY2sgPSBmdW5jdGlvbiggc2VsZWN0b3IgKSB7CgkJcmV0dXJuIHRoaXMuYWRkKCBzZWxlY3RvciA9PSBudWxsID8KCQkJdGhpcy5wcmV2T2JqZWN0IDogdGhpcy5wcmV2T2JqZWN0LmZpbHRlciggc2VsZWN0b3IgKQoJCSk7Cgl9Owp9CgovLyBzdXBwb3J0OiBqUXVlcnkgMS42LjEsIDEuNi4yIChodHRwOi8vYnVncy5qcXVlcnkuY29tL3RpY2tldC85NDEzKQppZiAoICQoICI8YT4iICkuZGF0YSggImEtYiIsICJhIiApLnJlbW92ZURhdGEoICJhLWIiICkuZGF0YSggImEtYiIgKSApIHsKCSQuZm4ucmVtb3ZlRGF0YSA9IChmdW5jdGlvbiggcmVtb3ZlRGF0YSApIHsKCQlyZXR1cm4gZnVuY3Rpb24oIGtleSApIHsKCQkJaWYgKCBhcmd1bWVudHMubGVuZ3RoICkgewoJCQkJcmV0dXJuIHJlbW92ZURhdGEuY2FsbCggdGhpcywgJC5jYW1lbENhc2UoIGtleSApICk7CgkJCX0gZWxzZSB7CgkJCQlyZXR1cm4gcmVtb3ZlRGF0YS5jYWxsKCB0aGlzICk7CgkJCX0KCQl9OwoJfSkoICQuZm4ucmVtb3ZlRGF0YSApOwp9CgoKCgoKLy8gZGVwcmVjYXRlZAokLnVpLmllID0gISEvbXNpZSBbXHcuXSsvLmV4ZWMoIG5hdmlnYXRvci51c2VyQWdlbnQudG9Mb3dlckNhc2UoKSApOwoKJC5zdXBwb3J0LnNlbGVjdHN0YXJ0ID0gIm9uc2VsZWN0c3RhcnQiIGluIGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJkaXYiICk7CiQuZm4uZXh0ZW5kKHsKCWRpc2FibGVTZWxlY3Rpb246IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLmJpbmQoICggJC5zdXBwb3J0LnNlbGVjdHN0YXJ0ID8gInNlbGVjdHN0YXJ0IiA6ICJtb3VzZWRvd24iICkgKwoJCQkiLnVpLWRpc2FibGVTZWxlY3Rpb24iLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQl9KTsKCX0sCgoJZW5hYmxlU2VsZWN0aW9uOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy51bmJpbmQoICIudWktZGlzYWJsZVNlbGVjdGlvbiIgKTsKCX0sCgoJekluZGV4OiBmdW5jdGlvbiggekluZGV4ICkgewoJCWlmICggekluZGV4ICE9PSB1bmRlZmluZWQgKSB7CgkJCXJldHVybiB0aGlzLmNzcyggInpJbmRleCIsIHpJbmRleCApOwoJCX0KCgkJaWYgKCB0aGlzLmxlbmd0aCApIHsKCQkJdmFyIGVsZW0gPSAkKCB0aGlzWyAwIF0gKSwgcG9zaXRpb24sIHZhbHVlOwoJCQl3aGlsZSAoIGVsZW0ubGVuZ3RoICYmIGVsZW1bIDAgXSAhPT0gZG9jdW1lbnQgKSB7CgkJCQkvLyBJZ25vcmUgei1pbmRleCBpZiBwb3NpdGlvbiBpcyBzZXQgdG8gYSB2YWx1ZSB3aGVyZSB6LWluZGV4IGlzIGlnbm9yZWQgYnkgdGhlIGJyb3dzZXIKCQkJCS8vIFRoaXMgbWFrZXMgYmVoYXZpb3Igb2YgdGhpcyBmdW5jdGlvbiBjb25zaXN0ZW50IGFjcm9zcyBicm93c2VycwoJCQkJLy8gV2ViS2l0IGFsd2F5cyByZXR1cm5zIGF1dG8gaWYgdGhlIGVsZW1lbnQgaXMgcG9zaXRpb25lZAoJCQkJcG9zaXRpb24gPSBlbGVtLmNzcyggInBvc2l0aW9uIiApOwoJCQkJaWYgKCBwb3NpdGlvbiA9PT0gImFic29sdXRlIiB8fCBwb3NpdGlvbiA9PT0gInJlbGF0aXZlIiB8fCBwb3NpdGlvbiA9PT0gImZpeGVkIiApIHsKCQkJCQkvLyBJRSByZXR1cm5zIDAgd2hlbiB6SW5kZXggaXMgbm90IHNwZWNpZmllZAoJCQkJCS8vIG90aGVyIGJyb3dzZXJzIHJldHVybiBhIHN0cmluZwoJCQkJCS8vIHdlIGlnbm9yZSB0aGUgY2FzZSBvZiBuZXN0ZWQgZWxlbWVudHMgd2l0aCBhbiBleHBsaWNpdCB2YWx1ZSBvZiAwCgkJCQkJLy8gPGRpdiBzdHlsZT0iei1pbmRleDogLTEwOyI+PGRpdiBzdHlsZT0iei1pbmRleDogMDsiPjwvZGl2PjwvZGl2PgoJCQkJCXZhbHVlID0gcGFyc2VJbnQoIGVsZW0uY3NzKCAiekluZGV4IiApLCAxMCApOwoJCQkJCWlmICggIWlzTmFOKCB2YWx1ZSApICYmIHZhbHVlICE9PSAwICkgewoJCQkJCQlyZXR1cm4gdmFsdWU7CgkJCQkJfQoJCQkJfQoJCQkJZWxlbSA9IGVsZW0ucGFyZW50KCk7CgkJCX0KCQl9CgoJCXJldHVybiAwOwoJfQp9KTsKCi8vICQudWkucGx1Z2luIGlzIGRlcHJlY2F0ZWQuIFVzZSAkLndpZGdldCgpIGV4dGVuc2lvbnMgaW5zdGVhZC4KJC51aS5wbHVnaW4gPSB7CglhZGQ6IGZ1bmN0aW9uKCBtb2R1bGUsIG9wdGlvbiwgc2V0ICkgewoJCXZhciBpLAoJCQlwcm90byA9ICQudWlbIG1vZHVsZSBdLnByb3RvdHlwZTsKCQlmb3IgKCBpIGluIHNldCApIHsKCQkJcHJvdG8ucGx1Z2luc1sgaSBdID0gcHJvdG8ucGx1Z2luc1sgaSBdIHx8IFtdOwoJCQlwcm90by5wbHVnaW5zWyBpIF0ucHVzaCggWyBvcHRpb24sIHNldFsgaSBdIF0gKTsKCQl9Cgl9LAoJY2FsbDogZnVuY3Rpb24oIGluc3RhbmNlLCBuYW1lLCBhcmdzLCBhbGxvd0Rpc2Nvbm5lY3RlZCApIHsKCQl2YXIgaSwKCQkJc2V0ID0gaW5zdGFuY2UucGx1Z2luc1sgbmFtZSBdOwoKCQlpZiAoICFzZXQgKSB7CgkJCXJldHVybjsKCQl9CgoJCWlmICggIWFsbG93RGlzY29ubmVjdGVkICYmICggIWluc3RhbmNlLmVsZW1lbnRbIDAgXS5wYXJlbnROb2RlIHx8IGluc3RhbmNlLmVsZW1lbnRbIDAgXS5wYXJlbnROb2RlLm5vZGVUeXBlID09PSAxMSApICkgewoJCQlyZXR1cm47CgkJfQoKCQlmb3IgKCBpID0gMDsgaSA8IHNldC5sZW5ndGg7IGkrKyApIHsKCQkJaWYgKCBpbnN0YW5jZS5vcHRpb25zWyBzZXRbIGkgXVsgMCBdIF0gKSB7CgkJCQlzZXRbIGkgXVsgMSBdLmFwcGx5KCBpbnN0YW5jZS5lbGVtZW50LCBhcmdzICk7CgkJCX0KCQl9Cgl9Cn07Cgp9KSggalF1ZXJ5ICk7CihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgoJJC5leHRlbmQoICQubW9iaWxlLCB7CgkJLy8gZGVmaW5lIHRoZSB3aW5kb3cgYW5kIHRoZSBkb2N1bWVudCBvYmplY3RzCgkJd2luZG93OiAkKCB3aW5kb3cgKSwKCQlkb2N1bWVudDogJCggZG9jdW1lbnQgKSwKCgkJLy8gVE9ETzogUmVtb3ZlIGFuZCB1c2UgJC51aS5rZXlDb2RlIGRpcmVjdGx5CgkJa2V5Q29kZTogJC51aS5rZXlDb2RlLAoKCQkvLyBQbGFjZSB0byBzdG9yZSB2YXJpb3VzIHdpZGdldCBleHRlbnNpb25zCgkJYmVoYXZpb3JzOiB7fSwKCgkJLy8gU2Nyb2xsIHBhZ2UgdmVydGljYWxseTogc2Nyb2xsIHRvIDAgdG8gaGlkZSBpT1MgYWRkcmVzcyBiYXIsIG9yIHBhc3MgYSBZIHZhbHVlCgkJc2lsZW50U2Nyb2xsOiBmdW5jdGlvbiggeXBvcyApIHsKCQkJaWYgKCAkLnR5cGUoIHlwb3MgKSAhPT0gIm51bWJlciIgKSB7CgkJCQl5cG9zID0gJC5tb2JpbGUuZGVmYXVsdEhvbWVTY3JvbGw7CgkJCX0KCgkJCS8vIHByZXZlbnQgc2Nyb2xsc3RhcnQgYW5kIHNjcm9sbHN0b3AgZXZlbnRzCgkJCSQuZXZlbnQuc3BlY2lhbC5zY3JvbGxzdGFydC5lbmFibGVkID0gZmFsc2U7CgoJCQlzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoJCQkJd2luZG93LnNjcm9sbFRvKCAwLCB5cG9zICk7CgkJCQkkLm1vYmlsZS5kb2N1bWVudC50cmlnZ2VyKCAic2lsZW50c2Nyb2xsIiwgeyB4OiAwLCB5OiB5cG9zIH0pOwoJCQl9LCAyMCApOwoKCQkJc2V0VGltZW91dChmdW5jdGlvbigpIHsKCQkJCSQuZXZlbnQuc3BlY2lhbC5zY3JvbGxzdGFydC5lbmFibGVkID0gdHJ1ZTsKCQkJfSwgMTUwICk7CgkJfSwKCgkJZ2V0Q2xvc2VzdEJhc2VVcmw6IGZ1bmN0aW9uKCBlbGUgKQl7CgkJCS8vIEZpbmQgdGhlIGNsb3Nlc3QgcGFnZSBhbmQgZXh0cmFjdCBvdXQgaXRzIHVybC4KCQkJdmFyIHVybCA9ICQoIGVsZSApLmNsb3Nlc3QoICIudWktcGFnZSIgKS5qcW1EYXRhKCAidXJsIiApLAoJCQkJYmFzZSA9ICQubW9iaWxlLnBhdGguZG9jdW1lbnRCYXNlLmhyZWZOb0hhc2g7CgoJCQlpZiAoICEkLm1vYmlsZS5keW5hbWljQmFzZUVuYWJsZWQgfHwgIXVybCB8fCAhJC5tb2JpbGUucGF0aC5pc1BhdGgoIHVybCApICkgewoJCQkJdXJsID0gYmFzZTsKCQkJfQoKCQkJcmV0dXJuICQubW9iaWxlLnBhdGgubWFrZVVybEFic29sdXRlKCB1cmwsIGJhc2UgKTsKCQl9LAoJCXJlbW92ZUFjdGl2ZUxpbmtDbGFzczogZnVuY3Rpb24oIGZvcmNlUmVtb3ZhbCApIHsKCQkJaWYgKCAhISQubW9iaWxlLmFjdGl2ZUNsaWNrZWRMaW5rICYmCgkJCQkoICEkLm1vYmlsZS5hY3RpdmVDbGlja2VkTGluay5jbG9zZXN0KCAiLiIgKyAkLm1vYmlsZS5hY3RpdmVQYWdlQ2xhc3MgKS5sZW5ndGggfHwKCQkJCQlmb3JjZVJlbW92YWwgKSApIHsKCgkJCQkkLm1vYmlsZS5hY3RpdmVDbGlja2VkTGluay5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJfQoJCQkkLm1vYmlsZS5hY3RpdmVDbGlja2VkTGluayA9IG51bGw7CgkJfSwKCgkJLy8gREVQUkVDQVRFRCBpbiAxLjQKCQkvLyBGaW5kIHRoZSBjbG9zZXN0IHBhcmVudCB3aXRoIGEgdGhlbWUgY2xhc3Mgb24gaXQuIE5vdGUgdGhhdAoJCS8vIHdlIGFyZSBub3QgdXNpbmcgJC5mbi5jbG9zZXN0KCkgb24gcHVycG9zZSBoZXJlIGJlY2F1c2UgdGhpcwoJCS8vIG1ldGhvZCBnZXRzIGNhbGxlZCBxdWl0ZSBhIGJpdCBhbmQgd2UgbmVlZCBpdCB0byBiZSBhcyBmYXN0CgkJLy8gYXMgcG9zc2libGUuCgkJZ2V0SW5oZXJpdGVkVGhlbWU6IGZ1bmN0aW9uKCBlbCwgZGVmYXVsdFRoZW1lICkgewoJCQl2YXIgZSA9IGVsWyAwIF0sCgkJCQlsdHIgPSAiIiwKCQkJCXJlID0gL3VpLShiYXJ8Ym9keXxvdmVybGF5KS0oW2Etel0pXGIvLAoJCQkJYywgbTsKCQkJd2hpbGUgKCBlICkgewoJCQkJYyA9IGUuY2xhc3NOYW1lIHx8ICIiOwoJCQkJaWYgKCBjICYmICggbSA9IHJlLmV4ZWMoIGMgKSApICYmICggbHRyID0gbVsgMiBdICkgKSB7CgkJCQkJLy8gV2UgZm91bmQgYSBwYXJlbnQgd2l0aCBhIHRoZW1lIGNsYXNzCgkJCQkJLy8gb24gaXQgc28gYmFpbCBmcm9tIHRoaXMgbG9vcC4KCQkJCQlicmVhazsKCQkJCX0KCgkJCQllID0gZS5wYXJlbnROb2RlOwoJCQl9CgkJCS8vIFJldHVybiB0aGUgdGhlbWUgbGV0dGVyIHdlIGZvdW5kLCBpZiBub25lLCByZXR1cm4gdGhlCgkJCS8vIHNwZWNpZmllZCBkZWZhdWx0LgoJCQlyZXR1cm4gbHRyIHx8IGRlZmF1bHRUaGVtZSB8fCAiYSI7CgkJfSwKCgkJZW5oYW5jZWFibGU6IGZ1bmN0aW9uKCBlbGVtZW50cyApIHsKCQkJcmV0dXJuIHRoaXMuaGF2ZVBhcmVudHMoIGVsZW1lbnRzLCAiZW5oYW5jZSIgKTsKCQl9LAoKCQloaWphY2thYmxlOiBmdW5jdGlvbiggZWxlbWVudHMgKSB7CgkJCXJldHVybiB0aGlzLmhhdmVQYXJlbnRzKCBlbGVtZW50cywgImFqYXgiICk7CgkJfSwKCgkJaGF2ZVBhcmVudHM6IGZ1bmN0aW9uKCBlbGVtZW50cywgYXR0ciApIHsKCQkJaWYgKCAhJC5tb2JpbGUuaWdub3JlQ29udGVudEVuYWJsZWQgKSB7CgkJCQlyZXR1cm4gZWxlbWVudHM7CgkJCX0KCgkJCXZhciBjb3VudCA9IGVsZW1lbnRzLmxlbmd0aCwKCQkJCSRuZXdTZXQgPSAkKCksCgkJCQllLCAkZWxlbWVudCwgZXhjbHVkZWQsCgkJCQlpLCBjOwoKCQkJZm9yICggaSA9IDA7IGkgPCBjb3VudDsgaSsrICkgewoJCQkJJGVsZW1lbnQgPSBlbGVtZW50cy5lcSggaSApOwoJCQkJZXhjbHVkZWQgPSBmYWxzZTsKCQkJCWUgPSBlbGVtZW50c1sgaSBdOwoKCQkJCXdoaWxlICggZSApIHsKCQkJCQljID0gZS5nZXRBdHRyaWJ1dGUgPyBlLmdldEF0dHJpYnV0ZSggImRhdGEtIiArICQubW9iaWxlLm5zICsgYXR0ciApIDogIiI7CgoJCQkJCWlmICggYyA9PT0gImZhbHNlIiApIHsKCQkJCQkJZXhjbHVkZWQgPSB0cnVlOwoJCQkJCQlicmVhazsKCQkJCQl9CgoJCQkJCWUgPSBlLnBhcmVudE5vZGU7CgkJCQl9CgoJCQkJaWYgKCAhZXhjbHVkZWQgKSB7CgkJCQkJJG5ld1NldCA9ICRuZXdTZXQuYWRkKCAkZWxlbWVudCApOwoJCQkJfQoJCQl9CgoJCQlyZXR1cm4gJG5ld1NldDsKCQl9LAoKCQlnZXRTY3JlZW5IZWlnaHQ6IGZ1bmN0aW9uKCkgewoJCQkvLyBOYXRpdmUgaW5uZXJIZWlnaHQgcmV0dXJucyBtb3JlIGFjY3VyYXRlIHZhbHVlIGZvciB0aGlzIGFjcm9zcyBwbGF0Zm9ybXMsCgkJCS8vIGpRdWVyeSB2ZXJzaW9uIGlzIGhlcmUgYXMgYSBub3JtYWxpemVkIGZhbGxiYWNrIGZvciBwbGF0Zm9ybXMgbGlrZSBTeW1iaWFuCgkJCXJldHVybiB3aW5kb3cuaW5uZXJIZWlnaHQgfHwgJC5tb2JpbGUud2luZG93LmhlaWdodCgpOwoJCX0sCgoJCS8vc2ltcGx5IHNldCB0aGUgYWN0aXZlIHBhZ2UncyBtaW5pbXVtIGhlaWdodCB0byBzY3JlZW4gaGVpZ2h0LCBkZXBlbmRpbmcgb24gb3JpZW50YXRpb24KCQlyZXNldEFjdGl2ZVBhZ2VIZWlnaHQ6IGZ1bmN0aW9uKCBoZWlnaHQgKSB7CgkJCXZhciBwYWdlID0gJCggIi4iICsgJC5tb2JpbGUuYWN0aXZlUGFnZUNsYXNzICksCgkJCQlwYWdlSGVpZ2h0ID0gcGFnZS5oZWlnaHQoKSwKCQkJCXBhZ2VPdXRlckhlaWdodCA9IHBhZ2Uub3V0ZXJIZWlnaHQoIHRydWUgKTsKCgkJCWhlaWdodCA9ICggdHlwZW9mIGhlaWdodCA9PT0gIm51bWJlciIgKSA/IGhlaWdodCA6ICQubW9iaWxlLmdldFNjcmVlbkhlaWdodCgpOwoKCQkJcGFnZS5jc3MoICJtaW4taGVpZ2h0IiwgaGVpZ2h0IC0gKCBwYWdlT3V0ZXJIZWlnaHQgLSBwYWdlSGVpZ2h0ICkgKTsKCQl9LAoKCQlsb2FkaW5nOiBmdW5jdGlvbigpIHsKCQkJLy8gSWYgdGhpcyBpcyB0aGUgZmlyc3QgY2FsbCB0byB0aGlzIGZ1bmN0aW9uLCBpbnN0YW50aWF0ZSBhIGxvYWRlciB3aWRnZXQKCQkJdmFyIGxvYWRlciA9IHRoaXMubG9hZGluZy5fd2lkZ2V0IHx8ICQoICQubW9iaWxlLmxvYWRlci5wcm90b3R5cGUuZGVmYXVsdEh0bWwgKS5sb2FkZXIoKSwKCgkJCQkvLyBDYWxsIHRoZSBhcHByb3ByaWF0ZSBtZXRob2Qgb24gdGhlIGxvYWRlcgoJCQkJcmV0dXJuVmFsdWUgPSBsb2FkZXIubG9hZGVyLmFwcGx5KCBsb2FkZXIsIGFyZ3VtZW50cyApOwoKCQkJLy8gTWFrZSBzdXJlIHRoZSBsb2FkZXIgaXMgcmV0YWluZWQgZm9yIGZ1dHVyZSBjYWxscyB0byB0aGlzIGZ1bmN0aW9uLgoJCQl0aGlzLmxvYWRpbmcuX3dpZGdldCA9IGxvYWRlcjsKCgkJCXJldHVybiByZXR1cm5WYWx1ZTsKCQl9Cgl9KTsKCgkkLmFkZERlcGVuZGVudHMgPSBmdW5jdGlvbiggZWxlbSwgbmV3RGVwZW5kZW50cyApIHsKCQl2YXIgJGVsZW0gPSAkKCBlbGVtICksCgkJCWRlcGVuZGVudHMgPSAkZWxlbS5qcW1EYXRhKCAiZGVwZW5kZW50cyIgKSB8fCAkKCk7CgoJCSRlbGVtLmpxbURhdGEoICJkZXBlbmRlbnRzIiwgJCggZGVwZW5kZW50cyApLmFkZCggbmV3RGVwZW5kZW50cyApICk7Cgl9OwoKCS8vIHBsdWdpbnMKCSQuZm4uZXh0ZW5kKHsKCQlyZW1vdmVXaXRoRGVwZW5kZW50czogZnVuY3Rpb24oKSB7CgkJCSQucmVtb3ZlV2l0aERlcGVuZGVudHMoIHRoaXMgKTsKCQl9LAoKCQkvLyBFbmhhbmNlIGNoaWxkIGVsZW1lbnRzCgkJZW5oYW5jZVdpdGhpbjogZnVuY3Rpb24oKSB7CgkJCXZhciB3aWRnZXRFbGVtZW50cywKCQkJCXRoYXQgPSB0aGlzOwoKCQkJLy8gQWRkIG5vIGpzIGNsYXNzIHRvIGVsZW1lbnRzCgkJCWlmICggJC5tb2JpbGUubm9qcyApIHsKCQkJCSQubW9iaWxlLm5vanMoIHRoaXMgKTsKCQkJfQoKCQkJLy8gQmluZCBsaW5rcyBmb3IgYWpheCBuYXYKCQkJaWYgKCAkLm1vYmlsZS5saW5rcyApIHsKCQkJCSQubW9iaWxlLmxpbmtzKCB0aGlzICk7CgkJCX0KCgkJCS8vIERlZ3JhZGUgaW5wdXRzIGZvciBzdHlsZWluZwoJCQlpZiAoICQubW9iaWxlLmRlZ3JhZGVJbnB1dHNXaXRoaW4gKSB7CgkJCQkkLm1vYmlsZS5kZWdyYWRlSW5wdXRzV2l0aGluKCB0aGlzICk7CgkJCX0KCgkJCS8vIFJ1biBidXR0b25tYXJrdXAKCQkJaWYgKCAkLmZuLmJ1dHRvbk1hcmt1cCApIHsKCQkJCSQoICQuZm4uYnV0dG9uTWFya3VwLmluaXRTZWxlY3RvciApLmJ1dHRvbk1hcmt1cCgpOwoJCQl9CgoJCQkvLyBBZGQgY2xhc3NlcyBmb3IgZmllbGRDb250YWluCgkJCWlmICggJC5mbi5maWVsZGNvbnRhaW4gKSB7CgkJCQl0aGlzLmZpbmQoICI6anFtRGF0YShyb2xlPSdmaWVsZGNvbnRhaW4nKSIgKS5qcW1FbmhhbmNlYWJsZSgpLmZpZWxkY29udGFpbigpOwoJCQl9CgoJCQkvLyBFbmhhbmNlIHdpZGdldHMKCQkJJC5lYWNoKCAkLm1vYmlsZS53aWRnZXRzLCBmdW5jdGlvbiggbmFtZSwgY29uc3RydWN0b3IgKSB7CgoJCQkJLy8gSWYgaW5pdFNlbGVjdG9yIG5vdCBmYWxzZSBmaW5kIGVsZW1lbnRzCgkJCQlpZiAoIGNvbnN0cnVjdG9yLmluaXRTZWxlY3RvciApIHsKCgkJCQkJLy8gRmlsdGVyIGVsZW1lbnRzIHRoYXQgc2hvdWxkIG5vdCBiZSBlbmhhbmNlZCBiYXNlZCBvbiBwYXJlbnRzCgkJCQkJd2lkZ2V0RWxlbWVudHMgPSAkLm1vYmlsZS5lbmhhbmNlYWJsZSggdGhhdC5maW5kKCBjb25zdHJ1Y3Rvci5pbml0U2VsZWN0b3IgKSApOwoKCQkJCQkvLyBJZiBhbnkgbWF0Y2hpbmcgZWxlbWVudHMgcmVtYWluIGZpbHRlciBvbmVzIHdpdGgga2VlcE5hdGl2ZVNlbGVjdG9yCgkJCQkJaWYgKCB3aWRnZXRFbGVtZW50cy5sZW5ndGggKSB7CgoJCQkJCQkvLyAkLm1vYmlsZS5wYWdlLnByb3RvdHlwZS5rZWVwTmF0aXZlU2VsZWN0b3IgaXMgZGVwcmVjYXRlZCB0aGlzIGlzIGp1c3QgZm9yIGJhY2tjb21wYXQKCQkJCQkJLy8gU3dpdGNoIHRvICQubW9iaWxlLmtlZXBOYXRpdmUgaW4gMS41IHdoaWNoIGlzIGp1c3QgYSB2YWx1ZSBub3QgYSBmdW5jdGlvbgoJCQkJCQl3aWRnZXRFbGVtZW50cyA9IHdpZGdldEVsZW1lbnRzLm5vdCggJC5tb2JpbGUucGFnZS5wcm90b3R5cGUua2VlcE5hdGl2ZVNlbGVjdG9yKCkgKTsKCQkJCQl9CgoJCQkJCS8vIEVuaGFuY2Ugd2hhdGV2ZXIgaXMgbGVmdAoJCQkJCXdpZGdldEVsZW1lbnRzWyBjb25zdHJ1Y3Rvci5wcm90b3R5cGUud2lkZ2V0TmFtZSBdKCk7CgkJCQl9CgkJCX0pOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSwKCgkJYWRkRGVwZW5kZW50czogZnVuY3Rpb24oIG5ld0RlcGVuZGVudHMgKSB7CgkJCSQuYWRkRGVwZW5kZW50cyggdGhpcywgbmV3RGVwZW5kZW50cyApOwoJCX0sCgoJCS8vIG5vdGUgdGhhdCB0aGlzIGhlbHBlciBkb2Vzbid0IGF0dGVtcHQgdG8gaGFuZGxlIHRoZSBjYWxsYmFjawoJCS8vIG9yIHNldHRpbmcgb2YgYW4gaHRtbCBlbGVtZW50J3MgdGV4dCwgaXRzIG9ubHkgcHVycG9zZSBpcwoJCS8vIHRvIHJldHVybiB0aGUgaHRtbCBlbmNvZGVkIHZlcnNpb24gb2YgdGhlIHRleHQgaW4gYWxsIGNhc2VzLiAodGh1cyB0aGUgbmFtZSkKCQlnZXRFbmNvZGVkVGV4dDogZnVuY3Rpb24oKSB7CgkJCXJldHVybiAkKCAiPGE+IiApLnRleHQoIHRoaXMudGV4dCgpICkuaHRtbCgpOwoJCX0sCgoJCS8vIGZsdWVudCBoZWxwZXIgZnVuY3Rpb24gZm9yIHRoZSBtb2JpbGUgbmFtZXNwYWNlZCBlcXVpdmFsZW50CgkJanFtRW5oYW5jZWFibGU6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gJC5tb2JpbGUuZW5oYW5jZWFibGUoIHRoaXMgKTsKCQl9LAoKCQlqcW1IaWphY2thYmxlOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuICQubW9iaWxlLmhpamFja2FibGUoIHRoaXMgKTsKCQl9Cgl9KTsKCgkkLnJlbW92ZVdpdGhEZXBlbmRlbnRzID0gZnVuY3Rpb24oIG5hdGl2ZUVsZW1lbnQgKSB7CgkJdmFyIGVsZW1lbnQgPSAkKCBuYXRpdmVFbGVtZW50ICk7CgoJCSggZWxlbWVudC5qcW1EYXRhKCAiZGVwZW5kZW50cyIgKSB8fCAkKCkgKS5yZW1vdmUoKTsKCQllbGVtZW50LnJlbW92ZSgpOwoJfTsKCSQuYWRkRGVwZW5kZW50cyA9IGZ1bmN0aW9uKCBuYXRpdmVFbGVtZW50LCBuZXdEZXBlbmRlbnRzICkgewoJCXZhciBlbGVtZW50ID0gJCggbmF0aXZlRWxlbWVudCApLAoJCQlkZXBlbmRlbnRzID0gZWxlbWVudC5qcW1EYXRhKCAiZGVwZW5kZW50cyIgKSB8fCAkKCk7CgoJCWVsZW1lbnQuanFtRGF0YSggImRlcGVuZGVudHMiLCAkKCBkZXBlbmRlbnRzICkuYWRkKCBuZXdEZXBlbmRlbnRzICkgKTsKCX07CgoJJC5maW5kLm1hdGNoZXMgPSBmdW5jdGlvbiggZXhwciwgc2V0ICkgewoJCXJldHVybiAkLmZpbmQoIGV4cHIsIG51bGwsIG51bGwsIHNldCApOwoJfTsKCgkkLmZpbmQubWF0Y2hlc1NlbGVjdG9yID0gZnVuY3Rpb24oIG5vZGUsIGV4cHIgKSB7CgkJcmV0dXJuICQuZmluZCggZXhwciwgbnVsbCwgbnVsbCwgWyBub2RlIF0gKS5sZW5ndGggPiAwOwoJfTsKCn0pKCBqUXVlcnksIHRoaXMgKTsKCgovKiEKICogalF1ZXJ5IFVJIFdpZGdldCBAVkVSU0lPTgogKiBodHRwOi8vanF1ZXJ5dWkuY29tCiAqCiAqIENvcHlyaWdodCAyMDEzIGpRdWVyeSBGb3VuZGF0aW9uIGFuZCBvdGhlciBjb250cmlidXRvcnMKICogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLgogKiBodHRwOi8vanF1ZXJ5Lm9yZy9saWNlbnNlCiAqCiAqIGh0dHA6Ly9hcGkuanF1ZXJ5dWkuY29tL2pRdWVyeS53aWRnZXQvCiAqLwooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCnZhciB1dWlkID0gMCwKCXNsaWNlID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLAoJX2NsZWFuRGF0YSA9ICQuY2xlYW5EYXRhOwokLmNsZWFuRGF0YSA9IGZ1bmN0aW9uKCBlbGVtcyApIHsKCWZvciAoIHZhciBpID0gMCwgZWxlbTsgKGVsZW0gPSBlbGVtc1tpXSkgIT0gbnVsbDsgaSsrICkgewoJCXRyeSB7CgkJCSQoIGVsZW0gKS50cmlnZ2VySGFuZGxlciggInJlbW92ZSIgKTsKCQkvLyBodHRwOi8vYnVncy5qcXVlcnkuY29tL3RpY2tldC84MjM1CgkJfSBjYXRjaCggZSApIHt9Cgl9CglfY2xlYW5EYXRhKCBlbGVtcyApOwp9OwoKJC53aWRnZXQgPSBmdW5jdGlvbiggbmFtZSwgYmFzZSwgcHJvdG90eXBlICkgewoJdmFyIGZ1bGxOYW1lLCBleGlzdGluZ0NvbnN0cnVjdG9yLCBjb25zdHJ1Y3RvciwgYmFzZVByb3RvdHlwZSwKCQkvLyBwcm94aWVkUHJvdG90eXBlIGFsbG93cyB0aGUgcHJvdmlkZWQgcHJvdG90eXBlIHRvIHJlbWFpbiB1bm1vZGlmaWVkCgkJLy8gc28gdGhhdCBpdCBjYW4gYmUgdXNlZCBhcyBhIG1peGluIGZvciBtdWx0aXBsZSB3aWRnZXRzICgjODg3NikKCQlwcm94aWVkUHJvdG90eXBlID0ge30sCgkJbmFtZXNwYWNlID0gbmFtZS5zcGxpdCggIi4iIClbIDAgXTsKCgluYW1lID0gbmFtZS5zcGxpdCggIi4iIClbIDEgXTsKCWZ1bGxOYW1lID0gbmFtZXNwYWNlICsgIi0iICsgbmFtZTsKCglpZiAoICFwcm90b3R5cGUgKSB7CgkJcHJvdG90eXBlID0gYmFzZTsKCQliYXNlID0gJC5XaWRnZXQ7Cgl9CgoJLy8gY3JlYXRlIHNlbGVjdG9yIGZvciBwbHVnaW4KCSQuZXhwclsgIjoiIF1bIGZ1bGxOYW1lLnRvTG93ZXJDYXNlKCkgXSA9IGZ1bmN0aW9uKCBlbGVtICkgewoJCXJldHVybiAhISQuZGF0YSggZWxlbSwgZnVsbE5hbWUgKTsKCX07CgoJJFsgbmFtZXNwYWNlIF0gPSAkWyBuYW1lc3BhY2UgXSB8fCB7fTsKCWV4aXN0aW5nQ29uc3RydWN0b3IgPSAkWyBuYW1lc3BhY2UgXVsgbmFtZSBdOwoJY29uc3RydWN0b3IgPSAkWyBuYW1lc3BhY2UgXVsgbmFtZSBdID0gZnVuY3Rpb24oIG9wdGlvbnMsIGVsZW1lbnQgKSB7CgkJLy8gYWxsb3cgaW5zdGFudGlhdGlvbiB3aXRob3V0ICJuZXciIGtleXdvcmQKCQlpZiAoICF0aGlzLl9jcmVhdGVXaWRnZXQgKSB7CgkJCXJldHVybiBuZXcgY29uc3RydWN0b3IoIG9wdGlvbnMsIGVsZW1lbnQgKTsKCQl9CgoJCS8vIGFsbG93IGluc3RhbnRpYXRpb24gd2l0aG91dCBpbml0aWFsaXppbmcgZm9yIHNpbXBsZSBpbmhlcml0YW5jZQoJCS8vIG11c3QgdXNlICJuZXciIGtleXdvcmQgKHRoZSBjb2RlIGFib3ZlIGFsd2F5cyBwYXNzZXMgYXJncykKCQlpZiAoIGFyZ3VtZW50cy5sZW5ndGggKSB7CgkJCXRoaXMuX2NyZWF0ZVdpZGdldCggb3B0aW9ucywgZWxlbWVudCApOwoJCX0KCX07CgkvLyBleHRlbmQgd2l0aCB0aGUgZXhpc3RpbmcgY29uc3RydWN0b3IgdG8gY2Fycnkgb3ZlciBhbnkgc3RhdGljIHByb3BlcnRpZXMKCSQuZXh0ZW5kKCBjb25zdHJ1Y3RvciwgZXhpc3RpbmdDb25zdHJ1Y3RvciwgewoJCXZlcnNpb246IHByb3RvdHlwZS52ZXJzaW9uLAoJCS8vIGNvcHkgdGhlIG9iamVjdCB1c2VkIHRvIGNyZWF0ZSB0aGUgcHJvdG90eXBlIGluIGNhc2Ugd2UgbmVlZCB0bwoJCS8vIHJlZGVmaW5lIHRoZSB3aWRnZXQgbGF0ZXIKCQlfcHJvdG86ICQuZXh0ZW5kKCB7fSwgcHJvdG90eXBlICksCgkJLy8gdHJhY2sgd2lkZ2V0cyB0aGF0IGluaGVyaXQgZnJvbSB0aGlzIHdpZGdldCBpbiBjYXNlIHRoaXMgd2lkZ2V0IGlzCgkJLy8gcmVkZWZpbmVkIGFmdGVyIGEgd2lkZ2V0IGluaGVyaXRzIGZyb20gaXQKCQlfY2hpbGRDb25zdHJ1Y3RvcnM6IFtdCgl9KTsKCgliYXNlUHJvdG90eXBlID0gbmV3IGJhc2UoKTsKCS8vIHdlIG5lZWQgdG8gbWFrZSB0aGUgb3B0aW9ucyBoYXNoIGEgcHJvcGVydHkgZGlyZWN0bHkgb24gdGhlIG5ldyBpbnN0YW5jZQoJLy8gb3RoZXJ3aXNlIHdlJ2xsIG1vZGlmeSB0aGUgb3B0aW9ucyBoYXNoIG9uIHRoZSBwcm90b3R5cGUgdGhhdCB3ZSdyZQoJLy8gaW5oZXJpdGluZyBmcm9tCgliYXNlUHJvdG90eXBlLm9wdGlvbnMgPSAkLndpZGdldC5leHRlbmQoIHt9LCBiYXNlUHJvdG90eXBlLm9wdGlvbnMgKTsKCSQuZWFjaCggcHJvdG90eXBlLCBmdW5jdGlvbiggcHJvcCwgdmFsdWUgKSB7CgkJaWYgKCAhJC5pc0Z1bmN0aW9uKCB2YWx1ZSApICkgewoJCQlwcm94aWVkUHJvdG90eXBlWyBwcm9wIF0gPSB2YWx1ZTsKCQkJcmV0dXJuOwoJCX0KCQlwcm94aWVkUHJvdG90eXBlWyBwcm9wIF0gPSAoZnVuY3Rpb24oKSB7CgkJCXZhciBfc3VwZXIgPSBmdW5jdGlvbigpIHsKCQkJCQlyZXR1cm4gYmFzZS5wcm90b3R5cGVbIHByb3AgXS5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgkJCQl9LAoJCQkJX3N1cGVyQXBwbHkgPSBmdW5jdGlvbiggYXJncyApIHsKCQkJCQlyZXR1cm4gYmFzZS5wcm90b3R5cGVbIHByb3AgXS5hcHBseSggdGhpcywgYXJncyApOwoJCQkJfTsKCQkJcmV0dXJuIGZ1bmN0aW9uKCkgewoJCQkJdmFyIF9fc3VwZXIgPSB0aGlzLl9zdXBlciwKCQkJCQlfX3N1cGVyQXBwbHkgPSB0aGlzLl9zdXBlckFwcGx5LAoJCQkJCXJldHVyblZhbHVlOwoKCQkJCXRoaXMuX3N1cGVyID0gX3N1cGVyOwoJCQkJdGhpcy5fc3VwZXJBcHBseSA9IF9zdXBlckFwcGx5OwoKCQkJCXJldHVyblZhbHVlID0gdmFsdWUuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwoKCQkJCXRoaXMuX3N1cGVyID0gX19zdXBlcjsKCQkJCXRoaXMuX3N1cGVyQXBwbHkgPSBfX3N1cGVyQXBwbHk7CgoJCQkJcmV0dXJuIHJldHVyblZhbHVlOwoJCQl9OwoJCX0pKCk7Cgl9KTsKCWNvbnN0cnVjdG9yLnByb3RvdHlwZSA9ICQud2lkZ2V0LmV4dGVuZCggYmFzZVByb3RvdHlwZSwgewoJCS8vIFRPRE86IHJlbW92ZSBzdXBwb3J0IGZvciB3aWRnZXRFdmVudFByZWZpeAoJCS8vIGFsd2F5cyB1c2UgdGhlIG5hbWUgKyBhIGNvbG9uIGFzIHRoZSBwcmVmaXgsIGUuZy4sIGRyYWdnYWJsZTpzdGFydAoJCS8vIGRvbid0IHByZWZpeCBmb3Igd2lkZ2V0cyB0aGF0IGFyZW4ndCBET00tYmFzZWQKCQl3aWRnZXRFdmVudFByZWZpeDogZXhpc3RpbmdDb25zdHJ1Y3RvciA/IChiYXNlUHJvdG90eXBlLndpZGdldEV2ZW50UHJlZml4IHx8IG5hbWUpIDogbmFtZQoJfSwgcHJveGllZFByb3RvdHlwZSwgewoJCWNvbnN0cnVjdG9yOiBjb25zdHJ1Y3RvciwKCQluYW1lc3BhY2U6IG5hbWVzcGFjZSwKCQl3aWRnZXROYW1lOiBuYW1lLAoJCXdpZGdldEZ1bGxOYW1lOiBmdWxsTmFtZQoJfSk7CgoJLy8gSWYgdGhpcyB3aWRnZXQgaXMgYmVpbmcgcmVkZWZpbmVkIHRoZW4gd2UgbmVlZCB0byBmaW5kIGFsbCB3aWRnZXRzIHRoYXQKCS8vIGFyZSBpbmhlcml0aW5nIGZyb20gaXQgYW5kIHJlZGVmaW5lIGFsbCBvZiB0aGVtIHNvIHRoYXQgdGhleSBpbmhlcml0IGZyb20KCS8vIHRoZSBuZXcgdmVyc2lvbiBvZiB0aGlzIHdpZGdldC4gV2UncmUgZXNzZW50aWFsbHkgdHJ5aW5nIHRvIHJlcGxhY2Ugb25lCgkvLyBsZXZlbCBpbiB0aGUgcHJvdG90eXBlIGNoYWluLgoJaWYgKCBleGlzdGluZ0NvbnN0cnVjdG9yICkgewoJCSQuZWFjaCggZXhpc3RpbmdDb25zdHJ1Y3Rvci5fY2hpbGRDb25zdHJ1Y3RvcnMsIGZ1bmN0aW9uKCBpLCBjaGlsZCApIHsKCQkJdmFyIGNoaWxkUHJvdG90eXBlID0gY2hpbGQucHJvdG90eXBlOwoKCQkJLy8gcmVkZWZpbmUgdGhlIGNoaWxkIHdpZGdldCB1c2luZyB0aGUgc2FtZSBwcm90b3R5cGUgdGhhdCB3YXMKCQkJLy8gb3JpZ2luYWxseSB1c2VkLCBidXQgaW5oZXJpdCBmcm9tIHRoZSBuZXcgdmVyc2lvbiBvZiB0aGUgYmFzZQoJCQkkLndpZGdldCggY2hpbGRQcm90b3R5cGUubmFtZXNwYWNlICsgIi4iICsgY2hpbGRQcm90b3R5cGUud2lkZ2V0TmFtZSwgY29uc3RydWN0b3IsIGNoaWxkLl9wcm90byApOwoJCX0pOwoJCS8vIHJlbW92ZSB0aGUgbGlzdCBvZiBleGlzdGluZyBjaGlsZCBjb25zdHJ1Y3RvcnMgZnJvbSB0aGUgb2xkIGNvbnN0cnVjdG9yCgkJLy8gc28gdGhlIG9sZCBjaGlsZCBjb25zdHJ1Y3RvcnMgY2FuIGJlIGdhcmJhZ2UgY29sbGVjdGVkCgkJZGVsZXRlIGV4aXN0aW5nQ29uc3RydWN0b3IuX2NoaWxkQ29uc3RydWN0b3JzOwoJfSBlbHNlIHsKCQliYXNlLl9jaGlsZENvbnN0cnVjdG9ycy5wdXNoKCBjb25zdHJ1Y3RvciApOwoJfQoKCSQud2lkZ2V0LmJyaWRnZSggbmFtZSwgY29uc3RydWN0b3IgKTsKCglyZXR1cm4gY29uc3RydWN0b3I7Cn07CgokLndpZGdldC5leHRlbmQgPSBmdW5jdGlvbiggdGFyZ2V0ICkgewoJdmFyIGlucHV0ID0gc2xpY2UuY2FsbCggYXJndW1lbnRzLCAxICksCgkJaW5wdXRJbmRleCA9IDAsCgkJaW5wdXRMZW5ndGggPSBpbnB1dC5sZW5ndGgsCgkJa2V5LAoJCXZhbHVlOwoJZm9yICggOyBpbnB1dEluZGV4IDwgaW5wdXRMZW5ndGg7IGlucHV0SW5kZXgrKyApIHsKCQlmb3IgKCBrZXkgaW4gaW5wdXRbIGlucHV0SW5kZXggXSApIHsKCQkJdmFsdWUgPSBpbnB1dFsgaW5wdXRJbmRleCBdWyBrZXkgXTsKCQkJaWYgKCBpbnB1dFsgaW5wdXRJbmRleCBdLmhhc093blByb3BlcnR5KCBrZXkgKSAmJiB2YWx1ZSAhPT0gdW5kZWZpbmVkICkgewoJCQkJLy8gQ2xvbmUgb2JqZWN0cwoJCQkJaWYgKCAkLmlzUGxhaW5PYmplY3QoIHZhbHVlICkgKSB7CgkJCQkJdGFyZ2V0WyBrZXkgXSA9ICQuaXNQbGFpbk9iamVjdCggdGFyZ2V0WyBrZXkgXSApID8KCQkJCQkJJC53aWRnZXQuZXh0ZW5kKCB7fSwgdGFyZ2V0WyBrZXkgXSwgdmFsdWUgKSA6CgkJCQkJCS8vIERvbid0IGV4dGVuZCBzdHJpbmdzLCBhcnJheXMsIGV0Yy4gd2l0aCBvYmplY3RzCgkJCQkJCSQud2lkZ2V0LmV4dGVuZCgge30sIHZhbHVlICk7CgkJCQkvLyBDb3B5IGV2ZXJ5dGhpbmcgZWxzZSBieSByZWZlcmVuY2UKCQkJCX0gZWxzZSB7CgkJCQkJdGFyZ2V0WyBrZXkgXSA9IHZhbHVlOwoJCQkJfQoJCQl9CgkJfQoJfQoJcmV0dXJuIHRhcmdldDsKfTsKCiQud2lkZ2V0LmJyaWRnZSA9IGZ1bmN0aW9uKCBuYW1lLCBvYmplY3QgKSB7Cgl2YXIgZnVsbE5hbWUgPSBvYmplY3QucHJvdG90eXBlLndpZGdldEZ1bGxOYW1lIHx8IG5hbWU7CgkkLmZuWyBuYW1lIF0gPSBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQl2YXIgaXNNZXRob2RDYWxsID0gdHlwZW9mIG9wdGlvbnMgPT09ICJzdHJpbmciLAoJCQlhcmdzID0gc2xpY2UuY2FsbCggYXJndW1lbnRzLCAxICksCgkJCXJldHVyblZhbHVlID0gdGhpczsKCgkJLy8gYWxsb3cgbXVsdGlwbGUgaGFzaGVzIHRvIGJlIHBhc3NlZCBvbiBpbml0CgkJb3B0aW9ucyA9ICFpc01ldGhvZENhbGwgJiYgYXJncy5sZW5ndGggPwoJCQkkLndpZGdldC5leHRlbmQuYXBwbHkoIG51bGwsIFsgb3B0aW9ucyBdLmNvbmNhdChhcmdzKSApIDoKCQkJb3B0aW9uczsKCgkJaWYgKCBpc01ldGhvZENhbGwgKSB7CgkJCXRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJCXZhciBtZXRob2RWYWx1ZSwKCQkJCQlpbnN0YW5jZSA9ICQuZGF0YSggdGhpcywgZnVsbE5hbWUgKTsKCQkJCWlmICggb3B0aW9ucyA9PT0gImluc3RhbmNlIiApIHsKCQkJCQlyZXR1cm5WYWx1ZSA9IGluc3RhbmNlOwoJCQkJCXJldHVybiBmYWxzZTsKCQkJCX0KCQkJCWlmICggIWluc3RhbmNlICkgewoJCQkJCXJldHVybiAkLmVycm9yKCAiY2Fubm90IGNhbGwgbWV0aG9kcyBvbiAiICsgbmFtZSArICIgcHJpb3IgdG8gaW5pdGlhbGl6YXRpb247ICIgKwoJCQkJCQkiYXR0ZW1wdGVkIHRvIGNhbGwgbWV0aG9kICciICsgb3B0aW9ucyArICInIiApOwoJCQkJfQoJCQkJaWYgKCAhJC5pc0Z1bmN0aW9uKCBpbnN0YW5jZVtvcHRpb25zXSApIHx8IG9wdGlvbnMuY2hhckF0KCAwICkgPT09ICJfIiApIHsKCQkJCQlyZXR1cm4gJC5lcnJvciggIm5vIHN1Y2ggbWV0aG9kICciICsgb3B0aW9ucyArICInIGZvciAiICsgbmFtZSArICIgd2lkZ2V0IGluc3RhbmNlIiApOwoJCQkJfQoJCQkJbWV0aG9kVmFsdWUgPSBpbnN0YW5jZVsgb3B0aW9ucyBdLmFwcGx5KCBpbnN0YW5jZSwgYXJncyApOwoJCQkJaWYgKCBtZXRob2RWYWx1ZSAhPT0gaW5zdGFuY2UgJiYgbWV0aG9kVmFsdWUgIT09IHVuZGVmaW5lZCApIHsKCQkJCQlyZXR1cm5WYWx1ZSA9IG1ldGhvZFZhbHVlICYmIG1ldGhvZFZhbHVlLmpxdWVyeSA/CgkJCQkJCXJldHVyblZhbHVlLnB1c2hTdGFjayggbWV0aG9kVmFsdWUuZ2V0KCkgKSA6CgkJCQkJCW1ldGhvZFZhbHVlOwoJCQkJCXJldHVybiBmYWxzZTsKCQkJCX0KCQkJfSk7CgkJfSBlbHNlIHsKCQkJdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJdmFyIGluc3RhbmNlID0gJC5kYXRhKCB0aGlzLCBmdWxsTmFtZSApOwoJCQkJaWYgKCBpbnN0YW5jZSApIHsKCQkJCQlpbnN0YW5jZS5vcHRpb24oIG9wdGlvbnMgfHwge30gKS5faW5pdCgpOwoJCQkJfSBlbHNlIHsKCQkJCQkkLmRhdGEoIHRoaXMsIGZ1bGxOYW1lLCBuZXcgb2JqZWN0KCBvcHRpb25zLCB0aGlzICkgKTsKCQkJCX0KCQkJfSk7CgkJfQoKCQlyZXR1cm4gcmV0dXJuVmFsdWU7Cgl9Owp9OwoKJC5XaWRnZXQgPSBmdW5jdGlvbiggLyogb3B0aW9ucywgZWxlbWVudCAqLyApIHt9OwokLldpZGdldC5fY2hpbGRDb25zdHJ1Y3RvcnMgPSBbXTsKCiQuV2lkZ2V0LnByb3RvdHlwZSA9IHsKCXdpZGdldE5hbWU6ICJ3aWRnZXQiLAoJd2lkZ2V0RXZlbnRQcmVmaXg6ICIiLAoJZGVmYXVsdEVsZW1lbnQ6ICI8ZGl2PiIsCglvcHRpb25zOiB7CgkJZGlzYWJsZWQ6IGZhbHNlLAoKCQkvLyBjYWxsYmFja3MKCQljcmVhdGU6IG51bGwKCX0sCglfY3JlYXRlV2lkZ2V0OiBmdW5jdGlvbiggb3B0aW9ucywgZWxlbWVudCApIHsKCQllbGVtZW50ID0gJCggZWxlbWVudCB8fCB0aGlzLmRlZmF1bHRFbGVtZW50IHx8IHRoaXMgKVsgMCBdOwoJCXRoaXMuZWxlbWVudCA9ICQoIGVsZW1lbnQgKTsKCQl0aGlzLnV1aWQgPSB1dWlkKys7CgkJdGhpcy5ldmVudE5hbWVzcGFjZSA9ICIuIiArIHRoaXMud2lkZ2V0TmFtZSArIHRoaXMudXVpZDsKCQl0aGlzLm9wdGlvbnMgPSAkLndpZGdldC5leHRlbmQoIHt9LAoJCQl0aGlzLm9wdGlvbnMsCgkJCXRoaXMuX2dldENyZWF0ZU9wdGlvbnMoKSwKCQkJb3B0aW9ucyApOwoKCQl0aGlzLmJpbmRpbmdzID0gJCgpOwoJCXRoaXMuaG92ZXJhYmxlID0gJCgpOwoJCXRoaXMuZm9jdXNhYmxlID0gJCgpOwoKCQlpZiAoIGVsZW1lbnQgIT09IHRoaXMgKSB7CgkJCSQuZGF0YSggZWxlbWVudCwgdGhpcy53aWRnZXRGdWxsTmFtZSwgdGhpcyApOwoJCQl0aGlzLl9vbiggdHJ1ZSwgdGhpcy5lbGVtZW50LCB7CgkJCQlyZW1vdmU6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCQlpZiAoIGV2ZW50LnRhcmdldCA9PT0gZWxlbWVudCApIHsKCQkJCQkJdGhpcy5kZXN0cm95KCk7CgkJCQkJfQoJCQkJfQoJCQl9KTsKCQkJdGhpcy5kb2N1bWVudCA9ICQoIGVsZW1lbnQuc3R5bGUgPwoJCQkJLy8gZWxlbWVudCB3aXRoaW4gdGhlIGRvY3VtZW50CgkJCQllbGVtZW50Lm93bmVyRG9jdW1lbnQgOgoJCQkJLy8gZWxlbWVudCBpcyB3aW5kb3cgb3IgZG9jdW1lbnQKCQkJCWVsZW1lbnQuZG9jdW1lbnQgfHwgZWxlbWVudCApOwoJCQl0aGlzLndpbmRvdyA9ICQoIHRoaXMuZG9jdW1lbnRbMF0uZGVmYXVsdFZpZXcgfHwgdGhpcy5kb2N1bWVudFswXS5wYXJlbnRXaW5kb3cgKTsKCQl9CgoJCXRoaXMuX2NyZWF0ZSgpOwoJCXRoaXMuX3RyaWdnZXIoICJjcmVhdGUiLCBudWxsLCB0aGlzLl9nZXRDcmVhdGVFdmVudERhdGEoKSApOwoJCXRoaXMuX2luaXQoKTsKCX0sCglfZ2V0Q3JlYXRlT3B0aW9uczogJC5ub29wLAoJX2dldENyZWF0ZUV2ZW50RGF0YTogJC5ub29wLAoJX2NyZWF0ZTogJC5ub29wLAoJX2luaXQ6ICQubm9vcCwKCglkZXN0cm95OiBmdW5jdGlvbigpIHsKCQl0aGlzLl9kZXN0cm95KCk7CgkJLy8gd2UgY2FuIHByb2JhYmx5IHJlbW92ZSB0aGUgdW5iaW5kIGNhbGxzIGluIDIuMAoJCS8vIGFsbCBldmVudCBiaW5kaW5ncyBzaG91bGQgZ28gdGhyb3VnaCB0aGlzLl9vbigpCgkJdGhpcy5lbGVtZW50CgkJCS51bmJpbmQoIHRoaXMuZXZlbnROYW1lc3BhY2UgKQoJCQkucmVtb3ZlRGF0YSggdGhpcy53aWRnZXRGdWxsTmFtZSApCgkJCS8vIHN1cHBvcnQ6IGpxdWVyeSA8MS42LjMKCQkJLy8gaHR0cDovL2J1Z3MuanF1ZXJ5LmNvbS90aWNrZXQvOTQxMwoJCQkucmVtb3ZlRGF0YSggJC5jYW1lbENhc2UoIHRoaXMud2lkZ2V0RnVsbE5hbWUgKSApOwoJCXRoaXMud2lkZ2V0KCkKCQkJLnVuYmluZCggdGhpcy5ldmVudE5hbWVzcGFjZSApCgkJCS5yZW1vdmVBdHRyKCAiYXJpYS1kaXNhYmxlZCIgKQoJCQkucmVtb3ZlQ2xhc3MoCgkJCQl0aGlzLndpZGdldEZ1bGxOYW1lICsgIi1kaXNhYmxlZCAiICsKCQkJCSJ1aS1zdGF0ZS1kaXNhYmxlZCIgKTsKCgkJLy8gY2xlYW4gdXAgZXZlbnRzIGFuZCBzdGF0ZXMKCQl0aGlzLmJpbmRpbmdzLnVuYmluZCggdGhpcy5ldmVudE5hbWVzcGFjZSApOwoJCXRoaXMuaG92ZXJhYmxlLnJlbW92ZUNsYXNzKCAidWktc3RhdGUtaG92ZXIiICk7CgkJdGhpcy5mb2N1c2FibGUucmVtb3ZlQ2xhc3MoICJ1aS1zdGF0ZS1mb2N1cyIgKTsKCX0sCglfZGVzdHJveTogJC5ub29wLAoKCXdpZGdldDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuZWxlbWVudDsKCX0sCgoJb3B0aW9uOiBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQl2YXIgb3B0aW9ucyA9IGtleSwKCQkJcGFydHMsCgkJCWN1ck9wdGlvbiwKCQkJaTsKCgkJaWYgKCBhcmd1bWVudHMubGVuZ3RoID09PSAwICkgewoJCQkvLyBkb24ndCByZXR1cm4gYSByZWZlcmVuY2UgdG8gdGhlIGludGVybmFsIGhhc2gKCQkJcmV0dXJuICQud2lkZ2V0LmV4dGVuZCgge30sIHRoaXMub3B0aW9ucyApOwoJCX0KCgkJaWYgKCB0eXBlb2Yga2V5ID09PSAic3RyaW5nIiApIHsKCQkJLy8gaGFuZGxlIG5lc3RlZCBrZXlzLCBlLmcuLCAiZm9vLmJhciIgPT4geyBmb286IHsgYmFyOiBfX18gfSB9CgkJCW9wdGlvbnMgPSB7fTsKCQkJcGFydHMgPSBrZXkuc3BsaXQoICIuIiApOwoJCQlrZXkgPSBwYXJ0cy5zaGlmdCgpOwoJCQlpZiAoIHBhcnRzLmxlbmd0aCApIHsKCQkJCWN1ck9wdGlvbiA9IG9wdGlvbnNbIGtleSBdID0gJC53aWRnZXQuZXh0ZW5kKCB7fSwgdGhpcy5vcHRpb25zWyBrZXkgXSApOwoJCQkJZm9yICggaSA9IDA7IGkgPCBwYXJ0cy5sZW5ndGggLSAxOyBpKysgKSB7CgkJCQkJY3VyT3B0aW9uWyBwYXJ0c1sgaSBdIF0gPSBjdXJPcHRpb25bIHBhcnRzWyBpIF0gXSB8fCB7fTsKCQkJCQljdXJPcHRpb24gPSBjdXJPcHRpb25bIHBhcnRzWyBpIF0gXTsKCQkJCX0KCQkJCWtleSA9IHBhcnRzLnBvcCgpOwoJCQkJaWYgKCB2YWx1ZSA9PT0gdW5kZWZpbmVkICkgewoJCQkJCXJldHVybiBjdXJPcHRpb25bIGtleSBdID09PSB1bmRlZmluZWQgPyBudWxsIDogY3VyT3B0aW9uWyBrZXkgXTsKCQkJCX0KCQkJCWN1ck9wdGlvblsga2V5IF0gPSB2YWx1ZTsKCQkJfSBlbHNlIHsKCQkJCWlmICggdmFsdWUgPT09IHVuZGVmaW5lZCApIHsKCQkJCQlyZXR1cm4gdGhpcy5vcHRpb25zWyBrZXkgXSA9PT0gdW5kZWZpbmVkID8gbnVsbCA6IHRoaXMub3B0aW9uc1sga2V5IF07CgkJCQl9CgkJCQlvcHRpb25zWyBrZXkgXSA9IHZhbHVlOwoJCQl9CgkJfQoKCQl0aGlzLl9zZXRPcHRpb25zKCBvcHRpb25zICk7CgoJCXJldHVybiB0aGlzOwoJfSwKCV9zZXRPcHRpb25zOiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQl2YXIga2V5OwoKCQlmb3IgKCBrZXkgaW4gb3B0aW9ucyApIHsKCQkJdGhpcy5fc2V0T3B0aW9uKCBrZXksIG9wdGlvbnNbIGtleSBdICk7CgkJfQoKCQlyZXR1cm4gdGhpczsKCX0sCglfc2V0T3B0aW9uOiBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQl0aGlzLm9wdGlvbnNbIGtleSBdID0gdmFsdWU7CgoJCWlmICgga2V5ID09PSAiZGlzYWJsZWQiICkgewoJCQl0aGlzLndpZGdldCgpCgkJCQkudG9nZ2xlQ2xhc3MoIHRoaXMud2lkZ2V0RnVsbE5hbWUgKyAiLWRpc2FibGVkIiwgISF2YWx1ZSApOwoJCQl0aGlzLmhvdmVyYWJsZS5yZW1vdmVDbGFzcyggInVpLXN0YXRlLWhvdmVyIiApOwoJCQl0aGlzLmZvY3VzYWJsZS5yZW1vdmVDbGFzcyggInVpLXN0YXRlLWZvY3VzIiApOwoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWVuYWJsZTogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuX3NldE9wdGlvbnMoeyBkaXNhYmxlZDogZmFsc2UgfSk7Cgl9LAoJZGlzYWJsZTogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuX3NldE9wdGlvbnMoeyBkaXNhYmxlZDogdHJ1ZSB9KTsKCX0sCgoJX29uOiBmdW5jdGlvbiggc3VwcHJlc3NEaXNhYmxlZENoZWNrLCBlbGVtZW50LCBoYW5kbGVycyApIHsKCQl2YXIgZGVsZWdhdGVFbGVtZW50LAoJCQlpbnN0YW5jZSA9IHRoaXM7CgoJCS8vIG5vIHN1cHByZXNzRGlzYWJsZWRDaGVjayBmbGFnLCBzaHVmZmxlIGFyZ3VtZW50cwoJCWlmICggdHlwZW9mIHN1cHByZXNzRGlzYWJsZWRDaGVjayAhPT0gImJvb2xlYW4iICkgewoJCQloYW5kbGVycyA9IGVsZW1lbnQ7CgkJCWVsZW1lbnQgPSBzdXBwcmVzc0Rpc2FibGVkQ2hlY2s7CgkJCXN1cHByZXNzRGlzYWJsZWRDaGVjayA9IGZhbHNlOwoJCX0KCgkJLy8gbm8gZWxlbWVudCBhcmd1bWVudCwgc2h1ZmZsZSBhbmQgdXNlIHRoaXMuZWxlbWVudAoJCWlmICggIWhhbmRsZXJzICkgewoJCQloYW5kbGVycyA9IGVsZW1lbnQ7CgkJCWVsZW1lbnQgPSB0aGlzLmVsZW1lbnQ7CgkJCWRlbGVnYXRlRWxlbWVudCA9IHRoaXMud2lkZ2V0KCk7CgkJfSBlbHNlIHsKCQkJLy8gYWNjZXB0IHNlbGVjdG9ycywgRE9NIGVsZW1lbnRzCgkJCWVsZW1lbnQgPSBkZWxlZ2F0ZUVsZW1lbnQgPSAkKCBlbGVtZW50ICk7CgkJCXRoaXMuYmluZGluZ3MgPSB0aGlzLmJpbmRpbmdzLmFkZCggZWxlbWVudCApOwoJCX0KCgkJJC5lYWNoKCBoYW5kbGVycywgZnVuY3Rpb24oIGV2ZW50LCBoYW5kbGVyICkgewoJCQlmdW5jdGlvbiBoYW5kbGVyUHJveHkoKSB7CgkJCQkvLyBhbGxvdyB3aWRnZXRzIHRvIGN1c3RvbWl6ZSB0aGUgZGlzYWJsZWQgaGFuZGxpbmcKCQkJCS8vIC0gZGlzYWJsZWQgYXMgYW4gYXJyYXkgaW5zdGVhZCBvZiBib29sZWFuCgkJCQkvLyAtIGRpc2FibGVkIGNsYXNzIGFzIG1ldGhvZCBmb3IgZGlzYWJsaW5nIGluZGl2aWR1YWwgcGFydHMKCQkJCWlmICggIXN1cHByZXNzRGlzYWJsZWRDaGVjayAmJgoJCQkJCQkoIGluc3RhbmNlLm9wdGlvbnMuZGlzYWJsZWQgPT09IHRydWUgfHwKCQkJCQkJCSQoIHRoaXMgKS5oYXNDbGFzcyggInVpLXN0YXRlLWRpc2FibGVkIiApICkgKSB7CgkJCQkJcmV0dXJuOwoJCQkJfQoJCQkJcmV0dXJuICggdHlwZW9mIGhhbmRsZXIgPT09ICJzdHJpbmciID8gaW5zdGFuY2VbIGhhbmRsZXIgXSA6IGhhbmRsZXIgKQoJCQkJCS5hcHBseSggaW5zdGFuY2UsIGFyZ3VtZW50cyApOwoJCQl9CgoJCQkvLyBjb3B5IHRoZSBndWlkIHNvIGRpcmVjdCB1bmJpbmRpbmcgd29ya3MKCQkJaWYgKCB0eXBlb2YgaGFuZGxlciAhPT0gInN0cmluZyIgKSB7CgkJCQloYW5kbGVyUHJveHkuZ3VpZCA9IGhhbmRsZXIuZ3VpZCA9CgkJCQkJaGFuZGxlci5ndWlkIHx8IGhhbmRsZXJQcm94eS5ndWlkIHx8ICQuZ3VpZCsrOwoJCQl9CgoJCQl2YXIgbWF0Y2ggPSBldmVudC5tYXRjaCggL14oXHcrKVxzKiguKikkLyApLAoJCQkJZXZlbnROYW1lID0gbWF0Y2hbMV0gKyBpbnN0YW5jZS5ldmVudE5hbWVzcGFjZSwKCQkJCXNlbGVjdG9yID0gbWF0Y2hbMl07CgkJCWlmICggc2VsZWN0b3IgKSB7CgkJCQlkZWxlZ2F0ZUVsZW1lbnQuZGVsZWdhdGUoIHNlbGVjdG9yLCBldmVudE5hbWUsIGhhbmRsZXJQcm94eSApOwoJCQl9IGVsc2UgewoJCQkJZWxlbWVudC5iaW5kKCBldmVudE5hbWUsIGhhbmRsZXJQcm94eSApOwoJCQl9CgkJfSk7Cgl9LAoKCV9vZmY6IGZ1bmN0aW9uKCBlbGVtZW50LCBldmVudE5hbWUgKSB7CgkJZXZlbnROYW1lID0gKGV2ZW50TmFtZSB8fCAiIikuc3BsaXQoICIgIiApLmpvaW4oIHRoaXMuZXZlbnROYW1lc3BhY2UgKyAiICIgKSArIHRoaXMuZXZlbnROYW1lc3BhY2U7CgkJZWxlbWVudC51bmJpbmQoIGV2ZW50TmFtZSApLnVuZGVsZWdhdGUoIGV2ZW50TmFtZSApOwoJfSwKCglfZGVsYXk6IGZ1bmN0aW9uKCBoYW5kbGVyLCBkZWxheSApIHsKCQlmdW5jdGlvbiBoYW5kbGVyUHJveHkoKSB7CgkJCXJldHVybiAoIHR5cGVvZiBoYW5kbGVyID09PSAic3RyaW5nIiA/IGluc3RhbmNlWyBoYW5kbGVyIF0gOiBoYW5kbGVyICkKCQkJCS5hcHBseSggaW5zdGFuY2UsIGFyZ3VtZW50cyApOwoJCX0KCQl2YXIgaW5zdGFuY2UgPSB0aGlzOwoJCXJldHVybiBzZXRUaW1lb3V0KCBoYW5kbGVyUHJveHksIGRlbGF5IHx8IDAgKTsKCX0sCgoJX2hvdmVyYWJsZTogZnVuY3Rpb24oIGVsZW1lbnQgKSB7CgkJdGhpcy5ob3ZlcmFibGUgPSB0aGlzLmhvdmVyYWJsZS5hZGQoIGVsZW1lbnQgKTsKCQl0aGlzLl9vbiggZWxlbWVudCwgewoJCQltb3VzZWVudGVyOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkkKCBldmVudC5jdXJyZW50VGFyZ2V0ICkuYWRkQ2xhc3MoICJ1aS1zdGF0ZS1ob3ZlciIgKTsKCQkJfSwKCQkJbW91c2VsZWF2ZTogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJJCggZXZlbnQuY3VycmVudFRhcmdldCApLnJlbW92ZUNsYXNzKCAidWktc3RhdGUtaG92ZXIiICk7CgkJCX0KCQl9KTsKCX0sCgoJX2ZvY3VzYWJsZTogZnVuY3Rpb24oIGVsZW1lbnQgKSB7CgkJdGhpcy5mb2N1c2FibGUgPSB0aGlzLmZvY3VzYWJsZS5hZGQoIGVsZW1lbnQgKTsKCQl0aGlzLl9vbiggZWxlbWVudCwgewoJCQlmb2N1c2luOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkkKCBldmVudC5jdXJyZW50VGFyZ2V0ICkuYWRkQ2xhc3MoICJ1aS1zdGF0ZS1mb2N1cyIgKTsKCQkJfSwKCQkJZm9jdXNvdXQ6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCSQoIGV2ZW50LmN1cnJlbnRUYXJnZXQgKS5yZW1vdmVDbGFzcyggInVpLXN0YXRlLWZvY3VzIiApOwoJCQl9CgkJfSk7Cgl9LAoKCV90cmlnZ2VyOiBmdW5jdGlvbiggdHlwZSwgZXZlbnQsIGRhdGEgKSB7CgkJdmFyIHByb3AsIG9yaWcsCgkJCWNhbGxiYWNrID0gdGhpcy5vcHRpb25zWyB0eXBlIF07CgoJCWRhdGEgPSBkYXRhIHx8IHt9OwoJCWV2ZW50ID0gJC5FdmVudCggZXZlbnQgKTsKCQlldmVudC50eXBlID0gKCB0eXBlID09PSB0aGlzLndpZGdldEV2ZW50UHJlZml4ID8KCQkJdHlwZSA6CgkJCXRoaXMud2lkZ2V0RXZlbnRQcmVmaXggKyB0eXBlICkudG9Mb3dlckNhc2UoKTsKCQkvLyB0aGUgb3JpZ2luYWwgZXZlbnQgbWF5IGNvbWUgZnJvbSBhbnkgZWxlbWVudAoJCS8vIHNvIHdlIG5lZWQgdG8gcmVzZXQgdGhlIHRhcmdldCBvbiB0aGUgbmV3IGV2ZW50CgkJZXZlbnQudGFyZ2V0ID0gdGhpcy5lbGVtZW50WyAwIF07CgoJCS8vIGNvcHkgb3JpZ2luYWwgZXZlbnQgcHJvcGVydGllcyBvdmVyIHRvIHRoZSBuZXcgZXZlbnQKCQlvcmlnID0gZXZlbnQub3JpZ2luYWxFdmVudDsKCQlpZiAoIG9yaWcgKSB7CgkJCWZvciAoIHByb3AgaW4gb3JpZyApIHsKCQkJCWlmICggISggcHJvcCBpbiBldmVudCApICkgewoJCQkJCWV2ZW50WyBwcm9wIF0gPSBvcmlnWyBwcm9wIF07CgkJCQl9CgkJCX0KCQl9CgoJCXRoaXMuZWxlbWVudC50cmlnZ2VyKCBldmVudCwgZGF0YSApOwoJCXJldHVybiAhKCAkLmlzRnVuY3Rpb24oIGNhbGxiYWNrICkgJiYKCQkJY2FsbGJhY2suYXBwbHkoIHRoaXMuZWxlbWVudFswXSwgWyBldmVudCBdLmNvbmNhdCggZGF0YSApICkgPT09IGZhbHNlIHx8CgkJCWV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICk7Cgl9Cn07CgokLmVhY2goIHsgc2hvdzogImZhZGVJbiIsIGhpZGU6ICJmYWRlT3V0IiB9LCBmdW5jdGlvbiggbWV0aG9kLCBkZWZhdWx0RWZmZWN0ICkgewoJJC5XaWRnZXQucHJvdG90eXBlWyAiXyIgKyBtZXRob2QgXSA9IGZ1bmN0aW9uKCBlbGVtZW50LCBvcHRpb25zLCBjYWxsYmFjayApIHsKCQlpZiAoIHR5cGVvZiBvcHRpb25zID09PSAic3RyaW5nIiApIHsKCQkJb3B0aW9ucyA9IHsgZWZmZWN0OiBvcHRpb25zIH07CgkJfQoJCXZhciBoYXNPcHRpb25zLAoJCQllZmZlY3ROYW1lID0gIW9wdGlvbnMgPwoJCQkJbWV0aG9kIDoKCQkJCW9wdGlvbnMgPT09IHRydWUgfHwgdHlwZW9mIG9wdGlvbnMgPT09ICJudW1iZXIiID8KCQkJCQlkZWZhdWx0RWZmZWN0IDoKCQkJCQlvcHRpb25zLmVmZmVjdCB8fCBkZWZhdWx0RWZmZWN0OwoJCW9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoJCWlmICggdHlwZW9mIG9wdGlvbnMgPT09ICJudW1iZXIiICkgewoJCQlvcHRpb25zID0geyBkdXJhdGlvbjogb3B0aW9ucyB9OwoJCX0KCQloYXNPcHRpb25zID0gISQuaXNFbXB0eU9iamVjdCggb3B0aW9ucyApOwoJCW9wdGlvbnMuY29tcGxldGUgPSBjYWxsYmFjazsKCQlpZiAoIG9wdGlvbnMuZGVsYXkgKSB7CgkJCWVsZW1lbnQuZGVsYXkoIG9wdGlvbnMuZGVsYXkgKTsKCQl9CgkJaWYgKCBoYXNPcHRpb25zICYmICQuZWZmZWN0cyAmJiAkLmVmZmVjdHMuZWZmZWN0WyBlZmZlY3ROYW1lIF0gKSB7CgkJCWVsZW1lbnRbIG1ldGhvZCBdKCBvcHRpb25zICk7CgkJfSBlbHNlIGlmICggZWZmZWN0TmFtZSAhPT0gbWV0aG9kICYmIGVsZW1lbnRbIGVmZmVjdE5hbWUgXSApIHsKCQkJZWxlbWVudFsgZWZmZWN0TmFtZSBdKCBvcHRpb25zLmR1cmF0aW9uLCBvcHRpb25zLmVhc2luZywgY2FsbGJhY2sgKTsKCQl9IGVsc2UgewoJCQllbGVtZW50LnF1ZXVlKGZ1bmN0aW9uKCBuZXh0ICkgewoJCQkJJCggdGhpcyApWyBtZXRob2QgXSgpOwoJCQkJaWYgKCBjYWxsYmFjayApIHsKCQkJCQljYWxsYmFjay5jYWxsKCBlbGVtZW50WyAwIF0gKTsKCQkJCX0KCQkJCW5leHQoKTsKCQkJfSk7CgkJfQoJfTsKfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCnZhciByY2FwaXRhbHMgPSAvW0EtWl0vZywKCXJlcGxhY2VGdW5jdGlvbiA9IGZ1bmN0aW9uKCBjICkgewoJCXJldHVybiAiLSIgKyBjLnRvTG93ZXJDYXNlKCk7Cgl9OwoKJC5leHRlbmQoICQuV2lkZ2V0LnByb3RvdHlwZSwgewoJX2dldENyZWF0ZU9wdGlvbnM6IGZ1bmN0aW9uKCkgewoJCXZhciBvcHRpb24sIHZhbHVlLAoJCQllbGVtID0gdGhpcy5lbGVtZW50WyAwIF0sCgkJCW9wdGlvbnMgPSB7fTsKCgkJLy8KCQlpZiggISQubW9iaWxlLmdldEF0dHJpYnV0ZSggZWxlbSwgImRlZmF1bHRzIiApICl7CgkJCWZvciAoIG9wdGlvbiBpbiB0aGlzLm9wdGlvbnMgKSB7CgkJCQl2YWx1ZSA9ICQubW9iaWxlLmdldEF0dHJpYnV0ZSggZWxlbSwgb3B0aW9uLnJlcGxhY2UoIHJjYXBpdGFscywgcmVwbGFjZUZ1bmN0aW9uICkgKTsKCQkJCWlmICggdmFsdWUgIT0gbnVsbCApIHsKCQkJCQlvcHRpb25zWyBvcHRpb24gXSA9IHZhbHVlOwoJCQkJfQoJCQl9CgkJfQoKCQlyZXR1cm4gb3B0aW9uczsKCX0KfSk7CgovL1RPRE86IFJlbW92ZSBpbiAxLjUgZm9yIGJhY2tjb21wYXQgb25seQokLm1vYmlsZS53aWRnZXQgPSAkLldpZGdldDsKCn0pKCBqUXVlcnkgKTsKCgooZnVuY3Rpb24oICQgKSB7CgkvLyBUT0RPIG1vdmUgbG9hZGVyIGNsYXNzIGRvd24gaW50byB0aGUgd2lkZ2V0IHNldHRpbmdzCgl2YXIgbG9hZGVyQ2xhc3MgPSAidWktbG9hZGVyIiwgJGh0bWwgPSAkKCAiaHRtbCIgKTsKCgkkLndpZGdldCggIm1vYmlsZS5sb2FkZXIiLCB7CgkJLy8gTk9URSBpZiB0aGUgZ2xvYmFsIGNvbmZpZyBzZXR0aW5ncyBhcmUgZGVmaW5lZCB0aGV5IHdpbGwgb3ZlcnJpZGUgdGhlc2UKCQkvLyAgICAgIG9wdGlvbnMKCQlvcHRpb25zOiB7CgkJCS8vIHRoZSB0aGVtZSBmb3IgdGhlIGxvYWRpbmcgbWVzc2FnZQoJCQl0aGVtZTogImEiLAoKCQkJLy8gd2hldGhlciB0aGUgdGV4dCBpbiB0aGUgbG9hZGluZyBtZXNzYWdlIGlzIHNob3duCgkJCXRleHRWaXNpYmxlOiBmYWxzZSwKCgkJCS8vIGN1c3RvbSBodG1sIGZvciB0aGUgaW5uZXIgY29udGVudCBvZiB0aGUgbG9hZGluZyBtZXNzYWdlCgkJCWh0bWw6ICIiLAoKCQkJLy8gdGhlIHRleHQgdG8gYmUgZGlzcGxheWVkIHdoZW4gdGhlIHBvcHVwIGlzIHNob3duCgkJCXRleHQ6ICJsb2FkaW5nIgoJCX0sCgoJCWRlZmF1bHRIdG1sOiAiPGRpdiBjbGFzcz0nIiArIGxvYWRlckNsYXNzICsgIic+IiArCgkJCSI8c3BhbiBjbGFzcz0ndWktaWNvbi1sb2FkaW5nJz48L3NwYW4+IiArCgkJCSI8aDE+PC9oMT4iICsKCQkJIjwvZGl2PiIsCgoJCS8vIEZvciBub24tZml4ZWQgc3VwcG9ydGluIGJyb3dzZXJzLiBQb3NpdGlvbiBhdCB5IGNlbnRlciAoaWYgc2Nyb2xsVG9wIHN1cHBvcnRlZCksIGFib3ZlIHRoZSBhY3RpdmVCdG4gKGlmIGRlZmluZWQpLCBvciBqdXN0IDEwMHB4IGZyb20gdG9wCgkJZmFrZUZpeExvYWRlcjogZnVuY3Rpb24oKSB7CgkJCXZhciBhY3RpdmVCdG4gPSAkKCAiLiIgKyAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApLmZpcnN0KCk7CgoJCQl0aGlzLmVsZW1lbnQKCQkJCS5jc3MoewoJCQkJCXRvcDogJC5zdXBwb3J0LnNjcm9sbFRvcCAmJiB0aGlzLndpbmRvdy5zY3JvbGxUb3AoKSArIHRoaXMud2luZG93LmhlaWdodCgpIC8gMiB8fAoJCQkJCQlhY3RpdmVCdG4ubGVuZ3RoICYmIGFjdGl2ZUJ0bi5vZmZzZXQoKS50b3AgfHwgMTAwCgkJCQl9KTsKCQl9LAoKCQkvLyBjaGVjayBwb3NpdGlvbiBvZiBsb2FkZXIgdG8gc2VlIGlmIGl0IGFwcGVhcnMgdG8gYmUgImZpeGVkIiB0byBjZW50ZXIKCQkvLyBpZiBub3QsIHVzZSBhYnMgcG9zaXRpb25pbmcKCQljaGVja0xvYWRlclBvc2l0aW9uOiBmdW5jdGlvbigpIHsKCQkJdmFyIG9mZnNldCA9IHRoaXMuZWxlbWVudC5vZmZzZXQoKSwKCQkJCXNjcm9sbFRvcCA9IHRoaXMud2luZG93LnNjcm9sbFRvcCgpLAoJCQkJc2NyZWVuSGVpZ2h0ID0gJC5tb2JpbGUuZ2V0U2NyZWVuSGVpZ2h0KCk7CgoJCQlpZiAoIG9mZnNldC50b3AgPCBzY3JvbGxUb3AgfHwgKCBvZmZzZXQudG9wIC0gc2Nyb2xsVG9wICkgPiBzY3JlZW5IZWlnaHQgKSB7CgkJCQl0aGlzLmVsZW1lbnQuYWRkQ2xhc3MoICJ1aS1sb2FkZXItZmFrZWZpeCIgKTsKCQkJCXRoaXMuZmFrZUZpeExvYWRlcigpOwoJCQkJdGhpcy53aW5kb3cKCQkJCQkudW5iaW5kKCAic2Nyb2xsIiwgdGhpcy5jaGVja0xvYWRlclBvc2l0aW9uICkKCQkJCQkuYmluZCggInNjcm9sbCIsICQucHJveHkoIHRoaXMuZmFrZUZpeExvYWRlciwgdGhpcyApICk7CgkJCX0KCQl9LAoKCQlyZXNldEh0bWw6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLmVsZW1lbnQuaHRtbCggJCggdGhpcy5kZWZhdWx0SHRtbCApLmh0bWwoKSApOwoJCX0sCgoJCS8vIFR1cm4gb24vb2ZmIHBhZ2UgbG9hZGluZyBtZXNzYWdlLiBUaGVtZSBkb3VibGVzIGFzIGFuIG9iamVjdCBhcmd1bWVudAoJCS8vIHdpdGggdGhlIGZvbGxvd2luZyBzaGFwZTogeyB0aGVtZTogJycsIHRleHQ6ICcnLCBodG1sOiAnJywgdGV4dFZpc2libGU6ICcnIH0KCQkvLyBOT1RFIHRoYXQgdGhlICQubW9iaWxlLmxvYWRpbmcqIHNldHRpbmdzIGFuZCBwYXJhbXMgcGFzdCB0aGUgZmlyc3QgYXJlIGRlcHJlY2F0ZWQKCQkvLyBUT0RPIHN3ZWV0IGplc3VzIHdlIG5lZWQgdG8gYnJlYWsgc29tZSBvZiB0aGlzIG91dAoJCXNob3c6IGZ1bmN0aW9uKCB0aGVtZSwgbXNnVGV4dCwgdGV4dG9ubHkgKSB7CgkJCXZhciB0ZXh0VmlzaWJsZSwgbWVzc2FnZSwgbG9hZFNldHRpbmdzOwoKCQkJdGhpcy5yZXNldEh0bWwoKTsKCgkJCS8vIHVzZSB0aGUgcHJvdG90eXBlIG9wdGlvbnMgc28gdGhhdCBwZW9wbGUgY2FuIHNldCB0aGVtIGdsb2JhbGx5IGF0CgkJCS8vIG1vYmlsZSBpbml0LiBDb25zaXN0ZW5jeSwgaXQncyB3aGF0J3MgZm9yIGRpbm5lcgoJCQlpZiAoICQudHlwZSggdGhlbWUgKSA9PT0gIm9iamVjdCIgKSB7CgkJCQlsb2FkU2V0dGluZ3MgPSAkLmV4dGVuZCgge30sIHRoaXMub3B0aW9ucywgdGhlbWUgKTsKCgkJCQl0aGVtZSA9IGxvYWRTZXR0aW5ncy50aGVtZTsKCQkJfSBlbHNlIHsKCQkJCWxvYWRTZXR0aW5ncyA9IHRoaXMub3B0aW9uczsKCgkJCQkvLyBoZXJlIHdlIHByZWZlciB0aGUgdGhlbWUgdmFsdWUgcGFzc2VkIGFzIGEgc3RyaW5nIGFyZ3VtZW50LCB0aGVuCgkJCQkvLyB3ZSBwcmVmZXIgdGhlIGdsb2JhbCBvcHRpb24gYmVjYXVzZSB3ZSBjYW4ndCB1c2UgdW5kZWZpbmVkIGRlZmF1bHQKCQkJCS8vIHByb3RvdHlwZSBvcHRpb25zLCB0aGVuIHRoZSBwcm90b3R5cGUgb3B0aW9uCgkJCQl0aGVtZSA9IHRoZW1lIHx8IGxvYWRTZXR0aW5ncy50aGVtZTsKCQkJfQoKCQkJLy8gc2V0IHRoZSBtZXNzYWdlIHRleHQsIHByZWZlciB0aGUgcGFyYW0sIHRoZW4gdGhlIHNldHRpbmdzIG9iamVjdAoJCQkvLyB0aGVuIGxvYWRpbmcgbWVzc2FnZQoJCQltZXNzYWdlID0gbXNnVGV4dCB8fCAoIGxvYWRTZXR0aW5ncy50ZXh0ID09PSBmYWxzZSA/ICIiIDogbG9hZFNldHRpbmdzLnRleHQgKTsKCgkJCS8vIHByZXBhcmUgdGhlIGRvbQoJCQkkaHRtbC5hZGRDbGFzcyggInVpLWxvYWRpbmciICk7CgoJCQl0ZXh0VmlzaWJsZSA9IGxvYWRTZXR0aW5ncy50ZXh0VmlzaWJsZTsKCgkJCS8vIGFkZCB0aGUgcHJvcGVyIGNzcyBnaXZlbiB0aGUgb3B0aW9ucyAodGhlbWUsIHRleHQsIGV0YykKCQkJLy8gRm9yY2UgdGV4dCB2aXNpYmlsaXR5IGlmIHRoZSBzZWNvbmQgYXJndW1lbnQgd2FzIHN1cHBsaWVkLCBvcgoJCQkvLyBpZiB0aGUgdGV4dCB3YXMgZXhwbGljaXRseSBzZXQgaW4gdGhlIG9iamVjdCBhcmdzCgkJCXRoaXMuZWxlbWVudC5hdHRyKCJjbGFzcyIsIGxvYWRlckNsYXNzICsKCQkJCSIgdWktY29ybmVyLWFsbCB1aS1ib2R5LSIgKyB0aGVtZSArCgkJCQkiIHVpLWxvYWRlci0iICsgKCB0ZXh0VmlzaWJsZSB8fCBtc2dUZXh0IHx8IHRoZW1lLnRleHQgPyAidmVyYm9zZSIgOiAiZGVmYXVsdCIgKSArCgkJCQkoIGxvYWRTZXR0aW5ncy50ZXh0b25seSB8fCB0ZXh0b25seSA/ICIgdWktbG9hZGVyLXRleHRvbmx5IiA6ICIiICkgKTsKCgkJCS8vIFRPRE8gdmVyaWZ5IHRoYXQganF1ZXJ5LmZuLmh0bWwgaXMgb2sgdG8gdXNlIGluIGJvdGggY2FzZXMgaGVyZQoJCQkvLyAgICAgIHRoaXMgbWlnaHQgYmUgb3Zlcmx5IGRlZmVuc2l2ZSBpbiBwcmV2ZW50aW5nIHVua25vd2luZyB4c3MKCQkJLy8gaWYgdGhlIGh0bWwgYXR0cmlidXRlIGlzIGRlZmluZWQgb24gdGhlIGxvYWRpbmcgc2V0dGluZ3MsIHVzZSB0aGF0CgkJCS8vIG90aGVyd2lzZSB1c2UgdGhlIGZhbGxiYWNrcyBmcm9tIGFib3ZlCgkJCWlmICggbG9hZFNldHRpbmdzLmh0bWwgKSB7CgkJCQl0aGlzLmVsZW1lbnQuaHRtbCggbG9hZFNldHRpbmdzLmh0bWwgKTsKCQkJfSBlbHNlIHsKCQkJCXRoaXMuZWxlbWVudC5maW5kKCAiaDEiICkudGV4dCggbWVzc2FnZSApOwoJCQl9CgoJCQkvLyBhdHRhY2ggdGhlIGxvYWRlciB0byB0aGUgRE9NCgkJCXRoaXMuZWxlbWVudC5hcHBlbmRUbyggJC5tb2JpbGUucGFnZUNvbnRhaW5lciApOwoKCQkJLy8gY2hlY2sgdGhhdCB0aGUgbG9hZGVyIGlzIHZpc2libGUKCQkJdGhpcy5jaGVja0xvYWRlclBvc2l0aW9uKCk7CgoJCQkvLyBvbiBzY3JvbGwgY2hlY2sgdGhlIGxvYWRlciBwb3NpdGlvbgoJCQl0aGlzLndpbmRvdy5iaW5kKCAic2Nyb2xsIiwgJC5wcm94eSggdGhpcy5jaGVja0xvYWRlclBvc2l0aW9uLCB0aGlzICkgKTsKCQl9LAoKCQloaWRlOiBmdW5jdGlvbigpIHsKCQkJJGh0bWwucmVtb3ZlQ2xhc3MoICJ1aS1sb2FkaW5nIiApOwoKCQkJaWYgKCB0aGlzLm9wdGlvbnMudGV4dCApIHsKCQkJCXRoaXMuZWxlbWVudC5yZW1vdmVDbGFzcyggInVpLWxvYWRlci1mYWtlZml4IiApOwoJCQl9CgoJCQkkLm1vYmlsZS53aW5kb3cudW5iaW5kKCAic2Nyb2xsIiwgdGhpcy5mYWtlRml4TG9hZGVyICk7CgkJCSQubW9iaWxlLndpbmRvdy51bmJpbmQoICJzY3JvbGwiLCB0aGlzLmNoZWNrTG9hZGVyUG9zaXRpb24gKTsKCQl9Cgl9KTsKCn0pKGpRdWVyeSwgdGhpcyk7CgoKLy8gU2NyaXB0OiBqUXVlcnkgaGFzaGNoYW5nZSBldmVudAovLyAKLy8gKlZlcnNpb246IDEuMywgTGFzdCB1cGRhdGVkOiA3LzIxLzIwMTAqCi8vIAovLyBQcm9qZWN0IEhvbWUgLSBodHRwOi8vYmVuYWxtYW4uY29tL3Byb2plY3RzL2pxdWVyeS1oYXNoY2hhbmdlLXBsdWdpbi8KLy8gR2l0SHViICAgICAgIC0gaHR0cDovL2dpdGh1Yi5jb20vY293Ym95L2pxdWVyeS1oYXNoY2hhbmdlLwovLyBTb3VyY2UgICAgICAgLSBodHRwOi8vZ2l0aHViLmNvbS9jb3dib3kvanF1ZXJ5LWhhc2hjaGFuZ2UvcmF3L21hc3Rlci9qcXVlcnkuYmEtaGFzaGNoYW5nZS5qcwovLyAoTWluaWZpZWQpICAgLSBodHRwOi8vZ2l0aHViLmNvbS9jb3dib3kvanF1ZXJ5LWhhc2hjaGFuZ2UvcmF3L21hc3Rlci9qcXVlcnkuYmEtaGFzaGNoYW5nZS5taW4uanMgKDAuOGtiIGd6aXBwZWQpCi8vIAovLyBBYm91dDogTGljZW5zZQovLyAKLy8gQ29weXJpZ2h0IChjKSAyMDEwICJDb3dib3kiIEJlbiBBbG1hbiwKLy8gRHVhbCBsaWNlbnNlZCB1bmRlciB0aGUgTUlUIGFuZCBHUEwgbGljZW5zZXMuCi8vIGh0dHA6Ly9iZW5hbG1hbi5jb20vYWJvdXQvbGljZW5zZS8KLy8gCi8vIEFib3V0OiBFeGFtcGxlcwovLyAKLy8gVGhlc2Ugd29ya2luZyBleGFtcGxlcywgY29tcGxldGUgd2l0aCBmdWxseSBjb21tZW50ZWQgY29kZSwgaWxsdXN0cmF0ZSBhIGZldwovLyB3YXlzIGluIHdoaWNoIHRoaXMgcGx1Z2luIGNhbiBiZSB1c2VkLgovLyAKLy8gaGFzaGNoYW5nZSBldmVudCAtIGh0dHA6Ly9iZW5hbG1hbi5jb20vY29kZS9wcm9qZWN0cy9qcXVlcnktaGFzaGNoYW5nZS9leGFtcGxlcy9oYXNoY2hhbmdlLwovLyBkb2N1bWVudC5kb21haW4gLSBodHRwOi8vYmVuYWxtYW4uY29tL2NvZGUvcHJvamVjdHMvanF1ZXJ5LWhhc2hjaGFuZ2UvZXhhbXBsZXMvZG9jdW1lbnRfZG9tYWluLwovLyAKLy8gQWJvdXQ6IFN1cHBvcnQgYW5kIFRlc3RpbmcKLy8gCi8vIEluZm9ybWF0aW9uIGFib3V0IHdoYXQgdmVyc2lvbiBvciB2ZXJzaW9ucyBvZiBqUXVlcnkgdGhpcyBwbHVnaW4gaGFzIGJlZW4KLy8gdGVzdGVkIHdpdGgsIHdoYXQgYnJvd3NlcnMgaXQgaGFzIGJlZW4gdGVzdGVkIGluLCBhbmQgd2hlcmUgdGhlIHVuaXQgdGVzdHMKLy8gcmVzaWRlIChzbyB5b3UgY2FuIHRlc3QgaXQgeW91cnNlbGYpLgovLyAKLy8galF1ZXJ5IFZlcnNpb25zIC0gMS4yLjYsIDEuMy4yLCAxLjQuMSwgMS40LjIKLy8gQnJvd3NlcnMgVGVzdGVkIC0gSW50ZXJuZXQgRXhwbG9yZXIgNi04LCBGaXJlZm94IDItNCwgQ2hyb21lIDUtNiwgU2FmYXJpIDMuMi01LAovLyAgICAgICAgICAgICAgICAgICBPcGVyYSA5LjYtMTAuNjAsIGlQaG9uZSAzLjEsIEFuZHJvaWQgMS42LTIuMiwgQmxhY2tCZXJyeSA0LjYtNS4KLy8gVW5pdCBUZXN0cyAgICAgIC0gaHR0cDovL2JlbmFsbWFuLmNvbS9jb2RlL3Byb2plY3RzL2pxdWVyeS1oYXNoY2hhbmdlL3VuaXQvCi8vIAovLyBBYm91dDogS25vd24gaXNzdWVzCi8vIAovLyBXaGlsZSB0aGlzIGpRdWVyeSBoYXNoY2hhbmdlIGV2ZW50IGltcGxlbWVudGF0aW9uIGlzIHF1aXRlIHN0YWJsZSBhbmQKLy8gcm9idXN0LCB0aGVyZSBhcmUgYSBmZXcgdW5mb3J0dW5hdGUgYnJvd3NlciBidWdzIHN1cnJvdW5kaW5nIGV4cGVjdGVkCi8vIGhhc2hjaGFuZ2UgZXZlbnQtYmFzZWQgYmVoYXZpb3JzLCBpbmRlcGVuZGVudCBvZiBhbnkgSmF2YVNjcmlwdAovLyB3aW5kb3cub25oYXNoY2hhbmdlIGFic3RyYWN0aW9uLiBTZWUgdGhlIGZvbGxvd2luZyBleGFtcGxlcyBmb3IgbW9yZQovLyBpbmZvcm1hdGlvbjoKLy8gCi8vIENocm9tZTogQmFjayBCdXR0b24gLSBodHRwOi8vYmVuYWxtYW4uY29tL2NvZGUvcHJvamVjdHMvanF1ZXJ5LWhhc2hjaGFuZ2UvZXhhbXBsZXMvYnVnLWNocm9tZS1iYWNrLWJ1dHRvbi8KLy8gRmlyZWZveDogUmVtb3RlIFhNTEh0dHBSZXF1ZXN0IC0gaHR0cDovL2JlbmFsbWFuLmNvbS9jb2RlL3Byb2plY3RzL2pxdWVyeS1oYXNoY2hhbmdlL2V4YW1wbGVzL2J1Zy1maXJlZm94LXJlbW90ZS14aHIvCi8vIFdlYktpdDogQmFjayBCdXR0b24gaW4gYW4gSWZyYW1lIC0gaHR0cDovL2JlbmFsbWFuLmNvbS9jb2RlL3Byb2plY3RzL2pxdWVyeS1oYXNoY2hhbmdlL2V4YW1wbGVzL2J1Zy13ZWJraXQtaGFzaC1pZnJhbWUvCi8vIFNhZmFyaTogQmFjayBCdXR0b24gZnJvbSBhIGRpZmZlcmVudCBkb21haW4gLSBodHRwOi8vYmVuYWxtYW4uY29tL2NvZGUvcHJvamVjdHMvanF1ZXJ5LWhhc2hjaGFuZ2UvZXhhbXBsZXMvYnVnLXNhZmFyaS1iYWNrLWZyb20tZGlmZi1kb21haW4vCi8vIAovLyBBbHNvIG5vdGUgdGhhdCBzaG91bGQgYSBicm93c2VyIG5hdGl2ZWx5IHN1cHBvcnQgdGhlIHdpbmRvdy5vbmhhc2hjaGFuZ2UgCi8vIGV2ZW50LCBidXQgbm90IHJlcG9ydCB0aGF0IGl0IGRvZXMsIHRoZSBmYWxsYmFjayBwb2xsaW5nIGxvb3Agd2lsbCBiZSB1c2VkLgovLyAKLy8gQWJvdXQ6IFJlbGVhc2UgSGlzdG9yeQovLyAKLy8gMS4zICAgLSAoNy8yMS8yMDEwKSBSZW9yZ2FuaXplZCBJRTYvNyBJZnJhbWUgY29kZSB0byBtYWtlIGl0IG1vcmUKLy8gICAgICAgICAicmVtb3ZhYmxlIiBmb3IgbW9iaWxlLW9ubHkgZGV2ZWxvcG1lbnQuIEFkZGVkIElFNi83IGRvY3VtZW50LnRpdGxlCi8vICAgICAgICAgc3VwcG9ydC4gQXR0ZW1wdGVkIHRvIG1ha2UgSWZyYW1lIGFzIGhpZGRlbiBhcyBwb3NzaWJsZSBieSB1c2luZwovLyAgICAgICAgIHRlY2huaXF1ZXMgZnJvbSBodHRwOi8vd3d3LnBhY2llbGxvZ3JvdXAuY29tL2Jsb2cvP3A9NjA0LiBBZGRlZCAKLy8gICAgICAgICBzdXBwb3J0IGZvciB0aGUgInNob3J0Y3V0IiBmb3JtYXQgJCh3aW5kb3cpLmhhc2hjaGFuZ2UoIGZuICkgYW5kCi8vICAgICAgICAgJCh3aW5kb3cpLmhhc2hjaGFuZ2UoKSBsaWtlIGpRdWVyeSBwcm92aWRlcyBmb3IgYnVpbHQtaW4gZXZlbnRzLgovLyAgICAgICAgIFJlbmFtZWQgalF1ZXJ5Lmhhc2hjaGFuZ2VEZWxheSB0byA8alF1ZXJ5LmZuLmhhc2hjaGFuZ2UuZGVsYXk+IGFuZAovLyAgICAgICAgIGxvd2VyZWQgaXRzIGRlZmF1bHQgdmFsdWUgdG8gNTAuIEFkZGVkIDxqUXVlcnkuZm4uaGFzaGNoYW5nZS5kb21haW4+Ci8vICAgICAgICAgYW5kIDxqUXVlcnkuZm4uaGFzaGNoYW5nZS5zcmM+IHByb3BlcnRpZXMgcGx1cyBkb2N1bWVudC1kb21haW4uaHRtbAovLyAgICAgICAgIGZpbGUgdG8gYWRkcmVzcyBhY2Nlc3MgZGVuaWVkIGlzc3VlcyB3aGVuIHNldHRpbmcgZG9jdW1lbnQuZG9tYWluIGluCi8vICAgICAgICAgSUU2LzcuCi8vIDEuMiAgIC0gKDIvMTEvMjAxMCkgRml4ZWQgYSBidWcgd2hlcmUgY29taW5nIGJhY2sgdG8gYSBwYWdlIHVzaW5nIHRoaXMgcGx1Z2luCi8vICAgICAgICAgZnJvbSBhIHBhZ2Ugb24gYW5vdGhlciBkb21haW4gd291bGQgY2F1c2UgYW4gZXJyb3IgaW4gU2FmYXJpIDQuIEFsc28sCi8vICAgICAgICAgSUU2LzcgSWZyYW1lIGlzIG5vdyBpbnNlcnRlZCBhZnRlciB0aGUgYm9keSAodGhpcyBhY3R1YWxseSB3b3JrcyksCi8vICAgICAgICAgd2hpY2ggcHJldmVudHMgdGhlIHBhZ2UgZnJvbSBzY3JvbGxpbmcgd2hlbiB0aGUgZXZlbnQgaXMgZmlyc3QgYm91bmQuCi8vICAgICAgICAgRXZlbnQgY2FuIGFsc28gbm93IGJlIGJvdW5kIGJlZm9yZSBET00gcmVhZHksIGJ1dCBpdCB3b24ndCBiZSB1c2FibGUKLy8gICAgICAgICBiZWZvcmUgdGhlbiBpbiBJRTYvNy4KLy8gMS4xICAgLSAoMS8yMS8yMDEwKSBJbmNvcnBvcmF0ZWQgZG9jdW1lbnQuZG9jdW1lbnRNb2RlIHRlc3QgdG8gZml4IElFOCBidWcKLy8gICAgICAgICB3aGVyZSBicm93c2VyIHZlcnNpb24gaXMgaW5jb3JyZWN0bHkgcmVwb3J0ZWQgYXMgOC4wLCBkZXNwaXRlCi8vICAgICAgICAgaW5jbHVzaW9uIG9mIHRoZSBYLVVBLUNvbXBhdGlibGUgSUU9RW11bGF0ZUlFNyBtZXRhIHRhZy4KLy8gMS4wICAgLSAoMS85LzIwMTApIEluaXRpYWwgUmVsZWFzZS4gQnJva2Ugb3V0IHRoZSBqUXVlcnkgQkJRIGV2ZW50LnNwZWNpYWwKLy8gICAgICAgICB3aW5kb3cub25oYXNoY2hhbmdlIGZ1bmN0aW9uYWxpdHkgaW50byBhIHNlcGFyYXRlIHBsdWdpbiBmb3IgdXNlcnMKLy8gICAgICAgICB3aG8gd2FudCBqdXN0IHRoZSBiYXNpYyBldmVudCAmIGJhY2sgYnV0dG9uIHN1cHBvcnQsIHdpdGhvdXQgYWxsIHRoZQovLyAgICAgICAgIGV4dHJhIGF3ZXNvbWVuZXNzIHRoYXQgQkJRIHByb3ZpZGVzLiBUaGlzIHBsdWdpbiB3aWxsIGJlIGluY2x1ZGVkIGFzCi8vICAgICAgICAgcGFydCBvZiBqUXVlcnkgQkJRLCBidXQgYWxzbyBiZSBhdmFpbGFibGUgc2VwYXJhdGVseS4KCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CiAgLy8gUmV1c2VkIHN0cmluZy4KICB2YXIgc3RyX2hhc2hjaGFuZ2UgPSAnaGFzaGNoYW5nZScsCiAgICAKICAgIC8vIE1ldGhvZCAvIG9iamVjdCByZWZlcmVuY2VzLgogICAgZG9jID0gZG9jdW1lbnQsCiAgICBmYWtlX29uaGFzaGNoYW5nZSwKICAgIHNwZWNpYWwgPSAkLmV2ZW50LnNwZWNpYWwsCiAgICAKICAgIC8vIERvZXMgdGhlIGJyb3dzZXIgc3VwcG9ydCB3aW5kb3cub25oYXNoY2hhbmdlPyBOb3RlIHRoYXQgSUU4IHJ1bm5pbmcgaW4KICAgIC8vIElFNyBjb21wYXRpYmlsaXR5IG1vZGUgcmVwb3J0cyB0cnVlIGZvciAnb25oYXNoY2hhbmdlJyBpbiB3aW5kb3csIGV2ZW4KICAgIC8vIHRob3VnaCB0aGUgZXZlbnQgaXNuJ3Qgc3VwcG9ydGVkLCBzbyBhbHNvIHRlc3QgZG9jdW1lbnQuZG9jdW1lbnRNb2RlLgogICAgZG9jX21vZGUgPSBkb2MuZG9jdW1lbnRNb2RlLAogICAgc3VwcG9ydHNfb25oYXNoY2hhbmdlID0gJ29uJyArIHN0cl9oYXNoY2hhbmdlIGluIHdpbmRvdyAmJiAoIGRvY19tb2RlID09PSB1bmRlZmluZWQgfHwgZG9jX21vZGUgPiA3ICk7CiAgCiAgLy8gR2V0IGxvY2F0aW9uLmhhc2ggKG9yIHdoYXQgeW91J2QgZXhwZWN0IGxvY2F0aW9uLmhhc2ggdG8gYmUpIHNhbnMgYW55CiAgLy8gbGVhZGluZyAjLiBUaGFua3MgZm9yIG1ha2luZyB0aGlzIG5lY2Vzc2FyeSwgRmlyZWZveCEKICBmdW5jdGlvbiBnZXRfZnJhZ21lbnQoIHVybCApIHsKICAgIHVybCA9IHVybCB8fCBsb2NhdGlvbi5ocmVmOwogICAgcmV0dXJuICcjJyArIHVybC5yZXBsYWNlKCAvXlteI10qIz8oLiopJC8sICckMScgKTsKICB9OwogIAogIC8vIE1ldGhvZDogalF1ZXJ5LmZuLmhhc2hjaGFuZ2UKICAvLyAKICAvLyBCaW5kIGEgaGFuZGxlciB0byB0aGUgd2luZG93Lm9uaGFzaGNoYW5nZSBldmVudCBvciB0cmlnZ2VyIGFsbCBib3VuZAogIC8vIHdpbmRvdy5vbmhhc2hjaGFuZ2UgZXZlbnQgaGFuZGxlcnMuIFRoaXMgYmVoYXZpb3IgaXMgY29uc2lzdGVudCB3aXRoCiAgLy8galF1ZXJ5J3MgYnVpbHQtaW4gZXZlbnQgaGFuZGxlcnMuCiAgLy8gCiAgLy8gVXNhZ2U6CiAgLy8gCiAgLy8gPiBqUXVlcnkod2luZG93KS5oYXNoY2hhbmdlKCBbIGhhbmRsZXIgXSApOwogIC8vIAogIC8vIEFyZ3VtZW50czoKICAvLyAKICAvLyAgaGFuZGxlciAtIChGdW5jdGlvbikgT3B0aW9uYWwgaGFuZGxlciB0byBiZSBib3VuZCB0byB0aGUgaGFzaGNoYW5nZQogIC8vICAgIGV2ZW50LiBUaGlzIGlzIGEgInNob3J0Y3V0IiBmb3IgdGhlIG1vcmUgdmVyYm9zZSBmb3JtOgogIC8vICAgIGpRdWVyeSh3aW5kb3cpLmJpbmQoICdoYXNoY2hhbmdlJywgaGFuZGxlciApLiBJZiBoYW5kbGVyIGlzIG9taXR0ZWQsCiAgLy8gICAgYWxsIGJvdW5kIHdpbmRvdy5vbmhhc2hjaGFuZ2UgZXZlbnQgaGFuZGxlcnMgd2lsbCBiZSB0cmlnZ2VyZWQuIFRoaXMKICAvLyAgICBpcyBhIHNob3J0Y3V0IGZvciB0aGUgbW9yZSB2ZXJib3NlCiAgLy8gICAgalF1ZXJ5KHdpbmRvdykudHJpZ2dlciggJ2hhc2hjaGFuZ2UnICkuIFRoZXNlIGZvcm1zIGFyZSBkZXNjcmliZWQgaW4KICAvLyAgICB0aGUgPGhhc2hjaGFuZ2UgZXZlbnQ+IHNlY3Rpb24uCiAgLy8gCiAgLy8gUmV0dXJuczoKICAvLyAKICAvLyAgKGpRdWVyeSkgVGhlIGluaXRpYWwgalF1ZXJ5IGNvbGxlY3Rpb24gb2YgZWxlbWVudHMuCiAgCiAgLy8gQWxsb3cgdGhlICJzaG9ydGN1dCIgZm9ybWF0ICQoZWxlbSkuaGFzaGNoYW5nZSggZm4gKSBmb3IgYmluZGluZyBhbmQKICAvLyAkKGVsZW0pLmhhc2hjaGFuZ2UoKSBmb3IgdHJpZ2dlcmluZywgbGlrZSBqUXVlcnkgZG9lcyBmb3IgYnVpbHQtaW4gZXZlbnRzLgogICQuZm5bIHN0cl9oYXNoY2hhbmdlIF0gPSBmdW5jdGlvbiggZm4gKSB7CiAgICByZXR1cm4gZm4gPyB0aGlzLmJpbmQoIHN0cl9oYXNoY2hhbmdlLCBmbiApIDogdGhpcy50cmlnZ2VyKCBzdHJfaGFzaGNoYW5nZSApOwogIH07CiAgCiAgLy8gUHJvcGVydHk6IGpRdWVyeS5mbi5oYXNoY2hhbmdlLmRlbGF5CiAgLy8gCiAgLy8gVGhlIG51bWVyaWMgaW50ZXJ2YWwgKGluIG1pbGxpc2Vjb25kcykgYXQgd2hpY2ggdGhlIDxoYXNoY2hhbmdlIGV2ZW50PgogIC8vIHBvbGxpbmcgbG9vcCBleGVjdXRlcy4gRGVmYXVsdHMgdG8gNTAuCiAgCiAgLy8gUHJvcGVydHk6IGpRdWVyeS5mbi5oYXNoY2hhbmdlLmRvbWFpbgogIC8vIAogIC8vIElmIHlvdSdyZSBzZXR0aW5nIGRvY3VtZW50LmRvbWFpbiBpbiB5b3VyIEphdmFTY3JpcHQsIGFuZCB5b3Ugd2FudCBoYXNoCiAgLy8gaGlzdG9yeSB0byB3b3JrIGluIElFNi83LCBub3Qgb25seSBtdXN0IHRoaXMgcHJvcGVydHkgYmUgc2V0LCBidXQgeW91IG11c3QKICAvLyBhbHNvIHNldCBkb2N1bWVudC5kb21haW4gQkVGT1JFIGpRdWVyeSBpcyBsb2FkZWQgaW50byB0aGUgcGFnZS4gVGhpcwogIC8vIHByb3BlcnR5IGlzIG9ubHkgYXBwbGljYWJsZSBpZiB5b3UgYXJlIHN1cHBvcnRpbmcgSUU2LzcgKG9yIElFOCBvcGVyYXRpbmcKICAvLyBpbiAiSUU3IGNvbXBhdGliaWxpdHkiIG1vZGUpLgogIC8vIAogIC8vIEluIGFkZGl0aW9uLCB0aGUgPGpRdWVyeS5mbi5oYXNoY2hhbmdlLnNyYz4gcHJvcGVydHkgbXVzdCBiZSBzZXQgdG8gdGhlCiAgLy8gcGF0aCBvZiB0aGUgaW5jbHVkZWQgImRvY3VtZW50LWRvbWFpbi5odG1sIiBmaWxlLCB3aGljaCBjYW4gYmUgcmVuYW1lZCBvcgogIC8vIG1vZGlmaWVkIGlmIG5lY2Vzc2FyeSAobm90ZSB0aGF0IHRoZSBkb2N1bWVudC5kb21haW4gc3BlY2lmaWVkIG11c3QgYmUgdGhlCiAgLy8gc2FtZSBpbiBib3RoIHlvdXIgbWFpbiBKYXZhU2NyaXB0IGFzIHdlbGwgYXMgaW4gdGhpcyBmaWxlKS4KICAvLyAKICAvLyBVc2FnZToKICAvLyAKICAvLyBqUXVlcnkuZm4uaGFzaGNoYW5nZS5kb21haW4gPSBkb2N1bWVudC5kb21haW47CiAgCiAgLy8gUHJvcGVydHk6IGpRdWVyeS5mbi5oYXNoY2hhbmdlLnNyYwogIC8vIAogIC8vIElmLCBmb3Igc29tZSByZWFzb24sIHlvdSBuZWVkIHRvIHNwZWNpZnkgYW4gSWZyYW1lIHNyYyBmaWxlIChmb3IgZXhhbXBsZSwKICAvLyB3aGVuIHNldHRpbmcgZG9jdW1lbnQuZG9tYWluIGFzIGluIDxqUXVlcnkuZm4uaGFzaGNoYW5nZS5kb21haW4+KSwgeW91IGNhbgogIC8vIGRvIHNvIHVzaW5nIHRoaXMgcHJvcGVydHkuIE5vdGUgdGhhdCB3aGVuIHVzaW5nIHRoaXMgcHJvcGVydHksIGhpc3RvcnkKICAvLyB3b24ndCBiZSByZWNvcmRlZCBpbiBJRTYvNyB1bnRpbCB0aGUgSWZyYW1lIHNyYyBmaWxlIGxvYWRzLiBUaGlzIHByb3BlcnR5CiAgLy8gaXMgb25seSBhcHBsaWNhYmxlIGlmIHlvdSBhcmUgc3VwcG9ydGluZyBJRTYvNyAob3IgSUU4IG9wZXJhdGluZyBpbiAiSUU3CiAgLy8gY29tcGF0aWJpbGl0eSIgbW9kZSkuCiAgLy8gCiAgLy8gVXNhZ2U6CiAgLy8gCiAgLy8galF1ZXJ5LmZuLmhhc2hjaGFuZ2Uuc3JjID0gJ3BhdGgvdG8vZmlsZS5odG1sJzsKICAKICAkLmZuWyBzdHJfaGFzaGNoYW5nZSBdLmRlbGF5ID0gNTA7CiAgLyoKICAkLmZuWyBzdHJfaGFzaGNoYW5nZSBdLmRvbWFpbiA9IG51bGw7CiAgJC5mblsgc3RyX2hhc2hjaGFuZ2UgXS5zcmMgPSBudWxsOwogICovCiAgCiAgLy8gRXZlbnQ6IGhhc2hjaGFuZ2UgZXZlbnQKICAvLyAKICAvLyBGaXJlZCB3aGVuIGxvY2F0aW9uLmhhc2ggY2hhbmdlcy4gSW4gYnJvd3NlcnMgdGhhdCBzdXBwb3J0IGl0LCB0aGUgbmF0aXZlCiAgLy8gSFRNTDUgd2luZG93Lm9uaGFzaGNoYW5nZSBldmVudCBpcyB1c2VkLCBvdGhlcndpc2UgYSBwb2xsaW5nIGxvb3AgaXMKICAvLyBpbml0aWFsaXplZCwgcnVubmluZyBldmVyeSA8alF1ZXJ5LmZuLmhhc2hjaGFuZ2UuZGVsYXk+IG1pbGxpc2Vjb25kcyB0bwogIC8vIHNlZSBpZiB0aGUgaGFzaCBoYXMgY2hhbmdlZC4gSW4gSUU2LzcgKGFuZCBJRTggb3BlcmF0aW5nIGluICJJRTcKICAvLyBjb21wYXRpYmlsaXR5IiBtb2RlKSwgYSBoaWRkZW4gSWZyYW1lIGlzIGNyZWF0ZWQgdG8gYWxsb3cgdGhlIGJhY2sgYnV0dG9uCiAgLy8gYW5kIGhhc2gtYmFzZWQgaGlzdG9yeSB0byB3b3JrLgogIC8vIAogIC8vIFVzYWdlIGFzIGRlc2NyaWJlZCBpbiA8alF1ZXJ5LmZuLmhhc2hjaGFuZ2U+OgogIC8vIAogIC8vID4gLy8gQmluZCBhbiBldmVudCBoYW5kbGVyLgogIC8vID4galF1ZXJ5KHdpbmRvdykuaGFzaGNoYW5nZSggZnVuY3Rpb24oZSkgewogIC8vID4gICB2YXIgaGFzaCA9IGxvY2F0aW9uLmhhc2g7CiAgLy8gPiAgIC4uLgogIC8vID4gfSk7CiAgLy8gPiAKICAvLyA+IC8vIE1hbnVhbGx5IHRyaWdnZXIgdGhlIGV2ZW50IGhhbmRsZXIuCiAgLy8gPiBqUXVlcnkod2luZG93KS5oYXNoY2hhbmdlKCk7CiAgLy8gCiAgLy8gQSBtb3JlIHZlcmJvc2UgdXNhZ2UgdGhhdCBhbGxvd3MgZm9yIGV2ZW50IG5hbWVzcGFjaW5nOgogIC8vIAogIC8vID4gLy8gQmluZCBhbiBldmVudCBoYW5kbGVyLgogIC8vID4galF1ZXJ5KHdpbmRvdykuYmluZCggJ2hhc2hjaGFuZ2UnLCBmdW5jdGlvbihlKSB7CiAgLy8gPiAgIHZhciBoYXNoID0gbG9jYXRpb24uaGFzaDsKICAvLyA+ICAgLi4uCiAgLy8gPiB9KTsKICAvLyA+IAogIC8vID4gLy8gTWFudWFsbHkgdHJpZ2dlciB0aGUgZXZlbnQgaGFuZGxlci4KICAvLyA+IGpRdWVyeSh3aW5kb3cpLnRyaWdnZXIoICdoYXNoY2hhbmdlJyApOwogIC8vIAogIC8vIEFkZGl0aW9uYWwgTm90ZXM6CiAgLy8gCiAgLy8gKiBUaGUgcG9sbGluZyBsb29wIGFuZCBJZnJhbWUgYXJlIG5vdCBjcmVhdGVkIHVudGlsIGF0IGxlYXN0IG9uZSBoYW5kbGVyCiAgLy8gICBpcyBhY3R1YWxseSBib3VuZCB0byB0aGUgJ2hhc2hjaGFuZ2UnIGV2ZW50LgogIC8vICogSWYgeW91IG5lZWQgdGhlIGJvdW5kIGhhbmRsZXIocykgdG8gZXhlY3V0ZSBpbW1lZGlhdGVseSwgaW4gY2FzZXMgd2hlcmUKICAvLyAgIGEgbG9jYXRpb24uaGFzaCBleGlzdHMgb24gcGFnZSBsb2FkLCB2aWEgYm9va21hcmsgb3IgcGFnZSByZWZyZXNoIGZvcgogIC8vICAgZXhhbXBsZSwgdXNlIGpRdWVyeSh3aW5kb3cpLmhhc2hjaGFuZ2UoKSBvciB0aGUgbW9yZSB2ZXJib3NlIAogIC8vICAgalF1ZXJ5KHdpbmRvdykudHJpZ2dlciggJ2hhc2hjaGFuZ2UnICkuCiAgLy8gKiBUaGUgZXZlbnQgY2FuIGJlIGJvdW5kIGJlZm9yZSBET00gcmVhZHksIGJ1dCBzaW5jZSBpdCB3b24ndCBiZSB1c2FibGUKICAvLyAgIGJlZm9yZSB0aGVuIGluIElFNi83IChkdWUgdG8gdGhlIG5lY2Vzc2FyeSBJZnJhbWUpLCByZWNvbW1lbmRlZCB1c2FnZSBpcwogIC8vICAgdG8gYmluZCBpdCBpbnNpZGUgYSBET00gcmVhZHkgaGFuZGxlci4KICAKICAvLyBPdmVycmlkZSBleGlzdGluZyAkLmV2ZW50LnNwZWNpYWwuaGFzaGNoYW5nZSBtZXRob2RzIChhbGxvd2luZyB0aGlzIHBsdWdpbgogIC8vIHRvIGJlIGRlZmluZWQgYWZ0ZXIgalF1ZXJ5IEJCUSBpbiBCQlEncyBzb3VyY2UgY29kZSkuCiAgc3BlY2lhbFsgc3RyX2hhc2hjaGFuZ2UgXSA9ICQuZXh0ZW5kKCBzcGVjaWFsWyBzdHJfaGFzaGNoYW5nZSBdLCB7CiAgICAKICAgIC8vIENhbGxlZCBvbmx5IHdoZW4gdGhlIGZpcnN0ICdoYXNoY2hhbmdlJyBldmVudCBpcyBib3VuZCB0byB3aW5kb3cuCiAgICBzZXR1cDogZnVuY3Rpb24oKSB7CiAgICAgIC8vIElmIHdpbmRvdy5vbmhhc2hjaGFuZ2UgaXMgc3VwcG9ydGVkIG5hdGl2ZWx5LCB0aGVyZSdzIG5vdGhpbmcgdG8gZG8uLgogICAgICBpZiAoIHN1cHBvcnRzX29uaGFzaGNoYW5nZSApIHsgcmV0dXJuIGZhbHNlOyB9CiAgICAgIAogICAgICAvLyBPdGhlcndpc2UsIHdlIG5lZWQgdG8gY3JlYXRlIG91ciBvd24uIEFuZCB3ZSBkb24ndCB3YW50IHRvIGNhbGwgdGhpcwogICAgICAvLyB1bnRpbCB0aGUgdXNlciBiaW5kcyB0byB0aGUgZXZlbnQsIGp1c3QgaW4gY2FzZSB0aGV5IG5ldmVyIGRvLCBzaW5jZSBpdAogICAgICAvLyB3aWxsIGNyZWF0ZSBhIHBvbGxpbmcgbG9vcCBhbmQgcG9zc2libHkgZXZlbiBhIGhpZGRlbiBJZnJhbWUuCiAgICAgICQoIGZha2Vfb25oYXNoY2hhbmdlLnN0YXJ0ICk7CiAgICB9LAogICAgCiAgICAvLyBDYWxsZWQgb25seSB3aGVuIHRoZSBsYXN0ICdoYXNoY2hhbmdlJyBldmVudCBpcyB1bmJvdW5kIGZyb20gd2luZG93LgogICAgdGVhcmRvd246IGZ1bmN0aW9uKCkgewogICAgICAvLyBJZiB3aW5kb3cub25oYXNoY2hhbmdlIGlzIHN1cHBvcnRlZCBuYXRpdmVseSwgdGhlcmUncyBub3RoaW5nIHRvIGRvLi4KICAgICAgaWYgKCBzdXBwb3J0c19vbmhhc2hjaGFuZ2UgKSB7IHJldHVybiBmYWxzZTsgfQogICAgICAKICAgICAgLy8gT3RoZXJ3aXNlLCB3ZSBuZWVkIHRvIHN0b3Agb3VycyAoaWYgcG9zc2libGUpLgogICAgICAkKCBmYWtlX29uaGFzaGNoYW5nZS5zdG9wICk7CiAgICB9CiAgICAKICB9KTsKICAKICAvLyBmYWtlX29uaGFzaGNoYW5nZSBkb2VzIGFsbCB0aGUgd29yayBvZiB0cmlnZ2VyaW5nIHRoZSB3aW5kb3cub25oYXNoY2hhbmdlCiAgLy8gZXZlbnQgZm9yIGJyb3dzZXJzIHRoYXQgZG9uJ3QgbmF0aXZlbHkgc3VwcG9ydCBpdCwgaW5jbHVkaW5nIGNyZWF0aW5nIGEKICAvLyBwb2xsaW5nIGxvb3AgdG8gd2F0Y2ggZm9yIGhhc2ggY2hhbmdlcyBhbmQgaW4gSUUgNi83IGNyZWF0aW5nIGEgaGlkZGVuCiAgLy8gSWZyYW1lIHRvIGVuYWJsZSBiYWNrIGFuZCBmb3J3YXJkLgogIGZha2Vfb25oYXNoY2hhbmdlID0gKGZ1bmN0aW9uKCkgewogICAgdmFyIHNlbGYgPSB7fSwKICAgICAgdGltZW91dF9pZCwKICAgICAgCiAgICAgIC8vIFJlbWVtYmVyIHRoZSBpbml0aWFsIGhhc2ggc28gaXQgZG9lc24ndCBnZXQgdHJpZ2dlcmVkIGltbWVkaWF0ZWx5LgogICAgICBsYXN0X2hhc2ggPSBnZXRfZnJhZ21lbnQoKSwKICAgICAgCiAgICAgIGZuX3JldHZhbCA9IGZ1bmN0aW9uKCB2YWwgKSB7IHJldHVybiB2YWw7IH0sCiAgICAgIGhpc3Rvcnlfc2V0ID0gZm5fcmV0dmFsLAogICAgICBoaXN0b3J5X2dldCA9IGZuX3JldHZhbDsKICAgIAogICAgLy8gU3RhcnQgdGhlIHBvbGxpbmcgbG9vcC4KICAgIHNlbGYuc3RhcnQgPSBmdW5jdGlvbigpIHsKICAgICAgdGltZW91dF9pZCB8fCBwb2xsKCk7CiAgICB9OwogICAgCiAgICAvLyBTdG9wIHRoZSBwb2xsaW5nIGxvb3AuCiAgICBzZWxmLnN0b3AgPSBmdW5jdGlvbigpIHsKICAgICAgdGltZW91dF9pZCAmJiBjbGVhclRpbWVvdXQoIHRpbWVvdXRfaWQgKTsKICAgICAgdGltZW91dF9pZCA9IHVuZGVmaW5lZDsKICAgIH07CiAgICAKICAgIC8vIFRoaXMgcG9sbGluZyBsb29wIGNoZWNrcyBldmVyeSAkLmZuLmhhc2hjaGFuZ2UuZGVsYXkgbWlsbGlzZWNvbmRzIHRvIHNlZQogICAgLy8gaWYgbG9jYXRpb24uaGFzaCBoYXMgY2hhbmdlZCwgYW5kIHRyaWdnZXJzIHRoZSAnaGFzaGNoYW5nZScgZXZlbnQgb24KICAgIC8vIHdpbmRvdyB3aGVuIG5lY2Vzc2FyeS4KICAgIGZ1bmN0aW9uIHBvbGwoKSB7CiAgICAgIHZhciBoYXNoID0gZ2V0X2ZyYWdtZW50KCksCiAgICAgICAgaGlzdG9yeV9oYXNoID0gaGlzdG9yeV9nZXQoIGxhc3RfaGFzaCApOwogICAgICAKICAgICAgaWYgKCBoYXNoICE9PSBsYXN0X2hhc2ggKSB7CiAgICAgICAgaGlzdG9yeV9zZXQoIGxhc3RfaGFzaCA9IGhhc2gsIGhpc3RvcnlfaGFzaCApOwogICAgICAgIAogICAgICAgICQod2luZG93KS50cmlnZ2VyKCBzdHJfaGFzaGNoYW5nZSApOwogICAgICAgIAogICAgICB9IGVsc2UgaWYgKCBoaXN0b3J5X2hhc2ggIT09IGxhc3RfaGFzaCApIHsKICAgICAgICBsb2NhdGlvbi5ocmVmID0gbG9jYXRpb24uaHJlZi5yZXBsYWNlKCAvIy4qLywgJycgKSArIGhpc3RvcnlfaGFzaDsKICAgICAgfQogICAgICAKICAgICAgdGltZW91dF9pZCA9IHNldFRpbWVvdXQoIHBvbGwsICQuZm5bIHN0cl9oYXNoY2hhbmdlIF0uZGVsYXkgKTsKICAgIH07CiAgICAKICAgIC8vIHZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dgogICAgLy8gdnZ2dnZ2dnZ2dnZ2dnZ2dnZ2diBSRU1PVkUgSUYgTk9UIFNVUFBPUlRJTkcgSUU2LzcvOCB2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2CiAgICAvLyB2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnYKICAgIHdpbmRvdy5hdHRhY2hFdmVudCAmJiAhd2luZG93LmFkZEV2ZW50TGlzdGVuZXIgJiYgIXN1cHBvcnRzX29uaGFzaGNoYW5nZSAmJiAoZnVuY3Rpb24oKSB7CiAgICAgIC8vIE5vdCBvbmx5IGRvIElFNi83IG5lZWQgdGhlICJtYWdpY2FsIiBJZnJhbWUgdHJlYXRtZW50LCBidXQgc28gZG9lcyBJRTgKICAgICAgLy8gd2hlbiBydW5uaW5nIGluICJJRTcgY29tcGF0aWJpbGl0eSIgbW9kZS4KICAgICAgCiAgICAgIHZhciBpZnJhbWUsCiAgICAgICAgaWZyYW1lX3NyYzsKICAgICAgCiAgICAgIC8vIFdoZW4gdGhlIGV2ZW50IGlzIGJvdW5kIGFuZCBwb2xsaW5nIHN0YXJ0cyBpbiBJRSA2LzcsIGNyZWF0ZSBhIGhpZGRlbgogICAgICAvLyBJZnJhbWUgZm9yIGhpc3RvcnkgaGFuZGxpbmcuCiAgICAgIHNlbGYuc3RhcnQgPSBmdW5jdGlvbigpIHsKICAgICAgICBpZiAoICFpZnJhbWUgKSB7CiAgICAgICAgICBpZnJhbWVfc3JjID0gJC5mblsgc3RyX2hhc2hjaGFuZ2UgXS5zcmM7CiAgICAgICAgICBpZnJhbWVfc3JjID0gaWZyYW1lX3NyYyAmJiBpZnJhbWVfc3JjICsgZ2V0X2ZyYWdtZW50KCk7CiAgICAgICAgICAKICAgICAgICAgIC8vIENyZWF0ZSBoaWRkZW4gSWZyYW1lLiBBdHRlbXB0IHRvIG1ha2UgSWZyYW1lIGFzIGhpZGRlbiBhcyBwb3NzaWJsZQogICAgICAgICAgLy8gYnkgdXNpbmcgdGVjaG5pcXVlcyBmcm9tIGh0dHA6Ly93d3cucGFjaWVsbG9ncm91cC5jb20vYmxvZy8/cD02MDQuCiAgICAgICAgICBpZnJhbWUgPSAkKCc8aWZyYW1lIHRhYmluZGV4PSItMSIgdGl0bGU9ImVtcHR5Ii8+JykuaGlkZSgpCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBXaGVuIElmcmFtZSBoYXMgY29tcGxldGVseSBsb2FkZWQsIGluaXRpYWxpemUgdGhlIGhpc3RvcnkgYW5kCiAgICAgICAgICAgIC8vIHN0YXJ0IHBvbGxpbmcuCiAgICAgICAgICAgIC5vbmUoICdsb2FkJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgaWZyYW1lX3NyYyB8fCBoaXN0b3J5X3NldCggZ2V0X2ZyYWdtZW50KCkgKTsKICAgICAgICAgICAgICBwb2xsKCk7CiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBMb2FkIElmcmFtZSBzcmMgaWYgc3BlY2lmaWVkLCBvdGhlcndpc2Ugbm90aGluZy4KICAgICAgICAgICAgLmF0dHIoICdzcmMnLCBpZnJhbWVfc3JjIHx8ICdqYXZhc2NyaXB0OjAnICkKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEFwcGVuZCBJZnJhbWUgYWZ0ZXIgdGhlIGVuZCBvZiB0aGUgYm9keSB0byBwcmV2ZW50IHVubmVjZXNzYXJ5CiAgICAgICAgICAgIC8vIGluaXRpYWwgcGFnZSBzY3JvbGxpbmcgKHllcywgdGhpcyB3b3JrcykuCiAgICAgICAgICAgIC5pbnNlcnRBZnRlciggJ2JvZHknIClbMF0uY29udGVudFdpbmRvdzsKICAgICAgICAgIAogICAgICAgICAgLy8gV2hlbmV2ZXIgYGRvY3VtZW50LnRpdGxlYCBjaGFuZ2VzLCB1cGRhdGUgdGhlIElmcmFtZSdzIHRpdGxlIHRvCiAgICAgICAgICAvLyBwcmV0dGlmeSB0aGUgYmFjay9uZXh0IGhpc3RvcnkgbWVudSBlbnRyaWVzLiBTaW5jZSBJRSBzb21ldGltZXMKICAgICAgICAgIC8vIGVycm9ycyB3aXRoICJVbnNwZWNpZmllZCBlcnJvciIgdGhlIHZlcnkgZmlyc3QgdGltZSB0aGlzIGlzIHNldAogICAgICAgICAgLy8gKHllcywgdmVyeSB1c2VmdWwpIHdyYXAgdGhpcyB3aXRoIGEgdHJ5L2NhdGNoIGJsb2NrLgogICAgICAgICAgZG9jLm9ucHJvcGVydHljaGFuZ2UgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICBpZiAoIGV2ZW50LnByb3BlcnR5TmFtZSA9PT0gJ3RpdGxlJyApIHsKICAgICAgICAgICAgICAgIGlmcmFtZS5kb2N1bWVudC50aXRsZSA9IGRvYy50aXRsZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gY2F0Y2goZSkge30KICAgICAgICAgIH07CiAgICAgICAgICAKICAgICAgICB9CiAgICAgIH07CiAgICAgIAogICAgICAvLyBPdmVycmlkZSB0aGUgInN0b3AiIG1ldGhvZCBzaW5jZSBhbiBJRTYvNyBJZnJhbWUgd2FzIGNyZWF0ZWQuIEV2ZW4KICAgICAgLy8gaWYgdGhlcmUgYXJlIG5vIGxvbmdlciBhbnkgYm91bmQgZXZlbnQgaGFuZGxlcnMsIHRoZSBwb2xsaW5nIGxvb3AKICAgICAgLy8gaXMgc3RpbGwgbmVjZXNzYXJ5IGZvciBiYWNrL25leHQgdG8gd29yayBhdCBhbGwhCiAgICAgIHNlbGYuc3RvcCA9IGZuX3JldHZhbDsKICAgICAgCiAgICAgIC8vIEdldCBoaXN0b3J5IGJ5IGxvb2tpbmcgYXQgdGhlIGhpZGRlbiBJZnJhbWUncyBsb2NhdGlvbi5oYXNoLgogICAgICBoaXN0b3J5X2dldCA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBnZXRfZnJhZ21lbnQoIGlmcmFtZS5sb2NhdGlvbi5ocmVmICk7CiAgICAgIH07CiAgICAgIAogICAgICAvLyBTZXQgYSBuZXcgaGlzdG9yeSBpdGVtIGJ5IG9wZW5pbmcgYW5kIHRoZW4gY2xvc2luZyB0aGUgSWZyYW1lCiAgICAgIC8vIGRvY3VtZW50LCAqdGhlbiogc2V0dGluZyBpdHMgbG9jYXRpb24uaGFzaC4gSWYgZG9jdW1lbnQuZG9tYWluIGhhcwogICAgICAvLyBiZWVuIHNldCwgdXBkYXRlIHRoYXQgYXMgd2VsbC4KICAgICAgaGlzdG9yeV9zZXQgPSBmdW5jdGlvbiggaGFzaCwgaGlzdG9yeV9oYXNoICkgewogICAgICAgIHZhciBpZnJhbWVfZG9jID0gaWZyYW1lLmRvY3VtZW50LAogICAgICAgICAgZG9tYWluID0gJC5mblsgc3RyX2hhc2hjaGFuZ2UgXS5kb21haW47CiAgICAgICAgCiAgICAgICAgaWYgKCBoYXNoICE9PSBoaXN0b3J5X2hhc2ggKSB7CiAgICAgICAgICAvLyBVcGRhdGUgSWZyYW1lIHdpdGggYW55IGluaXRpYWwgYGRvY3VtZW50LnRpdGxlYCB0aGF0IG1pZ2h0IGJlIHNldC4KICAgICAgICAgIGlmcmFtZV9kb2MudGl0bGUgPSBkb2MudGl0bGU7CiAgICAgICAgICAKICAgICAgICAgIC8vIE9wZW5pbmcgdGhlIElmcmFtZSdzIGRvY3VtZW50IGFmdGVyIGl0IGhhcyBiZWVuIGNsb3NlZCBpcyB3aGF0CiAgICAgICAgICAvLyBhY3R1YWxseSBhZGRzIGEgaGlzdG9yeSBlbnRyeS4KICAgICAgICAgIGlmcmFtZV9kb2Mub3BlbigpOwogICAgICAgICAgCiAgICAgICAgICAvLyBTZXQgZG9jdW1lbnQuZG9tYWluIGZvciB0aGUgSWZyYW1lIGRvY3VtZW50IGFzIHdlbGwsIGlmIG5lY2Vzc2FyeS4KICAgICAgICAgIGRvbWFpbiAmJiBpZnJhbWVfZG9jLndyaXRlKCAnPHNjcmlwdD5kb2N1bWVudC5kb21haW49IicgKyBkb21haW4gKyAnIjxcL3NjcmlwdD4nICk7CiAgICAgICAgICAKICAgICAgICAgIGlmcmFtZV9kb2MuY2xvc2UoKTsKICAgICAgICAgIAogICAgICAgICAgLy8gVXBkYXRlIHRoZSBJZnJhbWUncyBoYXNoLCBmb3IgZ3JlYXQganVzdGljZS4KICAgICAgICAgIGlmcmFtZS5sb2NhdGlvbi5oYXNoID0gaGFzaDsKICAgICAgICB9CiAgICAgIH07CiAgICAgIAogICAgfSkoKTsKICAgIC8vIF5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXgogICAgLy8gXl5eXl5eXl5eXl5eXl5eXl5eXiBSRU1PVkUgSUYgTk9UIFNVUFBPUlRJTkcgSUU2LzcvOCBeXl5eXl5eXl5eXl5eXl5eXl5eCiAgICAvLyBeXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl4KICAgIAogICAgcmV0dXJuIHNlbGY7CiAgfSkoKTsKICAKfSkoalF1ZXJ5LHRoaXMpOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgoJLyohIG1hdGNoTWVkaWEoKSBwb2x5ZmlsbCAtIFRlc3QgYSBDU1MgbWVkaWEgdHlwZS9xdWVyeSBpbiBKUy4gQXV0aG9ycyAmIGNvcHlyaWdodCAoYykgMjAxMjogU2NvdHQgSmVobCwgUGF1bCBJcmlzaCwgTmljaG9sYXMgWmFrYXMuIER1YWwgTUlUL0JTRCBsaWNlbnNlICovCgl3aW5kb3cubWF0Y2hNZWRpYSA9IHdpbmRvdy5tYXRjaE1lZGlhIHx8IChmdW5jdGlvbiggZG9jLCB1bmRlZmluZWQgKSB7CgoJCQoKCQl2YXIgYm9vbCwKCQkJZG9jRWxlbSA9IGRvYy5kb2N1bWVudEVsZW1lbnQsCgkJCXJlZk5vZGUgPSBkb2NFbGVtLmZpcnN0RWxlbWVudENoaWxkIHx8IGRvY0VsZW0uZmlyc3RDaGlsZCwKCQkJLy8gZmFrZUJvZHkgcmVxdWlyZWQgZm9yIDxGRjQgd2hlbiBleGVjdXRlZCBpbiA8aGVhZD4KCQkJZmFrZUJvZHkgPSBkb2MuY3JlYXRlRWxlbWVudCggImJvZHkiICksCgkJCWRpdiA9IGRvYy5jcmVhdGVFbGVtZW50KCAiZGl2IiApOwoKCQlkaXYuaWQgPSAibXEtdGVzdC0xIjsKCQlkaXYuc3R5bGUuY3NzVGV4dCA9ICJwb3NpdGlvbjphYnNvbHV0ZTt0b3A6LTEwMGVtIjsKCQlmYWtlQm9keS5zdHlsZS5iYWNrZ3JvdW5kID0gIm5vbmUiOwoJCWZha2VCb2R5LmFwcGVuZENoaWxkKGRpdik7CgoJCXJldHVybiBmdW5jdGlvbihxKXsKCgkJCWRpdi5pbm5lckhUTUwgPSAiJnNoeTs8c3R5bGUgbWVkaWE9XCIiICsgcSArICJcIj4gI21xLXRlc3QtMSB7IHdpZHRoOiA0MnB4OyB9PC9zdHlsZT4iOwoKCQkJZG9jRWxlbS5pbnNlcnRCZWZvcmUoIGZha2VCb2R5LCByZWZOb2RlICk7CgkJCWJvb2wgPSBkaXYub2Zmc2V0V2lkdGggPT09IDQyOwoJCQlkb2NFbGVtLnJlbW92ZUNoaWxkKCBmYWtlQm9keSApOwoKCQkJcmV0dXJuIHsKCQkJCW1hdGNoZXM6IGJvb2wsCgkJCQltZWRpYTogcQoJCQl9OwoKCQl9OwoKCX0oIGRvY3VtZW50ICkpOwoKCS8vICQubW9iaWxlLm1lZGlhIHVzZXMgbWF0Y2hNZWRpYSB0byByZXR1cm4gYSBib29sZWFuLgoJJC5tb2JpbGUubWVkaWEgPSBmdW5jdGlvbiggcSApIHsKCQlyZXR1cm4gd2luZG93Lm1hdGNoTWVkaWEoIHEgKS5tYXRjaGVzOwoJfTsKCn0pKGpRdWVyeSk7CgoJKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgkJdmFyIHN1cHBvcnQgPSB7CgkJCXRvdWNoOiAib250b3VjaGVuZCIgaW4gZG9jdW1lbnQKCQl9OwoKCQkkLm1vYmlsZS5zdXBwb3J0ID0gJC5tb2JpbGUuc3VwcG9ydCB8fCB7fTsKCQkkLmV4dGVuZCggJC5zdXBwb3J0LCBzdXBwb3J0ICk7CgkJJC5leHRlbmQoICQubW9iaWxlLnN1cHBvcnQsIHN1cHBvcnQgKTsKCX0oIGpRdWVyeSApKTsKCgkoZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCQkkLmV4dGVuZCggJC5zdXBwb3J0LCB7CgkJCW9yaWVudGF0aW9uOiAib3JpZW50YXRpb24iIGluIHdpbmRvdyAmJiAib25vcmllbnRhdGlvbmNoYW5nZSIgaW4gd2luZG93CgkJfSk7Cgl9KCBqUXVlcnkgKSk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCi8vIHRoeCBNb2Rlcm5penIKZnVuY3Rpb24gcHJvcEV4aXN0cyggcHJvcCApIHsKCXZhciB1Y19wcm9wID0gcHJvcC5jaGFyQXQoIDAgKS50b1VwcGVyQ2FzZSgpICsgcHJvcC5zdWJzdHIoIDEgKSwKCQlwcm9wcyA9ICggcHJvcCArICIgIiArIHZlbmRvcnMuam9pbiggdWNfcHJvcCArICIgIiApICsgdWNfcHJvcCApLnNwbGl0KCAiICIgKSwKCQl2OwoKCWZvciAoIHYgaW4gcHJvcHMgKSB7CgkJaWYgKCBmYkNTU1sgcHJvcHNbIHYgXSBdICE9PSB1bmRlZmluZWQgKSB7CgkJCXJldHVybiB0cnVlOwoJCX0KCX0KfQoKdmFyIGZha2VCb2R5ID0gJCggIjxib2R5PiIgKS5wcmVwZW5kVG8oICJodG1sIiApLAoJZmJDU1MgPSBmYWtlQm9keVsgMCBdLnN0eWxlLAoJdmVuZG9ycyA9IFsgIldlYmtpdCIsICJNb3oiLCAiTyIgXSwKCXdlYm9zID0gInBhbG1HZXRSZXNvdXJjZSIgaW4gd2luZG93LCAvL29ubHkgdXNlZCB0byBydWxlIG91dCBzY3JvbGxUb3AKCW9wZXJhID0gd2luZG93Lm9wZXJhLAoJb3BlcmFtaW5pID0gd2luZG93Lm9wZXJhbWluaSAmJiAoe30pLnRvU3RyaW5nLmNhbGwoIHdpbmRvdy5vcGVyYW1pbmkgKSA9PT0gIltvYmplY3QgT3BlcmFNaW5pXSIsCgliYiA9IHdpbmRvdy5ibGFja2JlcnJ5ICYmICFwcm9wRXhpc3RzKCAiLXdlYmtpdC10cmFuc2Zvcm0iICksIC8vb25seSB1c2VkIHRvIHJ1bGUgb3V0IGJveCBzaGFkb3csIGFzIGl0J3MgZmlsbGVkIG9wYXF1ZSBvbiBCQiA1IGFuZCBsb3dlcgoJbm9raWFMVEU3XzM7CgoKZnVuY3Rpb24gdmFsaWRTdHlsZSggcHJvcCwgdmFsdWUsIGNoZWNrX3ZlbmQgKSB7Cgl2YXIgZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImRpdiIgKSwKCQl1YyA9IGZ1bmN0aW9uKCB0eHQgKSB7CgkJCXJldHVybiB0eHQuY2hhckF0KCAwICkudG9VcHBlckNhc2UoKSArIHR4dC5zdWJzdHIoIDEgKTsKCQl9LAoJCXZlbmRfcHJlZiA9IGZ1bmN0aW9uKCB2ZW5kICkgewoJCQlpZiAoIHZlbmQgPT09ICIiICkgewoJCQkJcmV0dXJuICIiOwoJCQl9IGVsc2UgewoJCQkJcmV0dXJuICAiLSIgKyB2ZW5kLmNoYXJBdCggMCApLnRvTG93ZXJDYXNlKCkgKyB2ZW5kLnN1YnN0ciggMSApICsgIi0iOwoJCQl9CgkJfSwKCQljaGVja19zdHlsZSA9IGZ1bmN0aW9uKCB2ZW5kICkgewoJCQl2YXIgdmVuZF9wcm9wID0gdmVuZF9wcmVmKCB2ZW5kICkgKyBwcm9wICsgIjogIiArIHZhbHVlICsgIjsiLAoJCQkJdWNfdmVuZCA9IHVjKCB2ZW5kICksCgkJCQlwcm9wU3R5bGUgPSB1Y192ZW5kICsgKCB1Y192ZW5kID09PSAiIiA/IHByb3AgOiB1YyggcHJvcCApICk7CgoJCQlkaXYuc2V0QXR0cmlidXRlKCAic3R5bGUiLCB2ZW5kX3Byb3AgKTsKCgkJCWlmICggISFkaXYuc3R5bGVbIHByb3BTdHlsZSBdICkgewoJCQkJcmV0ID0gdHJ1ZTsKCQkJfQoJCX0sCgkJY2hlY2tfdmVuZHMgPSBjaGVja192ZW5kID8gY2hlY2tfdmVuZCA6IHZlbmRvcnMsCgkJaSwgcmV0OwoKCWZvciggaSA9IDA7IGkgPCBjaGVja192ZW5kcy5sZW5ndGg7IGkrKyApIHsKCQljaGVja19zdHlsZSggY2hlY2tfdmVuZHNbaV0gKTsKCX0KCXJldHVybiAhIXJldDsKfQoKLy8gaW5saW5lIFNWRyBzdXBwb3J0IHRlc3QKZnVuY3Rpb24gaW5saW5lU1ZHKCkgewoJLy8gVGhhbmtzIE1vZGVybml6ciAmIEVyaWsgRGFobHN0cm9tCgl2YXIgdyA9IHdpbmRvdywKCQlzdmcgPSAhIXcuZG9jdW1lbnQuY3JlYXRlRWxlbWVudE5TICYmICEhdy5kb2N1bWVudC5jcmVhdGVFbGVtZW50TlMoICJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIsICJzdmciICkuY3JlYXRlU1ZHUmVjdCAmJiAhKCB3Lm9wZXJhICYmIG5hdmlnYXRvci51c2VyQWdlbnQuaW5kZXhPZiggIkNocm9tZSIgKSA9PT0gLTEgKSwKCQlzdXBwb3J0ID0gZnVuY3Rpb24oIGRhdGEgKSB7CgkJCWlmICggISggZGF0YSAmJiBzdmcgKSApIHsKCQkJCSQoICJodG1sIiApLmFkZENsYXNzKCAidWktbm9zdmciICk7CgkJCX0KCQl9LAoJCWltZyA9IG5ldyB3LkltYWdlKCk7CgoJaW1nLm9uZXJyb3IgPSBmdW5jdGlvbigpIHsKCQlzdXBwb3J0KCBmYWxzZSApOwoJfTsKCWltZy5vbmxvYWQgPSBmdW5jdGlvbigpIHsKCQlzdXBwb3J0KCBpbWcud2lkdGggPT09IDEgJiYgaW1nLmhlaWdodCA9PT0gMSApOwoJfTsKCWltZy5zcmMgPSAiZGF0YTppbWFnZS9naWY7YmFzZTY0LFIwbEdPRGxoQVFBQkFJQUFBQUFBQVAvLy95d0FBQUFBQVFBQkFBQUNBVXdBT3c9PSI7Cn0KCmZ1bmN0aW9uIHRyYW5zZm9ybTNkVGVzdCgpIHsKCXZhciBtcVByb3AgPSAidHJhbnNmb3JtLTNkIiwKCQkvLyBCZWNhdXNlIHRoZSBgdHJhbnNsYXRlM2RgIHRlc3QgYmVsb3cgdGhyb3dzIGZhbHNlIHBvc2l0aXZlcyBpbiBBbmRyb2lkOgoJCXJldCA9ICQubW9iaWxlLm1lZGlhKCAiKC0iICsgdmVuZG9ycy5qb2luKCAiLSIgKyBtcVByb3AgKyAiKSwoLSIgKSArICItIiArIG1xUHJvcCArICIpLCgiICsgbXFQcm9wICsgIikiICksCgkJZWwsIHRyYW5zZm9ybXMsIHQ7CgoJaWYgKCByZXQgKSB7CgkJcmV0dXJuICEhcmV0OwoJfQoKCWVsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImRpdiIgKTsKCXRyYW5zZm9ybXMgPSB7CgkJLy8gV2XigJlyZSBvbWl0dGluZyBPcGVyYSBmb3IgdGhlIHRpbWUgYmVpbmc7IE1TIHVzZXMgdW5wcmVmaXhlZC4KCQkiTW96VHJhbnNmb3JtIjogIi1tb3otdHJhbnNmb3JtIiwKCQkidHJhbnNmb3JtIjogInRyYW5zZm9ybSIKCX07CgoJZmFrZUJvZHkuYXBwZW5kKCBlbCApOwoKCWZvciAoIHQgaW4gdHJhbnNmb3JtcyApIHsKCQlpZiAoIGVsLnN0eWxlWyB0IF0gIT09IHVuZGVmaW5lZCApewoJCQllbC5zdHlsZVsgdCBdID0gInRyYW5zbGF0ZTNkKCAxMDBweCwgMXB4LCAxcHggKSI7CgkJCXJldCA9IHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKCBlbCApLmdldFByb3BlcnR5VmFsdWUoIHRyYW5zZm9ybXNbIHQgXSApOwoJCX0KCX0KCXJldHVybiAoICEhcmV0ICYmIHJldCAhPT0gIm5vbmUiICk7Cn0KCi8vIFRlc3QgZm9yIGR5bmFtaWMtdXBkYXRpbmcgYmFzZSB0YWcgc3VwcG9ydCAoIGFsbG93cyB1cyB0byBhdm9pZCBocmVmLHNyYyBhdHRyIHJld3JpdGluZyApCmZ1bmN0aW9uIGJhc2VUYWdUZXN0KCkgewoJdmFyIGZhdXhCYXNlID0gbG9jYXRpb24ucHJvdG9jb2wgKyAiLy8iICsgbG9jYXRpb24uaG9zdCArIGxvY2F0aW9uLnBhdGhuYW1lICsgInVpLWRpci8iLAoJCWJhc2UgPSAkKCAiaGVhZCBiYXNlIiApLAoJCWZhdXhFbGUgPSBudWxsLAoJCWhyZWYgPSAiIiwKCQlsaW5rLCByZWJhc2U7CgoJaWYgKCAhYmFzZS5sZW5ndGggKSB7CgkJYmFzZSA9IGZhdXhFbGUgPSAkKCAiPGJhc2U+IiwgeyAiaHJlZiI6IGZhdXhCYXNlIH0pLmFwcGVuZFRvKCAiaGVhZCIgKTsKCX0gZWxzZSB7CgkJaHJlZiA9IGJhc2UuYXR0ciggImhyZWYiICk7Cgl9CgoJbGluayA9ICQoICI8YSBocmVmPSd0ZXN0dXJsJyAvPiIgKS5wcmVwZW5kVG8oIGZha2VCb2R5ICk7CglyZWJhc2UgPSBsaW5rWyAwIF0uaHJlZjsKCWJhc2VbIDAgXS5ocmVmID0gaHJlZiB8fCBsb2NhdGlvbi5wYXRobmFtZTsKCglpZiAoIGZhdXhFbGUgKSB7CgkJZmF1eEVsZS5yZW1vdmUoKTsKCX0KCXJldHVybiByZWJhc2UuaW5kZXhPZiggZmF1eEJhc2UgKSA9PT0gMDsKfQoKLy8gVGhhbmtzIE1vZGVybml6cgpmdW5jdGlvbiBjc3NQb2ludGVyRXZlbnRzVGVzdCgpIHsKCXZhciBlbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggIngiICksCgkJZG9jdW1lbnRFbGVtZW50ID0gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LAoJCWdldENvbXB1dGVkU3R5bGUgPSB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZSwKCQlzdXBwb3J0czsKCglpZiAoICEoICJwb2ludGVyRXZlbnRzIiBpbiBlbGVtZW50LnN0eWxlICkgKSB7CgkJcmV0dXJuIGZhbHNlOwoJfQoKCWVsZW1lbnQuc3R5bGUucG9pbnRlckV2ZW50cyA9ICJhdXRvIjsKCWVsZW1lbnQuc3R5bGUucG9pbnRlckV2ZW50cyA9ICJ4IjsKCWRvY3VtZW50RWxlbWVudC5hcHBlbmRDaGlsZCggZWxlbWVudCApOwoJc3VwcG9ydHMgPSBnZXRDb21wdXRlZFN0eWxlICYmCglnZXRDb21wdXRlZFN0eWxlKCBlbGVtZW50LCAiIiApLnBvaW50ZXJFdmVudHMgPT09ICJhdXRvIjsKCWRvY3VtZW50RWxlbWVudC5yZW1vdmVDaGlsZCggZWxlbWVudCApOwoJcmV0dXJuICEhc3VwcG9ydHM7Cn0KCmZ1bmN0aW9uIGJvdW5kaW5nUmVjdCgpIHsKCXZhciBkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiZGl2IiApOwoJcmV0dXJuIHR5cGVvZiBkaXYuZ2V0Qm91bmRpbmdDbGllbnRSZWN0ICE9PSAidW5kZWZpbmVkIjsKfQoKLy8gbm9uLVVBLWJhc2VkIElFIHZlcnNpb24gY2hlY2sgYnkgSmFtZXMgUGFkb2xzZXksIG1vZGlmaWVkIGJ5IGpkYWx0b24gLSBmcm9tIGh0dHA6Ly9naXN0LmdpdGh1Yi5jb20vNTI3NjgzCi8vIGFsbG93cyBmb3IgaW5jbHVzaW9uIG9mIElFIDYrLCBpbmNsdWRpbmcgV2luZG93cyBNb2JpbGUgNwokLmV4dGVuZCggJC5tb2JpbGUsIHsgYnJvd3Nlcjoge30gfSApOwokLm1vYmlsZS5icm93c2VyLm9sZElFID0gKGZ1bmN0aW9uKCkgewoJdmFyIHYgPSAzLAoJCWRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJkaXYiICksCgkJYSA9IGRpdi5hbGwgfHwgW107CgoJZG8gewoJCWRpdi5pbm5lckhUTUwgPSAiPCEtLVtpZiBndCBJRSAiICsgKCArK3YgKSArICJdPjxicj48IVtlbmRpZl0tLT4iOwoJfSB3aGlsZSggYVswXSApOwoKCXJldHVybiB2ID4gNCA/IHYgOiAhdjsKfSkoKTsKCmZ1bmN0aW9uIGZpeGVkUG9zaXRpb24oKSB7Cgl2YXIgdyA9IHdpbmRvdywKCQl1YSA9IG5hdmlnYXRvci51c2VyQWdlbnQsCgkJcGxhdGZvcm0gPSBuYXZpZ2F0b3IucGxhdGZvcm0sCgkJLy8gUmVuZGVyaW5nIGVuZ2luZSBpcyBXZWJraXQsIGFuZCBjYXB0dXJlIG1ham9yIHZlcnNpb24KCQl3a21hdGNoID0gdWEubWF0Y2goIC9BcHBsZVdlYktpdFwvKFswLTldKykvICksCgkJd2t2ZXJzaW9uID0gISF3a21hdGNoICYmIHdrbWF0Y2hbIDEgXSwKCQlmZm1hdGNoID0gdWEubWF0Y2goIC9GZW5uZWNcLyhbMC05XSspLyApLAoJCWZmdmVyc2lvbiA9ICEhZmZtYXRjaCAmJiBmZm1hdGNoWyAxIF0sCgkJb3BlcmFtbW9iaWxlbWF0Y2ggPSB1YS5tYXRjaCggL09wZXJhIE1vYmlcLyhbMC05XSspLyApLAoJCW9tdmVyc2lvbiA9ICEhb3BlcmFtbW9iaWxlbWF0Y2ggJiYgb3BlcmFtbW9iaWxlbWF0Y2hbIDEgXTsKCglpZiAoCgkJLy8gaU9TIDQuMyBhbmQgb2xkZXIgOiBQbGF0Zm9ybSBpcyBpUGhvbmUvUGFkL1RvdWNoIGFuZCBXZWJraXQgdmVyc2lvbiBpcyBsZXNzIHRoYW4gNTM0IChpb3M1KQoJCSggKCBwbGF0Zm9ybS5pbmRleE9mKCAiaVBob25lIiApID4gLTEgfHwgcGxhdGZvcm0uaW5kZXhPZiggImlQYWQiICkgPiAtMSAgfHwgcGxhdGZvcm0uaW5kZXhPZiggImlQb2QiICkgPiAtMSApICYmIHdrdmVyc2lvbiAmJiB3a3ZlcnNpb24gPCA1MzQgKSB8fAoJCS8vIE9wZXJhIE1pbmkKCQkoIHcub3BlcmFtaW5pICYmICh7fSkudG9TdHJpbmcuY2FsbCggdy5vcGVyYW1pbmkgKSA9PT0gIltvYmplY3QgT3BlcmFNaW5pXSIgKSB8fAoJCSggb3BlcmFtbW9iaWxlbWF0Y2ggJiYgb212ZXJzaW9uIDwgNzQ1OCApCXx8CgkJLy9BbmRyb2lkIGx0ZSAyLjE6IFBsYXRmb3JtIGlzIEFuZHJvaWQgYW5kIFdlYmtpdCB2ZXJzaW9uIGlzIGxlc3MgdGhhbiA1MzMgKEFuZHJvaWQgMi4yKQoJCSggdWEuaW5kZXhPZiggIkFuZHJvaWQiICkgPiAtMSAmJiB3a3ZlcnNpb24gJiYgd2t2ZXJzaW9uIDwgNTMzICkgfHwKCQkvLyBGaXJlZm94IE1vYmlsZSBiZWZvcmUgNi4wIC0KCQkoIGZmdmVyc2lvbiAmJiBmZnZlcnNpb24gPCA2ICkgfHwKCQkvLyBXZWJPUyBsZXNzIHRoYW4gMwoJCSggInBhbG1HZXRSZXNvdXJjZSIgaW4gd2luZG93ICYmIHdrdmVyc2lvbiAmJiB3a3ZlcnNpb24gPCA1MzQgKQl8fAoJCS8vIE1lZUdvCgkJKCB1YS5pbmRleE9mKCAiTWVlR28iICkgPiAtMSAmJiB1YS5pbmRleE9mKCAiTm9raWFCcm93c2VyLzguNS4wIiApID4gLTEgKSApIHsKCQlyZXR1cm4gZmFsc2U7Cgl9CgoJcmV0dXJuIHRydWU7Cn0KCiQuZXh0ZW5kKCAkLnN1cHBvcnQsIHsKCWNzc1RyYW5zaXRpb25zOiAiV2ViS2l0VHJhbnNpdGlvbkV2ZW50IiBpbiB3aW5kb3cgfHwKCQl2YWxpZFN0eWxlKCAidHJhbnNpdGlvbiIsICJoZWlnaHQgMTAwbXMgbGluZWFyIiwgWyAiV2Via2l0IiwgIk1veiIsICIiIF0gKSAmJgoJCSEkLm1vYmlsZS5icm93c2VyLm9sZElFICYmICFvcGVyYSwKCgkvLyBOb3RlLCBDaHJvbWUgZm9yIGlPUyBoYXMgYW4gZXh0cmVtZWx5IHF1aXJreSBpbXBsZW1lbnRhdGlvbiBvZiBwb3BzdGF0ZS4KCS8vIFdlJ3ZlIGNob3NlbiB0byB0YWtlIHRoZSBzaG9ydGVzdCBwYXRoIHRvIGEgYnVnIGZpeCBoZXJlIGZvciBpc3N1ZSAjNTQyNgoJLy8gU2VlIHRoZSBmb2xsb3dpbmcgbGluayBmb3IgaW5mb3JtYXRpb24gYWJvdXQgdGhlIHJlZ2V4IGNob3NlbgoJLy8gaHR0cHM6Ly9kZXZlbG9wZXJzLmdvb2dsZS5jb20vY2hyb21lL21vYmlsZS9kb2NzL3VzZXItYWdlbnQjY2hyb21lX2Zvcl9pb3NfdXNlci1hZ2VudAoJcHVzaFN0YXRlOiAicHVzaFN0YXRlIiBpbiBoaXN0b3J5ICYmCgkJInJlcGxhY2VTdGF0ZSIgaW4gaGlzdG9yeSAmJgoJCS8vIFdoZW4gcnVubmluZyBpbnNpZGUgYSBGRiBpZnJhbWUsIGNhbGxpbmcgcmVwbGFjZVN0YXRlIGNhdXNlcyBhbiBlcnJvcgoJCSEoIHdpbmRvdy5uYXZpZ2F0b3IudXNlckFnZW50LmluZGV4T2YoICJGaXJlZm94IiApID49IDAgJiYgd2luZG93LnRvcCAhPT0gd2luZG93ICkgJiYKCQkoIHdpbmRvdy5uYXZpZ2F0b3IudXNlckFnZW50LnNlYXJjaCgvQ3JpT1MvKSA9PT0gLTEgKSwKCgltZWRpYXF1ZXJ5OiAkLm1vYmlsZS5tZWRpYSggIm9ubHkgYWxsIiApLAoJY3NzUHNldWRvRWxlbWVudDogISFwcm9wRXhpc3RzKCAiY29udGVudCIgKSwKCXRvdWNoT3ZlcmZsb3c6ICEhcHJvcEV4aXN0cyggIm92ZXJmbG93U2Nyb2xsaW5nIiApLAoJY3NzVHJhbnNmb3JtM2Q6IHRyYW5zZm9ybTNkVGVzdCgpLAoJY3NzQW5pbWF0aW9uczogISFwcm9wRXhpc3RzKCAiYW5pbWF0aW9uTmFtZSIgKSwKCWJveFNoYWRvdzogISFwcm9wRXhpc3RzKCAiYm94U2hhZG93IiApICYmICFiYiwKCWZpeGVkUG9zaXRpb246IGZpeGVkUG9zaXRpb24oKSwKCXNjcm9sbFRvcDogKCJwYWdlWE9mZnNldCIgaW4gd2luZG93IHx8CgkJInNjcm9sbFRvcCIgaW4gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50IHx8CgkJInNjcm9sbFRvcCIgaW4gZmFrZUJvZHlbIDAgXSkgJiYgIXdlYm9zICYmICFvcGVyYW1pbmksCgoJZHluYW1pY0Jhc2VUYWc6IGJhc2VUYWdUZXN0KCksCgljc3NQb2ludGVyRXZlbnRzOiBjc3NQb2ludGVyRXZlbnRzVGVzdCgpLAoJYm91bmRpbmdSZWN0OiBib3VuZGluZ1JlY3QoKSwKCWlubGluZVNWRzogaW5saW5lU1ZHCn0pOwoKZmFrZUJvZHkucmVtb3ZlKCk7CgoKLy8gJC5tb2JpbGUuYWpheEJsYWNrbGlzdCBpcyB1c2VkIHRvIG92ZXJyaWRlIGFqYXhFbmFibGVkIG9uIHBsYXRmb3JtcyB0aGF0IGhhdmUga25vd24gY29uZmxpY3RzIHdpdGggaGFzaCBoaXN0b3J5IHVwZGF0ZXMgKEJCNSwgU3ltYmlhbikKLy8gb3IgdGhhdCBnZW5lcmFsbHkgd29yayBiZXR0ZXIgYnJvd3NpbmcgaW4gcmVndWxhciBodHRwIGZvciBmdWxsIHBhZ2UgcmVmcmVzaGVzIChPcGVyYSBNaW5pKQovLyBOb3RlOiBUaGlzIGRldGVjdGlvbiBiZWxvdyBpcyB1c2VkIGFzIGEgbGFzdCByZXNvcnQuCi8vIFdlIHJlY29tbWVuZCBvbmx5IHVzaW5nIHRoZXNlIGRldGVjdGlvbiBtZXRob2RzIHdoZW4gYWxsIG90aGVyIG1vcmUgcmVsaWFibGUvZm9yd2FyZC1sb29raW5nIGFwcHJvYWNoZXMgYXJlIG5vdCBwb3NzaWJsZQpub2tpYUxURTdfMyA9IChmdW5jdGlvbigpIHsKCgl2YXIgdWEgPSB3aW5kb3cubmF2aWdhdG9yLnVzZXJBZ2VudDsKCgkvL1RoZSBmb2xsb3dpbmcgaXMgYW4gYXR0ZW1wdCB0byBtYXRjaCBOb2tpYSBicm93c2VycyB0aGF0IGFyZSBydW5uaW5nIFN5bWJpYW4vczYwLCB3aXRoIHdlYmtpdCwgdmVyc2lvbiA3LjMgb3Igb2xkZXIKCXJldHVybiB1YS5pbmRleE9mKCAiTm9raWEiICkgPiAtMSAmJgoJCQkoIHVhLmluZGV4T2YoICJTeW1iaWFuLzMiICkgPiAtMSB8fCB1YS5pbmRleE9mKCAiU2VyaWVzNjAvNSIgKSA+IC0xICkgJiYKCQkJdWEuaW5kZXhPZiggIkFwcGxlV2ViS2l0IiApID4gLTEgJiYKCQkJdWEubWF0Y2goIC8oQnJvd3Nlck5HfE5va2lhQnJvd3NlcilcLzdcLlswLTNdLyApOwp9KSgpOwoKLy8gU3VwcG9ydCBjb25kaXRpb25zIHRoYXQgbXVzdCBiZSBtZXQgaW4gb3JkZXIgdG8gcHJvY2VlZAovLyBkZWZhdWx0IGVuaGFuY2VkIHF1YWxpZmljYXRpb25zIGFyZSBtZWRpYSBxdWVyeSBzdXBwb3J0IE9SIElFIDcrCgokLm1vYmlsZS5ncmFkZUEgPSBmdW5jdGlvbigpIHsKCXJldHVybiAoICggJC5zdXBwb3J0Lm1lZGlhcXVlcnkgJiYgJC5zdXBwb3J0LmNzc1BzZXVkb0VsZW1lbnQgKSB8fCAkLm1vYmlsZS5icm93c2VyLm9sZElFICYmICQubW9iaWxlLmJyb3dzZXIub2xkSUUgPj0gOCApICYmICggJC5zdXBwb3J0LmJvdW5kaW5nUmVjdCB8fCAkLmZuLmpxdWVyeS5tYXRjaCgvMVwuWzAtNytdXC5bMC05K10/LykgIT09IG51bGwgKTsKfTsKCiQubW9iaWxlLmFqYXhCbGFja2xpc3QgPQoJCQkvLyBCbGFja0JlcnJ5IGJyb3dzZXJzLCBwcmUtd2Via2l0CgkJCXdpbmRvdy5ibGFja2JlcnJ5ICYmICF3aW5kb3cuV2ViS2l0UG9pbnQgfHwKCQkJLy8gT3BlcmEgTWluaQoJCQlvcGVyYW1pbmkgfHwKCQkJLy8gU3ltYmlhbiB3ZWJraXRzIHByZSA3LjMKCQkJbm9raWFMVEU3XzM7CgovLyBMYXN0bHksIHRoaXMgd29ya2Fyb3VuZCBpcyB0aGUgb25seSB3YXkgd2UndmUgZm91bmQgc28gZmFyIHRvIGdldCBwcmUgNy4zIFN5bWJpYW4gd2Via2l0IGRldmljZXMKLy8gdG8gcmVuZGVyIHRoZSBzdHlsZXNoZWV0cyB3aGVuIHRoZXkncmUgcmVmZXJlbmNlZCBiZWZvcmUgdGhpcyBzY3JpcHQsIGFzIHdlJ2QgcmVjb21tZW5kIGRvaW5nLgovLyBUaGlzIHNpbXBseSByZWFwcGVuZHMgdGhlIENTUyBpbiBwbGFjZSwgd2hpY2ggZm9yIHNvbWUgcmVhc29uIG1ha2VzIGl0IGFwcGx5CmlmICggbm9raWFMVEU3XzMgKSB7CgkkKGZ1bmN0aW9uKCkgewoJCSQoICJoZWFkIGxpbmtbcmVsPSdzdHlsZXNoZWV0J10iICkuYXR0ciggInJlbCIsICJhbHRlcm5hdGUgc3R5bGVzaGVldCIgKS5hdHRyKCAicmVsIiwgInN0eWxlc2hlZXQiICk7Cgl9KTsKfQoKLy8gRm9yIHJ1bGluZyBvdXQgc2hhZG93cyB2aWEgY3NzCmlmICggISQuc3VwcG9ydC5ib3hTaGFkb3cgKSB7CgkkKCAiaHRtbCIgKS5hZGRDbGFzcyggInVpLW5vYm94c2hhZG93IiApOwp9Cgp9KSggalF1ZXJ5ICk7CgoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7Cgl2YXIgJHdpbiA9ICQubW9iaWxlLndpbmRvdywgc2VsZiwKCQlkdW1teUZuVG9Jbml0TmF2aWdhdGUgPSBmdW5jdGlvbigpIHsKCQl9OwoKCSQuZXZlbnQuc3BlY2lhbC5iZWZvcmVuYXZpZ2F0ZSA9IHsKCQlzZXR1cDogZnVuY3Rpb24oKSB7CgkJCSR3aW4ub24oICJuYXZpZ2F0ZSIsIGR1bW15Rm5Ub0luaXROYXZpZ2F0ZSApOwoJCX0sCgoJCXRlYXJkb3duOiBmdW5jdGlvbigpIHsKCQkJJHdpbi5vZmYoICJuYXZpZ2F0ZSIsIGR1bW15Rm5Ub0luaXROYXZpZ2F0ZSApOwoJCX0KCX07CgoJJC5ldmVudC5zcGVjaWFsLm5hdmlnYXRlID0gc2VsZiA9IHsKCQlib3VuZDogZmFsc2UsCgoJCXB1c2hTdGF0ZUVuYWJsZWQ6IHRydWUsCgoJCW9yaWdpbmFsRXZlbnROYW1lOiB1bmRlZmluZWQsCgoJCS8vIElmIHB1c2hzdGF0ZSBzdXBwb3J0IGlzIHByZXNlbnQgYW5kIHB1c2ggc3RhdGUgc3VwcG9ydCBpcyBkZWZpbmVkIHRvCgkJLy8gYmUgdHJ1ZSBvbiB0aGUgbW9iaWxlIG5hbWVzcGFjZS4KCQlpc1B1c2hTdGF0ZUVuYWJsZWQ6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gJC5zdXBwb3J0LnB1c2hTdGF0ZSAmJgoJCQkJJC5tb2JpbGUucHVzaFN0YXRlRW5hYmxlZCA9PT0gdHJ1ZSAmJgoJCQkJdGhpcy5pc0hhc2hDaGFuZ2VFbmFibGVkKCk7CgkJfSwKCgkJLy8gISEgYXNzdW1lcyBtb2JpbGUgbmFtZXNwYWNlIGlzIHByZXNlbnQKCQlpc0hhc2hDaGFuZ2VFbmFibGVkOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuICQubW9iaWxlLmhhc2hMaXN0ZW5pbmdFbmFibGVkID09PSB0cnVlOwoJCX0sCgoJCS8vIFRPRE8gYSBsb3Qgb2YgZHVwbGljYXRpb24gYmV0d2VlbiBwb3BzdGF0ZSBhbmQgaGFzaGNoYW5nZQoJCXBvcHN0YXRlOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciBuZXdFdmVudCA9IG5ldyAkLkV2ZW50KCAibmF2aWdhdGUiICksCgkJCQliZWZvcmVOYXZpZ2F0ZSA9IG5ldyAkLkV2ZW50KCAiYmVmb3JlbmF2aWdhdGUiICksCgkJCQlzdGF0ZSA9IGV2ZW50Lm9yaWdpbmFsRXZlbnQuc3RhdGUgfHwge307CgoJCQliZWZvcmVOYXZpZ2F0ZS5vcmlnaW5hbEV2ZW50ID0gZXZlbnQ7CgkJCSR3aW4udHJpZ2dlciggYmVmb3JlTmF2aWdhdGUgKTsKCgkJCWlmICggYmVmb3JlTmF2aWdhdGUuaXNEZWZhdWx0UHJldmVudGVkKCkgKXsKCQkJCXJldHVybjsKCQkJfQoKCQkJaWYgKCBldmVudC5oaXN0b3J5U3RhdGUgKXsKCQkJCSQuZXh0ZW5kKHN0YXRlLCBldmVudC5oaXN0b3J5U3RhdGUpOwoJCQl9CgoJCQkvLyBNYWtlIHN1cmUgdGhlIG9yaWdpbmFsIGV2ZW50IGlzIHRyYWNrZWQgZm9yIHRoZSBlbmQKCQkJLy8gdXNlciB0byBpbnNwZWN0IGluY2FzZSB0aGV5IHdhbnQgdG8gZG8gc29tZXRoaW5nIHNwZWNpYWwKCQkJbmV3RXZlbnQub3JpZ2luYWxFdmVudCA9IGV2ZW50OwoKCQkJLy8gTk9URSB3ZSBsZXQgdGhlIGN1cnJlbnQgc3RhY2sgdW53aW5kIGJlY2F1c2UgYW55IGFzc2lnbm1lbnQgdG8KCQkJLy8gICAgICBsb2NhdGlvbi5oYXNoIHdpbGwgc3RvcCB0aGUgd29ybGQgYW5kIHJ1biB0aGlzIGV2ZW50IGhhbmRsZXIuIEJ5CgkJCS8vICAgICAgZG9pbmcgdGhpcyB3ZSBjcmVhdGUgYSBzaW1pbGFyIGJlaGF2aW9yIHRvIGhhc2hjaGFuZ2Ugb24gaGFzaAoJCQkvLyAgICAgIGFzc2lnbm1lbnQKCQkJc2V0VGltZW91dChmdW5jdGlvbigpIHsKCQkJCSR3aW4udHJpZ2dlciggbmV3RXZlbnQsIHsKCQkJCQlzdGF0ZTogc3RhdGUKCQkJCX0pOwoJCQl9LCAwKTsKCQl9LAoKCQloYXNoY2hhbmdlOiBmdW5jdGlvbiggZXZlbnQgLyosIGRhdGEgKi8gKSB7CgkJCXZhciBuZXdFdmVudCA9IG5ldyAkLkV2ZW50KCAibmF2aWdhdGUiICksCgkJCQliZWZvcmVOYXZpZ2F0ZSA9IG5ldyAkLkV2ZW50KCAiYmVmb3JlbmF2aWdhdGUiICk7CgoJCQliZWZvcmVOYXZpZ2F0ZS5vcmlnaW5hbEV2ZW50ID0gZXZlbnQ7CgkJCSR3aW4udHJpZ2dlciggYmVmb3JlTmF2aWdhdGUgKTsKCgkJCWlmICggYmVmb3JlTmF2aWdhdGUuaXNEZWZhdWx0UHJldmVudGVkKCkgKXsKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gTWFrZSBzdXJlIHRoZSBvcmlnaW5hbCBldmVudCBpcyB0cmFja2VkIGZvciB0aGUgZW5kCgkJCS8vIHVzZXIgdG8gaW5zcGVjdCBpbmNhc2UgdGhleSB3YW50IHRvIGRvIHNvbWV0aGluZyBzcGVjaWFsCgkJCW5ld0V2ZW50Lm9yaWdpbmFsRXZlbnQgPSBldmVudDsKCgkJCS8vIFRyaWdnZXIgdGhlIGhhc2hjaGFuZ2Ugd2l0aCBzdGF0ZSBwcm92aWRlZCBieSB0aGUgdXNlcgoJCQkvLyB0aGF0IGFsdGVyZWQgdGhlIGhhc2gKCQkJJHdpbi50cmlnZ2VyKCBuZXdFdmVudCwgewoJCQkJLy8gVXNlcnMgdGhhdCB3YW50IHRvIGZ1bGx5IG5vcm1hbGl6ZSB0aGUgdHdvIGV2ZW50cwoJCQkJLy8gd2lsbCBuZWVkIHRvIGRvIGhpc3RvcnkgbWFuYWdlbWVudCBkb3duIHRoZSBzdGFjayBhbmQKCQkJCS8vIGFkZCB0aGUgc3RhdGUgdG8gdGhlIGV2ZW50IGJlZm9yZSB0aGlzIGJpbmRpbmcgaXMgZmlyZWQKCQkJCS8vIFRPRE8gY29uc2lkZXIgYWxsb3dpbmcgZm9yIHRoZSBleHBsaWNpdCBhZGRpdGlvbiBvZiBjYWxsYmFja3MKCQkJCS8vICAgICAgdG8gYmUgZmlyZWQgYmVmb3JlIHRoaXMgdmFsdWUgaXMgc2V0IHRvIGF2b2lkIGV2ZW50IHRpbWluZyBpc3N1ZXMKCQkJCXN0YXRlOiBldmVudC5oYXNoY2hhbmdlU3RhdGUgfHwge30KCQkJfSk7CgkJfSwKCgkJLy8gVE9ETyBXZSByZWFsbHkgb25seSB3YW50IHRvIHNldCB0aGlzIHVwIG9uY2UKCQkvLyAgICAgIGJ1dCBJJ20gbm90IGNsZWFyIGlmIHRoZXJlJ3MgYSBiZXRlciB3YXkgdG8gYWNoaWV2ZQoJCS8vICAgICAgdGhpcyB3aXRoIHRoZSBqUXVlcnkgc3BlY2lhbCBldmVudCBzdHJ1Y3R1cmUKCQlzZXR1cDogZnVuY3Rpb24oIC8qIGRhdGEsIG5hbWVzcGFjZXMgKi8gKSB7CgkJCWlmICggc2VsZi5ib3VuZCApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJc2VsZi5ib3VuZCA9IHRydWU7CgoJCQlpZiAoIHNlbGYuaXNQdXNoU3RhdGVFbmFibGVkKCkgKSB7CgkJCQlzZWxmLm9yaWdpbmFsRXZlbnROYW1lID0gInBvcHN0YXRlIjsKCQkJCSR3aW4uYmluZCggInBvcHN0YXRlLm5hdmlnYXRlIiwgc2VsZi5wb3BzdGF0ZSApOwoJCQl9IGVsc2UgaWYgKCBzZWxmLmlzSGFzaENoYW5nZUVuYWJsZWQoKSApewoJCQkJc2VsZi5vcmlnaW5hbEV2ZW50TmFtZSA9ICJoYXNoY2hhbmdlIjsKCQkJCSR3aW4uYmluZCggImhhc2hjaGFuZ2UubmF2aWdhdGUiLCBzZWxmLmhhc2hjaGFuZ2UgKTsKCQkJfQoJCX0KCX07Cn0pKCBqUXVlcnkgKTsKCgoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgkJdmFyIHBhdGgsICRiYXNlLCBkaWFsb2dIYXNoS2V5ID0gIiZ1aS1zdGF0ZT1kaWFsb2ciOwoKCQkkLm1vYmlsZS5wYXRoID0gcGF0aCA9IHsKCQkJdWlTdGF0ZUtleTogIiZ1aS1zdGF0ZSIsCgoJCQkvLyBUaGlzIHNjYXJ5IGxvb2tpbmcgcmVndWxhciBleHByZXNzaW9uIHBhcnNlcyBhbiBhYnNvbHV0ZSBVUkwgb3IgaXRzIHJlbGF0aXZlCgkJCS8vIHZhcmlhbnRzIChwcm90b2NvbCwgc2l0ZSwgZG9jdW1lbnQsIHF1ZXJ5LCBhbmQgaGFzaCksIGludG8gdGhlIHZhcmlvdXMKCQkJLy8gY29tcG9uZW50cyAocHJvdG9jb2wsIGhvc3QsIHBhdGgsIHF1ZXJ5LCBmcmFnbWVudCwgZXRjIHRoYXQgbWFrZSB1cCB0aGUKCQkJLy8gVVJMIGFzIHdlbGwgYXMgc29tZSBvdGhlciBjb21tb25seSB1c2VkIHN1Yi1wYXJ0cy4gV2hlbiB1c2VkIHdpdGggUmVnRXhwLmV4ZWMoKQoJCQkvLyBvciBTdHJpbmcubWF0Y2gsIGl0IHBhcnNlcyB0aGUgVVJMIGludG8gYSByZXN1bHRzIGFycmF5IHRoYXQgbG9va3MgbGlrZSB0aGlzOgoJCQkvLwoJCQkvLyAgICAgWzBdOiBodHRwOi8vamJsYXM6cGFzc3dvcmRAbXljb21wYW55LmNvbTo4MDgwL21haWwvaW5ib3g/bXNnPTEyMzQmdHlwZT11bnJlYWQjbXNnLWNvbnRlbnQKCQkJLy8gICAgIFsxXTogaHR0cDovL2pibGFzOnBhc3N3b3JkQG15Y29tcGFueS5jb206ODA4MC9tYWlsL2luYm94P21zZz0xMjM0JnR5cGU9dW5yZWFkCgkJCS8vICAgICBbMl06IGh0dHA6Ly9qYmxhczpwYXNzd29yZEBteWNvbXBhbnkuY29tOjgwODAvbWFpbC9pbmJveAoJCQkvLyAgICAgWzNdOiBodHRwOi8vamJsYXM6cGFzc3dvcmRAbXljb21wYW55LmNvbTo4MDgwCgkJCS8vICAgICBbNF06IGh0dHA6CgkJCS8vICAgICBbNV06IC8vCgkJCS8vICAgICBbNl06IGpibGFzOnBhc3N3b3JkQG15Y29tcGFueS5jb206ODA4MAoJCQkvLyAgICAgWzddOiBqYmxhczpwYXNzd29yZAoJCQkvLyAgICAgWzhdOiBqYmxhcwoJCQkvLyAgICAgWzldOiBwYXNzd29yZAoJCQkvLyAgICBbMTBdOiBteWNvbXBhbnkuY29tOjgwODAKCQkJLy8gICAgWzExXTogbXljb21wYW55LmNvbQoJCQkvLyAgICBbMTJdOiA4MDgwCgkJCS8vICAgIFsxM106IC9tYWlsL2luYm94CgkJCS8vICAgIFsxNF06IC9tYWlsLwoJCQkvLyAgICBbMTVdOiBpbmJveAoJCQkvLyAgICBbMTZdOiA/bXNnPTEyMzQmdHlwZT11bnJlYWQKCQkJLy8gICAgWzE3XTogI21zZy1jb250ZW50CgkJCS8vCgkJCXVybFBhcnNlUkU6IC9eXHMqKCgoKFteOlwvI1w/XSs6KT8oPzooXC9cLykoKD86KChbXjpAXC8jXD9dKykoPzpcOihbXjpAXC8jXD9dKykpPylAKT8oKFteOlwvI1w/XF1cW10rfFxbW15cL1xdQCM/XStcXSkoPzpcOihbMC05XSspKT8pKT8pPyk/KChcLz8oPzpbXlwvXD8jXStcLyspKikoW15cPyNdKikpKT8oXD9bXiNdKyk/KSgjLiopPy8sCgoJCQkvLyBBYnN0cmFjdGlvbiB0byBhZGRyZXNzIHhzcyAoSXNzdWUgIzQ3ODcpIGJ5IHJlbW92aW5nIHRoZSBhdXRob3JpdHkgaW4KCQkJLy8gYnJvd3NlcnMgdGhhdCBhdXRvCWRlY29kZSBpdC4gQWxsIHJlZmVyZW5jZXMgdG8gbG9jYXRpb24uaHJlZiBzaG91bGQgYmUKCQkJLy8gcmVwbGFjZWQgd2l0aCBhIGNhbGwgdG8gdGhpcyBtZXRob2Qgc28gdGhhdCBpdCBjYW4gYmUgZGVhbHQgd2l0aCBwcm9wZXJseSBoZXJlCgkJCWdldExvY2F0aW9uOiBmdW5jdGlvbiggdXJsICkgewoJCQkJdmFyIHVyaSA9IHVybCA/IHRoaXMucGFyc2VVcmwoIHVybCApIDogbG9jYXRpb24sCgkJCQkJaGFzaCA9IHRoaXMucGFyc2VVcmwoIHVybCB8fCBsb2NhdGlvbi5ocmVmICkuaGFzaDsKCgkJCQkvLyBtaW1pYyB0aGUgYnJvd3NlciB3aXRoIGFuIGVtcHR5IHN0cmluZyB3aGVuIHRoZSBoYXNoIGlzIGVtcHR5CgkJCQloYXNoID0gaGFzaCA9PT0gIiMiID8gIiIgOiBoYXNoOwoKCQkJCS8vIE1ha2Ugc3VyZSB0byBwYXJzZSB0aGUgdXJsIG9yIHRoZSBsb2NhdGlvbiBvYmplY3QgZm9yIHRoZSBoYXNoIGJlY2F1c2UgdXNpbmcgbG9jYXRpb24uaGFzaAoJCQkJLy8gaXMgYXV0b2RlY29kZWQgaW4gZmlyZWZveCwgdGhlIHJlc3Qgb2YgdGhlIHVybCBzaG91bGQgYmUgZnJvbSB0aGUgb2JqZWN0IChsb2NhdGlvbiB1bmxlc3MKCQkJCS8vIHdlJ3JlIHRlc3RpbmcpIHRvIGF2b2lkIHRoZSBpbmNsdXNpb24gb2YgdGhlIGF1dGhvcml0eQoJCQkJcmV0dXJuIHVyaS5wcm90b2NvbCArICIvLyIgKyB1cmkuaG9zdCArIHVyaS5wYXRobmFtZSArIHVyaS5zZWFyY2ggKyBoYXNoOwoJCQl9LAoKCQkJLy9yZXR1cm4gdGhlIG9yaWdpbmFsIGRvY3VtZW50IHVybAoJCQlnZXREb2N1bWVudFVybDogZnVuY3Rpb24oIGFzUGFyc2VkT2JqZWN0ICkgewoJCQkJcmV0dXJuIGFzUGFyc2VkT2JqZWN0ID8gJC5leHRlbmQoIHt9LCBwYXRoLmRvY3VtZW50VXJsICkgOiBwYXRoLmRvY3VtZW50VXJsLmhyZWY7CgkJCX0sCgoJCQlwYXJzZUxvY2F0aW9uOiBmdW5jdGlvbigpIHsKCQkJCXJldHVybiB0aGlzLnBhcnNlVXJsKCB0aGlzLmdldExvY2F0aW9uKCkgKTsKCQkJfSwKCgkJCS8vUGFyc2UgYSBVUkwgaW50byBhIHN0cnVjdHVyZSB0aGF0IGFsbG93cyBlYXN5IGFjY2VzcyB0bwoJCQkvL2FsbCBvZiB0aGUgVVJMIGNvbXBvbmVudHMgYnkgbmFtZS4KCQkJcGFyc2VVcmw6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQkvLyBJZiB3ZSdyZSBwYXNzZWQgYW4gb2JqZWN0LCB3ZSdsbCBhc3N1bWUgdGhhdCBpdCBpcwoJCQkJLy8gYSBwYXJzZWQgdXJsIG9iamVjdCBhbmQganVzdCByZXR1cm4gaXQgYmFjayB0byB0aGUgY2FsbGVyLgoJCQkJaWYgKCAkLnR5cGUoIHVybCApID09PSAib2JqZWN0IiApIHsKCQkJCQlyZXR1cm4gdXJsOwoJCQkJfQoKCQkJCXZhciBtYXRjaGVzID0gcGF0aC51cmxQYXJzZVJFLmV4ZWMoIHVybCB8fCAiIiApIHx8IFtdOwoKCQkJCQkvLyBDcmVhdGUgYW4gb2JqZWN0IHRoYXQgYWxsb3dzIHRoZSBjYWxsZXIgdG8gYWNjZXNzIHRoZSBzdWItbWF0Y2hlcwoJCQkJCS8vIGJ5IG5hbWUuIE5vdGUgdGhhdCBJRSByZXR1cm5zIGFuIGVtcHR5IHN0cmluZyBpbnN0ZWFkIG9mIHVuZGVmaW5lZCwKCQkJCQkvLyBsaWtlIGFsbCBvdGhlciBicm93c2VycyBkbywgc28gd2Ugbm9ybWFsaXplIGV2ZXJ5dGhpbmcgc28gaXRzIGNvbnNpc3RlbnQKCQkJCQkvLyBubyBtYXR0ZXIgd2hhdCBicm93c2VyIHdlJ3JlIHJ1bm5pbmcgb24uCgkJCQkJcmV0dXJuIHsKCQkJCQkJaHJlZjogICAgICAgICBtYXRjaGVzWyAgMCBdIHx8ICIiLAoJCQkJCQlocmVmTm9IYXNoOiAgIG1hdGNoZXNbICAxIF0gfHwgIiIsCgkJCQkJCWhyZWZOb1NlYXJjaDogbWF0Y2hlc1sgIDIgXSB8fCAiIiwKCQkJCQkJZG9tYWluOiAgICAgICBtYXRjaGVzWyAgMyBdIHx8ICIiLAoJCQkJCQlwcm90b2NvbDogICAgIG1hdGNoZXNbICA0IF0gfHwgIiIsCgkJCQkJCWRvdWJsZVNsYXNoOiAgbWF0Y2hlc1sgIDUgXSB8fCAiIiwKCQkJCQkJYXV0aG9yaXR5OiAgICBtYXRjaGVzWyAgNiBdIHx8ICIiLAoJCQkJCQl1c2VybmFtZTogICAgIG1hdGNoZXNbICA4IF0gfHwgIiIsCgkJCQkJCXBhc3N3b3JkOiAgICAgbWF0Y2hlc1sgIDkgXSB8fCAiIiwKCQkJCQkJaG9zdDogICAgICAgICBtYXRjaGVzWyAxMCBdIHx8ICIiLAoJCQkJCQlob3N0bmFtZTogICAgIG1hdGNoZXNbIDExIF0gfHwgIiIsCgkJCQkJCXBvcnQ6ICAgICAgICAgbWF0Y2hlc1sgMTIgXSB8fCAiIiwKCQkJCQkJcGF0aG5hbWU6ICAgICBtYXRjaGVzWyAxMyBdIHx8ICIiLAoJCQkJCQlkaXJlY3Rvcnk6ICAgIG1hdGNoZXNbIDE0IF0gfHwgIiIsCgkJCQkJCWZpbGVuYW1lOiAgICAgbWF0Y2hlc1sgMTUgXSB8fCAiIiwKCQkJCQkJc2VhcmNoOiAgICAgICBtYXRjaGVzWyAxNiBdIHx8ICIiLAoJCQkJCQloYXNoOiAgICAgICAgIG1hdGNoZXNbIDE3IF0gfHwgIiIKCQkJCQl9OwoJCQl9LAoKCQkJLy9UdXJuIHJlbFBhdGggaW50byBhbiBhc2JvbHV0ZSBwYXRoLiBhYnNQYXRoIGlzCgkJCS8vYW4gb3B0aW9uYWwgYWJzb2x1dGUgcGF0aCB3aGljaCBkZXNjcmliZXMgd2hhdAoJCQkvL3JlbFBhdGggaXMgcmVsYXRpdmUgdG8uCgkJCW1ha2VQYXRoQWJzb2x1dGU6IGZ1bmN0aW9uKCByZWxQYXRoLCBhYnNQYXRoICkgewoJCQkJdmFyIGFic1N0YWNrLAoJCQkJCXJlbFN0YWNrLAoJCQkJCWksIGQ7CgoJCQkJaWYgKCByZWxQYXRoICYmIHJlbFBhdGguY2hhckF0KCAwICkgPT09ICIvIiApIHsKCQkJCQlyZXR1cm4gcmVsUGF0aDsKCQkJCX0KCgkJCQlyZWxQYXRoID0gcmVsUGF0aCB8fCAiIjsKCQkJCWFic1BhdGggPSBhYnNQYXRoID8gYWJzUGF0aC5yZXBsYWNlKCAvXlwvfChcL1teXC9dKnxbXlwvXSspJC9nLCAiIiApIDogIiI7CgoJCQkJYWJzU3RhY2sgPSBhYnNQYXRoID8gYWJzUGF0aC5zcGxpdCggIi8iICkgOiBbXTsKCQkJCXJlbFN0YWNrID0gcmVsUGF0aC5zcGxpdCggIi8iICk7CgoJCQkJZm9yICggaSA9IDA7IGkgPCByZWxTdGFjay5sZW5ndGg7IGkrKyApIHsKCQkJCQlkID0gcmVsU3RhY2tbIGkgXTsKCQkJCQlzd2l0Y2ggKCBkICkgewoJCQkJCQljYXNlICIuIjoKCQkJCQkJCWJyZWFrOwoJCQkJCQljYXNlICIuLiI6CgkJCQkJCQlpZiAoIGFic1N0YWNrLmxlbmd0aCApIHsKCQkJCQkJCQlhYnNTdGFjay5wb3AoKTsKCQkJCQkJCX0KCQkJCQkJCWJyZWFrOwoJCQkJCQlkZWZhdWx0OgoJCQkJCQkJYWJzU3RhY2sucHVzaCggZCApOwoJCQkJCQkJYnJlYWs7CgkJCQkJfQoJCQkJfQoJCQkJcmV0dXJuICIvIiArIGFic1N0YWNrLmpvaW4oICIvIiApOwoJCQl9LAoKCQkJLy9SZXR1cm5zIHRydWUgaWYgYm90aCB1cmxzIGhhdmUgdGhlIHNhbWUgZG9tYWluLgoJCQlpc1NhbWVEb21haW46IGZ1bmN0aW9uKCBhYnNVcmwxLCBhYnNVcmwyICkgewoJCQkJcmV0dXJuIHBhdGgucGFyc2VVcmwoIGFic1VybDEgKS5kb21haW4gPT09IHBhdGgucGFyc2VVcmwoIGFic1VybDIgKS5kb21haW47CgkJCX0sCgoJCQkvL1JldHVybnMgdHJ1ZSBmb3IgYW55IHJlbGF0aXZlIHZhcmlhbnQuCgkJCWlzUmVsYXRpdmVVcmw6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQkvLyBBbGwgcmVsYXRpdmUgVXJsIHZhcmlhbnRzIGhhdmUgb25lIHRoaW5nIGluIGNvbW1vbiwgbm8gcHJvdG9jb2wuCgkJCQlyZXR1cm4gcGF0aC5wYXJzZVVybCggdXJsICkucHJvdG9jb2wgPT09ICIiOwoJCQl9LAoKCQkJLy9SZXR1cm5zIHRydWUgZm9yIGFuIGFic29sdXRlIHVybC4KCQkJaXNBYnNvbHV0ZVVybDogZnVuY3Rpb24oIHVybCApIHsKCQkJCXJldHVybiBwYXRoLnBhcnNlVXJsKCB1cmwgKS5wcm90b2NvbCAhPT0gIiI7CgkJCX0sCgoJCQkvL1R1cm4gdGhlIHNwZWNpZmllZCByZWFsdGl2ZSBVUkwgaW50byBhbiBhYnNvbHV0ZSBvbmUuIFRoaXMgZnVuY3Rpb24KCQkJLy9jYW4gaGFuZGxlIGFsbCByZWxhdGl2ZSB2YXJpYW50cyAocHJvdG9jb2wsIHNpdGUsIGRvY3VtZW50LCBxdWVyeSwgZnJhZ21lbnQpLgoJCQltYWtlVXJsQWJzb2x1dGU6IGZ1bmN0aW9uKCByZWxVcmwsIGFic1VybCApIHsKCQkJCWlmICggIXBhdGguaXNSZWxhdGl2ZVVybCggcmVsVXJsICkgKSB7CgkJCQkJcmV0dXJuIHJlbFVybDsKCQkJCX0KCgkJCQlpZiAoIGFic1VybCA9PT0gdW5kZWZpbmVkICkgewoJCQkJCWFic1VybCA9IHRoaXMuZG9jdW1lbnRCYXNlOwoJCQkJfQoKCQkJCXZhciByZWxPYmogPSBwYXRoLnBhcnNlVXJsKCByZWxVcmwgKSwKCQkJCQlhYnNPYmogPSBwYXRoLnBhcnNlVXJsKCBhYnNVcmwgKSwKCQkJCQlwcm90b2NvbCA9IHJlbE9iai5wcm90b2NvbCB8fCBhYnNPYmoucHJvdG9jb2wsCgkJCQkJZG91YmxlU2xhc2ggPSByZWxPYmoucHJvdG9jb2wgPyByZWxPYmouZG91YmxlU2xhc2ggOiAoIHJlbE9iai5kb3VibGVTbGFzaCB8fCBhYnNPYmouZG91YmxlU2xhc2ggKSwKCQkJCQlhdXRob3JpdHkgPSByZWxPYmouYXV0aG9yaXR5IHx8IGFic09iai5hdXRob3JpdHksCgkJCQkJaGFzUGF0aCA9IHJlbE9iai5wYXRobmFtZSAhPT0gIiIsCgkJCQkJcGF0aG5hbWUgPSBwYXRoLm1ha2VQYXRoQWJzb2x1dGUoIHJlbE9iai5wYXRobmFtZSB8fCBhYnNPYmouZmlsZW5hbWUsIGFic09iai5wYXRobmFtZSApLAoJCQkJCXNlYXJjaCA9IHJlbE9iai5zZWFyY2ggfHwgKCAhaGFzUGF0aCAmJiBhYnNPYmouc2VhcmNoICkgfHwgIiIsCgkJCQkJaGFzaCA9IHJlbE9iai5oYXNoOwoKCQkJCXJldHVybiBwcm90b2NvbCArIGRvdWJsZVNsYXNoICsgYXV0aG9yaXR5ICsgcGF0aG5hbWUgKyBzZWFyY2ggKyBoYXNoOwoJCQl9LAoKCQkJLy9BZGQgc2VhcmNoIChha2EgcXVlcnkpIHBhcmFtcyB0byB0aGUgc3BlY2lmaWVkIHVybC4KCQkJYWRkU2VhcmNoUGFyYW1zOiBmdW5jdGlvbiggdXJsLCBwYXJhbXMgKSB7CgkJCQl2YXIgdSA9IHBhdGgucGFyc2VVcmwoIHVybCApLAoJCQkJCXAgPSAoIHR5cGVvZiBwYXJhbXMgPT09ICJvYmplY3QiICkgPyAkLnBhcmFtKCBwYXJhbXMgKSA6IHBhcmFtcywKCQkJCQlzID0gdS5zZWFyY2ggfHwgIj8iOwoJCQkJcmV0dXJuIHUuaHJlZk5vU2VhcmNoICsgcyArICggcy5jaGFyQXQoIHMubGVuZ3RoIC0gMSApICE9PSAiPyIgPyAiJiIgOiAiIiApICsgcCArICggdS5oYXNoIHx8ICIiICk7CgkJCX0sCgoJCQljb252ZXJ0VXJsVG9EYXRhVXJsOiBmdW5jdGlvbiggYWJzVXJsICkgewoJCQkJdmFyIHUgPSBwYXRoLnBhcnNlVXJsKCBhYnNVcmwgKTsKCQkJCWlmICggcGF0aC5pc0VtYmVkZGVkUGFnZSggdSApICkgewoJCQkJCS8vIEZvciBlbWJlZGRlZCBwYWdlcywgcmVtb3ZlIHRoZSBkaWFsb2cgaGFzaCBrZXkgYXMgaW4gZ2V0RmlsZVBhdGgoKSwKCQkJCQkvLyBhbmQgcmVtb3ZlIG90aGVyd2lzZSB0aGUgRGF0YSBVcmwgd29uJ3QgbWF0Y2ggdGhlIGlkIG9mIHRoZSBlbWJlZGRlZCBQYWdlLgoJCQkJCXJldHVybiB1Lmhhc2gKCQkJCQkJLnNwbGl0KCBkaWFsb2dIYXNoS2V5IClbMF0KCQkJCQkJLnJlcGxhY2UoIC9eIy8sICIiICkKCQkJCQkJLnJlcGxhY2UoIC9cPy4qJC8sICIiICk7CgkJCQl9IGVsc2UgaWYgKCBwYXRoLmlzU2FtZURvbWFpbiggdSwgdGhpcy5kb2N1bWVudEJhc2UgKSApIHsKCQkJCQlyZXR1cm4gdS5ocmVmTm9IYXNoLnJlcGxhY2UoIHRoaXMuZG9jdW1lbnRCYXNlLmRvbWFpbiwgIiIgKS5zcGxpdCggZGlhbG9nSGFzaEtleSApWzBdOwoJCQkJfQoKCQkJCXJldHVybiB3aW5kb3cuZGVjb2RlVVJJQ29tcG9uZW50KGFic1VybCk7CgkJCX0sCgoJCQkvL2dldCBwYXRoIGZyb20gY3VycmVudCBoYXNoLCBvciBmcm9tIGEgZmlsZSBwYXRoCgkJCWdldDogZnVuY3Rpb24oIG5ld1BhdGggKSB7CgkJCQlpZiAoIG5ld1BhdGggPT09IHVuZGVmaW5lZCApIHsKCQkJCQluZXdQYXRoID0gcGF0aC5wYXJzZUxvY2F0aW9uKCkuaGFzaDsKCQkJCX0KCQkJCXJldHVybiBwYXRoLnN0cmlwSGFzaCggbmV3UGF0aCApLnJlcGxhY2UoIC9bXlwvXSpcLlteXC8qXSskLywgIiIgKTsKCQkJfSwKCgkJCS8vc2V0IGxvY2F0aW9uIGhhc2ggdG8gcGF0aAoJCQlzZXQ6IGZ1bmN0aW9uKCBwYXRoICkgewoJCQkJbG9jYXRpb24uaGFzaCA9IHBhdGg7CgkJCX0sCgoJCQkvL3Rlc3QgaWYgYSBnaXZlbiB1cmwgKHN0cmluZykgaXMgYSBwYXRoCgkJCS8vTk9URSBtaWdodCBiZSBleGNlcHRpb25hbGx5IG5haXZlCgkJCWlzUGF0aDogZnVuY3Rpb24oIHVybCApIHsKCQkJCXJldHVybiAoIC9cLy8gKS50ZXN0KCB1cmwgKTsKCQkJfSwKCgkJCS8vcmV0dXJuIGEgdXJsIHBhdGggd2l0aCB0aGUgd2luZG93J3MgbG9jYXRpb24gcHJvdG9jb2wvaG9zdG5hbWUvcGF0aG5hbWUgcmVtb3ZlZAoJCQljbGVhbjogZnVuY3Rpb24oIHVybCApIHsKCQkJCXJldHVybiB1cmwucmVwbGFjZSggdGhpcy5kb2N1bWVudEJhc2UuZG9tYWluLCAiIiApOwoJCQl9LAoKCQkJLy9qdXN0IHJldHVybiB0aGUgdXJsIHdpdGhvdXQgYW4gaW5pdGlhbCAjCgkJCXN0cmlwSGFzaDogZnVuY3Rpb24oIHVybCApIHsKCQkJCXJldHVybiB1cmwucmVwbGFjZSggL14jLywgIiIgKTsKCQkJfSwKCgkJCXN0cmlwUXVlcnlQYXJhbXM6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQlyZXR1cm4gdXJsLnJlcGxhY2UoIC9cPy4qJC8sICIiICk7CgkJCX0sCgoJCQkvL3JlbW92ZSB0aGUgcHJlY2VkaW5nIGhhc2gsIGFueSBxdWVyeSBwYXJhbXMsIGFuZCBkaWFsb2cgbm90YXRpb25zCgkJCWNsZWFuSGFzaDogZnVuY3Rpb24oIGhhc2ggKSB7CgkJCQlyZXR1cm4gcGF0aC5zdHJpcEhhc2goIGhhc2gucmVwbGFjZSggL1w/LiokLywgIiIgKS5yZXBsYWNlKCBkaWFsb2dIYXNoS2V5LCAiIiApICk7CgkJCX0sCgoJCQlpc0hhc2hWYWxpZDogZnVuY3Rpb24oIGhhc2ggKSB7CgkJCQlyZXR1cm4gKCAvXiNbXiNdKyQvICkudGVzdCggaGFzaCApOwoJCQl9LAoKCQkJLy9jaGVjayB3aGV0aGVyIGEgdXJsIGlzIHJlZmVyZW5jaW5nIHRoZSBzYW1lIGRvbWFpbiwgb3IgYW4gZXh0ZXJuYWwgZG9tYWluIG9yIGRpZmZlcmVudCBwcm90b2NvbAoJCQkvL2NvdWxkIGJlIG1haWx0bywgZXRjCgkJCWlzRXh0ZXJuYWw6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQl2YXIgdSA9IHBhdGgucGFyc2VVcmwoIHVybCApOwoJCQkJcmV0dXJuIHUucHJvdG9jb2wgJiYgdS5kb21haW4gIT09IHRoaXMuZG9jdW1lbnRVcmwuZG9tYWluID8gdHJ1ZSA6IGZhbHNlOwoJCQl9LAoKCQkJaGFzUHJvdG9jb2w6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQlyZXR1cm4gKCAvXig6P1x3KzopLyApLnRlc3QoIHVybCApOwoJCQl9LAoKCQkJaXNFbWJlZGRlZFBhZ2U6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQl2YXIgdSA9IHBhdGgucGFyc2VVcmwoIHVybCApOwoKCQkJCS8vaWYgdGhlIHBhdGggaXMgYWJzb2x1dGUsIHRoZW4gd2UgbmVlZCB0byBjb21wYXJlIHRoZSB1cmwgYWdhaW5zdAoJCQkJLy9ib3RoIHRoZSB0aGlzLmRvY3VtZW50VXJsIGFuZCB0aGUgZG9jdW1lbnRCYXNlLiBUaGUgbWFpbiByZWFzb24gZm9yIHRoaXMKCQkJCS8vaXMgdGhhdCBsaW5rcyBlbWJlZGRlZCB3aXRoaW4gZXh0ZXJuYWwgZG9jdW1lbnRzIHdpbGwgcmVmZXIgdG8gdGhlCgkJCQkvL2FwcGxpY2F0aW9uIGRvY3VtZW50LCB3aGVyZWFzIGxpbmtzIGVtYmVkZGVkIHdpdGhpbiB0aGUgYXBwbGljYXRpb24KCQkJCS8vZG9jdW1lbnQgd2lsbCBiZSByZXNvbHZlZCBhZ2FpbnN0IHRoZSBkb2N1bWVudCBiYXNlLgoJCQkJaWYgKCB1LnByb3RvY29sICE9PSAiIiApIHsKCQkJCQlyZXR1cm4gKCAhdGhpcy5pc1BhdGgodS5oYXNoKSAmJiB1Lmhhc2ggJiYgKCB1LmhyZWZOb0hhc2ggPT09IHRoaXMuZG9jdW1lbnRVcmwuaHJlZk5vSGFzaCB8fCAoIHRoaXMuZG9jdW1lbnRCYXNlRGlmZmVycyAmJiB1LmhyZWZOb0hhc2ggPT09IHRoaXMuZG9jdW1lbnRCYXNlLmhyZWZOb0hhc2ggKSApICk7CgkJCQl9CgkJCQlyZXR1cm4gKCAvXiMvICkudGVzdCggdS5ocmVmICk7CgkJCX0sCgoJCQlzcXVhc2g6IGZ1bmN0aW9uKCB1cmwsIHJlc29sdXRpb25VcmwgKSB7CgkJCQl2YXIgaHJlZiwgY2xlYW5lZFVybCwgc2VhcmNoLCBzdGF0ZUluZGV4LAoJCQkJCWlzUGF0aCA9IHRoaXMuaXNQYXRoKCB1cmwgKSwKCQkJCQl1cmkgPSB0aGlzLnBhcnNlVXJsKCB1cmwgKSwKCQkJCQlwcmVzZXJ2ZWRIYXNoID0gdXJpLmhhc2gsCgkJCQkJdWlTdGF0ZSA9ICIiOwoKCQkJCS8vIHByb2R1Y2UgYSB1cmwgYWdhaW5zdCB3aGljaCB3ZSBjYW4gcmVzb2xlIHRoZSBwcm92aWRlZCBwYXRoCgkJCQlyZXNvbHV0aW9uVXJsID0gcmVzb2x1dGlvblVybCB8fCAocGF0aC5pc1BhdGgodXJsKSA/IHBhdGguZ2V0TG9jYXRpb24oKSA6IHBhdGguZ2V0RG9jdW1lbnRVcmwoKSk7CgoJCQkJLy8gSWYgdGhlIHVybCBpcyBhbnl0aGluZyBidXQgYSBzaW1wbGUgc3RyaW5nLCByZW1vdmUgYW55IHByZWNlZGluZyBoYXNoCgkJCQkvLyBlZyAjZm9vL2JhciAtPiBmb28vYmFyCgkJCQkvLyAgICAjZm9vIC0+ICNmb28KCQkJCWNsZWFuZWRVcmwgPSBpc1BhdGggPyBwYXRoLnN0cmlwSGFzaCggdXJsICkgOiB1cmw7CgoJCQkJLy8gSWYgdGhlIHVybCBpcyBhIGZ1bGwgdXJsIHdpdGggYSBoYXNoIGNoZWNrIGlmIHRoZSBwYXJzZWQgaGFzaCBpcyBhIHBhdGgKCQkJCS8vIGlmIGl0IGlzLCBzdHJpcCB0aGUgIywgYW5kIHVzZSBpdCBvdGhlcndpc2UgY29udGludWUgd2l0aG91dCBjaGFuZ2UKCQkJCWNsZWFuZWRVcmwgPSBwYXRoLmlzUGF0aCggdXJpLmhhc2ggKSA/IHBhdGguc3RyaXBIYXNoKCB1cmkuaGFzaCApIDogY2xlYW5lZFVybDsKCgkJCQkvLyBTcGxpdCB0aGUgVUkgU3RhdGUga2V5cyBvZmYgdGhlIGhyZWYKCQkJCXN0YXRlSW5kZXggPSBjbGVhbmVkVXJsLmluZGV4T2YoIHRoaXMudWlTdGF0ZUtleSApOwoKCQkJCS8vIHN0b3JlIHRoZSB1aSBzdGF0ZSBrZXlzIGZvciB1c2UKCQkJCWlmICggc3RhdGVJbmRleCA+IC0xICl7CgkJCQkJdWlTdGF0ZSA9IGNsZWFuZWRVcmwuc2xpY2UoIHN0YXRlSW5kZXggKTsKCQkJCQljbGVhbmVkVXJsID0gY2xlYW5lZFVybC5zbGljZSggMCwgc3RhdGVJbmRleCApOwoJCQkJfQoKCQkJCS8vIG1ha2UgdGhlIGNsZWFuZWRVcmwgYWJzb2x1dGUgcmVsYXRpdmUgdG8gdGhlIHJlc29sdXRpb24gdXJsCgkJCQlocmVmID0gcGF0aC5tYWtlVXJsQWJzb2x1dGUoIGNsZWFuZWRVcmwsIHJlc29sdXRpb25VcmwgKTsKCgkJCQkvLyBncmFiIHRoZSBzZWFyY2ggZnJvbSB0aGUgcmVzb2x2ZWQgdXJsIHNpbmNlIHBhcnNpbmcgZnJvbQoJCQkJLy8gdGhlIHBhc3NlZCB1cmwgbWF5IG5vdCB5aWVsZCB0aGUgY29ycmVjdCByZXN1bHQKCQkJCXNlYXJjaCA9IHRoaXMucGFyc2VVcmwoIGhyZWYgKS5zZWFyY2g7CgoJCQkJLy8gVE9ETyBhbGwgdGhpcyBjcmFwIGlzIHRlcnJpYmxlLCBjbGVhbiBpdCB1cAoJCQkJaWYgKCBpc1BhdGggKSB7CgkJCQkJLy8gcmVqZWN0IHRoZSBoYXNoIGlmIGl0J3MgYSBwYXRoIG9yIGl0J3MganVzdCBhIGRpYWxvZyBrZXkKCQkJCQlpZiAoIHBhdGguaXNQYXRoKCBwcmVzZXJ2ZWRIYXNoICkgfHwgcHJlc2VydmVkSGFzaC5yZXBsYWNlKCIjIiwgIiIpLmluZGV4T2YoIHRoaXMudWlTdGF0ZUtleSApID09PSAwKSB7CgkJCQkJCXByZXNlcnZlZEhhc2ggPSAiIjsKCQkJCQl9CgoJCQkJCS8vIEFwcGVuZCB0aGUgVUkgU3RhdGUga2V5cyB3aGVyZSBpdCBleGlzdHMgYW5kIGl0J3MgYmVlbiByZW1vdmVkCgkJCQkJLy8gZnJvbSB0aGUgdXJsCgkJCQkJaWYgKCB1aVN0YXRlICYmIHByZXNlcnZlZEhhc2guaW5kZXhPZiggdGhpcy51aVN0YXRlS2V5ICkgPT09IC0xKXsKCQkJCQkJcHJlc2VydmVkSGFzaCArPSB1aVN0YXRlOwoJCQkJCX0KCgkJCQkJLy8gbWFrZSBzdXJlIHRoYXQgcG91bmQgaXMgb24gdGhlIGZyb250IG9mIHRoZSBoYXNoCgkJCQkJaWYgKCBwcmVzZXJ2ZWRIYXNoLmluZGV4T2YoICIjIiApID09PSAtMSAmJiBwcmVzZXJ2ZWRIYXNoICE9PSAiIiApewoJCQkJCQlwcmVzZXJ2ZWRIYXNoID0gIiMiICsgcHJlc2VydmVkSGFzaDsKCQkJCQl9CgoJCQkJCS8vIHJlY29uc3RydWN0IGVhY2ggb2YgdGhlIHBpZWNlcyB3aXRoIHRoZSBuZXcgc2VhcmNoIHN0cmluZyBhbmQgaGFzaAoJCQkJCWhyZWYgPSBwYXRoLnBhcnNlVXJsKCBocmVmICk7CgkJCQkJaHJlZiA9IGhyZWYucHJvdG9jb2wgKyAiLy8iICsgaHJlZi5ob3N0ICsgaHJlZi5wYXRobmFtZSArIHNlYXJjaCArIHByZXNlcnZlZEhhc2g7CgkJCQl9IGVsc2UgewoJCQkJCWhyZWYgKz0gaHJlZi5pbmRleE9mKCAiIyIgKSA+IC0xID8gdWlTdGF0ZSA6ICIjIiArIHVpU3RhdGU7CgkJCQl9CgoJCQkJcmV0dXJuIGhyZWY7CgkJCX0sCgoJCQlpc1ByZXNlcnZhYmxlSGFzaDogZnVuY3Rpb24oIGhhc2ggKSB7CgkJCQlyZXR1cm4gaGFzaC5yZXBsYWNlKCAiIyIsICIiICkuaW5kZXhPZiggdGhpcy51aVN0YXRlS2V5ICkgPT09IDA7CgkJCX0sCgoJCQkvLyBFc2NhcGUgd2VpcmQgY2hhcmFjdGVycyBpbiB0aGUgaGFzaCBpZiBpdCBpcyB0byBiZSB1c2VkIGFzIGEgc2VsZWN0b3IKCQkJaGFzaFRvU2VsZWN0b3I6IGZ1bmN0aW9uKCBoYXNoICkgewoJCQkJdmFyIGhhc0hhc2ggPSAoIGhhc2guc3Vic3RyaW5nKCAwLCAxICkgPT09ICIjIiApOwoJCQkJaWYgKCBoYXNIYXNoICkgewoJCQkJCWhhc2ggPSBoYXNoLnN1YnN0cmluZyggMSApOwoJCQkJfQoJCQkJcmV0dXJuICggaGFzSGFzaCA/ICIjIiA6ICIiICkgKyBoYXNoLnJlcGxhY2UoIC8oWyEiIyQlJicoKSorLC4vOjs8PT4/QFtcXV5ge3x9fl0pL2csICJcXCQxIiApOwoJCQl9LAoKCQkJLy8gcmV0dXJuIHRoZSBzdWJzdHJpbmcgb2YgYSBmaWxlcGF0aCBiZWZvcmUgdGhlIHN1Yi1wYWdlIGtleSwgZm9yIG1ha2luZwoJCQkvLyBhIHNlcnZlciByZXF1ZXN0CgkJCWdldEZpbGVQYXRoOiBmdW5jdGlvbiggcGF0aCApIHsKCQkJCXZhciBzcGxpdGtleSA9ICImIiArICQubW9iaWxlLnN1YlBhZ2VVcmxLZXk7CgkJCQlyZXR1cm4gcGF0aCAmJiBwYXRoLnNwbGl0KCBzcGxpdGtleSApWzBdLnNwbGl0KCBkaWFsb2dIYXNoS2V5IClbMF07CgkJCX0sCgoJCQkvLyBjaGVjayBpZiB0aGUgc3BlY2lmaWVkIHVybCByZWZlcnMgdG8gdGhlIGZpcnN0IHBhZ2UgaW4gdGhlIG1haW4KCQkJLy8gYXBwbGljYXRpb24gZG9jdW1lbnQuCgkJCWlzRmlyc3RQYWdlVXJsOiBmdW5jdGlvbiggdXJsICkgewoJCQkJLy8gV2Ugb25seSBkZWFsIHdpdGggYWJzb2x1dGUgcGF0aHMuCgkJCQl2YXIgdSA9IHBhdGgucGFyc2VVcmwoIHBhdGgubWFrZVVybEFic29sdXRlKCB1cmwsIHRoaXMuZG9jdW1lbnRCYXNlICkgKSwKCgkJCQkJLy8gRG9lcyB0aGUgdXJsIGhhdmUgdGhlIHNhbWUgcGF0aCBhcyB0aGUgZG9jdW1lbnQ/CgkJCQkJc2FtZVBhdGggPSB1LmhyZWZOb0hhc2ggPT09IHRoaXMuZG9jdW1lbnRVcmwuaHJlZk5vSGFzaCB8fAoJCQkJCQkoIHRoaXMuZG9jdW1lbnRCYXNlRGlmZmVycyAmJgoJCQkJCQkJdS5ocmVmTm9IYXNoID09PSB0aGlzLmRvY3VtZW50QmFzZS5ocmVmTm9IYXNoICksCgoJCQkJCS8vIEdldCB0aGUgZmlyc3QgcGFnZSBlbGVtZW50LgoJCQkJCWZwID0gJC5tb2JpbGUuZmlyc3RQYWdlLAoKCQkJCQkvLyBHZXQgdGhlIGlkIG9mIHRoZSBmaXJzdCBwYWdlIGVsZW1lbnQgaWYgaXQgaGFzIG9uZS4KCQkJCQlmcElkID0gZnAgJiYgZnBbMF0gPyBmcFswXS5pZCA6IHVuZGVmaW5lZDsKCgkJCQkvLyBUaGUgdXJsIHJlZmVycyB0byB0aGUgZmlyc3QgcGFnZSBpZiB0aGUgcGF0aCBtYXRjaGVzIHRoZSBkb2N1bWVudCBhbmQKCQkJCS8vIGl0IGVpdGhlciBoYXMgbm8gaGFzaCB2YWx1ZSwgb3IgdGhlIGhhc2ggaXMgZXhhY3RseSBlcXVhbCB0byB0aGUgaWQKCQkJCS8vIG9mIHRoZSBmaXJzdCBwYWdlIGVsZW1lbnQuCgkJCQlyZXR1cm4gc2FtZVBhdGggJiYKCQkJCQkoICF1Lmhhc2ggfHwKCQkJCQkJdS5oYXNoID09PSAiIyIgfHwKCQkJCQkJKCBmcElkICYmIHUuaGFzaC5yZXBsYWNlKCAvXiMvLCAiIiApID09PSBmcElkICkgKTsKCQkJfSwKCgkJCS8vIFNvbWUgZW1iZWRkZWQgYnJvd3NlcnMsIGxpa2UgdGhlIHdlYiB2aWV3IGluIFBob25lIEdhcCwgYWxsb3cKCQkJLy8gY3Jvc3MtZG9tYWluIFhIUiByZXF1ZXN0cyBpZiB0aGUgZG9jdW1lbnQgZG9pbmcgdGhlIHJlcXVlc3Qgd2FzIGxvYWRlZAoJCQkvLyB2aWEgdGhlIGZpbGU6Ly8gcHJvdG9jb2wuIFRoaXMgaXMgdXN1YWxseSB0byBhbGxvdyB0aGUgYXBwbGljYXRpb24gdG8KCQkJLy8gInBob25lIGhvbWUiIGFuZCBmZXRjaCBhcHAgc3BlY2lmaWMgZGF0YS4gV2Ugbm9ybWFsbHkgbGV0IHRoZSBicm93c2VyCgkJCS8vIGhhbmRsZSBleHRlcm5hbC9jcm9zcy1kb21haW4gdXJscywgYnV0IGlmIHRoZSBhbGxvd0Nyb3NzRG9tYWluUGFnZXMKCQkJLy8gb3B0aW9uIGlzIHRydWUsIHdlIHdpbGwgYWxsb3cgY3Jvc3MtZG9tYWluIGh0dHAvaHR0cHMgcmVxdWVzdHMgdG8gZ28KCQkJLy8gdGhyb3VnaCBvdXIgcGFnZSBsb2FkaW5nIGxvZ2ljLgoJCQlpc1Blcm1pdHRlZENyb3NzRG9tYWluUmVxdWVzdDogZnVuY3Rpb24oIGRvY1VybCwgcmVxVXJsICkgewoJCQkJcmV0dXJuICQubW9iaWxlLmFsbG93Q3Jvc3NEb21haW5QYWdlcyAmJgoJCQkJCShkb2NVcmwucHJvdG9jb2wgPT09ICJmaWxlOiIgfHwgZG9jVXJsLnByb3RvY29sID09PSAiY29udGVudDoiKSAmJgoJCQkJCXJlcVVybC5zZWFyY2goIC9eaHR0cHM/Oi8gKSAhPT0gLTE7CgkJCX0KCQl9OwoKCQlwYXRoLmRvY3VtZW50VXJsID0gcGF0aC5wYXJzZUxvY2F0aW9uKCk7CgoJCSRiYXNlID0gJCggImhlYWQiICkuZmluZCggImJhc2UiICk7CgoJCXBhdGguZG9jdW1lbnRCYXNlID0gJGJhc2UubGVuZ3RoID8KCQkJcGF0aC5wYXJzZVVybCggcGF0aC5tYWtlVXJsQWJzb2x1dGUoICRiYXNlLmF0dHIoICJocmVmIiApLCBwYXRoLmRvY3VtZW50VXJsLmhyZWYgKSApIDoKCQkJcGF0aC5kb2N1bWVudFVybDsKCgkJcGF0aC5kb2N1bWVudEJhc2VEaWZmZXJzID0gKHBhdGguZG9jdW1lbnRVcmwuaHJlZk5vSGFzaCAhPT0gcGF0aC5kb2N1bWVudEJhc2UuaHJlZk5vSGFzaCk7CgoJCS8vcmV0dXJuIHRoZSBvcmlnaW5hbCBkb2N1bWVudCBiYXNlIHVybAoJCXBhdGguZ2V0RG9jdW1lbnRCYXNlID0gZnVuY3Rpb24oIGFzUGFyc2VkT2JqZWN0ICkgewoJCQlyZXR1cm4gYXNQYXJzZWRPYmplY3QgPyAkLmV4dGVuZCgge30sIHBhdGguZG9jdW1lbnRCYXNlICkgOiBwYXRoLmRvY3VtZW50QmFzZS5ocmVmOwoJCX07CgoJCS8vIERFUFJFQ0FURUQgYXMgb2YgMS40LjAgLSByZW1vdmUgaW4gMS41LjAKCQkkLmV4dGVuZCggJC5tb2JpbGUsIHsKCgkJCS8vcmV0dXJuIHRoZSBvcmlnaW5hbCBkb2N1bWVudCB1cmwKCQkJZ2V0RG9jdW1lbnRVcmw6IHBhdGguZ2V0RG9jdW1lbnRVcmwsCgoJCQkvL3JldHVybiB0aGUgb3JpZ2luYWwgZG9jdW1lbnQgYmFzZSB1cmwKCQkJZ2V0RG9jdW1lbnRCYXNlOiBwYXRoLmdldERvY3VtZW50QmFzZQoJCX0pOwp9KSggalF1ZXJ5ICk7CgoKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoJJC5tb2JpbGUuSGlzdG9yeSA9IGZ1bmN0aW9uKCBzdGFjaywgaW5kZXggKSB7CgkJdGhpcy5zdGFjayA9IHN0YWNrIHx8IFtdOwoJCXRoaXMuYWN0aXZlSW5kZXggPSBpbmRleCB8fCAwOwoJfTsKCgkkLmV4dGVuZCgkLm1vYmlsZS5IaXN0b3J5LnByb3RvdHlwZSwgewoJCWdldEFjdGl2ZTogZnVuY3Rpb24oKSB7CgkJCXJldHVybiB0aGlzLnN0YWNrWyB0aGlzLmFjdGl2ZUluZGV4IF07CgkJfSwKCgkJZ2V0TGFzdDogZnVuY3Rpb24oKSB7CgkJCXJldHVybiB0aGlzLnN0YWNrWyB0aGlzLnByZXZpb3VzSW5kZXggXTsKCQl9LAoKCQlnZXROZXh0OiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHRoaXMuc3RhY2tbIHRoaXMuYWN0aXZlSW5kZXggKyAxIF07CgkJfSwKCgkJZ2V0UHJldjogZnVuY3Rpb24oKSB7CgkJCXJldHVybiB0aGlzLnN0YWNrWyB0aGlzLmFjdGl2ZUluZGV4IC0gMSBdOwoJCX0sCgoJCS8vIGFkZE5ldyBpcyB1c2VkIHdoZW5ldmVyIGEgbmV3IHBhZ2UgaXMgYWRkZWQKCQlhZGQ6IGZ1bmN0aW9uKCB1cmwsIGRhdGEgKXsKCQkJZGF0YSA9IGRhdGEgfHwge307CgoJCQkvL2lmIHRoZXJlJ3MgZm9yd2FyZCBoaXN0b3J5LCB3aXBlIGl0CgkJCWlmICggdGhpcy5nZXROZXh0KCkgKSB7CgkJCQl0aGlzLmNsZWFyRm9yd2FyZCgpOwoJCQl9CgoJCQkvLyBpZiB0aGUgaGFzaCBpcyBpbmNsdWRlZCBpbiB0aGUgZGF0YSBtYWtlIHN1cmUgdGhlIHNoYXBlCgkJCS8vIGlzIGNvbnNpc3RlbnQgZm9yIGNvbXBhcmlzb24KCQkJaWYgKCBkYXRhLmhhc2ggJiYgZGF0YS5oYXNoLmluZGV4T2YoICIjIiApID09PSAtMSkgewoJCQkJZGF0YS5oYXNoID0gIiMiICsgZGF0YS5oYXNoOwoJCQl9CgoJCQlkYXRhLnVybCA9IHVybDsKCQkJdGhpcy5zdGFjay5wdXNoKCBkYXRhICk7CgkJCXRoaXMuYWN0aXZlSW5kZXggPSB0aGlzLnN0YWNrLmxlbmd0aCAtIDE7CgkJfSwKCgkJLy93aXBlIHVybHMgYWhlYWQgb2YgYWN0aXZlIGluZGV4CgkJY2xlYXJGb3J3YXJkOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5zdGFjayA9IHRoaXMuc3RhY2suc2xpY2UoIDAsIHRoaXMuYWN0aXZlSW5kZXggKyAxICk7CgkJfSwKCgkJZmluZDogZnVuY3Rpb24oIHVybCwgc3RhY2ssIGVhcmx5UmV0dXJuICkgewoJCQlzdGFjayA9IHN0YWNrIHx8IHRoaXMuc3RhY2s7CgoJCQl2YXIgZW50cnksIGksIGxlbmd0aCA9IHN0YWNrLmxlbmd0aCwgaW5kZXg7CgoJCQlmb3IgKCBpID0gMDsgaSA8IGxlbmd0aDsgaSsrICkgewoJCQkJZW50cnkgPSBzdGFja1tpXTsKCgkJCQlpZiAoIGRlY29kZVVSSUNvbXBvbmVudCh1cmwpID09PSBkZWNvZGVVUklDb21wb25lbnQoZW50cnkudXJsKSB8fAoJCQkJCWRlY29kZVVSSUNvbXBvbmVudCh1cmwpID09PSBkZWNvZGVVUklDb21wb25lbnQoZW50cnkuaGFzaCkgKSB7CgkJCQkJaW5kZXggPSBpOwoKCQkJCQlpZiAoIGVhcmx5UmV0dXJuICkgewoJCQkJCQlyZXR1cm4gaW5kZXg7CgkJCQkJfQoJCQkJfQoJCQl9CgoJCQlyZXR1cm4gaW5kZXg7CgkJfSwKCgkJY2xvc2VzdDogZnVuY3Rpb24oIHVybCApIHsKCQkJdmFyIGNsb3Nlc3QsIGEgPSB0aGlzLmFjdGl2ZUluZGV4OwoKCQkJLy8gRmlyc3QsIHRha2UgdGhlIHNsaWNlIG9mIHRoZSBoaXN0b3J5IHN0YWNrIGJlZm9yZSB0aGUgY3VycmVudCBpbmRleCBhbmQgc2VhcmNoCgkJCS8vIGZvciBhIHVybCBtYXRjaC4gSWYgb25lIGlzIGZvdW5kLCB3ZSdsbCBhdm9pZCBhdm9pZCBsb29raW5nIHRocm91Z2ggZm9yd2FyZCBoaXN0b3J5CgkJCS8vIE5PVEUgdGhlIHByZWZlcmVuY2UgZm9yIGJhY2t3YXJkIGhpc3RvcnkgbW92ZW1lbnQgaXMgZHJpdmVuIGJ5IHRoZSBmYWN0IHRoYXQKCQkJLy8gICAgICBtb3N0IG1vYmlsZSBicm93c2VycyBvbmx5IGhhdmUgYSBkZWRpY2F0ZWQgYmFjayBidXR0b24sIGFuZCB1c2VycyByYXJlbHkgdXNlCgkJCS8vICAgICAgdGhlIGZvcndhcmQgYnV0dG9uIGluIGRlc2t0b3AgYnJvd3NlciBhbnlob3cKCQkJY2xvc2VzdCA9IHRoaXMuZmluZCggdXJsLCB0aGlzLnN0YWNrLnNsaWNlKDAsIGEpICk7CgoJCQkvLyBJZiBub3RoaW5nIHdhcyBmb3VuZCBpbiBiYWNrd2FyZCBoaXN0b3J5IGNoZWNrIGZvcndhcmQuIFRoZSBgdHJ1ZWAKCQkJLy8gdmFsdWUgcGFzc2VkIGFzIHRoZSB0aGlyZCBwYXJhbWV0ZXIgY2F1c2VzIHRoZSBmaW5kIG1ldGhvZCB0byBicmVhawoJCQkvLyBvbiB0aGUgZmlyc3QgbWF0Y2ggaW4gdGhlIGZvcndhcmQgaGlzdG9yeSBzbGljZS4gVGhlIHN0YXJ0aW5nIGluZGV4CgkJCS8vIG9mIHRoZSBzbGljZSBtdXN0IHRoZW4gYmUgYWRkZWQgdG8gdGhlIHJlc3VsdCB0byBnZXQgdGhlIGVsZW1lbnQgaW5kZXgKCQkJLy8gaW4gdGhlIG9yaWdpbmFsIGhpc3Rvcnkgc3RhY2sgOiggOigKCQkJLy8KCQkJLy8gVE9ETyB0aGlzIGlzIGh5cGVyIGNvbmZ1c2luZyBhbmQgc2hvdWxkIGJlIGNsZWFuZWQgdXAgKHVnaCBzbyBiYWQpCgkJCWlmICggY2xvc2VzdCA9PT0gdW5kZWZpbmVkICkgewoJCQkJY2xvc2VzdCA9IHRoaXMuZmluZCggdXJsLCB0aGlzLnN0YWNrLnNsaWNlKGEpLCB0cnVlICk7CgkJCQljbG9zZXN0ID0gY2xvc2VzdCA9PT0gdW5kZWZpbmVkID8gY2xvc2VzdCA6IGNsb3Nlc3QgKyBhOwoJCQl9CgoJCQlyZXR1cm4gY2xvc2VzdDsKCQl9LAoKCQlkaXJlY3Q6IGZ1bmN0aW9uKCBvcHRzICkgewoJCQl2YXIgbmV3QWN0aXZlSW5kZXggPSB0aGlzLmNsb3Nlc3QoIG9wdHMudXJsICksIGEgPSB0aGlzLmFjdGl2ZUluZGV4OwoKCQkJLy8gc2F2ZSBuZXcgcGFnZSBpbmRleCwgbnVsbCBjaGVjayB0byBwcmV2ZW50IGZhbHNleSAwIHJlc3VsdAoJCQkvLyByZWNvcmQgdGhlIHByZXZpb3VzIGluZGV4IGZvciByZWZlcmVuY2UKCQkJaWYgKCBuZXdBY3RpdmVJbmRleCAhPT0gdW5kZWZpbmVkICkgewoJCQkJdGhpcy5hY3RpdmVJbmRleCA9IG5ld0FjdGl2ZUluZGV4OwoJCQkJdGhpcy5wcmV2aW91c0luZGV4ID0gYTsKCQkJfQoKCQkJLy8gaW52b2tlIGNhbGxiYWNrcyB3aGVyZSBhcHByb3ByaWF0ZQoJCQkvLwoJCQkvLyBUT0RPIHRoaXMgaXMgYWxzbyBjb252b2x1dGVkIGFuZCBjb25mdXNpbmcKCQkJaWYgKCBuZXdBY3RpdmVJbmRleCA8IGEgKSB7CgkJCQkoIG9wdHMucHJlc2VudCB8fCBvcHRzLmJhY2sgfHwgJC5ub29wICkoIHRoaXMuZ2V0QWN0aXZlKCksICJiYWNrIiApOwoJCQl9IGVsc2UgaWYgKCBuZXdBY3RpdmVJbmRleCA+IGEgKSB7CgkJCQkoIG9wdHMucHJlc2VudCB8fCBvcHRzLmZvcndhcmQgfHwgJC5ub29wICkoIHRoaXMuZ2V0QWN0aXZlKCksICJmb3J3YXJkIiApOwoJCQl9IGVsc2UgaWYgKCBuZXdBY3RpdmVJbmRleCA9PT0gdW5kZWZpbmVkICYmIG9wdHMubWlzc2luZyApewoJCQkJb3B0cy5taXNzaW5nKCB0aGlzLmdldEFjdGl2ZSgpICk7CgkJCX0KCQl9Cgl9KTsKfSkoIGpRdWVyeSApOwoKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoJdmFyIHBhdGggPSAkLm1vYmlsZS5wYXRoLAoJCWluaXRpYWxIcmVmID0gbG9jYXRpb24uaHJlZjsKCgkkLm1vYmlsZS5OYXZpZ2F0b3IgPSBmdW5jdGlvbiggaGlzdG9yeSApIHsKCQl0aGlzLmhpc3RvcnkgPSBoaXN0b3J5OwoJCXRoaXMuaWdub3JlSW5pdGlhbEhhc2hDaGFuZ2UgPSB0cnVlOwoKCQkkLm1vYmlsZS53aW5kb3cuYmluZCh7CgkJCSJwb3BzdGF0ZS5oaXN0b3J5IjogJC5wcm94eSggdGhpcy5wb3BzdGF0ZSwgdGhpcyApLAoJCQkiaGFzaGNoYW5nZS5oaXN0b3J5IjogJC5wcm94eSggdGhpcy5oYXNoY2hhbmdlLCB0aGlzICkKCQl9KTsKCX07CgoJJC5leHRlbmQoJC5tb2JpbGUuTmF2aWdhdG9yLnByb3RvdHlwZSwgewoJCXNxdWFzaDogZnVuY3Rpb24oIHVybCwgZGF0YSApIHsKCQkJdmFyIHN0YXRlLCBocmVmLCBoYXNoID0gcGF0aC5pc1BhdGgodXJsKSA/IHBhdGguc3RyaXBIYXNoKHVybCkgOiB1cmw7CgoJCQlocmVmID0gcGF0aC5zcXVhc2goIHVybCApOwoKCQkJLy8gbWFrZSBzdXJlIHRvIHByb3ZpZGUgdGhpcyBpbmZvcm1hdGlvbiB3aGVuIGl0IGlzbid0IGV4cGxpY2l0bHkgc2V0IGluIHRoZQoJCQkvLyBkYXRhIG9iamVjdCB0aGF0IHdhcyBwYXNzZWQgdG8gdGhlIHNxdWFzaCBtZXRob2QKCQkJc3RhdGUgPSAkLmV4dGVuZCh7CgkJCQloYXNoOiBoYXNoLAoJCQkJdXJsOiBocmVmCgkJCX0sIGRhdGEpOwoKCQkJLy8gcmVwbGFjZSB0aGUgY3VycmVudCB1cmwgd2l0aCB0aGUgbmV3IGhyZWYgYW5kIHN0b3JlIHRoZSBzdGF0ZQoJCQkvLyBOb3RlIHRoYXQgaW4gc29tZSBjYXNlcyB3ZSBtaWdodCBiZSByZXBsYWNpbmcgYW4gdXJsIHdpdGggdGhlCgkJCS8vIHNhbWUgdXJsLiBXZSBkbyB0aGlzIGFueXdheXMgYmVjYXVzZSB3ZSBuZWVkIHRvIG1ha2Ugc3VyZSB0aGF0CgkJCS8vIGFsbCBvZiBvdXIgaGlzdG9yeSBlbnRyaWVzIGhhdmUgYSBzdGF0ZSBvYmplY3QgYXNzb2NpYXRlZCB3aXRoCgkJCS8vIHRoZW0uIFRoaXMgYWxsb3dzIHVzIHRvIHdvcmsgYXJvdW5kIHRoZSBjYXNlIHdoZXJlICQubW9iaWxlLmJhY2soKQoJCQkvLyBpcyBjYWxsZWQgdG8gdHJhbnNpdGlvbiBmcm9tIGFuIGV4dGVybmFsIHBhZ2UgdG8gYW4gZW1iZWRkZWQgcGFnZS4KCQkJLy8gSW4gdGhhdCBwYXJ0aWN1bGFyIGNhc2UsIGEgaGFzaGNoYW5nZSBldmVudCBpcyAqTk9UKiBnZW5lcmF0ZWQgYnkgdGhlIGJyb3dzZXIuCgkJCS8vIEVuc3VyaW5nIGVhY2ggaGlzdG9yeSBlbnRyeSBoYXMgYSBzdGF0ZSBvYmplY3QgbWVhbnMgdGhhdCBvblBvcFN0YXRlKCkKCQkJLy8gd2lsbCBhbHdheXMgdHJpZ2dlciBvdXIgaGFzaGNoYW5nZSBjYWxsYmFjayBldmVuIHdoZW4gYSBoYXNoY2hhbmdlIGV2ZW50CgkJCS8vIGlzIG5vdCBmaXJlZC4KCQkJd2luZG93Lmhpc3RvcnkucmVwbGFjZVN0YXRlKCBzdGF0ZSwgc3RhdGUudGl0bGUgfHwgZG9jdW1lbnQudGl0bGUsIGhyZWYgKTsKCgkJCXJldHVybiBzdGF0ZTsKCQl9LAoKCQloYXNoOiBmdW5jdGlvbiggdXJsLCBocmVmICkgewoJCQl2YXIgcGFyc2VkLCBsb2MsIGhhc2gsIHJlc29sdmVkOwoKCQkJLy8gR3JhYiB0aGUgaGFzaCBmb3IgcmVjb3JkaW5nLiBJZiB0aGUgcGFzc2VkIHVybCBpcyBhIHBhdGgKCQkJLy8gd2UgdXNlZCB0aGUgcGFyc2VkIHZlcnNpb24gb2YgdGhlIHNxdWFzaGVkIHVybCB0byByZWNvbnN0cnVjdCwKCQkJLy8gb3RoZXJ3aXNlIHdlIGFzc3VtZSBpdCdzIGEgaGFzaCBhbmQgc3RvcmUgaXQgZGlyZWN0bHkKCQkJcGFyc2VkID0gcGF0aC5wYXJzZVVybCggdXJsICk7CgkJCWxvYyA9IHBhdGgucGFyc2VMb2NhdGlvbigpOwoKCQkJaWYgKCBsb2MucGF0aG5hbWUgKyBsb2Muc2VhcmNoID09PSBwYXJzZWQucGF0aG5hbWUgKyBwYXJzZWQuc2VhcmNoICkgewoJCQkJLy8gSWYgdGhlIHBhdGhuYW1lIGFuZCBzZWFyY2ggb2YgdGhlIHBhc3NlZCB1cmwgaXMgaWRlbnRpY2FsIHRvIHRoZSBjdXJyZW50IGxvYwoJCQkJLy8gdGhlbiB3ZSBtdXN0IHVzZSB0aGUgaGFzaC4gT3RoZXJ3aXNlIHRoZXJlIHdpbGwgYmUgbm8gZXZlbnQKCQkJCS8vIGVnLCB1cmwgPSAiL2Zvby9iYXI/YmF6I2JhbmciLCBsb2NhdGlvbi5ocmVmID0gImh0dHA6Ly9leGFtcGxlLmNvbS9mb28vYmFyP2JheiIKCQkJCWhhc2ggPSBwYXJzZWQuaGFzaCA/IHBhcnNlZC5oYXNoIDogcGFyc2VkLnBhdGhuYW1lICsgcGFyc2VkLnNlYXJjaDsKCQkJfSBlbHNlIGlmICggcGF0aC5pc1BhdGgodXJsKSApIHsKCQkJCXJlc29sdmVkID0gcGF0aC5wYXJzZVVybCggaHJlZiApOwoJCQkJLy8gSWYgdGhlIHBhc3NlZCB1cmwgaXMgYSBwYXRoLCBtYWtlIGl0IGRvbWFpbiByZWxhdGl2ZSBhbmQgcmVtb3ZlIGFueSB0cmFpbGluZyBoYXNoCgkJCQloYXNoID0gcmVzb2x2ZWQucGF0aG5hbWUgKyByZXNvbHZlZC5zZWFyY2ggKyAocGF0aC5pc1ByZXNlcnZhYmxlSGFzaCggcmVzb2x2ZWQuaGFzaCApPyByZXNvbHZlZC5oYXNoLnJlcGxhY2UoICIjIiwgIiIgKSA6ICIiKTsKCQkJfSBlbHNlIHsKCQkJCWhhc2ggPSB1cmw7CgkJCX0KCgkJCXJldHVybiBoYXNoOwoJCX0sCgoJCS8vIFRPRE8gcmVjb25zaWRlciBuYW1lCgkJZ286IGZ1bmN0aW9uKCB1cmwsIGRhdGEsIG5vRXZlbnRzICkgewoJCQl2YXIgc3RhdGUsIGhyZWYsIGhhc2gsIHBvcHN0YXRlRXZlbnQsCgkJCQlpc1BvcFN0YXRlRXZlbnQgPSAkLmV2ZW50LnNwZWNpYWwubmF2aWdhdGUuaXNQdXNoU3RhdGVFbmFibGVkKCk7CgoJCQkvLyBHZXQgdGhlIHVybCBhcyBpdCB3b3VsZCBsb29rIHNxdWFzaGVkIG9uIHRvIHRoZSBjdXJyZW50IHJlc29sdXRpb24gdXJsCgkJCWhyZWYgPSBwYXRoLnNxdWFzaCggdXJsICk7CgoJCQkvLyBzb3J0IG91dCB3aGF0IHRoZSBoYXNoIHNvdWxkIGJlIGZyb20gdGhlIHVybAoJCQloYXNoID0gdGhpcy5oYXNoKCB1cmwsIGhyZWYgKTsKCgkJCS8vIEhlcmUgd2UgcHJldmVudCB0aGUgbmV4dCBoYXNoIGNoYW5nZSBvciBwb3BzdGF0ZSBldmVudCBmcm9tIGRvaW5nIGFueQoJCQkvLyBoaXN0b3J5IG1hbmFnZW1lbnQuIEluIHRoZSBjYXNlIG9mIGhhc2hjaGFuZ2Ugd2UgZG9uJ3Qgc3dhbGxvdyBpdAoJCQkvLyBpZiB0aGVyZSB3aWxsIGJlIG5vIGhhc2hjaGFuZ2UgZmlyZWQgKHNpbmNlIHRoYXQgd29uJ3QgcmVzZXQgdGhlIHZhbHVlKQoJCQkvLyBhbmQgd2lsbCBzd2FsbG93IHRoZSBmb2xsb3dpbmcgaGFzaGNoYW5nZQoJCQlpZiAoIG5vRXZlbnRzICYmIGhhc2ggIT09IHBhdGguc3RyaXBIYXNoKHBhdGgucGFyc2VMb2NhdGlvbigpLmhhc2gpICkgewoJCQkJdGhpcy5wcmV2ZW50TmV4dEhhc2hDaGFuZ2UgPSBub0V2ZW50czsKCQkJfQoKCQkJLy8gSU1QT1JUQU5UIGluIHRoZSBjYXNlIHdoZXJlIHBvcHN0YXRlIGlzIHN1cHBvcnRlZCB0aGUgZXZlbnQgd2lsbCBiZSB0cmlnZ2VyZWQKCQkJLy8gICAgICBkaXJlY3RseSwgc3RvcHBpbmcgZnVydGhlciBleGVjdXRpb24gLSBpZSwgaW50ZXJ1cHRpbmcgdGhlIGZsb3cgb2YgdGhpcwoJCQkvLyAgICAgIG1ldGhvZCBjYWxsIHRvIGZpcmUgYmluZGluZ3MgYXQgdGhpcyBleHByZXNzaW9uLiBCZWxvdyB0aGUgbmF2aWdhdGUgbWV0aG9kCgkJCS8vICAgICAgdGhlcmUgaXMgYSBiaW5kaW5nIHRvIGNhdGNoIHRoaXMgZXZlbnQgYW5kIHN0b3AgaXRzIHByb3BhZ2F0aW9uLgoJCQkvLwoJCQkvLyAgICAgIFdlIHRoZW4gdHJpZ2dlciBhIG5ldyBwb3BzdGF0ZSBldmVudCBvbiB0aGUgd2luZG93IHdpdGggYSBudWxsIHN0YXRlCgkJCS8vICAgICAgc28gdGhhdCB0aGUgbmF2aWdhdGUgZXZlbnRzIGNhbiBjb25jbHVkZSB0aGVpciB3b3JrIHByb3Blcmx5CgkJCS8vCgkJCS8vIGlmIHRoZSB1cmwgaXMgYSBwYXRoIHdlIHdhbnQgdG8gcHJlc2VydmUgdGhlIHF1ZXJ5IHBhcmFtcyB0aGF0IGFyZSBhdmFpbGFibGUgb24KCQkJLy8gdGhlIGN1cnJlbnQgdXJsLgoJCQl0aGlzLnByZXZlbnRIYXNoQXNzaWduUG9wU3RhdGUgPSB0cnVlOwoJCQl3aW5kb3cubG9jYXRpb24uaGFzaCA9IGhhc2g7CgoJCQkvLyBJZiBwb3BzdGF0ZSBpcyBlbmFibGVkIGFuZCB0aGUgYnJvd3NlciB0cmlnZ2VycyBgcG9wc3RhdGVgIGV2ZW50cyB3aGVuIHRoZSBoYXNoCgkJCS8vIGlzIHNldCAodGhpcyBvZnRlbiBoYXBwZW5zIGltbWVkaWF0ZWx5IGluIGJyb3dzZXJzIGxpa2UgQ2hyb21lKSwgdGhlbiB0aGUKCQkJLy8gdGhpcyBmbGFnIHdpbGwgYmUgc2V0IHRvIGZhbHNlIGFscmVhZHkuIElmIGl0J3MgYSBicm93c2VyIHRoYXQgZG9lcyBub3QgdHJpZ2dlcgoJCQkvLyBhIGBwb3BzdGF0ZWAgb24gaGFzaCBhc3NpZ25lbWVudCBvciBgcmVwbGFjZVN0YXRlYCB0aGVuIHdlIG5lZWQgYXZvaWQgdGhlIGJyYW5jaAoJCQkvLyB0aGF0IHN3YWxsb3dzIHRoZSBldmVudCBjcmVhdGVkIGJ5IHRoZSBwb3BzdGF0ZSBnZW5lcmF0ZWQgYnkgdGhlIGhhc2ggYXNzaWdubWVudAoJCQkvLyBBdCB0aGUgdGltZSBvZiB0aGlzIHdyaXRpbmcgdGhpcyBoYXBwZW5zIHdpdGggT3BlcmEgMTIgYW5kIHNvbWUgdmVyc2lvbiBvZiBJRQoJCQl0aGlzLnByZXZlbnRIYXNoQXNzaWduUG9wU3RhdGUgPSBmYWxzZTsKCgkJCXN0YXRlID0gJC5leHRlbmQoewoJCQkJdXJsOiBocmVmLAoJCQkJaGFzaDogaGFzaCwKCQkJCXRpdGxlOiBkb2N1bWVudC50aXRsZQoJCQl9LCBkYXRhKTsKCgkJCWlmICggaXNQb3BTdGF0ZUV2ZW50ICkgewoJCQkJcG9wc3RhdGVFdmVudCA9IG5ldyAkLkV2ZW50KCAicG9wc3RhdGUiICk7CgkJCQlwb3BzdGF0ZUV2ZW50Lm9yaWdpbmFsRXZlbnQgPSB7CgkJCQkJdHlwZTogInBvcHN0YXRlIiwKCQkJCQlzdGF0ZTogbnVsbAoJCQkJfTsKCgkJCQl0aGlzLnNxdWFzaCggdXJsLCBzdGF0ZSApOwoKCQkJCS8vIFRyaWdnZXIgYSBuZXcgZmF1eCBwb3BzdGF0ZSBldmVudCB0byByZXBsYWNlIHRoZSBvbmUgdGhhdCB3ZQoJCQkJLy8gY2F1Z2h0IHRoYXQgd2FzIHRyaWdnZXJlZCBieSB0aGUgaGFzaCBzZXR0aW5nIGFib3ZlLgoJCQkJaWYgKCAhbm9FdmVudHMgKSB7CgkJCQkJdGhpcy5pZ25vcmVQb3BTdGF0ZSA9IHRydWU7CgkJCQkJJC5tb2JpbGUud2luZG93LnRyaWdnZXIoIHBvcHN0YXRlRXZlbnQgKTsKCQkJCX0KCQkJfQoKCQkJLy8gcmVjb3JkIHRoZSBoaXN0b3J5IGVudHJ5IHNvIHRoYXQgdGhlIGluZm9ybWF0aW9uIGNhbiBiZSBpbmNsdWRlZAoJCQkvLyBpbiBoYXNoY2hhbmdlIGV2ZW50IGRyaXZlbiBuYXZpZ2F0ZSBldmVudHMgaW4gYSBzaW1pbGFyIGZhc2hpb24gdG8KCQkJLy8gdGhlIHN0YXRlIHRoYXQncyBwcm92aWRlZCBieSBwb3BzdGF0ZQoJCQl0aGlzLmhpc3RvcnkuYWRkKCBzdGF0ZS51cmwsIHN0YXRlICk7CgkJfSwKCgoJCS8vIFRoaXMgYmluZGluZyBpcyBpbnRlbmRlZCB0byBjYXRjaCB0aGUgcG9wc3RhdGUgZXZlbnRzIHRoYXQgYXJlIGZpcmVkCgkJLy8gd2hlbiBleGVjdXRpb24gb2YgdGhlIGAkLm5hdmlnYXRlYCBtZXRob2Qgc3RvcHMgYXQgd2luZG93LmxvY2F0aW9uLmhhc2ggPSB1cmw7CgkJLy8gYW5kIGNvbXBsZXRlbHkgcHJldmVudCB0aGVtIGZyb20gcHJvcGFnYXRpbmcuIFRoZSBwb3BzdGF0ZSBldmVudCB3aWxsIHRoZW4gYmUKCQkvLyByZXRyaWdnZXJlZCBhZnRlciBleGVjdXRpb24gcmVzdW1lcwoJCS8vCgkJLy8gVE9ETyBncmFiIHRoZSBvcmlnaW5hbCBldmVudCBoZXJlIGFuZCB1c2UgaXQgZm9yIHRoZSBzeW50aGV0aWMgZXZlbnQgaW4gdGhlCgkJLy8gICAgICBzZWNvbmQgaGFsZiBvZiB0aGUgbmF2aWdhdGUgZXhlY3V0aW9uIHRoYXQgd2lsbCBmb2xsb3cgdGhpcyBiaW5kaW5nCgkJcG9wc3RhdGU6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdmFyIGhhc2gsIHN0YXRlOwoKCQkJLy8gUGFydGx5IHRvIHN1cHBvcnQgb3VyIHRlc3Qgc3VpdGUgd2hpY2ggbWFudWFsbHkgYWx0ZXJzIHRoZSBzdXBwb3J0CgkJCS8vIHZhbHVlIHRvIHRlc3QgaGFzaGNoYW5nZS4gUGFydGx5IHRvIHByZXZlbnQgYWxsIGFyb3VuZCB3ZWlyZG5lc3MKCQkJaWYgKCAhJC5ldmVudC5zcGVjaWFsLm5hdmlnYXRlLmlzUHVzaFN0YXRlRW5hYmxlZCgpICl7CgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIElmIHRoaXMgaXMgdGhlIHBvcHN0YXRlIHRyaWdnZXJlZCBieSB0aGUgYWN0dWFsIGFsdGVyYXRpb24gb2YgdGhlIGhhc2gKCQkJLy8gcHJldmVudCBpdCBjb21wbGV0ZWx5LiBIaXN0b3J5IGlzIHRyYWNrZWQgbWFudWFsbHkKCQkJaWYgKCB0aGlzLnByZXZlbnRIYXNoQXNzaWduUG9wU3RhdGUgKSB7CgkJCQl0aGlzLnByZXZlbnRIYXNoQXNzaWduUG9wU3RhdGUgPSBmYWxzZTsKCQkJCWV2ZW50LnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbigpOwoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBpZiB0aGlzIGlzIHRoZSBwb3BzdGF0ZSB0cmlnZ2VyZWQgYWZ0ZXIgdGhlIGByZXBsYWNlU3RhdGVgIGNhbGwgaW4gdGhlIGdvCgkJCS8vIG1ldGhvZCwgdGhlbiBzaW1wbHkgaWdub3JlIGl0LiBUaGUgaGlzdG9yeSBlbnRyeSBoYXMgYWxyZWFkeSBiZWVuIGNhcHR1cmVkCgkJCWlmICggdGhpcy5pZ25vcmVQb3BTdGF0ZSApIHsKCQkJCXRoaXMuaWdub3JlUG9wU3RhdGUgPSBmYWxzZTsKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gSWYgdGhlcmUgaXMgbm8gc3RhdGUsIGFuZCB0aGUgaGlzdG9yeSBzdGFjayBsZW5ndGggaXMgb25lIHdlcmUKCQkJLy8gcHJvYmFibHkgZ2V0dGluZyB0aGUgcGFnZSBsb2FkIHBvcHN0YXRlIGZpcmVkIGJ5IGJyb3dzZXJzIGxpa2UgY2hyb21lCgkJCS8vIGF2b2lkIGl0IGFuZCBzZXQgdGhlIG9uZSB0aW1lIGZsYWcgdG8gZmFsc2UuCgkJCS8vIFRPRE86IERvIHdlIHJlYWxseSBuZWVkIGFsbCB0aGVzZSBjb25kaXRpb25zPyBDb21wYXJpbmcgbG9jYXRpb24gaHJlZnMKCQkJLy8gc2hvdWxkIGJlIHN1ZmZpY2llbnQuCgkJCWlmICggIWV2ZW50Lm9yaWdpbmFsRXZlbnQuc3RhdGUgJiYKCQkJCXRoaXMuaGlzdG9yeS5zdGFjay5sZW5ndGggPT09IDEgJiYKCQkJCXRoaXMuaWdub3JlSW5pdGlhbEhhc2hDaGFuZ2UgKSB7CgkJCQl0aGlzLmlnbm9yZUluaXRpYWxIYXNoQ2hhbmdlID0gZmFsc2U7CgoJCQkJaWYgKCBsb2NhdGlvbi5ocmVmID09PSBpbml0aWFsSHJlZiApIHsKCQkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJCXJldHVybjsKCQkJCX0KCQkJfQoKCQkJLy8gYWNjb3VudCBmb3IgZGlyZWN0IG1hbmlwdWxhdGlvbiBvZiB0aGUgaGFzaC4gVGhhdCBpcywgd2Ugd2lsbCByZWNlaXZlIGEgcG9wc3RhdGUKCQkJLy8gd2hlbiB0aGUgaGFzaCBpcyBjaGFuZ2VkIGJ5IGFzc2lnbm1lbnQsIGFuZCBpdCB3b24ndCBoYXZlIGEgc3RhdGUgYXNzb2NpYXRlZC4gV2UKCQkJLy8gdGhlbiBuZWVkIHRvIHNxdWFzaCB0aGUgaGFzaC4gU2VlIGJlbG93IGZvciBoYW5kbGluZyBvZiBoYXNoIGFzc2lnbm1lbnQgdGhhdAoJCQkvLyBtYXRjaGVzIGFuIGV4aXN0aW5nIGhpc3RvcnkgZW50cnkKCQkJLy8gVE9ETyBpdCBtaWdodCBiZSBiZXR0ZXIgdG8gb25seSBhZGQgdG8gdGhlIGhpc3Rvcnkgc3RhY2sKCQkJLy8gICAgICB3aGVuIHRoZSBoYXNoIGlzIGFkamFjZW50IHRvIHRoZSBhY3RpdmUgaGlzdG9yeSBlbnRyeQoJCQloYXNoID0gcGF0aC5wYXJzZUxvY2F0aW9uKCkuaGFzaDsKCQkJaWYgKCAhZXZlbnQub3JpZ2luYWxFdmVudC5zdGF0ZSAmJiBoYXNoICkgewoJCQkJLy8gc3F1YXNoIHRoZSBoYXNoIHRoYXQncyBiZWVuIGFzc2lnbmVkIG9uIHRoZSBVUkwgd2l0aCByZXBsYWNlU3RhdGUKCQkJCS8vIGFsc28gZ3JhYiB0aGUgcmVzdWx0aW5nIHN0YXRlIG9iamVjdCBmb3Igc3RvcmFnZQoJCQkJc3RhdGUgPSB0aGlzLnNxdWFzaCggaGFzaCApOwoKCQkJCS8vIHJlY29yZCB0aGUgbmV3IGhhc2ggYXMgYW4gYWRkaXRpb25hbCBoaXN0b3J5IGVudHJ5CgkJCQkvLyB0byBtYXRjaCB0aGUgYnJvd3NlcidzIHRyZWF0bWVudCBvZiBoYXNoIGFzc2lnbm1lbnQKCQkJCXRoaXMuaGlzdG9yeS5hZGQoIHN0YXRlLnVybCwgc3RhdGUgKTsKCgkJCQkvLyBwYXNzIHRoZSBuZXdseSBjcmVhdGVkIHN0YXRlIGluZm9ybWF0aW9uCgkJCQkvLyBhbG9uZyB3aXRoIHRoZSBldmVudAoJCQkJZXZlbnQuaGlzdG9yeVN0YXRlID0gc3RhdGU7CgoJCQkJLy8gZG8gbm90IGFsdGVyIGhpc3RvcnksIHdlJ3ZlIGFkZGVkIGEgbmV3IGhpc3RvcnkgZW50cnkKCQkJCS8vIHNvIHdlIGtub3cgd2hlcmUgd2UgYXJlCgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIElmIGFsbCBlbHNlIGZhaWxzIHRoaXMgaXMgYSBwb3BzdGF0ZSB0aGF0IGNvbWVzIGZyb20gdGhlIGJhY2sgb3IgZm9yd2FyZCBidXR0b25zCgkJCS8vIG1ha2Ugc3VyZSB0byBzZXQgdGhlIHN0YXRlIG9mIG91ciBoaXN0b3J5IHN0YWNrIHByb3Blcmx5LCBhbmQgcmVjb3JkIHRoZSBkaXJlY3Rpb25hbGl0eQoJCQl0aGlzLmhpc3RvcnkuZGlyZWN0KHsKCQkJCXVybDogKGV2ZW50Lm9yaWdpbmFsRXZlbnQuc3RhdGUgfHwge30pLnVybCB8fCBoYXNoLAoKCQkJCS8vIFdoZW4gdGhlIHVybCBpcyBlaXRoZXIgZm9yd2FyZCBvciBiYWNrd2FyZCBpbiBoaXN0b3J5IGluY2x1ZGUgdGhlIGVudHJ5CgkJCQkvLyBhcyBkYXRhIG9uIHRoZSBldmVudCBvYmplY3QgZm9yIG1lcmdpbmcgYXMgZGF0YSBpbiB0aGUgbmF2aWdhdGUgZXZlbnQKCQkJCXByZXNlbnQ6IGZ1bmN0aW9uKCBoaXN0b3J5RW50cnksIGRpcmVjdGlvbiApIHsKCQkJCQkvLyBtYWtlIHN1cmUgdG8gY3JlYXRlIGEgbmV3IG9iamVjdCB0byBwYXNzIGRvd24gYXMgdGhlIG5hdmlnYXRlIGV2ZW50IGRhdGEKCQkJCQlldmVudC5oaXN0b3J5U3RhdGUgPSAkLmV4dGVuZCh7fSwgaGlzdG9yeUVudHJ5KTsKCQkJCQlldmVudC5oaXN0b3J5U3RhdGUuZGlyZWN0aW9uID0gZGlyZWN0aW9uOwoJCQkJfQoJCQl9KTsKCQl9LAoKCQkvLyBOT1RFIG11c3QgYmluZCBiZWZvcmUgYG5hdmlnYXRlYCBzcGVjaWFsIGV2ZW50IGhhc2hjaGFuZ2UgYmluZGluZyBvdGhlcndpc2UgdGhlCgkJLy8gICAgICBuYXZpZ2F0aW9uIGRhdGEgd29uJ3QgYmUgYXR0YWNoZWQgdG8gdGhlIGhhc2hjaGFuZ2UgZXZlbnQgaW4gdGltZSBmb3IgdGhvc2UKCQkvLyAgICAgIGJpbmRpbmdzIHRvIGF0dGFjaCBpdCB0byB0aGUgYG5hdmlnYXRlYCBzcGVjaWFsIGV2ZW50CgkJLy8gVE9ETyBhZGQgYSBjaGVjayBoZXJlIHRoYXQgYGhhc2hjaGFuZ2UubmF2aWdhdGVgIGlzIGJvdW5kIGFscmVhZHkgb3RoZXJ3aXNlIGl0J3MKCQkvLyAgICAgIGJyb2tlbiAoZXhjZXB0aW9uPykKCQloYXNoY2hhbmdlOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciBoaXN0b3J5LCBoYXNoOwoKCQkJLy8gSWYgaGFzaGNoYW5nZSBsaXN0ZW5pbmcgaXMgZXhwbGljaXRseSBkaXNhYmxlZCBvciBwdXNoc3RhdGUgaXMgc3VwcG9ydGVkCgkJCS8vIGF2b2lkIG1ha2luZyB1c2Ugb2YgdGhlIGhhc2hjaGFuZ2UgaGFuZGxlci4KCQkJaWYgKCEkLmV2ZW50LnNwZWNpYWwubmF2aWdhdGUuaXNIYXNoQ2hhbmdlRW5hYmxlZCgpIHx8CgkJCQkkLmV2ZW50LnNwZWNpYWwubmF2aWdhdGUuaXNQdXNoU3RhdGVFbmFibGVkKCkgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIE9uIG9jY2FzaW9uIGV4cGxpY2l0bHkgd2FudCB0byBwcmV2ZW50IHRoZSBuZXh0IGhhc2ggZnJvbSBwcm9wb2dhdGluZyBiZWNhdXNlIHdlIG9ubHkKCQkJLy8gd2l0aCB0byBhbHRlciB0aGUgdXJsIHRvIHJlcHJlc2VudCB0aGUgbmV3IHN0YXRlIGRvIHNvIGhlcmUKCQkJaWYgKCB0aGlzLnByZXZlbnROZXh0SGFzaENoYW5nZSApewoJCQkJdGhpcy5wcmV2ZW50TmV4dEhhc2hDaGFuZ2UgPSBmYWxzZTsKCQkJCWV2ZW50LnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbigpOwoJCQkJcmV0dXJuOwoJCQl9CgoJCQloaXN0b3J5ID0gdGhpcy5oaXN0b3J5OwoJCQloYXNoID0gcGF0aC5wYXJzZUxvY2F0aW9uKCkuaGFzaDsKCgkJCS8vIElmIHRoaXMgaXMgYSBoYXNoY2hhbmdlIGNhdXNlZCBieSB0aGUgYmFjayBvciBmb3J3YXJkIGJ1dHRvbgoJCQkvLyBtYWtlIHN1cmUgdG8gc2V0IHRoZSBzdGF0ZSBvZiBvdXIgaGlzdG9yeSBzdGFjayBwcm9wZXJseQoJCQl0aGlzLmhpc3RvcnkuZGlyZWN0KHsKCQkJCXVybDogaGFzaCwKCgkJCQkvLyBXaGVuIHRoZSB1cmwgaXMgZWl0aGVyIGZvcndhcmQgb3IgYmFja3dhcmQgaW4gaGlzdG9yeSBpbmNsdWRlIHRoZSBlbnRyeQoJCQkJLy8gYXMgZGF0YSBvbiB0aGUgZXZlbnQgb2JqZWN0IGZvciBtZXJnaW5nIGFzIGRhdGEgaW4gdGhlIG5hdmlnYXRlIGV2ZW50CgkJCQlwcmVzZW50OiBmdW5jdGlvbiggaGlzdG9yeUVudHJ5LCBkaXJlY3Rpb24gKSB7CgkJCQkJLy8gbWFrZSBzdXJlIHRvIGNyZWF0ZSBhIG5ldyBvYmplY3QgdG8gcGFzcyBkb3duIGFzIHRoZSBuYXZpZ2F0ZSBldmVudCBkYXRhCgkJCQkJZXZlbnQuaGFzaGNoYW5nZVN0YXRlID0gJC5leHRlbmQoe30sIGhpc3RvcnlFbnRyeSk7CgkJCQkJZXZlbnQuaGFzaGNoYW5nZVN0YXRlLmRpcmVjdGlvbiA9IGRpcmVjdGlvbjsKCQkJCX0sCgoJCQkJLy8gV2hlbiB3ZSBkb24ndCBmaW5kIGEgaGFzaCBpbiBvdXIgaGlzdG9yeSBjbGVhcmx5IHdlJ3JlIGFpbWluZyB0byBnbyB0aGVyZQoJCQkJLy8gcmVjb3JkIHRoZSBlbnRyeSBhcyBuZXcgZm9yIGZ1dHVyZSB0cmF2ZXJzYWwKCQkJCS8vCgkJCQkvLyBOT1RFIGl0J3Mgbm90IGVudGlyZWx5IGNsZWFyIHRoYXQgdGhpcyBpcyB0aGUgcmlnaHQgdGhpbmcgdG8gZG8gZ2l2ZW4gdGhhdCB3ZQoJCQkJLy8gICAgICBjYW4ndCBrbm93IHRoZSB1c2VycyBpbnRlbnRpb24uIEl0IG1pZ2h0IGJlIGJldHRlciB0byBleHBsaWNpdGx5IF9ub3RfCgkJCQkvLyAgICAgIHN1cHBvcnQgbG9jYXRpb24uaGFzaCBhc3NpZ25tZW50IGluIHByZWZlcmVuY2UgdG8gJC5uYXZpZ2F0ZSBjYWxscwoJCQkJLy8gVE9ETyBmaXJzdCBhcmcgdG8gYWRkIHNob3VsZCBiZSB0aGUgaHJlZiwgYnV0IGl0IGNhdXNlcyBpc3N1ZXMgaW4gaWRlbnRpZnlpbmcKCQkJCS8vICAgICAgZW1iZWRlZCBwYWdlcwoJCQkJbWlzc2luZzogZnVuY3Rpb24oKSB7CgkJCQkJaGlzdG9yeS5hZGQoIGhhc2gsIHsKCQkJCQkJaGFzaDogaGFzaCwKCQkJCQkJdGl0bGU6IGRvY3VtZW50LnRpdGxlCgkJCQkJfSk7CgkJCQl9CgkJCX0pOwoJCX0KCX0pOwp9KSggalF1ZXJ5ICk7CgoKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoJLy8gVE9ETyBjb25zaWRlciBxdWV1ZWluZyBuYXZpZ2F0aW9uIGFjdGl2aXR5IHVudGlsIHByZXZpb3VzIGFjdGl2aXRpZXMgaGF2ZSBjb21wbGV0ZWQKCS8vICAgICAgc28gdGhhdCBlbmQgdXNlcnMgZG9uJ3QgaGF2ZSB0byB0aGluayBhYm91dCBpdC4gUHVudGluZyBmb3Igbm93CgkvLyBUT0RPICEhIG1vdmUgdGhlIGV2ZW50IGJpbmRpbmdzIGludG8gY2FsbGJhY2tzIG9uIHRoZSBuYXZpZ2F0ZSBldmVudAoJJC5tb2JpbGUubmF2aWdhdGUgPSBmdW5jdGlvbiggdXJsLCBkYXRhLCBub0V2ZW50cyApIHsKCQkkLm1vYmlsZS5uYXZpZ2F0ZS5uYXZpZ2F0b3IuZ28oIHVybCwgZGF0YSwgbm9FdmVudHMgKTsKCX07CgoJLy8gZXhwb3NlIHRoZSBoaXN0b3J5IG9uIHRoZSBuYXZpZ2F0ZSBtZXRob2QgaW4gYW50aWNpcGF0aW9uIG9mIGZ1bGwgaW50ZWdyYXRpb24gd2l0aAoJLy8gZXhpc3RpbmcgbmF2aWdhdGlvbiBmdW5jdGlvbmFsdHkgdGhhdCBpcyB0aWdodGx5IGNvdXBsZWQgdG8gdGhlIGhpc3RvcnkgaW5mb3JtYXRpb24KCSQubW9iaWxlLm5hdmlnYXRlLmhpc3RvcnkgPSBuZXcgJC5tb2JpbGUuSGlzdG9yeSgpOwoKCS8vIGluc3RhbnRpYXRlIGFuIGluc3RhbmNlIG9mIHRoZSBuYXZpZ2F0b3IgZm9yIHVzZSB3aXRoaW4gdGhlICQubmF2aWdhdGUgbWV0aG9kCgkkLm1vYmlsZS5uYXZpZ2F0ZS5uYXZpZ2F0b3IgPSBuZXcgJC5tb2JpbGUuTmF2aWdhdG9yKCAkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5ICk7CgoJdmFyIGxvYyA9ICQubW9iaWxlLnBhdGgucGFyc2VMb2NhdGlvbigpOwoJJC5tb2JpbGUubmF2aWdhdGUuaGlzdG9yeS5hZGQoIGxvYy5ocmVmLCB7aGFzaDogbG9jLmhhc2h9ICk7Cn0pKCBqUXVlcnkgKTsKCgovLyBUaGlzIHBsdWdpbiBpcyBhbiBleHBlcmltZW50IGZvciBhYnN0cmFjdGluZyBhd2F5IHRoZSB0b3VjaCBhbmQgbW91c2UKLy8gZXZlbnRzIHNvIHRoYXQgZGV2ZWxvcGVycyBkb24ndCBoYXZlIHRvIHdvcnJ5IGFib3V0IHdoaWNoIG1ldGhvZCBvZiBpbnB1dAovLyB0aGUgZGV2aWNlIHRoZWlyIGRvY3VtZW50IGlzIGxvYWRlZCBvbiBzdXBwb3J0cy4KLy8KLy8gVGhlIGlkZWEgaGVyZSBpcyB0byBhbGxvdyB0aGUgZGV2ZWxvcGVyIHRvIHJlZ2lzdGVyIGxpc3RlbmVycyBmb3IgdGhlCi8vIGJhc2ljIG1vdXNlIGV2ZW50cywgc3VjaCBhcyBtb3VzZWRvd24sIG1vdXNlbW92ZSwgbW91c2V1cCwgYW5kIGNsaWNrLAovLyBhbmQgdGhlIHBsdWdpbiB3aWxsIHRha2UgY2FyZSBvZiByZWdpc3RlcmluZyB0aGUgY29ycmVjdCBsaXN0ZW5lcnMKLy8gYmVoaW5kIHRoZSBzY2VuZXMgdG8gaW52b2tlIHRoZSBsaXN0ZW5lciBhdCB0aGUgZmFzdGVzdCBwb3NzaWJsZSB0aW1lCi8vIGZvciB0aGF0IGRldmljZSwgd2hpbGUgc3RpbGwgcmV0YWluaW5nIHRoZSBvcmRlciBvZiBldmVudCBmaXJpbmcgaW4KLy8gdGhlIHRyYWRpdGlvbmFsIG1vdXNlIGVudmlyb25tZW50LCBzaG91bGQgbXVsdGlwbGUgaGFuZGxlcnMgYmUgcmVnaXN0ZXJlZAovLyBvbiB0aGUgc2FtZSBlbGVtZW50IGZvciBkaWZmZXJlbnQgZXZlbnRzLgovLwovLyBUaGUgY3VycmVudCB2ZXJzaW9uIGV4cG9zZXMgdGhlIGZvbGxvd2luZyB2aXJ0dWFsIGV2ZW50cyB0byBqUXVlcnkgYmluZCBtZXRob2RzOgovLyAidm1vdXNlb3ZlciB2bW91c2Vkb3duIHZtb3VzZW1vdmUgdm1vdXNldXAgdmNsaWNrIHZtb3VzZW91dCB2bW91c2VjYW5jZWwiCgooZnVuY3Rpb24oICQsIHdpbmRvdywgZG9jdW1lbnQsIHVuZGVmaW5lZCApIHsKCnZhciBkYXRhUHJvcGVydHlOYW1lID0gInZpcnR1YWxNb3VzZUJpbmRpbmdzIiwKCXRvdWNoVGFyZ2V0UHJvcGVydHlOYW1lID0gInZpcnR1YWxUb3VjaElEIiwKCXZpcnR1YWxFdmVudE5hbWVzID0gInZtb3VzZW92ZXIgdm1vdXNlZG93biB2bW91c2Vtb3ZlIHZtb3VzZXVwIHZjbGljayB2bW91c2VvdXQgdm1vdXNlY2FuY2VsIi5zcGxpdCggIiAiICksCgl0b3VjaEV2ZW50UHJvcHMgPSAiY2xpZW50WCBjbGllbnRZIHBhZ2VYIHBhZ2VZIHNjcmVlblggc2NyZWVuWSIuc3BsaXQoICIgIiApLAoJbW91c2VIb29rUHJvcHMgPSAkLmV2ZW50Lm1vdXNlSG9va3MgPyAkLmV2ZW50Lm1vdXNlSG9va3MucHJvcHMgOiBbXSwKCW1vdXNlRXZlbnRQcm9wcyA9ICQuZXZlbnQucHJvcHMuY29uY2F0KCBtb3VzZUhvb2tQcm9wcyApLAoJYWN0aXZlRG9jSGFuZGxlcnMgPSB7fSwKCXJlc2V0VGltZXJJRCA9IDAsCglzdGFydFggPSAwLAoJc3RhcnRZID0gMCwKCWRpZFNjcm9sbCA9IGZhbHNlLAoJY2xpY2tCbG9ja0xpc3QgPSBbXSwKCWJsb2NrTW91c2VUcmlnZ2VycyA9IGZhbHNlLAoJYmxvY2tUb3VjaFRyaWdnZXJzID0gZmFsc2UsCglldmVudENhcHR1cmVTdXBwb3J0ZWQgPSAiYWRkRXZlbnRMaXN0ZW5lciIgaW4gZG9jdW1lbnQsCgkkZG9jdW1lbnQgPSAkKCBkb2N1bWVudCApLAoJbmV4dFRvdWNoSUQgPSAxLAoJbGFzdFRvdWNoSUQgPSAwLCB0aHJlc2hvbGQsCglpOwoKJC52bW91c2UgPSB7Cgltb3ZlRGlzdGFuY2VUaHJlc2hvbGQ6IDEwLAoJY2xpY2tEaXN0YW5jZVRocmVzaG9sZDogMTAsCglyZXNldFRpbWVyRHVyYXRpb246IDE1MDAKfTsKCmZ1bmN0aW9uIGdldE5hdGl2ZUV2ZW50KCBldmVudCApIHsKCgl3aGlsZSAoIGV2ZW50ICYmIHR5cGVvZiBldmVudC5vcmlnaW5hbEV2ZW50ICE9PSAidW5kZWZpbmVkIiApIHsKCQlldmVudCA9IGV2ZW50Lm9yaWdpbmFsRXZlbnQ7Cgl9CglyZXR1cm4gZXZlbnQ7Cn0KCmZ1bmN0aW9uIGNyZWF0ZVZpcnR1YWxFdmVudCggZXZlbnQsIGV2ZW50VHlwZSApIHsKCgl2YXIgdCA9IGV2ZW50LnR5cGUsCgkJb2UsIHByb3BzLCBuZSwgcHJvcCwgY3QsIHRvdWNoLCBpLCBqLCBsZW47CgoJZXZlbnQgPSAkLkV2ZW50KCBldmVudCApOwoJZXZlbnQudHlwZSA9IGV2ZW50VHlwZTsKCglvZSA9IGV2ZW50Lm9yaWdpbmFsRXZlbnQ7Cglwcm9wcyA9ICQuZXZlbnQucHJvcHM7CgoJLy8gYWRkcmVzc2VzIHNlcGFyYXRpb24gb2YgJC5ldmVudC5wcm9wcyBpbiB0byAkLmV2ZW50Lm1vdXNlSG9vay5wcm9wcyBhbmQgSXNzdWUgMzI4MAoJLy8gaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnktbW9iaWxlL2lzc3Vlcy8zMjgwCglpZiAoIHQuc2VhcmNoKCAvXihtb3VzZXxjbGljaykvICkgPiAtMSApIHsKCQlwcm9wcyA9IG1vdXNlRXZlbnRQcm9wczsKCX0KCgkvLyBjb3B5IG9yaWdpbmFsIGV2ZW50IHByb3BlcnRpZXMgb3ZlciB0byB0aGUgbmV3IGV2ZW50CgkvLyB0aGlzIHdvdWxkIGhhcHBlbiBpZiB3ZSBjb3VsZCBjYWxsICQuZXZlbnQuZml4IGluc3RlYWQgb2YgJC5FdmVudAoJLy8gYnV0IHdlIGRvbid0IGhhdmUgYSB3YXkgdG8gZm9yY2UgYW4gZXZlbnQgdG8gYmUgZml4ZWQgbXVsdGlwbGUgdGltZXMKCWlmICggb2UgKSB7CgkJZm9yICggaSA9IHByb3BzLmxlbmd0aCwgcHJvcDsgaTsgKSB7CgkJCXByb3AgPSBwcm9wc1sgLS1pIF07CgkJCWV2ZW50WyBwcm9wIF0gPSBvZVsgcHJvcCBdOwoJCX0KCX0KCgkvLyBtYWtlIHN1cmUgdGhhdCBpZiB0aGUgbW91c2UgYW5kIGNsaWNrIHZpcnR1YWwgZXZlbnRzIGFyZSBnZW5lcmF0ZWQKCS8vIHdpdGhvdXQgYSAud2hpY2ggb25lIGlzIGRlZmluZWQKCWlmICggdC5zZWFyY2goL21vdXNlKGRvd258dXApfGNsaWNrLykgPiAtMSAmJiAhZXZlbnQud2hpY2ggKSB7CgkJZXZlbnQud2hpY2ggPSAxOwoJfQoKCWlmICggdC5zZWFyY2goL150b3VjaC8pICE9PSAtMSApIHsKCQluZSA9IGdldE5hdGl2ZUV2ZW50KCBvZSApOwoJCXQgPSBuZS50b3VjaGVzOwoJCWN0ID0gbmUuY2hhbmdlZFRvdWNoZXM7CgkJdG91Y2ggPSAoIHQgJiYgdC5sZW5ndGggKSA/IHRbMF0gOiAoICggY3QgJiYgY3QubGVuZ3RoICkgPyBjdFsgMCBdIDogdW5kZWZpbmVkICk7CgoJCWlmICggdG91Y2ggKSB7CgkJCWZvciAoIGogPSAwLCBsZW4gPSB0b3VjaEV2ZW50UHJvcHMubGVuZ3RoOyBqIDwgbGVuOyBqKyspIHsKCQkJCXByb3AgPSB0b3VjaEV2ZW50UHJvcHNbIGogXTsKCQkJCWV2ZW50WyBwcm9wIF0gPSB0b3VjaFsgcHJvcCBdOwoJCQl9CgkJfQoJfQoKCXJldHVybiBldmVudDsKfQoKZnVuY3Rpb24gZ2V0VmlydHVhbEJpbmRpbmdGbGFncyggZWxlbWVudCApIHsKCgl2YXIgZmxhZ3MgPSB7fSwKCQliLCBrOwoKCXdoaWxlICggZWxlbWVudCApIHsKCgkJYiA9ICQuZGF0YSggZWxlbWVudCwgZGF0YVByb3BlcnR5TmFtZSApOwoKCQlmb3IgKCAgayBpbiBiICkgewoJCQlpZiAoIGJbIGsgXSApIHsKCQkJCWZsYWdzWyBrIF0gPSBmbGFncy5oYXNWaXJ0dWFsQmluZGluZyA9IHRydWU7CgkJCX0KCQl9CgkJZWxlbWVudCA9IGVsZW1lbnQucGFyZW50Tm9kZTsKCX0KCXJldHVybiBmbGFnczsKfQoKZnVuY3Rpb24gZ2V0Q2xvc2VzdEVsZW1lbnRXaXRoVmlydHVhbEJpbmRpbmcoIGVsZW1lbnQsIGV2ZW50VHlwZSApIHsKCXZhciBiOwoJd2hpbGUgKCBlbGVtZW50ICkgewoKCQliID0gJC5kYXRhKCBlbGVtZW50LCBkYXRhUHJvcGVydHlOYW1lICk7CgoJCWlmICggYiAmJiAoICFldmVudFR5cGUgfHwgYlsgZXZlbnRUeXBlIF0gKSApIHsKCQkJcmV0dXJuIGVsZW1lbnQ7CgkJfQoJCWVsZW1lbnQgPSBlbGVtZW50LnBhcmVudE5vZGU7Cgl9CglyZXR1cm4gbnVsbDsKfQoKZnVuY3Rpb24gZW5hYmxlVG91Y2hCaW5kaW5ncygpIHsKCWJsb2NrVG91Y2hUcmlnZ2VycyA9IGZhbHNlOwp9CgpmdW5jdGlvbiBkaXNhYmxlVG91Y2hCaW5kaW5ncygpIHsKCWJsb2NrVG91Y2hUcmlnZ2VycyA9IHRydWU7Cn0KCmZ1bmN0aW9uIGVuYWJsZU1vdXNlQmluZGluZ3MoKSB7CglsYXN0VG91Y2hJRCA9IDA7CgljbGlja0Jsb2NrTGlzdC5sZW5ndGggPSAwOwoJYmxvY2tNb3VzZVRyaWdnZXJzID0gZmFsc2U7CgoJLy8gV2hlbiBtb3VzZSBiaW5kaW5ncyBhcmUgZW5hYmxlZCwgb3VyCgkvLyB0b3VjaCBiaW5kaW5ncyBhcmUgZGlzYWJsZWQuCglkaXNhYmxlVG91Y2hCaW5kaW5ncygpOwp9CgpmdW5jdGlvbiBkaXNhYmxlTW91c2VCaW5kaW5ncygpIHsKCS8vIFdoZW4gbW91c2UgYmluZGluZ3MgYXJlIGRpc2FibGVkLCBvdXIKCS8vIHRvdWNoIGJpbmRpbmdzIGFyZSBlbmFibGVkLgoJZW5hYmxlVG91Y2hCaW5kaW5ncygpOwp9CgpmdW5jdGlvbiBzdGFydFJlc2V0VGltZXIoKSB7CgljbGVhclJlc2V0VGltZXIoKTsKCXJlc2V0VGltZXJJRCA9IHNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCXJlc2V0VGltZXJJRCA9IDA7CgkJZW5hYmxlTW91c2VCaW5kaW5ncygpOwoJfSwgJC52bW91c2UucmVzZXRUaW1lckR1cmF0aW9uICk7Cn0KCmZ1bmN0aW9uIGNsZWFyUmVzZXRUaW1lcigpIHsKCWlmICggcmVzZXRUaW1lcklEICkgewoJCWNsZWFyVGltZW91dCggcmVzZXRUaW1lcklEICk7CgkJcmVzZXRUaW1lcklEID0gMDsKCX0KfQoKZnVuY3Rpb24gdHJpZ2dlclZpcnR1YWxFdmVudCggZXZlbnRUeXBlLCBldmVudCwgZmxhZ3MgKSB7Cgl2YXIgdmU7CgoJaWYgKCAoIGZsYWdzICYmIGZsYWdzWyBldmVudFR5cGUgXSApIHx8CgkJCQkoICFmbGFncyAmJiBnZXRDbG9zZXN0RWxlbWVudFdpdGhWaXJ0dWFsQmluZGluZyggZXZlbnQudGFyZ2V0LCBldmVudFR5cGUgKSApICkgewoKCQl2ZSA9IGNyZWF0ZVZpcnR1YWxFdmVudCggZXZlbnQsIGV2ZW50VHlwZSApOwoKCQkkKCBldmVudC50YXJnZXQpLnRyaWdnZXIoIHZlICk7Cgl9CgoJcmV0dXJuIHZlOwp9CgpmdW5jdGlvbiBtb3VzZUV2ZW50Q2FsbGJhY2soIGV2ZW50ICkgewoJdmFyIHRvdWNoSUQgPSAkLmRhdGEoIGV2ZW50LnRhcmdldCwgdG91Y2hUYXJnZXRQcm9wZXJ0eU5hbWUgKSwKCQl2ZTsKCglpZiAoICFibG9ja01vdXNlVHJpZ2dlcnMgJiYgKCAhbGFzdFRvdWNoSUQgfHwgbGFzdFRvdWNoSUQgIT09IHRvdWNoSUQgKSApIHsKCQl2ZSA9IHRyaWdnZXJWaXJ0dWFsRXZlbnQoICJ2IiArIGV2ZW50LnR5cGUsIGV2ZW50ICk7CgkJaWYgKCB2ZSApIHsKCQkJaWYgKCB2ZS5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCX0KCQkJaWYgKCB2ZS5pc1Byb3BhZ2F0aW9uU3RvcHBlZCgpICkgewoJCQkJZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7CgkJCX0KCQkJaWYgKCB2ZS5pc0ltbWVkaWF0ZVByb3BhZ2F0aW9uU3RvcHBlZCgpICkgewoJCQkJZXZlbnQuc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uKCk7CgkJCX0KCQl9Cgl9Cn0KCmZ1bmN0aW9uIGhhbmRsZVRvdWNoU3RhcnQoIGV2ZW50ICkgewoKCXZhciB0b3VjaGVzID0gZ2V0TmF0aXZlRXZlbnQoIGV2ZW50ICkudG91Y2hlcywKCQl0YXJnZXQsIGZsYWdzLCB0OwoKCWlmICggdG91Y2hlcyAmJiB0b3VjaGVzLmxlbmd0aCA9PT0gMSApIHsKCgkJdGFyZ2V0ID0gZXZlbnQudGFyZ2V0OwoJCWZsYWdzID0gZ2V0VmlydHVhbEJpbmRpbmdGbGFncyggdGFyZ2V0ICk7CgoJCWlmICggZmxhZ3MuaGFzVmlydHVhbEJpbmRpbmcgKSB7CgoJCQlsYXN0VG91Y2hJRCA9IG5leHRUb3VjaElEKys7CgkJCSQuZGF0YSggdGFyZ2V0LCB0b3VjaFRhcmdldFByb3BlcnR5TmFtZSwgbGFzdFRvdWNoSUQgKTsKCgkJCWNsZWFyUmVzZXRUaW1lcigpOwoKCQkJZGlzYWJsZU1vdXNlQmluZGluZ3MoKTsKCQkJZGlkU2Nyb2xsID0gZmFsc2U7CgoJCQl0ID0gZ2V0TmF0aXZlRXZlbnQoIGV2ZW50ICkudG91Y2hlc1sgMCBdOwoJCQlzdGFydFggPSB0LnBhZ2VYOwoJCQlzdGFydFkgPSB0LnBhZ2VZOwoKCQkJdHJpZ2dlclZpcnR1YWxFdmVudCggInZtb3VzZW92ZXIiLCBldmVudCwgZmxhZ3MgKTsKCQkJdHJpZ2dlclZpcnR1YWxFdmVudCggInZtb3VzZWRvd24iLCBldmVudCwgZmxhZ3MgKTsKCQl9Cgl9Cn0KCmZ1bmN0aW9uIGhhbmRsZVNjcm9sbCggZXZlbnQgKSB7CglpZiAoIGJsb2NrVG91Y2hUcmlnZ2VycyApIHsKCQlyZXR1cm47Cgl9CgoJaWYgKCAhZGlkU2Nyb2xsICkgewoJCXRyaWdnZXJWaXJ0dWFsRXZlbnQoICJ2bW91c2VjYW5jZWwiLCBldmVudCwgZ2V0VmlydHVhbEJpbmRpbmdGbGFncyggZXZlbnQudGFyZ2V0ICkgKTsKCX0KCglkaWRTY3JvbGwgPSB0cnVlOwoJc3RhcnRSZXNldFRpbWVyKCk7Cn0KCmZ1bmN0aW9uIGhhbmRsZVRvdWNoTW92ZSggZXZlbnQgKSB7CglpZiAoIGJsb2NrVG91Y2hUcmlnZ2VycyApIHsKCQlyZXR1cm47Cgl9CgoJdmFyIHQgPSBnZXROYXRpdmVFdmVudCggZXZlbnQgKS50b3VjaGVzWyAwIF0sCgkJZGlkQ2FuY2VsID0gZGlkU2Nyb2xsLAoJCW1vdmVUaHJlc2hvbGQgPSAkLnZtb3VzZS5tb3ZlRGlzdGFuY2VUaHJlc2hvbGQsCgkJZmxhZ3MgPSBnZXRWaXJ0dWFsQmluZGluZ0ZsYWdzKCBldmVudC50YXJnZXQgKTsKCgkJZGlkU2Nyb2xsID0gZGlkU2Nyb2xsIHx8CgkJCSggTWF0aC5hYnMoIHQucGFnZVggLSBzdGFydFggKSA+IG1vdmVUaHJlc2hvbGQgfHwKCQkJCU1hdGguYWJzKCB0LnBhZ2VZIC0gc3RhcnRZICkgPiBtb3ZlVGhyZXNob2xkICk7CgoKCWlmICggZGlkU2Nyb2xsICYmICFkaWRDYW5jZWwgKSB7CgkJdHJpZ2dlclZpcnR1YWxFdmVudCggInZtb3VzZWNhbmNlbCIsIGV2ZW50LCBmbGFncyApOwoJfQoKCXRyaWdnZXJWaXJ0dWFsRXZlbnQoICJ2bW91c2Vtb3ZlIiwgZXZlbnQsIGZsYWdzICk7CglzdGFydFJlc2V0VGltZXIoKTsKfQoKZnVuY3Rpb24gaGFuZGxlVG91Y2hFbmQoIGV2ZW50ICkgewoJaWYgKCBibG9ja1RvdWNoVHJpZ2dlcnMgKSB7CgkJcmV0dXJuOwoJfQoKCWRpc2FibGVUb3VjaEJpbmRpbmdzKCk7CgoJdmFyIGZsYWdzID0gZ2V0VmlydHVhbEJpbmRpbmdGbGFncyggZXZlbnQudGFyZ2V0ICksCgkJdmUsIHQ7Cgl0cmlnZ2VyVmlydHVhbEV2ZW50KCAidm1vdXNldXAiLCBldmVudCwgZmxhZ3MgKTsKCglpZiAoICFkaWRTY3JvbGwgKSB7CgkJdmUgPSB0cmlnZ2VyVmlydHVhbEV2ZW50KCAidmNsaWNrIiwgZXZlbnQsIGZsYWdzICk7CgkJaWYgKCB2ZSAmJiB2ZS5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJLy8gVGhlIHRhcmdldCBvZiB0aGUgbW91c2UgZXZlbnRzIHRoYXQgZm9sbG93IHRoZSB0b3VjaGVuZAoJCQkvLyBldmVudCBkb24ndCBuZWNlc3NhcmlseSBtYXRjaCB0aGUgdGFyZ2V0IHVzZWQgZHVyaW5nIHRoZQoJCQkvLyB0b3VjaC4gVGhpcyBtZWFucyB3ZSBuZWVkIHRvIHJlbHkgb24gY29vcmRpbmF0ZXMgZm9yIGJsb2NraW5nCgkJCS8vIGFueSBjbGljayB0aGF0IGlzIGdlbmVyYXRlZC4KCQkJdCA9IGdldE5hdGl2ZUV2ZW50KCBldmVudCApLmNoYW5nZWRUb3VjaGVzWyAwIF07CgkJCWNsaWNrQmxvY2tMaXN0LnB1c2goewoJCQkJdG91Y2hJRDogbGFzdFRvdWNoSUQsCgkJCQl4OiB0LmNsaWVudFgsCgkJCQl5OiB0LmNsaWVudFkKCQkJfSk7CgoJCQkvLyBQcmV2ZW50IGFueSBtb3VzZSBldmVudHMgdGhhdCBmb2xsb3cgZnJvbSB0cmlnZ2VyaW5nCgkJCS8vIHZpcnR1YWwgZXZlbnQgbm90aWZpY2F0aW9ucy4KCQkJYmxvY2tNb3VzZVRyaWdnZXJzID0gdHJ1ZTsKCQl9Cgl9Cgl0cmlnZ2VyVmlydHVhbEV2ZW50KCAidm1vdXNlb3V0IiwgZXZlbnQsIGZsYWdzKTsKCWRpZFNjcm9sbCA9IGZhbHNlOwoKCXN0YXJ0UmVzZXRUaW1lcigpOwp9CgpmdW5jdGlvbiBoYXNWaXJ0dWFsQmluZGluZ3MoIGVsZSApIHsKCXZhciBiaW5kaW5ncyA9ICQuZGF0YSggZWxlLCBkYXRhUHJvcGVydHlOYW1lICksCgkJazsKCglpZiAoIGJpbmRpbmdzICkgewoJCWZvciAoIGsgaW4gYmluZGluZ3MgKSB7CgkJCWlmICggYmluZGluZ3NbIGsgXSApIHsKCQkJCXJldHVybiB0cnVlOwoJCQl9CgkJfQoJfQoJcmV0dXJuIGZhbHNlOwp9CgpmdW5jdGlvbiBkdW1teU1vdXNlSGFuZGxlcigpIHt9CgpmdW5jdGlvbiBnZXRTcGVjaWFsRXZlbnRPYmplY3QoIGV2ZW50VHlwZSApIHsKCXZhciByZWFsVHlwZSA9IGV2ZW50VHlwZS5zdWJzdHIoIDEgKTsKCglyZXR1cm4gewoJCXNldHVwOiBmdW5jdGlvbigvKiBkYXRhLCBuYW1lc3BhY2UgKi8pIHsKCQkJLy8gSWYgdGhpcyBpcyB0aGUgZmlyc3QgdmlydHVhbCBtb3VzZSBiaW5kaW5nIGZvciB0aGlzIGVsZW1lbnQsCgkJCS8vIGFkZCBhIGJpbmRpbmdzIG9iamVjdCB0byBpdHMgZGF0YS4KCgkJCWlmICggIWhhc1ZpcnR1YWxCaW5kaW5ncyggdGhpcyApICkgewoJCQkJJC5kYXRhKCB0aGlzLCBkYXRhUHJvcGVydHlOYW1lLCB7fSApOwoJCQl9CgoJCQkvLyBJZiBzZXR1cCBpcyBjYWxsZWQsIHdlIGtub3cgaXQgaXMgdGhlIGZpcnN0IGJpbmRpbmcgZm9yIHRoaXMKCQkJLy8gZXZlbnRUeXBlLCBzbyBpbml0aWFsaXplIHRoZSBjb3VudCBmb3IgdGhlIGV2ZW50VHlwZSB0byB6ZXJvLgoJCQl2YXIgYmluZGluZ3MgPSAkLmRhdGEoIHRoaXMsIGRhdGFQcm9wZXJ0eU5hbWUgKTsKCQkJYmluZGluZ3NbIGV2ZW50VHlwZSBdID0gdHJ1ZTsKCgkJCS8vIElmIHRoaXMgaXMgdGhlIGZpcnN0IHZpcnR1YWwgbW91c2UgZXZlbnQgZm9yIHRoaXMgdHlwZSwKCQkJLy8gcmVnaXN0ZXIgYSBnbG9iYWwgaGFuZGxlciBvbiB0aGUgZG9jdW1lbnQuCgoJCQlhY3RpdmVEb2NIYW5kbGVyc1sgZXZlbnRUeXBlIF0gPSAoIGFjdGl2ZURvY0hhbmRsZXJzWyBldmVudFR5cGUgXSB8fCAwICkgKyAxOwoKCQkJaWYgKCBhY3RpdmVEb2NIYW5kbGVyc1sgZXZlbnRUeXBlIF0gPT09IDEgKSB7CgkJCQkkZG9jdW1lbnQuYmluZCggcmVhbFR5cGUsIG1vdXNlRXZlbnRDYWxsYmFjayApOwoJCQl9CgoJCQkvLyBTb21lIGJyb3dzZXJzLCBsaWtlIE9wZXJhIE1pbmksIHdvbid0IGRpc3BhdGNoIG1vdXNlL2NsaWNrIGV2ZW50cwoJCQkvLyBmb3IgZWxlbWVudHMgdW5sZXNzIHRoZXkgYWN0dWFsbHkgaGF2ZSBoYW5kbGVycyByZWdpc3RlcmVkIG9uIHRoZW0uCgkJCS8vIFRvIGdldCBhcm91bmQgdGhpcywgd2UgcmVnaXN0ZXIgZHVtbXkgaGFuZGxlcnMgb24gdGhlIGVsZW1lbnRzLgoKCQkJJCggdGhpcyApLmJpbmQoIHJlYWxUeXBlLCBkdW1teU1vdXNlSGFuZGxlciApOwoKCQkJLy8gRm9yIG5vdywgaWYgZXZlbnQgY2FwdHVyZSBpcyBub3Qgc3VwcG9ydGVkLCB3ZSByZWx5IG9uIG1vdXNlIGhhbmRsZXJzLgoJCQlpZiAoIGV2ZW50Q2FwdHVyZVN1cHBvcnRlZCApIHsKCQkJCS8vIElmIHRoaXMgaXMgdGhlIGZpcnN0IHZpcnR1YWwgbW91c2UgYmluZGluZyBmb3IgdGhlIGRvY3VtZW50LAoJCQkJLy8gcmVnaXN0ZXIgb3VyIHRvdWNoc3RhcnQgaGFuZGxlciBvbiB0aGUgZG9jdW1lbnQuCgoJCQkJYWN0aXZlRG9jSGFuZGxlcnNbICJ0b3VjaHN0YXJ0IiBdID0gKCBhY3RpdmVEb2NIYW5kbGVyc1sgInRvdWNoc3RhcnQiIF0gfHwgMCkgKyAxOwoKCQkJCWlmICggYWN0aXZlRG9jSGFuZGxlcnNbICJ0b3VjaHN0YXJ0IiBdID09PSAxICkgewoJCQkJCSRkb2N1bWVudC5iaW5kKCAidG91Y2hzdGFydCIsIGhhbmRsZVRvdWNoU3RhcnQgKQoJCQkJCQkuYmluZCggInRvdWNoZW5kIiwgaGFuZGxlVG91Y2hFbmQgKQoKCQkJCQkJLy8gT24gdG91Y2ggcGxhdGZvcm1zLCB0b3VjaGluZyB0aGUgc2NyZWVuIGFuZCB0aGVuIGRyYWdnaW5nIHlvdXIgZmluZ2VyCgkJCQkJCS8vIGNhdXNlcyB0aGUgd2luZG93IGNvbnRlbnQgdG8gc2Nyb2xsIGFmdGVyIHNvbWUgZGlzdGFuY2UgdGhyZXNob2xkIGlzCgkJCQkJCS8vIGV4Y2VlZGVkLiBPbiB0aGVzZSBwbGF0Zm9ybXMsIGEgc2Nyb2xsIHByZXZlbnRzIGEgY2xpY2sgZXZlbnQgZnJvbSBiZWluZwoJCQkJCQkvLyBkaXNwYXRjaGVkLCBhbmQgb24gc29tZSBwbGF0Zm9ybXMsIGV2ZW4gdGhlIHRvdWNoZW5kIGlzIHN1cHByZXNzZWQuIFRvCgkJCQkJCS8vIG1pbWljIHRoZSBzdXBwcmVzc2lvbiBvZiB0aGUgY2xpY2sgZXZlbnQsIHdlIG5lZWQgdG8gd2F0Y2ggZm9yIGEgc2Nyb2xsCgkJCQkJCS8vIGV2ZW50LiBVbmZvcnR1bmF0ZWx5LCBzb21lIHBsYXRmb3JtcyBsaWtlIGlPUyBkb24ndCBkaXNwYXRjaCBzY3JvbGwKCQkJCQkJLy8gZXZlbnRzIHVudGlsICpBRlRFUiogdGhlIHVzZXIgbGlmdHMgdGhlaXIgZmluZ2VyICh0b3VjaGVuZCkuIFRoaXMgbWVhbnMKCQkJCQkJLy8gd2UgbmVlZCB0byB3YXRjaCBib3RoIHNjcm9sbCBhbmQgdG91Y2htb3ZlIGV2ZW50cyB0byBmaWd1cmUgb3V0IHdoZXRoZXIKCQkJCQkJLy8gb3Igbm90IGEgc2Nyb2xsIGhhcHBlbmVucyBiZWZvcmUgdGhlIHRvdWNoZW5kIGV2ZW50IGlzIGZpcmVkLgoKCQkJCQkJLmJpbmQoICJ0b3VjaG1vdmUiLCBoYW5kbGVUb3VjaE1vdmUgKQoJCQkJCQkuYmluZCggInNjcm9sbCIsIGhhbmRsZVNjcm9sbCApOwoJCQkJfQoJCQl9CgkJfSwKCgkJdGVhcmRvd246IGZ1bmN0aW9uKC8qIGRhdGEsIG5hbWVzcGFjZSAqLykgewoJCQkvLyBJZiB0aGlzIGlzIHRoZSBsYXN0IHZpcnR1YWwgYmluZGluZyBmb3IgdGhpcyBldmVudFR5cGUsCgkJCS8vIHJlbW92ZSBpdHMgZ2xvYmFsIGhhbmRsZXIgZnJvbSB0aGUgZG9jdW1lbnQuCgoJCQktLWFjdGl2ZURvY0hhbmRsZXJzWyBldmVudFR5cGUgXTsKCgkJCWlmICggIWFjdGl2ZURvY0hhbmRsZXJzWyBldmVudFR5cGUgXSApIHsKCQkJCSRkb2N1bWVudC51bmJpbmQoIHJlYWxUeXBlLCBtb3VzZUV2ZW50Q2FsbGJhY2sgKTsKCQkJfQoKCQkJaWYgKCBldmVudENhcHR1cmVTdXBwb3J0ZWQgKSB7CgkJCQkvLyBJZiB0aGlzIGlzIHRoZSBsYXN0IHZpcnR1YWwgbW91c2UgYmluZGluZyBpbiBleGlzdGVuY2UsCgkJCQkvLyByZW1vdmUgb3VyIGRvY3VtZW50IHRvdWNoc3RhcnQgbGlzdGVuZXIuCgoJCQkJLS1hY3RpdmVEb2NIYW5kbGVyc1sgInRvdWNoc3RhcnQiIF07CgoJCQkJaWYgKCAhYWN0aXZlRG9jSGFuZGxlcnNbICJ0b3VjaHN0YXJ0IiBdICkgewoJCQkJCSRkb2N1bWVudC51bmJpbmQoICJ0b3VjaHN0YXJ0IiwgaGFuZGxlVG91Y2hTdGFydCApCgkJCQkJCS51bmJpbmQoICJ0b3VjaG1vdmUiLCBoYW5kbGVUb3VjaE1vdmUgKQoJCQkJCQkudW5iaW5kKCAidG91Y2hlbmQiLCBoYW5kbGVUb3VjaEVuZCApCgkJCQkJCS51bmJpbmQoICJzY3JvbGwiLCBoYW5kbGVTY3JvbGwgKTsKCQkJCX0KCQkJfQoKCQkJdmFyICR0aGlzID0gJCggdGhpcyApLAoJCQkJYmluZGluZ3MgPSAkLmRhdGEoIHRoaXMsIGRhdGFQcm9wZXJ0eU5hbWUgKTsKCgkJCS8vIHRlYXJkb3duIG1heSBiZSBjYWxsZWQgd2hlbiBhbiBlbGVtZW50IHdhcwoJCQkvLyByZW1vdmVkIGZyb20gdGhlIERPTS4gSWYgdGhpcyBpcyB0aGUgY2FzZSwKCQkJLy8galF1ZXJ5IGNvcmUgbWF5IGhhdmUgYWxyZWFkeSBzdHJpcHBlZCB0aGUgZWxlbWVudAoJCQkvLyBvZiBhbnkgZGF0YSBiaW5kaW5ncyBzbyB3ZSBuZWVkIHRvIGNoZWNrIGl0IGJlZm9yZQoJCQkvLyB1c2luZyBpdC4KCQkJaWYgKCBiaW5kaW5ncyApIHsKCQkJCWJpbmRpbmdzWyBldmVudFR5cGUgXSA9IGZhbHNlOwoJCQl9CgoJCQkvLyBVbnJlZ2lzdGVyIHRoZSBkdW1teSBldmVudCBoYW5kbGVyLgoKCQkJJHRoaXMudW5iaW5kKCByZWFsVHlwZSwgZHVtbXlNb3VzZUhhbmRsZXIgKTsKCgkJCS8vIElmIHRoaXMgaXMgdGhlIGxhc3QgdmlydHVhbCBtb3VzZSBiaW5kaW5nIG9uIHRoZQoJCQkvLyBlbGVtZW50LCByZW1vdmUgdGhlIGJpbmRpbmcgZGF0YSBmcm9tIHRoZSBlbGVtZW50LgoKCQkJaWYgKCAhaGFzVmlydHVhbEJpbmRpbmdzKCB0aGlzICkgKSB7CgkJCQkkdGhpcy5yZW1vdmVEYXRhKCBkYXRhUHJvcGVydHlOYW1lICk7CgkJCX0KCQl9Cgl9Owp9CgovLyBFeHBvc2Ugb3VyIGN1c3RvbSBldmVudHMgdG8gdGhlIGpRdWVyeSBiaW5kL3VuYmluZCBtZWNoYW5pc20uCgpmb3IgKCBpID0gMDsgaSA8IHZpcnR1YWxFdmVudE5hbWVzLmxlbmd0aDsgaSsrICkgewoJJC5ldmVudC5zcGVjaWFsWyB2aXJ0dWFsRXZlbnROYW1lc1sgaSBdIF0gPSBnZXRTcGVjaWFsRXZlbnRPYmplY3QoIHZpcnR1YWxFdmVudE5hbWVzWyBpIF0gKTsKfQoKLy8gQWRkIGEgY2FwdHVyZSBjbGljayBoYW5kbGVyIHRvIGJsb2NrIGNsaWNrcy4KLy8gTm90ZSB0aGF0IHdlIHJlcXVpcmUgZXZlbnQgY2FwdHVyZSBzdXBwb3J0IGZvciB0aGlzIHNvIGlmIHRoZSBkZXZpY2UKLy8gZG9lc24ndCBzdXBwb3J0IGl0LCB3ZSBwdW50IGZvciBub3cgYW5kIHJlbHkgc29sZWx5IG9uIG1vdXNlIGV2ZW50cy4KaWYgKCBldmVudENhcHR1cmVTdXBwb3J0ZWQgKSB7Cglkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCAiY2xpY2siLCBmdW5jdGlvbiggZSApIHsKCQl2YXIgY250ID0gY2xpY2tCbG9ja0xpc3QubGVuZ3RoLAoJCQl0YXJnZXQgPSBlLnRhcmdldCwKCQkJeCwgeSwgZWxlLCBpLCBvLCB0b3VjaElEOwoKCQlpZiAoIGNudCApIHsKCQkJeCA9IGUuY2xpZW50WDsKCQkJeSA9IGUuY2xpZW50WTsKCQkJdGhyZXNob2xkID0gJC52bW91c2UuY2xpY2tEaXN0YW5jZVRocmVzaG9sZDsKCgkJCS8vIFRoZSBpZGVhIGhlcmUgaXMgdG8gcnVuIHRocm91Z2ggdGhlIGNsaWNrQmxvY2tMaXN0IHRvIHNlZSBpZgoJCQkvLyB0aGUgY3VycmVudCBjbGljayBldmVudCBpcyBpbiB0aGUgcHJveGltaXR5IG9mIG9uZSBvZiBvdXIKCQkJLy8gdmNsaWNrIGV2ZW50cyB0aGF0IGhhZCBwcmV2ZW50RGVmYXVsdCgpIGNhbGxlZCBvbiBpdC4gSWYgd2UgZmluZAoJCQkvLyBvbmUsIHRoZW4gd2UgYmxvY2sgdGhlIGNsaWNrLgoJCQkvLwoJCQkvLyBXaHkgZG8gd2UgaGF2ZSB0byByZWx5IG9uIHByb3hpbWl0eT8KCQkJLy8KCQkJLy8gQmVjYXVzZSB0aGUgdGFyZ2V0IG9mIHRoZSB0b3VjaCBldmVudCB0aGF0IHRyaWdnZXJlZCB0aGUgdmNsaWNrCgkJCS8vIGNhbiBiZSBkaWZmZXJlbnQgZnJvbSB0aGUgdGFyZ2V0IG9mIHRoZSBjbGljayBldmVudCBzeW50aGVzaXplZAoJCQkvLyBieSB0aGUgYnJvd3Nlci4gVGhlIHRhcmdldCBvZiBhIG1vdXNlL2NsaWNrIGV2ZW50IHRoYXQgaXMgc3ludGVoc2l6ZWQKCQkJLy8gZnJvbSBhIHRvdWNoIGV2ZW50IHNlZW1zIHRvIGJlIGltcGxlbWVudGF0aW9uIHNwZWNpZmljLiBGb3IgZXhhbXBsZSwKCQkJLy8gc29tZSBicm93c2VycyB3aWxsIGZpcmUgbW91c2UvY2xpY2sgZXZlbnRzIGZvciBhIGxpbmsgdGhhdCBpcyBuZWFyCgkJCS8vIGEgdG91Y2ggZXZlbnQsIGV2ZW4gdGhvdWdoIHRoZSB0YXJnZXQgb2YgdGhlIHRvdWNoc3RhcnQvdG91Y2hlbmQgZXZlbnQKCQkJLy8gc2F5cyB0aGUgdXNlciB0b3VjaGVkIG91dHNpZGUgdGhlIGxpbmsuIEFsc28sIGl0IHNlZW1zIHRoYXQgd2l0aCBtb3N0CgkJCS8vIGJyb3dzZXJzLCB0aGUgdGFyZ2V0IG9mIHRoZSBtb3VzZS9jbGljayBldmVudCBpcyBub3QgY2FsY3VsYXRlZCB1bnRpbCB0aGUKCQkJLy8gdGltZSBpdCBpcyBkaXNwYXRjaGVkLCBzbyBpZiB5b3UgcmVwbGFjZSBhbiBlbGVtZW50IHRoYXQgeW91IHRvdWNoZWQKCQkJLy8gd2l0aCBhbm90aGVyIGVsZW1lbnQsIHRoZSB0YXJnZXQgb2YgdGhlIG1vdXNlL2NsaWNrIHdpbGwgYmUgdGhlIG5ldwoJCQkvLyBlbGVtZW50IHVuZGVybmVhdGggdGhhdCBwb2ludC4KCQkJLy8KCQkJLy8gQXNpZGUgZnJvbSBwcm94aW1pdHksIHdlIGFsc28gY2hlY2sgdG8gc2VlIGlmIHRoZSB0YXJnZXQgYW5kIGFueQoJCQkvLyBvZiBpdHMgYW5jZXN0b3JzIHdlcmUgdGhlIG9uZXMgdGhhdCBibG9ja2VkIGEgY2xpY2suIFRoaXMgaXMgbmVjZXNzYXJ5CgkJCS8vIGJlY2F1c2Ugb2YgdGhlIHN0cmFuZ2UgbW91c2UvY2xpY2sgdGFyZ2V0IGNhbGN1bGF0aW9uIGRvbmUgaW4gdGhlCgkJCS8vIEFuZHJvaWQgMi4xIGJyb3dzZXIsIHdoZXJlIGlmIHlvdSBjbGljayBvbiBhbiBlbGVtZW50LCBhbmQgdGhlcmUgaXMgYQoJCQkvLyBtb3VzZS9jbGljayBoYW5kbGVyIG9uIG9uZSBvZiBpdHMgYW5jZXN0b3JzLCB0aGUgdGFyZ2V0IHdpbGwgYmUgdGhlCgkJCS8vIGlubmVybW9zdCBjaGlsZCBvZiB0aGUgdG91Y2hlZCBlbGVtZW50LCBldmVuIGlmIHRoYXQgY2hpbGQgaXMgbm8gd2hlcmUKCQkJLy8gbmVhciB0aGUgcG9pbnQgb2YgdG91Y2guCgoJCQllbGUgPSB0YXJnZXQ7CgoJCQl3aGlsZSAoIGVsZSApIHsKCQkJCWZvciAoIGkgPSAwOyBpIDwgY250OyBpKysgKSB7CgkJCQkJbyA9IGNsaWNrQmxvY2tMaXN0WyBpIF07CgkJCQkJdG91Y2hJRCA9IDA7CgoJCQkJCWlmICggKCBlbGUgPT09IHRhcmdldCAmJiBNYXRoLmFicyggby54IC0geCApIDwgdGhyZXNob2xkICYmIE1hdGguYWJzKCBvLnkgLSB5ICkgPCB0aHJlc2hvbGQgKSB8fAoJCQkJCQkJCSQuZGF0YSggZWxlLCB0b3VjaFRhcmdldFByb3BlcnR5TmFtZSApID09PSBvLnRvdWNoSUQgKSB7CgkJCQkJCS8vIFhYWDogV2UgbWF5IHdhbnQgdG8gY29uc2lkZXIgcmVtb3ZpbmcgbWF0Y2hlcyBmcm9tIHRoZSBibG9jayBsaXN0CgkJCQkJCS8vICAgICAgaW5zdGVhZCBvZiB3YWl0aW5nIGZvciB0aGUgcmVzZXQgdGltZXIgdG8gZmlyZS4KCQkJCQkJZS5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJCQllLnN0b3BQcm9wYWdhdGlvbigpOwoJCQkJCQlyZXR1cm47CgkJCQkJfQoJCQkJfQoJCQkJZWxlID0gZWxlLnBhcmVudE5vZGU7CgkJCX0KCQl9Cgl9LCB0cnVlKTsKfQp9KSggalF1ZXJ5LCB3aW5kb3csIGRvY3VtZW50ICk7CgoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCXZhciAkZG9jdW1lbnQgPSAkKCBkb2N1bWVudCApLAoJCXN1cHBvcnRUb3VjaCA9ICQubW9iaWxlLnN1cHBvcnQudG91Y2gsCgkJc2Nyb2xsRXZlbnQgPSAidG91Y2htb3ZlIHNjcm9sbCIsCgkJdG91Y2hTdGFydEV2ZW50ID0gc3VwcG9ydFRvdWNoID8gInRvdWNoc3RhcnQiIDogIm1vdXNlZG93biIsCgkJdG91Y2hTdG9wRXZlbnQgPSBzdXBwb3J0VG91Y2ggPyAidG91Y2hlbmQiIDogIm1vdXNldXAiLAoJCXRvdWNoTW92ZUV2ZW50ID0gc3VwcG9ydFRvdWNoID8gInRvdWNobW92ZSIgOiAibW91c2Vtb3ZlIjsKCgkvLyBzZXR1cCBuZXcgZXZlbnQgc2hvcnRjdXRzCgkkLmVhY2goICggInRvdWNoc3RhcnQgdG91Y2htb3ZlIHRvdWNoZW5kICIgKwoJCSJ0YXAgdGFwaG9sZCAiICsKCQkic3dpcGUgc3dpcGVsZWZ0IHN3aXBlcmlnaHQgIiArCgkJInNjcm9sbHN0YXJ0IHNjcm9sbHN0b3AiICkuc3BsaXQoICIgIiApLCBmdW5jdGlvbiggaSwgbmFtZSApIHsKCgkJJC5mblsgbmFtZSBdID0gZnVuY3Rpb24oIGZuICkgewoJCQlyZXR1cm4gZm4gPyB0aGlzLmJpbmQoIG5hbWUsIGZuICkgOiB0aGlzLnRyaWdnZXIoIG5hbWUgKTsKCQl9OwoKCQkvLyBqUXVlcnkgPCAxLjgKCQlpZiAoICQuYXR0ckZuICkgewoJCQkkLmF0dHJGblsgbmFtZSBdID0gdHJ1ZTsKCQl9Cgl9KTsKCglmdW5jdGlvbiB0cmlnZ2VyQ3VzdG9tRXZlbnQoIG9iaiwgZXZlbnRUeXBlLCBldmVudCApIHsKCQl2YXIgb3JpZ2luYWxUeXBlID0gZXZlbnQudHlwZTsKCQlldmVudC50eXBlID0gZXZlbnRUeXBlOwoJCSQuZXZlbnQuZGlzcGF0Y2guY2FsbCggb2JqLCBldmVudCApOwoJCWV2ZW50LnR5cGUgPSBvcmlnaW5hbFR5cGU7Cgl9CgoJLy8gYWxzbyBoYW5kbGVzIHNjcm9sbHN0b3AKCSQuZXZlbnQuc3BlY2lhbC5zY3JvbGxzdGFydCA9IHsKCgkJZW5hYmxlZDogdHJ1ZSwKCQlzZXR1cDogZnVuY3Rpb24oKSB7CgoJCQl2YXIgdGhpc09iamVjdCA9IHRoaXMsCgkJCQkkdGhpcyA9ICQoIHRoaXNPYmplY3QgKSwKCQkJCXNjcm9sbGluZywKCQkJCXRpbWVyOwoKCQkJZnVuY3Rpb24gdHJpZ2dlciggZXZlbnQsIHN0YXRlICkgewoJCQkJc2Nyb2xsaW5nID0gc3RhdGU7CgkJCQl0cmlnZ2VyQ3VzdG9tRXZlbnQoIHRoaXNPYmplY3QsIHNjcm9sbGluZyA/ICJzY3JvbGxzdGFydCIgOiAic2Nyb2xsc3RvcCIsIGV2ZW50ICk7CgkJCX0KCgkJCS8vIGlQaG9uZSB0cmlnZ2VycyBzY3JvbGwgYWZ0ZXIgYSBzbWFsbCBkZWxheTsgdXNlIHRvdWNobW92ZSBpbnN0ZWFkCgkJCSR0aGlzLmJpbmQoIHNjcm9sbEV2ZW50LCBmdW5jdGlvbiggZXZlbnQgKSB7CgoJCQkJaWYgKCAhJC5ldmVudC5zcGVjaWFsLnNjcm9sbHN0YXJ0LmVuYWJsZWQgKSB7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICggIXNjcm9sbGluZyApIHsKCQkJCQl0cmlnZ2VyKCBldmVudCwgdHJ1ZSApOwoJCQkJfQoKCQkJCWNsZWFyVGltZW91dCggdGltZXIgKTsKCQkJCXRpbWVyID0gc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQkJdHJpZ2dlciggZXZlbnQsIGZhbHNlICk7CgkJCQl9LCA1MCApOwoJCQl9KTsKCQl9LAoJCXRlYXJkb3duOiBmdW5jdGlvbigpIHsKCQkJJCggdGhpcyApLnVuYmluZCggc2Nyb2xsRXZlbnQgKTsKCQl9Cgl9OwoKCS8vIGFsc28gaGFuZGxlcyB0YXBob2xkCgkkLmV2ZW50LnNwZWNpYWwudGFwID0gewoJCXRhcGhvbGRUaHJlc2hvbGQ6IDc1MCwKCQllbWl0VGFwT25UYXBob2xkOiB0cnVlLAoJCXNldHVwOiBmdW5jdGlvbigpIHsKCQkJdmFyIHRoaXNPYmplY3QgPSB0aGlzLAoJCQkJJHRoaXMgPSAkKCB0aGlzT2JqZWN0ICksCgkJCQlpc1RhcGhvbGQgPSBmYWxzZTsKCgkJCSR0aGlzLmJpbmQoICJ2bW91c2Vkb3duIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJaXNUYXBob2xkID0gZmFsc2U7CgkJCQlpZiAoIGV2ZW50LndoaWNoICYmIGV2ZW50LndoaWNoICE9PSAxICkgewoJCQkJCXJldHVybiBmYWxzZTsKCQkJCX0KCgkJCQl2YXIgb3JpZ1RhcmdldCA9IGV2ZW50LnRhcmdldCwKCQkJCQl0aW1lcjsKCgkJCQlmdW5jdGlvbiBjbGVhclRhcFRpbWVyKCkgewoJCQkJCWNsZWFyVGltZW91dCggdGltZXIgKTsKCQkJCX0KCgkJCQlmdW5jdGlvbiBjbGVhclRhcEhhbmRsZXJzKCkgewoJCQkJCWNsZWFyVGFwVGltZXIoKTsKCgkJCQkJJHRoaXMudW5iaW5kKCAidmNsaWNrIiwgY2xpY2tIYW5kbGVyICkKCQkJCQkJLnVuYmluZCggInZtb3VzZXVwIiwgY2xlYXJUYXBUaW1lciApOwoJCQkJCSRkb2N1bWVudC51bmJpbmQoICJ2bW91c2VjYW5jZWwiLCBjbGVhclRhcEhhbmRsZXJzICk7CgkJCQl9CgoJCQkJZnVuY3Rpb24gY2xpY2tIYW5kbGVyKCBldmVudCApIHsKCQkJCQljbGVhclRhcEhhbmRsZXJzKCk7CgoJCQkJCS8vIE9OTFkgdHJpZ2dlciBhICd0YXAnIGV2ZW50IGlmIHRoZSBzdGFydCB0YXJnZXQgaXMKCQkJCQkvLyB0aGUgc2FtZSBhcyB0aGUgc3RvcCB0YXJnZXQuCgkJCQkJaWYgKCAhaXNUYXBob2xkICYmIG9yaWdUYXJnZXQgPT09IGV2ZW50LnRhcmdldCApIHsKCQkJCQkJdHJpZ2dlckN1c3RvbUV2ZW50KCB0aGlzT2JqZWN0LCAidGFwIiwgZXZlbnQgKTsKCQkJCQl9IGVsc2UgaWYgKCBpc1RhcGhvbGQgKSB7CgkJCQkJCWV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOwoJCQkJCX0KCQkJCX0KCgkJCQkkdGhpcy5iaW5kKCAidm1vdXNldXAiLCBjbGVhclRhcFRpbWVyICkKCQkJCQkuYmluZCggInZjbGljayIsIGNsaWNrSGFuZGxlciApOwoJCQkJJGRvY3VtZW50LmJpbmQoICJ2bW91c2VjYW5jZWwiLCBjbGVhclRhcEhhbmRsZXJzICk7CgoJCQkJdGltZXIgPSBzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJCQlpZiAoICEkLmV2ZW50LnNwZWNpYWwudGFwLmVtaXRUYXBPblRhcGhvbGQgKSB7CgkJCQkJCWlzVGFwaG9sZCA9IHRydWU7CgkJCQkJfQoJCQkJCXRyaWdnZXJDdXN0b21FdmVudCggdGhpc09iamVjdCwgInRhcGhvbGQiLCAkLkV2ZW50KCAidGFwaG9sZCIsIHsgdGFyZ2V0OiBvcmlnVGFyZ2V0IH0gKSApOwoJCQkJfSwgJC5ldmVudC5zcGVjaWFsLnRhcC50YXBob2xkVGhyZXNob2xkICk7CgkJCX0pOwoJCX0sCgkJdGVhcmRvd246IGZ1bmN0aW9uKCkgewoJCQkkKCB0aGlzICkudW5iaW5kKCAidm1vdXNlZG93biIgKS51bmJpbmQoICJ2Y2xpY2siICkudW5iaW5kKCAidm1vdXNldXAiICk7CgkJCSRkb2N1bWVudC51bmJpbmQoICJ2bW91c2VjYW5jZWwiICk7CgkJfQoJfTsKCgkvLyBhbHNvIGhhbmRsZXMgc3dpcGVsZWZ0LCBzd2lwZXJpZ2h0CgkkLmV2ZW50LnNwZWNpYWwuc3dpcGUgPSB7CgkJc2Nyb2xsU3VwcmVzc2lvblRocmVzaG9sZDogMzAsIC8vIE1vcmUgdGhhbiB0aGlzIGhvcml6b250YWwgZGlzcGxhY2VtZW50LCBhbmQgd2Ugd2lsbCBzdXBwcmVzcyBzY3JvbGxpbmcuCgoJCWR1cmF0aW9uVGhyZXNob2xkOiAxMDAwLCAvLyBNb3JlIHRpbWUgdGhhbiB0aGlzLCBhbmQgaXQgaXNuJ3QgYSBzd2lwZS4KCgkJaG9yaXpvbnRhbERpc3RhbmNlVGhyZXNob2xkOiAzMCwgIC8vIFN3aXBlIGhvcml6b250YWwgZGlzcGxhY2VtZW50IG11c3QgYmUgbW9yZSB0aGFuIHRoaXMuCgoJCXZlcnRpY2FsRGlzdGFuY2VUaHJlc2hvbGQ6IDc1LCAgLy8gU3dpcGUgdmVydGljYWwgZGlzcGxhY2VtZW50IG11c3QgYmUgbGVzcyB0aGFuIHRoaXMuCgoJCXN0YXJ0OiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciBkYXRhID0gZXZlbnQub3JpZ2luYWxFdmVudC50b3VjaGVzID8KCQkJCQlldmVudC5vcmlnaW5hbEV2ZW50LnRvdWNoZXNbIDAgXSA6IGV2ZW50OwoJCQlyZXR1cm4gewoJCQkJCQl0aW1lOiAoIG5ldyBEYXRlKCkgKS5nZXRUaW1lKCksCgkJCQkJCWNvb3JkczogWyBkYXRhLnBhZ2VYLCBkYXRhLnBhZ2VZIF0sCgkJCQkJCW9yaWdpbjogJCggZXZlbnQudGFyZ2V0ICkKCQkJCQl9OwoJCX0sCgoJCXN0b3A6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdmFyIGRhdGEgPSBldmVudC5vcmlnaW5hbEV2ZW50LnRvdWNoZXMgPwoJCQkJCWV2ZW50Lm9yaWdpbmFsRXZlbnQudG91Y2hlc1sgMCBdIDogZXZlbnQ7CgkJCXJldHVybiB7CgkJCQkJCXRpbWU6ICggbmV3IERhdGUoKSApLmdldFRpbWUoKSwKCQkJCQkJY29vcmRzOiBbIGRhdGEucGFnZVgsIGRhdGEucGFnZVkgXQoJCQkJCX07CgkJfSwKCgkJaGFuZGxlU3dpcGU6IGZ1bmN0aW9uKCBzdGFydCwgc3RvcCwgdGhpc09iamVjdCwgb3JpZ1RhcmdldCApIHsKCQkJaWYgKCBzdG9wLnRpbWUgLSBzdGFydC50aW1lIDwgJC5ldmVudC5zcGVjaWFsLnN3aXBlLmR1cmF0aW9uVGhyZXNob2xkICYmCgkJCQlNYXRoLmFicyggc3RhcnQuY29vcmRzWyAwIF0gLSBzdG9wLmNvb3Jkc1sgMCBdICkgPiAkLmV2ZW50LnNwZWNpYWwuc3dpcGUuaG9yaXpvbnRhbERpc3RhbmNlVGhyZXNob2xkICYmCgkJCQlNYXRoLmFicyggc3RhcnQuY29vcmRzWyAxIF0gLSBzdG9wLmNvb3Jkc1sgMSBdICkgPCAkLmV2ZW50LnNwZWNpYWwuc3dpcGUudmVydGljYWxEaXN0YW5jZVRocmVzaG9sZCApIHsKCQkJCXZhciBkaXJlY3Rpb24gPSBzdGFydC5jb29yZHNbMF0gPiBzdG9wLmNvb3Jkc1sgMCBdID8gInN3aXBlbGVmdCIgOiAic3dpcGVyaWdodCI7CgoJCQkJdHJpZ2dlckN1c3RvbUV2ZW50KCB0aGlzT2JqZWN0LCAic3dpcGUiLCAkLkV2ZW50KCAic3dpcGUiLCB7IHRhcmdldDogb3JpZ1RhcmdldCwgc3dpcGVzdGFydDogc3RhcnQsIHN3aXBlc3RvcDogc3RvcCB9KSApOwoJCQkJdHJpZ2dlckN1c3RvbUV2ZW50KCB0aGlzT2JqZWN0LCBkaXJlY3Rpb24sJC5FdmVudCggZGlyZWN0aW9uLCB7IHRhcmdldDogb3JpZ1RhcmdldCwgc3dpcGVzdGFydDogc3RhcnQsIHN3aXBlc3RvcDogc3RvcCB9ICkgKTsKCQkJCXJldHVybiB0cnVlOwoJCQl9CgkJCXJldHVybiBmYWxzZTsKCgkJfSwKCgkJc2V0dXA6IGZ1bmN0aW9uKCkgewoJCQl2YXIgdGhpc09iamVjdCA9IHRoaXMsCgkJCQkkdGhpcyA9ICQoIHRoaXNPYmplY3QgKTsKCgkJCSR0aGlzLmJpbmQoIHRvdWNoU3RhcnRFdmVudCwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJdmFyIHN0b3AsCgkJCQkJc3RhcnQgPSAkLmV2ZW50LnNwZWNpYWwuc3dpcGUuc3RhcnQoIGV2ZW50ICksCgkJCQkJb3JpZ1RhcmdldCA9IGV2ZW50LnRhcmdldCwKCQkJCQllbWl0dGVkID0gZmFsc2U7CgoJCQkJZnVuY3Rpb24gbW92ZUhhbmRsZXIoIGV2ZW50ICkgewoJCQkJCWlmICggIXN0YXJ0ICkgewoJCQkJCQlyZXR1cm47CgkJCQkJfQoKCQkJCQlzdG9wID0gJC5ldmVudC5zcGVjaWFsLnN3aXBlLnN0b3AoIGV2ZW50ICk7CgkJCQkJaWYgKCAhZW1pdHRlZCApewoJCQkJCQllbWl0dGVkID0gJC5ldmVudC5zcGVjaWFsLnN3aXBlLmhhbmRsZVN3aXBlKCBzdGFydCwgc3RvcCwgdGhpc09iamVjdCwgb3JpZ1RhcmdldCApOwoJCQkJCX0KCQkJCQkvLyBwcmV2ZW50IHNjcm9sbGluZwoJCQkJCWlmICggTWF0aC5hYnMoIHN0YXJ0LmNvb3Jkc1sgMCBdIC0gc3RvcC5jb29yZHNbIDAgXSApID4gJC5ldmVudC5zcGVjaWFsLnN3aXBlLnNjcm9sbFN1cHJlc3Npb25UaHJlc2hvbGQgKSB7CgkJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQkJfQoJCQkJfQoKCQkJCSR0aGlzLmJpbmQoIHRvdWNoTW92ZUV2ZW50LCBtb3ZlSGFuZGxlciApCgkJCQkJLm9uZSggdG91Y2hTdG9wRXZlbnQsIGZ1bmN0aW9uKCkgewoJCQkJCQllbWl0dGVkID0gdHJ1ZTsKCQkJCQkJJHRoaXMudW5iaW5kKCB0b3VjaE1vdmVFdmVudCwgbW92ZUhhbmRsZXIgKTsKCQkJCX0pOwoJCQl9KTsKCQl9LAoKCQl0ZWFyZG93bjogZnVuY3Rpb24oKSB7CgkJCSQoIHRoaXMgKS51bmJpbmQoIHRvdWNoU3RhcnRFdmVudCApLnVuYmluZCggdG91Y2hNb3ZlRXZlbnQgKS51bmJpbmQoIHRvdWNoU3RvcEV2ZW50ICk7CgkJfQoJfTsKCSQuZWFjaCh7CgkJc2Nyb2xsc3RvcDogInNjcm9sbHN0YXJ0IiwKCQl0YXBob2xkOiAidGFwIiwKCQlzd2lwZWxlZnQ6ICJzd2lwZSIsCgkJc3dpcGVyaWdodDogInN3aXBlIgoJfSwgZnVuY3Rpb24oIGV2ZW50LCBzb3VyY2VFdmVudCApIHsKCgkJJC5ldmVudC5zcGVjaWFsWyBldmVudCBdID0gewoJCQlzZXR1cDogZnVuY3Rpb24oKSB7CgkJCQkkKCB0aGlzICkuYmluZCggc291cmNlRXZlbnQsICQubm9vcCApOwoJCQl9LAoJCQl0ZWFyZG93bjogZnVuY3Rpb24oKSB7CgkJCQkkKCB0aGlzICkudW5iaW5kKCBzb3VyY2VFdmVudCApOwoJCQl9CgkJfTsKCX0pOwoKfSkoIGpRdWVyeSwgdGhpcyApOwoKCgkvLyB0aHJvdHRsZWQgcmVzaXplIGV2ZW50CgkoZnVuY3Rpb24oICQgKSB7CgkJJC5ldmVudC5zcGVjaWFsLnRocm90dGxlZHJlc2l6ZSA9IHsKCQkJc2V0dXA6IGZ1bmN0aW9uKCkgewoJCQkJJCggdGhpcyApLmJpbmQoICJyZXNpemUiLCBoYW5kbGVyICk7CgkJCX0sCgkJCXRlYXJkb3duOiBmdW5jdGlvbigpIHsKCQkJCSQoIHRoaXMgKS51bmJpbmQoICJyZXNpemUiLCBoYW5kbGVyICk7CgkJCX0KCQl9OwoKCQl2YXIgdGhyb3R0bGUgPSAyNTAsCgkJCWhhbmRsZXIgPSBmdW5jdGlvbigpIHsKCQkJCWN1cnIgPSAoIG5ldyBEYXRlKCkgKS5nZXRUaW1lKCk7CgkJCQlkaWZmID0gY3VyciAtIGxhc3RDYWxsOwoKCQkJCWlmICggZGlmZiA+PSB0aHJvdHRsZSApIHsKCgkJCQkJbGFzdENhbGwgPSBjdXJyOwoJCQkJCSQoIHRoaXMgKS50cmlnZ2VyKCAidGhyb3R0bGVkcmVzaXplIiApOwoKCQkJCX0gZWxzZSB7CgoJCQkJCWlmICggaGVsZENhbGwgKSB7CgkJCQkJCWNsZWFyVGltZW91dCggaGVsZENhbGwgKTsKCQkJCQl9CgoJCQkJCS8vIFByb21pc2UgYSBoZWxkIGNhbGwgd2lsbCBzdGlsbCBleGVjdXRlCgkJCQkJaGVsZENhbGwgPSBzZXRUaW1lb3V0KCBoYW5kbGVyLCB0aHJvdHRsZSAtIGRpZmYgKTsKCQkJCX0KCQkJfSwKCQkJbGFzdENhbGwgPSAwLAoJCQloZWxkQ2FsbCwKCQkJY3VyciwKCQkJZGlmZjsKCX0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgd2luZG93ICkgewoJdmFyIHdpbiA9ICQoIHdpbmRvdyApLAoJCWV2ZW50X25hbWUgPSAib3JpZW50YXRpb25jaGFuZ2UiLAoJCWdldF9vcmllbnRhdGlvbiwKCQlsYXN0X29yaWVudGF0aW9uLAoJCWluaXRpYWxfb3JpZW50YXRpb25faXNfbGFuZHNjYXBlLAoJCWluaXRpYWxfb3JpZW50YXRpb25faXNfZGVmYXVsdCwKCQlwb3J0cmFpdF9tYXAgPSB7ICIwIjogdHJ1ZSwgIjE4MCI6IHRydWUgfSwKCQl3dywgd2gsIGxhbmRzY2FwZV90aHJlc2hvbGQ7CgoJLy8gSXQgc2VlbXMgdGhhdCBzb21lIGRldmljZS9icm93c2VyIHZlbmRvcnMgdXNlIHdpbmRvdy5vcmllbnRhdGlvbiB2YWx1ZXMgMCBhbmQgMTgwIHRvCgkvLyBkZW5vdGUgdGhlICJkZWZhdWx0IiBvcmllbnRhdGlvbi4gRm9yIGlPUyBkZXZpY2VzLCBhbmQgbW9zdCBvdGhlciBzbWFydC1waG9uZXMgdGVzdGVkLAoJLy8gdGhlIGRlZmF1bHQgb3JpZW50YXRpb24gaXMgYWx3YXlzICJwb3J0cmFpdCIsIGJ1dCBpbiBzb21lIEFuZHJvaWQgYW5kIFJJTSBiYXNlZCB0YWJsZXRzLAoJLy8gdGhlIGRlZmF1bHQgb3JpZW50YXRpb24gaXMgImxhbmRzY2FwZSIuIFRoZSBmb2xsb3dpbmcgY29kZSBhdHRlbXB0cyB0byB1c2UgdGhlIHdpbmRvdwoJLy8gZGltZW5zaW9ucyB0byBmaWd1cmUgb3V0IHdoYXQgdGhlIGN1cnJlbnQgb3JpZW50YXRpb24gaXMsIGFuZCB0aGVuIG1ha2VzIGFkanVzdG1lbnRzCgkvLyB0byB0aGUgdG8gdGhlIHBvcnRyYWl0X21hcCBpZiBuZWNlc3NhcnksIHNvIHRoYXQgd2UgY2FuIHByb3Blcmx5IGRlY29kZSB0aGUKCS8vIHdpbmRvdy5vcmllbnRhdGlvbiB2YWx1ZSB3aGVuZXZlciBnZXRfb3JpZW50YXRpb24oKSBpcyBjYWxsZWQuCgkvLwoJLy8gTm90ZSB0aGF0IHdlIHVzZWQgdG8gdXNlIGEgbWVkaWEgcXVlcnkgdG8gZmlndXJlIG91dCB3aGF0IHRoZSBvcmllbnRhdGlvbiB0aGUgYnJvd3NlcgoJLy8gdGhpbmtzIGl0IGlzIGluOgoJLy8KCS8vICAgICBpbml0aWFsX29yaWVudGF0aW9uX2lzX2xhbmRzY2FwZSA9ICQubW9iaWxlLm1lZGlhKCJhbGwgYW5kIChvcmllbnRhdGlvbjogbGFuZHNjYXBlKSIpOwoJLy8KCS8vIGJ1dCB0aGVyZSB3YXMgYW4gaVBob25lL2lQb2QgVG91Y2ggYnVnIGJlZ2lubmluZyB3aXRoIGlPUyA0LjIsIHVwIHRocm91Z2ggaU9TIDUuMSwKCS8vIHdoZXJlIHRoZSBicm93c2VyICpBTFdBWVMqIGFwcGxpZWQgdGhlIGxhbmRzY2FwZSBtZWRpYSBxdWVyeS4gVGhpcyBidWcgZG9lcyBub3QKCS8vIGhhcHBlbiBvbiBpUGFkLgoKCWlmICggJC5zdXBwb3J0Lm9yaWVudGF0aW9uICkgewoKCQkvLyBDaGVjayB0aGUgd2luZG93IHdpZHRoIGFuZCBoZWlnaHQgdG8gZmlndXJlIG91dCB3aGF0IHRoZSBjdXJyZW50IG9yaWVudGF0aW9uCgkJLy8gb2YgdGhlIGRldmljZSBpcyBhdCB0aGlzIG1vbWVudC4gTm90ZSB0aGF0IHdlJ3ZlIGluaXRpYWxpemVkIHRoZSBwb3J0cmFpdCBtYXAKCQkvLyB2YWx1ZXMgdG8gMCBhbmQgMTgwLCAqQU5EKiB3ZSBwdXJwb3NlbHkgY2hlY2sgZm9yIGxhbmRzY2FwZSBzbyB0aGF0IGlmIHdlIGd1ZXNzCgkJLy8gd3JvbmcsICwgd2UgZGVmYXVsdCB0byB0aGUgYXNzdW1wdGlvbiB0aGF0IHBvcnRyYWl0IGlzIHRoZSBkZWZhdWx0IG9yaWVudGF0aW9uLgoJCS8vIFdlIHVzZSBhIHRocmVzaG9sZCBjaGVjayBiZWxvdyBiZWNhdXNlIG9uIHNvbWUgcGxhdGZvcm1zIGxpa2UgaU9TLCB0aGUgaVBob25lCgkJLy8gZm9ybS1mYWN0b3IgY2FuIHJlcG9ydCBhIGxhcmdlciB3aWR0aCB0aGFuIGhlaWdodCBpZiB0aGUgdXNlciB0dXJucyBvbiB0aGUKCQkvLyBkZXZlbG9wZXIgY29uc29sZS4gVGhlIGFjdHVhbCB0aHJlc2hvbGQgdmFsdWUgaXMgc29tZXdoYXQgYXJiaXRyYXJ5LCB3ZSBqdXN0CgkJLy8gbmVlZCB0byBtYWtlIHN1cmUgaXQgaXMgbGFyZ2UgZW5vdWdoIHRvIGV4Y2x1ZGUgdGhlIGRldmVsb3BlciBjb25zb2xlIGNhc2UuCgoJCXd3ID0gd2luZG93LmlubmVyV2lkdGggfHwgd2luLndpZHRoKCk7CgkJd2ggPSB3aW5kb3cuaW5uZXJIZWlnaHQgfHwgd2luLmhlaWdodCgpOwoJCWxhbmRzY2FwZV90aHJlc2hvbGQgPSA1MDsKCgkJaW5pdGlhbF9vcmllbnRhdGlvbl9pc19sYW5kc2NhcGUgPSB3dyA+IHdoICYmICggd3cgLSB3aCApID4gbGFuZHNjYXBlX3RocmVzaG9sZDsKCgoJCS8vIE5vdyBjaGVjayB0byBzZWUgaWYgdGhlIGN1cnJlbnQgd2luZG93Lm9yaWVudGF0aW9uIGlzIDAgb3IgMTgwLgoJCWluaXRpYWxfb3JpZW50YXRpb25faXNfZGVmYXVsdCA9IHBvcnRyYWl0X21hcFsgd2luZG93Lm9yaWVudGF0aW9uIF07CgoJCS8vIElmIHRoZSBpbml0aWFsIG9yaWVudGF0aW9uIGlzIGxhbmRzY2FwZSwgYnV0IHdpbmRvdy5vcmllbnRhdGlvbiByZXBvcnRzIDAgb3IgMTgwLCAqT1IqCgkJLy8gaWYgdGhlIGluaXRpYWwgb3JpZW50YXRpb24gaXMgcG9ydHJhaXQsIGJ1dCB3aW5kb3cub3JpZW50YXRpb24gcmVwb3J0cyA5MCBvciAtOTAsIHdlCgkJLy8gbmVlZCB0byBmbGlwIG91ciBwb3J0cmFpdF9tYXAgdmFsdWVzIGJlY2F1c2UgbGFuZHNjYXBlIGlzIHRoZSBkZWZhdWx0IG9yaWVudGF0aW9uIGZvcgoJCS8vIHRoaXMgZGV2aWNlL2Jyb3dzZXIuCgkJaWYgKCAoIGluaXRpYWxfb3JpZW50YXRpb25faXNfbGFuZHNjYXBlICYmIGluaXRpYWxfb3JpZW50YXRpb25faXNfZGVmYXVsdCApIHx8ICggIWluaXRpYWxfb3JpZW50YXRpb25faXNfbGFuZHNjYXBlICYmICFpbml0aWFsX29yaWVudGF0aW9uX2lzX2RlZmF1bHQgKSApIHsKCQkJcG9ydHJhaXRfbWFwID0geyAiLTkwIjogdHJ1ZSwgIjkwIjogdHJ1ZSB9OwoJCX0KCX0KCgkkLmV2ZW50LnNwZWNpYWwub3JpZW50YXRpb25jaGFuZ2UgPSAkLmV4dGVuZCgge30sICQuZXZlbnQuc3BlY2lhbC5vcmllbnRhdGlvbmNoYW5nZSwgewoJCXNldHVwOiBmdW5jdGlvbigpIHsKCQkJLy8gSWYgdGhlIGV2ZW50IGlzIHN1cHBvcnRlZCBuYXRpdmVseSwgcmV0dXJuIGZhbHNlIHNvIHRoYXQgalF1ZXJ5CgkJCS8vIHdpbGwgYmluZCB0byB0aGUgZXZlbnQgdXNpbmcgRE9NIG1ldGhvZHMuCgkJCWlmICggJC5zdXBwb3J0Lm9yaWVudGF0aW9uICYmICEkLmV2ZW50LnNwZWNpYWwub3JpZW50YXRpb25jaGFuZ2UuZGlzYWJsZWQgKSB7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCgkJCS8vIEdldCB0aGUgY3VycmVudCBvcmllbnRhdGlvbiB0byBhdm9pZCBpbml0aWFsIGRvdWJsZS10cmlnZ2VyaW5nLgoJCQlsYXN0X29yaWVudGF0aW9uID0gZ2V0X29yaWVudGF0aW9uKCk7CgoJCQkvLyBCZWNhdXNlIHRoZSBvcmllbnRhdGlvbmNoYW5nZSBldmVudCBkb2Vzbid0IGV4aXN0LCBzaW11bGF0ZSB0aGUKCQkJLy8gZXZlbnQgYnkgdGVzdGluZyB3aW5kb3cgZGltZW5zaW9ucyBvbiByZXNpemUuCgkJCXdpbi5iaW5kKCAidGhyb3R0bGVkcmVzaXplIiwgaGFuZGxlciApOwoJCX0sCgkJdGVhcmRvd246IGZ1bmN0aW9uKCkgewoJCQkvLyBJZiB0aGUgZXZlbnQgaXMgbm90IHN1cHBvcnRlZCBuYXRpdmVseSwgcmV0dXJuIGZhbHNlIHNvIHRoYXQKCQkJLy8galF1ZXJ5IHdpbGwgdW5iaW5kIHRoZSBldmVudCB1c2luZyBET00gbWV0aG9kcy4KCQkJaWYgKCAkLnN1cHBvcnQub3JpZW50YXRpb24gJiYgISQuZXZlbnQuc3BlY2lhbC5vcmllbnRhdGlvbmNoYW5nZS5kaXNhYmxlZCApIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoKCQkJLy8gQmVjYXVzZSB0aGUgb3JpZW50YXRpb25jaGFuZ2UgZXZlbnQgZG9lc24ndCBleGlzdCwgdW5iaW5kIHRoZQoJCQkvLyByZXNpemUgZXZlbnQgaGFuZGxlci4KCQkJd2luLnVuYmluZCggInRocm90dGxlZHJlc2l6ZSIsIGhhbmRsZXIgKTsKCQl9LAoJCWFkZDogZnVuY3Rpb24oIGhhbmRsZU9iaiApIHsKCQkJLy8gU2F2ZSBhIHJlZmVyZW5jZSB0byB0aGUgYm91bmQgZXZlbnQgaGFuZGxlci4KCQkJdmFyIG9sZF9oYW5kbGVyID0gaGFuZGxlT2JqLmhhbmRsZXI7CgoKCQkJaGFuZGxlT2JqLmhhbmRsZXIgPSBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkvLyBNb2RpZnkgZXZlbnQgb2JqZWN0LCBhZGRpbmcgdGhlIC5vcmllbnRhdGlvbiBwcm9wZXJ0eS4KCQkJCWV2ZW50Lm9yaWVudGF0aW9uID0gZ2V0X29yaWVudGF0aW9uKCk7CgoJCQkJLy8gQ2FsbCB0aGUgb3JpZ2luYWxseS1ib3VuZCBldmVudCBoYW5kbGVyIGFuZCByZXR1cm4gaXRzIHJlc3VsdC4KCQkJCXJldHVybiBvbGRfaGFuZGxlci5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgkJCX07CgkJfQoJfSk7CgoJLy8gSWYgdGhlIGV2ZW50IGlzIG5vdCBzdXBwb3J0ZWQgbmF0aXZlbHksIHRoaXMgaGFuZGxlciB3aWxsIGJlIGJvdW5kIHRvCgkvLyB0aGUgd2luZG93IHJlc2l6ZSBldmVudCB0byBzaW11bGF0ZSB0aGUgb3JpZW50YXRpb25jaGFuZ2UgZXZlbnQuCglmdW5jdGlvbiBoYW5kbGVyKCkgewoJCS8vIEdldCB0aGUgY3VycmVudCBvcmllbnRhdGlvbi4KCQl2YXIgb3JpZW50YXRpb24gPSBnZXRfb3JpZW50YXRpb24oKTsKCgkJaWYgKCBvcmllbnRhdGlvbiAhPT0gbGFzdF9vcmllbnRhdGlvbiApIHsKCQkJLy8gVGhlIG9yaWVudGF0aW9uIGhhcyBjaGFuZ2VkLCBzbyB0cmlnZ2VyIHRoZSBvcmllbnRhdGlvbmNoYW5nZSBldmVudC4KCQkJbGFzdF9vcmllbnRhdGlvbiA9IG9yaWVudGF0aW9uOwoJCQl3aW4udHJpZ2dlciggZXZlbnRfbmFtZSApOwoJCX0KCX0KCgkvLyBHZXQgdGhlIGN1cnJlbnQgcGFnZSBvcmllbnRhdGlvbi4gVGhpcyBtZXRob2QgaXMgZXhwb3NlZCBwdWJsaWNseSwgc2hvdWxkIGl0CgkvLyBiZSBuZWVkZWQsIGFzIGpRdWVyeS5ldmVudC5zcGVjaWFsLm9yaWVudGF0aW9uY2hhbmdlLm9yaWVudGF0aW9uKCkKCSQuZXZlbnQuc3BlY2lhbC5vcmllbnRhdGlvbmNoYW5nZS5vcmllbnRhdGlvbiA9IGdldF9vcmllbnRhdGlvbiA9IGZ1bmN0aW9uKCkgewoJCXZhciBpc1BvcnRyYWl0ID0gdHJ1ZSwgZWxlbSA9IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudDsKCgkJLy8gcHJlZmVyIHdpbmRvdyBvcmllbnRhdGlvbiB0byB0aGUgY2FsY3VsYXRpb24gYmFzZWQgb24gc2NyZWVuc2l6ZSBhcwoJCS8vIHRoZSBhY3R1YWwgc2NyZWVuIHJlc2l6ZSB0YWtlcyBwbGFjZSBiZWZvcmUgb3IgYWZ0ZXIgdGhlIG9yaWVudGF0aW9uIGNoYW5nZSBldmVudAoJCS8vIGhhcyBiZWVuIGZpcmVkIGRlcGVuZGluZyBvbiBpbXBsZW1lbnRhdGlvbiAoZWcgYW5kcm9pZCAyLjMgaXMgYmVmb3JlLCBpcGhvbmUgYWZ0ZXIpLgoJCS8vIE1vcmUgdGVzdGluZyBpcyByZXF1aXJlZCB0byBkZXRlcm1pbmUgaWYgYSBtb3JlIHJlbGlhYmxlIG1ldGhvZCBvZiBkZXRlcm1pbmluZyB0aGUgbmV3IHNjcmVlbnNpemUKCQkvLyBpcyBwb3NzaWJsZSB3aGVuIG9yaWVudGF0aW9uY2hhbmdlIGlzIGZpcmVkLiAoZWcsIHVzZSBtZWRpYSBxdWVyaWVzICsgZWxlbWVudCArIG9wYWNpdHkpCgkJaWYgKCAkLnN1cHBvcnQub3JpZW50YXRpb24gKSB7CgkJCS8vIGlmIHRoZSB3aW5kb3cgb3JpZW50YXRpb24gcmVnaXN0ZXJzIGFzIDAgb3IgMTgwIGRlZ3JlZXMgcmVwb3J0CgkJCS8vIHBvcnRyYWl0LCBvdGhlcndpc2UgbGFuZHNjYXBlCgkJCWlzUG9ydHJhaXQgPSBwb3J0cmFpdF9tYXBbIHdpbmRvdy5vcmllbnRhdGlvbiBdOwoJCX0gZWxzZSB7CgkJCWlzUG9ydHJhaXQgPSBlbGVtICYmIGVsZW0uY2xpZW50V2lkdGggLyBlbGVtLmNsaWVudEhlaWdodCA8IDEuMTsKCQl9CgoJCXJldHVybiBpc1BvcnRyYWl0ID8gInBvcnRyYWl0IiA6ICJsYW5kc2NhcGUiOwoJfTsKCgkkLmZuWyBldmVudF9uYW1lIF0gPSBmdW5jdGlvbiggZm4gKSB7CgkJcmV0dXJuIGZuID8gdGhpcy5iaW5kKCBldmVudF9uYW1lLCBmbiApIDogdGhpcy50cmlnZ2VyKCBldmVudF9uYW1lICk7Cgl9OwoKCS8vIGpRdWVyeSA8IDEuOAoJaWYgKCAkLmF0dHJGbiApIHsKCQkkLmF0dHJGblsgZXZlbnRfbmFtZSBdID0gdHJ1ZTsKCX0KCn0oIGpRdWVyeSwgdGhpcyApKTsKCgoKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKCS8vIGV4aXN0aW5nIGJhc2UgdGFnPwoJdmFyIGJhc2VFbGVtZW50ID0gJCggImhlYWQiICkuY2hpbGRyZW4oICJiYXNlIiApLAoKCS8vIGJhc2UgZWxlbWVudCBtYW5hZ2VtZW50LCBkZWZpbmVkIGRlcGVuZGluZyBvbiBkeW5hbWljIGJhc2UgdGFnIHN1cHBvcnQKCS8vIFRPRE8gbW92ZSB0byBleHRlcm5hbCB3aWRnZXQKCWJhc2UgPSB7CgoJCS8vIGRlZmluZSBiYXNlIGVsZW1lbnQsIGZvciB1c2UgaW4gcm91dGluZyBhc3NldCB1cmxzIHRoYXQgYXJlIHJlZmVyZW5jZWQKCQkvLyBpbiBBamF4LXJlcXVlc3RlZCBtYXJrdXAKCQllbGVtZW50OiAoIGJhc2VFbGVtZW50Lmxlbmd0aCA/IGJhc2VFbGVtZW50IDoKCQkJJCggIjxiYXNlPiIsIHsgaHJlZjogJC5tb2JpbGUucGF0aC5kb2N1bWVudEJhc2UuaHJlZk5vSGFzaCB9ICkucHJlcGVuZFRvKCAkKCAiaGVhZCIgKSApICksCgoJCWxpbmtTZWxlY3RvcjogIltzcmNdLCBsaW5rW2hyZWZdLCBhW3JlbD0nZXh0ZXJuYWwnXSwgOmpxbURhdGEoYWpheD0nZmFsc2UnKSwgYVt0YXJnZXRdIiwKCgkJLy8gc2V0IHRoZSBnZW5lcmF0ZWQgQkFTRSBlbGVtZW50J3MgaHJlZiB0byBhIG5ldyBwYWdlJ3MgYmFzZSBwYXRoCgkJc2V0OiBmdW5jdGlvbiggaHJlZiApIHsKCgkJCS8vIHdlIHNob3VsZCBkbyBub3RoaW5nIGlmIHRoZSB1c2VyIHdhbnRzIHRvIG1hbmFnZSB0aGVpciB1cmwgYmFzZQoJCQkvLyBtYW51YWxseQoJCQlpZiAoICEkLm1vYmlsZS5keW5hbWljQmFzZUVuYWJsZWQgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIHdlIHNob3VsZCB1c2UgdGhlIGJhc2UgdGFnIGlmIHdlIGNhbiBtYW5pcHVsYXRlIGl0IGR5bmFtaWNhbGx5CgkJCWlmICggJC5zdXBwb3J0LmR5bmFtaWNCYXNlVGFnICkgewoJCQkJYmFzZS5lbGVtZW50LmF0dHIoICJocmVmIiwKCQkJCQkkLm1vYmlsZS5wYXRoLm1ha2VVcmxBYnNvbHV0ZSggaHJlZiwgJC5tb2JpbGUucGF0aC5kb2N1bWVudEJhc2UgKSApOwoJCQl9CgkJfSwKCgkJcmV3cml0ZTogZnVuY3Rpb24oIGhyZWYsIHBhZ2UgKSB7CgkJCXZhciBuZXdQYXRoID0gJC5tb2JpbGUucGF0aC5nZXQoIGhyZWYgKTsKCgkJCXBhZ2UuZmluZCggYmFzZS5saW5rU2VsZWN0b3IgKS5lYWNoKGZ1bmN0aW9uKCBpLCBsaW5rICkgewoJCQkJdmFyIHRoaXNBdHRyID0gJCggbGluayApLmlzKCAiW2hyZWZdIiApID8gImhyZWYiIDoKCQkJCQkkKCBsaW5rICkuaXMoICJbc3JjXSIgKSA/ICJzcmMiIDogImFjdGlvbiIsCgkJCQl0aGlzVXJsID0gJCggbGluayApLmF0dHIoIHRoaXNBdHRyICk7CgoJCQkJLy8gWFhYX2pibGFzOiBXZSBuZWVkIHRvIGZpeCB0aGlzIHNvIHRoYXQgaXQgcmVtb3ZlcyB0aGUgZG9jdW1lbnQKCQkJCS8vICAgICAgICAgICAgYmFzZSBVUkwsIGFuZCB0aGVuIHByZXBlbmRzIHdpdGggdGhlIG5ldyBwYWdlIFVSTC4KCQkJCS8vIGlmIGZ1bGwgcGF0aCBleGlzdHMgYW5kIGlzIHNhbWUsIGNob3AgaXQgLSBoZWxwcyBJRSBvdXQKCQkJCXRoaXNVcmwgPSB0aGlzVXJsLnJlcGxhY2UoIGxvY2F0aW9uLnByb3RvY29sICsgIi8vIiArCgkJCQkJbG9jYXRpb24uaG9zdCArIGxvY2F0aW9uLnBhdGhuYW1lLCAiIiApOwoKCQkJCWlmICggIS9eKFx3Kzp8I3xcLykvLnRlc3QoIHRoaXNVcmwgKSApIHsKCQkJCQkkKCBsaW5rICkuYXR0ciggdGhpc0F0dHIsIG5ld1BhdGggKyB0aGlzVXJsICk7CgkJCQl9CgkJCX0pOwoJCX0sCgoJCS8vIHNldCB0aGUgZ2VuZXJhdGVkIEJBU0UgZWxlbWVudCdzIGhyZWYgdG8gYSBuZXcgcGFnZSdzIGJhc2UgcGF0aAoJCXJlc2V0OiBmdW5jdGlvbigvKiBocmVmICovKSB7CgkJCWJhc2UuZWxlbWVudC5hdHRyKCAiaHJlZiIsICQubW9iaWxlLnBhdGguZG9jdW1lbnRCYXNlLmhyZWZOb1NlYXJjaCApOwoJCX0KCX07CgoJJC5tb2JpbGUuYmFzZSA9IGJhc2U7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKJC5tb2JpbGUud2lkZ2V0cyA9IHt9OwoKdmFyIG9yaWdpbmFsV2lkZ2V0ID0gJC53aWRnZXQsCgoJLy8gUmVjb3JkIHRoZSBvcmlnaW5hbCwgbm9uLW1vYmlsZWluaXQtbW9kaWZpZWQgdmVyc2lvbiBvZiAkLm1vYmlsZS5rZWVwTmF0aXZlCgkvLyBzbyB3ZSBjYW4gbGF0ZXIgZGV0ZXJtaW5lIHdoZXRoZXIgc29tZW9uZSBoYXMgbW9kaWZpZWQgJC5tb2JpbGUua2VlcE5hdGl2ZQoJa2VlcE5hdGl2ZUZhY3RvcnlEZWZhdWx0ID0gJC5tb2JpbGUua2VlcE5hdGl2ZTsKCiQud2lkZ2V0ID0gKGZ1bmN0aW9uKCBvcmlnICkgewoJcmV0dXJuIGZ1bmN0aW9uKCkgewoJCXZhciBjb25zdHJ1Y3RvciA9IG9yaWcuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApLAoJCQluYW1lID0gY29uc3RydWN0b3IucHJvdG90eXBlLndpZGdldE5hbWU7CgoJCWNvbnN0cnVjdG9yLmluaXRTZWxlY3RvciA9ICggKCBjb25zdHJ1Y3Rvci5wcm90b3R5cGUuaW5pdFNlbGVjdG9yICE9PSB1bmRlZmluZWQgKSA/CgkJCWNvbnN0cnVjdG9yLnByb3RvdHlwZS5pbml0U2VsZWN0b3IgOiAiOmpxbURhdGEocm9sZT0nIiArIG5hbWUgKyAiJykiICk7CgoJCSQubW9iaWxlLndpZGdldHNbIG5hbWUgXSA9IGNvbnN0cnVjdG9yOwoKCQlyZXR1cm4gY29uc3RydWN0b3I7Cgl9Owp9KSggJC53aWRnZXQgKTsKCi8vIE1ha2Ugc3VyZSAkLndpZGdldCBzdGlsbCBoYXMgYnJpZGdlIGFuZCBleHRlbmQgbWV0aG9kcwokLmV4dGVuZCggJC53aWRnZXQsIG9yaWdpbmFsV2lkZ2V0ICk7CgovLyBGb3IgYmFja2NvbXBhdCByZW1vdmUgaW4gMS41CiQubW9iaWxlLmRvY3VtZW50Lm9uKCAiY3JlYXRlIiwgZnVuY3Rpb24oIGV2ZW50ICl7CgkkKCBldmVudC50YXJnZXQgKS5lbmhhbmNlV2l0aGluKCk7Cn0pOwoKJC53aWRnZXQoICJtb2JpbGUucGFnZSIsIHsKCW9wdGlvbnM6IHsKCQl0aGVtZTogImEiLAoJCWRvbUNhY2hlOiBmYWxzZSwKCgkJLy8gRGVwcmVjYXRlZCBpbiAxLjQgcmVtb3ZlIGluIDEuNQoJCWtlZXBOYXRpdmVEZWZhdWx0OiAkLm1vYmlsZS5rZWVwTmF0aXZlLAoJCWNvbnRlbnRUaGVtZTogbnVsbCwKCQllbmhhbmNlZDogZmFsc2UKCX0sCgoJLy8gREVQUkVDQVRFRCBmb3IgPiAxLjQKCS8vIFRPRE8gcmVtb3ZlIGF0IDEuNQoJX2NyZWF0ZVdpZGdldDogZnVuY3Rpb24oKSB7CgkJJC5XaWRnZXQucHJvdG90eXBlLl9jcmVhdGVXaWRnZXQuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwoJCXRoaXMuX3RyaWdnZXIoICJpbml0IiApOwoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQkvLyBJZiBmYWxzZSBpcyByZXR1cm5lZCBieSB0aGUgY2FsbGJhY2tzIGRvIG5vdCBjcmVhdGUgdGhlIHBhZ2UKCQlpZiAoIHRoaXMuX3RyaWdnZXIoICJiZWZvcmVjcmVhdGUiICkgPT09IGZhbHNlICkgewoJCQlyZXR1cm4gZmFsc2U7CgkJfQoKCQlpZiAoICF0aGlzLm9wdGlvbnMuZW5oYW5jZWQgKSB7CgkJCXRoaXMuX2VuaGFuY2UoKTsKCQl9CgoJCXRoaXMuX29uKCB0aGlzLmVsZW1lbnQsIHsKCQkJcGFnZWJlZm9yZWhpZGU6ICJyZW1vdmVDb250YWluZXJCYWNrZ3JvdW5kIiwKCQkJcGFnZWJlZm9yZXNob3c6ICJfaGFuZGxlUGFnZUJlZm9yZVNob3ciCgkJfSk7CgoJCXRoaXMuZWxlbWVudC5lbmhhbmNlV2l0aGluKCk7CgkJLy8gRGlhbG9nIHdpZGdldCBpcyBkZXByZWNhdGVkIGluIDEuNCByZW1vdmUgdGhpcyBpbiAxLjUKCQlpZiggJC5tb2JpbGUuZ2V0QXR0cmlidXRlKCB0aGlzLmVsZW1lbnRbMF0sICJyb2xlIiApID09PSAiZGlhbG9nIiAmJiAkLm1vYmlsZS5kaWFsb2cgKXsKCQkJdGhpcy5lbGVtZW50LmRpYWxvZygpOwoJCX0KCX0sCgoJX2VuaGFuY2U6IGZ1bmN0aW9uICgpewoJCXZhciBhdHRyUHJlZml4ID0gImRhdGEtIiArICQubW9iaWxlLm5zLAoJCQlzZWxmID0gdGhpczsKCgkJaWYgKCB0aGlzLm9wdGlvbnMucm9sZSApIHsKCQkJdGhpcy5lbGVtZW50LmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyb2xlIiwgdGhpcy5vcHRpb25zLnJvbGUgKTsKCQl9CgoJCXRoaXMuZWxlbWVudAoJCQkuYXR0ciggInRhYmluZGV4IiwgIjAiICkKCQkJLmFkZENsYXNzKCAidWktcGFnZSB1aS1wYWdlLXRoZW1lLSIgKyB0aGlzLm9wdGlvbnMudGhlbWUgKTsKCgkJLy8gTWFuaXB1bGF0aW9uIG9mIGNvbnRlbnQgb3MgRGVwcmVjYXRlZCBhcyBvZiAxLjQgcmVtb3ZlIGluIDEuNQoJCXRoaXMuZWxlbWVudC5maW5kKCAiWyIgKyBhdHRyUHJlZml4ICsgInJvbGU9J2NvbnRlbnQnXSIgKS5lYWNoKCBmdW5jdGlvbigpIHsKCQkJdmFyICR0aGlzID0gJCggdGhpcyApLAoJCQkJdGhlbWUgPSB0aGlzLmdldEF0dHJpYnV0ZSggYXR0clByZWZpeCArICJ0aGVtZSIgKSB8fCB1bmRlZmluZWQ7CgkJCQlzZWxmLm9wdGlvbnMuY29udGVudFRoZW1lID0gdGhlbWUgfHwgc2VsZi5vcHRpb25zLmNvbnRlbnRUaGVtZSB8fCAoIHNlbGYub3B0aW9ucy5kaWFsb2cgJiYgc2VsZi5vcHRpb25zLnRoZW1lICkgfHwgKCBzZWxmLmVsZW1lbnQuanFtRGF0YSgicm9sZSIpID09PSAiZGlhbG9nIiAmJiAgc2VsZi5vcHRpb25zLnRoZW1lICk7CgkJCQkkdGhpcy5hZGRDbGFzcyggInVpLWNvbnRlbnQiICk7CgkJCQlpZiAoIHNlbGYub3B0aW9ucy5jb250ZW50VGhlbWUgKSB7CgkJCQkJJHRoaXMuYWRkQ2xhc3MoICJ1aS1ib2R5LSIgKyAoIHNlbGYub3B0aW9ucy5jb250ZW50VGhlbWUgKSApOwoJCQkJfQoJCQkJLy8gQWRkIEFSSUEgcm9sZQoJCQkJJHRoaXMuYXR0ciggInJvbGUiLCAibWFpbiIgKS5hZGRDbGFzcyggInVpLWNvbnRlbnQiICk7CgkJfSk7Cgl9LAoKCWJpbmRSZW1vdmU6IGZ1bmN0aW9uKCBjYWxsYmFjayApIHsKCQl2YXIgcGFnZSA9IHRoaXMuZWxlbWVudDsKCgkJLy8gd2hlbiBkb20gY2FjaGluZyBpcyBub3QgZW5hYmxlZCBvciB0aGUgcGFnZSBpcyBlbWJlZGRlZCBiaW5kIHRvIHJlbW92ZSB0aGUgcGFnZSBvbiBoaWRlCgkJaWYgKCAhcGFnZS5kYXRhKCAibW9iaWxlLXBhZ2UiICkub3B0aW9ucy5kb21DYWNoZSAmJgoJCQlwYWdlLmlzKCAiOmpxbURhdGEoZXh0ZXJuYWwtcGFnZT0ndHJ1ZScpIiApICkgewoKCQkJLy8gVE9ETyB1c2UgX29uIC0gdGhhdCBpcywgc29ydCBvdXQgd2h5IGl0IGRvZXNuJ3Qgd29yayBpbiB0aGlzIGNhc2UKCQkJcGFnZS5iaW5kKCAicGFnZWhpZGUucmVtb3ZlIiwgY2FsbGJhY2sgfHwgZnVuY3Rpb24oLyogZSAqLykgewoJCQkJdmFyICR0aGlzID0gJCggdGhpcyApLAoJCQkJCXByRXZlbnQgPSBuZXcgJC5FdmVudCggInBhZ2VyZW1vdmUiICk7CgoJCQkJJHRoaXMudHJpZ2dlciggcHJFdmVudCApOwoKCQkJCWlmICggIXByRXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKSB7CgkJCQkJJHRoaXMucmVtb3ZlV2l0aERlcGVuZGVudHMoKTsKCQkJCX0KCQkJfSk7CgkJfQoJfSwKCglfc2V0T3B0aW9uczogZnVuY3Rpb24oIG8gKSB7CgkJaWYgKCBvLnRoZW1lICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMuZWxlbWVudC5yZW1vdmVDbGFzcyggInVpLWJvZHktIiArIHRoaXMub3B0aW9ucy50aGVtZSApLmFkZENsYXNzKCAidWktYm9keS0iICsgby50aGVtZSApOwoJCX0KCgkJaWYgKCBvLmNvbnRlbnRUaGVtZSAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLmVsZW1lbnQuZmluZCggIltkYXRhLSIgKyAkLm1vYmlsZS5ucyArICI9J2NvbnRlbnQnXSIgKS5yZW1vdmVDbGFzcyggInVpLWJvZHktIiArIHRoaXMub3B0aW9ucy5jb250ZW50VGhlbWUgKQoJCQkJLmFkZENsYXNzKCAidWktYm9keS0iICsgby5jb250ZW50VGhlbWUgKTsKCQl9Cgl9LAoKCV9oYW5kbGVQYWdlQmVmb3JlU2hvdzogZnVuY3Rpb24oLyogZSAqLykgewoJCXRoaXMuc2V0Q29udGFpbmVyQmFja2dyb3VuZCgpOwoJfSwKCS8vIERlcHJlY2F0ZWQgaW4gMS40IHJlbW92ZSBpbiAxLjUKCXJlbW92ZUNvbnRhaW5lckJhY2tncm91bmQ6IGZ1bmN0aW9uKCkgewoJCXRoaXMuZWxlbWVudC5jbG9zZXN0KCAiOm1vYmlsZS1wYWdlY29udGFpbmVyIiApLnBhZ2Vjb250YWluZXIoeyAidGhlbWUiOiAibm9uZSIgfSk7Cgl9LAoJLy8gRGVwcmVjYXRlZCBpbiAxLjQgcmVtb3ZlIGluIDEuNQoJLy8gc2V0IHRoZSBwYWdlIGNvbnRhaW5lciBiYWNrZ3JvdW5kIHRvIHRoZSBwYWdlIHRoZW1lCglzZXRDb250YWluZXJCYWNrZ3JvdW5kOiBmdW5jdGlvbiggdGhlbWUgKSB7CgkJdGhpcy5lbGVtZW50LnBhcmVudCgpLnBhZ2Vjb250YWluZXIoIHsgInRoZW1lIjogdGhlbWUgfHwgdGhpcy5vcHRpb25zLnRoZW1lIH0gKTsKCX0sCgkvLyBEZXByZWNhdGVkIGluIDEuNCByZW1vdmUgaW4gMS41CglrZWVwTmF0aXZlU2VsZWN0b3I6IGZ1bmN0aW9uKCkgewoJCXZhciBvcHRpb25zID0gdGhpcy5vcHRpb25zLAoJCQlrZWVwTmF0aXZlID0gJC50cmltKCBvcHRpb25zLmtlZXBOYXRpdmUgfHwgIiIgKSwKCQkJZ2xvYmFsVmFsdWUgPSAkLnRyaW0oICQubW9iaWxlLmtlZXBOYXRpdmUgKSwKCQkJb3B0aW9uVmFsdWUgPSAkLnRyaW0oIG9wdGlvbnMua2VlcE5hdGl2ZURlZmF1bHQgKSwKCgkJCS8vIENoZWNrIGlmICQubW9iaWxlLmtlZXBOYXRpdmUgaGFzIGNoYW5nZWQgZnJvbSB0aGUgZmFjdG9yeSBkZWZhdWx0CgkJCW5ld0RlZmF1bHQgPSAoIGtlZXBOYXRpdmVGYWN0b3J5RGVmYXVsdCA9PT0gZ2xvYmFsVmFsdWUgPwoJCQkJIiIgOiBnbG9iYWxWYWx1ZSApLAoKCQkJLy8gSWYgJC5tb2JpbGUua2VlcE5hdGl2ZSBoYXMgbm90IGNoYW5nZWQsIHVzZSBvcHRpb25zLmtlZXBOYXRpdmVEZWZhdWx0CgkJCW9sZERlZmF1bHQgPSAoIG5ld0RlZmF1bHQgPT09ICIiID8gb3B0aW9uVmFsdWUgOiAiIiApOwoKCQkvLyBDb25jYXRlbmF0ZSBrZWVwTmF0aXZlIHNlbGVjdG9ycyBmcm9tIGFsbCBzb3VyY2VzIHdoZXJlIHRoZSB2YWx1ZSBoYXMKCQkvLyBjaGFuZ2VkIG9yLCBpZiBub3RoaW5nIGhhcyBjaGFuZ2VkLCByZXR1cm4gdGhlIGRlZmF1bHQKCQlyZXR1cm4gKCAoIGtlZXBOYXRpdmUgPyBbIGtlZXBOYXRpdmUgXSA6IFtdICkKCQkJLmNvbmNhdCggbmV3RGVmYXVsdCA/IFsgbmV3RGVmYXVsdCBdIDogW10gKQoJCQkuY29uY2F0KCBvbGREZWZhdWx0ID8gWyBvbGREZWZhdWx0IF0gOiBbXSApCgkJCS5qb2luKCAiLCAiICkgKTsKCX0KfSk7Cn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKCSQud2lkZ2V0KCAibW9iaWxlLnBhZ2Vjb250YWluZXIiLCB7CgkJb3B0aW9uczogewoJCQl0aGVtZTogImEiCgkJfSwKCgkJaW5pdFNlbGVjdG9yOiBmYWxzZSwKCgkJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJCXRoaXMuc2V0TGFzdFNjcm9sbEVuYWJsZWQgPSB0cnVlOwoKCQkJLy8gVE9ETyBjb25zaWRlciBtb3ZpbmcgdGhlIG5hdmlnYXRpb24gaGFuZGxlciBPVVQgb2Ygd2lkZ2V0IGludG8KCQkJLy8gICAgICBzb21lIG90aGVyIG9iamVjdCBhcyBnbHVlIGJldHdlZW4gdGhlIG5hdmlnYXRlIGV2ZW50IGFuZCB0aGUKCQkJLy8gICAgICBjb250ZW50IHdpZGdldCBsb2FkIGFuZCBjaGFuZ2UgbWV0aG9kcwoJCQl0aGlzLl9vbiggdGhpcy53aW5kb3csIHsgbmF2aWdhdGU6ICJfZmlsdGVyTmF2aWdhdGVFdmVudHMiIH0pOwoKCQkJdGhpcy5fb24oIHRoaXMud2luZG93LCB7CgkJCQkvLyBkaXNhYmxlIGFuIHNjcm9sbCBzZXR0aW5nIHdoZW4gYSBoYXNoY2hhbmdlIGhhcyBiZWVuIGZpcmVkLAoJCQkJLy8gdGhpcyBvbmx5IHdvcmtzIGJlY2F1c2UgdGhlIHJlY29yZGluZyBvZiB0aGUgc2Nyb2xsIHBvc2l0aW9uCgkJCQkvLyBpcyBkZWxheWVkIGZvciAxMDBtcyBhZnRlciB0aGUgYnJvd3NlciBtaWdodCBoYXZlIGNoYW5nZWQgdGhlCgkJCQkvLyBwb3NpdGlvbiBiZWNhdXNlIG9mIHRoZSBoYXNoY2hhbmdlCgkJCQluYXZpZ2F0ZTogIl9kaXNhYmxlUmVjb3JkU2Nyb2xsIiwKCgkJCQkvLyBiaW5kIHRvIHNjcm9sbHN0b3AgZm9yIHRoZSBmaXJzdCBwYWdlLCAicGFnZWNoYW5nZSIgd29uJ3QgYmUKCQkJCS8vIGZpcmVkIGluIHRoYXQgY2FzZQoJCQkJc2Nyb2xsc3RvcDogIl9kZWxheWVkUmVjb3JkU2Nyb2xsIgoJCQl9KTsKCgkJCS8vIFRPRE8gbW92ZSBmcm9tIHBhZ2UqIGV2ZW50cyB0byBjb250ZW50KiBldmVudHMKCQkJdGhpcy5fb24oeyBwYWdlY2hhbmdlOiAiX2FmdGVyQ29udGVudENoYW5nZSIgfSk7CgoJCQkvLyBoYW5kbGUgaW5pdGlhbCBoYXNoY2hhbmdlIGZyb20gY2hyb21lIDooCgkJCXRoaXMud2luZG93Lm9uZSggIm5hdmlnYXRlIiwgJC5wcm94eShmdW5jdGlvbigpIHsKCQkJCXRoaXMuc2V0TGFzdFNjcm9sbEVuYWJsZWQgPSB0cnVlOwoJCQl9LCB0aGlzKSk7CgkJfSwKCgkJX3NldE9wdGlvbnM6IGZ1bmN0aW9uKCBvcHRpb25zICl7CgkJCWlmICggb3B0aW9ucy50aGVtZSAhPT0gdW5kZWZpbmVkICYmIG9wdGlvbnMudGhlbWUgIT09ICJub25lIiApIHsKCQkJCXRoaXMuZWxlbWVudC5yZW1vdmVDbGFzcyggInVpLW92ZXJsYXktIiArIHRoaXMub3B0aW9ucy50aGVtZSApCgkJCQkJLmFkZENsYXNzKCAidWktb3ZlcmxheS0iICsgb3B0aW9ucy50aGVtZSApOwoJCQl9IGVsc2UgaWYgKCBvcHRpb25zLnRoZW1lICE9PSB1bmRlZmluZWQgKSB7CgkJCQl0aGlzLmVsZW1lbnQucmVtb3ZlQ2xhc3MoICJ1aS1vdmVybGF5LSIgKyB0aGlzLm9wdGlvbnMudGhlbWUgKTsKCQkJfQoKCQkJdGhpcy5fc3VwZXIoIG9wdGlvbnMgKTsKCQl9LAoKCQlfZGlzYWJsZVJlY29yZFNjcm9sbDogZnVuY3Rpb24oKSB7CgkJCXRoaXMuc2V0TGFzdFNjcm9sbEVuYWJsZWQgPSBmYWxzZTsKCQl9LAoKCQlfZW5hYmxlUmVjb3JkU2Nyb2xsOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5zZXRMYXN0U2Nyb2xsRW5hYmxlZCA9IHRydWU7CgkJfSwKCgkJLy8gVE9ETyBjb25zaWRlciB0aGUgbmFtZSBoZXJlLCBzaW5jZSBpdCdzIHB1cnBvc2Ugc3BlY2lmaWMKCQlfYWZ0ZXJDb250ZW50Q2hhbmdlOiBmdW5jdGlvbigpIHsKCQkJLy8gb25jZSB0aGUgcGFnZSBoYXMgY2hhbmdlZCwgcmUtZW5hYmxlIHRoZSBzY3JvbGwgcmVjb3JkaW5nCgkJCXRoaXMuc2V0TGFzdFNjcm9sbEVuYWJsZWQgPSB0cnVlOwoKCQkJLy8gcmVtb3ZlIGFueSBiaW5kaW5nIHRoYXQgcHJldmlvdXNseSBleGlzdGVkIG9uIHRoZSBnZXQgc2Nyb2xsCgkJCS8vIHdoaWNoIG1heSBvciBtYXkgbm90IGJlIGRpZmZlcmVudCB0aGFuIHRoZSBzY3JvbGwgZWxlbWVudAoJCQkvLyBkZXRlcm1pbmVkIGZvciB0aGlzIHBhZ2UgcHJldmlvdXNseQoJCQl0aGlzLl9vZmYoIHRoaXMud2luZG93LCAic2Nyb2xsc3RvcCIgKTsKCgkJCS8vIGRldGVybWluZSBhbmQgYmluZCB0byB0aGUgY3VycmVudCBzY29sbCBlbGVtZW50IHdoaWNoIG1heSBiZSB0aGUKCQkJLy8gd2luZG93IG9yIGluIHRoZSBjYXNlIG9mIHRvdWNoIG92ZXJmbG93IHRoZSBlbGVtZW50IHRvdWNoIG92ZXJmbG93CgkJCXRoaXMuX29uKCB0aGlzLndpbmRvdywgeyBzY3JvbGxzdG9wOiAiX2RlbGF5ZWRSZWNvcmRTY3JvbGwiIH0pOwoJCX0sCgoJCV9yZWNvcmRTY3JvbGw6IGZ1bmN0aW9uKCkgewoJCQkvLyB0aGlzIGJhcnJpZXIgcHJldmVudHMgc2V0dGluZyB0aGUgc2Nyb2xsIHZhbHVlIGJhc2VkIG9uCgkJCS8vIHRoZSBicm93c2VyIHNjcm9sbGluZyB0aGUgd2luZG93IGJhc2VkIG9uIGEgaGFzaGNoYW5nZQoJCQlpZiAoICF0aGlzLnNldExhc3RTY3JvbGxFbmFibGVkICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQl2YXIgYWN0aXZlID0gdGhpcy5fZ2V0QWN0aXZlSGlzdG9yeSgpLAoJCQkJY3VycmVudFNjcm9sbCwgbWluU2Nyb2xsLCBkZWZhdWx0U2Nyb2xsOwoKCQkJaWYgKCBhY3RpdmUgKSB7CgkJCQljdXJyZW50U2Nyb2xsID0gdGhpcy5fZ2V0U2Nyb2xsKCk7CgkJCQltaW5TY3JvbGwgPSB0aGlzLl9nZXRNaW5TY3JvbGwoKTsKCQkJCWRlZmF1bHRTY3JvbGwgPSB0aGlzLl9nZXREZWZhdWx0U2Nyb2xsKCk7CgoJCQkJLy8gU2V0IGFjdGl2ZSBwYWdlJ3MgbGFzdFNjcm9sbCBwcm9wLiBJZiB0aGUgbG9jYXRpb24gd2UncmUKCQkJCS8vIHNjcm9sbGluZyB0byBpcyBsZXNzIHRoYW4gbWluU2Nyb2xsQmFjaywgbGV0IGl0IGdvLgoJCQkJYWN0aXZlLmxhc3RTY3JvbGwgPSBjdXJyZW50U2Nyb2xsIDwgbWluU2Nyb2xsID8gZGVmYXVsdFNjcm9sbCA6IGN1cnJlbnRTY3JvbGw7CgkJCX0KCQl9LAoKCQlfZGVsYXllZFJlY29yZFNjcm9sbDogZnVuY3Rpb24oKSB7CgkJCXNldFRpbWVvdXQoICQucHJveHkodGhpcywgIl9yZWNvcmRTY3JvbGwiKSwgMTAwICk7CgkJfSwKCgkJX2dldFNjcm9sbDogZnVuY3Rpb24oKSB7CgkJCXJldHVybiB0aGlzLndpbmRvdy5zY3JvbGxUb3AoKTsKCQl9LAoKCQlfZ2V0TWluU2Nyb2xsOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuICQubW9iaWxlLm1pblNjcm9sbEJhY2s7CgkJfSwKCgkJX2dldERlZmF1bHRTY3JvbGw6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gJC5tb2JpbGUuZGVmYXVsdEhvbWVTY3JvbGw7CgkJfSwKCgkJX2ZpbHRlck5hdmlnYXRlRXZlbnRzOiBmdW5jdGlvbiggZSwgZGF0YSApIHsKCQkJdmFyIHVybDsKCgkJCWlmICggZS5vcmlnaW5hbEV2ZW50ICYmIGUub3JpZ2luYWxFdmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJdXJsID0gZS5vcmlnaW5hbEV2ZW50LnR5cGUuaW5kZXhPZiggImhhc2hjaGFuZ2UiICkgPiAtMSA/IGRhdGEuc3RhdGUuaGFzaCA6IGRhdGEuc3RhdGUudXJsOwoKCQkJaWYgKCAhdXJsICkgewoJCQkJdXJsID0gdGhpcy5fZ2V0SGFzaCgpOwoJCQl9CgoJCQlpZiAoICF1cmwgfHwgdXJsID09PSAiIyIgfHwgdXJsLmluZGV4T2YoICIjIiArICQubW9iaWxlLnBhdGgudWlTdGF0ZUtleSApID09PSAwICl7CgkJCQl1cmwgPSBsb2NhdGlvbi5ocmVmOwoJCQl9CgoJCQl0aGlzLl9oYW5kbGVOYXZpZ2F0ZSggdXJsLCBkYXRhLnN0YXRlICk7CgkJfSwKCgkJX2dldEhhc2g6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gJC5tb2JpbGUucGF0aC5wYXJzZUxvY2F0aW9uKCkuaGFzaDsKCQl9LAoKCQkvLyBUT0RPIGFjdGl2ZSBwYWdlIHNob3VsZCBiZSBtYW5hZ2VkIGJ5IHRoZSBjb250YWluZXIgKGllLCBpdCBzaG91bGQgYmUgYSBwcm9wZXJ0eSkKCQlnZXRBY3RpdmVQYWdlOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHRoaXMuYWN0aXZlUGFnZTsKCQl9LAoKCQkvLyBUT0RPIHRoZSBmaXJzdCBwYWdlIHNob3VsZCBiZSBhIHByb3BlcnR5IHNldCBkdXJpbmcgX2NyZWF0ZSB1c2luZyB0aGUgbG9naWMKCQkvLyAgICAgIHRoYXQgY3VycmVudGx5IHJlc2lkZXMgaW4gaW5pdAoJCV9nZXRJbml0aWFsQ29udGVudDogZnVuY3Rpb24oKSB7CgkJCXJldHVybiAkLm1vYmlsZS5maXJzdFBhZ2U7CgkJfSwKCgkJLy8gVE9ETyBlYWNoIGNvbnRlbnQgY29udGFpbmVyIHNob3VsZCBoYXZlIGEgaGlzdG9yeSBvYmplY3QKCQlfZ2V0SGlzdG9yeTogZnVuY3Rpb24oKSB7CgkJCXJldHVybiAkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5OwoJCX0sCgoJCS8vIFRPRE8gdXNlIF9nZXRIaXN0b3J5CgkJX2dldEFjdGl2ZUhpc3Rvcnk6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gJC5tb2JpbGUubmF2aWdhdGUuaGlzdG9yeS5nZXRBY3RpdmUoKTsKCQl9LAoKCQkvLyBUT0RPIHRoZSBkb2N1bWVudCBiYXNlIHNob3VsZCBiZSBkZXRlcm1pbmVkIGF0IGNyZWF0aW9uCgkJX2dldERvY3VtZW50QmFzZTogZnVuY3Rpb24oKSB7CgkJCXJldHVybiAkLm1vYmlsZS5wYXRoLmRvY3VtZW50QmFzZTsKCQl9LAoKCQlfYmFjazogZnVuY3Rpb24oKSB7CgkJCSQubW9iaWxlLmJhY2soKTsKCQl9LAoKCQlfZm9yd2FyZDogZnVuY3Rpb24oKSB7CgkJCXdpbmRvdy5oaXN0b3J5LmZvcndhcmQoKTsKCQl9LAoKCQkvLyBUT0RPIHJlbmFtZSBfaGFuZGxlRGVzdGluYXRpb24KCQlfaGFuZGxlRGVzdGluYXRpb246IGZ1bmN0aW9uKCB0byApIHsKCQkJdmFyIGhpc3Rvcnk7CgoJCQkvLyBjbGVhbiB0aGUgaGFzaCBmb3IgY29tcGFyaXNvbiBpZiBpdCdzIGEgdXJsCgkJCWlmICggJC50eXBlKHRvKSA9PT0gInN0cmluZyIgKSB7CgkJCQl0byA9ICQubW9iaWxlLnBhdGguc3RyaXBIYXNoKCB0byApOwoJCQl9CgoJCQlpZiAoIHRvICkgewoJCQkJaGlzdG9yeSA9IHRoaXMuX2dldEhpc3RvcnkoKTsKCgkJCQkvLyBBdCB0aGlzIHBvaW50LCAndG8nIGNhbiBiZSBvbmUgb2YgMyB0aGluZ3MsIGEgY2FjaGVkIHBhZ2UKCQkJCS8vIGVsZW1lbnQgZnJvbSBhIGhpc3Rvcnkgc3RhY2sgZW50cnksIGFuIGlkLCBvciBzaXRlLXJlbGF0aXZlIC8KCQkJCS8vIGFic29sdXRlIFVSTC4gSWYgJ3RvJyBpcyBhbiBpZCwgd2UgbmVlZCB0byByZXNvbHZlIGl0IGFnYWluc3QKCQkJCS8vIHRoZSBkb2N1bWVudEJhc2UsIG5vdCB0aGUgbG9jYXRpb24uaHJlZiwgc2luY2UgdGhlIGhhc2hjaGFuZ2UKCQkJCS8vIGNvdWxkJ3ZlIGJlZW4gdGhlIHJlc3VsdCBvZiBhIGZvcndhcmQvYmFja3dhcmQgbmF2aWdhdGlvbgoJCQkJLy8gdGhhdCBjcm9zc2VzIGZyb20gYW4gZXh0ZXJuYWwgcGFnZS9kaWFsb2cgdG8gYW4gaW50ZXJuYWwKCQkJCS8vIHBhZ2UvZGlhbG9nLgoJCQkJLy8KCQkJCS8vIFRPRE8gbW92ZSBjaGVjayB0byBoaXN0b3J5IG9iamVjdCBvciBwYXRoIG9iamVjdD8KCQkJCXRvID0gISQubW9iaWxlLnBhdGguaXNQYXRoKCB0byApID8gKCAkLm1vYmlsZS5wYXRoLm1ha2VVcmxBYnNvbHV0ZSggIiMiICsgdG8sIHRoaXMuX2dldERvY3VtZW50QmFzZSgpICkgKSA6IHRvOwoKCQkJCS8vIElmIHdlJ3JlIGFib3V0IHRvIGdvIHRvIGFuIGluaXRpYWwgVVJMIHRoYXQgY29udGFpbnMgYQoJCQkJLy8gcmVmZXJlbmNlIHRvIGEgbm9uLWV4aXN0ZW50IGludGVybmFsIHBhZ2UsIGdvIHRvIHRoZSBmaXJzdAoJCQkJLy8gcGFnZSBpbnN0ZWFkLiBXZSBrbm93IHRoYXQgdGhlIGluaXRpYWwgaGFzaCByZWZlcnMgdG8gYQoJCQkJLy8gbm9uLWV4aXN0ZW50IHBhZ2UsIGJlY2F1c2UgdGhlIGluaXRpYWwgaGFzaCBkaWQgbm90IGVuZAoJCQkJLy8gdXAgaW4gdGhlIGluaXRpYWwgaGlzdG9yeSBlbnRyeQoJCQkJLy8gVE9ETyBtb3ZlIGNoZWNrIHRvIGhpc3Rvcnkgb2JqZWN0PwoJCQkJaWYgKCB0byA9PT0gJC5tb2JpbGUucGF0aC5tYWtlVXJsQWJzb2x1dGUoICIjIiArIGhpc3RvcnkuaW5pdGlhbERzdCwgdGhpcy5fZ2V0RG9jdW1lbnRCYXNlKCkgKSAmJgoJCQkJCWhpc3Rvcnkuc3RhY2subGVuZ3RoICYmCgkJCQkJaGlzdG9yeS5zdGFja1swXS51cmwgIT09IGhpc3RvcnkuaW5pdGlhbERzdC5yZXBsYWNlKCAkLm1vYmlsZS5kaWFsb2dIYXNoS2V5LCAiIiApICkgewoJCQkJCXRvID0gdGhpcy5fZ2V0SW5pdGlhbENvbnRlbnQoKTsKCQkJCX0KCQkJfQoJCQlyZXR1cm4gdG8gfHwgdGhpcy5fZ2V0SW5pdGlhbENvbnRlbnQoKTsKCQl9LAoKCQlfaGFuZGxlRGlhbG9nOiBmdW5jdGlvbiggY2hhbmdlUGFnZU9wdGlvbnMsIGRhdGEgKSB7CgkJCXZhciB0bywgYWN0aXZlLCBhY3RpdmVDb250ZW50ID0gdGhpcy5nZXRBY3RpdmVQYWdlKCk7CgoJCQkvLyBJZiBjdXJyZW50IGFjdGl2ZSBwYWdlIGlzIG5vdCBhIGRpYWxvZyBza2lwIHRoZSBkaWFsb2cgYW5kIGNvbnRpbnVlCgkJCS8vIGluIHRoZSBzYW1lIGRpcmVjdGlvbgoJCQlpZiAoIGFjdGl2ZUNvbnRlbnQgJiYgIWFjdGl2ZUNvbnRlbnQuaGFzQ2xhc3MoICJ1aS1kaWFsb2ciICkgKSB7CgkJCQkvLyBkZXRlcm1pbmUgaWYgd2UncmUgaGVhZGluZyBmb3J3YXJkIG9yIGJhY2t3YXJkIGFuZCBjb250aW51ZQoJCQkJLy8gYWNjb3JkaW5nbHkgcGFzdCB0aGUgY3VycmVudCBkaWFsb2cKCQkJCWlmICggZGF0YS5kaXJlY3Rpb24gPT09ICJiYWNrIiApIHsKCQkJCQl0aGlzLl9iYWNrKCk7CgkJCQl9IGVsc2UgewoJCQkJCXRoaXMuX2ZvcndhcmQoKTsKCQkJCX0KCgkJCQkvLyBwcmV2ZW50IGNoYW5nZVBhZ2UgY2FsbAoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9IGVsc2UgewoJCQkJLy8gaWYgdGhlIGN1cnJlbnQgYWN0aXZlIHBhZ2UgaXMgYSBkaWFsb2cgYW5kIHdlJ3JlIG5hdmlnYXRpbmcKCQkJCS8vIHRvIGEgZGlhbG9nIHVzZSB0aGUgZGlhbG9nIG9iamVjdGVkIHNhdmVkIGluIHRoZSBzdGFjawoJCQkJdG8gPSBkYXRhLnBhZ2VVcmw7CgkJCQlhY3RpdmUgPSB0aGlzLl9nZXRBY3RpdmVIaXN0b3J5KCk7CgoJCQkJLy8gbWFrZSBzdXJlIHRvIHNldCB0aGUgcm9sZSwgdHJhbnNpdGlvbiBhbmQgcmV2ZXJzYWwKCQkJCS8vIGFzIG1vc3Qgb2YgdGhpcyBpcyBsb3N0IGJ5IHRoZSBkb21DYWNoZSBjbGVhbmluZwoJCQkJJC5leHRlbmQoIGNoYW5nZVBhZ2VPcHRpb25zLCB7CgkJCQkJcm9sZTogYWN0aXZlLnJvbGUsCgkJCQkJdHJhbnNpdGlvbjogYWN0aXZlLnRyYW5zaXRpb24sCgkJCQkJcmV2ZXJzZTogZGF0YS5kaXJlY3Rpb24gPT09ICJiYWNrIgoJCQkJfSk7CgkJCX0KCgkJCXJldHVybiB0bzsKCQl9LAoKCQlfaGFuZGxlTmF2aWdhdGU6IGZ1bmN0aW9uKCB1cmwsIGRhdGEgKSB7CgkJCS8vZmluZCBmaXJzdCBwYWdlIHZpYSBoYXNoCgkJCS8vIFRPRE8gc3RyaXBwaW5nIHRoZSBoYXNoIHR3aWNlIHdpdGggaGFuZGxlVXJsCgkJCXZhciB0byA9ICQubW9iaWxlLnBhdGguc3RyaXBIYXNoKCB1cmwgKSwgaGlzdG9yeSA9IHRoaXMuX2dldEhpc3RvcnkoKSwKCgkJCQkvLyB0cmFuc2l0aW9uIGlzIGZhbHNlIGlmIGl0J3MgdGhlIGZpcnN0IHBhZ2UsIHVuZGVmaW5lZAoJCQkJLy8gb3RoZXJ3aXNlIChhbmQgbWF5IGJlIG92ZXJyaWRkZW4gYnkgZGVmYXVsdCkKCQkJCXRyYW5zaXRpb24gPSBoaXN0b3J5LnN0YWNrLmxlbmd0aCA9PT0gMCA/ICJub25lIiA6IHVuZGVmaW5lZCwKCgkJCQkvLyBkZWZhdWx0IG9wdGlvbnMgZm9yIHRoZSBjaGFuZ1BhZ2UgY2FsbHMgbWFkZSBhZnRlciBleGFtaW5pbmcKCQkJCS8vIHRoZSBjdXJyZW50IHN0YXRlIG9mIHRoZSBwYWdlIGFuZCB0aGUgaGFzaCwgTk9URSB0aGF0IHRoZQoJCQkJLy8gdHJhbnNpdGlvbiBpcyBkZXJpdmVkIGZyb20gdGhlIHByZXZpb3VzIGhpc3RvcnkgZW50cnkKCQkJCWNoYW5nZVBhZ2VPcHRpb25zID0gewoJCQkJCWNoYW5nZUhhc2g6IGZhbHNlLAoJCQkJCWZyb21IYXNoQ2hhbmdlOiB0cnVlLAoJCQkJCXJldmVyc2U6IGRhdGEuZGlyZWN0aW9uID09PSAiYmFjayIKCQkJCX07CgoJCQkkLmV4dGVuZCggY2hhbmdlUGFnZU9wdGlvbnMsIGRhdGEsIHsKCQkJCXRyYW5zaXRpb246ICggaGlzdG9yeS5nZXRMYXN0KCkgfHwge30gKS50cmFuc2l0aW9uIHx8IHRyYW5zaXRpb24KCQkJfSk7CgoJCQkvLyBUT0RPIG1vdmUgdG8gX2hhbmRsZURlc3RpbmF0aW9uID8KCQkJLy8gSWYgdGhpcyBpc24ndCB0aGUgZmlyc3QgcGFnZSwgaWYgdGhlIGN1cnJlbnQgdXJsIGlzIGEgZGlhbG9nIGhhc2gKCQkJLy8ga2V5LCBhbmQgdGhlIGluaXRpYWwgZGVzdGluYXRpb24gaXNuJ3QgZXF1YWwgdG8gdGhlIGN1cnJlbnQgdGFyZ2V0CgkJCS8vIHBhZ2UsIHVzZSB0aGUgc3BlY2lhbCBkaWFsb2cgaGFuZGxpbmcKCQkJaWYgKCBoaXN0b3J5LmFjdGl2ZUluZGV4ID4gMCAmJgoJCQkJdG8uaW5kZXhPZiggJC5tb2JpbGUuZGlhbG9nSGFzaEtleSApID4gLTEgJiYKCQkJCWhpc3RvcnkuaW5pdGlhbERzdCAhPT0gdG8gKSB7CgoJCQkJdG8gPSB0aGlzLl9oYW5kbGVEaWFsb2coIGNoYW5nZVBhZ2VPcHRpb25zLCBkYXRhICk7CgoJCQkJaWYgKCB0byA9PT0gZmFsc2UgKSB7CgkJCQkJcmV0dXJuOwoJCQkJfQoJCQl9CgoJCQl0aGlzLl9jaGFuZ2VDb250ZW50KCB0aGlzLl9oYW5kbGVEZXN0aW5hdGlvbiggdG8gKSwgY2hhbmdlUGFnZU9wdGlvbnMgKTsKCQl9LAoKCQlfY2hhbmdlQ29udGVudDogZnVuY3Rpb24oIHRvLCBvcHRzICkgewoJCQkkLm1vYmlsZS5jaGFuZ2VQYWdlKCB0bywgb3B0cyApOwoJCX0sCgoJCV9nZXRCYXNlOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuICQubW9iaWxlLmJhc2U7CgkJfSwKCgkJX2dldE5zOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuICQubW9iaWxlLm5zOwoJCX0sCgoJCV9lbmhhbmNlOiBmdW5jdGlvbiggY29udGVudCwgcm9sZSApIHsKCQkJLy8gVE9ETyBjb25zaWRlciBzdXBwb3J0aW5nIGEgY3VzdG9tIGNhbGxiYWNrLCBhbmQgcGFzc2luZyBpbgoJCQkvLyB0aGUgc2V0dGluZ3Mgd2hpY2ggaW5jbHVkZXMgdGhlIHJvbGUKCQkJcmV0dXJuIGNvbnRlbnQucGFnZSh7IHJvbGU6IHJvbGUgfSk7CgkJfSwKCgkJX2luY2x1ZGU6IGZ1bmN0aW9uKCBwYWdlLCBzZXR0aW5ncyApIHsKCQkJLy8gYXBwZW5kIHRvIHBhZ2UgYW5kIGVuaGFuY2UKCQkJcGFnZS5hcHBlbmRUbyggdGhpcy5lbGVtZW50ICk7CgoJCQkvLyB1c2UgdGhlIHBhZ2Ugd2lkZ2V0IHRvIGVuaGFuY2UKCQkJdGhpcy5fZW5oYW5jZSggcGFnZSwgc2V0dGluZ3Mucm9sZSApOwoKCQkJLy8gcmVtb3ZlIHBhZ2Ugb24gaGlkZQoJCQlwYWdlLnBhZ2UoICJiaW5kUmVtb3ZlIiApOwoJCX0sCgoJCV9maW5kOiBmdW5jdGlvbiggYWJzVXJsICkgewoJCQkvLyBUT0RPIGNvbnNpZGVyIHN1cHBvcnRpbmcgYSBjdXN0b20gY2FsbGJhY2sKCQkJdmFyIGZpbGVVcmwgPSB0aGlzLl9jcmVhdGVGaWxlVXJsKCBhYnNVcmwgKSwKCQkJCWRhdGFVcmwgPSB0aGlzLl9jcmVhdGVEYXRhVXJsKCBhYnNVcmwgKSwKCQkJCXBhZ2UsIGluaXRpYWxDb250ZW50ID0gdGhpcy5fZ2V0SW5pdGlhbENvbnRlbnQoKTsKCgkJCS8vIENoZWNrIHRvIHNlZSBpZiB0aGUgcGFnZSBhbHJlYWR5IGV4aXN0cyBpbiB0aGUgRE9NLgoJCQkvLyBOT1RFIGRvIF9ub3RfIHVzZSB0aGUgOmpxbURhdGEgcHNldWRvIHNlbGVjdG9yIGJlY2F1c2UgcGFyZW50aGVzaXMKCQkJLy8gICAgICBhcmUgYSB2YWxpZCB1cmwgY2hhciBhbmQgaXQgYnJlYWtzIG9uIHRoZSBmaXJzdCBvY2N1cmVuY2UKCQkJcGFnZSA9IHRoaXMuZWxlbWVudAoJCQkJLmNoaWxkcmVuKCAiW2RhdGEtIiArIHRoaXMuX2dldE5zKCkgKyJ1cmw9JyIgKyBkYXRhVXJsICsgIiddIiApOwoKCQkJLy8gSWYgd2UgZmFpbGVkIHRvIGZpbmQgdGhlIHBhZ2UsIGNoZWNrIHRvIHNlZSBpZiB0aGUgdXJsIGlzIGEKCQkJLy8gcmVmZXJlbmNlIHRvIGFuIGVtYmVkZGVkIHBhZ2UuIElmIHNvLCBpdCBtYXkgaGF2ZSBiZWVuIGR5bmFtaWNhbGx5CgkJCS8vIGluamVjdGVkIGJ5IGEgZGV2ZWxvcGVyLCBpbiB3aGljaCBjYXNlIGl0IHdvdWxkIGJlIGxhY2tpbmcgYQoJCQkvLyBkYXRhLXVybCBhdHRyaWJ1dGUgYW5kIGluIG5lZWQgb2YgZW5oYW5jZW1lbnQuCgkJCWlmICggcGFnZS5sZW5ndGggPT09IDAgJiYgZGF0YVVybCAmJiAhJC5tb2JpbGUucGF0aC5pc1BhdGgoIGRhdGFVcmwgKSApIHsKCQkJCXBhZ2UgPSB0aGlzLmVsZW1lbnQuY2hpbGRyZW4oICQubW9iaWxlLnBhdGguaGFzaFRvU2VsZWN0b3IoIiMiICsgZGF0YVVybCkgKQoJCQkJCS5hdHRyKCAiZGF0YS0iICsgdGhpcy5fZ2V0TnMoKSArICJ1cmwiLCBkYXRhVXJsICkKCQkJCQkuanFtRGF0YSggInVybCIsIGRhdGFVcmwgKTsKCQkJfQoKCQkJLy8gSWYgd2UgZmFpbGVkIHRvIGZpbmQgYSBwYWdlIGluIHRoZSBET00sIGNoZWNrIHRoZSBVUkwgdG8gc2VlIGlmIGl0CgkJCS8vIHJlZmVycyB0byB0aGUgZmlyc3QgcGFnZSBpbiB0aGUgYXBwbGljYXRpb24uIEFsc28gY2hlY2sgdG8gbWFrZSBzdXJlCgkJCS8vIG91ciBjYWNoZWQtZmlyc3QtcGFnZSBpcyBhY3R1YWxseSBpbiB0aGUgRE9NLiBTb21lIHVzZXIgZGVwbG95ZWQKCQkJLy8gYXBwcyBhcmUgcHJ1bmluZyB0aGUgZmlyc3QgcGFnZSBmcm9tIHRoZSBET00gZm9yIHZhcmlvdXMgcmVhc29ucy4KCQkJLy8gV2UgY2hlY2sgZm9yIHRoaXMgY2FzZSBoZXJlIGJlY2F1c2Ugd2UgZG9uJ3Qgd2FudCBhIGZpcnN0LXBhZ2Ugd2l0aAoJCQkvLyBhbiBpZCBmYWxsaW5nIHRocm91Z2ggdG8gdGhlIG5vbi1leGlzdGVudCBlbWJlZGRlZCBwYWdlIGVycm9yIGNhc2UuCgkJCWlmICggcGFnZS5sZW5ndGggPT09IDAgJiYKCQkJCSQubW9iaWxlLnBhdGguaXNGaXJzdFBhZ2VVcmwoIGZpbGVVcmwgKSAmJgoJCQkJaW5pdGlhbENvbnRlbnQgJiYKCQkJCWluaXRpYWxDb250ZW50LnBhcmVudCgpLmxlbmd0aCApIHsKCQkJCXBhZ2UgPSAkKCBpbml0aWFsQ29udGVudCApOwoJCQl9CgoJCQlyZXR1cm4gcGFnZTsKCQl9LAoKCQlfZ2V0TG9hZGVyOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuICQubW9iaWxlLmxvYWRpbmcoKTsKCQl9LAoKCQlfc2hvd0xvYWRpbmc6IGZ1bmN0aW9uKCBkZWxheSwgdGhlbWUsIG1zZywgdGV4dG9ubHkgKSB7CgkJCS8vIFRoaXMgY29uZmlndXJhYmxlIHRpbWVvdXQgYWxsb3dzIGNhY2hlZCBwYWdlcyBhIGJyaWVmCgkJCS8vIGRlbGF5IHRvIGxvYWQgd2l0aG91dCBzaG93aW5nIGEgbWVzc2FnZQoJCQl0aGlzLl9sb2FkTXNnID0gc2V0VGltZW91dCgkLnByb3h5KGZ1bmN0aW9uKCkgewoJCQkJdGhpcy5fZ2V0TG9hZGVyKCkubG9hZGVyKCAic2hvdyIsIHRoZW1lLCBtc2csIHRleHRvbmx5ICk7CgkJCX0sIHRoaXMpLCBkZWxheSApOwoJCX0sCgoJCV9oaWRlTG9hZGluZzogZnVuY3Rpb24oKSB7CgkJCS8vIFN0b3AgbWVzc2FnZSBzaG93IHRpbWVyCgkJCWNsZWFyVGltZW91dCggdGhpcy5fbG9hZE1zZyApOwoKCQkJLy8gSGlkZSBsb2FkaW5nIG1lc3NhZ2UKCQkJdGhpcy5fZ2V0TG9hZGVyKCkubG9hZGVyKCAiaGlkZSIgKTsKCQl9LAoKCQlfc2hvd0Vycm9yOiBmdW5jdGlvbigpIHsKCQkJLy8gbWFrZSBzdXJlIHRvIHJlbW92ZSB0aGUgY3VycmVudCBsb2FkaW5nIG1lc3NhZ2UKCQkJdGhpcy5faGlkZUxvYWRpbmcoKTsKCgkJCS8vIHNob3cgdGhlIGVycm9yIG1lc3NhZ2UKCQkJdGhpcy5fc2hvd0xvYWRpbmcoIDAsICQubW9iaWxlLnBhZ2VMb2FkRXJyb3JNZXNzYWdlVGhlbWUsICQubW9iaWxlLnBhZ2VMb2FkRXJyb3JNZXNzYWdlLCB0cnVlICk7CgoJCQkvLyBoaWRlIHRoZSBlcnJvciBtZXNzYWdlIGFmdGVyIGEgZGVsYXkKCQkJLy8gVE9ETyBjb25maWd1cmF0aW9uCgkJCXNldFRpbWVvdXQoICQucHJveHkodGhpcywgIl9oaWRlTG9hZGluZyIpLCAxNTAwICk7CgkJfSwKCgkJX3BhcnNlOiBmdW5jdGlvbiggaHRtbCwgZmlsZVVybCApIHsKCQkJLy8gVE9ETyBjb25zaWRlciBhbGxvd2luZyBjdXN0b21pemF0aW9uIG9mIHRoaXMgbWV0aG9kLiBJdCdzIHZlcnkgSlFNIHNwZWNpZmljCgkJCXZhciBwYWdlLCBhbGwgPSAkKCAiPGRpdj48L2Rpdj4iICk7CgoJCQkvL3dvcmthcm91bmQgdG8gYWxsb3cgc2NyaXB0cyB0byBleGVjdXRlIHdoZW4gaW5jbHVkZWQgaW4gcGFnZSBkaXZzCgkJCWFsbC5nZXQoIDAgKS5pbm5lckhUTUwgPSBodG1sOwoKCQkJcGFnZSA9IGFsbC5maW5kKCAiOmpxbURhdGEocm9sZT0ncGFnZScpLCA6anFtRGF0YShyb2xlPSdkaWFsb2cnKSIgKS5maXJzdCgpOwoKCQkJLy9pZiBwYWdlIGVsZW0gY291bGRuJ3QgYmUgZm91bmQsIGNyZWF0ZSBvbmUgYW5kIGluc2VydCB0aGUgYm9keSBlbGVtZW50J3MgY29udGVudHMKCQkJaWYgKCAhcGFnZS5sZW5ndGggKSB7CgkJCQlwYWdlID0gJCggIjxkaXYgZGF0YS0iICsgdGhpcy5fZ2V0TnMoKSArICJyb2xlPSdwYWdlJz4iICsKCQkJCQkoIGh0bWwuc3BsaXQoIC88XC8/Ym9keVtePl0qPi9nbWkgKVsxXSB8fCAiIiApICsKCQkJCQkiPC9kaXY+IiApOwoJCQl9CgoJCQkvLyBUT0RPIHRhZ2dpbmcgYSBwYWdlIHdpdGggZXh0ZXJuYWwgdG8gbWFrZSBzdXJlIHRoYXQgZW1iZWRkZWQgcGFnZXMgYXJlbid0CgkJCS8vIHJlbW92ZWQgYnkgdGhlIHZhcmlvdXMgcGFnZSBoYW5kbGluZyBjb2RlIGlzIGJhZC4gSGF2aW5nIHBhZ2UgaGFuZGxpbmcgY29kZQoJCQkvLyBpbiBtYW55IHBsYWNlcyBpcyBiYWQuIFNvbHV0aW9ucyBwb3N0IDEuMAoJCQlwYWdlLmF0dHIoICJkYXRhLSIgKyB0aGlzLl9nZXROcygpICsgInVybCIsICQubW9iaWxlLnBhdGguY29udmVydFVybFRvRGF0YVVybChmaWxlVXJsKSApCgkJCQkuYXR0ciggImRhdGEtIiArIHRoaXMuX2dldE5zKCkgKyAiZXh0ZXJuYWwtcGFnZSIsIHRydWUgKTsKCgkJCXJldHVybiBwYWdlOwoJCX0sCgoJCV9zZXRMb2FkZWRUaXRsZTogZnVuY3Rpb24oIHBhZ2UsIGh0bWwgKSB7CgkJCS8vcGFnZSB0aXRsZSByZWdleHAKCQkJdmFyIG5ld1BhZ2VUaXRsZSA9IGh0bWwubWF0Y2goIC88dGl0bGVbXj5dKj4oW148XSopLyApICYmIFJlZ0V4cC4kMTsKCgkJCWlmICggbmV3UGFnZVRpdGxlICYmICFwYWdlLmpxbURhdGEoInRpdGxlIikgKSB7CgkJCQluZXdQYWdlVGl0bGUgPSAkKCAiPGRpdj4iICsgbmV3UGFnZVRpdGxlICsgIjwvZGl2PiIgKS50ZXh0KCk7CgkJCQlwYWdlLmpxbURhdGEoICJ0aXRsZSIsIG5ld1BhZ2VUaXRsZSApOwoJCQl9CgkJfSwKCgkJX2lzUmV3cml0YWJsZUJhc2VUYWc6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gJC5tb2JpbGUuZHluYW1pY0Jhc2VFbmFibGVkICYmICEkLnN1cHBvcnQuZHluYW1pY0Jhc2VUYWc7CgkJfSwKCgkJX2NyZWF0ZURhdGFVcmw6IGZ1bmN0aW9uKCBhYnNvbHV0ZVVybCApIHsKCQkJcmV0dXJuICQubW9iaWxlLnBhdGguY29udmVydFVybFRvRGF0YVVybCggYWJzb2x1dGVVcmwgKTsKCQl9LAoKCQlfY3JlYXRlRmlsZVVybDogZnVuY3Rpb24oIGFic29sdXRlVXJsICkgewoJCQlyZXR1cm4gJC5tb2JpbGUucGF0aC5nZXRGaWxlUGF0aCggYWJzb2x1dGVVcmwgKTsKCQl9LAoKCQlfdHJpZ2dlcldpdGhEZXByZWNhdGVkOiBmdW5jdGlvbiggbmFtZSwgZGF0YSwgcGFnZSApIHsKCQkJdmFyIGRlcHJlY2F0ZWRFdmVudCA9ICQuRXZlbnQoICJwYWdlIiArIG5hbWUgKSwKCQkJCW5ld0V2ZW50ID0gJC5FdmVudCggdGhpcy53aWRnZXROYW1lICsgbmFtZSApOwoKCQkJLy8gREVQUkVDQVRFRAoJCQkvLyB0cmlnZ2VyIHRoZSBvbGQgZGVwcmVjYXRlZCBldmVudCBvbiB0aGUgcGFnZSBpZiBpdCdzIHByb3ZpZGVkCgkJCSggcGFnZSB8fCB0aGlzLmVsZW1lbnQgKS50cmlnZ2VyKCBkZXByZWNhdGVkRXZlbnQsIGRhdGEgKTsKCgkJCS8vIHVzZSB0aGUgd2lkZ2V0IHRyaWdnZXIgbWV0aG9kIGZvciB0aGUgbmV3IGNvbnRlbnQqIGV2ZW50CgkJCXRoaXMuZWxlbWVudC50cmlnZ2VyKCBuZXdFdmVudCwgZGF0YSApOwoKCQkJcmV0dXJuIHsKCQkJCWRlcHJlY2F0ZWRFdmVudDogZGVwcmVjYXRlZEV2ZW50LAoJCQkJZXZlbnQ6IG5ld0V2ZW50CgkJCX07CgkJfSwKCgkJLy8gVE9ETyBpdCB3b3VsZCBiZSBuaWNlIHRvIHNwbGl0IHRoaXMgdXAgbW9yZSBidXQgZXZlcnl0aGluZyBhcHBlYXJzIHRvIGJlICJvbmUgb2ZmIgoJCS8vICAgICAgb3IgcmVxdWlyZSBvcmRlcmluZyBzdWNoIHRoYXQgb3RoZXIgYml0cyBhcmUgc3ByaW5rbGVkIGluIGJldHdlZW4gcGFydHMgdGhhdAoJCS8vICAgICAgY291bGQgYmUgYWJzdHJhY3RlZCBvdXQgYXMgYSBncm91cAoJCV9sb2FkU3VjY2VzczogZnVuY3Rpb24oIGFic1VybCwgdHJpZ2dlckRhdGEsIHNldHRpbmdzLCBkZWZlcnJlZCApIHsKCQkJdmFyIGZpbGVVcmwgPSB0aGlzLl9jcmVhdGVGaWxlVXJsKCBhYnNVcmwgKSwKCQkJCWRhdGFVcmwgPSB0aGlzLl9jcmVhdGVEYXRhVXJsKCBhYnNVcmwgKTsKCgkJCXJldHVybiAkLnByb3h5KGZ1bmN0aW9uKCBodG1sLCB0ZXh0U3RhdHVzLCB4aHIgKSB7CgkJCQkvL3ByZS1wYXJzZSBodG1sIHRvIGNoZWNrIGZvciBhIGRhdGEtdXJsLAoJCQkJLy91c2UgaXQgYXMgdGhlIG5ldyBmaWxlVXJsLCBiYXNlIHBhdGgsIGV0YwoJCQkJdmFyIGNvbnRlbnQsCgoJCQkJCS8vIFRPRE8gaGFuZGxlIGRpYWxvZ3MgYWdhaW4KCQkJCQlwYWdlRWxlbVJlZ2V4ID0gbmV3IFJlZ0V4cCggIig8W14+XStcXGJkYXRhLSIgKyB0aGlzLl9nZXROcygpICsgInJvbGU9W1wiJ10/cGFnZVtcIiddP1tePl0qPikiICksCgoJCQkJCWRhdGFVcmxSZWdleCA9IG5ldyBSZWdFeHAoICJcXGJkYXRhLSIgKyB0aGlzLl9nZXROcygpICsgInVybD1bXCInXT8oW15cIic+XSopW1wiJ10/IiApOwoKCQkJCS8vIGRhdGEtdXJsIG11c3QgYmUgcHJvdmlkZWQgZm9yIHRoZSBiYXNlIHRhZyBzbyByZXNvdXJjZSByZXF1ZXN0cwoJCQkJLy8gY2FuIGJlIGRpcmVjdGVkIHRvIHRoZSBjb3JyZWN0IHVybC4gbG9hZGluZyBpbnRvIGEgdGVtcHJvcmFyeQoJCQkJLy8gZWxlbWVudCBtYWtlcyB0aGVzZSByZXF1ZXN0cyBpbW1lZGlhdGVseQoJCQkJaWYgKCBwYWdlRWxlbVJlZ2V4LnRlc3QoIGh0bWwgKSAmJgoJCQkJCVJlZ0V4cC4kMSAmJgoJCQkJCWRhdGFVcmxSZWdleC50ZXN0KCBSZWdFeHAuJDEgKSAmJgoJCQkJCVJlZ0V4cC4kMSApIHsKCQkJCQlmaWxlVXJsID0gJC5tb2JpbGUucGF0aC5nZXRGaWxlUGF0aCggJCgiPGRpdj4iICsgUmVnRXhwLiQxICsgIjwvZGl2PiIpLnRleHQoKSApOwoJCQkJfQoKCQkJCS8vZG9udCB1cGRhdGUgdGhlIGJhc2UgdGFnIGlmIHdlIGFyZSBwcmVmZXRjaGluZwoJCQkJaWYgKCBzZXR0aW5ncy5wcmVmZXRjaCA9PT0gdW5kZWZpbmVkICl7CgkJCQkJdGhpcy5fZ2V0QmFzZSgpLnNldCggZmlsZVVybCApOwoJCQkJfQoKCQkJCWNvbnRlbnQgPSB0aGlzLl9wYXJzZSggaHRtbCwgZmlsZVVybCApOwoKCQkJCXRoaXMuX3NldExvYWRlZFRpdGxlKCBjb250ZW50LCBodG1sICk7CgoJCQkJLy8gcmV3cml0ZSBzcmMgYW5kIGhyZWYgYXR0cnMgdG8gdXNlIGEgYmFzZSB1cmwgaWYgdGhlIGJhc2UgdGFnIHdvbid0IHdvcmsKCQkJCWlmICggdGhpcy5faXNSZXdyaXRhYmxlQmFzZVRhZygpICYmIGNvbnRlbnQgKSB7CgkJCQkJdGhpcy5fZ2V0QmFzZSgpLnJld3JpdGUoIGZpbGVVcmwsIGNvbnRlbnQgKTsKCQkJCX0KCgkJCQl0aGlzLl9pbmNsdWRlKCBjb250ZW50LCBzZXR0aW5ncyApOwoKCQkJCS8vIEVuaGFuY2luZyB0aGUgY29udGVudCBtYXkgcmVzdWx0IGluIG5ldyBkaWFsb2dzL3N1YiBjb250ZW50IGJlaW5nIGluc2VydGVkCgkJCQkvLyBpbnRvIHRoZSBET00uIElmIHRoZSBvcmlnaW5hbCBhYnNVcmwgcmVmZXJzIHRvIGEgc3ViLWNvbnRlbnQsIHRoYXQgaXMgdGhlCgkJCQkvLyByZWFsIGNvbnRlbnQgd2UgYXJlIGludGVyZXN0ZWQgaW4uCgkJCQlpZiAoIGFic1VybC5pbmRleE9mKCAiJiIgKyAkLm1vYmlsZS5zdWJQYWdlVXJsS2V5ICkgPiAtMSApIHsKCQkJCQljb250ZW50ID0gdGhpcy5lbGVtZW50LmNoaWxkcmVuKCAiW2RhdGEtIiArIHRoaXMuX2dldE5zKCkgKyJ1cmw9JyIgKyBkYXRhVXJsICsgIiddIiApOwoJCQkJfQoKCQkJCS8vIFJlbW92ZSBsb2FkaW5nIG1lc3NhZ2UuCgkJCQlpZiAoIHNldHRpbmdzLnNob3dMb2FkTXNnICkgewoJCQkJCXRoaXMuX2hpZGVMb2FkaW5nKCk7CgkJCQl9CgoJCQkJLy8gQWRkIHRoZSBjb250ZW50IHJlZmVyZW5jZSBhbmQgeGhyIHRvIG91ciB0cmlnZ2VyRGF0YS4KCQkJCXRyaWdnZXJEYXRhLnhociA9IHhocjsKCQkJCXRyaWdnZXJEYXRhLnRleHRTdGF0dXMgPSB0ZXh0U3RhdHVzOwoKCQkJCS8vIERFUFJFQ0FURUQKCQkJCXRyaWdnZXJEYXRhLnBhZ2UgPSBjb250ZW50OwoKCQkJCXRyaWdnZXJEYXRhLmNvbnRlbnQgPSBjb250ZW50OwoKCQkJCS8vIExldCBsaXN0ZW5lcnMga25vdyB0aGUgY29udGVudCBsb2FkZWQgc3VjY2Vzc2Z1bGx5LgoJCQkJdGhpcy5fdHJpZ2dlcldpdGhEZXByZWNhdGVkKCAibG9hZCIsIHRyaWdnZXJEYXRhICk7CgoJCQkJZGVmZXJyZWQucmVzb2x2ZSggYWJzVXJsLCBzZXR0aW5ncywgY29udGVudCApOwoJCQl9LCB0aGlzKTsKCQl9LAoKCQlfbG9hZERlZmF1bHRzOiB7CgkJCXR5cGU6ICJnZXQiLAoJCQlkYXRhOiB1bmRlZmluZWQsCgoJCQkvLyBERVBSRUNBVEVECgkJCXJlbG9hZFBhZ2U6IGZhbHNlLAoKCQkJcmVsb2FkOiBmYWxzZSwKCgkJCS8vIEJ5IGRlZmF1bHQgd2UgcmVseSBvbiB0aGUgcm9sZSBkZWZpbmVkIGJ5IHRoZSBAZGF0YS1yb2xlIGF0dHJpYnV0ZS4KCQkJcm9sZTogdW5kZWZpbmVkLAoKCQkJc2hvd0xvYWRNc2c6IGZhbHNlLAoKCQkJLy8gVGhpcyBkZWxheSBhbGxvd3MgbG9hZHMgdGhhdCBwdWxsIGZyb20gYnJvd3NlciBjYWNoZSB0bwoJCQkvLyBvY2N1ciB3aXRob3V0IHNob3dpbmcgdGhlIGxvYWRpbmcgbWVzc2FnZS4KCQkJbG9hZE1zZ0RlbGF5OiA1MAoJCX0sCgoJCWxvYWQ6IGZ1bmN0aW9uKCB1cmwsIG9wdGlvbnMgKSB7CgkJCS8vIFRoaXMgZnVuY3Rpb24gdXNlcyBkZWZlcnJlZCBub3RpZmljYXRpb25zIHRvIGxldCBjYWxsZXJzCgkJCS8vIGtub3cgd2hlbiB0aGUgY29udGVudCBpcyBkb25lIGxvYWRpbmcsIG9yIGlmIGFuIGVycm9yIGhhcyBvY2N1cnJlZC4KCQkJdmFyIGRlZmVycmVkID0gKCBvcHRpb25zICYmIG9wdGlvbnMuZGVmZXJyZWQgKSB8fCAkLkRlZmVycmVkKCksCgoJCQkJLy8gVGhlIGRlZmF1bHQgbG9hZCBvcHRpb25zIHdpdGggb3ZlcnJpZGVzIHNwZWNpZmllZCBieSB0aGUgY2FsbGVyLgoJCQkJc2V0dGluZ3MgPSAkLmV4dGVuZCgge30sIHRoaXMuX2xvYWREZWZhdWx0cywgb3B0aW9ucyApLAoKCQkJCS8vIFRoZSBET00gZWxlbWVudCBmb3IgdGhlIGNvbnRlbnQgYWZ0ZXIgaXQgaGFzIGJlZW4gbG9hZGVkLgoJCQkJY29udGVudCA9IG51bGwsCgoJCQkJLy8gVGhlIGFic29sdXRlIHZlcnNpb24gb2YgdGhlIFVSTCBwYXNzZWQgaW50byB0aGUgZnVuY3Rpb24uIFRoaXMKCQkJCS8vIHZlcnNpb24gb2YgdGhlIFVSTCBtYXkgY29udGFpbiBkaWFsb2cvc3ViY29udGVudCBwYXJhbXMgaW4gaXQuCgkJCQlhYnNVcmwgPSAkLm1vYmlsZS5wYXRoLm1ha2VVcmxBYnNvbHV0ZSggdXJsLCB0aGlzLl9maW5kQmFzZVdpdGhEZWZhdWx0KCkgKSwKCQkJCWZpbGVVcmwsIGRhdGFVcmwsIHBibEV2ZW50LCB0cmlnZ2VyRGF0YTsKCgkJCS8vIERFUFJFQ0FURUQgcmVsb2FkUGFnZQoJCQlzZXR0aW5ncy5yZWxvYWQgPSBzZXR0aW5ncy5yZWxvYWRQYWdlOwoKCQkJLy8gSWYgdGhlIGNhbGxlciBwcm92aWRlZCBkYXRhLCBhbmQgd2UncmUgdXNpbmcgImdldCIgcmVxdWVzdCwKCQkJLy8gYXBwZW5kIHRoZSBkYXRhIHRvIHRoZSBVUkwuCgkJCWlmICggc2V0dGluZ3MuZGF0YSAmJiBzZXR0aW5ncy50eXBlID09PSAiZ2V0IiApIHsKCQkJCWFic1VybCA9ICQubW9iaWxlLnBhdGguYWRkU2VhcmNoUGFyYW1zKCBhYnNVcmwsIHNldHRpbmdzLmRhdGEgKTsKCQkJCXNldHRpbmdzLmRhdGEgPSB1bmRlZmluZWQ7CgkJCX0KCgkJCS8vIElmIHRoZSBjYWxsZXIgaXMgdXNpbmcgYSAicG9zdCIgcmVxdWVzdCwgcmVsb2FkIG11c3QgYmUgdHJ1ZQoJCQlpZiAoIHNldHRpbmdzLmRhdGEgJiYgc2V0dGluZ3MudHlwZSA9PT0gInBvc3QiICkgewoJCQkJc2V0dGluZ3MucmVsb2FkID0gdHJ1ZTsKCQkJfQoKCQkJLy8gVGhlIGFic29sdXRlIHZlcnNpb24gb2YgdGhlIFVSTCBtaW51cyBhbnkgZGlhbG9nL3N1YmNvbnRlbnQgcGFyYW1zLgoJCQkvLyBJbiBvdGhlcndvcmRzIHRoZSByZWFsIFVSTCBvZiB0aGUgY29udGVudCB0byBiZSBsb2FkZWQuCgkJCWZpbGVVcmwgPSB0aGlzLl9jcmVhdGVGaWxlVXJsKCBhYnNVcmwgKTsKCgkJCS8vIFRoZSB2ZXJzaW9uIG9mIHRoZSBVcmwgYWN0dWFsbHkgc3RvcmVkIGluIHRoZSBkYXRhLXVybCBhdHRyaWJ1dGUgb2YKCQkJLy8gdGhlIGNvbnRlbnQuIEZvciBlbWJlZGRlZCBjb250ZW50LCBpdCBpcyBqdXN0IHRoZSBpZCBvZiB0aGUgcGFnZS4gRm9yCgkJCS8vIGNvbnRlbnQgd2l0aGluIHRoZSBzYW1lIGRvbWFpbiBhcyB0aGUgZG9jdW1lbnQgYmFzZSwgaXQgaXMgdGhlIHNpdGUKCQkJLy8gcmVsYXRpdmUgcGF0aC4gRm9yIGNyb3NzLWRvbWFpbiBjb250ZW50IChQaG9uZSBHYXAgb25seSkgdGhlIGVudGlyZQoJCQkvLyBhYnNvbHV0ZSBVcmwgaXMgdXNlZCB0byBsb2FkIHRoZSBjb250ZW50LgoJCQlkYXRhVXJsID0gdGhpcy5fY3JlYXRlRGF0YVVybCggYWJzVXJsICk7CgoJCQljb250ZW50ID0gdGhpcy5fZmluZCggYWJzVXJsICk7CgoJCQkvLyBJZiBpdCBpc24ndCBhIHJlZmVyZW5jZSB0byB0aGUgZmlyc3QgY29udGVudCBhbmQgcmVmZXJzIHRvIG1pc3NpbmcKCQkJLy8gZW1iZWRkZWQgY29udGVudCByZWplY3QgdGhlIGRlZmVycmVkIGFuZCByZXR1cm4KCQkJaWYgKCBjb250ZW50Lmxlbmd0aCA9PT0gMCAmJgoJCQkJJC5tb2JpbGUucGF0aC5pc0VtYmVkZGVkUGFnZShmaWxlVXJsKSAmJgoJCQkJISQubW9iaWxlLnBhdGguaXNGaXJzdFBhZ2VVcmwoZmlsZVVybCkgKSB7CgkJCQlkZWZlcnJlZC5yZWplY3QoIGFic1VybCwgc2V0dGluZ3MgKTsKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gUmVzZXQgYmFzZSB0byB0aGUgZGVmYXVsdCBkb2N1bWVudCBiYXNlCgkJCS8vIFRPRE8gZmlndXJlIG91dCB3aHkgd2UgZG9lIHRoaXMKCQkJdGhpcy5fZ2V0QmFzZSgpLnJlc2V0KCk7CgoJCQkvLyBJZiB0aGUgY29udGVudCB3ZSBhcmUgaW50ZXJlc3RlZCBpbiBpcyBhbHJlYWR5IGluIHRoZSBET00sCgkJCS8vIGFuZCB0aGUgY2FsbGVyIGRpZCBub3QgaW5kaWNhdGUgdGhhdCB3ZSBzaG91bGQgZm9yY2UgYQoJCQkvLyByZWxvYWQgb2YgdGhlIGZpbGUsIHdlIGFyZSBkb25lLiBSZXNvbHZlIHRoZSBkZWZlcnJyZWQgc28gdGhhdAoJCQkvLyB1c2VycyBjYW4gYmluZCB0byAuZG9uZSBvbiB0aGUgcHJvbWlzZQoJCQlpZiAoIGNvbnRlbnQubGVuZ3RoICYmICFzZXR0aW5ncy5yZWxvYWQgKSB7CgkJCQl0aGlzLl9lbmhhbmNlKCBjb250ZW50LCBzZXR0aW5ncy5yb2xlICk7CgkJCQlkZWZlcnJlZC5yZXNvbHZlKCBhYnNVcmwsIHNldHRpbmdzLCBjb250ZW50ICk7CgoJCQkJLy9pZiB3ZSBhcmUgcmVsb2FkaW5nIHRoZSBjb250ZW50IG1ha2Ugc3VyZSB3ZSB1cGRhdGUKCQkJCS8vIHRoZSBiYXNlIGlmIGl0cyBub3QgYSBwcmVmZXRjaAoJCQkJaWYgKCAhc2V0dGluZ3MucHJlZmV0Y2ggKXsKCQkJCQl0aGlzLl9nZXRCYXNlKCkuc2V0KHVybCk7CgkJCQl9CgoJCQkJcmV0dXJuOwoJCQl9CgoJCQl0cmlnZ2VyRGF0YSA9IHsKCQkJCXVybDogdXJsLAoJCQkJYWJzVXJsOiBhYnNVcmwsCgkJCQlkYXRhVXJsOiBkYXRhVXJsLAoJCQkJZGVmZXJyZWQ6IGRlZmVycmVkLAoJCQkJb3B0aW9uczogc2V0dGluZ3MKCQkJfTsKCgkJCS8vIExldCBsaXN0ZW5lcnMga25vdyB3ZSdyZSBhYm91dCB0byBsb2FkIGNvbnRlbnQuCgkJCXBibEV2ZW50ID0gdGhpcy5fdHJpZ2dlcldpdGhEZXByZWNhdGVkKCAiYmVmb3JlbG9hZCIsIHRyaWdnZXJEYXRhICk7CgoJCQkvLyBJZiB0aGUgZGVmYXVsdCBiZWhhdmlvciBpcyBwcmV2ZW50ZWQsIHN0b3AgaGVyZSEKCQkJaWYgKCBwYmxFdmVudC5kZXByZWNhdGVkRXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgfHwKCQkJCXBibEV2ZW50LmV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQlpZiAoIHNldHRpbmdzLnNob3dMb2FkTXNnICkgewoJCQkJdGhpcy5fc2hvd0xvYWRpbmcoIHNldHRpbmdzLmxvYWRNc2dEZWxheSApOwoJCQl9CgoJCQkvLyBSZXNldCBiYXNlIHRvIHRoZSBkZWZhdWx0IGRvY3VtZW50IGJhc2UuCgkJCS8vIG9ubHkgcmVzZXQgaWYgd2UgYXJlIG5vdCBwcmVmZXRjaGluZwoJCQlpZiAoIHNldHRpbmdzLnByZWZldGNoID09PSB1bmRlZmluZWQgKSB7CgkJCQl0aGlzLl9nZXRCYXNlKCkucmVzZXQoKTsKCQkJfQoKCQkJaWYgKCAhKCAkLm1vYmlsZS5hbGxvd0Nyb3NzRG9tYWluUGFnZXMgfHwKCQkJCSQubW9iaWxlLnBhdGguaXNTYW1lRG9tYWluKCQubW9iaWxlLnBhdGguZG9jdW1lbnRVcmwsIGFic1VybCApICkgKSB7CgkJCQlkZWZlcnJlZC5yZWplY3QoIGFic1VybCwgc2V0dGluZ3MgKTsKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gTG9hZCB0aGUgbmV3IGNvbnRlbnQuCgkJCSQuYWpheCh7CgkJCQl1cmw6IGZpbGVVcmwsCgkJCQl0eXBlOiBzZXR0aW5ncy50eXBlLAoJCQkJZGF0YTogc2V0dGluZ3MuZGF0YSwKCQkJCWNvbnRlbnRUeXBlOiBzZXR0aW5ncy5jb250ZW50VHlwZSwKCQkJCWRhdGFUeXBlOiAiaHRtbCIsCgkJCQlzdWNjZXNzOiB0aGlzLl9sb2FkU3VjY2VzcyggYWJzVXJsLCB0cmlnZ2VyRGF0YSwgc2V0dGluZ3MsIGRlZmVycmVkICksCgkJCQllcnJvcjogdGhpcy5fbG9hZEVycm9yKCBhYnNVcmwsIHRyaWdnZXJEYXRhLCBzZXR0aW5ncywgZGVmZXJyZWQgKQoJCQl9KTsKCQl9LAoKCQlfbG9hZEVycm9yOiBmdW5jdGlvbiggYWJzVXJsLCB0cmlnZ2VyRGF0YSwgc2V0dGluZ3MsIGRlZmVycmVkICkgewoJCQlyZXR1cm4gJC5wcm94eShmdW5jdGlvbiggeGhyLCB0ZXh0U3RhdHVzLCBlcnJvclRocm93biApIHsKCQkJCS8vc2V0IGJhc2UgYmFjayB0byBjdXJyZW50IHBhdGgKCQkJCXRoaXMuX2dldEJhc2UoKS5zZXQoICQubW9iaWxlLnBhdGguZ2V0KCkgKTsKCgkJCQkvLyBBZGQgZXJyb3IgaW5mbyB0byBvdXIgdHJpZ2dlckRhdGEuCgkJCQl0cmlnZ2VyRGF0YS54aHIgPSB4aHI7CgkJCQl0cmlnZ2VyRGF0YS50ZXh0U3RhdHVzID0gdGV4dFN0YXR1czsKCQkJCXRyaWdnZXJEYXRhLmVycm9yVGhyb3duID0gZXJyb3JUaHJvd247CgoJCQkJLy8gTGV0IGxpc3RlbmVycyBrbm93IHRoZSBwYWdlIGxvYWQgZmFpbGVkLgoJCQkJdmFyIHBsZkV2ZW50ID0gdGhpcy5fdHJpZ2dlcldpdGhEZXByZWNhdGVkKCAibG9hZGZhaWxlZCIsIHRyaWdnZXJEYXRhICk7CgoJCQkJLy8gSWYgdGhlIGRlZmF1bHQgYmVoYXZpb3IgaXMgcHJldmVudGVkLCBzdG9wIGhlcmUhCgkJCQkvLyBOb3RlIHRoYXQgaXQgaXMgdGhlIHJlc3BvbnNpYmlsaXR5IG9mIHRoZSBsaXN0ZW5lci9oYW5kbGVyCgkJCQkvLyB0aGF0IGNhbGxlZCBwcmV2ZW50RGVmYXVsdCgpLCB0byByZXNvbHZlL3JlamVjdCB0aGUKCQkJCS8vIGRlZmVycmVkIG9iamVjdCB3aXRoaW4gdGhlIHRyaWdnZXJEYXRhLgoJCQkJaWYgKCBwbGZFdmVudC5kZXByZWNhdGVkRXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgfHwKCQkJCQlwbGZFdmVudC5ldmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJLy8gUmVtb3ZlIGxvYWRpbmcgbWVzc2FnZS4KCQkJCWlmICggc2V0dGluZ3Muc2hvd0xvYWRNc2cgKSB7CgkJCQkJdGhpcy5fc2hvd0Vycm9yKCk7CgkJCQl9CgoJCQkJZGVmZXJyZWQucmVqZWN0KCBhYnNVcmwsIHNldHRpbmdzICk7CgkJCX0sIHRoaXMpOwoJCX0sCgoJCV9nZXRUcmFuc2l0aW9uSGFuZGxlcjogZnVuY3Rpb24oIHRyYW5zaXRpb24gKSB7CgkJCXRyYW5zaXRpb24gPSAkLm1vYmlsZS5fbWF5YmVEZWdyYWRlVHJhbnNpdGlvbiggdHJhbnNpdGlvbiApOwoKCQkJLy9maW5kIHRoZSB0cmFuc2l0aW9uIGhhbmRsZXIgZm9yIHRoZSBzcGVjaWZpZWQgdHJhbnNpdGlvbi4gSWYgdGhlcmUKCQkJLy9pc24ndCBvbmUgaW4gb3VyIHRyYW5zaXRpb25IYW5kbGVycyBkaWN0aW9uYXJ5LCB1c2UgdGhlIGRlZmF1bHQgb25lLgoJCQkvL2NhbGwgdGhlIGhhbmRsZXIgaW1tZWRpYXRlbHkgdG8ga2ljay1vZmYgdGhlIHRyYW5zaXRpb24uCgkJCXJldHVybiAkLm1vYmlsZS50cmFuc2l0aW9uSGFuZGxlcnNbIHRyYW5zaXRpb24gXSB8fCAkLm1vYmlsZS5kZWZhdWx0VHJhbnNpdGlvbkhhbmRsZXI7CgkJfSwKCgkJLy8gVE9ETyBtb3ZlIGludG8gdHJhbnNpdGlvbiBoYW5kbGVycz8KCQlfdHJpZ2dlckNzc1RyYW5zaXRpb25FdmVudHM6IGZ1bmN0aW9uKCB0bywgZnJvbSwgcHJlZml4ICkgewoJCQlwcmVmaXggPSBwcmVmaXggfHwgIiI7CgoJCQkvLyBUT0RPIGRlY2lkZSBpZiB0aGVzZSBldmVudHMgc2hvdWxkIGluIGZhY3QgYmUgdHJpZ2dlcmVkIG9uIHRoZSBjb250YWluZXIKCQkJaWYgKCBmcm9tICkgewoJCQkJLy90cmlnZ2VyIGJlZm9yZSBzaG93L2hpZGUgZXZlbnRzCgkJCQkvLyBUT0RPIGRlcHJlY2F0ZSBuZXh0UGFnZSBpbiBmYXZvciBvZiBuZXh0CgkJCQl0aGlzLl90cmlnZ2VyV2l0aERlcHJlY2F0ZWQoIHByZWZpeCArICJoaWRlIiwgeyBuZXh0UGFnZTogdG8gfSwgZnJvbSApOwoJCQl9CgoJCQkvLyBUT0RPIGRlcHJlY2F0ZSBwcmV2UGFnZSBpbiBmYXZvciBvZiBwcmV2aW91cwoJCQl0aGlzLl90cmlnZ2VyV2l0aERlcHJlY2F0ZWQoIHByZWZpeCArICJzaG93IiwgeyBwcmV2UGFnZTogZnJvbSB8fCAkKCAiIiApIH0sIHRvICk7CgkJfSwKCgkJLy8gVE9ETyBtYWtlIHByaXZhdGUgb25jZSBjaGFuZ2UgaGFzIGJlZW4gZGVmaW5lZCBpbiB0aGUgd2lkZ2V0CgkJX2Nzc1RyYW5zaXRpb246IGZ1bmN0aW9uKCB0bywgZnJvbSwgb3B0aW9ucyApIHsKCQkJdmFyIHRyYW5zaXRpb24gPSBvcHRpb25zLnRyYW5zaXRpb24sCgkJCQlyZXZlcnNlID0gb3B0aW9ucy5yZXZlcnNlLAoJCQkJZGVmZXJyZWQgPSBvcHRpb25zLmRlZmVycmVkLAoJCQkJVHJhbnNpdGlvbkhhbmRsZXIsCgkJCQlwcm9taXNlOwoKCQkJdGhpcy5fdHJpZ2dlckNzc1RyYW5zaXRpb25FdmVudHMoIHRvLCBmcm9tLCAiYmVmb3JlIiApOwoKCQkJLy8gVE9ETyBwdXQgdGhpcyBpbiBhIGJpbmRpbmcgdG8gZXZlbnRzICpvdXRzaWRlKiB0aGUgd2lkZ2V0CgkJCXRoaXMuX2hpZGVMb2FkaW5nKCk7CgoJCQlUcmFuc2l0aW9uSGFuZGxlciA9IHRoaXMuX2dldFRyYW5zaXRpb25IYW5kbGVyKCB0cmFuc2l0aW9uICk7CgoJCQlwcm9taXNlID0gKCBuZXcgVHJhbnNpdGlvbkhhbmRsZXIoIHRyYW5zaXRpb24sIHJldmVyc2UsIHRvLCBmcm9tICkgKS50cmFuc2l0aW9uKCk7CgoJCQkvLyBUT0RPIHRlbXBvcmFyeSBhY2NvbW9kYXRpb24gb2YgYXJndW1lbnQgZGVmZXJyZWQKCQkJcHJvbWlzZS5kb25lKGZ1bmN0aW9uKCkgewoJCQkJZGVmZXJyZWQucmVzb2x2ZS5hcHBseSggZGVmZXJyZWQsIGFyZ3VtZW50cyApOwoJCQl9KTsKCgkJCXByb21pc2UuZG9uZSgkLnByb3h5KGZ1bmN0aW9uKCkgewoJCQkJdGhpcy5fdHJpZ2dlckNzc1RyYW5zaXRpb25FdmVudHMoIHRvLCBmcm9tICk7CgkJCX0sIHRoaXMpKTsKCQl9LAoKCQlfcmVsZWFzZVRyYW5zaXRpb25Mb2NrOiBmdW5jdGlvbigpIHsKCQkJLy9yZWxlYXNlIHRyYW5zaXRpb24gbG9jayBzbyBuYXZpZ2F0aW9uIGlzIGZyZWUgYWdhaW4KCQkJaXNQYWdlVHJhbnNpdGlvbmluZyA9IGZhbHNlOwoJCQlpZiAoIHBhZ2VUcmFuc2l0aW9uUXVldWUubGVuZ3RoID4gMCApIHsKCQkJCSQubW9iaWxlLmNoYW5nZVBhZ2UuYXBwbHkoIG51bGwsIHBhZ2VUcmFuc2l0aW9uUXVldWUucG9wKCkgKTsKCQkJfQoJCX0sCgoJCV9yZW1vdmVBY3RpdmVMaW5rQ2xhc3M6IGZ1bmN0aW9uKCBmb3JjZSApIHsKCQkJLy9jbGVhciBvdXQgdGhlIGFjdGl2ZSBidXR0b24gc3RhdGUKCQkJJC5tb2JpbGUucmVtb3ZlQWN0aXZlTGlua0NsYXNzKCBmb3JjZSApOwoJCX0sCgoJCV9sb2FkVXJsOiBmdW5jdGlvbiggdG8sIHRyaWdnZXJEYXRhLCBzZXR0aW5ncyApIHsKCQkJLy8gcHJlc2VydmUgdGhlIG9yaWdpbmFsIHRhcmdldCBhcyB0aGUgZGF0YVVybCB2YWx1ZSB3aWxsIGJlCgkJCS8vIHNpbXBsaWZpZWQgZWcsIHJlbW92aW5nIHVpLXN0YXRlLCBhbmQgcmVtb3ZpbmcgcXVlcnkgcGFyYW1zCgkJCS8vIGZyb20gdGhlIGhhc2ggdGhpcyBpcyBzbyB0aGF0IHVzZXJzIHdobyB3YW50IHRvIHVzZSBxdWVyeQoJCQkvLyBwYXJhbXMgaGF2ZSBhY2Nlc3MgdG8gdGhlbSBpbiB0aGUgZXZlbnQgYmluZGluZ3MgZm9yIHRoZSBwYWdlCgkJCS8vIGxpZmUgY3ljbGUgU2VlIGlzc3VlICM1MDg1CgkJCXNldHRpbmdzLnRhcmdldCA9IHRvOwoJCQlzZXR0aW5ncy5kZWZlcnJlZCA9ICQuRGVmZXJyZWQoKTsKCgkJCXRoaXMubG9hZCggdG8sIHNldHRpbmdzICk7CgoJCQlzZXR0aW5ncy5kZWZlcnJlZC5kb25lKCQucHJveHkoZnVuY3Rpb24oIHVybCwgb3B0aW9ucywgY29udGVudCApIHsKCQkJCWlzUGFnZVRyYW5zaXRpb25pbmcgPSBmYWxzZTsKCgkJCQkvLyBzdG9yZSB0aGUgb3JpZ2luYWwgYWJzb2x1dGUgdXJsIHNvIHRoYXQgaXQgY2FuIGJlIHByb3ZpZGVkCgkJCQkvLyB0byBldmVudHMgaW4gdGhlIHRyaWdnZXJEYXRhIG9mIHRoZSBzdWJzZXF1ZW50IGNoYW5nZVBhZ2UgY2FsbAoJCQkJb3B0aW9ucy5hYnNVcmwgPSB0cmlnZ2VyRGF0YS5hYnNVcmw7CgoJCQkJdGhpcy50cmFuc2l0aW9uKCBjb250ZW50LCB0cmlnZ2VyRGF0YSwgb3B0aW9ucyApOwoJCQl9LCB0aGlzKSk7CgoJCQlzZXR0aW5ncy5kZWZlcnJlZC5mYWlsKCQucHJveHkoZnVuY3Rpb24oLyogdXJsLCBvcHRpb25zICovKSB7CgkJCQl0aGlzLl9yZW1vdmVBY3RpdmVMaW5rQ2xhc3MoIHRydWUgKTsKCQkJCXRoaXMuX3JlbGVhc2VUcmFuc2l0aW9uTG9jaygpOwoJCQkJdGhpcy5fdHJpZ2dlcldpdGhEZXByZWNhdGVkKCAiY2hhbmdlZmFpbGVkIiwgdHJpZ2dlckRhdGEgKTsKCQkJfSwgdGhpcykpOwoJCX0sCgoJCV90cmlnZ2VyUGFnZUJlZm9yZUNoYW5nZTogZnVuY3Rpb24oIHRvLCB0cmlnZ2VyRGF0YSwgc2V0dGluZ3MgKSB7CgkJCXZhciBwYmNFdmVudCA9IG5ldyAkLkV2ZW50KCAicGFnZWJlZm9yZWNoYW5nZSIgKTsKCgkJCSQuZXh0ZW5kKHRyaWdnZXJEYXRhLCB7IHRvUGFnZTogdG8sIG9wdGlvbnM6IHNldHRpbmdzIH0pOwoKCQkJLy8gTk9URTogcHJlc2VydmUgdGhlIG9yaWdpbmFsIHRhcmdldCBhcyB0aGUgZGF0YVVybCB2YWx1ZSB3aWxsIGJlCgkJCS8vIHNpbXBsaWZpZWQgZWcsIHJlbW92aW5nIHVpLXN0YXRlLCBhbmQgcmVtb3ZpbmcgcXVlcnkgcGFyYW1zIGZyb20KCQkJLy8gdGhlIGhhc2ggdGhpcyBpcyBzbyB0aGF0IHVzZXJzIHdobyB3YW50IHRvIHVzZSBxdWVyeSBwYXJhbXMgaGF2ZQoJCQkvLyBhY2Nlc3MgdG8gdGhlbSBpbiB0aGUgZXZlbnQgYmluZGluZ3MgZm9yIHRoZSBwYWdlIGxpZmUgY3ljbGUKCQkJLy8gU2VlIGlzc3VlICM1MDg1CgkJCWlmICggJC50eXBlKHRvKSA9PT0gInN0cmluZyIgKSB7CgkJCQkvLyBpZiB0aGUgdG9QYWdlIGlzIGEgc3RyaW5nIHNpbXBseSBjb252ZXJ0IGl0CgkJCQl0cmlnZ2VyRGF0YS5hYnNVcmwgPSAkLm1vYmlsZS5wYXRoLm1ha2VVcmxBYnNvbHV0ZSggdG8sIHRoaXMuX2ZpbmRCYXNlV2l0aERlZmF1bHQoKSApOwoJCQl9IGVsc2UgewoJCQkJLy8gaWYgdGhlIHRvUGFnZSBpcyBhIGpRdWVyeSBvYmplY3QgZ3JhYiB0aGUgYWJzb2x1dGUgdXJsIHN0b3JlZAoJCQkJLy8gaW4gdGhlIGxvYWRQYWdlIGNhbGxiYWNrIHdoZXJlIGl0IGV4aXN0cwoJCQkJdHJpZ2dlckRhdGEuYWJzVXJsID0gc2V0dGluZ3MuYWJzVXJsOwoJCQl9CgoJCQkvLyBMZXQgbGlzdGVuZXJzIGtub3cgd2UncmUgYWJvdXQgdG8gY2hhbmdlIHRoZSBjdXJyZW50IHBhZ2UuCgkJCXRoaXMuZWxlbWVudC50cmlnZ2VyKCBwYmNFdmVudCwgdHJpZ2dlckRhdGEgKTsKCgkJCS8vIElmIHRoZSBkZWZhdWx0IGJlaGF2aW9yIGlzIHByZXZlbnRlZCwgc3RvcCBoZXJlIQoJCQlpZiAoIHBiY0V2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgoJCQlyZXR1cm4gdHJ1ZTsKCQl9LAoKCQljaGFuZ2U6IGZ1bmN0aW9uKCB0bywgb3B0aW9ucyApIHsKCQkJLy8gSWYgd2UgYXJlIGluIHRoZSBtaWRzdCBvZiBhIHRyYW5zaXRpb24sIHF1ZXVlIHRoZSBjdXJyZW50IHJlcXVlc3QuCgkJCS8vIFdlJ2xsIGNhbGwgY2hhbmdlUGFnZSgpIG9uY2Ugd2UncmUgZG9uZSB3aXRoIHRoZSBjdXJyZW50IHRyYW5zaXRpb24KCQkJLy8gdG8gc2VydmljZSB0aGUgcmVxdWVzdC4KCQkJaWYgKCBpc1BhZ2VUcmFuc2l0aW9uaW5nICkgewoJCQkJcGFnZVRyYW5zaXRpb25RdWV1ZS51bnNoaWZ0KCBhcmd1bWVudHMgKTsKCQkJCXJldHVybjsKCQkJfQoKCQkJdmFyIHNldHRpbmdzID0gJC5leHRlbmQoIHt9LCAkLm1vYmlsZS5jaGFuZ2VQYWdlLmRlZmF1bHRzLCBvcHRpb25zICksCgkJCQl0cmlnZ2VyRGF0YSA9IHt9OwoKCQkJLy8gTWFrZSBzdXJlIHdlIGhhdmUgYSBmcm9tUGFnZS4KCQkJc2V0dGluZ3MuZnJvbVBhZ2UgPSBzZXR0aW5ncy5mcm9tUGFnZSB8fCB0aGlzLmFjdGl2ZVBhZ2U7CgoJCQkvLyBpZiB0aGUgcGFnZSBiZWZvcmVjaGFuZ2UgZGVmYXVsdCBpcyBwcmV2ZW50ZWQgcmV0dXJuIGVhcmx5CgkJCWlmICggIXRoaXMuX3RyaWdnZXJQYWdlQmVmb3JlQ2hhbmdlKHRvLCB0cmlnZ2VyRGF0YSwgc2V0dGluZ3MpICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBXZSBhbGxvdyAicGFnZWJlZm9yZWNoYW5nZSIgb2JzZXJ2ZXJzIHRvIG1vZGlmeSB0aGUgdG8gaW4KCQkJLy8gdGhlIHRyaWdnZXIgZGF0YSB0byBhbGxvdyBmb3IgcmVkaXJlY3RzLiBNYWtlIHN1cmUgb3VyIHRvIGlzCgkJCS8vIHVwZGF0ZWQuIFdlIGFsc28gbmVlZCB0byByZS1ldmFsdWF0ZSB3aGV0aGVyIGl0IGlzIGEgc3RyaW5nLAoJCQkvLyBiZWNhdXNlIGFuIG9iamVjdCBjYW4gYWxzbyBiZSByZXBsYWNlZCBieSBhIHN0cmluZwoJCQl0byA9IHRyaWdnZXJEYXRhLnRvUGFnZTsKCgkJCS8vIElmIHRoZSBjYWxsZXIgcGFzc2VkIHVzIGEgdXJsLCBjYWxsIGxvYWRQYWdlKCkKCQkJLy8gdG8gbWFrZSBzdXJlIGl0IGlzIGxvYWRlZCBpbnRvIHRoZSBET00uIFdlJ2xsIGxpc3RlbgoJCQkvLyB0byB0aGUgcHJvbWlzZSBvYmplY3QgaXQgcmV0dXJucyBzbyB3ZSBrbm93IHdoZW4KCQkJLy8gaXQgaXMgZG9uZSBsb2FkaW5nIG9yIGlmIGFuIGVycm9yIG9jdXJyZWQuCgkJCWlmICggJC50eXBlKHRvKSA9PT0gInN0cmluZyIgKSB7CgkJCQkvLyBTZXQgdGhlIGlzUGFnZVRyYW5zaXRpb25pbmcgZmxhZyB0byBwcmV2ZW50IGFueSByZXF1ZXN0cyBmcm9tCgkJCQkvLyBlbnRlcmluZyB0aGlzIG1ldGhvZCB3aGlsZSB3ZSBhcmUgaW4gdGhlIG1pZHN0IG9mIGxvYWRpbmcgYSBwYWdlCgkJCQkvLyBvciB0cmFuc2l0aW9uaW5nLgoJCQkJaXNQYWdlVHJhbnNpdGlvbmluZyA9IHRydWU7CgoJCQkJdGhpcy5fbG9hZFVybCggdG8sIHRyaWdnZXJEYXRhLCBzZXR0aW5ncyApOwoJCQl9IGVsc2UgewoJCQkJdGhpcy50cmFuc2l0aW9uKCB0bywgdHJpZ2dlckRhdGEsIHNldHRpbmdzICk7CgkJCX0KCQl9LAoKCQl0cmFuc2l0aW9uOiBmdW5jdGlvbiggdG9QYWdlLCB0cmlnZ2VyRGF0YSwgc2V0dGluZ3MgKSB7CgkJCXZhciBmcm9tUGFnZSwgdXJsLCBwYWdlVXJsLCBmaWxlVXJsLAoJCQkJYWN0aXZlLCBhY3RpdmVJc0luaXRpYWxQYWdlLAoJCQkJaGlzdG9yeURpciwgcGFnZVRpdGxlLCBpc0RpYWxvZywKCQkJCWFscmVhZHlUaGVyZSwgbmV3UGFnZVRpdGxlLAoJCQkJcGFyYW1zLAljc3NUcmFuc2l0aW9uRGVmZXJyZWQsCgkJCQliZWZvcmVUcmFuc2l0aW9uOwoKCQkJLy8gSWYgd2UgYXJlIGluIHRoZSBtaWRzdCBvZiBhIHRyYW5zaXRpb24sIHF1ZXVlIHRoZSBjdXJyZW50IHJlcXVlc3QuCgkJCS8vIFdlJ2xsIGNhbGwgY2hhbmdlUGFnZSgpIG9uY2Ugd2UncmUgZG9uZSB3aXRoIHRoZSBjdXJyZW50IHRyYW5zaXRpb24KCQkJLy8gdG8gc2VydmljZSB0aGUgcmVxdWVzdC4KCQkJaWYgKCBpc1BhZ2VUcmFuc2l0aW9uaW5nICkgewoJCQkJLy8gbWFrZSBzdXJlIHRvIG9ubHkgcXVldWUgdGhlIHRvIGFuZCBzZXR0aW5ncyB2YWx1ZXMgc28gdGhlIGFyZ3VtZW50cwoJCQkJLy8gd29yayB3aXRoIGEgY2FsbCB0byB0aGUgY2hhbmdlIG1ldGhvZAoJCQkJcGFnZVRyYW5zaXRpb25RdWV1ZS51bnNoaWZ0KCBbdG9QYWdlLCBzZXR0aW5nc10gKTsKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gREVQUkVDQVRFRCAtIHRoaXMgY2FsbCBvbmx5LCBpbiBmYXZvciBvZiB0aGUgYmVmb3JlIHRyYW5zaXRpb24KCQkJLy8gaWYgdGhlIHBhZ2UgYmVmb3JlY2hhbmdlIGRlZmF1bHQgaXMgcHJldmVudGVkIHJldHVybiBlYXJseQoJCQlpZiAoICF0aGlzLl90cmlnZ2VyUGFnZUJlZm9yZUNoYW5nZSh0b1BhZ2UsIHRyaWdnZXJEYXRhLCBzZXR0aW5ncykgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIGlmIHRoZSAoY29udGVudHxwYWdlKWJlZm9yZXRyYW5zaXRpb24gZGVmYXVsdCBpcyBwcmV2ZW50ZWQgcmV0dXJuIGVhcmx5CgkJCS8vIE5vdGUsIHdlIGhhdmUgdG8gY2hlY2sgZm9yIGJvdGggdGhlIGRlcHJlY2F0ZWQgYW5kIG5ldyBldmVudHMKCQkJYmVmb3JlVHJhbnNpdGlvbiA9IHRoaXMuX3RyaWdnZXJXaXRoRGVwcmVjYXRlZCggImJlZm9yZXRyYW5zaXRpb24iLCB0cmlnZ2VyRGF0YSApOwoJCQlpZiAoYmVmb3JlVHJhbnNpdGlvbi5kZXByZWNhdGVkRXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgfHwKCQkJCWJlZm9yZVRyYW5zaXRpb24uZXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIFNldCB0aGUgaXNQYWdlVHJhbnNpdGlvbmluZyBmbGFnIHRvIHByZXZlbnQgYW55IHJlcXVlc3RzIGZyb20KCQkJLy8gZW50ZXJpbmcgdGhpcyBtZXRob2Qgd2hpbGUgd2UgYXJlIGluIHRoZSBtaWRzdCBvZiBsb2FkaW5nIGEgcGFnZQoJCQkvLyBvciB0cmFuc2l0aW9uaW5nLgoJCQlpc1BhZ2VUcmFuc2l0aW9uaW5nID0gdHJ1ZTsKCgkJCS8vIElmIHdlIGFyZSBnb2luZyB0byB0aGUgZmlyc3QtcGFnZSBvZiB0aGUgYXBwbGljYXRpb24sIHdlIG5lZWQgdG8gbWFrZQoJCQkvLyBzdXJlIHNldHRpbmdzLmRhdGFVcmwgaXMgc2V0IHRvIHRoZSBhcHBsaWNhdGlvbiBkb2N1bWVudCB1cmwuIFRoaXMgYWxsb3dzCgkJCS8vIHVzIHRvIGF2b2lkIGdlbmVyYXRpbmcgYSBkb2N1bWVudCB1cmwgd2l0aCBhbiBpZCBoYXNoIGluIHRoZSBjYXNlIHdoZXJlIHRoZQoJCQkvLyBmaXJzdC1wYWdlIG9mIHRoZSBkb2N1bWVudCBoYXMgYW4gaWQgYXR0cmlidXRlIHNwZWNpZmllZC4KCQkJaWYgKCB0b1BhZ2VbIDAgXSA9PT0gJC5tb2JpbGUuZmlyc3RQYWdlWyAwIF0gJiYgIXNldHRpbmdzLmRhdGFVcmwgKSB7CgkJCQlzZXR0aW5ncy5kYXRhVXJsID0gJC5tb2JpbGUucGF0aC5kb2N1bWVudFVybC5ocmVmTm9IYXNoOwoJCQl9CgoJCQkvLyBUaGUgY2FsbGVyIHBhc3NlZCB1cyBhIHJlYWwgcGFnZSBET00gZWxlbWVudC4gVXBkYXRlIG91cgoJCQkvLyBpbnRlcm5hbCBzdGF0ZSBhbmQgdGhlbiB0cmlnZ2VyIGEgdHJhbnNpdGlvbiB0byB0aGUgcGFnZS4KCQkJZnJvbVBhZ2UgPSBzZXR0aW5ncy5mcm9tUGFnZTsKCQkJdXJsID0gKCBzZXR0aW5ncy5kYXRhVXJsICYmICQubW9iaWxlLnBhdGguY29udmVydFVybFRvRGF0YVVybChzZXR0aW5ncy5kYXRhVXJsKSApIHx8CgkJCQl0b1BhZ2UuanFtRGF0YSggInVybCIgKTsKCgkJCS8vIFRoZSBwYWdlVXJsIHZhciBpcyB1c3VhbGx5IHRoZSBzYW1lIGFzIHVybCwgZXhjZXB0IHdoZW4gdXJsIGlzIG9ic2N1cmVkCgkJCS8vIGFzIGEgZGlhbG9nIHVybC4gcGFnZVVybCBhbHdheXMgY29udGFpbnMgdGhlIGZpbGUgcGF0aAoJCQlwYWdlVXJsID0gdXJsOwoJCQlmaWxlVXJsID0gJC5tb2JpbGUucGF0aC5nZXRGaWxlUGF0aCggdXJsICk7CgkJCWFjdGl2ZSA9ICQubW9iaWxlLm5hdmlnYXRlLmhpc3RvcnkuZ2V0QWN0aXZlKCk7CgkJCWFjdGl2ZUlzSW5pdGlhbFBhZ2UgPSAkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5LmFjdGl2ZUluZGV4ID09PSAwOwoJCQloaXN0b3J5RGlyID0gMDsKCQkJcGFnZVRpdGxlID0gZG9jdW1lbnQudGl0bGU7CgkJCWlzRGlhbG9nID0gKCBzZXR0aW5ncy5yb2xlID09PSAiZGlhbG9nIiB8fAoJCQkJdG9QYWdlLmpxbURhdGEoICJyb2xlIiApID09PSAiZGlhbG9nIiApICYmCgkJCQl0b1BhZ2UuanFtRGF0YSggImRpYWxvZyIgKSAhPT0gdHJ1ZTsKCgkJCS8vIEJ5IGRlZmF1bHQsIHdlIHByZXZlbnQgY2hhbmdlUGFnZSByZXF1ZXN0cyB3aGVuIHRoZSBmcm9tUGFnZSBhbmQgdG9QYWdlCgkJCS8vIGFyZSB0aGUgc2FtZSBlbGVtZW50LCBidXQgZm9sa3MgdGhhdCBnZW5lcmF0ZSBjb250ZW50CgkJCS8vIG1hbnVhbGx5L2R5bmFtaWNhbGx5IGFuZCByZXVzZSBwYWdlcyB3YW50IHRvIGJlIGFibGUgdG8gdHJhbnNpdGlvbiB0bwoJCQkvLyB0aGUgc2FtZSBwYWdlLiBUbyBhbGxvdyB0aGlzLCB0aGV5IHdpbGwgbmVlZCB0byBjaGFuZ2UgdGhlIGRlZmF1bHQKCQkJLy8gdmFsdWUgb2YgYWxsb3dTYW1lUGFnZVRyYW5zaXRpb24gdG8gdHJ1ZSwgKk9SKiwgcGFzcyBpdCBpbiBhcyBhbgoJCQkvLyBvcHRpb24gd2hlbiB0aGV5IG1hbnVhbGx5IGNhbGwgY2hhbmdlUGFnZSgpLiBJdCBzaG91bGQgYmUgbm90ZWQgdGhhdAoJCQkvLyBvdXIgZGVmYXVsdCB0cmFuc2l0aW9uIGFuaW1hdGlvbnMgYXNzdW1lIHRoYXQgdGhlIGZvcm1QYWdlIGFuZCB0b1BhZ2UKCQkJLy8gYXJlIGRpZmZlcmVudCBlbGVtZW50cywgc28gdGhleSBtYXkgYmVoYXZlIHVuZXhwZWN0ZWRseS4gSXQgaXMgdXAgdG8KCQkJLy8gdGhlIGRldmVsb3BlciB0aGF0IHR1cm5zIG9uIHRoZSBhbGxvd1NhbWVQYWdlVHJhbnNpdGlvbmEgb3B0aW9uIHRvCgkJCS8vIGVpdGhlciB0dXJuIG9mZiB0cmFuc2l0aW9uIGFuaW1hdGlvbnMsIG9yIG1ha2Ugc3VyZSB0aGF0IGFuIGFwcHJvcHJpYXRlCgkJCS8vIGFuaW1hdGlvbiB0cmFuc2l0aW9uIGlzIHVzZWQuCgkJCWlmICggZnJvbVBhZ2UgJiYgZnJvbVBhZ2VbMF0gPT09IHRvUGFnZVswXSAmJgoJCQkJIXNldHRpbmdzLmFsbG93U2FtZVBhZ2VUcmFuc2l0aW9uICkgewoKCQkJCWlzUGFnZVRyYW5zaXRpb25pbmcgPSBmYWxzZTsKCQkJCXRoaXMuX3RyaWdnZXJXaXRoRGVwcmVjYXRlZCggInRyYW5zaXRpb24iLCB0cmlnZ2VyRGF0YSApOwoJCQkJdGhpcy5lbGVtZW50LnRyaWdnZXIoICJwYWdlY2hhbmdlIiwgdHJpZ2dlckRhdGEgKTsKCgkJCQkvLyBFdmVuIGlmIHRoZXJlIGlzIG5vIHBhZ2UgY2hhbmdlIHRvIGJlIGRvbmUsIHdlIHNob3VsZCBrZWVwIHRoZQoJCQkJLy8gdXJsSGlzdG9yeSBpbiBzeW5jIHdpdGggdGhlIGhhc2ggY2hhbmdlcwoJCQkJaWYgKCBzZXR0aW5ncy5mcm9tSGFzaENoYW5nZSApIHsKCQkJCQkkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5LmRpcmVjdCh7IHVybDogdXJsIH0pOwoJCQkJfQoKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gV2UgbmVlZCB0byBtYWtlIHN1cmUgdGhlIHBhZ2Ugd2UgYXJlIGdpdmVuIGhhcyBhbHJlYWR5IGJlZW4gZW5oYW5jZWQuCgkJCXRvUGFnZS5wYWdlKHsgcm9sZTogc2V0dGluZ3Mucm9sZSB9KTsKCgkJCS8vIElmIHRoZSBjaGFuZ2VQYWdlIHJlcXVlc3Qgd2FzIHNlbnQgZnJvbSBhIGhhc2hDaGFuZ2UgZXZlbnQsIGNoZWNrIHRvCgkJCS8vIHNlZSBpZiB0aGUgcGFnZSBpcyBhbHJlYWR5IHdpdGhpbiB0aGUgdXJsSGlzdG9yeSBzdGFjay4gSWYgc28sIHdlJ2xsCgkJCS8vIGFzc3VtZSB0aGUgdXNlciBoaXQgdGhlIGZvcndhcmQvYmFjayBidXR0b24gYW5kIHdpbGwgdHJ5IHRvIG1hdGNoIHRoZQoJCQkvLyB0cmFuc2l0aW9uIGFjY29yZGluZ2x5LgoJCQlpZiAoIHNldHRpbmdzLmZyb21IYXNoQ2hhbmdlICkgewoJCQkJaGlzdG9yeURpciA9IHNldHRpbmdzLmRpcmVjdGlvbiA9PT0gImJhY2siID8gLTEgOiAxOwoJCQl9CgoJCQkvLyBLaWxsIHRoZSBrZXlib2FyZC4KCQkJLy8gWFhYX2pibGFzOiBXZSBuZWVkIHRvIHN0b3AgY3Jhd2xpbmcgdGhlIGVudGlyZSBkb2N1bWVudCB0byBraWxsIGZvY3VzLgoJCQkvLyAgICAgICAgICAgIEluc3RlYWQsIHdlIHNob3VsZCBiZSB0cmFja2luZyBmb2N1cyB3aXRoIGEgZGVsZWdhdGUoKQoJCQkvLyAgICAgICAgICAgIGhhbmRsZXIgc28gd2UgYWxyZWFkeSBoYXZlIHRoZSBlbGVtZW50IGluIGhhbmQgYXQgdGhpcwoJCQkvLyAgICAgICAgICAgIHBvaW50LgoJCQkvLyBXcmFwIHRoaXMgaW4gYSB0cnkvY2F0Y2ggYmxvY2sgc2luY2UgSUU5IHRocm93ICJVbnNwZWNpZmllZCBlcnJvciIgaWYKCQkJLy8gZG9jdW1lbnQuYWN0aXZlRWxlbWVudCBpcyB1bmRlZmluZWQgd2hlbiB3ZSBhcmUgaW4gYW4gSUZyYW1lLgoJCQl0cnkgewoJCQkJaWYgKCBkb2N1bWVudC5hY3RpdmVFbGVtZW50ICYmCgkJCQkJZG9jdW1lbnQuYWN0aXZlRWxlbWVudC5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpICE9PSAiYm9keSIgKSB7CgoJCQkJCSQoIGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQgKS5ibHVyKCk7CgkJCQl9IGVsc2UgewoJCQkJCSQoICJpbnB1dDpmb2N1cywgdGV4dGFyZWE6Zm9jdXMsIHNlbGVjdDpmb2N1cyIgKS5ibHVyKCk7CgkJCQl9CgkJCX0gY2F0Y2goIGUgKSB7fQoKCQkJLy8gUmVjb3JkIHdoZXRoZXIgd2UgYXJlIGF0IGEgcGxhY2UgaW4gaGlzdG9yeSB3aGVyZSBhIGRpYWxvZyB1c2VkIHRvIGJlIC0KCQkJLy8gaWYgc28sIGRvIG5vdCBhZGQgYSBuZXcgaGlzdG9yeSBlbnRyeSBhbmQgZG8gbm90IGNoYW5nZSB0aGUgaGFzaCBlaXRoZXIKCQkJYWxyZWFkeVRoZXJlID0gZmFsc2U7CgoJCQkvLyBJZiB3ZSdyZSBkaXNwbGF5aW5nIHRoZSBwYWdlIGFzIGEgZGlhbG9nLCB3ZSBkb24ndCB3YW50IHRoZSB1cmwKCQkJLy8gZm9yIHRoZSBkaWFsb2cgY29udGVudCB0byBiZSB1c2VkIGluIHRoZSBoYXNoLiBJbnN0ZWFkLCB3ZSB3YW50CgkJCS8vIHRvIGFwcGVuZCB0aGUgZGlhbG9nSGFzaEtleSB0byB0aGUgdXJsIG9mIHRoZSBjdXJyZW50IHBhZ2UuCgkJCWlmICggaXNEaWFsb2cgJiYgYWN0aXZlICkgewoJCQkJLy8gb24gdGhlIGluaXRpYWwgcGFnZSBsb2FkIGFjdGl2ZS51cmwgaXMgdW5kZWZpbmVkIGFuZCBpbiB0aGF0IGNhc2UKCQkJCS8vIHNob3VsZCBiZSBhbiBlbXB0eSBzdHJpbmcuIE1vdmluZyB0aGUgdW5kZWZpbmVkIC0+IGVtcHR5IHN0cmluZyBiYWNrCgkJCQkvLyBpbnRvIHVybEhpc3RvcnkuYWRkTmV3IHNlZW1lZCBpbXBydWRlbnQgZ2l2ZW4gdW5kZWZpbmVkIGJldHRlcgoJCQkJLy8gcmVwcmVzZW50cyB0aGUgdXJsIHN0YXRlCgoJCQkJLy8gSWYgd2UgYXJlIGF0IGEgcGxhY2UgaW4gaGlzdG9yeSB0aGF0IG9uY2UgYmVsb25nZWQgdG8gYSBkaWFsb2csIHJldXNlCgkJCQkvLyB0aGlzIHN0YXRlIHdpdGhvdXQgYWRkaW5nIHRvIHVybEhpc3RvcnkgYW5kIHdpdGhvdXQgbW9kaWZ5aW5nIHRoZQoJCQkJLy8gaGFzaC4gSG93ZXZlciwgaWYgYSBkaWFsb2cgaXMgYWxyZWFkeSBkaXNwbGF5ZWQgYXQgdGhpcyBwb2ludCwgYW5kCgkJCQkvLyB3ZSdyZSBhYm91dCB0byBkaXNwbGF5IGFub3RoZXIgZGlhbG9nLCB0aGVuIHdlIG11c3QgYWRkIGFub3RoZXIgaGFzaAoJCQkJLy8gYW5kIGhpc3RvcnkgZW50cnkgb24gdG9wIHNvIHRoYXQgb25lIG1heSBuYXZpZ2F0ZSBiYWNrIHRvIHRoZQoJCQkJLy8gb3JpZ2luYWwgZGlhbG9nCgkJCQlpZiAoIGFjdGl2ZS51cmwgJiYKCQkJCQlhY3RpdmUudXJsLmluZGV4T2YoICQubW9iaWxlLmRpYWxvZ0hhc2hLZXkgKSA+IC0xICYmCgkJCQkJdGhpcy5hY3RpdmVQYWdlICYmCgkJCQkJIXRoaXMuYWN0aXZlUGFnZS5oYXNDbGFzcyggInVpLWRpYWxvZyIgKSAmJgoJCQkJCSQubW9iaWxlLm5hdmlnYXRlLmhpc3RvcnkuYWN0aXZlSW5kZXggPiAwICkgewoKCQkJCQlzZXR0aW5ncy5jaGFuZ2VIYXNoID0gZmFsc2U7CgkJCQkJYWxyZWFkeVRoZXJlID0gdHJ1ZTsKCQkJCX0KCgkJCQkvLyBOb3JtYWxseSwgd2UgdGFjayBvbiBhIGRpYWxvZyBoYXNoIGtleSwgYnV0IGlmIHRoaXMgaXMgdGhlIGxvY2F0aW9uCgkJCQkvLyBvZiBhIHN0YWxlIGRpYWxvZywgd2UgcmV1c2UgdGhlIFVSTCBmcm9tIHRoZSBlbnRyeQoJCQkJdXJsID0gKCBhY3RpdmUudXJsIHx8ICIiICk7CgoJCQkJLy8gYWNjb3VudCBmb3IgYWJzb2x1dGUgdXJscyBpbnN0ZWFkIG9mIGp1c3QgcmVsYXRpdmUgdXJscyB1c2UgYXMgaGFzaGVzCgkJCQlpZiAoICFhbHJlYWR5VGhlcmUgJiYgdXJsLmluZGV4T2YoIiMiKSA+IC0xICkgewoJCQkJCXVybCArPSAkLm1vYmlsZS5kaWFsb2dIYXNoS2V5OwoJCQkJfSBlbHNlIHsKCQkJCQl1cmwgKz0gIiMiICsgJC5tb2JpbGUuZGlhbG9nSGFzaEtleTsKCQkJCX0KCgkJCQkvLyB0YWNrIG9uIGFub3RoZXIgZGlhbG9nSGFzaEtleSBpZiB0aGlzIGlzIHRoZSBzYW1lIGFzIHRoZSBpbml0aWFsIGhhc2gKCQkJCS8vIHRoaXMgbWFrZXMgc3VyZSB0aGF0IGEgaGlzdG9yeSBlbnRyeSBpcyBjcmVhdGVkIGZvciB0aGlzIGRpYWxvZwoJCQkJaWYgKCAkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5LmFjdGl2ZUluZGV4ID09PSAwICYmIHVybCA9PT0gJC5tb2JpbGUubmF2aWdhdGUuaGlzdG9yeS5pbml0aWFsRHN0ICkgewoJCQkJCXVybCArPSAkLm1vYmlsZS5kaWFsb2dIYXNoS2V5OwoJCQkJfQoJCQl9CgoJCQkvLyBpZiB0aXRsZSBlbGVtZW50IHdhc24ndCBmb3VuZCwgdHJ5IHRoZSBwYWdlIGRpdiBkYXRhIGF0dHIgdG9vCgkJCS8vIElmIHRoaXMgaXMgYSBkZWVwLWxpbmsgb3IgYSByZWxvYWQgKCBhY3RpdmUgPT09IHVuZGVmaW5lZCApIHRoZW4ganVzdAoJCQkvLyB1c2UgcGFnZVRpdGxlCgkJCW5ld1BhZ2VUaXRsZSA9ICggIWFjdGl2ZSApID8gcGFnZVRpdGxlIDogdG9QYWdlLmpxbURhdGEoICJ0aXRsZSIgKSB8fAoJCQkJdG9QYWdlLmNoaWxkcmVuKCAiOmpxbURhdGEocm9sZT0naGVhZGVyJykiICkuZmluZCggIi51aS10aXRsZSIgKS50ZXh0KCk7CgkJCWlmICggISFuZXdQYWdlVGl0bGUgJiYgcGFnZVRpdGxlID09PSBkb2N1bWVudC50aXRsZSApIHsKCQkJCXBhZ2VUaXRsZSA9IG5ld1BhZ2VUaXRsZTsKCQkJfQoJCQlpZiAoICF0b1BhZ2UuanFtRGF0YSggInRpdGxlIiApICkgewoJCQkJdG9QYWdlLmpxbURhdGEoICJ0aXRsZSIsIHBhZ2VUaXRsZSApOwoJCQl9CgoJCQkvLyBNYWtlIHN1cmUgd2UgaGF2ZSBhIHRyYW5zaXRpb24gZGVmaW5lZC4KCQkJc2V0dGluZ3MudHJhbnNpdGlvbiA9IHNldHRpbmdzLnRyYW5zaXRpb24gfHwKCQkJCSggKCBoaXN0b3J5RGlyICYmICFhY3RpdmVJc0luaXRpYWxQYWdlICkgPyBhY3RpdmUudHJhbnNpdGlvbiA6IHVuZGVmaW5lZCApIHx8CgkJCQkoIGlzRGlhbG9nID8gJC5tb2JpbGUuZGVmYXVsdERpYWxvZ1RyYW5zaXRpb24gOiAkLm1vYmlsZS5kZWZhdWx0UGFnZVRyYW5zaXRpb24gKTsKCgkJCS8vYWRkIHBhZ2UgdG8gaGlzdG9yeSBzdGFjayBpZiBpdCdzIG5vdCBiYWNrIG9yIGZvcndhcmQKCQkJaWYgKCAhaGlzdG9yeURpciAmJiBhbHJlYWR5VGhlcmUgKSB7CgkJCQkkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5LmdldEFjdGl2ZSgpLnBhZ2VVcmwgPSBwYWdlVXJsOwoJCQl9CgoJCQkvLyBTZXQgdGhlIGxvY2F0aW9uIGhhc2guCgkJCWlmICggdXJsICYmICFzZXR0aW5ncy5mcm9tSGFzaENoYW5nZSApIHsKCgkJCQkvLyByZWJ1aWxkaW5nIHRoZSBoYXNoIGhlcmUgc2luY2Ugd2UgbG9vc2UgaXQgZWFybGllciBvbgoJCQkJLy8gVE9ETyBwcmVzZXJ2ZSB0aGUgb3JpZ2luYWxseSBwYXNzZWQgaW4gcGF0aAoJCQkJaWYgKCAhJC5tb2JpbGUucGF0aC5pc1BhdGgoIHVybCApICYmIHVybC5pbmRleE9mKCAiIyIgKSA8IDAgKSB7CgkJCQkJdXJsID0gIiMiICsgdXJsOwoJCQkJfQoKCQkJCS8vIFRPRE8gdGhlIHByb3BlcnR5IG5hbWVzIGhlcmUgYXJlIGp1c3Qgc2lsbHkKCQkJCXBhcmFtcyA9IHsKCQkJCQl0cmFuc2l0aW9uOiBzZXR0aW5ncy50cmFuc2l0aW9uLAoJCQkJCXRpdGxlOiBwYWdlVGl0bGUsCgkJCQkJcGFnZVVybDogcGFnZVVybCwKCQkJCQlyb2xlOiBzZXR0aW5ncy5yb2xlCgkJCQl9OwoKCQkJCWlmICggc2V0dGluZ3MuY2hhbmdlSGFzaCAhPT0gZmFsc2UgJiYgJC5tb2JpbGUuaGFzaExpc3RlbmluZ0VuYWJsZWQgKSB7CgkJCQkJJC5tb2JpbGUubmF2aWdhdGUoIHVybCwgcGFyYW1zLCB0cnVlKTsKCQkJCX0gZWxzZSBpZiAoIHRvUGFnZVsgMCBdICE9PSAkLm1vYmlsZS5maXJzdFBhZ2VbIDAgXSApIHsKCQkJCQkkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5LmFkZCggdXJsLCBwYXJhbXMgKTsKCQkJCX0KCQkJfQoKCQkJLy9zZXQgcGFnZSB0aXRsZQoJCQlkb2N1bWVudC50aXRsZSA9IHBhZ2VUaXRsZTsKCgkJCS8vc2V0ICJ0b1BhZ2UiIGFzIGFjdGl2ZVBhZ2UgZGVwcmVjYXRlZCBpbiAxLjQgcmVtb3ZlIGluIDEuNQoJCQkkLm1vYmlsZS5hY3RpdmVQYWdlID0gdG9QYWdlOwoKCQkJLy9uZXcgd2F5IHRvIGhhbmRsZSBhY3RpdmVQYWdlCgkJCXRoaXMuYWN0aXZlUGFnZSA9IHRvUGFnZTsKCgkJCS8vIElmIHdlJ3JlIG5hdmlnYXRpbmcgYmFjayBpbiB0aGUgVVJMIGhpc3RvcnksIHNldCByZXZlcnNlIGFjY29yZGluZ2x5LgoJCQlzZXR0aW5ncy5yZXZlcnNlID0gc2V0dGluZ3MucmV2ZXJzZSB8fCBoaXN0b3J5RGlyIDwgMDsKCgkJCWNzc1RyYW5zaXRpb25EZWZlcnJlZCA9ICQuRGVmZXJyZWQoKTsKCgkJCXRoaXMuX2Nzc1RyYW5zaXRpb24odG9QYWdlLCBmcm9tUGFnZSwgewoJCQkJdHJhbnNpdGlvbjogc2V0dGluZ3MudHJhbnNpdGlvbiwKCQkJCXJldmVyc2U6IHNldHRpbmdzLnJldmVyc2UsCgkJCQlkZWZlcnJlZDogY3NzVHJhbnNpdGlvbkRlZmVycmVkCgkJCX0pOwoKCQkJY3NzVHJhbnNpdGlvbkRlZmVycmVkLmRvbmUoJC5wcm94eShmdW5jdGlvbiggbmFtZSwgcmV2ZXJzZSwgJHRvLCAkZnJvbSwgYWxyZWFkeUZvY3VzZWQgKSB7CgkJCQkkLm1vYmlsZS5yZW1vdmVBY3RpdmVMaW5rQ2xhc3MoKTsKCgkJCQkvL2lmIHRoZXJlJ3MgYSBkdXBsaWNhdGVDYWNoZWRQYWdlLCByZW1vdmUgaXQgZnJvbSB0aGUgRE9NIG5vdyB0aGF0IGl0J3MgaGlkZGVuCgkJCQlpZiAoIHNldHRpbmdzLmR1cGxpY2F0ZUNhY2hlZFBhZ2UgKSB7CgkJCQkJc2V0dGluZ3MuZHVwbGljYXRlQ2FjaGVkUGFnZS5yZW1vdmUoKTsKCQkJCX0KCgkJCQkvLyBkZXNwaXRlIHZpc2liaWxpdHk6IGhpZGRlbiBhZGRyZXNzZXMgaXNzdWUgIzI5NjUKCQkJCS8vIGh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5LW1vYmlsZS9pc3N1ZXMvMjk2NQoJCQkJaWYgKCAhYWxyZWFkeUZvY3VzZWQgKSB7CgkJCQkJJC5tb2JpbGUuZm9jdXNQYWdlKCB0b1BhZ2UgKTsKCQkJCX0KCgkJCQl0aGlzLl9yZWxlYXNlVHJhbnNpdGlvbkxvY2soKTsKCQkJCXRoaXMuZWxlbWVudC50cmlnZ2VyKCAicGFnZWNoYW5nZSIsIHRyaWdnZXJEYXRhICk7CgkJCQl0aGlzLl90cmlnZ2VyV2l0aERlcHJlY2F0ZWQoICJ0cmFuc2l0aW9uIiwgdHJpZ2dlckRhdGEgKTsKCQkJfSwgdGhpcykpOwoJCX0sCgoJCS8vIGRldGVybWluZSB0aGUgY3VycmVudCBiYXNlIHVybAoJCV9maW5kQmFzZVdpdGhEZWZhdWx0OiBmdW5jdGlvbigpIHsKCQkJdmFyIGNsb3Nlc3RCYXNlID0gKCB0aGlzLmFjdGl2ZVBhZ2UgJiYKCQkJJC5tb2JpbGUuZ2V0Q2xvc2VzdEJhc2VVcmwoIHRoaXMuYWN0aXZlUGFnZSApICk7CgkJcmV0dXJuIGNsb3Nlc3RCYXNlIHx8ICQubW9iaWxlLnBhdGguZG9jdW1lbnRCYXNlLmhyZWZOb0hhc2g7CgkJfQoJfSk7CgoJLy8gVGhlIGZvbGxvd2luZyBoYW5kbGVycyBzaG91bGQgYmUgYm91bmQgYWZ0ZXIgbW9iaWxlaW5pdCBoYXMgYmVlbiB0cmlnZ2VyZWQKCS8vIHRoZSBmb2xsb3dpbmcgZGVmZXJyZWQgaXMgcmVzb2x2ZWQgaW4gdGhlIGluaXQgZmlsZQoJJC5tb2JpbGUubmF2cmVhZHlEZWZlcnJlZCA9ICQuRGVmZXJyZWQoKTsKCgkvL3RoZXNlIHZhcmlhYmxlcyBtYWtlIGFsbCBwYWdlIGNvbnRhaW5lcnMgdXNlIHRoZSBzYW1lIHF1ZXVlIGFuZCBvbmx5IG5hdmlnYXRlIG9uZSBhdCBhIHRpbWUKCS8vIHF1ZXVlIHRvIGhvbGQgc2ltdWx0YW5pb3VzIHBhZ2UgdHJhbnNpdGlvbnMKCXZhciBwYWdlVHJhbnNpdGlvblF1ZXVlID0gW10sCgoJCS8vIGluZGljYXRlcyB3aGV0aGVyIG9yIG5vdCBwYWdlIGlzIGluIHByb2Nlc3Mgb2YgdHJhbnNpdGlvbmluZwoJCWlzUGFnZVRyYW5zaXRpb25pbmcgPSBmYWxzZTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKCQkvLyByZXNvbHZlZCBvbiBkb21yZWFkeQoJdmFyIGRvbXJlYWR5RGVmZXJyZWQgPSAkLkRlZmVycmVkKCksCgkJZG9jdW1lbnRVcmwgPSAkLm1vYmlsZS5wYXRoLmRvY3VtZW50VXJsLAoKCQkvLyB1c2VkIHRvIHRyYWNrIGxhc3QgdmNsaWNrZWQgZWxlbWVudCB0byBtYWtlIHN1cmUgaXRzIHZhbHVlIGlzIGFkZGVkIHRvIGZvcm0gZGF0YQoJCSRsYXN0VkNsaWNrZWQgPSBudWxsOwoKCS8qIEV2ZW50IEJpbmRpbmdzIC0gaGFzaGNoYW5nZSwgc3VibWl0LCBhbmQgY2xpY2sgKi8KCWZ1bmN0aW9uIGZpbmRDbG9zZXN0TGluayggZWxlICkJewoJCXdoaWxlICggZWxlICkgewoJCQkvLyBMb29rIGZvciB0aGUgY2xvc2VzdCBlbGVtZW50IHdpdGggYSBub2RlTmFtZSBvZiAiYSIuCgkJCS8vIE5vdGUgdGhhdCB3ZSBhcmUgY2hlY2tpbmcgaWYgd2UgaGF2ZSBhIHZhbGlkIG5vZGVOYW1lCgkJCS8vIGJlZm9yZSBhdHRlbXB0aW5nIHRvIGFjY2VzcyBpdC4gVGhpcyBpcyBiZWNhdXNlIHRoZQoJCQkvLyBub2RlIHdlIGdldCBjYWxsZWQgd2l0aCBjb3VsZCBoYXZlIG9yaWdpbmF0ZWQgZnJvbSB3aXRoaW4KCQkJLy8gYW4gZW1iZWRkZWQgU1ZHIGRvY3VtZW50IHdoZXJlIHNvbWUgc3ltYm9sIGluc3RhbmNlIGVsZW1lbnRzCgkJCS8vIGRvbid0IGhhdmUgbm9kZU5hbWUgZGVmaW5lZCBvbiB0aGVtLCBvciBzdHJpbmdzIGFyZSBvZiB0eXBlCgkJCS8vIFNWR0FuaW1hdGVkU3RyaW5nLgoJCQlpZiAoICggdHlwZW9mIGVsZS5ub2RlTmFtZSA9PT0gInN0cmluZyIgKSAmJiBlbGUubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gImEiICkgewoJCQkJYnJlYWs7CgkJCX0KCQkJZWxlID0gZWxlLnBhcmVudE5vZGU7CgkJfQoJCXJldHVybiBlbGU7Cgl9CgoJJC5tb2JpbGUubG9hZFBhZ2UgPSBmdW5jdGlvbiggdXJsLCBvcHRzICkgewoJCXZhciBjb250YWluZXI7CgoJCW9wdHMgPSBvcHRzIHx8IHt9OwoJCWNvbnRhaW5lciA9ICggb3B0cy5wYWdlQ29udGFpbmVyIHx8ICQubW9iaWxlLnBhZ2VDb250YWluZXIgKTsKCgkJLy8gY3JlYXRlIHRoZSBkZWZlcnJlZCB0aGF0IHdpbGwgYmUgc3VwcGxpZWQgdG8gbG9hZFBhZ2UgY2FsbGVycwoJCS8vIGFuZCByZXNvbHZlZCBieSB0aGUgY29udGVudCB3aWRnZXQncyBsb2FkIG1ldGhvZAoJCW9wdHMuZGVmZXJyZWQgPSAkLkRlZmVycmVkKCk7CgoJCS8vIFByZWZlcnJpbmcgdG8gYWxsb3cgZXhjZXB0aW9ucyBmb3IgdW5pbml0aWFsaXplZCBvcHRzLnBhZ2VDb250YWluZXIKCQkvLyB3aWRnZXRzIHNvIHdlIGtub3cgaWYgd2UgbmVlZCB0byBmb3JjZSBpbml0IGhlcmUgZm9yIHVzZXJzCgkJY29udGFpbmVyLnBhZ2Vjb250YWluZXIoICJsb2FkIiwgdXJsLCBvcHRzICk7CgoJCS8vIHByb3ZpZGUgdGhlIGRlZmVycmVkCgkJcmV0dXJuIG9wdHMuZGVmZXJyZWQucHJvbWlzZSgpOwoJfTsKCgkvL2RlZmluZSB2YXJzIGZvciBpbnRlcmFsIHVzZQoKCS8qIGludGVybmFsIHV0aWxpdHkgZnVuY3Rpb25zICovCgoJLy8gTk9URSBJc3N1ZSAjNDk1MCBBbmRyb2lkIHBob25lZ2FwIGRvZXNuJ3QgbmF2aWdhdGUgYmFjayBwcm9wZXJseQoJLy8gICAgICB3aGVuIGEgZnVsbCBwYWdlIHJlZnJlc2ggaGFzIHRha2VuIHBsYWNlLiBJdCBhcHBlYXJzIHRoYXQgaGFzaGNoYW5nZQoJLy8gICAgICBhbmQgcmVwbGFjZXN0YXRlIGhpc3RvcnkgYWx0ZXJhdGlvbnMgd29yayBmaW5lIGJ1dCB3ZSBuZWVkIHRvIHN1cHBvcnQKCS8vICAgICAgYm90aCBmb3JtcyBvZiBoaXN0b3J5IHRyYXZlcnNhbCBpbiBvdXIgY29kZSB0aGF0IHVzZXMgYmFja3dhcmQgaGlzdG9yeQoJLy8gICAgICBtb3ZlbWVudAoJJC5tb2JpbGUuYmFjayA9IGZ1bmN0aW9uKCkgewoJCXZhciBuYXYgPSB3aW5kb3cubmF2aWdhdG9yOwoKCQkvLyBpZiB0aGUgc2V0dGluZyBpcyBvbiBhbmQgdGhlIG5hdmlnYXRvciBvYmplY3QgaXMKCQkvLyBhdmFpbGFibGUgdXNlIHRoZSBwaG9uZWdhcCBuYXZpZ2F0aW9uIGNhcGFiaWxpdHkKCQlpZiAoIHRoaXMucGhvbmVnYXBOYXZpZ2F0aW9uRW5hYmxlZCAmJgoJCQluYXYgJiYKCQkJbmF2LmFwcCAmJgoJCQluYXYuYXBwLmJhY2tIaXN0b3J5ICl7CgkJCW5hdi5hcHAuYmFja0hpc3RvcnkoKTsKCQl9IGVsc2UgewoJCQl3aW5kb3cuaGlzdG9yeS5iYWNrKCk7CgkJfQoJfTsKCgkvL2RpcmVjdCBmb2N1cyB0byB0aGUgcGFnZSB0aXRsZSwgb3Igb3RoZXJ3aXNlIGZpcnN0IGZvY3VzYWJsZSBlbGVtZW50CgkkLm1vYmlsZS5mb2N1c1BhZ2UgPSBmdW5jdGlvbiAoIHBhZ2UgKSB7CgkJdmFyIGF1dG9mb2N1cyA9IHBhZ2UuZmluZCggIlthdXRvZm9jdXNdIiApLAoJCQlwYWdlVGl0bGUgPSBwYWdlLmZpbmQoICIudWktdGl0bGU6ZXEoMCkiICk7CgoJCWlmICggYXV0b2ZvY3VzLmxlbmd0aCApIHsKCQkJYXV0b2ZvY3VzLmZvY3VzKCk7CgkJCXJldHVybjsKCQl9CgoJCWlmICggcGFnZVRpdGxlLmxlbmd0aCApIHsKCQkJcGFnZVRpdGxlLmZvY3VzKCk7CgkJfSBlbHNlewoJCQlwYWdlLmZvY3VzKCk7CgkJfQoJfTsKCgkvLyBOby1vcCBpbXBsZW1lbnRhdGlvbiBvZiB0cmFuc2l0aW9uIGRlZ3JhZGF0aW9uCgkkLm1vYmlsZS5fbWF5YmVEZWdyYWRlVHJhbnNpdGlvbiA9ICQubW9iaWxlLl9tYXliZURlZ3JhZGVUcmFuc2l0aW9uIHx8IGZ1bmN0aW9uKCB0cmFuc2l0aW9uICkgewoJCXJldHVybiB0cmFuc2l0aW9uOwoJfTsKCgkvKiBleHBvc2VkICQubW9iaWxlIG1ldGhvZHMgKi8KCgkvL2FuaW1hdGlvbiBjb21wbGV0ZSBjYWxsYmFjawoJJC5mbi5hbmltYXRpb25Db21wbGV0ZSA9IGZ1bmN0aW9uKCBjYWxsYmFjayApIHsKCQlpZiAoICQuc3VwcG9ydC5jc3NUcmFuc2l0aW9ucyApIHsKCQkJcmV0dXJuICQoIHRoaXMgKS5vbmUoICJ3ZWJraXRBbmltYXRpb25FbmQgYW5pbWF0aW9uZW5kIiwgY2FsbGJhY2sgKTsKCQl9CgkJZWxzZXsKCQkJLy8gZGVmZXIgZXhlY3V0aW9uIGZvciBjb25zaXN0ZW5jeSBiZXR3ZWVuIHdlYmtpdC9ub24gd2Via2l0CgkJCXNldFRpbWVvdXQoIGNhbGxiYWNrLCAwICk7CgkJCXJldHVybiAkKCB0aGlzICk7CgkJfQoJfTsKCgkkLm1vYmlsZS5jaGFuZ2VQYWdlID0gZnVuY3Rpb24oIHRvLCBvcHRpb25zICkgewoJCSQubW9iaWxlLnBhZ2VDb250YWluZXIucGFnZWNvbnRhaW5lciggImNoYW5nZSIsIHRvLCBvcHRpb25zICk7Cgl9OwoKCSQubW9iaWxlLmNoYW5nZVBhZ2UuZGVmYXVsdHMgPSB7CgkJdHJhbnNpdGlvbjogdW5kZWZpbmVkLAoJCXJldmVyc2U6IGZhbHNlLAoJCWNoYW5nZUhhc2g6IHRydWUsCgkJZnJvbUhhc2hDaGFuZ2U6IGZhbHNlLAoJCXJvbGU6IHVuZGVmaW5lZCwgLy8gQnkgZGVmYXVsdCB3ZSByZWx5IG9uIHRoZSByb2xlIGRlZmluZWQgYnkgdGhlIEBkYXRhLXJvbGUgYXR0cmlidXRlLgoJCWR1cGxpY2F0ZUNhY2hlZFBhZ2U6IHVuZGVmaW5lZCwKCQlwYWdlQ29udGFpbmVyOiB1bmRlZmluZWQsCgkJc2hvd0xvYWRNc2c6IHRydWUsIC8vbG9hZGluZyBtZXNzYWdlIHNob3dzIGJ5IGRlZmF1bHQgd2hlbiBwYWdlcyBhcmUgYmVpbmcgZmV0Y2hlZCBkdXJpbmcgY2hhbmdlUGFnZQoJCWRhdGFVcmw6IHVuZGVmaW5lZCwKCQlmcm9tUGFnZTogdW5kZWZpbmVkLAoJCWFsbG93U2FtZVBhZ2VUcmFuc2l0aW9uOiBmYWxzZQoJfTsKCgkkLm1vYmlsZS5fcmVnaXN0ZXJJbnRlcm5hbEV2ZW50cyA9IGZ1bmN0aW9uKCkgewoJCXZhciBnZXRBamF4Rm9ybURhdGEgPSBmdW5jdGlvbiggJGZvcm0sIGNhbGN1bGF0ZU9ubHkgKSB7CgkJCXZhciB1cmwsIHJldCA9IHRydWUsIGZvcm1EYXRhLCB2Y2xpY2tlZE5hbWUsIG1ldGhvZDsKCQkJaWYgKCAhJC5tb2JpbGUuYWpheEVuYWJsZWQgfHwKCQkJCQkvLyB0ZXN0IHRoYXQgdGhlIGZvcm0gaXMsIGl0c2VsZiwgYWpheCBmYWxzZQoJCQkJCSRmb3JtLmlzKCAiOmpxbURhdGEoYWpheD0nZmFsc2UnKSIgKSB8fAoJCQkJCS8vIHRlc3QgdGhhdCAkLm1vYmlsZS5pZ25vcmVDb250ZW50RW5hYmxlZCBpcyBzZXQgYW5kCgkJCQkJLy8gdGhlIGZvcm0gb3Igb25lIG9mIGl0J3MgcGFyZW50cyBpcyBhamF4PWZhbHNlCgkJCQkJISRmb3JtLmpxbUhpamFja2FibGUoKS5sZW5ndGggfHwKCQkJCQkkZm9ybS5hdHRyKCAidGFyZ2V0IiApICkgewoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgoJCQl1cmwgPSAoICRsYXN0VkNsaWNrZWQgJiYgJGxhc3RWQ2xpY2tlZC5hdHRyKCAiZm9ybWFjdGlvbiIgKSApIHx8CgkJCQkkZm9ybS5hdHRyKCAiYWN0aW9uIiApOwoJCQltZXRob2QgPSAoICRmb3JtLmF0dHIoICJtZXRob2QiICkgfHwgImdldCIgKS50b0xvd2VyQ2FzZSgpOwoKCQkJLy8gSWYgbm8gYWN0aW9uIGlzIHNwZWNpZmllZCwgYnJvd3NlcnMgZGVmYXVsdCB0byB1c2luZyB0aGUKCQkJLy8gVVJMIG9mIHRoZSBkb2N1bWVudCBjb250YWluaW5nIHRoZSBmb3JtLiBTaW5jZSB3ZSBkeW5hbWljYWxseQoJCQkvLyBwdWxsIGluIHBhZ2VzIGZyb20gZXh0ZXJuYWwgZG9jdW1lbnRzLCB0aGUgZm9ybSBzaG91bGQgc3VibWl0CgkJCS8vIHRvIHRoZSBVUkwgZm9yIHRoZSBzb3VyY2UgZG9jdW1lbnQgb2YgdGhlIHBhZ2UgY29udGFpbmluZwoJCQkvLyB0aGUgZm9ybS4KCQkJaWYgKCAhdXJsICkgewoJCQkJLy8gR2V0IHRoZSBAZGF0YS11cmwgZm9yIHRoZSBwYWdlIGNvbnRhaW5pbmcgdGhlIGZvcm0uCgkJCQl1cmwgPSAkLm1vYmlsZS5nZXRDbG9zZXN0QmFzZVVybCggJGZvcm0gKTsKCgkJCQkvLyBOT1RFOiBJZiB0aGUgbWV0aG9kIGlzICJnZXQiLCB3ZSBuZWVkIHRvIHN0cmlwIG9mZiB0aGUgcXVlcnkgc3RyaW5nCgkJCQkvLyBiZWNhdXNlIGl0IHdpbGwgZ2V0IHJlcGxhY2VkIHdpdGggdGhlIG5ldyBmb3JtIGRhdGEuIFNlZSBpc3N1ZSAjNTcxMC4KCQkJCWlmICggbWV0aG9kID09PSAiZ2V0IiApIHsKCQkJCQl1cmwgPSAkLm1vYmlsZS5wYXRoLnBhcnNlVXJsKCB1cmwgKS5ocmVmTm9TZWFyY2g7CgkJCQl9CgoJCQkJaWYgKCB1cmwgPT09ICQubW9iaWxlLnBhdGguZG9jdW1lbnRCYXNlLmhyZWZOb0hhc2ggKSB7CgkJCQkJLy8gVGhlIHVybCB3ZSBnb3QgYmFjayBtYXRjaGVzIHRoZSBkb2N1bWVudCBiYXNlLAoJCQkJCS8vIHdoaWNoIG1lYW5zIHRoZSBwYWdlIG11c3QgYmUgYW4gaW50ZXJuYWwvZW1iZWRkZWQgcGFnZSwKCQkJCQkvLyBzbyBkZWZhdWx0IHRvIHVzaW5nIHRoZSBhY3R1YWwgZG9jdW1lbnQgdXJsIGFzIGEgYnJvd3NlcgoJCQkJCS8vIHdvdWxkLgoJCQkJCXVybCA9IGRvY3VtZW50VXJsLmhyZWZOb1NlYXJjaDsKCQkJCX0KCQkJfQoKCQkJdXJsID0gJC5tb2JpbGUucGF0aC5tYWtlVXJsQWJzb2x1dGUoICB1cmwsICQubW9iaWxlLmdldENsb3Nlc3RCYXNlVXJsKCAkZm9ybSApICk7CgoJCQlpZiAoICggJC5tb2JpbGUucGF0aC5pc0V4dGVybmFsKCB1cmwgKSAmJiAhJC5tb2JpbGUucGF0aC5pc1Blcm1pdHRlZENyb3NzRG9tYWluUmVxdWVzdCggZG9jdW1lbnRVcmwsIHVybCApICkgKSB7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCgkJCWlmICggIWNhbGN1bGF0ZU9ubHkgKSB7CgkJCQlmb3JtRGF0YSA9ICRmb3JtLnNlcmlhbGl6ZUFycmF5KCk7CgoJCQkJaWYgKCAkbGFzdFZDbGlja2VkICYmICRsYXN0VkNsaWNrZWRbIDAgXS5mb3JtID09PSAkZm9ybVsgMCBdICkgewoJCQkJCXZjbGlja2VkTmFtZSA9ICRsYXN0VkNsaWNrZWQuYXR0ciggIm5hbWUiICk7CgkJCQkJaWYgKCB2Y2xpY2tlZE5hbWUgKSB7CgkJCQkJCS8vIE1ha2Ugc3VyZSB0aGUgbGFzdCBjbGlja2VkIGVsZW1lbnQgaXMgaW5jbHVkZWQgaW4gdGhlIGZvcm0KCQkJCQkJJC5lYWNoKCBmb3JtRGF0YSwgZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CgkJCQkJCQlpZiAoIHZhbHVlLm5hbWUgPT09IHZjbGlja2VkTmFtZSApIHsKCQkJCQkJCQkvLyBVbnNldCB2Y2xpY2tlZE5hbWUgLSB3ZSd2ZSBmb3VuZCBpdCBpbiB0aGUgc2VyaWFsaXplZCBkYXRhIGFscmVhZHkKCQkJCQkJCQl2Y2xpY2tlZE5hbWUgPSAiIjsKCQkJCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQkJCQl9CgkJCQkJCX0pOwoJCQkJCQlpZiAoIHZjbGlja2VkTmFtZSApIHsKCQkJCQkJCWZvcm1EYXRhLnB1c2goIHsgbmFtZTogdmNsaWNrZWROYW1lLCB2YWx1ZTogJGxhc3RWQ2xpY2tlZC5hdHRyKCAidmFsdWUiICkgfSApOwoJCQkJCQl9CgkJCQkJfQoJCQkJfQoKCQkJCXJldCA9IHsKCQkJCQl1cmw6IHVybCwKCQkJCQlvcHRpb25zOiB7CgkJCQkJCXR5cGU6CQltZXRob2QsCgkJCQkJCWRhdGE6CQkkLnBhcmFtKCBmb3JtRGF0YSApLAoJCQkJCQl0cmFuc2l0aW9uOgkkZm9ybS5qcW1EYXRhKCAidHJhbnNpdGlvbiIgKSwKCQkJCQkJcmV2ZXJzZToJJGZvcm0uanFtRGF0YSggImRpcmVjdGlvbiIgKSA9PT0gInJldmVyc2UiLAoJCQkJCQlyZWxvYWRQYWdlOgl0cnVlCgkJCQkJfQoJCQkJfTsKCQkJfQoKCQkJcmV0dXJuIHJldDsKCQl9OwoKCQkvL2JpbmQgdG8gZm9ybSBzdWJtaXQgZXZlbnRzLCBoYW5kbGUgd2l0aCBBamF4CgkJJC5tb2JpbGUuZG9jdW1lbnQuZGVsZWdhdGUoICJmb3JtIiwgInN1Ym1pdCIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdmFyIGZvcm1EYXRhOwoKCQkJaWYgKCAhZXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKSB7CgkJCQlmb3JtRGF0YSA9IGdldEFqYXhGb3JtRGF0YSggJCggdGhpcyApICk7CgkJCQlpZiAoIGZvcm1EYXRhICkgewoJCQkJCSQubW9iaWxlLmNoYW5nZVBhZ2UoIGZvcm1EYXRhLnVybCwgZm9ybURhdGEub3B0aW9ucyApOwoJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQl9CgkJCX0KCQl9KTsKCgkJLy9hZGQgYWN0aXZlIHN0YXRlIG9uIHZjbGljawoJCSQubW9iaWxlLmRvY3VtZW50LmJpbmQoICJ2Y2xpY2siLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciAkYnRuLCBidG5FbHMsIHRhcmdldCA9IGV2ZW50LnRhcmdldCwgbmVlZENsb3Nlc3QgPSBmYWxzZTsKCQkJLy8gaWYgdGhpcyBpc24ndCBhIGxlZnQgY2xpY2sgd2UgZG9uJ3QgY2FyZS4gSXRzIGltcG9ydGFudCB0byBub3RlCgkJCS8vIHRoYXQgd2hlbiB0aGUgdmlydHVhbCBldmVudCBpcyBnZW5lcmF0ZWQgaXQgd2lsbCBjcmVhdGUgdGhlIHdoaWNoIGF0dHIKCQkJaWYgKCBldmVudC53aGljaCA+IDEgfHwgISQubW9iaWxlLmxpbmtCaW5kaW5nRW5hYmxlZCApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gUmVjb3JkIHRoYXQgdGhpcyBlbGVtZW50IHdhcyBjbGlja2VkLCBpbiBjYXNlIHdlIG5lZWQgaXQgZm9yIGNvcnJlY3QKCQkJLy8gZm9ybSBzdWJtaXNzaW9uIGR1cmluZyB0aGUgInN1Ym1pdCIgaGFuZGxlciBhYm92ZQoJCQkkbGFzdFZDbGlja2VkID0gJCggdGFyZ2V0ICk7CgoJCQkvLyBUcnkgdG8gZmluZCBhIHRhcmdldCBlbGVtZW50IHRvIHdoaWNoIHRoZSBhY3RpdmUgY2xhc3Mgd2lsbCBiZSBhcHBsaWVkCgkJCWlmICggJC5kYXRhKCB0YXJnZXQsICJtb2JpbGUtYnV0dG9uIiApICkgewoJCQkJLy8gSWYgdGhlIGZvcm0gd2lsbCBub3QgYmUgc3VibWl0dGVkIHZpYSBBSkFYLCBkbyBub3QgYWRkIGFjdGl2ZSBjbGFzcwoJCQkJaWYgKCAhZ2V0QWpheEZvcm1EYXRhKCAkKCB0YXJnZXQgKS5jbG9zZXN0KCAiZm9ybSIgKSwgdHJ1ZSApICkgewoJCQkJCXJldHVybjsKCQkJCX0KCQkJCS8vIFdlIHdpbGwgYXBwbHkgdGhlIGFjdGl2ZSBzdGF0ZSB0byB0aGlzIGJ1dHRvbiB3aWRnZXQgLSB0aGUgcGFyZW50CgkJCQkvLyBvZiB0aGUgaW5wdXQgdGhhdCB3YXMgY2xpY2tlZCB3aWxsIGhhdmUgdGhlIGFzc29jaWF0ZWQgZGF0YQoJCQkJaWYgKCB0YXJnZXQucGFyZW50Tm9kZSApIHsKCQkJCQl0YXJnZXQgPSB0YXJnZXQucGFyZW50Tm9kZTsKCQkJCX0KCQkJfSBlbHNlIHsKCQkJCXRhcmdldCA9IGZpbmRDbG9zZXN0TGluayggdGFyZ2V0ICk7CgkJCQlpZiAoICEoIHRhcmdldCAmJiAkLm1vYmlsZS5wYXRoLnBhcnNlVXJsKCB0YXJnZXQuZ2V0QXR0cmlidXRlKCAiaHJlZiIgKSB8fCAiIyIgKS5oYXNoICE9PSAiIyIgKSApIHsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJLy8gVE9ETyB0ZWFjaCAkLm1vYmlsZS5oaWphY2thYmxlIHRvIG9wZXJhdGUgb24gcmF3IGRvbSBlbGVtZW50cyBzbyB0aGUKCQkJCS8vIGxpbmsgd3JhcHBpbmcgY2FuIGJlIGF2b2lkZWQKCQkJCWlmICggISQoIHRhcmdldCApLmpxbUhpamFja2FibGUoKS5sZW5ndGggKSB7CgkJCQkJcmV0dXJuOwoJCQkJfQoJCQl9CgoJCQkvLyBBdm9pZCBjYWxsaW5nIC5jbG9zZXN0IGJ5IHVzaW5nIHRoZSBkYXRhIHNldCBkdXJpbmcgLmJ1dHRvbk1hcmt1cCgpCgkJCS8vIExpc3QgaXRlbXMgaGF2ZSB0aGUgYnV0dG9uIGRhdGEgaW4gdGhlIHBhcmVudCBvZiB0aGUgZWxlbWVudCBjbGlja2VkCgkJCWlmICggISF+dGFyZ2V0LmNsYXNzTmFtZS5pbmRleE9mKCAidWktbGluay1pbmhlcml0IiApICkgewoJCQkJaWYgKCB0YXJnZXQucGFyZW50Tm9kZSApIHsKCQkJCQlidG5FbHMgPSAkLmRhdGEoIHRhcmdldC5wYXJlbnROb2RlLCAiYnV0dG9uRWxlbWVudHMiICk7CgkJCQl9CgkJCS8vIE90aGVyd2lzZSwgbG9vayBmb3IgdGhlIGRhdGEgb24gdGhlIHRhcmdldCBpdHNlbGYKCQkJfSBlbHNlIHsKCQkJCWJ0bkVscyA9ICQuZGF0YSggdGFyZ2V0LCAiYnV0dG9uRWxlbWVudHMiICk7CgkJCX0KCQkJLy8gSWYgZm91bmQsIGdyYWIgdGhlIGJ1dHRvbidzIG91dGVyIGVsZW1lbnQKCQkJaWYgKCBidG5FbHMgKSB7CgkJCQl0YXJnZXQgPSBidG5FbHMub3V0ZXI7CgkJCX0gZWxzZSB7CgkJCQluZWVkQ2xvc2VzdCA9IHRydWU7CgkJCX0KCgkJCSRidG4gPSAkKCB0YXJnZXQgKTsKCQkJLy8gSWYgdGhlIG91dGVyIGVsZW1lbnQgd2Fzbid0IGZvdW5kIGJ5IHRoZSBvdXIgaGV1cmlzdGljcywgdXNlIC5jbG9zZXN0KCkKCQkJaWYgKCBuZWVkQ2xvc2VzdCApIHsKCQkJCSRidG4gPSAkYnRuLmNsb3Nlc3QoICIudWktYnRuIiApOwoJCQl9CgoJCQlpZiAoICRidG4ubGVuZ3RoID4gMCAmJgoJCQkJISggJGJ0bi5oYXNDbGFzcyggInVpLXN0YXRlLWRpc2FibGVkIiB8fAoKCQkJCQkvLyBERVBSRUNBVEVEIGFzIG9mIDEuNC4wIC0gcmVtb3ZlIGFmdGVyIDEuNC4wIHJlbGVhc2UKCQkJCQkvLyBvbmx5IHVpLXN0YXRlLWRpc2FibGVkIHNob3VsZCBiZSBwcmVzZW50IHRoZXJlYWZ0ZXIKCQkJCQkkYnRuLmhhc0NsYXNzKCAidWktZGlzYWJsZWQiICkgKSApICkgewoJCQkJJC5tb2JpbGUucmVtb3ZlQWN0aXZlTGlua0NsYXNzKCB0cnVlICk7CgkJCQkkLm1vYmlsZS5hY3RpdmVDbGlja2VkTGluayA9ICRidG47CgkJCQkkLm1vYmlsZS5hY3RpdmVDbGlja2VkTGluay5hZGRDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJfQoJCX0pOwoKCQkvLyBjbGljayByb3V0aW5nIC0gZGlyZWN0IHRvIEhUVFAgb3IgQWpheCwgYWNjb3JkaW5nbHkKCQkkLm1vYmlsZS5kb2N1bWVudC5iaW5kKCAiY2xpY2siLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCWlmICggISQubW9iaWxlLmxpbmtCaW5kaW5nRW5hYmxlZCB8fCBldmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJdmFyIGxpbmsgPSBmaW5kQ2xvc2VzdExpbmsoIGV2ZW50LnRhcmdldCApLAoJCQkJJGxpbmsgPSAkKCBsaW5rICksCgkJCQlodHRwQ2xlYW51cCwKCQkJCWJhc2VVcmwsIGhyZWYsCgkJCQl1c2VEZWZhdWx0VXJsSGFuZGxpbmcsIGlzRXh0ZXJuYWwsCgkJCQl0cmFuc2l0aW9uLCByZXZlcnNlLCByb2xlOwoKCQkJLy8gSWYgdGhlcmUgaXMgbm8gbGluayBhc3NvY2lhdGVkIHdpdGggdGhlIGNsaWNrIG9yIGl0cyBub3QgYSBsZWZ0CgkJCS8vIGNsaWNrIHdlIHdhbnQgdG8gaWdub3JlIHRoZSBjbGljawoJCQkvLyBUT0RPIHRlYWNoICQubW9iaWxlLmhpamFja2FibGUgdG8gb3BlcmF0ZSBvbiByYXcgZG9tIGVsZW1lbnRzIHNvIHRoZSBsaW5rIHdyYXBwaW5nCgkJCS8vIGNhbiBiZSBhdm9pZGVkCgkJCWlmICggIWxpbmsgfHwgZXZlbnQud2hpY2ggPiAxIHx8ICEkbGluay5qcW1IaWphY2thYmxlKCkubGVuZ3RoICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvL3JlbW92ZSBhY3RpdmUgbGluayBjbGFzcyBpZiBleHRlcm5hbCAodGhlbiBpdCB3b24ndCBiZSB0aGVyZSBpZiB5b3UgY29tZSBiYWNrKQoJCQlodHRwQ2xlYW51cCA9IGZ1bmN0aW9uKCkgewoJCQkJd2luZG93LnNldFRpbWVvdXQoZnVuY3Rpb24oKSB7ICQubW9iaWxlLnJlbW92ZUFjdGl2ZUxpbmtDbGFzcyggdHJ1ZSApOyB9LCAyMDAgKTsKCQkJfTsKCgkJCS8vaWYgdGhlcmUncyBhIGRhdGEtcmVsPWJhY2sgYXR0ciwgZ28gYmFjayBpbiBoaXN0b3J5CgkJCWlmICggJGxpbmsuaXMoICI6anFtRGF0YShyZWw9J2JhY2snKSIgKSApIHsKCQkJCSQubW9iaWxlLmJhY2soKTsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoKCQkJYmFzZVVybCA9ICQubW9iaWxlLmdldENsb3Nlc3RCYXNlVXJsKCAkbGluayApOwoKCQkJLy9nZXQgaHJlZiwgaWYgZGVmaW5lZCwgb3RoZXJ3aXNlIGRlZmF1bHQgdG8gZW1wdHkgaGFzaAoJCQlocmVmID0gJC5tb2JpbGUucGF0aC5tYWtlVXJsQWJzb2x1dGUoICRsaW5rLmF0dHIoICJocmVmIiApIHx8ICIjIiwgYmFzZVVybCApOwoKCQkJLy9pZiBhamF4IGlzIGRpc2FibGVkLCBleGl0IGVhcmx5CgkJCWlmICggISQubW9iaWxlLmFqYXhFbmFibGVkICYmICEkLm1vYmlsZS5wYXRoLmlzRW1iZWRkZWRQYWdlKCBocmVmICkgKSB7CgkJCQlodHRwQ2xlYW51cCgpOwoJCQkJLy91c2UgZGVmYXVsdCBjbGljayBoYW5kbGluZwoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBYWFhfamJsYXM6IElkZWFsbHkgbGlua3MgdG8gYXBwbGljYXRpb24gcGFnZXMgc2hvdWxkIGJlIHNwZWNpZmllZCBhcwoJCQkvLyAgICAgICAgICAgIGFuIHVybCB0byB0aGUgYXBwbGljYXRpb24gZG9jdW1lbnQgd2l0aCBhIGhhc2ggdGhhdCBpcyBlaXRoZXIKCQkJLy8gICAgICAgICAgICB0aGUgc2l0ZSByZWxhdGl2ZSBwYXRoIG9yIGlkIHRvIHRoZSBwYWdlLiBCdXQgc29tZSBvZiB0aGUKCQkJLy8gICAgICAgICAgICBpbnRlcm5hbCBjb2RlIHRoYXQgZHluYW1pY2FsbHkgZ2VuZXJhdGVzIHN1Yi1wYWdlcyBmb3IgbmVzdGVkCgkJCS8vICAgICAgICAgICAgbGlzdHMgYW5kIHNlbGVjdCBkaWFsb2dzLCBqdXN0IHdyaXRlIGEgaGFzaCBpbiB0aGUgbGluayB0aGV5CgkJCS8vICAgICAgICAgICAgY3JlYXRlLiBUaGlzIG1lYW5zIHRoZSBhY3R1YWwgVVJMIHBhdGggaXMgYmFzZWQgb24gd2hhdGV2ZXIKCQkJLy8gICAgICAgICAgICB0aGUgY3VycmVudCB2YWx1ZSBvZiB0aGUgYmFzZSB0YWcgaXMgYXQgdGhlIHRpbWUgdGhpcyBjb2RlCgkJCS8vICAgICAgICAgICAgaXMgY2FsbGVkLiBGb3Igbm93IHdlIGFyZSBqdXN0IGFzc3VtaW5nIHRoYXQgYW55IHVybCB3aXRoIGEKCQkJLy8gICAgICAgICAgICBoYXNoIGluIGl0IGlzIGFuIGFwcGxpY2F0aW9uIHBhZ2UgcmVmZXJlbmNlLgoJCQlpZiAoIGhyZWYuc2VhcmNoKCAiIyIgKSAhPT0gLTEgKSB7CgkJCQlocmVmID0gaHJlZi5yZXBsYWNlKCAvW14jXSojLywgIiIgKTsKCQkJCWlmICggIWhyZWYgKSB7CgkJCQkJLy9saW5rIHdhcyBhbiBlbXB0eSBoYXNoIG1lYW50IHB1cmVseQoJCQkJCS8vZm9yIGludGVyYWN0aW9uLCBzbyB3ZSBpZ25vcmUgaXQuCgkJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCQlyZXR1cm47CgkJCQl9IGVsc2UgaWYgKCAkLm1vYmlsZS5wYXRoLmlzUGF0aCggaHJlZiApICkgewoJCQkJCS8vd2UgaGF2ZSBhcGF0aCBzbyBtYWtlIGl0IHRoZSBocmVmIHdlIHdhbnQgdG8gbG9hZC4KCQkJCQlocmVmID0gJC5tb2JpbGUucGF0aC5tYWtlVXJsQWJzb2x1dGUoIGhyZWYsIGJhc2VVcmwgKTsKCQkJCX0gZWxzZSB7CgkJCQkJLy93ZSBoYXZlIGEgc2ltcGxlIGlkIHNvIHVzZSB0aGUgZG9jdW1lbnRVcmwgYXMgaXRzIGJhc2UuCgkJCQkJaHJlZiA9ICQubW9iaWxlLnBhdGgubWFrZVVybEFic29sdXRlKCAiIyIgKyBocmVmLCBkb2N1bWVudFVybC5ocmVmTm9IYXNoICk7CgkJCQl9CgkJCX0KCgkJCS8vIFNob3VsZCB3ZSBoYW5kbGUgdGhpcyBsaW5rLCBvciBsZXQgdGhlIGJyb3dzZXIgZGVhbCB3aXRoIGl0PwoJCQl1c2VEZWZhdWx0VXJsSGFuZGxpbmcgPSAkbGluay5pcyggIltyZWw9J2V4dGVybmFsJ10iICkgfHwgJGxpbmsuaXMoICI6anFtRGF0YShhamF4PSdmYWxzZScpIiApIHx8ICRsaW5rLmlzKCAiW3RhcmdldF0iICk7CgoJCQkvLyBTb21lIGVtYmVkZGVkIGJyb3dzZXJzLCBsaWtlIHRoZSB3ZWIgdmlldyBpbiBQaG9uZSBHYXAsIGFsbG93IGNyb3NzLWRvbWFpbiBYSFIKCQkJLy8gcmVxdWVzdHMgaWYgdGhlIGRvY3VtZW50IGRvaW5nIHRoZSByZXF1ZXN0IHdhcyBsb2FkZWQgdmlhIHRoZSBmaWxlOi8vIHByb3RvY29sLgoJCQkvLyBUaGlzIGlzIHVzdWFsbHkgdG8gYWxsb3cgdGhlIGFwcGxpY2F0aW9uIHRvICJwaG9uZSBob21lIiBhbmQgZmV0Y2ggYXBwIHNwZWNpZmljCgkJCS8vIGRhdGEuIFdlIG5vcm1hbGx5IGxldCB0aGUgYnJvd3NlciBoYW5kbGUgZXh0ZXJuYWwvY3Jvc3MtZG9tYWluIHVybHMsIGJ1dCBpZiB0aGUKCQkJLy8gYWxsb3dDcm9zc0RvbWFpblBhZ2VzIG9wdGlvbiBpcyB0cnVlLCB3ZSB3aWxsIGFsbG93IGNyb3NzLWRvbWFpbiBodHRwL2h0dHBzCgkJCS8vIHJlcXVlc3RzIHRvIGdvIHRocm91Z2ggb3VyIHBhZ2UgbG9hZGluZyBsb2dpYy4KCgkJCS8vY2hlY2sgZm9yIHByb3RvY29sIG9yIHJlbCBhbmQgaXRzIG5vdCBhbiBlbWJlZGRlZCBwYWdlCgkJCS8vVE9ETyBvdmVybGFwIGluIGxvZ2ljIGZyb20gaXNFeHRlcm5hbCwgcmVsPWV4dGVybmFsIGNoZWNrIHNob3VsZCBiZQoJCQkvLyAgICAgbW92ZWQgaW50byBtb3JlIGNvbXByZWhlbnNpdmUgaXNFeHRlcm5hbExpbmsKCQkJaXNFeHRlcm5hbCA9IHVzZURlZmF1bHRVcmxIYW5kbGluZyB8fCAoICQubW9iaWxlLnBhdGguaXNFeHRlcm5hbCggaHJlZiApICYmICEkLm1vYmlsZS5wYXRoLmlzUGVybWl0dGVkQ3Jvc3NEb21haW5SZXF1ZXN0KCBkb2N1bWVudFVybCwgaHJlZiApICk7CgoJCQlpZiAoIGlzRXh0ZXJuYWwgKSB7CgkJCQlodHRwQ2xlYW51cCgpOwoJCQkJLy91c2UgZGVmYXVsdCBjbGljayBoYW5kbGluZwoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvL3VzZSBhamF4CgkJCXRyYW5zaXRpb24gPSAkbGluay5qcW1EYXRhKCAidHJhbnNpdGlvbiIgKTsKCQkJcmV2ZXJzZSA9ICRsaW5rLmpxbURhdGEoICJkaXJlY3Rpb24iICkgPT09ICJyZXZlcnNlIiB8fAoJCQkJCQkvLyBkZXByZWNhdGVkIC0gcmVtb3ZlIGJ5IDEuMAoJCQkJCQkkbGluay5qcW1EYXRhKCAiYmFjayIgKTsKCgkJCS8vdGhpcyBtYXkgbmVlZCB0byBiZSBtb3JlIHNwZWNpZmljIGFzIHdlIHVzZSBkYXRhLXJlbCBtb3JlCgkJCXJvbGUgPSAkbGluay5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicmVsIiApIHx8IHVuZGVmaW5lZDsKCgkJCSQubW9iaWxlLmNoYW5nZVBhZ2UoIGhyZWYsIHsgdHJhbnNpdGlvbjogdHJhbnNpdGlvbiwgcmV2ZXJzZTogcmV2ZXJzZSwgcm9sZTogcm9sZSwgbGluazogJGxpbmsgfSApOwoJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCX0pOwoKCQkvL3ByZWZldGNoIHBhZ2VzIHdoZW4gYW5jaG9ycyB3aXRoIGRhdGEtcHJlZmV0Y2ggYXJlIGVuY291bnRlcmVkCgkJJC5tb2JpbGUuZG9jdW1lbnQuZGVsZWdhdGUoICIudWktcGFnZSIsICJwYWdlc2hvdy5wcmVmZXRjaCIsIGZ1bmN0aW9uKCkgewoJCQl2YXIgdXJscyA9IFtdOwoJCQkkKCB0aGlzICkuZmluZCggImE6anFtRGF0YShwcmVmZXRjaCkiICkuZWFjaChmdW5jdGlvbigpIHsKCQkJCXZhciAkbGluayA9ICQoIHRoaXMgKSwKCQkJCQl1cmwgPSAkbGluay5hdHRyKCAiaHJlZiIgKTsKCgkJCQlpZiAoIHVybCAmJiAkLmluQXJyYXkoIHVybCwgdXJscyApID09PSAtMSApIHsKCQkJCQl1cmxzLnB1c2goIHVybCApOwoKCQkJCQkkLm1vYmlsZS5sb2FkUGFnZSggdXJsLCB7IHJvbGU6ICRsaW5rLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyZWwiICkscHJlZmV0Y2g6IHRydWUgfSApOwoJCQkJfQoJCQl9KTsKCQl9KTsKCgkJLy8gVE9ETyBlbnN1cmUgdGhhdCB0aGUgbmF2aWdhdGUgYmluZGluZyBpbiB0aGUgY29udGVudCB3aWRnZXQgaGFwcGVucyBhdCB0aGUgcmlnaHQgdGltZQoJCSQubW9iaWxlLnBhZ2VDb250YWluZXIucGFnZWNvbnRhaW5lcigpOwoKCQkvL3NldCBwYWdlIG1pbi1oZWlnaHRzIHRvIGJlIGRldmljZSBzcGVjaWZpYwoJCSQubW9iaWxlLmRvY3VtZW50LmJpbmQoICJwYWdlc2hvdyIsICQubW9iaWxlLnJlc2V0QWN0aXZlUGFnZUhlaWdodCApOwoJCSQubW9iaWxlLndpbmRvdy5iaW5kKCAidGhyb3R0bGVkcmVzaXplIiwgJC5tb2JpbGUucmVzZXRBY3RpdmVQYWdlSGVpZ2h0ICk7CgoJfTsvL25hdnJlYWR5RGVmZXJyZWQgZG9uZSBjYWxsYmFjawoKCSQoIGZ1bmN0aW9uKCkgeyBkb21yZWFkeURlZmVycmVkLnJlc29sdmUoKTsgfSApOwoKCSQud2hlbiggZG9tcmVhZHlEZWZlcnJlZCwgJC5tb2JpbGUubmF2cmVhZHlEZWZlcnJlZCApLmRvbmUoIGZ1bmN0aW9uKCkgeyAkLm1vYmlsZS5fcmVnaXN0ZXJJbnRlcm5hbEV2ZW50cygpOyB9ICk7Cn0pKCBqUXVlcnkgKTsKCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKCS8vIFRPRE8gcmVtb3ZlIGRpcmVjdCByZWZlcmVuY2VzIHRvICQubW9iaWxlIGFuZCBwcm9wZXJ0aWVzLCB3ZSBzaG91bGQKCS8vICAgICAgZmF2b3IgaW5qZWN0aW9uIHdpdGggcGFyYW1zIHRvIHRoZSBjb25zdHJ1Y3RvcgoJJC5tb2JpbGUuVHJhbnNpdGlvbiA9IGZ1bmN0aW9uKCkgewoJCXRoaXMuaW5pdC5hcHBseSggdGhpcywgYXJndW1lbnRzICk7Cgl9OwoKCSQuZXh0ZW5kKCQubW9iaWxlLlRyYW5zaXRpb24ucHJvdG90eXBlLCB7CgkJdG9QcmVDbGFzczogIiB1aS1wYWdlLXByZS1pbiIsCgoJCWluaXQ6IGZ1bmN0aW9uKCBuYW1lLCByZXZlcnNlLCAkdG8sICRmcm9tICkgewoJCQkkLmV4dGVuZCh0aGlzLCB7CgkJCQluYW1lOiBuYW1lLAoJCQkJcmV2ZXJzZTogcmV2ZXJzZSwKCQkJCSR0bzogJHRvLAoJCQkJJGZyb206ICRmcm9tLAoJCQkJZGVmZXJyZWQ6IG5ldyAkLkRlZmVycmVkKCkKCQkJfSk7CgkJfSwKCgkJY2xlYW5Gcm9tOiBmdW5jdGlvbigpIHsKCQkJdGhpcy4kZnJvbQoJCQkJLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVQYWdlQ2xhc3MgKyAiIG91dCBpbiByZXZlcnNlICIgKyB0aGlzLm5hbWUgKQoJCQkJLmhlaWdodCggIiIgKTsKCQl9LAoKCQkvLyBOT1RFIG92ZXJyaWRkZW4gYnkgY2hpbGQgb2JqZWN0IHByb3RvdHlwZXMsIG5vb3AnZCBoZXJlIGFzIGRlZmF1bHRzCgkJYmVmb3JlRG9uZUluOiBmdW5jdGlvbigpIHt9LAoJCWJlZm9yZURvbmVPdXQ6IGZ1bmN0aW9uKCkge30sCgkJYmVmb3JlU3RhcnRPdXQ6IGZ1bmN0aW9uKCkge30sCgoJCWRvbmVJbjogZnVuY3Rpb24oKSB7CgkJCXRoaXMuYmVmb3JlRG9uZUluKCk7CgoJCQl0aGlzLiR0by5yZW1vdmVDbGFzcyggIm91dCBpbiByZXZlcnNlICIgKyB0aGlzLm5hbWUgKS5oZWlnaHQoICIiICk7CgoJCQl0aGlzLnRvZ2dsZVZpZXdwb3J0Q2xhc3MoKTsKCgkJCS8vIEluIHNvbWUgYnJvd3NlcnMgKGlPUzUpLCAzRCB0cmFuc2l0aW9ucyBibG9jayB0aGUgYWJpbGl0eSB0byBzY3JvbGwgdG8gdGhlIGRlc2lyZWQgbG9jYXRpb24gZHVyaW5nIHRyYW5zaXRpb24KCQkJLy8gVGhpcyBlbnN1cmVzIHdlIGp1bXAgdG8gdGhhdCBzcG90IGFmdGVyIHRoZSBmYWN0LCBpZiB3ZSBhcmVuJ3QgdGhlcmUgYWxyZWFkeS4KCQkJaWYgKCAkLm1vYmlsZS53aW5kb3cuc2Nyb2xsVG9wKCkgIT09IHRoaXMudG9TY3JvbGwgKSB7CgkJCQl0aGlzLnNjcm9sbFBhZ2UoKTsKCQkJfQoJCQlpZiggIXRoaXMuc2VxdWVudGlhbCApewoJCQkJdGhpcy4kdG8uYWRkQ2xhc3MoICQubW9iaWxlLmFjdGl2ZVBhZ2VDbGFzcyApOwoJCQl9CgkJCXRoaXMuZGVmZXJyZWQucmVzb2x2ZSggdGhpcy5uYW1lLCB0aGlzLnJldmVyc2UsIHRoaXMuJHRvLCB0aGlzLiRmcm9tLCB0cnVlICk7CgkJfSwKCgkJZG9uZU91dDogZnVuY3Rpb24oIHNjcmVlbkhlaWdodCwgcmV2ZXJzZUNsYXNzLCBub25lLCBwcmV2ZW50Rm9jdXMgKSB7CgkJCXRoaXMuYmVmb3JlRG9uZU91dCgpOwoJCQl0aGlzLnN0YXJ0SW4oIHNjcmVlbkhlaWdodCwgcmV2ZXJzZUNsYXNzLCBub25lLCBwcmV2ZW50Rm9jdXMgKTsKCQl9LAoKCQloaWRlSW46IGZ1bmN0aW9uKCBjYWxsYmFjayApIHsKCQkJLy8gUHJldmVudCBmbGlja2VyaW5nIGluIHBob25lZ2FwIGNvbnRhaW5lcjogc2VlIGNvbW1lbnRzIGF0ICM0MDI0IHJlZ2FyZGluZyBpT1MKCQkJdGhpcy4kdG8uY3NzKCAiei1pbmRleCIsIC0xMCApOwoJCQljYWxsYmFjay5jYWxsKCB0aGlzICk7CgkJCXRoaXMuJHRvLmNzcyggInotaW5kZXgiLCAiIiApOwoJCX0sCgoJCXNjcm9sbFBhZ2U6IGZ1bmN0aW9uKCkgewoJCQkvLyBCeSB1c2luZyBzY3JvbGxUbyBpbnN0ZWFkIG9mIHNpbGVudFNjcm9sbCwgd2UgY2FuIGtlZXAgdGhpbmdzIGJldHRlciBpbiBvcmRlcgoJCQkvLyBKdXN0IHRvIGJlIHByZWNhdXRpb3MsIGRpc2FibGUgc2Nyb2xsc3RhcnQgbGlzdGVuaW5nIGxpa2Ugc2lsZW50U2Nyb2xsIHdvdWxkCgkJCSQuZXZlbnQuc3BlY2lhbC5zY3JvbGxzdGFydC5lbmFibGVkID0gZmFsc2U7CgkJCS8vaWYgd2UgYXJlIGhpZGluZyB0aGUgdXJsIGJhciBvciB0aGUgcGFnZSB3YXMgcHJldmlvdXNseSBzY3JvbGxlZCBzY3JvbGwgdG8gaGlkZSBvciByZXR1cm4gdG8gcG9zaXRpb24KCQkJaWYgKCAkLm1vYmlsZS5oaWRlVXJsQmFyIHx8IHRoaXMudG9TY3JvbGwgIT09ICQubW9iaWxlLmRlZmF1bHRIb21lU2Nyb2xsICkgewoJCQkJd2luZG93LnNjcm9sbFRvKCAwLCB0aGlzLnRvU2Nyb2xsICk7CgkJCX0KCgkJCS8vIHJlZW5hYmxlIHNjcm9sbHN0YXJ0IGxpc3RlbmluZyBsaWtlIHNpbGVudFNjcm9sbCB3b3VsZAoJCQlzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJCSQuZXZlbnQuc3BlY2lhbC5zY3JvbGxzdGFydC5lbmFibGVkID0gdHJ1ZTsKCQkJfSwgMTUwICk7CgkJfSwKCgkJc3RhcnRJbjogZnVuY3Rpb24oIHNjcmVlbkhlaWdodCwgcmV2ZXJzZUNsYXNzLCBub25lLCBwcmV2ZW50Rm9jdXMgKSB7CgkJCXRoaXMuaGlkZUluKGZ1bmN0aW9uKCkgewoJCQkJdGhpcy4kdG8uYWRkQ2xhc3MoICQubW9iaWxlLmFjdGl2ZVBhZ2VDbGFzcyArIHRoaXMudG9QcmVDbGFzcyApOwoKCQkJCS8vIFNlbmQgZm9jdXMgdG8gcGFnZSBhcyBpdCBpcyBub3cgZGlzcGxheTogYmxvY2sKCQkJCWlmKCAhcHJldmVudEZvY3VzICl7CgkJCQkJJC5tb2JpbGUuZm9jdXNQYWdlKCB0aGlzLiR0byApOwoJCQkJfQoKCQkJCS8vIFNldCB0byBwYWdlIGhlaWdodAoJCQkJdGhpcy4kdG8uaGVpZ2h0KCBzY3JlZW5IZWlnaHQgKyB0aGlzLnRvU2Nyb2xsICk7CgogICAgICAgICAgICAgICAgaWYgKCAhbm9uZSApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNjcm9sbFBhZ2UoKTsKICAgICAgICAgICAgICAgIH0KCQkJfSk7CgoJCQlpZiAoICFub25lICkgewoJCQkJdGhpcy4kdG8uYW5pbWF0aW9uQ29tcGxldGUoICQucHJveHkoZnVuY3Rpb24oKSB7CgkJCQkJdGhpcy5kb25lSW4oKTsKCQkJCX0sIHRoaXMgKSk7CgkJCX0KCgkJCXRoaXMuJHRvCgkJCQkucmVtb3ZlQ2xhc3MoIHRoaXMudG9QcmVDbGFzcyApCgkJCQkuYWRkQ2xhc3MoIHRoaXMubmFtZSArICIgaW4gIiArIHJldmVyc2VDbGFzcyApOwoKCQkJaWYgKCBub25lICkgewoJCQkJdGhpcy5kb25lSW4oKTsKCQkJfQoKCQl9LAoKCQlzdGFydE91dDogZnVuY3Rpb24oIHNjcmVlbkhlaWdodCwgcmV2ZXJzZUNsYXNzLCBub25lICkgewoJCQl0aGlzLmJlZm9yZVN0YXJ0T3V0KCBzY3JlZW5IZWlnaHQsIHJldmVyc2VDbGFzcywgbm9uZSApOwoKCQkJLy8gU2V0IHRoZSBmcm9tIHBhZ2UncyBoZWlnaHQgYW5kIHN0YXJ0IGl0IHRyYW5zaXRpb25pbmcgb3V0CgkJCS8vIE5vdGU6IHNldHRpbmcgYW4gZXhwbGljaXQgaGVpZ2h0IGhlbHBzIGVsaW1pbmF0ZSB0aWxpbmcgaW4gdGhlIHRyYW5zaXRpb25zCgkJCXRoaXMuJGZyb20KCQkJCS5oZWlnaHQoIHNjcmVlbkhlaWdodCArICQubW9iaWxlLndpbmRvdy5zY3JvbGxUb3AoKSApCgkJCQkuYWRkQ2xhc3MoIHRoaXMubmFtZSArICIgb3V0IiArIHJldmVyc2VDbGFzcyApOwoJCX0sCgoKCQl0b2dnbGVWaWV3cG9ydENsYXNzOiBmdW5jdGlvbigpIHsKCQkJJC5tb2JpbGUucGFnZUNvbnRhaW5lci50b2dnbGVDbGFzcyggInVpLW1vYmlsZS12aWV3cG9ydC10cmFuc2l0aW9uaW5nIHZpZXdwb3J0LSIgKyB0aGlzLm5hbWUgKTsKCQl9LAoKCQl0cmFuc2l0aW9uOiBmdW5jdGlvbigpIHsKCQkJLy8gTk9URSBtYW55IG9mIHRoZXNlIGNvdWxkIGJlIGNhbGN1bGF0ZWQvcmVjb3JkZWQgaW4gdGhlIGNvbnN0cnVjdG9yLCBpdCdzIG15CgkJCS8vICAgICAgb3BpbmlvbiB0aGF0IGJpbmRpbmcgdGhlbSBhcyBsYXRlIGFzIHBvc3NpYmxlIGhhcyB2YWx1ZSB3aXRoIHJlZ2FyZHMgdG8KCQkJLy8gICAgICBiZXR0ZXIgdHJhbnNpdGlvbnMgd2l0aCBmZXdlciBidWdzLiBJZSwgaXQncyBub3QgZ3VhcmFudGVlZCB0aGF0IHRoZQoJCQkvLyAgICAgIG9iamVjdCB3aWxsIGJlIGNyZWF0ZWQgYW5kIHRyYW5zaXRpb24gd2lsbCBiZSBydW4gaW1tZWRpYXRlbHkgYWZ0ZXIgYXMKCQkJLy8gICAgICBpdCBpcyB0b2RheS4gU28gd2Ugd2FpdCB1bnRpbCB0cmFuc2l0aW9uIGlzIGludm9rZWQgdG8gZ2F0aGVyIHRoZSBmb2xsb3dpbmcKCQkJdmFyIHJldmVyc2VDbGFzcyA9IHRoaXMucmV2ZXJzZSA/ICIgcmV2ZXJzZSIgOiAiIiwKCQkJCXNjcmVlbkhlaWdodCA9ICQubW9iaWxlLmdldFNjcmVlbkhlaWdodCgpLAoJCQkJbWF4VHJhbnNpdGlvbk92ZXJyaWRlID0gJC5tb2JpbGUubWF4VHJhbnNpdGlvbldpZHRoICE9PSBmYWxzZSAmJiAkLm1vYmlsZS53aW5kb3cud2lkdGgoKSA+ICQubW9iaWxlLm1heFRyYW5zaXRpb25XaWR0aCwKCQkJCW5vbmUgPSAhJC5zdXBwb3J0LmNzc1RyYW5zaXRpb25zIHx8ICEkLnN1cHBvcnQuY3NzQW5pbWF0aW9ucyB8fCBtYXhUcmFuc2l0aW9uT3ZlcnJpZGUgfHwgIXRoaXMubmFtZSB8fCB0aGlzLm5hbWUgPT09ICJub25lIiB8fCBNYXRoLm1heCggJC5tb2JpbGUud2luZG93LnNjcm9sbFRvcCgpLCB0aGlzLnRvU2Nyb2xsICkgPiAkLm1vYmlsZS5nZXRNYXhTY3JvbGxGb3JUcmFuc2l0aW9uKCk7CgoJCQl0aGlzLnRvU2Nyb2xsID0gJC5tb2JpbGUubmF2aWdhdGUuaGlzdG9yeS5nZXRBY3RpdmUoKS5sYXN0U2Nyb2xsIHx8ICQubW9iaWxlLmRlZmF1bHRIb21lU2Nyb2xsOwoJCQl0aGlzLnRvZ2dsZVZpZXdwb3J0Q2xhc3MoKTsKCgkJCWlmICggdGhpcy4kZnJvbSAmJiAhbm9uZSApIHsKCQkJCXRoaXMuc3RhcnRPdXQoIHNjcmVlbkhlaWdodCwgcmV2ZXJzZUNsYXNzLCBub25lICk7CgkJCX0gZWxzZSB7CgkJCQl0aGlzLmRvbmVPdXQoIHNjcmVlbkhlaWdodCwgcmV2ZXJzZUNsYXNzLCBub25lLCB0cnVlICk7CgkJCX0KCgkJCXJldHVybiB0aGlzLmRlZmVycmVkLnByb21pc2UoKTsKCQl9Cgl9KTsKfSkoIGpRdWVyeSwgdGhpcyApOwoKCihmdW5jdGlvbiggJCApIHsKCgkkLm1vYmlsZS5TZXJpYWxUcmFuc2l0aW9uID0gZnVuY3Rpb24oKSB7CgkJdGhpcy5pbml0LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7Cgl9OwoKCSQuZXh0ZW5kKCQubW9iaWxlLlNlcmlhbFRyYW5zaXRpb24ucHJvdG90eXBlLCAkLm1vYmlsZS5UcmFuc2l0aW9uLnByb3RvdHlwZSwgewoJCXNlcXVlbnRpYWw6IHRydWUsCgoJCWJlZm9yZURvbmVPdXQ6IGZ1bmN0aW9uKCkgewoJCQlpZiAoIHRoaXMuJGZyb20gKSB7CgkJCQl0aGlzLmNsZWFuRnJvbSgpOwoJCQl9CgkJfSwKCgkJYmVmb3JlU3RhcnRPdXQ6IGZ1bmN0aW9uKCBzY3JlZW5IZWlnaHQsIHJldmVyc2VDbGFzcywgbm9uZSApIHsKCQkJdGhpcy4kZnJvbS5hbmltYXRpb25Db21wbGV0ZSgkLnByb3h5KGZ1bmN0aW9uKCkgewoJCQkJdGhpcy5kb25lT3V0KCBzY3JlZW5IZWlnaHQsIHJldmVyc2VDbGFzcywgbm9uZSApOwoJCQl9LCB0aGlzICkpOwoJCX0KCX0pOwoKfSkoIGpRdWVyeSApOwoKCihmdW5jdGlvbiggJCApIHsKCgkkLm1vYmlsZS5Db25jdXJyZW50VHJhbnNpdGlvbiA9IGZ1bmN0aW9uKCkgewoJCXRoaXMuaW5pdC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoJfTsKCgkkLmV4dGVuZCgkLm1vYmlsZS5Db25jdXJyZW50VHJhbnNpdGlvbi5wcm90b3R5cGUsICQubW9iaWxlLlRyYW5zaXRpb24ucHJvdG90eXBlLCB7CgkJc2VxdWVudGlhbDogZmFsc2UsCgoJCWJlZm9yZURvbmVJbjogZnVuY3Rpb24oKSB7CgkJCWlmICggdGhpcy4kZnJvbSApIHsKCQkJCXRoaXMuY2xlYW5Gcm9tKCk7CgkJCX0KCQl9LAoKCQliZWZvcmVTdGFydE91dDogZnVuY3Rpb24oIHNjcmVlbkhlaWdodCwgcmV2ZXJzZUNsYXNzLCBub25lICkgewoJCQl0aGlzLmRvbmVPdXQoIHNjcmVlbkhlaWdodCwgcmV2ZXJzZUNsYXNzLCBub25lICk7CgkJfQoJfSk7Cgp9KSggalF1ZXJ5ICk7CgoKKGZ1bmN0aW9uKCAkICkgewoKCS8vIGdlbmVyYXRlIHRoZSBoYW5kbGVycyBmcm9tIHRoZSBhYm92ZQoJdmFyIGRlZmF1bHRHZXRNYXhTY3JvbGxGb3JUcmFuc2l0aW9uID0gZnVuY3Rpb24oKSB7CgkJcmV0dXJuICQubW9iaWxlLmdldFNjcmVlbkhlaWdodCgpICogMzsKCX07CgoJLy90cmFuc2l0aW9uIGhhbmRsZXIgZGljdGlvbmFyeSBmb3IgM3JkIHBhcnR5IHRyYW5zaXRpb25zCgkkLm1vYmlsZS50cmFuc2l0aW9uSGFuZGxlcnMgPSB7CgkJInNlcXVlbnRpYWwiOiAkLm1vYmlsZS5TZXJpYWxUcmFuc2l0aW9uLAoJCSJzaW11bHRhbmVvdXMiOiAkLm1vYmlsZS5Db25jdXJyZW50VHJhbnNpdGlvbgoJfTsKCgkvLyBNYWtlIG91ciB0cmFuc2l0aW9uIGhhbmRsZXIgdGhlIHB1YmxpYyBkZWZhdWx0LgoJJC5tb2JpbGUuZGVmYXVsdFRyYW5zaXRpb25IYW5kbGVyID0gJC5tb2JpbGUudHJhbnNpdGlvbkhhbmRsZXJzLnNlcXVlbnRpYWw7CgoJJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrcyA9IHt9OwoKCS8vIElmIHRyYW5zaXRpb24gaXMgZGVmaW5lZCwgY2hlY2sgaWYgY3NzIDNEIHRyYW5zZm9ybXMgYXJlIHN1cHBvcnRlZCwgYW5kIGlmIG5vdCwgaWYgYSBmYWxsYmFjayBpcyBzcGVjaWZpZWQKCSQubW9iaWxlLl9tYXliZURlZ3JhZGVUcmFuc2l0aW9uID0gZnVuY3Rpb24oIHRyYW5zaXRpb24gKSB7CgkJaWYgKCB0cmFuc2l0aW9uICYmICEkLnN1cHBvcnQuY3NzVHJhbnNmb3JtM2QgJiYgJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrc1sgdHJhbnNpdGlvbiBdICkgewoJCQl0cmFuc2l0aW9uID0gJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrc1sgdHJhbnNpdGlvbiBdOwoJCX0KCgkJcmV0dXJuIHRyYW5zaXRpb247Cgl9OwoKCS8vIFNldCB0aGUgZ2V0TWF4U2Nyb2xsRm9yVHJhbnNpdGlvbiB0byBkZWZhdWx0IGlmIG5vIGltcGxlbWVudGF0aW9uIHdhcyBzZXQgYnkgdXNlcgoJJC5tb2JpbGUuZ2V0TWF4U2Nyb2xsRm9yVHJhbnNpdGlvbiA9ICQubW9iaWxlLmdldE1heFNjcm9sbEZvclRyYW5zaXRpb24gfHwgZGVmYXVsdEdldE1heFNjcm9sbEZvclRyYW5zaXRpb247Cgp9KSggalF1ZXJ5ICk7CgovKgoqIGZhbGxiYWNrIHRyYW5zaXRpb24gZm9yIGZsaXAgaW4gbm9uLTNEIHN1cHBvcnRpbmcgYnJvd3NlcnMgKHdoaWNoIHRlbmQgdG8gaGFuZGxlIGNvbXBsZXggdHJhbnNpdGlvbnMgcG9vcmx5IGluIGdlbmVyYWwKKi8KCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS50cmFuc2l0aW9uRmFsbGJhY2tzLmZsaXAgPSAiZmFkZSI7Cgp9KSggalF1ZXJ5LCB0aGlzICk7Ci8qCiogZmFsbGJhY2sgdHJhbnNpdGlvbiBmb3IgZmxvdyBpbiBub24tM0Qgc3VwcG9ydGluZyBicm93c2VycyAod2hpY2ggdGVuZCB0byBoYW5kbGUgY29tcGxleCB0cmFuc2l0aW9ucyBwb29ybHkgaW4gZ2VuZXJhbAoqLwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLnRyYW5zaXRpb25GYWxsYmFja3MuZmxvdyA9ICJmYWRlIjsKCn0pKCBqUXVlcnksIHRoaXMgKTsKLyoKKiBmYWxsYmFjayB0cmFuc2l0aW9uIGZvciBwb3AgaW4gbm9uLTNEIHN1cHBvcnRpbmcgYnJvd3NlcnMgKHdoaWNoIHRlbmQgdG8gaGFuZGxlIGNvbXBsZXggdHJhbnNpdGlvbnMgcG9vcmx5IGluIGdlbmVyYWwKKi8KCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS50cmFuc2l0aW9uRmFsbGJhY2tzLnBvcCA9ICJmYWRlIjsKCn0pKCBqUXVlcnksIHRoaXMgKTsKLyoKKiBmYWxsYmFjayB0cmFuc2l0aW9uIGZvciBzbGlkZSBpbiBub24tM0Qgc3VwcG9ydGluZyBicm93c2VycyAod2hpY2ggdGVuZCB0byBoYW5kbGUgY29tcGxleCB0cmFuc2l0aW9ucyBwb29ybHkgaW4gZ2VuZXJhbAoqLwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCi8vIFVzZSB0aGUgc2ltdWx0YW5lb3VzIHRyYW5zaXRpb25zIGhhbmRsZXIgZm9yIHNsaWRlIHRyYW5zaXRpb25zCiQubW9iaWxlLnRyYW5zaXRpb25IYW5kbGVycy5zbGlkZSA9ICQubW9iaWxlLnRyYW5zaXRpb25IYW5kbGVycy5zaW11bHRhbmVvdXM7CgovLyBTZXQgdGhlIHNsaWRlIHRyYW5zaXRpb25zJ3MgZmFsbGJhY2sgdG8gImZhZGUiCiQubW9iaWxlLnRyYW5zaXRpb25GYWxsYmFja3Muc2xpZGUgPSAiZmFkZSI7Cgp9KSggalF1ZXJ5LCB0aGlzICk7Ci8qCiogZmFsbGJhY2sgdHJhbnNpdGlvbiBmb3Igc2xpZGVkb3duIGluIG5vbi0zRCBzdXBwb3J0aW5nIGJyb3dzZXJzICh3aGljaCB0ZW5kIHRvIGhhbmRsZSBjb21wbGV4IHRyYW5zaXRpb25zIHBvb3JseSBpbiBnZW5lcmFsCiovCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrcy5zbGlkZWRvd24gPSAiZmFkZSI7Cgp9KSggalF1ZXJ5LCB0aGlzICk7Ci8qCiogZmFsbGJhY2sgdHJhbnNpdGlvbiBmb3Igc2xpZGVmYWRlIGluIG5vbi0zRCBzdXBwb3J0aW5nIGJyb3dzZXJzICh3aGljaCB0ZW5kIHRvIGhhbmRsZSBjb21wbGV4IHRyYW5zaXRpb25zIHBvb3JseSBpbiBnZW5lcmFsCiovCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKLy8gU2V0IHRoZSBzbGlkZSB0cmFuc2l0aW9ucydzIGZhbGxiYWNrIHRvICJmYWRlIgokLm1vYmlsZS50cmFuc2l0aW9uRmFsbGJhY2tzLnNsaWRlZmFkZSA9ICJmYWRlIjsKCn0pKCBqUXVlcnksIHRoaXMgKTsKLyoKKiBmYWxsYmFjayB0cmFuc2l0aW9uIGZvciBzbGlkZXVwIGluIG5vbi0zRCBzdXBwb3J0aW5nIGJyb3dzZXJzICh3aGljaCB0ZW5kIHRvIGhhbmRsZSBjb21wbGV4IHRyYW5zaXRpb25zIHBvb3JseSBpbiBnZW5lcmFsCiovCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrcy5zbGlkZXVwID0gImZhZGUiOwoKfSkoIGpRdWVyeSwgdGhpcyApOwovKgoqIGZhbGxiYWNrIHRyYW5zaXRpb24gZm9yIHR1cm4gaW4gbm9uLTNEIHN1cHBvcnRpbmcgYnJvd3NlcnMgKHdoaWNoIHRlbmQgdG8gaGFuZGxlIGNvbXBsZXggdHJhbnNpdGlvbnMgcG9vcmx5IGluIGdlbmVyYWwKKi8KCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS50cmFuc2l0aW9uRmFsbGJhY2tzLnR1cm4gPSAiZmFkZSI7Cgp9KSggalF1ZXJ5LCB0aGlzICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLmRlZ3JhZGVJbnB1dHMgPSB7Cgljb2xvcjogZmFsc2UsCglkYXRlOiBmYWxzZSwKCWRhdGV0aW1lOiBmYWxzZSwKCSJkYXRldGltZS1sb2NhbCI6IGZhbHNlLAoJZW1haWw6IGZhbHNlLAoJbW9udGg6IGZhbHNlLAoJbnVtYmVyOiBmYWxzZSwKCXJhbmdlOiAibnVtYmVyIiwKCXNlYXJjaDogInRleHQiLAoJdGVsOiBmYWxzZSwKCXRpbWU6IGZhbHNlLAoJdXJsOiBmYWxzZSwKCXdlZWs6IGZhbHNlCn07Ci8vIEJhY2tjb21wYXQgcmVtb3ZlIGluIDEuNQokLm1vYmlsZS5wYWdlLnByb3RvdHlwZS5vcHRpb25zLmRlZ3JhZGVJbnB1dHMgPSAkLm1vYmlsZS5kZWdyYWRlSW5wdXRzOwoKLy8gQXV0byBzZWxmLWluaXQgd2lkZ2V0cwokLm1vYmlsZS5kZWdyYWRlSW5wdXRzV2l0aGluID0gZnVuY3Rpb24oIHRhcmdldCApIHsKCgl0YXJnZXQgPSAkKCB0YXJnZXQgKTsKCgkvLyBEZWdyYWRlIGlucHV0cyB0byBhdm9pZCBwb29ybHkgaW1wbGVtZW50ZWQgbmF0aXZlIGZ1bmN0aW9uYWxpdHkKCXRhcmdldC5maW5kKCAiaW5wdXQiICkubm90KCAkLm1vYmlsZS5wYWdlLnByb3RvdHlwZS5rZWVwTmF0aXZlU2VsZWN0b3IoKSApLmVhY2goZnVuY3Rpb24oKSB7CgkJdmFyIGVsZW1lbnQgPSAkKCB0aGlzICksCgkJCXR5cGUgPSB0aGlzLmdldEF0dHJpYnV0ZSggInR5cGUiICksCgkJCW9wdFR5cGUgPSAkLm1vYmlsZS5kZWdyYWRlSW5wdXRzWyB0eXBlIF0gfHwgInRleHQiLAoJCQlodG1sLCBoYXNUeXBlLCBmaW5kc3RyLCByZXBzdHI7CgoJCWlmICggJC5tb2JpbGUuZGVncmFkZUlucHV0c1sgdHlwZSBdICkgewoJCQlodG1sID0gJCggIjxkaXY+IiApLmh0bWwoIGVsZW1lbnQuY2xvbmUoKSApLmh0bWwoKTsKCQkJLy8gSW4gSUUgYnJvd3NlcnMsIHRoZSB0eXBlIHNvbWV0aW1lcyBkb2Vzbid0IGV4aXN0IGluIHRoZSBjbG9uZWQgbWFya3VwLCBzbyB3ZSByZXBsYWNlIHRoZSBjbG9zaW5nIHRhZyBpbnN0ZWFkCgkJCWhhc1R5cGUgPSBodG1sLmluZGV4T2YoICIgdHlwZT0iICkgPiAtMTsKCQkJZmluZHN0ciA9IGhhc1R5cGUgPyAvXHMrdHlwZT1bIiddP1x3K1snIl0/LyA6IC9cLz8+LzsKCQkJcmVwc3RyID0gIiB0eXBlPVwiIiArIG9wdFR5cGUgKyAiXCIgZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidHlwZT1cIiIgKyB0eXBlICsgIlwiIiArICggaGFzVHlwZSA/ICIiIDogIj4iICk7CgoJCQllbGVtZW50LnJlcGxhY2VXaXRoKCBodG1sLnJlcGxhY2UoIGZpbmRzdHIsIHJlcHN0ciApICk7CgkJfQoJfSk7Cgp9OwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLnBhZ2UiLCAkLm1vYmlsZS5wYWdlLCB7CglvcHRpb25zOiB7CgoJCS8vIEFjY2VwdHMgbGVmdCwgcmlnaHQgYW5kIG5vbmUKCQljbG9zZUJ0bjogImxlZnQiLAoJCWNsb3NlQnRuVGV4dDogIkNsb3NlIiwKCQlvdmVybGF5VGhlbWU6ICJhIiwKCQljb3JuZXJzOiB0cnVlLAoJCWRpYWxvZzogZmFsc2UKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5fc3VwZXIoKTsKCQlpZiggdGhpcy5vcHRpb25zLmRpYWxvZyApewoKCQkJJC5leHRlbmQoIHRoaXMsIHsKCQkJCV9pc0Nsb3NlYWJsZTogZmFsc2UsCgkJCQlfaW5uZXI6IHRoaXMuZWxlbWVudC5jaGlsZHJlbigpLAoJCQkJX2hlYWRlckNsb3NlQnV0dG9uOiBudWxsCgkJCX0pOwoKCQkJaWYoICF0aGlzLm9wdGlvbnMuZW5oYW5jZWQgKSB7CgkJCQl0aGlzLl9zZXRDbG9zZUJ0biggdGhpcy5vcHRpb25zLmNsb3NlQnRuICk7CgkJCX0KCQl9Cgl9LAoKCV9lbmhhbmNlOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9zdXBlcigpOwoKCQkvLyBDbGFzcyB0aGUgbWFya3VwIGZvciBkaWFsb2cgc3R5bGluZyBhbmQgd3JhcCBpbnRlcmlvcgoJCWlmKCB0aGlzLm9wdGlvbnMuZGlhbG9nICl7CgkJCXRoaXMuZWxlbWVudC5hZGRDbGFzcyggInVpLWRpYWxvZyIgKQoJCQkJLndyYXBJbm5lciggJCggIjxkaXYvPiIsIHsKCgkJCQkJLy8gQVJJQSByb2xlCgkJCQkJInJvbGUiIDogImRpYWxvZyIsCgkJCQkJImNsYXNzIiA6ICJ1aS1kaWFsb2ctY29udGFpbiB1aS1vdmVybGF5LXNoYWRvdyIgKwoJCQkJCQkoIHRoaXMub3B0aW9ucy5jb3JuZXJzID8gIiB1aS1jb3JuZXItYWxsIiA6ICIiICkKCQkJCX0pKTsKCQl9Cgl9LAoKCV9zZXRPcHRpb25zOiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQl2YXIgY2xvc2VCdXR0b25Mb2NhdGlvbiwgY2xvc2VCdXR0b25UZXh0LAoJCQljdXJyZW50T3B0cyA9IHRoaXMub3B0aW9uczsKCgkJaWYgKCBvcHRpb25zLmNvcm5lcnMgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhpcy5faW5uZXIudG9nZ2xlQ2xhc3MoICJ1aS1jb3JuZXItYWxsIiwgISFvcHRpb25zLmNvcm5lcnMgKTsKCQl9CgoJCWlmICggb3B0aW9ucy5vdmVybGF5VGhlbWUgIT09IHVuZGVmaW5lZCApIHsKCQkJaWYgKCAkLm1vYmlsZS5hY3RpdmVQYWdlWyAwIF0gPT09IHRoaXMuZWxlbWVudFsgMCBdICkgewoJCQkJY3VycmVudE9wdHMub3ZlcmxheVRoZW1lID0gb3B0aW9ucy5vdmVybGF5VGhlbWU7CgkJCQl0aGlzLl9oYW5kbGVQYWdlQmVmb3JlU2hvdygpOwoJCQl9CgkJfQoKCQlpZiAoIG9wdGlvbnMuY2xvc2VCdG5UZXh0ICE9PSB1bmRlZmluZWQgKSB7CgkJCWNsb3NlQnV0dG9uTG9jYXRpb24gPSBjdXJyZW50T3B0cy5jbG9zZUJ0bjsKCQkJY2xvc2VCdXR0b25UZXh0ID0gb3B0aW9ucy5jbG9zZUJ0blRleHQ7CgkJfQoKCQlpZiAoIG9wdGlvbnMuY2xvc2VCdG4gIT09IHVuZGVmaW5lZCApIHsKCQkJY2xvc2VCdXR0b25Mb2NhdGlvbiA9IG9wdGlvbnMuY2xvc2VCdG47CgkJfQoKCQlpZiAoIGNsb3NlQnV0dG9uTG9jYXRpb24gKSB7CgkJCXRoaXMuX3NldENsb3NlQnRuKCBjbG9zZUJ1dHRvbkxvY2F0aW9uLCBjbG9zZUJ1dHRvblRleHQgKTsKCQl9CgoJCXRoaXMuX3N1cGVyKCBvcHRpb25zICk7Cgl9LAoKCV9oYW5kbGVQYWdlQmVmb3JlU2hvdzogZnVuY3Rpb24gKCkgewoJCWlmICggdGhpcy5vcHRpb25zLm92ZXJsYXlUaGVtZSAmJiB0aGlzLm9wdGlvbnMuZGlhbG9nICkgewoJCQl0aGlzLnJlbW92ZUNvbnRhaW5lckJhY2tncm91bmQoKTsKCQkJdGhpcy5zZXRDb250YWluZXJCYWNrZ3JvdW5kKCB0aGlzLm9wdGlvbnMub3ZlcmxheVRoZW1lICk7CgkJfSBlbHNlIHsKCQkJdGhpcy5fc3VwZXIoKTsKCQl9Cgl9LAoKCV9zZXRDbG9zZUJ0bjogZnVuY3Rpb24oIGxvY2F0aW9uLCB0ZXh0ICkgewoJCXZhciBkc3QsCgkJCWJ0biA9IHRoaXMuX2hlYWRlckNsb3NlQnV0dG9uOwoKCQkvLyBTYW5pdGl6ZSB2YWx1ZQoJCWxvY2F0aW9uID0gImxlZnQiID09PSBsb2NhdGlvbiA/ICJsZWZ0IiA6ICJyaWdodCIgPT09IGxvY2F0aW9uID8gInJpZ2h0IiA6ICJub25lIjsKCgkJaWYgKCAibm9uZSIgPT09IGxvY2F0aW9uICkgewoJCQlpZiAoIGJ0biApIHsKCQkJCWJ0bi5yZW1vdmUoKTsKCQkJCWJ0biA9IG51bGw7CgkJCX0KCQl9IGVsc2UgaWYgKCBidG4gKSB7CgkJCWJ0bi5yZW1vdmVDbGFzcyggInVpLWJ0bi1sZWZ0IHVpLWJ0bi1yaWdodCIgKS5hZGRDbGFzcyggInVpLWJ0bi0iICsgbG9jYXRpb24gKTsKCQkJaWYgKCB0ZXh0ICkgewoJCQkJYnRuLnRleHQoIHRleHQgKTsKCQkJfQoJCX0gZWxzZSB7CgkJCWRzdCA9IHRoaXMuX2lubmVyLmZpbmQoICI6anFtRGF0YShyb2xlPSdoZWFkZXInKSIgKS5maXJzdCgpOwoJCQlidG4gPSAkKCAiPGE+PC9hPiIsIHsKCQkJCQkicm9sZSI6ICJidXR0b24iLAoJCQkJCSJocmVmIjogIiMiLAoJCQkJCSJjbGFzcyI6ICJ1aS1idG4gdWktY29ybmVyLWFsbCB1aS1pY29uLWRlbGV0ZSB1aS1idG4taWNvbi1ub3RleHQgdWktYnRuLSIgKyBsb2NhdGlvbgoJCQkJfSkKCQkJCS50ZXh0KCB0ZXh0IHx8IHRoaXMub3B0aW9ucy5jbG9zZUJ0blRleHQgfHwgIiIgKQoJCQkJLnByZXBlbmRUbyggZHN0ICk7CgkJCXRoaXMuX29uKCBidG4sIHsgY2xpY2s6ICJjbG9zZSIgfSApOwoJCX0KCgkJdGhpcy5faGVhZGVyQ2xvc2VCdXR0b24gPSBidG47Cgl9LAoKCS8vIENsb3NlIG1ldGhvZCBnb2VzIGJhY2sgaW4gaGlzdG9yeQoJY2xvc2U6IGZ1bmN0aW9uKCkgewoJCXZhciBpZHgsIGRzdCwgaGlzdCA9ICQubW9iaWxlLm5hdmlnYXRlLmhpc3Rvcnk7CgoJCQlpZiAoICQubW9iaWxlLmhhc2hMaXN0ZW5pbmdFbmFibGVkICYmIGhpc3QuYWN0aXZlSW5kZXggPiAwICkgewoJCQkJJC5tb2JpbGUuYmFjaygpOwoJCQl9IGVsc2UgewoJCQkJaWR4ID0gTWF0aC5tYXgoIDAsIGhpc3QuYWN0aXZlSW5kZXggLSAxICk7CgkJCQlkc3QgPSBoaXN0LnN0YWNrWyBpZHggXS5wYWdlVXJsIHx8IGhpc3Quc3RhY2tbIGlkeCBdLnVybDsKCQkJCWhpc3QucHJldmlvdXNJbmRleCA9IGhpc3QuYWN0aXZlSW5kZXg7CgkJCQloaXN0LmFjdGl2ZUluZGV4ID0gaWR4OwoJCQkJaWYgKCAhJC5tb2JpbGUucGF0aC5pc1BhdGgoIGRzdCApICkgewoJCQkJCWRzdCA9ICQubW9iaWxlLnBhdGgubWFrZVVybEFic29sdXRlKCAiIyIgKyBkc3QgKTsKCQkJCX0KCgkJCQkkLm1vYmlsZS5jaGFuZ2VQYWdlKCBkc3QsIHsgZGlyZWN0aW9uOiAiYmFjayIsIGNoYW5nZUhhc2g6IGZhbHNlLCBmcm9tSGFzaENoYW5nZTogdHJ1ZSB9ICk7CgkJCX0KCX0KfSk7Cgp9KSggalF1ZXJ5LCB0aGlzICk7CgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUuZGlhbG9nIiwgewoJb3B0aW9uczogewoKCQkvLyBBY2NlcHRzIGxlZnQsIHJpZ2h0IGFuZCBub25lCgkJY2xvc2VCdG46ICJsZWZ0IiwKCQljbG9zZUJ0blRleHQ6ICJDbG9zZSIsCgkJb3ZlcmxheVRoZW1lOiAiYSIsCgkJY29ybmVyczogdHJ1ZQoJfSwKCgkvLyBPdmVycmlkZSB0aGUgdGhlbWUgc2V0IGJ5IHRoZSBwYWdlIHBsdWdpbiBvbiBwYWdlc2hvdwoJX2hhbmRsZVBhZ2VCZWZvcmVTaG93OiBmdW5jdGlvbigpIHsKCQl0aGlzLl9pc0Nsb3NlYWJsZSA9IHRydWU7CgkJaWYgKCB0aGlzLm9wdGlvbnMub3ZlcmxheVRoZW1lICkgewoJCQl0aGlzLmVsZW1lbnQKCQkJCS5wYWdlKCAicmVtb3ZlQ29udGFpbmVyQmFja2dyb3VuZCIgKQoJCQkJLnBhZ2UoICJzZXRDb250YWluZXJCYWNrZ3JvdW5kIiwgdGhpcy5vcHRpb25zLm92ZXJsYXlUaGVtZSApOwoJCX0KCX0sCgoJX2hhbmRsZVBhZ2VCZWZvcmVIaWRlOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9pc0Nsb3NlYWJsZSA9IGZhbHNlOwoJfSwKCgkvLyBjbGljayBhbmQgc3VibWl0IGV2ZW50czoKCS8vIC0gY2xpY2tzIGFuZCBzdWJtaXRzIHNob3VsZCB1c2UgdGhlIGNsb3NpbmcgdHJhbnNpdGlvbiB0aGF0IHRoZSBkaWFsb2cKCS8vICAgb3BlbmVkIHdpdGggdW5sZXNzIGEgZGF0YS10cmFuc2l0aW9uIGlzIHNwZWNpZmllZCBvbiB0aGUgbGluay9mb3JtCgkvLyAtIGlmIHRoZSBjbGljayB3YXMgb24gdGhlIGNsb3NlIGJ1dHRvbiwgb3IgdGhlIGxpbmsgaGFzIGEgZGF0YS1yZWw9ImJhY2siCgkvLyAgIGl0J2xsIGdvIGJhY2sgaW4gaGlzdG9yeSBuYXR1cmFsbHkKCV9oYW5kbGVWQ2xpY2tTdWJtaXQ6IGZ1bmN0aW9uKCBldmVudCApIHsKCQl2YXIgYXR0cnMsCgkJCSR0YXJnZXQgPSAkKCBldmVudC50YXJnZXQgKS5jbG9zZXN0KCBldmVudC50eXBlID09PSAidmNsaWNrIiA/ICJhIiA6ICJmb3JtIiApOwoKCQlpZiAoICR0YXJnZXQubGVuZ3RoICYmICEkdGFyZ2V0LmpxbURhdGEoICJ0cmFuc2l0aW9uIiApICkgewoJCQlhdHRycyA9IHt9OwoJCQlhdHRyc1sgImRhdGEtIiArICQubW9iaWxlLm5zICsgInRyYW5zaXRpb24iIF0gPQoJCQkJKCAkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5LmdldEFjdGl2ZSgpIHx8IHt9IClbICJ0cmFuc2l0aW9uIiBdIHx8CgkJCQkkLm1vYmlsZS5kZWZhdWx0RGlhbG9nVHJhbnNpdGlvbjsKCQkJYXR0cnNbICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJkaXJlY3Rpb24iIF0gPSAicmV2ZXJzZSI7CgkJCSR0YXJnZXQuYXR0ciggYXR0cnMgKTsKCQl9Cgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXZhciBlbGVtID0gdGhpcy5lbGVtZW50LAoJCQlvcHRzID0gdGhpcy5vcHRpb25zOwoKCQkvLyBDbGFzcyB0aGUgbWFya3VwIGZvciBkaWFsb2cgc3R5bGluZyBhbmQgd3JhcCBpbnRlcmlvcgoJCWVsZW0uYWRkQ2xhc3MoICJ1aS1kaWFsb2ciICkKCQkJLndyYXBJbm5lciggJCggIjxkaXYvPiIsIHsKCgkJCQkvLyBBUklBIHJvbGUKCQkJCSJyb2xlIiA6ICJkaWFsb2ciLAoJCQkJImNsYXNzIiA6ICJ1aS1kaWFsb2ctY29udGFpbiB1aS1vdmVybGF5LXNoYWRvdyIgKwoJCQkJCSggISFvcHRzLmNvcm5lcnMgPyAiIHVpLWNvcm5lci1hbGwiIDogIiIgKQoJCQl9KSk7CgoJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCV9pc0Nsb3NlYWJsZTogZmFsc2UsCgkJCV9pbm5lcjogZWxlbS5jaGlsZHJlbigpLAoJCQlfaGVhZGVyQ2xvc2VCdXR0b246IG51bGwKCQl9KTsKCgkJdGhpcy5fb24oIGVsZW0sIHsKCQkJdmNsaWNrOiAiX2hhbmRsZVZDbGlja1N1Ym1pdCIsCgkJCXN1Ym1pdDogIl9oYW5kbGVWQ2xpY2tTdWJtaXQiLAoJCQlwYWdlYmVmb3Jlc2hvdzogIl9oYW5kbGVQYWdlQmVmb3JlU2hvdyIsCgkJCXBhZ2ViZWZvcmVoaWRlOiAiX2hhbmRsZVBhZ2VCZWZvcmVIaWRlIgoJCX0pOwoKCQl0aGlzLl9zZXRDbG9zZUJ0biggb3B0cy5jbG9zZUJ0biApOwoJfSwKCglfc2V0T3B0aW9uczogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJdmFyIGNsb3NlQnV0dG9uTG9jYXRpb24sIGNsb3NlQnV0dG9uVGV4dCwKCQkJY3VycmVudE9wdHMgPSB0aGlzLm9wdGlvbnM7CgoJCWlmICggb3B0aW9ucy5jb3JuZXJzICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMuX2lubmVyLnRvZ2dsZUNsYXNzKCAidWktY29ybmVyLWFsbCIsICEhb3B0aW9ucy5jb3JuZXJzICk7CgkJfQoKCQlpZiAoIG9wdGlvbnMub3ZlcmxheVRoZW1lICE9PSB1bmRlZmluZWQgKSB7CgkJCWlmICggJC5tb2JpbGUuYWN0aXZlUGFnZVsgMCBdID09PSB0aGlzLmVsZW1lbnRbIDAgXSApIHsKCQkJCWN1cnJlbnRPcHRzLm92ZXJsYXlUaGVtZSA9IG9wdGlvbnMub3ZlcmxheVRoZW1lOwoJCQkJdGhpcy5faGFuZGxlUGFnZUJlZm9yZVNob3coKTsKCQkJfQoJCX0KCgkJaWYgKCBvcHRpb25zLmNsb3NlQnRuVGV4dCAhPT0gdW5kZWZpbmVkICkgewoJCQljbG9zZUJ1dHRvbkxvY2F0aW9uID0gY3VycmVudE9wdHMuY2xvc2VCdG47CgkJCWNsb3NlQnV0dG9uVGV4dCA9IG9wdGlvbnMuY2xvc2VCdG5UZXh0OwoJCX0KCgkJaWYgKCBvcHRpb25zLmNsb3NlQnRuICE9PSB1bmRlZmluZWQgKSB7CgkJCWNsb3NlQnV0dG9uTG9jYXRpb24gPSBvcHRpb25zLmNsb3NlQnRuOwoJCX0KCgkJaWYgKCBjbG9zZUJ1dHRvbkxvY2F0aW9uICkgewoJCQl0aGlzLl9zZXRDbG9zZUJ0biggY2xvc2VCdXR0b25Mb2NhdGlvbiwgY2xvc2VCdXR0b25UZXh0ICk7CgkJfQoKCQl0aGlzLl9zdXBlciggb3B0aW9ucyApOwoJfSwKCglfc2V0Q2xvc2VCdG46IGZ1bmN0aW9uKCBsb2NhdGlvbiwgdGV4dCApIHsKCQl2YXIgZHN0LAoJCQlidG4gPSB0aGlzLl9oZWFkZXJDbG9zZUJ1dHRvbjsKCgkJLy8gU2FuaXRpemUgdmFsdWUKCQlsb2NhdGlvbiA9ICJsZWZ0IiA9PT0gbG9jYXRpb24gPyAibGVmdCIgOiAicmlnaHQiID09PSBsb2NhdGlvbiA/ICJyaWdodCIgOiAibm9uZSI7CgoJCWlmICggIm5vbmUiID09PSBsb2NhdGlvbiApIHsKCQkJaWYgKCBidG4gKSB7CgkJCQlidG4ucmVtb3ZlKCk7CgkJCQlidG4gPSBudWxsOwoJCQl9CgkJfSBlbHNlIGlmICggYnRuICkgewoJCQlidG4ucmVtb3ZlQ2xhc3MoICJ1aS1idG4tbGVmdCB1aS1idG4tcmlnaHQiICkuYWRkQ2xhc3MoICJ1aS1idG4tIiArIGxvY2F0aW9uICk7CgkJCWlmICggdGV4dCApIHsKCQkJCWJ0bi50ZXh0KCB0ZXh0ICk7CgkJCX0KCQl9IGVsc2UgewoJCQlkc3QgPSB0aGlzLl9pbm5lci5maW5kKCAiOmpxbURhdGEocm9sZT0naGVhZGVyJykiICkuZmlyc3QoKTsKCQkJYnRuID0gJCggIjxhPjwvYT4iLCB7CgkJCQkJInJvbGUiOiAiYnV0dG9uIiwKCQkJCQkiaHJlZiI6ICIjIiwKCQkJCQkiY2xhc3MiOiAidWktYnRuIHVpLWNvcm5lci1hbGwgdWktaWNvbi1kZWxldGUgdWktYnRuLWljb24tbm90ZXh0IHVpLWJ0bi0iICsgbG9jYXRpb24KCQkJCX0pCgkJCQkudGV4dCggdGV4dCB8fCB0aGlzLm9wdGlvbnMuY2xvc2VCdG5UZXh0IHx8ICIiICkKCQkJCS5wcmVwZW5kVG8oIGRzdCApOwoJCQl0aGlzLl9vbiggYnRuLCB7IGNsaWNrOiAiY2xvc2UiIH0gKTsKCQl9CgoJCXRoaXMuX2hlYWRlckNsb3NlQnV0dG9uID0gYnRuOwoJfSwKCgkvLyBDbG9zZSBtZXRob2QgZ29lcyBiYWNrIGluIGhpc3RvcnkKCWNsb3NlOiBmdW5jdGlvbigpIHsKCQl2YXIgaWR4LCBkc3QsIGhpc3QgPSAkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5OwoKCQlpZiAoIHRoaXMuX2lzQ2xvc2VhYmxlICkgewoJCQl0aGlzLl9pc0Nsb3NlYWJsZSA9IGZhbHNlOwoJCQkvLyBJZiB0aGUgaGFzaCBsaXN0ZW5pbmcgaXMgZW5hYmxlZCBhbmQgdGhlcmUgaXMgYXQgbGVhc3Qgb25lIHByZWNlZGluZyBoaXN0b3J5CgkJCS8vIGVudHJ5IGl0J3Mgb2sgdG8gZ28gYmFjay4gSW5pdGlhbCBwYWdlcyB3aXRoIHRoZSBkaWFsb2cgaGFzaCBzdGF0ZSBhcmUgYW4gZXhhbXBsZQoJCQkvLyB3aGVyZSB0aGUgc3RhY2sgY2hlY2sgaXMgbmVjZXNzYXJ5CgkJCWlmICggJC5tb2JpbGUuaGFzaExpc3RlbmluZ0VuYWJsZWQgJiYgaGlzdC5hY3RpdmVJbmRleCA+IDAgKSB7CgkJCQkkLm1vYmlsZS5iYWNrKCk7CgkJCX0gZWxzZSB7CgkJCQlpZHggPSBNYXRoLm1heCggMCwgaGlzdC5hY3RpdmVJbmRleCAtIDEgKTsKCQkJCWRzdCA9IGhpc3Quc3RhY2tbIGlkeCBdLnBhZ2VVcmwgfHwgaGlzdC5zdGFja1sgaWR4IF0udXJsOwoJCQkJaGlzdC5wcmV2aW91c0luZGV4ID0gaGlzdC5hY3RpdmVJbmRleDsKCQkJCWhpc3QuYWN0aXZlSW5kZXggPSBpZHg7CgkJCQlpZiAoICEkLm1vYmlsZS5wYXRoLmlzUGF0aCggZHN0ICkgKSB7CgkJCQkJZHN0ID0gJC5tb2JpbGUucGF0aC5tYWtlVXJsQWJzb2x1dGUoICIjIiArIGRzdCApOwoJCQkJfQoKCQkJCSQubW9iaWxlLmNoYW5nZVBhZ2UoIGRzdCwgeyBkaXJlY3Rpb246ICJiYWNrIiwgY2hhbmdlSGFzaDogZmFsc2UsIGZyb21IYXNoQ2hhbmdlOiB0cnVlIH0gKTsKCQkJfQoJCX0KCX0KfSk7Cgp9KSggalF1ZXJ5LCB0aGlzICk7CihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKdmFyIHJJbml0aWFsTGV0dGVyID0gLyhbQS1aXSkvZzsKCiQud2lkZ2V0KCAibW9iaWxlLmNvbGxhcHNpYmxlIiwgewoJb3B0aW9uczogewoJCWVuaGFuY2VkOiBmYWxzZSwKCQlleHBhbmRDdWVUZXh0OiBudWxsLAoJCWNvbGxhcHNlQ3VlVGV4dDogbnVsbCwKCQljb2xsYXBzZWQ6IHRydWUsCgkJaGVhZGluZzogImgxLGgyLGgzLGg0LGg1LGg2LGxlZ2VuZCIsCgkJY29sbGFwc2VkSWNvbjogbnVsbCwKCQlleHBhbmRlZEljb246IG51bGwsCgkJaWNvbnBvczogbnVsbCwKCQl0aGVtZTogbnVsbCwKCQljb250ZW50VGhlbWU6IG51bGwsCgkJaW5zZXQ6IG51bGwsCgkJY29ybmVyczogbnVsbCwKCQltaW5pOiBudWxsCgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXZhciBlbGVtID0gdGhpcy5lbGVtZW50LAoJCQl1aSA9IHsKCQkJCWFjY29yZGlvbjogZWxlbQoJCQkJCS5jbG9zZXN0KCAiOmpxbURhdGEocm9sZT0nY29sbGFwc2libGUtc2V0JykiICsKCQkJCQkJKCAkLm1vYmlsZS5jb2xsYXBzaWJsZXNldCA/ICIsIDptb2JpbGUtY29sbGFwc2libGVzZXQiIDogIiIgKSApCgkJCQkJLmFkZENsYXNzKCAidWktY29sbGFwc2libGUtc2V0IiApCgkJCX07CgoJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCV91aTogdWkKCQl9KTsKCgkJaWYgKCB0aGlzLm9wdGlvbnMuZW5oYW5jZWQgKSB7CgkJCXVpLmhlYWRpbmcgPSAkKCAiLnVpLWNvbGxhcHNpYmxlLWhlYWRpbmciLCB0aGlzLmVsZW1lbnRbIDAgXSApOwoJCQl1aS5jb250ZW50ID0gdWkuaGVhZGluZy5uZXh0KCk7CgkJCXVpLmFuY2hvciA9ICQoICJhIiwgdWkuaGVhZGluZ1sgMCBdICkuZmlyc3QoKTsKCQkJdWkuc3RhdHVzID0gdWkuYW5jaG9yLmNoaWxkcmVuKCAiLnVpLWNvbGxhcHNpYmxlLWhlYWRpbmctc3RhdHVzIiApOwoJCX0gZWxzZSB7CgkJCXRoaXMuX2VuaGFuY2UoIGVsZW0sIHVpICk7CgkJfQoKCQl0aGlzLl9vbiggdWkuaGVhZGluZywgewoJCQkidGFwIjogZnVuY3Rpb24oKSB7CgkJCQl1aS5oZWFkaW5nLmZpbmQoICJhIiApLmZpcnN0KCkuYWRkQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCX0sCgoJCQkiY2xpY2siOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQl0aGlzLl9oYW5kbGVFeHBhbmRDb2xsYXBzZSggIXVpLmhlYWRpbmcuaGFzQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZS1oZWFkaW5nLWNvbGxhcHNlZCIgKSApOwoJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCWV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOwoJCQl9CgkJfSk7Cgl9LAoKCS8vIEFkanVzdCB0aGUga2V5cyBpbnNpZGUgb3B0aW9ucyBmb3IgaW5oZXJpdGVkIHZhbHVlcwoJX2dldE9wdGlvbnM6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCXZhciBrZXksCgkJCWFjY29yZGlvbiA9IHRoaXMuX3VpLmFjY29yZGlvbiwKCQkJYWNjb3JkaW9uV2lkZ2V0ID0gdGhpcy5fdWkuYWNjb3JkaW9uV2lkZ2V0OwoKCQkvLyBDb3B5IG9wdGlvbnMKCQlvcHRpb25zID0gJC5leHRlbmQoIHt9LCBvcHRpb25zICk7CgoJCWlmICggYWNjb3JkaW9uLmxlbmd0aCAmJiAhYWNjb3JkaW9uV2lkZ2V0ICkgewoJCQl0aGlzLl91aS5hY2NvcmRpb25XaWRnZXQgPQoJCQlhY2NvcmRpb25XaWRnZXQgPSBhY2NvcmRpb24uZGF0YSggIm1vYmlsZS1jb2xsYXBzaWJsZXNldCIgKTsKCQl9CgoJCWZvciAoIGtleSBpbiBvcHRpb25zICkgewoKCQkJLy8gUmV0cmlldmUgdGhlIG9wdGlvbiB2YWx1ZSBmaXJzdCBmcm9tIHRoZSBvcHRpb25zIG9iamVjdCBwYXNzZWQgaW4gYW5kLCBpZgoJCQkvLyBudWxsLCBmcm9tIHRoZSBwYXJlbnQgYWNjb3JkaW9uIG9yLCBpZiB0aGF0J3MgbnVsbCB0b28sIG9yIGlmIHRoZXJlJ3Mgbm8KCQkJLy8gcGFyZW50IGFjY29yZGlvbiwgdGhlbiBmcm9tIHRoZSBkZWZhdWx0cy4KCQkJb3B0aW9uc1sga2V5IF0gPQoJCQkJKCBvcHRpb25zWyBrZXkgXSAhPSBudWxsICkgPyBvcHRpb25zWyBrZXkgXSA6CgkJCQkoIGFjY29yZGlvbldpZGdldCApID8gYWNjb3JkaW9uV2lkZ2V0Lm9wdGlvbnNbIGtleSBdIDoKCQkJCWFjY29yZGlvbi5sZW5ndGggPyAkLm1vYmlsZS5nZXRBdHRyaWJ1dGUoIGFjY29yZGlvblsgMCBdLAoJCQkJCWtleS5yZXBsYWNlKCBySW5pdGlhbExldHRlciwgIi0kMSIgKS50b0xvd2VyQ2FzZSgpICk6CgkJCQludWxsOwoKCQkJaWYgKCBudWxsID09IG9wdGlvbnNbIGtleSBdICkgewoJCQkJb3B0aW9uc1sga2V5IF0gPSAkLm1vYmlsZS5jb2xsYXBzaWJsZS5kZWZhdWx0c1sga2V5IF07CgkJCX0KCQl9CgoJCXJldHVybiBvcHRpb25zOwoJfSwKCglfdGhlbWVDbGFzc0Zyb21PcHRpb246IGZ1bmN0aW9uKCBwcmVmaXgsIHZhbHVlICkgewoJCXJldHVybiAoIHZhbHVlID8gKCB2YWx1ZSA9PT0gIm5vbmUiID8gIiIgOiBwcmVmaXggKyB2YWx1ZSApIDogIiIgKTsKCX0sCgoJX2VuaGFuY2U6IGZ1bmN0aW9uKCBlbGVtLCB1aSApIHsKCQl2YXIgaWNvbmNsYXNzLAoJCQlvcHRzID0gdGhpcy5fZ2V0T3B0aW9ucyggdGhpcy5vcHRpb25zICksCgkJCWNvbnRlbnRUaGVtZUNsYXNzID0gdGhpcy5fdGhlbWVDbGFzc0Zyb21PcHRpb24oICJ1aS1ib2R5LSIsIG9wdHMuY29udGVudFRoZW1lICk7CgoJCWVsZW0uYWRkQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZSAiICsKCQkJKCBvcHRzLmluc2V0ID8gInVpLWNvbGxhcHNpYmxlLWluc2V0ICIgOiAiIiApICsKCQkJKCBvcHRzLmluc2V0ICYmIG9wdHMuY29ybmVycyA/ICJ1aS1jb3JuZXItYWxsICIgOiAiIiApICsKCQkJKCBjb250ZW50VGhlbWVDbGFzcyA/ICJ1aS1jb2xsYXBzaWJsZS10aGVtZWQtY29udGVudCAiIDogIiIgKSApOwoJCXVpLm9yaWdpbmFsSGVhZGluZyA9IGVsZW0uY2hpbGRyZW4oIHRoaXMub3B0aW9ucy5oZWFkaW5nICkuZmlyc3QoKSwKCQl1aS5jb250ZW50ID0gZWxlbQoJCQkud3JhcElubmVyKCAiPGRpdiAiICsKCQkJCSJjbGFzcz0ndWktY29sbGFwc2libGUtY29udGVudCAiICsKCQkJCWNvbnRlbnRUaGVtZUNsYXNzICsgIic+PC9kaXY+IiApCgkJCS5jaGlsZHJlbiggIi51aS1jb2xsYXBzaWJsZS1jb250ZW50IiApLAoJCXVpLmhlYWRpbmcgPSB1aS5vcmlnaW5hbEhlYWRpbmc7CgoJCS8vIFJlcGxhY2UgY29sbGFwc2libGVIZWFkaW5nIGlmIGl0J3MgYSBsZWdlbmQKCQlpZiAoIHVpLmhlYWRpbmcuaXMoICJsZWdlbmQiICkgKSB7CgkJCXVpLmhlYWRpbmcgPSAkKCAiPGRpdiByb2xlPSdoZWFkaW5nJz4iKyB1aS5oZWFkaW5nLmh0bWwoKSArIjwvZGl2PiIgKTsKCQkJdWkucGxhY2Vob2xkZXIgPSAkKCAiPGRpdj48IS0tIHBsYWNlaG9sZGVyIGZvciBsZWdlbmQgLS0+PC9kaXY+IiApLmluc2VydEJlZm9yZSggdWkub3JpZ2luYWxIZWFkaW5nICk7CgkJCXVpLm9yaWdpbmFsSGVhZGluZy5yZW1vdmUoKTsKCQl9CgoJCWljb25jbGFzcyA9ICggb3B0cy5jb2xsYXBzZWQgPyAoIG9wdHMuY29sbGFwc2VkSWNvbiA/ICJ1aS1pY29uLSIgKyBvcHRzLmNvbGxhcHNlZEljb24gOiAiIiApOgoJCQkoIG9wdHMuZXhwYW5kZWRJY29uID8gInVpLWljb24tIiArIG9wdHMuZXhwYW5kZWRJY29uIDogIiIgKSApOwoKCQl1aS5zdGF0dXMgPSAkKCAiPHNwYW4gY2xhc3M9J3VpLWNvbGxhcHNpYmxlLWhlYWRpbmctc3RhdHVzJz48L3NwYW4+IiApOwoJCXVpLmFuY2hvciA9IHVpLmhlYWRpbmcKCQkJLmRldGFjaCgpCgkJCS8vbW9kaWZ5IG1hcmt1cCAmIGF0dHJpYnV0ZXMKCQkJLmFkZENsYXNzKCAidWktY29sbGFwc2libGUtaGVhZGluZyIgKQoJCQkuYXBwZW5kKCB1aS5zdGF0dXMgKQoJCQkud3JhcElubmVyKCAiPGEgaHJlZj0nIycgY2xhc3M9J3VpLWNvbGxhcHNpYmxlLWhlYWRpbmctdG9nZ2xlJz48L2E+IiApCgkJCS5maW5kKCAiYSIgKQoJCQkJLmZpcnN0KCkKCQkJCS5hZGRDbGFzcyggInVpLWJ0biAiICsKCQkJCQkoIGljb25jbGFzcyA/IGljb25jbGFzcyArICIgIiA6ICIiICkgKwoJCQkJCSggaWNvbmNsYXNzID8gKCAidWktYnRuLWljb24tIiArCgkJCQkJCSggb3B0cy5pY29ucG9zID09PSAicmlnaHQiID8gInJpZ2h0IiA6ICJsZWZ0IiApICkgKwoJCQkJCQkiICIgOiAiIiApICsKCQkJCQl0aGlzLl90aGVtZUNsYXNzRnJvbU9wdGlvbiggInVpLWJ0bi0iLCBvcHRzLnRoZW1lICkgKyAiICIgKwoJCQkJCSggb3B0cy5taW5pID8gInVpLW1pbmkgIiA6ICIiICkgKTsKCgkJLy9kcm9wIGhlYWRpbmcgaW4gYmVmb3JlIGNvbnRlbnQKCQl1aS5oZWFkaW5nLmluc2VydEJlZm9yZSggdWkuY29udGVudCApOwoKCQl0aGlzLl9oYW5kbGVFeHBhbmRDb2xsYXBzZSggdGhpcy5vcHRpb25zLmNvbGxhcHNlZCApOwoKCQlyZXR1cm4gdWk7Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCXZhciBrZXksIG9wdGlvbnMgPSB7fTsKCgkJZm9yICgga2V5IGluICQubW9iaWxlLmNvbGxhcHNpYmxlLmRlZmF1bHRzICkgewoJCQlvcHRpb25zWyBrZXkgXSA9IHRoaXMub3B0aW9uc1sga2V5IF07CgkJfQoKCQl0aGlzLl9zZXRPcHRpb25zKCBvcHRpb25zICk7Cgl9LAoKCV9zZXRPcHRpb25zOiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQl2YXIgaXNDb2xsYXBzZWQsIG5ld1RoZW1lLCBvbGRUaGVtZSwgaGFzQ29ybmVycywKCQkJZWxlbSA9IHRoaXMuZWxlbWVudCwKCQkJY3VycmVudE9wdHMgPSB0aGlzLl9nZXRPcHRpb25zKCB0aGlzLm9wdGlvbnMgKSwKCQkJdWkgPSB0aGlzLl91aSwKCQkJYW5jaG9yID0gdWkuYW5jaG9yLAoJCQlzdGF0dXMgPSB1aS5zdGF0dXMsCgkJCW9wdHMgPSB0aGlzLl9nZXRPcHRpb25zKCBvcHRpb25zICk7CgoJCS8vIEZpcnN0IGFuZCBmb3JlbW9zdCB3ZSBuZWVkIHRvIG1ha2Ugc3VyZSB0aGUgY29sbGFwc2libGUgaXMgaW4gdGhlIHByb3BlcgoJCS8vIHN0YXRlLCBpbiBjYXNlIHNvbWVib2R5IGRlY2lkZWQgdG8gY2hhbmdlIHRoZSBjb2xsYXBzZWQgb3B0aW9uIGF0IHRoZQoJCS8vIHNhbWUgdGltZSBhcyBhbm90aGVyIG9wdGlvbgoJCWlmICggb3B0aW9ucy5jb2xsYXBzZWQgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhpcy5faGFuZGxlRXhwYW5kQ29sbGFwc2UoIG9wdGlvbnMuY29sbGFwc2VkICk7CgkJfQoKCQlpc0NvbGxhcHNlZCA9IGVsZW0uaGFzQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZS1jb2xsYXBzZWQiICk7CgoJCS8vIE9ubHkgb3B0aW9ucyByZWZlcnJpbmcgdG8gdGhlIGN1cnJlbnQgc3RhdGUgbmVlZCB0byBiZSBhcHBsaWVkIHJpZ2h0IGF3YXkKCQkvLyBJdCBpcyBlbm91Z2ggdG8gc3RvcmUgb3B0aW9ucyBjb3ZlcmluZyB0aGUgYWx0ZXJuYXRlIGluIHRoaXMub3B0aW9ucy4KCQlpZiAoIGlzQ29sbGFwc2VkICkgewoJCQlpZiAoIG9wdHMuZXhwYW5kQ3VlVGV4dCAhPT0gdW5kZWZpbmVkICkgewoJCQkJc3RhdHVzLnRleHQoIG9wdHMuZXhwYW5kQ3VlVGV4dCApOwoJCQl9CgkJCWlmICggb3B0cy5jb2xsYXBzZWRJY29uICE9PSB1bmRlZmluZWQgKSB7CgkJCQlpZiAoIGN1cnJlbnRPcHRzLmNvbGxhcHNlZEljb24gKSB7CgkJCQkJYW5jaG9yLnJlbW92ZUNsYXNzKCAidWktaWNvbi0iICsgY3VycmVudE9wdHMuY29sbGFwc2VkSWNvbiApOwoJCQkJfQoJCQkJaWYgKCBvcHRzLmNvbGxhcHNlZEljb24gKSB7CgkJCQkJYW5jaG9yLmFkZENsYXNzKCAidWktaWNvbi0iICsgb3B0cy5jb2xsYXBzZWRJY29uICk7CgkJCQl9CgkJCX0KCQl9IGVsc2UgewoJCQlpZiAoIG9wdHMuY29sbGFwc2VDdWVUZXh0ICE9PSB1bmRlZmluZWQgKSB7CgkJCQlzdGF0dXMudGV4dCggb3B0cy5jb2xsYXBzZUN1ZVRleHQgKTsKCQkJfQoJCQlpZiAoIG9wdHMuZXhwYW5kZWRJY29uICE9PSB1bmRlZmluZWQgKSB7CgkJCQlpZiAoIGN1cnJlbnRPcHRzLmV4cGFuZGVkSWNvbiApIHsKCQkJCQlhbmNob3IucmVtb3ZlQ2xhc3MoICJ1aS1pY29uLSIgKyBjdXJyZW50T3B0cy5leHBhbmRlZEljb24gKTsKCQkJCX0KCQkJCWlmICggb3B0cy5leHBhbmRlZEljb24gKSB7CgkJCQkJYW5jaG9yLmFkZENsYXNzKCAidWktaWNvbi0iICsgb3B0cy5leHBhbmRlZEljb24gKTsKCQkJCX0KCQkJfQoJCX0KCgkJaWYgKCBvcHRzLmljb25wb3MgIT09IHVuZGVmaW5lZCApIHsKCQkJYW5jaG9yLnJlbW92ZUNsYXNzKCAidWktYnRuLWljb24tIiArICggY3VycmVudE9wdHMuaWNvblBvcyA9PT0gInJpZ2h0IiA/ICJyaWdodCIgOiAibGVmdCIgKSApOwoJCQlhbmNob3IuYWRkQ2xhc3MoICJ1aS1idG4taWNvbi0iICsgKCBvcHRzLmljb25Qb3MgPT09ICJyaWdodCIgPyAicmlnaHQiIDogImxlZnQiICkgKTsKCQl9CgoJCWlmICggb3B0cy50aGVtZSAhPT0gdW5kZWZpbmVkICkgewoJCQlvbGRUaGVtZSA9IHRoaXMuX3RoZW1lQ2xhc3NGcm9tT3B0aW9uKCAidWktYnRuLSIsIGN1cnJlbnRPcHRzLnRoZW1lICk7CgkJCW5ld1RoZW1lID0gdGhpcy5fdGhlbWVDbGFzc0Zyb21PcHRpb24oICJ1aS1idG4tIiwgb3B0cy50aGVtZSApOwoJCQlhbmNob3IucmVtb3ZlQ2xhc3MoIG9sZFRoZW1lICkuYWRkQ2xhc3MoIG5ld1RoZW1lICk7CgkJfQoKCQlpZiAoIG9wdHMuY29udGVudFRoZW1lICE9PSB1bmRlZmluZWQgKSB7CgkJCW9sZFRoZW1lID0gdGhpcy5fdGhlbWVDbGFzc0Zyb21PcHRpb24oICJ1aS1ib2R5LSIsIGN1cnJlbnRPcHRzLnRoZW1lICk7CgkJCW5ld1RoZW1lID0gdGhpcy5fdGhlbWVDbGFzc0Zyb21PcHRpb24oICJ1aS1ib2R5LSIsIG9wdHMudGhlbWUgKTsKCQkJdWkuY29udGVudC5yZW1vdmVDbGFzcyggb2xkVGhlbWUgKS5hZGRDbGFzcyggbmV3VGhlbWUgKTsKCQl9CgoJCWlmICggb3B0cy5pbnNldCAhPT0gdW5kZWZpbmVkICkgewoJCQllbGVtLnRvZ2dsZUNsYXNzKCAidWktY29sbGFwc2libGUtaW5zZXQiLCBvcHRzLmluc2V0ICk7CgkJCWhhc0Nvcm5lcnMgPSAhISggb3B0cy5pbnNldCAmJiAoIG9wdHMuY29ybmVycyB8fCBjdXJyZW50T3B0cy5jb3JuZXJzICkgKTsKCQl9CgoJCWlmICggb3B0cy5jb3JuZXJzICE9PSB1bmRlZmluZWQgKSB7CgkJCWhhc0Nvcm5lcnMgPSAhISggb3B0cy5jb3JuZXJzICYmICggb3B0cy5pbnNldCB8fCBjdXJyZW50T3B0cy5pbnNldCApICk7CgkJfQoKCQlpZiAoIGhhc0Nvcm5lcnMgIT09IHVuZGVmaW5lZCApIHsKCQkJZWxlbS50b2dnbGVDbGFzcyggInVpLWNvcm5lci1hbGwiLCBoYXNDb3JuZXJzICk7CgkJfQoKCQlpZiAoIG9wdHMubWluaSAhPT0gdW5kZWZpbmVkICkgewoJCQlhbmNob3IudG9nZ2xlQ2xhc3MoICJ1aS1taW5pIiwgb3B0cy5taW5pICk7CgkJfQoKCQl0aGlzLl9zdXBlciggb3B0aW9ucyApOwoJfSwKCglfaGFuZGxlRXhwYW5kQ29sbGFwc2U6IGZ1bmN0aW9uKCBpc0NvbGxhcHNlICkgewoJCXZhciBvcHRzID0gdGhpcy5fZ2V0T3B0aW9ucyggdGhpcy5vcHRpb25zICksCgkJCXVpID0gdGhpcy5fdWk7CgoJCXVpLnN0YXR1cy50ZXh0KCBpc0NvbGxhcHNlID8gb3B0cy5leHBhbmRDdWVUZXh0IDogb3B0cy5jb2xsYXBzZUN1ZVRleHQgKTsKCQl1aS5oZWFkaW5nCgkJCS50b2dnbGVDbGFzcyggInVpLWNvbGxhcHNpYmxlLWhlYWRpbmctY29sbGFwc2VkIiwgaXNDb2xsYXBzZSApCgkJCS5maW5kKCAiYSIgKS5maXJzdCgpCgkJCS50b2dnbGVDbGFzcyggInVpLWljb24tIiArIG9wdHMuZXhwYW5kZWRJY29uLCAhaXNDb2xsYXBzZSApCgoJCQkvLyBsb2dpYyBvciBjYXVzZSBzYW1lIGljb24gZm9yIGV4cGFuZGVkL2NvbGxhcHNlZCBzdGF0ZSB3b3VsZCByZW1vdmUgdGhlIHVpLWljb24tY2xhc3MKCQkJLnRvZ2dsZUNsYXNzKCAidWktaWNvbi0iICsgb3B0cy5jb2xsYXBzZWRJY29uLCAoIGlzQ29sbGFwc2UgfHwgb3B0cy5leHBhbmRlZEljb24gPT09IG9wdHMuY29sbGFwc2VkSWNvbiApICkKCQkJLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoKCQl0aGlzLmVsZW1lbnQudG9nZ2xlQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZS1jb2xsYXBzZWQiLCBpc0NvbGxhcHNlICk7CgkJdWkuY29udGVudAoJCQkudG9nZ2xlQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZS1jb250ZW50LWNvbGxhcHNlZCIsIGlzQ29sbGFwc2UgKQoJCQkuYXR0ciggImFyaWEtaGlkZGVuIiwgaXNDb2xsYXBzZSApCgkJCS50cmlnZ2VyKCAidXBkYXRlbGF5b3V0IiApOwoJCXRoaXMub3B0aW9ucy5jb2xsYXBzZWQgPSBpc0NvbGxhcHNlOwoJCXRoaXMuX3RyaWdnZXIoIGlzQ29sbGFwc2UgPyAiY29sbGFwc2UiIDogImV4cGFuZCIgKTsKCX0sCgoJZXhwYW5kOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9oYW5kbGVFeHBhbmRDb2xsYXBzZSggZmFsc2UgKTsKCX0sCgoJY29sbGFwc2U6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX2hhbmRsZUV4cGFuZENvbGxhcHNlKCB0cnVlICk7Cgl9LAoKCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCQl2YXIgdWkgPSB0aGlzLl91aSwKCQkJb3B0cyA9IHRoaXMub3B0aW9uczsKCgkJaWYgKCBvcHRzLmVuaGFuY2VkICkgewoJCQlyZXR1cm47CgkJfQoKCQlpZiAoIHVpLnBsYWNlaG9sZGVyICkgewoJCQl1aS5vcmlnaW5hbEhlYWRpbmcuaW5zZXJ0QmVmb3JlKCB1aS5wbGFjZWhvbGRlciApOwoJCQl1aS5wbGFjZWhvbGRlci5yZW1vdmUoKTsKCQkJdWkuaGVhZGluZy5yZW1vdmUoKTsKCQl9IGVsc2UgewoJCQl1aS5zdGF0dXMucmVtb3ZlKCk7CgkJCXVpLmhlYWRpbmcKCQkJCS5yZW1vdmVDbGFzcyggInVpLWNvbGxhcHNpYmxlLWhlYWRpbmcgdWktY29sbGFwc2libGUtaGVhZGluZy1jb2xsYXBzZWQiICkKCQkJCS5jaGlsZHJlbigpCgkJCQkJLmNvbnRlbnRzKCkKCQkJCQkJLnVud3JhcCgpOwoJCX0KCgkJdWkuYW5jaG9yLmNvbnRlbnRzKCkudW53cmFwKCk7CgkJdWkuY29udGVudC5jb250ZW50cygpLnVud3JhcCgpOwoJCXRoaXMuZWxlbWVudAoJCQkucmVtb3ZlQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZSB1aS1jb2xsYXBzaWJsZS1jb2xsYXBzZWQgIiArCgkJCQkidWktY29sbGFwc2libGUtdGhlbWVkLWNvbnRlbnQgdWktY29sbGFwc2libGUtaW5zZXQgdWktY29ybmVyLWFsbCIgKTsKCX0KfSk7CgovLyBEZWZhdWx0cyB0byBiZSB1c2VkIGJ5IGFsbCBpbnN0YW5jZXMgb2YgY29sbGFwc2libGUgaWYgcGVyLWluc3RhbmNlIHZhbHVlcwovLyBhcmUgdW5zZXQgb3IgaWYgbm90aGluZyBpcyBzcGVjaWZpZWQgYnkgd2F5IG9mIGluaGVyaXRhbmNlIGZyb20gYW4gYWNjb3JkaW9uLgovLyBOb3RlIHRoYXQgdGhpcyBoYXNoIGRvZXMgbm90IGNvbnRhaW4gb3B0aW9ucyAiY29sbGFwc2VkIiBvciAiaGVhZGluZyIsCi8vIGJlY2F1c2UgdGhvc2UgYXJlIG5vdCBpbmhlcml0YWJsZS4KJC5tb2JpbGUuY29sbGFwc2libGUuZGVmYXVsdHMgPSB7CglleHBhbmRDdWVUZXh0OiAiIGNsaWNrIHRvIGV4cGFuZCBjb250ZW50cyIsCgljb2xsYXBzZUN1ZVRleHQ6ICIgY2xpY2sgdG8gY29sbGFwc2UgY29udGVudHMiLAoJY29sbGFwc2VkSWNvbjogInBsdXMiLAoJY29udGVudFRoZW1lOiAiaW5oZXJpdCIsCglleHBhbmRlZEljb246ICJtaW51cyIsCglpY29ucG9zOiAibGVmdCIsCglpbnNldDogdHJ1ZSwKCWNvcm5lcnM6IHRydWUsCgltaW5pOiBmYWxzZQp9OwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS5iZWhhdmlvcnMuYWRkRmlyc3RMYXN0Q2xhc3NlcyA9IHsKCV9nZXRWaXNpYmxlczogZnVuY3Rpb24oICRlbHMsIGNyZWF0ZSApIHsKCQl2YXIgdmlzaWJsZXM7CgoJCWlmICggY3JlYXRlICkgewoJCQl2aXNpYmxlcyA9ICRlbHMubm90KCAiLnVpLXNjcmVlbi1oaWRkZW4iICk7CgkJfSBlbHNlIHsKCQkJdmlzaWJsZXMgPSAkZWxzLmZpbHRlciggIjp2aXNpYmxlIiApOwoJCQlpZiAoIHZpc2libGVzLmxlbmd0aCA9PT0gMCApIHsKCQkJCXZpc2libGVzID0gJGVscy5ub3QoICIudWktc2NyZWVuLWhpZGRlbiIgKTsKCQkJfQoJCX0KCgkJcmV0dXJuIHZpc2libGVzOwoJfSwKCglfYWRkRmlyc3RMYXN0Q2xhc3NlczogZnVuY3Rpb24oICRlbHMsICR2aXNpYmxlcywgY3JlYXRlICkgewoJCSRlbHMucmVtb3ZlQ2xhc3MoICJ1aS1maXJzdC1jaGlsZCB1aS1sYXN0LWNoaWxkIiApOwoJCSR2aXNpYmxlcy5lcSggMCApLmFkZENsYXNzKCAidWktZmlyc3QtY2hpbGQiICkuZW5kKCkubGFzdCgpLmFkZENsYXNzKCAidWktbGFzdC1jaGlsZCIgKTsKCQlpZiAoICFjcmVhdGUgKSB7CgkJCXRoaXMuZWxlbWVudC50cmlnZ2VyKCAidXBkYXRlbGF5b3V0IiApOwoJCX0KCX0sCgoJX3JlbW92ZUZpcnN0TGFzdENsYXNzZXM6IGZ1bmN0aW9uKCAkZWxzICkgewoJCSRlbHMucmVtb3ZlQ2xhc3MoICJ1aS1maXJzdC1jaGlsZCB1aS1sYXN0LWNoaWxkIiApOwoJfQp9OwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7Cgp2YXIgY2hpbGRDb2xsYXBzaWJsZXNTZWxlY3RvciA9ICI6bW9iaWxlLWNvbGxhcHNpYmxlLCAiICsgJC5tb2JpbGUuY29sbGFwc2libGUuaW5pdFNlbGVjdG9yOwoKJC53aWRnZXQoICJtb2JpbGUuY29sbGFwc2libGVzZXQiLCAkLmV4dGVuZCggewoKCS8vIFRoZSBpbml0U2VsZWN0b3IgaXMgZGVwcmVjYXRlZCBhcyBvZiAxLjQuMC4gSW4gMS41LjAgd2Ugd2lsbCB1c2UKCS8vIDpqcW1EYXRhKHJvbGU9J2NvbGxhcHNpYmxlc2V0Jykgd2hpY2ggd2lsbCBhbGxvdyB1cyB0byBnZXQgcmlkIG9mIHRoZSBsaW5lCgkvLyBiZWxvdyBhbHRvZ2V0aGVyLCBiZWNhdXNlIHRoZSBhdXRvaW5pdCB3aWxsIGdlbmVyYXRlIHN1Y2ggYW4gaW5pdFNlbGVjdG9yCglpbml0U2VsZWN0b3I6ICI6anFtRGF0YShyb2xlPSdjb2xsYXBzaWJsZS1zZXQnKSw6anFtRGF0YShyb2xlPSdjb2xsYXBzaWJsZXNldCcpIiwKCglvcHRpb25zOiAkLmV4dGVuZCggewoJCWVuaGFuY2VkOiBmYWxzZSwKCX0sICQubW9iaWxlLmNvbGxhcHNpYmxlLmRlZmF1bHRzICksCgoJX2hhbmRsZUNvbGxhcHNpYmxlRXhwYW5kOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJdmFyIGNsb3Nlc3RDb2xsYXBzaWJsZSA9ICQoIGV2ZW50LnRhcmdldCApLmNsb3Nlc3QoICIudWktY29sbGFwc2libGUiICk7CgoJCWlmICggY2xvc2VzdENvbGxhcHNpYmxlLnBhcmVudCgpLmlzKCAiOm1vYmlsZS1jb2xsYXBzaWJsZXNldCwgOmpxbURhdGEocm9sZT0nY29sbGFwc2libGUtc2V0JykiICkgKSB7CgkJCWNsb3Nlc3RDb2xsYXBzaWJsZQoJCQkJLnNpYmxpbmdzKCAiLnVpLWNvbGxhcHNpYmxlOm5vdCgudWktY29sbGFwc2libGUtY29sbGFwc2VkKSIgKQoJCQkJLmNvbGxhcHNpYmxlKCAiY29sbGFwc2UiICk7CgkJfQoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl2YXIgZWxlbSA9IHRoaXMuZWxlbWVudCwKCQkJb3B0cyA9IHRoaXMub3B0aW9uczsKCgkJJC5leHRlbmQoIHRoaXMsIHsKCQkJX2NsYXNzZXM6ICIiCgkJfSk7CgoJCWlmICggIW9wdHMuZW5oYW5jZWQgKSB7CgkJCWVsZW0uYWRkQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZS1zZXQgIiArCgkJCQl0aGlzLl90aGVtZUNsYXNzRnJvbU9wdGlvbiggInVpLWdyb3VwLXRoZW1lLSIsIG9wdHMudGhlbWUgKSArICIgIiArCgkJCQkoIG9wdHMuY29ybmVycyAmJiBvcHRzLmluc2V0ID8gInVpLWNvcm5lci1hbGwgIiA6ICIiICkgKTsKCQkJdGhpcy5lbGVtZW50LmZpbmQoICQubW9iaWxlLmNvbGxhcHNpYmxlLmluaXRTZWxlY3RvciApLmNvbGxhcHNpYmxlKCk7CgkJfQoKCQl0aGlzLl9vbiggZWxlbSwgeyBjb2xsYXBzaWJsZWV4cGFuZDogIl9oYW5kbGVDb2xsYXBzaWJsZUV4cGFuZCIgfSApOwoJfSwKCglfdGhlbWVDbGFzc0Zyb21PcHRpb246IGZ1bmN0aW9uKCBwcmVmaXgsIHZhbHVlICkgewoJCXJldHVybiAoIHZhbHVlID8gKCB2YWx1ZSA9PT0gIm5vbmUiID8gIiIgOiBwcmVmaXggKyB2YWx1ZSApIDogIiIgKTsKCX0sCgoJX2luaXQ6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3JlZnJlc2goIHRydWUgKTsKCgkJLy8gQmVjYXVzZSB0aGUgY29ybmVycyBhcmUgaGFuZGxlZCBieSB0aGUgY29sbGFwc2libGUgaXRzZWxmIGFuZCB0aGUgZGVmYXVsdCBzdGF0ZSBpcyBjb2xsYXBzZWQKCQkvLyBUaGF0IHdhcyBjYXVzaW5nIGh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5LW1vYmlsZS9pc3N1ZXMvNDExNgoJCXRoaXMuZWxlbWVudAoJCQkuY2hpbGRyZW4oIGNoaWxkQ29sbGFwc2libGVzU2VsZWN0b3IgKQoJCQkuZmlsdGVyKCAiOmpxbURhdGEoY29sbGFwc2VkPSdmYWxzZScpIiApCgkJCS5jb2xsYXBzaWJsZSggImV4cGFuZCIgKTsKCX0sCgoJX3NldE9wdGlvbnM6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCXZhciByZXQsIGhhc0Nvcm5lcnMsCgkJCWVsZW0gPSB0aGlzLmVsZW1lbnQsCgkJCXRoZW1lQ2xhc3MgPSB0aGlzLl90aGVtZUNsYXNzRnJvbU9wdGlvbiggInVpLWdyb3VwLXRoZW1lLSIsIG9wdGlvbnMudGhlbWUgKTsKCgkJaWYgKCB0aGVtZUNsYXNzICkgewoJCQllbGVtCgkJCQkucmVtb3ZlQ2xhc3MoIHRoaXMuX3RoZW1lQ2xhc3NGcm9tT3B0aW9uKCAidWktZ3JvdXAtdGhlbWUtIiwgdGhpcy5vcHRpb25zLnRoZW1lICkgKQoJCQkJLmFkZENsYXNzKCB0aGVtZUNsYXNzICk7CgkJfQoKCQlpZiAoIG9wdGlvbnMuaW5zZXQgIT09IHVuZGVmaW5lZCApIHsKCQkJaGFzQ29ybmVycyA9ICEhKCBvcHRpb25zLmluc2V0ICYmICggb3B0aW9ucy5jb3JuZXJzIHx8IHRoaXMub3B0aW9ucy5jb3JuZXJzICkgKTsKCQl9CgoJCWlmICggb3B0aW9ucy5jb3JuZXJzICE9PSB1bmRlZmluZWQgKSB7CgkJCWhhc0Nvcm5lcnMgPSAhISggb3B0aW9ucy5jb3JuZXJzICYmICggb3B0aW9ucy5pbnNldCB8fCB0aGlzLm9wdGlvbnMuaW5zZXQgKSApOwoJCX0KCgkJaWYgKCBoYXNDb3JuZXJzICE9PSB1bmRlZmluZWQgKSB7CgkJCWVsZW0udG9nZ2xlQ2xhc3MoICJ1aS1jb3JuZXItYWxsIiwgaGFzQ29ybmVycyApOwoJCX0KCgkJcmV0ID0gdGhpcy5fc3VwZXIoIG9wdGlvbnMgKTsKCQl0aGlzLmVsZW1lbnQuY2hpbGRyZW4oICI6bW9iaWxlLWNvbGxhcHNpYmxlIiApLmNvbGxhcHNpYmxlKCAicmVmcmVzaCIgKTsKCQlyZXR1cm4gcmV0OwoJfSwKCglfZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJdmFyIGVsID0gdGhpcy5lbGVtZW50OwoKCQl0aGlzLl9yZW1vdmVGaXJzdExhc3RDbGFzc2VzKCBlbC5jaGlsZHJlbiggY2hpbGRDb2xsYXBzaWJsZXNTZWxlY3RvciApICk7CgkJZWwKCQkJLnJlbW92ZUNsYXNzKCAidWktY29sbGFwc2libGUtc2V0IHVpLWNvcm5lci1hbGwgIiArCgkJCQl0aGlzLl90aGVtZUNsYXNzRnJvbU9wdGlvbiggInVpLWdyb3VwLXRoZW1lIiwgdGhpcy5vcHRpb25zLnRoZW1lICkgKQoJCQkuY2hpbGRyZW4oICI6bW9iaWxlLWNvbGxhcHNpYmxlIiApCgkJCS5jb2xsYXBzaWJsZSggImRlc3Ryb3kiICk7Cgl9LAoKCV9yZWZyZXNoOiBmdW5jdGlvbiggY3JlYXRlICkgewoJCXZhciBjb2xsYXBzaWJsZXNJblNldCA9IHRoaXMuZWxlbWVudC5jaGlsZHJlbiggY2hpbGRDb2xsYXBzaWJsZXNTZWxlY3RvciApOwoKCQl0aGlzLmVsZW1lbnQuZmluZCggJC5tb2JpbGUuY29sbGFwc2libGUuaW5pdFNlbGVjdG9yICkubm90KCAiLnVpLWNvbGxhcHNpYmxlIiApLmNvbGxhcHNpYmxlKCk7CgoJCXRoaXMuX2FkZEZpcnN0TGFzdENsYXNzZXMoIGNvbGxhcHNpYmxlc0luU2V0LCB0aGlzLl9nZXRWaXNpYmxlcyggY29sbGFwc2libGVzSW5TZXQsIGNyZWF0ZSApLCBjcmVhdGUgKTsKCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJdGhpcy5fcmVmcmVzaCggZmFsc2UgKTsKCX0KfSwgJC5tb2JpbGUuYmVoYXZpb3JzLmFkZEZpcnN0TGFzdENsYXNzZXMgKSApOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgovLyBEZXByZWNhdGVkIGluIDEuNAokLmZuLmZpZWxkY29udGFpbiA9IGZ1bmN0aW9uKC8qIG9wdGlvbnMgKi8pIHsKCXJldHVybiB0aGlzLmFkZENsYXNzKCAidWktZmllbGQtY29udGFpbiIgKTsKfTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC5mbi5ncmlkID0gZnVuY3Rpb24oIG9wdGlvbnMgKSB7CglyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoKCQl2YXIgJHRoaXMgPSAkKCB0aGlzICksCgkJCW8gPSAkLmV4dGVuZCh7CgkJCQlncmlkOiBudWxsCgkJCX0sIG9wdGlvbnMgKSwKCQkJJGtpZHMgPSAkdGhpcy5jaGlsZHJlbigpLAoJCQlncmlkQ29scyA9IHsgc29sbzoxLCBhOjIsIGI6MywgYzo0LCBkOjUgfSwKCQkJZ3JpZCA9IG8uZ3JpZCwKCQkJaXRlcmF0b3IsCgkJCWxldHRlcjsKCgkJCWlmICggIWdyaWQgKSB7CgkJCQlpZiAoICRraWRzLmxlbmd0aCA8PSA1ICkgewoJCQkJCWZvciAoIGxldHRlciBpbiBncmlkQ29scyApIHsKCQkJCQkJaWYgKCBncmlkQ29sc1sgbGV0dGVyIF0gPT09ICRraWRzLmxlbmd0aCApIHsKCQkJCQkJCWdyaWQgPSBsZXR0ZXI7CgkJCQkJCX0KCQkJCQl9CgkJCQl9IGVsc2UgewoJCQkJCWdyaWQgPSAiYSI7CgkJCQkJJHRoaXMuYWRkQ2xhc3MoICJ1aS1ncmlkLWR1byIgKTsKCQkJCX0KCQkJfQoJCQlpdGVyYXRvciA9IGdyaWRDb2xzW2dyaWRdOwoKCQkkdGhpcy5hZGRDbGFzcyggInVpLWdyaWQtIiArIGdyaWQgKTsKCgkJJGtpZHMuZmlsdGVyKCAiOm50aC1jaGlsZCgiICsgaXRlcmF0b3IgKyAibisxKSIgKS5hZGRDbGFzcyggInVpLWJsb2NrLWEiICk7CgoJCWlmICggaXRlcmF0b3IgPiAxICkgewoJCQkka2lkcy5maWx0ZXIoICI6bnRoLWNoaWxkKCIgKyBpdGVyYXRvciArICJuKzIpIiApLmFkZENsYXNzKCAidWktYmxvY2stYiIgKTsKCQl9CgkJaWYgKCBpdGVyYXRvciA+IDIgKSB7CgkJCSRraWRzLmZpbHRlciggIjpudGgtY2hpbGQoIiArIGl0ZXJhdG9yICsgIm4rMykiICkuYWRkQ2xhc3MoICJ1aS1ibG9jay1jIiApOwoJCX0KCQlpZiAoIGl0ZXJhdG9yID4gMyApIHsKCQkJJGtpZHMuZmlsdGVyKCAiOm50aC1jaGlsZCgiICsgaXRlcmF0b3IgKyAibis0KSIgKS5hZGRDbGFzcyggInVpLWJsb2NrLWQiICk7CgkJfQoJCWlmICggaXRlcmF0b3IgPiA0ICkgewoJCQkka2lkcy5maWx0ZXIoICI6bnRoLWNoaWxkKCIgKyBpdGVyYXRvciArICJuKzUpIiApLmFkZENsYXNzKCAidWktYmxvY2stZSIgKTsKCQl9Cgl9KTsKfTsKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS5uYXZiYXIiLCB7CglvcHRpb25zOiB7CgkJaWNvbnBvczogInRvcCIsCgkJZ3JpZDogbnVsbAoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCgkJdmFyICRuYXZiYXIgPSB0aGlzLmVsZW1lbnQsCgkJCSRuYXZidG5zID0gJG5hdmJhci5maW5kKCAiYSIgKSwKCQkJaWNvbnBvcyA9ICRuYXZidG5zLmZpbHRlciggIjpqcW1EYXRhKGljb24pIiApLmxlbmd0aCA/IHRoaXMub3B0aW9ucy5pY29ucG9zIDogdW5kZWZpbmVkOwoKCQkkbmF2YmFyLmFkZENsYXNzKCAidWktbmF2YmFyIiApCgkJCS5hdHRyKCAicm9sZSIsICJuYXZpZ2F0aW9uIiApCgkJCS5maW5kKCAidWwiICkKCQkJLmpxbUVuaGFuY2VhYmxlKCkKCQkJLmdyaWQoeyBncmlkOiB0aGlzLm9wdGlvbnMuZ3JpZCB9KTsKCgkJJG5hdmJ0bnMKCQkJLmVhY2goIGZ1bmN0aW9uKCkgewoJCQkJdmFyIGljb24gPSAkLm1vYmlsZS5nZXRBdHRyaWJ1dGUoIHRoaXMsICJpY29uIiApLAoJCQkJCXRoZW1lID0gJC5tb2JpbGUuZ2V0QXR0cmlidXRlKCB0aGlzLCAidGhlbWUiICksCgkJCQkJY2xhc3NlcyA9ICJ1aS1idG4iOwoKCQkJCWlmICggdGhlbWUgKSB7CgkJCQkJY2xhc3NlcyArPSAiIHVpLWJ0bi0iICsgdGhlbWU7CgkJCQl9CgkJCQlpZiAoIGljb24gKSB7CgkJCQkJY2xhc3NlcyArPSAiIHVpLWljb24tIiArIGljb24gKyAiIHVpLWJ0bi1pY29uLSIgKyBpY29ucG9zOwoJCQkJfQoJCQkJJCggdGhpcyApLmFkZENsYXNzKCBjbGFzc2VzICk7CgkJCX0pOwoKCQkkbmF2YmFyLmRlbGVnYXRlKCAiYSIsICJ2Y2xpY2siLCBmdW5jdGlvbiggLyogZXZlbnQgKi8gKSB7CgkJCXZhciBhY3RpdmVCdG4gPSAkKCB0aGlzICk7CgoJCQlpZiAoICEoIGFjdGl2ZUJ0bi5oYXNDbGFzcyggInVpLXN0YXRlLWRpc2FibGVkIiApIHx8CgoJCQkJLy8gREVQUkVDQVRFRCBhcyBvZiAxLjQuMCAtIHJlbW92ZSBhZnRlciAxLjQuMCByZWxlYXNlCgkJCQkvLyBvbmx5IHVpLXN0YXRlLWRpc2FibGVkIHNob3VsZCBiZSBwcmVzZW50IHRoZXJlYWZ0ZXIKCQkJCWFjdGl2ZUJ0bi5oYXNDbGFzcyggInVpLWRpc2FibGVkIiApIHx8CgkJCQlhY3RpdmVCdG4uaGFzQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICkgKSApIHsKCgkJCQkkbmF2YnRucy5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJCWFjdGl2ZUJ0bi5hZGRDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCgkJCQkvLyBUaGUgY29kZSBiZWxvdyBpcyBhIHdvcmthcm91bmQgdG8gZml4ICMxMTgxCgkJCQkkKCBkb2N1bWVudCApLm9uZSggInBhZ2VoaWRlIiwgZnVuY3Rpb24oKSB7CgkJCQkJYWN0aXZlQnRuLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQkJfSk7CgkJCX0KCQl9KTsKCgkJLy8gQnV0dG9ucyBpbiB0aGUgbmF2YmFyIHdpdGggdWktc3RhdGUtcGVyc2lzdCBjbGFzcyBzaG91bGQgcmVnYWluIHRoZWlyIGFjdGl2ZSBzdGF0ZSBiZWZvcmUgcGFnZSBzaG93CgkJJG5hdmJhci5jbG9zZXN0KCAiLnVpLXBhZ2UiICkuYmluZCggInBhZ2ViZWZvcmVzaG93IiwgZnVuY3Rpb24oKSB7CgkJCSRuYXZidG5zLmZpbHRlciggIi51aS1zdGF0ZS1wZXJzaXN0IiApLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCX0pOwoJfQp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKdmFyIGdldEF0dHIgPSAkLm1vYmlsZS5nZXRBdHRyaWJ1dGU7CgokLndpZGdldCggIm1vYmlsZS5saXN0dmlldyIsICQuZXh0ZW5kKCB7CgoJb3B0aW9uczogewoJCXRoZW1lOiBudWxsLAoJCWNvdW50VGhlbWU6IG51bGwsIC8qIERlcHJlY2F0ZWQgaW4gMS40ICovCgkJZGl2aWRlclRoZW1lOiBudWxsLAoJCWljb246ICJjYXJhdC1yIiwKCQlzcGxpdEljb246ICJjYXJhdC1yIiwKCQlzcGxpdFRoZW1lOiBudWxsLAoJCWNvcm5lcnM6IHRydWUsCgkJc2hhZG93OiB0cnVlLAoJCWluc2V0OiBmYWxzZQoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl2YXIgdCA9IHRoaXMsCgkJCWxpc3R2aWV3Q2xhc3NlcyA9ICIiOwoKCQlsaXN0dmlld0NsYXNzZXMgKz0gdC5vcHRpb25zLmluc2V0ID8gIiB1aS1saXN0dmlldy1pbnNldCIgOiAiIjsKCgkJaWYgKCAhIXQub3B0aW9ucy5pbnNldCApIHsKCQkJbGlzdHZpZXdDbGFzc2VzICs9IHQub3B0aW9ucy5jb3JuZXJzID8gIiB1aS1jb3JuZXItYWxsIiA6ICIiOwoJCQlsaXN0dmlld0NsYXNzZXMgKz0gdC5vcHRpb25zLnNoYWRvdyA/ICIgdWktc2hhZG93IiA6ICIiOwoJCX0KCgkJLy8gY3JlYXRlIGxpc3R2aWV3IG1hcmt1cAoJCXQuZWxlbWVudC5hZGRDbGFzcyggIiB1aS1saXN0dmlldyIgKyBsaXN0dmlld0NsYXNzZXMgKTsKCgkJdC5yZWZyZXNoKCB0cnVlICk7Cgl9LAoKCS8vIFRPRE86IFJlbW92ZSBpbiAxLjUKCV9maW5kRmlyc3RFbGVtZW50QnlUYWdOYW1lOiBmdW5jdGlvbiggZWxlLCBuZXh0UHJvcCwgbGNOYW1lLCB1Y05hbWUgKSB7CgkJdmFyIGRpY3QgPSB7fTsKCQlkaWN0WyBsY05hbWUgXSA9IGRpY3RbIHVjTmFtZSBdID0gdHJ1ZTsKCQl3aGlsZSAoIGVsZSApIHsKCQkJaWYgKCBkaWN0WyBlbGUubm9kZU5hbWUgXSApIHsKCQkJCXJldHVybiBlbGU7CgkJCX0KCQkJZWxlID0gZWxlWyBuZXh0UHJvcCBdOwoJCX0KCQlyZXR1cm4gbnVsbDsKCX0sCgkvLyBUT0RPOiBSZW1vdmUgaW4gMS41CglfYWRkVGh1bWJDbGFzc2VzOiBmdW5jdGlvbiggY29udGFpbmVycyApIHsKCQl2YXIgaSwgaW1nLCBsZW4gPSBjb250YWluZXJzLmxlbmd0aDsKCQlmb3IgKCBpID0gMDsgaSA8IGxlbjsgaSsrICkgewoJCQlpbWcgPSAkKCB0aGlzLl9maW5kRmlyc3RFbGVtZW50QnlUYWdOYW1lKCBjb250YWluZXJzWyBpIF0uZmlyc3RDaGlsZCwgIm5leHRTaWJsaW5nIiwgImltZyIsICJJTUciICkgKTsKCQkJaWYgKCBpbWcubGVuZ3RoICkgewoJCQkJJCggdGhpcy5fZmluZEZpcnN0RWxlbWVudEJ5VGFnTmFtZSggaW1nWyAwIF0ucGFyZW50Tm9kZSwgInBhcmVudE5vZGUiLCAibGkiLCAiTEkiICkgKS5hZGRDbGFzcyggaW1nLmhhc0NsYXNzKCAidWktbGktaWNvbiIgKSA/ICJ1aS1saS1oYXMtaWNvbiIgOiAidWktbGktaGFzLXRodW1iIiApOwoJCQl9CgkJfQoJfSwKCglfZ2V0Q2hpbGRyZW5CeVRhZ05hbWU6IGZ1bmN0aW9uKCBlbGUsIGxjTmFtZSwgdWNOYW1lICkgewoJCXZhciByZXN1bHRzID0gW10sCgkJCWRpY3QgPSB7fTsKCQlkaWN0WyBsY05hbWUgXSA9IGRpY3RbIHVjTmFtZSBdID0gdHJ1ZTsKCQllbGUgPSBlbGUuZmlyc3RDaGlsZDsKCQl3aGlsZSAoIGVsZSApIHsKCQkJaWYgKCBkaWN0WyBlbGUubm9kZU5hbWUgXSApIHsKCQkJCXJlc3VsdHMucHVzaCggZWxlICk7CgkJCX0KCQkJZWxlID0gZWxlLm5leHRTaWJsaW5nOwoJCX0KCQlyZXR1cm4gJCggcmVzdWx0cyApOwoJfSwKCglfYmVmb3JlTGlzdHZpZXdSZWZyZXNoOiAkLm5vb3AsCglfYWZ0ZXJMaXN0dmlld1JlZnJlc2g6ICQubm9vcCwKCglyZWZyZXNoOiBmdW5jdGlvbiggY3JlYXRlICkgewoJCXZhciBidXR0b25DbGFzcywgcG9zLCBudW1saSwgaXRlbSwgaXRlbUNsYXNzLCBpdGVtVGhlbWUsIGl0ZW1JY29uLCBpY29uLCBhLAoJCQlpc0RpdmlkZXIsIHN0YXJ0Q291bnQsIG5ld1N0YXJ0Q291bnQsIHZhbHVlLCBsYXN0LCBzcGxpdHRoZW1lLCBzcGxpdFRoZW1lQ2xhc3MsIHNwbGl0aWNvbiwKCQkJYWx0QnV0dG9uQ2xhc3MsIGRpdmlkZXJUaGVtZSwgbGksCgkJCW8gPSB0aGlzLm9wdGlvbnMsCgkJCSRsaXN0ID0gdGhpcy5lbGVtZW50LAoJCQlvbCA9ICEhJC5ub2RlTmFtZSggJGxpc3RbIDAgXSwgIm9sIiApLAoJCQlzdGFydCA9ICRsaXN0LmF0dHIoICJzdGFydCIgKSwKCQkJaXRlbUNsYXNzRGljdCA9IHt9LAoJCQljb3VudEJ1YmJsZXMgPSAkbGlzdC5maW5kKCAiLnVpLWxpLWNvdW50IiApLAoJCQljb3VudFRoZW1lID0gZ2V0QXR0ciggJGxpc3RbIDAgXSwgImNvdW50dGhlbWUiICkgfHwgdGhpcy5vcHRpb25zLmNvdW50VGhlbWUsCgkJCWNvdW50VGhlbWVDbGFzcyA9IGNvdW50VGhlbWUgPyAidWktYm9keS0iICsgY291bnRUaGVtZSA6ICJ1aS1ib2R5LWluaGVyaXQiOwoKCQlpZiAoIG8udGhlbWUgKSB7CgkJCSRsaXN0LmFkZENsYXNzKCAidWktZ3JvdXAtdGhlbWUtIiArIG8udGhlbWUgKTsKCQl9CgoJCS8vIENoZWNrIGlmIGEgc3RhcnQgYXR0cmlidXRlIGhhcyBiZWVuIHNldCB3aGlsZSB0YWtpbmcgYSB2YWx1ZSBvZiAwIGludG8gYWNjb3VudAoJCWlmICggb2wgJiYgKCBzdGFydCB8fCBzdGFydCA9PT0gMCApICkgewoJCQlzdGFydENvdW50ID0gcGFyc2VJbnQoIHN0YXJ0LCAxMCApIC0gMTsKCQkJJGxpc3QuY3NzKCAiY291bnRlci1yZXNldCIsICJsaXN0bnVtYmVyaW5nICIgKyBzdGFydENvdW50ICk7CgkJfQoKCQl0aGlzLl9iZWZvcmVMaXN0dmlld1JlZnJlc2goKTsKCgkJbGkgPSB0aGlzLl9nZXRDaGlsZHJlbkJ5VGFnTmFtZSggJGxpc3RbIDAgXSwgImxpIiwgIkxJIiApOwoKCQlmb3IgKCBwb3MgPSAwLCBudW1saSA9IGxpLmxlbmd0aDsgcG9zIDwgbnVtbGk7IHBvcysrICkgewoJCQlpdGVtID0gbGkuZXEoIHBvcyApOwoJCQlpdGVtQ2xhc3MgPSAiIjsKCgkJCWlmICggY3JlYXRlIHx8IGl0ZW1bIDAgXS5jbGFzc05hbWUuc2VhcmNoKCAvXGJ1aS1saS1zdGF0aWNcYnxcYnVpLWxpLWRpdmlkZXJcYi8gKSA8IDAgKSB7CgkJCQlhID0gdGhpcy5fZ2V0Q2hpbGRyZW5CeVRhZ05hbWUoIGl0ZW1bIDAgXSwgImEiLCAiQSIgKTsKCQkJCWlzRGl2aWRlciA9ICggZ2V0QXR0ciggaXRlbVsgMCBdLCAicm9sZSIgKSA9PT0gImxpc3QtZGl2aWRlciIgKTsKCQkJCXZhbHVlID0gaXRlbS5hdHRyKCAidmFsdWUiICk7CgkJCQlpdGVtVGhlbWUgPSBnZXRBdHRyKCBpdGVtWyAwIF0sICJ0aGVtZSIgKTsKCgkJCQlpZiAoIGEubGVuZ3RoICYmIGFbIDAgXS5jbGFzc05hbWUuc2VhcmNoKCAvXGJ1aS1idG5cYi8gKSA8IDAgJiYgIWlzRGl2aWRlciApIHsKCQkJCQlpdGVtSWNvbiA9IGdldEF0dHIoIGl0ZW1bIDAgXSwgImljb24iICk7CgkJCQkJaWNvbiA9ICggaXRlbUljb24gPT09IGZhbHNlICkgPyBmYWxzZSA6ICggaXRlbUljb24gfHwgby5pY29uICk7CgoJCQkJCS8vIFRPRE86IFJlbW92ZSBpbiAxLjUgdG9nZXRoZXIgd2l0aCBsaW5rcy5qcyAobGlua3MuanMgLyAudWktbGluayBkZXByZWNhdGVkIGluIDEuNCkKCQkJCQlhLnJlbW92ZUNsYXNzKCAidWktbGluayIgKTsKCgkJCQkJYnV0dG9uQ2xhc3MgPSAidWktYnRuIjsKCgkJCQkJaWYgKCBpdGVtVGhlbWUgKSB7CgkJCQkJCWJ1dHRvbkNsYXNzICs9ICIgdWktYnRuLSIgKyBpdGVtVGhlbWU7CgkJCQkJfQoKCQkJCQlpZiAoIGEubGVuZ3RoID4gMSApIHsKCQkJCQkJaXRlbUNsYXNzID0gInVpLWxpLWhhcy1hbHQiOwoKCQkJCQkJbGFzdCA9IGEubGFzdCgpOwoJCQkJCQlzcGxpdHRoZW1lID0gZ2V0QXR0ciggbGFzdFsgMCBdLCAidGhlbWUiICkgfHwgby5zcGxpdFRoZW1lIHx8IGdldEF0dHIoIGl0ZW1bIDAgXSwgInRoZW1lIiwgdHJ1ZSApOwoJCQkJCQlzcGxpdFRoZW1lQ2xhc3MgPSBzcGxpdHRoZW1lID8gIiB1aS1idG4tIiArIHNwbGl0dGhlbWUgOiAiIjsKCQkJCQkJc3BsaXRpY29uID0gZ2V0QXR0ciggbGFzdFsgMCBdLCAiaWNvbiIgKSB8fCBnZXRBdHRyKCBpdGVtWyAwIF0sICJpY29uIiApIHx8IG8uc3BsaXRJY29uOwoJCQkJCQlhbHRCdXR0b25DbGFzcyA9ICJ1aS1idG4gdWktYnRuLWljb24tbm90ZXh0IHVpLWljb24tIiArIHNwbGl0aWNvbiArIHNwbGl0VGhlbWVDbGFzczsKCgkJCQkJCWxhc3QKCQkJCQkJCS5hdHRyKCAidGl0bGUiLCAkLnRyaW0oIGxhc3QuZ2V0RW5jb2RlZFRleHQoKSApICkKCQkJCQkJCS5hZGRDbGFzcyggYWx0QnV0dG9uQ2xhc3MgKQoJCQkJCQkJLmVtcHR5KCk7CgkJCQkJfSBlbHNlIGlmICggaWNvbiApIHsKCQkJCQkJYnV0dG9uQ2xhc3MgKz0gIiB1aS1idG4taWNvbi1yaWdodCB1aS1pY29uLSIgKyBpY29uOwoJCQkJCX0KCgkJCQkJYS5maXJzdCgpLmFkZENsYXNzKCBidXR0b25DbGFzcyApOwoJCQkJfSBlbHNlIGlmICggaXNEaXZpZGVyICkgewoJCQkJCWRpdmlkZXJUaGVtZSA9ICggZ2V0QXR0ciggaXRlbVsgMCBdLCAidGhlbWUiICkgfHwgby5kaXZpZGVyVGhlbWUgfHwgby50aGVtZSApOwoKCQkJCQlpdGVtQ2xhc3MgPSAidWktbGktZGl2aWRlciB1aS1iYXItIiArICggZGl2aWRlclRoZW1lID8gZGl2aWRlclRoZW1lIDogImluaGVyaXQiICk7CgoJCQkJCWl0ZW0uYXR0ciggInJvbGUiLCAiaGVhZGluZyIgKTsKCQkJCX0gZWxzZSBpZiAoIGEubGVuZ3RoIDw9IDAgKSB7CgkJCQkJaXRlbUNsYXNzID0gInVpLWxpLXN0YXRpYyB1aS1ib2R5LSIgKyAoIGl0ZW1UaGVtZSA/IGl0ZW1UaGVtZSA6ICJpbmhlcml0IiApOwoJCQkJfQoJCQkJaWYgKCBvbCAmJiB2YWx1ZSApIHsKCQkJCQluZXdTdGFydENvdW50ID0gcGFyc2VJbnQoIHZhbHVlICwgMTAgKSAtIDE7CgoJCQkJCWl0ZW0uY3NzKCAiY291bnRlci1yZXNldCIsICJsaXN0bnVtYmVyaW5nICIgKyBuZXdTdGFydENvdW50ICk7CgkJCQl9CgkJCX0KCgkJCS8vIEluc3RlYWQgb2Ygc2V0dGluZyBpdGVtIGNsYXNzIGRpcmVjdGx5IG9uIHRoZSBsaXN0IGl0ZW0KCQkJLy8gYXQgdGhpcyBwb2ludCBpbiB0aW1lLCBwdXNoIHRoZSBpdGVtIGludG8gYSBkaWN0aW9uYXJ5CgkJCS8vIHRoYXQgdGVsbHMgdXMgd2hhdCBjbGFzcyB0byBzZXQgb24gaXQgc28gd2UgY2FuIGRvIHRoaXMgYWZ0ZXIgdGhpcwoJCQkvLyBwcm9jZXNzaW5nIGxvb3AgaXMgZmluaXNoZWQuCgoJCQlpZiAoICFpdGVtQ2xhc3NEaWN0WyBpdGVtQ2xhc3MgXSApIHsKCQkJCWl0ZW1DbGFzc0RpY3RbIGl0ZW1DbGFzcyBdID0gW107CgkJCX0KCgkJCWl0ZW1DbGFzc0RpY3RbIGl0ZW1DbGFzcyBdLnB1c2goIGl0ZW1bIDAgXSApOwoJCX0KCgkJLy8gU2V0IHRoZSBhcHByb3ByaWF0ZSBsaXN0dmlldyBpdGVtIGNsYXNzZXMgb24gZWFjaCBsaXN0IGl0ZW0uCgkJLy8gVGhlIG1haW4gcmVhc29uIHdlIGRpZG4ndCBkbyB0aGlzCgkJLy8gaW4gdGhlIGZvci1sb29wIGFib3ZlIGlzIGJlY2F1c2Ugd2UgY2FuIGVsaW1pbmF0ZSBwZXItaXRlbSBmdW5jdGlvbiBvdmVyaGVhZAoJCS8vIGJ5IGNhbGxpbmcgYWRkQ2xhc3MoKSBhbmQgY2hpbGRyZW4oKSBvbmNlIG9yIHR3aWNlIGFmdGVyd2FyZHMuIFRoaXMKCQkvLyBjYW4gZ2l2ZSB1cyBhIHNpZ25pZmljYW50IGJvb3N0IG9uIHBsYXRmb3JtcyBsaWtlIFdQNy41LgoKCQlmb3IgKCBpdGVtQ2xhc3MgaW4gaXRlbUNsYXNzRGljdCApIHsKCQkJJCggaXRlbUNsYXNzRGljdFsgaXRlbUNsYXNzIF0gKS5hZGRDbGFzcyggaXRlbUNsYXNzICk7CgkJfQoKCQljb3VudEJ1YmJsZXMuZWFjaCggZnVuY3Rpb24oKSB7CgkJCSQoIHRoaXMgKS5jbG9zZXN0KCAibGkiICkuYWRkQ2xhc3MoICJ1aS1saS1oYXMtY291bnQiICk7CgkJfSk7CgkJaWYgKCBjb3VudFRoZW1lQ2xhc3MgKSB7CgkJCWNvdW50QnViYmxlcy5hZGRDbGFzcyggY291bnRUaGVtZUNsYXNzICk7CgkJfQoKCQkvLyBEZXByZWNhdGVkIGluIDEuNC4gRnJvbSAxLjUgeW91IGhhdmUgdG8gYWRkIGNsYXNzIHVpLWxpLWhhcy10aHVtYiBvciB1aS1saS1oYXMtaWNvbiB0byB0aGUgTEkuCgkJdGhpcy5fYWRkVGh1bWJDbGFzc2VzKCBsaSApOwoJCXRoaXMuX2FkZFRodW1iQ2xhc3NlcyggbGkuZmluZCggIi51aS1idG4iICkgKTsKCgkJdGhpcy5fYWZ0ZXJMaXN0dmlld1JlZnJlc2goKTsKCgkJdGhpcy5fYWRkRmlyc3RMYXN0Q2xhc3NlcyggbGksIHRoaXMuX2dldFZpc2libGVzKCBsaSwgY3JlYXRlICksIGNyZWF0ZSApOwoJfQp9LCAkLm1vYmlsZS5iZWhhdmlvcnMuYWRkRmlyc3RMYXN0Q2xhc3NlcyApICk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCi8vIFRPRE8gcmVuYW1lIGZpbHRlckNhbGxiYWNrL2RlcHJlY2F0ZSBhbmQgZGVmYXVsdCB0byB0aGUgaXRlbSBpdHNlbGYgYXMgdGhlIGZpcnN0IGFyZ3VtZW50CnZhciBkZWZhdWx0RmlsdGVyQ2FsbGJhY2sgPSBmdW5jdGlvbiggaW5kZXgsIHNlYXJjaFZhbHVlICkgewoJcmV0dXJuICggKCAiIiArICggJC5tb2JpbGUuZ2V0QXR0cmlidXRlKCB0aGlzLCAiZmlsdGVydGV4dCIgKSB8fCAkKCB0aGlzICkudGV4dCgpICkgKQoJCS50b0xvd2VyQ2FzZSgpLmluZGV4T2YoIHNlYXJjaFZhbHVlICkgPT09IC0xICk7Cn07CgokLndpZGdldCggIm1vYmlsZS5maWx0ZXJhYmxlIiwgewoKCWluaXRTZWxlY3RvcjogIjpqcW1EYXRhKGZpbHRlcj0ndHJ1ZScpIiwKCglvcHRpb25zOiB7CgkJZmlsdGVyUmV2ZWFsOiBmYWxzZSwKCQlmaWx0ZXJDYWxsYmFjazogZGVmYXVsdEZpbHRlckNhbGxiYWNrLAoJCWVuaGFuY2VkOiBmYWxzZSwKCQlpbnB1dDogbnVsbCwKCQljaGlsZHJlbjogIj4gbGksID4gb3B0aW9uLCA+IG9wdGdyb3VwIG9wdGlvbiwgPiB0Ym9keSB0ciwgPiAudWktY29udHJvbGdyb3VwLWNvbnRyb2xzID4gLnVpLWJ0biwgPiAudWktY29udHJvbGdyb3VwLWNvbnRyb2xzID4gLnVpLWNoZWNrYm94LCA+IC51aS1jb250cm9sZ3JvdXAtY29udHJvbHMgPiAudWktcmFkaW8iCgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXZhciBvcHRzID0gdGhpcy5vcHRpb25zOwoKCQkkLmV4dGVuZCggdGhpcywgewoJCQlfc2VhcmNoOiBudWxsLAoJCQlfdGltZXI6IDAKCQl9KTsKCgkJdGhpcy5fc2V0SW5wdXQoIG9wdHMuaW5wdXQgKTsKCQlpZiAoICFvcHRzLmVuaGFuY2VkICkgewoJCQl0aGlzLl9maWx0ZXJJdGVtcyggKCAoIHRoaXMuX3NlYXJjaCAmJiB0aGlzLl9zZWFyY2gudmFsKCkgKSB8fCAiIiApLnRvTG93ZXJDYXNlKCkgKTsKCQl9Cgl9LAoKCV9vbktleVVwOiBmdW5jdGlvbigpIHsKCQl2YXIgdmFsLCBsYXN0dmFsLAoJCQlzZWFyY2ggPSB0aGlzLl9zZWFyY2g7CgoJCWlmICggc2VhcmNoICkgewoJCQl2YWwgPSBzZWFyY2gudmFsKCkudG9Mb3dlckNhc2UoKSwKCQkJbGFzdHZhbCA9ICQubW9iaWxlLmdldEF0dHJpYnV0ZSggc2VhcmNoWyAwIF0sICJsYXN0dmFsIiApICsgIiI7CgoJCQlpZiAoIGxhc3R2YWwgJiYgbGFzdHZhbCA9PT0gdmFsICkgewoJCQkJLy8gRXhlY3V0ZSB0aGUgaGFuZGxlciBvbmx5IG9uY2UgcGVyIHZhbHVlIGNoYW5nZQoJCQkJcmV0dXJuOwoJCQl9CgoJCQlpZiAoIHRoaXMuX3RpbWVyICkgewoJCQkJd2luZG93LmNsZWFyVGltZW91dCggdGhpcy5fdGltZXIgKTsKCQkJCXRoaXMuX3RpbWVyID0gMDsKCQkJfQoKCQkJdGhpcy5fdGltZXIgPSB0aGlzLl9kZWxheSggZnVuY3Rpb24oKSB7CgkJCQl0aGlzLl90cmlnZ2VyKCAiYmVmb3JlZmlsdGVyIiwgImJlZm9yZWZpbHRlciIsIHsgaW5wdXQ6IHNlYXJjaCB9ICk7CgoJCQkJLy8gQ2hhbmdlIHZhbCBhcyBsYXN0dmFsIGZvciBuZXh0IGV4ZWN1dGlvbgoJCQkJc2VhcmNoWyAwIF0uc2V0QXR0cmlidXRlKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAibGFzdHZhbCIsIHZhbCApOwoKCQkJCXRoaXMuX2ZpbHRlckl0ZW1zKCB2YWwgKTsKCQkJCXRoaXMuX3RpbWVyID0gMDsKCQkJfSwgMjUwICk7CgkJfQoJfSwKCglfZ2V0RmlsdGVyYWJsZUl0ZW1zOiBmdW5jdGlvbigpIHsKCQl2YXIgZWxlbSA9IHRoaXMuZWxlbWVudCwKCQkJY2hpbGRyZW4gPSB0aGlzLm9wdGlvbnMuY2hpbGRyZW4sCgkJCWl0ZW1zID0gIWNoaWxkcmVuID8geyBsZW5ndGg6IDAgfToKCQkJCSQuaXNGdW5jdGlvbiggY2hpbGRyZW4gKSA/IGNoaWxkcmVuKCk6CgkJCQljaGlsZHJlbi5ub2RlTmFtZSA/ICQoIGNoaWxkcmVuICk6CgkJCQljaGlsZHJlbi5qcXVlcnkgPyBjaGlsZHJlbjoKCQkJCXRoaXMuZWxlbWVudC5maW5kKCBjaGlsZHJlbiApOwoKCQlpZiAoIGl0ZW1zLmxlbmd0aCA9PT0gMCApIHsKCQkJaXRlbXMgPSBlbGVtLmNoaWxkcmVuKCk7CgkJfQoKCQlyZXR1cm4gaXRlbXM7Cgl9LAoKCV9maWx0ZXJJdGVtczogZnVuY3Rpb24oIHZhbCApIHsKCQl2YXIgaWR4LCBjYWxsYmFjaywgbGVuZ3RoLCBkc3QsCgkJCXNob3cgPSBbXSwKCQkJaGlkZSA9IFtdLAoJCQlvcHRzID0gdGhpcy5vcHRpb25zLAoJCQlmaWx0ZXJJdGVtcyA9IHRoaXMuX2dldEZpbHRlcmFibGVJdGVtcygpOwoKCQlpZiAoIHZhbCAhPSBudWxsICkgewoJCQljYWxsYmFjayA9IG9wdHMuZmlsdGVyQ2FsbGJhY2sgfHwgZGVmYXVsdEZpbHRlckNhbGxiYWNrOwoJCQlsZW5ndGggPSBmaWx0ZXJJdGVtcy5sZW5ndGg7CgoJCQkvLyBQYXJ0aXRpb24gdGhlIGl0ZW1zIGludG8gdGhvc2UgdG8gYmUgaGlkZGVuIGFuZCB0aG9zZSB0byBiZSBzaG93bgoJCQlmb3IgKCBpZHggPSAwIDsgaWR4IDwgbGVuZ3RoIDsgaWR4KysgKSB7CgkJCQlkc3QgPSAoIGNhbGxiYWNrLmNhbGwoIGZpbHRlckl0ZW1zWyBpZHggXSwgaWR4LCB2YWwgKSApID8gaGlkZSA6IHNob3c7CgkJCQlkc3QucHVzaCggZmlsdGVySXRlbXNbIGlkeCBdICk7CgkJCX0KCQl9CgoJCS8vIElmIG5vdGhpbmcgaXMgaGlkZGVuLCB0aGVuIHRoZSBkZWNpc2lvbiB3aGV0aGVyIHRvIGhpZGUgb3Igc2hvdyB0aGUgaXRlbXMKCQkvLyBpcyBiYXNlZCBvbiB0aGUgImZpbHRlclJldmVhbCIgb3B0aW9uLgoJCWlmICggaGlkZS5sZW5ndGggPT09IDAgKSB7CgkJCWZpbHRlckl0ZW1zWyBvcHRzLmZpbHRlclJldmVhbCA/ICJhZGRDbGFzcyIgOiAicmVtb3ZlQ2xhc3MiIF0oICJ1aS1zY3JlZW4taGlkZGVuIiApOwoJCX0gZWxzZSB7CgkJCSQoIGhpZGUgKS5hZGRDbGFzcyggInVpLXNjcmVlbi1oaWRkZW4iICk7CgkJCSQoIHNob3cgKS5yZW1vdmVDbGFzcyggInVpLXNjcmVlbi1oaWRkZW4iICk7CgkJfQoKCQl0aGlzLl9yZWZyZXNoQ2hpbGRXaWRnZXQoKTsKCX0sCgoJLy8gVGhlIERlZmF1bHQgaW1wbGVtZW50YXRpb24gb2YgX3JlZnJlc2hDaGlsZFdpZGdldCBhdHRlbXB0cyB0byBjYWxsCgkvLyByZWZyZXNoIG9uIGNvbGxhcHNpYmxlc2V0LCBjb250cm9sZ3JvdXAsIHNlbGVjdG1lbnUsIG9yIGxpc3R2aWV3CglfcmVmcmVzaENoaWxkV2lkZ2V0OiBmdW5jdGlvbigpIHsKCQl2YXIgd2lkZ2V0LCBpZHgsCgkJCXJlY29nbml6ZWRXaWRnZXRzID0gWyAiY29sbGFwc2libGVzZXQiLCAic2VsZWN0bWVudSIsICJjb250cm9sZ3JvdXAiLCAibGlzdHZpZXciIF07CgoJCWZvciAoIGlkeCA9IHJlY29nbml6ZWRXaWRnZXRzLmxlbmd0aCAtIDEgOyBpZHggPiAtMSA7IGlkeC0tICkgewoJCQl3aWRnZXQgPSByZWNvZ25pemVkV2lkZ2V0c1sgaWR4IF07CgkJCWlmICggJC5tb2JpbGVbIHdpZGdldCBdICkgewoJCQkJd2lkZ2V0ID0gdGhpcy5lbGVtZW50LmRhdGEoICJtb2JpbGUtIiArIHdpZGdldCApOwoJCQkJaWYgKCB3aWRnZXQgJiYgJC5pc0Z1bmN0aW9uKCB3aWRnZXQucmVmcmVzaCApICkgewoJCQkJCXdpZGdldC5yZWZyZXNoKCk7CgkJCQl9CgkJCX0KCQl9Cgl9LAoKCS8vIFRPRE86IFdoZW4gdGhlIGlucHV0IGlzIG5vdCBpbnRlcm5hbCwgZG8gbm90IGV2ZW4gc3RvcmUgaXQgaW4gdGhpcy5fc2VhcmNoCglfc2V0SW5wdXQ6IGZ1bmN0aW9uICggc2VsZWN0b3IgKSB7CgkJdmFyIHNlYXJjaCA9IHRoaXMuX3NlYXJjaDsKCgkJLy8gU3RvcCBhIHBlbmRpbmcgZmlsdGVyIG9wZXJhdGlvbgoJCWlmICggdGhpcy5fdGltZXIgKSB7CgkJCXdpbmRvdy5jbGVhclRpbWVvdXQoIHRoaXMuX3RpbWVyICk7CgkJCXRoaXMuX3RpbWVyID0gMDsKCQl9CgoJCWlmICggc2VhcmNoICkgewoJCQl0aGlzLl9vZmYoIHNlYXJjaCwgImtleXVwIGNoYW5nZSBpbnB1dCIgKTsKCQkJc2VhcmNoID0gbnVsbDsKCQl9CgoJCWlmICggc2VsZWN0b3IgKSB7CgkJCXNlYXJjaCA9IHNlbGVjdG9yLmpxdWVyeSA/IHNlbGVjdG9yOgoJCQkJc2VsZWN0b3Iubm9kZU5hbWUgPyAkKCBzZWxlY3RvciApOgoJCQkJdGhpcy5kb2N1bWVudC5maW5kKCBzZWxlY3RvciApOwoKCQkJdGhpcy5fb24oIHNlYXJjaCwgewoJCQkJa2V5dXA6ICJfb25LZXlVcCIsCgkJCQljaGFuZ2U6ICJfb25LZXlVcCIsCgkJCQlpbnB1dDogIl9vbktleVVwIgoJCQl9KTsKCQl9CgoJCXRoaXMuX3NlYXJjaCA9IHNlYXJjaDsKCX0sCgoJX3NldE9wdGlvbnM6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCXZhciByZWZpbHRlciA9ICEoICggb3B0aW9ucy5maWx0ZXJSZXZlYWwgPT09IHVuZGVmaW5lZCApICYmCgkJCQkoIG9wdGlvbnMuZmlsdGVyQ2FsbGJhY2sgPT09IHVuZGVmaW5lZCApICYmCgkJCQkoIG9wdGlvbnMuY2hpbGRyZW4gPT09IHVuZGVmaW5lZCApICk7CgoJCXRoaXMuX3N1cGVyKCBvcHRpb25zICk7CgoJCWlmICggb3B0aW9ucy5pbnB1dCAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLl9zZXRJbnB1dCggb3B0aW9ucy5pbnB1dCApOwoJCQlyZWZpbHRlciA9IHRydWU7CgkJfQoKCQlpZiAoIHJlZmlsdGVyICkgewoJCQl0aGlzLnJlZnJlc2goKTsKCQl9Cgl9LAoKCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCQl2YXIgb3B0cyA9IHRoaXMub3B0aW9ucywKCQkJaXRlbXMgPSB0aGlzLl9nZXRGaWx0ZXJhYmxlSXRlbXMoKTsKCgkJaWYgKCBvcHRzLmVuaGFuY2VkICkgewoJCQlpdGVtcy50b2dnbGVDbGFzcyggInVpLXNjcmVlbi1oaWRkZW4iLCBvcHRzLmZpbHRlclJldmVhbCApOwoJCX0gZWxzZSB7CgkJCWl0ZW1zLnJlbW92ZUNsYXNzKCAidWktc2NyZWVuLWhpZGRlbiIgKTsKCQl9Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCWlmICggdGhpcy5fdGltZXIgKSB7CgkJCXdpbmRvdy5jbGVhclRpbWVvdXQoIHRoaXMuX3RpbWVyICk7CgkJCXRoaXMuX3RpbWVyID0gMDsKCQl9CgkJdGhpcy5fZmlsdGVySXRlbXMoICggKCB0aGlzLl9zZWFyY2ggJiYgdGhpcy5fc2VhcmNoLnZhbCgpICkgfHwgIiIgKS50b0xvd2VyQ2FzZSgpICk7Cgl9Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgovLyBDcmVhdGUgYSBmdW5jdGlvbiB0aGF0IHdpbGwgcmVwbGFjZSB0aGUgX3NldE9wdGlvbnMgZnVuY3Rpb24gb2YgYSB3aWRnZXQsCi8vIGFuZCB3aWxsIHBhc3MgdGhlIG9wdGlvbnMgb24gdG8gdGhlIGlucHV0IG9mIHRoZSBmaWx0ZXJhYmxlLgp2YXIgcmVwbGFjZVNldE9wdGlvbnMgPSBmdW5jdGlvbiggc2VsZiwgb3JpZyApIHsKCQlyZXR1cm4gZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJCW9yaWcuY2FsbCggdGhpcywgb3B0aW9ucyApOwoJCQlzZWxmLl9zeW5jVGV4dElucHV0T3B0aW9ucyggb3B0aW9ucyApOwoJCX07Cgl9LAoJckRpdmlkZXJMaXN0SXRlbSA9IC8oXnxccyl1aS1saS1kaXZpZGVyKFxzfCQpLywKCW9yaWdEZWZhdWx0RmlsdGVyQ2FsbGJhY2sgPSAkLm1vYmlsZS5maWx0ZXJhYmxlLnByb3RvdHlwZS5vcHRpb25zLmZpbHRlckNhbGxiYWNrOwoKLy8gT3ZlcnJpZGUgdGhlIGRlZmF1bHQgZmlsdGVyIGNhbGxiYWNrIHdpdGggb25lIHRoYXQgZG9lcyBub3QgaGlkZSBsaXN0IGRpdmlkZXJzCiQubW9iaWxlLmZpbHRlcmFibGUucHJvdG90eXBlLm9wdGlvbnMuZmlsdGVyQ2FsbGJhY2sgPSBmdW5jdGlvbiggaW5kZXgsIHNlYXJjaFZhbHVlICkgewoJcmV0dXJuICF0aGlzLmNsYXNzTmFtZS5tYXRjaCggckRpdmlkZXJMaXN0SXRlbSApICYmCgkJb3JpZ0RlZmF1bHRGaWx0ZXJDYWxsYmFjay5jYWxsKCB0aGlzLCBpbmRleCwgc2VhcmNoVmFsdWUgKTsKfTsKCiQud2lkZ2V0KCAibW9iaWxlLmZpbHRlcmFibGUiLCAkLm1vYmlsZS5maWx0ZXJhYmxlLCB7CglvcHRpb25zOiB7CgkJZmlsdGVyUGxhY2Vob2xkZXI6ICJGaWx0ZXIgaXRlbXMuLi4iLAoJCWZpbHRlclRoZW1lOiBudWxsCgl9LAoKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl2YXIgaWR4LCB3aWRnZXROYW1lLAoJCQllbGVtID0gdGhpcy5lbGVtZW50LAoJCQlyZWNvZ25pemVkV2lkZ2V0cyA9IFsgImNvbGxhcHNpYmxlc2V0IiwgInNlbGVjdG1lbnUiLCAiY29udHJvbGdyb3VwIiwgImxpc3R2aWV3IiBdLAoJCQljcmVhdGVIYW5kbGVycyA9IHt9OwoKCQl0aGlzLl9zdXBlcigpOwoKCQkkLmV4dGVuZCggdGhpcywgewoJCQlfd2lkZ2V0OiBudWxsCgkJfSk7CgoJCWZvciAoIGlkeCA9IHJlY29nbml6ZWRXaWRnZXRzLmxlbmd0aCAtIDEgOyBpZHggPiAtMSA7IGlkeC0tICkgewoJCQl3aWRnZXROYW1lID0gcmVjb2duaXplZFdpZGdldHNbIGlkeCBdOwoJCQlpZiAoICQubW9iaWxlWyB3aWRnZXROYW1lIF0gKSB7CgkJCQlpZiAoIHRoaXMuX3NldFdpZGdldCggZWxlbS5kYXRhKCAibW9iaWxlLSIgKyB3aWRnZXROYW1lICkgKSApIHsKCQkJCQlicmVhazsKCQkJCX0gZWxzZSB7CgkJCQkJY3JlYXRlSGFuZGxlcnNbIHdpZGdldE5hbWUgKyAiY3JlYXRlIiBdID0gIl9oYW5kbGVDcmVhdGUiOwoJCQkJfQoJCQl9CgkJfQoKCQlpZiAoICF0aGlzLl93aWRnZXQgKSB7CgkJCXRoaXMuX29uKCBlbGVtLCBjcmVhdGVIYW5kbGVycyApOwoJCX0KCX0sCgoJX2hhbmRsZUNyZWF0ZTogZnVuY3Rpb24oIGV2dCApIHsKCQl0aGlzLl9zZXRXaWRnZXQoIHRoaXMuZWxlbWVudC5kYXRhKCAibW9iaWxlLSIgKyBldnQudHlwZS5zdWJzdHJpbmcoIDAsIGV2dC50eXBlLmxlbmd0aCAtIDYgKSApICk7Cgl9LAoKCV9zZXRXaWRnZXQ6IGZ1bmN0aW9uKCB3aWRnZXQgKSB7CgkJaWYgKCAhdGhpcy5fd2lkZ2V0ICYmIHdpZGdldCApIHsKCQkJdGhpcy5fd2lkZ2V0ID0gd2lkZ2V0OwoJCQl0aGlzLl93aWRnZXQuX3NldE9wdGlvbnMgPSByZXBsYWNlU2V0T3B0aW9ucyggdGhpcywgdGhpcy5fd2lkZ2V0Ll9zZXRPcHRpb25zICk7CgkJfQoKCQlpZiAoICEhdGhpcy5fd2lkZ2V0ICkgewoJCQl0aGlzLl9zeW5jVGV4dElucHV0T3B0aW9ucyggdGhpcy5fd2lkZ2V0Lm9wdGlvbnMgKTsKCQkJaWYgKCB0aGlzLl93aWRnZXQud2lkZ2V0TmFtZSA9PT0gImxpc3R2aWV3IiApIHsKCQkJCXRoaXMuX3dpZGdldC5vcHRpb25zLmhpZGVkaXZpZGVycyA9IHRydWU7CgkJCQl0aGlzLl93aWRnZXQuZWxlbWVudC5saXN0dmlldyggInJlZnJlc2giICk7CgkJCX0KCQl9CgoJCXJldHVybiAhIXRoaXMuX3dpZGdldDsKCX0sCgoJX2lzU2VhcmNoSW50ZXJuYWw6IGZ1bmN0aW9uKCkgewoJCXJldHVybiAoIHRoaXMuX3NlYXJjaCAmJiB0aGlzLl9zZWFyY2guanFtRGF0YSggInVpLWZpbHRlcmFibGUtIiArIHRoaXMudXVpZCArICItaW50ZXJuYWwiICkgKTsKCX0sCgoJX3NldElucHV0OiBmdW5jdGlvbiggc2VsZWN0b3IgKSB7CgkJdmFyIG9wdHMgPSB0aGlzLm9wdGlvbnMsCgkJCXVwZGF0ZVBsYWNlaG9sZGVyID0gdHJ1ZSwKCQkJdGV4dGlucHV0T3B0cyA9IHt9OwoKCQlpZiAoICFzZWxlY3RvciApIHsKCQkJaWYgKCB0aGlzLl9pc1NlYXJjaEludGVybmFsKCkgKSB7CgoJCQkJLy8gSWdub3JlIHRoZSBjYWxsIHRvIHNldCBhIG5ldyBpbnB1dCBpZiB0aGUgc2VsZWN0b3IgZ29lcyB0byBmYWxzeSBhbmQKCQkJCS8vIHRoZSBjdXJyZW50IHRleHRpbnB1dCBpcyBhbHJlYWR5IG9mIHRoZSBpbnRlcm5hbGx5IGdlbmVyYXRlZCB2YXJpZXR5LgoJCQkJcmV0dXJuOwoJCQl9IGVsc2UgewoKCQkJCS8vIEdlbmVyYXRpbmcgYSBuZXcgdGV4dGlucHV0IHdpZGdldC4gTm8gbmVlZCB0byBzZXQgdGhlIHBsYWNlaG9sZGVyCgkJCQkvLyBmdXJ0aGVyIGRvd24gdGhlIGZ1bmN0aW9uLgoJCQkJdXBkYXRlUGxhY2Vob2xkZXIgPSBmYWxzZTsKCQkJCXNlbGVjdG9yID0gJCggIjxpbnB1dCAiICsKCQkJCQkiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidHlwZT0nc2VhcmNoJyAiICsKCQkJCQkicGxhY2Vob2xkZXI9JyIgKyBvcHRzLmZpbHRlclBsYWNlaG9sZGVyICsgIic+PC9pbnB1dD4iICkKCQkJCQkuanFtRGF0YSggInVpLWZpbHRlcmFibGUtIiArIHRoaXMudXVpZCArICItaW50ZXJuYWwiLCB0cnVlICk7CgkJCQkkKCAiPGZvcm0gY2xhc3M9J3VpLWZpbHRlcmFibGUnPjwvZm9ybT4iICkKCQkJCQkuYXBwZW5kKCBzZWxlY3RvciApCgkJCQkJLnN1Ym1pdCggZnVuY3Rpb24oIGV2dCApIHsKCQkJCQkJZXZ0LnByZXZlbnREZWZhdWx0KCk7CgkJCQkJCXNlbGVjdG9yLmJsdXIoKTsKCQkJCQl9KQoJCQkJCS5pbnNlcnRCZWZvcmUoIHRoaXMuZWxlbWVudCApOwoJCQkJaWYgKCAkLm1vYmlsZS50ZXh0aW5wdXQgKSB7CgkJCQkJaWYgKCB0aGlzLm9wdGlvbnMuZmlsdGVyVGhlbWUgIT0gbnVsbCApIHsKCQkJCQkJdGV4dGlucHV0T3B0c1sgInRoZW1lIiBdID0gb3B0cy5maWx0ZXJUaGVtZTsKCQkJCQl9CgoJCQkJCXNlbGVjdG9yLnRleHRpbnB1dCggdGV4dGlucHV0T3B0cyApOwoJCQkJfQoJCQl9CgkJfQoKCQl0aGlzLl9zdXBlciggc2VsZWN0b3IgKTsKCgkJaWYgKCB0aGlzLl9pc1NlYXJjaEludGVybmFsKCkgJiYgdXBkYXRlUGxhY2Vob2xkZXIgKSB7CgkJCXRoaXMuX3NlYXJjaC5hdHRyKCAicGxhY2Vob2xkZXIiLCB0aGlzLm9wdGlvbnMuZmlsdGVyUGxhY2Vob2xkZXIgKTsKCQl9Cgl9LAoKCV9zZXRPcHRpb25zOiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQl2YXIgcmV0ID0gdGhpcy5fc3VwZXIoIG9wdGlvbnMgKTsKCgkJLy8gTmVlZCB0byBzZXQgdGhlIGZpbHRlclBsYWNlaG9sZGVyIGFmdGVyIGhhdmluZyBlc3RhYmxpc2hlZCB0aGUgc2VhcmNoIGlucHV0CgkJaWYgKCBvcHRpb25zLmZpbHRlclBsYWNlaG9sZGVyICE9PSB1bmRlZmluZWQgKSB7CgkJCWlmICggdGhpcy5faXNTZWFyY2hJbnRlcm5hbCgpICkgewoJCQkJdGhpcy5fc2VhcmNoLmF0dHIoICJwbGFjZWhvbGRlciIsIG9wdGlvbnMuZmlsdGVyUGxhY2Vob2xkZXIgKTsKCQkJfQoJCX0KCgkJaWYgKCBvcHRpb25zLmZpbHRlclRoZW1lICE9PSB1bmRlZmluZWQgJiYgdGhpcy5fc2VhcmNoICYmICQubW9iaWxlLnRleHRpbnB1dCApIHsKCQkJdGhpcy5fc2VhcmNoLnRleHRpbnB1dCggIm9wdGlvbiIsICJ0aGVtZSIsIG9wdGlvbnMuZmlsdGVyVGhlbWUgKTsKCQl9CgoJCXJldHVybiByZXQ7Cgl9LAoKCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCQlpZiAoIHRoaXMuX2lzU2VhcmNoSW50ZXJuYWwoKSApIHsKCQkJdGhpcy5fc2VhcmNoLnJlbW92ZSgpOwoJCX0KCQl0aGlzLl9zdXBlcigpOwoJfSwKCglfc3luY1RleHRJbnB1dE9wdGlvbnM6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCXZhciBpZHgsCgkJCXRleHRpbnB1dE9wdGlvbnMgPSB7fTsKCgkJLy8gV2Ugb25seSBzeW5jIG9wdGlvbnMgaWYgdGhlIGZpbHRlcmFibGUncyB0ZXh0aW5wdXQgaXMgb2YgdGhlIGludGVybmFsbHkKCQkvLyBnZW5lcmF0ZWQgdmFyaWV0eSwgcmF0aGVyIHRoYW4gb25lIHNwZWNpZmllZCBieSB0aGUgdXNlci4KCQlpZiAoIHRoaXMuX2lzU2VhcmNoSW50ZXJuYWwoKSAmJiAkLm1vYmlsZS50ZXh0aW5wdXQgKSB7CgoJCQkvLyBBcHBseSBvbmx5IHRoZSBvcHRpb25zIHVuZGVyc3Rvb2QgYnkgdGV4dGlucHV0CgkJCWZvciAoIGlkeCBpbiAkLm1vYmlsZS50ZXh0aW5wdXQucHJvdG90eXBlLm9wdGlvbnMgKSB7CgkJCQlpZiAoIG9wdGlvbnNbIGlkeCBdICE9PSB1bmRlZmluZWQgKSB7CgkJCQkJaWYgKCBpZHggPT09ICJ0aGVtZSIgJiYgdGhpcy5vcHRpb25zLmZpbHRlclRoZW1lICE9IG51bGwgKSB7CgkJCQkJCXRleHRpbnB1dE9wdGlvbnNbIGlkeCBdID0gdGhpcy5vcHRpb25zLmZpbHRlclRoZW1lOwoJCQkJCX0gZWxzZSB7CgkJCQkJCXRleHRpbnB1dE9wdGlvbnNbIGlkeCBdID0gb3B0aW9uc1sgaWR4IF07CgkJCQkJfQoJCQkJfQoJCQl9CgkJCXRoaXMuX3NlYXJjaC50ZXh0aW5wdXQoICJvcHRpb24iLCB0ZXh0aW5wdXRPcHRpb25zICk7CgkJfQoJfQp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKZnVuY3Rpb24gZGVmYXVsdEF1dG9kaXZpZGVyc1NlbGVjdG9yKCBlbHQgKSB7CgkvLyBsb29rIGZvciB0aGUgdGV4dCBpbiB0aGUgZ2l2ZW4gZWxlbWVudAoJdmFyIHRleHQgPSAkLnRyaW0oIGVsdC50ZXh0KCkgKSB8fCBudWxsOwoKCWlmICggIXRleHQgKSB7CgkJcmV0dXJuIG51bGw7Cgl9CgoJLy8gY3JlYXRlIHRoZSB0ZXh0IGZvciB0aGUgZGl2aWRlciAoZmlyc3QgdXBwZXJjYXNlZCBsZXR0ZXIpCgl0ZXh0ID0gdGV4dC5zbGljZSggMCwgMSApLnRvVXBwZXJDYXNlKCk7CgoJcmV0dXJuIHRleHQ7Cn0KCiQud2lkZ2V0KCAibW9iaWxlLmxpc3R2aWV3IiwgJC5tb2JpbGUubGlzdHZpZXcsIHsKCW9wdGlvbnM6IHsKCQlhdXRvZGl2aWRlcnM6IGZhbHNlLAoJCWF1dG9kaXZpZGVyc1NlbGVjdG9yOiBkZWZhdWx0QXV0b2RpdmlkZXJzU2VsZWN0b3IKCX0sCgoJX2JlZm9yZUxpc3R2aWV3UmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJaWYgKCB0aGlzLm9wdGlvbnMuYXV0b2RpdmlkZXJzICkgewoJCQl0aGlzLl9yZXBsYWNlRGl2aWRlcnMoKTsKCQkJdGhpcy5fc3VwZXJBcHBseSggYXJndW1lbnRzICk7CgkJfQoJfSwKCglfcmVwbGFjZURpdmlkZXJzOiBmdW5jdGlvbigpIHsKCQl2YXIgaSwgbGlzLCBsaSwgZGl2aWRlclRleHQsCgkJCWxhc3REaXZpZGVyVGV4dCA9IG51bGwsCgkJCWxpc3QgPSB0aGlzLmVsZW1lbnQsCgkJCWRpdmlkZXI7CgoJCWxpc3QuY2hpbGRyZW4oICJsaTpqcW1EYXRhKHJvbGU9J2xpc3QtZGl2aWRlcicpIiApLnJlbW92ZSgpOwoKCQlsaXMgPSBsaXN0LmNoaWxkcmVuKCAibGkiICk7CgoJCWZvciAoIGkgPSAwOyBpIDwgbGlzLmxlbmd0aCA7IGkrKyApIHsKCQkJbGkgPSBsaXNbIGkgXTsKCQkJZGl2aWRlclRleHQgPSB0aGlzLm9wdGlvbnMuYXV0b2RpdmlkZXJzU2VsZWN0b3IoICQoIGxpICkgKTsKCgkJCWlmICggZGl2aWRlclRleHQgJiYgbGFzdERpdmlkZXJUZXh0ICE9PSBkaXZpZGVyVGV4dCApIHsKCQkJCWRpdmlkZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAibGkiICk7CgkJCQlkaXZpZGVyLmFwcGVuZENoaWxkKCBkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSggZGl2aWRlclRleHQgKSApOwoJCQkJZGl2aWRlci5zZXRBdHRyaWJ1dGUoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyb2xlIiwgImxpc3QtZGl2aWRlciIgKTsKCQkJCWxpLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKCBkaXZpZGVyLCBsaSApOwoJCQl9CgoJCQlsYXN0RGl2aWRlclRleHQgPSBkaXZpZGVyVGV4dDsKCQl9Cgl9Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7Cgp2YXIgcmRpdmlkZXIgPSAvKF58XHMpdWktbGktZGl2aWRlcigkfFxzKS8sCglyaGlkZGVuID0gLyhefFxzKXVpLXNjcmVlbi1oaWRkZW4oJHxccykvOwoKJC53aWRnZXQoICJtb2JpbGUubGlzdHZpZXciLCAkLm1vYmlsZS5saXN0dmlldywgewoJb3B0aW9uczogewoJCWhpZGVkaXZpZGVyczogZmFsc2UKCX0sCgoJX2FmdGVyTGlzdHZpZXdSZWZyZXNoOiBmdW5jdGlvbigpIHsKCQl2YXIgaXRlbXMsIGlkeCwgaXRlbSwgaGlkZURpdmlkZXIgPSB0cnVlOwoKCQl0aGlzLl9zdXBlckFwcGx5KCBhcmd1bWVudHMgKTsKCgkJaWYgKCB0aGlzLm9wdGlvbnMuaGlkZWRpdmlkZXJzICkgewoJCQlpdGVtcyA9IHRoaXMuX2dldENoaWxkcmVuQnlUYWdOYW1lKCB0aGlzLmVsZW1lbnRbIDAgXSwgImxpIiwgIkxJIiApOwoJCQlmb3IgKCBpZHggPSBpdGVtcy5sZW5ndGggLSAxIDsgaWR4ID4gLTEgOyBpZHgtLSApIHsKCQkJCWl0ZW0gPSBpdGVtc1sgaWR4IF07CgkJCQlpZiAoIGl0ZW0uY2xhc3NOYW1lLm1hdGNoKCByZGl2aWRlciApICkgewoJCQkJCWlmICggaGlkZURpdmlkZXIgKSB7CgkJCQkJCWl0ZW0uY2xhc3NOYW1lID0gaXRlbS5jbGFzc05hbWUgKyAiIHVpLXNjcmVlbi1oaWRkZW4iOwoJCQkJCX0KCQkJCQloaWRlRGl2aWRlciA9IHRydWU7CgkJCQl9IGVsc2UgewoJCQkJCWlmICggIWl0ZW0uY2xhc3NOYW1lLm1hdGNoKCByaGlkZGVuICkgKSB7CgkJCQkJCWhpZGVEaXZpZGVyID0gZmFsc2U7CgkJCQkJfQoJCQkJfQoJCQl9CgkJfQoJfQp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUubm9qcyA9IGZ1bmN0aW9uKCB0YXJnZXQgKSB7CgkkKCAiOmpxbURhdGEocm9sZT0nbm9qcycpIiwgdGFyZ2V0ICkuYWRkQ2xhc3MoICJ1aS1ub2pzIiApOwp9OwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS5iZWhhdmlvcnMuZm9ybVJlc2V0ID0gewoJX2hhbmRsZUZvcm1SZXNldDogZnVuY3Rpb24oKSB7CgkJdGhpcy5fb24oIHRoaXMuZWxlbWVudC5jbG9zZXN0KCAiZm9ybSIgKSwgewoJCQlyZXNldDogZnVuY3Rpb24oKSB7CgkJCQl0aGlzLl9kZWxheSggIl9yZXNldCIgKTsKCQkJfQoJCX0pOwoJfQp9OwoKfSkoIGpRdWVyeSApOwoKLyoKKiAiY2hlY2tib3hyYWRpbyIgcGx1Z2luCiovCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLmNoZWNrYm94cmFkaW8iLCAkLmV4dGVuZCggewoKCWluaXRTZWxlY3RvcjogImlucHV0Om5vdCggOmpxbURhdGEocm9sZT0nZmxpcHN3aXRjaCcgKSApW3R5cGU9J2NoZWNrYm94J10saW5wdXRbdHlwZT0ncmFkaW8nXTpub3QoIDpqcW1EYXRhKHJvbGU9J2ZsaXBzd2l0Y2gnICkpIiwKCglvcHRpb25zOiB7CgkJdGhlbWU6ICJpbmhlcml0IiwKCQltaW5pOiBmYWxzZSwKCQl3cmFwcGVyQ2xhc3M6IG51bGwsCgkJZW5oYW5jZWQ6IGZhbHNlLAoJCWljb25wb3M6ICJsZWZ0IgoKCX0sCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl2YXIgaW5wdXQgPSB0aGlzLmVsZW1lbnQsCgkJCW8gPSB0aGlzLm9wdGlvbnMsCgkJCWluaGVyaXRBdHRyID0gZnVuY3Rpb24oIGlucHV0LCBkYXRhQXR0ciApIHsKCQkJCXJldHVybiBpbnB1dC5qcW1EYXRhKCBkYXRhQXR0ciApIHx8CgkJCQkJaW5wdXQuY2xvc2VzdCggImZvcm0sIGZpZWxkc2V0IiApLmpxbURhdGEoIGRhdGFBdHRyICk7CgkJCX0sCgkJCS8vIE5PVEU6IFdpbmRvd3MgUGhvbmUgY291bGQgbm90IGZpbmQgdGhlIGxhYmVsIHRocm91Z2ggYSBzZWxlY3RvcgoJCQkvLyBmaWx0ZXIgd29ya3MgdGhvdWdoLgoJCQlwYXJlbnRMYWJlbCA9IGlucHV0LmNsb3Nlc3QoICJsYWJlbCIgKSwKCQkJbGFiZWwgPSBwYXJlbnRMYWJlbC5sZW5ndGggPyBwYXJlbnRMYWJlbCA6CgkJCQlpbnB1dAoJCQkJCS5jbG9zZXN0KCAiZm9ybSwgZmllbGRzZXQsIDpqcW1EYXRhKHJvbGU9J3BhZ2UnKSwgOmpxbURhdGEocm9sZT0nZGlhbG9nJykiICkKCQkJCQkuZmluZCggImxhYmVsIiApCgkJCQkJLmZpbHRlciggIltmb3I9JyIgKyAkLm1vYmlsZS5wYXRoLmhhc2hUb1NlbGVjdG9yKCBpbnB1dFswXS5pZCApICsgIiddIiApCgkJCQkJLmZpcnN0KCksCgkJCWlucHV0dHlwZSA9IGlucHV0WzBdLnR5cGUsCgkJCWNoZWNrZWRTdGF0ZSA9IGlucHV0dHlwZSArICItb24iLAoJCQl1bmNoZWNrZWRTdGF0ZSA9IGlucHV0dHlwZSArICItb2ZmIiwKCQkJY2hlY2tlZENsYXNzID0gInVpLSIgKyBjaGVja2VkU3RhdGUsCgkJCXVuY2hlY2tlZENsYXNzID0gInVpLSIgKyB1bmNoZWNrZWRTdGF0ZTsKCgkJaWYgKCBpbnB1dHR5cGUgIT09ICJjaGVja2JveCIgJiYgaW5wdXR0eXBlICE9PSAicmFkaW8iICkgewoJCQlyZXR1cm47CgkJfQoKCQlpZiAoIHRoaXMuZWxlbWVudFswXS5kaXNhYmxlZCApewoJCQl0aGlzLm9wdGlvbnMuZGlzYWJsZWQgPSB0cnVlOwoJCX0KCgkJby5pY29ucG9zID0gaW5oZXJpdEF0dHIoIGlucHV0LCAiaWNvbnBvcyIgKSB8fCBsYWJlbC5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAiaWNvbnBvcyIgKSB8fCBvLmljb25wb3MsCgoJCS8vIEVzdGFibGlzaCBvcHRpb25zCgkJby5taW5pID0gaW5oZXJpdEF0dHIoIGlucHV0LCAibWluaSIgKSB8fCBvLm1pbmk7CgoJCS8vIEV4cG9zZSBmb3Igb3RoZXIgbWV0aG9kcwoJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCWlucHV0OiBpbnB1dCwKCQkJbGFiZWw6IGxhYmVsLAoJCQlwYXJlbnRMYWJlbDogcGFyZW50TGFiZWwsCgkJCWlucHV0dHlwZTogaW5wdXR0eXBlLAoJCQljaGVja2VkQ2xhc3M6IGNoZWNrZWRDbGFzcywKCQkJdW5jaGVja2VkQ2xhc3M6IHVuY2hlY2tlZENsYXNzLAoJCQljaGVja2VkaWNvbjogY2hlY2tlZFN0YXRlLAoJCQl1bmNoZWNrZWRpY29uOiB1bmNoZWNrZWRTdGF0ZQoJCX0pOwoKCQlpZiAoICF0aGlzLm9wdGlvbnMuZW5oYW5jZWQgKSB7CgkJCXRoaXMuX2VuaGFuY2UoKTsKCQl9CgoJCXRoaXMuX29uKCBsYWJlbCwgewoJCQl2bW91c2VvdmVyOiAiX2hhbmRsZUxhYmVsVk1vdXNlT3ZlciIsCgkJCXZjbGljazogIl9oYW5kbGVMYWJlbFZDbGljayIKCQl9KTsKCgkJdGhpcy5fb24oIGlucHV0LCB7CgkJCXZtb3VzZWRvd246ICJfY2FjaGVWYWxzIiwKCQkJdmNsaWNrOiAiX2hhbmRsZUlucHV0VkNsaWNrIiwKCQkJZm9jdXM6ICJfaGFuZGxlSW5wdXRGb2N1cyIsCgkJCWJsdXI6ICJfaGFuZGxlSW5wdXRCbHVyIgoJCX0pOwoKCQl0aGlzLl9oYW5kbGVGb3JtUmVzZXQoKTsKCQl0aGlzLnJlZnJlc2goKTsKCX0sCgoJX2VuaGFuY2U6IGZ1bmN0aW9uKCkgewoJCXRoaXMubGFiZWwuYWRkQ2xhc3MoICJ1aS1idG4gdWktY29ybmVyLWFsbCIpOwoKCQlpZiggdGhpcy5wYXJlbnRMYWJlbC5sZW5ndGggPiAwICl7CgkJCXRoaXMuaW5wdXQuYWRkKCB0aGlzLmxhYmVsICkud3JhcEFsbCggdGhpcy5fd3JhcHBlcigpICk7CgkJfSBlbHNlIHsKCQkJLy90aGlzLmVsZW1lbnQucmVwbGFjZVdpdGgoIHRoaXMuaW5wdXQuYWRkKCB0aGlzLmxhYmVsICkud3JhcEFsbCggdGhpcy5fd3JhcHBlcigpICkgKTsKCQkJdGhpcy5lbGVtZW50LndyYXAoIHRoaXMuX3dyYXBwZXIoKSApOwoJCQl0aGlzLmVsZW1lbnQucGFyZW50KCkucHJlcGVuZCggdGhpcy5sYWJlbCApOwoJCX0KCQkKCQkvLyBXcmFwIHRoZSBpbnB1dCArIGxhYmVsIGluIGEgZGl2CgkJCgkJdGhpcy5fc2V0T3B0aW9ucyh7CgkJCSJ0aGVtZSI6IHRoaXMub3B0aW9ucy50aGVtZSwKCQkJImljb25wb3MiOiB0aGlzLm9wdGlvbnMuaWNvbnBvcywKCQkJIm1pbmkiOiB0aGlzLm9wdGlvbnMubWluaQoJCX0pOwoKCX0sCgoJX3dyYXBwZXI6IGZ1bmN0aW9uKCkgewoJCXJldHVybiAkKCAiPGRpdiBjbGFzcz0nIiAgKwoJCQkoIHRoaXMub3B0aW9ucy53cmFwcGVyQ2xhc3MgPyB0aGlzLm9wdGlvbnMud3JhcHBlckNsYXNzIDogIiIgKSArCgkJCSIgdWktIiArIHRoaXMuaW5wdXR0eXBlICsKCQkJKCB0aGlzLm9wdGlvbnMuZGlzYWJsZWQgPyAiIHVpLXN0YXRlLWRpc2FibGVkIiA6ICIiICkgKyAiJyA+IiApOwoJfSwKCglfaGFuZGxlSW5wdXRGb2N1czogZnVuY3Rpb24oKSB7CgkJdGhpcy5sYWJlbC5hZGRDbGFzcyggJC5tb2JpbGUuZm9jdXNDbGFzcyApOwoJfSwKCglfaGFuZGxlSW5wdXRCbHVyOiBmdW5jdGlvbigpIHsKCQl0aGlzLmxhYmVsLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5mb2N1c0NsYXNzICk7Cgl9LAoKCV9oYW5kbGVJbnB1dFZDbGljazogZnVuY3Rpb24oKSB7CgkJdmFyICR0aGlzID0gdGhpcy5lbGVtZW50OwoKCQkvLyBBZGRzIGNoZWNrZWQgYXR0cmlidXRlIHRvIGNoZWNrZWQgaW5wdXQgd2hlbiBrZXlib2FyZCBpcyB1c2VkCgkJaWYgKCAkdGhpcy5pcyggIjpjaGVja2VkIiApICkgewoKCQkJJHRoaXMucHJvcCggImNoZWNrZWQiLCB0cnVlKTsKCQkJdGhpcy5fZ2V0SW5wdXRTZXQoKS5ub3QoICR0aGlzICkucHJvcCggImNoZWNrZWQiLCBmYWxzZSApOwoJCX0gZWxzZSB7CgkJCSR0aGlzLnByb3AoICJjaGVja2VkIiwgZmFsc2UgKTsKCQl9CgoJCXRoaXMuX3VwZGF0ZUFsbCgpOwoJfSwKCglfaGFuZGxlTGFiZWxWTW91c2VPdmVyOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJaWYgKCB0aGlzLmxhYmVsLnBhcmVudCgpLmhhc0NsYXNzKCAidWktc3RhdGUtZGlzYWJsZWQiICkgKSB7CgkJCWV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOwoJCX0KCX0sCgoJX2hhbmRsZUxhYmVsVkNsaWNrOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJdmFyIGlucHV0ID0gdGhpcy5lbGVtZW50OwoKCQlpZiAoIGlucHV0LmlzKCAiOmRpc2FibGVkIiApICkgewoJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQlyZXR1cm47CgkJfQoKCQl0aGlzLl9jYWNoZVZhbHMoKTsKCgkJaW5wdXQucHJvcCggImNoZWNrZWQiLCB0aGlzLmlucHV0dHlwZSA9PT0gInJhZGlvIiAmJiB0cnVlIHx8ICFpbnB1dC5wcm9wKCAiY2hlY2tlZCIgKSApOwoKCQkvLyB0cmlnZ2VyIGNsaWNrIGhhbmRsZXIncyBib3VuZCBkaXJlY3RseSB0byB0aGUgaW5wdXQgYXMgYSBzdWJzdGl0dXRlIGZvcgoJCS8vIGhvdyBsYWJlbCBjbGlja3MgYmVoYXZlIG5vcm1hbGx5IGluIHRoZSBicm93c2VycwoJCS8vIFRPRE86IGl0IHdvdWxkIGJlIG5pY2UgdG8gbGV0IHRoZSBicm93c2VyJ3MgaGFuZGxlIHRoZSBjbGlja3MgYW5kIHBhc3MgdGhlbQoJCS8vICAgICAgIHRocm91Z2ggdG8gdGhlIGFzc29jaWF0ZSBpbnB1dC4gd2UgY2FuIHN3YWxsb3cgdGhhdCBjbGljayBhdCB0aGUgcGFyZW50CgkJLy8gICAgICAgd3JhcHBlciBlbGVtZW50IGxldmVsCgkJaW5wdXQudHJpZ2dlckhhbmRsZXIoICJjbGljayIgKTsKCgkJLy8gSW5wdXQgc2V0IGZvciBjb21tb24gcmFkaW8gYnV0dG9ucyB3aWxsIGNvbnRhaW4gYWxsIHRoZSByYWRpbwoJCS8vIGJ1dHRvbnMsIGJ1dCB3aWxsIG5vdCBmb3IgY2hlY2tib3hlcy4gY2xlYXJpbmcgdGhlIGNoZWNrZWQgc3RhdHVzCgkJLy8gb2Ygb3RoZXIgcmFkaW9zIGVuc3VyZXMgdGhlIGFjdGl2ZSBidXR0b24gc3RhdGUgaXMgYXBwbGllZCBwcm9wZXJseQoJCXRoaXMuX2dldElucHV0U2V0KCkubm90KCBpbnB1dCApLnByb3AoICJjaGVja2VkIiwgZmFsc2UgKTsKCgkJdGhpcy5fdXBkYXRlQWxsKCk7CgkJcmV0dXJuIGZhbHNlOwoJfSwKCglfY2FjaGVWYWxzOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9nZXRJbnB1dFNldCgpLmVhY2goIGZ1bmN0aW9uKCkgewoJCQkkKCB0aGlzICkuYXR0cigiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAiY2FjaGVWYWwiLCB0aGlzLmNoZWNrZWQgKTsKCQl9KTsKCX0sCgoJLy9yZXR1cm5zIGVpdGhlciBhIHNldCBvZiByYWRpb3Mgd2l0aCB0aGUgc2FtZSBuYW1lIGF0dHJpYnV0ZSwgb3IgYSBzaW5nbGUgY2hlY2tib3gKCV9nZXRJbnB1dFNldDogZnVuY3Rpb24oKSB7CgkJaWYgKCB0aGlzLmlucHV0dHlwZSA9PT0gImNoZWNrYm94IiApIHsKCQkJcmV0dXJuIHRoaXMuZWxlbWVudDsKCQl9CgoJCXJldHVybiB0aGlzLmVsZW1lbnQuY2xvc2VzdCggImZvcm0sIDpqcW1EYXRhKHJvbGU9J3BhZ2UnKSwgOmpxbURhdGEocm9sZT0nZGlhbG9nJykiICkKCQkJLmZpbmQoICJpbnB1dFtuYW1lPSciICsgdGhpcy5lbGVtZW50WyAwIF0ubmFtZSArICInXVt0eXBlPSciICsgdGhpcy5pbnB1dHR5cGUgKyAiJ10iICk7Cgl9LAoKCV91cGRhdGVBbGw6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpczsKCgkJdGhpcy5fZ2V0SW5wdXRTZXQoKS5lYWNoKCBmdW5jdGlvbigpIHsKCQkJdmFyICR0aGlzID0gJCggdGhpcyApOwoKCQkJaWYgKCB0aGlzLmNoZWNrZWQgfHwgc2VsZi5pbnB1dHR5cGUgPT09ICJjaGVja2JveCIgKSB7CgkJCQkkdGhpcy50cmlnZ2VyKCAiY2hhbmdlIiApOwoJCQl9CgkJfSkKCQkuY2hlY2tib3hyYWRpbyggInJlZnJlc2giICk7Cgl9LAoKCV9yZXNldDogZnVuY3Rpb24oKSB7CgkJdGhpcy5yZWZyZXNoKCk7Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCXZhciBpbnB1dCA9IHRoaXMuZWxlbWVudFsgMCBdLAoJCQlhY3RpdmUgPSAiICIgKyAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcywKCQkJaGFzSWNvbiA9ICggdGhpcy5lbGVtZW50LnBhcmVudHMoICIudWktY29udHJvbGdyb3VwLWhvcml6b250YWwiICkubGVuZ3RoID09PSAwICksCgkJCWNoZWNrZWRDbGFzcyA9IHRoaXMuY2hlY2tlZENsYXNzICsgKCBoYXNJY29uID8gIiIgOiBhY3RpdmUgKSwKCQkJbGFiZWwgPSB0aGlzLmxhYmVsOwoKCQlsYWJlbAoJCQkudG9nZ2xlQ2xhc3MoICJ1aS1pY29uLSIgKyB0aGlzLmNoZWNrZWRpY29uLCBpbnB1dC5jaGVja2VkICkKCQkJLnRvZ2dsZUNsYXNzKCAidWktaWNvbi0iICsgdGhpcy51bmNoZWNrZWRpY29uLCAhaW5wdXQuY2hlY2tlZCApOwoJCWlmICggaW5wdXQuY2hlY2tlZCApIHsKCQkJbGFiZWwucmVtb3ZlQ2xhc3MoIHRoaXMudW5jaGVja2VkQ2xhc3MgKyBhY3RpdmUgKS5hZGRDbGFzcyggY2hlY2tlZENsYXNzICk7CgkJfSBlbHNlIHsKCQkJbGFiZWwucmVtb3ZlQ2xhc3MoIGNoZWNrZWRDbGFzcyApLmFkZENsYXNzKCB0aGlzLnVuY2hlY2tlZENsYXNzICk7CgkJfQoJfSwKCgl3aWRnZXQ6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLmxhYmVsLnBhcmVudCgpOwoJfSwKCglfc2V0T3B0aW9uczogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJdmFyIGxhYmVsID0gdGhpcy5sYWJlbCwKCQkJY3VycmVudE9wdGlvbnMgPSB0aGlzLm9wdGlvbnM7CgoJCWlmICggb3B0aW9ucy5kaXNhYmxlZCAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLmlucHV0LnByb3AoICJkaXNhYmxlZCIsICEhb3B0aW9ucy5kaXNhYmxlZCApOwoJCQl0aGlzLndpZGdldCgpLnRvZ2dsZUNsYXNzKCAidWktc3RhdGUtZGlzYWJsZWQiLCAhIW9wdGlvbnMuZGlzYWJsZWQgKTsKCQl9CgkJaWYgKCBvcHRpb25zLm1pbmkgIT09IHVuZGVmaW5lZCApIHsKCQkJbGFiZWwucGFyZW50KCkudG9nZ2xlQ2xhc3MoICJ1aS1taW5pIiwgISFvcHRpb25zLm1pbmkgKTsKCQl9CgkJaWYgKCBvcHRpb25zLnRoZW1lICE9PSB1bmRlZmluZWQgKSB7CgkJCWxhYmVsCgkJCQkucmVtb3ZlQ2xhc3MoICJ1aS1idG4tIiArIGN1cnJlbnRPcHRpb25zLnRoZW1lICkKCQkJCS5hZGRDbGFzcyggInVpLWJ0bi0iICsgb3B0aW9ucy50aGVtZSApOwoJCX0KCQlpZiAoIG9wdGlvbnMud3JhcHBlckNsYXNzICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMud2lkZ2V0KCkKCQkJCS5yZW1vdmVDbGFzcyggY3VycmVudE9wdGlvbnMud3JhcHBlckNsYXNzICkKCQkJCS5hZGRDbGFzcyggb3B0aW9ucy53cmFwcGVyQ2xhc3MgKTsKCQl9CgkJaWYgKCBvcHRpb25zLmljb25wb3MgIT09IHVuZGVmaW5lZCAmJgoJCQkoIHRoaXMuZWxlbWVudC5wYXJlbnRzKCAiW2RhdGEtIiArICQubW9iaWxlLm5zICsgInR5cGU9J2hvcml6b250YWwnXSIgKS5sZW5ndGggPT09IDAgKSApIHsKCQkJbGFiZWwucmVtb3ZlQ2xhc3MoICJ1aS1idG4taWNvbi0iICsgY3VycmVudE9wdGlvbnMuaWNvbnBvcyApLmFkZENsYXNzKCAidWktYnRuLWljb24tIiArIG9wdGlvbnMuaWNvbnBvcyApOwoJCX0gZWxzZSBpZiAoIHRoaXMuZWxlbWVudC5wYXJlbnRzKCAiW2RhdGEtIiArICQubW9iaWxlLm5zICsgInR5cGU9J2hvcml6b250YWwnXSIgKS5sZW5ndGggIT09IDAgKXsKCQkJbGFiZWwucmVtb3ZlQ2xhc3MoICJ1aS1idG4taWNvbi0iICsgY3VycmVudE9wdGlvbnMuaWNvbnBvcyApOwoJCX0KCQl0aGlzLl9zdXBlciggb3B0aW9ucyApOwoJfQoKfSwgJC5tb2JpbGUuYmVoYXZpb3JzLmZvcm1SZXNldCApICk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLmJ1dHRvbiIsIHsKCglpbml0U2VsZWN0b3I6ICJpbnB1dFt0eXBlPSdidXR0b24nXSwgaW5wdXRbdHlwZT0nc3VibWl0J10sIGlucHV0W3R5cGU9J3Jlc2V0J10iLAoKCW9wdGlvbnM6IHsKCQl0aGVtZTogbnVsbCwKCQlpY29uOiBudWxsLAoJCWljb25wb3M6ICJsZWZ0IiwKCQlpY29uc2hhZG93OiBmYWxzZSwgLyogVE9ETzogRGVwcmVjYXRlZCBpbiAxLjQsIHJlbW92ZSBpbiAxLjUuICovCgkJY29ybmVyczogdHJ1ZSwKCQlzaGFkb3c6IHRydWUsCgkJaW5saW5lOiBudWxsLAoJCW1pbmk6IG51bGwsCgkJd3JhcHBlckNsYXNzOiBudWxsLAoJCWVuaGFuY2VkOiBmYWxzZQoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCgkJaWYgKCB0aGlzLmVsZW1lbnQuaXMoICI6ZGlzYWJsZWQiICkgKSB7CgkJCXRoaXMub3B0aW9ucy5kaXNhYmxlZCA9IHRydWU7CgkJfQoKCQlpZiAoICF0aGlzLm9wdGlvbnMuZW5oYW5jZWQgKSB7CgkJCXRoaXMuX2VuaGFuY2UoKTsKCQl9CgoJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCXdyYXBwZXI6IHRoaXMuZWxlbWVudC5wYXJlbnQoKQoJCX0pOwoKCQl0aGlzLl9vbiggewoJCQlmb2N1czogZnVuY3Rpb24oKSB7CgkJCQl0aGlzLndpZGdldCgpLmFkZENsYXNzKCAkLm1vYmlsZS5mb2N1c0NsYXNzICk7CgkJCX0sCgoJCQlibHVyOiBmdW5jdGlvbigpIHsKCQkJCXRoaXMud2lkZ2V0KCkucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmZvY3VzQ2xhc3MgKTsKCQkJfQoJCX0pOwoJCQoJCXRoaXMucmVmcmVzaCggdHJ1ZSApOwoJfSwKCglfZW5oYW5jZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5lbGVtZW50LndyYXAoIHRoaXMuX2J1dHRvbigpICk7Cgl9LAoKCV9idXR0b246IGZ1bmN0aW9uKCkgewoJCXZhciBvcHRpb25zID0gdGhpcy5vcHRpb25zOwoKCQlyZXR1cm4gJCgiPGRpdiBjbGFzcz0ndWktYnRuIHVpLWlucHV0LWJ0biIgKwoJCQkoIG9wdGlvbnMud3JhcHBlckNsYXNzID8gIiAiICsgb3B0aW9ucy53cmFwcGVyQ2xhc3MgOiAiIiApICsKCQkJKCBvcHRpb25zLnRoZW1lID8gIiB1aS1idG4tIiArIG9wdGlvbnMudGhlbWUgOiAiIiApICsKCQkJKCBvcHRpb25zLmNvcm5lcnMgPyAiIHVpLWNvcm5lci1hbGwiIDogIiIgKSArCgkJCSggb3B0aW9ucy5zaGFkb3cgPyAiIHVpLXNoYWRvdyIgOiAiIiApICsKCQkJKCBvcHRpb25zLmlubGluZSA/ICIgdWktYnRuLWlubGluZSIgOiAiIiApICsKCQkJKCBvcHRpb25zLm1pbmkgPyAiIHVpLW1pbmkiIDogIiIgKSArCgkJCSggb3B0aW9ucy5kaXNhYmxlZCA/ICIgdWktc3RhdGUtZGlzYWJsZWQiIDogIiIgKSArCgkJCSggKCBvcHRpb25zLmljb25wb3MgJiYgb3B0aW9ucy5pY29uICkgPwoJCQkJIiB1aS1idG4taWNvbi0iICsgb3B0aW9ucy5pY29ucG9zIDoKCQkJCSggb3B0aW9ucy5pY29uID8gIiB1aS1idG4taWNvbi1sZWZ0IiA6ICIiICkgKSArCgkJCSggb3B0aW9ucy5pY29uID8gIiB1aS1pY29uLSIgKyBvcHRpb25zLmljb24gOiAiIiApICsKCQkJIicgPiIgKyB0aGlzLmVsZW1lbnQudmFsKCkgKyAiPC9kaXY+Iik7Cgl9LAoKCXdpZGdldDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMud3JhcHBlcjsKCX0sCgoJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLmVsZW1lbnQuaW5zZXJ0QmVmb3JlKCB0aGlzLmJ1dHRvbiApOwoJCQl0aGlzLmJ1dHRvbi5yZW1vdmUoKTsKCX0sCgoJX3NldE9wdGlvbnM6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCXZhciBvdXRlciA9IHRoaXMud2lkZ2V0KCk7CgoJCWlmICggb3B0aW9ucy50aGVtZSAhPT0gdW5kZWZpbmVkICkgewoJCQlvdXRlcgoJCQkJLnJlbW92ZUNsYXNzKCB0aGlzLm9wdGlvbnMudGhlbWUgKQoJCQkJLmFkZENsYXNzKCAidWktYnRuLSIgKyBvcHRpb25zLnRoZW1lICk7CgkJfQoJCWlmICggb3B0aW9ucy5jb3JuZXJzICE9PSB1bmRlZmluZWQgKSB7CgkJCW91dGVyLnRvZ2dsZUNsYXNzKCAidWktY29ybmVyLWFsbCIsIG9wdGlvbnMuY29ybmVycyApOwoJCX0KCQlpZiAoIG9wdGlvbnMuc2hhZG93ICE9PSB1bmRlZmluZWQgKSB7CgkJCW91dGVyLnRvZ2dsZUNsYXNzKCAidWktc2hhZG93Iiwgb3B0aW9ucy5zaGFkb3cgKTsKCQl9CgkJaWYgKCBvcHRpb25zLmlubGluZSAhPT0gdW5kZWZpbmVkICkgewoJCQlvdXRlci50b2dnbGVDbGFzcyggInVpLWJ0bi1pbmxpbmUiLCBvcHRpb25zLmlubGluZSApOwoJCX0KCQlpZiAoIG9wdGlvbnMubWluaSAhPT0gdW5kZWZpbmVkICkgewoJCQlvdXRlci50b2dnbGVDbGFzcyggInVpLW1pbmkiLCBvcHRpb25zLm1pbmkgKTsKCQl9CgkJaWYgKCBvcHRpb25zLmljb25wb3MgIT09IHVuZGVmaW5lZCApIHsKCQkJb3V0ZXIucmVtb3ZlQ2xhc3MoICJ1aS1idG4taWNvbi0iICsgb3B0aW9ucy5pY29ucG9zICk7CgkJfQoJCWlmICggb3B0aW9ucy5pY29uICE9PSB1bmRlZmluZWQgKSB7CgkJCWlmICggIXRoaXMub3B0aW9ucy5pY29ucG9zICYmICFvcHRpb25zLmljb25wb3MgKSB7CgkJCQlvdXRlci50b2dnbGVDbGFzcyggInVpLWJ0bi1pY29uLWxlZnQiLCBvcHRpb25zLmljb24gKTsKCQkJfQoJCQlvdXRlcgoJCQkJLnJlbW92ZUNsYXNzKCAidWktaWNvbi0iICsgdGhpcy5vcHRpb25zLmljb24gKQoJCQkJLnRvZ2dsZUNsYXNzKCAidWktaWNvbi0iICsgb3B0aW9ucy5pY29uLCBvcHRpb25zLmljb24gKTsKCQl9CgkJaWYoIG9wdGlvbnMuZGlzYWJsZWQgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhpcy5lbGVtZW50LnByb3AoICJkaXNhYmxlZCIsIG9wdGlvbnMuZGlzYWJsZWQgKTsKCQkJb3V0ZXIudG9nZ2xlQ2xhc3MoICJ1aS1zdGF0ZS1kaXNhYmxlZCIsIG9wdGlvbnMuZGlzYWJsZWQgKTsKCQl9CgoJCXRoaXMuX3N1cGVyKCBvcHRpb25zICk7Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCBjcmVhdGUgKSB7CgkJaWYgKCB0aGlzLm9wdGlvbnMuaWNvbiAmJiB0aGlzLm9wdGlvbnMuaWNvbnBvcyA9PT0gIm5vdGV4dCIgJiYgdGhpcy5lbGVtZW50LmF0dHIoICJ0aXRsZSIgKSApIHsKCQkJdGhpcy5lbGVtZW50LmF0dHIoICJ0aXRsZSIsIHRoaXMuZWxlbWVudC52YWwoKSApOwoJCX0KCQlpZiAoICFjcmVhdGUgKSB7CgkJCXZhciBvcmlnaW5hbEVsZW1lbnQgPSB0aGlzLmVsZW1lbnQuZGV0YWNoKCk7CgkJCSQoIHRoaXMud3JhcHBlciApLnRleHQoIHRoaXMuZWxlbWVudC52YWwoKSApLmFwcGVuZCggb3JpZ2luYWxFbGVtZW50ICk7CgkJfQoJfQp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCApIHsKCXZhcgltZXRhID0gJCggIm1ldGFbbmFtZT12aWV3cG9ydF0iICksCgkJaW5pdGlhbENvbnRlbnQgPSBtZXRhLmF0dHIoICJjb250ZW50IiApLAoJCWRpc2FibGVkWm9vbSA9IGluaXRpYWxDb250ZW50ICsgIixtYXhpbXVtLXNjYWxlPTEsIHVzZXItc2NhbGFibGU9bm8iLAoJCWVuYWJsZWRab29tID0gaW5pdGlhbENvbnRlbnQgKyAiLG1heGltdW0tc2NhbGU9MTAsIHVzZXItc2NhbGFibGU9eWVzIiwKCQlkaXNhYmxlZEluaXRpYWxseSA9IC8odXNlci1zY2FsYWJsZVtcc10qPVtcc10qbm8pfChtYXhpbXVtLXNjYWxlW1xzXSo9W1xzXSoxKVskLFxzXS8udGVzdCggaW5pdGlhbENvbnRlbnQgKTsKCgkkLm1vYmlsZS56b29tID0gJC5leHRlbmQoIHt9LCB7CgkJZW5hYmxlZDogIWRpc2FibGVkSW5pdGlhbGx5LAoJCWxvY2tlZDogZmFsc2UsCgkJZGlzYWJsZTogZnVuY3Rpb24oIGxvY2sgKSB7CgkJCWlmICggIWRpc2FibGVkSW5pdGlhbGx5ICYmICEkLm1vYmlsZS56b29tLmxvY2tlZCApIHsKCQkJCW1ldGEuYXR0ciggImNvbnRlbnQiLCBkaXNhYmxlZFpvb20gKTsKCQkJCSQubW9iaWxlLnpvb20uZW5hYmxlZCA9IGZhbHNlOwoJCQkJJC5tb2JpbGUuem9vbS5sb2NrZWQgPSBsb2NrIHx8IGZhbHNlOwoJCQl9CgkJfSwKCQllbmFibGU6IGZ1bmN0aW9uKCB1bmxvY2sgKSB7CgkJCWlmICggIWRpc2FibGVkSW5pdGlhbGx5ICYmICggISQubW9iaWxlLnpvb20ubG9ja2VkIHx8IHVubG9jayA9PT0gdHJ1ZSApICkgewoJCQkJbWV0YS5hdHRyKCAiY29udGVudCIsIGVuYWJsZWRab29tICk7CgkJCQkkLm1vYmlsZS56b29tLmVuYWJsZWQgPSB0cnVlOwoJCQkJJC5tb2JpbGUuem9vbS5sb2NrZWQgPSBmYWxzZTsKCQkJfQoJCX0sCgkJcmVzdG9yZTogZnVuY3Rpb24oKSB7CgkJCWlmICggIWRpc2FibGVkSW5pdGlhbGx5ICkgewoJCQkJbWV0YS5hdHRyKCAiY29udGVudCIsIGluaXRpYWxDb250ZW50ICk7CgkJCQkkLm1vYmlsZS56b29tLmVuYWJsZWQgPSB0cnVlOwoJCQl9CgkJfQoJfSk7Cgp9KCBqUXVlcnkgKSk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLnRleHRpbnB1dCIsIHsKCWluaXRTZWxlY3RvcjogImlucHV0W3R5cGU9J3RleHQnXSwgaW5wdXRbdHlwZT0nc2VhcmNoJ10sIDpqcW1EYXRhKHR5cGU9J3NlYXJjaCcpLCBpbnB1dFt0eXBlPSdudW1iZXInXSwgOmpxbURhdGEodHlwZT0nbnVtYmVyJyksIGlucHV0W3R5cGU9J3Bhc3N3b3JkJ10sIGlucHV0W3R5cGU9J2VtYWlsJ10sIGlucHV0W3R5cGU9J3VybCddLCBpbnB1dFt0eXBlPSd0ZWwnXSwgdGV4dGFyZWEsIGlucHV0W3R5cGU9J3RpbWUnXSwgaW5wdXRbdHlwZT0nZGF0ZSddLCBpbnB1dFt0eXBlPSdtb250aCddLCBpbnB1dFt0eXBlPSd3ZWVrJ10sIGlucHV0W3R5cGU9J2RhdGV0aW1lJ10sIGlucHV0W3R5cGU9J2RhdGV0aW1lLWxvY2FsJ10sIGlucHV0W3R5cGU9J2NvbG9yJ10sIGlucHV0Om5vdChbdHlwZV0pLCBpbnB1dFt0eXBlPSdmaWxlJ10iLAoKCW9wdGlvbnM6IHsKCQl0aGVtZTogbnVsbCwKCQljb3JuZXJzOiB0cnVlLAoJCW1pbmk6IGZhbHNlLAoJCS8vIFRoaXMgb3B0aW9uIGRlZmF1bHRzIHRvIHRydWUgb24gaU9TIGRldmljZXMuCgkJcHJldmVudEZvY3VzWm9vbTogL2lQaG9uZXxpUGFkfGlQb2QvLnRlc3QoIG5hdmlnYXRvci5wbGF0Zm9ybSApICYmIG5hdmlnYXRvci51c2VyQWdlbnQuaW5kZXhPZiggIkFwcGxlV2ViS2l0IiApID4gLTEsCgkJd3JhcHBlckNsYXNzOiAiIiwKCQllbmhhbmNlZDogZmFsc2UKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgoJCXZhciBvcHRpb25zID0gdGhpcy5vcHRpb25zLAoJCQlpc1NlYXJjaCA9IHRoaXMuZWxlbWVudC5pcyggIlt0eXBlPSdzZWFyY2gnXSwgOmpxbURhdGEodHlwZT0nc2VhcmNoJykiICksCgkJCWlzVGV4dGFyZWEgPSB0aGlzLmVsZW1lbnRbIDAgXS50YWdOYW1lID09PSAiVEVYVEFSRUEiLAoJCQlpc1JhbmdlID0gdGhpcy5lbGVtZW50LmlzKCAiW2RhdGEtIiArICggJC5tb2JpbGUubnMgfHwgIiIgKSArICJ0eXBlPSdyYW5nZSddIiApLAoJCQlpbnB1dE5lZWRzV3JhcCA9ICggKHRoaXMuZWxlbWVudC5pcyggImlucHV0IiApIHx8CgkJCQl0aGlzLmVsZW1lbnQuaXMoICJbZGF0YS0iICsgKCAkLm1vYmlsZS5ucyB8fCAiIiApICsgInR5cGU9J3NlYXJjaCddIiApICkgJiYKCQkJCQkhaXNSYW5nZSApOwoJCQkKCQkkLmV4dGVuZCggdGhpcywgewoJCQljbGFzc2VzOiB0aGlzLl9jbGFzc2VzRnJvbU9wdGlvbnMoKSwKCQkJaXNTZWFyY2g6IGlzU2VhcmNoLAoJCQlpc1RleHRhcmVhOiBpc1RleHRhcmVhLAoJCQlpc1JhbmdlOiBpc1JhbmdlLAoJCQlpbnB1dE5lZWRzV3JhcDogaW5wdXROZWVkc1dyYXAKCQl9KTsKCgkJdGhpcy5fYXV0b0NvcnJlY3QoKTsKCgkJaWYgKCB0aGlzLmVsZW1lbnRbIDAgXS5kaXNhYmxlZCApIHsKCQkJb3B0aW9ucy5kaXNhYmxlZCA9IHRydWU7CgkJfQoKCQlpZiAoICFvcHRpb25zLmVuaGFuY2VkICkgewoJCQl0aGlzLl9lbmhhbmNlKCk7CgkJfQoKCQl0aGlzLl9vbiggewoJCQkiZm9jdXMiOiAiX2hhbmRsZUZvY3VzIiwKCQkJImJsdXIiOiAiX2hhbmRsZUJsdXIiCgkJfSk7CgoJfSwKCglyZWZyZXNoOiBmdW5jdGlvbigpIHsKCQl0aGlzLnNldE9wdGlvbnMoewoJCQkiZGlzYWJsZWQiIDogdGhpcy5lbGVtZW50LmlzKCAiOmRpc2FibGVkIiApCgkJfSk7Cgl9LAoKCV9lbmhhbmNlOiBmdW5jdGlvbigpIHsKCQl2YXIgZWxlbWVudENsYXNzZXMgPSBbXTsKCgkJaWYgKCB0aGlzLmlzVGV4dGFyZWEgKSB7CgkJCWVsZW1lbnRDbGFzc2VzLnB1c2goICJ1aS1pbnB1dC10ZXh0IiApOwoJCX0KCgkJaWYgKCB0aGlzLmlzVGV4dGFyZWEgfHwgdGhpcy5pc1JhbmdlICkgewoJCQllbGVtZW50Q2xhc3Nlcy5wdXNoKCAidWktc2hhZG93LWluc2V0IiApOwoJCX0KCgkJLy8ic2VhcmNoIiBhbmQgInRleHQiIGlucHV0IHdpZGdldHMKCQlpZiAoIHRoaXMuaW5wdXROZWVkc1dyYXAgKSB7CgkJCXRoaXMuZWxlbWVudC53cmFwKCB0aGlzLl93cmFwKCkgKTsKCQl9IGVsc2UgewoJCQllbGVtZW50Q2xhc3NlcyA9IGVsZW1lbnRDbGFzc2VzLmNvbmNhdCggdGhpcy5jbGFzc2VzICk7CgkJfQoKCQl0aGlzLmVsZW1lbnQuYWRkQ2xhc3MoIGVsZW1lbnRDbGFzc2VzLmpvaW4oICIgIiApICk7Cgl9LAoKCXdpZGdldDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuICggdGhpcy5pbnB1dE5lZWRzV3JhcCApID8gdGhpcy5lbGVtZW50LnBhcmVudCgpIDogdGhpcy5lbGVtZW50OwoJfSwKCglfY2xhc3Nlc0Zyb21PcHRpb25zOiBmdW5jdGlvbigpIHsKCQl2YXIgb3B0aW9ucyA9IHRoaXMub3B0aW9ucywKCQkJY2xhc3NlcyA9IFtdOwoKCQljbGFzc2VzLnB1c2goICJ1aS1ib2R5LSIgKyAoICggb3B0aW9ucy50aGVtZSA9PT0gbnVsbCApID8gImluaGVyaXQiIDogb3B0aW9ucy50aGVtZSApICk7CgkJaWYgKCBvcHRpb25zLmNvcm5lcnMgKSB7CgkJCWNsYXNzZXMucHVzaCggInVpLWNvcm5lci1hbGwiICk7CgkJfQoJCWlmICggb3B0aW9ucy5taW5pICkgewoJCQljbGFzc2VzLnB1c2goICJ1aS1taW5pIiApOwoJCX0KCQlpZiAoIG9wdGlvbnMuZGlzYWJsZWQgKSB7CgkJCWNsYXNzZXMucHVzaCggInVpLXN0YXRlLWRpc2FibGVkIiApOwoJCX0KCQlpZiAoIG9wdGlvbnMud3JhcHBlckNsYXNzICkgewoJCQljbGFzc2VzLnB1c2goIG9wdGlvbnMud3JhcHBlckNsYXNzICk7CgkJfQoKCQlyZXR1cm4gY2xhc3NlczsKCX0sCgoJX3dyYXA6IGZ1bmN0aW9uKCkgewoJCXJldHVybiAkKCAiPGRpdiBjbGFzcz0nIiArCgkJCSggdGhpcy5pc1NlYXJjaCA/ICJ1aS1pbnB1dC1zZWFyY2ggIiA6ICJ1aS1pbnB1dC10ZXh0ICIgKSArCgkJCXRoaXMuY2xhc3Nlcy5qb2luKCAiICIgKSArICIgIiArCgkJCSJ1aS1zaGFkb3ctaW5zZXQnPjwvZGl2PiIgKTsKCX0sCgoJX2F1dG9Db3JyZWN0OiBmdW5jdGlvbigpIHsKCQkvLyBYWFg6IFRlbXBvcmFyeSB3b3JrYXJvdW5kIGZvciBpc3N1ZSA3ODUgKEFwcGxlIGJ1ZyA4OTEwNTg5KS4KCQkvLyAgICAgIFR1cm4gb2ZmIGF1dG9jb3JyZWN0IGFuZCBhdXRvY29tcGxldGUgb24gbm9uLWlPUyA1IGRldmljZXMKCQkvLyAgICAgIHNpbmNlIHRoZSBwb3B1cCB0aGV5IHVzZSBjYW4ndCBiZSBkaXNtaXNzZWQgYnkgdGhlIHVzZXIuIE5vdGUKCQkvLyAgICAgIHRoYXQgd2UgdGVzdCBmb3IgdGhlIHByZXNlbmNlIG9mIHRoZSBmZWF0dXJlIGJ5IGxvb2tpbmcgZm9yCgkJLy8gICAgICB0aGUgYXV0b2NvcnJlY3QgcHJvcGVydHkgb24gdGhlIGlucHV0IGVsZW1lbnQuIFdlIGN1cnJlbnRseQoJCS8vICAgICAgaGF2ZSBubyB0ZXN0IGZvciBpT1MgNSBvciBuZXdlciBzbyB3ZSdyZSB0ZW1wb3JhcmlseSB1c2luZwoJCS8vICAgICAgdGhlIHRvdWNoT3ZlcmZsb3cgc3VwcG9ydCBmbGFnIGZvciBqUU0gMS4wLiBZZXMsIEkgZmVlbCBkaXJ0eS4KCQkvLyAgICAgIC0gamJsYXMKCQlpZiAoIHR5cGVvZiB0aGlzLmVsZW1lbnRbMF0uYXV0b2NvcnJlY3QgIT09ICJ1bmRlZmluZWQiICYmCgkJCSEkLnN1cHBvcnQudG91Y2hPdmVyZmxvdyApIHsKCgkJCS8vIFNldCB0aGUgYXR0cmlidXRlIGluc3RlYWQgb2YgdGhlIHByb3BlcnR5IGp1c3QgaW4gY2FzZSB0aGVyZQoJCQkvLyBpcyBjb2RlIHRoYXQgYXR0ZW1wdHMgdG8gbWFrZSBtb2RpZmljYXRpb25zIHZpYSBIVE1MLgoJCQl0aGlzLmVsZW1lbnRbMF0uc2V0QXR0cmlidXRlKCAiYXV0b2NvcnJlY3QiLCAib2ZmIiApOwoJCQl0aGlzLmVsZW1lbnRbMF0uc2V0QXR0cmlidXRlKCAiYXV0b2NvbXBsZXRlIiwgIm9mZiIgKTsKCQl9Cgl9LAoKCV9oYW5kbGVCbHVyOiBmdW5jdGlvbigpIHsKCQl0aGlzLndpZGdldCgpLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5mb2N1c0NsYXNzICk7CgkJaWYgKCB0aGlzLm9wdGlvbnMucHJldmVudEZvY3VzWm9vbSApIHsKCQkJJC5tb2JpbGUuem9vbS5lbmFibGUoIHRydWUgKTsKCQl9Cgl9LAoKCV9oYW5kbGVGb2N1czogZnVuY3Rpb24oKSB7CgkJLy8gSW4gbWFueSBzaXR1YXRpb25zLCBpT1Mgd2lsbCB6b29tIGludG8gdGhlIGlucHV0IHVwb24gdGFwLCB0aGlzCgkJLy8gcHJldmVudHMgdGhhdCBmcm9tIGhhcHBlbmluZwoJCWlmICggdGhpcy5vcHRpb25zLnByZXZlbnRGb2N1c1pvb20gKSB7CgkJCSQubW9iaWxlLnpvb20uZGlzYWJsZSggdHJ1ZSApOwoJCX0KCQl0aGlzLndpZGdldCgpLmFkZENsYXNzKCAkLm1vYmlsZS5mb2N1c0NsYXNzICk7Cgl9LAoKCV9zZXRPcHRpb25zOiBmdW5jdGlvbiAoIG9wdGlvbnMgKSB7CgkJdmFyIG91dGVyID0gdGhpcy53aWRnZXQoKTsKCgkJdGhpcy5fc3VwZXIoIG9wdGlvbnMgKTsKCgkJaWYgKCAhKCBvcHRpb25zLmRpc2FibGVkID09PSB1bmRlZmluZWQgJiYKCQkJb3B0aW9ucy5taW5pID09PSB1bmRlZmluZWQgJiYKCQkJb3B0aW9ucy5jb3JuZXJzID09PSB1bmRlZmluZWQgJiYKCQkJb3B0aW9ucy50aGVtZSA9PT0gdW5kZWZpbmVkICYmCgkJCW9wdGlvbnMud3JhcHBlckNsYXNzID09PSB1bmRlZmluZWQgKSApIHsKCgkJCW91dGVyLnJlbW92ZUNsYXNzKCB0aGlzLmNsYXNzZXMuam9pbiggIiAiICkgKTsKCQkJdGhpcy5jbGFzc2VzID0gdGhpcy5fY2xhc3Nlc0Zyb21PcHRpb25zKCk7CgkJCW91dGVyLmFkZENsYXNzKCB0aGlzLmNsYXNzZXMuam9pbiggIiAiICkgKTsKCQl9CgoJCWlmICggb3B0aW9ucy5kaXNhYmxlZCAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLmVsZW1lbnQucHJvcCggImRpc2FibGVkIiwgISFvcHRpb25zLmRpc2FibGVkICk7CgkJfQoJfSwKCglfZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJaWYgKCB0aGlzLm9wdGlvbnMuZW5oYW5jZWQgKSB7CgkJCXJldHVybjsKCQl9CgkJaWYgKCB0aGlzLmlucHV0TmVlZHNXcmFwICkgewoJCQl0aGlzLmVsZW1lbnQudW53cmFwKCk7CgkJfQoJCXRoaXMuZWxlbWVudC5yZW1vdmVDbGFzcyggInVpLWlucHV0LXRleHQgIiArIHRoaXMuY2xhc3Nlcy5qb2luKCAiICIgKSApOwoJfQp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUuc2xpZGVyIiwgJC5leHRlbmQoIHsKCWluaXRTZWxlY3RvcjogImlucHV0W3R5cGU9J3JhbmdlJ10sIDpqcW1EYXRhKHR5cGU9J3JhbmdlJyksIDpqcW1EYXRhKHJvbGU9J3NsaWRlcicpIiwKCgl3aWRnZXRFdmVudFByZWZpeDogInNsaWRlIiwKCglvcHRpb25zOiB7CgkJdGhlbWU6IG51bGwsCgkJdHJhY2tUaGVtZTogbnVsbCwKCQljb3JuZXJzOiB0cnVlLAoJCW1pbmk6IGZhbHNlLAoJCWhpZ2hsaWdodDogZmFsc2UKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgoJCS8vIFRPRE86IEVhY2ggb2YgdGhlc2Ugc2hvdWxkIGhhdmUgY29tbWVudHMgZXhwbGFpbiB3aGF0IHRoZXkncmUgZm9yCgkJdmFyIHNlbGYgPSB0aGlzLAoJCQljb250cm9sID0gdGhpcy5lbGVtZW50LAoJCQl0cmFja1RoZW1lID0gdGhpcy5vcHRpb25zLnRyYWNrVGhlbWUgfHwgJC5tb2JpbGUuZ2V0QXR0cmlidXRlKCBjb250cm9sWyAwIF0sICJ0aGVtZSIgKSwKCQkJdHJhY2tUaGVtZUNsYXNzID0gdHJhY2tUaGVtZSA/ICIgdWktYmFyLSIgKyB0cmFja1RoZW1lIDogIiB1aS1iYXItaW5oZXJpdCIsCgkJCWNvcm5lckNsYXNzID0gKCB0aGlzLm9wdGlvbnMuY29ybmVycyB8fCBjb250cm9sLmpxbURhdGEoICJjb3JuZXJzIiApICkgPyAiIHVpLWNvcm5lci1hbGwiIDogIiIsCgkJCW1pbmlDbGFzcyA9ICggdGhpcy5vcHRpb25zLm1pbmkgfHwgY29udHJvbC5qcW1EYXRhKCAibWluaSIgKSApID8gIiB1aS1taW5pIiA6ICIiLAoJCQljVHlwZSA9IGNvbnRyb2xbIDAgXS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpLAoJCQlpc1RvZ2dsZVN3aXRjaCA9ICggY1R5cGUgPT09ICJzZWxlY3QiICksCgkJCWlzUmFuZ2VzbGlkZXIgPSBjb250cm9sLnBhcmVudCgpLmlzKCAiOmpxbURhdGEocm9sZT0ncmFuZ2VzbGlkZXInKSIgKSwKCQkJc2VsZWN0Q2xhc3MgPSAoIGlzVG9nZ2xlU3dpdGNoICkgPyAidWktc2xpZGVyLXN3aXRjaCIgOiAiIiwKCQkJY29udHJvbElEID0gY29udHJvbC5hdHRyKCAiaWQiICksCgkJCSRsYWJlbCA9ICQoICJbZm9yPSciICsgY29udHJvbElEICsgIiddIiApLAoJCQlsYWJlbElEID0gJGxhYmVsLmF0dHIoICJpZCIgKSB8fCBjb250cm9sSUQgKyAiLWxhYmVsIiwKCQkJbWluID0gIWlzVG9nZ2xlU3dpdGNoID8gcGFyc2VGbG9hdCggY29udHJvbC5hdHRyKCAibWluIiApICkgOiAwLAoJCQltYXggPSAgIWlzVG9nZ2xlU3dpdGNoID8gcGFyc2VGbG9hdCggY29udHJvbC5hdHRyKCAibWF4IiApICkgOiBjb250cm9sLmZpbmQoICJvcHRpb24iICkubGVuZ3RoLTEsCgkJCXN0ZXAgPSB3aW5kb3cucGFyc2VGbG9hdCggY29udHJvbC5hdHRyKCAic3RlcCIgKSB8fCAxICksCgkJCWRvbUhhbmRsZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJhIiApLAoJCQloYW5kbGUgPSAkKCBkb21IYW5kbGUgKSwKCQkJZG9tU2xpZGVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImRpdiIgKSwKCQkJc2xpZGVyID0gJCggZG9tU2xpZGVyICksCgkJCXZhbHVlYmcgPSB0aGlzLm9wdGlvbnMuaGlnaGxpZ2h0ICYmICFpc1RvZ2dsZVN3aXRjaCA/IChmdW5jdGlvbigpIHsKCQkJCXZhciBiZyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJkaXYiICk7CgkJCQliZy5jbGFzc05hbWUgPSAidWktc2xpZGVyLWJnICIgKyAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzczsKCQkJCXJldHVybiAkKCBiZyApLnByZXBlbmRUbyggc2xpZGVyICk7CgkJCX0pKCkgOiBmYWxzZSwKCQkJb3B0aW9ucywKCQkJd3JhcHBlciwKCQkJaiwgbGVuZ3RoLAoJCQlpLCBvcHRpb25zQ291bnQsIG9yaWdUYWJJbmRleCwKCQkJc2lkZSwgYWN0aXZlQ2xhc3MsIHNsaWRlckltZzsKCgkJJGxhYmVsLmF0dHIoICJpZCIsIGxhYmVsSUQgKTsKCQl0aGlzLmlzVG9nZ2xlU3dpdGNoID0gaXNUb2dnbGVTd2l0Y2g7CgoJCWRvbUhhbmRsZS5zZXRBdHRyaWJ1dGUoICJocmVmIiwgIiMiICk7CgkJZG9tU2xpZGVyLnNldEF0dHJpYnV0ZSggInJvbGUiLCAiYXBwbGljYXRpb24iICk7CgkJZG9tU2xpZGVyLmNsYXNzTmFtZSA9IFsgdGhpcy5pc1RvZ2dsZVN3aXRjaCA/ICJ1aS1zbGlkZXIgdWktc2xpZGVyLXRyYWNrIHVpLXNoYWRvdy1pbnNldCAiIDogInVpLXNsaWRlci10cmFjayB1aS1zaGFkb3ctaW5zZXQgIiwgc2VsZWN0Q2xhc3MsIHRyYWNrVGhlbWVDbGFzcywgY29ybmVyQ2xhc3MsIG1pbmlDbGFzcyBdLmpvaW4oICIiICk7CgkJZG9tSGFuZGxlLmNsYXNzTmFtZSA9ICJ1aS1zbGlkZXItaGFuZGxlIjsKCQlkb21TbGlkZXIuYXBwZW5kQ2hpbGQoIGRvbUhhbmRsZSApOwoKCQloYW5kbGUuYXR0cih7CgkJCSJyb2xlIjogInNsaWRlciIsCgkJCSJhcmlhLXZhbHVlbWluIjogbWluLAoJCQkiYXJpYS12YWx1ZW1heCI6IG1heCwKCQkJImFyaWEtdmFsdWVub3ciOiB0aGlzLl92YWx1ZSgpLAoJCQkiYXJpYS12YWx1ZXRleHQiOiB0aGlzLl92YWx1ZSgpLAoJCQkidGl0bGUiOiB0aGlzLl92YWx1ZSgpLAoJCQkiYXJpYS1sYWJlbGxlZGJ5IjogbGFiZWxJRAoJCX0pOwoKCQkkLmV4dGVuZCggdGhpcywgewoJCQlzbGlkZXI6IHNsaWRlciwKCQkJaGFuZGxlOiBoYW5kbGUsCgkJCWNvbnRyb2w6IGNvbnRyb2wsCgkJCXR5cGU6IGNUeXBlLAoJCQlzdGVwOiBzdGVwLAoJCQltYXg6IG1heCwKCQkJbWluOiBtaW4sCgkJCXZhbHVlYmc6IHZhbHVlYmcsCgkJCWlzUmFuZ2VzbGlkZXI6IGlzUmFuZ2VzbGlkZXIsCgkJCWRyYWdnaW5nOiBmYWxzZSwKCQkJYmVmb3JlU3RhcnQ6IG51bGwsCgkJCXVzZXJNb2RpZmllZDogZmFsc2UsCgkJCW1vdXNlTW92ZWQ6IGZhbHNlCgkJfSk7CgoJCWlmICggaXNUb2dnbGVTd2l0Y2ggKSB7CgkJCS8vIFRPRE86IHJlc3RvcmUgb3JpZ2luYWwgdGFiaW5kZXggKGlmIGFueSkgaW4gYSBkZXN0cm95IG1ldGhvZAoJCQlvcmlnVGFiSW5kZXggPSBjb250cm9sLmF0dHIoICJ0YWJpbmRleCIgKTsKCQkJaWYgKCBvcmlnVGFiSW5kZXggKSB7CgkJCQloYW5kbGUuYXR0ciggInRhYmluZGV4Iiwgb3JpZ1RhYkluZGV4ICk7CgkJCX0KCQkJY29udHJvbC5hdHRyKCAidGFiaW5kZXgiLCAiLTEiICkuZm9jdXMoZnVuY3Rpb24oKSB7CgkJCQkkKCB0aGlzICkuYmx1cigpOwoJCQkJaGFuZGxlLmZvY3VzKCk7CgkJCX0pOwoKCQkJd3JhcHBlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJkaXYiICk7CgkJCXdyYXBwZXIuY2xhc3NOYW1lID0gInVpLXNsaWRlci1pbm5lcm9mZnNldCI7CgoJCQlmb3IgKCBqID0gMCwgbGVuZ3RoID0gZG9tU2xpZGVyLmNoaWxkTm9kZXMubGVuZ3RoOyBqIDwgbGVuZ3RoOyBqKysgKSB7CgkJCQl3cmFwcGVyLmFwcGVuZENoaWxkKCBkb21TbGlkZXIuY2hpbGROb2Rlc1tqXSApOwoJCQl9CgoJCQlkb21TbGlkZXIuYXBwZW5kQ2hpbGQoIHdyYXBwZXIgKTsKCgkJCS8vIHNsaWRlci53cmFwSW5uZXIoICI8ZGl2IGNsYXNzPSd1aS1zbGlkZXItaW5uZXJvZmZzZXQnPjwvZGl2PiIgKTsKCgkJCS8vIG1ha2UgdGhlIGhhbmRsZSBtb3ZlIHdpdGggYSBzbW9vdGggdHJhbnNpdGlvbgoJCQloYW5kbGUuYWRkQ2xhc3MoICJ1aS1zbGlkZXItaGFuZGxlLXNuYXBwaW5nIiApOwoKCQkJb3B0aW9ucyA9IGNvbnRyb2wuZmluZCggIm9wdGlvbiIgKTsKCgkJCWZvciAoIGkgPSAwLCBvcHRpb25zQ291bnQgPSBvcHRpb25zLmxlbmd0aDsgaSA8IG9wdGlvbnNDb3VudDsgaSsrICkgewoJCQkJc2lkZSA9ICFpID8gImIiIDogImEiOwoJCQkJYWN0aXZlQ2xhc3MgPSAhaSA/ICIiIDogIiAiICsgJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3M7CgkJCQlzbGlkZXJJbWcgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAic3BhbiIgKTsKCgkJCQlzbGlkZXJJbWcuY2xhc3NOYW1lID0gWyAidWktc2xpZGVyLWxhYmVsIHVpLXNsaWRlci1sYWJlbC0iLCBzaWRlLCBhY3RpdmVDbGFzcyBdLmpvaW4oICIiICk7CgkJCQlzbGlkZXJJbWcuc2V0QXR0cmlidXRlKCAicm9sZSIsICJpbWciICk7CgkJCQlzbGlkZXJJbWcuYXBwZW5kQ2hpbGQoIGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKCBvcHRpb25zW2ldLmlubmVySFRNTCApICk7CgkJCQkkKCBzbGlkZXJJbWcgKS5wcmVwZW5kVG8oIHNsaWRlciApOwoJCQl9CgoJCQlzZWxmLl9sYWJlbHMgPSAkKCAiLnVpLXNsaWRlci1sYWJlbCIsIHNsaWRlciApOwoKCQl9CgoJCS8vIG1vbml0b3IgdGhlIGlucHV0IGZvciB1cGRhdGVkIHZhbHVlcwoJCWNvbnRyb2wuYWRkQ2xhc3MoIGlzVG9nZ2xlU3dpdGNoID8gInVpLXNsaWRlci1zd2l0Y2giIDogInVpLXNsaWRlci1pbnB1dCIgKTsKCgkJdGhpcy5fb24oIGNvbnRyb2wsIHsKCQkJImNoYW5nZSI6ICJfY29udHJvbENoYW5nZSIsCgkJCSJrZXl1cCI6ICJfY29udHJvbEtleXVwIiwKCQkJImJsdXIiOiAiX2NvbnRyb2xCbHVyIiwKCQkJInZtb3VzZXVwIjogIl9jb250cm9sVk1vdXNlVXAiCgkJfSk7CgoJCXNsaWRlci5iaW5kKCAidm1vdXNlZG93biIsICQucHJveHkoIHRoaXMuX3NsaWRlclZNb3VzZURvd24sIHRoaXMgKSApCgkJCS5iaW5kKCAidmNsaWNrIiwgZmFsc2UgKTsKCgkJLy8gV2UgaGF2ZSB0byBpbnN0YW50aWF0ZSBhIG5ldyBmdW5jdGlvbiBvYmplY3QgZm9yIHRoZSB1bmJpbmQgdG8gd29yayBwcm9wZXJseQoJCS8vIHNpbmNlIHRoZSBtZXRob2QgaXRzZWxmIGlzIGRlZmluZWQgaW4gdGhlIHByb3RvdHlwZSAoY2F1c2luZyBpdCB0byB1bmJpbmQgZXZlcnl0aGluZykKCQl0aGlzLl9vbiggZG9jdW1lbnQsIHsgInZtb3VzZW1vdmUiOiAiX3ByZXZlbnREb2N1bWVudERyYWciIH0pOwoJCXRoaXMuX29uKCBzbGlkZXIuYWRkKCBkb2N1bWVudCApLCB7ICJ2bW91c2V1cCI6ICJfc2xpZGVyVk1vdXNlVXAiIH0pOwoKCQlzbGlkZXIuaW5zZXJ0QWZ0ZXIoIGNvbnRyb2wgKTsKCgkJLy8gd3JhcCBpbiBhIGRpdiBmb3Igc3R5bGluZyBwdXJwb3NlcwoJCWlmICggIWlzVG9nZ2xlU3dpdGNoICYmICFpc1Jhbmdlc2xpZGVyICkgewoJCQl3cmFwcGVyID0gdGhpcy5vcHRpb25zLm1pbmkgPyAiPGRpdiBjbGFzcz0ndWktc2xpZGVyIHVpLW1pbmknPiIgOiAiPGRpdiBjbGFzcz0ndWktc2xpZGVyJz4iOwoKCQkJY29udHJvbC5hZGQoIHNsaWRlciApLndyYXBBbGwoIHdyYXBwZXIgKTsKCQl9CgoJCS8vIGJpbmQgdGhlIGhhbmRsZSBldmVudCBjYWxsYmFja3MgYW5kIHNldCB0aGUgY29udGV4dCB0byB0aGUgd2lkZ2V0IGluc3RhbmNlCgkJdGhpcy5fb24oIHRoaXMuaGFuZGxlLCB7CgkJCSJ2bW91c2Vkb3duIjogIl9oYW5kbGVWTW91c2VEb3duIiwKCQkJImtleWRvd24iOiAiX2hhbmRsZUtleWRvd24iLAoJCQkia2V5dXAiOiAiX2hhbmRsZUtleXVwIgoJCX0pOwoKCQl0aGlzLmhhbmRsZS5iaW5kKCAidmNsaWNrIiwgZmFsc2UgKTsKCgkJdGhpcy5faGFuZGxlRm9ybVJlc2V0KCk7CgoJCXRoaXMucmVmcmVzaCggdW5kZWZpbmVkLCB1bmRlZmluZWQsIHRydWUgKTsKCX0sCgoJX3NldE9wdGlvbnM6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCWlmICggb3B0aW9ucy50aGVtZSAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLl9zZXRUaGVtZSggb3B0aW9ucy50aGVtZSApOwoJCX0KCgkJaWYgKCBvcHRpb25zLnRyYWNrVGhlbWUgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhpcy5fc2V0VHJhY2tUaGVtZSggb3B0aW9ucy50cmFja1RoZW1lICk7CgkJfQoKCQlpZiAoIG9wdGlvbnMuY29ybmVycyAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLl9zZXRDb3JuZXJzKCBvcHRpb25zLmNvcm5lcnMgKTsKCQl9CgoJCWlmICggb3B0aW9ucy5taW5pICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMuX3NldE1pbmkoIG9wdGlvbnMubWluaSApOwoJCX0KCgkJaWYgKCBvcHRpb25zLmhpZ2hsaWdodCAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLl9zZXRIaWdobGlnaHQoIG9wdGlvbnMuaGlnaGxpZ2h0ICk7CgkJfQoKCQlpZiAoIG9wdGlvbnMuZGlzYWJsZWQgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhpcy5fc2V0RGlzYWJsZWQoIG9wdGlvbnMuZGlzYWJsZWQgKTsKCQl9CgkJdGhpcy5fc3VwZXIoIG9wdGlvbnMgKTsKCX0sCgoJX2NvbnRyb2xDaGFuZ2U6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkvLyBpZiB0aGUgdXNlciBkcmFnZ2VkIHRoZSBoYW5kbGUsIHRoZSAiY2hhbmdlIiBldmVudCB3YXMgdHJpZ2dlcmVkIGZyb20gaW5zaWRlIHJlZnJlc2goKTsgZG9uJ3QgY2FsbCByZWZyZXNoKCkgYWdhaW4KCQlpZiAoIHRoaXMuX3RyaWdnZXIoICJjb250cm9sY2hhbmdlIiwgZXZlbnQgKSA9PT0gZmFsc2UgKSB7CgkJCXJldHVybiBmYWxzZTsKCQl9CgkJaWYgKCAhdGhpcy5tb3VzZU1vdmVkICkgewoJCQl0aGlzLnJlZnJlc2goIHRoaXMuX3ZhbHVlKCksIHRydWUgKTsKCQl9Cgl9LAoKCV9jb250cm9sS2V5dXA6IGZ1bmN0aW9uKC8qIGV2ZW50ICovKSB7IC8vIG5lY2Vzc2FyeT8KCQl0aGlzLnJlZnJlc2goIHRoaXMuX3ZhbHVlKCksIHRydWUsIHRydWUgKTsKCX0sCgoJX2NvbnRyb2xCbHVyOiBmdW5jdGlvbigvKiBldmVudCAqLykgewoJCXRoaXMucmVmcmVzaCggdGhpcy5fdmFsdWUoKSwgdHJ1ZSApOwoJfSwKCgkvLyBpdCBhcHBlYXJzIHRoZSBjbGlja2luZyB0aGUgdXAgYW5kIGRvd24gYnV0dG9ucyBpbiBjaHJvbWUgb24KCS8vIHJhbmdlL251bWJlciBpbnB1dHMgZG9lc24ndCB0cmlnZ2VyIGEgY2hhbmdlIHVudGlsIHRoZSBmaWVsZCBpcwoJLy8gYmx1cnJlZC4gSGVyZSB3ZSBjaGVjayB0aGlmIHRoZSB2YWx1ZSBoYXMgY2hhbmdlZCBhbmQgcmVmcmVzaAoJX2NvbnRyb2xWTW91c2VVcDogZnVuY3Rpb24oLyogZXZlbnQgKi8pIHsKCQl0aGlzLl9jaGVja2VkUmVmcmVzaCgpOwoJfSwKCgkvLyBOT1RFIGZvcmNlIGZvY3VzIG9uIGhhbmRsZQoJX2hhbmRsZVZNb3VzZURvd246IGZ1bmN0aW9uKC8qIGV2ZW50ICovKSB7CgkJdGhpcy5oYW5kbGUuZm9jdXMoKTsKCX0sCgoJX2hhbmRsZUtleWRvd246IGZ1bmN0aW9uKCBldmVudCApIHsKCQl2YXIgaW5kZXggPSB0aGlzLl92YWx1ZSgpOwoJCWlmICggdGhpcy5vcHRpb25zLmRpc2FibGVkICkgewoJCQlyZXR1cm47CgkJfQoKCQkvLyBJbiBhbGwgY2FzZXMgcHJldmVudCB0aGUgZGVmYXVsdCBhbmQgbWFyayB0aGUgaGFuZGxlIGFzIGFjdGl2ZQoJCXN3aXRjaCAoIGV2ZW50LmtleUNvZGUgKSB7CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5IT01FOgoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuRU5EOgoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuUEFHRV9VUDoKCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLlBBR0VfRE9XTjoKCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLlVQOgoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuUklHSFQ6CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5ET1dOOgoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuTEVGVDoKCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgoJCQkJaWYgKCAhdGhpcy5fa2V5U2xpZGluZyApIHsKCQkJCQl0aGlzLl9rZXlTbGlkaW5nID0gdHJ1ZTsKCQkJCQl0aGlzLmhhbmRsZS5hZGRDbGFzcyggInVpLXN0YXRlLWFjdGl2ZSIgKTsgLyogVE9ETzogV2UgZG9uJ3QgdXNlIHRoaXMgY2xhc3MgZm9yIHN0eWxpbmcuIERvIHdlIG5lZWQgdG8gYWRkIGl0PyAqLwoJCQkJfQoKCQkJCWJyZWFrOwoJCX0KCgkJLy8gbW92ZSB0aGUgc2xpZGVyIGFjY29yZGluZyB0byB0aGUga2V5cHJlc3MKCQlzd2l0Y2ggKCBldmVudC5rZXlDb2RlICkgewoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuSE9NRToKCQkJCXRoaXMucmVmcmVzaCggdGhpcy5taW4gKTsKCQkJCWJyZWFrOwoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuRU5EOgoJCQkJdGhpcy5yZWZyZXNoKCB0aGlzLm1heCApOwoJCQkJYnJlYWs7CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5QQUdFX1VQOgoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuVVA6CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5SSUdIVDoKCQkJCXRoaXMucmVmcmVzaCggaW5kZXggKyB0aGlzLnN0ZXAgKTsKCQkJCWJyZWFrOwoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuUEFHRV9ET1dOOgoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuRE9XTjoKCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLkxFRlQ6CgkJCQl0aGlzLnJlZnJlc2goIGluZGV4IC0gdGhpcy5zdGVwICk7CgkJCQlicmVhazsKCQl9Cgl9LCAvLyByZW1vdmUgYWN0aXZlIG1hcmsKCglfaGFuZGxlS2V5dXA6IGZ1bmN0aW9uKC8qIGV2ZW50ICovKSB7CgkJaWYgKCB0aGlzLl9rZXlTbGlkaW5nICkgewoJCQl0aGlzLl9rZXlTbGlkaW5nID0gZmFsc2U7CgkJCXRoaXMuaGFuZGxlLnJlbW92ZUNsYXNzKCAidWktc3RhdGUtYWN0aXZlIiApOyAvKiBTZWUgY29tbWVudCBhYm92ZS4gKi8KCQl9Cgl9LAoKCV9zbGlkZXJWTW91c2VEb3duOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJLy8gTk9URTogd2UgZG9uJ3QgZG8gdGhpcyBpbiByZWZyZXNoIGJlY2F1c2Ugd2Ugc3RpbGwgd2FudCB0bwoJCS8vICAgICAgIHN1cHBvcnQgcHJvZ3JhbW1hdGljIGFsdGVyYXRpb24gb2YgZGlzYWJsZWQgaW5wdXRzCgkJaWYgKCB0aGlzLm9wdGlvbnMuZGlzYWJsZWQgfHwgISggZXZlbnQud2hpY2ggPT09IDEgfHwgZXZlbnQud2hpY2ggPT09IDAgfHwgZXZlbnQud2hpY2ggPT09IHVuZGVmaW5lZCApICkgewoJCQlyZXR1cm4gZmFsc2U7CgkJfQoJCWlmICggdGhpcy5fdHJpZ2dlciggImJlZm9yZXN0YXJ0IiwgZXZlbnQgKSA9PT0gZmFsc2UgKSB7CgkJCXJldHVybiBmYWxzZTsKCQl9CgkJdGhpcy5kcmFnZ2luZyA9IHRydWU7CgkJdGhpcy51c2VyTW9kaWZpZWQgPSBmYWxzZTsKCQl0aGlzLm1vdXNlTW92ZWQgPSBmYWxzZTsKCgkJaWYgKCB0aGlzLmlzVG9nZ2xlU3dpdGNoICkgewoJCQl0aGlzLmJlZm9yZVN0YXJ0ID0gdGhpcy5lbGVtZW50WzBdLnNlbGVjdGVkSW5kZXg7CgkJfQoKCQl0aGlzLnJlZnJlc2goIGV2ZW50ICk7CgkJdGhpcy5fdHJpZ2dlciggInN0YXJ0IiApOwoJCXJldHVybiBmYWxzZTsKCX0sCgoJX3NsaWRlclZNb3VzZVVwOiBmdW5jdGlvbigpIHsKCQlpZiAoIHRoaXMuZHJhZ2dpbmcgKSB7CgkJCXRoaXMuZHJhZ2dpbmcgPSBmYWxzZTsKCgkJCWlmICggdGhpcy5pc1RvZ2dsZVN3aXRjaCApIHsKCQkJCS8vIG1ha2UgdGhlIGhhbmRsZSBtb3ZlIHdpdGggYSBzbW9vdGggdHJhbnNpdGlvbgoJCQkJdGhpcy5oYW5kbGUuYWRkQ2xhc3MoICJ1aS1zbGlkZXItaGFuZGxlLXNuYXBwaW5nIiApOwoKCQkJCWlmICggdGhpcy5tb3VzZU1vdmVkICkgewoJCQkJCS8vIHRoaXMgaXMgYSBkcmFnLCBjaGFuZ2UgdGhlIHZhbHVlIG9ubHkgaWYgdXNlciBkcmFnZ2VkIGVub3VnaAoJCQkJCWlmICggdGhpcy51c2VyTW9kaWZpZWQgKSB7CgkJCQkJCXRoaXMucmVmcmVzaCggdGhpcy5iZWZvcmVTdGFydCA9PT0gMCA/IDEgOiAwICk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJdGhpcy5yZWZyZXNoKCB0aGlzLmJlZm9yZVN0YXJ0ICk7CgkJCQkJfQoJCQkJfSBlbHNlIHsKCQkJCQkvLyB0aGlzIGlzIGp1c3QgYSBjbGljaywgY2hhbmdlIHRoZSB2YWx1ZQoJCQkJCXRoaXMucmVmcmVzaCggdGhpcy5iZWZvcmVTdGFydCA9PT0gMCA/IDEgOiAwICk7CgkJCQl9CgkJCX0KCgkJCXRoaXMubW91c2VNb3ZlZCA9IGZhbHNlOwoJCQl0aGlzLl90cmlnZ2VyKCAic3RvcCIgKTsKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCX0sCgoJX3ByZXZlbnREb2N1bWVudERyYWc6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJLy8gTk9URTogd2UgZG9uJ3QgZG8gdGhpcyBpbiByZWZyZXNoIGJlY2F1c2Ugd2Ugc3RpbGwgd2FudCB0bwoJCQkvLyAgICAgICBzdXBwb3J0IHByb2dyYW1tYXRpYyBhbHRlcmF0aW9uIG9mIGRpc2FibGVkIGlucHV0cwoJCQlpZiAoIHRoaXMuX3RyaWdnZXIoICJkcmFnIiwgZXZlbnQgKSA9PT0gZmFsc2UpIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoJCQlpZiAoIHRoaXMuZHJhZ2dpbmcgJiYgIXRoaXMub3B0aW9ucy5kaXNhYmxlZCApIHsKCgkJCQkvLyB0aGlzLm1vdXNlTW92ZWQgbXVzdCBiZSB1cGRhdGVkIGJlZm9yZSByZWZyZXNoKCkgYmVjYXVzZSBpdCB3aWxsIGJlIHVzZWQgaW4gdGhlIGNvbnRyb2wgImNoYW5nZSIgZXZlbnQKCQkJCXRoaXMubW91c2VNb3ZlZCA9IHRydWU7CgoJCQkJaWYgKCB0aGlzLmlzVG9nZ2xlU3dpdGNoICkgewoJCQkJCS8vIG1ha2UgdGhlIGhhbmRsZSBtb3ZlIGluIHN5bmMgd2l0aCB0aGUgbW91c2UKCQkJCQl0aGlzLmhhbmRsZS5yZW1vdmVDbGFzcyggInVpLXNsaWRlci1oYW5kbGUtc25hcHBpbmciICk7CgkJCQl9CgoJCQkJdGhpcy5yZWZyZXNoKCBldmVudCApOwoKCQkJCS8vIG9ubHkgYWZ0ZXIgcmVmcmVzaCgpIHlvdSBjYW4gY2FsY3VsYXRlIHRoaXMudXNlck1vZGlmaWVkCgkJCQl0aGlzLnVzZXJNb2RpZmllZCA9IHRoaXMuYmVmb3JlU3RhcnQgIT09IHRoaXMuZWxlbWVudFswXS5zZWxlY3RlZEluZGV4OwoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgkJfSwKCglfY2hlY2tlZFJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCWlmICggdGhpcy52YWx1ZSAhPT0gdGhpcy5fdmFsdWUoKSApIHsKCQkJdGhpcy5yZWZyZXNoKCB0aGlzLl92YWx1ZSgpICk7CgkJfQoJfSwKCglfdmFsdWU6IGZ1bmN0aW9uKCkgewoJCXJldHVybiAgdGhpcy5pc1RvZ2dsZVN3aXRjaCA/IHRoaXMuZWxlbWVudFswXS5zZWxlY3RlZEluZGV4IDogcGFyc2VGbG9hdCggdGhpcy5lbGVtZW50LnZhbCgpICkgOwoJfSwKCgoJX3Jlc2V0OiBmdW5jdGlvbigpIHsKCQl0aGlzLnJlZnJlc2goIHVuZGVmaW5lZCwgZmFsc2UsIHRydWUgKTsKCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oIHZhbCwgaXNmcm9tQ29udHJvbCwgcHJldmVudElucHV0VXBkYXRlICkgewoJCS8vIE5PVEU6IHdlIGRvbid0IHJldHVybiBoZXJlIGJlY2F1c2Ugd2Ugd2FudCB0byBzdXBwb3J0IHByb2dyYW1tYXRpYwoJCS8vICAgICAgIGFsdGVyYXRpb24gb2YgdGhlIGlucHV0IHZhbHVlLCB3aGljaCBzaG91bGQgc3RpbGwgdXBkYXRlIHRoZSBzbGlkZXIKCgkJdmFyIHNlbGYgPSB0aGlzLAoJCQlwYXJlbnRUaGVtZSA9ICQubW9iaWxlLmdldEF0dHJpYnV0ZSggdGhpcy5lbGVtZW50WyAwIF0sICJ0aGVtZSIgKSwKCQkJdGhlbWUgPSB0aGlzLm9wdGlvbnMudGhlbWUgfHwgcGFyZW50VGhlbWUsCgkJCXRoZW1lQ2xhc3MgPSAgdGhlbWUgPyAiIHVpLWJ0bi0iICsgdGhlbWUgOiAiIiwKCQkJdHJhY2tUaGVtZSA9IHRoaXMub3B0aW9ucy50cmFja1RoZW1lIHx8IHBhcmVudFRoZW1lLAoJCQl0cmFja1RoZW1lQ2xhc3MgPSB0cmFja1RoZW1lID8gIiB1aS1iYXItIiArIHRyYWNrVGhlbWUgOiAiIHVpLWJhci1pbmhlcml0IiwKCQkJY29ybmVyQ2xhc3MgPSB0aGlzLm9wdGlvbnMuY29ybmVycyA/ICIgdWktY29ybmVyLWFsbCIgOiAiIiwKCQkJbWluaUNsYXNzID0gdGhpcy5vcHRpb25zLm1pbmkgPyAiIHVpLW1pbmkiIDogIiIsCgkJCWxlZnQsIHdpZHRoLCBkYXRhLCB0b2wsCgkJCXB4U3RlcCwgcGVyY2VudCwKCQkJY29udHJvbCwgaXNJbnB1dCwgb3B0aW9uRWxlbWVudHMsIG1pbiwgbWF4LCBzdGVwLAoJCQluZXd2YWwsIHZhbE1vZFN0ZXAsIGFsaWduVmFsdWUsIHBlcmNlbnRQZXJTdGVwLAoJCQloYW5kbGVQZXJjZW50LCBhUGVyY2VudCwgYlBlcmNlbnQsCgkJCXZhbHVlQ2hhbmdlZDsKCgkJc2VsZi5zbGlkZXJbMF0uY2xhc3NOYW1lID0gWyB0aGlzLmlzVG9nZ2xlU3dpdGNoID8gInVpLXNsaWRlciB1aS1zbGlkZXItc3dpdGNoIHVpLXNsaWRlci10cmFjayB1aS1zaGFkb3ctaW5zZXQiIDogInVpLXNsaWRlci10cmFjayB1aS1zaGFkb3ctaW5zZXQiLCB0cmFja1RoZW1lQ2xhc3MsIGNvcm5lckNsYXNzLCBtaW5pQ2xhc3MgXS5qb2luKCAiIiApOwoJCWlmICggdGhpcy5vcHRpb25zLmRpc2FibGVkIHx8IHRoaXMuZWxlbWVudC5wcm9wKCAiZGlzYWJsZWQiICkgKSB7CgkJCXRoaXMuZGlzYWJsZSgpOwoJCX0KCgkJLy8gc2V0IHRoZSBzdG9yZWQgdmFsdWUgZm9yIGNvbXBhcmlzb24gbGF0ZXIKCQl0aGlzLnZhbHVlID0gdGhpcy5fdmFsdWUoKTsKCQlpZiAoIHRoaXMub3B0aW9ucy5oaWdobGlnaHQgJiYgIXRoaXMuaXNUb2dnbGVTd2l0Y2ggJiYgdGhpcy5zbGlkZXIuZmluZCggIi51aS1zbGlkZXItYmciICkubGVuZ3RoID09PSAwICkgewoJCQl0aGlzLnZhbHVlYmcgPSAoZnVuY3Rpb24oKSB7CgkJCQl2YXIgYmcgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiZGl2IiApOwoJCQkJYmcuY2xhc3NOYW1lID0gInVpLXNsaWRlci1iZyAiICsgJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3M7CgkJCQlyZXR1cm4gJCggYmcgKS5wcmVwZW5kVG8oIHNlbGYuc2xpZGVyICk7CgkJCX0pKCk7CgkJfQoJCXRoaXMuaGFuZGxlLmFkZENsYXNzKCAidWktYnRuIiArIHRoZW1lQ2xhc3MgKyAiIHVpLXNoYWRvdyIgKTsKCgkJY29udHJvbCA9IHRoaXMuZWxlbWVudDsKCQlpc0lucHV0ID0gIXRoaXMuaXNUb2dnbGVTd2l0Y2g7CgkJb3B0aW9uRWxlbWVudHMgPSBpc0lucHV0ID8gW10gOiBjb250cm9sLmZpbmQoICJvcHRpb24iICk7CgkJbWluID0gIGlzSW5wdXQgPyBwYXJzZUZsb2F0KCBjb250cm9sLmF0dHIoICJtaW4iICkgKSA6IDA7CgkJbWF4ID0gaXNJbnB1dCA/IHBhcnNlRmxvYXQoIGNvbnRyb2wuYXR0ciggIm1heCIgKSApIDogb3B0aW9uRWxlbWVudHMubGVuZ3RoIC0gMTsKCQlzdGVwID0gKCBpc0lucHV0ICYmIHBhcnNlRmxvYXQoIGNvbnRyb2wuYXR0ciggInN0ZXAiICkgKSA+IDAgKSA/IHBhcnNlRmxvYXQoIGNvbnRyb2wuYXR0ciggInN0ZXAiICkgKSA6IDE7CgoJCWlmICggdHlwZW9mIHZhbCA9PT0gIm9iamVjdCIgKSB7CgkJCWRhdGEgPSB2YWw7CgkJCS8vIGEgc2xpZ2h0IHRvbGVyYW5jZSBoZWxwZWQgZ2V0IHRvIHRoZSBlbmRzIG9mIHRoZSBzbGlkZXIKCQkJdG9sID0gODsKCgkJCWxlZnQgPSB0aGlzLnNsaWRlci5vZmZzZXQoKS5sZWZ0OwoJCQl3aWR0aCA9IHRoaXMuc2xpZGVyLndpZHRoKCk7CgkJCXB4U3RlcCA9IHdpZHRoLygobWF4LW1pbikvc3RlcCk7CgkJCWlmICggIXRoaXMuZHJhZ2dpbmcgfHwKCQkJCQlkYXRhLnBhZ2VYIDwgbGVmdCAtIHRvbCB8fAoJCQkJCWRhdGEucGFnZVggPiBsZWZ0ICsgd2lkdGggKyB0b2wgKSB7CgkJCQlyZXR1cm47CgkJCX0KCQkJaWYgKCBweFN0ZXAgPiAxICkgewoJCQkJcGVyY2VudCA9ICggKCBkYXRhLnBhZ2VYIC0gbGVmdCApIC8gd2lkdGggKSAqIDEwMDsKCQkJfSBlbHNlIHsKCQkJCXBlcmNlbnQgPSBNYXRoLnJvdW5kKCAoICggZGF0YS5wYWdlWCAtIGxlZnQgKSAvIHdpZHRoICkgKiAxMDAgKTsKCQkJfQoJCX0gZWxzZSB7CgkJCWlmICggdmFsID09IG51bGwgKSB7CgkJCQl2YWwgPSBpc0lucHV0ID8gcGFyc2VGbG9hdCggY29udHJvbC52YWwoKSB8fCAwICkgOiBjb250cm9sWzBdLnNlbGVjdGVkSW5kZXg7CgkJCX0KCQkJcGVyY2VudCA9ICggcGFyc2VGbG9hdCggdmFsICkgLSBtaW4gKSAvICggbWF4IC0gbWluICkgKiAxMDA7CgkJfQoKCQlpZiAoIGlzTmFOKCBwZXJjZW50ICkgKSB7CgkJCXJldHVybjsKCQl9CgoJCW5ld3ZhbCA9ICggcGVyY2VudCAvIDEwMCApICogKCBtYXggLSBtaW4gKSArIG1pbjsKCgkJLy9mcm9tIGpRdWVyeSBVSSBzbGlkZXIsIHRoZSBmb2xsb3dpbmcgc291cmNlIHdpbGwgcm91bmQgdG8gdGhlIG5lYXJlc3Qgc3RlcAoJCXZhbE1vZFN0ZXAgPSAoIG5ld3ZhbCAtIG1pbiApICUgc3RlcDsKCQlhbGlnblZhbHVlID0gbmV3dmFsIC0gdmFsTW9kU3RlcDsKCgkJaWYgKCBNYXRoLmFicyggdmFsTW9kU3RlcCApICogMiA+PSBzdGVwICkgewoJCQlhbGlnblZhbHVlICs9ICggdmFsTW9kU3RlcCA+IDAgKSA/IHN0ZXAgOiAoIC1zdGVwICk7CgkJfQoKCQlwZXJjZW50UGVyU3RlcCA9IDEwMC8oKG1heC1taW4pL3N0ZXApOwoJCS8vIFNpbmNlIEphdmFTY3JpcHQgaGFzIHByb2JsZW1zIHdpdGggbGFyZ2UgZmxvYXRzLCByb3VuZAoJCS8vIHRoZSBmaW5hbCB2YWx1ZSB0byA1IGRpZ2l0cyBhZnRlciB0aGUgZGVjaW1hbCBwb2ludCAoc2VlIGpRdWVyeVVJOiAjNDEyNCkKCQluZXd2YWwgPSBwYXJzZUZsb2F0KCBhbGlnblZhbHVlLnRvRml4ZWQoNSkgKTsKCgkJaWYgKCB0eXBlb2YgcHhTdGVwID09PSAidW5kZWZpbmVkIiApIHsKCQkJcHhTdGVwID0gd2lkdGggLyAoIChtYXgtbWluKSAvIHN0ZXAgKTsKCQl9CgkJaWYgKCBweFN0ZXAgPiAxICYmIGlzSW5wdXQgKSB7CgkJCXBlcmNlbnQgPSAoIG5ld3ZhbCAtIG1pbiApICogcGVyY2VudFBlclN0ZXAgKiAoIDEgLyBzdGVwICk7CgkJfQoJCWlmICggcGVyY2VudCA8IDAgKSB7CgkJCXBlcmNlbnQgPSAwOwoJCX0KCgkJaWYgKCBwZXJjZW50ID4gMTAwICkgewoJCQlwZXJjZW50ID0gMTAwOwoJCX0KCgkJaWYgKCBuZXd2YWwgPCBtaW4gKSB7CgkJCW5ld3ZhbCA9IG1pbjsKCQl9CgoJCWlmICggbmV3dmFsID4gbWF4ICkgewoJCQluZXd2YWwgPSBtYXg7CgkJfQoKCQl0aGlzLmhhbmRsZS5jc3MoICJsZWZ0IiwgcGVyY2VudCArICIlIiApOwoKCQl0aGlzLmhhbmRsZVswXS5zZXRBdHRyaWJ1dGUoICJhcmlhLXZhbHVlbm93IiwgaXNJbnB1dCA/IG5ld3ZhbCA6IG9wdGlvbkVsZW1lbnRzLmVxKCBuZXd2YWwgKS5hdHRyKCAidmFsdWUiICkgKTsKCgkJdGhpcy5oYW5kbGVbMF0uc2V0QXR0cmlidXRlKCAiYXJpYS12YWx1ZXRleHQiLCBpc0lucHV0ID8gbmV3dmFsIDogb3B0aW9uRWxlbWVudHMuZXEoIG5ld3ZhbCApLmdldEVuY29kZWRUZXh0KCkgKTsKCgkJdGhpcy5oYW5kbGVbMF0uc2V0QXR0cmlidXRlKCAidGl0bGUiLCBpc0lucHV0ID8gbmV3dmFsIDogb3B0aW9uRWxlbWVudHMuZXEoIG5ld3ZhbCApLmdldEVuY29kZWRUZXh0KCkgKTsKCgkJaWYgKCB0aGlzLnZhbHVlYmcgKSB7CgkJCXRoaXMudmFsdWViZy5jc3MoICJ3aWR0aCIsIHBlcmNlbnQgKyAiJSIgKTsKCQl9CgoJCS8vIGRyYWcgdGhlIGxhYmVsIHdpZHRocwoJCWlmICggdGhpcy5fbGFiZWxzICkgewoJCQloYW5kbGVQZXJjZW50ID0gdGhpcy5oYW5kbGUud2lkdGgoKSAvIHRoaXMuc2xpZGVyLndpZHRoKCkgKiAxMDA7CgkJCWFQZXJjZW50ID0gcGVyY2VudCAmJiBoYW5kbGVQZXJjZW50ICsgKCAxMDAgLSBoYW5kbGVQZXJjZW50ICkgKiBwZXJjZW50IC8gMTAwOwoJCQliUGVyY2VudCA9IHBlcmNlbnQgPT09IDEwMCA/IDAgOiBNYXRoLm1pbiggaGFuZGxlUGVyY2VudCArIDEwMCAtIGFQZXJjZW50LCAxMDAgKTsKCgkJCXRoaXMuX2xhYmVscy5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJdmFyIGFiID0gJCggdGhpcyApLmhhc0NsYXNzKCAidWktc2xpZGVyLWxhYmVsLWEiICk7CgkJCQkkKCB0aGlzICkud2lkdGgoICggYWIgPyBhUGVyY2VudCA6IGJQZXJjZW50ICApICsgIiUiICk7CgkJCX0pOwoJCX0KCgkJaWYgKCAhcHJldmVudElucHV0VXBkYXRlICkgewoJCQl2YWx1ZUNoYW5nZWQgPSBmYWxzZTsKCgkJCS8vIHVwZGF0ZSBjb250cm9sInMgdmFsdWUKCQkJaWYgKCBpc0lucHV0ICkgewoJCQkJdmFsdWVDaGFuZ2VkID0gY29udHJvbC52YWwoKSAhPT0gbmV3dmFsOwoJCQkJY29udHJvbC52YWwoIG5ld3ZhbCApOwoJCQl9IGVsc2UgewoJCQkJdmFsdWVDaGFuZ2VkID0gY29udHJvbFsgMCBdLnNlbGVjdGVkSW5kZXggIT09IG5ld3ZhbDsKCQkJCWNvbnRyb2xbIDAgXS5zZWxlY3RlZEluZGV4ID0gbmV3dmFsOwoJCQl9CgkJCWlmICggdGhpcy5fdHJpZ2dlciggImJlZm9yZWNoYW5nZSIsIHZhbCApID09PSBmYWxzZSkgewoJCQkJCXJldHVybiBmYWxzZTsKCQkJfQoJCQlpZiAoICFpc2Zyb21Db250cm9sICYmIHZhbHVlQ2hhbmdlZCApIHsKCQkJCWNvbnRyb2wudHJpZ2dlciggImNoYW5nZSIgKTsKCQkJfQoJCX0KCX0sCgoJX3NldEhpZ2hsaWdodDogZnVuY3Rpb24oIHZhbHVlICkgewoJCXZhbHVlID0gISF2YWx1ZTsKCQlpZiAoIHZhbHVlICkgewoJCQl0aGlzLm9wdGlvbnMuaGlnaGxpZ2h0ID0gISF2YWx1ZTsKCQkJdGhpcy5yZWZyZXNoKCk7CgkJfSBlbHNlIGlmICggdGhpcy52YWx1ZWJnICkgewoJCQl0aGlzLnZhbHVlYmcucmVtb3ZlKCk7CgkJCXRoaXMudmFsdWViZyA9IGZhbHNlOwoJCX0KCX0sCgoJX3NldFRoZW1lOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJdGhpcy5oYW5kbGUKCQkJLnJlbW92ZUNsYXNzKCAidWktYnRuLSIgKyB0aGlzLm9wdGlvbnMudGhlbWUgKQoJCQkuYWRkQ2xhc3MoICJ1aS1idG4tIiArIHZhbHVlICk7CgoJCXZhciBjdXJyZW50VGhlbWUgPSB0aGlzLm9wdGlvbnMudGhlbWUgPyB0aGlzLm9wdGlvbnMudGhlbWUgOiAiaW5oZXJpdCIsCgkJCW5ld1RoZW1lID0gdmFsdWUgPyB2YWx1ZSA6ICJpbmhlcml0IjsKCgkJdGhpcy5jb250cm9sCgkJCS5yZW1vdmVDbGFzcyggInVpLWJvZHktIiArIGN1cnJlbnRUaGVtZSApCgkJCS5hZGRDbGFzcyggInVpLWJvZHktIiArIG5ld1RoZW1lICk7Cgl9LAoKCV9zZXRUcmFja1RoZW1lOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJdmFyIGN1cnJlbnRUcmFja1RoZW1lID0gdGhpcy5vcHRpb25zLnRyYWNrVGhlbWUgPyB0aGlzLm9wdGlvbnMudHJhY2tUaGVtZSA6ICJpbmhlcml0IiwKCQkJbmV3VHJhY2tUaGVtZSA9IHZhbHVlID8gdmFsdWUgOiAiaW5oZXJpdCI7CgoJCXRoaXMuc2xpZGVyCgkJCS5yZW1vdmVDbGFzcyggInVpLWJvZHktIiArIGN1cnJlbnRUcmFja1RoZW1lICkKCQkJLmFkZENsYXNzKCAidWktYm9keS0iICsgbmV3VHJhY2tUaGVtZSApOwoJfSwKCglfc2V0TWluaTogZnVuY3Rpb24oIHZhbHVlICkgewoJCXZhbHVlID0gISF2YWx1ZTsKCQlpZiAoICF0aGlzLmlzVG9nZ2xlU3dpdGNoICYmICF0aGlzLmlzUmFuZ2VzbGlkZXIgKSB7CgkJCXRoaXMuc2xpZGVyLnBhcmVudCgpLnRvZ2dsZUNsYXNzKCAidWktbWluaSIsIHZhbHVlICk7CgkJCXRoaXMuZWxlbWVudC50b2dnbGVDbGFzcyggInVpLW1pbmkiLCB2YWx1ZSApOwoJCX0KCQl0aGlzLnNsaWRlci50b2dnbGVDbGFzcyggInVpLW1pbmkiLCB2YWx1ZSApOwoJfSwKCglfc2V0Q29ybmVyczogZnVuY3Rpb24oIHZhbHVlICkgewoJCXRoaXMuc2xpZGVyLnRvZ2dsZUNsYXNzKCAidWktY29ybmVyLWFsbCIsIHZhbHVlICk7CgoJCWlmICggIXRoaXMuaXNUb2dnbGVTd2l0Y2ggKSB7CgkJCXRoaXMuY29udHJvbC50b2dnbGVDbGFzcyggInVpLWNvcm5lci1hbGwiLCB2YWx1ZSApOwoJCX0KCX0sCgoJX3NldERpc2FibGVkOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJdmFsdWUgPSAhIXZhbHVlOwoJCXRoaXMuZWxlbWVudC5wcm9wKCAiZGlzYWJsZWQiLCB2YWx1ZSApOwoJCXRoaXMuc2xpZGVyLnRvZ2dsZUNsYXNzKCAidWktc3RhdGUtZGlzYWJsZWQiICkuYXR0ciggImFyaWEtZGlzYWJsZWQiLCB2YWx1ZSApOwoJfQoKfSwgJC5tb2JpbGUuYmVoYXZpb3JzLmZvcm1SZXNldCApICk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCnZhciBwb3B1cDsKCmZ1bmN0aW9uIGdldFBvcHVwKCkgewoJaWYgKCAhcG9wdXAgKSB7CgkJcG9wdXAgPSAkKCAiPGRpdj48L2Rpdj4iLCB7CgkJCSJjbGFzcyI6ICJ1aS1zbGlkZXItcG9wdXAgdWktc2hhZG93IHVpLWNvcm5lci1hbGwiCgkJfSk7Cgl9CglyZXR1cm4gcG9wdXAuY2xvbmUoKTsKfQoKJC53aWRnZXQoICJtb2JpbGUuc2xpZGVyIiwgJC5tb2JpbGUuc2xpZGVyLCB7CglvcHRpb25zOiB7CgkJcG9wdXBFbmFibGVkOiBmYWxzZSwKCQlzaG93VmFsdWU6IGZhbHNlCgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3N1cGVyKCk7CgoJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCV9jdXJyZW50VmFsdWU6IG51bGwsCgkJCV9wb3B1cDogbnVsbCwKCQkJX3BvcHVwVmlzaWJsZTogZmFsc2UKCQl9KTsKCgkJdGhpcy5fc2V0T3B0aW9uKCAicG9wdXBFbmFibGVkIiwgdGhpcy5vcHRpb25zLnBvcHVwRW5hYmxlZCApOwoKCQl0aGlzLl9vbiggdGhpcy5oYW5kbGUsIHsgInZtb3VzZWRvd24iIDogIl9zaG93UG9wdXAiIH0gKTsKCQl0aGlzLl9vbiggdGhpcy5zbGlkZXIuYWRkKCB0aGlzLmRvY3VtZW50ICksIHsgInZtb3VzZXVwIiA6ICJfaGlkZVBvcHVwIiB9ICk7CgkJdGhpcy5fcmVmcmVzaCgpOwoJfSwKCgkvLyBwb3NpdGlvbiB0aGUgcG9wdXAgY2VudGVyZWQgNXB4IGFib3ZlIHRoZSBoYW5kbGUKCV9wb3NpdGlvblBvcHVwOiBmdW5jdGlvbigpIHsKCQl2YXIgZHN0T2Zmc2V0ID0gdGhpcy5oYW5kbGUub2Zmc2V0KCk7CgoJCXRoaXMuX3BvcHVwLm9mZnNldCggewoJCQlsZWZ0OiBkc3RPZmZzZXQubGVmdCArICggdGhpcy5oYW5kbGUud2lkdGgoKSAtIHRoaXMuX3BvcHVwLndpZHRoKCkgKSAvIDIsCgkJCXRvcDogZHN0T2Zmc2V0LnRvcCAtIHRoaXMuX3BvcHVwLm91dGVySGVpZ2h0KCkgLSA1CgkJfSk7Cgl9LAoKCV9zZXRPcHRpb246IGZ1bmN0aW9uKCBrZXksIHZhbHVlICkgewoJCXRoaXMuX3N1cGVyKCBrZXksIHZhbHVlICk7CgoJCWlmICgga2V5ID09PSAic2hvd1ZhbHVlIiApIHsKCQkJdGhpcy5oYW5kbGUuaHRtbCggdmFsdWUgJiYgIXRoaXMub3B0aW9ucy5taW5pID8gdGhpcy5fdmFsdWUoKSA6ICIiICk7CgkJfSBlbHNlIGlmICgga2V5ID09PSAicG9wdXBFbmFibGVkIiApIHsKCQkJaWYgKCB2YWx1ZSAmJiAhdGhpcy5fcG9wdXAgKSB7CgkJCQl0aGlzLl9wb3B1cCA9IGdldFBvcHVwKCkKCQkJCQkuYWRkQ2xhc3MoICJ1aS1ib2R5LSIgKyAoIHRoaXMub3B0aW9ucy50aGVtZSB8fCAiYSIgKSApCgkJCQkJLmluc2VydEJlZm9yZSggdGhpcy5lbGVtZW50ICk7CgkJCX0KCQl9Cgl9LAoKCS8vIHNob3cgdmFsdWUgb24gdGhlIGhhbmRsZSBhbmQgaW4gcG9wdXAKCXJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3N1cGVyLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsKCQl0aGlzLl9yZWZyZXNoKCk7Cgl9LAoKCV9yZWZyZXNoOiBmdW5jdGlvbigpIHsKCQl2YXIgbyA9IHRoaXMub3B0aW9ucywgbmV3VmFsdWU7CgoJCWlmICggby5wb3B1cEVuYWJsZWQgKSB7CgkJCS8vIHJlbW92ZSB0aGUgdGl0bGUgYXR0cmlidXRlIGZyb20gdGhlIGhhbmRsZSAod2hpY2ggaXMKCQkJLy8gcmVzcG9uc2libGUgZm9yIHRoZSBhbm5veWluZyB0b29sdGlwKTsgTkIgd2UgaGF2ZQoJCQkvLyB0byBkbyBpdCBoZXJlIGFzIHRoZSBqcW0gc2xpZGVyIHNldHMgaXQgZXZlcnkgdGltZQoJCQkvLyB0aGUgc2xpZGVyJ3MgdmFsdWUgY2hhbmdlcyA6KAoJCQl0aGlzLmhhbmRsZS5yZW1vdmVBdHRyKCAidGl0bGUiICk7CgkJfQoKCQluZXdWYWx1ZSA9IHRoaXMuX3ZhbHVlKCk7CgkJaWYgKCBuZXdWYWx1ZSA9PT0gdGhpcy5fY3VycmVudFZhbHVlICkgewoJCQlyZXR1cm47CgkJfQoJCXRoaXMuX2N1cnJlbnRWYWx1ZSA9IG5ld1ZhbHVlOwoKCQlpZiAoIG8ucG9wdXBFbmFibGVkICYmIHRoaXMuX3BvcHVwICkgewoJCQl0aGlzLl9wb3NpdGlvblBvcHVwKCk7CgkJCXRoaXMuX3BvcHVwLmh0bWwoIG5ld1ZhbHVlICk7CgkJfSBlbHNlIGlmICggby5zaG93VmFsdWUgJiYgIXRoaXMub3B0aW9ucy5taW5pICkgewoJCQl0aGlzLmhhbmRsZS5odG1sKCBuZXdWYWx1ZSApOwoJCX0KCX0sCgoJX3Nob3dQb3B1cDogZnVuY3Rpb24oKSB7CgkJaWYgKCB0aGlzLm9wdGlvbnMucG9wdXBFbmFibGVkICYmICF0aGlzLl9wb3B1cFZpc2libGUgKSB7CgkJCXRoaXMuaGFuZGxlLmh0bWwoICIiICk7CgkJCXRoaXMuX3BvcHVwLnNob3coKTsKCQkJdGhpcy5fcG9zaXRpb25Qb3B1cCgpOwoJCQl0aGlzLl9wb3B1cFZpc2libGUgPSB0cnVlOwoJCX0KCX0sCgoJX2hpZGVQb3B1cDogZnVuY3Rpb24oKSB7CgkJdmFyIG8gPSB0aGlzLm9wdGlvbnM7CgoJCWlmICggby5wb3B1cEVuYWJsZWQgJiYgdGhpcy5fcG9wdXBWaXNpYmxlICkgewoJCQlpZiAoIG8uc2hvd1ZhbHVlICYmICFvLm1pbmkgKSB7CgkJCQl0aGlzLmhhbmRsZS5odG1sKCB0aGlzLl92YWx1ZSgpICk7CgkJCX0KCQkJdGhpcy5fcG9wdXAuaGlkZSgpOwoJCQl0aGlzLl9wb3B1cFZpc2libGUgPSBmYWxzZTsKCQl9Cgl9Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS5mbGlwc3dpdGNoIiwgJC5leHRlbmQoewoKCW9wdGlvbnM6IHsKCQlvblRleHQ6ICJPbiIsCgkJb2ZmVGV4dDogIk9mZiIsCgkJdGhlbWU6IG51bGwsCgkJZW5oYW5jZWQ6IGZhbHNlLAoJCXdyYXBwZXJDbGFzczogbnVsbCwKCQltaW5pOiBmYWxzZQoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQkJaWYgKCAhdGhpcy5vcHRpb25zLmVuaGFuY2VkICkgewoJCQkJdGhpcy5fZW5oYW5jZSgpOwoJCQl9IGVsc2UgewoJCQkJJC5leHRlbmQoIHRoaXMsIHsKCQkJCQlmbGlwc3dpdGNoOiB0aGlzLmVsZW1lbnQucGFyZW50KCksCgkJCQkJb246IHRoaXMuZWxlbWVudC5maW5kKCAiLnVpLWZsaXBzd2l0Y2gtb24iICkuZXEoIDAgKSwKCQkJCQlvZmY6IHRoaXMuZWxlbWVudC5maW5kKCAiLnVpLWZsaXBzd2l0Y2gtb2ZmIiApLmVxKDApLAoJCQkJCXR5cGU6IHRoaXMuZWxlbWVudC5nZXQoIDAgKS50YWdOYW1lCgkJCQl9KTsKCQkJfQoKCQkJaWYoIHRoaXMuZWxlbWVudC5pcyggIjpkaXNhYmxlZCIgKSApewoJCQkJdGhpcy5fc2V0T3B0aW9ucyh7CgkJCQkJImRpc2FibGVkIjogdHJ1ZQoJCQkJfSk7CgkJCX0KCgkJCXRoaXMuX29uKCB0aGlzLmZsaXBzd2l0Y2gsIHsKCQkJCSJjbGljayI6ICJfdG9nZ2xlIiwKCQkJCSJzd2lwZWxlZnQiOiAiX2xlZnQiLAoJCQkJInN3aXBlcmlnaHQiOiAiX3JpZ2h0IgoJCQl9KTsKCgkJCXRoaXMuX29uKCB0aGlzLm9uLCB7CgkJCQkia2V5ZG93biI6ICJfa2V5ZG93biIKCQkJfSk7Cgl9LAoKCXdpZGdldDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuZmxpcHN3aXRjaDsKCX0sCgoJX2xlZnQ6IGZ1bmN0aW9uKCkgewoJCXRoaXMuZmxpcHN3aXRjaC5yZW1vdmVDbGFzcyggInVpLWZsaXBzd2l0Y2gtYWN0aXZlIiApOwoJCWlmICggdGhpcy50eXBlID09PSAiU0VMRUNUIiApIHsKCQkJdGhpcy5lbGVtZW50LmdldCggMCApLnNlbGVjdGVkSW5kZXggPSAwOwoJCX0gZWxzZSB7CgkJCXRoaXMuZWxlbWVudC5wcm9wKCAiY2hlY2tlZCIsIHRydWUgKTsKCQl9CgkJdGhpcy5fdHJpZ2dlciggImNoYW5nZSIgKTsKCX0sCgoJX3JpZ2h0OiBmdW5jdGlvbigpIHsKCQl0aGlzLmZsaXBzd2l0Y2guYWRkQ2xhc3MoICJ1aS1mbGlwc3dpdGNoLWFjdGl2ZSIgKTsKCQlpZiAoIHRoaXMudHlwZSA9PT0gIlNFTEVDVCIgKSB7CgkJCXRoaXMuZWxlbWVudC5nZXQoIDAgKS5zZWxlY3RlZEluZGV4ID0gMTsKCQl9IGVsc2UgewoJCQl0aGlzLmVsZW1lbnQucHJvcCggImNoZWNrZWQiLCBmYWxzZSApOwoJCX0KCQl0aGlzLl90cmlnZ2VyKCAiY2hhbmdlIiApOwoJfSwKCglfZW5oYW5jZTogZnVuY3Rpb24oKSB7CgkJdmFyIGZsaXBzd2l0Y2ggPSAkKCAiPGRpdj4iICksCgkJCXRoZW1lID0gdGhpcy5vcHRpb25zLnRoZW1lID8gdGhpcy5vcHRpb25zLnRoZW1lIDogImluaGVyaXQiLAoJCQlvbiA9ICQoICI8c3BhbiB0YWJpbmRleD0nMSc+PC9zcGFuPiIgKSwKCQkJb2ZmID0gJCggIjxzcGFuPjwvc3Bhbj4iICksCgkJCXR5cGUgPSB0aGlzLmVsZW1lbnQuZ2V0KCAwICkudGFnTmFtZSwKCQkJb25UZXh0ID0gKCB0eXBlID09PSAiSU5QVVQiICkgPyB0aGlzLm9wdGlvbnMub25UZXh0IDogdGhpcy5lbGVtZW50LmZpbmQoICJvcHRpb24iICkuZXEoIDEgKS50ZXh0KCksCgkJCW9mZlRleHQgPSAoIHR5cGUgPT09ICJJTlBVVCIgKSA/IHRoaXMub3B0aW9ucy5vZmZUZXh0IDogdGhpcy5lbGVtZW50LmZpbmQoICJvcHRpb24iICkuZXEoIDAgKS50ZXh0KCk7CgoJCQlvbi5hZGRDbGFzcyggInVpLWZsaXBzd2l0Y2gtb24gdWktYnRuIHVpLXNoYWRvdyB1aS1idG4taW5oZXJpdCIgKS50ZXh0KCBvblRleHQgKTsKCQkJb2ZmLmFkZENsYXNzKCAidWktZmxpcHN3aXRjaC1vZmYiICkudGV4dCggb2ZmVGV4dCApOwoJCQkKCQkJZmxpcHN3aXRjaC5hZGRDbGFzcyggInVpLWZsaXBzd2l0Y2ggdWktc2hhZG93LWluc2V0IHVpLWNvcm5lci1hbGwgdWktYmFyLSIgKyB0aGVtZSArICIgIiArICggdGhpcy5vcHRpb25zLndyYXBwZXJDbGFzcyA/IHRoaXMub3B0aW9ucy53cmFwcGVyQ2xhc3MgOiAiIiApICsgIiAiICsgKCAoIHRoaXMuZWxlbWVudC5pcyggIjpjaGVja2VkIiApIHx8IHRoaXMuZWxlbWVudC5maW5kKCJvcHRpb24iKS5lcSgxKS5pcygiOnNlbGVjdGVkIikgKSA/ICJ1aS1mbGlwc3dpdGNoLWFjdGl2ZSIgOiAiIiApICsgKCB0aGlzLmVsZW1lbnQuaXMoIjpkaXNhYmxlZCIpID8gIiB1aS1zdGF0ZS1kaXNhYmxlZCI6ICIiKSArICggdGhpcy5vcHRpb25zLm1pbmkgPyAiIHVpLW1pbmkiOiAiIiApICkuYXBwZW5kKCBvbiwgb2ZmICk7CgkJCQoJCQl0aGlzLmVsZW1lbnQuYWRkQ2xhc3MoICJ1aS1mbGlwc3dpdGNoLWlucHV0IiApOwoJCQl0aGlzLmVsZW1lbnQuYWZ0ZXIoIGZsaXBzd2l0Y2ggKS5hcHBlbmRUbyggZmxpcHN3aXRjaCApOwoKCQkkLmV4dGVuZCggdGhpcywgewoJCQlmbGlwc3dpdGNoOiBmbGlwc3dpdGNoLAoJCQlvbjogb24sCgkJCW9mZjogb2ZmLAoJCQl0eXBlOiB0eXBlCgkJfSk7Cgl9LAoKCV9jaGFuZ2U6IGZ1bmN0aW9uKCkgewoJCXZhciBkaXJlY3Rpb247CgkJCgkJaWYgKCB0aGlzLnR5cGUgPT09ICJTRUxFQ1QiICkgewoJCQlkaXJlY3Rpb24gPSAoIHRoaXMuZWxlbWVudC5nZXQoIDAgKS5zZWxlY3RlZEluZGV4ID4gMCApPyAiX3JpZ2h0IjogIl9sZWZ0IjsKCQl9IGVsc2UgewoJCQlkaXJlY3Rpb24gPSB0aGlzLmVsZW1lbnQuaXMoICI6Y2hlY2tlZCIgKT8gIl9yaWdodCI6ICJfbGVmdCI7CgkJfQoJCXRoaXNbIGRpcmVjdGlvbiBdKCk7Cgl9LAoKCV90b2dnbGU6IGZ1bmN0aW9uKCkgewoJCXZhciBkaXJlY3Rpb24gPSB0aGlzLmZsaXBzd2l0Y2guaGFzQ2xhc3MoICJ1aS1mbGlwc3dpdGNoLWFjdGl2ZSIgKSA/ICJfbGVmdCIgOiAiX3JpZ2h0IjsKCQkKCQl0aGlzW2RpcmVjdGlvbl0oKTsKCX0sCgoJX2tleWRvd246IGZ1bmN0aW9uKCBlICkgewoJCWlmICggZS53aGljaCA9PT0gJC5tb2JpbGUua2V5Q29kZS5MRUZUICkgewoJCQl0aGlzLl9sZWZ0KCk7CgkJfSBlbHNlIGlmICggZS53aGljaCA9PT0gJC5tb2JpbGUua2V5Q29kZS5SSUdIVCApIHsKCQkJdGhpcy5fcmlnaHQoKTsKCQl9IGVsc2UgaWYgKCBlLndoaWNoID09PSAkLm1vYmlsZS5rZXlDb2RlLlNQQUNFICkgewoJCQl0aGlzLl90b2dnbGUoKTsKCQkJZS5wcmV2ZW50RGVmYXVsdCgpOwoJCX0KCX0sCgoJX3NldE9wdGlvbnM6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCWlmICggb3B0aW9ucy50aGVtZSAhPT0gdW5kZWZpbmVkICkgewoJCQl2YXIgY3VycmVudFRoZW1lID0gb3B0aW9ucy50aGVtZSA/IG9wdGlvbnMudGhlbWUgOiAiaW5oZXJpdCIsCgkJCQluZXdUaGVtZSA9IG9wdGlvbnMudGhlbWUgPyBvcHRpb25zLnRoZW1lIDogImluaGVyaXQiOwoKCQkJdGhpcy53aWRnZXQoKQoJCQkJLnJlbW92ZUNsYXNzKCAidWktYmFyLSIgKyBjdXJyZW50VGhlbWUgKQoJCQkJLmFkZENsYXNzKCAidWktYmFyLSIgKyBuZXdUaGVtZSApOwoJCX0KCQlpZiAoIG9wdGlvbnMub25UZXh0ICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMub24udGV4dCggb3B0aW9ucy5vblRleHQgKTsKCQl9CgkJaWYgKCBvcHRpb25zLm9mZlRleHQgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhpcy5vZmYudGV4dCggb3B0aW9ucy5vZmZUZXh0ICk7CgkJfQoJCWlmICggb3B0aW9ucy5kaXNhYmxlZCAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLndpZGdldCgpLnRvZ2dsZUNsYXNzKCAidWktc3RhdGUtZGlzYWJsZWQiLCBvcHRpb25zLmRpc2FibGVkICk7CgkJfQoJCWlmKCBvcHRpb25zLm1pbmkgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhpcy53aWRnZXQoKS50b2dnbGVDbGFzcyggInVpLW1pbmkiLCBvcHRpb25zLm1pbmkgKTsKCQl9CgkJCgkJdGhpcy5fc3VwZXIoIG9wdGlvbnMgKTsKCX0sCgoJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCWlmICggdGhpcy5vcHRpb25zLmVuaGFuY2VkICkgewoJCQlyZXR1cm47CgkJfQoJCXRoaXMub24ucmVtb3ZlKCk7CgkJdGhpcy5vZmYucmVtb3ZlKCk7CgkJdGhpcy5lbGVtZW50LnVud3JhcCgpOwoJCXRoaXMuZmxpcHN3aXRjaC5yZW1vdmUoKTsKCQl0aGlzLnJlbW92ZUNsYXNzKCAidWktZmxpcHN3aXRjaC1pbnB1dCIgKTsKCX0KCn0sICQubW9iaWxlLmJlaGF2aW9ycy5mb3JtUmVzZXQgKSApOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgkkLndpZGdldCggIm1vYmlsZS5yYW5nZXNsaWRlciIsICQuZXh0ZW5kKCB7CgoJCW9wdGlvbnM6IHsKCQkJdGhlbWU6IG51bGwsCgkJCXRyYWNrVGhlbWU6IG51bGwsCgkJCWNvcm5lcnM6IHRydWUsCgkJCW1pbmk6IGZhbHNlLAoJCQloaWdobGlnaHQ6IHRydWUKCQl9LAoKCQlfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQkJdmFyICRlbCA9IHRoaXMuZWxlbWVudCwKCQkJZWxDbGFzcyA9IHRoaXMub3B0aW9ucy5taW5pID8gInVpLXJhbmdlc2xpZGVyIHVpLW1pbmkiIDogInVpLXJhbmdlc2xpZGVyIiwKCQkJX2lucHV0Rmlyc3QgPSAkZWwuZmluZCggImlucHV0IiApLmZpcnN0KCksCgkJCV9pbnB1dExhc3QgPSAkZWwuZmluZCggImlucHV0IiApLmxhc3QoKSwKCQkJX2xhYmVsID0gJGVsLmZpbmQoICJsYWJlbCIgKS5maXJzdCgpLAoJCQlfc2xpZGVyRmlyc3QgPSAkLmRhdGEoIF9pbnB1dEZpcnN0LmdldCgwKSwgIm1vYmlsZS1zbGlkZXIiICkuc2xpZGVyLAoJCQlfc2xpZGVyTGFzdCA9ICQuZGF0YSggX2lucHV0TGFzdC5nZXQoMCksICJtb2JpbGUtc2xpZGVyIiApLnNsaWRlciwKCQkJZmlyc3RIYW5kbGUgPSAkLmRhdGEoIF9pbnB1dEZpcnN0LmdldCgwKSwgIm1vYmlsZS1zbGlkZXIiICkuaGFuZGxlLAoJCQlfc2xpZGVycyA9ICQoICI8ZGl2IGNsYXNzPSd1aS1yYW5nZXNsaWRlci1zbGlkZXJzJyAvPiIgKS5hcHBlbmRUbyggJGVsICk7CgoJCQlfaW5wdXRGaXJzdC5hZGRDbGFzcyggInVpLXJhbmdlc2xpZGVyLWZpcnN0IiApOwoJCQlfaW5wdXRMYXN0LmFkZENsYXNzKCAidWktcmFuZ2VzbGlkZXItbGFzdCIgKTsKCQkJJGVsLmFkZENsYXNzKCBlbENsYXNzICk7CgoJCQlfc2xpZGVyRmlyc3QuYXBwZW5kVG8oIF9zbGlkZXJzICk7CgkJCV9zbGlkZXJMYXN0LmFwcGVuZFRvKCBfc2xpZGVycyApOwoJCQlfbGFiZWwuaW5zZXJ0QmVmb3JlKCAkZWwgKTsKCQkJZmlyc3RIYW5kbGUucHJlcGVuZFRvKCBfc2xpZGVyTGFzdCApOwoKCQkJJC5leHRlbmQoIHRoaXMsIHsKCQkJCV9pbnB1dEZpcnN0OiBfaW5wdXRGaXJzdCwKCQkJCV9pbnB1dExhc3Q6IF9pbnB1dExhc3QsCgkJCQlfc2xpZGVyRmlyc3Q6IF9zbGlkZXJGaXJzdCwKCQkJCV9zbGlkZXJMYXN0OiBfc2xpZGVyTGFzdCwKCQkJCV9sYWJlbDogX2xhYmVsLAoJCQkJX3RhcmdldFZhbDogbnVsbCwKCQkJCV9zbGlkZXJUYXJnZXQ6IGZhbHNlLAoJCQkJX3NsaWRlcnM6IF9zbGlkZXJzLAoJCQkJX3Byb3h5OiBmYWxzZQoJCQl9KTsKCgkJCXRoaXMucmVmcmVzaCgpOwoJCQl0aGlzLl9vbiggdGhpcy5lbGVtZW50LmZpbmQoICJpbnB1dC51aS1zbGlkZXItaW5wdXQiICksIHsKCQkJCSJzbGlkZWJlZm9yZXN0YXJ0IjogIl9zbGlkZWJlZm9yZXN0YXJ0IiwKCQkJCSJzbGlkZXN0b3AiOiAiX3NsaWRlc3RvcCIsCgkJCQkic2xpZGVkcmFnIjogIl9zbGlkZWRyYWciLAoJCQkJInNsaWRlYmVmb3JlY2hhbmdlIjogIl9jaGFuZ2UiLAoJCQkJImJsdXIiOiAiX2NoYW5nZSIsCgkJCQkia2V5dXAiOiAiX2NoYW5nZSIKCQkJfSk7CgkJCXRoaXMuX29uKHsKCQkJCSJtb3VzZWRvd24iOiJfY2hhbmdlIgoJCQl9KTsKCQkJdGhpcy5fb24oIHRoaXMuZWxlbWVudC5jbG9zZXN0KCAiZm9ybSIgKSwgewoJCQkJInJlc2V0IjoiX2hhbmRsZVJlc2V0IgoJCQl9KTsKCQkJdGhpcy5fb24oIGZpcnN0SGFuZGxlLCB7CgkJCQkidm1vdXNlZG93biI6ICJfZHJhZ0ZpcnN0SGFuZGxlIgoJCQl9KTsKCQl9LAoJCV9oYW5kbGVSZXNldDogZnVuY3Rpb24oKSB7CgkJCXZhciBzZWxmID0gdGhpczsKCQkJLy93ZSBtdXN0IHdhaXQgZm9yIHRoZSBzdGFjayB0byB1bndpbmQgYmVmb3JlIHVwZGF0ZWluZyBvdGhlciB3aXNlIHNsaWRlcnMgd2lsbCBub3QgaGF2ZSB1cGRhdGVkIHlldAoJCQlzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJCXNlbGYuX3VwZGF0ZUhpZ2hsaWdodCgpOwoJCQl9LDApOwoJCX0sCgoJCV9kcmFnRmlyc3RIYW5kbGU6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJLy9pZiB0aGUgZmlyc3QgaGFuZGxlIGlzIGRyYWdnZWQgc2VuZCB0aGUgZXZlbnQgdG8gdGhlIGZpcnN0IHNsaWRlcgoJCQkkLmRhdGEoIHRoaXMuX2lucHV0Rmlyc3QuZ2V0KDApLCAibW9iaWxlLXNsaWRlciIgKS5kcmFnZ2luZyA9IHRydWU7CgkJCSQuZGF0YSggdGhpcy5faW5wdXRGaXJzdC5nZXQoMCksICJtb2JpbGUtc2xpZGVyIiApLnJlZnJlc2goIGV2ZW50ICk7CgkJCXJldHVybiBmYWxzZTsKCQl9LAoKCQlfc2xpZGVkcmFnOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciBmaXJzdCA9ICQoIGV2ZW50LnRhcmdldCApLmlzKCB0aGlzLl9pbnB1dEZpcnN0ICksCgkJCQlvdGhlclNsaWRlciA9ICggZmlyc3QgKSA/IHRoaXMuX2lucHV0TGFzdCA6IHRoaXMuX2lucHV0Rmlyc3Q7CgoJCQl0aGlzLl9zbGlkZXJUYXJnZXQgPSBmYWxzZTsKCQkJLy9pZiB0aGUgZHJhZyB3YXMgaW5pdGlhdGVkIG9uIGFuIGV4dHJlbWUgYW5kIHRoZSBvdGhlciBoYW5kbGUgaXMgZm9jdXNlZCBzZW5kIHRoZSBldmVudHMgdG8KCQkJLy90aGUgY2xvc2VzdCBoYW5kbGUKCQkJaWYgKCAoIHRoaXMuX3Byb3h5ID09PSAiZmlyc3QiICYmIGZpcnN0ICkgfHwgKCB0aGlzLl9wcm94eSA9PT0gImxhc3QiICYmICFmaXJzdCApICkgewoJCQkJJC5kYXRhKCBvdGhlclNsaWRlci5nZXQoMCksICJtb2JpbGUtc2xpZGVyIiApLmRyYWdnaW5nID0gdHJ1ZTsKCQkJCSQuZGF0YSggb3RoZXJTbGlkZXIuZ2V0KDApLCAibW9iaWxlLXNsaWRlciIgKS5yZWZyZXNoKCBldmVudCApOwoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgkJfSwKCgkJX3NsaWRlc3RvcDogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQl2YXIgZmlyc3QgPSAkKCBldmVudC50YXJnZXQgKS5pcyggdGhpcy5faW5wdXRGaXJzdCApOwoKCQkJdGhpcy5fcHJveHkgPSBmYWxzZTsKCQkJLy90aGlzIHN0b3BzIGRyYWdnaW5nIG9mIHRoZSBoYW5kbGUgYW5kIGJyaW5ncyB0aGUgYWN0aXZlIHRyYWNrIHRvIHRoZSBmcm9udAoJCQkvL3RoaXMgbWFrZXMgY2xpY2tzIG9uIHRoZSB0cmFjayBnbyB0aGUgdGhlIGxhc3QgaGFuZGxlIHVzZWQKCQkJdGhpcy5lbGVtZW50LmZpbmQoICJpbnB1dCIgKS50cmlnZ2VyKCAidm1vdXNldXAiICk7CgkJCXRoaXMuX3NsaWRlckZpcnN0LmNzcyggInotaW5kZXgiLCBmaXJzdCA/IDEgOiAiIiApOwoJCX0sCgoJCV9zbGlkZWJlZm9yZXN0YXJ0OiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXRoaXMuX3NsaWRlclRhcmdldCA9IGZhbHNlOwoJCQkvL2lmIHRoZSB0cmFjayBpcyB0aGUgdGFyZ2V0IHJlbWVtYmVyIHRoaXMgYW5kIHRoZSBvcmlnaW5hbCB2YWx1ZQoJCQlpZiAoICQoIGV2ZW50Lm9yaWdpbmFsRXZlbnQudGFyZ2V0ICkuaGFzQ2xhc3MoICJ1aS1zbGlkZXItdHJhY2siICkgKSB7CgkJCQl0aGlzLl9zbGlkZXJUYXJnZXQgPSB0cnVlOwoJCQkJdGhpcy5fdGFyZ2V0VmFsID0gJCggZXZlbnQudGFyZ2V0ICkudmFsKCk7CgkJCX0KCQl9LAoKCQlfc2V0T3B0aW9uczogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJCWlmICggb3B0aW9ucy50aGVtZSAhPT0gdW5kZWZpbmVkICkgewoJCQkJdGhpcy5fc2V0VGhlbWUoIG9wdGlvbnMudGhlbWUgKTsKCQkJfQoKCQkJaWYgKCBvcHRpb25zLnRyYWNrVGhlbWUgIT09IHVuZGVmaW5lZCApIHsKCQkJCXRoaXMuX3NldFRyYWNrVGhlbWUoIG9wdGlvbnMudHJhY2tUaGVtZSApOwoJCQl9CgoJCQlpZiAoIG9wdGlvbnMubWluaSAhPT0gdW5kZWZpbmVkICkgewoJCQkJdGhpcy5fc2V0TWluaSggb3B0aW9ucy5taW5pICk7CgkJCX0KCgkJCWlmICggb3B0aW9ucy5oaWdobGlnaHQgIT09IHVuZGVmaW5lZCApIHsKCQkJCXRoaXMuX3NldEhpZ2hsaWdodCggb3B0aW9ucy5oaWdobGlnaHQgKTsKCQkJfQoJCQl0aGlzLl9zdXBlciggb3B0aW9ucyApOwoJCQl0aGlzLnJlZnJlc2goKTsKCQl9LAoKCQlyZWZyZXNoOiBmdW5jdGlvbigpIHsKCQkJdmFyICRlbCA9IHRoaXMuZWxlbWVudCwKCQkJCW8gPSB0aGlzLm9wdGlvbnM7CgoJCQlpZiggdGhpcy5faW5wdXRGaXJzdC5pcyggIjpkaXNhYmxlZCIgKSB8fCB0aGlzLl9pbnB1dExhc3QuaXMoICI6ZGlzYWJsZWQiICkgKXsKCQkJCXRoaXMub3B0aW9ucy5kaXNhYmxlZCA9IHRydWU7CgkJCX0KCgkJCSRlbC5maW5kKCAiaW5wdXQiICkuc2xpZGVyKHsKCQkJCXRoZW1lOiBvLnRoZW1lLAoJCQkJdHJhY2tUaGVtZTogby50cmFja1RoZW1lLAoJCQkJZGlzYWJsZWQ6IG8uZGlzYWJsZWQsCgkJCQljb3JuZXJzOiBvLmNvcm5lcnMsCgkJCQltaW5pOiBvLm1pbmksCgkJCQloaWdobGlnaHQ6IG8uaGlnaGxpZ2h0CgkJCX0pLnNsaWRlciggInJlZnJlc2giICk7CgkJCXRoaXMuX3VwZGF0ZUhpZ2hsaWdodCgpOwoJCX0sCgoJCV9jaGFuZ2U6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJaWYgKCBldmVudC50eXBlID09PSAia2V5dXAiICkgewoJCQkJdGhpcy5fdXBkYXRlSGlnaGxpZ2h0KCk7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCgkJCXZhciBzZWxmID0gdGhpcywKCQkJCW1pbiA9IHBhcnNlRmxvYXQoIHRoaXMuX2lucHV0Rmlyc3QudmFsKCksIDEwICksCgkJCQltYXggPSBwYXJzZUZsb2F0KCB0aGlzLl9pbnB1dExhc3QudmFsKCksIDEwICksCgkJCQlmaXJzdCA9ICQoIGV2ZW50LnRhcmdldCApLmhhc0NsYXNzKCAidWktcmFuZ2VzbGlkZXItZmlyc3QiICksCgkJCQl0aGlzU2xpZGVyID0gZmlyc3QgPyB0aGlzLl9pbnB1dEZpcnN0IDogdGhpcy5faW5wdXRMYXN0LAoJCQkJb3RoZXJTbGlkZXIgPSBmaXJzdCA/IHRoaXMuX2lucHV0TGFzdCA6IHRoaXMuX2lucHV0Rmlyc3Q7CgoKCQkJaWYgKCAoIHRoaXMuX2lucHV0Rmlyc3QudmFsKCkgPiB0aGlzLl9pbnB1dExhc3QudmFsKCkgJiYgZXZlbnQudHlwZSA9PT0gIm1vdXNlZG93biIgJiYgISQoZXZlbnQudGFyZ2V0KS5oYXNDbGFzcygidWktc2xpZGVyLWhhbmRsZSIpKSApewoJCQkJdGhpc1NsaWRlci5ibHVyKCk7CgkJCX0gZWxzZSBpZiAoIGV2ZW50LnR5cGUgPT09ICJtb3VzZWRvd24iICl7CgkJCQlyZXR1cm47CgkJCX0KCQkJaWYgKCBtaW4gPiBtYXggJiYgIXRoaXMuX3NsaWRlclRhcmdldCApIHsKCQkJCS8vdGhpcyBwcmV2ZW50cyBtaW4gZnJvbSBiZWluZyBncmVhdGVyIHRoZW4gbWF4CgkJCQl0aGlzU2xpZGVyLnZhbCggZmlyc3QgPyBtYXg6IG1pbiApLnNsaWRlciggInJlZnJlc2giICk7CgkJCQl0aGlzLl90cmlnZ2VyKCAibm9ybWFsaXplIiApOwoJCQl9IGVsc2UgaWYgKCBtaW4gPiBtYXggKSB7CgkJCQkvL3RoaXMgbWFrZXMgaXQgc28gY2xpY2tzIG9uIHRoZSB0YXJnZXQgb24gZWl0aGVyIGV4dHJlbWUgZ28gdG8gdGhlIGNsb3Nlc3QgaGFuZGxlCgkJCQl0aGlzU2xpZGVyLnZhbCggdGhpcy5fdGFyZ2V0VmFsICkuc2xpZGVyKCAicmVmcmVzaCIgKTsKCgkJCQkvL1lvdSBtdXN0IHdhaXQgZm9yIHRoZSBzdGFjayB0byB1bndpbmQgc28gZmlyc3Qgc2xpZGVyIGlzIHVwZGF0ZWQgYmVmb3JlIHVwZGF0aW5nIHNlY29uZAoJCQkJc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQkJb3RoZXJTbGlkZXIudmFsKCBmaXJzdCA/IG1pbjogbWF4ICkuc2xpZGVyKCAicmVmcmVzaCIgKTsKCQkJCQkkLmRhdGEoIG90aGVyU2xpZGVyLmdldCgwKSwgIm1vYmlsZS1zbGlkZXIiICkuaGFuZGxlLmZvY3VzKCk7CgkJCQkJc2VsZi5fc2xpZGVyRmlyc3QuY3NzKCAiei1pbmRleCIsIGZpcnN0ID8gIiIgOiAxICk7CgkJCQkJc2VsZi5fdHJpZ2dlciggIm5vcm1hbGl6ZSIgKTsKCQkJCX0sIDAgKTsKCQkJCXRoaXMuX3Byb3h5ID0gKCBmaXJzdCApID8gImZpcnN0IiA6ICJsYXN0IjsKCQkJfQoJCQkvL2ZpeGVzIGlzc3VlIHdoZXJlIHdoZW4gYm90aCBfc2xpZGVycyBhcmUgYXQgbWluIHRoZXkgY2Fubm90IGJlIGFkanVzdGVkCgkJCWlmICggbWluID09PSBtYXggKSB7CgkJCQkkLmRhdGEoIHRoaXNTbGlkZXIuZ2V0KDApLCAibW9iaWxlLXNsaWRlciIgKS5oYW5kbGUuY3NzKCAiei1pbmRleCIsIDEgKTsKCQkJCSQuZGF0YSggb3RoZXJTbGlkZXIuZ2V0KDApLCAibW9iaWxlLXNsaWRlciIgKS5oYW5kbGUuY3NzKCAiei1pbmRleCIsIDAgKTsKCQkJfSBlbHNlIHsKCQkJCSQuZGF0YSggb3RoZXJTbGlkZXIuZ2V0KDApLCAibW9iaWxlLXNsaWRlciIgKS5oYW5kbGUuY3NzKCAiei1pbmRleCIsICIiICk7CgkJCQkkLmRhdGEoIHRoaXNTbGlkZXIuZ2V0KDApLCAibW9iaWxlLXNsaWRlciIgKS5oYW5kbGUuY3NzKCAiei1pbmRleCIsICIiICk7CgkJCX0KCgkJCXRoaXMuX3VwZGF0ZUhpZ2hsaWdodCgpOwoKCQkJaWYgKCBtaW4gPj0gbWF4ICkgewoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgkJfSwKCgkJX3VwZGF0ZUhpZ2hsaWdodDogZnVuY3Rpb24oKSB7CgkJCXZhciBtaW4gPSBwYXJzZUludCggJC5kYXRhKCB0aGlzLl9pbnB1dEZpcnN0LmdldCgwKSwgIm1vYmlsZS1zbGlkZXIiICkuaGFuZGxlLmdldCgwKS5zdHlsZS5sZWZ0LCAxMCApLAoJCQkJbWF4ID0gcGFyc2VJbnQoICQuZGF0YSggdGhpcy5faW5wdXRMYXN0LmdldCgwKSwgIm1vYmlsZS1zbGlkZXIiICkuaGFuZGxlLmdldCgwKS5zdHlsZS5sZWZ0LCAxMCApLAoJCQkJd2lkdGggPSAobWF4IC0gbWluKTsKCgkJCXRoaXMuZWxlbWVudC5maW5kKCAiLnVpLXNsaWRlci1iZyIgKS5jc3MoewoJCQkJIm1hcmdpbi1sZWZ0IjogbWluICsgIiUiLAoJCQkJIndpZHRoIjogd2lkdGggKyAiJSIKCQkJfSk7CgkJfSwKCgkJX3NldFRoZW1lOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJCXRoaXMuX2lucHV0Rmlyc3Quc2xpZGVyKCAib3B0aW9uIiwgInRoZW1lIiwgdmFsdWUgKTsKCQkJdGhpcy5faW5wdXRMYXN0LnNsaWRlciggIm9wdGlvbiIsICJ0aGVtZSIsIHZhbHVlICk7CgkJfSwKCgkJX3NldFRyYWNrVGhlbWU6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQkJdGhpcy5faW5wdXRGaXJzdC5zbGlkZXIoICJvcHRpb24iLCAidHJhY2tUaGVtZSIsIHZhbHVlICk7CgkJCXRoaXMuX2lucHV0TGFzdC5zbGlkZXIoICJvcHRpb24iLCAidHJhY2tUaGVtZSIsIHZhbHVlICk7CgkJfSwKCgkJX3NldE1pbmk6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQkJdGhpcy5faW5wdXRGaXJzdC5zbGlkZXIoICJvcHRpb24iLCAibWluaSIsIHZhbHVlICk7CgkJCXRoaXMuX2lucHV0TGFzdC5zbGlkZXIoICJvcHRpb24iLCAibWluaSIsIHZhbHVlICk7CgkJCXRoaXMuZWxlbWVudC50b2dnbGVDbGFzcyggInVpLW1pbmkiLCAhIXZhbHVlICk7CgkJfSwKCgkJX3NldEhpZ2hsaWdodDogZnVuY3Rpb24oIHZhbHVlICkgewoJCQl0aGlzLl9pbnB1dEZpcnN0LnNsaWRlciggIm9wdGlvbiIsICJoaWdobGlnaHQiLCB2YWx1ZSApOwoJCQl0aGlzLl9pbnB1dExhc3Quc2xpZGVyKCAib3B0aW9uIiwgImhpZ2hsaWdodCIsIHZhbHVlICk7CgkJfSwKCgkJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLl9sYWJlbC5wcmVwZW5kVG8oIHRoaXMuZWxlbWVudCApOwoJCQl0aGlzLmVsZW1lbnQucmVtb3ZlQ2xhc3MoICJ1aS1yYW5nZXNsaWRlciB1aS1taW5pIiApOwoJCQl0aGlzLl9pbnB1dEZpcnN0LmFmdGVyKCB0aGlzLl9zbGlkZXJGaXJzdCApOwoJCQl0aGlzLl9pbnB1dExhc3QuYWZ0ZXIoIHRoaXMuX3NsaWRlckxhc3QgKTsKCQkJdGhpcy5fc2xpZGVycy5yZW1vdmUoKTsKCQkJdGhpcy5lbGVtZW50LmZpbmQoICJpbnB1dCIgKS5yZW1vdmVDbGFzcyggInVpLXJhbmdlc2xpZGVyLWZpcnN0IHVpLXJhbmdlc2xpZGVyLWxhc3QiICkuc2xpZGVyKCAiZGVzdHJveSIgKTsKCQl9CgoJfSwgJC5tb2JpbGUuYmVoYXZpb3JzLmZvcm1SZXNldCApICk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCgkkLndpZGdldCggIm1vYmlsZS50ZXh0aW5wdXQiLCAkLm1vYmlsZS50ZXh0aW5wdXQsIHsKCQlvcHRpb25zOiB7CgkJCWNsZWFyQnRuOiBmYWxzZSwKCQkJY2xlYXJCdG5UZXh0OiAiQ2xlYXIgdGV4dCIKCQl9LAoKCQlfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5fc3VwZXIoKTsKCgkJCWlmICggISF0aGlzLm9wdGlvbnMuY2xlYXJCdG4gfHwgdGhpcy5pc1NlYXJjaCApewoJCQkJdGhpcy5fYWRkQ2xlYXJCdG4oKTsKCQkJfQoJCX0sCgoJCWNsZWFyQnV0dG9uOiBmdW5jdGlvbigpIHsKCgkJCXJldHVybiAkKCAiPGEgaHJlZj0nIycgY2xhc3M9J3VpLWlucHV0LWNsZWFyIHVpLWJ0biB1aS1pY29uLWRlbGV0ZSB1aS1idG4taWNvbi1ub3RleHQgdWktY29ybmVyLWFsbCIgKwogICAgIicgdGl0bGU9JyIgKyB0aGlzLm9wdGlvbnMuY2xlYXJCdG5UZXh0ICsgIic+IiArIHRoaXMub3B0aW9ucy5jbGVhckJ0blRleHQgKyAiPC9hPiIgKTsKCgkJfSwKCgkJX2NsZWFyQnRuQ2xpY2s6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdGhpcy5lbGVtZW50LnZhbCggIiIgKQoJCQkJCS5mb2N1cygpCgkJCQkJLnRyaWdnZXIoICJjaGFuZ2UiICk7CgoJCQl0aGlzLl9jbGVhckJ0bi5hZGRDbGFzcyggInVpLWlucHV0LWNsZWFyLWhpZGRlbiIgKTsKCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQl9LAoKCQlfYWRkQ2xlYXJCdG46IGZ1bmN0aW9uKCkgewoKCQkJaWYgKCAhdGhpcy5vcHRpb25zLmVuaGFuY2VkICkgewoJCQkJdGhpcy5fZW5oYW5jZUNsZWFyKCk7CgkJCX0KCgkJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCQlfY2xlYXJCdG46IHRoaXMud2lkZ2V0KCkuZmluZCgiYS51aS1pbnB1dC1jbGVhciIpCgkJCX0pOwoKCQkJdGhpcy5fYmluZENsZWFyRXZlbnRzKCk7CgoJCQl0aGlzLl90b2dnbGVDbGVhcigpOwoKCQl9LAoKCQlfZW5oYW5jZUNsZWFyOiBmdW5jdGlvbigpIHsKCgkJCXRoaXMuY2xlYXJCdXR0b24oKS5hcHBlbmRUbyggdGhpcy53aWRnZXQoKSApOwoJCQl0aGlzLndpZGdldCgpLmFkZENsYXNzKCAidWktaW5wdXQtaGFzLWNsZWFyIiApOwoKCQl9LAoKCQlfYmluZENsZWFyRXZlbnRzOiBmdW5jdGlvbigpIHsKCgkJCXRoaXMuX29uKCB0aGlzLl9jbGVhckJ0biwgewoJCQkJImNsaWNrIjogIl9jbGVhckJ0bkNsaWNrIgoJCQl9KTsKCgkJCXRoaXMuX29uKHsKCQkJCSJrZXl1cCI6ICJfdG9nZ2xlQ2xlYXIiLAoJCQkJImNoYW5nZSI6ICJfdG9nZ2xlQ2xlYXIiLAoJCQkJImlucHV0IjogIl90b2dnbGVDbGVhciIsCgkJCQkiZm9jdXMiOiAiX3RvZ2dsZUNsZWFyIiwKCQkJCSJibHVyIjogIl90b2dnbGVDbGVhciIsCgkJCQkiY3V0IjogIl90b2dnbGVDbGVhciIsCgkJCQkicGFzdGUiOiAiX3RvZ2dsZUNsZWFyIgoKCQkJfSk7CgoJCX0sCgoJCV91bmJpbmRDbGVhcjogZnVuY3Rpb24oKSB7CgkJCXRoaXMuX29mZiggdGhpcy5fY2xlYXJCdG4sICJjbGljayIpOwoJCQl0aGlzLl9vZmYoIHRoaXMuZWxlbWVudCwgImtleXVwIGNoYW5nZSBpbnB1dCBmb2N1cyBibHVyIGN1dCBwYXN0ZSIgKTsKCQl9LAoKCQlfc2V0T3B0aW9uczpmdW5jdGlvbiggb3B0aW9ucyApIHsKCQkJdGhpcy5fc3VwZXIoIG9wdGlvbnMgKTsKCgkJCWlmICggb3B0aW9ucy5jbGVhcmJ0biAhPT0gdW5kZWZpbmVkICYmICF0aGlzLmVsZW1lbnQuaXMoICJ0ZXh0YXJlYSwgOmpxbURhdGEodHlwZT0ncmFuZ2UnKSIgKSApIHsKCQkJCWlmICggb3B0aW9ucy5jbGVhckJ0biApewoJCQkJCXRoaXMuX2FkZENsZWFyQnRuKCk7CgkJCQl9IGVsc2UgewoJCQkJCXRoaXMuX2Rlc3Ryb3lDbGVhcigpOwoJCQkJfQoJCQl9CgoJCQlpZiAoIG9wdGlvbnMuY2xlYXJCdG5UZXh0ICE9PSB1bmRlZmluZWQgJiYgdGhpcy5fY2xlYXJCdG4gIT09IHVuZGVmaW5lZCApIHsKCQkJCXRoaXMuX2NsZWFyQnRuLnRleHQoIG9wdGlvbnMuY2xlYXJCdG5UZXh0ICk7CgkJCX0KCQl9LAoKCQlfdG9nZ2xlQ2xlYXI6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLl9kZWxheSggIl90b2dnbGVDbGVhckNsYXNzIiwgMCApOwoJCX0sCgoJCV90b2dnbGVDbGVhckNsYXNzOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5fY2xlYXJCdG4udG9nZ2xlQ2xhc3MoICJ1aS1pbnB1dC1jbGVhci1oaWRkZW4iLCAhdGhpcy5lbGVtZW50LnZhbCgpICk7CgkJfSwKCgkJX2Rlc3Ryb3lDbGVhcjogZnVuY3Rpb24oKSB7CgkJCXRoaXMuZWxlbWVudC5yZW1vdmVDbGFzcyggInVpLWlucHV0LWhhcy1jbGVhciIgKTsKCQkJdGhpcy5fdW5iaW5kQ2xlYXIoKS5fY2xlYXJCdG4ucmVtb3ZlKCk7CgkJfSwKCgkJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLl9zdXBlcigpOwoJCQl0aGlzLl9kZXN0cm95Q2xlYXIoKTsKCQl9CgoJfSk7CgoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgoJJC53aWRnZXQoICJtb2JpbGUudGV4dGlucHV0IiwgJC5tb2JpbGUudGV4dGlucHV0LCB7CgkJb3B0aW9uczogewoJCQlhdXRvZ3Jvdzp0cnVlLAoJCQlrZXl1cFRpbWVvdXRCdWZmZXI6IDEwMAoJCX0sCgoJCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLl9zdXBlcigpOwoKCQkJaWYgKCB0aGlzLm9wdGlvbnMuYXV0b2dyb3cgJiYgdGhpcy5pc1RleHRhcmVhICkgewoJCQkJdGhpcy5fYXV0b2dyb3coKTsKCQkJfQoJCX0sCgoJCV9hdXRvZ3JvdzogZnVuY3Rpb24oKSB7CgkJCXRoaXMuX29uKHsKCQkJCSJrZXl1cCI6ICJfdGltZW91dCIsCgkJCQkiY2hhbmdlIjogIl90aW1lb3V0IiwKCQkJCSJpbnB1dCI6ICJfdGltZW91dCIsCgkJCQkicGFzdGUiOiAiX3RpbWVvdXQiLAoJCQl9KTsKCgkJCS8vIEF0dGFjaCB0byB0aGUgdmFyaW91cyB5b3UtaGF2ZS1iZWNvbWUtdmlzaWJsZSBub3RpZmljYXRpb25zIHRoYXQgdGhlCgkJCS8vIHZhcmlvdXMgZnJhbWV3b3JrIGVsZW1lbnRzIGVtaXQuCgkJCS8vIFRPRE86IFJlbW92ZSBhbGwgYnV0IHRoZSB1cGRhdGVsYXlvdXQgaGFuZGxlciBvbmNlICM2NDI2IGlzIGZpeGVkLgoJCQl0aGlzLl9vbiggdHJ1ZSwgdGhpcy5kb2N1bWVudCwgewoKCQkJCS8vIFRPRE86IE1vdmUgdG8gbm9uLWRlcHJlY2F0ZWQgZXZlbnQKCQkJCSJwYWdlc2hvdyI6ICJfaGFuZGxlU2hvdyIsCgkJCQkicG9wdXBiZWZvcmVwb3NpdGlvbiI6ICJfaGFuZGxlU2hvdyIsCgkJCQkidXBkYXRlbGF5b3V0IjogIl9oYW5kbGVTaG93IiwKCQkJCSJwYW5lbG9wZW4iOiAiX2hhbmRsZVNob3ciCgkJCX0pOwoJCX0sCgoJCS8vIFN5bmNocm9ub3VzbHkgZml4IHRoZSB3aWRnZXQgaGVpZ2h0IGlmIHRoaXMgd2lkZ2V0J3MgcGFyZW50cyBhcmUgc3VjaAoJCS8vIHRoYXQgdGhleSBzaG93L2hpZGUgY29udGVudCBhdCBydW50aW1lLiBXZSBzdGlsbCBuZWVkIHRvIGNoZWNrIHdoZXRoZXIKCQkvLyB0aGUgd2lkZ2V0IGlzIGFjdHVhbGx5IHZpc2libGUgaW4gY2FzZSBpdCBpcyBjb250YWluZWQgaW5zaWRlIG11bHRpcGxlCgkJLy8gc3VjaCBjb250YWluZXJzLiBGb3IgZXhhbXBsZTogcGFuZWwgY29udGFpbnMgY29sbGFwc2libGUgY29udGFpbnMKCQkvLyBhdXRvZ3JvdyB0ZXh0aW5wdXQuIFRoZSBwYW5lbCBtYXkgZW1pdCAicGFuZWxvcGVuIiBpbmRpY2F0aW5nIHRoYXQgaXRzCgkJLy8gY29udGVudCBoYXMgYmVjb21lIHZpc2libGUsIGJ1dCB0aGUgY29sbGFwc2libGUgaXMgc3RpbGwgY29sbGFwc2VkLCBzbwoJCS8vIHRoZSBhdXRvZ3JvdyB0ZXh0YXJlYSBpcyBzdGlsbCBub3QgdmlzaWJsZS4KCQlfaGFuZGxlU2hvdzogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQlpZiAoICQuY29udGFpbnMoIGV2ZW50LnRhcmdldCwgdGhpcy5lbGVtZW50WyAwIF0gKSAmJgoJCQkJdGhpcy5lbGVtZW50LmlzKCAiOnZpc2libGUiICkgKSB7CgoJCQkJaWYgKCBldmVudC50eXBlICE9PSAicG9wdXBiZWZvcmVwb3NpdGlvbiIgKSB7CgkJCQkJdGhpcy5lbGVtZW50CgkJCQkJCS5hZGRDbGFzcyggInVpLXRleHRpbnB1dC1hdXRvZ3Jvdy1yZXNpemUiICkKCQkJCQkJLm9uZSggInRyYW5zaXRpb25lbmQgd2Via2l0VHJhbnNpdGlvbkVuZCBvVHJhbnNpdGlvbkVuZCIsCgkJCQkJCQkkLnByb3h5KCBmdW5jdGlvbigpIHsKCQkJCQkJCQl0aGlzLmVsZW1lbnQucmVtb3ZlQ2xhc3MoICJ1aS10ZXh0aW5wdXQtYXV0b2dyb3ctcmVzaXplIiApOwoJCQkJCQkJfSwgdGhpcyApICk7CgkJCQl9CgkJCQl0aGlzLl9wcmVwYXJlSGVpZ2h0VXBkYXRlKCk7CgkJCX0KCQl9LAoKCQlfdW5iaW5kQXV0b2dyb3c6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLl9vZmYoIHRoaXMuZWxlbWVudCwgImtleXVwIGNoYW5nZSBpbnB1dCBwYXN0ZSIgKTsKCQkJdGhpcy5fb2ZmKCB0aGlzLmRvY3VtZW50LAoJCQkJInBhZ2VzaG93IHBvcHVwYmVmb3JlcG9zaXRpb24gdXBkYXRlbGF5b3V0IHBhbmVsb3BlbiIgKTsKCQl9LAoKCQlrZXl1cFRpbWVvdXQ6IG51bGwsCgoJCV9wcmVwYXJlSGVpZ2h0VXBkYXRlOiBmdW5jdGlvbiggZGVsYXkgKSB7CgkJCWlmICggdGhpcy5rZXl1cFRpbWVvdXQgKSB7CgkJCQljbGVhclRpbWVvdXQoIHRoaXMua2V5dXBUaW1lb3V0ICk7CgkJCX0KCQkJaWYgKCBkZWxheSA9PT0gdW5kZWZpbmVkICkgewoJCQkJdGhpcy5fdXBkYXRlSGVpZ2h0KCk7CgkJCX0gZWxzZSB7CgkJCQl0aGlzLmtleXVwVGltZW91dCA9IHRoaXMuX2RlbGF5KCAiX3VwZGF0ZUhlaWdodCIsIGRlbGF5ICk7CgkJCX0KCQl9LAoKCQlfdGltZW91dDogZnVuY3Rpb24oKSB7CgkJCXRoaXMuX3ByZXBhcmVIZWlnaHRVcGRhdGUoIHRoaXMub3B0aW9ucy5rZXl1cFRpbWVvdXRCdWZmZXIgKTsKCQl9LAoKCQlfdXBkYXRlSGVpZ2h0OiBmdW5jdGlvbigpIHsKCgkJCXRoaXMua2V5dXBUaW1lb3V0ID0gMDsKCgkJCXRoaXMuZWxlbWVudC5jc3MoewoJCQkJImhlaWdodCI6IDAsCgkJCQkibWluLWhlaWdodCI6IDAsCgkJCQkibWF4LWhlaWdodCI6IDAKCQkJfSk7CgoJCQl2YXIgcGFkZGluZ1RvcCwgcGFkZGluZ0JvdHRvbSwgcGFkZGluZ0hlaWdodCwKCQkJCXNjcm9sbEhlaWdodCA9IHRoaXMuZWxlbWVudFsgMCBdLnNjcm9sbEhlaWdodCwKCQkJCWNsaWVudEhlaWdodCA9IHRoaXMuZWxlbWVudFsgMCBdLmNsaWVudEhlaWdodCwKCQkJCWJvcmRlclRvcCA9IHBhcnNlRmxvYXQoIHRoaXMuZWxlbWVudC5jc3MoICJib3JkZXItdG9wLXdpZHRoIiApICksCgkJCQlib3JkZXJCb3R0b20gPSBwYXJzZUZsb2F0KCB0aGlzLmVsZW1lbnQuY3NzKCAiYm9yZGVyLWJvdHRvbS13aWR0aCIgKSApLAoJCQkJYm9yZGVySGVpZ2h0ID0gYm9yZGVyVG9wICsgYm9yZGVyQm90dG9tLAoJCQkJaGVpZ2h0ID0gc2Nyb2xsSGVpZ2h0ICsgYm9yZGVySGVpZ2h0ICsgMTU7CgoJCQkvLyBJc3N1ZSA2MTc5OiBQYWRkaW5nIGlzIG5vdCBpbmNsdWRlZCBpbiBzY3JvbGxIZWlnaHQgYW5kCgkJCS8vIGNsaWVudEhlaWdodCBieSBGaXJlZm94IGlmIG5vIHNjcm9sbGJhciBpcyB2aXNpYmxlLiBCZWNhdXNlCgkJCS8vIHRleHRhcmVhcyB1c2UgdGhlIGJvcmRlci1ib3ggYm94LXNpemluZyBtb2RlbCwgcGFkZGluZyBzaG91bGQgYmUKCQkJLy8gaW5jbHVkZWQgaW4gdGhlIG5ldyAoYXNzaWduZWQpIGhlaWdodC4gQmVjYXVzZSB0aGUgaGVpZ2h0IGlzIHNldAoJCQkvLyB0byAwLCBjbGllbnRIZWlnaHQgPT0gMCBpbiBGaXJlZm94LiBUaGVyZWZvcmUsIHdlIGNhbiB1c2UgdGhpcyB0bwoJCQkvLyBjaGVjayBpZiBwYWRkaW5nIG11c3QgYmUgYWRkZWQuCgkJCWlmICggY2xpZW50SGVpZ2h0ID09PSAwICkgewoJCQkJcGFkZGluZ1RvcCA9IHBhcnNlRmxvYXQoIHRoaXMuZWxlbWVudC5jc3MoICJwYWRkaW5nLXRvcCIgKSApOwoJCQkJcGFkZGluZ0JvdHRvbSA9IHBhcnNlRmxvYXQoIHRoaXMuZWxlbWVudC5jc3MoICJwYWRkaW5nLWJvdHRvbSIgKSApOwoJCQkJcGFkZGluZ0hlaWdodCA9IHBhZGRpbmdUb3AgKyBwYWRkaW5nQm90dG9tOwoKCQkJCWhlaWdodCArPSBwYWRkaW5nSGVpZ2h0OwoJCQl9CgoJCQl0aGlzLmVsZW1lbnQuY3NzKHsKCQkJCSJoZWlnaHQiOiBoZWlnaHQsCgkJCQkibWluLWhlaWdodCI6ICIiLAoJCQkJIm1heC1oZWlnaHQiOiAiIgoJCQl9KTsKCQl9LAoKCQlyZWZyZXNoOiBmdW5jdGlvbigpIHsKCQkJaWYgKCB0aGlzLm9wdGlvbnMuYXV0b2dyb3cgJiYgdGhpcy5pc1RleHRhcmVhICkgewoJCQkJdGhpcy5fdXBkYXRlSGVpZ2h0KCk7CgkJCX0KCQl9LAoKCQlfc2V0T3B0aW9uczogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgoJCQl0aGlzLl9zdXBlciggb3B0aW9ucyApOwoKCQkJaWYgKCBvcHRpb25zLmF1dG9ncm93ICE9PSB1bmRlZmluZWQgJiYgdGhpcy5pc1RleHRhcmVhICkgewoJCQkJaWYgKCBvcHRpb25zLmF1dG9ncm93ICkgewoJCQkJCXRoaXMuX2F1dG9ncm93KCk7CgkJCQl9IGVsc2UgewoJCQkJCXRoaXMuX3VuYmluZEF1dG9ncm93KCk7CgkJCQl9CgkJCX0KCQl9CgoJfSk7Cn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUuc2VsZWN0bWVudSIsICQuZXh0ZW5kKCB7Cglpbml0U2VsZWN0b3I6ICJzZWxlY3Q6bm90KCA6anFtRGF0YShyb2xlPSdzbGlkZXInKSk6bm90KCA6anFtRGF0YShyb2xlPSdmbGlwc3dpdGNoJykgKSIsCgoJb3B0aW9uczogewoJCXRoZW1lOiBudWxsLAoJCWRpc2FibGVkOiBmYWxzZSwKCQlpY29uOiAiY2FyYXQtZCIsCgkJaWNvbnBvczogInJpZ2h0IiwKCQlpbmxpbmU6IGZhbHNlLAoJCWNvcm5lcnM6IHRydWUsCgkJc2hhZG93OiB0cnVlLAoJCWljb25zaGFkb3c6IGZhbHNlLCAvKiBUT0RPOiBEZXByZWNhdGVkIGluIDEuNCwgcmVtb3ZlIGluIDEuNS4gKi8KCQlvdmVybGF5VGhlbWU6IG51bGwsCgkJZGl2aWRlclRoZW1lOiBudWxsLAoJCWhpZGVQbGFjZWhvbGRlck1lbnVJdGVtczogdHJ1ZSwKCQljbG9zZVRleHQ6ICJDbG9zZSIsCgkJbmF0aXZlTWVudTogdHJ1ZSwKCQkvLyBUaGlzIG9wdGlvbiBkZWZhdWx0cyB0byB0cnVlIG9uIGlPUyBkZXZpY2VzLgoJCXByZXZlbnRGb2N1c1pvb206IC9pUGhvbmV8aVBhZHxpUG9kLy50ZXN0KCBuYXZpZ2F0b3IucGxhdGZvcm0gKSAmJiBuYXZpZ2F0b3IudXNlckFnZW50LmluZGV4T2YoICJBcHBsZVdlYktpdCIgKSA+IC0xLAoJCW1pbmk6IGZhbHNlCgl9LAoKCV9idXR0b246IGZ1bmN0aW9uKCkgewoJCXJldHVybiAkKCAiPGRpdi8+IiApOwoJfSwKCglfc2V0RGlzYWJsZWQ6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQl0aGlzLmVsZW1lbnQuYXR0ciggImRpc2FibGVkIiwgdmFsdWUgKTsKCQl0aGlzLmJ1dHRvbi5hdHRyKCAiYXJpYS1kaXNhYmxlZCIsIHZhbHVlICk7CgkJcmV0dXJuIHRoaXMuX3NldE9wdGlvbiggImRpc2FibGVkIiwgdmFsdWUgKTsKCX0sCgoJX2ZvY3VzQnV0dG9uIDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzOwoKCQlzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJc2VsZi5idXR0b24uZm9jdXMoKTsKCQl9LCA0MCk7Cgl9LAoKCV9zZWxlY3RPcHRpb25zOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5zZWxlY3QuZmluZCggIm9wdGlvbiIgKTsKCX0sCgoJLy8gc2V0dXAgaXRlbXMgdGhhdCBhcmUgZ2VuZXJhbGx5IG5lY2Vzc2FyeSBmb3Igc2VsZWN0IG1lbnUgZXh0ZW5zaW9uCglfcHJlRXh0ZW5zaW9uOiBmdW5jdGlvbigpIHsKCQl2YXIgaW5saW5lID0gdGhpcy5vcHRpb25zLmlubGluZSB8fCB0aGlzLmVsZW1lbnQuanFtRGF0YSggImlubGluZSIgKSwKCQkJbWluaSA9IHRoaXMub3B0aW9ucy5taW5pIHx8IHRoaXMuZWxlbWVudC5qcW1EYXRhKCAibWluaSIgKSwKCQkJY2xhc3NlcyA9ICIiOwoJCS8vIFRPRE86IFBvc3QgMS4xLS1vbmNlIHdlIGhhdmUgdGltZSB0byB0ZXN0IHRob3JvdWdobHktLWFueSBjbGFzc2VzIG1hbnVhbGx5IGFwcGxpZWQgdG8gdGhlIG9yaWdpbmFsIGVsZW1lbnQgc2hvdWxkIGJlIGNhcnJpZWQgb3ZlciB0byB0aGUgZW5oYW5jZWQgZWxlbWVudCwgd2l0aCBhbiBgLWVuaGFuY2VkYCBzdWZmaXguIFNlZSBodHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L2pxdWVyeS1tb2JpbGUvaXNzdWVzLzM1NzcKCQkvKiBpZiAoICRlbFswXS5jbGFzc05hbWUubGVuZ3RoICkgewoJCQljbGFzc2VzID0gJGVsWzBdLmNsYXNzTmFtZTsKCQl9ICovCgkJaWYgKCAhIX50aGlzLmVsZW1lbnRbMF0uY2xhc3NOYW1lLmluZGV4T2YoICJ1aS1idG4tbGVmdCIgKSApIHsKCQkJY2xhc3NlcyA9ICIgdWktYnRuLWxlZnQiOwoJCX0KCgkJaWYgKCAgISF+dGhpcy5lbGVtZW50WzBdLmNsYXNzTmFtZS5pbmRleE9mKCAidWktYnRuLXJpZ2h0IiApICkgewoJCQljbGFzc2VzID0gIiB1aS1idG4tcmlnaHQiOwoJCX0KCgkJaWYgKCBpbmxpbmUgKSB7CgkJCWNsYXNzZXMgKz0gIiB1aS1idG4taW5saW5lIjsKCQl9CgkJaWYgKCBtaW5pICkgewoJCQljbGFzc2VzICs9ICIgdWktbWluaSI7CgkJfQoKCQl0aGlzLnNlbGVjdCA9IHRoaXMuZWxlbWVudC5yZW1vdmVDbGFzcyggInVpLWJ0bi1sZWZ0IHVpLWJ0bi1yaWdodCIgKS53cmFwKCAiPGRpdiBjbGFzcz0ndWktc2VsZWN0IiArIGNsYXNzZXMgKyAiJz4iICk7CgkJdGhpcy5zZWxlY3RJZCAgPSB0aGlzLnNlbGVjdC5hdHRyKCAiaWQiICkgfHwgKCAic2VsZWN0LSIgKyB0aGlzLnV1aWQgKTsKCQl0aGlzLmJ1dHRvbklkID0gdGhpcy5zZWxlY3RJZCArICItYnV0dG9uIjsKCQl0aGlzLmxhYmVsID0gJCggImxhYmVsW2Zvcj0nIisgdGhpcy5zZWxlY3RJZCArIiddIiApOwoJCXRoaXMuaXNNdWx0aXBsZSA9IHRoaXMuc2VsZWN0WyAwIF0ubXVsdGlwbGU7Cgl9LAoKCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCQl2YXIgd3JhcHBlciA9IHRoaXMuZWxlbWVudC5wYXJlbnRzKCAiLnVpLXNlbGVjdCIgKTsKCQlpZiAoIHdyYXBwZXIubGVuZ3RoID4gMCApIHsKCQkJaWYgKCB3cmFwcGVyLmlzKCAiLnVpLWJ0bi1sZWZ0LCAudWktYnRuLXJpZ2h0IiApICkgewoJCQkJdGhpcy5lbGVtZW50LmFkZENsYXNzKCB3cmFwcGVyLmhhc0NsYXNzKCAidWktYnRuLWxlZnQiICkgPyAidWktYnRuLWxlZnQiIDogInVpLWJ0bi1yaWdodCIgKTsKCQkJfQoJCQl0aGlzLmVsZW1lbnQuaW5zZXJ0QWZ0ZXIoIHdyYXBwZXIgKTsKCQkJd3JhcHBlci5yZW1vdmUoKTsKCQl9Cgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3ByZUV4dGVuc2lvbigpOwoKCQl0aGlzLmJ1dHRvbiA9IHRoaXMuX2J1dHRvbigpOwoKCQl2YXIgc2VsZiA9IHRoaXMsCgoJCQlvcHRpb25zID0gdGhpcy5vcHRpb25zLAoKCQkJaWNvbnBvcyA9IG9wdGlvbnMuaWNvbiA/ICggb3B0aW9ucy5pY29ucG9zIHx8IHRoaXMuc2VsZWN0LmpxbURhdGEoICJpY29ucG9zIiApICkgOiBmYWxzZSwKCgkJCWJ1dHRvbiA9IHRoaXMuYnV0dG9uCgkJCQkuaW5zZXJ0QmVmb3JlKCB0aGlzLnNlbGVjdCApCgkJCQkuYXR0ciggImlkIiwgdGhpcy5idXR0b25JZCApCgkJCQkuYWRkQ2xhc3MoICJ1aS1idG4iICsKCQkJCQkoIG9wdGlvbnMuaWNvbiA/ICggIiB1aS1pY29uLSIgKyBvcHRpb25zLmljb24gKyAiIHVpLWJ0bi1pY29uLSIgKyBpY29ucG9zICsKCQkJCQkoIG9wdGlvbnMuaWNvbnNoYWRvdyA/ICIgdWktc2hhZG93LWljb24iIDogIiIgKSApIDoJIiIgKSArIC8qIFRPRE86IFJlbW92ZSBpbiAxLjUuICovCgkJCQkJKCBvcHRpb25zLnRoZW1lID8gIiB1aS1idG4tIiArIG9wdGlvbnMudGhlbWUgOiAiIiApICsKCQkJCQkoIG9wdGlvbnMuY29ybmVycyA/ICIgdWktY29ybmVyLWFsbCIgOiAiIiApICsKCQkJCQkoIG9wdGlvbnMuc2hhZG93ID8gIiB1aS1zaGFkb3ciIDogIiIgKSApOwoKCQl0aGlzLnNldEJ1dHRvblRleHQoKTsKCgkJLy8gT3BlcmEgZG9lcyBub3QgcHJvcGVybHkgc3VwcG9ydCBvcGFjaXR5IG9uIHNlbGVjdCBlbGVtZW50cwoJCS8vIEluIE1pbmksIGl0IGhpZGVzIHRoZSBlbGVtZW50LCBidXQgbm90IGl0cyB0ZXh0CgkJLy8gT24gdGhlIGRlc2t0b3AsaXQgc2VlbXMgdG8gZG8gdGhlIG9wcG9zaXRlCgkJLy8gZm9yIHRoZXNlIHJlYXNvbnMsIHVzaW5nIHRoZSBuYXRpdmVNZW51IG9wdGlvbiByZXN1bHRzIGluIGEgZnVsbCBuYXRpdmUgc2VsZWN0IGluIE9wZXJhCgkJaWYgKCBvcHRpb25zLm5hdGl2ZU1lbnUgJiYgd2luZG93Lm9wZXJhICYmIHdpbmRvdy5vcGVyYS52ZXJzaW9uICkgewoJCQlidXR0b24uYWRkQ2xhc3MoICJ1aS1zZWxlY3QtbmF0aXZlb25seSIgKTsKCQl9CgoJCS8vIEFkZCBjb3VudGVyIGZvciBtdWx0aSBzZWxlY3RzCgkJaWYgKCB0aGlzLmlzTXVsdGlwbGUgKSB7CgkJCXRoaXMuYnV0dG9uQ291bnQgPSAkKCAiPHNwYW4+IiApCgkJCQkuYWRkQ2xhc3MoICJ1aS1saS1jb3VudCB1aS1ib2R5LWluaGVyaXQiICkKCQkJCS5oaWRlKCkKCQkJCS5hcHBlbmRUbyggYnV0dG9uLmFkZENsYXNzKCAidWktbGktaGFzLWNvdW50IiApICk7CgkJfQoKCQkvLyBEaXNhYmxlIGlmIHNwZWNpZmllZAoJCWlmICggb3B0aW9ucy5kaXNhYmxlZCB8fCB0aGlzLmVsZW1lbnQuYXR0ciggImRpc2FibGVkIiApKSB7CgkJCXRoaXMuZGlzYWJsZSgpOwoJCX0KCgkJLy8gRXZlbnRzIG9uIG5hdGl2ZSBzZWxlY3QKCQl0aGlzLnNlbGVjdC5jaGFuZ2UoZnVuY3Rpb24oKSB7CgkJCXNlbGYucmVmcmVzaCgpOwoKCQkJaWYgKCAhIW9wdGlvbnMubmF0aXZlTWVudSApIHsKCQkJCXRoaXMuYmx1cigpOwoJCQl9CgkJfSk7CgoJCXRoaXMuX2hhbmRsZUZvcm1SZXNldCgpOwoKCQl0aGlzLl9vbiggdGhpcy5idXR0b24sIHsKCQkJa2V5ZG93bjogIl9oYW5kbGVLZXlkb3duIgoJCX0pOwoKCQl0aGlzLmJ1aWxkKCk7Cgl9LAoKCWJ1aWxkOiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXM7CgoJCXRoaXMuc2VsZWN0CgkJCS5hcHBlbmRUbyggc2VsZi5idXR0b24gKQoJCQkuYmluZCggInZtb3VzZWRvd24iLCBmdW5jdGlvbigpIHsKCQkJCS8vIEFkZCBhY3RpdmUgY2xhc3MgdG8gYnV0dG9uCgkJCQlzZWxmLmJ1dHRvbi5hZGRDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJfSkKCQkJLmJpbmQoICJmb2N1cyIsIGZ1bmN0aW9uKCkgewoJCQkJc2VsZi5idXR0b24uYWRkQ2xhc3MoICQubW9iaWxlLmZvY3VzQ2xhc3MgKTsKCQkJfSkKCQkJLmJpbmQoICJibHVyIiwgZnVuY3Rpb24oKSB7CgkJCQlzZWxmLmJ1dHRvbi5yZW1vdmVDbGFzcyggJC5tb2JpbGUuZm9jdXNDbGFzcyApOwoJCQl9KQoJCQkuYmluZCggImZvY3VzIHZtb3VzZW92ZXIiLCBmdW5jdGlvbigpIHsKCQkJCXNlbGYuYnV0dG9uLnRyaWdnZXIoICJ2bW91c2VvdmVyIiApOwoJCQl9KQoJCQkuYmluZCggInZtb3VzZW1vdmUiLCBmdW5jdGlvbigpIHsKCQkJCS8vIFJlbW92ZSBhY3RpdmUgY2xhc3Mgb24gc2Nyb2xsL3RvdWNobW92ZQoJCQkJc2VsZi5idXR0b24ucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCX0pCgkJCS5iaW5kKCAiY2hhbmdlIGJsdXIgdm1vdXNlb3V0IiwgZnVuY3Rpb24oKSB7CgkJCQlzZWxmLmJ1dHRvbi50cmlnZ2VyKCAidm1vdXNlb3V0IiApCgkJCQkJLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQl9KTsKCgkJLy8gSW4gbWFueSBzaXR1YXRpb25zLCBpT1Mgd2lsbCB6b29tIGludG8gdGhlIHNlbGVjdCB1cG9uIHRhcCwgdGhpcyBwcmV2ZW50cyB0aGF0IGZyb20gaGFwcGVuaW5nCgkJc2VsZi5idXR0b24uYmluZCggInZtb3VzZWRvd24iLCBmdW5jdGlvbigpIHsKCQkJaWYgKCBzZWxmLm9wdGlvbnMucHJldmVudEZvY3VzWm9vbSApIHsKCQkJCQkkLm1vYmlsZS56b29tLmRpc2FibGUoIHRydWUgKTsKCQkJfQoJCX0pOwoJCXNlbGYubGFiZWwuYmluZCggImNsaWNrIGZvY3VzIiwgZnVuY3Rpb24oKSB7CgkJCWlmICggc2VsZi5vcHRpb25zLnByZXZlbnRGb2N1c1pvb20gKSB7CgkJCQkJJC5tb2JpbGUuem9vbS5kaXNhYmxlKCB0cnVlICk7CgkJCX0KCQl9KTsKCQlzZWxmLnNlbGVjdC5iaW5kKCAiZm9jdXMiLCBmdW5jdGlvbigpIHsKCQkJaWYgKCBzZWxmLm9wdGlvbnMucHJldmVudEZvY3VzWm9vbSApIHsKCQkJCQkkLm1vYmlsZS56b29tLmRpc2FibGUoIHRydWUgKTsKCQkJfQoJCX0pOwoJCXNlbGYuYnV0dG9uLmJpbmQoICJtb3VzZXVwIiwgZnVuY3Rpb24oKSB7CgkJCWlmICggc2VsZi5vcHRpb25zLnByZXZlbnRGb2N1c1pvb20gKSB7CgkJCQlzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoJCQkJCSQubW9iaWxlLnpvb20uZW5hYmxlKCB0cnVlICk7CgkJCQl9LCAwICk7CgkJCX0KCQl9KTsKCQlzZWxmLnNlbGVjdC5iaW5kKCAiYmx1ciIsIGZ1bmN0aW9uKCkgewoJCQlpZiAoIHNlbGYub3B0aW9ucy5wcmV2ZW50Rm9jdXNab29tICkgewoJCQkJJC5tb2JpbGUuem9vbS5lbmFibGUoIHRydWUgKTsKCQkJfQoJCX0pOwoKCX0sCgoJc2VsZWN0ZWQ6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLl9zZWxlY3RPcHRpb25zKCkuZmlsdGVyKCAiOnNlbGVjdGVkIiApOwoJfSwKCglzZWxlY3RlZEluZGljZXM6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpczsKCgkJcmV0dXJuIHRoaXMuc2VsZWN0ZWQoKS5tYXAoZnVuY3Rpb24oKSB7CgkJCXJldHVybiBzZWxmLl9zZWxlY3RPcHRpb25zKCkuaW5kZXgoIHRoaXMgKTsKCQl9KS5nZXQoKTsKCX0sCgoJc2V0QnV0dG9uVGV4dDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzLAoJCQlzZWxlY3RlZCA9IHRoaXMuc2VsZWN0ZWQoKSwKCQkJdGV4dCA9IHRoaXMucGxhY2Vob2xkZXIsCgkJCXNwYW4gPSAkKCBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAic3BhbiIgKSApOwoKCQl0aGlzLmJ1dHRvbi5jaGlsZHJlbiggInNwYW4iICkubm90KCAiLnVpLWxpLWNvdW50IiApLnJlbW92ZSgpLmVuZCgpLmVuZCgpLnByZXBlbmQoIChmdW5jdGlvbigpIHsKCQkJaWYgKCBzZWxlY3RlZC5sZW5ndGggKSB7CgkJCQl0ZXh0ID0gc2VsZWN0ZWQubWFwKGZ1bmN0aW9uKCkgewoJCQkJCXJldHVybiAkKCB0aGlzICkudGV4dCgpOwoJCQkJfSkuZ2V0KCkuam9pbiggIiwgIiApOwoJCQl9IGVsc2UgewoJCQkJdGV4dCA9IHNlbGYucGxhY2Vob2xkZXI7CgkJCX0KCgkJCWlmICggdGV4dCApIHsKCQkJCXNwYW4udGV4dCggdGV4dCApOwoJCQl9IGVsc2UgewoJCQkJc3Bhbi5odG1sKCAiJm5ic3A7IiApOwoJCQl9CgoJCQkvLyBUT0RPIHBvc3NpYmx5IGFnZ3JlZ2F0ZSBtdWx0aXBsZSBzZWxlY3Qgb3B0aW9uIGNsYXNzZXMKCQkJcmV0dXJuIHNwYW4KCQkJCS5hZGRDbGFzcyggc2VsZi5zZWxlY3QuYXR0ciggImNsYXNzIiApICkKCQkJCS5hZGRDbGFzcyggc2VsZWN0ZWQuYXR0ciggImNsYXNzIiApICkKCQkJCS5yZW1vdmVDbGFzcyggInVpLXNjcmVlbi1oaWRkZW4iICk7CgkJfSkoKSk7Cgl9LAoKCXNldEJ1dHRvbkNvdW50OiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZWN0ZWQgPSB0aGlzLnNlbGVjdGVkKCk7CgoJCS8vIG11bHRpcGxlIGNvdW50IGluc2lkZSBidXR0b24KCQlpZiAoIHRoaXMuaXNNdWx0aXBsZSApIHsKCQkJdGhpcy5idXR0b25Db3VudFsgc2VsZWN0ZWQubGVuZ3RoID4gMSA/ICJzaG93IiA6ICJoaWRlIiBdKCkudGV4dCggc2VsZWN0ZWQubGVuZ3RoICk7CgkJfQoJfSwKCglfaGFuZGxlS2V5ZG93bjogZnVuY3Rpb24oIC8qIGV2ZW50ICovICkgewoJCXRoaXMuX2RlbGF5KCAiX3JlZnJlc2hCdXR0b24iICk7Cgl9LAoKCV9yZXNldDogZnVuY3Rpb24oKSB7CgkJdGhpcy5yZWZyZXNoKCk7Cgl9LAoKCV9yZWZyZXNoQnV0dG9uOiBmdW5jdGlvbigpIHsKCQl0aGlzLnNldEJ1dHRvblRleHQoKTsKCQl0aGlzLnNldEJ1dHRvbkNvdW50KCk7Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3JlZnJlc2hCdXR0b24oKTsKCX0sCgoJLy8gb3BlbiBhbmQgY2xvc2UgcHJlc2VydmVkIGluIG5hdGl2ZSBzZWxlY3RzCgkvLyB0byBzaW1wbGlmeSB1c2VycyBjb2RlIHdoZW4gbG9vcGluZyBvdmVyIHNlbGVjdHMKCW9wZW46ICQubm9vcCwKCWNsb3NlOiAkLm5vb3AsCgoJZGlzYWJsZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5fc2V0RGlzYWJsZWQoIHRydWUgKTsKCQl0aGlzLmJ1dHRvbi5hZGRDbGFzcyggInVpLXN0YXRlLWRpc2FibGVkIiApOwoJfSwKCgllbmFibGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3NldERpc2FibGVkKCBmYWxzZSApOwoJCXRoaXMuYnV0dG9uLnJlbW92ZUNsYXNzKCAidWktc3RhdGUtZGlzYWJsZWQiICk7Cgl9Cn0sICQubW9iaWxlLmJlaGF2aW9ycy5mb3JtUmVzZXQgKSApOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS5saW5rcyA9IGZ1bmN0aW9uKCB0YXJnZXQgKSB7CgoJLy9saW5rcyB3aXRoaW4gY29udGVudCBhcmVhcywgdGVzdHMgaW5jbHVkZWQgd2l0aCBwYWdlCgkkKCB0YXJnZXQgKQoJCS5maW5kKCAiYSIgKQoJCS5qcW1FbmhhbmNlYWJsZSgpCgkJLmZpbHRlciggIjpqcW1EYXRhKHJlbD0ncG9wdXAnKVtocmVmXVtocmVmIT0nJ10iICkKCQkuZWFjaCggZnVuY3Rpb24oKSB7CgkJCS8vIEFjY2Vzc2liaWxpdHkgaW5mbyBmb3IgcG9wdXBzCgkJCXZhciBlID0gdGhpcywKCQkJCWhyZWYgPSAkKCB0aGlzICkuYXR0ciggImhyZWYiICksCgkJCQlzZWwgPSAkLm1vYmlsZS5wYXRoLmhhc2hUb1NlbGVjdG9yKCBocmVmICksCgkJCQlpZHJlZiA9IGhyZWYuc3Vic3RyaW5nKCAxICk7CgoJCQllLnNldEF0dHJpYnV0ZSggImFyaWEtaGFzcG9wdXAiLCB0cnVlICk7CgkJCWUuc2V0QXR0cmlidXRlKCAiYXJpYS1vd25zIiwgaWRyZWYgKTsKCQkJZS5zZXRBdHRyaWJ1dGUoICJhcmlhLWV4cGFuZGVkIiwgZmFsc2UgKTsKCQkJJCggZG9jdW1lbnQgKQoJCQkJLm9uKCAicG9wdXBhZnRlcm9wZW4iLCBzZWwsIGZ1bmN0aW9uKCkgewoJCQkJCWUuc2V0QXR0cmlidXRlKCAiYXJpYS1leHBhbmRlZCIsIHRydWUgKTsKCQkJCX0pCgkJCQkub24oICJwb3B1cGFmdGVyY2xvc2UiLCBzZWwsIGZ1bmN0aW9uKCkgewoJCQkJCWUuc2V0QXR0cmlidXRlKCAiYXJpYS1leHBhbmRlZCIsIGZhbHNlICk7CgkJCQl9KTsKCQl9KQoJCS5lbmQoKQoJCS5ub3QoICIudWktYnRuLCA6anFtRGF0YShyb2xlPSdub25lJyksIDpqcW1EYXRhKHJvbGU9J25vanMnKSIgKQoJCS5hZGRDbGFzcyggInVpLWxpbmsiICk7Cgp9OwoKfSkoIGpRdWVyeSApOwoKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKZnVuY3Rpb24gZml0U2VnbWVudEluc2lkZVNlZ21lbnQoIHdpbmRvd1NpemUsIHNlZ21lbnRTaXplLCBvZmZzZXQsIGRlc2lyZWQgKSB7Cgl2YXIgcmV0dXJuVmFsdWUgPSBkZXNpcmVkOwoKCWlmICggd2luZG93U2l6ZSA8IHNlZ21lbnRTaXplICkgewoJCS8vIENlbnRlciBzZWdtZW50IGlmIGl0J3MgYmlnZ2VyIHRoYW4gdGhlIHdpbmRvdwoJCXJldHVyblZhbHVlID0gb2Zmc2V0ICsgKCB3aW5kb3dTaXplIC0gc2VnbWVudFNpemUgKSAvIDI7Cgl9IGVsc2UgewoJCS8vIE90aGVyd2lzZSBjZW50ZXIgaXQgYXQgdGhlIGRlc2lyZWQgY29vcmRpbmF0ZSB3aGlsZSBrZWVwaW5nIGl0IGNvbXBsZXRlbHkgaW5zaWRlIHRoZSB3aW5kb3cKCQlyZXR1cm5WYWx1ZSA9IE1hdGgubWluKCBNYXRoLm1heCggb2Zmc2V0LCBkZXNpcmVkIC0gc2VnbWVudFNpemUgLyAyICksIG9mZnNldCArIHdpbmRvd1NpemUgLSBzZWdtZW50U2l6ZSApOwoJfQoKCXJldHVybiByZXR1cm5WYWx1ZTsKfQoKZnVuY3Rpb24gZ2V0V2luZG93Q29vcmRpbmF0ZXMoIHRoZVdpbmRvdyApIHsKCXJldHVybiB7CgkJeDogdGhlV2luZG93LnNjcm9sbExlZnQoKSwKCQl5OiB0aGVXaW5kb3cuc2Nyb2xsVG9wKCksCgkJY3g6ICggdGhlV2luZG93WyAwIF0uaW5uZXJXaWR0aCB8fCB0aGVXaW5kb3cud2lkdGgoKSApLAoJCWN5OiAoIHRoZVdpbmRvd1sgMCBdLmlubmVySGVpZ2h0IHx8IHRoZVdpbmRvdy5oZWlnaHQoKSApCgl9Owp9CgokLndpZGdldCggIm1vYmlsZS5wb3B1cCIsIHsKCW9wdGlvbnM6IHsKCQl3cmFwcGVyQ2xhc3M6IG51bGwsCgkJdGhlbWU6IG51bGwsCgkJb3ZlcmxheVRoZW1lOiBudWxsLAoJCXNoYWRvdzogdHJ1ZSwKCQljb3JuZXJzOiB0cnVlLAoJCXRyYW5zaXRpb246ICJub25lIiwKCQlwb3NpdGlvblRvOiAib3JpZ2luIiwKCQl0b2xlcmFuY2U6IG51bGwsCgkJY2xvc2VMaW5rU2VsZWN0b3I6ICJhOmpxbURhdGEocmVsPSdiYWNrJykiLAoJCWNsb3NlTGlua0V2ZW50czogImNsaWNrLnBvcHVwIiwKCQluYXZpZ2F0ZUV2ZW50czogIm5hdmlnYXRlLnBvcHVwIiwKCQljbG9zZUV2ZW50czogIm5hdmlnYXRlLnBvcHVwIHBhZ2ViZWZvcmVjaGFuZ2UucG9wdXAiLAoJCWRpc21pc3NpYmxlOiB0cnVlLAoJCWVuaGFuY2VkOiBmYWxzZSwKCgkJLy8gTk9URSBXaW5kb3dzIFBob25lIDcgaGFzIGEgc2Nyb2xsIHBvc2l0aW9uIGNhY2hpbmcgaXNzdWUgdGhhdAoJCS8vICAgICAgcmVxdWlyZXMgdXMgdG8gZGlzYWJsZSBwb3B1cCBoaXN0b3J5IG1hbmFnZW1lbnQgYnkgZGVmYXVsdAoJCS8vICAgICAgaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnktbW9iaWxlL2lzc3Vlcy80Nzg0CgkJLy8KCQkvLyBOT1RFIHRoaXMgb3B0aW9uIGlzIG1vZGlmaWVkIGluIF9jcmVhdGUhCgkJaGlzdG9yeTogISQubW9iaWxlLmJyb3dzZXIub2xkSUUKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdmFyIHRoZUVsZW1lbnQgPSB0aGlzLmVsZW1lbnQsCgkJCW15SWQgPSB0aGVFbGVtZW50LmF0dHIoICJpZCIgKSwKCQkJY3VycmVudE9wdGlvbnMgPSB0aGlzLm9wdGlvbnM7CgoJCS8vIFdlIG5lZWQgdG8gYWRqdXN0IHRoZSBoaXN0b3J5IG9wdGlvbiB0byBiZSBmYWxzZSBpZiB0aGVyZSdzIG5vIEFKQVggbmF2LgoJCS8vIFdlIGNhbid0IGRvIGl0IGluIHRoZSBvcHRpb24gZGVjbGFyYXRpb25zIGJlY2F1c2UgdGhvc2UgYXJlIHJ1biBiZWZvcmUKCQkvLyBpdCBpcyBkZXRlcm1pbmVkIHdoZXRoZXIgdGhlcmUgc2hhbGwgYmUgQUpBWCBuYXYuCgkJY3VycmVudE9wdGlvbnMuaGlzdG9yeSA9IGN1cnJlbnRPcHRpb25zLmhpc3RvcnkgJiYgJC5tb2JpbGUuYWpheEVuYWJsZWQgJiYgJC5tb2JpbGUuaGFzaExpc3RlbmluZ0VuYWJsZWQ7CgoJCS8vIERlZmluZSBpbnN0YW5jZSB2YXJpYWJsZXMKCQkkLmV4dGVuZCggdGhpcywgewoJCQlfc2Nyb2xsVG9wOiAwLAoJCQlfcGFnZTogdGhlRWxlbWVudC5jbG9zZXN0KCAiLnVpLXBhZ2UiICksCgkJCV91aTogbnVsbCwKCQkJX2ZhbGxiYWNrVHJhbnNpdGlvbjogIiIsCgkJCV9jdXJyZW50VHJhbnNpdGlvbjogZmFsc2UsCgkJCV9wcmVyZXF1aXNpdGVzOiBudWxsLAoJCQlfaXNPcGVuOiBmYWxzZSwKCQkJX3RvbGVyYW5jZTogbnVsbCwKCQkJX3Jlc2l6ZURhdGE6IG51bGwsCgkJCV9pZ25vcmVSZXNpemVUbzogMCwKCQkJX29yaWVudGF0aW9uY2hhbmdlSW5Qcm9ncmVzczogZmFsc2UKCQl9KTsKCgkJaWYgKCB0aGlzLl9wYWdlLmxlbmd0aCA9PT0gMCApIHsKCQkJdGhpcy5fcGFnZSA9ICQoICJib2R5IiApOwoJCX0KCgkJaWYgKCBjdXJyZW50T3B0aW9ucy5lbmhhbmNlZCApIHsKCQkJdGhpcy5fdWkgPSB7CgkJCQljb250YWluZXI6IHRoZUVsZW1lbnQucGFyZW50KCksCgkJCQlzY3JlZW46IHRoZUVsZW1lbnQucGFyZW50KCkucHJldigpLAoJCQkJcGxhY2Vob2xkZXI6ICQoIHRoaXMuZG9jdW1lbnRbIDAgXS5nZXRFbGVtZW50QnlJZCggbXlJZCArICItcGxhY2Vob2xkZXIiICkgKQoJCQl9OwoJCX0gZWxzZSB7CgkJCXRoaXMuX3VpID0gdGhpcy5fZW5oYW5jZSggdGhlRWxlbWVudCwgbXlJZCApOwoJCQl0aGlzLl9hcHBseVRyYW5zaXRpb24oIGN1cnJlbnRPcHRpb25zLnRyYW5zaXRpb24gKTsKCQl9CgkJdGhpcwoJCQkuX3NldFRvbGVyYW5jZSggY3VycmVudE9wdGlvbnMudG9sZXJhbmNlICkKCQkJLl91aS5mb2N1c0VsZW1lbnQgPSB0aGlzLl91aS5jb250YWluZXI7CgoJCS8vIEV2ZW50IGhhbmRsZXJzCgkJdGhpcy5fb24oIHRoaXMuX3VpLnNjcmVlbiwgeyAidmNsaWNrIjogIl9lYXRFdmVudEFuZENsb3NlIiB9ICk7CgkJdGhpcy5fb24oIHRoaXMud2luZG93LCB7CgkJCW9yaWVudGF0aW9uY2hhbmdlOiAkLnByb3h5KCB0aGlzLCAiX2hhbmRsZVdpbmRvd09yaWVudGF0aW9uY2hhbmdlIiApLAoJCQlyZXNpemU6ICQucHJveHkoIHRoaXMsICJfaGFuZGxlV2luZG93UmVzaXplIiApLAoJCQlrZXl1cDogJC5wcm94eSggdGhpcywgIl9oYW5kbGVXaW5kb3dLZXlVcCIgKQoJCX0pOwoJCXRoaXMuX29uKCB0aGlzLmRvY3VtZW50LCB7ICJmb2N1c2luIjogIl9oYW5kbGVEb2N1bWVudEZvY3VzSW4iIH0gKTsKCX0sCgoJX2VuaGFuY2U6IGZ1bmN0aW9uKCB0aGVFbGVtZW50LCBteUlkICkgewoJCXZhciBjdXJyZW50T3B0aW9ucyA9IHRoaXMub3B0aW9ucywKCQkJd3JhcHBlckNsYXNzID0gY3VycmVudE9wdGlvbnMud3JhcHBlckNsYXNzLAoJCQl1aSA9IHsKCQkJCXNjcmVlbjogJCggIjxkaXYgY2xhc3M9J3VpLXNjcmVlbi1oaWRkZW4gdWktcG9wdXAtc2NyZWVuICIgKwoJCQkJdGhpcy5fdGhlbWVDbGFzc0Zyb21PcHRpb24oICJ1aS1vdmVybGF5LSIsIGN1cnJlbnRPcHRpb25zLm92ZXJsYXlUaGVtZSApICsgIic+PC9kaXY+IiApLAoJCQkJcGxhY2Vob2xkZXI6ICQoICI8ZGl2IHN0eWxlPSdkaXNwbGF5OiBub25lOyc+PCEtLSBwbGFjZWhvbGRlciAtLT48L2Rpdj4iICksCgkJCQljb250YWluZXI6ICQoICI8ZGl2IGNsYXNzPSd1aS1wb3B1cC1jb250YWluZXIgdWktcG9wdXAtaGlkZGVuIHVpLXBvcHVwLXRydW5jYXRlIiArCgkJCQkJKCB3cmFwcGVyQ2xhc3MgPyAoICIgIiArIHdyYXBwZXJDbGFzcyApIDogIiIgKSArICInPjwvZGl2PiIgKQoJCQl9LAoJCQlmcmFnbWVudCA9IHRoaXMuZG9jdW1lbnRbIDAgXS5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCk7CgoJCWZyYWdtZW50LmFwcGVuZENoaWxkKCB1aS5zY3JlZW5bIDAgXSApOwoJCWZyYWdtZW50LmFwcGVuZENoaWxkKCB1aS5jb250YWluZXJbIDAgXSApOwoKCQlpZiAoIG15SWQgKSB7CgkJCXVpLnNjcmVlbi5hdHRyKCAiaWQiLCBteUlkICsgIi1zY3JlZW4iICk7CgkJCXVpLmNvbnRhaW5lci5hdHRyKCAiaWQiLCBteUlkICsgIi1wb3B1cCIgKTsKCQkJdWkucGxhY2Vob2xkZXIKCQkJCS5hdHRyKCAiaWQiLCBteUlkICsgIi1wbGFjZWhvbGRlciIgKQoJCQkJLmh0bWwoICI8IS0tIHBsYWNlaG9sZGVyIGZvciAiICsgbXlJZCArICIgLS0+IiApOwoJCX0KCgkJLy8gQXBwbHkgdGhlIHByb3RvCgkJdGhpcy5fcGFnZVsgMCBdLmFwcGVuZENoaWxkKCBmcmFnbWVudCApOwoJCS8vIExlYXZlIGEgcGxhY2Vob2xkZXIgd2hlcmUgdGhlIGVsZW1lbnQgdXNlZCB0byBiZQoJCXVpLnBsYWNlaG9sZGVyLmluc2VydEFmdGVyKCB0aGVFbGVtZW50ICk7CgkJdGhlRWxlbWVudAoJCQkuZGV0YWNoKCkKCQkJLmFkZENsYXNzKCAidWktcG9wdXAgIiArCgkJCQl0aGlzLl90aGVtZUNsYXNzRnJvbU9wdGlvbiggInVpLWJvZHktIiwgY3VycmVudE9wdGlvbnMudGhlbWUgKSArICIgIiArCgkJCQkoIGN1cnJlbnRPcHRpb25zLnNoYWRvdyA/ICJ1aS1vdmVybGF5LXNoYWRvdyAiIDogIiIgKSArCgkJCQkoIGN1cnJlbnRPcHRpb25zLmNvcm5lcnMgPyAidWktY29ybmVyLWFsbCAiIDogIiIgKSApCgkJCS5hcHBlbmRUbyggdWkuY29udGFpbmVyICk7CgoJCXJldHVybiB1aTsKCX0sCgoJX2VhdEV2ZW50QW5kQ2xvc2U6IGZ1bmN0aW9uKCB0aGVFdmVudCApIHsKCQl0aGVFdmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCXRoZUV2ZW50LnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbigpOwoJCWlmICggdGhpcy5vcHRpb25zLmRpc21pc3NpYmxlICkgewoJCQl0aGlzLmNsb3NlKCk7CgkJfQoJCXJldHVybiBmYWxzZTsKCX0sCgoJLy8gTWFrZSBzdXJlIHRoZSBzY3JlZW4gc2l6ZSBpcyBpbmNyZWFzZWQgYmV5b25kIHRoZSBwYWdlIGhlaWdodCBpZiB0aGUgcG9wdXAncyBjYXVzZXMgdGhlIGRvY3VtZW50IHRvIGluY3JlYXNlIGluIGhlaWdodAoJX3Jlc2l6ZVNjcmVlbjogZnVuY3Rpb24oKSB7CgkJdmFyIHBvcHVwSGVpZ2h0ID0gdGhpcy5fdWkuY29udGFpbmVyLm91dGVySGVpZ2h0KCB0cnVlICk7CgoJCXRoaXMuX3VpLnNjcmVlbi5yZW1vdmVBdHRyKCAic3R5bGUiICk7CgkJaWYgKCBwb3B1cEhlaWdodCA+IHRoaXMuX3VpLnNjcmVlbi5oZWlnaHQoKSApIHsKCQkJdGhpcy5fdWkuc2NyZWVuLmhlaWdodCggcG9wdXBIZWlnaHQgKTsKCQl9Cgl9LAoKCV9oYW5kbGVXaW5kb3dLZXlVcDogZnVuY3Rpb24oIHRoZUV2ZW50ICkgewoJCWlmICggdGhpcy5faXNPcGVuICYmIHRoZUV2ZW50LmtleUNvZGUgPT09ICQubW9iaWxlLmtleUNvZGUuRVNDQVBFICkgewoJCQlyZXR1cm4gdGhpcy5fZWF0RXZlbnRBbmRDbG9zZSggdGhlRXZlbnQgKTsKCQl9Cgl9LAoKCV9leHBlY3RSZXNpemVFdmVudDogZnVuY3Rpb24oKSB7CgkJdmFyIHdpbmRvd0Nvb3JkaW5hdGVzID0gZ2V0V2luZG93Q29vcmRpbmF0ZXMoIHRoaXMud2luZG93ICk7CgoJCWlmICggdGhpcy5fcmVzaXplRGF0YSApIHsKCQkJaWYgKCB3aW5kb3dDb29yZGluYXRlcy54ID09PSB0aGlzLl9yZXNpemVEYXRhLndpbmRvd0Nvb3JkaW5hdGVzLnggJiYKCQkJCXdpbmRvd0Nvb3JkaW5hdGVzLnkgPT09IHRoaXMuX3Jlc2l6ZURhdGEud2luZG93Q29vcmRpbmF0ZXMueSAmJgoJCQkJd2luZG93Q29vcmRpbmF0ZXMuY3ggPT09IHRoaXMuX3Jlc2l6ZURhdGEud2luZG93Q29vcmRpbmF0ZXMuY3ggJiYKCQkJCXdpbmRvd0Nvb3JkaW5hdGVzLmN5ID09PSB0aGlzLl9yZXNpemVEYXRhLndpbmRvd0Nvb3JkaW5hdGVzLmN5ICkgewoJCQkJLy8gdGltZW91dCBub3QgcmVmcmVzaGVkCgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0gZWxzZSB7CgkJCQkvLyBjbGVhciBleGlzdGluZyB0aW1lb3V0IC0gaXQgd2lsbCBiZSByZWZyZXNoZWQgYmVsb3cKCQkJCWNsZWFyVGltZW91dCggdGhpcy5fcmVzaXplRGF0YS50aW1lb3V0SWQgKTsKCQkJfQoJCX0KCgkJdGhpcy5fcmVzaXplRGF0YSA9IHsKCQkJdGltZW91dElkOiB0aGlzLl9kZWxheSggIl9yZXNpemVUaW1lb3V0IiwgMjAwICksCgkJCXdpbmRvd0Nvb3JkaW5hdGVzOiB3aW5kb3dDb29yZGluYXRlcwoJCX07CgoJCXJldHVybiB0cnVlOwoJfSwKCglfcmVzaXplVGltZW91dDogZnVuY3Rpb24oKSB7CgkJaWYgKCB0aGlzLl9pc09wZW4gKSB7CgkJCWlmICggIXRoaXMuX2V4cGVjdFJlc2l6ZUV2ZW50KCkgKSB7CgkJCQlpZiAoIHRoaXMuX3VpLmNvbnRhaW5lci5oYXNDbGFzcyggInVpLXBvcHVwLWhpZGRlbiIgKSApIHsKCQkJCQkvLyBlZmZlY3RpdmVseSByYXBpZC1vcGVuIHRoZSBwb3B1cCB3aGlsZSBsZWF2aW5nIHRoZSBzY3JlZW4gaW50YWN0CgkJCQkJdGhpcy5fdWkuY29udGFpbmVyLnJlbW92ZUNsYXNzKCAidWktcG9wdXAtaGlkZGVuIHVpLXBvcHVwLXRydW5jYXRlIiApOwoJCQkJCXRoaXMucmVwb3NpdGlvbiggeyBwb3NpdGlvblRvOiAid2luZG93IiB9ICk7CgkJCQkJdGhpcy5faWdub3JlUmVzaXplRXZlbnRzKCk7CgkJCQl9CgoJCQkJdGhpcy5fcmVzaXplU2NyZWVuKCk7CgkJCQl0aGlzLl9yZXNpemVEYXRhID0gbnVsbDsKCQkJCXRoaXMuX29yaWVudGF0aW9uY2hhbmdlSW5Qcm9ncmVzcyA9IGZhbHNlOwoJCQl9CgkJfSBlbHNlIHsKCQkJdGhpcy5fcmVzaXplRGF0YSA9IG51bGw7CgkJCXRoaXMuX29yaWVudGF0aW9uY2hhbmdlSW5Qcm9ncmVzcyA9IGZhbHNlOwoJCX0KCX0sCgoJX3N0b3BJZ25vcmluZ1Jlc2l6ZUV2ZW50czogZnVuY3Rpb24oKSB7CgkJdGhpcy5faWdub3JlUmVzaXplVG8gPSAwOwoJfSwKCglfaWdub3JlUmVzaXplRXZlbnRzOiBmdW5jdGlvbigpIHsKCQlpZiAoIHRoaXMuX2lnbm9yZVJlc2l6ZVRvICkgewoJCQljbGVhclRpbWVvdXQoIHRoaXMuX2lnbm9yZVJlc2l6ZVRvICk7CgkJfQoJCXRoaXMuX2lnbm9yZVJlc2l6ZVRvID0gdGhpcy5fZGVsYXkoICJfc3RvcElnbm9yaW5nUmVzaXplRXZlbnRzIiwgMTAwMCApOwoJfSwKCglfaGFuZGxlV2luZG93UmVzaXplOiBmdW5jdGlvbigvKiB0aGVFdmVudCAqLykgewoJCWlmICggdGhpcy5faXNPcGVuICYmIHRoaXMuX2lnbm9yZVJlc2l6ZVRvID09PSAwICkgewoJCQlpZiAoICggdGhpcy5fZXhwZWN0UmVzaXplRXZlbnQoKSB8fCB0aGlzLl9vcmllbnRhdGlvbmNoYW5nZUluUHJvZ3Jlc3MgKSAmJgoJCQkJIXRoaXMuX3VpLmNvbnRhaW5lci5oYXNDbGFzcyggInVpLXBvcHVwLWhpZGRlbiIgKSApIHsKCQkJCS8vIGVmZmVjdGl2ZWx5IHJhcGlkLWNsb3NlIHRoZSBwb3B1cCB3aGlsZSBsZWF2aW5nIHRoZSBzY3JlZW4gaW50YWN0CgkJCQl0aGlzLl91aS5jb250YWluZXIKCQkJCQkuYWRkQ2xhc3MoICJ1aS1wb3B1cC1oaWRkZW4gdWktcG9wdXAtdHJ1bmNhdGUiICkKCQkJCQkucmVtb3ZlQXR0ciggInN0eWxlIiApOwoJCQl9CgkJfQoJfSwKCglfaGFuZGxlV2luZG93T3JpZW50YXRpb25jaGFuZ2U6IGZ1bmN0aW9uKC8qIHRoZUV2ZW50ICovKSB7CgkJaWYgKCAhdGhpcy5fb3JpZW50YXRpb25jaGFuZ2VJblByb2dyZXNzICYmIHRoaXMuX2lzT3BlbiAmJiB0aGlzLl9pZ25vcmVSZXNpemVUbyA9PT0gMCApIHsKCQkJdGhpcy5fZXhwZWN0UmVzaXplRXZlbnQoKTsKCQkJdGhpcy5fb3JpZW50YXRpb25jaGFuZ2VJblByb2dyZXNzID0gdHJ1ZTsKCQl9Cgl9LAoKCS8vIFdoZW4gdGhlIHBvcHVwIGlzIG9wZW4sIGF0dGVtcHRpbmcgdG8gZm9jdXMgb24gYW4gZWxlbWVudCB0aGF0IGlzIG5vdCBhCgkvLyBjaGlsZCBvZiB0aGUgcG9wdXAgd2lsbCByZWRpcmVjdCBmb2N1cyB0byB0aGUgcG9wdXAKCV9oYW5kbGVEb2N1bWVudEZvY3VzSW46IGZ1bmN0aW9uKCB0aGVFdmVudCApIHsKCQl2YXIgdGFyZ2V0LAoJCQl0YXJnZXRFbGVtZW50ID0gdGhlRXZlbnQudGFyZ2V0LAoJCQl1aSA9IHRoaXMuX3VpOwoKCQlpZiAoICF0aGlzLl9pc09wZW4gKSB7CgkJCXJldHVybjsKCQl9CgoJCWlmICggdGFyZ2V0RWxlbWVudCAhPT0gdWkuY29udGFpbmVyWyAwIF0gKSB7CgkJCXRhcmdldCA9ICQoIHRhcmdldEVsZW1lbnQgKTsKCQkJaWYgKCAwID09PSB0YXJnZXQucGFyZW50cygpLmZpbHRlciggdWkuY29udGFpbmVyWyAwIF0gKS5sZW5ndGggKSB7CgkJCQkkKCB0aGlzLmRvY3VtZW50WyAwIF0uYWN0aXZlRWxlbWVudCApLm9uZSggImZvY3VzIiwgZnVuY3Rpb24oLyogdGhlRXZlbnQgKi8pIHsKCQkJCQl0YXJnZXQuYmx1cigpOwoJCQkJfSk7CgkJCQl1aS5mb2N1c0VsZW1lbnQuZm9jdXMoKTsKCQkJCXRoZUV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQl0aGVFdmVudC5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24oKTsKCQkJCXJldHVybiBmYWxzZTsKCQkJfSBlbHNlIGlmICggdWkuZm9jdXNFbGVtZW50WyAwIF0gPT09IHVpLmNvbnRhaW5lclsgMCBdICkgewoJCQkJdWkuZm9jdXNFbGVtZW50ID0gdGFyZ2V0OwoJCQl9CgkJfQoKCQl0aGlzLl9pZ25vcmVSZXNpemVFdmVudHMoKTsKCX0sCgoJX3RoZW1lQ2xhc3NGcm9tT3B0aW9uOiBmdW5jdGlvbiggcHJlZml4LCB2YWx1ZSApIHsKCQlyZXR1cm4gKCB2YWx1ZSA/ICggdmFsdWUgPT09ICJub25lIiA/ICIiIDogKCBwcmVmaXggKyB2YWx1ZSApICkgOiAoIHByZWZpeCArICJpbmhlcml0IiApICk7Cgl9LAoKCV9hcHBseVRyYW5zaXRpb246IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQlpZiAoIHZhbHVlICkgewoJCQl0aGlzLl91aS5jb250YWluZXIucmVtb3ZlQ2xhc3MoIHRoaXMuX2ZhbGxiYWNrVHJhbnNpdGlvbiApOwoJCQlpZiAoIHZhbHVlICE9PSAibm9uZSIgKSB7CgkJCQl0aGlzLl9mYWxsYmFja1RyYW5zaXRpb24gPSAkLm1vYmlsZS5fbWF5YmVEZWdyYWRlVHJhbnNpdGlvbiggdmFsdWUgKTsKCQkJCWlmICggdGhpcy5fZmFsbGJhY2tUcmFuc2l0aW9uID09PSAibm9uZSIgKSB7CgkJCQkJdGhpcy5fZmFsbGJhY2tUcmFuc2l0aW9uID0gIiI7CgkJCQl9CgkJCQl0aGlzLl91aS5jb250YWluZXIuYWRkQ2xhc3MoIHRoaXMuX2ZhbGxiYWNrVHJhbnNpdGlvbiApOwoJCQl9CgkJfQoKCQlyZXR1cm4gdGhpczsKCX0sCgoJX3NldE9wdGlvbnM6IGZ1bmN0aW9uKCBuZXdPcHRpb25zICkgewoJCXZhciBjdXJyZW50T3B0aW9ucyA9IHRoaXMub3B0aW9ucywKCQkJdGhlRWxlbWVudCA9IHRoaXMuZWxlbWVudCwKCQkJc2NyZWVuID0gdGhpcy5fdWkuc2NyZWVuOwoKCQlpZiAoIG5ld09wdGlvbnMud3JhcHBlckNsYXNzICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMuX3VpLmNvbnRhaW5lcgoJCQkJLnJlbW92ZUNsYXNzKCBjdXJyZW50T3B0aW9ucy53cmFwcGVyQ2xhc3MgKQoJCQkJLmFkZENsYXNzKCBuZXdPcHRpb25zLndyYXBwZXJDbGFzcyApOwoJCX0KCgkJaWYgKCBuZXdPcHRpb25zLnRoZW1lICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoZUVsZW1lbnQKCQkJCS5yZW1vdmVDbGFzcyggdGhpcy5fdGhlbWVDbGFzc0Zyb21PcHRpb24oICJ1aS1ib2R5LSIsIGN1cnJlbnRPcHRpb25zLnRoZW1lICkgKQoJCQkJLmFkZENsYXNzKCB0aGlzLl90aGVtZUNsYXNzRnJvbU9wdGlvbiggInVpLWJvZHktIiwgbmV3T3B0aW9ucy50aGVtZSApICk7CgkJfQoKCQlpZiAoIG5ld09wdGlvbnMub3ZlcmxheVRoZW1lICE9PSB1bmRlZmluZWQgKSB7CgkJCXNjcmVlbgoJCQkJLnJlbW92ZUNsYXNzKCB0aGlzLl90aGVtZUNsYXNzRnJvbU9wdGlvbiggInVpLW92ZXJsYXktIiwgY3VycmVudE9wdGlvbnMub3ZlcmxheVRoZW1lICkgKQoJCQkJLmFkZENsYXNzKCB0aGlzLl90aGVtZUNsYXNzRnJvbU9wdGlvbiggInVpLW92ZXJsYXktIiwgbmV3T3B0aW9ucy5vdmVybGF5VGhlbWUgKSApOwoKCQkJaWYgKCB0aGlzLl9pc09wZW4gKSB7CgkJCQlzY3JlZW4uYWRkQ2xhc3MoICJpbiIgKTsKCQkJfQoJCX0KCgkJaWYgKCBuZXdPcHRpb25zLnNoYWRvdyAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGVFbGVtZW50LnRvZ2dsZUNsYXNzKCAidWktb3ZlcmxheS1zaGFkb3ciLCBuZXdPcHRpb25zLnNoYWRvdyApOwoJCX0KCgkJaWYgKCBuZXdPcHRpb25zLmNvcm5lcnMgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhlRWxlbWVudC50b2dnbGVDbGFzcyggInVpLWNvcm5lci1hbGwiLCBuZXdPcHRpb25zLmNvcm5lcnMgKTsKCQl9CgoJCWlmICggbmV3T3B0aW9ucy50cmFuc2l0aW9uICE9PSB1bmRlZmluZWQgKSB7CgkJCWlmICggIXRoaXMuX2N1cnJlbnRUcmFuc2l0aW9uICkgewoJCQkJdGhpcy5fYXBwbHlUcmFuc2l0aW9uKCBuZXdPcHRpb25zLnRyYW5zaXRpb24gKTsKCQkJfQoJCX0KCgkJaWYgKCBuZXdPcHRpb25zLnRvbGVyYW5jZSAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLl9zZXRUb2xlcmFuY2UoIG5ld09wdGlvbnMudG9sZXJhbmNlICk7CgkJfQoKCQlpZiAoIG5ld09wdGlvbnMuZGlzYWJsZWQgIT09IHVuZGVmaW5lZCApIHsKCQkJaWYgKCBuZXdPcHRpb25zLmRpc2FibGVkICkgewoJCQkJdGhpcy5jbG9zZSgpOwoJCQl9CgkJfQoKCQlyZXR1cm4gdGhpcy5fc3VwZXIoIG5ld09wdGlvbnMgKTsKCX0sCgoJX3NldFRvbGVyYW5jZTogZnVuY3Rpb24oIHZhbHVlICkgewoJCXZhciB0b2wgPSB7IHQ6IDMwLCByOiAxNSwgYjogMzAsIGw6IDE1IH0sCgkJCWFyOwoKCQlpZiAoIHZhbHVlICE9PSB1bmRlZmluZWQgKSB7CgkJCWFyID0gU3RyaW5nKCB2YWx1ZSApLnNwbGl0KCAiLCIgKTsKCgkJCSQuZWFjaCggYXIsIGZ1bmN0aW9uKCBpZHgsIHZhbCApIHsgYXJbIGlkeCBdID0gcGFyc2VJbnQoIHZhbCwgMTAgKTsgfSApOwoKCQkJc3dpdGNoKCBhci5sZW5ndGggKSB7CgkJCQkvLyBBbGwgdmFsdWVzIGFyZSB0byBiZSB0aGUgc2FtZQoJCQkJY2FzZSAxOgoJCQkJCWlmICggIWlzTmFOKCBhclsgMCBdICkgKSB7CgkJCQkJCXRvbC50ID0gdG9sLnIgPSB0b2wuYiA9IHRvbC5sID0gYXJbIDAgXTsKCQkJCQl9CgkJCQkJYnJlYWs7CgoJCQkJLy8gVGhlIGZpcnN0IHZhbHVlIGRlbm90ZXMgdG9wL2JvdHRvbSB0b2xlcmFuY2UsIGFuZCB0aGUgc2Vjb25kIHZhbHVlIGRlbm90ZXMgbGVmdC9yaWdodCB0b2xlcmFuY2UKCQkJCWNhc2UgMjoKCQkJCQlpZiAoICFpc05hTiggYXJbIDAgXSApICkgewoJCQkJCQl0b2wudCA9IHRvbC5iID0gYXJbIDAgXTsKCQkJCQl9CgkJCQkJaWYgKCAhaXNOYU4oIGFyWyAxIF0gKSApIHsKCQkJCQkJdG9sLmwgPSB0b2wuciA9IGFyWyAxIF07CgkJCQkJfQoJCQkJCWJyZWFrOwoKCQkJCS8vIFRoZSBhcnJheSBjb250YWlucyB2YWx1ZXMgaW4gdGhlIG9yZGVyIHRvcCwgcmlnaHQsIGJvdHRvbSwgbGVmdAoJCQkJY2FzZSA0OgoJCQkJCWlmICggIWlzTmFOKCBhclsgMCBdICkgKSB7CgkJCQkJCXRvbC50ID0gYXJbIDAgXTsKCQkJCQl9CgkJCQkJaWYgKCAhaXNOYU4oIGFyWyAxIF0gKSApIHsKCQkJCQkJdG9sLnIgPSBhclsgMSBdOwoJCQkJCX0KCQkJCQlpZiAoICFpc05hTiggYXJbIDIgXSApICkgewoJCQkJCQl0b2wuYiA9IGFyWyAyIF07CgkJCQkJfQoJCQkJCWlmICggIWlzTmFOKCBhclsgMyBdICkgKSB7CgkJCQkJCXRvbC5sID0gYXJbIDMgXTsKCQkJCQl9CgkJCQkJYnJlYWs7CgoJCQkJZGVmYXVsdDoKCQkJCQlicmVhazsKCQkJfQoJCX0KCgkJdGhpcy5fdG9sZXJhbmNlID0gdG9sOwoJCXJldHVybiB0aGlzOwoJfSwKCglfY2xhbXBQb3B1cFdpZHRoOiBmdW5jdGlvbiggaW5mb09ubHkgKSB7CgkJdmFyIG1lbnVTaXplLAoJCQl3aW5kb3dDb29yZGluYXRlcyA9IGdldFdpbmRvd0Nvb3JkaW5hdGVzKCB0aGlzLndpbmRvdyApLAoJCQkvLyByZWN0YW5nbGUgd2l0aGluIHdoaWNoIHRoZSBwb3B1cCBtdXN0IGZpdAoJCQlyZWN0YW5nbGUgPSB7CgkJCQl4OiB0aGlzLl90b2xlcmFuY2UubCwKCQkJCXk6IHdpbmRvd0Nvb3JkaW5hdGVzLnkgKyB0aGlzLl90b2xlcmFuY2UudCwKCQkJCWN4OiB3aW5kb3dDb29yZGluYXRlcy5jeCAtIHRoaXMuX3RvbGVyYW5jZS5sIC0gdGhpcy5fdG9sZXJhbmNlLnIsCgkJCQljeTogd2luZG93Q29vcmRpbmF0ZXMuY3kgLSB0aGlzLl90b2xlcmFuY2UudCAtIHRoaXMuX3RvbGVyYW5jZS5iCgkJCX07CgoJCWlmICggIWluZm9Pbmx5ICkgewoJCQkvLyBDbGFtcCB0aGUgd2lkdGggb2YgdGhlIG1lbnUgYmVmb3JlIGdyYWJiaW5nIGl0cyBzaXplCgkJCXRoaXMuX3VpLmNvbnRhaW5lci5jc3MoICJtYXgtd2lkdGgiLCByZWN0YW5nbGUuY3ggKTsKCQl9CgoJCW1lbnVTaXplID0gewoJCQljeDogdGhpcy5fdWkuY29udGFpbmVyLm91dGVyV2lkdGgoIHRydWUgKSwKCQkJY3k6IHRoaXMuX3VpLmNvbnRhaW5lci5vdXRlckhlaWdodCggdHJ1ZSApCgkJfTsKCgkJcmV0dXJuIHsgcmM6IHJlY3RhbmdsZSwgbWVudVNpemU6IG1lbnVTaXplIH07Cgl9LAoKCV9jYWxjdWxhdGVGaW5hbExvY2F0aW9uOiBmdW5jdGlvbiggZGVzaXJlZCwgY2xhbXBJbmZvICkgewoJCXZhciByZXR1cm5WYWx1ZSwKCQkJcmVjdGFuZ2xlID0gY2xhbXBJbmZvLnJjLAoJCQltZW51U2l6ZSA9IGNsYW1wSW5mby5tZW51U2l6ZTsKCgoJCS8vIENlbnRlciB0aGUgbWVudSBvdmVyIHRoZSBkZXNpcmVkIGNvb3JkaW5hdGVzLCB3aGlsZSBub3QgZ29pbmcgb3V0c2lkZQoJCS8vIHRoZSB3aW5kb3cgdG9sZXJhbmNlcy4gVGhpcyB3aWxsIGNlbnRlciB3cnQuIHRoZSB3aW5kb3cgaWYgdGhlIHBvcHVwIGlzCgkJLy8gdG9vIGxhcmdlLgoJCXJldHVyblZhbHVlID0gewoJCQlsZWZ0OiBmaXRTZWdtZW50SW5zaWRlU2VnbWVudCggcmVjdGFuZ2xlLmN4LCBtZW51U2l6ZS5jeCwgcmVjdGFuZ2xlLngsIGRlc2lyZWQueCApLAoJCQl0b3A6IGZpdFNlZ21lbnRJbnNpZGVTZWdtZW50KCByZWN0YW5nbGUuY3ksIG1lbnVTaXplLmN5LCByZWN0YW5nbGUueSwgZGVzaXJlZC55ICkKCQl9OwoKCQkvLyBNYWtlIHN1cmUgdGhlIHRvcCBvZiB0aGUgbWVudSBpcyB2aXNpYmxlCgkJcmV0dXJuVmFsdWUudG9wID0gTWF0aC5tYXgoIDAsIHJldHVyblZhbHVlLnRvcCApOwoKCQkvLyBJZiB0aGUgaGVpZ2h0IG9mIHRoZSBtZW51IGlzIHNtYWxsZXIgdGhhbiB0aGUgaGVpZ2h0IG9mIHRoZSBkb2N1bWVudAoJCS8vIGFsaWduIHRoZSBib3R0b20gd2l0aCB0aGUgYm90dG9tIG9mIHRoZSBkb2N1bWVudAoKCQlyZXR1cm5WYWx1ZS50b3AgLT0gTWF0aC5taW4oIHJldHVyblZhbHVlLnRvcCwKCQkJTWF0aC5tYXgoIDAsIHJldHVyblZhbHVlLnRvcCArIG1lbnVTaXplLmN5IC0gdGhpcy5kb2N1bWVudC5oZWlnaHQoKSApICk7CgoJCXJldHVybiByZXR1cm5WYWx1ZTsKCX0sCgoJLy8gVHJ5IGFuZCBjZW50ZXIgdGhlIG92ZXJsYXkgb3ZlciB0aGUgZ2l2ZW4gY29vcmRpbmF0ZXMKCV9wbGFjZW1lbnRDb29yZHM6IGZ1bmN0aW9uKCBkZXNpcmVkICkgewoJCXJldHVybiB0aGlzLl9jYWxjdWxhdGVGaW5hbExvY2F0aW9uKCBkZXNpcmVkLCB0aGlzLl9jbGFtcFBvcHVwV2lkdGgoKSApOwoJfSwKCglfY3JlYXRlUHJlcmVxdWlzaXRlczogZnVuY3Rpb24oIHNjcmVlblByZXJlcXVpc2l0ZSwgY29udGFpbmVyUHJlcmVxdWlzaXRlLCB3aGVuRG9uZSApIHsKCQl2YXIgcHJlcmVxdWlzaXRlcywKCQkJc2VsZiA9IHRoaXM7CgoJCS8vIEl0IGlzIGltcG9ydGFudCB0byBtYWludGFpbiBib3RoIHRoZSBsb2NhbCB2YXJpYWJsZSBwcmVyZXF1aXNpdGVzIGFuZAoJCS8vIHNlbGYuX3ByZXJlcXVpc2l0ZXMuIFRoZSBsb2NhbCB2YXJpYWJsZSByZW1haW5zIGluIHRoZSBjbG9zdXJlIG9mIHRoZQoJCS8vIGZ1bmN0aW9ucyB3aGljaCBjYWxsIHRoZSBjYWxsYmFja3MgcGFzc2VkIGluLiBUaGUgY29tcGFyaXNvbiBiZXR3ZWVuIHRoZQoJCS8vIGxvY2FsIHZhcmlhYmxlIGFuZCBzZWxmLl9wcmVyZXF1aXNpdGVzIGlzIG5lY2Vzc2FyeSwgYmVjYXVzZSBvbmNlIGEKCQkvLyBmdW5jdGlvbiBoYXMgYmVlbiBwYXNzZWQgdG8gLmFuaW1hdGlvbkNvbXBsZXRlKCkgaXQgd2lsbCBiZSBjYWxsZWQgbmV4dAoJCS8vIHRpbWUgYW4gYW5pbWF0aW9uIGNvbXBsZXRlcywgZXZlbiBpZiB0aGF0J3Mgbm90IHRoZSBhbmltYXRpb24gd2hvc2UgZW5kCgkJLy8gdGhlIGZ1bmN0aW9uIHdhcyBzdXBwb3NlZCB0byBjYXRjaCAoZm9yIGV4YW1wbGUsIGlmIGFuIGFib3J0IGhhcHBlbnMKCQkvLyBkdXJpbmcgdGhlIG9wZW5pbmcgYW5pbWF0aW9uLCB0aGUgLmFuaW1hdGlvbkNvbXBsZXRlIGhhbmRsZXIgaXMgbm90CgkJLy8gY2FsbGVkIGZvciB0aGF0IGFuaW1hdGlvbiBhbnltb3JlLCBidXQgdGhlIGhhbmRsZXIgcmVtYWlucyBhdHRhY2hlZCwgc28KCQkvLyBpdCBpcyBjYWxsZWQgdGhlIG5leHQgdGltZSB0aGUgcG9wdXAgaXMgb3BlbmVkIC0gbWFraW5nIGl0IHN0YWxlLgoJCS8vIENvbXBhcmluZyB0aGUgbG9jYWwgdmFyaWFibGUgcHJlcmVxdWlzaXRlcyB0byB0aGUgd2lkZ2V0LWxldmVsIHZhcmlhYmxlCgkJLy8gc2VsZi5fcHJlcmVxdWlzaXRlcyBlbnN1cmVzIHRoYXQgY2FsbGJhY2tzIHRyaWdnZXJlZCBieSBhIHN0YWxlCgkJLy8gLmFuaW1hdGlvbkNvbXBsZXRlIHdpbGwgYmUgaWdub3JlZC4KCgkJcHJlcmVxdWlzaXRlcyA9IHsKCQkJc2NyZWVuOiAkLkRlZmVycmVkKCksCgkJCWNvbnRhaW5lcjogJC5EZWZlcnJlZCgpCgkJfTsKCgkJcHJlcmVxdWlzaXRlcy5zY3JlZW4udGhlbiggZnVuY3Rpb24oKSB7CgkJCWlmICggcHJlcmVxdWlzaXRlcyA9PT0gc2VsZi5fcHJlcmVxdWlzaXRlcyApIHsKCQkJCXNjcmVlblByZXJlcXVpc2l0ZSgpOwoJCQl9CgkJfSk7CgoJCXByZXJlcXVpc2l0ZXMuY29udGFpbmVyLnRoZW4oIGZ1bmN0aW9uKCkgewoJCQlpZiAoIHByZXJlcXVpc2l0ZXMgPT09IHNlbGYuX3ByZXJlcXVpc2l0ZXMgKSB7CgkJCQljb250YWluZXJQcmVyZXF1aXNpdGUoKTsKCQkJfQoJCX0pOwoKCQkkLndoZW4oIHByZXJlcXVpc2l0ZXMuc2NyZWVuLCBwcmVyZXF1aXNpdGVzLmNvbnRhaW5lciApLmRvbmUoIGZ1bmN0aW9uKCkgewoJCQlpZiAoIHByZXJlcXVpc2l0ZXMgPT09IHNlbGYuX3ByZXJlcXVpc2l0ZXMgKSB7CgkJCQlzZWxmLl9wcmVyZXF1aXNpdGVzID0gbnVsbDsKCQkJCXdoZW5Eb25lKCk7CgkJCX0KCQl9KTsKCgkJc2VsZi5fcHJlcmVxdWlzaXRlcyA9IHByZXJlcXVpc2l0ZXM7Cgl9LAoKCV9hbmltYXRlOiBmdW5jdGlvbiggYXJncyApIHsKCQkvLyBOT1RFIGJlZm9yZSByZW1vdmluZyB0aGUgZGVmYXVsdCBhbmltYXRpb24gb2YgdGhlIHNjcmVlbgoJCS8vICAgICAgdGhpcyBoYWQgYW4gYW5pbWF0ZSBjYWxsYmFjayB0aGF0IHdvdWxkIHJlc29sdmUgdGhlIGRlZmVycmVkCgkJLy8gICAgICBub3cgdGhlIGRlZmVycmVkIGlzIHJlc29sdmVkIGltbWVkaWF0ZWx5CgkJLy8gVE9ETyByZW1vdmUgdGhlIGRlcGVuZGVuY3kgb24gdGhlIHNjcmVlbiBkZWZlcnJlZAoJCXRoaXMuX3VpLnNjcmVlbgoJCQkucmVtb3ZlQ2xhc3MoIGFyZ3MuY2xhc3NUb1JlbW92ZSApCgkJCS5hZGRDbGFzcyggYXJncy5zY3JlZW5DbGFzc1RvQWRkICk7CgoJCWFyZ3MucHJlcmVxdWlzaXRlcy5zY3JlZW4ucmVzb2x2ZSgpOwoKCQlpZiAoIGFyZ3MudHJhbnNpdGlvbiAmJiBhcmdzLnRyYW5zaXRpb24gIT09ICJub25lIiApIHsKCQkJaWYgKCBhcmdzLmFwcGx5VHJhbnNpdGlvbiApIHsKCQkJCXRoaXMuX2FwcGx5VHJhbnNpdGlvbiggYXJncy50cmFuc2l0aW9uICk7CgkJCX0KCQkJaWYgKCB0aGlzLl9mYWxsYmFja1RyYW5zaXRpb24gKSB7CgkJCQl0aGlzLl91aS5jb250YWluZXIKCQkJCQkuYW5pbWF0aW9uQ29tcGxldGUoICQucHJveHkoIGFyZ3MucHJlcmVxdWlzaXRlcy5jb250YWluZXIsICJyZXNvbHZlIiApICkKCQkJCQkuYWRkQ2xhc3MoIGFyZ3MuY29udGFpbmVyQ2xhc3NUb0FkZCApCgkJCQkJLnJlbW92ZUNsYXNzKCBhcmdzLmNsYXNzVG9SZW1vdmUgKTsKCQkJCXJldHVybjsKCQkJfQoJCX0KCQl0aGlzLl91aS5jb250YWluZXIucmVtb3ZlQ2xhc3MoIGFyZ3MuY2xhc3NUb1JlbW92ZSApOwoJCWFyZ3MucHJlcmVxdWlzaXRlcy5jb250YWluZXIucmVzb2x2ZSgpOwoJfSwKCgkvLyBUaGUgZGVzaXJlZCBjb29yZGluYXRlcyBwYXNzZWQgaW4gd2lsbCBiZSByZXR1cm5lZCB1bnRvdWNoZWQgaWYgbm8gcmVmZXJlbmNlIGVsZW1lbnQgY2FuIGJlIGlkZW50aWZpZWQgdmlhCgkvLyBkZXNpcmVkUG9zaXRpb24ucG9zaXRpb25Uby4gTmV2ZXJ0aGVsZXNzLCB0aGlzIGZ1bmN0aW9uIGVuc3VyZXMgdGhhdCBpdHMgcmV0dXJuIHZhbHVlIGFsd2F5cyBjb250YWlucyB2YWxpZAoJLy8geCBhbmQgeSBjb29yZGluYXRlcyBieSBzcGVjaWZ5aW5nIHRoZSBjZW50ZXIgbWlkZGxlIG9mIHRoZSB3aW5kb3cgaWYgdGhlIGNvb3JkaW5hdGVzIGFyZSBhYnNlbnQuCgkvLyBvcHRpb25zOiB7IHg6IGNvb3JkaW5hdGUsIHk6IGNvb3JkaW5hdGUsIHBvc2l0aW9uVG86IHN0cmluZzogIm9yaWdpbiIsICJ3aW5kb3ciLCBvciBqUXVlcnkgc2VsZWN0b3IKCV9kZXNpcmVkQ29vcmRzOiBmdW5jdGlvbiggb3Blbk9wdGlvbnMgKSB7CgkJdmFyIG9mZnNldCwKCQkJZHN0ID0gbnVsbCwKCQkJd2luZG93Q29vcmRpbmF0ZXMgPSBnZXRXaW5kb3dDb29yZGluYXRlcyggdGhpcy53aW5kb3cgKSwKCQkJeCA9IG9wZW5PcHRpb25zLngsCgkJCXkgPSBvcGVuT3B0aW9ucy55LAoJCQlwVG8gPSBvcGVuT3B0aW9ucy5wb3NpdGlvblRvOwoKCQkvLyBFc3RhYmxpc2ggd2hpY2ggZWxlbWVudCB3aWxsIHNlcnZlIGFzIHRoZSByZWZlcmVuY2UKCQlpZiAoIHBUbyAmJiBwVG8gIT09ICJvcmlnaW4iICkgewoJCQlpZiAoIHBUbyA9PT0gIndpbmRvdyIgKSB7CgkJCQl4ID0gd2luZG93Q29vcmRpbmF0ZXMuY3ggLyAyICsgd2luZG93Q29vcmRpbmF0ZXMueDsKCQkJCXkgPSB3aW5kb3dDb29yZGluYXRlcy5jeSAvIDIgKyB3aW5kb3dDb29yZGluYXRlcy55OwoJCQl9IGVsc2UgewoJCQkJdHJ5IHsKCQkJCQlkc3QgPSAkKCBwVG8gKTsKCQkJCX0gY2F0Y2goIGVyciApIHsKCQkJCQlkc3QgPSBudWxsOwoJCQkJfQoJCQkJaWYgKCBkc3QgKSB7CgkJCQkJZHN0LmZpbHRlciggIjp2aXNpYmxlIiApOwoJCQkJCWlmICggZHN0Lmxlbmd0aCA9PT0gMCApIHsKCQkJCQkJZHN0ID0gbnVsbDsKCQkJCQl9CgkJCQl9CgkJCX0KCQl9CgoJCS8vIElmIGFuIGVsZW1lbnQgd2FzIGZvdW5kLCBjZW50ZXIgb3ZlciBpdAoJCWlmICggZHN0ICkgewoJCQlvZmZzZXQgPSBkc3Qub2Zmc2V0KCk7CgkJCXggPSBvZmZzZXQubGVmdCArIGRzdC5vdXRlcldpZHRoKCkgLyAyOwoJCQl5ID0gb2Zmc2V0LnRvcCArIGRzdC5vdXRlckhlaWdodCgpIC8gMjsKCQl9CgoJCS8vIE1ha2Ugc3VyZSB4IGFuZCB5IGFyZSB2YWxpZCBudW1iZXJzIC0gY2VudGVyIG92ZXIgdGhlIHdpbmRvdwoJCWlmICggJC50eXBlKCB4ICkgIT09ICJudW1iZXIiIHx8IGlzTmFOKCB4ICkgKSB7CgkJCXggPSB3aW5kb3dDb29yZGluYXRlcy5jeCAvIDIgKyB3aW5kb3dDb29yZGluYXRlcy54OwoJCX0KCQlpZiAoICQudHlwZSggeSApICE9PSAibnVtYmVyIiB8fCBpc05hTiggeSApICkgewoJCQl5ID0gd2luZG93Q29vcmRpbmF0ZXMuY3kgLyAyICsgd2luZG93Q29vcmRpbmF0ZXMueTsKCQl9CgoJCXJldHVybiB7IHg6IHgsIHk6IHkgfTsKCX0sCgoJX3JlcG9zaXRpb246IGZ1bmN0aW9uKCBvcGVuT3B0aW9ucyApIHsKCQkvLyBXZSBvbmx5IGNhcmUgYWJvdXQgcG9zaXRpb24tcmVsYXRlZCBwYXJhbWV0ZXJzIGZvciByZXBvc2l0aW9uaW5nCgkJb3Blbk9wdGlvbnMgPSB7CgkJCXg6IG9wZW5PcHRpb25zLngsCgkJCXk6IG9wZW5PcHRpb25zLnksCgkJCXBvc2l0aW9uVG86IG9wZW5PcHRpb25zLnBvc2l0aW9uVG8KCQl9OwoJCXRoaXMuX3RyaWdnZXIoICJiZWZvcmVwb3NpdGlvbiIsIHVuZGVmaW5lZCwgb3Blbk9wdGlvbnMgKTsKCQl0aGlzLl91aS5jb250YWluZXIub2Zmc2V0KCB0aGlzLl9wbGFjZW1lbnRDb29yZHMoIHRoaXMuX2Rlc2lyZWRDb29yZHMoIG9wZW5PcHRpb25zICkgKSApOwoJfSwKCglyZXBvc2l0aW9uOiBmdW5jdGlvbiggb3Blbk9wdGlvbnMgKSB7CgkJaWYgKCB0aGlzLl9pc09wZW4gKSB7CgkJCXRoaXMuX3JlcG9zaXRpb24oIG9wZW5PcHRpb25zICk7CgkJfQoJfSwKCglfb3BlblByZXJlcXVpc2l0ZXNDb21wbGV0ZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5fdWkuY29udGFpbmVyLmFkZENsYXNzKCAidWktcG9wdXAtYWN0aXZlIiApOwoJCXRoaXMuX2lzT3BlbiA9IHRydWU7CgkJdGhpcy5fcmVzaXplU2NyZWVuKCk7CgkJdGhpcy5fdWkuY29udGFpbmVyLmF0dHIoICJ0YWJpbmRleCIsICIwIiApLmZvY3VzKCk7CgkJdGhpcy5faWdub3JlUmVzaXplRXZlbnRzKCk7CgkJdGhpcy5fdHJpZ2dlciggImFmdGVyb3BlbiIgKTsKCX0sCgoJX29wZW46IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCXZhciBvcGVuT3B0aW9ucyA9ICQuZXh0ZW5kKCB7fSwgdGhpcy5vcHRpb25zLCBvcHRpb25zICksCgkJCS8vIFRPRE8gbW92ZSBibGFja2xpc3QgdG8gcHJpdmF0ZSBtZXRob2QKCQkJYW5kcm9pZEJsYWNrbGlzdCA9ICggZnVuY3Rpb24oKSB7CgkJCQl2YXIgdWEgPSBuYXZpZ2F0b3IudXNlckFnZW50LAoJCQkJCS8vIFJlbmRlcmluZyBlbmdpbmUgaXMgV2Via2l0LCBhbmQgY2FwdHVyZSBtYWpvciB2ZXJzaW9uCgkJCQkJd2ttYXRjaCA9IHVhLm1hdGNoKCAvQXBwbGVXZWJLaXRcLyhbMC05XC5dKykvICksCgkJCQkJd2t2ZXJzaW9uID0gISF3a21hdGNoICYmIHdrbWF0Y2hbIDEgXSwKCQkJCQlhbmRyb2lkbWF0Y2ggPSB1YS5tYXRjaCggL0FuZHJvaWQgKFxkKyg/OlwuXGQrKSkvICksCgkJCQkJYW5kdmVyc2lvbiA9ICEhYW5kcm9pZG1hdGNoICYmIGFuZHJvaWRtYXRjaFsgMSBdLAoJCQkJCWNocm9tZW1hdGNoID0gdWEuaW5kZXhPZiggIkNocm9tZSIgKSA+IC0xOwoKCQkJCS8vIFBsYXRmb3JtIGlzIEFuZHJvaWQsIFdlYktpdCB2ZXJzaW9uIGlzIGdyZWF0ZXIgdGhhbiA1MzQuMTMgKCBBbmRyb2lkIDMuMi4xICkgYW5kIG5vdCBDaHJvbWUuCgkJCQlpZiAoIGFuZHJvaWRtYXRjaCAhPT0gbnVsbCAmJiBhbmR2ZXJzaW9uID09PSAiNC4wIiAmJiB3a3ZlcnNpb24gJiYgd2t2ZXJzaW9uID4gNTM0LjEzICYmICFjaHJvbWVtYXRjaCApIHsKCQkJCQlyZXR1cm4gdHJ1ZTsKCQkJCX0KCQkJCXJldHVybiBmYWxzZTsKCQkJfSgpKTsKCgkJLy8gQ291bnQgZG93biB0byB0cmlnZ2VyaW5nICJwb3B1cGFmdGVyb3BlbiIgLSB3ZSBoYXZlIHR3byBwcmVyZXF1aXNpdGVzOgoJCS8vIDEuIFRoZSBwb3B1cCB3aW5kb3cgYW5pbWF0aW9uIGNvbXBsZXRlcyAoY29udGFpbmVyKCkpCgkJLy8gMi4gVGhlIHNjcmVlbiBvcGFjaXR5IGFuaW1hdGlvbiBjb21wbGV0ZXMgKHNjcmVlbigpKQoJCXRoaXMuX2NyZWF0ZVByZXJlcXVpc2l0ZXMoCgkJCSQubm9vcCwKCQkJJC5ub29wLAoJCQkkLnByb3h5KCB0aGlzLCAiX29wZW5QcmVyZXF1aXNpdGVzQ29tcGxldGUiICkgKTsKCgkJdGhpcy5fY3VycmVudFRyYW5zaXRpb24gPSBvcGVuT3B0aW9ucy50cmFuc2l0aW9uOwoJCXRoaXMuX2FwcGx5VHJhbnNpdGlvbiggb3Blbk9wdGlvbnMudHJhbnNpdGlvbiApOwoKCQl0aGlzLl91aS5zY3JlZW4ucmVtb3ZlQ2xhc3MoICJ1aS1zY3JlZW4taGlkZGVuIiApOwoJCXRoaXMuX3VpLmNvbnRhaW5lci5yZW1vdmVDbGFzcyggInVpLXBvcHVwLXRydW5jYXRlIiApOwoKCQkvLyBHaXZlIGFwcGxpY2F0aW9ucyBhIGNoYW5jZSB0byBtb2RpZnkgdGhlIGNvbnRlbnRzIG9mIHRoZSBjb250YWluZXIgYmVmb3JlIGl0IGFwcGVhcnMKCQl0aGlzLl9yZXBvc2l0aW9uKCBvcGVuT3B0aW9ucyApOwoKCQl0aGlzLl91aS5jb250YWluZXIucmVtb3ZlQ2xhc3MoICJ1aS1wb3B1cC1oaWRkZW4iICk7CgoJCWlmICggdGhpcy5vcHRpb25zLm92ZXJsYXlUaGVtZSAmJiBhbmRyb2lkQmxhY2tsaXN0ICkgewoJCQkvKiBUT0RPOiBUaGUgbmF0aXZlIGJyb3dzZXIgb24gQW5kcm9pZCA0LjAuWCAoIkljZSBDcmVhbSBTYW5kd2ljaCIpIHN1ZmZlcnMgZnJvbSBhbiBpc3N1ZSB3aGVyZSB0aGUgcG9wdXAgb3ZlcmxheSBhcHBlYXJzIHRvIGJlIHotaW5kZXhlZCBhYm92ZSB0aGUgcG9wdXAgaXRzZWxmIHdoZW4gY2VydGFpbiBvdGhlciBzdHlsZXMgZXhpc3Qgb24gdGhlIHNhbWUgcGFnZSAtLSBuYW1lbHksIGFueSBlbGVtZW50IHNldCB0byBgcG9zaXRpb246IGZpeGVkYCBhbmQgY2VydGFpbiB0eXBlcyBvZiBpbnB1dC4gVGhlc2UgaXNzdWVzIGFyZSByZW1pbmlzY2VudCBvZiBwcmV2aW91c2x5IHVuY292ZXJlZCBidWdzIGluIG9sZGVyIHZlcnNpb25zIG9mIEFuZHJvaWQncyBuYXRpdmUgYnJvd3NlcjogaHR0cHM6Ly9naXRodWIuY29tL3Njb3R0amVobC9EZXZpY2UtQnVncy9pc3N1ZXMvMwoJCQlUaGlzIGZpeCBjbG9zZXMgdGhlIGZvbGxvd2luZyBidWdzICggSSB1c2UgImNsb3NlcyIgd2l0aCByZWx1Y3RhbmNlLCBhbmQgc3RyZXNzIHRoYXQgdGhpcyBpc3N1ZSBzaG91bGQgYmUgcmV2aXNpdGVkIGFzIHNvb24gYXMgcG9zc2libGUgKToKCQkJaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnktbW9iaWxlL2lzc3Vlcy80ODE2CgkJCWh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5LW1vYmlsZS9pc3N1ZXMvNDg0NAoJCQlodHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L2pxdWVyeS1tb2JpbGUvaXNzdWVzLzQ4NzQKCQkJKi8KCgkJCS8vIFRPRE8gc29ydCBvdXQgd2h5IHRoaXMuX3BhZ2UgaXNuJ3Qgd29ya2luZwoJCQl0aGlzLmVsZW1lbnQuY2xvc2VzdCggIi51aS1wYWdlIiApLmFkZENsYXNzKCAidWktcG9wdXAtb3BlbiIgKTsKCQl9CgkJdGhpcy5fYW5pbWF0ZSh7CgkJCWFkZGl0aW9uYWxDb25kaXRpb246IHRydWUsCgkJCXRyYW5zaXRpb246IG9wZW5PcHRpb25zLnRyYW5zaXRpb24sCgkJCWNsYXNzVG9SZW1vdmU6ICIiLAoJCQlzY3JlZW5DbGFzc1RvQWRkOiAiaW4iLAoJCQljb250YWluZXJDbGFzc1RvQWRkOiAiaW4iLAoJCQlhcHBseVRyYW5zaXRpb246IGZhbHNlLAoJCQlwcmVyZXF1aXNpdGVzOiB0aGlzLl9wcmVyZXF1aXNpdGVzCgkJfSk7Cgl9LAoKCV9jbG9zZVByZXJlcXVpc2l0ZVNjcmVlbjogZnVuY3Rpb24oKSB7CgkJdGhpcy5fdWkuc2NyZWVuCgkJCS5yZW1vdmVDbGFzcyggIm91dCIgKQoJCQkuYWRkQ2xhc3MoICJ1aS1zY3JlZW4taGlkZGVuIiApOwoJfSwKCglfY2xvc2VQcmVyZXF1aXNpdGVDb250YWluZXI6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3VpLmNvbnRhaW5lcgoJCQkucmVtb3ZlQ2xhc3MoICJyZXZlcnNlIG91dCIgKQoJCQkuYWRkQ2xhc3MoICJ1aS1wb3B1cC1oaWRkZW4gdWktcG9wdXAtdHJ1bmNhdGUiICkKCQkJLnJlbW92ZUF0dHIoICJzdHlsZSIgKTsKCX0sCgoJX2Nsb3NlUHJlcmVxdWlzaXRlc0RvbmU6IGZ1bmN0aW9uKCkgewoJCXZhciBjb250YWluZXIgPSB0aGlzLl91aS5jb250YWluZXI7CgoJCWNvbnRhaW5lci5yZW1vdmVBdHRyKCAidGFiaW5kZXgiICk7CgoJCS8vIHJlbW92ZSB0aGUgZ2xvYmFsIG11dGV4IGZvciBwb3B1cHMKCQkkLm1vYmlsZS5wb3B1cC5hY3RpdmUgPSB1bmRlZmluZWQ7CgoJCS8vIEJsdXIgZWxlbWVudHMgaW5zaWRlIHRoZSBjb250YWluZXIsIGluY2x1ZGluZyB0aGUgY29udGFpbmVyCgkJJCggIjpmb2N1cyIsIGNvbnRhaW5lclsgMCBdICkuYWRkKCBjb250YWluZXJbIDAgXSApLmJsdXIoKTsKCgkJLy8gYWxlcnQgdXNlcnMgdGhhdCB0aGUgcG9wdXAgaXMgY2xvc2VkCgkJdGhpcy5fdHJpZ2dlciggImFmdGVyY2xvc2UiICk7Cgl9LAoKCV9jbG9zZTogZnVuY3Rpb24oIGltbWVkaWF0ZSApIHsKCQl0aGlzLl91aS5jb250YWluZXIucmVtb3ZlQ2xhc3MoICJ1aS1wb3B1cC1hY3RpdmUiICk7CgkJdGhpcy5fcGFnZS5yZW1vdmVDbGFzcyggInVpLXBvcHVwLW9wZW4iICk7CgoJCXRoaXMuX2lzT3BlbiA9IGZhbHNlOwoKCQkvLyBDb3VudCBkb3duIHRvIHRyaWdnZXJpbmcgInBvcHVwYWZ0ZXJjbG9zZSIgLSB3ZSBoYXZlIHR3byBwcmVyZXF1aXNpdGVzOgoJCS8vIDEuIFRoZSBwb3B1cCB3aW5kb3cgcmV2ZXJzZSBhbmltYXRpb24gY29tcGxldGVzIChjb250YWluZXIoKSkKCQkvLyAyLiBUaGUgc2NyZWVuIG9wYWNpdHkgYW5pbWF0aW9uIGNvbXBsZXRlcyAoc2NyZWVuKCkpCgkJdGhpcy5fY3JlYXRlUHJlcmVxdWlzaXRlcygKCQkJJC5wcm94eSggdGhpcywgIl9jbG9zZVByZXJlcXVpc2l0ZVNjcmVlbiIgKSwKCQkJJC5wcm94eSggdGhpcywgIl9jbG9zZVByZXJlcXVpc2l0ZUNvbnRhaW5lciIgKSwKCQkJJC5wcm94eSggdGhpcywgIl9jbG9zZVByZXJlcXVpc2l0ZXNEb25lIiApICk7CgoJCXRoaXMuX2FuaW1hdGUoIHsKCQkJYWRkaXRpb25hbENvbmRpdGlvbjogdGhpcy5fdWkuc2NyZWVuLmhhc0NsYXNzKCAiaW4iICksCgkJCXRyYW5zaXRpb246ICggaW1tZWRpYXRlID8gIm5vbmUiIDogKCB0aGlzLl9jdXJyZW50VHJhbnNpdGlvbiApICksCgkJCWNsYXNzVG9SZW1vdmU6ICJpbiIsCgkJCXNjcmVlbkNsYXNzVG9BZGQ6ICJvdXQiLAoJCQljb250YWluZXJDbGFzc1RvQWRkOiAicmV2ZXJzZSBvdXQiLAoJCQlhcHBseVRyYW5zaXRpb246IHRydWUsCgkJCXByZXJlcXVpc2l0ZXM6IHRoaXMuX3ByZXJlcXVpc2l0ZXMKCQl9KTsKCX0sCgoJX3VuZW5oYW5jZTogZnVuY3Rpb24oKSB7CgkJaWYgKCB0aGlzLm9wdGlvbnMuZW5oYW5jZWQgKSB7CgkJCXJldHVybjsKCQl9CgoJCS8vIFB1dCB0aGUgZWxlbWVudCBiYWNrIHRvIHdoZXJlIHRoZSBwbGFjZWhvbGRlciB3YXMgYW5kIHJlbW92ZSB0aGUgInVpLXBvcHVwIiBjbGFzcwoJCXRoaXMuX3NldE9wdGlvbnMoIHsgdGhlbWU6ICQubW9iaWxlLnBvcHVwLnByb3RvdHlwZS5vcHRpb25zLnRoZW1lIH0gKTsKCQl0aGlzLmVsZW1lbnQKCQkJLy8gQ2Fubm90IGRpcmVjdGx5IGluc2VydEFmdGVyKCkgLSB3ZSBuZWVkIHRvIGRldGFjaCgpIGZpcnN0LCBiZWNhdXNlCgkJCS8vIGluc2VydEFmdGVyKCkgd2lsbCBkbyBub3RoaW5nIGlmIHRoZSBwYXlsb2FkIGRpdiB3YXMgbm90IGF0dGFjaGVkCgkJCS8vIHRvIHRoZSBET00gYXQgdGhlIHRpbWUgdGhlIHdpZGdldCB3YXMgY3JlYXRlZCwgYW5kIHNvIHRoZSBwYXlsb2FkCgkJCS8vIHdpbGwgcmVtYWluIGluc2lkZSB0aGUgY29udGFpbmVyIGV2ZW4gYWZ0ZXIgd2UgY2FsbCBpbnNlcnRBZnRlcigpLgoJCQkvLyBJZiB0aGF0IGhhcHBlbnMgYW5kIHdlIHJlbW92ZSB0aGUgY29udGFpbmVyIGEgZmV3IGxpbmVzIGJlbG93LCB3ZQoJCQkvLyB3aWxsIGNhdXNlIGFuIGluZmluaXRlIHJlY3Vyc2lvbiAtICM1MjQ0CgkJCS5kZXRhY2goKQoJCQkuaW5zZXJ0QWZ0ZXIoIHRoaXMuX3VpLnBsYWNlaG9sZGVyICkKCQkJLnJlbW92ZUNsYXNzKCAidWktcG9wdXAgdWktb3ZlcmxheS1zaGFkb3cgdWktY29ybmVyLWFsbCB1aS1ib2R5LWluaGVyaXQiICk7CgkJdGhpcy5fdWkuc2NyZWVuLnJlbW92ZSgpOwoJCXRoaXMuX3VpLmNvbnRhaW5lci5yZW1vdmUoKTsKCQl0aGlzLl91aS5wbGFjZWhvbGRlci5yZW1vdmUoKTsKCX0sCgoJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCWlmICggJC5tb2JpbGUucG9wdXAuYWN0aXZlID09PSB0aGlzICkgewoJCQl0aGlzLmVsZW1lbnQub25lKCAicG9wdXBhZnRlcmNsb3NlIiwgJC5wcm94eSggdGhpcywgIl91bmVuaGFuY2UiICkgKTsKCQkJdGhpcy5jbG9zZSgpOwoJCX0gZWxzZSB7CgkJCXRoaXMuX3VuZW5oYW5jZSgpOwoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9LAoKCV9jbG9zZVBvcHVwOiBmdW5jdGlvbiggdGhlRXZlbnQsIGRhdGEgKSB7CgkJdmFyIHBhcnNlZERzdCwgdG9VcmwsCgkJCWN1cnJlbnRPcHRpb25zID0gdGhpcy5vcHRpb25zLAoJCQlpbW1lZGlhdGUgPSBmYWxzZTsKCgkJaWYgKCAoIHRoZUV2ZW50ICYmIHRoZUV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICkgfHwgJC5tb2JpbGUucG9wdXAuYWN0aXZlICE9PSB0aGlzICkgewoJCQlyZXR1cm47CgkJfQoKCQkvLyByZXN0b3JlIGxvY2F0aW9uIG9uIHNjcmVlbgoJCXdpbmRvdy5zY3JvbGxUbyggMCwgdGhpcy5fc2Nyb2xsVG9wICk7CgoJCWlmICggdGhlRXZlbnQgJiYgdGhlRXZlbnQudHlwZSA9PT0gInBhZ2ViZWZvcmVjaGFuZ2UiICYmIGRhdGEgKSB7CgkJCS8vIERldGVybWluZSB3aGV0aGVyIHdlIG5lZWQgdG8gcmFwaWQtY2xvc2UgdGhlIHBvcHVwLCBvciB3aGV0aGVyIHdlIGNhbgoJCQkvLyB0YWtlIHRoZSB0aW1lIHRvIHJ1biB0aGUgY2xvc2luZyB0cmFuc2l0aW9uCgkJCWlmICggdHlwZW9mIGRhdGEudG9QYWdlID09PSAic3RyaW5nIiApIHsKCQkJCXBhcnNlZERzdCA9IGRhdGEudG9QYWdlOwoJCQl9IGVsc2UgewoJCQkJcGFyc2VkRHN0ID0gZGF0YS50b1BhZ2UuanFtRGF0YSggInVybCIgKTsKCQkJfQoJCQlwYXJzZWREc3QgPSAkLm1vYmlsZS5wYXRoLnBhcnNlVXJsKCBwYXJzZWREc3QgKTsKCQkJdG9VcmwgPSBwYXJzZWREc3QucGF0aG5hbWUgKyBwYXJzZWREc3Quc2VhcmNoICsgcGFyc2VkRHN0Lmhhc2g7CgoJCQlpZiAoIHRoaXMuX215VXJsICE9PSAkLm1vYmlsZS5wYXRoLm1ha2VVcmxBYnNvbHV0ZSggdG9VcmwgKSApIHsKCQkJCS8vIEdvaW5nIHRvIGEgZGlmZmVyZW50IHBhZ2UgLSBjbG9zZSBpbW1lZGlhdGVseQoJCQkJaW1tZWRpYXRlID0gdHJ1ZTsKCQkJfSBlbHNlIHsKCQkJCXRoZUV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCX0KCQl9CgoJCS8vIHJlbW92ZSBuYXYgYmluZGluZ3MKCQl0aGlzLndpbmRvdy5vZmYoIGN1cnJlbnRPcHRpb25zLmNsb3NlRXZlbnRzICk7CgkJLy8gdW5iaW5kIGNsaWNrIGhhbmRsZXJzIGFkZGVkIHdoZW4gaGlzdG9yeSBpcyBkaXNhYmxlZAoJCXRoaXMuZWxlbWVudC51bmRlbGVnYXRlKCBjdXJyZW50T3B0aW9ucy5jbG9zZUxpbmtTZWxlY3RvciwgY3VycmVudE9wdGlvbnMuY2xvc2VMaW5rRXZlbnRzICk7CgoJCXRoaXMuX2Nsb3NlKCBpbW1lZGlhdGUgKTsKCX0sCgoJLy8gYW55IG5hdmlnYXRpb24gZXZlbnQgYWZ0ZXIgYSBwb3B1cCBpcyBvcGVuZWQgc2hvdWxkIGNsb3NlIHRoZSBwb3B1cAoJLy8gTk9URSB0aGUgcGFnZWJlZm9yZWNoYW5nZSBpcyBib3VuZCB0byBjYXRjaCBuYXZpZ2F0aW9uIGV2ZW50cyB0aGF0IGRvbid0CgkvLyAgICAgIGFsdGVyIHRoZSB1cmwgKGVnLCBkaWFsb2dzIGZyb20gcG9wdXBzKQoJX2JpbmRDb250YWluZXJDbG9zZTogZnVuY3Rpb24oKSB7CgkJdGhpcy53aW5kb3cKCQkJLm9uKCB0aGlzLm9wdGlvbnMuY2xvc2VFdmVudHMsICQucHJveHkoIHRoaXMsICJfY2xvc2VQb3B1cCIgKSApOwoJfSwKCgl3aWRnZXQ6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLl91aS5jb250YWluZXI7Cgl9LAoKCS8vIFRPRE8gbm8gY2xlYXIgZGVsaW5pYXRpb24gb2Ygd2hhdCBzaG91bGQgYmUgaGVyZSBhbmQKCS8vIHdoYXQgc2hvdWxkIGJlIGluIF9vcGVuLiBTZWVtcyB0byBiZSAidmlzdWFsIiB2cyAiaGlzdG9yeSIgZm9yIG5vdwoJb3BlbjogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJdmFyIHVybCwgaGFzaGtleSwgYWN0aXZlUGFnZSwgY3VycmVudElzRGlhbG9nLCBoYXNIYXNoLCB1cmxIaXN0b3J5LAoJCQlzZWxmID0gdGhpcywKCQkJY3VycmVudE9wdGlvbnMgPSB0aGlzLm9wdGlvbnM7CgoJCS8vIG1ha2Ugc3VyZSBvcGVuIGlzIGlkZW1wb3RlbnQKCQlpZiAoICQubW9iaWxlLnBvcHVwLmFjdGl2ZSB8fCBjdXJyZW50T3B0aW9ucy5kaXNhYmxlZCApIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQkvLyBzZXQgdGhlIGdsb2JhbCBwb3B1cCBtdXRleAoJCSQubW9iaWxlLnBvcHVwLmFjdGl2ZSA9IHRoaXM7CgkJdGhpcy5fc2Nyb2xsVG9wID0gdGhpcy53aW5kb3cuc2Nyb2xsVG9wKCk7CgoJCS8vIGlmIGhpc3RvcnkgYWx0ZXJhdGlvbiBpcyBkaXNhYmxlZCBjbG9zZSBvbiBuYXZpZ2F0ZSBldmVudHMKCQkvLyBhbmQgbGVhdmUgdGhlIHVybCBhcyBpcwoJCWlmICggISggY3VycmVudE9wdGlvbnMuaGlzdG9yeSApICkgewoJCQlzZWxmLl9vcGVuKCBvcHRpb25zICk7CgkJCXNlbGYuX2JpbmRDb250YWluZXJDbG9zZSgpOwoKCQkJLy8gV2hlbiBoaXN0b3kgaXMgZGlzYWJsZWQgd2UgaGF2ZSB0byBncmFiIHRoZSBkYXRhLXJlbAoJCQkvLyBiYWNrIGxpbmsgY2xpY2tzIHNvIHdlIGNhbiBjbG9zZSB0aGUgcG9wdXAgaW5zdGVhZCBvZgoJCQkvLyByZWx5aW5nIG9uIGhpc3RvcnkgdG8gZG8gaXQgZm9yIHVzCgkJCXNlbGYuZWxlbWVudAoJCQkJLmRlbGVnYXRlKCBjdXJyZW50T3B0aW9ucy5jbG9zZUxpbmtTZWxlY3RvciwgY3VycmVudE9wdGlvbnMuY2xvc2VMaW5rRXZlbnRzLCBmdW5jdGlvbiggdGhlRXZlbnQgKSB7CgkJCQkJc2VsZi5jbG9zZSgpOwoJCQkJCXRoZUV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQl9KTsKCgkJCXJldHVybiB0aGlzOwoJCX0KCgkJLy8gY2FjaGUgc29tZSB2YWx1ZXMgZm9yIG1pbi9yZWFkYWJpbGl0eQoJCXVybEhpc3RvcnkgPSAkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5OwoJCWhhc2hrZXkgPSAkLm1vYmlsZS5kaWFsb2dIYXNoS2V5OwoJCWFjdGl2ZVBhZ2UgPSAkLm1vYmlsZS5hY3RpdmVQYWdlOwoJCWN1cnJlbnRJc0RpYWxvZyA9ICggYWN0aXZlUGFnZSA/IGFjdGl2ZVBhZ2UuaGFzQ2xhc3MoICJ1aS1kaWFsb2ciICkgOiBmYWxzZSApOwoJCXRoaXMuX215VXJsID0gdXJsID0gdXJsSGlzdG9yeS5nZXRBY3RpdmUoKS51cmw7CgkJaGFzSGFzaCA9ICggdXJsLmluZGV4T2YoIGhhc2hrZXkgKSA+IC0xICkgJiYgIWN1cnJlbnRJc0RpYWxvZyAmJiAoIHVybEhpc3RvcnkuYWN0aXZlSW5kZXggPiAwICk7CgoJCWlmICggaGFzSGFzaCApIHsKCQkJc2VsZi5fb3Blbiggb3B0aW9ucyApOwoJCQlzZWxmLl9iaW5kQ29udGFpbmVyQ2xvc2UoKTsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQkvLyBpZiB0aGUgY3VycmVudCB1cmwgaGFzIG5vIGRpYWxvZyBoYXNoIGtleSBwcm9jZWVkIGFzIG5vcm1hbAoJCS8vIG90aGVyd2lzZSwgaWYgdGhlIHBhZ2UgaXMgYSBkaWFsb2cgc2ltcGx5IHRhY2sgb24gdGhlIGhhc2gga2V5CgkJaWYgKCB1cmwuaW5kZXhPZiggaGFzaGtleSApID09PSAtMSAmJiAhY3VycmVudElzRGlhbG9nICl7CgkJCXVybCA9IHVybCArICh1cmwuaW5kZXhPZiggIiMiICkgPiAtMSA/IGhhc2hrZXkgOiAiIyIgKyBoYXNoa2V5KTsKCQl9IGVsc2UgewoJCQl1cmwgPSAkLm1vYmlsZS5wYXRoLnBhcnNlTG9jYXRpb24oKS5oYXNoICsgaGFzaGtleTsKCQl9CgoJCS8vIFRhY2sgb24gYW4gZXh0cmEgaGFzaGtleSBpZiB0aGlzIGlzIHRoZSBmaXJzdCBwYWdlIGFuZCB3ZSd2ZSBqdXN0IHJlY29uc3RydWN0ZWQgdGhlIGluaXRpYWwgaGFzaAoJCWlmICggdXJsSGlzdG9yeS5hY3RpdmVJbmRleCA9PT0gMCAmJiB1cmwgPT09IHVybEhpc3RvcnkuaW5pdGlhbERzdCApIHsKCQkJdXJsICs9IGhhc2hrZXk7CgkJfQoKCQkvLyBzd2FsbG93IHRoZSB0aGUgaW5pdGlhbCBuYXZpZ2F0aW9uIGV2ZW50LCBhbmQgYmluZCBmb3IgdGhlIG5leHQKCQl0aGlzLndpbmRvdy5vbmUoICJiZWZvcmVuYXZpZ2F0ZSIsIGZ1bmN0aW9uKCB0aGVFdmVudCApIHsKCQkJdGhlRXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJc2VsZi5fb3Blbiggb3B0aW9ucyApOwoJCQlzZWxmLl9iaW5kQ29udGFpbmVyQ2xvc2UoKTsKCQl9KTsKCgkJdGhpcy51cmxBbHRlcmVkID0gdHJ1ZTsKCQkkLm1vYmlsZS5uYXZpZ2F0ZSggdXJsLCB7IHJvbGU6ICJkaWFsb2ciIH0gKTsKCgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWNsb3NlOiBmdW5jdGlvbigpIHsKCQkvLyBtYWtlIHN1cmUgY2xvc2UgaXMgaWRlbXBvdGVudAoJCWlmICggJC5tb2JpbGUucG9wdXAuYWN0aXZlICE9PSB0aGlzICkgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCXRoaXMuX3Njcm9sbFRvcCA9IHRoaXMud2luZG93LnNjcm9sbFRvcCgpOwoKCQlpZiAoIHRoaXMub3B0aW9ucy5oaXN0b3J5ICYmIHRoaXMudXJsQWx0ZXJlZCApIHsKCQkJJC5tb2JpbGUuYmFjaygpOwoJCQl0aGlzLnVybEFsdGVyZWQgPSBmYWxzZTsKCQl9IGVsc2UgewoJCQkvLyBzaW11bGF0ZSB0aGUgbmF2IGJpbmRpbmdzIGhhdmluZyBmaXJlZAoJCQl0aGlzLl9jbG9zZVBvcHVwKCk7CgkJfQoKCQlyZXR1cm4gdGhpczsKCX0KfSk7CgoKLy8gVE9ETyB0aGlzIGNhbiBiZSBtb3ZlZCBpbnNpZGUgdGhlIHdpZGdldAokLm1vYmlsZS5wb3B1cC5oYW5kbGVMaW5rID0gZnVuY3Rpb24oICRsaW5rICkgewoJdmFyIG9mZnNldCwKCQlwYXRoID0gJC5tb2JpbGUucGF0aCwKCgkJLy8gTk9URSBtYWtlIHN1cmUgdG8gZ2V0IG9ubHkgdGhlIGhhc2ggZnJvbSB0aGUgaHJlZiBiZWNhdXNlIGllNyAod3A3KQoJCS8vICAgICAgcmV0dXJucyB0aGUgYWJzb2x1dGUgaHJlZiBpbiB0aGlzIGNhc2UgcnVpbmluZyB0aGUgZWxlbWVudCBzZWxlY3Rpb24KCQlwb3B1cCA9ICQoIHBhdGguaGFzaFRvU2VsZWN0b3IoIHBhdGgucGFyc2VVcmwoICRsaW5rLmF0dHIoICJocmVmIiApICkuaGFzaCApICkuZmlyc3QoKTsKCglpZiAoIHBvcHVwLmxlbmd0aCA+IDAgJiYgcG9wdXAuZGF0YSggIm1vYmlsZS1wb3B1cCIgKSApIHsKCQlvZmZzZXQgPSAkbGluay5vZmZzZXQoKTsKCQlwb3B1cC5wb3B1cCggIm9wZW4iLCB7CgkJCXg6IG9mZnNldC5sZWZ0ICsgJGxpbmsub3V0ZXJXaWR0aCgpIC8gMiwKCQkJeTogb2Zmc2V0LnRvcCArICRsaW5rLm91dGVySGVpZ2h0KCkgLyAyLAoJCQl0cmFuc2l0aW9uOiAkbGluay5qcW1EYXRhKCAidHJhbnNpdGlvbiIgKSwKCQkJcG9zaXRpb25UbzogJGxpbmsuanFtRGF0YSggInBvc2l0aW9uLXRvIiApCgkJfSk7Cgl9CgoJLy9yZW1vdmUgYWZ0ZXIgZGVsYXkKCXNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCSRsaW5rLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJfSwgMzAwICk7Cn07CgovLyBUT0RPIG1vdmUgaW5zaWRlIF9jcmVhdGUKJC5tb2JpbGUuZG9jdW1lbnQub24oICJwYWdlYmVmb3JlY2hhbmdlIiwgZnVuY3Rpb24oIHRoZUV2ZW50LCBkYXRhICkgewoJaWYgKCBkYXRhLm9wdGlvbnMucm9sZSA9PT0gInBvcHVwIiApIHsKCQkkLm1vYmlsZS5wb3B1cC5oYW5kbGVMaW5rKCBkYXRhLm9wdGlvbnMubGluayApOwoJCXRoZUV2ZW50LnByZXZlbnREZWZhdWx0KCk7Cgl9Cn0pOwoKfSkoIGpRdWVyeSApOwoKLyoKKiBjdXN0b20gInNlbGVjdG1lbnUiIHBsdWdpbgoqLwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7Cgp2YXIgdW5mb2N1c2FibGVJdGVtU2VsZWN0b3IgPSAiLnVpLWRpc2FibGVkLC51aS1zdGF0ZS1kaXNhYmxlZCwudWktbGktZGl2aWRlciwudWktc2NyZWVuLWhpZGRlbiw6anFtRGF0YShyb2xlPSdwbGFjZWhvbGRlcicpIiwKCWdvVG9BZGphY2VudEl0ZW0gPSBmdW5jdGlvbiggaXRlbSwgdGFyZ2V0LCBkaXJlY3Rpb24gKSB7CgkJdmFyIGFkamFjZW50ID0gaXRlbVsgZGlyZWN0aW9uICsgIkFsbCIgXSgpCgkJCS5ub3QoIHVuZm9jdXNhYmxlSXRlbVNlbGVjdG9yICkKCQkJLmZpcnN0KCk7CgoJCS8vIGlmIHRoZXJlJ3MgYSBwcmV2aW91cyBvcHRpb24sIGZvY3VzIGl0CgkJaWYgKCBhZGphY2VudC5sZW5ndGggKSB7CgkJCXRhcmdldAoJCQkJLmJsdXIoKQoJCQkJLmF0dHIoICJ0YWJpbmRleCIsICItMSIgKTsKCgkJCWFkamFjZW50LmZpbmQoICJhIiApLmZpcnN0KCkuZm9jdXMoKTsKCQl9Cgl9OwoKJC53aWRnZXQoICJtb2JpbGUuc2VsZWN0bWVudSIsICQubW9iaWxlLnNlbGVjdG1lbnUsIHsKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXZhciBvID0gdGhpcy5vcHRpb25zOwoKCQkvLyBDdXN0b20gc2VsZWN0cyBjYW5ub3QgZXhpc3QgaW5zaWRlIHBvcHVwcywgc28gcmV2ZXJ0IHRoZSAibmF0aXZlTWVudSIKCQkvLyBvcHRpb24gdG8gdHJ1ZSBpZiBhIHBhcmVudCBpcyBhIHBvcHVwCgkJby5uYXRpdmVNZW51ID0gby5uYXRpdmVNZW51IHx8ICggdGhpcy5lbGVtZW50LnBhcmVudHMoICI6anFtRGF0YShyb2xlPSdwb3B1cCcpLDptb2JpbGUtcG9wdXAiICkubGVuZ3RoID4gMCApOwoKCQlyZXR1cm4gdGhpcy5fc3VwZXIoKTsKCX0sCgoJX2hhbmRsZVNlbGVjdEZvY3VzOiBmdW5jdGlvbigpIHsKCQl0aGlzLmVsZW1lbnQuYmx1cigpOwoJCXRoaXMuYnV0dG9uLmZvY3VzKCk7Cgl9LAoKCV9oYW5kbGVLZXlkb3duOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJdGhpcy5fc3VwZXIoIGV2ZW50ICk7CgkJdGhpcy5faGFuZGxlQnV0dG9uVmNsaWNrS2V5ZG93biggZXZlbnQgKTsKCX0sCgoJX2hhbmRsZUJ1dHRvblZjbGlja0tleWRvd246IGZ1bmN0aW9uKCBldmVudCApIHsKCQlpZiAoIHRoaXMub3B0aW9ucy5kaXNhYmxlZCB8fCB0aGlzLmlzT3BlbiApIHsKCQkJcmV0dXJuOwoJCX0KCgkJaWYgKGV2ZW50LnR5cGUgPT09ICJ2Y2xpY2siIHx8CgkJCQlldmVudC5rZXlDb2RlICYmIChldmVudC5rZXlDb2RlID09PSAkLm1vYmlsZS5rZXlDb2RlLkVOVEVSIHx8IGV2ZW50LmtleUNvZGUgPT09ICQubW9iaWxlLmtleUNvZGUuU1BBQ0UpKSB7CgoJCQl0aGlzLl9kZWNpZGVGb3JtYXQoKTsKCQkJaWYgKCB0aGlzLm1lbnVUeXBlID09PSAib3ZlcmxheSIgKSB7CgkJCQl0aGlzLmJ1dHRvbi5hdHRyKCAiaHJlZiIsICIjIiArIHRoaXMucG9wdXBJZCApLmF0dHIoICJkYXRhLSIgKyAoICQubW9iaWxlLm5zIHx8ICIiICkgKyAicmVsIiwgInBvcHVwIiApOwoJCQl9IGVsc2UgewoJCQkJdGhpcy5idXR0b24uYXR0ciggImhyZWYiLCAiIyIgKyB0aGlzLmRpYWxvZ0lkICkuYXR0ciggImRhdGEtIiArICggJC5tb2JpbGUubnMgfHwgIiIgKSArICJyZWwiLCAiZGlhbG9nIiApOwoJCQl9CgkJCXRoaXMuaXNPcGVuID0gdHJ1ZTsKCQkJLy8gRG8gbm90IHByZXZlbnQgZGVmYXVsdCwgc28gdGhlIG5hdmlnYXRpb24gbWF5IGhhdmUgYSBjaGFuY2UgdG8gYWN0dWFsbHkgb3BlbiB0aGUgY2hvc2VuIGZvcm1hdAoJCX0KCX0sCgoJX2hhbmRsZUxpc3RGb2N1czogZnVuY3Rpb24oIGUgKSB7CgkJdmFyIHBhcmFtcyA9ICggZS50eXBlID09PSAiZm9jdXNpbiIgKSA/CgkJCXsgdGFiaW5kZXg6ICIwIiwgZXZlbnQ6ICJ2bW91c2VvdmVyIiB9OgoJCQl7IHRhYmluZGV4OiAiLTEiLCBldmVudDogInZtb3VzZW91dCIgfTsKCgkJJCggZS50YXJnZXQgKQoJCQkuYXR0ciggInRhYmluZGV4IiwgcGFyYW1zLnRhYmluZGV4ICkKCQkJLnRyaWdnZXIoIHBhcmFtcy5ldmVudCApOwoJfSwKCglfaGFuZGxlTGlzdEtleWRvd246IGZ1bmN0aW9uKCBldmVudCApIHsKCQl2YXIgdGFyZ2V0ID0gJCggZXZlbnQudGFyZ2V0ICksCgkJCWxpID0gdGFyZ2V0LmNsb3Nlc3QoICJsaSIgKTsKCgkJLy8gc3dpdGNoIGxvZ2ljIGJhc2VkIG9uIHdoaWNoIGtleSB3YXMgcHJlc3NlZAoJCXN3aXRjaCAoIGV2ZW50LmtleUNvZGUgKSB7CgkJCS8vIHVwIG9yIGxlZnQgYXJyb3cga2V5cwoJCWNhc2UgMzg6CgkJCWdvVG9BZGphY2VudEl0ZW0oIGxpLCB0YXJnZXQsICJwcmV2IiApOwoJCQlyZXR1cm4gZmFsc2U7CgkJCS8vIGRvd24gb3IgcmlnaHQgYXJyb3cga2V5cwoJCWNhc2UgNDA6CgkJCWdvVG9BZGphY2VudEl0ZW0oIGxpLCB0YXJnZXQsICJuZXh0IiApOwoJCQlyZXR1cm4gZmFsc2U7CgkJCS8vIElmIGVudGVyIG9yIHNwYWNlIGlzIHByZXNzZWQsIHRyaWdnZXIgY2xpY2sKCQljYXNlIDEzOgoJCWNhc2UgMzI6CgkJCXRhcmdldC50cmlnZ2VyKCAiY2xpY2siICk7CgkJCXJldHVybiBmYWxzZTsKCQl9Cgl9LAoKCV9oYW5kbGVNZW51UGFnZUhpZGU6IGZ1bmN0aW9uKCkgewoJCS8vIFRPRE8gY2VudHJhbGl6ZSBwYWdlIHJlbW92YWwgYmluZGluZyAvIGhhbmRsaW5nIGluIHRoZSBwYWdlIHBsdWdpbi4KCQkvLyBTdWdnZXN0aW9uIGZyb20gQGpibGFzIHRvIGRvIHJlZmNvdW50aW5nCgkJLy8KCQkvLyBUT0RPIGV4dHJlbWVseSBjb25mdXNpbmcgZGVwZW5kZW5jeSBvbiB0aGUgb3BlbiBtZXRob2Qgd2hlcmUgdGhlIHBhZ2VoaWRlLnJlbW92ZQoJCS8vIGJpbmRpbmdzIGFyZSBzdHJpcHBlZCB0byBwcmV2ZW50IHRoZSBwYXJlbnQgcGFnZSBmcm9tIGRpc2FwcGVhcmluZy4gVGhlIHdheQoJCS8vIHdlJ3JlIGtlZXBpbmcgcGFnZXMgaW4gdGhlIERPTSByaWdodCBub3cgc3Vja3MKCQkvLwoJCS8vIHJlYmluZCB0aGUgcGFnZSByZW1vdmUgdGhhdCB3YXMgdW5ib3VuZCBpbiB0aGUgb3BlbiBmdW5jdGlvbgoJCS8vIHRvIGFsbG93IGZvciB0aGUgcGFyZW50IHBhZ2UgcmVtb3ZhbCBmcm9tIGFjdGlvbnMgb3RoZXIgdGhhbiB0aGUgdXNlCgkJLy8gb2YgYSBkaWFsb2cgc2l6ZWQgY3VzdG9tIHNlbGVjdAoJCS8vCgkJLy8gZG9pbmcgdGhpcyBoZXJlIHByb3ZpZGVzIGZvciB0aGUgYmFjayBidXR0b24gb24gdGhlIGN1c3RvbSBzZWxlY3QgZGlhbG9nCgkJdGhpcy50aGlzUGFnZS5wYWdlKCAiYmluZFJlbW92ZSIgKTsKCX0sCgoJX2hhbmRsZUhlYWRlckNsb3NlQ2xpY2s6IGZ1bmN0aW9uKCkgewoJCWlmICggdGhpcy5tZW51VHlwZSA9PT0gIm92ZXJsYXkiICkgewoJCQl0aGlzLmNsb3NlKCk7CgkJCXJldHVybiBmYWxzZTsKCQl9Cgl9LAoKCWJ1aWxkOiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZWN0SWQsIHBvcHVwSWQsIGRpYWxvZ0lkLCBsYWJlbCwgdGhpc1BhZ2UsIGlzTXVsdGlwbGUsIG1lbnVJZCwgdGhlbWVBdHRyLCBvdmVybGF5VGhlbWVBdHRyLAoJCQlkaXZpZGVyVGhlbWVBdHRyLCBtZW51UGFnZSwgbGlzdGJveCwgbGlzdCwgaGVhZGVyLCBoZWFkZXJUaXRsZSwgbWVudVBhZ2VDb250ZW50LCBtZW51UGFnZUNsb3NlLCBoZWFkZXJDbG9zZSwgc2VsZiwKCQkJbyA9IHRoaXMub3B0aW9uczsKCgkJaWYgKCBvLm5hdGl2ZU1lbnUgKSB7CgkJCXJldHVybiB0aGlzLl9zdXBlcigpOwoJCX0KCgkJc2VsZiA9IHRoaXM7CgkJc2VsZWN0SWQgPSB0aGlzLnNlbGVjdElkOwoJCXBvcHVwSWQgPSBzZWxlY3RJZCArICItbGlzdGJveCI7CgkJZGlhbG9nSWQgPSBzZWxlY3RJZCArICItZGlhbG9nIjsKCQlsYWJlbCA9IHRoaXMubGFiZWw7CgkJdGhpc1BhZ2UgPSB0aGlzLmVsZW1lbnQuY2xvc2VzdCggIi51aS1wYWdlIiApOwoJCWlzTXVsdGlwbGUgPSB0aGlzLmVsZW1lbnRbIDAgXS5tdWx0aXBsZTsKCQltZW51SWQgPSBzZWxlY3RJZCArICItbWVudSI7CgkJdGhlbWVBdHRyID0gby50aGVtZSA/ICggIiBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJ0aGVtZT0nIiArIG8udGhlbWUgKyAiJyIgKSA6ICIiOwoJCW92ZXJsYXlUaGVtZUF0dHIgPSBvLm92ZXJsYXlUaGVtZSA/ICggIiBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJ0aGVtZT0nIiArIG8ub3ZlcmxheVRoZW1lICsgIiciICkgOiAiIjsKCQlkaXZpZGVyVGhlbWVBdHRyID0gKCBvLmRpdmlkZXJUaGVtZSAmJiBpc011bHRpcGxlICkgPyAoICIgZGF0YS0iICsgJC5tb2JpbGUubnMgKyAiZGl2aWRlci10aGVtZT0nIiArIG8uZGl2aWRlclRoZW1lICsgIiciICkgOiAiIjsKCQltZW51UGFnZSA9ICQoICI8ZGl2IGRhdGEtIiArICQubW9iaWxlLm5zICsgInJvbGU9J2RpYWxvZycgY2xhc3M9J3VpLXNlbGVjdG1lbnUnIGlkPSciICsgZGlhbG9nSWQgKyAiJyIgKyB0aGVtZUF0dHIgKyBvdmVybGF5VGhlbWVBdHRyICsgIj4iICsKCQkJIjxkaXYgZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicm9sZT0naGVhZGVyJz4iICsKCQkJIjxkaXYgY2xhc3M9J3VpLXRpdGxlJz4iICsgbGFiZWwuZ2V0RW5jb2RlZFRleHQoKSArICI8L2Rpdj4iKwoJCQkiPC9kaXY+IisKCQkJIjxkaXYgZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicm9sZT0nY29udGVudCc+PC9kaXY+IisKCQkJIjwvZGl2PiIgKTsKCQlsaXN0Ym94ID0gJCggIjxkaXYgaWQ9JyIgKyBwb3B1cElkICsgIicgY2xhc3M9J3VpLXNlbGVjdG1lbnUnPiIgKS5pbnNlcnRBZnRlciggdGhpcy5zZWxlY3QgKS5wb3B1cCh7IHRoZW1lOiBvLm92ZXJsYXlUaGVtZSB9KTsKCQlsaXN0ID0gJCggIjx1bCBjbGFzcz0ndWktc2VsZWN0bWVudS1saXN0JyBpZD0nIiArIG1lbnVJZCArICInIHJvbGU9J2xpc3Rib3gnIGFyaWEtbGFiZWxsZWRieT0nIiArIHRoaXMuYnV0dG9uSWQgKyAiJyIgKyB0aGVtZUF0dHIgKyBkaXZpZGVyVGhlbWVBdHRyICsgIj4iICkuYXBwZW5kVG8oIGxpc3Rib3ggKTsKCQloZWFkZXIgPSAkKCAiPGRpdiBjbGFzcz0ndWktaGVhZGVyIHVpLWJhci0iICsgKCBvLnRoZW1lID8gby50aGVtZSA6ICJpbmhlcml0IiApICsgIic+IiApLnByZXBlbmRUbyggbGlzdGJveCApOwoJCWhlYWRlclRpdGxlID0gJCggIjxoMSBjbGFzcz0ndWktdGl0bGUnPiIgKS5hcHBlbmRUbyggaGVhZGVyICk7CgoJCWlmICggdGhpcy5pc011bHRpcGxlICkgewoJCQloZWFkZXJDbG9zZSA9ICQoICI8YT4iLCB7CgkJCQkicm9sZSI6ICJidXR0b24iLAoJCQkJInRleHQiOiBvLmNsb3NlVGV4dCwKCQkJCSJocmVmIjogIiMiLAoJCQkJImNsYXNzIjogInVpLWJ0biB1aS1jb3JuZXItYWxsIHVpLWJ0bi1sZWZ0IHVpLWJ0bi1pY29uLW5vdGV4dCB1aS1pY29uLWRlbGV0ZSIKCQkJfSkuYXBwZW5kVG8oIGhlYWRlciApOwoJCX0KCgkJJC5leHRlbmQoIHRoaXMsIHsKCQkJc2VsZWN0SWQ6IHNlbGVjdElkLAoJCQltZW51SWQ6IG1lbnVJZCwKCQkJcG9wdXBJZDogcG9wdXBJZCwKCQkJZGlhbG9nSWQ6IGRpYWxvZ0lkLAoJCQl0aGlzUGFnZTogdGhpc1BhZ2UsCgkJCW1lbnVQYWdlOiBtZW51UGFnZSwKCQkJbGFiZWw6IGxhYmVsLAoJCQlpc011bHRpcGxlOiBpc011bHRpcGxlLAoJCQl0aGVtZTogby50aGVtZSwKCQkJbGlzdGJveDogbGlzdGJveCwKCQkJbGlzdDogbGlzdCwKCQkJaGVhZGVyOiBoZWFkZXIsCgkJCWhlYWRlclRpdGxlOiBoZWFkZXJUaXRsZSwKCQkJaGVhZGVyQ2xvc2U6IGhlYWRlckNsb3NlLAoJCQltZW51UGFnZUNvbnRlbnQ6IG1lbnVQYWdlQ29udGVudCwKCQkJbWVudVBhZ2VDbG9zZTogbWVudVBhZ2VDbG9zZSwKCQkJcGxhY2Vob2xkZXI6ICIiCgkJfSk7CgoJCS8vIENyZWF0ZSBsaXN0IGZyb20gc2VsZWN0LCB1cGRhdGUgc3RhdGUKCQl0aGlzLnJlZnJlc2goKTsKCgkJaWYgKCB0aGlzLl9vcmlnVGFiSW5kZXggPT09IHVuZGVmaW5lZCApIHsKCQkJLy8gTWFwIHVuZGVmaW5lZCB0byBmYWxzZSwgYmVjYXVzZSB0aGlzLl9vcmlnVGFiSW5kZXggPT09IHVuZGVmaW5lZAoJCQkvLyBpbmRpY2F0ZXMgdGhhdCB3ZSBoYXZlIG5vdCB5ZXQgY2hlY2tlZCB3aGV0aGVyIHRoZSBzZWxlY3QgaGFzCgkJCS8vIG9yaWdpbmFsbHkgaGFkIGEgdGFiaW5kZXggYXR0cmlidXRlLCB3aGVyZWFzIGZhbHNlIGluZGljYXRlcyB0aGF0CgkJCS8vIHdlIGhhdmUgY2hlY2tlZCB0aGUgc2VsZWN0IGZvciBzdWNoIGFuIGF0dHJpYnV0ZSwgYW5kIGhhdmUgZm91bmQKCQkJLy8gbm9uZSBwcmVzZW50LgoJCQl0aGlzLl9vcmlnVGFiSW5kZXggPSAoIHRoaXMuc2VsZWN0WyAwIF0uZ2V0QXR0cmlidXRlKCAidGFiaW5kZXgiICkgPT09IG51bGwgKSA/IGZhbHNlIDogdGhpcy5zZWxlY3QuYXR0ciggInRhYmluZGV4IiApOwoJCX0KCQl0aGlzLnNlbGVjdC5hdHRyKCAidGFiaW5kZXgiLCAiLTEiICk7CgkJdGhpcy5fb24oIHRoaXMuc2VsZWN0LCB7IGZvY3VzIDogIl9oYW5kbGVTZWxlY3RGb2N1cyIgfSApOwoKCQkvLyBCdXR0b24gZXZlbnRzCgkJdGhpcy5fb24oIHRoaXMuYnV0dG9uLCB7CgkJCXZjbGljazogIl9oYW5kbGVCdXR0b25WY2xpY2tLZXlkb3duIgoJCX0pOwoKCQkvLyBFdmVudHMgZm9yIGxpc3QgaXRlbXMKCQl0aGlzLmxpc3QuYXR0ciggInJvbGUiLCAibGlzdGJveCIgKTsKCQl0aGlzLl9vbiggdGhpcy5saXN0LCB7CgkJCWZvY3VzaW4gOiAiX2hhbmRsZUxpc3RGb2N1cyIsCgkJCWZvY3Vzb3V0IDogIl9oYW5kbGVMaXN0Rm9jdXMiLAoJCQlrZXlkb3duOiAiX2hhbmRsZUxpc3RLZXlkb3duIgoJCX0pOwoJCXRoaXMubGlzdAoJCQkuZGVsZWdhdGUoICJsaTpub3QoLnVpLWRpc2FibGVkLC51aS1zdGF0ZS1kaXNhYmxlZCwudWktbGktZGl2aWRlcikiLCAiY2xpY2siLCBmdW5jdGlvbiggZXZlbnQgKSB7CgoJCQkJLy8gaW5kZXggb2Ygb3B0aW9uIHRhZyB0byBiZSBzZWxlY3RlZAoJCQkJdmFyIG9sZEluZGV4ID0gc2VsZi5zZWxlY3RbIDAgXS5zZWxlY3RlZEluZGV4LAoJCQkJCW5ld0luZGV4ID0gJC5tb2JpbGUuZ2V0QXR0cmlidXRlKCB0aGlzLCAib3B0aW9uLWluZGV4IiApLAoJCQkJCW9wdGlvbiA9IHNlbGYuX3NlbGVjdE9wdGlvbnMoKS5lcSggbmV3SW5kZXggKVsgMCBdOwoKCQkJCS8vIHRvZ2dsZSBzZWxlY3RlZCBzdGF0dXMgb24gdGhlIHRhZyBmb3IgbXVsdGkgc2VsZWN0cwoJCQkJb3B0aW9uLnNlbGVjdGVkID0gc2VsZi5pc011bHRpcGxlID8gIW9wdGlvbi5zZWxlY3RlZCA6IHRydWU7CgoJCQkJLy8gdG9nZ2xlIGNoZWNrYm94IGNsYXNzIGZvciBtdWx0aXBsZSBzZWxlY3RzCgkJCQlpZiAoIHNlbGYuaXNNdWx0aXBsZSApIHsKCQkJCQkkKCB0aGlzICkuZmluZCggImEiICkKCQkJCQkJLnRvZ2dsZUNsYXNzKCAidWktaWNvbi1jaGVja2JveC1vbiIsIG9wdGlvbi5zZWxlY3RlZCApCgkJCQkJCS50b2dnbGVDbGFzcyggInVpLWljb24tY2hlY2tib3gtb2ZmIiwgIW9wdGlvbi5zZWxlY3RlZCApOwoJCQkJfQoKCQkJCS8vIHRyaWdnZXIgY2hhbmdlIGlmIHZhbHVlIGNoYW5nZWQKCQkJCWlmICggc2VsZi5pc011bHRpcGxlIHx8IG9sZEluZGV4ICE9PSBuZXdJbmRleCApIHsKCQkJCQlzZWxmLnNlbGVjdC50cmlnZ2VyKCAiY2hhbmdlIiApOwoJCQkJfQoKCQkJCS8vIGhpZGUgY3VzdG9tIHNlbGVjdCBmb3Igc2luZ2xlIHNlbGVjdHMgb25seSAtIG90aGVyd2lzZSBmb2N1cyBjbGlja2VkIGl0ZW0KCQkJCS8vIFdlIG5lZWQgdG8gZ3JhYiB0aGUgY2xpY2tlZCBpdGVtIHRoZSBoYXJkIHdheSwgYmVjYXVzZSB0aGUgbGlzdCBtYXkgaGF2ZSBiZWVuIHJlYnVpbHQKCQkJCWlmICggc2VsZi5pc011bHRpcGxlICkgewoJCQkJCXNlbGYubGlzdC5maW5kKCAibGk6bm90KC51aS1saS1kaXZpZGVyKSIgKS5lcSggbmV3SW5kZXggKQoJCQkJCQkuZmluZCggImEiICkuZmlyc3QoKS5mb2N1cygpOwoJCQkJfQoJCQkJZWxzZSB7CgkJCQkJc2VsZi5jbG9zZSgpOwoJCQkJfQoKCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCX0pOwoKCQkvLyBidXR0b24gcmVmb2N1cyBlbnN1cmVzIHByb3BlciBoZWlnaHQgY2FsY3VsYXRpb24KCQkvLyBieSByZW1vdmluZyB0aGUgaW5saW5lIHN0eWxlIGFuZCBlbnN1cmluZyBwYWdlIGluY2x1c2lvbgoJCXRoaXMuX29uKCB0aGlzLm1lbnVQYWdlLCB7IHBhZ2VoaWRlOiAiX2hhbmRsZU1lbnVQYWdlSGlkZSIgfSApOwoKCQkvLyBFdmVudHMgb24gdGhlIHBvcHVwCgkJdGhpcy5fb24oIHRoaXMubGlzdGJveCwgeyBwb3B1cGFmdGVyY2xvc2U6ICJjbG9zZSIgfSApOwoKCQkvLyBDbG9zZSBidXR0b24gb24gc21hbGwgb3ZlcmxheXMKCQlpZiAoIHRoaXMuaXNNdWx0aXBsZSApIHsKCQkJdGhpcy5fb24oIHRoaXMuaGVhZGVyQ2xvc2UsIHsgY2xpY2s6ICJfaGFuZGxlSGVhZGVyQ2xvc2VDbGljayIgfSApOwoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9LAoKCV9pc1JlYnVpbGRSZXF1aXJlZDogZnVuY3Rpb24oKSB7CgkJdmFyIGxpc3QgPSB0aGlzLmxpc3QuZmluZCggImxpIiApLAoJCQlvcHRpb25zID0gdGhpcy5fc2VsZWN0T3B0aW9ucygpLm5vdCggIi51aS1zY3JlZW4taGlkZGVuIiApOwoKCQkvLyBUT0RPIGV4Y2VlZGluZ2x5IG5haXZlIG1ldGhvZCB0byBkZXRlcm1pbmUgZGlmZmVyZW5jZQoJCS8vIGlnbm9yZXMgdmFsdWUgY2hhbmdlcyBldGMgaW4gZmF2b3Igb2YgYSBmb3JjZWRSZWJ1aWxkCgkJLy8gZnJvbSB0aGUgdXNlciBpbiB0aGUgcmVmcmVzaCBtZXRob2QKCQlyZXR1cm4gb3B0aW9ucy50ZXh0KCkgIT09IGxpc3QudGV4dCgpOwoJfSwKCglzZWxlY3RlZDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuX3NlbGVjdE9wdGlvbnMoKS5maWx0ZXIoICI6c2VsZWN0ZWQ6bm90KCA6anFtRGF0YShwbGFjZWhvbGRlcj0ndHJ1ZScpICkiICk7Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCBmb3JjZSApIHsKCQl2YXIgc2VsZiwgaW5kaWNlczsKCgkJaWYgKCB0aGlzLm9wdGlvbnMubmF0aXZlTWVudSApIHsKCQkJcmV0dXJuIHRoaXMuX3N1cGVyKCBmb3JjZSApOwoJCX0KCgkJc2VsZiA9IHRoaXM7CgkJaWYgKCBmb3JjZSB8fCB0aGlzLl9pc1JlYnVpbGRSZXF1aXJlZCgpICkgewoJCQlzZWxmLl9idWlsZExpc3QoKTsKCQl9CgoJCWluZGljZXMgPSB0aGlzLnNlbGVjdGVkSW5kaWNlcygpOwoKCQlzZWxmLnNldEJ1dHRvblRleHQoKTsKCQlzZWxmLnNldEJ1dHRvbkNvdW50KCk7CgoJCXNlbGYubGlzdC5maW5kKCAibGk6bm90KC51aS1saS1kaXZpZGVyKSIgKQoJCQkuZmluZCggImEiICkucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICkuZW5kKCkKCQkJLmF0dHIoICJhcmlhLXNlbGVjdGVkIiwgZmFsc2UgKQoJCQkuZWFjaChmdW5jdGlvbiggaSApIHsKCgkJCQlpZiAoICQuaW5BcnJheSggaSwgaW5kaWNlcyApID4gLTEgKSB7CgkJCQkJdmFyIGl0ZW0gPSAkKCB0aGlzICk7CgoJCQkJCS8vIEFyaWEgc2VsZWN0ZWQgYXR0cgoJCQkJCWl0ZW0uYXR0ciggImFyaWEtc2VsZWN0ZWQiLCB0cnVlICk7CgoJCQkJCS8vIE11bHRpcGxlIHNlbGVjdHM6IGFkZCB0aGUgIm9uIiBjaGVja2JveCBzdGF0ZSB0byB0aGUgaWNvbgoJCQkJCWlmICggc2VsZi5pc011bHRpcGxlICkgewoJCQkJCQlpdGVtLmZpbmQoICJhIiApLnJlbW92ZUNsYXNzKCAidWktaWNvbi1jaGVja2JveC1vZmYiICkuYWRkQ2xhc3MoICJ1aS1pY29uLWNoZWNrYm94LW9uIiApOwoJCQkJCX0gZWxzZSB7CgkJCQkJCWlmICggaXRlbS5oYXNDbGFzcyggInVpLXNjcmVlbi1oaWRkZW4iICkgKSB7CgkJCQkJCQlpdGVtLm5leHQoKS5maW5kKCAiYSIgKS5hZGRDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJCQkJfSBlbHNlIHsKCQkJCQkJCWl0ZW0uZmluZCggImEiICkuYWRkQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCQkJCX0KCQkJCQl9CgkJCQl9CgkJCX0pOwoJfSwKCgljbG9zZTogZnVuY3Rpb24oKSB7CgkJaWYgKCB0aGlzLm9wdGlvbnMuZGlzYWJsZWQgfHwgIXRoaXMuaXNPcGVuICkgewoJCQlyZXR1cm47CgkJfQoKCQl2YXIgc2VsZiA9IHRoaXM7CgoJCWlmICggc2VsZi5tZW51VHlwZSA9PT0gInBhZ2UiICkgewoJCQlzZWxmLm1lbnVQYWdlLmRpYWxvZyggImNsb3NlIiApOwoJCQlzZWxmLmxpc3QuYXBwZW5kVG8oIHNlbGYubGlzdGJveCApOwoJCX0gZWxzZSB7CgkJCXNlbGYubGlzdGJveC5wb3B1cCggImNsb3NlIiApOwoJCX0KCgkJc2VsZi5fZm9jdXNCdXR0b24oKTsKCQkvLyBhbGxvdyB0aGUgZGlhbG9nIHRvIGJlIGNsb3NlZCBhZ2FpbgoJCXNlbGYuaXNPcGVuID0gZmFsc2U7Cgl9LAoKCW9wZW46IGZ1bmN0aW9uKCkgewoJCXRoaXMuYnV0dG9uLmNsaWNrKCk7Cgl9LAoKCV9mb2N1c01lbnVJdGVtOiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZWN0b3IgPSB0aGlzLmxpc3QuZmluZCggImEuIiArICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJaWYgKCBzZWxlY3Rvci5sZW5ndGggPT09IDAgKSB7CgkJCXNlbGVjdG9yID0gdGhpcy5saXN0LmZpbmQoICJsaTpub3QoIiArIHVuZm9jdXNhYmxlSXRlbVNlbGVjdG9yICsgIikgYS51aS1idG4iICk7CgkJfQoJCXNlbGVjdG9yLmZpcnN0KCkuZm9jdXMoKTsKCX0sCgoJX2RlY2lkZUZvcm1hdDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzLAoJCQkkd2luZG93ID0gdGhpcy53aW5kb3csCgkJCXNlbGZMaXN0UGFyZW50ID0gc2VsZi5saXN0LnBhcmVudCgpLAoJCQltZW51SGVpZ2h0ID0gc2VsZkxpc3RQYXJlbnQub3V0ZXJIZWlnaHQoKSwKCQkJc2Nyb2xsVG9wID0gJHdpbmRvdy5zY3JvbGxUb3AoKSwKCQkJYnRuT2Zmc2V0ID0gc2VsZi5idXR0b24ub2Zmc2V0KCkudG9wLAoJCQlzY3JlZW5IZWlnaHQgPSAkd2luZG93LmhlaWdodCgpOwoKCQlpZiAoIG1lbnVIZWlnaHQgPiBzY3JlZW5IZWlnaHQgLSA4MCB8fCAhJC5zdXBwb3J0LnNjcm9sbFRvcCApIHsKCgkJCXNlbGYubWVudVBhZ2UuYXBwZW5kVG8oICQubW9iaWxlLnBhZ2VDb250YWluZXIgKS5wYWdlKCk7CgkJCXNlbGYubWVudVBhZ2VDb250ZW50ID0gc2VsZi5tZW51UGFnZS5maW5kKCAiLnVpLWNvbnRlbnQiICk7CgkJCXNlbGYubWVudVBhZ2VDbG9zZSA9IHNlbGYubWVudVBhZ2UuZmluZCggIi51aS1oZWFkZXIgYSIgKTsKCgkJCS8vIHByZXZlbnQgdGhlIHBhcmVudCBwYWdlIGZyb20gYmVpbmcgcmVtb3ZlZCBmcm9tIHRoZSBET00sCgkJCS8vIG90aGVyd2lzZSB0aGUgcmVzdWx0cyBvZiBzZWxlY3RpbmcgYSBsaXN0IGl0ZW0gaW4gdGhlIGRpYWxvZwoJCQkvLyBmYWxsIGludG8gYSBibGFjayBob2xlCgkJCXNlbGYudGhpc1BhZ2UudW5iaW5kKCAicGFnZWhpZGUucmVtb3ZlIiApOwoKCQkJLy9mb3IgV2ViT1MvT3BlcmEgTWluaSAoc2V0IGxhc3RzY3JvbGwgdXNpbmcgYnV0dG9uIG9mZnNldCkKCQkJaWYgKCBzY3JvbGxUb3AgPT09IDAgJiYgYnRuT2Zmc2V0ID4gc2NyZWVuSGVpZ2h0ICkgewoJCQkJc2VsZi50aGlzUGFnZS5vbmUoICJwYWdlaGlkZSIsIGZ1bmN0aW9uKCkgewoJCQkJCSQoIHRoaXMgKS5qcW1EYXRhKCAibGFzdFNjcm9sbCIsIGJ0bk9mZnNldCApOwoJCQkJfSk7CgkJCX0KCgkJCXNlbGYubWVudVBhZ2Uub25lKCB7CgkJCQlwYWdlc2hvdzogJC5wcm94eSggdGhpcywgIl9mb2N1c01lbnVJdGVtIiApLAoJCQkJcGFnZWhpZGU6ICQucHJveHkoIHRoaXMsICJjbG9zZSIgKQoJCQl9KTsKCgkJCXNlbGYubWVudVR5cGUgPSAicGFnZSI7CgkJCXNlbGYubWVudVBhZ2VDb250ZW50LmFwcGVuZCggc2VsZi5saXN0ICk7CgkJCXNlbGYubWVudVBhZ2UuZmluZCggImRpdiAudWktdGl0bGUiICkudGV4dCggc2VsZi5sYWJlbC50ZXh0KCkgKTsKCQl9IGVsc2UgewoJCQlzZWxmLm1lbnVUeXBlID0gIm92ZXJsYXkiOwoKCQkJc2VsZi5saXN0Ym94Lm9uZSggeyBwb3B1cGFmdGVyb3BlbjogJC5wcm94eSggdGhpcywgIl9mb2N1c01lbnVJdGVtIiApIH0gKTsKCQl9Cgl9LAoKCV9idWlsZExpc3Q6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpcywKCQkJbyA9IHRoaXMub3B0aW9ucywKCQkJcGxhY2Vob2xkZXIgPSB0aGlzLnBsYWNlaG9sZGVyLAoJCQluZWVkUGxhY2Vob2xkZXIgPSB0cnVlLAoJCQlkYXRhSWNvbiA9IHRoaXMuaXNNdWx0aXBsZSA/ICJjaGVja2JveC1vZmYiIDogImZhbHNlIiwKCQkJJG9wdGlvbnMsIG51bU9wdGlvbnMsIHNlbGVjdCwKCQkJZGF0YVByZWZpeCA9ICJkYXRhLSIgKyAkLm1vYmlsZS5ucywKCQkJZGF0YUluZGV4QXR0ciA9IGRhdGFQcmVmaXggKyAib3B0aW9uLWluZGV4IiwKCQkJZGF0YUljb25BdHRyID0gZGF0YVByZWZpeCArICJpY29uIiwKCQkJZGF0YVJvbGVBdHRyID0gZGF0YVByZWZpeCArICJyb2xlIiwKCQkJZGF0YVBsYWNlaG9sZGVyQXR0ciA9IGRhdGFQcmVmaXggKyAicGxhY2Vob2xkZXIiLAoJCQlmcmFnbWVudCA9IGRvY3VtZW50LmNyZWF0ZURvY3VtZW50RnJhZ21lbnQoKSwKCQkJaXNQbGFjZWhvbGRlckl0ZW0gPSBmYWxzZSwKCQkJb3B0R3JvdXAsCgkJCWksCgkJCW9wdGlvbiwgJG9wdGlvbiwgcGFyZW50LCB0ZXh0LCBhbmNob3IsIGNsYXNzZXMsCgkJCW9wdExhYmVsLCBkaXZpZGVyLCBpdGVtOwoKCQlzZWxmLmxpc3QuZW1wdHkoKS5maWx0ZXIoICIudWktbGlzdHZpZXciICkubGlzdHZpZXcoICJkZXN0cm95IiApOwoJCSRvcHRpb25zID0gdGhpcy5fc2VsZWN0T3B0aW9ucygpOwoJCW51bU9wdGlvbnMgPSAkb3B0aW9ucy5sZW5ndGg7CgkJc2VsZWN0ID0gdGhpcy5zZWxlY3RbIDAgXTsKCgkJZm9yICggaSA9IDA7IGkgPCBudW1PcHRpb25zO2krKywgaXNQbGFjZWhvbGRlckl0ZW0gPSBmYWxzZSkgewoJCQlvcHRpb24gPSAkb3B0aW9uc1tpXTsKCQkJJG9wdGlvbiA9ICQoIG9wdGlvbiApOwoKCQkJLy8gRG8gbm90IGNyZWF0ZSBvcHRpb25zIGJhc2VkIG9uIHVpLXNjcmVlbi1oaWRkZW4gc2VsZWN0IG9wdGlvbnMKCQkJaWYgKCAkb3B0aW9uLmhhc0NsYXNzKCAidWktc2NyZWVuLWhpZGRlbiIgKSApIHsKCQkJCWNvbnRpbnVlOwoJCQl9CgoJCQlwYXJlbnQgPSBvcHRpb24ucGFyZW50Tm9kZTsKCQkJdGV4dCA9ICRvcHRpb24udGV4dCgpOwoJCQlhbmNob3IgID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImEiICk7CgkJCWNsYXNzZXMgPSBbXTsKCgkJCWFuY2hvci5zZXRBdHRyaWJ1dGUoICJocmVmIiwgIiMiICk7CgkJCWFuY2hvci5hcHBlbmRDaGlsZCggZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoIHRleHQgKSApOwoKCQkJLy8gQXJlIHdlIGluc2lkZSBhbiBvcHRncm91cD8KCQkJaWYgKCBwYXJlbnQgIT09IHNlbGVjdCAmJiBwYXJlbnQubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gIm9wdGdyb3VwIiApIHsKCQkJCW9wdExhYmVsID0gcGFyZW50LmdldEF0dHJpYnV0ZSggImxhYmVsIiApOwoJCQkJaWYgKCBvcHRMYWJlbCAhPT0gb3B0R3JvdXAgKSB7CgkJCQkJZGl2aWRlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJsaSIgKTsKCQkJCQlkaXZpZGVyLnNldEF0dHJpYnV0ZSggZGF0YVJvbGVBdHRyLCAibGlzdC1kaXZpZGVyIiApOwoJCQkJCWRpdmlkZXIuc2V0QXR0cmlidXRlKCAicm9sZSIsICJvcHRpb24iICk7CgkJCQkJZGl2aWRlci5zZXRBdHRyaWJ1dGUoICJ0YWJpbmRleCIsICItMSIgKTsKCQkJCQlkaXZpZGVyLmFwcGVuZENoaWxkKCBkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSggb3B0TGFiZWwgKSApOwoJCQkJCWZyYWdtZW50LmFwcGVuZENoaWxkKCBkaXZpZGVyICk7CgkJCQkJb3B0R3JvdXAgPSBvcHRMYWJlbDsKCQkJCX0KCQkJfQoKCQkJaWYgKCBuZWVkUGxhY2Vob2xkZXIgJiYgKCAhb3B0aW9uLmdldEF0dHJpYnV0ZSggInZhbHVlIiApIHx8IHRleHQubGVuZ3RoID09PSAwIHx8ICRvcHRpb24uanFtRGF0YSggInBsYWNlaG9sZGVyIiApICkgKSB7CgkJCQluZWVkUGxhY2Vob2xkZXIgPSBmYWxzZTsKCQkJCWlzUGxhY2Vob2xkZXJJdGVtID0gdHJ1ZTsKCgkJCQkvLyBJZiB3ZSBoYXZlIGlkZW50aWZpZWQgYSBwbGFjZWhvbGRlciwgcmVjb3JkIHRoZSBmYWN0IHRoYXQgaXQgd2FzCgkJCQkvLyB1cyB3aG8gaGF2ZSBhZGRlZCB0aGUgcGxhY2Vob2xkZXIgdG8gdGhlIG9wdGlvbiBhbmQgbWFyayBpdAoJCQkJLy8gcmV0cm9hY3RpdmVseSBpbiB0aGUgc2VsZWN0IGFzIHdlbGwKCQkJCWlmICggbnVsbCA9PT0gb3B0aW9uLmdldEF0dHJpYnV0ZSggZGF0YVBsYWNlaG9sZGVyQXR0ciApICkgewoJCQkJCXRoaXMuX3JlbW92ZVBsYWNlaG9sZGVyQXR0ciA9IHRydWU7CgkJCQl9CgkJCQlvcHRpb24uc2V0QXR0cmlidXRlKCBkYXRhUGxhY2Vob2xkZXJBdHRyLCB0cnVlICk7CgkJCQlpZiAoIG8uaGlkZVBsYWNlaG9sZGVyTWVudUl0ZW1zICkgewoJCQkJCWNsYXNzZXMucHVzaCggInVpLXNjcmVlbi1oaWRkZW4iICk7CgkJCQl9CgkJCQlpZiAoIHBsYWNlaG9sZGVyICE9PSB0ZXh0ICkgewoJCQkJCXBsYWNlaG9sZGVyID0gc2VsZi5wbGFjZWhvbGRlciA9IHRleHQ7CgkJCQl9CgkJCX0KCgkJCWl0ZW0gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAibGkiICk7CgkJCWlmICggb3B0aW9uLmRpc2FibGVkICkgewoJCQkJY2xhc3Nlcy5wdXNoKCAidWktZGlzYWJsZWQiICk7CgkJCQlpdGVtLnNldEF0dHJpYnV0ZSggImFyaWEtZGlzYWJsZWQiLCB0cnVlICk7CgkJCX0KCQkJaXRlbS5zZXRBdHRyaWJ1dGUoIGRhdGFJbmRleEF0dHIsIGkgKTsKCQkJaXRlbS5zZXRBdHRyaWJ1dGUoIGRhdGFJY29uQXR0ciwgZGF0YUljb24gKTsKCQkJaWYgKCBpc1BsYWNlaG9sZGVySXRlbSApIHsKCQkJCWl0ZW0uc2V0QXR0cmlidXRlKCBkYXRhUGxhY2Vob2xkZXJBdHRyLCB0cnVlICk7CgkJCX0KCQkJaXRlbS5jbGFzc05hbWUgPSBjbGFzc2VzLmpvaW4oICIgIiApOwoJCQlpdGVtLnNldEF0dHJpYnV0ZSggInJvbGUiLCAib3B0aW9uIiApOwoJCQlhbmNob3Iuc2V0QXR0cmlidXRlKCAidGFiaW5kZXgiLCAiLTEiICk7CgkJCWl0ZW0uYXBwZW5kQ2hpbGQoIGFuY2hvciApOwoJCQlmcmFnbWVudC5hcHBlbmRDaGlsZCggaXRlbSApOwoJCX0KCgkJc2VsZi5saXN0WzBdLmFwcGVuZENoaWxkKCBmcmFnbWVudCApOwoKCQkvLyBIaWRlIGhlYWRlciBpZiBpdCdzIG5vdCBhIG11bHRpc2VsZWN0IGFuZCB0aGVyZSdzIG5vIHBsYWNlaG9sZGVyCgkJaWYgKCAhdGhpcy5pc011bHRpcGxlICYmICFwbGFjZWhvbGRlci5sZW5ndGggKSB7CgkJCXRoaXMuaGVhZGVyLmFkZENsYXNzKCAidWktc2NyZWVuLWhpZGRlbiIgKTsKCQl9IGVsc2UgewoJCQl0aGlzLmhlYWRlclRpdGxlLnRleHQoIHRoaXMucGxhY2Vob2xkZXIgKTsKCQl9CgoJCS8vIE5vdyBwb3B1bGF0ZWQsIGNyZWF0ZSBsaXN0dmlldwoJCXNlbGYubGlzdC5saXN0dmlldygpOwoJfSwKCglfYnV0dG9uOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5vcHRpb25zLm5hdGl2ZU1lbnUgPwoJCQl0aGlzLl9zdXBlcigpIDoKCQkJJCggIjxhPiIsIHsKCQkJCSJocmVmIjogIiMiLAoJCQkJInJvbGUiOiAiYnV0dG9uIiwKCQkJCS8vIFRPRE8gdmFsdWUgaXMgdW5kZWZpbmVkIGF0IGNyZWF0aW9uCgkJCQkiaWQiOiB0aGlzLmJ1dHRvbklkLAoJCQkJImFyaWEtaGFzcG9wdXAiOiAidHJ1ZSIsCgoJCQkJLy8gVE9ETyB2YWx1ZSBpcyB1bmRlZmluZWQgYXQgY3JlYXRpb24KCQkJCSJhcmlhLW93bnMiOiB0aGlzLm1lbnVJZAoJCQl9KTsKCX0sCgoJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoKCQlpZiAoICF0aGlzLm9wdGlvbnMubmF0aXZlTWVudSApIHsKCQkJdGhpcy5jbG9zZSgpOwoKCQkJLy8gUmVzdG9yZSB0aGUgdGFiaW5kZXggYXR0cmlidXRlIHRvIGl0cyBvcmlnaW5hbCB2YWx1ZQoJCQlpZiAoIHRoaXMuX29yaWdUYWJJbmRleCAhPT0gdW5kZWZpbmVkICkgewoJCQkJaWYgKCB0aGlzLl9vcmlnVGFiSW5kZXggIT09IGZhbHNlICkgewoJCQkJCXRoaXMuc2VsZWN0LmF0dHIoICJ0YWJpbmRleCIsIHRoaXMuX29yaWdUYWJJbmRleCApOwoJCQkJfSBlbHNlIHsKCQkJCQl0aGlzLnNlbGVjdC5yZW1vdmVBdHRyKCAidGFiaW5kZXgiICk7CgkJCQl9CgkJCX0KCgkJCS8vIFJlbW92ZSB0aGUgcGxhY2Vob2xkZXIgYXR0cmlidXRlIGlmIHdlIHdlcmUgdGhlIG9uZXMgdG8gYWRkIGl0CgkJCWlmICggdGhpcy5fcmVtb3ZlUGxhY2Vob2xkZXJBdHRyICkgewoJCQkJdGhpcy5fc2VsZWN0T3B0aW9ucygpLnJlbW92ZUF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJwbGFjZWhvbGRlciIgKTsKCQkJfQoKCQkJLy8gUmVtb3ZlIHRoZSBwb3B1cAoJCQl0aGlzLmxpc3Rib3gucmVtb3ZlKCk7CgoJCQkvLyBSZW1vdmUgdGhlIGRpYWxvZwoJCQl0aGlzLm1lbnVQYWdlLnJlbW92ZSgpOwoJCX0KCgkJLy8gQ2hhaW4gdXAKCQl0aGlzLl9zdXBlcigpOwoJfQp9KTsKCn0pKCBqUXVlcnkgKTsKCgovLyBidXR0b25NYXJrdXAgaXMgZGVwcmVjYXRlZCBhcyBvZiAxLjQuMCBhbmQgd2lsbCBiZSByZW1vdmVkIGluIDEuNS4wLgoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgoKLy8gR2VuZXJhbCBwb2xpY3k6IERvIG5vdCBhY2Nlc3MgZGF0YS0qIGF0dHJpYnV0ZXMgZXhjZXB0IGR1cmluZyBlbmhhbmNlbWVudC4KLy8gSW4gYWxsIG90aGVyIGNhc2VzIHdlIGRldGVybWluZSB0aGUgc3RhdGUgb2YgdGhlIGJ1dHRvbiBleGNsdXNpdmVseSBmcm9tIGl0cwovLyBjbGFzc05hbWUuIFRoYXQncyB3aHkgb3B0aW9uc1RvQ2xhc3NlcyBleHBlY3RzIGEgZnVsbCBjb21wbGVtZW50IG9mIG9wdGlvbnMsCi8vIGFuZCB0aGUgalF1ZXJ5IHBsdWdpbiBjb21wbGV0ZXMgdGhlIHNldCBvZiBvcHRpb25zIGZyb20gdGhlIGRlZmF1bHQgdmFsdWVzLgoKLy8gTWFwIGNsYXNzZXMgdG8gYnV0dG9uTWFya3VwIGJvb2xlYW4gb3B0aW9ucyAtIHVzZWQgaW4gY2xhc3NOYW1lVG9PcHRpb25zKCkKdmFyIHJldmVyc2VCb29sT3B0aW9uTWFwID0gewoJCSJ1aS1zaGFkb3ciIDogInNoYWRvdyIsCgkJInVpLWNvcm5lci1hbGwiIDogImNvcm5lcnMiLAoJCSJ1aS1idG4taW5saW5lIiA6ICJpbmxpbmUiLAoJCSJ1aS1zaGFkb3ctaWNvbiIgOiAiaWNvbnNoYWRvdyIsIC8qIFRPRE86IFJlbW92ZSBpbiAxLjUgKi8KCQkidWktbWluaSIgOiAibWluaSIKCX0sCglnZXRBdHRyRml4ZWQgPSBmdW5jdGlvbigpIHsKCQl2YXIgcmV0ID0gJC5tb2JpbGUuZ2V0QXR0cmlidXRlLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsKCgkJcmV0dXJuICggcmV0ID09IG51bGwgPyB1bmRlZmluZWQgOiByZXQgKTsKCX0sCgljYXBpdGFsTGV0dGVyc1JFID0gL1tBLVpdL2c7CgovLyBvcHRpb25zVG9DbGFzc2VzOgovLyBAb3B0aW9uczogQSBjb21wbGV0ZSBzZXQgb2Ygb3B0aW9ucyB0byBjb252ZXJ0IHRvIGNsYXNzIG5hbWVzLgovLyBAZXhpc3RpbmdDbGFzc2VzOiBleHRyYSBjbGFzc2VzIHRvIGFkZCB0byB0aGUgcmVzdWx0Ci8vCi8vIENvbnZlcnRzIEBvcHRpb25zIHRvIGJ1dHRvbk1hcmt1cCBjbGFzc2VzIGFuZCByZXR1cm5zIHRoZSByZXN1bHQgYXMgYW4gYXJyYXkKLy8gdGhhdCBjYW4gYmUgY29udmVydGVkIHRvIGFuIGVsZW1lbnQncyBjbGFzc05hbWUgd2l0aCAuam9pbiggIiAiICkuIEFsbAovLyBwb3NzaWJsZSBvcHRpb25zIG11c3QgYmUgc2V0IGluc2lkZSBAb3B0aW9ucy4gVXNlICQuZm4uYnV0dG9uTWFya3VwLmRlZmF1bHRzCi8vIHRvIGdldCBhIGNvbXBsZXRlIHNldCBhbmQgdXNlICQuZXh0ZW5kIHRvIG92ZXJyaWRlIHlvdXIgY2hvaWNlIG9mIG9wdGlvbnMKLy8gZnJvbSB0aGF0IHNldC4KZnVuY3Rpb24gb3B0aW9uc1RvQ2xhc3Nlcyggb3B0aW9ucywgZXhpc3RpbmdDbGFzc2VzICkgewoJdmFyIGNsYXNzZXMgPSBleGlzdGluZ0NsYXNzZXMgPyBleGlzdGluZ0NsYXNzZXMgOiBbXTsKCgkvLyBBZGQgY2xhc3NlcyB0byB0aGUgYXJyYXkgLSBmaXJzdCB1aS1idG4KCWNsYXNzZXMucHVzaCggInVpLWJ0biIgKTsKCgkvLyBJZiB0aGVyZSBpcyBhIHRoZW1lCglpZiAoIG9wdGlvbnMudGhlbWUgKSB7CgkJY2xhc3Nlcy5wdXNoKCAidWktYnRuLSIgKyBvcHRpb25zLnRoZW1lICk7Cgl9CgoJLy8gSWYgdGhlcmUncyBhbiBpY29uLCBhZGQgdGhlIGljb24tcmVsYXRlZCBjbGFzc2VzCglpZiAoIG9wdGlvbnMuaWNvbiApIHsKCQljbGFzc2VzID0gY2xhc3Nlcy5jb25jYXQoWwoJCQkidWktaWNvbi0iICsgb3B0aW9ucy5pY29uLAoJCQkidWktYnRuLWljb24tIiArIG9wdGlvbnMuaWNvbnBvcwoJCV0pOwoJCWlmICggb3B0aW9ucy5pY29uc2hhZG93ICkgewoJCQljbGFzc2VzLnB1c2goICJ1aS1zaGFkb3ctaWNvbiIgKTsgLyogVE9ETzogUmVtb3ZlIGluIDEuNSAqLwoJCX0KCX0KCgkvLyBBZGQgdGhlIGFwcHJvcHJpYXRlIGNsYXNzIGZvciBlYWNoIGJvb2xlYW4gb3B0aW9uCglpZiAoIG9wdGlvbnMuaW5saW5lICkgewoJCWNsYXNzZXMucHVzaCggInVpLWJ0bi1pbmxpbmUiICk7Cgl9CglpZiAoIG9wdGlvbnMuc2hhZG93ICkgewoJCWNsYXNzZXMucHVzaCggInVpLXNoYWRvdyIgKTsKCX0KCWlmICggb3B0aW9ucy5jb3JuZXJzICkgewoJCWNsYXNzZXMucHVzaCggInVpLWNvcm5lci1hbGwiICk7Cgl9CglpZiAoIG9wdGlvbnMubWluaSApIHsKCQljbGFzc2VzLnB1c2goICJ1aS1taW5pIiApOwoJfQoKCS8vIENyZWF0ZSBhIHN0cmluZyBmcm9tIHRoZSBhcnJheSBhbmQgcmV0dXJuIGl0CglyZXR1cm4gY2xhc3NlczsKfQoKLy8gY2xhc3NOYW1lVG9PcHRpb25zOgovLyBAY2xhc3NlczogQSBzdHJpbmcgY29udGFpbmluZyBhIC5jbGFzc05hbWUtc3R5bGUgc3BhY2Utc2VwYXJhdGVkIGNsYXNzIGxpc3QKLy8KLy8gTG9vcHMgb3ZlciBAY2xhc3NlcyBhbmQgY2FsY3VsYXRlcyBhbiBvcHRpb25zIG9iamVjdCBiYXNlZCBvbiB0aGUKLy8gYnV0dG9uTWFya3VwLXJlbGF0ZWQgY2xhc3NlcyBpdCBmaW5kcy4gSXQgcmVjb3JkcyB1bnJlY29nbml6ZWQgY2xhc3NlcyBpbiBhbgovLyBhcnJheS4KLy8KLy8gUmV0dXJuczogQW4gb2JqZWN0IGNvbnRhaW5pbmcgdGhlIGZvbGxvd2luZyBpdGVtczoKLy8KLy8gIm9wdGlvbnMiOiBidXR0b25NYXJrdXAgb3B0aW9ucyBmb3VuZCB0byBiZSBwcmVzZW50IGJlY2F1c2Ugb2YgdGhlCi8vIHByZXNlbmNlL2Fic2VuY2Ugb2YgY29ycmVzcG9uZGluZyBjbGFzc2VzCi8vCi8vICJ1bmtub3duQ2xhc3NlcyI6IGEgc3RyaW5nIGNvbnRhaW5pbmcgYWxsIHRoZSBub24tYnV0dG9uTWFya3VwLXJlbGF0ZWQKLy8gY2xhc3NlcyBmb3VuZCBpbiBAY2xhc3NlcwovLwovLyAiYWxyZWFkeUVuaGFuY2VkIjogQSBib29sZWFuIGluZGljYXRpbmcgd2hldGhlciB0aGUgdWktYnRuIGNsYXNzIHdhcyBhbW9uZwovLyB0aG9zZSBmb3VuZCB0byBiZSBwcmVzZW50CmZ1bmN0aW9uIGNsYXNzTmFtZVRvT3B0aW9ucyggY2xhc3NlcyApIHsKCXZhciBpZHgsIG1hcCwgdW5rbm93bkNsYXNzLAoJCWFscmVhZHlFbmhhbmNlZCA9IGZhbHNlLAoJCW5vSWNvbiA9IHRydWUsCgkJbyA9IHsKCQkJaWNvbjogIiIsCgkJCWlubGluZTogZmFsc2UsCgkJCXNoYWRvdzogZmFsc2UsCgkJCWNvcm5lcnM6IGZhbHNlLAoJCQlpY29uc2hhZG93OiBmYWxzZSwKCQkJbWluaTogZmFsc2UKCQl9LAoJCXVua25vd25DbGFzc2VzID0gW107CgoJY2xhc3NlcyA9IGNsYXNzZXMuc3BsaXQoICIgIiApOwoKCS8vIExvb3Agb3ZlciB0aGUgY2xhc3NlcwoJZm9yICggaWR4ID0gMCA7IGlkeCA8IGNsYXNzZXMubGVuZ3RoIDsgaWR4KysgKSB7CgoJCS8vIEFzc3VtZSBpdCdzIGFuIHVucmVjb2duaXplZCBjbGFzcwoJCXVua25vd25DbGFzcyA9IHRydWU7CgoJCS8vIFJlY29nbml6ZSBib29sZWFuIG9wdGlvbnMgZnJvbSB0aGUgcHJlc2VuY2Ugb2YgY2xhc3NlcwoJCW1hcCA9IHJldmVyc2VCb29sT3B0aW9uTWFwWyBjbGFzc2VzWyBpZHggXSBdOwoJCWlmICggbWFwICE9PSB1bmRlZmluZWQgKSB7CgkJCXVua25vd25DbGFzcyA9IGZhbHNlOwoJCQlvWyBtYXAgXSA9IHRydWU7CgoJCS8vIFJlY29nbml6ZSB0aGUgcHJlc2VuY2Ugb2YgYW4gaWNvbiBhbmQgZXN0YWJsaXNoIHRoZSBpY29uIHBvc2l0aW9uCgkJfSBlbHNlIGlmICggY2xhc3Nlc1sgaWR4IF0uaW5kZXhPZiggInVpLWJ0bi1pY29uLSIgKSA9PT0gMCApIHsKCQkJdW5rbm93bkNsYXNzID0gZmFsc2U7CgkJCW5vSWNvbiA9IGZhbHNlOwoJCQlvLmljb25wb3MgPSBjbGFzc2VzWyBpZHggXS5zdWJzdHJpbmcoIDEyICk7CgoJCS8vIEVzdGFibGlzaCB3aGljaCBpY29uIGlzIHByZXNlbnQKCQl9IGVsc2UgaWYgKCBjbGFzc2VzWyBpZHggXS5pbmRleE9mKCAidWktaWNvbi0iICkgPT09IDAgKSB7CgkJCXVua25vd25DbGFzcyA9IGZhbHNlOwoJCQlvLmljb24gPSBjbGFzc2VzWyBpZHggXS5zdWJzdHJpbmcoIDggKTsKCgkJLy8gRXN0YWJsaXNoIHRoZSB0aGVtZSAtIHRoaXMgcmVjb2duaXplcyBvbmUtbGV0dGVyIHRoZW1lIHN3YXRjaCBuYW1lcwoJCX0gZWxzZSBpZiAoIGNsYXNzZXNbIGlkeCBdLmluZGV4T2YoICJ1aS1idG4tIiApID09PSAwICYmIGNsYXNzZXNbIGlkeCBdLmxlbmd0aCA9PT0gOCApIHsKCQkJdW5rbm93bkNsYXNzID0gZmFsc2U7CgkJCW8udGhlbWUgPSBjbGFzc2VzWyBpZHggXS5zdWJzdHJpbmcoIDcgKTsKCgkJLy8gUmVjb2duaXplIHRoYXQgdGhpcyBlbGVtZW50IGhhcyBhbHJlYWR5IGJlZW4gYnV0dG9uTWFya3VwLWVuaGFuY2VkCgkJfSBlbHNlIGlmICggY2xhc3Nlc1sgaWR4IF0gPT09ICJ1aS1idG4iICkgewoJCQl1bmtub3duQ2xhc3MgPSBmYWxzZTsKCQkJYWxyZWFkeUVuaGFuY2VkID0gdHJ1ZTsKCQl9CgoJCS8vIElmIHRoaXMgY2xhc3MgaGFzIG5vdCBiZWVuIHJlY29nbml6ZWQsIGFkZCBpdCB0byB0aGUgbGlzdAoJCWlmICggdW5rbm93bkNsYXNzICkgewoJCQl1bmtub3duQ2xhc3Nlcy5wdXNoKCBjbGFzc2VzWyBpZHggXSApOwoJCX0KCX0KCgkvLyBJZiBhICJ1aS1idG4taWNvbi0qIiBpY29uIHBvc2l0aW9uIGNsYXNzIGlzIGFic2VudCB0aGVyZSBjYW5ub3QgYmUgYW4gaWNvbgoJaWYgKCBub0ljb24gKSB7CgkJby5pY29uID0gIiI7Cgl9CgoJcmV0dXJuIHsKCQlvcHRpb25zOiBvLAoJCXVua25vd25DbGFzc2VzOiB1bmtub3duQ2xhc3NlcywKCQlhbHJlYWR5RW5oYW5jZWQ6IGFscmVhZHlFbmhhbmNlZAoJfTsKfQoKZnVuY3Rpb24gY2FtZWxDYXNlMkh5cGhlbmF0ZWQoIGMgKSB7CglyZXR1cm4gIi0iICsgYy50b0xvd2VyQ2FzZSgpOwp9CgovLyAkLmZuLmJ1dHRvbk1hcmt1cDoKLy8gRE9NOiBnZXRzL3NldHMgLmNsYXNzTmFtZQovLwovLyBAb3B0aW9uczogb3B0aW9ucyB0byBhcHBseSB0byB0aGUgZWxlbWVudHMgaW4gdGhlIGpRdWVyeSBvYmplY3QKLy8gQG92ZXJ3cml0ZUNsYXNzZXM6IGJvb2xlYW4gaW5kaWNhdGluZyB3aGV0aGVyIHRvIGhvbm91ciBleGlzdGluZyBjbGFzc2VzCi8vCi8vIENhbGN1bGF0ZXMgdGhlIGNsYXNzZXMgdG8gYXBwbHkgdG8gdGhlIGVsZW1lbnRzIGluIHRoZSBqUXVlcnkgb2JqZWN0IGJhc2VkIG9uCi8vIHRoZSBvcHRpb25zIHBhc3NlZCBpbi4gSWYgQG92ZXJ3cml0ZUNsYXNzZXMgaXMgdHJ1ZSwgaXQgc2V0cyB0aGUgY2xhc3NOYW1lCi8vIHByb3BlcnR5IG9mIGVhY2ggZWxlbWVudCBpbiB0aGUgalF1ZXJ5IG9iamVjdCB0byB0aGUgYnV0dG9uTWFya3VwIGNsYXNzZXMKLy8gaXQgY2FsY3VsYXRlcyBiYXNlZCBvbiB0aGUgb3B0aW9ucyBwYXNzZWQgaW4uCi8vCi8vIElmIHlvdSB3aXNoIHRvIHByZXNlcnZlIGFueSBjbGFzc2VzIHRoYXQgYXJlIGFscmVhZHkgcHJlc2VudCBvbiB0aGUgZWxlbWVudHMKLy8gaW5zaWRlIHRoZSBqUXVlcnkgb2JqZWN0LCBpbmNsdWRpbmcgYnV0dG9uTWFya3VwLXJlbGF0ZWQgY2xhc3NlcyB0aGF0IHdlcmUKLy8gYWRkZWQgYnkgYSBwcmV2aW91cyBjYWxsIHRvICQuZm4uYnV0dG9uTWFya3VwKCkgb3IgZHVyaW5nIHBhZ2UgZW5oYW5jZW1lbnQKLy8gdGhlbiB5b3Ugc2hvdWxkIG9taXQgQG92ZXJ3cml0ZUNsYXNzZXMgb3Igc2V0IGl0IHRvIGZhbHNlLgokLmZuLmJ1dHRvbk1hcmt1cCA9IGZ1bmN0aW9uKCBvcHRpb25zLCBvdmVyd3JpdGVDbGFzc2VzICkgewoJdmFyIGlkeCwgZGF0YSwgZWwsIHJldHJpZXZlZE9wdGlvbnMsIG9wdGlvbktleSwKCQlkZWZhdWx0cyA9ICQuZm4uYnV0dG9uTWFya3VwLmRlZmF1bHRzOwoKCWZvciAoIGlkeCA9IDAgOyBpZHggPCB0aGlzLmxlbmd0aCA7IGlkeCsrICkgewoJCWVsID0gdGhpc1sgaWR4IF07CgkJZGF0YSA9IG92ZXJ3cml0ZUNsYXNzZXMgPwoKCQkJLy8gQXNzdW1lIHRoaXMgZWxlbWVudCBpcyBub3QgZW5oYW5jZWQgYW5kIGlnbm9yZSBpdHMgY2xhc3NlcwoJCQl7IGFscmVhZHlFbmhhbmNlZDogZmFsc2UsIHVua25vd25DbGFzc2VzOiBbXSB9IDoKCgkJCS8vIE90aGVyd2lzZSBhbmFseXplIGV4aXN0aW5nIGNsYXNzZXMgdG8gZXN0YWJsaXNoIGV4aXN0aW5nIG9wdGlvbnMgYW5kCgkJCS8vIGNsYXNzZXMKCQkJY2xhc3NOYW1lVG9PcHRpb25zKCBlbC5jbGFzc05hbWUgKTsKCgkJcmV0cmlldmVkT3B0aW9ucyA9ICQuZXh0ZW5kKCB7fSwKCgkJCS8vIElmIHRoZSBlbGVtZW50IGFscmVhZHkgaGFzIHRoZSBjbGFzcyB1aS1idG4sIHRoZW4gd2UgYXNzdW1lIHRoYXQKCQkJLy8gaXQgaGFzIHBhc3NlZCB0aHJvdWdoIGJ1dHRvbk1hcmt1cCBiZWZvcmUgLSBvdGhlcndpc2UsIHRoZSBvcHRpb25zCgkJCS8vIHJldHVybmVkIGJ5IGNsYXNzTmFtZVRvT3B0aW9ucyBkbyBub3QgY29ycmVjdGx5IHJlZmxlY3QgdGhlIHN0YXRlIG9mCgkJCS8vIHRoZSBlbGVtZW50CgkJCSggZGF0YS5hbHJlYWR5RW5oYW5jZWQgPyBkYXRhLm9wdGlvbnMgOiB7fSApLAoKCQkJLy8gRmluYWxseSwgYXBwbHkgdGhlIG9wdGlvbnMgcGFzc2VkIGluCgkJCW9wdGlvbnMgKTsKCgkJLy8gSWYgdGhpcyBpcyB0aGUgZmlyc3QgY2FsbCBvbiB0aGlzIGVsZW1lbnQsIHJldHJpZXZlIHJlbWFpbmluZyBvcHRpb25zCgkJLy8gZnJvbSB0aGUgZGF0YS1hdHRyaWJ1dGVzCgkJaWYgKCAhZGF0YS5hbHJlYWR5RW5oYW5jZWQgKSB7CgkJCWZvciAoIG9wdGlvbktleSBpbiBkZWZhdWx0cyApIHsKCQkJCWlmICggcmV0cmlldmVkT3B0aW9uc1sgb3B0aW9uS2V5IF0gPT09IHVuZGVmaW5lZCApIHsKCQkJCQlyZXRyaWV2ZWRPcHRpb25zWyBvcHRpb25LZXkgXSA9IGdldEF0dHJGaXhlZCggZWwsCgkJCQkJCW9wdGlvbktleS5yZXBsYWNlKCBjYXBpdGFsTGV0dGVyc1JFLCBjYW1lbENhc2UySHlwaGVuYXRlZCApCgkJCQkJKTsKCQkJCX0KCQkJfQoJCX0KCgkJZWwuY2xhc3NOYW1lID0gb3B0aW9uc1RvQ2xhc3NlcygKCgkJCS8vIE1lcmdlIGFsbCB0aGUgb3B0aW9ucyBhbmQgYXBwbHkgdGhlbSBhcyBjbGFzc2VzCgkJCSQuZXh0ZW5kKCB7fSwKCgkJCQkvLyBUaGUgZGVmYXVsdHMgZm9ybSB0aGUgYmFzaXMKCQkJCWRlZmF1bHRzLAoKCQkJCS8vIEFkZCB0aGUgY29tcHV0ZWQgb3B0aW9ucwoJCQkJcmV0cmlldmVkT3B0aW9ucwoJCQkpLAoKCQkJLy8gLi4uIGFuZCByZS1hcHBseSBhbnkgdW5yZWNvZ25pemVkIGNsYXNzZXMgdGhhdCB3ZXJlIGZvdW5kCgkJCWRhdGEudW5rbm93bkNsYXNzZXMgKS5qb2luKCAiICIgKTsKCQlpZiAoIGVsLnRhZ05hbWUudG9Mb3dlckNhc2UoKSAhPT0gImJ1dHRvbiIgKSB7CgkJCWVsLnNldEF0dHJpYnV0ZSggInJvbGUiLCAiYnV0dG9uIiApOwoJCX0KCX0KCglyZXR1cm4gdGhpczsKfTsKCi8vIGJ1dHRvbk1hcmt1cCBkZWZhdWx0cy4gVGhpcyBtdXN0IGJlIGEgY29tcGxldGUgc2V0LCBpLmUuLCBhIHZhbHVlIG11c3QgYmUKLy8gZ2l2ZW4gaGVyZSBmb3IgYWxsIHJlY29nbml6ZWQgb3B0aW9ucwokLmZuLmJ1dHRvbk1hcmt1cC5kZWZhdWx0cyA9IHsKCWljb246ICIiLAoJaWNvbnBvczogImxlZnQiLAoJdGhlbWU6IG51bGwsCglpbmxpbmU6IGZhbHNlLAoJc2hhZG93OiB0cnVlLAoJY29ybmVyczogdHJ1ZSwKCWljb25zaGFkb3c6IGZhbHNlLCAvKiBUT0RPOiBSZW1vdmUgaW4gMS41LiBPcHRpb24gZGVwcmVjYXRlZCBpbiAxLjQuICovCgltaW5pOiBmYWxzZQp9OwoKJC5leHRlbmQoICQuZm4uYnV0dG9uTWFya3VwLCB7Cglpbml0U2VsZWN0b3I6ICJhOmpxbURhdGEocm9sZT0nYnV0dG9uJyksIC51aS1iYXIgPiBhLCAudWktYmFyID4gOmpxbURhdGEocm9sZT0nY29udHJvbGdyb3VwJykgPiBhLCBidXR0b24iCn0pOwoKfSkoIGpRdWVyeSApOwoKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUuY29udHJvbGdyb3VwIiwgJC5leHRlbmQoIHsKCW9wdGlvbnM6IHsKCQllbmhhbmNlZDogZmFsc2UsCgkJdGhlbWU6IG51bGwsCgkJc2hhZG93OiBmYWxzZSwKCQljb3JuZXJzOiB0cnVlLAoJCWV4Y2x1ZGVJbnZpc2libGU6IHRydWUsCgkJdHlwZTogInZlcnRpY2FsIiwKCQltaW5pOiBmYWxzZQoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl2YXIgZWxlbSA9IHRoaXMuZWxlbWVudCwKCQkJb3B0cyA9IHRoaXMub3B0aW9uczsKCgkJLy8gUnVuIGJ1dHRvbm1hcmt1cAoJCWlmKCAkLmZuLmJ1dHRvbk1hcmt1cCApewoJCQl0aGlzLmVsZW1lbnQuZmluZCggJC5mbi5idXR0b25NYXJrdXAuaW5pdFNlbGVjdG9yICkuYnV0dG9uTWFya3VwKCk7CgkJfQoJCS8vIEVuaGFuY2UgY2hpbGQgd2lkZ2V0cwoJCSQuZWFjaCggdGhpcy5fY2hpbGRXaWRnZXRzLCAkLnByb3h5KCBmdW5jdGlvbiggbnVtYmVyLCB3aWRnZXROYW1lICkgewoJCQlpZiggJC5tb2JpbGVbIHdpZGdldE5hbWUgXSApIHsKCQkJCXRoaXMuZWxlbWVudC5maW5kKCAkLm1vYmlsZVsgd2lkZ2V0TmFtZSBdLmluaXRTZWxlY3RvciApWyB3aWRnZXROYW1lIF0oKTsKCQkJfQoJCX0sIHRoaXMgKSk7CgoJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCV91aTogbnVsbCwKCQkJX2luaXRpYWxSZWZyZXNoOiB0cnVlCgkJfSk7CgoJCWlmICggb3B0cy5lbmhhbmNlZCApIHsKCQkJdGhpcy5fdWkgPSB7CgkJCQlncm91cExlZ2VuZDogZWxlbS5jaGlsZHJlbiggIi51aS1jb250cm9sZ3JvdXAtbGFiZWwiICkuY2hpbGRyZW4oKSwKCQkJCWNoaWxkV3JhcHBlcjogZWxlbS5jaGlsZHJlbiggIi51aS1jb250cm9sZ3JvdXAtY29udHJvbHMiICkKCQkJfTsKCQl9IGVsc2UgewoJCQl0aGlzLl91aSA9IHRoaXMuX2VuaGFuY2UoKTsKCQl9CgkJCgl9LAoKCV9jaGlsZFdpZGdldHM6IFsgImNoZWNrYm94cmFkaW8iLCAic2VsZWN0bWVudSIsICJidXR0b24iIF0sCgoJX3RoZW1lQ2xhc3NGcm9tT3B0aW9uOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJcmV0dXJuICggdmFsdWUgPyAoIHZhbHVlID09PSAibm9uZSIgPyAiIiA6ICJ1aS1ncm91cC10aGVtZS0iICsgdmFsdWUgKSA6ICIiICk7Cgl9LAoKCV9lbmhhbmNlOiBmdW5jdGlvbigpIHsKCQl2YXIgZWxlbSA9IHRoaXMuZWxlbWVudCwKCQkJb3B0cyA9IHRoaXMub3B0aW9ucywKCQkJdWkgPSB7CgkJCQlncm91cExlZ2VuZDogZWxlbS5jaGlsZHJlbiggImxlZ2VuZCIgKSwKCQkJCWNoaWxkV3JhcHBlcjogZWxlbQoJCQkJCS5hZGRDbGFzcyggInVpLWNvbnRyb2xncm91cCAiICsKCQkJCQkJInVpLWNvbnRyb2xncm91cC0iICsKCQkJCQkJCSggb3B0cy50eXBlID09PSAiaG9yaXpvbnRhbCIgPyAiaG9yaXpvbnRhbCIgOiAidmVydGljYWwiICkgKyAiICIgKwoJCQkJCQl0aGlzLl90aGVtZUNsYXNzRnJvbU9wdGlvbiggb3B0cy50aGVtZSApICsgIiAiICsKCQkJCQkJKCBvcHRzLmNvcm5lcnMgPyAidWktY29ybmVyLWFsbCAiIDogIiIgKSArCgkJCQkJCSggb3B0cy5taW5pID8gInVpLW1pbmkgIiA6ICIiICkgKQoJCQkJCS53cmFwSW5uZXIoICI8ZGl2ICIgKwoJCQkJCQkiY2xhc3M9J3VpLWNvbnRyb2xncm91cC1jb250cm9scyAiICsKCQkJCQkJCSggb3B0cy5zaGFkb3cgPT09IHRydWUgPyAidWktc2hhZG93IiA6ICIiICkgKyAiJz48L2Rpdj4iICkKCQkJCQkuY2hpbGRyZW4oKQoJCQl9OwoKCQlpZiAoIHVpLmdyb3VwTGVnZW5kLmxlbmd0aCA+IDAgKSB7CgkJCSQoICI8ZGl2IHJvbGU9J2hlYWRpbmcnIGNsYXNzPSd1aS1jb250cm9sZ3JvdXAtbGFiZWwnPjwvZGl2PiIgKQoJCQkJLmFwcGVuZCggdWkuZ3JvdXBMZWdlbmQgKQoJCQkJLnByZXBlbmRUbyggZWxlbSApOwoJCX0KCgkJcmV0dXJuIHVpOwoJfSwKCglfaW5pdDogZnVuY3Rpb24oKSB7CgkJdGhpcy5yZWZyZXNoKCk7Cgl9LAoKCV9zZXRPcHRpb25zOiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQl2YXIgY2FsbFJlZnJlc2gsCgkJCWVsZW0gPSB0aGlzLmVsZW1lbnQ7CgoJCS8vIE11c3QgaGF2ZSBvbmUgb2YgaG9yaXpvbnRhbCBvciB2ZXJ0aWNhbAoJCWlmICggb3B0aW9ucy50eXBlICE9PSB1bmRlZmluZWQgKSB7CgkJCWVsZW0KCQkJCS5yZW1vdmVDbGFzcyggInVpLWNvbnRyb2xncm91cC1ob3Jpem9udGFsIHVpLWNvbnRyb2xncm91cC12ZXJ0aWNhbCIgKQoJCQkJLmFkZENsYXNzKCAidWktY29udHJvbGdyb3VwLSIgKyAoIG9wdGlvbnMudHlwZSA9PT0gImhvcml6b250YWwiID8gImhvcml6b250YWwiIDogInZlcnRpY2FsIiApICk7CgkJCWNhbGxSZWZyZXNoID0gdHJ1ZTsKCQl9CgoJCWlmICggb3B0aW9ucy50aGVtZSAhPT0gdW5kZWZpbmVkICkgewoJCQllbGVtCgkJCQkucmVtb3ZlQ2xhc3MoIHRoaXMuX3RoZW1lQ2xhc3NGcm9tT3B0aW9uKCB0aGlzLm9wdGlvbnMudGhlbWUgKSApCgkJCQkuYWRkQ2xhc3MoIHRoaXMuX3RoZW1lQ2xhc3NGcm9tT3B0aW9uKCBvcHRpb25zLnRoZW1lICkgKTsKCQl9CgoJCWlmICggb3B0aW9ucy5jb3JuZXJzICE9PSB1bmRlZmluZWQgKSB7CgkJCWVsZW0udG9nZ2xlQ2xhc3MoICJ1aS1jb3JuZXItYWxsIiwgb3B0aW9ucy5jb3JuZXJzICk7CgkJfQoKCQlpZiAoIG9wdGlvbnMubWluaSAhPT0gdW5kZWZpbmVkICkgewoJCQllbGVtLnRvZ2dsZUNsYXNzKCAidWktbWluaSIsIG9wdGlvbnMubWluaSApOwoJCX0KCgkJaWYgKCBvcHRpb25zLnNoYWRvdyAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLl91aS5jaGlsZFdyYXBwZXIudG9nZ2xlQ2xhc3MoICJ1aS1zaGFkb3ciLCBvcHRpb25zLnNoYWRvdyApOwoJCX0KCgkJaWYgKCBvcHRpb25zLmV4Y2x1ZGVJbnZpc2libGUgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhpcy5vcHRpb25zLmV4Y2x1ZGVJbnZpc2libGUgPSBvcHRpb25zLmV4Y2x1ZGVJbnZpc2libGU7CgkJCWNhbGxSZWZyZXNoID0gdHJ1ZTsKCQl9CgoJCWlmICggY2FsbFJlZnJlc2ggKSB7CgkJCXRoaXMucmVmcmVzaCgpOwoJCX0KCgkJcmV0dXJuIHRoaXMuX3N1cGVyKCBvcHRpb25zICk7Cgl9LAoKCWNvbnRhaW5lcjogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuX3VpLmNoaWxkV3JhcHBlcjsKCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJdmFyICRlbCA9IHRoaXMuY29udGFpbmVyKCksCgkJCWVscyA9ICRlbC5maW5kKCAiLnVpLWJ0biIgKS5ub3QoICIudWktc2xpZGVyLWhhbmRsZSIgKSwKCQkJY3JlYXRlID0gdGhpcy5faW5pdGlhbFJlZnJlc2g7CgkJaWYgKCAkLm1vYmlsZS5jaGVja2JveHJhZGlvICkgewoJCQkkZWwuZmluZCggIjptb2JpbGUtY2hlY2tib3hyYWRpbyIgKS5jaGVja2JveHJhZGlvKCAicmVmcmVzaCIgKTsKCQl9CgkJdGhpcy5fYWRkRmlyc3RMYXN0Q2xhc3NlcyggZWxzLAoJCQl0aGlzLm9wdGlvbnMuZXhjbHVkZUludmlzaWJsZSA/IHRoaXMuX2dldFZpc2libGVzKCBlbHMsIGNyZWF0ZSApIDogZWxzLAoJCQljcmVhdGUgKTsKCQl0aGlzLl9pbml0aWFsUmVmcmVzaCA9IGZhbHNlOwoJfSwKCgkvLyBDYXZlYXQ6IElmIHRoZSBsZWdlbmQgaXMgbm90IHRoZSBmaXJzdCBjaGlsZCBvZiB0aGUgY29udHJvbGdyb3VwIGF0IGVuaGFuY2UKCS8vIHRpbWUsIGl0IHdpbGwgYmUgYWZ0ZXIgX2Rlc3Ryb3koKS4KCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCQl2YXIgdWksIGJ1dHRvbnMsCgkJCW9wdHMgPSB0aGlzLm9wdGlvbnM7CgoJCWlmICggb3B0cy5lbmhhbmNlZCApIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQl1aSA9IHRoaXMuX3VpOwoJCWJ1dHRvbnMgPSB0aGlzLmVsZW1lbnQKCQkJLnJlbW92ZUNsYXNzKCAidWktY29udHJvbGdyb3VwICIgKwoJCQkJInVpLWNvbnRyb2xncm91cC1ob3Jpem9udGFsIHVpLWNvbnRyb2xncm91cC12ZXJ0aWNhbCB1aS1jb3JuZXItYWxsIHVpLW1pbmkgIiArCgkJCQl0aGlzLl90aGVtZUNsYXNzRnJvbU9wdGlvbiggb3B0cy50aGVtZSApICkKCQkJLmZpbmQoICIudWktYnRuIiApCgkJCS5ub3QoICIudWktc2xpZGVyLWhhbmRsZSIgKTsKCgkJdGhpcy5fcmVtb3ZlRmlyc3RMYXN0Q2xhc3NlcyggYnV0dG9ucyApOwoKCQl1aS5ncm91cExlZ2VuZC51bndyYXAoKTsKCQl1aS5jaGlsZFdyYXBwZXIuY2hpbGRyZW4oKS51bndyYXAoKTsKCX0KfSwgJC5tb2JpbGUuYmVoYXZpb3JzLmFkZEZpcnN0TGFzdENsYXNzZXMgKSApOwoKfSkoalF1ZXJ5KTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKCgkkLndpZGdldCggIm1vYmlsZS50b29sYmFyIiwgewoJCWluaXRTZWxlY3RvcjogIjpqcW1EYXRhKHJvbGU9J2Zvb3RlcicpLCA6anFtRGF0YShyb2xlPSdoZWFkZXInKSIsCgoJCW9wdGlvbnM6IHsKCQkJdGhlbWU6IG51bGwsCgkJCWFkZEJhY2tCdG46IGZhbHNlLAoJCQliYWNrQnRuVGhlbWU6IG51bGwsCgkJCWJhY2tCdG5UZXh0OiAiQmFjayIKCQl9LAoKCQlfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQkJdmFyIGxlZnRidG4sIHJpZ2h0YnRuLCBiYWNrQnRuLAoJCQkJcm9sZSA9ICB0aGlzLmVsZW1lbnQuaXMoICI6anFtRGF0YShyb2xlPSdoZWFkZXInKSIgKSA/ICJoZWFkZXIiIDogImZvb3RlciIsCgkJCQlwYWdlID0gdGhpcy5lbGVtZW50LmNsb3Nlc3QoICIudWktcGFnZSIgKTsKCQkJaWYgKCBwYWdlLmxlbmd0aCA9PT0gMCApewoJCQkJcGFnZSA9IGZhbHNlOwoJCQkJdGhpcy5fb24oIHRoaXMuZG9jdW1lbnQsIHsKCQkJCQkicGFnZXNob3ciOiAicmVmcmVzaCIKCQkJCX0pOwoJCQl9CgkJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCQlyb2xlOiByb2xlLAoJCQkJcGFnZTogcGFnZSwKCQkJCWxlZnRidG46IGxlZnRidG4sCgkJCQlyaWdodGJ0bjogcmlnaHRidG4sCgkJCQliYWNrQnRuOiBiYWNrQnRuCgkJCX0pOwoJCQl0aGlzLmVsZW1lbnQuYXR0ciggInJvbGUiLCByb2xlID09PSAiaGVhZGVyIiA/ICJiYW5uZXIiIDogImNvbnRlbnRpbmZvIiApLmFkZENsYXNzKCAidWktIiArIHJvbGUgKTsKCQkJdGhpcy5yZWZyZXNoKCk7CgkJCXRoaXMuX3NldE9wdGlvbnMoIHRoaXMub3B0aW9ucyApOwoJCX0sCgkJX3NldE9wdGlvbnM6IGZ1bmN0aW9uKCBvICkgewoJCQlpZiAoIG8uYWRkQmFja0J0biAhPT0gdW5kZWZpbmVkICkgewoJCQkJaWYgKCB0aGlzLm9wdGlvbnMuYWRkQmFja0J0biAmJgoJCQkJCXRoaXMucm9sZSA9PT0gImhlYWRlciIgJiYKCQkJCQkkKCAiLnVpLXBhZ2UiICkubGVuZ3RoID4gMSAmJgoJCQkJCXRoaXMucGFnZVsgMCBdLmdldEF0dHJpYnV0ZSggImRhdGEtIiArICQubW9iaWxlLm5zICsgInVybCIgKSAhPT0gJC5tb2JpbGUucGF0aC5zdHJpcEhhc2goIGxvY2F0aW9uLmhhc2ggKSAmJgoJCQkJCSF0aGlzLmxlZnRidG4gKSB7CgkJCQkJCXRoaXMuX2FkZEJhY2tCdXR0b24oKTsKCQkJCX0gZWxzZSB7CgkJCQkJdGhpcy5lbGVtZW50LmZpbmQoICIudWktdG9vbGJhci1iYWNrLWJ0biIgKS5yZW1vdmUoKTsKCQkJCX0KCQkJfQoJCQlpZiAoIG8uYmFja0J0blRoZW1lICE9PSB1bmRlZmluZWQgKSB7CgkJCQl0aGlzLmVsZW1lbnQKCQkJCQkuZmluZCggIi51aS10b29sYmFyLWJhY2stYnRuIiApCgkJCQkJLmFkZENsYXNzKCAidWktYnRuIHVpLWJ0bi0iICsgby5iYWNrQnRuVGhlbWUgKTsKCQkJfQoJCQlpZiAoIG8uYmFja0J0blRleHQgIT09IHVuZGVmaW5lZCApIHsKCQkJCXRoaXMuZWxlbWVudC5maW5kKCAiLnVpLXRvb2xiYXItYmFjay1idG4gLnVpLWJ0bi10ZXh0IiApLnRleHQoIG8uYmFja0J0blRleHQgKTsKCQkJfQoJCQlpZiAoIG8udGhlbWUgIT09IHVuZGVmaW5lZCApIHsKCQkJCXZhciBjdXJyZW50VGhlbWUgPSB0aGlzLm9wdGlvbnMudGhlbWUgPyB0aGlzLm9wdGlvbnMudGhlbWUgOiAiaW5oZXJpdCIsCgkJCQkJbmV3VGhlbWUgPSBvLnRoZW1lID8gby50aGVtZSA6ICJpbmhlcml0IjsKCgkJCQl0aGlzLmVsZW1lbnQucmVtb3ZlQ2xhc3MoICJ1aS1iYXItIiArIGN1cnJlbnRUaGVtZSApLmFkZENsYXNzKCAidWktYmFyLSIgKyBuZXdUaGVtZSApOwoJCQl9CgoJCQl0aGlzLl9zdXBlciggbyApOwoJCX0sCgkJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJCWlmICggdGhpcy5yb2xlID09PSAiaGVhZGVyIiApIHsKCQkJCXRoaXMuX2FkZEhlYWRlckJ1dHRvbkNsYXNzZXMoKTsKCQkJfQoJCQlpZiAoICF0aGlzLnBhZ2UgKSB7CgkJCQkkKCAiW2RhdGEtIisgJC5tb2JpbGUubnMgKyJyb2xlPSdwYWdlJ10iICkuY3NzKHsicG9zaXRpb24iOiJyZWxhdGl2ZSJ9KTsKCQkJCWlmICggdGhpcy5yb2xlID09PSAiZm9vdGVyIiApIHsKCQkJCQl0aGlzLmVsZW1lbnQuYXBwZW5kVG8oICJib2R5IiApOwoJCQkJfQoJCQl9CgkJCXRoaXMuX2FkZEhlYWRpbmdDbGFzc2VzKCk7CgkJCXRoaXMuX2J0bk1hcmt1cCgpOwoJCX0sCgkJLy8gRGVwcmVjYXRlZCBpbiAxLjQuIEFzIGZyb20gMS41IGRhdGEtcm9sZT0iYnV0dG9uIiBoYXMgdG8gYmUgcHJlc2VudCBpbiB0aGUgbWFya3VwLgoJCV9idG5NYXJrdXA6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLmVsZW1lbnQuY2hpbGRyZW4oICJhIiApLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyb2xlIiwgImJ1dHRvbiIgKTsKCQkJdGhpcy5lbGVtZW50LnRyaWdnZXIoICJjcmVhdGUiICk7CgkJfSwKCQlfYWRkSGVhZGVyQnV0dG9uQ2xhc3NlczogZnVuY3Rpb24oKSB7CgkJCXZhciAkaGVhZGVyYW5jaG9ycyA9IHRoaXMuZWxlbWVudC5jaGlsZHJlbiggImEsIGJ1dHRvbiIgKTsKCQkJdGhpcy5sZWZ0YnRuID0gJGhlYWRlcmFuY2hvcnMuaGFzQ2xhc3MoICJ1aS1idG4tbGVmdCIgKTsKCQkJdGhpcy5yaWdodGJ0biA9ICRoZWFkZXJhbmNob3JzLmhhc0NsYXNzKCAidWktYnRuLXJpZ2h0IiApOwoKCQkJdGhpcy5sZWZ0YnRuID0gdGhpcy5sZWZ0YnRuIHx8ICRoZWFkZXJhbmNob3JzLmVxKCAwICkubm90KCAiLnVpLWJ0bi1yaWdodCIgKS5hZGRDbGFzcyggInVpLWJ0bi1sZWZ0IiApLmxlbmd0aDsKCgkJCXRoaXMucmlnaHRidG4gPSB0aGlzLnJpZ2h0YnRuIHx8ICRoZWFkZXJhbmNob3JzLmVxKCAxICkuYWRkQ2xhc3MoICJ1aS1idG4tcmlnaHQiICkubGVuZ3RoOwoKCQl9LAoJCV9hZGRCYWNrQnV0dG9uOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5iYWNrQnRuID0gJCggIjxhIHJvbGU9J2J1dHRvbicgaHJlZj0namF2YXNjcmlwdDp2b2lkKDApOycgY2xhc3M9J3VpLWJ0bi1sZWZ0IHVpLXRvb2xiYXItYmFjay1idG4nIGRhdGEtIiArICQubW9iaWxlLm5zICsgInJlbD0nYmFjaycgZGF0YS0iICsgJC5tb2JpbGUubnMgKyAiaWNvbj0nY2FyYXQtbCc+IiArIHRoaXMub3B0aW9ucy5iYWNrQnRuVGV4dCArICI8L2E+IiApCgkJCQkJLy8gSWYgdGhlbWUgaXMgcHJvdmlkZWQsIG92ZXJyaWRlIGRlZmF1bHQgaW5oZXJpdGFuY2UKCQkJCQkuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgInRoZW1lIiwgdGhpcy5vcHRpb25zLmJhY2tCdG5UaGVtZSB8fCB0aGlzLm9wdGlvbnMudGhlbWUgKQoJCQkJCS5wcmVwZW5kVG8oIHRoaXMuZWxlbWVudCApOwoJCX0sCgkJX2FkZEhlYWRpbmdDbGFzc2VzOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5lbGVtZW50LmNoaWxkcmVuKCAiaDEsIGgyLCBoMywgaDQsIGg1LCBoNiIgKQoJCQkJLmFkZENsYXNzKCAidWktdGl0bGUiICkKCQkJCS8vIFJlZ2FyZGxlc3Mgb2YgaCBlbGVtZW50IG51bWJlciBpbiBzcmMsIGl0IGJlY29tZXMgaDEgZm9yIHRoZSBlbmhhbmNlZCBwYWdlCgkJCQkuYXR0cih7CgkJCQkJInJvbGUiOiAiaGVhZGluZyIsCgkJCQkJImFyaWEtbGV2ZWwiOiAiMSIKCQkJCX0pOwoJCX0KCX0pOwoJCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKCgkkLndpZGdldCggIm1vYmlsZS50b29sYmFyIiwgJC5tb2JpbGUudG9vbGJhciwgewoJCW9wdGlvbnM6IHsKCQkJcG9zaXRpb246bnVsbCwKCQkJdmlzaWJsZU9uUGFnZVNob3c6IHRydWUsCgkJCWRpc2FibGVQYWdlWm9vbTogdHJ1ZSwKCQkJdHJhbnNpdGlvbjogInNsaWRlIiwgLy9jYW4gYmUgbm9uZSwgZmFkZSwgc2xpZGUgKHNsaWRlIG1hcHMgdG8gc2xpZGV1cCBvciBzbGlkZWRvd24pCgkJCWZ1bGxzY3JlZW46IGZhbHNlLAoJCQl0YXBUb2dnbGU6IHRydWUsCgkJCXRhcFRvZ2dsZUJsYWNrbGlzdDogImEsIGJ1dHRvbiwgaW5wdXQsIHNlbGVjdCwgdGV4dGFyZWEsIC51aS1oZWFkZXItZml4ZWQsIC51aS1mb290ZXItZml4ZWQsIC51aS1mbGlwc3dpdGNoLCAudWktcG9wdXAsIC51aS1wYW5lbCwgLnVpLXBhbmVsLWRpc21pc3Mtb3BlbiIsCgkJCWhpZGVEdXJpbmdGb2N1czogImlucHV0LCB0ZXh0YXJlYSwgc2VsZWN0IiwKCQkJdXBkYXRlUGFnZVBhZGRpbmc6IHRydWUsCgkJCXRyYWNrUGVyc2lzdGVudFRvb2xiYXJzOiB0cnVlLAoKCQkJLy8gQnJvd3NlciBkZXRlY3Rpb24hIFdlZWVlLCBoZXJlIHdlIGdvLi4uCgkJCS8vIFVuZm9ydHVuYXRlbHksIHBvc2l0aW9uOmZpeGVkIGlzIGNvc3RseSwgbm90IHRvIG1lbnRpb24gcHJvYmFibHkgaW1wb3NzaWJsZSwgdG8gZmVhdHVyZS1kZXRlY3QgYWNjdXJhdGVseS4KCQkJLy8gU29tZSB0ZXN0cyBleGlzdCwgYnV0IHRoZXkgY3VycmVudGx5IHJldHVybiBmYWxzZSByZXN1bHRzIGluIGNyaXRpY2FsIGRldmljZXMgYW5kIGJyb3dzZXJzLCB3aGljaCBjb3VsZCBsZWFkIHRvIGEgYnJva2VuIGV4cGVyaWVuY2UuCgkJCS8vIFRlc3RpbmcgZml4ZWQgcG9zaXRpb25pbmcgaXMgYWxzbyBwcmV0dHkgb2J0cnVzaXZlIHRvIHBhZ2UgbG9hZCwgcmVxdWlyaW5nIGluamVjdGVkIGVsZW1lbnRzIGFuZCBzY3JvbGxpbmcgdGhlIHdpbmRvdwoJCQkvLyBUaGUgZm9sbG93aW5nIGZ1bmN0aW9uIHNlcnZlcyB0byBydWxlIG91dCBzb21lIHBvcHVsYXIgYnJvd3NlcnMgd2l0aCBrbm93biBmaXhlZC1wb3NpdGlvbmluZyBpc3N1ZXMKCQkJLy8gVGhpcyBpcyBhIHBsdWdpbiBvcHRpb24gbGlrZSBhbnkgb3RoZXIsIHNvIGZlZWwgZnJlZSB0byBpbXByb3ZlIG9yIG92ZXJ3cml0ZSBpdAoJCQlzdXBwb3J0QmxhY2tsaXN0OiBmdW5jdGlvbigpIHsKCQkJCXJldHVybiAhJC5zdXBwb3J0LmZpeGVkUG9zaXRpb247CgkJCX0KCQl9LAoKCQlfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5fc3VwZXIoKTsKCQkJaWYgKCB0aGlzLm9wdGlvbnMucG9zaXRpb24gPT09ICJmaXhlZCIgJiYgIXRoaXMub3B0aW9ucy5zdXBwb3J0QmxhY2tsaXN0KCkgKXsKCQkJCXRoaXMuX21ha2VGaXhlZCgpOwoJCQl9CgkJfSwKCgkJX21ha2VGaXhlZDogZnVuY3Rpb24oKXsKCQkJdGhpcy5lbGVtZW50LmFkZENsYXNzKCAidWktIisgdGhpcy5yb2xlICsiLWZpeGVkIiApOwoJCQl0aGlzLnVwZGF0ZVBhZ2VQYWRkaW5nKCk7CgkJCXRoaXMuX2FkZFRyYW5zaXRpb25DbGFzcygpOwoJCQl0aGlzLl9iaW5kUGFnZUV2ZW50cygpOwoJCQl0aGlzLl9iaW5kVG9nZ2xlSGFuZGxlcnMoKTsKCQkJdGhpcy5fc2V0T3B0aW9ucyggdGhpcy5vcHRpb25zICk7CgkJfSwKCgkJX3NldE9wdGlvbnM6IGZ1bmN0aW9uKCBvICl7CgkJCWlmKCBvLnBvc2l0aW9uID09PSAiZml4ZWQiICYmIHRoaXMub3B0aW9ucy5wb3NpdGlvbiAhPT0gImZpeGVkIiApIHsKCQkJCXRoaXMuX21ha2VGaXhlZCgpOwoJCQl9CgkJCWlmICggdGhpcy5vcHRpb25zLnBvc2l0aW9uID09PSAiZml4ZWQiICYmICF0aGlzLm9wdGlvbnMuc3VwcG9ydEJsYWNrbGlzdCgpICl7CgkJCQl2YXIgJHBhZ2UgPSAoICEhdGhpcy5wYWdlICk/IHRoaXMucGFnZTogKCAkKCIudWktcGFnZS1hY3RpdmUiKS5sZW5ndGggPiAwICk/ICQoIi51aS1wYWdlLWFjdGl2ZSIpOiAkKCIudWktcGFnZSIpLmVxKDApOwoKCQkJCWlmICggby5mdWxsc2NyZWVuICE9PSB1bmRlZmluZWQpewoJCQkJCWlmICggby5mdWxsc2NyZWVuICkgewoJCQkJCQl0aGlzLmVsZW1lbnQuYWRkQ2xhc3MoICJ1aS0iKyB0aGlzLnJvbGUgKyItZnVsbHNjcmVlbiIgKTsKCQkJCQkJJHBhZ2UuYWRkQ2xhc3MoICJ1aS1wYWdlLSIgKyB0aGlzLnJvbGUgKyAiLWZ1bGxzY3JlZW4iICk7CgkJCQkJfQoJCQkJCS8vIElmIG5vdCBmdWxsc2NyZWVuLCBhZGQgY2xhc3MgdG8gcGFnZSB0byBzZXQgdG9wIG9yIGJvdHRvbSBwYWRkaW5nCgkJCQkJZWxzZSB7CgkJCQkJCXRoaXMuZWxlbWVudC5yZW1vdmVDbGFzcyggInVpLSIrIHRoaXMucm9sZSArIi1mdWxsc2NyZWVuIiApOwoJCQkJCQkkcGFnZS5yZW1vdmVDbGFzcyggInVpLXBhZ2UtIiArIHRoaXMucm9sZSArICItZnVsbHNjcmVlbiIgKS5hZGRDbGFzcyggInVpLXBhZ2UtIiArIHRoaXMucm9sZSsgIi1maXhlZCIgKTsKCQkJCQl9CgkJCQl9CgkJCX0KCQkJdGhpcy5fc3VwZXIobyk7CgkJfSwKCgkJX2FkZFRyYW5zaXRpb25DbGFzczogZnVuY3Rpb24oKSB7CgkJCXZhciB0Y2xhc3MgPSB0aGlzLm9wdGlvbnMudHJhbnNpdGlvbjsKCgkJCWlmICggdGNsYXNzICYmIHRjbGFzcyAhPT0gIm5vbmUiICkgewoJCQkJLy8gdXNlIGFwcHJvcHJpYXRlIHNsaWRlIGZvciBoZWFkZXIgb3IgZm9vdGVyCgkJCQlpZiAoIHRjbGFzcyA9PT0gInNsaWRlIiApIHsKCQkJCQl0Y2xhc3MgPSB0aGlzLmVsZW1lbnQuaGFzQ2xhc3MoICJ1aS1oZWFkZXIiICkgPyAic2xpZGVkb3duIiA6ICJzbGlkZXVwIjsKCQkJCX0KCgkJCQl0aGlzLmVsZW1lbnQuYWRkQ2xhc3MoIHRjbGFzcyApOwoJCQl9CgkJfSwKCgkJX2JpbmRQYWdlRXZlbnRzOiBmdW5jdGlvbigpIHsKCQkJdmFyIHBhZ2UgPSAoICEhdGhpcy5wYWdlICk/IHRoaXMuZWxlbWVudC5jbG9zZXN0KCAiLnVpLXBhZ2UiICk6IHRoaXMuZG9jdW1lbnQ7CgkJCS8vcGFnZSBldmVudCBiaW5kaW5ncwoJCQkvLyBGaXhlZCB0b29sYmFycyByZXF1aXJlIHBhZ2Ugem9vbSB0byBiZSBkaXNhYmxlZCwgb3RoZXJ3aXNlIHVzYWJpbGl0eSBpc3N1ZXMgY3JvcCB1cAoJCQkvLyBUaGlzIG1ldGhvZCBpcyBtZWFudCB0byBkaXNhYmxlIHpvb20gd2hpbGUgYSBmaXhlZC1wb3NpdGlvbmVkIHRvb2xiYXIgcGFnZSBpcyB2aXNpYmxlCgkJCXRoaXMuX29uKCBwYWdlICwgewoJCQkJInBhZ2ViZWZvcmVzaG93IjogIl9oYW5kbGVQYWdlQmVmb3JlU2hvdyIsCgkJCQkid2Via2l0QW5pbWF0aW9uU3RhcnQiOiJfaGFuZGxlQW5pbWF0aW9uU3RhcnQiLAoJCQkJImFuaW1hdGlvbnN0YXJ0IjoiX2hhbmRsZUFuaW1hdGlvblN0YXJ0IiwKCQkJCSJ1cGRhdGVsYXlvdXQiOiAiX2hhbmRsZUFuaW1hdGlvblN0YXJ0IiwKCQkJCSJwYWdlc2hvdyI6ICJfaGFuZGxlUGFnZVNob3ciLAoJCQkJInBhZ2ViZWZvcmVoaWRlIjogIl9oYW5kbGVQYWdlQmVmb3JlSGlkZSIKCQkJfSk7CgkJfSwKCgkJX2hhbmRsZVBhZ2VCZWZvcmVTaG93OiBmdW5jdGlvbiggKSB7CgkJCXZhciBvID0gdGhpcy5vcHRpb25zOwoJCQlpZiAoIG8uZGlzYWJsZVBhZ2Vab29tICkgewoJCQkJJC5tb2JpbGUuem9vbS5kaXNhYmxlKCB0cnVlICk7CgkJCX0KCQkJaWYgKCAhby52aXNpYmxlT25QYWdlU2hvdyApIHsKCQkJCXRoaXMuaGlkZSggdHJ1ZSApOwoJCQl9CgkJfSwKCgkJX2hhbmRsZUFuaW1hdGlvblN0YXJ0OiBmdW5jdGlvbigpIHsKCQkJaWYgKCB0aGlzLm9wdGlvbnMudXBkYXRlUGFnZVBhZGRpbmcgKSB7CgkJCQl0aGlzLnVwZGF0ZVBhZ2VQYWRkaW5nKCAoICEhdGhpcy5wYWdlICk/IHRoaXMucGFnZTogIi51aS1wYWdlLWFjdGl2ZSIgKTsKCQkJfQoJCX0sCgoJCV9oYW5kbGVQYWdlU2hvdzogZnVuY3Rpb24oKSB7CgkJCXRoaXMudXBkYXRlUGFnZVBhZGRpbmcoICggISF0aGlzLnBhZ2UgKT8gdGhpcy5wYWdlOiAiLnVpLXBhZ2UtYWN0aXZlIiApOwoJCQlpZiAoIHRoaXMub3B0aW9ucy51cGRhdGVQYWdlUGFkZGluZyApIHsKCQkJCXRoaXMuX29uKCB0aGlzLndpbmRvdywgeyAidGhyb3R0bGVkcmVzaXplIjogInVwZGF0ZVBhZ2VQYWRkaW5nIiB9ICk7CgkJCX0KCQl9LAoKCQlfaGFuZGxlUGFnZUJlZm9yZUhpZGU6IGZ1bmN0aW9uKCBlLCB1aSApIHsKCQkJdmFyIG8gPSB0aGlzLm9wdGlvbnMsCgkJCQl0aGlzRm9vdGVyLCB0aGlzSGVhZGVyLCBuZXh0Rm9vdGVyLCBuZXh0SGVhZGVyOwoKCgkJCWlmICggby5kaXNhYmxlUGFnZVpvb20gKSB7CgkJCQkkLm1vYmlsZS56b29tLmVuYWJsZSggdHJ1ZSApOwoJCQl9CgkJCWlmICggby51cGRhdGVQYWdlUGFkZGluZyApIHsKCQkJCXRoaXMuX29mZiggdGhpcy53aW5kb3csICJ0aHJvdHRsZWRyZXNpemUiICk7CgkJCX0KCgkJCWlmICggby50cmFja1BlcnNpc3RlbnRUb29sYmFycyApIHsKCQkJCXRoaXNGb290ZXIgPSAkKCAiLnVpLWZvb3Rlci1maXhlZDpqcW1EYXRhKGlkKSIsIHRoaXMucGFnZSApOwoJCQkJdGhpc0hlYWRlciA9ICQoICIudWktaGVhZGVyLWZpeGVkOmpxbURhdGEoaWQpIiwgdGhpcy5wYWdlICk7CgkJCQluZXh0Rm9vdGVyID0gdGhpc0Zvb3Rlci5sZW5ndGggJiYgdWkubmV4dFBhZ2UgJiYgJCggIi51aS1mb290ZXItZml4ZWQ6anFtRGF0YShpZD0nIiArIHRoaXNGb290ZXIuanFtRGF0YSggImlkIiApICsgIicpIiwgdWkubmV4dFBhZ2UgKSB8fCAkKCk7CgkJCQluZXh0SGVhZGVyID0gdGhpc0hlYWRlci5sZW5ndGggJiYgdWkubmV4dFBhZ2UgJiYgJCggIi51aS1oZWFkZXItZml4ZWQ6anFtRGF0YShpZD0nIiArIHRoaXNIZWFkZXIuanFtRGF0YSggImlkIiApICsgIicpIiwgdWkubmV4dFBhZ2UgKSB8fCAkKCk7CgoJCQkJaWYgKCBuZXh0Rm9vdGVyLmxlbmd0aCB8fCBuZXh0SGVhZGVyLmxlbmd0aCApIHsKCgkJCQkJbmV4dEZvb3Rlci5hZGQoIG5leHRIZWFkZXIgKS5hcHBlbmRUbyggJC5tb2JpbGUucGFnZUNvbnRhaW5lciApOwoKCQkJCQl1aS5uZXh0UGFnZS5vbmUoICJwYWdlc2hvdyIsIGZ1bmN0aW9uKCkgewoJCQkJCQluZXh0SGVhZGVyLnByZXBlbmRUbyggdGhpcyApOwoJCQkJCQluZXh0Rm9vdGVyLmFwcGVuZFRvKCB0aGlzICk7CgkJCQkJfSk7CgkJCQl9CgkJCX0KCQl9LAoKCQlfdmlzaWJsZTogdHJ1ZSwKCgkJLy8gVGhpcyB3aWxsIHNldCB0aGUgY29udGVudCBlbGVtZW50J3MgdG9wIG9yIGJvdHRvbSBwYWRkaW5nIGVxdWFsIHRvIHRoZSB0b29sYmFyJ3MgaGVpZ2h0CgkJdXBkYXRlUGFnZVBhZGRpbmc6IGZ1bmN0aW9uKCB0YlBhZ2UgKSB7CgkJCXZhciAkZWwgPSB0aGlzLmVsZW1lbnQsCgkJCQloZWFkZXIgPSAoIHRoaXMucm9sZSA9PT0iaGVhZGVyIiApLAoJCQkJcG9zID0gcGFyc2VGbG9hdCggJGVsLmNzcyggaGVhZGVyID8gInRvcCIgOiAiYm90dG9tIiApICk7CgoJCQkvLyBUaGlzIGJlaGF2aW9yIG9ubHkgYXBwbGllcyB0byAiZml4ZWQiLCBub3QgImZ1bGxzY3JlZW4iCgkJCWlmICggdGhpcy5vcHRpb25zLmZ1bGxzY3JlZW4gKSB7IHJldHVybjsgfQoJCQkvLyB0YlBhZ2UgYXJndW1lbnQgY2FuIGJlIGEgUGFnZSBvYmplY3Qgb3IgYW4gZXZlbnQsIGlmIGNvbWluZyBmcm9tIHRocm90dGxlZCByZXNpemUuCgkJCXRiUGFnZSA9ICggdGJQYWdlICYmIHRiUGFnZS50eXBlID09PSB1bmRlZmluZWQgJiYgdGJQYWdlICkgfHwgdGhpcy5wYWdlIHx8ICRlbC5jbG9zZXN0KCAiLnVpLXBhZ2UiICk7CgkJCXRiUGFnZSA9ICggISF0aGlzLnBhZ2UgKT8gdGhpcy5wYWdlOiAiLnVpLXBhZ2UtYWN0aXZlIjsKCQkJJCggdGJQYWdlICkuY3NzKCAicGFkZGluZy0iICsgKCBoZWFkZXIgPyAidG9wIiA6ICJib3R0b20iICksICRlbC5vdXRlckhlaWdodCgpICsgcG9zICk7CgkJfSwKCgkJX3VzZVRyYW5zaXRpb246IGZ1bmN0aW9uKCBub3RyYW5zaXRpb24gKSB7CgkJCXZhciAkd2luID0gdGhpcy53aW5kb3csCgkJCQkkZWwgPSB0aGlzLmVsZW1lbnQsCgkJCQlzY3JvbGwgPSAkd2luLnNjcm9sbFRvcCgpLAoJCQkJZWxIZWlnaHQgPSAkZWwuaGVpZ2h0KCksCgkJCQlwSGVpZ2h0ID0gKCAhIXRoaXMucGFnZSApPyAkZWwuY2xvc2VzdCggIi51aS1wYWdlIiApLmhlaWdodCgpOiQoIi51aS1wYWdlLWFjdGl2ZSIpLmhlaWdodCgpLAoJCQkJdmlld3BvcnRIZWlnaHQgPSAkLm1vYmlsZS5nZXRTY3JlZW5IZWlnaHQoKTsKCgkJCXJldHVybiAhbm90cmFuc2l0aW9uICYmCgkJCQkoIHRoaXMub3B0aW9ucy50cmFuc2l0aW9uICYmIHRoaXMub3B0aW9ucy50cmFuc2l0aW9uICE9PSAibm9uZSIgJiYKCQkJCSgKCQkJCQkoIHRoaXMucm9sZSA9PT0gImhlYWRlciIgJiYgIXRoaXMub3B0aW9ucy5mdWxsc2NyZWVuICYmIHNjcm9sbCA+IGVsSGVpZ2h0ICkgfHwKCQkJCQkoIHRoaXMucm9sZSA9PT0gImZvb3RlciIgJiYgIXRoaXMub3B0aW9ucy5mdWxsc2NyZWVuICYmIHNjcm9sbCArIHZpZXdwb3J0SGVpZ2h0IDwgcEhlaWdodCAtIGVsSGVpZ2h0ICkKCQkJCSkgfHwgdGhpcy5vcHRpb25zLmZ1bGxzY3JlZW4KCQkJCSk7CgkJfSwKCgkJc2hvdzogZnVuY3Rpb24oIG5vdHJhbnNpdGlvbiApIHsKCQkJdmFyIGhpZGVDbGFzcyA9ICJ1aS1maXhlZC1oaWRkZW4iLAoJCQkJJGVsID0gdGhpcy5lbGVtZW50OwoKCQkJaWYgKCB0aGlzLl91c2VUcmFuc2l0aW9uKCBub3RyYW5zaXRpb24gKSApIHsKCQkJCSRlbAoJCQkJCS5yZW1vdmVDbGFzcyggIm91dCAiICsgaGlkZUNsYXNzICkKCQkJCQkuYWRkQ2xhc3MoICJpbiIgKQoJCQkJCS5hbmltYXRpb25Db21wbGV0ZShmdW5jdGlvbiAoKSB7CgkJCQkJCSRlbC5yZW1vdmVDbGFzcyggImluIiApOwoJCQkJCX0pOwoJCQl9CgkJCWVsc2UgewoJCQkJJGVsLnJlbW92ZUNsYXNzKCBoaWRlQ2xhc3MgKTsKCQkJfQoJCQl0aGlzLl92aXNpYmxlID0gdHJ1ZTsKCQl9LAoKCQloaWRlOiBmdW5jdGlvbiggbm90cmFuc2l0aW9uICkgewoJCQl2YXIgaGlkZUNsYXNzID0gInVpLWZpeGVkLWhpZGRlbiIsCgkJCQkkZWwgPSB0aGlzLmVsZW1lbnQsCgkJCQkvLyBpZiBpdCdzIGEgc2xpZGUgdHJhbnNpdGlvbiwgb3VyIG5ldyB0cmFuc2l0aW9ucyBuZWVkIHRoZSByZXZlcnNlIGNsYXNzIGFzIHdlbGwgdG8gc2xpZGUgb3V0d2FyZAoJCQkJb3V0Y2xhc3MgPSAib3V0IiArICggdGhpcy5vcHRpb25zLnRyYW5zaXRpb24gPT09ICJzbGlkZSIgPyAiIHJldmVyc2UiIDogIiIgKTsKCgkJCWlmICggdGhpcy5fdXNlVHJhbnNpdGlvbiggbm90cmFuc2l0aW9uICkgKSB7CgkJCQkkZWwKCQkJCQkuYWRkQ2xhc3MoIG91dGNsYXNzICkKCQkJCQkucmVtb3ZlQ2xhc3MoICJpbiIgKQoJCQkJCS5hbmltYXRpb25Db21wbGV0ZShmdW5jdGlvbigpIHsKCQkJCQkJJGVsLmFkZENsYXNzKCBoaWRlQ2xhc3MgKS5yZW1vdmVDbGFzcyggb3V0Y2xhc3MgKTsKCQkJCQl9KTsKCQkJfQoJCQllbHNlIHsKCQkJCSRlbC5hZGRDbGFzcyggaGlkZUNsYXNzICkucmVtb3ZlQ2xhc3MoIG91dGNsYXNzICk7CgkJCX0KCQkJdGhpcy5fdmlzaWJsZSA9IGZhbHNlOwoJCX0sCgoJCXRvZ2dsZTogZnVuY3Rpb24oKSB7CgkJCXRoaXNbIHRoaXMuX3Zpc2libGUgPyAiaGlkZSIgOiAic2hvdyIgXSgpOwoJCX0sCgoJCV9iaW5kVG9nZ2xlSGFuZGxlcnM6IGZ1bmN0aW9uKCkgewoJCQl2YXIgc2VsZiA9IHRoaXMsCgkJCQlvID0gc2VsZi5vcHRpb25zLAoJCQkJZGVsYXlTaG93LCBkZWxheUhpZGUsCgkJCQlpc1Zpc2libGUgPSB0cnVlLAoJCQkJcGFnZSA9ICggISF0aGlzLnBhZ2UgKT8gdGhpcy5wYWdlOiAkKCIudWktcGFnZSIpOwoKCQkJLy8gdGFwIHRvZ2dsZQoJCQlwYWdlCgkJCQkuYmluZCggInZjbGljayIsIGZ1bmN0aW9uKCBlICkgewoJCQkJCWlmICggby50YXBUb2dnbGUgJiYgISQoIGUudGFyZ2V0ICkuY2xvc2VzdCggby50YXBUb2dnbGVCbGFja2xpc3QgKS5sZW5ndGggKSB7CgkJCQkJCXNlbGYudG9nZ2xlKCk7CgkJCQkJfQoJCQkJfSkKCQkJCS5iaW5kKCAiZm9jdXNpbiBmb2N1c291dCIsIGZ1bmN0aW9uKCBlICkgewoJCQkJCS8vdGhpcyBoaWRlcyB0aGUgdG9vbGJhcnMgb24gYSBrZXlib2FyZCBwb3AgdG8gZ2l2ZSBtb3JlIHNjcmVlbiByb29tIGFuZCBwcmV2ZW50IGlvcyBidWcgd2hpY2gKCQkJCQkvL3Bvc2l0aW9ucyBmaXhlZCB0b29sYmFycyBpbiB0aGUgbWlkZGxlIG9mIHRoZSBzY3JlZW4gb24gcG9wIGlmIHRoZSBpbnB1dCBpcyBuZWFyIHRoZSB0b3Agb3IKCQkJCQkvL2JvdHRvbSBvZiB0aGUgc2NyZWVuIGFkZHJlc3NlcyBpc3N1ZXMgIzQ0MTAgRm9vdGVyIG5hdmJhciBtb3ZlcyB1cCB3aGVuIGNsaWNraW5nIG9uIGEgdGV4dGJveCBpbiBhbiBBbmRyb2lkIGVudmlyb25tZW50CgkJCQkJLy9hbmQgaXNzdWUgIzQxMTMgSGVhZGVyIGFuZCBmb290ZXIgY2hhbmdlIHRoZWlyIHBvc2l0aW9uIGFmdGVyIGtleWJvYXJkIHBvcHVwIC0gaU9TCgkJCQkJLy9hbmQgaXNzdWUgIzQ0MTAgRm9vdGVyIG5hdmJhciBtb3ZlcyB1cCB3aGVuIGNsaWNraW5nIG9uIGEgdGV4dGJveCBpbiBhbiBBbmRyb2lkIGVudmlyb25tZW50CgkJCQkJaWYgKCBzY3JlZW4ud2lkdGggPCAxMDI1ICYmICQoIGUudGFyZ2V0ICkuaXMoIG8uaGlkZUR1cmluZ0ZvY3VzICkgJiYgISQoIGUudGFyZ2V0ICkuY2xvc2VzdCggIi51aS1oZWFkZXItZml4ZWQsIC51aS1mb290ZXItZml4ZWQiICkubGVuZ3RoICkgewoJCQkJCQkvL0ZpeCBmb3IgaXNzdWUgIzQ3MjQgTW92aW5nIHRocm91Z2ggZm9ybSBpbiBNb2JpbGUgU2FmYXJpIHdpdGggIk5leHQiIGFuZCAiUHJldmlvdXMiIHN5c3RlbQoJCQkJCQkvL2NvbnRyb2xzIGNhdXNlcyBmaXhlZCBwb3NpdGlvbiwgdGFwLXRvZ2dsZSBmYWxzZSBIZWFkZXIgdG8gcmV2ZWFsIGl0c2VsZgoJCQkJCQkvLyBpc1Zpc2libGUgaW5zdGVhZCBvZiBzZWxmLl92aXNpYmxlIGJlY2F1c2UgdGhlIGZvY3VzaW4gYW5kIGZvY3Vzb3V0IGV2ZW50cyBmaXJlIHR3aWNlIGF0IHRoZSBzYW1lIHRpbWUKCQkJCQkJLy8gQWxzbyB1c2UgYSBkZWxheSBmb3IgaGlkaW5nIHRoZSB0b29sYmFycyBiZWNhdXNlIG9uIEFuZHJvaWQgbmF0aXZlIGJyb3dzZXIgZm9jdXNpbiBpcyBkaXJlY2x0eSBmb2xsb3dlZAoJCQkJCQkvLyBieSBhIGZvY3Vzb3V0IHdoZW4gYSBuYXRpdmUgc2VsZWN0cyBvcGVucyBhbmQgdGhlIG90aGVyIHdheSBhcm91bmQgd2hlbiBpdCBjbG9zZXMuCgkJCQkJCWlmICggZS50eXBlID09PSAiZm9jdXNvdXQiICYmICFpc1Zpc2libGUgKSB7CgkJCQkJCQlpc1Zpc2libGUgPSB0cnVlOwoJCQkJCQkJLy93YWl0IGZvciB0aGUgc3RhY2sgdG8gdW53aW5kIGFuZCBzZWUgaWYgd2UgaGF2ZSBqdW1wZWQgdG8gYW5vdGhlciBpbnB1dAoJCQkJCQkJY2xlYXJUaW1lb3V0KCBkZWxheUhpZGUgKTsKCQkJCQkJCWRlbGF5U2hvdyA9IHNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCQkJCQkJCXNlbGYuc2hvdygpOwoJCQkJCQkJfSwgMCApOwoJCQkJCQl9IGVsc2UgaWYgKCBlLnR5cGUgPT09ICJmb2N1c2luIiAmJiAhIWlzVmlzaWJsZSApIHsKCQkJCQkJCS8vaWYgd2UgaGF2ZSBqdW1wZWQgdG8gYW5vdGhlciBpbnB1dCBjbGVhciB0aGUgdGltZSBvdXQgdG8gY2FuY2VsIHRoZSBzaG93LgoJCQkJCQkJY2xlYXJUaW1lb3V0KCBkZWxheVNob3cgKTsKCQkJCQkJCWlzVmlzaWJsZSA9IGZhbHNlOwoJCQkJCQkJZGVsYXlIaWRlID0gc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQkJCQkJc2VsZi5oaWRlKCk7CgkJCQkJCQl9LCAwICk7CgkJCQkJCX0KCQkJCQl9CgkJCQl9KTsKCQl9LAoKCQlfZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJCXZhciAkZWwgPSB0aGlzLmVsZW1lbnQsCgkJCQloZWFkZXIgPSAkZWwuaGFzQ2xhc3MoICJ1aS1oZWFkZXIiICk7CgoJCQkkZWwuY2xvc2VzdCggIi51aS1wYWdlIiApLmNzcyggInBhZGRpbmctIiArICggaGVhZGVyID8gInRvcCIgOiAiYm90dG9tIiApLCAiIiApOwoJCQkkZWwucmVtb3ZlQ2xhc3MoICJ1aS1oZWFkZXItZml4ZWQgdWktZm9vdGVyLWZpeGVkIHVpLWhlYWRlci1mdWxsc2NyZWVuIHVpLWZvb3Rlci1mdWxsc2NyZWVuIGluIG91dCBmYWRlIHNsaWRlZG93biBzbGlkZXVwIHVpLWZpeGVkLWhpZGRlbiIgKTsKCQkJJGVsLmNsb3Nlc3QoICIudWktcGFnZSIgKS5yZW1vdmVDbGFzcyggInVpLXBhZ2UtaGVhZGVyLWZpeGVkIHVpLXBhZ2UtZm9vdGVyLWZpeGVkIHVpLXBhZ2UtaGVhZGVyLWZ1bGxzY3JlZW4gdWktcGFnZS1mb290ZXItZnVsbHNjcmVlbiIgKTsKCQl9CgoJfSk7Cn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoJJC53aWRnZXQoICJtb2JpbGUudG9vbGJhciIsICQubW9iaWxlLnRvb2xiYXIsIHsKCgkJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJCXRoaXMuX3N1cGVyKCk7CgkJfSwKCgkJX21ha2VGaXhlZDogZnVuY3Rpb24oKSB7CgkJCXRoaXMuX3N1cGVyKCk7CgkJCXRoaXMuX3dvcmthcm91bmRzKCk7CgkJfSwKCgkJLy9jaGVjayB0aGUgYnJvd3NlciBhbmQgdmVyc2lvbiBhbmQgcnVuIG5lZWRlZCB3b3JrYXJvdW5kcwoJCV93b3JrYXJvdW5kczogZnVuY3Rpb24oKSB7CgkJCXZhciB1YSA9IG5hdmlnYXRvci51c2VyQWdlbnQsCgkJCXBsYXRmb3JtID0gbmF2aWdhdG9yLnBsYXRmb3JtLAoJCQkvLyBSZW5kZXJpbmcgZW5naW5lIGlzIFdlYmtpdCwgYW5kIGNhcHR1cmUgbWFqb3IgdmVyc2lvbgoJCQl3a21hdGNoID0gdWEubWF0Y2goIC9BcHBsZVdlYktpdFwvKFswLTldKykvICksCgkJCXdrdmVyc2lvbiA9ICEhd2ttYXRjaCAmJiB3a21hdGNoWyAxIF0sCgkJCW9zID0gbnVsbCwKCQkJc2VsZiA9IHRoaXM7CgkJCS8vc2V0IHRoZSBvcyB3ZSBhcmUgd29ya2luZyBpbiBpZiBpdCBkb3NlbnQgbWF0Y2ggb25lIHdpdGggd29ya2Fyb3VuZHMgcmV0dXJuCgkJCWlmICggcGxhdGZvcm0uaW5kZXhPZiggImlQaG9uZSIgKSA+IC0xIHx8IHBsYXRmb3JtLmluZGV4T2YoICJpUGFkIiApID4gLTEgIHx8IHBsYXRmb3JtLmluZGV4T2YoICJpUG9kIiApID4gLTEgKSB7CgkJCQlvcyA9ICJpb3MiOwoJCQl9IGVsc2UgaWYgKCB1YS5pbmRleE9mKCAiQW5kcm9pZCIgKSA+IC0xICkgewoJCQkJb3MgPSAiYW5kcm9pZCI7CgkJCX0gZWxzZSB7CgkJCQlyZXR1cm47CgkJCX0KCQkJLy9jaGVjayBvcyB2ZXJzaW9uIGlmIGl0IGRvc2VudCBtYXRjaCBvbmUgd2l0aCB3b3JrYXJvdW5kcyByZXR1cm4KCQkJaWYgKCBvcyA9PT0gImlvcyIgKSB7CgkJCQkvL2lPUyAgd29ya2Fyb3VuZHMKCQkJCXNlbGYuX2JpbmRTY3JvbGxXb3JrYXJvdW5kKCk7CgkJCX0gZWxzZSBpZiAoIG9zID09PSAiYW5kcm9pZCIgJiYgd2t2ZXJzaW9uICYmIHdrdmVyc2lvbiA8IDUzNCApIHsKCQkJCS8vQW5kcm9pZCAyLjMgcnVuIGFsbCBBbmRyb2lkIDIuMyB3b3JrYXJvdW5kCgkJCQlzZWxmLl9iaW5kU2Nyb2xsV29ya2Fyb3VuZCgpOwoJCQkJc2VsZi5fYmluZExpc3RUaHVtYldvcmthcm91bmQoKTsKCQkJfSBlbHNlIHsKCQkJCXJldHVybjsKCQkJfQoJCX0sCgoJCS8vVXRpbGl0eSBjbGFzcyBmb3IgY2hlY2tpbmcgaGVhZGVyIGFuZCBmb290ZXIgcG9zaXRpb25zIHJlbGF0aXZlIHRvIHZpZXdwb3J0CgkJX3ZpZXdwb3J0T2Zmc2V0OiBmdW5jdGlvbigpIHsKCQkJdmFyICRlbCA9IHRoaXMuZWxlbWVudCwKCQkJCWhlYWRlciA9ICRlbC5oYXNDbGFzcyggInVpLWhlYWRlciIgKSwKCQkJCW9mZnNldCA9IE1hdGguYWJzKCAkZWwub2Zmc2V0KCkudG9wIC0gdGhpcy53aW5kb3cuc2Nyb2xsVG9wKCkgKTsKCQkJaWYgKCAhaGVhZGVyICkgewoJCQkJb2Zmc2V0ID0gTWF0aC5yb3VuZCggb2Zmc2V0IC0gdGhpcy53aW5kb3cuaGVpZ2h0KCkgKyAkZWwub3V0ZXJIZWlnaHQoKSApIC0gNjA7CgkJCX0KCQkJcmV0dXJuIG9mZnNldDsKCQl9LAoKCQkvL2JpbmQgZXZlbnRzIGZvciBfdHJpZ2dlclJlZHJhdygpIGZ1bmN0aW9uCgkJX2JpbmRTY3JvbGxXb3JrYXJvdW5kOiBmdW5jdGlvbigpIHsKCQkJdmFyIHNlbGYgPSB0aGlzOwoJCQkvL2JpbmQgdG8gc2Nyb2xsc3RvcCBhbmQgY2hlY2sgaWYgdGhlIHRvb2xiYXJzIGFyZSBjb3JyZWN0bHkgcG9zaXRpb25lZAoJCQl0aGlzLl9vbiggdGhpcy53aW5kb3csIHsgc2Nyb2xsc3RvcDogZnVuY3Rpb24oKSB7CgkJCQl2YXIgdmlld3BvcnRPZmZzZXQgPSBzZWxmLl92aWV3cG9ydE9mZnNldCgpOwoJCQkJLy9jaGVjayBpZiB0aGUgaGVhZGVyIGlzIHZpc2libGUgYW5kIGlmIGl0cyBpbiB0aGUgcmlnaHQgcGxhY2UKCQkJCWlmICggdmlld3BvcnRPZmZzZXQgPiAyICYmIHNlbGYuX3Zpc2libGUgKSB7CgkJCQkJc2VsZi5fdHJpZ2dlclJlZHJhdygpOwoJCQkJfQoJCQl9fSk7CgkJfSwKCgkJLy90aGlzIGFkZHJlc3NlcyBpc3N1ZSAjNDI1MCBQZXJzaXN0ZW50IGZvb3RlciBpbnN0YWJpbGl0eSBpbiB2MS4xIHdpdGggbG9uZyBzZWxlY3QgbGlzdHMgaW4gQW5kcm9pZCAyLjMuMwoJCS8vYW5kIGlzc3VlICMzNzQ4IEFuZHJvaWQgMi54OiBQYWdlIHRyYW5zaXRpb25zIGJyb2tlbiB3aGVuIGZpeGVkIHRvb2xiYXJzIHVzZWQKCQkvL3RoZSBhYnNvbHV0ZWx5IHBvc2l0aW9uZWQgdGh1bWJuYWlsIGluIGEgbGlzdCB2aWV3IGNhdXNlcyBwcm9ibGVtcyB3aXRoIGZpeGVkIHBvc2l0aW9uIGJ1dHRvbnMgYWJvdmUgaW4gYSBuYXYgYmFyCgkJLy9zZXR0aW5nIHRoZSBsaSdzIHRvIC13ZWJraXQtdHJhbnNmb3JtOnRyYW5zbGF0ZTNkKDAsMCwwKTsgc29sdmVzIHRoaXMgcHJvYmxlbSB0byBhdm9pZGUgcG90ZW50aWFsIGlzc3VlcyBpbiBvdGhlcgoJCS8vcGxhdGZvcm1zIHdlIHNjb3BlIHRoaXMgd2l0aCB0aGUgY2xhc3MgdWktYW5kcm9pZC0yeC1maXgKCQlfYmluZExpc3RUaHVtYldvcmthcm91bmQ6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLmVsZW1lbnQuY2xvc2VzdCggIi51aS1wYWdlIiApLmFkZENsYXNzKCAidWktYW5kcm9pZC0yeC1maXhlZCIgKTsKCQl9LAoJCS8vdGhpcyBhZGRyZXNzZXMgaXNzdWVzICM0MzM3IEZpeGVkIGhlYWRlciBwcm9ibGVtIGFmdGVyIHNjcm9sbGluZyBjb250ZW50IG9uIGlPUyBhbmQgQW5kcm9pZAoJCS8vYW5kIGRldmljZSBidWdzIHByb2plY3QgaXNzdWUgIzEgRm9ybSBlbGVtZW50cyBjYW4gbG9zZSBjbGljayBoaXQgYXJlYSBpbiBwb3NpdGlvbjogZml4ZWQgY29udGFpbmVycy4KCQkvL3RoaXMgYWxzbyBhZGRyZXNzZXMgbm90IG9uIGZpeGVkIHRvb2xiYXJzIHBhZ2UgaW4gZG9jcwoJCS8vYWRkaW5nIDFweCBvZiBwYWRkaW5nIHRvIHRoZSBib3R0b20gdGhlbiByZW1vdmluZyBpdCBjYXVzZXMgYSAicmVkcmF3IgoJCS8vd2hpY2ggcG9zaXRpb25zIHRoZSB0b29sYmFycyBjb3JyZWN0bHkgKHRoZXkgd2lsbCBhbHdheXMgYmUgdmlzdWFsbHkgY29ycmVjdCkKCQlfdHJpZ2dlclJlZHJhdzogZnVuY3Rpb24oKSB7CgkJCXZhciBwYWRkaW5nQm90dG9tID0gcGFyc2VGbG9hdCggJCggIi51aS1wYWdlLWFjdGl2ZSIgKS5jc3MoICJwYWRkaW5nLWJvdHRvbSIgKSApOwoJCQkvL3RyaWdnZXIgcGFnZSByZWRyYXcgdG8gZml4IGluY29ycmVjdGx5IHBvc2l0aW9uZWQgZml4ZWQgZWxlbWVudHMKCQkJJCggIi51aS1wYWdlLWFjdGl2ZSIgKS5jc3MoICJwYWRkaW5nLWJvdHRvbSIsICggcGFkZGluZ0JvdHRvbSArIDEgKSArICJweCIgKTsKCQkJLy9pZiB0aGUgcGFkZGluZyBpcyByZXNldCB3aXRoIG91dCBhIHRpbWVvdXQgdGhlIHJlcG9zaXRpb24gd2lsbCBub3Qgb2NjdXJlLgoJCQkvL3RoaXMgaXMgaW5kZXBlbmRhbnQgb2YgSlFNIHRoZSBicm93c2VyIHNlZW1zIHRvIG5lZWQgdGhlIHRpbWUgdG8gcmVhY3QuCgkJCXNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCQkJJCggIi51aS1wYWdlLWFjdGl2ZSIgKS5jc3MoICJwYWRkaW5nLWJvdHRvbSIsIHBhZGRpbmdCb3R0b20gKyAicHgiICk7CgkJCX0sIDAgKTsKCQl9LAoKCQlkZXN0cm95OiBmdW5jdGlvbigpIHsKCQkJdGhpcy5fc3VwZXIoKTsKCQkJLy9SZW1vdmUgdGhlIGNsYXNzIHdlIGFkZGVkIHRvIHRoZSBwYWdlIHByZXZpb3VzbHkgaW4gYW5kcm9pZCAyLngKCQkJdGhpcy5lbGVtZW50LmNsb3Nlc3QoICIudWktcGFnZS1hY3RpdmUiICkucmVtb3ZlQ2xhc3MoICJ1aS1hbmRyb2lkLTJ4LWZpeCIgKTsKCQl9Cgl9KTsKCn0pKCBqUXVlcnkgKTsKCgooIGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7Cgp2YXIgaWVIYWNrID0gKCAkLm1vYmlsZS5icm93c2VyLm9sZElFICYmICQubW9iaWxlLmJyb3dzZXIub2xkSUUgPD0gOCApLAoJdWlUZW1wbGF0ZSA9ICQoCgkJIjxkaXYgY2xhc3M9J3VpLXBvcHVwLWFycm93LWd1aWRlJz48L2Rpdj4iICsKCQkiPGRpdiBjbGFzcz0ndWktcG9wdXAtYXJyb3ctY29udGFpbmVyIiArICggaWVIYWNrID8gIiBpZSIgOiAiIiApICsgIic+IiArCgkJCSI8ZGl2IGNsYXNzPSd1aS1wb3B1cC1hcnJvdyc+IiArCgkJCQkiPGRpdiBjbGFzcz0ndWktcG9wdXAtYXJyb3ctYmFja2dyb3VuZCc+PC9kaXY+IiArCgkJCSI8L2Rpdj4iICsKCQkiPC9kaXY+IgoJKSwKCS8vIE5lZWRlZCBmb3IgdHJhbnNmb3JtaW5nIGNvb3JkaW5hdGVzIGZyb20gc2NyZWVuIHRvIGFycm93IGJhY2tncm91bmQKCXR4RmFjdG9yID0gTWF0aC5zcXJ0KCAyICkgLyAyOwoKZnVuY3Rpb24gZ2V0QXJyb3coKSB7Cgl2YXIgY2xvbmUgPSB1aVRlbXBsYXRlLmNsb25lKCksCgkJZ2QgPSBjbG9uZS5lcSggMCApLAoJCWN0ID0gY2xvbmUuZXEoIDEgKSwKCQlhciA9IGN0LmNoaWxkcmVuKCksCgkJYmcgPSBhci5jaGlsZHJlbigpOwoKCXJldHVybiB7IGFyRWxzOiBjdC5hZGQoIGdkICksIGdkOiBnZCwgY3Q6IGN0LCBhcjogYXIsIGJnOiBiZyB9Owp9CgokLndpZGdldCggIm1vYmlsZS5wb3B1cCIsICQubW9iaWxlLnBvcHVwLCB7CglvcHRpb25zOiB7CgoJCWFycm93OiAiIgoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl2YXIgYXIsCgkJCXJldCA9IHRoaXMuX3N1cGVyKCk7CgoJCWlmICggdGhpcy5vcHRpb25zLmFycm93ICkgewoJCQl0aGlzLl91aS5hcnJvdyA9IGFyID0gdGhpcy5fYWRkQXJyb3coKTsKCQl9CgoJCXJldHVybiByZXQ7Cgl9LAoKCV9hZGRBcnJvdzogZnVuY3Rpb24oKSB7CgkJdmFyIHRoZW1lLAoJCQlvcHRzID0gdGhpcy5vcHRpb25zLAoJCQlhciA9IGdldEFycm93KCk7CgoJCXRoZW1lID0gdGhpcy5fdGhlbWVDbGFzc0Zyb21PcHRpb24oICJ1aS1ib2R5LSIsIG9wdHMudGhlbWUgKTsKCQlhci5hci5hZGRDbGFzcyggdGhlbWUgKyAoIG9wdHMuc2hhZG93ID8gIiB1aS1vdmVybGF5LXNoYWRvdyIgOiAiIiApICk7CgkJYXIuYmcuYWRkQ2xhc3MoIHRoZW1lICk7CgkJYXIuYXJFbHMuaGlkZSgpLmFwcGVuZFRvKCB0aGlzLmVsZW1lbnQgKTsKCgkJcmV0dXJuIGFyOwoJfSwKCglfdW5lbmhhbmNlOiBmdW5jdGlvbigpIHsKCQl2YXIgYXIgPSB0aGlzLl91aS5hcnJvdzsKCgkJaWYgKCBhciApIHsKCQkJYXIuYXJFbHMucmVtb3ZlKCk7CgkJfQoKCQlyZXR1cm4gdGhpcy5fc3VwZXIoKTsKCX0sCgoJLy8gUHJldGVuZCB0byBzaG93IGFuIGFycm93IGRlc2NyaWJlZCBieSBAcCBhbmQgQGRpciBhbmQgY2FsY3VsYXRlIHRoZQoJLy8gZGlzdGFuY2UgZnJvbSB0aGUgZGVzaXJlZCBwb2ludC4gSWYgYSBiZXN0LWRpc3RhbmNlIGlzIHBhc3NlZCBpbiwgcmV0dXJuCgkvLyB0aGUgbWluaW11bSBvZiB0aGUgb25lIHBhc3NlZCBpbiBhbmQgdGhlIG9uZSBjYWxjdWxhdGVkLgoJX3RyeUFuQXJyb3c6IGZ1bmN0aW9uKCBwLCBkaXIsIGRlc2lyZWQsIHMsIGJlc3QgKSB7CgkJdmFyIHJlc3VsdCwgciwgZGlmZiwgZGVzaXJlZEZvckFycm93ID0ge30sIHRpcCA9IHt9OwoKCQkvLyBJZiB0aGUgYXJyb3cgaGFzIG5vIHdpZ2dsZSByb29tIGFsb25nIHRoZSBlZGdlIG9mIHRoZSBwb3B1cCwgaXQgY2Fubm90CgkJLy8gYmUgZGlzcGxheWVkIGFsb25nIHRoZSByZXF1ZXN0ZWQgZWRnZSB3aXRob3V0IGl0IHN0aWNraW5nIG91dC4KCQlpZiAoIHMuYXJGdWxsWyBwLmRpbUtleSBdID4gcy5ndWlkZURpbXNbIHAuZGltS2V5IF0gKSB7CgkJCXJldHVybiBiZXN0OwoJCX0KCgkJZGVzaXJlZEZvckFycm93WyBwLmZzdCBdID0gZGVzaXJlZFsgcC5mc3QgXSArCgkJCSggcy5hckhhbGZbIHAub0RpbUtleSBdICsgcy5tZW51SGFsZlsgcC5vRGltS2V5IF0gKSAqIHAub2Zmc2V0RmFjdG9yIC0KCQkJcy5jb250ZW50Qm94WyBwLmZzdCBdICsgKCBzLmNsYW1wSW5mby5tZW51U2l6ZVsgcC5vRGltS2V5IF0gLSBzLmNvbnRlbnRCb3hbIHAub0RpbUtleSBdICkgKiBwLmFycm93T2Zmc2V0RmFjdG9yOwoJCWRlc2lyZWRGb3JBcnJvd1sgcC5zbmQgXSA9IGRlc2lyZWRbIHAuc25kIF07CgoJCXJlc3VsdCA9IHMucmVzdWx0IHx8IHRoaXMuX2NhbGN1bGF0ZUZpbmFsTG9jYXRpb24oIGRlc2lyZWRGb3JBcnJvdywgcy5jbGFtcEluZm8gKTsKCQlyID0geyB4OiByZXN1bHQubGVmdCwgeTogcmVzdWx0LnRvcCB9OwoKCQl0aXBbIHAuZnN0IF0gPSByWyBwLmZzdCBdICsgcy5jb250ZW50Qm94WyBwLmZzdCBdICsgcC50aXBPZmZzZXQ7CgkJdGlwWyBwLnNuZCBdID0gTWF0aC5tYXgoIHJlc3VsdFsgcC5wcm9wIF0gKyBzLmd1aWRlT2Zmc2V0WyBwLnByb3AgXSArIHMuYXJIYWxmWyBwLmRpbUtleSBdLAoJCQlNYXRoLm1pbiggcmVzdWx0WyBwLnByb3AgXSArIHMuZ3VpZGVPZmZzZXRbIHAucHJvcCBdICsgcy5ndWlkZURpbXNbIHAuZGltS2V5IF0gLSBzLmFySGFsZlsgcC5kaW1LZXkgXSwKCQkJCWRlc2lyZWRbIHAuc25kIF0gKSApOwoKCQlkaWZmID0gTWF0aC5hYnMoIGRlc2lyZWQueCAtIHRpcC54ICkgKyBNYXRoLmFicyggZGVzaXJlZC55IC0gdGlwLnkgKTsKCQlpZiAoICFiZXN0IHx8IGRpZmYgPCBiZXN0LmRpZmYgKSB7CgkJCS8vIENvbnZlcnQgdGlwIG9mZnNldCB0byBjb29yZGluYXRlcyBpbnNpZGUgdGhlIHBvcHVwCgkJCXRpcFsgcC5zbmQgXSAtPSBzLmFySGFsZlsgcC5kaW1LZXkgXSArIHJlc3VsdFsgcC5wcm9wIF0gKyBzLmNvbnRlbnRCb3hbIHAuc25kIF07CgkJCWJlc3QgPSB7IGRpcjogZGlyLCBkaWZmOiBkaWZmLCByZXN1bHQ6IHJlc3VsdCwgcG9zUHJvcDogcC5wcm9wLCBwb3NWYWw6IHRpcFsgcC5zbmQgXSB9OwoJCX0KCgkJcmV0dXJuIGJlc3Q7Cgl9LAoKCV9nZXRQbGFjZW1lbnRTdGF0ZTogZnVuY3Rpb24oIGNsYW1wICkgewoJCXZhciBvZmZzZXQsIGdkT2Zmc2V0LAoJCQlhciA9IHRoaXMuX3VpLmFycm93LAoJCQlzdGF0ZSA9IHsKCQkJCWNsYW1wSW5mbzogdGhpcy5fY2xhbXBQb3B1cFdpZHRoKCAhY2xhbXAgKSwKCQkJCWFyRnVsbDogeyBjeDogYXIuY3Qud2lkdGgoKSwgY3k6IGFyLmN0LmhlaWdodCgpIH0sCgkJCQlndWlkZURpbXM6IHsgY3g6IGFyLmdkLndpZHRoKCksIGN5OiBhci5nZC5oZWlnaHQoKSB9LAoJCQkJZ3VpZGVPZmZzZXQ6IGFyLmdkLm9mZnNldCgpCgkJCX07CgoJCW9mZnNldCA9IHRoaXMuZWxlbWVudC5vZmZzZXQoKTsKCgkJYXIuZ2QuY3NzKCB7IGxlZnQ6IDAsIHRvcDogMCwgcmlnaHQ6IDAsIGJvdHRvbTogMCB9ICk7CgkJZ2RPZmZzZXQgPSBhci5nZC5vZmZzZXQoKTsKCQlzdGF0ZS5jb250ZW50Qm94ID0gewoJCQl4OiBnZE9mZnNldC5sZWZ0IC0gb2Zmc2V0LmxlZnQsCgkJCXk6IGdkT2Zmc2V0LnRvcCAtIG9mZnNldC50b3AsCgkJCWN4OiBhci5nZC53aWR0aCgpLAoJCQljeTogYXIuZ2QuaGVpZ2h0KCkKCQl9OwoJCWFyLmdkLnJlbW92ZUF0dHIoICJzdHlsZSIgKTsKCgkJLy8gVGhlIGFycm93IGJveCBtb3ZlcyBiZXR3ZWVuIGd1aWRlT2Zmc2V0IGFuZCBndWlkZU9mZnNldCArIGd1aWRlRGltcyAtIGFyRnVsbAoJCXN0YXRlLmd1aWRlT2Zmc2V0ID0geyBsZWZ0OiBzdGF0ZS5ndWlkZU9mZnNldC5sZWZ0IC0gb2Zmc2V0LmxlZnQsIHRvcDogc3RhdGUuZ3VpZGVPZmZzZXQudG9wIC0gb2Zmc2V0LnRvcCB9OwoJCXN0YXRlLmFySGFsZiA9IHsgY3g6IHN0YXRlLmFyRnVsbC5jeCAvIDIsIGN5OiBzdGF0ZS5hckZ1bGwuY3kgLyAyIH07CgkJc3RhdGUubWVudUhhbGYgPSB7IGN4OiBzdGF0ZS5jbGFtcEluZm8ubWVudVNpemUuY3ggLyAyLCBjeTogc3RhdGUuY2xhbXBJbmZvLm1lbnVTaXplLmN5IC8gMiB9OwoKCQlyZXR1cm4gc3RhdGU7Cgl9LAoKCV9wbGFjZW1lbnRDb29yZHM6IGZ1bmN0aW9uKCBkZXNpcmVkICkgewoJCXZhciBzdGF0ZSwgYmVzdCwgcGFyYW1zLCBiZ09mZnNldCwgZWxPZmZzZXQsIGRpZmYsIGJnUmVmLAoJCQlvcHRpb25WYWx1ZSA9IHRoaXMub3B0aW9ucy5hcnJvdywKCQkJYXIgPSB0aGlzLl91aS5hcnJvdzsKCgkJaWYgKCAhYXIgKSB7CgkJCXJldHVybiB0aGlzLl9zdXBlciggZGVzaXJlZCApOwoJCX0KCgkJYXIuYXJFbHMuc2hvdygpOwoKCQliZ1JlZiA9IHt9OwoJCXN0YXRlID0gdGhpcy5fZ2V0UGxhY2VtZW50U3RhdGUoIHRydWUgKTsKCQlwYXJhbXMgPSB7CgkJCSJsIjogeyBmc3Q6ICJ4Iiwgc25kOiAieSIsIHByb3A6ICJ0b3AiLCBkaW1LZXk6ICJjeSIsIG9EaW1LZXk6ICJjeCIsIG9mZnNldEZhY3RvcjogMSwgdGlwT2Zmc2V0OiAgLXN0YXRlLmFySGFsZi5jeCwgYXJyb3dPZmZzZXRGYWN0b3I6IDAgfSwKCQkJInIiOiB7IGZzdDogIngiLCBzbmQ6ICJ5IiwgcHJvcDogInRvcCIsIGRpbUtleTogImN5Iiwgb0RpbUtleTogImN4Iiwgb2Zmc2V0RmFjdG9yOiAtMSwgdGlwT2Zmc2V0OiBzdGF0ZS5hckhhbGYuY3ggKyBzdGF0ZS5jb250ZW50Qm94LmN4LCBhcnJvd09mZnNldEZhY3RvcjogMSB9LAoJCQkiYiI6IHsgZnN0OiAieSIsIHNuZDogIngiLCBwcm9wOiAibGVmdCIsIGRpbUtleTogImN4Iiwgb0RpbUtleTogImN5Iiwgb2Zmc2V0RmFjdG9yOiAtMSwgdGlwT2Zmc2V0OiBzdGF0ZS5hckhhbGYuY3kgKyBzdGF0ZS5jb250ZW50Qm94LmN5LCBhcnJvd09mZnNldEZhY3RvcjogMSB9LAoJCQkidCI6IHsgZnN0OiAieSIsIHNuZDogIngiLCBwcm9wOiAibGVmdCIsIGRpbUtleTogImN4Iiwgb0RpbUtleTogImN5Iiwgb2Zmc2V0RmFjdG9yOiAxLCB0aXBPZmZzZXQ6IC1zdGF0ZS5hckhhbGYuY3ksIGFycm93T2Zmc2V0RmFjdG9yOiAwIH0KCQl9OwoKCQkvLyBUcnkgZWFjaCBzaWRlIHNwZWNpZmllZCBpbiB0aGUgb3B0aW9ucyB0byBzZWUgb24gd2hpY2ggb25lIHRoZSBhcnJvdwoJCS8vIHNob3VsZCBiZSBwbGFjZWQgc3VjaCB0aGF0IHRoZSBkaXN0YW5jZSBiZXR3ZWVuIHRoZSB0aXAgb2YgdGhlIGFycm93IGFuZAoJCS8vIHRoZSBkZXNpcmVkIGNvb3JkaW5hdGVzIGlzIHRoZSBzaG9ydGVzdC4KCQkkLmVhY2goICggb3B0aW9uVmFsdWUgPT09IHRydWUgPyAibCx0LHIsYiIgOiBvcHRpb25WYWx1ZSApLnNwbGl0KCAiLCIgKSwKCQkJJC5wcm94eSggZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CgkJCQliZXN0ID0gdGhpcy5fdHJ5QW5BcnJvdyggcGFyYW1zWyB2YWx1ZSBdLCB2YWx1ZSwgZGVzaXJlZCwgc3RhdGUsIGJlc3QgKTsKCQkJfSwgdGhpcyApICk7CgoJCS8vIENvdWxkIG5vdCBwbGFjZSB0aGUgYXJyb3cgYWxvbmcgYW55IG9mIHRoZSBlZGdlcyAtIGJlaGF2ZSBhcyBpZiBzaG93aW5nCgkJLy8gdGhlIGFycm93IHdhcyB0dXJuZWQgb2ZmLgoJCWlmICggIWJlc3QgKSB7CgkJCWFyLmFyRWxzLmhpZGUoKTsKCQkJcmV0dXJuIHRoaXMuX3N1cGVyKCBkZXNpcmVkICk7CgkJfQoKCQkvLyBNb3ZlIHRoZSBhcnJvdyBpbnRvIHBsYWNlCgkJYXIuY3QKCQkJLnJlbW92ZUNsYXNzKCAidWktcG9wdXAtYXJyb3ctbCB1aS1wb3B1cC1hcnJvdy10IHVpLXBvcHVwLWFycm93LXIgdWktcG9wdXAtYXJyb3ctYiIgKQoJCQkuYWRkQ2xhc3MoICJ1aS1wb3B1cC1hcnJvdy0iICsgYmVzdC5kaXIgKQoJCQkucmVtb3ZlQXR0ciggInN0eWxlIiApLmNzcyggYmVzdC5wb3NQcm9wLCBiZXN0LnBvc1ZhbCApCgkJCS5zaG93KCk7CgoJCS8vIERvIG5vdCBtb3ZlL3NpemUgdGhlIGJhY2tncm91bmQgZGl2IG9uIElFLCBiZWNhdXNlIHdlIHVzZSB0aGUgYXJyb3cgZGl2IGZvciBiYWNrZ3JvdW5kIGFzIHdlbGwuCgkJaWYgKCAhaWVIYWNrICkgewoJCQllbE9mZnNldCA9IHRoaXMuZWxlbWVudC5vZmZzZXQoKTsKCQkJYmdSZWZbIHBhcmFtc1sgYmVzdC5kaXIgXS5mc3QgXSA9IGFyLmN0Lm9mZnNldCgpOwoJCQliZ1JlZlsgcGFyYW1zWyBiZXN0LmRpciBdLnNuZCBdID0gewoJCQkJbGVmdDogZWxPZmZzZXQubGVmdCArIHN0YXRlLmNvbnRlbnRCb3gueCwKCQkJCXRvcDogZWxPZmZzZXQudG9wICsgc3RhdGUuY29udGVudEJveC55CgkJCX07CgkJCWJnT2Zmc2V0ID0gYXIuYmcKCQkJCS5yZW1vdmVBdHRyKCAic3R5bGUiICkKCQkJCS5jc3MoICggImN4IiA9PT0gcGFyYW1zWyBiZXN0LmRpciBdLmRpbUtleSA/ICJ3aWR0aCIgOiAiaGVpZ2h0IiApLCBzdGF0ZS5jb250ZW50Qm94WyBwYXJhbXNbIGJlc3QuZGlyIF0uZGltS2V5IF0gKQoJCQkJLm9mZnNldCgpOwoJCQlkaWZmID0geyBkeDogYmdSZWYueC5sZWZ0IC0gYmdPZmZzZXQubGVmdCwgZHk6IGJnUmVmLnkudG9wIC0gYmdPZmZzZXQudG9wIH07CgkJCWFyLmJnLmNzcyggeyBsZWZ0OiB0eEZhY3RvciAqIGRpZmYuZHkgKyB0eEZhY3RvciAqIGRpZmYuZHgsIHRvcDogdHhGYWN0b3IgKiBkaWZmLmR5IC0gdHhGYWN0b3IgKiBkaWZmLmR4IH0gKTsKCQl9CgoJCXJldHVybiBiZXN0LnJlc3VsdDsKCX0sCgoJX3NldE9wdGlvbnM6IGZ1bmN0aW9uKCBvcHRzICkgewoJCXZhciBuZXdUaGVtZSwKCQkJb2xkVGhlbWUgPSB0aGlzLm9wdGlvbnMudGhlbWUsCgkJCWFyID0gdGhpcy5fdWkuYXJyb3csCgkJCXJldCA9IHRoaXMuX3N1cGVyKCBvcHRzICk7CgoJCWlmICggb3B0cy5hcnJvdyAhPT0gdW5kZWZpbmVkICkgewoJCQlpZiAoICFhciAmJiBvcHRzLmFycm93ICkgewoJCQkJdGhpcy5fdWkuYXJyb3cgPSB0aGlzLl9hZGRBcnJvdygpOwoKCQkJCS8vIEltcG9ydGFudCB0byByZXR1cm4gaGVyZSBzbyB3ZSBkb24ndCBzZXQgdGhlIHNhbWUgb3B0aW9ucyBhbGwgb3ZlcgoJCQkJLy8gYWdhaW4gYmVsb3cuCgkJCQlyZXR1cm47CgkJCX0gZWxzZSBpZiAoIGFyICYmICFvcHRzLmFycm93ICkgewoJCQkJYXIuYXJFbHMucmVtb3ZlKCk7CgkJCQl0aGlzLl91aS5hcnJvdyA9IG51bGw7CgkJCX0KCQl9CgoJCS8vIFJlYXNzaWduIHdpdGggcG90ZW50aWFsbHkgbmV3IGFycm93CgkJYXIgPSB0aGlzLl91aS5hcnJvdzsKCgkJaWYgKCBhciApIHsKCQkJaWYgKCBvcHRzLnRoZW1lICE9PSB1bmRlZmluZWQgKSB7CgkJCQlvbGRUaGVtZSA9IHRoaXMuX3RoZW1lQ2xhc3NGcm9tT3B0aW9uKCAidWktYm9keS0iLCBvbGRUaGVtZSApOwoJCQkJbmV3VGhlbWUgPSB0aGlzLl90aGVtZUNsYXNzRnJvbU9wdGlvbiggInVpLWJvZHktIiwgb3B0cy50aGVtZSApOwoJCQkJYXIuYXIucmVtb3ZlQ2xhc3MoIG9sZFRoZW1lICkuYWRkQ2xhc3MoIG5ld1RoZW1lICk7CgkJCQlhci5iZy5yZW1vdmVDbGFzcyggb2xkVGhlbWUgKS5hZGRDbGFzcyggbmV3VGhlbWUgKTsKCQkJfQoKCQkJaWYgKCBvcHRzLnNoYWRvdyAhPT0gdW5kZWZpbmVkICkgewoJCQkJYXIuYXIudG9nZ2xlQ2xhc3MoICJ1aS1vdmVybGF5LXNoYWRvdyIsIG9wdHMuc2hhZG93ICk7CgkJCX0KCQl9CgoJCXJldHVybiByZXQ7Cgl9LAoKCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCQl2YXIgYXIgPSB0aGlzLl91aS5hcnJvdzsKCgkJaWYgKCBhciApIHsKCQkJYXIuYXJFbHMucmVtb3ZlKCk7CgkJfQoKCQlyZXR1cm4gdGhpcy5fc3VwZXIoKTsKCX0KfSk7Cgp9KSggalF1ZXJ5ICk7CgoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS5wYW5lbCIsIHsKCW9wdGlvbnM6IHsKCQljbGFzc2VzOiB7CgkJCXBhbmVsOiAidWktcGFuZWwiLAoJCQlwYW5lbE9wZW46ICJ1aS1wYW5lbC1vcGVuIiwKCQkJcGFuZWxDbG9zZWQ6ICJ1aS1wYW5lbC1jbG9zZWQiLAoJCQlwYW5lbEZpeGVkOiAidWktcGFuZWwtZml4ZWQiLAoJCQlwYW5lbElubmVyOiAidWktcGFuZWwtaW5uZXIiLAoJCQltb2RhbDogInVpLXBhbmVsLWRpc21pc3MiLAoJCQltb2RhbE9wZW46ICJ1aS1wYW5lbC1kaXNtaXNzLW9wZW4iLAoJCQlwYWdlQ29udGFpbmVyOiAidWktcGFuZWwtcGFnZS1jb250YWluZXIiLAoJCQlwYWdlV3JhcHBlcjogInVpLXBhbmVsLXdyYXBwZXIiLAoJCQlwYWdlRml4ZWRUb29sYmFyOiAidWktcGFuZWwtZml4ZWQtdG9vbGJhciIsCgkJCXBhZ2VDb250ZW50UHJlZml4OiAidWktcGFuZWwtcGFnZS1jb250ZW50IiwgLyogVXNlZCBmb3Igd3JhcHBlciBhbmQgZml4ZWQgdG9vbGJhcnMgcG9zaXRpb24sIGRpc3BsYXkgYW5kIG9wZW4gY2xhc3Nlcy4gKi8KCQkJYW5pbWF0ZTogInVpLXBhbmVsLWFuaW1hdGUiCgkJfSwKCQlhbmltYXRlOiB0cnVlLAoJCXRoZW1lOiBudWxsLAoJCXBvc2l0aW9uOiAibGVmdCIsCgkJZGlzbWlzc2libGU6IHRydWUsCgkJZGlzcGxheTogInJldmVhbCIsIC8vYWNjZXB0cyByZXZlYWwsIHB1c2gsIG92ZXJsYXkKCQlzd2lwZUNsb3NlOiB0cnVlLAoJCXBvc2l0aW9uRml4ZWQ6IGZhbHNlCgl9LAoKCV9wYW5lbElEOiBudWxsLAoJX2Nsb3NlTGluazogbnVsbCwKCV9wYXJlbnRQYWdlOiBudWxsLAoJX3BhZ2U6IG51bGwsCglfbW9kYWw6IG51bGwsCglfcGFuZWxJbm5lcjogbnVsbCwKCV93cmFwcGVyOiBudWxsLAoJX2ZpeGVkVG9vbGJhcnM6IG51bGwsCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdmFyIGVsID0gdGhpcy5lbGVtZW50LAoJCQlwYXJlbnRQYWdlID0gZWwuY2xvc2VzdCggIjpqcW1EYXRhKHJvbGU9J3BhZ2UnKSIgKTsKCgkJLy8gZXhwb3NlIHNvbWUgcHJpdmF0ZSBwcm9wcyB0byBvdGhlciBtZXRob2RzCgkJJC5leHRlbmQoIHRoaXMsIHsKCQkJX3BhbmVsSUQ6IGVsLmF0dHIoICJpZCIgKSwKCQkJX2Nsb3NlTGluazogZWwuZmluZCggIjpqcW1EYXRhKHJlbD0nY2xvc2UnKSIgKSwKCQkJX3BhcmVudFBhZ2U6ICggcGFyZW50UGFnZS5sZW5ndGggPiAwICkgPyBwYXJlbnRQYWdlIDogZmFsc2UsCgkJCV9wYWdlOiB0aGlzLl9nZXRQYWdlLAoJCQlfcGFuZWxJbm5lcjogdGhpcy5fZ2V0UGFuZWxJbm5lcigpLAoJCQlfd3JhcHBlcjogdGhpcy5fZ2V0V3JhcHBlciwKCQkJX2ZpeGVkVG9vbGJhcnM6IHRoaXMuX2dldEZpeGVkVG9vbGJhcnMKCQl9KTsKCQkKCQl0aGlzLl9hZGRQYW5lbENsYXNzZXMoKTsKCgkJLy8gaWYgYW5pbWF0aW5nLCBhZGQgdGhlIGNsYXNzIHRvIGRvIHNvCgkJaWYgKCAkLnN1cHBvcnQuY3NzVHJhbnNmb3JtM2QgJiYgISF0aGlzLm9wdGlvbnMuYW5pbWF0ZSApIHsKCQkJdGhpcy5lbGVtZW50LmFkZENsYXNzKCB0aGlzLm9wdGlvbnMuY2xhc3Nlcy5hbmltYXRlICk7CgkJfQoKCQl0aGlzLl9iaW5kVXBkYXRlTGF5b3V0KCk7CgkJdGhpcy5fYmluZENsb3NlRXZlbnRzKCk7CgkJdGhpcy5fYmluZExpbmtMaXN0ZW5lcnMoKTsKCQl0aGlzLl9iaW5kUGFnZUV2ZW50cygpOwoKCQlpZiAoICEhdGhpcy5vcHRpb25zLmRpc21pc3NpYmxlICkgewoJCQl0aGlzLl9jcmVhdGVNb2RhbCgpOwoJCX0KCgkJdGhpcy5fYmluZFN3aXBlRXZlbnRzKCk7Cgl9LAoJCglfZ2V0UGFuZWxJbm5lcjogZnVuY3Rpb24oKSB7CgkJdmFyIHBhbmVsSW5uZXIgPSB0aGlzLmVsZW1lbnQuZmluZCggIi4iICsgdGhpcy5vcHRpb25zLmNsYXNzZXMucGFuZWxJbm5lciApOwoJCQoJCWlmICggcGFuZWxJbm5lci5sZW5ndGggPT09IDAgKSB7CgkJCXBhbmVsSW5uZXIgPSB0aGlzLmVsZW1lbnQuY2hpbGRyZW4oKS53cmFwQWxsKCAiPGRpdiBjbGFzcz0nIiArIHRoaXMub3B0aW9ucy5jbGFzc2VzLnBhbmVsSW5uZXIgKyAiJyAvPiIgKS5wYXJlbnQoKTsKCQl9CgkJCgkJcmV0dXJuIHBhbmVsSW5uZXI7Cgl9LAoJCglfY3JlYXRlTW9kYWw6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpcywKCQkJdGFyZ2V0ID0gc2VsZi5fcGFyZW50UGFnZSA/IHNlbGYuX3BhcmVudFBhZ2UucGFyZW50KCkgOiBzZWxmLmVsZW1lbnQucGFyZW50KCk7CgoJCXNlbGYuX21vZGFsID0gJCggIjxkaXYgY2xhc3M9JyIgKyBzZWxmLm9wdGlvbnMuY2xhc3Nlcy5tb2RhbCArICInIGRhdGEtcGFuZWxpZD0nIiArIHNlbGYuX3BhbmVsSUQgKyAiJz48L2Rpdj4iICkKCQkJLm9uKCAibW91c2Vkb3duIiwgZnVuY3Rpb24oKSB7CgkJCQlzZWxmLmNsb3NlKCk7CgkJCX0pCgkJCS5hcHBlbmRUbyggdGFyZ2V0ICk7Cgl9LAoJCglfZ2V0UGFnZTogZnVuY3Rpb24oKSB7CgkJdmFyIHBhZ2UgPSB0aGlzLl9wYXJlbnRQYWdlID8gdGhpcy5fcGFyZW50UGFnZSA6ICQoICIuIiArICQubW9iaWxlLmFjdGl2ZVBhZ2VDbGFzcyApOwoJCQoJCXJldHVybiBwYWdlOwoJfSwKCQoJX2dldFdyYXBwZXI6IGZ1bmN0aW9uKCkgewoJCXZhciB3cmFwcGVyID0gdGhpcy5fcGFnZSgpLmZpbmQoICIuIiArIHRoaXMub3B0aW9ucy5jbGFzc2VzLnBhZ2VXcmFwcGVyICk7CgoJCWlmICggd3JhcHBlci5sZW5ndGggPT09IDAgKSB7CgkJCXdyYXBwZXIgPSB0aGlzLl9wYWdlKCkuY2hpbGRyZW4oICIudWktaGVhZGVyOm5vdCg6anFtRGF0YShwb3NpdGlvbj0nZml4ZWQnKSksIC51aS1jb250ZW50Om5vdCg6anFtRGF0YShyb2xlPSdwb3B1cCcpKSwgLnVpLWZvb3Rlcjpub3QoOmpxbURhdGEocG9zaXRpb249J2ZpeGVkJykpIiApCgkJCQkud3JhcEFsbCggIjxkaXYgY2xhc3M9JyIgKyB0aGlzLm9wdGlvbnMuY2xhc3Nlcy5wYWdlV3JhcHBlciArICInPjwvZGl2PiIgKQoJCQkJLnBhcmVudCgpOwoJCX0KCgkJcmV0dXJuIHdyYXBwZXI7Cgl9LAoJCglfZ2V0Rml4ZWRUb29sYmFyczogZnVuY3Rpb24oKSB7CgkJdmFyIGV4dEZpeGVkVG9vbGJhcnMgPSAkKCAiYm9keSIgKS5jaGlsZHJlbiggIi51aS1oZWFkZXI6anFtRGF0YShwb3NpdGlvbj0nZml4ZWQnKSwgLnVpLWZvb3RlcjpqcW1EYXRhKHBvc2l0aW9uPSdmaXhlZCcpIiApLAoJCQlpbnRGaXhlZFRvb2xiYXJzID0gdGhpcy5fcGFnZSgpLmZpbmQoICIudWktaGVhZGVyOmpxbURhdGEocG9zaXRpb249J2ZpeGVkJyksIC51aS1mb290ZXI6anFtRGF0YShwb3NpdGlvbj0nZml4ZWQnKSIgKSwKCQkJZml4ZWRUb29sYmFycyA9IGV4dEZpeGVkVG9vbGJhcnMuYWRkKCBpbnRGaXhlZFRvb2xiYXJzICkuYWRkQ2xhc3MoIHRoaXMub3B0aW9ucy5jbGFzc2VzLnBhZ2VGaXhlZFRvb2xiYXIgKTsKCgkJcmV0dXJuIGZpeGVkVG9vbGJhcnM7Cgl9LAoKCV9nZXRQb3NEaXNwbGF5Q2xhc3NlczogZnVuY3Rpb24oIHByZWZpeCApIHsKCQlyZXR1cm4gcHJlZml4ICsgIi1wb3NpdGlvbi0iICsgdGhpcy5vcHRpb25zLnBvc2l0aW9uICsgIiAiICsgcHJlZml4ICsgIi1kaXNwbGF5LSIgKyB0aGlzLm9wdGlvbnMuZGlzcGxheTsKCX0sCgoJX2dldFBhbmVsQ2xhc3NlczogZnVuY3Rpb24oKSB7CgkJdmFyIHBhbmVsQ2xhc3NlcyA9IHRoaXMub3B0aW9ucy5jbGFzc2VzLnBhbmVsICsKCQkJIiAiICsgdGhpcy5fZ2V0UG9zRGlzcGxheUNsYXNzZXMoIHRoaXMub3B0aW9ucy5jbGFzc2VzLnBhbmVsICkgKwoJCQkiICIgKyB0aGlzLm9wdGlvbnMuY2xhc3Nlcy5wYW5lbENsb3NlZCArCgkJCSIgIiArICJ1aS1ib2R5LSIgKyAoIHRoaXMub3B0aW9ucy50aGVtZSA/IHRoaXMub3B0aW9ucy50aGVtZSA6ICJpbmhlcml0IiApOwoKCQlpZiAoICEhdGhpcy5vcHRpb25zLnBvc2l0aW9uRml4ZWQgKSB7CgkJCXBhbmVsQ2xhc3NlcyArPSAiICIgKyB0aGlzLm9wdGlvbnMuY2xhc3Nlcy5wYW5lbEZpeGVkOwoJCX0KCgkJcmV0dXJuIHBhbmVsQ2xhc3NlczsKCX0sCgoJX2FkZFBhbmVsQ2xhc3NlczogZnVuY3Rpb24oKSB7CgkJdGhpcy5lbGVtZW50LmFkZENsYXNzKCB0aGlzLl9nZXRQYW5lbENsYXNzZXMoKSApOwoJfSwKCglfYmluZENsb3NlRXZlbnRzOiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXM7CgoJCXNlbGYuX2Nsb3NlTGluay5vbiggImNsaWNrLnBhbmVsIiAsIGZ1bmN0aW9uKCBlICkgewoJCQllLnByZXZlbnREZWZhdWx0KCk7CgkJCXNlbGYuY2xvc2UoKTsKCQkJcmV0dXJuIGZhbHNlOwoJCX0pOwoJCXNlbGYuZWxlbWVudC5vbiggImNsaWNrLnBhbmVsIiAsICJhOmpxbURhdGEoYWpheD0nZmFsc2UnKSIsIGZ1bmN0aW9uKC8qIGUgKi8pIHsKCQkJc2VsZi5jbG9zZSgpOwoJCX0pOwoJfSwKCglfcG9zaXRpb25QYW5lbDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzLAoJCQlwYW5lbElubmVySGVpZ2h0ID0gc2VsZi5fcGFuZWxJbm5lci5vdXRlckhlaWdodCgpLAoJCQlleHBhbmQgPSBwYW5lbElubmVySGVpZ2h0ID4gJC5tb2JpbGUuZ2V0U2NyZWVuSGVpZ2h0KCk7CgoJCWlmICggZXhwYW5kIHx8ICFzZWxmLm9wdGlvbnMucG9zaXRpb25GaXhlZCApIHsKCQkJaWYgKCBleHBhbmQgKSB7CgkJCQlzZWxmLl91bmZpeFBhbmVsKCk7CgkJCQkkLm1vYmlsZS5yZXNldEFjdGl2ZVBhZ2VIZWlnaHQoIHBhbmVsSW5uZXJIZWlnaHQgKTsKCQkJfQoJCQl3aW5kb3cuc2Nyb2xsVG8oIDAsICQubW9iaWxlLmRlZmF1bHRIb21lU2Nyb2xsICk7CgkJfSBlbHNlIHsKCQkJc2VsZi5fZml4UGFuZWwoKTsKCQl9Cgl9LAoKCV9iaW5kRml4TGlzdGVuZXI6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX29uKCAkKCB3aW5kb3cgKSwgeyAidGhyb3R0bGVkcmVzaXplIjogIl9wb3NpdGlvblBhbmVsIiB9KTsKCX0sCgoJX3VuYmluZEZpeExpc3RlbmVyOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9vZmYoICQoIHdpbmRvdyApLCAidGhyb3R0bGVkcmVzaXplIiApOwoJfSwKCglfdW5maXhQYW5lbDogZnVuY3Rpb24oKSB7CgkJaWYgKCAhIXRoaXMub3B0aW9ucy5wb3NpdGlvbkZpeGVkICYmICQuc3VwcG9ydC5maXhlZFBvc2l0aW9uICkgewoJCQl0aGlzLmVsZW1lbnQucmVtb3ZlQ2xhc3MoIHRoaXMub3B0aW9ucy5jbGFzc2VzLnBhbmVsRml4ZWQgKTsKCQl9Cgl9LAoKCV9maXhQYW5lbDogZnVuY3Rpb24oKSB7CgkJaWYgKCAhIXRoaXMub3B0aW9ucy5wb3NpdGlvbkZpeGVkICYmICQuc3VwcG9ydC5maXhlZFBvc2l0aW9uICkgewoJCQl0aGlzLmVsZW1lbnQuYWRkQ2xhc3MoIHRoaXMub3B0aW9ucy5jbGFzc2VzLnBhbmVsRml4ZWQgKTsKCQl9Cgl9LAoKCV9iaW5kVXBkYXRlTGF5b3V0OiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXM7CgoJCXNlbGYuZWxlbWVudC5vbiggInVwZGF0ZWxheW91dCIsIGZ1bmN0aW9uKC8qIGUgKi8pIHsKCQkJaWYgKCBzZWxmLl9vcGVuICkgewoJCQkJc2VsZi5fcG9zaXRpb25QYW5lbCgpOwoJCQl9CgkJfSk7Cgl9LAoKCV9iaW5kTGlua0xpc3RlbmVyczogZnVuY3Rpb24oKSB7CgkJdGhpcy5fb24oICJib2R5IiwgewoJCQkiY2xpY2sgYSI6ICJfaGFuZGxlQ2xpY2siCgkJfSk7CgkJCgl9LAoKCV9oYW5kbGVDbGljazogZnVuY3Rpb24oIGUgKXsKCQlpZiAoICBlLmN1cnJlbnRUYXJnZXQuaHJlZi5zcGxpdCggIiMiIClbIDEgXSA9PT0gdGhpcy5fcGFuZWxJRCAmJiB0aGlzLl9wYW5lbElEICE9PSB1bmRlZmluZWQgKSB7CgkJCWUucHJldmVudERlZmF1bHQoKTsKCQkJdmFyIGxpbmsgPSAkKCBlLnRhcmdldCApOwoJCQlpZiAoIGxpbmsuaGFzQ2xhc3MoICJ1aS1idG4iICkgKSB7CgkJCQlsaW5rLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQkJdGhpcy5lbGVtZW50Lm9uZSggInBhbmVsb3BlbiBwYW5lbGNsb3NlIiwgZnVuY3Rpb24oKSB7CgkJCQkJbGluay5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJCX0pOwoJCQl9CgkJCXRoaXMudG9nZ2xlKCk7CgkJCXJldHVybiBmYWxzZTsKCQl9Cgl9LAoKCV9iaW5kU3dpcGVFdmVudHM6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpcywKCQkJYXJlYSA9IHNlbGYuX21vZGFsID8gc2VsZi5lbGVtZW50LmFkZCggc2VsZi5fbW9kYWwgKSA6IHNlbGYuZWxlbWVudDsKCgkJLy8gb24gc3dpcGUsIGNsb3NlIHRoZSBwYW5lbAoJCWlmICggISFzZWxmLm9wdGlvbnMuc3dpcGVDbG9zZSApIHsKCQkJaWYgKCBzZWxmLm9wdGlvbnMucG9zaXRpb24gPT09ICJsZWZ0IiApIHsKCQkJCWFyZWEub24oICJzd2lwZWxlZnQucGFuZWwiLCBmdW5jdGlvbigvKiBlICovKSB7CgkJCQkJc2VsZi5jbG9zZSgpOwoJCQkJfSk7CgkJCX0gZWxzZSB7CgkJCQlhcmVhLm9uKCAic3dpcGVyaWdodC5wYW5lbCIsIGZ1bmN0aW9uKC8qIGUgKi8pIHsKCQkJCQlzZWxmLmNsb3NlKCk7CgkJCQl9KTsKCQkJfQoJCX0KCX0sCgoJX2JpbmRQYWdlRXZlbnRzOiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXM7CgoJCXRoaXMuZG9jdW1lbnQKCQkJLy8gQ2xvc2UgdGhlIHBhbmVsIGlmIGFub3RoZXIgcGFuZWwgb24gdGhlIHBhZ2Ugb3BlbnMKCQkJLm9uKCAicGFuZWxiZWZvcmVvcGVuIiwgZnVuY3Rpb24oIGUgKSB7CgkJCQlpZiAoIHNlbGYuX29wZW4gJiYgZS50YXJnZXQgIT09IHNlbGYuZWxlbWVudFsgMCBdICkgewoJCQkJCXNlbGYuY2xvc2UoKTsKCQkJCX0KCQkJfSkKCQkJLy8gT24gZXNjYXBlLCBjbG9zZT8gbWlnaHQgbmVlZCB0byBoYXZlIGEgdGFyZ2V0IGNoZWNrIHRvby4uLgoJCQkub24oICJrZXl1cC5wYW5lbCIsIGZ1bmN0aW9uKCBlICkgewoJCQkJaWYgKCBlLmtleUNvZGUgPT09IDI3ICYmIHNlbGYuX29wZW4gKSB7CgkJCQkJc2VsZi5jbG9zZSgpOwoJCQkJfQoJCQl9KTsKCQkJCgkJLy8gQ2xlYW4gdXAgb3BlbiBwYW5lbHMgYWZ0ZXIgcGFnZSBoaWRlCgkJaWYgKCBzZWxmLl9wYXJlbnRQYWdlICkgewoJCQl0aGlzLmRvY3VtZW50Lm9uKCAicGFnZWhpZGUiLCAiOmpxbURhdGEocm9sZT0ncGFnZScpIiwgZnVuY3Rpb24oKSB7CgkJCQlpZiAoIHNlbGYuX29wZW4gKSB7CgkJCQkJc2VsZi5jbG9zZSggdHJ1ZSApOwoJCQkJfQoJCQl9KTsKCQl9IGVsc2UgewoJCQl0aGlzLmRvY3VtZW50Lm9uKCAicGFnZWJlZm9yZWhpZGUiLCBmdW5jdGlvbigpIHsKCQkJCWlmICggc2VsZi5fb3BlbiApIHsKCQkJCQlzZWxmLmNsb3NlKCB0cnVlICk7CgkJCQl9CgkJCX0pOwoJCX0KCX0sCgoJLy8gc3RhdGUgc3RvcmFnZSBvZiBvcGVuIG9yIGNsb3NlZAoJX29wZW46IGZhbHNlLAoJX3BhZ2VDb250ZW50T3BlbkNsYXNzZXM6IG51bGwsCglfbW9kYWxPcGVuQ2xhc3NlczogbnVsbCwKCglvcGVuOiBmdW5jdGlvbiggaW1tZWRpYXRlICkgewoJCWlmICggIXRoaXMuX29wZW4gKSB7CgkJCXZhciBzZWxmID0gdGhpcywKCQkJCW8gPSBzZWxmLm9wdGlvbnMsCgkJCQkKCQkJCV9vcGVuUGFuZWwgPSBmdW5jdGlvbigpIHsKCQkJCQlzZWxmLmRvY3VtZW50Lm9mZiggInBhbmVsY2xvc2UiICk7CgkJCQkJc2VsZi5fcGFnZSgpLmpxbURhdGEoICJwYW5lbCIsICJvcGVuIiApOwoJCQkJCQoJCQkJCWlmICggJC5zdXBwb3J0LmNzc1RyYW5zZm9ybTNkICYmICEhby5hbmltYXRlICYmIG8uZGlzcGxheSAhPT0gIm92ZXJsYXkiICkgewoJCQkJCQlzZWxmLl93cmFwcGVyKCkuYWRkQ2xhc3MoIG8uY2xhc3Nlcy5hbmltYXRlICk7CgkJCQkJCXNlbGYuX2ZpeGVkVG9vbGJhcnMoKS5hZGRDbGFzcyggby5jbGFzc2VzLmFuaW1hdGUgKTsKCQkJCQl9CgoJCQkJCWlmICggIWltbWVkaWF0ZSAmJiAkLnN1cHBvcnQuY3NzVHJhbnNmb3JtM2QgJiYgISFvLmFuaW1hdGUgKSB7CgkJCQkJCXNlbGYuZG9jdW1lbnQub24oIHNlbGYuX3RyYW5zaXRpb25FbmRFdmVudHMsIGNvbXBsZXRlICk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJc2V0VGltZW91dCggY29tcGxldGUsIDAgKTsKCQkJCQl9CgoJCQkJCWlmICggby50aGVtZSAmJiBvLmRpc3BsYXkgIT09ICJvdmVybGF5IiApIHsKCQkJCQkJc2VsZi5fcGFnZSgpLnBhcmVudCgpCgkJCQkJCQkuYWRkQ2xhc3MoIG8uY2xhc3Nlcy5wYWdlQ29udGFpbmVyICsgIi10aGVtZWQgIiArIG8uY2xhc3Nlcy5wYWdlQ29udGFpbmVyICsgIi0iICsgby50aGVtZSApOwoJCQkJCX0KCgkJCQkJc2VsZi5lbGVtZW50CgkJCQkJCS5yZW1vdmVDbGFzcyggby5jbGFzc2VzLnBhbmVsQ2xvc2VkICkKCQkJCQkJLmFkZENsYXNzKCBvLmNsYXNzZXMucGFuZWxPcGVuICk7CgoJCQkJCXNlbGYuX3Bvc2l0aW9uUGFuZWwoKTsKCgkJCQkJc2VsZi5fcGFnZUNvbnRlbnRPcGVuQ2xhc3NlcyA9IHNlbGYuX2dldFBvc0Rpc3BsYXlDbGFzc2VzKCBvLmNsYXNzZXMucGFnZUNvbnRlbnRQcmVmaXggKTsKCQkJCQkKCQkJCQlpZiAoIG8uZGlzcGxheSAhPT0gIm92ZXJsYXkiICkgewoJCQkJCQlzZWxmLl9wYWdlKCkucGFyZW50KCkuYWRkQ2xhc3MoIG8uY2xhc3Nlcy5wYWdlQ29udGFpbmVyICk7CgkJCQkJCXNlbGYuX3dyYXBwZXIoKS5hZGRDbGFzcyggc2VsZi5fcGFnZUNvbnRlbnRPcGVuQ2xhc3NlcyApOwoJCQkJCQlzZWxmLl9maXhlZFRvb2xiYXJzKCkuYWRkQ2xhc3MoIHNlbGYuX3BhZ2VDb250ZW50T3BlbkNsYXNzZXMgKTsKCQkJCQl9CgoJCQkJCXNlbGYuX21vZGFsT3BlbkNsYXNzZXMgPSBzZWxmLl9nZXRQb3NEaXNwbGF5Q2xhc3Nlcyggby5jbGFzc2VzLm1vZGFsICkgKyAiICIgKyBvLmNsYXNzZXMubW9kYWxPcGVuOwoJCQkJCWlmICggc2VsZi5fbW9kYWwgKSB7CgkJCQkJCXNlbGYuX21vZGFsCgkJCQkJCQkuYWRkQ2xhc3MoIHNlbGYuX21vZGFsT3BlbkNsYXNzZXMgKQoJCQkJCQkJLmhlaWdodCggTWF0aC5tYXgoIHNlbGYuX21vZGFsLmhlaWdodCgpLCBzZWxmLmRvY3VtZW50LmhlaWdodCgpICkgKTsKCQkJCQl9CgkJCQl9LAoJCQkJY29tcGxldGUgPSBmdW5jdGlvbigpIHsKCQkJCQlzZWxmLmRvY3VtZW50Lm9mZiggc2VsZi5fdHJhbnNpdGlvbkVuZEV2ZW50cywgY29tcGxldGUgKTsKCQkJCQkKCQkJCQlpZiAoIG8uZGlzcGxheSAhPT0gIm92ZXJsYXkiICkgewoJCQkJCQlzZWxmLl93cmFwcGVyKCkuYWRkQ2xhc3MoIG8uY2xhc3Nlcy5wYWdlQ29udGVudFByZWZpeCArICItb3BlbiIgKTsKCQkJCQkJc2VsZi5fZml4ZWRUb29sYmFycygpLmFkZENsYXNzKCBvLmNsYXNzZXMucGFnZUNvbnRlbnRQcmVmaXggKyAiLW9wZW4iICk7CgkJCQkJfQoKCQkJCQlzZWxmLl9iaW5kRml4TGlzdGVuZXIoKTsKCgkJCQkJc2VsZi5fdHJpZ2dlciggIm9wZW4iICk7CgkJCQl9OwoKCQkJc2VsZi5fdHJpZ2dlciggImJlZm9yZW9wZW4iICk7CgkJCQoJCQlpZiAoIHNlbGYuX3BhZ2UoKS5qcW1EYXRhKCAicGFuZWwiICkgPT09ICJvcGVuIiApIHsKCQkJCXNlbGYuZG9jdW1lbnQub24oICJwYW5lbGNsb3NlIiwgZnVuY3Rpb24oKSB7CgkJCQkJX29wZW5QYW5lbCgpOwoJCQkJfSk7CgkJCX0gZWxzZSB7CgkJCQlfb3BlblBhbmVsKCk7CgkJCX0KCgkJCXNlbGYuX29wZW4gPSB0cnVlOwoJCX0KCX0sCgoJY2xvc2U6IGZ1bmN0aW9uKCBpbW1lZGlhdGUgKSB7CgkJaWYgKCB0aGlzLl9vcGVuICkgewoJCQl2YXIgc2VsZiA9IHRoaXMsCgkJCQlvID0gdGhpcy5vcHRpb25zLAoJCQkJCgkJCQlfY2xvc2VQYW5lbCA9IGZ1bmN0aW9uKCkgewoJCQkJCWlmICggIWltbWVkaWF0ZSAmJiAkLnN1cHBvcnQuY3NzVHJhbnNmb3JtM2QgJiYgISFvLmFuaW1hdGUgKSB7CgkJCQkJCXNlbGYuZG9jdW1lbnQub24oIHNlbGYuX3RyYW5zaXRpb25FbmRFdmVudHMsIGNvbXBsZXRlICk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJc2V0VGltZW91dCggY29tcGxldGUsIDAgKTsKCQkJCQl9CgoJCQkJCXNlbGYuZWxlbWVudC5yZW1vdmVDbGFzcyggby5jbGFzc2VzLnBhbmVsT3BlbiApOwoJCQkJCQoJCQkJCWlmICggby5kaXNwbGF5ICE9PSAib3ZlcmxheSIgKSB7CgkJCQkJCXNlbGYuX3dyYXBwZXIoKS5yZW1vdmVDbGFzcyggc2VsZi5fcGFnZUNvbnRlbnRPcGVuQ2xhc3NlcyApOwoJCQkJCQlzZWxmLl9maXhlZFRvb2xiYXJzKCkucmVtb3ZlQ2xhc3MoIHNlbGYuX3BhZ2VDb250ZW50T3BlbkNsYXNzZXMgKTsKCQkJCQl9CgkJCQkJCgkJCQkJaWYgKCBzZWxmLl9tb2RhbCApIHsKCQkJCQkJc2VsZi5fbW9kYWwucmVtb3ZlQ2xhc3MoIHNlbGYuX21vZGFsT3BlbkNsYXNzZXMgKTsKCQkJCQl9CgkJCQl9LAoJCQkJY29tcGxldGUgPSBmdW5jdGlvbigpIHsKCQkJCQlzZWxmLmRvY3VtZW50Lm9mZiggc2VsZi5fdHJhbnNpdGlvbkVuZEV2ZW50cywgY29tcGxldGUgKTsKCQkJCQkKCQkJCQlpZiAoIG8udGhlbWUgJiYgby5kaXNwbGF5ICE9PSAib3ZlcmxheSIgKSB7CgkJCQkJCXNlbGYuX3BhZ2UoKS5wYXJlbnQoKS5yZW1vdmVDbGFzcyggby5jbGFzc2VzLnBhZ2VDb250YWluZXIgKyAiLXRoZW1lZCAiICsgby5jbGFzc2VzLnBhZ2VDb250YWluZXIgKyAiLSIgKyBvLnRoZW1lICk7CgkJCQkJfQoJCQkJCQkKCQkJCQlzZWxmLmVsZW1lbnQuYWRkQ2xhc3MoIG8uY2xhc3Nlcy5wYW5lbENsb3NlZCApOwoKCQkJCQlpZiAoIG8uZGlzcGxheSAhPT0gIm92ZXJsYXkiICkgewoJCQkJCQlzZWxmLl9wYWdlKCkucGFyZW50KCkucmVtb3ZlQ2xhc3MoIG8uY2xhc3Nlcy5wYWdlQ29udGFpbmVyICk7CgkJCQkJCXNlbGYuX3dyYXBwZXIoKS5yZW1vdmVDbGFzcyggby5jbGFzc2VzLnBhZ2VDb250ZW50UHJlZml4ICsgIi1vcGVuIiApOwoJCQkJCQlzZWxmLl9maXhlZFRvb2xiYXJzKCkucmVtb3ZlQ2xhc3MoIG8uY2xhc3Nlcy5wYWdlQ29udGVudFByZWZpeCArICItb3BlbiIgKTsKCQkJCQl9CgoJCQkJCWlmICggJC5zdXBwb3J0LmNzc1RyYW5zZm9ybTNkICYmICEhby5hbmltYXRlICYmIG8uZGlzcGxheSAhPT0gIm92ZXJsYXkiICkgewoJCQkJCQlzZWxmLl93cmFwcGVyKCkucmVtb3ZlQ2xhc3MoIG8uY2xhc3Nlcy5hbmltYXRlICk7CgkJCQkJCXNlbGYuX2ZpeGVkVG9vbGJhcnMoKS5yZW1vdmVDbGFzcyggby5jbGFzc2VzLmFuaW1hdGUgKTsKCQkJCQl9CgoJCQkJCXNlbGYuX2ZpeFBhbmVsKCk7CgkJCQkJc2VsZi5fdW5iaW5kRml4TGlzdGVuZXIoKTsKCQkJCQkkLm1vYmlsZS5yZXNldEFjdGl2ZVBhZ2VIZWlnaHQoKTsKCgkJCQkJc2VsZi5fcGFnZSgpLmpxbVJlbW92ZURhdGEoICJwYW5lbCIgKTsKCQkJCQkKCQkJCQlzZWxmLl90cmlnZ2VyKCAiY2xvc2UiICk7CgkJCQl9OwoKCQkJc2VsZi5fdHJpZ2dlciggImJlZm9yZWNsb3NlIiApOwoKCQkJX2Nsb3NlUGFuZWwoKTsKCgkJCXNlbGYuX29wZW4gPSBmYWxzZTsKCQl9Cgl9LAoKCXRvZ2dsZTogZnVuY3Rpb24oKSB7CgkJdGhpc1sgdGhpcy5fb3BlbiA/ICJjbG9zZSIgOiAib3BlbiIgXSgpOwoJfSwKCglfdHJhbnNpdGlvbkVuZEV2ZW50czogIndlYmtpdFRyYW5zaXRpb25FbmQgb1RyYW5zaXRpb25FbmQgb3RyYW5zaXRpb25lbmQgdHJhbnNpdGlvbmVuZCBtc1RyYW5zaXRpb25FbmQiLAoKCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCQl2YXIgbyA9IHRoaXMub3B0aW9ucywKCQkJbXVsdGlwbGVQYW5lbHMgPSAoICQoICJib2R5ID4gOm1vYmlsZS1wYW5lbCIgKS5sZW5ndGggKyAkLm1vYmlsZS5hY3RpdmVQYWdlLmZpbmQoICI6bW9iaWxlLXBhbmVsIiApLmxlbmd0aCApID4gMTsKCgkJaWYgKCBvLmRpc3BsYXkgIT09ICJvdmVybGF5IiApIHsKCQkJLy8gRGVzdHJveSB0aGUgd3JhcHBlciBldmVuIGlmIHRoZXJlIGFyZSBzdGlsbCBvdGhlciBwYW5lbHMsIGJlY2F1c2Ugd2UgZG9uJ3Qga25vdyBpZiB0aGV5IHVzZSBhIHdyYXBwZXIKCQkJdGhpcy5fd3JhcHBlcigpLmNoaWxkcmVuKCkudW53cmFwKCk7CgoJCQlpZiAoIHRoaXMuX29wZW4gKSB7CgkJCQkKCQkJCXRoaXMuX2ZpeGVkVG9vbGJhcnMoKS5yZW1vdmVDbGFzcyggby5jbGFzc2VzLnBhZ2VDb250ZW50UHJlZml4ICsgIi1vcGVuIiApOwoJCQkJCgkJCQlpZiAoICQuc3VwcG9ydC5jc3NUcmFuc2Zvcm0zZCAmJiAhIW8uYW5pbWF0ZSApIHsKCQkJCQl0aGlzLl9maXhlZFRvb2xiYXJzKCkucmVtb3ZlQ2xhc3MoIG8uY2xhc3Nlcy5hbmltYXRlICk7CgkJCQl9CgkJCQkKCQkJCXRoaXMuX3BhZ2UoKS5wYXJlbnQoKS5yZW1vdmVDbGFzcyggby5jbGFzc2VzLnBhZ2VDb250YWluZXIgKTsKCQkJCQoJCQkJaWYgKCBvLnRoZW1lICkgewoJCQkJCXRoaXMuX3BhZ2UoKS5wYXJlbnQoKS5yZW1vdmVDbGFzcyggby5jbGFzc2VzLnBhZ2VDb250YWluZXIgKyAiLXRoZW1lZCAiICsgby5jbGFzc2VzLnBhZ2VDb250YWluZXIgKyAiLSIgKyBvLnRoZW1lICk7CgkJCQl9CgkJCX0KCQl9CgoJCWlmICggIW11bHRpcGxlUGFuZWxzICkgewoKCQkJdGhpcy5kb2N1bWVudC5vZmYoICJwYW5lbG9wZW4gcGFuZWxjbG9zZSIgKTsKCQkJCgkJCWlmICggdGhpcy5fb3BlbiApIHsKCQkJCXRoaXMuZG9jdW1lbnQub2ZmKCB0aGlzLl90cmFuc2l0aW9uRW5kRXZlbnRzICk7CgkJCQkkLm1vYmlsZS5yZXNldEFjdGl2ZVBhZ2VIZWlnaHQoKTsKCQkJfQoJCX0KCQkKCQlpZiAoIHRoaXMuX29wZW4gKSB7CgkJCXRoaXMuX3BhZ2UoKS5qcW1SZW1vdmVEYXRhKCAicGFuZWwiICk7CgkJfQoJCQoJCXRoaXMuX3BhbmVsSW5uZXIuY2hpbGRyZW4oKS51bndyYXAoKTsKCgkJdGhpcy5lbGVtZW50CgkJCS5yZW1vdmVDbGFzcyggWyB0aGlzLl9nZXRQYW5lbENsYXNzZXMoKSwgby5jbGFzc2VzLnBhbmVsT3Blbiwgby5jbGFzc2VzLmFuaW1hdGUgXS5qb2luKCAiICIgKSApCgkJCS5vZmYoICJzd2lwZWxlZnQucGFuZWwgc3dpcGVyaWdodC5wYW5lbCIgKQoJCQkub2ZmKCAicGFuZWxiZWZvcmVvcGVuIiApCgkJCS5vZmYoICJwYW5lbGhpZGUiICkKCQkJLm9mZiggImtleXVwLnBhbmVsIiApCgkJCS5vZmYoICJ1cGRhdGVsYXlvdXQiICkKCQkJLm9mZiggdGhpcy5fdHJhbnNpdGlvbkVuZEV2ZW50cyApOwoKCQl0aGlzLl9jbG9zZUxpbmsub2ZmKCAiY2xpY2sucGFuZWwiICk7CgoJCWlmICggdGhpcy5fbW9kYWwgKSB7CgkJCXRoaXMuX21vZGFsLnJlbW92ZSgpOwoJCX0KCX0KfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLnRhYmxlIiwgewoJb3B0aW9uczogewoJCWNsYXNzZXM6IHsKCQkJdGFibGU6ICJ1aS10YWJsZSIKCQl9LAoJCWVuaGFuY2VkOiBmYWxzZQoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQlpZiAoICF0aGlzLm9wdGlvbnMuZW5oYW5jZWQgKSB7CgkJCXRoaXMuZWxlbWVudC5hZGRDbGFzcyggdGhpcy5vcHRpb25zLmNsYXNzZXMudGFibGUgKTsKCQl9CgoJCS8vIGV4dGVuZCBoZXJlLCBhc3NpZ24gb24gcmVmcmVzaCA+IF9zZXRIZWFkZXJzCgkJJC5leHRlbmQoIHRoaXMsIHsKCgkJCS8vIEV4cG9zZSBoZWFkZXJzIGFuZCBhbGxIZWFkZXJzIHByb3BlcnRpZXMgb24gdGhlIHdpZGdldAoJCQkvLyBoZWFkZXJzIHJlZmVyZW5jZXMgdGhlIFRIcyB3aXRoaW4gdGhlIGZpcnN0IFRSIGluIHRoZSB0YWJsZQoJCQloZWFkZXJzOiB1bmRlZmluZWQsCgoJCQkvLyBhbGxIZWFkZXJzIHJlZmVyZW5jZXMgaGVhZGVycywgcGx1cyBhbGwgVEhzIGluIHRoZSB0aGVhZCwgd2hpY2ggbWF5CgkJCS8vIGluY2x1ZGUgc2V2ZXJhbCByb3dzLCBvciBub3QKCQkJYWxsSGVhZGVyczogdW5kZWZpbmVkCgkJfSk7CgoJCXRoaXMuX3JlZnJlc2goIHRydWUgKTsKCX0sCgoJX3NldEhlYWRlcnM6IGZ1bmN0aW9uKCkgewoJCXZhciB0cnMgPSB0aGlzLmVsZW1lbnQuZmluZCggInRoZWFkIHRyIiApOwoKCQl0aGlzLmhlYWRlcnMgPSB0aGlzLmVsZW1lbnQuZmluZCggInRyOmVxKDApIiApLmNoaWxkcmVuKCk7CgkJdGhpcy5hbGxIZWFkZXJzID0gdGhpcy5oZWFkZXJzLmFkZCggdHJzLmNoaWxkcmVuKCkgKTsKCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJdGhpcy5fcmVmcmVzaCgpOwoJfSwKCglyZWJ1aWxkOiAkLm5vb3AsCgoJX3JlZnJlc2g6IGZ1bmN0aW9uKCAvKiBjcmVhdGUgKi8gKSB7CgkJdmFyIHRhYmxlID0gdGhpcy5lbGVtZW50LAoJCQl0cnMgPSB0YWJsZS5maW5kKCAidGhlYWQgdHIiICk7CgoJCS8vIHVwZGF0aW5nIGhlYWRlcnMgb24gcmVmcmVzaCAoZml4ZXMgIzU4ODApCgkJdGhpcy5fc2V0SGVhZGVycygpOwoKCQkvLyBJdGVyYXRlIG92ZXIgdGhlIHRycwoJCXRycy5lYWNoKCBmdW5jdGlvbigpIHsKCQkJdmFyIGNvbHVtbkNvdW50ID0gMDsKCgkJCS8vIEl0ZXJhdGUgb3ZlciB0aGUgY2hpbGRyZW4gb2YgdGhlIHRyCgkJCSQoIHRoaXMgKS5jaGlsZHJlbigpLmVhY2goIGZ1bmN0aW9uKCkgewoJCQkJdmFyIHNwYW4gPSBwYXJzZUludCggdGhpcy5nZXRBdHRyaWJ1dGUoICJjb2xzcGFuIiApLCAxMCApLAoJCQkJCXNlbGVjdG9yID0gIjpudGgtY2hpbGQoIiArICggY29sdW1uQ291bnQgKyAxICkgKyAiKSIsCgkJCQkJajsKCgkJCQl0aGlzLnNldEF0dHJpYnV0ZSggImRhdGEtIiArICQubW9iaWxlLm5zICsgImNvbHN0YXJ0IiwgY29sdW1uQ291bnQgKyAxICk7CgoJCQkJaWYgKCBzcGFuICkgewoJCQkJCWZvciggaiA9IDA7IGogPCBzcGFuIC0gMTsgaisrICkgewoJCQkJCQljb2x1bW5Db3VudCsrOwoJCQkJCQlzZWxlY3RvciArPSAiLCA6bnRoLWNoaWxkKCIgKyAoIGNvbHVtbkNvdW50ICsgMSApICsgIikiOwoJCQkJCX0KCQkJCX0KCgkJCQkvLyBTdG9yZSAiY2VsbHMiIGRhdGEgb24gaGVhZGVyIGFzIGEgcmVmZXJlbmNlIHRvIGFsbCBjZWxscyBpbiB0aGUgCgkJCQkvLyBzYW1lIGNvbHVtbiBhcyB0aGlzIFRICgkJCQkkKCB0aGlzICkuanFtRGF0YSggImNlbGxzIiwgdGFibGUuZmluZCggInRyIiApLm5vdCggdHJzLmVxKCAwICkgKS5ub3QoIHRoaXMgKS5jaGlsZHJlbiggc2VsZWN0b3IgKSApOwoKCQkJCWNvbHVtbkNvdW50Kys7CgkJCX0pOwoJCX0pOwoJfQp9KTsKCn0pKCBqUXVlcnkgKTsKCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLnRhYmxlIiwgJC5tb2JpbGUudGFibGUsIHsKCW9wdGlvbnM6IHsKCQltb2RlOiAiY29sdW1udG9nZ2xlIiwKCQljb2x1bW5CdG5UaGVtZTogbnVsbCwKCQljb2x1bW5Qb3B1cFRoZW1lOiBudWxsLAoJCWNvbHVtbkJ0blRleHQ6ICJDb2x1bW5zLi4uIiwKCQljbGFzc2VzOiAkLmV4dGVuZCggJC5tb2JpbGUudGFibGUucHJvdG90eXBlLm9wdGlvbnMuY2xhc3NlcywgewoJCQlwb3B1cDogInVpLXRhYmxlLWNvbHVtbnRvZ2dsZS1wb3B1cCIsCgkJCWNvbHVtbkJ0bjogInVpLXRhYmxlLWNvbHVtbnRvZ2dsZS1idG4iLAoJCQlwcmlvcml0eVByZWZpeDogInVpLXRhYmxlLXByaW9yaXR5LSIsCgkJCWNvbHVtblRvZ2dsZVRhYmxlOiAidWktdGFibGUtY29sdW1udG9nZ2xlIgoJCX0pCgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3N1cGVyKCk7CgoJCWlmKCB0aGlzLm9wdGlvbnMubW9kZSAhPT0gImNvbHVtbnRvZ2dsZSIgKSB7CgkJCXJldHVybjsKCQl9CgoJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCV9tZW51OiBudWxsCgkJfSk7CgoJCWlmKCB0aGlzLm9wdGlvbnMuZW5oYW5jZWQgKSB7CgkJCXRoaXMuX21lbnUgPSB0aGlzLmRvY3VtZW50LmZpbmQoIHRoaXMuX2lkKCkgKyAiLXBvcHVwIiApLmNoaWxkcmVuKCkuZmlyc3QoKTsKCQl9IGVsc2UgewoJCQl0aGlzLl9tZW51ID0gdGhpcy5fZW5oYW5jZUNvbFRvZ2dsZSgpOwoJCQl0aGlzLmVsZW1lbnQuYWRkQ2xhc3MoIHRoaXMub3B0aW9ucy5jbGFzc2VzLmNvbHVtblRvZ2dsZVRhYmxlICk7CgkJfQoKCQl0aGlzLl9zZXR1cEV2ZW50cygpOwoKCQl0aGlzLl9zZXRUb2dnbGVTdGF0ZSgpOwoJfSwKCglfaWQ6IGZ1bmN0aW9uKCkgewoJCXJldHVybiAoIHRoaXMuZWxlbWVudC5hdHRyKCAiaWQiICkgfHwgKCB0aGlzLndpZGdldE5hbWUgKyB0aGlzLnV1aWQgKSApOwoJfSwKCglfc2V0dXBFdmVudHM6IGZ1bmN0aW9uKCkgewoJCS8vTk9URTogaW5wdXRzIGFyZSBib3VuZCBpbiBiaW5kVG9nZ2xlcywKCQkvLyBzbyBpdCBjYW4gYmUgY2FsbGVkIG9uIHJlZnJlc2gsIHRvbwoKCQkvLyB1cGRhdGUgY29sdW1uIHRvZ2dsZXMgb24gcmVzaXplCgkJdGhpcy5fb24oIHRoaXMud2luZG93LCB7CgkJCXRocm90dGxlZHJlc2l6ZTogIl9zZXRUb2dnbGVTdGF0ZSIKCQl9KTsKCX0sCgoJX2JpbmRUb2dnbGVzOiBmdW5jdGlvbiggbWVudSApIHsKCQl2YXIgaW5wdXRzID0gbWVudS5maW5kKCAiaW5wdXQiICk7CgoJCXRoaXMuX29uKCBpbnB1dHMsIHsKCQkJY2hhbmdlOiAiX21lbnVJbnB1dENoYW5nZSIKCQl9KTsKCX0sCgoJX2FkZFRvZ2dsZXM6IGZ1bmN0aW9uKCBtZW51LCBrZWVwICkgewoJCXZhciBvcHRzID0gdGhpcy5vcHRpb25zOwoKCQkvLyBhbGxvdyB1cGRhdGUgb2YgbWVudSBvbiByZWZyZXNoIChmaXhlcyAjNTg4MCkKCQlpZiAoICFrZWVwICkgewoJCQltZW51LmVtcHR5KCk7CgkJfQoKCQkvLyBjcmVhdGUgdGhlIGhpZGUvc2hvdyB0b2dnbGVzCgkJdGhpcy5oZWFkZXJzLm5vdCggInRkIiApLmVhY2goIGZ1bmN0aW9uKCkgewoJCQl2YXIgaGVhZGVyID0gJCggdGhpcyApLAoJCQkJcHJpb3JpdHkgPSAkLm1vYmlsZS5nZXRBdHRyaWJ1dGUoIHRoaXMsICJwcmlvcml0eSIgKSwKCQkJCWNlbGxzID0gaGVhZGVyLmFkZCggaGVhZGVyLmpxbURhdGEoICJjZWxscyIgKSApOwoKCQkJaWYoIHByaW9yaXR5ICkgewoJCQkJY2VsbHMuYWRkQ2xhc3MoIG9wdHMuY2xhc3Nlcy5wcmlvcml0eVByZWZpeCArIHByaW9yaXR5ICk7CgoJCQkJaWYgKCAha2VlcCApIHsKCQkJCQkkKCI8bGFiZWw+PGlucHV0IHR5cGU9J2NoZWNrYm94JyBjaGVja2VkIC8+IiArCgkJCQkJCSggaGVhZGVyLmNoaWxkcmVuKCAiYWJiciIgKS5maXJzdCgpLmF0dHIoICJ0aXRsZSIgKSB8fAoJCQkJCQkJaGVhZGVyLnRleHQoKSApICsKCQkJCQkJIjwvbGFiZWw+IiApCgkJCQkJCS5hcHBlbmRUbyggbWVudSApCgkJCQkJCS5jaGlsZHJlbiggMCApCgkJCQkJCS5qcW1EYXRhKCAiY2VsbHMiLCBjZWxscyApCgkJCQkJCS5jaGVja2JveHJhZGlvKCB7CgkJCQkJCQl0aGVtZTogb3B0cy5jb2x1bW5Qb3B1cFRoZW1lCgkJCQkJCX0pOwoJCQkJfQoJCQl9CgkJfSk7CgoJCS8vIHNldCBiaW5kaW5ncyBoZXJlCgkJaWYgKCAha2VlcCApIHsKCQkJdGhpcy5fYmluZFRvZ2dsZXMoIG1lbnUgKTsKCQl9Cgl9LAoKCV9tZW51SW5wdXRDaGFuZ2U6IGZ1bmN0aW9uKCBldnQgKSB7CgkJdmFyIGlucHV0ID0gJCggZXZ0LnRhcmdldCApLAoJCQljaGVja2VkID0gaW5wdXRbIDAgXS5jaGVja2VkOwoKCQlpbnB1dC5qcW1EYXRhKCAiY2VsbHMiICkKCQkJLnRvZ2dsZUNsYXNzKCAidWktdGFibGUtY2VsbC1oaWRkZW4iLCAhY2hlY2tlZCApCgkJCS50b2dnbGVDbGFzcyggInVpLXRhYmxlLWNlbGwtdmlzaWJsZSIsIGNoZWNrZWQgKTsKCgkJaWYgKCBpbnB1dFsgMCBdLmdldEF0dHJpYnV0ZSggImxvY2tlZCIgKSApIHsKCQkJaW5wdXQucmVtb3ZlQXR0ciggImxvY2tlZCIgKTsKCgkJCXRoaXMuX3VubG9ja0NlbGxzKCBpbnB1dC5qcW1EYXRhKCAiY2VsbHMiICkgKTsKCQl9IGVsc2UgewoJCQlpbnB1dC5hdHRyKCAibG9ja2VkIiwgdHJ1ZSApOwoJCX0KCX0sCgoJX3VubG9ja0NlbGxzOiBmdW5jdGlvbiggY2VsbHMgKSB7CgkJLy8gYWxsb3cgaGlkZS9zaG93IHZpYSBDU1Mgb25seSA9IHJlbW92ZSBhbGwgdG9nZ2xlLWxvY2tzCgkJY2VsbHMucmVtb3ZlQ2xhc3MoICJ1aS10YWJsZS1jZWxsLWhpZGRlbiB1aS10YWJsZS1jZWxsLXZpc2libGUiKTsKCX0sCgoJX2VuaGFuY2VDb2xUb2dnbGU6IGZ1bmN0aW9uKCkgewoJCXZhciBpZCAsIG1lbnVCdXR0b24sIHBvcHVwLCBtZW51LAoJCQl0YWJsZSA9IHRoaXMuZWxlbWVudCwKCQkJb3B0cyA9IHRoaXMub3B0aW9ucywKCQkJbnMgPSAkLm1vYmlsZS5ucywKCQkJZnJhZ21lbnQgPSB0aGlzLmRvY3VtZW50WyAwIF0uY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpOwoKCQlpZCA9IHRoaXMuX2lkKCkgKyAiLXBvcHVwIjsKCQltZW51QnV0dG9uID0gJCggIjxhIHJvbGU9J2J1dHRvbicgaHJlZj0nIyIgKyBpZCArICInICIgKwoJCQkiY2xhc3M9JyIgKyBvcHRzLmNsYXNzZXMuY29sdW1uQnRuICsgIiB1aS1idG4gdWktYnRuLSIgKyAoIG9wdHMuY29sdW1uQnRuVGhlbWUgfHwgImEiICkgKyAiIHVpLWNvcm5lci1hbGwgdWktc2hhZG93IHVpLW1pbmknICIgKwoJCQkiZGF0YS0iICsgbnMgKyAicmVsPSdwb3B1cCcgIiArCgkJCSJkYXRhLSIgKyBucyArICJtaW5pPSd0cnVlJz4iICsgb3B0cy5jb2x1bW5CdG5UZXh0ICsgIjwvYT4iICk7CgkJcG9wdXAgPSAkKCAiPGRpdiBkYXRhLSIgKyBucyArICJyb2xlPSdwb3B1cCcgZGF0YS0iICsgbnMgKyAicm9sZT0nZmllbGRjb250YWluJyBjbGFzcz0nIiArIG9wdHMuY2xhc3Nlcy5wb3B1cCArICInIGlkPSciICsgaWQgKyAiJz48L2Rpdj4iICk7CgkJbWVudSA9ICQoICI8ZmllbGRzZXQgZGF0YS0iICsgbnMgKyAicm9sZT0nY29udHJvbGdyb3VwJz48L2ZpZWxkc2V0PiIgKTsKCgkJLy8gc2V0IGV4dGVuc2lvbiBoZXJlLCBzZW5kICJmYWxzZSIgdG8gdHJpZ2dlciBidWlsZC9yZWJ1aWxkCgkJdGhpcy5fYWRkVG9nZ2xlcyggbWVudSwgZmFsc2UgKTsKCgkJbWVudS5hcHBlbmRUbyggcG9wdXAgKTsKCgkJZnJhZ21lbnQuYXBwZW5kQ2hpbGQoIHBvcHVwWyAwIF0gKTsKCQlmcmFnbWVudC5hcHBlbmRDaGlsZCggbWVudUJ1dHRvblsgMCBdICk7CgkJdGFibGUuYmVmb3JlKCBmcmFnbWVudCApOwoKCQlwb3B1cC5wb3B1cCgpLmVuaGFuY2VXaXRoaW4oKTsKCgkJcmV0dXJuIG1lbnU7Cgl9LAoKCXJlYnVpbGQ6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3N1cGVyKCk7CgoJCWlmICggdGhpcy5vcHRpb25zLm1vZGUgPT09ICJjb2x1bW50b2dnbGUiICkgewoJCQkvLyBOT1RFOiByZWJ1aWxkIHBhc3NlcyAiZmFsc2UiLCB3aGlsZSByZWZyZXNoIHBhc3NlcyAidW5kZWZpbmVkIgoJCQkvLyBib3RoIHJlZnJlc2ggdGhlIHRhYmxlLCBidXQgaW5zaWRlIGFkZFRvZ2dsZXMsICFmYWxzZSB3aWxsIGJlIHRydWUsCgkJCS8vIHNvIGEgcmVidWlsZCBjYWxsIGNhbiBiZSBpbmRlbnRpZmllZAoJCQl0aGlzLl9yZWZyZXNoKCBmYWxzZSApOwoJCX0KCX0sCgoJX3JlZnJlc2g6IGZ1bmN0aW9uKCBjcmVhdGUgKSB7CgkJdGhpcy5fc3VwZXIoIGNyZWF0ZSApOwoKCQlpZiAoICFjcmVhdGUgJiYgdGhpcy5vcHRpb25zLm1vZGUgPT09ICJjb2x1bW50b2dnbGUiICkgewoJCQkvLyBjb2x1bW5zIG5vdCBiZWluZyByZXBsYWNlZCBtdXN0IGJlIGNsZWFyZWQgZnJvbSBpbnB1dCB0b2dnbGUtbG9ja3MKCQkJdGhpcy5fdW5sb2NrQ2VsbHMoIHRoaXMuYWxsSGVhZGVycyApOwoKCQkJLy8gdXBkYXRlIGNvbHVtbnRvZ2dsZXMgYW5kIGNlbGxzCgkJCXRoaXMuX2FkZFRvZ2dsZXMoIHRoaXMuX21lbnUsIGNyZWF0ZSApOwoKCQkJLy8gY2hlY2svdW5jaGVjawoJCQl0aGlzLl9zZXRUb2dnbGVTdGF0ZSgpOwoJCX0KCX0sCgoJX3NldFRvZ2dsZVN0YXRlOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9tZW51LmZpbmQoICJpbnB1dCIgKS5lYWNoKCBmdW5jdGlvbigpIHsKCQkJdmFyIGNoZWNrYm94ID0gJCggdGhpcyApOwoKCQkJdGhpcy5jaGVja2VkID0gY2hlY2tib3guanFtRGF0YSggImNlbGxzIiApLmVxKCAwICkuY3NzKCAiZGlzcGxheSIgKSA9PT0gInRhYmxlLWNlbGwiOwoJCQljaGVja2JveC5jaGVja2JveHJhZGlvKCAicmVmcmVzaCIgKTsKCQl9KTsKCX0sCgoJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3N1cGVyKCk7Cgl9Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS50YWJsZSIsICQubW9iaWxlLnRhYmxlLCB7CglvcHRpb25zOiB7CgkJbW9kZTogInJlZmxvdyIsCgkJY2xhc3NlczogJC5leHRlbmQoICQubW9iaWxlLnRhYmxlLnByb3RvdHlwZS5vcHRpb25zLmNsYXNzZXMsIHsKCQkJcmVmbG93VGFibGU6ICJ1aS10YWJsZS1yZWZsb3ciLAoJCQljZWxsTGFiZWxzOiAidWktdGFibGUtY2VsbC1sYWJlbCIKCQl9KQoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9zdXBlcigpOwoKCQkvLyBJZiBpdCdzIG5vdCByZWZsb3cgbW9kZSwgcmV0dXJuIGhlcmUuCgkJaWYoIHRoaXMub3B0aW9ucy5tb2RlICE9PSAicmVmbG93IiApIHsKCQkJcmV0dXJuOwoJCX0KCgkJaWYoICF0aGlzLm9wdGlvbnMuZW5oYW5jZWQgKSB7CgkJCXRoaXMuZWxlbWVudC5hZGRDbGFzcyggdGhpcy5vcHRpb25zLmNsYXNzZXMucmVmbG93VGFibGUgKTsKCgkJCXRoaXMuX3VwZGF0ZVJlZmxvdygpOwoJCX0KCX0sCgoJcmVidWlsZDogZnVuY3Rpb24oKSB7CgkJdGhpcy5fc3VwZXIoKTsKCgkJaWYgKCB0aGlzLm9wdGlvbnMubW9kZSA9PT0gInJlZmxvdyIgKSB7CgkJCXRoaXMuX3JlZnJlc2goIGZhbHNlICk7CgkJfQoJfSwKCglfcmVmcmVzaDogZnVuY3Rpb24oIGNyZWF0ZSApIHsKCQl0aGlzLl9zdXBlciggY3JlYXRlICk7CgkJaWYgKCAhY3JlYXRlICYmIHRoaXMub3B0aW9ucy5tb2RlID09PSAicmVmbG93IiApIHsKCQkJdGhpcy5fdXBkYXRlUmVmbG93KCApOwoJCX0KCX0sCgoJX3VwZGF0ZVJlZmxvdzogZnVuY3Rpb24oKSB7CgkJdmFyIHRhYmxlID0gdGhpcywKCQkJb3B0cyA9IHRoaXMub3B0aW9uczsKCgkJLy8gZ2V0IGhlYWRlcnMgaW4gcmV2ZXJzZSBvcmRlciBzbyB0aGF0IHRvcC1sZXZlbCBoZWFkZXJzIGFyZSBhcHBlbmRlZCBsYXN0CgkJJCggdGFibGUuYWxsSGVhZGVycy5nZXQoKS5yZXZlcnNlKCkgKS5lYWNoKCBmdW5jdGlvbigpIHsKCQkJdmFyIGNlbGxzID0gJCggdGhpcyApLmpxbURhdGEoICJjZWxscyIgKSwKCQkJCWNvbHN0YXJ0ID0gJC5tb2JpbGUuZ2V0QXR0cmlidXRlKCB0aGlzLCAiY29sc3RhcnQiICksCgkJCQloaWVyYXJjaHlDbGFzcyA9IGNlbGxzLm5vdCggdGhpcyApLmZpbHRlciggInRoZWFkIHRoIiApLmxlbmd0aCAmJiAiIHVpLXRhYmxlLWNlbGwtbGFiZWwtdG9wIiwKCQkJCXRleHQgPSAkKCB0aGlzICkudGV4dCgpLAoJCQkJaXRlcmF0aW9uLCBmaWx0ZXI7CgoJCQkJaWYgKCB0ZXh0ICE9PSAiIiAgKSB7CgoJCQkJCWlmKCBoaWVyYXJjaHlDbGFzcyApIHsKCQkJCQkJaXRlcmF0aW9uID0gcGFyc2VJbnQoIHRoaXMuZ2V0QXR0cmlidXRlKCAiY29sc3BhbiIgKSwgMTAgKTsKCQkJCQkJZmlsdGVyID0gIiI7CgoJCQkJCQlpZiAoIGl0ZXJhdGlvbiApewoJCQkJCQkJZmlsdGVyID0gInRkOm50aC1jaGlsZCgiKyBpdGVyYXRpb24gKyJuICsgIiArICggY29sc3RhcnQgKSArIikiOwoJCQkJCQl9CgoJCQkJCQl0YWJsZS5fYWRkTGFiZWxzKCBjZWxscy5maWx0ZXIoIGZpbHRlciApLCBvcHRzLmNsYXNzZXMuY2VsbExhYmVscyArIGhpZXJhcmNoeUNsYXNzLCB0ZXh0ICk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJdGFibGUuX2FkZExhYmVscyggY2VsbHMsIG9wdHMuY2xhc3Nlcy5jZWxsTGFiZWxzLCB0ZXh0ICk7CgkJCQkJfQoKCQkJCX0KCQl9KTsKCX0sCgoJX2FkZExhYmVsczogZnVuY3Rpb24oIGNlbGxzLCBsYWJlbCwgdGV4dCApIHsKCQkvLyAubm90IGZpeGVzICM2MDA2CgkJY2VsbHMubm90KCAiOmhhcyhiLiIgKyBsYWJlbCArICIpIiApLnByZXBlbmQoICI8YiBjbGFzcz0nIiArIGxhYmVsICsgIic+IiArIHRleHQgKyAiPC9iPiIgICk7Cgl9Cn0pOwoKfSkoIGpRdWVyeSApOwoKLyohCiAqIGpRdWVyeSBVSSBUYWJzIEBWRVJTSU9OCiAqIGh0dHA6Ly9qcXVlcnl1aS5jb20KICoKICogQ29weXJpZ2h0IDIwMTMgalF1ZXJ5IEZvdW5kYXRpb24gYW5kIG90aGVyIGNvbnRyaWJ1dG9ycwogKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuCiAqIGh0dHA6Ly9qcXVlcnkub3JnL2xpY2Vuc2UKICoKICogaHR0cDovL2FwaS5qcXVlcnl1aS5jb20vdGFicy8KICoKICogRGVwZW5kczoKICoJanF1ZXJ5LnVpLmNvcmUuanMKICoJanF1ZXJ5LnVpLndpZGdldC5qcwogKi8KKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7Cgp2YXIgdGFiSWQgPSAwLAoJcmhhc2ggPSAvIy4qJC87CgpmdW5jdGlvbiBnZXROZXh0VGFiSWQoKSB7CglyZXR1cm4gKyt0YWJJZDsKfQoKZnVuY3Rpb24gaXNMb2NhbCggYW5jaG9yICkgewoJcmV0dXJuIGFuY2hvci5oYXNoLmxlbmd0aCA+IDEgJiYKCQlkZWNvZGVVUklDb21wb25lbnQoIGFuY2hvci5ocmVmLnJlcGxhY2UoIHJoYXNoLCAiIiApICkgPT09CgkJCWRlY29kZVVSSUNvbXBvbmVudCggbG9jYXRpb24uaHJlZi5yZXBsYWNlKCByaGFzaCwgIiIgKSApOwp9CgokLndpZGdldCggInVpLnRhYnMiLCB7Cgl2ZXJzaW9uOiAiQFZFUlNJT04iLAoJZGVsYXk6IDMwMCwKCW9wdGlvbnM6IHsKCQlhY3RpdmU6IG51bGwsCgkJY29sbGFwc2libGU6IGZhbHNlLAoJCWV2ZW50OiAiY2xpY2siLAoJCWhlaWdodFN0eWxlOiAiY29udGVudCIsCgkJaGlkZTogbnVsbCwKCQlzaG93OiBudWxsLAoKCQkvLyBjYWxsYmFja3MKCQlhY3RpdmF0ZTogbnVsbCwKCQliZWZvcmVBY3RpdmF0ZTogbnVsbCwKCQliZWZvcmVMb2FkOiBudWxsLAoJCWxvYWQ6IG51bGwKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdmFyIHRoYXQgPSB0aGlzLAoJCQlvcHRpb25zID0gdGhpcy5vcHRpb25zOwoKCQl0aGlzLnJ1bm5pbmcgPSBmYWxzZTsKCgkJdGhpcy5lbGVtZW50CgkJCS5hZGRDbGFzcyggInVpLXRhYnMgdWktd2lkZ2V0IHVpLXdpZGdldC1jb250ZW50IHVpLWNvcm5lci1hbGwiICkKCQkJLnRvZ2dsZUNsYXNzKCAidWktdGFicy1jb2xsYXBzaWJsZSIsIG9wdGlvbnMuY29sbGFwc2libGUgKQoJCQkvLyBQcmV2ZW50IHVzZXJzIGZyb20gZm9jdXNpbmcgZGlzYWJsZWQgdGFicyB2aWEgY2xpY2sKCQkJLmRlbGVnYXRlKCAiLnVpLXRhYnMtbmF2ID4gbGkiLCAibW91c2Vkb3duIiArIHRoaXMuZXZlbnROYW1lc3BhY2UsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCWlmICggJCggdGhpcyApLmlzKCAiLnVpLXN0YXRlLWRpc2FibGVkIiApICkgewoJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQl9CgkJCX0pCgkJCS8vIHN1cHBvcnQ6IElFIDw5CgkJCS8vIFByZXZlbnRpbmcgdGhlIGRlZmF1bHQgYWN0aW9uIGluIG1vdXNlZG93biBkb2Vzbid0IHByZXZlbnQgSUUKCQkJLy8gZnJvbSBmb2N1c2luZyB0aGUgZWxlbWVudCwgc28gaWYgdGhlIGFuY2hvciBnZXRzIGZvY3VzZWQsIGJsdXIuCgkJCS8vIFdlIGRvbid0IGhhdmUgdG8gd29ycnkgYWJvdXQgZm9jdXNpbmcgdGhlIHByZXZpb3VzbHkgZm9jdXNlZAoJCQkvLyBlbGVtZW50IHNpbmNlIGNsaWNraW5nIG9uIGEgbm9uLWZvY3VzYWJsZSBlbGVtZW50IHNob3VsZCBmb2N1cwoJCQkvLyB0aGUgYm9keSBhbnl3YXkuCgkJCS5kZWxlZ2F0ZSggIi51aS10YWJzLWFuY2hvciIsICJmb2N1cyIgKyB0aGlzLmV2ZW50TmFtZXNwYWNlLCBmdW5jdGlvbigpIHsKCQkJCWlmICggJCggdGhpcyApLmNsb3Nlc3QoICJsaSIgKS5pcyggIi51aS1zdGF0ZS1kaXNhYmxlZCIgKSApIHsKCQkJCQl0aGlzLmJsdXIoKTsKCQkJCX0KCQkJfSk7CgoJCXRoaXMuX3Byb2Nlc3NUYWJzKCk7CgkJb3B0aW9ucy5hY3RpdmUgPSB0aGlzLl9pbml0aWFsQWN0aXZlKCk7CgoJCS8vIFRha2UgZGlzYWJsaW5nIHRhYnMgdmlhIGNsYXNzIGF0dHJpYnV0ZSBmcm9tIEhUTUwKCQkvLyBpbnRvIGFjY291bnQgYW5kIHVwZGF0ZSBvcHRpb24gcHJvcGVybHkuCgkJaWYgKCAkLmlzQXJyYXkoIG9wdGlvbnMuZGlzYWJsZWQgKSApIHsKCQkJb3B0aW9ucy5kaXNhYmxlZCA9ICQudW5pcXVlKCBvcHRpb25zLmRpc2FibGVkLmNvbmNhdCgKCQkJCSQubWFwKCB0aGlzLnRhYnMuZmlsdGVyKCAiLnVpLXN0YXRlLWRpc2FibGVkIiApLCBmdW5jdGlvbiggbGkgKSB7CgkJCQkJcmV0dXJuIHRoYXQudGFicy5pbmRleCggbGkgKTsKCQkJCX0pCgkJCSkgKS5zb3J0KCk7CgkJfQoKCQkvLyBjaGVjayBmb3IgbGVuZ3RoIGF2b2lkcyBlcnJvciB3aGVuIGluaXRpYWxpemluZyBlbXB0eSBsaXN0CgkJaWYgKCB0aGlzLm9wdGlvbnMuYWN0aXZlICE9PSBmYWxzZSAmJiB0aGlzLmFuY2hvcnMubGVuZ3RoICkgewoJCQl0aGlzLmFjdGl2ZSA9IHRoaXMuX2ZpbmRBY3RpdmUoIG9wdGlvbnMuYWN0aXZlICk7CgkJfSBlbHNlIHsKCQkJdGhpcy5hY3RpdmUgPSAkKCk7CgkJfQoKCQl0aGlzLl9yZWZyZXNoKCk7CgoJCWlmICggdGhpcy5hY3RpdmUubGVuZ3RoICkgewoJCQl0aGlzLmxvYWQoIG9wdGlvbnMuYWN0aXZlICk7CgkJfQoJfSwKCglfaW5pdGlhbEFjdGl2ZTogZnVuY3Rpb24oKSB7CgkJdmFyIGFjdGl2ZSA9IHRoaXMub3B0aW9ucy5hY3RpdmUsCgkJCWNvbGxhcHNpYmxlID0gdGhpcy5vcHRpb25zLmNvbGxhcHNpYmxlLAoJCQlsb2NhdGlvbkhhc2ggPSBsb2NhdGlvbi5oYXNoLnN1YnN0cmluZyggMSApOwoKCQlpZiAoIGFjdGl2ZSA9PT0gbnVsbCApIHsKCQkJLy8gY2hlY2sgdGhlIGZyYWdtZW50IGlkZW50aWZpZXIgaW4gdGhlIFVSTAoJCQlpZiAoIGxvY2F0aW9uSGFzaCApIHsKCQkJCXRoaXMudGFicy5lYWNoKGZ1bmN0aW9uKCBpLCB0YWIgKSB7CgkJCQkJaWYgKCAkKCB0YWIgKS5hdHRyKCAiYXJpYS1jb250cm9scyIgKSA9PT0gbG9jYXRpb25IYXNoICkgewoJCQkJCQlhY3RpdmUgPSBpOwoJCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQkJfQoJCQkJfSk7CgkJCX0KCgkJCS8vIGNoZWNrIGZvciBhIHRhYiBtYXJrZWQgYWN0aXZlIHZpYSBhIGNsYXNzCgkJCWlmICggYWN0aXZlID09PSBudWxsICkgewoJCQkJYWN0aXZlID0gdGhpcy50YWJzLmluZGV4KCB0aGlzLnRhYnMuZmlsdGVyKCAiLnVpLXRhYnMtYWN0aXZlIiApICk7CgkJCX0KCgkJCS8vIG5vIGFjdGl2ZSB0YWIsIHNldCB0byBmYWxzZQoJCQlpZiAoIGFjdGl2ZSA9PT0gbnVsbCB8fCBhY3RpdmUgPT09IC0xICkgewoJCQkJYWN0aXZlID0gdGhpcy50YWJzLmxlbmd0aCA/IDAgOiBmYWxzZTsKCQkJfQoJCX0KCgkJLy8gaGFuZGxlIG51bWJlcnM6IG5lZ2F0aXZlLCBvdXQgb2YgcmFuZ2UKCQlpZiAoIGFjdGl2ZSAhPT0gZmFsc2UgKSB7CgkJCWFjdGl2ZSA9IHRoaXMudGFicy5pbmRleCggdGhpcy50YWJzLmVxKCBhY3RpdmUgKSApOwoJCQlpZiAoIGFjdGl2ZSA9PT0gLTEgKSB7CgkJCQlhY3RpdmUgPSBjb2xsYXBzaWJsZSA/IGZhbHNlIDogMDsKCQkJfQoJCX0KCgkJLy8gZG9uJ3QgYWxsb3cgY29sbGFwc2libGU6IGZhbHNlIGFuZCBhY3RpdmU6IGZhbHNlCgkJaWYgKCAhY29sbGFwc2libGUgJiYgYWN0aXZlID09PSBmYWxzZSAmJiB0aGlzLmFuY2hvcnMubGVuZ3RoICkgewoJCQlhY3RpdmUgPSAwOwoJCX0KCgkJcmV0dXJuIGFjdGl2ZTsKCX0sCgoJX2dldENyZWF0ZUV2ZW50RGF0YTogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHsKCQkJdGFiOiB0aGlzLmFjdGl2ZSwKCQkJcGFuZWw6ICF0aGlzLmFjdGl2ZS5sZW5ndGggPyAkKCkgOiB0aGlzLl9nZXRQYW5lbEZvclRhYiggdGhpcy5hY3RpdmUgKQoJCX07Cgl9LAoKCV90YWJLZXlkb3duOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJdmFyIGZvY3VzZWRUYWIgPSAkKCB0aGlzLmRvY3VtZW50WzBdLmFjdGl2ZUVsZW1lbnQgKS5jbG9zZXN0KCAibGkiICksCgkJCXNlbGVjdGVkSW5kZXggPSB0aGlzLnRhYnMuaW5kZXgoIGZvY3VzZWRUYWIgKSwKCQkJZ29pbmdGb3J3YXJkID0gdHJ1ZTsKCgkJaWYgKCB0aGlzLl9oYW5kbGVQYWdlTmF2KCBldmVudCApICkgewoJCQlyZXR1cm47CgkJfQoKCQlzd2l0Y2ggKCBldmVudC5rZXlDb2RlICkgewoJCQljYXNlICQudWkua2V5Q29kZS5SSUdIVDoKCQkJY2FzZSAkLnVpLmtleUNvZGUuRE9XTjoKCQkJCXNlbGVjdGVkSW5kZXgrKzsKCQkJCWJyZWFrOwoJCQljYXNlICQudWkua2V5Q29kZS5VUDoKCQkJY2FzZSAkLnVpLmtleUNvZGUuTEVGVDoKCQkJCWdvaW5nRm9yd2FyZCA9IGZhbHNlOwoJCQkJc2VsZWN0ZWRJbmRleC0tOwoJCQkJYnJlYWs7CgkJCWNhc2UgJC51aS5rZXlDb2RlLkVORDoKCQkJCXNlbGVjdGVkSW5kZXggPSB0aGlzLmFuY2hvcnMubGVuZ3RoIC0gMTsKCQkJCWJyZWFrOwoJCQljYXNlICQudWkua2V5Q29kZS5IT01FOgoJCQkJc2VsZWN0ZWRJbmRleCA9IDA7CgkJCQlicmVhazsKCQkJY2FzZSAkLnVpLmtleUNvZGUuU1BBQ0U6CgkJCQkvLyBBY3RpdmF0ZSBvbmx5LCBubyBjb2xsYXBzaW5nCgkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJY2xlYXJUaW1lb3V0KCB0aGlzLmFjdGl2YXRpbmcgKTsKCQkJCXRoaXMuX2FjdGl2YXRlKCBzZWxlY3RlZEluZGV4ICk7CgkJCQlyZXR1cm47CgkJCWNhc2UgJC51aS5rZXlDb2RlLkVOVEVSOgoJCQkJLy8gVG9nZ2xlIChjYW5jZWwgZGVsYXllZCBhY3RpdmF0aW9uLCBhbGxvdyBjb2xsYXBzaW5nKQoJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCWNsZWFyVGltZW91dCggdGhpcy5hY3RpdmF0aW5nICk7CgkJCQkvLyBEZXRlcm1pbmUgaWYgd2Ugc2hvdWxkIGNvbGxhcHNlIG9yIGFjdGl2YXRlCgkJCQl0aGlzLl9hY3RpdmF0ZSggc2VsZWN0ZWRJbmRleCA9PT0gdGhpcy5vcHRpb25zLmFjdGl2ZSA/IGZhbHNlIDogc2VsZWN0ZWRJbmRleCApOwoJCQkJcmV0dXJuOwoJCQlkZWZhdWx0OgoJCQkJcmV0dXJuOwoJCX0KCgkJLy8gRm9jdXMgdGhlIGFwcHJvcHJpYXRlIHRhYiwgYmFzZWQgb24gd2hpY2gga2V5IHdhcyBwcmVzc2VkCgkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQljbGVhclRpbWVvdXQoIHRoaXMuYWN0aXZhdGluZyApOwoJCXNlbGVjdGVkSW5kZXggPSB0aGlzLl9mb2N1c05leHRUYWIoIHNlbGVjdGVkSW5kZXgsIGdvaW5nRm9yd2FyZCApOwoKCQkvLyBOYXZpZ2F0aW5nIHdpdGggY29udHJvbCBrZXkgd2lsbCBwcmV2ZW50IGF1dG9tYXRpYyBhY3RpdmF0aW9uCgkJaWYgKCAhZXZlbnQuY3RybEtleSApIHsKCQkJLy8gVXBkYXRlIGFyaWEtc2VsZWN0ZWQgaW1tZWRpYXRlbHkgc28gdGhhdCBBVCB0aGluayB0aGUgdGFiIGlzIGFscmVhZHkgc2VsZWN0ZWQuCgkJCS8vIE90aGVyd2lzZSBBVCBtYXkgY29uZnVzZSB0aGUgdXNlciBieSBzdGF0aW5nIHRoYXQgdGhleSBuZWVkIHRvIGFjdGl2YXRlIHRoZSB0YWIsCgkJCS8vIGJ1dCB0aGUgdGFiIHdpbGwgYWxyZWFkeSBiZSBhY3RpdmF0ZWQgYnkgdGhlIHRpbWUgdGhlIGFubm91bmNlbWVudCBmaW5pc2hlcy4KCQkJZm9jdXNlZFRhYi5hdHRyKCAiYXJpYS1zZWxlY3RlZCIsICJmYWxzZSIgKTsKCQkJdGhpcy50YWJzLmVxKCBzZWxlY3RlZEluZGV4ICkuYXR0ciggImFyaWEtc2VsZWN0ZWQiLCAidHJ1ZSIgKTsKCgkJCXRoaXMuYWN0aXZhdGluZyA9IHRoaXMuX2RlbGF5KGZ1bmN0aW9uKCkgewoJCQkJdGhpcy5vcHRpb24oICJhY3RpdmUiLCBzZWxlY3RlZEluZGV4ICk7CgkJCX0sIHRoaXMuZGVsYXkgKTsKCQl9Cgl9LAoKCV9wYW5lbEtleWRvd246IGZ1bmN0aW9uKCBldmVudCApIHsKCQlpZiAoIHRoaXMuX2hhbmRsZVBhZ2VOYXYoIGV2ZW50ICkgKSB7CgkJCXJldHVybjsKCQl9CgoJCS8vIEN0cmwrdXAgbW92ZXMgZm9jdXMgdG8gdGhlIGN1cnJlbnQgdGFiCgkJaWYgKCBldmVudC5jdHJsS2V5ICYmIGV2ZW50LmtleUNvZGUgPT09ICQudWkua2V5Q29kZS5VUCApIHsKCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJdGhpcy5hY3RpdmUuZm9jdXMoKTsKCQl9Cgl9LAoKCS8vIEFsdCtwYWdlIHVwL2Rvd24gbW92ZXMgZm9jdXMgdG8gdGhlIHByZXZpb3VzL25leHQgdGFiIChhbmQgYWN0aXZhdGVzKQoJX2hhbmRsZVBhZ2VOYXY6IGZ1bmN0aW9uKCBldmVudCApIHsKCQlpZiAoIGV2ZW50LmFsdEtleSAmJiBldmVudC5rZXlDb2RlID09PSAkLnVpLmtleUNvZGUuUEFHRV9VUCApIHsKCQkJdGhpcy5fYWN0aXZhdGUoIHRoaXMuX2ZvY3VzTmV4dFRhYiggdGhpcy5vcHRpb25zLmFjdGl2ZSAtIDEsIGZhbHNlICkgKTsKCQkJcmV0dXJuIHRydWU7CgkJfQoJCWlmICggZXZlbnQuYWx0S2V5ICYmIGV2ZW50LmtleUNvZGUgPT09ICQudWkua2V5Q29kZS5QQUdFX0RPV04gKSB7CgkJCXRoaXMuX2FjdGl2YXRlKCB0aGlzLl9mb2N1c05leHRUYWIoIHRoaXMub3B0aW9ucy5hY3RpdmUgKyAxLCB0cnVlICkgKTsKCQkJcmV0dXJuIHRydWU7CgkJfQoJfSwKCglfZmluZE5leHRUYWI6IGZ1bmN0aW9uKCBpbmRleCwgZ29pbmdGb3J3YXJkICkgewoJCXZhciBsYXN0VGFiSW5kZXggPSB0aGlzLnRhYnMubGVuZ3RoIC0gMTsKCgkJZnVuY3Rpb24gY29uc3RyYWluKCkgewoJCQlpZiAoIGluZGV4ID4gbGFzdFRhYkluZGV4ICkgewoJCQkJaW5kZXggPSAwOwoJCQl9CgkJCWlmICggaW5kZXggPCAwICkgewoJCQkJaW5kZXggPSBsYXN0VGFiSW5kZXg7CgkJCX0KCQkJcmV0dXJuIGluZGV4OwoJCX0KCgkJd2hpbGUgKCAkLmluQXJyYXkoIGNvbnN0cmFpbigpLCB0aGlzLm9wdGlvbnMuZGlzYWJsZWQgKSAhPT0gLTEgKSB7CgkJCWluZGV4ID0gZ29pbmdGb3J3YXJkID8gaW5kZXggKyAxIDogaW5kZXggLSAxOwoJCX0KCgkJcmV0dXJuIGluZGV4OwoJfSwKCglfZm9jdXNOZXh0VGFiOiBmdW5jdGlvbiggaW5kZXgsIGdvaW5nRm9yd2FyZCApIHsKCQlpbmRleCA9IHRoaXMuX2ZpbmROZXh0VGFiKCBpbmRleCwgZ29pbmdGb3J3YXJkICk7CgkJdGhpcy50YWJzLmVxKCBpbmRleCApLmZvY3VzKCk7CgkJcmV0dXJuIGluZGV4OwoJfSwKCglfc2V0T3B0aW9uOiBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQlpZiAoIGtleSA9PT0gImFjdGl2ZSIgKSB7CgkJCS8vIF9hY3RpdmF0ZSgpIHdpbGwgaGFuZGxlIGludmFsaWQgdmFsdWVzIGFuZCB1cGRhdGUgdGhpcy5vcHRpb25zCgkJCXRoaXMuX2FjdGl2YXRlKCB2YWx1ZSApOwoJCQlyZXR1cm47CgkJfQoKCQlpZiAoIGtleSA9PT0gImRpc2FibGVkIiApIHsKCQkJLy8gZG9uJ3QgdXNlIHRoZSB3aWRnZXQgZmFjdG9yeSdzIGRpc2FibGVkIGhhbmRsaW5nCgkJCXRoaXMuX3NldHVwRGlzYWJsZWQoIHZhbHVlICk7CgkJCXJldHVybjsKCQl9CgoJCXRoaXMuX3N1cGVyKCBrZXksIHZhbHVlKTsKCgkJaWYgKCBrZXkgPT09ICJjb2xsYXBzaWJsZSIgKSB7CgkJCXRoaXMuZWxlbWVudC50b2dnbGVDbGFzcyggInVpLXRhYnMtY29sbGFwc2libGUiLCB2YWx1ZSApOwoJCQkvLyBTZXR0aW5nIGNvbGxhcHNpYmxlOiBmYWxzZSB3aGlsZSBjb2xsYXBzZWQ7IG9wZW4gZmlyc3QgcGFuZWwKCQkJaWYgKCAhdmFsdWUgJiYgdGhpcy5vcHRpb25zLmFjdGl2ZSA9PT0gZmFsc2UgKSB7CgkJCQl0aGlzLl9hY3RpdmF0ZSggMCApOwoJCQl9CgkJfQoKCQlpZiAoIGtleSA9PT0gImV2ZW50IiApIHsKCQkJdGhpcy5fc2V0dXBFdmVudHMoIHZhbHVlICk7CgkJfQoKCQlpZiAoIGtleSA9PT0gImhlaWdodFN0eWxlIiApIHsKCQkJdGhpcy5fc2V0dXBIZWlnaHRTdHlsZSggdmFsdWUgKTsKCQl9Cgl9LAoKCV90YWJJZDogZnVuY3Rpb24oIHRhYiApIHsKCQlyZXR1cm4gdGFiLmF0dHIoICJhcmlhLWNvbnRyb2xzIiApIHx8ICJ1aS10YWJzLSIgKyBnZXROZXh0VGFiSWQoKTsKCX0sCgoJX3Nhbml0aXplU2VsZWN0b3I6IGZ1bmN0aW9uKCBoYXNoICkgewoJCXJldHVybiBoYXNoID8gaGFzaC5yZXBsYWNlKCAvWyEiJCUmJygpKissLlwvOjs8PT4/QFxbXF1cXmB7fH1+XS9nLCAiXFwkJiIgKSA6ICIiOwoJfSwKCglyZWZyZXNoOiBmdW5jdGlvbigpIHsKCQl2YXIgb3B0aW9ucyA9IHRoaXMub3B0aW9ucywKCQkJbGlzID0gdGhpcy50YWJsaXN0LmNoaWxkcmVuKCAiOmhhcyhhW2hyZWZdKSIgKTsKCgkJLy8gZ2V0IGRpc2FibGVkIHRhYnMgZnJvbSBjbGFzcyBhdHRyaWJ1dGUgZnJvbSBIVE1MCgkJLy8gdGhpcyB3aWxsIGdldCBjb252ZXJ0ZWQgdG8gYSBib29sZWFuIGlmIG5lZWRlZCBpbiBfcmVmcmVzaCgpCgkJb3B0aW9ucy5kaXNhYmxlZCA9ICQubWFwKCBsaXMuZmlsdGVyKCAiLnVpLXN0YXRlLWRpc2FibGVkIiApLCBmdW5jdGlvbiggdGFiICkgewoJCQlyZXR1cm4gbGlzLmluZGV4KCB0YWIgKTsKCQl9KTsKCgkJdGhpcy5fcHJvY2Vzc1RhYnMoKTsKCgkJLy8gd2FzIGNvbGxhcHNlZCBvciBubyB0YWJzCgkJaWYgKCBvcHRpb25zLmFjdGl2ZSA9PT0gZmFsc2UgfHwgIXRoaXMuYW5jaG9ycy5sZW5ndGggKSB7CgkJCW9wdGlvbnMuYWN0aXZlID0gZmFsc2U7CgkJCXRoaXMuYWN0aXZlID0gJCgpOwoJCS8vIHdhcyBhY3RpdmUsIGJ1dCBhY3RpdmUgdGFiIGlzIGdvbmUKCQl9IGVsc2UgaWYgKCB0aGlzLmFjdGl2ZS5sZW5ndGggJiYgISQuY29udGFpbnMoIHRoaXMudGFibGlzdFsgMCBdLCB0aGlzLmFjdGl2ZVsgMCBdICkgKSB7CgkJCS8vIGFsbCByZW1haW5pbmcgdGFicyBhcmUgZGlzYWJsZWQKCQkJaWYgKCB0aGlzLnRhYnMubGVuZ3RoID09PSBvcHRpb25zLmRpc2FibGVkLmxlbmd0aCApIHsKCQkJCW9wdGlvbnMuYWN0aXZlID0gZmFsc2U7CgkJCQl0aGlzLmFjdGl2ZSA9ICQoKTsKCQkJLy8gYWN0aXZhdGUgcHJldmlvdXMgdGFiCgkJCX0gZWxzZSB7CgkJCQl0aGlzLl9hY3RpdmF0ZSggdGhpcy5fZmluZE5leHRUYWIoIE1hdGgubWF4KCAwLCBvcHRpb25zLmFjdGl2ZSAtIDEgKSwgZmFsc2UgKSApOwoJCQl9CgkJLy8gd2FzIGFjdGl2ZSwgYWN0aXZlIHRhYiBzdGlsbCBleGlzdHMKCQl9IGVsc2UgewoJCQkvLyBtYWtlIHN1cmUgYWN0aXZlIGluZGV4IGlzIGNvcnJlY3QKCQkJb3B0aW9ucy5hY3RpdmUgPSB0aGlzLnRhYnMuaW5kZXgoIHRoaXMuYWN0aXZlICk7CgkJfQoKCQl0aGlzLl9yZWZyZXNoKCk7Cgl9LAoKCV9yZWZyZXNoOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9zZXR1cERpc2FibGVkKCB0aGlzLm9wdGlvbnMuZGlzYWJsZWQgKTsKCQl0aGlzLl9zZXR1cEV2ZW50cyggdGhpcy5vcHRpb25zLmV2ZW50ICk7CgkJdGhpcy5fc2V0dXBIZWlnaHRTdHlsZSggdGhpcy5vcHRpb25zLmhlaWdodFN0eWxlICk7CgoJCXRoaXMudGFicy5ub3QoIHRoaXMuYWN0aXZlICkuYXR0cih7CgkJCSJhcmlhLXNlbGVjdGVkIjogImZhbHNlIiwKCQkJdGFiSW5kZXg6IC0xCgkJfSk7CgkJdGhpcy5wYW5lbHMubm90KCB0aGlzLl9nZXRQYW5lbEZvclRhYiggdGhpcy5hY3RpdmUgKSApCgkJCS5oaWRlKCkKCQkJLmF0dHIoewoJCQkJImFyaWEtZXhwYW5kZWQiOiAiZmFsc2UiLAoJCQkJImFyaWEtaGlkZGVuIjogInRydWUiCgkJCX0pOwoKCQkvLyBNYWtlIHN1cmUgb25lIHRhYiBpcyBpbiB0aGUgdGFiIG9yZGVyCgkJaWYgKCAhdGhpcy5hY3RpdmUubGVuZ3RoICkgewoJCQl0aGlzLnRhYnMuZXEoIDAgKS5hdHRyKCAidGFiSW5kZXgiLCAwICk7CgkJfSBlbHNlIHsKCQkJdGhpcy5hY3RpdmUKCQkJCS5hZGRDbGFzcyggInVpLXRhYnMtYWN0aXZlIHVpLXN0YXRlLWFjdGl2ZSIgKQoJCQkJLmF0dHIoewoJCQkJCSJhcmlhLXNlbGVjdGVkIjogInRydWUiLAoJCQkJCXRhYkluZGV4OiAwCgkJCQl9KTsKCQkJdGhpcy5fZ2V0UGFuZWxGb3JUYWIoIHRoaXMuYWN0aXZlICkKCQkJCS5zaG93KCkKCQkJCS5hdHRyKHsKCQkJCQkiYXJpYS1leHBhbmRlZCI6ICJ0cnVlIiwKCQkJCQkiYXJpYS1oaWRkZW4iOiAiZmFsc2UiCgkJCQl9KTsKCQl9Cgl9LAoKCV9wcm9jZXNzVGFiczogZnVuY3Rpb24oKSB7CgkJdmFyIHRoYXQgPSB0aGlzOwoKCQl0aGlzLnRhYmxpc3QgPSB0aGlzLl9nZXRMaXN0KCkKCQkJLmFkZENsYXNzKCAidWktdGFicy1uYXYgdWktaGVscGVyLXJlc2V0IHVpLWhlbHBlci1jbGVhcmZpeCB1aS13aWRnZXQtaGVhZGVyIHVpLWNvcm5lci1hbGwiICkKCQkJLmF0dHIoICJyb2xlIiwgInRhYmxpc3QiICk7CgoJCXRoaXMudGFicyA9IHRoaXMudGFibGlzdC5maW5kKCAiPiBsaTpoYXMoYVtocmVmXSkiICkKCQkJLmFkZENsYXNzKCAidWktc3RhdGUtZGVmYXVsdCB1aS1jb3JuZXItdG9wIiApCgkJCS5hdHRyKHsKCQkJCXJvbGU6ICJ0YWIiLAoJCQkJdGFiSW5kZXg6IC0xCgkJCX0pOwoKCQl0aGlzLmFuY2hvcnMgPSB0aGlzLnRhYnMubWFwKGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuICQoICJhIiwgdGhpcyApWyAwIF07CgkJCX0pCgkJCS5hZGRDbGFzcyggInVpLXRhYnMtYW5jaG9yIiApCgkJCS5hdHRyKHsKCQkJCXJvbGU6ICJwcmVzZW50YXRpb24iLAoJCQkJdGFiSW5kZXg6IC0xCgkJCX0pOwoKCQl0aGlzLnBhbmVscyA9ICQoKTsKCgkJdGhpcy5hbmNob3JzLmVhY2goZnVuY3Rpb24oIGksIGFuY2hvciApIHsKCQkJdmFyIHNlbGVjdG9yLCBwYW5lbCwgcGFuZWxJZCwKCQkJCWFuY2hvcklkID0gJCggYW5jaG9yICkudW5pcXVlSWQoKS5hdHRyKCAiaWQiICksCgkJCQl0YWIgPSAkKCBhbmNob3IgKS5jbG9zZXN0KCAibGkiICksCgkJCQlvcmlnaW5hbEFyaWFDb250cm9scyA9IHRhYi5hdHRyKCAiYXJpYS1jb250cm9scyIgKTsKCgkJCS8vIGlubGluZSB0YWIKCQkJaWYgKCBpc0xvY2FsKCBhbmNob3IgKSApIHsKCQkJCXNlbGVjdG9yID0gYW5jaG9yLmhhc2g7CgkJCQlwYW5lbCA9IHRoYXQuZWxlbWVudC5maW5kKCB0aGF0Ll9zYW5pdGl6ZVNlbGVjdG9yKCBzZWxlY3RvciApICk7CgkJCS8vIHJlbW90ZSB0YWIKCQkJfSBlbHNlIHsKCQkJCXBhbmVsSWQgPSB0aGF0Ll90YWJJZCggdGFiICk7CgkJCQlzZWxlY3RvciA9ICIjIiArIHBhbmVsSWQ7CgkJCQlwYW5lbCA9IHRoYXQuZWxlbWVudC5maW5kKCBzZWxlY3RvciApOwoJCQkJaWYgKCAhcGFuZWwubGVuZ3RoICkgewoJCQkJCXBhbmVsID0gdGhhdC5fY3JlYXRlUGFuZWwoIHBhbmVsSWQgKTsKCQkJCQlwYW5lbC5pbnNlcnRBZnRlciggdGhhdC5wYW5lbHNbIGkgLSAxIF0gfHwgdGhhdC50YWJsaXN0ICk7CgkJCQl9CgkJCQlwYW5lbC5hdHRyKCAiYXJpYS1saXZlIiwgInBvbGl0ZSIgKTsKCQkJfQoKCQkJaWYgKCBwYW5lbC5sZW5ndGgpIHsKCQkJCXRoYXQucGFuZWxzID0gdGhhdC5wYW5lbHMuYWRkKCBwYW5lbCApOwoJCQl9CgkJCWlmICggb3JpZ2luYWxBcmlhQ29udHJvbHMgKSB7CgkJCQl0YWIuZGF0YSggInVpLXRhYnMtYXJpYS1jb250cm9scyIsIG9yaWdpbmFsQXJpYUNvbnRyb2xzICk7CgkJCX0KCQkJdGFiLmF0dHIoewoJCQkJImFyaWEtY29udHJvbHMiOiBzZWxlY3Rvci5zdWJzdHJpbmcoIDEgKSwKCQkJCSJhcmlhLWxhYmVsbGVkYnkiOiBhbmNob3JJZAoJCQl9KTsKCQkJcGFuZWwuYXR0ciggImFyaWEtbGFiZWxsZWRieSIsIGFuY2hvcklkICk7CgkJfSk7CgoJCXRoaXMucGFuZWxzCgkJCS5hZGRDbGFzcyggInVpLXRhYnMtcGFuZWwgdWktd2lkZ2V0LWNvbnRlbnQgdWktY29ybmVyLWJvdHRvbSIgKQoJCQkuYXR0ciggInJvbGUiLCAidGFicGFuZWwiICk7Cgl9LAoKCS8vIGFsbG93IG92ZXJyaWRpbmcgaG93IHRvIGZpbmQgdGhlIGxpc3QgZm9yIHJhcmUgdXNhZ2Ugc2NlbmFyaW9zICgjNzcxNSkKCV9nZXRMaXN0OiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5lbGVtZW50LmZpbmQoICJvbCx1bCIgKS5lcSggMCApOwoJfSwKCglfY3JlYXRlUGFuZWw6IGZ1bmN0aW9uKCBpZCApIHsKCQlyZXR1cm4gJCggIjxkaXY+IiApCgkJCS5hdHRyKCAiaWQiLCBpZCApCgkJCS5hZGRDbGFzcyggInVpLXRhYnMtcGFuZWwgdWktd2lkZ2V0LWNvbnRlbnQgdWktY29ybmVyLWJvdHRvbSIgKQoJCQkuZGF0YSggInVpLXRhYnMtZGVzdHJveSIsIHRydWUgKTsKCX0sCgoJX3NldHVwRGlzYWJsZWQ6IGZ1bmN0aW9uKCBkaXNhYmxlZCApIHsKCQlpZiAoICQuaXNBcnJheSggZGlzYWJsZWQgKSApIHsKCQkJaWYgKCAhZGlzYWJsZWQubGVuZ3RoICkgewoJCQkJZGlzYWJsZWQgPSBmYWxzZTsKCQkJfSBlbHNlIGlmICggZGlzYWJsZWQubGVuZ3RoID09PSB0aGlzLmFuY2hvcnMubGVuZ3RoICkgewoJCQkJZGlzYWJsZWQgPSB0cnVlOwoJCQl9CgkJfQoKCQkvLyBkaXNhYmxlIHRhYnMKCQlmb3IgKCB2YXIgaSA9IDAsIGxpOyAoIGxpID0gdGhpcy50YWJzWyBpIF0gKTsgaSsrICkgewoJCQlpZiAoIGRpc2FibGVkID09PSB0cnVlIHx8ICQuaW5BcnJheSggaSwgZGlzYWJsZWQgKSAhPT0gLTEgKSB7CgkJCQkkKCBsaSApCgkJCQkJLmFkZENsYXNzKCAidWktc3RhdGUtZGlzYWJsZWQiICkKCQkJCQkuYXR0ciggImFyaWEtZGlzYWJsZWQiLCAidHJ1ZSIgKTsKCQkJfSBlbHNlIHsKCQkJCSQoIGxpICkKCQkJCQkucmVtb3ZlQ2xhc3MoICJ1aS1zdGF0ZS1kaXNhYmxlZCIgKQoJCQkJCS5yZW1vdmVBdHRyKCAiYXJpYS1kaXNhYmxlZCIgKTsKCQkJfQoJCX0KCgkJdGhpcy5vcHRpb25zLmRpc2FibGVkID0gZGlzYWJsZWQ7Cgl9LAoKCV9zZXR1cEV2ZW50czogZnVuY3Rpb24oIGV2ZW50ICkgewoJCXZhciBldmVudHMgPSB7CgkJCWNsaWNrOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQl9CgkJfTsKCQlpZiAoIGV2ZW50ICkgewoJCQkkLmVhY2goIGV2ZW50LnNwbGl0KCIgIiksIGZ1bmN0aW9uKCBpbmRleCwgZXZlbnROYW1lICkgewoJCQkJZXZlbnRzWyBldmVudE5hbWUgXSA9ICJfZXZlbnRIYW5kbGVyIjsKCQkJfSk7CgkJfQoKCQl0aGlzLl9vZmYoIHRoaXMuYW5jaG9ycy5hZGQoIHRoaXMudGFicyApLmFkZCggdGhpcy5wYW5lbHMgKSApOwoJCXRoaXMuX29uKCB0aGlzLmFuY2hvcnMsIGV2ZW50cyApOwoJCXRoaXMuX29uKCB0aGlzLnRhYnMsIHsga2V5ZG93bjogIl90YWJLZXlkb3duIiB9ICk7CgkJdGhpcy5fb24oIHRoaXMucGFuZWxzLCB7IGtleWRvd246ICJfcGFuZWxLZXlkb3duIiB9ICk7CgoJCXRoaXMuX2ZvY3VzYWJsZSggdGhpcy50YWJzICk7CgkJdGhpcy5faG92ZXJhYmxlKCB0aGlzLnRhYnMgKTsKCX0sCgoJX3NldHVwSGVpZ2h0U3R5bGU6IGZ1bmN0aW9uKCBoZWlnaHRTdHlsZSApIHsKCQl2YXIgbWF4SGVpZ2h0LAoJCQlwYXJlbnQgPSB0aGlzLmVsZW1lbnQucGFyZW50KCk7CgoJCWlmICggaGVpZ2h0U3R5bGUgPT09ICJmaWxsIiApIHsKCQkJbWF4SGVpZ2h0ID0gcGFyZW50LmhlaWdodCgpOwoJCQltYXhIZWlnaHQgLT0gdGhpcy5lbGVtZW50Lm91dGVySGVpZ2h0KCkgLSB0aGlzLmVsZW1lbnQuaGVpZ2h0KCk7CgoJCQl0aGlzLmVsZW1lbnQuc2libGluZ3MoICI6dmlzaWJsZSIgKS5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJdmFyIGVsZW0gPSAkKCB0aGlzICksCgkJCQkJcG9zaXRpb24gPSBlbGVtLmNzcyggInBvc2l0aW9uIiApOwoKCQkJCWlmICggcG9zaXRpb24gPT09ICJhYnNvbHV0ZSIgfHwgcG9zaXRpb24gPT09ICJmaXhlZCIgKSB7CgkJCQkJcmV0dXJuOwoJCQkJfQoJCQkJbWF4SGVpZ2h0IC09IGVsZW0ub3V0ZXJIZWlnaHQoIHRydWUgKTsKCQkJfSk7CgoJCQl0aGlzLmVsZW1lbnQuY2hpbGRyZW4oKS5ub3QoIHRoaXMucGFuZWxzICkuZWFjaChmdW5jdGlvbigpIHsKCQkJCW1heEhlaWdodCAtPSAkKCB0aGlzICkub3V0ZXJIZWlnaHQoIHRydWUgKTsKCQkJfSk7CgoJCQl0aGlzLnBhbmVscy5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJJCggdGhpcyApLmhlaWdodCggTWF0aC5tYXgoIDAsIG1heEhlaWdodCAtCgkJCQkJJCggdGhpcyApLmlubmVySGVpZ2h0KCkgKyAkKCB0aGlzICkuaGVpZ2h0KCkgKSApOwoJCQl9KQoJCQkuY3NzKCAib3ZlcmZsb3ciLCAiYXV0byIgKTsKCQl9IGVsc2UgaWYgKCBoZWlnaHRTdHlsZSA9PT0gImF1dG8iICkgewoJCQltYXhIZWlnaHQgPSAwOwoJCQl0aGlzLnBhbmVscy5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJbWF4SGVpZ2h0ID0gTWF0aC5tYXgoIG1heEhlaWdodCwgJCggdGhpcyApLmhlaWdodCggIiIgKS5oZWlnaHQoKSApOwoJCQl9KS5oZWlnaHQoIG1heEhlaWdodCApOwoJCX0KCX0sCgoJX2V2ZW50SGFuZGxlcjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCXZhciBvcHRpb25zID0gdGhpcy5vcHRpb25zLAoJCQlhY3RpdmUgPSB0aGlzLmFjdGl2ZSwKCQkJYW5jaG9yID0gJCggZXZlbnQuY3VycmVudFRhcmdldCApLAoJCQl0YWIgPSBhbmNob3IuY2xvc2VzdCggImxpIiApLAoJCQljbGlja2VkSXNBY3RpdmUgPSB0YWJbIDAgXSA9PT0gYWN0aXZlWyAwIF0sCgkJCWNvbGxhcHNpbmcgPSBjbGlja2VkSXNBY3RpdmUgJiYgb3B0aW9ucy5jb2xsYXBzaWJsZSwKCQkJdG9TaG93ID0gY29sbGFwc2luZyA/ICQoKSA6IHRoaXMuX2dldFBhbmVsRm9yVGFiKCB0YWIgKSwKCQkJdG9IaWRlID0gIWFjdGl2ZS5sZW5ndGggPyAkKCkgOiB0aGlzLl9nZXRQYW5lbEZvclRhYiggYWN0aXZlICksCgkJCWV2ZW50RGF0YSA9IHsKCQkJCW9sZFRhYjogYWN0aXZlLAoJCQkJb2xkUGFuZWw6IHRvSGlkZSwKCQkJCW5ld1RhYjogY29sbGFwc2luZyA/ICQoKSA6IHRhYiwKCQkJCW5ld1BhbmVsOiB0b1Nob3cKCQkJfTsKCgkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCgkJaWYgKCB0YWIuaGFzQ2xhc3MoICJ1aS1zdGF0ZS1kaXNhYmxlZCIgKSB8fAoJCQkJLy8gdGFiIGlzIGFscmVhZHkgbG9hZGluZwoJCQkJdGFiLmhhc0NsYXNzKCAidWktdGFicy1sb2FkaW5nIiApIHx8CgkJCQkvLyBjYW4ndCBzd2l0Y2ggZHVybmluZyBhbiBhbmltYXRpb24KCQkJCXRoaXMucnVubmluZyB8fAoJCQkJLy8gY2xpY2sgb24gYWN0aXZlIGhlYWRlciwgYnV0IG5vdCBjb2xsYXBzaWJsZQoJCQkJKCBjbGlja2VkSXNBY3RpdmUgJiYgIW9wdGlvbnMuY29sbGFwc2libGUgKSB8fAoJCQkJLy8gYWxsb3cgY2FuY2VsaW5nIGFjdGl2YXRpb24KCQkJCSggdGhpcy5fdHJpZ2dlciggImJlZm9yZUFjdGl2YXRlIiwgZXZlbnQsIGV2ZW50RGF0YSApID09PSBmYWxzZSApICkgewoJCQlyZXR1cm47CgkJfQoKCQlvcHRpb25zLmFjdGl2ZSA9IGNvbGxhcHNpbmcgPyBmYWxzZSA6IHRoaXMudGFicy5pbmRleCggdGFiICk7CgoJCXRoaXMuYWN0aXZlID0gY2xpY2tlZElzQWN0aXZlID8gJCgpIDogdGFiOwoJCWlmICggdGhpcy54aHIgKSB7CgkJCXRoaXMueGhyLmFib3J0KCk7CgkJfQoKCQlpZiAoICF0b0hpZGUubGVuZ3RoICYmICF0b1Nob3cubGVuZ3RoICkgewoJCQkkLmVycm9yKCAialF1ZXJ5IFVJIFRhYnM6IE1pc21hdGNoaW5nIGZyYWdtZW50IGlkZW50aWZpZXIuIiApOwoJCX0KCgkJaWYgKCB0b1Nob3cubGVuZ3RoICkgewoJCQl0aGlzLmxvYWQoIHRoaXMudGFicy5pbmRleCggdGFiICksIGV2ZW50ICk7CgkJfQoJCXRoaXMuX3RvZ2dsZSggZXZlbnQsIGV2ZW50RGF0YSApOwoJfSwKCgkvLyBoYW5kbGVzIHNob3cvaGlkZSBmb3Igc2VsZWN0aW5nIHRhYnMKCV90b2dnbGU6IGZ1bmN0aW9uKCBldmVudCwgZXZlbnREYXRhICkgewoJCXZhciB0aGF0ID0gdGhpcywKCQkJdG9TaG93ID0gZXZlbnREYXRhLm5ld1BhbmVsLAoJCQl0b0hpZGUgPSBldmVudERhdGEub2xkUGFuZWw7CgoJCXRoaXMucnVubmluZyA9IHRydWU7CgoJCWZ1bmN0aW9uIGNvbXBsZXRlKCkgewoJCQl0aGF0LnJ1bm5pbmcgPSBmYWxzZTsKCQkJdGhhdC5fdHJpZ2dlciggImFjdGl2YXRlIiwgZXZlbnQsIGV2ZW50RGF0YSApOwoJCX0KCgkJZnVuY3Rpb24gc2hvdygpIHsKCQkJZXZlbnREYXRhLm5ld1RhYi5jbG9zZXN0KCAibGkiICkuYWRkQ2xhc3MoICJ1aS10YWJzLWFjdGl2ZSB1aS1zdGF0ZS1hY3RpdmUiICk7CgoJCQlpZiAoIHRvU2hvdy5sZW5ndGggJiYgdGhhdC5vcHRpb25zLnNob3cgKSB7CgkJCQl0aGF0Ll9zaG93KCB0b1Nob3csIHRoYXQub3B0aW9ucy5zaG93LCBjb21wbGV0ZSApOwoJCQl9IGVsc2UgewoJCQkJdG9TaG93LnNob3coKTsKCQkJCWNvbXBsZXRlKCk7CgkJCX0KCQl9CgoJCS8vIHN0YXJ0IG91dCBieSBoaWRpbmcsIHRoZW4gc2hvd2luZywgdGhlbiBjb21wbGV0aW5nCgkJaWYgKCB0b0hpZGUubGVuZ3RoICYmIHRoaXMub3B0aW9ucy5oaWRlICkgewoJCQl0aGlzLl9oaWRlKCB0b0hpZGUsIHRoaXMub3B0aW9ucy5oaWRlLCBmdW5jdGlvbigpIHsKCQkJCWV2ZW50RGF0YS5vbGRUYWIuY2xvc2VzdCggImxpIiApLnJlbW92ZUNsYXNzKCAidWktdGFicy1hY3RpdmUgdWktc3RhdGUtYWN0aXZlIiApOwoJCQkJc2hvdygpOwoJCQl9KTsKCQl9IGVsc2UgewoJCQlldmVudERhdGEub2xkVGFiLmNsb3Nlc3QoICJsaSIgKS5yZW1vdmVDbGFzcyggInVpLXRhYnMtYWN0aXZlIHVpLXN0YXRlLWFjdGl2ZSIgKTsKCQkJdG9IaWRlLmhpZGUoKTsKCQkJc2hvdygpOwoJCX0KCgkJdG9IaWRlLmF0dHIoewoJCQkiYXJpYS1leHBhbmRlZCI6ICJmYWxzZSIsCgkJCSJhcmlhLWhpZGRlbiI6ICJ0cnVlIgoJCX0pOwoJCWV2ZW50RGF0YS5vbGRUYWIuYXR0ciggImFyaWEtc2VsZWN0ZWQiLCAiZmFsc2UiICk7CgkJLy8gSWYgd2UncmUgc3dpdGNoaW5nIHRhYnMsIHJlbW92ZSB0aGUgb2xkIHRhYiBmcm9tIHRoZSB0YWIgb3JkZXIuCgkJLy8gSWYgd2UncmUgb3BlbmluZyBmcm9tIGNvbGxhcHNlZCBzdGF0ZSwgcmVtb3ZlIHRoZSBwcmV2aW91cyB0YWIgZnJvbSB0aGUgdGFiIG9yZGVyLgoJCS8vIElmIHdlJ3JlIGNvbGxhcHNpbmcsIHRoZW4ga2VlcCB0aGUgY29sbGFwc2luZyB0YWIgaW4gdGhlIHRhYiBvcmRlci4KCQlpZiAoIHRvU2hvdy5sZW5ndGggJiYgdG9IaWRlLmxlbmd0aCApIHsKCQkJZXZlbnREYXRhLm9sZFRhYi5hdHRyKCAidGFiSW5kZXgiLCAtMSApOwoJCX0gZWxzZSBpZiAoIHRvU2hvdy5sZW5ndGggKSB7CgkJCXRoaXMudGFicy5maWx0ZXIoZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gJCggdGhpcyApLmF0dHIoICJ0YWJJbmRleCIgKSA9PT0gMDsKCQkJfSkKCQkJLmF0dHIoICJ0YWJJbmRleCIsIC0xICk7CgkJfQoKCQl0b1Nob3cuYXR0cih7CgkJCSJhcmlhLWV4cGFuZGVkIjogInRydWUiLAoJCQkiYXJpYS1oaWRkZW4iOiAiZmFsc2UiCgkJfSk7CgkJZXZlbnREYXRhLm5ld1RhYi5hdHRyKHsKCQkJImFyaWEtc2VsZWN0ZWQiOiAidHJ1ZSIsCgkJCXRhYkluZGV4OiAwCgkJfSk7Cgl9LAoKCV9hY3RpdmF0ZTogZnVuY3Rpb24oIGluZGV4ICkgewoJCXZhciBhbmNob3IsCgkJCWFjdGl2ZSA9IHRoaXMuX2ZpbmRBY3RpdmUoIGluZGV4ICk7CgoJCS8vIHRyeWluZyB0byBhY3RpdmF0ZSB0aGUgYWxyZWFkeSBhY3RpdmUgcGFuZWwKCQlpZiAoIGFjdGl2ZVsgMCBdID09PSB0aGlzLmFjdGl2ZVsgMCBdICkgewoJCQlyZXR1cm47CgkJfQoKCQkvLyB0cnlpbmcgdG8gY29sbGFwc2UsIHNpbXVsYXRlIGEgY2xpY2sgb24gdGhlIGN1cnJlbnQgYWN0aXZlIGhlYWRlcgoJCWlmICggIWFjdGl2ZS5sZW5ndGggKSB7CgkJCWFjdGl2ZSA9IHRoaXMuYWN0aXZlOwoJCX0KCgkJYW5jaG9yID0gYWN0aXZlLmZpbmQoICIudWktdGFicy1hbmNob3IiIClbIDAgXTsKCQl0aGlzLl9ldmVudEhhbmRsZXIoewoJCQl0YXJnZXQ6IGFuY2hvciwKCQkJY3VycmVudFRhcmdldDogYW5jaG9yLAoJCQlwcmV2ZW50RGVmYXVsdDogJC5ub29wCgkJfSk7Cgl9LAoKCV9maW5kQWN0aXZlOiBmdW5jdGlvbiggaW5kZXggKSB7CgkJcmV0dXJuIGluZGV4ID09PSBmYWxzZSA/ICQoKSA6IHRoaXMudGFicy5lcSggaW5kZXggKTsKCX0sCgoJX2dldEluZGV4OiBmdW5jdGlvbiggaW5kZXggKSB7CgkJLy8gbWV0YS1mdW5jdGlvbiB0byBnaXZlIHVzZXJzIG9wdGlvbiB0byBwcm92aWRlIGEgaHJlZiBzdHJpbmcgaW5zdGVhZCBvZiBhIG51bWVyaWNhbCBpbmRleC4KCQlpZiAoIHR5cGVvZiBpbmRleCA9PT0gInN0cmluZyIgKSB7CgkJCWluZGV4ID0gdGhpcy5hbmNob3JzLmluZGV4KCB0aGlzLmFuY2hvcnMuZmlsdGVyKCAiW2hyZWYkPSciICsgaW5kZXggKyAiJ10iICkgKTsKCQl9CgoJCXJldHVybiBpbmRleDsKCX0sCgoJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCWlmICggdGhpcy54aHIgKSB7CgkJCXRoaXMueGhyLmFib3J0KCk7CgkJfQoKCQl0aGlzLmVsZW1lbnQucmVtb3ZlQ2xhc3MoICJ1aS10YWJzIHVpLXdpZGdldCB1aS13aWRnZXQtY29udGVudCB1aS1jb3JuZXItYWxsIHVpLXRhYnMtY29sbGFwc2libGUiICk7CgoJCXRoaXMudGFibGlzdAoJCQkucmVtb3ZlQ2xhc3MoICJ1aS10YWJzLW5hdiB1aS1oZWxwZXItcmVzZXQgdWktaGVscGVyLWNsZWFyZml4IHVpLXdpZGdldC1oZWFkZXIgdWktY29ybmVyLWFsbCIgKQoJCQkucmVtb3ZlQXR0ciggInJvbGUiICk7CgoJCXRoaXMuYW5jaG9ycwoJCQkucmVtb3ZlQ2xhc3MoICJ1aS10YWJzLWFuY2hvciIgKQoJCQkucmVtb3ZlQXR0ciggInJvbGUiICkKCQkJLnJlbW92ZUF0dHIoICJ0YWJJbmRleCIgKQoJCQkucmVtb3ZlVW5pcXVlSWQoKTsKCgkJdGhpcy50YWJzLmFkZCggdGhpcy5wYW5lbHMgKS5lYWNoKGZ1bmN0aW9uKCkgewoJCQlpZiAoICQuZGF0YSggdGhpcywgInVpLXRhYnMtZGVzdHJveSIgKSApIHsKCQkJCSQoIHRoaXMgKS5yZW1vdmUoKTsKCQkJfSBlbHNlIHsKCQkJCSQoIHRoaXMgKQoJCQkJCS5yZW1vdmVDbGFzcyggInVpLXN0YXRlLWRlZmF1bHQgdWktc3RhdGUtYWN0aXZlIHVpLXN0YXRlLWRpc2FibGVkICIgKwoJCQkJCQkidWktY29ybmVyLXRvcCB1aS1jb3JuZXItYm90dG9tIHVpLXdpZGdldC1jb250ZW50IHVpLXRhYnMtYWN0aXZlIHVpLXRhYnMtcGFuZWwiICkKCQkJCQkucmVtb3ZlQXR0ciggInRhYkluZGV4IiApCgkJCQkJLnJlbW92ZUF0dHIoICJhcmlhLWxpdmUiICkKCQkJCQkucmVtb3ZlQXR0ciggImFyaWEtYnVzeSIgKQoJCQkJCS5yZW1vdmVBdHRyKCAiYXJpYS1zZWxlY3RlZCIgKQoJCQkJCS5yZW1vdmVBdHRyKCAiYXJpYS1sYWJlbGxlZGJ5IiApCgkJCQkJLnJlbW92ZUF0dHIoICJhcmlhLWhpZGRlbiIgKQoJCQkJCS5yZW1vdmVBdHRyKCAiYXJpYS1leHBhbmRlZCIgKQoJCQkJCS5yZW1vdmVBdHRyKCAicm9sZSIgKTsKCQkJfQoJCX0pOwoKCQl0aGlzLnRhYnMuZWFjaChmdW5jdGlvbigpIHsKCQkJdmFyIGxpID0gJCggdGhpcyApLAoJCQkJcHJldiA9IGxpLmRhdGEoICJ1aS10YWJzLWFyaWEtY29udHJvbHMiICk7CgkJCWlmICggcHJldiApIHsKCQkJCWxpCgkJCQkJLmF0dHIoICJhcmlhLWNvbnRyb2xzIiwgcHJldiApCgkJCQkJLnJlbW92ZURhdGEoICJ1aS10YWJzLWFyaWEtY29udHJvbHMiICk7CgkJCX0gZWxzZSB7CgkJCQlsaS5yZW1vdmVBdHRyKCAiYXJpYS1jb250cm9scyIgKTsKCQkJfQoJCX0pOwoKCQl0aGlzLnBhbmVscy5zaG93KCk7CgoJCWlmICggdGhpcy5vcHRpb25zLmhlaWdodFN0eWxlICE9PSAiY29udGVudCIgKSB7CgkJCXRoaXMucGFuZWxzLmNzcyggImhlaWdodCIsICIiICk7CgkJfQoJfSwKCgllbmFibGU6IGZ1bmN0aW9uKCBpbmRleCApIHsKCQl2YXIgZGlzYWJsZWQgPSB0aGlzLm9wdGlvbnMuZGlzYWJsZWQ7CgkJaWYgKCBkaXNhYmxlZCA9PT0gZmFsc2UgKSB7CgkJCXJldHVybjsKCQl9CgoJCWlmICggaW5kZXggPT09IHVuZGVmaW5lZCApIHsKCQkJZGlzYWJsZWQgPSBmYWxzZTsKCQl9IGVsc2UgewoJCQlpbmRleCA9IHRoaXMuX2dldEluZGV4KCBpbmRleCApOwoJCQlpZiAoICQuaXNBcnJheSggZGlzYWJsZWQgKSApIHsKCQkJCWRpc2FibGVkID0gJC5tYXAoIGRpc2FibGVkLCBmdW5jdGlvbiggbnVtICkgewoJCQkJCXJldHVybiBudW0gIT09IGluZGV4ID8gbnVtIDogbnVsbDsKCQkJCX0pOwoJCQl9IGVsc2UgewoJCQkJZGlzYWJsZWQgPSAkLm1hcCggdGhpcy50YWJzLCBmdW5jdGlvbiggbGksIG51bSApIHsKCQkJCQlyZXR1cm4gbnVtICE9PSBpbmRleCA/IG51bSA6IG51bGw7CgkJCQl9KTsKCQkJfQoJCX0KCQl0aGlzLl9zZXR1cERpc2FibGVkKCBkaXNhYmxlZCApOwoJfSwKCglkaXNhYmxlOiBmdW5jdGlvbiggaW5kZXggKSB7CgkJdmFyIGRpc2FibGVkID0gdGhpcy5vcHRpb25zLmRpc2FibGVkOwoJCWlmICggZGlzYWJsZWQgPT09IHRydWUgKSB7CgkJCXJldHVybjsKCQl9CgoJCWlmICggaW5kZXggPT09IHVuZGVmaW5lZCApIHsKCQkJZGlzYWJsZWQgPSB0cnVlOwoJCX0gZWxzZSB7CgkJCWluZGV4ID0gdGhpcy5fZ2V0SW5kZXgoIGluZGV4ICk7CgkJCWlmICggJC5pbkFycmF5KCBpbmRleCwgZGlzYWJsZWQgKSAhPT0gLTEgKSB7CgkJCQlyZXR1cm47CgkJCX0KCQkJaWYgKCAkLmlzQXJyYXkoIGRpc2FibGVkICkgKSB7CgkJCQlkaXNhYmxlZCA9ICQubWVyZ2UoIFsgaW5kZXggXSwgZGlzYWJsZWQgKS5zb3J0KCk7CgkJCX0gZWxzZSB7CgkJCQlkaXNhYmxlZCA9IFsgaW5kZXggXTsKCQkJfQoJCX0KCQl0aGlzLl9zZXR1cERpc2FibGVkKCBkaXNhYmxlZCApOwoJfSwKCglsb2FkOiBmdW5jdGlvbiggaW5kZXgsIGV2ZW50ICkgewoJCWluZGV4ID0gdGhpcy5fZ2V0SW5kZXgoIGluZGV4ICk7CgkJdmFyIHRoYXQgPSB0aGlzLAoJCQl0YWIgPSB0aGlzLnRhYnMuZXEoIGluZGV4ICksCgkJCWFuY2hvciA9IHRhYi5maW5kKCAiLnVpLXRhYnMtYW5jaG9yIiApLAoJCQlwYW5lbCA9IHRoaXMuX2dldFBhbmVsRm9yVGFiKCB0YWIgKSwKCQkJZXZlbnREYXRhID0gewoJCQkJdGFiOiB0YWIsCgkJCQlwYW5lbDogcGFuZWwKCQkJfTsKCgkJLy8gbm90IHJlbW90ZQoJCWlmICggaXNMb2NhbCggYW5jaG9yWyAwIF0gKSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJdGhpcy54aHIgPSAkLmFqYXgoIHRoaXMuX2FqYXhTZXR0aW5ncyggYW5jaG9yLCBldmVudCwgZXZlbnREYXRhICkgKTsKCgkJLy8gc3VwcG9ydDogalF1ZXJ5IDwxLjgKCQkvLyBqUXVlcnkgPDEuOCByZXR1cm5zIGZhbHNlIGlmIHRoZSByZXF1ZXN0IGlzIGNhbmNlbGVkIGluIGJlZm9yZVNlbmQsCgkJLy8gYnV0IGFzIG9mIDEuOCwgJC5hamF4KCkgYWx3YXlzIHJldHVybnMgYSBqcVhIUiBvYmplY3QuCgkJaWYgKCB0aGlzLnhociAmJiB0aGlzLnhoci5zdGF0dXNUZXh0ICE9PSAiY2FuY2VsZWQiICkgewoJCQl0YWIuYWRkQ2xhc3MoICJ1aS10YWJzLWxvYWRpbmciICk7CgkJCXBhbmVsLmF0dHIoICJhcmlhLWJ1c3kiLCAidHJ1ZSIgKTsKCgkJCXRoaXMueGhyCgkJCQkuc3VjY2VzcyhmdW5jdGlvbiggcmVzcG9uc2UgKSB7CgkJCQkJLy8gc3VwcG9ydDogalF1ZXJ5IDwxLjgKCQkJCQkvLyBodHRwOi8vYnVncy5qcXVlcnkuY29tL3RpY2tldC8xMTc3OAoJCQkJCXNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CgkJCQkJCXBhbmVsLmh0bWwoIHJlc3BvbnNlICk7CgkJCQkJCXRoYXQuX3RyaWdnZXIoICJsb2FkIiwgZXZlbnQsIGV2ZW50RGF0YSApOwoJCQkJCX0sIDEgKTsKCQkJCX0pCgkJCQkuY29tcGxldGUoZnVuY3Rpb24oIGpxWEhSLCBzdGF0dXMgKSB7CgkJCQkJLy8gc3VwcG9ydDogalF1ZXJ5IDwxLjgKCQkJCQkvLyBodHRwOi8vYnVncy5qcXVlcnkuY29tL3RpY2tldC8xMTc3OAoJCQkJCXNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CgkJCQkJCWlmICggc3RhdHVzID09PSAiYWJvcnQiICkgewoJCQkJCQkJdGhhdC5wYW5lbHMuc3RvcCggZmFsc2UsIHRydWUgKTsKCQkJCQkJfQoKCQkJCQkJdGFiLnJlbW92ZUNsYXNzKCAidWktdGFicy1sb2FkaW5nIiApOwoJCQkJCQlwYW5lbC5yZW1vdmVBdHRyKCAiYXJpYS1idXN5IiApOwoKCQkJCQkJaWYgKCBqcVhIUiA9PT0gdGhhdC54aHIgKSB7CgkJCQkJCQlkZWxldGUgdGhhdC54aHI7CgkJCQkJCX0KCQkJCQl9LCAxICk7CgkJCQl9KTsKCQl9Cgl9LAoKCV9hamF4U2V0dGluZ3M6IGZ1bmN0aW9uKCBhbmNob3IsIGV2ZW50LCBldmVudERhdGEgKSB7CgkJdmFyIHRoYXQgPSB0aGlzOwoJCXJldHVybiB7CgkJCXVybDogYW5jaG9yLmF0dHIoICJocmVmIiApLAoJCQliZWZvcmVTZW5kOiBmdW5jdGlvbigganFYSFIsIHNldHRpbmdzICkgewoJCQkJcmV0dXJuIHRoYXQuX3RyaWdnZXIoICJiZWZvcmVMb2FkIiwgZXZlbnQsCgkJCQkJJC5leHRlbmQoIHsganFYSFIgOiBqcVhIUiwgYWpheFNldHRpbmdzOiBzZXR0aW5ncyB9LCBldmVudERhdGEgKSApOwoJCQl9CgkJfTsKCX0sCgoJX2dldFBhbmVsRm9yVGFiOiBmdW5jdGlvbiggdGFiICkgewoJCXZhciBpZCA9ICQoIHRhYiApLmF0dHIoICJhcmlhLWNvbnRyb2xzIiApOwoJCXJldHVybiB0aGlzLmVsZW1lbnQuZmluZCggdGhpcy5fc2FuaXRpemVTZWxlY3RvciggIiMiICsgaWQgKSApOwoJfQp9KTsKCn0pKCBqUXVlcnkgKTsKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHdpbmRvdyApIHsKCgkkLm1vYmlsZS5pb3NvcmllbnRhdGlvbmZpeEVuYWJsZWQgPSB0cnVlOwoKCS8vIFRoaXMgZml4IGFkZHJlc3NlcyBhbiBpT1MgYnVnLCBzbyByZXR1cm4gZWFybHkgaWYgdGhlIFVBIGNsYWltcyBpdCdzIHNvbWV0aGluZyBlbHNlLgoJdmFyIHVhID0gbmF2aWdhdG9yLnVzZXJBZ2VudCwKCQl6b29tLAoJCWV2dCwgeCwgeSwgeiwgYWlnOwoJaWYgKCAhKCAvaVBob25lfGlQYWR8aVBvZC8udGVzdCggbmF2aWdhdG9yLnBsYXRmb3JtICkgJiYgL09TIFsxLTVdX1swLTlfXSogbGlrZSBNYWMgT1MgWC9pLnRlc3QoIHVhICkgJiYgdWEuaW5kZXhPZiggIkFwcGxlV2ViS2l0IiApID4gLTEgKSApewoJCSQubW9iaWxlLmlvc29yaWVudGF0aW9uZml4RW5hYmxlZCA9IGZhbHNlOwoJCXJldHVybjsKCX0KCgl6b29tID0gJC5tb2JpbGUuem9vbTsKCglmdW5jdGlvbiBjaGVja1RpbHQoIGUgKSB7CgkJZXZ0ID0gZS5vcmlnaW5hbEV2ZW50OwoJCWFpZyA9IGV2dC5hY2NlbGVyYXRpb25JbmNsdWRpbmdHcmF2aXR5OwoKCQl4ID0gTWF0aC5hYnMoIGFpZy54ICk7CgkJeSA9IE1hdGguYWJzKCBhaWcueSApOwoJCXogPSBNYXRoLmFicyggYWlnLnogKTsKCgkJLy8gSWYgcG9ydHJhaXQgb3JpZW50YXRpb24gYW5kIGluIG9uZSBvZiB0aGUgZGFuZ2VyIHpvbmVzCgkJaWYgKCAhd2luZG93Lm9yaWVudGF0aW9uICYmICggeCA+IDcgfHwgKCAoIHogPiA2ICYmIHkgPCA4IHx8IHogPCA4ICYmIHkgPiA2ICkgJiYgeCA+IDUgKSApICkgewoJCQkJaWYgKCB6b29tLmVuYWJsZWQgKSB7CgkJCQkJem9vbS5kaXNhYmxlKCk7CgkJCQl9CgkJfQllbHNlIGlmICggIXpvb20uZW5hYmxlZCApIHsKCQkJCXpvb20uZW5hYmxlKCk7CgkJfQoJfQoKCSQubW9iaWxlLmRvY3VtZW50Lm9uKCAibW9iaWxlaW5pdCIsIGZ1bmN0aW9uKCkgewoJCWlmICggJC5tb2JpbGUuaW9zb3JpZW50YXRpb25maXhFbmFibGVkICl7CgkJCSQubW9iaWxlLndpbmRvdwoJCQkJLmJpbmQoICJvcmllbnRhdGlvbmNoYW5nZS5pb3NvcmllbnRhdGlvbmZpeCIsIHpvb20uZW5hYmxlICkKCQkJCS5iaW5kKCAiZGV2aWNlbW90aW9uLmlvc29yaWVudGF0aW9uZml4IiwgY2hlY2tUaWx0ICk7CgkJfQoJfSk7Cgp9KCBqUXVlcnksIHRoaXMgKSk7CgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoJdmFyCSRodG1sID0gJCggImh0bWwiICksCgkJJHdpbmRvdyA9ICQubW9iaWxlLndpbmRvdzsKCgkvL3JlbW92ZSBpbml0aWFsIGJ1aWxkIGNsYXNzIChvbmx5IHByZXNlbnQgb24gZmlyc3QgcGFnZXNob3cpCglmdW5jdGlvbiBoaWRlUmVuZGVyaW5nQ2xhc3MoKSB7CgkJJGh0bWwucmVtb3ZlQ2xhc3MoICJ1aS1tb2JpbGUtcmVuZGVyaW5nIiApOwoJfQoKCS8vIHRyaWdnZXIgbW9iaWxlaW5pdCBldmVudCAtIHVzZWZ1bCBob29rIGZvciBjb25maWd1cmluZyAkLm1vYmlsZSBzZXR0aW5ncyBiZWZvcmUgdGhleSdyZSB1c2VkCgkkKCB3aW5kb3cuZG9jdW1lbnQgKS50cmlnZ2VyKCAibW9iaWxlaW5pdCIgKTsKCgkvLyBzdXBwb3J0IGNvbmRpdGlvbnMKCS8vIGlmIGRldmljZSBzdXBwb3J0IGNvbmRpdGlvbihzKSBhcmVuJ3QgbWV0LCBsZWF2ZSB0aGluZ3MgYXMgdGhleSBhcmUgLT4gYSBiYXNpYywgdXNhYmxlIGV4cGVyaWVuY2UsCgkvLyBvdGhlcndpc2UsIHByb2NlZWQgd2l0aCB0aGUgZW5oYW5jZW1lbnRzCglpZiAoICEkLm1vYmlsZS5ncmFkZUEoKSApIHsKCQlyZXR1cm47Cgl9CgoJLy8gb3ZlcnJpZGUgYWpheEVuYWJsZWQgb24gcGxhdGZvcm1zIHRoYXQgaGF2ZSBrbm93biBjb25mbGljdHMgd2l0aCBoYXNoIGhpc3RvcnkgdXBkYXRlcwoJLy8gb3IgZ2VuZXJhbGx5IHdvcmsgYmV0dGVyIGJyb3dzaW5nIGluIHJlZ3VsYXIgaHR0cCBmb3IgZnVsbCBwYWdlIHJlZnJlc2hlcyAoQkI1LCBPcGVyYSBNaW5pKQoJaWYgKCAkLm1vYmlsZS5hamF4QmxhY2tsaXN0ICkgewoJCSQubW9iaWxlLmFqYXhFbmFibGVkID0gZmFsc2U7Cgl9CgoJLy8gQWRkIG1vYmlsZSwgaW5pdGlhbCBsb2FkICJyZW5kZXJpbmciIGNsYXNzZXMgdG8gZG9jRWwKCSRodG1sLmFkZENsYXNzKCAidWktbW9iaWxlIHVpLW1vYmlsZS1yZW5kZXJpbmciICk7CgoJLy8gVGhpcyBpcyBhIGZhbGxiYWNrLiBJZiBhbnl0aGluZyBnb2VzIHdyb25nIChKUyBlcnJvcnMsIGV0YyksIG9yIGV2ZW50cyBkb24ndCBmaXJlLAoJLy8gdGhpcyBlbnN1cmVzIHRoZSByZW5kZXJpbmcgY2xhc3MgaXMgcmVtb3ZlZCBhZnRlciA1IHNlY29uZHMsIHNvIGNvbnRlbnQgaXMgdmlzaWJsZSBhbmQgYWNjZXNzaWJsZQoJc2V0VGltZW91dCggaGlkZVJlbmRlcmluZ0NsYXNzLCA1MDAwICk7CgoJJC5leHRlbmQoICQubW9iaWxlLCB7CgkJLy8gZmluZCBhbmQgZW5oYW5jZSB0aGUgcGFnZXMgaW4gdGhlIGRvbSBhbmQgdHJhbnNpdGlvbiB0byB0aGUgZmlyc3QgcGFnZS4KCQlpbml0aWFsaXplUGFnZTogZnVuY3Rpb24oKSB7CgkJCS8vIGZpbmQgcHJlc2VudCBwYWdlcwoJCQl2YXIgcGF0aCA9ICQubW9iaWxlLnBhdGgsCgkJCQkkcGFnZXMgPSAkKCAiOmpxbURhdGEocm9sZT0ncGFnZScpLCA6anFtRGF0YShyb2xlPSdkaWFsb2cnKSIgKSwKCQkJCWhhc2ggPSBwYXRoLnN0cmlwSGFzaCggcGF0aC5zdHJpcFF1ZXJ5UGFyYW1zKHBhdGgucGFyc2VMb2NhdGlvbigpLmhhc2gpICksCgkJCQloYXNoUGFnZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCBoYXNoICk7CgoJCQkvLyBpZiBubyBwYWdlcyBhcmUgZm91bmQsIGNyZWF0ZSBvbmUgd2l0aCBib2R5J3MgaW5uZXIgaHRtbAoJCQlpZiAoICEkcGFnZXMubGVuZ3RoICkgewoJCQkJJHBhZ2VzID0gJCggImJvZHkiICkud3JhcElubmVyKCAiPGRpdiBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyb2xlPSdwYWdlJz48L2Rpdj4iICkuY2hpbGRyZW4oIDAgKTsKCQkJfQoKCQkJLy8gYWRkIGRpYWxvZ3MsIHNldCBkYXRhLXVybCBhdHRycwoJCQkkcGFnZXMuZWFjaChmdW5jdGlvbigpIHsKCQkJCXZhciAkdGhpcyA9ICQoIHRoaXMgKTsKCgkJCQkvLyB1bmxlc3MgdGhlIGRhdGEgdXJsIGlzIGFscmVhZHkgc2V0IHNldCBpdCB0byB0aGUgcGF0aG5hbWUKCQkJCWlmICggISR0aGlzWyAwIF0uZ2V0QXR0cmlidXRlKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidXJsIiApICkgewoJCQkJCSR0aGlzLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJ1cmwiLCAkdGhpcy5hdHRyKCAiaWQiICkgfHwgbG9jYXRpb24ucGF0aG5hbWUgKyBsb2NhdGlvbi5zZWFyY2ggKTsKCQkJCX0KCQkJfSk7CgoJCQkvLyBkZWZpbmUgZmlyc3QgcGFnZSBpbiBkb20gY2FzZSBvbmUgYmFja3Mgb3V0IHRvIHRoZSBkaXJlY3Rvcnkgcm9vdCAobm90IGFsd2F5cyB0aGUgZmlyc3QgcGFnZSB2aXNpdGVkLCBidXQgZGVmaW5lZCBhcyBmYWxsYmFjaykKCQkJJC5tb2JpbGUuZmlyc3RQYWdlID0gJHBhZ2VzLmZpcnN0KCk7CgoJCQkvLyBkZWZpbmUgcGFnZSBjb250YWluZXIKCQkJJC5tb2JpbGUucGFnZUNvbnRhaW5lciA9ICQubW9iaWxlLmZpcnN0UGFnZQoJCQkJLnBhcmVudCgpCgkJCQkuYWRkQ2xhc3MoICJ1aS1tb2JpbGUtdmlld3BvcnQiICkKCQkJCS5wYWdlY29udGFpbmVyKCk7CgoJCQkvLyBpbml0aWFsaXplIG5hdmlnYXRpb24gZXZlbnRzIG5vdywgYWZ0ZXIgbW9iaWxlaW5pdCBoYXMgb2NjdXJyZWQgYW5kIHRoZSBwYWdlIGNvbnRhaW5lcgoJCQkvLyBoYXMgYmVlbiBjcmVhdGVkIGJ1dCBiZWZvcmUgdGhlIHJlc3Qgb2YgdGhlIGxpYnJhcnkgaXMgYWxlcnRlZCB0byB0aGF0IGZhY3QKCQkJJC5tb2JpbGUubmF2cmVhZHlEZWZlcnJlZC5yZXNvbHZlKCk7CgoJCQkvLyBhbGVydCBsaXN0ZW5lcnMgdGhhdCB0aGUgcGFnZWNvbnRhaW5lciBoYXMgYmVlbiBkZXRlcm1pbmVkIGZvciBiaW5kaW5nCgkJCS8vIHRvIGV2ZW50cyB0cmlnZ2VyZWQgb24gaXQKCQkJJHdpbmRvdy50cmlnZ2VyKCAicGFnZWNvbnRhaW5lcmNyZWF0ZSIgKTsKCgkJCS8vIGN1ZSBwYWdlIGxvYWRpbmcgbWVzc2FnZQoJCQkkLm1vYmlsZS5sb2FkaW5nKCAic2hvdyIgKTsKCgkJCS8vcmVtb3ZlIGluaXRpYWwgYnVpbGQgY2xhc3MgKG9ubHkgcHJlc2VudCBvbiBmaXJzdCBwYWdlc2hvdykKCQkJaGlkZVJlbmRlcmluZ0NsYXNzKCk7CgoJCQkvLyBpZiBoYXNoY2hhbmdlIGxpc3RlbmluZyBpcyBkaXNhYmxlZCwgdGhlcmUncyBubyBoYXNoIGRlZXBsaW5rLAoJCQkvLyB0aGUgaGFzaCBpcyBub3QgdmFsaWQgKGNvbnRhaW5zIG1vcmUgdGhhbiBvbmUgIyBvciBkb2VzIG5vdCBzdGFydCB3aXRoICMpCgkJCS8vIG9yIHRoZXJlIGlzIG5vIHBhZ2Ugd2l0aCB0aGF0IGhhc2gsIGNoYW5nZSB0byB0aGUgZmlyc3QgcGFnZSBpbiB0aGUgRE9NCgkJCS8vIFJlbWVtYmVyLCBob3dldmVyLCB0aGF0IHRoZSBoYXNoIGNhbiBhbHNvIGJlIGEgcGF0aCEKCQkJaWYgKCAhICggJC5tb2JpbGUuaGFzaExpc3RlbmluZ0VuYWJsZWQgJiYKCQkJCSQubW9iaWxlLnBhdGguaXNIYXNoVmFsaWQoIGxvY2F0aW9uLmhhc2ggKSAmJgoJCQkJKCAkKCBoYXNoUGFnZSApLmlzKCAiOmpxbURhdGEocm9sZT0ncGFnZScpIiApIHx8CgkJCQkJJC5tb2JpbGUucGF0aC5pc1BhdGgoIGhhc2ggKSB8fAoJCQkJCWhhc2ggPT09ICQubW9iaWxlLmRpYWxvZ0hhc2hLZXkgKSApICkgewoKCQkJCS8vIFN0b3JlIHRoZSBpbml0aWFsIGRlc3RpbmF0aW9uCgkJCQlpZiAoICQubW9iaWxlLnBhdGguaXNIYXNoVmFsaWQoIGxvY2F0aW9uLmhhc2ggKSApIHsKCQkJCQkkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5LmluaXRpYWxEc3QgPSBoYXNoLnJlcGxhY2UoICIjIiwgIiIgKTsKCQkJCX0KCgkJCQkvLyBtYWtlIHN1cmUgdG8gc2V0IGluaXRpYWwgcG9wc3RhdGUgc3RhdGUgaWYgaXQgZXhpc3RzCgkJCQkvLyBzbyB0aGF0IG5hdmlnYXRpb24gYmFjayB0byB0aGUgaW5pdGlhbCBwYWdlIHdvcmtzIHByb3Blcmx5CgkJCQlpZiAoICQuZXZlbnQuc3BlY2lhbC5uYXZpZ2F0ZS5pc1B1c2hTdGF0ZUVuYWJsZWQoKSApIHsKCQkJCQkkLm1vYmlsZS5uYXZpZ2F0ZS5uYXZpZ2F0b3Iuc3F1YXNoKCBwYXRoLnBhcnNlTG9jYXRpb24oKS5ocmVmICk7CgkJCQl9CgoJCQkJJC5tb2JpbGUuY2hhbmdlUGFnZSggJC5tb2JpbGUuZmlyc3RQYWdlLCB7CgkJCQkJdHJhbnNpdGlvbjogIm5vbmUiLAoJCQkJCXJldmVyc2U6IHRydWUsCgkJCQkJY2hhbmdlSGFzaDogZmFsc2UsCgkJCQkJZnJvbUhhc2hDaGFuZ2U6IHRydWUKCQkJCX0pOwoJCQl9IGVsc2UgewoJCQkJLy8gdHJpZ2dlciBoYXNoY2hhbmdlIG9yIG5hdmlnYXRlIHRvIHNxdWFzaCBhbmQgcmVjb3JkIHRoZSBjb3JyZWN0CgkJCQkvLyBoaXN0b3J5IGVudHJ5IGZvciBhbiBpbml0aWFsIGhhc2ggcGF0aAoJCQkJaWYgKCAhJC5ldmVudC5zcGVjaWFsLm5hdmlnYXRlLmlzUHVzaFN0YXRlRW5hYmxlZCgpICkgewoJCQkJCSR3aW5kb3cudHJpZ2dlciggImhhc2hjaGFuZ2UiLCBbdHJ1ZV0gKTsKCQkJCX0gZWxzZSB7CgkJCQkJLy8gVE9ETyBmaWd1cmUgb3V0IGhvdyB0byBzaW1wbGlmeSB0aGlzIGludGVyYWN0aW9uIHdpdGggdGhlIGluaXRpYWwgaGlzdG9yeSBlbnRyeQoJCQkJCS8vIGF0IHRoZSBib3R0b20ganMvbmF2aWdhdGUvbmF2aWdhdGUuanMKCQkJCQkkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5LnN0YWNrID0gW107CgkJCQkJJC5tb2JpbGUubmF2aWdhdGUoICQubW9iaWxlLnBhdGguaXNQYXRoKCBsb2NhdGlvbi5oYXNoICkgPyBsb2NhdGlvbi5oYXNoIDogbG9jYXRpb24uaHJlZiApOwoJCQkJfQoJCQl9CgkJfQoJfSk7CgoJJChmdW5jdGlvbigpIHsKCQkvL1J1biBpbmxpbmVTVkcgc3VwcG9ydCB0ZXN0CgkJJC5zdXBwb3J0LmlubGluZVNWRygpOwoJCQoJCS8vIGNoZWNrIHdoaWNoIHNjcm9sbFRvcCB2YWx1ZSBzaG91bGQgYmUgdXNlZCBieSBzY3JvbGxpbmcgdG8gMSBpbW1lZGlhdGVseSBhdCBkb21yZWFkeQoJCS8vIHRoZW4gY2hlY2sgd2hhdCB0aGUgc2Nyb2xsIHRvcCBpcy4gQW5kcm9pZCB3aWxsIHJlcG9ydCAwLi4uIG90aGVycyAxCgkJLy8gbm90ZSB0aGF0IHRoaXMgaW5pdGlhbCBzY3JvbGwgd29uJ3QgaGlkZSB0aGUgYWRkcmVzcyBiYXIuIEl0J3MganVzdCBmb3IgdGhlIGNoZWNrLgoJCQoJCS8vIGhpZGUgaU9TIGJyb3dzZXIgY2hyb21lIG9uIGxvYWQgaWYgaGlkZVVybEJhciBpcyB0cnVlIHRoaXMgaXMgdG8gdHJ5IGFuZCBkbyBpdCBhcyBzb29uIGFzIHBvc3NpYmxlCgkJaWYgKCAkLm1vYmlsZS5oaWRlVXJsQmFyICkgewoJCQl3aW5kb3cuc2Nyb2xsVG8oIDAsIDEgKTsKCQl9CgoJCS8vIGlmIGRlZmF1bHRIb21lU2Nyb2xsIGhhc24ndCBiZWVuIHNldCB5ZXQsIHNlZSBpZiBzY3JvbGxUb3AgaXMgMQoJCS8vIGl0IHNob3VsZCBiZSAxIGluIG1vc3QgYnJvd3NlcnMsIGJ1dCBhbmRyb2lkIHRyZWF0cyAxIGFzIDAgKGZvciBoaWRpbmcgYWRkciBiYXIpCgkJLy8gc28gaWYgaXQncyAxLCB1c2UgMCBmcm9tIG5vdyBvbgoJCSQubW9iaWxlLmRlZmF1bHRIb21lU2Nyb2xsID0gKCAhJC5zdXBwb3J0LnNjcm9sbFRvcCB8fCAkLm1vYmlsZS53aW5kb3cuc2Nyb2xsVG9wKCkgPT09IDEgKSA/IDAgOiAxOwoKCQkvL2RvbS1yZWFkeSBpbml0cwoJCWlmICggJC5tb2JpbGUuYXV0b0luaXRpYWxpemVQYWdlICkgewoJCQkkLm1vYmlsZS5pbml0aWFsaXplUGFnZSgpOwoJCX0KCgkJLy8gd2luZG93IGxvYWQgZXZlbnQKCQkvLyBoaWRlIGlPUyBicm93c2VyIGNocm9tZSBvbiBsb2FkIGlmIGhpZGVVcmxCYXIgaXMgdHJ1ZSB0aGlzIGlzIGFzIGZhbGwgYmFjayBpbmNhc2Ugd2Ugd2VyZSB0b28gZWFybHkgYmVmb3JlCgkJaWYgKCAkLm1vYmlsZS5oaWRlVXJsQmFyICkgewoJCQkkd2luZG93LmxvYWQoICQubW9iaWxlLnNpbGVudFNjcm9sbCApOwoJCX0KCgkJaWYgKCAhJC5zdXBwb3J0LmNzc1BvaW50ZXJFdmVudHMgKSB7CgkJCS8vIElFIGFuZCBPcGVyYSBkb24ndCBzdXBwb3J0IENTUyBwb2ludGVyLWV2ZW50czogbm9uZSB0aGF0IHdlIHVzZSB0byBkaXNhYmxlIGxpbmstYmFzZWQgYnV0dG9ucwoJCQkvLyBieSBhZGRpbmcgdGhlICd1aS1kaXNhYmxlZCcgY2xhc3MgdG8gdGhlbS4gVXNpbmcgYSBKYXZhU2NyaXB0IHdvcmthcm91bmQgZm9yIHRob3NlIGJyb3dzZXIuCgkJCS8vIGh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5LW1vYmlsZS9pc3N1ZXMvMzU1OAoKCQkJLy8gREVQUkVDQVRFRCBhcyBvZiAxLjQuMCAtIHJlbW92ZSB1aS1kaXNhYmxlZCBhZnRlciAxLjQuMCByZWxlYXNlCgkJCS8vIG9ubHkgdWktc3RhdGUtZGlzYWJsZWQgc2hvdWxkIGJlIHByZXNlbnQgdGhlcmVhZnRlcgoJCQkkLm1vYmlsZS5kb2N1bWVudC5kZWxlZ2F0ZSggIi51aS1zdGF0ZS1kaXNhYmxlZCwudWktZGlzYWJsZWQiLCAidmNsaWNrIiwKCQkJCWZ1bmN0aW9uKCBlICkgewoJCQkJCWUucHJldmVudERlZmF1bHQoKTsKCQkJCQllLnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbigpOwoJCQkJfQoJCQkpOwoJCX0KCX0pOwp9KCBqUXVlcnksIHRoaXMgKSk7CgoKfSkpOwo=",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Fri, 07 Nov 2014 06:49:08 GMT",
                    "Content-Length": "439244",
                    "Date": "Fri, 07 Nov 2014 06:49:10 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}