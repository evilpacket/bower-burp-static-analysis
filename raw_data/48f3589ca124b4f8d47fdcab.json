{
    "url": "http://localhost:9999/fex-team/ueditor/_test/tools/br/js/testrunner.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Open redirection (DOM-based)",
    "issueType": 5243152,
    "severity": "Low",
    "confidence": "Firm",
    "issueBackground": "DOM-based open redirection vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this data into the target of a redirection in an unsafe way. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will cause a redirection to an arbitrary external domain. This behavior can be leveraged to facilitate phishing attacks against users of the application. The ability to use an authentic application URL, targeting the correct domain with a valid SSL certificate (if SSL is used) lends credibility to the phishing attack because many users, even if they verify these features, will not notice the subsequent redirection to a different domain.<br><br><b>Note:</b> If an attacker is able to control the start of the string that is passed to the redirection API, then it may be possible to escalate this vulnerability into a JavaScript injection attack, by using a URL with the javascript: pseudo-protocol to execute arbitrary script code when the URL is processed by the browser.",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based open redirection vulnerabilities is not to dynamically set redirection targets using data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing an arbitrary URL as a redirection target. In general, this is best achieved by using a whitelist of URLs that are permitted redirection targets, and strictly validating the target against this list before performing the redirection.",
    "issueDetail": "The application may be vulnerable to DOM-based open redirection. Data is read from <b>window.location.href</b> and written to <b>window.location.href</b> via the following statement:<ul><li>window.location.href = window.location.href.match(/^(.+?)(\\?.*)?$/)[1] + \"?\" + encodeURIComponent(text);</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/fex-team/ueditor/_test/tools/br/js/testrunner.js",
                "path": "/fex-team/ueditor/_test/tools/br/js/testrunner.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9mZXgtdGVhbS91ZWRpdG9yL190ZXN0L3Rvb2xzL2JyL2pzL3Rlc3RydW5uZXIuanMgSFRUUC8xLjENCkhvc3Q6IGxvY2FsaG9zdDo5OTk5DQoNCg==",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogMzc4ODQNCkFjY2VwdC1SYW5nZXM6IGJ5dGVzDQpDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2phdmFzY3JpcHQNCkRhdGU6IFN1biwgMDkgTm92IDIwMTQgMDA6MzE6MjEgR01UDQpMYXN0LU1vZGlmaWVkOiBTdW4sIDA5IE5vdiAyMDE0IDAwOjMxOjIwIEdNVA0KDQovKgogKiBRVW5pdCAtIEEgSmF2YVNjcmlwdCBVbml0IFRlc3RpbmcgRnJhbWV3b3JrCiAqIAogKiBodHRwOi8vZG9jcy5qcXVlcnkuY29tL1FVbml0CiAqCiAqIENvcHlyaWdodCAoYykgMjAwOSBKb2huIFJlc2lnLCBKw7ZybiBaYWVmZmVyZXIKICogRHVhbCBsaWNlbnNlZCB1bmRlciB0aGUgTUlUIChNSVQtTElDRU5TRS50eHQpCiAqIGFuZCBHUEwgKEdQTC1MSUNFTlNFLnR4dCkgbGljZW5zZXMuCiAqLwoKKGZ1bmN0aW9uICh3aW5kb3cpIHsKCiAgICB2YXIgUVVuaXQgPSB7CgogICAgICAgIC8vIEluaXRpYWxpemUgdGhlIGNvbmZpZ3VyYXRpb24gb3B0aW9ucwogICAgICAgIGluaXQ6ZnVuY3Rpb24gKCkgewogICAgICAgICAgICBjb25maWcgPSB7CiAgICAgICAgICAgICAgICBzdGF0czp7IGFsbDowLCBiYWQ6MCB9LAogICAgICAgICAgICAgICAgbW9kdWxlU3RhdHM6eyBhbGw6MCwgYmFkOjAgfSwKICAgICAgICAgICAgICAgIHN0YXJ0ZWQ6K25ldyBEYXRlLAogICAgICAgICAgICAgICAgYmxvY2tpbmc6ZmFsc2UsCiAgICAgICAgICAgICAgICBhdXRvcnVuOmZhbHNlLAogICAgICAgICAgICAgICAgYXNzZXJ0aW9uczpbXSwKICAgICAgICAgICAgICAgIGZpbHRlcnM6W10sCiAgICAgICAgICAgICAgICBxdWV1ZTpbXQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgdmFyIHRlc3RzID0gaWQoInF1bml0LXRlc3RzIiksCiAgICAgICAgICAgICAgICBiYW5uZXIgPSBpZCgicXVuaXQtYmFubmVyIiksCiAgICAgICAgICAgICAgICByZXN1bHQgPSBpZCgicXVuaXQtdGVzdHJlc3VsdCIpOwoKICAgICAgICAgICAgaWYgKHRlc3RzKSB7CiAgICAgICAgICAgICAgICB0ZXN0cy5pbm5lckhUTUwgPSAiIjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGJhbm5lcikgewogICAgICAgICAgICAgICAgYmFubmVyLmNsYXNzTmFtZSA9ICIiOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAocmVzdWx0KSB7CiAgICAgICAgICAgICAgICByZXN1bHQucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChyZXN1bHQpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLy8gY2FsbCBvbiBzdGFydCBvZiBtb2R1bGUgdGVzdCB0byBwcmVwZW5kIG5hbWUgdG8gYWxsIHRlc3RzCiAgICAgICAgbW9kdWxlOmZ1bmN0aW9uIChuYW1lLCB0ZXN0RW52aXJvbm1lbnQpIHsKICAgICAgICAgICAgY29uZmlnLmN1cnJlbnRNb2R1bGUgPSBuYW1lOwoKICAgICAgICAgICAgc3luY2hyb25pemUoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgaWYgKGNvbmZpZy5jdXJyZW50TW9kdWxlKSB7CiAgICAgICAgICAgICAgICAgICAgUVVuaXQubW9kdWxlRG9uZShjb25maWcuY3VycmVudE1vZHVsZSwgY29uZmlnLm1vZHVsZVN0YXRzLmJhZCwgY29uZmlnLm1vZHVsZVN0YXRzLmFsbCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY29uZmlnLmN1cnJlbnRNb2R1bGUgPSBuYW1lOwogICAgICAgICAgICAgICAgY29uZmlnLm1vZHVsZVRlc3RFbnZpcm9ubWVudCA9IHRlc3RFbnZpcm9ubWVudDsKICAgICAgICAgICAgICAgIGNvbmZpZy5tb2R1bGVTdGF0cyA9IHsgYWxsOjAsIGJhZDowIH07CgogICAgICAgICAgICAgICAgUVVuaXQubW9kdWxlU3RhcnQobmFtZSwgdGVzdEVudmlyb25tZW50KTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgYXN5bmNUZXN0OmZ1bmN0aW9uICh0ZXN0TmFtZSwgZXhwZWN0ZWQsIGNhbGxiYWNrKSB7CiAgICAgICAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAyKSB7CiAgICAgICAgICAgICAgICBjYWxsYmFjayA9IGV4cGVjdGVkOwogICAgICAgICAgICAgICAgZXhwZWN0ZWQgPSAwOwogICAgICAgICAgICB9CgogICAgICAgICAgICBRVW5pdC50ZXN0KHRlc3ROYW1lLCBleHBlY3RlZCwgY2FsbGJhY2ssIHRydWUpOwogICAgICAgIH0sCi8vICAgICAgICBjYWxsdGVzdDpmdW5jdGlvbih0ZXN0RW52aXJvbm1lbnQsY2FsbGJhY2spewovLyAgICAgICAgICAgIGNsZWFySW50ZXJ2YWwoY29uZmlnLnRpbWVyKTsKLy8gICAgICAgICAgICBjYWxsYmFjay5jYWxsKHRlc3RFbnZpcm9ubWVudCk7Ci8vCi8vICAgICAgICB9LAoKICAgICAgICB0ZXN0OmZ1bmN0aW9uICh0ZXN0TmFtZSwgZXhwZWN0ZWQsIGNhbGxiYWNrLCBhc3luYykgewogICAgICAgICAgICB2YXIgbmFtZSA9IHRlc3ROYW1lLCB0ZXN0RW52aXJvbm1lbnQsIHRlc3RFbnZpcm9ubWVudEFyZzsKCiAgICAgICAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAyKSB7CiAgICAgICAgICAgICAgICBjYWxsYmFjayA9IGV4cGVjdGVkOwogICAgICAgICAgICAgICAgZXhwZWN0ZWQgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIGlzIDJuZCBhcmd1bWVudCBhIHRlc3RFbnZpcm9ubWVudD8KICAgICAgICAgICAgaWYgKGV4cGVjdGVkICYmIHR5cGVvZiBleHBlY3RlZCA9PT0gJ29iamVjdCcpIHsKICAgICAgICAgICAgICAgIHRlc3RFbnZpcm9ubWVudEFyZyA9IGV4cGVjdGVkOwogICAgICAgICAgICAgICAgZXhwZWN0ZWQgPSBudWxsOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoY29uZmlnLmN1cnJlbnRNb2R1bGUpIHsKICAgICAgICAgICAgICAgIG5hbWUgPSBjb25maWcuY3VycmVudE1vZHVsZSArICIgbW9kdWxlOiAiICsgbmFtZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCF2YWxpZFRlc3QobmFtZSkpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgc3luY2hyb25pemUoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIFFVbml0LnN0b3BDb3VudCA9IDA7CiAgICAgICAgICAgICAgICAgICAgUVVuaXQuc3RhcnRDb3VudCA9IDA7CiAgICAgICAgICAgICAgICAgICAgUVVuaXQudGVzdFN0YXJ0KHRlc3ROYW1lKTsKCiAgICAgICAgICAgICAgICAgICAgdGVzdEVudmlyb25tZW50ID0gZXh0ZW5kKHsKICAgICAgICAgICAgICAgICAgICAgICAgc2V0dXA6ZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICB0ZWFyZG93bjpmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9LCBjb25maWcubW9kdWxlVGVzdEVudmlyb25tZW50KTsKICAgICAgICAgICAgICAgICAgICBpZiAodGVzdEVudmlyb25tZW50QXJnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGV4dGVuZCh0ZXN0RW52aXJvbm1lbnQsIHRlc3RFbnZpcm9ubWVudEFyZyk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvLyBhbGxvdyB1dGlsaXR5IGZ1bmN0aW9ucyB0byBhY2Nlc3MgdGhlIGN1cnJlbnQgdGVzdCBlbnZpcm9ubWVudAogICAgICAgICAgICAgICAgICAgIFFVbml0LmN1cnJlbnRfdGVzdEVudmlyb25tZW50ID0gdGVzdEVudmlyb25tZW50OwoKICAgICAgICAgICAgICAgICAgICBjb25maWcuYXNzZXJ0aW9ucyA9IFtdOwogICAgICAgICAgICAgICAgICAgIGNvbmZpZy5leHBlY3RlZCA9IGV4cGVjdGVkOwoKICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWNvbmZpZy5wb2xsdXRpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNhdmVHbG9iYWwoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgdGVzdEVudmlyb25tZW50LnNldHVwLmNhbGwodGVzdEVudmlyb25tZW50KTsKCiAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICBRVW5pdC5vayhmYWxzZSwgIlNldHVwIGZhaWxlZCBvbiAiICsgbmFtZSArICI6ICIgKyBlLm1lc3NhZ2UpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgaWYgKGFzeW5jKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIFFVbml0LnN0b3AoKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChRVW5pdC5yZWFkeUZsYWcgPT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uZmlnLnRpbWVyID0gc2V0SW50ZXJ2YWwoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChRVW5pdC5yZWFkeUZsYWcgPT0gMSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjay5jYWxsKHRlc3RFbnZpcm9ubWVudCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChRVW5pdC5zdG9wQ291bnQgPT0gMSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbGVhckludGVydmFsKGNvbmZpZy50aW1lcik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwgMTAwKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrLmNhbGwodGVzdEVudmlyb25tZW50KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBjYXRjaAogICAgICAgICAgICAgICAgICAgICAgICAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICBmYWlsKCJUZXN0ICIgKyBuYW1lICsgIiBkaWVkLCBleGNlcHRpb24gYW5kIHRlc3QgZm9sbG93cyIsIGUsIGNhbGxiYWNrKTsKICAgICAgICAgICAgICAgICAgICAgICAgUVVuaXQub2soZmFsc2UsICJEaWVkIG9uIHRlc3QgIyIgKyAoY29uZmlnLmFzc2VydGlvbnMubGVuZ3RoICsgMSkgKyAiOiAiICsgZS5tZXNzYWdlKTsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gZWxzZSBuZXh0IHRlc3Qgd2lsbCBjYXJyeSB0aGUgcmVzcG9uc2liaWxpdHkKICAgICAgICAgICAgICAgICAgICAgICAgc2F2ZUdsb2JhbCgpOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gUmVzdGFydCB0aGUgdGVzdHMgaWYgdGhleSdyZSBibG9ja2luZwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoY29uZmlnLmJsb2NraW5nKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGFydCgpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICApCiAgICAgICAgICAgIDsKCiAgICAgICAgICAgIHN5bmNocm9uaXplKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgY2hlY2tQb2xsdXRpb24oKTsKICAgICAgICAgICAgICAgICAgICB0ZXN0RW52aXJvbm1lbnQudGVhcmRvd24uY2FsbCh0ZXN0RW52aXJvbm1lbnQpOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgIFFVbml0Lm9rKGZhbHNlLCAiVGVhcmRvd24gZmFpbGVkIG9uICIgKyBuYW1lICsgIjogIiArIGUubWVzc2FnZSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICBRVW5pdC5yZXNldCgpOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgIGZhaWwoInJlc2V0KCkgZmFpbGVkLCBmb2xsb3dpbmcgVGVzdCAiICsgbmFtZSArICIsIGV4Y2VwdGlvbiBhbmQgcmVzZXQgZm4gZm9sbG93cyIsIGUsIHJlc2V0KTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoY29uZmlnLmV4cGVjdGVkICYmIGNvbmZpZy5leHBlY3RlZCAhPSBjb25maWcuYXNzZXJ0aW9ucy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICBRVW5pdC5vayhmYWxzZSwgIkV4cGVjdGVkICIgKyBjb25maWcuZXhwZWN0ZWQgKyAiIGFzc2VydGlvbnMsIGJ1dCAiICsgY29uZmlnLmFzc2VydGlvbnMubGVuZ3RoICsgIiB3ZXJlIHJ1biIpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHZhciBnb29kID0gMCwgYmFkID0gMCwKICAgICAgICAgICAgICAgICAgICB0ZXN0cyA9IGlkKCJxdW5pdC10ZXN0cyIpOwoKICAgICAgICAgICAgICAgIGNvbmZpZy5zdGF0cy5hbGwgKz0gY29uZmlnLmFzc2VydGlvbnMubGVuZ3RoOwogICAgICAgICAgICAgICAgY29uZmlnLm1vZHVsZVN0YXRzLmFsbCArPSBjb25maWcuYXNzZXJ0aW9ucy5sZW5ndGg7CgogICAgICAgICAgICAgICAgaWYgKHRlc3RzKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIG9sID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgib2wiKTsKICAgICAgICAgICAgICAgICAgICBvbC5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiOwoKICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGNvbmZpZy5hc3NlcnRpb25zLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBhc3NlcnRpb24gPSBjb25maWcuYXNzZXJ0aW9uc1tpXTsKCiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBsaSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImxpIik7CiAgICAgICAgICAgICAgICAgICAgICAgIGxpLmNsYXNzTmFtZSA9IGFzc2VydGlvbi5yZXN1bHQgPyAicGFzcyIgOiAiZmFpbCI7CiAgICAgICAgICAgICAgICAgICAgICAgIGxpLmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKGFzc2VydGlvbi5tZXNzYWdlIHx8ICIobm8gbWVzc2FnZSkiKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIG9sLmFwcGVuZENoaWxkKGxpKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChhc3NlcnRpb24ucmVzdWx0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBnb29kKys7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBiYWQrKzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbmZpZy5zdGF0cy5iYWQrKzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbmZpZy5tb2R1bGVTdGF0cy5iYWQrKzsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgdmFyIGIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzdHJvbmciKTsKICAgICAgICAgICAgICAgICAgICBiLmlubmVySFRNTCA9IG5hbWUgKyAiIDxiIHN0eWxlPSdjb2xvcjpibGFjazsnPig8YiBjbGFzcz0nZmFpbCc+IiArIGJhZCArICI8L2I+LCA8YiBjbGFzcz0ncGFzcyc+IiArIGdvb2QgKyAiPC9iPiwgIiArIGNvbmZpZy5hc3NlcnRpb25zLmxlbmd0aCArICIpPC9iPiI7CgogICAgICAgICAgICAgICAgICAgIGFkZEV2ZW50KGIsICJjbGljayIsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG5leHQgPSBiLm5leHRTaWJsaW5nLCBkaXNwbGF5ID0gbmV4dC5zdHlsZS5kaXNwbGF5OwogICAgICAgICAgICAgICAgICAgICAgICBuZXh0LnN0eWxlLmRpc3BsYXkgPSBkaXNwbGF5ID09PSAibm9uZSIgPyAiYmxvY2siIDogIm5vbmUiOwogICAgICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgICAgICBhZGRFdmVudChiLCAiZGJsY2xpY2siLCBmdW5jdGlvbiAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgdGFyZ2V0ID0gZSAmJiBlLnRhcmdldCA/IGUudGFyZ2V0IDogd2luZG93LmV2ZW50LnNyY0VsZW1lbnQ7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0YXJnZXQubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gInN0cm9uZyIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0ZXh0ID0gIiIsIG5vZGUgPSB0YXJnZXQuZmlyc3RDaGlsZDsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aGlsZSAobm9kZS5ub2RlVHlwZSA9PT0gMykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRleHQgKz0gbm9kZS5ub2RlVmFsdWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZSA9IG5vZGUubmV4dFNpYmxpbmc7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGV4dCA9IHRleHQucmVwbGFjZSgvKF5ccyp8XHMqJCkvZywgIiIpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cubG9jYXRpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cubG9jYXRpb24uaHJlZiA9IHdpbmRvdy5sb2NhdGlvbi5ocmVmLm1hdGNoKC9eKC4rPykoXD8uKik/JC8pWzFdICsgIj8iICsgZW5jb2RlVVJJQ29tcG9uZW50KHRleHQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgICAgIHZhciBsaSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImxpIik7CiAgICAgICAgICAgICAgICAgICAgbGkuY2xhc3NOYW1lID0gYmFkID8gImZhaWwiIDogInBhc3MiOwogICAgICAgICAgICAgICAgICAgIGxpLmFwcGVuZENoaWxkKGIpOwogICAgICAgICAgICAgICAgICAgIGxpLmFwcGVuZENoaWxkKG9sKTsKICAgICAgICAgICAgICAgICAgICB0ZXN0cy5hcHBlbmRDaGlsZChsaSk7CgogICAgICAgICAgICAgICAgICAgIGlmIChiYWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRvb2xiYXIgPSBpZCgicXVuaXQtdGVzdHJ1bm5lci10b29sYmFyIik7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0b29sYmFyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b29sYmFyLnN0eWxlLmRpc3BsYXkgPSAiYmxvY2siOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWQoInF1bml0LWZpbHRlci1wYXNzIikuZGlzYWJsZWQgPSBudWxsOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWQoInF1bml0LWZpbHRlci1taXNzaW5nIikuZGlzYWJsZWQgPSBudWxsOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjb25maWcuYXNzZXJ0aW9ucy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWNvbmZpZy5hc3NlcnRpb25zW2ldLnJlc3VsdCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYmFkKys7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25maWcuc3RhdHMuYmFkKys7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25maWcubW9kdWxlU3RhdHMuYmFkKys7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgUVVuaXQudGVzdERvbmUodGVzdE5hbWUsIGJhZCwgY29uZmlnLmFzc2VydGlvbnMpOwoKICAgICAgICAgICAgICAgIGlmICghd2luZG93LnNldFRpbWVvdXQgJiYgIWNvbmZpZy5xdWV1ZS5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICBkb25lKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgaWYgKHdpbmRvdy5zZXRUaW1lb3V0ICYmICFjb25maWcuZG9uZVRpbWVyKSB7CiAgICAgICAgICAgICAgICBjb25maWcuZG9uZVRpbWVyID0gd2luZG93LnNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIGlmICghY29uZmlnLnF1ZXVlLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgICAgICBkb25lKCk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgc3luY2hyb25pemUoZG9uZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwgMTMpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogU3BlY2lmeSB0aGUgbnVtYmVyIG9mIGV4cGVjdGVkIGFzc2VydGlvbnMgdG8gZ3VyYW50ZWUgdGhhdCBmYWlsZWQgdGVzdCAobm8gYXNzZXJ0aW9ucyBhcmUgcnVuIGF0IGFsbCkgZG9uJ3Qgc2xpcCB0aHJvdWdoLgogICAgICAgICAqLwogICAgICAgIGV4cGVjdDpmdW5jdGlvbiAoYXNzZXJ0cykgewogICAgICAgICAgICBjb25maWcuZXhwZWN0ZWQgPSBhc3NlcnRzOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEFzc2VydHMgdHJ1ZS4KICAgICAgICAgKiBAZXhhbXBsZSBvayggImFzZGZhc2RmIi5sZW5ndGggPiA1LCAiVGhlcmUgbXVzdCBiZSBhdCBsZWFzdCA1IGNoYXJzIiApOwogICAgICAgICAqLwogICAgICAgIG9rOmZ1bmN0aW9uIChhLCBtc2cpIHsKICAgICAgICAgICAgZGV0YWlsRm9yQXJyZXJ0ICs9IGEgPyAnJyA6ICdtYXNzYWdlOicgKyBtc2cgKyAnXFxuJzsKICAgICAgICAgICAgUVVuaXQubG9nKGEsIG1zZyk7CiAgICAgICAgICAgIGNvbmZpZy5hc3NlcnRpb25zLnB1c2goewogICAgICAgICAgICAgICAgcmVzdWx0OiEhYSwKICAgICAgICAgICAgICAgIG1lc3NhZ2U6bXNnCiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIENoZWNrcyB0aGF0IHRoZSBmaXJzdCB0d28gYXJndW1lbnRzIGFyZSBlcXVhbCwgd2l0aCBhbiBvcHRpb25hbCBtZXNzYWdlLgogICAgICAgICAqIFByaW50cyBvdXQgYm90aCBhY3R1YWwgYW5kIGV4cGVjdGVkIHZhbHVlcy4KICAgICAgICAgKgogICAgICAgICAqIFByZWZlcmVkIHRvIG9rKCBhY3R1YWwgPT0gZXhwZWN0ZWQsIG1lc3NhZ2UgKQogICAgICAgICAqCiAgICAgICAgICogQGV4YW1wbGUgZXF1YWwoIGZvcm1hdCgiUmVjZWl2ZWQgezB9IGJ5dGVzLiIsIDIpLCAiUmVjZWl2ZWQgMiBieXRlcy4iICk7CiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0gT2JqZWN0IGFjdHVhbAogICAgICAgICAqIEBwYXJhbSBPYmplY3QgZXhwZWN0ZWQKICAgICAgICAgKiBAcGFyYW0gU3RyaW5nIG1lc3NhZ2UgKG9wdGlvbmFsKQogICAgICAgICAqLwogICAgICAgIGVxdWFsOmZ1bmN0aW9uIChhY3R1YWwsIGV4cGVjdGVkLCBtZXNzYWdlKSB7CiAgICAgICAgICAgIHB1c2goZXhwZWN0ZWQgPT0gYWN0dWFsLCBhY3R1YWwsIGV4cGVjdGVkLCBtZXNzYWdlKTsKICAgICAgICB9LAoKICAgICAgICBub3RFcXVhbDpmdW5jdGlvbiAoYWN0dWFsLCBleHBlY3RlZCwgbWVzc2FnZSkgewogICAgICAgICAgICBwdXNoKGV4cGVjdGVkICE9IGFjdHVhbCwgYWN0dWFsLCBleHBlY3RlZCwgbWVzc2FnZSk7CiAgICAgICAgfSwKCiAgICAgICAgZGVlcEVxdWFsOmZ1bmN0aW9uIChhLCBiLCBtZXNzYWdlKSB7CiAgICAgICAgICAgIHB1c2goUVVuaXQuZXF1aXYoYSwgYiksIGEsIGIsIG1lc3NhZ2UpOwogICAgICAgIH0sCgogICAgICAgIG5vdERlZXBFcXVhbDpmdW5jdGlvbiAoYSwgYiwgbWVzc2FnZSkgewogICAgICAgICAgICBwdXNoKCFRVW5pdC5lcXVpdihhLCBiKSwgYSwgYiwgbWVzc2FnZSk7CiAgICAgICAgfSwKCiAgICAgICAgc3RyaWN0RXF1YWw6ZnVuY3Rpb24gKGFjdHVhbCwgZXhwZWN0ZWQsIG1lc3NhZ2UpIHsKICAgICAgICAgICAgcHVzaChleHBlY3RlZCA9PT0gYWN0dWFsLCBhY3R1YWwsIGV4cGVjdGVkLCBtZXNzYWdlKTsKICAgICAgICB9LAoKICAgICAgICBub3RTdHJpY3RFcXVhbDpmdW5jdGlvbiAoYWN0dWFsLCBleHBlY3RlZCwgbWVzc2FnZSkgewogICAgICAgICAgICBwdXNoKGV4cGVjdGVkICE9PSBhY3R1YWwsIGFjdHVhbCwgZXhwZWN0ZWQsIG1lc3NhZ2UpOwogICAgICAgIH0sCgogICAgICAgIHN0YXJ0OmZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgUVVuaXQuc3RhcnRDb3VudCsrOwogICAgICAgICAgICBRVW5pdC5zdG9wQ291bnQtLTsKICAgICAgICAgICAgLy8gQSBzbGlnaHQgZGVsYXksIHRvIGF2b2lkIGFueSBjdXJyZW50IGNhbGxiYWNrcwogICAgICAgICAgICBpZiAod2luZG93LnNldFRpbWVvdXQpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5zZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoY29uZmlnLnRpbWVvdXQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KGNvbmZpZy50aW1lb3V0KTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGNvbmZpZy5ibG9ja2luZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIHByb2Nlc3MoKTsKICAgICAgICAgICAgICAgIH0sIDEzKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGNvbmZpZy5ibG9ja2luZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgcHJvY2VzcygpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgc3RvcDpmdW5jdGlvbiAodGltZW91dCkgewogICAgICAgICAgICBjb25maWcuYmxvY2tpbmcgPSB0cnVlOwogICAgICAgICAgICBRVW5pdC5zdG9wQ291bnQrKzsKICAgICAgICAgICAgaWYgKHRpbWVvdXQgJiYgd2luZG93LnNldFRpbWVvdXQpIHsKICAgICAgICAgICAgICAgIGNvbmZpZy50aW1lb3V0ID0gd2luZG93LnNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIFFVbml0Lm9rKGZhbHNlLCAiVGVzdCB0aW1lZCBvdXQiKTsKICAgICAgICAgICAgICAgICAgICBRVW5pdC5zdGFydCgpOwogICAgICAgICAgICAgICAgfSwgdGltZW91dCk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBSZXNldHMgdGhlIHRlc3Qgc2V0dXAuIFVzZWZ1bCBmb3IgdGVzdHMgdGhhdCBtb2RpZnkgdGhlIERPTS4KICAgICAgICAgKi8KICAgICAgICByZXNldDpmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGlmICh3aW5kb3cualF1ZXJ5KSB7CiAgICAgICAgICAgICAgICBqUXVlcnkoIiNtYWluIikuaHRtbChjb25maWcuZml4dHVyZSk7CiAgICAgICAgICAgICAgICBqUXVlcnkuZXZlbnQuZ2xvYmFsID0ge307CiAgICAgICAgICAgICAgICBqUXVlcnkuYWpheFNldHRpbmdzID0gZXh0ZW5kKHt9LCBjb25maWcuYWpheFNldHRpbmdzKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIFRyaWdnZXIgYW4gZXZlbnQgb24gYW4gZWxlbWVudC4KICAgICAgICAgKgogICAgICAgICAqIEBleGFtcGxlIHRyaWdnZXJFdmVudCggZG9jdW1lbnQuYm9keSwgImNsaWNrIiApOwogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIERPTUVsZW1lbnQgZWxlbQogICAgICAgICAqIEBwYXJhbSBTdHJpbmcgdHlwZQogICAgICAgICAqLwogICAgICAgIHRyaWdnZXJFdmVudDpmdW5jdGlvbiAoZWxlbSwgdHlwZSwgZXZlbnQpIHsKICAgICAgICAgICAgaWYgKGRvY3VtZW50LmNyZWF0ZUV2ZW50KSB7CiAgICAgICAgICAgICAgICBldmVudCA9IGRvY3VtZW50LmNyZWF0ZUV2ZW50KCJNb3VzZUV2ZW50cyIpOwogICAgICAgICAgICAgICAgZXZlbnQuaW5pdE1vdXNlRXZlbnQodHlwZSwgdHJ1ZSwgdHJ1ZSwgZWxlbS5vd25lckRvY3VtZW50LmRlZmF1bHRWaWV3LAogICAgICAgICAgICAgICAgICAgIDAsIDAsIDAsIDAsIDAsIGZhbHNlLCBmYWxzZSwgZmFsc2UsIGZhbHNlLCAwLCBudWxsKTsKICAgICAgICAgICAgICAgIGVsZW0uZGlzcGF0Y2hFdmVudChldmVudCk7CgogICAgICAgICAgICB9IGVsc2UgaWYgKGVsZW0uZmlyZUV2ZW50KSB7CiAgICAgICAgICAgICAgICBlbGVtLmZpcmVFdmVudCgib24iICsgdHlwZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvLyBTYWZlIG9iamVjdCB0eXBlIGNoZWNraW5nCiAgICAgICAgaXM6ZnVuY3Rpb24gKHR5cGUsIG9iaikgewogICAgICAgICAgICByZXR1cm4gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKG9iaikgPT09ICJbb2JqZWN0ICIgKyB0eXBlICsgIl0iOwogICAgICAgIH0sCgogICAgICAgIC8vIExvZ2dpbmcgY2FsbGJhY2tzCiAgICAgICAgZG9uZTpmdW5jdGlvbiAoZmFpbHVyZXMsIHRvdGFsLCBkZXRhaWwpIHsKICAgICAgICB9LAogICAgICAgIGxvZzpmdW5jdGlvbiAocmVzdWx0LCBtZXNzYWdlKSB7CiAgICAgICAgfSwKICAgICAgICB0ZXN0U3RhcnQ6ZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICB9LAogICAgICAgIHRlc3REb25lOmZ1bmN0aW9uIChuYW1lLCBmYWlsdXJlcywgdG90YWxEZXRhaWwpIHsKICAgICAgICB9LAogICAgICAgIG1vZHVsZVN0YXJ0OmZ1bmN0aW9uIChuYW1lLCB0ZXN0RW52aXJvbm1lbnQpIHsKICAgICAgICB9LAogICAgICAgIG1vZHVsZURvbmU6ZnVuY3Rpb24gKG5hbWUsIGZhaWx1cmVzLCB0b3RhbCkgewogICAgICAgIH0KICAgIH07Ci8vcmVjb3JkIGRldGFpbCB0ZXN0TmFtZSwgYmFkLCBjb25maWcuYXNzZXJ0aW9ucwogICAgUVVuaXQudGVzdERvbmUgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgaWYgKGFyZ3VtZW50c1swXVsxXSkgewogICAgICAgICAgICBmYWlsZWREZXRhaWwgKz0gJ3Rlc3ROYW1lOicgKyBhcmd1bWVudHNbMF1bMF0gKyAnIGZhaWxOdW06JyArIGFyZ3VtZW50c1swXVsxXSArICJcXG4iICsgZGV0YWlsRm9yQXJyZXJ0OwogICAgICAgICAgICBkZXRhaWxGb3JBcnJlcnQgPSAnJzsKICAgICAgICB9CgogICAgfTsKLy8gQmFja3dhcmRzIGNvbXBhdGliaWxpdHksIGRlcHJlY2F0ZWQKICAgIFFVbml0LmVxdWFscyA9IFFVbml0LmVxdWFsOwogICAgUVVuaXQuc2FtZSA9IFFVbml0LmRlZXBFcXVhbDsKICAgIFFVbml0LnN0b3BDb3VudCA9IDA7CiAgICBRVW5pdC5zdGFydENvdW50ID0gMDsKICAgIFFVbml0LnJlYWR5RmxhZyA9IDE7Ci8vIE1haW50YWluIGludGVybmFsIHN0YXRlCiAgICB2YXIgY29uZmlnID0gewogICAgICAgIC8vIFRoZSBxdWV1ZSBvZiB0ZXN0cyB0byBydW4KICAgICAgICBxdWV1ZTpbXSwKCiAgICAgICAgLy8gYmxvY2sgdW50aWwgZG9jdW1lbnQgcmVhZHkKICAgICAgICBibG9ja2luZzp0cnVlLAoKCiAgICAgICAgdGltZXI6IiIKICAgIH07Ci8vZmFpbGVkIGRldGFpbCBmb3IgZWFjaCB0ZXN0IGRvbmUKICAgIHZhciBmYWlsZWREZXRhaWwgPSAnJzsKICAgIHZhciBkZXRhaWxGb3JBcnJlcnQgPSAnJzsKLy8gTG9hZCBwYXJhbWF0ZXJzCiAgICAoZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBsb2NhdGlvbiA9IHdpbmRvdy5sb2NhdGlvbiB8fCB7IHNlYXJjaDoiIiwgcHJvdG9jb2w6ImZpbGU6IiB9LAogICAgICAgICAgICBHRVRQYXJhbXMgPSBsb2NhdGlvbi5zZWFyY2guc2xpY2UoMSkuc3BsaXQoJyYnKTsKCiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBHRVRQYXJhbXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgR0VUUGFyYW1zW2ldID0gZGVjb2RlVVJJQ29tcG9uZW50KEdFVFBhcmFtc1tpXSk7CiAgICAgICAgICAgIGlmIChHRVRQYXJhbXNbaV0gPT09ICJub2dsb2JhbHMiKSB7CiAgICAgICAgICAgICAgICBHRVRQYXJhbXMuc3BsaWNlKGksIDEpOwogICAgICAgICAgICAgICAgaS0tOwogICAgICAgICAgICAgICAgY29uZmlnLm5vZ2xvYmFscyA9IHRydWU7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoR0VUUGFyYW1zW2ldLnNlYXJjaCgnPScpID4gLTEpIHsKICAgICAgICAgICAgICAgIEdFVFBhcmFtcy5zcGxpY2UoaSwgMSk7CiAgICAgICAgICAgICAgICBpLS07CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIHJlc3RyaWN0IG1vZHVsZXMvdGVzdHMgYnkgZ2V0IHBhcmFtZXRlcnMKICAgICAgICBjb25maWcuZmlsdGVycyA9IEdFVFBhcmFtczsKCiAgICAgICAgLy8gRmlndXJlIG91dCBpZiB3ZSdyZSBydW5uaW5nIHRoZSB0ZXN0cyBmcm9tIGEgc2VydmVyIG9yIG5vdAogICAgICAgIFFVbml0LmlzTG9jYWwgPSAhIShsb2NhdGlvbi5wcm90b2NvbCA9PT0gJ2ZpbGU6Jyk7CiAgICB9KSgpOwoKLy8gRXhwb3NlIHRoZSBBUEkgYXMgZ2xvYmFsIHZhcmlhYmxlcywgdW5sZXNzIGFuICdleHBvcnRzJwovLyBvYmplY3QgZXhpc3RzLCBpbiB0aGF0IGNhc2Ugd2UgYXNzdW1lIHdlJ3JlIGluIENvbW1vbkpTCiAgICBpZiAodHlwZW9mIGV4cG9ydHMgPT09ICJ1bmRlZmluZWQiIHx8IHR5cGVvZiByZXF1aXJlID09PSAidW5kZWZpbmVkIikgewogICAgICAgIGV4dGVuZCh3aW5kb3csIFFVbml0KTsKICAgICAgICB3aW5kb3cuUVVuaXQgPSBRVW5pdDsKICAgIH0gZWxzZSB7CiAgICAgICAgZXh0ZW5kKGV4cG9ydHMsIFFVbml0KTsKICAgICAgICBleHBvcnRzLlFVbml0ID0gUVVuaXQ7CiAgICB9CgogICAgaWYgKHR5cGVvZiBkb2N1bWVudCA9PT0gInVuZGVmaW5lZCIgfHwgZG9jdW1lbnQucmVhZHlTdGF0ZSA9PT0gImNvbXBsZXRlIikgewogICAgICAgIGNvbmZpZy5hdXRvcnVuID0gdHJ1ZTsKICAgIH0KCiAgICBhZGRFdmVudCh3aW5kb3csICJsb2FkIiwgZnVuY3Rpb24gKCkgewogICAgICAgIC8vIEluaXRpYWxpemUgdGhlIGNvbmZpZywgc2F2aW5nIHRoZSBleGVjdXRpb24gcXVldWUKICAgICAgICB2YXIgb2xkY29uZmlnID0gZXh0ZW5kKHt9LCBjb25maWcpOwogICAgICAgIFFVbml0LmluaXQoKTsKICAgICAgICBleHRlbmQoY29uZmlnLCBvbGRjb25maWcpOwoKICAgICAgICBjb25maWcuYmxvY2tpbmcgPSBmYWxzZTsKCiAgICAgICAgdmFyIHVzZXJBZ2VudCA9IGlkKCJxdW5pdC11c2VyQWdlbnQiKTsKICAgICAgICBpZiAodXNlckFnZW50KSB7CiAgICAgICAgICAgIHVzZXJBZ2VudC5pbm5lckhUTUwgPSBuYXZpZ2F0b3IudXNlckFnZW50OwogICAgICAgIH0KCiAgICAgICAgdmFyIHRvb2xiYXIgPSBpZCgicXVuaXQtdGVzdHJ1bm5lci10b29sYmFyIik7CiAgICAgICAgaWYgKHRvb2xiYXIpIHsKICAgICAgICAgICAgdG9vbGJhci5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiOwoKICAgICAgICAgICAgdmFyIGZpbHRlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImlucHV0Iik7CiAgICAgICAgICAgIGZpbHRlci50eXBlID0gImNoZWNrYm94IjsKICAgICAgICAgICAgZmlsdGVyLmlkID0gInF1bml0LWZpbHRlci1wYXNzIjsKICAgICAgICAgICAgZmlsdGVyLmRpc2FibGVkID0gdHJ1ZTsKICAgICAgICAgICAgYWRkRXZlbnQoZmlsdGVyLCAiY2xpY2siLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB2YXIgbGkgPSBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgibGkiKTsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGkubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBpZiAobGlbaV0uY2xhc3NOYW1lLmluZGV4T2YoInBhc3MiKSA+IC0xKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGxpW2ldLnN0eWxlLmRpc3BsYXkgPSBmaWx0ZXIuY2hlY2tlZCA/ICJub25lIiA6ICIiOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHRvb2xiYXIuYXBwZW5kQ2hpbGQoZmlsdGVyKTsKCiAgICAgICAgICAgIHZhciBsYWJlbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImxhYmVsIik7CiAgICAgICAgICAgIGxhYmVsLnNldEF0dHJpYnV0ZSgiZm9yIiwgInF1bml0LWZpbHRlci1wYXNzIik7CiAgICAgICAgICAgIGxhYmVsLmlubmVySFRNTCA9ICJIaWRlIHBhc3NlZCB0ZXN0cyI7CiAgICAgICAgICAgIHRvb2xiYXIuYXBwZW5kQ2hpbGQobGFiZWwpOwoKICAgICAgICAgICAgdmFyIG1pc3NpbmcgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJpbnB1dCIpOwogICAgICAgICAgICBtaXNzaW5nLnR5cGUgPSAiY2hlY2tib3giOwogICAgICAgICAgICBtaXNzaW5nLmlkID0gInF1bml0LWZpbHRlci1taXNzaW5nIjsKICAgICAgICAgICAgbWlzc2luZy5kaXNhYmxlZCA9IHRydWU7CiAgICAgICAgICAgIGFkZEV2ZW50KG1pc3NpbmcsICJjbGljayIsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHZhciBsaSA9IGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCJsaSIpOwogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsaS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGlmIChsaVtpXS5jbGFzc05hbWUuaW5kZXhPZigiZmFpbCIpID4gLTEgJiYgbGlbaV0uaW5uZXJIVE1MLmluZGV4T2YoJ21pc3NpbmcgdGVzdCAtIHVudGVzdGVkIGNvZGUgaXMgYnJva2VuIGNvZGUnKSA+IC0xKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGxpW2ldLnBhcmVudE5vZGUucGFyZW50Tm9kZS5zdHlsZS5kaXNwbGF5ID0gbWlzc2luZy5jaGVja2VkID8gIm5vbmUiIDogImJsb2NrIjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0b29sYmFyLmFwcGVuZENoaWxkKG1pc3NpbmcpOwoKICAgICAgICAgICAgbGFiZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJsYWJlbCIpOwogICAgICAgICAgICBsYWJlbC5zZXRBdHRyaWJ1dGUoImZvciIsICJxdW5pdC1maWx0ZXItbWlzc2luZyIpOwogICAgICAgICAgICBsYWJlbC5pbm5lckhUTUwgPSAiSGlkZSBtaXNzaW5nIHRlc3RzICh1bnRlc3RlZCBjb2RlIGlzIGJyb2tlbiBjb2RlKSI7CiAgICAgICAgICAgIHRvb2xiYXIuYXBwZW5kQ2hpbGQobGFiZWwpOwogICAgICAgIH0KCiAgICAgICAgdmFyIG1haW4gPSBpZCgnbWFpbicpOwogICAgICAgIGlmIChtYWluKSB7CiAgICAgICAgICAgIGNvbmZpZy5maXh0dXJlID0gbWFpbi5pbm5lckhUTUw7CiAgICAgICAgfQoKICAgICAgICBpZiAod2luZG93LmpRdWVyeSkgewogICAgICAgICAgICBjb25maWcuYWpheFNldHRpbmdzID0gd2luZG93LmpRdWVyeS5hamF4U2V0dGluZ3M7CiAgICAgICAgfQoKICAgICAgICBRVW5pdC5zdGFydCgpOwogICAgfSk7CgogICAgZnVuY3Rpb24gZG9uZSgpIHsKICAgICAgICBpZiAoY29uZmlnLmRvbmVUaW1lciAmJiB3aW5kb3cuY2xlYXJUaW1lb3V0KSB7CiAgICAgICAgICAgIHdpbmRvdy5jbGVhclRpbWVvdXQoY29uZmlnLmRvbmVUaW1lcik7CiAgICAgICAgICAgIGNvbmZpZy5kb25lVGltZXIgPSBudWxsOwogICAgICAgIH0KCiAgICAgICAgaWYgKGNvbmZpZy5xdWV1ZS5sZW5ndGgpIHsKICAgICAgICAgICAgY29uZmlnLmRvbmVUaW1lciA9IHdpbmRvdy5zZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIGlmICghY29uZmlnLnF1ZXVlLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgIGRvbmUoKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgc3luY2hyb25pemUoZG9uZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sIDEzKTsKCiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGNvbmZpZy5hdXRvcnVuID0gdHJ1ZTsKCiAgICAgICAgLy8gTG9nIHRoZSBsYXN0IG1vZHVsZSByZXN1bHRzCiAgICAgICAgaWYgKGNvbmZpZy5jdXJyZW50TW9kdWxlKSB7CiAgICAgICAgICAgIFFVbml0Lm1vZHVsZURvbmUoY29uZmlnLmN1cnJlbnRNb2R1bGUsIGNvbmZpZy5tb2R1bGVTdGF0cy5iYWQsIGNvbmZpZy5tb2R1bGVTdGF0cy5hbGwpOwogICAgICAgIH0KCiAgICAgICAgdmFyIGJhbm5lciA9IGlkKCJxdW5pdC1iYW5uZXIiKSwKICAgICAgICAgICAgdGVzdHMgPSBpZCgicXVuaXQtdGVzdHMiKSwKICAgICAgICAgICAgaHRtbCA9IFsnVGVzdHMgY29tcGxldGVkIGluICcsCiAgICAgICAgICAgICAgICArbmV3IERhdGUgLSBjb25maWcuc3RhcnRlZCwgJyBtaWxsaXNlY29uZHMuPGJyLz4nLAogICAgICAgICAgICAgICAgJzxzcGFuIGNsYXNzPSJwYXNzZWQiPicsIGNvbmZpZy5zdGF0cy5hbGwgLSBjb25maWcuc3RhdHMuYmFkLCAnPC9zcGFuPiB0ZXN0cyBvZiA8c3BhbiBjbGFzcz0idG90YWwiPicsIGNvbmZpZy5zdGF0cy5hbGwsICc8L3NwYW4+IHBhc3NlZCwgPHNwYW4gY2xhc3M9ImZhaWxlZCI+JywgY29uZmlnLnN0YXRzLmJhZCwgJzwvc3Bhbj4gZmFpbGVkLiddLmpvaW4oJycpOwoKICAgICAgICBpZiAoYmFubmVyKSB7CiAgICAgICAgICAgIGJhbm5lci5jbGFzc05hbWUgPSAoY29uZmlnLnN0YXRzLmJhZCA/ICJxdW5pdC1mYWlsIiA6ICJxdW5pdC1wYXNzIik7CiAgICAgICAgfQoKICAgICAgICBpZiAodGVzdHMpIHsKICAgICAgICAgICAgdmFyIHJlc3VsdCA9IGlkKCJxdW5pdC10ZXN0cmVzdWx0Iik7CgogICAgICAgICAgICBpZiAoIXJlc3VsdCkgewogICAgICAgICAgICAgICAgcmVzdWx0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgicCIpOwogICAgICAgICAgICAgICAgcmVzdWx0LmlkID0gInF1bml0LXRlc3RyZXN1bHQiOwogICAgICAgICAgICAgICAgcmVzdWx0LmNsYXNzTmFtZSA9ICJyZXN1bHQiOwogICAgICAgICAgICAgICAgdGVzdHMucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUocmVzdWx0LCB0ZXN0cy5uZXh0U2libGluZyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJlc3VsdC5pbm5lckhUTUwgPSBodG1sOwogICAgICAgIH0KCiAgICAgICAgUVVuaXQuZG9uZShjb25maWcuc3RhdHMuYmFkLCBjb25maWcuc3RhdHMuYWxsLCBmYWlsZWREZXRhaWwpOwogICAgfQoKICAgIGZ1bmN0aW9uIHZhbGlkVGVzdChuYW1lKSB7CiAgICAgICAgdmFyIGkgPSBjb25maWcuZmlsdGVycy5sZW5ndGgsCiAgICAgICAgICAgIHJ1biA9IGZhbHNlOwoKICAgICAgICBpZiAoIWkpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQoKICAgICAgICB3aGlsZSAoaS0tKSB7CiAgICAgICAgICAgIHZhciBmaWx0ZXIgPSBjb25maWcuZmlsdGVyc1tpXSwKICAgICAgICAgICAgICAgIG5vdCA9IGZpbHRlci5jaGFyQXQoMCkgPT0gJyEnOwoKICAgICAgICAgICAgaWYgKG5vdCkgewogICAgICAgICAgICAgICAgZmlsdGVyID0gZmlsdGVyLnNsaWNlKDEpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAobmFtZS5pbmRleE9mKGZpbHRlcikgIT09IC0xKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gIW5vdDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKG5vdCkgewogICAgICAgICAgICAgICAgcnVuID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHJ1bjsKICAgIH0KCiAgICBmdW5jdGlvbiBwdXNoKHJlc3VsdCwgYWN0dWFsLCBleHBlY3RlZCwgbWVzc2FnZSkgewogICAgICAgIG1lc3NhZ2UgPSBtZXNzYWdlIHx8IChyZXN1bHQgPyAib2theSIgOiAiZmFpbGVkIik7CiAgICAgICAgUVVuaXQub2socmVzdWx0LCByZXN1bHQgPyBtZXNzYWdlICsgIjogIiArIGV4cGVjdGVkIDogbWVzc2FnZSArICIsIGV4cGVjdGVkOiAiICsgUVVuaXQuanNEdW1wLnBhcnNlKGV4cGVjdGVkKSArICIgcmVzdWx0OiAiICsgUVVuaXQuanNEdW1wLnBhcnNlKGFjdHVhbCkpOwogICAgfQoKICAgIGZ1bmN0aW9uIHN5bmNocm9uaXplKGNhbGxiYWNrKSB7CiAgICAgICAgY29uZmlnLnF1ZXVlLnB1c2goY2FsbGJhY2spOwoKICAgICAgICBpZiAoY29uZmlnLmF1dG9ydW4gJiYgIWNvbmZpZy5ibG9ja2luZykgewogICAgICAgICAgICBwcm9jZXNzKCk7CiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIHByb2Nlc3MoKSB7CiAgICAgICAgd2hpbGUgKGNvbmZpZy5xdWV1ZS5sZW5ndGggJiYgIWNvbmZpZy5ibG9ja2luZykgewogICAgICAgICAgICBjb25maWcucXVldWUuc2hpZnQoKSgpOwogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBzYXZlR2xvYmFsKCkgewogICAgICAgIGNvbmZpZy5wb2xsdXRpb24gPSBbXTsKCiAgICAgICAgaWYgKGNvbmZpZy5ub2dsb2JhbHMpIHsKICAgICAgICAgICAgZm9yICh2YXIga2V5IGluIHdpbmRvdykgewogICAgICAgICAgICAgICAgY29uZmlnLnBvbGx1dGlvbi5wdXNoKGtleSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gY2hlY2tQb2xsdXRpb24obmFtZSkgewogICAgICAgIHZhciBvbGQgPSBjb25maWcucG9sbHV0aW9uOwogICAgICAgIHNhdmVHbG9iYWwoKTsKCiAgICAgICAgdmFyIG5ld0dsb2JhbHMgPSBkaWZmKG9sZCwgY29uZmlnLnBvbGx1dGlvbik7CiAgICAgICAgaWYgKG5ld0dsb2JhbHMubGVuZ3RoID4gMCkgewogICAgICAgICAgICBvayhmYWxzZSwgIkludHJvZHVjZWQgZ2xvYmFsIHZhcmlhYmxlKHMpOiAiICsgbmV3R2xvYmFscy5qb2luKCIsICIpKTsKICAgICAgICAgICAgY29uZmlnLmV4cGVjdGVkKys7CiAgICAgICAgfQoKICAgICAgICB2YXIgZGVsZXRlZEdsb2JhbHMgPSBkaWZmKGNvbmZpZy5wb2xsdXRpb24sIG9sZCk7CiAgICAgICAgaWYgKGRlbGV0ZWRHbG9iYWxzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgb2soZmFsc2UsICJEZWxldGVkIGdsb2JhbCB2YXJpYWJsZShzKTogIiArIGRlbGV0ZWRHbG9iYWxzLmpvaW4oIiwgIikpOwogICAgICAgICAgICBjb25maWcuZXhwZWN0ZWQrKzsKICAgICAgICB9CiAgICB9CgovLyByZXR1cm5zIGEgbmV3IEFycmF5IHdpdGggdGhlIGVsZW1lbnRzIHRoYXQgYXJlIGluIGEgYnV0IG5vdCBpbiBiCiAgICBmdW5jdGlvbiBkaWZmKGEsIGIpIHsKICAgICAgICB2YXIgcmVzdWx0ID0gYS5zbGljZSgpOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcmVzdWx0Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgYi5sZW5ndGg7IGorKykgewogICAgICAgICAgICAgICAgaWYgKHJlc3VsdFtpXSA9PT0gYltqXSkgewogICAgICAgICAgICAgICAgICAgIHJlc3VsdC5zcGxpY2UoaSwgMSk7CiAgICAgICAgICAgICAgICAgICAgaS0tOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CgogICAgZnVuY3Rpb24gZmFpbChtZXNzYWdlLCBleGNlcHRpb24sIGNhbGxiYWNrKSB7CiAgICAgICAgaWYgKHR5cGVvZiBjb25zb2xlICE9PSAidW5kZWZpbmVkIiAmJiBjb25zb2xlLmVycm9yICYmIGNvbnNvbGUud2FybikgewogICAgICAgICAgICBjb25zb2xlLmVycm9yKG1lc3NhZ2UpOwogICAgICAgICAgICBjb25zb2xlLmVycm9yKGV4Y2VwdGlvbik7CiAgICAgICAgICAgIGNvbnNvbGUud2FybihjYWxsYmFjay50b1N0cmluZygpKTsKCiAgICAgICAgfSBlbHNlIGlmICh3aW5kb3cub3BlcmEgJiYgb3BlcmEucG9zdEVycm9yKSB7CiAgICAgICAgICAgIG9wZXJhLnBvc3RFcnJvcihtZXNzYWdlLCBleGNlcHRpb24sIGNhbGxiYWNrLnRvU3RyaW5nKTsKICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gZXh0ZW5kKGEsIGIpIHsKICAgICAgICBmb3IgKHZhciBwcm9wIGluIGIpIHsKICAgICAgICAgICAgYVtwcm9wXSA9IGJbcHJvcF07CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gYTsKICAgIH0KCiAgICBmdW5jdGlvbiBhZGRFdmVudChlbGVtLCB0eXBlLCBmbikgewogICAgICAgIGlmIChlbGVtLmFkZEV2ZW50TGlzdGVuZXIpIHsKICAgICAgICAgICAgZWxlbS5hZGRFdmVudExpc3RlbmVyKHR5cGUsIGZuLCBmYWxzZSk7CiAgICAgICAgfSBlbHNlIGlmIChlbGVtLmF0dGFjaEV2ZW50KSB7CiAgICAgICAgICAgIGVsZW0uYXR0YWNoRXZlbnQoIm9uIiArIHR5cGUsIGZuKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBmbigpOwogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBpZChuYW1lKSB7CiAgICAgICAgcmV0dXJuICEhKHR5cGVvZiBkb2N1bWVudCAhPT0gInVuZGVmaW5lZCIgJiYgZG9jdW1lbnQgJiYgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQpICYmCiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKG5hbWUpOwogICAgfQoKLy8gVGVzdCBmb3IgZXF1YWxpdHkgYW55IEphdmFTY3JpcHQgdHlwZS4KLy8gRGlzY3Vzc2lvbnMgYW5kIHJlZmVyZW5jZTogaHR0cDovL3BoaWxyYXRoZS5jb20vYXJ0aWNsZXMvZXF1aXYKLy8gVGVzdCBzdWl0ZXM6IGh0dHA6Ly9waGlscmF0aGUuY29tL3Rlc3RzL2VxdWl2Ci8vIEF1dGhvcjogUGhpbGlwcGUgUmF0aMOpIDxwcmF0aGVAZ21haWwuY29tPgogICAgUVVuaXQuZXF1aXYgPSBmdW5jdGlvbiAoKSB7CgogICAgICAgIHZhciBpbm5lckVxdWl2OyAvLyB0aGUgcmVhbCBlcXVpdiBmdW5jdGlvbgogICAgICAgIHZhciBjYWxsZXJzID0gW107IC8vIHN0YWNrIHRvIGRlY2lkZSBiZXR3ZWVuIHNraXAvYWJvcnQgZnVuY3Rpb25zCgoKICAgICAgICAvLyBEZXRlcm1pbmUgd2hhdCBpcyBvLgogICAgICAgIGZ1bmN0aW9uIGhvb3ppdChvKSB7CiAgICAgICAgICAgIGlmIChRVW5pdC5pcygiU3RyaW5nIiwgbykpIHsKICAgICAgICAgICAgICAgIHJldHVybiAic3RyaW5nIjsKCiAgICAgICAgICAgIH0gZWxzZSBpZiAoUVVuaXQuaXMoIkJvb2xlYW4iLCBvKSkgewogICAgICAgICAgICAgICAgcmV0dXJuICJib29sZWFuIjsKCiAgICAgICAgICAgIH0gZWxzZSBpZiAoUVVuaXQuaXMoIk51bWJlciIsIG8pKSB7CgogICAgICAgICAgICAgICAgaWYgKGlzTmFOKG8pKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICJuYW4iOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gIm51bWJlciI7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBvID09PSAidW5kZWZpbmVkIikgewogICAgICAgICAgICAgICAgcmV0dXJuICJ1bmRlZmluZWQiOwoKICAgICAgICAgICAgICAgIC8vIGNvbnNpZGVyOiB0eXBlb2YgbnVsbCA9PT0gb2JqZWN0CiAgICAgICAgICAgIH0gZWxzZSBpZiAobyA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmV0dXJuICJudWxsIjsKCiAgICAgICAgICAgICAgICAvLyBjb25zaWRlcjogdHlwZW9mIFtdID09PSBvYmplY3QKICAgICAgICAgICAgfSBlbHNlIGlmIChRVW5pdC5pcygiQXJyYXkiLCBvKSkgewogICAgICAgICAgICAgICAgcmV0dXJuICJhcnJheSI7CgogICAgICAgICAgICAgICAgLy8gY29uc2lkZXI6IHR5cGVvZiBuZXcgRGF0ZSgpID09PSBvYmplY3QKICAgICAgICAgICAgfSBlbHNlIGlmIChRVW5pdC5pcygiRGF0ZSIsIG8pKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gImRhdGUiOwoKICAgICAgICAgICAgICAgIC8vIGNvbnNpZGVyOiAvLi8gaW5zdGFuY2VvZiBPYmplY3Q7CiAgICAgICAgICAgICAgICAvLyAgICAgICAgICAgLy4vIGluc3RhbmNlb2YgUmVnRXhwOwogICAgICAgICAgICAgICAgLy8gICAgICAgICAgdHlwZW9mIC8uLyA9PT0gImZ1bmN0aW9uIjsgLy8gPT4gZmFsc2UgaW4gSUUgYW5kIE9wZXJhLAogICAgICAgICAgICAgICAgLy8gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cnVlIGluIEZGIGFuZCBTYWZhcmkKICAgICAgICAgICAgfSBlbHNlIGlmIChRVW5pdC5pcygiUmVnRXhwIiwgbykpIHsKICAgICAgICAgICAgICAgIHJldHVybiAicmVnZXhwIjsKCiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIG8gPT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gIm9iamVjdCI7CgogICAgICAgICAgICB9IGVsc2UgaWYgKFFVbml0LmlzKCJGdW5jdGlvbiIsIG8pKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gImZ1bmN0aW9uIjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIENhbGwgdGhlIG8gcmVsYXRlZCBjYWxsYmFjayB3aXRoIHRoZSBnaXZlbiBhcmd1bWVudHMuCiAgICAgICAgZnVuY3Rpb24gYmluZENhbGxiYWNrcyhvLCBjYWxsYmFja3MsIGFyZ3MpIHsKICAgICAgICAgICAgdmFyIHByb3AgPSBob296aXQobyk7CiAgICAgICAgICAgIGlmIChwcm9wKSB7CiAgICAgICAgICAgICAgICBpZiAoaG9veml0KGNhbGxiYWNrc1twcm9wXSkgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gY2FsbGJhY2tzW3Byb3BdLmFwcGx5KGNhbGxiYWNrcywgYXJncyk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBjYWxsYmFja3NbcHJvcF07IC8vIG9yIHVuZGVmaW5lZAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB2YXIgY2FsbGJhY2tzID0gZnVuY3Rpb24gKCkgewoKICAgICAgICAgICAgLy8gZm9yIHN0cmluZywgYm9vbGVhbiwgbnVtYmVyIGFuZCBudWxsCiAgICAgICAgICAgIGZ1bmN0aW9uIHVzZVN0cmljdEVxdWFsaXR5KGIsIGEpIHsKICAgICAgICAgICAgICAgIGlmIChiIGluc3RhbmNlb2YgYS5jb25zdHJ1Y3RvciB8fCBhIGluc3RhbmNlb2YgYi5jb25zdHJ1Y3RvcikgewogICAgICAgICAgICAgICAgICAgIC8vIHRvIGNhdGNoIHNob3J0IGFubm90YWlvbiBWUyAnbmV3JyBhbm5vdGF0aW9uIG9mIGEgZGVjbGFyYXRpb24KICAgICAgICAgICAgICAgICAgICAvLyBlLmcuIHZhciBpID0gMTsKICAgICAgICAgICAgICAgICAgICAvLyAgICAgIHZhciBqID0gbmV3IE51bWJlcigxKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gYSA9PSBiOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gYSA9PT0gYjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgICJzdHJpbmciOnVzZVN0cmljdEVxdWFsaXR5LAogICAgICAgICAgICAgICAgImJvb2xlYW4iOnVzZVN0cmljdEVxdWFsaXR5LAogICAgICAgICAgICAgICAgIm51bWJlciI6dXNlU3RyaWN0RXF1YWxpdHksCiAgICAgICAgICAgICAgICAibnVsbCI6dXNlU3RyaWN0RXF1YWxpdHksCiAgICAgICAgICAgICAgICAidW5kZWZpbmVkIjp1c2VTdHJpY3RFcXVhbGl0eSwKCiAgICAgICAgICAgICAgICAibmFuIjpmdW5jdGlvbiAoYikgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBpc05hTihiKTsKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgImRhdGUiOmZ1bmN0aW9uIChiLCBhKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGhvb3ppdChiKSA9PT0gImRhdGUiICYmIGEudmFsdWVPZigpID09PSBiLnZhbHVlT2YoKTsKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgInJlZ2V4cCI6ZnVuY3Rpb24gKGIsIGEpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gaG9veml0KGIpID09PSAicmVnZXhwIiAmJgogICAgICAgICAgICAgICAgICAgICAgICBhLnNvdXJjZSA9PT0gYi5zb3VyY2UgJiYgLy8gdGhlIHJlZ2V4IGl0c2VsZgogICAgICAgICAgICAgICAgICAgICAgICBhLmdsb2JhbCA9PT0gYi5nbG9iYWwgJiYgLy8gYW5kIGl0cyBtb2RpZmVycyAoZ21pKSAuLi4KICAgICAgICAgICAgICAgICAgICAgICAgYS5pZ25vcmVDYXNlID09PSBiLmlnbm9yZUNhc2UgJiYKICAgICAgICAgICAgICAgICAgICAgICAgYS5tdWx0aWxpbmUgPT09IGIubXVsdGlsaW5lOwogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICAvLyAtIHNraXAgd2hlbiB0aGUgcHJvcGVydHkgaXMgYSBtZXRob2Qgb2YgYW4gaW5zdGFuY2UgKE9PUCkKICAgICAgICAgICAgICAgIC8vIC0gYWJvcnQgb3RoZXJ3aXNlLAogICAgICAgICAgICAgICAgLy8gICBpbml0aWFsID09PSB3b3VsZCBoYXZlIGNhdGNoIGlkZW50aWNhbCByZWZlcmVuY2VzIGFueXdheQogICAgICAgICAgICAgICAgImZ1bmN0aW9uIjpmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGNhbGxlciA9IGNhbGxlcnNbY2FsbGVycy5sZW5ndGggLSAxXTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gY2FsbGVyICE9PSBPYmplY3QgJiYKICAgICAgICAgICAgICAgICAgICAgICAgdHlwZW9mIGNhbGxlciAhPT0gInVuZGVmaW5lZCI7CiAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgICJhcnJheSI6ZnVuY3Rpb24gKGIsIGEpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgaTsKICAgICAgICAgICAgICAgICAgICB2YXIgbGVuOwoKICAgICAgICAgICAgICAgICAgICAvLyBiIGNvdWxkIGJlIGFuIG9iamVjdCBsaXRlcmFsIGhlcmUKICAgICAgICAgICAgICAgICAgICBpZiAoIShob296aXQoYikgPT09ICJhcnJheSIpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGxlbiA9IGEubGVuZ3RoOwogICAgICAgICAgICAgICAgICAgIGlmIChsZW4gIT09IGIubGVuZ3RoKSB7IC8vIHNhZmUgYW5kIGZhc3RlcgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW47IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWlubmVyRXF1aXYoYVtpXSwgYltpXSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgIm9iamVjdCI6ZnVuY3Rpb24gKGIsIGEpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgaTsKICAgICAgICAgICAgICAgICAgICB2YXIgZXEgPSB0cnVlOyAvLyB1bmxlc3Mgd2UgY2FuIHByb292ZSBpdAogICAgICAgICAgICAgICAgICAgIHZhciBhUHJvcGVydGllcyA9IFtdLCBiUHJvcGVydGllcyA9IFtdOyAvLyBjb2xsZWN0aW9uIG9mIHN0cmluZ3MKCiAgICAgICAgICAgICAgICAgICAgLy8gY29tcGFyaW5nIGNvbnN0cnVjdG9ycyBpcyBtb3JlIHN0cmljdCB0aGFuIHVzaW5nIGluc3RhbmNlb2YKICAgICAgICAgICAgICAgICAgICBpZiAoYS5jb25zdHJ1Y3RvciAhPT0gYi5jb25zdHJ1Y3RvcikgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvLyBzdGFjayBjb25zdHJ1Y3RvciBiZWZvcmUgdHJhdmVyc2luZyBwcm9wZXJ0aWVzCiAgICAgICAgICAgICAgICAgICAgY2FsbGVycy5wdXNoKGEuY29uc3RydWN0b3IpOwoKICAgICAgICAgICAgICAgICAgICBmb3IgKGkgaW4gYSkgeyAvLyBiZSBzdHJpY3Q6IGRvbid0IGVuc3VyZXMgaGFzT3duUHJvcGVydHkgYW5kIGdvIGRlZXAKCiAgICAgICAgICAgICAgICAgICAgICAgIGFQcm9wZXJ0aWVzLnB1c2goaSk7IC8vIGNvbGxlY3QgYSdzIHByb3BlcnRpZXMKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghaW5uZXJFcXVpdihhW2ldLCBiW2ldKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZXEgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgY2FsbGVycy5wb3AoKTsgLy8gdW5zdGFjaywgd2UgYXJlIGRvbmUKCiAgICAgICAgICAgICAgICAgICAgZm9yIChpIGluIGIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYlByb3BlcnRpZXMucHVzaChpKTsgLy8gY29sbGVjdCBiJ3MgcHJvcGVydGllcwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLy8gRW5zdXJlcyBpZGVudGljYWwgcHJvcGVydGllcyBuYW1lCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGVxICYmIGlubmVyRXF1aXYoYVByb3BlcnRpZXMuc29ydCgpLCBiUHJvcGVydGllcy5zb3J0KCkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgIH0oKTsKCiAgICAgICAgaW5uZXJFcXVpdiA9IGZ1bmN0aW9uICgpIHsgLy8gY2FuIHRha2UgbXVsdGlwbGUgYXJndW1lbnRzCiAgICAgICAgICAgIHZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmFwcGx5KGFyZ3VtZW50cyk7CiAgICAgICAgICAgIGlmIChhcmdzLmxlbmd0aCA8IDIpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOyAvLyBlbmQgdHJhbnNpdGlvbgogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gKGZ1bmN0aW9uIChhLCBiKSB7CiAgICAgICAgICAgICAgICBpZiAoYSA9PT0gYikgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOyAvLyBjYXRjaCB0aGUgbW9zdCB5b3UgY2FuCiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGEgPT09IG51bGwgfHwgYiA9PT0gbnVsbCB8fCB0eXBlb2YgYSA9PT0gInVuZGVmaW5lZCIgfHwgdHlwZW9mIGIgPT09ICJ1bmRlZmluZWQiIHx8IGhvb3ppdChhKSAhPT0gaG9veml0KGIpKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOyAvLyBkb24ndCBsb3NlIHRpbWUgd2l0aCBlcnJvciBwcm9uZSBjYXNlcwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gYmluZENhbGxiYWNrcyhhLCBjYWxsYmFja3MsIFtiLCBhXSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gYXBwbHkgdHJhbnNpdGlvbiB3aXRoICgxLi5uKSBhcmd1bWVudHMKICAgICAgICAgICAgfSkoYXJnc1swXSwgYXJnc1sxXSkgJiYgYXJndW1lbnRzLmNhbGxlZS5hcHBseSh0aGlzLCBhcmdzLnNwbGljZSgxLCBhcmdzLmxlbmd0aCAtIDEpKTsKICAgICAgICB9OwoKICAgICAgICByZXR1cm4gaW5uZXJFcXVpdjsKCiAgICB9KCk7CgogICAgLyoqCiAgICAgKiBqc0R1bXAKICAgICAqIENvcHlyaWdodCAoYykgMjAwOCBBcmllbCBGbGVzbGVyIC0gYWZsZXNsZXIoYXQpZ21haWwoZG90KWNvbSB8IGh0dHA6Ly9mbGVzbGVyLmJsb2dzcG90LmNvbQogICAgICogTGljZW5zZWQgdW5kZXIgQlNEIChodHRwOi8vd3d3Lm9wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL2JzZC1saWNlbnNlLnBocCkKICAgICAqIERhdGU6IDUvMTUvMjAwOAogICAgICogQHByb2plY3REZXNjcmlwdGlvbiBBZHZhbmNlZCBhbmQgZXh0ZW5zaWJsZSBkYXRhIGR1bXBpbmcgZm9yIEphdmFzY3JpcHQuCiAgICAgKiBAdmVyc2lvbiAxLjAuMAogICAgICogQGF1dGhvciBBcmllbCBGbGVzbGVyCiAgICAgKiBAbGluayB7aHR0cDovL2ZsZXNsZXIuYmxvZ3Nwb3QuY29tLzIwMDgvMDUvanNkdW1wLXByZXR0eS1kdW1wLW9mLWFueS1qYXZhc2NyaXB0Lmh0bWx9CiAgICAgKi8KICAgIFFVbml0LmpzRHVtcCA9IChmdW5jdGlvbiAoKSB7CiAgICAgICAgZnVuY3Rpb24gcXVvdGUoc3RyKSB7CiAgICAgICAgICAgIHJldHVybiAnIicgKyBzdHIudG9TdHJpbmcoKS5yZXBsYWNlKC8iL2csICdcXCInKSArICciJzsKICAgICAgICB9CgogICAgICAgIDsKICAgICAgICBmdW5jdGlvbiBsaXRlcmFsKG8pIHsKICAgICAgICAgICAgcmV0dXJuIG8gKyAnJzsKICAgICAgICB9CgogICAgICAgIDsKICAgICAgICBmdW5jdGlvbiBqb2luKHByZSwgYXJyLCBwb3N0KSB7CiAgICAgICAgICAgIHZhciBzID0ganNEdW1wLnNlcGFyYXRvcigpLAogICAgICAgICAgICAgICAgYmFzZSA9IGpzRHVtcC5pbmRlbnQoKSwKICAgICAgICAgICAgICAgIGlubmVyID0ganNEdW1wLmluZGVudCgxKTsKICAgICAgICAgICAgaWYgKGFyci5qb2luKQogICAgICAgICAgICAgICAgYXJyID0gYXJyLmpvaW4oJywnICsgcyArIGlubmVyKTsKICAgICAgICAgICAgaWYgKCFhcnIpCiAgICAgICAgICAgICAgICByZXR1cm4gcHJlICsgcG9zdDsKICAgICAgICAgICAgcmV0dXJuIFsgcHJlLCBpbm5lciArIGFyciwgYmFzZSArIHBvc3QgXS5qb2luKHMpOwogICAgICAgIH0KCiAgICAgICAgOwogICAgICAgIGZ1bmN0aW9uIGFycmF5KGFycikgewogICAgICAgICAgICB2YXIgaSA9IGFyci5sZW5ndGgsIHJldCA9IEFycmF5KGkpOwogICAgICAgICAgICB0aGlzLnVwKCk7CiAgICAgICAgICAgIHdoaWxlIChpLS0pCiAgICAgICAgICAgICAgICByZXRbaV0gPSB0aGlzLnBhcnNlKGFycltpXSk7CiAgICAgICAgICAgIHRoaXMuZG93bigpOwogICAgICAgICAgICByZXR1cm4gam9pbignWycsIHJldCwgJ10nKTsKICAgICAgICB9CgogICAgICAgIDsKCiAgICAgICAgdmFyIHJlTmFtZSA9IC9eZnVuY3Rpb24gKFx3KykvOwoKICAgICAgICB2YXIganNEdW1wID0gewogICAgICAgICAgICBwYXJzZTpmdW5jdGlvbiAob2JqLCB0eXBlKSB7IC8vdHlwZSBpcyB1c2VkIG1vc3RseSBpbnRlcm5hbGx5LCB5b3UgY2FuIGZpeCBhIChjdXN0b20pdHlwZSBpbiBhZHZhbmNlCiAgICAgICAgICAgICAgICB2YXIgcGFyc2VyID0gdGhpcy5wYXJzZXJzWyB0eXBlIHx8IHRoaXMudHlwZU9mKG9iaikgXTsKICAgICAgICAgICAgICAgIHR5cGUgPSB0eXBlb2YgcGFyc2VyOwoKICAgICAgICAgICAgICAgIHJldHVybiB0eXBlID09ICdmdW5jdGlvbicgPyBwYXJzZXIuY2FsbCh0aGlzLCBvYmopIDoKICAgICAgICAgICAgICAgICAgICB0eXBlID09ICdzdHJpbmcnID8gcGFyc2VyIDoKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wYXJzZXJzLmVycm9yOwogICAgICAgICAgICB9LAogICAgICAgICAgICB0eXBlT2Y6ZnVuY3Rpb24gKG9iaikgewogICAgICAgICAgICAgICAgdmFyIHR5cGU7CiAgICAgICAgICAgICAgICBpZiAob2JqID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgdHlwZSA9ICJudWxsIjsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIG9iaiA9PT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgICAgICAgICB0eXBlID0gInVuZGVmaW5lZCI7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKFFVbml0LmlzKCJSZWdFeHAiLCBvYmopKSB7CiAgICAgICAgICAgICAgICAgICAgdHlwZSA9ICJyZWdleHAiOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChRVW5pdC5pcygiRGF0ZSIsIG9iaikpIHsKICAgICAgICAgICAgICAgICAgICB0eXBlID0gImRhdGUiOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChRVW5pdC5pcygiRnVuY3Rpb24iLCBvYmopKSB7CiAgICAgICAgICAgICAgICAgICAgdHlwZSA9ICJmdW5jdGlvbiI7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKFFVbml0LmlzKCJBcnJheSIsIG9iaikpIHsKICAgICAgICAgICAgICAgICAgICB0eXBlID0gImFycmF5IjsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoUVVuaXQuaXMoIldpbmRvdyIsIG9iaikgfHwgUVVuaXQuaXMoImdsb2JhbCIsIG9iaikpIHsKICAgICAgICAgICAgICAgICAgICB0eXBlID0gIndpbmRvdyI7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKFFVbml0LmlzKCJIVE1MRG9jdW1lbnQiLCBvYmopKSB7CiAgICAgICAgICAgICAgICAgICAgdHlwZSA9ICJkb2N1bWVudCI7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKFFVbml0LmlzKCJIVE1MQ29sbGVjdGlvbiIsIG9iaikgfHwgUVVuaXQuaXMoIk5vZGVMaXN0Iiwgb2JqKSkgewogICAgICAgICAgICAgICAgICAgIHR5cGUgPSAibm9kZWxpc3QiOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICgvXlxbb2JqZWN0IEhUTUwvLnRlc3QoT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKG9iaikpKSB7CiAgICAgICAgICAgICAgICAgICAgdHlwZSA9ICJub2RlIjsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdHlwZSA9IHR5cGVvZiBvYmo7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gdHlwZTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgc2VwYXJhdG9yOmZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLm11bHRpbGluZSA/IHRoaXMuSFRNTCA/ICc8YnIgLz4nIDogJ1xuJyA6IHRoaXMuSFRNTCA/ICcmbmJzcDsnIDogJyAnOwogICAgICAgICAgICB9LAogICAgICAgICAgICBpbmRlbnQ6ZnVuY3Rpb24gKGV4dHJhKSB7Ly8gZXh0cmEgY2FuIGJlIGEgbnVtYmVyLCBzaG9ydGN1dCBmb3IgaW5jcmVhc2luZy1jYWxsaW5nLWRlY3JlYXNpbmcKICAgICAgICAgICAgICAgIGlmICghdGhpcy5tdWx0aWxpbmUpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICcnOwogICAgICAgICAgICAgICAgdmFyIGNociA9IHRoaXMuaW5kZW50Q2hhcjsKICAgICAgICAgICAgICAgIGlmICh0aGlzLkhUTUwpCiAgICAgICAgICAgICAgICAgICAgY2hyID0gY2hyLnJlcGxhY2UoL1x0L2csICcgICAnKS5yZXBsYWNlKC8gL2csICcmbmJzcDsnKTsKICAgICAgICAgICAgICAgIHJldHVybiBBcnJheSh0aGlzLl9kZXB0aF8gKyAoZXh0cmEgfHwgMCkpLmpvaW4oY2hyKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXA6ZnVuY3Rpb24gKGEpIHsKICAgICAgICAgICAgICAgIHRoaXMuX2RlcHRoXyArPSBhIHx8IDE7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGRvd246ZnVuY3Rpb24gKGEpIHsKICAgICAgICAgICAgICAgIHRoaXMuX2RlcHRoXyAtPSBhIHx8IDE7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHNldFBhcnNlcjpmdW5jdGlvbiAobmFtZSwgcGFyc2VyKSB7CiAgICAgICAgICAgICAgICB0aGlzLnBhcnNlcnNbbmFtZV0gPSBwYXJzZXI7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIC8vIFRoZSBuZXh0IDMgYXJlIGV4cG9zZWQgc28geW91IGNhbiB1c2UgdGhlbQogICAgICAgICAgICBxdW90ZTpxdW90ZSwKICAgICAgICAgICAgbGl0ZXJhbDpsaXRlcmFsLAogICAgICAgICAgICBqb2luOmpvaW4sCiAgICAgICAgICAgIC8vCiAgICAgICAgICAgIF9kZXB0aF86MSwKICAgICAgICAgICAgLy8gVGhpcyBpcyB0aGUgbGlzdCBvZiBwYXJzZXJzLCB0byBtb2RpZnkgdGhlbSwgdXNlIGpzRHVtcC5zZXRQYXJzZXIKICAgICAgICAgICAgcGFyc2Vyczp7CiAgICAgICAgICAgICAgICB3aW5kb3c6J1tXaW5kb3ddJywKICAgICAgICAgICAgICAgIGRvY3VtZW50OidbRG9jdW1lbnRdJywKICAgICAgICAgICAgICAgIGVycm9yOidbRVJST1JdJywgLy93aGVuIG5vIHBhcnNlciBpcyBmb3VuZCwgc2hvdWxkbid0IGhhcHBlbgogICAgICAgICAgICAgICAgdW5rbm93bjonW1Vua25vd25dJywKICAgICAgICAgICAgICAgICdudWxsJzonbnVsbCcsCiAgICAgICAgICAgICAgICB1bmRlZmluZWQ6J3VuZGVmaW5lZCcsCiAgICAgICAgICAgICAgICAnZnVuY3Rpb24nOmZ1bmN0aW9uIChmbikgewogICAgICAgICAgICAgICAgICAgIHZhciByZXQgPSAnZnVuY3Rpb24nLAogICAgICAgICAgICAgICAgICAgICAgICBuYW1lID0gJ25hbWUnIGluIGZuID8gZm4ubmFtZSA6IChyZU5hbWUuZXhlYyhmbikgfHwgW10pWzFdOy8vZnVuY3Rpb25zIG5ldmVyIGhhdmUgbmFtZSBpbiBJRQogICAgICAgICAgICAgICAgICAgIGlmIChuYW1lKQogICAgICAgICAgICAgICAgICAgICAgICByZXQgKz0gJyAnICsgbmFtZTsKICAgICAgICAgICAgICAgICAgICByZXQgKz0gJygnOwoKICAgICAgICAgICAgICAgICAgICByZXQgPSBbIHJldCwgdGhpcy5wYXJzZShmbiwgJ2Z1bmN0aW9uQXJncycpLCAnKXsnXS5qb2luKCcnKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gam9pbihyZXQsIHRoaXMucGFyc2UoZm4sICdmdW5jdGlvbkNvZGUnKSwgJ30nKTsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBhcnJheTphcnJheSwKICAgICAgICAgICAgICAgIG5vZGVsaXN0OmFycmF5LAogICAgICAgICAgICAgICAgYXJndW1lbnRzOmFycmF5LAogICAgICAgICAgICAgICAgb2JqZWN0OmZ1bmN0aW9uIChtYXApIHsKICAgICAgICAgICAgICAgICAgICB2YXIgcmV0ID0gWyBdOwogICAgICAgICAgICAgICAgICAgIHRoaXMudXAoKTsKICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gbWFwKQogICAgICAgICAgICAgICAgICAgICAgICByZXQucHVzaCh0aGlzLnBhcnNlKGtleSwgJ2tleScpICsgJzogJyArIHRoaXMucGFyc2UobWFwW2tleV0pKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmRvd24oKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gam9pbigneycsIHJldCwgJ30nKTsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBub2RlOmZ1bmN0aW9uIChub2RlKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIG9wZW4gPSB0aGlzLkhUTUwgPyAnJmx0OycgOiAnPCcsCiAgICAgICAgICAgICAgICAgICAgICAgIGNsb3NlID0gdGhpcy5IVE1MID8gJyZndDsnIDogJz4nOwoKICAgICAgICAgICAgICAgICAgICB2YXIgdGFnID0gbm9kZS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpLAogICAgICAgICAgICAgICAgICAgICAgICByZXQgPSBvcGVuICsgdGFnOwoKICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBhIGluIHRoaXMuRE9NQXR0cnMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHZhbCA9IG5vZGVbdGhpcy5ET01BdHRyc1thXV07CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh2YWwpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXQgKz0gJyAnICsgYSArICc9JyArIHRoaXMucGFyc2UodmFsLCAnYXR0cmlidXRlJyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHJldHVybiByZXQgKyBjbG9zZSArIG9wZW4gKyAnLycgKyB0YWcgKyBjbG9zZTsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBmdW5jdGlvbkFyZ3M6ZnVuY3Rpb24gKGZuKSB7Ly9mdW5jdGlvbiBjYWxscyBpdCBpbnRlcm5hbGx5LCBpdCdzIHRoZSBhcmd1bWVudHMgcGFydCBvZiB0aGUgZnVuY3Rpb24KICAgICAgICAgICAgICAgICAgICB2YXIgbCA9IGZuLmxlbmd0aDsKICAgICAgICAgICAgICAgICAgICBpZiAoIWwpIHJldHVybiAnJzsKCiAgICAgICAgICAgICAgICAgICAgdmFyIGFyZ3MgPSBBcnJheShsKTsKICAgICAgICAgICAgICAgICAgICB3aGlsZSAobC0tKQogICAgICAgICAgICAgICAgICAgICAgICBhcmdzW2xdID0gU3RyaW5nLmZyb21DaGFyQ29kZSg5NyArIGwpOy8vOTcgaXMgJ2EnCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICcgJyArIGFyZ3Muam9pbignLCAnKSArICcgJzsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBrZXk6cXVvdGUsIC8vb2JqZWN0IGNhbGxzIGl0IGludGVybmFsbHksIHRoZSBrZXkgcGFydCBvZiBhbiBpdGVtIGluIGEgbWFwCiAgICAgICAgICAgICAgICBmdW5jdGlvbkNvZGU6J1tjb2RlXScsIC8vZnVuY3Rpb24gY2FsbHMgaXQgaW50ZXJuYWxseSwgaXQncyB0aGUgY29udGVudCBvZiB0aGUgZnVuY3Rpb24KICAgICAgICAgICAgICAgIGF0dHJpYnV0ZTpxdW90ZSwgLy9ub2RlIGNhbGxzIGl0IGludGVybmFsbHksIGl0J3MgYW4gaHRtbCBhdHRyaWJ1dGUgdmFsdWUKICAgICAgICAgICAgICAgIHN0cmluZzpxdW90ZSwKICAgICAgICAgICAgICAgIGRhdGU6cXVvdGUsCiAgICAgICAgICAgICAgICByZWdleHA6bGl0ZXJhbCwgLy9yZWdleAogICAgICAgICAgICAgICAgbnVtYmVyOmxpdGVyYWwsCiAgICAgICAgICAgICAgICAnYm9vbGVhbic6bGl0ZXJhbAogICAgICAgICAgICB9LAogICAgICAgICAgICBET01BdHRyczp7Ly9hdHRyaWJ1dGVzIHRvIGR1bXAgZnJvbSBub2RlcywgbmFtZT0+cmVhbE5hbWUKICAgICAgICAgICAgICAgIGlkOidpZCcsCiAgICAgICAgICAgICAgICBuYW1lOiduYW1lJywKICAgICAgICAgICAgICAgICdjbGFzcyc6J2NsYXNzTmFtZScKICAgICAgICAgICAgfSwKICAgICAgICAgICAgSFRNTDp0cnVlLCAvL2lmIHRydWUsIGVudGl0aWVzIGFyZSBlc2NhcGVkICggPCwgPiwgXHQsIHNwYWNlIGFuZCBcbiApCiAgICAgICAgICAgIGluZGVudENoYXI6JyAgICcsIC8vaW5kZW50YXRpb24gdW5pdAogICAgICAgICAgICBtdWx0aWxpbmU6dHJ1ZSAvL2lmIHRydWUsIGl0ZW1zIGluIGEgY29sbGVjdGlvbiwgYXJlIHNlcGFyYXRlZCBieSBhIFxuLCBlbHNlIGp1c3QgYSBzcGFjZS4KICAgICAgICB9OwoKICAgICAgICByZXR1cm4ganNEdW1wOwogICAgfSkoKTsKCn0pKHRoaXMpOwo=",
                "body": "LyoKICogUVVuaXQgLSBBIEphdmFTY3JpcHQgVW5pdCBUZXN0aW5nIEZyYW1ld29yawogKiAKICogaHR0cDovL2RvY3MuanF1ZXJ5LmNvbS9RVW5pdAogKgogKiBDb3B5cmlnaHQgKGMpIDIwMDkgSm9obiBSZXNpZywgSsO2cm4gWmFlZmZlcmVyCiAqIER1YWwgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCAoTUlULUxJQ0VOU0UudHh0KQogKiBhbmQgR1BMIChHUEwtTElDRU5TRS50eHQpIGxpY2Vuc2VzLgogKi8KCihmdW5jdGlvbiAod2luZG93KSB7CgogICAgdmFyIFFVbml0ID0gewoKICAgICAgICAvLyBJbml0aWFsaXplIHRoZSBjb25maWd1cmF0aW9uIG9wdGlvbnMKICAgICAgICBpbml0OmZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgY29uZmlnID0gewogICAgICAgICAgICAgICAgc3RhdHM6eyBhbGw6MCwgYmFkOjAgfSwKICAgICAgICAgICAgICAgIG1vZHVsZVN0YXRzOnsgYWxsOjAsIGJhZDowIH0sCiAgICAgICAgICAgICAgICBzdGFydGVkOituZXcgRGF0ZSwKICAgICAgICAgICAgICAgIGJsb2NraW5nOmZhbHNlLAogICAgICAgICAgICAgICAgYXV0b3J1bjpmYWxzZSwKICAgICAgICAgICAgICAgIGFzc2VydGlvbnM6W10sCiAgICAgICAgICAgICAgICBmaWx0ZXJzOltdLAogICAgICAgICAgICAgICAgcXVldWU6W10KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIHZhciB0ZXN0cyA9IGlkKCJxdW5pdC10ZXN0cyIpLAogICAgICAgICAgICAgICAgYmFubmVyID0gaWQoInF1bml0LWJhbm5lciIpLAogICAgICAgICAgICAgICAgcmVzdWx0ID0gaWQoInF1bml0LXRlc3RyZXN1bHQiKTsKCiAgICAgICAgICAgIGlmICh0ZXN0cykgewogICAgICAgICAgICAgICAgdGVzdHMuaW5uZXJIVE1MID0gIiI7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChiYW5uZXIpIHsKICAgICAgICAgICAgICAgIGJhbm5lci5jbGFzc05hbWUgPSAiIjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHJlc3VsdCkgewogICAgICAgICAgICAgICAgcmVzdWx0LnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQocmVzdWx0KTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8vIGNhbGwgb24gc3RhcnQgb2YgbW9kdWxlIHRlc3QgdG8gcHJlcGVuZCBuYW1lIHRvIGFsbCB0ZXN0cwogICAgICAgIG1vZHVsZTpmdW5jdGlvbiAobmFtZSwgdGVzdEVudmlyb25tZW50KSB7CiAgICAgICAgICAgIGNvbmZpZy5jdXJyZW50TW9kdWxlID0gbmFtZTsKCiAgICAgICAgICAgIHN5bmNocm9uaXplKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIGlmIChjb25maWcuY3VycmVudE1vZHVsZSkgewogICAgICAgICAgICAgICAgICAgIFFVbml0Lm1vZHVsZURvbmUoY29uZmlnLmN1cnJlbnRNb2R1bGUsIGNvbmZpZy5tb2R1bGVTdGF0cy5iYWQsIGNvbmZpZy5tb2R1bGVTdGF0cy5hbGwpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGNvbmZpZy5jdXJyZW50TW9kdWxlID0gbmFtZTsKICAgICAgICAgICAgICAgIGNvbmZpZy5tb2R1bGVUZXN0RW52aXJvbm1lbnQgPSB0ZXN0RW52aXJvbm1lbnQ7CiAgICAgICAgICAgICAgICBjb25maWcubW9kdWxlU3RhdHMgPSB7IGFsbDowLCBiYWQ6MCB9OwoKICAgICAgICAgICAgICAgIFFVbml0Lm1vZHVsZVN0YXJ0KG5hbWUsIHRlc3RFbnZpcm9ubWVudCk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIGFzeW5jVGVzdDpmdW5jdGlvbiAodGVzdE5hbWUsIGV4cGVjdGVkLCBjYWxsYmFjaykgewogICAgICAgICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMikgewogICAgICAgICAgICAgICAgY2FsbGJhY2sgPSBleHBlY3RlZDsKICAgICAgICAgICAgICAgIGV4cGVjdGVkID0gMDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgUVVuaXQudGVzdCh0ZXN0TmFtZSwgZXhwZWN0ZWQsIGNhbGxiYWNrLCB0cnVlKTsKICAgICAgICB9LAovLyAgICAgICAgY2FsbHRlc3Q6ZnVuY3Rpb24odGVzdEVudmlyb25tZW50LGNhbGxiYWNrKXsKLy8gICAgICAgICAgICBjbGVhckludGVydmFsKGNvbmZpZy50aW1lcik7Ci8vICAgICAgICAgICAgY2FsbGJhY2suY2FsbCh0ZXN0RW52aXJvbm1lbnQpOwovLwovLyAgICAgICAgfSwKCiAgICAgICAgdGVzdDpmdW5jdGlvbiAodGVzdE5hbWUsIGV4cGVjdGVkLCBjYWxsYmFjaywgYXN5bmMpIHsKICAgICAgICAgICAgdmFyIG5hbWUgPSB0ZXN0TmFtZSwgdGVzdEVudmlyb25tZW50LCB0ZXN0RW52aXJvbm1lbnRBcmc7CgogICAgICAgICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMikgewogICAgICAgICAgICAgICAgY2FsbGJhY2sgPSBleHBlY3RlZDsKICAgICAgICAgICAgICAgIGV4cGVjdGVkID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBpcyAybmQgYXJndW1lbnQgYSB0ZXN0RW52aXJvbm1lbnQ/CiAgICAgICAgICAgIGlmIChleHBlY3RlZCAmJiB0eXBlb2YgZXhwZWN0ZWQgPT09ICdvYmplY3QnKSB7CiAgICAgICAgICAgICAgICB0ZXN0RW52aXJvbm1lbnRBcmcgPSBleHBlY3RlZDsKICAgICAgICAgICAgICAgIGV4cGVjdGVkID0gbnVsbDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGNvbmZpZy5jdXJyZW50TW9kdWxlKSB7CiAgICAgICAgICAgICAgICBuYW1lID0gY29uZmlnLmN1cnJlbnRNb2R1bGUgKyAiIG1vZHVsZTogIiArIG5hbWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICghdmFsaWRUZXN0KG5hbWUpKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHN5bmNocm9uaXplKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICBRVW5pdC5zdG9wQ291bnQgPSAwOwogICAgICAgICAgICAgICAgICAgIFFVbml0LnN0YXJ0Q291bnQgPSAwOwogICAgICAgICAgICAgICAgICAgIFFVbml0LnRlc3RTdGFydCh0ZXN0TmFtZSk7CgogICAgICAgICAgICAgICAgICAgIHRlc3RFbnZpcm9ubWVudCA9IGV4dGVuZCh7CiAgICAgICAgICAgICAgICAgICAgICAgIHNldHVwOmZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgdGVhcmRvd246ZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSwgY29uZmlnLm1vZHVsZVRlc3RFbnZpcm9ubWVudCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRlc3RFbnZpcm9ubWVudEFyZykgewogICAgICAgICAgICAgICAgICAgICAgICBleHRlbmQodGVzdEVudmlyb25tZW50LCB0ZXN0RW52aXJvbm1lbnRBcmcpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLy8gYWxsb3cgdXRpbGl0eSBmdW5jdGlvbnMgdG8gYWNjZXNzIHRoZSBjdXJyZW50IHRlc3QgZW52aXJvbm1lbnQKICAgICAgICAgICAgICAgICAgICBRVW5pdC5jdXJyZW50X3Rlc3RFbnZpcm9ubWVudCA9IHRlc3RFbnZpcm9ubWVudDsKCiAgICAgICAgICAgICAgICAgICAgY29uZmlnLmFzc2VydGlvbnMgPSBbXTsKICAgICAgICAgICAgICAgICAgICBjb25maWcuZXhwZWN0ZWQgPSBleHBlY3RlZDsKCiAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFjb25maWcucG9sbHV0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzYXZlR2xvYmFsKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIHRlc3RFbnZpcm9ubWVudC5zZXR1cC5jYWxsKHRlc3RFbnZpcm9ubWVudCk7CgogICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgUVVuaXQub2soZmFsc2UsICJTZXR1cCBmYWlsZWQgb24gIiArIG5hbWUgKyAiOiAiICsgZS5tZXNzYWdlKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmIChhc3luYykgewogICAgICAgICAgICAgICAgICAgICAgICBRVW5pdC5zdG9wKCk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoUVVuaXQucmVhZHlGbGFnID09IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbmZpZy50aW1lciA9IHNldEludGVydmFsKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoUVVuaXQucmVhZHlGbGFnID09IDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2suY2FsbCh0ZXN0RW52aXJvbm1lbnQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoUVVuaXQuc3RvcENvdW50ID09IDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXJ0KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2xlYXJJbnRlcnZhbChjb25maWcudGltZXIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sIDEwMCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjay5jYWxsKHRlc3RFbnZpcm9ubWVudCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgY2F0Y2gKICAgICAgICAgICAgICAgICAgICAgICAgKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZmFpbCgiVGVzdCAiICsgbmFtZSArICIgZGllZCwgZXhjZXB0aW9uIGFuZCB0ZXN0IGZvbGxvd3MiLCBlLCBjYWxsYmFjayk7CiAgICAgICAgICAgICAgICAgICAgICAgIFFVbml0Lm9rKGZhbHNlLCAiRGllZCBvbiB0ZXN0ICMiICsgKGNvbmZpZy5hc3NlcnRpb25zLmxlbmd0aCArIDEpICsgIjogIiArIGUubWVzc2FnZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGVsc2UgbmV4dCB0ZXN0IHdpbGwgY2FycnkgdGhlIHJlc3BvbnNpYmlsaXR5CiAgICAgICAgICAgICAgICAgICAgICAgIHNhdmVHbG9iYWwoKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFJlc3RhcnQgdGhlIHRlc3RzIGlmIHRoZXkncmUgYmxvY2tpbmcKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNvbmZpZy5ibG9ja2luZykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgKQogICAgICAgICAgICA7CgogICAgICAgICAgICBzeW5jaHJvbml6ZShmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIGNoZWNrUG9sbHV0aW9uKCk7CiAgICAgICAgICAgICAgICAgICAgdGVzdEVudmlyb25tZW50LnRlYXJkb3duLmNhbGwodGVzdEVudmlyb25tZW50KTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICBRVW5pdC5vayhmYWxzZSwgIlRlYXJkb3duIGZhaWxlZCBvbiAiICsgbmFtZSArICI6ICIgKyBlLm1lc3NhZ2UpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgUVVuaXQucmVzZXQoKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICBmYWlsKCJyZXNldCgpIGZhaWxlZCwgZm9sbG93aW5nIFRlc3QgIiArIG5hbWUgKyAiLCBleGNlcHRpb24gYW5kIHJlc2V0IGZuIGZvbGxvd3MiLCBlLCByZXNldCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKGNvbmZpZy5leHBlY3RlZCAmJiBjb25maWcuZXhwZWN0ZWQgIT0gY29uZmlnLmFzc2VydGlvbnMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgUVVuaXQub2soZmFsc2UsICJFeHBlY3RlZCAiICsgY29uZmlnLmV4cGVjdGVkICsgIiBhc3NlcnRpb25zLCBidXQgIiArIGNvbmZpZy5hc3NlcnRpb25zLmxlbmd0aCArICIgd2VyZSBydW4iKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB2YXIgZ29vZCA9IDAsIGJhZCA9IDAsCiAgICAgICAgICAgICAgICAgICAgdGVzdHMgPSBpZCgicXVuaXQtdGVzdHMiKTsKCiAgICAgICAgICAgICAgICBjb25maWcuc3RhdHMuYWxsICs9IGNvbmZpZy5hc3NlcnRpb25zLmxlbmd0aDsKICAgICAgICAgICAgICAgIGNvbmZpZy5tb2R1bGVTdGF0cy5hbGwgKz0gY29uZmlnLmFzc2VydGlvbnMubGVuZ3RoOwoKICAgICAgICAgICAgICAgIGlmICh0ZXN0cykgewogICAgICAgICAgICAgICAgICAgIHZhciBvbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoIm9sIik7CiAgICAgICAgICAgICAgICAgICAgb2wuc3R5bGUuZGlzcGxheSA9ICJub25lIjsKCiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjb25maWcuYXNzZXJ0aW9ucy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgYXNzZXJ0aW9uID0gY29uZmlnLmFzc2VydGlvbnNbaV07CgogICAgICAgICAgICAgICAgICAgICAgICB2YXIgbGkgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJsaSIpOwogICAgICAgICAgICAgICAgICAgICAgICBsaS5jbGFzc05hbWUgPSBhc3NlcnRpb24ucmVzdWx0ID8gInBhc3MiIDogImZhaWwiOwogICAgICAgICAgICAgICAgICAgICAgICBsaS5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZShhc3NlcnRpb24ubWVzc2FnZSB8fCAiKG5vIG1lc3NhZ2UpIikpOwogICAgICAgICAgICAgICAgICAgICAgICBvbC5hcHBlbmRDaGlsZChsaSk7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoYXNzZXJ0aW9uLnJlc3VsdCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZ29vZCsrOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYmFkKys7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25maWcuc3RhdHMuYmFkKys7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25maWcubW9kdWxlU3RhdHMuYmFkKys7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHZhciBiID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgic3Ryb25nIik7CiAgICAgICAgICAgICAgICAgICAgYi5pbm5lckhUTUwgPSBuYW1lICsgIiA8YiBzdHlsZT0nY29sb3I6YmxhY2s7Jz4oPGIgY2xhc3M9J2ZhaWwnPiIgKyBiYWQgKyAiPC9iPiwgPGIgY2xhc3M9J3Bhc3MnPiIgKyBnb29kICsgIjwvYj4sICIgKyBjb25maWcuYXNzZXJ0aW9ucy5sZW5ndGggKyAiKTwvYj4iOwoKICAgICAgICAgICAgICAgICAgICBhZGRFdmVudChiLCAiY2xpY2siLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBuZXh0ID0gYi5uZXh0U2libGluZywgZGlzcGxheSA9IG5leHQuc3R5bGUuZGlzcGxheTsKICAgICAgICAgICAgICAgICAgICAgICAgbmV4dC5zdHlsZS5kaXNwbGF5ID0gZGlzcGxheSA9PT0gIm5vbmUiID8gImJsb2NrIiA6ICJub25lIjsKICAgICAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAgICAgYWRkRXZlbnQoYiwgImRibGNsaWNrIiwgZnVuY3Rpb24gKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRhcmdldCA9IGUgJiYgZS50YXJnZXQgPyBlLnRhcmdldCA6IHdpbmRvdy5ldmVudC5zcmNFbGVtZW50OwogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGFyZ2V0Lm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09ICJzdHJvbmciKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdGV4dCA9ICIiLCBub2RlID0gdGFyZ2V0LmZpcnN0Q2hpbGQ7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUgKG5vZGUubm9kZVR5cGUgPT09IDMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZXh0ICs9IG5vZGUubm9kZVZhbHVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUgPSBub2RlLm5leHRTaWJsaW5nOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRleHQgPSB0ZXh0LnJlcGxhY2UoLyheXHMqfFxzKiQpL2csICIiKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmxvY2F0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmxvY2F0aW9uLmhyZWYgPSB3aW5kb3cubG9jYXRpb24uaHJlZi5tYXRjaCgvXiguKz8pKFw/LiopPyQvKVsxXSArICI/IiArIGVuY29kZVVSSUNvbXBvbmVudCh0ZXh0KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgICAgICB2YXIgbGkgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJsaSIpOwogICAgICAgICAgICAgICAgICAgIGxpLmNsYXNzTmFtZSA9IGJhZCA/ICJmYWlsIiA6ICJwYXNzIjsKICAgICAgICAgICAgICAgICAgICBsaS5hcHBlbmRDaGlsZChiKTsKICAgICAgICAgICAgICAgICAgICBsaS5hcHBlbmRDaGlsZChvbCk7CiAgICAgICAgICAgICAgICAgICAgdGVzdHMuYXBwZW5kQ2hpbGQobGkpOwoKICAgICAgICAgICAgICAgICAgICBpZiAoYmFkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0b29sYmFyID0gaWQoInF1bml0LXRlc3RydW5uZXItdG9vbGJhciIpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAodG9vbGJhcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9vbGJhci5zdHlsZS5kaXNwbGF5ID0gImJsb2NrIjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlkKCJxdW5pdC1maWx0ZXItcGFzcyIpLmRpc2FibGVkID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlkKCJxdW5pdC1maWx0ZXItbWlzc2luZyIpLmRpc2FibGVkID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgY29uZmlnLmFzc2VydGlvbnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFjb25maWcuYXNzZXJ0aW9uc1tpXS5yZXN1bHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJhZCsrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uZmlnLnN0YXRzLmJhZCsrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uZmlnLm1vZHVsZVN0YXRzLmJhZCsrOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIFFVbml0LnRlc3REb25lKHRlc3ROYW1lLCBiYWQsIGNvbmZpZy5hc3NlcnRpb25zKTsKCiAgICAgICAgICAgICAgICBpZiAoIXdpbmRvdy5zZXRUaW1lb3V0ICYmICFjb25maWcucXVldWUubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgZG9uZSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGlmICh3aW5kb3cuc2V0VGltZW91dCAmJiAhY29uZmlnLmRvbmVUaW1lcikgewogICAgICAgICAgICAgICAgY29uZmlnLmRvbmVUaW1lciA9IHdpbmRvdy5zZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoIWNvbmZpZy5xdWV1ZS5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZG9uZSgpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHN5bmNocm9uaXplKGRvbmUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sIDEzKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIFNwZWNpZnkgdGhlIG51bWJlciBvZiBleHBlY3RlZCBhc3NlcnRpb25zIHRvIGd1cmFudGVlIHRoYXQgZmFpbGVkIHRlc3QgKG5vIGFzc2VydGlvbnMgYXJlIHJ1biBhdCBhbGwpIGRvbid0IHNsaXAgdGhyb3VnaC4KICAgICAgICAgKi8KICAgICAgICBleHBlY3Q6ZnVuY3Rpb24gKGFzc2VydHMpIHsKICAgICAgICAgICAgY29uZmlnLmV4cGVjdGVkID0gYXNzZXJ0czsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBBc3NlcnRzIHRydWUuCiAgICAgICAgICogQGV4YW1wbGUgb2soICJhc2RmYXNkZiIubGVuZ3RoID4gNSwgIlRoZXJlIG11c3QgYmUgYXQgbGVhc3QgNSBjaGFycyIgKTsKICAgICAgICAgKi8KICAgICAgICBvazpmdW5jdGlvbiAoYSwgbXNnKSB7CiAgICAgICAgICAgIGRldGFpbEZvckFycmVydCArPSBhID8gJycgOiAnbWFzc2FnZTonICsgbXNnICsgJ1xcbic7CiAgICAgICAgICAgIFFVbml0LmxvZyhhLCBtc2cpOwogICAgICAgICAgICBjb25maWcuYXNzZXJ0aW9ucy5wdXNoKHsKICAgICAgICAgICAgICAgIHJlc3VsdDohIWEsCiAgICAgICAgICAgICAgICBtZXNzYWdlOm1zZwogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBDaGVja3MgdGhhdCB0aGUgZmlyc3QgdHdvIGFyZ3VtZW50cyBhcmUgZXF1YWwsIHdpdGggYW4gb3B0aW9uYWwgbWVzc2FnZS4KICAgICAgICAgKiBQcmludHMgb3V0IGJvdGggYWN0dWFsIGFuZCBleHBlY3RlZCB2YWx1ZXMuCiAgICAgICAgICoKICAgICAgICAgKiBQcmVmZXJlZCB0byBvayggYWN0dWFsID09IGV4cGVjdGVkLCBtZXNzYWdlICkKICAgICAgICAgKgogICAgICAgICAqIEBleGFtcGxlIGVxdWFsKCBmb3JtYXQoIlJlY2VpdmVkIHswfSBieXRlcy4iLCAyKSwgIlJlY2VpdmVkIDIgYnl0ZXMuIiApOwogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIE9iamVjdCBhY3R1YWwKICAgICAgICAgKiBAcGFyYW0gT2JqZWN0IGV4cGVjdGVkCiAgICAgICAgICogQHBhcmFtIFN0cmluZyBtZXNzYWdlIChvcHRpb25hbCkKICAgICAgICAgKi8KICAgICAgICBlcXVhbDpmdW5jdGlvbiAoYWN0dWFsLCBleHBlY3RlZCwgbWVzc2FnZSkgewogICAgICAgICAgICBwdXNoKGV4cGVjdGVkID09IGFjdHVhbCwgYWN0dWFsLCBleHBlY3RlZCwgbWVzc2FnZSk7CiAgICAgICAgfSwKCiAgICAgICAgbm90RXF1YWw6ZnVuY3Rpb24gKGFjdHVhbCwgZXhwZWN0ZWQsIG1lc3NhZ2UpIHsKICAgICAgICAgICAgcHVzaChleHBlY3RlZCAhPSBhY3R1YWwsIGFjdHVhbCwgZXhwZWN0ZWQsIG1lc3NhZ2UpOwogICAgICAgIH0sCgogICAgICAgIGRlZXBFcXVhbDpmdW5jdGlvbiAoYSwgYiwgbWVzc2FnZSkgewogICAgICAgICAgICBwdXNoKFFVbml0LmVxdWl2KGEsIGIpLCBhLCBiLCBtZXNzYWdlKTsKICAgICAgICB9LAoKICAgICAgICBub3REZWVwRXF1YWw6ZnVuY3Rpb24gKGEsIGIsIG1lc3NhZ2UpIHsKICAgICAgICAgICAgcHVzaCghUVVuaXQuZXF1aXYoYSwgYiksIGEsIGIsIG1lc3NhZ2UpOwogICAgICAgIH0sCgogICAgICAgIHN0cmljdEVxdWFsOmZ1bmN0aW9uIChhY3R1YWwsIGV4cGVjdGVkLCBtZXNzYWdlKSB7CiAgICAgICAgICAgIHB1c2goZXhwZWN0ZWQgPT09IGFjdHVhbCwgYWN0dWFsLCBleHBlY3RlZCwgbWVzc2FnZSk7CiAgICAgICAgfSwKCiAgICAgICAgbm90U3RyaWN0RXF1YWw6ZnVuY3Rpb24gKGFjdHVhbCwgZXhwZWN0ZWQsIG1lc3NhZ2UpIHsKICAgICAgICAgICAgcHVzaChleHBlY3RlZCAhPT0gYWN0dWFsLCBhY3R1YWwsIGV4cGVjdGVkLCBtZXNzYWdlKTsKICAgICAgICB9LAoKICAgICAgICBzdGFydDpmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIFFVbml0LnN0YXJ0Q291bnQrKzsKICAgICAgICAgICAgUVVuaXQuc3RvcENvdW50LS07CiAgICAgICAgICAgIC8vIEEgc2xpZ2h0IGRlbGF5LCB0byBhdm9pZCBhbnkgY3VycmVudCBjYWxsYmFja3MKICAgICAgICAgICAgaWYgKHdpbmRvdy5zZXRUaW1lb3V0KSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGNvbmZpZy50aW1lb3V0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dChjb25maWcudGltZW91dCk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBjb25maWcuYmxvY2tpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICBwcm9jZXNzKCk7CiAgICAgICAgICAgICAgICB9LCAxMyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjb25maWcuYmxvY2tpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHByb2Nlc3MoKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIHN0b3A6ZnVuY3Rpb24gKHRpbWVvdXQpIHsKICAgICAgICAgICAgY29uZmlnLmJsb2NraW5nID0gdHJ1ZTsKICAgICAgICAgICAgUVVuaXQuc3RvcENvdW50Kys7CiAgICAgICAgICAgIGlmICh0aW1lb3V0ICYmIHdpbmRvdy5zZXRUaW1lb3V0KSB7CiAgICAgICAgICAgICAgICBjb25maWcudGltZW91dCA9IHdpbmRvdy5zZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICBRVW5pdC5vayhmYWxzZSwgIlRlc3QgdGltZWQgb3V0Iik7CiAgICAgICAgICAgICAgICAgICAgUVVuaXQuc3RhcnQoKTsKICAgICAgICAgICAgICAgIH0sIHRpbWVvdXQpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogUmVzZXRzIHRoZSB0ZXN0IHNldHVwLiBVc2VmdWwgZm9yIHRlc3RzIHRoYXQgbW9kaWZ5IHRoZSBET00uCiAgICAgICAgICovCiAgICAgICAgcmVzZXQ6ZnVuY3Rpb24gKCkgewogICAgICAgICAgICBpZiAod2luZG93LmpRdWVyeSkgewogICAgICAgICAgICAgICAgalF1ZXJ5KCIjbWFpbiIpLmh0bWwoY29uZmlnLmZpeHR1cmUpOwogICAgICAgICAgICAgICAgalF1ZXJ5LmV2ZW50Lmdsb2JhbCA9IHt9OwogICAgICAgICAgICAgICAgalF1ZXJ5LmFqYXhTZXR0aW5ncyA9IGV4dGVuZCh7fSwgY29uZmlnLmFqYXhTZXR0aW5ncyk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBUcmlnZ2VyIGFuIGV2ZW50IG9uIGFuIGVsZW1lbnQuCiAgICAgICAgICoKICAgICAgICAgKiBAZXhhbXBsZSB0cmlnZ2VyRXZlbnQoIGRvY3VtZW50LmJvZHksICJjbGljayIgKTsKICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSBET01FbGVtZW50IGVsZW0KICAgICAgICAgKiBAcGFyYW0gU3RyaW5nIHR5cGUKICAgICAgICAgKi8KICAgICAgICB0cmlnZ2VyRXZlbnQ6ZnVuY3Rpb24gKGVsZW0sIHR5cGUsIGV2ZW50KSB7CiAgICAgICAgICAgIGlmIChkb2N1bWVudC5jcmVhdGVFdmVudCkgewogICAgICAgICAgICAgICAgZXZlbnQgPSBkb2N1bWVudC5jcmVhdGVFdmVudCgiTW91c2VFdmVudHMiKTsKICAgICAgICAgICAgICAgIGV2ZW50LmluaXRNb3VzZUV2ZW50KHR5cGUsIHRydWUsIHRydWUsIGVsZW0ub3duZXJEb2N1bWVudC5kZWZhdWx0VmlldywKICAgICAgICAgICAgICAgICAgICAwLCAwLCAwLCAwLCAwLCBmYWxzZSwgZmFsc2UsIGZhbHNlLCBmYWxzZSwgMCwgbnVsbCk7CiAgICAgICAgICAgICAgICBlbGVtLmRpc3BhdGNoRXZlbnQoZXZlbnQpOwoKICAgICAgICAgICAgfSBlbHNlIGlmIChlbGVtLmZpcmVFdmVudCkgewogICAgICAgICAgICAgICAgZWxlbS5maXJlRXZlbnQoIm9uIiArIHR5cGUpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLy8gU2FmZSBvYmplY3QgdHlwZSBjaGVja2luZwogICAgICAgIGlzOmZ1bmN0aW9uICh0eXBlLCBvYmopIHsKICAgICAgICAgICAgcmV0dXJuIE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChvYmopID09PSAiW29iamVjdCAiICsgdHlwZSArICJdIjsKICAgICAgICB9LAoKICAgICAgICAvLyBMb2dnaW5nIGNhbGxiYWNrcwogICAgICAgIGRvbmU6ZnVuY3Rpb24gKGZhaWx1cmVzLCB0b3RhbCwgZGV0YWlsKSB7CiAgICAgICAgfSwKICAgICAgICBsb2c6ZnVuY3Rpb24gKHJlc3VsdCwgbWVzc2FnZSkgewogICAgICAgIH0sCiAgICAgICAgdGVzdFN0YXJ0OmZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgfSwKICAgICAgICB0ZXN0RG9uZTpmdW5jdGlvbiAobmFtZSwgZmFpbHVyZXMsIHRvdGFsRGV0YWlsKSB7CiAgICAgICAgfSwKICAgICAgICBtb2R1bGVTdGFydDpmdW5jdGlvbiAobmFtZSwgdGVzdEVudmlyb25tZW50KSB7CiAgICAgICAgfSwKICAgICAgICBtb2R1bGVEb25lOmZ1bmN0aW9uIChuYW1lLCBmYWlsdXJlcywgdG90YWwpIHsKICAgICAgICB9CiAgICB9OwovL3JlY29yZCBkZXRhaWwgdGVzdE5hbWUsIGJhZCwgY29uZmlnLmFzc2VydGlvbnMKICAgIFFVbml0LnRlc3REb25lID0gZnVuY3Rpb24gKCkgewogICAgICAgIGlmIChhcmd1bWVudHNbMF1bMV0pIHsKICAgICAgICAgICAgZmFpbGVkRGV0YWlsICs9ICd0ZXN0TmFtZTonICsgYXJndW1lbnRzWzBdWzBdICsgJyBmYWlsTnVtOicgKyBhcmd1bWVudHNbMF1bMV0gKyAiXFxuIiArIGRldGFpbEZvckFycmVydDsKICAgICAgICAgICAgZGV0YWlsRm9yQXJyZXJ0ID0gJyc7CiAgICAgICAgfQoKICAgIH07Ci8vIEJhY2t3YXJkcyBjb21wYXRpYmlsaXR5LCBkZXByZWNhdGVkCiAgICBRVW5pdC5lcXVhbHMgPSBRVW5pdC5lcXVhbDsKICAgIFFVbml0LnNhbWUgPSBRVW5pdC5kZWVwRXF1YWw7CiAgICBRVW5pdC5zdG9wQ291bnQgPSAwOwogICAgUVVuaXQuc3RhcnRDb3VudCA9IDA7CiAgICBRVW5pdC5yZWFkeUZsYWcgPSAxOwovLyBNYWludGFpbiBpbnRlcm5hbCBzdGF0ZQogICAgdmFyIGNvbmZpZyA9IHsKICAgICAgICAvLyBUaGUgcXVldWUgb2YgdGVzdHMgdG8gcnVuCiAgICAgICAgcXVldWU6W10sCgogICAgICAgIC8vIGJsb2NrIHVudGlsIGRvY3VtZW50IHJlYWR5CiAgICAgICAgYmxvY2tpbmc6dHJ1ZSwKCgogICAgICAgIHRpbWVyOiIiCiAgICB9OwovL2ZhaWxlZCBkZXRhaWwgZm9yIGVhY2ggdGVzdCBkb25lCiAgICB2YXIgZmFpbGVkRGV0YWlsID0gJyc7CiAgICB2YXIgZGV0YWlsRm9yQXJyZXJ0ID0gJyc7Ci8vIExvYWQgcGFyYW1hdGVycwogICAgKGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgbG9jYXRpb24gPSB3aW5kb3cubG9jYXRpb24gfHwgeyBzZWFyY2g6IiIsIHByb3RvY29sOiJmaWxlOiIgfSwKICAgICAgICAgICAgR0VUUGFyYW1zID0gbG9jYXRpb24uc2VhcmNoLnNsaWNlKDEpLnNwbGl0KCcmJyk7CgogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgR0VUUGFyYW1zLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIEdFVFBhcmFtc1tpXSA9IGRlY29kZVVSSUNvbXBvbmVudChHRVRQYXJhbXNbaV0pOwogICAgICAgICAgICBpZiAoR0VUUGFyYW1zW2ldID09PSAibm9nbG9iYWxzIikgewogICAgICAgICAgICAgICAgR0VUUGFyYW1zLnNwbGljZShpLCAxKTsKICAgICAgICAgICAgICAgIGktLTsKICAgICAgICAgICAgICAgIGNvbmZpZy5ub2dsb2JhbHMgPSB0cnVlOwogICAgICAgICAgICB9IGVsc2UgaWYgKEdFVFBhcmFtc1tpXS5zZWFyY2goJz0nKSA+IC0xKSB7CiAgICAgICAgICAgICAgICBHRVRQYXJhbXMuc3BsaWNlKGksIDEpOwogICAgICAgICAgICAgICAgaS0tOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyByZXN0cmljdCBtb2R1bGVzL3Rlc3RzIGJ5IGdldCBwYXJhbWV0ZXJzCiAgICAgICAgY29uZmlnLmZpbHRlcnMgPSBHRVRQYXJhbXM7CgogICAgICAgIC8vIEZpZ3VyZSBvdXQgaWYgd2UncmUgcnVubmluZyB0aGUgdGVzdHMgZnJvbSBhIHNlcnZlciBvciBub3QKICAgICAgICBRVW5pdC5pc0xvY2FsID0gISEobG9jYXRpb24ucHJvdG9jb2wgPT09ICdmaWxlOicpOwogICAgfSkoKTsKCi8vIEV4cG9zZSB0aGUgQVBJIGFzIGdsb2JhbCB2YXJpYWJsZXMsIHVubGVzcyBhbiAnZXhwb3J0cycKLy8gb2JqZWN0IGV4aXN0cywgaW4gdGhhdCBjYXNlIHdlIGFzc3VtZSB3ZSdyZSBpbiBDb21tb25KUwogICAgaWYgKHR5cGVvZiBleHBvcnRzID09PSAidW5kZWZpbmVkIiB8fCB0eXBlb2YgcmVxdWlyZSA9PT0gInVuZGVmaW5lZCIpIHsKICAgICAgICBleHRlbmQod2luZG93LCBRVW5pdCk7CiAgICAgICAgd2luZG93LlFVbml0ID0gUVVuaXQ7CiAgICB9IGVsc2UgewogICAgICAgIGV4dGVuZChleHBvcnRzLCBRVW5pdCk7CiAgICAgICAgZXhwb3J0cy5RVW5pdCA9IFFVbml0OwogICAgfQoKICAgIGlmICh0eXBlb2YgZG9jdW1lbnQgPT09ICJ1bmRlZmluZWQiIHx8IGRvY3VtZW50LnJlYWR5U3RhdGUgPT09ICJjb21wbGV0ZSIpIHsKICAgICAgICBjb25maWcuYXV0b3J1biA9IHRydWU7CiAgICB9CgogICAgYWRkRXZlbnQod2luZG93LCAibG9hZCIsIGZ1bmN0aW9uICgpIHsKICAgICAgICAvLyBJbml0aWFsaXplIHRoZSBjb25maWcsIHNhdmluZyB0aGUgZXhlY3V0aW9uIHF1ZXVlCiAgICAgICAgdmFyIG9sZGNvbmZpZyA9IGV4dGVuZCh7fSwgY29uZmlnKTsKICAgICAgICBRVW5pdC5pbml0KCk7CiAgICAgICAgZXh0ZW5kKGNvbmZpZywgb2xkY29uZmlnKTsKCiAgICAgICAgY29uZmlnLmJsb2NraW5nID0gZmFsc2U7CgogICAgICAgIHZhciB1c2VyQWdlbnQgPSBpZCgicXVuaXQtdXNlckFnZW50Iik7CiAgICAgICAgaWYgKHVzZXJBZ2VudCkgewogICAgICAgICAgICB1c2VyQWdlbnQuaW5uZXJIVE1MID0gbmF2aWdhdG9yLnVzZXJBZ2VudDsKICAgICAgICB9CgogICAgICAgIHZhciB0b29sYmFyID0gaWQoInF1bml0LXRlc3RydW5uZXItdG9vbGJhciIpOwogICAgICAgIGlmICh0b29sYmFyKSB7CiAgICAgICAgICAgIHRvb2xiYXIuc3R5bGUuZGlzcGxheSA9ICJub25lIjsKCiAgICAgICAgICAgIHZhciBmaWx0ZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJpbnB1dCIpOwogICAgICAgICAgICBmaWx0ZXIudHlwZSA9ICJjaGVja2JveCI7CiAgICAgICAgICAgIGZpbHRlci5pZCA9ICJxdW5pdC1maWx0ZXItcGFzcyI7CiAgICAgICAgICAgIGZpbHRlci5kaXNhYmxlZCA9IHRydWU7CiAgICAgICAgICAgIGFkZEV2ZW50KGZpbHRlciwgImNsaWNrIiwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdmFyIGxpID0gZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoImxpIik7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxpLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGxpW2ldLmNsYXNzTmFtZS5pbmRleE9mKCJwYXNzIikgPiAtMSkgewogICAgICAgICAgICAgICAgICAgICAgICBsaVtpXS5zdHlsZS5kaXNwbGF5ID0gZmlsdGVyLmNoZWNrZWQgPyAibm9uZSIgOiAiIjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0b29sYmFyLmFwcGVuZENoaWxkKGZpbHRlcik7CgogICAgICAgICAgICB2YXIgbGFiZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJsYWJlbCIpOwogICAgICAgICAgICBsYWJlbC5zZXRBdHRyaWJ1dGUoImZvciIsICJxdW5pdC1maWx0ZXItcGFzcyIpOwogICAgICAgICAgICBsYWJlbC5pbm5lckhUTUwgPSAiSGlkZSBwYXNzZWQgdGVzdHMiOwogICAgICAgICAgICB0b29sYmFyLmFwcGVuZENoaWxkKGxhYmVsKTsKCiAgICAgICAgICAgIHZhciBtaXNzaW5nID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiaW5wdXQiKTsKICAgICAgICAgICAgbWlzc2luZy50eXBlID0gImNoZWNrYm94IjsKICAgICAgICAgICAgbWlzc2luZy5pZCA9ICJxdW5pdC1maWx0ZXItbWlzc2luZyI7CiAgICAgICAgICAgIG1pc3NpbmcuZGlzYWJsZWQgPSB0cnVlOwogICAgICAgICAgICBhZGRFdmVudChtaXNzaW5nLCAiY2xpY2siLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB2YXIgbGkgPSBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgibGkiKTsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGkubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBpZiAobGlbaV0uY2xhc3NOYW1lLmluZGV4T2YoImZhaWwiKSA+IC0xICYmIGxpW2ldLmlubmVySFRNTC5pbmRleE9mKCdtaXNzaW5nIHRlc3QgLSB1bnRlc3RlZCBjb2RlIGlzIGJyb2tlbiBjb2RlJykgPiAtMSkgewogICAgICAgICAgICAgICAgICAgICAgICBsaVtpXS5wYXJlbnROb2RlLnBhcmVudE5vZGUuc3R5bGUuZGlzcGxheSA9IG1pc3NpbmcuY2hlY2tlZCA/ICJub25lIiA6ICJibG9jayI7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdG9vbGJhci5hcHBlbmRDaGlsZChtaXNzaW5nKTsKCiAgICAgICAgICAgIGxhYmVsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgibGFiZWwiKTsKICAgICAgICAgICAgbGFiZWwuc2V0QXR0cmlidXRlKCJmb3IiLCAicXVuaXQtZmlsdGVyLW1pc3NpbmciKTsKICAgICAgICAgICAgbGFiZWwuaW5uZXJIVE1MID0gIkhpZGUgbWlzc2luZyB0ZXN0cyAodW50ZXN0ZWQgY29kZSBpcyBicm9rZW4gY29kZSkiOwogICAgICAgICAgICB0b29sYmFyLmFwcGVuZENoaWxkKGxhYmVsKTsKICAgICAgICB9CgogICAgICAgIHZhciBtYWluID0gaWQoJ21haW4nKTsKICAgICAgICBpZiAobWFpbikgewogICAgICAgICAgICBjb25maWcuZml4dHVyZSA9IG1haW4uaW5uZXJIVE1MOwogICAgICAgIH0KCiAgICAgICAgaWYgKHdpbmRvdy5qUXVlcnkpIHsKICAgICAgICAgICAgY29uZmlnLmFqYXhTZXR0aW5ncyA9IHdpbmRvdy5qUXVlcnkuYWpheFNldHRpbmdzOwogICAgICAgIH0KCiAgICAgICAgUVVuaXQuc3RhcnQoKTsKICAgIH0pOwoKICAgIGZ1bmN0aW9uIGRvbmUoKSB7CiAgICAgICAgaWYgKGNvbmZpZy5kb25lVGltZXIgJiYgd2luZG93LmNsZWFyVGltZW91dCkgewogICAgICAgICAgICB3aW5kb3cuY2xlYXJUaW1lb3V0KGNvbmZpZy5kb25lVGltZXIpOwogICAgICAgICAgICBjb25maWcuZG9uZVRpbWVyID0gbnVsbDsKICAgICAgICB9CgogICAgICAgIGlmIChjb25maWcucXVldWUubGVuZ3RoKSB7CiAgICAgICAgICAgIGNvbmZpZy5kb25lVGltZXIgPSB3aW5kb3cuc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICBpZiAoIWNvbmZpZy5xdWV1ZS5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICBkb25lKCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHN5bmNocm9uaXplKGRvbmUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LCAxMyk7CgogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBjb25maWcuYXV0b3J1biA9IHRydWU7CgogICAgICAgIC8vIExvZyB0aGUgbGFzdCBtb2R1bGUgcmVzdWx0cwogICAgICAgIGlmIChjb25maWcuY3VycmVudE1vZHVsZSkgewogICAgICAgICAgICBRVW5pdC5tb2R1bGVEb25lKGNvbmZpZy5jdXJyZW50TW9kdWxlLCBjb25maWcubW9kdWxlU3RhdHMuYmFkLCBjb25maWcubW9kdWxlU3RhdHMuYWxsKTsKICAgICAgICB9CgogICAgICAgIHZhciBiYW5uZXIgPSBpZCgicXVuaXQtYmFubmVyIiksCiAgICAgICAgICAgIHRlc3RzID0gaWQoInF1bml0LXRlc3RzIiksCiAgICAgICAgICAgIGh0bWwgPSBbJ1Rlc3RzIGNvbXBsZXRlZCBpbiAnLAogICAgICAgICAgICAgICAgK25ldyBEYXRlIC0gY29uZmlnLnN0YXJ0ZWQsICcgbWlsbGlzZWNvbmRzLjxici8+JywKICAgICAgICAgICAgICAgICc8c3BhbiBjbGFzcz0icGFzc2VkIj4nLCBjb25maWcuc3RhdHMuYWxsIC0gY29uZmlnLnN0YXRzLmJhZCwgJzwvc3Bhbj4gdGVzdHMgb2YgPHNwYW4gY2xhc3M9InRvdGFsIj4nLCBjb25maWcuc3RhdHMuYWxsLCAnPC9zcGFuPiBwYXNzZWQsIDxzcGFuIGNsYXNzPSJmYWlsZWQiPicsIGNvbmZpZy5zdGF0cy5iYWQsICc8L3NwYW4+IGZhaWxlZC4nXS5qb2luKCcnKTsKCiAgICAgICAgaWYgKGJhbm5lcikgewogICAgICAgICAgICBiYW5uZXIuY2xhc3NOYW1lID0gKGNvbmZpZy5zdGF0cy5iYWQgPyAicXVuaXQtZmFpbCIgOiAicXVuaXQtcGFzcyIpOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRlc3RzKSB7CiAgICAgICAgICAgIHZhciByZXN1bHQgPSBpZCgicXVuaXQtdGVzdHJlc3VsdCIpOwoKICAgICAgICAgICAgaWYgKCFyZXN1bHQpIHsKICAgICAgICAgICAgICAgIHJlc3VsdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInAiKTsKICAgICAgICAgICAgICAgIHJlc3VsdC5pZCA9ICJxdW5pdC10ZXN0cmVzdWx0IjsKICAgICAgICAgICAgICAgIHJlc3VsdC5jbGFzc05hbWUgPSAicmVzdWx0IjsKICAgICAgICAgICAgICAgIHRlc3RzLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKHJlc3VsdCwgdGVzdHMubmV4dFNpYmxpbmcpOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXN1bHQuaW5uZXJIVE1MID0gaHRtbDsKICAgICAgICB9CgogICAgICAgIFFVbml0LmRvbmUoY29uZmlnLnN0YXRzLmJhZCwgY29uZmlnLnN0YXRzLmFsbCwgZmFpbGVkRGV0YWlsKTsKICAgIH0KCiAgICBmdW5jdGlvbiB2YWxpZFRlc3QobmFtZSkgewogICAgICAgIHZhciBpID0gY29uZmlnLmZpbHRlcnMubGVuZ3RoLAogICAgICAgICAgICBydW4gPSBmYWxzZTsKCiAgICAgICAgaWYgKCFpKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KCiAgICAgICAgd2hpbGUgKGktLSkgewogICAgICAgICAgICB2YXIgZmlsdGVyID0gY29uZmlnLmZpbHRlcnNbaV0sCiAgICAgICAgICAgICAgICBub3QgPSBmaWx0ZXIuY2hhckF0KDApID09ICchJzsKCiAgICAgICAgICAgIGlmIChub3QpIHsKICAgICAgICAgICAgICAgIGZpbHRlciA9IGZpbHRlci5zbGljZSgxKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKG5hbWUuaW5kZXhPZihmaWx0ZXIpICE9PSAtMSkgewogICAgICAgICAgICAgICAgcmV0dXJuICFub3Q7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChub3QpIHsKICAgICAgICAgICAgICAgIHJ1biA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiBydW47CiAgICB9CgogICAgZnVuY3Rpb24gcHVzaChyZXN1bHQsIGFjdHVhbCwgZXhwZWN0ZWQsIG1lc3NhZ2UpIHsKICAgICAgICBtZXNzYWdlID0gbWVzc2FnZSB8fCAocmVzdWx0ID8gIm9rYXkiIDogImZhaWxlZCIpOwogICAgICAgIFFVbml0Lm9rKHJlc3VsdCwgcmVzdWx0ID8gbWVzc2FnZSArICI6ICIgKyBleHBlY3RlZCA6IG1lc3NhZ2UgKyAiLCBleHBlY3RlZDogIiArIFFVbml0LmpzRHVtcC5wYXJzZShleHBlY3RlZCkgKyAiIHJlc3VsdDogIiArIFFVbml0LmpzRHVtcC5wYXJzZShhY3R1YWwpKTsKICAgIH0KCiAgICBmdW5jdGlvbiBzeW5jaHJvbml6ZShjYWxsYmFjaykgewogICAgICAgIGNvbmZpZy5xdWV1ZS5wdXNoKGNhbGxiYWNrKTsKCiAgICAgICAgaWYgKGNvbmZpZy5hdXRvcnVuICYmICFjb25maWcuYmxvY2tpbmcpIHsKICAgICAgICAgICAgcHJvY2VzcygpOwogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBwcm9jZXNzKCkgewogICAgICAgIHdoaWxlIChjb25maWcucXVldWUubGVuZ3RoICYmICFjb25maWcuYmxvY2tpbmcpIHsKICAgICAgICAgICAgY29uZmlnLnF1ZXVlLnNoaWZ0KCkoKTsKICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gc2F2ZUdsb2JhbCgpIHsKICAgICAgICBjb25maWcucG9sbHV0aW9uID0gW107CgogICAgICAgIGlmIChjb25maWcubm9nbG9iYWxzKSB7CiAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiB3aW5kb3cpIHsKICAgICAgICAgICAgICAgIGNvbmZpZy5wb2xsdXRpb24ucHVzaChrZXkpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIGNoZWNrUG9sbHV0aW9uKG5hbWUpIHsKICAgICAgICB2YXIgb2xkID0gY29uZmlnLnBvbGx1dGlvbjsKICAgICAgICBzYXZlR2xvYmFsKCk7CgogICAgICAgIHZhciBuZXdHbG9iYWxzID0gZGlmZihvbGQsIGNvbmZpZy5wb2xsdXRpb24pOwogICAgICAgIGlmIChuZXdHbG9iYWxzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgb2soZmFsc2UsICJJbnRyb2R1Y2VkIGdsb2JhbCB2YXJpYWJsZShzKTogIiArIG5ld0dsb2JhbHMuam9pbigiLCAiKSk7CiAgICAgICAgICAgIGNvbmZpZy5leHBlY3RlZCsrOwogICAgICAgIH0KCiAgICAgICAgdmFyIGRlbGV0ZWRHbG9iYWxzID0gZGlmZihjb25maWcucG9sbHV0aW9uLCBvbGQpOwogICAgICAgIGlmIChkZWxldGVkR2xvYmFscy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgIG9rKGZhbHNlLCAiRGVsZXRlZCBnbG9iYWwgdmFyaWFibGUocyk6ICIgKyBkZWxldGVkR2xvYmFscy5qb2luKCIsICIpKTsKICAgICAgICAgICAgY29uZmlnLmV4cGVjdGVkKys7CiAgICAgICAgfQogICAgfQoKLy8gcmV0dXJucyBhIG5ldyBBcnJheSB3aXRoIHRoZSBlbGVtZW50cyB0aGF0IGFyZSBpbiBhIGJ1dCBub3QgaW4gYgogICAgZnVuY3Rpb24gZGlmZihhLCBiKSB7CiAgICAgICAgdmFyIHJlc3VsdCA9IGEuc2xpY2UoKTsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJlc3VsdC5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IGIubGVuZ3RoOyBqKyspIHsKICAgICAgICAgICAgICAgIGlmIChyZXN1bHRbaV0gPT09IGJbal0pIHsKICAgICAgICAgICAgICAgICAgICByZXN1bHQuc3BsaWNlKGksIDEpOwogICAgICAgICAgICAgICAgICAgIGktLTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICAgIGZ1bmN0aW9uIGZhaWwobWVzc2FnZSwgZXhjZXB0aW9uLCBjYWxsYmFjaykgewogICAgICAgIGlmICh0eXBlb2YgY29uc29sZSAhPT0gInVuZGVmaW5lZCIgJiYgY29uc29sZS5lcnJvciAmJiBjb25zb2xlLndhcm4pIHsKICAgICAgICAgICAgY29uc29sZS5lcnJvcihtZXNzYWdlKTsKICAgICAgICAgICAgY29uc29sZS5lcnJvcihleGNlcHRpb24pOwogICAgICAgICAgICBjb25zb2xlLndhcm4oY2FsbGJhY2sudG9TdHJpbmcoKSk7CgogICAgICAgIH0gZWxzZSBpZiAod2luZG93Lm9wZXJhICYmIG9wZXJhLnBvc3RFcnJvcikgewogICAgICAgICAgICBvcGVyYS5wb3N0RXJyb3IobWVzc2FnZSwgZXhjZXB0aW9uLCBjYWxsYmFjay50b1N0cmluZyk7CiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIGV4dGVuZChhLCBiKSB7CiAgICAgICAgZm9yICh2YXIgcHJvcCBpbiBiKSB7CiAgICAgICAgICAgIGFbcHJvcF0gPSBiW3Byb3BdOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGE7CiAgICB9CgogICAgZnVuY3Rpb24gYWRkRXZlbnQoZWxlbSwgdHlwZSwgZm4pIHsKICAgICAgICBpZiAoZWxlbS5hZGRFdmVudExpc3RlbmVyKSB7CiAgICAgICAgICAgIGVsZW0uYWRkRXZlbnRMaXN0ZW5lcih0eXBlLCBmbiwgZmFsc2UpOwogICAgICAgIH0gZWxzZSBpZiAoZWxlbS5hdHRhY2hFdmVudCkgewogICAgICAgICAgICBlbGVtLmF0dGFjaEV2ZW50KCJvbiIgKyB0eXBlLCBmbik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZm4oKTsKICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gaWQobmFtZSkgewogICAgICAgIHJldHVybiAhISh0eXBlb2YgZG9jdW1lbnQgIT09ICJ1bmRlZmluZWQiICYmIGRvY3VtZW50ICYmIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKSAmJgogICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChuYW1lKTsKICAgIH0KCi8vIFRlc3QgZm9yIGVxdWFsaXR5IGFueSBKYXZhU2NyaXB0IHR5cGUuCi8vIERpc2N1c3Npb25zIGFuZCByZWZlcmVuY2U6IGh0dHA6Ly9waGlscmF0aGUuY29tL2FydGljbGVzL2VxdWl2Ci8vIFRlc3Qgc3VpdGVzOiBodHRwOi8vcGhpbHJhdGhlLmNvbS90ZXN0cy9lcXVpdgovLyBBdXRob3I6IFBoaWxpcHBlIFJhdGjDqSA8cHJhdGhlQGdtYWlsLmNvbT4KICAgIFFVbml0LmVxdWl2ID0gZnVuY3Rpb24gKCkgewoKICAgICAgICB2YXIgaW5uZXJFcXVpdjsgLy8gdGhlIHJlYWwgZXF1aXYgZnVuY3Rpb24KICAgICAgICB2YXIgY2FsbGVycyA9IFtdOyAvLyBzdGFjayB0byBkZWNpZGUgYmV0d2VlbiBza2lwL2Fib3J0IGZ1bmN0aW9ucwoKCiAgICAgICAgLy8gRGV0ZXJtaW5lIHdoYXQgaXMgby4KICAgICAgICBmdW5jdGlvbiBob296aXQobykgewogICAgICAgICAgICBpZiAoUVVuaXQuaXMoIlN0cmluZyIsIG8pKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gInN0cmluZyI7CgogICAgICAgICAgICB9IGVsc2UgaWYgKFFVbml0LmlzKCJCb29sZWFuIiwgbykpIHsKICAgICAgICAgICAgICAgIHJldHVybiAiYm9vbGVhbiI7CgogICAgICAgICAgICB9IGVsc2UgaWYgKFFVbml0LmlzKCJOdW1iZXIiLCBvKSkgewoKICAgICAgICAgICAgICAgIGlmIChpc05hTihvKSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAibmFuIjsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICJudW1iZXIiOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgbyA9PT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgICAgIHJldHVybiAidW5kZWZpbmVkIjsKCiAgICAgICAgICAgICAgICAvLyBjb25zaWRlcjogdHlwZW9mIG51bGwgPT09IG9iamVjdAogICAgICAgICAgICB9IGVsc2UgaWYgKG8gPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHJldHVybiAibnVsbCI7CgogICAgICAgICAgICAgICAgLy8gY29uc2lkZXI6IHR5cGVvZiBbXSA9PT0gb2JqZWN0CiAgICAgICAgICAgIH0gZWxzZSBpZiAoUVVuaXQuaXMoIkFycmF5IiwgbykpIHsKICAgICAgICAgICAgICAgIHJldHVybiAiYXJyYXkiOwoKICAgICAgICAgICAgICAgIC8vIGNvbnNpZGVyOiB0eXBlb2YgbmV3IERhdGUoKSA9PT0gb2JqZWN0CiAgICAgICAgICAgIH0gZWxzZSBpZiAoUVVuaXQuaXMoIkRhdGUiLCBvKSkgewogICAgICAgICAgICAgICAgcmV0dXJuICJkYXRlIjsKCiAgICAgICAgICAgICAgICAvLyBjb25zaWRlcjogLy4vIGluc3RhbmNlb2YgT2JqZWN0OwogICAgICAgICAgICAgICAgLy8gICAgICAgICAgIC8uLyBpbnN0YW5jZW9mIFJlZ0V4cDsKICAgICAgICAgICAgICAgIC8vICAgICAgICAgIHR5cGVvZiAvLi8gPT09ICJmdW5jdGlvbiI7IC8vID0+IGZhbHNlIGluIElFIGFuZCBPcGVyYSwKICAgICAgICAgICAgICAgIC8vICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJ1ZSBpbiBGRiBhbmQgU2FmYXJpCiAgICAgICAgICAgIH0gZWxzZSBpZiAoUVVuaXQuaXMoIlJlZ0V4cCIsIG8pKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gInJlZ2V4cCI7CgogICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBvID09PSAib2JqZWN0IikgewogICAgICAgICAgICAgICAgcmV0dXJuICJvYmplY3QiOwoKICAgICAgICAgICAgfSBlbHNlIGlmIChRVW5pdC5pcygiRnVuY3Rpb24iLCBvKSkgewogICAgICAgICAgICAgICAgcmV0dXJuICJmdW5jdGlvbiI7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyBDYWxsIHRoZSBvIHJlbGF0ZWQgY2FsbGJhY2sgd2l0aCB0aGUgZ2l2ZW4gYXJndW1lbnRzLgogICAgICAgIGZ1bmN0aW9uIGJpbmRDYWxsYmFja3MobywgY2FsbGJhY2tzLCBhcmdzKSB7CiAgICAgICAgICAgIHZhciBwcm9wID0gaG9veml0KG8pOwogICAgICAgICAgICBpZiAocHJvcCkgewogICAgICAgICAgICAgICAgaWYgKGhvb3ppdChjYWxsYmFja3NbcHJvcF0pID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNhbGxiYWNrc1twcm9wXS5hcHBseShjYWxsYmFja3MsIGFyZ3MpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gY2FsbGJhY2tzW3Byb3BdOyAvLyBvciB1bmRlZmluZWQKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdmFyIGNhbGxiYWNrcyA9IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgICAgIC8vIGZvciBzdHJpbmcsIGJvb2xlYW4sIG51bWJlciBhbmQgbnVsbAogICAgICAgICAgICBmdW5jdGlvbiB1c2VTdHJpY3RFcXVhbGl0eShiLCBhKSB7CiAgICAgICAgICAgICAgICBpZiAoYiBpbnN0YW5jZW9mIGEuY29uc3RydWN0b3IgfHwgYSBpbnN0YW5jZW9mIGIuY29uc3RydWN0b3IpIHsKICAgICAgICAgICAgICAgICAgICAvLyB0byBjYXRjaCBzaG9ydCBhbm5vdGFpb24gVlMgJ25ldycgYW5ub3RhdGlvbiBvZiBhIGRlY2xhcmF0aW9uCiAgICAgICAgICAgICAgICAgICAgLy8gZS5nLiB2YXIgaSA9IDE7CiAgICAgICAgICAgICAgICAgICAgLy8gICAgICB2YXIgaiA9IG5ldyBOdW1iZXIoMSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGEgPT0gYjsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGEgPT09IGI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAic3RyaW5nIjp1c2VTdHJpY3RFcXVhbGl0eSwKICAgICAgICAgICAgICAgICJib29sZWFuIjp1c2VTdHJpY3RFcXVhbGl0eSwKICAgICAgICAgICAgICAgICJudW1iZXIiOnVzZVN0cmljdEVxdWFsaXR5LAogICAgICAgICAgICAgICAgIm51bGwiOnVzZVN0cmljdEVxdWFsaXR5LAogICAgICAgICAgICAgICAgInVuZGVmaW5lZCI6dXNlU3RyaWN0RXF1YWxpdHksCgogICAgICAgICAgICAgICAgIm5hbiI6ZnVuY3Rpb24gKGIpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gaXNOYU4oYik7CiAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgICJkYXRlIjpmdW5jdGlvbiAoYiwgYSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBob296aXQoYikgPT09ICJkYXRlIiAmJiBhLnZhbHVlT2YoKSA9PT0gYi52YWx1ZU9mKCk7CiAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgICJyZWdleHAiOmZ1bmN0aW9uIChiLCBhKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGhvb3ppdChiKSA9PT0gInJlZ2V4cCIgJiYKICAgICAgICAgICAgICAgICAgICAgICAgYS5zb3VyY2UgPT09IGIuc291cmNlICYmIC8vIHRoZSByZWdleCBpdHNlbGYKICAgICAgICAgICAgICAgICAgICAgICAgYS5nbG9iYWwgPT09IGIuZ2xvYmFsICYmIC8vIGFuZCBpdHMgbW9kaWZlcnMgKGdtaSkgLi4uCiAgICAgICAgICAgICAgICAgICAgICAgIGEuaWdub3JlQ2FzZSA9PT0gYi5pZ25vcmVDYXNlICYmCiAgICAgICAgICAgICAgICAgICAgICAgIGEubXVsdGlsaW5lID09PSBiLm11bHRpbGluZTsKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgLy8gLSBza2lwIHdoZW4gdGhlIHByb3BlcnR5IGlzIGEgbWV0aG9kIG9mIGFuIGluc3RhbmNlIChPT1ApCiAgICAgICAgICAgICAgICAvLyAtIGFib3J0IG90aGVyd2lzZSwKICAgICAgICAgICAgICAgIC8vICAgaW5pdGlhbCA9PT0gd291bGQgaGF2ZSBjYXRjaCBpZGVudGljYWwgcmVmZXJlbmNlcyBhbnl3YXkKICAgICAgICAgICAgICAgICJmdW5jdGlvbiI6ZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIHZhciBjYWxsZXIgPSBjYWxsZXJzW2NhbGxlcnMubGVuZ3RoIC0gMV07CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNhbGxlciAhPT0gT2JqZWN0ICYmCiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGVvZiBjYWxsZXIgIT09ICJ1bmRlZmluZWQiOwogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICAiYXJyYXkiOmZ1bmN0aW9uIChiLCBhKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGk7CiAgICAgICAgICAgICAgICAgICAgdmFyIGxlbjsKCiAgICAgICAgICAgICAgICAgICAgLy8gYiBjb3VsZCBiZSBhbiBvYmplY3QgbGl0ZXJhbCBoZXJlCiAgICAgICAgICAgICAgICAgICAgaWYgKCEoaG9veml0KGIpID09PSAiYXJyYXkiKSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBsZW4gPSBhLmxlbmd0aDsKICAgICAgICAgICAgICAgICAgICBpZiAobGVuICE9PSBiLmxlbmd0aCkgeyAvLyBzYWZlIGFuZCBmYXN0ZXIKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFpbm5lckVxdWl2KGFbaV0sIGJbaV0pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgICJvYmplY3QiOmZ1bmN0aW9uIChiLCBhKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGk7CiAgICAgICAgICAgICAgICAgICAgdmFyIGVxID0gdHJ1ZTsgLy8gdW5sZXNzIHdlIGNhbiBwcm9vdmUgaXQKICAgICAgICAgICAgICAgICAgICB2YXIgYVByb3BlcnRpZXMgPSBbXSwgYlByb3BlcnRpZXMgPSBbXTsgLy8gY29sbGVjdGlvbiBvZiBzdHJpbmdzCgogICAgICAgICAgICAgICAgICAgIC8vIGNvbXBhcmluZyBjb25zdHJ1Y3RvcnMgaXMgbW9yZSBzdHJpY3QgdGhhbiB1c2luZyBpbnN0YW5jZW9mCiAgICAgICAgICAgICAgICAgICAgaWYgKGEuY29uc3RydWN0b3IgIT09IGIuY29uc3RydWN0b3IpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLy8gc3RhY2sgY29uc3RydWN0b3IgYmVmb3JlIHRyYXZlcnNpbmcgcHJvcGVydGllcwogICAgICAgICAgICAgICAgICAgIGNhbGxlcnMucHVzaChhLmNvbnN0cnVjdG9yKTsKCiAgICAgICAgICAgICAgICAgICAgZm9yIChpIGluIGEpIHsgLy8gYmUgc3RyaWN0OiBkb24ndCBlbnN1cmVzIGhhc093blByb3BlcnR5IGFuZCBnbyBkZWVwCgogICAgICAgICAgICAgICAgICAgICAgICBhUHJvcGVydGllcy5wdXNoKGkpOyAvLyBjb2xsZWN0IGEncyBwcm9wZXJ0aWVzCgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWlubmVyRXF1aXYoYVtpXSwgYltpXSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVxID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGNhbGxlcnMucG9wKCk7IC8vIHVuc3RhY2ssIHdlIGFyZSBkb25lCgogICAgICAgICAgICAgICAgICAgIGZvciAoaSBpbiBiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGJQcm9wZXJ0aWVzLnB1c2goaSk7IC8vIGNvbGxlY3QgYidzIHByb3BlcnRpZXMKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIC8vIEVuc3VyZXMgaWRlbnRpY2FsIHByb3BlcnRpZXMgbmFtZQogICAgICAgICAgICAgICAgICAgIHJldHVybiBlcSAmJiBpbm5lckVxdWl2KGFQcm9wZXJ0aWVzLnNvcnQoKSwgYlByb3BlcnRpZXMuc29ydCgpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICB9KCk7CgogICAgICAgIGlubmVyRXF1aXYgPSBmdW5jdGlvbiAoKSB7IC8vIGNhbiB0YWtlIG11bHRpcGxlIGFyZ3VtZW50cwogICAgICAgICAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5hcHBseShhcmd1bWVudHMpOwogICAgICAgICAgICBpZiAoYXJncy5sZW5ndGggPCAyKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsgLy8gZW5kIHRyYW5zaXRpb24KICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIChmdW5jdGlvbiAoYSwgYikgewogICAgICAgICAgICAgICAgaWYgKGEgPT09IGIpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsgLy8gY2F0Y2ggdGhlIG1vc3QgeW91IGNhbgogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChhID09PSBudWxsIHx8IGIgPT09IG51bGwgfHwgdHlwZW9mIGEgPT09ICJ1bmRlZmluZWQiIHx8IHR5cGVvZiBiID09PSAidW5kZWZpbmVkIiB8fCBob296aXQoYSkgIT09IGhvb3ppdChiKSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsgLy8gZG9uJ3QgbG9zZSB0aW1lIHdpdGggZXJyb3IgcHJvbmUgY2FzZXMKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGJpbmRDYWxsYmFja3MoYSwgY2FsbGJhY2tzLCBbYiwgYV0pOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIGFwcGx5IHRyYW5zaXRpb24gd2l0aCAoMS4ubikgYXJndW1lbnRzCiAgICAgICAgICAgIH0pKGFyZ3NbMF0sIGFyZ3NbMV0pICYmIGFyZ3VtZW50cy5jYWxsZWUuYXBwbHkodGhpcywgYXJncy5zcGxpY2UoMSwgYXJncy5sZW5ndGggLSAxKSk7CiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIGlubmVyRXF1aXY7CgogICAgfSgpOwoKICAgIC8qKgogICAgICoganNEdW1wCiAgICAgKiBDb3B5cmlnaHQgKGMpIDIwMDggQXJpZWwgRmxlc2xlciAtIGFmbGVzbGVyKGF0KWdtYWlsKGRvdCljb20gfCBodHRwOi8vZmxlc2xlci5ibG9nc3BvdC5jb20KICAgICAqIExpY2Vuc2VkIHVuZGVyIEJTRCAoaHR0cDovL3d3dy5vcGVuc291cmNlLm9yZy9saWNlbnNlcy9ic2QtbGljZW5zZS5waHApCiAgICAgKiBEYXRlOiA1LzE1LzIwMDgKICAgICAqIEBwcm9qZWN0RGVzY3JpcHRpb24gQWR2YW5jZWQgYW5kIGV4dGVuc2libGUgZGF0YSBkdW1waW5nIGZvciBKYXZhc2NyaXB0LgogICAgICogQHZlcnNpb24gMS4wLjAKICAgICAqIEBhdXRob3IgQXJpZWwgRmxlc2xlcgogICAgICogQGxpbmsge2h0dHA6Ly9mbGVzbGVyLmJsb2dzcG90LmNvbS8yMDA4LzA1L2pzZHVtcC1wcmV0dHktZHVtcC1vZi1hbnktamF2YXNjcmlwdC5odG1sfQogICAgICovCiAgICBRVW5pdC5qc0R1bXAgPSAoZnVuY3Rpb24gKCkgewogICAgICAgIGZ1bmN0aW9uIHF1b3RlKHN0cikgewogICAgICAgICAgICByZXR1cm4gJyInICsgc3RyLnRvU3RyaW5nKCkucmVwbGFjZSgvIi9nLCAnXFwiJykgKyAnIic7CiAgICAgICAgfQoKICAgICAgICA7CiAgICAgICAgZnVuY3Rpb24gbGl0ZXJhbChvKSB7CiAgICAgICAgICAgIHJldHVybiBvICsgJyc7CiAgICAgICAgfQoKICAgICAgICA7CiAgICAgICAgZnVuY3Rpb24gam9pbihwcmUsIGFyciwgcG9zdCkgewogICAgICAgICAgICB2YXIgcyA9IGpzRHVtcC5zZXBhcmF0b3IoKSwKICAgICAgICAgICAgICAgIGJhc2UgPSBqc0R1bXAuaW5kZW50KCksCiAgICAgICAgICAgICAgICBpbm5lciA9IGpzRHVtcC5pbmRlbnQoMSk7CiAgICAgICAgICAgIGlmIChhcnIuam9pbikKICAgICAgICAgICAgICAgIGFyciA9IGFyci5qb2luKCcsJyArIHMgKyBpbm5lcik7CiAgICAgICAgICAgIGlmICghYXJyKQogICAgICAgICAgICAgICAgcmV0dXJuIHByZSArIHBvc3Q7CiAgICAgICAgICAgIHJldHVybiBbIHByZSwgaW5uZXIgKyBhcnIsIGJhc2UgKyBwb3N0IF0uam9pbihzKTsKICAgICAgICB9CgogICAgICAgIDsKICAgICAgICBmdW5jdGlvbiBhcnJheShhcnIpIHsKICAgICAgICAgICAgdmFyIGkgPSBhcnIubGVuZ3RoLCByZXQgPSBBcnJheShpKTsKICAgICAgICAgICAgdGhpcy51cCgpOwogICAgICAgICAgICB3aGlsZSAoaS0tKQogICAgICAgICAgICAgICAgcmV0W2ldID0gdGhpcy5wYXJzZShhcnJbaV0pOwogICAgICAgICAgICB0aGlzLmRvd24oKTsKICAgICAgICAgICAgcmV0dXJuIGpvaW4oJ1snLCByZXQsICddJyk7CiAgICAgICAgfQoKICAgICAgICA7CgogICAgICAgIHZhciByZU5hbWUgPSAvXmZ1bmN0aW9uIChcdyspLzsKCiAgICAgICAgdmFyIGpzRHVtcCA9IHsKICAgICAgICAgICAgcGFyc2U6ZnVuY3Rpb24gKG9iaiwgdHlwZSkgeyAvL3R5cGUgaXMgdXNlZCBtb3N0bHkgaW50ZXJuYWxseSwgeW91IGNhbiBmaXggYSAoY3VzdG9tKXR5cGUgaW4gYWR2YW5jZQogICAgICAgICAgICAgICAgdmFyIHBhcnNlciA9IHRoaXMucGFyc2Vyc1sgdHlwZSB8fCB0aGlzLnR5cGVPZihvYmopIF07CiAgICAgICAgICAgICAgICB0eXBlID0gdHlwZW9mIHBhcnNlcjsKCiAgICAgICAgICAgICAgICByZXR1cm4gdHlwZSA9PSAnZnVuY3Rpb24nID8gcGFyc2VyLmNhbGwodGhpcywgb2JqKSA6CiAgICAgICAgICAgICAgICAgICAgdHlwZSA9PSAnc3RyaW5nJyA/IHBhcnNlciA6CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucGFyc2Vycy5lcnJvcjsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdHlwZU9mOmZ1bmN0aW9uIChvYmopIHsKICAgICAgICAgICAgICAgIHZhciB0eXBlOwogICAgICAgICAgICAgICAgaWYgKG9iaiA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHR5cGUgPSAibnVsbCI7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBvYmogPT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgICAgICAgICAgdHlwZSA9ICJ1bmRlZmluZWQiOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChRVW5pdC5pcygiUmVnRXhwIiwgb2JqKSkgewogICAgICAgICAgICAgICAgICAgIHR5cGUgPSAicmVnZXhwIjsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoUVVuaXQuaXMoIkRhdGUiLCBvYmopKSB7CiAgICAgICAgICAgICAgICAgICAgdHlwZSA9ICJkYXRlIjsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoUVVuaXQuaXMoIkZ1bmN0aW9uIiwgb2JqKSkgewogICAgICAgICAgICAgICAgICAgIHR5cGUgPSAiZnVuY3Rpb24iOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChRVW5pdC5pcygiQXJyYXkiLCBvYmopKSB7CiAgICAgICAgICAgICAgICAgICAgdHlwZSA9ICJhcnJheSI7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKFFVbml0LmlzKCJXaW5kb3ciLCBvYmopIHx8IFFVbml0LmlzKCJnbG9iYWwiLCBvYmopKSB7CiAgICAgICAgICAgICAgICAgICAgdHlwZSA9ICJ3aW5kb3ciOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChRVW5pdC5pcygiSFRNTERvY3VtZW50Iiwgb2JqKSkgewogICAgICAgICAgICAgICAgICAgIHR5cGUgPSAiZG9jdW1lbnQiOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChRVW5pdC5pcygiSFRNTENvbGxlY3Rpb24iLCBvYmopIHx8IFFVbml0LmlzKCJOb2RlTGlzdCIsIG9iaikpIHsKICAgICAgICAgICAgICAgICAgICB0eXBlID0gIm5vZGVsaXN0IjsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoL15cW29iamVjdCBIVE1MLy50ZXN0KE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChvYmopKSkgewogICAgICAgICAgICAgICAgICAgIHR5cGUgPSAibm9kZSI7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHR5cGUgPSB0eXBlb2Ygb2JqOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHR5cGU7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHNlcGFyYXRvcjpmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5tdWx0aWxpbmUgPyB0aGlzLkhUTUwgPyAnPGJyIC8+JyA6ICdcbicgOiB0aGlzLkhUTUwgPyAnJm5ic3A7JyA6ICcgJzsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgaW5kZW50OmZ1bmN0aW9uIChleHRyYSkgey8vIGV4dHJhIGNhbiBiZSBhIG51bWJlciwgc2hvcnRjdXQgZm9yIGluY3JlYXNpbmctY2FsbGluZy1kZWNyZWFzaW5nCiAgICAgICAgICAgICAgICBpZiAoIXRoaXMubXVsdGlsaW5lKQogICAgICAgICAgICAgICAgICAgIHJldHVybiAnJzsKICAgICAgICAgICAgICAgIHZhciBjaHIgPSB0aGlzLmluZGVudENoYXI7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5IVE1MKQogICAgICAgICAgICAgICAgICAgIGNociA9IGNoci5yZXBsYWNlKC9cdC9nLCAnICAgJykucmVwbGFjZSgvIC9nLCAnJm5ic3A7Jyk7CiAgICAgICAgICAgICAgICByZXR1cm4gQXJyYXkodGhpcy5fZGVwdGhfICsgKGV4dHJhIHx8IDApKS5qb2luKGNocik7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVwOmZ1bmN0aW9uIChhKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9kZXB0aF8gKz0gYSB8fCAxOwogICAgICAgICAgICB9LAogICAgICAgICAgICBkb3duOmZ1bmN0aW9uIChhKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9kZXB0aF8gLT0gYSB8fCAxOwogICAgICAgICAgICB9LAogICAgICAgICAgICBzZXRQYXJzZXI6ZnVuY3Rpb24gKG5hbWUsIHBhcnNlcikgewogICAgICAgICAgICAgICAgdGhpcy5wYXJzZXJzW25hbWVdID0gcGFyc2VyOwogICAgICAgICAgICB9LAogICAgICAgICAgICAvLyBUaGUgbmV4dCAzIGFyZSBleHBvc2VkIHNvIHlvdSBjYW4gdXNlIHRoZW0KICAgICAgICAgICAgcXVvdGU6cXVvdGUsCiAgICAgICAgICAgIGxpdGVyYWw6bGl0ZXJhbCwKICAgICAgICAgICAgam9pbjpqb2luLAogICAgICAgICAgICAvLwogICAgICAgICAgICBfZGVwdGhfOjEsCiAgICAgICAgICAgIC8vIFRoaXMgaXMgdGhlIGxpc3Qgb2YgcGFyc2VycywgdG8gbW9kaWZ5IHRoZW0sIHVzZSBqc0R1bXAuc2V0UGFyc2VyCiAgICAgICAgICAgIHBhcnNlcnM6ewogICAgICAgICAgICAgICAgd2luZG93OidbV2luZG93XScsCiAgICAgICAgICAgICAgICBkb2N1bWVudDonW0RvY3VtZW50XScsCiAgICAgICAgICAgICAgICBlcnJvcjonW0VSUk9SXScsIC8vd2hlbiBubyBwYXJzZXIgaXMgZm91bmQsIHNob3VsZG4ndCBoYXBwZW4KICAgICAgICAgICAgICAgIHVua25vd246J1tVbmtub3duXScsCiAgICAgICAgICAgICAgICAnbnVsbCc6J251bGwnLAogICAgICAgICAgICAgICAgdW5kZWZpbmVkOid1bmRlZmluZWQnLAogICAgICAgICAgICAgICAgJ2Z1bmN0aW9uJzpmdW5jdGlvbiAoZm4pIHsKICAgICAgICAgICAgICAgICAgICB2YXIgcmV0ID0gJ2Z1bmN0aW9uJywKICAgICAgICAgICAgICAgICAgICAgICAgbmFtZSA9ICduYW1lJyBpbiBmbiA/IGZuLm5hbWUgOiAocmVOYW1lLmV4ZWMoZm4pIHx8IFtdKVsxXTsvL2Z1bmN0aW9ucyBuZXZlciBoYXZlIG5hbWUgaW4gSUUKICAgICAgICAgICAgICAgICAgICBpZiAobmFtZSkKICAgICAgICAgICAgICAgICAgICAgICAgcmV0ICs9ICcgJyArIG5hbWU7CiAgICAgICAgICAgICAgICAgICAgcmV0ICs9ICcoJzsKCiAgICAgICAgICAgICAgICAgICAgcmV0ID0gWyByZXQsIHRoaXMucGFyc2UoZm4sICdmdW5jdGlvbkFyZ3MnKSwgJyl7J10uam9pbignJyk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGpvaW4ocmV0LCB0aGlzLnBhcnNlKGZuLCAnZnVuY3Rpb25Db2RlJyksICd9Jyk7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgYXJyYXk6YXJyYXksCiAgICAgICAgICAgICAgICBub2RlbGlzdDphcnJheSwKICAgICAgICAgICAgICAgIGFyZ3VtZW50czphcnJheSwKICAgICAgICAgICAgICAgIG9iamVjdDpmdW5jdGlvbiAobWFwKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHJldCA9IFsgXTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnVwKCk7CiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIga2V5IGluIG1hcCkKICAgICAgICAgICAgICAgICAgICAgICAgcmV0LnB1c2godGhpcy5wYXJzZShrZXksICdrZXknKSArICc6ICcgKyB0aGlzLnBhcnNlKG1hcFtrZXldKSk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5kb3duKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGpvaW4oJ3snLCByZXQsICd9Jyk7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgbm9kZTpmdW5jdGlvbiAobm9kZSkgewogICAgICAgICAgICAgICAgICAgIHZhciBvcGVuID0gdGhpcy5IVE1MID8gJyZsdDsnIDogJzwnLAogICAgICAgICAgICAgICAgICAgICAgICBjbG9zZSA9IHRoaXMuSFRNTCA/ICcmZ3Q7JyA6ICc+JzsKCiAgICAgICAgICAgICAgICAgICAgdmFyIHRhZyA9IG5vZGUubm9kZU5hbWUudG9Mb3dlckNhc2UoKSwKICAgICAgICAgICAgICAgICAgICAgICAgcmV0ID0gb3BlbiArIHRhZzsKCiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgYSBpbiB0aGlzLkRPTUF0dHJzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB2YWwgPSBub2RlW3RoaXMuRE9NQXR0cnNbYV1dOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAodmFsKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0ICs9ICcgJyArIGEgKyAnPScgKyB0aGlzLnBhcnNlKHZhbCwgJ2F0dHJpYnV0ZScpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmV0ICsgY2xvc2UgKyBvcGVuICsgJy8nICsgdGFnICsgY2xvc2U7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgZnVuY3Rpb25BcmdzOmZ1bmN0aW9uIChmbikgey8vZnVuY3Rpb24gY2FsbHMgaXQgaW50ZXJuYWxseSwgaXQncyB0aGUgYXJndW1lbnRzIHBhcnQgb2YgdGhlIGZ1bmN0aW9uCiAgICAgICAgICAgICAgICAgICAgdmFyIGwgPSBmbi5sZW5ndGg7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFsKSByZXR1cm4gJyc7CgogICAgICAgICAgICAgICAgICAgIHZhciBhcmdzID0gQXJyYXkobCk7CiAgICAgICAgICAgICAgICAgICAgd2hpbGUgKGwtLSkKICAgICAgICAgICAgICAgICAgICAgICAgYXJnc1tsXSA9IFN0cmluZy5mcm9tQ2hhckNvZGUoOTcgKyBsKTsvLzk3IGlzICdhJwogICAgICAgICAgICAgICAgICAgIHJldHVybiAnICcgKyBhcmdzLmpvaW4oJywgJykgKyAnICc7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAga2V5OnF1b3RlLCAvL29iamVjdCBjYWxscyBpdCBpbnRlcm5hbGx5LCB0aGUga2V5IHBhcnQgb2YgYW4gaXRlbSBpbiBhIG1hcAogICAgICAgICAgICAgICAgZnVuY3Rpb25Db2RlOidbY29kZV0nLCAvL2Z1bmN0aW9uIGNhbGxzIGl0IGludGVybmFsbHksIGl0J3MgdGhlIGNvbnRlbnQgb2YgdGhlIGZ1bmN0aW9uCiAgICAgICAgICAgICAgICBhdHRyaWJ1dGU6cXVvdGUsIC8vbm9kZSBjYWxscyBpdCBpbnRlcm5hbGx5LCBpdCdzIGFuIGh0bWwgYXR0cmlidXRlIHZhbHVlCiAgICAgICAgICAgICAgICBzdHJpbmc6cXVvdGUsCiAgICAgICAgICAgICAgICBkYXRlOnF1b3RlLAogICAgICAgICAgICAgICAgcmVnZXhwOmxpdGVyYWwsIC8vcmVnZXgKICAgICAgICAgICAgICAgIG51bWJlcjpsaXRlcmFsLAogICAgICAgICAgICAgICAgJ2Jvb2xlYW4nOmxpdGVyYWwKICAgICAgICAgICAgfSwKICAgICAgICAgICAgRE9NQXR0cnM6ey8vYXR0cmlidXRlcyB0byBkdW1wIGZyb20gbm9kZXMsIG5hbWU9PnJlYWxOYW1lCiAgICAgICAgICAgICAgICBpZDonaWQnLAogICAgICAgICAgICAgICAgbmFtZTonbmFtZScsCiAgICAgICAgICAgICAgICAnY2xhc3MnOidjbGFzc05hbWUnCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIEhUTUw6dHJ1ZSwgLy9pZiB0cnVlLCBlbnRpdGllcyBhcmUgZXNjYXBlZCAoIDwsID4sIFx0LCBzcGFjZSBhbmQgXG4gKQogICAgICAgICAgICBpbmRlbnRDaGFyOicgICAnLCAvL2luZGVudGF0aW9uIHVuaXQKICAgICAgICAgICAgbXVsdGlsaW5lOnRydWUgLy9pZiB0cnVlLCBpdGVtcyBpbiBhIGNvbGxlY3Rpb24sIGFyZSBzZXBhcmF0ZWQgYnkgYSBcbiwgZWxzZSBqdXN0IGEgc3BhY2UuCiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIGpzRHVtcDsKICAgIH0pKCk7Cgp9KSh0aGlzKTsK",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Sun, 09 Nov 2014 00:31:20 GMT",
                    "Content-Length": "37884",
                    "Date": "Sun, 09 Nov 2014 00:31:21 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}