{
    "url": "http://localhost:9999/jaridmargolin/marionette.components/dist/marionette.components.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Open redirection (DOM-based)",
    "issueType": 5243152,
    "severity": "Low",
    "confidence": "Firm",
    "issueBackground": "DOM-based open redirection vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this data into the target of a redirection in an unsafe way. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will cause a redirection to an arbitrary external domain. This behavior can be leveraged to facilitate phishing attacks against users of the application. The ability to use an authentic application URL, targeting the correct domain with a valid SSL certificate (if SSL is used) lends credibility to the phishing attack because many users, even if they verify these features, will not notice the subsequent redirection to a different domain.<br><br><b>Note:</b> If an attacker is able to control the start of the string that is passed to the redirection API, then it may be possible to escalate this vulnerability into a JavaScript injection attack, by using a URL with the javascript: pseudo-protocol to execute arbitrary script code when the URL is processed by the browser.",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based open redirection vulnerabilities is not to dynamically set redirection targets using data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing an arbitrary URL as a redirection target. In general, this is best achieved by using a whitelist of URLs that are permitted redirection targets, and strictly validating the target against this list before performing the redirection.",
    "issueDetail": "The application may be vulnerable to DOM-based open redirection. Data is read from <b>location.href</b> and written to <b>location.replace()</b> via the following statements:<ul><li>var href = location.href.replace(/(javascript:|#).*$/, '');</li><li>location.replace(href + '#' + fragment);</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/jaridmargolin/marionette.components/dist/marionette.components.js",
                "path": "/jaridmargolin/marionette.components/dist/marionette.components.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9qYXJpZG1hcmdvbGluL21hcmlvbmV0dGUuY29tcG9uZW50cy9kaXN0L21hcmlvbmV0dGUuY29tcG9uZW50cy5qcyBIVFRQLzEuMQ0KSG9zdDogbG9jYWxob3N0Ojk5OTkNCg0K",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogNTEwNTU2DQpBY2NlcHQtUmFuZ2VzOiBieXRlcw0KQ29udGVudC1UeXBlOiBhcHBsaWNhdGlvbi9qYXZhc2NyaXB0DQpEYXRlOiBGcmksIDA3IE5vdiAyMDE0IDA5OjE2OjMxIEdNVA0KTGFzdC1Nb2RpZmllZDogRnJpLCAwNyBOb3YgMjAxNCAwOToxNjozMSBHTVQNCg0KKGZ1bmN0aW9uIChyb290LCBmYWN0b3J5KSB7CiAgaWYgKHR5cGVvZiBkZWZpbmUgPT09ICdmdW5jdGlvbicgJiYgZGVmaW5lLmFtZCkgewogICAgLy8gQU1ELiBSZWdpc3RlciBhcyBhbiBhbm9ueW1vdXMgbW9kdWxlLgogICAgZGVmaW5lKFtdLCBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiAocm9vdC5yZXR1cm5FeHBvcnRzR2xvYmFsID0gZmFjdG9yeSgpKTsKICAgIH0pOwogIH0gZWxzZSBpZiAodHlwZW9mIGV4cG9ydHMgPT09ICdvYmplY3QnKSB7CiAgICAvLyBOb2RlLiBEb2VzIG5vdCB3b3JrIHdpdGggc3RyaWN0IENvbW1vbkpTLCBidXQKICAgIC8vIG9ubHkgQ29tbW9uSlMtbGlrZSBlbnZpcm9tZW50cyB0aGF0IHN1cHBvcnQgbW9kdWxlLmV4cG9ydHMsCiAgICAvLyBsaWtlIE5vZGUuCiAgICBtb2R1bGUuZXhwb3J0cyA9IGZhY3RvcnkoKTsKICB9IGVsc2UgewogICAgcm9vdFsnTWFyaW9uZXR0ZUNvbXBvbmVudHMnXSA9IGZhY3RvcnkoKTsKICB9Cn0odGhpcywgZnVuY3Rpb24gKCkgewoKLy8gICAgIFVuZGVyc2NvcmUuanMgMS42LjAKLy8gICAgIGh0dHA6Ly91bmRlcnNjb3JlanMub3JnCi8vICAgICAoYykgMjAwOS0yMDE0IEplcmVteSBBc2hrZW5hcywgRG9jdW1lbnRDbG91ZCBhbmQgSW52ZXN0aWdhdGl2ZSBSZXBvcnRlcnMgJiBFZGl0b3JzCi8vICAgICBVbmRlcnNjb3JlIG1heSBiZSBmcmVlbHkgZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLgp2YXIgdW5kZXJzY29yZSwganF1ZXJ5LCBiYWNrYm9uZSwgYmFja2JvbmV3cmVxciwgYmFja2JvbmViYWJ5c2l0dGVyLCBiYWNrYm9uZW1hcmlvbmV0dGUsIF9iYXNlXywgX2NvbGxlY3Rpb25fLCBjb21wb3NpdGUsIGl0ZW0sIGxheW91dCwgbWFyaW9uZXR0ZWNvbXBvbmVudHM7CihmdW5jdGlvbiAoKSB7CiAgLy8gQmFzZWxpbmUgc2V0dXAKICAvLyAtLS0tLS0tLS0tLS0tLQogIC8vIEVzdGFibGlzaCB0aGUgcm9vdCBvYmplY3QsIGB3aW5kb3dgIGluIHRoZSBicm93c2VyLCBvciBgZXhwb3J0c2Agb24gdGhlIHNlcnZlci4KICB2YXIgcm9vdCA9IHRoaXM7CiAgLy8gU2F2ZSB0aGUgcHJldmlvdXMgdmFsdWUgb2YgdGhlIGBfYCB2YXJpYWJsZS4KICB2YXIgcHJldmlvdXNVbmRlcnNjb3JlID0gcm9vdC5fOwogIC8vIEVzdGFibGlzaCB0aGUgb2JqZWN0IHRoYXQgZ2V0cyByZXR1cm5lZCB0byBicmVhayBvdXQgb2YgYSBsb29wIGl0ZXJhdGlvbi4KICB2YXIgYnJlYWtlciA9IHt9OwogIC8vIFNhdmUgYnl0ZXMgaW4gdGhlIG1pbmlmaWVkIChidXQgbm90IGd6aXBwZWQpIHZlcnNpb246CiAgdmFyIEFycmF5UHJvdG8gPSBBcnJheS5wcm90b3R5cGUsIE9ialByb3RvID0gT2JqZWN0LnByb3RvdHlwZSwgRnVuY1Byb3RvID0gRnVuY3Rpb24ucHJvdG90eXBlOwogIC8vIENyZWF0ZSBxdWljayByZWZlcmVuY2UgdmFyaWFibGVzIGZvciBzcGVlZCBhY2Nlc3MgdG8gY29yZSBwcm90b3R5cGVzLgogIHZhciBwdXNoID0gQXJyYXlQcm90by5wdXNoLCBzbGljZSA9IEFycmF5UHJvdG8uc2xpY2UsIGNvbmNhdCA9IEFycmF5UHJvdG8uY29uY2F0LCB0b1N0cmluZyA9IE9ialByb3RvLnRvU3RyaW5nLCBoYXNPd25Qcm9wZXJ0eSA9IE9ialByb3RvLmhhc093blByb3BlcnR5OwogIC8vIEFsbCAqKkVDTUFTY3JpcHQgNSoqIG5hdGl2ZSBmdW5jdGlvbiBpbXBsZW1lbnRhdGlvbnMgdGhhdCB3ZSBob3BlIHRvIHVzZQogIC8vIGFyZSBkZWNsYXJlZCBoZXJlLgogIHZhciBuYXRpdmVGb3JFYWNoID0gQXJyYXlQcm90by5mb3JFYWNoLCBuYXRpdmVNYXAgPSBBcnJheVByb3RvLm1hcCwgbmF0aXZlUmVkdWNlID0gQXJyYXlQcm90by5yZWR1Y2UsIG5hdGl2ZVJlZHVjZVJpZ2h0ID0gQXJyYXlQcm90by5yZWR1Y2VSaWdodCwgbmF0aXZlRmlsdGVyID0gQXJyYXlQcm90by5maWx0ZXIsIG5hdGl2ZUV2ZXJ5ID0gQXJyYXlQcm90by5ldmVyeSwgbmF0aXZlU29tZSA9IEFycmF5UHJvdG8uc29tZSwgbmF0aXZlSW5kZXhPZiA9IEFycmF5UHJvdG8uaW5kZXhPZiwgbmF0aXZlTGFzdEluZGV4T2YgPSBBcnJheVByb3RvLmxhc3RJbmRleE9mLCBuYXRpdmVJc0FycmF5ID0gQXJyYXkuaXNBcnJheSwgbmF0aXZlS2V5cyA9IE9iamVjdC5rZXlzLCBuYXRpdmVCaW5kID0gRnVuY1Byb3RvLmJpbmQ7CiAgLy8gQ3JlYXRlIGEgc2FmZSByZWZlcmVuY2UgdG8gdGhlIFVuZGVyc2NvcmUgb2JqZWN0IGZvciB1c2UgYmVsb3cuCiAgdmFyIF8gPSBmdW5jdGlvbiAob2JqKSB7CiAgICBpZiAob2JqIGluc3RhbmNlb2YgXykKICAgICAgcmV0dXJuIG9iajsKICAgIGlmICghKHRoaXMgaW5zdGFuY2VvZiBfKSkKICAgICAgcmV0dXJuIG5ldyBfKG9iaik7CiAgICB0aGlzLl93cmFwcGVkID0gb2JqOwogIH07CiAgLy8gRXhwb3J0IHRoZSBVbmRlcnNjb3JlIG9iamVjdCBmb3IgKipOb2RlLmpzKiosIHdpdGgKICAvLyBiYWNrd2FyZHMtY29tcGF0aWJpbGl0eSBmb3IgdGhlIG9sZCBgcmVxdWlyZSgpYCBBUEkuIElmIHdlJ3JlIGluCiAgLy8gdGhlIGJyb3dzZXIsIGFkZCBgX2AgYXMgYSBnbG9iYWwgb2JqZWN0IHZpYSBhIHN0cmluZyBpZGVudGlmaWVyLAogIC8vIGZvciBDbG9zdXJlIENvbXBpbGVyICJhZHZhbmNlZCIgbW9kZS4KICBpZiAodHlwZW9mIGV4cG9ydHMgIT09ICd1bmRlZmluZWQnKSB7CiAgICBpZiAodHlwZW9mIG1vZHVsZSAhPT0gJ3VuZGVmaW5lZCcgJiYgbW9kdWxlLmV4cG9ydHMpIHsKICAgICAgZXhwb3J0cyA9IG1vZHVsZS5leHBvcnRzID0gXzsKICAgIH0KICAgIGV4cG9ydHMuXyA9IF87CiAgfSBlbHNlIHsKICAgIHJvb3QuXyA9IF87CiAgfQogIC8vIEN1cnJlbnQgdmVyc2lvbi4KICBfLlZFUlNJT04gPSAnMS42LjAnOwogIC8vIENvbGxlY3Rpb24gRnVuY3Rpb25zCiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAvLyBUaGUgY29ybmVyc3RvbmUsIGFuIGBlYWNoYCBpbXBsZW1lbnRhdGlvbiwgYWthIGBmb3JFYWNoYC4KICAvLyBIYW5kbGVzIG9iamVjdHMgd2l0aCB0aGUgYnVpbHQtaW4gYGZvckVhY2hgLCBhcnJheXMsIGFuZCByYXcgb2JqZWN0cy4KICAvLyBEZWxlZ2F0ZXMgdG8gKipFQ01BU2NyaXB0IDUqKidzIG5hdGl2ZSBgZm9yRWFjaGAgaWYgYXZhaWxhYmxlLgogIHZhciBlYWNoID0gXy5lYWNoID0gXy5mb3JFYWNoID0gZnVuY3Rpb24gKG9iaiwgaXRlcmF0b3IsIGNvbnRleHQpIHsKICAgIGlmIChvYmogPT0gbnVsbCkKICAgICAgcmV0dXJuIG9iajsKICAgIGlmIChuYXRpdmVGb3JFYWNoICYmIG9iai5mb3JFYWNoID09PSBuYXRpdmVGb3JFYWNoKSB7CiAgICAgIG9iai5mb3JFYWNoKGl0ZXJhdG9yLCBjb250ZXh0KTsKICAgIH0gZWxzZSBpZiAob2JqLmxlbmd0aCA9PT0gK29iai5sZW5ndGgpIHsKICAgICAgZm9yICh2YXIgaSA9IDAsIGxlbmd0aCA9IG9iai5sZW5ndGg7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgIGlmIChpdGVyYXRvci5jYWxsKGNvbnRleHQsIG9ialtpXSwgaSwgb2JqKSA9PT0gYnJlYWtlcikKICAgICAgICAgIHJldHVybjsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgdmFyIGtleXMgPSBfLmtleXMob2JqKTsKICAgICAgZm9yICh2YXIgaSA9IDAsIGxlbmd0aCA9IGtleXMubGVuZ3RoOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICBpZiAoaXRlcmF0b3IuY2FsbChjb250ZXh0LCBvYmpba2V5c1tpXV0sIGtleXNbaV0sIG9iaikgPT09IGJyZWFrZXIpCiAgICAgICAgICByZXR1cm47CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBvYmo7CiAgfTsKICAvLyBSZXR1cm4gdGhlIHJlc3VsdHMgb2YgYXBwbHlpbmcgdGhlIGl0ZXJhdG9yIHRvIGVhY2ggZWxlbWVudC4KICAvLyBEZWxlZ2F0ZXMgdG8gKipFQ01BU2NyaXB0IDUqKidzIG5hdGl2ZSBgbWFwYCBpZiBhdmFpbGFibGUuCiAgXy5tYXAgPSBfLmNvbGxlY3QgPSBmdW5jdGlvbiAob2JqLCBpdGVyYXRvciwgY29udGV4dCkgewogICAgdmFyIHJlc3VsdHMgPSBbXTsKICAgIGlmIChvYmogPT0gbnVsbCkKICAgICAgcmV0dXJuIHJlc3VsdHM7CiAgICBpZiAobmF0aXZlTWFwICYmIG9iai5tYXAgPT09IG5hdGl2ZU1hcCkKICAgICAgcmV0dXJuIG9iai5tYXAoaXRlcmF0b3IsIGNvbnRleHQpOwogICAgZWFjaChvYmosIGZ1bmN0aW9uICh2YWx1ZSwgaW5kZXgsIGxpc3QpIHsKICAgICAgcmVzdWx0cy5wdXNoKGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgdmFsdWUsIGluZGV4LCBsaXN0KSk7CiAgICB9KTsKICAgIHJldHVybiByZXN1bHRzOwogIH07CiAgdmFyIHJlZHVjZUVycm9yID0gJ1JlZHVjZSBvZiBlbXB0eSBhcnJheSB3aXRoIG5vIGluaXRpYWwgdmFsdWUnOwogIC8vICoqUmVkdWNlKiogYnVpbGRzIHVwIGEgc2luZ2xlIHJlc3VsdCBmcm9tIGEgbGlzdCBvZiB2YWx1ZXMsIGFrYSBgaW5qZWN0YCwKICAvLyBvciBgZm9sZGxgLiBEZWxlZ2F0ZXMgdG8gKipFQ01BU2NyaXB0IDUqKidzIG5hdGl2ZSBgcmVkdWNlYCBpZiBhdmFpbGFibGUuCiAgXy5yZWR1Y2UgPSBfLmZvbGRsID0gXy5pbmplY3QgPSBmdW5jdGlvbiAob2JqLCBpdGVyYXRvciwgbWVtbywgY29udGV4dCkgewogICAgdmFyIGluaXRpYWwgPSBhcmd1bWVudHMubGVuZ3RoID4gMjsKICAgIGlmIChvYmogPT0gbnVsbCkKICAgICAgb2JqID0gW107CiAgICBpZiAobmF0aXZlUmVkdWNlICYmIG9iai5yZWR1Y2UgPT09IG5hdGl2ZVJlZHVjZSkgewogICAgICBpZiAoY29udGV4dCkKICAgICAgICBpdGVyYXRvciA9IF8uYmluZChpdGVyYXRvciwgY29udGV4dCk7CiAgICAgIHJldHVybiBpbml0aWFsID8gb2JqLnJlZHVjZShpdGVyYXRvciwgbWVtbykgOiBvYmoucmVkdWNlKGl0ZXJhdG9yKTsKICAgIH0KICAgIGVhY2gob2JqLCBmdW5jdGlvbiAodmFsdWUsIGluZGV4LCBsaXN0KSB7CiAgICAgIGlmICghaW5pdGlhbCkgewogICAgICAgIG1lbW8gPSB2YWx1ZTsKICAgICAgICBpbml0aWFsID0gdHJ1ZTsKICAgICAgfSBlbHNlIHsKICAgICAgICBtZW1vID0gaXRlcmF0b3IuY2FsbChjb250ZXh0LCBtZW1vLCB2YWx1ZSwgaW5kZXgsIGxpc3QpOwogICAgICB9CiAgICB9KTsKICAgIGlmICghaW5pdGlhbCkKICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihyZWR1Y2VFcnJvcik7CiAgICByZXR1cm4gbWVtbzsKICB9OwogIC8vIFRoZSByaWdodC1hc3NvY2lhdGl2ZSB2ZXJzaW9uIG9mIHJlZHVjZSwgYWxzbyBrbm93biBhcyBgZm9sZHJgLgogIC8vIERlbGVnYXRlcyB0byAqKkVDTUFTY3JpcHQgNSoqJ3MgbmF0aXZlIGByZWR1Y2VSaWdodGAgaWYgYXZhaWxhYmxlLgogIF8ucmVkdWNlUmlnaHQgPSBfLmZvbGRyID0gZnVuY3Rpb24gKG9iaiwgaXRlcmF0b3IsIG1lbW8sIGNvbnRleHQpIHsKICAgIHZhciBpbml0aWFsID0gYXJndW1lbnRzLmxlbmd0aCA+IDI7CiAgICBpZiAob2JqID09IG51bGwpCiAgICAgIG9iaiA9IFtdOwogICAgaWYgKG5hdGl2ZVJlZHVjZVJpZ2h0ICYmIG9iai5yZWR1Y2VSaWdodCA9PT0gbmF0aXZlUmVkdWNlUmlnaHQpIHsKICAgICAgaWYgKGNvbnRleHQpCiAgICAgICAgaXRlcmF0b3IgPSBfLmJpbmQoaXRlcmF0b3IsIGNvbnRleHQpOwogICAgICByZXR1cm4gaW5pdGlhbCA/IG9iai5yZWR1Y2VSaWdodChpdGVyYXRvciwgbWVtbykgOiBvYmoucmVkdWNlUmlnaHQoaXRlcmF0b3IpOwogICAgfQogICAgdmFyIGxlbmd0aCA9IG9iai5sZW5ndGg7CiAgICBpZiAobGVuZ3RoICE9PSArbGVuZ3RoKSB7CiAgICAgIHZhciBrZXlzID0gXy5rZXlzKG9iaik7CiAgICAgIGxlbmd0aCA9IGtleXMubGVuZ3RoOwogICAgfQogICAgZWFjaChvYmosIGZ1bmN0aW9uICh2YWx1ZSwgaW5kZXgsIGxpc3QpIHsKICAgICAgaW5kZXggPSBrZXlzID8ga2V5c1stLWxlbmd0aF0gOiAtLWxlbmd0aDsKICAgICAgaWYgKCFpbml0aWFsKSB7CiAgICAgICAgbWVtbyA9IG9ialtpbmRleF07CiAgICAgICAgaW5pdGlhbCA9IHRydWU7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgbWVtbyA9IGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgbWVtbywgb2JqW2luZGV4XSwgaW5kZXgsIGxpc3QpOwogICAgICB9CiAgICB9KTsKICAgIGlmICghaW5pdGlhbCkKICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihyZWR1Y2VFcnJvcik7CiAgICByZXR1cm4gbWVtbzsKICB9OwogIC8vIFJldHVybiB0aGUgZmlyc3QgdmFsdWUgd2hpY2ggcGFzc2VzIGEgdHJ1dGggdGVzdC4gQWxpYXNlZCBhcyBgZGV0ZWN0YC4KICBfLmZpbmQgPSBfLmRldGVjdCA9IGZ1bmN0aW9uIChvYmosIHByZWRpY2F0ZSwgY29udGV4dCkgewogICAgdmFyIHJlc3VsdDsKICAgIGFueShvYmosIGZ1bmN0aW9uICh2YWx1ZSwgaW5kZXgsIGxpc3QpIHsKICAgICAgaWYgKHByZWRpY2F0ZS5jYWxsKGNvbnRleHQsIHZhbHVlLCBpbmRleCwgbGlzdCkpIHsKICAgICAgICByZXN1bHQgPSB2YWx1ZTsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgfSk7CiAgICByZXR1cm4gcmVzdWx0OwogIH07CiAgLy8gUmV0dXJuIGFsbCB0aGUgZWxlbWVudHMgdGhhdCBwYXNzIGEgdHJ1dGggdGVzdC4KICAvLyBEZWxlZ2F0ZXMgdG8gKipFQ01BU2NyaXB0IDUqKidzIG5hdGl2ZSBgZmlsdGVyYCBpZiBhdmFpbGFibGUuCiAgLy8gQWxpYXNlZCBhcyBgc2VsZWN0YC4KICBfLmZpbHRlciA9IF8uc2VsZWN0ID0gZnVuY3Rpb24gKG9iaiwgcHJlZGljYXRlLCBjb250ZXh0KSB7CiAgICB2YXIgcmVzdWx0cyA9IFtdOwogICAgaWYgKG9iaiA9PSBudWxsKQogICAgICByZXR1cm4gcmVzdWx0czsKICAgIGlmIChuYXRpdmVGaWx0ZXIgJiYgb2JqLmZpbHRlciA9PT0gbmF0aXZlRmlsdGVyKQogICAgICByZXR1cm4gb2JqLmZpbHRlcihwcmVkaWNhdGUsIGNvbnRleHQpOwogICAgZWFjaChvYmosIGZ1bmN0aW9uICh2YWx1ZSwgaW5kZXgsIGxpc3QpIHsKICAgICAgaWYgKHByZWRpY2F0ZS5jYWxsKGNvbnRleHQsIHZhbHVlLCBpbmRleCwgbGlzdCkpCiAgICAgICAgcmVzdWx0cy5wdXNoKHZhbHVlKTsKICAgIH0pOwogICAgcmV0dXJuIHJlc3VsdHM7CiAgfTsKICAvLyBSZXR1cm4gYWxsIHRoZSBlbGVtZW50cyBmb3Igd2hpY2ggYSB0cnV0aCB0ZXN0IGZhaWxzLgogIF8ucmVqZWN0ID0gZnVuY3Rpb24gKG9iaiwgcHJlZGljYXRlLCBjb250ZXh0KSB7CiAgICByZXR1cm4gXy5maWx0ZXIob2JqLCBmdW5jdGlvbiAodmFsdWUsIGluZGV4LCBsaXN0KSB7CiAgICAgIHJldHVybiAhcHJlZGljYXRlLmNhbGwoY29udGV4dCwgdmFsdWUsIGluZGV4LCBsaXN0KTsKICAgIH0sIGNvbnRleHQpOwogIH07CiAgLy8gRGV0ZXJtaW5lIHdoZXRoZXIgYWxsIG9mIHRoZSBlbGVtZW50cyBtYXRjaCBhIHRydXRoIHRlc3QuCiAgLy8gRGVsZWdhdGVzIHRvICoqRUNNQVNjcmlwdCA1KioncyBuYXRpdmUgYGV2ZXJ5YCBpZiBhdmFpbGFibGUuCiAgLy8gQWxpYXNlZCBhcyBgYWxsYC4KICBfLmV2ZXJ5ID0gXy5hbGwgPSBmdW5jdGlvbiAob2JqLCBwcmVkaWNhdGUsIGNvbnRleHQpIHsKICAgIHByZWRpY2F0ZSB8fCAocHJlZGljYXRlID0gXy5pZGVudGl0eSk7CiAgICB2YXIgcmVzdWx0ID0gdHJ1ZTsKICAgIGlmIChvYmogPT0gbnVsbCkKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIGlmIChuYXRpdmVFdmVyeSAmJiBvYmouZXZlcnkgPT09IG5hdGl2ZUV2ZXJ5KQogICAgICByZXR1cm4gb2JqLmV2ZXJ5KHByZWRpY2F0ZSwgY29udGV4dCk7CiAgICBlYWNoKG9iaiwgZnVuY3Rpb24gKHZhbHVlLCBpbmRleCwgbGlzdCkgewogICAgICBpZiAoIShyZXN1bHQgPSByZXN1bHQgJiYgcHJlZGljYXRlLmNhbGwoY29udGV4dCwgdmFsdWUsIGluZGV4LCBsaXN0KSkpCiAgICAgICAgcmV0dXJuIGJyZWFrZXI7CiAgICB9KTsKICAgIHJldHVybiAhIXJlc3VsdDsKICB9OwogIC8vIERldGVybWluZSBpZiBhdCBsZWFzdCBvbmUgZWxlbWVudCBpbiB0aGUgb2JqZWN0IG1hdGNoZXMgYSB0cnV0aCB0ZXN0LgogIC8vIERlbGVnYXRlcyB0byAqKkVDTUFTY3JpcHQgNSoqJ3MgbmF0aXZlIGBzb21lYCBpZiBhdmFpbGFibGUuCiAgLy8gQWxpYXNlZCBhcyBgYW55YC4KICB2YXIgYW55ID0gXy5zb21lID0gXy5hbnkgPSBmdW5jdGlvbiAob2JqLCBwcmVkaWNhdGUsIGNvbnRleHQpIHsKICAgIHByZWRpY2F0ZSB8fCAocHJlZGljYXRlID0gXy5pZGVudGl0eSk7CiAgICB2YXIgcmVzdWx0ID0gZmFsc2U7CiAgICBpZiAob2JqID09IG51bGwpCiAgICAgIHJldHVybiByZXN1bHQ7CiAgICBpZiAobmF0aXZlU29tZSAmJiBvYmouc29tZSA9PT0gbmF0aXZlU29tZSkKICAgICAgcmV0dXJuIG9iai5zb21lKHByZWRpY2F0ZSwgY29udGV4dCk7CiAgICBlYWNoKG9iaiwgZnVuY3Rpb24gKHZhbHVlLCBpbmRleCwgbGlzdCkgewogICAgICBpZiAocmVzdWx0IHx8IChyZXN1bHQgPSBwcmVkaWNhdGUuY2FsbChjb250ZXh0LCB2YWx1ZSwgaW5kZXgsIGxpc3QpKSkKICAgICAgICByZXR1cm4gYnJlYWtlcjsKICAgIH0pOwogICAgcmV0dXJuICEhcmVzdWx0OwogIH07CiAgLy8gRGV0ZXJtaW5lIGlmIHRoZSBhcnJheSBvciBvYmplY3QgY29udGFpbnMgYSBnaXZlbiB2YWx1ZSAodXNpbmcgYD09PWApLgogIC8vIEFsaWFzZWQgYXMgYGluY2x1ZGVgLgogIF8uY29udGFpbnMgPSBfLmluY2x1ZGUgPSBmdW5jdGlvbiAob2JqLCB0YXJnZXQpIHsKICAgIGlmIChvYmogPT0gbnVsbCkKICAgICAgcmV0dXJuIGZhbHNlOwogICAgaWYgKG5hdGl2ZUluZGV4T2YgJiYgb2JqLmluZGV4T2YgPT09IG5hdGl2ZUluZGV4T2YpCiAgICAgIHJldHVybiBvYmouaW5kZXhPZih0YXJnZXQpICE9IC0xOwogICAgcmV0dXJuIGFueShvYmosIGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICByZXR1cm4gdmFsdWUgPT09IHRhcmdldDsKICAgIH0pOwogIH07CiAgLy8gSW52b2tlIGEgbWV0aG9kICh3aXRoIGFyZ3VtZW50cykgb24gZXZlcnkgaXRlbSBpbiBhIGNvbGxlY3Rpb24uCiAgXy5pbnZva2UgPSBmdW5jdGlvbiAob2JqLCBtZXRob2QpIHsKICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDIpOwogICAgdmFyIGlzRnVuYyA9IF8uaXNGdW5jdGlvbihtZXRob2QpOwogICAgcmV0dXJuIF8ubWFwKG9iaiwgZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgIHJldHVybiAoaXNGdW5jID8gbWV0aG9kIDogdmFsdWVbbWV0aG9kXSkuYXBwbHkodmFsdWUsIGFyZ3MpOwogICAgfSk7CiAgfTsKICAvLyBDb252ZW5pZW5jZSB2ZXJzaW9uIG9mIGEgY29tbW9uIHVzZSBjYXNlIG9mIGBtYXBgOiBmZXRjaGluZyBhIHByb3BlcnR5LgogIF8ucGx1Y2sgPSBmdW5jdGlvbiAob2JqLCBrZXkpIHsKICAgIHJldHVybiBfLm1hcChvYmosIF8ucHJvcGVydHkoa2V5KSk7CiAgfTsKICAvLyBDb252ZW5pZW5jZSB2ZXJzaW9uIG9mIGEgY29tbW9uIHVzZSBjYXNlIG9mIGBmaWx0ZXJgOiBzZWxlY3Rpbmcgb25seSBvYmplY3RzCiAgLy8gY29udGFpbmluZyBzcGVjaWZpYyBga2V5OnZhbHVlYCBwYWlycy4KICBfLndoZXJlID0gZnVuY3Rpb24gKG9iaiwgYXR0cnMpIHsKICAgIHJldHVybiBfLmZpbHRlcihvYmosIF8ubWF0Y2hlcyhhdHRycykpOwogIH07CiAgLy8gQ29udmVuaWVuY2UgdmVyc2lvbiBvZiBhIGNvbW1vbiB1c2UgY2FzZSBvZiBgZmluZGA6IGdldHRpbmcgdGhlIGZpcnN0IG9iamVjdAogIC8vIGNvbnRhaW5pbmcgc3BlY2lmaWMgYGtleTp2YWx1ZWAgcGFpcnMuCiAgXy5maW5kV2hlcmUgPSBmdW5jdGlvbiAob2JqLCBhdHRycykgewogICAgcmV0dXJuIF8uZmluZChvYmosIF8ubWF0Y2hlcyhhdHRycykpOwogIH07CiAgLy8gUmV0dXJuIHRoZSBtYXhpbXVtIGVsZW1lbnQgb3IgKGVsZW1lbnQtYmFzZWQgY29tcHV0YXRpb24pLgogIC8vIENhbid0IG9wdGltaXplIGFycmF5cyBvZiBpbnRlZ2VycyBsb25nZXIgdGhhbiA2NSw1MzUgZWxlbWVudHMuCiAgLy8gU2VlIFtXZWJLaXQgQnVnIDgwNzk3XShodHRwczovL2J1Z3Mud2Via2l0Lm9yZy9zaG93X2J1Zy5jZ2k/aWQ9ODA3OTcpCiAgXy5tYXggPSBmdW5jdGlvbiAob2JqLCBpdGVyYXRvciwgY29udGV4dCkgewogICAgaWYgKCFpdGVyYXRvciAmJiBfLmlzQXJyYXkob2JqKSAmJiBvYmpbMF0gPT09ICtvYmpbMF0gJiYgb2JqLmxlbmd0aCA8IDY1NTM1KSB7CiAgICAgIHJldHVybiBNYXRoLm1heC5hcHBseShNYXRoLCBvYmopOwogICAgfQogICAgdmFyIHJlc3VsdCA9IC1JbmZpbml0eSwgbGFzdENvbXB1dGVkID0gLUluZmluaXR5OwogICAgZWFjaChvYmosIGZ1bmN0aW9uICh2YWx1ZSwgaW5kZXgsIGxpc3QpIHsKICAgICAgdmFyIGNvbXB1dGVkID0gaXRlcmF0b3IgPyBpdGVyYXRvci5jYWxsKGNvbnRleHQsIHZhbHVlLCBpbmRleCwgbGlzdCkgOiB2YWx1ZTsKICAgICAgaWYgKGNvbXB1dGVkID4gbGFzdENvbXB1dGVkKSB7CiAgICAgICAgcmVzdWx0ID0gdmFsdWU7CiAgICAgICAgbGFzdENvbXB1dGVkID0gY29tcHV0ZWQ7CiAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuIHJlc3VsdDsKICB9OwogIC8vIFJldHVybiB0aGUgbWluaW11bSBlbGVtZW50IChvciBlbGVtZW50LWJhc2VkIGNvbXB1dGF0aW9uKS4KICBfLm1pbiA9IGZ1bmN0aW9uIChvYmosIGl0ZXJhdG9yLCBjb250ZXh0KSB7CiAgICBpZiAoIWl0ZXJhdG9yICYmIF8uaXNBcnJheShvYmopICYmIG9ialswXSA9PT0gK29ialswXSAmJiBvYmoubGVuZ3RoIDwgNjU1MzUpIHsKICAgICAgcmV0dXJuIE1hdGgubWluLmFwcGx5KE1hdGgsIG9iaik7CiAgICB9CiAgICB2YXIgcmVzdWx0ID0gSW5maW5pdHksIGxhc3RDb21wdXRlZCA9IEluZmluaXR5OwogICAgZWFjaChvYmosIGZ1bmN0aW9uICh2YWx1ZSwgaW5kZXgsIGxpc3QpIHsKICAgICAgdmFyIGNvbXB1dGVkID0gaXRlcmF0b3IgPyBpdGVyYXRvci5jYWxsKGNvbnRleHQsIHZhbHVlLCBpbmRleCwgbGlzdCkgOiB2YWx1ZTsKICAgICAgaWYgKGNvbXB1dGVkIDwgbGFzdENvbXB1dGVkKSB7CiAgICAgICAgcmVzdWx0ID0gdmFsdWU7CiAgICAgICAgbGFzdENvbXB1dGVkID0gY29tcHV0ZWQ7CiAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuIHJlc3VsdDsKICB9OwogIC8vIFNodWZmbGUgYW4gYXJyYXksIHVzaW5nIHRoZSBtb2Rlcm4gdmVyc2lvbiBvZiB0aGUKICAvLyBbRmlzaGVyLVlhdGVzIHNodWZmbGVdKGh0dHA6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvRmlzaGVy4oCTWWF0ZXNfc2h1ZmZsZSkuCiAgXy5zaHVmZmxlID0gZnVuY3Rpb24gKG9iaikgewogICAgdmFyIHJhbmQ7CiAgICB2YXIgaW5kZXggPSAwOwogICAgdmFyIHNodWZmbGVkID0gW107CiAgICBlYWNoKG9iaiwgZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgIHJhbmQgPSBfLnJhbmRvbShpbmRleCsrKTsKICAgICAgc2h1ZmZsZWRbaW5kZXggLSAxXSA9IHNodWZmbGVkW3JhbmRdOwogICAgICBzaHVmZmxlZFtyYW5kXSA9IHZhbHVlOwogICAgfSk7CiAgICByZXR1cm4gc2h1ZmZsZWQ7CiAgfTsKICAvLyBTYW1wbGUgKipuKiogcmFuZG9tIHZhbHVlcyBmcm9tIGEgY29sbGVjdGlvbi4KICAvLyBJZiAqKm4qKiBpcyBub3Qgc3BlY2lmaWVkLCByZXR1cm5zIGEgc2luZ2xlIHJhbmRvbSBlbGVtZW50LgogIC8vIFRoZSBpbnRlcm5hbCBgZ3VhcmRgIGFyZ3VtZW50IGFsbG93cyBpdCB0byB3b3JrIHdpdGggYG1hcGAuCiAgXy5zYW1wbGUgPSBmdW5jdGlvbiAob2JqLCBuLCBndWFyZCkgewogICAgaWYgKG4gPT0gbnVsbCB8fCBndWFyZCkgewogICAgICBpZiAob2JqLmxlbmd0aCAhPT0gK29iai5sZW5ndGgpCiAgICAgICAgb2JqID0gXy52YWx1ZXMob2JqKTsKICAgICAgcmV0dXJuIG9ialtfLnJhbmRvbShvYmoubGVuZ3RoIC0gMSldOwogICAgfQogICAgcmV0dXJuIF8uc2h1ZmZsZShvYmopLnNsaWNlKDAsIE1hdGgubWF4KDAsIG4pKTsKICB9OwogIC8vIEFuIGludGVybmFsIGZ1bmN0aW9uIHRvIGdlbmVyYXRlIGxvb2t1cCBpdGVyYXRvcnMuCiAgdmFyIGxvb2t1cEl0ZXJhdG9yID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgICBpZiAodmFsdWUgPT0gbnVsbCkKICAgICAgcmV0dXJuIF8uaWRlbnRpdHk7CiAgICBpZiAoXy5pc0Z1bmN0aW9uKHZhbHVlKSkKICAgICAgcmV0dXJuIHZhbHVlOwogICAgcmV0dXJuIF8ucHJvcGVydHkodmFsdWUpOwogIH07CiAgLy8gU29ydCB0aGUgb2JqZWN0J3MgdmFsdWVzIGJ5IGEgY3JpdGVyaW9uIHByb2R1Y2VkIGJ5IGFuIGl0ZXJhdG9yLgogIF8uc29ydEJ5ID0gZnVuY3Rpb24gKG9iaiwgaXRlcmF0b3IsIGNvbnRleHQpIHsKICAgIGl0ZXJhdG9yID0gbG9va3VwSXRlcmF0b3IoaXRlcmF0b3IpOwogICAgcmV0dXJuIF8ucGx1Y2soXy5tYXAob2JqLCBmdW5jdGlvbiAodmFsdWUsIGluZGV4LCBsaXN0KSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgdmFsdWU6IHZhbHVlLAogICAgICAgIGluZGV4OiBpbmRleCwKICAgICAgICBjcml0ZXJpYTogaXRlcmF0b3IuY2FsbChjb250ZXh0LCB2YWx1ZSwgaW5kZXgsIGxpc3QpCiAgICAgIH07CiAgICB9KS5zb3J0KGZ1bmN0aW9uIChsZWZ0LCByaWdodCkgewogICAgICB2YXIgYSA9IGxlZnQuY3JpdGVyaWE7CiAgICAgIHZhciBiID0gcmlnaHQuY3JpdGVyaWE7CiAgICAgIGlmIChhICE9PSBiKSB7CiAgICAgICAgaWYgKGEgPiBiIHx8IGEgPT09IHZvaWQgMCkKICAgICAgICAgIHJldHVybiAxOwogICAgICAgIGlmIChhIDwgYiB8fCBiID09PSB2b2lkIDApCiAgICAgICAgICByZXR1cm4gLTE7CiAgICAgIH0KICAgICAgcmV0dXJuIGxlZnQuaW5kZXggLSByaWdodC5pbmRleDsKICAgIH0pLCAndmFsdWUnKTsKICB9OwogIC8vIEFuIGludGVybmFsIGZ1bmN0aW9uIHVzZWQgZm9yIGFnZ3JlZ2F0ZSAiZ3JvdXAgYnkiIG9wZXJhdGlvbnMuCiAgdmFyIGdyb3VwID0gZnVuY3Rpb24gKGJlaGF2aW9yKSB7CiAgICByZXR1cm4gZnVuY3Rpb24gKG9iaiwgaXRlcmF0b3IsIGNvbnRleHQpIHsKICAgICAgdmFyIHJlc3VsdCA9IHt9OwogICAgICBpdGVyYXRvciA9IGxvb2t1cEl0ZXJhdG9yKGl0ZXJhdG9yKTsKICAgICAgZWFjaChvYmosIGZ1bmN0aW9uICh2YWx1ZSwgaW5kZXgpIHsKICAgICAgICB2YXIga2V5ID0gaXRlcmF0b3IuY2FsbChjb250ZXh0LCB2YWx1ZSwgaW5kZXgsIG9iaik7CiAgICAgICAgYmVoYXZpb3IocmVzdWx0LCBrZXksIHZhbHVlKTsKICAgICAgfSk7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9OwogIH07CiAgLy8gR3JvdXBzIHRoZSBvYmplY3QncyB2YWx1ZXMgYnkgYSBjcml0ZXJpb24uIFBhc3MgZWl0aGVyIGEgc3RyaW5nIGF0dHJpYnV0ZQogIC8vIHRvIGdyb3VwIGJ5LCBvciBhIGZ1bmN0aW9uIHRoYXQgcmV0dXJucyB0aGUgY3JpdGVyaW9uLgogIF8uZ3JvdXBCeSA9IGdyb3VwKGZ1bmN0aW9uIChyZXN1bHQsIGtleSwgdmFsdWUpIHsKICAgIF8uaGFzKHJlc3VsdCwga2V5KSA/IHJlc3VsdFtrZXldLnB1c2godmFsdWUpIDogcmVzdWx0W2tleV0gPSBbdmFsdWVdOwogIH0pOwogIC8vIEluZGV4ZXMgdGhlIG9iamVjdCdzIHZhbHVlcyBieSBhIGNyaXRlcmlvbiwgc2ltaWxhciB0byBgZ3JvdXBCeWAsIGJ1dCBmb3IKICAvLyB3aGVuIHlvdSBrbm93IHRoYXQgeW91ciBpbmRleCB2YWx1ZXMgd2lsbCBiZSB1bmlxdWUuCiAgXy5pbmRleEJ5ID0gZ3JvdXAoZnVuY3Rpb24gKHJlc3VsdCwga2V5LCB2YWx1ZSkgewogICAgcmVzdWx0W2tleV0gPSB2YWx1ZTsKICB9KTsKICAvLyBDb3VudHMgaW5zdGFuY2VzIG9mIGFuIG9iamVjdCB0aGF0IGdyb3VwIGJ5IGEgY2VydGFpbiBjcml0ZXJpb24uIFBhc3MKICAvLyBlaXRoZXIgYSBzdHJpbmcgYXR0cmlidXRlIHRvIGNvdW50IGJ5LCBvciBhIGZ1bmN0aW9uIHRoYXQgcmV0dXJucyB0aGUKICAvLyBjcml0ZXJpb24uCiAgXy5jb3VudEJ5ID0gZ3JvdXAoZnVuY3Rpb24gKHJlc3VsdCwga2V5KSB7CiAgICBfLmhhcyhyZXN1bHQsIGtleSkgPyByZXN1bHRba2V5XSsrIDogcmVzdWx0W2tleV0gPSAxOwogIH0pOwogIC8vIFVzZSBhIGNvbXBhcmF0b3IgZnVuY3Rpb24gdG8gZmlndXJlIG91dCB0aGUgc21hbGxlc3QgaW5kZXggYXQgd2hpY2gKICAvLyBhbiBvYmplY3Qgc2hvdWxkIGJlIGluc2VydGVkIHNvIGFzIHRvIG1haW50YWluIG9yZGVyLiBVc2VzIGJpbmFyeSBzZWFyY2guCiAgXy5zb3J0ZWRJbmRleCA9IGZ1bmN0aW9uIChhcnJheSwgb2JqLCBpdGVyYXRvciwgY29udGV4dCkgewogICAgaXRlcmF0b3IgPSBsb29rdXBJdGVyYXRvcihpdGVyYXRvcik7CiAgICB2YXIgdmFsdWUgPSBpdGVyYXRvci5jYWxsKGNvbnRleHQsIG9iaik7CiAgICB2YXIgbG93ID0gMCwgaGlnaCA9IGFycmF5Lmxlbmd0aDsKICAgIHdoaWxlIChsb3cgPCBoaWdoKSB7CiAgICAgIHZhciBtaWQgPSBsb3cgKyBoaWdoID4+PiAxOwogICAgICBpdGVyYXRvci5jYWxsKGNvbnRleHQsIGFycmF5W21pZF0pIDwgdmFsdWUgPyBsb3cgPSBtaWQgKyAxIDogaGlnaCA9IG1pZDsKICAgIH0KICAgIHJldHVybiBsb3c7CiAgfTsKICAvLyBTYWZlbHkgY3JlYXRlIGEgcmVhbCwgbGl2ZSBhcnJheSBmcm9tIGFueXRoaW5nIGl0ZXJhYmxlLgogIF8udG9BcnJheSA9IGZ1bmN0aW9uIChvYmopIHsKICAgIGlmICghb2JqKQogICAgICByZXR1cm4gW107CiAgICBpZiAoXy5pc0FycmF5KG9iaikpCiAgICAgIHJldHVybiBzbGljZS5jYWxsKG9iaik7CiAgICBpZiAob2JqLmxlbmd0aCA9PT0gK29iai5sZW5ndGgpCiAgICAgIHJldHVybiBfLm1hcChvYmosIF8uaWRlbnRpdHkpOwogICAgcmV0dXJuIF8udmFsdWVzKG9iaik7CiAgfTsKICAvLyBSZXR1cm4gdGhlIG51bWJlciBvZiBlbGVtZW50cyBpbiBhbiBvYmplY3QuCiAgXy5zaXplID0gZnVuY3Rpb24gKG9iaikgewogICAgaWYgKG9iaiA9PSBudWxsKQogICAgICByZXR1cm4gMDsKICAgIHJldHVybiBvYmoubGVuZ3RoID09PSArb2JqLmxlbmd0aCA/IG9iai5sZW5ndGggOiBfLmtleXMob2JqKS5sZW5ndGg7CiAgfTsKICAvLyBBcnJheSBGdW5jdGlvbnMKICAvLyAtLS0tLS0tLS0tLS0tLS0KICAvLyBHZXQgdGhlIGZpcnN0IGVsZW1lbnQgb2YgYW4gYXJyYXkuIFBhc3NpbmcgKipuKiogd2lsbCByZXR1cm4gdGhlIGZpcnN0IE4KICAvLyB2YWx1ZXMgaW4gdGhlIGFycmF5LiBBbGlhc2VkIGFzIGBoZWFkYCBhbmQgYHRha2VgLiBUaGUgKipndWFyZCoqIGNoZWNrCiAgLy8gYWxsb3dzIGl0IHRvIHdvcmsgd2l0aCBgXy5tYXBgLgogIF8uZmlyc3QgPSBfLmhlYWQgPSBfLnRha2UgPSBmdW5jdGlvbiAoYXJyYXksIG4sIGd1YXJkKSB7CiAgICBpZiAoYXJyYXkgPT0gbnVsbCkKICAgICAgcmV0dXJuIHZvaWQgMDsKICAgIGlmIChuID09IG51bGwgfHwgZ3VhcmQpCiAgICAgIHJldHVybiBhcnJheVswXTsKICAgIGlmIChuIDwgMCkKICAgICAgcmV0dXJuIFtdOwogICAgcmV0dXJuIHNsaWNlLmNhbGwoYXJyYXksIDAsIG4pOwogIH07CiAgLy8gUmV0dXJucyBldmVyeXRoaW5nIGJ1dCB0aGUgbGFzdCBlbnRyeSBvZiB0aGUgYXJyYXkuIEVzcGVjaWFsbHkgdXNlZnVsIG9uCiAgLy8gdGhlIGFyZ3VtZW50cyBvYmplY3QuIFBhc3NpbmcgKipuKiogd2lsbCByZXR1cm4gYWxsIHRoZSB2YWx1ZXMgaW4KICAvLyB0aGUgYXJyYXksIGV4Y2x1ZGluZyB0aGUgbGFzdCBOLiBUaGUgKipndWFyZCoqIGNoZWNrIGFsbG93cyBpdCB0byB3b3JrIHdpdGgKICAvLyBgXy5tYXBgLgogIF8uaW5pdGlhbCA9IGZ1bmN0aW9uIChhcnJheSwgbiwgZ3VhcmQpIHsKICAgIHJldHVybiBzbGljZS5jYWxsKGFycmF5LCAwLCBhcnJheS5sZW5ndGggLSAobiA9PSBudWxsIHx8IGd1YXJkID8gMSA6IG4pKTsKICB9OwogIC8vIEdldCB0aGUgbGFzdCBlbGVtZW50IG9mIGFuIGFycmF5LiBQYXNzaW5nICoqbioqIHdpbGwgcmV0dXJuIHRoZSBsYXN0IE4KICAvLyB2YWx1ZXMgaW4gdGhlIGFycmF5LiBUaGUgKipndWFyZCoqIGNoZWNrIGFsbG93cyBpdCB0byB3b3JrIHdpdGggYF8ubWFwYC4KICBfLmxhc3QgPSBmdW5jdGlvbiAoYXJyYXksIG4sIGd1YXJkKSB7CiAgICBpZiAoYXJyYXkgPT0gbnVsbCkKICAgICAgcmV0dXJuIHZvaWQgMDsKICAgIGlmIChuID09IG51bGwgfHwgZ3VhcmQpCiAgICAgIHJldHVybiBhcnJheVthcnJheS5sZW5ndGggLSAxXTsKICAgIHJldHVybiBzbGljZS5jYWxsKGFycmF5LCBNYXRoLm1heChhcnJheS5sZW5ndGggLSBuLCAwKSk7CiAgfTsKICAvLyBSZXR1cm5zIGV2ZXJ5dGhpbmcgYnV0IHRoZSBmaXJzdCBlbnRyeSBvZiB0aGUgYXJyYXkuIEFsaWFzZWQgYXMgYHRhaWxgIGFuZCBgZHJvcGAuCiAgLy8gRXNwZWNpYWxseSB1c2VmdWwgb24gdGhlIGFyZ3VtZW50cyBvYmplY3QuIFBhc3NpbmcgYW4gKipuKiogd2lsbCByZXR1cm4KICAvLyB0aGUgcmVzdCBOIHZhbHVlcyBpbiB0aGUgYXJyYXkuIFRoZSAqKmd1YXJkKioKICAvLyBjaGVjayBhbGxvd3MgaXQgdG8gd29yayB3aXRoIGBfLm1hcGAuCiAgXy5yZXN0ID0gXy50YWlsID0gXy5kcm9wID0gZnVuY3Rpb24gKGFycmF5LCBuLCBndWFyZCkgewogICAgcmV0dXJuIHNsaWNlLmNhbGwoYXJyYXksIG4gPT0gbnVsbCB8fCBndWFyZCA/IDEgOiBuKTsKICB9OwogIC8vIFRyaW0gb3V0IGFsbCBmYWxzeSB2YWx1ZXMgZnJvbSBhbiBhcnJheS4KICBfLmNvbXBhY3QgPSBmdW5jdGlvbiAoYXJyYXkpIHsKICAgIHJldHVybiBfLmZpbHRlcihhcnJheSwgXy5pZGVudGl0eSk7CiAgfTsKICAvLyBJbnRlcm5hbCBpbXBsZW1lbnRhdGlvbiBvZiBhIHJlY3Vyc2l2ZSBgZmxhdHRlbmAgZnVuY3Rpb24uCiAgdmFyIGZsYXR0ZW4gPSBmdW5jdGlvbiAoaW5wdXQsIHNoYWxsb3csIG91dHB1dCkgewogICAgaWYgKHNoYWxsb3cgJiYgXy5ldmVyeShpbnB1dCwgXy5pc0FycmF5KSkgewogICAgICByZXR1cm4gY29uY2F0LmFwcGx5KG91dHB1dCwgaW5wdXQpOwogICAgfQogICAgZWFjaChpbnB1dCwgZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgIGlmIChfLmlzQXJyYXkodmFsdWUpIHx8IF8uaXNBcmd1bWVudHModmFsdWUpKSB7CiAgICAgICAgc2hhbGxvdyA/IHB1c2guYXBwbHkob3V0cHV0LCB2YWx1ZSkgOiBmbGF0dGVuKHZhbHVlLCBzaGFsbG93LCBvdXRwdXQpOwogICAgICB9IGVsc2UgewogICAgICAgIG91dHB1dC5wdXNoKHZhbHVlKTsKICAgICAgfQogICAgfSk7CiAgICByZXR1cm4gb3V0cHV0OwogIH07CiAgLy8gRmxhdHRlbiBvdXQgYW4gYXJyYXksIGVpdGhlciByZWN1cnNpdmVseSAoYnkgZGVmYXVsdCksIG9yIGp1c3Qgb25lIGxldmVsLgogIF8uZmxhdHRlbiA9IGZ1bmN0aW9uIChhcnJheSwgc2hhbGxvdykgewogICAgcmV0dXJuIGZsYXR0ZW4oYXJyYXksIHNoYWxsb3csIFtdKTsKICB9OwogIC8vIFJldHVybiBhIHZlcnNpb24gb2YgdGhlIGFycmF5IHRoYXQgZG9lcyBub3QgY29udGFpbiB0aGUgc3BlY2lmaWVkIHZhbHVlKHMpLgogIF8ud2l0aG91dCA9IGZ1bmN0aW9uIChhcnJheSkgewogICAgcmV0dXJuIF8uZGlmZmVyZW5jZShhcnJheSwgc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpKTsKICB9OwogIC8vIFNwbGl0IGFuIGFycmF5IGludG8gdHdvIGFycmF5czogb25lIHdob3NlIGVsZW1lbnRzIGFsbCBzYXRpc2Z5IHRoZSBnaXZlbgogIC8vIHByZWRpY2F0ZSwgYW5kIG9uZSB3aG9zZSBlbGVtZW50cyBhbGwgZG8gbm90IHNhdGlzZnkgdGhlIHByZWRpY2F0ZS4KICBfLnBhcnRpdGlvbiA9IGZ1bmN0aW9uIChhcnJheSwgcHJlZGljYXRlKSB7CiAgICB2YXIgcGFzcyA9IFtdLCBmYWlsID0gW107CiAgICBlYWNoKGFycmF5LCBmdW5jdGlvbiAoZWxlbSkgewogICAgICAocHJlZGljYXRlKGVsZW0pID8gcGFzcyA6IGZhaWwpLnB1c2goZWxlbSk7CiAgICB9KTsKICAgIHJldHVybiBbCiAgICAgIHBhc3MsCiAgICAgIGZhaWwKICAgIF07CiAgfTsKICAvLyBQcm9kdWNlIGEgZHVwbGljYXRlLWZyZWUgdmVyc2lvbiBvZiB0aGUgYXJyYXkuIElmIHRoZSBhcnJheSBoYXMgYWxyZWFkeQogIC8vIGJlZW4gc29ydGVkLCB5b3UgaGF2ZSB0aGUgb3B0aW9uIG9mIHVzaW5nIGEgZmFzdGVyIGFsZ29yaXRobS4KICAvLyBBbGlhc2VkIGFzIGB1bmlxdWVgLgogIF8udW5pcSA9IF8udW5pcXVlID0gZnVuY3Rpb24gKGFycmF5LCBpc1NvcnRlZCwgaXRlcmF0b3IsIGNvbnRleHQpIHsKICAgIGlmIChfLmlzRnVuY3Rpb24oaXNTb3J0ZWQpKSB7CiAgICAgIGNvbnRleHQgPSBpdGVyYXRvcjsKICAgICAgaXRlcmF0b3IgPSBpc1NvcnRlZDsKICAgICAgaXNTb3J0ZWQgPSBmYWxzZTsKICAgIH0KICAgIHZhciBpbml0aWFsID0gaXRlcmF0b3IgPyBfLm1hcChhcnJheSwgaXRlcmF0b3IsIGNvbnRleHQpIDogYXJyYXk7CiAgICB2YXIgcmVzdWx0cyA9IFtdOwogICAgdmFyIHNlZW4gPSBbXTsKICAgIGVhY2goaW5pdGlhbCwgZnVuY3Rpb24gKHZhbHVlLCBpbmRleCkgewogICAgICBpZiAoaXNTb3J0ZWQgPyAhaW5kZXggfHwgc2VlbltzZWVuLmxlbmd0aCAtIDFdICE9PSB2YWx1ZSA6ICFfLmNvbnRhaW5zKHNlZW4sIHZhbHVlKSkgewogICAgICAgIHNlZW4ucHVzaCh2YWx1ZSk7CiAgICAgICAgcmVzdWx0cy5wdXNoKGFycmF5W2luZGV4XSk7CiAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuIHJlc3VsdHM7CiAgfTsKICAvLyBQcm9kdWNlIGFuIGFycmF5IHRoYXQgY29udGFpbnMgdGhlIHVuaW9uOiBlYWNoIGRpc3RpbmN0IGVsZW1lbnQgZnJvbSBhbGwgb2YKICAvLyB0aGUgcGFzc2VkLWluIGFycmF5cy4KICBfLnVuaW9uID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIF8udW5pcShfLmZsYXR0ZW4oYXJndW1lbnRzLCB0cnVlKSk7CiAgfTsKICAvLyBQcm9kdWNlIGFuIGFycmF5IHRoYXQgY29udGFpbnMgZXZlcnkgaXRlbSBzaGFyZWQgYmV0d2VlbiBhbGwgdGhlCiAgLy8gcGFzc2VkLWluIGFycmF5cy4KICBfLmludGVyc2VjdGlvbiA9IGZ1bmN0aW9uIChhcnJheSkgewogICAgdmFyIHJlc3QgPSBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CiAgICByZXR1cm4gXy5maWx0ZXIoXy51bmlxKGFycmF5KSwgZnVuY3Rpb24gKGl0ZW0pIHsKICAgICAgcmV0dXJuIF8uZXZlcnkocmVzdCwgZnVuY3Rpb24gKG90aGVyKSB7CiAgICAgICAgcmV0dXJuIF8uY29udGFpbnMob3RoZXIsIGl0ZW0pOwogICAgICB9KTsKICAgIH0pOwogIH07CiAgLy8gVGFrZSB0aGUgZGlmZmVyZW5jZSBiZXR3ZWVuIG9uZSBhcnJheSBhbmQgYSBudW1iZXIgb2Ygb3RoZXIgYXJyYXlzLgogIC8vIE9ubHkgdGhlIGVsZW1lbnRzIHByZXNlbnQgaW4ganVzdCB0aGUgZmlyc3QgYXJyYXkgd2lsbCByZW1haW4uCiAgXy5kaWZmZXJlbmNlID0gZnVuY3Rpb24gKGFycmF5KSB7CiAgICB2YXIgcmVzdCA9IGNvbmNhdC5hcHBseShBcnJheVByb3RvLCBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSkpOwogICAgcmV0dXJuIF8uZmlsdGVyKGFycmF5LCBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgcmV0dXJuICFfLmNvbnRhaW5zKHJlc3QsIHZhbHVlKTsKICAgIH0pOwogIH07CiAgLy8gWmlwIHRvZ2V0aGVyIG11bHRpcGxlIGxpc3RzIGludG8gYSBzaW5nbGUgYXJyYXkgLS0gZWxlbWVudHMgdGhhdCBzaGFyZQogIC8vIGFuIGluZGV4IGdvIHRvZ2V0aGVyLgogIF8uemlwID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGxlbmd0aCA9IF8ubWF4KF8ucGx1Y2soYXJndW1lbnRzLCAnbGVuZ3RoJykuY29uY2F0KDApKTsKICAgIHZhciByZXN1bHRzID0gbmV3IEFycmF5KGxlbmd0aCk7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgIHJlc3VsdHNbaV0gPSBfLnBsdWNrKGFyZ3VtZW50cywgJycgKyBpKTsKICAgIH0KICAgIHJldHVybiByZXN1bHRzOwogIH07CiAgLy8gQ29udmVydHMgbGlzdHMgaW50byBvYmplY3RzLiBQYXNzIGVpdGhlciBhIHNpbmdsZSBhcnJheSBvZiBgW2tleSwgdmFsdWVdYAogIC8vIHBhaXJzLCBvciB0d28gcGFyYWxsZWwgYXJyYXlzIG9mIHRoZSBzYW1lIGxlbmd0aCAtLSBvbmUgb2Yga2V5cywgYW5kIG9uZSBvZgogIC8vIHRoZSBjb3JyZXNwb25kaW5nIHZhbHVlcy4KICBfLm9iamVjdCA9IGZ1bmN0aW9uIChsaXN0LCB2YWx1ZXMpIHsKICAgIGlmIChsaXN0ID09IG51bGwpCiAgICAgIHJldHVybiB7fTsKICAgIHZhciByZXN1bHQgPSB7fTsKICAgIGZvciAodmFyIGkgPSAwLCBsZW5ndGggPSBsaXN0Lmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgIGlmICh2YWx1ZXMpIHsKICAgICAgICByZXN1bHRbbGlzdFtpXV0gPSB2YWx1ZXNbaV07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmVzdWx0W2xpc3RbaV1bMF1dID0gbGlzdFtpXVsxXTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9OwogIC8vIElmIHRoZSBicm93c2VyIGRvZXNuJ3Qgc3VwcGx5IHVzIHdpdGggaW5kZXhPZiAoSSdtIGxvb2tpbmcgYXQgeW91LCAqKk1TSUUqKiksCiAgLy8gd2UgbmVlZCB0aGlzIGZ1bmN0aW9uLiBSZXR1cm4gdGhlIHBvc2l0aW9uIG9mIHRoZSBmaXJzdCBvY2N1cnJlbmNlIG9mIGFuCiAgLy8gaXRlbSBpbiBhbiBhcnJheSwgb3IgLTEgaWYgdGhlIGl0ZW0gaXMgbm90IGluY2x1ZGVkIGluIHRoZSBhcnJheS4KICAvLyBEZWxlZ2F0ZXMgdG8gKipFQ01BU2NyaXB0IDUqKidzIG5hdGl2ZSBgaW5kZXhPZmAgaWYgYXZhaWxhYmxlLgogIC8vIElmIHRoZSBhcnJheSBpcyBsYXJnZSBhbmQgYWxyZWFkeSBpbiBzb3J0IG9yZGVyLCBwYXNzIGB0cnVlYAogIC8vIGZvciAqKmlzU29ydGVkKiogdG8gdXNlIGJpbmFyeSBzZWFyY2guCiAgXy5pbmRleE9mID0gZnVuY3Rpb24gKGFycmF5LCBpdGVtLCBpc1NvcnRlZCkgewogICAgaWYgKGFycmF5ID09IG51bGwpCiAgICAgIHJldHVybiAtMTsKICAgIHZhciBpID0gMCwgbGVuZ3RoID0gYXJyYXkubGVuZ3RoOwogICAgaWYgKGlzU29ydGVkKSB7CiAgICAgIGlmICh0eXBlb2YgaXNTb3J0ZWQgPT0gJ251bWJlcicpIHsKICAgICAgICBpID0gaXNTb3J0ZWQgPCAwID8gTWF0aC5tYXgoMCwgbGVuZ3RoICsgaXNTb3J0ZWQpIDogaXNTb3J0ZWQ7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaSA9IF8uc29ydGVkSW5kZXgoYXJyYXksIGl0ZW0pOwogICAgICAgIHJldHVybiBhcnJheVtpXSA9PT0gaXRlbSA/IGkgOiAtMTsKICAgICAgfQogICAgfQogICAgaWYgKG5hdGl2ZUluZGV4T2YgJiYgYXJyYXkuaW5kZXhPZiA9PT0gbmF0aXZlSW5kZXhPZikKICAgICAgcmV0dXJuIGFycmF5LmluZGV4T2YoaXRlbSwgaXNTb3J0ZWQpOwogICAgZm9yICg7IGkgPCBsZW5ndGg7IGkrKykKICAgICAgaWYgKGFycmF5W2ldID09PSBpdGVtKQogICAgICAgIHJldHVybiBpOwogICAgcmV0dXJuIC0xOwogIH07CiAgLy8gRGVsZWdhdGVzIHRvICoqRUNNQVNjcmlwdCA1KioncyBuYXRpdmUgYGxhc3RJbmRleE9mYCBpZiBhdmFpbGFibGUuCiAgXy5sYXN0SW5kZXhPZiA9IGZ1bmN0aW9uIChhcnJheSwgaXRlbSwgZnJvbSkgewogICAgaWYgKGFycmF5ID09IG51bGwpCiAgICAgIHJldHVybiAtMTsKICAgIHZhciBoYXNJbmRleCA9IGZyb20gIT0gbnVsbDsKICAgIGlmIChuYXRpdmVMYXN0SW5kZXhPZiAmJiBhcnJheS5sYXN0SW5kZXhPZiA9PT0gbmF0aXZlTGFzdEluZGV4T2YpIHsKICAgICAgcmV0dXJuIGhhc0luZGV4ID8gYXJyYXkubGFzdEluZGV4T2YoaXRlbSwgZnJvbSkgOiBhcnJheS5sYXN0SW5kZXhPZihpdGVtKTsKICAgIH0KICAgIHZhciBpID0gaGFzSW5kZXggPyBmcm9tIDogYXJyYXkubGVuZ3RoOwogICAgd2hpbGUgKGktLSkKICAgICAgaWYgKGFycmF5W2ldID09PSBpdGVtKQogICAgICAgIHJldHVybiBpOwogICAgcmV0dXJuIC0xOwogIH07CiAgLy8gR2VuZXJhdGUgYW4gaW50ZWdlciBBcnJheSBjb250YWluaW5nIGFuIGFyaXRobWV0aWMgcHJvZ3Jlc3Npb24uIEEgcG9ydCBvZgogIC8vIHRoZSBuYXRpdmUgUHl0aG9uIGByYW5nZSgpYCBmdW5jdGlvbi4gU2VlCiAgLy8gW3RoZSBQeXRob24gZG9jdW1lbnRhdGlvbl0oaHR0cDovL2RvY3MucHl0aG9uLm9yZy9saWJyYXJ5L2Z1bmN0aW9ucy5odG1sI3JhbmdlKS4KICBfLnJhbmdlID0gZnVuY3Rpb24gKHN0YXJ0LCBzdG9wLCBzdGVwKSB7CiAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA8PSAxKSB7CiAgICAgIHN0b3AgPSBzdGFydCB8fCAwOwogICAgICBzdGFydCA9IDA7CiAgICB9CiAgICBzdGVwID0gYXJndW1lbnRzWzJdIHx8IDE7CiAgICB2YXIgbGVuZ3RoID0gTWF0aC5tYXgoTWF0aC5jZWlsKChzdG9wIC0gc3RhcnQpIC8gc3RlcCksIDApOwogICAgdmFyIGlkeCA9IDA7CiAgICB2YXIgcmFuZ2UgPSBuZXcgQXJyYXkobGVuZ3RoKTsKICAgIHdoaWxlIChpZHggPCBsZW5ndGgpIHsKICAgICAgcmFuZ2VbaWR4KytdID0gc3RhcnQ7CiAgICAgIHN0YXJ0ICs9IHN0ZXA7CiAgICB9CiAgICByZXR1cm4gcmFuZ2U7CiAgfTsKICAvLyBGdW5jdGlvbiAoYWhlbSkgRnVuY3Rpb25zCiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tCiAgLy8gUmV1c2FibGUgY29uc3RydWN0b3IgZnVuY3Rpb24gZm9yIHByb3RvdHlwZSBzZXR0aW5nLgogIHZhciBjdG9yID0gZnVuY3Rpb24gKCkgewogIH07CiAgLy8gQ3JlYXRlIGEgZnVuY3Rpb24gYm91bmQgdG8gYSBnaXZlbiBvYmplY3QgKGFzc2lnbmluZyBgdGhpc2AsIGFuZCBhcmd1bWVudHMsCiAgLy8gb3B0aW9uYWxseSkuIERlbGVnYXRlcyB0byAqKkVDTUFTY3JpcHQgNSoqJ3MgbmF0aXZlIGBGdW5jdGlvbi5iaW5kYCBpZgogIC8vIGF2YWlsYWJsZS4KICBfLmJpbmQgPSBmdW5jdGlvbiAoZnVuYywgY29udGV4dCkgewogICAgdmFyIGFyZ3MsIGJvdW5kOwogICAgaWYgKG5hdGl2ZUJpbmQgJiYgZnVuYy5iaW5kID09PSBuYXRpdmVCaW5kKQogICAgICByZXR1cm4gbmF0aXZlQmluZC5hcHBseShmdW5jLCBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSkpOwogICAgaWYgKCFfLmlzRnVuY3Rpb24oZnVuYykpCiAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoKTsKICAgIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cywgMik7CiAgICByZXR1cm4gYm91bmQgPSBmdW5jdGlvbiAoKSB7CiAgICAgIGlmICghKHRoaXMgaW5zdGFuY2VvZiBib3VuZCkpCiAgICAgICAgcmV0dXJuIGZ1bmMuYXBwbHkoY29udGV4dCwgYXJncy5jb25jYXQoc2xpY2UuY2FsbChhcmd1bWVudHMpKSk7CiAgICAgIGN0b3IucHJvdG90eXBlID0gZnVuYy5wcm90b3R5cGU7CiAgICAgIHZhciBzZWxmID0gbmV3IGN0b3IoKTsKICAgICAgY3Rvci5wcm90b3R5cGUgPSBudWxsOwogICAgICB2YXIgcmVzdWx0ID0gZnVuYy5hcHBseShzZWxmLCBhcmdzLmNvbmNhdChzbGljZS5jYWxsKGFyZ3VtZW50cykpKTsKICAgICAgaWYgKE9iamVjdChyZXN1bHQpID09PSByZXN1bHQpCiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgcmV0dXJuIHNlbGY7CiAgICB9OwogIH07CiAgLy8gUGFydGlhbGx5IGFwcGx5IGEgZnVuY3Rpb24gYnkgY3JlYXRpbmcgYSB2ZXJzaW9uIHRoYXQgaGFzIGhhZCBzb21lIG9mIGl0cwogIC8vIGFyZ3VtZW50cyBwcmUtZmlsbGVkLCB3aXRob3V0IGNoYW5naW5nIGl0cyBkeW5hbWljIGB0aGlzYCBjb250ZXh0LiBfIGFjdHMKICAvLyBhcyBhIHBsYWNlaG9sZGVyLCBhbGxvd2luZyBhbnkgY29tYmluYXRpb24gb2YgYXJndW1lbnRzIHRvIGJlIHByZS1maWxsZWQuCiAgXy5wYXJ0aWFsID0gZnVuY3Rpb24gKGZ1bmMpIHsKICAgIHZhciBib3VuZEFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CiAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICB2YXIgcG9zaXRpb24gPSAwOwogICAgICB2YXIgYXJncyA9IGJvdW5kQXJncy5zbGljZSgpOwogICAgICBmb3IgKHZhciBpID0gMCwgbGVuZ3RoID0gYXJncy5sZW5ndGg7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgIGlmIChhcmdzW2ldID09PSBfKQogICAgICAgICAgYXJnc1tpXSA9IGFyZ3VtZW50c1twb3NpdGlvbisrXTsKICAgICAgfQogICAgICB3aGlsZSAocG9zaXRpb24gPCBhcmd1bWVudHMubGVuZ3RoKQogICAgICAgIGFyZ3MucHVzaChhcmd1bWVudHNbcG9zaXRpb24rK10pOwogICAgICByZXR1cm4gZnVuYy5hcHBseSh0aGlzLCBhcmdzKTsKICAgIH07CiAgfTsKICAvLyBCaW5kIGEgbnVtYmVyIG9mIGFuIG9iamVjdCdzIG1ldGhvZHMgdG8gdGhhdCBvYmplY3QuIFJlbWFpbmluZyBhcmd1bWVudHMKICAvLyBhcmUgdGhlIG1ldGhvZCBuYW1lcyB0byBiZSBib3VuZC4gVXNlZnVsIGZvciBlbnN1cmluZyB0aGF0IGFsbCBjYWxsYmFja3MKICAvLyBkZWZpbmVkIG9uIGFuIG9iamVjdCBiZWxvbmcgdG8gaXQuCiAgXy5iaW5kQWxsID0gZnVuY3Rpb24gKG9iaikgewogICAgdmFyIGZ1bmNzID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwogICAgaWYgKGZ1bmNzLmxlbmd0aCA9PT0gMCkKICAgICAgdGhyb3cgbmV3IEVycm9yKCdiaW5kQWxsIG11c3QgYmUgcGFzc2VkIGZ1bmN0aW9uIG5hbWVzJyk7CiAgICBlYWNoKGZ1bmNzLCBmdW5jdGlvbiAoZikgewogICAgICBvYmpbZl0gPSBfLmJpbmQob2JqW2ZdLCBvYmopOwogICAgfSk7CiAgICByZXR1cm4gb2JqOwogIH07CiAgLy8gTWVtb2l6ZSBhbiBleHBlbnNpdmUgZnVuY3Rpb24gYnkgc3RvcmluZyBpdHMgcmVzdWx0cy4KICBfLm1lbW9pemUgPSBmdW5jdGlvbiAoZnVuYywgaGFzaGVyKSB7CiAgICB2YXIgbWVtbyA9IHt9OwogICAgaGFzaGVyIHx8IChoYXNoZXIgPSBfLmlkZW50aXR5KTsKICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBrZXkgPSBoYXNoZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgcmV0dXJuIF8uaGFzKG1lbW8sIGtleSkgPyBtZW1vW2tleV0gOiBtZW1vW2tleV0gPSBmdW5jLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9OwogIH07CiAgLy8gRGVsYXlzIGEgZnVuY3Rpb24gZm9yIHRoZSBnaXZlbiBudW1iZXIgb2YgbWlsbGlzZWNvbmRzLCBhbmQgdGhlbiBjYWxscwogIC8vIGl0IHdpdGggdGhlIGFyZ3VtZW50cyBzdXBwbGllZC4KICBfLmRlbGF5ID0gZnVuY3Rpb24gKGZ1bmMsIHdhaXQpIHsKICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDIpOwogICAgcmV0dXJuIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gZnVuYy5hcHBseShudWxsLCBhcmdzKTsKICAgIH0sIHdhaXQpOwogIH07CiAgLy8gRGVmZXJzIGEgZnVuY3Rpb24sIHNjaGVkdWxpbmcgaXQgdG8gcnVuIGFmdGVyIHRoZSBjdXJyZW50IGNhbGwgc3RhY2sgaGFzCiAgLy8gY2xlYXJlZC4KICBfLmRlZmVyID0gZnVuY3Rpb24gKGZ1bmMpIHsKICAgIHJldHVybiBfLmRlbGF5LmFwcGx5KF8sIFsKICAgICAgZnVuYywKICAgICAgMQogICAgXS5jb25jYXQoc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpKSk7CiAgfTsKICAvLyBSZXR1cm5zIGEgZnVuY3Rpb24sIHRoYXQsIHdoZW4gaW52b2tlZCwgd2lsbCBvbmx5IGJlIHRyaWdnZXJlZCBhdCBtb3N0IG9uY2UKICAvLyBkdXJpbmcgYSBnaXZlbiB3aW5kb3cgb2YgdGltZS4gTm9ybWFsbHksIHRoZSB0aHJvdHRsZWQgZnVuY3Rpb24gd2lsbCBydW4KICAvLyBhcyBtdWNoIGFzIGl0IGNhbiwgd2l0aG91dCBldmVyIGdvaW5nIG1vcmUgdGhhbiBvbmNlIHBlciBgd2FpdGAgZHVyYXRpb247CiAgLy8gYnV0IGlmIHlvdSdkIGxpa2UgdG8gZGlzYWJsZSB0aGUgZXhlY3V0aW9uIG9uIHRoZSBsZWFkaW5nIGVkZ2UsIHBhc3MKICAvLyBge2xlYWRpbmc6IGZhbHNlfWAuIFRvIGRpc2FibGUgZXhlY3V0aW9uIG9uIHRoZSB0cmFpbGluZyBlZGdlLCBkaXR0by4KICBfLnRocm90dGxlID0gZnVuY3Rpb24gKGZ1bmMsIHdhaXQsIG9wdGlvbnMpIHsKICAgIHZhciBjb250ZXh0LCBhcmdzLCByZXN1bHQ7CiAgICB2YXIgdGltZW91dCA9IG51bGw7CiAgICB2YXIgcHJldmlvdXMgPSAwOwogICAgb3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KTsKICAgIHZhciBsYXRlciA9IGZ1bmN0aW9uICgpIHsKICAgICAgcHJldmlvdXMgPSBvcHRpb25zLmxlYWRpbmcgPT09IGZhbHNlID8gMCA6IF8ubm93KCk7CiAgICAgIHRpbWVvdXQgPSBudWxsOwogICAgICByZXN1bHQgPSBmdW5jLmFwcGx5KGNvbnRleHQsIGFyZ3MpOwogICAgICBjb250ZXh0ID0gYXJncyA9IG51bGw7CiAgICB9OwogICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIG5vdyA9IF8ubm93KCk7CiAgICAgIGlmICghcHJldmlvdXMgJiYgb3B0aW9ucy5sZWFkaW5nID09PSBmYWxzZSkKICAgICAgICBwcmV2aW91cyA9IG5vdzsKICAgICAgdmFyIHJlbWFpbmluZyA9IHdhaXQgLSAobm93IC0gcHJldmlvdXMpOwogICAgICBjb250ZXh0ID0gdGhpczsKICAgICAgYXJncyA9IGFyZ3VtZW50czsKICAgICAgaWYgKHJlbWFpbmluZyA8PSAwKSB7CiAgICAgICAgY2xlYXJUaW1lb3V0KHRpbWVvdXQpOwogICAgICAgIHRpbWVvdXQgPSBudWxsOwogICAgICAgIHByZXZpb3VzID0gbm93OwogICAgICAgIHJlc3VsdCA9IGZ1bmMuYXBwbHkoY29udGV4dCwgYXJncyk7CiAgICAgICAgY29udGV4dCA9IGFyZ3MgPSBudWxsOwogICAgICB9IGVsc2UgaWYgKCF0aW1lb3V0ICYmIG9wdGlvbnMudHJhaWxpbmcgIT09IGZhbHNlKSB7CiAgICAgICAgdGltZW91dCA9IHNldFRpbWVvdXQobGF0ZXIsIHJlbWFpbmluZyk7CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH07CiAgfTsKICAvLyBSZXR1cm5zIGEgZnVuY3Rpb24sIHRoYXQsIGFzIGxvbmcgYXMgaXQgY29udGludWVzIHRvIGJlIGludm9rZWQsIHdpbGwgbm90CiAgLy8gYmUgdHJpZ2dlcmVkLiBUaGUgZnVuY3Rpb24gd2lsbCBiZSBjYWxsZWQgYWZ0ZXIgaXQgc3RvcHMgYmVpbmcgY2FsbGVkIGZvcgogIC8vIE4gbWlsbGlzZWNvbmRzLiBJZiBgaW1tZWRpYXRlYCBpcyBwYXNzZWQsIHRyaWdnZXIgdGhlIGZ1bmN0aW9uIG9uIHRoZQogIC8vIGxlYWRpbmcgZWRnZSwgaW5zdGVhZCBvZiB0aGUgdHJhaWxpbmcuCiAgXy5kZWJvdW5jZSA9IGZ1bmN0aW9uIChmdW5jLCB3YWl0LCBpbW1lZGlhdGUpIHsKICAgIHZhciB0aW1lb3V0LCBhcmdzLCBjb250ZXh0LCB0aW1lc3RhbXAsIHJlc3VsdDsKICAgIHZhciBsYXRlciA9IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIGxhc3QgPSBfLm5vdygpIC0gdGltZXN0YW1wOwogICAgICBpZiAobGFzdCA8IHdhaXQpIHsKICAgICAgICB0aW1lb3V0ID0gc2V0VGltZW91dChsYXRlciwgd2FpdCAtIGxhc3QpOwogICAgICB9IGVsc2UgewogICAgICAgIHRpbWVvdXQgPSBudWxsOwogICAgICAgIGlmICghaW1tZWRpYXRlKSB7CiAgICAgICAgICByZXN1bHQgPSBmdW5jLmFwcGx5KGNvbnRleHQsIGFyZ3MpOwogICAgICAgICAgY29udGV4dCA9IGFyZ3MgPSBudWxsOwogICAgICAgIH0KICAgICAgfQogICAgfTsKICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgIGNvbnRleHQgPSB0aGlzOwogICAgICBhcmdzID0gYXJndW1lbnRzOwogICAgICB0aW1lc3RhbXAgPSBfLm5vdygpOwogICAgICB2YXIgY2FsbE5vdyA9IGltbWVkaWF0ZSAmJiAhdGltZW91dDsKICAgICAgaWYgKCF0aW1lb3V0KSB7CiAgICAgICAgdGltZW91dCA9IHNldFRpbWVvdXQobGF0ZXIsIHdhaXQpOwogICAgICB9CiAgICAgIGlmIChjYWxsTm93KSB7CiAgICAgICAgcmVzdWx0ID0gZnVuYy5hcHBseShjb250ZXh0LCBhcmdzKTsKICAgICAgICBjb250ZXh0ID0gYXJncyA9IG51bGw7CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH07CiAgfTsKICAvLyBSZXR1cm5zIGEgZnVuY3Rpb24gdGhhdCB3aWxsIGJlIGV4ZWN1dGVkIGF0IG1vc3Qgb25lIHRpbWUsIG5vIG1hdHRlciBob3cKICAvLyBvZnRlbiB5b3UgY2FsbCBpdC4gVXNlZnVsIGZvciBsYXp5IGluaXRpYWxpemF0aW9uLgogIF8ub25jZSA9IGZ1bmN0aW9uIChmdW5jKSB7CiAgICB2YXIgcmFuID0gZmFsc2UsIG1lbW87CiAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICBpZiAocmFuKQogICAgICAgIHJldHVybiBtZW1vOwogICAgICByYW4gPSB0cnVlOwogICAgICBtZW1vID0gZnVuYy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICBmdW5jID0gbnVsbDsKICAgICAgcmV0dXJuIG1lbW87CiAgICB9OwogIH07CiAgLy8gUmV0dXJucyB0aGUgZmlyc3QgZnVuY3Rpb24gcGFzc2VkIGFzIGFuIGFyZ3VtZW50IHRvIHRoZSBzZWNvbmQsCiAgLy8gYWxsb3dpbmcgeW91IHRvIGFkanVzdCBhcmd1bWVudHMsIHJ1biBjb2RlIGJlZm9yZSBhbmQgYWZ0ZXIsIGFuZAogIC8vIGNvbmRpdGlvbmFsbHkgZXhlY3V0ZSB0aGUgb3JpZ2luYWwgZnVuY3Rpb24uCiAgXy53cmFwID0gZnVuY3Rpb24gKGZ1bmMsIHdyYXBwZXIpIHsKICAgIHJldHVybiBfLnBhcnRpYWwod3JhcHBlciwgZnVuYyk7CiAgfTsKICAvLyBSZXR1cm5zIGEgZnVuY3Rpb24gdGhhdCBpcyB0aGUgY29tcG9zaXRpb24gb2YgYSBsaXN0IG9mIGZ1bmN0aW9ucywgZWFjaAogIC8vIGNvbnN1bWluZyB0aGUgcmV0dXJuIHZhbHVlIG9mIHRoZSBmdW5jdGlvbiB0aGF0IGZvbGxvd3MuCiAgXy5jb21wb3NlID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGZ1bmNzID0gYXJndW1lbnRzOwogICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIGFyZ3MgPSBhcmd1bWVudHM7CiAgICAgIGZvciAodmFyIGkgPSBmdW5jcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICAgIGFyZ3MgPSBbZnVuY3NbaV0uYXBwbHkodGhpcywgYXJncyldOwogICAgICB9CiAgICAgIHJldHVybiBhcmdzWzBdOwogICAgfTsKICB9OwogIC8vIFJldHVybnMgYSBmdW5jdGlvbiB0aGF0IHdpbGwgb25seSBiZSBleGVjdXRlZCBhZnRlciBiZWluZyBjYWxsZWQgTiB0aW1lcy4KICBfLmFmdGVyID0gZnVuY3Rpb24gKHRpbWVzLCBmdW5jKSB7CiAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICBpZiAoLS10aW1lcyA8IDEpIHsKICAgICAgICByZXR1cm4gZnVuYy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9CiAgICB9OwogIH07CiAgLy8gT2JqZWN0IEZ1bmN0aW9ucwogIC8vIC0tLS0tLS0tLS0tLS0tLS0KICAvLyBSZXRyaWV2ZSB0aGUgbmFtZXMgb2YgYW4gb2JqZWN0J3MgcHJvcGVydGllcy4KICAvLyBEZWxlZ2F0ZXMgdG8gKipFQ01BU2NyaXB0IDUqKidzIG5hdGl2ZSBgT2JqZWN0LmtleXNgCiAgXy5rZXlzID0gZnVuY3Rpb24gKG9iaikgewogICAgaWYgKCFfLmlzT2JqZWN0KG9iaikpCiAgICAgIHJldHVybiBbXTsKICAgIGlmIChuYXRpdmVLZXlzKQogICAgICByZXR1cm4gbmF0aXZlS2V5cyhvYmopOwogICAgdmFyIGtleXMgPSBbXTsKICAgIGZvciAodmFyIGtleSBpbiBvYmopCiAgICAgIGlmIChfLmhhcyhvYmosIGtleSkpCiAgICAgICAga2V5cy5wdXNoKGtleSk7CiAgICByZXR1cm4ga2V5czsKICB9OwogIC8vIFJldHJpZXZlIHRoZSB2YWx1ZXMgb2YgYW4gb2JqZWN0J3MgcHJvcGVydGllcy4KICBfLnZhbHVlcyA9IGZ1bmN0aW9uIChvYmopIHsKICAgIHZhciBrZXlzID0gXy5rZXlzKG9iaik7CiAgICB2YXIgbGVuZ3RoID0ga2V5cy5sZW5ndGg7CiAgICB2YXIgdmFsdWVzID0gbmV3IEFycmF5KGxlbmd0aCk7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgIHZhbHVlc1tpXSA9IG9ialtrZXlzW2ldXTsKICAgIH0KICAgIHJldHVybiB2YWx1ZXM7CiAgfTsKICAvLyBDb252ZXJ0IGFuIG9iamVjdCBpbnRvIGEgbGlzdCBvZiBgW2tleSwgdmFsdWVdYCBwYWlycy4KICBfLnBhaXJzID0gZnVuY3Rpb24gKG9iaikgewogICAgdmFyIGtleXMgPSBfLmtleXMob2JqKTsKICAgIHZhciBsZW5ndGggPSBrZXlzLmxlbmd0aDsKICAgIHZhciBwYWlycyA9IG5ldyBBcnJheShsZW5ndGgpOwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICBwYWlyc1tpXSA9IFsKICAgICAgICBrZXlzW2ldLAogICAgICAgIG9ialtrZXlzW2ldXQogICAgICBdOwogICAgfQogICAgcmV0dXJuIHBhaXJzOwogIH07CiAgLy8gSW52ZXJ0IHRoZSBrZXlzIGFuZCB2YWx1ZXMgb2YgYW4gb2JqZWN0LiBUaGUgdmFsdWVzIG11c3QgYmUgc2VyaWFsaXphYmxlLgogIF8uaW52ZXJ0ID0gZnVuY3Rpb24gKG9iaikgewogICAgdmFyIHJlc3VsdCA9IHt9OwogICAgdmFyIGtleXMgPSBfLmtleXMob2JqKTsKICAgIGZvciAodmFyIGkgPSAwLCBsZW5ndGggPSBrZXlzLmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgIHJlc3VsdFtvYmpba2V5c1tpXV1dID0ga2V5c1tpXTsKICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfTsKICAvLyBSZXR1cm4gYSBzb3J0ZWQgbGlzdCBvZiB0aGUgZnVuY3Rpb24gbmFtZXMgYXZhaWxhYmxlIG9uIHRoZSBvYmplY3QuCiAgLy8gQWxpYXNlZCBhcyBgbWV0aG9kc2AKICBfLmZ1bmN0aW9ucyA9IF8ubWV0aG9kcyA9IGZ1bmN0aW9uIChvYmopIHsKICAgIHZhciBuYW1lcyA9IFtdOwogICAgZm9yICh2YXIga2V5IGluIG9iaikgewogICAgICBpZiAoXy5pc0Z1bmN0aW9uKG9ialtrZXldKSkKICAgICAgICBuYW1lcy5wdXNoKGtleSk7CiAgICB9CiAgICByZXR1cm4gbmFtZXMuc29ydCgpOwogIH07CiAgLy8gRXh0ZW5kIGEgZ2l2ZW4gb2JqZWN0IHdpdGggYWxsIHRoZSBwcm9wZXJ0aWVzIGluIHBhc3NlZC1pbiBvYmplY3QocykuCiAgXy5leHRlbmQgPSBmdW5jdGlvbiAob2JqKSB7CiAgICBlYWNoKHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSwgZnVuY3Rpb24gKHNvdXJjZSkgewogICAgICBpZiAoc291cmNlKSB7CiAgICAgICAgZm9yICh2YXIgcHJvcCBpbiBzb3VyY2UpIHsKICAgICAgICAgIG9ialtwcm9wXSA9IHNvdXJjZVtwcm9wXTsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuIG9iajsKICB9OwogIC8vIFJldHVybiBhIGNvcHkgb2YgdGhlIG9iamVjdCBvbmx5IGNvbnRhaW5pbmcgdGhlIHdoaXRlbGlzdGVkIHByb3BlcnRpZXMuCiAgXy5waWNrID0gZnVuY3Rpb24gKG9iaikgewogICAgdmFyIGNvcHkgPSB7fTsKICAgIHZhciBrZXlzID0gY29uY2F0LmFwcGx5KEFycmF5UHJvdG8sIHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSk7CiAgICBlYWNoKGtleXMsIGZ1bmN0aW9uIChrZXkpIHsKICAgICAgaWYgKGtleSBpbiBvYmopCiAgICAgICAgY29weVtrZXldID0gb2JqW2tleV07CiAgICB9KTsKICAgIHJldHVybiBjb3B5OwogIH07CiAgLy8gUmV0dXJuIGEgY29weSBvZiB0aGUgb2JqZWN0IHdpdGhvdXQgdGhlIGJsYWNrbGlzdGVkIHByb3BlcnRpZXMuCiAgXy5vbWl0ID0gZnVuY3Rpb24gKG9iaikgewogICAgdmFyIGNvcHkgPSB7fTsKICAgIHZhciBrZXlzID0gY29uY2F0LmFwcGx5KEFycmF5UHJvdG8sIHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSk7CiAgICBmb3IgKHZhciBrZXkgaW4gb2JqKSB7CiAgICAgIGlmICghXy5jb250YWlucyhrZXlzLCBrZXkpKQogICAgICAgIGNvcHlba2V5XSA9IG9ialtrZXldOwogICAgfQogICAgcmV0dXJuIGNvcHk7CiAgfTsKICAvLyBGaWxsIGluIGEgZ2l2ZW4gb2JqZWN0IHdpdGggZGVmYXVsdCBwcm9wZXJ0aWVzLgogIF8uZGVmYXVsdHMgPSBmdW5jdGlvbiAob2JqKSB7CiAgICBlYWNoKHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSwgZnVuY3Rpb24gKHNvdXJjZSkgewogICAgICBpZiAoc291cmNlKSB7CiAgICAgICAgZm9yICh2YXIgcHJvcCBpbiBzb3VyY2UpIHsKICAgICAgICAgIGlmIChvYmpbcHJvcF0gPT09IHZvaWQgMCkKICAgICAgICAgICAgb2JqW3Byb3BdID0gc291cmNlW3Byb3BdOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgICByZXR1cm4gb2JqOwogIH07CiAgLy8gQ3JlYXRlIGEgKHNoYWxsb3ctY2xvbmVkKSBkdXBsaWNhdGUgb2YgYW4gb2JqZWN0LgogIF8uY2xvbmUgPSBmdW5jdGlvbiAob2JqKSB7CiAgICBpZiAoIV8uaXNPYmplY3Qob2JqKSkKICAgICAgcmV0dXJuIG9iajsKICAgIHJldHVybiBfLmlzQXJyYXkob2JqKSA/IG9iai5zbGljZSgpIDogXy5leHRlbmQoe30sIG9iaik7CiAgfTsKICAvLyBJbnZva2VzIGludGVyY2VwdG9yIHdpdGggdGhlIG9iaiwgYW5kIHRoZW4gcmV0dXJucyBvYmouCiAgLy8gVGhlIHByaW1hcnkgcHVycG9zZSBvZiB0aGlzIG1ldGhvZCBpcyB0byAidGFwIGludG8iIGEgbWV0aG9kIGNoYWluLCBpbgogIC8vIG9yZGVyIHRvIHBlcmZvcm0gb3BlcmF0aW9ucyBvbiBpbnRlcm1lZGlhdGUgcmVzdWx0cyB3aXRoaW4gdGhlIGNoYWluLgogIF8udGFwID0gZnVuY3Rpb24gKG9iaiwgaW50ZXJjZXB0b3IpIHsKICAgIGludGVyY2VwdG9yKG9iaik7CiAgICByZXR1cm4gb2JqOwogIH07CiAgLy8gSW50ZXJuYWwgcmVjdXJzaXZlIGNvbXBhcmlzb24gZnVuY3Rpb24gZm9yIGBpc0VxdWFsYC4KICB2YXIgZXEgPSBmdW5jdGlvbiAoYSwgYiwgYVN0YWNrLCBiU3RhY2spIHsKICAgIC8vIElkZW50aWNhbCBvYmplY3RzIGFyZSBlcXVhbC4gYDAgPT09IC0wYCwgYnV0IHRoZXkgYXJlbid0IGlkZW50aWNhbC4KICAgIC8vIFNlZSB0aGUgW0hhcm1vbnkgYGVnYWxgIHByb3Bvc2FsXShodHRwOi8vd2lraS5lY21hc2NyaXB0Lm9yZy9kb2t1LnBocD9pZD1oYXJtb255OmVnYWwpLgogICAgaWYgKGEgPT09IGIpCiAgICAgIHJldHVybiBhICE9PSAwIHx8IDEgLyBhID09IDEgLyBiOwogICAgLy8gQSBzdHJpY3QgY29tcGFyaXNvbiBpcyBuZWNlc3NhcnkgYmVjYXVzZSBgbnVsbCA9PSB1bmRlZmluZWRgLgogICAgaWYgKGEgPT0gbnVsbCB8fCBiID09IG51bGwpCiAgICAgIHJldHVybiBhID09PSBiOwogICAgLy8gVW53cmFwIGFueSB3cmFwcGVkIG9iamVjdHMuCiAgICBpZiAoYSBpbnN0YW5jZW9mIF8pCiAgICAgIGEgPSBhLl93cmFwcGVkOwogICAgaWYgKGIgaW5zdGFuY2VvZiBfKQogICAgICBiID0gYi5fd3JhcHBlZDsKICAgIC8vIENvbXBhcmUgYFtbQ2xhc3NdXWAgbmFtZXMuCiAgICB2YXIgY2xhc3NOYW1lID0gdG9TdHJpbmcuY2FsbChhKTsKICAgIGlmIChjbGFzc05hbWUgIT0gdG9TdHJpbmcuY2FsbChiKSkKICAgICAgcmV0dXJuIGZhbHNlOwogICAgc3dpdGNoIChjbGFzc05hbWUpIHsKICAgIC8vIFN0cmluZ3MsIG51bWJlcnMsIGRhdGVzLCBhbmQgYm9vbGVhbnMgYXJlIGNvbXBhcmVkIGJ5IHZhbHVlLgogICAgY2FzZSAnW29iamVjdCBTdHJpbmddJzoKICAgICAgLy8gUHJpbWl0aXZlcyBhbmQgdGhlaXIgY29ycmVzcG9uZGluZyBvYmplY3Qgd3JhcHBlcnMgYXJlIGVxdWl2YWxlbnQ7IHRodXMsIGAiNSJgIGlzCiAgICAgIC8vIGVxdWl2YWxlbnQgdG8gYG5ldyBTdHJpbmcoIjUiKWAuCiAgICAgIHJldHVybiBhID09IFN0cmluZyhiKTsKICAgIGNhc2UgJ1tvYmplY3QgTnVtYmVyXSc6CiAgICAgIC8vIGBOYU5gcyBhcmUgZXF1aXZhbGVudCwgYnV0IG5vbi1yZWZsZXhpdmUuIEFuIGBlZ2FsYCBjb21wYXJpc29uIGlzIHBlcmZvcm1lZCBmb3IKICAgICAgLy8gb3RoZXIgbnVtZXJpYyB2YWx1ZXMuCiAgICAgIHJldHVybiBhICE9ICthID8gYiAhPSArYiA6IGEgPT0gMCA/IDEgLyBhID09IDEgLyBiIDogYSA9PSArYjsKICAgIGNhc2UgJ1tvYmplY3QgRGF0ZV0nOgogICAgY2FzZSAnW29iamVjdCBCb29sZWFuXSc6CiAgICAgIC8vIENvZXJjZSBkYXRlcyBhbmQgYm9vbGVhbnMgdG8gbnVtZXJpYyBwcmltaXRpdmUgdmFsdWVzLiBEYXRlcyBhcmUgY29tcGFyZWQgYnkgdGhlaXIKICAgICAgLy8gbWlsbGlzZWNvbmQgcmVwcmVzZW50YXRpb25zLiBOb3RlIHRoYXQgaW52YWxpZCBkYXRlcyB3aXRoIG1pbGxpc2Vjb25kIHJlcHJlc2VudGF0aW9ucwogICAgICAvLyBvZiBgTmFOYCBhcmUgbm90IGVxdWl2YWxlbnQuCiAgICAgIHJldHVybiArYSA9PSArYjsKICAgIC8vIFJlZ0V4cHMgYXJlIGNvbXBhcmVkIGJ5IHRoZWlyIHNvdXJjZSBwYXR0ZXJucyBhbmQgZmxhZ3MuCiAgICBjYXNlICdbb2JqZWN0IFJlZ0V4cF0nOgogICAgICByZXR1cm4gYS5zb3VyY2UgPT0gYi5zb3VyY2UgJiYgYS5nbG9iYWwgPT0gYi5nbG9iYWwgJiYgYS5tdWx0aWxpbmUgPT0gYi5tdWx0aWxpbmUgJiYgYS5pZ25vcmVDYXNlID09IGIuaWdub3JlQ2FzZTsKICAgIH0KICAgIGlmICh0eXBlb2YgYSAhPSAnb2JqZWN0JyB8fCB0eXBlb2YgYiAhPSAnb2JqZWN0JykKICAgICAgcmV0dXJuIGZhbHNlOwogICAgLy8gQXNzdW1lIGVxdWFsaXR5IGZvciBjeWNsaWMgc3RydWN0dXJlcy4gVGhlIGFsZ29yaXRobSBmb3IgZGV0ZWN0aW5nIGN5Y2xpYwogICAgLy8gc3RydWN0dXJlcyBpcyBhZGFwdGVkIGZyb20gRVMgNS4xIHNlY3Rpb24gMTUuMTIuMywgYWJzdHJhY3Qgb3BlcmF0aW9uIGBKT2AuCiAgICB2YXIgbGVuZ3RoID0gYVN0YWNrLmxlbmd0aDsKICAgIHdoaWxlIChsZW5ndGgtLSkgewogICAgICAvLyBMaW5lYXIgc2VhcmNoLiBQZXJmb3JtYW5jZSBpcyBpbnZlcnNlbHkgcHJvcG9ydGlvbmFsIHRvIHRoZSBudW1iZXIgb2YKICAgICAgLy8gdW5pcXVlIG5lc3RlZCBzdHJ1Y3R1cmVzLgogICAgICBpZiAoYVN0YWNrW2xlbmd0aF0gPT0gYSkKICAgICAgICByZXR1cm4gYlN0YWNrW2xlbmd0aF0gPT0gYjsKICAgIH0KICAgIC8vIE9iamVjdHMgd2l0aCBkaWZmZXJlbnQgY29uc3RydWN0b3JzIGFyZSBub3QgZXF1aXZhbGVudCwgYnV0IGBPYmplY3RgcwogICAgLy8gZnJvbSBkaWZmZXJlbnQgZnJhbWVzIGFyZS4KICAgIHZhciBhQ3RvciA9IGEuY29uc3RydWN0b3IsIGJDdG9yID0gYi5jb25zdHJ1Y3RvcjsKICAgIGlmIChhQ3RvciAhPT0gYkN0b3IgJiYgIShfLmlzRnVuY3Rpb24oYUN0b3IpICYmIGFDdG9yIGluc3RhbmNlb2YgYUN0b3IgJiYgXy5pc0Z1bmN0aW9uKGJDdG9yKSAmJiBiQ3RvciBpbnN0YW5jZW9mIGJDdG9yKSAmJiAoJ2NvbnN0cnVjdG9yJyBpbiBhICYmICdjb25zdHJ1Y3RvcicgaW4gYikpIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgLy8gQWRkIHRoZSBmaXJzdCBvYmplY3QgdG8gdGhlIHN0YWNrIG9mIHRyYXZlcnNlZCBvYmplY3RzLgogICAgYVN0YWNrLnB1c2goYSk7CiAgICBiU3RhY2sucHVzaChiKTsKICAgIHZhciBzaXplID0gMCwgcmVzdWx0ID0gdHJ1ZTsKICAgIC8vIFJlY3Vyc2l2ZWx5IGNvbXBhcmUgb2JqZWN0cyBhbmQgYXJyYXlzLgogICAgaWYgKGNsYXNzTmFtZSA9PSAnW29iamVjdCBBcnJheV0nKSB7CiAgICAgIC8vIENvbXBhcmUgYXJyYXkgbGVuZ3RocyB0byBkZXRlcm1pbmUgaWYgYSBkZWVwIGNvbXBhcmlzb24gaXMgbmVjZXNzYXJ5LgogICAgICBzaXplID0gYS5sZW5ndGg7CiAgICAgIHJlc3VsdCA9IHNpemUgPT0gYi5sZW5ndGg7CiAgICAgIGlmIChyZXN1bHQpIHsKICAgICAgICAvLyBEZWVwIGNvbXBhcmUgdGhlIGNvbnRlbnRzLCBpZ25vcmluZyBub24tbnVtZXJpYyBwcm9wZXJ0aWVzLgogICAgICAgIHdoaWxlIChzaXplLS0pIHsKICAgICAgICAgIGlmICghKHJlc3VsdCA9IGVxKGFbc2l6ZV0sIGJbc2l6ZV0sIGFTdGFjaywgYlN0YWNrKSkpCiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgLy8gRGVlcCBjb21wYXJlIG9iamVjdHMuCiAgICAgIGZvciAodmFyIGtleSBpbiBhKSB7CiAgICAgICAgaWYgKF8uaGFzKGEsIGtleSkpIHsKICAgICAgICAgIC8vIENvdW50IHRoZSBleHBlY3RlZCBudW1iZXIgb2YgcHJvcGVydGllcy4KICAgICAgICAgIHNpemUrKzsKICAgICAgICAgIC8vIERlZXAgY29tcGFyZSBlYWNoIG1lbWJlci4KICAgICAgICAgIGlmICghKHJlc3VsdCA9IF8uaGFzKGIsIGtleSkgJiYgZXEoYVtrZXldLCBiW2tleV0sIGFTdGFjaywgYlN0YWNrKSkpCiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgfQogICAgICAvLyBFbnN1cmUgdGhhdCBib3RoIG9iamVjdHMgY29udGFpbiB0aGUgc2FtZSBudW1iZXIgb2YgcHJvcGVydGllcy4KICAgICAgaWYgKHJlc3VsdCkgewogICAgICAgIGZvciAoa2V5IGluIGIpIHsKICAgICAgICAgIGlmIChfLmhhcyhiLCBrZXkpICYmICFzaXplLS0pCiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgICByZXN1bHQgPSAhc2l6ZTsKICAgICAgfQogICAgfQogICAgLy8gUmVtb3ZlIHRoZSBmaXJzdCBvYmplY3QgZnJvbSB0aGUgc3RhY2sgb2YgdHJhdmVyc2VkIG9iamVjdHMuCiAgICBhU3RhY2sucG9wKCk7CiAgICBiU3RhY2sucG9wKCk7CiAgICByZXR1cm4gcmVzdWx0OwogIH07CiAgLy8gUGVyZm9ybSBhIGRlZXAgY29tcGFyaXNvbiB0byBjaGVjayBpZiB0d28gb2JqZWN0cyBhcmUgZXF1YWwuCiAgXy5pc0VxdWFsID0gZnVuY3Rpb24gKGEsIGIpIHsKICAgIHJldHVybiBlcShhLCBiLCBbXSwgW10pOwogIH07CiAgLy8gSXMgYSBnaXZlbiBhcnJheSwgc3RyaW5nLCBvciBvYmplY3QgZW1wdHk/CiAgLy8gQW4gImVtcHR5IiBvYmplY3QgaGFzIG5vIGVudW1lcmFibGUgb3duLXByb3BlcnRpZXMuCiAgXy5pc0VtcHR5ID0gZnVuY3Rpb24gKG9iaikgewogICAgaWYgKG9iaiA9PSBudWxsKQogICAgICByZXR1cm4gdHJ1ZTsKICAgIGlmIChfLmlzQXJyYXkob2JqKSB8fCBfLmlzU3RyaW5nKG9iaikpCiAgICAgIHJldHVybiBvYmoubGVuZ3RoID09PSAwOwogICAgZm9yICh2YXIga2V5IGluIG9iaikKICAgICAgaWYgKF8uaGFzKG9iaiwga2V5KSkKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICByZXR1cm4gdHJ1ZTsKICB9OwogIC8vIElzIGEgZ2l2ZW4gdmFsdWUgYSBET00gZWxlbWVudD8KICBfLmlzRWxlbWVudCA9IGZ1bmN0aW9uIChvYmopIHsKICAgIHJldHVybiAhIShvYmogJiYgb2JqLm5vZGVUeXBlID09PSAxKTsKICB9OwogIC8vIElzIGEgZ2l2ZW4gdmFsdWUgYW4gYXJyYXk/CiAgLy8gRGVsZWdhdGVzIHRvIEVDTUE1J3MgbmF0aXZlIEFycmF5LmlzQXJyYXkKICBfLmlzQXJyYXkgPSBuYXRpdmVJc0FycmF5IHx8IGZ1bmN0aW9uIChvYmopIHsKICAgIHJldHVybiB0b1N0cmluZy5jYWxsKG9iaikgPT0gJ1tvYmplY3QgQXJyYXldJzsKICB9OwogIC8vIElzIGEgZ2l2ZW4gdmFyaWFibGUgYW4gb2JqZWN0PwogIF8uaXNPYmplY3QgPSBmdW5jdGlvbiAob2JqKSB7CiAgICByZXR1cm4gb2JqID09PSBPYmplY3Qob2JqKTsKICB9OwogIC8vIEFkZCBzb21lIGlzVHlwZSBtZXRob2RzOiBpc0FyZ3VtZW50cywgaXNGdW5jdGlvbiwgaXNTdHJpbmcsIGlzTnVtYmVyLCBpc0RhdGUsIGlzUmVnRXhwLgogIGVhY2goWwogICAgJ0FyZ3VtZW50cycsCiAgICAnRnVuY3Rpb24nLAogICAgJ1N0cmluZycsCiAgICAnTnVtYmVyJywKICAgICdEYXRlJywKICAgICdSZWdFeHAnCiAgXSwgZnVuY3Rpb24gKG5hbWUpIHsKICAgIF9bJ2lzJyArIG5hbWVdID0gZnVuY3Rpb24gKG9iaikgewogICAgICByZXR1cm4gdG9TdHJpbmcuY2FsbChvYmopID09ICdbb2JqZWN0ICcgKyBuYW1lICsgJ10nOwogICAgfTsKICB9KTsKICAvLyBEZWZpbmUgYSBmYWxsYmFjayB2ZXJzaW9uIG9mIHRoZSBtZXRob2QgaW4gYnJvd3NlcnMgKGFoZW0sIElFKSwgd2hlcmUKICAvLyB0aGVyZSBpc24ndCBhbnkgaW5zcGVjdGFibGUgIkFyZ3VtZW50cyIgdHlwZS4KICBpZiAoIV8uaXNBcmd1bWVudHMoYXJndW1lbnRzKSkgewogICAgXy5pc0FyZ3VtZW50cyA9IGZ1bmN0aW9uIChvYmopIHsKICAgICAgcmV0dXJuICEhKG9iaiAmJiBfLmhhcyhvYmosICdjYWxsZWUnKSk7CiAgICB9OwogIH0KICAvLyBPcHRpbWl6ZSBgaXNGdW5jdGlvbmAgaWYgYXBwcm9wcmlhdGUuCiAgaWYgKHR5cGVvZiAvLi8gIT09ICdmdW5jdGlvbicpIHsKICAgIF8uaXNGdW5jdGlvbiA9IGZ1bmN0aW9uIChvYmopIHsKICAgICAgcmV0dXJuIHR5cGVvZiBvYmogPT09ICdmdW5jdGlvbic7CiAgICB9OwogIH0KICAvLyBJcyBhIGdpdmVuIG9iamVjdCBhIGZpbml0ZSBudW1iZXI/CiAgXy5pc0Zpbml0ZSA9IGZ1bmN0aW9uIChvYmopIHsKICAgIHJldHVybiBpc0Zpbml0ZShvYmopICYmICFpc05hTihwYXJzZUZsb2F0KG9iaikpOwogIH07CiAgLy8gSXMgdGhlIGdpdmVuIHZhbHVlIGBOYU5gPyAoTmFOIGlzIHRoZSBvbmx5IG51bWJlciB3aGljaCBkb2VzIG5vdCBlcXVhbCBpdHNlbGYpLgogIF8uaXNOYU4gPSBmdW5jdGlvbiAob2JqKSB7CiAgICByZXR1cm4gXy5pc051bWJlcihvYmopICYmIG9iaiAhPSArb2JqOwogIH07CiAgLy8gSXMgYSBnaXZlbiB2YWx1ZSBhIGJvb2xlYW4/CiAgXy5pc0Jvb2xlYW4gPSBmdW5jdGlvbiAob2JqKSB7CiAgICByZXR1cm4gb2JqID09PSB0cnVlIHx8IG9iaiA9PT0gZmFsc2UgfHwgdG9TdHJpbmcuY2FsbChvYmopID09ICdbb2JqZWN0IEJvb2xlYW5dJzsKICB9OwogIC8vIElzIGEgZ2l2ZW4gdmFsdWUgZXF1YWwgdG8gbnVsbD8KICBfLmlzTnVsbCA9IGZ1bmN0aW9uIChvYmopIHsKICAgIHJldHVybiBvYmogPT09IG51bGw7CiAgfTsKICAvLyBJcyBhIGdpdmVuIHZhcmlhYmxlIHVuZGVmaW5lZD8KICBfLmlzVW5kZWZpbmVkID0gZnVuY3Rpb24gKG9iaikgewogICAgcmV0dXJuIG9iaiA9PT0gdm9pZCAwOwogIH07CiAgLy8gU2hvcnRjdXQgZnVuY3Rpb24gZm9yIGNoZWNraW5nIGlmIGFuIG9iamVjdCBoYXMgYSBnaXZlbiBwcm9wZXJ0eSBkaXJlY3RseQogIC8vIG9uIGl0c2VsZiAoaW4gb3RoZXIgd29yZHMsIG5vdCBvbiBhIHByb3RvdHlwZSkuCiAgXy5oYXMgPSBmdW5jdGlvbiAob2JqLCBrZXkpIHsKICAgIHJldHVybiBoYXNPd25Qcm9wZXJ0eS5jYWxsKG9iaiwga2V5KTsKICB9OwogIC8vIFV0aWxpdHkgRnVuY3Rpb25zCiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0KICAvLyBSdW4gVW5kZXJzY29yZS5qcyBpbiAqbm9Db25mbGljdCogbW9kZSwgcmV0dXJuaW5nIHRoZSBgX2AgdmFyaWFibGUgdG8gaXRzCiAgLy8gcHJldmlvdXMgb3duZXIuIFJldHVybnMgYSByZWZlcmVuY2UgdG8gdGhlIFVuZGVyc2NvcmUgb2JqZWN0LgogIF8ubm9Db25mbGljdCA9IGZ1bmN0aW9uICgpIHsKICAgIHJvb3QuXyA9IHByZXZpb3VzVW5kZXJzY29yZTsKICAgIHJldHVybiB0aGlzOwogIH07CiAgLy8gS2VlcCB0aGUgaWRlbnRpdHkgZnVuY3Rpb24gYXJvdW5kIGZvciBkZWZhdWx0IGl0ZXJhdG9ycy4KICBfLmlkZW50aXR5ID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgICByZXR1cm4gdmFsdWU7CiAgfTsKICBfLmNvbnN0YW50ID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gdmFsdWU7CiAgICB9OwogIH07CiAgXy5wcm9wZXJ0eSA9IGZ1bmN0aW9uIChrZXkpIHsKICAgIHJldHVybiBmdW5jdGlvbiAob2JqKSB7CiAgICAgIHJldHVybiBvYmpba2V5XTsKICAgIH07CiAgfTsKICAvLyBSZXR1cm5zIGEgcHJlZGljYXRlIGZvciBjaGVja2luZyB3aGV0aGVyIGFuIG9iamVjdCBoYXMgYSBnaXZlbiBzZXQgb2YgYGtleTp2YWx1ZWAgcGFpcnMuCiAgXy5tYXRjaGVzID0gZnVuY3Rpb24gKGF0dHJzKSB7CiAgICByZXR1cm4gZnVuY3Rpb24gKG9iaikgewogICAgICBpZiAob2JqID09PSBhdHRycykKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgLy9hdm9pZCBjb21wYXJpbmcgYW4gb2JqZWN0IHRvIGl0c2VsZi4KICAgICAgZm9yICh2YXIga2V5IGluIGF0dHJzKSB7CiAgICAgICAgaWYgKGF0dHJzW2tleV0gIT09IG9ialtrZXldKQogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIHJldHVybiB0cnVlOwogICAgfTsKICB9OwogIC8vIFJ1biBhIGZ1bmN0aW9uICoqbioqIHRpbWVzLgogIF8udGltZXMgPSBmdW5jdGlvbiAobiwgaXRlcmF0b3IsIGNvbnRleHQpIHsKICAgIHZhciBhY2N1bSA9IEFycmF5KE1hdGgubWF4KDAsIG4pKTsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbjsgaSsrKQogICAgICBhY2N1bVtpXSA9IGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgaSk7CiAgICByZXR1cm4gYWNjdW07CiAgfTsKICAvLyBSZXR1cm4gYSByYW5kb20gaW50ZWdlciBiZXR3ZWVuIG1pbiBhbmQgbWF4IChpbmNsdXNpdmUpLgogIF8ucmFuZG9tID0gZnVuY3Rpb24gKG1pbiwgbWF4KSB7CiAgICBpZiAobWF4ID09IG51bGwpIHsKICAgICAgbWF4ID0gbWluOwogICAgICBtaW4gPSAwOwogICAgfQogICAgcmV0dXJuIG1pbiArIE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIChtYXggLSBtaW4gKyAxKSk7CiAgfTsKICAvLyBBIChwb3NzaWJseSBmYXN0ZXIpIHdheSB0byBnZXQgdGhlIGN1cnJlbnQgdGltZXN0YW1wIGFzIGFuIGludGVnZXIuCiAgXy5ub3cgPSBEYXRlLm5vdyB8fCBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gbmV3IERhdGUoKS5nZXRUaW1lKCk7CiAgfTsKICAvLyBMaXN0IG9mIEhUTUwgZW50aXRpZXMgZm9yIGVzY2FwaW5nLgogIHZhciBlbnRpdHlNYXAgPSB7CiAgICBlc2NhcGU6IHsKICAgICAgJyYnOiAnJmFtcDsnLAogICAgICAnPCc6ICcmbHQ7JywKICAgICAgJz4nOiAnJmd0OycsCiAgICAgICciJzogJyZxdW90OycsCiAgICAgICdcJyc6ICcmI3gyNzsnCiAgICB9CiAgfTsKICBlbnRpdHlNYXAudW5lc2NhcGUgPSBfLmludmVydChlbnRpdHlNYXAuZXNjYXBlKTsKICAvLyBSZWdleGVzIGNvbnRhaW5pbmcgdGhlIGtleXMgYW5kIHZhbHVlcyBsaXN0ZWQgaW1tZWRpYXRlbHkgYWJvdmUuCiAgdmFyIGVudGl0eVJlZ2V4ZXMgPSB7CiAgICBlc2NhcGU6IG5ldyBSZWdFeHAoJ1snICsgXy5rZXlzKGVudGl0eU1hcC5lc2NhcGUpLmpvaW4oJycpICsgJ10nLCAnZycpLAogICAgdW5lc2NhcGU6IG5ldyBSZWdFeHAoJygnICsgXy5rZXlzKGVudGl0eU1hcC51bmVzY2FwZSkuam9pbignfCcpICsgJyknLCAnZycpCiAgfTsKICAvLyBGdW5jdGlvbnMgZm9yIGVzY2FwaW5nIGFuZCB1bmVzY2FwaW5nIHN0cmluZ3MgdG8vZnJvbSBIVE1MIGludGVycG9sYXRpb24uCiAgXy5lYWNoKFsKICAgICdlc2NhcGUnLAogICAgJ3VuZXNjYXBlJwogIF0sIGZ1bmN0aW9uIChtZXRob2QpIHsKICAgIF9bbWV0aG9kXSA9IGZ1bmN0aW9uIChzdHJpbmcpIHsKICAgICAgaWYgKHN0cmluZyA9PSBudWxsKQogICAgICAgIHJldHVybiAnJzsKICAgICAgcmV0dXJuICgnJyArIHN0cmluZykucmVwbGFjZShlbnRpdHlSZWdleGVzW21ldGhvZF0sIGZ1bmN0aW9uIChtYXRjaCkgewogICAgICAgIHJldHVybiBlbnRpdHlNYXBbbWV0aG9kXVttYXRjaF07CiAgICAgIH0pOwogICAgfTsKICB9KTsKICAvLyBJZiB0aGUgdmFsdWUgb2YgdGhlIG5hbWVkIGBwcm9wZXJ0eWAgaXMgYSBmdW5jdGlvbiB0aGVuIGludm9rZSBpdCB3aXRoIHRoZQogIC8vIGBvYmplY3RgIGFzIGNvbnRleHQ7IG90aGVyd2lzZSwgcmV0dXJuIGl0LgogIF8ucmVzdWx0ID0gZnVuY3Rpb24gKG9iamVjdCwgcHJvcGVydHkpIHsKICAgIGlmIChvYmplY3QgPT0gbnVsbCkKICAgICAgcmV0dXJuIHZvaWQgMDsKICAgIHZhciB2YWx1ZSA9IG9iamVjdFtwcm9wZXJ0eV07CiAgICByZXR1cm4gXy5pc0Z1bmN0aW9uKHZhbHVlKSA/IHZhbHVlLmNhbGwob2JqZWN0KSA6IHZhbHVlOwogIH07CiAgLy8gQWRkIHlvdXIgb3duIGN1c3RvbSBmdW5jdGlvbnMgdG8gdGhlIFVuZGVyc2NvcmUgb2JqZWN0LgogIF8ubWl4aW4gPSBmdW5jdGlvbiAob2JqKSB7CiAgICBlYWNoKF8uZnVuY3Rpb25zKG9iaiksIGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgIHZhciBmdW5jID0gX1tuYW1lXSA9IG9ialtuYW1lXTsKICAgICAgXy5wcm90b3R5cGVbbmFtZV0gPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIGFyZ3MgPSBbdGhpcy5fd3JhcHBlZF07CiAgICAgICAgcHVzaC5hcHBseShhcmdzLCBhcmd1bWVudHMpOwogICAgICAgIHJldHVybiByZXN1bHQuY2FsbCh0aGlzLCBmdW5jLmFwcGx5KF8sIGFyZ3MpKTsKICAgICAgfTsKICAgIH0pOwogIH07CiAgLy8gR2VuZXJhdGUgYSB1bmlxdWUgaW50ZWdlciBpZCAodW5pcXVlIHdpdGhpbiB0aGUgZW50aXJlIGNsaWVudCBzZXNzaW9uKS4KICAvLyBVc2VmdWwgZm9yIHRlbXBvcmFyeSBET00gaWRzLgogIHZhciBpZENvdW50ZXIgPSAwOwogIF8udW5pcXVlSWQgPSBmdW5jdGlvbiAocHJlZml4KSB7CiAgICB2YXIgaWQgPSArK2lkQ291bnRlciArICcnOwogICAgcmV0dXJuIHByZWZpeCA/IHByZWZpeCArIGlkIDogaWQ7CiAgfTsKICAvLyBCeSBkZWZhdWx0LCBVbmRlcnNjb3JlIHVzZXMgRVJCLXN0eWxlIHRlbXBsYXRlIGRlbGltaXRlcnMsIGNoYW5nZSB0aGUKICAvLyBmb2xsb3dpbmcgdGVtcGxhdGUgc2V0dGluZ3MgdG8gdXNlIGFsdGVybmF0aXZlIGRlbGltaXRlcnMuCiAgXy50ZW1wbGF0ZVNldHRpbmdzID0gewogICAgZXZhbHVhdGU6IC88JShbXHNcU10rPyklPi9nLAogICAgaW50ZXJwb2xhdGU6IC88JT0oW1xzXFNdKz8pJT4vZywKICAgIGVzY2FwZTogLzwlLShbXHNcU10rPyklPi9nCiAgfTsKICAvLyBXaGVuIGN1c3RvbWl6aW5nIGB0ZW1wbGF0ZVNldHRpbmdzYCwgaWYgeW91IGRvbid0IHdhbnQgdG8gZGVmaW5lIGFuCiAgLy8gaW50ZXJwb2xhdGlvbiwgZXZhbHVhdGlvbiBvciBlc2NhcGluZyByZWdleCwgd2UgbmVlZCBvbmUgdGhhdCBpcwogIC8vIGd1YXJhbnRlZWQgbm90IHRvIG1hdGNoLgogIHZhciBub01hdGNoID0gLyguKV4vOwogIC8vIENlcnRhaW4gY2hhcmFjdGVycyBuZWVkIHRvIGJlIGVzY2FwZWQgc28gdGhhdCB0aGV5IGNhbiBiZSBwdXQgaW50byBhCiAgLy8gc3RyaW5nIGxpdGVyYWwuCiAgdmFyIGVzY2FwZXMgPSB7CiAgICAnXCcnOiAnXCcnLAogICAgJ1xcJzogJ1xcJywKICAgICdccic6ICdyJywKICAgICdcbic6ICduJywKICAgICdcdCc6ICd0JywKICAgICdcdTIwMjgnOiAndTIwMjgnLAogICAgJ1x1MjAyOSc6ICd1MjAyOScKICB9OwogIHZhciBlc2NhcGVyID0gL1xcfCd8XHJ8XG58XHR8XHUyMDI4fFx1MjAyOS9nOwogIC8vIEphdmFTY3JpcHQgbWljcm8tdGVtcGxhdGluZywgc2ltaWxhciB0byBKb2huIFJlc2lnJ3MgaW1wbGVtZW50YXRpb24uCiAgLy8gVW5kZXJzY29yZSB0ZW1wbGF0aW5nIGhhbmRsZXMgYXJiaXRyYXJ5IGRlbGltaXRlcnMsIHByZXNlcnZlcyB3aGl0ZXNwYWNlLAogIC8vIGFuZCBjb3JyZWN0bHkgZXNjYXBlcyBxdW90ZXMgd2l0aGluIGludGVycG9sYXRlZCBjb2RlLgogIF8udGVtcGxhdGUgPSBmdW5jdGlvbiAodGV4dCwgZGF0YSwgc2V0dGluZ3MpIHsKICAgIHZhciByZW5kZXI7CiAgICBzZXR0aW5ncyA9IF8uZGVmYXVsdHMoe30sIHNldHRpbmdzLCBfLnRlbXBsYXRlU2V0dGluZ3MpOwogICAgLy8gQ29tYmluZSBkZWxpbWl0ZXJzIGludG8gb25lIHJlZ3VsYXIgZXhwcmVzc2lvbiB2aWEgYWx0ZXJuYXRpb24uCiAgICB2YXIgbWF0Y2hlciA9IG5ldyBSZWdFeHAoWwogICAgICAoc2V0dGluZ3MuZXNjYXBlIHx8IG5vTWF0Y2gpLnNvdXJjZSwKICAgICAgKHNldHRpbmdzLmludGVycG9sYXRlIHx8IG5vTWF0Y2gpLnNvdXJjZSwKICAgICAgKHNldHRpbmdzLmV2YWx1YXRlIHx8IG5vTWF0Y2gpLnNvdXJjZQogICAgXS5qb2luKCd8JykgKyAnfCQnLCAnZycpOwogICAgLy8gQ29tcGlsZSB0aGUgdGVtcGxhdGUgc291cmNlLCBlc2NhcGluZyBzdHJpbmcgbGl0ZXJhbHMgYXBwcm9wcmlhdGVseS4KICAgIHZhciBpbmRleCA9IDA7CiAgICB2YXIgc291cmNlID0gJ19fcCs9XCcnOwogICAgdGV4dC5yZXBsYWNlKG1hdGNoZXIsIGZ1bmN0aW9uIChtYXRjaCwgZXNjYXBlLCBpbnRlcnBvbGF0ZSwgZXZhbHVhdGUsIG9mZnNldCkgewogICAgICBzb3VyY2UgKz0gdGV4dC5zbGljZShpbmRleCwgb2Zmc2V0KS5yZXBsYWNlKGVzY2FwZXIsIGZ1bmN0aW9uIChtYXRjaCkgewogICAgICAgIHJldHVybiAnXFwnICsgZXNjYXBlc1ttYXRjaF07CiAgICAgIH0pOwogICAgICBpZiAoZXNjYXBlKSB7CiAgICAgICAgc291cmNlICs9ICdcJytcbigoX190PSgnICsgZXNjYXBlICsgJykpPT1udWxsP1wnXCc6Xy5lc2NhcGUoX190KSkrXG5cJyc7CiAgICAgIH0KICAgICAgaWYgKGludGVycG9sYXRlKSB7CiAgICAgICAgc291cmNlICs9ICdcJytcbigoX190PSgnICsgaW50ZXJwb2xhdGUgKyAnKSk9PW51bGw/XCdcJzpfX3QpK1xuXCcnOwogICAgICB9CiAgICAgIGlmIChldmFsdWF0ZSkgewogICAgICAgIHNvdXJjZSArPSAnXCc7XG4nICsgZXZhbHVhdGUgKyAnXG5fX3ArPVwnJzsKICAgICAgfQogICAgICBpbmRleCA9IG9mZnNldCArIG1hdGNoLmxlbmd0aDsKICAgICAgcmV0dXJuIG1hdGNoOwogICAgfSk7CiAgICBzb3VyY2UgKz0gJ1wnO1xuJzsKICAgIC8vIElmIGEgdmFyaWFibGUgaXMgbm90IHNwZWNpZmllZCwgcGxhY2UgZGF0YSB2YWx1ZXMgaW4gbG9jYWwgc2NvcGUuCiAgICBpZiAoIXNldHRpbmdzLnZhcmlhYmxlKQogICAgICBzb3VyY2UgPSAnd2l0aChvYmp8fHt9KXtcbicgKyBzb3VyY2UgKyAnfVxuJzsKICAgIHNvdXJjZSA9ICd2YXIgX190LF9fcD1cJ1wnLF9faj1BcnJheS5wcm90b3R5cGUuam9pbiwnICsgJ3ByaW50PWZ1bmN0aW9uKCl7X19wKz1fX2ouY2FsbChhcmd1bWVudHMsXCdcJyk7fTtcbicgKyBzb3VyY2UgKyAncmV0dXJuIF9fcDtcbic7CiAgICB0cnkgewogICAgICByZW5kZXIgPSBuZXcgRnVuY3Rpb24oc2V0dGluZ3MudmFyaWFibGUgfHwgJ29iaicsICdfJywgc291cmNlKTsKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgZS5zb3VyY2UgPSBzb3VyY2U7CiAgICAgIHRocm93IGU7CiAgICB9CiAgICBpZiAoZGF0YSkKICAgICAgcmV0dXJuIHJlbmRlcihkYXRhLCBfKTsKICAgIHZhciB0ZW1wbGF0ZSA9IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgIHJldHVybiByZW5kZXIuY2FsbCh0aGlzLCBkYXRhLCBfKTsKICAgIH07CiAgICAvLyBQcm92aWRlIHRoZSBjb21waWxlZCBmdW5jdGlvbiBzb3VyY2UgYXMgYSBjb252ZW5pZW5jZSBmb3IgcHJlY29tcGlsYXRpb24uCiAgICB0ZW1wbGF0ZS5zb3VyY2UgPSAnZnVuY3Rpb24oJyArIChzZXR0aW5ncy52YXJpYWJsZSB8fCAnb2JqJykgKyAnKXtcbicgKyBzb3VyY2UgKyAnfSc7CiAgICByZXR1cm4gdGVtcGxhdGU7CiAgfTsKICAvLyBBZGQgYSAiY2hhaW4iIGZ1bmN0aW9uLCB3aGljaCB3aWxsIGRlbGVnYXRlIHRvIHRoZSB3cmFwcGVyLgogIF8uY2hhaW4gPSBmdW5jdGlvbiAob2JqKSB7CiAgICByZXR1cm4gXyhvYmopLmNoYWluKCk7CiAgfTsKICAvLyBPT1AKICAvLyAtLS0tLS0tLS0tLS0tLS0KICAvLyBJZiBVbmRlcnNjb3JlIGlzIGNhbGxlZCBhcyBhIGZ1bmN0aW9uLCBpdCByZXR1cm5zIGEgd3JhcHBlZCBvYmplY3QgdGhhdAogIC8vIGNhbiBiZSB1c2VkIE9PLXN0eWxlLiBUaGlzIHdyYXBwZXIgaG9sZHMgYWx0ZXJlZCB2ZXJzaW9ucyBvZiBhbGwgdGhlCiAgLy8gdW5kZXJzY29yZSBmdW5jdGlvbnMuIFdyYXBwZWQgb2JqZWN0cyBtYXkgYmUgY2hhaW5lZC4KICAvLyBIZWxwZXIgZnVuY3Rpb24gdG8gY29udGludWUgY2hhaW5pbmcgaW50ZXJtZWRpYXRlIHJlc3VsdHMuCiAgdmFyIHJlc3VsdCA9IGZ1bmN0aW9uIChvYmopIHsKICAgIHJldHVybiB0aGlzLl9jaGFpbiA/IF8ob2JqKS5jaGFpbigpIDogb2JqOwogIH07CiAgLy8gQWRkIGFsbCBvZiB0aGUgVW5kZXJzY29yZSBmdW5jdGlvbnMgdG8gdGhlIHdyYXBwZXIgb2JqZWN0LgogIF8ubWl4aW4oXyk7CiAgLy8gQWRkIGFsbCBtdXRhdG9yIEFycmF5IGZ1bmN0aW9ucyB0byB0aGUgd3JhcHBlci4KICBlYWNoKFsKICAgICdwb3AnLAogICAgJ3B1c2gnLAogICAgJ3JldmVyc2UnLAogICAgJ3NoaWZ0JywKICAgICdzb3J0JywKICAgICdzcGxpY2UnLAogICAgJ3Vuc2hpZnQnCiAgXSwgZnVuY3Rpb24gKG5hbWUpIHsKICAgIHZhciBtZXRob2QgPSBBcnJheVByb3RvW25hbWVdOwogICAgXy5wcm90b3R5cGVbbmFtZV0gPSBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBvYmogPSB0aGlzLl93cmFwcGVkOwogICAgICBtZXRob2QuYXBwbHkob2JqLCBhcmd1bWVudHMpOwogICAgICBpZiAoKG5hbWUgPT0gJ3NoaWZ0JyB8fCBuYW1lID09ICdzcGxpY2UnKSAmJiBvYmoubGVuZ3RoID09PSAwKQogICAgICAgIGRlbGV0ZSBvYmpbMF07CiAgICAgIHJldHVybiByZXN1bHQuY2FsbCh0aGlzLCBvYmopOwogICAgfTsKICB9KTsKICAvLyBBZGQgYWxsIGFjY2Vzc29yIEFycmF5IGZ1bmN0aW9ucyB0byB0aGUgd3JhcHBlci4KICBlYWNoKFsKICAgICdjb25jYXQnLAogICAgJ2pvaW4nLAogICAgJ3NsaWNlJwogIF0sIGZ1bmN0aW9uIChuYW1lKSB7CiAgICB2YXIgbWV0aG9kID0gQXJyYXlQcm90b1tuYW1lXTsKICAgIF8ucHJvdG90eXBlW25hbWVdID0gZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gcmVzdWx0LmNhbGwodGhpcywgbWV0aG9kLmFwcGx5KHRoaXMuX3dyYXBwZWQsIGFyZ3VtZW50cykpOwogICAgfTsKICB9KTsKICBfLmV4dGVuZChfLnByb3RvdHlwZSwgewogICAgLy8gU3RhcnQgY2hhaW5pbmcgYSB3cmFwcGVkIFVuZGVyc2NvcmUgb2JqZWN0LgogICAgY2hhaW46IGZ1bmN0aW9uICgpIHsKICAgICAgdGhpcy5fY2hhaW4gPSB0cnVlOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgICAvLyBFeHRyYWN0cyB0aGUgcmVzdWx0IGZyb20gYSB3cmFwcGVkIGFuZCBjaGFpbmVkIG9iamVjdC4KICAgIHZhbHVlOiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiB0aGlzLl93cmFwcGVkOwogICAgfQogIH0pOwogIC8vIEFNRCByZWdpc3RyYXRpb24gaGFwcGVucyBhdCB0aGUgZW5kIGZvciBjb21wYXRpYmlsaXR5IHdpdGggQU1EIGxvYWRlcnMKICAvLyB0aGF0IG1heSBub3QgZW5mb3JjZSBuZXh0LXR1cm4gc2VtYW50aWNzIG9uIG1vZHVsZXMuIEV2ZW4gdGhvdWdoIGdlbmVyYWwKICAvLyBwcmFjdGljZSBmb3IgQU1EIHJlZ2lzdHJhdGlvbiBpcyB0byBiZSBhbm9ueW1vdXMsIHVuZGVyc2NvcmUgcmVnaXN0ZXJzCiAgLy8gYXMgYSBuYW1lZCBtb2R1bGUgYmVjYXVzZSwgbGlrZSBqUXVlcnksIGl0IGlzIGEgYmFzZSBsaWJyYXJ5IHRoYXQgaXMKICAvLyBwb3B1bGFyIGVub3VnaCB0byBiZSBidW5kbGVkIGluIGEgdGhpcmQgcGFydHkgbGliLCBidXQgbm90IGJlIHBhcnQgb2YKICAvLyBhbiBBTUQgbG9hZCByZXF1ZXN0LiBUaG9zZSBjYXNlcyBjb3VsZCBnZW5lcmF0ZSBhbiBlcnJvciB3aGVuIGFuCiAgLy8gYW5vbnltb3VzIGRlZmluZSgpIGlzIGNhbGxlZCBvdXRzaWRlIG9mIGEgbG9hZGVyIHJlcXVlc3QuCiAgaWYgKHRydWUpIHsKICAgIHVuZGVyc2NvcmUgPSBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBfOwogICAgfSgpOwogIH0KfS5jYWxsKHRoaXMpKTsKLyohCiAqIGpRdWVyeSBKYXZhU2NyaXB0IExpYnJhcnkgdjIuMS4xCiAqIGh0dHA6Ly9qcXVlcnkuY29tLwogKgogKiBJbmNsdWRlcyBTaXp6bGUuanMKICogaHR0cDovL3NpenpsZWpzLmNvbS8KICoKICogQ29weXJpZ2h0IDIwMDUsIDIwMTQgalF1ZXJ5IEZvdW5kYXRpb24sIEluYy4gYW5kIG90aGVyIGNvbnRyaWJ1dG9ycwogKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UKICogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQogKgogKiBEYXRlOiAyMDE0LTA1LTAxVDE3OjExWgogKi8KKGZ1bmN0aW9uIChnbG9iYWwsIGZhY3RvcnkpIHsKICBpZiAodHlwZW9mIG1vZHVsZSA9PT0gJ29iamVjdCcgJiYgdHlwZW9mIG1vZHVsZS5leHBvcnRzID09PSAnb2JqZWN0JykgewogICAgLy8gRm9yIENvbW1vbkpTIGFuZCBDb21tb25KUy1saWtlIGVudmlyb25tZW50cyB3aGVyZSBhIHByb3BlciB3aW5kb3cgaXMgcHJlc2VudCwKICAgIC8vIGV4ZWN1dGUgdGhlIGZhY3RvcnkgYW5kIGdldCBqUXVlcnkKICAgIC8vIEZvciBlbnZpcm9ubWVudHMgdGhhdCBkbyBub3QgaW5oZXJlbnRseSBwb3NzZXMgYSB3aW5kb3cgd2l0aCBhIGRvY3VtZW50CiAgICAvLyAoc3VjaCBhcyBOb2RlLmpzKSwgZXhwb3NlIGEgalF1ZXJ5LW1ha2luZyBmYWN0b3J5IGFzIG1vZHVsZS5leHBvcnRzCiAgICAvLyBUaGlzIGFjY2VudHVhdGVzIHRoZSBuZWVkIGZvciB0aGUgY3JlYXRpb24gb2YgYSByZWFsIHdpbmRvdwogICAgLy8gZS5nLiB2YXIgalF1ZXJ5ID0gcmVxdWlyZSgianF1ZXJ5Iikod2luZG93KTsKICAgIC8vIFNlZSB0aWNrZXQgIzE0NTQ5IGZvciBtb3JlIGluZm8KICAgIG1vZHVsZS5leHBvcnRzID0gZ2xvYmFsLmRvY3VtZW50ID8gZmFjdG9yeShnbG9iYWwsIHRydWUpIDogZnVuY3Rpb24gKHcpIHsKICAgICAgaWYgKCF3LmRvY3VtZW50KSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdqUXVlcnkgcmVxdWlyZXMgYSB3aW5kb3cgd2l0aCBhIGRvY3VtZW50Jyk7CiAgICAgIH0KICAgICAgcmV0dXJuIGZhY3Rvcnkodyk7CiAgICB9OwogIH0gZWxzZSB7CiAgICBmYWN0b3J5KGdsb2JhbCk7CiAgfSAgLy8gUGFzcyB0aGlzIGlmIHdpbmRvdyBpcyBub3QgZGVmaW5lZCB5ZXQKfSh0eXBlb2Ygd2luZG93ICE9PSAndW5kZWZpbmVkJyA/IHdpbmRvdyA6IHRoaXMsIGZ1bmN0aW9uICh3aW5kb3csIG5vR2xvYmFsKSB7CiAgLy8gQ2FuJ3QgZG8gdGhpcyBiZWNhdXNlIHNldmVyYWwgYXBwcyBpbmNsdWRpbmcgQVNQLk5FVCB0cmFjZQogIC8vIHRoZSBzdGFjayB2aWEgYXJndW1lbnRzLmNhbGxlci5jYWxsZWUgYW5kIEZpcmVmb3ggZGllcyBpZgogIC8vIHlvdSB0cnkgdG8gdHJhY2UgdGhyb3VnaCAidXNlIHN0cmljdCIgY2FsbCBjaGFpbnMuICgjMTMzMzUpCiAgLy8gU3VwcG9ydDogRmlyZWZveCAxOCsKICAvLwogIHZhciBhcnIgPSBbXTsKICB2YXIgc2xpY2UgPSBhcnIuc2xpY2U7CiAgdmFyIGNvbmNhdCA9IGFyci5jb25jYXQ7CiAgdmFyIHB1c2ggPSBhcnIucHVzaDsKICB2YXIgaW5kZXhPZiA9IGFyci5pbmRleE9mOwogIHZhciBjbGFzczJ0eXBlID0ge307CiAgdmFyIHRvU3RyaW5nID0gY2xhc3MydHlwZS50b1N0cmluZzsKICB2YXIgaGFzT3duID0gY2xhc3MydHlwZS5oYXNPd25Qcm9wZXJ0eTsKICB2YXIgc3VwcG9ydCA9IHt9OwogIHZhcgogICAgLy8gVXNlIHRoZSBjb3JyZWN0IGRvY3VtZW50IGFjY29yZGluZ2x5IHdpdGggd2luZG93IGFyZ3VtZW50IChzYW5kYm94KQogICAgZG9jdW1lbnQgPSB3aW5kb3cuZG9jdW1lbnQsIHZlcnNpb24gPSAnMi4xLjEnLAogICAgLy8gRGVmaW5lIGEgbG9jYWwgY29weSBvZiBqUXVlcnkKICAgIGpRdWVyeSA9IGZ1bmN0aW9uIChzZWxlY3RvciwgY29udGV4dCkgewogICAgICAvLyBUaGUgalF1ZXJ5IG9iamVjdCBpcyBhY3R1YWxseSBqdXN0IHRoZSBpbml0IGNvbnN0cnVjdG9yICdlbmhhbmNlZCcKICAgICAgLy8gTmVlZCBpbml0IGlmIGpRdWVyeSBpcyBjYWxsZWQgKGp1c3QgYWxsb3cgZXJyb3IgdG8gYmUgdGhyb3duIGlmIG5vdCBpbmNsdWRlZCkKICAgICAgcmV0dXJuIG5ldyBqUXVlcnkuZm4uaW5pdChzZWxlY3RvciwgY29udGV4dCk7CiAgICB9LAogICAgLy8gU3VwcG9ydDogQW5kcm9pZDw0LjEKICAgIC8vIE1ha2Ugc3VyZSB3ZSB0cmltIEJPTSBhbmQgTkJTUAogICAgcnRyaW0gPSAvXltcc1x1RkVGRlx4QTBdK3xbXHNcdUZFRkZceEEwXSskL2csCiAgICAvLyBNYXRjaGVzIGRhc2hlZCBzdHJpbmcgZm9yIGNhbWVsaXppbmcKICAgIHJtc1ByZWZpeCA9IC9eLW1zLS8sIHJkYXNoQWxwaGEgPSAvLShbXGRhLXpdKS9naSwKICAgIC8vIFVzZWQgYnkgalF1ZXJ5LmNhbWVsQ2FzZSBhcyBjYWxsYmFjayB0byByZXBsYWNlKCkKICAgIGZjYW1lbENhc2UgPSBmdW5jdGlvbiAoYWxsLCBsZXR0ZXIpIHsKICAgICAgcmV0dXJuIGxldHRlci50b1VwcGVyQ2FzZSgpOwogICAgfTsKICBqUXVlcnkuZm4gPSBqUXVlcnkucHJvdG90eXBlID0gewogICAgLy8gVGhlIGN1cnJlbnQgdmVyc2lvbiBvZiBqUXVlcnkgYmVpbmcgdXNlZAogICAganF1ZXJ5OiB2ZXJzaW9uLAogICAgY29uc3RydWN0b3I6IGpRdWVyeSwKICAgIC8vIFN0YXJ0IHdpdGggYW4gZW1wdHkgc2VsZWN0b3IKICAgIHNlbGVjdG9yOiAnJywKICAgIC8vIFRoZSBkZWZhdWx0IGxlbmd0aCBvZiBhIGpRdWVyeSBvYmplY3QgaXMgMAogICAgbGVuZ3RoOiAwLAogICAgdG9BcnJheTogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gc2xpY2UuY2FsbCh0aGlzKTsKICAgIH0sCiAgICAvLyBHZXQgdGhlIE50aCBlbGVtZW50IGluIHRoZSBtYXRjaGVkIGVsZW1lbnQgc2V0IE9SCiAgICAvLyBHZXQgdGhlIHdob2xlIG1hdGNoZWQgZWxlbWVudCBzZXQgYXMgYSBjbGVhbiBhcnJheQogICAgZ2V0OiBmdW5jdGlvbiAobnVtKSB7CiAgICAgIHJldHVybiBudW0gIT0gbnVsbCA/IG51bSA8IDAgPyB0aGlzW251bSArIHRoaXMubGVuZ3RoXSA6IHRoaXNbbnVtXSA6IC8vIFJldHVybiBhbGwgdGhlIGVsZW1lbnRzIGluIGEgY2xlYW4gYXJyYXkKICAgICAgc2xpY2UuY2FsbCh0aGlzKTsKICAgIH0sCiAgICAvLyBUYWtlIGFuIGFycmF5IG9mIGVsZW1lbnRzIGFuZCBwdXNoIGl0IG9udG8gdGhlIHN0YWNrCiAgICAvLyAocmV0dXJuaW5nIHRoZSBuZXcgbWF0Y2hlZCBlbGVtZW50IHNldCkKICAgIHB1c2hTdGFjazogZnVuY3Rpb24gKGVsZW1zKSB7CiAgICAgIC8vIEJ1aWxkIGEgbmV3IGpRdWVyeSBtYXRjaGVkIGVsZW1lbnQgc2V0CiAgICAgIHZhciByZXQgPSBqUXVlcnkubWVyZ2UodGhpcy5jb25zdHJ1Y3RvcigpLCBlbGVtcyk7CiAgICAgIC8vIEFkZCB0aGUgb2xkIG9iamVjdCBvbnRvIHRoZSBzdGFjayAoYXMgYSByZWZlcmVuY2UpCiAgICAgIHJldC5wcmV2T2JqZWN0ID0gdGhpczsKICAgICAgcmV0LmNvbnRleHQgPSB0aGlzLmNvbnRleHQ7CiAgICAgIC8vIFJldHVybiB0aGUgbmV3bHktZm9ybWVkIGVsZW1lbnQgc2V0CiAgICAgIHJldHVybiByZXQ7CiAgICB9LAogICAgLy8gRXhlY3V0ZSBhIGNhbGxiYWNrIGZvciBldmVyeSBlbGVtZW50IGluIHRoZSBtYXRjaGVkIHNldC4KICAgIC8vIChZb3UgY2FuIHNlZWQgdGhlIGFyZ3VtZW50cyB3aXRoIGFuIGFycmF5IG9mIGFyZ3MsIGJ1dCB0aGlzIGlzCiAgICAvLyBvbmx5IHVzZWQgaW50ZXJuYWxseS4pCiAgICBlYWNoOiBmdW5jdGlvbiAoY2FsbGJhY2ssIGFyZ3MpIHsKICAgICAgcmV0dXJuIGpRdWVyeS5lYWNoKHRoaXMsIGNhbGxiYWNrLCBhcmdzKTsKICAgIH0sCiAgICBtYXA6IGZ1bmN0aW9uIChjYWxsYmFjaykgewogICAgICByZXR1cm4gdGhpcy5wdXNoU3RhY2soalF1ZXJ5Lm1hcCh0aGlzLCBmdW5jdGlvbiAoZWxlbSwgaSkgewogICAgICAgIHJldHVybiBjYWxsYmFjay5jYWxsKGVsZW0sIGksIGVsZW0pOwogICAgICB9KSk7CiAgICB9LAogICAgc2xpY2U6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIHRoaXMucHVzaFN0YWNrKHNsaWNlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykpOwogICAgfSwKICAgIGZpcnN0OiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiB0aGlzLmVxKDApOwogICAgfSwKICAgIGxhc3Q6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIHRoaXMuZXEoLTEpOwogICAgfSwKICAgIGVxOiBmdW5jdGlvbiAoaSkgewogICAgICB2YXIgbGVuID0gdGhpcy5sZW5ndGgsIGogPSAraSArIChpIDwgMCA/IGxlbiA6IDApOwogICAgICByZXR1cm4gdGhpcy5wdXNoU3RhY2soaiA+PSAwICYmIGogPCBsZW4gPyBbdGhpc1tqXV0gOiBbXSk7CiAgICB9LAogICAgZW5kOiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiB0aGlzLnByZXZPYmplY3QgfHwgdGhpcy5jb25zdHJ1Y3RvcihudWxsKTsKICAgIH0sCiAgICAvLyBGb3IgaW50ZXJuYWwgdXNlIG9ubHkuCiAgICAvLyBCZWhhdmVzIGxpa2UgYW4gQXJyYXkncyBtZXRob2QsIG5vdCBsaWtlIGEgalF1ZXJ5IG1ldGhvZC4KICAgIHB1c2g6IHB1c2gsCiAgICBzb3J0OiBhcnIuc29ydCwKICAgIHNwbGljZTogYXJyLnNwbGljZQogIH07CiAgalF1ZXJ5LmV4dGVuZCA9IGpRdWVyeS5mbi5leHRlbmQgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgb3B0aW9ucywgbmFtZSwgc3JjLCBjb3B5LCBjb3B5SXNBcnJheSwgY2xvbmUsIHRhcmdldCA9IGFyZ3VtZW50c1swXSB8fCB7fSwgaSA9IDEsIGxlbmd0aCA9IGFyZ3VtZW50cy5sZW5ndGgsIGRlZXAgPSBmYWxzZTsKICAgIC8vIEhhbmRsZSBhIGRlZXAgY29weSBzaXR1YXRpb24KICAgIGlmICh0eXBlb2YgdGFyZ2V0ID09PSAnYm9vbGVhbicpIHsKICAgICAgZGVlcCA9IHRhcmdldDsKICAgICAgLy8gc2tpcCB0aGUgYm9vbGVhbiBhbmQgdGhlIHRhcmdldAogICAgICB0YXJnZXQgPSBhcmd1bWVudHNbaV0gfHwge307CiAgICAgIGkrKzsKICAgIH0KICAgIC8vIEhhbmRsZSBjYXNlIHdoZW4gdGFyZ2V0IGlzIGEgc3RyaW5nIG9yIHNvbWV0aGluZyAocG9zc2libGUgaW4gZGVlcCBjb3B5KQogICAgaWYgKHR5cGVvZiB0YXJnZXQgIT09ICdvYmplY3QnICYmICFqUXVlcnkuaXNGdW5jdGlvbih0YXJnZXQpKSB7CiAgICAgIHRhcmdldCA9IHt9OwogICAgfQogICAgLy8gZXh0ZW5kIGpRdWVyeSBpdHNlbGYgaWYgb25seSBvbmUgYXJndW1lbnQgaXMgcGFzc2VkCiAgICBpZiAoaSA9PT0gbGVuZ3RoKSB7CiAgICAgIHRhcmdldCA9IHRoaXM7CiAgICAgIGktLTsKICAgIH0KICAgIGZvciAoOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgLy8gT25seSBkZWFsIHdpdGggbm9uLW51bGwvdW5kZWZpbmVkIHZhbHVlcwogICAgICBpZiAoKG9wdGlvbnMgPSBhcmd1bWVudHNbaV0pICE9IG51bGwpIHsKICAgICAgICAvLyBFeHRlbmQgdGhlIGJhc2Ugb2JqZWN0CiAgICAgICAgZm9yIChuYW1lIGluIG9wdGlvbnMpIHsKICAgICAgICAgIHNyYyA9IHRhcmdldFtuYW1lXTsKICAgICAgICAgIGNvcHkgPSBvcHRpb25zW25hbWVdOwogICAgICAgICAgLy8gUHJldmVudCBuZXZlci1lbmRpbmcgbG9vcAogICAgICAgICAgaWYgKHRhcmdldCA9PT0gY29weSkgewogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KICAgICAgICAgIC8vIFJlY3Vyc2UgaWYgd2UncmUgbWVyZ2luZyBwbGFpbiBvYmplY3RzIG9yIGFycmF5cwogICAgICAgICAgaWYgKGRlZXAgJiYgY29weSAmJiAoalF1ZXJ5LmlzUGxhaW5PYmplY3QoY29weSkgfHwgKGNvcHlJc0FycmF5ID0galF1ZXJ5LmlzQXJyYXkoY29weSkpKSkgewogICAgICAgICAgICBpZiAoY29weUlzQXJyYXkpIHsKICAgICAgICAgICAgICBjb3B5SXNBcnJheSA9IGZhbHNlOwogICAgICAgICAgICAgIGNsb25lID0gc3JjICYmIGpRdWVyeS5pc0FycmF5KHNyYykgPyBzcmMgOiBbXTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBjbG9uZSA9IHNyYyAmJiBqUXVlcnkuaXNQbGFpbk9iamVjdChzcmMpID8gc3JjIDoge307CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gTmV2ZXIgbW92ZSBvcmlnaW5hbCBvYmplY3RzLCBjbG9uZSB0aGVtCiAgICAgICAgICAgIHRhcmdldFtuYW1lXSA9IGpRdWVyeS5leHRlbmQoZGVlcCwgY2xvbmUsIGNvcHkpOyAgLy8gRG9uJ3QgYnJpbmcgaW4gdW5kZWZpbmVkIHZhbHVlcwogICAgICAgICAgfSBlbHNlIGlmIChjb3B5ICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgdGFyZ2V0W25hbWVdID0gY29weTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIC8vIFJldHVybiB0aGUgbW9kaWZpZWQgb2JqZWN0CiAgICByZXR1cm4gdGFyZ2V0OwogIH07CiAgalF1ZXJ5LmV4dGVuZCh7CiAgICAvLyBVbmlxdWUgZm9yIGVhY2ggY29weSBvZiBqUXVlcnkgb24gdGhlIHBhZ2UKICAgIGV4cGFuZG86ICdqUXVlcnknICsgKHZlcnNpb24gKyBNYXRoLnJhbmRvbSgpKS5yZXBsYWNlKC9cRC9nLCAnJyksCiAgICAvLyBBc3N1bWUgalF1ZXJ5IGlzIHJlYWR5IHdpdGhvdXQgdGhlIHJlYWR5IG1vZHVsZQogICAgaXNSZWFkeTogdHJ1ZSwKICAgIGVycm9yOiBmdW5jdGlvbiAobXNnKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcihtc2cpOwogICAgfSwKICAgIG5vb3A6IGZ1bmN0aW9uICgpIHsKICAgIH0sCiAgICAvLyBTZWUgdGVzdC91bml0L2NvcmUuanMgZm9yIGRldGFpbHMgY29uY2VybmluZyBpc0Z1bmN0aW9uLgogICAgLy8gU2luY2UgdmVyc2lvbiAxLjMsIERPTSBtZXRob2RzIGFuZCBmdW5jdGlvbnMgbGlrZSBhbGVydAogICAgLy8gYXJlbid0IHN1cHBvcnRlZC4gVGhleSByZXR1cm4gZmFsc2Ugb24gSUUgKCMyOTY4KS4KICAgIGlzRnVuY3Rpb246IGZ1bmN0aW9uIChvYmopIHsKICAgICAgcmV0dXJuIGpRdWVyeS50eXBlKG9iaikgPT09ICdmdW5jdGlvbic7CiAgICB9LAogICAgaXNBcnJheTogQXJyYXkuaXNBcnJheSwKICAgIGlzV2luZG93OiBmdW5jdGlvbiAob2JqKSB7CiAgICAgIHJldHVybiBvYmogIT0gbnVsbCAmJiBvYmogPT09IG9iai53aW5kb3c7CiAgICB9LAogICAgaXNOdW1lcmljOiBmdW5jdGlvbiAob2JqKSB7CiAgICAgIC8vIHBhcnNlRmxvYXQgTmFOcyBudW1lcmljLWNhc3QgZmFsc2UgcG9zaXRpdmVzIChudWxsfHRydWV8ZmFsc2V8IiIpCiAgICAgIC8vIC4uLmJ1dCBtaXNpbnRlcnByZXRzIGxlYWRpbmctbnVtYmVyIHN0cmluZ3MsIHBhcnRpY3VsYXJseSBoZXggbGl0ZXJhbHMgKCIweC4uLiIpCiAgICAgIC8vIHN1YnRyYWN0aW9uIGZvcmNlcyBpbmZpbml0aWVzIHRvIE5hTgogICAgICByZXR1cm4gIWpRdWVyeS5pc0FycmF5KG9iaikgJiYgb2JqIC0gcGFyc2VGbG9hdChvYmopID49IDA7CiAgICB9LAogICAgaXNQbGFpbk9iamVjdDogZnVuY3Rpb24gKG9iaikgewogICAgICAvLyBOb3QgcGxhaW4gb2JqZWN0czoKICAgICAgLy8gLSBBbnkgb2JqZWN0IG9yIHZhbHVlIHdob3NlIGludGVybmFsIFtbQ2xhc3NdXSBwcm9wZXJ0eSBpcyBub3QgIltvYmplY3QgT2JqZWN0XSIKICAgICAgLy8gLSBET00gbm9kZXMKICAgICAgLy8gLSB3aW5kb3cKICAgICAgaWYgKGpRdWVyeS50eXBlKG9iaikgIT09ICdvYmplY3QnIHx8IG9iai5ub2RlVHlwZSB8fCBqUXVlcnkuaXNXaW5kb3cob2JqKSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICBpZiAob2JqLmNvbnN0cnVjdG9yICYmICFoYXNPd24uY2FsbChvYmouY29uc3RydWN0b3IucHJvdG90eXBlLCAnaXNQcm90b3R5cGVPZicpKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIC8vIElmIHRoZSBmdW5jdGlvbiBoYXNuJ3QgcmV0dXJuZWQgYWxyZWFkeSwgd2UncmUgY29uZmlkZW50IHRoYXQKICAgICAgLy8gfG9ianwgaXMgYSBwbGFpbiBvYmplY3QsIGNyZWF0ZWQgYnkge30gb3IgY29uc3RydWN0ZWQgd2l0aCBuZXcgT2JqZWN0CiAgICAgIHJldHVybiB0cnVlOwogICAgfSwKICAgIGlzRW1wdHlPYmplY3Q6IGZ1bmN0aW9uIChvYmopIHsKICAgICAgdmFyIG5hbWU7CiAgICAgIGZvciAobmFtZSBpbiBvYmopIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgICAgcmV0dXJuIHRydWU7CiAgICB9LAogICAgdHlwZTogZnVuY3Rpb24gKG9iaikgewogICAgICBpZiAob2JqID09IG51bGwpIHsKICAgICAgICByZXR1cm4gb2JqICsgJyc7CiAgICAgIH0KICAgICAgLy8gU3VwcG9ydDogQW5kcm9pZCA8IDQuMCwgaU9TIDwgNiAoZnVuY3Rpb25pc2ggUmVnRXhwKQogICAgICByZXR1cm4gdHlwZW9mIG9iaiA9PT0gJ29iamVjdCcgfHwgdHlwZW9mIG9iaiA9PT0gJ2Z1bmN0aW9uJyA/IGNsYXNzMnR5cGVbdG9TdHJpbmcuY2FsbChvYmopXSB8fCAnb2JqZWN0JyA6IHR5cGVvZiBvYmo7CiAgICB9LAogICAgLy8gRXZhbHVhdGVzIGEgc2NyaXB0IGluIGEgZ2xvYmFsIGNvbnRleHQKICAgIGdsb2JhbEV2YWw6IGZ1bmN0aW9uIChjb2RlKSB7CiAgICAgIHZhciBzY3JpcHQsIGluZGlyZWN0ID0gZXZhbDsKICAgICAgY29kZSA9IGpRdWVyeS50cmltKGNvZGUpOwogICAgICBpZiAoY29kZSkgewogICAgICAgIC8vIElmIHRoZSBjb2RlIGluY2x1ZGVzIGEgdmFsaWQsIHByb2xvZ3VlIHBvc2l0aW9uCiAgICAgICAgLy8gc3RyaWN0IG1vZGUgcHJhZ21hLCBleGVjdXRlIGNvZGUgYnkgaW5qZWN0aW5nIGEKICAgICAgICAvLyBzY3JpcHQgdGFnIGludG8gdGhlIGRvY3VtZW50LgogICAgICAgIGlmIChjb2RlLmluZGV4T2YoJ3VzZSBzdHJpY3QnKSA9PT0gMSkgewogICAgICAgICAgc2NyaXB0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc2NyaXB0Jyk7CiAgICAgICAgICBzY3JpcHQudGV4dCA9IGNvZGU7CiAgICAgICAgICBkb2N1bWVudC5oZWFkLmFwcGVuZENoaWxkKHNjcmlwdCkucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChzY3JpcHQpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAvLyBPdGhlcndpc2UsIGF2b2lkIHRoZSBET00gbm9kZSBjcmVhdGlvbiwgaW5zZXJ0aW9uCiAgICAgICAgICAvLyBhbmQgcmVtb3ZhbCBieSB1c2luZyBhbiBpbmRpcmVjdCBnbG9iYWwgZXZhbAogICAgICAgICAgaW5kaXJlY3QoY29kZSk7CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgLy8gQ29udmVydCBkYXNoZWQgdG8gY2FtZWxDYXNlOyB1c2VkIGJ5IHRoZSBjc3MgYW5kIGRhdGEgbW9kdWxlcwogICAgLy8gTWljcm9zb2Z0IGZvcmdvdCB0byBodW1wIHRoZWlyIHZlbmRvciBwcmVmaXggKCM5NTcyKQogICAgY2FtZWxDYXNlOiBmdW5jdGlvbiAoc3RyaW5nKSB7CiAgICAgIHJldHVybiBzdHJpbmcucmVwbGFjZShybXNQcmVmaXgsICdtcy0nKS5yZXBsYWNlKHJkYXNoQWxwaGEsIGZjYW1lbENhc2UpOwogICAgfSwKICAgIG5vZGVOYW1lOiBmdW5jdGlvbiAoZWxlbSwgbmFtZSkgewogICAgICByZXR1cm4gZWxlbS5ub2RlTmFtZSAmJiBlbGVtLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09IG5hbWUudG9Mb3dlckNhc2UoKTsKICAgIH0sCiAgICAvLyBhcmdzIGlzIGZvciBpbnRlcm5hbCB1c2FnZSBvbmx5CiAgICBlYWNoOiBmdW5jdGlvbiAob2JqLCBjYWxsYmFjaywgYXJncykgewogICAgICB2YXIgdmFsdWUsIGkgPSAwLCBsZW5ndGggPSBvYmoubGVuZ3RoLCBpc0FycmF5ID0gaXNBcnJheWxpa2Uob2JqKTsKICAgICAgaWYgKGFyZ3MpIHsKICAgICAgICBpZiAoaXNBcnJheSkgewogICAgICAgICAgZm9yICg7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgICB2YWx1ZSA9IGNhbGxiYWNrLmFwcGx5KG9ialtpXSwgYXJncyk7CiAgICAgICAgICAgIGlmICh2YWx1ZSA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBmb3IgKGkgaW4gb2JqKSB7CiAgICAgICAgICAgIHZhbHVlID0gY2FsbGJhY2suYXBwbHkob2JqW2ldLCBhcmdzKTsKICAgICAgICAgICAgaWYgKHZhbHVlID09PSBmYWxzZSkgewogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSAgLy8gQSBzcGVjaWFsLCBmYXN0LCBjYXNlIGZvciB0aGUgbW9zdCBjb21tb24gdXNlIG9mIGVhY2gKICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAoaXNBcnJheSkgewogICAgICAgICAgZm9yICg7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgICB2YWx1ZSA9IGNhbGxiYWNrLmNhbGwob2JqW2ldLCBpLCBvYmpbaV0pOwogICAgICAgICAgICBpZiAodmFsdWUgPT09IGZhbHNlKSB7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgZm9yIChpIGluIG9iaikgewogICAgICAgICAgICB2YWx1ZSA9IGNhbGxiYWNrLmNhbGwob2JqW2ldLCBpLCBvYmpbaV0pOwogICAgICAgICAgICBpZiAodmFsdWUgPT09IGZhbHNlKSB7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIG9iajsKICAgIH0sCiAgICAvLyBTdXBwb3J0OiBBbmRyb2lkPDQuMQogICAgdHJpbTogZnVuY3Rpb24gKHRleHQpIHsKICAgICAgcmV0dXJuIHRleHQgPT0gbnVsbCA/ICcnIDogKHRleHQgKyAnJykucmVwbGFjZShydHJpbSwgJycpOwogICAgfSwKICAgIC8vIHJlc3VsdHMgaXMgZm9yIGludGVybmFsIHVzYWdlIG9ubHkKICAgIG1ha2VBcnJheTogZnVuY3Rpb24gKGFyciwgcmVzdWx0cykgewogICAgICB2YXIgcmV0ID0gcmVzdWx0cyB8fCBbXTsKICAgICAgaWYgKGFyciAhPSBudWxsKSB7CiAgICAgICAgaWYgKGlzQXJyYXlsaWtlKE9iamVjdChhcnIpKSkgewogICAgICAgICAgalF1ZXJ5Lm1lcmdlKHJldCwgdHlwZW9mIGFyciA9PT0gJ3N0cmluZycgPyBbYXJyXSA6IGFycik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHB1c2guY2FsbChyZXQsIGFycik7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiByZXQ7CiAgICB9LAogICAgaW5BcnJheTogZnVuY3Rpb24gKGVsZW0sIGFyciwgaSkgewogICAgICByZXR1cm4gYXJyID09IG51bGwgPyAtMSA6IGluZGV4T2YuY2FsbChhcnIsIGVsZW0sIGkpOwogICAgfSwKICAgIG1lcmdlOiBmdW5jdGlvbiAoZmlyc3QsIHNlY29uZCkgewogICAgICB2YXIgbGVuID0gK3NlY29uZC5sZW5ndGgsIGogPSAwLCBpID0gZmlyc3QubGVuZ3RoOwogICAgICBmb3IgKDsgaiA8IGxlbjsgaisrKSB7CiAgICAgICAgZmlyc3RbaSsrXSA9IHNlY29uZFtqXTsKICAgICAgfQogICAgICBmaXJzdC5sZW5ndGggPSBpOwogICAgICByZXR1cm4gZmlyc3Q7CiAgICB9LAogICAgZ3JlcDogZnVuY3Rpb24gKGVsZW1zLCBjYWxsYmFjaywgaW52ZXJ0KSB7CiAgICAgIHZhciBjYWxsYmFja0ludmVyc2UsIG1hdGNoZXMgPSBbXSwgaSA9IDAsIGxlbmd0aCA9IGVsZW1zLmxlbmd0aCwgY2FsbGJhY2tFeHBlY3QgPSAhaW52ZXJ0OwogICAgICAvLyBHbyB0aHJvdWdoIHRoZSBhcnJheSwgb25seSBzYXZpbmcgdGhlIGl0ZW1zCiAgICAgIC8vIHRoYXQgcGFzcyB0aGUgdmFsaWRhdG9yIGZ1bmN0aW9uCiAgICAgIGZvciAoOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICBjYWxsYmFja0ludmVyc2UgPSAhY2FsbGJhY2soZWxlbXNbaV0sIGkpOwogICAgICAgIGlmIChjYWxsYmFja0ludmVyc2UgIT09IGNhbGxiYWNrRXhwZWN0KSB7CiAgICAgICAgICBtYXRjaGVzLnB1c2goZWxlbXNbaV0pOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gbWF0Y2hlczsKICAgIH0sCiAgICAvLyBhcmcgaXMgZm9yIGludGVybmFsIHVzYWdlIG9ubHkKICAgIG1hcDogZnVuY3Rpb24gKGVsZW1zLCBjYWxsYmFjaywgYXJnKSB7CiAgICAgIHZhciB2YWx1ZSwgaSA9IDAsIGxlbmd0aCA9IGVsZW1zLmxlbmd0aCwgaXNBcnJheSA9IGlzQXJyYXlsaWtlKGVsZW1zKSwgcmV0ID0gW107CiAgICAgIC8vIEdvIHRocm91Z2ggdGhlIGFycmF5LCB0cmFuc2xhdGluZyBlYWNoIG9mIHRoZSBpdGVtcyB0byB0aGVpciBuZXcgdmFsdWVzCiAgICAgIGlmIChpc0FycmF5KSB7CiAgICAgICAgZm9yICg7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgdmFsdWUgPSBjYWxsYmFjayhlbGVtc1tpXSwgaSwgYXJnKTsKICAgICAgICAgIGlmICh2YWx1ZSAhPSBudWxsKSB7CiAgICAgICAgICAgIHJldC5wdXNoKHZhbHVlKTsKICAgICAgICAgIH0KICAgICAgICB9ICAvLyBHbyB0aHJvdWdoIGV2ZXJ5IGtleSBvbiB0aGUgb2JqZWN0LAogICAgICB9IGVsc2UgewogICAgICAgIGZvciAoaSBpbiBlbGVtcykgewogICAgICAgICAgdmFsdWUgPSBjYWxsYmFjayhlbGVtc1tpXSwgaSwgYXJnKTsKICAgICAgICAgIGlmICh2YWx1ZSAhPSBudWxsKSB7CiAgICAgICAgICAgIHJldC5wdXNoKHZhbHVlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgLy8gRmxhdHRlbiBhbnkgbmVzdGVkIGFycmF5cwogICAgICByZXR1cm4gY29uY2F0LmFwcGx5KFtdLCByZXQpOwogICAgfSwKICAgIC8vIEEgZ2xvYmFsIEdVSUQgY291bnRlciBmb3Igb2JqZWN0cwogICAgZ3VpZDogMSwKICAgIC8vIEJpbmQgYSBmdW5jdGlvbiB0byBhIGNvbnRleHQsIG9wdGlvbmFsbHkgcGFydGlhbGx5IGFwcGx5aW5nIGFueQogICAgLy8gYXJndW1lbnRzLgogICAgcHJveHk6IGZ1bmN0aW9uIChmbiwgY29udGV4dCkgewogICAgICB2YXIgdG1wLCBhcmdzLCBwcm94eTsKICAgICAgaWYgKHR5cGVvZiBjb250ZXh0ID09PSAnc3RyaW5nJykgewogICAgICAgIHRtcCA9IGZuW2NvbnRleHRdOwogICAgICAgIGNvbnRleHQgPSBmbjsKICAgICAgICBmbiA9IHRtcDsKICAgICAgfQogICAgICAvLyBRdWljayBjaGVjayB0byBkZXRlcm1pbmUgaWYgdGFyZ2V0IGlzIGNhbGxhYmxlLCBpbiB0aGUgc3BlYwogICAgICAvLyB0aGlzIHRocm93cyBhIFR5cGVFcnJvciwgYnV0IHdlIHdpbGwganVzdCByZXR1cm4gdW5kZWZpbmVkLgogICAgICBpZiAoIWpRdWVyeS5pc0Z1bmN0aW9uKGZuKSkgewogICAgICAgIHJldHVybiB1bmRlZmluZWQ7CiAgICAgIH0KICAgICAgLy8gU2ltdWxhdGVkIGJpbmQKICAgICAgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAyKTsKICAgICAgcHJveHkgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIGZuLmFwcGx5KGNvbnRleHQgfHwgdGhpcywgYXJncy5jb25jYXQoc2xpY2UuY2FsbChhcmd1bWVudHMpKSk7CiAgICAgIH07CiAgICAgIC8vIFNldCB0aGUgZ3VpZCBvZiB1bmlxdWUgaGFuZGxlciB0byB0aGUgc2FtZSBvZiBvcmlnaW5hbCBoYW5kbGVyLCBzbyBpdCBjYW4gYmUgcmVtb3ZlZAogICAgICBwcm94eS5ndWlkID0gZm4uZ3VpZCA9IGZuLmd1aWQgfHwgalF1ZXJ5Lmd1aWQrKzsKICAgICAgcmV0dXJuIHByb3h5OwogICAgfSwKICAgIG5vdzogRGF0ZS5ub3csCiAgICAvLyBqUXVlcnkuc3VwcG9ydCBpcyBub3QgdXNlZCBpbiBDb3JlIGJ1dCBvdGhlciBwcm9qZWN0cyBhdHRhY2ggdGhlaXIKICAgIC8vIHByb3BlcnRpZXMgdG8gaXQgc28gaXQgbmVlZHMgdG8gZXhpc3QuCiAgICBzdXBwb3J0OiBzdXBwb3J0CiAgfSk7CiAgLy8gUG9wdWxhdGUgdGhlIGNsYXNzMnR5cGUgbWFwCiAgalF1ZXJ5LmVhY2goJ0Jvb2xlYW4gTnVtYmVyIFN0cmluZyBGdW5jdGlvbiBBcnJheSBEYXRlIFJlZ0V4cCBPYmplY3QgRXJyb3InLnNwbGl0KCcgJyksIGZ1bmN0aW9uIChpLCBuYW1lKSB7CiAgICBjbGFzczJ0eXBlWydbb2JqZWN0ICcgKyBuYW1lICsgJ10nXSA9IG5hbWUudG9Mb3dlckNhc2UoKTsKICB9KTsKICBmdW5jdGlvbiBpc0FycmF5bGlrZShvYmopIHsKICAgIHZhciBsZW5ndGggPSBvYmoubGVuZ3RoLCB0eXBlID0galF1ZXJ5LnR5cGUob2JqKTsKICAgIGlmICh0eXBlID09PSAnZnVuY3Rpb24nIHx8IGpRdWVyeS5pc1dpbmRvdyhvYmopKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIGlmIChvYmoubm9kZVR5cGUgPT09IDEgJiYgbGVuZ3RoKSB7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQogICAgcmV0dXJuIHR5cGUgPT09ICdhcnJheScgfHwgbGVuZ3RoID09PSAwIHx8IHR5cGVvZiBsZW5ndGggPT09ICdudW1iZXInICYmIGxlbmd0aCA+IDAgJiYgbGVuZ3RoIC0gMSBpbiBvYmo7CiAgfQogIHZhciBTaXp6bGUgPSAvKiEKICAgKiBTaXp6bGUgQ1NTIFNlbGVjdG9yIEVuZ2luZSB2MS4xMC4xOQogICAqIGh0dHA6Ly9zaXp6bGVqcy5jb20vCiAgICoKICAgKiBDb3B5cmlnaHQgMjAxMyBqUXVlcnkgRm91bmRhdGlvbiwgSW5jLiBhbmQgb3RoZXIgY29udHJpYnV0b3JzCiAgICogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlCiAgICogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQogICAqCiAgICogRGF0ZTogMjAxNC0wNC0xOAogICAqLwogIGZ1bmN0aW9uICh3aW5kb3cpIHsKICAgIHZhciBpLCBzdXBwb3J0LCBFeHByLCBnZXRUZXh0LCBpc1hNTCwgdG9rZW5pemUsIGNvbXBpbGUsIHNlbGVjdCwgb3V0ZXJtb3N0Q29udGV4dCwgc29ydElucHV0LCBoYXNEdXBsaWNhdGUsCiAgICAgIC8vIExvY2FsIGRvY3VtZW50IHZhcnMKICAgICAgc2V0RG9jdW1lbnQsIGRvY3VtZW50LCBkb2NFbGVtLCBkb2N1bWVudElzSFRNTCwgcmJ1Z2d5UVNBLCByYnVnZ3lNYXRjaGVzLCBtYXRjaGVzLCBjb250YWlucywKICAgICAgLy8gSW5zdGFuY2Utc3BlY2lmaWMgZGF0YQogICAgICBleHBhbmRvID0gJ3NpenpsZScgKyAtbmV3IERhdGUoKSwgcHJlZmVycmVkRG9jID0gd2luZG93LmRvY3VtZW50LCBkaXJydW5zID0gMCwgZG9uZSA9IDAsIGNsYXNzQ2FjaGUgPSBjcmVhdGVDYWNoZSgpLCB0b2tlbkNhY2hlID0gY3JlYXRlQ2FjaGUoKSwgY29tcGlsZXJDYWNoZSA9IGNyZWF0ZUNhY2hlKCksIHNvcnRPcmRlciA9IGZ1bmN0aW9uIChhLCBiKSB7CiAgICAgICAgaWYgKGEgPT09IGIpIHsKICAgICAgICAgIGhhc0R1cGxpY2F0ZSA9IHRydWU7CiAgICAgICAgfQogICAgICAgIHJldHVybiAwOwogICAgICB9LAogICAgICAvLyBHZW5lcmFsLXB1cnBvc2UgY29uc3RhbnRzCiAgICAgIHN0cnVuZGVmaW5lZCA9IHR5cGVvZiB1bmRlZmluZWQsIE1BWF9ORUdBVElWRSA9IDEgPDwgMzEsCiAgICAgIC8vIEluc3RhbmNlIG1ldGhvZHMKICAgICAgaGFzT3duID0ge30uaGFzT3duUHJvcGVydHksIGFyciA9IFtdLCBwb3AgPSBhcnIucG9wLCBwdXNoX25hdGl2ZSA9IGFyci5wdXNoLCBwdXNoID0gYXJyLnB1c2gsIHNsaWNlID0gYXJyLnNsaWNlLAogICAgICAvLyBVc2UgYSBzdHJpcHBlZC1kb3duIGluZGV4T2YgaWYgd2UgY2FuJ3QgdXNlIGEgbmF0aXZlIG9uZQogICAgICBpbmRleE9mID0gYXJyLmluZGV4T2YgfHwgZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICB2YXIgaSA9IDAsIGxlbiA9IHRoaXMubGVuZ3RoOwogICAgICAgIGZvciAoOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgIGlmICh0aGlzW2ldID09PSBlbGVtKSB7CiAgICAgICAgICAgIHJldHVybiBpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gLTE7CiAgICAgIH0sIGJvb2xlYW5zID0gJ2NoZWNrZWR8c2VsZWN0ZWR8YXN5bmN8YXV0b2ZvY3VzfGF1dG9wbGF5fGNvbnRyb2xzfGRlZmVyfGRpc2FibGVkfGhpZGRlbnxpc21hcHxsb29wfG11bHRpcGxlfG9wZW58cmVhZG9ubHl8cmVxdWlyZWR8c2NvcGVkJywKICAgICAgLy8gUmVndWxhciBleHByZXNzaW9ucwogICAgICAvLyBXaGl0ZXNwYWNlIGNoYXJhY3RlcnMgaHR0cDovL3d3dy53My5vcmcvVFIvY3NzMy1zZWxlY3RvcnMvI3doaXRlc3BhY2UKICAgICAgd2hpdGVzcGFjZSA9ICdbXFx4MjBcXHRcXHJcXG5cXGZdJywKICAgICAgLy8gaHR0cDovL3d3dy53My5vcmcvVFIvY3NzMy1zeW50YXgvI2NoYXJhY3RlcnMKICAgICAgY2hhcmFjdGVyRW5jb2RpbmcgPSAnKD86XFxcXC58W1xcdy1dfFteXFx4MDAtXFx4YTBdKSsnLAogICAgICAvLyBMb29zZWx5IG1vZGVsZWQgb24gQ1NTIGlkZW50aWZpZXIgY2hhcmFjdGVycwogICAgICAvLyBBbiB1bnF1b3RlZCB2YWx1ZSBzaG91bGQgYmUgYSBDU1MgaWRlbnRpZmllciBodHRwOi8vd3d3LnczLm9yZy9UUi9jc3MzLXNlbGVjdG9ycy8jYXR0cmlidXRlLXNlbGVjdG9ycwogICAgICAvLyBQcm9wZXIgc3ludGF4OiBodHRwOi8vd3d3LnczLm9yZy9UUi9DU1MyMS9zeW5kYXRhLmh0bWwjdmFsdWUtZGVmLWlkZW50aWZpZXIKICAgICAgaWRlbnRpZmllciA9IGNoYXJhY3RlckVuY29kaW5nLnJlcGxhY2UoJ3cnLCAndyMnKSwKICAgICAgLy8gQXR0cmlidXRlIHNlbGVjdG9yczogaHR0cDovL3d3dy53My5vcmcvVFIvc2VsZWN0b3JzLyNhdHRyaWJ1dGUtc2VsZWN0b3JzCiAgICAgIGF0dHJpYnV0ZXMgPSAnXFxbJyArIHdoaXRlc3BhY2UgKyAnKignICsgY2hhcmFjdGVyRW5jb2RpbmcgKyAnKSg/OicgKyB3aGl0ZXNwYWNlICsgLy8gT3BlcmF0b3IgKGNhcHR1cmUgMikKICAgICAgJyooWypeJHwhfl0/PSknICsgd2hpdGVzcGFjZSArIC8vICJBdHRyaWJ1dGUgdmFsdWVzIG11c3QgYmUgQ1NTIGlkZW50aWZpZXJzIFtjYXB0dXJlIDVdIG9yIHN0cmluZ3MgW2NhcHR1cmUgMyBvciBjYXB0dXJlIDRdIgogICAgICAnKig/OlwnKCg/OlxcXFwufFteXFxcXFwnXSkqKVwnfCIoKD86XFxcXC58W15cXFxcIl0pKikifCgnICsgaWRlbnRpZmllciArICcpKXwpJyArIHdoaXRlc3BhY2UgKyAnKlxcXScsIHBzZXVkb3MgPSAnOignICsgY2hhcmFjdGVyRW5jb2RpbmcgKyAnKSg/OlxcKCgnICsgLy8gVG8gcmVkdWNlIHRoZSBudW1iZXIgb2Ygc2VsZWN0b3JzIG5lZWRpbmcgdG9rZW5pemUgaW4gdGhlIHByZUZpbHRlciwgcHJlZmVyIGFyZ3VtZW50czoKICAgICAgLy8gMS4gcXVvdGVkIChjYXB0dXJlIDM7IGNhcHR1cmUgNCBvciBjYXB0dXJlIDUpCiAgICAgICcoXCcoKD86XFxcXC58W15cXFxcXCddKSopXCd8IigoPzpcXFxcLnxbXlxcXFwiXSkqKSIpfCcgKyAvLyAyLiBzaW1wbGUgKGNhcHR1cmUgNikKICAgICAgJygoPzpcXFxcLnxbXlxcXFwoKVtcXF1dfCcgKyBhdHRyaWJ1dGVzICsgJykqKXwnICsgLy8gMy4gYW55dGhpbmcgZWxzZSAoY2FwdHVyZSAyKQogICAgICAnLionICsgJylcXCl8KScsCiAgICAgIC8vIExlYWRpbmcgYW5kIG5vbi1lc2NhcGVkIHRyYWlsaW5nIHdoaXRlc3BhY2UsIGNhcHR1cmluZyBzb21lIG5vbi13aGl0ZXNwYWNlIGNoYXJhY3RlcnMgcHJlY2VkaW5nIHRoZSBsYXR0ZXIKICAgICAgcnRyaW0gPSBuZXcgUmVnRXhwKCdeJyArIHdoaXRlc3BhY2UgKyAnK3woKD86XnxbXlxcXFxdKSg/OlxcXFwuKSopJyArIHdoaXRlc3BhY2UgKyAnKyQnLCAnZycpLCByY29tbWEgPSBuZXcgUmVnRXhwKCdeJyArIHdoaXRlc3BhY2UgKyAnKiwnICsgd2hpdGVzcGFjZSArICcqJyksIHJjb21iaW5hdG9ycyA9IG5ldyBSZWdFeHAoJ14nICsgd2hpdGVzcGFjZSArICcqKFs+K35dfCcgKyB3aGl0ZXNwYWNlICsgJyknICsgd2hpdGVzcGFjZSArICcqJyksIHJhdHRyaWJ1dGVRdW90ZXMgPSBuZXcgUmVnRXhwKCc9JyArIHdoaXRlc3BhY2UgKyAnKihbXlxcXVwnIl0qPyknICsgd2hpdGVzcGFjZSArICcqXFxdJywgJ2cnKSwgcnBzZXVkbyA9IG5ldyBSZWdFeHAocHNldWRvcyksIHJpZGVudGlmaWVyID0gbmV3IFJlZ0V4cCgnXicgKyBpZGVudGlmaWVyICsgJyQnKSwgbWF0Y2hFeHByID0gewogICAgICAgICdJRCc6IG5ldyBSZWdFeHAoJ14jKCcgKyBjaGFyYWN0ZXJFbmNvZGluZyArICcpJyksCiAgICAgICAgJ0NMQVNTJzogbmV3IFJlZ0V4cCgnXlxcLignICsgY2hhcmFjdGVyRW5jb2RpbmcgKyAnKScpLAogICAgICAgICdUQUcnOiBuZXcgUmVnRXhwKCdeKCcgKyBjaGFyYWN0ZXJFbmNvZGluZy5yZXBsYWNlKCd3JywgJ3cqJykgKyAnKScpLAogICAgICAgICdBVFRSJzogbmV3IFJlZ0V4cCgnXicgKyBhdHRyaWJ1dGVzKSwKICAgICAgICAnUFNFVURPJzogbmV3IFJlZ0V4cCgnXicgKyBwc2V1ZG9zKSwKICAgICAgICAnQ0hJTEQnOiBuZXcgUmVnRXhwKCdeOihvbmx5fGZpcnN0fGxhc3R8bnRofG50aC1sYXN0KS0oY2hpbGR8b2YtdHlwZSkoPzpcXCgnICsgd2hpdGVzcGFjZSArICcqKGV2ZW58b2RkfCgoWystXXwpKFxcZCopbnwpJyArIHdoaXRlc3BhY2UgKyAnKig/OihbKy1dfCknICsgd2hpdGVzcGFjZSArICcqKFxcZCspfCkpJyArIHdoaXRlc3BhY2UgKyAnKlxcKXwpJywgJ2knKSwKICAgICAgICAnYm9vbCc6IG5ldyBSZWdFeHAoJ14oPzonICsgYm9vbGVhbnMgKyAnKSQnLCAnaScpLAogICAgICAgIC8vIEZvciB1c2UgaW4gbGlicmFyaWVzIGltcGxlbWVudGluZyAuaXMoKQogICAgICAgIC8vIFdlIHVzZSB0aGlzIGZvciBQT1MgbWF0Y2hpbmcgaW4gYHNlbGVjdGAKICAgICAgICAnbmVlZHNDb250ZXh0JzogbmV3IFJlZ0V4cCgnXicgKyB3aGl0ZXNwYWNlICsgJypbPit+XXw6KGV2ZW58b2RkfGVxfGd0fGx0fG50aHxmaXJzdHxsYXN0KSg/OlxcKCcgKyB3aGl0ZXNwYWNlICsgJyooKD86LVxcZCk/XFxkKiknICsgd2hpdGVzcGFjZSArICcqXFwpfCkoPz1bXi1dfCQpJywgJ2knKQogICAgICB9LCByaW5wdXRzID0gL14oPzppbnB1dHxzZWxlY3R8dGV4dGFyZWF8YnV0dG9uKSQvaSwgcmhlYWRlciA9IC9eaFxkJC9pLCBybmF0aXZlID0gL15bXntdK1x7XHMqXFtuYXRpdmUgXHcvLAogICAgICAvLyBFYXNpbHktcGFyc2VhYmxlL3JldHJpZXZhYmxlIElEIG9yIFRBRyBvciBDTEFTUyBzZWxlY3RvcnMKICAgICAgcnF1aWNrRXhwciA9IC9eKD86IyhbXHctXSspfChcdyspfFwuKFtcdy1dKykpJC8sIHJzaWJsaW5nID0gL1srfl0vLCByZXNjYXBlID0gLyd8XFwvZywKICAgICAgLy8gQ1NTIGVzY2FwZXMgaHR0cDovL3d3dy53My5vcmcvVFIvQ1NTMjEvc3luZGF0YS5odG1sI2VzY2FwZWQtY2hhcmFjdGVycwogICAgICBydW5lc2NhcGUgPSBuZXcgUmVnRXhwKCdcXFxcKFtcXGRhLWZdezEsNn0nICsgd2hpdGVzcGFjZSArICc/fCgnICsgd2hpdGVzcGFjZSArICcpfC4pJywgJ2lnJyksIGZ1bmVzY2FwZSA9IGZ1bmN0aW9uIChfLCBlc2NhcGVkLCBlc2NhcGVkV2hpdGVzcGFjZSkgewogICAgICAgIHZhciBoaWdoID0gJzB4JyArIGVzY2FwZWQgLSA2NTUzNjsKICAgICAgICAvLyBOYU4gbWVhbnMgbm9uLWNvZGVwb2ludAogICAgICAgIC8vIFN1cHBvcnQ6IEZpcmVmb3g8MjQKICAgICAgICAvLyBXb3JrYXJvdW5kIGVycm9uZW91cyBudW1lcmljIGludGVycHJldGF0aW9uIG9mICsiMHgiCiAgICAgICAgcmV0dXJuIGhpZ2ggIT09IGhpZ2ggfHwgZXNjYXBlZFdoaXRlc3BhY2UgPyBlc2NhcGVkIDogaGlnaCA8IDAgPyAvLyBCTVAgY29kZXBvaW50CiAgICAgICAgU3RyaW5nLmZyb21DaGFyQ29kZShoaWdoICsgNjU1MzYpIDogLy8gU3VwcGxlbWVudGFsIFBsYW5lIGNvZGVwb2ludCAoc3Vycm9nYXRlIHBhaXIpCiAgICAgICAgU3RyaW5nLmZyb21DaGFyQ29kZShoaWdoID4+IDEwIHwgNTUyOTYsIGhpZ2ggJiAxMDIzIHwgNTYzMjApOwogICAgICB9OwogICAgLy8gT3B0aW1pemUgZm9yIHB1c2guYXBwbHkoIF8sIE5vZGVMaXN0ICkKICAgIHRyeSB7CiAgICAgIHB1c2guYXBwbHkoYXJyID0gc2xpY2UuY2FsbChwcmVmZXJyZWREb2MuY2hpbGROb2RlcyksIHByZWZlcnJlZERvYy5jaGlsZE5vZGVzKTsKICAgICAgLy8gU3VwcG9ydDogQW5kcm9pZDw0LjAKICAgICAgLy8gRGV0ZWN0IHNpbGVudGx5IGZhaWxpbmcgcHVzaC5hcHBseQogICAgICBhcnJbcHJlZmVycmVkRG9jLmNoaWxkTm9kZXMubGVuZ3RoXS5ub2RlVHlwZTsKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgcHVzaCA9IHsKICAgICAgICBhcHBseTogYXJyLmxlbmd0aCA/IC8vIExldmVyYWdlIHNsaWNlIGlmIHBvc3NpYmxlCiAgICAgICAgZnVuY3Rpb24gKHRhcmdldCwgZWxzKSB7CiAgICAgICAgICBwdXNoX25hdGl2ZS5hcHBseSh0YXJnZXQsIHNsaWNlLmNhbGwoZWxzKSk7CiAgICAgICAgfSA6IC8vIFN1cHBvcnQ6IElFPDkKICAgICAgICAvLyBPdGhlcndpc2UgYXBwZW5kIGRpcmVjdGx5CiAgICAgICAgZnVuY3Rpb24gKHRhcmdldCwgZWxzKSB7CiAgICAgICAgICB2YXIgaiA9IHRhcmdldC5sZW5ndGgsIGkgPSAwOwogICAgICAgICAgLy8gQ2FuJ3QgdHJ1c3QgTm9kZUxpc3QubGVuZ3RoCiAgICAgICAgICB3aGlsZSAodGFyZ2V0W2orK10gPSBlbHNbaSsrXSkgewogICAgICAgICAgfQogICAgICAgICAgdGFyZ2V0Lmxlbmd0aCA9IGogLSAxOwogICAgICAgIH0KICAgICAgfTsKICAgIH0KICAgIGZ1bmN0aW9uIFNpenpsZShzZWxlY3RvciwgY29udGV4dCwgcmVzdWx0cywgc2VlZCkgewogICAgICB2YXIgbWF0Y2gsIGVsZW0sIG0sIG5vZGVUeXBlLAogICAgICAgIC8vIFFTQSB2YXJzCiAgICAgICAgaSwgZ3JvdXBzLCBvbGQsIG5pZCwgbmV3Q29udGV4dCwgbmV3U2VsZWN0b3I7CiAgICAgIGlmICgoY29udGV4dCA/IGNvbnRleHQub3duZXJEb2N1bWVudCB8fCBjb250ZXh0IDogcHJlZmVycmVkRG9jKSAhPT0gZG9jdW1lbnQpIHsKICAgICAgICBzZXREb2N1bWVudChjb250ZXh0KTsKICAgICAgfQogICAgICBjb250ZXh0ID0gY29udGV4dCB8fCBkb2N1bWVudDsKICAgICAgcmVzdWx0cyA9IHJlc3VsdHMgfHwgW107CiAgICAgIGlmICghc2VsZWN0b3IgfHwgdHlwZW9mIHNlbGVjdG9yICE9PSAnc3RyaW5nJykgewogICAgICAgIHJldHVybiByZXN1bHRzOwogICAgICB9CiAgICAgIGlmICgobm9kZVR5cGUgPSBjb250ZXh0Lm5vZGVUeXBlKSAhPT0gMSAmJiBub2RlVHlwZSAhPT0gOSkgewogICAgICAgIHJldHVybiBbXTsKICAgICAgfQogICAgICBpZiAoZG9jdW1lbnRJc0hUTUwgJiYgIXNlZWQpIHsKICAgICAgICAvLyBTaG9ydGN1dHMKICAgICAgICBpZiAobWF0Y2ggPSBycXVpY2tFeHByLmV4ZWMoc2VsZWN0b3IpKSB7CiAgICAgICAgICAvLyBTcGVlZC11cDogU2l6emxlKCIjSUQiKQogICAgICAgICAgaWYgKG0gPSBtYXRjaFsxXSkgewogICAgICAgICAgICBpZiAobm9kZVR5cGUgPT09IDkpIHsKICAgICAgICAgICAgICBlbGVtID0gY29udGV4dC5nZXRFbGVtZW50QnlJZChtKTsKICAgICAgICAgICAgICAvLyBDaGVjayBwYXJlbnROb2RlIHRvIGNhdGNoIHdoZW4gQmxhY2tiZXJyeSA0LjYgcmV0dXJucwogICAgICAgICAgICAgIC8vIG5vZGVzIHRoYXQgYXJlIG5vIGxvbmdlciBpbiB0aGUgZG9jdW1lbnQgKGpRdWVyeSAjNjk2MykKICAgICAgICAgICAgICBpZiAoZWxlbSAmJiBlbGVtLnBhcmVudE5vZGUpIHsKICAgICAgICAgICAgICAgIC8vIEhhbmRsZSB0aGUgY2FzZSB3aGVyZSBJRSwgT3BlcmEsIGFuZCBXZWJraXQgcmV0dXJuIGl0ZW1zCiAgICAgICAgICAgICAgICAvLyBieSBuYW1lIGluc3RlYWQgb2YgSUQKICAgICAgICAgICAgICAgIGlmIChlbGVtLmlkID09PSBtKSB7CiAgICAgICAgICAgICAgICAgIHJlc3VsdHMucHVzaChlbGVtKTsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdHM7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHRzOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAvLyBDb250ZXh0IGlzIG5vdCBhIGRvY3VtZW50CiAgICAgICAgICAgICAgaWYgKGNvbnRleHQub3duZXJEb2N1bWVudCAmJiAoZWxlbSA9IGNvbnRleHQub3duZXJEb2N1bWVudC5nZXRFbGVtZW50QnlJZChtKSkgJiYgY29udGFpbnMoY29udGV4dCwgZWxlbSkgJiYgZWxlbS5pZCA9PT0gbSkgewogICAgICAgICAgICAgICAgcmVzdWx0cy5wdXNoKGVsZW0pOwogICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdHM7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9ICAvLyBTcGVlZC11cDogU2l6emxlKCJUQUciKQogICAgICAgICAgfSBlbHNlIGlmIChtYXRjaFsyXSkgewogICAgICAgICAgICBwdXNoLmFwcGx5KHJlc3VsdHMsIGNvbnRleHQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoc2VsZWN0b3IpKTsKICAgICAgICAgICAgcmV0dXJuIHJlc3VsdHM7ICAvLyBTcGVlZC11cDogU2l6emxlKCIuQ0xBU1MiKQogICAgICAgICAgfSBlbHNlIGlmICgobSA9IG1hdGNoWzNdKSAmJiBzdXBwb3J0LmdldEVsZW1lbnRzQnlDbGFzc05hbWUgJiYgY29udGV4dC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKSB7CiAgICAgICAgICAgIHB1c2guYXBwbHkocmVzdWx0cywgY29udGV4dC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKG0pKTsKICAgICAgICAgICAgcmV0dXJuIHJlc3VsdHM7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIC8vIFFTQSBwYXRoCiAgICAgICAgaWYgKHN1cHBvcnQucXNhICYmICghcmJ1Z2d5UVNBIHx8ICFyYnVnZ3lRU0EudGVzdChzZWxlY3RvcikpKSB7CiAgICAgICAgICBuaWQgPSBvbGQgPSBleHBhbmRvOwogICAgICAgICAgbmV3Q29udGV4dCA9IGNvbnRleHQ7CiAgICAgICAgICBuZXdTZWxlY3RvciA9IG5vZGVUeXBlID09PSA5ICYmIHNlbGVjdG9yOwogICAgICAgICAgLy8gcVNBIHdvcmtzIHN0cmFuZ2VseSBvbiBFbGVtZW50LXJvb3RlZCBxdWVyaWVzCiAgICAgICAgICAvLyBXZSBjYW4gd29yayBhcm91bmQgdGhpcyBieSBzcGVjaWZ5aW5nIGFuIGV4dHJhIElEIG9uIHRoZSByb290CiAgICAgICAgICAvLyBhbmQgd29ya2luZyB1cCBmcm9tIHRoZXJlIChUaGFua3MgdG8gQW5kcmV3IER1cG9udCBmb3IgdGhlIHRlY2huaXF1ZSkKICAgICAgICAgIC8vIElFIDggZG9lc24ndCB3b3JrIG9uIG9iamVjdCBlbGVtZW50cwogICAgICAgICAgaWYgKG5vZGVUeXBlID09PSAxICYmIGNvbnRleHQubm9kZU5hbWUudG9Mb3dlckNhc2UoKSAhPT0gJ29iamVjdCcpIHsKICAgICAgICAgICAgZ3JvdXBzID0gdG9rZW5pemUoc2VsZWN0b3IpOwogICAgICAgICAgICBpZiAob2xkID0gY29udGV4dC5nZXRBdHRyaWJ1dGUoJ2lkJykpIHsKICAgICAgICAgICAgICBuaWQgPSBvbGQucmVwbGFjZShyZXNjYXBlLCAnXFwkJicpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGNvbnRleHQuc2V0QXR0cmlidXRlKCdpZCcsIG5pZCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbmlkID0gJ1tpZD1cJycgKyBuaWQgKyAnXCddICc7CiAgICAgICAgICAgIGkgPSBncm91cHMubGVuZ3RoOwogICAgICAgICAgICB3aGlsZSAoaS0tKSB7CiAgICAgICAgICAgICAgZ3JvdXBzW2ldID0gbmlkICsgdG9TZWxlY3Rvcihncm91cHNbaV0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG5ld0NvbnRleHQgPSByc2libGluZy50ZXN0KHNlbGVjdG9yKSAmJiB0ZXN0Q29udGV4dChjb250ZXh0LnBhcmVudE5vZGUpIHx8IGNvbnRleHQ7CiAgICAgICAgICAgIG5ld1NlbGVjdG9yID0gZ3JvdXBzLmpvaW4oJywnKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChuZXdTZWxlY3RvcikgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIHB1c2guYXBwbHkocmVzdWx0cywgbmV3Q29udGV4dC5xdWVyeVNlbGVjdG9yQWxsKG5ld1NlbGVjdG9yKSk7CiAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdHM7CiAgICAgICAgICAgIH0gY2F0Y2ggKHFzYUVycm9yKSB7CiAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgaWYgKCFvbGQpIHsKICAgICAgICAgICAgICAgIGNvbnRleHQucmVtb3ZlQXR0cmlidXRlKCdpZCcpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICAvLyBBbGwgb3RoZXJzCiAgICAgIHJldHVybiBzZWxlY3Qoc2VsZWN0b3IucmVwbGFjZShydHJpbSwgJyQxJyksIGNvbnRleHQsIHJlc3VsdHMsIHNlZWQpOwogICAgfQogICAgLyoqCiAgICAgKiBDcmVhdGUga2V5LXZhbHVlIGNhY2hlcyBvZiBsaW1pdGVkIHNpemUKICAgICAqIEByZXR1cm5zIHtGdW5jdGlvbihzdHJpbmcsIE9iamVjdCl9IFJldHVybnMgdGhlIE9iamVjdCBkYXRhIGFmdGVyIHN0b3JpbmcgaXQgb24gaXRzZWxmIHdpdGgKICAgICAqCXByb3BlcnR5IG5hbWUgdGhlIChzcGFjZS1zdWZmaXhlZCkgc3RyaW5nIGFuZCAoaWYgdGhlIGNhY2hlIGlzIGxhcmdlciB0aGFuIEV4cHIuY2FjaGVMZW5ndGgpCiAgICAgKglkZWxldGluZyB0aGUgb2xkZXN0IGVudHJ5CiAgICAgKi8KICAgIGZ1bmN0aW9uIGNyZWF0ZUNhY2hlKCkgewogICAgICB2YXIga2V5cyA9IFtdOwogICAgICBmdW5jdGlvbiBjYWNoZShrZXksIHZhbHVlKSB7CiAgICAgICAgLy8gVXNlIChrZXkgKyAiICIpIHRvIGF2b2lkIGNvbGxpc2lvbiB3aXRoIG5hdGl2ZSBwcm90b3R5cGUgcHJvcGVydGllcyAoc2VlIElzc3VlICMxNTcpCiAgICAgICAgaWYgKGtleXMucHVzaChrZXkgKyAnICcpID4gRXhwci5jYWNoZUxlbmd0aCkgewogICAgICAgICAgLy8gT25seSBrZWVwIHRoZSBtb3N0IHJlY2VudCBlbnRyaWVzCiAgICAgICAgICBkZWxldGUgY2FjaGVba2V5cy5zaGlmdCgpXTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGNhY2hlW2tleSArICcgJ10gPSB2YWx1ZTsKICAgICAgfQogICAgICByZXR1cm4gY2FjaGU7CiAgICB9CiAgICAvKioKICAgICAqIE1hcmsgYSBmdW5jdGlvbiBmb3Igc3BlY2lhbCB1c2UgYnkgU2l6emxlCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBmbiBUaGUgZnVuY3Rpb24gdG8gbWFyawogICAgICovCiAgICBmdW5jdGlvbiBtYXJrRnVuY3Rpb24oZm4pIHsKICAgICAgZm5bZXhwYW5kb10gPSB0cnVlOwogICAgICByZXR1cm4gZm47CiAgICB9CiAgICAvKioKICAgICAqIFN1cHBvcnQgdGVzdGluZyB1c2luZyBhbiBlbGVtZW50CiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBmbiBQYXNzZWQgdGhlIGNyZWF0ZWQgZGl2IGFuZCBleHBlY3RzIGEgYm9vbGVhbiByZXN1bHQKICAgICAqLwogICAgZnVuY3Rpb24gYXNzZXJ0KGZuKSB7CiAgICAgIHZhciBkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgICAgdHJ5IHsKICAgICAgICByZXR1cm4gISFmbihkaXYpOwogICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9IGZpbmFsbHkgewogICAgICAgIC8vIFJlbW92ZSBmcm9tIGl0cyBwYXJlbnQgYnkgZGVmYXVsdAogICAgICAgIGlmIChkaXYucGFyZW50Tm9kZSkgewogICAgICAgICAgZGl2LnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoZGl2KTsKICAgICAgICB9CiAgICAgICAgLy8gcmVsZWFzZSBtZW1vcnkgaW4gSUUKICAgICAgICBkaXYgPSBudWxsOwogICAgICB9CiAgICB9CiAgICAvKioKICAgICAqIEFkZHMgdGhlIHNhbWUgaGFuZGxlciBmb3IgYWxsIG9mIHRoZSBzcGVjaWZpZWQgYXR0cnMKICAgICAqIEBwYXJhbSB7U3RyaW5nfSBhdHRycyBQaXBlLXNlcGFyYXRlZCBsaXN0IG9mIGF0dHJpYnV0ZXMKICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGhhbmRsZXIgVGhlIG1ldGhvZCB0aGF0IHdpbGwgYmUgYXBwbGllZAogICAgICovCiAgICBmdW5jdGlvbiBhZGRIYW5kbGUoYXR0cnMsIGhhbmRsZXIpIHsKICAgICAgdmFyIGFyciA9IGF0dHJzLnNwbGl0KCd8JyksIGkgPSBhdHRycy5sZW5ndGg7CiAgICAgIHdoaWxlIChpLS0pIHsKICAgICAgICBFeHByLmF0dHJIYW5kbGVbYXJyW2ldXSA9IGhhbmRsZXI7CiAgICAgIH0KICAgIH0KICAgIC8qKgogICAgICogQ2hlY2tzIGRvY3VtZW50IG9yZGVyIG9mIHR3byBzaWJsaW5ncwogICAgICogQHBhcmFtIHtFbGVtZW50fSBhCiAgICAgKiBAcGFyYW0ge0VsZW1lbnR9IGIKICAgICAqIEByZXR1cm5zIHtOdW1iZXJ9IFJldHVybnMgbGVzcyB0aGFuIDAgaWYgYSBwcmVjZWRlcyBiLCBncmVhdGVyIHRoYW4gMCBpZiBhIGZvbGxvd3MgYgogICAgICovCiAgICBmdW5jdGlvbiBzaWJsaW5nQ2hlY2soYSwgYikgewogICAgICB2YXIgY3VyID0gYiAmJiBhLCBkaWZmID0gY3VyICYmIGEubm9kZVR5cGUgPT09IDEgJiYgYi5ub2RlVHlwZSA9PT0gMSAmJiAofmIuc291cmNlSW5kZXggfHwgTUFYX05FR0FUSVZFKSAtICh+YS5zb3VyY2VJbmRleCB8fCBNQVhfTkVHQVRJVkUpOwogICAgICAvLyBVc2UgSUUgc291cmNlSW5kZXggaWYgYXZhaWxhYmxlIG9uIGJvdGggbm9kZXMKICAgICAgaWYgKGRpZmYpIHsKICAgICAgICByZXR1cm4gZGlmZjsKICAgICAgfQogICAgICAvLyBDaGVjayBpZiBiIGZvbGxvd3MgYQogICAgICBpZiAoY3VyKSB7CiAgICAgICAgd2hpbGUgKGN1ciA9IGN1ci5uZXh0U2libGluZykgewogICAgICAgICAgaWYgKGN1ciA9PT0gYikgewogICAgICAgICAgICByZXR1cm4gLTE7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBhID8gMSA6IC0xOwogICAgfQogICAgLyoqCiAgICAgKiBSZXR1cm5zIGEgZnVuY3Rpb24gdG8gdXNlIGluIHBzZXVkb3MgZm9yIGlucHV0IHR5cGVzCiAgICAgKiBAcGFyYW0ge1N0cmluZ30gdHlwZQogICAgICovCiAgICBmdW5jdGlvbiBjcmVhdGVJbnB1dFBzZXVkbyh0eXBlKSB7CiAgICAgIHJldHVybiBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgIHZhciBuYW1lID0gZWxlbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpOwogICAgICAgIHJldHVybiBuYW1lID09PSAnaW5wdXQnICYmIGVsZW0udHlwZSA9PT0gdHlwZTsKICAgICAgfTsKICAgIH0KICAgIC8qKgogICAgICogUmV0dXJucyBhIGZ1bmN0aW9uIHRvIHVzZSBpbiBwc2V1ZG9zIGZvciBidXR0b25zCiAgICAgKiBAcGFyYW0ge1N0cmluZ30gdHlwZQogICAgICovCiAgICBmdW5jdGlvbiBjcmVhdGVCdXR0b25Qc2V1ZG8odHlwZSkgewogICAgICByZXR1cm4gZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICB2YXIgbmFtZSA9IGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKTsKICAgICAgICByZXR1cm4gKG5hbWUgPT09ICdpbnB1dCcgfHwgbmFtZSA9PT0gJ2J1dHRvbicpICYmIGVsZW0udHlwZSA9PT0gdHlwZTsKICAgICAgfTsKICAgIH0KICAgIC8qKgogICAgICogUmV0dXJucyBhIGZ1bmN0aW9uIHRvIHVzZSBpbiBwc2V1ZG9zIGZvciBwb3NpdGlvbmFscwogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gZm4KICAgICAqLwogICAgZnVuY3Rpb24gY3JlYXRlUG9zaXRpb25hbFBzZXVkbyhmbikgewogICAgICByZXR1cm4gbWFya0Z1bmN0aW9uKGZ1bmN0aW9uIChhcmd1bWVudCkgewogICAgICAgIGFyZ3VtZW50ID0gK2FyZ3VtZW50OwogICAgICAgIHJldHVybiBtYXJrRnVuY3Rpb24oZnVuY3Rpb24gKHNlZWQsIG1hdGNoZXMpIHsKICAgICAgICAgIHZhciBqLCBtYXRjaEluZGV4ZXMgPSBmbihbXSwgc2VlZC5sZW5ndGgsIGFyZ3VtZW50KSwgaSA9IG1hdGNoSW5kZXhlcy5sZW5ndGg7CiAgICAgICAgICAvLyBNYXRjaCBlbGVtZW50cyBmb3VuZCBhdCB0aGUgc3BlY2lmaWVkIGluZGV4ZXMKICAgICAgICAgIHdoaWxlIChpLS0pIHsKICAgICAgICAgICAgaWYgKHNlZWRbaiA9IG1hdGNoSW5kZXhlc1tpXV0pIHsKICAgICAgICAgICAgICBzZWVkW2pdID0gIShtYXRjaGVzW2pdID0gc2VlZFtqXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfSk7CiAgICB9CiAgICAvKioKICAgICAqIENoZWNrcyBhIG5vZGUgZm9yIHZhbGlkaXR5IGFzIGEgU2l6emxlIGNvbnRleHQKICAgICAqIEBwYXJhbSB7RWxlbWVudHxPYmplY3Q9fSBjb250ZXh0CiAgICAgKiBAcmV0dXJucyB7RWxlbWVudHxPYmplY3R8Qm9vbGVhbn0gVGhlIGlucHV0IG5vZGUgaWYgYWNjZXB0YWJsZSwgb3RoZXJ3aXNlIGEgZmFsc3kgdmFsdWUKICAgICAqLwogICAgZnVuY3Rpb24gdGVzdENvbnRleHQoY29udGV4dCkgewogICAgICByZXR1cm4gY29udGV4dCAmJiB0eXBlb2YgY29udGV4dC5nZXRFbGVtZW50c0J5VGFnTmFtZSAhPT0gc3RydW5kZWZpbmVkICYmIGNvbnRleHQ7CiAgICB9CiAgICAvLyBFeHBvc2Ugc3VwcG9ydCB2YXJzIGZvciBjb252ZW5pZW5jZQogICAgc3VwcG9ydCA9IFNpenpsZS5zdXBwb3J0ID0ge307CiAgICAvKioKICAgICAqIERldGVjdHMgWE1MIG5vZGVzCiAgICAgKiBAcGFyYW0ge0VsZW1lbnR8T2JqZWN0fSBlbGVtIEFuIGVsZW1lbnQgb3IgYSBkb2N1bWVudAogICAgICogQHJldHVybnMge0Jvb2xlYW59IFRydWUgaWZmIGVsZW0gaXMgYSBub24tSFRNTCBYTUwgbm9kZQogICAgICovCiAgICBpc1hNTCA9IFNpenpsZS5pc1hNTCA9IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgIC8vIGRvY3VtZW50RWxlbWVudCBpcyB2ZXJpZmllZCBmb3IgY2FzZXMgd2hlcmUgaXQgZG9lc24ndCB5ZXQgZXhpc3QKICAgICAgLy8gKHN1Y2ggYXMgbG9hZGluZyBpZnJhbWVzIGluIElFIC0gIzQ4MzMpCiAgICAgIHZhciBkb2N1bWVudEVsZW1lbnQgPSBlbGVtICYmIChlbGVtLm93bmVyRG9jdW1lbnQgfHwgZWxlbSkuZG9jdW1lbnRFbGVtZW50OwogICAgICByZXR1cm4gZG9jdW1lbnRFbGVtZW50ID8gZG9jdW1lbnRFbGVtZW50Lm5vZGVOYW1lICE9PSAnSFRNTCcgOiBmYWxzZTsKICAgIH07CiAgICAvKioKICAgICAqIFNldHMgZG9jdW1lbnQtcmVsYXRlZCB2YXJpYWJsZXMgb25jZSBiYXNlZCBvbiB0aGUgY3VycmVudCBkb2N1bWVudAogICAgICogQHBhcmFtIHtFbGVtZW50fE9iamVjdH0gW2RvY10gQW4gZWxlbWVudCBvciBkb2N1bWVudCBvYmplY3QgdG8gdXNlIHRvIHNldCB0aGUgZG9jdW1lbnQKICAgICAqIEByZXR1cm5zIHtPYmplY3R9IFJldHVybnMgdGhlIGN1cnJlbnQgZG9jdW1lbnQKICAgICAqLwogICAgc2V0RG9jdW1lbnQgPSBTaXp6bGUuc2V0RG9jdW1lbnQgPSBmdW5jdGlvbiAobm9kZSkgewogICAgICB2YXIgaGFzQ29tcGFyZSwgZG9jID0gbm9kZSA/IG5vZGUub3duZXJEb2N1bWVudCB8fCBub2RlIDogcHJlZmVycmVkRG9jLCBwYXJlbnQgPSBkb2MuZGVmYXVsdFZpZXc7CiAgICAgIC8vIElmIG5vIGRvY3VtZW50IGFuZCBkb2N1bWVudEVsZW1lbnQgaXMgYXZhaWxhYmxlLCByZXR1cm4KICAgICAgaWYgKGRvYyA9PT0gZG9jdW1lbnQgfHwgZG9jLm5vZGVUeXBlICE9PSA5IHx8ICFkb2MuZG9jdW1lbnRFbGVtZW50KSB7CiAgICAgICAgcmV0dXJuIGRvY3VtZW50OwogICAgICB9CiAgICAgIC8vIFNldCBvdXIgZG9jdW1lbnQKICAgICAgZG9jdW1lbnQgPSBkb2M7CiAgICAgIGRvY0VsZW0gPSBkb2MuZG9jdW1lbnRFbGVtZW50OwogICAgICAvLyBTdXBwb3J0IHRlc3RzCiAgICAgIGRvY3VtZW50SXNIVE1MID0gIWlzWE1MKGRvYyk7CiAgICAgIC8vIFN1cHBvcnQ6IElFPjgKICAgICAgLy8gSWYgaWZyYW1lIGRvY3VtZW50IGlzIGFzc2lnbmVkIHRvICJkb2N1bWVudCIgdmFyaWFibGUgYW5kIGlmIGlmcmFtZSBoYXMgYmVlbiByZWxvYWRlZCwKICAgICAgLy8gSUUgd2lsbCB0aHJvdyAicGVybWlzc2lvbiBkZW5pZWQiIGVycm9yIHdoZW4gYWNjZXNzaW5nICJkb2N1bWVudCIgdmFyaWFibGUsIHNlZSBqUXVlcnkgIzEzOTM2CiAgICAgIC8vIElFNi04IGRvIG5vdCBzdXBwb3J0IHRoZSBkZWZhdWx0VmlldyBwcm9wZXJ0eSBzbyBwYXJlbnQgd2lsbCBiZSB1bmRlZmluZWQKICAgICAgaWYgKHBhcmVudCAmJiBwYXJlbnQgIT09IHBhcmVudC50b3ApIHsKICAgICAgICAvLyBJRTExIGRvZXMgbm90IGhhdmUgYXR0YWNoRXZlbnQsIHNvIGFsbCBtdXN0IHN1ZmZlcgogICAgICAgIGlmIChwYXJlbnQuYWRkRXZlbnRMaXN0ZW5lcikgewogICAgICAgICAgcGFyZW50LmFkZEV2ZW50TGlzdGVuZXIoJ3VubG9hZCcsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgc2V0RG9jdW1lbnQoKTsKICAgICAgICAgIH0sIGZhbHNlKTsKICAgICAgICB9IGVsc2UgaWYgKHBhcmVudC5hdHRhY2hFdmVudCkgewogICAgICAgICAgcGFyZW50LmF0dGFjaEV2ZW50KCdvbnVubG9hZCcsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgc2V0RG9jdW1lbnQoKTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfQogICAgICAvKiBBdHRyaWJ1dGVzCiAgICAgIAktLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tICovCiAgICAgIC8vIFN1cHBvcnQ6IElFPDgKICAgICAgLy8gVmVyaWZ5IHRoYXQgZ2V0QXR0cmlidXRlIHJlYWxseSByZXR1cm5zIGF0dHJpYnV0ZXMgYW5kIG5vdCBwcm9wZXJ0aWVzIChleGNlcHRpbmcgSUU4IGJvb2xlYW5zKQogICAgICBzdXBwb3J0LmF0dHJpYnV0ZXMgPSBhc3NlcnQoZnVuY3Rpb24gKGRpdikgewogICAgICAgIGRpdi5jbGFzc05hbWUgPSAnaSc7CiAgICAgICAgcmV0dXJuICFkaXYuZ2V0QXR0cmlidXRlKCdjbGFzc05hbWUnKTsKICAgICAgfSk7CiAgICAgIC8qIGdldEVsZW1lbnQocylCeSoKICAgICAgCS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gKi8KICAgICAgLy8gQ2hlY2sgaWYgZ2V0RWxlbWVudHNCeVRhZ05hbWUoIioiKSByZXR1cm5zIG9ubHkgZWxlbWVudHMKICAgICAgc3VwcG9ydC5nZXRFbGVtZW50c0J5VGFnTmFtZSA9IGFzc2VydChmdW5jdGlvbiAoZGl2KSB7CiAgICAgICAgZGl2LmFwcGVuZENoaWxkKGRvYy5jcmVhdGVDb21tZW50KCcnKSk7CiAgICAgICAgcmV0dXJuICFkaXYuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJyonKS5sZW5ndGg7CiAgICAgIH0pOwogICAgICAvLyBDaGVjayBpZiBnZXRFbGVtZW50c0J5Q2xhc3NOYW1lIGNhbiBiZSB0cnVzdGVkCiAgICAgIHN1cHBvcnQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSA9IHJuYXRpdmUudGVzdChkb2MuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSkgJiYgYXNzZXJ0KGZ1bmN0aW9uIChkaXYpIHsKICAgICAgICBkaXYuaW5uZXJIVE1MID0gJzxkaXYgY2xhc3M9XCdhXCc+PC9kaXY+PGRpdiBjbGFzcz1cJ2EgaVwnPjwvZGl2Pic7CiAgICAgICAgLy8gU3VwcG9ydDogU2FmYXJpPDQKICAgICAgICAvLyBDYXRjaCBjbGFzcyBvdmVyLWNhY2hpbmcKICAgICAgICBkaXYuZmlyc3RDaGlsZC5jbGFzc05hbWUgPSAnaSc7CiAgICAgICAgLy8gU3VwcG9ydDogT3BlcmE8MTAKICAgICAgICAvLyBDYXRjaCBnRUJDTiBmYWlsdXJlIHRvIGZpbmQgbm9uLWxlYWRpbmcgY2xhc3NlcwogICAgICAgIHJldHVybiBkaXYuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSgnaScpLmxlbmd0aCA9PT0gMjsKICAgICAgfSk7CiAgICAgIC8vIFN1cHBvcnQ6IElFPDEwCiAgICAgIC8vIENoZWNrIGlmIGdldEVsZW1lbnRCeUlkIHJldHVybnMgZWxlbWVudHMgYnkgbmFtZQogICAgICAvLyBUaGUgYnJva2VuIGdldEVsZW1lbnRCeUlkIG1ldGhvZHMgZG9uJ3QgcGljayB1cCBwcm9ncmFtYXRpY2FsbHktc2V0IG5hbWVzLAogICAgICAvLyBzbyB1c2UgYSByb3VuZGFib3V0IGdldEVsZW1lbnRzQnlOYW1lIHRlc3QKICAgICAgc3VwcG9ydC5nZXRCeUlkID0gYXNzZXJ0KGZ1bmN0aW9uIChkaXYpIHsKICAgICAgICBkb2NFbGVtLmFwcGVuZENoaWxkKGRpdikuaWQgPSBleHBhbmRvOwogICAgICAgIHJldHVybiAhZG9jLmdldEVsZW1lbnRzQnlOYW1lIHx8ICFkb2MuZ2V0RWxlbWVudHNCeU5hbWUoZXhwYW5kbykubGVuZ3RoOwogICAgICB9KTsKICAgICAgLy8gSUQgZmluZCBhbmQgZmlsdGVyCiAgICAgIGlmIChzdXBwb3J0LmdldEJ5SWQpIHsKICAgICAgICBFeHByLmZpbmRbJ0lEJ10gPSBmdW5jdGlvbiAoaWQsIGNvbnRleHQpIHsKICAgICAgICAgIGlmICh0eXBlb2YgY29udGV4dC5nZXRFbGVtZW50QnlJZCAhPT0gc3RydW5kZWZpbmVkICYmIGRvY3VtZW50SXNIVE1MKSB7CiAgICAgICAgICAgIHZhciBtID0gY29udGV4dC5nZXRFbGVtZW50QnlJZChpZCk7CiAgICAgICAgICAgIC8vIENoZWNrIHBhcmVudE5vZGUgdG8gY2F0Y2ggd2hlbiBCbGFja2JlcnJ5IDQuNiByZXR1cm5zCiAgICAgICAgICAgIC8vIG5vZGVzIHRoYXQgYXJlIG5vIGxvbmdlciBpbiB0aGUgZG9jdW1lbnQgIzY5NjMKICAgICAgICAgICAgcmV0dXJuIG0gJiYgbS5wYXJlbnROb2RlID8gW21dIDogW107CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBFeHByLmZpbHRlclsnSUQnXSA9IGZ1bmN0aW9uIChpZCkgewogICAgICAgICAgdmFyIGF0dHJJZCA9IGlkLnJlcGxhY2UocnVuZXNjYXBlLCBmdW5lc2NhcGUpOwogICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgICAgIHJldHVybiBlbGVtLmdldEF0dHJpYnV0ZSgnaWQnKSA9PT0gYXR0cklkOwogICAgICAgICAgfTsKICAgICAgICB9OwogICAgICB9IGVsc2UgewogICAgICAgIC8vIFN1cHBvcnQ6IElFNi83CiAgICAgICAgLy8gZ2V0RWxlbWVudEJ5SWQgaXMgbm90IHJlbGlhYmxlIGFzIGEgZmluZCBzaG9ydGN1dAogICAgICAgIGRlbGV0ZSBFeHByLmZpbmRbJ0lEJ107CiAgICAgICAgRXhwci5maWx0ZXJbJ0lEJ10gPSBmdW5jdGlvbiAoaWQpIHsKICAgICAgICAgIHZhciBhdHRySWQgPSBpZC5yZXBsYWNlKHJ1bmVzY2FwZSwgZnVuZXNjYXBlKTsKICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgICB2YXIgbm9kZSA9IHR5cGVvZiBlbGVtLmdldEF0dHJpYnV0ZU5vZGUgIT09IHN0cnVuZGVmaW5lZCAmJiBlbGVtLmdldEF0dHJpYnV0ZU5vZGUoJ2lkJyk7CiAgICAgICAgICAgIHJldHVybiBub2RlICYmIG5vZGUudmFsdWUgPT09IGF0dHJJZDsKICAgICAgICAgIH07CiAgICAgICAgfTsKICAgICAgfQogICAgICAvLyBUYWcKICAgICAgRXhwci5maW5kWydUQUcnXSA9IHN1cHBvcnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUgPyBmdW5jdGlvbiAodGFnLCBjb250ZXh0KSB7CiAgICAgICAgaWYgKHR5cGVvZiBjb250ZXh0LmdldEVsZW1lbnRzQnlUYWdOYW1lICE9PSBzdHJ1bmRlZmluZWQpIHsKICAgICAgICAgIHJldHVybiBjb250ZXh0LmdldEVsZW1lbnRzQnlUYWdOYW1lKHRhZyk7CiAgICAgICAgfQogICAgICB9IDogZnVuY3Rpb24gKHRhZywgY29udGV4dCkgewogICAgICAgIHZhciBlbGVtLCB0bXAgPSBbXSwgaSA9IDAsIHJlc3VsdHMgPSBjb250ZXh0LmdldEVsZW1lbnRzQnlUYWdOYW1lKHRhZyk7CiAgICAgICAgLy8gRmlsdGVyIG91dCBwb3NzaWJsZSBjb21tZW50cwogICAgICAgIGlmICh0YWcgPT09ICcqJykgewogICAgICAgICAgd2hpbGUgKGVsZW0gPSByZXN1bHRzW2krK10pIHsKICAgICAgICAgICAgaWYgKGVsZW0ubm9kZVR5cGUgPT09IDEpIHsKICAgICAgICAgICAgICB0bXAucHVzaChlbGVtKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRtcDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdHM7CiAgICAgIH07CiAgICAgIC8vIENsYXNzCiAgICAgIEV4cHIuZmluZFsnQ0xBU1MnXSA9IHN1cHBvcnQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSAmJiBmdW5jdGlvbiAoY2xhc3NOYW1lLCBjb250ZXh0KSB7CiAgICAgICAgaWYgKHR5cGVvZiBjb250ZXh0LmdldEVsZW1lbnRzQnlDbGFzc05hbWUgIT09IHN0cnVuZGVmaW5lZCAmJiBkb2N1bWVudElzSFRNTCkgewogICAgICAgICAgcmV0dXJuIGNvbnRleHQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZShjbGFzc05hbWUpOwogICAgICAgIH0KICAgICAgfTsKICAgICAgLyogUVNBL21hdGNoZXNTZWxlY3RvcgogICAgICAJLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSAqLwogICAgICAvLyBRU0EgYW5kIG1hdGNoZXNTZWxlY3RvciBzdXBwb3J0CiAgICAgIC8vIG1hdGNoZXNTZWxlY3Rvcig6YWN0aXZlKSByZXBvcnRzIGZhbHNlIHdoZW4gdHJ1ZSAoSUU5L09wZXJhIDExLjUpCiAgICAgIHJidWdneU1hdGNoZXMgPSBbXTsKICAgICAgLy8gcVNhKDpmb2N1cykgcmVwb3J0cyBmYWxzZSB3aGVuIHRydWUgKENocm9tZSAyMSkKICAgICAgLy8gV2UgYWxsb3cgdGhpcyBiZWNhdXNlIG9mIGEgYnVnIGluIElFOC85IHRoYXQgdGhyb3dzIGFuIGVycm9yCiAgICAgIC8vIHdoZW5ldmVyIGBkb2N1bWVudC5hY3RpdmVFbGVtZW50YCBpcyBhY2Nlc3NlZCBvbiBhbiBpZnJhbWUKICAgICAgLy8gU28sIHdlIGFsbG93IDpmb2N1cyB0byBwYXNzIHRocm91Z2ggUVNBIGFsbCB0aGUgdGltZSB0byBhdm9pZCB0aGUgSUUgZXJyb3IKICAgICAgLy8gU2VlIGh0dHA6Ly9idWdzLmpxdWVyeS5jb20vdGlja2V0LzEzMzc4CiAgICAgIHJidWdneVFTQSA9IFtdOwogICAgICBpZiAoc3VwcG9ydC5xc2EgPSBybmF0aXZlLnRlc3QoZG9jLnF1ZXJ5U2VsZWN0b3JBbGwpKSB7CiAgICAgICAgLy8gQnVpbGQgUVNBIHJlZ2V4CiAgICAgICAgLy8gUmVnZXggc3RyYXRlZ3kgYWRvcHRlZCBmcm9tIERpZWdvIFBlcmluaQogICAgICAgIGFzc2VydChmdW5jdGlvbiAoZGl2KSB7CiAgICAgICAgICAvLyBTZWxlY3QgaXMgc2V0IHRvIGVtcHR5IHN0cmluZyBvbiBwdXJwb3NlCiAgICAgICAgICAvLyBUaGlzIGlzIHRvIHRlc3QgSUUncyB0cmVhdG1lbnQgb2Ygbm90IGV4cGxpY2l0bHkKICAgICAgICAgIC8vIHNldHRpbmcgYSBib29sZWFuIGNvbnRlbnQgYXR0cmlidXRlLAogICAgICAgICAgLy8gc2luY2UgaXRzIHByZXNlbmNlIHNob3VsZCBiZSBlbm91Z2gKICAgICAgICAgIC8vIGh0dHA6Ly9idWdzLmpxdWVyeS5jb20vdGlja2V0LzEyMzU5CiAgICAgICAgICBkaXYuaW5uZXJIVE1MID0gJzxzZWxlY3QgbXNhbGxvd2NsaXA9XCdcJz48b3B0aW9uIHNlbGVjdGVkPVwnXCc+PC9vcHRpb24+PC9zZWxlY3Q+JzsKICAgICAgICAgIC8vIFN1cHBvcnQ6IElFOCwgT3BlcmEgMTEtMTIuMTYKICAgICAgICAgIC8vIE5vdGhpbmcgc2hvdWxkIGJlIHNlbGVjdGVkIHdoZW4gZW1wdHkgc3RyaW5ncyBmb2xsb3cgXj0gb3IgJD0gb3IgKj0KICAgICAgICAgIC8vIFRoZSB0ZXN0IGF0dHJpYnV0ZSBtdXN0IGJlIHVua25vd24gaW4gT3BlcmEgYnV0ICJzYWZlIiBmb3IgV2luUlQKICAgICAgICAgIC8vIGh0dHA6Ly9tc2RuLm1pY3Jvc29mdC5jb20vZW4tdXMvbGlicmFyeS9pZS9oaDQ2NTM4OC5hc3B4I2F0dHJpYnV0ZV9zZWN0aW9uCiAgICAgICAgICBpZiAoZGl2LnF1ZXJ5U2VsZWN0b3JBbGwoJ1ttc2FsbG93Y2xpcF49XCdcJ10nKS5sZW5ndGgpIHsKICAgICAgICAgICAgcmJ1Z2d5UVNBLnB1c2goJ1sqXiRdPScgKyB3aGl0ZXNwYWNlICsgJyooPzpcJ1wnfCIiKScpOwogICAgICAgICAgfQogICAgICAgICAgLy8gU3VwcG9ydDogSUU4CiAgICAgICAgICAvLyBCb29sZWFuIGF0dHJpYnV0ZXMgYW5kICJ2YWx1ZSIgYXJlIG5vdCB0cmVhdGVkIGNvcnJlY3RseQogICAgICAgICAgaWYgKCFkaXYucXVlcnlTZWxlY3RvckFsbCgnW3NlbGVjdGVkXScpLmxlbmd0aCkgewogICAgICAgICAgICByYnVnZ3lRU0EucHVzaCgnXFxbJyArIHdoaXRlc3BhY2UgKyAnKig/OnZhbHVlfCcgKyBib29sZWFucyArICcpJyk7CiAgICAgICAgICB9CiAgICAgICAgICAvLyBXZWJraXQvT3BlcmEgLSA6Y2hlY2tlZCBzaG91bGQgcmV0dXJuIHNlbGVjdGVkIG9wdGlvbiBlbGVtZW50cwogICAgICAgICAgLy8gaHR0cDovL3d3dy53My5vcmcvVFIvMjAxMS9SRUMtY3NzMy1zZWxlY3RvcnMtMjAxMTA5MjkvI2NoZWNrZWQKICAgICAgICAgIC8vIElFOCB0aHJvd3MgZXJyb3IgaGVyZSBhbmQgd2lsbCBub3Qgc2VlIGxhdGVyIHRlc3RzCiAgICAgICAgICBpZiAoIWRpdi5xdWVyeVNlbGVjdG9yQWxsKCc6Y2hlY2tlZCcpLmxlbmd0aCkgewogICAgICAgICAgICByYnVnZ3lRU0EucHVzaCgnOmNoZWNrZWQnKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICBhc3NlcnQoZnVuY3Rpb24gKGRpdikgewogICAgICAgICAgLy8gU3VwcG9ydDogV2luZG93cyA4IE5hdGl2ZSBBcHBzCiAgICAgICAgICAvLyBUaGUgdHlwZSBhbmQgbmFtZSBhdHRyaWJ1dGVzIGFyZSByZXN0cmljdGVkIGR1cmluZyAuaW5uZXJIVE1MIGFzc2lnbm1lbnQKICAgICAgICAgIHZhciBpbnB1dCA9IGRvYy5jcmVhdGVFbGVtZW50KCdpbnB1dCcpOwogICAgICAgICAgaW5wdXQuc2V0QXR0cmlidXRlKCd0eXBlJywgJ2hpZGRlbicpOwogICAgICAgICAgZGl2LmFwcGVuZENoaWxkKGlucHV0KS5zZXRBdHRyaWJ1dGUoJ25hbWUnLCAnRCcpOwogICAgICAgICAgLy8gU3VwcG9ydDogSUU4CiAgICAgICAgICAvLyBFbmZvcmNlIGNhc2Utc2Vuc2l0aXZpdHkgb2YgbmFtZSBhdHRyaWJ1dGUKICAgICAgICAgIGlmIChkaXYucXVlcnlTZWxlY3RvckFsbCgnW25hbWU9ZF0nKS5sZW5ndGgpIHsKICAgICAgICAgICAgcmJ1Z2d5UVNBLnB1c2goJ25hbWUnICsgd2hpdGVzcGFjZSArICcqWypeJHwhfl0/PScpOwogICAgICAgICAgfQogICAgICAgICAgLy8gRkYgMy41IC0gOmVuYWJsZWQvOmRpc2FibGVkIGFuZCBoaWRkZW4gZWxlbWVudHMgKGhpZGRlbiBlbGVtZW50cyBhcmUgc3RpbGwgZW5hYmxlZCkKICAgICAgICAgIC8vIElFOCB0aHJvd3MgZXJyb3IgaGVyZSBhbmQgd2lsbCBub3Qgc2VlIGxhdGVyIHRlc3RzCiAgICAgICAgICBpZiAoIWRpdi5xdWVyeVNlbGVjdG9yQWxsKCc6ZW5hYmxlZCcpLmxlbmd0aCkgewogICAgICAgICAgICByYnVnZ3lRU0EucHVzaCgnOmVuYWJsZWQnLCAnOmRpc2FibGVkJyk7CiAgICAgICAgICB9CiAgICAgICAgICAvLyBPcGVyYSAxMC0xMSBkb2VzIG5vdCB0aHJvdyBvbiBwb3N0LWNvbW1hIGludmFsaWQgcHNldWRvcwogICAgICAgICAgZGl2LnF1ZXJ5U2VsZWN0b3JBbGwoJyosOngnKTsKICAgICAgICAgIHJidWdneVFTQS5wdXNoKCcsLio6Jyk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgaWYgKHN1cHBvcnQubWF0Y2hlc1NlbGVjdG9yID0gcm5hdGl2ZS50ZXN0KG1hdGNoZXMgPSBkb2NFbGVtLm1hdGNoZXMgfHwgZG9jRWxlbS53ZWJraXRNYXRjaGVzU2VsZWN0b3IgfHwgZG9jRWxlbS5tb3pNYXRjaGVzU2VsZWN0b3IgfHwgZG9jRWxlbS5vTWF0Y2hlc1NlbGVjdG9yIHx8IGRvY0VsZW0ubXNNYXRjaGVzU2VsZWN0b3IpKSB7CiAgICAgICAgYXNzZXJ0KGZ1bmN0aW9uIChkaXYpIHsKICAgICAgICAgIC8vIENoZWNrIHRvIHNlZSBpZiBpdCdzIHBvc3NpYmxlIHRvIGRvIG1hdGNoZXNTZWxlY3RvcgogICAgICAgICAgLy8gb24gYSBkaXNjb25uZWN0ZWQgbm9kZSAoSUUgOSkKICAgICAgICAgIHN1cHBvcnQuZGlzY29ubmVjdGVkTWF0Y2ggPSBtYXRjaGVzLmNhbGwoZGl2LCAnZGl2Jyk7CiAgICAgICAgICAvLyBUaGlzIHNob3VsZCBmYWlsIHdpdGggYW4gZXhjZXB0aW9uCiAgICAgICAgICAvLyBHZWNrbyBkb2VzIG5vdCBlcnJvciwgcmV0dXJucyBmYWxzZSBpbnN0ZWFkCiAgICAgICAgICBtYXRjaGVzLmNhbGwoZGl2LCAnW3MhPVwnXCddOngnKTsKICAgICAgICAgIHJidWdneU1hdGNoZXMucHVzaCgnIT0nLCBwc2V1ZG9zKTsKICAgICAgICB9KTsKICAgICAgfQogICAgICByYnVnZ3lRU0EgPSByYnVnZ3lRU0EubGVuZ3RoICYmIG5ldyBSZWdFeHAocmJ1Z2d5UVNBLmpvaW4oJ3wnKSk7CiAgICAgIHJidWdneU1hdGNoZXMgPSByYnVnZ3lNYXRjaGVzLmxlbmd0aCAmJiBuZXcgUmVnRXhwKHJidWdneU1hdGNoZXMuam9pbignfCcpKTsKICAgICAgLyogQ29udGFpbnMKICAgICAgCS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gKi8KICAgICAgaGFzQ29tcGFyZSA9IHJuYXRpdmUudGVzdChkb2NFbGVtLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uKTsKICAgICAgLy8gRWxlbWVudCBjb250YWlucyBhbm90aGVyCiAgICAgIC8vIFB1cnBvc2VmdWxseSBkb2VzIG5vdCBpbXBsZW1lbnQgaW5jbHVzaXZlIGRlc2NlbmRlbnQKICAgICAgLy8gQXMgaW4sIGFuIGVsZW1lbnQgZG9lcyBub3QgY29udGFpbiBpdHNlbGYKICAgICAgY29udGFpbnMgPSBoYXNDb21wYXJlIHx8IHJuYXRpdmUudGVzdChkb2NFbGVtLmNvbnRhaW5zKSA/IGZ1bmN0aW9uIChhLCBiKSB7CiAgICAgICAgdmFyIGFkb3duID0gYS5ub2RlVHlwZSA9PT0gOSA/IGEuZG9jdW1lbnRFbGVtZW50IDogYSwgYnVwID0gYiAmJiBiLnBhcmVudE5vZGU7CiAgICAgICAgcmV0dXJuIGEgPT09IGJ1cCB8fCAhIShidXAgJiYgYnVwLm5vZGVUeXBlID09PSAxICYmIChhZG93bi5jb250YWlucyA/IGFkb3duLmNvbnRhaW5zKGJ1cCkgOiBhLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uICYmIGEuY29tcGFyZURvY3VtZW50UG9zaXRpb24oYnVwKSAmIDE2KSk7CiAgICAgIH0gOiBmdW5jdGlvbiAoYSwgYikgewogICAgICAgIGlmIChiKSB7CiAgICAgICAgICB3aGlsZSAoYiA9IGIucGFyZW50Tm9kZSkgewogICAgICAgICAgICBpZiAoYiA9PT0gYSkgewogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfTsKICAgICAgLyogU29ydGluZwogICAgICAJLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSAqLwogICAgICAvLyBEb2N1bWVudCBvcmRlciBzb3J0aW5nCiAgICAgIHNvcnRPcmRlciA9IGhhc0NvbXBhcmUgPyBmdW5jdGlvbiAoYSwgYikgewogICAgICAgIC8vIEZsYWcgZm9yIGR1cGxpY2F0ZSByZW1vdmFsCiAgICAgICAgaWYgKGEgPT09IGIpIHsKICAgICAgICAgIGhhc0R1cGxpY2F0ZSA9IHRydWU7CiAgICAgICAgICByZXR1cm4gMDsKICAgICAgICB9CiAgICAgICAgLy8gU29ydCBvbiBtZXRob2QgZXhpc3RlbmNlIGlmIG9ubHkgb25lIGlucHV0IGhhcyBjb21wYXJlRG9jdW1lbnRQb3NpdGlvbgogICAgICAgIHZhciBjb21wYXJlID0gIWEuY29tcGFyZURvY3VtZW50UG9zaXRpb24gLSAhYi5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbjsKICAgICAgICBpZiAoY29tcGFyZSkgewogICAgICAgICAgcmV0dXJuIGNvbXBhcmU7CiAgICAgICAgfQogICAgICAgIC8vIENhbGN1bGF0ZSBwb3NpdGlvbiBpZiBib3RoIGlucHV0cyBiZWxvbmcgdG8gdGhlIHNhbWUgZG9jdW1lbnQKICAgICAgICBjb21wYXJlID0gKGEub3duZXJEb2N1bWVudCB8fCBhKSA9PT0gKGIub3duZXJEb2N1bWVudCB8fCBiKSA/IGEuY29tcGFyZURvY3VtZW50UG9zaXRpb24oYikgOiAvLyBPdGhlcndpc2Ugd2Uga25vdyB0aGV5IGFyZSBkaXNjb25uZWN0ZWQKICAgICAgICAxOwogICAgICAgIC8vIERpc2Nvbm5lY3RlZCBub2RlcwogICAgICAgIGlmIChjb21wYXJlICYgMSB8fCAhc3VwcG9ydC5zb3J0RGV0YWNoZWQgJiYgYi5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbihhKSA9PT0gY29tcGFyZSkgewogICAgICAgICAgLy8gQ2hvb3NlIHRoZSBmaXJzdCBlbGVtZW50IHRoYXQgaXMgcmVsYXRlZCB0byBvdXIgcHJlZmVycmVkIGRvY3VtZW50CiAgICAgICAgICBpZiAoYSA9PT0gZG9jIHx8IGEub3duZXJEb2N1bWVudCA9PT0gcHJlZmVycmVkRG9jICYmIGNvbnRhaW5zKHByZWZlcnJlZERvYywgYSkpIHsKICAgICAgICAgICAgcmV0dXJuIC0xOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGIgPT09IGRvYyB8fCBiLm93bmVyRG9jdW1lbnQgPT09IHByZWZlcnJlZERvYyAmJiBjb250YWlucyhwcmVmZXJyZWREb2MsIGIpKSB7CiAgICAgICAgICAgIHJldHVybiAxOwogICAgICAgICAgfQogICAgICAgICAgLy8gTWFpbnRhaW4gb3JpZ2luYWwgb3JkZXIKICAgICAgICAgIHJldHVybiBzb3J0SW5wdXQgPyBpbmRleE9mLmNhbGwoc29ydElucHV0LCBhKSAtIGluZGV4T2YuY2FsbChzb3J0SW5wdXQsIGIpIDogMDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGNvbXBhcmUgJiA0ID8gLTEgOiAxOwogICAgICB9IDogZnVuY3Rpb24gKGEsIGIpIHsKICAgICAgICAvLyBFeGl0IGVhcmx5IGlmIHRoZSBub2RlcyBhcmUgaWRlbnRpY2FsCiAgICAgICAgaWYgKGEgPT09IGIpIHsKICAgICAgICAgIGhhc0R1cGxpY2F0ZSA9IHRydWU7CiAgICAgICAgICByZXR1cm4gMDsKICAgICAgICB9CiAgICAgICAgdmFyIGN1ciwgaSA9IDAsIGF1cCA9IGEucGFyZW50Tm9kZSwgYnVwID0gYi5wYXJlbnROb2RlLCBhcCA9IFthXSwgYnAgPSBbYl07CiAgICAgICAgLy8gUGFyZW50bGVzcyBub2RlcyBhcmUgZWl0aGVyIGRvY3VtZW50cyBvciBkaXNjb25uZWN0ZWQKICAgICAgICBpZiAoIWF1cCB8fCAhYnVwKSB7CiAgICAgICAgICByZXR1cm4gYSA9PT0gZG9jID8gLTEgOiBiID09PSBkb2MgPyAxIDogYXVwID8gLTEgOiBidXAgPyAxIDogc29ydElucHV0ID8gaW5kZXhPZi5jYWxsKHNvcnRJbnB1dCwgYSkgLSBpbmRleE9mLmNhbGwoc29ydElucHV0LCBiKSA6IDA7ICAvLyBJZiB0aGUgbm9kZXMgYXJlIHNpYmxpbmdzLCB3ZSBjYW4gZG8gYSBxdWljayBjaGVjawogICAgICAgIH0gZWxzZSBpZiAoYXVwID09PSBidXApIHsKICAgICAgICAgIHJldHVybiBzaWJsaW5nQ2hlY2soYSwgYik7CiAgICAgICAgfQogICAgICAgIC8vIE90aGVyd2lzZSB3ZSBuZWVkIGZ1bGwgbGlzdHMgb2YgdGhlaXIgYW5jZXN0b3JzIGZvciBjb21wYXJpc29uCiAgICAgICAgY3VyID0gYTsKICAgICAgICB3aGlsZSAoY3VyID0gY3VyLnBhcmVudE5vZGUpIHsKICAgICAgICAgIGFwLnVuc2hpZnQoY3VyKTsKICAgICAgICB9CiAgICAgICAgY3VyID0gYjsKICAgICAgICB3aGlsZSAoY3VyID0gY3VyLnBhcmVudE5vZGUpIHsKICAgICAgICAgIGJwLnVuc2hpZnQoY3VyKTsKICAgICAgICB9CiAgICAgICAgLy8gV2FsayBkb3duIHRoZSB0cmVlIGxvb2tpbmcgZm9yIGEgZGlzY3JlcGFuY3kKICAgICAgICB3aGlsZSAoYXBbaV0gPT09IGJwW2ldKSB7CiAgICAgICAgICBpKys7CiAgICAgICAgfQogICAgICAgIHJldHVybiBpID8gLy8gRG8gYSBzaWJsaW5nIGNoZWNrIGlmIHRoZSBub2RlcyBoYXZlIGEgY29tbW9uIGFuY2VzdG9yCiAgICAgICAgc2libGluZ0NoZWNrKGFwW2ldLCBicFtpXSkgOiAvLyBPdGhlcndpc2Ugbm9kZXMgaW4gb3VyIGRvY3VtZW50IHNvcnQgZmlyc3QKICAgICAgICBhcFtpXSA9PT0gcHJlZmVycmVkRG9jID8gLTEgOiBicFtpXSA9PT0gcHJlZmVycmVkRG9jID8gMSA6IDA7CiAgICAgIH07CiAgICAgIHJldHVybiBkb2M7CiAgICB9OwogICAgU2l6emxlLm1hdGNoZXMgPSBmdW5jdGlvbiAoZXhwciwgZWxlbWVudHMpIHsKICAgICAgcmV0dXJuIFNpenpsZShleHByLCBudWxsLCBudWxsLCBlbGVtZW50cyk7CiAgICB9OwogICAgU2l6emxlLm1hdGNoZXNTZWxlY3RvciA9IGZ1bmN0aW9uIChlbGVtLCBleHByKSB7CiAgICAgIC8vIFNldCBkb2N1bWVudCB2YXJzIGlmIG5lZWRlZAogICAgICBpZiAoKGVsZW0ub3duZXJEb2N1bWVudCB8fCBlbGVtKSAhPT0gZG9jdW1lbnQpIHsKICAgICAgICBzZXREb2N1bWVudChlbGVtKTsKICAgICAgfQogICAgICAvLyBNYWtlIHN1cmUgdGhhdCBhdHRyaWJ1dGUgc2VsZWN0b3JzIGFyZSBxdW90ZWQKICAgICAgZXhwciA9IGV4cHIucmVwbGFjZShyYXR0cmlidXRlUXVvdGVzLCAnPVwnJDFcJ10nKTsKICAgICAgaWYgKHN1cHBvcnQubWF0Y2hlc1NlbGVjdG9yICYmIGRvY3VtZW50SXNIVE1MICYmICghcmJ1Z2d5TWF0Y2hlcyB8fCAhcmJ1Z2d5TWF0Y2hlcy50ZXN0KGV4cHIpKSAmJiAoIXJidWdneVFTQSB8fCAhcmJ1Z2d5UVNBLnRlc3QoZXhwcikpKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIHZhciByZXQgPSBtYXRjaGVzLmNhbGwoZWxlbSwgZXhwcik7CiAgICAgICAgICAvLyBJRSA5J3MgbWF0Y2hlc1NlbGVjdG9yIHJldHVybnMgZmFsc2Ugb24gZGlzY29ubmVjdGVkIG5vZGVzCiAgICAgICAgICBpZiAocmV0IHx8IHN1cHBvcnQuZGlzY29ubmVjdGVkTWF0Y2ggfHwgLy8gQXMgd2VsbCwgZGlzY29ubmVjdGVkIG5vZGVzIGFyZSBzYWlkIHRvIGJlIGluIGEgZG9jdW1lbnQKICAgICAgICAgICAgLy8gZnJhZ21lbnQgaW4gSUUgOQogICAgICAgICAgICBlbGVtLmRvY3VtZW50ICYmIGVsZW0uZG9jdW1lbnQubm9kZVR5cGUgIT09IDExKSB7CiAgICAgICAgICAgIHJldHVybiByZXQ7CiAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gU2l6emxlKGV4cHIsIGRvY3VtZW50LCBudWxsLCBbZWxlbV0pLmxlbmd0aCA+IDA7CiAgICB9OwogICAgU2l6emxlLmNvbnRhaW5zID0gZnVuY3Rpb24gKGNvbnRleHQsIGVsZW0pIHsKICAgICAgLy8gU2V0IGRvY3VtZW50IHZhcnMgaWYgbmVlZGVkCiAgICAgIGlmICgoY29udGV4dC5vd25lckRvY3VtZW50IHx8IGNvbnRleHQpICE9PSBkb2N1bWVudCkgewogICAgICAgIHNldERvY3VtZW50KGNvbnRleHQpOwogICAgICB9CiAgICAgIHJldHVybiBjb250YWlucyhjb250ZXh0LCBlbGVtKTsKICAgIH07CiAgICBTaXp6bGUuYXR0ciA9IGZ1bmN0aW9uIChlbGVtLCBuYW1lKSB7CiAgICAgIC8vIFNldCBkb2N1bWVudCB2YXJzIGlmIG5lZWRlZAogICAgICBpZiAoKGVsZW0ub3duZXJEb2N1bWVudCB8fCBlbGVtKSAhPT0gZG9jdW1lbnQpIHsKICAgICAgICBzZXREb2N1bWVudChlbGVtKTsKICAgICAgfQogICAgICB2YXIgZm4gPSBFeHByLmF0dHJIYW5kbGVbbmFtZS50b0xvd2VyQ2FzZSgpXSwKICAgICAgICAvLyBEb24ndCBnZXQgZm9vbGVkIGJ5IE9iamVjdC5wcm90b3R5cGUgcHJvcGVydGllcyAoalF1ZXJ5ICMxMzgwNykKICAgICAgICB2YWwgPSBmbiAmJiBoYXNPd24uY2FsbChFeHByLmF0dHJIYW5kbGUsIG5hbWUudG9Mb3dlckNhc2UoKSkgPyBmbihlbGVtLCBuYW1lLCAhZG9jdW1lbnRJc0hUTUwpIDogdW5kZWZpbmVkOwogICAgICByZXR1cm4gdmFsICE9PSB1bmRlZmluZWQgPyB2YWwgOiBzdXBwb3J0LmF0dHJpYnV0ZXMgfHwgIWRvY3VtZW50SXNIVE1MID8gZWxlbS5nZXRBdHRyaWJ1dGUobmFtZSkgOiAodmFsID0gZWxlbS5nZXRBdHRyaWJ1dGVOb2RlKG5hbWUpKSAmJiB2YWwuc3BlY2lmaWVkID8gdmFsLnZhbHVlIDogbnVsbDsKICAgIH07CiAgICBTaXp6bGUuZXJyb3IgPSBmdW5jdGlvbiAobXNnKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcignU3ludGF4IGVycm9yLCB1bnJlY29nbml6ZWQgZXhwcmVzc2lvbjogJyArIG1zZyk7CiAgICB9OwogICAgLyoqCiAgICAgKiBEb2N1bWVudCBzb3J0aW5nIGFuZCByZW1vdmluZyBkdXBsaWNhdGVzCiAgICAgKiBAcGFyYW0ge0FycmF5TGlrZX0gcmVzdWx0cwogICAgICovCiAgICBTaXp6bGUudW5pcXVlU29ydCA9IGZ1bmN0aW9uIChyZXN1bHRzKSB7CiAgICAgIHZhciBlbGVtLCBkdXBsaWNhdGVzID0gW10sIGogPSAwLCBpID0gMDsKICAgICAgLy8gVW5sZXNzIHdlICprbm93KiB3ZSBjYW4gZGV0ZWN0IGR1cGxpY2F0ZXMsIGFzc3VtZSB0aGVpciBwcmVzZW5jZQogICAgICBoYXNEdXBsaWNhdGUgPSAhc3VwcG9ydC5kZXRlY3REdXBsaWNhdGVzOwogICAgICBzb3J0SW5wdXQgPSAhc3VwcG9ydC5zb3J0U3RhYmxlICYmIHJlc3VsdHMuc2xpY2UoMCk7CiAgICAgIHJlc3VsdHMuc29ydChzb3J0T3JkZXIpOwogICAgICBpZiAoaGFzRHVwbGljYXRlKSB7CiAgICAgICAgd2hpbGUgKGVsZW0gPSByZXN1bHRzW2krK10pIHsKICAgICAgICAgIGlmIChlbGVtID09PSByZXN1bHRzW2ldKSB7CiAgICAgICAgICAgIGogPSBkdXBsaWNhdGVzLnB1c2goaSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHdoaWxlIChqLS0pIHsKICAgICAgICAgIHJlc3VsdHMuc3BsaWNlKGR1cGxpY2F0ZXNbal0sIDEpOwogICAgICAgIH0KICAgICAgfQogICAgICAvLyBDbGVhciBpbnB1dCBhZnRlciBzb3J0aW5nIHRvIHJlbGVhc2Ugb2JqZWN0cwogICAgICAvLyBTZWUgaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9zaXp6bGUvcHVsbC8yMjUKICAgICAgc29ydElucHV0ID0gbnVsbDsKICAgICAgcmV0dXJuIHJlc3VsdHM7CiAgICB9OwogICAgLyoqCiAgICAgKiBVdGlsaXR5IGZ1bmN0aW9uIGZvciByZXRyaWV2aW5nIHRoZSB0ZXh0IHZhbHVlIG9mIGFuIGFycmF5IG9mIERPTSBub2RlcwogICAgICogQHBhcmFtIHtBcnJheXxFbGVtZW50fSBlbGVtCiAgICAgKi8KICAgIGdldFRleHQgPSBTaXp6bGUuZ2V0VGV4dCA9IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgIHZhciBub2RlLCByZXQgPSAnJywgaSA9IDAsIG5vZGVUeXBlID0gZWxlbS5ub2RlVHlwZTsKICAgICAgaWYgKCFub2RlVHlwZSkgewogICAgICAgIC8vIElmIG5vIG5vZGVUeXBlLCB0aGlzIGlzIGV4cGVjdGVkIHRvIGJlIGFuIGFycmF5CiAgICAgICAgd2hpbGUgKG5vZGUgPSBlbGVtW2krK10pIHsKICAgICAgICAgIC8vIERvIG5vdCB0cmF2ZXJzZSBjb21tZW50IG5vZGVzCiAgICAgICAgICByZXQgKz0gZ2V0VGV4dChub2RlKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSBpZiAobm9kZVR5cGUgPT09IDEgfHwgbm9kZVR5cGUgPT09IDkgfHwgbm9kZVR5cGUgPT09IDExKSB7CiAgICAgICAgLy8gVXNlIHRleHRDb250ZW50IGZvciBlbGVtZW50cwogICAgICAgIC8vIGlubmVyVGV4dCB1c2FnZSByZW1vdmVkIGZvciBjb25zaXN0ZW5jeSBvZiBuZXcgbGluZXMgKGpRdWVyeSAjMTExNTMpCiAgICAgICAgaWYgKHR5cGVvZiBlbGVtLnRleHRDb250ZW50ID09PSAnc3RyaW5nJykgewogICAgICAgICAgcmV0dXJuIGVsZW0udGV4dENvbnRlbnQ7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIC8vIFRyYXZlcnNlIGl0cyBjaGlsZHJlbgogICAgICAgICAgZm9yIChlbGVtID0gZWxlbS5maXJzdENoaWxkOyBlbGVtOyBlbGVtID0gZWxlbS5uZXh0U2libGluZykgewogICAgICAgICAgICByZXQgKz0gZ2V0VGV4dChlbGVtKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0gZWxzZSBpZiAobm9kZVR5cGUgPT09IDMgfHwgbm9kZVR5cGUgPT09IDQpIHsKICAgICAgICByZXR1cm4gZWxlbS5ub2RlVmFsdWU7CiAgICAgIH0KICAgICAgLy8gRG8gbm90IGluY2x1ZGUgY29tbWVudCBvciBwcm9jZXNzaW5nIGluc3RydWN0aW9uIG5vZGVzCiAgICAgIHJldHVybiByZXQ7CiAgICB9OwogICAgRXhwciA9IFNpenpsZS5zZWxlY3RvcnMgPSB7CiAgICAgIC8vIENhbiBiZSBhZGp1c3RlZCBieSB0aGUgdXNlcgogICAgICBjYWNoZUxlbmd0aDogNTAsCiAgICAgIGNyZWF0ZVBzZXVkbzogbWFya0Z1bmN0aW9uLAogICAgICBtYXRjaDogbWF0Y2hFeHByLAogICAgICBhdHRySGFuZGxlOiB7fSwKICAgICAgZmluZDoge30sCiAgICAgIHJlbGF0aXZlOiB7CiAgICAgICAgJz4nOiB7CiAgICAgICAgICBkaXI6ICdwYXJlbnROb2RlJywKICAgICAgICAgIGZpcnN0OiB0cnVlCiAgICAgICAgfSwKICAgICAgICAnICc6IHsgZGlyOiAncGFyZW50Tm9kZScgfSwKICAgICAgICAnKyc6IHsKICAgICAgICAgIGRpcjogJ3ByZXZpb3VzU2libGluZycsCiAgICAgICAgICBmaXJzdDogdHJ1ZQogICAgICAgIH0sCiAgICAgICAgJ34nOiB7IGRpcjogJ3ByZXZpb3VzU2libGluZycgfQogICAgICB9LAogICAgICBwcmVGaWx0ZXI6IHsKICAgICAgICAnQVRUUic6IGZ1bmN0aW9uIChtYXRjaCkgewogICAgICAgICAgbWF0Y2hbMV0gPSBtYXRjaFsxXS5yZXBsYWNlKHJ1bmVzY2FwZSwgZnVuZXNjYXBlKTsKICAgICAgICAgIC8vIE1vdmUgdGhlIGdpdmVuIHZhbHVlIHRvIG1hdGNoWzNdIHdoZXRoZXIgcXVvdGVkIG9yIHVucXVvdGVkCiAgICAgICAgICBtYXRjaFszXSA9IChtYXRjaFszXSB8fCBtYXRjaFs0XSB8fCBtYXRjaFs1XSB8fCAnJykucmVwbGFjZShydW5lc2NhcGUsIGZ1bmVzY2FwZSk7CiAgICAgICAgICBpZiAobWF0Y2hbMl0gPT09ICd+PScpIHsKICAgICAgICAgICAgbWF0Y2hbM10gPSAnICcgKyBtYXRjaFszXSArICcgJzsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBtYXRjaC5zbGljZSgwLCA0KTsKICAgICAgICB9LAogICAgICAgICdDSElMRCc6IGZ1bmN0aW9uIChtYXRjaCkgewogICAgICAgICAgLyogbWF0Y2hlcyBmcm9tIG1hdGNoRXhwclsiQ0hJTEQiXQogICAgICAgICAgCQkxIHR5cGUgKG9ubHl8bnRofC4uLikKICAgICAgICAgIAkJMiB3aGF0IChjaGlsZHxvZi10eXBlKQogICAgICAgICAgCQkzIGFyZ3VtZW50IChldmVufG9kZHxcZCp8XGQqbihbKy1dXGQrKT98Li4uKQogICAgICAgICAgCQk0IHhuLWNvbXBvbmVudCBvZiB4bit5IGFyZ3VtZW50IChbKy1dP1xkKm58KQogICAgICAgICAgCQk1IHNpZ24gb2YgeG4tY29tcG9uZW50CiAgICAgICAgICAJCTYgeCBvZiB4bi1jb21wb25lbnQKICAgICAgICAgIAkJNyBzaWduIG9mIHktY29tcG9uZW50CiAgICAgICAgICAJCTggeSBvZiB5LWNvbXBvbmVudAogICAgICAgICAgCSovCiAgICAgICAgICBtYXRjaFsxXSA9IG1hdGNoWzFdLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICBpZiAobWF0Y2hbMV0uc2xpY2UoMCwgMykgPT09ICdudGgnKSB7CiAgICAgICAgICAgIC8vIG50aC0qIHJlcXVpcmVzIGFyZ3VtZW50CiAgICAgICAgICAgIGlmICghbWF0Y2hbM10pIHsKICAgICAgICAgICAgICBTaXp6bGUuZXJyb3IobWF0Y2hbMF0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIG51bWVyaWMgeCBhbmQgeSBwYXJhbWV0ZXJzIGZvciBFeHByLmZpbHRlci5DSElMRAogICAgICAgICAgICAvLyByZW1lbWJlciB0aGF0IGZhbHNlL3RydWUgY2FzdCByZXNwZWN0aXZlbHkgdG8gMC8xCiAgICAgICAgICAgIG1hdGNoWzRdID0gKyhtYXRjaFs0XSA/IG1hdGNoWzVdICsgKG1hdGNoWzZdIHx8IDEpIDogMiAqIChtYXRjaFszXSA9PT0gJ2V2ZW4nIHx8IG1hdGNoWzNdID09PSAnb2RkJykpOwogICAgICAgICAgICBtYXRjaFs1XSA9ICsobWF0Y2hbN10gKyBtYXRjaFs4XSB8fCBtYXRjaFszXSA9PT0gJ29kZCcpOyAgLy8gb3RoZXIgdHlwZXMgcHJvaGliaXQgYXJndW1lbnRzCiAgICAgICAgICB9IGVsc2UgaWYgKG1hdGNoWzNdKSB7CiAgICAgICAgICAgIFNpenpsZS5lcnJvcihtYXRjaFswXSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbWF0Y2g7CiAgICAgICAgfSwKICAgICAgICAnUFNFVURPJzogZnVuY3Rpb24gKG1hdGNoKSB7CiAgICAgICAgICB2YXIgZXhjZXNzLCB1bnF1b3RlZCA9ICFtYXRjaFs2XSAmJiBtYXRjaFsyXTsKICAgICAgICAgIGlmIChtYXRjaEV4cHJbJ0NISUxEJ10udGVzdChtYXRjaFswXSkpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICAvLyBBY2NlcHQgcXVvdGVkIGFyZ3VtZW50cyBhcy1pcwogICAgICAgICAgaWYgKG1hdGNoWzNdKSB7CiAgICAgICAgICAgIG1hdGNoWzJdID0gbWF0Y2hbNF0gfHwgbWF0Y2hbNV0gfHwgJyc7ICAvLyBTdHJpcCBleGNlc3MgY2hhcmFjdGVycyBmcm9tIHVucXVvdGVkIGFyZ3VtZW50cwogICAgICAgICAgfSBlbHNlIGlmICh1bnF1b3RlZCAmJiBycHNldWRvLnRlc3QodW5xdW90ZWQpICYmIChleGNlc3MgPSB0b2tlbml6ZSh1bnF1b3RlZCwgdHJ1ZSkpICYmIChleGNlc3MgPSB1bnF1b3RlZC5pbmRleE9mKCcpJywgdW5xdW90ZWQubGVuZ3RoIC0gZXhjZXNzKSAtIHVucXVvdGVkLmxlbmd0aCkpIHsKICAgICAgICAgICAgLy8gZXhjZXNzIGlzIGEgbmVnYXRpdmUgaW5kZXgKICAgICAgICAgICAgbWF0Y2hbMF0gPSBtYXRjaFswXS5zbGljZSgwLCBleGNlc3MpOwogICAgICAgICAgICBtYXRjaFsyXSA9IHVucXVvdGVkLnNsaWNlKDAsIGV4Y2Vzcyk7CiAgICAgICAgICB9CiAgICAgICAgICAvLyBSZXR1cm4gb25seSBjYXB0dXJlcyBuZWVkZWQgYnkgdGhlIHBzZXVkbyBmaWx0ZXIgbWV0aG9kICh0eXBlIGFuZCBhcmd1bWVudCkKICAgICAgICAgIHJldHVybiBtYXRjaC5zbGljZSgwLCAzKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIGZpbHRlcjogewogICAgICAgICdUQUcnOiBmdW5jdGlvbiAobm9kZU5hbWVTZWxlY3RvcikgewogICAgICAgICAgdmFyIG5vZGVOYW1lID0gbm9kZU5hbWVTZWxlY3Rvci5yZXBsYWNlKHJ1bmVzY2FwZSwgZnVuZXNjYXBlKS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgcmV0dXJuIG5vZGVOYW1lU2VsZWN0b3IgPT09ICcqJyA/IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9IDogZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICAgICAgcmV0dXJuIGVsZW0ubm9kZU5hbWUgJiYgZWxlbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpID09PSBub2RlTmFtZTsKICAgICAgICAgIH07CiAgICAgICAgfSwKICAgICAgICAnQ0xBU1MnOiBmdW5jdGlvbiAoY2xhc3NOYW1lKSB7CiAgICAgICAgICB2YXIgcGF0dGVybiA9IGNsYXNzQ2FjaGVbY2xhc3NOYW1lICsgJyAnXTsKICAgICAgICAgIHJldHVybiBwYXR0ZXJuIHx8IChwYXR0ZXJuID0gbmV3IFJlZ0V4cCgnKF58JyArIHdoaXRlc3BhY2UgKyAnKScgKyBjbGFzc05hbWUgKyAnKCcgKyB3aGl0ZXNwYWNlICsgJ3wkKScpKSAmJiBjbGFzc0NhY2hlKGNsYXNzTmFtZSwgZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICAgICAgcmV0dXJuIHBhdHRlcm4udGVzdCh0eXBlb2YgZWxlbS5jbGFzc05hbWUgPT09ICdzdHJpbmcnICYmIGVsZW0uY2xhc3NOYW1lIHx8IHR5cGVvZiBlbGVtLmdldEF0dHJpYnV0ZSAhPT0gc3RydW5kZWZpbmVkICYmIGVsZW0uZ2V0QXR0cmlidXRlKCdjbGFzcycpIHx8ICcnKTsKICAgICAgICAgIH0pOwogICAgICAgIH0sCiAgICAgICAgJ0FUVFInOiBmdW5jdGlvbiAobmFtZSwgb3BlcmF0b3IsIGNoZWNrKSB7CiAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICAgICAgdmFyIHJlc3VsdCA9IFNpenpsZS5hdHRyKGVsZW0sIG5hbWUpOwogICAgICAgICAgICBpZiAocmVzdWx0ID09IG51bGwpIHsKICAgICAgICAgICAgICByZXR1cm4gb3BlcmF0b3IgPT09ICchPSc7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCFvcGVyYXRvcikgewogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJlc3VsdCArPSAnJzsKICAgICAgICAgICAgcmV0dXJuIG9wZXJhdG9yID09PSAnPScgPyByZXN1bHQgPT09IGNoZWNrIDogb3BlcmF0b3IgPT09ICchPScgPyByZXN1bHQgIT09IGNoZWNrIDogb3BlcmF0b3IgPT09ICdePScgPyBjaGVjayAmJiByZXN1bHQuaW5kZXhPZihjaGVjaykgPT09IDAgOiBvcGVyYXRvciA9PT0gJyo9JyA/IGNoZWNrICYmIHJlc3VsdC5pbmRleE9mKGNoZWNrKSA+IC0xIDogb3BlcmF0b3IgPT09ICckPScgPyBjaGVjayAmJiByZXN1bHQuc2xpY2UoLWNoZWNrLmxlbmd0aCkgPT09IGNoZWNrIDogb3BlcmF0b3IgPT09ICd+PScgPyAoJyAnICsgcmVzdWx0ICsgJyAnKS5pbmRleE9mKGNoZWNrKSA+IC0xIDogb3BlcmF0b3IgPT09ICd8PScgPyByZXN1bHQgPT09IGNoZWNrIHx8IHJlc3VsdC5zbGljZSgwLCBjaGVjay5sZW5ndGggKyAxKSA9PT0gY2hlY2sgKyAnLScgOiBmYWxzZTsKICAgICAgICAgIH07CiAgICAgICAgfSwKICAgICAgICAnQ0hJTEQnOiBmdW5jdGlvbiAodHlwZSwgd2hhdCwgYXJndW1lbnQsIGZpcnN0LCBsYXN0KSB7CiAgICAgICAgICB2YXIgc2ltcGxlID0gdHlwZS5zbGljZSgwLCAzKSAhPT0gJ250aCcsIGZvcndhcmQgPSB0eXBlLnNsaWNlKC00KSAhPT0gJ2xhc3QnLCBvZlR5cGUgPSB3aGF0ID09PSAnb2YtdHlwZSc7CiAgICAgICAgICByZXR1cm4gZmlyc3QgPT09IDEgJiYgbGFzdCA9PT0gMCA/IC8vIFNob3J0Y3V0IGZvciA6bnRoLSoobikKICAgICAgICAgIGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgICAgIHJldHVybiAhIWVsZW0ucGFyZW50Tm9kZTsKICAgICAgICAgIH0gOiBmdW5jdGlvbiAoZWxlbSwgY29udGV4dCwgeG1sKSB7CiAgICAgICAgICAgIHZhciBjYWNoZSwgb3V0ZXJDYWNoZSwgbm9kZSwgZGlmZiwgbm9kZUluZGV4LCBzdGFydCwgZGlyID0gc2ltcGxlICE9PSBmb3J3YXJkID8gJ25leHRTaWJsaW5nJyA6ICdwcmV2aW91c1NpYmxpbmcnLCBwYXJlbnQgPSBlbGVtLnBhcmVudE5vZGUsIG5hbWUgPSBvZlR5cGUgJiYgZWxlbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpLCB1c2VDYWNoZSA9ICF4bWwgJiYgIW9mVHlwZTsKICAgICAgICAgICAgaWYgKHBhcmVudCkgewogICAgICAgICAgICAgIC8vIDooZmlyc3R8bGFzdHxvbmx5KS0oY2hpbGR8b2YtdHlwZSkKICAgICAgICAgICAgICBpZiAoc2ltcGxlKSB7CiAgICAgICAgICAgICAgICB3aGlsZSAoZGlyKSB7CiAgICAgICAgICAgICAgICAgIG5vZGUgPSBlbGVtOwogICAgICAgICAgICAgICAgICB3aGlsZSAobm9kZSA9IG5vZGVbZGlyXSkgewogICAgICAgICAgICAgICAgICAgIGlmIChvZlR5cGUgPyBub2RlLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09IG5hbWUgOiBub2RlLm5vZGVUeXBlID09PSAxKSB7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIC8vIFJldmVyc2UgZGlyZWN0aW9uIGZvciA6b25seS0qIChpZiB3ZSBoYXZlbid0IHlldCBkb25lIHNvKQogICAgICAgICAgICAgICAgICBzdGFydCA9IGRpciA9IHR5cGUgPT09ICdvbmx5JyAmJiAhc3RhcnQgJiYgJ25leHRTaWJsaW5nJzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBzdGFydCA9IFtmb3J3YXJkID8gcGFyZW50LmZpcnN0Q2hpbGQgOiBwYXJlbnQubGFzdENoaWxkXTsKICAgICAgICAgICAgICAvLyBub24teG1sIDpudGgtY2hpbGQoLi4uKSBzdG9yZXMgY2FjaGUgZGF0YSBvbiBgcGFyZW50YAogICAgICAgICAgICAgIGlmIChmb3J3YXJkICYmIHVzZUNhY2hlKSB7CiAgICAgICAgICAgICAgICAvLyBTZWVrIGBlbGVtYCBmcm9tIGEgcHJldmlvdXNseS1jYWNoZWQgaW5kZXgKICAgICAgICAgICAgICAgIG91dGVyQ2FjaGUgPSBwYXJlbnRbZXhwYW5kb10gfHwgKHBhcmVudFtleHBhbmRvXSA9IHt9KTsKICAgICAgICAgICAgICAgIGNhY2hlID0gb3V0ZXJDYWNoZVt0eXBlXSB8fCBbXTsKICAgICAgICAgICAgICAgIG5vZGVJbmRleCA9IGNhY2hlWzBdID09PSBkaXJydW5zICYmIGNhY2hlWzFdOwogICAgICAgICAgICAgICAgZGlmZiA9IGNhY2hlWzBdID09PSBkaXJydW5zICYmIGNhY2hlWzJdOwogICAgICAgICAgICAgICAgbm9kZSA9IG5vZGVJbmRleCAmJiBwYXJlbnQuY2hpbGROb2Rlc1tub2RlSW5kZXhdOwogICAgICAgICAgICAgICAgd2hpbGUgKG5vZGUgPSArK25vZGVJbmRleCAmJiBub2RlICYmIG5vZGVbZGlyXSB8fCAoZGlmZiA9IG5vZGVJbmRleCA9IDApIHx8IHN0YXJ0LnBvcCgpKSB7CiAgICAgICAgICAgICAgICAgIC8vIFdoZW4gZm91bmQsIGNhY2hlIGluZGV4ZXMgb24gYHBhcmVudGAgYW5kIGJyZWFrCiAgICAgICAgICAgICAgICAgIGlmIChub2RlLm5vZGVUeXBlID09PSAxICYmICsrZGlmZiAmJiBub2RlID09PSBlbGVtKSB7CiAgICAgICAgICAgICAgICAgICAgb3V0ZXJDYWNoZVt0eXBlXSA9IFsKICAgICAgICAgICAgICAgICAgICAgIGRpcnJ1bnMsCiAgICAgICAgICAgICAgICAgICAgICBub2RlSW5kZXgsCiAgICAgICAgICAgICAgICAgICAgICBkaWZmCiAgICAgICAgICAgICAgICAgICAgXTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSAgLy8gVXNlIHByZXZpb3VzbHktY2FjaGVkIGVsZW1lbnQgaW5kZXggaWYgYXZhaWxhYmxlCiAgICAgICAgICAgICAgfSBlbHNlIGlmICh1c2VDYWNoZSAmJiAoY2FjaGUgPSAoZWxlbVtleHBhbmRvXSB8fCAoZWxlbVtleHBhbmRvXSA9IHt9KSlbdHlwZV0pICYmIGNhY2hlWzBdID09PSBkaXJydW5zKSB7CiAgICAgICAgICAgICAgICBkaWZmID0gY2FjaGVbMV07ICAvLyB4bWwgOm50aC1jaGlsZCguLi4pIG9yIDpudGgtbGFzdC1jaGlsZCguLi4pIG9yIDpudGgoLWxhc3QpPy1vZi10eXBlKC4uLikKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gVXNlIHRoZSBzYW1lIGxvb3AgYXMgYWJvdmUgdG8gc2VlayBgZWxlbWAgZnJvbSB0aGUgc3RhcnQKICAgICAgICAgICAgICAgIHdoaWxlIChub2RlID0gKytub2RlSW5kZXggJiYgbm9kZSAmJiBub2RlW2Rpcl0gfHwgKGRpZmYgPSBub2RlSW5kZXggPSAwKSB8fCBzdGFydC5wb3AoKSkgewogICAgICAgICAgICAgICAgICBpZiAoKG9mVHlwZSA/IG5vZGUubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gbmFtZSA6IG5vZGUubm9kZVR5cGUgPT09IDEpICYmICsrZGlmZikgewogICAgICAgICAgICAgICAgICAgIC8vIENhY2hlIHRoZSBpbmRleCBvZiBlYWNoIGVuY291bnRlcmVkIGVsZW1lbnQKICAgICAgICAgICAgICAgICAgICBpZiAodXNlQ2FjaGUpIHsKICAgICAgICAgICAgICAgICAgICAgIChub2RlW2V4cGFuZG9dIHx8IChub2RlW2V4cGFuZG9dID0ge30pKVt0eXBlXSA9IFsKICAgICAgICAgICAgICAgICAgICAgICAgZGlycnVucywKICAgICAgICAgICAgICAgICAgICAgICAgZGlmZgogICAgICAgICAgICAgICAgICAgICAgXTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKG5vZGUgPT09IGVsZW0pIHsKICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAvLyBJbmNvcnBvcmF0ZSB0aGUgb2Zmc2V0LCB0aGVuIGNoZWNrIGFnYWluc3QgY3ljbGUgc2l6ZQogICAgICAgICAgICAgIGRpZmYgLT0gbGFzdDsKICAgICAgICAgICAgICByZXR1cm4gZGlmZiA9PT0gZmlyc3QgfHwgZGlmZiAlIGZpcnN0ID09PSAwICYmIGRpZmYgLyBmaXJzdCA+PSAwOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgIH0sCiAgICAgICAgJ1BTRVVETyc6IGZ1bmN0aW9uIChwc2V1ZG8sIGFyZ3VtZW50KSB7CiAgICAgICAgICAvLyBwc2V1ZG8tY2xhc3MgbmFtZXMgYXJlIGNhc2UtaW5zZW5zaXRpdmUKICAgICAgICAgIC8vIGh0dHA6Ly93d3cudzMub3JnL1RSL3NlbGVjdG9ycy8jcHNldWRvLWNsYXNzZXMKICAgICAgICAgIC8vIFByaW9yaXRpemUgYnkgY2FzZSBzZW5zaXRpdml0eSBpbiBjYXNlIGN1c3RvbSBwc2V1ZG9zIGFyZSBhZGRlZCB3aXRoIHVwcGVyY2FzZSBsZXR0ZXJzCiAgICAgICAgICAvLyBSZW1lbWJlciB0aGF0IHNldEZpbHRlcnMgaW5oZXJpdHMgZnJvbSBwc2V1ZG9zCiAgICAgICAgICB2YXIgYXJncywgZm4gPSBFeHByLnBzZXVkb3NbcHNldWRvXSB8fCBFeHByLnNldEZpbHRlcnNbcHNldWRvLnRvTG93ZXJDYXNlKCldIHx8IFNpenpsZS5lcnJvcigndW5zdXBwb3J0ZWQgcHNldWRvOiAnICsgcHNldWRvKTsKICAgICAgICAgIC8vIFRoZSB1c2VyIG1heSB1c2UgY3JlYXRlUHNldWRvIHRvIGluZGljYXRlIHRoYXQKICAgICAgICAgIC8vIGFyZ3VtZW50cyBhcmUgbmVlZGVkIHRvIGNyZWF0ZSB0aGUgZmlsdGVyIGZ1bmN0aW9uCiAgICAgICAgICAvLyBqdXN0IGFzIFNpenpsZSBkb2VzCiAgICAgICAgICBpZiAoZm5bZXhwYW5kb10pIHsKICAgICAgICAgICAgcmV0dXJuIGZuKGFyZ3VtZW50KTsKICAgICAgICAgIH0KICAgICAgICAgIC8vIEJ1dCBtYWludGFpbiBzdXBwb3J0IGZvciBvbGQgc2lnbmF0dXJlcwogICAgICAgICAgaWYgKGZuLmxlbmd0aCA+IDEpIHsKICAgICAgICAgICAgYXJncyA9IFsKICAgICAgICAgICAgICBwc2V1ZG8sCiAgICAgICAgICAgICAgcHNldWRvLAogICAgICAgICAgICAgICcnLAogICAgICAgICAgICAgIGFyZ3VtZW50CiAgICAgICAgICAgIF07CiAgICAgICAgICAgIHJldHVybiBFeHByLnNldEZpbHRlcnMuaGFzT3duUHJvcGVydHkocHNldWRvLnRvTG93ZXJDYXNlKCkpID8gbWFya0Z1bmN0aW9uKGZ1bmN0aW9uIChzZWVkLCBtYXRjaGVzKSB7CiAgICAgICAgICAgICAgdmFyIGlkeCwgbWF0Y2hlZCA9IGZuKHNlZWQsIGFyZ3VtZW50KSwgaSA9IG1hdGNoZWQubGVuZ3RoOwogICAgICAgICAgICAgIHdoaWxlIChpLS0pIHsKICAgICAgICAgICAgICAgIGlkeCA9IGluZGV4T2YuY2FsbChzZWVkLCBtYXRjaGVkW2ldKTsKICAgICAgICAgICAgICAgIHNlZWRbaWR4XSA9ICEobWF0Y2hlc1tpZHhdID0gbWF0Y2hlZFtpXSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KSA6IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZuKGVsZW0sIDAsIGFyZ3MpOwogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGZuOwogICAgICAgIH0KICAgICAgfSwKICAgICAgcHNldWRvczogewogICAgICAgIC8vIFBvdGVudGlhbGx5IGNvbXBsZXggcHNldWRvcwogICAgICAgICdub3QnOiBtYXJrRnVuY3Rpb24oZnVuY3Rpb24gKHNlbGVjdG9yKSB7CiAgICAgICAgICAvLyBUcmltIHRoZSBzZWxlY3RvciBwYXNzZWQgdG8gY29tcGlsZQogICAgICAgICAgLy8gdG8gYXZvaWQgdHJlYXRpbmcgbGVhZGluZyBhbmQgdHJhaWxpbmcKICAgICAgICAgIC8vIHNwYWNlcyBhcyBjb21iaW5hdG9ycwogICAgICAgICAgdmFyIGlucHV0ID0gW10sIHJlc3VsdHMgPSBbXSwgbWF0Y2hlciA9IGNvbXBpbGUoc2VsZWN0b3IucmVwbGFjZShydHJpbSwgJyQxJykpOwogICAgICAgICAgcmV0dXJuIG1hdGNoZXJbZXhwYW5kb10gPyBtYXJrRnVuY3Rpb24oZnVuY3Rpb24gKHNlZWQsIG1hdGNoZXMsIGNvbnRleHQsIHhtbCkgewogICAgICAgICAgICB2YXIgZWxlbSwgdW5tYXRjaGVkID0gbWF0Y2hlcihzZWVkLCBudWxsLCB4bWwsIFtdKSwgaSA9IHNlZWQubGVuZ3RoOwogICAgICAgICAgICAvLyBNYXRjaCBlbGVtZW50cyB1bm1hdGNoZWQgYnkgYG1hdGNoZXJgCiAgICAgICAgICAgIHdoaWxlIChpLS0pIHsKICAgICAgICAgICAgICBpZiAoZWxlbSA9IHVubWF0Y2hlZFtpXSkgewogICAgICAgICAgICAgICAgc2VlZFtpXSA9ICEobWF0Y2hlc1tpXSA9IGVsZW0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSkgOiBmdW5jdGlvbiAoZWxlbSwgY29udGV4dCwgeG1sKSB7CiAgICAgICAgICAgIGlucHV0WzBdID0gZWxlbTsKICAgICAgICAgICAgbWF0Y2hlcihpbnB1dCwgbnVsbCwgeG1sLCByZXN1bHRzKTsKICAgICAgICAgICAgcmV0dXJuICFyZXN1bHRzLnBvcCgpOwogICAgICAgICAgfTsKICAgICAgICB9KSwKICAgICAgICAnaGFzJzogbWFya0Z1bmN0aW9uKGZ1bmN0aW9uIChzZWxlY3RvcikgewogICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgICAgIHJldHVybiBTaXp6bGUoc2VsZWN0b3IsIGVsZW0pLmxlbmd0aCA+IDA7CiAgICAgICAgICB9OwogICAgICAgIH0pLAogICAgICAgICdjb250YWlucyc6IG1hcmtGdW5jdGlvbihmdW5jdGlvbiAodGV4dCkgewogICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgICAgIHJldHVybiAoZWxlbS50ZXh0Q29udGVudCB8fCBlbGVtLmlubmVyVGV4dCB8fCBnZXRUZXh0KGVsZW0pKS5pbmRleE9mKHRleHQpID4gLTE7CiAgICAgICAgICB9OwogICAgICAgIH0pLAogICAgICAgIC8vICJXaGV0aGVyIGFuIGVsZW1lbnQgaXMgcmVwcmVzZW50ZWQgYnkgYSA6bGFuZygpIHNlbGVjdG9yCiAgICAgICAgLy8gaXMgYmFzZWQgc29sZWx5IG9uIHRoZSBlbGVtZW50J3MgbGFuZ3VhZ2UgdmFsdWUKICAgICAgICAvLyBiZWluZyBlcXVhbCB0byB0aGUgaWRlbnRpZmllciBDLAogICAgICAgIC8vIG9yIGJlZ2lubmluZyB3aXRoIHRoZSBpZGVudGlmaWVyIEMgaW1tZWRpYXRlbHkgZm9sbG93ZWQgYnkgIi0iLgogICAgICAgIC8vIFRoZSBtYXRjaGluZyBvZiBDIGFnYWluc3QgdGhlIGVsZW1lbnQncyBsYW5ndWFnZSB2YWx1ZSBpcyBwZXJmb3JtZWQgY2FzZS1pbnNlbnNpdGl2ZWx5LgogICAgICAgIC8vIFRoZSBpZGVudGlmaWVyIEMgZG9lcyBub3QgaGF2ZSB0byBiZSBhIHZhbGlkIGxhbmd1YWdlIG5hbWUuIgogICAgICAgIC8vIGh0dHA6Ly93d3cudzMub3JnL1RSL3NlbGVjdG9ycy8jbGFuZy1wc2V1ZG8KICAgICAgICAnbGFuZyc6IG1hcmtGdW5jdGlvbihmdW5jdGlvbiAobGFuZykgewogICAgICAgICAgLy8gbGFuZyB2YWx1ZSBtdXN0IGJlIGEgdmFsaWQgaWRlbnRpZmllcgogICAgICAgICAgaWYgKCFyaWRlbnRpZmllci50ZXN0KGxhbmcgfHwgJycpKSB7CiAgICAgICAgICAgIFNpenpsZS5lcnJvcigndW5zdXBwb3J0ZWQgbGFuZzogJyArIGxhbmcpOwogICAgICAgICAgfQogICAgICAgICAgbGFuZyA9IGxhbmcucmVwbGFjZShydW5lc2NhcGUsIGZ1bmVzY2FwZSkudG9Mb3dlckNhc2UoKTsKICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgICB2YXIgZWxlbUxhbmc7CiAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICBpZiAoZWxlbUxhbmcgPSBkb2N1bWVudElzSFRNTCA/IGVsZW0ubGFuZyA6IGVsZW0uZ2V0QXR0cmlidXRlKCd4bWw6bGFuZycpIHx8IGVsZW0uZ2V0QXR0cmlidXRlKCdsYW5nJykpIHsKICAgICAgICAgICAgICAgIGVsZW1MYW5nID0gZWxlbUxhbmcudG9Mb3dlckNhc2UoKTsKICAgICAgICAgICAgICAgIHJldHVybiBlbGVtTGFuZyA9PT0gbGFuZyB8fCBlbGVtTGFuZy5pbmRleE9mKGxhbmcgKyAnLScpID09PSAwOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSB3aGlsZSAoKGVsZW0gPSBlbGVtLnBhcmVudE5vZGUpICYmIGVsZW0ubm9kZVR5cGUgPT09IDEpOwogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9OwogICAgICAgIH0pLAogICAgICAgIC8vIE1pc2NlbGxhbmVvdXMKICAgICAgICAndGFyZ2V0JzogZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICAgIHZhciBoYXNoID0gd2luZG93LmxvY2F0aW9uICYmIHdpbmRvdy5sb2NhdGlvbi5oYXNoOwogICAgICAgICAgcmV0dXJuIGhhc2ggJiYgaGFzaC5zbGljZSgxKSA9PT0gZWxlbS5pZDsKICAgICAgICB9LAogICAgICAgICdyb290JzogZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICAgIHJldHVybiBlbGVtID09PSBkb2NFbGVtOwogICAgICAgIH0sCiAgICAgICAgJ2ZvY3VzJzogZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICAgIHJldHVybiBlbGVtID09PSBkb2N1bWVudC5hY3RpdmVFbGVtZW50ICYmICghZG9jdW1lbnQuaGFzRm9jdXMgfHwgZG9jdW1lbnQuaGFzRm9jdXMoKSkgJiYgISEoZWxlbS50eXBlIHx8IGVsZW0uaHJlZiB8fCB+ZWxlbS50YWJJbmRleCk7CiAgICAgICAgfSwKICAgICAgICAvLyBCb29sZWFuIHByb3BlcnRpZXMKICAgICAgICAnZW5hYmxlZCc6IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgICByZXR1cm4gZWxlbS5kaXNhYmxlZCA9PT0gZmFsc2U7CiAgICAgICAgfSwKICAgICAgICAnZGlzYWJsZWQnOiBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgcmV0dXJuIGVsZW0uZGlzYWJsZWQgPT09IHRydWU7CiAgICAgICAgfSwKICAgICAgICAnY2hlY2tlZCc6IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgICAvLyBJbiBDU1MzLCA6Y2hlY2tlZCBzaG91bGQgcmV0dXJuIGJvdGggY2hlY2tlZCBhbmQgc2VsZWN0ZWQgZWxlbWVudHMKICAgICAgICAgIC8vIGh0dHA6Ly93d3cudzMub3JnL1RSLzIwMTEvUkVDLWNzczMtc2VsZWN0b3JzLTIwMTEwOTI5LyNjaGVja2VkCiAgICAgICAgICB2YXIgbm9kZU5hbWUgPSBlbGVtLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICByZXR1cm4gbm9kZU5hbWUgPT09ICdpbnB1dCcgJiYgISFlbGVtLmNoZWNrZWQgfHwgbm9kZU5hbWUgPT09ICdvcHRpb24nICYmICEhZWxlbS5zZWxlY3RlZDsKICAgICAgICB9LAogICAgICAgICdzZWxlY3RlZCc6IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgICAvLyBBY2Nlc3NpbmcgdGhpcyBwcm9wZXJ0eSBtYWtlcyBzZWxlY3RlZC1ieS1kZWZhdWx0CiAgICAgICAgICAvLyBvcHRpb25zIGluIFNhZmFyaSB3b3JrIHByb3Blcmx5CiAgICAgICAgICBpZiAoZWxlbS5wYXJlbnROb2RlKSB7CiAgICAgICAgICAgIGVsZW0ucGFyZW50Tm9kZS5zZWxlY3RlZEluZGV4OwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGVsZW0uc2VsZWN0ZWQgPT09IHRydWU7CiAgICAgICAgfSwKICAgICAgICAvLyBDb250ZW50cwogICAgICAgICdlbXB0eSc6IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgICAvLyBodHRwOi8vd3d3LnczLm9yZy9UUi9zZWxlY3RvcnMvI2VtcHR5LXBzZXVkbwogICAgICAgICAgLy8gOmVtcHR5IGlzIG5lZ2F0ZWQgYnkgZWxlbWVudCAoMSkgb3IgY29udGVudCBub2RlcyAodGV4dDogMzsgY2RhdGE6IDQ7IGVudGl0eSByZWY6IDUpLAogICAgICAgICAgLy8gICBidXQgbm90IGJ5IG90aGVycyAoY29tbWVudDogODsgcHJvY2Vzc2luZyBpbnN0cnVjdGlvbjogNzsgZXRjLikKICAgICAgICAgIC8vIG5vZGVUeXBlIDwgNiB3b3JrcyBiZWNhdXNlIGF0dHJpYnV0ZXMgKDIpIGRvIG5vdCBhcHBlYXIgYXMgY2hpbGRyZW4KICAgICAgICAgIGZvciAoZWxlbSA9IGVsZW0uZmlyc3RDaGlsZDsgZWxlbTsgZWxlbSA9IGVsZW0ubmV4dFNpYmxpbmcpIHsKICAgICAgICAgICAgaWYgKGVsZW0ubm9kZVR5cGUgPCA2KSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9LAogICAgICAgICdwYXJlbnQnOiBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgcmV0dXJuICFFeHByLnBzZXVkb3NbJ2VtcHR5J10oZWxlbSk7CiAgICAgICAgfSwKICAgICAgICAvLyBFbGVtZW50L2lucHV0IHR5cGVzCiAgICAgICAgJ2hlYWRlcic6IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgICByZXR1cm4gcmhlYWRlci50ZXN0KGVsZW0ubm9kZU5hbWUpOwogICAgICAgIH0sCiAgICAgICAgJ2lucHV0JzogZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICAgIHJldHVybiByaW5wdXRzLnRlc3QoZWxlbS5ub2RlTmFtZSk7CiAgICAgICAgfSwKICAgICAgICAnYnV0dG9uJzogZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICAgIHZhciBuYW1lID0gZWxlbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgcmV0dXJuIG5hbWUgPT09ICdpbnB1dCcgJiYgZWxlbS50eXBlID09PSAnYnV0dG9uJyB8fCBuYW1lID09PSAnYnV0dG9uJzsKICAgICAgICB9LAogICAgICAgICd0ZXh0JzogZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICAgIHZhciBhdHRyOwogICAgICAgICAgcmV0dXJuIGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gJ2lucHV0JyAmJiBlbGVtLnR5cGUgPT09ICd0ZXh0JyAmJiAoKGF0dHIgPSBlbGVtLmdldEF0dHJpYnV0ZSgndHlwZScpKSA9PSBudWxsIHx8IGF0dHIudG9Mb3dlckNhc2UoKSA9PT0gJ3RleHQnKTsKICAgICAgICB9LAogICAgICAgIC8vIFBvc2l0aW9uLWluLWNvbGxlY3Rpb24KICAgICAgICAnZmlyc3QnOiBjcmVhdGVQb3NpdGlvbmFsUHNldWRvKGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHJldHVybiBbMF07CiAgICAgICAgfSksCiAgICAgICAgJ2xhc3QnOiBjcmVhdGVQb3NpdGlvbmFsUHNldWRvKGZ1bmN0aW9uIChtYXRjaEluZGV4ZXMsIGxlbmd0aCkgewogICAgICAgICAgcmV0dXJuIFtsZW5ndGggLSAxXTsKICAgICAgICB9KSwKICAgICAgICAnZXEnOiBjcmVhdGVQb3NpdGlvbmFsUHNldWRvKGZ1bmN0aW9uIChtYXRjaEluZGV4ZXMsIGxlbmd0aCwgYXJndW1lbnQpIHsKICAgICAgICAgIHJldHVybiBbYXJndW1lbnQgPCAwID8gYXJndW1lbnQgKyBsZW5ndGggOiBhcmd1bWVudF07CiAgICAgICAgfSksCiAgICAgICAgJ2V2ZW4nOiBjcmVhdGVQb3NpdGlvbmFsUHNldWRvKGZ1bmN0aW9uIChtYXRjaEluZGV4ZXMsIGxlbmd0aCkgewogICAgICAgICAgdmFyIGkgPSAwOwogICAgICAgICAgZm9yICg7IGkgPCBsZW5ndGg7IGkgKz0gMikgewogICAgICAgICAgICBtYXRjaEluZGV4ZXMucHVzaChpKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBtYXRjaEluZGV4ZXM7CiAgICAgICAgfSksCiAgICAgICAgJ29kZCc6IGNyZWF0ZVBvc2l0aW9uYWxQc2V1ZG8oZnVuY3Rpb24gKG1hdGNoSW5kZXhlcywgbGVuZ3RoKSB7CiAgICAgICAgICB2YXIgaSA9IDE7CiAgICAgICAgICBmb3IgKDsgaSA8IGxlbmd0aDsgaSArPSAyKSB7CiAgICAgICAgICAgIG1hdGNoSW5kZXhlcy5wdXNoKGkpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG1hdGNoSW5kZXhlczsKICAgICAgICB9KSwKICAgICAgICAnbHQnOiBjcmVhdGVQb3NpdGlvbmFsUHNldWRvKGZ1bmN0aW9uIChtYXRjaEluZGV4ZXMsIGxlbmd0aCwgYXJndW1lbnQpIHsKICAgICAgICAgIHZhciBpID0gYXJndW1lbnQgPCAwID8gYXJndW1lbnQgKyBsZW5ndGggOiBhcmd1bWVudDsKICAgICAgICAgIGZvciAoOyAtLWkgPj0gMDspIHsKICAgICAgICAgICAgbWF0Y2hJbmRleGVzLnB1c2goaSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbWF0Y2hJbmRleGVzOwogICAgICAgIH0pLAogICAgICAgICdndCc6IGNyZWF0ZVBvc2l0aW9uYWxQc2V1ZG8oZnVuY3Rpb24gKG1hdGNoSW5kZXhlcywgbGVuZ3RoLCBhcmd1bWVudCkgewogICAgICAgICAgdmFyIGkgPSBhcmd1bWVudCA8IDAgPyBhcmd1bWVudCArIGxlbmd0aCA6IGFyZ3VtZW50OwogICAgICAgICAgZm9yICg7ICsraSA8IGxlbmd0aDspIHsKICAgICAgICAgICAgbWF0Y2hJbmRleGVzLnB1c2goaSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbWF0Y2hJbmRleGVzOwogICAgICAgIH0pCiAgICAgIH0KICAgIH07CiAgICBFeHByLnBzZXVkb3NbJ250aCddID0gRXhwci5wc2V1ZG9zWydlcSddOwogICAgLy8gQWRkIGJ1dHRvbi9pbnB1dCB0eXBlIHBzZXVkb3MKICAgIGZvciAoaSBpbiB7CiAgICAgICAgcmFkaW86IHRydWUsCiAgICAgICAgY2hlY2tib3g6IHRydWUsCiAgICAgICAgZmlsZTogdHJ1ZSwKICAgICAgICBwYXNzd29yZDogdHJ1ZSwKICAgICAgICBpbWFnZTogdHJ1ZQogICAgICB9KSB7CiAgICAgIEV4cHIucHNldWRvc1tpXSA9IGNyZWF0ZUlucHV0UHNldWRvKGkpOwogICAgfQogICAgZm9yIChpIGluIHsKICAgICAgICBzdWJtaXQ6IHRydWUsCiAgICAgICAgcmVzZXQ6IHRydWUKICAgICAgfSkgewogICAgICBFeHByLnBzZXVkb3NbaV0gPSBjcmVhdGVCdXR0b25Qc2V1ZG8oaSk7CiAgICB9CiAgICAvLyBFYXN5IEFQSSBmb3IgY3JlYXRpbmcgbmV3IHNldEZpbHRlcnMKICAgIGZ1bmN0aW9uIHNldEZpbHRlcnMoKSB7CiAgICB9CiAgICBzZXRGaWx0ZXJzLnByb3RvdHlwZSA9IEV4cHIuZmlsdGVycyA9IEV4cHIucHNldWRvczsKICAgIEV4cHIuc2V0RmlsdGVycyA9IG5ldyBzZXRGaWx0ZXJzKCk7CiAgICB0b2tlbml6ZSA9IFNpenpsZS50b2tlbml6ZSA9IGZ1bmN0aW9uIChzZWxlY3RvciwgcGFyc2VPbmx5KSB7CiAgICAgIHZhciBtYXRjaGVkLCBtYXRjaCwgdG9rZW5zLCB0eXBlLCBzb0ZhciwgZ3JvdXBzLCBwcmVGaWx0ZXJzLCBjYWNoZWQgPSB0b2tlbkNhY2hlW3NlbGVjdG9yICsgJyAnXTsKICAgICAgaWYgKGNhY2hlZCkgewogICAgICAgIHJldHVybiBwYXJzZU9ubHkgPyAwIDogY2FjaGVkLnNsaWNlKDApOwogICAgICB9CiAgICAgIHNvRmFyID0gc2VsZWN0b3I7CiAgICAgIGdyb3VwcyA9IFtdOwogICAgICBwcmVGaWx0ZXJzID0gRXhwci5wcmVGaWx0ZXI7CiAgICAgIHdoaWxlIChzb0ZhcikgewogICAgICAgIC8vIENvbW1hIGFuZCBmaXJzdCBydW4KICAgICAgICBpZiAoIW1hdGNoZWQgfHwgKG1hdGNoID0gcmNvbW1hLmV4ZWMoc29GYXIpKSkgewogICAgICAgICAgaWYgKG1hdGNoKSB7CiAgICAgICAgICAgIC8vIERvbid0IGNvbnN1bWUgdHJhaWxpbmcgY29tbWFzIGFzIHZhbGlkCiAgICAgICAgICAgIHNvRmFyID0gc29GYXIuc2xpY2UobWF0Y2hbMF0ubGVuZ3RoKSB8fCBzb0ZhcjsKICAgICAgICAgIH0KICAgICAgICAgIGdyb3Vwcy5wdXNoKHRva2VucyA9IFtdKTsKICAgICAgICB9CiAgICAgICAgbWF0Y2hlZCA9IGZhbHNlOwogICAgICAgIC8vIENvbWJpbmF0b3JzCiAgICAgICAgaWYgKG1hdGNoID0gcmNvbWJpbmF0b3JzLmV4ZWMoc29GYXIpKSB7CiAgICAgICAgICBtYXRjaGVkID0gbWF0Y2guc2hpZnQoKTsKICAgICAgICAgIHRva2Vucy5wdXNoKHsKICAgICAgICAgICAgdmFsdWU6IG1hdGNoZWQsCiAgICAgICAgICAgIC8vIENhc3QgZGVzY2VuZGFudCBjb21iaW5hdG9ycyB0byBzcGFjZQogICAgICAgICAgICB0eXBlOiBtYXRjaFswXS5yZXBsYWNlKHJ0cmltLCAnICcpCiAgICAgICAgICB9KTsKICAgICAgICAgIHNvRmFyID0gc29GYXIuc2xpY2UobWF0Y2hlZC5sZW5ndGgpOwogICAgICAgIH0KICAgICAgICAvLyBGaWx0ZXJzCiAgICAgICAgZm9yICh0eXBlIGluIEV4cHIuZmlsdGVyKSB7CiAgICAgICAgICBpZiAoKG1hdGNoID0gbWF0Y2hFeHByW3R5cGVdLmV4ZWMoc29GYXIpKSAmJiAoIXByZUZpbHRlcnNbdHlwZV0gfHwgKG1hdGNoID0gcHJlRmlsdGVyc1t0eXBlXShtYXRjaCkpKSkgewogICAgICAgICAgICBtYXRjaGVkID0gbWF0Y2guc2hpZnQoKTsKICAgICAgICAgICAgdG9rZW5zLnB1c2goewogICAgICAgICAgICAgIHZhbHVlOiBtYXRjaGVkLAogICAgICAgICAgICAgIHR5cGU6IHR5cGUsCiAgICAgICAgICAgICAgbWF0Y2hlczogbWF0Y2gKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHNvRmFyID0gc29GYXIuc2xpY2UobWF0Y2hlZC5sZW5ndGgpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoIW1hdGNoZWQpIHsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgfQogICAgICAvLyBSZXR1cm4gdGhlIGxlbmd0aCBvZiB0aGUgaW52YWxpZCBleGNlc3MKICAgICAgLy8gaWYgd2UncmUganVzdCBwYXJzaW5nCiAgICAgIC8vIE90aGVyd2lzZSwgdGhyb3cgYW4gZXJyb3Igb3IgcmV0dXJuIHRva2VucwogICAgICByZXR1cm4gcGFyc2VPbmx5ID8gc29GYXIubGVuZ3RoIDogc29GYXIgPyBTaXp6bGUuZXJyb3Ioc2VsZWN0b3IpIDogLy8gQ2FjaGUgdGhlIHRva2VucwogICAgICB0b2tlbkNhY2hlKHNlbGVjdG9yLCBncm91cHMpLnNsaWNlKDApOwogICAgfTsKICAgIGZ1bmN0aW9uIHRvU2VsZWN0b3IodG9rZW5zKSB7CiAgICAgIHZhciBpID0gMCwgbGVuID0gdG9rZW5zLmxlbmd0aCwgc2VsZWN0b3IgPSAnJzsKICAgICAgZm9yICg7IGkgPCBsZW47IGkrKykgewogICAgICAgIHNlbGVjdG9yICs9IHRva2Vuc1tpXS52YWx1ZTsKICAgICAgfQogICAgICByZXR1cm4gc2VsZWN0b3I7CiAgICB9CiAgICBmdW5jdGlvbiBhZGRDb21iaW5hdG9yKG1hdGNoZXIsIGNvbWJpbmF0b3IsIGJhc2UpIHsKICAgICAgdmFyIGRpciA9IGNvbWJpbmF0b3IuZGlyLCBjaGVja05vbkVsZW1lbnRzID0gYmFzZSAmJiBkaXIgPT09ICdwYXJlbnROb2RlJywgZG9uZU5hbWUgPSBkb25lKys7CiAgICAgIHJldHVybiBjb21iaW5hdG9yLmZpcnN0ID8gLy8gQ2hlY2sgYWdhaW5zdCBjbG9zZXN0IGFuY2VzdG9yL3ByZWNlZGluZyBlbGVtZW50CiAgICAgIGZ1bmN0aW9uIChlbGVtLCBjb250ZXh0LCB4bWwpIHsKICAgICAgICB3aGlsZSAoZWxlbSA9IGVsZW1bZGlyXSkgewogICAgICAgICAgaWYgKGVsZW0ubm9kZVR5cGUgPT09IDEgfHwgY2hlY2tOb25FbGVtZW50cykgewogICAgICAgICAgICByZXR1cm4gbWF0Y2hlcihlbGVtLCBjb250ZXh0LCB4bWwpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSA6IC8vIENoZWNrIGFnYWluc3QgYWxsIGFuY2VzdG9yL3ByZWNlZGluZyBlbGVtZW50cwogICAgICBmdW5jdGlvbiAoZWxlbSwgY29udGV4dCwgeG1sKSB7CiAgICAgICAgdmFyIG9sZENhY2hlLCBvdXRlckNhY2hlLCBuZXdDYWNoZSA9IFsKICAgICAgICAgICAgZGlycnVucywKICAgICAgICAgICAgZG9uZU5hbWUKICAgICAgICAgIF07CiAgICAgICAgLy8gV2UgY2FuJ3Qgc2V0IGFyYml0cmFyeSBkYXRhIG9uIFhNTCBub2Rlcywgc28gdGhleSBkb24ndCBiZW5lZml0IGZyb20gZGlyIGNhY2hpbmcKICAgICAgICBpZiAoeG1sKSB7CiAgICAgICAgICB3aGlsZSAoZWxlbSA9IGVsZW1bZGlyXSkgewogICAgICAgICAgICBpZiAoZWxlbS5ub2RlVHlwZSA9PT0gMSB8fCBjaGVja05vbkVsZW1lbnRzKSB7CiAgICAgICAgICAgICAgaWYgKG1hdGNoZXIoZWxlbSwgY29udGV4dCwgeG1sKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHdoaWxlIChlbGVtID0gZWxlbVtkaXJdKSB7CiAgICAgICAgICAgIGlmIChlbGVtLm5vZGVUeXBlID09PSAxIHx8IGNoZWNrTm9uRWxlbWVudHMpIHsKICAgICAgICAgICAgICBvdXRlckNhY2hlID0gZWxlbVtleHBhbmRvXSB8fCAoZWxlbVtleHBhbmRvXSA9IHt9KTsKICAgICAgICAgICAgICBpZiAoKG9sZENhY2hlID0gb3V0ZXJDYWNoZVtkaXJdKSAmJiBvbGRDYWNoZVswXSA9PT0gZGlycnVucyAmJiBvbGRDYWNoZVsxXSA9PT0gZG9uZU5hbWUpIHsKICAgICAgICAgICAgICAgIC8vIEFzc2lnbiB0byBuZXdDYWNoZSBzbyByZXN1bHRzIGJhY2stcHJvcGFnYXRlIHRvIHByZXZpb3VzIGVsZW1lbnRzCiAgICAgICAgICAgICAgICByZXR1cm4gbmV3Q2FjaGVbMl0gPSBvbGRDYWNoZVsyXTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gUmV1c2UgbmV3Y2FjaGUgc28gcmVzdWx0cyBiYWNrLXByb3BhZ2F0ZSB0byBwcmV2aW91cyBlbGVtZW50cwogICAgICAgICAgICAgICAgb3V0ZXJDYWNoZVtkaXJdID0gbmV3Q2FjaGU7CiAgICAgICAgICAgICAgICAvLyBBIG1hdGNoIG1lYW5zIHdlJ3JlIGRvbmU7IGEgZmFpbCBtZWFucyB3ZSBoYXZlIHRvIGtlZXAgY2hlY2tpbmcKICAgICAgICAgICAgICAgIGlmIChuZXdDYWNoZVsyXSA9IG1hdGNoZXIoZWxlbSwgY29udGV4dCwgeG1sKSkgewogICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH07CiAgICB9CiAgICBmdW5jdGlvbiBlbGVtZW50TWF0Y2hlcihtYXRjaGVycykgewogICAgICByZXR1cm4gbWF0Y2hlcnMubGVuZ3RoID4gMSA/IGZ1bmN0aW9uIChlbGVtLCBjb250ZXh0LCB4bWwpIHsKICAgICAgICB2YXIgaSA9IG1hdGNoZXJzLmxlbmd0aDsKICAgICAgICB3aGlsZSAoaS0tKSB7CiAgICAgICAgICBpZiAoIW1hdGNoZXJzW2ldKGVsZW0sIGNvbnRleHQsIHhtbCkpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfSA6IG1hdGNoZXJzWzBdOwogICAgfQogICAgZnVuY3Rpb24gbXVsdGlwbGVDb250ZXh0cyhzZWxlY3RvciwgY29udGV4dHMsIHJlc3VsdHMpIHsKICAgICAgdmFyIGkgPSAwLCBsZW4gPSBjb250ZXh0cy5sZW5ndGg7CiAgICAgIGZvciAoOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICBTaXp6bGUoc2VsZWN0b3IsIGNvbnRleHRzW2ldLCByZXN1bHRzKTsKICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0czsKICAgIH0KICAgIGZ1bmN0aW9uIGNvbmRlbnNlKHVubWF0Y2hlZCwgbWFwLCBmaWx0ZXIsIGNvbnRleHQsIHhtbCkgewogICAgICB2YXIgZWxlbSwgbmV3VW5tYXRjaGVkID0gW10sIGkgPSAwLCBsZW4gPSB1bm1hdGNoZWQubGVuZ3RoLCBtYXBwZWQgPSBtYXAgIT0gbnVsbDsKICAgICAgZm9yICg7IGkgPCBsZW47IGkrKykgewogICAgICAgIGlmIChlbGVtID0gdW5tYXRjaGVkW2ldKSB7CiAgICAgICAgICBpZiAoIWZpbHRlciB8fCBmaWx0ZXIoZWxlbSwgY29udGV4dCwgeG1sKSkgewogICAgICAgICAgICBuZXdVbm1hdGNoZWQucHVzaChlbGVtKTsKICAgICAgICAgICAgaWYgKG1hcHBlZCkgewogICAgICAgICAgICAgIG1hcC5wdXNoKGkpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBuZXdVbm1hdGNoZWQ7CiAgICB9CiAgICBmdW5jdGlvbiBzZXRNYXRjaGVyKHByZUZpbHRlciwgc2VsZWN0b3IsIG1hdGNoZXIsIHBvc3RGaWx0ZXIsIHBvc3RGaW5kZXIsIHBvc3RTZWxlY3RvcikgewogICAgICBpZiAocG9zdEZpbHRlciAmJiAhcG9zdEZpbHRlcltleHBhbmRvXSkgewogICAgICAgIHBvc3RGaWx0ZXIgPSBzZXRNYXRjaGVyKHBvc3RGaWx0ZXIpOwogICAgICB9CiAgICAgIGlmIChwb3N0RmluZGVyICYmICFwb3N0RmluZGVyW2V4cGFuZG9dKSB7CiAgICAgICAgcG9zdEZpbmRlciA9IHNldE1hdGNoZXIocG9zdEZpbmRlciwgcG9zdFNlbGVjdG9yKTsKICAgICAgfQogICAgICByZXR1cm4gbWFya0Z1bmN0aW9uKGZ1bmN0aW9uIChzZWVkLCByZXN1bHRzLCBjb250ZXh0LCB4bWwpIHsKICAgICAgICB2YXIgdGVtcCwgaSwgZWxlbSwgcHJlTWFwID0gW10sIHBvc3RNYXAgPSBbXSwgcHJlZXhpc3RpbmcgPSByZXN1bHRzLmxlbmd0aCwKICAgICAgICAgIC8vIEdldCBpbml0aWFsIGVsZW1lbnRzIGZyb20gc2VlZCBvciBjb250ZXh0CiAgICAgICAgICBlbGVtcyA9IHNlZWQgfHwgbXVsdGlwbGVDb250ZXh0cyhzZWxlY3RvciB8fCAnKicsIGNvbnRleHQubm9kZVR5cGUgPyBbY29udGV4dF0gOiBjb250ZXh0LCBbXSksCiAgICAgICAgICAvLyBQcmVmaWx0ZXIgdG8gZ2V0IG1hdGNoZXIgaW5wdXQsIHByZXNlcnZpbmcgYSBtYXAgZm9yIHNlZWQtcmVzdWx0cyBzeW5jaHJvbml6YXRpb24KICAgICAgICAgIG1hdGNoZXJJbiA9IHByZUZpbHRlciAmJiAoc2VlZCB8fCAhc2VsZWN0b3IpID8gY29uZGVuc2UoZWxlbXMsIHByZU1hcCwgcHJlRmlsdGVyLCBjb250ZXh0LCB4bWwpIDogZWxlbXMsIG1hdGNoZXJPdXQgPSBtYXRjaGVyID8gLy8gSWYgd2UgaGF2ZSBhIHBvc3RGaW5kZXIsIG9yIGZpbHRlcmVkIHNlZWQsIG9yIG5vbi1zZWVkIHBvc3RGaWx0ZXIgb3IgcHJlZXhpc3RpbmcgcmVzdWx0cywKICAgICAgICAgIHBvc3RGaW5kZXIgfHwgKHNlZWQgPyBwcmVGaWx0ZXIgOiBwcmVleGlzdGluZyB8fCBwb3N0RmlsdGVyKSA/IC8vIC4uLmludGVybWVkaWF0ZSBwcm9jZXNzaW5nIGlzIG5lY2Vzc2FyeQogICAgICAgICAgW10gOiAvLyAuLi5vdGhlcndpc2UgdXNlIHJlc3VsdHMgZGlyZWN0bHkKICAgICAgICAgIHJlc3VsdHMgOiBtYXRjaGVySW47CiAgICAgICAgLy8gRmluZCBwcmltYXJ5IG1hdGNoZXMKICAgICAgICBpZiAobWF0Y2hlcikgewogICAgICAgICAgbWF0Y2hlcihtYXRjaGVySW4sIG1hdGNoZXJPdXQsIGNvbnRleHQsIHhtbCk7CiAgICAgICAgfQogICAgICAgIC8vIEFwcGx5IHBvc3RGaWx0ZXIKICAgICAgICBpZiAocG9zdEZpbHRlcikgewogICAgICAgICAgdGVtcCA9IGNvbmRlbnNlKG1hdGNoZXJPdXQsIHBvc3RNYXApOwogICAgICAgICAgcG9zdEZpbHRlcih0ZW1wLCBbXSwgY29udGV4dCwgeG1sKTsKICAgICAgICAgIC8vIFVuLW1hdGNoIGZhaWxpbmcgZWxlbWVudHMgYnkgbW92aW5nIHRoZW0gYmFjayB0byBtYXRjaGVySW4KICAgICAgICAgIGkgPSB0ZW1wLmxlbmd0aDsKICAgICAgICAgIHdoaWxlIChpLS0pIHsKICAgICAgICAgICAgaWYgKGVsZW0gPSB0ZW1wW2ldKSB7CiAgICAgICAgICAgICAgbWF0Y2hlck91dFtwb3N0TWFwW2ldXSA9ICEobWF0Y2hlckluW3Bvc3RNYXBbaV1dID0gZWxlbSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKHNlZWQpIHsKICAgICAgICAgIGlmIChwb3N0RmluZGVyIHx8IHByZUZpbHRlcikgewogICAgICAgICAgICBpZiAocG9zdEZpbmRlcikgewogICAgICAgICAgICAgIC8vIEdldCB0aGUgZmluYWwgbWF0Y2hlck91dCBieSBjb25kZW5zaW5nIHRoaXMgaW50ZXJtZWRpYXRlIGludG8gcG9zdEZpbmRlciBjb250ZXh0cwogICAgICAgICAgICAgIHRlbXAgPSBbXTsKICAgICAgICAgICAgICBpID0gbWF0Y2hlck91dC5sZW5ndGg7CiAgICAgICAgICAgICAgd2hpbGUgKGktLSkgewogICAgICAgICAgICAgICAgaWYgKGVsZW0gPSBtYXRjaGVyT3V0W2ldKSB7CiAgICAgICAgICAgICAgICAgIC8vIFJlc3RvcmUgbWF0Y2hlckluIHNpbmNlIGVsZW0gaXMgbm90IHlldCBhIGZpbmFsIG1hdGNoCiAgICAgICAgICAgICAgICAgIHRlbXAucHVzaChtYXRjaGVySW5baV0gPSBlbGVtKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcG9zdEZpbmRlcihudWxsLCBtYXRjaGVyT3V0ID0gW10sIHRlbXAsIHhtbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gTW92ZSBtYXRjaGVkIGVsZW1lbnRzIGZyb20gc2VlZCB0byByZXN1bHRzIHRvIGtlZXAgdGhlbSBzeW5jaHJvbml6ZWQKICAgICAgICAgICAgaSA9IG1hdGNoZXJPdXQubGVuZ3RoOwogICAgICAgICAgICB3aGlsZSAoaS0tKSB7CiAgICAgICAgICAgICAgaWYgKChlbGVtID0gbWF0Y2hlck91dFtpXSkgJiYgKHRlbXAgPSBwb3N0RmluZGVyID8gaW5kZXhPZi5jYWxsKHNlZWQsIGVsZW0pIDogcHJlTWFwW2ldKSA+IC0xKSB7CiAgICAgICAgICAgICAgICBzZWVkW3RlbXBdID0gIShyZXN1bHRzW3RlbXBdID0gZWxlbSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9ICAvLyBBZGQgZWxlbWVudHMgdG8gcmVzdWx0cywgdGhyb3VnaCBwb3N0RmluZGVyIGlmIGRlZmluZWQKICAgICAgICB9IGVsc2UgewogICAgICAgICAgbWF0Y2hlck91dCA9IGNvbmRlbnNlKG1hdGNoZXJPdXQgPT09IHJlc3VsdHMgPyBtYXRjaGVyT3V0LnNwbGljZShwcmVleGlzdGluZywgbWF0Y2hlck91dC5sZW5ndGgpIDogbWF0Y2hlck91dCk7CiAgICAgICAgICBpZiAocG9zdEZpbmRlcikgewogICAgICAgICAgICBwb3N0RmluZGVyKG51bGwsIHJlc3VsdHMsIG1hdGNoZXJPdXQsIHhtbCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBwdXNoLmFwcGx5KHJlc3VsdHMsIG1hdGNoZXJPdXQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgICBmdW5jdGlvbiBtYXRjaGVyRnJvbVRva2Vucyh0b2tlbnMpIHsKICAgICAgdmFyIGNoZWNrQ29udGV4dCwgbWF0Y2hlciwgaiwgbGVuID0gdG9rZW5zLmxlbmd0aCwgbGVhZGluZ1JlbGF0aXZlID0gRXhwci5yZWxhdGl2ZVt0b2tlbnNbMF0udHlwZV0sIGltcGxpY2l0UmVsYXRpdmUgPSBsZWFkaW5nUmVsYXRpdmUgfHwgRXhwci5yZWxhdGl2ZVsnICddLCBpID0gbGVhZGluZ1JlbGF0aXZlID8gMSA6IDAsCiAgICAgICAgLy8gVGhlIGZvdW5kYXRpb25hbCBtYXRjaGVyIGVuc3VyZXMgdGhhdCBlbGVtZW50cyBhcmUgcmVhY2hhYmxlIGZyb20gdG9wLWxldmVsIGNvbnRleHQocykKICAgICAgICBtYXRjaENvbnRleHQgPSBhZGRDb21iaW5hdG9yKGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgICByZXR1cm4gZWxlbSA9PT0gY2hlY2tDb250ZXh0OwogICAgICAgIH0sIGltcGxpY2l0UmVsYXRpdmUsIHRydWUpLCBtYXRjaEFueUNvbnRleHQgPSBhZGRDb21iaW5hdG9yKGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgICByZXR1cm4gaW5kZXhPZi5jYWxsKGNoZWNrQ29udGV4dCwgZWxlbSkgPiAtMTsKICAgICAgICB9LCBpbXBsaWNpdFJlbGF0aXZlLCB0cnVlKSwgbWF0Y2hlcnMgPSBbZnVuY3Rpb24gKGVsZW0sIGNvbnRleHQsIHhtbCkgewogICAgICAgICAgICByZXR1cm4gIWxlYWRpbmdSZWxhdGl2ZSAmJiAoeG1sIHx8IGNvbnRleHQgIT09IG91dGVybW9zdENvbnRleHQpIHx8ICgoY2hlY2tDb250ZXh0ID0gY29udGV4dCkubm9kZVR5cGUgPyBtYXRjaENvbnRleHQoZWxlbSwgY29udGV4dCwgeG1sKSA6IG1hdGNoQW55Q29udGV4dChlbGVtLCBjb250ZXh0LCB4bWwpKTsKICAgICAgICAgIH1dOwogICAgICBmb3IgKDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgaWYgKG1hdGNoZXIgPSBFeHByLnJlbGF0aXZlW3Rva2Vuc1tpXS50eXBlXSkgewogICAgICAgICAgbWF0Y2hlcnMgPSBbYWRkQ29tYmluYXRvcihlbGVtZW50TWF0Y2hlcihtYXRjaGVycyksIG1hdGNoZXIpXTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgbWF0Y2hlciA9IEV4cHIuZmlsdGVyW3Rva2Vuc1tpXS50eXBlXS5hcHBseShudWxsLCB0b2tlbnNbaV0ubWF0Y2hlcyk7CiAgICAgICAgICAvLyBSZXR1cm4gc3BlY2lhbCB1cG9uIHNlZWluZyBhIHBvc2l0aW9uYWwgbWF0Y2hlcgogICAgICAgICAgaWYgKG1hdGNoZXJbZXhwYW5kb10pIHsKICAgICAgICAgICAgLy8gRmluZCB0aGUgbmV4dCByZWxhdGl2ZSBvcGVyYXRvciAoaWYgYW55KSBmb3IgcHJvcGVyIGhhbmRsaW5nCiAgICAgICAgICAgIGogPSArK2k7CiAgICAgICAgICAgIGZvciAoOyBqIDwgbGVuOyBqKyspIHsKICAgICAgICAgICAgICBpZiAoRXhwci5yZWxhdGl2ZVt0b2tlbnNbal0udHlwZV0pIHsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gc2V0TWF0Y2hlcihpID4gMSAmJiBlbGVtZW50TWF0Y2hlcihtYXRjaGVycyksIGkgPiAxICYmIHRvU2VsZWN0b3IoLy8gSWYgdGhlIHByZWNlZGluZyB0b2tlbiB3YXMgYSBkZXNjZW5kYW50IGNvbWJpbmF0b3IsIGluc2VydCBhbiBpbXBsaWNpdCBhbnktZWxlbWVudCBgKmAKICAgICAgICAgICAgdG9rZW5zLnNsaWNlKDAsIGkgLSAxKS5jb25jYXQoeyB2YWx1ZTogdG9rZW5zW2kgLSAyXS50eXBlID09PSAnICcgPyAnKicgOiAnJyB9KSkucmVwbGFjZShydHJpbSwgJyQxJyksIG1hdGNoZXIsIGkgPCBqICYmIG1hdGNoZXJGcm9tVG9rZW5zKHRva2Vucy5zbGljZShpLCBqKSksIGogPCBsZW4gJiYgbWF0Y2hlckZyb21Ub2tlbnModG9rZW5zID0gdG9rZW5zLnNsaWNlKGopKSwgaiA8IGxlbiAmJiB0b1NlbGVjdG9yKHRva2VucykpOwogICAgICAgICAgfQogICAgICAgICAgbWF0Y2hlcnMucHVzaChtYXRjaGVyKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIGVsZW1lbnRNYXRjaGVyKG1hdGNoZXJzKTsKICAgIH0KICAgIGZ1bmN0aW9uIG1hdGNoZXJGcm9tR3JvdXBNYXRjaGVycyhlbGVtZW50TWF0Y2hlcnMsIHNldE1hdGNoZXJzKSB7CiAgICAgIHZhciBieVNldCA9IHNldE1hdGNoZXJzLmxlbmd0aCA+IDAsIGJ5RWxlbWVudCA9IGVsZW1lbnRNYXRjaGVycy5sZW5ndGggPiAwLCBzdXBlck1hdGNoZXIgPSBmdW5jdGlvbiAoc2VlZCwgY29udGV4dCwgeG1sLCByZXN1bHRzLCBvdXRlcm1vc3QpIHsKICAgICAgICAgIHZhciBlbGVtLCBqLCBtYXRjaGVyLCBtYXRjaGVkQ291bnQgPSAwLCBpID0gJzAnLCB1bm1hdGNoZWQgPSBzZWVkICYmIFtdLCBzZXRNYXRjaGVkID0gW10sIGNvbnRleHRCYWNrdXAgPSBvdXRlcm1vc3RDb250ZXh0LAogICAgICAgICAgICAvLyBXZSBtdXN0IGFsd2F5cyBoYXZlIGVpdGhlciBzZWVkIGVsZW1lbnRzIG9yIG91dGVybW9zdCBjb250ZXh0CiAgICAgICAgICAgIGVsZW1zID0gc2VlZCB8fCBieUVsZW1lbnQgJiYgRXhwci5maW5kWydUQUcnXSgnKicsIG91dGVybW9zdCksCiAgICAgICAgICAgIC8vIFVzZSBpbnRlZ2VyIGRpcnJ1bnMgaWZmIHRoaXMgaXMgdGhlIG91dGVybW9zdCBtYXRjaGVyCiAgICAgICAgICAgIGRpcnJ1bnNVbmlxdWUgPSBkaXJydW5zICs9IGNvbnRleHRCYWNrdXAgPT0gbnVsbCA/IDEgOiBNYXRoLnJhbmRvbSgpIHx8IDAuMSwgbGVuID0gZWxlbXMubGVuZ3RoOwogICAgICAgICAgaWYgKG91dGVybW9zdCkgewogICAgICAgICAgICBvdXRlcm1vc3RDb250ZXh0ID0gY29udGV4dCAhPT0gZG9jdW1lbnQgJiYgY29udGV4dDsKICAgICAgICAgIH0KICAgICAgICAgIC8vIEFkZCBlbGVtZW50cyBwYXNzaW5nIGVsZW1lbnRNYXRjaGVycyBkaXJlY3RseSB0byByZXN1bHRzCiAgICAgICAgICAvLyBLZWVwIGBpYCBhIHN0cmluZyBpZiB0aGVyZSBhcmUgbm8gZWxlbWVudHMgc28gYG1hdGNoZWRDb3VudGAgd2lsbCBiZSAiMDAiIGJlbG93CiAgICAgICAgICAvLyBTdXBwb3J0OiBJRTw5LCBTYWZhcmkKICAgICAgICAgIC8vIFRvbGVyYXRlIE5vZGVMaXN0IHByb3BlcnRpZXMgKElFOiAibGVuZ3RoIjsgU2FmYXJpOiA8bnVtYmVyPikgbWF0Y2hpbmcgZWxlbWVudHMgYnkgaWQKICAgICAgICAgIGZvciAoOyBpICE9PSBsZW4gJiYgKGVsZW0gPSBlbGVtc1tpXSkgIT0gbnVsbDsgaSsrKSB7CiAgICAgICAgICAgIGlmIChieUVsZW1lbnQgJiYgZWxlbSkgewogICAgICAgICAgICAgIGogPSAwOwogICAgICAgICAgICAgIHdoaWxlIChtYXRjaGVyID0gZWxlbWVudE1hdGNoZXJzW2orK10pIHsKICAgICAgICAgICAgICAgIGlmIChtYXRjaGVyKGVsZW0sIGNvbnRleHQsIHhtbCkpIHsKICAgICAgICAgICAgICAgICAgcmVzdWx0cy5wdXNoKGVsZW0pOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKG91dGVybW9zdCkgewogICAgICAgICAgICAgICAgZGlycnVucyA9IGRpcnJ1bnNVbmlxdWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIFRyYWNrIHVubWF0Y2hlZCBlbGVtZW50cyBmb3Igc2V0IGZpbHRlcnMKICAgICAgICAgICAgaWYgKGJ5U2V0KSB7CiAgICAgICAgICAgICAgLy8gVGhleSB3aWxsIGhhdmUgZ29uZSB0aHJvdWdoIGFsbCBwb3NzaWJsZSBtYXRjaGVycwogICAgICAgICAgICAgIGlmIChlbGVtID0gIW1hdGNoZXIgJiYgZWxlbSkgewogICAgICAgICAgICAgICAgbWF0Y2hlZENvdW50LS07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIC8vIExlbmd0aGVuIHRoZSBhcnJheSBmb3IgZXZlcnkgZWxlbWVudCwgbWF0Y2hlZCBvciBub3QKICAgICAgICAgICAgICBpZiAoc2VlZCkgewogICAgICAgICAgICAgICAgdW5tYXRjaGVkLnB1c2goZWxlbSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICAvLyBBcHBseSBzZXQgZmlsdGVycyB0byB1bm1hdGNoZWQgZWxlbWVudHMKICAgICAgICAgIG1hdGNoZWRDb3VudCArPSBpOwogICAgICAgICAgaWYgKGJ5U2V0ICYmIGkgIT09IG1hdGNoZWRDb3VudCkgewogICAgICAgICAgICBqID0gMDsKICAgICAgICAgICAgd2hpbGUgKG1hdGNoZXIgPSBzZXRNYXRjaGVyc1tqKytdKSB7CiAgICAgICAgICAgICAgbWF0Y2hlcih1bm1hdGNoZWQsIHNldE1hdGNoZWQsIGNvbnRleHQsIHhtbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHNlZWQpIHsKICAgICAgICAgICAgICAvLyBSZWludGVncmF0ZSBlbGVtZW50IG1hdGNoZXMgdG8gZWxpbWluYXRlIHRoZSBuZWVkIGZvciBzb3J0aW5nCiAgICAgICAgICAgICAgaWYgKG1hdGNoZWRDb3VudCA+IDApIHsKICAgICAgICAgICAgICAgIHdoaWxlIChpLS0pIHsKICAgICAgICAgICAgICAgICAgaWYgKCEodW5tYXRjaGVkW2ldIHx8IHNldE1hdGNoZWRbaV0pKSB7CiAgICAgICAgICAgICAgICAgICAgc2V0TWF0Y2hlZFtpXSA9IHBvcC5jYWxsKHJlc3VsdHMpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIC8vIERpc2NhcmQgaW5kZXggcGxhY2Vob2xkZXIgdmFsdWVzIHRvIGdldCBvbmx5IGFjdHVhbCBtYXRjaGVzCiAgICAgICAgICAgICAgc2V0TWF0Y2hlZCA9IGNvbmRlbnNlKHNldE1hdGNoZWQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIEFkZCBtYXRjaGVzIHRvIHJlc3VsdHMKICAgICAgICAgICAgcHVzaC5hcHBseShyZXN1bHRzLCBzZXRNYXRjaGVkKTsKICAgICAgICAgICAgLy8gU2VlZGxlc3Mgc2V0IG1hdGNoZXMgc3VjY2VlZGluZyBtdWx0aXBsZSBzdWNjZXNzZnVsIG1hdGNoZXJzIHN0aXB1bGF0ZSBzb3J0aW5nCiAgICAgICAgICAgIGlmIChvdXRlcm1vc3QgJiYgIXNlZWQgJiYgc2V0TWF0Y2hlZC5sZW5ndGggPiAwICYmIG1hdGNoZWRDb3VudCArIHNldE1hdGNoZXJzLmxlbmd0aCA+IDEpIHsKICAgICAgICAgICAgICBTaXp6bGUudW5pcXVlU29ydChyZXN1bHRzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgLy8gT3ZlcnJpZGUgbWFuaXB1bGF0aW9uIG9mIGdsb2JhbHMgYnkgbmVzdGVkIG1hdGNoZXJzCiAgICAgICAgICBpZiAob3V0ZXJtb3N0KSB7CiAgICAgICAgICAgIGRpcnJ1bnMgPSBkaXJydW5zVW5pcXVlOwogICAgICAgICAgICBvdXRlcm1vc3RDb250ZXh0ID0gY29udGV4dEJhY2t1cDsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB1bm1hdGNoZWQ7CiAgICAgICAgfTsKICAgICAgcmV0dXJuIGJ5U2V0ID8gbWFya0Z1bmN0aW9uKHN1cGVyTWF0Y2hlcikgOiBzdXBlck1hdGNoZXI7CiAgICB9CiAgICBjb21waWxlID0gU2l6emxlLmNvbXBpbGUgPSBmdW5jdGlvbiAoc2VsZWN0b3IsIG1hdGNoKSB7CiAgICAgIHZhciBpLCBzZXRNYXRjaGVycyA9IFtdLCBlbGVtZW50TWF0Y2hlcnMgPSBbXSwgY2FjaGVkID0gY29tcGlsZXJDYWNoZVtzZWxlY3RvciArICcgJ107CiAgICAgIGlmICghY2FjaGVkKSB7CiAgICAgICAgLy8gR2VuZXJhdGUgYSBmdW5jdGlvbiBvZiByZWN1cnNpdmUgZnVuY3Rpb25zIHRoYXQgY2FuIGJlIHVzZWQgdG8gY2hlY2sgZWFjaCBlbGVtZW50CiAgICAgICAgaWYgKCFtYXRjaCkgewogICAgICAgICAgbWF0Y2ggPSB0b2tlbml6ZShzZWxlY3Rvcik7CiAgICAgICAgfQogICAgICAgIGkgPSBtYXRjaC5sZW5ndGg7CiAgICAgICAgd2hpbGUgKGktLSkgewogICAgICAgICAgY2FjaGVkID0gbWF0Y2hlckZyb21Ub2tlbnMobWF0Y2hbaV0pOwogICAgICAgICAgaWYgKGNhY2hlZFtleHBhbmRvXSkgewogICAgICAgICAgICBzZXRNYXRjaGVycy5wdXNoKGNhY2hlZCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBlbGVtZW50TWF0Y2hlcnMucHVzaChjYWNoZWQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAvLyBDYWNoZSB0aGUgY29tcGlsZWQgZnVuY3Rpb24KICAgICAgICBjYWNoZWQgPSBjb21waWxlckNhY2hlKHNlbGVjdG9yLCBtYXRjaGVyRnJvbUdyb3VwTWF0Y2hlcnMoZWxlbWVudE1hdGNoZXJzLCBzZXRNYXRjaGVycykpOwogICAgICAgIC8vIFNhdmUgc2VsZWN0b3IgYW5kIHRva2VuaXphdGlvbgogICAgICAgIGNhY2hlZC5zZWxlY3RvciA9IHNlbGVjdG9yOwogICAgICB9CiAgICAgIHJldHVybiBjYWNoZWQ7CiAgICB9OwogICAgLyoqCiAgICAgKiBBIGxvdy1sZXZlbCBzZWxlY3Rpb24gZnVuY3Rpb24gdGhhdCB3b3JrcyB3aXRoIFNpenpsZSdzIGNvbXBpbGVkCiAgICAgKiAgc2VsZWN0b3IgZnVuY3Rpb25zCiAgICAgKiBAcGFyYW0ge1N0cmluZ3xGdW5jdGlvbn0gc2VsZWN0b3IgQSBzZWxlY3RvciBvciBhIHByZS1jb21waWxlZAogICAgICogIHNlbGVjdG9yIGZ1bmN0aW9uIGJ1aWx0IHdpdGggU2l6emxlLmNvbXBpbGUKICAgICAqIEBwYXJhbSB7RWxlbWVudH0gY29udGV4dAogICAgICogQHBhcmFtIHtBcnJheX0gW3Jlc3VsdHNdCiAgICAgKiBAcGFyYW0ge0FycmF5fSBbc2VlZF0gQSBzZXQgb2YgZWxlbWVudHMgdG8gbWF0Y2ggYWdhaW5zdAogICAgICovCiAgICBzZWxlY3QgPSBTaXp6bGUuc2VsZWN0ID0gZnVuY3Rpb24gKHNlbGVjdG9yLCBjb250ZXh0LCByZXN1bHRzLCBzZWVkKSB7CiAgICAgIHZhciBpLCB0b2tlbnMsIHRva2VuLCB0eXBlLCBmaW5kLCBjb21waWxlZCA9IHR5cGVvZiBzZWxlY3RvciA9PT0gJ2Z1bmN0aW9uJyAmJiBzZWxlY3RvciwgbWF0Y2ggPSAhc2VlZCAmJiB0b2tlbml6ZShzZWxlY3RvciA9IGNvbXBpbGVkLnNlbGVjdG9yIHx8IHNlbGVjdG9yKTsKICAgICAgcmVzdWx0cyA9IHJlc3VsdHMgfHwgW107CiAgICAgIC8vIFRyeSB0byBtaW5pbWl6ZSBvcGVyYXRpb25zIGlmIHRoZXJlIGlzIG5vIHNlZWQgYW5kIG9ubHkgb25lIGdyb3VwCiAgICAgIGlmIChtYXRjaC5sZW5ndGggPT09IDEpIHsKICAgICAgICAvLyBUYWtlIGEgc2hvcnRjdXQgYW5kIHNldCB0aGUgY29udGV4dCBpZiB0aGUgcm9vdCBzZWxlY3RvciBpcyBhbiBJRAogICAgICAgIHRva2VucyA9IG1hdGNoWzBdID0gbWF0Y2hbMF0uc2xpY2UoMCk7CiAgICAgICAgaWYgKHRva2Vucy5sZW5ndGggPiAyICYmICh0b2tlbiA9IHRva2Vuc1swXSkudHlwZSA9PT0gJ0lEJyAmJiBzdXBwb3J0LmdldEJ5SWQgJiYgY29udGV4dC5ub2RlVHlwZSA9PT0gOSAmJiBkb2N1bWVudElzSFRNTCAmJiBFeHByLnJlbGF0aXZlW3Rva2Vuc1sxXS50eXBlXSkgewogICAgICAgICAgY29udGV4dCA9IChFeHByLmZpbmRbJ0lEJ10odG9rZW4ubWF0Y2hlc1swXS5yZXBsYWNlKHJ1bmVzY2FwZSwgZnVuZXNjYXBlKSwgY29udGV4dCkgfHwgW10pWzBdOwogICAgICAgICAgaWYgKCFjb250ZXh0KSB7CiAgICAgICAgICAgIHJldHVybiByZXN1bHRzOyAgLy8gUHJlY29tcGlsZWQgbWF0Y2hlcnMgd2lsbCBzdGlsbCB2ZXJpZnkgYW5jZXN0cnksIHNvIHN0ZXAgdXAgYSBsZXZlbAogICAgICAgICAgfSBlbHNlIGlmIChjb21waWxlZCkgewogICAgICAgICAgICBjb250ZXh0ID0gY29udGV4dC5wYXJlbnROb2RlOwogICAgICAgICAgfQogICAgICAgICAgc2VsZWN0b3IgPSBzZWxlY3Rvci5zbGljZSh0b2tlbnMuc2hpZnQoKS52YWx1ZS5sZW5ndGgpOwogICAgICAgIH0KICAgICAgICAvLyBGZXRjaCBhIHNlZWQgc2V0IGZvciByaWdodC10by1sZWZ0IG1hdGNoaW5nCiAgICAgICAgaSA9IG1hdGNoRXhwclsnbmVlZHNDb250ZXh0J10udGVzdChzZWxlY3RvcikgPyAwIDogdG9rZW5zLmxlbmd0aDsKICAgICAgICB3aGlsZSAoaS0tKSB7CiAgICAgICAgICB0b2tlbiA9IHRva2Vuc1tpXTsKICAgICAgICAgIC8vIEFib3J0IGlmIHdlIGhpdCBhIGNvbWJpbmF0b3IKICAgICAgICAgIGlmIChFeHByLnJlbGF0aXZlW3R5cGUgPSB0b2tlbi50eXBlXSkgewogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChmaW5kID0gRXhwci5maW5kW3R5cGVdKSB7CiAgICAgICAgICAgIC8vIFNlYXJjaCwgZXhwYW5kaW5nIGNvbnRleHQgZm9yIGxlYWRpbmcgc2libGluZyBjb21iaW5hdG9ycwogICAgICAgICAgICBpZiAoc2VlZCA9IGZpbmQodG9rZW4ubWF0Y2hlc1swXS5yZXBsYWNlKHJ1bmVzY2FwZSwgZnVuZXNjYXBlKSwgcnNpYmxpbmcudGVzdCh0b2tlbnNbMF0udHlwZSkgJiYgdGVzdENvbnRleHQoY29udGV4dC5wYXJlbnROb2RlKSB8fCBjb250ZXh0KSkgewogICAgICAgICAgICAgIC8vIElmIHNlZWQgaXMgZW1wdHkgb3Igbm8gdG9rZW5zIHJlbWFpbiwgd2UgY2FuIHJldHVybiBlYXJseQogICAgICAgICAgICAgIHRva2Vucy5zcGxpY2UoaSwgMSk7CiAgICAgICAgICAgICAgc2VsZWN0b3IgPSBzZWVkLmxlbmd0aCAmJiB0b1NlbGVjdG9yKHRva2Vucyk7CiAgICAgICAgICAgICAgaWYgKCFzZWxlY3RvcikgewogICAgICAgICAgICAgICAgcHVzaC5hcHBseShyZXN1bHRzLCBzZWVkKTsKICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHRzOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICAvLyBDb21waWxlIGFuZCBleGVjdXRlIGEgZmlsdGVyaW5nIGZ1bmN0aW9uIGlmIG9uZSBpcyBub3QgcHJvdmlkZWQKICAgICAgLy8gUHJvdmlkZSBgbWF0Y2hgIHRvIGF2b2lkIHJldG9rZW5pemF0aW9uIGlmIHdlIG1vZGlmaWVkIHRoZSBzZWxlY3RvciBhYm92ZQogICAgICAoY29tcGlsZWQgfHwgY29tcGlsZShzZWxlY3RvciwgbWF0Y2gpKShzZWVkLCBjb250ZXh0LCAhZG9jdW1lbnRJc0hUTUwsIHJlc3VsdHMsIHJzaWJsaW5nLnRlc3Qoc2VsZWN0b3IpICYmIHRlc3RDb250ZXh0KGNvbnRleHQucGFyZW50Tm9kZSkgfHwgY29udGV4dCk7CiAgICAgIHJldHVybiByZXN1bHRzOwogICAgfTsKICAgIC8vIE9uZS10aW1lIGFzc2lnbm1lbnRzCiAgICAvLyBTb3J0IHN0YWJpbGl0eQogICAgc3VwcG9ydC5zb3J0U3RhYmxlID0gZXhwYW5kby5zcGxpdCgnJykuc29ydChzb3J0T3JkZXIpLmpvaW4oJycpID09PSBleHBhbmRvOwogICAgLy8gU3VwcG9ydDogQ2hyb21lPDE0CiAgICAvLyBBbHdheXMgYXNzdW1lIGR1cGxpY2F0ZXMgaWYgdGhleSBhcmVuJ3QgcGFzc2VkIHRvIHRoZSBjb21wYXJpc29uIGZ1bmN0aW9uCiAgICBzdXBwb3J0LmRldGVjdER1cGxpY2F0ZXMgPSAhIWhhc0R1cGxpY2F0ZTsKICAgIC8vIEluaXRpYWxpemUgYWdhaW5zdCB0aGUgZGVmYXVsdCBkb2N1bWVudAogICAgc2V0RG9jdW1lbnQoKTsKICAgIC8vIFN1cHBvcnQ6IFdlYmtpdDw1MzcuMzIgLSBTYWZhcmkgNi4wLjMvQ2hyb21lIDI1IChmaXhlZCBpbiBDaHJvbWUgMjcpCiAgICAvLyBEZXRhY2hlZCBub2RlcyBjb25mb3VuZGluZ2x5IGZvbGxvdyAqZWFjaCBvdGhlcioKICAgIHN1cHBvcnQuc29ydERldGFjaGVkID0gYXNzZXJ0KGZ1bmN0aW9uIChkaXYxKSB7CiAgICAgIC8vIFNob3VsZCByZXR1cm4gMSwgYnV0IHJldHVybnMgNCAoZm9sbG93aW5nKQogICAgICByZXR1cm4gZGl2MS5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbihkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKSkgJiAxOwogICAgfSk7CiAgICAvLyBTdXBwb3J0OiBJRTw4CiAgICAvLyBQcmV2ZW50IGF0dHJpYnV0ZS9wcm9wZXJ0eSAiaW50ZXJwb2xhdGlvbiIKICAgIC8vIGh0dHA6Ly9tc2RuLm1pY3Jvc29mdC5jb20vZW4tdXMvbGlicmFyeS9tczUzNjQyOSUyOFZTLjg1JTI5LmFzcHgKICAgIGlmICghYXNzZXJ0KGZ1bmN0aW9uIChkaXYpIHsKICAgICAgICBkaXYuaW5uZXJIVE1MID0gJzxhIGhyZWY9XCcjXCc+PC9hPic7CiAgICAgICAgcmV0dXJuIGRpdi5maXJzdENoaWxkLmdldEF0dHJpYnV0ZSgnaHJlZicpID09PSAnIyc7CiAgICAgIH0pKSB7CiAgICAgIGFkZEhhbmRsZSgndHlwZXxocmVmfGhlaWdodHx3aWR0aCcsIGZ1bmN0aW9uIChlbGVtLCBuYW1lLCBpc1hNTCkgewogICAgICAgIGlmICghaXNYTUwpIHsKICAgICAgICAgIHJldHVybiBlbGVtLmdldEF0dHJpYnV0ZShuYW1lLCBuYW1lLnRvTG93ZXJDYXNlKCkgPT09ICd0eXBlJyA/IDEgOiAyKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQogICAgLy8gU3VwcG9ydDogSUU8OQogICAgLy8gVXNlIGRlZmF1bHRWYWx1ZSBpbiBwbGFjZSBvZiBnZXRBdHRyaWJ1dGUoInZhbHVlIikKICAgIGlmICghc3VwcG9ydC5hdHRyaWJ1dGVzIHx8ICFhc3NlcnQoZnVuY3Rpb24gKGRpdikgewogICAgICAgIGRpdi5pbm5lckhUTUwgPSAnPGlucHV0Lz4nOwogICAgICAgIGRpdi5maXJzdENoaWxkLnNldEF0dHJpYnV0ZSgndmFsdWUnLCAnJyk7CiAgICAgICAgcmV0dXJuIGRpdi5maXJzdENoaWxkLmdldEF0dHJpYnV0ZSgndmFsdWUnKSA9PT0gJyc7CiAgICAgIH0pKSB7CiAgICAgIGFkZEhhbmRsZSgndmFsdWUnLCBmdW5jdGlvbiAoZWxlbSwgbmFtZSwgaXNYTUwpIHsKICAgICAgICBpZiAoIWlzWE1MICYmIGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gJ2lucHV0JykgewogICAgICAgICAgcmV0dXJuIGVsZW0uZGVmYXVsdFZhbHVlOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgICAvLyBTdXBwb3J0OiBJRTw5CiAgICAvLyBVc2UgZ2V0QXR0cmlidXRlTm9kZSB0byBmZXRjaCBib29sZWFucyB3aGVuIGdldEF0dHJpYnV0ZSBsaWVzCiAgICBpZiAoIWFzc2VydChmdW5jdGlvbiAoZGl2KSB7CiAgICAgICAgcmV0dXJuIGRpdi5nZXRBdHRyaWJ1dGUoJ2Rpc2FibGVkJykgPT0gbnVsbDsKICAgICAgfSkpIHsKICAgICAgYWRkSGFuZGxlKGJvb2xlYW5zLCBmdW5jdGlvbiAoZWxlbSwgbmFtZSwgaXNYTUwpIHsKICAgICAgICB2YXIgdmFsOwogICAgICAgIGlmICghaXNYTUwpIHsKICAgICAgICAgIHJldHVybiBlbGVtW25hbWVdID09PSB0cnVlID8gbmFtZS50b0xvd2VyQ2FzZSgpIDogKHZhbCA9IGVsZW0uZ2V0QXR0cmlidXRlTm9kZShuYW1lKSkgJiYgdmFsLnNwZWNpZmllZCA/IHZhbC52YWx1ZSA6IG51bGw7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICAgIHJldHVybiBTaXp6bGU7CiAgfSh3aW5kb3cpOwogIGpRdWVyeS5maW5kID0gU2l6emxlOwogIGpRdWVyeS5leHByID0gU2l6emxlLnNlbGVjdG9yczsKICBqUXVlcnkuZXhwclsnOiddID0galF1ZXJ5LmV4cHIucHNldWRvczsKICBqUXVlcnkudW5pcXVlID0gU2l6emxlLnVuaXF1ZVNvcnQ7CiAgalF1ZXJ5LnRleHQgPSBTaXp6bGUuZ2V0VGV4dDsKICBqUXVlcnkuaXNYTUxEb2MgPSBTaXp6bGUuaXNYTUw7CiAgalF1ZXJ5LmNvbnRhaW5zID0gU2l6emxlLmNvbnRhaW5zOwogIHZhciBybmVlZHNDb250ZXh0ID0galF1ZXJ5LmV4cHIubWF0Y2gubmVlZHNDb250ZXh0OwogIHZhciByc2luZ2xlVGFnID0gL148KFx3KylccypcLz8+KD86PFwvXDE+fCkkLzsKICB2YXIgcmlzU2ltcGxlID0gL14uW146I1xbXC4sXSokLzsKICAvLyBJbXBsZW1lbnQgdGhlIGlkZW50aWNhbCBmdW5jdGlvbmFsaXR5IGZvciBmaWx0ZXIgYW5kIG5vdAogIGZ1bmN0aW9uIHdpbm5vdyhlbGVtZW50cywgcXVhbGlmaWVyLCBub3QpIHsKICAgIGlmIChqUXVlcnkuaXNGdW5jdGlvbihxdWFsaWZpZXIpKSB7CiAgICAgIHJldHVybiBqUXVlcnkuZ3JlcChlbGVtZW50cywgZnVuY3Rpb24gKGVsZW0sIGkpIHsKICAgICAgICAvKiBqc2hpbnQgLVcwMTggKi8KICAgICAgICByZXR1cm4gISFxdWFsaWZpZXIuY2FsbChlbGVtLCBpLCBlbGVtKSAhPT0gbm90OwogICAgICB9KTsKICAgIH0KICAgIGlmIChxdWFsaWZpZXIubm9kZVR5cGUpIHsKICAgICAgcmV0dXJuIGpRdWVyeS5ncmVwKGVsZW1lbnRzLCBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgIHJldHVybiBlbGVtID09PSBxdWFsaWZpZXIgIT09IG5vdDsKICAgICAgfSk7CiAgICB9CiAgICBpZiAodHlwZW9mIHF1YWxpZmllciA9PT0gJ3N0cmluZycpIHsKICAgICAgaWYgKHJpc1NpbXBsZS50ZXN0KHF1YWxpZmllcikpIHsKICAgICAgICByZXR1cm4galF1ZXJ5LmZpbHRlcihxdWFsaWZpZXIsIGVsZW1lbnRzLCBub3QpOwogICAgICB9CiAgICAgIHF1YWxpZmllciA9IGpRdWVyeS5maWx0ZXIocXVhbGlmaWVyLCBlbGVtZW50cyk7CiAgICB9CiAgICByZXR1cm4galF1ZXJ5LmdyZXAoZWxlbWVudHMsIGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgIHJldHVybiBpbmRleE9mLmNhbGwocXVhbGlmaWVyLCBlbGVtKSA+PSAwICE9PSBub3Q7CiAgICB9KTsKICB9CiAgalF1ZXJ5LmZpbHRlciA9IGZ1bmN0aW9uIChleHByLCBlbGVtcywgbm90KSB7CiAgICB2YXIgZWxlbSA9IGVsZW1zWzBdOwogICAgaWYgKG5vdCkgewogICAgICBleHByID0gJzpub3QoJyArIGV4cHIgKyAnKSc7CiAgICB9CiAgICByZXR1cm4gZWxlbXMubGVuZ3RoID09PSAxICYmIGVsZW0ubm9kZVR5cGUgPT09IDEgPyBqUXVlcnkuZmluZC5tYXRjaGVzU2VsZWN0b3IoZWxlbSwgZXhwcikgPyBbZWxlbV0gOiBbXSA6IGpRdWVyeS5maW5kLm1hdGNoZXMoZXhwciwgalF1ZXJ5LmdyZXAoZWxlbXMsIGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgIHJldHVybiBlbGVtLm5vZGVUeXBlID09PSAxOwogICAgfSkpOwogIH07CiAgalF1ZXJ5LmZuLmV4dGVuZCh7CiAgICBmaW5kOiBmdW5jdGlvbiAoc2VsZWN0b3IpIHsKICAgICAgdmFyIGksIGxlbiA9IHRoaXMubGVuZ3RoLCByZXQgPSBbXSwgc2VsZiA9IHRoaXM7CiAgICAgIGlmICh0eXBlb2Ygc2VsZWN0b3IgIT09ICdzdHJpbmcnKSB7CiAgICAgICAgcmV0dXJuIHRoaXMucHVzaFN0YWNrKGpRdWVyeShzZWxlY3RvcikuZmlsdGVyKGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW47IGkrKykgewogICAgICAgICAgICBpZiAoalF1ZXJ5LmNvbnRhaW5zKHNlbGZbaV0sIHRoaXMpKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9KSk7CiAgICAgIH0KICAgICAgZm9yIChpID0gMDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgalF1ZXJ5LmZpbmQoc2VsZWN0b3IsIHNlbGZbaV0sIHJldCk7CiAgICAgIH0KICAgICAgLy8gTmVlZGVkIGJlY2F1c2UgJCggc2VsZWN0b3IsIGNvbnRleHQgKSBiZWNvbWVzICQoIGNvbnRleHQgKS5maW5kKCBzZWxlY3RvciApCiAgICAgIHJldCA9IHRoaXMucHVzaFN0YWNrKGxlbiA+IDEgPyBqUXVlcnkudW5pcXVlKHJldCkgOiByZXQpOwogICAgICByZXQuc2VsZWN0b3IgPSB0aGlzLnNlbGVjdG9yID8gdGhpcy5zZWxlY3RvciArICcgJyArIHNlbGVjdG9yIDogc2VsZWN0b3I7CiAgICAgIHJldHVybiByZXQ7CiAgICB9LAogICAgZmlsdGVyOiBmdW5jdGlvbiAoc2VsZWN0b3IpIHsKICAgICAgcmV0dXJuIHRoaXMucHVzaFN0YWNrKHdpbm5vdyh0aGlzLCBzZWxlY3RvciB8fCBbXSwgZmFsc2UpKTsKICAgIH0sCiAgICBub3Q6IGZ1bmN0aW9uIChzZWxlY3RvcikgewogICAgICByZXR1cm4gdGhpcy5wdXNoU3RhY2sod2lubm93KHRoaXMsIHNlbGVjdG9yIHx8IFtdLCB0cnVlKSk7CiAgICB9LAogICAgaXM6IGZ1bmN0aW9uIChzZWxlY3RvcikgewogICAgICByZXR1cm4gISF3aW5ub3codGhpcywgLy8gSWYgdGhpcyBpcyBhIHBvc2l0aW9uYWwvcmVsYXRpdmUgc2VsZWN0b3IsIGNoZWNrIG1lbWJlcnNoaXAgaW4gdGhlIHJldHVybmVkIHNldAogICAgICAvLyBzbyAkKCJwOmZpcnN0IikuaXMoInA6bGFzdCIpIHdvbid0IHJldHVybiB0cnVlIGZvciBhIGRvYyB3aXRoIHR3byAicCIuCiAgICAgIHR5cGVvZiBzZWxlY3RvciA9PT0gJ3N0cmluZycgJiYgcm5lZWRzQ29udGV4dC50ZXN0KHNlbGVjdG9yKSA/IGpRdWVyeShzZWxlY3RvcikgOiBzZWxlY3RvciB8fCBbXSwgZmFsc2UpLmxlbmd0aDsKICAgIH0KICB9KTsKICAvLyBJbml0aWFsaXplIGEgalF1ZXJ5IG9iamVjdAogIC8vIEEgY2VudHJhbCByZWZlcmVuY2UgdG8gdGhlIHJvb3QgalF1ZXJ5KGRvY3VtZW50KQogIHZhciByb290alF1ZXJ5LAogICAgLy8gQSBzaW1wbGUgd2F5IHRvIGNoZWNrIGZvciBIVE1MIHN0cmluZ3MKICAgIC8vIFByaW9yaXRpemUgI2lkIG92ZXIgPHRhZz4gdG8gYXZvaWQgWFNTIHZpYSBsb2NhdGlvbi5oYXNoICgjOTUyMSkKICAgIC8vIFN0cmljdCBIVE1MIHJlY29nbml0aW9uICgjMTEyOTA6IG11c3Qgc3RhcnQgd2l0aCA8KQogICAgcnF1aWNrRXhwciA9IC9eKD86XHMqKDxbXHdcV10rPilbXj5dKnwjKFtcdy1dKikpJC8sIGluaXQgPSBqUXVlcnkuZm4uaW5pdCA9IGZ1bmN0aW9uIChzZWxlY3RvciwgY29udGV4dCkgewogICAgICB2YXIgbWF0Y2gsIGVsZW07CiAgICAgIC8vIEhBTkRMRTogJCgiIiksICQobnVsbCksICQodW5kZWZpbmVkKSwgJChmYWxzZSkKICAgICAgaWYgKCFzZWxlY3RvcikgewogICAgICAgIHJldHVybiB0aGlzOwogICAgICB9CiAgICAgIC8vIEhhbmRsZSBIVE1MIHN0cmluZ3MKICAgICAgaWYgKHR5cGVvZiBzZWxlY3RvciA9PT0gJ3N0cmluZycpIHsKICAgICAgICBpZiAoc2VsZWN0b3JbMF0gPT09ICc8JyAmJiBzZWxlY3RvcltzZWxlY3Rvci5sZW5ndGggLSAxXSA9PT0gJz4nICYmIHNlbGVjdG9yLmxlbmd0aCA+PSAzKSB7CiAgICAgICAgICAvLyBBc3N1bWUgdGhhdCBzdHJpbmdzIHRoYXQgc3RhcnQgYW5kIGVuZCB3aXRoIDw+IGFyZSBIVE1MIGFuZCBza2lwIHRoZSByZWdleCBjaGVjawogICAgICAgICAgbWF0Y2ggPSBbCiAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgIHNlbGVjdG9yLAogICAgICAgICAgICBudWxsCiAgICAgICAgICBdOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBtYXRjaCA9IHJxdWlja0V4cHIuZXhlYyhzZWxlY3Rvcik7CiAgICAgICAgfQogICAgICAgIC8vIE1hdGNoIGh0bWwgb3IgbWFrZSBzdXJlIG5vIGNvbnRleHQgaXMgc3BlY2lmaWVkIGZvciAjaWQKICAgICAgICBpZiAobWF0Y2ggJiYgKG1hdGNoWzFdIHx8ICFjb250ZXh0KSkgewogICAgICAgICAgLy8gSEFORExFOiAkKGh0bWwpIC0+ICQoYXJyYXkpCiAgICAgICAgICBpZiAobWF0Y2hbMV0pIHsKICAgICAgICAgICAgY29udGV4dCA9IGNvbnRleHQgaW5zdGFuY2VvZiBqUXVlcnkgPyBjb250ZXh0WzBdIDogY29udGV4dDsKICAgICAgICAgICAgLy8gc2NyaXB0cyBpcyB0cnVlIGZvciBiYWNrLWNvbXBhdAogICAgICAgICAgICAvLyBJbnRlbnRpb25hbGx5IGxldCB0aGUgZXJyb3IgYmUgdGhyb3duIGlmIHBhcnNlSFRNTCBpcyBub3QgcHJlc2VudAogICAgICAgICAgICBqUXVlcnkubWVyZ2UodGhpcywgalF1ZXJ5LnBhcnNlSFRNTChtYXRjaFsxXSwgY29udGV4dCAmJiBjb250ZXh0Lm5vZGVUeXBlID8gY29udGV4dC5vd25lckRvY3VtZW50IHx8IGNvbnRleHQgOiBkb2N1bWVudCwgdHJ1ZSkpOwogICAgICAgICAgICAvLyBIQU5ETEU6ICQoaHRtbCwgcHJvcHMpCiAgICAgICAgICAgIGlmIChyc2luZ2xlVGFnLnRlc3QobWF0Y2hbMV0pICYmIGpRdWVyeS5pc1BsYWluT2JqZWN0KGNvbnRleHQpKSB7CiAgICAgICAgICAgICAgZm9yIChtYXRjaCBpbiBjb250ZXh0KSB7CiAgICAgICAgICAgICAgICAvLyBQcm9wZXJ0aWVzIG9mIGNvbnRleHQgYXJlIGNhbGxlZCBhcyBtZXRob2RzIGlmIHBvc3NpYmxlCiAgICAgICAgICAgICAgICBpZiAoalF1ZXJ5LmlzRnVuY3Rpb24odGhpc1ttYXRjaF0pKSB7CiAgICAgICAgICAgICAgICAgIHRoaXNbbWF0Y2hdKGNvbnRleHRbbWF0Y2hdKTsgIC8vIC4uLmFuZCBvdGhlcndpc2Ugc2V0IGFzIGF0dHJpYnV0ZXMKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHRoaXMuYXR0cihtYXRjaCwgY29udGV4dFttYXRjaF0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGhpczsgIC8vIEhBTkRMRTogJCgjaWQpCiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBlbGVtID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQobWF0Y2hbMl0pOwogICAgICAgICAgICAvLyBDaGVjayBwYXJlbnROb2RlIHRvIGNhdGNoIHdoZW4gQmxhY2tiZXJyeSA0LjYgcmV0dXJucwogICAgICAgICAgICAvLyBub2RlcyB0aGF0IGFyZSBubyBsb25nZXIgaW4gdGhlIGRvY3VtZW50ICM2OTYzCiAgICAgICAgICAgIGlmIChlbGVtICYmIGVsZW0ucGFyZW50Tm9kZSkgewogICAgICAgICAgICAgIC8vIEluamVjdCB0aGUgZWxlbWVudCBkaXJlY3RseSBpbnRvIHRoZSBqUXVlcnkgb2JqZWN0CiAgICAgICAgICAgICAgdGhpcy5sZW5ndGggPSAxOwogICAgICAgICAgICAgIHRoaXNbMF0gPSBlbGVtOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuY29udGV4dCA9IGRvY3VtZW50OwogICAgICAgICAgICB0aGlzLnNlbGVjdG9yID0gc2VsZWN0b3I7CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgfSAgLy8gSEFORExFOiAkKGV4cHIsICQoLi4uKSkKICAgICAgICB9IGVsc2UgaWYgKCFjb250ZXh0IHx8IGNvbnRleHQuanF1ZXJ5KSB7CiAgICAgICAgICByZXR1cm4gKGNvbnRleHQgfHwgcm9vdGpRdWVyeSkuZmluZChzZWxlY3Rvcik7ICAvLyBIQU5ETEU6ICQoZXhwciwgY29udGV4dCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vICh3aGljaCBpcyBqdXN0IGVxdWl2YWxlbnQgdG86ICQoY29udGV4dCkuZmluZChleHByKQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXR1cm4gdGhpcy5jb25zdHJ1Y3Rvcihjb250ZXh0KS5maW5kKHNlbGVjdG9yKTsKICAgICAgICB9ICAvLyBIQU5ETEU6ICQoRE9NRWxlbWVudCkKICAgICAgfSBlbHNlIGlmIChzZWxlY3Rvci5ub2RlVHlwZSkgewogICAgICAgIHRoaXMuY29udGV4dCA9IHRoaXNbMF0gPSBzZWxlY3RvcjsKICAgICAgICB0aGlzLmxlbmd0aCA9IDE7CiAgICAgICAgcmV0dXJuIHRoaXM7ICAvLyBIQU5ETEU6ICQoZnVuY3Rpb24pCiAgICAgICAgICAgICAgICAgICAgICAvLyBTaG9ydGN1dCBmb3IgZG9jdW1lbnQgcmVhZHkKICAgICAgfSBlbHNlIGlmIChqUXVlcnkuaXNGdW5jdGlvbihzZWxlY3RvcikpIHsKICAgICAgICByZXR1cm4gdHlwZW9mIHJvb3RqUXVlcnkucmVhZHkgIT09ICd1bmRlZmluZWQnID8gcm9vdGpRdWVyeS5yZWFkeShzZWxlY3RvcikgOiAvLyBFeGVjdXRlIGltbWVkaWF0ZWx5IGlmIHJlYWR5IGlzIG5vdCBwcmVzZW50CiAgICAgICAgc2VsZWN0b3IoalF1ZXJ5KTsKICAgICAgfQogICAgICBpZiAoc2VsZWN0b3Iuc2VsZWN0b3IgIT09IHVuZGVmaW5lZCkgewogICAgICAgIHRoaXMuc2VsZWN0b3IgPSBzZWxlY3Rvci5zZWxlY3RvcjsKICAgICAgICB0aGlzLmNvbnRleHQgPSBzZWxlY3Rvci5jb250ZXh0OwogICAgICB9CiAgICAgIHJldHVybiBqUXVlcnkubWFrZUFycmF5KHNlbGVjdG9yLCB0aGlzKTsKICAgIH07CiAgLy8gR2l2ZSB0aGUgaW5pdCBmdW5jdGlvbiB0aGUgalF1ZXJ5IHByb3RvdHlwZSBmb3IgbGF0ZXIgaW5zdGFudGlhdGlvbgogIGluaXQucHJvdG90eXBlID0galF1ZXJ5LmZuOwogIC8vIEluaXRpYWxpemUgY2VudHJhbCByZWZlcmVuY2UKICByb290alF1ZXJ5ID0galF1ZXJ5KGRvY3VtZW50KTsKICB2YXIgcnBhcmVudHNwcmV2ID0gL14oPzpwYXJlbnRzfHByZXYoPzpVbnRpbHxBbGwpKS8sCiAgICAvLyBtZXRob2RzIGd1YXJhbnRlZWQgdG8gcHJvZHVjZSBhIHVuaXF1ZSBzZXQgd2hlbiBzdGFydGluZyBmcm9tIGEgdW5pcXVlIHNldAogICAgZ3VhcmFudGVlZFVuaXF1ZSA9IHsKICAgICAgY2hpbGRyZW46IHRydWUsCiAgICAgIGNvbnRlbnRzOiB0cnVlLAogICAgICBuZXh0OiB0cnVlLAogICAgICBwcmV2OiB0cnVlCiAgICB9OwogIGpRdWVyeS5leHRlbmQoewogICAgZGlyOiBmdW5jdGlvbiAoZWxlbSwgZGlyLCB1bnRpbCkgewogICAgICB2YXIgbWF0Y2hlZCA9IFtdLCB0cnVuY2F0ZSA9IHVudGlsICE9PSB1bmRlZmluZWQ7CiAgICAgIHdoaWxlICgoZWxlbSA9IGVsZW1bZGlyXSkgJiYgZWxlbS5ub2RlVHlwZSAhPT0gOSkgewogICAgICAgIGlmIChlbGVtLm5vZGVUeXBlID09PSAxKSB7CiAgICAgICAgICBpZiAodHJ1bmNhdGUgJiYgalF1ZXJ5KGVsZW0pLmlzKHVudGlsKSkgewogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICAgIG1hdGNoZWQucHVzaChlbGVtKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIG1hdGNoZWQ7CiAgICB9LAogICAgc2libGluZzogZnVuY3Rpb24gKG4sIGVsZW0pIHsKICAgICAgdmFyIG1hdGNoZWQgPSBbXTsKICAgICAgZm9yICg7IG47IG4gPSBuLm5leHRTaWJsaW5nKSB7CiAgICAgICAgaWYgKG4ubm9kZVR5cGUgPT09IDEgJiYgbiAhPT0gZWxlbSkgewogICAgICAgICAgbWF0Y2hlZC5wdXNoKG4pOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gbWF0Y2hlZDsKICAgIH0KICB9KTsKICBqUXVlcnkuZm4uZXh0ZW5kKHsKICAgIGhhczogZnVuY3Rpb24gKHRhcmdldCkgewogICAgICB2YXIgdGFyZ2V0cyA9IGpRdWVyeSh0YXJnZXQsIHRoaXMpLCBsID0gdGFyZ2V0cy5sZW5ndGg7CiAgICAgIHJldHVybiB0aGlzLmZpbHRlcihmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIGkgPSAwOwogICAgICAgIGZvciAoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgICBpZiAoalF1ZXJ5LmNvbnRhaW5zKHRoaXMsIHRhcmdldHNbaV0pKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICB9LAogICAgY2xvc2VzdDogZnVuY3Rpb24gKHNlbGVjdG9ycywgY29udGV4dCkgewogICAgICB2YXIgY3VyLCBpID0gMCwgbCA9IHRoaXMubGVuZ3RoLCBtYXRjaGVkID0gW10sIHBvcyA9IHJuZWVkc0NvbnRleHQudGVzdChzZWxlY3RvcnMpIHx8IHR5cGVvZiBzZWxlY3RvcnMgIT09ICdzdHJpbmcnID8galF1ZXJ5KHNlbGVjdG9ycywgY29udGV4dCB8fCB0aGlzLmNvbnRleHQpIDogMDsKICAgICAgZm9yICg7IGkgPCBsOyBpKyspIHsKICAgICAgICBmb3IgKGN1ciA9IHRoaXNbaV07IGN1ciAmJiBjdXIgIT09IGNvbnRleHQ7IGN1ciA9IGN1ci5wYXJlbnROb2RlKSB7CiAgICAgICAgICAvLyBBbHdheXMgc2tpcCBkb2N1bWVudCBmcmFnbWVudHMKICAgICAgICAgIGlmIChjdXIubm9kZVR5cGUgPCAxMSAmJiAocG9zID8gcG9zLmluZGV4KGN1cikgPiAtMSA6IC8vIERvbid0IHBhc3Mgbm9uLWVsZW1lbnRzIHRvIFNpenpsZQogICAgICAgICAgICBjdXIubm9kZVR5cGUgPT09IDEgJiYgalF1ZXJ5LmZpbmQubWF0Y2hlc1NlbGVjdG9yKGN1ciwgc2VsZWN0b3JzKSkpIHsKICAgICAgICAgICAgbWF0Y2hlZC5wdXNoKGN1cik7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gdGhpcy5wdXNoU3RhY2sobWF0Y2hlZC5sZW5ndGggPiAxID8galF1ZXJ5LnVuaXF1ZShtYXRjaGVkKSA6IG1hdGNoZWQpOwogICAgfSwKICAgIC8vIERldGVybWluZSB0aGUgcG9zaXRpb24gb2YgYW4gZWxlbWVudCB3aXRoaW4KICAgIC8vIHRoZSBtYXRjaGVkIHNldCBvZiBlbGVtZW50cwogICAgaW5kZXg6IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgIC8vIE5vIGFyZ3VtZW50LCByZXR1cm4gaW5kZXggaW4gcGFyZW50CiAgICAgIGlmICghZWxlbSkgewogICAgICAgIHJldHVybiB0aGlzWzBdICYmIHRoaXNbMF0ucGFyZW50Tm9kZSA/IHRoaXMuZmlyc3QoKS5wcmV2QWxsKCkubGVuZ3RoIDogLTE7CiAgICAgIH0KICAgICAgLy8gaW5kZXggaW4gc2VsZWN0b3IKICAgICAgaWYgKHR5cGVvZiBlbGVtID09PSAnc3RyaW5nJykgewogICAgICAgIHJldHVybiBpbmRleE9mLmNhbGwoalF1ZXJ5KGVsZW0pLCB0aGlzWzBdKTsKICAgICAgfQogICAgICAvLyBMb2NhdGUgdGhlIHBvc2l0aW9uIG9mIHRoZSBkZXNpcmVkIGVsZW1lbnQKICAgICAgcmV0dXJuIGluZGV4T2YuY2FsbCh0aGlzLCAvLyBJZiBpdCByZWNlaXZlcyBhIGpRdWVyeSBvYmplY3QsIHRoZSBmaXJzdCBlbGVtZW50IGlzIHVzZWQKICAgICAgZWxlbS5qcXVlcnkgPyBlbGVtWzBdIDogZWxlbSk7CiAgICB9LAogICAgYWRkOiBmdW5jdGlvbiAoc2VsZWN0b3IsIGNvbnRleHQpIHsKICAgICAgcmV0dXJuIHRoaXMucHVzaFN0YWNrKGpRdWVyeS51bmlxdWUoalF1ZXJ5Lm1lcmdlKHRoaXMuZ2V0KCksIGpRdWVyeShzZWxlY3RvciwgY29udGV4dCkpKSk7CiAgICB9LAogICAgYWRkQmFjazogZnVuY3Rpb24gKHNlbGVjdG9yKSB7CiAgICAgIHJldHVybiB0aGlzLmFkZChzZWxlY3RvciA9PSBudWxsID8gdGhpcy5wcmV2T2JqZWN0IDogdGhpcy5wcmV2T2JqZWN0LmZpbHRlcihzZWxlY3RvcikpOwogICAgfQogIH0pOwogIGZ1bmN0aW9uIHNpYmxpbmcoY3VyLCBkaXIpIHsKICAgIHdoaWxlICgoY3VyID0gY3VyW2Rpcl0pICYmIGN1ci5ub2RlVHlwZSAhPT0gMSkgewogICAgfQogICAgcmV0dXJuIGN1cjsKICB9CiAgalF1ZXJ5LmVhY2goewogICAgcGFyZW50OiBmdW5jdGlvbiAoZWxlbSkgewogICAgICB2YXIgcGFyZW50ID0gZWxlbS5wYXJlbnROb2RlOwogICAgICByZXR1cm4gcGFyZW50ICYmIHBhcmVudC5ub2RlVHlwZSAhPT0gMTEgPyBwYXJlbnQgOiBudWxsOwogICAgfSwKICAgIHBhcmVudHM6IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgIHJldHVybiBqUXVlcnkuZGlyKGVsZW0sICdwYXJlbnROb2RlJyk7CiAgICB9LAogICAgcGFyZW50c1VudGlsOiBmdW5jdGlvbiAoZWxlbSwgaSwgdW50aWwpIHsKICAgICAgcmV0dXJuIGpRdWVyeS5kaXIoZWxlbSwgJ3BhcmVudE5vZGUnLCB1bnRpbCk7CiAgICB9LAogICAgbmV4dDogZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgcmV0dXJuIHNpYmxpbmcoZWxlbSwgJ25leHRTaWJsaW5nJyk7CiAgICB9LAogICAgcHJldjogZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgcmV0dXJuIHNpYmxpbmcoZWxlbSwgJ3ByZXZpb3VzU2libGluZycpOwogICAgfSwKICAgIG5leHRBbGw6IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgIHJldHVybiBqUXVlcnkuZGlyKGVsZW0sICduZXh0U2libGluZycpOwogICAgfSwKICAgIHByZXZBbGw6IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgIHJldHVybiBqUXVlcnkuZGlyKGVsZW0sICdwcmV2aW91c1NpYmxpbmcnKTsKICAgIH0sCiAgICBuZXh0VW50aWw6IGZ1bmN0aW9uIChlbGVtLCBpLCB1bnRpbCkgewogICAgICByZXR1cm4galF1ZXJ5LmRpcihlbGVtLCAnbmV4dFNpYmxpbmcnLCB1bnRpbCk7CiAgICB9LAogICAgcHJldlVudGlsOiBmdW5jdGlvbiAoZWxlbSwgaSwgdW50aWwpIHsKICAgICAgcmV0dXJuIGpRdWVyeS5kaXIoZWxlbSwgJ3ByZXZpb3VzU2libGluZycsIHVudGlsKTsKICAgIH0sCiAgICBzaWJsaW5nczogZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgcmV0dXJuIGpRdWVyeS5zaWJsaW5nKChlbGVtLnBhcmVudE5vZGUgfHwge30pLmZpcnN0Q2hpbGQsIGVsZW0pOwogICAgfSwKICAgIGNoaWxkcmVuOiBmdW5jdGlvbiAoZWxlbSkgewogICAgICByZXR1cm4galF1ZXJ5LnNpYmxpbmcoZWxlbS5maXJzdENoaWxkKTsKICAgIH0sCiAgICBjb250ZW50czogZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgcmV0dXJuIGVsZW0uY29udGVudERvY3VtZW50IHx8IGpRdWVyeS5tZXJnZShbXSwgZWxlbS5jaGlsZE5vZGVzKTsKICAgIH0KICB9LCBmdW5jdGlvbiAobmFtZSwgZm4pIHsKICAgIGpRdWVyeS5mbltuYW1lXSA9IGZ1bmN0aW9uICh1bnRpbCwgc2VsZWN0b3IpIHsKICAgICAgdmFyIG1hdGNoZWQgPSBqUXVlcnkubWFwKHRoaXMsIGZuLCB1bnRpbCk7CiAgICAgIGlmIChuYW1lLnNsaWNlKC01KSAhPT0gJ1VudGlsJykgewogICAgICAgIHNlbGVjdG9yID0gdW50aWw7CiAgICAgIH0KICAgICAgaWYgKHNlbGVjdG9yICYmIHR5cGVvZiBzZWxlY3RvciA9PT0gJ3N0cmluZycpIHsKICAgICAgICBtYXRjaGVkID0galF1ZXJ5LmZpbHRlcihzZWxlY3RvciwgbWF0Y2hlZCk7CiAgICAgIH0KICAgICAgaWYgKHRoaXMubGVuZ3RoID4gMSkgewogICAgICAgIC8vIFJlbW92ZSBkdXBsaWNhdGVzCiAgICAgICAgaWYgKCFndWFyYW50ZWVkVW5pcXVlW25hbWVdKSB7CiAgICAgICAgICBqUXVlcnkudW5pcXVlKG1hdGNoZWQpOwogICAgICAgIH0KICAgICAgICAvLyBSZXZlcnNlIG9yZGVyIGZvciBwYXJlbnRzKiBhbmQgcHJldi1kZXJpdmF0aXZlcwogICAgICAgIGlmIChycGFyZW50c3ByZXYudGVzdChuYW1lKSkgewogICAgICAgICAgbWF0Y2hlZC5yZXZlcnNlKCk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiB0aGlzLnB1c2hTdGFjayhtYXRjaGVkKTsKICAgIH07CiAgfSk7CiAgdmFyIHJub3R3aGl0ZSA9IC9cUysvZzsKICAvLyBTdHJpbmcgdG8gT2JqZWN0IG9wdGlvbnMgZm9ybWF0IGNhY2hlCiAgdmFyIG9wdGlvbnNDYWNoZSA9IHt9OwogIC8vIENvbnZlcnQgU3RyaW5nLWZvcm1hdHRlZCBvcHRpb25zIGludG8gT2JqZWN0LWZvcm1hdHRlZCBvbmVzIGFuZCBzdG9yZSBpbiBjYWNoZQogIGZ1bmN0aW9uIGNyZWF0ZU9wdGlvbnMob3B0aW9ucykgewogICAgdmFyIG9iamVjdCA9IG9wdGlvbnNDYWNoZVtvcHRpb25zXSA9IHt9OwogICAgalF1ZXJ5LmVhY2gob3B0aW9ucy5tYXRjaChybm90d2hpdGUpIHx8IFtdLCBmdW5jdGlvbiAoXywgZmxhZykgewogICAgICBvYmplY3RbZmxhZ10gPSB0cnVlOwogICAgfSk7CiAgICByZXR1cm4gb2JqZWN0OwogIH0KICAvKgogICAqIENyZWF0ZSBhIGNhbGxiYWNrIGxpc3QgdXNpbmcgdGhlIGZvbGxvd2luZyBwYXJhbWV0ZXJzOgogICAqCiAgICoJb3B0aW9uczogYW4gb3B0aW9uYWwgbGlzdCBvZiBzcGFjZS1zZXBhcmF0ZWQgb3B0aW9ucyB0aGF0IHdpbGwgY2hhbmdlIGhvdwogICAqCQkJdGhlIGNhbGxiYWNrIGxpc3QgYmVoYXZlcyBvciBhIG1vcmUgdHJhZGl0aW9uYWwgb3B0aW9uIG9iamVjdAogICAqCiAgICogQnkgZGVmYXVsdCBhIGNhbGxiYWNrIGxpc3Qgd2lsbCBhY3QgbGlrZSBhbiBldmVudCBjYWxsYmFjayBsaXN0IGFuZCBjYW4gYmUKICAgKiAiZmlyZWQiIG11bHRpcGxlIHRpbWVzLgogICAqCiAgICogUG9zc2libGUgb3B0aW9uczoKICAgKgogICAqCW9uY2U6CQkJd2lsbCBlbnN1cmUgdGhlIGNhbGxiYWNrIGxpc3QgY2FuIG9ubHkgYmUgZmlyZWQgb25jZSAobGlrZSBhIERlZmVycmVkKQogICAqCiAgICoJbWVtb3J5OgkJCXdpbGwga2VlcCB0cmFjayBvZiBwcmV2aW91cyB2YWx1ZXMgYW5kIHdpbGwgY2FsbCBhbnkgY2FsbGJhY2sgYWRkZWQKICAgKgkJCQkJYWZ0ZXIgdGhlIGxpc3QgaGFzIGJlZW4gZmlyZWQgcmlnaHQgYXdheSB3aXRoIHRoZSBsYXRlc3QgIm1lbW9yaXplZCIKICAgKgkJCQkJdmFsdWVzIChsaWtlIGEgRGVmZXJyZWQpCiAgICoKICAgKgl1bmlxdWU6CQkJd2lsbCBlbnN1cmUgYSBjYWxsYmFjayBjYW4gb25seSBiZSBhZGRlZCBvbmNlIChubyBkdXBsaWNhdGUgaW4gdGhlIGxpc3QpCiAgICoKICAgKglzdG9wT25GYWxzZToJaW50ZXJydXB0IGNhbGxpbmdzIHdoZW4gYSBjYWxsYmFjayByZXR1cm5zIGZhbHNlCiAgICoKICAgKi8KICBqUXVlcnkuQ2FsbGJhY2tzID0gZnVuY3Rpb24gKG9wdGlvbnMpIHsKICAgIC8vIENvbnZlcnQgb3B0aW9ucyBmcm9tIFN0cmluZy1mb3JtYXR0ZWQgdG8gT2JqZWN0LWZvcm1hdHRlZCBpZiBuZWVkZWQKICAgIC8vICh3ZSBjaGVjayBpbiBjYWNoZSBmaXJzdCkKICAgIG9wdGlvbnMgPSB0eXBlb2Ygb3B0aW9ucyA9PT0gJ3N0cmluZycgPyBvcHRpb25zQ2FjaGVbb3B0aW9uc10gfHwgY3JlYXRlT3B0aW9ucyhvcHRpb25zKSA6IGpRdWVyeS5leHRlbmQoe30sIG9wdGlvbnMpOwogICAgdmFyCiAgICAgIC8vIExhc3QgZmlyZSB2YWx1ZSAoZm9yIG5vbi1mb3JnZXR0YWJsZSBsaXN0cykKICAgICAgbWVtb3J5LAogICAgICAvLyBGbGFnIHRvIGtub3cgaWYgbGlzdCB3YXMgYWxyZWFkeSBmaXJlZAogICAgICBmaXJlZCwKICAgICAgLy8gRmxhZyB0byBrbm93IGlmIGxpc3QgaXMgY3VycmVudGx5IGZpcmluZwogICAgICBmaXJpbmcsCiAgICAgIC8vIEZpcnN0IGNhbGxiYWNrIHRvIGZpcmUgKHVzZWQgaW50ZXJuYWxseSBieSBhZGQgYW5kIGZpcmVXaXRoKQogICAgICBmaXJpbmdTdGFydCwKICAgICAgLy8gRW5kIG9mIHRoZSBsb29wIHdoZW4gZmlyaW5nCiAgICAgIGZpcmluZ0xlbmd0aCwKICAgICAgLy8gSW5kZXggb2YgY3VycmVudGx5IGZpcmluZyBjYWxsYmFjayAobW9kaWZpZWQgYnkgcmVtb3ZlIGlmIG5lZWRlZCkKICAgICAgZmlyaW5nSW5kZXgsCiAgICAgIC8vIEFjdHVhbCBjYWxsYmFjayBsaXN0CiAgICAgIGxpc3QgPSBbXSwKICAgICAgLy8gU3RhY2sgb2YgZmlyZSBjYWxscyBmb3IgcmVwZWF0YWJsZSBsaXN0cwogICAgICBzdGFjayA9ICFvcHRpb25zLm9uY2UgJiYgW10sCiAgICAgIC8vIEZpcmUgY2FsbGJhY2tzCiAgICAgIGZpcmUgPSBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgIG1lbW9yeSA9IG9wdGlvbnMubWVtb3J5ICYmIGRhdGE7CiAgICAgICAgZmlyZWQgPSB0cnVlOwogICAgICAgIGZpcmluZ0luZGV4ID0gZmlyaW5nU3RhcnQgfHwgMDsKICAgICAgICBmaXJpbmdTdGFydCA9IDA7CiAgICAgICAgZmlyaW5nTGVuZ3RoID0gbGlzdC5sZW5ndGg7CiAgICAgICAgZmlyaW5nID0gdHJ1ZTsKICAgICAgICBmb3IgKDsgbGlzdCAmJiBmaXJpbmdJbmRleCA8IGZpcmluZ0xlbmd0aDsgZmlyaW5nSW5kZXgrKykgewogICAgICAgICAgaWYgKGxpc3RbZmlyaW5nSW5kZXhdLmFwcGx5KGRhdGFbMF0sIGRhdGFbMV0pID09PSBmYWxzZSAmJiBvcHRpb25zLnN0b3BPbkZhbHNlKSB7CiAgICAgICAgICAgIG1lbW9yeSA9IGZhbHNlOwogICAgICAgICAgICAvLyBUbyBwcmV2ZW50IGZ1cnRoZXIgY2FsbHMgdXNpbmcgYWRkCiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmaXJpbmcgPSBmYWxzZTsKICAgICAgICBpZiAobGlzdCkgewogICAgICAgICAgaWYgKHN0YWNrKSB7CiAgICAgICAgICAgIGlmIChzdGFjay5sZW5ndGgpIHsKICAgICAgICAgICAgICBmaXJlKHN0YWNrLnNoaWZ0KCkpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgaWYgKG1lbW9yeSkgewogICAgICAgICAgICBsaXN0ID0gW107CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzZWxmLmRpc2FibGUoKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgIC8vIEFjdHVhbCBDYWxsYmFja3Mgb2JqZWN0CiAgICAgIHNlbGYgPSB7CiAgICAgICAgLy8gQWRkIGEgY2FsbGJhY2sgb3IgYSBjb2xsZWN0aW9uIG9mIGNhbGxiYWNrcyB0byB0aGUgbGlzdAogICAgICAgIGFkZDogZnVuY3Rpb24gKCkgewogICAgICAgICAgaWYgKGxpc3QpIHsKICAgICAgICAgICAgLy8gRmlyc3QsIHdlIHNhdmUgdGhlIGN1cnJlbnQgbGVuZ3RoCiAgICAgICAgICAgIHZhciBzdGFydCA9IGxpc3QubGVuZ3RoOwogICAgICAgICAgICAoZnVuY3Rpb24gYWRkKGFyZ3MpIHsKICAgICAgICAgICAgICBqUXVlcnkuZWFjaChhcmdzLCBmdW5jdGlvbiAoXywgYXJnKSB7CiAgICAgICAgICAgICAgICB2YXIgdHlwZSA9IGpRdWVyeS50eXBlKGFyZyk7CiAgICAgICAgICAgICAgICBpZiAodHlwZSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICAgICAgICBpZiAoIW9wdGlvbnMudW5pcXVlIHx8ICFzZWxmLmhhcyhhcmcpKSB7CiAgICAgICAgICAgICAgICAgICAgbGlzdC5wdXNoKGFyZyk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoYXJnICYmIGFyZy5sZW5ndGggJiYgdHlwZSAhPT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgICAgICAgLy8gSW5zcGVjdCByZWN1cnNpdmVseQogICAgICAgICAgICAgICAgICBhZGQoYXJnKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfShhcmd1bWVudHMpKTsKICAgICAgICAgICAgLy8gRG8gd2UgbmVlZCB0byBhZGQgdGhlIGNhbGxiYWNrcyB0byB0aGUKICAgICAgICAgICAgLy8gY3VycmVudCBmaXJpbmcgYmF0Y2g/CiAgICAgICAgICAgIGlmIChmaXJpbmcpIHsKICAgICAgICAgICAgICBmaXJpbmdMZW5ndGggPSBsaXN0Lmxlbmd0aDsgIC8vIFdpdGggbWVtb3J5LCBpZiB3ZSdyZSBub3QgZmlyaW5nIHRoZW4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHdlIHNob3VsZCBjYWxsIHJpZ2h0IGF3YXkKICAgICAgICAgICAgfSBlbHNlIGlmIChtZW1vcnkpIHsKICAgICAgICAgICAgICBmaXJpbmdTdGFydCA9IHN0YXJ0OwogICAgICAgICAgICAgIGZpcmUobWVtb3J5KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSwKICAgICAgICAvLyBSZW1vdmUgYSBjYWxsYmFjayBmcm9tIHRoZSBsaXN0CiAgICAgICAgcmVtb3ZlOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBpZiAobGlzdCkgewogICAgICAgICAgICBqUXVlcnkuZWFjaChhcmd1bWVudHMsIGZ1bmN0aW9uIChfLCBhcmcpIHsKICAgICAgICAgICAgICB2YXIgaW5kZXg7CiAgICAgICAgICAgICAgd2hpbGUgKChpbmRleCA9IGpRdWVyeS5pbkFycmF5KGFyZywgbGlzdCwgaW5kZXgpKSA+IC0xKSB7CiAgICAgICAgICAgICAgICBsaXN0LnNwbGljZShpbmRleCwgMSk7CiAgICAgICAgICAgICAgICAvLyBIYW5kbGUgZmlyaW5nIGluZGV4ZXMKICAgICAgICAgICAgICAgIGlmIChmaXJpbmcpIHsKICAgICAgICAgICAgICAgICAgaWYgKGluZGV4IDw9IGZpcmluZ0xlbmd0aCkgewogICAgICAgICAgICAgICAgICAgIGZpcmluZ0xlbmd0aC0tOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmIChpbmRleCA8PSBmaXJpbmdJbmRleCkgewogICAgICAgICAgICAgICAgICAgIGZpcmluZ0luZGV4LS07CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSwKICAgICAgICAvLyBDaGVjayBpZiBhIGdpdmVuIGNhbGxiYWNrIGlzIGluIHRoZSBsaXN0LgogICAgICAgIC8vIElmIG5vIGFyZ3VtZW50IGlzIGdpdmVuLCByZXR1cm4gd2hldGhlciBvciBub3QgbGlzdCBoYXMgY2FsbGJhY2tzIGF0dGFjaGVkLgogICAgICAgIGhhczogZnVuY3Rpb24gKGZuKSB7CiAgICAgICAgICByZXR1cm4gZm4gPyBqUXVlcnkuaW5BcnJheShmbiwgbGlzdCkgPiAtMSA6ICEhKGxpc3QgJiYgbGlzdC5sZW5ndGgpOwogICAgICAgIH0sCiAgICAgICAgLy8gUmVtb3ZlIGFsbCBjYWxsYmFja3MgZnJvbSB0aGUgbGlzdAogICAgICAgIGVtcHR5OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBsaXN0ID0gW107CiAgICAgICAgICBmaXJpbmdMZW5ndGggPSAwOwogICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSwKICAgICAgICAvLyBIYXZlIHRoZSBsaXN0IGRvIG5vdGhpbmcgYW55bW9yZQogICAgICAgIGRpc2FibGU6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGxpc3QgPSBzdGFjayA9IG1lbW9yeSA9IHVuZGVmaW5lZDsKICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCiAgICAgICAgLy8gSXMgaXQgZGlzYWJsZWQ/CiAgICAgICAgZGlzYWJsZWQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHJldHVybiAhbGlzdDsKICAgICAgICB9LAogICAgICAgIC8vIExvY2sgdGhlIGxpc3QgaW4gaXRzIGN1cnJlbnQgc3RhdGUKICAgICAgICBsb2NrOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBzdGFjayA9IHVuZGVmaW5lZDsKICAgICAgICAgIGlmICghbWVtb3J5KSB7CiAgICAgICAgICAgIHNlbGYuZGlzYWJsZSgpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSwKICAgICAgICAvLyBJcyBpdCBsb2NrZWQ/CiAgICAgICAgbG9ja2VkOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICByZXR1cm4gIXN0YWNrOwogICAgICAgIH0sCiAgICAgICAgLy8gQ2FsbCBhbGwgY2FsbGJhY2tzIHdpdGggdGhlIGdpdmVuIGNvbnRleHQgYW5kIGFyZ3VtZW50cwogICAgICAgIGZpcmVXaXRoOiBmdW5jdGlvbiAoY29udGV4dCwgYXJncykgewogICAgICAgICAgaWYgKGxpc3QgJiYgKCFmaXJlZCB8fCBzdGFjaykpIHsKICAgICAgICAgICAgYXJncyA9IGFyZ3MgfHwgW107CiAgICAgICAgICAgIGFyZ3MgPSBbCiAgICAgICAgICAgICAgY29udGV4dCwKICAgICAgICAgICAgICBhcmdzLnNsaWNlID8gYXJncy5zbGljZSgpIDogYXJncwogICAgICAgICAgICBdOwogICAgICAgICAgICBpZiAoZmlyaW5nKSB7CiAgICAgICAgICAgICAgc3RhY2sucHVzaChhcmdzKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBmaXJlKGFyZ3MpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9LAogICAgICAgIC8vIENhbGwgYWxsIHRoZSBjYWxsYmFja3Mgd2l0aCB0aGUgZ2l2ZW4gYXJndW1lbnRzCiAgICAgICAgZmlyZTogZnVuY3Rpb24gKCkgewogICAgICAgICAgc2VsZi5maXJlV2l0aCh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSwKICAgICAgICAvLyBUbyBrbm93IGlmIHRoZSBjYWxsYmFja3MgaGF2ZSBhbHJlYWR5IGJlZW4gY2FsbGVkIGF0IGxlYXN0IG9uY2UKICAgICAgICBmaXJlZDogZnVuY3Rpb24gKCkgewogICAgICAgICAgcmV0dXJuICEhZmlyZWQ7CiAgICAgICAgfQogICAgICB9OwogICAgcmV0dXJuIHNlbGY7CiAgfTsKICBqUXVlcnkuZXh0ZW5kKHsKICAgIERlZmVycmVkOiBmdW5jdGlvbiAoZnVuYykgewogICAgICB2YXIgdHVwbGVzID0gWwogICAgICAgICAgLy8gYWN0aW9uLCBhZGQgbGlzdGVuZXIsIGxpc3RlbmVyIGxpc3QsIGZpbmFsIHN0YXRlCiAgICAgICAgICBbCiAgICAgICAgICAgICdyZXNvbHZlJywKICAgICAgICAgICAgJ2RvbmUnLAogICAgICAgICAgICBqUXVlcnkuQ2FsbGJhY2tzKCdvbmNlIG1lbW9yeScpLAogICAgICAgICAgICAncmVzb2x2ZWQnCiAgICAgICAgICBdLAogICAgICAgICAgWwogICAgICAgICAgICAncmVqZWN0JywKICAgICAgICAgICAgJ2ZhaWwnLAogICAgICAgICAgICBqUXVlcnkuQ2FsbGJhY2tzKCdvbmNlIG1lbW9yeScpLAogICAgICAgICAgICAncmVqZWN0ZWQnCiAgICAgICAgICBdLAogICAgICAgICAgWwogICAgICAgICAgICAnbm90aWZ5JywKICAgICAgICAgICAgJ3Byb2dyZXNzJywKICAgICAgICAgICAgalF1ZXJ5LkNhbGxiYWNrcygnbWVtb3J5JykKICAgICAgICAgIF0KICAgICAgICBdLCBzdGF0ZSA9ICdwZW5kaW5nJywgcHJvbWlzZSA9IHsKICAgICAgICAgIHN0YXRlOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiBzdGF0ZTsKICAgICAgICAgIH0sCiAgICAgICAgICBhbHdheXM6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgZGVmZXJyZWQuZG9uZShhcmd1bWVudHMpLmZhaWwoYXJndW1lbnRzKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICB9LAogICAgICAgICAgdGhlbjogZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgZm5zID0gYXJndW1lbnRzOwogICAgICAgICAgICByZXR1cm4galF1ZXJ5LkRlZmVycmVkKGZ1bmN0aW9uIChuZXdEZWZlcikgewogICAgICAgICAgICAgIGpRdWVyeS5lYWNoKHR1cGxlcywgZnVuY3Rpb24gKGksIHR1cGxlKSB7CiAgICAgICAgICAgICAgICB2YXIgZm4gPSBqUXVlcnkuaXNGdW5jdGlvbihmbnNbaV0pICYmIGZuc1tpXTsKICAgICAgICAgICAgICAgIC8vIGRlZmVycmVkWyBkb25lIHwgZmFpbCB8IHByb2dyZXNzIF0gZm9yIGZvcndhcmRpbmcgYWN0aW9ucyB0byBuZXdEZWZlcgogICAgICAgICAgICAgICAgZGVmZXJyZWRbdHVwbGVbMV1dKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgdmFyIHJldHVybmVkID0gZm4gJiYgZm4uYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgICAgICAgICAgaWYgKHJldHVybmVkICYmIGpRdWVyeS5pc0Z1bmN0aW9uKHJldHVybmVkLnByb21pc2UpKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuZWQucHJvbWlzZSgpLmRvbmUobmV3RGVmZXIucmVzb2x2ZSkuZmFpbChuZXdEZWZlci5yZWplY3QpLnByb2dyZXNzKG5ld0RlZmVyLm5vdGlmeSk7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgbmV3RGVmZXJbdHVwbGVbMF0gKyAnV2l0aCddKHRoaXMgPT09IHByb21pc2UgPyBuZXdEZWZlci5wcm9taXNlKCkgOiB0aGlzLCBmbiA/IFtyZXR1cm5lZF0gOiBhcmd1bWVudHMpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICBmbnMgPSBudWxsOwogICAgICAgICAgICB9KS5wcm9taXNlKCk7CiAgICAgICAgICB9LAogICAgICAgICAgLy8gR2V0IGEgcHJvbWlzZSBmb3IgdGhpcyBkZWZlcnJlZAogICAgICAgICAgLy8gSWYgb2JqIGlzIHByb3ZpZGVkLCB0aGUgcHJvbWlzZSBhc3BlY3QgaXMgYWRkZWQgdG8gdGhlIG9iamVjdAogICAgICAgICAgcHJvbWlzZTogZnVuY3Rpb24gKG9iaikgewogICAgICAgICAgICByZXR1cm4gb2JqICE9IG51bGwgPyBqUXVlcnkuZXh0ZW5kKG9iaiwgcHJvbWlzZSkgOiBwcm9taXNlOwogICAgICAgICAgfQogICAgICAgIH0sIGRlZmVycmVkID0ge307CiAgICAgIC8vIEtlZXAgcGlwZSBmb3IgYmFjay1jb21wYXQKICAgICAgcHJvbWlzZS5waXBlID0gcHJvbWlzZS50aGVuOwogICAgICAvLyBBZGQgbGlzdC1zcGVjaWZpYyBtZXRob2RzCiAgICAgIGpRdWVyeS5lYWNoKHR1cGxlcywgZnVuY3Rpb24gKGksIHR1cGxlKSB7CiAgICAgICAgdmFyIGxpc3QgPSB0dXBsZVsyXSwgc3RhdGVTdHJpbmcgPSB0dXBsZVszXTsKICAgICAgICAvLyBwcm9taXNlWyBkb25lIHwgZmFpbCB8IHByb2dyZXNzIF0gPSBsaXN0LmFkZAogICAgICAgIHByb21pc2VbdHVwbGVbMV1dID0gbGlzdC5hZGQ7CiAgICAgICAgLy8gSGFuZGxlIHN0YXRlCiAgICAgICAgaWYgKHN0YXRlU3RyaW5nKSB7CiAgICAgICAgICBsaXN0LmFkZChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIC8vIHN0YXRlID0gWyByZXNvbHZlZCB8IHJlamVjdGVkIF0KICAgICAgICAgICAgc3RhdGUgPSBzdGF0ZVN0cmluZzsgIC8vIFsgcmVqZWN0X2xpc3QgfCByZXNvbHZlX2xpc3QgXS5kaXNhYmxlOyBwcm9ncmVzc19saXN0LmxvY2sKICAgICAgICAgIH0sIHR1cGxlc1tpIF4gMV1bMl0uZGlzYWJsZSwgdHVwbGVzWzJdWzJdLmxvY2spOwogICAgICAgIH0KICAgICAgICAvLyBkZWZlcnJlZFsgcmVzb2x2ZSB8IHJlamVjdCB8IG5vdGlmeSBdCiAgICAgICAgZGVmZXJyZWRbdHVwbGVbMF1dID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgZGVmZXJyZWRbdHVwbGVbMF0gKyAnV2l0aCddKHRoaXMgPT09IGRlZmVycmVkID8gcHJvbWlzZSA6IHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9OwogICAgICAgIGRlZmVycmVkW3R1cGxlWzBdICsgJ1dpdGgnXSA9IGxpc3QuZmlyZVdpdGg7CiAgICAgIH0pOwogICAgICAvLyBNYWtlIHRoZSBkZWZlcnJlZCBhIHByb21pc2UKICAgICAgcHJvbWlzZS5wcm9taXNlKGRlZmVycmVkKTsKICAgICAgLy8gQ2FsbCBnaXZlbiBmdW5jIGlmIGFueQogICAgICBpZiAoZnVuYykgewogICAgICAgIGZ1bmMuY2FsbChkZWZlcnJlZCwgZGVmZXJyZWQpOwogICAgICB9CiAgICAgIC8vIEFsbCBkb25lIQogICAgICByZXR1cm4gZGVmZXJyZWQ7CiAgICB9LAogICAgLy8gRGVmZXJyZWQgaGVscGVyCiAgICB3aGVuOiBmdW5jdGlvbiAoc3Vib3JkaW5hdGUpIHsKICAgICAgdmFyIGkgPSAwLCByZXNvbHZlVmFsdWVzID0gc2xpY2UuY2FsbChhcmd1bWVudHMpLCBsZW5ndGggPSByZXNvbHZlVmFsdWVzLmxlbmd0aCwKICAgICAgICAvLyB0aGUgY291bnQgb2YgdW5jb21wbGV0ZWQgc3Vib3JkaW5hdGVzCiAgICAgICAgcmVtYWluaW5nID0gbGVuZ3RoICE9PSAxIHx8IHN1Ym9yZGluYXRlICYmIGpRdWVyeS5pc0Z1bmN0aW9uKHN1Ym9yZGluYXRlLnByb21pc2UpID8gbGVuZ3RoIDogMCwKICAgICAgICAvLyB0aGUgbWFzdGVyIERlZmVycmVkLiBJZiByZXNvbHZlVmFsdWVzIGNvbnNpc3Qgb2Ygb25seSBhIHNpbmdsZSBEZWZlcnJlZCwganVzdCB1c2UgdGhhdC4KICAgICAgICBkZWZlcnJlZCA9IHJlbWFpbmluZyA9PT0gMSA/IHN1Ym9yZGluYXRlIDogalF1ZXJ5LkRlZmVycmVkKCksCiAgICAgICAgLy8gVXBkYXRlIGZ1bmN0aW9uIGZvciBib3RoIHJlc29sdmUgYW5kIHByb2dyZXNzIHZhbHVlcwogICAgICAgIHVwZGF0ZUZ1bmMgPSBmdW5jdGlvbiAoaSwgY29udGV4dHMsIHZhbHVlcykgewogICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICBjb250ZXh0c1tpXSA9IHRoaXM7CiAgICAgICAgICAgIHZhbHVlc1tpXSA9IGFyZ3VtZW50cy5sZW5ndGggPiAxID8gc2xpY2UuY2FsbChhcmd1bWVudHMpIDogdmFsdWU7CiAgICAgICAgICAgIGlmICh2YWx1ZXMgPT09IHByb2dyZXNzVmFsdWVzKSB7CiAgICAgICAgICAgICAgZGVmZXJyZWQubm90aWZ5V2l0aChjb250ZXh0cywgdmFsdWVzKTsKICAgICAgICAgICAgfSBlbHNlIGlmICghLS1yZW1haW5pbmcpIHsKICAgICAgICAgICAgICBkZWZlcnJlZC5yZXNvbHZlV2l0aChjb250ZXh0cywgdmFsdWVzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICB9LCBwcm9ncmVzc1ZhbHVlcywgcHJvZ3Jlc3NDb250ZXh0cywgcmVzb2x2ZUNvbnRleHRzOwogICAgICAvLyBhZGQgbGlzdGVuZXJzIHRvIERlZmVycmVkIHN1Ym9yZGluYXRlczsgdHJlYXQgb3RoZXJzIGFzIHJlc29sdmVkCiAgICAgIGlmIChsZW5ndGggPiAxKSB7CiAgICAgICAgcHJvZ3Jlc3NWYWx1ZXMgPSBuZXcgQXJyYXkobGVuZ3RoKTsKICAgICAgICBwcm9ncmVzc0NvbnRleHRzID0gbmV3IEFycmF5KGxlbmd0aCk7CiAgICAgICAgcmVzb2x2ZUNvbnRleHRzID0gbmV3IEFycmF5KGxlbmd0aCk7CiAgICAgICAgZm9yICg7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgaWYgKHJlc29sdmVWYWx1ZXNbaV0gJiYgalF1ZXJ5LmlzRnVuY3Rpb24ocmVzb2x2ZVZhbHVlc1tpXS5wcm9taXNlKSkgewogICAgICAgICAgICByZXNvbHZlVmFsdWVzW2ldLnByb21pc2UoKS5kb25lKHVwZGF0ZUZ1bmMoaSwgcmVzb2x2ZUNvbnRleHRzLCByZXNvbHZlVmFsdWVzKSkuZmFpbChkZWZlcnJlZC5yZWplY3QpLnByb2dyZXNzKHVwZGF0ZUZ1bmMoaSwgcHJvZ3Jlc3NDb250ZXh0cywgcHJvZ3Jlc3NWYWx1ZXMpKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIC0tcmVtYWluaW5nOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICAvLyBpZiB3ZSdyZSBub3Qgd2FpdGluZyBvbiBhbnl0aGluZywgcmVzb2x2ZSB0aGUgbWFzdGVyCiAgICAgIGlmICghcmVtYWluaW5nKSB7CiAgICAgICAgZGVmZXJyZWQucmVzb2x2ZVdpdGgocmVzb2x2ZUNvbnRleHRzLCByZXNvbHZlVmFsdWVzKTsKICAgICAgfQogICAgICByZXR1cm4gZGVmZXJyZWQucHJvbWlzZSgpOwogICAgfQogIH0pOwogIC8vIFRoZSBkZWZlcnJlZCB1c2VkIG9uIERPTSByZWFkeQogIHZhciByZWFkeUxpc3Q7CiAgalF1ZXJ5LmZuLnJlYWR5ID0gZnVuY3Rpb24gKGZuKSB7CiAgICAvLyBBZGQgdGhlIGNhbGxiYWNrCiAgICBqUXVlcnkucmVhZHkucHJvbWlzZSgpLmRvbmUoZm4pOwogICAgcmV0dXJuIHRoaXM7CiAgfTsKICBqUXVlcnkuZXh0ZW5kKHsKICAgIC8vIElzIHRoZSBET00gcmVhZHkgdG8gYmUgdXNlZD8gU2V0IHRvIHRydWUgb25jZSBpdCBvY2N1cnMuCiAgICBpc1JlYWR5OiBmYWxzZSwKICAgIC8vIEEgY291bnRlciB0byB0cmFjayBob3cgbWFueSBpdGVtcyB0byB3YWl0IGZvciBiZWZvcmUKICAgIC8vIHRoZSByZWFkeSBldmVudCBmaXJlcy4gU2VlICM2NzgxCiAgICByZWFkeVdhaXQ6IDEsCiAgICAvLyBIb2xkIChvciByZWxlYXNlKSB0aGUgcmVhZHkgZXZlbnQKICAgIGhvbGRSZWFkeTogZnVuY3Rpb24gKGhvbGQpIHsKICAgICAgaWYgKGhvbGQpIHsKICAgICAgICBqUXVlcnkucmVhZHlXYWl0Kys7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgalF1ZXJ5LnJlYWR5KHRydWUpOwogICAgICB9CiAgICB9LAogICAgLy8gSGFuZGxlIHdoZW4gdGhlIERPTSBpcyByZWFkeQogICAgcmVhZHk6IGZ1bmN0aW9uICh3YWl0KSB7CiAgICAgIC8vIEFib3J0IGlmIHRoZXJlIGFyZSBwZW5kaW5nIGhvbGRzIG9yIHdlJ3JlIGFscmVhZHkgcmVhZHkKICAgICAgaWYgKHdhaXQgPT09IHRydWUgPyAtLWpRdWVyeS5yZWFkeVdhaXQgOiBqUXVlcnkuaXNSZWFkeSkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICAvLyBSZW1lbWJlciB0aGF0IHRoZSBET00gaXMgcmVhZHkKICAgICAgalF1ZXJ5LmlzUmVhZHkgPSB0cnVlOwogICAgICAvLyBJZiBhIG5vcm1hbCBET00gUmVhZHkgZXZlbnQgZmlyZWQsIGRlY3JlbWVudCwgYW5kIHdhaXQgaWYgbmVlZCBiZQogICAgICBpZiAod2FpdCAhPT0gdHJ1ZSAmJiAtLWpRdWVyeS5yZWFkeVdhaXQgPiAwKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIC8vIElmIHRoZXJlIGFyZSBmdW5jdGlvbnMgYm91bmQsIHRvIGV4ZWN1dGUKICAgICAgcmVhZHlMaXN0LnJlc29sdmVXaXRoKGRvY3VtZW50LCBbalF1ZXJ5XSk7CiAgICAgIC8vIFRyaWdnZXIgYW55IGJvdW5kIHJlYWR5IGV2ZW50cwogICAgICBpZiAoalF1ZXJ5LmZuLnRyaWdnZXJIYW5kbGVyKSB7CiAgICAgICAgalF1ZXJ5KGRvY3VtZW50KS50cmlnZ2VySGFuZGxlcigncmVhZHknKTsKICAgICAgICBqUXVlcnkoZG9jdW1lbnQpLm9mZigncmVhZHknKTsKICAgICAgfQogICAgfQogIH0pOwogIC8qKgogICAqIFRoZSByZWFkeSBldmVudCBoYW5kbGVyIGFuZCBzZWxmIGNsZWFudXAgbWV0aG9kCiAgICovCiAgZnVuY3Rpb24gY29tcGxldGVkKCkgewogICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcignRE9NQ29udGVudExvYWRlZCcsIGNvbXBsZXRlZCwgZmFsc2UpOwogICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2xvYWQnLCBjb21wbGV0ZWQsIGZhbHNlKTsKICAgIGpRdWVyeS5yZWFkeSgpOwogIH0KICBqUXVlcnkucmVhZHkucHJvbWlzZSA9IGZ1bmN0aW9uIChvYmopIHsKICAgIGlmICghcmVhZHlMaXN0KSB7CiAgICAgIHJlYWR5TGlzdCA9IGpRdWVyeS5EZWZlcnJlZCgpOwogICAgICAvLyBDYXRjaCBjYXNlcyB3aGVyZSAkKGRvY3VtZW50KS5yZWFkeSgpIGlzIGNhbGxlZCBhZnRlciB0aGUgYnJvd3NlciBldmVudCBoYXMgYWxyZWFkeSBvY2N1cnJlZC4KICAgICAgLy8gd2Ugb25jZSB0cmllZCB0byB1c2UgcmVhZHlTdGF0ZSAiaW50ZXJhY3RpdmUiIGhlcmUsIGJ1dCBpdCBjYXVzZWQgaXNzdWVzIGxpa2UgdGhlIG9uZQogICAgICAvLyBkaXNjb3ZlcmVkIGJ5IENocmlzUyBoZXJlOiBodHRwOi8vYnVncy5qcXVlcnkuY29tL3RpY2tldC8xMjI4MiNjb21tZW50OjE1CiAgICAgIGlmIChkb2N1bWVudC5yZWFkeVN0YXRlID09PSAnY29tcGxldGUnKSB7CiAgICAgICAgLy8gSGFuZGxlIGl0IGFzeW5jaHJvbm91c2x5IHRvIGFsbG93IHNjcmlwdHMgdGhlIG9wcG9ydHVuaXR5IHRvIGRlbGF5IHJlYWR5CiAgICAgICAgc2V0VGltZW91dChqUXVlcnkucmVhZHkpOwogICAgICB9IGVsc2UgewogICAgICAgIC8vIFVzZSB0aGUgaGFuZHkgZXZlbnQgY2FsbGJhY2sKICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdET01Db250ZW50TG9hZGVkJywgY29tcGxldGVkLCBmYWxzZSk7CiAgICAgICAgLy8gQSBmYWxsYmFjayB0byB3aW5kb3cub25sb2FkLCB0aGF0IHdpbGwgYWx3YXlzIHdvcmsKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbG9hZCcsIGNvbXBsZXRlZCwgZmFsc2UpOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gcmVhZHlMaXN0LnByb21pc2Uob2JqKTsKICB9OwogIC8vIEtpY2sgb2ZmIHRoZSBET00gcmVhZHkgY2hlY2sgZXZlbiBpZiB0aGUgdXNlciBkb2VzIG5vdAogIGpRdWVyeS5yZWFkeS5wcm9taXNlKCk7CiAgLy8gTXVsdGlmdW5jdGlvbmFsIG1ldGhvZCB0byBnZXQgYW5kIHNldCB2YWx1ZXMgb2YgYSBjb2xsZWN0aW9uCiAgLy8gVGhlIHZhbHVlL3MgY2FuIG9wdGlvbmFsbHkgYmUgZXhlY3V0ZWQgaWYgaXQncyBhIGZ1bmN0aW9uCiAgdmFyIGFjY2VzcyA9IGpRdWVyeS5hY2Nlc3MgPSBmdW5jdGlvbiAoZWxlbXMsIGZuLCBrZXksIHZhbHVlLCBjaGFpbmFibGUsIGVtcHR5R2V0LCByYXcpIHsKICAgIHZhciBpID0gMCwgbGVuID0gZWxlbXMubGVuZ3RoLCBidWxrID0ga2V5ID09IG51bGw7CiAgICAvLyBTZXRzIG1hbnkgdmFsdWVzCiAgICBpZiAoalF1ZXJ5LnR5cGUoa2V5KSA9PT0gJ29iamVjdCcpIHsKICAgICAgY2hhaW5hYmxlID0gdHJ1ZTsKICAgICAgZm9yIChpIGluIGtleSkgewogICAgICAgIGpRdWVyeS5hY2Nlc3MoZWxlbXMsIGZuLCBpLCBrZXlbaV0sIHRydWUsIGVtcHR5R2V0LCByYXcpOwogICAgICB9ICAvLyBTZXRzIG9uZSB2YWx1ZQogICAgfSBlbHNlIGlmICh2YWx1ZSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgIGNoYWluYWJsZSA9IHRydWU7CiAgICAgIGlmICghalF1ZXJ5LmlzRnVuY3Rpb24odmFsdWUpKSB7CiAgICAgICAgcmF3ID0gdHJ1ZTsKICAgICAgfQogICAgICBpZiAoYnVsaykgewogICAgICAgIC8vIEJ1bGsgb3BlcmF0aW9ucyBydW4gYWdhaW5zdCB0aGUgZW50aXJlIHNldAogICAgICAgIGlmIChyYXcpIHsKICAgICAgICAgIGZuLmNhbGwoZWxlbXMsIHZhbHVlKTsKICAgICAgICAgIGZuID0gbnVsbDsgIC8vIC4uLmV4Y2VwdCB3aGVuIGV4ZWN1dGluZyBmdW5jdGlvbiB2YWx1ZXMKICAgICAgICB9IGVsc2UgewogICAgICAgICAgYnVsayA9IGZuOwogICAgICAgICAgZm4gPSBmdW5jdGlvbiAoZWxlbSwga2V5LCB2YWx1ZSkgewogICAgICAgICAgICByZXR1cm4gYnVsay5jYWxsKGpRdWVyeShlbGVtKSwgdmFsdWUpOwogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKGZuKSB7CiAgICAgICAgZm9yICg7IGkgPCBsZW47IGkrKykgewogICAgICAgICAgZm4oZWxlbXNbaV0sIGtleSwgcmF3ID8gdmFsdWUgOiB2YWx1ZS5jYWxsKGVsZW1zW2ldLCBpLCBmbihlbGVtc1tpXSwga2V5KSkpOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgcmV0dXJuIGNoYWluYWJsZSA/IGVsZW1zIDogLy8gR2V0cwogICAgYnVsayA/IGZuLmNhbGwoZWxlbXMpIDogbGVuID8gZm4oZWxlbXNbMF0sIGtleSkgOiBlbXB0eUdldDsKICB9OwogIC8qKgogICAqIERldGVybWluZXMgd2hldGhlciBhbiBvYmplY3QgY2FuIGhhdmUgZGF0YQogICAqLwogIGpRdWVyeS5hY2NlcHREYXRhID0gZnVuY3Rpb24gKG93bmVyKSB7CiAgICAvLyBBY2NlcHRzIG9ubHk6CiAgICAvLyAgLSBOb2RlCiAgICAvLyAgICAtIE5vZGUuRUxFTUVOVF9OT0RFCiAgICAvLyAgICAtIE5vZGUuRE9DVU1FTlRfTk9ERQogICAgLy8gIC0gT2JqZWN0CiAgICAvLyAgICAtIEFueQogICAgLyoganNoaW50IC1XMDE4ICovCiAgICByZXR1cm4gb3duZXIubm9kZVR5cGUgPT09IDEgfHwgb3duZXIubm9kZVR5cGUgPT09IDkgfHwgIStvd25lci5ub2RlVHlwZTsKICB9OwogIGZ1bmN0aW9uIERhdGEoKSB7CiAgICAvLyBTdXBwb3J0OiBBbmRyb2lkIDwgNCwKICAgIC8vIE9sZCBXZWJLaXQgZG9lcyBub3QgaGF2ZSBPYmplY3QucHJldmVudEV4dGVuc2lvbnMvZnJlZXplIG1ldGhvZCwKICAgIC8vIHJldHVybiBuZXcgZW1wdHkgb2JqZWN0IGluc3RlYWQgd2l0aCBubyBbW3NldF1dIGFjY2Vzc29yCiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkodGhpcy5jYWNoZSA9IHt9LCAwLCB7CiAgICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB7fTsKICAgICAgfQogICAgfSk7CiAgICB0aGlzLmV4cGFuZG8gPSBqUXVlcnkuZXhwYW5kbyArIE1hdGgucmFuZG9tKCk7CiAgfQogIERhdGEudWlkID0gMTsKICBEYXRhLmFjY2VwdHMgPSBqUXVlcnkuYWNjZXB0RGF0YTsKICBEYXRhLnByb3RvdHlwZSA9IHsKICAgIGtleTogZnVuY3Rpb24gKG93bmVyKSB7CiAgICAgIC8vIFdlIGNhbiBhY2NlcHQgZGF0YSBmb3Igbm9uLWVsZW1lbnQgbm9kZXMgaW4gbW9kZXJuIGJyb3dzZXJzLAogICAgICAvLyBidXQgd2Ugc2hvdWxkIG5vdCwgc2VlICM4MzM1LgogICAgICAvLyBBbHdheXMgcmV0dXJuIHRoZSBrZXkgZm9yIGEgZnJvemVuIG9iamVjdC4KICAgICAgaWYgKCFEYXRhLmFjY2VwdHMob3duZXIpKSB7CiAgICAgICAgcmV0dXJuIDA7CiAgICAgIH0KICAgICAgdmFyIGRlc2NyaXB0b3IgPSB7fSwKICAgICAgICAvLyBDaGVjayBpZiB0aGUgb3duZXIgb2JqZWN0IGFscmVhZHkgaGFzIGEgY2FjaGUga2V5CiAgICAgICAgdW5sb2NrID0gb3duZXJbdGhpcy5leHBhbmRvXTsKICAgICAgLy8gSWYgbm90LCBjcmVhdGUgb25lCiAgICAgIGlmICghdW5sb2NrKSB7CiAgICAgICAgdW5sb2NrID0gRGF0YS51aWQrKzsKICAgICAgICAvLyBTZWN1cmUgaXQgaW4gYSBub24tZW51bWVyYWJsZSwgbm9uLXdyaXRhYmxlIHByb3BlcnR5CiAgICAgICAgdHJ5IHsKICAgICAgICAgIGRlc2NyaXB0b3JbdGhpcy5leHBhbmRvXSA9IHsgdmFsdWU6IHVubG9jayB9OwogICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXMob3duZXIsIGRlc2NyaXB0b3IpOyAgLy8gU3VwcG9ydDogQW5kcm9pZCA8IDQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIEZhbGxiYWNrIHRvIGEgbGVzcyBzZWN1cmUgZGVmaW5pdGlvbgogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgIGRlc2NyaXB0b3JbdGhpcy5leHBhbmRvXSA9IHVubG9jazsKICAgICAgICAgIGpRdWVyeS5leHRlbmQob3duZXIsIGRlc2NyaXB0b3IpOwogICAgICAgIH0KICAgICAgfQogICAgICAvLyBFbnN1cmUgdGhlIGNhY2hlIG9iamVjdAogICAgICBpZiAoIXRoaXMuY2FjaGVbdW5sb2NrXSkgewogICAgICAgIHRoaXMuY2FjaGVbdW5sb2NrXSA9IHt9OwogICAgICB9CiAgICAgIHJldHVybiB1bmxvY2s7CiAgICB9LAogICAgc2V0OiBmdW5jdGlvbiAob3duZXIsIGRhdGEsIHZhbHVlKSB7CiAgICAgIHZhciBwcm9wLAogICAgICAgIC8vIFRoZXJlIG1heSBiZSBhbiB1bmxvY2sgYXNzaWduZWQgdG8gdGhpcyBub2RlLAogICAgICAgIC8vIGlmIHRoZXJlIGlzIG5vIGVudHJ5IGZvciB0aGlzICJvd25lciIsIGNyZWF0ZSBvbmUgaW5saW5lCiAgICAgICAgLy8gYW5kIHNldCB0aGUgdW5sb2NrIGFzIHRob3VnaCBhbiBvd25lciBlbnRyeSBoYWQgYWx3YXlzIGV4aXN0ZWQKICAgICAgICB1bmxvY2sgPSB0aGlzLmtleShvd25lciksIGNhY2hlID0gdGhpcy5jYWNoZVt1bmxvY2tdOwogICAgICAvLyBIYW5kbGU6IFsgb3duZXIsIGtleSwgdmFsdWUgXSBhcmdzCiAgICAgIGlmICh0eXBlb2YgZGF0YSA9PT0gJ3N0cmluZycpIHsKICAgICAgICBjYWNoZVtkYXRhXSA9IHZhbHVlOyAgLy8gSGFuZGxlOiBbIG93bmVyLCB7IHByb3BlcnRpZXMgfSBdIGFyZ3MKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBGcmVzaCBhc3NpZ25tZW50cyBieSBvYmplY3QgYXJlIHNoYWxsb3cgY29waWVkCiAgICAgICAgaWYgKGpRdWVyeS5pc0VtcHR5T2JqZWN0KGNhY2hlKSkgewogICAgICAgICAgalF1ZXJ5LmV4dGVuZCh0aGlzLmNhY2hlW3VubG9ja10sIGRhdGEpOyAgLy8gT3RoZXJ3aXNlLCBjb3B5IHRoZSBwcm9wZXJ0aWVzIG9uZS1ieS1vbmUgdG8gdGhlIGNhY2hlIG9iamVjdAogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBmb3IgKHByb3AgaW4gZGF0YSkgewogICAgICAgICAgICBjYWNoZVtwcm9wXSA9IGRhdGFbcHJvcF07CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBjYWNoZTsKICAgIH0sCiAgICBnZXQ6IGZ1bmN0aW9uIChvd25lciwga2V5KSB7CiAgICAgIC8vIEVpdGhlciBhIHZhbGlkIGNhY2hlIGlzIGZvdW5kLCBvciB3aWxsIGJlIGNyZWF0ZWQuCiAgICAgIC8vIE5ldyBjYWNoZXMgd2lsbCBiZSBjcmVhdGVkIGFuZCB0aGUgdW5sb2NrIHJldHVybmVkLAogICAgICAvLyBhbGxvd2luZyBkaXJlY3QgYWNjZXNzIHRvIHRoZSBuZXdseSBjcmVhdGVkCiAgICAgIC8vIGVtcHR5IGRhdGEgb2JqZWN0LiBBIHZhbGlkIG93bmVyIG9iamVjdCBtdXN0IGJlIHByb3ZpZGVkLgogICAgICB2YXIgY2FjaGUgPSB0aGlzLmNhY2hlW3RoaXMua2V5KG93bmVyKV07CiAgICAgIHJldHVybiBrZXkgPT09IHVuZGVmaW5lZCA/IGNhY2hlIDogY2FjaGVba2V5XTsKICAgIH0sCiAgICBhY2Nlc3M6IGZ1bmN0aW9uIChvd25lciwga2V5LCB2YWx1ZSkgewogICAgICB2YXIgc3RvcmVkOwogICAgICAvLyBJbiBjYXNlcyB3aGVyZSBlaXRoZXI6CiAgICAgIC8vCiAgICAgIC8vICAgMS4gTm8ga2V5IHdhcyBzcGVjaWZpZWQKICAgICAgLy8gICAyLiBBIHN0cmluZyBrZXkgd2FzIHNwZWNpZmllZCwgYnV0IG5vIHZhbHVlIHByb3ZpZGVkCiAgICAgIC8vCiAgICAgIC8vIFRha2UgdGhlICJyZWFkIiBwYXRoIGFuZCBhbGxvdyB0aGUgZ2V0IG1ldGhvZCB0byBkZXRlcm1pbmUKICAgICAgLy8gd2hpY2ggdmFsdWUgdG8gcmV0dXJuLCByZXNwZWN0aXZlbHkgZWl0aGVyOgogICAgICAvLwogICAgICAvLyAgIDEuIFRoZSBlbnRpcmUgY2FjaGUgb2JqZWN0CiAgICAgIC8vICAgMi4gVGhlIGRhdGEgc3RvcmVkIGF0IHRoZSBrZXkKICAgICAgLy8KICAgICAgaWYgKGtleSA9PT0gdW5kZWZpbmVkIHx8IGtleSAmJiB0eXBlb2Yga2V5ID09PSAnc3RyaW5nJyAmJiB2YWx1ZSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgc3RvcmVkID0gdGhpcy5nZXQob3duZXIsIGtleSk7CiAgICAgICAgcmV0dXJuIHN0b3JlZCAhPT0gdW5kZWZpbmVkID8gc3RvcmVkIDogdGhpcy5nZXQob3duZXIsIGpRdWVyeS5jYW1lbENhc2Uoa2V5KSk7CiAgICAgIH0KICAgICAgLy8gWypdV2hlbiB0aGUga2V5IGlzIG5vdCBhIHN0cmluZywgb3IgYm90aCBhIGtleSBhbmQgdmFsdWUKICAgICAgLy8gYXJlIHNwZWNpZmllZCwgc2V0IG9yIGV4dGVuZCAoZXhpc3Rpbmcgb2JqZWN0cykgd2l0aCBlaXRoZXI6CiAgICAgIC8vCiAgICAgIC8vICAgMS4gQW4gb2JqZWN0IG9mIHByb3BlcnRpZXMKICAgICAgLy8gICAyLiBBIGtleSBhbmQgdmFsdWUKICAgICAgLy8KICAgICAgdGhpcy5zZXQob3duZXIsIGtleSwgdmFsdWUpOwogICAgICAvLyBTaW5jZSB0aGUgInNldCIgcGF0aCBjYW4gaGF2ZSB0d28gcG9zc2libGUgZW50cnkgcG9pbnRzCiAgICAgIC8vIHJldHVybiB0aGUgZXhwZWN0ZWQgZGF0YSBiYXNlZCBvbiB3aGljaCBwYXRoIHdhcyB0YWtlblsqXQogICAgICByZXR1cm4gdmFsdWUgIT09IHVuZGVmaW5lZCA/IHZhbHVlIDoga2V5OwogICAgfSwKICAgIHJlbW92ZTogZnVuY3Rpb24gKG93bmVyLCBrZXkpIHsKICAgICAgdmFyIGksIG5hbWUsIGNhbWVsLCB1bmxvY2sgPSB0aGlzLmtleShvd25lciksIGNhY2hlID0gdGhpcy5jYWNoZVt1bmxvY2tdOwogICAgICBpZiAoa2V5ID09PSB1bmRlZmluZWQpIHsKICAgICAgICB0aGlzLmNhY2hlW3VubG9ja10gPSB7fTsKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBTdXBwb3J0IGFycmF5IG9yIHNwYWNlIHNlcGFyYXRlZCBzdHJpbmcgb2Yga2V5cwogICAgICAgIGlmIChqUXVlcnkuaXNBcnJheShrZXkpKSB7CiAgICAgICAgICAvLyBJZiAibmFtZSIgaXMgYW4gYXJyYXkgb2Yga2V5cy4uLgogICAgICAgICAgLy8gV2hlbiBkYXRhIGlzIGluaXRpYWxseSBjcmVhdGVkLCB2aWEgKCJrZXkiLCAidmFsIikgc2lnbmF0dXJlLAogICAgICAgICAgLy8ga2V5cyB3aWxsIGJlIGNvbnZlcnRlZCB0byBjYW1lbENhc2UuCiAgICAgICAgICAvLyBTaW5jZSB0aGVyZSBpcyBubyB3YXkgdG8gdGVsbCBfaG93XyBhIGtleSB3YXMgYWRkZWQsIHJlbW92ZQogICAgICAgICAgLy8gYm90aCBwbGFpbiBrZXkgYW5kIGNhbWVsQ2FzZSBrZXkuICMxMjc4NgogICAgICAgICAgLy8gVGhpcyB3aWxsIG9ubHkgcGVuYWxpemUgdGhlIGFycmF5IGFyZ3VtZW50IHBhdGguCiAgICAgICAgICBuYW1lID0ga2V5LmNvbmNhdChrZXkubWFwKGpRdWVyeS5jYW1lbENhc2UpKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY2FtZWwgPSBqUXVlcnkuY2FtZWxDYXNlKGtleSk7CiAgICAgICAgICAvLyBUcnkgdGhlIHN0cmluZyBhcyBhIGtleSBiZWZvcmUgYW55IG1hbmlwdWxhdGlvbgogICAgICAgICAgaWYgKGtleSBpbiBjYWNoZSkgewogICAgICAgICAgICBuYW1lID0gWwogICAgICAgICAgICAgIGtleSwKICAgICAgICAgICAgICBjYW1lbAogICAgICAgICAgICBdOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgLy8gSWYgYSBrZXkgd2l0aCB0aGUgc3BhY2VzIGV4aXN0cywgdXNlIGl0LgogICAgICAgICAgICAvLyBPdGhlcndpc2UsIGNyZWF0ZSBhbiBhcnJheSBieSBtYXRjaGluZyBub24td2hpdGVzcGFjZQogICAgICAgICAgICBuYW1lID0gY2FtZWw7CiAgICAgICAgICAgIG5hbWUgPSBuYW1lIGluIGNhY2hlID8gW25hbWVdIDogbmFtZS5tYXRjaChybm90d2hpdGUpIHx8IFtdOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpID0gbmFtZS5sZW5ndGg7CiAgICAgICAgd2hpbGUgKGktLSkgewogICAgICAgICAgZGVsZXRlIGNhY2hlW25hbWVbaV1dOwogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgIGhhc0RhdGE6IGZ1bmN0aW9uIChvd25lcikgewogICAgICByZXR1cm4gIWpRdWVyeS5pc0VtcHR5T2JqZWN0KHRoaXMuY2FjaGVbb3duZXJbdGhpcy5leHBhbmRvXV0gfHwge30pOwogICAgfSwKICAgIGRpc2NhcmQ6IGZ1bmN0aW9uIChvd25lcikgewogICAgICBpZiAob3duZXJbdGhpcy5leHBhbmRvXSkgewogICAgICAgIGRlbGV0ZSB0aGlzLmNhY2hlW293bmVyW3RoaXMuZXhwYW5kb11dOwogICAgICB9CiAgICB9CiAgfTsKICB2YXIgZGF0YV9wcml2ID0gbmV3IERhdGEoKTsKICB2YXIgZGF0YV91c2VyID0gbmV3IERhdGEoKTsKICAvKgogIAlJbXBsZW1lbnRhdGlvbiBTdW1tYXJ5CiAgCiAgCTEuIEVuZm9yY2UgQVBJIHN1cmZhY2UgYW5kIHNlbWFudGljIGNvbXBhdGliaWxpdHkgd2l0aCAxLjkueCBicmFuY2gKICAJMi4gSW1wcm92ZSB0aGUgbW9kdWxlJ3MgbWFpbnRhaW5hYmlsaXR5IGJ5IHJlZHVjaW5nIHRoZSBzdG9yYWdlCiAgCQlwYXRocyB0byBhIHNpbmdsZSBtZWNoYW5pc20uCiAgCTMuIFVzZSB0aGUgc2FtZSBzaW5nbGUgbWVjaGFuaXNtIHRvIHN1cHBvcnQgInByaXZhdGUiIGFuZCAidXNlciIgZGF0YS4KICAJNC4gX05ldmVyXyBleHBvc2UgInByaXZhdGUiIGRhdGEgdG8gdXNlciBjb2RlIChUT0RPOiBEcm9wIF9kYXRhLCBfcmVtb3ZlRGF0YSkKICAJNS4gQXZvaWQgZXhwb3NpbmcgaW1wbGVtZW50YXRpb24gZGV0YWlscyBvbiB1c2VyIG9iamVjdHMgKGVnLiBleHBhbmRvIHByb3BlcnRpZXMpCiAgCTYuIFByb3ZpZGUgYSBjbGVhciBwYXRoIGZvciBpbXBsZW1lbnRhdGlvbiB1cGdyYWRlIHRvIFdlYWtNYXAgaW4gMjAxNAogICovCiAgdmFyIHJicmFjZSA9IC9eKD86XHtbXHdcV10qXH18XFtbXHdcV10qXF0pJC8sIHJtdWx0aURhc2ggPSAvKFtBLVpdKS9nOwogIGZ1bmN0aW9uIGRhdGFBdHRyKGVsZW0sIGtleSwgZGF0YSkgewogICAgdmFyIG5hbWU7CiAgICAvLyBJZiBub3RoaW5nIHdhcyBmb3VuZCBpbnRlcm5hbGx5LCB0cnkgdG8gZmV0Y2ggYW55CiAgICAvLyBkYXRhIGZyb20gdGhlIEhUTUw1IGRhdGEtKiBhdHRyaWJ1dGUKICAgIGlmIChkYXRhID09PSB1bmRlZmluZWQgJiYgZWxlbS5ub2RlVHlwZSA9PT0gMSkgewogICAgICBuYW1lID0gJ2RhdGEtJyArIGtleS5yZXBsYWNlKHJtdWx0aURhc2gsICctJDEnKS50b0xvd2VyQ2FzZSgpOwogICAgICBkYXRhID0gZWxlbS5nZXRBdHRyaWJ1dGUobmFtZSk7CiAgICAgIGlmICh0eXBlb2YgZGF0YSA9PT0gJ3N0cmluZycpIHsKICAgICAgICB0cnkgewogICAgICAgICAgZGF0YSA9IGRhdGEgPT09ICd0cnVlJyA/IHRydWUgOiBkYXRhID09PSAnZmFsc2UnID8gZmFsc2UgOiBkYXRhID09PSAnbnVsbCcgPyBudWxsIDogLy8gT25seSBjb252ZXJ0IHRvIGEgbnVtYmVyIGlmIGl0IGRvZXNuJ3QgY2hhbmdlIHRoZSBzdHJpbmcKICAgICAgICAgICtkYXRhICsgJycgPT09IGRhdGEgPyArZGF0YSA6IHJicmFjZS50ZXN0KGRhdGEpID8galF1ZXJ5LnBhcnNlSlNPTihkYXRhKSA6IGRhdGE7CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgIH0KICAgICAgICAvLyBNYWtlIHN1cmUgd2Ugc2V0IHRoZSBkYXRhIHNvIGl0IGlzbid0IGNoYW5nZWQgbGF0ZXIKICAgICAgICBkYXRhX3VzZXIuc2V0KGVsZW0sIGtleSwgZGF0YSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZGF0YSA9IHVuZGVmaW5lZDsKICAgICAgfQogICAgfQogICAgcmV0dXJuIGRhdGE7CiAgfQogIGpRdWVyeS5leHRlbmQoewogICAgaGFzRGF0YTogZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgcmV0dXJuIGRhdGFfdXNlci5oYXNEYXRhKGVsZW0pIHx8IGRhdGFfcHJpdi5oYXNEYXRhKGVsZW0pOwogICAgfSwKICAgIGRhdGE6IGZ1bmN0aW9uIChlbGVtLCBuYW1lLCBkYXRhKSB7CiAgICAgIHJldHVybiBkYXRhX3VzZXIuYWNjZXNzKGVsZW0sIG5hbWUsIGRhdGEpOwogICAgfSwKICAgIHJlbW92ZURhdGE6IGZ1bmN0aW9uIChlbGVtLCBuYW1lKSB7CiAgICAgIGRhdGFfdXNlci5yZW1vdmUoZWxlbSwgbmFtZSk7CiAgICB9LAogICAgLy8gVE9ETzogTm93IHRoYXQgYWxsIGNhbGxzIHRvIF9kYXRhIGFuZCBfcmVtb3ZlRGF0YSBoYXZlIGJlZW4gcmVwbGFjZWQKICAgIC8vIHdpdGggZGlyZWN0IGNhbGxzIHRvIGRhdGFfcHJpdiBtZXRob2RzLCB0aGVzZSBjYW4gYmUgZGVwcmVjYXRlZC4KICAgIF9kYXRhOiBmdW5jdGlvbiAoZWxlbSwgbmFtZSwgZGF0YSkgewogICAgICByZXR1cm4gZGF0YV9wcml2LmFjY2VzcyhlbGVtLCBuYW1lLCBkYXRhKTsKICAgIH0sCiAgICBfcmVtb3ZlRGF0YTogZnVuY3Rpb24gKGVsZW0sIG5hbWUpIHsKICAgICAgZGF0YV9wcml2LnJlbW92ZShlbGVtLCBuYW1lKTsKICAgIH0KICB9KTsKICBqUXVlcnkuZm4uZXh0ZW5kKHsKICAgIGRhdGE6IGZ1bmN0aW9uIChrZXksIHZhbHVlKSB7CiAgICAgIHZhciBpLCBuYW1lLCBkYXRhLCBlbGVtID0gdGhpc1swXSwgYXR0cnMgPSBlbGVtICYmIGVsZW0uYXR0cmlidXRlczsKICAgICAgLy8gR2V0cyBhbGwgdmFsdWVzCiAgICAgIGlmIChrZXkgPT09IHVuZGVmaW5lZCkgewogICAgICAgIGlmICh0aGlzLmxlbmd0aCkgewogICAgICAgICAgZGF0YSA9IGRhdGFfdXNlci5nZXQoZWxlbSk7CiAgICAgICAgICBpZiAoZWxlbS5ub2RlVHlwZSA9PT0gMSAmJiAhZGF0YV9wcml2LmdldChlbGVtLCAnaGFzRGF0YUF0dHJzJykpIHsKICAgICAgICAgICAgaSA9IGF0dHJzLmxlbmd0aDsKICAgICAgICAgICAgd2hpbGUgKGktLSkgewogICAgICAgICAgICAgIC8vIFN1cHBvcnQ6IElFMTErCiAgICAgICAgICAgICAgLy8gVGhlIGF0dHJzIGVsZW1lbnRzIGNhbiBiZSBudWxsICgjMTQ4OTQpCiAgICAgICAgICAgICAgaWYgKGF0dHJzW2ldKSB7CiAgICAgICAgICAgICAgICBuYW1lID0gYXR0cnNbaV0ubmFtZTsKICAgICAgICAgICAgICAgIGlmIChuYW1lLmluZGV4T2YoJ2RhdGEtJykgPT09IDApIHsKICAgICAgICAgICAgICAgICAgbmFtZSA9IGpRdWVyeS5jYW1lbENhc2UobmFtZS5zbGljZSg1KSk7CiAgICAgICAgICAgICAgICAgIGRhdGFBdHRyKGVsZW0sIG5hbWUsIGRhdGFbbmFtZV0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBkYXRhX3ByaXYuc2V0KGVsZW0sICdoYXNEYXRhQXR0cnMnLCB0cnVlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIGRhdGE7CiAgICAgIH0KICAgICAgLy8gU2V0cyBtdWx0aXBsZSB2YWx1ZXMKICAgICAgaWYgKHR5cGVvZiBrZXkgPT09ICdvYmplY3QnKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICBkYXRhX3VzZXIuc2V0KHRoaXMsIGtleSk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgcmV0dXJuIGFjY2Vzcyh0aGlzLCBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICB2YXIgZGF0YSwgY2FtZWxLZXkgPSBqUXVlcnkuY2FtZWxDYXNlKGtleSk7CiAgICAgICAgLy8gVGhlIGNhbGxpbmcgalF1ZXJ5IG9iamVjdCAoZWxlbWVudCBtYXRjaGVzKSBpcyBub3QgZW1wdHkKICAgICAgICAvLyAoYW5kIHRoZXJlZm9yZSBoYXMgYW4gZWxlbWVudCBhcHBlYXJzIGF0IHRoaXNbIDAgXSkgYW5kIHRoZQogICAgICAgIC8vIGB2YWx1ZWAgcGFyYW1ldGVyIHdhcyBub3QgdW5kZWZpbmVkLiBBbiBlbXB0eSBqUXVlcnkgb2JqZWN0CiAgICAgICAgLy8gd2lsbCByZXN1bHQgaW4gYHVuZGVmaW5lZGAgZm9yIGVsZW0gPSB0aGlzWyAwIF0gd2hpY2ggd2lsbAogICAgICAgIC8vIHRocm93IGFuIGV4Y2VwdGlvbiBpZiBhbiBhdHRlbXB0IHRvIHJlYWQgYSBkYXRhIGNhY2hlIGlzIG1hZGUuCiAgICAgICAgaWYgKGVsZW0gJiYgdmFsdWUgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgLy8gQXR0ZW1wdCB0byBnZXQgZGF0YSBmcm9tIHRoZSBjYWNoZQogICAgICAgICAgLy8gd2l0aCB0aGUga2V5IGFzLWlzCiAgICAgICAgICBkYXRhID0gZGF0YV91c2VyLmdldChlbGVtLCBrZXkpOwogICAgICAgICAgaWYgKGRhdGEgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICByZXR1cm4gZGF0YTsKICAgICAgICAgIH0KICAgICAgICAgIC8vIEF0dGVtcHQgdG8gZ2V0IGRhdGEgZnJvbSB0aGUgY2FjaGUKICAgICAgICAgIC8vIHdpdGggdGhlIGtleSBjYW1lbGl6ZWQKICAgICAgICAgIGRhdGEgPSBkYXRhX3VzZXIuZ2V0KGVsZW0sIGNhbWVsS2V5KTsKICAgICAgICAgIGlmIChkYXRhICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgcmV0dXJuIGRhdGE7CiAgICAgICAgICB9CiAgICAgICAgICAvLyBBdHRlbXB0IHRvICJkaXNjb3ZlciIgdGhlIGRhdGEgaW4KICAgICAgICAgIC8vIEhUTUw1IGN1c3RvbSBkYXRhLSogYXR0cnMKICAgICAgICAgIGRhdGEgPSBkYXRhQXR0cihlbGVtLCBjYW1lbEtleSwgdW5kZWZpbmVkKTsKICAgICAgICAgIGlmIChkYXRhICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgcmV0dXJuIGRhdGE7CiAgICAgICAgICB9CiAgICAgICAgICAvLyBXZSB0cmllZCByZWFsbHkgaGFyZCwgYnV0IHRoZSBkYXRhIGRvZXNuJ3QgZXhpc3QuCiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIC8vIFNldCB0aGUgZGF0YS4uLgogICAgICAgIHRoaXMuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAvLyBGaXJzdCwgYXR0ZW1wdCB0byBzdG9yZSBhIGNvcHkgb3IgcmVmZXJlbmNlIG9mIGFueQogICAgICAgICAgLy8gZGF0YSB0aGF0IG1pZ2h0J3ZlIGJlZW4gc3RvcmUgd2l0aCBhIGNhbWVsQ2FzZWQga2V5LgogICAgICAgICAgdmFyIGRhdGEgPSBkYXRhX3VzZXIuZ2V0KHRoaXMsIGNhbWVsS2V5KTsKICAgICAgICAgIC8vIEZvciBIVE1MNSBkYXRhLSogYXR0cmlidXRlIGludGVyb3AsIHdlIGhhdmUgdG8KICAgICAgICAgIC8vIHN0b3JlIHByb3BlcnR5IG5hbWVzIHdpdGggZGFzaGVzIGluIGEgY2FtZWxDYXNlIGZvcm0uCiAgICAgICAgICAvLyBUaGlzIG1pZ2h0IG5vdCBhcHBseSB0byBhbGwgcHJvcGVydGllcy4uLioKICAgICAgICAgIGRhdGFfdXNlci5zZXQodGhpcywgY2FtZWxLZXksIHZhbHVlKTsKICAgICAgICAgIC8vICouLi4gSW4gdGhlIGNhc2Ugb2YgcHJvcGVydGllcyB0aGF0IG1pZ2h0IF9hY3R1YWxseV8KICAgICAgICAgIC8vIGhhdmUgZGFzaGVzLCB3ZSBuZWVkIHRvIGFsc28gc3RvcmUgYSBjb3B5IG9mIHRoYXQKICAgICAgICAgIC8vIHVuY2hhbmdlZCBwcm9wZXJ0eS4KICAgICAgICAgIGlmIChrZXkuaW5kZXhPZignLScpICE9PSAtMSAmJiBkYXRhICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgZGF0YV91c2VyLnNldCh0aGlzLCBrZXksIHZhbHVlKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfSwgbnVsbCwgdmFsdWUsIGFyZ3VtZW50cy5sZW5ndGggPiAxLCBudWxsLCB0cnVlKTsKICAgIH0sCiAgICByZW1vdmVEYXRhOiBmdW5jdGlvbiAoa2V5KSB7CiAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24gKCkgewogICAgICAgIGRhdGFfdXNlci5yZW1vdmUodGhpcywga2V5KTsKICAgICAgfSk7CiAgICB9CiAgfSk7CiAgalF1ZXJ5LmV4dGVuZCh7CiAgICBxdWV1ZTogZnVuY3Rpb24gKGVsZW0sIHR5cGUsIGRhdGEpIHsKICAgICAgdmFyIHF1ZXVlOwogICAgICBpZiAoZWxlbSkgewogICAgICAgIHR5cGUgPSAodHlwZSB8fCAnZngnKSArICdxdWV1ZSc7CiAgICAgICAgcXVldWUgPSBkYXRhX3ByaXYuZ2V0KGVsZW0sIHR5cGUpOwogICAgICAgIC8vIFNwZWVkIHVwIGRlcXVldWUgYnkgZ2V0dGluZyBvdXQgcXVpY2tseSBpZiB0aGlzIGlzIGp1c3QgYSBsb29rdXAKICAgICAgICBpZiAoZGF0YSkgewogICAgICAgICAgaWYgKCFxdWV1ZSB8fCBqUXVlcnkuaXNBcnJheShkYXRhKSkgewogICAgICAgICAgICBxdWV1ZSA9IGRhdGFfcHJpdi5hY2Nlc3MoZWxlbSwgdHlwZSwgalF1ZXJ5Lm1ha2VBcnJheShkYXRhKSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBxdWV1ZS5wdXNoKGRhdGEpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gcXVldWUgfHwgW107CiAgICAgIH0KICAgIH0sCiAgICBkZXF1ZXVlOiBmdW5jdGlvbiAoZWxlbSwgdHlwZSkgewogICAgICB0eXBlID0gdHlwZSB8fCAnZngnOwogICAgICB2YXIgcXVldWUgPSBqUXVlcnkucXVldWUoZWxlbSwgdHlwZSksIHN0YXJ0TGVuZ3RoID0gcXVldWUubGVuZ3RoLCBmbiA9IHF1ZXVlLnNoaWZ0KCksIGhvb2tzID0galF1ZXJ5Ll9xdWV1ZUhvb2tzKGVsZW0sIHR5cGUpLCBuZXh0ID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgalF1ZXJ5LmRlcXVldWUoZWxlbSwgdHlwZSk7CiAgICAgICAgfTsKICAgICAgLy8gSWYgdGhlIGZ4IHF1ZXVlIGlzIGRlcXVldWVkLCBhbHdheXMgcmVtb3ZlIHRoZSBwcm9ncmVzcyBzZW50aW5lbAogICAgICBpZiAoZm4gPT09ICdpbnByb2dyZXNzJykgewogICAgICAgIGZuID0gcXVldWUuc2hpZnQoKTsKICAgICAgICBzdGFydExlbmd0aC0tOwogICAgICB9CiAgICAgIGlmIChmbikgewogICAgICAgIC8vIEFkZCBhIHByb2dyZXNzIHNlbnRpbmVsIHRvIHByZXZlbnQgdGhlIGZ4IHF1ZXVlIGZyb20gYmVpbmcKICAgICAgICAvLyBhdXRvbWF0aWNhbGx5IGRlcXVldWVkCiAgICAgICAgaWYgKHR5cGUgPT09ICdmeCcpIHsKICAgICAgICAgIHF1ZXVlLnVuc2hpZnQoJ2lucHJvZ3Jlc3MnKTsKICAgICAgICB9CiAgICAgICAgLy8gY2xlYXIgdXAgdGhlIGxhc3QgcXVldWUgc3RvcCBmdW5jdGlvbgogICAgICAgIGRlbGV0ZSBob29rcy5zdG9wOwogICAgICAgIGZuLmNhbGwoZWxlbSwgbmV4dCwgaG9va3MpOwogICAgICB9CiAgICAgIGlmICghc3RhcnRMZW5ndGggJiYgaG9va3MpIHsKICAgICAgICBob29rcy5lbXB0eS5maXJlKCk7CiAgICAgIH0KICAgIH0sCiAgICAvLyBub3QgaW50ZW5kZWQgZm9yIHB1YmxpYyBjb25zdW1wdGlvbiAtIGdlbmVyYXRlcyBhIHF1ZXVlSG9va3Mgb2JqZWN0LCBvciByZXR1cm5zIHRoZSBjdXJyZW50IG9uZQogICAgX3F1ZXVlSG9va3M6IGZ1bmN0aW9uIChlbGVtLCB0eXBlKSB7CiAgICAgIHZhciBrZXkgPSB0eXBlICsgJ3F1ZXVlSG9va3MnOwogICAgICByZXR1cm4gZGF0YV9wcml2LmdldChlbGVtLCBrZXkpIHx8IGRhdGFfcHJpdi5hY2Nlc3MoZWxlbSwga2V5LCB7CiAgICAgICAgZW1wdHk6IGpRdWVyeS5DYWxsYmFja3MoJ29uY2UgbWVtb3J5JykuYWRkKGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGRhdGFfcHJpdi5yZW1vdmUoZWxlbSwgWwogICAgICAgICAgICB0eXBlICsgJ3F1ZXVlJywKICAgICAgICAgICAga2V5CiAgICAgICAgICBdKTsKICAgICAgICB9KQogICAgICB9KTsKICAgIH0KICB9KTsKICBqUXVlcnkuZm4uZXh0ZW5kKHsKICAgIHF1ZXVlOiBmdW5jdGlvbiAodHlwZSwgZGF0YSkgewogICAgICB2YXIgc2V0dGVyID0gMjsKICAgICAgaWYgKHR5cGVvZiB0eXBlICE9PSAnc3RyaW5nJykgewogICAgICAgIGRhdGEgPSB0eXBlOwogICAgICAgIHR5cGUgPSAnZngnOwogICAgICAgIHNldHRlci0tOwogICAgICB9CiAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoIDwgc2V0dGVyKSB7CiAgICAgICAgcmV0dXJuIGpRdWVyeS5xdWV1ZSh0aGlzWzBdLCB0eXBlKTsKICAgICAgfQogICAgICByZXR1cm4gZGF0YSA9PT0gdW5kZWZpbmVkID8gdGhpcyA6IHRoaXMuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIHF1ZXVlID0galF1ZXJ5LnF1ZXVlKHRoaXMsIHR5cGUsIGRhdGEpOwogICAgICAgIC8vIGVuc3VyZSBhIGhvb2tzIGZvciB0aGlzIHF1ZXVlCiAgICAgICAgalF1ZXJ5Ll9xdWV1ZUhvb2tzKHRoaXMsIHR5cGUpOwogICAgICAgIGlmICh0eXBlID09PSAnZngnICYmIHF1ZXVlWzBdICE9PSAnaW5wcm9ncmVzcycpIHsKICAgICAgICAgIGpRdWVyeS5kZXF1ZXVlKHRoaXMsIHR5cGUpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9LAogICAgZGVxdWV1ZTogZnVuY3Rpb24gKHR5cGUpIHsKICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgalF1ZXJ5LmRlcXVldWUodGhpcywgdHlwZSk7CiAgICAgIH0pOwogICAgfSwKICAgIGNsZWFyUXVldWU6IGZ1bmN0aW9uICh0eXBlKSB7CiAgICAgIHJldHVybiB0aGlzLnF1ZXVlKHR5cGUgfHwgJ2Z4JywgW10pOwogICAgfSwKICAgIC8vIEdldCBhIHByb21pc2UgcmVzb2x2ZWQgd2hlbiBxdWV1ZXMgb2YgYSBjZXJ0YWluIHR5cGUKICAgIC8vIGFyZSBlbXB0aWVkIChmeCBpcyB0aGUgdHlwZSBieSBkZWZhdWx0KQogICAgcHJvbWlzZTogZnVuY3Rpb24gKHR5cGUsIG9iaikgewogICAgICB2YXIgdG1wLCBjb3VudCA9IDEsIGRlZmVyID0galF1ZXJ5LkRlZmVycmVkKCksIGVsZW1lbnRzID0gdGhpcywgaSA9IHRoaXMubGVuZ3RoLCByZXNvbHZlID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgaWYgKCEtLWNvdW50KSB7CiAgICAgICAgICAgIGRlZmVyLnJlc29sdmVXaXRoKGVsZW1lbnRzLCBbZWxlbWVudHNdKTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICBpZiAodHlwZW9mIHR5cGUgIT09ICdzdHJpbmcnKSB7CiAgICAgICAgb2JqID0gdHlwZTsKICAgICAgICB0eXBlID0gdW5kZWZpbmVkOwogICAgICB9CiAgICAgIHR5cGUgPSB0eXBlIHx8ICdmeCc7CiAgICAgIHdoaWxlIChpLS0pIHsKICAgICAgICB0bXAgPSBkYXRhX3ByaXYuZ2V0KGVsZW1lbnRzW2ldLCB0eXBlICsgJ3F1ZXVlSG9va3MnKTsKICAgICAgICBpZiAodG1wICYmIHRtcC5lbXB0eSkgewogICAgICAgICAgY291bnQrKzsKICAgICAgICAgIHRtcC5lbXB0eS5hZGQocmVzb2x2ZSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJlc29sdmUoKTsKICAgICAgcmV0dXJuIGRlZmVyLnByb21pc2Uob2JqKTsKICAgIH0KICB9KTsKICB2YXIgcG51bSA9IC9bKy1dPyg/OlxkKlwufClcZCsoPzpbZUVdWystXT9cZCt8KS8uc291cmNlOwogIHZhciBjc3NFeHBhbmQgPSBbCiAgICAnVG9wJywKICAgICdSaWdodCcsCiAgICAnQm90dG9tJywKICAgICdMZWZ0JwogIF07CiAgdmFyIGlzSGlkZGVuID0gZnVuY3Rpb24gKGVsZW0sIGVsKSB7CiAgICAvLyBpc0hpZGRlbiBtaWdodCBiZSBjYWxsZWQgZnJvbSBqUXVlcnkjZmlsdGVyIGZ1bmN0aW9uOwogICAgLy8gaW4gdGhhdCBjYXNlLCBlbGVtZW50IHdpbGwgYmUgc2Vjb25kIGFyZ3VtZW50CiAgICBlbGVtID0gZWwgfHwgZWxlbTsKICAgIHJldHVybiBqUXVlcnkuY3NzKGVsZW0sICdkaXNwbGF5JykgPT09ICdub25lJyB8fCAhalF1ZXJ5LmNvbnRhaW5zKGVsZW0ub3duZXJEb2N1bWVudCwgZWxlbSk7CiAgfTsKICB2YXIgcmNoZWNrYWJsZVR5cGUgPSAvXig/OmNoZWNrYm94fHJhZGlvKSQvaTsKICAoZnVuY3Rpb24gKCkgewogICAgdmFyIGZyYWdtZW50ID0gZG9jdW1lbnQuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpLCBkaXYgPSBmcmFnbWVudC5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKSksIGlucHV0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnaW5wdXQnKTsKICAgIC8vICMxMTIxNyAtIFdlYktpdCBsb3NlcyBjaGVjayB3aGVuIHRoZSBuYW1lIGlzIGFmdGVyIHRoZSBjaGVja2VkIGF0dHJpYnV0ZQogICAgLy8gU3VwcG9ydDogV2luZG93cyBXZWIgQXBwcyAoV1dBKQogICAgLy8gYG5hbWVgIGFuZCBgdHlwZWAgbmVlZCAuc2V0QXR0cmlidXRlIGZvciBXV0EKICAgIGlucHV0LnNldEF0dHJpYnV0ZSgndHlwZScsICdyYWRpbycpOwogICAgaW5wdXQuc2V0QXR0cmlidXRlKCdjaGVja2VkJywgJ2NoZWNrZWQnKTsKICAgIGlucHV0LnNldEF0dHJpYnV0ZSgnbmFtZScsICd0Jyk7CiAgICBkaXYuYXBwZW5kQ2hpbGQoaW5wdXQpOwogICAgLy8gU3VwcG9ydDogU2FmYXJpIDUuMSwgaU9TIDUuMSwgQW5kcm9pZCA0LngsIEFuZHJvaWQgMi4zCiAgICAvLyBvbGQgV2ViS2l0IGRvZXNuJ3QgY2xvbmUgY2hlY2tlZCBzdGF0ZSBjb3JyZWN0bHkgaW4gZnJhZ21lbnRzCiAgICBzdXBwb3J0LmNoZWNrQ2xvbmUgPSBkaXYuY2xvbmVOb2RlKHRydWUpLmNsb25lTm9kZSh0cnVlKS5sYXN0Q2hpbGQuY2hlY2tlZDsKICAgIC8vIE1ha2Ugc3VyZSB0ZXh0YXJlYSAoYW5kIGNoZWNrYm94KSBkZWZhdWx0VmFsdWUgaXMgcHJvcGVybHkgY2xvbmVkCiAgICAvLyBTdXBwb3J0OiBJRTktSUUxMSsKICAgIGRpdi5pbm5lckhUTUwgPSAnPHRleHRhcmVhPng8L3RleHRhcmVhPic7CiAgICBzdXBwb3J0Lm5vQ2xvbmVDaGVja2VkID0gISFkaXYuY2xvbmVOb2RlKHRydWUpLmxhc3RDaGlsZC5kZWZhdWx0VmFsdWU7CiAgfSgpKTsKICB2YXIgc3RydW5kZWZpbmVkID0gdHlwZW9mIHVuZGVmaW5lZDsKICBzdXBwb3J0LmZvY3VzaW5CdWJibGVzID0gJ29uZm9jdXNpbicgaW4gd2luZG93OwogIHZhciBya2V5RXZlbnQgPSAvXmtleS8sIHJtb3VzZUV2ZW50ID0gL14oPzptb3VzZXxwb2ludGVyfGNvbnRleHRtZW51KXxjbGljay8sIHJmb2N1c01vcnBoID0gL14oPzpmb2N1c2luZm9jdXN8Zm9jdXNvdXRibHVyKSQvLCBydHlwZW5hbWVzcGFjZSA9IC9eKFteLl0qKSg/OlwuKC4rKXwpJC87CiAgZnVuY3Rpb24gcmV0dXJuVHJ1ZSgpIHsKICAgIHJldHVybiB0cnVlOwogIH0KICBmdW5jdGlvbiByZXR1cm5GYWxzZSgpIHsKICAgIHJldHVybiBmYWxzZTsKICB9CiAgZnVuY3Rpb24gc2FmZUFjdGl2ZUVsZW1lbnQoKSB7CiAgICB0cnkgewogICAgICByZXR1cm4gZG9jdW1lbnQuYWN0aXZlRWxlbWVudDsKICAgIH0gY2F0Y2ggKGVycikgewogICAgfQogIH0KICAvKgogICAqIEhlbHBlciBmdW5jdGlvbnMgZm9yIG1hbmFnaW5nIGV2ZW50cyAtLSBub3QgcGFydCBvZiB0aGUgcHVibGljIGludGVyZmFjZS4KICAgKiBQcm9wcyB0byBEZWFuIEVkd2FyZHMnIGFkZEV2ZW50IGxpYnJhcnkgZm9yIG1hbnkgb2YgdGhlIGlkZWFzLgogICAqLwogIGpRdWVyeS5ldmVudCA9IHsKICAgIGdsb2JhbDoge30sCiAgICBhZGQ6IGZ1bmN0aW9uIChlbGVtLCB0eXBlcywgaGFuZGxlciwgZGF0YSwgc2VsZWN0b3IpIHsKICAgICAgdmFyIGhhbmRsZU9iakluLCBldmVudEhhbmRsZSwgdG1wLCBldmVudHMsIHQsIGhhbmRsZU9iaiwgc3BlY2lhbCwgaGFuZGxlcnMsIHR5cGUsIG5hbWVzcGFjZXMsIG9yaWdUeXBlLCBlbGVtRGF0YSA9IGRhdGFfcHJpdi5nZXQoZWxlbSk7CiAgICAgIC8vIERvbid0IGF0dGFjaCBldmVudHMgdG8gbm9EYXRhIG9yIHRleHQvY29tbWVudCBub2RlcyAoYnV0IGFsbG93IHBsYWluIG9iamVjdHMpCiAgICAgIGlmICghZWxlbURhdGEpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgLy8gQ2FsbGVyIGNhbiBwYXNzIGluIGFuIG9iamVjdCBvZiBjdXN0b20gZGF0YSBpbiBsaWV1IG9mIHRoZSBoYW5kbGVyCiAgICAgIGlmIChoYW5kbGVyLmhhbmRsZXIpIHsKICAgICAgICBoYW5kbGVPYmpJbiA9IGhhbmRsZXI7CiAgICAgICAgaGFuZGxlciA9IGhhbmRsZU9iakluLmhhbmRsZXI7CiAgICAgICAgc2VsZWN0b3IgPSBoYW5kbGVPYmpJbi5zZWxlY3RvcjsKICAgICAgfQogICAgICAvLyBNYWtlIHN1cmUgdGhhdCB0aGUgaGFuZGxlciBoYXMgYSB1bmlxdWUgSUQsIHVzZWQgdG8gZmluZC9yZW1vdmUgaXQgbGF0ZXIKICAgICAgaWYgKCFoYW5kbGVyLmd1aWQpIHsKICAgICAgICBoYW5kbGVyLmd1aWQgPSBqUXVlcnkuZ3VpZCsrOwogICAgICB9CiAgICAgIC8vIEluaXQgdGhlIGVsZW1lbnQncyBldmVudCBzdHJ1Y3R1cmUgYW5kIG1haW4gaGFuZGxlciwgaWYgdGhpcyBpcyB0aGUgZmlyc3QKICAgICAgaWYgKCEoZXZlbnRzID0gZWxlbURhdGEuZXZlbnRzKSkgewogICAgICAgIGV2ZW50cyA9IGVsZW1EYXRhLmV2ZW50cyA9IHt9OwogICAgICB9CiAgICAgIGlmICghKGV2ZW50SGFuZGxlID0gZWxlbURhdGEuaGFuZGxlKSkgewogICAgICAgIGV2ZW50SGFuZGxlID0gZWxlbURhdGEuaGFuZGxlID0gZnVuY3Rpb24gKGUpIHsKICAgICAgICAgIC8vIERpc2NhcmQgdGhlIHNlY29uZCBldmVudCBvZiBhIGpRdWVyeS5ldmVudC50cmlnZ2VyKCkgYW5kCiAgICAgICAgICAvLyB3aGVuIGFuIGV2ZW50IGlzIGNhbGxlZCBhZnRlciBhIHBhZ2UgaGFzIHVubG9hZGVkCiAgICAgICAgICByZXR1cm4gdHlwZW9mIGpRdWVyeSAhPT0gc3RydW5kZWZpbmVkICYmIGpRdWVyeS5ldmVudC50cmlnZ2VyZWQgIT09IGUudHlwZSA/IGpRdWVyeS5ldmVudC5kaXNwYXRjaC5hcHBseShlbGVtLCBhcmd1bWVudHMpIDogdW5kZWZpbmVkOwogICAgICAgIH07CiAgICAgIH0KICAgICAgLy8gSGFuZGxlIG11bHRpcGxlIGV2ZW50cyBzZXBhcmF0ZWQgYnkgYSBzcGFjZQogICAgICB0eXBlcyA9ICh0eXBlcyB8fCAnJykubWF0Y2gocm5vdHdoaXRlKSB8fCBbJyddOwogICAgICB0ID0gdHlwZXMubGVuZ3RoOwogICAgICB3aGlsZSAodC0tKSB7CiAgICAgICAgdG1wID0gcnR5cGVuYW1lc3BhY2UuZXhlYyh0eXBlc1t0XSkgfHwgW107CiAgICAgICAgdHlwZSA9IG9yaWdUeXBlID0gdG1wWzFdOwogICAgICAgIG5hbWVzcGFjZXMgPSAodG1wWzJdIHx8ICcnKS5zcGxpdCgnLicpLnNvcnQoKTsKICAgICAgICAvLyBUaGVyZSAqbXVzdCogYmUgYSB0eXBlLCBubyBhdHRhY2hpbmcgbmFtZXNwYWNlLW9ubHkgaGFuZGxlcnMKICAgICAgICBpZiAoIXR5cGUpIHsKICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIH0KICAgICAgICAvLyBJZiBldmVudCBjaGFuZ2VzIGl0cyB0eXBlLCB1c2UgdGhlIHNwZWNpYWwgZXZlbnQgaGFuZGxlcnMgZm9yIHRoZSBjaGFuZ2VkIHR5cGUKICAgICAgICBzcGVjaWFsID0galF1ZXJ5LmV2ZW50LnNwZWNpYWxbdHlwZV0gfHwge307CiAgICAgICAgLy8gSWYgc2VsZWN0b3IgZGVmaW5lZCwgZGV0ZXJtaW5lIHNwZWNpYWwgZXZlbnQgYXBpIHR5cGUsIG90aGVyd2lzZSBnaXZlbiB0eXBlCiAgICAgICAgdHlwZSA9IChzZWxlY3RvciA/IHNwZWNpYWwuZGVsZWdhdGVUeXBlIDogc3BlY2lhbC5iaW5kVHlwZSkgfHwgdHlwZTsKICAgICAgICAvLyBVcGRhdGUgc3BlY2lhbCBiYXNlZCBvbiBuZXdseSByZXNldCB0eXBlCiAgICAgICAgc3BlY2lhbCA9IGpRdWVyeS5ldmVudC5zcGVjaWFsW3R5cGVdIHx8IHt9OwogICAgICAgIC8vIGhhbmRsZU9iaiBpcyBwYXNzZWQgdG8gYWxsIGV2ZW50IGhhbmRsZXJzCiAgICAgICAgaGFuZGxlT2JqID0galF1ZXJ5LmV4dGVuZCh7CiAgICAgICAgICB0eXBlOiB0eXBlLAogICAgICAgICAgb3JpZ1R5cGU6IG9yaWdUeXBlLAogICAgICAgICAgZGF0YTogZGF0YSwKICAgICAgICAgIGhhbmRsZXI6IGhhbmRsZXIsCiAgICAgICAgICBndWlkOiBoYW5kbGVyLmd1aWQsCiAgICAgICAgICBzZWxlY3Rvcjogc2VsZWN0b3IsCiAgICAgICAgICBuZWVkc0NvbnRleHQ6IHNlbGVjdG9yICYmIGpRdWVyeS5leHByLm1hdGNoLm5lZWRzQ29udGV4dC50ZXN0KHNlbGVjdG9yKSwKICAgICAgICAgIG5hbWVzcGFjZTogbmFtZXNwYWNlcy5qb2luKCcuJykKICAgICAgICB9LCBoYW5kbGVPYmpJbik7CiAgICAgICAgLy8gSW5pdCB0aGUgZXZlbnQgaGFuZGxlciBxdWV1ZSBpZiB3ZSdyZSB0aGUgZmlyc3QKICAgICAgICBpZiAoIShoYW5kbGVycyA9IGV2ZW50c1t0eXBlXSkpIHsKICAgICAgICAgIGhhbmRsZXJzID0gZXZlbnRzW3R5cGVdID0gW107CiAgICAgICAgICBoYW5kbGVycy5kZWxlZ2F0ZUNvdW50ID0gMDsKICAgICAgICAgIC8vIE9ubHkgdXNlIGFkZEV2ZW50TGlzdGVuZXIgaWYgdGhlIHNwZWNpYWwgZXZlbnRzIGhhbmRsZXIgcmV0dXJucyBmYWxzZQogICAgICAgICAgaWYgKCFzcGVjaWFsLnNldHVwIHx8IHNwZWNpYWwuc2V0dXAuY2FsbChlbGVtLCBkYXRhLCBuYW1lc3BhY2VzLCBldmVudEhhbmRsZSkgPT09IGZhbHNlKSB7CiAgICAgICAgICAgIGlmIChlbGVtLmFkZEV2ZW50TGlzdGVuZXIpIHsKICAgICAgICAgICAgICBlbGVtLmFkZEV2ZW50TGlzdGVuZXIodHlwZSwgZXZlbnRIYW5kbGUsIGZhbHNlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoc3BlY2lhbC5hZGQpIHsKICAgICAgICAgIHNwZWNpYWwuYWRkLmNhbGwoZWxlbSwgaGFuZGxlT2JqKTsKICAgICAgICAgIGlmICghaGFuZGxlT2JqLmhhbmRsZXIuZ3VpZCkgewogICAgICAgICAgICBoYW5kbGVPYmouaGFuZGxlci5ndWlkID0gaGFuZGxlci5ndWlkOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAvLyBBZGQgdG8gdGhlIGVsZW1lbnQncyBoYW5kbGVyIGxpc3QsIGRlbGVnYXRlcyBpbiBmcm9udAogICAgICAgIGlmIChzZWxlY3RvcikgewogICAgICAgICAgaGFuZGxlcnMuc3BsaWNlKGhhbmRsZXJzLmRlbGVnYXRlQ291bnQrKywgMCwgaGFuZGxlT2JqKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgaGFuZGxlcnMucHVzaChoYW5kbGVPYmopOwogICAgICAgIH0KICAgICAgICAvLyBLZWVwIHRyYWNrIG9mIHdoaWNoIGV2ZW50cyBoYXZlIGV2ZXIgYmVlbiB1c2VkLCBmb3IgZXZlbnQgb3B0aW1pemF0aW9uCiAgICAgICAgalF1ZXJ5LmV2ZW50Lmdsb2JhbFt0eXBlXSA9IHRydWU7CiAgICAgIH0KICAgIH0sCiAgICAvLyBEZXRhY2ggYW4gZXZlbnQgb3Igc2V0IG9mIGV2ZW50cyBmcm9tIGFuIGVsZW1lbnQKICAgIHJlbW92ZTogZnVuY3Rpb24gKGVsZW0sIHR5cGVzLCBoYW5kbGVyLCBzZWxlY3RvciwgbWFwcGVkVHlwZXMpIHsKICAgICAgdmFyIGosIG9yaWdDb3VudCwgdG1wLCBldmVudHMsIHQsIGhhbmRsZU9iaiwgc3BlY2lhbCwgaGFuZGxlcnMsIHR5cGUsIG5hbWVzcGFjZXMsIG9yaWdUeXBlLCBlbGVtRGF0YSA9IGRhdGFfcHJpdi5oYXNEYXRhKGVsZW0pICYmIGRhdGFfcHJpdi5nZXQoZWxlbSk7CiAgICAgIGlmICghZWxlbURhdGEgfHwgIShldmVudHMgPSBlbGVtRGF0YS5ldmVudHMpKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIC8vIE9uY2UgZm9yIGVhY2ggdHlwZS5uYW1lc3BhY2UgaW4gdHlwZXM7IHR5cGUgbWF5IGJlIG9taXR0ZWQKICAgICAgdHlwZXMgPSAodHlwZXMgfHwgJycpLm1hdGNoKHJub3R3aGl0ZSkgfHwgWycnXTsKICAgICAgdCA9IHR5cGVzLmxlbmd0aDsKICAgICAgd2hpbGUgKHQtLSkgewogICAgICAgIHRtcCA9IHJ0eXBlbmFtZXNwYWNlLmV4ZWModHlwZXNbdF0pIHx8IFtdOwogICAgICAgIHR5cGUgPSBvcmlnVHlwZSA9IHRtcFsxXTsKICAgICAgICBuYW1lc3BhY2VzID0gKHRtcFsyXSB8fCAnJykuc3BsaXQoJy4nKS5zb3J0KCk7CiAgICAgICAgLy8gVW5iaW5kIGFsbCBldmVudHMgKG9uIHRoaXMgbmFtZXNwYWNlLCBpZiBwcm92aWRlZCkgZm9yIHRoZSBlbGVtZW50CiAgICAgICAgaWYgKCF0eXBlKSB7CiAgICAgICAgICBmb3IgKHR5cGUgaW4gZXZlbnRzKSB7CiAgICAgICAgICAgIGpRdWVyeS5ldmVudC5yZW1vdmUoZWxlbSwgdHlwZSArIHR5cGVzW3RdLCBoYW5kbGVyLCBzZWxlY3RvciwgdHJ1ZSk7CiAgICAgICAgICB9CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CiAgICAgICAgc3BlY2lhbCA9IGpRdWVyeS5ldmVudC5zcGVjaWFsW3R5cGVdIHx8IHt9OwogICAgICAgIHR5cGUgPSAoc2VsZWN0b3IgPyBzcGVjaWFsLmRlbGVnYXRlVHlwZSA6IHNwZWNpYWwuYmluZFR5cGUpIHx8IHR5cGU7CiAgICAgICAgaGFuZGxlcnMgPSBldmVudHNbdHlwZV0gfHwgW107CiAgICAgICAgdG1wID0gdG1wWzJdICYmIG5ldyBSZWdFeHAoJyhefFxcLiknICsgbmFtZXNwYWNlcy5qb2luKCdcXC4oPzouKlxcLnwpJykgKyAnKFxcLnwkKScpOwogICAgICAgIC8vIFJlbW92ZSBtYXRjaGluZyBldmVudHMKICAgICAgICBvcmlnQ291bnQgPSBqID0gaGFuZGxlcnMubGVuZ3RoOwogICAgICAgIHdoaWxlIChqLS0pIHsKICAgICAgICAgIGhhbmRsZU9iaiA9IGhhbmRsZXJzW2pdOwogICAgICAgICAgaWYgKChtYXBwZWRUeXBlcyB8fCBvcmlnVHlwZSA9PT0gaGFuZGxlT2JqLm9yaWdUeXBlKSAmJiAoIWhhbmRsZXIgfHwgaGFuZGxlci5ndWlkID09PSBoYW5kbGVPYmouZ3VpZCkgJiYgKCF0bXAgfHwgdG1wLnRlc3QoaGFuZGxlT2JqLm5hbWVzcGFjZSkpICYmICghc2VsZWN0b3IgfHwgc2VsZWN0b3IgPT09IGhhbmRsZU9iai5zZWxlY3RvciB8fCBzZWxlY3RvciA9PT0gJyoqJyAmJiBoYW5kbGVPYmouc2VsZWN0b3IpKSB7CiAgICAgICAgICAgIGhhbmRsZXJzLnNwbGljZShqLCAxKTsKICAgICAgICAgICAgaWYgKGhhbmRsZU9iai5zZWxlY3RvcikgewogICAgICAgICAgICAgIGhhbmRsZXJzLmRlbGVnYXRlQ291bnQtLTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoc3BlY2lhbC5yZW1vdmUpIHsKICAgICAgICAgICAgICBzcGVjaWFsLnJlbW92ZS5jYWxsKGVsZW0sIGhhbmRsZU9iaik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgLy8gUmVtb3ZlIGdlbmVyaWMgZXZlbnQgaGFuZGxlciBpZiB3ZSByZW1vdmVkIHNvbWV0aGluZyBhbmQgbm8gbW9yZSBoYW5kbGVycyBleGlzdAogICAgICAgIC8vIChhdm9pZHMgcG90ZW50aWFsIGZvciBlbmRsZXNzIHJlY3Vyc2lvbiBkdXJpbmcgcmVtb3ZhbCBvZiBzcGVjaWFsIGV2ZW50IGhhbmRsZXJzKQogICAgICAgIGlmIChvcmlnQ291bnQgJiYgIWhhbmRsZXJzLmxlbmd0aCkgewogICAgICAgICAgaWYgKCFzcGVjaWFsLnRlYXJkb3duIHx8IHNwZWNpYWwudGVhcmRvd24uY2FsbChlbGVtLCBuYW1lc3BhY2VzLCBlbGVtRGF0YS5oYW5kbGUpID09PSBmYWxzZSkgewogICAgICAgICAgICBqUXVlcnkucmVtb3ZlRXZlbnQoZWxlbSwgdHlwZSwgZWxlbURhdGEuaGFuZGxlKTsKICAgICAgICAgIH0KICAgICAgICAgIGRlbGV0ZSBldmVudHNbdHlwZV07CiAgICAgICAgfQogICAgICB9CiAgICAgIC8vIFJlbW92ZSB0aGUgZXhwYW5kbyBpZiBpdCdzIG5vIGxvbmdlciB1c2VkCiAgICAgIGlmIChqUXVlcnkuaXNFbXB0eU9iamVjdChldmVudHMpKSB7CiAgICAgICAgZGVsZXRlIGVsZW1EYXRhLmhhbmRsZTsKICAgICAgICBkYXRhX3ByaXYucmVtb3ZlKGVsZW0sICdldmVudHMnKTsKICAgICAgfQogICAgfSwKICAgIHRyaWdnZXI6IGZ1bmN0aW9uIChldmVudCwgZGF0YSwgZWxlbSwgb25seUhhbmRsZXJzKSB7CiAgICAgIHZhciBpLCBjdXIsIHRtcCwgYnViYmxlVHlwZSwgb250eXBlLCBoYW5kbGUsIHNwZWNpYWwsIGV2ZW50UGF0aCA9IFtlbGVtIHx8IGRvY3VtZW50XSwgdHlwZSA9IGhhc093bi5jYWxsKGV2ZW50LCAndHlwZScpID8gZXZlbnQudHlwZSA6IGV2ZW50LCBuYW1lc3BhY2VzID0gaGFzT3duLmNhbGwoZXZlbnQsICduYW1lc3BhY2UnKSA/IGV2ZW50Lm5hbWVzcGFjZS5zcGxpdCgnLicpIDogW107CiAgICAgIGN1ciA9IHRtcCA9IGVsZW0gPSBlbGVtIHx8IGRvY3VtZW50OwogICAgICAvLyBEb24ndCBkbyBldmVudHMgb24gdGV4dCBhbmQgY29tbWVudCBub2RlcwogICAgICBpZiAoZWxlbS5ub2RlVHlwZSA9PT0gMyB8fCBlbGVtLm5vZGVUeXBlID09PSA4KSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIC8vIGZvY3VzL2JsdXIgbW9ycGhzIHRvIGZvY3VzaW4vb3V0OyBlbnN1cmUgd2UncmUgbm90IGZpcmluZyB0aGVtIHJpZ2h0IG5vdwogICAgICBpZiAocmZvY3VzTW9ycGgudGVzdCh0eXBlICsgalF1ZXJ5LmV2ZW50LnRyaWdnZXJlZCkpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgaWYgKHR5cGUuaW5kZXhPZignLicpID49IDApIHsKICAgICAgICAvLyBOYW1lc3BhY2VkIHRyaWdnZXI7IGNyZWF0ZSBhIHJlZ2V4cCB0byBtYXRjaCBldmVudCB0eXBlIGluIGhhbmRsZSgpCiAgICAgICAgbmFtZXNwYWNlcyA9IHR5cGUuc3BsaXQoJy4nKTsKICAgICAgICB0eXBlID0gbmFtZXNwYWNlcy5zaGlmdCgpOwogICAgICAgIG5hbWVzcGFjZXMuc29ydCgpOwogICAgICB9CiAgICAgIG9udHlwZSA9IHR5cGUuaW5kZXhPZignOicpIDwgMCAmJiAnb24nICsgdHlwZTsKICAgICAgLy8gQ2FsbGVyIGNhbiBwYXNzIGluIGEgalF1ZXJ5LkV2ZW50IG9iamVjdCwgT2JqZWN0LCBvciBqdXN0IGFuIGV2ZW50IHR5cGUgc3RyaW5nCiAgICAgIGV2ZW50ID0gZXZlbnRbalF1ZXJ5LmV4cGFuZG9dID8gZXZlbnQgOiBuZXcgalF1ZXJ5LkV2ZW50KHR5cGUsIHR5cGVvZiBldmVudCA9PT0gJ29iamVjdCcgJiYgZXZlbnQpOwogICAgICAvLyBUcmlnZ2VyIGJpdG1hc2s6ICYgMSBmb3IgbmF0aXZlIGhhbmRsZXJzOyAmIDIgZm9yIGpRdWVyeSAoYWx3YXlzIHRydWUpCiAgICAgIGV2ZW50LmlzVHJpZ2dlciA9IG9ubHlIYW5kbGVycyA/IDIgOiAzOwogICAgICBldmVudC5uYW1lc3BhY2UgPSBuYW1lc3BhY2VzLmpvaW4oJy4nKTsKICAgICAgZXZlbnQubmFtZXNwYWNlX3JlID0gZXZlbnQubmFtZXNwYWNlID8gbmV3IFJlZ0V4cCgnKF58XFwuKScgKyBuYW1lc3BhY2VzLmpvaW4oJ1xcLig/Oi4qXFwufCknKSArICcoXFwufCQpJykgOiBudWxsOwogICAgICAvLyBDbGVhbiB1cCB0aGUgZXZlbnQgaW4gY2FzZSBpdCBpcyBiZWluZyByZXVzZWQKICAgICAgZXZlbnQucmVzdWx0ID0gdW5kZWZpbmVkOwogICAgICBpZiAoIWV2ZW50LnRhcmdldCkgewogICAgICAgIGV2ZW50LnRhcmdldCA9IGVsZW07CiAgICAgIH0KICAgICAgLy8gQ2xvbmUgYW55IGluY29taW5nIGRhdGEgYW5kIHByZXBlbmQgdGhlIGV2ZW50LCBjcmVhdGluZyB0aGUgaGFuZGxlciBhcmcgbGlzdAogICAgICBkYXRhID0gZGF0YSA9PSBudWxsID8gW2V2ZW50XSA6IGpRdWVyeS5tYWtlQXJyYXkoZGF0YSwgW2V2ZW50XSk7CiAgICAgIC8vIEFsbG93IHNwZWNpYWwgZXZlbnRzIHRvIGRyYXcgb3V0c2lkZSB0aGUgbGluZXMKICAgICAgc3BlY2lhbCA9IGpRdWVyeS5ldmVudC5zcGVjaWFsW3R5cGVdIHx8IHt9OwogICAgICBpZiAoIW9ubHlIYW5kbGVycyAmJiBzcGVjaWFsLnRyaWdnZXIgJiYgc3BlY2lhbC50cmlnZ2VyLmFwcGx5KGVsZW0sIGRhdGEpID09PSBmYWxzZSkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICAvLyBEZXRlcm1pbmUgZXZlbnQgcHJvcGFnYXRpb24gcGF0aCBpbiBhZHZhbmNlLCBwZXIgVzNDIGV2ZW50cyBzcGVjICgjOTk1MSkKICAgICAgLy8gQnViYmxlIHVwIHRvIGRvY3VtZW50LCB0aGVuIHRvIHdpbmRvdzsgd2F0Y2ggZm9yIGEgZ2xvYmFsIG93bmVyRG9jdW1lbnQgdmFyICgjOTcyNCkKICAgICAgaWYgKCFvbmx5SGFuZGxlcnMgJiYgIXNwZWNpYWwubm9CdWJibGUgJiYgIWpRdWVyeS5pc1dpbmRvdyhlbGVtKSkgewogICAgICAgIGJ1YmJsZVR5cGUgPSBzcGVjaWFsLmRlbGVnYXRlVHlwZSB8fCB0eXBlOwogICAgICAgIGlmICghcmZvY3VzTW9ycGgudGVzdChidWJibGVUeXBlICsgdHlwZSkpIHsKICAgICAgICAgIGN1ciA9IGN1ci5wYXJlbnROb2RlOwogICAgICAgIH0KICAgICAgICBmb3IgKDsgY3VyOyBjdXIgPSBjdXIucGFyZW50Tm9kZSkgewogICAgICAgICAgZXZlbnRQYXRoLnB1c2goY3VyKTsKICAgICAgICAgIHRtcCA9IGN1cjsKICAgICAgICB9CiAgICAgICAgLy8gT25seSBhZGQgd2luZG93IGlmIHdlIGdvdCB0byBkb2N1bWVudCAoZS5nLiwgbm90IHBsYWluIG9iaiBvciBkZXRhY2hlZCBET00pCiAgICAgICAgaWYgKHRtcCA9PT0gKGVsZW0ub3duZXJEb2N1bWVudCB8fCBkb2N1bWVudCkpIHsKICAgICAgICAgIGV2ZW50UGF0aC5wdXNoKHRtcC5kZWZhdWx0VmlldyB8fCB0bXAucGFyZW50V2luZG93IHx8IHdpbmRvdyk7CiAgICAgICAgfQogICAgICB9CiAgICAgIC8vIEZpcmUgaGFuZGxlcnMgb24gdGhlIGV2ZW50IHBhdGgKICAgICAgaSA9IDA7CiAgICAgIHdoaWxlICgoY3VyID0gZXZlbnRQYXRoW2krK10pICYmICFldmVudC5pc1Byb3BhZ2F0aW9uU3RvcHBlZCgpKSB7CiAgICAgICAgZXZlbnQudHlwZSA9IGkgPiAxID8gYnViYmxlVHlwZSA6IHNwZWNpYWwuYmluZFR5cGUgfHwgdHlwZTsKICAgICAgICAvLyBqUXVlcnkgaGFuZGxlcgogICAgICAgIGhhbmRsZSA9IChkYXRhX3ByaXYuZ2V0KGN1ciwgJ2V2ZW50cycpIHx8IHt9KVtldmVudC50eXBlXSAmJiBkYXRhX3ByaXYuZ2V0KGN1ciwgJ2hhbmRsZScpOwogICAgICAgIGlmIChoYW5kbGUpIHsKICAgICAgICAgIGhhbmRsZS5hcHBseShjdXIsIGRhdGEpOwogICAgICAgIH0KICAgICAgICAvLyBOYXRpdmUgaGFuZGxlcgogICAgICAgIGhhbmRsZSA9IG9udHlwZSAmJiBjdXJbb250eXBlXTsKICAgICAgICBpZiAoaGFuZGxlICYmIGhhbmRsZS5hcHBseSAmJiBqUXVlcnkuYWNjZXB0RGF0YShjdXIpKSB7CiAgICAgICAgICBldmVudC5yZXN1bHQgPSBoYW5kbGUuYXBwbHkoY3VyLCBkYXRhKTsKICAgICAgICAgIGlmIChldmVudC5yZXN1bHQgPT09IGZhbHNlKSB7CiAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIGV2ZW50LnR5cGUgPSB0eXBlOwogICAgICAvLyBJZiBub2JvZHkgcHJldmVudGVkIHRoZSBkZWZhdWx0IGFjdGlvbiwgZG8gaXQgbm93CiAgICAgIGlmICghb25seUhhbmRsZXJzICYmICFldmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSkgewogICAgICAgIGlmICgoIXNwZWNpYWwuX2RlZmF1bHQgfHwgc3BlY2lhbC5fZGVmYXVsdC5hcHBseShldmVudFBhdGgucG9wKCksIGRhdGEpID09PSBmYWxzZSkgJiYgalF1ZXJ5LmFjY2VwdERhdGEoZWxlbSkpIHsKICAgICAgICAgIC8vIENhbGwgYSBuYXRpdmUgRE9NIG1ldGhvZCBvbiB0aGUgdGFyZ2V0IHdpdGggdGhlIHNhbWUgbmFtZSBuYW1lIGFzIHRoZSBldmVudC4KICAgICAgICAgIC8vIERvbid0IGRvIGRlZmF1bHQgYWN0aW9ucyBvbiB3aW5kb3csIHRoYXQncyB3aGVyZSBnbG9iYWwgdmFyaWFibGVzIGJlICgjNjE3MCkKICAgICAgICAgIGlmIChvbnR5cGUgJiYgalF1ZXJ5LmlzRnVuY3Rpb24oZWxlbVt0eXBlXSkgJiYgIWpRdWVyeS5pc1dpbmRvdyhlbGVtKSkgewogICAgICAgICAgICAvLyBEb24ndCByZS10cmlnZ2VyIGFuIG9uRk9PIGV2ZW50IHdoZW4gd2UgY2FsbCBpdHMgRk9PKCkgbWV0aG9kCiAgICAgICAgICAgIHRtcCA9IGVsZW1bb250eXBlXTsKICAgICAgICAgICAgaWYgKHRtcCkgewogICAgICAgICAgICAgIGVsZW1bb250eXBlXSA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gUHJldmVudCByZS10cmlnZ2VyaW5nIG9mIHRoZSBzYW1lIGV2ZW50LCBzaW5jZSB3ZSBhbHJlYWR5IGJ1YmJsZWQgaXQgYWJvdmUKICAgICAgICAgICAgalF1ZXJ5LmV2ZW50LnRyaWdnZXJlZCA9IHR5cGU7CiAgICAgICAgICAgIGVsZW1bdHlwZV0oKTsKICAgICAgICAgICAgalF1ZXJ5LmV2ZW50LnRyaWdnZXJlZCA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgaWYgKHRtcCkgewogICAgICAgICAgICAgIGVsZW1bb250eXBlXSA9IHRtcDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gZXZlbnQucmVzdWx0OwogICAgfSwKICAgIGRpc3BhdGNoOiBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgLy8gTWFrZSBhIHdyaXRhYmxlIGpRdWVyeS5FdmVudCBmcm9tIHRoZSBuYXRpdmUgZXZlbnQgb2JqZWN0CiAgICAgIGV2ZW50ID0galF1ZXJ5LmV2ZW50LmZpeChldmVudCk7CiAgICAgIHZhciBpLCBqLCByZXQsIG1hdGNoZWQsIGhhbmRsZU9iaiwgaGFuZGxlclF1ZXVlID0gW10sIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cyksIGhhbmRsZXJzID0gKGRhdGFfcHJpdi5nZXQodGhpcywgJ2V2ZW50cycpIHx8IHt9KVtldmVudC50eXBlXSB8fCBbXSwgc3BlY2lhbCA9IGpRdWVyeS5ldmVudC5zcGVjaWFsW2V2ZW50LnR5cGVdIHx8IHt9OwogICAgICAvLyBVc2UgdGhlIGZpeC1lZCBqUXVlcnkuRXZlbnQgcmF0aGVyIHRoYW4gdGhlIChyZWFkLW9ubHkpIG5hdGl2ZSBldmVudAogICAgICBhcmdzWzBdID0gZXZlbnQ7CiAgICAgIGV2ZW50LmRlbGVnYXRlVGFyZ2V0ID0gdGhpczsKICAgICAgLy8gQ2FsbCB0aGUgcHJlRGlzcGF0Y2ggaG9vayBmb3IgdGhlIG1hcHBlZCB0eXBlLCBhbmQgbGV0IGl0IGJhaWwgaWYgZGVzaXJlZAogICAgICBpZiAoc3BlY2lhbC5wcmVEaXNwYXRjaCAmJiBzcGVjaWFsLnByZURpc3BhdGNoLmNhbGwodGhpcywgZXZlbnQpID09PSBmYWxzZSkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICAvLyBEZXRlcm1pbmUgaGFuZGxlcnMKICAgICAgaGFuZGxlclF1ZXVlID0galF1ZXJ5LmV2ZW50LmhhbmRsZXJzLmNhbGwodGhpcywgZXZlbnQsIGhhbmRsZXJzKTsKICAgICAgLy8gUnVuIGRlbGVnYXRlcyBmaXJzdDsgdGhleSBtYXkgd2FudCB0byBzdG9wIHByb3BhZ2F0aW9uIGJlbmVhdGggdXMKICAgICAgaSA9IDA7CiAgICAgIHdoaWxlICgobWF0Y2hlZCA9IGhhbmRsZXJRdWV1ZVtpKytdKSAmJiAhZXZlbnQuaXNQcm9wYWdhdGlvblN0b3BwZWQoKSkgewogICAgICAgIGV2ZW50LmN1cnJlbnRUYXJnZXQgPSBtYXRjaGVkLmVsZW07CiAgICAgICAgaiA9IDA7CiAgICAgICAgd2hpbGUgKChoYW5kbGVPYmogPSBtYXRjaGVkLmhhbmRsZXJzW2orK10pICYmICFldmVudC5pc0ltbWVkaWF0ZVByb3BhZ2F0aW9uU3RvcHBlZCgpKSB7CiAgICAgICAgICAvLyBUcmlnZ2VyZWQgZXZlbnQgbXVzdCBlaXRoZXIgMSkgaGF2ZSBubyBuYW1lc3BhY2UsIG9yCiAgICAgICAgICAvLyAyKSBoYXZlIG5hbWVzcGFjZShzKSBhIHN1YnNldCBvciBlcXVhbCB0byB0aG9zZSBpbiB0aGUgYm91bmQgZXZlbnQgKGJvdGggY2FuIGhhdmUgbm8gbmFtZXNwYWNlKS4KICAgICAgICAgIGlmICghZXZlbnQubmFtZXNwYWNlX3JlIHx8IGV2ZW50Lm5hbWVzcGFjZV9yZS50ZXN0KGhhbmRsZU9iai5uYW1lc3BhY2UpKSB7CiAgICAgICAgICAgIGV2ZW50LmhhbmRsZU9iaiA9IGhhbmRsZU9iajsKICAgICAgICAgICAgZXZlbnQuZGF0YSA9IGhhbmRsZU9iai5kYXRhOwogICAgICAgICAgICByZXQgPSAoKGpRdWVyeS5ldmVudC5zcGVjaWFsW2hhbmRsZU9iai5vcmlnVHlwZV0gfHwge30pLmhhbmRsZSB8fCBoYW5kbGVPYmouaGFuZGxlcikuYXBwbHkobWF0Y2hlZC5lbGVtLCBhcmdzKTsKICAgICAgICAgICAgaWYgKHJldCAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgaWYgKChldmVudC5yZXN1bHQgPSByZXQpID09PSBmYWxzZSkgewogICAgICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICAvLyBDYWxsIHRoZSBwb3N0RGlzcGF0Y2ggaG9vayBmb3IgdGhlIG1hcHBlZCB0eXBlCiAgICAgIGlmIChzcGVjaWFsLnBvc3REaXNwYXRjaCkgewogICAgICAgIHNwZWNpYWwucG9zdERpc3BhdGNoLmNhbGwodGhpcywgZXZlbnQpOwogICAgICB9CiAgICAgIHJldHVybiBldmVudC5yZXN1bHQ7CiAgICB9LAogICAgaGFuZGxlcnM6IGZ1bmN0aW9uIChldmVudCwgaGFuZGxlcnMpIHsKICAgICAgdmFyIGksIG1hdGNoZXMsIHNlbCwgaGFuZGxlT2JqLCBoYW5kbGVyUXVldWUgPSBbXSwgZGVsZWdhdGVDb3VudCA9IGhhbmRsZXJzLmRlbGVnYXRlQ291bnQsIGN1ciA9IGV2ZW50LnRhcmdldDsKICAgICAgLy8gRmluZCBkZWxlZ2F0ZSBoYW5kbGVycwogICAgICAvLyBCbGFjay1ob2xlIFNWRyA8dXNlPiBpbnN0YW5jZSB0cmVlcyAoIzEzMTgwKQogICAgICAvLyBBdm9pZCBub24tbGVmdC1jbGljayBidWJibGluZyBpbiBGaXJlZm94ICgjMzg2MSkKICAgICAgaWYgKGRlbGVnYXRlQ291bnQgJiYgY3VyLm5vZGVUeXBlICYmICghZXZlbnQuYnV0dG9uIHx8IGV2ZW50LnR5cGUgIT09ICdjbGljaycpKSB7CiAgICAgICAgZm9yICg7IGN1ciAhPT0gdGhpczsgY3VyID0gY3VyLnBhcmVudE5vZGUgfHwgdGhpcykgewogICAgICAgICAgLy8gRG9uJ3QgcHJvY2VzcyBjbGlja3Mgb24gZGlzYWJsZWQgZWxlbWVudHMgKCM2OTExLCAjODE2NSwgIzExMzgyLCAjMTE3NjQpCiAgICAgICAgICBpZiAoY3VyLmRpc2FibGVkICE9PSB0cnVlIHx8IGV2ZW50LnR5cGUgIT09ICdjbGljaycpIHsKICAgICAgICAgICAgbWF0Y2hlcyA9IFtdOwogICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgZGVsZWdhdGVDb3VudDsgaSsrKSB7CiAgICAgICAgICAgICAgaGFuZGxlT2JqID0gaGFuZGxlcnNbaV07CiAgICAgICAgICAgICAgLy8gRG9uJ3QgY29uZmxpY3Qgd2l0aCBPYmplY3QucHJvdG90eXBlIHByb3BlcnRpZXMgKCMxMzIwMykKICAgICAgICAgICAgICBzZWwgPSBoYW5kbGVPYmouc2VsZWN0b3IgKyAnICc7CiAgICAgICAgICAgICAgaWYgKG1hdGNoZXNbc2VsXSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICBtYXRjaGVzW3NlbF0gPSBoYW5kbGVPYmoubmVlZHNDb250ZXh0ID8galF1ZXJ5KHNlbCwgdGhpcykuaW5kZXgoY3VyKSA+PSAwIDogalF1ZXJ5LmZpbmQoc2VsLCB0aGlzLCBudWxsLCBbY3VyXSkubGVuZ3RoOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAobWF0Y2hlc1tzZWxdKSB7CiAgICAgICAgICAgICAgICBtYXRjaGVzLnB1c2goaGFuZGxlT2JqKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG1hdGNoZXMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgaGFuZGxlclF1ZXVlLnB1c2goewogICAgICAgICAgICAgICAgZWxlbTogY3VyLAogICAgICAgICAgICAgICAgaGFuZGxlcnM6IG1hdGNoZXMKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICAvLyBBZGQgdGhlIHJlbWFpbmluZyAoZGlyZWN0bHktYm91bmQpIGhhbmRsZXJzCiAgICAgIGlmIChkZWxlZ2F0ZUNvdW50IDwgaGFuZGxlcnMubGVuZ3RoKSB7CiAgICAgICAgaGFuZGxlclF1ZXVlLnB1c2goewogICAgICAgICAgZWxlbTogdGhpcywKICAgICAgICAgIGhhbmRsZXJzOiBoYW5kbGVycy5zbGljZShkZWxlZ2F0ZUNvdW50KQogICAgICAgIH0pOwogICAgICB9CiAgICAgIHJldHVybiBoYW5kbGVyUXVldWU7CiAgICB9LAogICAgLy8gSW5jbHVkZXMgc29tZSBldmVudCBwcm9wcyBzaGFyZWQgYnkgS2V5RXZlbnQgYW5kIE1vdXNlRXZlbnQKICAgIHByb3BzOiAnYWx0S2V5IGJ1YmJsZXMgY2FuY2VsYWJsZSBjdHJsS2V5IGN1cnJlbnRUYXJnZXQgZXZlbnRQaGFzZSBtZXRhS2V5IHJlbGF0ZWRUYXJnZXQgc2hpZnRLZXkgdGFyZ2V0IHRpbWVTdGFtcCB2aWV3IHdoaWNoJy5zcGxpdCgnICcpLAogICAgZml4SG9va3M6IHt9LAogICAga2V5SG9va3M6IHsKICAgICAgcHJvcHM6ICdjaGFyIGNoYXJDb2RlIGtleSBrZXlDb2RlJy5zcGxpdCgnICcpLAogICAgICBmaWx0ZXI6IGZ1bmN0aW9uIChldmVudCwgb3JpZ2luYWwpIHsKICAgICAgICAvLyBBZGQgd2hpY2ggZm9yIGtleSBldmVudHMKICAgICAgICBpZiAoZXZlbnQud2hpY2ggPT0gbnVsbCkgewogICAgICAgICAgZXZlbnQud2hpY2ggPSBvcmlnaW5hbC5jaGFyQ29kZSAhPSBudWxsID8gb3JpZ2luYWwuY2hhckNvZGUgOiBvcmlnaW5hbC5rZXlDb2RlOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZXZlbnQ7CiAgICAgIH0KICAgIH0sCiAgICBtb3VzZUhvb2tzOiB7CiAgICAgIHByb3BzOiAnYnV0dG9uIGJ1dHRvbnMgY2xpZW50WCBjbGllbnRZIG9mZnNldFggb2Zmc2V0WSBwYWdlWCBwYWdlWSBzY3JlZW5YIHNjcmVlblkgdG9FbGVtZW50Jy5zcGxpdCgnICcpLAogICAgICBmaWx0ZXI6IGZ1bmN0aW9uIChldmVudCwgb3JpZ2luYWwpIHsKICAgICAgICB2YXIgZXZlbnREb2MsIGRvYywgYm9keSwgYnV0dG9uID0gb3JpZ2luYWwuYnV0dG9uOwogICAgICAgIC8vIENhbGN1bGF0ZSBwYWdlWC9ZIGlmIG1pc3NpbmcgYW5kIGNsaWVudFgvWSBhdmFpbGFibGUKICAgICAgICBpZiAoZXZlbnQucGFnZVggPT0gbnVsbCAmJiBvcmlnaW5hbC5jbGllbnRYICE9IG51bGwpIHsKICAgICAgICAgIGV2ZW50RG9jID0gZXZlbnQudGFyZ2V0Lm93bmVyRG9jdW1lbnQgfHwgZG9jdW1lbnQ7CiAgICAgICAgICBkb2MgPSBldmVudERvYy5kb2N1bWVudEVsZW1lbnQ7CiAgICAgICAgICBib2R5ID0gZXZlbnREb2MuYm9keTsKICAgICAgICAgIGV2ZW50LnBhZ2VYID0gb3JpZ2luYWwuY2xpZW50WCArIChkb2MgJiYgZG9jLnNjcm9sbExlZnQgfHwgYm9keSAmJiBib2R5LnNjcm9sbExlZnQgfHwgMCkgLSAoZG9jICYmIGRvYy5jbGllbnRMZWZ0IHx8IGJvZHkgJiYgYm9keS5jbGllbnRMZWZ0IHx8IDApOwogICAgICAgICAgZXZlbnQucGFnZVkgPSBvcmlnaW5hbC5jbGllbnRZICsgKGRvYyAmJiBkb2Muc2Nyb2xsVG9wIHx8IGJvZHkgJiYgYm9keS5zY3JvbGxUb3AgfHwgMCkgLSAoZG9jICYmIGRvYy5jbGllbnRUb3AgfHwgYm9keSAmJiBib2R5LmNsaWVudFRvcCB8fCAwKTsKICAgICAgICB9CiAgICAgICAgLy8gQWRkIHdoaWNoIGZvciBjbGljazogMSA9PT0gbGVmdDsgMiA9PT0gbWlkZGxlOyAzID09PSByaWdodAogICAgICAgIC8vIE5vdGU6IGJ1dHRvbiBpcyBub3Qgbm9ybWFsaXplZCwgc28gZG9uJ3QgdXNlIGl0CiAgICAgICAgaWYgKCFldmVudC53aGljaCAmJiBidXR0b24gIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgZXZlbnQud2hpY2ggPSBidXR0b24gJiAxID8gMSA6IGJ1dHRvbiAmIDIgPyAzIDogYnV0dG9uICYgNCA/IDIgOiAwOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZXZlbnQ7CiAgICAgIH0KICAgIH0sCiAgICBmaXg6IGZ1bmN0aW9uIChldmVudCkgewogICAgICBpZiAoZXZlbnRbalF1ZXJ5LmV4cGFuZG9dKSB7CiAgICAgICAgcmV0dXJuIGV2ZW50OwogICAgICB9CiAgICAgIC8vIENyZWF0ZSBhIHdyaXRhYmxlIGNvcHkgb2YgdGhlIGV2ZW50IG9iamVjdCBhbmQgbm9ybWFsaXplIHNvbWUgcHJvcGVydGllcwogICAgICB2YXIgaSwgcHJvcCwgY29weSwgdHlwZSA9IGV2ZW50LnR5cGUsIG9yaWdpbmFsRXZlbnQgPSBldmVudCwgZml4SG9vayA9IHRoaXMuZml4SG9va3NbdHlwZV07CiAgICAgIGlmICghZml4SG9vaykgewogICAgICAgIHRoaXMuZml4SG9va3NbdHlwZV0gPSBmaXhIb29rID0gcm1vdXNlRXZlbnQudGVzdCh0eXBlKSA/IHRoaXMubW91c2VIb29rcyA6IHJrZXlFdmVudC50ZXN0KHR5cGUpID8gdGhpcy5rZXlIb29rcyA6IHt9OwogICAgICB9CiAgICAgIGNvcHkgPSBmaXhIb29rLnByb3BzID8gdGhpcy5wcm9wcy5jb25jYXQoZml4SG9vay5wcm9wcykgOiB0aGlzLnByb3BzOwogICAgICBldmVudCA9IG5ldyBqUXVlcnkuRXZlbnQob3JpZ2luYWxFdmVudCk7CiAgICAgIGkgPSBjb3B5Lmxlbmd0aDsKICAgICAgd2hpbGUgKGktLSkgewogICAgICAgIHByb3AgPSBjb3B5W2ldOwogICAgICAgIGV2ZW50W3Byb3BdID0gb3JpZ2luYWxFdmVudFtwcm9wXTsKICAgICAgfQogICAgICAvLyBTdXBwb3J0OiBDb3Jkb3ZhIDIuNSAoV2ViS2l0KSAoIzEzMjU1KQogICAgICAvLyBBbGwgZXZlbnRzIHNob3VsZCBoYXZlIGEgdGFyZ2V0OyBDb3Jkb3ZhIGRldmljZXJlYWR5IGRvZXNuJ3QKICAgICAgaWYgKCFldmVudC50YXJnZXQpIHsKICAgICAgICBldmVudC50YXJnZXQgPSBkb2N1bWVudDsKICAgICAgfQogICAgICAvLyBTdXBwb3J0OiBTYWZhcmkgNi4wKywgQ2hyb21lIDwgMjgKICAgICAgLy8gVGFyZ2V0IHNob3VsZCBub3QgYmUgYSB0ZXh0IG5vZGUgKCM1MDQsICMxMzE0MykKICAgICAgaWYgKGV2ZW50LnRhcmdldC5ub2RlVHlwZSA9PT0gMykgewogICAgICAgIGV2ZW50LnRhcmdldCA9IGV2ZW50LnRhcmdldC5wYXJlbnROb2RlOwogICAgICB9CiAgICAgIHJldHVybiBmaXhIb29rLmZpbHRlciA/IGZpeEhvb2suZmlsdGVyKGV2ZW50LCBvcmlnaW5hbEV2ZW50KSA6IGV2ZW50OwogICAgfSwKICAgIHNwZWNpYWw6IHsKICAgICAgbG9hZDogewogICAgICAgIC8vIFByZXZlbnQgdHJpZ2dlcmVkIGltYWdlLmxvYWQgZXZlbnRzIGZyb20gYnViYmxpbmcgdG8gd2luZG93LmxvYWQKICAgICAgICBub0J1YmJsZTogdHJ1ZQogICAgICB9LAogICAgICBmb2N1czogewogICAgICAgIC8vIEZpcmUgbmF0aXZlIGV2ZW50IGlmIHBvc3NpYmxlIHNvIGJsdXIvZm9jdXMgc2VxdWVuY2UgaXMgY29ycmVjdAogICAgICAgIHRyaWdnZXI6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGlmICh0aGlzICE9PSBzYWZlQWN0aXZlRWxlbWVudCgpICYmIHRoaXMuZm9jdXMpIHsKICAgICAgICAgICAgdGhpcy5mb2N1cygpOwogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBkZWxlZ2F0ZVR5cGU6ICdmb2N1c2luJwogICAgICB9LAogICAgICBibHVyOiB7CiAgICAgICAgdHJpZ2dlcjogZnVuY3Rpb24gKCkgewogICAgICAgICAgaWYgKHRoaXMgPT09IHNhZmVBY3RpdmVFbGVtZW50KCkgJiYgdGhpcy5ibHVyKSB7CiAgICAgICAgICAgIHRoaXMuYmx1cigpOwogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBkZWxlZ2F0ZVR5cGU6ICdmb2N1c291dCcKICAgICAgfSwKICAgICAgY2xpY2s6IHsKICAgICAgICAvLyBGb3IgY2hlY2tib3gsIGZpcmUgbmF0aXZlIGV2ZW50IHNvIGNoZWNrZWQgc3RhdGUgd2lsbCBiZSByaWdodAogICAgICAgIHRyaWdnZXI6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGlmICh0aGlzLnR5cGUgPT09ICdjaGVja2JveCcgJiYgdGhpcy5jbGljayAmJiBqUXVlcnkubm9kZU5hbWUodGhpcywgJ2lucHV0JykpIHsKICAgICAgICAgICAgdGhpcy5jbGljaygpOwogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAvLyBGb3IgY3Jvc3MtYnJvd3NlciBjb25zaXN0ZW5jeSwgZG9uJ3QgZmlyZSBuYXRpdmUgLmNsaWNrKCkgb24gbGlua3MKICAgICAgICBfZGVmYXVsdDogZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgICByZXR1cm4galF1ZXJ5Lm5vZGVOYW1lKGV2ZW50LnRhcmdldCwgJ2EnKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIGJlZm9yZXVubG9hZDogewogICAgICAgIHBvc3REaXNwYXRjaDogZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgICAvLyBTdXBwb3J0OiBGaXJlZm94IDIwKwogICAgICAgICAgLy8gRmlyZWZveCBkb2Vzbid0IGFsZXJ0IGlmIHRoZSByZXR1cm5WYWx1ZSBmaWVsZCBpcyBub3Qgc2V0LgogICAgICAgICAgaWYgKGV2ZW50LnJlc3VsdCAhPT0gdW5kZWZpbmVkICYmIGV2ZW50Lm9yaWdpbmFsRXZlbnQpIHsKICAgICAgICAgICAgZXZlbnQub3JpZ2luYWxFdmVudC5yZXR1cm5WYWx1ZSA9IGV2ZW50LnJlc3VsdDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICBzaW11bGF0ZTogZnVuY3Rpb24gKHR5cGUsIGVsZW0sIGV2ZW50LCBidWJibGUpIHsKICAgICAgLy8gUGlnZ3liYWNrIG9uIGEgZG9ub3IgZXZlbnQgdG8gc2ltdWxhdGUgYSBkaWZmZXJlbnQgb25lLgogICAgICAvLyBGYWtlIG9yaWdpbmFsRXZlbnQgdG8gYXZvaWQgZG9ub3IncyBzdG9wUHJvcGFnYXRpb24sIGJ1dCBpZiB0aGUKICAgICAgLy8gc2ltdWxhdGVkIGV2ZW50IHByZXZlbnRzIGRlZmF1bHQgdGhlbiB3ZSBkbyB0aGUgc2FtZSBvbiB0aGUgZG9ub3IuCiAgICAgIHZhciBlID0galF1ZXJ5LmV4dGVuZChuZXcgalF1ZXJ5LkV2ZW50KCksIGV2ZW50LCB7CiAgICAgICAgdHlwZTogdHlwZSwKICAgICAgICBpc1NpbXVsYXRlZDogdHJ1ZSwKICAgICAgICBvcmlnaW5hbEV2ZW50OiB7fQogICAgICB9KTsKICAgICAgaWYgKGJ1YmJsZSkgewogICAgICAgIGpRdWVyeS5ldmVudC50cmlnZ2VyKGUsIG51bGwsIGVsZW0pOwogICAgICB9IGVsc2UgewogICAgICAgIGpRdWVyeS5ldmVudC5kaXNwYXRjaC5jYWxsKGVsZW0sIGUpOwogICAgICB9CiAgICAgIGlmIChlLmlzRGVmYXVsdFByZXZlbnRlZCgpKSB7CiAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgfQogICAgfQogIH07CiAgalF1ZXJ5LnJlbW92ZUV2ZW50ID0gZnVuY3Rpb24gKGVsZW0sIHR5cGUsIGhhbmRsZSkgewogICAgaWYgKGVsZW0ucmVtb3ZlRXZlbnRMaXN0ZW5lcikgewogICAgICBlbGVtLnJlbW92ZUV2ZW50TGlzdGVuZXIodHlwZSwgaGFuZGxlLCBmYWxzZSk7CiAgICB9CiAgfTsKICBqUXVlcnkuRXZlbnQgPSBmdW5jdGlvbiAoc3JjLCBwcm9wcykgewogICAgLy8gQWxsb3cgaW5zdGFudGlhdGlvbiB3aXRob3V0IHRoZSAnbmV3JyBrZXl3b3JkCiAgICBpZiAoISh0aGlzIGluc3RhbmNlb2YgalF1ZXJ5LkV2ZW50KSkgewogICAgICByZXR1cm4gbmV3IGpRdWVyeS5FdmVudChzcmMsIHByb3BzKTsKICAgIH0KICAgIC8vIEV2ZW50IG9iamVjdAogICAgaWYgKHNyYyAmJiBzcmMudHlwZSkgewogICAgICB0aGlzLm9yaWdpbmFsRXZlbnQgPSBzcmM7CiAgICAgIHRoaXMudHlwZSA9IHNyYy50eXBlOwogICAgICAvLyBFdmVudHMgYnViYmxpbmcgdXAgdGhlIGRvY3VtZW50IG1heSBoYXZlIGJlZW4gbWFya2VkIGFzIHByZXZlbnRlZAogICAgICAvLyBieSBhIGhhbmRsZXIgbG93ZXIgZG93biB0aGUgdHJlZTsgcmVmbGVjdCB0aGUgY29ycmVjdCB2YWx1ZS4KICAgICAgdGhpcy5pc0RlZmF1bHRQcmV2ZW50ZWQgPSBzcmMuZGVmYXVsdFByZXZlbnRlZCB8fCBzcmMuZGVmYXVsdFByZXZlbnRlZCA9PT0gdW5kZWZpbmVkICYmIC8vIFN1cHBvcnQ6IEFuZHJvaWQgPCA0LjAKICAgICAgc3JjLnJldHVyblZhbHVlID09PSBmYWxzZSA/IHJldHVyblRydWUgOiByZXR1cm5GYWxzZTsgIC8vIEV2ZW50IHR5cGUKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMudHlwZSA9IHNyYzsKICAgIH0KICAgIC8vIFB1dCBleHBsaWNpdGx5IHByb3ZpZGVkIHByb3BlcnRpZXMgb250byB0aGUgZXZlbnQgb2JqZWN0CiAgICBpZiAocHJvcHMpIHsKICAgICAgalF1ZXJ5LmV4dGVuZCh0aGlzLCBwcm9wcyk7CiAgICB9CiAgICAvLyBDcmVhdGUgYSB0aW1lc3RhbXAgaWYgaW5jb21pbmcgZXZlbnQgZG9lc24ndCBoYXZlIG9uZQogICAgdGhpcy50aW1lU3RhbXAgPSBzcmMgJiYgc3JjLnRpbWVTdGFtcCB8fCBqUXVlcnkubm93KCk7CiAgICAvLyBNYXJrIGl0IGFzIGZpeGVkCiAgICB0aGlzW2pRdWVyeS5leHBhbmRvXSA9IHRydWU7CiAgfTsKICAvLyBqUXVlcnkuRXZlbnQgaXMgYmFzZWQgb24gRE9NMyBFdmVudHMgYXMgc3BlY2lmaWVkIGJ5IHRoZSBFQ01BU2NyaXB0IExhbmd1YWdlIEJpbmRpbmcKICAvLyBodHRwOi8vd3d3LnczLm9yZy9UUi8yMDAzL1dELURPTS1MZXZlbC0zLUV2ZW50cy0yMDAzMDMzMS9lY21hLXNjcmlwdC1iaW5kaW5nLmh0bWwKICBqUXVlcnkuRXZlbnQucHJvdG90eXBlID0gewogICAgaXNEZWZhdWx0UHJldmVudGVkOiByZXR1cm5GYWxzZSwKICAgIGlzUHJvcGFnYXRpb25TdG9wcGVkOiByZXR1cm5GYWxzZSwKICAgIGlzSW1tZWRpYXRlUHJvcGFnYXRpb25TdG9wcGVkOiByZXR1cm5GYWxzZSwKICAgIHByZXZlbnREZWZhdWx0OiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBlID0gdGhpcy5vcmlnaW5hbEV2ZW50OwogICAgICB0aGlzLmlzRGVmYXVsdFByZXZlbnRlZCA9IHJldHVyblRydWU7CiAgICAgIGlmIChlICYmIGUucHJldmVudERlZmF1bHQpIHsKICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgIH0KICAgIH0sCiAgICBzdG9wUHJvcGFnYXRpb246IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIGUgPSB0aGlzLm9yaWdpbmFsRXZlbnQ7CiAgICAgIHRoaXMuaXNQcm9wYWdhdGlvblN0b3BwZWQgPSByZXR1cm5UcnVlOwogICAgICBpZiAoZSAmJiBlLnN0b3BQcm9wYWdhdGlvbikgewogICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgIH0KICAgIH0sCiAgICBzdG9wSW1tZWRpYXRlUHJvcGFnYXRpb246IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIGUgPSB0aGlzLm9yaWdpbmFsRXZlbnQ7CiAgICAgIHRoaXMuaXNJbW1lZGlhdGVQcm9wYWdhdGlvblN0b3BwZWQgPSByZXR1cm5UcnVlOwogICAgICBpZiAoZSAmJiBlLnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbikgewogICAgICAgIGUuc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uKCk7CiAgICAgIH0KICAgICAgdGhpcy5zdG9wUHJvcGFnYXRpb24oKTsKICAgIH0KICB9OwogIC8vIENyZWF0ZSBtb3VzZWVudGVyL2xlYXZlIGV2ZW50cyB1c2luZyBtb3VzZW92ZXIvb3V0IGFuZCBldmVudC10aW1lIGNoZWNrcwogIC8vIFN1cHBvcnQ6IENocm9tZSAxNSsKICBqUXVlcnkuZWFjaCh7CiAgICBtb3VzZWVudGVyOiAnbW91c2VvdmVyJywKICAgIG1vdXNlbGVhdmU6ICdtb3VzZW91dCcsCiAgICBwb2ludGVyZW50ZXI6ICdwb2ludGVyb3ZlcicsCiAgICBwb2ludGVybGVhdmU6ICdwb2ludGVyb3V0JwogIH0sIGZ1bmN0aW9uIChvcmlnLCBmaXgpIHsKICAgIGpRdWVyeS5ldmVudC5zcGVjaWFsW29yaWddID0gewogICAgICBkZWxlZ2F0ZVR5cGU6IGZpeCwKICAgICAgYmluZFR5cGU6IGZpeCwKICAgICAgaGFuZGxlOiBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICB2YXIgcmV0LCB0YXJnZXQgPSB0aGlzLCByZWxhdGVkID0gZXZlbnQucmVsYXRlZFRhcmdldCwgaGFuZGxlT2JqID0gZXZlbnQuaGFuZGxlT2JqOwogICAgICAgIC8vIEZvciBtb3VzZW50ZXIvbGVhdmUgY2FsbCB0aGUgaGFuZGxlciBpZiByZWxhdGVkIGlzIG91dHNpZGUgdGhlIHRhcmdldC4KICAgICAgICAvLyBOQjogTm8gcmVsYXRlZFRhcmdldCBpZiB0aGUgbW91c2UgbGVmdC9lbnRlcmVkIHRoZSBicm93c2VyIHdpbmRvdwogICAgICAgIGlmICghcmVsYXRlZCB8fCByZWxhdGVkICE9PSB0YXJnZXQgJiYgIWpRdWVyeS5jb250YWlucyh0YXJnZXQsIHJlbGF0ZWQpKSB7CiAgICAgICAgICBldmVudC50eXBlID0gaGFuZGxlT2JqLm9yaWdUeXBlOwogICAgICAgICAgcmV0ID0gaGFuZGxlT2JqLmhhbmRsZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgIGV2ZW50LnR5cGUgPSBmaXg7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXQ7CiAgICAgIH0KICAgIH07CiAgfSk7CiAgLy8gQ3JlYXRlICJidWJibGluZyIgZm9jdXMgYW5kIGJsdXIgZXZlbnRzCiAgLy8gU3VwcG9ydDogRmlyZWZveCwgQ2hyb21lLCBTYWZhcmkKICBpZiAoIXN1cHBvcnQuZm9jdXNpbkJ1YmJsZXMpIHsKICAgIGpRdWVyeS5lYWNoKHsKICAgICAgZm9jdXM6ICdmb2N1c2luJywKICAgICAgYmx1cjogJ2ZvY3Vzb3V0JwogICAgfSwgZnVuY3Rpb24gKG9yaWcsIGZpeCkgewogICAgICAvLyBBdHRhY2ggYSBzaW5nbGUgY2FwdHVyaW5nIGhhbmRsZXIgb24gdGhlIGRvY3VtZW50IHdoaWxlIHNvbWVvbmUgd2FudHMgZm9jdXNpbi9mb2N1c291dAogICAgICB2YXIgaGFuZGxlciA9IGZ1bmN0aW9uIChldmVudCkgewogICAgICAgIGpRdWVyeS5ldmVudC5zaW11bGF0ZShmaXgsIGV2ZW50LnRhcmdldCwgalF1ZXJ5LmV2ZW50LmZpeChldmVudCksIHRydWUpOwogICAgICB9OwogICAgICBqUXVlcnkuZXZlbnQuc3BlY2lhbFtmaXhdID0gewogICAgICAgIHNldHVwOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICB2YXIgZG9jID0gdGhpcy5vd25lckRvY3VtZW50IHx8IHRoaXMsIGF0dGFjaGVzID0gZGF0YV9wcml2LmFjY2Vzcyhkb2MsIGZpeCk7CiAgICAgICAgICBpZiAoIWF0dGFjaGVzKSB7CiAgICAgICAgICAgIGRvYy5hZGRFdmVudExpc3RlbmVyKG9yaWcsIGhhbmRsZXIsIHRydWUpOwogICAgICAgICAgfQogICAgICAgICAgZGF0YV9wcml2LmFjY2Vzcyhkb2MsIGZpeCwgKGF0dGFjaGVzIHx8IDApICsgMSk7CiAgICAgICAgfSwKICAgICAgICB0ZWFyZG93bjogZnVuY3Rpb24gKCkgewogICAgICAgICAgdmFyIGRvYyA9IHRoaXMub3duZXJEb2N1bWVudCB8fCB0aGlzLCBhdHRhY2hlcyA9IGRhdGFfcHJpdi5hY2Nlc3MoZG9jLCBmaXgpIC0gMTsKICAgICAgICAgIGlmICghYXR0YWNoZXMpIHsKICAgICAgICAgICAgZG9jLnJlbW92ZUV2ZW50TGlzdGVuZXIob3JpZywgaGFuZGxlciwgdHJ1ZSk7CiAgICAgICAgICAgIGRhdGFfcHJpdi5yZW1vdmUoZG9jLCBmaXgpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZGF0YV9wcml2LmFjY2Vzcyhkb2MsIGZpeCwgYXR0YWNoZXMpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfTsKICAgIH0pOwogIH0KICBqUXVlcnkuZm4uZXh0ZW5kKHsKICAgIG9uOiBmdW5jdGlvbiAodHlwZXMsIHNlbGVjdG9yLCBkYXRhLCBmbiwgb25lKSB7CiAgICAgIHZhciBvcmlnRm4sIHR5cGU7CiAgICAgIC8vIFR5cGVzIGNhbiBiZSBhIG1hcCBvZiB0eXBlcy9oYW5kbGVycwogICAgICBpZiAodHlwZW9mIHR5cGVzID09PSAnb2JqZWN0JykgewogICAgICAgIC8vICggdHlwZXMtT2JqZWN0LCBzZWxlY3RvciwgZGF0YSApCiAgICAgICAgaWYgKHR5cGVvZiBzZWxlY3RvciAhPT0gJ3N0cmluZycpIHsKICAgICAgICAgIC8vICggdHlwZXMtT2JqZWN0LCBkYXRhICkKICAgICAgICAgIGRhdGEgPSBkYXRhIHx8IHNlbGVjdG9yOwogICAgICAgICAgc2VsZWN0b3IgPSB1bmRlZmluZWQ7CiAgICAgICAgfQogICAgICAgIGZvciAodHlwZSBpbiB0eXBlcykgewogICAgICAgICAgdGhpcy5vbih0eXBlLCBzZWxlY3RvciwgZGF0YSwgdHlwZXNbdHlwZV0sIG9uZSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzOwogICAgICB9CiAgICAgIGlmIChkYXRhID09IG51bGwgJiYgZm4gPT0gbnVsbCkgewogICAgICAgIC8vICggdHlwZXMsIGZuICkKICAgICAgICBmbiA9IHNlbGVjdG9yOwogICAgICAgIGRhdGEgPSBzZWxlY3RvciA9IHVuZGVmaW5lZDsKICAgICAgfSBlbHNlIGlmIChmbiA9PSBudWxsKSB7CiAgICAgICAgaWYgKHR5cGVvZiBzZWxlY3RvciA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgIC8vICggdHlwZXMsIHNlbGVjdG9yLCBmbiApCiAgICAgICAgICBmbiA9IGRhdGE7CiAgICAgICAgICBkYXRhID0gdW5kZWZpbmVkOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAvLyAoIHR5cGVzLCBkYXRhLCBmbiApCiAgICAgICAgICBmbiA9IGRhdGE7CiAgICAgICAgICBkYXRhID0gc2VsZWN0b3I7CiAgICAgICAgICBzZWxlY3RvciA9IHVuZGVmaW5lZDsKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKGZuID09PSBmYWxzZSkgewogICAgICAgIGZuID0gcmV0dXJuRmFsc2U7CiAgICAgIH0gZWxzZSBpZiAoIWZuKSB7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgIH0KICAgICAgaWYgKG9uZSA9PT0gMSkgewogICAgICAgIG9yaWdGbiA9IGZuOwogICAgICAgIGZuID0gZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgICAvLyBDYW4gdXNlIGFuIGVtcHR5IHNldCwgc2luY2UgZXZlbnQgY29udGFpbnMgdGhlIGluZm8KICAgICAgICAgIGpRdWVyeSgpLm9mZihldmVudCk7CiAgICAgICAgICByZXR1cm4gb3JpZ0ZuLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgfTsKICAgICAgICAvLyBVc2Ugc2FtZSBndWlkIHNvIGNhbGxlciBjYW4gcmVtb3ZlIHVzaW5nIG9yaWdGbgogICAgICAgIGZuLmd1aWQgPSBvcmlnRm4uZ3VpZCB8fCAob3JpZ0ZuLmd1aWQgPSBqUXVlcnkuZ3VpZCsrKTsKICAgICAgfQogICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgICBqUXVlcnkuZXZlbnQuYWRkKHRoaXMsIHR5cGVzLCBmbiwgZGF0YSwgc2VsZWN0b3IpOwogICAgICB9KTsKICAgIH0sCiAgICBvbmU6IGZ1bmN0aW9uICh0eXBlcywgc2VsZWN0b3IsIGRhdGEsIGZuKSB7CiAgICAgIHJldHVybiB0aGlzLm9uKHR5cGVzLCBzZWxlY3RvciwgZGF0YSwgZm4sIDEpOwogICAgfSwKICAgIG9mZjogZnVuY3Rpb24gKHR5cGVzLCBzZWxlY3RvciwgZm4pIHsKICAgICAgdmFyIGhhbmRsZU9iaiwgdHlwZTsKICAgICAgaWYgKHR5cGVzICYmIHR5cGVzLnByZXZlbnREZWZhdWx0ICYmIHR5cGVzLmhhbmRsZU9iaikgewogICAgICAgIC8vICggZXZlbnQgKSAgZGlzcGF0Y2hlZCBqUXVlcnkuRXZlbnQKICAgICAgICBoYW5kbGVPYmogPSB0eXBlcy5oYW5kbGVPYmo7CiAgICAgICAgalF1ZXJ5KHR5cGVzLmRlbGVnYXRlVGFyZ2V0KS5vZmYoaGFuZGxlT2JqLm5hbWVzcGFjZSA/IGhhbmRsZU9iai5vcmlnVHlwZSArICcuJyArIGhhbmRsZU9iai5uYW1lc3BhY2UgOiBoYW5kbGVPYmoub3JpZ1R5cGUsIGhhbmRsZU9iai5zZWxlY3RvciwgaGFuZGxlT2JqLmhhbmRsZXIpOwogICAgICAgIHJldHVybiB0aGlzOwogICAgICB9CiAgICAgIGlmICh0eXBlb2YgdHlwZXMgPT09ICdvYmplY3QnKSB7CiAgICAgICAgLy8gKCB0eXBlcy1vYmplY3QgWywgc2VsZWN0b3JdICkKICAgICAgICBmb3IgKHR5cGUgaW4gdHlwZXMpIHsKICAgICAgICAgIHRoaXMub2ZmKHR5cGUsIHNlbGVjdG9yLCB0eXBlc1t0eXBlXSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzOwogICAgICB9CiAgICAgIGlmIChzZWxlY3RvciA9PT0gZmFsc2UgfHwgdHlwZW9mIHNlbGVjdG9yID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgLy8gKCB0eXBlcyBbLCBmbl0gKQogICAgICAgIGZuID0gc2VsZWN0b3I7CiAgICAgICAgc2VsZWN0b3IgPSB1bmRlZmluZWQ7CiAgICAgIH0KICAgICAgaWYgKGZuID09PSBmYWxzZSkgewogICAgICAgIGZuID0gcmV0dXJuRmFsc2U7CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgalF1ZXJ5LmV2ZW50LnJlbW92ZSh0aGlzLCB0eXBlcywgZm4sIHNlbGVjdG9yKTsKICAgICAgfSk7CiAgICB9LAogICAgdHJpZ2dlcjogZnVuY3Rpb24gKHR5cGUsIGRhdGEpIHsKICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgalF1ZXJ5LmV2ZW50LnRyaWdnZXIodHlwZSwgZGF0YSwgdGhpcyk7CiAgICAgIH0pOwogICAgfSwKICAgIHRyaWdnZXJIYW5kbGVyOiBmdW5jdGlvbiAodHlwZSwgZGF0YSkgewogICAgICB2YXIgZWxlbSA9IHRoaXNbMF07CiAgICAgIGlmIChlbGVtKSB7CiAgICAgICAgcmV0dXJuIGpRdWVyeS5ldmVudC50cmlnZ2VyKHR5cGUsIGRhdGEsIGVsZW0sIHRydWUpOwogICAgICB9CiAgICB9CiAgfSk7CiAgdmFyIHJ4aHRtbFRhZyA9IC88KD8hYXJlYXxicnxjb2x8ZW1iZWR8aHJ8aW1nfGlucHV0fGxpbmt8bWV0YXxwYXJhbSkoKFtcdzpdKylbXj5dKilcLz4vZ2ksIHJ0YWdOYW1lID0gLzwoW1x3Ol0rKS8sIHJodG1sID0gLzx8JiM/XHcrOy8sIHJub0lubmVyaHRtbCA9IC88KD86c2NyaXB0fHN0eWxlfGxpbmspL2ksCiAgICAvLyBjaGVja2VkPSJjaGVja2VkIiBvciBjaGVja2VkCiAgICByY2hlY2tlZCA9IC9jaGVja2VkXHMqKD86W149XXw9XHMqLmNoZWNrZWQuKS9pLCByc2NyaXB0VHlwZSA9IC9eJHxcLyg/OmphdmF8ZWNtYSlzY3JpcHQvaSwgcnNjcmlwdFR5cGVNYXNrZWQgPSAvXnRydWVcLyguKikvLCByY2xlYW5TY3JpcHQgPSAvXlxzKjwhKD86XFtDREFUQVxbfC0tKXwoPzpcXVxdfC0tKT5ccyokL2csCiAgICAvLyBXZSBoYXZlIHRvIGNsb3NlIHRoZXNlIHRhZ3MgdG8gc3VwcG9ydCBYSFRNTCAoIzEzMjAwKQogICAgd3JhcE1hcCA9IHsKICAgICAgLy8gU3VwcG9ydDogSUUgOQogICAgICBvcHRpb246IFsKICAgICAgICAxLAogICAgICAgICc8c2VsZWN0IG11bHRpcGxlPVwnbXVsdGlwbGVcJz4nLAogICAgICAgICc8L3NlbGVjdD4nCiAgICAgIF0sCiAgICAgIHRoZWFkOiBbCiAgICAgICAgMSwKICAgICAgICAnPHRhYmxlPicsCiAgICAgICAgJzwvdGFibGU+JwogICAgICBdLAogICAgICBjb2w6IFsKICAgICAgICAyLAogICAgICAgICc8dGFibGU+PGNvbGdyb3VwPicsCiAgICAgICAgJzwvY29sZ3JvdXA+PC90YWJsZT4nCiAgICAgIF0sCiAgICAgIHRyOiBbCiAgICAgICAgMiwKICAgICAgICAnPHRhYmxlPjx0Ym9keT4nLAogICAgICAgICc8L3Rib2R5PjwvdGFibGU+JwogICAgICBdLAogICAgICB0ZDogWwogICAgICAgIDMsCiAgICAgICAgJzx0YWJsZT48dGJvZHk+PHRyPicsCiAgICAgICAgJzwvdHI+PC90Ym9keT48L3RhYmxlPicKICAgICAgXSwKICAgICAgX2RlZmF1bHQ6IFsKICAgICAgICAwLAogICAgICAgICcnLAogICAgICAgICcnCiAgICAgIF0KICAgIH07CiAgLy8gU3VwcG9ydDogSUUgOQogIHdyYXBNYXAub3B0Z3JvdXAgPSB3cmFwTWFwLm9wdGlvbjsKICB3cmFwTWFwLnRib2R5ID0gd3JhcE1hcC50Zm9vdCA9IHdyYXBNYXAuY29sZ3JvdXAgPSB3cmFwTWFwLmNhcHRpb24gPSB3cmFwTWFwLnRoZWFkOwogIHdyYXBNYXAudGggPSB3cmFwTWFwLnRkOwogIC8vIFN1cHBvcnQ6IDEueCBjb21wYXRpYmlsaXR5CiAgLy8gTWFuaXB1bGF0aW5nIHRhYmxlcyByZXF1aXJlcyBhIHRib2R5CiAgZnVuY3Rpb24gbWFuaXB1bGF0aW9uVGFyZ2V0KGVsZW0sIGNvbnRlbnQpIHsKICAgIHJldHVybiBqUXVlcnkubm9kZU5hbWUoZWxlbSwgJ3RhYmxlJykgJiYgalF1ZXJ5Lm5vZGVOYW1lKGNvbnRlbnQubm9kZVR5cGUgIT09IDExID8gY29udGVudCA6IGNvbnRlbnQuZmlyc3RDaGlsZCwgJ3RyJykgPyBlbGVtLmdldEVsZW1lbnRzQnlUYWdOYW1lKCd0Ym9keScpWzBdIHx8IGVsZW0uYXBwZW5kQ2hpbGQoZWxlbS5vd25lckRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3Rib2R5JykpIDogZWxlbTsKICB9CiAgLy8gUmVwbGFjZS9yZXN0b3JlIHRoZSB0eXBlIGF0dHJpYnV0ZSBvZiBzY3JpcHQgZWxlbWVudHMgZm9yIHNhZmUgRE9NIG1hbmlwdWxhdGlvbgogIGZ1bmN0aW9uIGRpc2FibGVTY3JpcHQoZWxlbSkgewogICAgZWxlbS50eXBlID0gKGVsZW0uZ2V0QXR0cmlidXRlKCd0eXBlJykgIT09IG51bGwpICsgJy8nICsgZWxlbS50eXBlOwogICAgcmV0dXJuIGVsZW07CiAgfQogIGZ1bmN0aW9uIHJlc3RvcmVTY3JpcHQoZWxlbSkgewogICAgdmFyIG1hdGNoID0gcnNjcmlwdFR5cGVNYXNrZWQuZXhlYyhlbGVtLnR5cGUpOwogICAgaWYgKG1hdGNoKSB7CiAgICAgIGVsZW0udHlwZSA9IG1hdGNoWzFdOwogICAgfSBlbHNlIHsKICAgICAgZWxlbS5yZW1vdmVBdHRyaWJ1dGUoJ3R5cGUnKTsKICAgIH0KICAgIHJldHVybiBlbGVtOwogIH0KICAvLyBNYXJrIHNjcmlwdHMgYXMgaGF2aW5nIGFscmVhZHkgYmVlbiBldmFsdWF0ZWQKICBmdW5jdGlvbiBzZXRHbG9iYWxFdmFsKGVsZW1zLCByZWZFbGVtZW50cykgewogICAgdmFyIGkgPSAwLCBsID0gZWxlbXMubGVuZ3RoOwogICAgZm9yICg7IGkgPCBsOyBpKyspIHsKICAgICAgZGF0YV9wcml2LnNldChlbGVtc1tpXSwgJ2dsb2JhbEV2YWwnLCAhcmVmRWxlbWVudHMgfHwgZGF0YV9wcml2LmdldChyZWZFbGVtZW50c1tpXSwgJ2dsb2JhbEV2YWwnKSk7CiAgICB9CiAgfQogIGZ1bmN0aW9uIGNsb25lQ29weUV2ZW50KHNyYywgZGVzdCkgewogICAgdmFyIGksIGwsIHR5cGUsIHBkYXRhT2xkLCBwZGF0YUN1ciwgdWRhdGFPbGQsIHVkYXRhQ3VyLCBldmVudHM7CiAgICBpZiAoZGVzdC5ub2RlVHlwZSAhPT0gMSkgewogICAgICByZXR1cm47CiAgICB9CiAgICAvLyAxLiBDb3B5IHByaXZhdGUgZGF0YTogZXZlbnRzLCBoYW5kbGVycywgZXRjLgogICAgaWYgKGRhdGFfcHJpdi5oYXNEYXRhKHNyYykpIHsKICAgICAgcGRhdGFPbGQgPSBkYXRhX3ByaXYuYWNjZXNzKHNyYyk7CiAgICAgIHBkYXRhQ3VyID0gZGF0YV9wcml2LnNldChkZXN0LCBwZGF0YU9sZCk7CiAgICAgIGV2ZW50cyA9IHBkYXRhT2xkLmV2ZW50czsKICAgICAgaWYgKGV2ZW50cykgewogICAgICAgIGRlbGV0ZSBwZGF0YUN1ci5oYW5kbGU7CiAgICAgICAgcGRhdGFDdXIuZXZlbnRzID0ge307CiAgICAgICAgZm9yICh0eXBlIGluIGV2ZW50cykgewogICAgICAgICAgZm9yIChpID0gMCwgbCA9IGV2ZW50c1t0eXBlXS5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgICAgalF1ZXJ5LmV2ZW50LmFkZChkZXN0LCB0eXBlLCBldmVudHNbdHlwZV1baV0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQogICAgLy8gMi4gQ29weSB1c2VyIGRhdGEKICAgIGlmIChkYXRhX3VzZXIuaGFzRGF0YShzcmMpKSB7CiAgICAgIHVkYXRhT2xkID0gZGF0YV91c2VyLmFjY2VzcyhzcmMpOwogICAgICB1ZGF0YUN1ciA9IGpRdWVyeS5leHRlbmQoe30sIHVkYXRhT2xkKTsKICAgICAgZGF0YV91c2VyLnNldChkZXN0LCB1ZGF0YUN1cik7CiAgICB9CiAgfQogIGZ1bmN0aW9uIGdldEFsbChjb250ZXh0LCB0YWcpIHsKICAgIHZhciByZXQgPSBjb250ZXh0LmdldEVsZW1lbnRzQnlUYWdOYW1lID8gY29udGV4dC5nZXRFbGVtZW50c0J5VGFnTmFtZSh0YWcgfHwgJyonKSA6IGNvbnRleHQucXVlcnlTZWxlY3RvckFsbCA/IGNvbnRleHQucXVlcnlTZWxlY3RvckFsbCh0YWcgfHwgJyonKSA6IFtdOwogICAgcmV0dXJuIHRhZyA9PT0gdW5kZWZpbmVkIHx8IHRhZyAmJiBqUXVlcnkubm9kZU5hbWUoY29udGV4dCwgdGFnKSA/IGpRdWVyeS5tZXJnZShbY29udGV4dF0sIHJldCkgOiByZXQ7CiAgfQogIC8vIFN1cHBvcnQ6IElFID49IDkKICBmdW5jdGlvbiBmaXhJbnB1dChzcmMsIGRlc3QpIHsKICAgIHZhciBub2RlTmFtZSA9IGRlc3Qubm9kZU5hbWUudG9Mb3dlckNhc2UoKTsKICAgIC8vIEZhaWxzIHRvIHBlcnNpc3QgdGhlIGNoZWNrZWQgc3RhdGUgb2YgYSBjbG9uZWQgY2hlY2tib3ggb3IgcmFkaW8gYnV0dG9uLgogICAgaWYgKG5vZGVOYW1lID09PSAnaW5wdXQnICYmIHJjaGVja2FibGVUeXBlLnRlc3Qoc3JjLnR5cGUpKSB7CiAgICAgIGRlc3QuY2hlY2tlZCA9IHNyYy5jaGVja2VkOyAgLy8gRmFpbHMgdG8gcmV0dXJuIHRoZSBzZWxlY3RlZCBvcHRpb24gdG8gdGhlIGRlZmF1bHQgc2VsZWN0ZWQgc3RhdGUgd2hlbiBjbG9uaW5nIG9wdGlvbnMKICAgIH0gZWxzZSBpZiAobm9kZU5hbWUgPT09ICdpbnB1dCcgfHwgbm9kZU5hbWUgPT09ICd0ZXh0YXJlYScpIHsKICAgICAgZGVzdC5kZWZhdWx0VmFsdWUgPSBzcmMuZGVmYXVsdFZhbHVlOwogICAgfQogIH0KICBqUXVlcnkuZXh0ZW5kKHsKICAgIGNsb25lOiBmdW5jdGlvbiAoZWxlbSwgZGF0YUFuZEV2ZW50cywgZGVlcERhdGFBbmRFdmVudHMpIHsKICAgICAgdmFyIGksIGwsIHNyY0VsZW1lbnRzLCBkZXN0RWxlbWVudHMsIGNsb25lID0gZWxlbS5jbG9uZU5vZGUodHJ1ZSksIGluUGFnZSA9IGpRdWVyeS5jb250YWlucyhlbGVtLm93bmVyRG9jdW1lbnQsIGVsZW0pOwogICAgICAvLyBTdXBwb3J0OiBJRSA+PSA5CiAgICAgIC8vIEZpeCBDbG9uaW5nIGlzc3VlcwogICAgICBpZiAoIXN1cHBvcnQubm9DbG9uZUNoZWNrZWQgJiYgKGVsZW0ubm9kZVR5cGUgPT09IDEgfHwgZWxlbS5ub2RlVHlwZSA9PT0gMTEpICYmICFqUXVlcnkuaXNYTUxEb2MoZWxlbSkpIHsKICAgICAgICAvLyBXZSBlc2NoZXcgU2l6emxlIGhlcmUgZm9yIHBlcmZvcm1hbmNlIHJlYXNvbnM6IGh0dHA6Ly9qc3BlcmYuY29tL2dldGFsbC12cy1zaXp6bGUvMgogICAgICAgIGRlc3RFbGVtZW50cyA9IGdldEFsbChjbG9uZSk7CiAgICAgICAgc3JjRWxlbWVudHMgPSBnZXRBbGwoZWxlbSk7CiAgICAgICAgZm9yIChpID0gMCwgbCA9IHNyY0VsZW1lbnRzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgZml4SW5wdXQoc3JjRWxlbWVudHNbaV0sIGRlc3RFbGVtZW50c1tpXSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIC8vIENvcHkgdGhlIGV2ZW50cyBmcm9tIHRoZSBvcmlnaW5hbCB0byB0aGUgY2xvbmUKICAgICAgaWYgKGRhdGFBbmRFdmVudHMpIHsKICAgICAgICBpZiAoZGVlcERhdGFBbmRFdmVudHMpIHsKICAgICAgICAgIHNyY0VsZW1lbnRzID0gc3JjRWxlbWVudHMgfHwgZ2V0QWxsKGVsZW0pOwogICAgICAgICAgZGVzdEVsZW1lbnRzID0gZGVzdEVsZW1lbnRzIHx8IGdldEFsbChjbG9uZSk7CiAgICAgICAgICBmb3IgKGkgPSAwLCBsID0gc3JjRWxlbWVudHMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgICAgIGNsb25lQ29weUV2ZW50KHNyY0VsZW1lbnRzW2ldLCBkZXN0RWxlbWVudHNbaV0pOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjbG9uZUNvcHlFdmVudChlbGVtLCBjbG9uZSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIC8vIFByZXNlcnZlIHNjcmlwdCBldmFsdWF0aW9uIGhpc3RvcnkKICAgICAgZGVzdEVsZW1lbnRzID0gZ2V0QWxsKGNsb25lLCAnc2NyaXB0Jyk7CiAgICAgIGlmIChkZXN0RWxlbWVudHMubGVuZ3RoID4gMCkgewogICAgICAgIHNldEdsb2JhbEV2YWwoZGVzdEVsZW1lbnRzLCAhaW5QYWdlICYmIGdldEFsbChlbGVtLCAnc2NyaXB0JykpOwogICAgICB9CiAgICAgIC8vIFJldHVybiB0aGUgY2xvbmVkIHNldAogICAgICByZXR1cm4gY2xvbmU7CiAgICB9LAogICAgYnVpbGRGcmFnbWVudDogZnVuY3Rpb24gKGVsZW1zLCBjb250ZXh0LCBzY3JpcHRzLCBzZWxlY3Rpb24pIHsKICAgICAgdmFyIGVsZW0sIHRtcCwgdGFnLCB3cmFwLCBjb250YWlucywgaiwgZnJhZ21lbnQgPSBjb250ZXh0LmNyZWF0ZURvY3VtZW50RnJhZ21lbnQoKSwgbm9kZXMgPSBbXSwgaSA9IDAsIGwgPSBlbGVtcy5sZW5ndGg7CiAgICAgIGZvciAoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgZWxlbSA9IGVsZW1zW2ldOwogICAgICAgIGlmIChlbGVtIHx8IGVsZW0gPT09IDApIHsKICAgICAgICAgIC8vIEFkZCBub2RlcyBkaXJlY3RseQogICAgICAgICAgaWYgKGpRdWVyeS50eXBlKGVsZW0pID09PSAnb2JqZWN0JykgewogICAgICAgICAgICAvLyBTdXBwb3J0OiBRdFdlYktpdAogICAgICAgICAgICAvLyBqUXVlcnkubWVyZ2UgYmVjYXVzZSBwdXNoLmFwcGx5KF8sIGFycmF5bGlrZSkgdGhyb3dzCiAgICAgICAgICAgIGpRdWVyeS5tZXJnZShub2RlcywgZWxlbS5ub2RlVHlwZSA/IFtlbGVtXSA6IGVsZW0pOyAgLy8gQ29udmVydCBub24taHRtbCBpbnRvIGEgdGV4dCBub2RlCiAgICAgICAgICB9IGVsc2UgaWYgKCFyaHRtbC50ZXN0KGVsZW0pKSB7CiAgICAgICAgICAgIG5vZGVzLnB1c2goY29udGV4dC5jcmVhdGVUZXh0Tm9kZShlbGVtKSk7ICAvLyBDb252ZXJ0IGh0bWwgaW50byBET00gbm9kZXMKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRtcCA9IHRtcCB8fCBmcmFnbWVudC5hcHBlbmRDaGlsZChjb250ZXh0LmNyZWF0ZUVsZW1lbnQoJ2RpdicpKTsKICAgICAgICAgICAgLy8gRGVzZXJpYWxpemUgYSBzdGFuZGFyZCByZXByZXNlbnRhdGlvbgogICAgICAgICAgICB0YWcgPSAocnRhZ05hbWUuZXhlYyhlbGVtKSB8fCBbCiAgICAgICAgICAgICAgJycsCiAgICAgICAgICAgICAgJycKICAgICAgICAgICAgXSlbMV0udG9Mb3dlckNhc2UoKTsKICAgICAgICAgICAgd3JhcCA9IHdyYXBNYXBbdGFnXSB8fCB3cmFwTWFwLl9kZWZhdWx0OwogICAgICAgICAgICB0bXAuaW5uZXJIVE1MID0gd3JhcFsxXSArIGVsZW0ucmVwbGFjZShyeGh0bWxUYWcsICc8JDE+PC8kMj4nKSArIHdyYXBbMl07CiAgICAgICAgICAgIC8vIERlc2NlbmQgdGhyb3VnaCB3cmFwcGVycyB0byB0aGUgcmlnaHQgY29udGVudAogICAgICAgICAgICBqID0gd3JhcFswXTsKICAgICAgICAgICAgd2hpbGUgKGotLSkgewogICAgICAgICAgICAgIHRtcCA9IHRtcC5sYXN0Q2hpbGQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gU3VwcG9ydDogUXRXZWJLaXQKICAgICAgICAgICAgLy8galF1ZXJ5Lm1lcmdlIGJlY2F1c2UgcHVzaC5hcHBseShfLCBhcnJheWxpa2UpIHRocm93cwogICAgICAgICAgICBqUXVlcnkubWVyZ2Uobm9kZXMsIHRtcC5jaGlsZE5vZGVzKTsKICAgICAgICAgICAgLy8gUmVtZW1iZXIgdGhlIHRvcC1sZXZlbCBjb250YWluZXIKICAgICAgICAgICAgdG1wID0gZnJhZ21lbnQuZmlyc3RDaGlsZDsKICAgICAgICAgICAgLy8gRml4ZXMgIzEyMzQ2CiAgICAgICAgICAgIC8vIFN1cHBvcnQ6IFdlYmtpdCwgSUUKICAgICAgICAgICAgdG1wLnRleHRDb250ZW50ID0gJyc7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIC8vIFJlbW92ZSB3cmFwcGVyIGZyb20gZnJhZ21lbnQKICAgICAgZnJhZ21lbnQudGV4dENvbnRlbnQgPSAnJzsKICAgICAgaSA9IDA7CiAgICAgIHdoaWxlIChlbGVtID0gbm9kZXNbaSsrXSkgewogICAgICAgIC8vICM0MDg3IC0gSWYgb3JpZ2luIGFuZCBkZXN0aW5hdGlvbiBlbGVtZW50cyBhcmUgdGhlIHNhbWUsIGFuZCB0aGlzIGlzCiAgICAgICAgLy8gdGhhdCBlbGVtZW50LCBkbyBub3QgZG8gYW55dGhpbmcKICAgICAgICBpZiAoc2VsZWN0aW9uICYmIGpRdWVyeS5pbkFycmF5KGVsZW0sIHNlbGVjdGlvbikgIT09IC0xKSB7CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CiAgICAgICAgY29udGFpbnMgPSBqUXVlcnkuY29udGFpbnMoZWxlbS5vd25lckRvY3VtZW50LCBlbGVtKTsKICAgICAgICAvLyBBcHBlbmQgdG8gZnJhZ21lbnQKICAgICAgICB0bXAgPSBnZXRBbGwoZnJhZ21lbnQuYXBwZW5kQ2hpbGQoZWxlbSksICdzY3JpcHQnKTsKICAgICAgICAvLyBQcmVzZXJ2ZSBzY3JpcHQgZXZhbHVhdGlvbiBoaXN0b3J5CiAgICAgICAgaWYgKGNvbnRhaW5zKSB7CiAgICAgICAgICBzZXRHbG9iYWxFdmFsKHRtcCk7CiAgICAgICAgfQogICAgICAgIC8vIENhcHR1cmUgZXhlY3V0YWJsZXMKICAgICAgICBpZiAoc2NyaXB0cykgewogICAgICAgICAgaiA9IDA7CiAgICAgICAgICB3aGlsZSAoZWxlbSA9IHRtcFtqKytdKSB7CiAgICAgICAgICAgIGlmIChyc2NyaXB0VHlwZS50ZXN0KGVsZW0udHlwZSB8fCAnJykpIHsKICAgICAgICAgICAgICBzY3JpcHRzLnB1c2goZWxlbSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIGZyYWdtZW50OwogICAgfSwKICAgIGNsZWFuRGF0YTogZnVuY3Rpb24gKGVsZW1zKSB7CiAgICAgIHZhciBkYXRhLCBlbGVtLCB0eXBlLCBrZXksIHNwZWNpYWwgPSBqUXVlcnkuZXZlbnQuc3BlY2lhbCwgaSA9IDA7CiAgICAgIGZvciAoOyAoZWxlbSA9IGVsZW1zW2ldKSAhPT0gdW5kZWZpbmVkOyBpKyspIHsKICAgICAgICBpZiAoalF1ZXJ5LmFjY2VwdERhdGEoZWxlbSkpIHsKICAgICAgICAgIGtleSA9IGVsZW1bZGF0YV9wcml2LmV4cGFuZG9dOwogICAgICAgICAgaWYgKGtleSAmJiAoZGF0YSA9IGRhdGFfcHJpdi5jYWNoZVtrZXldKSkgewogICAgICAgICAgICBpZiAoZGF0YS5ldmVudHMpIHsKICAgICAgICAgICAgICBmb3IgKHR5cGUgaW4gZGF0YS5ldmVudHMpIHsKICAgICAgICAgICAgICAgIGlmIChzcGVjaWFsW3R5cGVdKSB7CiAgICAgICAgICAgICAgICAgIGpRdWVyeS5ldmVudC5yZW1vdmUoZWxlbSwgdHlwZSk7ICAvLyBUaGlzIGlzIGEgc2hvcnRjdXQgdG8gYXZvaWQgalF1ZXJ5LmV2ZW50LnJlbW92ZSdzIG92ZXJoZWFkCiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBqUXVlcnkucmVtb3ZlRXZlbnQoZWxlbSwgdHlwZSwgZGF0YS5oYW5kbGUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZGF0YV9wcml2LmNhY2hlW2tleV0pIHsKICAgICAgICAgICAgICAvLyBEaXNjYXJkIGFueSByZW1haW5pbmcgYHByaXZhdGVgIGRhdGEKICAgICAgICAgICAgICBkZWxldGUgZGF0YV9wcml2LmNhY2hlW2tleV07CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgLy8gRGlzY2FyZCBhbnkgcmVtYWluaW5nIGB1c2VyYCBkYXRhCiAgICAgICAgZGVsZXRlIGRhdGFfdXNlci5jYWNoZVtlbGVtW2RhdGFfdXNlci5leHBhbmRvXV07CiAgICAgIH0KICAgIH0KICB9KTsKICBqUXVlcnkuZm4uZXh0ZW5kKHsKICAgIHRleHQ6IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICByZXR1cm4gYWNjZXNzKHRoaXMsIGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgIHJldHVybiB2YWx1ZSA9PT0gdW5kZWZpbmVkID8galF1ZXJ5LnRleHQodGhpcykgOiB0aGlzLmVtcHR5KCkuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICBpZiAodGhpcy5ub2RlVHlwZSA9PT0gMSB8fCB0aGlzLm5vZGVUeXBlID09PSAxMSB8fCB0aGlzLm5vZGVUeXBlID09PSA5KSB7CiAgICAgICAgICAgIHRoaXMudGV4dENvbnRlbnQgPSB2YWx1ZTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfSwgbnVsbCwgdmFsdWUsIGFyZ3VtZW50cy5sZW5ndGgpOwogICAgfSwKICAgIGFwcGVuZDogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gdGhpcy5kb21NYW5pcChhcmd1bWVudHMsIGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgaWYgKHRoaXMubm9kZVR5cGUgPT09IDEgfHwgdGhpcy5ub2RlVHlwZSA9PT0gMTEgfHwgdGhpcy5ub2RlVHlwZSA9PT0gOSkgewogICAgICAgICAgdmFyIHRhcmdldCA9IG1hbmlwdWxhdGlvblRhcmdldCh0aGlzLCBlbGVtKTsKICAgICAgICAgIHRhcmdldC5hcHBlbmRDaGlsZChlbGVtKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSwKICAgIHByZXBlbmQ6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIHRoaXMuZG9tTWFuaXAoYXJndW1lbnRzLCBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgIGlmICh0aGlzLm5vZGVUeXBlID09PSAxIHx8IHRoaXMubm9kZVR5cGUgPT09IDExIHx8IHRoaXMubm9kZVR5cGUgPT09IDkpIHsKICAgICAgICAgIHZhciB0YXJnZXQgPSBtYW5pcHVsYXRpb25UYXJnZXQodGhpcywgZWxlbSk7CiAgICAgICAgICB0YXJnZXQuaW5zZXJ0QmVmb3JlKGVsZW0sIHRhcmdldC5maXJzdENoaWxkKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSwKICAgIGJlZm9yZTogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gdGhpcy5kb21NYW5pcChhcmd1bWVudHMsIGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgaWYgKHRoaXMucGFyZW50Tm9kZSkgewogICAgICAgICAgdGhpcy5wYXJlbnROb2RlLmluc2VydEJlZm9yZShlbGVtLCB0aGlzKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSwKICAgIGFmdGVyOiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiB0aGlzLmRvbU1hbmlwKGFyZ3VtZW50cywgZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICBpZiAodGhpcy5wYXJlbnROb2RlKSB7CiAgICAgICAgICB0aGlzLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKGVsZW0sIHRoaXMubmV4dFNpYmxpbmcpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9LAogICAgcmVtb3ZlOiBmdW5jdGlvbiAoc2VsZWN0b3IsIGtlZXBEYXRhKSB7CiAgICAgIHZhciBlbGVtLCBlbGVtcyA9IHNlbGVjdG9yID8galF1ZXJ5LmZpbHRlcihzZWxlY3RvciwgdGhpcykgOiB0aGlzLCBpID0gMDsKICAgICAgZm9yICg7IChlbGVtID0gZWxlbXNbaV0pICE9IG51bGw7IGkrKykgewogICAgICAgIGlmICgha2VlcERhdGEgJiYgZWxlbS5ub2RlVHlwZSA9PT0gMSkgewogICAgICAgICAgalF1ZXJ5LmNsZWFuRGF0YShnZXRBbGwoZWxlbSkpOwogICAgICAgIH0KICAgICAgICBpZiAoZWxlbS5wYXJlbnROb2RlKSB7CiAgICAgICAgICBpZiAoa2VlcERhdGEgJiYgalF1ZXJ5LmNvbnRhaW5zKGVsZW0ub3duZXJEb2N1bWVudCwgZWxlbSkpIHsKICAgICAgICAgICAgc2V0R2xvYmFsRXZhbChnZXRBbGwoZWxlbSwgJ3NjcmlwdCcpKTsKICAgICAgICAgIH0KICAgICAgICAgIGVsZW0ucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChlbGVtKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogICAgZW1wdHk6IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIGVsZW0sIGkgPSAwOwogICAgICBmb3IgKDsgKGVsZW0gPSB0aGlzW2ldKSAhPSBudWxsOyBpKyspIHsKICAgICAgICBpZiAoZWxlbS5ub2RlVHlwZSA9PT0gMSkgewogICAgICAgICAgLy8gUHJldmVudCBtZW1vcnkgbGVha3MKICAgICAgICAgIGpRdWVyeS5jbGVhbkRhdGEoZ2V0QWxsKGVsZW0sIGZhbHNlKSk7CiAgICAgICAgICAvLyBSZW1vdmUgYW55IHJlbWFpbmluZyBub2RlcwogICAgICAgICAgZWxlbS50ZXh0Q29udGVudCA9ICcnOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgICBjbG9uZTogZnVuY3Rpb24gKGRhdGFBbmRFdmVudHMsIGRlZXBEYXRhQW5kRXZlbnRzKSB7CiAgICAgIGRhdGFBbmRFdmVudHMgPSBkYXRhQW5kRXZlbnRzID09IG51bGwgPyBmYWxzZSA6IGRhdGFBbmRFdmVudHM7CiAgICAgIGRlZXBEYXRhQW5kRXZlbnRzID0gZGVlcERhdGFBbmRFdmVudHMgPT0gbnVsbCA/IGRhdGFBbmRFdmVudHMgOiBkZWVwRGF0YUFuZEV2ZW50czsKICAgICAgcmV0dXJuIHRoaXMubWFwKGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4galF1ZXJ5LmNsb25lKHRoaXMsIGRhdGFBbmRFdmVudHMsIGRlZXBEYXRhQW5kRXZlbnRzKTsKICAgICAgfSk7CiAgICB9LAogICAgaHRtbDogZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgIHJldHVybiBhY2Nlc3ModGhpcywgZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgdmFyIGVsZW0gPSB0aGlzWzBdIHx8IHt9LCBpID0gMCwgbCA9IHRoaXMubGVuZ3RoOwogICAgICAgIGlmICh2YWx1ZSA9PT0gdW5kZWZpbmVkICYmIGVsZW0ubm9kZVR5cGUgPT09IDEpIHsKICAgICAgICAgIHJldHVybiBlbGVtLmlubmVySFRNTDsKICAgICAgICB9CiAgICAgICAgLy8gU2VlIGlmIHdlIGNhbiB0YWtlIGEgc2hvcnRjdXQgYW5kIGp1c3QgdXNlIGlubmVySFRNTAogICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICdzdHJpbmcnICYmICFybm9Jbm5lcmh0bWwudGVzdCh2YWx1ZSkgJiYgIXdyYXBNYXBbKHJ0YWdOYW1lLmV4ZWModmFsdWUpIHx8IFsKICAgICAgICAgICAgJycsCiAgICAgICAgICAgICcnCiAgICAgICAgICBdKVsxXS50b0xvd2VyQ2FzZSgpXSkgewogICAgICAgICAgdmFsdWUgPSB2YWx1ZS5yZXBsYWNlKHJ4aHRtbFRhZywgJzwkMT48LyQyPicpOwogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgZm9yICg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgICAgICBlbGVtID0gdGhpc1tpXSB8fCB7fTsKICAgICAgICAgICAgICAvLyBSZW1vdmUgZWxlbWVudCBub2RlcyBhbmQgcHJldmVudCBtZW1vcnkgbGVha3MKICAgICAgICAgICAgICBpZiAoZWxlbS5ub2RlVHlwZSA9PT0gMSkgewogICAgICAgICAgICAgICAgalF1ZXJ5LmNsZWFuRGF0YShnZXRBbGwoZWxlbSwgZmFsc2UpKTsKICAgICAgICAgICAgICAgIGVsZW0uaW5uZXJIVE1MID0gdmFsdWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsZW0gPSAwOyAgLy8gSWYgdXNpbmcgaW5uZXJIVE1MIHRocm93cyBhbiBleGNlcHRpb24sIHVzZSB0aGUgZmFsbGJhY2sgbWV0aG9kCiAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChlbGVtKSB7CiAgICAgICAgICB0aGlzLmVtcHR5KCkuYXBwZW5kKHZhbHVlKTsKICAgICAgICB9CiAgICAgIH0sIG51bGwsIHZhbHVlLCBhcmd1bWVudHMubGVuZ3RoKTsKICAgIH0sCiAgICByZXBsYWNlV2l0aDogZnVuY3Rpb24gKCkgewogICAgICB2YXIgYXJnID0gYXJndW1lbnRzWzBdOwogICAgICAvLyBNYWtlIHRoZSBjaGFuZ2VzLCByZXBsYWNpbmcgZWFjaCBjb250ZXh0IGVsZW1lbnQgd2l0aCB0aGUgbmV3IGNvbnRlbnQKICAgICAgdGhpcy5kb21NYW5pcChhcmd1bWVudHMsIGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgYXJnID0gdGhpcy5wYXJlbnROb2RlOwogICAgICAgIGpRdWVyeS5jbGVhbkRhdGEoZ2V0QWxsKHRoaXMpKTsKICAgICAgICBpZiAoYXJnKSB7CiAgICAgICAgICBhcmcucmVwbGFjZUNoaWxkKGVsZW0sIHRoaXMpOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIC8vIEZvcmNlIHJlbW92YWwgaWYgdGhlcmUgd2FzIG5vIG5ldyBjb250ZW50IChlLmcuLCBmcm9tIGVtcHR5IGFyZ3VtZW50cykKICAgICAgcmV0dXJuIGFyZyAmJiAoYXJnLmxlbmd0aCB8fCBhcmcubm9kZVR5cGUpID8gdGhpcyA6IHRoaXMucmVtb3ZlKCk7CiAgICB9LAogICAgZGV0YWNoOiBmdW5jdGlvbiAoc2VsZWN0b3IpIHsKICAgICAgcmV0dXJuIHRoaXMucmVtb3ZlKHNlbGVjdG9yLCB0cnVlKTsKICAgIH0sCiAgICBkb21NYW5pcDogZnVuY3Rpb24gKGFyZ3MsIGNhbGxiYWNrKSB7CiAgICAgIC8vIEZsYXR0ZW4gYW55IG5lc3RlZCBhcnJheXMKICAgICAgYXJncyA9IGNvbmNhdC5hcHBseShbXSwgYXJncyk7CiAgICAgIHZhciBmcmFnbWVudCwgZmlyc3QsIHNjcmlwdHMsIGhhc1NjcmlwdHMsIG5vZGUsIGRvYywgaSA9IDAsIGwgPSB0aGlzLmxlbmd0aCwgc2V0ID0gdGhpcywgaU5vQ2xvbmUgPSBsIC0gMSwgdmFsdWUgPSBhcmdzWzBdLCBpc0Z1bmN0aW9uID0galF1ZXJ5LmlzRnVuY3Rpb24odmFsdWUpOwogICAgICAvLyBXZSBjYW4ndCBjbG9uZU5vZGUgZnJhZ21lbnRzIHRoYXQgY29udGFpbiBjaGVja2VkLCBpbiBXZWJLaXQKICAgICAgaWYgKGlzRnVuY3Rpb24gfHwgbCA+IDEgJiYgdHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJyAmJiAhc3VwcG9ydC5jaGVja0Nsb25lICYmIHJjaGVja2VkLnRlc3QodmFsdWUpKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoaW5kZXgpIHsKICAgICAgICAgIHZhciBzZWxmID0gc2V0LmVxKGluZGV4KTsKICAgICAgICAgIGlmIChpc0Z1bmN0aW9uKSB7CiAgICAgICAgICAgIGFyZ3NbMF0gPSB2YWx1ZS5jYWxsKHRoaXMsIGluZGV4LCBzZWxmLmh0bWwoKSk7CiAgICAgICAgICB9CiAgICAgICAgICBzZWxmLmRvbU1hbmlwKGFyZ3MsIGNhbGxiYWNrKTsKICAgICAgICB9KTsKICAgICAgfQogICAgICBpZiAobCkgewogICAgICAgIGZyYWdtZW50ID0galF1ZXJ5LmJ1aWxkRnJhZ21lbnQoYXJncywgdGhpc1swXS5vd25lckRvY3VtZW50LCBmYWxzZSwgdGhpcyk7CiAgICAgICAgZmlyc3QgPSBmcmFnbWVudC5maXJzdENoaWxkOwogICAgICAgIGlmIChmcmFnbWVudC5jaGlsZE5vZGVzLmxlbmd0aCA9PT0gMSkgewogICAgICAgICAgZnJhZ21lbnQgPSBmaXJzdDsKICAgICAgICB9CiAgICAgICAgaWYgKGZpcnN0KSB7CiAgICAgICAgICBzY3JpcHRzID0galF1ZXJ5Lm1hcChnZXRBbGwoZnJhZ21lbnQsICdzY3JpcHQnKSwgZGlzYWJsZVNjcmlwdCk7CiAgICAgICAgICBoYXNTY3JpcHRzID0gc2NyaXB0cy5sZW5ndGg7CiAgICAgICAgICAvLyBVc2UgdGhlIG9yaWdpbmFsIGZyYWdtZW50IGZvciB0aGUgbGFzdCBpdGVtIGluc3RlYWQgb2YgdGhlIGZpcnN0IGJlY2F1c2UgaXQgY2FuIGVuZCB1cAogICAgICAgICAgLy8gYmVpbmcgZW1wdGllZCBpbmNvcnJlY3RseSBpbiBjZXJ0YWluIHNpdHVhdGlvbnMgKCM4MDcwKS4KICAgICAgICAgIGZvciAoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgICAgIG5vZGUgPSBmcmFnbWVudDsKICAgICAgICAgICAgaWYgKGkgIT09IGlOb0Nsb25lKSB7CiAgICAgICAgICAgICAgbm9kZSA9IGpRdWVyeS5jbG9uZShub2RlLCB0cnVlLCB0cnVlKTsKICAgICAgICAgICAgICAvLyBLZWVwIHJlZmVyZW5jZXMgdG8gY2xvbmVkIHNjcmlwdHMgZm9yIGxhdGVyIHJlc3RvcmF0aW9uCiAgICAgICAgICAgICAgaWYgKGhhc1NjcmlwdHMpIHsKICAgICAgICAgICAgICAgIC8vIFN1cHBvcnQ6IFF0V2ViS2l0CiAgICAgICAgICAgICAgICAvLyBqUXVlcnkubWVyZ2UgYmVjYXVzZSBwdXNoLmFwcGx5KF8sIGFycmF5bGlrZSkgdGhyb3dzCiAgICAgICAgICAgICAgICBqUXVlcnkubWVyZ2Uoc2NyaXB0cywgZ2V0QWxsKG5vZGUsICdzY3JpcHQnKSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhbGxiYWNrLmNhbGwodGhpc1tpXSwgbm9kZSwgaSk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaGFzU2NyaXB0cykgewogICAgICAgICAgICBkb2MgPSBzY3JpcHRzW3NjcmlwdHMubGVuZ3RoIC0gMV0ub3duZXJEb2N1bWVudDsKICAgICAgICAgICAgLy8gUmVlbmFibGUgc2NyaXB0cwogICAgICAgICAgICBqUXVlcnkubWFwKHNjcmlwdHMsIHJlc3RvcmVTY3JpcHQpOwogICAgICAgICAgICAvLyBFdmFsdWF0ZSBleGVjdXRhYmxlIHNjcmlwdHMgb24gZmlyc3QgZG9jdW1lbnQgaW5zZXJ0aW9uCiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBoYXNTY3JpcHRzOyBpKyspIHsKICAgICAgICAgICAgICBub2RlID0gc2NyaXB0c1tpXTsKICAgICAgICAgICAgICBpZiAocnNjcmlwdFR5cGUudGVzdChub2RlLnR5cGUgfHwgJycpICYmICFkYXRhX3ByaXYuYWNjZXNzKG5vZGUsICdnbG9iYWxFdmFsJykgJiYgalF1ZXJ5LmNvbnRhaW5zKGRvYywgbm9kZSkpIHsKICAgICAgICAgICAgICAgIGlmIChub2RlLnNyYykgewogICAgICAgICAgICAgICAgICAvLyBPcHRpb25hbCBBSkFYIGRlcGVuZGVuY3ksIGJ1dCB3b24ndCBydW4gc2NyaXB0cyBpZiBub3QgcHJlc2VudAogICAgICAgICAgICAgICAgICBpZiAoalF1ZXJ5Ll9ldmFsVXJsKSB7CiAgICAgICAgICAgICAgICAgICAgalF1ZXJ5Ll9ldmFsVXJsKG5vZGUuc3JjKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgalF1ZXJ5Lmdsb2JhbEV2YWwobm9kZS50ZXh0Q29udGVudC5yZXBsYWNlKHJjbGVhblNjcmlwdCwgJycpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgfSk7CiAgalF1ZXJ5LmVhY2goewogICAgYXBwZW5kVG86ICdhcHBlbmQnLAogICAgcHJlcGVuZFRvOiAncHJlcGVuZCcsCiAgICBpbnNlcnRCZWZvcmU6ICdiZWZvcmUnLAogICAgaW5zZXJ0QWZ0ZXI6ICdhZnRlcicsCiAgICByZXBsYWNlQWxsOiAncmVwbGFjZVdpdGgnCiAgfSwgZnVuY3Rpb24gKG5hbWUsIG9yaWdpbmFsKSB7CiAgICBqUXVlcnkuZm5bbmFtZV0gPSBmdW5jdGlvbiAoc2VsZWN0b3IpIHsKICAgICAgdmFyIGVsZW1zLCByZXQgPSBbXSwgaW5zZXJ0ID0galF1ZXJ5KHNlbGVjdG9yKSwgbGFzdCA9IGluc2VydC5sZW5ndGggLSAxLCBpID0gMDsKICAgICAgZm9yICg7IGkgPD0gbGFzdDsgaSsrKSB7CiAgICAgICAgZWxlbXMgPSBpID09PSBsYXN0ID8gdGhpcyA6IHRoaXMuY2xvbmUodHJ1ZSk7CiAgICAgICAgalF1ZXJ5KGluc2VydFtpXSlbb3JpZ2luYWxdKGVsZW1zKTsKICAgICAgICAvLyBTdXBwb3J0OiBRdFdlYktpdAogICAgICAgIC8vIC5nZXQoKSBiZWNhdXNlIHB1c2guYXBwbHkoXywgYXJyYXlsaWtlKSB0aHJvd3MKICAgICAgICBwdXNoLmFwcGx5KHJldCwgZWxlbXMuZ2V0KCkpOwogICAgICB9CiAgICAgIHJldHVybiB0aGlzLnB1c2hTdGFjayhyZXQpOwogICAgfTsKICB9KTsKICB2YXIgaWZyYW1lLCBlbGVtZGlzcGxheSA9IHt9OwogIC8qKgogICAqIFJldHJpZXZlIHRoZSBhY3R1YWwgZGlzcGxheSBvZiBhIGVsZW1lbnQKICAgKiBAcGFyYW0ge1N0cmluZ30gbmFtZSBub2RlTmFtZSBvZiB0aGUgZWxlbWVudAogICAqIEBwYXJhbSB7T2JqZWN0fSBkb2MgRG9jdW1lbnQgb2JqZWN0CiAgICovCiAgLy8gQ2FsbGVkIG9ubHkgZnJvbSB3aXRoaW4gZGVmYXVsdERpc3BsYXkKICBmdW5jdGlvbiBhY3R1YWxEaXNwbGF5KG5hbWUsIGRvYykgewogICAgdmFyIHN0eWxlLCBlbGVtID0galF1ZXJ5KGRvYy5jcmVhdGVFbGVtZW50KG5hbWUpKS5hcHBlbmRUbyhkb2MuYm9keSksCiAgICAgIC8vIGdldERlZmF1bHRDb21wdXRlZFN0eWxlIG1pZ2h0IGJlIHJlbGlhYmx5IHVzZWQgb25seSBvbiBhdHRhY2hlZCBlbGVtZW50CiAgICAgIGRpc3BsYXkgPSB3aW5kb3cuZ2V0RGVmYXVsdENvbXB1dGVkU3R5bGUgJiYgKHN0eWxlID0gd2luZG93LmdldERlZmF1bHRDb21wdXRlZFN0eWxlKGVsZW1bMF0pKSA/IC8vIFVzZSBvZiB0aGlzIG1ldGhvZCBpcyBhIHRlbXBvcmFyeSBmaXggKG1vcmUgbGlrZSBvcHRtaXphdGlvbikgdW50aWwgc29tZXRoaW5nIGJldHRlciBjb21lcyBhbG9uZywKICAgICAgLy8gc2luY2UgaXQgd2FzIHJlbW92ZWQgZnJvbSBzcGVjaWZpY2F0aW9uIGFuZCBzdXBwb3J0ZWQgb25seSBpbiBGRgogICAgICBzdHlsZS5kaXNwbGF5IDogalF1ZXJ5LmNzcyhlbGVtWzBdLCAnZGlzcGxheScpOwogICAgLy8gV2UgZG9uJ3QgaGF2ZSBhbnkgZGF0YSBzdG9yZWQgb24gdGhlIGVsZW1lbnQsCiAgICAvLyBzbyB1c2UgImRldGFjaCIgbWV0aG9kIGFzIGZhc3Qgd2F5IHRvIGdldCByaWQgb2YgdGhlIGVsZW1lbnQKICAgIGVsZW0uZGV0YWNoKCk7CiAgICByZXR1cm4gZGlzcGxheTsKICB9CiAgLyoqCiAgICogVHJ5IHRvIGRldGVybWluZSB0aGUgZGVmYXVsdCBkaXNwbGF5IHZhbHVlIG9mIGFuIGVsZW1lbnQKICAgKiBAcGFyYW0ge1N0cmluZ30gbm9kZU5hbWUKICAgKi8KICBmdW5jdGlvbiBkZWZhdWx0RGlzcGxheShub2RlTmFtZSkgewogICAgdmFyIGRvYyA9IGRvY3VtZW50LCBkaXNwbGF5ID0gZWxlbWRpc3BsYXlbbm9kZU5hbWVdOwogICAgaWYgKCFkaXNwbGF5KSB7CiAgICAgIGRpc3BsYXkgPSBhY3R1YWxEaXNwbGF5KG5vZGVOYW1lLCBkb2MpOwogICAgICAvLyBJZiB0aGUgc2ltcGxlIHdheSBmYWlscywgcmVhZCBmcm9tIGluc2lkZSBhbiBpZnJhbWUKICAgICAgaWYgKGRpc3BsYXkgPT09ICdub25lJyB8fCAhZGlzcGxheSkgewogICAgICAgIC8vIFVzZSB0aGUgYWxyZWFkeS1jcmVhdGVkIGlmcmFtZSBpZiBwb3NzaWJsZQogICAgICAgIGlmcmFtZSA9IChpZnJhbWUgfHwgalF1ZXJ5KCc8aWZyYW1lIGZyYW1lYm9yZGVyPVwnMFwnIHdpZHRoPVwnMFwnIGhlaWdodD1cJzBcJy8+JykpLmFwcGVuZFRvKGRvYy5kb2N1bWVudEVsZW1lbnQpOwogICAgICAgIC8vIEFsd2F5cyB3cml0ZSBhIG5ldyBIVE1MIHNrZWxldG9uIHNvIFdlYmtpdCBhbmQgRmlyZWZveCBkb24ndCBjaG9rZSBvbiByZXVzZQogICAgICAgIGRvYyA9IGlmcmFtZVswXS5jb250ZW50RG9jdW1lbnQ7CiAgICAgICAgLy8gU3VwcG9ydDogSUUKICAgICAgICBkb2Mud3JpdGUoKTsKICAgICAgICBkb2MuY2xvc2UoKTsKICAgICAgICBkaXNwbGF5ID0gYWN0dWFsRGlzcGxheShub2RlTmFtZSwgZG9jKTsKICAgICAgICBpZnJhbWUuZGV0YWNoKCk7CiAgICAgIH0KICAgICAgLy8gU3RvcmUgdGhlIGNvcnJlY3QgZGVmYXVsdCBkaXNwbGF5CiAgICAgIGVsZW1kaXNwbGF5W25vZGVOYW1lXSA9IGRpc3BsYXk7CiAgICB9CiAgICByZXR1cm4gZGlzcGxheTsKICB9CiAgdmFyIHJtYXJnaW4gPSAvXm1hcmdpbi87CiAgdmFyIHJudW1ub25weCA9IG5ldyBSZWdFeHAoJ14oJyArIHBudW0gKyAnKSg/IXB4KVthLXolXSskJywgJ2knKTsKICB2YXIgZ2V0U3R5bGVzID0gZnVuY3Rpb24gKGVsZW0pIHsKICAgIHJldHVybiBlbGVtLm93bmVyRG9jdW1lbnQuZGVmYXVsdFZpZXcuZ2V0Q29tcHV0ZWRTdHlsZShlbGVtLCBudWxsKTsKICB9OwogIGZ1bmN0aW9uIGN1ckNTUyhlbGVtLCBuYW1lLCBjb21wdXRlZCkgewogICAgdmFyIHdpZHRoLCBtaW5XaWR0aCwgbWF4V2lkdGgsIHJldCwgc3R5bGUgPSBlbGVtLnN0eWxlOwogICAgY29tcHV0ZWQgPSBjb21wdXRlZCB8fCBnZXRTdHlsZXMoZWxlbSk7CiAgICAvLyBTdXBwb3J0OiBJRTkKICAgIC8vIGdldFByb3BlcnR5VmFsdWUgaXMgb25seSBuZWVkZWQgZm9yIC5jc3MoJ2ZpbHRlcicpIGluIElFOSwgc2VlICMxMjUzNwogICAgaWYgKGNvbXB1dGVkKSB7CiAgICAgIHJldCA9IGNvbXB1dGVkLmdldFByb3BlcnR5VmFsdWUobmFtZSkgfHwgY29tcHV0ZWRbbmFtZV07CiAgICB9CiAgICBpZiAoY29tcHV0ZWQpIHsKICAgICAgaWYgKHJldCA9PT0gJycgJiYgIWpRdWVyeS5jb250YWlucyhlbGVtLm93bmVyRG9jdW1lbnQsIGVsZW0pKSB7CiAgICAgICAgcmV0ID0galF1ZXJ5LnN0eWxlKGVsZW0sIG5hbWUpOwogICAgICB9CiAgICAgIC8vIFN1cHBvcnQ6IGlPUyA8IDYKICAgICAgLy8gQSB0cmlidXRlIHRvIHRoZSAiYXdlc29tZSBoYWNrIGJ5IERlYW4gRWR3YXJkcyIKICAgICAgLy8gaU9TIDwgNiAoYXQgbGVhc3QpIHJldHVybnMgcGVyY2VudGFnZSBmb3IgYSBsYXJnZXIgc2V0IG9mIHZhbHVlcywgYnV0IHdpZHRoIHNlZW1zIHRvIGJlIHJlbGlhYmx5IHBpeGVscwogICAgICAvLyB0aGlzIGlzIGFnYWluc3QgdGhlIENTU09NIGRyYWZ0IHNwZWM6IGh0dHA6Ly9kZXYudzMub3JnL2Nzc3dnL2Nzc29tLyNyZXNvbHZlZC12YWx1ZXMKICAgICAgaWYgKHJudW1ub25weC50ZXN0KHJldCkgJiYgcm1hcmdpbi50ZXN0KG5hbWUpKSB7CiAgICAgICAgLy8gUmVtZW1iZXIgdGhlIG9yaWdpbmFsIHZhbHVlcwogICAgICAgIHdpZHRoID0gc3R5bGUud2lkdGg7CiAgICAgICAgbWluV2lkdGggPSBzdHlsZS5taW5XaWR0aDsKICAgICAgICBtYXhXaWR0aCA9IHN0eWxlLm1heFdpZHRoOwogICAgICAgIC8vIFB1dCBpbiB0aGUgbmV3IHZhbHVlcyB0byBnZXQgYSBjb21wdXRlZCB2YWx1ZSBvdXQKICAgICAgICBzdHlsZS5taW5XaWR0aCA9IHN0eWxlLm1heFdpZHRoID0gc3R5bGUud2lkdGggPSByZXQ7CiAgICAgICAgcmV0ID0gY29tcHV0ZWQud2lkdGg7CiAgICAgICAgLy8gUmV2ZXJ0IHRoZSBjaGFuZ2VkIHZhbHVlcwogICAgICAgIHN0eWxlLndpZHRoID0gd2lkdGg7CiAgICAgICAgc3R5bGUubWluV2lkdGggPSBtaW5XaWR0aDsKICAgICAgICBzdHlsZS5tYXhXaWR0aCA9IG1heFdpZHRoOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gcmV0ICE9PSB1bmRlZmluZWQgPyAvLyBTdXBwb3J0OiBJRQogICAgLy8gSUUgcmV0dXJucyB6SW5kZXggdmFsdWUgYXMgYW4gaW50ZWdlci4KICAgIHJldCArICcnIDogcmV0OwogIH0KICBmdW5jdGlvbiBhZGRHZXRIb29rSWYoY29uZGl0aW9uRm4sIGhvb2tGbikgewogICAgLy8gRGVmaW5lIHRoZSBob29rLCB3ZSdsbCBjaGVjayBvbiB0aGUgZmlyc3QgcnVuIGlmIGl0J3MgcmVhbGx5IG5lZWRlZC4KICAgIHJldHVybiB7CiAgICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIGlmIChjb25kaXRpb25GbigpKSB7CiAgICAgICAgICAvLyBIb29rIG5vdCBuZWVkZWQgKG9yIGl0J3Mgbm90IHBvc3NpYmxlIHRvIHVzZSBpdCBkdWUgdG8gbWlzc2luZyBkZXBlbmRlbmN5KSwKICAgICAgICAgIC8vIHJlbW92ZSBpdC4KICAgICAgICAgIC8vIFNpbmNlIHRoZXJlIGFyZSBubyBvdGhlciBob29rcyBmb3IgbWFyZ2luUmlnaHQsIHJlbW92ZSB0aGUgd2hvbGUgb2JqZWN0LgogICAgICAgICAgZGVsZXRlIHRoaXMuZ2V0OwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICAvLyBIb29rIG5lZWRlZDsgcmVkZWZpbmUgaXQgc28gdGhhdCB0aGUgc3VwcG9ydCB0ZXN0IGlzIG5vdCBleGVjdXRlZCBhZ2Fpbi4KICAgICAgICByZXR1cm4gKHRoaXMuZ2V0ID0gaG9va0ZuKS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9CiAgICB9OwogIH0KICAoZnVuY3Rpb24gKCkgewogICAgdmFyIHBpeGVsUG9zaXRpb25WYWwsIGJveFNpemluZ1JlbGlhYmxlVmFsLCBkb2NFbGVtID0gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LCBjb250YWluZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKSwgZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICBpZiAoIWRpdi5zdHlsZSkgewogICAgICByZXR1cm47CiAgICB9CiAgICBkaXYuc3R5bGUuYmFja2dyb3VuZENsaXAgPSAnY29udGVudC1ib3gnOwogICAgZGl2LmNsb25lTm9kZSh0cnVlKS5zdHlsZS5iYWNrZ3JvdW5kQ2xpcCA9ICcnOwogICAgc3VwcG9ydC5jbGVhckNsb25lU3R5bGUgPSBkaXYuc3R5bGUuYmFja2dyb3VuZENsaXAgPT09ICdjb250ZW50LWJveCc7CiAgICBjb250YWluZXIuc3R5bGUuY3NzVGV4dCA9ICdib3JkZXI6MDt3aWR0aDowO2hlaWdodDowO3RvcDowO2xlZnQ6LTk5OTlweDttYXJnaW4tdG9wOjFweDsnICsgJ3Bvc2l0aW9uOmFic29sdXRlJzsKICAgIGNvbnRhaW5lci5hcHBlbmRDaGlsZChkaXYpOwogICAgLy8gRXhlY3V0aW5nIGJvdGggcGl4ZWxQb3NpdGlvbiAmIGJveFNpemluZ1JlbGlhYmxlIHRlc3RzIHJlcXVpcmUgb25seSBvbmUgbGF5b3V0CiAgICAvLyBzbyB0aGV5J3JlIGV4ZWN1dGVkIGF0IHRoZSBzYW1lIHRpbWUgdG8gc2F2ZSB0aGUgc2Vjb25kIGNvbXB1dGF0aW9uLgogICAgZnVuY3Rpb24gY29tcHV0ZVBpeGVsUG9zaXRpb25BbmRCb3hTaXppbmdSZWxpYWJsZSgpIHsKICAgICAgZGl2LnN0eWxlLmNzc1RleHQgPSAvLyBTdXBwb3J0OiBGaXJlZm94PDI5LCBBbmRyb2lkIDIuMwogICAgICAvLyBWZW5kb3ItcHJlZml4IGJveC1zaXppbmcKICAgICAgJy13ZWJraXQtYm94LXNpemluZzpib3JkZXItYm94Oy1tb3otYm94LXNpemluZzpib3JkZXItYm94OycgKyAnYm94LXNpemluZzpib3JkZXItYm94O2Rpc3BsYXk6YmxvY2s7bWFyZ2luLXRvcDoxJTt0b3A6MSU7JyArICdib3JkZXI6MXB4O3BhZGRpbmc6MXB4O3dpZHRoOjRweDtwb3NpdGlvbjphYnNvbHV0ZSc7CiAgICAgIGRpdi5pbm5lckhUTUwgPSAnJzsKICAgICAgZG9jRWxlbS5hcHBlbmRDaGlsZChjb250YWluZXIpOwogICAgICB2YXIgZGl2U3R5bGUgPSB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZShkaXYsIG51bGwpOwogICAgICBwaXhlbFBvc2l0aW9uVmFsID0gZGl2U3R5bGUudG9wICE9PSAnMSUnOwogICAgICBib3hTaXppbmdSZWxpYWJsZVZhbCA9IGRpdlN0eWxlLndpZHRoID09PSAnNHB4JzsKICAgICAgZG9jRWxlbS5yZW1vdmVDaGlsZChjb250YWluZXIpOwogICAgfQogICAgLy8gU3VwcG9ydDogbm9kZS5qcyBqc2RvbQogICAgLy8gRG9uJ3QgYXNzdW1lIHRoYXQgZ2V0Q29tcHV0ZWRTdHlsZSBpcyBhIHByb3BlcnR5IG9mIHRoZSBnbG9iYWwgb2JqZWN0CiAgICBpZiAod2luZG93LmdldENvbXB1dGVkU3R5bGUpIHsKICAgICAgalF1ZXJ5LmV4dGVuZChzdXBwb3J0LCB7CiAgICAgICAgcGl4ZWxQb3NpdGlvbjogZnVuY3Rpb24gKCkgewogICAgICAgICAgLy8gVGhpcyB0ZXN0IGlzIGV4ZWN1dGVkIG9ubHkgb25jZSBidXQgd2Ugc3RpbGwgZG8gbWVtb2l6aW5nCiAgICAgICAgICAvLyBzaW5jZSB3ZSBjYW4gdXNlIHRoZSBib3hTaXppbmdSZWxpYWJsZSBwcmUtY29tcHV0aW5nLgogICAgICAgICAgLy8gTm8gbmVlZCB0byBjaGVjayBpZiB0aGUgdGVzdCB3YXMgYWxyZWFkeSBwZXJmb3JtZWQsIHRob3VnaC4KICAgICAgICAgIGNvbXB1dGVQaXhlbFBvc2l0aW9uQW5kQm94U2l6aW5nUmVsaWFibGUoKTsKICAgICAgICAgIHJldHVybiBwaXhlbFBvc2l0aW9uVmFsOwogICAgICAgIH0sCiAgICAgICAgYm94U2l6aW5nUmVsaWFibGU6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGlmIChib3hTaXppbmdSZWxpYWJsZVZhbCA9PSBudWxsKSB7CiAgICAgICAgICAgIGNvbXB1dGVQaXhlbFBvc2l0aW9uQW5kQm94U2l6aW5nUmVsaWFibGUoKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBib3hTaXppbmdSZWxpYWJsZVZhbDsKICAgICAgICB9LAogICAgICAgIHJlbGlhYmxlTWFyZ2luUmlnaHQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIC8vIFN1cHBvcnQ6IEFuZHJvaWQgMi4zCiAgICAgICAgICAvLyBDaGVjayBpZiBkaXYgd2l0aCBleHBsaWNpdCB3aWR0aCBhbmQgbm8gbWFyZ2luLXJpZ2h0IGluY29ycmVjdGx5CiAgICAgICAgICAvLyBnZXRzIGNvbXB1dGVkIG1hcmdpbi1yaWdodCBiYXNlZCBvbiB3aWR0aCBvZiBjb250YWluZXIuICgjMzMzMykKICAgICAgICAgIC8vIFdlYktpdCBCdWcgMTMzNDMgLSBnZXRDb21wdXRlZFN0eWxlIHJldHVybnMgd3JvbmcgdmFsdWUgZm9yIG1hcmdpbi1yaWdodAogICAgICAgICAgLy8gVGhpcyBzdXBwb3J0IGZ1bmN0aW9uIGlzIG9ubHkgZXhlY3V0ZWQgb25jZSBzbyBubyBtZW1vaXppbmcgaXMgbmVlZGVkLgogICAgICAgICAgdmFyIHJldCwgbWFyZ2luRGl2ID0gZGl2LmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpKTsKICAgICAgICAgIC8vIFJlc2V0IENTUzogYm94LXNpemluZzsgZGlzcGxheTsgbWFyZ2luOyBib3JkZXI7IHBhZGRpbmcKICAgICAgICAgIG1hcmdpbkRpdi5zdHlsZS5jc3NUZXh0ID0gZGl2LnN0eWxlLmNzc1RleHQgPSAvLyBTdXBwb3J0OiBGaXJlZm94PDI5LCBBbmRyb2lkIDIuMwogICAgICAgICAgLy8gVmVuZG9yLXByZWZpeCBib3gtc2l6aW5nCiAgICAgICAgICAnLXdlYmtpdC1ib3gtc2l6aW5nOmNvbnRlbnQtYm94Oy1tb3otYm94LXNpemluZzpjb250ZW50LWJveDsnICsgJ2JveC1zaXppbmc6Y29udGVudC1ib3g7ZGlzcGxheTpibG9jazttYXJnaW46MDtib3JkZXI6MDtwYWRkaW5nOjAnOwogICAgICAgICAgbWFyZ2luRGl2LnN0eWxlLm1hcmdpblJpZ2h0ID0gbWFyZ2luRGl2LnN0eWxlLndpZHRoID0gJzAnOwogICAgICAgICAgZGl2LnN0eWxlLndpZHRoID0gJzFweCc7CiAgICAgICAgICBkb2NFbGVtLmFwcGVuZENoaWxkKGNvbnRhaW5lcik7CiAgICAgICAgICByZXQgPSAhcGFyc2VGbG9hdCh3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZShtYXJnaW5EaXYsIG51bGwpLm1hcmdpblJpZ2h0KTsKICAgICAgICAgIGRvY0VsZW0ucmVtb3ZlQ2hpbGQoY29udGFpbmVyKTsKICAgICAgICAgIHJldHVybiByZXQ7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICB9KCkpOwogIC8vIEEgbWV0aG9kIGZvciBxdWlja2x5IHN3YXBwaW5nIGluL291dCBDU1MgcHJvcGVydGllcyB0byBnZXQgY29ycmVjdCBjYWxjdWxhdGlvbnMuCiAgalF1ZXJ5LnN3YXAgPSBmdW5jdGlvbiAoZWxlbSwgb3B0aW9ucywgY2FsbGJhY2ssIGFyZ3MpIHsKICAgIHZhciByZXQsIG5hbWUsIG9sZCA9IHt9OwogICAgLy8gUmVtZW1iZXIgdGhlIG9sZCB2YWx1ZXMsIGFuZCBpbnNlcnQgdGhlIG5ldyBvbmVzCiAgICBmb3IgKG5hbWUgaW4gb3B0aW9ucykgewogICAgICBvbGRbbmFtZV0gPSBlbGVtLnN0eWxlW25hbWVdOwogICAgICBlbGVtLnN0eWxlW25hbWVdID0gb3B0aW9uc1tuYW1lXTsKICAgIH0KICAgIHJldCA9IGNhbGxiYWNrLmFwcGx5KGVsZW0sIGFyZ3MgfHwgW10pOwogICAgLy8gUmV2ZXJ0IHRoZSBvbGQgdmFsdWVzCiAgICBmb3IgKG5hbWUgaW4gb3B0aW9ucykgewogICAgICBlbGVtLnN0eWxlW25hbWVdID0gb2xkW25hbWVdOwogICAgfQogICAgcmV0dXJuIHJldDsKICB9OwogIHZhcgogICAgLy8gc3dhcHBhYmxlIGlmIGRpc3BsYXkgaXMgbm9uZSBvciBzdGFydHMgd2l0aCB0YWJsZSBleGNlcHQgInRhYmxlIiwgInRhYmxlLWNlbGwiLCBvciAidGFibGUtY2FwdGlvbiIKICAgIC8vIHNlZSBoZXJlIGZvciBkaXNwbGF5IHZhbHVlczogaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9DU1MvZGlzcGxheQogICAgcmRpc3BsYXlzd2FwID0gL14obm9uZXx0YWJsZSg/IS1jW2VhXSkuKykvLCBybnVtc3BsaXQgPSBuZXcgUmVnRXhwKCdeKCcgKyBwbnVtICsgJykoLiopJCcsICdpJyksIHJyZWxOdW0gPSBuZXcgUmVnRXhwKCdeKFsrLV0pPSgnICsgcG51bSArICcpJywgJ2knKSwgY3NzU2hvdyA9IHsKICAgICAgcG9zaXRpb246ICdhYnNvbHV0ZScsCiAgICAgIHZpc2liaWxpdHk6ICdoaWRkZW4nLAogICAgICBkaXNwbGF5OiAnYmxvY2snCiAgICB9LCBjc3NOb3JtYWxUcmFuc2Zvcm0gPSB7CiAgICAgIGxldHRlclNwYWNpbmc6ICcwJywKICAgICAgZm9udFdlaWdodDogJzQwMCcKICAgIH0sIGNzc1ByZWZpeGVzID0gWwogICAgICAnV2Via2l0JywKICAgICAgJ08nLAogICAgICAnTW96JywKICAgICAgJ21zJwogICAgXTsKICAvLyByZXR1cm4gYSBjc3MgcHJvcGVydHkgbWFwcGVkIHRvIGEgcG90ZW50aWFsbHkgdmVuZG9yIHByZWZpeGVkIHByb3BlcnR5CiAgZnVuY3Rpb24gdmVuZG9yUHJvcE5hbWUoc3R5bGUsIG5hbWUpIHsKICAgIC8vIHNob3J0Y3V0IGZvciBuYW1lcyB0aGF0IGFyZSBub3QgdmVuZG9yIHByZWZpeGVkCiAgICBpZiAobmFtZSBpbiBzdHlsZSkgewogICAgICByZXR1cm4gbmFtZTsKICAgIH0KICAgIC8vIGNoZWNrIGZvciB2ZW5kb3IgcHJlZml4ZWQgbmFtZXMKICAgIHZhciBjYXBOYW1lID0gbmFtZVswXS50b1VwcGVyQ2FzZSgpICsgbmFtZS5zbGljZSgxKSwgb3JpZ05hbWUgPSBuYW1lLCBpID0gY3NzUHJlZml4ZXMubGVuZ3RoOwogICAgd2hpbGUgKGktLSkgewogICAgICBuYW1lID0gY3NzUHJlZml4ZXNbaV0gKyBjYXBOYW1lOwogICAgICBpZiAobmFtZSBpbiBzdHlsZSkgewogICAgICAgIHJldHVybiBuYW1lOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gb3JpZ05hbWU7CiAgfQogIGZ1bmN0aW9uIHNldFBvc2l0aXZlTnVtYmVyKGVsZW0sIHZhbHVlLCBzdWJ0cmFjdCkgewogICAgdmFyIG1hdGNoZXMgPSBybnVtc3BsaXQuZXhlYyh2YWx1ZSk7CiAgICByZXR1cm4gbWF0Y2hlcyA/IC8vIEd1YXJkIGFnYWluc3QgdW5kZWZpbmVkICJzdWJ0cmFjdCIsIGUuZy4sIHdoZW4gdXNlZCBhcyBpbiBjc3NIb29rcwogICAgTWF0aC5tYXgoMCwgbWF0Y2hlc1sxXSAtIChzdWJ0cmFjdCB8fCAwKSkgKyAobWF0Y2hlc1syXSB8fCAncHgnKSA6IHZhbHVlOwogIH0KICBmdW5jdGlvbiBhdWdtZW50V2lkdGhPckhlaWdodChlbGVtLCBuYW1lLCBleHRyYSwgaXNCb3JkZXJCb3gsIHN0eWxlcykgewogICAgdmFyIGkgPSBleHRyYSA9PT0gKGlzQm9yZGVyQm94ID8gJ2JvcmRlcicgOiAnY29udGVudCcpID8gLy8gSWYgd2UgYWxyZWFkeSBoYXZlIHRoZSByaWdodCBtZWFzdXJlbWVudCwgYXZvaWQgYXVnbWVudGF0aW9uCiAgICAgIDQgOiAvLyBPdGhlcndpc2UgaW5pdGlhbGl6ZSBmb3IgaG9yaXpvbnRhbCBvciB2ZXJ0aWNhbCBwcm9wZXJ0aWVzCiAgICAgIG5hbWUgPT09ICd3aWR0aCcgPyAxIDogMCwgdmFsID0gMDsKICAgIGZvciAoOyBpIDwgNDsgaSArPSAyKSB7CiAgICAgIC8vIGJvdGggYm94IG1vZGVscyBleGNsdWRlIG1hcmdpbiwgc28gYWRkIGl0IGlmIHdlIHdhbnQgaXQKICAgICAgaWYgKGV4dHJhID09PSAnbWFyZ2luJykgewogICAgICAgIHZhbCArPSBqUXVlcnkuY3NzKGVsZW0sIGV4dHJhICsgY3NzRXhwYW5kW2ldLCB0cnVlLCBzdHlsZXMpOwogICAgICB9CiAgICAgIGlmIChpc0JvcmRlckJveCkgewogICAgICAgIC8vIGJvcmRlci1ib3ggaW5jbHVkZXMgcGFkZGluZywgc28gcmVtb3ZlIGl0IGlmIHdlIHdhbnQgY29udGVudAogICAgICAgIGlmIChleHRyYSA9PT0gJ2NvbnRlbnQnKSB7CiAgICAgICAgICB2YWwgLT0galF1ZXJ5LmNzcyhlbGVtLCAncGFkZGluZycgKyBjc3NFeHBhbmRbaV0sIHRydWUsIHN0eWxlcyk7CiAgICAgICAgfQogICAgICAgIC8vIGF0IHRoaXMgcG9pbnQsIGV4dHJhIGlzbid0IGJvcmRlciBub3IgbWFyZ2luLCBzbyByZW1vdmUgYm9yZGVyCiAgICAgICAgaWYgKGV4dHJhICE9PSAnbWFyZ2luJykgewogICAgICAgICAgdmFsIC09IGpRdWVyeS5jc3MoZWxlbSwgJ2JvcmRlcicgKyBjc3NFeHBhbmRbaV0gKyAnV2lkdGgnLCB0cnVlLCBzdHlsZXMpOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBhdCB0aGlzIHBvaW50LCBleHRyYSBpc24ndCBjb250ZW50LCBzbyBhZGQgcGFkZGluZwogICAgICAgIHZhbCArPSBqUXVlcnkuY3NzKGVsZW0sICdwYWRkaW5nJyArIGNzc0V4cGFuZFtpXSwgdHJ1ZSwgc3R5bGVzKTsKICAgICAgICAvLyBhdCB0aGlzIHBvaW50LCBleHRyYSBpc24ndCBjb250ZW50IG5vciBwYWRkaW5nLCBzbyBhZGQgYm9yZGVyCiAgICAgICAgaWYgKGV4dHJhICE9PSAncGFkZGluZycpIHsKICAgICAgICAgIHZhbCArPSBqUXVlcnkuY3NzKGVsZW0sICdib3JkZXInICsgY3NzRXhwYW5kW2ldICsgJ1dpZHRoJywgdHJ1ZSwgc3R5bGVzKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIHJldHVybiB2YWw7CiAgfQogIGZ1bmN0aW9uIGdldFdpZHRoT3JIZWlnaHQoZWxlbSwgbmFtZSwgZXh0cmEpIHsKICAgIC8vIFN0YXJ0IHdpdGggb2Zmc2V0IHByb3BlcnR5LCB3aGljaCBpcyBlcXVpdmFsZW50IHRvIHRoZSBib3JkZXItYm94IHZhbHVlCiAgICB2YXIgdmFsdWVJc0JvcmRlckJveCA9IHRydWUsIHZhbCA9IG5hbWUgPT09ICd3aWR0aCcgPyBlbGVtLm9mZnNldFdpZHRoIDogZWxlbS5vZmZzZXRIZWlnaHQsIHN0eWxlcyA9IGdldFN0eWxlcyhlbGVtKSwgaXNCb3JkZXJCb3ggPSBqUXVlcnkuY3NzKGVsZW0sICdib3hTaXppbmcnLCBmYWxzZSwgc3R5bGVzKSA9PT0gJ2JvcmRlci1ib3gnOwogICAgLy8gc29tZSBub24taHRtbCBlbGVtZW50cyByZXR1cm4gdW5kZWZpbmVkIGZvciBvZmZzZXRXaWR0aCwgc28gY2hlY2sgZm9yIG51bGwvdW5kZWZpbmVkCiAgICAvLyBzdmcgLSBodHRwczovL2J1Z3ppbGxhLm1vemlsbGEub3JnL3Nob3dfYnVnLmNnaT9pZD02NDkyODUKICAgIC8vIE1hdGhNTCAtIGh0dHBzOi8vYnVnemlsbGEubW96aWxsYS5vcmcvc2hvd19idWcuY2dpP2lkPTQ5MTY2OAogICAgaWYgKHZhbCA8PSAwIHx8IHZhbCA9PSBudWxsKSB7CiAgICAgIC8vIEZhbGwgYmFjayB0byBjb21wdXRlZCB0aGVuIHVuY29tcHV0ZWQgY3NzIGlmIG5lY2Vzc2FyeQogICAgICB2YWwgPSBjdXJDU1MoZWxlbSwgbmFtZSwgc3R5bGVzKTsKICAgICAgaWYgKHZhbCA8IDAgfHwgdmFsID09IG51bGwpIHsKICAgICAgICB2YWwgPSBlbGVtLnN0eWxlW25hbWVdOwogICAgICB9CiAgICAgIC8vIENvbXB1dGVkIHVuaXQgaXMgbm90IHBpeGVscy4gU3RvcCBoZXJlIGFuZCByZXR1cm4uCiAgICAgIGlmIChybnVtbm9ucHgudGVzdCh2YWwpKSB7CiAgICAgICAgcmV0dXJuIHZhbDsKICAgICAgfQogICAgICAvLyB3ZSBuZWVkIHRoZSBjaGVjayBmb3Igc3R5bGUgaW4gY2FzZSBhIGJyb3dzZXIgd2hpY2ggcmV0dXJucyB1bnJlbGlhYmxlIHZhbHVlcwogICAgICAvLyBmb3IgZ2V0Q29tcHV0ZWRTdHlsZSBzaWxlbnRseSBmYWxscyBiYWNrIHRvIHRoZSByZWxpYWJsZSBlbGVtLnN0eWxlCiAgICAgIHZhbHVlSXNCb3JkZXJCb3ggPSBpc0JvcmRlckJveCAmJiAoc3VwcG9ydC5ib3hTaXppbmdSZWxpYWJsZSgpIHx8IHZhbCA9PT0gZWxlbS5zdHlsZVtuYW1lXSk7CiAgICAgIC8vIE5vcm1hbGl6ZSAiIiwgYXV0bywgYW5kIHByZXBhcmUgZm9yIGV4dHJhCiAgICAgIHZhbCA9IHBhcnNlRmxvYXQodmFsKSB8fCAwOwogICAgfQogICAgLy8gdXNlIHRoZSBhY3RpdmUgYm94LXNpemluZyBtb2RlbCB0byBhZGQvc3VidHJhY3QgaXJyZWxldmFudCBzdHlsZXMKICAgIHJldHVybiB2YWwgKyBhdWdtZW50V2lkdGhPckhlaWdodChlbGVtLCBuYW1lLCBleHRyYSB8fCAoaXNCb3JkZXJCb3ggPyAnYm9yZGVyJyA6ICdjb250ZW50JyksIHZhbHVlSXNCb3JkZXJCb3gsIHN0eWxlcykgKyAncHgnOwogIH0KICBmdW5jdGlvbiBzaG93SGlkZShlbGVtZW50cywgc2hvdykgewogICAgdmFyIGRpc3BsYXksIGVsZW0sIGhpZGRlbiwgdmFsdWVzID0gW10sIGluZGV4ID0gMCwgbGVuZ3RoID0gZWxlbWVudHMubGVuZ3RoOwogICAgZm9yICg7IGluZGV4IDwgbGVuZ3RoOyBpbmRleCsrKSB7CiAgICAgIGVsZW0gPSBlbGVtZW50c1tpbmRleF07CiAgICAgIGlmICghZWxlbS5zdHlsZSkgewogICAgICAgIGNvbnRpbnVlOwogICAgICB9CiAgICAgIHZhbHVlc1tpbmRleF0gPSBkYXRhX3ByaXYuZ2V0KGVsZW0sICdvbGRkaXNwbGF5Jyk7CiAgICAgIGRpc3BsYXkgPSBlbGVtLnN0eWxlLmRpc3BsYXk7CiAgICAgIGlmIChzaG93KSB7CiAgICAgICAgLy8gUmVzZXQgdGhlIGlubGluZSBkaXNwbGF5IG9mIHRoaXMgZWxlbWVudCB0byBsZWFybiBpZiBpdCBpcwogICAgICAgIC8vIGJlaW5nIGhpZGRlbiBieSBjYXNjYWRlZCBydWxlcyBvciBub3QKICAgICAgICBpZiAoIXZhbHVlc1tpbmRleF0gJiYgZGlzcGxheSA9PT0gJ25vbmUnKSB7CiAgICAgICAgICBlbGVtLnN0eWxlLmRpc3BsYXkgPSAnJzsKICAgICAgICB9CiAgICAgICAgLy8gU2V0IGVsZW1lbnRzIHdoaWNoIGhhdmUgYmVlbiBvdmVycmlkZGVuIHdpdGggZGlzcGxheTogbm9uZQogICAgICAgIC8vIGluIGEgc3R5bGVzaGVldCB0byB3aGF0ZXZlciB0aGUgZGVmYXVsdCBicm93c2VyIHN0eWxlIGlzCiAgICAgICAgLy8gZm9yIHN1Y2ggYW4gZWxlbWVudAogICAgICAgIGlmIChlbGVtLnN0eWxlLmRpc3BsYXkgPT09ICcnICYmIGlzSGlkZGVuKGVsZW0pKSB7CiAgICAgICAgICB2YWx1ZXNbaW5kZXhdID0gZGF0YV9wcml2LmFjY2VzcyhlbGVtLCAnb2xkZGlzcGxheScsIGRlZmF1bHREaXNwbGF5KGVsZW0ubm9kZU5hbWUpKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaGlkZGVuID0gaXNIaWRkZW4oZWxlbSk7CiAgICAgICAgaWYgKGRpc3BsYXkgIT09ICdub25lJyB8fCAhaGlkZGVuKSB7CiAgICAgICAgICBkYXRhX3ByaXYuc2V0KGVsZW0sICdvbGRkaXNwbGF5JywgaGlkZGVuID8gZGlzcGxheSA6IGpRdWVyeS5jc3MoZWxlbSwgJ2Rpc3BsYXknKSk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICAvLyBTZXQgdGhlIGRpc3BsYXkgb2YgbW9zdCBvZiB0aGUgZWxlbWVudHMgaW4gYSBzZWNvbmQgbG9vcAogICAgLy8gdG8gYXZvaWQgdGhlIGNvbnN0YW50IHJlZmxvdwogICAgZm9yIChpbmRleCA9IDA7IGluZGV4IDwgbGVuZ3RoOyBpbmRleCsrKSB7CiAgICAgIGVsZW0gPSBlbGVtZW50c1tpbmRleF07CiAgICAgIGlmICghZWxlbS5zdHlsZSkgewogICAgICAgIGNvbnRpbnVlOwogICAgICB9CiAgICAgIGlmICghc2hvdyB8fCBlbGVtLnN0eWxlLmRpc3BsYXkgPT09ICdub25lJyB8fCBlbGVtLnN0eWxlLmRpc3BsYXkgPT09ICcnKSB7CiAgICAgICAgZWxlbS5zdHlsZS5kaXNwbGF5ID0gc2hvdyA/IHZhbHVlc1tpbmRleF0gfHwgJycgOiAnbm9uZSc7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBlbGVtZW50czsKICB9CiAgalF1ZXJ5LmV4dGVuZCh7CiAgICAvLyBBZGQgaW4gc3R5bGUgcHJvcGVydHkgaG9va3MgZm9yIG92ZXJyaWRpbmcgdGhlIGRlZmF1bHQKICAgIC8vIGJlaGF2aW9yIG9mIGdldHRpbmcgYW5kIHNldHRpbmcgYSBzdHlsZSBwcm9wZXJ0eQogICAgY3NzSG9va3M6IHsKICAgICAgb3BhY2l0eTogewogICAgICAgIGdldDogZnVuY3Rpb24gKGVsZW0sIGNvbXB1dGVkKSB7CiAgICAgICAgICBpZiAoY29tcHV0ZWQpIHsKICAgICAgICAgICAgLy8gV2Ugc2hvdWxkIGFsd2F5cyBnZXQgYSBudW1iZXIgYmFjayBmcm9tIG9wYWNpdHkKICAgICAgICAgICAgdmFyIHJldCA9IGN1ckNTUyhlbGVtLCAnb3BhY2l0eScpOwogICAgICAgICAgICByZXR1cm4gcmV0ID09PSAnJyA/ICcxJyA6IHJldDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICAvLyBEb24ndCBhdXRvbWF0aWNhbGx5IGFkZCAicHgiIHRvIHRoZXNlIHBvc3NpYmx5LXVuaXRsZXNzIHByb3BlcnRpZXMKICAgIGNzc051bWJlcjogewogICAgICAnY29sdW1uQ291bnQnOiB0cnVlLAogICAgICAnZmlsbE9wYWNpdHknOiB0cnVlLAogICAgICAnZmxleEdyb3cnOiB0cnVlLAogICAgICAnZmxleFNocmluayc6IHRydWUsCiAgICAgICdmb250V2VpZ2h0JzogdHJ1ZSwKICAgICAgJ2xpbmVIZWlnaHQnOiB0cnVlLAogICAgICAnb3BhY2l0eSc6IHRydWUsCiAgICAgICdvcmRlcic6IHRydWUsCiAgICAgICdvcnBoYW5zJzogdHJ1ZSwKICAgICAgJ3dpZG93cyc6IHRydWUsCiAgICAgICd6SW5kZXgnOiB0cnVlLAogICAgICAnem9vbSc6IHRydWUKICAgIH0sCiAgICAvLyBBZGQgaW4gcHJvcGVydGllcyB3aG9zZSBuYW1lcyB5b3Ugd2lzaCB0byBmaXggYmVmb3JlCiAgICAvLyBzZXR0aW5nIG9yIGdldHRpbmcgdGhlIHZhbHVlCiAgICBjc3NQcm9wczogewogICAgICAvLyBub3JtYWxpemUgZmxvYXQgY3NzIHByb3BlcnR5CiAgICAgICdmbG9hdCc6ICdjc3NGbG9hdCcKICAgIH0sCiAgICAvLyBHZXQgYW5kIHNldCB0aGUgc3R5bGUgcHJvcGVydHkgb24gYSBET00gTm9kZQogICAgc3R5bGU6IGZ1bmN0aW9uIChlbGVtLCBuYW1lLCB2YWx1ZSwgZXh0cmEpIHsKICAgICAgLy8gRG9uJ3Qgc2V0IHN0eWxlcyBvbiB0ZXh0IGFuZCBjb21tZW50IG5vZGVzCiAgICAgIGlmICghZWxlbSB8fCBlbGVtLm5vZGVUeXBlID09PSAzIHx8IGVsZW0ubm9kZVR5cGUgPT09IDggfHwgIWVsZW0uc3R5bGUpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgLy8gTWFrZSBzdXJlIHRoYXQgd2UncmUgd29ya2luZyB3aXRoIHRoZSByaWdodCBuYW1lCiAgICAgIHZhciByZXQsIHR5cGUsIGhvb2tzLCBvcmlnTmFtZSA9IGpRdWVyeS5jYW1lbENhc2UobmFtZSksIHN0eWxlID0gZWxlbS5zdHlsZTsKICAgICAgbmFtZSA9IGpRdWVyeS5jc3NQcm9wc1tvcmlnTmFtZV0gfHwgKGpRdWVyeS5jc3NQcm9wc1tvcmlnTmFtZV0gPSB2ZW5kb3JQcm9wTmFtZShzdHlsZSwgb3JpZ05hbWUpKTsKICAgICAgLy8gZ2V0cyBob29rIGZvciB0aGUgcHJlZml4ZWQgdmVyc2lvbgogICAgICAvLyBmb2xsb3dlZCBieSB0aGUgdW5wcmVmaXhlZCB2ZXJzaW9uCiAgICAgIGhvb2tzID0galF1ZXJ5LmNzc0hvb2tzW25hbWVdIHx8IGpRdWVyeS5jc3NIb29rc1tvcmlnTmFtZV07CiAgICAgIC8vIENoZWNrIGlmIHdlJ3JlIHNldHRpbmcgYSB2YWx1ZQogICAgICBpZiAodmFsdWUgIT09IHVuZGVmaW5lZCkgewogICAgICAgIHR5cGUgPSB0eXBlb2YgdmFsdWU7CiAgICAgICAgLy8gY29udmVydCByZWxhdGl2ZSBudW1iZXIgc3RyaW5ncyAoKz0gb3IgLT0pIHRvIHJlbGF0aXZlIG51bWJlcnMuICM3MzQ1CiAgICAgICAgaWYgKHR5cGUgPT09ICdzdHJpbmcnICYmIChyZXQgPSBycmVsTnVtLmV4ZWModmFsdWUpKSkgewogICAgICAgICAgdmFsdWUgPSAocmV0WzFdICsgMSkgKiByZXRbMl0gKyBwYXJzZUZsb2F0KGpRdWVyeS5jc3MoZWxlbSwgbmFtZSkpOwogICAgICAgICAgLy8gRml4ZXMgYnVnICM5MjM3CiAgICAgICAgICB0eXBlID0gJ251bWJlcic7CiAgICAgICAgfQogICAgICAgIC8vIE1ha2Ugc3VyZSB0aGF0IG51bGwgYW5kIE5hTiB2YWx1ZXMgYXJlbid0IHNldC4gU2VlOiAjNzExNgogICAgICAgIGlmICh2YWx1ZSA9PSBudWxsIHx8IHZhbHVlICE9PSB2YWx1ZSkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICAvLyBJZiBhIG51bWJlciB3YXMgcGFzc2VkIGluLCBhZGQgJ3B4JyB0byB0aGUgKGV4Y2VwdCBmb3IgY2VydGFpbiBDU1MgcHJvcGVydGllcykKICAgICAgICBpZiAodHlwZSA9PT0gJ251bWJlcicgJiYgIWpRdWVyeS5jc3NOdW1iZXJbb3JpZ05hbWVdKSB7CiAgICAgICAgICB2YWx1ZSArPSAncHgnOwogICAgICAgIH0KICAgICAgICAvLyBGaXhlcyAjODkwOCwgaXQgY2FuIGJlIGRvbmUgbW9yZSBjb3JyZWN0bHkgYnkgc3BlY2lmeWluZyBzZXR0ZXJzIGluIGNzc0hvb2tzLAogICAgICAgIC8vIGJ1dCBpdCB3b3VsZCBtZWFuIHRvIGRlZmluZSBlaWdodCAoZm9yIGV2ZXJ5IHByb2JsZW1hdGljIHByb3BlcnR5KSBpZGVudGljYWwgZnVuY3Rpb25zCiAgICAgICAgaWYgKCFzdXBwb3J0LmNsZWFyQ2xvbmVTdHlsZSAmJiB2YWx1ZSA9PT0gJycgJiYgbmFtZS5pbmRleE9mKCdiYWNrZ3JvdW5kJykgPT09IDApIHsKICAgICAgICAgIHN0eWxlW25hbWVdID0gJ2luaGVyaXQnOwogICAgICAgIH0KICAgICAgICAvLyBJZiBhIGhvb2sgd2FzIHByb3ZpZGVkLCB1c2UgdGhhdCB2YWx1ZSwgb3RoZXJ3aXNlIGp1c3Qgc2V0IHRoZSBzcGVjaWZpZWQgdmFsdWUKICAgICAgICBpZiAoIWhvb2tzIHx8ICEoJ3NldCcgaW4gaG9va3MpIHx8ICh2YWx1ZSA9IGhvb2tzLnNldChlbGVtLCB2YWx1ZSwgZXh0cmEpKSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICBzdHlsZVtuYW1lXSA9IHZhbHVlOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBJZiBhIGhvb2sgd2FzIHByb3ZpZGVkIGdldCB0aGUgbm9uLWNvbXB1dGVkIHZhbHVlIGZyb20gdGhlcmUKICAgICAgICBpZiAoaG9va3MgJiYgJ2dldCcgaW4gaG9va3MgJiYgKHJldCA9IGhvb2tzLmdldChlbGVtLCBmYWxzZSwgZXh0cmEpKSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICByZXR1cm4gcmV0OwogICAgICAgIH0KICAgICAgICAvLyBPdGhlcndpc2UganVzdCBnZXQgdGhlIHZhbHVlIGZyb20gdGhlIHN0eWxlIG9iamVjdAogICAgICAgIHJldHVybiBzdHlsZVtuYW1lXTsKICAgICAgfQogICAgfSwKICAgIGNzczogZnVuY3Rpb24gKGVsZW0sIG5hbWUsIGV4dHJhLCBzdHlsZXMpIHsKICAgICAgdmFyIHZhbCwgbnVtLCBob29rcywgb3JpZ05hbWUgPSBqUXVlcnkuY2FtZWxDYXNlKG5hbWUpOwogICAgICAvLyBNYWtlIHN1cmUgdGhhdCB3ZSdyZSB3b3JraW5nIHdpdGggdGhlIHJpZ2h0IG5hbWUKICAgICAgbmFtZSA9IGpRdWVyeS5jc3NQcm9wc1tvcmlnTmFtZV0gfHwgKGpRdWVyeS5jc3NQcm9wc1tvcmlnTmFtZV0gPSB2ZW5kb3JQcm9wTmFtZShlbGVtLnN0eWxlLCBvcmlnTmFtZSkpOwogICAgICAvLyBnZXRzIGhvb2sgZm9yIHRoZSBwcmVmaXhlZCB2ZXJzaW9uCiAgICAgIC8vIGZvbGxvd2VkIGJ5IHRoZSB1bnByZWZpeGVkIHZlcnNpb24KICAgICAgaG9va3MgPSBqUXVlcnkuY3NzSG9va3NbbmFtZV0gfHwgalF1ZXJ5LmNzc0hvb2tzW29yaWdOYW1lXTsKICAgICAgLy8gSWYgYSBob29rIHdhcyBwcm92aWRlZCBnZXQgdGhlIGNvbXB1dGVkIHZhbHVlIGZyb20gdGhlcmUKICAgICAgaWYgKGhvb2tzICYmICdnZXQnIGluIGhvb2tzKSB7CiAgICAgICAgdmFsID0gaG9va3MuZ2V0KGVsZW0sIHRydWUsIGV4dHJhKTsKICAgICAgfQogICAgICAvLyBPdGhlcndpc2UsIGlmIGEgd2F5IHRvIGdldCB0aGUgY29tcHV0ZWQgdmFsdWUgZXhpc3RzLCB1c2UgdGhhdAogICAgICBpZiAodmFsID09PSB1bmRlZmluZWQpIHsKICAgICAgICB2YWwgPSBjdXJDU1MoZWxlbSwgbmFtZSwgc3R5bGVzKTsKICAgICAgfQogICAgICAvL2NvbnZlcnQgIm5vcm1hbCIgdG8gY29tcHV0ZWQgdmFsdWUKICAgICAgaWYgKHZhbCA9PT0gJ25vcm1hbCcgJiYgbmFtZSBpbiBjc3NOb3JtYWxUcmFuc2Zvcm0pIHsKICAgICAgICB2YWwgPSBjc3NOb3JtYWxUcmFuc2Zvcm1bbmFtZV07CiAgICAgIH0KICAgICAgLy8gUmV0dXJuLCBjb252ZXJ0aW5nIHRvIG51bWJlciBpZiBmb3JjZWQgb3IgYSBxdWFsaWZpZXIgd2FzIHByb3ZpZGVkIGFuZCB2YWwgbG9va3MgbnVtZXJpYwogICAgICBpZiAoZXh0cmEgPT09ICcnIHx8IGV4dHJhKSB7CiAgICAgICAgbnVtID0gcGFyc2VGbG9hdCh2YWwpOwogICAgICAgIHJldHVybiBleHRyYSA9PT0gdHJ1ZSB8fCBqUXVlcnkuaXNOdW1lcmljKG51bSkgPyBudW0gfHwgMCA6IHZhbDsKICAgICAgfQogICAgICByZXR1cm4gdmFsOwogICAgfQogIH0pOwogIGpRdWVyeS5lYWNoKFsKICAgICdoZWlnaHQnLAogICAgJ3dpZHRoJwogIF0sIGZ1bmN0aW9uIChpLCBuYW1lKSB7CiAgICBqUXVlcnkuY3NzSG9va3NbbmFtZV0gPSB7CiAgICAgIGdldDogZnVuY3Rpb24gKGVsZW0sIGNvbXB1dGVkLCBleHRyYSkgewogICAgICAgIGlmIChjb21wdXRlZCkgewogICAgICAgICAgLy8gY2VydGFpbiBlbGVtZW50cyBjYW4gaGF2ZSBkaW1lbnNpb24gaW5mbyBpZiB3ZSBpbnZpc2libHkgc2hvdyB0aGVtCiAgICAgICAgICAvLyBob3dldmVyLCBpdCBtdXN0IGhhdmUgYSBjdXJyZW50IGRpc3BsYXkgc3R5bGUgdGhhdCB3b3VsZCBiZW5lZml0IGZyb20gdGhpcwogICAgICAgICAgcmV0dXJuIHJkaXNwbGF5c3dhcC50ZXN0KGpRdWVyeS5jc3MoZWxlbSwgJ2Rpc3BsYXknKSkgJiYgZWxlbS5vZmZzZXRXaWR0aCA9PT0gMCA/IGpRdWVyeS5zd2FwKGVsZW0sIGNzc1Nob3csIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIGdldFdpZHRoT3JIZWlnaHQoZWxlbSwgbmFtZSwgZXh0cmEpOwogICAgICAgICAgfSkgOiBnZXRXaWR0aE9ySGVpZ2h0KGVsZW0sIG5hbWUsIGV4dHJhKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIHNldDogZnVuY3Rpb24gKGVsZW0sIHZhbHVlLCBleHRyYSkgewogICAgICAgIHZhciBzdHlsZXMgPSBleHRyYSAmJiBnZXRTdHlsZXMoZWxlbSk7CiAgICAgICAgcmV0dXJuIHNldFBvc2l0aXZlTnVtYmVyKGVsZW0sIHZhbHVlLCBleHRyYSA/IGF1Z21lbnRXaWR0aE9ySGVpZ2h0KGVsZW0sIG5hbWUsIGV4dHJhLCBqUXVlcnkuY3NzKGVsZW0sICdib3hTaXppbmcnLCBmYWxzZSwgc3R5bGVzKSA9PT0gJ2JvcmRlci1ib3gnLCBzdHlsZXMpIDogMCk7CiAgICAgIH0KICAgIH07CiAgfSk7CiAgLy8gU3VwcG9ydDogQW5kcm9pZCAyLjMKICBqUXVlcnkuY3NzSG9va3MubWFyZ2luUmlnaHQgPSBhZGRHZXRIb29rSWYoc3VwcG9ydC5yZWxpYWJsZU1hcmdpblJpZ2h0LCBmdW5jdGlvbiAoZWxlbSwgY29tcHV0ZWQpIHsKICAgIGlmIChjb21wdXRlZCkgewogICAgICAvLyBXZWJLaXQgQnVnIDEzMzQzIC0gZ2V0Q29tcHV0ZWRTdHlsZSByZXR1cm5zIHdyb25nIHZhbHVlIGZvciBtYXJnaW4tcmlnaHQKICAgICAgLy8gV29yayBhcm91bmQgYnkgdGVtcG9yYXJpbHkgc2V0dGluZyBlbGVtZW50IGRpc3BsYXkgdG8gaW5saW5lLWJsb2NrCiAgICAgIHJldHVybiBqUXVlcnkuc3dhcChlbGVtLCB7ICdkaXNwbGF5JzogJ2lubGluZS1ibG9jaycgfSwgY3VyQ1NTLCBbCiAgICAgICAgZWxlbSwKICAgICAgICAnbWFyZ2luUmlnaHQnCiAgICAgIF0pOwogICAgfQogIH0pOwogIC8vIFRoZXNlIGhvb2tzIGFyZSB1c2VkIGJ5IGFuaW1hdGUgdG8gZXhwYW5kIHByb3BlcnRpZXMKICBqUXVlcnkuZWFjaCh7CiAgICBtYXJnaW46ICcnLAogICAgcGFkZGluZzogJycsCiAgICBib3JkZXI6ICdXaWR0aCcKICB9LCBmdW5jdGlvbiAocHJlZml4LCBzdWZmaXgpIHsKICAgIGpRdWVyeS5jc3NIb29rc1twcmVmaXggKyBzdWZmaXhdID0gewogICAgICBleHBhbmQ6IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgIHZhciBpID0gMCwgZXhwYW5kZWQgPSB7fSwKICAgICAgICAgIC8vIGFzc3VtZXMgYSBzaW5nbGUgbnVtYmVyIGlmIG5vdCBhIHN0cmluZwogICAgICAgICAgcGFydHMgPSB0eXBlb2YgdmFsdWUgPT09ICdzdHJpbmcnID8gdmFsdWUuc3BsaXQoJyAnKSA6IFt2YWx1ZV07CiAgICAgICAgZm9yICg7IGkgPCA0OyBpKyspIHsKICAgICAgICAgIGV4cGFuZGVkW3ByZWZpeCArIGNzc0V4cGFuZFtpXSArIHN1ZmZpeF0gPSBwYXJ0c1tpXSB8fCBwYXJ0c1tpIC0gMl0gfHwgcGFydHNbMF07CiAgICAgICAgfQogICAgICAgIHJldHVybiBleHBhbmRlZDsKICAgICAgfQogICAgfTsKICAgIGlmICghcm1hcmdpbi50ZXN0KHByZWZpeCkpIHsKICAgICAgalF1ZXJ5LmNzc0hvb2tzW3ByZWZpeCArIHN1ZmZpeF0uc2V0ID0gc2V0UG9zaXRpdmVOdW1iZXI7CiAgICB9CiAgfSk7CiAgalF1ZXJ5LmZuLmV4dGVuZCh7CiAgICBjc3M6IGZ1bmN0aW9uIChuYW1lLCB2YWx1ZSkgewogICAgICByZXR1cm4gYWNjZXNzKHRoaXMsIGZ1bmN0aW9uIChlbGVtLCBuYW1lLCB2YWx1ZSkgewogICAgICAgIHZhciBzdHlsZXMsIGxlbiwgbWFwID0ge30sIGkgPSAwOwogICAgICAgIGlmIChqUXVlcnkuaXNBcnJheShuYW1lKSkgewogICAgICAgICAgc3R5bGVzID0gZ2V0U3R5bGVzKGVsZW0pOwogICAgICAgICAgbGVuID0gbmFtZS5sZW5ndGg7CiAgICAgICAgICBmb3IgKDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgICAgIG1hcFtuYW1lW2ldXSA9IGpRdWVyeS5jc3MoZWxlbSwgbmFtZVtpXSwgZmFsc2UsIHN0eWxlcyk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbWFwOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdmFsdWUgIT09IHVuZGVmaW5lZCA/IGpRdWVyeS5zdHlsZShlbGVtLCBuYW1lLCB2YWx1ZSkgOiBqUXVlcnkuY3NzKGVsZW0sIG5hbWUpOwogICAgICB9LCBuYW1lLCB2YWx1ZSwgYXJndW1lbnRzLmxlbmd0aCA+IDEpOwogICAgfSwKICAgIHNob3c6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIHNob3dIaWRlKHRoaXMsIHRydWUpOwogICAgfSwKICAgIGhpZGU6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIHNob3dIaWRlKHRoaXMpOwogICAgfSwKICAgIHRvZ2dsZTogZnVuY3Rpb24gKHN0YXRlKSB7CiAgICAgIGlmICh0eXBlb2Ygc3RhdGUgPT09ICdib29sZWFuJykgewogICAgICAgIHJldHVybiBzdGF0ZSA/IHRoaXMuc2hvdygpIDogdGhpcy5oaWRlKCk7CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgaWYgKGlzSGlkZGVuKHRoaXMpKSB7CiAgICAgICAgICBqUXVlcnkodGhpcykuc2hvdygpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBqUXVlcnkodGhpcykuaGlkZSgpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgfSk7CiAgZnVuY3Rpb24gVHdlZW4oZWxlbSwgb3B0aW9ucywgcHJvcCwgZW5kLCBlYXNpbmcpIHsKICAgIHJldHVybiBuZXcgVHdlZW4ucHJvdG90eXBlLmluaXQoZWxlbSwgb3B0aW9ucywgcHJvcCwgZW5kLCBlYXNpbmcpOwogIH0KICBqUXVlcnkuVHdlZW4gPSBUd2VlbjsKICBUd2Vlbi5wcm90b3R5cGUgPSB7CiAgICBjb25zdHJ1Y3RvcjogVHdlZW4sCiAgICBpbml0OiBmdW5jdGlvbiAoZWxlbSwgb3B0aW9ucywgcHJvcCwgZW5kLCBlYXNpbmcsIHVuaXQpIHsKICAgICAgdGhpcy5lbGVtID0gZWxlbTsKICAgICAgdGhpcy5wcm9wID0gcHJvcDsKICAgICAgdGhpcy5lYXNpbmcgPSBlYXNpbmcgfHwgJ3N3aW5nJzsKICAgICAgdGhpcy5vcHRpb25zID0gb3B0aW9uczsKICAgICAgdGhpcy5zdGFydCA9IHRoaXMubm93ID0gdGhpcy5jdXIoKTsKICAgICAgdGhpcy5lbmQgPSBlbmQ7CiAgICAgIHRoaXMudW5pdCA9IHVuaXQgfHwgKGpRdWVyeS5jc3NOdW1iZXJbcHJvcF0gPyAnJyA6ICdweCcpOwogICAgfSwKICAgIGN1cjogZnVuY3Rpb24gKCkgewogICAgICB2YXIgaG9va3MgPSBUd2Vlbi5wcm9wSG9va3NbdGhpcy5wcm9wXTsKICAgICAgcmV0dXJuIGhvb2tzICYmIGhvb2tzLmdldCA/IGhvb2tzLmdldCh0aGlzKSA6IFR3ZWVuLnByb3BIb29rcy5fZGVmYXVsdC5nZXQodGhpcyk7CiAgICB9LAogICAgcnVuOiBmdW5jdGlvbiAocGVyY2VudCkgewogICAgICB2YXIgZWFzZWQsIGhvb2tzID0gVHdlZW4ucHJvcEhvb2tzW3RoaXMucHJvcF07CiAgICAgIGlmICh0aGlzLm9wdGlvbnMuZHVyYXRpb24pIHsKICAgICAgICB0aGlzLnBvcyA9IGVhc2VkID0galF1ZXJ5LmVhc2luZ1t0aGlzLmVhc2luZ10ocGVyY2VudCwgdGhpcy5vcHRpb25zLmR1cmF0aW9uICogcGVyY2VudCwgMCwgMSwgdGhpcy5vcHRpb25zLmR1cmF0aW9uKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLnBvcyA9IGVhc2VkID0gcGVyY2VudDsKICAgICAgfQogICAgICB0aGlzLm5vdyA9ICh0aGlzLmVuZCAtIHRoaXMuc3RhcnQpICogZWFzZWQgKyB0aGlzLnN0YXJ0OwogICAgICBpZiAodGhpcy5vcHRpb25zLnN0ZXApIHsKICAgICAgICB0aGlzLm9wdGlvbnMuc3RlcC5jYWxsKHRoaXMuZWxlbSwgdGhpcy5ub3csIHRoaXMpOwogICAgICB9CiAgICAgIGlmIChob29rcyAmJiBob29rcy5zZXQpIHsKICAgICAgICBob29rcy5zZXQodGhpcyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgVHdlZW4ucHJvcEhvb2tzLl9kZWZhdWx0LnNldCh0aGlzKTsKICAgICAgfQogICAgICByZXR1cm4gdGhpczsKICAgIH0KICB9OwogIFR3ZWVuLnByb3RvdHlwZS5pbml0LnByb3RvdHlwZSA9IFR3ZWVuLnByb3RvdHlwZTsKICBUd2Vlbi5wcm9wSG9va3MgPSB7CiAgICBfZGVmYXVsdDogewogICAgICBnZXQ6IGZ1bmN0aW9uICh0d2VlbikgewogICAgICAgIHZhciByZXN1bHQ7CiAgICAgICAgaWYgKHR3ZWVuLmVsZW1bdHdlZW4ucHJvcF0gIT0gbnVsbCAmJiAoIXR3ZWVuLmVsZW0uc3R5bGUgfHwgdHdlZW4uZWxlbS5zdHlsZVt0d2Vlbi5wcm9wXSA9PSBudWxsKSkgewogICAgICAgICAgcmV0dXJuIHR3ZWVuLmVsZW1bdHdlZW4ucHJvcF07CiAgICAgICAgfQogICAgICAgIC8vIHBhc3NpbmcgYW4gZW1wdHkgc3RyaW5nIGFzIGEgM3JkIHBhcmFtZXRlciB0byAuY3NzIHdpbGwgYXV0b21hdGljYWxseQogICAgICAgIC8vIGF0dGVtcHQgYSBwYXJzZUZsb2F0IGFuZCBmYWxsYmFjayB0byBhIHN0cmluZyBpZiB0aGUgcGFyc2UgZmFpbHMKICAgICAgICAvLyBzbywgc2ltcGxlIHZhbHVlcyBzdWNoIGFzICIxMHB4IiBhcmUgcGFyc2VkIHRvIEZsb2F0LgogICAgICAgIC8vIGNvbXBsZXggdmFsdWVzIHN1Y2ggYXMgInJvdGF0ZSgxcmFkKSIgYXJlIHJldHVybmVkIGFzIGlzLgogICAgICAgIHJlc3VsdCA9IGpRdWVyeS5jc3ModHdlZW4uZWxlbSwgdHdlZW4ucHJvcCwgJycpOwogICAgICAgIC8vIEVtcHR5IHN0cmluZ3MsIG51bGwsIHVuZGVmaW5lZCBhbmQgImF1dG8iIGFyZSBjb252ZXJ0ZWQgdG8gMC4KICAgICAgICByZXR1cm4gIXJlc3VsdCB8fCByZXN1bHQgPT09ICdhdXRvJyA/IDAgOiByZXN1bHQ7CiAgICAgIH0sCiAgICAgIHNldDogZnVuY3Rpb24gKHR3ZWVuKSB7CiAgICAgICAgLy8gdXNlIHN0ZXAgaG9vayBmb3IgYmFjayBjb21wYXQgLSB1c2UgY3NzSG9vayBpZiBpdHMgdGhlcmUgLSB1c2UgLnN0eWxlIGlmIGl0cwogICAgICAgIC8vIGF2YWlsYWJsZSBhbmQgdXNlIHBsYWluIHByb3BlcnRpZXMgd2hlcmUgYXZhaWxhYmxlCiAgICAgICAgaWYgKGpRdWVyeS5meC5zdGVwW3R3ZWVuLnByb3BdKSB7CiAgICAgICAgICBqUXVlcnkuZnguc3RlcFt0d2Vlbi5wcm9wXSh0d2Vlbik7CiAgICAgICAgfSBlbHNlIGlmICh0d2Vlbi5lbGVtLnN0eWxlICYmICh0d2Vlbi5lbGVtLnN0eWxlW2pRdWVyeS5jc3NQcm9wc1t0d2Vlbi5wcm9wXV0gIT0gbnVsbCB8fCBqUXVlcnkuY3NzSG9va3NbdHdlZW4ucHJvcF0pKSB7CiAgICAgICAgICBqUXVlcnkuc3R5bGUodHdlZW4uZWxlbSwgdHdlZW4ucHJvcCwgdHdlZW4ubm93ICsgdHdlZW4udW5pdCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHR3ZWVuLmVsZW1bdHdlZW4ucHJvcF0gPSB0d2Vlbi5ub3c7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfTsKICAvLyBTdXBwb3J0OiBJRTkKICAvLyBQYW5pYyBiYXNlZCBhcHByb2FjaCB0byBzZXR0aW5nIHRoaW5ncyBvbiBkaXNjb25uZWN0ZWQgbm9kZXMKICBUd2Vlbi5wcm9wSG9va3Muc2Nyb2xsVG9wID0gVHdlZW4ucHJvcEhvb2tzLnNjcm9sbExlZnQgPSB7CiAgICBzZXQ6IGZ1bmN0aW9uICh0d2VlbikgewogICAgICBpZiAodHdlZW4uZWxlbS5ub2RlVHlwZSAmJiB0d2Vlbi5lbGVtLnBhcmVudE5vZGUpIHsKICAgICAgICB0d2Vlbi5lbGVtW3R3ZWVuLnByb3BdID0gdHdlZW4ubm93OwogICAgICB9CiAgICB9CiAgfTsKICBqUXVlcnkuZWFzaW5nID0gewogICAgbGluZWFyOiBmdW5jdGlvbiAocCkgewogICAgICByZXR1cm4gcDsKICAgIH0sCiAgICBzd2luZzogZnVuY3Rpb24gKHApIHsKICAgICAgcmV0dXJuIDAuNSAtIE1hdGguY29zKHAgKiBNYXRoLlBJKSAvIDI7CiAgICB9CiAgfTsKICBqUXVlcnkuZnggPSBUd2Vlbi5wcm90b3R5cGUuaW5pdDsKICAvLyBCYWNrIENvbXBhdCA8MS44IGV4dGVuc2lvbiBwb2ludAogIGpRdWVyeS5meC5zdGVwID0ge307CiAgdmFyIGZ4Tm93LCB0aW1lcklkLCByZnh0eXBlcyA9IC9eKD86dG9nZ2xlfHNob3d8aGlkZSkkLywgcmZ4bnVtID0gbmV3IFJlZ0V4cCgnXig/OihbKy1dKT18KSgnICsgcG51bSArICcpKFthLXolXSopJCcsICdpJyksIHJydW4gPSAvcXVldWVIb29rcyQvLCBhbmltYXRpb25QcmVmaWx0ZXJzID0gW2RlZmF1bHRQcmVmaWx0ZXJdLCB0d2VlbmVycyA9IHsKICAgICAgJyonOiBbZnVuY3Rpb24gKHByb3AsIHZhbHVlKSB7CiAgICAgICAgICB2YXIgdHdlZW4gPSB0aGlzLmNyZWF0ZVR3ZWVuKHByb3AsIHZhbHVlKSwgdGFyZ2V0ID0gdHdlZW4uY3VyKCksIHBhcnRzID0gcmZ4bnVtLmV4ZWModmFsdWUpLCB1bml0ID0gcGFydHMgJiYgcGFydHNbM10gfHwgKGpRdWVyeS5jc3NOdW1iZXJbcHJvcF0gPyAnJyA6ICdweCcpLAogICAgICAgICAgICAvLyBTdGFydGluZyB2YWx1ZSBjb21wdXRhdGlvbiBpcyByZXF1aXJlZCBmb3IgcG90ZW50aWFsIHVuaXQgbWlzbWF0Y2hlcwogICAgICAgICAgICBzdGFydCA9IChqUXVlcnkuY3NzTnVtYmVyW3Byb3BdIHx8IHVuaXQgIT09ICdweCcgJiYgK3RhcmdldCkgJiYgcmZ4bnVtLmV4ZWMoalF1ZXJ5LmNzcyh0d2Vlbi5lbGVtLCBwcm9wKSksIHNjYWxlID0gMSwgbWF4SXRlcmF0aW9ucyA9IDIwOwogICAgICAgICAgaWYgKHN0YXJ0ICYmIHN0YXJ0WzNdICE9PSB1bml0KSB7CiAgICAgICAgICAgIC8vIFRydXN0IHVuaXRzIHJlcG9ydGVkIGJ5IGpRdWVyeS5jc3MKICAgICAgICAgICAgdW5pdCA9IHVuaXQgfHwgc3RhcnRbM107CiAgICAgICAgICAgIC8vIE1ha2Ugc3VyZSB3ZSB1cGRhdGUgdGhlIHR3ZWVuIHByb3BlcnRpZXMgbGF0ZXIgb24KICAgICAgICAgICAgcGFydHMgPSBwYXJ0cyB8fCBbXTsKICAgICAgICAgICAgLy8gSXRlcmF0aXZlbHkgYXBwcm94aW1hdGUgZnJvbSBhIG5vbnplcm8gc3RhcnRpbmcgcG9pbnQKICAgICAgICAgICAgc3RhcnQgPSArdGFyZ2V0IHx8IDE7CiAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICAvLyBJZiBwcmV2aW91cyBpdGVyYXRpb24gemVyb2VkIG91dCwgZG91YmxlIHVudGlsIHdlIGdldCAqc29tZXRoaW5nKgogICAgICAgICAgICAgIC8vIFVzZSBhIHN0cmluZyBmb3IgZG91YmxpbmcgZmFjdG9yIHNvIHdlIGRvbid0IGFjY2lkZW50YWxseSBzZWUgc2NhbGUgYXMgdW5jaGFuZ2VkIGJlbG93CiAgICAgICAgICAgICAgc2NhbGUgPSBzY2FsZSB8fCAnLjUnOwogICAgICAgICAgICAgIC8vIEFkanVzdCBhbmQgYXBwbHkKICAgICAgICAgICAgICBzdGFydCA9IHN0YXJ0IC8gc2NhbGU7CiAgICAgICAgICAgICAgalF1ZXJ5LnN0eWxlKHR3ZWVuLmVsZW0sIHByb3AsIHN0YXJ0ICsgdW5pdCk7ICAvLyBVcGRhdGUgc2NhbGUsIHRvbGVyYXRpbmcgemVybyBvciBOYU4gZnJvbSB0d2Vlbi5jdXIoKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gQW5kIGJyZWFraW5nIHRoZSBsb29wIGlmIHNjYWxlIGlzIHVuY2hhbmdlZCBvciBwZXJmZWN0LCBvciBpZiB3ZSd2ZSBqdXN0IGhhZCBlbm91Z2gKICAgICAgICAgICAgfSB3aGlsZSAoc2NhbGUgIT09IChzY2FsZSA9IHR3ZWVuLmN1cigpIC8gdGFyZ2V0KSAmJiBzY2FsZSAhPT0gMSAmJiAtLW1heEl0ZXJhdGlvbnMpOwogICAgICAgICAgfQogICAgICAgICAgLy8gVXBkYXRlIHR3ZWVuIHByb3BlcnRpZXMKICAgICAgICAgIGlmIChwYXJ0cykgewogICAgICAgICAgICBzdGFydCA9IHR3ZWVuLnN0YXJ0ID0gK3N0YXJ0IHx8ICt0YXJnZXQgfHwgMDsKICAgICAgICAgICAgdHdlZW4udW5pdCA9IHVuaXQ7CiAgICAgICAgICAgIC8vIElmIGEgKz0vLT0gdG9rZW4gd2FzIHByb3ZpZGVkLCB3ZSdyZSBkb2luZyBhIHJlbGF0aXZlIGFuaW1hdGlvbgogICAgICAgICAgICB0d2Vlbi5lbmQgPSBwYXJ0c1sxXSA/IHN0YXJ0ICsgKHBhcnRzWzFdICsgMSkgKiBwYXJ0c1syXSA6ICtwYXJ0c1syXTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0d2VlbjsKICAgICAgICB9XQogICAgfTsKICAvLyBBbmltYXRpb25zIGNyZWF0ZWQgc3luY2hyb25vdXNseSB3aWxsIHJ1biBzeW5jaHJvbm91c2x5CiAgZnVuY3Rpb24gY3JlYXRlRnhOb3coKSB7CiAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgZnhOb3cgPSB1bmRlZmluZWQ7CiAgICB9KTsKICAgIHJldHVybiBmeE5vdyA9IGpRdWVyeS5ub3coKTsKICB9CiAgLy8gR2VuZXJhdGUgcGFyYW1ldGVycyB0byBjcmVhdGUgYSBzdGFuZGFyZCBhbmltYXRpb24KICBmdW5jdGlvbiBnZW5GeCh0eXBlLCBpbmNsdWRlV2lkdGgpIHsKICAgIHZhciB3aGljaCwgaSA9IDAsIGF0dHJzID0geyBoZWlnaHQ6IHR5cGUgfTsKICAgIC8vIGlmIHdlIGluY2x1ZGUgd2lkdGgsIHN0ZXAgdmFsdWUgaXMgMSB0byBkbyBhbGwgY3NzRXhwYW5kIHZhbHVlcywKICAgIC8vIGlmIHdlIGRvbid0IGluY2x1ZGUgd2lkdGgsIHN0ZXAgdmFsdWUgaXMgMiB0byBza2lwIG92ZXIgTGVmdCBhbmQgUmlnaHQKICAgIGluY2x1ZGVXaWR0aCA9IGluY2x1ZGVXaWR0aCA/IDEgOiAwOwogICAgZm9yICg7IGkgPCA0OyBpICs9IDIgLSBpbmNsdWRlV2lkdGgpIHsKICAgICAgd2hpY2ggPSBjc3NFeHBhbmRbaV07CiAgICAgIGF0dHJzWydtYXJnaW4nICsgd2hpY2hdID0gYXR0cnNbJ3BhZGRpbmcnICsgd2hpY2hdID0gdHlwZTsKICAgIH0KICAgIGlmIChpbmNsdWRlV2lkdGgpIHsKICAgICAgYXR0cnMub3BhY2l0eSA9IGF0dHJzLndpZHRoID0gdHlwZTsKICAgIH0KICAgIHJldHVybiBhdHRyczsKICB9CiAgZnVuY3Rpb24gY3JlYXRlVHdlZW4odmFsdWUsIHByb3AsIGFuaW1hdGlvbikgewogICAgdmFyIHR3ZWVuLCBjb2xsZWN0aW9uID0gKHR3ZWVuZXJzW3Byb3BdIHx8IFtdKS5jb25jYXQodHdlZW5lcnNbJyonXSksIGluZGV4ID0gMCwgbGVuZ3RoID0gY29sbGVjdGlvbi5sZW5ndGg7CiAgICBmb3IgKDsgaW5kZXggPCBsZW5ndGg7IGluZGV4KyspIHsKICAgICAgaWYgKHR3ZWVuID0gY29sbGVjdGlvbltpbmRleF0uY2FsbChhbmltYXRpb24sIHByb3AsIHZhbHVlKSkgewogICAgICAgIC8vIHdlJ3JlIGRvbmUgd2l0aCB0aGlzIHByb3BlcnR5CiAgICAgICAgcmV0dXJuIHR3ZWVuOwogICAgICB9CiAgICB9CiAgfQogIGZ1bmN0aW9uIGRlZmF1bHRQcmVmaWx0ZXIoZWxlbSwgcHJvcHMsIG9wdHMpIHsKICAgIC8qIGpzaGludCB2YWxpZHRoaXM6IHRydWUgKi8KICAgIHZhciBwcm9wLCB2YWx1ZSwgdG9nZ2xlLCB0d2VlbiwgaG9va3MsIG9sZGZpcmUsIGRpc3BsYXksIGNoZWNrRGlzcGxheSwgYW5pbSA9IHRoaXMsIG9yaWcgPSB7fSwgc3R5bGUgPSBlbGVtLnN0eWxlLCBoaWRkZW4gPSBlbGVtLm5vZGVUeXBlICYmIGlzSGlkZGVuKGVsZW0pLCBkYXRhU2hvdyA9IGRhdGFfcHJpdi5nZXQoZWxlbSwgJ2Z4c2hvdycpOwogICAgLy8gaGFuZGxlIHF1ZXVlOiBmYWxzZSBwcm9taXNlcwogICAgaWYgKCFvcHRzLnF1ZXVlKSB7CiAgICAgIGhvb2tzID0galF1ZXJ5Ll9xdWV1ZUhvb2tzKGVsZW0sICdmeCcpOwogICAgICBpZiAoaG9va3MudW5xdWV1ZWQgPT0gbnVsbCkgewogICAgICAgIGhvb2tzLnVucXVldWVkID0gMDsKICAgICAgICBvbGRmaXJlID0gaG9va3MuZW1wdHkuZmlyZTsKICAgICAgICBob29rcy5lbXB0eS5maXJlID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgaWYgKCFob29rcy51bnF1ZXVlZCkgewogICAgICAgICAgICBvbGRmaXJlKCk7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgfQogICAgICBob29rcy51bnF1ZXVlZCsrOwogICAgICBhbmltLmFsd2F5cyhmdW5jdGlvbiAoKSB7CiAgICAgICAgLy8gZG9pbmcgdGhpcyBtYWtlcyBzdXJlIHRoYXQgdGhlIGNvbXBsZXRlIGhhbmRsZXIgd2lsbCBiZSBjYWxsZWQKICAgICAgICAvLyBiZWZvcmUgdGhpcyBjb21wbGV0ZXMKICAgICAgICBhbmltLmFsd2F5cyhmdW5jdGlvbiAoKSB7CiAgICAgICAgICBob29rcy51bnF1ZXVlZC0tOwogICAgICAgICAgaWYgKCFqUXVlcnkucXVldWUoZWxlbSwgJ2Z4JykubGVuZ3RoKSB7CiAgICAgICAgICAgIGhvb2tzLmVtcHR5LmZpcmUoKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfSk7CiAgICB9CiAgICAvLyBoZWlnaHQvd2lkdGggb3ZlcmZsb3cgcGFzcwogICAgaWYgKGVsZW0ubm9kZVR5cGUgPT09IDEgJiYgKCdoZWlnaHQnIGluIHByb3BzIHx8ICd3aWR0aCcgaW4gcHJvcHMpKSB7CiAgICAgIC8vIE1ha2Ugc3VyZSB0aGF0IG5vdGhpbmcgc25lYWtzIG91dAogICAgICAvLyBSZWNvcmQgYWxsIDMgb3ZlcmZsb3cgYXR0cmlidXRlcyBiZWNhdXNlIElFOS0xMCBkbyBub3QKICAgICAgLy8gY2hhbmdlIHRoZSBvdmVyZmxvdyBhdHRyaWJ1dGUgd2hlbiBvdmVyZmxvd1ggYW5kCiAgICAgIC8vIG92ZXJmbG93WSBhcmUgc2V0IHRvIHRoZSBzYW1lIHZhbHVlCiAgICAgIG9wdHMub3ZlcmZsb3cgPSBbCiAgICAgICAgc3R5bGUub3ZlcmZsb3csCiAgICAgICAgc3R5bGUub3ZlcmZsb3dYLAogICAgICAgIHN0eWxlLm92ZXJmbG93WQogICAgICBdOwogICAgICAvLyBTZXQgZGlzcGxheSBwcm9wZXJ0eSB0byBpbmxpbmUtYmxvY2sgZm9yIGhlaWdodC93aWR0aAogICAgICAvLyBhbmltYXRpb25zIG9uIGlubGluZSBlbGVtZW50cyB0aGF0IGFyZSBoYXZpbmcgd2lkdGgvaGVpZ2h0IGFuaW1hdGVkCiAgICAgIGRpc3BsYXkgPSBqUXVlcnkuY3NzKGVsZW0sICdkaXNwbGF5Jyk7CiAgICAgIC8vIFRlc3QgZGVmYXVsdCBkaXNwbGF5IGlmIGRpc3BsYXkgaXMgY3VycmVudGx5ICJub25lIgogICAgICBjaGVja0Rpc3BsYXkgPSBkaXNwbGF5ID09PSAnbm9uZScgPyBkYXRhX3ByaXYuZ2V0KGVsZW0sICdvbGRkaXNwbGF5JykgfHwgZGVmYXVsdERpc3BsYXkoZWxlbS5ub2RlTmFtZSkgOiBkaXNwbGF5OwogICAgICBpZiAoY2hlY2tEaXNwbGF5ID09PSAnaW5saW5lJyAmJiBqUXVlcnkuY3NzKGVsZW0sICdmbG9hdCcpID09PSAnbm9uZScpIHsKICAgICAgICBzdHlsZS5kaXNwbGF5ID0gJ2lubGluZS1ibG9jayc7CiAgICAgIH0KICAgIH0KICAgIGlmIChvcHRzLm92ZXJmbG93KSB7CiAgICAgIHN0eWxlLm92ZXJmbG93ID0gJ2hpZGRlbic7CiAgICAgIGFuaW0uYWx3YXlzKGZ1bmN0aW9uICgpIHsKICAgICAgICBzdHlsZS5vdmVyZmxvdyA9IG9wdHMub3ZlcmZsb3dbMF07CiAgICAgICAgc3R5bGUub3ZlcmZsb3dYID0gb3B0cy5vdmVyZmxvd1sxXTsKICAgICAgICBzdHlsZS5vdmVyZmxvd1kgPSBvcHRzLm92ZXJmbG93WzJdOwogICAgICB9KTsKICAgIH0KICAgIC8vIHNob3cvaGlkZSBwYXNzCiAgICBmb3IgKHByb3AgaW4gcHJvcHMpIHsKICAgICAgdmFsdWUgPSBwcm9wc1twcm9wXTsKICAgICAgaWYgKHJmeHR5cGVzLmV4ZWModmFsdWUpKSB7CiAgICAgICAgZGVsZXRlIHByb3BzW3Byb3BdOwogICAgICAgIHRvZ2dsZSA9IHRvZ2dsZSB8fCB2YWx1ZSA9PT0gJ3RvZ2dsZSc7CiAgICAgICAgaWYgKHZhbHVlID09PSAoaGlkZGVuID8gJ2hpZGUnIDogJ3Nob3cnKSkgewogICAgICAgICAgLy8gSWYgdGhlcmUgaXMgZGF0YVNob3cgbGVmdCBvdmVyIGZyb20gYSBzdG9wcGVkIGhpZGUgb3Igc2hvdyBhbmQgd2UgYXJlIGdvaW5nIHRvIHByb2NlZWQgd2l0aCBzaG93LCB3ZSBzaG91bGQgcHJldGVuZCB0byBiZSBoaWRkZW4KICAgICAgICAgIGlmICh2YWx1ZSA9PT0gJ3Nob3cnICYmIGRhdGFTaG93ICYmIGRhdGFTaG93W3Byb3BdICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgaGlkZGVuID0gdHJ1ZTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBvcmlnW3Byb3BdID0gZGF0YVNob3cgJiYgZGF0YVNob3dbcHJvcF0gfHwgalF1ZXJ5LnN0eWxlKGVsZW0sIHByb3ApOyAgLy8gQW55IG5vbi1meCB2YWx1ZSBzdG9wcyB1cyBmcm9tIHJlc3RvcmluZyB0aGUgb3JpZ2luYWwgZGlzcGxheSB2YWx1ZQogICAgICB9IGVsc2UgewogICAgICAgIGRpc3BsYXkgPSB1bmRlZmluZWQ7CiAgICAgIH0KICAgIH0KICAgIGlmICghalF1ZXJ5LmlzRW1wdHlPYmplY3Qob3JpZykpIHsKICAgICAgaWYgKGRhdGFTaG93KSB7CiAgICAgICAgaWYgKCdoaWRkZW4nIGluIGRhdGFTaG93KSB7CiAgICAgICAgICBoaWRkZW4gPSBkYXRhU2hvdy5oaWRkZW47CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGRhdGFTaG93ID0gZGF0YV9wcml2LmFjY2VzcyhlbGVtLCAnZnhzaG93Jywge30pOwogICAgICB9CiAgICAgIC8vIHN0b3JlIHN0YXRlIGlmIGl0cyB0b2dnbGUgLSBlbmFibGVzIC5zdG9wKCkudG9nZ2xlKCkgdG8gInJldmVyc2UiCiAgICAgIGlmICh0b2dnbGUpIHsKICAgICAgICBkYXRhU2hvdy5oaWRkZW4gPSAhaGlkZGVuOwogICAgICB9CiAgICAgIGlmIChoaWRkZW4pIHsKICAgICAgICBqUXVlcnkoZWxlbSkuc2hvdygpOwogICAgICB9IGVsc2UgewogICAgICAgIGFuaW0uZG9uZShmdW5jdGlvbiAoKSB7CiAgICAgICAgICBqUXVlcnkoZWxlbSkuaGlkZSgpOwogICAgICAgIH0pOwogICAgICB9CiAgICAgIGFuaW0uZG9uZShmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIHByb3A7CiAgICAgICAgZGF0YV9wcml2LnJlbW92ZShlbGVtLCAnZnhzaG93Jyk7CiAgICAgICAgZm9yIChwcm9wIGluIG9yaWcpIHsKICAgICAgICAgIGpRdWVyeS5zdHlsZShlbGVtLCBwcm9wLCBvcmlnW3Byb3BdKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICBmb3IgKHByb3AgaW4gb3JpZykgewogICAgICAgIHR3ZWVuID0gY3JlYXRlVHdlZW4oaGlkZGVuID8gZGF0YVNob3dbcHJvcF0gOiAwLCBwcm9wLCBhbmltKTsKICAgICAgICBpZiAoIShwcm9wIGluIGRhdGFTaG93KSkgewogICAgICAgICAgZGF0YVNob3dbcHJvcF0gPSB0d2Vlbi5zdGFydDsKICAgICAgICAgIGlmIChoaWRkZW4pIHsKICAgICAgICAgICAgdHdlZW4uZW5kID0gdHdlZW4uc3RhcnQ7CiAgICAgICAgICAgIHR3ZWVuLnN0YXJ0ID0gcHJvcCA9PT0gJ3dpZHRoJyB8fCBwcm9wID09PSAnaGVpZ2h0JyA/IDEgOiAwOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSAgLy8gSWYgdGhpcyBpcyBhIG5vb3AgbGlrZSAuaGlkZSgpLmhpZGUoKSwgcmVzdG9yZSBhbiBvdmVyd3JpdHRlbiBkaXNwbGF5IHZhbHVlCiAgICB9IGVsc2UgaWYgKChkaXNwbGF5ID09PSAnbm9uZScgPyBkZWZhdWx0RGlzcGxheShlbGVtLm5vZGVOYW1lKSA6IGRpc3BsYXkpID09PSAnaW5saW5lJykgewogICAgICBzdHlsZS5kaXNwbGF5ID0gZGlzcGxheTsKICAgIH0KICB9CiAgZnVuY3Rpb24gcHJvcEZpbHRlcihwcm9wcywgc3BlY2lhbEVhc2luZykgewogICAgdmFyIGluZGV4LCBuYW1lLCBlYXNpbmcsIHZhbHVlLCBob29rczsKICAgIC8vIGNhbWVsQ2FzZSwgc3BlY2lhbEVhc2luZyBhbmQgZXhwYW5kIGNzc0hvb2sgcGFzcwogICAgZm9yIChpbmRleCBpbiBwcm9wcykgewogICAgICBuYW1lID0galF1ZXJ5LmNhbWVsQ2FzZShpbmRleCk7CiAgICAgIGVhc2luZyA9IHNwZWNpYWxFYXNpbmdbbmFtZV07CiAgICAgIHZhbHVlID0gcHJvcHNbaW5kZXhdOwogICAgICBpZiAoalF1ZXJ5LmlzQXJyYXkodmFsdWUpKSB7CiAgICAgICAgZWFzaW5nID0gdmFsdWVbMV07CiAgICAgICAgdmFsdWUgPSBwcm9wc1tpbmRleF0gPSB2YWx1ZVswXTsKICAgICAgfQogICAgICBpZiAoaW5kZXggIT09IG5hbWUpIHsKICAgICAgICBwcm9wc1tuYW1lXSA9IHZhbHVlOwogICAgICAgIGRlbGV0ZSBwcm9wc1tpbmRleF07CiAgICAgIH0KICAgICAgaG9va3MgPSBqUXVlcnkuY3NzSG9va3NbbmFtZV07CiAgICAgIGlmIChob29rcyAmJiAnZXhwYW5kJyBpbiBob29rcykgewogICAgICAgIHZhbHVlID0gaG9va3MuZXhwYW5kKHZhbHVlKTsKICAgICAgICBkZWxldGUgcHJvcHNbbmFtZV07CiAgICAgICAgLy8gbm90IHF1aXRlICQuZXh0ZW5kLCB0aGlzIHdvbnQgb3ZlcndyaXRlIGtleXMgYWxyZWFkeSBwcmVzZW50LgogICAgICAgIC8vIGFsc28gLSByZXVzaW5nICdpbmRleCcgZnJvbSBhYm92ZSBiZWNhdXNlIHdlIGhhdmUgdGhlIGNvcnJlY3QgIm5hbWUiCiAgICAgICAgZm9yIChpbmRleCBpbiB2YWx1ZSkgewogICAgICAgICAgaWYgKCEoaW5kZXggaW4gcHJvcHMpKSB7CiAgICAgICAgICAgIHByb3BzW2luZGV4XSA9IHZhbHVlW2luZGV4XTsKICAgICAgICAgICAgc3BlY2lhbEVhc2luZ1tpbmRleF0gPSBlYXNpbmc7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIHNwZWNpYWxFYXNpbmdbbmFtZV0gPSBlYXNpbmc7CiAgICAgIH0KICAgIH0KICB9CiAgZnVuY3Rpb24gQW5pbWF0aW9uKGVsZW0sIHByb3BlcnRpZXMsIG9wdGlvbnMpIHsKICAgIHZhciByZXN1bHQsIHN0b3BwZWQsIGluZGV4ID0gMCwgbGVuZ3RoID0gYW5pbWF0aW9uUHJlZmlsdGVycy5sZW5ndGgsIGRlZmVycmVkID0galF1ZXJ5LkRlZmVycmVkKCkuYWx3YXlzKGZ1bmN0aW9uICgpIHsKICAgICAgICAvLyBkb24ndCBtYXRjaCBlbGVtIGluIHRoZSA6YW5pbWF0ZWQgc2VsZWN0b3IKICAgICAgICBkZWxldGUgdGljay5lbGVtOwogICAgICB9KSwgdGljayA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBpZiAoc3RvcHBlZCkgewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICB2YXIgY3VycmVudFRpbWUgPSBmeE5vdyB8fCBjcmVhdGVGeE5vdygpLCByZW1haW5pbmcgPSBNYXRoLm1heCgwLCBhbmltYXRpb24uc3RhcnRUaW1lICsgYW5pbWF0aW9uLmR1cmF0aW9uIC0gY3VycmVudFRpbWUpLAogICAgICAgICAgLy8gYXJjaGFpYyBjcmFzaCBidWcgd29uJ3QgYWxsb3cgdXMgdG8gdXNlIDEgLSAoIDAuNSB8fCAwICkgKCMxMjQ5NykKICAgICAgICAgIHRlbXAgPSByZW1haW5pbmcgLyBhbmltYXRpb24uZHVyYXRpb24gfHwgMCwgcGVyY2VudCA9IDEgLSB0ZW1wLCBpbmRleCA9IDAsIGxlbmd0aCA9IGFuaW1hdGlvbi50d2VlbnMubGVuZ3RoOwogICAgICAgIGZvciAoOyBpbmRleCA8IGxlbmd0aDsgaW5kZXgrKykgewogICAgICAgICAgYW5pbWF0aW9uLnR3ZWVuc1tpbmRleF0ucnVuKHBlcmNlbnQpOwogICAgICAgIH0KICAgICAgICBkZWZlcnJlZC5ub3RpZnlXaXRoKGVsZW0sIFsKICAgICAgICAgIGFuaW1hdGlvbiwKICAgICAgICAgIHBlcmNlbnQsCiAgICAgICAgICByZW1haW5pbmcKICAgICAgICBdKTsKICAgICAgICBpZiAocGVyY2VudCA8IDEgJiYgbGVuZ3RoKSB7CiAgICAgICAgICByZXR1cm4gcmVtYWluaW5nOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBkZWZlcnJlZC5yZXNvbHZlV2l0aChlbGVtLCBbYW5pbWF0aW9uXSk7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICB9LCBhbmltYXRpb24gPSBkZWZlcnJlZC5wcm9taXNlKHsKICAgICAgICBlbGVtOiBlbGVtLAogICAgICAgIHByb3BzOiBqUXVlcnkuZXh0ZW5kKHt9LCBwcm9wZXJ0aWVzKSwKICAgICAgICBvcHRzOiBqUXVlcnkuZXh0ZW5kKHRydWUsIHsgc3BlY2lhbEVhc2luZzoge30gfSwgb3B0aW9ucyksCiAgICAgICAgb3JpZ2luYWxQcm9wZXJ0aWVzOiBwcm9wZXJ0aWVzLAogICAgICAgIG9yaWdpbmFsT3B0aW9uczogb3B0aW9ucywKICAgICAgICBzdGFydFRpbWU6IGZ4Tm93IHx8IGNyZWF0ZUZ4Tm93KCksCiAgICAgICAgZHVyYXRpb246IG9wdGlvbnMuZHVyYXRpb24sCiAgICAgICAgdHdlZW5zOiBbXSwKICAgICAgICBjcmVhdGVUd2VlbjogZnVuY3Rpb24gKHByb3AsIGVuZCkgewogICAgICAgICAgdmFyIHR3ZWVuID0galF1ZXJ5LlR3ZWVuKGVsZW0sIGFuaW1hdGlvbi5vcHRzLCBwcm9wLCBlbmQsIGFuaW1hdGlvbi5vcHRzLnNwZWNpYWxFYXNpbmdbcHJvcF0gfHwgYW5pbWF0aW9uLm9wdHMuZWFzaW5nKTsKICAgICAgICAgIGFuaW1hdGlvbi50d2VlbnMucHVzaCh0d2Vlbik7CiAgICAgICAgICByZXR1cm4gdHdlZW47CiAgICAgICAgfSwKICAgICAgICBzdG9wOiBmdW5jdGlvbiAoZ290b0VuZCkgewogICAgICAgICAgdmFyIGluZGV4ID0gMCwKICAgICAgICAgICAgLy8gaWYgd2UgYXJlIGdvaW5nIHRvIHRoZSBlbmQsIHdlIHdhbnQgdG8gcnVuIGFsbCB0aGUgdHdlZW5zCiAgICAgICAgICAgIC8vIG90aGVyd2lzZSB3ZSBza2lwIHRoaXMgcGFydAogICAgICAgICAgICBsZW5ndGggPSBnb3RvRW5kID8gYW5pbWF0aW9uLnR3ZWVucy5sZW5ndGggOiAwOwogICAgICAgICAgaWYgKHN0b3BwZWQpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICB9CiAgICAgICAgICBzdG9wcGVkID0gdHJ1ZTsKICAgICAgICAgIGZvciAoOyBpbmRleCA8IGxlbmd0aDsgaW5kZXgrKykgewogICAgICAgICAgICBhbmltYXRpb24udHdlZW5zW2luZGV4XS5ydW4oMSk7CiAgICAgICAgICB9CiAgICAgICAgICAvLyByZXNvbHZlIHdoZW4gd2UgcGxheWVkIHRoZSBsYXN0IGZyYW1lCiAgICAgICAgICAvLyBvdGhlcndpc2UsIHJlamVjdAogICAgICAgICAgaWYgKGdvdG9FbmQpIHsKICAgICAgICAgICAgZGVmZXJyZWQucmVzb2x2ZVdpdGgoZWxlbSwgWwogICAgICAgICAgICAgIGFuaW1hdGlvbiwKICAgICAgICAgICAgICBnb3RvRW5kCiAgICAgICAgICAgIF0pOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZGVmZXJyZWQucmVqZWN0V2l0aChlbGVtLCBbCiAgICAgICAgICAgICAgYW5pbWF0aW9uLAogICAgICAgICAgICAgIGdvdG9FbmQKICAgICAgICAgICAgXSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9CiAgICAgIH0pLCBwcm9wcyA9IGFuaW1hdGlvbi5wcm9wczsKICAgIHByb3BGaWx0ZXIocHJvcHMsIGFuaW1hdGlvbi5vcHRzLnNwZWNpYWxFYXNpbmcpOwogICAgZm9yICg7IGluZGV4IDwgbGVuZ3RoOyBpbmRleCsrKSB7CiAgICAgIHJlc3VsdCA9IGFuaW1hdGlvblByZWZpbHRlcnNbaW5kZXhdLmNhbGwoYW5pbWF0aW9uLCBlbGVtLCBwcm9wcywgYW5pbWF0aW9uLm9wdHMpOwogICAgICBpZiAocmVzdWx0KSB7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfQogICAgfQogICAgalF1ZXJ5Lm1hcChwcm9wcywgY3JlYXRlVHdlZW4sIGFuaW1hdGlvbik7CiAgICBpZiAoalF1ZXJ5LmlzRnVuY3Rpb24oYW5pbWF0aW9uLm9wdHMuc3RhcnQpKSB7CiAgICAgIGFuaW1hdGlvbi5vcHRzLnN0YXJ0LmNhbGwoZWxlbSwgYW5pbWF0aW9uKTsKICAgIH0KICAgIGpRdWVyeS5meC50aW1lcihqUXVlcnkuZXh0ZW5kKHRpY2ssIHsKICAgICAgZWxlbTogZWxlbSwKICAgICAgYW5pbTogYW5pbWF0aW9uLAogICAgICBxdWV1ZTogYW5pbWF0aW9uLm9wdHMucXVldWUKICAgIH0pKTsKICAgIC8vIGF0dGFjaCBjYWxsYmFja3MgZnJvbSBvcHRpb25zCiAgICByZXR1cm4gYW5pbWF0aW9uLnByb2dyZXNzKGFuaW1hdGlvbi5vcHRzLnByb2dyZXNzKS5kb25lKGFuaW1hdGlvbi5vcHRzLmRvbmUsIGFuaW1hdGlvbi5vcHRzLmNvbXBsZXRlKS5mYWlsKGFuaW1hdGlvbi5vcHRzLmZhaWwpLmFsd2F5cyhhbmltYXRpb24ub3B0cy5hbHdheXMpOwogIH0KICBqUXVlcnkuQW5pbWF0aW9uID0galF1ZXJ5LmV4dGVuZChBbmltYXRpb24sIHsKICAgIHR3ZWVuZXI6IGZ1bmN0aW9uIChwcm9wcywgY2FsbGJhY2spIHsKICAgICAgaWYgKGpRdWVyeS5pc0Z1bmN0aW9uKHByb3BzKSkgewogICAgICAgIGNhbGxiYWNrID0gcHJvcHM7CiAgICAgICAgcHJvcHMgPSBbJyonXTsKICAgICAgfSBlbHNlIHsKICAgICAgICBwcm9wcyA9IHByb3BzLnNwbGl0KCcgJyk7CiAgICAgIH0KICAgICAgdmFyIHByb3AsIGluZGV4ID0gMCwgbGVuZ3RoID0gcHJvcHMubGVuZ3RoOwogICAgICBmb3IgKDsgaW5kZXggPCBsZW5ndGg7IGluZGV4KyspIHsKICAgICAgICBwcm9wID0gcHJvcHNbaW5kZXhdOwogICAgICAgIHR3ZWVuZXJzW3Byb3BdID0gdHdlZW5lcnNbcHJvcF0gfHwgW107CiAgICAgICAgdHdlZW5lcnNbcHJvcF0udW5zaGlmdChjYWxsYmFjayk7CiAgICAgIH0KICAgIH0sCiAgICBwcmVmaWx0ZXI6IGZ1bmN0aW9uIChjYWxsYmFjaywgcHJlcGVuZCkgewogICAgICBpZiAocHJlcGVuZCkgewogICAgICAgIGFuaW1hdGlvblByZWZpbHRlcnMudW5zaGlmdChjYWxsYmFjayk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgYW5pbWF0aW9uUHJlZmlsdGVycy5wdXNoKGNhbGxiYWNrKTsKICAgICAgfQogICAgfQogIH0pOwogIGpRdWVyeS5zcGVlZCA9IGZ1bmN0aW9uIChzcGVlZCwgZWFzaW5nLCBmbikgewogICAgdmFyIG9wdCA9IHNwZWVkICYmIHR5cGVvZiBzcGVlZCA9PT0gJ29iamVjdCcgPyBqUXVlcnkuZXh0ZW5kKHt9LCBzcGVlZCkgOiB7CiAgICAgIGNvbXBsZXRlOiBmbiB8fCAhZm4gJiYgZWFzaW5nIHx8IGpRdWVyeS5pc0Z1bmN0aW9uKHNwZWVkKSAmJiBzcGVlZCwKICAgICAgZHVyYXRpb246IHNwZWVkLAogICAgICBlYXNpbmc6IGZuICYmIGVhc2luZyB8fCBlYXNpbmcgJiYgIWpRdWVyeS5pc0Z1bmN0aW9uKGVhc2luZykgJiYgZWFzaW5nCiAgICB9OwogICAgb3B0LmR1cmF0aW9uID0galF1ZXJ5LmZ4Lm9mZiA/IDAgOiB0eXBlb2Ygb3B0LmR1cmF0aW9uID09PSAnbnVtYmVyJyA/IG9wdC5kdXJhdGlvbiA6IG9wdC5kdXJhdGlvbiBpbiBqUXVlcnkuZnguc3BlZWRzID8galF1ZXJ5LmZ4LnNwZWVkc1tvcHQuZHVyYXRpb25dIDogalF1ZXJ5LmZ4LnNwZWVkcy5fZGVmYXVsdDsKICAgIC8vIG5vcm1hbGl6ZSBvcHQucXVldWUgLSB0cnVlL3VuZGVmaW5lZC9udWxsIC0+ICJmeCIKICAgIGlmIChvcHQucXVldWUgPT0gbnVsbCB8fCBvcHQucXVldWUgPT09IHRydWUpIHsKICAgICAgb3B0LnF1ZXVlID0gJ2Z4JzsKICAgIH0KICAgIC8vIFF1ZXVlaW5nCiAgICBvcHQub2xkID0gb3B0LmNvbXBsZXRlOwogICAgb3B0LmNvbXBsZXRlID0gZnVuY3Rpb24gKCkgewogICAgICBpZiAoalF1ZXJ5LmlzRnVuY3Rpb24ob3B0Lm9sZCkpIHsKICAgICAgICBvcHQub2xkLmNhbGwodGhpcyk7CiAgICAgIH0KICAgICAgaWYgKG9wdC5xdWV1ZSkgewogICAgICAgIGpRdWVyeS5kZXF1ZXVlKHRoaXMsIG9wdC5xdWV1ZSk7CiAgICAgIH0KICAgIH07CiAgICByZXR1cm4gb3B0OwogIH07CiAgalF1ZXJ5LmZuLmV4dGVuZCh7CiAgICBmYWRlVG86IGZ1bmN0aW9uIChzcGVlZCwgdG8sIGVhc2luZywgY2FsbGJhY2spIHsKICAgICAgLy8gc2hvdyBhbnkgaGlkZGVuIGVsZW1lbnRzIGFmdGVyIHNldHRpbmcgb3BhY2l0eSB0byAwCiAgICAgIHJldHVybiB0aGlzLmZpbHRlcihpc0hpZGRlbikuY3NzKCdvcGFjaXR5JywgMCkuc2hvdygpICAvLyBhbmltYXRlIHRvIHRoZSB2YWx1ZSBzcGVjaWZpZWQKLmVuZCgpLmFuaW1hdGUoeyBvcGFjaXR5OiB0byB9LCBzcGVlZCwgZWFzaW5nLCBjYWxsYmFjayk7CiAgICB9LAogICAgYW5pbWF0ZTogZnVuY3Rpb24gKHByb3AsIHNwZWVkLCBlYXNpbmcsIGNhbGxiYWNrKSB7CiAgICAgIHZhciBlbXB0eSA9IGpRdWVyeS5pc0VtcHR5T2JqZWN0KHByb3ApLCBvcHRhbGwgPSBqUXVlcnkuc3BlZWQoc3BlZWQsIGVhc2luZywgY2FsbGJhY2spLCBkb0FuaW1hdGlvbiA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIC8vIE9wZXJhdGUgb24gYSBjb3B5IG9mIHByb3Agc28gcGVyLXByb3BlcnR5IGVhc2luZyB3b24ndCBiZSBsb3N0CiAgICAgICAgICB2YXIgYW5pbSA9IEFuaW1hdGlvbih0aGlzLCBqUXVlcnkuZXh0ZW5kKHt9LCBwcm9wKSwgb3B0YWxsKTsKICAgICAgICAgIC8vIEVtcHR5IGFuaW1hdGlvbnMsIG9yIGZpbmlzaGluZyByZXNvbHZlcyBpbW1lZGlhdGVseQogICAgICAgICAgaWYgKGVtcHR5IHx8IGRhdGFfcHJpdi5nZXQodGhpcywgJ2ZpbmlzaCcpKSB7CiAgICAgICAgICAgIGFuaW0uc3RvcCh0cnVlKTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICBkb0FuaW1hdGlvbi5maW5pc2ggPSBkb0FuaW1hdGlvbjsKICAgICAgcmV0dXJuIGVtcHR5IHx8IG9wdGFsbC5xdWV1ZSA9PT0gZmFsc2UgPyB0aGlzLmVhY2goZG9BbmltYXRpb24pIDogdGhpcy5xdWV1ZShvcHRhbGwucXVldWUsIGRvQW5pbWF0aW9uKTsKICAgIH0sCiAgICBzdG9wOiBmdW5jdGlvbiAodHlwZSwgY2xlYXJRdWV1ZSwgZ290b0VuZCkgewogICAgICB2YXIgc3RvcFF1ZXVlID0gZnVuY3Rpb24gKGhvb2tzKSB7CiAgICAgICAgdmFyIHN0b3AgPSBob29rcy5zdG9wOwogICAgICAgIGRlbGV0ZSBob29rcy5zdG9wOwogICAgICAgIHN0b3AoZ290b0VuZCk7CiAgICAgIH07CiAgICAgIGlmICh0eXBlb2YgdHlwZSAhPT0gJ3N0cmluZycpIHsKICAgICAgICBnb3RvRW5kID0gY2xlYXJRdWV1ZTsKICAgICAgICBjbGVhclF1ZXVlID0gdHlwZTsKICAgICAgICB0eXBlID0gdW5kZWZpbmVkOwogICAgICB9CiAgICAgIGlmIChjbGVhclF1ZXVlICYmIHR5cGUgIT09IGZhbHNlKSB7CiAgICAgICAgdGhpcy5xdWV1ZSh0eXBlIHx8ICdmeCcsIFtdKTsKICAgICAgfQogICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgZGVxdWV1ZSA9IHRydWUsIGluZGV4ID0gdHlwZSAhPSBudWxsICYmIHR5cGUgKyAncXVldWVIb29rcycsIHRpbWVycyA9IGpRdWVyeS50aW1lcnMsIGRhdGEgPSBkYXRhX3ByaXYuZ2V0KHRoaXMpOwogICAgICAgIGlmIChpbmRleCkgewogICAgICAgICAgaWYgKGRhdGFbaW5kZXhdICYmIGRhdGFbaW5kZXhdLnN0b3ApIHsKICAgICAgICAgICAgc3RvcFF1ZXVlKGRhdGFbaW5kZXhdKTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgZm9yIChpbmRleCBpbiBkYXRhKSB7CiAgICAgICAgICAgIGlmIChkYXRhW2luZGV4XSAmJiBkYXRhW2luZGV4XS5zdG9wICYmIHJydW4udGVzdChpbmRleCkpIHsKICAgICAgICAgICAgICBzdG9wUXVldWUoZGF0YVtpbmRleF0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZvciAoaW5kZXggPSB0aW1lcnMubGVuZ3RoOyBpbmRleC0tOykgewogICAgICAgICAgaWYgKHRpbWVyc1tpbmRleF0uZWxlbSA9PT0gdGhpcyAmJiAodHlwZSA9PSBudWxsIHx8IHRpbWVyc1tpbmRleF0ucXVldWUgPT09IHR5cGUpKSB7CiAgICAgICAgICAgIHRpbWVyc1tpbmRleF0uYW5pbS5zdG9wKGdvdG9FbmQpOwogICAgICAgICAgICBkZXF1ZXVlID0gZmFsc2U7CiAgICAgICAgICAgIHRpbWVycy5zcGxpY2UoaW5kZXgsIDEpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAvLyBzdGFydCB0aGUgbmV4dCBpbiB0aGUgcXVldWUgaWYgdGhlIGxhc3Qgc3RlcCB3YXNuJ3QgZm9yY2VkCiAgICAgICAgLy8gdGltZXJzIGN1cnJlbnRseSB3aWxsIGNhbGwgdGhlaXIgY29tcGxldGUgY2FsbGJhY2tzLCB3aGljaCB3aWxsIGRlcXVldWUKICAgICAgICAvLyBidXQgb25seSBpZiB0aGV5IHdlcmUgZ290b0VuZAogICAgICAgIGlmIChkZXF1ZXVlIHx8ICFnb3RvRW5kKSB7CiAgICAgICAgICBqUXVlcnkuZGVxdWV1ZSh0aGlzLCB0eXBlKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSwKICAgIGZpbmlzaDogZnVuY3Rpb24gKHR5cGUpIHsKICAgICAgaWYgKHR5cGUgIT09IGZhbHNlKSB7CiAgICAgICAgdHlwZSA9IHR5cGUgfHwgJ2Z4JzsKICAgICAgfQogICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgaW5kZXgsIGRhdGEgPSBkYXRhX3ByaXYuZ2V0KHRoaXMpLCBxdWV1ZSA9IGRhdGFbdHlwZSArICdxdWV1ZSddLCBob29rcyA9IGRhdGFbdHlwZSArICdxdWV1ZUhvb2tzJ10sIHRpbWVycyA9IGpRdWVyeS50aW1lcnMsIGxlbmd0aCA9IHF1ZXVlID8gcXVldWUubGVuZ3RoIDogMDsKICAgICAgICAvLyBlbmFibGUgZmluaXNoaW5nIGZsYWcgb24gcHJpdmF0ZSBkYXRhCiAgICAgICAgZGF0YS5maW5pc2ggPSB0cnVlOwogICAgICAgIC8vIGVtcHR5IHRoZSBxdWV1ZSBmaXJzdAogICAgICAgIGpRdWVyeS5xdWV1ZSh0aGlzLCB0eXBlLCBbXSk7CiAgICAgICAgaWYgKGhvb2tzICYmIGhvb2tzLnN0b3ApIHsKICAgICAgICAgIGhvb2tzLnN0b3AuY2FsbCh0aGlzLCB0cnVlKTsKICAgICAgICB9CiAgICAgICAgLy8gbG9vayBmb3IgYW55IGFjdGl2ZSBhbmltYXRpb25zLCBhbmQgZmluaXNoIHRoZW0KICAgICAgICBmb3IgKGluZGV4ID0gdGltZXJzLmxlbmd0aDsgaW5kZXgtLTspIHsKICAgICAgICAgIGlmICh0aW1lcnNbaW5kZXhdLmVsZW0gPT09IHRoaXMgJiYgdGltZXJzW2luZGV4XS5xdWV1ZSA9PT0gdHlwZSkgewogICAgICAgICAgICB0aW1lcnNbaW5kZXhdLmFuaW0uc3RvcCh0cnVlKTsKICAgICAgICAgICAgdGltZXJzLnNwbGljZShpbmRleCwgMSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIC8vIGxvb2sgZm9yIGFueSBhbmltYXRpb25zIGluIHRoZSBvbGQgcXVldWUgYW5kIGZpbmlzaCB0aGVtCiAgICAgICAgZm9yIChpbmRleCA9IDA7IGluZGV4IDwgbGVuZ3RoOyBpbmRleCsrKSB7CiAgICAgICAgICBpZiAocXVldWVbaW5kZXhdICYmIHF1ZXVlW2luZGV4XS5maW5pc2gpIHsKICAgICAgICAgICAgcXVldWVbaW5kZXhdLmZpbmlzaC5jYWxsKHRoaXMpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAvLyB0dXJuIG9mZiBmaW5pc2hpbmcgZmxhZwogICAgICAgIGRlbGV0ZSBkYXRhLmZpbmlzaDsKICAgICAgfSk7CiAgICB9CiAgfSk7CiAgalF1ZXJ5LmVhY2goWwogICAgJ3RvZ2dsZScsCiAgICAnc2hvdycsCiAgICAnaGlkZScKICBdLCBmdW5jdGlvbiAoaSwgbmFtZSkgewogICAgdmFyIGNzc0ZuID0galF1ZXJ5LmZuW25hbWVdOwogICAgalF1ZXJ5LmZuW25hbWVdID0gZnVuY3Rpb24gKHNwZWVkLCBlYXNpbmcsIGNhbGxiYWNrKSB7CiAgICAgIHJldHVybiBzcGVlZCA9PSBudWxsIHx8IHR5cGVvZiBzcGVlZCA9PT0gJ2Jvb2xlYW4nID8gY3NzRm4uYXBwbHkodGhpcywgYXJndW1lbnRzKSA6IHRoaXMuYW5pbWF0ZShnZW5GeChuYW1lLCB0cnVlKSwgc3BlZWQsIGVhc2luZywgY2FsbGJhY2spOwogICAgfTsKICB9KTsKICAvLyBHZW5lcmF0ZSBzaG9ydGN1dHMgZm9yIGN1c3RvbSBhbmltYXRpb25zCiAgalF1ZXJ5LmVhY2goewogICAgc2xpZGVEb3duOiBnZW5GeCgnc2hvdycpLAogICAgc2xpZGVVcDogZ2VuRngoJ2hpZGUnKSwKICAgIHNsaWRlVG9nZ2xlOiBnZW5GeCgndG9nZ2xlJyksCiAgICBmYWRlSW46IHsgb3BhY2l0eTogJ3Nob3cnIH0sCiAgICBmYWRlT3V0OiB7IG9wYWNpdHk6ICdoaWRlJyB9LAogICAgZmFkZVRvZ2dsZTogeyBvcGFjaXR5OiAndG9nZ2xlJyB9CiAgfSwgZnVuY3Rpb24gKG5hbWUsIHByb3BzKSB7CiAgICBqUXVlcnkuZm5bbmFtZV0gPSBmdW5jdGlvbiAoc3BlZWQsIGVhc2luZywgY2FsbGJhY2spIHsKICAgICAgcmV0dXJuIHRoaXMuYW5pbWF0ZShwcm9wcywgc3BlZWQsIGVhc2luZywgY2FsbGJhY2spOwogICAgfTsKICB9KTsKICBqUXVlcnkudGltZXJzID0gW107CiAgalF1ZXJ5LmZ4LnRpY2sgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgdGltZXIsIGkgPSAwLCB0aW1lcnMgPSBqUXVlcnkudGltZXJzOwogICAgZnhOb3cgPSBqUXVlcnkubm93KCk7CiAgICBmb3IgKDsgaSA8IHRpbWVycy5sZW5ndGg7IGkrKykgewogICAgICB0aW1lciA9IHRpbWVyc1tpXTsKICAgICAgLy8gQ2hlY2tzIHRoZSB0aW1lciBoYXMgbm90IGFscmVhZHkgYmVlbiByZW1vdmVkCiAgICAgIGlmICghdGltZXIoKSAmJiB0aW1lcnNbaV0gPT09IHRpbWVyKSB7CiAgICAgICAgdGltZXJzLnNwbGljZShpLS0sIDEpOwogICAgICB9CiAgICB9CiAgICBpZiAoIXRpbWVycy5sZW5ndGgpIHsKICAgICAgalF1ZXJ5LmZ4LnN0b3AoKTsKICAgIH0KICAgIGZ4Tm93ID0gdW5kZWZpbmVkOwogIH07CiAgalF1ZXJ5LmZ4LnRpbWVyID0gZnVuY3Rpb24gKHRpbWVyKSB7CiAgICBqUXVlcnkudGltZXJzLnB1c2godGltZXIpOwogICAgaWYgKHRpbWVyKCkpIHsKICAgICAgalF1ZXJ5LmZ4LnN0YXJ0KCk7CiAgICB9IGVsc2UgewogICAgICBqUXVlcnkudGltZXJzLnBvcCgpOwogICAgfQogIH07CiAgalF1ZXJ5LmZ4LmludGVydmFsID0gMTM7CiAgalF1ZXJ5LmZ4LnN0YXJ0ID0gZnVuY3Rpb24gKCkgewogICAgaWYgKCF0aW1lcklkKSB7CiAgICAgIHRpbWVySWQgPSBzZXRJbnRlcnZhbChqUXVlcnkuZngudGljaywgalF1ZXJ5LmZ4LmludGVydmFsKTsKICAgIH0KICB9OwogIGpRdWVyeS5meC5zdG9wID0gZnVuY3Rpb24gKCkgewogICAgY2xlYXJJbnRlcnZhbCh0aW1lcklkKTsKICAgIHRpbWVySWQgPSBudWxsOwogIH07CiAgalF1ZXJ5LmZ4LnNwZWVkcyA9IHsKICAgIHNsb3c6IDYwMCwKICAgIGZhc3Q6IDIwMCwKICAgIC8vIERlZmF1bHQgc3BlZWQKICAgIF9kZWZhdWx0OiA0MDAKICB9OwogIC8vIEJhc2VkIG9mZiBvZiB0aGUgcGx1Z2luIGJ5IENsaW50IEhlbGZlcnMsIHdpdGggcGVybWlzc2lvbi4KICAvLyBodHRwOi8vYmxpbmRzaWduYWxzLmNvbS9pbmRleC5waHAvMjAwOS8wNy9qcXVlcnktZGVsYXkvCiAgalF1ZXJ5LmZuLmRlbGF5ID0gZnVuY3Rpb24gKHRpbWUsIHR5cGUpIHsKICAgIHRpbWUgPSBqUXVlcnkuZnggPyBqUXVlcnkuZnguc3BlZWRzW3RpbWVdIHx8IHRpbWUgOiB0aW1lOwogICAgdHlwZSA9IHR5cGUgfHwgJ2Z4JzsKICAgIHJldHVybiB0aGlzLnF1ZXVlKHR5cGUsIGZ1bmN0aW9uIChuZXh0LCBob29rcykgewogICAgICB2YXIgdGltZW91dCA9IHNldFRpbWVvdXQobmV4dCwgdGltZSk7CiAgICAgIGhvb2tzLnN0b3AgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgY2xlYXJUaW1lb3V0KHRpbWVvdXQpOwogICAgICB9OwogICAgfSk7CiAgfTsKICAoZnVuY3Rpb24gKCkgewogICAgdmFyIGlucHV0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnaW5wdXQnKSwgc2VsZWN0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc2VsZWN0JyksIG9wdCA9IHNlbGVjdC5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdvcHRpb24nKSk7CiAgICBpbnB1dC50eXBlID0gJ2NoZWNrYm94JzsKICAgIC8vIFN1cHBvcnQ6IGlPUyA1LjEsIEFuZHJvaWQgNC54LCBBbmRyb2lkIDIuMwogICAgLy8gQ2hlY2sgdGhlIGRlZmF1bHQgY2hlY2tib3gvcmFkaW8gdmFsdWUgKCIiIG9uIG9sZCBXZWJLaXQ7ICJvbiIgZWxzZXdoZXJlKQogICAgc3VwcG9ydC5jaGVja09uID0gaW5wdXQudmFsdWUgIT09ICcnOwogICAgLy8gTXVzdCBhY2Nlc3MgdGhlIHBhcmVudCB0byBtYWtlIGFuIG9wdGlvbiBzZWxlY3QgcHJvcGVybHkKICAgIC8vIFN1cHBvcnQ6IElFOSwgSUUxMAogICAgc3VwcG9ydC5vcHRTZWxlY3RlZCA9IG9wdC5zZWxlY3RlZDsKICAgIC8vIE1ha2Ugc3VyZSB0aGF0IHRoZSBvcHRpb25zIGluc2lkZSBkaXNhYmxlZCBzZWxlY3RzIGFyZW4ndCBtYXJrZWQgYXMgZGlzYWJsZWQKICAgIC8vIChXZWJLaXQgbWFya3MgdGhlbSBhcyBkaXNhYmxlZCkKICAgIHNlbGVjdC5kaXNhYmxlZCA9IHRydWU7CiAgICBzdXBwb3J0Lm9wdERpc2FibGVkID0gIW9wdC5kaXNhYmxlZDsKICAgIC8vIENoZWNrIGlmIGFuIGlucHV0IG1haW50YWlucyBpdHMgdmFsdWUgYWZ0ZXIgYmVjb21pbmcgYSByYWRpbwogICAgLy8gU3VwcG9ydDogSUU5LCBJRTEwCiAgICBpbnB1dCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2lucHV0Jyk7CiAgICBpbnB1dC52YWx1ZSA9ICd0JzsKICAgIGlucHV0LnR5cGUgPSAncmFkaW8nOwogICAgc3VwcG9ydC5yYWRpb1ZhbHVlID0gaW5wdXQudmFsdWUgPT09ICd0JzsKICB9KCkpOwogIHZhciBub2RlSG9vaywgYm9vbEhvb2ssIGF0dHJIYW5kbGUgPSBqUXVlcnkuZXhwci5hdHRySGFuZGxlOwogIGpRdWVyeS5mbi5leHRlbmQoewogICAgYXR0cjogZnVuY3Rpb24gKG5hbWUsIHZhbHVlKSB7CiAgICAgIHJldHVybiBhY2Nlc3ModGhpcywgalF1ZXJ5LmF0dHIsIG5hbWUsIHZhbHVlLCBhcmd1bWVudHMubGVuZ3RoID4gMSk7CiAgICB9LAogICAgcmVtb3ZlQXR0cjogZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgalF1ZXJ5LnJlbW92ZUF0dHIodGhpcywgbmFtZSk7CiAgICAgIH0pOwogICAgfQogIH0pOwogIGpRdWVyeS5leHRlbmQoewogICAgYXR0cjogZnVuY3Rpb24gKGVsZW0sIG5hbWUsIHZhbHVlKSB7CiAgICAgIHZhciBob29rcywgcmV0LCBuVHlwZSA9IGVsZW0ubm9kZVR5cGU7CiAgICAgIC8vIGRvbid0IGdldC9zZXQgYXR0cmlidXRlcyBvbiB0ZXh0LCBjb21tZW50IGFuZCBhdHRyaWJ1dGUgbm9kZXMKICAgICAgaWYgKCFlbGVtIHx8IG5UeXBlID09PSAzIHx8IG5UeXBlID09PSA4IHx8IG5UeXBlID09PSAyKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIC8vIEZhbGxiYWNrIHRvIHByb3Agd2hlbiBhdHRyaWJ1dGVzIGFyZSBub3Qgc3VwcG9ydGVkCiAgICAgIGlmICh0eXBlb2YgZWxlbS5nZXRBdHRyaWJ1dGUgPT09IHN0cnVuZGVmaW5lZCkgewogICAgICAgIHJldHVybiBqUXVlcnkucHJvcChlbGVtLCBuYW1lLCB2YWx1ZSk7CiAgICAgIH0KICAgICAgLy8gQWxsIGF0dHJpYnV0ZXMgYXJlIGxvd2VyY2FzZQogICAgICAvLyBHcmFiIG5lY2Vzc2FyeSBob29rIGlmIG9uZSBpcyBkZWZpbmVkCiAgICAgIGlmIChuVHlwZSAhPT0gMSB8fCAhalF1ZXJ5LmlzWE1MRG9jKGVsZW0pKSB7CiAgICAgICAgbmFtZSA9IG5hbWUudG9Mb3dlckNhc2UoKTsKICAgICAgICBob29rcyA9IGpRdWVyeS5hdHRySG9va3NbbmFtZV0gfHwgKGpRdWVyeS5leHByLm1hdGNoLmJvb2wudGVzdChuYW1lKSA/IGJvb2xIb29rIDogbm9kZUhvb2spOwogICAgICB9CiAgICAgIGlmICh2YWx1ZSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgaWYgKHZhbHVlID09PSBudWxsKSB7CiAgICAgICAgICBqUXVlcnkucmVtb3ZlQXR0cihlbGVtLCBuYW1lKTsKICAgICAgICB9IGVsc2UgaWYgKGhvb2tzICYmICdzZXQnIGluIGhvb2tzICYmIChyZXQgPSBob29rcy5zZXQoZWxlbSwgdmFsdWUsIG5hbWUpKSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICByZXR1cm4gcmV0OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBlbGVtLnNldEF0dHJpYnV0ZShuYW1lLCB2YWx1ZSArICcnKTsKICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICB9CiAgICAgIH0gZWxzZSBpZiAoaG9va3MgJiYgJ2dldCcgaW4gaG9va3MgJiYgKHJldCA9IGhvb2tzLmdldChlbGVtLCBuYW1lKSkgIT09IG51bGwpIHsKICAgICAgICByZXR1cm4gcmV0OwogICAgICB9IGVsc2UgewogICAgICAgIHJldCA9IGpRdWVyeS5maW5kLmF0dHIoZWxlbSwgbmFtZSk7CiAgICAgICAgLy8gTm9uLWV4aXN0ZW50IGF0dHJpYnV0ZXMgcmV0dXJuIG51bGwsIHdlIG5vcm1hbGl6ZSB0byB1bmRlZmluZWQKICAgICAgICByZXR1cm4gcmV0ID09IG51bGwgPyB1bmRlZmluZWQgOiByZXQ7CiAgICAgIH0KICAgIH0sCiAgICByZW1vdmVBdHRyOiBmdW5jdGlvbiAoZWxlbSwgdmFsdWUpIHsKICAgICAgdmFyIG5hbWUsIHByb3BOYW1lLCBpID0gMCwgYXR0ck5hbWVzID0gdmFsdWUgJiYgdmFsdWUubWF0Y2gocm5vdHdoaXRlKTsKICAgICAgaWYgKGF0dHJOYW1lcyAmJiBlbGVtLm5vZGVUeXBlID09PSAxKSB7CiAgICAgICAgd2hpbGUgKG5hbWUgPSBhdHRyTmFtZXNbaSsrXSkgewogICAgICAgICAgcHJvcE5hbWUgPSBqUXVlcnkucHJvcEZpeFtuYW1lXSB8fCBuYW1lOwogICAgICAgICAgLy8gQm9vbGVhbiBhdHRyaWJ1dGVzIGdldCBzcGVjaWFsIHRyZWF0bWVudCAoIzEwODcwKQogICAgICAgICAgaWYgKGpRdWVyeS5leHByLm1hdGNoLmJvb2wudGVzdChuYW1lKSkgewogICAgICAgICAgICAvLyBTZXQgY29ycmVzcG9uZGluZyBwcm9wZXJ0eSB0byBmYWxzZQogICAgICAgICAgICBlbGVtW3Byb3BOYW1lXSA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgZWxlbS5yZW1vdmVBdHRyaWJ1dGUobmFtZSk7CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgYXR0ckhvb2tzOiB7CiAgICAgIHR5cGU6IHsKICAgICAgICBzZXQ6IGZ1bmN0aW9uIChlbGVtLCB2YWx1ZSkgewogICAgICAgICAgaWYgKCFzdXBwb3J0LnJhZGlvVmFsdWUgJiYgdmFsdWUgPT09ICdyYWRpbycgJiYgalF1ZXJ5Lm5vZGVOYW1lKGVsZW0sICdpbnB1dCcpKSB7CiAgICAgICAgICAgIC8vIFNldHRpbmcgdGhlIHR5cGUgb24gYSByYWRpbyBidXR0b24gYWZ0ZXIgdGhlIHZhbHVlIHJlc2V0cyB0aGUgdmFsdWUgaW4gSUU2LTkKICAgICAgICAgICAgLy8gUmVzZXQgdmFsdWUgdG8gZGVmYXVsdCBpbiBjYXNlIHR5cGUgaXMgc2V0IGFmdGVyIHZhbHVlIGR1cmluZyBjcmVhdGlvbgogICAgICAgICAgICB2YXIgdmFsID0gZWxlbS52YWx1ZTsKICAgICAgICAgICAgZWxlbS5zZXRBdHRyaWJ1dGUoJ3R5cGUnLCB2YWx1ZSk7CiAgICAgICAgICAgIGlmICh2YWwpIHsKICAgICAgICAgICAgICBlbGVtLnZhbHVlID0gdmFsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9KTsKICAvLyBIb29rcyBmb3IgYm9vbGVhbiBhdHRyaWJ1dGVzCiAgYm9vbEhvb2sgPSB7CiAgICBzZXQ6IGZ1bmN0aW9uIChlbGVtLCB2YWx1ZSwgbmFtZSkgewogICAgICBpZiAodmFsdWUgPT09IGZhbHNlKSB7CiAgICAgICAgLy8gUmVtb3ZlIGJvb2xlYW4gYXR0cmlidXRlcyB3aGVuIHNldCB0byBmYWxzZQogICAgICAgIGpRdWVyeS5yZW1vdmVBdHRyKGVsZW0sIG5hbWUpOwogICAgICB9IGVsc2UgewogICAgICAgIGVsZW0uc2V0QXR0cmlidXRlKG5hbWUsIG5hbWUpOwogICAgICB9CiAgICAgIHJldHVybiBuYW1lOwogICAgfQogIH07CiAgalF1ZXJ5LmVhY2goalF1ZXJ5LmV4cHIubWF0Y2guYm9vbC5zb3VyY2UubWF0Y2goL1x3Ky9nKSwgZnVuY3Rpb24gKGksIG5hbWUpIHsKICAgIHZhciBnZXR0ZXIgPSBhdHRySGFuZGxlW25hbWVdIHx8IGpRdWVyeS5maW5kLmF0dHI7CiAgICBhdHRySGFuZGxlW25hbWVdID0gZnVuY3Rpb24gKGVsZW0sIG5hbWUsIGlzWE1MKSB7CiAgICAgIHZhciByZXQsIGhhbmRsZTsKICAgICAgaWYgKCFpc1hNTCkgewogICAgICAgIC8vIEF2b2lkIGFuIGluZmluaXRlIGxvb3AgYnkgdGVtcG9yYXJpbHkgcmVtb3ZpbmcgdGhpcyBmdW5jdGlvbiBmcm9tIHRoZSBnZXR0ZXIKICAgICAgICBoYW5kbGUgPSBhdHRySGFuZGxlW25hbWVdOwogICAgICAgIGF0dHJIYW5kbGVbbmFtZV0gPSByZXQ7CiAgICAgICAgcmV0ID0gZ2V0dGVyKGVsZW0sIG5hbWUsIGlzWE1MKSAhPSBudWxsID8gbmFtZS50b0xvd2VyQ2FzZSgpIDogbnVsbDsKICAgICAgICBhdHRySGFuZGxlW25hbWVdID0gaGFuZGxlOwogICAgICB9CiAgICAgIHJldHVybiByZXQ7CiAgICB9OwogIH0pOwogIHZhciByZm9jdXNhYmxlID0gL14oPzppbnB1dHxzZWxlY3R8dGV4dGFyZWF8YnV0dG9uKSQvaTsKICBqUXVlcnkuZm4uZXh0ZW5kKHsKICAgIHByb3A6IGZ1bmN0aW9uIChuYW1lLCB2YWx1ZSkgewogICAgICByZXR1cm4gYWNjZXNzKHRoaXMsIGpRdWVyeS5wcm9wLCBuYW1lLCB2YWx1ZSwgYXJndW1lbnRzLmxlbmd0aCA+IDEpOwogICAgfSwKICAgIHJlbW92ZVByb3A6IGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24gKCkgewogICAgICAgIGRlbGV0ZSB0aGlzW2pRdWVyeS5wcm9wRml4W25hbWVdIHx8IG5hbWVdOwogICAgICB9KTsKICAgIH0KICB9KTsKICBqUXVlcnkuZXh0ZW5kKHsKICAgIHByb3BGaXg6IHsKICAgICAgJ2Zvcic6ICdodG1sRm9yJywKICAgICAgJ2NsYXNzJzogJ2NsYXNzTmFtZScKICAgIH0sCiAgICBwcm9wOiBmdW5jdGlvbiAoZWxlbSwgbmFtZSwgdmFsdWUpIHsKICAgICAgdmFyIHJldCwgaG9va3MsIG5vdHhtbCwgblR5cGUgPSBlbGVtLm5vZGVUeXBlOwogICAgICAvLyBkb24ndCBnZXQvc2V0IHByb3BlcnRpZXMgb24gdGV4dCwgY29tbWVudCBhbmQgYXR0cmlidXRlIG5vZGVzCiAgICAgIGlmICghZWxlbSB8fCBuVHlwZSA9PT0gMyB8fCBuVHlwZSA9PT0gOCB8fCBuVHlwZSA9PT0gMikgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBub3R4bWwgPSBuVHlwZSAhPT0gMSB8fCAhalF1ZXJ5LmlzWE1MRG9jKGVsZW0pOwogICAgICBpZiAobm90eG1sKSB7CiAgICAgICAgLy8gRml4IG5hbWUgYW5kIGF0dGFjaCBob29rcwogICAgICAgIG5hbWUgPSBqUXVlcnkucHJvcEZpeFtuYW1lXSB8fCBuYW1lOwogICAgICAgIGhvb2tzID0galF1ZXJ5LnByb3BIb29rc1tuYW1lXTsKICAgICAgfQogICAgICBpZiAodmFsdWUgIT09IHVuZGVmaW5lZCkgewogICAgICAgIHJldHVybiBob29rcyAmJiAnc2V0JyBpbiBob29rcyAmJiAocmV0ID0gaG9va3Muc2V0KGVsZW0sIHZhbHVlLCBuYW1lKSkgIT09IHVuZGVmaW5lZCA/IHJldCA6IGVsZW1bbmFtZV0gPSB2YWx1ZTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gaG9va3MgJiYgJ2dldCcgaW4gaG9va3MgJiYgKHJldCA9IGhvb2tzLmdldChlbGVtLCBuYW1lKSkgIT09IG51bGwgPyByZXQgOiBlbGVtW25hbWVdOwogICAgICB9CiAgICB9LAogICAgcHJvcEhvb2tzOiB7CiAgICAgIHRhYkluZGV4OiB7CiAgICAgICAgZ2V0OiBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgcmV0dXJuIGVsZW0uaGFzQXR0cmlidXRlKCd0YWJpbmRleCcpIHx8IHJmb2N1c2FibGUudGVzdChlbGVtLm5vZGVOYW1lKSB8fCBlbGVtLmhyZWYgPyBlbGVtLnRhYkluZGV4IDogLTE7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfSk7CiAgLy8gU3VwcG9ydDogSUU5KwogIC8vIFNlbGVjdGVkbmVzcyBmb3IgYW4gb3B0aW9uIGluIGFuIG9wdGdyb3VwIGNhbiBiZSBpbmFjY3VyYXRlCiAgaWYgKCFzdXBwb3J0Lm9wdFNlbGVjdGVkKSB7CiAgICBqUXVlcnkucHJvcEhvb2tzLnNlbGVjdGVkID0gewogICAgICBnZXQ6IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgdmFyIHBhcmVudCA9IGVsZW0ucGFyZW50Tm9kZTsKICAgICAgICBpZiAocGFyZW50ICYmIHBhcmVudC5wYXJlbnROb2RlKSB7CiAgICAgICAgICBwYXJlbnQucGFyZW50Tm9kZS5zZWxlY3RlZEluZGV4OwogICAgICAgIH0KICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgfQogICAgfTsKICB9CiAgalF1ZXJ5LmVhY2goWwogICAgJ3RhYkluZGV4JywKICAgICdyZWFkT25seScsCiAgICAnbWF4TGVuZ3RoJywKICAgICdjZWxsU3BhY2luZycsCiAgICAnY2VsbFBhZGRpbmcnLAogICAgJ3Jvd1NwYW4nLAogICAgJ2NvbFNwYW4nLAogICAgJ3VzZU1hcCcsCiAgICAnZnJhbWVCb3JkZXInLAogICAgJ2NvbnRlbnRFZGl0YWJsZScKICBdLCBmdW5jdGlvbiAoKSB7CiAgICBqUXVlcnkucHJvcEZpeFt0aGlzLnRvTG93ZXJDYXNlKCldID0gdGhpczsKICB9KTsKICB2YXIgcmNsYXNzID0gL1tcdFxyXG5cZl0vZzsKICBqUXVlcnkuZm4uZXh0ZW5kKHsKICAgIGFkZENsYXNzOiBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgdmFyIGNsYXNzZXMsIGVsZW0sIGN1ciwgY2xhenosIGosIGZpbmFsVmFsdWUsIHByb2NlZWQgPSB0eXBlb2YgdmFsdWUgPT09ICdzdHJpbmcnICYmIHZhbHVlLCBpID0gMCwgbGVuID0gdGhpcy5sZW5ndGg7CiAgICAgIGlmIChqUXVlcnkuaXNGdW5jdGlvbih2YWx1ZSkpIHsKICAgICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uIChqKSB7CiAgICAgICAgICBqUXVlcnkodGhpcykuYWRkQ2xhc3ModmFsdWUuY2FsbCh0aGlzLCBqLCB0aGlzLmNsYXNzTmFtZSkpOwogICAgICAgIH0pOwogICAgICB9CiAgICAgIGlmIChwcm9jZWVkKSB7CiAgICAgICAgLy8gVGhlIGRpc2p1bmN0aW9uIGhlcmUgaXMgZm9yIGJldHRlciBjb21wcmVzc2liaWxpdHkgKHNlZSByZW1vdmVDbGFzcykKICAgICAgICBjbGFzc2VzID0gKHZhbHVlIHx8ICcnKS5tYXRjaChybm90d2hpdGUpIHx8IFtdOwogICAgICAgIGZvciAoOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgIGVsZW0gPSB0aGlzW2ldOwogICAgICAgICAgY3VyID0gZWxlbS5ub2RlVHlwZSA9PT0gMSAmJiAoZWxlbS5jbGFzc05hbWUgPyAoJyAnICsgZWxlbS5jbGFzc05hbWUgKyAnICcpLnJlcGxhY2UocmNsYXNzLCAnICcpIDogJyAnKTsKICAgICAgICAgIGlmIChjdXIpIHsKICAgICAgICAgICAgaiA9IDA7CiAgICAgICAgICAgIHdoaWxlIChjbGF6eiA9IGNsYXNzZXNbaisrXSkgewogICAgICAgICAgICAgIGlmIChjdXIuaW5kZXhPZignICcgKyBjbGF6eiArICcgJykgPCAwKSB7CiAgICAgICAgICAgICAgICBjdXIgKz0gY2xhenogKyAnICc7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIG9ubHkgYXNzaWduIGlmIGRpZmZlcmVudCB0byBhdm9pZCB1bm5lZWRlZCByZW5kZXJpbmcuCiAgICAgICAgICAgIGZpbmFsVmFsdWUgPSBqUXVlcnkudHJpbShjdXIpOwogICAgICAgICAgICBpZiAoZWxlbS5jbGFzc05hbWUgIT09IGZpbmFsVmFsdWUpIHsKICAgICAgICAgICAgICBlbGVtLmNsYXNzTmFtZSA9IGZpbmFsVmFsdWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogICAgcmVtb3ZlQ2xhc3M6IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICB2YXIgY2xhc3NlcywgZWxlbSwgY3VyLCBjbGF6eiwgaiwgZmluYWxWYWx1ZSwgcHJvY2VlZCA9IGFyZ3VtZW50cy5sZW5ndGggPT09IDAgfHwgdHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJyAmJiB2YWx1ZSwgaSA9IDAsIGxlbiA9IHRoaXMubGVuZ3RoOwogICAgICBpZiAoalF1ZXJ5LmlzRnVuY3Rpb24odmFsdWUpKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoaikgewogICAgICAgICAgalF1ZXJ5KHRoaXMpLnJlbW92ZUNsYXNzKHZhbHVlLmNhbGwodGhpcywgaiwgdGhpcy5jbGFzc05hbWUpKTsKICAgICAgICB9KTsKICAgICAgfQogICAgICBpZiAocHJvY2VlZCkgewogICAgICAgIGNsYXNzZXMgPSAodmFsdWUgfHwgJycpLm1hdGNoKHJub3R3aGl0ZSkgfHwgW107CiAgICAgICAgZm9yICg7IGkgPCBsZW47IGkrKykgewogICAgICAgICAgZWxlbSA9IHRoaXNbaV07CiAgICAgICAgICAvLyBUaGlzIGV4cHJlc3Npb24gaXMgaGVyZSBmb3IgYmV0dGVyIGNvbXByZXNzaWJpbGl0eSAoc2VlIGFkZENsYXNzKQogICAgICAgICAgY3VyID0gZWxlbS5ub2RlVHlwZSA9PT0gMSAmJiAoZWxlbS5jbGFzc05hbWUgPyAoJyAnICsgZWxlbS5jbGFzc05hbWUgKyAnICcpLnJlcGxhY2UocmNsYXNzLCAnICcpIDogJycpOwogICAgICAgICAgaWYgKGN1cikgewogICAgICAgICAgICBqID0gMDsKICAgICAgICAgICAgd2hpbGUgKGNsYXp6ID0gY2xhc3Nlc1tqKytdKSB7CiAgICAgICAgICAgICAgLy8gUmVtb3ZlICphbGwqIGluc3RhbmNlcwogICAgICAgICAgICAgIHdoaWxlIChjdXIuaW5kZXhPZignICcgKyBjbGF6eiArICcgJykgPj0gMCkgewogICAgICAgICAgICAgICAgY3VyID0gY3VyLnJlcGxhY2UoJyAnICsgY2xhenogKyAnICcsICcgJyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIG9ubHkgYXNzaWduIGlmIGRpZmZlcmVudCB0byBhdm9pZCB1bm5lZWRlZCByZW5kZXJpbmcuCiAgICAgICAgICAgIGZpbmFsVmFsdWUgPSB2YWx1ZSA/IGpRdWVyeS50cmltKGN1cikgOiAnJzsKICAgICAgICAgICAgaWYgKGVsZW0uY2xhc3NOYW1lICE9PSBmaW5hbFZhbHVlKSB7CiAgICAgICAgICAgICAgZWxlbS5jbGFzc05hbWUgPSBmaW5hbFZhbHVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAgIHRvZ2dsZUNsYXNzOiBmdW5jdGlvbiAodmFsdWUsIHN0YXRlVmFsKSB7CiAgICAgIHZhciB0eXBlID0gdHlwZW9mIHZhbHVlOwogICAgICBpZiAodHlwZW9mIHN0YXRlVmFsID09PSAnYm9vbGVhbicgJiYgdHlwZSA9PT0gJ3N0cmluZycpIHsKICAgICAgICByZXR1cm4gc3RhdGVWYWwgPyB0aGlzLmFkZENsYXNzKHZhbHVlKSA6IHRoaXMucmVtb3ZlQ2xhc3ModmFsdWUpOwogICAgICB9CiAgICAgIGlmIChqUXVlcnkuaXNGdW5jdGlvbih2YWx1ZSkpIHsKICAgICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uIChpKSB7CiAgICAgICAgICBqUXVlcnkodGhpcykudG9nZ2xlQ2xhc3ModmFsdWUuY2FsbCh0aGlzLCBpLCB0aGlzLmNsYXNzTmFtZSwgc3RhdGVWYWwpLCBzdGF0ZVZhbCk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgaWYgKHR5cGUgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAvLyB0b2dnbGUgaW5kaXZpZHVhbCBjbGFzcyBuYW1lcwogICAgICAgICAgdmFyIGNsYXNzTmFtZSwgaSA9IDAsIHNlbGYgPSBqUXVlcnkodGhpcyksIGNsYXNzTmFtZXMgPSB2YWx1ZS5tYXRjaChybm90d2hpdGUpIHx8IFtdOwogICAgICAgICAgd2hpbGUgKGNsYXNzTmFtZSA9IGNsYXNzTmFtZXNbaSsrXSkgewogICAgICAgICAgICAvLyBjaGVjayBlYWNoIGNsYXNzTmFtZSBnaXZlbiwgc3BhY2Ugc2VwYXJhdGVkIGxpc3QKICAgICAgICAgICAgaWYgKHNlbGYuaGFzQ2xhc3MoY2xhc3NOYW1lKSkgewogICAgICAgICAgICAgIHNlbGYucmVtb3ZlQ2xhc3MoY2xhc3NOYW1lKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBzZWxmLmFkZENsYXNzKGNsYXNzTmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gIC8vIFRvZ2dsZSB3aG9sZSBjbGFzcyBuYW1lCiAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSBzdHJ1bmRlZmluZWQgfHwgdHlwZSA9PT0gJ2Jvb2xlYW4nKSB7CiAgICAgICAgICBpZiAodGhpcy5jbGFzc05hbWUpIHsKICAgICAgICAgICAgLy8gc3RvcmUgY2xhc3NOYW1lIGlmIHNldAogICAgICAgICAgICBkYXRhX3ByaXYuc2V0KHRoaXMsICdfX2NsYXNzTmFtZV9fJywgdGhpcy5jbGFzc05hbWUpOwogICAgICAgICAgfQogICAgICAgICAgLy8gSWYgdGhlIGVsZW1lbnQgaGFzIGEgY2xhc3MgbmFtZSBvciBpZiB3ZSdyZSBwYXNzZWQgImZhbHNlIiwKICAgICAgICAgIC8vIHRoZW4gcmVtb3ZlIHRoZSB3aG9sZSBjbGFzc25hbWUgKGlmIHRoZXJlIHdhcyBvbmUsIHRoZSBhYm92ZSBzYXZlZCBpdCkuCiAgICAgICAgICAvLyBPdGhlcndpc2UgYnJpbmcgYmFjayB3aGF0ZXZlciB3YXMgcHJldmlvdXNseSBzYXZlZCAoaWYgYW55dGhpbmcpLAogICAgICAgICAgLy8gZmFsbGluZyBiYWNrIHRvIHRoZSBlbXB0eSBzdHJpbmcgaWYgbm90aGluZyB3YXMgc3RvcmVkLgogICAgICAgICAgdGhpcy5jbGFzc05hbWUgPSB0aGlzLmNsYXNzTmFtZSB8fCB2YWx1ZSA9PT0gZmFsc2UgPyAnJyA6IGRhdGFfcHJpdi5nZXQodGhpcywgJ19fY2xhc3NOYW1lX18nKSB8fCAnJzsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSwKICAgIGhhc0NsYXNzOiBmdW5jdGlvbiAoc2VsZWN0b3IpIHsKICAgICAgdmFyIGNsYXNzTmFtZSA9ICcgJyArIHNlbGVjdG9yICsgJyAnLCBpID0gMCwgbCA9IHRoaXMubGVuZ3RoOwogICAgICBmb3IgKDsgaSA8IGw7IGkrKykgewogICAgICAgIGlmICh0aGlzW2ldLm5vZGVUeXBlID09PSAxICYmICgnICcgKyB0aGlzW2ldLmNsYXNzTmFtZSArICcgJykucmVwbGFjZShyY2xhc3MsICcgJykuaW5kZXhPZihjbGFzc05hbWUpID49IDApIHsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgfSk7CiAgdmFyIHJyZXR1cm4gPSAvXHIvZzsKICBqUXVlcnkuZm4uZXh0ZW5kKHsKICAgIHZhbDogZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgIHZhciBob29rcywgcmV0LCBpc0Z1bmN0aW9uLCBlbGVtID0gdGhpc1swXTsKICAgICAgaWYgKCFhcmd1bWVudHMubGVuZ3RoKSB7CiAgICAgICAgaWYgKGVsZW0pIHsKICAgICAgICAgIGhvb2tzID0galF1ZXJ5LnZhbEhvb2tzW2VsZW0udHlwZV0gfHwgalF1ZXJ5LnZhbEhvb2tzW2VsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKV07CiAgICAgICAgICBpZiAoaG9va3MgJiYgJ2dldCcgaW4gaG9va3MgJiYgKHJldCA9IGhvb2tzLmdldChlbGVtLCAndmFsdWUnKSkgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICByZXR1cm4gcmV0OwogICAgICAgICAgfQogICAgICAgICAgcmV0ID0gZWxlbS52YWx1ZTsKICAgICAgICAgIHJldHVybiB0eXBlb2YgcmV0ID09PSAnc3RyaW5nJyA/IC8vIGhhbmRsZSBtb3N0IGNvbW1vbiBzdHJpbmcgY2FzZXMKICAgICAgICAgIHJldC5yZXBsYWNlKHJyZXR1cm4sICcnKSA6IC8vIGhhbmRsZSBjYXNlcyB3aGVyZSB2YWx1ZSBpcyBudWxsL3VuZGVmIG9yIG51bWJlcgogICAgICAgICAgcmV0ID09IG51bGwgPyAnJyA6IHJldDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIGlzRnVuY3Rpb24gPSBqUXVlcnkuaXNGdW5jdGlvbih2YWx1ZSk7CiAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24gKGkpIHsKICAgICAgICB2YXIgdmFsOwogICAgICAgIGlmICh0aGlzLm5vZGVUeXBlICE9PSAxKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGlmIChpc0Z1bmN0aW9uKSB7CiAgICAgICAgICB2YWwgPSB2YWx1ZS5jYWxsKHRoaXMsIGksIGpRdWVyeSh0aGlzKS52YWwoKSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHZhbCA9IHZhbHVlOwogICAgICAgIH0KICAgICAgICAvLyBUcmVhdCBudWxsL3VuZGVmaW5lZCBhcyAiIjsgY29udmVydCBudW1iZXJzIHRvIHN0cmluZwogICAgICAgIGlmICh2YWwgPT0gbnVsbCkgewogICAgICAgICAgdmFsID0gJyc7CiAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgdmFsID09PSAnbnVtYmVyJykgewogICAgICAgICAgdmFsICs9ICcnOwogICAgICAgIH0gZWxzZSBpZiAoalF1ZXJ5LmlzQXJyYXkodmFsKSkgewogICAgICAgICAgdmFsID0galF1ZXJ5Lm1hcCh2YWwsIGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICByZXR1cm4gdmFsdWUgPT0gbnVsbCA/ICcnIDogdmFsdWUgKyAnJzsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBob29rcyA9IGpRdWVyeS52YWxIb29rc1t0aGlzLnR5cGVdIHx8IGpRdWVyeS52YWxIb29rc1t0aGlzLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCldOwogICAgICAgIC8vIElmIHNldCByZXR1cm5zIHVuZGVmaW5lZCwgZmFsbCBiYWNrIHRvIG5vcm1hbCBzZXR0aW5nCiAgICAgICAgaWYgKCFob29rcyB8fCAhKCdzZXQnIGluIGhvb2tzKSB8fCBob29rcy5zZXQodGhpcywgdmFsLCAndmFsdWUnKSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICB0aGlzLnZhbHVlID0gdmFsOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgfSk7CiAgalF1ZXJ5LmV4dGVuZCh7CiAgICB2YWxIb29rczogewogICAgICBvcHRpb246IHsKICAgICAgICBnZXQ6IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgICB2YXIgdmFsID0galF1ZXJ5LmZpbmQuYXR0cihlbGVtLCAndmFsdWUnKTsKICAgICAgICAgIHJldHVybiB2YWwgIT0gbnVsbCA/IHZhbCA6IC8vIFN1cHBvcnQ6IElFMTAtMTErCiAgICAgICAgICAvLyBvcHRpb24udGV4dCB0aHJvd3MgZXhjZXB0aW9ucyAoIzE0Njg2LCAjMTQ4NTgpCiAgICAgICAgICBqUXVlcnkudHJpbShqUXVlcnkudGV4dChlbGVtKSk7CiAgICAgICAgfQogICAgICB9LAogICAgICBzZWxlY3Q6IHsKICAgICAgICBnZXQ6IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgICB2YXIgdmFsdWUsIG9wdGlvbiwgb3B0aW9ucyA9IGVsZW0ub3B0aW9ucywgaW5kZXggPSBlbGVtLnNlbGVjdGVkSW5kZXgsIG9uZSA9IGVsZW0udHlwZSA9PT0gJ3NlbGVjdC1vbmUnIHx8IGluZGV4IDwgMCwgdmFsdWVzID0gb25lID8gbnVsbCA6IFtdLCBtYXggPSBvbmUgPyBpbmRleCArIDEgOiBvcHRpb25zLmxlbmd0aCwgaSA9IGluZGV4IDwgMCA/IG1heCA6IG9uZSA/IGluZGV4IDogMDsKICAgICAgICAgIC8vIExvb3AgdGhyb3VnaCBhbGwgdGhlIHNlbGVjdGVkIG9wdGlvbnMKICAgICAgICAgIGZvciAoOyBpIDwgbWF4OyBpKyspIHsKICAgICAgICAgICAgb3B0aW9uID0gb3B0aW9uc1tpXTsKICAgICAgICAgICAgLy8gSUU2LTkgZG9lc24ndCB1cGRhdGUgc2VsZWN0ZWQgYWZ0ZXIgZm9ybSByZXNldCAoIzI1NTEpCiAgICAgICAgICAgIGlmICgob3B0aW9uLnNlbGVjdGVkIHx8IGkgPT09IGluZGV4KSAmJiAoc3VwcG9ydC5vcHREaXNhYmxlZCA/ICFvcHRpb24uZGlzYWJsZWQgOiBvcHRpb24uZ2V0QXR0cmlidXRlKCdkaXNhYmxlZCcpID09PSBudWxsKSAmJiAoIW9wdGlvbi5wYXJlbnROb2RlLmRpc2FibGVkIHx8ICFqUXVlcnkubm9kZU5hbWUob3B0aW9uLnBhcmVudE5vZGUsICdvcHRncm91cCcpKSkgewogICAgICAgICAgICAgIC8vIEdldCB0aGUgc3BlY2lmaWMgdmFsdWUgZm9yIHRoZSBvcHRpb24KICAgICAgICAgICAgICB2YWx1ZSA9IGpRdWVyeShvcHRpb24pLnZhbCgpOwogICAgICAgICAgICAgIC8vIFdlIGRvbid0IG5lZWQgYW4gYXJyYXkgZm9yIG9uZSBzZWxlY3RzCiAgICAgICAgICAgICAgaWYgKG9uZSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAvLyBNdWx0aS1TZWxlY3RzIHJldHVybiBhbiBhcnJheQogICAgICAgICAgICAgIHZhbHVlcy5wdXNoKHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHZhbHVlczsKICAgICAgICB9LAogICAgICAgIHNldDogZnVuY3Rpb24gKGVsZW0sIHZhbHVlKSB7CiAgICAgICAgICB2YXIgb3B0aW9uU2V0LCBvcHRpb24sIG9wdGlvbnMgPSBlbGVtLm9wdGlvbnMsIHZhbHVlcyA9IGpRdWVyeS5tYWtlQXJyYXkodmFsdWUpLCBpID0gb3B0aW9ucy5sZW5ndGg7CiAgICAgICAgICB3aGlsZSAoaS0tKSB7CiAgICAgICAgICAgIG9wdGlvbiA9IG9wdGlvbnNbaV07CiAgICAgICAgICAgIGlmIChvcHRpb24uc2VsZWN0ZWQgPSBqUXVlcnkuaW5BcnJheShvcHRpb24udmFsdWUsIHZhbHVlcykgPj0gMCkgewogICAgICAgICAgICAgIG9wdGlvblNldCA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIC8vIGZvcmNlIGJyb3dzZXJzIHRvIGJlaGF2ZSBjb25zaXN0ZW50bHkgd2hlbiBub24tbWF0Y2hpbmcgdmFsdWUgaXMgc2V0CiAgICAgICAgICBpZiAoIW9wdGlvblNldCkgewogICAgICAgICAgICBlbGVtLnNlbGVjdGVkSW5kZXggPSAtMTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB2YWx1ZXM7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfSk7CiAgLy8gUmFkaW9zIGFuZCBjaGVja2JveGVzIGdldHRlci9zZXR0ZXIKICBqUXVlcnkuZWFjaChbCiAgICAncmFkaW8nLAogICAgJ2NoZWNrYm94JwogIF0sIGZ1bmN0aW9uICgpIHsKICAgIGpRdWVyeS52YWxIb29rc1t0aGlzXSA9IHsKICAgICAgc2V0OiBmdW5jdGlvbiAoZWxlbSwgdmFsdWUpIHsKICAgICAgICBpZiAoalF1ZXJ5LmlzQXJyYXkodmFsdWUpKSB7CiAgICAgICAgICByZXR1cm4gZWxlbS5jaGVja2VkID0galF1ZXJ5LmluQXJyYXkoalF1ZXJ5KGVsZW0pLnZhbCgpLCB2YWx1ZSkgPj0gMDsKICAgICAgICB9CiAgICAgIH0KICAgIH07CiAgICBpZiAoIXN1cHBvcnQuY2hlY2tPbikgewogICAgICBqUXVlcnkudmFsSG9va3NbdGhpc10uZ2V0ID0gZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICAvLyBTdXBwb3J0OiBXZWJraXQKICAgICAgICAvLyAiIiBpcyByZXR1cm5lZCBpbnN0ZWFkIG9mICJvbiIgaWYgYSB2YWx1ZSBpc24ndCBzcGVjaWZpZWQKICAgICAgICByZXR1cm4gZWxlbS5nZXRBdHRyaWJ1dGUoJ3ZhbHVlJykgPT09IG51bGwgPyAnb24nIDogZWxlbS52YWx1ZTsKICAgICAgfTsKICAgIH0KICB9KTsKICAvLyBSZXR1cm4galF1ZXJ5IGZvciBhdHRyaWJ1dGVzLW9ubHkgaW5jbHVzaW9uCiAgalF1ZXJ5LmVhY2goKCdibHVyIGZvY3VzIGZvY3VzaW4gZm9jdXNvdXQgbG9hZCByZXNpemUgc2Nyb2xsIHVubG9hZCBjbGljayBkYmxjbGljayAnICsgJ21vdXNlZG93biBtb3VzZXVwIG1vdXNlbW92ZSBtb3VzZW92ZXIgbW91c2VvdXQgbW91c2VlbnRlciBtb3VzZWxlYXZlICcgKyAnY2hhbmdlIHNlbGVjdCBzdWJtaXQga2V5ZG93biBrZXlwcmVzcyBrZXl1cCBlcnJvciBjb250ZXh0bWVudScpLnNwbGl0KCcgJyksIGZ1bmN0aW9uIChpLCBuYW1lKSB7CiAgICAvLyBIYW5kbGUgZXZlbnQgYmluZGluZwogICAgalF1ZXJ5LmZuW25hbWVdID0gZnVuY3Rpb24gKGRhdGEsIGZuKSB7CiAgICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID4gMCA/IHRoaXMub24obmFtZSwgbnVsbCwgZGF0YSwgZm4pIDogdGhpcy50cmlnZ2VyKG5hbWUpOwogICAgfTsKICB9KTsKICBqUXVlcnkuZm4uZXh0ZW5kKHsKICAgIGhvdmVyOiBmdW5jdGlvbiAoZm5PdmVyLCBmbk91dCkgewogICAgICByZXR1cm4gdGhpcy5tb3VzZWVudGVyKGZuT3ZlcikubW91c2VsZWF2ZShmbk91dCB8fCBmbk92ZXIpOwogICAgfSwKICAgIGJpbmQ6IGZ1bmN0aW9uICh0eXBlcywgZGF0YSwgZm4pIHsKICAgICAgcmV0dXJuIHRoaXMub24odHlwZXMsIG51bGwsIGRhdGEsIGZuKTsKICAgIH0sCiAgICB1bmJpbmQ6IGZ1bmN0aW9uICh0eXBlcywgZm4pIHsKICAgICAgcmV0dXJuIHRoaXMub2ZmKHR5cGVzLCBudWxsLCBmbik7CiAgICB9LAogICAgZGVsZWdhdGU6IGZ1bmN0aW9uIChzZWxlY3RvciwgdHlwZXMsIGRhdGEsIGZuKSB7CiAgICAgIHJldHVybiB0aGlzLm9uKHR5cGVzLCBzZWxlY3RvciwgZGF0YSwgZm4pOwogICAgfSwKICAgIHVuZGVsZWdhdGU6IGZ1bmN0aW9uIChzZWxlY3RvciwgdHlwZXMsIGZuKSB7CiAgICAgIC8vICggbmFtZXNwYWNlICkgb3IgKCBzZWxlY3RvciwgdHlwZXMgWywgZm5dICkKICAgICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPT09IDEgPyB0aGlzLm9mZihzZWxlY3RvciwgJyoqJykgOiB0aGlzLm9mZih0eXBlcywgc2VsZWN0b3IgfHwgJyoqJywgZm4pOwogICAgfQogIH0pOwogIHZhciBub25jZSA9IGpRdWVyeS5ub3coKTsKICB2YXIgcnF1ZXJ5ID0gL1w/LzsKICAvLyBTdXBwb3J0OiBBbmRyb2lkIDIuMwogIC8vIFdvcmthcm91bmQgZmFpbHVyZSB0byBzdHJpbmctY2FzdCBudWxsIGlucHV0CiAgalF1ZXJ5LnBhcnNlSlNPTiA9IGZ1bmN0aW9uIChkYXRhKSB7CiAgICByZXR1cm4gSlNPTi5wYXJzZShkYXRhICsgJycpOwogIH07CiAgLy8gQ3Jvc3MtYnJvd3NlciB4bWwgcGFyc2luZwogIGpRdWVyeS5wYXJzZVhNTCA9IGZ1bmN0aW9uIChkYXRhKSB7CiAgICB2YXIgeG1sLCB0bXA7CiAgICBpZiAoIWRhdGEgfHwgdHlwZW9mIGRhdGEgIT09ICdzdHJpbmcnKSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfQogICAgLy8gU3VwcG9ydDogSUU5CiAgICB0cnkgewogICAgICB0bXAgPSBuZXcgRE9NUGFyc2VyKCk7CiAgICAgIHhtbCA9IHRtcC5wYXJzZUZyb21TdHJpbmcoZGF0YSwgJ3RleHQveG1sJyk7CiAgICB9IGNhdGNoIChlKSB7CiAgICAgIHhtbCA9IHVuZGVmaW5lZDsKICAgIH0KICAgIGlmICgheG1sIHx8IHhtbC5nZXRFbGVtZW50c0J5VGFnTmFtZSgncGFyc2VyZXJyb3InKS5sZW5ndGgpIHsKICAgICAgalF1ZXJ5LmVycm9yKCdJbnZhbGlkIFhNTDogJyArIGRhdGEpOwogICAgfQogICAgcmV0dXJuIHhtbDsKICB9OwogIHZhcgogICAgLy8gRG9jdW1lbnQgbG9jYXRpb24KICAgIGFqYXhMb2NQYXJ0cywgYWpheExvY2F0aW9uLCByaGFzaCA9IC8jLiokLywgcnRzID0gLyhbPyZdKV89W14mXSovLCByaGVhZGVycyA9IC9eKC4qPyk6WyBcdF0qKFteXHJcbl0qKSQvZ20sCiAgICAvLyAjNzY1MywgIzgxMjUsICM4MTUyOiBsb2NhbCBwcm90b2NvbCBkZXRlY3Rpb24KICAgIHJsb2NhbFByb3RvY29sID0gL14oPzphYm91dHxhcHB8YXBwLXN0b3JhZ2V8ListZXh0ZW5zaW9ufGZpbGV8cmVzfHdpZGdldCk6JC8sIHJub0NvbnRlbnQgPSAvXig/OkdFVHxIRUFEKSQvLCBycHJvdG9jb2wgPSAvXlwvXC8vLCBydXJsID0gL14oW1x3ListXSs6KSg/OlwvXC8oPzpbXlwvPyNdKkB8KShbXlwvPyM6XSopKD86OihcZCspfCl8KS8sCiAgICAvKiBQcmVmaWx0ZXJzCiAgICAqIDEpIFRoZXkgYXJlIHVzZWZ1bCB0byBpbnRyb2R1Y2UgY3VzdG9tIGRhdGFUeXBlcyAoc2VlIGFqYXgvanNvbnAuanMgZm9yIGFuIGV4YW1wbGUpCiAgICAqIDIpIFRoZXNlIGFyZSBjYWxsZWQ6CiAgICAqICAgIC0gQkVGT1JFIGFza2luZyBmb3IgYSB0cmFuc3BvcnQKICAgICogICAgLSBBRlRFUiBwYXJhbSBzZXJpYWxpemF0aW9uIChzLmRhdGEgaXMgYSBzdHJpbmcgaWYgcy5wcm9jZXNzRGF0YSBpcyB0cnVlKQogICAgKiAzKSBrZXkgaXMgdGhlIGRhdGFUeXBlCiAgICAqIDQpIHRoZSBjYXRjaGFsbCBzeW1ib2wgIioiIGNhbiBiZSB1c2VkCiAgICAqIDUpIGV4ZWN1dGlvbiB3aWxsIHN0YXJ0IHdpdGggdHJhbnNwb3J0IGRhdGFUeXBlIGFuZCBUSEVOIGNvbnRpbnVlIGRvd24gdG8gIioiIGlmIG5lZWRlZAogICAgKi8KICAgIHByZWZpbHRlcnMgPSB7fSwKICAgIC8qIFRyYW5zcG9ydHMgYmluZGluZ3MKICAgICogMSkga2V5IGlzIHRoZSBkYXRhVHlwZQogICAgKiAyKSB0aGUgY2F0Y2hhbGwgc3ltYm9sICIqIiBjYW4gYmUgdXNlZAogICAgKiAzKSBzZWxlY3Rpb24gd2lsbCBzdGFydCB3aXRoIHRyYW5zcG9ydCBkYXRhVHlwZSBhbmQgVEhFTiBnbyB0byAiKiIgaWYgbmVlZGVkCiAgICAqLwogICAgdHJhbnNwb3J0cyA9IHt9LAogICAgLy8gQXZvaWQgY29tbWVudC1wcm9sb2cgY2hhciBzZXF1ZW5jZSAoIzEwMDk4KTsgbXVzdCBhcHBlYXNlIGxpbnQgYW5kIGV2YWRlIGNvbXByZXNzaW9uCiAgICBhbGxUeXBlcyA9ICcqLycuY29uY2F0KCcqJyk7CiAgLy8gIzgxMzgsIElFIG1heSB0aHJvdyBhbiBleGNlcHRpb24gd2hlbiBhY2Nlc3NpbmcKICAvLyBhIGZpZWxkIGZyb20gd2luZG93LmxvY2F0aW9uIGlmIGRvY3VtZW50LmRvbWFpbiBoYXMgYmVlbiBzZXQKICB0cnkgewogICAgYWpheExvY2F0aW9uID0gbG9jYXRpb24uaHJlZjsKICB9IGNhdGNoIChlKSB7CiAgICAvLyBVc2UgdGhlIGhyZWYgYXR0cmlidXRlIG9mIGFuIEEgZWxlbWVudAogICAgLy8gc2luY2UgSUUgd2lsbCBtb2RpZnkgaXQgZ2l2ZW4gZG9jdW1lbnQubG9jYXRpb24KICAgIGFqYXhMb2NhdGlvbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2EnKTsKICAgIGFqYXhMb2NhdGlvbi5ocmVmID0gJyc7CiAgICBhamF4TG9jYXRpb24gPSBhamF4TG9jYXRpb24uaHJlZjsKICB9CiAgLy8gU2VnbWVudCBsb2NhdGlvbiBpbnRvIHBhcnRzCiAgYWpheExvY1BhcnRzID0gcnVybC5leGVjKGFqYXhMb2NhdGlvbi50b0xvd2VyQ2FzZSgpKSB8fCBbXTsKICAvLyBCYXNlICJjb25zdHJ1Y3RvciIgZm9yIGpRdWVyeS5hamF4UHJlZmlsdGVyIGFuZCBqUXVlcnkuYWpheFRyYW5zcG9ydAogIGZ1bmN0aW9uIGFkZFRvUHJlZmlsdGVyc09yVHJhbnNwb3J0cyhzdHJ1Y3R1cmUpIHsKICAgIC8vIGRhdGFUeXBlRXhwcmVzc2lvbiBpcyBvcHRpb25hbCBhbmQgZGVmYXVsdHMgdG8gIioiCiAgICByZXR1cm4gZnVuY3Rpb24gKGRhdGFUeXBlRXhwcmVzc2lvbiwgZnVuYykgewogICAgICBpZiAodHlwZW9mIGRhdGFUeXBlRXhwcmVzc2lvbiAhPT0gJ3N0cmluZycpIHsKICAgICAgICBmdW5jID0gZGF0YVR5cGVFeHByZXNzaW9uOwogICAgICAgIGRhdGFUeXBlRXhwcmVzc2lvbiA9ICcqJzsKICAgICAgfQogICAgICB2YXIgZGF0YVR5cGUsIGkgPSAwLCBkYXRhVHlwZXMgPSBkYXRhVHlwZUV4cHJlc3Npb24udG9Mb3dlckNhc2UoKS5tYXRjaChybm90d2hpdGUpIHx8IFtdOwogICAgICBpZiAoalF1ZXJ5LmlzRnVuY3Rpb24oZnVuYykpIHsKICAgICAgICAvLyBGb3IgZWFjaCBkYXRhVHlwZSBpbiB0aGUgZGF0YVR5cGVFeHByZXNzaW9uCiAgICAgICAgd2hpbGUgKGRhdGFUeXBlID0gZGF0YVR5cGVzW2krK10pIHsKICAgICAgICAgIC8vIFByZXBlbmQgaWYgcmVxdWVzdGVkCiAgICAgICAgICBpZiAoZGF0YVR5cGVbMF0gPT09ICcrJykgewogICAgICAgICAgICBkYXRhVHlwZSA9IGRhdGFUeXBlLnNsaWNlKDEpIHx8ICcqJzsKICAgICAgICAgICAgKHN0cnVjdHVyZVtkYXRhVHlwZV0gPSBzdHJ1Y3R1cmVbZGF0YVR5cGVdIHx8IFtdKS51bnNoaWZ0KGZ1bmMpOyAgLy8gT3RoZXJ3aXNlIGFwcGVuZAogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgKHN0cnVjdHVyZVtkYXRhVHlwZV0gPSBzdHJ1Y3R1cmVbZGF0YVR5cGVdIHx8IFtdKS5wdXNoKGZ1bmMpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfTsKICB9CiAgLy8gQmFzZSBpbnNwZWN0aW9uIGZ1bmN0aW9uIGZvciBwcmVmaWx0ZXJzIGFuZCB0cmFuc3BvcnRzCiAgZnVuY3Rpb24gaW5zcGVjdFByZWZpbHRlcnNPclRyYW5zcG9ydHMoc3RydWN0dXJlLCBvcHRpb25zLCBvcmlnaW5hbE9wdGlvbnMsIGpxWEhSKSB7CiAgICB2YXIgaW5zcGVjdGVkID0ge30sIHNlZWtpbmdUcmFuc3BvcnQgPSBzdHJ1Y3R1cmUgPT09IHRyYW5zcG9ydHM7CiAgICBmdW5jdGlvbiBpbnNwZWN0KGRhdGFUeXBlKSB7CiAgICAgIHZhciBzZWxlY3RlZDsKICAgICAgaW5zcGVjdGVkW2RhdGFUeXBlXSA9IHRydWU7CiAgICAgIGpRdWVyeS5lYWNoKHN0cnVjdHVyZVtkYXRhVHlwZV0gfHwgW10sIGZ1bmN0aW9uIChfLCBwcmVmaWx0ZXJPckZhY3RvcnkpIHsKICAgICAgICB2YXIgZGF0YVR5cGVPclRyYW5zcG9ydCA9IHByZWZpbHRlck9yRmFjdG9yeShvcHRpb25zLCBvcmlnaW5hbE9wdGlvbnMsIGpxWEhSKTsKICAgICAgICBpZiAodHlwZW9mIGRhdGFUeXBlT3JUcmFuc3BvcnQgPT09ICdzdHJpbmcnICYmICFzZWVraW5nVHJhbnNwb3J0ICYmICFpbnNwZWN0ZWRbZGF0YVR5cGVPclRyYW5zcG9ydF0pIHsKICAgICAgICAgIG9wdGlvbnMuZGF0YVR5cGVzLnVuc2hpZnQoZGF0YVR5cGVPclRyYW5zcG9ydCk7CiAgICAgICAgICBpbnNwZWN0KGRhdGFUeXBlT3JUcmFuc3BvcnQpOwogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0gZWxzZSBpZiAoc2Vla2luZ1RyYW5zcG9ydCkgewogICAgICAgICAgcmV0dXJuICEoc2VsZWN0ZWQgPSBkYXRhVHlwZU9yVHJhbnNwb3J0KTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICByZXR1cm4gc2VsZWN0ZWQ7CiAgICB9CiAgICByZXR1cm4gaW5zcGVjdChvcHRpb25zLmRhdGFUeXBlc1swXSkgfHwgIWluc3BlY3RlZFsnKiddICYmIGluc3BlY3QoJyonKTsKICB9CiAgLy8gQSBzcGVjaWFsIGV4dGVuZCBmb3IgYWpheCBvcHRpb25zCiAgLy8gdGhhdCB0YWtlcyAiZmxhdCIgb3B0aW9ucyAobm90IHRvIGJlIGRlZXAgZXh0ZW5kZWQpCiAgLy8gRml4ZXMgIzk4ODcKICBmdW5jdGlvbiBhamF4RXh0ZW5kKHRhcmdldCwgc3JjKSB7CiAgICB2YXIga2V5LCBkZWVwLCBmbGF0T3B0aW9ucyA9IGpRdWVyeS5hamF4U2V0dGluZ3MuZmxhdE9wdGlvbnMgfHwge307CiAgICBmb3IgKGtleSBpbiBzcmMpIHsKICAgICAgaWYgKHNyY1trZXldICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAoZmxhdE9wdGlvbnNba2V5XSA/IHRhcmdldCA6IGRlZXAgfHwgKGRlZXAgPSB7fSkpW2tleV0gPSBzcmNba2V5XTsKICAgICAgfQogICAgfQogICAgaWYgKGRlZXApIHsKICAgICAgalF1ZXJ5LmV4dGVuZCh0cnVlLCB0YXJnZXQsIGRlZXApOwogICAgfQogICAgcmV0dXJuIHRhcmdldDsKICB9CiAgLyogSGFuZGxlcyByZXNwb25zZXMgdG8gYW4gYWpheCByZXF1ZXN0OgogICAqIC0gZmluZHMgdGhlIHJpZ2h0IGRhdGFUeXBlIChtZWRpYXRlcyBiZXR3ZWVuIGNvbnRlbnQtdHlwZSBhbmQgZXhwZWN0ZWQgZGF0YVR5cGUpCiAgICogLSByZXR1cm5zIHRoZSBjb3JyZXNwb25kaW5nIHJlc3BvbnNlCiAgICovCiAgZnVuY3Rpb24gYWpheEhhbmRsZVJlc3BvbnNlcyhzLCBqcVhIUiwgcmVzcG9uc2VzKSB7CiAgICB2YXIgY3QsIHR5cGUsIGZpbmFsRGF0YVR5cGUsIGZpcnN0RGF0YVR5cGUsIGNvbnRlbnRzID0gcy5jb250ZW50cywgZGF0YVR5cGVzID0gcy5kYXRhVHlwZXM7CiAgICAvLyBSZW1vdmUgYXV0byBkYXRhVHlwZSBhbmQgZ2V0IGNvbnRlbnQtdHlwZSBpbiB0aGUgcHJvY2VzcwogICAgd2hpbGUgKGRhdGFUeXBlc1swXSA9PT0gJyonKSB7CiAgICAgIGRhdGFUeXBlcy5zaGlmdCgpOwogICAgICBpZiAoY3QgPT09IHVuZGVmaW5lZCkgewogICAgICAgIGN0ID0gcy5taW1lVHlwZSB8fCBqcVhIUi5nZXRSZXNwb25zZUhlYWRlcignQ29udGVudC1UeXBlJyk7CiAgICAgIH0KICAgIH0KICAgIC8vIENoZWNrIGlmIHdlJ3JlIGRlYWxpbmcgd2l0aCBhIGtub3duIGNvbnRlbnQtdHlwZQogICAgaWYgKGN0KSB7CiAgICAgIGZvciAodHlwZSBpbiBjb250ZW50cykgewogICAgICAgIGlmIChjb250ZW50c1t0eXBlXSAmJiBjb250ZW50c1t0eXBlXS50ZXN0KGN0KSkgewogICAgICAgICAgZGF0YVR5cGVzLnVuc2hpZnQodHlwZSk7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIC8vIENoZWNrIHRvIHNlZSBpZiB3ZSBoYXZlIGEgcmVzcG9uc2UgZm9yIHRoZSBleHBlY3RlZCBkYXRhVHlwZQogICAgaWYgKGRhdGFUeXBlc1swXSBpbiByZXNwb25zZXMpIHsKICAgICAgZmluYWxEYXRhVHlwZSA9IGRhdGFUeXBlc1swXTsKICAgIH0gZWxzZSB7CiAgICAgIC8vIFRyeSBjb252ZXJ0aWJsZSBkYXRhVHlwZXMKICAgICAgZm9yICh0eXBlIGluIHJlc3BvbnNlcykgewogICAgICAgIGlmICghZGF0YVR5cGVzWzBdIHx8IHMuY29udmVydGVyc1t0eXBlICsgJyAnICsgZGF0YVR5cGVzWzBdXSkgewogICAgICAgICAgZmluYWxEYXRhVHlwZSA9IHR5cGU7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgICAgaWYgKCFmaXJzdERhdGFUeXBlKSB7CiAgICAgICAgICBmaXJzdERhdGFUeXBlID0gdHlwZTsKICAgICAgICB9CiAgICAgIH0KICAgICAgLy8gT3IganVzdCB1c2UgZmlyc3Qgb25lCiAgICAgIGZpbmFsRGF0YVR5cGUgPSBmaW5hbERhdGFUeXBlIHx8IGZpcnN0RGF0YVR5cGU7CiAgICB9CiAgICAvLyBJZiB3ZSBmb3VuZCBhIGRhdGFUeXBlCiAgICAvLyBXZSBhZGQgdGhlIGRhdGFUeXBlIHRvIHRoZSBsaXN0IGlmIG5lZWRlZAogICAgLy8gYW5kIHJldHVybiB0aGUgY29ycmVzcG9uZGluZyByZXNwb25zZQogICAgaWYgKGZpbmFsRGF0YVR5cGUpIHsKICAgICAgaWYgKGZpbmFsRGF0YVR5cGUgIT09IGRhdGFUeXBlc1swXSkgewogICAgICAgIGRhdGFUeXBlcy51bnNoaWZ0KGZpbmFsRGF0YVR5cGUpOwogICAgICB9CiAgICAgIHJldHVybiByZXNwb25zZXNbZmluYWxEYXRhVHlwZV07CiAgICB9CiAgfQogIC8qIENoYWluIGNvbnZlcnNpb25zIGdpdmVuIHRoZSByZXF1ZXN0IGFuZCB0aGUgb3JpZ2luYWwgcmVzcG9uc2UKICAgKiBBbHNvIHNldHMgdGhlIHJlc3BvbnNlWFhYIGZpZWxkcyBvbiB0aGUganFYSFIgaW5zdGFuY2UKICAgKi8KICBmdW5jdGlvbiBhamF4Q29udmVydChzLCByZXNwb25zZSwganFYSFIsIGlzU3VjY2VzcykgewogICAgdmFyIGNvbnYyLCBjdXJyZW50LCBjb252LCB0bXAsIHByZXYsIGNvbnZlcnRlcnMgPSB7fSwKICAgICAgLy8gV29yayB3aXRoIGEgY29weSBvZiBkYXRhVHlwZXMgaW4gY2FzZSB3ZSBuZWVkIHRvIG1vZGlmeSBpdCBmb3IgY29udmVyc2lvbgogICAgICBkYXRhVHlwZXMgPSBzLmRhdGFUeXBlcy5zbGljZSgpOwogICAgLy8gQ3JlYXRlIGNvbnZlcnRlcnMgbWFwIHdpdGggbG93ZXJjYXNlZCBrZXlzCiAgICBpZiAoZGF0YVR5cGVzWzFdKSB7CiAgICAgIGZvciAoY29udiBpbiBzLmNvbnZlcnRlcnMpIHsKICAgICAgICBjb252ZXJ0ZXJzW2NvbnYudG9Mb3dlckNhc2UoKV0gPSBzLmNvbnZlcnRlcnNbY29udl07CiAgICAgIH0KICAgIH0KICAgIGN1cnJlbnQgPSBkYXRhVHlwZXMuc2hpZnQoKTsKICAgIC8vIENvbnZlcnQgdG8gZWFjaCBzZXF1ZW50aWFsIGRhdGFUeXBlCiAgICB3aGlsZSAoY3VycmVudCkgewogICAgICBpZiAocy5yZXNwb25zZUZpZWxkc1tjdXJyZW50XSkgewogICAgICAgIGpxWEhSW3MucmVzcG9uc2VGaWVsZHNbY3VycmVudF1dID0gcmVzcG9uc2U7CiAgICAgIH0KICAgICAgLy8gQXBwbHkgdGhlIGRhdGFGaWx0ZXIgaWYgcHJvdmlkZWQKICAgICAgaWYgKCFwcmV2ICYmIGlzU3VjY2VzcyAmJiBzLmRhdGFGaWx0ZXIpIHsKICAgICAgICByZXNwb25zZSA9IHMuZGF0YUZpbHRlcihyZXNwb25zZSwgcy5kYXRhVHlwZSk7CiAgICAgIH0KICAgICAgcHJldiA9IGN1cnJlbnQ7CiAgICAgIGN1cnJlbnQgPSBkYXRhVHlwZXMuc2hpZnQoKTsKICAgICAgaWYgKGN1cnJlbnQpIHsKICAgICAgICAvLyBUaGVyZSdzIG9ubHkgd29yayB0byBkbyBpZiBjdXJyZW50IGRhdGFUeXBlIGlzIG5vbi1hdXRvCiAgICAgICAgaWYgKGN1cnJlbnQgPT09ICcqJykgewogICAgICAgICAgY3VycmVudCA9IHByZXY7ICAvLyBDb252ZXJ0IHJlc3BvbnNlIGlmIHByZXYgZGF0YVR5cGUgaXMgbm9uLWF1dG8gYW5kIGRpZmZlcnMgZnJvbSBjdXJyZW50CiAgICAgICAgfSBlbHNlIGlmIChwcmV2ICE9PSAnKicgJiYgcHJldiAhPT0gY3VycmVudCkgewogICAgICAgICAgLy8gU2VlayBhIGRpcmVjdCBjb252ZXJ0ZXIKICAgICAgICAgIGNvbnYgPSBjb252ZXJ0ZXJzW3ByZXYgKyAnICcgKyBjdXJyZW50XSB8fCBjb252ZXJ0ZXJzWycqICcgKyBjdXJyZW50XTsKICAgICAgICAgIC8vIElmIG5vbmUgZm91bmQsIHNlZWsgYSBwYWlyCiAgICAgICAgICBpZiAoIWNvbnYpIHsKICAgICAgICAgICAgZm9yIChjb252MiBpbiBjb252ZXJ0ZXJzKSB7CiAgICAgICAgICAgICAgLy8gSWYgY29udjIgb3V0cHV0cyBjdXJyZW50CiAgICAgICAgICAgICAgdG1wID0gY29udjIuc3BsaXQoJyAnKTsKICAgICAgICAgICAgICBpZiAodG1wWzFdID09PSBjdXJyZW50KSB7CiAgICAgICAgICAgICAgICAvLyBJZiBwcmV2IGNhbiBiZSBjb252ZXJ0ZWQgdG8gYWNjZXB0ZWQgaW5wdXQKICAgICAgICAgICAgICAgIGNvbnYgPSBjb252ZXJ0ZXJzW3ByZXYgKyAnICcgKyB0bXBbMF1dIHx8IGNvbnZlcnRlcnNbJyogJyArIHRtcFswXV07CiAgICAgICAgICAgICAgICBpZiAoY29udikgewogICAgICAgICAgICAgICAgICAvLyBDb25kZW5zZSBlcXVpdmFsZW5jZSBjb252ZXJ0ZXJzCiAgICAgICAgICAgICAgICAgIGlmIChjb252ID09PSB0cnVlKSB7CiAgICAgICAgICAgICAgICAgICAgY29udiA9IGNvbnZlcnRlcnNbY29udjJdOyAgLy8gT3RoZXJ3aXNlLCBpbnNlcnQgdGhlIGludGVybWVkaWF0ZSBkYXRhVHlwZQogICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGNvbnZlcnRlcnNbY29udjJdICE9PSB0cnVlKSB7CiAgICAgICAgICAgICAgICAgICAgY3VycmVudCA9IHRtcFswXTsKICAgICAgICAgICAgICAgICAgICBkYXRhVHlwZXMudW5zaGlmdCh0bXBbMV0pOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgLy8gQXBwbHkgY29udmVydGVyIChpZiBub3QgYW4gZXF1aXZhbGVuY2UpCiAgICAgICAgICBpZiAoY29udiAhPT0gdHJ1ZSkgewogICAgICAgICAgICAvLyBVbmxlc3MgZXJyb3JzIGFyZSBhbGxvd2VkIHRvIGJ1YmJsZSwgY2F0Y2ggYW5kIHJldHVybiB0aGVtCiAgICAgICAgICAgIGlmIChjb252ICYmIHNbJ3Rocm93cyddKSB7CiAgICAgICAgICAgICAgcmVzcG9uc2UgPSBjb252KHJlc3BvbnNlKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmVzcG9uc2UgPSBjb252KHJlc3BvbnNlKTsKICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgICBzdGF0ZTogJ3BhcnNlcmVycm9yJywKICAgICAgICAgICAgICAgICAgZXJyb3I6IGNvbnYgPyBlIDogJ05vIGNvbnZlcnNpb24gZnJvbSAnICsgcHJldiArICcgdG8gJyArIGN1cnJlbnQKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICByZXR1cm4gewogICAgICBzdGF0ZTogJ3N1Y2Nlc3MnLAogICAgICBkYXRhOiByZXNwb25zZQogICAgfTsKICB9CiAgalF1ZXJ5LmV4dGVuZCh7CiAgICAvLyBDb3VudGVyIGZvciBob2xkaW5nIHRoZSBudW1iZXIgb2YgYWN0aXZlIHF1ZXJpZXMKICAgIGFjdGl2ZTogMCwKICAgIC8vIExhc3QtTW9kaWZpZWQgaGVhZGVyIGNhY2hlIGZvciBuZXh0IHJlcXVlc3QKICAgIGxhc3RNb2RpZmllZDoge30sCiAgICBldGFnOiB7fSwKICAgIGFqYXhTZXR0aW5nczogewogICAgICB1cmw6IGFqYXhMb2NhdGlvbiwKICAgICAgdHlwZTogJ0dFVCcsCiAgICAgIGlzTG9jYWw6IHJsb2NhbFByb3RvY29sLnRlc3QoYWpheExvY1BhcnRzWzFdKSwKICAgICAgZ2xvYmFsOiB0cnVlLAogICAgICBwcm9jZXNzRGF0YTogdHJ1ZSwKICAgICAgYXN5bmM6IHRydWUsCiAgICAgIGNvbnRlbnRUeXBlOiAnYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkOyBjaGFyc2V0PVVURi04JywKICAgICAgLyoKICAgICAgdGltZW91dDogMCwKICAgICAgZGF0YTogbnVsbCwKICAgICAgZGF0YVR5cGU6IG51bGwsCiAgICAgIHVzZXJuYW1lOiBudWxsLAogICAgICBwYXNzd29yZDogbnVsbCwKICAgICAgY2FjaGU6IG51bGwsCiAgICAgIHRocm93czogZmFsc2UsCiAgICAgIHRyYWRpdGlvbmFsOiBmYWxzZSwKICAgICAgaGVhZGVyczoge30sCiAgICAgICovCiAgICAgIGFjY2VwdHM6IHsKICAgICAgICAnKic6IGFsbFR5cGVzLAogICAgICAgIHRleHQ6ICd0ZXh0L3BsYWluJywKICAgICAgICBodG1sOiAndGV4dC9odG1sJywKICAgICAgICB4bWw6ICdhcHBsaWNhdGlvbi94bWwsIHRleHQveG1sJywKICAgICAgICBqc29uOiAnYXBwbGljYXRpb24vanNvbiwgdGV4dC9qYXZhc2NyaXB0JwogICAgICB9LAogICAgICBjb250ZW50czogewogICAgICAgIHhtbDogL3htbC8sCiAgICAgICAgaHRtbDogL2h0bWwvLAogICAgICAgIGpzb246IC9qc29uLwogICAgICB9LAogICAgICByZXNwb25zZUZpZWxkczogewogICAgICAgIHhtbDogJ3Jlc3BvbnNlWE1MJywKICAgICAgICB0ZXh0OiAncmVzcG9uc2VUZXh0JywKICAgICAgICBqc29uOiAncmVzcG9uc2VKU09OJwogICAgICB9LAogICAgICAvLyBEYXRhIGNvbnZlcnRlcnMKICAgICAgLy8gS2V5cyBzZXBhcmF0ZSBzb3VyY2UgKG9yIGNhdGNoYWxsICIqIikgYW5kIGRlc3RpbmF0aW9uIHR5cGVzIHdpdGggYSBzaW5nbGUgc3BhY2UKICAgICAgY29udmVydGVyczogewogICAgICAgIC8vIENvbnZlcnQgYW55dGhpbmcgdG8gdGV4dAogICAgICAgICcqIHRleHQnOiBTdHJpbmcsCiAgICAgICAgLy8gVGV4dCB0byBodG1sICh0cnVlID0gbm8gdHJhbnNmb3JtYXRpb24pCiAgICAgICAgJ3RleHQgaHRtbCc6IHRydWUsCiAgICAgICAgLy8gRXZhbHVhdGUgdGV4dCBhcyBhIGpzb24gZXhwcmVzc2lvbgogICAgICAgICd0ZXh0IGpzb24nOiBqUXVlcnkucGFyc2VKU09OLAogICAgICAgIC8vIFBhcnNlIHRleHQgYXMgeG1sCiAgICAgICAgJ3RleHQgeG1sJzogalF1ZXJ5LnBhcnNlWE1MCiAgICAgIH0sCiAgICAgIC8vIEZvciBvcHRpb25zIHRoYXQgc2hvdWxkbid0IGJlIGRlZXAgZXh0ZW5kZWQ6CiAgICAgIC8vIHlvdSBjYW4gYWRkIHlvdXIgb3duIGN1c3RvbSBvcHRpb25zIGhlcmUgaWYKICAgICAgLy8gYW5kIHdoZW4geW91IGNyZWF0ZSBvbmUgdGhhdCBzaG91bGRuJ3QgYmUKICAgICAgLy8gZGVlcCBleHRlbmRlZCAoc2VlIGFqYXhFeHRlbmQpCiAgICAgIGZsYXRPcHRpb25zOiB7CiAgICAgICAgdXJsOiB0cnVlLAogICAgICAgIGNvbnRleHQ6IHRydWUKICAgICAgfQogICAgfSwKICAgIC8vIENyZWF0ZXMgYSBmdWxsIGZsZWRnZWQgc2V0dGluZ3Mgb2JqZWN0IGludG8gdGFyZ2V0CiAgICAvLyB3aXRoIGJvdGggYWpheFNldHRpbmdzIGFuZCBzZXR0aW5ncyBmaWVsZHMuCiAgICAvLyBJZiB0YXJnZXQgaXMgb21pdHRlZCwgd3JpdGVzIGludG8gYWpheFNldHRpbmdzLgogICAgYWpheFNldHVwOiBmdW5jdGlvbiAodGFyZ2V0LCBzZXR0aW5ncykgewogICAgICByZXR1cm4gc2V0dGluZ3MgPyAvLyBCdWlsZGluZyBhIHNldHRpbmdzIG9iamVjdAogICAgICBhamF4RXh0ZW5kKGFqYXhFeHRlbmQodGFyZ2V0LCBqUXVlcnkuYWpheFNldHRpbmdzKSwgc2V0dGluZ3MpIDogLy8gRXh0ZW5kaW5nIGFqYXhTZXR0aW5ncwogICAgICBhamF4RXh0ZW5kKGpRdWVyeS5hamF4U2V0dGluZ3MsIHRhcmdldCk7CiAgICB9LAogICAgYWpheFByZWZpbHRlcjogYWRkVG9QcmVmaWx0ZXJzT3JUcmFuc3BvcnRzKHByZWZpbHRlcnMpLAogICAgYWpheFRyYW5zcG9ydDogYWRkVG9QcmVmaWx0ZXJzT3JUcmFuc3BvcnRzKHRyYW5zcG9ydHMpLAogICAgLy8gTWFpbiBtZXRob2QKICAgIGFqYXg6IGZ1bmN0aW9uICh1cmwsIG9wdGlvbnMpIHsKICAgICAgLy8gSWYgdXJsIGlzIGFuIG9iamVjdCwgc2ltdWxhdGUgcHJlLTEuNSBzaWduYXR1cmUKICAgICAgaWYgKHR5cGVvZiB1cmwgPT09ICdvYmplY3QnKSB7CiAgICAgICAgb3B0aW9ucyA9IHVybDsKICAgICAgICB1cmwgPSB1bmRlZmluZWQ7CiAgICAgIH0KICAgICAgLy8gRm9yY2Ugb3B0aW9ucyB0byBiZSBhbiBvYmplY3QKICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICAgIHZhciB0cmFuc3BvcnQsCiAgICAgICAgLy8gVVJMIHdpdGhvdXQgYW50aS1jYWNoZSBwYXJhbQogICAgICAgIGNhY2hlVVJMLAogICAgICAgIC8vIFJlc3BvbnNlIGhlYWRlcnMKICAgICAgICByZXNwb25zZUhlYWRlcnNTdHJpbmcsIHJlc3BvbnNlSGVhZGVycywKICAgICAgICAvLyB0aW1lb3V0IGhhbmRsZQogICAgICAgIHRpbWVvdXRUaW1lciwKICAgICAgICAvLyBDcm9zcy1kb21haW4gZGV0ZWN0aW9uIHZhcnMKICAgICAgICBwYXJ0cywKICAgICAgICAvLyBUbyBrbm93IGlmIGdsb2JhbCBldmVudHMgYXJlIHRvIGJlIGRpc3BhdGNoZWQKICAgICAgICBmaXJlR2xvYmFscywKICAgICAgICAvLyBMb29wIHZhcmlhYmxlCiAgICAgICAgaSwKICAgICAgICAvLyBDcmVhdGUgdGhlIGZpbmFsIG9wdGlvbnMgb2JqZWN0CiAgICAgICAgcyA9IGpRdWVyeS5hamF4U2V0dXAoe30sIG9wdGlvbnMpLAogICAgICAgIC8vIENhbGxiYWNrcyBjb250ZXh0CiAgICAgICAgY2FsbGJhY2tDb250ZXh0ID0gcy5jb250ZXh0IHx8IHMsCiAgICAgICAgLy8gQ29udGV4dCBmb3IgZ2xvYmFsIGV2ZW50cyBpcyBjYWxsYmFja0NvbnRleHQgaWYgaXQgaXMgYSBET00gbm9kZSBvciBqUXVlcnkgY29sbGVjdGlvbgogICAgICAgIGdsb2JhbEV2ZW50Q29udGV4dCA9IHMuY29udGV4dCAmJiAoY2FsbGJhY2tDb250ZXh0Lm5vZGVUeXBlIHx8IGNhbGxiYWNrQ29udGV4dC5qcXVlcnkpID8galF1ZXJ5KGNhbGxiYWNrQ29udGV4dCkgOiBqUXVlcnkuZXZlbnQsCiAgICAgICAgLy8gRGVmZXJyZWRzCiAgICAgICAgZGVmZXJyZWQgPSBqUXVlcnkuRGVmZXJyZWQoKSwgY29tcGxldGVEZWZlcnJlZCA9IGpRdWVyeS5DYWxsYmFja3MoJ29uY2UgbWVtb3J5JyksCiAgICAgICAgLy8gU3RhdHVzLWRlcGVuZGVudCBjYWxsYmFja3MKICAgICAgICBzdGF0dXNDb2RlID0gcy5zdGF0dXNDb2RlIHx8IHt9LAogICAgICAgIC8vIEhlYWRlcnMgKHRoZXkgYXJlIHNlbnQgYWxsIGF0IG9uY2UpCiAgICAgICAgcmVxdWVzdEhlYWRlcnMgPSB7fSwgcmVxdWVzdEhlYWRlcnNOYW1lcyA9IHt9LAogICAgICAgIC8vIFRoZSBqcVhIUiBzdGF0ZQogICAgICAgIHN0YXRlID0gMCwKICAgICAgICAvLyBEZWZhdWx0IGFib3J0IG1lc3NhZ2UKICAgICAgICBzdHJBYm9ydCA9ICdjYW5jZWxlZCcsCiAgICAgICAgLy8gRmFrZSB4aHIKICAgICAgICBqcVhIUiA9IHsKICAgICAgICAgIHJlYWR5U3RhdGU6IDAsCiAgICAgICAgICAvLyBCdWlsZHMgaGVhZGVycyBoYXNodGFibGUgaWYgbmVlZGVkCiAgICAgICAgICBnZXRSZXNwb25zZUhlYWRlcjogZnVuY3Rpb24gKGtleSkgewogICAgICAgICAgICB2YXIgbWF0Y2g7CiAgICAgICAgICAgIGlmIChzdGF0ZSA9PT0gMikgewogICAgICAgICAgICAgIGlmICghcmVzcG9uc2VIZWFkZXJzKSB7CiAgICAgICAgICAgICAgICByZXNwb25zZUhlYWRlcnMgPSB7fTsKICAgICAgICAgICAgICAgIHdoaWxlIChtYXRjaCA9IHJoZWFkZXJzLmV4ZWMocmVzcG9uc2VIZWFkZXJzU3RyaW5nKSkgewogICAgICAgICAgICAgICAgICByZXNwb25zZUhlYWRlcnNbbWF0Y2hbMV0udG9Mb3dlckNhc2UoKV0gPSBtYXRjaFsyXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbWF0Y2ggPSByZXNwb25zZUhlYWRlcnNba2V5LnRvTG93ZXJDYXNlKCldOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBtYXRjaCA9PSBudWxsID8gbnVsbCA6IG1hdGNoOwogICAgICAgICAgfSwKICAgICAgICAgIC8vIFJhdyBzdHJpbmcKICAgICAgICAgIGdldEFsbFJlc3BvbnNlSGVhZGVyczogZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gc3RhdGUgPT09IDIgPyByZXNwb25zZUhlYWRlcnNTdHJpbmcgOiBudWxsOwogICAgICAgICAgfSwKICAgICAgICAgIC8vIENhY2hlcyB0aGUgaGVhZGVyCiAgICAgICAgICBzZXRSZXF1ZXN0SGVhZGVyOiBmdW5jdGlvbiAobmFtZSwgdmFsdWUpIHsKICAgICAgICAgICAgdmFyIGxuYW1lID0gbmFtZS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICBpZiAoIXN0YXRlKSB7CiAgICAgICAgICAgICAgbmFtZSA9IHJlcXVlc3RIZWFkZXJzTmFtZXNbbG5hbWVdID0gcmVxdWVzdEhlYWRlcnNOYW1lc1tsbmFtZV0gfHwgbmFtZTsKICAgICAgICAgICAgICByZXF1ZXN0SGVhZGVyc1tuYW1lXSA9IHZhbHVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgfSwKICAgICAgICAgIC8vIE92ZXJyaWRlcyByZXNwb25zZSBjb250ZW50LXR5cGUgaGVhZGVyCiAgICAgICAgICBvdmVycmlkZU1pbWVUeXBlOiBmdW5jdGlvbiAodHlwZSkgewogICAgICAgICAgICBpZiAoIXN0YXRlKSB7CiAgICAgICAgICAgICAgcy5taW1lVHlwZSA9IHR5cGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICB9LAogICAgICAgICAgLy8gU3RhdHVzLWRlcGVuZGVudCBjYWxsYmFja3MKICAgICAgICAgIHN0YXR1c0NvZGU6IGZ1bmN0aW9uIChtYXApIHsKICAgICAgICAgICAgdmFyIGNvZGU7CiAgICAgICAgICAgIGlmIChtYXApIHsKICAgICAgICAgICAgICBpZiAoc3RhdGUgPCAyKSB7CiAgICAgICAgICAgICAgICBmb3IgKGNvZGUgaW4gbWFwKSB7CiAgICAgICAgICAgICAgICAgIC8vIExhenktYWRkIHRoZSBuZXcgY2FsbGJhY2sgaW4gYSB3YXkgdGhhdCBwcmVzZXJ2ZXMgb2xkIG9uZXMKICAgICAgICAgICAgICAgICAgc3RhdHVzQ29kZVtjb2RlXSA9IFsKICAgICAgICAgICAgICAgICAgICBzdGF0dXNDb2RlW2NvZGVdLAogICAgICAgICAgICAgICAgICAgIG1hcFtjb2RlXQogICAgICAgICAgICAgICAgICBdOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBFeGVjdXRlIHRoZSBhcHByb3ByaWF0ZSBjYWxsYmFja3MKICAgICAgICAgICAgICAgIGpxWEhSLmFsd2F5cyhtYXBbanFYSFIuc3RhdHVzXSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgfSwKICAgICAgICAgIC8vIENhbmNlbCB0aGUgcmVxdWVzdAogICAgICAgICAgYWJvcnQ6IGZ1bmN0aW9uIChzdGF0dXNUZXh0KSB7CiAgICAgICAgICAgIHZhciBmaW5hbFRleHQgPSBzdGF0dXNUZXh0IHx8IHN0ckFib3J0OwogICAgICAgICAgICBpZiAodHJhbnNwb3J0KSB7CiAgICAgICAgICAgICAgdHJhbnNwb3J0LmFib3J0KGZpbmFsVGV4dCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZG9uZSgwLCBmaW5hbFRleHQpOwogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAvLyBBdHRhY2ggZGVmZXJyZWRzCiAgICAgIGRlZmVycmVkLnByb21pc2UoanFYSFIpLmNvbXBsZXRlID0gY29tcGxldGVEZWZlcnJlZC5hZGQ7CiAgICAgIGpxWEhSLnN1Y2Nlc3MgPSBqcVhIUi5kb25lOwogICAgICBqcVhIUi5lcnJvciA9IGpxWEhSLmZhaWw7CiAgICAgIC8vIFJlbW92ZSBoYXNoIGNoYXJhY3RlciAoIzc1MzE6IGFuZCBzdHJpbmcgcHJvbW90aW9uKQogICAgICAvLyBBZGQgcHJvdG9jb2wgaWYgbm90IHByb3ZpZGVkIChwcmVmaWx0ZXJzIG1pZ2h0IGV4cGVjdCBpdCkKICAgICAgLy8gSGFuZGxlIGZhbHN5IHVybCBpbiB0aGUgc2V0dGluZ3Mgb2JqZWN0ICgjMTAwOTM6IGNvbnNpc3RlbmN5IHdpdGggb2xkIHNpZ25hdHVyZSkKICAgICAgLy8gV2UgYWxzbyB1c2UgdGhlIHVybCBwYXJhbWV0ZXIgaWYgYXZhaWxhYmxlCiAgICAgIHMudXJsID0gKCh1cmwgfHwgcy51cmwgfHwgYWpheExvY2F0aW9uKSArICcnKS5yZXBsYWNlKHJoYXNoLCAnJykucmVwbGFjZShycHJvdG9jb2wsIGFqYXhMb2NQYXJ0c1sxXSArICcvLycpOwogICAgICAvLyBBbGlhcyBtZXRob2Qgb3B0aW9uIHRvIHR5cGUgYXMgcGVyIHRpY2tldCAjMTIwMDQKICAgICAgcy50eXBlID0gb3B0aW9ucy5tZXRob2QgfHwgb3B0aW9ucy50eXBlIHx8IHMubWV0aG9kIHx8IHMudHlwZTsKICAgICAgLy8gRXh0cmFjdCBkYXRhVHlwZXMgbGlzdAogICAgICBzLmRhdGFUeXBlcyA9IGpRdWVyeS50cmltKHMuZGF0YVR5cGUgfHwgJyonKS50b0xvd2VyQ2FzZSgpLm1hdGNoKHJub3R3aGl0ZSkgfHwgWycnXTsKICAgICAgLy8gQSBjcm9zcy1kb21haW4gcmVxdWVzdCBpcyBpbiBvcmRlciB3aGVuIHdlIGhhdmUgYSBwcm90b2NvbDpob3N0OnBvcnQgbWlzbWF0Y2gKICAgICAgaWYgKHMuY3Jvc3NEb21haW4gPT0gbnVsbCkgewogICAgICAgIHBhcnRzID0gcnVybC5leGVjKHMudXJsLnRvTG93ZXJDYXNlKCkpOwogICAgICAgIHMuY3Jvc3NEb21haW4gPSAhIShwYXJ0cyAmJiAocGFydHNbMV0gIT09IGFqYXhMb2NQYXJ0c1sxXSB8fCBwYXJ0c1syXSAhPT0gYWpheExvY1BhcnRzWzJdIHx8IChwYXJ0c1szXSB8fCAocGFydHNbMV0gPT09ICdodHRwOicgPyAnODAnIDogJzQ0MycpKSAhPT0gKGFqYXhMb2NQYXJ0c1szXSB8fCAoYWpheExvY1BhcnRzWzFdID09PSAnaHR0cDonID8gJzgwJyA6ICc0NDMnKSkpKTsKICAgICAgfQogICAgICAvLyBDb252ZXJ0IGRhdGEgaWYgbm90IGFscmVhZHkgYSBzdHJpbmcKICAgICAgaWYgKHMuZGF0YSAmJiBzLnByb2Nlc3NEYXRhICYmIHR5cGVvZiBzLmRhdGEgIT09ICdzdHJpbmcnKSB7CiAgICAgICAgcy5kYXRhID0galF1ZXJ5LnBhcmFtKHMuZGF0YSwgcy50cmFkaXRpb25hbCk7CiAgICAgIH0KICAgICAgLy8gQXBwbHkgcHJlZmlsdGVycwogICAgICBpbnNwZWN0UHJlZmlsdGVyc09yVHJhbnNwb3J0cyhwcmVmaWx0ZXJzLCBzLCBvcHRpb25zLCBqcVhIUik7CiAgICAgIC8vIElmIHJlcXVlc3Qgd2FzIGFib3J0ZWQgaW5zaWRlIGEgcHJlZmlsdGVyLCBzdG9wIHRoZXJlCiAgICAgIGlmIChzdGF0ZSA9PT0gMikgewogICAgICAgIHJldHVybiBqcVhIUjsKICAgICAgfQogICAgICAvLyBXZSBjYW4gZmlyZSBnbG9iYWwgZXZlbnRzIGFzIG9mIG5vdyBpZiBhc2tlZCB0bwogICAgICBmaXJlR2xvYmFscyA9IHMuZ2xvYmFsOwogICAgICAvLyBXYXRjaCBmb3IgYSBuZXcgc2V0IG9mIHJlcXVlc3RzCiAgICAgIGlmIChmaXJlR2xvYmFscyAmJiBqUXVlcnkuYWN0aXZlKysgPT09IDApIHsKICAgICAgICBqUXVlcnkuZXZlbnQudHJpZ2dlcignYWpheFN0YXJ0Jyk7CiAgICAgIH0KICAgICAgLy8gVXBwZXJjYXNlIHRoZSB0eXBlCiAgICAgIHMudHlwZSA9IHMudHlwZS50b1VwcGVyQ2FzZSgpOwogICAgICAvLyBEZXRlcm1pbmUgaWYgcmVxdWVzdCBoYXMgY29udGVudAogICAgICBzLmhhc0NvbnRlbnQgPSAhcm5vQ29udGVudC50ZXN0KHMudHlwZSk7CiAgICAgIC8vIFNhdmUgdGhlIFVSTCBpbiBjYXNlIHdlJ3JlIHRveWluZyB3aXRoIHRoZSBJZi1Nb2RpZmllZC1TaW5jZQogICAgICAvLyBhbmQvb3IgSWYtTm9uZS1NYXRjaCBoZWFkZXIgbGF0ZXIgb24KICAgICAgY2FjaGVVUkwgPSBzLnVybDsKICAgICAgLy8gTW9yZSBvcHRpb25zIGhhbmRsaW5nIGZvciByZXF1ZXN0cyB3aXRoIG5vIGNvbnRlbnQKICAgICAgaWYgKCFzLmhhc0NvbnRlbnQpIHsKICAgICAgICAvLyBJZiBkYXRhIGlzIGF2YWlsYWJsZSwgYXBwZW5kIGRhdGEgdG8gdXJsCiAgICAgICAgaWYgKHMuZGF0YSkgewogICAgICAgICAgY2FjaGVVUkwgPSBzLnVybCArPSAocnF1ZXJ5LnRlc3QoY2FjaGVVUkwpID8gJyYnIDogJz8nKSArIHMuZGF0YTsKICAgICAgICAgIC8vICM5NjgyOiByZW1vdmUgZGF0YSBzbyB0aGF0IGl0J3Mgbm90IHVzZWQgaW4gYW4gZXZlbnR1YWwgcmV0cnkKICAgICAgICAgIGRlbGV0ZSBzLmRhdGE7CiAgICAgICAgfQogICAgICAgIC8vIEFkZCBhbnRpLWNhY2hlIGluIHVybCBpZiBuZWVkZWQKICAgICAgICBpZiAocy5jYWNoZSA9PT0gZmFsc2UpIHsKICAgICAgICAgIHMudXJsID0gcnRzLnRlc3QoY2FjaGVVUkwpID8gLy8gSWYgdGhlcmUgaXMgYWxyZWFkeSBhICdfJyBwYXJhbWV0ZXIsIHNldCBpdHMgdmFsdWUKICAgICAgICAgIGNhY2hlVVJMLnJlcGxhY2UocnRzLCAnJDFfPScgKyBub25jZSsrKSA6IC8vIE90aGVyd2lzZSBhZGQgb25lIHRvIHRoZSBlbmQKICAgICAgICAgIGNhY2hlVVJMICsgKHJxdWVyeS50ZXN0KGNhY2hlVVJMKSA/ICcmJyA6ICc/JykgKyAnXz0nICsgbm9uY2UrKzsKICAgICAgICB9CiAgICAgIH0KICAgICAgLy8gU2V0IHRoZSBJZi1Nb2RpZmllZC1TaW5jZSBhbmQvb3IgSWYtTm9uZS1NYXRjaCBoZWFkZXIsIGlmIGluIGlmTW9kaWZpZWQgbW9kZS4KICAgICAgaWYgKHMuaWZNb2RpZmllZCkgewogICAgICAgIGlmIChqUXVlcnkubGFzdE1vZGlmaWVkW2NhY2hlVVJMXSkgewogICAgICAgICAganFYSFIuc2V0UmVxdWVzdEhlYWRlcignSWYtTW9kaWZpZWQtU2luY2UnLCBqUXVlcnkubGFzdE1vZGlmaWVkW2NhY2hlVVJMXSk7CiAgICAgICAgfQogICAgICAgIGlmIChqUXVlcnkuZXRhZ1tjYWNoZVVSTF0pIHsKICAgICAgICAgIGpxWEhSLnNldFJlcXVlc3RIZWFkZXIoJ0lmLU5vbmUtTWF0Y2gnLCBqUXVlcnkuZXRhZ1tjYWNoZVVSTF0pOwogICAgICAgIH0KICAgICAgfQogICAgICAvLyBTZXQgdGhlIGNvcnJlY3QgaGVhZGVyLCBpZiBkYXRhIGlzIGJlaW5nIHNlbnQKICAgICAgaWYgKHMuZGF0YSAmJiBzLmhhc0NvbnRlbnQgJiYgcy5jb250ZW50VHlwZSAhPT0gZmFsc2UgfHwgb3B0aW9ucy5jb250ZW50VHlwZSkgewogICAgICAgIGpxWEhSLnNldFJlcXVlc3RIZWFkZXIoJ0NvbnRlbnQtVHlwZScsIHMuY29udGVudFR5cGUpOwogICAgICB9CiAgICAgIC8vIFNldCB0aGUgQWNjZXB0cyBoZWFkZXIgZm9yIHRoZSBzZXJ2ZXIsIGRlcGVuZGluZyBvbiB0aGUgZGF0YVR5cGUKICAgICAganFYSFIuc2V0UmVxdWVzdEhlYWRlcignQWNjZXB0Jywgcy5kYXRhVHlwZXNbMF0gJiYgcy5hY2NlcHRzW3MuZGF0YVR5cGVzWzBdXSA/IHMuYWNjZXB0c1tzLmRhdGFUeXBlc1swXV0gKyAocy5kYXRhVHlwZXNbMF0gIT09ICcqJyA/ICcsICcgKyBhbGxUeXBlcyArICc7IHE9MC4wMScgOiAnJykgOiBzLmFjY2VwdHNbJyonXSk7CiAgICAgIC8vIENoZWNrIGZvciBoZWFkZXJzIG9wdGlvbgogICAgICBmb3IgKGkgaW4gcy5oZWFkZXJzKSB7CiAgICAgICAganFYSFIuc2V0UmVxdWVzdEhlYWRlcihpLCBzLmhlYWRlcnNbaV0pOwogICAgICB9CiAgICAgIC8vIEFsbG93IGN1c3RvbSBoZWFkZXJzL21pbWV0eXBlcyBhbmQgZWFybHkgYWJvcnQKICAgICAgaWYgKHMuYmVmb3JlU2VuZCAmJiAocy5iZWZvcmVTZW5kLmNhbGwoY2FsbGJhY2tDb250ZXh0LCBqcVhIUiwgcykgPT09IGZhbHNlIHx8IHN0YXRlID09PSAyKSkgewogICAgICAgIC8vIEFib3J0IGlmIG5vdCBkb25lIGFscmVhZHkgYW5kIHJldHVybgogICAgICAgIHJldHVybiBqcVhIUi5hYm9ydCgpOwogICAgICB9CiAgICAgIC8vIGFib3J0aW5nIGlzIG5vIGxvbmdlciBhIGNhbmNlbGxhdGlvbgogICAgICBzdHJBYm9ydCA9ICdhYm9ydCc7CiAgICAgIC8vIEluc3RhbGwgY2FsbGJhY2tzIG9uIGRlZmVycmVkcwogICAgICBmb3IgKGkgaW4gewogICAgICAgICAgc3VjY2VzczogMSwKICAgICAgICAgIGVycm9yOiAxLAogICAgICAgICAgY29tcGxldGU6IDEKICAgICAgICB9KSB7CiAgICAgICAganFYSFJbaV0oc1tpXSk7CiAgICAgIH0KICAgICAgLy8gR2V0IHRyYW5zcG9ydAogICAgICB0cmFuc3BvcnQgPSBpbnNwZWN0UHJlZmlsdGVyc09yVHJhbnNwb3J0cyh0cmFuc3BvcnRzLCBzLCBvcHRpb25zLCBqcVhIUik7CiAgICAgIC8vIElmIG5vIHRyYW5zcG9ydCwgd2UgYXV0by1hYm9ydAogICAgICBpZiAoIXRyYW5zcG9ydCkgewogICAgICAgIGRvbmUoLTEsICdObyBUcmFuc3BvcnQnKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBqcVhIUi5yZWFkeVN0YXRlID0gMTsKICAgICAgICAvLyBTZW5kIGdsb2JhbCBldmVudAogICAgICAgIGlmIChmaXJlR2xvYmFscykgewogICAgICAgICAgZ2xvYmFsRXZlbnRDb250ZXh0LnRyaWdnZXIoJ2FqYXhTZW5kJywgWwogICAgICAgICAgICBqcVhIUiwKICAgICAgICAgICAgcwogICAgICAgICAgXSk7CiAgICAgICAgfQogICAgICAgIC8vIFRpbWVvdXQKICAgICAgICBpZiAocy5hc3luYyAmJiBzLnRpbWVvdXQgPiAwKSB7CiAgICAgICAgICB0aW1lb3V0VGltZXIgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAganFYSFIuYWJvcnQoJ3RpbWVvdXQnKTsKICAgICAgICAgIH0sIHMudGltZW91dCk7CiAgICAgICAgfQogICAgICAgIHRyeSB7CiAgICAgICAgICBzdGF0ZSA9IDE7CiAgICAgICAgICB0cmFuc3BvcnQuc2VuZChyZXF1ZXN0SGVhZGVycywgZG9uZSk7CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgLy8gUHJvcGFnYXRlIGV4Y2VwdGlvbiBhcyBlcnJvciBpZiBub3QgZG9uZQogICAgICAgICAgaWYgKHN0YXRlIDwgMikgewogICAgICAgICAgICBkb25lKC0xLCBlKTsgIC8vIFNpbXBseSByZXRocm93IG90aGVyd2lzZQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhyb3cgZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgLy8gQ2FsbGJhY2sgZm9yIHdoZW4gZXZlcnl0aGluZyBpcyBkb25lCiAgICAgIGZ1bmN0aW9uIGRvbmUoc3RhdHVzLCBuYXRpdmVTdGF0dXNUZXh0LCByZXNwb25zZXMsIGhlYWRlcnMpIHsKICAgICAgICB2YXIgaXNTdWNjZXNzLCBzdWNjZXNzLCBlcnJvciwgcmVzcG9uc2UsIG1vZGlmaWVkLCBzdGF0dXNUZXh0ID0gbmF0aXZlU3RhdHVzVGV4dDsKICAgICAgICAvLyBDYWxsZWQgb25jZQogICAgICAgIGlmIChzdGF0ZSA9PT0gMikgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICAvLyBTdGF0ZSBpcyAiZG9uZSIgbm93CiAgICAgICAgc3RhdGUgPSAyOwogICAgICAgIC8vIENsZWFyIHRpbWVvdXQgaWYgaXQgZXhpc3RzCiAgICAgICAgaWYgKHRpbWVvdXRUaW1lcikgewogICAgICAgICAgY2xlYXJUaW1lb3V0KHRpbWVvdXRUaW1lcik7CiAgICAgICAgfQogICAgICAgIC8vIERlcmVmZXJlbmNlIHRyYW5zcG9ydCBmb3IgZWFybHkgZ2FyYmFnZSBjb2xsZWN0aW9uCiAgICAgICAgLy8gKG5vIG1hdHRlciBob3cgbG9uZyB0aGUganFYSFIgb2JqZWN0IHdpbGwgYmUgdXNlZCkKICAgICAgICB0cmFuc3BvcnQgPSB1bmRlZmluZWQ7CiAgICAgICAgLy8gQ2FjaGUgcmVzcG9uc2UgaGVhZGVycwogICAgICAgIHJlc3BvbnNlSGVhZGVyc1N0cmluZyA9IGhlYWRlcnMgfHwgJyc7CiAgICAgICAgLy8gU2V0IHJlYWR5U3RhdGUKICAgICAgICBqcVhIUi5yZWFkeVN0YXRlID0gc3RhdHVzID4gMCA/IDQgOiAwOwogICAgICAgIC8vIERldGVybWluZSBpZiBzdWNjZXNzZnVsCiAgICAgICAgaXNTdWNjZXNzID0gc3RhdHVzID49IDIwMCAmJiBzdGF0dXMgPCAzMDAgfHwgc3RhdHVzID09PSAzMDQ7CiAgICAgICAgLy8gR2V0IHJlc3BvbnNlIGRhdGEKICAgICAgICBpZiAocmVzcG9uc2VzKSB7CiAgICAgICAgICByZXNwb25zZSA9IGFqYXhIYW5kbGVSZXNwb25zZXMocywganFYSFIsIHJlc3BvbnNlcyk7CiAgICAgICAgfQogICAgICAgIC8vIENvbnZlcnQgbm8gbWF0dGVyIHdoYXQgKHRoYXQgd2F5IHJlc3BvbnNlWFhYIGZpZWxkcyBhcmUgYWx3YXlzIHNldCkKICAgICAgICByZXNwb25zZSA9IGFqYXhDb252ZXJ0KHMsIHJlc3BvbnNlLCBqcVhIUiwgaXNTdWNjZXNzKTsKICAgICAgICAvLyBJZiBzdWNjZXNzZnVsLCBoYW5kbGUgdHlwZSBjaGFpbmluZwogICAgICAgIGlmIChpc1N1Y2Nlc3MpIHsKICAgICAgICAgIC8vIFNldCB0aGUgSWYtTW9kaWZpZWQtU2luY2UgYW5kL29yIElmLU5vbmUtTWF0Y2ggaGVhZGVyLCBpZiBpbiBpZk1vZGlmaWVkIG1vZGUuCiAgICAgICAgICBpZiAocy5pZk1vZGlmaWVkKSB7CiAgICAgICAgICAgIG1vZGlmaWVkID0ganFYSFIuZ2V0UmVzcG9uc2VIZWFkZXIoJ0xhc3QtTW9kaWZpZWQnKTsKICAgICAgICAgICAgaWYgKG1vZGlmaWVkKSB7CiAgICAgICAgICAgICAgalF1ZXJ5Lmxhc3RNb2RpZmllZFtjYWNoZVVSTF0gPSBtb2RpZmllZDsKICAgICAgICAgICAgfQogICAgICAgICAgICBtb2RpZmllZCA9IGpxWEhSLmdldFJlc3BvbnNlSGVhZGVyKCdldGFnJyk7CiAgICAgICAgICAgIGlmIChtb2RpZmllZCkgewogICAgICAgICAgICAgIGpRdWVyeS5ldGFnW2NhY2hlVVJMXSA9IG1vZGlmaWVkOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICAvLyBpZiBubyBjb250ZW50CiAgICAgICAgICBpZiAoc3RhdHVzID09PSAyMDQgfHwgcy50eXBlID09PSAnSEVBRCcpIHsKICAgICAgICAgICAgc3RhdHVzVGV4dCA9ICdub2NvbnRlbnQnOyAgLy8gaWYgbm90IG1vZGlmaWVkCiAgICAgICAgICB9IGVsc2UgaWYgKHN0YXR1cyA9PT0gMzA0KSB7CiAgICAgICAgICAgIHN0YXR1c1RleHQgPSAnbm90bW9kaWZpZWQnOyAgLy8gSWYgd2UgaGF2ZSBkYXRhLCBsZXQncyBjb252ZXJ0IGl0CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzdGF0dXNUZXh0ID0gcmVzcG9uc2Uuc3RhdGU7CiAgICAgICAgICAgIHN1Y2Nlc3MgPSByZXNwb25zZS5kYXRhOwogICAgICAgICAgICBlcnJvciA9IHJlc3BvbnNlLmVycm9yOwogICAgICAgICAgICBpc1N1Y2Nlc3MgPSAhZXJyb3I7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIC8vIFdlIGV4dHJhY3QgZXJyb3IgZnJvbSBzdGF0dXNUZXh0CiAgICAgICAgICAvLyB0aGVuIG5vcm1hbGl6ZSBzdGF0dXNUZXh0IGFuZCBzdGF0dXMgZm9yIG5vbi1hYm9ydHMKICAgICAgICAgIGVycm9yID0gc3RhdHVzVGV4dDsKICAgICAgICAgIGlmIChzdGF0dXMgfHwgIXN0YXR1c1RleHQpIHsKICAgICAgICAgICAgc3RhdHVzVGV4dCA9ICdlcnJvcic7CiAgICAgICAgICAgIGlmIChzdGF0dXMgPCAwKSB7CiAgICAgICAgICAgICAgc3RhdHVzID0gMDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAvLyBTZXQgZGF0YSBmb3IgdGhlIGZha2UgeGhyIG9iamVjdAogICAgICAgIGpxWEhSLnN0YXR1cyA9IHN0YXR1czsKICAgICAgICBqcVhIUi5zdGF0dXNUZXh0ID0gKG5hdGl2ZVN0YXR1c1RleHQgfHwgc3RhdHVzVGV4dCkgKyAnJzsKICAgICAgICAvLyBTdWNjZXNzL0Vycm9yCiAgICAgICAgaWYgKGlzU3VjY2VzcykgewogICAgICAgICAgZGVmZXJyZWQucmVzb2x2ZVdpdGgoY2FsbGJhY2tDb250ZXh0LCBbCiAgICAgICAgICAgIHN1Y2Nlc3MsCiAgICAgICAgICAgIHN0YXR1c1RleHQsCiAgICAgICAgICAgIGpxWEhSCiAgICAgICAgICBdKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZGVmZXJyZWQucmVqZWN0V2l0aChjYWxsYmFja0NvbnRleHQsIFsKICAgICAgICAgICAganFYSFIsCiAgICAgICAgICAgIHN0YXR1c1RleHQsCiAgICAgICAgICAgIGVycm9yCiAgICAgICAgICBdKTsKICAgICAgICB9CiAgICAgICAgLy8gU3RhdHVzLWRlcGVuZGVudCBjYWxsYmFja3MKICAgICAgICBqcVhIUi5zdGF0dXNDb2RlKHN0YXR1c0NvZGUpOwogICAgICAgIHN0YXR1c0NvZGUgPSB1bmRlZmluZWQ7CiAgICAgICAgaWYgKGZpcmVHbG9iYWxzKSB7CiAgICAgICAgICBnbG9iYWxFdmVudENvbnRleHQudHJpZ2dlcihpc1N1Y2Nlc3MgPyAnYWpheFN1Y2Nlc3MnIDogJ2FqYXhFcnJvcicsIFsKICAgICAgICAgICAganFYSFIsCiAgICAgICAgICAgIHMsCiAgICAgICAgICAgIGlzU3VjY2VzcyA/IHN1Y2Nlc3MgOiBlcnJvcgogICAgICAgICAgXSk7CiAgICAgICAgfQogICAgICAgIC8vIENvbXBsZXRlCiAgICAgICAgY29tcGxldGVEZWZlcnJlZC5maXJlV2l0aChjYWxsYmFja0NvbnRleHQsIFsKICAgICAgICAgIGpxWEhSLAogICAgICAgICAgc3RhdHVzVGV4dAogICAgICAgIF0pOwogICAgICAgIGlmIChmaXJlR2xvYmFscykgewogICAgICAgICAgZ2xvYmFsRXZlbnRDb250ZXh0LnRyaWdnZXIoJ2FqYXhDb21wbGV0ZScsIFsKICAgICAgICAgICAganFYSFIsCiAgICAgICAgICAgIHMKICAgICAgICAgIF0pOwogICAgICAgICAgLy8gSGFuZGxlIHRoZSBnbG9iYWwgQUpBWCBjb3VudGVyCiAgICAgICAgICBpZiAoIS0talF1ZXJ5LmFjdGl2ZSkgewogICAgICAgICAgICBqUXVlcnkuZXZlbnQudHJpZ2dlcignYWpheFN0b3AnKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIGpxWEhSOwogICAgfSwKICAgIGdldEpTT046IGZ1bmN0aW9uICh1cmwsIGRhdGEsIGNhbGxiYWNrKSB7CiAgICAgIHJldHVybiBqUXVlcnkuZ2V0KHVybCwgZGF0YSwgY2FsbGJhY2ssICdqc29uJyk7CiAgICB9LAogICAgZ2V0U2NyaXB0OiBmdW5jdGlvbiAodXJsLCBjYWxsYmFjaykgewogICAgICByZXR1cm4galF1ZXJ5LmdldCh1cmwsIHVuZGVmaW5lZCwgY2FsbGJhY2ssICdzY3JpcHQnKTsKICAgIH0KICB9KTsKICBqUXVlcnkuZWFjaChbCiAgICAnZ2V0JywKICAgICdwb3N0JwogIF0sIGZ1bmN0aW9uIChpLCBtZXRob2QpIHsKICAgIGpRdWVyeVttZXRob2RdID0gZnVuY3Rpb24gKHVybCwgZGF0YSwgY2FsbGJhY2ssIHR5cGUpIHsKICAgICAgLy8gc2hpZnQgYXJndW1lbnRzIGlmIGRhdGEgYXJndW1lbnQgd2FzIG9taXR0ZWQKICAgICAgaWYgKGpRdWVyeS5pc0Z1bmN0aW9uKGRhdGEpKSB7CiAgICAgICAgdHlwZSA9IHR5cGUgfHwgY2FsbGJhY2s7CiAgICAgICAgY2FsbGJhY2sgPSBkYXRhOwogICAgICAgIGRhdGEgPSB1bmRlZmluZWQ7CiAgICAgIH0KICAgICAgcmV0dXJuIGpRdWVyeS5hamF4KHsKICAgICAgICB1cmw6IHVybCwKICAgICAgICB0eXBlOiBtZXRob2QsCiAgICAgICAgZGF0YVR5cGU6IHR5cGUsCiAgICAgICAgZGF0YTogZGF0YSwKICAgICAgICBzdWNjZXNzOiBjYWxsYmFjawogICAgICB9KTsKICAgIH07CiAgfSk7CiAgLy8gQXR0YWNoIGEgYnVuY2ggb2YgZnVuY3Rpb25zIGZvciBoYW5kbGluZyBjb21tb24gQUpBWCBldmVudHMKICBqUXVlcnkuZWFjaChbCiAgICAnYWpheFN0YXJ0JywKICAgICdhamF4U3RvcCcsCiAgICAnYWpheENvbXBsZXRlJywKICAgICdhamF4RXJyb3InLAogICAgJ2FqYXhTdWNjZXNzJywKICAgICdhamF4U2VuZCcKICBdLCBmdW5jdGlvbiAoaSwgdHlwZSkgewogICAgalF1ZXJ5LmZuW3R5cGVdID0gZnVuY3Rpb24gKGZuKSB7CiAgICAgIHJldHVybiB0aGlzLm9uKHR5cGUsIGZuKTsKICAgIH07CiAgfSk7CiAgalF1ZXJ5Ll9ldmFsVXJsID0gZnVuY3Rpb24gKHVybCkgewogICAgcmV0dXJuIGpRdWVyeS5hamF4KHsKICAgICAgdXJsOiB1cmwsCiAgICAgIHR5cGU6ICdHRVQnLAogICAgICBkYXRhVHlwZTogJ3NjcmlwdCcsCiAgICAgIGFzeW5jOiBmYWxzZSwKICAgICAgZ2xvYmFsOiBmYWxzZSwKICAgICAgJ3Rocm93cyc6IHRydWUKICAgIH0pOwogIH07CiAgalF1ZXJ5LmZuLmV4dGVuZCh7CiAgICB3cmFwQWxsOiBmdW5jdGlvbiAoaHRtbCkgewogICAgICB2YXIgd3JhcDsKICAgICAgaWYgKGpRdWVyeS5pc0Z1bmN0aW9uKGh0bWwpKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoaSkgewogICAgICAgICAgalF1ZXJ5KHRoaXMpLndyYXBBbGwoaHRtbC5jYWxsKHRoaXMsIGkpKTsKICAgICAgICB9KTsKICAgICAgfQogICAgICBpZiAodGhpc1swXSkgewogICAgICAgIC8vIFRoZSBlbGVtZW50cyB0byB3cmFwIHRoZSB0YXJnZXQgYXJvdW5kCiAgICAgICAgd3JhcCA9IGpRdWVyeShodG1sLCB0aGlzWzBdLm93bmVyRG9jdW1lbnQpLmVxKDApLmNsb25lKHRydWUpOwogICAgICAgIGlmICh0aGlzWzBdLnBhcmVudE5vZGUpIHsKICAgICAgICAgIHdyYXAuaW5zZXJ0QmVmb3JlKHRoaXNbMF0pOwogICAgICAgIH0KICAgICAgICB3cmFwLm1hcChmdW5jdGlvbiAoKSB7CiAgICAgICAgICB2YXIgZWxlbSA9IHRoaXM7CiAgICAgICAgICB3aGlsZSAoZWxlbS5maXJzdEVsZW1lbnRDaGlsZCkgewogICAgICAgICAgICBlbGVtID0gZWxlbS5maXJzdEVsZW1lbnRDaGlsZDsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBlbGVtOwogICAgICAgIH0pLmFwcGVuZCh0aGlzKTsKICAgICAgfQogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgICB3cmFwSW5uZXI6IGZ1bmN0aW9uIChodG1sKSB7CiAgICAgIGlmIChqUXVlcnkuaXNGdW5jdGlvbihodG1sKSkgewogICAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24gKGkpIHsKICAgICAgICAgIGpRdWVyeSh0aGlzKS53cmFwSW5uZXIoaHRtbC5jYWxsKHRoaXMsIGkpKTsKICAgICAgICB9KTsKICAgICAgfQogICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgc2VsZiA9IGpRdWVyeSh0aGlzKSwgY29udGVudHMgPSBzZWxmLmNvbnRlbnRzKCk7CiAgICAgICAgaWYgKGNvbnRlbnRzLmxlbmd0aCkgewogICAgICAgICAgY29udGVudHMud3JhcEFsbChodG1sKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgc2VsZi5hcHBlbmQoaHRtbCk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0sCiAgICB3cmFwOiBmdW5jdGlvbiAoaHRtbCkgewogICAgICB2YXIgaXNGdW5jdGlvbiA9IGpRdWVyeS5pc0Z1bmN0aW9uKGh0bWwpOwogICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uIChpKSB7CiAgICAgICAgalF1ZXJ5KHRoaXMpLndyYXBBbGwoaXNGdW5jdGlvbiA/IGh0bWwuY2FsbCh0aGlzLCBpKSA6IGh0bWwpOwogICAgICB9KTsKICAgIH0sCiAgICB1bndyYXA6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIHRoaXMucGFyZW50KCkuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgaWYgKCFqUXVlcnkubm9kZU5hbWUodGhpcywgJ2JvZHknKSkgewogICAgICAgICAgalF1ZXJ5KHRoaXMpLnJlcGxhY2VXaXRoKHRoaXMuY2hpbGROb2Rlcyk7CiAgICAgICAgfQogICAgICB9KS5lbmQoKTsKICAgIH0KICB9KTsKICBqUXVlcnkuZXhwci5maWx0ZXJzLmhpZGRlbiA9IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAvLyBTdXBwb3J0OiBPcGVyYSA8PSAxMi4xMgogICAgLy8gT3BlcmEgcmVwb3J0cyBvZmZzZXRXaWR0aHMgYW5kIG9mZnNldEhlaWdodHMgbGVzcyB0aGFuIHplcm8gb24gc29tZSBlbGVtZW50cwogICAgcmV0dXJuIGVsZW0ub2Zmc2V0V2lkdGggPD0gMCAmJiBlbGVtLm9mZnNldEhlaWdodCA8PSAwOwogIH07CiAgalF1ZXJ5LmV4cHIuZmlsdGVycy52aXNpYmxlID0gZnVuY3Rpb24gKGVsZW0pIHsKICAgIHJldHVybiAhalF1ZXJ5LmV4cHIuZmlsdGVycy5oaWRkZW4oZWxlbSk7CiAgfTsKICB2YXIgcjIwID0gLyUyMC9nLCByYnJhY2tldCA9IC9cW1xdJC8sIHJDUkxGID0gL1xyP1xuL2csIHJzdWJtaXR0ZXJUeXBlcyA9IC9eKD86c3VibWl0fGJ1dHRvbnxpbWFnZXxyZXNldHxmaWxlKSQvaSwgcnN1Ym1pdHRhYmxlID0gL14oPzppbnB1dHxzZWxlY3R8dGV4dGFyZWF8a2V5Z2VuKS9pOwogIGZ1bmN0aW9uIGJ1aWxkUGFyYW1zKHByZWZpeCwgb2JqLCB0cmFkaXRpb25hbCwgYWRkKSB7CiAgICB2YXIgbmFtZTsKICAgIGlmIChqUXVlcnkuaXNBcnJheShvYmopKSB7CiAgICAgIC8vIFNlcmlhbGl6ZSBhcnJheSBpdGVtLgogICAgICBqUXVlcnkuZWFjaChvYmosIGZ1bmN0aW9uIChpLCB2KSB7CiAgICAgICAgaWYgKHRyYWRpdGlvbmFsIHx8IHJicmFja2V0LnRlc3QocHJlZml4KSkgewogICAgICAgICAgLy8gVHJlYXQgZWFjaCBhcnJheSBpdGVtIGFzIGEgc2NhbGFyLgogICAgICAgICAgYWRkKHByZWZpeCwgdik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIC8vIEl0ZW0gaXMgbm9uLXNjYWxhciAoYXJyYXkgb3Igb2JqZWN0KSwgZW5jb2RlIGl0cyBudW1lcmljIGluZGV4LgogICAgICAgICAgYnVpbGRQYXJhbXMocHJlZml4ICsgJ1snICsgKHR5cGVvZiB2ID09PSAnb2JqZWN0JyA/IGkgOiAnJykgKyAnXScsIHYsIHRyYWRpdGlvbmFsLCBhZGQpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9IGVsc2UgaWYgKCF0cmFkaXRpb25hbCAmJiBqUXVlcnkudHlwZShvYmopID09PSAnb2JqZWN0JykgewogICAgICAvLyBTZXJpYWxpemUgb2JqZWN0IGl0ZW0uCiAgICAgIGZvciAobmFtZSBpbiBvYmopIHsKICAgICAgICBidWlsZFBhcmFtcyhwcmVmaXggKyAnWycgKyBuYW1lICsgJ10nLCBvYmpbbmFtZV0sIHRyYWRpdGlvbmFsLCBhZGQpOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICAvLyBTZXJpYWxpemUgc2NhbGFyIGl0ZW0uCiAgICAgIGFkZChwcmVmaXgsIG9iaik7CiAgICB9CiAgfQogIC8vIFNlcmlhbGl6ZSBhbiBhcnJheSBvZiBmb3JtIGVsZW1lbnRzIG9yIGEgc2V0IG9mCiAgLy8ga2V5L3ZhbHVlcyBpbnRvIGEgcXVlcnkgc3RyaW5nCiAgalF1ZXJ5LnBhcmFtID0gZnVuY3Rpb24gKGEsIHRyYWRpdGlvbmFsKSB7CiAgICB2YXIgcHJlZml4LCBzID0gW10sIGFkZCA9IGZ1bmN0aW9uIChrZXksIHZhbHVlKSB7CiAgICAgICAgLy8gSWYgdmFsdWUgaXMgYSBmdW5jdGlvbiwgaW52b2tlIGl0IGFuZCByZXR1cm4gaXRzIHZhbHVlCiAgICAgICAgdmFsdWUgPSBqUXVlcnkuaXNGdW5jdGlvbih2YWx1ZSkgPyB2YWx1ZSgpIDogdmFsdWUgPT0gbnVsbCA/ICcnIDogdmFsdWU7CiAgICAgICAgc1tzLmxlbmd0aF0gPSBlbmNvZGVVUklDb21wb25lbnQoa2V5KSArICc9JyArIGVuY29kZVVSSUNvbXBvbmVudCh2YWx1ZSk7CiAgICAgIH07CiAgICAvLyBTZXQgdHJhZGl0aW9uYWwgdG8gdHJ1ZSBmb3IgalF1ZXJ5IDw9IDEuMy4yIGJlaGF2aW9yLgogICAgaWYgKHRyYWRpdGlvbmFsID09PSB1bmRlZmluZWQpIHsKICAgICAgdHJhZGl0aW9uYWwgPSBqUXVlcnkuYWpheFNldHRpbmdzICYmIGpRdWVyeS5hamF4U2V0dGluZ3MudHJhZGl0aW9uYWw7CiAgICB9CiAgICAvLyBJZiBhbiBhcnJheSB3YXMgcGFzc2VkIGluLCBhc3N1bWUgdGhhdCBpdCBpcyBhbiBhcnJheSBvZiBmb3JtIGVsZW1lbnRzLgogICAgaWYgKGpRdWVyeS5pc0FycmF5KGEpIHx8IGEuanF1ZXJ5ICYmICFqUXVlcnkuaXNQbGFpbk9iamVjdChhKSkgewogICAgICAvLyBTZXJpYWxpemUgdGhlIGZvcm0gZWxlbWVudHMKICAgICAgalF1ZXJ5LmVhY2goYSwgZnVuY3Rpb24gKCkgewogICAgICAgIGFkZCh0aGlzLm5hbWUsIHRoaXMudmFsdWUpOwogICAgICB9KTsKICAgIH0gZWxzZSB7CiAgICAgIC8vIElmIHRyYWRpdGlvbmFsLCBlbmNvZGUgdGhlICJvbGQiIHdheSAodGhlIHdheSAxLjMuMiBvciBvbGRlcgogICAgICAvLyBkaWQgaXQpLCBvdGhlcndpc2UgZW5jb2RlIHBhcmFtcyByZWN1cnNpdmVseS4KICAgICAgZm9yIChwcmVmaXggaW4gYSkgewogICAgICAgIGJ1aWxkUGFyYW1zKHByZWZpeCwgYVtwcmVmaXhdLCB0cmFkaXRpb25hbCwgYWRkKTsKICAgICAgfQogICAgfQogICAgLy8gUmV0dXJuIHRoZSByZXN1bHRpbmcgc2VyaWFsaXphdGlvbgogICAgcmV0dXJuIHMuam9pbignJicpLnJlcGxhY2UocjIwLCAnKycpOwogIH07CiAgalF1ZXJ5LmZuLmV4dGVuZCh7CiAgICBzZXJpYWxpemU6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIGpRdWVyeS5wYXJhbSh0aGlzLnNlcmlhbGl6ZUFycmF5KCkpOwogICAgfSwKICAgIHNlcmlhbGl6ZUFycmF5OiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiB0aGlzLm1hcChmdW5jdGlvbiAoKSB7CiAgICAgICAgLy8gQ2FuIGFkZCBwcm9wSG9vayBmb3IgImVsZW1lbnRzIiB0byBmaWx0ZXIgb3IgYWRkIGZvcm0gZWxlbWVudHMKICAgICAgICB2YXIgZWxlbWVudHMgPSBqUXVlcnkucHJvcCh0aGlzLCAnZWxlbWVudHMnKTsKICAgICAgICByZXR1cm4gZWxlbWVudHMgPyBqUXVlcnkubWFrZUFycmF5KGVsZW1lbnRzKSA6IHRoaXM7CiAgICAgIH0pLmZpbHRlcihmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIHR5cGUgPSB0aGlzLnR5cGU7CiAgICAgICAgLy8gVXNlIC5pcyggIjpkaXNhYmxlZCIgKSBzbyB0aGF0IGZpZWxkc2V0W2Rpc2FibGVkXSB3b3JrcwogICAgICAgIHJldHVybiB0aGlzLm5hbWUgJiYgIWpRdWVyeSh0aGlzKS5pcygnOmRpc2FibGVkJykgJiYgcnN1Ym1pdHRhYmxlLnRlc3QodGhpcy5ub2RlTmFtZSkgJiYgIXJzdWJtaXR0ZXJUeXBlcy50ZXN0KHR5cGUpICYmICh0aGlzLmNoZWNrZWQgfHwgIXJjaGVja2FibGVUeXBlLnRlc3QodHlwZSkpOwogICAgICB9KS5tYXAoZnVuY3Rpb24gKGksIGVsZW0pIHsKICAgICAgICB2YXIgdmFsID0galF1ZXJ5KHRoaXMpLnZhbCgpOwogICAgICAgIHJldHVybiB2YWwgPT0gbnVsbCA/IG51bGwgOiBqUXVlcnkuaXNBcnJheSh2YWwpID8galF1ZXJ5Lm1hcCh2YWwsIGZ1bmN0aW9uICh2YWwpIHsKICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIG5hbWU6IGVsZW0ubmFtZSwKICAgICAgICAgICAgdmFsdWU6IHZhbC5yZXBsYWNlKHJDUkxGLCAnXHJcbicpCiAgICAgICAgICB9OwogICAgICAgIH0pIDogewogICAgICAgICAgbmFtZTogZWxlbS5uYW1lLAogICAgICAgICAgdmFsdWU6IHZhbC5yZXBsYWNlKHJDUkxGLCAnXHJcbicpCiAgICAgICAgfTsKICAgICAgfSkuZ2V0KCk7CiAgICB9CiAgfSk7CiAgalF1ZXJ5LmFqYXhTZXR0aW5ncy54aHIgPSBmdW5jdGlvbiAoKSB7CiAgICB0cnkgewogICAgICByZXR1cm4gbmV3IFhNTEh0dHBSZXF1ZXN0KCk7CiAgICB9IGNhdGNoIChlKSB7CiAgICB9CiAgfTsKICB2YXIgeGhySWQgPSAwLCB4aHJDYWxsYmFja3MgPSB7fSwgeGhyU3VjY2Vzc1N0YXR1cyA9IHsKICAgICAgLy8gZmlsZSBwcm90b2NvbCBhbHdheXMgeWllbGRzIHN0YXR1cyBjb2RlIDAsIGFzc3VtZSAyMDAKICAgICAgMDogMjAwLAogICAgICAvLyBTdXBwb3J0OiBJRTkKICAgICAgLy8gIzE0NTA6IHNvbWV0aW1lcyBJRSByZXR1cm5zIDEyMjMgd2hlbiBpdCBzaG91bGQgYmUgMjA0CiAgICAgIDEyMjM6IDIwNAogICAgfSwgeGhyU3VwcG9ydGVkID0galF1ZXJ5LmFqYXhTZXR0aW5ncy54aHIoKTsKICAvLyBTdXBwb3J0OiBJRTkKICAvLyBPcGVuIHJlcXVlc3RzIG11c3QgYmUgbWFudWFsbHkgYWJvcnRlZCBvbiB1bmxvYWQgKCM1MjgwKQogIGlmICh3aW5kb3cuQWN0aXZlWE9iamVjdCkgewogICAgalF1ZXJ5KHdpbmRvdykub24oJ3VubG9hZCcsIGZ1bmN0aW9uICgpIHsKICAgICAgZm9yICh2YXIga2V5IGluIHhockNhbGxiYWNrcykgewogICAgICAgIHhockNhbGxiYWNrc1trZXldKCk7CiAgICAgIH0KICAgIH0pOwogIH0KICBzdXBwb3J0LmNvcnMgPSAhIXhoclN1cHBvcnRlZCAmJiAnd2l0aENyZWRlbnRpYWxzJyBpbiB4aHJTdXBwb3J0ZWQ7CiAgc3VwcG9ydC5hamF4ID0geGhyU3VwcG9ydGVkID0gISF4aHJTdXBwb3J0ZWQ7CiAgalF1ZXJ5LmFqYXhUcmFuc3BvcnQoZnVuY3Rpb24gKG9wdGlvbnMpIHsKICAgIHZhciBjYWxsYmFjazsKICAgIC8vIENyb3NzIGRvbWFpbiBvbmx5IGFsbG93ZWQgaWYgc3VwcG9ydGVkIHRocm91Z2ggWE1MSHR0cFJlcXVlc3QKICAgIGlmIChzdXBwb3J0LmNvcnMgfHwgeGhyU3VwcG9ydGVkICYmICFvcHRpb25zLmNyb3NzRG9tYWluKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgc2VuZDogZnVuY3Rpb24gKGhlYWRlcnMsIGNvbXBsZXRlKSB7CiAgICAgICAgICB2YXIgaSwgeGhyID0gb3B0aW9ucy54aHIoKSwgaWQgPSArK3hocklkOwogICAgICAgICAgeGhyLm9wZW4ob3B0aW9ucy50eXBlLCBvcHRpb25zLnVybCwgb3B0aW9ucy5hc3luYywgb3B0aW9ucy51c2VybmFtZSwgb3B0aW9ucy5wYXNzd29yZCk7CiAgICAgICAgICAvLyBBcHBseSBjdXN0b20gZmllbGRzIGlmIHByb3ZpZGVkCiAgICAgICAgICBpZiAob3B0aW9ucy54aHJGaWVsZHMpIHsKICAgICAgICAgICAgZm9yIChpIGluIG9wdGlvbnMueGhyRmllbGRzKSB7CiAgICAgICAgICAgICAgeGhyW2ldID0gb3B0aW9ucy54aHJGaWVsZHNbaV07CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIC8vIE92ZXJyaWRlIG1pbWUgdHlwZSBpZiBuZWVkZWQKICAgICAgICAgIGlmIChvcHRpb25zLm1pbWVUeXBlICYmIHhoci5vdmVycmlkZU1pbWVUeXBlKSB7CiAgICAgICAgICAgIHhoci5vdmVycmlkZU1pbWVUeXBlKG9wdGlvbnMubWltZVR5cGUpOwogICAgICAgICAgfQogICAgICAgICAgLy8gWC1SZXF1ZXN0ZWQtV2l0aCBoZWFkZXIKICAgICAgICAgIC8vIEZvciBjcm9zcy1kb21haW4gcmVxdWVzdHMsIHNlZWluZyBhcyBjb25kaXRpb25zIGZvciBhIHByZWZsaWdodCBhcmUKICAgICAgICAgIC8vIGFraW4gdG8gYSBqaWdzYXcgcHV6emxlLCB3ZSBzaW1wbHkgbmV2ZXIgc2V0IGl0IHRvIGJlIHN1cmUuCiAgICAgICAgICAvLyAoaXQgY2FuIGFsd2F5cyBiZSBzZXQgb24gYSBwZXItcmVxdWVzdCBiYXNpcyBvciBldmVuIHVzaW5nIGFqYXhTZXR1cCkKICAgICAgICAgIC8vIEZvciBzYW1lLWRvbWFpbiByZXF1ZXN0cywgd29uJ3QgY2hhbmdlIGhlYWRlciBpZiBhbHJlYWR5IHByb3ZpZGVkLgogICAgICAgICAgaWYgKCFvcHRpb25zLmNyb3NzRG9tYWluICYmICFoZWFkZXJzWydYLVJlcXVlc3RlZC1XaXRoJ10pIHsKICAgICAgICAgICAgaGVhZGVyc1snWC1SZXF1ZXN0ZWQtV2l0aCddID0gJ1hNTEh0dHBSZXF1ZXN0JzsKICAgICAgICAgIH0KICAgICAgICAgIC8vIFNldCBoZWFkZXJzCiAgICAgICAgICBmb3IgKGkgaW4gaGVhZGVycykgewogICAgICAgICAgICB4aHIuc2V0UmVxdWVzdEhlYWRlcihpLCBoZWFkZXJzW2ldKTsKICAgICAgICAgIH0KICAgICAgICAgIC8vIENhbGxiYWNrCiAgICAgICAgICBjYWxsYmFjayA9IGZ1bmN0aW9uICh0eXBlKSB7CiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgaWYgKGNhbGxiYWNrKSB7CiAgICAgICAgICAgICAgICBkZWxldGUgeGhyQ2FsbGJhY2tzW2lkXTsKICAgICAgICAgICAgICAgIGNhbGxiYWNrID0geGhyLm9ubG9hZCA9IHhoci5vbmVycm9yID0gbnVsbDsKICAgICAgICAgICAgICAgIGlmICh0eXBlID09PSAnYWJvcnQnKSB7CiAgICAgICAgICAgICAgICAgIHhoci5hYm9ydCgpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnZXJyb3InKSB7CiAgICAgICAgICAgICAgICAgIGNvbXBsZXRlKC8vIGZpbGU6IHByb3RvY29sIGFsd2F5cyB5aWVsZHMgc3RhdHVzIDA7IHNlZSAjODYwNSwgIzE0MjA3CiAgICAgICAgICAgICAgICAgIHhoci5zdGF0dXMsIHhoci5zdGF0dXNUZXh0KTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGNvbXBsZXRlKHhoclN1Y2Nlc3NTdGF0dXNbeGhyLnN0YXR1c10gfHwgeGhyLnN0YXR1cywgeGhyLnN0YXR1c1RleHQsIC8vIFN1cHBvcnQ6IElFOQogICAgICAgICAgICAgICAgICAvLyBBY2Nlc3NpbmcgYmluYXJ5LWRhdGEgcmVzcG9uc2VUZXh0IHRocm93cyBhbiBleGNlcHRpb24KICAgICAgICAgICAgICAgICAgLy8gKCMxMTQyNikKICAgICAgICAgICAgICAgICAgdHlwZW9mIHhoci5yZXNwb25zZVRleHQgPT09ICdzdHJpbmcnID8geyB0ZXh0OiB4aHIucmVzcG9uc2VUZXh0IH0gOiB1bmRlZmluZWQsIHhoci5nZXRBbGxSZXNwb25zZUhlYWRlcnMoKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgICAgfTsKICAgICAgICAgIC8vIExpc3RlbiB0byBldmVudHMKICAgICAgICAgIHhoci5vbmxvYWQgPSBjYWxsYmFjaygpOwogICAgICAgICAgeGhyLm9uZXJyb3IgPSBjYWxsYmFjaygnZXJyb3InKTsKICAgICAgICAgIC8vIENyZWF0ZSB0aGUgYWJvcnQgY2FsbGJhY2sKICAgICAgICAgIGNhbGxiYWNrID0geGhyQ2FsbGJhY2tzW2lkXSA9IGNhbGxiYWNrKCdhYm9ydCcpOwogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgLy8gRG8gc2VuZCB0aGUgcmVxdWVzdCAodGhpcyBtYXkgcmFpc2UgYW4gZXhjZXB0aW9uKQogICAgICAgICAgICB4aHIuc2VuZChvcHRpb25zLmhhc0NvbnRlbnQgJiYgb3B0aW9ucy5kYXRhIHx8IG51bGwpOwogICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAvLyAjMTQ2ODM6IE9ubHkgcmV0aHJvdyBpZiB0aGlzIGhhc24ndCBiZWVuIG5vdGlmaWVkIGFzIGFuIGVycm9yIHlldAogICAgICAgICAgICBpZiAoY2FsbGJhY2spIHsKICAgICAgICAgICAgICB0aHJvdyBlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBhYm9ydDogZnVuY3Rpb24gKCkgewogICAgICAgICAgaWYgKGNhbGxiYWNrKSB7CiAgICAgICAgICAgIGNhbGxiYWNrKCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9OwogICAgfQogIH0pOwogIC8vIEluc3RhbGwgc2NyaXB0IGRhdGFUeXBlCiAgalF1ZXJ5LmFqYXhTZXR1cCh7CiAgICBhY2NlcHRzOiB7IHNjcmlwdDogJ3RleHQvamF2YXNjcmlwdCwgYXBwbGljYXRpb24vamF2YXNjcmlwdCwgYXBwbGljYXRpb24vZWNtYXNjcmlwdCwgYXBwbGljYXRpb24veC1lY21hc2NyaXB0JyB9LAogICAgY29udGVudHM6IHsgc2NyaXB0OiAvKD86amF2YXxlY21hKXNjcmlwdC8gfSwKICAgIGNvbnZlcnRlcnM6IHsKICAgICAgJ3RleHQgc2NyaXB0JzogZnVuY3Rpb24gKHRleHQpIHsKICAgICAgICBqUXVlcnkuZ2xvYmFsRXZhbCh0ZXh0KTsKICAgICAgICByZXR1cm4gdGV4dDsKICAgICAgfQogICAgfQogIH0pOwogIC8vIEhhbmRsZSBjYWNoZSdzIHNwZWNpYWwgY2FzZSBhbmQgY3Jvc3NEb21haW4KICBqUXVlcnkuYWpheFByZWZpbHRlcignc2NyaXB0JywgZnVuY3Rpb24gKHMpIHsKICAgIGlmIChzLmNhY2hlID09PSB1bmRlZmluZWQpIHsKICAgICAgcy5jYWNoZSA9IGZhbHNlOwogICAgfQogICAgaWYgKHMuY3Jvc3NEb21haW4pIHsKICAgICAgcy50eXBlID0gJ0dFVCc7CiAgICB9CiAgfSk7CiAgLy8gQmluZCBzY3JpcHQgdGFnIGhhY2sgdHJhbnNwb3J0CiAgalF1ZXJ5LmFqYXhUcmFuc3BvcnQoJ3NjcmlwdCcsIGZ1bmN0aW9uIChzKSB7CiAgICAvLyBUaGlzIHRyYW5zcG9ydCBvbmx5IGRlYWxzIHdpdGggY3Jvc3MgZG9tYWluIHJlcXVlc3RzCiAgICBpZiAocy5jcm9zc0RvbWFpbikgewogICAgICB2YXIgc2NyaXB0LCBjYWxsYmFjazsKICAgICAgcmV0dXJuIHsKICAgICAgICBzZW5kOiBmdW5jdGlvbiAoXywgY29tcGxldGUpIHsKICAgICAgICAgIHNjcmlwdCA9IGpRdWVyeSgnPHNjcmlwdD4nKS5wcm9wKHsKICAgICAgICAgICAgYXN5bmM6IHRydWUsCiAgICAgICAgICAgIGNoYXJzZXQ6IHMuc2NyaXB0Q2hhcnNldCwKICAgICAgICAgICAgc3JjOiBzLnVybAogICAgICAgICAgfSkub24oJ2xvYWQgZXJyb3InLCBjYWxsYmFjayA9IGZ1bmN0aW9uIChldnQpIHsKICAgICAgICAgICAgc2NyaXB0LnJlbW92ZSgpOwogICAgICAgICAgICBjYWxsYmFjayA9IG51bGw7CiAgICAgICAgICAgIGlmIChldnQpIHsKICAgICAgICAgICAgICBjb21wbGV0ZShldnQudHlwZSA9PT0gJ2Vycm9yJyA/IDQwNCA6IDIwMCwgZXZ0LnR5cGUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICAgIGRvY3VtZW50LmhlYWQuYXBwZW5kQ2hpbGQoc2NyaXB0WzBdKTsKICAgICAgICB9LAogICAgICAgIGFib3J0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBpZiAoY2FsbGJhY2spIHsKICAgICAgICAgICAgY2FsbGJhY2soKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH07CiAgICB9CiAgfSk7CiAgdmFyIG9sZENhbGxiYWNrcyA9IFtdLCByanNvbnAgPSAvKD0pXD8oPz0mfCQpfFw/XD8vOwogIC8vIERlZmF1bHQganNvbnAgc2V0dGluZ3MKICBqUXVlcnkuYWpheFNldHVwKHsKICAgIGpzb25wOiAnY2FsbGJhY2snLAogICAganNvbnBDYWxsYmFjazogZnVuY3Rpb24gKCkgewogICAgICB2YXIgY2FsbGJhY2sgPSBvbGRDYWxsYmFja3MucG9wKCkgfHwgalF1ZXJ5LmV4cGFuZG8gKyAnXycgKyBub25jZSsrOwogICAgICB0aGlzW2NhbGxiYWNrXSA9IHRydWU7CiAgICAgIHJldHVybiBjYWxsYmFjazsKICAgIH0KICB9KTsKICAvLyBEZXRlY3QsIG5vcm1hbGl6ZSBvcHRpb25zIGFuZCBpbnN0YWxsIGNhbGxiYWNrcyBmb3IganNvbnAgcmVxdWVzdHMKICBqUXVlcnkuYWpheFByZWZpbHRlcignanNvbiBqc29ucCcsIGZ1bmN0aW9uIChzLCBvcmlnaW5hbFNldHRpbmdzLCBqcVhIUikgewogICAgdmFyIGNhbGxiYWNrTmFtZSwgb3ZlcndyaXR0ZW4sIHJlc3BvbnNlQ29udGFpbmVyLCBqc29uUHJvcCA9IHMuanNvbnAgIT09IGZhbHNlICYmIChyanNvbnAudGVzdChzLnVybCkgPyAndXJsJyA6IHR5cGVvZiBzLmRhdGEgPT09ICdzdHJpbmcnICYmICEocy5jb250ZW50VHlwZSB8fCAnJykuaW5kZXhPZignYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkJykgJiYgcmpzb25wLnRlc3Qocy5kYXRhKSAmJiAnZGF0YScpOwogICAgLy8gSGFuZGxlIGlmZiB0aGUgZXhwZWN0ZWQgZGF0YSB0eXBlIGlzICJqc29ucCIgb3Igd2UgaGF2ZSBhIHBhcmFtZXRlciB0byBzZXQKICAgIGlmIChqc29uUHJvcCB8fCBzLmRhdGFUeXBlc1swXSA9PT0gJ2pzb25wJykgewogICAgICAvLyBHZXQgY2FsbGJhY2sgbmFtZSwgcmVtZW1iZXJpbmcgcHJlZXhpc3RpbmcgdmFsdWUgYXNzb2NpYXRlZCB3aXRoIGl0CiAgICAgIGNhbGxiYWNrTmFtZSA9IHMuanNvbnBDYWxsYmFjayA9IGpRdWVyeS5pc0Z1bmN0aW9uKHMuanNvbnBDYWxsYmFjaykgPyBzLmpzb25wQ2FsbGJhY2soKSA6IHMuanNvbnBDYWxsYmFjazsKICAgICAgLy8gSW5zZXJ0IGNhbGxiYWNrIGludG8gdXJsIG9yIGZvcm0gZGF0YQogICAgICBpZiAoanNvblByb3ApIHsKICAgICAgICBzW2pzb25Qcm9wXSA9IHNbanNvblByb3BdLnJlcGxhY2Uocmpzb25wLCAnJDEnICsgY2FsbGJhY2tOYW1lKTsKICAgICAgfSBlbHNlIGlmIChzLmpzb25wICE9PSBmYWxzZSkgewogICAgICAgIHMudXJsICs9IChycXVlcnkudGVzdChzLnVybCkgPyAnJicgOiAnPycpICsgcy5qc29ucCArICc9JyArIGNhbGxiYWNrTmFtZTsKICAgICAgfQogICAgICAvLyBVc2UgZGF0YSBjb252ZXJ0ZXIgdG8gcmV0cmlldmUganNvbiBhZnRlciBzY3JpcHQgZXhlY3V0aW9uCiAgICAgIHMuY29udmVydGVyc1snc2NyaXB0IGpzb24nXSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBpZiAoIXJlc3BvbnNlQ29udGFpbmVyKSB7CiAgICAgICAgICBqUXVlcnkuZXJyb3IoY2FsbGJhY2tOYW1lICsgJyB3YXMgbm90IGNhbGxlZCcpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzcG9uc2VDb250YWluZXJbMF07CiAgICAgIH07CiAgICAgIC8vIGZvcmNlIGpzb24gZGF0YVR5cGUKICAgICAgcy5kYXRhVHlwZXNbMF0gPSAnanNvbic7CiAgICAgIC8vIEluc3RhbGwgY2FsbGJhY2sKICAgICAgb3ZlcndyaXR0ZW4gPSB3aW5kb3dbY2FsbGJhY2tOYW1lXTsKICAgICAgd2luZG93W2NhbGxiYWNrTmFtZV0gPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmVzcG9uc2VDb250YWluZXIgPSBhcmd1bWVudHM7CiAgICAgIH07CiAgICAgIC8vIENsZWFuLXVwIGZ1bmN0aW9uIChmaXJlcyBhZnRlciBjb252ZXJ0ZXJzKQogICAgICBqcVhIUi5hbHdheXMoZnVuY3Rpb24gKCkgewogICAgICAgIC8vIFJlc3RvcmUgcHJlZXhpc3RpbmcgdmFsdWUKICAgICAgICB3aW5kb3dbY2FsbGJhY2tOYW1lXSA9IG92ZXJ3cml0dGVuOwogICAgICAgIC8vIFNhdmUgYmFjayBhcyBmcmVlCiAgICAgICAgaWYgKHNbY2FsbGJhY2tOYW1lXSkgewogICAgICAgICAgLy8gbWFrZSBzdXJlIHRoYXQgcmUtdXNpbmcgdGhlIG9wdGlvbnMgZG9lc24ndCBzY3JldyB0aGluZ3MgYXJvdW5kCiAgICAgICAgICBzLmpzb25wQ2FsbGJhY2sgPSBvcmlnaW5hbFNldHRpbmdzLmpzb25wQ2FsbGJhY2s7CiAgICAgICAgICAvLyBzYXZlIHRoZSBjYWxsYmFjayBuYW1lIGZvciBmdXR1cmUgdXNlCiAgICAgICAgICBvbGRDYWxsYmFja3MucHVzaChjYWxsYmFja05hbWUpOwogICAgICAgIH0KICAgICAgICAvLyBDYWxsIGlmIGl0IHdhcyBhIGZ1bmN0aW9uIGFuZCB3ZSBoYXZlIGEgcmVzcG9uc2UKICAgICAgICBpZiAocmVzcG9uc2VDb250YWluZXIgJiYgalF1ZXJ5LmlzRnVuY3Rpb24ob3ZlcndyaXR0ZW4pKSB7CiAgICAgICAgICBvdmVyd3JpdHRlbihyZXNwb25zZUNvbnRhaW5lclswXSk7CiAgICAgICAgfQogICAgICAgIHJlc3BvbnNlQ29udGFpbmVyID0gb3ZlcndyaXR0ZW4gPSB1bmRlZmluZWQ7CiAgICAgIH0pOwogICAgICAvLyBEZWxlZ2F0ZSB0byBzY3JpcHQKICAgICAgcmV0dXJuICdzY3JpcHQnOwogICAgfQogIH0pOwogIC8vIGRhdGE6IHN0cmluZyBvZiBodG1sCiAgLy8gY29udGV4dCAob3B0aW9uYWwpOiBJZiBzcGVjaWZpZWQsIHRoZSBmcmFnbWVudCB3aWxsIGJlIGNyZWF0ZWQgaW4gdGhpcyBjb250ZXh0LCBkZWZhdWx0cyB0byBkb2N1bWVudAogIC8vIGtlZXBTY3JpcHRzIChvcHRpb25hbCk6IElmIHRydWUsIHdpbGwgaW5jbHVkZSBzY3JpcHRzIHBhc3NlZCBpbiB0aGUgaHRtbCBzdHJpbmcKICBqUXVlcnkucGFyc2VIVE1MID0gZnVuY3Rpb24gKGRhdGEsIGNvbnRleHQsIGtlZXBTY3JpcHRzKSB7CiAgICBpZiAoIWRhdGEgfHwgdHlwZW9mIGRhdGEgIT09ICdzdHJpbmcnKSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfQogICAgaWYgKHR5cGVvZiBjb250ZXh0ID09PSAnYm9vbGVhbicpIHsKICAgICAga2VlcFNjcmlwdHMgPSBjb250ZXh0OwogICAgICBjb250ZXh0ID0gZmFsc2U7CiAgICB9CiAgICBjb250ZXh0ID0gY29udGV4dCB8fCBkb2N1bWVudDsKICAgIHZhciBwYXJzZWQgPSByc2luZ2xlVGFnLmV4ZWMoZGF0YSksIHNjcmlwdHMgPSAha2VlcFNjcmlwdHMgJiYgW107CiAgICAvLyBTaW5nbGUgdGFnCiAgICBpZiAocGFyc2VkKSB7CiAgICAgIHJldHVybiBbY29udGV4dC5jcmVhdGVFbGVtZW50KHBhcnNlZFsxXSldOwogICAgfQogICAgcGFyc2VkID0galF1ZXJ5LmJ1aWxkRnJhZ21lbnQoW2RhdGFdLCBjb250ZXh0LCBzY3JpcHRzKTsKICAgIGlmIChzY3JpcHRzICYmIHNjcmlwdHMubGVuZ3RoKSB7CiAgICAgIGpRdWVyeShzY3JpcHRzKS5yZW1vdmUoKTsKICAgIH0KICAgIHJldHVybiBqUXVlcnkubWVyZ2UoW10sIHBhcnNlZC5jaGlsZE5vZGVzKTsKICB9OwogIC8vIEtlZXAgYSBjb3B5IG9mIHRoZSBvbGQgbG9hZCBtZXRob2QKICB2YXIgX2xvYWQgPSBqUXVlcnkuZm4ubG9hZDsKICAvKioKICAgKiBMb2FkIGEgdXJsIGludG8gYSBwYWdlCiAgICovCiAgalF1ZXJ5LmZuLmxvYWQgPSBmdW5jdGlvbiAodXJsLCBwYXJhbXMsIGNhbGxiYWNrKSB7CiAgICBpZiAodHlwZW9mIHVybCAhPT0gJ3N0cmluZycgJiYgX2xvYWQpIHsKICAgICAgcmV0dXJuIF9sb2FkLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9CiAgICB2YXIgc2VsZWN0b3IsIHR5cGUsIHJlc3BvbnNlLCBzZWxmID0gdGhpcywgb2ZmID0gdXJsLmluZGV4T2YoJyAnKTsKICAgIGlmIChvZmYgPj0gMCkgewogICAgICBzZWxlY3RvciA9IGpRdWVyeS50cmltKHVybC5zbGljZShvZmYpKTsKICAgICAgdXJsID0gdXJsLnNsaWNlKDAsIG9mZik7CiAgICB9CiAgICAvLyBJZiBpdCdzIGEgZnVuY3Rpb24KICAgIGlmIChqUXVlcnkuaXNGdW5jdGlvbihwYXJhbXMpKSB7CiAgICAgIC8vIFdlIGFzc3VtZSB0aGF0IGl0J3MgdGhlIGNhbGxiYWNrCiAgICAgIGNhbGxiYWNrID0gcGFyYW1zOwogICAgICBwYXJhbXMgPSB1bmRlZmluZWQ7ICAvLyBPdGhlcndpc2UsIGJ1aWxkIGEgcGFyYW0gc3RyaW5nCiAgICB9IGVsc2UgaWYgKHBhcmFtcyAmJiB0eXBlb2YgcGFyYW1zID09PSAnb2JqZWN0JykgewogICAgICB0eXBlID0gJ1BPU1QnOwogICAgfQogICAgLy8gSWYgd2UgaGF2ZSBlbGVtZW50cyB0byBtb2RpZnksIG1ha2UgdGhlIHJlcXVlc3QKICAgIGlmIChzZWxmLmxlbmd0aCA+IDApIHsKICAgICAgalF1ZXJ5LmFqYXgoewogICAgICAgIHVybDogdXJsLAogICAgICAgIC8vIGlmICJ0eXBlIiB2YXJpYWJsZSBpcyB1bmRlZmluZWQsIHRoZW4gIkdFVCIgbWV0aG9kIHdpbGwgYmUgdXNlZAogICAgICAgIHR5cGU6IHR5cGUsCiAgICAgICAgZGF0YVR5cGU6ICdodG1sJywKICAgICAgICBkYXRhOiBwYXJhbXMKICAgICAgfSkuZG9uZShmdW5jdGlvbiAocmVzcG9uc2VUZXh0KSB7CiAgICAgICAgLy8gU2F2ZSByZXNwb25zZSBmb3IgdXNlIGluIGNvbXBsZXRlIGNhbGxiYWNrCiAgICAgICAgcmVzcG9uc2UgPSBhcmd1bWVudHM7CiAgICAgICAgc2VsZi5odG1sKHNlbGVjdG9yID8gLy8gSWYgYSBzZWxlY3RvciB3YXMgc3BlY2lmaWVkLCBsb2NhdGUgdGhlIHJpZ2h0IGVsZW1lbnRzIGluIGEgZHVtbXkgZGl2CiAgICAgICAgLy8gRXhjbHVkZSBzY3JpcHRzIHRvIGF2b2lkIElFICdQZXJtaXNzaW9uIERlbmllZCcgZXJyb3JzCiAgICAgICAgalF1ZXJ5KCc8ZGl2PicpLmFwcGVuZChqUXVlcnkucGFyc2VIVE1MKHJlc3BvbnNlVGV4dCkpLmZpbmQoc2VsZWN0b3IpIDogLy8gT3RoZXJ3aXNlIHVzZSB0aGUgZnVsbCByZXN1bHQKICAgICAgICByZXNwb25zZVRleHQpOwogICAgICB9KS5jb21wbGV0ZShjYWxsYmFjayAmJiBmdW5jdGlvbiAoanFYSFIsIHN0YXR1cykgewogICAgICAgIHNlbGYuZWFjaChjYWxsYmFjaywgcmVzcG9uc2UgfHwgWwogICAgICAgICAganFYSFIucmVzcG9uc2VUZXh0LAogICAgICAgICAgc3RhdHVzLAogICAgICAgICAganFYSFIKICAgICAgICBdKTsKICAgICAgfSk7CiAgICB9CiAgICByZXR1cm4gdGhpczsKICB9OwogIGpRdWVyeS5leHByLmZpbHRlcnMuYW5pbWF0ZWQgPSBmdW5jdGlvbiAoZWxlbSkgewogICAgcmV0dXJuIGpRdWVyeS5ncmVwKGpRdWVyeS50aW1lcnMsIGZ1bmN0aW9uIChmbikgewogICAgICByZXR1cm4gZWxlbSA9PT0gZm4uZWxlbTsKICAgIH0pLmxlbmd0aDsKICB9OwogIHZhciBkb2NFbGVtID0gd2luZG93LmRvY3VtZW50LmRvY3VtZW50RWxlbWVudDsKICAvKioKICAgKiBHZXRzIGEgd2luZG93IGZyb20gYW4gZWxlbWVudAogICAqLwogIGZ1bmN0aW9uIGdldFdpbmRvdyhlbGVtKSB7CiAgICByZXR1cm4galF1ZXJ5LmlzV2luZG93KGVsZW0pID8gZWxlbSA6IGVsZW0ubm9kZVR5cGUgPT09IDkgJiYgZWxlbS5kZWZhdWx0VmlldzsKICB9CiAgalF1ZXJ5Lm9mZnNldCA9IHsKICAgIHNldE9mZnNldDogZnVuY3Rpb24gKGVsZW0sIG9wdGlvbnMsIGkpIHsKICAgICAgdmFyIGN1clBvc2l0aW9uLCBjdXJMZWZ0LCBjdXJDU1NUb3AsIGN1clRvcCwgY3VyT2Zmc2V0LCBjdXJDU1NMZWZ0LCBjYWxjdWxhdGVQb3NpdGlvbiwgcG9zaXRpb24gPSBqUXVlcnkuY3NzKGVsZW0sICdwb3NpdGlvbicpLCBjdXJFbGVtID0galF1ZXJ5KGVsZW0pLCBwcm9wcyA9IHt9OwogICAgICAvLyBTZXQgcG9zaXRpb24gZmlyc3QsIGluLWNhc2UgdG9wL2xlZnQgYXJlIHNldCBldmVuIG9uIHN0YXRpYyBlbGVtCiAgICAgIGlmIChwb3NpdGlvbiA9PT0gJ3N0YXRpYycpIHsKICAgICAgICBlbGVtLnN0eWxlLnBvc2l0aW9uID0gJ3JlbGF0aXZlJzsKICAgICAgfQogICAgICBjdXJPZmZzZXQgPSBjdXJFbGVtLm9mZnNldCgpOwogICAgICBjdXJDU1NUb3AgPSBqUXVlcnkuY3NzKGVsZW0sICd0b3AnKTsKICAgICAgY3VyQ1NTTGVmdCA9IGpRdWVyeS5jc3MoZWxlbSwgJ2xlZnQnKTsKICAgICAgY2FsY3VsYXRlUG9zaXRpb24gPSAocG9zaXRpb24gPT09ICdhYnNvbHV0ZScgfHwgcG9zaXRpb24gPT09ICdmaXhlZCcpICYmIChjdXJDU1NUb3AgKyBjdXJDU1NMZWZ0KS5pbmRleE9mKCdhdXRvJykgPiAtMTsKICAgICAgLy8gTmVlZCB0byBiZSBhYmxlIHRvIGNhbGN1bGF0ZSBwb3NpdGlvbiBpZiBlaXRoZXIgdG9wIG9yIGxlZnQgaXMgYXV0byBhbmQgcG9zaXRpb24gaXMgZWl0aGVyIGFic29sdXRlIG9yIGZpeGVkCiAgICAgIGlmIChjYWxjdWxhdGVQb3NpdGlvbikgewogICAgICAgIGN1clBvc2l0aW9uID0gY3VyRWxlbS5wb3NpdGlvbigpOwogICAgICAgIGN1clRvcCA9IGN1clBvc2l0aW9uLnRvcDsKICAgICAgICBjdXJMZWZ0ID0gY3VyUG9zaXRpb24ubGVmdDsKICAgICAgfSBlbHNlIHsKICAgICAgICBjdXJUb3AgPSBwYXJzZUZsb2F0KGN1ckNTU1RvcCkgfHwgMDsKICAgICAgICBjdXJMZWZ0ID0gcGFyc2VGbG9hdChjdXJDU1NMZWZ0KSB8fCAwOwogICAgICB9CiAgICAgIGlmIChqUXVlcnkuaXNGdW5jdGlvbihvcHRpb25zKSkgewogICAgICAgIG9wdGlvbnMgPSBvcHRpb25zLmNhbGwoZWxlbSwgaSwgY3VyT2Zmc2V0KTsKICAgICAgfQogICAgICBpZiAob3B0aW9ucy50b3AgIT0gbnVsbCkgewogICAgICAgIHByb3BzLnRvcCA9IG9wdGlvbnMudG9wIC0gY3VyT2Zmc2V0LnRvcCArIGN1clRvcDsKICAgICAgfQogICAgICBpZiAob3B0aW9ucy5sZWZ0ICE9IG51bGwpIHsKICAgICAgICBwcm9wcy5sZWZ0ID0gb3B0aW9ucy5sZWZ0IC0gY3VyT2Zmc2V0LmxlZnQgKyBjdXJMZWZ0OwogICAgICB9CiAgICAgIGlmICgndXNpbmcnIGluIG9wdGlvbnMpIHsKICAgICAgICBvcHRpb25zLnVzaW5nLmNhbGwoZWxlbSwgcHJvcHMpOwogICAgICB9IGVsc2UgewogICAgICAgIGN1ckVsZW0uY3NzKHByb3BzKTsKICAgICAgfQogICAgfQogIH07CiAgalF1ZXJ5LmZuLmV4dGVuZCh7CiAgICBvZmZzZXQ6IGZ1bmN0aW9uIChvcHRpb25zKSB7CiAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoKSB7CiAgICAgICAgcmV0dXJuIG9wdGlvbnMgPT09IHVuZGVmaW5lZCA/IHRoaXMgOiB0aGlzLmVhY2goZnVuY3Rpb24gKGkpIHsKICAgICAgICAgIGpRdWVyeS5vZmZzZXQuc2V0T2Zmc2V0KHRoaXMsIG9wdGlvbnMsIGkpOwogICAgICAgIH0pOwogICAgICB9CiAgICAgIHZhciBkb2NFbGVtLCB3aW4sIGVsZW0gPSB0aGlzWzBdLCBib3ggPSB7CiAgICAgICAgICB0b3A6IDAsCiAgICAgICAgICBsZWZ0OiAwCiAgICAgICAgfSwgZG9jID0gZWxlbSAmJiBlbGVtLm93bmVyRG9jdW1lbnQ7CiAgICAgIGlmICghZG9jKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIGRvY0VsZW0gPSBkb2MuZG9jdW1lbnRFbGVtZW50OwogICAgICAvLyBNYWtlIHN1cmUgaXQncyBub3QgYSBkaXNjb25uZWN0ZWQgRE9NIG5vZGUKICAgICAgaWYgKCFqUXVlcnkuY29udGFpbnMoZG9jRWxlbSwgZWxlbSkpIHsKICAgICAgICByZXR1cm4gYm94OwogICAgICB9CiAgICAgIC8vIElmIHdlIGRvbid0IGhhdmUgZ0JDUiwganVzdCB1c2UgMCwwIHJhdGhlciB0aGFuIGVycm9yCiAgICAgIC8vIEJsYWNrQmVycnkgNSwgaU9TIDMgKG9yaWdpbmFsIGlQaG9uZSkKICAgICAgaWYgKHR5cGVvZiBlbGVtLmdldEJvdW5kaW5nQ2xpZW50UmVjdCAhPT0gc3RydW5kZWZpbmVkKSB7CiAgICAgICAgYm94ID0gZWxlbS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsKICAgICAgfQogICAgICB3aW4gPSBnZXRXaW5kb3coZG9jKTsKICAgICAgcmV0dXJuIHsKICAgICAgICB0b3A6IGJveC50b3AgKyB3aW4ucGFnZVlPZmZzZXQgLSBkb2NFbGVtLmNsaWVudFRvcCwKICAgICAgICBsZWZ0OiBib3gubGVmdCArIHdpbi5wYWdlWE9mZnNldCAtIGRvY0VsZW0uY2xpZW50TGVmdAogICAgICB9OwogICAgfSwKICAgIHBvc2l0aW9uOiBmdW5jdGlvbiAoKSB7CiAgICAgIGlmICghdGhpc1swXSkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICB2YXIgb2Zmc2V0UGFyZW50LCBvZmZzZXQsIGVsZW0gPSB0aGlzWzBdLCBwYXJlbnRPZmZzZXQgPSB7CiAgICAgICAgICB0b3A6IDAsCiAgICAgICAgICBsZWZ0OiAwCiAgICAgICAgfTsKICAgICAgLy8gRml4ZWQgZWxlbWVudHMgYXJlIG9mZnNldCBmcm9tIHdpbmRvdyAocGFyZW50T2Zmc2V0ID0ge3RvcDowLCBsZWZ0OiAwfSwgYmVjYXVzZSBpdCBpcyBpdHMgb25seSBvZmZzZXQgcGFyZW50CiAgICAgIGlmIChqUXVlcnkuY3NzKGVsZW0sICdwb3NpdGlvbicpID09PSAnZml4ZWQnKSB7CiAgICAgICAgLy8gV2UgYXNzdW1lIHRoYXQgZ2V0Qm91bmRpbmdDbGllbnRSZWN0IGlzIGF2YWlsYWJsZSB3aGVuIGNvbXB1dGVkIHBvc2l0aW9uIGlzIGZpeGVkCiAgICAgICAgb2Zmc2V0ID0gZWxlbS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBHZXQgKnJlYWwqIG9mZnNldFBhcmVudAogICAgICAgIG9mZnNldFBhcmVudCA9IHRoaXMub2Zmc2V0UGFyZW50KCk7CiAgICAgICAgLy8gR2V0IGNvcnJlY3Qgb2Zmc2V0cwogICAgICAgIG9mZnNldCA9IHRoaXMub2Zmc2V0KCk7CiAgICAgICAgaWYgKCFqUXVlcnkubm9kZU5hbWUob2Zmc2V0UGFyZW50WzBdLCAnaHRtbCcpKSB7CiAgICAgICAgICBwYXJlbnRPZmZzZXQgPSBvZmZzZXRQYXJlbnQub2Zmc2V0KCk7CiAgICAgICAgfQogICAgICAgIC8vIEFkZCBvZmZzZXRQYXJlbnQgYm9yZGVycwogICAgICAgIHBhcmVudE9mZnNldC50b3AgKz0galF1ZXJ5LmNzcyhvZmZzZXRQYXJlbnRbMF0sICdib3JkZXJUb3BXaWR0aCcsIHRydWUpOwogICAgICAgIHBhcmVudE9mZnNldC5sZWZ0ICs9IGpRdWVyeS5jc3Mob2Zmc2V0UGFyZW50WzBdLCAnYm9yZGVyTGVmdFdpZHRoJywgdHJ1ZSk7CiAgICAgIH0KICAgICAgLy8gU3VidHJhY3QgcGFyZW50IG9mZnNldHMgYW5kIGVsZW1lbnQgbWFyZ2lucwogICAgICByZXR1cm4gewogICAgICAgIHRvcDogb2Zmc2V0LnRvcCAtIHBhcmVudE9mZnNldC50b3AgLSBqUXVlcnkuY3NzKGVsZW0sICdtYXJnaW5Ub3AnLCB0cnVlKSwKICAgICAgICBsZWZ0OiBvZmZzZXQubGVmdCAtIHBhcmVudE9mZnNldC5sZWZ0IC0galF1ZXJ5LmNzcyhlbGVtLCAnbWFyZ2luTGVmdCcsIHRydWUpCiAgICAgIH07CiAgICB9LAogICAgb2Zmc2V0UGFyZW50OiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiB0aGlzLm1hcChmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIG9mZnNldFBhcmVudCA9IHRoaXMub2Zmc2V0UGFyZW50IHx8IGRvY0VsZW07CiAgICAgICAgd2hpbGUgKG9mZnNldFBhcmVudCAmJiAoIWpRdWVyeS5ub2RlTmFtZShvZmZzZXRQYXJlbnQsICdodG1sJykgJiYgalF1ZXJ5LmNzcyhvZmZzZXRQYXJlbnQsICdwb3NpdGlvbicpID09PSAnc3RhdGljJykpIHsKICAgICAgICAgIG9mZnNldFBhcmVudCA9IG9mZnNldFBhcmVudC5vZmZzZXRQYXJlbnQ7CiAgICAgICAgfQogICAgICAgIHJldHVybiBvZmZzZXRQYXJlbnQgfHwgZG9jRWxlbTsKICAgICAgfSk7CiAgICB9CiAgfSk7CiAgLy8gQ3JlYXRlIHNjcm9sbExlZnQgYW5kIHNjcm9sbFRvcCBtZXRob2RzCiAgalF1ZXJ5LmVhY2goewogICAgc2Nyb2xsTGVmdDogJ3BhZ2VYT2Zmc2V0JywKICAgIHNjcm9sbFRvcDogJ3BhZ2VZT2Zmc2V0JwogIH0sIGZ1bmN0aW9uIChtZXRob2QsIHByb3ApIHsKICAgIHZhciB0b3AgPSAncGFnZVlPZmZzZXQnID09PSBwcm9wOwogICAgalF1ZXJ5LmZuW21ldGhvZF0gPSBmdW5jdGlvbiAodmFsKSB7CiAgICAgIHJldHVybiBhY2Nlc3ModGhpcywgZnVuY3Rpb24gKGVsZW0sIG1ldGhvZCwgdmFsKSB7CiAgICAgICAgdmFyIHdpbiA9IGdldFdpbmRvdyhlbGVtKTsKICAgICAgICBpZiAodmFsID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgIHJldHVybiB3aW4gPyB3aW5bcHJvcF0gOiBlbGVtW21ldGhvZF07CiAgICAgICAgfQogICAgICAgIGlmICh3aW4pIHsKICAgICAgICAgIHdpbi5zY3JvbGxUbyghdG9wID8gdmFsIDogd2luZG93LnBhZ2VYT2Zmc2V0LCB0b3AgPyB2YWwgOiB3aW5kb3cucGFnZVlPZmZzZXQpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBlbGVtW21ldGhvZF0gPSB2YWw7CiAgICAgICAgfQogICAgICB9LCBtZXRob2QsIHZhbCwgYXJndW1lbnRzLmxlbmd0aCwgbnVsbCk7CiAgICB9OwogIH0pOwogIC8vIEFkZCB0aGUgdG9wL2xlZnQgY3NzSG9va3MgdXNpbmcgalF1ZXJ5LmZuLnBvc2l0aW9uCiAgLy8gV2Via2l0IGJ1ZzogaHR0cHM6Ly9idWdzLndlYmtpdC5vcmcvc2hvd19idWcuY2dpP2lkPTI5MDg0CiAgLy8gZ2V0Q29tcHV0ZWRTdHlsZSByZXR1cm5zIHBlcmNlbnQgd2hlbiBzcGVjaWZpZWQgZm9yIHRvcC9sZWZ0L2JvdHRvbS9yaWdodAogIC8vIHJhdGhlciB0aGFuIG1ha2UgdGhlIGNzcyBtb2R1bGUgZGVwZW5kIG9uIHRoZSBvZmZzZXQgbW9kdWxlLCB3ZSBqdXN0IGNoZWNrIGZvciBpdCBoZXJlCiAgalF1ZXJ5LmVhY2goWwogICAgJ3RvcCcsCiAgICAnbGVmdCcKICBdLCBmdW5jdGlvbiAoaSwgcHJvcCkgewogICAgalF1ZXJ5LmNzc0hvb2tzW3Byb3BdID0gYWRkR2V0SG9va0lmKHN1cHBvcnQucGl4ZWxQb3NpdGlvbiwgZnVuY3Rpb24gKGVsZW0sIGNvbXB1dGVkKSB7CiAgICAgIGlmIChjb21wdXRlZCkgewogICAgICAgIGNvbXB1dGVkID0gY3VyQ1NTKGVsZW0sIHByb3ApOwogICAgICAgIC8vIGlmIGN1ckNTUyByZXR1cm5zIHBlcmNlbnRhZ2UsIGZhbGxiYWNrIHRvIG9mZnNldAogICAgICAgIHJldHVybiBybnVtbm9ucHgudGVzdChjb21wdXRlZCkgPyBqUXVlcnkoZWxlbSkucG9zaXRpb24oKVtwcm9wXSArICdweCcgOiBjb21wdXRlZDsKICAgICAgfQogICAgfSk7CiAgfSk7CiAgLy8gQ3JlYXRlIGlubmVySGVpZ2h0LCBpbm5lcldpZHRoLCBoZWlnaHQsIHdpZHRoLCBvdXRlckhlaWdodCBhbmQgb3V0ZXJXaWR0aCBtZXRob2RzCiAgalF1ZXJ5LmVhY2goewogICAgSGVpZ2h0OiAnaGVpZ2h0JywKICAgIFdpZHRoOiAnd2lkdGgnCiAgfSwgZnVuY3Rpb24gKG5hbWUsIHR5cGUpIHsKICAgIGpRdWVyeS5lYWNoKHsKICAgICAgcGFkZGluZzogJ2lubmVyJyArIG5hbWUsCiAgICAgIGNvbnRlbnQ6IHR5cGUsCiAgICAgICcnOiAnb3V0ZXInICsgbmFtZQogICAgfSwgZnVuY3Rpb24gKGRlZmF1bHRFeHRyYSwgZnVuY05hbWUpIHsKICAgICAgLy8gbWFyZ2luIGlzIG9ubHkgZm9yIG91dGVySGVpZ2h0LCBvdXRlcldpZHRoCiAgICAgIGpRdWVyeS5mbltmdW5jTmFtZV0gPSBmdW5jdGlvbiAobWFyZ2luLCB2YWx1ZSkgewogICAgICAgIHZhciBjaGFpbmFibGUgPSBhcmd1bWVudHMubGVuZ3RoICYmIChkZWZhdWx0RXh0cmEgfHwgdHlwZW9mIG1hcmdpbiAhPT0gJ2Jvb2xlYW4nKSwgZXh0cmEgPSBkZWZhdWx0RXh0cmEgfHwgKG1hcmdpbiA9PT0gdHJ1ZSB8fCB2YWx1ZSA9PT0gdHJ1ZSA/ICdtYXJnaW4nIDogJ2JvcmRlcicpOwogICAgICAgIHJldHVybiBhY2Nlc3ModGhpcywgZnVuY3Rpb24gKGVsZW0sIHR5cGUsIHZhbHVlKSB7CiAgICAgICAgICB2YXIgZG9jOwogICAgICAgICAgaWYgKGpRdWVyeS5pc1dpbmRvdyhlbGVtKSkgewogICAgICAgICAgICAvLyBBcyBvZiA1LzgvMjAxMiB0aGlzIHdpbGwgeWllbGQgaW5jb3JyZWN0IHJlc3VsdHMgZm9yIE1vYmlsZSBTYWZhcmksIGJ1dCB0aGVyZQogICAgICAgICAgICAvLyBpc24ndCBhIHdob2xlIGxvdCB3ZSBjYW4gZG8uIFNlZSBwdWxsIHJlcXVlc3QgYXQgdGhpcyBVUkwgZm9yIGRpc2N1c3Npb246CiAgICAgICAgICAgIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5L3B1bGwvNzY0CiAgICAgICAgICAgIHJldHVybiBlbGVtLmRvY3VtZW50LmRvY3VtZW50RWxlbWVudFsnY2xpZW50JyArIG5hbWVdOwogICAgICAgICAgfQogICAgICAgICAgLy8gR2V0IGRvY3VtZW50IHdpZHRoIG9yIGhlaWdodAogICAgICAgICAgaWYgKGVsZW0ubm9kZVR5cGUgPT09IDkpIHsKICAgICAgICAgICAgZG9jID0gZWxlbS5kb2N1bWVudEVsZW1lbnQ7CiAgICAgICAgICAgIC8vIEVpdGhlciBzY3JvbGxbV2lkdGgvSGVpZ2h0XSBvciBvZmZzZXRbV2lkdGgvSGVpZ2h0XSBvciBjbGllbnRbV2lkdGgvSGVpZ2h0XSwKICAgICAgICAgICAgLy8gd2hpY2hldmVyIGlzIGdyZWF0ZXN0CiAgICAgICAgICAgIHJldHVybiBNYXRoLm1heChlbGVtLmJvZHlbJ3Njcm9sbCcgKyBuYW1lXSwgZG9jWydzY3JvbGwnICsgbmFtZV0sIGVsZW0uYm9keVsnb2Zmc2V0JyArIG5hbWVdLCBkb2NbJ29mZnNldCcgKyBuYW1lXSwgZG9jWydjbGllbnQnICsgbmFtZV0pOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHZhbHVlID09PSB1bmRlZmluZWQgPyAvLyBHZXQgd2lkdGggb3IgaGVpZ2h0IG9uIHRoZSBlbGVtZW50LCByZXF1ZXN0aW5nIGJ1dCBub3QgZm9yY2luZyBwYXJzZUZsb2F0CiAgICAgICAgICBqUXVlcnkuY3NzKGVsZW0sIHR5cGUsIGV4dHJhKSA6IC8vIFNldCB3aWR0aCBvciBoZWlnaHQgb24gdGhlIGVsZW1lbnQKICAgICAgICAgIGpRdWVyeS5zdHlsZShlbGVtLCB0eXBlLCB2YWx1ZSwgZXh0cmEpOwogICAgICAgIH0sIHR5cGUsIGNoYWluYWJsZSA/IG1hcmdpbiA6IHVuZGVmaW5lZCwgY2hhaW5hYmxlLCBudWxsKTsKICAgICAgfTsKICAgIH0pOwogIH0pOwogIC8vIFRoZSBudW1iZXIgb2YgZWxlbWVudHMgY29udGFpbmVkIGluIHRoZSBtYXRjaGVkIGVsZW1lbnQgc2V0CiAgalF1ZXJ5LmZuLnNpemUgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5sZW5ndGg7CiAgfTsKICBqUXVlcnkuZm4uYW5kU2VsZiA9IGpRdWVyeS5mbi5hZGRCYWNrOwogIC8vIFJlZ2lzdGVyIGFzIGEgbmFtZWQgQU1EIG1vZHVsZSwgc2luY2UgalF1ZXJ5IGNhbiBiZSBjb25jYXRlbmF0ZWQgd2l0aCBvdGhlcgogIC8vIGZpbGVzIHRoYXQgbWF5IHVzZSBkZWZpbmUsIGJ1dCBub3QgdmlhIGEgcHJvcGVyIGNvbmNhdGVuYXRpb24gc2NyaXB0IHRoYXQKICAvLyB1bmRlcnN0YW5kcyBhbm9ueW1vdXMgQU1EIG1vZHVsZXMuIEEgbmFtZWQgQU1EIGlzIHNhZmVzdCBhbmQgbW9zdCByb2J1c3QKICAvLyB3YXkgdG8gcmVnaXN0ZXIuIExvd2VyY2FzZSBqcXVlcnkgaXMgdXNlZCBiZWNhdXNlIEFNRCBtb2R1bGUgbmFtZXMgYXJlCiAgLy8gZGVyaXZlZCBmcm9tIGZpbGUgbmFtZXMsIGFuZCBqUXVlcnkgaXMgbm9ybWFsbHkgZGVsaXZlcmVkIGluIGEgbG93ZXJjYXNlCiAgLy8gZmlsZSBuYW1lLiBEbyB0aGlzIGFmdGVyIGNyZWF0aW5nIHRoZSBnbG9iYWwgc28gdGhhdCBpZiBhbiBBTUQgbW9kdWxlIHdhbnRzCiAgLy8gdG8gY2FsbCBub0NvbmZsaWN0IHRvIGhpZGUgdGhpcyB2ZXJzaW9uIG9mIGpRdWVyeSwgaXQgd2lsbCB3b3JrLgogIC8vIE5vdGUgdGhhdCBmb3IgbWF4aW11bSBwb3J0YWJpbGl0eSwgbGlicmFyaWVzIHRoYXQgYXJlIG5vdCBqUXVlcnkgc2hvdWxkCiAgLy8gZGVjbGFyZSB0aGVtc2VsdmVzIGFzIGFub255bW91cyBtb2R1bGVzLCBhbmQgYXZvaWQgc2V0dGluZyBhIGdsb2JhbCBpZiBhbgogIC8vIEFNRCBsb2FkZXIgaXMgcHJlc2VudC4galF1ZXJ5IGlzIGEgc3BlY2lhbCBjYXNlLiBGb3IgbW9yZSBpbmZvcm1hdGlvbiwgc2VlCiAgLy8gaHR0cHM6Ly9naXRodWIuY29tL2pyYnVya2UvcmVxdWlyZWpzL3dpa2kvVXBkYXRpbmctZXhpc3RpbmctbGlicmFyaWVzI3dpa2ktYW5vbgogIGlmICh0cnVlKSB7CiAgICBqcXVlcnkgPSBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBqUXVlcnk7CiAgICB9KCk7CiAgfQogIHZhcgogICAgLy8gTWFwIG92ZXIgalF1ZXJ5IGluIGNhc2Ugb2Ygb3ZlcndyaXRlCiAgICBfalF1ZXJ5ID0gd2luZG93LmpRdWVyeSwKICAgIC8vIE1hcCBvdmVyIHRoZSAkIGluIGNhc2Ugb2Ygb3ZlcndyaXRlCiAgICBfJCA9IHdpbmRvdy4kOwogIGpRdWVyeS5ub0NvbmZsaWN0ID0gZnVuY3Rpb24gKGRlZXApIHsKICAgIGlmICh3aW5kb3cuJCA9PT0galF1ZXJ5KSB7CiAgICAgIHdpbmRvdy4kID0gXyQ7CiAgICB9CiAgICBpZiAoZGVlcCAmJiB3aW5kb3cualF1ZXJ5ID09PSBqUXVlcnkpIHsKICAgICAgd2luZG93LmpRdWVyeSA9IF9qUXVlcnk7CiAgICB9CiAgICByZXR1cm4galF1ZXJ5OwogIH07CiAgLy8gRXhwb3NlIGpRdWVyeSBhbmQgJCBpZGVudGlmaWVycywgZXZlbiBpbgogIC8vIEFNRCAoIzcxMDIjY29tbWVudDoxMCwgaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnkvcHVsbC81NTcpCiAgLy8gYW5kIENvbW1vbkpTIGZvciBicm93c2VyIGVtdWxhdG9ycyAoIzEzNTY2KQogIGlmICh0eXBlb2Ygbm9HbG9iYWwgPT09IHN0cnVuZGVmaW5lZCkgewogICAgd2luZG93LmpRdWVyeSA9IHdpbmRvdy4kID0galF1ZXJ5OwogIH0KICByZXR1cm4galF1ZXJ5Owp9KSk7Ci8vICAgICBCYWNrYm9uZS5qcyAxLjEuMgovLyAgICAgKGMpIDIwMTAtMjAxNCBKZXJlbXkgQXNoa2VuYXMsIERvY3VtZW50Q2xvdWQgYW5kIEludmVzdGlnYXRpdmUgUmVwb3J0ZXJzICYgRWRpdG9ycwovLyAgICAgQmFja2JvbmUgbWF5IGJlIGZyZWVseSBkaXN0cmlidXRlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuCi8vICAgICBGb3IgYWxsIGRldGFpbHMgYW5kIGRvY3VtZW50YXRpb246Ci8vICAgICBodHRwOi8vYmFja2JvbmVqcy5vcmcKKGZ1bmN0aW9uIChyb290LCBmYWN0b3J5KSB7CiAgLy8gU2V0IHVwIEJhY2tib25lIGFwcHJvcHJpYXRlbHkgZm9yIHRoZSBlbnZpcm9ubWVudC4gU3RhcnQgd2l0aCBBTUQuCiAgaWYgKHRydWUpIHsKICAgIGJhY2tib25lID0gZnVuY3Rpb24gKF8sICQsIGV4cG9ydHMpIHsKICAgICAgLy8gRXhwb3J0IGdsb2JhbCBldmVuIGluIEFNRCBjYXNlIGluIGNhc2UgdGhpcyBzY3JpcHQgaXMgbG9hZGVkIHdpdGgKICAgICAgLy8gb3RoZXJzIHRoYXQgbWF5IHN0aWxsIGV4cGVjdCBhIGdsb2JhbCBCYWNrYm9uZS4KICAgICAgcm9vdC5CYWNrYm9uZSA9IGZhY3Rvcnkocm9vdCwgZXhwb3J0cywgXywgJCk7CiAgICAgIHJldHVybiBleHBvcnRzOwogICAgfSh1bmRlcnNjb3JlLCBqcXVlcnksIHt9KTsKICB9IGVsc2UgaWYgKHR5cGVvZiBleHBvcnRzICE9PSAndW5kZWZpbmVkJykgewogICAgdmFyIF8gPSB1bmRlcnNjb3JlOwogICAgZmFjdG9yeShyb290LCBleHBvcnRzLCBfKTsKICB9IGVsc2UgewogICAgcm9vdC5CYWNrYm9uZSA9IGZhY3Rvcnkocm9vdCwge30sIHJvb3QuXywgcm9vdC5qUXVlcnkgfHwgcm9vdC5aZXB0byB8fCByb290LmVuZGVyIHx8IHJvb3QuJCk7CiAgfQp9KHRoaXMsIGZ1bmN0aW9uIChyb290LCBCYWNrYm9uZSwgXywgJCkgewogIC8vIEluaXRpYWwgU2V0dXAKICAvLyAtLS0tLS0tLS0tLS0tCiAgLy8gU2F2ZSB0aGUgcHJldmlvdXMgdmFsdWUgb2YgdGhlIGBCYWNrYm9uZWAgdmFyaWFibGUsIHNvIHRoYXQgaXQgY2FuIGJlCiAgLy8gcmVzdG9yZWQgbGF0ZXIgb24sIGlmIGBub0NvbmZsaWN0YCBpcyB1c2VkLgogIHZhciBwcmV2aW91c0JhY2tib25lID0gcm9vdC5CYWNrYm9uZTsKICAvLyBDcmVhdGUgbG9jYWwgcmVmZXJlbmNlcyB0byBhcnJheSBtZXRob2RzIHdlJ2xsIHdhbnQgdG8gdXNlIGxhdGVyLgogIHZhciBhcnJheSA9IFtdOwogIHZhciBwdXNoID0gYXJyYXkucHVzaDsKICB2YXIgc2xpY2UgPSBhcnJheS5zbGljZTsKICB2YXIgc3BsaWNlID0gYXJyYXkuc3BsaWNlOwogIC8vIEN1cnJlbnQgdmVyc2lvbiBvZiB0aGUgbGlicmFyeS4gS2VlcCBpbiBzeW5jIHdpdGggYHBhY2thZ2UuanNvbmAuCiAgQmFja2JvbmUuVkVSU0lPTiA9ICcxLjEuMic7CiAgLy8gRm9yIEJhY2tib25lJ3MgcHVycG9zZXMsIGpRdWVyeSwgWmVwdG8sIEVuZGVyLCBvciBNeSBMaWJyYXJ5IChraWRkaW5nKSBvd25zCiAgLy8gdGhlIGAkYCB2YXJpYWJsZS4KICBCYWNrYm9uZS4kID0gJDsKICAvLyBSdW5zIEJhY2tib25lLmpzIGluICpub0NvbmZsaWN0KiBtb2RlLCByZXR1cm5pbmcgdGhlIGBCYWNrYm9uZWAgdmFyaWFibGUKICAvLyB0byBpdHMgcHJldmlvdXMgb3duZXIuIFJldHVybnMgYSByZWZlcmVuY2UgdG8gdGhpcyBCYWNrYm9uZSBvYmplY3QuCiAgQmFja2JvbmUubm9Db25mbGljdCA9IGZ1bmN0aW9uICgpIHsKICAgIHJvb3QuQmFja2JvbmUgPSBwcmV2aW91c0JhY2tib25lOwogICAgcmV0dXJuIHRoaXM7CiAgfTsKICAvLyBUdXJuIG9uIGBlbXVsYXRlSFRUUGAgdG8gc3VwcG9ydCBsZWdhY3kgSFRUUCBzZXJ2ZXJzLiBTZXR0aW5nIHRoaXMgb3B0aW9uCiAgLy8gd2lsbCBmYWtlIGAiUEFUQ0giYCwgYCJQVVQiYCBhbmQgYCJERUxFVEUiYCByZXF1ZXN0cyB2aWEgdGhlIGBfbWV0aG9kYCBwYXJhbWV0ZXIgYW5kCiAgLy8gc2V0IGEgYFgtSHR0cC1NZXRob2QtT3ZlcnJpZGVgIGhlYWRlci4KICBCYWNrYm9uZS5lbXVsYXRlSFRUUCA9IGZhbHNlOwogIC8vIFR1cm4gb24gYGVtdWxhdGVKU09OYCB0byBzdXBwb3J0IGxlZ2FjeSBzZXJ2ZXJzIHRoYXQgY2FuJ3QgZGVhbCB3aXRoIGRpcmVjdAogIC8vIGBhcHBsaWNhdGlvbi9qc29uYCByZXF1ZXN0cyAuLi4gd2lsbCBlbmNvZGUgdGhlIGJvZHkgYXMKICAvLyBgYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkYCBpbnN0ZWFkIGFuZCB3aWxsIHNlbmQgdGhlIG1vZGVsIGluIGEKICAvLyBmb3JtIHBhcmFtIG5hbWVkIGBtb2RlbGAuCiAgQmFja2JvbmUuZW11bGF0ZUpTT04gPSBmYWxzZTsKICAvLyBCYWNrYm9uZS5FdmVudHMKICAvLyAtLS0tLS0tLS0tLS0tLS0KICAvLyBBIG1vZHVsZSB0aGF0IGNhbiBiZSBtaXhlZCBpbiB0byAqYW55IG9iamVjdCogaW4gb3JkZXIgdG8gcHJvdmlkZSBpdCB3aXRoCiAgLy8gY3VzdG9tIGV2ZW50cy4gWW91IG1heSBiaW5kIHdpdGggYG9uYCBvciByZW1vdmUgd2l0aCBgb2ZmYCBjYWxsYmFjawogIC8vIGZ1bmN0aW9ucyB0byBhbiBldmVudDsgYHRyaWdnZXJgLWluZyBhbiBldmVudCBmaXJlcyBhbGwgY2FsbGJhY2tzIGluCiAgLy8gc3VjY2Vzc2lvbi4KICAvLwogIC8vICAgICB2YXIgb2JqZWN0ID0ge307CiAgLy8gICAgIF8uZXh0ZW5kKG9iamVjdCwgQmFja2JvbmUuRXZlbnRzKTsKICAvLyAgICAgb2JqZWN0Lm9uKCdleHBhbmQnLCBmdW5jdGlvbigpeyBhbGVydCgnZXhwYW5kZWQnKTsgfSk7CiAgLy8gICAgIG9iamVjdC50cmlnZ2VyKCdleHBhbmQnKTsKICAvLwogIHZhciBFdmVudHMgPSBCYWNrYm9uZS5FdmVudHMgPSB7CiAgICAvLyBCaW5kIGFuIGV2ZW50IHRvIGEgYGNhbGxiYWNrYCBmdW5jdGlvbi4gUGFzc2luZyBgImFsbCJgIHdpbGwgYmluZAogICAgLy8gdGhlIGNhbGxiYWNrIHRvIGFsbCBldmVudHMgZmlyZWQuCiAgICBvbjogZnVuY3Rpb24gKG5hbWUsIGNhbGxiYWNrLCBjb250ZXh0KSB7CiAgICAgIGlmICghZXZlbnRzQXBpKHRoaXMsICdvbicsIG5hbWUsIFsKICAgICAgICAgIGNhbGxiYWNrLAogICAgICAgICAgY29udGV4dAogICAgICAgIF0pIHx8ICFjYWxsYmFjaykKICAgICAgICByZXR1cm4gdGhpczsKICAgICAgdGhpcy5fZXZlbnRzIHx8ICh0aGlzLl9ldmVudHMgPSB7fSk7CiAgICAgIHZhciBldmVudHMgPSB0aGlzLl9ldmVudHNbbmFtZV0gfHwgKHRoaXMuX2V2ZW50c1tuYW1lXSA9IFtdKTsKICAgICAgZXZlbnRzLnB1c2goewogICAgICAgIGNhbGxiYWNrOiBjYWxsYmFjaywKICAgICAgICBjb250ZXh0OiBjb250ZXh0LAogICAgICAgIGN0eDogY29udGV4dCB8fCB0aGlzCiAgICAgIH0pOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgICAvLyBCaW5kIGFuIGV2ZW50IHRvIG9ubHkgYmUgdHJpZ2dlcmVkIGEgc2luZ2xlIHRpbWUuIEFmdGVyIHRoZSBmaXJzdCB0aW1lCiAgICAvLyB0aGUgY2FsbGJhY2sgaXMgaW52b2tlZCwgaXQgd2lsbCBiZSByZW1vdmVkLgogICAgb25jZTogZnVuY3Rpb24gKG5hbWUsIGNhbGxiYWNrLCBjb250ZXh0KSB7CiAgICAgIGlmICghZXZlbnRzQXBpKHRoaXMsICdvbmNlJywgbmFtZSwgWwogICAgICAgICAgY2FsbGJhY2ssCiAgICAgICAgICBjb250ZXh0CiAgICAgICAgXSkgfHwgIWNhbGxiYWNrKQogICAgICAgIHJldHVybiB0aGlzOwogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIHZhciBvbmNlID0gXy5vbmNlKGZ1bmN0aW9uICgpIHsKICAgICAgICBzZWxmLm9mZihuYW1lLCBvbmNlKTsKICAgICAgICBjYWxsYmFjay5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9KTsKICAgICAgb25jZS5fY2FsbGJhY2sgPSBjYWxsYmFjazsKICAgICAgcmV0dXJuIHRoaXMub24obmFtZSwgb25jZSwgY29udGV4dCk7CiAgICB9LAogICAgLy8gUmVtb3ZlIG9uZSBvciBtYW55IGNhbGxiYWNrcy4gSWYgYGNvbnRleHRgIGlzIG51bGwsIHJlbW92ZXMgYWxsCiAgICAvLyBjYWxsYmFja3Mgd2l0aCB0aGF0IGZ1bmN0aW9uLiBJZiBgY2FsbGJhY2tgIGlzIG51bGwsIHJlbW92ZXMgYWxsCiAgICAvLyBjYWxsYmFja3MgZm9yIHRoZSBldmVudC4gSWYgYG5hbWVgIGlzIG51bGwsIHJlbW92ZXMgYWxsIGJvdW5kCiAgICAvLyBjYWxsYmFja3MgZm9yIGFsbCBldmVudHMuCiAgICBvZmY6IGZ1bmN0aW9uIChuYW1lLCBjYWxsYmFjaywgY29udGV4dCkgewogICAgICB2YXIgcmV0YWluLCBldiwgZXZlbnRzLCBuYW1lcywgaSwgbCwgaiwgazsKICAgICAgaWYgKCF0aGlzLl9ldmVudHMgfHwgIWV2ZW50c0FwaSh0aGlzLCAnb2ZmJywgbmFtZSwgWwogICAgICAgICAgY2FsbGJhY2ssCiAgICAgICAgICBjb250ZXh0CiAgICAgICAgXSkpCiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgIGlmICghbmFtZSAmJiAhY2FsbGJhY2sgJiYgIWNvbnRleHQpIHsKICAgICAgICB0aGlzLl9ldmVudHMgPSB2b2lkIDA7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgIH0KICAgICAgbmFtZXMgPSBuYW1lID8gW25hbWVdIDogXy5rZXlzKHRoaXMuX2V2ZW50cyk7CiAgICAgIGZvciAoaSA9IDAsIGwgPSBuYW1lcy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICBuYW1lID0gbmFtZXNbaV07CiAgICAgICAgaWYgKGV2ZW50cyA9IHRoaXMuX2V2ZW50c1tuYW1lXSkgewogICAgICAgICAgdGhpcy5fZXZlbnRzW25hbWVdID0gcmV0YWluID0gW107CiAgICAgICAgICBpZiAoY2FsbGJhY2sgfHwgY29udGV4dCkgewogICAgICAgICAgICBmb3IgKGogPSAwLCBrID0gZXZlbnRzLmxlbmd0aDsgaiA8IGs7IGorKykgewogICAgICAgICAgICAgIGV2ID0gZXZlbnRzW2pdOwogICAgICAgICAgICAgIGlmIChjYWxsYmFjayAmJiBjYWxsYmFjayAhPT0gZXYuY2FsbGJhY2sgJiYgY2FsbGJhY2sgIT09IGV2LmNhbGxiYWNrLl9jYWxsYmFjayB8fCBjb250ZXh0ICYmIGNvbnRleHQgIT09IGV2LmNvbnRleHQpIHsKICAgICAgICAgICAgICAgIHJldGFpbi5wdXNoKGV2KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICghcmV0YWluLmxlbmd0aCkKICAgICAgICAgICAgZGVsZXRlIHRoaXMuX2V2ZW50c1tuYW1lXTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogICAgLy8gVHJpZ2dlciBvbmUgb3IgbWFueSBldmVudHMsIGZpcmluZyBhbGwgYm91bmQgY2FsbGJhY2tzLiBDYWxsYmFja3MgYXJlCiAgICAvLyBwYXNzZWQgdGhlIHNhbWUgYXJndW1lbnRzIGFzIGB0cmlnZ2VyYCBpcywgYXBhcnQgZnJvbSB0aGUgZXZlbnQgbmFtZQogICAgLy8gKHVubGVzcyB5b3UncmUgbGlzdGVuaW5nIG9uIGAiYWxsImAsIHdoaWNoIHdpbGwgY2F1c2UgeW91ciBjYWxsYmFjayB0bwogICAgLy8gcmVjZWl2ZSB0aGUgdHJ1ZSBuYW1lIG9mIHRoZSBldmVudCBhcyB0aGUgZmlyc3QgYXJndW1lbnQpLgogICAgdHJpZ2dlcjogZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgaWYgKCF0aGlzLl9ldmVudHMpCiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwogICAgICBpZiAoIWV2ZW50c0FwaSh0aGlzLCAndHJpZ2dlcicsIG5hbWUsIGFyZ3MpKQogICAgICAgIHJldHVybiB0aGlzOwogICAgICB2YXIgZXZlbnRzID0gdGhpcy5fZXZlbnRzW25hbWVdOwogICAgICB2YXIgYWxsRXZlbnRzID0gdGhpcy5fZXZlbnRzLmFsbDsKICAgICAgaWYgKGV2ZW50cykKICAgICAgICB0cmlnZ2VyRXZlbnRzKGV2ZW50cywgYXJncyk7CiAgICAgIGlmIChhbGxFdmVudHMpCiAgICAgICAgdHJpZ2dlckV2ZW50cyhhbGxFdmVudHMsIGFyZ3VtZW50cyk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAgIC8vIFRlbGwgdGhpcyBvYmplY3QgdG8gc3RvcCBsaXN0ZW5pbmcgdG8gZWl0aGVyIHNwZWNpZmljIGV2ZW50cyAuLi4gb3IKICAgIC8vIHRvIGV2ZXJ5IG9iamVjdCBpdCdzIGN1cnJlbnRseSBsaXN0ZW5pbmcgdG8uCiAgICBzdG9wTGlzdGVuaW5nOiBmdW5jdGlvbiAob2JqLCBuYW1lLCBjYWxsYmFjaykgewogICAgICB2YXIgbGlzdGVuaW5nVG8gPSB0aGlzLl9saXN0ZW5pbmdUbzsKICAgICAgaWYgKCFsaXN0ZW5pbmdUbykKICAgICAgICByZXR1cm4gdGhpczsKICAgICAgdmFyIHJlbW92ZSA9ICFuYW1lICYmICFjYWxsYmFjazsKICAgICAgaWYgKCFjYWxsYmFjayAmJiB0eXBlb2YgbmFtZSA9PT0gJ29iamVjdCcpCiAgICAgICAgY2FsbGJhY2sgPSB0aGlzOwogICAgICBpZiAob2JqKQogICAgICAgIChsaXN0ZW5pbmdUbyA9IHt9KVtvYmouX2xpc3RlbklkXSA9IG9iajsKICAgICAgZm9yICh2YXIgaWQgaW4gbGlzdGVuaW5nVG8pIHsKICAgICAgICBvYmogPSBsaXN0ZW5pbmdUb1tpZF07CiAgICAgICAgb2JqLm9mZihuYW1lLCBjYWxsYmFjaywgdGhpcyk7CiAgICAgICAgaWYgKHJlbW92ZSB8fCBfLmlzRW1wdHkob2JqLl9ldmVudHMpKQogICAgICAgICAgZGVsZXRlIHRoaXMuX2xpc3RlbmluZ1RvW2lkXTsKICAgICAgfQogICAgICByZXR1cm4gdGhpczsKICAgIH0KICB9OwogIC8vIFJlZ3VsYXIgZXhwcmVzc2lvbiB1c2VkIHRvIHNwbGl0IGV2ZW50IHN0cmluZ3MuCiAgdmFyIGV2ZW50U3BsaXR0ZXIgPSAvXHMrLzsKICAvLyBJbXBsZW1lbnQgZmFuY3kgZmVhdHVyZXMgb2YgdGhlIEV2ZW50cyBBUEkgc3VjaCBhcyBtdWx0aXBsZSBldmVudAogIC8vIG5hbWVzIGAiY2hhbmdlIGJsdXIiYCBhbmQgalF1ZXJ5LXN0eWxlIGV2ZW50IG1hcHMgYHtjaGFuZ2U6IGFjdGlvbn1gCiAgLy8gaW4gdGVybXMgb2YgdGhlIGV4aXN0aW5nIEFQSS4KICB2YXIgZXZlbnRzQXBpID0gZnVuY3Rpb24gKG9iaiwgYWN0aW9uLCBuYW1lLCByZXN0KSB7CiAgICBpZiAoIW5hbWUpCiAgICAgIHJldHVybiB0cnVlOwogICAgLy8gSGFuZGxlIGV2ZW50IG1hcHMuCiAgICBpZiAodHlwZW9mIG5hbWUgPT09ICdvYmplY3QnKSB7CiAgICAgIGZvciAodmFyIGtleSBpbiBuYW1lKSB7CiAgICAgICAgb2JqW2FjdGlvbl0uYXBwbHkob2JqLCBbCiAgICAgICAgICBrZXksCiAgICAgICAgICBuYW1lW2tleV0KICAgICAgICBdLmNvbmNhdChyZXN0KSk7CiAgICAgIH0KICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgLy8gSGFuZGxlIHNwYWNlIHNlcGFyYXRlZCBldmVudCBuYW1lcy4KICAgIGlmIChldmVudFNwbGl0dGVyLnRlc3QobmFtZSkpIHsKICAgICAgdmFyIG5hbWVzID0gbmFtZS5zcGxpdChldmVudFNwbGl0dGVyKTsKICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSBuYW1lcy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICBvYmpbYWN0aW9uXS5hcHBseShvYmosIFtuYW1lc1tpXV0uY29uY2F0KHJlc3QpKTsKICAgICAgfQogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICByZXR1cm4gdHJ1ZTsKICB9OwogIC8vIEEgZGlmZmljdWx0LXRvLWJlbGlldmUsIGJ1dCBvcHRpbWl6ZWQgaW50ZXJuYWwgZGlzcGF0Y2ggZnVuY3Rpb24gZm9yCiAgLy8gdHJpZ2dlcmluZyBldmVudHMuIFRyaWVzIHRvIGtlZXAgdGhlIHVzdWFsIGNhc2VzIHNwZWVkeSAobW9zdCBpbnRlcm5hbAogIC8vIEJhY2tib25lIGV2ZW50cyBoYXZlIDMgYXJndW1lbnRzKS4KICB2YXIgdHJpZ2dlckV2ZW50cyA9IGZ1bmN0aW9uIChldmVudHMsIGFyZ3MpIHsKICAgIHZhciBldiwgaSA9IC0xLCBsID0gZXZlbnRzLmxlbmd0aCwgYTEgPSBhcmdzWzBdLCBhMiA9IGFyZ3NbMV0sIGEzID0gYXJnc1syXTsKICAgIHN3aXRjaCAoYXJncy5sZW5ndGgpIHsKICAgIGNhc2UgMDoKICAgICAgd2hpbGUgKCsraSA8IGwpCiAgICAgICAgKGV2ID0gZXZlbnRzW2ldKS5jYWxsYmFjay5jYWxsKGV2LmN0eCk7CiAgICAgIHJldHVybjsKICAgIGNhc2UgMToKICAgICAgd2hpbGUgKCsraSA8IGwpCiAgICAgICAgKGV2ID0gZXZlbnRzW2ldKS5jYWxsYmFjay5jYWxsKGV2LmN0eCwgYTEpOwogICAgICByZXR1cm47CiAgICBjYXNlIDI6CiAgICAgIHdoaWxlICgrK2kgPCBsKQogICAgICAgIChldiA9IGV2ZW50c1tpXSkuY2FsbGJhY2suY2FsbChldi5jdHgsIGExLCBhMik7CiAgICAgIHJldHVybjsKICAgIGNhc2UgMzoKICAgICAgd2hpbGUgKCsraSA8IGwpCiAgICAgICAgKGV2ID0gZXZlbnRzW2ldKS5jYWxsYmFjay5jYWxsKGV2LmN0eCwgYTEsIGEyLCBhMyk7CiAgICAgIHJldHVybjsKICAgIGRlZmF1bHQ6CiAgICAgIHdoaWxlICgrK2kgPCBsKQogICAgICAgIChldiA9IGV2ZW50c1tpXSkuY2FsbGJhY2suYXBwbHkoZXYuY3R4LCBhcmdzKTsKICAgICAgcmV0dXJuOwogICAgfQogIH07CiAgdmFyIGxpc3Rlbk1ldGhvZHMgPSB7CiAgICBsaXN0ZW5UbzogJ29uJywKICAgIGxpc3RlblRvT25jZTogJ29uY2UnCiAgfTsKICAvLyBJbnZlcnNpb24tb2YtY29udHJvbCB2ZXJzaW9ucyBvZiBgb25gIGFuZCBgb25jZWAuIFRlbGwgKnRoaXMqIG9iamVjdCB0bwogIC8vIGxpc3RlbiB0byBhbiBldmVudCBpbiBhbm90aGVyIG9iamVjdCAuLi4ga2VlcGluZyB0cmFjayBvZiB3aGF0IGl0J3MKICAvLyBsaXN0ZW5pbmcgdG8uCiAgXy5lYWNoKGxpc3Rlbk1ldGhvZHMsIGZ1bmN0aW9uIChpbXBsZW1lbnRhdGlvbiwgbWV0aG9kKSB7CiAgICBFdmVudHNbbWV0aG9kXSA9IGZ1bmN0aW9uIChvYmosIG5hbWUsIGNhbGxiYWNrKSB7CiAgICAgIHZhciBsaXN0ZW5pbmdUbyA9IHRoaXMuX2xpc3RlbmluZ1RvIHx8ICh0aGlzLl9saXN0ZW5pbmdUbyA9IHt9KTsKICAgICAgdmFyIGlkID0gb2JqLl9saXN0ZW5JZCB8fCAob2JqLl9saXN0ZW5JZCA9IF8udW5pcXVlSWQoJ2wnKSk7CiAgICAgIGxpc3RlbmluZ1RvW2lkXSA9IG9iajsKICAgICAgaWYgKCFjYWxsYmFjayAmJiB0eXBlb2YgbmFtZSA9PT0gJ29iamVjdCcpCiAgICAgICAgY2FsbGJhY2sgPSB0aGlzOwogICAgICBvYmpbaW1wbGVtZW50YXRpb25dKG5hbWUsIGNhbGxiYWNrLCB0aGlzKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9OwogIH0pOwogIC8vIEFsaWFzZXMgZm9yIGJhY2t3YXJkcyBjb21wYXRpYmlsaXR5LgogIEV2ZW50cy5iaW5kID0gRXZlbnRzLm9uOwogIEV2ZW50cy51bmJpbmQgPSBFdmVudHMub2ZmOwogIC8vIEFsbG93IHRoZSBgQmFja2JvbmVgIG9iamVjdCB0byBzZXJ2ZSBhcyBhIGdsb2JhbCBldmVudCBidXMsIGZvciBmb2xrcyB3aG8KICAvLyB3YW50IGdsb2JhbCAicHVic3ViIiBpbiBhIGNvbnZlbmllbnQgcGxhY2UuCiAgXy5leHRlbmQoQmFja2JvbmUsIEV2ZW50cyk7CiAgLy8gQmFja2JvbmUuTW9kZWwKICAvLyAtLS0tLS0tLS0tLS0tLQogIC8vIEJhY2tib25lICoqTW9kZWxzKiogYXJlIHRoZSBiYXNpYyBkYXRhIG9iamVjdCBpbiB0aGUgZnJhbWV3b3JrIC0tCiAgLy8gZnJlcXVlbnRseSByZXByZXNlbnRpbmcgYSByb3cgaW4gYSB0YWJsZSBpbiBhIGRhdGFiYXNlIG9uIHlvdXIgc2VydmVyLgogIC8vIEEgZGlzY3JldGUgY2h1bmsgb2YgZGF0YSBhbmQgYSBidW5jaCBvZiB1c2VmdWwsIHJlbGF0ZWQgbWV0aG9kcyBmb3IKICAvLyBwZXJmb3JtaW5nIGNvbXB1dGF0aW9ucyBhbmQgdHJhbnNmb3JtYXRpb25zIG9uIHRoYXQgZGF0YS4KICAvLyBDcmVhdGUgYSBuZXcgbW9kZWwgd2l0aCB0aGUgc3BlY2lmaWVkIGF0dHJpYnV0ZXMuIEEgY2xpZW50IGlkIChgY2lkYCkKICAvLyBpcyBhdXRvbWF0aWNhbGx5IGdlbmVyYXRlZCBhbmQgYXNzaWduZWQgZm9yIHlvdS4KICB2YXIgTW9kZWwgPSBCYWNrYm9uZS5Nb2RlbCA9IGZ1bmN0aW9uIChhdHRyaWJ1dGVzLCBvcHRpb25zKSB7CiAgICB2YXIgYXR0cnMgPSBhdHRyaWJ1dGVzIHx8IHt9OwogICAgb3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KTsKICAgIHRoaXMuY2lkID0gXy51bmlxdWVJZCgnYycpOwogICAgdGhpcy5hdHRyaWJ1dGVzID0ge307CiAgICBpZiAob3B0aW9ucy5jb2xsZWN0aW9uKQogICAgICB0aGlzLmNvbGxlY3Rpb24gPSBvcHRpb25zLmNvbGxlY3Rpb247CiAgICBpZiAob3B0aW9ucy5wYXJzZSkKICAgICAgYXR0cnMgPSB0aGlzLnBhcnNlKGF0dHJzLCBvcHRpb25zKSB8fCB7fTsKICAgIGF0dHJzID0gXy5kZWZhdWx0cyh7fSwgYXR0cnMsIF8ucmVzdWx0KHRoaXMsICdkZWZhdWx0cycpKTsKICAgIHRoaXMuc2V0KGF0dHJzLCBvcHRpb25zKTsKICAgIHRoaXMuY2hhbmdlZCA9IHt9OwogICAgdGhpcy5pbml0aWFsaXplLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgfTsKICAvLyBBdHRhY2ggYWxsIGluaGVyaXRhYmxlIG1ldGhvZHMgdG8gdGhlIE1vZGVsIHByb3RvdHlwZS4KICBfLmV4dGVuZChNb2RlbC5wcm90b3R5cGUsIEV2ZW50cywgewogICAgLy8gQSBoYXNoIG9mIGF0dHJpYnV0ZXMgd2hvc2UgY3VycmVudCBhbmQgcHJldmlvdXMgdmFsdWUgZGlmZmVyLgogICAgY2hhbmdlZDogbnVsbCwKICAgIC8vIFRoZSB2YWx1ZSByZXR1cm5lZCBkdXJpbmcgdGhlIGxhc3QgZmFpbGVkIHZhbGlkYXRpb24uCiAgICB2YWxpZGF0aW9uRXJyb3I6IG51bGwsCiAgICAvLyBUaGUgZGVmYXVsdCBuYW1lIGZvciB0aGUgSlNPTiBgaWRgIGF0dHJpYnV0ZSBpcyBgImlkImAuIE1vbmdvREIgYW5kCiAgICAvLyBDb3VjaERCIHVzZXJzIG1heSB3YW50IHRvIHNldCB0aGlzIHRvIGAiX2lkImAuCiAgICBpZEF0dHJpYnV0ZTogJ2lkJywKICAgIC8vIEluaXRpYWxpemUgaXMgYW4gZW1wdHkgZnVuY3Rpb24gYnkgZGVmYXVsdC4gT3ZlcnJpZGUgaXQgd2l0aCB5b3VyIG93bgogICAgLy8gaW5pdGlhbGl6YXRpb24gbG9naWMuCiAgICBpbml0aWFsaXplOiBmdW5jdGlvbiAoKSB7CiAgICB9LAogICAgLy8gUmV0dXJuIGEgY29weSBvZiB0aGUgbW9kZWwncyBgYXR0cmlidXRlc2Agb2JqZWN0LgogICAgdG9KU09OOiBmdW5jdGlvbiAob3B0aW9ucykgewogICAgICByZXR1cm4gXy5jbG9uZSh0aGlzLmF0dHJpYnV0ZXMpOwogICAgfSwKICAgIC8vIFByb3h5IGBCYWNrYm9uZS5zeW5jYCBieSBkZWZhdWx0IC0tIGJ1dCBvdmVycmlkZSB0aGlzIGlmIHlvdSBuZWVkCiAgICAvLyBjdXN0b20gc3luY2luZyBzZW1hbnRpY3MgZm9yICp0aGlzKiBwYXJ0aWN1bGFyIG1vZGVsLgogICAgc3luYzogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gQmFja2JvbmUuc3luYy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfSwKICAgIC8vIEdldCB0aGUgdmFsdWUgb2YgYW4gYXR0cmlidXRlLgogICAgZ2V0OiBmdW5jdGlvbiAoYXR0cikgewogICAgICByZXR1cm4gdGhpcy5hdHRyaWJ1dGVzW2F0dHJdOwogICAgfSwKICAgIC8vIEdldCB0aGUgSFRNTC1lc2NhcGVkIHZhbHVlIG9mIGFuIGF0dHJpYnV0ZS4KICAgIGVzY2FwZTogZnVuY3Rpb24gKGF0dHIpIHsKICAgICAgcmV0dXJuIF8uZXNjYXBlKHRoaXMuZ2V0KGF0dHIpKTsKICAgIH0sCiAgICAvLyBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgYXR0cmlidXRlIGNvbnRhaW5zIGEgdmFsdWUgdGhhdCBpcyBub3QgbnVsbAogICAgLy8gb3IgdW5kZWZpbmVkLgogICAgaGFzOiBmdW5jdGlvbiAoYXR0cikgewogICAgICByZXR1cm4gdGhpcy5nZXQoYXR0cikgIT0gbnVsbDsKICAgIH0sCiAgICAvLyBTZXQgYSBoYXNoIG9mIG1vZGVsIGF0dHJpYnV0ZXMgb24gdGhlIG9iamVjdCwgZmlyaW5nIGAiY2hhbmdlImAuIFRoaXMgaXMKICAgIC8vIHRoZSBjb3JlIHByaW1pdGl2ZSBvcGVyYXRpb24gb2YgYSBtb2RlbCwgdXBkYXRpbmcgdGhlIGRhdGEgYW5kIG5vdGlmeWluZwogICAgLy8gYW55b25lIHdobyBuZWVkcyB0byBrbm93IGFib3V0IHRoZSBjaGFuZ2UgaW4gc3RhdGUuIFRoZSBoZWFydCBvZiB0aGUgYmVhc3QuCiAgICBzZXQ6IGZ1bmN0aW9uIChrZXksIHZhbCwgb3B0aW9ucykgewogICAgICB2YXIgYXR0ciwgYXR0cnMsIHVuc2V0LCBjaGFuZ2VzLCBzaWxlbnQsIGNoYW5naW5nLCBwcmV2LCBjdXJyZW50OwogICAgICBpZiAoa2V5ID09IG51bGwpCiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgIC8vIEhhbmRsZSBib3RoIGAia2V5IiwgdmFsdWVgIGFuZCBge2tleTogdmFsdWV9YCAtc3R5bGUgYXJndW1lbnRzLgogICAgICBpZiAodHlwZW9mIGtleSA9PT0gJ29iamVjdCcpIHsKICAgICAgICBhdHRycyA9IGtleTsKICAgICAgICBvcHRpb25zID0gdmFsOwogICAgICB9IGVsc2UgewogICAgICAgIChhdHRycyA9IHt9KVtrZXldID0gdmFsOwogICAgICB9CiAgICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CiAgICAgIC8vIFJ1biB2YWxpZGF0aW9uLgogICAgICBpZiAoIXRoaXMuX3ZhbGlkYXRlKGF0dHJzLCBvcHRpb25zKSkKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIC8vIEV4dHJhY3QgYXR0cmlidXRlcyBhbmQgb3B0aW9ucy4KICAgICAgdW5zZXQgPSBvcHRpb25zLnVuc2V0OwogICAgICBzaWxlbnQgPSBvcHRpb25zLnNpbGVudDsKICAgICAgY2hhbmdlcyA9IFtdOwogICAgICBjaGFuZ2luZyA9IHRoaXMuX2NoYW5naW5nOwogICAgICB0aGlzLl9jaGFuZ2luZyA9IHRydWU7CiAgICAgIGlmICghY2hhbmdpbmcpIHsKICAgICAgICB0aGlzLl9wcmV2aW91c0F0dHJpYnV0ZXMgPSBfLmNsb25lKHRoaXMuYXR0cmlidXRlcyk7CiAgICAgICAgdGhpcy5jaGFuZ2VkID0ge307CiAgICAgIH0KICAgICAgY3VycmVudCA9IHRoaXMuYXR0cmlidXRlcywgcHJldiA9IHRoaXMuX3ByZXZpb3VzQXR0cmlidXRlczsKICAgICAgLy8gQ2hlY2sgZm9yIGNoYW5nZXMgb2YgYGlkYC4KICAgICAgaWYgKHRoaXMuaWRBdHRyaWJ1dGUgaW4gYXR0cnMpCiAgICAgICAgdGhpcy5pZCA9IGF0dHJzW3RoaXMuaWRBdHRyaWJ1dGVdOwogICAgICAvLyBGb3IgZWFjaCBgc2V0YCBhdHRyaWJ1dGUsIHVwZGF0ZSBvciBkZWxldGUgdGhlIGN1cnJlbnQgdmFsdWUuCiAgICAgIGZvciAoYXR0ciBpbiBhdHRycykgewogICAgICAgIHZhbCA9IGF0dHJzW2F0dHJdOwogICAgICAgIGlmICghXy5pc0VxdWFsKGN1cnJlbnRbYXR0cl0sIHZhbCkpCiAgICAgICAgICBjaGFuZ2VzLnB1c2goYXR0cik7CiAgICAgICAgaWYgKCFfLmlzRXF1YWwocHJldlthdHRyXSwgdmFsKSkgewogICAgICAgICAgdGhpcy5jaGFuZ2VkW2F0dHJdID0gdmFsOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBkZWxldGUgdGhpcy5jaGFuZ2VkW2F0dHJdOwogICAgICAgIH0KICAgICAgICB1bnNldCA/IGRlbGV0ZSBjdXJyZW50W2F0dHJdIDogY3VycmVudFthdHRyXSA9IHZhbDsKICAgICAgfQogICAgICAvLyBUcmlnZ2VyIGFsbCByZWxldmFudCBhdHRyaWJ1dGUgY2hhbmdlcy4KICAgICAgaWYgKCFzaWxlbnQpIHsKICAgICAgICBpZiAoY2hhbmdlcy5sZW5ndGgpCiAgICAgICAgICB0aGlzLl9wZW5kaW5nID0gb3B0aW9uczsKICAgICAgICBmb3IgKHZhciBpID0gMCwgbCA9IGNoYW5nZXMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgICB0aGlzLnRyaWdnZXIoJ2NoYW5nZTonICsgY2hhbmdlc1tpXSwgdGhpcywgY3VycmVudFtjaGFuZ2VzW2ldXSwgb3B0aW9ucyk7CiAgICAgICAgfQogICAgICB9CiAgICAgIC8vIFlvdSBtaWdodCBiZSB3b25kZXJpbmcgd2h5IHRoZXJlJ3MgYSBgd2hpbGVgIGxvb3AgaGVyZS4gQ2hhbmdlcyBjYW4KICAgICAgLy8gYmUgcmVjdXJzaXZlbHkgbmVzdGVkIHdpdGhpbiBgImNoYW5nZSJgIGV2ZW50cy4KICAgICAgaWYgKGNoYW5naW5nKQogICAgICAgIHJldHVybiB0aGlzOwogICAgICBpZiAoIXNpbGVudCkgewogICAgICAgIHdoaWxlICh0aGlzLl9wZW5kaW5nKSB7CiAgICAgICAgICBvcHRpb25zID0gdGhpcy5fcGVuZGluZzsKICAgICAgICAgIHRoaXMuX3BlbmRpbmcgPSBmYWxzZTsKICAgICAgICAgIHRoaXMudHJpZ2dlcignY2hhbmdlJywgdGhpcywgb3B0aW9ucyk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHRoaXMuX3BlbmRpbmcgPSBmYWxzZTsKICAgICAgdGhpcy5fY2hhbmdpbmcgPSBmYWxzZTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogICAgLy8gUmVtb3ZlIGFuIGF0dHJpYnV0ZSBmcm9tIHRoZSBtb2RlbCwgZmlyaW5nIGAiY2hhbmdlImAuIGB1bnNldGAgaXMgYSBub29wCiAgICAvLyBpZiB0aGUgYXR0cmlidXRlIGRvZXNuJ3QgZXhpc3QuCiAgICB1bnNldDogZnVuY3Rpb24gKGF0dHIsIG9wdGlvbnMpIHsKICAgICAgcmV0dXJuIHRoaXMuc2V0KGF0dHIsIHZvaWQgMCwgXy5leHRlbmQoe30sIG9wdGlvbnMsIHsgdW5zZXQ6IHRydWUgfSkpOwogICAgfSwKICAgIC8vIENsZWFyIGFsbCBhdHRyaWJ1dGVzIG9uIHRoZSBtb2RlbCwgZmlyaW5nIGAiY2hhbmdlImAuCiAgICBjbGVhcjogZnVuY3Rpb24gKG9wdGlvbnMpIHsKICAgICAgdmFyIGF0dHJzID0ge307CiAgICAgIGZvciAodmFyIGtleSBpbiB0aGlzLmF0dHJpYnV0ZXMpCiAgICAgICAgYXR0cnNba2V5XSA9IHZvaWQgMDsKICAgICAgcmV0dXJuIHRoaXMuc2V0KGF0dHJzLCBfLmV4dGVuZCh7fSwgb3B0aW9ucywgeyB1bnNldDogdHJ1ZSB9KSk7CiAgICB9LAogICAgLy8gRGV0ZXJtaW5lIGlmIHRoZSBtb2RlbCBoYXMgY2hhbmdlZCBzaW5jZSB0aGUgbGFzdCBgImNoYW5nZSJgIGV2ZW50LgogICAgLy8gSWYgeW91IHNwZWNpZnkgYW4gYXR0cmlidXRlIG5hbWUsIGRldGVybWluZSBpZiB0aGF0IGF0dHJpYnV0ZSBoYXMgY2hhbmdlZC4KICAgIGhhc0NoYW5nZWQ6IGZ1bmN0aW9uIChhdHRyKSB7CiAgICAgIGlmIChhdHRyID09IG51bGwpCiAgICAgICAgcmV0dXJuICFfLmlzRW1wdHkodGhpcy5jaGFuZ2VkKTsKICAgICAgcmV0dXJuIF8uaGFzKHRoaXMuY2hhbmdlZCwgYXR0cik7CiAgICB9LAogICAgLy8gUmV0dXJuIGFuIG9iamVjdCBjb250YWluaW5nIGFsbCB0aGUgYXR0cmlidXRlcyB0aGF0IGhhdmUgY2hhbmdlZCwgb3IKICAgIC8vIGZhbHNlIGlmIHRoZXJlIGFyZSBubyBjaGFuZ2VkIGF0dHJpYnV0ZXMuIFVzZWZ1bCBmb3IgZGV0ZXJtaW5pbmcgd2hhdAogICAgLy8gcGFydHMgb2YgYSB2aWV3IG5lZWQgdG8gYmUgdXBkYXRlZCBhbmQvb3Igd2hhdCBhdHRyaWJ1dGVzIG5lZWQgdG8gYmUKICAgIC8vIHBlcnNpc3RlZCB0byB0aGUgc2VydmVyLiBVbnNldCBhdHRyaWJ1dGVzIHdpbGwgYmUgc2V0IHRvIHVuZGVmaW5lZC4KICAgIC8vIFlvdSBjYW4gYWxzbyBwYXNzIGFuIGF0dHJpYnV0ZXMgb2JqZWN0IHRvIGRpZmYgYWdhaW5zdCB0aGUgbW9kZWwsCiAgICAvLyBkZXRlcm1pbmluZyBpZiB0aGVyZSAqd291bGQgYmUqIGEgY2hhbmdlLgogICAgY2hhbmdlZEF0dHJpYnV0ZXM6IGZ1bmN0aW9uIChkaWZmKSB7CiAgICAgIGlmICghZGlmZikKICAgICAgICByZXR1cm4gdGhpcy5oYXNDaGFuZ2VkKCkgPyBfLmNsb25lKHRoaXMuY2hhbmdlZCkgOiBmYWxzZTsKICAgICAgdmFyIHZhbCwgY2hhbmdlZCA9IGZhbHNlOwogICAgICB2YXIgb2xkID0gdGhpcy5fY2hhbmdpbmcgPyB0aGlzLl9wcmV2aW91c0F0dHJpYnV0ZXMgOiB0aGlzLmF0dHJpYnV0ZXM7CiAgICAgIGZvciAodmFyIGF0dHIgaW4gZGlmZikgewogICAgICAgIGlmIChfLmlzRXF1YWwob2xkW2F0dHJdLCB2YWwgPSBkaWZmW2F0dHJdKSkKICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIChjaGFuZ2VkIHx8IChjaGFuZ2VkID0ge30pKVthdHRyXSA9IHZhbDsKICAgICAgfQogICAgICByZXR1cm4gY2hhbmdlZDsKICAgIH0sCiAgICAvLyBHZXQgdGhlIHByZXZpb3VzIHZhbHVlIG9mIGFuIGF0dHJpYnV0ZSwgcmVjb3JkZWQgYXQgdGhlIHRpbWUgdGhlIGxhc3QKICAgIC8vIGAiY2hhbmdlImAgZXZlbnQgd2FzIGZpcmVkLgogICAgcHJldmlvdXM6IGZ1bmN0aW9uIChhdHRyKSB7CiAgICAgIGlmIChhdHRyID09IG51bGwgfHwgIXRoaXMuX3ByZXZpb3VzQXR0cmlidXRlcykKICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgcmV0dXJuIHRoaXMuX3ByZXZpb3VzQXR0cmlidXRlc1thdHRyXTsKICAgIH0sCiAgICAvLyBHZXQgYWxsIG9mIHRoZSBhdHRyaWJ1dGVzIG9mIHRoZSBtb2RlbCBhdCB0aGUgdGltZSBvZiB0aGUgcHJldmlvdXMKICAgIC8vIGAiY2hhbmdlImAgZXZlbnQuCiAgICBwcmV2aW91c0F0dHJpYnV0ZXM6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIF8uY2xvbmUodGhpcy5fcHJldmlvdXNBdHRyaWJ1dGVzKTsKICAgIH0sCiAgICAvLyBGZXRjaCB0aGUgbW9kZWwgZnJvbSB0aGUgc2VydmVyLiBJZiB0aGUgc2VydmVyJ3MgcmVwcmVzZW50YXRpb24gb2YgdGhlCiAgICAvLyBtb2RlbCBkaWZmZXJzIGZyb20gaXRzIGN1cnJlbnQgYXR0cmlidXRlcywgdGhleSB3aWxsIGJlIG92ZXJyaWRkZW4sCiAgICAvLyB0cmlnZ2VyaW5nIGEgYCJjaGFuZ2UiYCBldmVudC4KICAgIGZldGNoOiBmdW5jdGlvbiAob3B0aW9ucykgewogICAgICBvcHRpb25zID0gb3B0aW9ucyA/IF8uY2xvbmUob3B0aW9ucykgOiB7fTsKICAgICAgaWYgKG9wdGlvbnMucGFyc2UgPT09IHZvaWQgMCkKICAgICAgICBvcHRpb25zLnBhcnNlID0gdHJ1ZTsKICAgICAgdmFyIG1vZGVsID0gdGhpczsKICAgICAgdmFyIHN1Y2Nlc3MgPSBvcHRpb25zLnN1Y2Nlc3M7CiAgICAgIG9wdGlvbnMuc3VjY2VzcyA9IGZ1bmN0aW9uIChyZXNwKSB7CiAgICAgICAgaWYgKCFtb2RlbC5zZXQobW9kZWwucGFyc2UocmVzcCwgb3B0aW9ucyksIG9wdGlvbnMpKQogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIGlmIChzdWNjZXNzKQogICAgICAgICAgc3VjY2Vzcyhtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CiAgICAgICAgbW9kZWwudHJpZ2dlcignc3luYycsIG1vZGVsLCByZXNwLCBvcHRpb25zKTsKICAgICAgfTsKICAgICAgd3JhcEVycm9yKHRoaXMsIG9wdGlvbnMpOwogICAgICByZXR1cm4gdGhpcy5zeW5jKCdyZWFkJywgdGhpcywgb3B0aW9ucyk7CiAgICB9LAogICAgLy8gU2V0IGEgaGFzaCBvZiBtb2RlbCBhdHRyaWJ1dGVzLCBhbmQgc3luYyB0aGUgbW9kZWwgdG8gdGhlIHNlcnZlci4KICAgIC8vIElmIHRoZSBzZXJ2ZXIgcmV0dXJucyBhbiBhdHRyaWJ1dGVzIGhhc2ggdGhhdCBkaWZmZXJzLCB0aGUgbW9kZWwncwogICAgLy8gc3RhdGUgd2lsbCBiZSBgc2V0YCBhZ2Fpbi4KICAgIHNhdmU6IGZ1bmN0aW9uIChrZXksIHZhbCwgb3B0aW9ucykgewogICAgICB2YXIgYXR0cnMsIG1ldGhvZCwgeGhyLCBhdHRyaWJ1dGVzID0gdGhpcy5hdHRyaWJ1dGVzOwogICAgICAvLyBIYW5kbGUgYm90aCBgImtleSIsIHZhbHVlYCBhbmQgYHtrZXk6IHZhbHVlfWAgLXN0eWxlIGFyZ3VtZW50cy4KICAgICAgaWYgKGtleSA9PSBudWxsIHx8IHR5cGVvZiBrZXkgPT09ICdvYmplY3QnKSB7CiAgICAgICAgYXR0cnMgPSBrZXk7CiAgICAgICAgb3B0aW9ucyA9IHZhbDsKICAgICAgfSBlbHNlIHsKICAgICAgICAoYXR0cnMgPSB7fSlba2V5XSA9IHZhbDsKICAgICAgfQogICAgICBvcHRpb25zID0gXy5leHRlbmQoeyB2YWxpZGF0ZTogdHJ1ZSB9LCBvcHRpb25zKTsKICAgICAgLy8gSWYgd2UncmUgbm90IHdhaXRpbmcgYW5kIGF0dHJpYnV0ZXMgZXhpc3QsIHNhdmUgYWN0cyBhcwogICAgICAvLyBgc2V0KGF0dHIpLnNhdmUobnVsbCwgb3B0cylgIHdpdGggdmFsaWRhdGlvbi4gT3RoZXJ3aXNlLCBjaGVjayBpZgogICAgICAvLyB0aGUgbW9kZWwgd2lsbCBiZSB2YWxpZCB3aGVuIHRoZSBhdHRyaWJ1dGVzLCBpZiBhbnksIGFyZSBzZXQuCiAgICAgIGlmIChhdHRycyAmJiAhb3B0aW9ucy53YWl0KSB7CiAgICAgICAgaWYgKCF0aGlzLnNldChhdHRycywgb3B0aW9ucykpCiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKCF0aGlzLl92YWxpZGF0ZShhdHRycywgb3B0aW9ucykpCiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgICAgLy8gU2V0IHRlbXBvcmFyeSBhdHRyaWJ1dGVzIGlmIGB7d2FpdDogdHJ1ZX1gLgogICAgICBpZiAoYXR0cnMgJiYgb3B0aW9ucy53YWl0KSB7CiAgICAgICAgdGhpcy5hdHRyaWJ1dGVzID0gXy5leHRlbmQoe30sIGF0dHJpYnV0ZXMsIGF0dHJzKTsKICAgICAgfQogICAgICAvLyBBZnRlciBhIHN1Y2Nlc3NmdWwgc2VydmVyLXNpZGUgc2F2ZSwgdGhlIGNsaWVudCBpcyAob3B0aW9uYWxseSkKICAgICAgLy8gdXBkYXRlZCB3aXRoIHRoZSBzZXJ2ZXItc2lkZSBzdGF0ZS4KICAgICAgaWYgKG9wdGlvbnMucGFyc2UgPT09IHZvaWQgMCkKICAgICAgICBvcHRpb25zLnBhcnNlID0gdHJ1ZTsKICAgICAgdmFyIG1vZGVsID0gdGhpczsKICAgICAgdmFyIHN1Y2Nlc3MgPSBvcHRpb25zLnN1Y2Nlc3M7CiAgICAgIG9wdGlvbnMuc3VjY2VzcyA9IGZ1bmN0aW9uIChyZXNwKSB7CiAgICAgICAgLy8gRW5zdXJlIGF0dHJpYnV0ZXMgYXJlIHJlc3RvcmVkIGR1cmluZyBzeW5jaHJvbm91cyBzYXZlcy4KICAgICAgICBtb2RlbC5hdHRyaWJ1dGVzID0gYXR0cmlidXRlczsKICAgICAgICB2YXIgc2VydmVyQXR0cnMgPSBtb2RlbC5wYXJzZShyZXNwLCBvcHRpb25zKTsKICAgICAgICBpZiAob3B0aW9ucy53YWl0KQogICAgICAgICAgc2VydmVyQXR0cnMgPSBfLmV4dGVuZChhdHRycyB8fCB7fSwgc2VydmVyQXR0cnMpOwogICAgICAgIGlmIChfLmlzT2JqZWN0KHNlcnZlckF0dHJzKSAmJiAhbW9kZWwuc2V0KHNlcnZlckF0dHJzLCBvcHRpb25zKSkgewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICBpZiAoc3VjY2VzcykKICAgICAgICAgIHN1Y2Nlc3MobW9kZWwsIHJlc3AsIG9wdGlvbnMpOwogICAgICAgIG1vZGVsLnRyaWdnZXIoJ3N5bmMnLCBtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CiAgICAgIH07CiAgICAgIHdyYXBFcnJvcih0aGlzLCBvcHRpb25zKTsKICAgICAgbWV0aG9kID0gdGhpcy5pc05ldygpID8gJ2NyZWF0ZScgOiBvcHRpb25zLnBhdGNoID8gJ3BhdGNoJyA6ICd1cGRhdGUnOwogICAgICBpZiAobWV0aG9kID09PSAncGF0Y2gnKQogICAgICAgIG9wdGlvbnMuYXR0cnMgPSBhdHRyczsKICAgICAgeGhyID0gdGhpcy5zeW5jKG1ldGhvZCwgdGhpcywgb3B0aW9ucyk7CiAgICAgIC8vIFJlc3RvcmUgYXR0cmlidXRlcy4KICAgICAgaWYgKGF0dHJzICYmIG9wdGlvbnMud2FpdCkKICAgICAgICB0aGlzLmF0dHJpYnV0ZXMgPSBhdHRyaWJ1dGVzOwogICAgICByZXR1cm4geGhyOwogICAgfSwKICAgIC8vIERlc3Ryb3kgdGhpcyBtb2RlbCBvbiB0aGUgc2VydmVyIGlmIGl0IHdhcyBhbHJlYWR5IHBlcnNpc3RlZC4KICAgIC8vIE9wdGltaXN0aWNhbGx5IHJlbW92ZXMgdGhlIG1vZGVsIGZyb20gaXRzIGNvbGxlY3Rpb24sIGlmIGl0IGhhcyBvbmUuCiAgICAvLyBJZiBgd2FpdDogdHJ1ZWAgaXMgcGFzc2VkLCB3YWl0cyBmb3IgdGhlIHNlcnZlciB0byByZXNwb25kIGJlZm9yZSByZW1vdmFsLgogICAgZGVzdHJveTogZnVuY3Rpb24gKG9wdGlvbnMpIHsKICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgPyBfLmNsb25lKG9wdGlvbnMpIDoge307CiAgICAgIHZhciBtb2RlbCA9IHRoaXM7CiAgICAgIHZhciBzdWNjZXNzID0gb3B0aW9ucy5zdWNjZXNzOwogICAgICB2YXIgZGVzdHJveSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBtb2RlbC50cmlnZ2VyKCdkZXN0cm95JywgbW9kZWwsIG1vZGVsLmNvbGxlY3Rpb24sIG9wdGlvbnMpOwogICAgICB9OwogICAgICBvcHRpb25zLnN1Y2Nlc3MgPSBmdW5jdGlvbiAocmVzcCkgewogICAgICAgIGlmIChvcHRpb25zLndhaXQgfHwgbW9kZWwuaXNOZXcoKSkKICAgICAgICAgIGRlc3Ryb3koKTsKICAgICAgICBpZiAoc3VjY2VzcykKICAgICAgICAgIHN1Y2Nlc3MobW9kZWwsIHJlc3AsIG9wdGlvbnMpOwogICAgICAgIGlmICghbW9kZWwuaXNOZXcoKSkKICAgICAgICAgIG1vZGVsLnRyaWdnZXIoJ3N5bmMnLCBtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CiAgICAgIH07CiAgICAgIGlmICh0aGlzLmlzTmV3KCkpIHsKICAgICAgICBvcHRpb25zLnN1Y2Nlc3MoKTsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgICAgd3JhcEVycm9yKHRoaXMsIG9wdGlvbnMpOwogICAgICB2YXIgeGhyID0gdGhpcy5zeW5jKCdkZWxldGUnLCB0aGlzLCBvcHRpb25zKTsKICAgICAgaWYgKCFvcHRpb25zLndhaXQpCiAgICAgICAgZGVzdHJveSgpOwogICAgICByZXR1cm4geGhyOwogICAgfSwKICAgIC8vIERlZmF1bHQgVVJMIGZvciB0aGUgbW9kZWwncyByZXByZXNlbnRhdGlvbiBvbiB0aGUgc2VydmVyIC0tIGlmIHlvdSdyZQogICAgLy8gdXNpbmcgQmFja2JvbmUncyByZXN0ZnVsIG1ldGhvZHMsIG92ZXJyaWRlIHRoaXMgdG8gY2hhbmdlIHRoZSBlbmRwb2ludAogICAgLy8gdGhhdCB3aWxsIGJlIGNhbGxlZC4KICAgIHVybDogZnVuY3Rpb24gKCkgewogICAgICB2YXIgYmFzZSA9IF8ucmVzdWx0KHRoaXMsICd1cmxSb290JykgfHwgXy5yZXN1bHQodGhpcy5jb2xsZWN0aW9uLCAndXJsJykgfHwgdXJsRXJyb3IoKTsKICAgICAgaWYgKHRoaXMuaXNOZXcoKSkKICAgICAgICByZXR1cm4gYmFzZTsKICAgICAgcmV0dXJuIGJhc2UucmVwbGFjZSgvKFteXC9dKSQvLCAnJDEvJykgKyBlbmNvZGVVUklDb21wb25lbnQodGhpcy5pZCk7CiAgICB9LAogICAgLy8gKipwYXJzZSoqIGNvbnZlcnRzIGEgcmVzcG9uc2UgaW50byB0aGUgaGFzaCBvZiBhdHRyaWJ1dGVzIHRvIGJlIGBzZXRgIG9uCiAgICAvLyB0aGUgbW9kZWwuIFRoZSBkZWZhdWx0IGltcGxlbWVudGF0aW9uIGlzIGp1c3QgdG8gcGFzcyB0aGUgcmVzcG9uc2UgYWxvbmcuCiAgICBwYXJzZTogZnVuY3Rpb24gKHJlc3AsIG9wdGlvbnMpIHsKICAgICAgcmV0dXJuIHJlc3A7CiAgICB9LAogICAgLy8gQ3JlYXRlIGEgbmV3IG1vZGVsIHdpdGggaWRlbnRpY2FsIGF0dHJpYnV0ZXMgdG8gdGhpcyBvbmUuCiAgICBjbG9uZTogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gbmV3IHRoaXMuY29uc3RydWN0b3IodGhpcy5hdHRyaWJ1dGVzKTsKICAgIH0sCiAgICAvLyBBIG1vZGVsIGlzIG5ldyBpZiBpdCBoYXMgbmV2ZXIgYmVlbiBzYXZlZCB0byB0aGUgc2VydmVyLCBhbmQgbGFja3MgYW4gaWQuCiAgICBpc05ldzogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gIXRoaXMuaGFzKHRoaXMuaWRBdHRyaWJ1dGUpOwogICAgfSwKICAgIC8vIENoZWNrIGlmIHRoZSBtb2RlbCBpcyBjdXJyZW50bHkgaW4gYSB2YWxpZCBzdGF0ZS4KICAgIGlzVmFsaWQ6IGZ1bmN0aW9uIChvcHRpb25zKSB7CiAgICAgIHJldHVybiB0aGlzLl92YWxpZGF0ZSh7fSwgXy5leHRlbmQob3B0aW9ucyB8fCB7fSwgeyB2YWxpZGF0ZTogdHJ1ZSB9KSk7CiAgICB9LAogICAgLy8gUnVuIHZhbGlkYXRpb24gYWdhaW5zdCB0aGUgbmV4dCBjb21wbGV0ZSBzZXQgb2YgbW9kZWwgYXR0cmlidXRlcywKICAgIC8vIHJldHVybmluZyBgdHJ1ZWAgaWYgYWxsIGlzIHdlbGwuIE90aGVyd2lzZSwgZmlyZSBhbiBgImludmFsaWQiYCBldmVudC4KICAgIF92YWxpZGF0ZTogZnVuY3Rpb24gKGF0dHJzLCBvcHRpb25zKSB7CiAgICAgIGlmICghb3B0aW9ucy52YWxpZGF0ZSB8fCAhdGhpcy52YWxpZGF0ZSkKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgYXR0cnMgPSBfLmV4dGVuZCh7fSwgdGhpcy5hdHRyaWJ1dGVzLCBhdHRycyk7CiAgICAgIHZhciBlcnJvciA9IHRoaXMudmFsaWRhdGlvbkVycm9yID0gdGhpcy52YWxpZGF0ZShhdHRycywgb3B0aW9ucykgfHwgbnVsbDsKICAgICAgaWYgKCFlcnJvcikKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgdGhpcy50cmlnZ2VyKCdpbnZhbGlkJywgdGhpcywgZXJyb3IsIF8uZXh0ZW5kKG9wdGlvbnMsIHsgdmFsaWRhdGlvbkVycm9yOiBlcnJvciB9KSk7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICB9KTsKICAvLyBVbmRlcnNjb3JlIG1ldGhvZHMgdGhhdCB3ZSB3YW50IHRvIGltcGxlbWVudCBvbiB0aGUgTW9kZWwuCiAgdmFyIG1vZGVsTWV0aG9kcyA9IFsKICAgICdrZXlzJywKICAgICd2YWx1ZXMnLAogICAgJ3BhaXJzJywKICAgICdpbnZlcnQnLAogICAgJ3BpY2snLAogICAgJ29taXQnCiAgXTsKICAvLyBNaXggaW4gZWFjaCBVbmRlcnNjb3JlIG1ldGhvZCBhcyBhIHByb3h5IHRvIGBNb2RlbCNhdHRyaWJ1dGVzYC4KICBfLmVhY2gobW9kZWxNZXRob2RzLCBmdW5jdGlvbiAobWV0aG9kKSB7CiAgICBNb2RlbC5wcm90b3R5cGVbbWV0aG9kXSA9IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cyk7CiAgICAgIGFyZ3MudW5zaGlmdCh0aGlzLmF0dHJpYnV0ZXMpOwogICAgICByZXR1cm4gX1ttZXRob2RdLmFwcGx5KF8sIGFyZ3MpOwogICAgfTsKICB9KTsKICAvLyBCYWNrYm9uZS5Db2xsZWN0aW9uCiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLQogIC8vIElmIG1vZGVscyB0ZW5kIHRvIHJlcHJlc2VudCBhIHNpbmdsZSByb3cgb2YgZGF0YSwgYSBCYWNrYm9uZSBDb2xsZWN0aW9uIGlzCiAgLy8gbW9yZSBhbmFsYWdvdXMgdG8gYSB0YWJsZSBmdWxsIG9mIGRhdGEgLi4uIG9yIGEgc21hbGwgc2xpY2Ugb3IgcGFnZSBvZiB0aGF0CiAgLy8gdGFibGUsIG9yIGEgY29sbGVjdGlvbiBvZiByb3dzIHRoYXQgYmVsb25nIHRvZ2V0aGVyIGZvciBhIHBhcnRpY3VsYXIgcmVhc29uCiAgLy8gLS0gYWxsIG9mIHRoZSBtZXNzYWdlcyBpbiB0aGlzIHBhcnRpY3VsYXIgZm9sZGVyLCBhbGwgb2YgdGhlIGRvY3VtZW50cwogIC8vIGJlbG9uZ2luZyB0byB0aGlzIHBhcnRpY3VsYXIgYXV0aG9yLCBhbmQgc28gb24uIENvbGxlY3Rpb25zIG1haW50YWluCiAgLy8gaW5kZXhlcyBvZiB0aGVpciBtb2RlbHMsIGJvdGggaW4gb3JkZXIsIGFuZCBmb3IgbG9va3VwIGJ5IGBpZGAuCiAgLy8gQ3JlYXRlIGEgbmV3ICoqQ29sbGVjdGlvbioqLCBwZXJoYXBzIHRvIGNvbnRhaW4gYSBzcGVjaWZpYyB0eXBlIG9mIGBtb2RlbGAuCiAgLy8gSWYgYSBgY29tcGFyYXRvcmAgaXMgc3BlY2lmaWVkLCB0aGUgQ29sbGVjdGlvbiB3aWxsIG1haW50YWluCiAgLy8gaXRzIG1vZGVscyBpbiBzb3J0IG9yZGVyLCBhcyB0aGV5J3JlIGFkZGVkIGFuZCByZW1vdmVkLgogIHZhciBDb2xsZWN0aW9uID0gQmFja2JvbmUuQ29sbGVjdGlvbiA9IGZ1bmN0aW9uIChtb2RlbHMsIG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CiAgICBpZiAob3B0aW9ucy5tb2RlbCkKICAgICAgdGhpcy5tb2RlbCA9IG9wdGlvbnMubW9kZWw7CiAgICBpZiAob3B0aW9ucy5jb21wYXJhdG9yICE9PSB2b2lkIDApCiAgICAgIHRoaXMuY29tcGFyYXRvciA9IG9wdGlvbnMuY29tcGFyYXRvcjsKICAgIHRoaXMuX3Jlc2V0KCk7CiAgICB0aGlzLmluaXRpYWxpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIGlmIChtb2RlbHMpCiAgICAgIHRoaXMucmVzZXQobW9kZWxzLCBfLmV4dGVuZCh7IHNpbGVudDogdHJ1ZSB9LCBvcHRpb25zKSk7CiAgfTsKICAvLyBEZWZhdWx0IG9wdGlvbnMgZm9yIGBDb2xsZWN0aW9uI3NldGAuCiAgdmFyIHNldE9wdGlvbnMgPSB7CiAgICBhZGQ6IHRydWUsCiAgICByZW1vdmU6IHRydWUsCiAgICBtZXJnZTogdHJ1ZQogIH07CiAgdmFyIGFkZE9wdGlvbnMgPSB7CiAgICBhZGQ6IHRydWUsCiAgICByZW1vdmU6IGZhbHNlCiAgfTsKICAvLyBEZWZpbmUgdGhlIENvbGxlY3Rpb24ncyBpbmhlcml0YWJsZSBtZXRob2RzLgogIF8uZXh0ZW5kKENvbGxlY3Rpb24ucHJvdG90eXBlLCBFdmVudHMsIHsKICAgIC8vIFRoZSBkZWZhdWx0IG1vZGVsIGZvciBhIGNvbGxlY3Rpb24gaXMganVzdCBhICoqQmFja2JvbmUuTW9kZWwqKi4KICAgIC8vIFRoaXMgc2hvdWxkIGJlIG92ZXJyaWRkZW4gaW4gbW9zdCBjYXNlcy4KICAgIG1vZGVsOiBNb2RlbCwKICAgIC8vIEluaXRpYWxpemUgaXMgYW4gZW1wdHkgZnVuY3Rpb24gYnkgZGVmYXVsdC4gT3ZlcnJpZGUgaXQgd2l0aCB5b3VyIG93bgogICAgLy8gaW5pdGlhbGl6YXRpb24gbG9naWMuCiAgICBpbml0aWFsaXplOiBmdW5jdGlvbiAoKSB7CiAgICB9LAogICAgLy8gVGhlIEpTT04gcmVwcmVzZW50YXRpb24gb2YgYSBDb2xsZWN0aW9uIGlzIGFuIGFycmF5IG9mIHRoZQogICAgLy8gbW9kZWxzJyBhdHRyaWJ1dGVzLgogICAgdG9KU09OOiBmdW5jdGlvbiAob3B0aW9ucykgewogICAgICByZXR1cm4gdGhpcy5tYXAoZnVuY3Rpb24gKG1vZGVsKSB7CiAgICAgICAgcmV0dXJuIG1vZGVsLnRvSlNPTihvcHRpb25zKTsKICAgICAgfSk7CiAgICB9LAogICAgLy8gUHJveHkgYEJhY2tib25lLnN5bmNgIGJ5IGRlZmF1bHQuCiAgICBzeW5jOiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBCYWNrYm9uZS5zeW5jLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9LAogICAgLy8gQWRkIGEgbW9kZWwsIG9yIGxpc3Qgb2YgbW9kZWxzIHRvIHRoZSBzZXQuCiAgICBhZGQ6IGZ1bmN0aW9uIChtb2RlbHMsIG9wdGlvbnMpIHsKICAgICAgcmV0dXJuIHRoaXMuc2V0KG1vZGVscywgXy5leHRlbmQoeyBtZXJnZTogZmFsc2UgfSwgb3B0aW9ucywgYWRkT3B0aW9ucykpOwogICAgfSwKICAgIC8vIFJlbW92ZSBhIG1vZGVsLCBvciBhIGxpc3Qgb2YgbW9kZWxzIGZyb20gdGhlIHNldC4KICAgIHJlbW92ZTogZnVuY3Rpb24gKG1vZGVscywgb3B0aW9ucykgewogICAgICB2YXIgc2luZ3VsYXIgPSAhXy5pc0FycmF5KG1vZGVscyk7CiAgICAgIG1vZGVscyA9IHNpbmd1bGFyID8gW21vZGVsc10gOiBfLmNsb25lKG1vZGVscyk7CiAgICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CiAgICAgIHZhciBpLCBsLCBpbmRleCwgbW9kZWw7CiAgICAgIGZvciAoaSA9IDAsIGwgPSBtb2RlbHMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgbW9kZWwgPSBtb2RlbHNbaV0gPSB0aGlzLmdldChtb2RlbHNbaV0pOwogICAgICAgIGlmICghbW9kZWwpCiAgICAgICAgICBjb250aW51ZTsKICAgICAgICBkZWxldGUgdGhpcy5fYnlJZFttb2RlbC5pZF07CiAgICAgICAgZGVsZXRlIHRoaXMuX2J5SWRbbW9kZWwuY2lkXTsKICAgICAgICBpbmRleCA9IHRoaXMuaW5kZXhPZihtb2RlbCk7CiAgICAgICAgdGhpcy5tb2RlbHMuc3BsaWNlKGluZGV4LCAxKTsKICAgICAgICB0aGlzLmxlbmd0aC0tOwogICAgICAgIGlmICghb3B0aW9ucy5zaWxlbnQpIHsKICAgICAgICAgIG9wdGlvbnMuaW5kZXggPSBpbmRleDsKICAgICAgICAgIG1vZGVsLnRyaWdnZXIoJ3JlbW92ZScsIG1vZGVsLCB0aGlzLCBvcHRpb25zKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5fcmVtb3ZlUmVmZXJlbmNlKG1vZGVsLCBvcHRpb25zKTsKICAgICAgfQogICAgICByZXR1cm4gc2luZ3VsYXIgPyBtb2RlbHNbMF0gOiBtb2RlbHM7CiAgICB9LAogICAgLy8gVXBkYXRlIGEgY29sbGVjdGlvbiBieSBgc2V0YC1pbmcgYSBuZXcgbGlzdCBvZiBtb2RlbHMsIGFkZGluZyBuZXcgb25lcywKICAgIC8vIHJlbW92aW5nIG1vZGVscyB0aGF0IGFyZSBubyBsb25nZXIgcHJlc2VudCwgYW5kIG1lcmdpbmcgbW9kZWxzIHRoYXQKICAgIC8vIGFscmVhZHkgZXhpc3QgaW4gdGhlIGNvbGxlY3Rpb24sIGFzIG5lY2Vzc2FyeS4gU2ltaWxhciB0byAqKk1vZGVsI3NldCoqLAogICAgLy8gdGhlIGNvcmUgb3BlcmF0aW9uIGZvciB1cGRhdGluZyB0aGUgZGF0YSBjb250YWluZWQgYnkgdGhlIGNvbGxlY3Rpb24uCiAgICBzZXQ6IGZ1bmN0aW9uIChtb2RlbHMsIG9wdGlvbnMpIHsKICAgICAgb3B0aW9ucyA9IF8uZGVmYXVsdHMoe30sIG9wdGlvbnMsIHNldE9wdGlvbnMpOwogICAgICBpZiAob3B0aW9ucy5wYXJzZSkKICAgICAgICBtb2RlbHMgPSB0aGlzLnBhcnNlKG1vZGVscywgb3B0aW9ucyk7CiAgICAgIHZhciBzaW5ndWxhciA9ICFfLmlzQXJyYXkobW9kZWxzKTsKICAgICAgbW9kZWxzID0gc2luZ3VsYXIgPyBtb2RlbHMgPyBbbW9kZWxzXSA6IFtdIDogXy5jbG9uZShtb2RlbHMpOwogICAgICB2YXIgaSwgbCwgaWQsIG1vZGVsLCBhdHRycywgZXhpc3RpbmcsIHNvcnQ7CiAgICAgIHZhciBhdCA9IG9wdGlvbnMuYXQ7CiAgICAgIHZhciB0YXJnZXRNb2RlbCA9IHRoaXMubW9kZWw7CiAgICAgIHZhciBzb3J0YWJsZSA9IHRoaXMuY29tcGFyYXRvciAmJiBhdCA9PSBudWxsICYmIG9wdGlvbnMuc29ydCAhPT0gZmFsc2U7CiAgICAgIHZhciBzb3J0QXR0ciA9IF8uaXNTdHJpbmcodGhpcy5jb21wYXJhdG9yKSA/IHRoaXMuY29tcGFyYXRvciA6IG51bGw7CiAgICAgIHZhciB0b0FkZCA9IFtdLCB0b1JlbW92ZSA9IFtdLCBtb2RlbE1hcCA9IHt9OwogICAgICB2YXIgYWRkID0gb3B0aW9ucy5hZGQsIG1lcmdlID0gb3B0aW9ucy5tZXJnZSwgcmVtb3ZlID0gb3B0aW9ucy5yZW1vdmU7CiAgICAgIHZhciBvcmRlciA9ICFzb3J0YWJsZSAmJiBhZGQgJiYgcmVtb3ZlID8gW10gOiBmYWxzZTsKICAgICAgLy8gVHVybiBiYXJlIG9iamVjdHMgaW50byBtb2RlbCByZWZlcmVuY2VzLCBhbmQgcHJldmVudCBpbnZhbGlkIG1vZGVscwogICAgICAvLyBmcm9tIGJlaW5nIGFkZGVkLgogICAgICBmb3IgKGkgPSAwLCBsID0gbW9kZWxzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgIGF0dHJzID0gbW9kZWxzW2ldIHx8IHt9OwogICAgICAgIGlmIChhdHRycyBpbnN0YW5jZW9mIE1vZGVsKSB7CiAgICAgICAgICBpZCA9IG1vZGVsID0gYXR0cnM7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlkID0gYXR0cnNbdGFyZ2V0TW9kZWwucHJvdG90eXBlLmlkQXR0cmlidXRlIHx8ICdpZCddOwogICAgICAgIH0KICAgICAgICAvLyBJZiBhIGR1cGxpY2F0ZSBpcyBmb3VuZCwgcHJldmVudCBpdCBmcm9tIGJlaW5nIGFkZGVkIGFuZAogICAgICAgIC8vIG9wdGlvbmFsbHkgbWVyZ2UgaXQgaW50byB0aGUgZXhpc3RpbmcgbW9kZWwuCiAgICAgICAgaWYgKGV4aXN0aW5nID0gdGhpcy5nZXQoaWQpKSB7CiAgICAgICAgICBpZiAocmVtb3ZlKQogICAgICAgICAgICBtb2RlbE1hcFtleGlzdGluZy5jaWRdID0gdHJ1ZTsKICAgICAgICAgIGlmIChtZXJnZSkgewogICAgICAgICAgICBhdHRycyA9IGF0dHJzID09PSBtb2RlbCA/IG1vZGVsLmF0dHJpYnV0ZXMgOiBhdHRyczsKICAgICAgICAgICAgaWYgKG9wdGlvbnMucGFyc2UpCiAgICAgICAgICAgICAgYXR0cnMgPSBleGlzdGluZy5wYXJzZShhdHRycywgb3B0aW9ucyk7CiAgICAgICAgICAgIGV4aXN0aW5nLnNldChhdHRycywgb3B0aW9ucyk7CiAgICAgICAgICAgIGlmIChzb3J0YWJsZSAmJiAhc29ydCAmJiBleGlzdGluZy5oYXNDaGFuZ2VkKHNvcnRBdHRyKSkKICAgICAgICAgICAgICBzb3J0ID0gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICAgIG1vZGVsc1tpXSA9IGV4aXN0aW5nOyAgLy8gSWYgdGhpcyBpcyBhIG5ldywgdmFsaWQgbW9kZWwsIHB1c2ggaXQgdG8gdGhlIGB0b0FkZGAgbGlzdC4KICAgICAgICB9IGVsc2UgaWYgKGFkZCkgewogICAgICAgICAgbW9kZWwgPSBtb2RlbHNbaV0gPSB0aGlzLl9wcmVwYXJlTW9kZWwoYXR0cnMsIG9wdGlvbnMpOwogICAgICAgICAgaWYgKCFtb2RlbCkKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICB0b0FkZC5wdXNoKG1vZGVsKTsKICAgICAgICAgIHRoaXMuX2FkZFJlZmVyZW5jZShtb2RlbCwgb3B0aW9ucyk7CiAgICAgICAgfQogICAgICAgIC8vIERvIG5vdCBhZGQgbXVsdGlwbGUgbW9kZWxzIHdpdGggdGhlIHNhbWUgYGlkYC4KICAgICAgICBtb2RlbCA9IGV4aXN0aW5nIHx8IG1vZGVsOwogICAgICAgIGlmIChvcmRlciAmJiAobW9kZWwuaXNOZXcoKSB8fCAhbW9kZWxNYXBbbW9kZWwuaWRdKSkKICAgICAgICAgIG9yZGVyLnB1c2gobW9kZWwpOwogICAgICAgIG1vZGVsTWFwW21vZGVsLmlkXSA9IHRydWU7CiAgICAgIH0KICAgICAgLy8gUmVtb3ZlIG5vbmV4aXN0ZW50IG1vZGVscyBpZiBhcHByb3ByaWF0ZS4KICAgICAgaWYgKHJlbW92ZSkgewogICAgICAgIGZvciAoaSA9IDAsIGwgPSB0aGlzLmxlbmd0aDsgaSA8IGw7ICsraSkgewogICAgICAgICAgaWYgKCFtb2RlbE1hcFsobW9kZWwgPSB0aGlzLm1vZGVsc1tpXSkuY2lkXSkKICAgICAgICAgICAgdG9SZW1vdmUucHVzaChtb2RlbCk7CiAgICAgICAgfQogICAgICAgIGlmICh0b1JlbW92ZS5sZW5ndGgpCiAgICAgICAgICB0aGlzLnJlbW92ZSh0b1JlbW92ZSwgb3B0aW9ucyk7CiAgICAgIH0KICAgICAgLy8gU2VlIGlmIHNvcnRpbmcgaXMgbmVlZGVkLCB1cGRhdGUgYGxlbmd0aGAgYW5kIHNwbGljZSBpbiBuZXcgbW9kZWxzLgogICAgICBpZiAodG9BZGQubGVuZ3RoIHx8IG9yZGVyICYmIG9yZGVyLmxlbmd0aCkgewogICAgICAgIGlmIChzb3J0YWJsZSkKICAgICAgICAgIHNvcnQgPSB0cnVlOwogICAgICAgIHRoaXMubGVuZ3RoICs9IHRvQWRkLmxlbmd0aDsKICAgICAgICBpZiAoYXQgIT0gbnVsbCkgewogICAgICAgICAgZm9yIChpID0gMCwgbCA9IHRvQWRkLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgICB0aGlzLm1vZGVscy5zcGxpY2UoYXQgKyBpLCAwLCB0b0FkZFtpXSk7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlmIChvcmRlcikKICAgICAgICAgICAgdGhpcy5tb2RlbHMubGVuZ3RoID0gMDsKICAgICAgICAgIHZhciBvcmRlcmVkTW9kZWxzID0gb3JkZXIgfHwgdG9BZGQ7CiAgICAgICAgICBmb3IgKGkgPSAwLCBsID0gb3JkZXJlZE1vZGVscy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgICAgdGhpcy5tb2RlbHMucHVzaChvcmRlcmVkTW9kZWxzW2ldKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgLy8gU2lsZW50bHkgc29ydCB0aGUgY29sbGVjdGlvbiBpZiBhcHByb3ByaWF0ZS4KICAgICAgaWYgKHNvcnQpCiAgICAgICAgdGhpcy5zb3J0KHsgc2lsZW50OiB0cnVlIH0pOwogICAgICAvLyBVbmxlc3Mgc2lsZW5jZWQsIGl0J3MgdGltZSB0byBmaXJlIGFsbCBhcHByb3ByaWF0ZSBhZGQvc29ydCBldmVudHMuCiAgICAgIGlmICghb3B0aW9ucy5zaWxlbnQpIHsKICAgICAgICBmb3IgKGkgPSAwLCBsID0gdG9BZGQubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgICAobW9kZWwgPSB0b0FkZFtpXSkudHJpZ2dlcignYWRkJywgbW9kZWwsIHRoaXMsIG9wdGlvbnMpOwogICAgICAgIH0KICAgICAgICBpZiAoc29ydCB8fCBvcmRlciAmJiBvcmRlci5sZW5ndGgpCiAgICAgICAgICB0aGlzLnRyaWdnZXIoJ3NvcnQnLCB0aGlzLCBvcHRpb25zKTsKICAgICAgfQogICAgICAvLyBSZXR1cm4gdGhlIGFkZGVkIChvciBtZXJnZWQpIG1vZGVsIChvciBtb2RlbHMpLgogICAgICByZXR1cm4gc2luZ3VsYXIgPyBtb2RlbHNbMF0gOiBtb2RlbHM7CiAgICB9LAogICAgLy8gV2hlbiB5b3UgaGF2ZSBtb3JlIGl0ZW1zIHRoYW4geW91IHdhbnQgdG8gYWRkIG9yIHJlbW92ZSBpbmRpdmlkdWFsbHksCiAgICAvLyB5b3UgY2FuIHJlc2V0IHRoZSBlbnRpcmUgc2V0IHdpdGggYSBuZXcgbGlzdCBvZiBtb2RlbHMsIHdpdGhvdXQgZmlyaW5nCiAgICAvLyBhbnkgZ3JhbnVsYXIgYGFkZGAgb3IgYHJlbW92ZWAgZXZlbnRzLiBGaXJlcyBgcmVzZXRgIHdoZW4gZmluaXNoZWQuCiAgICAvLyBVc2VmdWwgZm9yIGJ1bGsgb3BlcmF0aW9ucyBhbmQgb3B0aW1pemF0aW9ucy4KICAgIHJlc2V0OiBmdW5jdGlvbiAobW9kZWxzLCBvcHRpb25zKSB7CiAgICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CiAgICAgIGZvciAodmFyIGkgPSAwLCBsID0gdGhpcy5tb2RlbHMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgdGhpcy5fcmVtb3ZlUmVmZXJlbmNlKHRoaXMubW9kZWxzW2ldLCBvcHRpb25zKTsKICAgICAgfQogICAgICBvcHRpb25zLnByZXZpb3VzTW9kZWxzID0gdGhpcy5tb2RlbHM7CiAgICAgIHRoaXMuX3Jlc2V0KCk7CiAgICAgIG1vZGVscyA9IHRoaXMuYWRkKG1vZGVscywgXy5leHRlbmQoeyBzaWxlbnQ6IHRydWUgfSwgb3B0aW9ucykpOwogICAgICBpZiAoIW9wdGlvbnMuc2lsZW50KQogICAgICAgIHRoaXMudHJpZ2dlcigncmVzZXQnLCB0aGlzLCBvcHRpb25zKTsKICAgICAgcmV0dXJuIG1vZGVsczsKICAgIH0sCiAgICAvLyBBZGQgYSBtb2RlbCB0byB0aGUgZW5kIG9mIHRoZSBjb2xsZWN0aW9uLgogICAgcHVzaDogZnVuY3Rpb24gKG1vZGVsLCBvcHRpb25zKSB7CiAgICAgIHJldHVybiB0aGlzLmFkZChtb2RlbCwgXy5leHRlbmQoeyBhdDogdGhpcy5sZW5ndGggfSwgb3B0aW9ucykpOwogICAgfSwKICAgIC8vIFJlbW92ZSBhIG1vZGVsIGZyb20gdGhlIGVuZCBvZiB0aGUgY29sbGVjdGlvbi4KICAgIHBvcDogZnVuY3Rpb24gKG9wdGlvbnMpIHsKICAgICAgdmFyIG1vZGVsID0gdGhpcy5hdCh0aGlzLmxlbmd0aCAtIDEpOwogICAgICB0aGlzLnJlbW92ZShtb2RlbCwgb3B0aW9ucyk7CiAgICAgIHJldHVybiBtb2RlbDsKICAgIH0sCiAgICAvLyBBZGQgYSBtb2RlbCB0byB0aGUgYmVnaW5uaW5nIG9mIHRoZSBjb2xsZWN0aW9uLgogICAgdW5zaGlmdDogZnVuY3Rpb24gKG1vZGVsLCBvcHRpb25zKSB7CiAgICAgIHJldHVybiB0aGlzLmFkZChtb2RlbCwgXy5leHRlbmQoeyBhdDogMCB9LCBvcHRpb25zKSk7CiAgICB9LAogICAgLy8gUmVtb3ZlIGEgbW9kZWwgZnJvbSB0aGUgYmVnaW5uaW5nIG9mIHRoZSBjb2xsZWN0aW9uLgogICAgc2hpZnQ6IGZ1bmN0aW9uIChvcHRpb25zKSB7CiAgICAgIHZhciBtb2RlbCA9IHRoaXMuYXQoMCk7CiAgICAgIHRoaXMucmVtb3ZlKG1vZGVsLCBvcHRpb25zKTsKICAgICAgcmV0dXJuIG1vZGVsOwogICAgfSwKICAgIC8vIFNsaWNlIG91dCBhIHN1Yi1hcnJheSBvZiBtb2RlbHMgZnJvbSB0aGUgY29sbGVjdGlvbi4KICAgIHNsaWNlOiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBzbGljZS5hcHBseSh0aGlzLm1vZGVscywgYXJndW1lbnRzKTsKICAgIH0sCiAgICAvLyBHZXQgYSBtb2RlbCBmcm9tIHRoZSBzZXQgYnkgaWQuCiAgICBnZXQ6IGZ1bmN0aW9uIChvYmopIHsKICAgICAgaWYgKG9iaiA9PSBudWxsKQogICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgIHJldHVybiB0aGlzLl9ieUlkW29ial0gfHwgdGhpcy5fYnlJZFtvYmouaWRdIHx8IHRoaXMuX2J5SWRbb2JqLmNpZF07CiAgICB9LAogICAgLy8gR2V0IHRoZSBtb2RlbCBhdCB0aGUgZ2l2ZW4gaW5kZXguCiAgICBhdDogZnVuY3Rpb24gKGluZGV4KSB7CiAgICAgIHJldHVybiB0aGlzLm1vZGVsc1tpbmRleF07CiAgICB9LAogICAgLy8gUmV0dXJuIG1vZGVscyB3aXRoIG1hdGNoaW5nIGF0dHJpYnV0ZXMuIFVzZWZ1bCBmb3Igc2ltcGxlIGNhc2VzIG9mCiAgICAvLyBgZmlsdGVyYC4KICAgIHdoZXJlOiBmdW5jdGlvbiAoYXR0cnMsIGZpcnN0KSB7CiAgICAgIGlmIChfLmlzRW1wdHkoYXR0cnMpKQogICAgICAgIHJldHVybiBmaXJzdCA/IHZvaWQgMCA6IFtdOwogICAgICByZXR1cm4gdGhpc1tmaXJzdCA/ICdmaW5kJyA6ICdmaWx0ZXInXShmdW5jdGlvbiAobW9kZWwpIHsKICAgICAgICBmb3IgKHZhciBrZXkgaW4gYXR0cnMpIHsKICAgICAgICAgIGlmIChhdHRyc1trZXldICE9PSBtb2RlbC5nZXQoa2V5KSkKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfSk7CiAgICB9LAogICAgLy8gUmV0dXJuIHRoZSBmaXJzdCBtb2RlbCB3aXRoIG1hdGNoaW5nIGF0dHJpYnV0ZXMuIFVzZWZ1bCBmb3Igc2ltcGxlIGNhc2VzCiAgICAvLyBvZiBgZmluZGAuCiAgICBmaW5kV2hlcmU6IGZ1bmN0aW9uIChhdHRycykgewogICAgICByZXR1cm4gdGhpcy53aGVyZShhdHRycywgdHJ1ZSk7CiAgICB9LAogICAgLy8gRm9yY2UgdGhlIGNvbGxlY3Rpb24gdG8gcmUtc29ydCBpdHNlbGYuIFlvdSBkb24ndCBuZWVkIHRvIGNhbGwgdGhpcyB1bmRlcgogICAgLy8gbm9ybWFsIGNpcmN1bXN0YW5jZXMsIGFzIHRoZSBzZXQgd2lsbCBtYWludGFpbiBzb3J0IG9yZGVyIGFzIGVhY2ggaXRlbQogICAgLy8gaXMgYWRkZWQuCiAgICBzb3J0OiBmdW5jdGlvbiAob3B0aW9ucykgewogICAgICBpZiAoIXRoaXMuY29tcGFyYXRvcikKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0Nhbm5vdCBzb3J0IGEgc2V0IHdpdGhvdXQgYSBjb21wYXJhdG9yJyk7CiAgICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CiAgICAgIC8vIFJ1biBzb3J0IGJhc2VkIG9uIHR5cGUgb2YgYGNvbXBhcmF0b3JgLgogICAgICBpZiAoXy5pc1N0cmluZyh0aGlzLmNvbXBhcmF0b3IpIHx8IHRoaXMuY29tcGFyYXRvci5sZW5ndGggPT09IDEpIHsKICAgICAgICB0aGlzLm1vZGVscyA9IHRoaXMuc29ydEJ5KHRoaXMuY29tcGFyYXRvciwgdGhpcyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5tb2RlbHMuc29ydChfLmJpbmQodGhpcy5jb21wYXJhdG9yLCB0aGlzKSk7CiAgICAgIH0KICAgICAgaWYgKCFvcHRpb25zLnNpbGVudCkKICAgICAgICB0aGlzLnRyaWdnZXIoJ3NvcnQnLCB0aGlzLCBvcHRpb25zKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogICAgLy8gUGx1Y2sgYW4gYXR0cmlidXRlIGZyb20gZWFjaCBtb2RlbCBpbiB0aGUgY29sbGVjdGlvbi4KICAgIHBsdWNrOiBmdW5jdGlvbiAoYXR0cikgewogICAgICByZXR1cm4gXy5pbnZva2UodGhpcy5tb2RlbHMsICdnZXQnLCBhdHRyKTsKICAgIH0sCiAgICAvLyBGZXRjaCB0aGUgZGVmYXVsdCBzZXQgb2YgbW9kZWxzIGZvciB0aGlzIGNvbGxlY3Rpb24sIHJlc2V0dGluZyB0aGUKICAgIC8vIGNvbGxlY3Rpb24gd2hlbiB0aGV5IGFycml2ZS4gSWYgYHJlc2V0OiB0cnVlYCBpcyBwYXNzZWQsIHRoZSByZXNwb25zZQogICAgLy8gZGF0YSB3aWxsIGJlIHBhc3NlZCB0aHJvdWdoIHRoZSBgcmVzZXRgIG1ldGhvZCBpbnN0ZWFkIG9mIGBzZXRgLgogICAgZmV0Y2g6IGZ1bmN0aW9uIChvcHRpb25zKSB7CiAgICAgIG9wdGlvbnMgPSBvcHRpb25zID8gXy5jbG9uZShvcHRpb25zKSA6IHt9OwogICAgICBpZiAob3B0aW9ucy5wYXJzZSA9PT0gdm9pZCAwKQogICAgICAgIG9wdGlvbnMucGFyc2UgPSB0cnVlOwogICAgICB2YXIgc3VjY2VzcyA9IG9wdGlvbnMuc3VjY2VzczsKICAgICAgdmFyIGNvbGxlY3Rpb24gPSB0aGlzOwogICAgICBvcHRpb25zLnN1Y2Nlc3MgPSBmdW5jdGlvbiAocmVzcCkgewogICAgICAgIHZhciBtZXRob2QgPSBvcHRpb25zLnJlc2V0ID8gJ3Jlc2V0JyA6ICdzZXQnOwogICAgICAgIGNvbGxlY3Rpb25bbWV0aG9kXShyZXNwLCBvcHRpb25zKTsKICAgICAgICBpZiAoc3VjY2VzcykKICAgICAgICAgIHN1Y2Nlc3MoY29sbGVjdGlvbiwgcmVzcCwgb3B0aW9ucyk7CiAgICAgICAgY29sbGVjdGlvbi50cmlnZ2VyKCdzeW5jJywgY29sbGVjdGlvbiwgcmVzcCwgb3B0aW9ucyk7CiAgICAgIH07CiAgICAgIHdyYXBFcnJvcih0aGlzLCBvcHRpb25zKTsKICAgICAgcmV0dXJuIHRoaXMuc3luYygncmVhZCcsIHRoaXMsIG9wdGlvbnMpOwogICAgfSwKICAgIC8vIENyZWF0ZSBhIG5ldyBpbnN0YW5jZSBvZiBhIG1vZGVsIGluIHRoaXMgY29sbGVjdGlvbi4gQWRkIHRoZSBtb2RlbCB0byB0aGUKICAgIC8vIGNvbGxlY3Rpb24gaW1tZWRpYXRlbHksIHVubGVzcyBgd2FpdDogdHJ1ZWAgaXMgcGFzc2VkLCBpbiB3aGljaCBjYXNlIHdlCiAgICAvLyB3YWl0IGZvciB0aGUgc2VydmVyIHRvIGFncmVlLgogICAgY3JlYXRlOiBmdW5jdGlvbiAobW9kZWwsIG9wdGlvbnMpIHsKICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgPyBfLmNsb25lKG9wdGlvbnMpIDoge307CiAgICAgIGlmICghKG1vZGVsID0gdGhpcy5fcHJlcGFyZU1vZGVsKG1vZGVsLCBvcHRpb25zKSkpCiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICBpZiAoIW9wdGlvbnMud2FpdCkKICAgICAgICB0aGlzLmFkZChtb2RlbCwgb3B0aW9ucyk7CiAgICAgIHZhciBjb2xsZWN0aW9uID0gdGhpczsKICAgICAgdmFyIHN1Y2Nlc3MgPSBvcHRpb25zLnN1Y2Nlc3M7CiAgICAgIG9wdGlvbnMuc3VjY2VzcyA9IGZ1bmN0aW9uIChtb2RlbCwgcmVzcCkgewogICAgICAgIGlmIChvcHRpb25zLndhaXQpCiAgICAgICAgICBjb2xsZWN0aW9uLmFkZChtb2RlbCwgb3B0aW9ucyk7CiAgICAgICAgaWYgKHN1Y2Nlc3MpCiAgICAgICAgICBzdWNjZXNzKG1vZGVsLCByZXNwLCBvcHRpb25zKTsKICAgICAgfTsKICAgICAgbW9kZWwuc2F2ZShudWxsLCBvcHRpb25zKTsKICAgICAgcmV0dXJuIG1vZGVsOwogICAgfSwKICAgIC8vICoqcGFyc2UqKiBjb252ZXJ0cyBhIHJlc3BvbnNlIGludG8gYSBsaXN0IG9mIG1vZGVscyB0byBiZSBhZGRlZCB0byB0aGUKICAgIC8vIGNvbGxlY3Rpb24uIFRoZSBkZWZhdWx0IGltcGxlbWVudGF0aW9uIGlzIGp1c3QgdG8gcGFzcyBpdCB0aHJvdWdoLgogICAgcGFyc2U6IGZ1bmN0aW9uIChyZXNwLCBvcHRpb25zKSB7CiAgICAgIHJldHVybiByZXNwOwogICAgfSwKICAgIC8vIENyZWF0ZSBhIG5ldyBjb2xsZWN0aW9uIHdpdGggYW4gaWRlbnRpY2FsIGxpc3Qgb2YgbW9kZWxzIGFzIHRoaXMgb25lLgogICAgY2xvbmU6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIG5ldyB0aGlzLmNvbnN0cnVjdG9yKHRoaXMubW9kZWxzKTsKICAgIH0sCiAgICAvLyBQcml2YXRlIG1ldGhvZCB0byByZXNldCBhbGwgaW50ZXJuYWwgc3RhdGUuIENhbGxlZCB3aGVuIHRoZSBjb2xsZWN0aW9uCiAgICAvLyBpcyBmaXJzdCBpbml0aWFsaXplZCBvciByZXNldC4KICAgIF9yZXNldDogZnVuY3Rpb24gKCkgewogICAgICB0aGlzLmxlbmd0aCA9IDA7CiAgICAgIHRoaXMubW9kZWxzID0gW107CiAgICAgIHRoaXMuX2J5SWQgPSB7fTsKICAgIH0sCiAgICAvLyBQcmVwYXJlIGEgaGFzaCBvZiBhdHRyaWJ1dGVzIChvciBvdGhlciBtb2RlbCkgdG8gYmUgYWRkZWQgdG8gdGhpcwogICAgLy8gY29sbGVjdGlvbi4KICAgIF9wcmVwYXJlTW9kZWw6IGZ1bmN0aW9uIChhdHRycywgb3B0aW9ucykgewogICAgICBpZiAoYXR0cnMgaW5zdGFuY2VvZiBNb2RlbCkKICAgICAgICByZXR1cm4gYXR0cnM7CiAgICAgIG9wdGlvbnMgPSBvcHRpb25zID8gXy5jbG9uZShvcHRpb25zKSA6IHt9OwogICAgICBvcHRpb25zLmNvbGxlY3Rpb24gPSB0aGlzOwogICAgICB2YXIgbW9kZWwgPSBuZXcgdGhpcy5tb2RlbChhdHRycywgb3B0aW9ucyk7CiAgICAgIGlmICghbW9kZWwudmFsaWRhdGlvbkVycm9yKQogICAgICAgIHJldHVybiBtb2RlbDsKICAgICAgdGhpcy50cmlnZ2VyKCdpbnZhbGlkJywgdGhpcywgbW9kZWwudmFsaWRhdGlvbkVycm9yLCBvcHRpb25zKTsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfSwKICAgIC8vIEludGVybmFsIG1ldGhvZCB0byBjcmVhdGUgYSBtb2RlbCdzIHRpZXMgdG8gYSBjb2xsZWN0aW9uLgogICAgX2FkZFJlZmVyZW5jZTogZnVuY3Rpb24gKG1vZGVsLCBvcHRpb25zKSB7CiAgICAgIHRoaXMuX2J5SWRbbW9kZWwuY2lkXSA9IG1vZGVsOwogICAgICBpZiAobW9kZWwuaWQgIT0gbnVsbCkKICAgICAgICB0aGlzLl9ieUlkW21vZGVsLmlkXSA9IG1vZGVsOwogICAgICBpZiAoIW1vZGVsLmNvbGxlY3Rpb24pCiAgICAgICAgbW9kZWwuY29sbGVjdGlvbiA9IHRoaXM7CiAgICAgIG1vZGVsLm9uKCdhbGwnLCB0aGlzLl9vbk1vZGVsRXZlbnQsIHRoaXMpOwogICAgfSwKICAgIC8vIEludGVybmFsIG1ldGhvZCB0byBzZXZlciBhIG1vZGVsJ3MgdGllcyB0byBhIGNvbGxlY3Rpb24uCiAgICBfcmVtb3ZlUmVmZXJlbmNlOiBmdW5jdGlvbiAobW9kZWwsIG9wdGlvbnMpIHsKICAgICAgaWYgKHRoaXMgPT09IG1vZGVsLmNvbGxlY3Rpb24pCiAgICAgICAgZGVsZXRlIG1vZGVsLmNvbGxlY3Rpb247CiAgICAgIG1vZGVsLm9mZignYWxsJywgdGhpcy5fb25Nb2RlbEV2ZW50LCB0aGlzKTsKICAgIH0sCiAgICAvLyBJbnRlcm5hbCBtZXRob2QgY2FsbGVkIGV2ZXJ5IHRpbWUgYSBtb2RlbCBpbiB0aGUgc2V0IGZpcmVzIGFuIGV2ZW50LgogICAgLy8gU2V0cyBuZWVkIHRvIHVwZGF0ZSB0aGVpciBpbmRleGVzIHdoZW4gbW9kZWxzIGNoYW5nZSBpZHMuIEFsbCBvdGhlcgogICAgLy8gZXZlbnRzIHNpbXBseSBwcm94eSB0aHJvdWdoLiAiYWRkIiBhbmQgInJlbW92ZSIgZXZlbnRzIHRoYXQgb3JpZ2luYXRlCiAgICAvLyBpbiBvdGhlciBjb2xsZWN0aW9ucyBhcmUgaWdub3JlZC4KICAgIF9vbk1vZGVsRXZlbnQ6IGZ1bmN0aW9uIChldmVudCwgbW9kZWwsIGNvbGxlY3Rpb24sIG9wdGlvbnMpIHsKICAgICAgaWYgKChldmVudCA9PT0gJ2FkZCcgfHwgZXZlbnQgPT09ICdyZW1vdmUnKSAmJiBjb2xsZWN0aW9uICE9PSB0aGlzKQogICAgICAgIHJldHVybjsKICAgICAgaWYgKGV2ZW50ID09PSAnZGVzdHJveScpCiAgICAgICAgdGhpcy5yZW1vdmUobW9kZWwsIG9wdGlvbnMpOwogICAgICBpZiAobW9kZWwgJiYgZXZlbnQgPT09ICdjaGFuZ2U6JyArIG1vZGVsLmlkQXR0cmlidXRlKSB7CiAgICAgICAgZGVsZXRlIHRoaXMuX2J5SWRbbW9kZWwucHJldmlvdXMobW9kZWwuaWRBdHRyaWJ1dGUpXTsKICAgICAgICBpZiAobW9kZWwuaWQgIT0gbnVsbCkKICAgICAgICAgIHRoaXMuX2J5SWRbbW9kZWwuaWRdID0gbW9kZWw7CiAgICAgIH0KICAgICAgdGhpcy50cmlnZ2VyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9CiAgfSk7CiAgLy8gVW5kZXJzY29yZSBtZXRob2RzIHRoYXQgd2Ugd2FudCB0byBpbXBsZW1lbnQgb24gdGhlIENvbGxlY3Rpb24uCiAgLy8gOTAlIG9mIHRoZSBjb3JlIHVzZWZ1bG5lc3Mgb2YgQmFja2JvbmUgQ29sbGVjdGlvbnMgaXMgYWN0dWFsbHkgaW1wbGVtZW50ZWQKICAvLyByaWdodCBoZXJlOgogIHZhciBtZXRob2RzID0gWwogICAgJ2ZvckVhY2gnLAogICAgJ2VhY2gnLAogICAgJ21hcCcsCiAgICAnY29sbGVjdCcsCiAgICAncmVkdWNlJywKICAgICdmb2xkbCcsCiAgICAnaW5qZWN0JywKICAgICdyZWR1Y2VSaWdodCcsCiAgICAnZm9sZHInLAogICAgJ2ZpbmQnLAogICAgJ2RldGVjdCcsCiAgICAnZmlsdGVyJywKICAgICdzZWxlY3QnLAogICAgJ3JlamVjdCcsCiAgICAnZXZlcnknLAogICAgJ2FsbCcsCiAgICAnc29tZScsCiAgICAnYW55JywKICAgICdpbmNsdWRlJywKICAgICdjb250YWlucycsCiAgICAnaW52b2tlJywKICAgICdtYXgnLAogICAgJ21pbicsCiAgICAndG9BcnJheScsCiAgICAnc2l6ZScsCiAgICAnZmlyc3QnLAogICAgJ2hlYWQnLAogICAgJ3Rha2UnLAogICAgJ2luaXRpYWwnLAogICAgJ3Jlc3QnLAogICAgJ3RhaWwnLAogICAgJ2Ryb3AnLAogICAgJ2xhc3QnLAogICAgJ3dpdGhvdXQnLAogICAgJ2RpZmZlcmVuY2UnLAogICAgJ2luZGV4T2YnLAogICAgJ3NodWZmbGUnLAogICAgJ2xhc3RJbmRleE9mJywKICAgICdpc0VtcHR5JywKICAgICdjaGFpbicsCiAgICAnc2FtcGxlJwogIF07CiAgLy8gTWl4IGluIGVhY2ggVW5kZXJzY29yZSBtZXRob2QgYXMgYSBwcm94eSB0byBgQ29sbGVjdGlvbiNtb2RlbHNgLgogIF8uZWFjaChtZXRob2RzLCBmdW5jdGlvbiAobWV0aG9kKSB7CiAgICBDb2xsZWN0aW9uLnByb3RvdHlwZVttZXRob2RdID0gZnVuY3Rpb24gKCkgewogICAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzKTsKICAgICAgYXJncy51bnNoaWZ0KHRoaXMubW9kZWxzKTsKICAgICAgcmV0dXJuIF9bbWV0aG9kXS5hcHBseShfLCBhcmdzKTsKICAgIH07CiAgfSk7CiAgLy8gVW5kZXJzY29yZSBtZXRob2RzIHRoYXQgdGFrZSBhIHByb3BlcnR5IG5hbWUgYXMgYW4gYXJndW1lbnQuCiAgdmFyIGF0dHJpYnV0ZU1ldGhvZHMgPSBbCiAgICAnZ3JvdXBCeScsCiAgICAnY291bnRCeScsCiAgICAnc29ydEJ5JywKICAgICdpbmRleEJ5JwogIF07CiAgLy8gVXNlIGF0dHJpYnV0ZXMgaW5zdGVhZCBvZiBwcm9wZXJ0aWVzLgogIF8uZWFjaChhdHRyaWJ1dGVNZXRob2RzLCBmdW5jdGlvbiAobWV0aG9kKSB7CiAgICBDb2xsZWN0aW9uLnByb3RvdHlwZVttZXRob2RdID0gZnVuY3Rpb24gKHZhbHVlLCBjb250ZXh0KSB7CiAgICAgIHZhciBpdGVyYXRvciA9IF8uaXNGdW5jdGlvbih2YWx1ZSkgPyB2YWx1ZSA6IGZ1bmN0aW9uIChtb2RlbCkgewogICAgICAgIHJldHVybiBtb2RlbC5nZXQodmFsdWUpOwogICAgICB9OwogICAgICByZXR1cm4gX1ttZXRob2RdKHRoaXMubW9kZWxzLCBpdGVyYXRvciwgY29udGV4dCk7CiAgICB9OwogIH0pOwogIC8vIEJhY2tib25lLlZpZXcKICAvLyAtLS0tLS0tLS0tLS0tCiAgLy8gQmFja2JvbmUgVmlld3MgYXJlIGFsbW9zdCBtb3JlIGNvbnZlbnRpb24gdGhhbiB0aGV5IGFyZSBhY3R1YWwgY29kZS4gQSBWaWV3CiAgLy8gaXMgc2ltcGx5IGEgSmF2YVNjcmlwdCBvYmplY3QgdGhhdCByZXByZXNlbnRzIGEgbG9naWNhbCBjaHVuayBvZiBVSSBpbiB0aGUKICAvLyBET00uIFRoaXMgbWlnaHQgYmUgYSBzaW5nbGUgaXRlbSwgYW4gZW50aXJlIGxpc3QsIGEgc2lkZWJhciBvciBwYW5lbCwgb3IKICAvLyBldmVuIHRoZSBzdXJyb3VuZGluZyBmcmFtZSB3aGljaCB3cmFwcyB5b3VyIHdob2xlIGFwcC4gRGVmaW5pbmcgYSBjaHVuayBvZgogIC8vIFVJIGFzIGEgKipWaWV3KiogYWxsb3dzIHlvdSB0byBkZWZpbmUgeW91ciBET00gZXZlbnRzIGRlY2xhcmF0aXZlbHksIHdpdGhvdXQKICAvLyBoYXZpbmcgdG8gd29ycnkgYWJvdXQgcmVuZGVyIG9yZGVyIC4uLiBhbmQgbWFrZXMgaXQgZWFzeSBmb3IgdGhlIHZpZXcgdG8KICAvLyByZWFjdCB0byBzcGVjaWZpYyBjaGFuZ2VzIGluIHRoZSBzdGF0ZSBvZiB5b3VyIG1vZGVscy4KICAvLyBDcmVhdGluZyBhIEJhY2tib25lLlZpZXcgY3JlYXRlcyBpdHMgaW5pdGlhbCBlbGVtZW50IG91dHNpZGUgb2YgdGhlIERPTSwKICAvLyBpZiBhbiBleGlzdGluZyBlbGVtZW50IGlzIG5vdCBwcm92aWRlZC4uLgogIHZhciBWaWV3ID0gQmFja2JvbmUuVmlldyA9IGZ1bmN0aW9uIChvcHRpb25zKSB7CiAgICB0aGlzLmNpZCA9IF8udW5pcXVlSWQoJ3ZpZXcnKTsKICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CiAgICBfLmV4dGVuZCh0aGlzLCBfLnBpY2sob3B0aW9ucywgdmlld09wdGlvbnMpKTsKICAgIHRoaXMuX2Vuc3VyZUVsZW1lbnQoKTsKICAgIHRoaXMuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgdGhpcy5kZWxlZ2F0ZUV2ZW50cygpOwogIH07CiAgLy8gQ2FjaGVkIHJlZ2V4IHRvIHNwbGl0IGtleXMgZm9yIGBkZWxlZ2F0ZWAuCiAgdmFyIGRlbGVnYXRlRXZlbnRTcGxpdHRlciA9IC9eKFxTKylccyooLiopJC87CiAgLy8gTGlzdCBvZiB2aWV3IG9wdGlvbnMgdG8gYmUgbWVyZ2VkIGFzIHByb3BlcnRpZXMuCiAgdmFyIHZpZXdPcHRpb25zID0gWwogICAgJ21vZGVsJywKICAgICdjb2xsZWN0aW9uJywKICAgICdlbCcsCiAgICAnaWQnLAogICAgJ2F0dHJpYnV0ZXMnLAogICAgJ2NsYXNzTmFtZScsCiAgICAndGFnTmFtZScsCiAgICAnZXZlbnRzJwogIF07CiAgLy8gU2V0IHVwIGFsbCBpbmhlcml0YWJsZSAqKkJhY2tib25lLlZpZXcqKiBwcm9wZXJ0aWVzIGFuZCBtZXRob2RzLgogIF8uZXh0ZW5kKFZpZXcucHJvdG90eXBlLCBFdmVudHMsIHsKICAgIC8vIFRoZSBkZWZhdWx0IGB0YWdOYW1lYCBvZiBhIFZpZXcncyBlbGVtZW50IGlzIGAiZGl2ImAuCiAgICB0YWdOYW1lOiAnZGl2JywKICAgIC8vIGpRdWVyeSBkZWxlZ2F0ZSBmb3IgZWxlbWVudCBsb29rdXAsIHNjb3BlZCB0byBET00gZWxlbWVudHMgd2l0aGluIHRoZQogICAgLy8gY3VycmVudCB2aWV3LiBUaGlzIHNob3VsZCBiZSBwcmVmZXJyZWQgdG8gZ2xvYmFsIGxvb2t1cHMgd2hlcmUgcG9zc2libGUuCiAgICAkOiBmdW5jdGlvbiAoc2VsZWN0b3IpIHsKICAgICAgcmV0dXJuIHRoaXMuJGVsLmZpbmQoc2VsZWN0b3IpOwogICAgfSwKICAgIC8vIEluaXRpYWxpemUgaXMgYW4gZW1wdHkgZnVuY3Rpb24gYnkgZGVmYXVsdC4gT3ZlcnJpZGUgaXQgd2l0aCB5b3VyIG93bgogICAgLy8gaW5pdGlhbGl6YXRpb24gbG9naWMuCiAgICBpbml0aWFsaXplOiBmdW5jdGlvbiAoKSB7CiAgICB9LAogICAgLy8gKipyZW5kZXIqKiBpcyB0aGUgY29yZSBmdW5jdGlvbiB0aGF0IHlvdXIgdmlldyBzaG91bGQgb3ZlcnJpZGUsIGluIG9yZGVyCiAgICAvLyB0byBwb3B1bGF0ZSBpdHMgZWxlbWVudCAoYHRoaXMuZWxgKSwgd2l0aCB0aGUgYXBwcm9wcmlhdGUgSFRNTC4gVGhlCiAgICAvLyBjb252ZW50aW9uIGlzIGZvciAqKnJlbmRlcioqIHRvIGFsd2F5cyByZXR1cm4gYHRoaXNgLgogICAgcmVuZGVyOiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAgIC8vIFJlbW92ZSB0aGlzIHZpZXcgYnkgdGFraW5nIHRoZSBlbGVtZW50IG91dCBvZiB0aGUgRE9NLCBhbmQgcmVtb3ZpbmcgYW55CiAgICAvLyBhcHBsaWNhYmxlIEJhY2tib25lLkV2ZW50cyBsaXN0ZW5lcnMuCiAgICByZW1vdmU6IGZ1bmN0aW9uICgpIHsKICAgICAgdGhpcy4kZWwucmVtb3ZlKCk7CiAgICAgIHRoaXMuc3RvcExpc3RlbmluZygpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgICAvLyBDaGFuZ2UgdGhlIHZpZXcncyBlbGVtZW50IChgdGhpcy5lbGAgcHJvcGVydHkpLCBpbmNsdWRpbmcgZXZlbnQKICAgIC8vIHJlLWRlbGVnYXRpb24uCiAgICBzZXRFbGVtZW50OiBmdW5jdGlvbiAoZWxlbWVudCwgZGVsZWdhdGUpIHsKICAgICAgaWYgKHRoaXMuJGVsKQogICAgICAgIHRoaXMudW5kZWxlZ2F0ZUV2ZW50cygpOwogICAgICB0aGlzLiRlbCA9IGVsZW1lbnQgaW5zdGFuY2VvZiBCYWNrYm9uZS4kID8gZWxlbWVudCA6IEJhY2tib25lLiQoZWxlbWVudCk7CiAgICAgIHRoaXMuZWwgPSB0aGlzLiRlbFswXTsKICAgICAgaWYgKGRlbGVnYXRlICE9PSBmYWxzZSkKICAgICAgICB0aGlzLmRlbGVnYXRlRXZlbnRzKCk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAgIC8vIFNldCBjYWxsYmFja3MsIHdoZXJlIGB0aGlzLmV2ZW50c2AgaXMgYSBoYXNoIG9mCiAgICAvLwogICAgLy8gKnsiZXZlbnQgc2VsZWN0b3IiOiAiY2FsbGJhY2sifSoKICAgIC8vCiAgICAvLyAgICAgewogICAgLy8gICAgICAgJ21vdXNlZG93biAudGl0bGUnOiAgJ2VkaXQnLAogICAgLy8gICAgICAgJ2NsaWNrIC5idXR0b24nOiAgICAgJ3NhdmUnLAogICAgLy8gICAgICAgJ2NsaWNrIC5vcGVuJzogICAgICAgZnVuY3Rpb24oZSkgeyAuLi4gfQogICAgLy8gICAgIH0KICAgIC8vCiAgICAvLyBwYWlycy4gQ2FsbGJhY2tzIHdpbGwgYmUgYm91bmQgdG8gdGhlIHZpZXcsIHdpdGggYHRoaXNgIHNldCBwcm9wZXJseS4KICAgIC8vIFVzZXMgZXZlbnQgZGVsZWdhdGlvbiBmb3IgZWZmaWNpZW5jeS4KICAgIC8vIE9taXR0aW5nIHRoZSBzZWxlY3RvciBiaW5kcyB0aGUgZXZlbnQgdG8gYHRoaXMuZWxgLgogICAgLy8gVGhpcyBvbmx5IHdvcmtzIGZvciBkZWxlZ2F0ZS1hYmxlIGV2ZW50czogbm90IGBmb2N1c2AsIGBibHVyYCwgYW5kCiAgICAvLyBub3QgYGNoYW5nZWAsIGBzdWJtaXRgLCBhbmQgYHJlc2V0YCBpbiBJbnRlcm5ldCBFeHBsb3Jlci4KICAgIGRlbGVnYXRlRXZlbnRzOiBmdW5jdGlvbiAoZXZlbnRzKSB7CiAgICAgIGlmICghKGV2ZW50cyB8fCAoZXZlbnRzID0gXy5yZXN1bHQodGhpcywgJ2V2ZW50cycpKSkpCiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgIHRoaXMudW5kZWxlZ2F0ZUV2ZW50cygpOwogICAgICBmb3IgKHZhciBrZXkgaW4gZXZlbnRzKSB7CiAgICAgICAgdmFyIG1ldGhvZCA9IGV2ZW50c1trZXldOwogICAgICAgIGlmICghXy5pc0Z1bmN0aW9uKG1ldGhvZCkpCiAgICAgICAgICBtZXRob2QgPSB0aGlzW2V2ZW50c1trZXldXTsKICAgICAgICBpZiAoIW1ldGhvZCkKICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIHZhciBtYXRjaCA9IGtleS5tYXRjaChkZWxlZ2F0ZUV2ZW50U3BsaXR0ZXIpOwogICAgICAgIHZhciBldmVudE5hbWUgPSBtYXRjaFsxXSwgc2VsZWN0b3IgPSBtYXRjaFsyXTsKICAgICAgICBtZXRob2QgPSBfLmJpbmQobWV0aG9kLCB0aGlzKTsKICAgICAgICBldmVudE5hbWUgKz0gJy5kZWxlZ2F0ZUV2ZW50cycgKyB0aGlzLmNpZDsKICAgICAgICBpZiAoc2VsZWN0b3IgPT09ICcnKSB7CiAgICAgICAgICB0aGlzLiRlbC5vbihldmVudE5hbWUsIG1ldGhvZCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXMuJGVsLm9uKGV2ZW50TmFtZSwgc2VsZWN0b3IsIG1ldGhvZCk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAgIC8vIENsZWFycyBhbGwgY2FsbGJhY2tzIHByZXZpb3VzbHkgYm91bmQgdG8gdGhlIHZpZXcgd2l0aCBgZGVsZWdhdGVFdmVudHNgLgogICAgLy8gWW91IHVzdWFsbHkgZG9uJ3QgbmVlZCB0byB1c2UgdGhpcywgYnV0IG1heSB3aXNoIHRvIGlmIHlvdSBoYXZlIG11bHRpcGxlCiAgICAvLyBCYWNrYm9uZSB2aWV3cyBhdHRhY2hlZCB0byB0aGUgc2FtZSBET00gZWxlbWVudC4KICAgIHVuZGVsZWdhdGVFdmVudHM6IGZ1bmN0aW9uICgpIHsKICAgICAgdGhpcy4kZWwub2ZmKCcuZGVsZWdhdGVFdmVudHMnICsgdGhpcy5jaWQpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgICAvLyBFbnN1cmUgdGhhdCB0aGUgVmlldyBoYXMgYSBET00gZWxlbWVudCB0byByZW5kZXIgaW50by4KICAgIC8vIElmIGB0aGlzLmVsYCBpcyBhIHN0cmluZywgcGFzcyBpdCB0aHJvdWdoIGAkKClgLCB0YWtlIHRoZSBmaXJzdAogICAgLy8gbWF0Y2hpbmcgZWxlbWVudCwgYW5kIHJlLWFzc2lnbiBpdCB0byBgZWxgLiBPdGhlcndpc2UsIGNyZWF0ZQogICAgLy8gYW4gZWxlbWVudCBmcm9tIHRoZSBgaWRgLCBgY2xhc3NOYW1lYCBhbmQgYHRhZ05hbWVgIHByb3BlcnRpZXMuCiAgICBfZW5zdXJlRWxlbWVudDogZnVuY3Rpb24gKCkgewogICAgICBpZiAoIXRoaXMuZWwpIHsKICAgICAgICB2YXIgYXR0cnMgPSBfLmV4dGVuZCh7fSwgXy5yZXN1bHQodGhpcywgJ2F0dHJpYnV0ZXMnKSk7CiAgICAgICAgaWYgKHRoaXMuaWQpCiAgICAgICAgICBhdHRycy5pZCA9IF8ucmVzdWx0KHRoaXMsICdpZCcpOwogICAgICAgIGlmICh0aGlzLmNsYXNzTmFtZSkKICAgICAgICAgIGF0dHJzWydjbGFzcyddID0gXy5yZXN1bHQodGhpcywgJ2NsYXNzTmFtZScpOwogICAgICAgIHZhciAkZWwgPSBCYWNrYm9uZS4kKCc8JyArIF8ucmVzdWx0KHRoaXMsICd0YWdOYW1lJykgKyAnPicpLmF0dHIoYXR0cnMpOwogICAgICAgIHRoaXMuc2V0RWxlbWVudCgkZWwsIGZhbHNlKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLnNldEVsZW1lbnQoXy5yZXN1bHQodGhpcywgJ2VsJyksIGZhbHNlKTsKICAgICAgfQogICAgfQogIH0pOwogIC8vIEJhY2tib25lLnN5bmMKICAvLyAtLS0tLS0tLS0tLS0tCiAgLy8gT3ZlcnJpZGUgdGhpcyBmdW5jdGlvbiB0byBjaGFuZ2UgdGhlIG1hbm5lciBpbiB3aGljaCBCYWNrYm9uZSBwZXJzaXN0cwogIC8vIG1vZGVscyB0byB0aGUgc2VydmVyLiBZb3Ugd2lsbCBiZSBwYXNzZWQgdGhlIHR5cGUgb2YgcmVxdWVzdCwgYW5kIHRoZQogIC8vIG1vZGVsIGluIHF1ZXN0aW9uLiBCeSBkZWZhdWx0LCBtYWtlcyBhIFJFU1RmdWwgQWpheCByZXF1ZXN0CiAgLy8gdG8gdGhlIG1vZGVsJ3MgYHVybCgpYC4gU29tZSBwb3NzaWJsZSBjdXN0b21pemF0aW9ucyBjb3VsZCBiZToKICAvLwogIC8vICogVXNlIGBzZXRUaW1lb3V0YCB0byBiYXRjaCByYXBpZC1maXJlIHVwZGF0ZXMgaW50byBhIHNpbmdsZSByZXF1ZXN0LgogIC8vICogU2VuZCB1cCB0aGUgbW9kZWxzIGFzIFhNTCBpbnN0ZWFkIG9mIEpTT04uCiAgLy8gKiBQZXJzaXN0IG1vZGVscyB2aWEgV2ViU29ja2V0cyBpbnN0ZWFkIG9mIEFqYXguCiAgLy8KICAvLyBUdXJuIG9uIGBCYWNrYm9uZS5lbXVsYXRlSFRUUGAgaW4gb3JkZXIgdG8gc2VuZCBgUFVUYCBhbmQgYERFTEVURWAgcmVxdWVzdHMKICAvLyBhcyBgUE9TVGAsIHdpdGggYSBgX21ldGhvZGAgcGFyYW1ldGVyIGNvbnRhaW5pbmcgdGhlIHRydWUgSFRUUCBtZXRob2QsCiAgLy8gYXMgd2VsbCBhcyBhbGwgcmVxdWVzdHMgd2l0aCB0aGUgYm9keSBhcyBgYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkYAogIC8vIGluc3RlYWQgb2YgYGFwcGxpY2F0aW9uL2pzb25gIHdpdGggdGhlIG1vZGVsIGluIGEgcGFyYW0gbmFtZWQgYG1vZGVsYC4KICAvLyBVc2VmdWwgd2hlbiBpbnRlcmZhY2luZyB3aXRoIHNlcnZlci1zaWRlIGxhbmd1YWdlcyBsaWtlICoqUEhQKiogdGhhdCBtYWtlCiAgLy8gaXQgZGlmZmljdWx0IHRvIHJlYWQgdGhlIGJvZHkgb2YgYFBVVGAgcmVxdWVzdHMuCiAgQmFja2JvbmUuc3luYyA9IGZ1bmN0aW9uIChtZXRob2QsIG1vZGVsLCBvcHRpb25zKSB7CiAgICB2YXIgdHlwZSA9IG1ldGhvZE1hcFttZXRob2RdOwogICAgLy8gRGVmYXVsdCBvcHRpb25zLCB1bmxlc3Mgc3BlY2lmaWVkLgogICAgXy5kZWZhdWx0cyhvcHRpb25zIHx8IChvcHRpb25zID0ge30pLCB7CiAgICAgIGVtdWxhdGVIVFRQOiBCYWNrYm9uZS5lbXVsYXRlSFRUUCwKICAgICAgZW11bGF0ZUpTT046IEJhY2tib25lLmVtdWxhdGVKU09OCiAgICB9KTsKICAgIC8vIERlZmF1bHQgSlNPTi1yZXF1ZXN0IG9wdGlvbnMuCiAgICB2YXIgcGFyYW1zID0gewogICAgICB0eXBlOiB0eXBlLAogICAgICBkYXRhVHlwZTogJ2pzb24nCiAgICB9OwogICAgLy8gRW5zdXJlIHRoYXQgd2UgaGF2ZSBhIFVSTC4KICAgIGlmICghb3B0aW9ucy51cmwpIHsKICAgICAgcGFyYW1zLnVybCA9IF8ucmVzdWx0KG1vZGVsLCAndXJsJykgfHwgdXJsRXJyb3IoKTsKICAgIH0KICAgIC8vIEVuc3VyZSB0aGF0IHdlIGhhdmUgdGhlIGFwcHJvcHJpYXRlIHJlcXVlc3QgZGF0YS4KICAgIGlmIChvcHRpb25zLmRhdGEgPT0gbnVsbCAmJiBtb2RlbCAmJiAobWV0aG9kID09PSAnY3JlYXRlJyB8fCBtZXRob2QgPT09ICd1cGRhdGUnIHx8IG1ldGhvZCA9PT0gJ3BhdGNoJykpIHsKICAgICAgcGFyYW1zLmNvbnRlbnRUeXBlID0gJ2FwcGxpY2F0aW9uL2pzb24nOwogICAgICBwYXJhbXMuZGF0YSA9IEpTT04uc3RyaW5naWZ5KG9wdGlvbnMuYXR0cnMgfHwgbW9kZWwudG9KU09OKG9wdGlvbnMpKTsKICAgIH0KICAgIC8vIEZvciBvbGRlciBzZXJ2ZXJzLCBlbXVsYXRlIEpTT04gYnkgZW5jb2RpbmcgdGhlIHJlcXVlc3QgaW50byBhbiBIVE1MLWZvcm0uCiAgICBpZiAob3B0aW9ucy5lbXVsYXRlSlNPTikgewogICAgICBwYXJhbXMuY29udGVudFR5cGUgPSAnYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkJzsKICAgICAgcGFyYW1zLmRhdGEgPSBwYXJhbXMuZGF0YSA/IHsgbW9kZWw6IHBhcmFtcy5kYXRhIH0gOiB7fTsKICAgIH0KICAgIC8vIEZvciBvbGRlciBzZXJ2ZXJzLCBlbXVsYXRlIEhUVFAgYnkgbWltaWNraW5nIHRoZSBIVFRQIG1ldGhvZCB3aXRoIGBfbWV0aG9kYAogICAgLy8gQW5kIGFuIGBYLUhUVFAtTWV0aG9kLU92ZXJyaWRlYCBoZWFkZXIuCiAgICBpZiAob3B0aW9ucy5lbXVsYXRlSFRUUCAmJiAodHlwZSA9PT0gJ1BVVCcgfHwgdHlwZSA9PT0gJ0RFTEVURScgfHwgdHlwZSA9PT0gJ1BBVENIJykpIHsKICAgICAgcGFyYW1zLnR5cGUgPSAnUE9TVCc7CiAgICAgIGlmIChvcHRpb25zLmVtdWxhdGVKU09OKQogICAgICAgIHBhcmFtcy5kYXRhLl9tZXRob2QgPSB0eXBlOwogICAgICB2YXIgYmVmb3JlU2VuZCA9IG9wdGlvbnMuYmVmb3JlU2VuZDsKICAgICAgb3B0aW9ucy5iZWZvcmVTZW5kID0gZnVuY3Rpb24gKHhocikgewogICAgICAgIHhoci5zZXRSZXF1ZXN0SGVhZGVyKCdYLUhUVFAtTWV0aG9kLU92ZXJyaWRlJywgdHlwZSk7CiAgICAgICAgaWYgKGJlZm9yZVNlbmQpCiAgICAgICAgICByZXR1cm4gYmVmb3JlU2VuZC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9OwogICAgfQogICAgLy8gRG9uJ3QgcHJvY2VzcyBkYXRhIG9uIGEgbm9uLUdFVCByZXF1ZXN0LgogICAgaWYgKHBhcmFtcy50eXBlICE9PSAnR0VUJyAmJiAhb3B0aW9ucy5lbXVsYXRlSlNPTikgewogICAgICBwYXJhbXMucHJvY2Vzc0RhdGEgPSBmYWxzZTsKICAgIH0KICAgIC8vIElmIHdlJ3JlIHNlbmRpbmcgYSBgUEFUQ0hgIHJlcXVlc3QsIGFuZCB3ZSdyZSBpbiBhbiBvbGQgSW50ZXJuZXQgRXhwbG9yZXIKICAgIC8vIHRoYXQgc3RpbGwgaGFzIEFjdGl2ZVggZW5hYmxlZCBieSBkZWZhdWx0LCBvdmVycmlkZSBqUXVlcnkgdG8gdXNlIHRoYXQKICAgIC8vIGZvciBYSFIgaW5zdGVhZC4gUmVtb3ZlIHRoaXMgbGluZSB3aGVuIGpRdWVyeSBzdXBwb3J0cyBgUEFUQ0hgIG9uIElFOC4KICAgIGlmIChwYXJhbXMudHlwZSA9PT0gJ1BBVENIJyAmJiBub1hoclBhdGNoKSB7CiAgICAgIHBhcmFtcy54aHIgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIG5ldyBBY3RpdmVYT2JqZWN0KCdNaWNyb3NvZnQuWE1MSFRUUCcpOwogICAgICB9OwogICAgfQogICAgLy8gTWFrZSB0aGUgcmVxdWVzdCwgYWxsb3dpbmcgdGhlIHVzZXIgdG8gb3ZlcnJpZGUgYW55IEFqYXggb3B0aW9ucy4KICAgIHZhciB4aHIgPSBvcHRpb25zLnhociA9IEJhY2tib25lLmFqYXgoXy5leHRlbmQocGFyYW1zLCBvcHRpb25zKSk7CiAgICBtb2RlbC50cmlnZ2VyKCdyZXF1ZXN0JywgbW9kZWwsIHhociwgb3B0aW9ucyk7CiAgICByZXR1cm4geGhyOwogIH07CiAgdmFyIG5vWGhyUGF0Y2ggPSB0eXBlb2Ygd2luZG93ICE9PSAndW5kZWZpbmVkJyAmJiAhIXdpbmRvdy5BY3RpdmVYT2JqZWN0ICYmICEod2luZG93LlhNTEh0dHBSZXF1ZXN0ICYmIG5ldyBYTUxIdHRwUmVxdWVzdCgpLmRpc3BhdGNoRXZlbnQpOwogIC8vIE1hcCBmcm9tIENSVUQgdG8gSFRUUCBmb3Igb3VyIGRlZmF1bHQgYEJhY2tib25lLnN5bmNgIGltcGxlbWVudGF0aW9uLgogIHZhciBtZXRob2RNYXAgPSB7CiAgICAnY3JlYXRlJzogJ1BPU1QnLAogICAgJ3VwZGF0ZSc6ICdQVVQnLAogICAgJ3BhdGNoJzogJ1BBVENIJywKICAgICdkZWxldGUnOiAnREVMRVRFJywKICAgICdyZWFkJzogJ0dFVCcKICB9OwogIC8vIFNldCB0aGUgZGVmYXVsdCBpbXBsZW1lbnRhdGlvbiBvZiBgQmFja2JvbmUuYWpheGAgdG8gcHJveHkgdGhyb3VnaCB0byBgJGAuCiAgLy8gT3ZlcnJpZGUgdGhpcyBpZiB5b3UnZCBsaWtlIHRvIHVzZSBhIGRpZmZlcmVudCBsaWJyYXJ5LgogIEJhY2tib25lLmFqYXggPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gQmFja2JvbmUuJC5hamF4LmFwcGx5KEJhY2tib25lLiQsIGFyZ3VtZW50cyk7CiAgfTsKICAvLyBCYWNrYm9uZS5Sb3V0ZXIKICAvLyAtLS0tLS0tLS0tLS0tLS0KICAvLyBSb3V0ZXJzIG1hcCBmYXV4LVVSTHMgdG8gYWN0aW9ucywgYW5kIGZpcmUgZXZlbnRzIHdoZW4gcm91dGVzIGFyZQogIC8vIG1hdGNoZWQuIENyZWF0aW5nIGEgbmV3IG9uZSBzZXRzIGl0cyBgcm91dGVzYCBoYXNoLCBpZiBub3Qgc2V0IHN0YXRpY2FsbHkuCiAgdmFyIFJvdXRlciA9IEJhY2tib25lLlJvdXRlciA9IGZ1bmN0aW9uIChvcHRpb25zKSB7CiAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwogICAgaWYgKG9wdGlvbnMucm91dGVzKQogICAgICB0aGlzLnJvdXRlcyA9IG9wdGlvbnMucm91dGVzOwogICAgdGhpcy5fYmluZFJvdXRlcygpOwogICAgdGhpcy5pbml0aWFsaXplLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgfTsKICAvLyBDYWNoZWQgcmVndWxhciBleHByZXNzaW9ucyBmb3IgbWF0Y2hpbmcgbmFtZWQgcGFyYW0gcGFydHMgYW5kIHNwbGF0dGVkCiAgLy8gcGFydHMgb2Ygcm91dGUgc3RyaW5ncy4KICB2YXIgb3B0aW9uYWxQYXJhbSA9IC9cKCguKj8pXCkvZzsKICB2YXIgbmFtZWRQYXJhbSA9IC8oXChcPyk/Olx3Ky9nOwogIHZhciBzcGxhdFBhcmFtID0gL1wqXHcrL2c7CiAgdmFyIGVzY2FwZVJlZ0V4cCA9IC9bXC17fVxbXF0rPy4sXFxcXiR8I1xzXS9nOwogIC8vIFNldCB1cCBhbGwgaW5oZXJpdGFibGUgKipCYWNrYm9uZS5Sb3V0ZXIqKiBwcm9wZXJ0aWVzIGFuZCBtZXRob2RzLgogIF8uZXh0ZW5kKFJvdXRlci5wcm90b3R5cGUsIEV2ZW50cywgewogICAgLy8gSW5pdGlhbGl6ZSBpcyBhbiBlbXB0eSBmdW5jdGlvbiBieSBkZWZhdWx0LiBPdmVycmlkZSBpdCB3aXRoIHlvdXIgb3duCiAgICAvLyBpbml0aWFsaXphdGlvbiBsb2dpYy4KICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uICgpIHsKICAgIH0sCiAgICAvLyBNYW51YWxseSBiaW5kIGEgc2luZ2xlIG5hbWVkIHJvdXRlIHRvIGEgY2FsbGJhY2suIEZvciBleGFtcGxlOgogICAgLy8KICAgIC8vICAgICB0aGlzLnJvdXRlKCdzZWFyY2gvOnF1ZXJ5L3A6bnVtJywgJ3NlYXJjaCcsIGZ1bmN0aW9uKHF1ZXJ5LCBudW0pIHsKICAgIC8vICAgICAgIC4uLgogICAgLy8gICAgIH0pOwogICAgLy8KICAgIHJvdXRlOiBmdW5jdGlvbiAocm91dGUsIG5hbWUsIGNhbGxiYWNrKSB7CiAgICAgIGlmICghXy5pc1JlZ0V4cChyb3V0ZSkpCiAgICAgICAgcm91dGUgPSB0aGlzLl9yb3V0ZVRvUmVnRXhwKHJvdXRlKTsKICAgICAgaWYgKF8uaXNGdW5jdGlvbihuYW1lKSkgewogICAgICAgIGNhbGxiYWNrID0gbmFtZTsKICAgICAgICBuYW1lID0gJyc7CiAgICAgIH0KICAgICAgaWYgKCFjYWxsYmFjaykKICAgICAgICBjYWxsYmFjayA9IHRoaXNbbmFtZV07CiAgICAgIHZhciByb3V0ZXIgPSB0aGlzOwogICAgICBCYWNrYm9uZS5oaXN0b3J5LnJvdXRlKHJvdXRlLCBmdW5jdGlvbiAoZnJhZ21lbnQpIHsKICAgICAgICB2YXIgYXJncyA9IHJvdXRlci5fZXh0cmFjdFBhcmFtZXRlcnMocm91dGUsIGZyYWdtZW50KTsKICAgICAgICByb3V0ZXIuZXhlY3V0ZShjYWxsYmFjaywgYXJncyk7CiAgICAgICAgcm91dGVyLnRyaWdnZXIuYXBwbHkocm91dGVyLCBbJ3JvdXRlOicgKyBuYW1lXS5jb25jYXQoYXJncykpOwogICAgICAgIHJvdXRlci50cmlnZ2VyKCdyb3V0ZScsIG5hbWUsIGFyZ3MpOwogICAgICAgIEJhY2tib25lLmhpc3RvcnkudHJpZ2dlcigncm91dGUnLCByb3V0ZXIsIG5hbWUsIGFyZ3MpOwogICAgICB9KTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogICAgLy8gRXhlY3V0ZSBhIHJvdXRlIGhhbmRsZXIgd2l0aCB0aGUgcHJvdmlkZWQgcGFyYW1ldGVycy4gIFRoaXMgaXMgYW4KICAgIC8vIGV4Y2VsbGVudCBwbGFjZSB0byBkbyBwcmUtcm91dGUgc2V0dXAgb3IgcG9zdC1yb3V0ZSBjbGVhbnVwLgogICAgZXhlY3V0ZTogZnVuY3Rpb24gKGNhbGxiYWNrLCBhcmdzKSB7CiAgICAgIGlmIChjYWxsYmFjaykKICAgICAgICBjYWxsYmFjay5hcHBseSh0aGlzLCBhcmdzKTsKICAgIH0sCiAgICAvLyBTaW1wbGUgcHJveHkgdG8gYEJhY2tib25lLmhpc3RvcnlgIHRvIHNhdmUgYSBmcmFnbWVudCBpbnRvIHRoZSBoaXN0b3J5LgogICAgbmF2aWdhdGU6IGZ1bmN0aW9uIChmcmFnbWVudCwgb3B0aW9ucykgewogICAgICBCYWNrYm9uZS5oaXN0b3J5Lm5hdmlnYXRlKGZyYWdtZW50LCBvcHRpb25zKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogICAgLy8gQmluZCBhbGwgZGVmaW5lZCByb3V0ZXMgdG8gYEJhY2tib25lLmhpc3RvcnlgLiBXZSBoYXZlIHRvIHJldmVyc2UgdGhlCiAgICAvLyBvcmRlciBvZiB0aGUgcm91dGVzIGhlcmUgdG8gc3VwcG9ydCBiZWhhdmlvciB3aGVyZSB0aGUgbW9zdCBnZW5lcmFsCiAgICAvLyByb3V0ZXMgY2FuIGJlIGRlZmluZWQgYXQgdGhlIGJvdHRvbSBvZiB0aGUgcm91dGUgbWFwLgogICAgX2JpbmRSb3V0ZXM6IGZ1bmN0aW9uICgpIHsKICAgICAgaWYgKCF0aGlzLnJvdXRlcykKICAgICAgICByZXR1cm47CiAgICAgIHRoaXMucm91dGVzID0gXy5yZXN1bHQodGhpcywgJ3JvdXRlcycpOwogICAgICB2YXIgcm91dGUsIHJvdXRlcyA9IF8ua2V5cyh0aGlzLnJvdXRlcyk7CiAgICAgIHdoaWxlICgocm91dGUgPSByb3V0ZXMucG9wKCkpICE9IG51bGwpIHsKICAgICAgICB0aGlzLnJvdXRlKHJvdXRlLCB0aGlzLnJvdXRlc1tyb3V0ZV0pOwogICAgICB9CiAgICB9LAogICAgLy8gQ29udmVydCBhIHJvdXRlIHN0cmluZyBpbnRvIGEgcmVndWxhciBleHByZXNzaW9uLCBzdWl0YWJsZSBmb3IgbWF0Y2hpbmcKICAgIC8vIGFnYWluc3QgdGhlIGN1cnJlbnQgbG9jYXRpb24gaGFzaC4KICAgIF9yb3V0ZVRvUmVnRXhwOiBmdW5jdGlvbiAocm91dGUpIHsKICAgICAgcm91dGUgPSByb3V0ZS5yZXBsYWNlKGVzY2FwZVJlZ0V4cCwgJ1xcJCYnKS5yZXBsYWNlKG9wdGlvbmFsUGFyYW0sICcoPzokMSk/JykucmVwbGFjZShuYW1lZFBhcmFtLCBmdW5jdGlvbiAobWF0Y2gsIG9wdGlvbmFsKSB7CiAgICAgICAgcmV0dXJuIG9wdGlvbmFsID8gbWF0Y2ggOiAnKFteLz9dKyknOwogICAgICB9KS5yZXBsYWNlKHNwbGF0UGFyYW0sICcoW14/XSo/KScpOwogICAgICByZXR1cm4gbmV3IFJlZ0V4cCgnXicgKyByb3V0ZSArICcoPzpcXD8oW1xcc1xcU10qKSk/JCcpOwogICAgfSwKICAgIC8vIEdpdmVuIGEgcm91dGUsIGFuZCBhIFVSTCBmcmFnbWVudCB0aGF0IGl0IG1hdGNoZXMsIHJldHVybiB0aGUgYXJyYXkgb2YKICAgIC8vIGV4dHJhY3RlZCBkZWNvZGVkIHBhcmFtZXRlcnMuIEVtcHR5IG9yIHVubWF0Y2hlZCBwYXJhbWV0ZXJzIHdpbGwgYmUKICAgIC8vIHRyZWF0ZWQgYXMgYG51bGxgIHRvIG5vcm1hbGl6ZSBjcm9zcy1icm93c2VyIGJlaGF2aW9yLgogICAgX2V4dHJhY3RQYXJhbWV0ZXJzOiBmdW5jdGlvbiAocm91dGUsIGZyYWdtZW50KSB7CiAgICAgIHZhciBwYXJhbXMgPSByb3V0ZS5leGVjKGZyYWdtZW50KS5zbGljZSgxKTsKICAgICAgcmV0dXJuIF8ubWFwKHBhcmFtcywgZnVuY3Rpb24gKHBhcmFtLCBpKSB7CiAgICAgICAgLy8gRG9uJ3QgZGVjb2RlIHRoZSBzZWFyY2ggcGFyYW1zLgogICAgICAgIGlmIChpID09PSBwYXJhbXMubGVuZ3RoIC0gMSkKICAgICAgICAgIHJldHVybiBwYXJhbSB8fCBudWxsOwogICAgICAgIHJldHVybiBwYXJhbSA/IGRlY29kZVVSSUNvbXBvbmVudChwYXJhbSkgOiBudWxsOwogICAgICB9KTsKICAgIH0KICB9KTsKICAvLyBCYWNrYm9uZS5IaXN0b3J5CiAgLy8gLS0tLS0tLS0tLS0tLS0tLQogIC8vIEhhbmRsZXMgY3Jvc3MtYnJvd3NlciBoaXN0b3J5IG1hbmFnZW1lbnQsIGJhc2VkIG9uIGVpdGhlcgogIC8vIFtwdXNoU3RhdGVdKGh0dHA6Ly9kaXZlaW50b2h0bWw1LmluZm8vaGlzdG9yeS5odG1sKSBhbmQgcmVhbCBVUkxzLCBvcgogIC8vIFtvbmhhc2hjaGFuZ2VdKGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvRE9NL3dpbmRvdy5vbmhhc2hjaGFuZ2UpCiAgLy8gYW5kIFVSTCBmcmFnbWVudHMuIElmIHRoZSBicm93c2VyIHN1cHBvcnRzIG5laXRoZXIgKG9sZCBJRSwgbmF0Y2gpLAogIC8vIGZhbGxzIGJhY2sgdG8gcG9sbGluZy4KICB2YXIgSGlzdG9yeSA9IEJhY2tib25lLkhpc3RvcnkgPSBmdW5jdGlvbiAoKSB7CiAgICB0aGlzLmhhbmRsZXJzID0gW107CiAgICBfLmJpbmRBbGwodGhpcywgJ2NoZWNrVXJsJyk7CiAgICAvLyBFbnN1cmUgdGhhdCBgSGlzdG9yeWAgY2FuIGJlIHVzZWQgb3V0c2lkZSBvZiB0aGUgYnJvd3Nlci4KICAgIGlmICh0eXBlb2Ygd2luZG93ICE9PSAndW5kZWZpbmVkJykgewogICAgICB0aGlzLmxvY2F0aW9uID0gd2luZG93LmxvY2F0aW9uOwogICAgICB0aGlzLmhpc3RvcnkgPSB3aW5kb3cuaGlzdG9yeTsKICAgIH0KICB9OwogIC8vIENhY2hlZCByZWdleCBmb3Igc3RyaXBwaW5nIGEgbGVhZGluZyBoYXNoL3NsYXNoIGFuZCB0cmFpbGluZyBzcGFjZS4KICB2YXIgcm91dGVTdHJpcHBlciA9IC9eWyNcL118XHMrJC9nOwogIC8vIENhY2hlZCByZWdleCBmb3Igc3RyaXBwaW5nIGxlYWRpbmcgYW5kIHRyYWlsaW5nIHNsYXNoZXMuCiAgdmFyIHJvb3RTdHJpcHBlciA9IC9eXC8rfFwvKyQvZzsKICAvLyBDYWNoZWQgcmVnZXggZm9yIGRldGVjdGluZyBNU0lFLgogIHZhciBpc0V4cGxvcmVyID0gL21zaWUgW1x3Ll0rLzsKICAvLyBDYWNoZWQgcmVnZXggZm9yIHJlbW92aW5nIGEgdHJhaWxpbmcgc2xhc2guCiAgdmFyIHRyYWlsaW5nU2xhc2ggPSAvXC8kLzsKICAvLyBDYWNoZWQgcmVnZXggZm9yIHN0cmlwcGluZyB1cmxzIG9mIGhhc2guCiAgdmFyIHBhdGhTdHJpcHBlciA9IC8jLiokLzsKICAvLyBIYXMgdGhlIGhpc3RvcnkgaGFuZGxpbmcgYWxyZWFkeSBiZWVuIHN0YXJ0ZWQ/CiAgSGlzdG9yeS5zdGFydGVkID0gZmFsc2U7CiAgLy8gU2V0IHVwIGFsbCBpbmhlcml0YWJsZSAqKkJhY2tib25lLkhpc3RvcnkqKiBwcm9wZXJ0aWVzIGFuZCBtZXRob2RzLgogIF8uZXh0ZW5kKEhpc3RvcnkucHJvdG90eXBlLCBFdmVudHMsIHsKICAgIC8vIFRoZSBkZWZhdWx0IGludGVydmFsIHRvIHBvbGwgZm9yIGhhc2ggY2hhbmdlcywgaWYgbmVjZXNzYXJ5LCBpcwogICAgLy8gdHdlbnR5IHRpbWVzIGEgc2Vjb25kLgogICAgaW50ZXJ2YWw6IDUwLAogICAgLy8gQXJlIHdlIGF0IHRoZSBhcHAgcm9vdD8KICAgIGF0Um9vdDogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gdGhpcy5sb2NhdGlvbi5wYXRobmFtZS5yZXBsYWNlKC9bXlwvXSQvLCAnJCYvJykgPT09IHRoaXMucm9vdDsKICAgIH0sCiAgICAvLyBHZXRzIHRoZSB0cnVlIGhhc2ggdmFsdWUuIENhbm5vdCB1c2UgbG9jYXRpb24uaGFzaCBkaXJlY3RseSBkdWUgdG8gYnVnCiAgICAvLyBpbiBGaXJlZm94IHdoZXJlIGxvY2F0aW9uLmhhc2ggd2lsbCBhbHdheXMgYmUgZGVjb2RlZC4KICAgIGdldEhhc2g6IGZ1bmN0aW9uICh3aW5kb3cpIHsKICAgICAgdmFyIG1hdGNoID0gKHdpbmRvdyB8fCB0aGlzKS5sb2NhdGlvbi5ocmVmLm1hdGNoKC8jKC4qKSQvKTsKICAgICAgcmV0dXJuIG1hdGNoID8gbWF0Y2hbMV0gOiAnJzsKICAgIH0sCiAgICAvLyBHZXQgdGhlIGNyb3NzLWJyb3dzZXIgbm9ybWFsaXplZCBVUkwgZnJhZ21lbnQsIGVpdGhlciBmcm9tIHRoZSBVUkwsCiAgICAvLyB0aGUgaGFzaCwgb3IgdGhlIG92ZXJyaWRlLgogICAgZ2V0RnJhZ21lbnQ6IGZ1bmN0aW9uIChmcmFnbWVudCwgZm9yY2VQdXNoU3RhdGUpIHsKICAgICAgaWYgKGZyYWdtZW50ID09IG51bGwpIHsKICAgICAgICBpZiAodGhpcy5faGFzUHVzaFN0YXRlIHx8ICF0aGlzLl93YW50c0hhc2hDaGFuZ2UgfHwgZm9yY2VQdXNoU3RhdGUpIHsKICAgICAgICAgIGZyYWdtZW50ID0gZGVjb2RlVVJJKHRoaXMubG9jYXRpb24ucGF0aG5hbWUgKyB0aGlzLmxvY2F0aW9uLnNlYXJjaCk7CiAgICAgICAgICB2YXIgcm9vdCA9IHRoaXMucm9vdC5yZXBsYWNlKHRyYWlsaW5nU2xhc2gsICcnKTsKICAgICAgICAgIGlmICghZnJhZ21lbnQuaW5kZXhPZihyb290KSkKICAgICAgICAgICAgZnJhZ21lbnQgPSBmcmFnbWVudC5zbGljZShyb290Lmxlbmd0aCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGZyYWdtZW50ID0gdGhpcy5nZXRIYXNoKCk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBmcmFnbWVudC5yZXBsYWNlKHJvdXRlU3RyaXBwZXIsICcnKTsKICAgIH0sCiAgICAvLyBTdGFydCB0aGUgaGFzaCBjaGFuZ2UgaGFuZGxpbmcsIHJldHVybmluZyBgdHJ1ZWAgaWYgdGhlIGN1cnJlbnQgVVJMIG1hdGNoZXMKICAgIC8vIGFuIGV4aXN0aW5nIHJvdXRlLCBhbmQgYGZhbHNlYCBvdGhlcndpc2UuCiAgICBzdGFydDogZnVuY3Rpb24gKG9wdGlvbnMpIHsKICAgICAgaWYgKEhpc3Rvcnkuc3RhcnRlZCkKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0JhY2tib25lLmhpc3RvcnkgaGFzIGFscmVhZHkgYmVlbiBzdGFydGVkJyk7CiAgICAgIEhpc3Rvcnkuc3RhcnRlZCA9IHRydWU7CiAgICAgIC8vIEZpZ3VyZSBvdXQgdGhlIGluaXRpYWwgY29uZmlndXJhdGlvbi4gRG8gd2UgbmVlZCBhbiBpZnJhbWU/CiAgICAgIC8vIElzIHB1c2hTdGF0ZSBkZXNpcmVkIC4uLiBpcyBpdCBhdmFpbGFibGU/CiAgICAgIHRoaXMub3B0aW9ucyA9IF8uZXh0ZW5kKHsgcm9vdDogJy8nIH0sIHRoaXMub3B0aW9ucywgb3B0aW9ucyk7CiAgICAgIHRoaXMucm9vdCA9IHRoaXMub3B0aW9ucy5yb290OwogICAgICB0aGlzLl93YW50c0hhc2hDaGFuZ2UgPSB0aGlzLm9wdGlvbnMuaGFzaENoYW5nZSAhPT0gZmFsc2U7CiAgICAgIHRoaXMuX3dhbnRzUHVzaFN0YXRlID0gISF0aGlzLm9wdGlvbnMucHVzaFN0YXRlOwogICAgICB0aGlzLl9oYXNQdXNoU3RhdGUgPSAhISh0aGlzLm9wdGlvbnMucHVzaFN0YXRlICYmIHRoaXMuaGlzdG9yeSAmJiB0aGlzLmhpc3RvcnkucHVzaFN0YXRlKTsKICAgICAgdmFyIGZyYWdtZW50ID0gdGhpcy5nZXRGcmFnbWVudCgpOwogICAgICB2YXIgZG9jTW9kZSA9IGRvY3VtZW50LmRvY3VtZW50TW9kZTsKICAgICAgdmFyIG9sZElFID0gaXNFeHBsb3Jlci5leGVjKG5hdmlnYXRvci51c2VyQWdlbnQudG9Mb3dlckNhc2UoKSkgJiYgKCFkb2NNb2RlIHx8IGRvY01vZGUgPD0gNyk7CiAgICAgIC8vIE5vcm1hbGl6ZSByb290IHRvIGFsd2F5cyBpbmNsdWRlIGEgbGVhZGluZyBhbmQgdHJhaWxpbmcgc2xhc2guCiAgICAgIHRoaXMucm9vdCA9ICgnLycgKyB0aGlzLnJvb3QgKyAnLycpLnJlcGxhY2Uocm9vdFN0cmlwcGVyLCAnLycpOwogICAgICBpZiAob2xkSUUgJiYgdGhpcy5fd2FudHNIYXNoQ2hhbmdlKSB7CiAgICAgICAgdmFyIGZyYW1lID0gQmFja2JvbmUuJCgnPGlmcmFtZSBzcmM9ImphdmFzY3JpcHQ6MCIgdGFiaW5kZXg9Ii0xIj4nKTsKICAgICAgICB0aGlzLmlmcmFtZSA9IGZyYW1lLmhpZGUoKS5hcHBlbmRUbygnYm9keScpWzBdLmNvbnRlbnRXaW5kb3c7CiAgICAgICAgdGhpcy5uYXZpZ2F0ZShmcmFnbWVudCk7CiAgICAgIH0KICAgICAgLy8gRGVwZW5kaW5nIG9uIHdoZXRoZXIgd2UncmUgdXNpbmcgcHVzaFN0YXRlIG9yIGhhc2hlcywgYW5kIHdoZXRoZXIKICAgICAgLy8gJ29uaGFzaGNoYW5nZScgaXMgc3VwcG9ydGVkLCBkZXRlcm1pbmUgaG93IHdlIGNoZWNrIHRoZSBVUkwgc3RhdGUuCiAgICAgIGlmICh0aGlzLl9oYXNQdXNoU3RhdGUpIHsKICAgICAgICBCYWNrYm9uZS4kKHdpbmRvdykub24oJ3BvcHN0YXRlJywgdGhpcy5jaGVja1VybCk7CiAgICAgIH0gZWxzZSBpZiAodGhpcy5fd2FudHNIYXNoQ2hhbmdlICYmICdvbmhhc2hjaGFuZ2UnIGluIHdpbmRvdyAmJiAhb2xkSUUpIHsKICAgICAgICBCYWNrYm9uZS4kKHdpbmRvdykub24oJ2hhc2hjaGFuZ2UnLCB0aGlzLmNoZWNrVXJsKTsKICAgICAgfSBlbHNlIGlmICh0aGlzLl93YW50c0hhc2hDaGFuZ2UpIHsKICAgICAgICB0aGlzLl9jaGVja1VybEludGVydmFsID0gc2V0SW50ZXJ2YWwodGhpcy5jaGVja1VybCwgdGhpcy5pbnRlcnZhbCk7CiAgICAgIH0KICAgICAgLy8gRGV0ZXJtaW5lIGlmIHdlIG5lZWQgdG8gY2hhbmdlIHRoZSBiYXNlIHVybCwgZm9yIGEgcHVzaFN0YXRlIGxpbmsKICAgICAgLy8gb3BlbmVkIGJ5IGEgbm9uLXB1c2hTdGF0ZSBicm93c2VyLgogICAgICB0aGlzLmZyYWdtZW50ID0gZnJhZ21lbnQ7CiAgICAgIHZhciBsb2MgPSB0aGlzLmxvY2F0aW9uOwogICAgICAvLyBUcmFuc2l0aW9uIGZyb20gaGFzaENoYW5nZSB0byBwdXNoU3RhdGUgb3IgdmljZSB2ZXJzYSBpZiBib3RoIGFyZQogICAgICAvLyByZXF1ZXN0ZWQuCiAgICAgIGlmICh0aGlzLl93YW50c0hhc2hDaGFuZ2UgJiYgdGhpcy5fd2FudHNQdXNoU3RhdGUpIHsKICAgICAgICAvLyBJZiB3ZSd2ZSBzdGFydGVkIG9mZiB3aXRoIGEgcm91dGUgZnJvbSBhIGBwdXNoU3RhdGVgLWVuYWJsZWQKICAgICAgICAvLyBicm93c2VyLCBidXQgd2UncmUgY3VycmVudGx5IGluIGEgYnJvd3NlciB0aGF0IGRvZXNuJ3Qgc3VwcG9ydCBpdC4uLgogICAgICAgIGlmICghdGhpcy5faGFzUHVzaFN0YXRlICYmICF0aGlzLmF0Um9vdCgpKSB7CiAgICAgICAgICB0aGlzLmZyYWdtZW50ID0gdGhpcy5nZXRGcmFnbWVudChudWxsLCB0cnVlKTsKICAgICAgICAgIHRoaXMubG9jYXRpb24ucmVwbGFjZSh0aGlzLnJvb3QgKyAnIycgKyB0aGlzLmZyYWdtZW50KTsKICAgICAgICAgIC8vIFJldHVybiBpbW1lZGlhdGVseSBhcyBicm93c2VyIHdpbGwgZG8gcmVkaXJlY3QgdG8gbmV3IHVybAogICAgICAgICAgcmV0dXJuIHRydWU7ICAvLyBPciBpZiB3ZSd2ZSBzdGFydGVkIG91dCB3aXRoIGEgaGFzaC1iYXNlZCByb3V0ZSwgYnV0IHdlJ3JlIGN1cnJlbnRseQogICAgICAgICAgICAgICAgICAgICAgICAvLyBpbiBhIGJyb3dzZXIgd2hlcmUgaXQgY291bGQgYmUgYHB1c2hTdGF0ZWAtYmFzZWQgaW5zdGVhZC4uLgogICAgICAgIH0gZWxzZSBpZiAodGhpcy5faGFzUHVzaFN0YXRlICYmIHRoaXMuYXRSb290KCkgJiYgbG9jLmhhc2gpIHsKICAgICAgICAgIHRoaXMuZnJhZ21lbnQgPSB0aGlzLmdldEhhc2goKS5yZXBsYWNlKHJvdXRlU3RyaXBwZXIsICcnKTsKICAgICAgICAgIHRoaXMuaGlzdG9yeS5yZXBsYWNlU3RhdGUoe30sIGRvY3VtZW50LnRpdGxlLCB0aGlzLnJvb3QgKyB0aGlzLmZyYWdtZW50KTsKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKCF0aGlzLm9wdGlvbnMuc2lsZW50KQogICAgICAgIHJldHVybiB0aGlzLmxvYWRVcmwoKTsKICAgIH0sCiAgICAvLyBEaXNhYmxlIEJhY2tib25lLmhpc3RvcnksIHBlcmhhcHMgdGVtcG9yYXJpbHkuIE5vdCB1c2VmdWwgaW4gYSByZWFsIGFwcCwKICAgIC8vIGJ1dCBwb3NzaWJseSB1c2VmdWwgZm9yIHVuaXQgdGVzdGluZyBSb3V0ZXJzLgogICAgc3RvcDogZnVuY3Rpb24gKCkgewogICAgICBCYWNrYm9uZS4kKHdpbmRvdykub2ZmKCdwb3BzdGF0ZScsIHRoaXMuY2hlY2tVcmwpLm9mZignaGFzaGNoYW5nZScsIHRoaXMuY2hlY2tVcmwpOwogICAgICBpZiAodGhpcy5fY2hlY2tVcmxJbnRlcnZhbCkKICAgICAgICBjbGVhckludGVydmFsKHRoaXMuX2NoZWNrVXJsSW50ZXJ2YWwpOwogICAgICBIaXN0b3J5LnN0YXJ0ZWQgPSBmYWxzZTsKICAgIH0sCiAgICAvLyBBZGQgYSByb3V0ZSB0byBiZSB0ZXN0ZWQgd2hlbiB0aGUgZnJhZ21lbnQgY2hhbmdlcy4gUm91dGVzIGFkZGVkIGxhdGVyCiAgICAvLyBtYXkgb3ZlcnJpZGUgcHJldmlvdXMgcm91dGVzLgogICAgcm91dGU6IGZ1bmN0aW9uIChyb3V0ZSwgY2FsbGJhY2spIHsKICAgICAgdGhpcy5oYW5kbGVycy51bnNoaWZ0KHsKICAgICAgICByb3V0ZTogcm91dGUsCiAgICAgICAgY2FsbGJhY2s6IGNhbGxiYWNrCiAgICAgIH0pOwogICAgfSwKICAgIC8vIENoZWNrcyB0aGUgY3VycmVudCBVUkwgdG8gc2VlIGlmIGl0IGhhcyBjaGFuZ2VkLCBhbmQgaWYgaXQgaGFzLAogICAgLy8gY2FsbHMgYGxvYWRVcmxgLCBub3JtYWxpemluZyBhY3Jvc3MgdGhlIGhpZGRlbiBpZnJhbWUuCiAgICBjaGVja1VybDogZnVuY3Rpb24gKGUpIHsKICAgICAgdmFyIGN1cnJlbnQgPSB0aGlzLmdldEZyYWdtZW50KCk7CiAgICAgIGlmIChjdXJyZW50ID09PSB0aGlzLmZyYWdtZW50ICYmIHRoaXMuaWZyYW1lKSB7CiAgICAgICAgY3VycmVudCA9IHRoaXMuZ2V0RnJhZ21lbnQodGhpcy5nZXRIYXNoKHRoaXMuaWZyYW1lKSk7CiAgICAgIH0KICAgICAgaWYgKGN1cnJlbnQgPT09IHRoaXMuZnJhZ21lbnQpCiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICBpZiAodGhpcy5pZnJhbWUpCiAgICAgICAgdGhpcy5uYXZpZ2F0ZShjdXJyZW50KTsKICAgICAgdGhpcy5sb2FkVXJsKCk7CiAgICB9LAogICAgLy8gQXR0ZW1wdCB0byBsb2FkIHRoZSBjdXJyZW50IFVSTCBmcmFnbWVudC4gSWYgYSByb3V0ZSBzdWNjZWVkcyB3aXRoIGEKICAgIC8vIG1hdGNoLCByZXR1cm5zIGB0cnVlYC4gSWYgbm8gZGVmaW5lZCByb3V0ZXMgbWF0Y2hlcyB0aGUgZnJhZ21lbnQsCiAgICAvLyByZXR1cm5zIGBmYWxzZWAuCiAgICBsb2FkVXJsOiBmdW5jdGlvbiAoZnJhZ21lbnQpIHsKICAgICAgZnJhZ21lbnQgPSB0aGlzLmZyYWdtZW50ID0gdGhpcy5nZXRGcmFnbWVudChmcmFnbWVudCk7CiAgICAgIHJldHVybiBfLmFueSh0aGlzLmhhbmRsZXJzLCBmdW5jdGlvbiAoaGFuZGxlcikgewogICAgICAgIGlmIChoYW5kbGVyLnJvdXRlLnRlc3QoZnJhZ21lbnQpKSB7CiAgICAgICAgICBoYW5kbGVyLmNhbGxiYWNrKGZyYWdtZW50KTsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9LAogICAgLy8gU2F2ZSBhIGZyYWdtZW50IGludG8gdGhlIGhhc2ggaGlzdG9yeSwgb3IgcmVwbGFjZSB0aGUgVVJMIHN0YXRlIGlmIHRoZQogICAgLy8gJ3JlcGxhY2UnIG9wdGlvbiBpcyBwYXNzZWQuIFlvdSBhcmUgcmVzcG9uc2libGUgZm9yIHByb3Blcmx5IFVSTC1lbmNvZGluZwogICAgLy8gdGhlIGZyYWdtZW50IGluIGFkdmFuY2UuCiAgICAvLwogICAgLy8gVGhlIG9wdGlvbnMgb2JqZWN0IGNhbiBjb250YWluIGB0cmlnZ2VyOiB0cnVlYCBpZiB5b3Ugd2lzaCB0byBoYXZlIHRoZQogICAgLy8gcm91dGUgY2FsbGJhY2sgYmUgZmlyZWQgKG5vdCB1c3VhbGx5IGRlc2lyYWJsZSksIG9yIGByZXBsYWNlOiB0cnVlYCwgaWYKICAgIC8vIHlvdSB3aXNoIHRvIG1vZGlmeSB0aGUgY3VycmVudCBVUkwgd2l0aG91dCBhZGRpbmcgYW4gZW50cnkgdG8gdGhlIGhpc3RvcnkuCiAgICBuYXZpZ2F0ZTogZnVuY3Rpb24gKGZyYWdtZW50LCBvcHRpb25zKSB7CiAgICAgIGlmICghSGlzdG9yeS5zdGFydGVkKQogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgaWYgKCFvcHRpb25zIHx8IG9wdGlvbnMgPT09IHRydWUpCiAgICAgICAgb3B0aW9ucyA9IHsgdHJpZ2dlcjogISFvcHRpb25zIH07CiAgICAgIHZhciB1cmwgPSB0aGlzLnJvb3QgKyAoZnJhZ21lbnQgPSB0aGlzLmdldEZyYWdtZW50KGZyYWdtZW50IHx8ICcnKSk7CiAgICAgIC8vIFN0cmlwIHRoZSBoYXNoIGZvciBtYXRjaGluZy4KICAgICAgZnJhZ21lbnQgPSBmcmFnbWVudC5yZXBsYWNlKHBhdGhTdHJpcHBlciwgJycpOwogICAgICBpZiAodGhpcy5mcmFnbWVudCA9PT0gZnJhZ21lbnQpCiAgICAgICAgcmV0dXJuOwogICAgICB0aGlzLmZyYWdtZW50ID0gZnJhZ21lbnQ7CiAgICAgIC8vIERvbid0IGluY2x1ZGUgYSB0cmFpbGluZyBzbGFzaCBvbiB0aGUgcm9vdC4KICAgICAgaWYgKGZyYWdtZW50ID09PSAnJyAmJiB1cmwgIT09ICcvJykKICAgICAgICB1cmwgPSB1cmwuc2xpY2UoMCwgLTEpOwogICAgICAvLyBJZiBwdXNoU3RhdGUgaXMgYXZhaWxhYmxlLCB3ZSB1c2UgaXQgdG8gc2V0IHRoZSBmcmFnbWVudCBhcyBhIHJlYWwgVVJMLgogICAgICBpZiAodGhpcy5faGFzUHVzaFN0YXRlKSB7CiAgICAgICAgdGhpcy5oaXN0b3J5W29wdGlvbnMucmVwbGFjZSA/ICdyZXBsYWNlU3RhdGUnIDogJ3B1c2hTdGF0ZSddKHt9LCBkb2N1bWVudC50aXRsZSwgdXJsKTsgIC8vIElmIGhhc2ggY2hhbmdlcyBoYXZlbid0IGJlZW4gZXhwbGljaXRseSBkaXNhYmxlZCwgdXBkYXRlIHRoZSBoYXNoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGZyYWdtZW50IHRvIHN0b3JlIGhpc3RvcnkuCiAgICAgIH0gZWxzZSBpZiAodGhpcy5fd2FudHNIYXNoQ2hhbmdlKSB7CiAgICAgICAgdGhpcy5fdXBkYXRlSGFzaCh0aGlzLmxvY2F0aW9uLCBmcmFnbWVudCwgb3B0aW9ucy5yZXBsYWNlKTsKICAgICAgICBpZiAodGhpcy5pZnJhbWUgJiYgZnJhZ21lbnQgIT09IHRoaXMuZ2V0RnJhZ21lbnQodGhpcy5nZXRIYXNoKHRoaXMuaWZyYW1lKSkpIHsKICAgICAgICAgIC8vIE9wZW5pbmcgYW5kIGNsb3NpbmcgdGhlIGlmcmFtZSB0cmlja3MgSUU3IGFuZCBlYXJsaWVyIHRvIHB1c2ggYQogICAgICAgICAgLy8gaGlzdG9yeSBlbnRyeSBvbiBoYXNoLXRhZyBjaGFuZ2UuICBXaGVuIHJlcGxhY2UgaXMgdHJ1ZSwgd2UgZG9uJ3QKICAgICAgICAgIC8vIHdhbnQgdGhpcy4KICAgICAgICAgIGlmICghb3B0aW9ucy5yZXBsYWNlKQogICAgICAgICAgICB0aGlzLmlmcmFtZS5kb2N1bWVudC5vcGVuKCkuY2xvc2UoKTsKICAgICAgICAgIHRoaXMuX3VwZGF0ZUhhc2godGhpcy5pZnJhbWUubG9jYXRpb24sIGZyYWdtZW50LCBvcHRpb25zLnJlcGxhY2UpOwogICAgICAgIH0gIC8vIElmIHlvdSd2ZSB0b2xkIHVzIHRoYXQgeW91IGV4cGxpY2l0bHkgZG9uJ3Qgd2FudCBmYWxsYmFjayBoYXNoY2hhbmdlLQogICAgICAgICAgIC8vIGJhc2VkIGhpc3RvcnksIHRoZW4gYG5hdmlnYXRlYCBiZWNvbWVzIGEgcGFnZSByZWZyZXNoLgogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiB0aGlzLmxvY2F0aW9uLmFzc2lnbih1cmwpOwogICAgICB9CiAgICAgIGlmIChvcHRpb25zLnRyaWdnZXIpCiAgICAgICAgcmV0dXJuIHRoaXMubG9hZFVybChmcmFnbWVudCk7CiAgICB9LAogICAgLy8gVXBkYXRlIHRoZSBoYXNoIGxvY2F0aW9uLCBlaXRoZXIgcmVwbGFjaW5nIHRoZSBjdXJyZW50IGVudHJ5LCBvciBhZGRpbmcKICAgIC8vIGEgbmV3IG9uZSB0byB0aGUgYnJvd3NlciBoaXN0b3J5LgogICAgX3VwZGF0ZUhhc2g6IGZ1bmN0aW9uIChsb2NhdGlvbiwgZnJhZ21lbnQsIHJlcGxhY2UpIHsKICAgICAgaWYgKHJlcGxhY2UpIHsKICAgICAgICB2YXIgaHJlZiA9IGxvY2F0aW9uLmhyZWYucmVwbGFjZSgvKGphdmFzY3JpcHQ6fCMpLiokLywgJycpOwogICAgICAgIGxvY2F0aW9uLnJlcGxhY2UoaHJlZiArICcjJyArIGZyYWdtZW50KTsKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBTb21lIGJyb3dzZXJzIHJlcXVpcmUgdGhhdCBgaGFzaGAgY29udGFpbnMgYSBsZWFkaW5nICMuCiAgICAgICAgbG9jYXRpb24uaGFzaCA9ICcjJyArIGZyYWdtZW50OwogICAgICB9CiAgICB9CiAgfSk7CiAgLy8gQ3JlYXRlIHRoZSBkZWZhdWx0IEJhY2tib25lLmhpc3RvcnkuCiAgQmFja2JvbmUuaGlzdG9yeSA9IG5ldyBIaXN0b3J5KCk7CiAgLy8gSGVscGVycwogIC8vIC0tLS0tLS0KICAvLyBIZWxwZXIgZnVuY3Rpb24gdG8gY29ycmVjdGx5IHNldCB1cCB0aGUgcHJvdG90eXBlIGNoYWluLCBmb3Igc3ViY2xhc3Nlcy4KICAvLyBTaW1pbGFyIHRvIGBnb29nLmluaGVyaXRzYCwgYnV0IHVzZXMgYSBoYXNoIG9mIHByb3RvdHlwZSBwcm9wZXJ0aWVzIGFuZAogIC8vIGNsYXNzIHByb3BlcnRpZXMgdG8gYmUgZXh0ZW5kZWQuCiAgdmFyIGV4dGVuZCA9IGZ1bmN0aW9uIChwcm90b1Byb3BzLCBzdGF0aWNQcm9wcykgewogICAgdmFyIHBhcmVudCA9IHRoaXM7CiAgICB2YXIgY2hpbGQ7CiAgICAvLyBUaGUgY29uc3RydWN0b3IgZnVuY3Rpb24gZm9yIHRoZSBuZXcgc3ViY2xhc3MgaXMgZWl0aGVyIGRlZmluZWQgYnkgeW91CiAgICAvLyAodGhlICJjb25zdHJ1Y3RvciIgcHJvcGVydHkgaW4geW91ciBgZXh0ZW5kYCBkZWZpbml0aW9uKSwgb3IgZGVmYXVsdGVkCiAgICAvLyBieSB1cyB0byBzaW1wbHkgY2FsbCB0aGUgcGFyZW50J3MgY29uc3RydWN0b3IuCiAgICBpZiAocHJvdG9Qcm9wcyAmJiBfLmhhcyhwcm90b1Byb3BzLCAnY29uc3RydWN0b3InKSkgewogICAgICBjaGlsZCA9IHByb3RvUHJvcHMuY29uc3RydWN0b3I7CiAgICB9IGVsc2UgewogICAgICBjaGlsZCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gcGFyZW50LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIH07CiAgICB9CiAgICAvLyBBZGQgc3RhdGljIHByb3BlcnRpZXMgdG8gdGhlIGNvbnN0cnVjdG9yIGZ1bmN0aW9uLCBpZiBzdXBwbGllZC4KICAgIF8uZXh0ZW5kKGNoaWxkLCBwYXJlbnQsIHN0YXRpY1Byb3BzKTsKICAgIC8vIFNldCB0aGUgcHJvdG90eXBlIGNoYWluIHRvIGluaGVyaXQgZnJvbSBgcGFyZW50YCwgd2l0aG91dCBjYWxsaW5nCiAgICAvLyBgcGFyZW50YCdzIGNvbnN0cnVjdG9yIGZ1bmN0aW9uLgogICAgdmFyIFN1cnJvZ2F0ZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgdGhpcy5jb25zdHJ1Y3RvciA9IGNoaWxkOwogICAgfTsKICAgIFN1cnJvZ2F0ZS5wcm90b3R5cGUgPSBwYXJlbnQucHJvdG90eXBlOwogICAgY2hpbGQucHJvdG90eXBlID0gbmV3IFN1cnJvZ2F0ZSgpOwogICAgLy8gQWRkIHByb3RvdHlwZSBwcm9wZXJ0aWVzIChpbnN0YW5jZSBwcm9wZXJ0aWVzKSB0byB0aGUgc3ViY2xhc3MsCiAgICAvLyBpZiBzdXBwbGllZC4KICAgIGlmIChwcm90b1Byb3BzKQogICAgICBfLmV4dGVuZChjaGlsZC5wcm90b3R5cGUsIHByb3RvUHJvcHMpOwogICAgLy8gU2V0IGEgY29udmVuaWVuY2UgcHJvcGVydHkgaW4gY2FzZSB0aGUgcGFyZW50J3MgcHJvdG90eXBlIGlzIG5lZWRlZAogICAgLy8gbGF0ZXIuCiAgICBjaGlsZC5fX3N1cGVyX18gPSBwYXJlbnQucHJvdG90eXBlOwogICAgcmV0dXJuIGNoaWxkOwogIH07CiAgLy8gU2V0IHVwIGluaGVyaXRhbmNlIGZvciB0aGUgbW9kZWwsIGNvbGxlY3Rpb24sIHJvdXRlciwgdmlldyBhbmQgaGlzdG9yeS4KICBNb2RlbC5leHRlbmQgPSBDb2xsZWN0aW9uLmV4dGVuZCA9IFJvdXRlci5leHRlbmQgPSBWaWV3LmV4dGVuZCA9IEhpc3RvcnkuZXh0ZW5kID0gZXh0ZW5kOwogIC8vIFRocm93IGFuIGVycm9yIHdoZW4gYSBVUkwgaXMgbmVlZGVkLCBhbmQgbm9uZSBpcyBzdXBwbGllZC4KICB2YXIgdXJsRXJyb3IgPSBmdW5jdGlvbiAoKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoJ0EgInVybCIgcHJvcGVydHkgb3IgZnVuY3Rpb24gbXVzdCBiZSBzcGVjaWZpZWQnKTsKICB9OwogIC8vIFdyYXAgYW4gb3B0aW9uYWwgZXJyb3IgY2FsbGJhY2sgd2l0aCBhIGZhbGxiYWNrIGVycm9yIGV2ZW50LgogIHZhciB3cmFwRXJyb3IgPSBmdW5jdGlvbiAobW9kZWwsIG9wdGlvbnMpIHsKICAgIHZhciBlcnJvciA9IG9wdGlvbnMuZXJyb3I7CiAgICBvcHRpb25zLmVycm9yID0gZnVuY3Rpb24gKHJlc3ApIHsKICAgICAgaWYgKGVycm9yKQogICAgICAgIGVycm9yKG1vZGVsLCByZXNwLCBvcHRpb25zKTsKICAgICAgbW9kZWwudHJpZ2dlcignZXJyb3InLCBtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CiAgICB9OwogIH07CiAgcmV0dXJuIEJhY2tib25lOwp9KSk7Ci8vIEJhY2tib25lLldyZXFyIChCYWNrYm9uZS5NYXJpb25ldHRlKQovLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCi8vIHYxLjMuMQovLwovLyBDb3B5cmlnaHQgKGMpMjAxNCBEZXJpY2sgQmFpbGV5LCBNdXRlZCBTb2x1dGlvbnMsIExMQy4KLy8gRGlzdHJpYnV0ZWQgdW5kZXIgTUlUIGxpY2Vuc2UKLy8KLy8gaHR0cDovL2dpdGh1Yi5jb20vbWFyaW9uZXR0ZWpzL2JhY2tib25lLndyZXFyCihmdW5jdGlvbiAocm9vdCwgZmFjdG9yeSkgewogIGlmICh0cnVlKSB7CiAgICBiYWNrYm9uZXdyZXFyID0gZnVuY3Rpb24gKEJhY2tib25lLCBfKSB7CiAgICAgIHJldHVybiBmYWN0b3J5KEJhY2tib25lLCBfKTsKICAgIH0oYmFja2JvbmUsIHVuZGVyc2NvcmUpOwogIH0gZWxzZSBpZiAodHlwZW9mIGV4cG9ydHMgIT09ICd1bmRlZmluZWQnKSB7CiAgICB2YXIgQmFja2JvbmUgPSBiYWNrYm9uZTsKICAgIHZhciBfID0gdW5kZXJzY29yZTsKICAgIG1vZHVsZS5leHBvcnRzID0gZmFjdG9yeShCYWNrYm9uZSwgXyk7CiAgfSBlbHNlIHsKICAgIGZhY3Rvcnkocm9vdC5CYWNrYm9uZSwgcm9vdC5fKTsKICB9Cn0odGhpcywgZnVuY3Rpb24gKEJhY2tib25lLCBfKSB7CiAgCiAgdmFyIHByZXZpb3VzV3JlcXIgPSBCYWNrYm9uZS5XcmVxcjsKICB2YXIgV3JlcXIgPSBCYWNrYm9uZS5XcmVxciA9IHt9OwogIEJhY2tib25lLldyZXFyLlZFUlNJT04gPSAnMS4zLjEnOwogIEJhY2tib25lLldyZXFyLm5vQ29uZmxpY3QgPSBmdW5jdGlvbiAoKSB7CiAgICBCYWNrYm9uZS5XcmVxciA9IHByZXZpb3VzV3JlcXI7CiAgICByZXR1cm4gdGhpczsKICB9OwogIC8vIEhhbmRsZXJzCiAgLy8gLS0tLS0tLS0KICAvLyBBIHJlZ2lzdHJ5IG9mIGZ1bmN0aW9ucyB0byBjYWxsLCBnaXZlbiBhIG5hbWUKICBXcmVxci5IYW5kbGVycyA9IGZ1bmN0aW9uIChCYWNrYm9uZSwgXykgewogICAgCiAgICAvLyBDb25zdHJ1Y3RvcgogICAgLy8gLS0tLS0tLS0tLS0KICAgIHZhciBIYW5kbGVycyA9IGZ1bmN0aW9uIChvcHRpb25zKSB7CiAgICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnM7CiAgICAgIHRoaXMuX3dyZXFySGFuZGxlcnMgPSB7fTsKICAgICAgaWYgKF8uaXNGdW5jdGlvbih0aGlzLmluaXRpYWxpemUpKSB7CiAgICAgICAgdGhpcy5pbml0aWFsaXplKG9wdGlvbnMpOwogICAgICB9CiAgICB9OwogICAgSGFuZGxlcnMuZXh0ZW5kID0gQmFja2JvbmUuTW9kZWwuZXh0ZW5kOwogICAgLy8gSW5zdGFuY2UgTWVtYmVycwogICAgLy8gLS0tLS0tLS0tLS0tLS0tLQogICAgXy5leHRlbmQoSGFuZGxlcnMucHJvdG90eXBlLCBCYWNrYm9uZS5FdmVudHMsIHsKICAgICAgLy8gQWRkIG11bHRpcGxlIGhhbmRsZXJzIHVzaW5nIGFuIG9iamVjdCBsaXRlcmFsIGNvbmZpZ3VyYXRpb24KICAgICAgc2V0SGFuZGxlcnM6IGZ1bmN0aW9uIChoYW5kbGVycykgewogICAgICAgIF8uZWFjaChoYW5kbGVycywgZnVuY3Rpb24gKGhhbmRsZXIsIG5hbWUpIHsKICAgICAgICAgIHZhciBjb250ZXh0ID0gbnVsbDsKICAgICAgICAgIGlmIChfLmlzT2JqZWN0KGhhbmRsZXIpICYmICFfLmlzRnVuY3Rpb24oaGFuZGxlcikpIHsKICAgICAgICAgICAgY29udGV4dCA9IGhhbmRsZXIuY29udGV4dDsKICAgICAgICAgICAgaGFuZGxlciA9IGhhbmRsZXIuY2FsbGJhY2s7CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLnNldEhhbmRsZXIobmFtZSwgaGFuZGxlciwgY29udGV4dCk7CiAgICAgICAgfSwgdGhpcyk7CiAgICAgIH0sCiAgICAgIC8vIEFkZCBhIGhhbmRsZXIgZm9yIHRoZSBnaXZlbiBuYW1lLCB3aXRoIGFuCiAgICAgIC8vIG9wdGlvbmFsIGNvbnRleHQgdG8gcnVuIHRoZSBoYW5kbGVyIHdpdGhpbgogICAgICBzZXRIYW5kbGVyOiBmdW5jdGlvbiAobmFtZSwgaGFuZGxlciwgY29udGV4dCkgewogICAgICAgIHZhciBjb25maWcgPSB7CiAgICAgICAgICBjYWxsYmFjazogaGFuZGxlciwKICAgICAgICAgIGNvbnRleHQ6IGNvbnRleHQKICAgICAgICB9OwogICAgICAgIHRoaXMuX3dyZXFySGFuZGxlcnNbbmFtZV0gPSBjb25maWc7CiAgICAgICAgdGhpcy50cmlnZ2VyKCdoYW5kbGVyOmFkZCcsIG5hbWUsIGhhbmRsZXIsIGNvbnRleHQpOwogICAgICB9LAogICAgICAvLyBEZXRlcm1pbmUgd2hldGhlciBvciBub3QgYSBoYW5kbGVyIGlzIHJlZ2lzdGVyZWQKICAgICAgaGFzSGFuZGxlcjogZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICByZXR1cm4gISF0aGlzLl93cmVxckhhbmRsZXJzW25hbWVdOwogICAgICB9LAogICAgICAvLyBHZXQgdGhlIGN1cnJlbnRseSByZWdpc3RlcmVkIGhhbmRsZXIgZm9yCiAgICAgIC8vIHRoZSBzcGVjaWZpZWQgbmFtZS4gVGhyb3dzIGFuIGV4Y2VwdGlvbiBpZgogICAgICAvLyBubyBoYW5kbGVyIGlzIGZvdW5kLgogICAgICBnZXRIYW5kbGVyOiBmdW5jdGlvbiAobmFtZSkgewogICAgICAgIHZhciBjb25maWcgPSB0aGlzLl93cmVxckhhbmRsZXJzW25hbWVdOwogICAgICAgIGlmICghY29uZmlnKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5hcHBseShhcmd1bWVudHMpOwogICAgICAgICAgcmV0dXJuIGNvbmZpZy5jYWxsYmFjay5hcHBseShjb25maWcuY29udGV4dCwgYXJncyk7CiAgICAgICAgfTsKICAgICAgfSwKICAgICAgLy8gUmVtb3ZlIGEgaGFuZGxlciBmb3IgdGhlIHNwZWNpZmllZCBuYW1lCiAgICAgIHJlbW92ZUhhbmRsZXI6IGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgZGVsZXRlIHRoaXMuX3dyZXFySGFuZGxlcnNbbmFtZV07CiAgICAgIH0sCiAgICAgIC8vIFJlbW92ZSBhbGwgaGFuZGxlcnMgZnJvbSB0aGlzIHJlZ2lzdHJ5CiAgICAgIHJlbW92ZUFsbEhhbmRsZXJzOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgdGhpcy5fd3JlcXJIYW5kbGVycyA9IHt9OwogICAgICB9CiAgICB9KTsKICAgIHJldHVybiBIYW5kbGVyczsKICB9KEJhY2tib25lLCBfKTsKICAvLyBXcmVxci5Db21tYW5kU3RvcmFnZQogIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgLy8KICAvLyBTdG9yZSBhbmQgcmV0cmlldmUgY29tbWFuZHMgZm9yIGV4ZWN1dGlvbi4KICBXcmVxci5Db21tYW5kU3RvcmFnZSA9IGZ1bmN0aW9uICgpIHsKICAgIAogICAgLy8gQ29uc3RydWN0b3IgZnVuY3Rpb24KICAgIHZhciBDb21tYW5kU3RvcmFnZSA9IGZ1bmN0aW9uIChvcHRpb25zKSB7CiAgICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnM7CiAgICAgIHRoaXMuX2NvbW1hbmRzID0ge307CiAgICAgIGlmIChfLmlzRnVuY3Rpb24odGhpcy5pbml0aWFsaXplKSkgewogICAgICAgIHRoaXMuaW5pdGlhbGl6ZShvcHRpb25zKTsKICAgICAgfQogICAgfTsKICAgIC8vIEluc3RhbmNlIG1ldGhvZHMKICAgIF8uZXh0ZW5kKENvbW1hbmRTdG9yYWdlLnByb3RvdHlwZSwgQmFja2JvbmUuRXZlbnRzLCB7CiAgICAgIC8vIEdldCBhbiBvYmplY3QgbGl0ZXJhbCBieSBjb21tYW5kIG5hbWUsIHRoYXQgY29udGFpbnMKICAgICAgLy8gdGhlIGBjb21tYW5kTmFtZWAgYW5kIHRoZSBgaW5zdGFuY2VzYCBvZiBhbGwgY29tbWFuZHMKICAgICAgLy8gcmVwcmVzZW50ZWQgYXMgYW4gYXJyYXkgb2YgYXJndW1lbnRzIHRvIHByb2Nlc3MKICAgICAgZ2V0Q29tbWFuZHM6IGZ1bmN0aW9uIChjb21tYW5kTmFtZSkgewogICAgICAgIHZhciBjb21tYW5kcyA9IHRoaXMuX2NvbW1hbmRzW2NvbW1hbmROYW1lXTsKICAgICAgICAvLyB3ZSBkb24ndCBoYXZlIGl0LCBzbyBhZGQgaXQKICAgICAgICBpZiAoIWNvbW1hbmRzKSB7CiAgICAgICAgICAvLyBidWlsZCB0aGUgY29uZmlndXJhdGlvbgogICAgICAgICAgY29tbWFuZHMgPSB7CiAgICAgICAgICAgIGNvbW1hbmQ6IGNvbW1hbmROYW1lLAogICAgICAgICAgICBpbnN0YW5jZXM6IFtdCiAgICAgICAgICB9OwogICAgICAgICAgLy8gc3RvcmUgaXQKICAgICAgICAgIHRoaXMuX2NvbW1hbmRzW2NvbW1hbmROYW1lXSA9IGNvbW1hbmRzOwogICAgICAgIH0KICAgICAgICByZXR1cm4gY29tbWFuZHM7CiAgICAgIH0sCiAgICAgIC8vIEFkZCBhIGNvbW1hbmQgYnkgbmFtZSwgdG8gdGhlIHN0b3JhZ2UgYW5kIHN0b3JlIHRoZQogICAgICAvLyBhcmdzIGZvciB0aGUgY29tbWFuZAogICAgICBhZGRDb21tYW5kOiBmdW5jdGlvbiAoY29tbWFuZE5hbWUsIGFyZ3MpIHsKICAgICAgICB2YXIgY29tbWFuZCA9IHRoaXMuZ2V0Q29tbWFuZHMoY29tbWFuZE5hbWUpOwogICAgICAgIGNvbW1hbmQuaW5zdGFuY2VzLnB1c2goYXJncyk7CiAgICAgIH0sCiAgICAgIC8vIENsZWFyIGFsbCBjb21tYW5kcyBmb3IgdGhlIGdpdmVuIGBjb21tYW5kTmFtZWAKICAgICAgY2xlYXJDb21tYW5kczogZnVuY3Rpb24gKGNvbW1hbmROYW1lKSB7CiAgICAgICAgdmFyIGNvbW1hbmQgPSB0aGlzLmdldENvbW1hbmRzKGNvbW1hbmROYW1lKTsKICAgICAgICBjb21tYW5kLmluc3RhbmNlcyA9IFtdOwogICAgICB9CiAgICB9KTsKICAgIHJldHVybiBDb21tYW5kU3RvcmFnZTsKICB9KCk7CiAgLy8gV3JlcXIuQ29tbWFuZHMKICAvLyAtLS0tLS0tLS0tLS0tLQogIC8vCiAgLy8gQSBzaW1wbGUgY29tbWFuZCBwYXR0ZXJuIGltcGxlbWVudGF0aW9uLiBSZWdpc3RlciBhIGNvbW1hbmQKICAvLyBoYW5kbGVyIGFuZCBleGVjdXRlIGl0LgogIFdyZXFyLkNvbW1hbmRzID0gZnVuY3Rpb24gKFdyZXFyKSB7CiAgICAKICAgIHJldHVybiBXcmVxci5IYW5kbGVycy5leHRlbmQoewogICAgICAvLyBkZWZhdWx0IHN0b3JhZ2UgdHlwZQogICAgICBzdG9yYWdlVHlwZTogV3JlcXIuQ29tbWFuZFN0b3JhZ2UsCiAgICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbiAob3B0aW9ucykgewogICAgICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICAgICAgdGhpcy5faW5pdGlhbGl6ZVN0b3JhZ2UodGhpcy5vcHRpb25zKTsKICAgICAgICB0aGlzLm9uKCdoYW5kbGVyOmFkZCcsIHRoaXMuX2V4ZWN1dGVDb21tYW5kcywgdGhpcyk7CiAgICAgICAgdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMpOwogICAgICAgIFdyZXFyLkhhbmRsZXJzLnByb3RvdHlwZS5jb25zdHJ1Y3Rvci5hcHBseSh0aGlzLCBhcmdzKTsKICAgICAgfSwKICAgICAgLy8gRXhlY3V0ZSBhIG5hbWVkIGNvbW1hbmQgd2l0aCB0aGUgc3VwcGxpZWQgYXJncwogICAgICBleGVjdXRlOiBmdW5jdGlvbiAobmFtZSwgYXJncykgewogICAgICAgIG5hbWUgPSBhcmd1bWVudHNbMF07CiAgICAgICAgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CiAgICAgICAgaWYgKHRoaXMuaGFzSGFuZGxlcihuYW1lKSkgewogICAgICAgICAgdGhpcy5nZXRIYW5kbGVyKG5hbWUpLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzLnN0b3JhZ2UuYWRkQ29tbWFuZChuYW1lLCBhcmdzKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIC8vIEludGVybmFsIG1ldGhvZCB0byBoYW5kbGUgYnVsayBleGVjdXRpb24gb2Ygc3RvcmVkIGNvbW1hbmRzCiAgICAgIF9leGVjdXRlQ29tbWFuZHM6IGZ1bmN0aW9uIChuYW1lLCBoYW5kbGVyLCBjb250ZXh0KSB7CiAgICAgICAgdmFyIGNvbW1hbmQgPSB0aGlzLnN0b3JhZ2UuZ2V0Q29tbWFuZHMobmFtZSk7CiAgICAgICAgLy8gbG9vcCB0aHJvdWdoIGFuZCBleGVjdXRlIGFsbCB0aGUgc3RvcmVkIGNvbW1hbmQgaW5zdGFuY2VzCiAgICAgICAgXy5lYWNoKGNvbW1hbmQuaW5zdGFuY2VzLCBmdW5jdGlvbiAoYXJncykgewogICAgICAgICAgaGFuZGxlci5hcHBseShjb250ZXh0LCBhcmdzKTsKICAgICAgICB9KTsKICAgICAgICB0aGlzLnN0b3JhZ2UuY2xlYXJDb21tYW5kcyhuYW1lKTsKICAgICAgfSwKICAgICAgLy8gSW50ZXJuYWwgbWV0aG9kIHRvIGluaXRpYWxpemUgc3RvcmFnZSBlaXRoZXIgZnJvbSB0aGUgdHlwZSdzCiAgICAgIC8vIGBzdG9yYWdlVHlwZWAgb3IgdGhlIGluc3RhbmNlIGBvcHRpb25zLnN0b3JhZ2VUeXBlYC4KICAgICAgX2luaXRpYWxpemVTdG9yYWdlOiBmdW5jdGlvbiAob3B0aW9ucykgewogICAgICAgIHZhciBzdG9yYWdlOwogICAgICAgIHZhciBTdG9yYWdlVHlwZSA9IG9wdGlvbnMuc3RvcmFnZVR5cGUgfHwgdGhpcy5zdG9yYWdlVHlwZTsKICAgICAgICBpZiAoXy5pc0Z1bmN0aW9uKFN0b3JhZ2VUeXBlKSkgewogICAgICAgICAgc3RvcmFnZSA9IG5ldyBTdG9yYWdlVHlwZSgpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBzdG9yYWdlID0gU3RvcmFnZVR5cGU7CiAgICAgICAgfQogICAgICAgIHRoaXMuc3RvcmFnZSA9IHN0b3JhZ2U7CiAgICAgIH0KICAgIH0pOwogIH0oV3JlcXIpOwogIC8vIFdyZXFyLlJlcXVlc3RSZXNwb25zZQogIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLQogIC8vCiAgLy8gQSBzaW1wbGUgcmVxdWVzdC9yZXNwb25zZSBpbXBsZW1lbnRhdGlvbi4gUmVnaXN0ZXIgYQogIC8vIHJlcXVlc3QgaGFuZGxlciwgYW5kIHJldHVybiBhIHJlc3BvbnNlIGZyb20gaXQKICBXcmVxci5SZXF1ZXN0UmVzcG9uc2UgPSBmdW5jdGlvbiAoV3JlcXIpIHsKICAgIAogICAgcmV0dXJuIFdyZXFyLkhhbmRsZXJzLmV4dGVuZCh7CiAgICAgIHJlcXVlc3Q6IGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgbmFtZSA9IGFyZ3VtZW50c1swXTsKICAgICAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CiAgICAgICAgaWYgKHRoaXMuaGFzSGFuZGxlcihuYW1lKSkgewogICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0SGFuZGxlcihuYW1lKS5hcHBseSh0aGlzLCBhcmdzKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogIH0oV3JlcXIpOwogIC8vIEV2ZW50IEFnZ3JlZ2F0b3IKICAvLyAtLS0tLS0tLS0tLS0tLS0tCiAgLy8gQSBwdWItc3ViIG9iamVjdCB0aGF0IGNhbiBiZSB1c2VkIHRvIGRlY291cGxlIHZhcmlvdXMgcGFydHMKICAvLyBvZiBhbiBhcHBsaWNhdGlvbiB0aHJvdWdoIGV2ZW50LWRyaXZlbiBhcmNoaXRlY3R1cmUuCiAgV3JlcXIuRXZlbnRBZ2dyZWdhdG9yID0gZnVuY3Rpb24gKEJhY2tib25lLCBfKSB7CiAgICAKICAgIHZhciBFQSA9IGZ1bmN0aW9uICgpIHsKICAgIH07CiAgICAvLyBDb3B5IHRoZSBgZXh0ZW5kYCBmdW5jdGlvbiB1c2VkIGJ5IEJhY2tib25lJ3MgY2xhc3NlcwogICAgRUEuZXh0ZW5kID0gQmFja2JvbmUuTW9kZWwuZXh0ZW5kOwogICAgLy8gQ29weSB0aGUgYmFzaWMgQmFja2JvbmUuRXZlbnRzIG9uIHRvIHRoZSBldmVudCBhZ2dyZWdhdG9yCiAgICBfLmV4dGVuZChFQS5wcm90b3R5cGUsIEJhY2tib25lLkV2ZW50cyk7CiAgICByZXR1cm4gRUE7CiAgfShCYWNrYm9uZSwgXyk7CiAgLy8gV3JlcXIuQ2hhbm5lbAogIC8vIC0tLS0tLS0tLS0tLS0tCiAgLy8KICAvLyBBbiBvYmplY3QgdGhhdCB3cmFwcyB0aGUgdGhyZWUgbWVzc2FnaW5nIHN5c3RlbXM6CiAgLy8gRXZlbnRBZ2dyZWdhdG9yLCBSZXF1ZXN0UmVzcG9uc2UsIENvbW1hbmRzCiAgV3JlcXIuQ2hhbm5lbCA9IGZ1bmN0aW9uIChXcmVxcikgewogICAgCiAgICB2YXIgQ2hhbm5lbCA9IGZ1bmN0aW9uIChjaGFubmVsTmFtZSkgewogICAgICB0aGlzLnZlbnQgPSBuZXcgQmFja2JvbmUuV3JlcXIuRXZlbnRBZ2dyZWdhdG9yKCk7CiAgICAgIHRoaXMucmVxcmVzID0gbmV3IEJhY2tib25lLldyZXFyLlJlcXVlc3RSZXNwb25zZSgpOwogICAgICB0aGlzLmNvbW1hbmRzID0gbmV3IEJhY2tib25lLldyZXFyLkNvbW1hbmRzKCk7CiAgICAgIHRoaXMuY2hhbm5lbE5hbWUgPSBjaGFubmVsTmFtZTsKICAgIH07CiAgICBfLmV4dGVuZChDaGFubmVsLnByb3RvdHlwZSwgewogICAgICAvLyBSZW1vdmUgYWxsIGhhbmRsZXJzIGZyb20gdGhlIG1lc3NhZ2luZyBzeXN0ZW1zIG9mIHRoaXMgY2hhbm5lbAogICAgICByZXNldDogZnVuY3Rpb24gKCkgewogICAgICAgIHRoaXMudmVudC5vZmYoKTsKICAgICAgICB0aGlzLnZlbnQuc3RvcExpc3RlbmluZygpOwogICAgICAgIHRoaXMucmVxcmVzLnJlbW92ZUFsbEhhbmRsZXJzKCk7CiAgICAgICAgdGhpcy5jb21tYW5kcy5yZW1vdmVBbGxIYW5kbGVycygpOwogICAgICAgIHJldHVybiB0aGlzOwogICAgICB9LAogICAgICAvLyBDb25uZWN0IGEgaGFzaCBvZiBldmVudHM7IG9uZSBmb3IgZWFjaCBtZXNzYWdpbmcgc3lzdGVtCiAgICAgIGNvbm5lY3RFdmVudHM6IGZ1bmN0aW9uIChoYXNoLCBjb250ZXh0KSB7CiAgICAgICAgdGhpcy5fY29ubmVjdCgndmVudCcsIGhhc2gsIGNvbnRleHQpOwogICAgICAgIHJldHVybiB0aGlzOwogICAgICB9LAogICAgICBjb25uZWN0Q29tbWFuZHM6IGZ1bmN0aW9uIChoYXNoLCBjb250ZXh0KSB7CiAgICAgICAgdGhpcy5fY29ubmVjdCgnY29tbWFuZHMnLCBoYXNoLCBjb250ZXh0KTsKICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfSwKICAgICAgY29ubmVjdFJlcXVlc3RzOiBmdW5jdGlvbiAoaGFzaCwgY29udGV4dCkgewogICAgICAgIHRoaXMuX2Nvbm5lY3QoJ3JlcXJlcycsIGhhc2gsIGNvbnRleHQpOwogICAgICAgIHJldHVybiB0aGlzOwogICAgICB9LAogICAgICAvLyBBdHRhY2ggdGhlIGhhbmRsZXJzIHRvIGEgZ2l2ZW4gbWVzc2FnZSBzeXN0ZW0gYHR5cGVgCiAgICAgIF9jb25uZWN0OiBmdW5jdGlvbiAodHlwZSwgaGFzaCwgY29udGV4dCkgewogICAgICAgIGlmICghaGFzaCkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBjb250ZXh0ID0gY29udGV4dCB8fCB0aGlzOwogICAgICAgIHZhciBtZXRob2QgPSB0eXBlID09PSAndmVudCcgPyAnb24nIDogJ3NldEhhbmRsZXInOwogICAgICAgIF8uZWFjaChoYXNoLCBmdW5jdGlvbiAoZm4sIGV2ZW50TmFtZSkgewogICAgICAgICAgdGhpc1t0eXBlXVttZXRob2RdKGV2ZW50TmFtZSwgXy5iaW5kKGZuLCBjb250ZXh0KSk7CiAgICAgICAgfSwgdGhpcyk7CiAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuIENoYW5uZWw7CiAgfShXcmVxcik7CiAgLy8gV3JlcXIuUmFkaW8KICAvLyAtLS0tLS0tLS0tLS0tLQogIC8vCiAgLy8gQW4gb2JqZWN0IHRoYXQgbGV0cyB5b3UgY29tbXVuaWNhdGUgd2l0aCBtYW55IGNoYW5uZWxzLgogIFdyZXFyLnJhZGlvID0gZnVuY3Rpb24gKFdyZXFyKSB7CiAgICAKICAgIHZhciBSYWRpbyA9IGZ1bmN0aW9uICgpIHsKICAgICAgdGhpcy5fY2hhbm5lbHMgPSB7fTsKICAgICAgdGhpcy52ZW50ID0ge307CiAgICAgIHRoaXMuY29tbWFuZHMgPSB7fTsKICAgICAgdGhpcy5yZXFyZXMgPSB7fTsKICAgICAgdGhpcy5fcHJveHlNZXRob2RzKCk7CiAgICB9OwogICAgXy5leHRlbmQoUmFkaW8ucHJvdG90eXBlLCB7CiAgICAgIGNoYW5uZWw6IGZ1bmN0aW9uIChjaGFubmVsTmFtZSkgewogICAgICAgIGlmICghY2hhbm5lbE5hbWUpIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcignQ2hhbm5lbCBtdXN0IHJlY2VpdmUgYSBuYW1lJyk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzLl9nZXRDaGFubmVsKGNoYW5uZWxOYW1lKTsKICAgICAgfSwKICAgICAgX2dldENoYW5uZWw6IGZ1bmN0aW9uIChjaGFubmVsTmFtZSkgewogICAgICAgIHZhciBjaGFubmVsID0gdGhpcy5fY2hhbm5lbHNbY2hhbm5lbE5hbWVdOwogICAgICAgIGlmICghY2hhbm5lbCkgewogICAgICAgICAgY2hhbm5lbCA9IG5ldyBXcmVxci5DaGFubmVsKGNoYW5uZWxOYW1lKTsKICAgICAgICAgIHRoaXMuX2NoYW5uZWxzW2NoYW5uZWxOYW1lXSA9IGNoYW5uZWw7CiAgICAgICAgfQogICAgICAgIHJldHVybiBjaGFubmVsOwogICAgICB9LAogICAgICBfcHJveHlNZXRob2RzOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgXy5lYWNoKFsKICAgICAgICAgICd2ZW50JywKICAgICAgICAgICdjb21tYW5kcycsCiAgICAgICAgICAncmVxcmVzJwogICAgICAgIF0sIGZ1bmN0aW9uIChzeXN0ZW0pIHsKICAgICAgICAgIF8uZWFjaChtZXNzYWdlU3lzdGVtc1tzeXN0ZW1dLCBmdW5jdGlvbiAobWV0aG9kKSB7CiAgICAgICAgICAgIHRoaXNbc3lzdGVtXVttZXRob2RdID0gcHJveHlNZXRob2QodGhpcywgc3lzdGVtLCBtZXRob2QpOwogICAgICAgICAgfSwgdGhpcyk7CiAgICAgICAgfSwgdGhpcyk7CiAgICAgIH0KICAgIH0pOwogICAgdmFyIG1lc3NhZ2VTeXN0ZW1zID0gewogICAgICB2ZW50OiBbCiAgICAgICAgJ29uJywKICAgICAgICAnb2ZmJywKICAgICAgICAndHJpZ2dlcicsCiAgICAgICAgJ29uY2UnLAogICAgICAgICdzdG9wTGlzdGVuaW5nJywKICAgICAgICAnbGlzdGVuVG8nLAogICAgICAgICdsaXN0ZW5Ub09uY2UnCiAgICAgIF0sCiAgICAgIGNvbW1hbmRzOiBbCiAgICAgICAgJ2V4ZWN1dGUnLAogICAgICAgICdzZXRIYW5kbGVyJywKICAgICAgICAnc2V0SGFuZGxlcnMnLAogICAgICAgICdyZW1vdmVIYW5kbGVyJywKICAgICAgICAncmVtb3ZlQWxsSGFuZGxlcnMnCiAgICAgIF0sCiAgICAgIHJlcXJlczogWwogICAgICAgICdyZXF1ZXN0JywKICAgICAgICAnc2V0SGFuZGxlcicsCiAgICAgICAgJ3NldEhhbmRsZXJzJywKICAgICAgICAncmVtb3ZlSGFuZGxlcicsCiAgICAgICAgJ3JlbW92ZUFsbEhhbmRsZXJzJwogICAgICBdCiAgICB9OwogICAgdmFyIHByb3h5TWV0aG9kID0gZnVuY3Rpb24gKHJhZGlvLCBzeXN0ZW0sIG1ldGhvZCkgewogICAgICByZXR1cm4gZnVuY3Rpb24gKGNoYW5uZWxOYW1lKSB7CiAgICAgICAgdmFyIG1lc3NhZ2VTeXN0ZW0gPSByYWRpby5fZ2V0Q2hhbm5lbChjaGFubmVsTmFtZSlbc3lzdGVtXTsKICAgICAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CiAgICAgICAgcmV0dXJuIG1lc3NhZ2VTeXN0ZW1bbWV0aG9kXS5hcHBseShtZXNzYWdlU3lzdGVtLCBhcmdzKTsKICAgICAgfTsKICAgIH07CiAgICByZXR1cm4gbmV3IFJhZGlvKCk7CiAgfShXcmVxcik7CiAgcmV0dXJuIEJhY2tib25lLldyZXFyOwp9KSk7Ci8vIEJhY2tib25lLkJhYnlTaXR0ZXIKLy8gLS0tLS0tLS0tLS0tLS0tLS0tLQovLyB2MC4xLjQKLy8KLy8gQ29weXJpZ2h0IChjKTIwMTQgRGVyaWNrIEJhaWxleSwgTXV0ZWQgU29sdXRpb25zLCBMTEMuCi8vIERpc3RyaWJ1dGVkIHVuZGVyIE1JVCBsaWNlbnNlCi8vCi8vIGh0dHA6Ly9naXRodWIuY29tL21hcmlvbmV0dGVqcy9iYWNrYm9uZS5iYWJ5c2l0dGVyCihmdW5jdGlvbiAocm9vdCwgZmFjdG9yeSkgewogIGlmICh0cnVlKSB7CiAgICBiYWNrYm9uZWJhYnlzaXR0ZXIgPSBmdW5jdGlvbiAoQmFja2JvbmUsIF8pIHsKICAgICAgcmV0dXJuIGZhY3RvcnkoQmFja2JvbmUsIF8pOwogICAgfShiYWNrYm9uZSwgdW5kZXJzY29yZSk7CiAgfSBlbHNlIGlmICh0eXBlb2YgZXhwb3J0cyAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgIHZhciBCYWNrYm9uZSA9IGJhY2tib25lOwogICAgdmFyIF8gPSB1bmRlcnNjb3JlOwogICAgbW9kdWxlLmV4cG9ydHMgPSBmYWN0b3J5KEJhY2tib25lLCBfKTsKICB9IGVsc2UgewogICAgZmFjdG9yeShyb290LkJhY2tib25lLCByb290Ll8pOwogIH0KfSh0aGlzLCBmdW5jdGlvbiAoQmFja2JvbmUsIF8pIHsKICAKICB2YXIgcHJldmlvdXNDaGlsZFZpZXdDb250YWluZXIgPSBCYWNrYm9uZS5DaGlsZFZpZXdDb250YWluZXI7CiAgLy8gQmFieVNpdHRlci5DaGlsZFZpZXdDb250YWluZXIKICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogIC8vCiAgLy8gUHJvdmlkZSBhIGNvbnRhaW5lciB0byBzdG9yZSwgcmV0cmlldmUgYW5kCiAgLy8gc2h1dCBkb3duIGNoaWxkIHZpZXdzLgogIEJhY2tib25lLkNoaWxkVmlld0NvbnRhaW5lciA9IGZ1bmN0aW9uIChCYWNrYm9uZSwgXykgewogICAgLy8gQ29udGFpbmVyIENvbnN0cnVjdG9yCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIHZhciBDb250YWluZXIgPSBmdW5jdGlvbiAodmlld3MpIHsKICAgICAgdGhpcy5fdmlld3MgPSB7fTsKICAgICAgdGhpcy5faW5kZXhCeU1vZGVsID0ge307CiAgICAgIHRoaXMuX2luZGV4QnlDdXN0b20gPSB7fTsKICAgICAgdGhpcy5fdXBkYXRlTGVuZ3RoKCk7CiAgICAgIF8uZWFjaCh2aWV3cywgdGhpcy5hZGQsIHRoaXMpOwogICAgfTsKICAgIC8vIENvbnRhaW5lciBNZXRob2RzCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLQogICAgXy5leHRlbmQoQ29udGFpbmVyLnByb3RvdHlwZSwgewogICAgICAvLyBBZGQgYSB2aWV3IHRvIHRoaXMgY29udGFpbmVyLiBTdG9yZXMgdGhlIHZpZXcKICAgICAgLy8gYnkgYGNpZGAgYW5kIG1ha2VzIGl0IHNlYXJjaGFibGUgYnkgdGhlIG1vZGVsCiAgICAgIC8vIGNpZCAoYW5kIG1vZGVsIGl0c2VsZikuIE9wdGlvbmFsbHkgc3BlY2lmeQogICAgICAvLyBhIGN1c3RvbSBrZXkgdG8gc3RvcmUgYW4gcmV0cmlldmUgdGhlIHZpZXcuCiAgICAgIGFkZDogZnVuY3Rpb24gKHZpZXcsIGN1c3RvbUluZGV4KSB7CiAgICAgICAgdmFyIHZpZXdDaWQgPSB2aWV3LmNpZDsKICAgICAgICAvLyBzdG9yZSB0aGUgdmlldwogICAgICAgIHRoaXMuX3ZpZXdzW3ZpZXdDaWRdID0gdmlldzsKICAgICAgICAvLyBpbmRleCBpdCBieSBtb2RlbAogICAgICAgIGlmICh2aWV3Lm1vZGVsKSB7CiAgICAgICAgICB0aGlzLl9pbmRleEJ5TW9kZWxbdmlldy5tb2RlbC5jaWRdID0gdmlld0NpZDsKICAgICAgICB9CiAgICAgICAgLy8gaW5kZXggYnkgY3VzdG9tCiAgICAgICAgaWYgKGN1c3RvbUluZGV4KSB7CiAgICAgICAgICB0aGlzLl9pbmRleEJ5Q3VzdG9tW2N1c3RvbUluZGV4XSA9IHZpZXdDaWQ7CiAgICAgICAgfQogICAgICAgIHRoaXMuX3VwZGF0ZUxlbmd0aCgpOwogICAgICAgIHJldHVybiB0aGlzOwogICAgICB9LAogICAgICAvLyBGaW5kIGEgdmlldyBieSB0aGUgbW9kZWwgdGhhdCB3YXMgYXR0YWNoZWQgdG8KICAgICAgLy8gaXQuIFVzZXMgdGhlIG1vZGVsJ3MgYGNpZGAgdG8gZmluZCBpdC4KICAgICAgZmluZEJ5TW9kZWw6IGZ1bmN0aW9uIChtb2RlbCkgewogICAgICAgIHJldHVybiB0aGlzLmZpbmRCeU1vZGVsQ2lkKG1vZGVsLmNpZCk7CiAgICAgIH0sCiAgICAgIC8vIEZpbmQgYSB2aWV3IGJ5IHRoZSBgY2lkYCBvZiB0aGUgbW9kZWwgdGhhdCB3YXMgYXR0YWNoZWQgdG8KICAgICAgLy8gaXQuIFVzZXMgdGhlIG1vZGVsJ3MgYGNpZGAgdG8gZmluZCB0aGUgdmlldyBgY2lkYCBhbmQKICAgICAgLy8gcmV0cmlldmUgdGhlIHZpZXcgdXNpbmcgaXQuCiAgICAgIGZpbmRCeU1vZGVsQ2lkOiBmdW5jdGlvbiAobW9kZWxDaWQpIHsKICAgICAgICB2YXIgdmlld0NpZCA9IHRoaXMuX2luZGV4QnlNb2RlbFttb2RlbENpZF07CiAgICAgICAgcmV0dXJuIHRoaXMuZmluZEJ5Q2lkKHZpZXdDaWQpOwogICAgICB9LAogICAgICAvLyBGaW5kIGEgdmlldyBieSBhIGN1c3RvbSBpbmRleGVyLgogICAgICBmaW5kQnlDdXN0b206IGZ1bmN0aW9uIChpbmRleCkgewogICAgICAgIHZhciB2aWV3Q2lkID0gdGhpcy5faW5kZXhCeUN1c3RvbVtpbmRleF07CiAgICAgICAgcmV0dXJuIHRoaXMuZmluZEJ5Q2lkKHZpZXdDaWQpOwogICAgICB9LAogICAgICAvLyBGaW5kIGJ5IGluZGV4LiBUaGlzIGlzIG5vdCBndWFyYW50ZWVkIHRvIGJlIGEKICAgICAgLy8gc3RhYmxlIGluZGV4LgogICAgICBmaW5kQnlJbmRleDogZnVuY3Rpb24gKGluZGV4KSB7CiAgICAgICAgcmV0dXJuIF8udmFsdWVzKHRoaXMuX3ZpZXdzKVtpbmRleF07CiAgICAgIH0sCiAgICAgIC8vIHJldHJpZXZlIGEgdmlldyBieSBpdHMgYGNpZGAgZGlyZWN0bHkKICAgICAgZmluZEJ5Q2lkOiBmdW5jdGlvbiAoY2lkKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3ZpZXdzW2NpZF07CiAgICAgIH0sCiAgICAgIC8vIFJlbW92ZSBhIHZpZXcKICAgICAgcmVtb3ZlOiBmdW5jdGlvbiAodmlldykgewogICAgICAgIHZhciB2aWV3Q2lkID0gdmlldy5jaWQ7CiAgICAgICAgLy8gZGVsZXRlIG1vZGVsIGluZGV4CiAgICAgICAgaWYgKHZpZXcubW9kZWwpIHsKICAgICAgICAgIGRlbGV0ZSB0aGlzLl9pbmRleEJ5TW9kZWxbdmlldy5tb2RlbC5jaWRdOwogICAgICAgIH0KICAgICAgICAvLyBkZWxldGUgY3VzdG9tIGluZGV4CiAgICAgICAgXy5hbnkodGhpcy5faW5kZXhCeUN1c3RvbSwgZnVuY3Rpb24gKGNpZCwga2V5KSB7CiAgICAgICAgICBpZiAoY2lkID09PSB2aWV3Q2lkKSB7CiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLl9pbmRleEJ5Q3VzdG9tW2tleV07CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0sIHRoaXMpOwogICAgICAgIC8vIHJlbW92ZSB0aGUgdmlldyBmcm9tIHRoZSBjb250YWluZXIKICAgICAgICBkZWxldGUgdGhpcy5fdmlld3Nbdmlld0NpZF07CiAgICAgICAgLy8gdXBkYXRlIHRoZSBsZW5ndGgKICAgICAgICB0aGlzLl91cGRhdGVMZW5ndGgoKTsKICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfSwKICAgICAgLy8gQ2FsbCBhIG1ldGhvZCBvbiBldmVyeSB2aWV3IGluIHRoZSBjb250YWluZXIsCiAgICAgIC8vIHBhc3NpbmcgcGFyYW1ldGVycyB0byB0aGUgY2FsbCBtZXRob2Qgb25lIGF0IGEKICAgICAgLy8gdGltZSwgbGlrZSBgZnVuY3Rpb24uY2FsbGAuCiAgICAgIGNhbGw6IGZ1bmN0aW9uIChtZXRob2QpIHsKICAgICAgICB0aGlzLmFwcGx5KG1ldGhvZCwgXy50YWlsKGFyZ3VtZW50cykpOwogICAgICB9LAogICAgICAvLyBBcHBseSBhIG1ldGhvZCBvbiBldmVyeSB2aWV3IGluIHRoZSBjb250YWluZXIsCiAgICAgIC8vIHBhc3NpbmcgcGFyYW1ldGVycyB0byB0aGUgY2FsbCBtZXRob2Qgb25lIGF0IGEKICAgICAgLy8gdGltZSwgbGlrZSBgZnVuY3Rpb24uYXBwbHlgLgogICAgICBhcHBseTogZnVuY3Rpb24gKG1ldGhvZCwgYXJncykgewogICAgICAgIF8uZWFjaCh0aGlzLl92aWV3cywgZnVuY3Rpb24gKHZpZXcpIHsKICAgICAgICAgIGlmIChfLmlzRnVuY3Rpb24odmlld1ttZXRob2RdKSkgewogICAgICAgICAgICB2aWV3W21ldGhvZF0uYXBwbHkodmlldywgYXJncyB8fCBbXSk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0sCiAgICAgIC8vIFVwZGF0ZSB0aGUgYC5sZW5ndGhgIGF0dHJpYnV0ZSBvbiB0aGlzIGNvbnRhaW5lcgogICAgICBfdXBkYXRlTGVuZ3RoOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgdGhpcy5sZW5ndGggPSBfLnNpemUodGhpcy5fdmlld3MpOwogICAgICB9CiAgICB9KTsKICAgIC8vIEJvcnJvd2luZyB0aGlzIGNvZGUgZnJvbSBCYWNrYm9uZS5Db2xsZWN0aW9uOgogICAgLy8gaHR0cDovL2JhY2tib25lanMub3JnL2RvY3MvYmFja2JvbmUuaHRtbCNzZWN0aW9uLTEwNgogICAgLy8KICAgIC8vIE1peCBpbiBtZXRob2RzIGZyb20gVW5kZXJzY29yZSwgZm9yIGl0ZXJhdGlvbiwgYW5kIG90aGVyCiAgICAvLyBjb2xsZWN0aW9uIHJlbGF0ZWQgZmVhdHVyZXMuCiAgICB2YXIgbWV0aG9kcyA9IFsKICAgICAgJ2ZvckVhY2gnLAogICAgICAnZWFjaCcsCiAgICAgICdtYXAnLAogICAgICAnZmluZCcsCiAgICAgICdkZXRlY3QnLAogICAgICAnZmlsdGVyJywKICAgICAgJ3NlbGVjdCcsCiAgICAgICdyZWplY3QnLAogICAgICAnZXZlcnknLAogICAgICAnYWxsJywKICAgICAgJ3NvbWUnLAogICAgICAnYW55JywKICAgICAgJ2luY2x1ZGUnLAogICAgICAnY29udGFpbnMnLAogICAgICAnaW52b2tlJywKICAgICAgJ3RvQXJyYXknLAogICAgICAnZmlyc3QnLAogICAgICAnaW5pdGlhbCcsCiAgICAgICdyZXN0JywKICAgICAgJ2xhc3QnLAogICAgICAnd2l0aG91dCcsCiAgICAgICdpc0VtcHR5JywKICAgICAgJ3BsdWNrJwogICAgXTsKICAgIF8uZWFjaChtZXRob2RzLCBmdW5jdGlvbiAobWV0aG9kKSB7CiAgICAgIENvbnRhaW5lci5wcm90b3R5cGVbbWV0aG9kXSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgdmlld3MgPSBfLnZhbHVlcyh0aGlzLl92aWV3cyk7CiAgICAgICAgdmFyIGFyZ3MgPSBbdmlld3NdLmNvbmNhdChfLnRvQXJyYXkoYXJndW1lbnRzKSk7CiAgICAgICAgcmV0dXJuIF9bbWV0aG9kXS5hcHBseShfLCBhcmdzKTsKICAgICAgfTsKICAgIH0pOwogICAgLy8gcmV0dXJuIHRoZSBwdWJsaWMgQVBJCiAgICByZXR1cm4gQ29udGFpbmVyOwogIH0oQmFja2JvbmUsIF8pOwogIEJhY2tib25lLkNoaWxkVmlld0NvbnRhaW5lci5WRVJTSU9OID0gJzAuMS40JzsKICBCYWNrYm9uZS5DaGlsZFZpZXdDb250YWluZXIubm9Db25mbGljdCA9IGZ1bmN0aW9uICgpIHsKICAgIEJhY2tib25lLkNoaWxkVmlld0NvbnRhaW5lciA9IHByZXZpb3VzQ2hpbGRWaWV3Q29udGFpbmVyOwogICAgcmV0dXJuIHRoaXM7CiAgfTsKICByZXR1cm4gQmFja2JvbmUuQ2hpbGRWaWV3Q29udGFpbmVyOwp9KSk7Ci8vIE1hcmlvbmV0dGVKUyAoQmFja2JvbmUuTWFyaW9uZXR0ZSkKLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQovLyB2Mi4yLjAKLy8KLy8gQ29weXJpZ2h0IChjKTIwMTQgRGVyaWNrIEJhaWxleSwgTXV0ZWQgU29sdXRpb25zLCBMTEMuCi8vIERpc3RyaWJ1dGVkIHVuZGVyIE1JVCBsaWNlbnNlCi8vCi8vIGh0dHA6Ly9tYXJpb25ldHRlanMuY29tCihmdW5jdGlvbiAocm9vdCwgZmFjdG9yeSkgewogIGlmICh0cnVlKSB7CiAgICBiYWNrYm9uZW1hcmlvbmV0dGUgPSBmdW5jdGlvbiAoQmFja2JvbmUsIF8pIHsKICAgICAgcmV0dXJuIHJvb3QuTWFyaW9uZXR0ZSA9IGZhY3Rvcnkocm9vdCwgQmFja2JvbmUsIF8pOwogICAgfShiYWNrYm9uZSwgdW5kZXJzY29yZSk7CiAgfSBlbHNlIGlmICh0eXBlb2YgZXhwb3J0cyAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgIHZhciBCYWNrYm9uZSA9IGJhY2tib25lOwogICAgdmFyIF8gPSB1bmRlcnNjb3JlOwogICAgdmFyIFdyZXFyID0gYmFja2JvbmV3cmVxcjsKICAgIHZhciBCYWJ5U2l0dGVyID0gYmFja2JvbmViYWJ5c2l0dGVyOwogICAgbW9kdWxlLmV4cG9ydHMgPSBmYWN0b3J5KHJvb3QsIEJhY2tib25lLCBfKTsKICB9IGVsc2UgewogICAgcm9vdC5NYXJpb25ldHRlID0gZmFjdG9yeShyb290LCByb290LkJhY2tib25lLCByb290Ll8pOwogIH0KfSh0aGlzLCBmdW5jdGlvbiAocm9vdCwgQmFja2JvbmUsIF8pIHsKICAKICB2YXIgcHJldmlvdXNNYXJpb25ldHRlID0gcm9vdC5NYXJpb25ldHRlOwogIHZhciBNYXJpb25ldHRlID0gQmFja2JvbmUuTWFyaW9uZXR0ZSA9IHt9OwogIE1hcmlvbmV0dGUuVkVSU0lPTiA9ICcyLjIuMCc7CiAgTWFyaW9uZXR0ZS5ub0NvbmZsaWN0ID0gZnVuY3Rpb24gKCkgewogICAgcm9vdC5NYXJpb25ldHRlID0gcHJldmlvdXNNYXJpb25ldHRlOwogICAgcmV0dXJuIHRoaXM7CiAgfTsKICAvLyBHZXQgdGhlIERlZmVycmVkIGNyZWF0b3IgZm9yIGxhdGVyIHVzZQogIE1hcmlvbmV0dGUuRGVmZXJyZWQgPSBCYWNrYm9uZS4kLkRlZmVycmVkOwogIC8qIGpzaGludCB1bnVzZWQ6IGZhbHNlICovCiAgLy8gSGVscGVycwogIC8vIC0tLS0tLS0KICAvLyBGb3Igc2xpY2luZyBgYXJndW1lbnRzYCBpbiBmdW5jdGlvbnMKICB2YXIgc2xpY2UgPSBBcnJheS5wcm90b3R5cGUuc2xpY2U7CiAgLy8gTWFyaW9uZXR0ZS5leHRlbmQKICAvLyAtLS0tLS0tLS0tLS0tLS0tLQogIC8vIEJvcnJvdyB0aGUgQmFja2JvbmUgYGV4dGVuZGAgbWV0aG9kIHNvIHdlIGNhbiB1c2UgaXQgYXMgbmVlZGVkCiAgTWFyaW9uZXR0ZS5leHRlbmQgPSBCYWNrYm9uZS5Nb2RlbC5leHRlbmQ7CiAgLy8gTWFyaW9uZXR0ZS5nZXRPcHRpb24KICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLQogIC8vIFJldHJpZXZlIGFuIG9iamVjdCwgZnVuY3Rpb24gb3Igb3RoZXIgdmFsdWUgZnJvbSBhIHRhcmdldAogIC8vIG9iamVjdCBvciBpdHMgYG9wdGlvbnNgLCB3aXRoIGBvcHRpb25zYCB0YWtpbmcgcHJlY2VkZW5jZS4KICBNYXJpb25ldHRlLmdldE9wdGlvbiA9IGZ1bmN0aW9uICh0YXJnZXQsIG9wdGlvbk5hbWUpIHsKICAgIGlmICghdGFyZ2V0IHx8ICFvcHRpb25OYW1lKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHZhciB2YWx1ZTsKICAgIGlmICh0YXJnZXQub3B0aW9ucyAmJiB0YXJnZXQub3B0aW9uc1tvcHRpb25OYW1lXSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgIHZhbHVlID0gdGFyZ2V0Lm9wdGlvbnNbb3B0aW9uTmFtZV07CiAgICB9IGVsc2UgewogICAgICB2YWx1ZSA9IHRhcmdldFtvcHRpb25OYW1lXTsKICAgIH0KICAgIHJldHVybiB2YWx1ZTsKICB9OwogIC8vIFByb3h5IGBNYXJpb25ldHRlLmdldE9wdGlvbmAKICBNYXJpb25ldHRlLnByb3h5R2V0T3B0aW9uID0gZnVuY3Rpb24gKG9wdGlvbk5hbWUpIHsKICAgIHJldHVybiBNYXJpb25ldHRlLmdldE9wdGlvbih0aGlzLCBvcHRpb25OYW1lKTsKICB9OwogIC8vIE1hcmlvbmV0dGUubm9ybWFsaXplTWV0aG9kcwogIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAvLyBQYXNzIGluIGEgbWFwcGluZyBvZiBldmVudHMgPT4gZnVuY3Rpb25zIG9yIGZ1bmN0aW9uIG5hbWVzCiAgLy8gYW5kIHJldHVybiBhIG1hcHBpbmcgb2YgZXZlbnRzID0+IGZ1bmN0aW9ucwogIE1hcmlvbmV0dGUubm9ybWFsaXplTWV0aG9kcyA9IGZ1bmN0aW9uIChoYXNoKSB7CiAgICB2YXIgbm9ybWFsaXplZEhhc2ggPSB7fTsKICAgIF8uZWFjaChoYXNoLCBmdW5jdGlvbiAobWV0aG9kLCBuYW1lKSB7CiAgICAgIGlmICghXy5pc0Z1bmN0aW9uKG1ldGhvZCkpIHsKICAgICAgICBtZXRob2QgPSB0aGlzW21ldGhvZF07CiAgICAgIH0KICAgICAgaWYgKCFtZXRob2QpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgbm9ybWFsaXplZEhhc2hbbmFtZV0gPSBtZXRob2Q7CiAgICB9LCB0aGlzKTsKICAgIHJldHVybiBub3JtYWxpemVkSGFzaDsKICB9OwogIC8vIHV0aWxpdHkgbWV0aG9kIGZvciBwYXJzaW5nIEB1aS4gc3ludGF4IHN0cmluZ3MKICAvLyBpbnRvIGFzc29jaWF0ZWQgc2VsZWN0b3IKICBNYXJpb25ldHRlLm5vcm1hbGl6ZVVJU3RyaW5nID0gZnVuY3Rpb24gKHVpU3RyaW5nLCB1aSkgewogICAgcmV0dXJuIHVpU3RyaW5nLnJlcGxhY2UoL0B1aVwuW2EtekEtWl8kMC05XSovZywgZnVuY3Rpb24gKHIpIHsKICAgICAgcmV0dXJuIHVpW3Iuc2xpY2UoNCldOwogICAgfSk7CiAgfTsKICAvLyBhbGxvd3MgZm9yIHRoZSB1c2Ugb2YgdGhlIEB1aS4gc3ludGF4IHdpdGhpbgogIC8vIGEgZ2l2ZW4ga2V5IGZvciB0cmlnZ2VycyBhbmQgZXZlbnRzCiAgLy8gc3dhcHMgdGhlIEB1aSB3aXRoIHRoZSBhc3NvY2lhdGVkIHNlbGVjdG9yLgogIC8vIFJldHVybnMgYSBuZXcsIG5vbi1tdXRhdGVkLCBwYXJzZWQgZXZlbnRzIGhhc2guCiAgTWFyaW9uZXR0ZS5ub3JtYWxpemVVSUtleXMgPSBmdW5jdGlvbiAoaGFzaCwgdWkpIHsKICAgIGlmICh0eXBlb2YgaGFzaCA9PT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgaGFzaCA9IF8uY2xvbmUoaGFzaCk7CiAgICBfLmVhY2goXy5rZXlzKGhhc2gpLCBmdW5jdGlvbiAoa2V5KSB7CiAgICAgIHZhciBub3JtYWxpemVkS2V5ID0gTWFyaW9uZXR0ZS5ub3JtYWxpemVVSVN0cmluZyhrZXksIHVpKTsKICAgICAgaWYgKG5vcm1hbGl6ZWRLZXkgIT09IGtleSkgewogICAgICAgIGhhc2hbbm9ybWFsaXplZEtleV0gPSBoYXNoW2tleV07CiAgICAgICAgZGVsZXRlIGhhc2hba2V5XTsKICAgICAgfQogICAgfSk7CiAgICByZXR1cm4gaGFzaDsKICB9OwogIC8vIGFsbG93cyBmb3IgdGhlIHVzZSBvZiB0aGUgQHVpLiBzeW50YXggd2l0aGluCiAgLy8gYSBnaXZlbiB2YWx1ZSBmb3IgcmVnaW9ucwogIC8vIHN3YXBzIHRoZSBAdWkgd2l0aCB0aGUgYXNzb2NpYXRlZCBzZWxlY3RvcgogIE1hcmlvbmV0dGUubm9ybWFsaXplVUlWYWx1ZXMgPSBmdW5jdGlvbiAoaGFzaCwgdWkpIHsKICAgIGlmICh0eXBlb2YgaGFzaCA9PT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgXy5lYWNoKGhhc2gsIGZ1bmN0aW9uICh2YWwsIGtleSkgewogICAgICBpZiAoXy5pc1N0cmluZyh2YWwpKSB7CiAgICAgICAgaGFzaFtrZXldID0gTWFyaW9uZXR0ZS5ub3JtYWxpemVVSVN0cmluZyh2YWwsIHVpKTsKICAgICAgfQogICAgfSk7CiAgICByZXR1cm4gaGFzaDsKICB9OwogIC8vIE1peCBpbiBtZXRob2RzIGZyb20gVW5kZXJzY29yZSwgZm9yIGl0ZXJhdGlvbiwgYW5kIG90aGVyCiAgLy8gY29sbGVjdGlvbiByZWxhdGVkIGZlYXR1cmVzLgogIC8vIEJvcnJvd2luZyB0aGlzIGNvZGUgZnJvbSBCYWNrYm9uZS5Db2xsZWN0aW9uOgogIC8vIGh0dHA6Ly9iYWNrYm9uZWpzLm9yZy9kb2NzL2JhY2tib25lLmh0bWwjc2VjdGlvbi0xMjEKICBNYXJpb25ldHRlLmFjdEFzQ29sbGVjdGlvbiA9IGZ1bmN0aW9uIChvYmplY3QsIGxpc3RQcm9wZXJ0eSkgewogICAgdmFyIG1ldGhvZHMgPSBbCiAgICAgICdmb3JFYWNoJywKICAgICAgJ2VhY2gnLAogICAgICAnbWFwJywKICAgICAgJ2ZpbmQnLAogICAgICAnZGV0ZWN0JywKICAgICAgJ2ZpbHRlcicsCiAgICAgICdzZWxlY3QnLAogICAgICAncmVqZWN0JywKICAgICAgJ2V2ZXJ5JywKICAgICAgJ2FsbCcsCiAgICAgICdzb21lJywKICAgICAgJ2FueScsCiAgICAgICdpbmNsdWRlJywKICAgICAgJ2NvbnRhaW5zJywKICAgICAgJ2ludm9rZScsCiAgICAgICd0b0FycmF5JywKICAgICAgJ2ZpcnN0JywKICAgICAgJ2luaXRpYWwnLAogICAgICAncmVzdCcsCiAgICAgICdsYXN0JywKICAgICAgJ3dpdGhvdXQnLAogICAgICAnaXNFbXB0eScsCiAgICAgICdwbHVjaycKICAgIF07CiAgICBfLmVhY2gobWV0aG9kcywgZnVuY3Rpb24gKG1ldGhvZCkgewogICAgICBvYmplY3RbbWV0aG9kXSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgbGlzdCA9IF8udmFsdWVzKF8ucmVzdWx0KHRoaXMsIGxpc3RQcm9wZXJ0eSkpOwogICAgICAgIHZhciBhcmdzID0gW2xpc3RdLmNvbmNhdChfLnRvQXJyYXkoYXJndW1lbnRzKSk7CiAgICAgICAgcmV0dXJuIF9bbWV0aG9kXS5hcHBseShfLCBhcmdzKTsKICAgICAgfTsKICAgIH0pOwogIH07CiAgLy8gVHJpZ2dlciBhbiBldmVudCBhbmQvb3IgYSBjb3JyZXNwb25kaW5nIG1ldGhvZCBuYW1lLiBFeGFtcGxlczoKICAvLwogIC8vIGB0aGlzLnRyaWdnZXJNZXRob2QoImZvbyIpYCB3aWxsIHRyaWdnZXIgdGhlICJmb28iIGV2ZW50IGFuZAogIC8vIGNhbGwgdGhlICJvbkZvbyIgbWV0aG9kLgogIC8vCiAgLy8gYHRoaXMudHJpZ2dlck1ldGhvZCgiZm9vOmJhciIpYCB3aWxsIHRyaWdnZXIgdGhlICJmb286YmFyIiBldmVudCBhbmQKICAvLyBjYWxsIHRoZSAib25Gb29CYXIiIG1ldGhvZC4KICBNYXJpb25ldHRlLnRyaWdnZXJNZXRob2QgPSBmdW5jdGlvbiAoZXZlbnQpIHsKICAgIC8vIHNwbGl0IHRoZSBldmVudCBuYW1lIG9uIHRoZSAiOiIKICAgIHZhciBzcGxpdHRlciA9IC8oXnw6KShcdykvZ2k7CiAgICAvLyB0YWtlIHRoZSBldmVudCBzZWN0aW9uICgic2VjdGlvbjE6c2VjdGlvbjI6c2VjdGlvbjMiKQogICAgLy8gYW5kIHR1cm4gaXQgaW4gdG8gdXBwZXJjYXNlIG5hbWUKICAgIGZ1bmN0aW9uIGdldEV2ZW50TmFtZShtYXRjaCwgcHJlZml4LCBldmVudE5hbWUpIHsKICAgICAgcmV0dXJuIGV2ZW50TmFtZS50b1VwcGVyQ2FzZSgpOwogICAgfQogICAgLy8gZ2V0IHRoZSBtZXRob2QgbmFtZSBmcm9tIHRoZSBldmVudCBuYW1lCiAgICB2YXIgbWV0aG9kTmFtZSA9ICdvbicgKyBldmVudC5yZXBsYWNlKHNwbGl0dGVyLCBnZXRFdmVudE5hbWUpOwogICAgdmFyIG1ldGhvZCA9IHRoaXNbbWV0aG9kTmFtZV07CiAgICB2YXIgcmVzdWx0OwogICAgLy8gY2FsbCB0aGUgb25NZXRob2ROYW1lIGlmIGl0IGV4aXN0cwogICAgaWYgKF8uaXNGdW5jdGlvbihtZXRob2QpKSB7CiAgICAgIC8vIHBhc3MgYWxsIGFyZ3VtZW50cywgZXhjZXB0IHRoZSBldmVudCBuYW1lCiAgICAgIHJlc3VsdCA9IG1ldGhvZC5hcHBseSh0aGlzLCBfLnRhaWwoYXJndW1lbnRzKSk7CiAgICB9CiAgICAvLyB0cmlnZ2VyIHRoZSBldmVudCwgaWYgYSB0cmlnZ2VyIG1ldGhvZCBleGlzdHMKICAgIGlmIChfLmlzRnVuY3Rpb24odGhpcy50cmlnZ2VyKSkgewogICAgICB0aGlzLnRyaWdnZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfTsKICAvLyB0cmlnZ2VyTWV0aG9kT24gaW52b2tlcyB0cmlnZ2VyTWV0aG9kIG9uIGEgc3BlY2lmaWMgY29udGV4dAogIC8vCiAgLy8gZS5nLiBgTWFyaW9uZXR0ZS50cmlnZ2VyTWV0aG9kT24odmlldywgJ3Nob3cnKWAKICAvLyB3aWxsIHRyaWdnZXIgYSAic2hvdyIgZXZlbnQgb3IgaW52b2tlIG9uU2hvdyB0aGUgdmlldy4KICBNYXJpb25ldHRlLnRyaWdnZXJNZXRob2RPbiA9IGZ1bmN0aW9uIChjb250ZXh0LCBldmVudCkgewogICAgdmFyIGFyZ3MgPSBfLnRhaWwoYXJndW1lbnRzLCAyKTsKICAgIHZhciBmbmM7CiAgICBpZiAoXy5pc0Z1bmN0aW9uKGNvbnRleHQudHJpZ2dlck1ldGhvZCkpIHsKICAgICAgZm5jID0gY29udGV4dC50cmlnZ2VyTWV0aG9kOwogICAgfSBlbHNlIHsKICAgICAgZm5jID0gTWFyaW9uZXR0ZS50cmlnZ2VyTWV0aG9kOwogICAgfQogICAgcmV0dXJuIGZuYy5hcHBseShjb250ZXh0LCBbZXZlbnRdLmNvbmNhdChhcmdzKSk7CiAgfTsKICAvLyBET01SZWZyZXNoCiAgLy8gLS0tLS0tLS0tLQogIC8vCiAgLy8gTW9uaXRvciBhIHZpZXcncyBzdGF0ZSwgYW5kIGFmdGVyIGl0IGhhcyBiZWVuIHJlbmRlcmVkIGFuZCBzaG93bgogIC8vIGluIHRoZSBET00sIHRyaWdnZXIgYSAiZG9tOnJlZnJlc2giIGV2ZW50IGV2ZXJ5IHRpbWUgaXQgaXMKICAvLyByZS1yZW5kZXJlZC4KICBNYXJpb25ldHRlLk1vbml0b3JET01SZWZyZXNoID0gZnVuY3Rpb24gKGRvY3VtZW50RWxlbWVudCkgewogICAgLy8gdHJhY2sgd2hlbiB0aGUgdmlldyBoYXMgYmVlbiBzaG93biBpbiB0aGUgRE9NLAogICAgLy8gdXNpbmcgYSBNYXJpb25ldHRlLlJlZ2lvbiAob3IgYnkgb3RoZXIgbWVhbnMgb2YgdHJpZ2dlcmluZyAic2hvdyIpCiAgICBmdW5jdGlvbiBoYW5kbGVTaG93KHZpZXcpIHsKICAgICAgdmlldy5faXNTaG93biA9IHRydWU7CiAgICAgIHRyaWdnZXJET01SZWZyZXNoKHZpZXcpOwogICAgfQogICAgLy8gdHJhY2sgd2hlbiB0aGUgdmlldyBoYXMgYmVlbiByZW5kZXJlZAogICAgZnVuY3Rpb24gaGFuZGxlUmVuZGVyKHZpZXcpIHsKICAgICAgdmlldy5faXNSZW5kZXJlZCA9IHRydWU7CiAgICAgIHRyaWdnZXJET01SZWZyZXNoKHZpZXcpOwogICAgfQogICAgLy8gVHJpZ2dlciB0aGUgImRvbTpyZWZyZXNoIiBldmVudCBhbmQgY29ycmVzcG9uZGluZyAib25Eb21SZWZyZXNoIiBtZXRob2QKICAgIGZ1bmN0aW9uIHRyaWdnZXJET01SZWZyZXNoKHZpZXcpIHsKICAgICAgaWYgKHZpZXcuX2lzU2hvd24gJiYgdmlldy5faXNSZW5kZXJlZCAmJiBpc0luRE9NKHZpZXcpKSB7CiAgICAgICAgaWYgKF8uaXNGdW5jdGlvbih2aWV3LnRyaWdnZXJNZXRob2QpKSB7CiAgICAgICAgICB2aWV3LnRyaWdnZXJNZXRob2QoJ2RvbTpyZWZyZXNoJyk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBmdW5jdGlvbiBpc0luRE9NKHZpZXcpIHsKICAgICAgcmV0dXJuIEJhY2tib25lLiQuY29udGFpbnMoZG9jdW1lbnRFbGVtZW50LCB2aWV3LmVsKTsKICAgIH0KICAgIC8vIEV4cG9ydCBwdWJsaWMgQVBJCiAgICByZXR1cm4gZnVuY3Rpb24gKHZpZXcpIHsKICAgICAgdmlldy5saXN0ZW5Ubyh2aWV3LCAnc2hvdycsIGZ1bmN0aW9uICgpIHsKICAgICAgICBoYW5kbGVTaG93KHZpZXcpOwogICAgICB9KTsKICAgICAgdmlldy5saXN0ZW5Ubyh2aWV3LCAncmVuZGVyJywgZnVuY3Rpb24gKCkgewogICAgICAgIGhhbmRsZVJlbmRlcih2aWV3KTsKICAgICAgfSk7CiAgICB9OwogIH0oZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50KTsKICAvKiBqc2hpbnQgbWF4cGFyYW1zOiA1ICovCiAgLy8gTWFyaW9uZXR0ZS5iaW5kRW50aXR5RXZlbnRzICYgdW5iaW5kRW50aXR5RXZlbnRzCiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgLy8KICAvLyBUaGVzZSBtZXRob2RzIGFyZSB1c2VkIHRvIGJpbmQvdW5iaW5kIGEgYmFja2JvbmUgImVudGl0eSIgKGNvbGxlY3Rpb24vbW9kZWwpCiAgLy8gdG8gbWV0aG9kcyBvbiBhIHRhcmdldCBvYmplY3QuCiAgLy8KICAvLyBUaGUgZmlyc3QgcGFyYW1ldGVyLCBgdGFyZ2V0YCwgbXVzdCBoYXZlIGEgYGxpc3RlblRvYCBtZXRob2QgZnJvbSB0aGUKICAvLyBFdmVudEJpbmRlciBvYmplY3QuCiAgLy8KICAvLyBUaGUgc2Vjb25kIHBhcmFtZXRlciBpcyB0aGUgZW50aXR5IChCYWNrYm9uZS5Nb2RlbCBvciBCYWNrYm9uZS5Db2xsZWN0aW9uKQogIC8vIHRvIGJpbmQgdGhlIGV2ZW50cyBmcm9tLgogIC8vCiAgLy8gVGhlIHRoaXJkIHBhcmFtZXRlciBpcyBhIGhhc2ggb2YgeyAiZXZlbnQ6bmFtZSI6ICJldmVudEhhbmRsZXIiIH0KICAvLyBjb25maWd1cmF0aW9uLiBNdWx0aXBsZSBoYW5kbGVycyBjYW4gYmUgc2VwYXJhdGVkIGJ5IGEgc3BhY2UuIEEKICAvLyBmdW5jdGlvbiBjYW4gYmUgc3VwcGxpZWQgaW5zdGVhZCBvZiBhIHN0cmluZyBoYW5kbGVyIG5hbWUuCiAgKGZ1bmN0aW9uIChNYXJpb25ldHRlKSB7CiAgICAKICAgIC8vIEJpbmQgdGhlIGV2ZW50IHRvIGhhbmRsZXJzIHNwZWNpZmllZCBhcyBhIHN0cmluZyBvZgogICAgLy8gaGFuZGxlciBuYW1lcyBvbiB0aGUgdGFyZ2V0IG9iamVjdAogICAgZnVuY3Rpb24gYmluZEZyb21TdHJpbmdzKHRhcmdldCwgZW50aXR5LCBldnQsIG1ldGhvZHMpIHsKICAgICAgdmFyIG1ldGhvZE5hbWVzID0gbWV0aG9kcy5zcGxpdCgvXHMrLyk7CiAgICAgIF8uZWFjaChtZXRob2ROYW1lcywgZnVuY3Rpb24gKG1ldGhvZE5hbWUpIHsKICAgICAgICB2YXIgbWV0aG9kID0gdGFyZ2V0W21ldGhvZE5hbWVdOwogICAgICAgIGlmICghbWV0aG9kKSB7CiAgICAgICAgICB0aHJvdyBuZXcgTWFyaW9uZXR0ZS5FcnJvcignTWV0aG9kICInICsgbWV0aG9kTmFtZSArICciIHdhcyBjb25maWd1cmVkIGFzIGFuIGV2ZW50IGhhbmRsZXIsIGJ1dCBkb2VzIG5vdCBleGlzdC4nKTsKICAgICAgICB9CiAgICAgICAgdGFyZ2V0Lmxpc3RlblRvKGVudGl0eSwgZXZ0LCBtZXRob2QpOwogICAgICB9KTsKICAgIH0KICAgIC8vIEJpbmQgdGhlIGV2ZW50IHRvIGEgc3VwcGxpZWQgY2FsbGJhY2sgZnVuY3Rpb24KICAgIGZ1bmN0aW9uIGJpbmRUb0Z1bmN0aW9uKHRhcmdldCwgZW50aXR5LCBldnQsIG1ldGhvZCkgewogICAgICB0YXJnZXQubGlzdGVuVG8oZW50aXR5LCBldnQsIG1ldGhvZCk7CiAgICB9CiAgICAvLyBCaW5kIHRoZSBldmVudCB0byBoYW5kbGVycyBzcGVjaWZpZWQgYXMgYSBzdHJpbmcgb2YKICAgIC8vIGhhbmRsZXIgbmFtZXMgb24gdGhlIHRhcmdldCBvYmplY3QKICAgIGZ1bmN0aW9uIHVuYmluZEZyb21TdHJpbmdzKHRhcmdldCwgZW50aXR5LCBldnQsIG1ldGhvZHMpIHsKICAgICAgdmFyIG1ldGhvZE5hbWVzID0gbWV0aG9kcy5zcGxpdCgvXHMrLyk7CiAgICAgIF8uZWFjaChtZXRob2ROYW1lcywgZnVuY3Rpb24gKG1ldGhvZE5hbWUpIHsKICAgICAgICB2YXIgbWV0aG9kID0gdGFyZ2V0W21ldGhvZE5hbWVdOwogICAgICAgIHRhcmdldC5zdG9wTGlzdGVuaW5nKGVudGl0eSwgZXZ0LCBtZXRob2QpOwogICAgICB9KTsKICAgIH0KICAgIC8vIEJpbmQgdGhlIGV2ZW50IHRvIGEgc3VwcGxpZWQgY2FsbGJhY2sgZnVuY3Rpb24KICAgIGZ1bmN0aW9uIHVuYmluZFRvRnVuY3Rpb24odGFyZ2V0LCBlbnRpdHksIGV2dCwgbWV0aG9kKSB7CiAgICAgIHRhcmdldC5zdG9wTGlzdGVuaW5nKGVudGl0eSwgZXZ0LCBtZXRob2QpOwogICAgfQogICAgLy8gZ2VuZXJpYyBsb29waW5nIGZ1bmN0aW9uCiAgICBmdW5jdGlvbiBpdGVyYXRlRXZlbnRzKHRhcmdldCwgZW50aXR5LCBiaW5kaW5ncywgZnVuY3Rpb25DYWxsYmFjaywgc3RyaW5nQ2FsbGJhY2spIHsKICAgICAgaWYgKCFlbnRpdHkgfHwgIWJpbmRpbmdzKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIC8vIHR5cGUtY2hlY2sgYmluZGluZ3MKICAgICAgaWYgKCFfLmlzRnVuY3Rpb24oYmluZGluZ3MpICYmICFfLmlzT2JqZWN0KGJpbmRpbmdzKSkgewogICAgICAgIHRocm93IG5ldyBNYXJpb25ldHRlLkVycm9yKHsKICAgICAgICAgIG1lc3NhZ2U6ICdCaW5kaW5ncyBtdXN0IGJlIGFuIG9iamVjdCBvciBmdW5jdGlvbi4nLAogICAgICAgICAgdXJsOiAnbWFyaW9uZXR0ZS5mdW5jdGlvbnMuaHRtbCNtYXJpb25ldHRlYmluZGVudGl0eWV2ZW50cycKICAgICAgICB9KTsKICAgICAgfQogICAgICAvLyBhbGxvdyB0aGUgYmluZGluZ3MgdG8gYmUgYSBmdW5jdGlvbgogICAgICBpZiAoXy5pc0Z1bmN0aW9uKGJpbmRpbmdzKSkgewogICAgICAgIGJpbmRpbmdzID0gYmluZGluZ3MuY2FsbCh0YXJnZXQpOwogICAgICB9CiAgICAgIC8vIGl0ZXJhdGUgdGhlIGJpbmRpbmdzIGFuZCBiaW5kIHRoZW0KICAgICAgXy5lYWNoKGJpbmRpbmdzLCBmdW5jdGlvbiAobWV0aG9kcywgZXZ0KSB7CiAgICAgICAgLy8gYWxsb3cgZm9yIGEgZnVuY3Rpb24gYXMgdGhlIGhhbmRsZXIsCiAgICAgICAgLy8gb3IgYSBsaXN0IG9mIGV2ZW50IG5hbWVzIGFzIGEgc3RyaW5nCiAgICAgICAgaWYgKF8uaXNGdW5jdGlvbihtZXRob2RzKSkgewogICAgICAgICAgZnVuY3Rpb25DYWxsYmFjayh0YXJnZXQsIGVudGl0eSwgZXZ0LCBtZXRob2RzKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgc3RyaW5nQ2FsbGJhY2sodGFyZ2V0LCBlbnRpdHksIGV2dCwgbWV0aG9kcyk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICAgIC8vIEV4cG9ydCBQdWJsaWMgQVBJCiAgICBNYXJpb25ldHRlLmJpbmRFbnRpdHlFdmVudHMgPSBmdW5jdGlvbiAodGFyZ2V0LCBlbnRpdHksIGJpbmRpbmdzKSB7CiAgICAgIGl0ZXJhdGVFdmVudHModGFyZ2V0LCBlbnRpdHksIGJpbmRpbmdzLCBiaW5kVG9GdW5jdGlvbiwgYmluZEZyb21TdHJpbmdzKTsKICAgIH07CiAgICBNYXJpb25ldHRlLnVuYmluZEVudGl0eUV2ZW50cyA9IGZ1bmN0aW9uICh0YXJnZXQsIGVudGl0eSwgYmluZGluZ3MpIHsKICAgICAgaXRlcmF0ZUV2ZW50cyh0YXJnZXQsIGVudGl0eSwgYmluZGluZ3MsIHVuYmluZFRvRnVuY3Rpb24sIHVuYmluZEZyb21TdHJpbmdzKTsKICAgIH07CiAgICAvLyBQcm94eSBgYmluZEVudGl0eUV2ZW50c2AKICAgIE1hcmlvbmV0dGUucHJveHlCaW5kRW50aXR5RXZlbnRzID0gZnVuY3Rpb24gKGVudGl0eSwgYmluZGluZ3MpIHsKICAgICAgcmV0dXJuIE1hcmlvbmV0dGUuYmluZEVudGl0eUV2ZW50cyh0aGlzLCBlbnRpdHksIGJpbmRpbmdzKTsKICAgIH07CiAgICAvLyBQcm94eSBgdW5iaW5kRW50aXR5RXZlbnRzYAogICAgTWFyaW9uZXR0ZS5wcm94eVVuYmluZEVudGl0eUV2ZW50cyA9IGZ1bmN0aW9uIChlbnRpdHksIGJpbmRpbmdzKSB7CiAgICAgIHJldHVybiBNYXJpb25ldHRlLnVuYmluZEVudGl0eUV2ZW50cyh0aGlzLCBlbnRpdHksIGJpbmRpbmdzKTsKICAgIH07CiAgfShNYXJpb25ldHRlKSk7CiAgdmFyIGVycm9yUHJvcHMgPSBbCiAgICAnZGVzY3JpcHRpb24nLAogICAgJ2ZpbGVOYW1lJywKICAgICdsaW5lTnVtYmVyJywKICAgICduYW1lJywKICAgICdtZXNzYWdlJywKICAgICdudW1iZXInCiAgXTsKICBNYXJpb25ldHRlLkVycm9yID0gTWFyaW9uZXR0ZS5leHRlbmQuY2FsbChFcnJvciwgewogICAgdXJsUm9vdDogJ2h0dHA6Ly9tYXJpb25ldHRlanMuY29tL2RvY3MvJyArIE1hcmlvbmV0dGUuVkVSU0lPTiArICcvJywKICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbiAobWVzc2FnZSwgb3B0aW9ucykgewogICAgICBpZiAoXy5pc09iamVjdChtZXNzYWdlKSkgewogICAgICAgIG9wdGlvbnMgPSBtZXNzYWdlOwogICAgICAgIG1lc3NhZ2UgPSBvcHRpb25zLm1lc3NhZ2U7CiAgICAgIH0gZWxzZSBpZiAoIW9wdGlvbnMpIHsKICAgICAgICBvcHRpb25zID0ge307CiAgICAgIH0KICAgICAgdmFyIGVycm9yID0gRXJyb3IuY2FsbCh0aGlzLCBtZXNzYWdlKTsKICAgICAgXy5leHRlbmQodGhpcywgXy5waWNrKGVycm9yLCBlcnJvclByb3BzKSwgXy5waWNrKG9wdGlvbnMsIGVycm9yUHJvcHMpKTsKICAgICAgdGhpcy5jYXB0dXJlU3RhY2tUcmFjZSgpOwogICAgICBpZiAob3B0aW9ucy51cmwpIHsKICAgICAgICB0aGlzLnVybCA9IHRoaXMudXJsUm9vdCArIG9wdGlvbnMudXJsOwogICAgICB9CiAgICB9LAogICAgY2FwdHVyZVN0YWNrVHJhY2U6IGZ1bmN0aW9uICgpIHsKICAgICAgaWYgKEVycm9yLmNhcHR1cmVTdGFja1RyYWNlKSB7CiAgICAgICAgRXJyb3IuY2FwdHVyZVN0YWNrVHJhY2UodGhpcywgTWFyaW9uZXR0ZS5FcnJvcik7CiAgICAgIH0KICAgIH0sCiAgICB0b1N0cmluZzogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gdGhpcy5uYW1lICsgJzogJyArIHRoaXMubWVzc2FnZSArICh0aGlzLnVybCA/ICcgU2VlOiAnICsgdGhpcy51cmwgOiAnJyk7CiAgICB9CiAgfSk7CiAgTWFyaW9uZXR0ZS5FcnJvci5leHRlbmQgPSBNYXJpb25ldHRlLmV4dGVuZDsKICAvLyBDYWxsYmFja3MKICAvLyAtLS0tLS0tLS0KICAvLyBBIHNpbXBsZSB3YXkgb2YgbWFuYWdpbmcgYSBjb2xsZWN0aW9uIG9mIGNhbGxiYWNrcwogIC8vIGFuZCBleGVjdXRpbmcgdGhlbSBhdCBhIGxhdGVyIHBvaW50IGluIHRpbWUsIHVzaW5nIGpRdWVyeSdzCiAgLy8gYERlZmVycmVkYCBvYmplY3QuCiAgTWFyaW9uZXR0ZS5DYWxsYmFja3MgPSBmdW5jdGlvbiAoKSB7CiAgICB0aGlzLl9kZWZlcnJlZCA9IE1hcmlvbmV0dGUuRGVmZXJyZWQoKTsKICAgIHRoaXMuX2NhbGxiYWNrcyA9IFtdOwogIH07CiAgXy5leHRlbmQoTWFyaW9uZXR0ZS5DYWxsYmFja3MucHJvdG90eXBlLCB7CiAgICAvLyBBZGQgYSBjYWxsYmFjayB0byBiZSBleGVjdXRlZC4gQ2FsbGJhY2tzIGFkZGVkIGhlcmUgYXJlCiAgICAvLyBndWFyYW50ZWVkIHRvIGV4ZWN1dGUsIGV2ZW4gaWYgdGhleSBhcmUgYWRkZWQgYWZ0ZXIgdGhlCiAgICAvLyBgcnVuYCBtZXRob2QgaXMgY2FsbGVkLgogICAgYWRkOiBmdW5jdGlvbiAoY2FsbGJhY2ssIGNvbnRleHRPdmVycmlkZSkgewogICAgICB2YXIgcHJvbWlzZSA9IF8ucmVzdWx0KHRoaXMuX2RlZmVycmVkLCAncHJvbWlzZScpOwogICAgICB0aGlzLl9jYWxsYmFja3MucHVzaCh7CiAgICAgICAgY2I6IGNhbGxiYWNrLAogICAgICAgIGN0eDogY29udGV4dE92ZXJyaWRlCiAgICAgIH0pOwogICAgICBwcm9taXNlLnRoZW4oZnVuY3Rpb24gKGFyZ3MpIHsKICAgICAgICBpZiAoY29udGV4dE92ZXJyaWRlKSB7CiAgICAgICAgICBhcmdzLmNvbnRleHQgPSBjb250ZXh0T3ZlcnJpZGU7CiAgICAgICAgfQogICAgICAgIGNhbGxiYWNrLmNhbGwoYXJncy5jb250ZXh0LCBhcmdzLm9wdGlvbnMpOwogICAgICB9KTsKICAgIH0sCiAgICAvLyBSdW4gYWxsIHJlZ2lzdGVyZWQgY2FsbGJhY2tzIHdpdGggdGhlIGNvbnRleHQgc3BlY2lmaWVkLgogICAgLy8gQWRkaXRpb25hbCBjYWxsYmFja3MgY2FuIGJlIGFkZGVkIGFmdGVyIHRoaXMgaGFzIGJlZW4gcnVuCiAgICAvLyBhbmQgdGhleSB3aWxsIHN0aWxsIGJlIGV4ZWN1dGVkLgogICAgcnVuOiBmdW5jdGlvbiAob3B0aW9ucywgY29udGV4dCkgewogICAgICB0aGlzLl9kZWZlcnJlZC5yZXNvbHZlKHsKICAgICAgICBvcHRpb25zOiBvcHRpb25zLAogICAgICAgIGNvbnRleHQ6IGNvbnRleHQKICAgICAgfSk7CiAgICB9LAogICAgLy8gUmVzZXRzIHRoZSBsaXN0IG9mIGNhbGxiYWNrcyB0byBiZSBydW4sIGFsbG93aW5nIHRoZSBzYW1lIGxpc3QKICAgIC8vIHRvIGJlIHJ1biBtdWx0aXBsZSB0aW1lcyAtIHdoZW5ldmVyIHRoZSBgcnVuYCBtZXRob2QgaXMgY2FsbGVkLgogICAgcmVzZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIGNhbGxiYWNrcyA9IHRoaXMuX2NhbGxiYWNrczsKICAgICAgdGhpcy5fZGVmZXJyZWQgPSBNYXJpb25ldHRlLkRlZmVycmVkKCk7CiAgICAgIHRoaXMuX2NhbGxiYWNrcyA9IFtdOwogICAgICBfLmVhY2goY2FsbGJhY2tzLCBmdW5jdGlvbiAoY2IpIHsKICAgICAgICB0aGlzLmFkZChjYi5jYiwgY2IuY3R4KTsKICAgICAgfSwgdGhpcyk7CiAgICB9CiAgfSk7CiAgLy8gTWFyaW9uZXR0ZSBDb250cm9sbGVyCiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgLy8KICAvLyBBIG11bHRpLXB1cnBvc2Ugb2JqZWN0IHRvIHVzZSBhcyBhIGNvbnRyb2xsZXIgZm9yCiAgLy8gbW9kdWxlcyBhbmQgcm91dGVycywgYW5kIGFzIGEgbWVkaWF0b3IgZm9yIHdvcmtmbG93CiAgLy8gYW5kIGNvb3JkaW5hdGlvbiBvZiBvdGhlciBvYmplY3RzLCB2aWV3cywgYW5kIG1vcmUuCiAgTWFyaW9uZXR0ZS5Db250cm9sbGVyID0gZnVuY3Rpb24gKG9wdGlvbnMpIHsKICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICBpZiAoXy5pc0Z1bmN0aW9uKHRoaXMuaW5pdGlhbGl6ZSkpIHsKICAgICAgdGhpcy5pbml0aWFsaXplKHRoaXMub3B0aW9ucyk7CiAgICB9CiAgfTsKICBNYXJpb25ldHRlLkNvbnRyb2xsZXIuZXh0ZW5kID0gTWFyaW9uZXR0ZS5leHRlbmQ7CiAgLy8gQ29udHJvbGxlciBNZXRob2RzCiAgLy8gLS0tLS0tLS0tLS0tLS0KICAvLyBFbnN1cmUgaXQgY2FuIHRyaWdnZXIgZXZlbnRzIHdpdGggQmFja2JvbmUuRXZlbnRzCiAgXy5leHRlbmQoTWFyaW9uZXR0ZS5Db250cm9sbGVyLnByb3RvdHlwZSwgQmFja2JvbmUuRXZlbnRzLCB7CiAgICBkZXN0cm95OiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMpOwogICAgICB0aGlzLnRyaWdnZXJNZXRob2QuYXBwbHkodGhpcywgWydiZWZvcmU6ZGVzdHJveSddLmNvbmNhdChhcmdzKSk7CiAgICAgIHRoaXMudHJpZ2dlck1ldGhvZC5hcHBseSh0aGlzLCBbJ2Rlc3Ryb3knXS5jb25jYXQoYXJncykpOwogICAgICB0aGlzLnN0b3BMaXN0ZW5pbmcoKTsKICAgICAgdGhpcy5vZmYoKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogICAgLy8gaW1wb3J0IHRoZSBgdHJpZ2dlck1ldGhvZGAgdG8gdHJpZ2dlciBldmVudHMgd2l0aCBjb3JyZXNwb25kaW5nCiAgICAvLyBtZXRob2RzIGlmIHRoZSBtZXRob2QgZXhpc3RzCiAgICB0cmlnZ2VyTWV0aG9kOiBNYXJpb25ldHRlLnRyaWdnZXJNZXRob2QsCiAgICAvLyBQcm94eSBgZ2V0T3B0aW9uYCB0byBlbmFibGUgZ2V0dGluZyBvcHRpb25zIGZyb20gdGhpcyBvciB0aGlzLm9wdGlvbnMgYnkgbmFtZS4KICAgIGdldE9wdGlvbjogTWFyaW9uZXR0ZS5wcm94eUdldE9wdGlvbgogIH0pOwogIC8vIE1hcmlvbmV0dGUgT2JqZWN0CiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgLy8KICAvLyBBIEJhc2UgQ2xhc3MgdGhhdCBvdGhlciBDbGFzc2VzIHNob3VsZCBkZXNjZW5kIGZyb20uCiAgLy8gT2JqZWN0IGJvcnJvd3MgbWFueSBjb252ZW50aW9ucyBhbmQgdXRpbGl0aWVzIGZyb20gQmFja2JvbmUuCiAgTWFyaW9uZXR0ZS5PYmplY3QgPSBmdW5jdGlvbiAob3B0aW9ucykgewogICAgdGhpcy5vcHRpb25zID0gXy5leHRlbmQoe30sIF8ucmVzdWx0KHRoaXMsICdvcHRpb25zJyksIG9wdGlvbnMpOwogICAgdGhpcy5pbml0aWFsaXplLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgfTsKICBNYXJpb25ldHRlLk9iamVjdC5leHRlbmQgPSBNYXJpb25ldHRlLmV4dGVuZDsKICAvLyBPYmplY3QgTWV0aG9kcwogIC8vIC0tLS0tLS0tLS0tLS0tCiAgXy5leHRlbmQoTWFyaW9uZXR0ZS5PYmplY3QucHJvdG90eXBlLCB7CiAgICAvL3RoaXMgaXMgYSBub29wIG1ldGhvZCBpbnRlbmRlZCB0byBiZSBvdmVycmlkZGVuIGJ5IGNsYXNzZXMgdGhhdCBleHRlbmQgZnJvbSB0aGlzIGJhc2UKICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uICgpIHsKICAgIH0sCiAgICBkZXN0cm95OiBmdW5jdGlvbiAoKSB7CiAgICAgIHRoaXMudHJpZ2dlck1ldGhvZCgnYmVmb3JlOmRlc3Ryb3knKTsKICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdkZXN0cm95Jyk7CiAgICAgIHRoaXMuc3RvcExpc3RlbmluZygpOwogICAgfSwKICAgIC8vIEltcG9ydCB0aGUgYHRyaWdnZXJNZXRob2RgIHRvIHRyaWdnZXIgZXZlbnRzIHdpdGggY29ycmVzcG9uZGluZwogICAgLy8gbWV0aG9kcyBpZiB0aGUgbWV0aG9kIGV4aXN0cwogICAgdHJpZ2dlck1ldGhvZDogTWFyaW9uZXR0ZS50cmlnZ2VyTWV0aG9kLAogICAgLy8gUHJveHkgYGdldE9wdGlvbmAgdG8gZW5hYmxlIGdldHRpbmcgb3B0aW9ucyBmcm9tIHRoaXMgb3IgdGhpcy5vcHRpb25zIGJ5IG5hbWUuCiAgICBnZXRPcHRpb246IE1hcmlvbmV0dGUucHJveHlHZXRPcHRpb24sCiAgICAvLyBQcm94eSBgdW5iaW5kRW50aXR5RXZlbnRzYCB0byBlbmFibGUgYmluZGluZyB2aWV3J3MgZXZlbnRzIGZyb20gYW5vdGhlciBlbnRpdHkuCiAgICBiaW5kRW50aXR5RXZlbnRzOiBNYXJpb25ldHRlLnByb3h5QmluZEVudGl0eUV2ZW50cywKICAgIC8vIFByb3h5IGB1bmJpbmRFbnRpdHlFdmVudHNgIHRvIGVuYWJsZSB1bmJpbmRpbmcgdmlldydzIGV2ZW50cyBmcm9tIGFub3RoZXIgZW50aXR5LgogICAgdW5iaW5kRW50aXR5RXZlbnRzOiBNYXJpb25ldHRlLnByb3h5VW5iaW5kRW50aXR5RXZlbnRzCiAgfSk7CiAgLy8gRW5zdXJlIGl0IGNhbiB0cmlnZ2VyIGV2ZW50cyB3aXRoIEJhY2tib25lLkV2ZW50cwogIF8uZXh0ZW5kKE1hcmlvbmV0dGUuT2JqZWN0LnByb3RvdHlwZSwgQmFja2JvbmUuRXZlbnRzKTsKICAvKiBqc2hpbnQgbWF4Y29tcGxleGl0eTogMTAsIG1heHN0YXRlbWVudHM6IDI5ICovCiAgLy8gUmVnaW9uCiAgLy8gLS0tLS0tCiAgLy8KICAvLyBNYW5hZ2UgdGhlIHZpc3VhbCByZWdpb25zIG9mIHlvdXIgY29tcG9zaXRlIGFwcGxpY2F0aW9uLiBTZWUKICAvLyBodHRwOi8vbG9zdGVjaGllcy5jb20vZGVyaWNrYmFpbGV5LzIwMTEvMTIvMTIvY29tcG9zaXRlLWpzLWFwcHMtcmVnaW9ucy1hbmQtcmVnaW9uLW1hbmFnZXJzLwogIE1hcmlvbmV0dGUuUmVnaW9uID0gZnVuY3Rpb24gKG9wdGlvbnMpIHsKICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICB0aGlzLmVsID0gdGhpcy5nZXRPcHRpb24oJ2VsJyk7CiAgICAvLyBIYW5kbGUgd2hlbiB0aGlzLmVsIGlzIHBhc3NlZCBpbiBhcyBhICQgd3JhcHBlZCBlbGVtZW50LgogICAgdGhpcy5lbCA9IHRoaXMuZWwgaW5zdGFuY2VvZiBCYWNrYm9uZS4kID8gdGhpcy5lbFswXSA6IHRoaXMuZWw7CiAgICBpZiAoIXRoaXMuZWwpIHsKICAgICAgdGhyb3cgbmV3IE1hcmlvbmV0dGUuRXJyb3IoewogICAgICAgIG5hbWU6ICdOb0VsRXJyb3InLAogICAgICAgIG1lc3NhZ2U6ICdBbiAiZWwiIG11c3QgYmUgc3BlY2lmaWVkIGZvciBhIHJlZ2lvbi4nCiAgICAgIH0pOwogICAgfQogICAgdGhpcy4kZWwgPSB0aGlzLmdldEVsKHRoaXMuZWwpOwogICAgaWYgKHRoaXMuaW5pdGlhbGl6ZSkgewogICAgICB2YXIgYXJncyA9IHNsaWNlLmFwcGx5KGFyZ3VtZW50cyk7CiAgICAgIHRoaXMuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmdzKTsKICAgIH0KICB9OwogIC8vIFJlZ2lvbiBDbGFzcyBtZXRob2RzCiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLQogIF8uZXh0ZW5kKE1hcmlvbmV0dGUuUmVnaW9uLCB7CiAgICAvLyBCdWlsZCBhbiBpbnN0YW5jZSBvZiBhIHJlZ2lvbiBieSBwYXNzaW5nIGluIGEgY29uZmlndXJhdGlvbiBvYmplY3QKICAgIC8vIGFuZCBhIGRlZmF1bHQgcmVnaW9uIGNsYXNzIHRvIHVzZSBpZiBub25lIGlzIHNwZWNpZmllZCBpbiB0aGUgY29uZmlnLgogICAgLy8KICAgIC8vIFRoZSBjb25maWcgb2JqZWN0IHNob3VsZCBlaXRoZXIgYmUgYSBzdHJpbmcgYXMgYSBqUXVlcnkgRE9NIHNlbGVjdG9yLAogICAgLy8gYSBSZWdpb24gY2xhc3MgZGlyZWN0bHksIG9yIGFuIG9iamVjdCBsaXRlcmFsIHRoYXQgc3BlY2lmaWVzIGJvdGgKICAgIC8vIGEgc2VsZWN0b3IgYW5kIHJlZ2lvbkNsYXNzOgogICAgLy8KICAgIC8vIGBgYGpzCiAgICAvLyB7CiAgICAvLyAgIHNlbGVjdG9yOiAiI2ZvbyIsCiAgICAvLyAgIHJlZ2lvbkNsYXNzOiBNeUN1c3RvbVJlZ2lvbgogICAgLy8gfQogICAgLy8gYGBgCiAgICAvLwogICAgYnVpbGRSZWdpb246IGZ1bmN0aW9uIChyZWdpb25Db25maWcsIERlZmF1bHRSZWdpb25DbGFzcykgewogICAgICBpZiAoXy5pc1N0cmluZyhyZWdpb25Db25maWcpKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2J1aWxkUmVnaW9uRnJvbVNlbGVjdG9yKHJlZ2lvbkNvbmZpZywgRGVmYXVsdFJlZ2lvbkNsYXNzKTsKICAgICAgfQogICAgICBpZiAocmVnaW9uQ29uZmlnLnNlbGVjdG9yIHx8IHJlZ2lvbkNvbmZpZy5lbCB8fCByZWdpb25Db25maWcucmVnaW9uQ2xhc3MpIHsKICAgICAgICByZXR1cm4gdGhpcy5fYnVpbGRSZWdpb25Gcm9tT2JqZWN0KHJlZ2lvbkNvbmZpZywgRGVmYXVsdFJlZ2lvbkNsYXNzKTsKICAgICAgfQogICAgICBpZiAoXy5pc0Z1bmN0aW9uKHJlZ2lvbkNvbmZpZykpIHsKICAgICAgICByZXR1cm4gdGhpcy5fYnVpbGRSZWdpb25Gcm9tUmVnaW9uQ2xhc3MocmVnaW9uQ29uZmlnKTsKICAgICAgfQogICAgICB0aHJvdyBuZXcgTWFyaW9uZXR0ZS5FcnJvcih7CiAgICAgICAgbWVzc2FnZTogJ0ltcHJvcGVyIHJlZ2lvbiBjb25maWd1cmF0aW9uIHR5cGUuJywKICAgICAgICB1cmw6ICdtYXJpb25ldHRlLnJlZ2lvbi5odG1sI3JlZ2lvbi1jb25maWd1cmF0aW9uLXR5cGVzJwogICAgICB9KTsKICAgIH0sCiAgICAvLyBCdWlsZCB0aGUgcmVnaW9uIGZyb20gYSBzdHJpbmcgc2VsZWN0b3IgbGlrZSAnI2Zvby1yZWdpb24nCiAgICBfYnVpbGRSZWdpb25Gcm9tU2VsZWN0b3I6IGZ1bmN0aW9uIChzZWxlY3RvciwgRGVmYXVsdFJlZ2lvbkNsYXNzKSB7CiAgICAgIHJldHVybiBuZXcgRGVmYXVsdFJlZ2lvbkNsYXNzKHsgZWw6IHNlbGVjdG9yIH0pOwogICAgfSwKICAgIC8vIEJ1aWxkIHRoZSByZWdpb24gZnJvbSBhIGNvbmZpZ3VyYXRpb24gb2JqZWN0CiAgICAvLyBgYGBqcwogICAgLy8geyBzZWxlY3RvcjogJyNmb28nLCByZWdpb25DbGFzczogRm9vUmVnaW9uIH0KICAgIC8vIGBgYAogICAgX2J1aWxkUmVnaW9uRnJvbU9iamVjdDogZnVuY3Rpb24gKHJlZ2lvbkNvbmZpZywgRGVmYXVsdFJlZ2lvbkNsYXNzKSB7CiAgICAgIHZhciBSZWdpb25DbGFzcyA9IHJlZ2lvbkNvbmZpZy5yZWdpb25DbGFzcyB8fCBEZWZhdWx0UmVnaW9uQ2xhc3M7CiAgICAgIHZhciBvcHRpb25zID0gXy5vbWl0KHJlZ2lvbkNvbmZpZywgJ3NlbGVjdG9yJywgJ3JlZ2lvbkNsYXNzJyk7CiAgICAgIGlmIChyZWdpb25Db25maWcuc2VsZWN0b3IgJiYgIW9wdGlvbnMuZWwpIHsKICAgICAgICBvcHRpb25zLmVsID0gcmVnaW9uQ29uZmlnLnNlbGVjdG9yOwogICAgICB9CiAgICAgIHZhciByZWdpb24gPSBuZXcgUmVnaW9uQ2xhc3Mob3B0aW9ucyk7CiAgICAgIC8vIG92ZXJyaWRlIHRoZSBgZ2V0RWxgIGZ1bmN0aW9uIGlmIHdlIGhhdmUgYSBwYXJlbnRFbAogICAgICAvLyB0aGlzIG11c3QgYmUgb3ZlcnJpZGRlbiB0byBlbnN1cmUgdGhlIHNlbGVjdG9yIGlzIGZvdW5kCiAgICAgIC8vIG9uIHRoZSBmaXJzdCB1c2Ugb2YgdGhlIHJlZ2lvbi4gaWYgd2UgdHJ5IHRvIGFzc2lnbiB0aGUKICAgICAgLy8gcmVnaW9uJ3MgYGVsYCB0byBgcGFyZW50RWwuZmluZChzZWxlY3RvcilgIGluIHRoZSBvYmplY3QKICAgICAgLy8gbGl0ZXJhbCB0byBidWlsZCB0aGUgcmVnaW9uLCB0aGUgZWxlbWVudCB3aWxsIG5vdCBiZQogICAgICAvLyBndWFyYW50ZWVkIHRvIGJlIGluIHRoZSBET00gYWxyZWFkeSwgYW5kIHdpbGwgY2F1c2UgcHJvYmxlbXMKICAgICAgaWYgKHJlZ2lvbkNvbmZpZy5wYXJlbnRFbCkgewogICAgICAgIHJlZ2lvbi5nZXRFbCA9IGZ1bmN0aW9uIChlbCkgewogICAgICAgICAgaWYgKF8uaXNPYmplY3QoZWwpKSB7CiAgICAgICAgICAgIHJldHVybiBCYWNrYm9uZS4kKGVsKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBwYXJlbnRFbCA9IHJlZ2lvbkNvbmZpZy5wYXJlbnRFbDsKICAgICAgICAgIGlmIChfLmlzRnVuY3Rpb24ocGFyZW50RWwpKSB7CiAgICAgICAgICAgIHBhcmVudEVsID0gcGFyZW50RWwoKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBwYXJlbnRFbC5maW5kKGVsKTsKICAgICAgICB9OwogICAgICB9CiAgICAgIHJldHVybiByZWdpb247CiAgICB9LAogICAgLy8gQnVpbGQgdGhlIHJlZ2lvbiBkaXJlY3RseSBmcm9tIGEgZ2l2ZW4gYFJlZ2lvbkNsYXNzYAogICAgX2J1aWxkUmVnaW9uRnJvbVJlZ2lvbkNsYXNzOiBmdW5jdGlvbiAoUmVnaW9uQ2xhc3MpIHsKICAgICAgcmV0dXJuIG5ldyBSZWdpb25DbGFzcygpOwogICAgfQogIH0pOwogIC8vIFJlZ2lvbiBJbnN0YW5jZSBNZXRob2RzCiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICBfLmV4dGVuZChNYXJpb25ldHRlLlJlZ2lvbi5wcm90b3R5cGUsIEJhY2tib25lLkV2ZW50cywgewogICAgLy8gRGlzcGxheXMgYSBiYWNrYm9uZSB2aWV3IGluc3RhbmNlIGluc2lkZSBvZiB0aGUgcmVnaW9uLgogICAgLy8gSGFuZGxlcyBjYWxsaW5nIHRoZSBgcmVuZGVyYCBtZXRob2QgZm9yIHlvdS4gUmVhZHMgY29udGVudAogICAgLy8gZGlyZWN0bHkgZnJvbSB0aGUgYGVsYCBhdHRyaWJ1dGUuIEFsc28gY2FsbHMgYW4gb3B0aW9uYWwKICAgIC8vIGBvblNob3dgIGFuZCBgb25EZXN0cm95YCBtZXRob2Qgb24geW91ciB2aWV3LCBqdXN0IGFmdGVyIHNob3dpbmcKICAgIC8vIG9yIGp1c3QgYmVmb3JlIGRlc3Ryb3lpbmcgdGhlIHZpZXcsIHJlc3BlY3RpdmVseS4KICAgIC8vIFRoZSBgcHJldmVudERlc3Ryb3lgIG9wdGlvbiBjYW4gYmUgdXNlZCB0byBwcmV2ZW50IGEgdmlldyBmcm9tCiAgICAvLyB0aGUgb2xkIHZpZXcgYmVpbmcgZGVzdHJveWVkIG9uIHNob3cuCiAgICAvLyBUaGUgYGZvcmNlU2hvd2Agb3B0aW9uIGNhbiBiZSB1c2VkIHRvIGZvcmNlIGEgdmlldyB0byBiZQogICAgLy8gcmUtcmVuZGVyZWQgaWYgaXQncyBhbHJlYWR5IHNob3duIGluIHRoZSByZWdpb24uCiAgICBzaG93OiBmdW5jdGlvbiAodmlldywgb3B0aW9ucykgewogICAgICB0aGlzLl9lbnN1cmVFbGVtZW50KCk7CiAgICAgIHZhciBzaG93T3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICAgIHZhciBpc0RpZmZlcmVudFZpZXcgPSB2aWV3ICE9PSB0aGlzLmN1cnJlbnRWaWV3OwogICAgICB2YXIgcHJldmVudERlc3Ryb3kgPSAhIXNob3dPcHRpb25zLnByZXZlbnREZXN0cm95OwogICAgICB2YXIgZm9yY2VTaG93ID0gISFzaG93T3B0aW9ucy5mb3JjZVNob3c7CiAgICAgIC8vIHdlIGFyZSBvbmx5IGNoYW5naW5nIHRoZSB2aWV3IGlmIHRoZXJlIGlzIGEgdmlldyB0byBjaGFuZ2UgdG8gYmVnaW4gd2l0aAogICAgICB2YXIgaXNDaGFuZ2luZ1ZpZXcgPSAhIXRoaXMuY3VycmVudFZpZXc7CiAgICAgIC8vIG9ubHkgZGVzdHJveSB0aGUgdmlldyBpZiB3ZSBkb24ndCB3YW50IHRvIHByZXZlbnREZXN0cm95IGFuZCB0aGUgdmlldyBpcyBkaWZmZXJlbnQKICAgICAgdmFyIF9zaG91bGREZXN0cm95VmlldyA9ICFwcmV2ZW50RGVzdHJveSAmJiBpc0RpZmZlcmVudFZpZXc7CiAgICAgIC8vIHNob3cgdGhlIHZpZXcgaWYgdGhlIHZpZXcgaXMgZGlmZmVyZW50IG9yIGlmIHlvdSB3YW50IHRvIHJlLXNob3cgdGhlIHZpZXcKICAgICAgdmFyIF9zaG91bGRTaG93VmlldyA9IGlzRGlmZmVyZW50VmlldyB8fCBmb3JjZVNob3c7CiAgICAgIGlmIChpc0NoYW5naW5nVmlldykgewogICAgICAgIHRoaXMudHJpZ2dlck1ldGhvZCgnYmVmb3JlOnN3YXBPdXQnLCB0aGlzLmN1cnJlbnRWaWV3KTsKICAgICAgfQogICAgICBpZiAoX3Nob3VsZERlc3Ryb3lWaWV3KSB7CiAgICAgICAgdGhpcy5lbXB0eSgpOwogICAgICB9CiAgICAgIGlmIChfc2hvdWxkU2hvd1ZpZXcpIHsKICAgICAgICAvLyBXZSBuZWVkIHRvIGxpc3RlbiBmb3IgaWYgYSB2aWV3IGlzIGRlc3Ryb3llZAogICAgICAgIC8vIGluIGEgd2F5IG90aGVyIHRoYW4gdGhyb3VnaCB0aGUgcmVnaW9uLgogICAgICAgIC8vIElmIHRoaXMgaGFwcGVucyB3ZSBuZWVkIHRvIHJlbW92ZSB0aGUgcmVmZXJlbmNlCiAgICAgICAgLy8gdG8gdGhlIGN1cnJlbnRWaWV3IHNpbmNlIG9uY2UgYSB2aWV3IGhhcyBiZWVuIGRlc3Ryb3llZAogICAgICAgIC8vIHdlIGNhbiBub3QgcmV1c2UgaXQuCiAgICAgICAgdmlldy5vbmNlKCdkZXN0cm95JywgXy5iaW5kKHRoaXMuZW1wdHksIHRoaXMpKTsKICAgICAgICB2aWV3LnJlbmRlcigpOwogICAgICAgIGlmIChpc0NoYW5naW5nVmlldykgewogICAgICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdiZWZvcmU6c3dhcCcsIHZpZXcpOwogICAgICAgIH0KICAgICAgICB0aGlzLnRyaWdnZXJNZXRob2QoJ2JlZm9yZTpzaG93Jywgdmlldyk7CiAgICAgICAgTWFyaW9uZXR0ZS50cmlnZ2VyTWV0aG9kT24odmlldywgJ2JlZm9yZTpzaG93Jyk7CiAgICAgICAgaWYgKGlzQ2hhbmdpbmdWaWV3KSB7CiAgICAgICAgICB0aGlzLnRyaWdnZXJNZXRob2QoJ3N3YXBPdXQnLCB0aGlzLmN1cnJlbnRWaWV3KTsKICAgICAgICB9CiAgICAgICAgdGhpcy5hdHRhY2hIdG1sKHZpZXcpOwogICAgICAgIHRoaXMuY3VycmVudFZpZXcgPSB2aWV3OwogICAgICAgIGlmIChpc0NoYW5naW5nVmlldykgewogICAgICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdzd2FwJywgdmlldyk7CiAgICAgICAgfQogICAgICAgIHRoaXMudHJpZ2dlck1ldGhvZCgnc2hvdycsIHZpZXcpOwogICAgICAgIE1hcmlvbmV0dGUudHJpZ2dlck1ldGhvZE9uKHZpZXcsICdzaG93Jyk7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogICAgX2Vuc3VyZUVsZW1lbnQ6IGZ1bmN0aW9uICgpIHsKICAgICAgaWYgKCFfLmlzT2JqZWN0KHRoaXMuZWwpKSB7CiAgICAgICAgdGhpcy4kZWwgPSB0aGlzLmdldEVsKHRoaXMuZWwpOwogICAgICAgIHRoaXMuZWwgPSB0aGlzLiRlbFswXTsKICAgICAgfQogICAgICBpZiAoIXRoaXMuJGVsIHx8IHRoaXMuJGVsLmxlbmd0aCA9PT0gMCkgewogICAgICAgIHRocm93IG5ldyBNYXJpb25ldHRlLkVycm9yKCdBbiAiZWwiICcgKyB0aGlzLiRlbC5zZWxlY3RvciArICcgbXVzdCBleGlzdCBpbiBET00nKTsKICAgICAgfQogICAgfSwKICAgIC8vIE92ZXJyaWRlIHRoaXMgbWV0aG9kIHRvIGNoYW5nZSBob3cgdGhlIHJlZ2lvbiBmaW5kcyB0aGUKICAgIC8vIERPTSBlbGVtZW50IHRoYXQgaXQgbWFuYWdlcy4gUmV0dXJuIGEgalF1ZXJ5IHNlbGVjdG9yIG9iamVjdC4KICAgIGdldEVsOiBmdW5jdGlvbiAoZWwpIHsKICAgICAgcmV0dXJuIEJhY2tib25lLiQoZWwpOwogICAgfSwKICAgIC8vIE92ZXJyaWRlIHRoaXMgbWV0aG9kIHRvIGNoYW5nZSBob3cgdGhlIG5ldyB2aWV3IGlzCiAgICAvLyBhcHBlbmRlZCB0byB0aGUgYCRlbGAgdGhhdCB0aGUgcmVnaW9uIGlzIG1hbmFnaW5nCiAgICBhdHRhY2hIdG1sOiBmdW5jdGlvbiAodmlldykgewogICAgICAvLyBlbXB0eSB0aGUgbm9kZSBhbmQgYXBwZW5kIG5ldyB2aWV3CiAgICAgIHRoaXMuZWwuaW5uZXJIVE1MID0gJyc7CiAgICAgIHRoaXMuZWwuYXBwZW5kQ2hpbGQodmlldy5lbCk7CiAgICB9LAogICAgLy8gRGVzdHJveSB0aGUgY3VycmVudCB2aWV3LCBpZiB0aGVyZSBpcyBvbmUuIElmIHRoZXJlIGlzIG5vCiAgICAvLyBjdXJyZW50IHZpZXcsIGl0IGRvZXMgbm90aGluZyBhbmQgcmV0dXJucyBpbW1lZGlhdGVseS4KICAgIGVtcHR5OiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciB2aWV3ID0gdGhpcy5jdXJyZW50VmlldzsKICAgICAgLy8gSWYgdGhlcmUgaXMgbm8gdmlldyBpbiB0aGUgcmVnaW9uCiAgICAgIC8vIHdlIHNob3VsZCBub3QgcmVtb3ZlIGFueXRoaW5nCiAgICAgIGlmICghdmlldykgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICB0aGlzLnRyaWdnZXJNZXRob2QoJ2JlZm9yZTplbXB0eScsIHZpZXcpOwogICAgICB0aGlzLl9kZXN0cm95VmlldygpOwogICAgICB0aGlzLnRyaWdnZXJNZXRob2QoJ2VtcHR5Jywgdmlldyk7CiAgICAgIC8vIFJlbW92ZSByZWdpb24gcG9pbnRlciB0byB0aGUgY3VycmVudFZpZXcKICAgICAgZGVsZXRlIHRoaXMuY3VycmVudFZpZXc7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAgIC8vIGNhbGwgJ2Rlc3Ryb3knIG9yICdyZW1vdmUnLCBkZXBlbmRpbmcgb24gd2hpY2ggaXMgZm91bmQKICAgIC8vIG9uIHRoZSB2aWV3IChpZiBzaG93aW5nIGEgcmF3IEJhY2tib25lIHZpZXcgb3IgYSBNYXJpb25ldHRlIFZpZXcpCiAgICBfZGVzdHJveVZpZXc6IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIHZpZXcgPSB0aGlzLmN1cnJlbnRWaWV3OwogICAgICBpZiAodmlldy5kZXN0cm95ICYmICF2aWV3LmlzRGVzdHJveWVkKSB7CiAgICAgICAgdmlldy5kZXN0cm95KCk7CiAgICAgIH0gZWxzZSBpZiAodmlldy5yZW1vdmUpIHsKICAgICAgICB2aWV3LnJlbW92ZSgpOwogICAgICB9CiAgICB9LAogICAgLy8gQXR0YWNoIGFuIGV4aXN0aW5nIHZpZXcgdG8gdGhlIHJlZ2lvbi4gVGhpcwogICAgLy8gd2lsbCBub3QgY2FsbCBgcmVuZGVyYCBvciBgb25TaG93YCBmb3IgdGhlIG5ldyB2aWV3LAogICAgLy8gYW5kIHdpbGwgbm90IHJlcGxhY2UgdGhlIGN1cnJlbnQgSFRNTCBmb3IgdGhlIGBlbGAKICAgIC8vIG9mIHRoZSByZWdpb24uCiAgICBhdHRhY2hWaWV3OiBmdW5jdGlvbiAodmlldykgewogICAgICB0aGlzLmN1cnJlbnRWaWV3ID0gdmlldzsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogICAgLy8gQ2hlY2tzIHdoZXRoZXIgYSB2aWV3IGlzIGN1cnJlbnRseSBwcmVzZW50IHdpdGhpbgogICAgLy8gdGhlIHJlZ2lvbi4gUmV0dXJucyBgdHJ1ZWAgaWYgdGhlcmUgaXMgYW5kIGBmYWxzZWAgaWYKICAgIC8vIG5vIHZpZXcgaXMgcHJlc2VudC4KICAgIGhhc1ZpZXc6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuICEhdGhpcy5jdXJyZW50VmlldzsKICAgIH0sCiAgICAvLyBSZXNldCB0aGUgcmVnaW9uIGJ5IGRlc3Ryb3lpbmcgYW55IGV4aXN0aW5nIHZpZXcgYW5kCiAgICAvLyBjbGVhcmluZyBvdXQgdGhlIGNhY2hlZCBgJGVsYC4gVGhlIG5leHQgdGltZSBhIHZpZXcKICAgIC8vIGlzIHNob3duIHZpYSB0aGlzIHJlZ2lvbiwgdGhlIHJlZ2lvbiB3aWxsIHJlLXF1ZXJ5IHRoZQogICAgLy8gRE9NIGZvciB0aGUgcmVnaW9uJ3MgYGVsYC4KICAgIHJlc2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgIHRoaXMuZW1wdHkoKTsKICAgICAgaWYgKHRoaXMuJGVsKSB7CiAgICAgICAgdGhpcy5lbCA9IHRoaXMuJGVsLnNlbGVjdG9yOwogICAgICB9CiAgICAgIGRlbGV0ZSB0aGlzLiRlbDsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogICAgLy8gUHJveHkgYGdldE9wdGlvbmAgdG8gZW5hYmxlIGdldHRpbmcgb3B0aW9ucyBmcm9tIHRoaXMgb3IgdGhpcy5vcHRpb25zIGJ5IG5hbWUuCiAgICBnZXRPcHRpb246IE1hcmlvbmV0dGUucHJveHlHZXRPcHRpb24sCiAgICAvLyBpbXBvcnQgdGhlIGB0cmlnZ2VyTWV0aG9kYCB0byB0cmlnZ2VyIGV2ZW50cyB3aXRoIGNvcnJlc3BvbmRpbmcKICAgIC8vIG1ldGhvZHMgaWYgdGhlIG1ldGhvZCBleGlzdHMKICAgIHRyaWdnZXJNZXRob2Q6IE1hcmlvbmV0dGUudHJpZ2dlck1ldGhvZAogIH0pOwogIC8vIENvcHkgdGhlIGBleHRlbmRgIGZ1bmN0aW9uIHVzZWQgYnkgQmFja2JvbmUncyBjbGFzc2VzCiAgTWFyaW9uZXR0ZS5SZWdpb24uZXh0ZW5kID0gTWFyaW9uZXR0ZS5leHRlbmQ7CiAgLy8gTWFyaW9uZXR0ZS5SZWdpb25NYW5hZ2VyCiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgLy8KICAvLyBNYW5hZ2Ugb25lIG9yIG1vcmUgcmVsYXRlZCBgTWFyaW9uZXR0ZS5SZWdpb25gIG9iamVjdHMuCiAgTWFyaW9uZXR0ZS5SZWdpb25NYW5hZ2VyID0gZnVuY3Rpb24gKE1hcmlvbmV0dGUpIHsKICAgIHZhciBSZWdpb25NYW5hZ2VyID0gTWFyaW9uZXR0ZS5Db250cm9sbGVyLmV4dGVuZCh7CiAgICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbiAob3B0aW9ucykgewogICAgICAgIHRoaXMuX3JlZ2lvbnMgPSB7fTsKICAgICAgICBNYXJpb25ldHRlLkNvbnRyb2xsZXIuY2FsbCh0aGlzLCBvcHRpb25zKTsKICAgICAgfSwKICAgICAgLy8gQWRkIG11bHRpcGxlIHJlZ2lvbnMgdXNpbmcgYW4gb2JqZWN0IGxpdGVyYWwgb3IgYQogICAgICAvLyBmdW5jdGlvbiB0aGF0IHJldHVybnMgYW4gb2JqZWN0IGxpdGVyYWwsIHdoZXJlCiAgICAgIC8vIGVhY2gga2V5IGJlY29tZXMgdGhlIHJlZ2lvbiBuYW1lLCBhbmQgZWFjaCB2YWx1ZSBpcwogICAgICAvLyB0aGUgcmVnaW9uIGRlZmluaXRpb24uCiAgICAgIGFkZFJlZ2lvbnM6IGZ1bmN0aW9uIChyZWdpb25EZWZpbml0aW9ucywgZGVmYXVsdHMpIHsKICAgICAgICBpZiAoXy5pc0Z1bmN0aW9uKHJlZ2lvbkRlZmluaXRpb25zKSkgewogICAgICAgICAgcmVnaW9uRGVmaW5pdGlvbnMgPSByZWdpb25EZWZpbml0aW9ucy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgIH0KICAgICAgICB2YXIgcmVnaW9ucyA9IHt9OwogICAgICAgIF8uZWFjaChyZWdpb25EZWZpbml0aW9ucywgZnVuY3Rpb24gKGRlZmluaXRpb24sIG5hbWUpIHsKICAgICAgICAgIGlmIChfLmlzU3RyaW5nKGRlZmluaXRpb24pKSB7CiAgICAgICAgICAgIGRlZmluaXRpb24gPSB7IHNlbGVjdG9yOiBkZWZpbml0aW9uIH07CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZGVmaW5pdGlvbi5zZWxlY3RvcikgewogICAgICAgICAgICBkZWZpbml0aW9uID0gXy5kZWZhdWx0cyh7fSwgZGVmaW5pdGlvbiwgZGVmYXVsdHMpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHJlZ2lvbiA9IHRoaXMuYWRkUmVnaW9uKG5hbWUsIGRlZmluaXRpb24pOwogICAgICAgICAgcmVnaW9uc1tuYW1lXSA9IHJlZ2lvbjsKICAgICAgICB9LCB0aGlzKTsKICAgICAgICByZXR1cm4gcmVnaW9uczsKICAgICAgfSwKICAgICAgLy8gQWRkIGFuIGluZGl2aWR1YWwgcmVnaW9uIHRvIHRoZSByZWdpb24gbWFuYWdlciwKICAgICAgLy8gYW5kIHJldHVybiB0aGUgcmVnaW9uIGluc3RhbmNlCiAgICAgIGFkZFJlZ2lvbjogZnVuY3Rpb24gKG5hbWUsIGRlZmluaXRpb24pIHsKICAgICAgICB2YXIgcmVnaW9uOwogICAgICAgIGlmIChkZWZpbml0aW9uIGluc3RhbmNlb2YgTWFyaW9uZXR0ZS5SZWdpb24pIHsKICAgICAgICAgIHJlZ2lvbiA9IGRlZmluaXRpb247CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJlZ2lvbiA9IE1hcmlvbmV0dGUuUmVnaW9uLmJ1aWxkUmVnaW9uKGRlZmluaXRpb24sIE1hcmlvbmV0dGUuUmVnaW9uKTsKICAgICAgICB9CiAgICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdiZWZvcmU6YWRkOnJlZ2lvbicsIG5hbWUsIHJlZ2lvbik7CiAgICAgICAgdGhpcy5fc3RvcmUobmFtZSwgcmVnaW9uKTsKICAgICAgICB0aGlzLnRyaWdnZXJNZXRob2QoJ2FkZDpyZWdpb24nLCBuYW1lLCByZWdpb24pOwogICAgICAgIHJldHVybiByZWdpb247CiAgICAgIH0sCiAgICAgIC8vIEdldCBhIHJlZ2lvbiBieSBuYW1lCiAgICAgIGdldDogZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICByZXR1cm4gdGhpcy5fcmVnaW9uc1tuYW1lXTsKICAgICAgfSwKICAgICAgLy8gR2V0cyBhbGwgdGhlIHJlZ2lvbnMgY29udGFpbmVkIHdpdGhpbgogICAgICAvLyB0aGUgYHJlZ2lvbk1hbmFnZXJgIGluc3RhbmNlLgogICAgICBnZXRSZWdpb25zOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIF8uY2xvbmUodGhpcy5fcmVnaW9ucyk7CiAgICAgIH0sCiAgICAgIC8vIFJlbW92ZSBhIHJlZ2lvbiBieSBuYW1lCiAgICAgIHJlbW92ZVJlZ2lvbjogZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICB2YXIgcmVnaW9uID0gdGhpcy5fcmVnaW9uc1tuYW1lXTsKICAgICAgICB0aGlzLl9yZW1vdmUobmFtZSwgcmVnaW9uKTsKICAgICAgICByZXR1cm4gcmVnaW9uOwogICAgICB9LAogICAgICAvLyBFbXB0eSBhbGwgcmVnaW9ucyBpbiB0aGUgcmVnaW9uIG1hbmFnZXIsIGFuZAogICAgICAvLyByZW1vdmUgdGhlbQogICAgICByZW1vdmVSZWdpb25zOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIHJlZ2lvbnMgPSB0aGlzLmdldFJlZ2lvbnMoKTsKICAgICAgICBfLmVhY2godGhpcy5fcmVnaW9ucywgZnVuY3Rpb24gKHJlZ2lvbiwgbmFtZSkgewogICAgICAgICAgdGhpcy5fcmVtb3ZlKG5hbWUsIHJlZ2lvbik7CiAgICAgICAgfSwgdGhpcyk7CiAgICAgICAgcmV0dXJuIHJlZ2lvbnM7CiAgICAgIH0sCiAgICAgIC8vIEVtcHR5IGFsbCByZWdpb25zIGluIHRoZSByZWdpb24gbWFuYWdlciwgYnV0CiAgICAgIC8vIGxlYXZlIHRoZW0gYXR0YWNoZWQKICAgICAgZW1wdHlSZWdpb25zOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIHJlZ2lvbnMgPSB0aGlzLmdldFJlZ2lvbnMoKTsKICAgICAgICBfLmVhY2gocmVnaW9ucywgZnVuY3Rpb24gKHJlZ2lvbikgewogICAgICAgICAgcmVnaW9uLmVtcHR5KCk7CiAgICAgICAgfSwgdGhpcyk7CiAgICAgICAgcmV0dXJuIHJlZ2lvbnM7CiAgICAgIH0sCiAgICAgIC8vIERlc3Ryb3kgYWxsIHJlZ2lvbnMgYW5kIHNodXQgZG93biB0aGUgcmVnaW9uCiAgICAgIC8vIG1hbmFnZXIgZW50aXJlbHkKICAgICAgZGVzdHJveTogZnVuY3Rpb24gKCkgewogICAgICAgIHRoaXMucmVtb3ZlUmVnaW9ucygpOwogICAgICAgIHJldHVybiBNYXJpb25ldHRlLkNvbnRyb2xsZXIucHJvdG90eXBlLmRlc3Ryb3kuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfSwKICAgICAgLy8gaW50ZXJuYWwgbWV0aG9kIHRvIHN0b3JlIHJlZ2lvbnMKICAgICAgX3N0b3JlOiBmdW5jdGlvbiAobmFtZSwgcmVnaW9uKSB7CiAgICAgICAgdGhpcy5fcmVnaW9uc1tuYW1lXSA9IHJlZ2lvbjsKICAgICAgICB0aGlzLl9zZXRMZW5ndGgoKTsKICAgICAgfSwKICAgICAgLy8gaW50ZXJuYWwgbWV0aG9kIHRvIHJlbW92ZSBhIHJlZ2lvbgogICAgICBfcmVtb3ZlOiBmdW5jdGlvbiAobmFtZSwgcmVnaW9uKSB7CiAgICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdiZWZvcmU6cmVtb3ZlOnJlZ2lvbicsIG5hbWUsIHJlZ2lvbik7CiAgICAgICAgcmVnaW9uLmVtcHR5KCk7CiAgICAgICAgcmVnaW9uLnN0b3BMaXN0ZW5pbmcoKTsKICAgICAgICBkZWxldGUgdGhpcy5fcmVnaW9uc1tuYW1lXTsKICAgICAgICB0aGlzLl9zZXRMZW5ndGgoKTsKICAgICAgICB0aGlzLnRyaWdnZXJNZXRob2QoJ3JlbW92ZTpyZWdpb24nLCBuYW1lLCByZWdpb24pOwogICAgICB9LAogICAgICAvLyBzZXQgdGhlIG51bWJlciBvZiByZWdpb25zIGN1cnJlbnQgaGVsZAogICAgICBfc2V0TGVuZ3RoOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgdGhpcy5sZW5ndGggPSBfLnNpemUodGhpcy5fcmVnaW9ucyk7CiAgICAgIH0KICAgIH0pOwogICAgTWFyaW9uZXR0ZS5hY3RBc0NvbGxlY3Rpb24oUmVnaW9uTWFuYWdlci5wcm90b3R5cGUsICdfcmVnaW9ucycpOwogICAgcmV0dXJuIFJlZ2lvbk1hbmFnZXI7CiAgfShNYXJpb25ldHRlKTsKICAvLyBUZW1wbGF0ZSBDYWNoZQogIC8vIC0tLS0tLS0tLS0tLS0tCiAgLy8gTWFuYWdlIHRlbXBsYXRlcyBzdG9yZWQgaW4gYDxzY3JpcHQ+YCBibG9ja3MsCiAgLy8gY2FjaGluZyB0aGVtIGZvciBmYXN0ZXIgYWNjZXNzLgogIE1hcmlvbmV0dGUuVGVtcGxhdGVDYWNoZSA9IGZ1bmN0aW9uICh0ZW1wbGF0ZUlkKSB7CiAgICB0aGlzLnRlbXBsYXRlSWQgPSB0ZW1wbGF0ZUlkOwogIH07CiAgLy8gVGVtcGxhdGVDYWNoZSBvYmplY3QtbGV2ZWwgbWV0aG9kcy4gTWFuYWdlIHRoZSB0ZW1wbGF0ZQogIC8vIGNhY2hlcyBmcm9tIHRoZXNlIG1ldGhvZCBjYWxscyBpbnN0ZWFkIG9mIGNyZWF0aW5nCiAgLy8geW91ciBvd24gVGVtcGxhdGVDYWNoZSBpbnN0YW5jZXMKICBfLmV4dGVuZChNYXJpb25ldHRlLlRlbXBsYXRlQ2FjaGUsIHsKICAgIHRlbXBsYXRlQ2FjaGVzOiB7fSwKICAgIC8vIEdldCB0aGUgc3BlY2lmaWVkIHRlbXBsYXRlIGJ5IGlkLiBFaXRoZXIKICAgIC8vIHJldHJpZXZlcyB0aGUgY2FjaGVkIHZlcnNpb24sIG9yIGxvYWRzIGl0CiAgICAvLyBmcm9tIHRoZSBET00uCiAgICBnZXQ6IGZ1bmN0aW9uICh0ZW1wbGF0ZUlkKSB7CiAgICAgIHZhciBjYWNoZWRUZW1wbGF0ZSA9IHRoaXMudGVtcGxhdGVDYWNoZXNbdGVtcGxhdGVJZF07CiAgICAgIGlmICghY2FjaGVkVGVtcGxhdGUpIHsKICAgICAgICBjYWNoZWRUZW1wbGF0ZSA9IG5ldyBNYXJpb25ldHRlLlRlbXBsYXRlQ2FjaGUodGVtcGxhdGVJZCk7CiAgICAgICAgdGhpcy50ZW1wbGF0ZUNhY2hlc1t0ZW1wbGF0ZUlkXSA9IGNhY2hlZFRlbXBsYXRlOwogICAgICB9CiAgICAgIHJldHVybiBjYWNoZWRUZW1wbGF0ZS5sb2FkKCk7CiAgICB9LAogICAgLy8gQ2xlYXIgdGVtcGxhdGVzIGZyb20gdGhlIGNhY2hlLiBJZiBubyBhcmd1bWVudHMKICAgIC8vIGFyZSBzcGVjaWZpZWQsIGNsZWFycyBhbGwgdGVtcGxhdGVzOgogICAgLy8gYGNsZWFyKClgCiAgICAvLwogICAgLy8gSWYgYXJndW1lbnRzIGFyZSBzcGVjaWZpZWQsIGNsZWFycyBlYWNoIG9mIHRoZQogICAgLy8gc3BlY2lmaWVkIHRlbXBsYXRlcyBmcm9tIHRoZSBjYWNoZToKICAgIC8vIGBjbGVhcigiI3QxIiwgIiN0MiIsICIuLi4iKWAKICAgIGNsZWFyOiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBpOwogICAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzKTsKICAgICAgdmFyIGxlbmd0aCA9IGFyZ3MubGVuZ3RoOwogICAgICBpZiAobGVuZ3RoID4gMCkgewogICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgZGVsZXRlIHRoaXMudGVtcGxhdGVDYWNoZXNbYXJnc1tpXV07CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMudGVtcGxhdGVDYWNoZXMgPSB7fTsKICAgICAgfQogICAgfQogIH0pOwogIC8vIFRlbXBsYXRlQ2FjaGUgaW5zdGFuY2UgbWV0aG9kcywgYWxsb3dpbmcgZWFjaAogIC8vIHRlbXBsYXRlIGNhY2hlIG9iamVjdCB0byBtYW5hZ2UgaXRzIG93biBzdGF0ZQogIC8vIGFuZCBrbm93IHdoZXRoZXIgb3Igbm90IGl0IGhhcyBiZWVuIGxvYWRlZAogIF8uZXh0ZW5kKE1hcmlvbmV0dGUuVGVtcGxhdGVDYWNoZS5wcm90b3R5cGUsIHsKICAgIC8vIEludGVybmFsIG1ldGhvZCB0byBsb2FkIHRoZSB0ZW1wbGF0ZQogICAgbG9hZDogZnVuY3Rpb24gKCkgewogICAgICAvLyBHdWFyZCBjbGF1c2UgdG8gcHJldmVudCBsb2FkaW5nIHRoaXMgdGVtcGxhdGUgbW9yZSB0aGFuIG9uY2UKICAgICAgaWYgKHRoaXMuY29tcGlsZWRUZW1wbGF0ZSkgewogICAgICAgIHJldHVybiB0aGlzLmNvbXBpbGVkVGVtcGxhdGU7CiAgICAgIH0KICAgICAgLy8gTG9hZCB0aGUgdGVtcGxhdGUgYW5kIGNvbXBpbGUgaXQKICAgICAgdmFyIHRlbXBsYXRlID0gdGhpcy5sb2FkVGVtcGxhdGUodGhpcy50ZW1wbGF0ZUlkKTsKICAgICAgdGhpcy5jb21waWxlZFRlbXBsYXRlID0gdGhpcy5jb21waWxlVGVtcGxhdGUodGVtcGxhdGUpOwogICAgICByZXR1cm4gdGhpcy5jb21waWxlZFRlbXBsYXRlOwogICAgfSwKICAgIC8vIExvYWQgYSB0ZW1wbGF0ZSBmcm9tIHRoZSBET00sIGJ5IGRlZmF1bHQuIE92ZXJyaWRlCiAgICAvLyB0aGlzIG1ldGhvZCB0byBwcm92aWRlIHlvdXIgb3duIHRlbXBsYXRlIHJldHJpZXZhbAogICAgLy8gRm9yIGFzeW5jaHJvbm91cyBsb2FkaW5nIHdpdGggQU1EL1JlcXVpcmVKUywgY29uc2lkZXIKICAgIC8vIHVzaW5nIGEgdGVtcGxhdGUtbG9hZGVyIHBsdWdpbiBhcyBkZXNjcmliZWQgaGVyZToKICAgIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS9tYXJpb25ldHRlanMvYmFja2JvbmUubWFyaW9uZXR0ZS93aWtpL1VzaW5nLW1hcmlvbmV0dGUtd2l0aC1yZXF1aXJlanMKICAgIGxvYWRUZW1wbGF0ZTogZnVuY3Rpb24gKHRlbXBsYXRlSWQpIHsKICAgICAgdmFyIHRlbXBsYXRlID0gQmFja2JvbmUuJCh0ZW1wbGF0ZUlkKS5odG1sKCk7CiAgICAgIGlmICghdGVtcGxhdGUgfHwgdGVtcGxhdGUubGVuZ3RoID09PSAwKSB7CiAgICAgICAgdGhyb3cgbmV3IE1hcmlvbmV0dGUuRXJyb3IoewogICAgICAgICAgbmFtZTogJ05vVGVtcGxhdGVFcnJvcicsCiAgICAgICAgICBtZXNzYWdlOiAnQ291bGQgbm90IGZpbmQgdGVtcGxhdGU6ICInICsgdGVtcGxhdGVJZCArICciJwogICAgICAgIH0pOwogICAgICB9CiAgICAgIHJldHVybiB0ZW1wbGF0ZTsKICAgIH0sCiAgICAvLyBQcmUtY29tcGlsZSB0aGUgdGVtcGxhdGUgYmVmb3JlIGNhY2hpbmcgaXQuIE92ZXJyaWRlCiAgICAvLyB0aGlzIG1ldGhvZCBpZiB5b3UgZG8gbm90IG5lZWQgdG8gcHJlLWNvbXBpbGUgYSB0ZW1wbGF0ZQogICAgLy8gKEpTVCAvIFJlcXVpcmVKUyBmb3IgZXhhbXBsZSkgb3IgaWYgeW91IHdhbnQgdG8gY2hhbmdlCiAgICAvLyB0aGUgdGVtcGxhdGUgZW5naW5lIHVzZWQgKEhhbmRlYmFycywgZXRjKS4KICAgIGNvbXBpbGVUZW1wbGF0ZTogZnVuY3Rpb24gKHJhd1RlbXBsYXRlKSB7CiAgICAgIHJldHVybiBfLnRlbXBsYXRlKHJhd1RlbXBsYXRlKTsKICAgIH0KICB9KTsKICAvLyBSZW5kZXJlcgogIC8vIC0tLS0tLS0tCiAgLy8gUmVuZGVyIGEgdGVtcGxhdGUgd2l0aCBkYXRhIGJ5IHBhc3NpbmcgaW4gdGhlIHRlbXBsYXRlCiAgLy8gc2VsZWN0b3IgYW5kIHRoZSBkYXRhIHRvIHJlbmRlci4KICBNYXJpb25ldHRlLlJlbmRlcmVyID0gewogICAgLy8gUmVuZGVyIGEgdGVtcGxhdGUgd2l0aCBkYXRhLiBUaGUgYHRlbXBsYXRlYCBwYXJhbWV0ZXIgaXMKICAgIC8vIHBhc3NlZCB0byB0aGUgYFRlbXBsYXRlQ2FjaGVgIG9iamVjdCB0byByZXRyaWV2ZSB0aGUKICAgIC8vIHRlbXBsYXRlIGZ1bmN0aW9uLiBPdmVycmlkZSB0aGlzIG1ldGhvZCB0byBwcm92aWRlIHlvdXIgb3duCiAgICAvLyBjdXN0b20gcmVuZGVyaW5nIGFuZCB0ZW1wbGF0ZSBoYW5kbGluZyBmb3IgYWxsIG9mIE1hcmlvbmV0dGUuCiAgICByZW5kZXI6IGZ1bmN0aW9uICh0ZW1wbGF0ZSwgZGF0YSkgewogICAgICBpZiAoIXRlbXBsYXRlKSB7CiAgICAgICAgdGhyb3cgbmV3IE1hcmlvbmV0dGUuRXJyb3IoewogICAgICAgICAgbmFtZTogJ1RlbXBsYXRlTm90Rm91bmRFcnJvcicsCiAgICAgICAgICBtZXNzYWdlOiAnQ2Fubm90IHJlbmRlciB0aGUgdGVtcGxhdGUgc2luY2UgaXRzIGZhbHNlLCBudWxsIG9yIHVuZGVmaW5lZC4nCiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgdmFyIHRlbXBsYXRlRnVuYzsKICAgICAgaWYgKHR5cGVvZiB0ZW1wbGF0ZSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgIHRlbXBsYXRlRnVuYyA9IHRlbXBsYXRlOwogICAgICB9IGVsc2UgewogICAgICAgIHRlbXBsYXRlRnVuYyA9IE1hcmlvbmV0dGUuVGVtcGxhdGVDYWNoZS5nZXQodGVtcGxhdGUpOwogICAgICB9CiAgICAgIHJldHVybiB0ZW1wbGF0ZUZ1bmMoZGF0YSk7CiAgICB9CiAgfTsKICAvKiBqc2hpbnQgbWF4bGVuOiAxMTQsIG5vbmV3OiBmYWxzZSAqLwogIC8vIE1hcmlvbmV0dGUuVmlldwogIC8vIC0tLS0tLS0tLS0tLS0tLQogIC8vIFRoZSBjb3JlIHZpZXcgY2xhc3MgdGhhdCBvdGhlciBNYXJpb25ldHRlIHZpZXdzIGV4dGVuZCBmcm9tLgogIE1hcmlvbmV0dGUuVmlldyA9IEJhY2tib25lLlZpZXcuZXh0ZW5kKHsKICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbiAob3B0aW9ucykgewogICAgICBfLmJpbmRBbGwodGhpcywgJ3JlbmRlcicpOwogICAgICAvLyB0aGlzIGV4cG9zZXMgdmlldyBvcHRpb25zIHRvIHRoZSB2aWV3IGluaXRpYWxpemVyCiAgICAgIC8vIHRoaXMgaXMgYSBiYWNrZmlsbCBzaW5jZSBiYWNrYm9uZSByZW1vdmVkIHRoZSBhc3NpZ25tZW50CiAgICAgIC8vIG9mIHRoaXMub3B0aW9ucwogICAgICAvLyBhdCBzb21lIHBvaW50IGhvd2V2ZXIgdGhpcyBtYXkgYmUgcmVtb3ZlZAogICAgICB0aGlzLm9wdGlvbnMgPSBfLmV4dGVuZCh7fSwgXy5yZXN1bHQodGhpcywgJ29wdGlvbnMnKSwgXy5pc0Z1bmN0aW9uKG9wdGlvbnMpID8gb3B0aW9ucy5jYWxsKHRoaXMpIDogb3B0aW9ucyk7CiAgICAgIHRoaXMuX2JlaGF2aW9ycyA9IE1hcmlvbmV0dGUuQmVoYXZpb3JzKHRoaXMpOwogICAgICBCYWNrYm9uZS5WaWV3LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIE1hcmlvbmV0dGUuTW9uaXRvckRPTVJlZnJlc2godGhpcyk7CiAgICAgIHRoaXMubGlzdGVuVG8odGhpcywgJ3Nob3cnLCB0aGlzLm9uU2hvd0NhbGxlZCk7CiAgICB9LAogICAgLy8gR2V0IHRoZSB0ZW1wbGF0ZSBmb3IgdGhpcyB2aWV3CiAgICAvLyBpbnN0YW5jZS4gWW91IGNhbiBzZXQgYSBgdGVtcGxhdGVgIGF0dHJpYnV0ZSBpbiB0aGUgdmlldwogICAgLy8gZGVmaW5pdGlvbiBvciBwYXNzIGEgYHRlbXBsYXRlOiAid2hhdGV2ZXIiYCBwYXJhbWV0ZXIgaW4KICAgIC8vIHRvIHRoZSBjb25zdHJ1Y3RvciBvcHRpb25zLgogICAgZ2V0VGVtcGxhdGU6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIHRoaXMuZ2V0T3B0aW9uKCd0ZW1wbGF0ZScpOwogICAgfSwKICAgIC8vIFNlcmlhbGl6ZSBhIG1vZGVsIGJ5IHJldHVybmluZyBpdHMgYXR0cmlidXRlcy4gQ2xvbmVzCiAgICAvLyB0aGUgYXR0cmlidXRlcyB0byBhbGxvdyBtb2RpZmljYXRpb24uCiAgICBzZXJpYWxpemVNb2RlbDogZnVuY3Rpb24gKG1vZGVsKSB7CiAgICAgIHJldHVybiBtb2RlbC50b0pTT04uYXBwbHkobW9kZWwsIHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSk7CiAgICB9LAogICAgLy8gTWl4IGluIHRlbXBsYXRlIGhlbHBlciBtZXRob2RzLiBMb29rcyBmb3IgYQogICAgLy8gYHRlbXBsYXRlSGVscGVyc2AgYXR0cmlidXRlLCB3aGljaCBjYW4gZWl0aGVyIGJlIGFuCiAgICAvLyBvYmplY3QgbGl0ZXJhbCwgb3IgYSBmdW5jdGlvbiB0aGF0IHJldHVybnMgYW4gb2JqZWN0CiAgICAvLyBsaXRlcmFsLiBBbGwgbWV0aG9kcyBhbmQgYXR0cmlidXRlcyBmcm9tIHRoaXMgb2JqZWN0CiAgICAvLyBhcmUgY29waWVzIHRvIHRoZSBvYmplY3QgcGFzc2VkIGluLgogICAgbWl4aW5UZW1wbGF0ZUhlbHBlcnM6IGZ1bmN0aW9uICh0YXJnZXQpIHsKICAgICAgdGFyZ2V0ID0gdGFyZ2V0IHx8IHt9OwogICAgICB2YXIgdGVtcGxhdGVIZWxwZXJzID0gdGhpcy5nZXRPcHRpb24oJ3RlbXBsYXRlSGVscGVycycpOwogICAgICBpZiAoXy5pc0Z1bmN0aW9uKHRlbXBsYXRlSGVscGVycykpIHsKICAgICAgICB0ZW1wbGF0ZUhlbHBlcnMgPSB0ZW1wbGF0ZUhlbHBlcnMuY2FsbCh0aGlzKTsKICAgICAgfQogICAgICByZXR1cm4gXy5leHRlbmQodGFyZ2V0LCB0ZW1wbGF0ZUhlbHBlcnMpOwogICAgfSwKICAgIC8vIG5vcm1hbGl6ZSB0aGUga2V5cyBvZiBwYXNzZWQgaGFzaCB3aXRoIHRoZSB2aWV3cyBgdWlgIHNlbGVjdG9ycy4KICAgIC8vIGB7IkB1aS5mb28iOiAiYmFyIn1gCiAgICBub3JtYWxpemVVSUtleXM6IGZ1bmN0aW9uIChoYXNoKSB7CiAgICAgIHZhciB1aSA9IF8ucmVzdWx0KHRoaXMsICd1aScpOwogICAgICB2YXIgdWlCaW5kaW5ncyA9IF8ucmVzdWx0KHRoaXMsICdfdWlCaW5kaW5ncycpOwogICAgICByZXR1cm4gTWFyaW9uZXR0ZS5ub3JtYWxpemVVSUtleXMoaGFzaCwgdWlCaW5kaW5ncyB8fCB1aSk7CiAgICB9LAogICAgLy8gbm9ybWFsaXplIHRoZSB2YWx1ZXMgb2YgcGFzc2VkIGhhc2ggd2l0aCB0aGUgdmlld3MgYHVpYCBzZWxlY3RvcnMuCiAgICAvLyBge2ZvbzogIkB1aS5iYXIifWAKICAgIG5vcm1hbGl6ZVVJVmFsdWVzOiBmdW5jdGlvbiAoaGFzaCkgewogICAgICB2YXIgdWkgPSBfLnJlc3VsdCh0aGlzLCAndWknKTsKICAgICAgdmFyIHVpQmluZGluZ3MgPSBfLnJlc3VsdCh0aGlzLCAnX3VpQmluZGluZ3MnKTsKICAgICAgcmV0dXJuIE1hcmlvbmV0dGUubm9ybWFsaXplVUlWYWx1ZXMoaGFzaCwgdWlCaW5kaW5ncyB8fCB1aSk7CiAgICB9LAogICAgLy8gQ29uZmlndXJlIGB0cmlnZ2Vyc2AgdG8gZm9yd2FyZCBET00gZXZlbnRzIHRvIHZpZXcKICAgIC8vIGV2ZW50cy4gYHRyaWdnZXJzOiB7ImNsaWNrIC5mb28iOiAiZG86Zm9vIn1gCiAgICBjb25maWd1cmVUcmlnZ2VyczogZnVuY3Rpb24gKCkgewogICAgICBpZiAoIXRoaXMudHJpZ2dlcnMpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgdmFyIHRyaWdnZXJFdmVudHMgPSB7fTsKICAgICAgLy8gQWxsb3cgYHRyaWdnZXJzYCB0byBiZSBjb25maWd1cmVkIGFzIGEgZnVuY3Rpb24KICAgICAgdmFyIHRyaWdnZXJzID0gdGhpcy5ub3JtYWxpemVVSUtleXMoXy5yZXN1bHQodGhpcywgJ3RyaWdnZXJzJykpOwogICAgICAvLyBDb25maWd1cmUgdGhlIHRyaWdnZXJzLCBwcmV2ZW50IGRlZmF1bHQKICAgICAgLy8gYWN0aW9uIGFuZCBzdG9wIHByb3BhZ2F0aW9uIG9mIERPTSBldmVudHMKICAgICAgXy5lYWNoKHRyaWdnZXJzLCBmdW5jdGlvbiAodmFsdWUsIGtleSkgewogICAgICAgIHRyaWdnZXJFdmVudHNba2V5XSA9IHRoaXMuX2J1aWxkVmlld1RyaWdnZXIodmFsdWUpOwogICAgICB9LCB0aGlzKTsKICAgICAgcmV0dXJuIHRyaWdnZXJFdmVudHM7CiAgICB9LAogICAgLy8gT3ZlcnJpZGluZyBCYWNrYm9uZS5WaWV3J3MgZGVsZWdhdGVFdmVudHMgdG8gaGFuZGxlCiAgICAvLyB0aGUgYHRyaWdnZXJzYCwgYG1vZGVsRXZlbnRzYCwgYW5kIGBjb2xsZWN0aW9uRXZlbnRzYCBjb25maWd1cmF0aW9uCiAgICBkZWxlZ2F0ZUV2ZW50czogZnVuY3Rpb24gKGV2ZW50cykgewogICAgICB0aGlzLl9kZWxlZ2F0ZURPTUV2ZW50cyhldmVudHMpOwogICAgICB0aGlzLmJpbmRFbnRpdHlFdmVudHModGhpcy5tb2RlbCwgdGhpcy5nZXRPcHRpb24oJ21vZGVsRXZlbnRzJykpOwogICAgICB0aGlzLmJpbmRFbnRpdHlFdmVudHModGhpcy5jb2xsZWN0aW9uLCB0aGlzLmdldE9wdGlvbignY29sbGVjdGlvbkV2ZW50cycpKTsKICAgICAgXy5lYWNoKHRoaXMuX2JlaGF2aW9ycywgZnVuY3Rpb24gKGJlaGF2aW9yKSB7CiAgICAgICAgYmVoYXZpb3IuYmluZEVudGl0eUV2ZW50cyh0aGlzLm1vZGVsLCBiZWhhdmlvci5nZXRPcHRpb24oJ21vZGVsRXZlbnRzJykpOwogICAgICAgIGJlaGF2aW9yLmJpbmRFbnRpdHlFdmVudHModGhpcy5jb2xsZWN0aW9uLCBiZWhhdmlvci5nZXRPcHRpb24oJ2NvbGxlY3Rpb25FdmVudHMnKSk7CiAgICAgIH0sIHRoaXMpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgICAvLyBpbnRlcm5hbCBtZXRob2QgdG8gZGVsZWdhdGUgRE9NIGV2ZW50cyBhbmQgdHJpZ2dlcnMKICAgIF9kZWxlZ2F0ZURPTUV2ZW50czogZnVuY3Rpb24gKGV2ZW50c0FyZykgewogICAgICB2YXIgZXZlbnRzID0gZXZlbnRzQXJnIHx8IHRoaXMuZXZlbnRzOwogICAgICBpZiAoXy5pc0Z1bmN0aW9uKGV2ZW50cykpIHsKICAgICAgICBldmVudHMgPSBldmVudHMuY2FsbCh0aGlzKTsKICAgICAgfQogICAgICAvLyBub3JtYWxpemUgdWkga2V5cwogICAgICBldmVudHMgPSB0aGlzLm5vcm1hbGl6ZVVJS2V5cyhldmVudHMpOwogICAgICBpZiAoXy5pc1VuZGVmaW5lZChldmVudHNBcmcpKSB7CiAgICAgICAgdGhpcy5ldmVudHMgPSBldmVudHM7CiAgICAgIH0KICAgICAgdmFyIGNvbWJpbmVkRXZlbnRzID0ge307CiAgICAgIC8vIGxvb2sgdXAgaWYgdGhpcyB2aWV3IGhhcyBiZWhhdmlvciBldmVudHMKICAgICAgdmFyIGJlaGF2aW9yRXZlbnRzID0gXy5yZXN1bHQodGhpcywgJ2JlaGF2aW9yRXZlbnRzJykgfHwge307CiAgICAgIHZhciB0cmlnZ2VycyA9IHRoaXMuY29uZmlndXJlVHJpZ2dlcnMoKTsKICAgICAgdmFyIGJlaGF2aW9yVHJpZ2dlcnMgPSBfLnJlc3VsdCh0aGlzLCAnYmVoYXZpb3JUcmlnZ2VycycpIHx8IHt9OwogICAgICAvLyBiZWhhdmlvciBldmVudHMgd2lsbCBiZSBvdmVycmlkZW4gYnkgdmlldyBldmVudHMgYW5kIG9yIHRyaWdnZXJzCiAgICAgIF8uZXh0ZW5kKGNvbWJpbmVkRXZlbnRzLCBiZWhhdmlvckV2ZW50cywgZXZlbnRzLCB0cmlnZ2VycywgYmVoYXZpb3JUcmlnZ2Vycyk7CiAgICAgIEJhY2tib25lLlZpZXcucHJvdG90eXBlLmRlbGVnYXRlRXZlbnRzLmNhbGwodGhpcywgY29tYmluZWRFdmVudHMpOwogICAgfSwKICAgIC8vIE92ZXJyaWRpbmcgQmFja2JvbmUuVmlldydzIHVuZGVsZWdhdGVFdmVudHMgdG8gaGFuZGxlIHVuYmluZGluZwogICAgLy8gdGhlIGB0cmlnZ2Vyc2AsIGBtb2RlbEV2ZW50c2AsIGFuZCBgY29sbGVjdGlvbkV2ZW50c2AgY29uZmlnCiAgICB1bmRlbGVnYXRlRXZlbnRzOiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMpOwogICAgICBCYWNrYm9uZS5WaWV3LnByb3RvdHlwZS51bmRlbGVnYXRlRXZlbnRzLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgICB0aGlzLnVuYmluZEVudGl0eUV2ZW50cyh0aGlzLm1vZGVsLCB0aGlzLmdldE9wdGlvbignbW9kZWxFdmVudHMnKSk7CiAgICAgIHRoaXMudW5iaW5kRW50aXR5RXZlbnRzKHRoaXMuY29sbGVjdGlvbiwgdGhpcy5nZXRPcHRpb24oJ2NvbGxlY3Rpb25FdmVudHMnKSk7CiAgICAgIF8uZWFjaCh0aGlzLl9iZWhhdmlvcnMsIGZ1bmN0aW9uIChiZWhhdmlvcikgewogICAgICAgIGJlaGF2aW9yLnVuYmluZEVudGl0eUV2ZW50cyh0aGlzLm1vZGVsLCBiZWhhdmlvci5nZXRPcHRpb24oJ21vZGVsRXZlbnRzJykpOwogICAgICAgIGJlaGF2aW9yLnVuYmluZEVudGl0eUV2ZW50cyh0aGlzLmNvbGxlY3Rpb24sIGJlaGF2aW9yLmdldE9wdGlvbignY29sbGVjdGlvbkV2ZW50cycpKTsKICAgICAgfSwgdGhpcyk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAgIC8vIEludGVybmFsIG1ldGhvZCwgaGFuZGxlcyB0aGUgYHNob3dgIGV2ZW50LgogICAgb25TaG93Q2FsbGVkOiBmdW5jdGlvbiAoKSB7CiAgICB9LAogICAgLy8gSW50ZXJuYWwgaGVscGVyIG1ldGhvZCB0byB2ZXJpZnkgd2hldGhlciB0aGUgdmlldyBoYXNuJ3QgYmVlbiBkZXN0cm95ZWQKICAgIF9lbnN1cmVWaWV3SXNJbnRhY3Q6IGZ1bmN0aW9uICgpIHsKICAgICAgaWYgKHRoaXMuaXNEZXN0cm95ZWQpIHsKICAgICAgICB0aHJvdyBuZXcgTWFyaW9uZXR0ZS5FcnJvcih7CiAgICAgICAgICBuYW1lOiAnVmlld0Rlc3Ryb3llZEVycm9yJywKICAgICAgICAgIG1lc3NhZ2U6ICdWaWV3IChjaWQ6ICInICsgdGhpcy5jaWQgKyAnIikgaGFzIGFscmVhZHkgYmVlbiBkZXN0cm95ZWQgYW5kIGNhbm5vdCBiZSB1c2VkLicKICAgICAgICB9KTsKICAgICAgfQogICAgfSwKICAgIC8vIERlZmF1bHQgYGRlc3Ryb3lgIGltcGxlbWVudGF0aW9uLCBmb3IgcmVtb3ZpbmcgYSB2aWV3IGZyb20gdGhlCiAgICAvLyBET00gYW5kIHVuYmluZGluZyBpdC4gUmVnaW9ucyB3aWxsIGNhbGwgdGhpcyBtZXRob2QKICAgIC8vIGZvciB5b3UuIFlvdSBjYW4gc3BlY2lmeSBhbiBgb25EZXN0cm95YCBtZXRob2QgaW4geW91ciB2aWV3IHRvCiAgICAvLyBhZGQgY3VzdG9tIGNvZGUgdGhhdCBpcyBjYWxsZWQgYWZ0ZXIgdGhlIHZpZXcgaXMgZGVzdHJveWVkLgogICAgZGVzdHJveTogZnVuY3Rpb24gKCkgewogICAgICBpZiAodGhpcy5pc0Rlc3Ryb3llZCkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzKTsKICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kLmFwcGx5KHRoaXMsIFsnYmVmb3JlOmRlc3Ryb3knXS5jb25jYXQoYXJncykpOwogICAgICAvLyBtYXJrIGFzIGRlc3Ryb3llZCBiZWZvcmUgZG9pbmcgdGhlIGFjdHVhbCBkZXN0cm95LCB0bwogICAgICAvLyBwcmV2ZW50IGluZmluaXRlIGxvb3BzIHdpdGhpbiAiZGVzdHJveSIgZXZlbnQgaGFuZGxlcnMKICAgICAgLy8gdGhhdCBhcmUgdHJ5aW5nIHRvIGRlc3Ryb3kgb3RoZXIgdmlld3MKICAgICAgdGhpcy5pc0Rlc3Ryb3llZCA9IHRydWU7CiAgICAgIHRoaXMudHJpZ2dlck1ldGhvZC5hcHBseSh0aGlzLCBbJ2Rlc3Ryb3knXS5jb25jYXQoYXJncykpOwogICAgICAvLyB1bmJpbmQgVUkgZWxlbWVudHMKICAgICAgdGhpcy51bmJpbmRVSUVsZW1lbnRzKCk7CiAgICAgIC8vIHJlbW92ZSB0aGUgdmlldyBmcm9tIHRoZSBET00KICAgICAgdGhpcy5yZW1vdmUoKTsKICAgICAgLy8gQ2FsbCBkZXN0cm95IG9uIGVhY2ggYmVoYXZpb3IgYWZ0ZXIKICAgICAgLy8gZGVzdHJveWluZyB0aGUgdmlldy4KICAgICAgLy8gVGhpcyB1bmJpbmRzIGV2ZW50IGxpc3RlbmVycwogICAgICAvLyB0aGF0IGJlaGF2aW9ycyBoYXZlIHJlZ2lzdGVyZCBmb3IuCiAgICAgIF8uaW52b2tlKHRoaXMuX2JlaGF2aW9ycywgJ2Rlc3Ryb3knLCBhcmdzKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogICAgYmluZFVJRWxlbWVudHM6IGZ1bmN0aW9uICgpIHsKICAgICAgdGhpcy5fYmluZFVJRWxlbWVudHMoKTsKICAgICAgXy5pbnZva2UodGhpcy5fYmVoYXZpb3JzLCB0aGlzLl9iaW5kVUlFbGVtZW50cyk7CiAgICB9LAogICAgLy8gVGhpcyBtZXRob2QgYmluZHMgdGhlIGVsZW1lbnRzIHNwZWNpZmllZCBpbiB0aGUgInVpIiBoYXNoIGluc2lkZSB0aGUgdmlldydzIGNvZGUgd2l0aAogICAgLy8gdGhlIGFzc29jaWF0ZWQgalF1ZXJ5IHNlbGVjdG9ycy4KICAgIF9iaW5kVUlFbGVtZW50czogZnVuY3Rpb24gKCkgewogICAgICBpZiAoIXRoaXMudWkpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgLy8gc3RvcmUgdGhlIHVpIGhhc2ggaW4gX3VpQmluZGluZ3Mgc28gdGhleSBjYW4gYmUgcmVzZXQgbGF0ZXIKICAgICAgLy8gYW5kIHNvIHJlLXJlbmRlcmluZyB0aGUgdmlldyB3aWxsIGJlIGFibGUgdG8gZmluZCB0aGUgYmluZGluZ3MKICAgICAgaWYgKCF0aGlzLl91aUJpbmRpbmdzKSB7CiAgICAgICAgdGhpcy5fdWlCaW5kaW5ncyA9IHRoaXMudWk7CiAgICAgIH0KICAgICAgLy8gZ2V0IHRoZSBiaW5kaW5ncyByZXN1bHQsIGFzIGEgZnVuY3Rpb24gb3Igb3RoZXJ3aXNlCiAgICAgIHZhciBiaW5kaW5ncyA9IF8ucmVzdWx0KHRoaXMsICdfdWlCaW5kaW5ncycpOwogICAgICAvLyBlbXB0eSB0aGUgdWkgc28gd2UgZG9uJ3QgaGF2ZSBhbnl0aGluZyB0byBzdGFydCB3aXRoCiAgICAgIHRoaXMudWkgPSB7fTsKICAgICAgLy8gYmluZCBlYWNoIG9mIHRoZSBzZWxlY3RvcnMKICAgICAgXy5lYWNoKF8ua2V5cyhiaW5kaW5ncyksIGZ1bmN0aW9uIChrZXkpIHsKICAgICAgICB2YXIgc2VsZWN0b3IgPSBiaW5kaW5nc1trZXldOwogICAgICAgIHRoaXMudWlba2V5XSA9IHRoaXMuJChzZWxlY3Rvcik7CiAgICAgIH0sIHRoaXMpOwogICAgfSwKICAgIC8vIFRoaXMgbWV0aG9kIHVuYmluZHMgdGhlIGVsZW1lbnRzIHNwZWNpZmllZCBpbiB0aGUgInVpIiBoYXNoCiAgICB1bmJpbmRVSUVsZW1lbnRzOiBmdW5jdGlvbiAoKSB7CiAgICAgIHRoaXMuX3VuYmluZFVJRWxlbWVudHMoKTsKICAgICAgXy5pbnZva2UodGhpcy5fYmVoYXZpb3JzLCB0aGlzLl91bmJpbmRVSUVsZW1lbnRzKTsKICAgIH0sCiAgICBfdW5iaW5kVUlFbGVtZW50czogZnVuY3Rpb24gKCkgewogICAgICBpZiAoIXRoaXMudWkgfHwgIXRoaXMuX3VpQmluZGluZ3MpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgLy8gZGVsZXRlIGFsbCBvZiB0aGUgZXhpc3RpbmcgdWkgYmluZGluZ3MKICAgICAgXy5lYWNoKHRoaXMudWksIGZ1bmN0aW9uICgkZWwsIG5hbWUpIHsKICAgICAgICBkZWxldGUgdGhpcy51aVtuYW1lXTsKICAgICAgfSwgdGhpcyk7CiAgICAgIC8vIHJlc2V0IHRoZSB1aSBlbGVtZW50IHRvIHRoZSBvcmlnaW5hbCBiaW5kaW5ncyBjb25maWd1cmF0aW9uCiAgICAgIHRoaXMudWkgPSB0aGlzLl91aUJpbmRpbmdzOwogICAgICBkZWxldGUgdGhpcy5fdWlCaW5kaW5nczsKICAgIH0sCiAgICAvLyBJbnRlcm5hbCBtZXRob2QgdG8gY3JlYXRlIGFuIGV2ZW50IGhhbmRsZXIgZm9yIGEgZ2l2ZW4gYHRyaWdnZXJEZWZgIGxpa2UKICAgIC8vICdjbGljazpmb28nCiAgICBfYnVpbGRWaWV3VHJpZ2dlcjogZnVuY3Rpb24gKHRyaWdnZXJEZWYpIHsKICAgICAgdmFyIGhhc09wdGlvbnMgPSBfLmlzT2JqZWN0KHRyaWdnZXJEZWYpOwogICAgICB2YXIgb3B0aW9ucyA9IF8uZGVmYXVsdHMoe30sIGhhc09wdGlvbnMgPyB0cmlnZ2VyRGVmIDoge30sIHsKICAgICAgICBwcmV2ZW50RGVmYXVsdDogdHJ1ZSwKICAgICAgICBzdG9wUHJvcGFnYXRpb246IHRydWUKICAgICAgfSk7CiAgICAgIHZhciBldmVudE5hbWUgPSBoYXNPcHRpb25zID8gb3B0aW9ucy5ldmVudCA6IHRyaWdnZXJEZWY7CiAgICAgIHJldHVybiBmdW5jdGlvbiAoZSkgewogICAgICAgIGlmIChlKSB7CiAgICAgICAgICBpZiAoZS5wcmV2ZW50RGVmYXVsdCAmJiBvcHRpb25zLnByZXZlbnREZWZhdWx0KSB7CiAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChlLnN0b3BQcm9wYWdhdGlvbiAmJiBvcHRpb25zLnN0b3BQcm9wYWdhdGlvbikgewogICAgICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgYXJncyA9IHsKICAgICAgICAgIHZpZXc6IHRoaXMsCiAgICAgICAgICBtb2RlbDogdGhpcy5tb2RlbCwKICAgICAgICAgIGNvbGxlY3Rpb246IHRoaXMuY29sbGVjdGlvbgogICAgICAgIH07CiAgICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKGV2ZW50TmFtZSwgYXJncyk7CiAgICAgIH07CiAgICB9LAogICAgc2V0RWxlbWVudDogZnVuY3Rpb24gKCkgewogICAgICB2YXIgcmV0ID0gQmFja2JvbmUuVmlldy5wcm90b3R5cGUuc2V0RWxlbWVudC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAvLyBwcm94eSBiZWhhdmlvciAkZWwgdG8gdGhlIHZpZXcncyAkZWwuCiAgICAgIC8vIFRoaXMgaXMgbmVlZGVkIGJlY2F1c2UgYSB2aWV3J3MgJGVsIHByb3h5CiAgICAgIC8vIGlzIG5vdCBzZXQgdW50aWwgYWZ0ZXIgc2V0RWxlbWVudCBpcyBjYWxsZWQuCiAgICAgIF8uaW52b2tlKHRoaXMuX2JlaGF2aW9ycywgJ3Byb3h5Vmlld1Byb3BlcnRpZXMnLCB0aGlzKTsKICAgICAgcmV0dXJuIHJldDsKICAgIH0sCiAgICAvLyBpbXBvcnQgdGhlIGB0cmlnZ2VyTWV0aG9kYCB0byB0cmlnZ2VyIGV2ZW50cyB3aXRoIGNvcnJlc3BvbmRpbmcKICAgIC8vIG1ldGhvZHMgaWYgdGhlIG1ldGhvZCBleGlzdHMKICAgIHRyaWdnZXJNZXRob2Q6IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIGFyZ3MgPSBhcmd1bWVudHM7CiAgICAgIHZhciB0cmlnZ2VyTWV0aG9kID0gTWFyaW9uZXR0ZS50cmlnZ2VyTWV0aG9kOwogICAgICB2YXIgcmV0ID0gdHJpZ2dlck1ldGhvZC5hcHBseSh0aGlzLCBhcmdzKTsKICAgICAgXy5lYWNoKHRoaXMuX2JlaGF2aW9ycywgZnVuY3Rpb24gKGIpIHsKICAgICAgICB0cmlnZ2VyTWV0aG9kLmFwcGx5KGIsIGFyZ3MpOwogICAgICB9KTsKICAgICAgcmV0dXJuIHJldDsKICAgIH0sCiAgICAvLyBJbXBvcnRzIHRoZSAibm9ybWFsaXplTWV0aG9kcyIgdG8gdHJhbnNmb3JtIGhhc2hlcyBvZgogICAgLy8gZXZlbnRzPT5mdW5jdGlvbiByZWZlcmVuY2VzL25hbWVzIHRvIGEgaGFzaCBvZiBldmVudHM9PmZ1bmN0aW9uIHJlZmVyZW5jZXMKICAgIG5vcm1hbGl6ZU1ldGhvZHM6IE1hcmlvbmV0dGUubm9ybWFsaXplTWV0aG9kcywKICAgIC8vIFByb3h5IGBnZXRPcHRpb25gIHRvIGVuYWJsZSBnZXR0aW5nIG9wdGlvbnMgZnJvbSB0aGlzIG9yIHRoaXMub3B0aW9ucyBieSBuYW1lLgogICAgZ2V0T3B0aW9uOiBNYXJpb25ldHRlLnByb3h5R2V0T3B0aW9uLAogICAgLy8gUHJveHkgYHVuYmluZEVudGl0eUV2ZW50c2AgdG8gZW5hYmxlIGJpbmRpbmcgdmlldydzIGV2ZW50cyBmcm9tIGFub3RoZXIgZW50aXR5LgogICAgYmluZEVudGl0eUV2ZW50czogTWFyaW9uZXR0ZS5wcm94eUJpbmRFbnRpdHlFdmVudHMsCiAgICAvLyBQcm94eSBgdW5iaW5kRW50aXR5RXZlbnRzYCB0byBlbmFibGUgdW5iaW5kaW5nIHZpZXcncyBldmVudHMgZnJvbSBhbm90aGVyIGVudGl0eS4KICAgIHVuYmluZEVudGl0eUV2ZW50czogTWFyaW9uZXR0ZS5wcm94eVVuYmluZEVudGl0eUV2ZW50cwogIH0pOwogIC8vIEl0ZW0gVmlldwogIC8vIC0tLS0tLS0tLQogIC8vIEEgc2luZ2xlIGl0ZW0gdmlldyBpbXBsZW1lbnRhdGlvbiB0aGF0IGNvbnRhaW5zIGNvZGUgZm9yIHJlbmRlcmluZwogIC8vIHdpdGggdW5kZXJzY29yZS5qcyB0ZW1wbGF0ZXMsIHNlcmlhbGl6aW5nIHRoZSB2aWV3J3MgbW9kZWwgb3IgY29sbGVjdGlvbiwKICAvLyBhbmQgY2FsbGluZyBzZXZlcmFsIG1ldGhvZHMgb24gZXh0ZW5kZWQgdmlld3MsIHN1Y2ggYXMgYG9uUmVuZGVyYC4KICBNYXJpb25ldHRlLkl0ZW1WaWV3ID0gTWFyaW9uZXR0ZS5WaWV3LmV4dGVuZCh7CiAgICAvLyBTZXR0aW5nIHVwIHRoZSBpbmhlcml0YW5jZSBjaGFpbiB3aGljaCBhbGxvd3MgY2hhbmdlcyB0bwogICAgLy8gTWFyaW9uZXR0ZS5WaWV3LnByb3RvdHlwZS5jb25zdHJ1Y3RvciB3aGljaCBhbGxvd3Mgb3ZlcnJpZGluZwogICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uICgpIHsKICAgICAgTWFyaW9uZXR0ZS5WaWV3LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9LAogICAgLy8gU2VyaWFsaXplIHRoZSBtb2RlbCBvciBjb2xsZWN0aW9uIGZvciB0aGUgdmlldy4gSWYgYSBtb2RlbCBpcwogICAgLy8gZm91bmQsIHRoZSB2aWV3J3MgYHNlcmlhbGl6ZU1vZGVsYCBpcyBjYWxsZWQuIElmIGEgY29sbGVjdGlvbiBpcyBmb3VuZCwKICAgIC8vIGVhY2ggbW9kZWwgaW4gdGhlIGNvbGxlY3Rpb24gaXMgc2VyaWFsaXplZCBieSBjYWxsaW5nCiAgICAvLyB0aGUgdmlldydzIGBzZXJpYWxpemVDb2xsZWN0aW9uYCBhbmQgcHV0IGludG8gYW4gYGl0ZW1zYCBhcnJheSBpbgogICAgLy8gdGhlIHJlc3VsdGluZyBkYXRhLiBJZiBib3RoIGFyZSBmb3VuZCwgZGVmYXVsdHMgdG8gdGhlIG1vZGVsLgogICAgLy8gWW91IGNhbiBvdmVycmlkZSB0aGUgYHNlcmlhbGl6ZURhdGFgIG1ldGhvZCBpbiB5b3VyIG93biB2aWV3IGRlZmluaXRpb24sCiAgICAvLyB0byBwcm92aWRlIGN1c3RvbSBzZXJpYWxpemF0aW9uIGZvciB5b3VyIHZpZXcncyBkYXRhLgogICAgc2VyaWFsaXplRGF0YTogZnVuY3Rpb24gKCkgewogICAgICB2YXIgZGF0YSA9IHt9OwogICAgICBpZiAodGhpcy5tb2RlbCkgewogICAgICAgIGRhdGEgPSBfLnBhcnRpYWwodGhpcy5zZXJpYWxpemVNb2RlbCwgdGhpcy5tb2RlbCkuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfSBlbHNlIGlmICh0aGlzLmNvbGxlY3Rpb24pIHsKICAgICAgICBkYXRhID0geyBpdGVtczogXy5wYXJ0aWFsKHRoaXMuc2VyaWFsaXplQ29sbGVjdGlvbiwgdGhpcy5jb2xsZWN0aW9uKS5hcHBseSh0aGlzLCBhcmd1bWVudHMpIH07CiAgICAgIH0KICAgICAgcmV0dXJuIGRhdGE7CiAgICB9LAogICAgLy8gU2VyaWFsaXplIGEgY29sbGVjdGlvbiBieSBzZXJpYWxpemluZyBlYWNoIG9mIGl0cyBtb2RlbHMuCiAgICBzZXJpYWxpemVDb2xsZWN0aW9uOiBmdW5jdGlvbiAoY29sbGVjdGlvbikgewogICAgICByZXR1cm4gY29sbGVjdGlvbi50b0pTT04uYXBwbHkoY29sbGVjdGlvbiwgc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpKTsKICAgIH0sCiAgICAvLyBSZW5kZXIgdGhlIHZpZXcsIGRlZmF1bHRpbmcgdG8gdW5kZXJzY29yZS5qcyB0ZW1wbGF0ZXMuCiAgICAvLyBZb3UgY2FuIG92ZXJyaWRlIHRoaXMgaW4geW91ciB2aWV3IGRlZmluaXRpb24gdG8gcHJvdmlkZQogICAgLy8gYSB2ZXJ5IHNwZWNpZmljIHJlbmRlcmluZyBmb3IgeW91ciB2aWV3LiBJbiBnZW5lcmFsLCB0aG91Z2gsCiAgICAvLyB5b3Ugc2hvdWxkIG92ZXJyaWRlIHRoZSBgTWFyaW9uZXR0ZS5SZW5kZXJlcmAgb2JqZWN0IHRvCiAgICAvLyBjaGFuZ2UgaG93IE1hcmlvbmV0dGUgcmVuZGVycyB2aWV3cy4KICAgIHJlbmRlcjogZnVuY3Rpb24gKCkgewogICAgICB0aGlzLl9lbnN1cmVWaWV3SXNJbnRhY3QoKTsKICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdiZWZvcmU6cmVuZGVyJywgdGhpcyk7CiAgICAgIHRoaXMuX3JlbmRlclRlbXBsYXRlKCk7CiAgICAgIHRoaXMuYmluZFVJRWxlbWVudHMoKTsKICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdyZW5kZXInLCB0aGlzKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogICAgLy8gSW50ZXJuYWwgbWV0aG9kIHRvIHJlbmRlciB0aGUgdGVtcGxhdGUgd2l0aCB0aGUgc2VyaWFsaXplZCBkYXRhCiAgICAvLyBhbmQgdGVtcGxhdGUgaGVscGVycyB2aWEgdGhlIGBNYXJpb25ldHRlLlJlbmRlcmVyYCBvYmplY3QuCiAgICAvLyBUaHJvd3MgYW4gYFVuZGVmaW5lZFRlbXBsYXRlRXJyb3JgIGVycm9yIGlmIHRoZSB0ZW1wbGF0ZSBpcwogICAgLy8gYW55IGZhbHNlbHkgdmFsdWUgYnV0IGxpdGVyYWwgYGZhbHNlYC4KICAgIF9yZW5kZXJUZW1wbGF0ZTogZnVuY3Rpb24gKCkgewogICAgICB2YXIgdGVtcGxhdGUgPSB0aGlzLmdldFRlbXBsYXRlKCk7CiAgICAgIC8vIEFsbG93IHRlbXBsYXRlLWxlc3MgaXRlbSB2aWV3cwogICAgICBpZiAodGVtcGxhdGUgPT09IGZhbHNlKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIGlmICghdGVtcGxhdGUpIHsKICAgICAgICB0aHJvdyBuZXcgTWFyaW9uZXR0ZS5FcnJvcih7CiAgICAgICAgICBuYW1lOiAnVW5kZWZpbmVkVGVtcGxhdGVFcnJvcicsCiAgICAgICAgICBtZXNzYWdlOiAnQ2Fubm90IHJlbmRlciB0aGUgdGVtcGxhdGUgc2luY2UgaXQgaXMgbnVsbCBvciB1bmRlZmluZWQuJwogICAgICAgIH0pOwogICAgICB9CiAgICAgIC8vIEFkZCBpbiBlbnRpdHkgZGF0YSBhbmQgdGVtcGxhdGUgaGVscGVycwogICAgICB2YXIgZGF0YSA9IHRoaXMuc2VyaWFsaXplRGF0YSgpOwogICAgICBkYXRhID0gdGhpcy5taXhpblRlbXBsYXRlSGVscGVycyhkYXRhKTsKICAgICAgLy8gUmVuZGVyIGFuZCBhZGQgdG8gZWwKICAgICAgdmFyIGh0bWwgPSBNYXJpb25ldHRlLlJlbmRlcmVyLnJlbmRlcih0ZW1wbGF0ZSwgZGF0YSwgdGhpcyk7CiAgICAgIHRoaXMuYXR0YWNoRWxDb250ZW50KGh0bWwpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgICAvLyBBdHRhY2hlcyB0aGUgY29udGVudCBvZiBhIGdpdmVuIHZpZXcuCiAgICAvLyBUaGlzIG1ldGhvZCBjYW4gYmUgb3ZlcnJpZGRlbiB0byBvcHRpbWl6ZSByZW5kZXJpbmcsCiAgICAvLyBvciB0byByZW5kZXIgaW4gYSBub24gc3RhbmRhcmQgd2F5LgogICAgLy8KICAgIC8vIEZvciBleGFtcGxlLCB1c2luZyBgaW5uZXJIVE1MYCBpbnN0ZWFkIG9mIGAkZWwuaHRtbGAKICAgIC8vCiAgICAvLyBgYGBqcwogICAgLy8gYXR0YWNoRWxDb250ZW50OiBmdW5jdGlvbihodG1sKSB7CiAgICAvLyAgIHRoaXMuZWwuaW5uZXJIVE1MID0gaHRtbDsKICAgIC8vICAgcmV0dXJuIHRoaXM7CiAgICAvLyB9CiAgICAvLyBgYGAKICAgIGF0dGFjaEVsQ29udGVudDogZnVuY3Rpb24gKGh0bWwpIHsKICAgICAgdGhpcy4kZWwuaHRtbChodG1sKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogICAgLy8gT3ZlcnJpZGUgdGhlIGRlZmF1bHQgZGVzdHJveSBldmVudCB0byBhZGQgYSBmZXcKICAgIC8vIG1vcmUgZXZlbnRzIHRoYXQgYXJlIHRyaWdnZXJlZC4KICAgIGRlc3Ryb3k6IGZ1bmN0aW9uICgpIHsKICAgICAgaWYgKHRoaXMuaXNEZXN0cm95ZWQpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgcmV0dXJuIE1hcmlvbmV0dGUuVmlldy5wcm90b3R5cGUuZGVzdHJveS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfQogIH0pOwogIC8qIGpzaGludCBtYXhzdGF0ZW1lbnRzOiAxNCAqLwogIC8qIGpzaGludCBtYXhsZW46IDIwMCAqLwogIC8vIENvbGxlY3Rpb24gVmlldwogIC8vIC0tLS0tLS0tLS0tLS0tLQogIC8vIEEgdmlldyB0aGF0IGl0ZXJhdGVzIG92ZXIgYSBCYWNrYm9uZS5Db2xsZWN0aW9uCiAgLy8gYW5kIHJlbmRlcnMgYW4gaW5kaXZpZHVhbCBjaGlsZCB2aWV3IGZvciBlYWNoIG1vZGVsLgogIE1hcmlvbmV0dGUuQ29sbGVjdGlvblZpZXcgPSBNYXJpb25ldHRlLlZpZXcuZXh0ZW5kKHsKICAgIC8vIHVzZWQgYXMgdGhlIHByZWZpeCBmb3IgY2hpbGQgdmlldyBldmVudHMKICAgIC8vIHRoYXQgYXJlIGZvcndhcmRlZCB0aHJvdWdoIHRoZSBjb2xsZWN0aW9udmlldwogICAgY2hpbGRWaWV3RXZlbnRQcmVmaXg6ICdjaGlsZHZpZXcnLAogICAgLy8gY29uc3RydWN0b3IKICAgIC8vIG9wdGlvbiB0byBwYXNzIGB7c29ydDogZmFsc2V9YCB0byBwcmV2ZW50IHRoZSBgQ29sbGVjdGlvblZpZXdgIGZyb20KICAgIC8vIG1haW50YWluaW5nIHRoZSBzb3J0ZWQgb3JkZXIgb2YgdGhlIGNvbGxlY3Rpb24uCiAgICAvLyBUaGlzIHdpbGwgZmFsbGJhY2sgb250byBhcHBlbmRpbmcgY2hpbGRWaWV3J3MgdG8gdGhlIGVuZC4KICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbiAob3B0aW9ucykgewogICAgICB2YXIgaW5pdE9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogICAgICB0aGlzLnNvcnQgPSBfLmlzVW5kZWZpbmVkKGluaXRPcHRpb25zLnNvcnQpID8gdHJ1ZSA6IGluaXRPcHRpb25zLnNvcnQ7CiAgICAgIGlmIChpbml0T3B0aW9ucy5jb2xsZWN0aW9uICYmICEoaW5pdE9wdGlvbnMuY29sbGVjdGlvbiBpbnN0YW5jZW9mIEJhY2tib25lLkNvbGxlY3Rpb24pKSB7CiAgICAgICAgdGhyb3cgbmV3IE1hcmlvbmV0dGUuRXJyb3IoJ1RoZSBDb2xsZWN0aW9uIG9wdGlvbiBwYXNzZWQgdG8gdGhpcyB2aWV3IG5lZWRzIHRvIGJlIGFuIGluc3RhbmNlIG9mIGEgQmFja2JvbmUuQ29sbGVjdGlvbicpOwogICAgICB9CiAgICAgIHRoaXMub25jZSgncmVuZGVyJywgdGhpcy5faW5pdGlhbEV2ZW50cyk7CiAgICAgIHRoaXMuX2luaXRDaGlsZFZpZXdTdG9yYWdlKCk7CiAgICAgIE1hcmlvbmV0dGUuVmlldy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB0aGlzLmluaXRSZW5kZXJCdWZmZXIoKTsKICAgIH0sCiAgICAvLyBJbnN0ZWFkIG9mIGluc2VydGluZyBlbGVtZW50cyBvbmUgYnkgb25lIGludG8gdGhlIHBhZ2UsCiAgICAvLyBpdCdzIG11Y2ggbW9yZSBwZXJmb3JtYW50IHRvIGluc2VydCBlbGVtZW50cyBpbnRvIGEgZG9jdW1lbnQKICAgIC8vIGZyYWdtZW50IGFuZCB0aGVuIGluc2VydCB0aGF0IGRvY3VtZW50IGZyYWdtZW50IGludG8gdGhlIHBhZ2UKICAgIGluaXRSZW5kZXJCdWZmZXI6IGZ1bmN0aW9uICgpIHsKICAgICAgdGhpcy5lbEJ1ZmZlciA9IGRvY3VtZW50LmNyZWF0ZURvY3VtZW50RnJhZ21lbnQoKTsKICAgICAgdGhpcy5fYnVmZmVyZWRDaGlsZHJlbiA9IFtdOwogICAgfSwKICAgIHN0YXJ0QnVmZmVyaW5nOiBmdW5jdGlvbiAoKSB7CiAgICAgIHRoaXMuaW5pdFJlbmRlckJ1ZmZlcigpOwogICAgICB0aGlzLmlzQnVmZmVyaW5nID0gdHJ1ZTsKICAgIH0sCiAgICBlbmRCdWZmZXJpbmc6IGZ1bmN0aW9uICgpIHsKICAgICAgdGhpcy5pc0J1ZmZlcmluZyA9IGZhbHNlOwogICAgICB0aGlzLl90cmlnZ2VyQmVmb3JlU2hvd0J1ZmZlcmVkQ2hpbGRyZW4oKTsKICAgICAgdGhpcy5hdHRhY2hCdWZmZXIodGhpcywgdGhpcy5lbEJ1ZmZlcik7CiAgICAgIHRoaXMuX3RyaWdnZXJTaG93QnVmZmVyZWRDaGlsZHJlbigpOwogICAgICB0aGlzLmluaXRSZW5kZXJCdWZmZXIoKTsKICAgIH0sCiAgICBfdHJpZ2dlckJlZm9yZVNob3dCdWZmZXJlZENoaWxkcmVuOiBmdW5jdGlvbiAoKSB7CiAgICAgIGlmICh0aGlzLl9pc1Nob3duKSB7CiAgICAgICAgXy5lYWNoKHRoaXMuX2J1ZmZlcmVkQ2hpbGRyZW4sIF8ucGFydGlhbCh0aGlzLl90cmlnZ2VyTWV0aG9kT25DaGlsZCwgJ2JlZm9yZTpzaG93JykpOwogICAgICB9CiAgICB9LAogICAgX3RyaWdnZXJTaG93QnVmZmVyZWRDaGlsZHJlbjogZnVuY3Rpb24gKCkgewogICAgICBpZiAodGhpcy5faXNTaG93bikgewogICAgICAgIF8uZWFjaCh0aGlzLl9idWZmZXJlZENoaWxkcmVuLCBfLnBhcnRpYWwodGhpcy5fdHJpZ2dlck1ldGhvZE9uQ2hpbGQsICdzaG93JykpOwogICAgICAgIHRoaXMuX2J1ZmZlcmVkQ2hpbGRyZW4gPSBbXTsKICAgICAgfQogICAgfSwKICAgIC8vIEludGVybmFsIG1ldGhvZCBmb3IgXy5lYWNoIGxvb3BzIHRvIGNhbGwgYE1hcmlvbmV0dGUudHJpZ2dlck1ldGhvZE9uYCBvbgogICAgLy8gYSBjaGlsZCB2aWV3CiAgICBfdHJpZ2dlck1ldGhvZE9uQ2hpbGQ6IGZ1bmN0aW9uIChldmVudCwgY2hpbGRWaWV3KSB7CiAgICAgIE1hcmlvbmV0dGUudHJpZ2dlck1ldGhvZE9uKGNoaWxkVmlldywgZXZlbnQpOwogICAgfSwKICAgIC8vIENvbmZpZ3VyZWQgdGhlIGluaXRpYWwgZXZlbnRzIHRoYXQgdGhlIGNvbGxlY3Rpb24gdmlldwogICAgLy8gYmluZHMgdG8uCiAgICBfaW5pdGlhbEV2ZW50czogZnVuY3Rpb24gKCkgewogICAgICBpZiAodGhpcy5jb2xsZWN0aW9uKSB7CiAgICAgICAgdGhpcy5saXN0ZW5Ubyh0aGlzLmNvbGxlY3Rpb24sICdhZGQnLCB0aGlzLl9vbkNvbGxlY3Rpb25BZGQpOwogICAgICAgIHRoaXMubGlzdGVuVG8odGhpcy5jb2xsZWN0aW9uLCAncmVtb3ZlJywgdGhpcy5fb25Db2xsZWN0aW9uUmVtb3ZlKTsKICAgICAgICB0aGlzLmxpc3RlblRvKHRoaXMuY29sbGVjdGlvbiwgJ3Jlc2V0JywgdGhpcy5yZW5kZXIpOwogICAgICAgIGlmICh0aGlzLnNvcnQpIHsKICAgICAgICAgIHRoaXMubGlzdGVuVG8odGhpcy5jb2xsZWN0aW9uLCAnc29ydCcsIHRoaXMuX3NvcnRWaWV3cyk7CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgLy8gSGFuZGxlIGEgY2hpbGQgYWRkZWQgdG8gdGhlIGNvbGxlY3Rpb24KICAgIF9vbkNvbGxlY3Rpb25BZGQ6IGZ1bmN0aW9uIChjaGlsZCkgewogICAgICB0aGlzLmRlc3Ryb3lFbXB0eVZpZXcoKTsKICAgICAgdmFyIENoaWxkVmlldyA9IHRoaXMuZ2V0Q2hpbGRWaWV3KGNoaWxkKTsKICAgICAgdmFyIGluZGV4ID0gdGhpcy5jb2xsZWN0aW9uLmluZGV4T2YoY2hpbGQpOwogICAgICB0aGlzLmFkZENoaWxkKGNoaWxkLCBDaGlsZFZpZXcsIGluZGV4KTsKICAgIH0sCiAgICAvLyBnZXQgdGhlIGNoaWxkIHZpZXcgYnkgbW9kZWwgaXQgaG9sZHMsIGFuZCByZW1vdmUgaXQKICAgIF9vbkNvbGxlY3Rpb25SZW1vdmU6IGZ1bmN0aW9uIChtb2RlbCkgewogICAgICB2YXIgdmlldyA9IHRoaXMuY2hpbGRyZW4uZmluZEJ5TW9kZWwobW9kZWwpOwogICAgICB0aGlzLnJlbW92ZUNoaWxkVmlldyh2aWV3KTsKICAgICAgdGhpcy5jaGVja0VtcHR5KCk7CiAgICB9LAogICAgLy8gT3ZlcnJpZGUgZnJvbSBgTWFyaW9uZXR0ZS5WaWV3YCB0byB0cmlnZ2VyIHNob3cgb24gY2hpbGQgdmlld3MKICAgIG9uU2hvd0NhbGxlZDogZnVuY3Rpb24gKCkgewogICAgICB0aGlzLmNoaWxkcmVuLmVhY2goXy5wYXJ0aWFsKHRoaXMuX3RyaWdnZXJNZXRob2RPbkNoaWxkLCAnc2hvdycpKTsKICAgIH0sCiAgICAvLyBSZW5kZXIgY2hpbGRyZW4gdmlld3MuIE92ZXJyaWRlIHRoaXMgbWV0aG9kIHRvCiAgICAvLyBwcm92aWRlIHlvdXIgb3duIGltcGxlbWVudGF0aW9uIG9mIGEgcmVuZGVyIGZ1bmN0aW9uIGZvcgogICAgLy8gdGhlIGNvbGxlY3Rpb24gdmlldy4KICAgIHJlbmRlcjogZnVuY3Rpb24gKCkgewogICAgICB0aGlzLl9lbnN1cmVWaWV3SXNJbnRhY3QoKTsKICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdiZWZvcmU6cmVuZGVyJywgdGhpcyk7CiAgICAgIHRoaXMuX3JlbmRlckNoaWxkcmVuKCk7CiAgICAgIHRoaXMudHJpZ2dlck1ldGhvZCgncmVuZGVyJywgdGhpcyk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAgIC8vIFJlbmRlciB2aWV3IGFmdGVyIHNvcnRpbmcuIE92ZXJyaWRlIHRoaXMgbWV0aG9kIHRvCiAgICAvLyBjaGFuZ2UgaG93IHRoZSB2aWV3IHJlbmRlcnMgYWZ0ZXIgYSBgc29ydGAgb24gdGhlIGNvbGxlY3Rpb24uCiAgICAvLyBBbiBleGFtcGxlIG9mIHRoaXMgd291bGQgYmUgdG8gb25seSBgcmVuZGVyQ2hpbGRyZW5gIGluIGEgYENvbXBvc2l0ZVZpZXdgCiAgICAvLyByYXRoZXIgdGhhbiB0aGUgZnVsbCB2aWV3LgogICAgcmVzb3J0VmlldzogZnVuY3Rpb24gKCkgewogICAgICB0aGlzLnJlbmRlcigpOwogICAgfSwKICAgIC8vIEludGVybmFsIG1ldGhvZC4gVGhpcyBjaGVja3MgZm9yIGFueSBjaGFuZ2VzIGluIHRoZSBvcmRlciBvZiB0aGUgY29sbGVjdGlvbi4KICAgIC8vIElmIHRoZSBpbmRleCBvZiBhbnkgdmlldyBkb2Vzbid0IG1hdGNoLCBpdCB3aWxsIHJlbmRlci4KICAgIF9zb3J0Vmlld3M6IGZ1bmN0aW9uICgpIHsKICAgICAgLy8gY2hlY2sgZm9yIGFueSBjaGFuZ2VzIGluIHNvcnQgb3JkZXIgb2Ygdmlld3MKICAgICAgdmFyIG9yZGVyQ2hhbmdlZCA9IHRoaXMuY29sbGVjdGlvbi5maW5kKGZ1bmN0aW9uIChpdGVtLCBpbmRleCkgewogICAgICAgIHZhciB2aWV3ID0gdGhpcy5jaGlsZHJlbi5maW5kQnlNb2RlbChpdGVtKTsKICAgICAgICByZXR1cm4gIXZpZXcgfHwgdmlldy5faW5kZXggIT09IGluZGV4OwogICAgICB9LCB0aGlzKTsKICAgICAgaWYgKG9yZGVyQ2hhbmdlZCkgewogICAgICAgIHRoaXMucmVzb3J0VmlldygpOwogICAgICB9CiAgICB9LAogICAgLy8gSW50ZXJuYWwgbWV0aG9kLiBTZXBhcmF0ZWQgc28gdGhhdCBDb21wb3NpdGVWaWV3IGNhbiBoYXZlCiAgICAvLyBtb3JlIGNvbnRyb2wgb3ZlciBldmVudHMgYmVpbmcgdHJpZ2dlcmVkLCBhcm91bmQgdGhlIHJlbmRlcmluZwogICAgLy8gcHJvY2VzcwogICAgX3JlbmRlckNoaWxkcmVuOiBmdW5jdGlvbiAoKSB7CiAgICAgIHRoaXMuZGVzdHJveUVtcHR5VmlldygpOwogICAgICB0aGlzLmRlc3Ryb3lDaGlsZHJlbigpOwogICAgICBpZiAodGhpcy5pc0VtcHR5KHRoaXMuY29sbGVjdGlvbikpIHsKICAgICAgICB0aGlzLnNob3dFbXB0eVZpZXcoKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLnRyaWdnZXJNZXRob2QoJ2JlZm9yZTpyZW5kZXI6Y29sbGVjdGlvbicsIHRoaXMpOwogICAgICAgIHRoaXMuc3RhcnRCdWZmZXJpbmcoKTsKICAgICAgICB0aGlzLnNob3dDb2xsZWN0aW9uKCk7CiAgICAgICAgdGhpcy5lbmRCdWZmZXJpbmcoKTsKICAgICAgICB0aGlzLnRyaWdnZXJNZXRob2QoJ3JlbmRlcjpjb2xsZWN0aW9uJywgdGhpcyk7CiAgICAgIH0KICAgIH0sCiAgICAvLyBJbnRlcm5hbCBtZXRob2QgdG8gbG9vcCB0aHJvdWdoIGNvbGxlY3Rpb24gYW5kIHNob3cgZWFjaCBjaGlsZCB2aWV3LgogICAgc2hvd0NvbGxlY3Rpb246IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIENoaWxkVmlldzsKICAgICAgdGhpcy5jb2xsZWN0aW9uLmVhY2goZnVuY3Rpb24gKGNoaWxkLCBpbmRleCkgewogICAgICAgIENoaWxkVmlldyA9IHRoaXMuZ2V0Q2hpbGRWaWV3KGNoaWxkKTsKICAgICAgICB0aGlzLmFkZENoaWxkKGNoaWxkLCBDaGlsZFZpZXcsIGluZGV4KTsKICAgICAgfSwgdGhpcyk7CiAgICB9LAogICAgLy8gSW50ZXJuYWwgbWV0aG9kIHRvIHNob3cgYW4gZW1wdHkgdmlldyBpbiBwbGFjZSBvZgogICAgLy8gYSBjb2xsZWN0aW9uIG9mIGNoaWxkIHZpZXdzLCB3aGVuIHRoZSBjb2xsZWN0aW9uIGlzIGVtcHR5CiAgICBzaG93RW1wdHlWaWV3OiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBFbXB0eVZpZXcgPSB0aGlzLmdldEVtcHR5VmlldygpOwogICAgICBpZiAoRW1wdHlWaWV3ICYmICF0aGlzLl9zaG93aW5nRW1wdHlWaWV3KSB7CiAgICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdiZWZvcmU6cmVuZGVyOmVtcHR5Jyk7CiAgICAgICAgdGhpcy5fc2hvd2luZ0VtcHR5VmlldyA9IHRydWU7CiAgICAgICAgdmFyIG1vZGVsID0gbmV3IEJhY2tib25lLk1vZGVsKCk7CiAgICAgICAgdGhpcy5hZGRFbXB0eVZpZXcobW9kZWwsIEVtcHR5Vmlldyk7CiAgICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdyZW5kZXI6ZW1wdHknKTsKICAgICAgfQogICAgfSwKICAgIC8vIEludGVybmFsIG1ldGhvZCB0byBkZXN0cm95IGFuIGV4aXN0aW5nIGVtcHR5VmlldyBpbnN0YW5jZQogICAgLy8gaWYgb25lIGV4aXN0cy4gQ2FsbGVkIHdoZW4gYSBjb2xsZWN0aW9uIHZpZXcgaGFzIGJlZW4KICAgIC8vIHJlbmRlcmVkIGVtcHR5LCBhbmQgdGhlbiBhIGNoaWxkIGlzIGFkZGVkIHRvIHRoZSBjb2xsZWN0aW9uLgogICAgZGVzdHJveUVtcHR5VmlldzogZnVuY3Rpb24gKCkgewogICAgICBpZiAodGhpcy5fc2hvd2luZ0VtcHR5VmlldykgewogICAgICAgIHRoaXMudHJpZ2dlck1ldGhvZCgnYmVmb3JlOnJlbW92ZTplbXB0eScpOwogICAgICAgIHRoaXMuZGVzdHJveUNoaWxkcmVuKCk7CiAgICAgICAgZGVsZXRlIHRoaXMuX3Nob3dpbmdFbXB0eVZpZXc7CiAgICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdyZW1vdmU6ZW1wdHknKTsKICAgICAgfQogICAgfSwKICAgIC8vIFJldHJpZXZlIHRoZSBlbXB0eSB2aWV3IGNsYXNzCiAgICBnZXRFbXB0eVZpZXc6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIHRoaXMuZ2V0T3B0aW9uKCdlbXB0eVZpZXcnKTsKICAgIH0sCiAgICAvLyBSZW5kZXIgYW5kIHNob3cgdGhlIGVtcHR5Vmlldy4gU2ltaWxhciB0byBhZGRDaGlsZCBtZXRob2QKICAgIC8vIGJ1dCAiY2hpbGQ6YWRkZWQiIGV2ZW50cyBhcmUgbm90IGZpcmVkLCBhbmQgdGhlIGV2ZW50IGZyb20KICAgIC8vIGVtcHR5VmlldyBhcmUgbm90IGZvcndhcmRlZAogICAgYWRkRW1wdHlWaWV3OiBmdW5jdGlvbiAoY2hpbGQsIEVtcHR5VmlldykgewogICAgICAvLyBnZXQgdGhlIGVtcHR5Vmlld09wdGlvbnMsIGZhbGxpbmcgYmFjayB0byBjaGlsZFZpZXdPcHRpb25zCiAgICAgIHZhciBlbXB0eVZpZXdPcHRpb25zID0gdGhpcy5nZXRPcHRpb24oJ2VtcHR5Vmlld09wdGlvbnMnKSB8fCB0aGlzLmdldE9wdGlvbignY2hpbGRWaWV3T3B0aW9ucycpOwogICAgICBpZiAoXy5pc0Z1bmN0aW9uKGVtcHR5Vmlld09wdGlvbnMpKSB7CiAgICAgICAgZW1wdHlWaWV3T3B0aW9ucyA9IGVtcHR5Vmlld09wdGlvbnMuY2FsbCh0aGlzKTsKICAgICAgfQogICAgICAvLyBidWlsZCB0aGUgZW1wdHkgdmlldwogICAgICB2YXIgdmlldyA9IHRoaXMuYnVpbGRDaGlsZFZpZXcoY2hpbGQsIEVtcHR5VmlldywgZW1wdHlWaWV3T3B0aW9ucyk7CiAgICAgIC8vIFByb3h5IGVtcHR5VmlldyBldmVudHMKICAgICAgdGhpcy5wcm94eUNoaWxkRXZlbnRzKHZpZXcpOwogICAgICAvLyB0cmlnZ2VyIHRoZSAnYmVmb3JlOnNob3cnIGV2ZW50IG9uIGB2aWV3YCBpZiB0aGUgY29sbGVjdGlvbiB2aWV3CiAgICAgIC8vIGhhcyBhbHJlYWR5IGJlZW4gc2hvd24KICAgICAgaWYgKHRoaXMuX2lzU2hvd24pIHsKICAgICAgICBNYXJpb25ldHRlLnRyaWdnZXJNZXRob2RPbih2aWV3LCAnYmVmb3JlOnNob3cnKTsKICAgICAgfQogICAgICAvLyBTdG9yZSB0aGUgYGVtcHR5Vmlld2AgbGlrZSBhIGBjaGlsZFZpZXdgIHNvIHdlIGNhbiBwcm9wZXJseQogICAgICAvLyByZW1vdmUgYW5kL29yIGNsb3NlIGl0IGxhdGVyCiAgICAgIHRoaXMuY2hpbGRyZW4uYWRkKHZpZXcpOwogICAgICAvLyBSZW5kZXIgaXQgYW5kIHNob3cgaXQKICAgICAgdGhpcy5yZW5kZXJDaGlsZFZpZXcodmlldywgLTEpOwogICAgICAvLyBjYWxsIHRoZSAnc2hvdycgbWV0aG9kIGlmIHRoZSBjb2xsZWN0aW9uIHZpZXcKICAgICAgLy8gaGFzIGFscmVhZHkgYmVlbiBzaG93bgogICAgICBpZiAodGhpcy5faXNTaG93bikgewogICAgICAgIE1hcmlvbmV0dGUudHJpZ2dlck1ldGhvZE9uKHZpZXcsICdzaG93Jyk7CiAgICAgIH0KICAgIH0sCiAgICAvLyBSZXRyaWV2ZSB0aGUgYGNoaWxkVmlld2AgY2xhc3MsIGVpdGhlciBmcm9tIGB0aGlzLm9wdGlvbnMuY2hpbGRWaWV3YAogICAgLy8gb3IgZnJvbSB0aGUgYGNoaWxkVmlld2AgaW4gdGhlIG9iamVjdCBkZWZpbml0aW9uLiBUaGUgIm9wdGlvbnMiCiAgICAvLyB0YWtlcyBwcmVjZWRlbmNlLgogICAgLy8gVGhpcyBtZXRob2QgcmVjZWl2ZXMgdGhlIG1vZGVsIHRoYXQgd2lsbCBiZSBwYXNzZWQgdG8gdGhlIGluc3RhbmNlCiAgICAvLyBjcmVhdGVkIGZyb20gdGhpcyBgY2hpbGRWaWV3YC4gT3ZlcnJpZGluZyBtZXRob2RzIG1heSB1c2UgdGhlIGNoaWxkCiAgICAvLyB0byBkZXRlcm1pbmUgd2hhdCBgY2hpbGRWaWV3YCBjbGFzcyB0byByZXR1cm4uCiAgICBnZXRDaGlsZFZpZXc6IGZ1bmN0aW9uIChjaGlsZCkgewogICAgICB2YXIgY2hpbGRWaWV3ID0gdGhpcy5nZXRPcHRpb24oJ2NoaWxkVmlldycpOwogICAgICBpZiAoIWNoaWxkVmlldykgewogICAgICAgIHRocm93IG5ldyBNYXJpb25ldHRlLkVycm9yKHsKICAgICAgICAgIG5hbWU6ICdOb0NoaWxkVmlld0Vycm9yJywKICAgICAgICAgIG1lc3NhZ2U6ICdBICJjaGlsZFZpZXciIG11c3QgYmUgc3BlY2lmaWVkJwogICAgICAgIH0pOwogICAgICB9CiAgICAgIHJldHVybiBjaGlsZFZpZXc7CiAgICB9LAogICAgLy8gUmVuZGVyIHRoZSBjaGlsZCdzIHZpZXcgYW5kIGFkZCBpdCB0byB0aGUKICAgIC8vIEhUTUwgZm9yIHRoZSBjb2xsZWN0aW9uIHZpZXcgYXQgYSBnaXZlbiBpbmRleC4KICAgIC8vIFRoaXMgd2lsbCBhbHNvIHVwZGF0ZSB0aGUgaW5kaWNlcyBvZiBsYXRlciB2aWV3cyBpbiB0aGUgY29sbGVjdGlvbgogICAgLy8gaW4gb3JkZXIgdG8ga2VlcCB0aGUgY2hpbGRyZW4gaW4gc3luYyB3aXRoIHRoZSBjb2xsZWN0aW9uLgogICAgYWRkQ2hpbGQ6IGZ1bmN0aW9uIChjaGlsZCwgQ2hpbGRWaWV3LCBpbmRleCkgewogICAgICB2YXIgY2hpbGRWaWV3T3B0aW9ucyA9IHRoaXMuZ2V0T3B0aW9uKCdjaGlsZFZpZXdPcHRpb25zJyk7CiAgICAgIGlmIChfLmlzRnVuY3Rpb24oY2hpbGRWaWV3T3B0aW9ucykpIHsKICAgICAgICBjaGlsZFZpZXdPcHRpb25zID0gY2hpbGRWaWV3T3B0aW9ucy5jYWxsKHRoaXMsIGNoaWxkLCBpbmRleCk7CiAgICAgIH0KICAgICAgdmFyIHZpZXcgPSB0aGlzLmJ1aWxkQ2hpbGRWaWV3KGNoaWxkLCBDaGlsZFZpZXcsIGNoaWxkVmlld09wdGlvbnMpOwogICAgICAvLyBpbmNyZW1lbnQgaW5kaWNlcyBvZiB2aWV3cyBhZnRlciB0aGlzIG9uZQogICAgICB0aGlzLl91cGRhdGVJbmRpY2VzKHZpZXcsIHRydWUsIGluZGV4KTsKICAgICAgdGhpcy5fYWRkQ2hpbGRWaWV3KHZpZXcsIGluZGV4KTsKICAgICAgcmV0dXJuIHZpZXc7CiAgICB9LAogICAgLy8gSW50ZXJuYWwgbWV0aG9kLiBUaGlzIGRlY3JlbWVudHMgb3IgaW5jcmVtZW50cyB0aGUgaW5kaWNlcyBvZiB2aWV3cyBhZnRlciB0aGUKICAgIC8vIGFkZGVkL3JlbW92ZWQgdmlldyB0byBrZWVwIGluIHN5bmMgd2l0aCB0aGUgY29sbGVjdGlvbi4KICAgIF91cGRhdGVJbmRpY2VzOiBmdW5jdGlvbiAodmlldywgaW5jcmVtZW50LCBpbmRleCkgewogICAgICBpZiAoIXRoaXMuc29ydCkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBpZiAoaW5jcmVtZW50KSB7CiAgICAgICAgLy8gYXNzaWduIHRoZSBpbmRleCB0byB0aGUgdmlldwogICAgICAgIHZpZXcuX2luZGV4ID0gaW5kZXg7CiAgICAgICAgLy8gaW5jcmVtZW50IHRoZSBpbmRleCBvZiB2aWV3cyBhZnRlciB0aGlzIG9uZQogICAgICAgIHRoaXMuY2hpbGRyZW4uZWFjaChmdW5jdGlvbiAobGF0ZXJWaWV3KSB7CiAgICAgICAgICBpZiAobGF0ZXJWaWV3Ll9pbmRleCA+PSB2aWV3Ll9pbmRleCkgewogICAgICAgICAgICBsYXRlclZpZXcuX2luZGV4Kys7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gZGVjcmVtZW50IHRoZSBpbmRleCBvZiB2aWV3cyBhZnRlciB0aGlzIG9uZQogICAgICAgIHRoaXMuY2hpbGRyZW4uZWFjaChmdW5jdGlvbiAobGF0ZXJWaWV3KSB7CiAgICAgICAgICBpZiAobGF0ZXJWaWV3Ll9pbmRleCA+PSB2aWV3Ll9pbmRleCkgewogICAgICAgICAgICBsYXRlclZpZXcuX2luZGV4LS07CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0sCiAgICAvLyBJbnRlcm5hbCBNZXRob2QuIEFkZCB0aGUgdmlldyB0byBjaGlsZHJlbiBhbmQgcmVuZGVyIGl0IGF0CiAgICAvLyB0aGUgZ2l2ZW4gaW5kZXguCiAgICBfYWRkQ2hpbGRWaWV3OiBmdW5jdGlvbiAodmlldywgaW5kZXgpIHsKICAgICAgLy8gc2V0IHVwIHRoZSBjaGlsZCB2aWV3IGV2ZW50IGZvcndhcmRpbmcKICAgICAgdGhpcy5wcm94eUNoaWxkRXZlbnRzKHZpZXcpOwogICAgICB0aGlzLnRyaWdnZXJNZXRob2QoJ2JlZm9yZTphZGQ6Y2hpbGQnLCB2aWV3KTsKICAgICAgLy8gU3RvcmUgdGhlIGNoaWxkIHZpZXcgaXRzZWxmIHNvIHdlIGNhbiBwcm9wZXJseQogICAgICAvLyByZW1vdmUgYW5kL29yIGRlc3Ryb3kgaXQgbGF0ZXIKICAgICAgdGhpcy5jaGlsZHJlbi5hZGQodmlldyk7CiAgICAgIHRoaXMucmVuZGVyQ2hpbGRWaWV3KHZpZXcsIGluZGV4KTsKICAgICAgaWYgKHRoaXMuX2lzU2hvd24gJiYgIXRoaXMuaXNCdWZmZXJpbmcpIHsKICAgICAgICBNYXJpb25ldHRlLnRyaWdnZXJNZXRob2RPbih2aWV3LCAnc2hvdycpOwogICAgICB9CiAgICAgIHRoaXMudHJpZ2dlck1ldGhvZCgnYWRkOmNoaWxkJywgdmlldyk7CiAgICB9LAogICAgLy8gcmVuZGVyIHRoZSBjaGlsZCB2aWV3CiAgICByZW5kZXJDaGlsZFZpZXc6IGZ1bmN0aW9uICh2aWV3LCBpbmRleCkgewogICAgICB2aWV3LnJlbmRlcigpOwogICAgICB0aGlzLmF0dGFjaEh0bWwodGhpcywgdmlldywgaW5kZXgpOwogICAgICByZXR1cm4gdmlldzsKICAgIH0sCiAgICAvLyBCdWlsZCBhIGBjaGlsZFZpZXdgIGZvciBhIG1vZGVsIGluIHRoZSBjb2xsZWN0aW9uLgogICAgYnVpbGRDaGlsZFZpZXc6IGZ1bmN0aW9uIChjaGlsZCwgQ2hpbGRWaWV3Q2xhc3MsIGNoaWxkVmlld09wdGlvbnMpIHsKICAgICAgdmFyIG9wdGlvbnMgPSBfLmV4dGVuZCh7IG1vZGVsOiBjaGlsZCB9LCBjaGlsZFZpZXdPcHRpb25zKTsKICAgICAgcmV0dXJuIG5ldyBDaGlsZFZpZXdDbGFzcyhvcHRpb25zKTsKICAgIH0sCiAgICAvLyBSZW1vdmUgdGhlIGNoaWxkIHZpZXcgYW5kIGRlc3Ryb3kgaXQuCiAgICAvLyBUaGlzIGZ1bmN0aW9uIGFsc28gdXBkYXRlcyB0aGUgaW5kaWNlcyBvZgogICAgLy8gbGF0ZXIgdmlld3MgaW4gdGhlIGNvbGxlY3Rpb24gaW4gb3JkZXIgdG8ga2VlcAogICAgLy8gdGhlIGNoaWxkcmVuIGluIHN5bmMgd2l0aCB0aGUgY29sbGVjdGlvbi4KICAgIHJlbW92ZUNoaWxkVmlldzogZnVuY3Rpb24gKHZpZXcpIHsKICAgICAgaWYgKHZpZXcpIHsKICAgICAgICB0aGlzLnRyaWdnZXJNZXRob2QoJ2JlZm9yZTpyZW1vdmU6Y2hpbGQnLCB2aWV3KTsKICAgICAgICAvLyBjYWxsICdkZXN0cm95JyBvciAncmVtb3ZlJywgZGVwZW5kaW5nIG9uIHdoaWNoIGlzIGZvdW5kCiAgICAgICAgaWYgKHZpZXcuZGVzdHJveSkgewogICAgICAgICAgdmlldy5kZXN0cm95KCk7CiAgICAgICAgfSBlbHNlIGlmICh2aWV3LnJlbW92ZSkgewogICAgICAgICAgdmlldy5yZW1vdmUoKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5zdG9wTGlzdGVuaW5nKHZpZXcpOwogICAgICAgIHRoaXMuY2hpbGRyZW4ucmVtb3ZlKHZpZXcpOwogICAgICAgIHRoaXMudHJpZ2dlck1ldGhvZCgncmVtb3ZlOmNoaWxkJywgdmlldyk7CiAgICAgICAgLy8gZGVjcmVtZW50IHRoZSBpbmRleCBvZiB2aWV3cyBhZnRlciB0aGlzIG9uZQogICAgICAgIHRoaXMuX3VwZGF0ZUluZGljZXModmlldywgZmFsc2UpOwogICAgICB9CiAgICAgIHJldHVybiB2aWV3OwogICAgfSwKICAgIC8vIGNoZWNrIGlmIHRoZSBjb2xsZWN0aW9uIGlzIGVtcHR5CiAgICBpc0VtcHR5OiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiAhdGhpcy5jb2xsZWN0aW9uIHx8IHRoaXMuY29sbGVjdGlvbi5sZW5ndGggPT09IDA7CiAgICB9LAogICAgLy8gSWYgZW1wdHksIHNob3cgdGhlIGVtcHR5IHZpZXcKICAgIGNoZWNrRW1wdHk6IGZ1bmN0aW9uICgpIHsKICAgICAgaWYgKHRoaXMuaXNFbXB0eSh0aGlzLmNvbGxlY3Rpb24pKSB7CiAgICAgICAgdGhpcy5zaG93RW1wdHlWaWV3KCk7CiAgICAgIH0KICAgIH0sCiAgICAvLyBZb3UgbWlnaHQgbmVlZCB0byBvdmVycmlkZSB0aGlzIGlmIHlvdSd2ZSBvdmVycmlkZGVuIGF0dGFjaEh0bWwKICAgIGF0dGFjaEJ1ZmZlcjogZnVuY3Rpb24gKGNvbGxlY3Rpb25WaWV3LCBidWZmZXIpIHsKICAgICAgY29sbGVjdGlvblZpZXcuJGVsLmFwcGVuZChidWZmZXIpOwogICAgfSwKICAgIC8vIEFwcGVuZCB0aGUgSFRNTCB0byB0aGUgY29sbGVjdGlvbidzIGBlbGAuCiAgICAvLyBPdmVycmlkZSB0aGlzIG1ldGhvZCB0byBkbyBzb21ldGhpbmcgb3RoZXIKICAgIC8vIHRoYW4gYC5hcHBlbmRgLgogICAgYXR0YWNoSHRtbDogZnVuY3Rpb24gKGNvbGxlY3Rpb25WaWV3LCBjaGlsZFZpZXcsIGluZGV4KSB7CiAgICAgIGlmIChjb2xsZWN0aW9uVmlldy5pc0J1ZmZlcmluZykgewogICAgICAgIC8vIGJ1ZmZlcmluZyBoYXBwZW5zIG9uIHJlc2V0IGV2ZW50cyBhbmQgaW5pdGlhbCByZW5kZXJzCiAgICAgICAgLy8gaW4gb3JkZXIgdG8gcmVkdWNlIHRoZSBudW1iZXIgb2YgaW5zZXJ0cyBpbnRvIHRoZQogICAgICAgIC8vIGRvY3VtZW50LCB3aGljaCBhcmUgZXhwZW5zaXZlLgogICAgICAgIGNvbGxlY3Rpb25WaWV3LmVsQnVmZmVyLmFwcGVuZENoaWxkKGNoaWxkVmlldy5lbCk7CiAgICAgICAgY29sbGVjdGlvblZpZXcuX2J1ZmZlcmVkQ2hpbGRyZW4ucHVzaChjaGlsZFZpZXcpOwogICAgICB9IGVsc2UgewogICAgICAgIC8vIElmIHdlJ3ZlIGFscmVhZHkgcmVuZGVyZWQgdGhlIG1haW4gY29sbGVjdGlvbiwgYXBwZW5kCiAgICAgICAgLy8gdGhlIG5ldyBjaGlsZCBpbnRvIHRoZSBjb3JyZWN0IG9yZGVyIGlmIHdlIG5lZWQgdG8uIE90aGVyd2lzZQogICAgICAgIC8vIGFwcGVuZCB0byB0aGUgZW5kLgogICAgICAgIGlmICghY29sbGVjdGlvblZpZXcuX2luc2VydEJlZm9yZShjaGlsZFZpZXcsIGluZGV4KSkgewogICAgICAgICAgY29sbGVjdGlvblZpZXcuX2luc2VydEFmdGVyKGNoaWxkVmlldyk7CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgLy8gSW50ZXJuYWwgbWV0aG9kLiBDaGVjayB3aGV0aGVyIHdlIG5lZWQgdG8gaW5zZXJ0IHRoZSB2aWV3IGludG8KICAgIC8vIHRoZSBjb3JyZWN0IHBvc2l0aW9uLgogICAgX2luc2VydEJlZm9yZTogZnVuY3Rpb24gKGNoaWxkVmlldywgaW5kZXgpIHsKICAgICAgdmFyIGN1cnJlbnRWaWV3OwogICAgICB2YXIgZmluZFBvc2l0aW9uID0gdGhpcy5zb3J0ICYmIGluZGV4IDwgdGhpcy5jaGlsZHJlbi5sZW5ndGggLSAxOwogICAgICBpZiAoZmluZFBvc2l0aW9uKSB7CiAgICAgICAgLy8gRmluZCB0aGUgdmlldyBhZnRlciB0aGlzIG9uZQogICAgICAgIGN1cnJlbnRWaWV3ID0gdGhpcy5jaGlsZHJlbi5maW5kKGZ1bmN0aW9uICh2aWV3KSB7CiAgICAgICAgICByZXR1cm4gdmlldy5faW5kZXggPT09IGluZGV4ICsgMTsKICAgICAgICB9KTsKICAgICAgfQogICAgICBpZiAoY3VycmVudFZpZXcpIHsKICAgICAgICBjdXJyZW50Vmlldy4kZWwuYmVmb3JlKGNoaWxkVmlldy5lbCk7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgICAgcmV0dXJuIGZhbHNlOwogICAgfSwKICAgIC8vIEludGVybmFsIG1ldGhvZC4gQXBwZW5kIGEgdmlldyB0byB0aGUgZW5kIG9mIHRoZSAkZWwKICAgIF9pbnNlcnRBZnRlcjogZnVuY3Rpb24gKGNoaWxkVmlldykgewogICAgICB0aGlzLiRlbC5hcHBlbmQoY2hpbGRWaWV3LmVsKTsKICAgIH0sCiAgICAvLyBJbnRlcm5hbCBtZXRob2QgdG8gc2V0IHVwIHRoZSBgY2hpbGRyZW5gIG9iamVjdCBmb3IKICAgIC8vIHN0b3JpbmcgYWxsIG9mIHRoZSBjaGlsZCB2aWV3cwogICAgX2luaXRDaGlsZFZpZXdTdG9yYWdlOiBmdW5jdGlvbiAoKSB7CiAgICAgIHRoaXMuY2hpbGRyZW4gPSBuZXcgQmFja2JvbmUuQ2hpbGRWaWV3Q29udGFpbmVyKCk7CiAgICB9LAogICAgLy8gSGFuZGxlIGNsZWFudXAgYW5kIG90aGVyIGRlc3Ryb3lpbmcgbmVlZHMgZm9yIHRoZSBjb2xsZWN0aW9uIG9mIHZpZXdzCiAgICBkZXN0cm95OiBmdW5jdGlvbiAoKSB7CiAgICAgIGlmICh0aGlzLmlzRGVzdHJveWVkKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIHRoaXMudHJpZ2dlck1ldGhvZCgnYmVmb3JlOmRlc3Ryb3k6Y29sbGVjdGlvbicpOwogICAgICB0aGlzLmRlc3Ryb3lDaGlsZHJlbigpOwogICAgICB0aGlzLnRyaWdnZXJNZXRob2QoJ2Rlc3Ryb3k6Y29sbGVjdGlvbicpOwogICAgICByZXR1cm4gTWFyaW9uZXR0ZS5WaWV3LnByb3RvdHlwZS5kZXN0cm95LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9LAogICAgLy8gRGVzdHJveSB0aGUgY2hpbGQgdmlld3MgdGhhdCB0aGlzIGNvbGxlY3Rpb24gdmlldwogICAgLy8gaXMgaG9sZGluZyBvbiB0bywgaWYgYW55CiAgICBkZXN0cm95Q2hpbGRyZW46IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIGNoaWxkVmlld3MgPSB0aGlzLmNoaWxkcmVuLm1hcChfLmlkZW50aXR5KTsKICAgICAgdGhpcy5jaGlsZHJlbi5lYWNoKHRoaXMucmVtb3ZlQ2hpbGRWaWV3LCB0aGlzKTsKICAgICAgdGhpcy5jaGVja0VtcHR5KCk7CiAgICAgIHJldHVybiBjaGlsZFZpZXdzOwogICAgfSwKICAgIC8vIFNldCB1cCB0aGUgY2hpbGQgdmlldyBldmVudCBmb3J3YXJkaW5nLiBVc2VzIGEgImNoaWxkdmlldzoiCiAgICAvLyBwcmVmaXggaW4gZnJvbnQgb2YgYWxsIGZvcndhcmRlZCBldmVudHMuCiAgICBwcm94eUNoaWxkRXZlbnRzOiBmdW5jdGlvbiAodmlldykgewogICAgICB2YXIgcHJlZml4ID0gdGhpcy5nZXRPcHRpb24oJ2NoaWxkVmlld0V2ZW50UHJlZml4Jyk7CiAgICAgIC8vIEZvcndhcmQgYWxsIGNoaWxkIHZpZXcgZXZlbnRzIHRocm91Z2ggdGhlIHBhcmVudCwKICAgICAgLy8gcHJlcGVuZGluZyAiY2hpbGR2aWV3OiIgdG8gdGhlIGV2ZW50IG5hbWUKICAgICAgdGhpcy5saXN0ZW5Ubyh2aWV3LCAnYWxsJywgZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMpOwogICAgICAgIHZhciByb290RXZlbnQgPSBhcmdzWzBdOwogICAgICAgIHZhciBjaGlsZEV2ZW50cyA9IHRoaXMubm9ybWFsaXplTWV0aG9kcyhfLnJlc3VsdCh0aGlzLCAnY2hpbGRFdmVudHMnKSk7CiAgICAgICAgYXJnc1swXSA9IHByZWZpeCArICc6JyArIHJvb3RFdmVudDsKICAgICAgICBhcmdzLnNwbGljZSgxLCAwLCB2aWV3KTsKICAgICAgICAvLyBjYWxsIGNvbGxlY3Rpb25WaWV3IGNoaWxkRXZlbnQgaWYgZGVmaW5lZAogICAgICAgIGlmICh0eXBlb2YgY2hpbGRFdmVudHMgIT09ICd1bmRlZmluZWQnICYmIF8uaXNGdW5jdGlvbihjaGlsZEV2ZW50c1tyb290RXZlbnRdKSkgewogICAgICAgICAgY2hpbGRFdmVudHNbcm9vdEV2ZW50XS5hcHBseSh0aGlzLCBhcmdzLnNsaWNlKDEpKTsKICAgICAgICB9CiAgICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgICB9LCB0aGlzKTsKICAgIH0KICB9KTsKICAvKiBqc2hpbnQgbWF4c3RhdGVtZW50czogMTcsIG1heGxlbjogMTE3ICovCiAgLy8gQ29tcG9zaXRlIFZpZXcKICAvLyAtLS0tLS0tLS0tLS0tLQogIC8vIFVzZWQgZm9yIHJlbmRlcmluZyBhIGJyYW5jaC1sZWFmLCBoaWVyYXJjaGljYWwgc3RydWN0dXJlLgogIC8vIEV4dGVuZHMgZGlyZWN0bHkgZnJvbSBDb2xsZWN0aW9uVmlldyBhbmQgYWxzbyByZW5kZXJzIGFuCiAgLy8gYSBjaGlsZCB2aWV3IGFzIGBtb2RlbFZpZXdgLCBmb3IgdGhlIHRvcCBsZWFmCiAgTWFyaW9uZXR0ZS5Db21wb3NpdGVWaWV3ID0gTWFyaW9uZXR0ZS5Db2xsZWN0aW9uVmlldy5leHRlbmQoewogICAgLy8gU2V0dGluZyB1cCB0aGUgaW5oZXJpdGFuY2UgY2hhaW4gd2hpY2ggYWxsb3dzIGNoYW5nZXMgdG8KICAgIC8vIE1hcmlvbmV0dGUuQ29sbGVjdGlvblZpZXcucHJvdG90eXBlLmNvbnN0cnVjdG9yIHdoaWNoIGFsbG93cyBvdmVycmlkaW5nCiAgICAvLyBvcHRpb24gdG8gcGFzcyAne3NvcnQ6IGZhbHNlfScgdG8gcHJldmVudCB0aGUgQ29tcG9zaXRlVmlldyBmcm9tCiAgICAvLyBtYWludGFpbmluZyB0aGUgc29ydGVkIG9yZGVyIG9mIHRoZSBjb2xsZWN0aW9uLgogICAgLy8gVGhpcyB3aWxsIGZhbGxiYWNrIG9udG8gYXBwZW5kaW5nIGNoaWxkVmlldydzIHRvIHRoZSBlbmQuCiAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24gKCkgewogICAgICBNYXJpb25ldHRlLkNvbGxlY3Rpb25WaWV3LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9LAogICAgLy8gQ29uZmlndXJlZCB0aGUgaW5pdGlhbCBldmVudHMgdGhhdCB0aGUgY29tcG9zaXRlIHZpZXcKICAgIC8vIGJpbmRzIHRvLiBPdmVycmlkZSB0aGlzIG1ldGhvZCB0byBwcmV2ZW50IHRoZSBpbml0aWFsCiAgICAvLyBldmVudHMsIG9yIHRvIGFkZCB5b3VyIG93biBpbml0aWFsIGV2ZW50cy4KICAgIF9pbml0aWFsRXZlbnRzOiBmdW5jdGlvbiAoKSB7CiAgICAgIC8vIEJpbmQgb25seSBhZnRlciBjb21wb3NpdGUgdmlldyBpcyByZW5kZXJlZCB0byBhdm9pZCBhZGRpbmcgY2hpbGQgdmlld3MKICAgICAgLy8gdG8gbm9uZXhpc3RlbnQgY2hpbGRWaWV3Q29udGFpbmVyCiAgICAgIGlmICh0aGlzLmNvbGxlY3Rpb24pIHsKICAgICAgICB0aGlzLmxpc3RlblRvKHRoaXMuY29sbGVjdGlvbiwgJ2FkZCcsIHRoaXMuX29uQ29sbGVjdGlvbkFkZCk7CiAgICAgICAgdGhpcy5saXN0ZW5Ubyh0aGlzLmNvbGxlY3Rpb24sICdyZW1vdmUnLCB0aGlzLl9vbkNvbGxlY3Rpb25SZW1vdmUpOwogICAgICAgIHRoaXMubGlzdGVuVG8odGhpcy5jb2xsZWN0aW9uLCAncmVzZXQnLCB0aGlzLl9yZW5kZXJDaGlsZHJlbik7CiAgICAgICAgaWYgKHRoaXMuc29ydCkgewogICAgICAgICAgdGhpcy5saXN0ZW5Ubyh0aGlzLmNvbGxlY3Rpb24sICdzb3J0JywgdGhpcy5fc29ydFZpZXdzKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICAvLyBSZXRyaWV2ZSB0aGUgYGNoaWxkVmlld2AgdG8gYmUgdXNlZCB3aGVuIHJlbmRlcmluZyBlYWNoIG9mCiAgICAvLyB0aGUgaXRlbXMgaW4gdGhlIGNvbGxlY3Rpb24uIFRoZSBkZWZhdWx0IGlzIHRvIHJldHVybgogICAgLy8gYHRoaXMuY2hpbGRWaWV3YCBvciBNYXJpb25ldHRlLkNvbXBvc2l0ZVZpZXcgaWYgbm8gYGNoaWxkVmlld2AKICAgIC8vIGhhcyBiZWVuIGRlZmluZWQKICAgIGdldENoaWxkVmlldzogZnVuY3Rpb24gKGNoaWxkKSB7CiAgICAgIHZhciBjaGlsZFZpZXcgPSB0aGlzLmdldE9wdGlvbignY2hpbGRWaWV3JykgfHwgdGhpcy5jb25zdHJ1Y3RvcjsKICAgICAgaWYgKCFjaGlsZFZpZXcpIHsKICAgICAgICB0aHJvdyBuZXcgTWFyaW9uZXR0ZS5FcnJvcih7CiAgICAgICAgICBuYW1lOiAnTm9DaGlsZFZpZXdFcnJvcicsCiAgICAgICAgICBtZXNzYWdlOiAnQSAiY2hpbGRWaWV3IiBtdXN0IGJlIHNwZWNpZmllZCcKICAgICAgICB9KTsKICAgICAgfQogICAgICByZXR1cm4gY2hpbGRWaWV3OwogICAgfSwKICAgIC8vIFNlcmlhbGl6ZSB0aGUgY29sbGVjdGlvbiBmb3IgdGhlIHZpZXcuCiAgICAvLyBZb3UgY2FuIG92ZXJyaWRlIHRoZSBgc2VyaWFsaXplRGF0YWAgbWV0aG9kIGluIHlvdXIgb3duIHZpZXcKICAgIC8vIGRlZmluaXRpb24sIHRvIHByb3ZpZGUgY3VzdG9tIHNlcmlhbGl6YXRpb24gZm9yIHlvdXIgdmlldydzIGRhdGEuCiAgICBzZXJpYWxpemVEYXRhOiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBkYXRhID0ge307CiAgICAgIGlmICh0aGlzLm1vZGVsKSB7CiAgICAgICAgZGF0YSA9IF8ucGFydGlhbCh0aGlzLnNlcmlhbGl6ZU1vZGVsLCB0aGlzLm1vZGVsKS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9CiAgICAgIHJldHVybiBkYXRhOwogICAgfSwKICAgIC8vIFJlbmRlcnMgdGhlIG1vZGVsIG9uY2UsIGFuZCB0aGUgY29sbGVjdGlvbiBvbmNlLiBDYWxsaW5nCiAgICAvLyB0aGlzIGFnYWluIHdpbGwgdGVsbCB0aGUgbW9kZWwncyB2aWV3IHRvIHJlLXJlbmRlciBpdHNlbGYKICAgIC8vIGJ1dCB0aGUgY29sbGVjdGlvbiB3aWxsIG5vdCByZS1yZW5kZXIuCiAgICByZW5kZXI6IGZ1bmN0aW9uICgpIHsKICAgICAgdGhpcy5fZW5zdXJlVmlld0lzSW50YWN0KCk7CiAgICAgIHRoaXMuaXNSZW5kZXJlZCA9IHRydWU7CiAgICAgIHRoaXMucmVzZXRDaGlsZFZpZXdDb250YWluZXIoKTsKICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdiZWZvcmU6cmVuZGVyJywgdGhpcyk7CiAgICAgIHRoaXMuX3JlbmRlclRlbXBsYXRlKCk7CiAgICAgIHRoaXMuX3JlbmRlckNoaWxkcmVuKCk7CiAgICAgIHRoaXMudHJpZ2dlck1ldGhvZCgncmVuZGVyJywgdGhpcyk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAgIF9yZW5kZXJDaGlsZHJlbjogZnVuY3Rpb24gKCkgewogICAgICBpZiAodGhpcy5pc1JlbmRlcmVkKSB7CiAgICAgICAgTWFyaW9uZXR0ZS5Db2xsZWN0aW9uVmlldy5wcm90b3R5cGUuX3JlbmRlckNoaWxkcmVuLmNhbGwodGhpcyk7CiAgICAgIH0KICAgIH0sCiAgICAvLyBSZW5kZXIgdGhlIHJvb3QgdGVtcGxhdGUgdGhhdCB0aGUgY2hpbGRyZW4KICAgIC8vIHZpZXdzIGFyZSBhcHBlbmRlZCB0bwogICAgX3JlbmRlclRlbXBsYXRlOiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBkYXRhID0ge307CiAgICAgIGRhdGEgPSB0aGlzLnNlcmlhbGl6ZURhdGEoKTsKICAgICAgZGF0YSA9IHRoaXMubWl4aW5UZW1wbGF0ZUhlbHBlcnMoZGF0YSk7CiAgICAgIHRoaXMudHJpZ2dlck1ldGhvZCgnYmVmb3JlOnJlbmRlcjp0ZW1wbGF0ZScpOwogICAgICB2YXIgdGVtcGxhdGUgPSB0aGlzLmdldFRlbXBsYXRlKCk7CiAgICAgIHZhciBodG1sID0gTWFyaW9uZXR0ZS5SZW5kZXJlci5yZW5kZXIodGVtcGxhdGUsIGRhdGEsIHRoaXMpOwogICAgICB0aGlzLmF0dGFjaEVsQ29udGVudChodG1sKTsKICAgICAgLy8gdGhlIHVpIGJpbmRpbmdzIGlzIGRvbmUgaGVyZSBhbmQgbm90IGF0IHRoZSBlbmQgb2YgcmVuZGVyIHNpbmNlIHRoZXkKICAgICAgLy8gd2lsbCBub3QgYmUgYXZhaWxhYmxlIHVudGlsIGFmdGVyIHRoZSBtb2RlbCBpcyByZW5kZXJlZCwgYnV0IHNob3VsZCBiZQogICAgICAvLyBhdmFpbGFibGUgYmVmb3JlIHRoZSBjb2xsZWN0aW9uIGlzIHJlbmRlcmVkLgogICAgICB0aGlzLmJpbmRVSUVsZW1lbnRzKCk7CiAgICAgIHRoaXMudHJpZ2dlck1ldGhvZCgncmVuZGVyOnRlbXBsYXRlJyk7CiAgICB9LAogICAgLy8gQXR0YWNoZXMgdGhlIGNvbnRlbnQgb2YgdGhlIHJvb3QuCiAgICAvLyBUaGlzIG1ldGhvZCBjYW4gYmUgb3ZlcnJpZGRlbiB0byBvcHRpbWl6ZSByZW5kZXJpbmcsCiAgICAvLyBvciB0byByZW5kZXIgaW4gYSBub24gc3RhbmRhcmQgd2F5LgogICAgLy8KICAgIC8vIEZvciBleGFtcGxlLCB1c2luZyBgaW5uZXJIVE1MYCBpbnN0ZWFkIG9mIGAkZWwuaHRtbGAKICAgIC8vCiAgICAvLyBgYGBqcwogICAgLy8gYXR0YWNoRWxDb250ZW50OiBmdW5jdGlvbihodG1sKSB7CiAgICAvLyAgIHRoaXMuZWwuaW5uZXJIVE1MID0gaHRtbDsKICAgIC8vICAgcmV0dXJuIHRoaXM7CiAgICAvLyB9CiAgICAvLyBgYGAKICAgIGF0dGFjaEVsQ29udGVudDogZnVuY3Rpb24gKGh0bWwpIHsKICAgICAgdGhpcy4kZWwuaHRtbChodG1sKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogICAgLy8gWW91IG1pZ2h0IG5lZWQgdG8gb3ZlcnJpZGUgdGhpcyBpZiB5b3UndmUgb3ZlcnJpZGRlbiBhdHRhY2hIdG1sCiAgICBhdHRhY2hCdWZmZXI6IGZ1bmN0aW9uIChjb21wb3NpdGVWaWV3LCBidWZmZXIpIHsKICAgICAgdmFyICRjb250YWluZXIgPSB0aGlzLmdldENoaWxkVmlld0NvbnRhaW5lcihjb21wb3NpdGVWaWV3KTsKICAgICAgJGNvbnRhaW5lci5hcHBlbmQoYnVmZmVyKTsKICAgIH0sCiAgICAvLyBJbnRlcm5hbCBtZXRob2QuIEFwcGVuZCBhIHZpZXcgdG8gdGhlIGVuZCBvZiB0aGUgJGVsLgogICAgLy8gT3ZlcmlkZGVuIGZyb20gQ29sbGVjdGlvblZpZXcgdG8gZW5zdXJlIHZpZXcgaXMgYXBwZW5kZWQgdG8KICAgIC8vIGNoaWxkVmlld0NvbnRhaW5lcgogICAgX2luc2VydEFmdGVyOiBmdW5jdGlvbiAoY2hpbGRWaWV3KSB7CiAgICAgIHZhciAkY29udGFpbmVyID0gdGhpcy5nZXRDaGlsZFZpZXdDb250YWluZXIodGhpcyk7CiAgICAgICRjb250YWluZXIuYXBwZW5kKGNoaWxkVmlldy5lbCk7CiAgICB9LAogICAgLy8gSW50ZXJuYWwgbWV0aG9kIHRvIGVuc3VyZSBhbiBgJGNoaWxkVmlld0NvbnRhaW5lcmAgZXhpc3RzLCBmb3IgdGhlCiAgICAvLyBgYXR0YWNoSHRtbGAgbWV0aG9kIHRvIHVzZS4KICAgIGdldENoaWxkVmlld0NvbnRhaW5lcjogZnVuY3Rpb24gKGNvbnRhaW5lclZpZXcpIHsKICAgICAgaWYgKCckY2hpbGRWaWV3Q29udGFpbmVyJyBpbiBjb250YWluZXJWaWV3KSB7CiAgICAgICAgcmV0dXJuIGNvbnRhaW5lclZpZXcuJGNoaWxkVmlld0NvbnRhaW5lcjsKICAgICAgfQogICAgICB2YXIgY29udGFpbmVyOwogICAgICB2YXIgY2hpbGRWaWV3Q29udGFpbmVyID0gTWFyaW9uZXR0ZS5nZXRPcHRpb24oY29udGFpbmVyVmlldywgJ2NoaWxkVmlld0NvbnRhaW5lcicpOwogICAgICBpZiAoY2hpbGRWaWV3Q29udGFpbmVyKSB7CiAgICAgICAgdmFyIHNlbGVjdG9yID0gXy5pc0Z1bmN0aW9uKGNoaWxkVmlld0NvbnRhaW5lcikgPyBjaGlsZFZpZXdDb250YWluZXIuY2FsbChjb250YWluZXJWaWV3KSA6IGNoaWxkVmlld0NvbnRhaW5lcjsKICAgICAgICBpZiAoc2VsZWN0b3IuY2hhckF0KDApID09PSAnQCcgJiYgY29udGFpbmVyVmlldy51aSkgewogICAgICAgICAgY29udGFpbmVyID0gY29udGFpbmVyVmlldy51aVtzZWxlY3Rvci5zdWJzdHIoNCldOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjb250YWluZXIgPSBjb250YWluZXJWaWV3LiQoc2VsZWN0b3IpOwogICAgICAgIH0KICAgICAgICBpZiAoY29udGFpbmVyLmxlbmd0aCA8PSAwKSB7CiAgICAgICAgICB0aHJvdyBuZXcgTWFyaW9uZXR0ZS5FcnJvcih7CiAgICAgICAgICAgIG5hbWU6ICdDaGlsZFZpZXdDb250YWluZXJNaXNzaW5nRXJyb3InLAogICAgICAgICAgICBtZXNzYWdlOiAnVGhlIHNwZWNpZmllZCAiY2hpbGRWaWV3Q29udGFpbmVyIiB3YXMgbm90IGZvdW5kOiAnICsgY29udGFpbmVyVmlldy5jaGlsZFZpZXdDb250YWluZXIKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBjb250YWluZXIgPSBjb250YWluZXJWaWV3LiRlbDsKICAgICAgfQogICAgICBjb250YWluZXJWaWV3LiRjaGlsZFZpZXdDb250YWluZXIgPSBjb250YWluZXI7CiAgICAgIHJldHVybiBjb250YWluZXI7CiAgICB9LAogICAgLy8gSW50ZXJuYWwgbWV0aG9kIHRvIHJlc2V0IHRoZSBgJGNoaWxkVmlld0NvbnRhaW5lcmAgb24gcmVuZGVyCiAgICByZXNldENoaWxkVmlld0NvbnRhaW5lcjogZnVuY3Rpb24gKCkgewogICAgICBpZiAodGhpcy4kY2hpbGRWaWV3Q29udGFpbmVyKSB7CiAgICAgICAgZGVsZXRlIHRoaXMuJGNoaWxkVmlld0NvbnRhaW5lcjsKICAgICAgfQogICAgfQogIH0pOwogIC8vIExheW91dFZpZXcKICAvLyAtLS0tLS0tLS0tCiAgLy8gVXNlZCBmb3IgbWFuYWdpbmcgYXBwbGljYXRpb24gbGF5b3V0Vmlld3MsIG5lc3RlZCBsYXlvdXRWaWV3cyBhbmQKICAvLyBtdWx0aXBsZSByZWdpb25zIHdpdGhpbiBhbiBhcHBsaWNhdGlvbiBvciBzdWItYXBwbGljYXRpb24uCiAgLy8KICAvLyBBIHNwZWNpYWxpemVkIHZpZXcgY2xhc3MgdGhhdCByZW5kZXJzIGFuIGFyZWEgb2YgSFRNTCBhbmQgdGhlbgogIC8vIGF0dGFjaGVzIGBSZWdpb25gIGluc3RhbmNlcyB0byB0aGUgc3BlY2lmaWVkIGByZWdpb25zYC4KICAvLyBVc2VkIGZvciBjb21wb3NpdGUgdmlldyBtYW5hZ2VtZW50IGFuZCBzdWItYXBwbGljYXRpb24gYXJlYXMuCiAgTWFyaW9uZXR0ZS5MYXlvdXRWaWV3ID0gTWFyaW9uZXR0ZS5JdGVtVmlldy5leHRlbmQoewogICAgcmVnaW9uQ2xhc3M6IE1hcmlvbmV0dGUuUmVnaW9uLAogICAgLy8gRW5zdXJlIHRoZSByZWdpb25zIGFyZSBhdmFpbGFibGUgd2hlbiB0aGUgYGluaXRpYWxpemVgIG1ldGhvZAogICAgLy8gaXMgY2FsbGVkLgogICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uIChvcHRpb25zKSB7CiAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogICAgICB0aGlzLl9maXJzdFJlbmRlciA9IHRydWU7CiAgICAgIHRoaXMuX2luaXRpYWxpemVSZWdpb25zKG9wdGlvbnMpOwogICAgICBNYXJpb25ldHRlLkl0ZW1WaWV3LmNhbGwodGhpcywgb3B0aW9ucyk7CiAgICB9LAogICAgLy8gTGF5b3V0VmlldydzIHJlbmRlciB3aWxsIHVzZSB0aGUgZXhpc3RpbmcgcmVnaW9uIG9iamVjdHMgdGhlCiAgICAvLyBmaXJzdCB0aW1lIGl0IGlzIGNhbGxlZC4gU3Vic2VxdWVudCBjYWxscyB3aWxsIGRlc3Ryb3kgdGhlCiAgICAvLyB2aWV3cyB0aGF0IHRoZSByZWdpb25zIGFyZSBzaG93aW5nIGFuZCB0aGVuIHJlc2V0IHRoZSBgZWxgCiAgICAvLyBmb3IgdGhlIHJlZ2lvbnMgdG8gdGhlIG5ld2x5IHJlbmRlcmVkIERPTSBlbGVtZW50cy4KICAgIHJlbmRlcjogZnVuY3Rpb24gKCkgewogICAgICB0aGlzLl9lbnN1cmVWaWV3SXNJbnRhY3QoKTsKICAgICAgaWYgKHRoaXMuX2ZpcnN0UmVuZGVyKSB7CiAgICAgICAgLy8gaWYgdGhpcyBpcyB0aGUgZmlyc3QgcmVuZGVyLCBkb24ndCBkbyBhbnl0aGluZyB0bwogICAgICAgIC8vIHJlc2V0IHRoZSByZWdpb25zCiAgICAgICAgdGhpcy5fZmlyc3RSZW5kZXIgPSBmYWxzZTsKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBJZiB0aGlzIGlzIG5vdCB0aGUgZmlyc3QgcmVuZGVyIGNhbGwsIHRoZW4gd2UgbmVlZCB0bwogICAgICAgIC8vIHJlLWluaXRpYWxpemUgdGhlIGBlbGAgZm9yIGVhY2ggcmVnaW9uCiAgICAgICAgdGhpcy5fcmVJbml0aWFsaXplUmVnaW9ucygpOwogICAgICB9CiAgICAgIHJldHVybiBNYXJpb25ldHRlLkl0ZW1WaWV3LnByb3RvdHlwZS5yZW5kZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH0sCiAgICAvLyBIYW5kbGUgZGVzdHJveWluZyByZWdpb25zLCBhbmQgdGhlbiBkZXN0cm95IHRoZSB2aWV3IGl0c2VsZi4KICAgIGRlc3Ryb3k6IGZ1bmN0aW9uICgpIHsKICAgICAgaWYgKHRoaXMuaXNEZXN0cm95ZWQpIHsKICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfQogICAgICB0aGlzLnJlZ2lvbk1hbmFnZXIuZGVzdHJveSgpOwogICAgICByZXR1cm4gTWFyaW9uZXR0ZS5JdGVtVmlldy5wcm90b3R5cGUuZGVzdHJveS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfSwKICAgIC8vIEFkZCBhIHNpbmdsZSByZWdpb24sIGJ5IG5hbWUsIHRvIHRoZSBsYXlvdXRWaWV3CiAgICBhZGRSZWdpb246IGZ1bmN0aW9uIChuYW1lLCBkZWZpbml0aW9uKSB7CiAgICAgIHRoaXMudHJpZ2dlck1ldGhvZCgnYmVmb3JlOnJlZ2lvbjphZGQnLCBuYW1lKTsKICAgICAgdmFyIHJlZ2lvbnMgPSB7fTsKICAgICAgcmVnaW9uc1tuYW1lXSA9IGRlZmluaXRpb247CiAgICAgIHJldHVybiB0aGlzLl9idWlsZFJlZ2lvbnMocmVnaW9ucylbbmFtZV07CiAgICB9LAogICAgLy8gQWRkIG11bHRpcGxlIHJlZ2lvbnMgYXMgYSB7bmFtZTogZGVmaW5pdGlvbiwgbmFtZTI6IGRlZjJ9IG9iamVjdCBsaXRlcmFsCiAgICBhZGRSZWdpb25zOiBmdW5jdGlvbiAocmVnaW9ucykgewogICAgICB0aGlzLnJlZ2lvbnMgPSBfLmV4dGVuZCh7fSwgdGhpcy5yZWdpb25zLCByZWdpb25zKTsKICAgICAgcmV0dXJuIHRoaXMuX2J1aWxkUmVnaW9ucyhyZWdpb25zKTsKICAgIH0sCiAgICAvLyBSZW1vdmUgYSBzaW5nbGUgcmVnaW9uIGZyb20gdGhlIExheW91dFZpZXcsIGJ5IG5hbWUKICAgIHJlbW92ZVJlZ2lvbjogZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdiZWZvcmU6cmVnaW9uOnJlbW92ZScsIG5hbWUpOwogICAgICBkZWxldGUgdGhpcy5yZWdpb25zW25hbWVdOwogICAgICByZXR1cm4gdGhpcy5yZWdpb25NYW5hZ2VyLnJlbW92ZVJlZ2lvbihuYW1lKTsKICAgIH0sCiAgICAvLyBQcm92aWRlcyBhbHRlcm5hdGl2ZSBhY2Nlc3MgdG8gcmVnaW9ucwogICAgLy8gQWNjZXB0cyB0aGUgcmVnaW9uIG5hbWUKICAgIC8vIGdldFJlZ2lvbignbWFpbicpCiAgICBnZXRSZWdpb246IGZ1bmN0aW9uIChyZWdpb24pIHsKICAgICAgcmV0dXJuIHRoaXMucmVnaW9uTWFuYWdlci5nZXQocmVnaW9uKTsKICAgIH0sCiAgICAvLyBHZXQgYWxsIHJlZ2lvbnMKICAgIGdldFJlZ2lvbnM6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIHRoaXMucmVnaW9uTWFuYWdlci5nZXRSZWdpb25zKCk7CiAgICB9LAogICAgLy8gaW50ZXJuYWwgbWV0aG9kIHRvIGJ1aWxkIHJlZ2lvbnMKICAgIF9idWlsZFJlZ2lvbnM6IGZ1bmN0aW9uIChyZWdpb25zKSB7CiAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgdmFyIGRlZmF1bHRzID0gewogICAgICAgIHJlZ2lvbkNsYXNzOiB0aGlzLmdldE9wdGlvbigncmVnaW9uQ2xhc3MnKSwKICAgICAgICBwYXJlbnRFbDogZnVuY3Rpb24gKCkgewogICAgICAgICAgcmV0dXJuIHRoYXQuJGVsOwogICAgICAgIH0KICAgICAgfTsKICAgICAgcmV0dXJuIHRoaXMucmVnaW9uTWFuYWdlci5hZGRSZWdpb25zKHJlZ2lvbnMsIGRlZmF1bHRzKTsKICAgIH0sCiAgICAvLyBJbnRlcm5hbCBtZXRob2QgdG8gaW5pdGlhbGl6ZSB0aGUgcmVnaW9ucyB0aGF0IGhhdmUgYmVlbiBkZWZpbmVkIGluIGEKICAgIC8vIGByZWdpb25zYCBhdHRyaWJ1dGUgb24gdGhpcyBsYXlvdXRWaWV3LgogICAgX2luaXRpYWxpemVSZWdpb25zOiBmdW5jdGlvbiAob3B0aW9ucykgewogICAgICB2YXIgcmVnaW9uczsKICAgICAgdGhpcy5faW5pdFJlZ2lvbk1hbmFnZXIoKTsKICAgICAgaWYgKF8uaXNGdW5jdGlvbih0aGlzLnJlZ2lvbnMpKSB7CiAgICAgICAgcmVnaW9ucyA9IHRoaXMucmVnaW9ucyhvcHRpb25zKTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZWdpb25zID0gdGhpcy5yZWdpb25zIHx8IHt9OwogICAgICB9CiAgICAgIC8vIEVuYWJsZSB1c2VycyB0byBkZWZpbmUgYHJlZ2lvbnNgIGFzIGluc3RhbmNlIG9wdGlvbnMuCiAgICAgIHZhciByZWdpb25PcHRpb25zID0gdGhpcy5nZXRPcHRpb24uY2FsbChvcHRpb25zLCAncmVnaW9ucycpOwogICAgICAvLyBlbmFibGUgcmVnaW9uIG9wdGlvbnMgdG8gYmUgYSBmdW5jdGlvbgogICAgICBpZiAoXy5pc0Z1bmN0aW9uKHJlZ2lvbk9wdGlvbnMpKSB7CiAgICAgICAgcmVnaW9uT3B0aW9ucyA9IHJlZ2lvbk9wdGlvbnMuY2FsbCh0aGlzLCBvcHRpb25zKTsKICAgICAgfQogICAgICBfLmV4dGVuZChyZWdpb25zLCByZWdpb25PcHRpb25zKTsKICAgICAgLy8gTm9ybWFsaXplIHJlZ2lvbiBzZWxlY3RvcnMgaGFzaCB0byBhbGxvdwogICAgICAvLyBhIHVzZXIgdG8gdXNlIHRoZSBAdWkuIHN5bnRheC4KICAgICAgcmVnaW9ucyA9IHRoaXMubm9ybWFsaXplVUlWYWx1ZXMocmVnaW9ucyk7CiAgICAgIHRoaXMuYWRkUmVnaW9ucyhyZWdpb25zKTsKICAgIH0sCiAgICAvLyBJbnRlcm5hbCBtZXRob2QgdG8gcmUtaW5pdGlhbGl6ZSBhbGwgb2YgdGhlIHJlZ2lvbnMgYnkgdXBkYXRpbmcgdGhlIGBlbGAgdGhhdAogICAgLy8gdGhleSBwb2ludCB0bwogICAgX3JlSW5pdGlhbGl6ZVJlZ2lvbnM6IGZ1bmN0aW9uICgpIHsKICAgICAgdGhpcy5yZWdpb25NYW5hZ2VyLmVtcHR5UmVnaW9ucygpOwogICAgICB0aGlzLnJlZ2lvbk1hbmFnZXIuZWFjaChmdW5jdGlvbiAocmVnaW9uKSB7CiAgICAgICAgcmVnaW9uLnJlc2V0KCk7CiAgICAgIH0pOwogICAgfSwKICAgIC8vIEVuYWJsZSBlYXN5IG92ZXJyaWRpbmcgb2YgdGhlIGRlZmF1bHQgYFJlZ2lvbk1hbmFnZXJgCiAgICAvLyBmb3IgY3VzdG9taXplZCByZWdpb24gaW50ZXJhY3Rpb25zIGFuZCBidXNpbmVzcyBzcGVjaWZpYwogICAgLy8gdmlldyBsb2dpYyBmb3IgYmV0dGVyIGNvbnRyb2wgb3ZlciBzaW5nbGUgcmVnaW9ucy4KICAgIGdldFJlZ2lvbk1hbmFnZXI6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIG5ldyBNYXJpb25ldHRlLlJlZ2lvbk1hbmFnZXIoKTsKICAgIH0sCiAgICAvLyBJbnRlcm5hbCBtZXRob2QgdG8gaW5pdGlhbGl6ZSB0aGUgcmVnaW9uIG1hbmFnZXIKICAgIC8vIGFuZCBhbGwgcmVnaW9ucyBpbiBpdAogICAgX2luaXRSZWdpb25NYW5hZ2VyOiBmdW5jdGlvbiAoKSB7CiAgICAgIHRoaXMucmVnaW9uTWFuYWdlciA9IHRoaXMuZ2V0UmVnaW9uTWFuYWdlcigpOwogICAgICB0aGlzLmxpc3RlblRvKHRoaXMucmVnaW9uTWFuYWdlciwgJ2JlZm9yZTphZGQ6cmVnaW9uJywgZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICB0aGlzLnRyaWdnZXJNZXRob2QoJ2JlZm9yZTphZGQ6cmVnaW9uJywgbmFtZSk7CiAgICAgIH0pOwogICAgICB0aGlzLmxpc3RlblRvKHRoaXMucmVnaW9uTWFuYWdlciwgJ2FkZDpyZWdpb24nLCBmdW5jdGlvbiAobmFtZSwgcmVnaW9uKSB7CiAgICAgICAgdGhpc1tuYW1lXSA9IHJlZ2lvbjsKICAgICAgICB0aGlzLnRyaWdnZXJNZXRob2QoJ2FkZDpyZWdpb24nLCBuYW1lLCByZWdpb24pOwogICAgICB9KTsKICAgICAgdGhpcy5saXN0ZW5Ubyh0aGlzLnJlZ2lvbk1hbmFnZXIsICdiZWZvcmU6cmVtb3ZlOnJlZ2lvbicsIGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdiZWZvcmU6cmVtb3ZlOnJlZ2lvbicsIG5hbWUpOwogICAgICB9KTsKICAgICAgdGhpcy5saXN0ZW5Ubyh0aGlzLnJlZ2lvbk1hbmFnZXIsICdyZW1vdmU6cmVnaW9uJywgZnVuY3Rpb24gKG5hbWUsIHJlZ2lvbikgewogICAgICAgIGRlbGV0ZSB0aGlzW25hbWVdOwogICAgICAgIHRoaXMudHJpZ2dlck1ldGhvZCgncmVtb3ZlOnJlZ2lvbicsIG5hbWUsIHJlZ2lvbik7CiAgICAgIH0pOwogICAgfQogIH0pOwogIC8vIEJlaGF2aW9yCiAgLy8gLS0tLS0tLS0tLS0KICAvLyBBIEJlaGF2aW9yIGlzIGFuIGlzb2xhdGVkIHNldCBvZiBET00gLwogIC8vIHVzZXIgaW50ZXJhY3Rpb25zIHRoYXQgY2FuIGJlIG1peGVkIGludG8gYW55IFZpZXcuCiAgLy8gQmVoYXZpb3JzIGFsbG93IHlvdSB0byBibGFja2JveCBWaWV3IHNwZWNpZmljIGludGVyYWN0aW9ucwogIC8vIGludG8gcG9ydGFibGUgbG9naWNhbCBjaHVua3MsIGtlZXBpbmcgeW91ciB2aWV3cyBzaW1wbGUgYW5kIHlvdXIgY29kZSBEUlkuCiAgTWFyaW9uZXR0ZS5CZWhhdmlvciA9IGZ1bmN0aW9uIChfLCBCYWNrYm9uZSkgewogICAgZnVuY3Rpb24gQmVoYXZpb3Iob3B0aW9ucywgdmlldykgewogICAgICAvLyBTZXR1cCByZWZlcmVuY2UgdG8gdGhlIHZpZXcuCiAgICAgIC8vIHRoaXMgY29tZXMgaW4gaGFuZGxlIHdoZW4gYSBiZWhhdmlvcgogICAgICAvLyB3YW50cyB0byBkaXJlY3RseSB0YWxrIHVwIHRoZSBjaGFpbgogICAgICAvLyB0byB0aGUgdmlldy4KICAgICAgdGhpcy52aWV3ID0gdmlldzsKICAgICAgdGhpcy5kZWZhdWx0cyA9IF8ucmVzdWx0KHRoaXMsICdkZWZhdWx0cycpIHx8IHt9OwogICAgICB0aGlzLm9wdGlvbnMgPSBfLmV4dGVuZCh7fSwgdGhpcy5kZWZhdWx0cywgb3B0aW9ucyk7CiAgICAgIC8vIHByb3h5IGJlaGF2aW9yICQgbWV0aG9kIHRvIHRoZSB2aWV3CiAgICAgIC8vIHRoaXMgaXMgdXNlZnVsIGZvciBkb2luZyBqcXVlcnkgRE9NIGxvb2t1cHMKICAgICAgLy8gc2NvcGVkIHRvIGJlaGF2aW9ycyB2aWV3LgogICAgICB0aGlzLiQgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMudmlldy4kLmFwcGx5KHRoaXMudmlldywgYXJndW1lbnRzKTsKICAgICAgfTsKICAgICAgLy8gQ2FsbCB0aGUgaW5pdGlhbGl6ZSBtZXRob2QgcGFzc2luZwogICAgICAvLyB0aGUgYXJndW1lbnRzIGZyb20gdGhlIGluc3RhbmNlIGNvbnN0cnVjdG9yCiAgICAgIHRoaXMuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfQogICAgXy5leHRlbmQoQmVoYXZpb3IucHJvdG90eXBlLCBCYWNrYm9uZS5FdmVudHMsIHsKICAgICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24gKCkgewogICAgICB9LAogICAgICAvLyBzdG9wTGlzdGVuaW5nIHRvIGJlaGF2aW9yIGBvbkxpc3RlbmAgZXZlbnRzLgogICAgICBkZXN0cm95OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgdGhpcy5zdG9wTGlzdGVuaW5nKCk7CiAgICAgIH0sCiAgICAgIHByb3h5Vmlld1Byb3BlcnRpZXM6IGZ1bmN0aW9uICh2aWV3KSB7CiAgICAgICAgdGhpcy4kZWwgPSB2aWV3LiRlbDsKICAgICAgICB0aGlzLmVsID0gdmlldy5lbDsKICAgICAgfSwKICAgICAgLy8gaW1wb3J0IHRoZSBgdHJpZ2dlck1ldGhvZGAgdG8gdHJpZ2dlciBldmVudHMgd2l0aCBjb3JyZXNwb25kaW5nCiAgICAgIC8vIG1ldGhvZHMgaWYgdGhlIG1ldGhvZCBleGlzdHMKICAgICAgdHJpZ2dlck1ldGhvZDogTWFyaW9uZXR0ZS50cmlnZ2VyTWV0aG9kLAogICAgICAvLyBQcm94eSBgZ2V0T3B0aW9uYCB0byBlbmFibGUgZ2V0dGluZyBvcHRpb25zIGZyb20gdGhpcyBvciB0aGlzLm9wdGlvbnMgYnkgbmFtZS4KICAgICAgZ2V0T3B0aW9uOiBNYXJpb25ldHRlLnByb3h5R2V0T3B0aW9uLAogICAgICAvLyBQcm94eSBgdW5iaW5kRW50aXR5RXZlbnRzYCB0byBlbmFibGUgYmluZGluZyB2aWV3J3MgZXZlbnRzIGZyb20gYW5vdGhlciBlbnRpdHkuCiAgICAgIGJpbmRFbnRpdHlFdmVudHM6IE1hcmlvbmV0dGUucHJveHlCaW5kRW50aXR5RXZlbnRzLAogICAgICAvLyBQcm94eSBgdW5iaW5kRW50aXR5RXZlbnRzYCB0byBlbmFibGUgdW5iaW5kaW5nIHZpZXcncyBldmVudHMgZnJvbSBhbm90aGVyIGVudGl0eS4KICAgICAgdW5iaW5kRW50aXR5RXZlbnRzOiBNYXJpb25ldHRlLnByb3h5VW5iaW5kRW50aXR5RXZlbnRzCiAgICB9KTsKICAgIC8vIEJvcnJvdyBCYWNrYm9uZXMgZXh0ZW5kIGltcGxlbWVudGF0aW9uCiAgICAvLyB0aGlzIGFsbG93cyB1cyB0byBzZXR1cCBhIHByb3BlcgogICAgLy8gaW5oZXJpdGFuY2UgcGF0dGVybiB0aGF0IGZvbGxvd3Mgc3VpdAogICAgLy8gd2l0aCB0aGUgcmVzdCBvZiBNYXJpb25ldHRlIHZpZXdzLgogICAgQmVoYXZpb3IuZXh0ZW5kID0gTWFyaW9uZXR0ZS5leHRlbmQ7CiAgICByZXR1cm4gQmVoYXZpb3I7CiAgfShfLCBCYWNrYm9uZSk7CiAgLyoganNoaW50IG1heGxlbjogMTQzICovCiAgLy8gTWFyaW9uZXR0ZS5CZWhhdmlvcnMKICAvLyAtLS0tLS0tLQogIC8vIEJlaGF2aW9ycyBpcyBhIHV0aWxpdHkgY2xhc3MgdGhhdCB0YWtlcyBjYXJlIG9mCiAgLy8gZ2x1aW5nIHlvdXIgYmVoYXZpb3IgaW5zdGFuY2VzIHRvIHRoZWlyIGdpdmVuIFZpZXcuCiAgLy8gVGhlIG1vc3QgaW1wb3J0YW50IHBhcnQgb2YgdGhpcyBjbGFzcyBpcyB0aGF0IHlvdQogIC8vICoqTVVTVCoqIG92ZXJyaWRlIHRoZSBjbGFzcyBsZXZlbCBiZWhhdmlvcnNMb29rdXAKICAvLyBtZXRob2QgZm9yIHRoaW5ncyB0byB3b3JrIHByb3Blcmx5LgogIE1hcmlvbmV0dGUuQmVoYXZpb3JzID0gZnVuY3Rpb24gKE1hcmlvbmV0dGUsIF8pIHsKICAgIGZ1bmN0aW9uIEJlaGF2aW9ycyh2aWV3LCBiZWhhdmlvcnMpIHsKICAgICAgaWYgKCFfLmlzT2JqZWN0KHZpZXcuYmVoYXZpb3JzKSkgewogICAgICAgIHJldHVybiB7fTsKICAgICAgfQogICAgICAvLyBCZWhhdmlvcnMgZGVmaW5lZCBvbiBhIHZpZXcgY2FuIGJlIGEgZmxhdCBvYmplY3QgbGl0ZXJhbAogICAgICAvLyBvciBpdCBjYW4gYmUgYSBmdW5jdGlvbiB0aGF0IHJldHVybnMgYW4gb2JqZWN0LgogICAgICBiZWhhdmlvcnMgPSBCZWhhdmlvcnMucGFyc2VCZWhhdmlvcnModmlldywgYmVoYXZpb3JzIHx8IF8ucmVzdWx0KHZpZXcsICdiZWhhdmlvcnMnKSk7CiAgICAgIC8vIFdyYXBzIHNldmVyYWwgb2YgdGhlIHZpZXcncyBtZXRob2RzCiAgICAgIC8vIGNhbGxpbmcgdGhlIG1ldGhvZHMgZmlyc3Qgb24gZWFjaCBiZWhhdmlvcgogICAgICAvLyBhbmQgdGhlbiBldmVudHVhbGx5IGNhbGxpbmcgdGhlIG1ldGhvZCBvbiB0aGUgdmlldy4KICAgICAgQmVoYXZpb3JzLndyYXAodmlldywgYmVoYXZpb3JzLCBfLmtleXMobWV0aG9kcykpOwogICAgICByZXR1cm4gYmVoYXZpb3JzOwogICAgfQogICAgdmFyIG1ldGhvZHMgPSB7CiAgICAgIGJlaGF2aW9yVHJpZ2dlcnM6IGZ1bmN0aW9uIChiZWhhdmlvclRyaWdnZXJzLCBiZWhhdmlvcnMpIHsKICAgICAgICB2YXIgdHJpZ2dlckJ1aWxkZXIgPSBuZXcgQmVoYXZpb3JUcmlnZ2Vyc0J1aWxkZXIodGhpcywgYmVoYXZpb3JzKTsKICAgICAgICByZXR1cm4gdHJpZ2dlckJ1aWxkZXIuYnVpbGRCZWhhdmlvclRyaWdnZXJzKCk7CiAgICAgIH0sCiAgICAgIGJlaGF2aW9yRXZlbnRzOiBmdW5jdGlvbiAoYmVoYXZpb3JFdmVudHMsIGJlaGF2aW9ycykgewogICAgICAgIHZhciBfYmVoYXZpb3JzRXZlbnRzID0ge307CiAgICAgICAgdmFyIHZpZXdVSSA9IF8ucmVzdWx0KHRoaXMsICd1aScpOwogICAgICAgIF8uZWFjaChiZWhhdmlvcnMsIGZ1bmN0aW9uIChiLCBpKSB7CiAgICAgICAgICB2YXIgX2V2ZW50cyA9IHt9OwogICAgICAgICAgdmFyIGJlaGF2aW9yRXZlbnRzID0gXy5jbG9uZShfLnJlc3VsdChiLCAnZXZlbnRzJykpIHx8IHt9OwogICAgICAgICAgdmFyIGJlaGF2aW9yVUkgPSBfLnJlc3VsdChiLCAndWknKTsKICAgICAgICAgIC8vIENvbnN0cnVjdCBhbiBpbnRlcm5hbCBVSSBoYXNoIGZpcnN0IHVzaW5nCiAgICAgICAgICAvLyB0aGUgdmlld3MgVUkgaGFzaCBhbmQgdGhlbiB0aGUgYmVoYXZpb3JzIFVJIGhhc2guCiAgICAgICAgICAvLyBUaGlzIGFsbG93cyB0aGUgdXNlciB0byB1c2UgVUkgaGFzaCBlbGVtZW50cwogICAgICAgICAgLy8gZGVmaW5lZCBpbiB0aGUgcGFyZW50IHZpZXcgYXMgd2VsbCBhcyB0aG9zZQogICAgICAgICAgLy8gZGVmaW5lZCBpbiB0aGUgZ2l2ZW4gYmVoYXZpb3IuCiAgICAgICAgICB2YXIgdWkgPSBfLmV4dGVuZCh7fSwgdmlld1VJLCBiZWhhdmlvclVJKTsKICAgICAgICAgIC8vIE5vcm1hbGl6ZSBiZWhhdmlvciBldmVudHMgaGFzaCB0byBhbGxvdwogICAgICAgICAgLy8gYSB1c2VyIHRvIHVzZSB0aGUgQHVpLiBzeW50YXguCiAgICAgICAgICBiZWhhdmlvckV2ZW50cyA9IE1hcmlvbmV0dGUubm9ybWFsaXplVUlLZXlzKGJlaGF2aW9yRXZlbnRzLCB1aSk7CiAgICAgICAgICBfLmVhY2goXy5rZXlzKGJlaGF2aW9yRXZlbnRzKSwgZnVuY3Rpb24gKGtleSkgewogICAgICAgICAgICAvLyBBcHBlbmQgd2hpdGUtc3BhY2UgYXQgdGhlIGVuZCBvZiBlYWNoIGtleSB0byBwcmV2ZW50IGJlaGF2aW9yIGtleSBjb2xsaXNpb25zLgogICAgICAgICAgICAvLyBUaGlzIGlzIHJlbHlpbmcgb24gdGhlIGZhY3QgdGhhdCBiYWNrYm9uZSBldmVudHMgY29uc2lkZXJzICJjbGljayAuZm9vIiB0aGUgc2FtZSBhcwogICAgICAgICAgICAvLyAiY2xpY2sgLmZvbyAiLgogICAgICAgICAgICAvLyArMiBpcyB1c2VkIGJlY2F1c2UgbmV3IEFycmF5KDEpIG9yIDAgaXMgIiIgYW5kIG5vdCAiICIKICAgICAgICAgICAgdmFyIHdoaXRlc3BhY2UgPSBuZXcgQXJyYXkoaSArIDIpLmpvaW4oJyAnKTsKICAgICAgICAgICAgdmFyIGV2ZW50S2V5ID0ga2V5ICsgd2hpdGVzcGFjZTsKICAgICAgICAgICAgdmFyIGhhbmRsZXIgPSBfLmlzRnVuY3Rpb24oYmVoYXZpb3JFdmVudHNba2V5XSkgPyBiZWhhdmlvckV2ZW50c1trZXldIDogYltiZWhhdmlvckV2ZW50c1trZXldXTsKICAgICAgICAgICAgX2V2ZW50c1tldmVudEtleV0gPSBfLmJpbmQoaGFuZGxlciwgYik7CiAgICAgICAgICB9KTsKICAgICAgICAgIF9iZWhhdmlvcnNFdmVudHMgPSBfLmV4dGVuZChfYmVoYXZpb3JzRXZlbnRzLCBfZXZlbnRzKTsKICAgICAgICB9KTsKICAgICAgICByZXR1cm4gX2JlaGF2aW9yc0V2ZW50czsKICAgICAgfQogICAgfTsKICAgIF8uZXh0ZW5kKEJlaGF2aW9ycywgewogICAgICAvLyBQbGFjZWhvbGRlciBtZXRob2QgdG8gYmUgZXh0ZW5kZWQgYnkgdGhlIHVzZXIuCiAgICAgIC8vIFRoZSBtZXRob2Qgc2hvdWxkIGRlZmluZSB0aGUgb2JqZWN0IHRoYXQgc3RvcmVzIHRoZSBiZWhhdmlvcnMuCiAgICAgIC8vIGkuZS4KICAgICAgLy8KICAgICAgLy8gYGBganMKICAgICAgLy8gTWFyaW9uZXR0ZS5CZWhhdmlvcnMuYmVoYXZpb3JzTG9va3VwOiBmdW5jdGlvbigpIHsKICAgICAgLy8gICByZXR1cm4gQXBwLkJlaGF2aW9ycwogICAgICAvLyB9CiAgICAgIC8vIGBgYAogICAgICBiZWhhdmlvcnNMb29rdXA6IGZ1bmN0aW9uICgpIHsKICAgICAgICB0aHJvdyBuZXcgTWFyaW9uZXR0ZS5FcnJvcih7CiAgICAgICAgICBtZXNzYWdlOiAnWW91IG11c3QgZGVmaW5lIHdoZXJlIHlvdXIgYmVoYXZpb3JzIGFyZSBzdG9yZWQuJywKICAgICAgICAgIHVybDogJ21hcmlvbmV0dGUuYmVoYXZpb3JzLmh0bWwjYmVoYXZpb3JzbG9va3VwJwogICAgICAgIH0pOwogICAgICB9LAogICAgICAvLyBUYWtlcyBjYXJlIG9mIGdldHRpbmcgdGhlIGJlaGF2aW9yIGNsYXNzCiAgICAgIC8vIGdpdmVuIG9wdGlvbnMgYW5kIGEga2V5LgogICAgICAvLyBJZiBhIHVzZXIgcGFzc2VzIGluIG9wdGlvbnMuYmVoYXZpb3JDbGFzcwogICAgICAvLyBkZWZhdWx0IHRvIHVzaW5nIHRoYXQuIE90aGVyd2lzZSBkZWxlZ2F0ZQogICAgICAvLyB0aGUgbG9va3VwIHRvIHRoZSB1c2VycyBgYmVoYXZpb3JzTG9va3VwYCBpbXBsZW1lbnRhdGlvbi4KICAgICAgZ2V0QmVoYXZpb3JDbGFzczogZnVuY3Rpb24gKG9wdGlvbnMsIGtleSkgewogICAgICAgIGlmIChvcHRpb25zLmJlaGF2aW9yQ2xhc3MpIHsKICAgICAgICAgIHJldHVybiBvcHRpb25zLmJlaGF2aW9yQ2xhc3M7CiAgICAgICAgfQogICAgICAgIC8vIEdldCBiZWhhdmlvciBjbGFzcyBjYW4gYmUgZWl0aGVyIGEgZmxhdCBvYmplY3Qgb3IgYSBtZXRob2QKICAgICAgICByZXR1cm4gXy5pc0Z1bmN0aW9uKEJlaGF2aW9ycy5iZWhhdmlvcnNMb29rdXApID8gQmVoYXZpb3JzLmJlaGF2aW9yc0xvb2t1cC5hcHBseSh0aGlzLCBhcmd1bWVudHMpW2tleV0gOiBCZWhhdmlvcnMuYmVoYXZpb3JzTG9va3VwW2tleV07CiAgICAgIH0sCiAgICAgIC8vIEl0ZXJhdGUgb3ZlciB0aGUgYmVoYXZpb3JzIG9iamVjdCwgZm9yIGVhY2ggYmVoYXZpb3IKICAgICAgLy8gaW5zdGFudGlhdGUgaXQgYW5kIGdldCBpdHMgZ3JvdXBlZCBiZWhhdmlvcnMuCiAgICAgIHBhcnNlQmVoYXZpb3JzOiBmdW5jdGlvbiAodmlldywgYmVoYXZpb3JzKSB7CiAgICAgICAgcmV0dXJuIF8uY2hhaW4oYmVoYXZpb3JzKS5tYXAoZnVuY3Rpb24gKG9wdGlvbnMsIGtleSkgewogICAgICAgICAgdmFyIEJlaGF2aW9yQ2xhc3MgPSBCZWhhdmlvcnMuZ2V0QmVoYXZpb3JDbGFzcyhvcHRpb25zLCBrZXkpOwogICAgICAgICAgdmFyIGJlaGF2aW9yID0gbmV3IEJlaGF2aW9yQ2xhc3Mob3B0aW9ucywgdmlldyk7CiAgICAgICAgICB2YXIgbmVzdGVkQmVoYXZpb3JzID0gQmVoYXZpb3JzLnBhcnNlQmVoYXZpb3JzKHZpZXcsIF8ucmVzdWx0KGJlaGF2aW9yLCAnYmVoYXZpb3JzJykpOwogICAgICAgICAgcmV0dXJuIFtiZWhhdmlvcl0uY29uY2F0KG5lc3RlZEJlaGF2aW9ycyk7CiAgICAgICAgfSkuZmxhdHRlbigpLnZhbHVlKCk7CiAgICAgIH0sCiAgICAgIC8vIFdyYXAgdmlldyBpbnRlcm5hbCBtZXRob2RzIHNvIHRoYXQgdGhleSBkZWxlZ2F0ZSB0byBiZWhhdmlvcnMuIEZvciBleGFtcGxlLAogICAgICAvLyBgb25EZXN0cm95YCBzaG91bGQgdHJpZ2dlciBkZXN0cm95IG9uIGFsbCBvZiB0aGUgYmVoYXZpb3JzIGFuZCB0aGVuIGRlc3Ryb3kgaXRzZWxmLgogICAgICAvLyBpLmUuCiAgICAgIC8vCiAgICAgIC8vIGB2aWV3LmRlbGVnYXRlRXZlbnRzID0gXy5wYXJ0aWFsKG1ldGhvZHMuZGVsZWdhdGVFdmVudHMsIHZpZXcuZGVsZWdhdGVFdmVudHMsIGJlaGF2aW9ycyk7YAogICAgICB3cmFwOiBmdW5jdGlvbiAodmlldywgYmVoYXZpb3JzLCBtZXRob2ROYW1lcykgewogICAgICAgIF8uZWFjaChtZXRob2ROYW1lcywgZnVuY3Rpb24gKG1ldGhvZE5hbWUpIHsKICAgICAgICAgIHZpZXdbbWV0aG9kTmFtZV0gPSBfLnBhcnRpYWwobWV0aG9kc1ttZXRob2ROYW1lXSwgdmlld1ttZXRob2ROYW1lXSwgYmVoYXZpb3JzKTsKICAgICAgICB9KTsKICAgICAgfQogICAgfSk7CiAgICAvLyBDbGFzcyB0byBidWlsZCBoYW5kbGVycyBmb3IgYHRyaWdnZXJzYCBvbiBiZWhhdmlvcnMKICAgIC8vIGZvciB2aWV3cwogICAgZnVuY3Rpb24gQmVoYXZpb3JUcmlnZ2Vyc0J1aWxkZXIodmlldywgYmVoYXZpb3JzKSB7CiAgICAgIHRoaXMuX3ZpZXcgPSB2aWV3OwogICAgICB0aGlzLl92aWV3VUkgPSBfLnJlc3VsdCh2aWV3LCAndWknKTsKICAgICAgdGhpcy5fYmVoYXZpb3JzID0gYmVoYXZpb3JzOwogICAgICB0aGlzLl90cmlnZ2VycyA9IHt9OwogICAgfQogICAgXy5leHRlbmQoQmVoYXZpb3JUcmlnZ2Vyc0J1aWxkZXIucHJvdG90eXBlLCB7CiAgICAgIC8vIE1haW4gbWV0aG9kIHRvIGJ1aWxkIHRoZSB0cmlnZ2VycyBoYXNoIHdpdGggZXZlbnQga2V5cyBhbmQgaGFuZGxlcnMKICAgICAgYnVpbGRCZWhhdmlvclRyaWdnZXJzOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgXy5lYWNoKHRoaXMuX2JlaGF2aW9ycywgdGhpcy5fYnVpbGRUcmlnZ2VySGFuZGxlcnNGb3JCZWhhdmlvciwgdGhpcyk7CiAgICAgICAgcmV0dXJuIHRoaXMuX3RyaWdnZXJzOwogICAgICB9LAogICAgICAvLyBJbnRlcm5hbCBtZXRob2QgdG8gYnVpbGQgYWxsIHRyaWdnZXIgaGFuZGxlcnMgZm9yIGEgZ2l2ZW4gYmVoYXZpb3IKICAgICAgX2J1aWxkVHJpZ2dlckhhbmRsZXJzRm9yQmVoYXZpb3I6IGZ1bmN0aW9uIChiZWhhdmlvciwgaSkgewogICAgICAgIHZhciB1aSA9IF8uZXh0ZW5kKHt9LCB0aGlzLl92aWV3VUksIF8ucmVzdWx0KGJlaGF2aW9yLCAndWknKSk7CiAgICAgICAgdmFyIHRyaWdnZXJzSGFzaCA9IF8uY2xvbmUoXy5yZXN1bHQoYmVoYXZpb3IsICd0cmlnZ2VycycpKSB8fCB7fTsKICAgICAgICB0cmlnZ2Vyc0hhc2ggPSBNYXJpb25ldHRlLm5vcm1hbGl6ZVVJS2V5cyh0cmlnZ2Vyc0hhc2gsIHVpKTsKICAgICAgICBfLmVhY2godHJpZ2dlcnNIYXNoLCBfLnBhcnRpYWwodGhpcy5fc2V0SGFuZGxlckZvckJlaGF2aW9yLCBiZWhhdmlvciwgaSksIHRoaXMpOwogICAgICB9LAogICAgICAvLyBJbnRlcm5hbCBtZXRob2QgdG8gY3JlYXRlIGFuZCBhc3NpZ24gdGhlIHRyaWdnZXIgaGFuZGxlciBmb3IgYSBnaXZlbgogICAgICAvLyBiZWhhdmlvcgogICAgICBfc2V0SGFuZGxlckZvckJlaGF2aW9yOiBmdW5jdGlvbiAoYmVoYXZpb3IsIGksIGV2ZW50TmFtZSwgdHJpZ2dlcikgewogICAgICAgIC8vIFVuaXF1ZSBpZGVudGlmaWVyIGZvciB0aGUgYHRoaXMuX3RyaWdnZXJzYCBoYXNoCiAgICAgICAgdmFyIHRyaWdnZXJLZXkgPSB0cmlnZ2VyLnJlcGxhY2UoL15cUysvLCBmdW5jdGlvbiAodHJpZ2dlck5hbWUpIHsKICAgICAgICAgIHJldHVybiB0cmlnZ2VyTmFtZSArICcuJyArICdiZWhhdmlvcnRyaWdnZXJzJyArIGk7CiAgICAgICAgfSk7CiAgICAgICAgdGhpcy5fdHJpZ2dlcnNbdHJpZ2dlcktleV0gPSB0aGlzLl92aWV3Ll9idWlsZFZpZXdUcmlnZ2VyKGV2ZW50TmFtZSk7CiAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuIEJlaGF2aW9yczsKICB9KE1hcmlvbmV0dGUsIF8pOwogIC8vIEFwcFJvdXRlcgogIC8vIC0tLS0tLS0tLQogIC8vIFJlZHVjZSB0aGUgYm9pbGVycGxhdGUgY29kZSBvZiBoYW5kbGluZyByb3V0ZSBldmVudHMKICAvLyBhbmQgdGhlbiBjYWxsaW5nIGEgc2luZ2xlIG1ldGhvZCBvbiBhbm90aGVyIG9iamVjdC4KICAvLyBIYXZlIHlvdXIgcm91dGVycyBjb25maWd1cmVkIHRvIGNhbGwgdGhlIG1ldGhvZCBvbgogIC8vIHlvdXIgb2JqZWN0LCBkaXJlY3RseS4KICAvLwogIC8vIENvbmZpZ3VyZSBhbiBBcHBSb3V0ZXIgd2l0aCBgYXBwUm91dGVzYC4KICAvLwogIC8vIEFwcCByb3V0ZXJzIGNhbiBvbmx5IHRha2Ugb25lIGBjb250cm9sbGVyYCBvYmplY3QuCiAgLy8gSXQgaXMgcmVjb21tZW5kZWQgdGhhdCB5b3UgZGl2aWRlIHlvdXIgY29udHJvbGxlcgogIC8vIG9iamVjdHMgaW4gdG8gc21hbGxlciBwaWVjZXMgb2YgcmVsYXRlZCBmdW5jdGlvbmFsaXR5CiAgLy8gYW5kIGhhdmUgbXVsdGlwbGUgcm91dGVycyAvIGNvbnRyb2xsZXJzLCBpbnN0ZWFkIG9mCiAgLy8ganVzdCBvbmUgZ2lhbnQgcm91dGVyIGFuZCBjb250cm9sbGVyLgogIC8vCiAgLy8gWW91IGNhbiBhbHNvIGFkZCBzdGFuZGFyZCByb3V0ZXMgdG8gYW4gQXBwUm91dGVyLgogIE1hcmlvbmV0dGUuQXBwUm91dGVyID0gQmFja2JvbmUuUm91dGVyLmV4dGVuZCh7CiAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24gKG9wdGlvbnMpIHsKICAgICAgQmFja2JvbmUuUm91dGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICAgIHZhciBhcHBSb3V0ZXMgPSB0aGlzLmdldE9wdGlvbignYXBwUm91dGVzJyk7CiAgICAgIHZhciBjb250cm9sbGVyID0gdGhpcy5fZ2V0Q29udHJvbGxlcigpOwogICAgICB0aGlzLnByb2Nlc3NBcHBSb3V0ZXMoY29udHJvbGxlciwgYXBwUm91dGVzKTsKICAgICAgdGhpcy5vbigncm91dGUnLCB0aGlzLl9wcm9jZXNzT25Sb3V0ZSwgdGhpcyk7CiAgICB9LAogICAgLy8gU2ltaWxhciB0byByb3V0ZSBtZXRob2Qgb24gYSBCYWNrYm9uZSBSb3V0ZXIgYnV0CiAgICAvLyBtZXRob2QgaXMgY2FsbGVkIG9uIHRoZSBjb250cm9sbGVyCiAgICBhcHBSb3V0ZTogZnVuY3Rpb24gKHJvdXRlLCBtZXRob2ROYW1lKSB7CiAgICAgIHZhciBjb250cm9sbGVyID0gdGhpcy5fZ2V0Q29udHJvbGxlcigpOwogICAgICB0aGlzLl9hZGRBcHBSb3V0ZShjb250cm9sbGVyLCByb3V0ZSwgbWV0aG9kTmFtZSk7CiAgICB9LAogICAgLy8gcHJvY2VzcyB0aGUgcm91dGUgZXZlbnQgYW5kIHRyaWdnZXIgdGhlIG9uUm91dGUKICAgIC8vIG1ldGhvZCBjYWxsLCBpZiBpdCBleGlzdHMKICAgIF9wcm9jZXNzT25Sb3V0ZTogZnVuY3Rpb24gKHJvdXRlTmFtZSwgcm91dGVBcmdzKSB7CiAgICAgIC8vIGZpbmQgdGhlIHBhdGggdGhhdCBtYXRjaGVkCiAgICAgIHZhciByb3V0ZVBhdGggPSBfLmludmVydCh0aGlzLmdldE9wdGlvbignYXBwUm91dGVzJykpW3JvdXRlTmFtZV07CiAgICAgIC8vIG1ha2Ugc3VyZSBhbiBvblJvdXRlIGlzIHRoZXJlLCBhbmQgY2FsbCBpdAogICAgICBpZiAoXy5pc0Z1bmN0aW9uKHRoaXMub25Sb3V0ZSkpIHsKICAgICAgICB0aGlzLm9uUm91dGUocm91dGVOYW1lLCByb3V0ZVBhdGgsIHJvdXRlQXJncyk7CiAgICAgIH0KICAgIH0sCiAgICAvLyBJbnRlcm5hbCBtZXRob2QgdG8gcHJvY2VzcyB0aGUgYGFwcFJvdXRlc2AgZm9yIHRoZQogICAgLy8gcm91dGVyLCBhbmQgdHVybiB0aGVtIGluIHRvIHJvdXRlcyB0aGF0IHRyaWdnZXIgdGhlCiAgICAvLyBzcGVjaWZpZWQgbWV0aG9kIG9uIHRoZSBzcGVjaWZpZWQgYGNvbnRyb2xsZXJgLgogICAgcHJvY2Vzc0FwcFJvdXRlczogZnVuY3Rpb24gKGNvbnRyb2xsZXIsIGFwcFJvdXRlcykgewogICAgICBpZiAoIWFwcFJvdXRlcykgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICB2YXIgcm91dGVOYW1lcyA9IF8ua2V5cyhhcHBSb3V0ZXMpLnJldmVyc2UoKTsKICAgICAgLy8gQmFja2JvbmUgcmVxdWlyZXMgcmV2ZXJ0ZWQgb3JkZXIgb2Ygcm91dGVzCiAgICAgIF8uZWFjaChyb3V0ZU5hbWVzLCBmdW5jdGlvbiAocm91dGUpIHsKICAgICAgICB0aGlzLl9hZGRBcHBSb3V0ZShjb250cm9sbGVyLCByb3V0ZSwgYXBwUm91dGVzW3JvdXRlXSk7CiAgICAgIH0sIHRoaXMpOwogICAgfSwKICAgIF9nZXRDb250cm9sbGVyOiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiB0aGlzLmdldE9wdGlvbignY29udHJvbGxlcicpOwogICAgfSwKICAgIF9hZGRBcHBSb3V0ZTogZnVuY3Rpb24gKGNvbnRyb2xsZXIsIHJvdXRlLCBtZXRob2ROYW1lKSB7CiAgICAgIHZhciBtZXRob2QgPSBjb250cm9sbGVyW21ldGhvZE5hbWVdOwogICAgICBpZiAoIW1ldGhvZCkgewogICAgICAgIHRocm93IG5ldyBNYXJpb25ldHRlLkVycm9yKCdNZXRob2QgIicgKyBtZXRob2ROYW1lICsgJyIgd2FzIG5vdCBmb3VuZCBvbiB0aGUgY29udHJvbGxlcicpOwogICAgICB9CiAgICAgIHRoaXMucm91dGUocm91dGUsIG1ldGhvZE5hbWUsIF8uYmluZChtZXRob2QsIGNvbnRyb2xsZXIpKTsKICAgIH0sCiAgICAvLyBQcm94eSBgZ2V0T3B0aW9uYCB0byBlbmFibGUgZ2V0dGluZyBvcHRpb25zIGZyb20gdGhpcyBvciB0aGlzLm9wdGlvbnMgYnkgbmFtZS4KICAgIGdldE9wdGlvbjogTWFyaW9uZXR0ZS5wcm94eUdldE9wdGlvbgogIH0pOwogIC8vIEFwcGxpY2F0aW9uCiAgLy8gLS0tLS0tLS0tLS0KICAvLyBDb250YWluIGFuZCBtYW5hZ2UgdGhlIGNvbXBvc2l0ZSBhcHBsaWNhdGlvbiBhcyBhIHdob2xlLgogIC8vIFN0b3JlcyBhbmQgc3RhcnRzIHVwIGBSZWdpb25gIG9iamVjdHMsIGluY2x1ZGVzIGFuCiAgLy8gZXZlbnQgYWdncmVnYXRvciBhcyBgYXBwLnZlbnRgCiAgTWFyaW9uZXR0ZS5BcHBsaWNhdGlvbiA9IGZ1bmN0aW9uIChvcHRpb25zKSB7CiAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zOwogICAgdGhpcy5faW5pdGlhbGl6ZVJlZ2lvbnMob3B0aW9ucyk7CiAgICB0aGlzLl9pbml0Q2FsbGJhY2tzID0gbmV3IE1hcmlvbmV0dGUuQ2FsbGJhY2tzKCk7CiAgICB0aGlzLnN1Ym1vZHVsZXMgPSB7fTsKICAgIF8uZXh0ZW5kKHRoaXMsIG9wdGlvbnMpOwogICAgdGhpcy5faW5pdENoYW5uZWwoKTsKICAgIHRoaXMuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIH07CiAgXy5leHRlbmQoTWFyaW9uZXR0ZS5BcHBsaWNhdGlvbi5wcm90b3R5cGUsIEJhY2tib25lLkV2ZW50cywgewogICAgLy8gSW5pdGlhbGl6ZSBpcyBhbiBlbXB0eSBmdW5jdGlvbiBieSBkZWZhdWx0LiBPdmVycmlkZSBpdCB3aXRoIHlvdXIgb3duCiAgICAvLyBpbml0aWFsaXphdGlvbiBsb2dpYy4KICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uICgpIHsKICAgIH0sCiAgICAvLyBDb21tYW5kIGV4ZWN1dGlvbiwgZmFjaWxpdGF0ZWQgYnkgQmFja2JvbmUuV3JlcXIuQ29tbWFuZHMKICAgIGV4ZWN1dGU6IGZ1bmN0aW9uICgpIHsKICAgICAgdGhpcy5jb21tYW5kcy5leGVjdXRlLmFwcGx5KHRoaXMuY29tbWFuZHMsIGFyZ3VtZW50cyk7CiAgICB9LAogICAgLy8gUmVxdWVzdC9yZXNwb25zZSwgZmFjaWxpdGF0ZWQgYnkgQmFja2JvbmUuV3JlcXIuUmVxdWVzdFJlc3BvbnNlCiAgICByZXF1ZXN0OiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiB0aGlzLnJlcXJlcy5yZXF1ZXN0LmFwcGx5KHRoaXMucmVxcmVzLCBhcmd1bWVudHMpOwogICAgfSwKICAgIC8vIEFkZCBhbiBpbml0aWFsaXplciB0aGF0IGlzIGVpdGhlciBydW4gYXQgd2hlbiB0aGUgYHN0YXJ0YAogICAgLy8gbWV0aG9kIGlzIGNhbGxlZCwgb3IgcnVuIGltbWVkaWF0ZWx5IGlmIGFkZGVkIGFmdGVyIGBzdGFydGAKICAgIC8vIGhhcyBhbHJlYWR5IGJlZW4gY2FsbGVkLgogICAgYWRkSW5pdGlhbGl6ZXI6IGZ1bmN0aW9uIChpbml0aWFsaXplcikgewogICAgICB0aGlzLl9pbml0Q2FsbGJhY2tzLmFkZChpbml0aWFsaXplcik7CiAgICB9LAogICAgLy8ga2ljayBvZmYgYWxsIG9mIHRoZSBhcHBsaWNhdGlvbidzIHByb2Nlc3Nlcy4KICAgIC8vIGluaXRpYWxpemVzIGFsbCBvZiB0aGUgcmVnaW9ucyB0aGF0IGhhdmUgYmVlbiBhZGRlZAogICAgLy8gdG8gdGhlIGFwcCwgYW5kIHJ1bnMgYWxsIG9mIHRoZSBpbml0aWFsaXplciBmdW5jdGlvbnMKICAgIHN0YXJ0OiBmdW5jdGlvbiAob3B0aW9ucykgewogICAgICB0aGlzLnRyaWdnZXJNZXRob2QoJ2JlZm9yZTpzdGFydCcsIG9wdGlvbnMpOwogICAgICB0aGlzLl9pbml0Q2FsbGJhY2tzLnJ1bihvcHRpb25zLCB0aGlzKTsKICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdzdGFydCcsIG9wdGlvbnMpOwogICAgfSwKICAgIC8vIEFkZCByZWdpb25zIHRvIHlvdXIgYXBwLgogICAgLy8gQWNjZXB0cyBhIGhhc2ggb2YgbmFtZWQgc3RyaW5ncyBvciBSZWdpb24gb2JqZWN0cwogICAgLy8gYWRkUmVnaW9ucyh7c29tZXRoaW5nOiAiI3NvbWVSZWdpb24ifSkKICAgIC8vIGFkZFJlZ2lvbnMoe3NvbWV0aGluZzogUmVnaW9uLmV4dGVuZCh7ZWw6ICIjc29tZVJlZ2lvbiJ9KSB9KTsKICAgIGFkZFJlZ2lvbnM6IGZ1bmN0aW9uIChyZWdpb25zKSB7CiAgICAgIHJldHVybiB0aGlzLl9yZWdpb25NYW5hZ2VyLmFkZFJlZ2lvbnMocmVnaW9ucyk7CiAgICB9LAogICAgLy8gRW1wdHkgYWxsIHJlZ2lvbnMgaW4gdGhlIGFwcCwgd2l0aG91dCByZW1vdmluZyB0aGVtCiAgICBlbXB0eVJlZ2lvbnM6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIHRoaXMuX3JlZ2lvbk1hbmFnZXIuZW1wdHlSZWdpb25zKCk7CiAgICB9LAogICAgLy8gUmVtb3ZlcyBhIHJlZ2lvbiBmcm9tIHlvdXIgYXBwLCBieSBuYW1lCiAgICAvLyBBY2NlcHRzIHRoZSByZWdpb25zIG5hbWUKICAgIC8vIHJlbW92ZVJlZ2lvbignbXlSZWdpb24nKQogICAgcmVtb3ZlUmVnaW9uOiBmdW5jdGlvbiAocmVnaW9uKSB7CiAgICAgIHJldHVybiB0aGlzLl9yZWdpb25NYW5hZ2VyLnJlbW92ZVJlZ2lvbihyZWdpb24pOwogICAgfSwKICAgIC8vIFByb3ZpZGVzIGFsdGVybmF0aXZlIGFjY2VzcyB0byByZWdpb25zCiAgICAvLyBBY2NlcHRzIHRoZSByZWdpb24gbmFtZQogICAgLy8gZ2V0UmVnaW9uKCdtYWluJykKICAgIGdldFJlZ2lvbjogZnVuY3Rpb24gKHJlZ2lvbikgewogICAgICByZXR1cm4gdGhpcy5fcmVnaW9uTWFuYWdlci5nZXQocmVnaW9uKTsKICAgIH0sCiAgICAvLyBHZXQgYWxsIHRoZSByZWdpb25zIGZyb20gdGhlIHJlZ2lvbiBtYW5hZ2VyCiAgICBnZXRSZWdpb25zOiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiB0aGlzLl9yZWdpb25NYW5hZ2VyLmdldFJlZ2lvbnMoKTsKICAgIH0sCiAgICAvLyBDcmVhdGUgYSBtb2R1bGUsIGF0dGFjaGVkIHRvIHRoZSBhcHBsaWNhdGlvbgogICAgbW9kdWxlOiBmdW5jdGlvbiAobW9kdWxlTmFtZXMsIG1vZHVsZURlZmluaXRpb24pIHsKICAgICAgLy8gT3ZlcndyaXRlIHRoZSBtb2R1bGUgY2xhc3MgaWYgdGhlIHVzZXIgc3BlY2lmaWVzIG9uZQogICAgICB2YXIgTW9kdWxlQ2xhc3MgPSBNYXJpb25ldHRlLk1vZHVsZS5nZXRDbGFzcyhtb2R1bGVEZWZpbml0aW9uKTsKICAgICAgLy8gc2xpY2UgdGhlIGFyZ3MsIGFuZCBhZGQgdGhpcyBhcHBsaWNhdGlvbiBvYmplY3QgYXMgdGhlCiAgICAgIC8vIGZpcnN0IGFyZ3VtZW50IG9mIHRoZSBhcnJheQogICAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzKTsKICAgICAgYXJncy51bnNoaWZ0KHRoaXMpOwogICAgICAvLyBzZWUgdGhlIE1hcmlvbmV0dGUuTW9kdWxlIG9iamVjdCBmb3IgbW9yZSBpbmZvcm1hdGlvbgogICAgICByZXR1cm4gTW9kdWxlQ2xhc3MuY3JlYXRlLmFwcGx5KE1vZHVsZUNsYXNzLCBhcmdzKTsKICAgIH0sCiAgICAvLyBFbmFibGUgZWFzeSBvdmVycmlkaW5nIG9mIHRoZSBkZWZhdWx0IGBSZWdpb25NYW5hZ2VyYAogICAgLy8gZm9yIGN1c3RvbWl6ZWQgcmVnaW9uIGludGVyYWN0aW9ucyBhbmQgYnVzaW5lc3Mtc3BlY2lmaWMKICAgIC8vIHZpZXcgbG9naWMgZm9yIGJldHRlciBjb250cm9sIG92ZXIgc2luZ2xlIHJlZ2lvbnMuCiAgICBnZXRSZWdpb25NYW5hZ2VyOiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBuZXcgTWFyaW9uZXR0ZS5SZWdpb25NYW5hZ2VyKCk7CiAgICB9LAogICAgLy8gSW50ZXJuYWwgbWV0aG9kIHRvIGluaXRpYWxpemUgdGhlIHJlZ2lvbnMgdGhhdCBoYXZlIGJlZW4gZGVmaW5lZCBpbiBhCiAgICAvLyBgcmVnaW9uc2AgYXR0cmlidXRlIG9uIHRoZSBhcHBsaWNhdGlvbiBpbnN0YW5jZQogICAgX2luaXRpYWxpemVSZWdpb25zOiBmdW5jdGlvbiAob3B0aW9ucykgewogICAgICB2YXIgcmVnaW9ucyA9IF8uaXNGdW5jdGlvbih0aGlzLnJlZ2lvbnMpID8gdGhpcy5yZWdpb25zKG9wdGlvbnMpIDogdGhpcy5yZWdpb25zIHx8IHt9OwogICAgICB0aGlzLl9pbml0UmVnaW9uTWFuYWdlcigpOwogICAgICAvLyBFbmFibGUgdXNlcnMgdG8gZGVmaW5lIGByZWdpb25zYCBpbiBpbnN0YW5jZSBvcHRpb25zLgogICAgICB2YXIgb3B0aW9uUmVnaW9ucyA9IE1hcmlvbmV0dGUuZ2V0T3B0aW9uKG9wdGlvbnMsICdyZWdpb25zJyk7CiAgICAgIC8vIEVuYWJsZSByZWdpb24gb3B0aW9ucyB0byBiZSBhIGZ1bmN0aW9uCiAgICAgIGlmIChfLmlzRnVuY3Rpb24ob3B0aW9uUmVnaW9ucykpIHsKICAgICAgICBvcHRpb25SZWdpb25zID0gb3B0aW9uUmVnaW9ucy5jYWxsKHRoaXMsIG9wdGlvbnMpOwogICAgICB9CiAgICAgIC8vIE92ZXJ3cml0ZSBjdXJyZW50IHJlZ2lvbnMgd2l0aCB0aG9zZSBwYXNzZWQgaW4gb3B0aW9ucwogICAgICBfLmV4dGVuZChyZWdpb25zLCBvcHRpb25SZWdpb25zKTsKICAgICAgdGhpcy5hZGRSZWdpb25zKHJlZ2lvbnMpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgICAvLyBJbnRlcm5hbCBtZXRob2QgdG8gc2V0IHVwIHRoZSByZWdpb24gbWFuYWdlcgogICAgX2luaXRSZWdpb25NYW5hZ2VyOiBmdW5jdGlvbiAoKSB7CiAgICAgIHRoaXMuX3JlZ2lvbk1hbmFnZXIgPSB0aGlzLmdldFJlZ2lvbk1hbmFnZXIoKTsKICAgICAgdGhpcy5saXN0ZW5Ubyh0aGlzLl9yZWdpb25NYW5hZ2VyLCAnYmVmb3JlOmFkZDpyZWdpb24nLCBmdW5jdGlvbiAobmFtZSkgewogICAgICAgIHRoaXMudHJpZ2dlck1ldGhvZCgnYmVmb3JlOmFkZDpyZWdpb24nLCBuYW1lKTsKICAgICAgfSk7CiAgICAgIHRoaXMubGlzdGVuVG8odGhpcy5fcmVnaW9uTWFuYWdlciwgJ2FkZDpyZWdpb24nLCBmdW5jdGlvbiAobmFtZSwgcmVnaW9uKSB7CiAgICAgICAgdGhpc1tuYW1lXSA9IHJlZ2lvbjsKICAgICAgICB0aGlzLnRyaWdnZXJNZXRob2QoJ2FkZDpyZWdpb24nLCBuYW1lLCByZWdpb24pOwogICAgICB9KTsKICAgICAgdGhpcy5saXN0ZW5Ubyh0aGlzLl9yZWdpb25NYW5hZ2VyLCAnYmVmb3JlOnJlbW92ZTpyZWdpb24nLCBmdW5jdGlvbiAobmFtZSkgewogICAgICAgIHRoaXMudHJpZ2dlck1ldGhvZCgnYmVmb3JlOnJlbW92ZTpyZWdpb24nLCBuYW1lKTsKICAgICAgfSk7CiAgICAgIHRoaXMubGlzdGVuVG8odGhpcy5fcmVnaW9uTWFuYWdlciwgJ3JlbW92ZTpyZWdpb24nLCBmdW5jdGlvbiAobmFtZSwgcmVnaW9uKSB7CiAgICAgICAgZGVsZXRlIHRoaXNbbmFtZV07CiAgICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdyZW1vdmU6cmVnaW9uJywgbmFtZSwgcmVnaW9uKTsKICAgICAgfSk7CiAgICB9LAogICAgLy8gSW50ZXJuYWwgbWV0aG9kIHRvIHNldHVwIHRoZSBXcmVxci5yYWRpbyBjaGFubmVsCiAgICBfaW5pdENoYW5uZWw6IGZ1bmN0aW9uICgpIHsKICAgICAgdGhpcy5jaGFubmVsTmFtZSA9IF8ucmVzdWx0KHRoaXMsICdjaGFubmVsTmFtZScpIHx8ICdnbG9iYWwnOwogICAgICB0aGlzLmNoYW5uZWwgPSBfLnJlc3VsdCh0aGlzLCAnY2hhbm5lbCcpIHx8IEJhY2tib25lLldyZXFyLnJhZGlvLmNoYW5uZWwodGhpcy5jaGFubmVsTmFtZSk7CiAgICAgIHRoaXMudmVudCA9IF8ucmVzdWx0KHRoaXMsICd2ZW50JykgfHwgdGhpcy5jaGFubmVsLnZlbnQ7CiAgICAgIHRoaXMuY29tbWFuZHMgPSBfLnJlc3VsdCh0aGlzLCAnY29tbWFuZHMnKSB8fCB0aGlzLmNoYW5uZWwuY29tbWFuZHM7CiAgICAgIHRoaXMucmVxcmVzID0gXy5yZXN1bHQodGhpcywgJ3JlcXJlcycpIHx8IHRoaXMuY2hhbm5lbC5yZXFyZXM7CiAgICB9LAogICAgLy8gaW1wb3J0IHRoZSBgdHJpZ2dlck1ldGhvZGAgdG8gdHJpZ2dlciBldmVudHMgd2l0aCBjb3JyZXNwb25kaW5nCiAgICAvLyBtZXRob2RzIGlmIHRoZSBtZXRob2QgZXhpc3RzCiAgICB0cmlnZ2VyTWV0aG9kOiBNYXJpb25ldHRlLnRyaWdnZXJNZXRob2QsCiAgICAvLyBQcm94eSBgZ2V0T3B0aW9uYCB0byBlbmFibGUgZ2V0dGluZyBvcHRpb25zIGZyb20gdGhpcyBvciB0aGlzLm9wdGlvbnMgYnkgbmFtZS4KICAgIGdldE9wdGlvbjogTWFyaW9uZXR0ZS5wcm94eUdldE9wdGlvbgogIH0pOwogIC8vIENvcHkgdGhlIGBleHRlbmRgIGZ1bmN0aW9uIHVzZWQgYnkgQmFja2JvbmUncyBjbGFzc2VzCiAgTWFyaW9uZXR0ZS5BcHBsaWNhdGlvbi5leHRlbmQgPSBNYXJpb25ldHRlLmV4dGVuZDsKICAvKiBqc2hpbnQgbWF4cGFyYW1zOiA5ICovCiAgLy8gTW9kdWxlCiAgLy8gLS0tLS0tCiAgLy8gQSBzaW1wbGUgbW9kdWxlIHN5c3RlbSwgdXNlZCB0byBjcmVhdGUgcHJpdmFjeSBhbmQgZW5jYXBzdWxhdGlvbiBpbgogIC8vIE1hcmlvbmV0dGUgYXBwbGljYXRpb25zCiAgTWFyaW9uZXR0ZS5Nb2R1bGUgPSBmdW5jdGlvbiAobW9kdWxlTmFtZSwgYXBwLCBvcHRpb25zKSB7CiAgICB0aGlzLm1vZHVsZU5hbWUgPSBtb2R1bGVOYW1lOwogICAgdGhpcy5vcHRpb25zID0gXy5leHRlbmQoe30sIHRoaXMub3B0aW9ucywgb3B0aW9ucyk7CiAgICAvLyBBbGxvdyBmb3IgYSB1c2VyIHRvIG92ZXJpZGUgdGhlIGluaXRpYWxpemUKICAgIC8vIGZvciBhIGdpdmVuIG1vZHVsZSBpbnN0YW5jZS4KICAgIHRoaXMuaW5pdGlhbGl6ZSA9IG9wdGlvbnMuaW5pdGlhbGl6ZSB8fCB0aGlzLmluaXRpYWxpemU7CiAgICAvLyBTZXQgdXAgYW4gaW50ZXJuYWwgc3RvcmUgZm9yIHN1Yi1tb2R1bGVzLgogICAgdGhpcy5zdWJtb2R1bGVzID0ge307CiAgICB0aGlzLl9zZXR1cEluaXRpYWxpemVyc0FuZEZpbmFsaXplcnMoKTsKICAgIC8vIFNldCBhbiBpbnRlcm5hbCByZWZlcmVuY2UgdG8gdGhlIGFwcAogICAgLy8gd2l0aGluIGEgbW9kdWxlLgogICAgdGhpcy5hcHAgPSBhcHA7CiAgICBpZiAoXy5pc0Z1bmN0aW9uKHRoaXMuaW5pdGlhbGl6ZSkpIHsKICAgICAgdGhpcy5pbml0aWFsaXplKG1vZHVsZU5hbWUsIGFwcCwgdGhpcy5vcHRpb25zKTsKICAgIH0KICB9OwogIE1hcmlvbmV0dGUuTW9kdWxlLmV4dGVuZCA9IE1hcmlvbmV0dGUuZXh0ZW5kOwogIC8vIEV4dGVuZCB0aGUgTW9kdWxlIHByb3RvdHlwZSB3aXRoIGV2ZW50cyAvIGxpc3RlblRvLCBzbyB0aGF0IHRoZSBtb2R1bGUKICAvLyBjYW4gYmUgdXNlZCBhcyBhbiBldmVudCBhZ2dyZWdhdG9yIG9yIHB1Yi9zdWIuCiAgXy5leHRlbmQoTWFyaW9uZXR0ZS5Nb2R1bGUucHJvdG90eXBlLCBCYWNrYm9uZS5FdmVudHMsIHsKICAgIC8vIEJ5IGRlZmF1bHQgbW9kdWxlcyBzdGFydCB3aXRoIHRoZWlyIHBhcmVudHMuCiAgICBzdGFydFdpdGhQYXJlbnQ6IHRydWUsCiAgICAvLyBJbml0aWFsaXplIGlzIGFuIGVtcHR5IGZ1bmN0aW9uIGJ5IGRlZmF1bHQuIE92ZXJyaWRlIGl0IHdpdGggeW91ciBvd24KICAgIC8vIGluaXRpYWxpemF0aW9uIGxvZ2ljIHdoZW4gZXh0ZW5kaW5nIE1hcmlvbmV0dGUuTW9kdWxlLgogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24gKCkgewogICAgfSwKICAgIC8vIEluaXRpYWxpemVyIGZvciBhIHNwZWNpZmljIG1vZHVsZS4gSW5pdGlhbGl6ZXJzIGFyZSBydW4gd2hlbiB0aGUKICAgIC8vIG1vZHVsZSdzIGBzdGFydGAgbWV0aG9kIGlzIGNhbGxlZC4KICAgIGFkZEluaXRpYWxpemVyOiBmdW5jdGlvbiAoY2FsbGJhY2spIHsKICAgICAgdGhpcy5faW5pdGlhbGl6ZXJDYWxsYmFja3MuYWRkKGNhbGxiYWNrKTsKICAgIH0sCiAgICAvLyBGaW5hbGl6ZXJzIGFyZSBydW4gd2hlbiBhIG1vZHVsZSBpcyBzdG9wcGVkLiBUaGV5IGFyZSB1c2VkIHRvIHRlYXJkb3duCiAgICAvLyBhbmQgZmluYWxpemUgYW55IHZhcmlhYmxlcywgcmVmZXJlbmNlcywgZXZlbnRzIGFuZCBvdGhlciBjb2RlIHRoYXQgdGhlCiAgICAvLyBtb2R1bGUgaGFkIHNldCB1cC4KICAgIGFkZEZpbmFsaXplcjogZnVuY3Rpb24gKGNhbGxiYWNrKSB7CiAgICAgIHRoaXMuX2ZpbmFsaXplckNhbGxiYWNrcy5hZGQoY2FsbGJhY2spOwogICAgfSwKICAgIC8vIFN0YXJ0IHRoZSBtb2R1bGUsIGFuZCBydW4gYWxsIG9mIGl0cyBpbml0aWFsaXplcnMKICAgIHN0YXJ0OiBmdW5jdGlvbiAob3B0aW9ucykgewogICAgICAvLyBQcmV2ZW50IHJlLXN0YXJ0aW5nIGEgbW9kdWxlIHRoYXQgaXMgYWxyZWFkeSBzdGFydGVkCiAgICAgIGlmICh0aGlzLl9pc0luaXRpYWxpemVkKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIC8vIHN0YXJ0IHRoZSBzdWItbW9kdWxlcyAoZGVwdGgtZmlyc3QgaGllcmFyY2h5KQogICAgICBfLmVhY2godGhpcy5zdWJtb2R1bGVzLCBmdW5jdGlvbiAobW9kKSB7CiAgICAgICAgLy8gY2hlY2sgdG8gc2VlIGlmIHdlIHNob3VsZCBzdGFydCB0aGUgc3ViLW1vZHVsZSB3aXRoIHRoaXMgcGFyZW50CiAgICAgICAgaWYgKG1vZC5zdGFydFdpdGhQYXJlbnQpIHsKICAgICAgICAgIG1vZC5zdGFydChvcHRpb25zKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICAvLyBydW4gdGhlIGNhbGxiYWNrcyB0byAic3RhcnQiIHRoZSBjdXJyZW50IG1vZHVsZQogICAgICB0aGlzLnRyaWdnZXJNZXRob2QoJ2JlZm9yZTpzdGFydCcsIG9wdGlvbnMpOwogICAgICB0aGlzLl9pbml0aWFsaXplckNhbGxiYWNrcy5ydW4ob3B0aW9ucywgdGhpcyk7CiAgICAgIHRoaXMuX2lzSW5pdGlhbGl6ZWQgPSB0cnVlOwogICAgICB0aGlzLnRyaWdnZXJNZXRob2QoJ3N0YXJ0Jywgb3B0aW9ucyk7CiAgICB9LAogICAgLy8gU3RvcCB0aGlzIG1vZHVsZSBieSBydW5uaW5nIGl0cyBmaW5hbGl6ZXJzIGFuZCB0aGVuIHN0b3AgYWxsIG9mCiAgICAvLyB0aGUgc3ViLW1vZHVsZXMgZm9yIHRoaXMgbW9kdWxlCiAgICBzdG9wOiBmdW5jdGlvbiAoKSB7CiAgICAgIC8vIGlmIHdlIGFyZSBub3QgaW5pdGlhbGl6ZWQsIGRvbid0IGJvdGhlciBmaW5hbGl6aW5nCiAgICAgIGlmICghdGhpcy5faXNJbml0aWFsaXplZCkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICB0aGlzLl9pc0luaXRpYWxpemVkID0gZmFsc2U7CiAgICAgIHRoaXMudHJpZ2dlck1ldGhvZCgnYmVmb3JlOnN0b3AnKTsKICAgICAgLy8gc3RvcCB0aGUgc3ViLW1vZHVsZXM7IGRlcHRoLWZpcnN0LCB0byBtYWtlIHN1cmUgdGhlCiAgICAgIC8vIHN1Yi1tb2R1bGVzIGFyZSBzdG9wcGVkIC8gZmluYWxpemVkIGJlZm9yZSBwYXJlbnRzCiAgICAgIF8uZWFjaCh0aGlzLnN1Ym1vZHVsZXMsIGZ1bmN0aW9uIChtb2QpIHsKICAgICAgICBtb2Quc3RvcCgpOwogICAgICB9KTsKICAgICAgLy8gcnVuIHRoZSBmaW5hbGl6ZXJzCiAgICAgIHRoaXMuX2ZpbmFsaXplckNhbGxiYWNrcy5ydW4odW5kZWZpbmVkLCB0aGlzKTsKICAgICAgLy8gcmVzZXQgdGhlIGluaXRpYWxpemVycyBhbmQgZmluYWxpemVycwogICAgICB0aGlzLl9pbml0aWFsaXplckNhbGxiYWNrcy5yZXNldCgpOwogICAgICB0aGlzLl9maW5hbGl6ZXJDYWxsYmFja3MucmVzZXQoKTsKICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdzdG9wJyk7CiAgICB9LAogICAgLy8gQ29uZmlndXJlIHRoZSBtb2R1bGUgd2l0aCBhIGRlZmluaXRpb24gZnVuY3Rpb24gYW5kIGFueSBjdXN0b20gYXJncwogICAgLy8gdGhhdCBhcmUgdG8gYmUgcGFzc2VkIGluIHRvIHRoZSBkZWZpbml0aW9uIGZ1bmN0aW9uCiAgICBhZGREZWZpbml0aW9uOiBmdW5jdGlvbiAobW9kdWxlRGVmaW5pdGlvbiwgY3VzdG9tQXJncykgewogICAgICB0aGlzLl9ydW5Nb2R1bGVEZWZpbml0aW9uKG1vZHVsZURlZmluaXRpb24sIGN1c3RvbUFyZ3MpOwogICAgfSwKICAgIC8vIEludGVybmFsIG1ldGhvZDogcnVuIHRoZSBtb2R1bGUgZGVmaW5pdGlvbiBmdW5jdGlvbiB3aXRoIHRoZSBjb3JyZWN0CiAgICAvLyBhcmd1bWVudHMKICAgIF9ydW5Nb2R1bGVEZWZpbml0aW9uOiBmdW5jdGlvbiAoZGVmaW5pdGlvbiwgY3VzdG9tQXJncykgewogICAgICAvLyBJZiB0aGVyZSBpcyBubyBkZWZpbml0aW9uIHNob3J0IGNpcmN1dCB0aGUgbWV0aG9kLgogICAgICBpZiAoIWRlZmluaXRpb24pIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgLy8gYnVpbGQgdGhlIGNvcnJlY3QgbGlzdCBvZiBhcmd1bWVudHMgZm9yIHRoZSBtb2R1bGUgZGVmaW5pdGlvbgogICAgICB2YXIgYXJncyA9IF8uZmxhdHRlbihbCiAgICAgICAgdGhpcywKICAgICAgICB0aGlzLmFwcCwKICAgICAgICBCYWNrYm9uZSwKICAgICAgICBNYXJpb25ldHRlLAogICAgICAgIEJhY2tib25lLiQsCiAgICAgICAgXywKICAgICAgICBjdXN0b21BcmdzCiAgICAgIF0pOwogICAgICBkZWZpbml0aW9uLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgfSwKICAgIC8vIEludGVybmFsIG1ldGhvZDogc2V0IHVwIG5ldyBjb3BpZXMgb2YgaW5pdGlhbGl6ZXJzIGFuZCBmaW5hbGl6ZXJzLgogICAgLy8gQ2FsbGluZyB0aGlzIG1ldGhvZCB3aWxsIHdpcGUgb3V0IGFsbCBleGlzdGluZyBpbml0aWFsaXplcnMgYW5kCiAgICAvLyBmaW5hbGl6ZXJzLgogICAgX3NldHVwSW5pdGlhbGl6ZXJzQW5kRmluYWxpemVyczogZnVuY3Rpb24gKCkgewogICAgICB0aGlzLl9pbml0aWFsaXplckNhbGxiYWNrcyA9IG5ldyBNYXJpb25ldHRlLkNhbGxiYWNrcygpOwogICAgICB0aGlzLl9maW5hbGl6ZXJDYWxsYmFja3MgPSBuZXcgTWFyaW9uZXR0ZS5DYWxsYmFja3MoKTsKICAgIH0sCiAgICAvLyBpbXBvcnQgdGhlIGB0cmlnZ2VyTWV0aG9kYCB0byB0cmlnZ2VyIGV2ZW50cyB3aXRoIGNvcnJlc3BvbmRpbmcKICAgIC8vIG1ldGhvZHMgaWYgdGhlIG1ldGhvZCBleGlzdHMKICAgIHRyaWdnZXJNZXRob2Q6IE1hcmlvbmV0dGUudHJpZ2dlck1ldGhvZAogIH0pOwogIC8vIENsYXNzIG1ldGhvZHMgdG8gY3JlYXRlIG1vZHVsZXMKICBfLmV4dGVuZChNYXJpb25ldHRlLk1vZHVsZSwgewogICAgLy8gQ3JlYXRlIGEgbW9kdWxlLCBoYW5naW5nIG9mZiB0aGUgYXBwIHBhcmFtZXRlciBhcyB0aGUgcGFyZW50IG9iamVjdC4KICAgIGNyZWF0ZTogZnVuY3Rpb24gKGFwcCwgbW9kdWxlTmFtZXMsIG1vZHVsZURlZmluaXRpb24pIHsKICAgICAgdmFyIG1vZHVsZSA9IGFwcDsKICAgICAgLy8gZ2V0IHRoZSBjdXN0b20gYXJncyBwYXNzZWQgaW4gYWZ0ZXIgdGhlIG1vZHVsZSBkZWZpbml0aW9uIGFuZAogICAgICAvLyBnZXQgcmlkIG9mIHRoZSBtb2R1bGUgbmFtZSBhbmQgZGVmaW5pdGlvbiBmdW5jdGlvbgogICAgICB2YXIgY3VzdG9tQXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzKTsKICAgICAgY3VzdG9tQXJncy5zcGxpY2UoMCwgMyk7CiAgICAgIC8vIFNwbGl0IHRoZSBtb2R1bGUgbmFtZXMgYW5kIGdldCB0aGUgbnVtYmVyIG9mIHN1Ym1vZHVsZXMuCiAgICAgIC8vIGkuZS4gYW4gZXhhbXBsZSBtb2R1bGUgbmFtZSBvZiBgRG9nZS5Xb3cuQW1hemVgIHdvdWxkCiAgICAgIC8vIHRoZW4gaGF2ZSB0aGUgcG90ZW50aWFsIGZvciAzIG1vZHVsZSBkZWZpbml0aW9ucy4KICAgICAgbW9kdWxlTmFtZXMgPSBtb2R1bGVOYW1lcy5zcGxpdCgnLicpOwogICAgICB2YXIgbGVuZ3RoID0gbW9kdWxlTmFtZXMubGVuZ3RoOwogICAgICAvLyBzdG9yZSB0aGUgbW9kdWxlIGRlZmluaXRpb24gZm9yIHRoZSBsYXN0IG1vZHVsZSBpbiB0aGUgY2hhaW4KICAgICAgdmFyIG1vZHVsZURlZmluaXRpb25zID0gW107CiAgICAgIG1vZHVsZURlZmluaXRpb25zW2xlbmd0aCAtIDFdID0gbW9kdWxlRGVmaW5pdGlvbjsKICAgICAgLy8gTG9vcCB0aHJvdWdoIGFsbCB0aGUgcGFydHMgb2YgdGhlIG1vZHVsZSBkZWZpbml0aW9uCiAgICAgIF8uZWFjaChtb2R1bGVOYW1lcywgZnVuY3Rpb24gKG1vZHVsZU5hbWUsIGkpIHsKICAgICAgICB2YXIgcGFyZW50TW9kdWxlID0gbW9kdWxlOwogICAgICAgIG1vZHVsZSA9IHRoaXMuX2dldE1vZHVsZShwYXJlbnRNb2R1bGUsIG1vZHVsZU5hbWUsIGFwcCwgbW9kdWxlRGVmaW5pdGlvbik7CiAgICAgICAgdGhpcy5fYWRkTW9kdWxlRGVmaW5pdGlvbihwYXJlbnRNb2R1bGUsIG1vZHVsZSwgbW9kdWxlRGVmaW5pdGlvbnNbaV0sIGN1c3RvbUFyZ3MpOwogICAgICB9LCB0aGlzKTsKICAgICAgLy8gUmV0dXJuIHRoZSBsYXN0IG1vZHVsZSBpbiB0aGUgZGVmaW5pdGlvbiBjaGFpbgogICAgICByZXR1cm4gbW9kdWxlOwogICAgfSwKICAgIF9nZXRNb2R1bGU6IGZ1bmN0aW9uIChwYXJlbnRNb2R1bGUsIG1vZHVsZU5hbWUsIGFwcCwgZGVmLCBhcmdzKSB7CiAgICAgIHZhciBvcHRpb25zID0gXy5leHRlbmQoe30sIGRlZik7CiAgICAgIHZhciBNb2R1bGVDbGFzcyA9IHRoaXMuZ2V0Q2xhc3MoZGVmKTsKICAgICAgLy8gR2V0IGFuIGV4aXN0aW5nIG1vZHVsZSBvZiB0aGlzIG5hbWUgaWYgd2UgaGF2ZSBvbmUKICAgICAgdmFyIG1vZHVsZSA9IHBhcmVudE1vZHVsZVttb2R1bGVOYW1lXTsKICAgICAgaWYgKCFtb2R1bGUpIHsKICAgICAgICAvLyBDcmVhdGUgYSBuZXcgbW9kdWxlIGlmIHdlIGRvbid0IGhhdmUgb25lCiAgICAgICAgbW9kdWxlID0gbmV3IE1vZHVsZUNsYXNzKG1vZHVsZU5hbWUsIGFwcCwgb3B0aW9ucyk7CiAgICAgICAgcGFyZW50TW9kdWxlW21vZHVsZU5hbWVdID0gbW9kdWxlOwogICAgICAgIC8vIHN0b3JlIHRoZSBtb2R1bGUgb24gdGhlIHBhcmVudAogICAgICAgIHBhcmVudE1vZHVsZS5zdWJtb2R1bGVzW21vZHVsZU5hbWVdID0gbW9kdWxlOwogICAgICB9CiAgICAgIHJldHVybiBtb2R1bGU7CiAgICB9LAogICAgLy8gIyMgTW9kdWxlIENsYXNzZXMKICAgIC8vCiAgICAvLyBNb2R1bGUgY2xhc3NlcyBjYW4gYmUgdXNlZCBhcyBhbiBhbHRlcm5hdGl2ZSB0byB0aGUgZGVmaW5lIHBhdHRlcm4uCiAgICAvLyBUaGUgZXh0ZW5kIGZ1bmN0aW9uIG9mIGEgTW9kdWxlIGlzIGlkZW50aWNhbCB0byB0aGUgZXh0ZW5kIGZ1bmN0aW9ucwogICAgLy8gb24gb3RoZXIgQmFja2JvbmUgYW5kIE1hcmlvbmV0dGUgY2xhc3Nlcy4KICAgIC8vIFRoaXMgYWxsb3dzIG1vZHVsZSBsaWZlY3lsZSBldmVudHMgbGlrZSBgb25TdGFydGAgYW5kIGBvblN0b3BgIHRvIGJlIGNhbGxlZCBkaXJlY3RseS4KICAgIGdldENsYXNzOiBmdW5jdGlvbiAobW9kdWxlRGVmaW5pdGlvbikgewogICAgICB2YXIgTW9kdWxlQ2xhc3MgPSBNYXJpb25ldHRlLk1vZHVsZTsKICAgICAgaWYgKCFtb2R1bGVEZWZpbml0aW9uKSB7CiAgICAgICAgcmV0dXJuIE1vZHVsZUNsYXNzOwogICAgICB9CiAgICAgIC8vIElmIGFsbCBvZiB0aGUgbW9kdWxlJ3MgZnVuY3Rpb25hbGl0eSBpcyBkZWZpbmVkIGluc2lkZSBpdHMgY2xhc3MsCiAgICAgIC8vIHRoZW4gdGhlIGNsYXNzIGNhbiBiZSBwYXNzZWQgaW4gZGlyZWN0bHkuIGBNeUFwcC5tb2R1bGUoIkZvbyIsIEZvb01vZHVsZSlgLgogICAgICBpZiAobW9kdWxlRGVmaW5pdGlvbi5wcm90b3R5cGUgaW5zdGFuY2VvZiBNb2R1bGVDbGFzcykgewogICAgICAgIHJldHVybiBtb2R1bGVEZWZpbml0aW9uOwogICAgICB9CiAgICAgIHJldHVybiBtb2R1bGVEZWZpbml0aW9uLm1vZHVsZUNsYXNzIHx8IE1vZHVsZUNsYXNzOwogICAgfSwKICAgIC8vIEFkZCB0aGUgbW9kdWxlIGRlZmluaXRpb24gYW5kIGFkZCBhIHN0YXJ0V2l0aFBhcmVudCBpbml0aWFsaXplciBmdW5jdGlvbi4KICAgIC8vIFRoaXMgaXMgY29tcGxpY2F0ZWQgYmVjYXVzZSBtb2R1bGUgZGVmaW5pdGlvbnMgYXJlIGhlYXZpbHkgb3ZlcmxvYWRlZAogICAgLy8gYW5kIHN1cHBvcnQgYW4gYW5vbnltb3VzIGZ1bmN0aW9uLCBtb2R1bGUgY2xhc3MsIG9yIG9wdGlvbnMgb2JqZWN0CiAgICBfYWRkTW9kdWxlRGVmaW5pdGlvbjogZnVuY3Rpb24gKHBhcmVudE1vZHVsZSwgbW9kdWxlLCBkZWYsIGFyZ3MpIHsKICAgICAgdmFyIGZuID0gdGhpcy5fZ2V0RGVmaW5lKGRlZik7CiAgICAgIHZhciBzdGFydFdpdGhQYXJlbnQgPSB0aGlzLl9nZXRTdGFydFdpdGhQYXJlbnQoZGVmLCBtb2R1bGUpOwogICAgICBpZiAoZm4pIHsKICAgICAgICBtb2R1bGUuYWRkRGVmaW5pdGlvbihmbiwgYXJncyk7CiAgICAgIH0KICAgICAgdGhpcy5fYWRkU3RhcnRXaXRoUGFyZW50KHBhcmVudE1vZHVsZSwgbW9kdWxlLCBzdGFydFdpdGhQYXJlbnQpOwogICAgfSwKICAgIF9nZXRTdGFydFdpdGhQYXJlbnQ6IGZ1bmN0aW9uIChkZWYsIG1vZHVsZSkgewogICAgICB2YXIgc3dwOwogICAgICBpZiAoXy5pc0Z1bmN0aW9uKGRlZikgJiYgZGVmLnByb3RvdHlwZSBpbnN0YW5jZW9mIE1hcmlvbmV0dGUuTW9kdWxlKSB7CiAgICAgICAgc3dwID0gbW9kdWxlLmNvbnN0cnVjdG9yLnByb3RvdHlwZS5zdGFydFdpdGhQYXJlbnQ7CiAgICAgICAgcmV0dXJuIF8uaXNVbmRlZmluZWQoc3dwKSA/IHRydWUgOiBzd3A7CiAgICAgIH0KICAgICAgaWYgKF8uaXNPYmplY3QoZGVmKSkgewogICAgICAgIHN3cCA9IGRlZi5zdGFydFdpdGhQYXJlbnQ7CiAgICAgICAgcmV0dXJuIF8uaXNVbmRlZmluZWQoc3dwKSA/IHRydWUgOiBzd3A7CiAgICAgIH0KICAgICAgcmV0dXJuIHRydWU7CiAgICB9LAogICAgX2dldERlZmluZTogZnVuY3Rpb24gKGRlZikgewogICAgICBpZiAoXy5pc0Z1bmN0aW9uKGRlZikgJiYgIShkZWYucHJvdG90eXBlIGluc3RhbmNlb2YgTWFyaW9uZXR0ZS5Nb2R1bGUpKSB7CiAgICAgICAgcmV0dXJuIGRlZjsKICAgICAgfQogICAgICBpZiAoXy5pc09iamVjdChkZWYpKSB7CiAgICAgICAgcmV0dXJuIGRlZi5kZWZpbmU7CiAgICAgIH0KICAgICAgcmV0dXJuIG51bGw7CiAgICB9LAogICAgX2FkZFN0YXJ0V2l0aFBhcmVudDogZnVuY3Rpb24gKHBhcmVudE1vZHVsZSwgbW9kdWxlLCBzdGFydFdpdGhQYXJlbnQpIHsKICAgICAgbW9kdWxlLnN0YXJ0V2l0aFBhcmVudCA9IG1vZHVsZS5zdGFydFdpdGhQYXJlbnQgJiYgc3RhcnRXaXRoUGFyZW50OwogICAgICBpZiAoIW1vZHVsZS5zdGFydFdpdGhQYXJlbnQgfHwgISFtb2R1bGUuc3RhcnRXaXRoUGFyZW50SXNDb25maWd1cmVkKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIG1vZHVsZS5zdGFydFdpdGhQYXJlbnRJc0NvbmZpZ3VyZWQgPSB0cnVlOwogICAgICBwYXJlbnRNb2R1bGUuYWRkSW5pdGlhbGl6ZXIoZnVuY3Rpb24gKG9wdGlvbnMpIHsKICAgICAgICBpZiAobW9kdWxlLnN0YXJ0V2l0aFBhcmVudCkgewogICAgICAgICAgbW9kdWxlLnN0YXJ0KG9wdGlvbnMpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgfSk7CiAgcmV0dXJuIE1hcmlvbmV0dGU7Cn0pKTsKLyohCiAqIGJhc2UuanMKICogCiAqIENvcHlyaWdodCAoYykgMjAxNAogKi8KX2Jhc2VfID0gZnVuY3Rpb24gKE1hcmlvbmV0dGUpIHsKICAvKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIEJhc2UKICAgKgogICAqIE5vdCBpbnRlbmRlZCB0byBiZSB1c2VkIGRpcmVjdGx5LiBQcm92aWRlcyBiYXNlIGZ1bmN0aW9uYWxpdHkgZm9yCiAgICogQ29sbGVjdGlvbkNvbXBvbmVudCwgQ29tcG9zaXRlQ29tcG9uZW50LCBJdGVtQ29tcG9uZW50LCBhbmQgTGF5b3V0Q29tcG9uZW50LgogICAqIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAgcmV0dXJuIE1hcmlvbmV0dGUuT2JqZWN0LmV4dGVuZCh7CiAgICAvKioKICAgICAqIE92ZXJ3cml0ZSBNYXJpb25ldHRlLk9iamVjdCBjb25zdHJ1Y3RvciB0byBhZGQgYSBjcmVhdGVDb21wb25lbnQKICAgICAqIHN0ZXAgaW5iZXR3ZWVuIHNldHRpbmcgb3B0aW9ucyBhbmQgaW5pdGlhbGl6ZSBjYWxsLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKiB2YXIgY29udHJvbGxlciA9IG5ldyBDb21wb25lbnQoeyBWaWV3OiBJdGVtVmlldyB9KTsKICAgICAqCiAgICAgKiBAY29uc3RydWN0b3IKICAgICAqIEBwdWJsaWMKICAgICAqCiAgICAgKiBAcGFyYW0ge29iamVjdH0gb3B0aW9ucyAtIE9iamVjdCBvcHRpb25zLgogICAgICovCiAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24gKG9wdGlvbnMpIHsKICAgICAgdGhpcy5vcHRpb25zID0gXy5leHRlbmQoe30sIF8ucmVzdWx0KHRoaXMsICdvcHRpb25zJyksIG9wdGlvbnMpOwogICAgICB0aGlzLmNyZWF0ZVZpZXcoKTsKICAgICAgdGhpcy5pbml0aWFsaXplLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9LAogICAgLyoqCiAgICAgKiBJbnN0bmF0aWF0ZSBvdXIgdmlldyBwYXNzaW5nIGluIGFueSBkZWZpbmVkIGVudGl0aWVzLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKgogICAgICogQHBhcmFtIHtvYmplY3R9IG9wdGlvbnMgLSBPYmplY3Qgb3B0aW9ucyBwYXNzZWQgdG8gY29uc3RydWN0b3IuCiAgICAgKi8KICAgIGNyZWF0ZVZpZXc6IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIFZpZXcgPSB0aGlzLmdldFJlcXVpcmVkKCdWaWV3Jyk7CiAgICAgIHZhciBkZWZhdWx0cyA9IHRoaXMuY3JlYXRlRW50aXRpZXMoKTsKICAgICAgdmFyIG9wdGlvbnMgPSB0aGlzLmdldE9wdGlvbigndmlld09wdGlvbnMnKTsKICAgICAgLy8gUmVuZGVyIHlvIQogICAgICB0aGlzLnZpZXcgPSBuZXcgVmlldyhfLmV4dGVuZCh7fSwgZGVmYXVsdHMsIG9wdGlvbnMpKTsKICAgICAgdGhpcy5fYmluZEluc3RhbmNlRXZlbnRzKCd2aWV3Jyk7CiAgICB9LAogICAgLyoqCiAgICAgKiBCaW5kIGluc3RhbmNlIGV2ZW50cyB0byBjb21wb25lbnQuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gaW5zdGFuY2VOYW1lIC0gTmFtZSBvZiBpbnN0YW5jZSB0byBiaW5kIGV2ZW50cyBmcm9tLgogICAgICovCiAgICBfYmluZEluc3RhbmNlRXZlbnRzOiBmdW5jdGlvbiAoaW5zdGFuY2VOYW1lKSB7CiAgICAgIHZhciBpbnN0YW5jZSA9IHRoaXNbaW5zdGFuY2VOYW1lXTsKICAgICAgdmFyIGV2ZW50c05hbWUgPSBpbnN0YW5jZU5hbWUgKyAnRXZlbnRzJzsKICAgICAgdGhpcy5iaW5kRW50aXR5RXZlbnRzKGluc3RhbmNlLCB0aGlzLmdldE9wdGlvbihldmVudHNOYW1lKSk7CiAgICB9LAogICAgLyoqCiAgICAgKiBDcmVhdGUgZW50aXRpZXMgdG8gYmUgcGFzc2VkIHRvIHlvdXIgdmlldy4gQmFzZSBjbGFzcyBieSBkZWZhdWx0CiAgICAgKiBkb2VzIG5vdCBjcmVhdGUgb3IgcmV0dXJuIGFueSBlbnRpdGllcy4gQ29sbGVjdGlvbkNvbXBvbmVudCBmb3IKICAgICAqIGV4YW1wbGUgd291bGQgYXR0YWNoIHRoaXMuY29sbGVjdGlvbiBhbmQgcmV0dXJuIGFuIG9iamVjdCB3aXRoCiAgICAgKiBhIGNvbGxlY3Rpb24ga2V5IHdob3MgdmFsdWUgaXMgdGhlIG5ld2x5IGNyZWF0ZWQgY29sbGVjdGlvbi4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICovCiAgICBjcmVhdGVFbnRpdGllczogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4ge307CiAgICB9LAogICAgLyoqCiAgICAgKiBDcmVhdGUgZW50aXR5IChpZiBub3QgeWV0IGNyZWF0ZWQpLiBBZGQgaW5zdGFuY2UgdG8gY29tcG9uZW50CiAgICAgKiBhbmQgYmluZCBhbGwgaW5zdGFuY2UgZXZlbnRzIHRvIGNvbXBvbmVudC4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBpbnN0YW5jZU5hbWUgLSBOYW1lIG9mIGNsYXNzIHRvIGNyZWF0ZS9yZXRyaWV2ZS4KICAgICAqLwogICAgX2NyZWF0ZUVudGl0eTogZnVuY3Rpb24gKGluc3RhbmNlTmFtZSkgewogICAgICB2YXIgaW5zdGFuY2UgPSB0aGlzW2luc3RhbmNlTmFtZV0gPSB0aGlzLl9nZXRFbnRpdHkoaW5zdGFuY2VOYW1lKTsKICAgICAgdGhpcy5fYmluZEluc3RhbmNlRXZlbnRzKGluc3RhbmNlTmFtZSk7CiAgICAgIHJldHVybiBpbnN0YW5jZTsKICAgIH0sCiAgICAvKioKICAgICAqIFJldHJlaXZlIHByZS1leGlzdGluZyBkZWNsYXJlZCBpbnN0YW5jZSwgb3IgY3JlYXRlIGEgbmV3CiAgICAgKiBpbnN0YW5jZS4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBpbnN0YW5jZU5hbWUgLSBOYW1lIG9mIGNsYXNzIHRvIGNyZWF0ZS9yZXRyaWV2ZS4KICAgICAqLwogICAgX2dldEVudGl0eTogZnVuY3Rpb24gKGluc3RhbmNlTmFtZSkgewogICAgICB2YXIgaW5zdGFuY2UgPSB0aGlzLmdldE9wdGlvbihpbnN0YW5jZU5hbWUpOwogICAgICBpZiAoaW5zdGFuY2UpIHsKICAgICAgICByZXR1cm4gaW5zdGFuY2U7CiAgICAgIH0KICAgICAgdmFyIG9iak5hbWUgPSBpbnN0YW5jZU5hbWUuc3Vic3RyaW5nKDAsIDEpLnRvVXBwZXJDYXNlKCkgKyBpbnN0YW5jZU5hbWUuc3Vic3RyaW5nKDEpOwogICAgICB2YXIgT2JqID0gdGhpcy5nZXRPcHRpb24ob2JqTmFtZSk7CiAgICAgIHJldHVybiBuZXcgT2JqKCk7CiAgICB9LAogICAgLyoqCiAgICAgKiBDb21wb25lbnQgY2xlYW4gdXAgYnkgZGVzdHJveWluZyBjaGlsZCB2aWV3LiBPYmplY3QucHJvdG90eXBlLmRlc3Ryb3kKICAgICAqIGF1dG9tYXRpY2FsbHkgc3RvcHMgbGlzdGVuaW5nIHRvIGFsbCBldmVudHMuCiAgICAgKgogICAgICogQHB1YmxpYwogICAgICovCiAgICBkZXN0cm95OiBmdW5jdGlvbiAoKSB7CiAgICAgIC8vIENsZWFuIHVwIGJ5IGRlc3Ryb3lpbmcgbmVzdGVkIHZpZXcuCiAgICAgIHRoaXMudmlldy5kZXN0cm95KCk7CiAgICAgIE1hcmlvbmV0dGUuT2JqZWN0LnByb3RvdHlwZS5kZXN0cm95LmFwcGx5KHRoaXMpOwogICAgfSwKICAgIC8qKgogICAgICogTWFrZSBzdXJlIHByb3AgaXMgZGVmaW5lZCBvbiBvdXIgaW5zdGFuY2Ugb3IKICAgICAqIGluIG91ciBpbnN0YW5jZSBvcHRpb25zIG9iamVjdC4KICAgICAqCiAgICAgKiBAcHVibGljCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgLSBOYW1lIG9mIHByb3BlcnR5IHdlIGFyZSBjaGVja2luZwogICAgICogICBleGlzdGFuY2Ugb2YuCiAgICAgKi8KICAgIGdldFJlcXVpcmVkOiBmdW5jdGlvbiAobmFtZSkgewogICAgICB2YXIgb3B0aW9uID0gdGhpcy5nZXRPcHRpb24obmFtZSk7CiAgICAgIGlmICghb3B0aW9uKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdgJyArIG5hbWUgKyAnYCBtdXN0IHRvIGJlIGRlZmluZWQuJyk7CiAgICAgIH0KICAgICAgcmV0dXJuIG9wdGlvbjsKICAgIH0KICB9KTsKfShiYWNrYm9uZW1hcmlvbmV0dGUpOwovKiEKICogY29sbGVjdGlvbi5qcwogKiAKICogQ29weXJpZ2h0IChjKSAyMDE0CiAqLwpfY29sbGVjdGlvbl8gPSBmdW5jdGlvbiAoQmFja2JvbmUsIE1hcmlvbmV0dGUsIEJhc2UpIHsKICAvKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIENvbGxlY3Rpb25Db21wb25lbnQKICAgKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwogIHJldHVybiBCYXNlLmV4dGVuZCh7CiAgICAvLyBEZWZhdWx0IHRvIENvbGxlY3Rpb25WaWV3CiAgICBWaWV3OiBNYXJpb25ldHRlLkNvbGxlY3Rpb25WaWV3LAogICAgQ29sbGVjdGlvbjogQmFja2JvbmUuQ29sbGVjdGlvbiwKICAgIC8qKgogICAgICogQXR0YWNoIGFuZCByZXR1cm4gb2JqZWN0IHdpdGggY29sbGVjdGlvbiBpbnN0YW5jZS4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICovCiAgICBjcmVhdGVFbnRpdGllczogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4geyBjb2xsZWN0aW9uOiB0aGlzLl9jcmVhdGVFbnRpdHkoJ2NvbGxlY3Rpb24nKSB9OwogICAgfQogIH0pOwp9KGJhY2tib25lLCBiYWNrYm9uZW1hcmlvbmV0dGUsIF9iYXNlXyk7Ci8qIQogKiBjb21wb3NpdGUuanMKICogCiAqIENvcHlyaWdodCAoYykgMjAxNAogKi8KY29tcG9zaXRlID0gZnVuY3Rpb24gKEJhY2tib25lLCBNYXJpb25ldHRlLCBCYXNlKSB7CiAgLyogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBDb21wb3NpdGVDb21wb25lbnQKICAgKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwogIHJldHVybiBCYXNlLmV4dGVuZCh7CiAgICAvLyBEZWZhdWx0IHRvIENvbXBvc2l0ZVZpZXcKICAgIFZpZXc6IE1hcmlvbmV0dGUuQ29tcG9zaXRlVmlldywKICAgIE1vZGVsOiBCYWNrYm9uZS5Nb2RlbCwKICAgIENvbGxlY3Rpb246IEJhY2tib25lLkNvbGxlY3Rpb24sCiAgICAvKioKICAgICAqIEF0dGFjaCBhbmQgcmV0dXJuIG9iamVjdCB3aXRoIGNvbGxlY3Rpb24gYW5kIG1vZGVsIGluc3RhbmNlcy4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICovCiAgICBjcmVhdGVFbnRpdGllczogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gewogICAgICAgIG1vZGVsOiB0aGlzLl9jcmVhdGVFbnRpdHkoJ21vZGVsJyksCiAgICAgICAgY29sbGVjdGlvbjogdGhpcy5fY3JlYXRlRW50aXR5KCdjb2xsZWN0aW9uJykKICAgICAgfTsKICAgIH0KICB9KTsKfShiYWNrYm9uZSwgYmFja2JvbmVtYXJpb25ldHRlLCBfYmFzZV8pOwovKiEKICogaXRlbS5qcwogKiAKICogQ29weXJpZ2h0IChjKSAyMDE0CiAqLwppdGVtID0gZnVuY3Rpb24gKEJhY2tib25lLCBNYXJpb25ldHRlLCBCYXNlKSB7CiAgLyogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBJdGVtQ29tcG9uZW50CiAgICogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICByZXR1cm4gQmFzZS5leHRlbmQoewogICAgLy8gRGVmYXVsdCB0byBJdGVtVmlldwogICAgVmlldzogTWFyaW9uZXR0ZS5JdGVtVmlldywKICAgIE1vZGVsOiBCYWNrYm9uZS5Nb2RlbCwKICAgIC8qKgogICAgICogQXR0YWNoIGFuZCByZXR1cm4gb2JqZWN0IHdpdGggbW9kZWwgaW5zdGFuY2UuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqLwogICAgY3JlYXRlRW50aXRpZXM6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIHsgbW9kZWw6IHRoaXMuX2NyZWF0ZUVudGl0eSgnbW9kZWwnKSB9OwogICAgfQogIH0pOwp9KGJhY2tib25lLCBiYWNrYm9uZW1hcmlvbmV0dGUsIF9iYXNlXyk7Ci8qIQogKiBsYXlvdXQuanMKICogCiAqIENvcHlyaWdodCAoYykgMjAxNAogKi8KbGF5b3V0ID0gZnVuY3Rpb24gKE1hcmlvbmV0dGUsIEl0ZW0pIHsKICAvKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIExheW91dENvbXBvbmVudAogICAqCiAgICogQ3VycmVudGx5IGJsYW5rIDovIE5lZWQgdG8gZGlnIHRocm91Z2ggbGF5b3V0VmlldyB0byBzZWUgcG9zc2libGUKICAgKiBpbnRlZ3JhdGlvbnMgZm9yIG1ha2luZyBpdCBlYXNpZXIgdG8gd29yayB3aXRoIHJlZ2lvbnMgZnJvbSBhIGNvbXBvbmVudC4KICAgKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwogIHJldHVybiBJdGVtLmV4dGVuZCh7CiAgICAvLyBEZWZhdWx0IHRvIExheW91dFZpZXcKICAgIFZpZXc6IE1hcmlvbmV0dGUuTGF5b3V0VmlldywKICAgIC8qKgogICAgICogU3VibGNhc3MgY29uc3RydWN0b3IgdG8gc3RvcmUgY3JlYXRlZCBjb21wb25lbnRzIHNvIHRoZXkKICAgICAqIGNhbiBiZSBpbnN0YW50aWF0ZWQgYW5kIGNsZWFuZWQgb24gZGVzdHJveS4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICogdmFyIGNvbnRyb2xsZXIgPSBuZXcgQ29tcG9uZW50KHsgVmlldzogSXRlbVZpZXcgfSk7CiAgICAgKgogICAgICogQGNvbnN0cnVjdG9yCiAgICAgKiBAcHVibGljCiAgICAgKgogICAgICogQHBhcmFtIHtvYmplY3R9IG9wdGlvbnMgLSBPYmplY3Qgb3B0aW9ucy4KICAgICAqLwogICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uICgpIHsKICAgICAgLy8gQ3JlYXRlIGFuIGVtcHR5IG9iamVjdCB0byBzdG9yZSBjcmVhdGVkIGNvbXBvbmVudHMuCiAgICAgIHRoaXMuY2hpbGRyZW4gPSB7fTsKICAgICAgLy8gQ3JlYXRlIGFuIGVtcHR5IG9iamVjdCB0byBzdG9yZSBjdXJyZW50bHkgc2hvd24KICAgICAgLy8gY29tcG9uZW50cyBpbiBlYWNoIHJlZ2lvbi4gS2V5IHJlcHJlc2VudHMgdGhlIHJlZ2lvbgogICAgICAvLyBhbmQgdmFsdWUgaXMgYSByZWZlcmVuY2UgdG8gdGhlIGNvbXBvbmVudCBzdG9yZWQgaW4KICAgICAgLy8gaW5zdGFuY2UgdmFyaWFibGUgYGNoaWxkcmVuYC4KICAgICAgdGhpcy5zaG93aW5nID0ge307CiAgICAgIEl0ZW0ucHJvdG90eXBlLmNvbnN0cnVjdG9yLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9LAogICAgLyogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAgKiBjcmVhdGUgJiBzaG93CiAgICAgKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICAgIC8qKgogICAgICogU2hvdyBhIGNvbXBvbmVudCB3aXRoaW4gYSBkZXNpZ25hdGVkIHJlZ2lvbi4KICAgICAqCiAgICAgKiBAcHVibGljCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IHJlZ2lvbk5hbWUgLSBOYW1lIG9mIHJlZ2lvbiB0byBkaXNwbGF5IGNvbXBvbmVudCB3aXRoaW4uCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gY29tcG9uZW50TmFtZSAtIE5hbWUgb2YgY29tcG9uZW50IHRvIGRpc3BsYXkgd2l0aGluIHJlZ2lvbi4KICAgICAqIEBwYXJhbSB7Y29uc3RydWN0b3J9IENvbXBvbmVudCAtIENsYXNzIG9mIGNvbXBvbmVudCB0byBpbnN0bmF0aWF0ZS4KICAgICAqIEBwYXJhbSB7b2JqZWN0fSBvcHRpb25zIC0gT3B0aW9ucyB0byBwYXNzIHRvIGNvbXBvbmVudCBhdCBpbnN0YW50aWF0aW9uLgogICAgICogQHBhcmFtIHtib29sZWFufSBwcmV2ZW50RGVzdHJveSAtIFdoZXRoZXIgb3Igbm90IHlvdSBzaG91bGQgZGVzdHJveSB0aGUKICAgICAqICAgcHJldmlvdXMgQ29tcG9uZW50LgogICAgICovCiAgICBzaG93OiBmdW5jdGlvbiAocmVnaW9uTmFtZSwgY29tcG9uZW50TmFtZSwgQ29tcG9uZW50LCBvcHRpb25zLCBwcmV2ZW50RGVzdHJveSkgewogICAgICB2YXIgcmVnaW9uID0gdGhpcy5nZXRSZWdpb24ocmVnaW9uTmFtZSk7CiAgICAgIHZhciBjdXJyZW50TmFtZSA9IHRoaXMuc2hvd2luZ1tyZWdpb25OYW1lXTsKICAgICAgdmFyIGN1cnJlbnRDb21wb25lbnQgPSByZWdpb25bY3VycmVudE5hbWVdOwogICAgICAvLyBsaWZlIGlzIGVhc3kgd2hlbiBub3RoaW5nIG5lZWRzIHRvIGNoYW5nZQogICAgICBpZiAoY3VycmVudE5hbWUgPT09IGNvbXBvbmVudE5hbWUpIHsKICAgICAgICByZXR1cm4gY3VycmVudENvbXBvbmVudDsKICAgICAgfQogICAgICAvLyBpZiBhbm90aGVyIHZpZXcgaXMgY3VycmVudGx5IGJlaW5nIHNob3cgYW5kIHdlIGRvbid0CiAgICAgIC8vIHdhbnQgdG8gcHJldmVudCBpdHMgZGVzdHJ1Y3Rpb24uLi4KICAgICAgaWYgKGN1cnJlbnROYW1lICYmICFwcmV2ZW50RGVzdHJveSkgewogICAgICAgIHRoaXMuZGVzdHJveUNoaWxkKGN1cnJlbnRDb21wb25lbnQsIHJlZ2lvbk5hbWUpOwogICAgICAgIGRlbGV0ZSByZWdpb25bY3VycmVudE5hbWVdOwogICAgICB9CiAgICAgIC8vIGlmIHdlIGRvbid0IGV4aXN0IHlldCwgd2Ugc2hvdWxkLgogICAgICBpZiAoIXJlZ2lvbltjb21wb25lbnROYW1lXSkgewogICAgICAgIHJlZ2lvbltjb21wb25lbnROYW1lXSA9IHRoaXMuY3JlYXRlQ2hpbGQoQ29tcG9uZW50LCBvcHRpb25zLCByZWdpb25OYW1lKTsKICAgICAgfQogICAgICAvLyBzaG93CiAgICAgIHRoaXMuc2hvd2luZ1tyZWdpb25OYW1lXSA9IGNvbXBvbmVudE5hbWU7CiAgICAgIHRoaXMudmlld1tyZWdpb25OYW1lXS5zaG93KHJlZ2lvbltjb21wb25lbnROYW1lXS52aWV3LCB7IHByZXZlbnREZXN0cm95OiBwcmV2ZW50RGVzdHJveSB9KTsKICAgICAgLy8gcmV0dXJuIHRoZSBuZXcgY29tcG9uZW50CiAgICAgIHJldHVybiByZWdpb25bY29tcG9uZW50TmFtZV07CiAgICB9LAogICAgLyoqCiAgICAgICAqIENyZWF0ZSBhIGNoaWxkIGNvbXBvbmVudC4gQW5kIGJpbmQgZW50aXR5IGV2ZW50cwogICAgICAgKiB0byBsYXlvdXQgY29tcG9uZW50LgogICAgICAgKgogICAgICAgKiBAcHJpdmF0ZQogICAgICAgKgogICAgICAgKiBAcGFyYW0ge2NvbnN0cnVjdG9yfSBDb21wb25lbnQgLSBDb21wb25lbnQgdG8gaW5zdGFudGlhdGUuCiAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBjb21wb25lbnROYW1lIC0gTmFtZSBvZiBjb21wb25lbnQgdG8gY3JlYXRlCiAgICAKICAgICAgICovCiAgICBjcmVhdGVDaGlsZDogZnVuY3Rpb24gKENvbXBvbmVudCwgb3B0aW9ucywgcmVnaW9uTmFtZSkgewogICAgICB2YXIgY29tcG9uZW50ID0gbmV3IENvbXBvbmVudChvcHRpb25zIHx8IHt9KTsKICAgICAgdmFyIGV2ZW50cyA9IHRoaXMuZ2V0UmVnaW9uRXZlbnRzKHJlZ2lvbk5hbWUpOwogICAgICB0aGlzLmJpbmRFbnRpdHlFdmVudHMoY29tcG9uZW50LCBldmVudHMpOwogICAgICByZXR1cm4gY29tcG9uZW50OwogICAgfSwKICAgIC8qIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgICogZW1wdHkKICAgICAqIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwogICAgLyoqCiAgICAgKiBMb29wIG92ZXIgYWxsIHJlZ2lvbnMgd2l0aCBjaGlsZHJlbiBjb21wb25lbnRzLCBhbmQgZGVzdHJveQogICAgICogY29tcG9uZW50cy9yZW1vdmUgZXZlbnQgYmluZGluZ3MuCiAgICAgKgogICAgICogQHB1YmxpYwogICAgICovCiAgICBlbXB0eTogZnVuY3Rpb24gKCkgewogICAgICBfLmVhY2godGhpcy5jaGlsZHJlbiwgZnVuY3Rpb24gKHJlZ2lvbnMsIHJlZ2lvbk5hbWUpIHsKICAgICAgICB0aGlzLmVtcHR5UmVnaW9uKHJlZ2lvbk5hbWUpOwogICAgICB9LCB0aGlzKTsKICAgIH0sCiAgICAvKioKICAgICAqIEVtcHR5IGEgZ2l2ZW4gcmVnaW9uIGJ5IG5hbWUuIElmIG5vIHJlZ2lvbiBpcyBwcm92aWRlZAogICAgICogYWxsIHJlZ2lvbnMgd2lsbCBiZSBlbXB0eS4gUHJldHR5IG11Y2gganVzdCBhIHdyYXBwZXIgYXJvdW5kCiAgICAgKiBkZXN0cm95UmVnaW9uQ2hpbGRyZW4uCiAgICAgKgogICAgICogQHB1YmxpYwogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSByZWdpb05hbWUgLSBOYW1lIG9mIHJlZ2lvbiB0byBlbXB0eQogICAgICovCiAgICBlbXB0eVJlZ2lvbjogZnVuY3Rpb24gKHJlZ2lvbk5hbWUpIHsKICAgICAgdGhpcy5kZXN0cm95UmVnaW9uQ2hpbGRyZW4odGhpcy5jaGlsZHJlbltyZWdpb25OYW1lXSwgcmVnaW9uTmFtZSk7CiAgICAgIGRlbGV0ZSB0aGlzLnNob3dpbmdbcmVnaW9uTmFtZV07CiAgICB9LAogICAgLyogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAgKiBkZXN0cm95CiAgICAgKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICAgIC8qKgogICAgICogQ2FsbGVkIG9uIGNvbnRyb2xsZXIgZGVzdHJveS4gVXNlZCB0byBkZXN0cm95IGNoaWxkcmVuCiAgICAgKiBjb21wb25lbnRzIGFuZCBjbGVhbiB1cCBhbnkgYm91bmQgZXZlbnRzLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKi8KICAgIGRlc3Ryb3k6IGZ1bmN0aW9uICgpIHsKICAgICAgXy5lYWNoKHRoaXMuY2hpbGRyZW4sIHRoaXMuZGVzdHJveVJlZ2lvbkNoaWxkcmVuLCB0aGlzKTsKICAgICAgSXRlbS5wcm90b3R5cGUuZGVzdHJveS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfSwKICAgIC8qKgogICAgICogRGVzdHJveSBhbGwgY29tcG9uZW50cyBpbiBhIGdpdmVuIHJlZ2lvbi4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICoKICAgICAqIEBwYXJhbSB7b2JqZWN0fSByZWdpb24gLSBjaGlsZHJlbiByZWdpb24gb2JqZWN0LgogICAgICogQHBhcmFtIHtzdHJpbmd9IHJlZ2lvbk5hbWUgLSBOYW1lIG9mIHJlZ2lvbiB0byBkZXN0cm95LgogICAgICovCiAgICBkZXN0cm95UmVnaW9uQ2hpbGRyZW46IGZ1bmN0aW9uIChyZWdpb24sIHJlZ2lvbk5hbWUpIHsKICAgICAgXy5lYWNoKHJlZ2lvbiwgZnVuY3Rpb24gKGNvbXBvbmVudCwgY29tcG9uZW50TmFtZSkgewogICAgICAgIHRoaXMuZGVzdHJveUNoaWxkKGNvbXBvbmVudCwgcmVnaW9uTmFtZSk7CiAgICAgIH0sIHRoaXMpOwogICAgICBkZWxldGUgdGhpcy5jaGlsZHJlbltyZWdpb25OYW1lXTsKICAgIH0sCiAgICAvKioKICAgICAqIERlc3Ryb3kgYSBjaGlsZCBjb21wb25lbnQuIEFuZCB1bmJpbmQgZW50aXR5IGV2ZW50cwogICAgICogZnJvbSBsYXlvdXQgY29tcG9uZW50LgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKgogICAgICogQHBhcmFtIHtvYmplY3R9IGNvbXBvbmVudCAtIGNvbXBvbmVudCB0byBkZXN0cm95LgogICAgICogQHBhcmFtIHtzdHJpbmd9IGNvbXBvbmVudE5hbWUgLSBOYW1lIG9mIGNvbXBvbmVudCB0byBkZXN0cm95LgogICAgICogQHBhcmFtIHtzdHJpbmd9IHJlZ2lvbk5hbWUgLSBOYW1lIG9mIHJlZ2lvbiB1c2VkIHRvIHVuYmluZCBjb21wb25lbnQKICAgICAqICAgZXZlbnRzLgogICAgICovCiAgICBkZXN0cm95Q2hpbGQ6IGZ1bmN0aW9uIChjb21wb25lbnQsIHJlZ2lvbk5hbWUpIHsKICAgICAgdmFyIGV2ZW50cyA9IHRoaXMuZ2V0UmVnaW9uRXZlbnRzKHJlZ2lvbk5hbWUpOwogICAgICB0aGlzLnVuYmluZEVudGl0eUV2ZW50cyhjb21wb25lbnQsIGV2ZW50cyk7CiAgICAgIGNvbXBvbmVudC5kZXN0cm95KCk7CiAgICB9LAogICAgLyogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAgKiB1dGlscwogICAgICogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAgICAvKioKICAgICAqIFJldHVybiB0aGUgY29tcG9uZW50IGJlaW5nIHNob3cgaW4gYSBnaXZlbiByZWdpb24uCiAgICAgKgogICAgICogQHB1YmxpYwogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSByZWdpb25OYW1lIC0gTmFtZSBvZiByZWdpb24gdG8gZ3JhYiBjdXJyZW50IHNob3duCiAgICAgKiAgIGNvbXBvbmVudCBmcm9tLgogICAgICovCiAgICBzaG93aW5nSW46IGZ1bmN0aW9uIChyZWdpb25OYW1lKSB7CiAgICAgIHZhciBjb21wb25lbnROYW1lID0gdGhpcy5zaG93aW5nW3JlZ2lvbk5hbWVdOwogICAgICByZXR1cm4gdGhpcy5jaGlsZHJlbltyZWdpb25OYW1lXVtjb21wb25lbnROYW1lXTsKICAgIH0sCiAgICAvKioKICAgICAqIFJldHVybiBldmVudHMgaGFzaCBmb3IgZ2l2ZW4gCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gcmVnaW9uTmFtZSAtIEdldCBldmVudHMgaGFzaCBmb3IgYSBnaXZlbiByZWdpb24uCiAgICAgKi8KICAgIGdldFJlZ2lvbkV2ZW50czogZnVuY3Rpb24gKHJlZ2lvbk5hbWUpIHsKICAgICAgcmV0dXJuIHRoaXMuZ2V0T3B0aW9uKHJlZ2lvbk5hbWUgKyAnRXZlbnRzJyk7CiAgICB9LAogICAgLyoqCiAgICAgKiBHZXQgcmVnaW9uIGNvbnRlbnRzIGZyb20gY2hpbGRyZW4uIElmIG5vIHJlZ2lvbiBleGlzdHMKICAgICAqIHNldCBhbmQgcmV0dXJuIGVtcHR5IG9iamVjdC4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSByZWdpb25OYW1lIC0gTmFtZSBvZiByZWdpb24gdG8gcmV0dXJuIGNoaWxkcmVuCiAgICAgKiAgIGNvbnRlbnRzIGZyb20uCiAgICAgKi8KICAgIGdldFJlZ2lvbjogZnVuY3Rpb24gKHJlZ2lvbk5hbWUpIHsKICAgICAgdmFyIHJlZ2lvbiA9IHRoaXMuY2hpbGRyZW5bcmVnaW9uTmFtZV0gPSB0aGlzLmNoaWxkcmVuW3JlZ2lvbk5hbWVdIHx8IHt9OwogICAgICByZXR1cm4gcmVnaW9uOwogICAgfQogIH0pOwp9KGJhY2tib25lbWFyaW9uZXR0ZSwgaXRlbSk7Ci8qIQogKiBtYXJpb25ldHRlLmNvbXBvbmVudHMuanMKICogCiAqIENvcHlyaWdodCAoYykgMjAxNAogKi8KbWFyaW9uZXR0ZWNvbXBvbmVudHMgPSBmdW5jdGlvbiAoQmFzZSwgQ29sbGVjdGlvbiwgQ29tcG9zaXRlLCBJdGVtLCBMYXlvdXQpIHsKICAvKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIG1hcmlvbmV0dGUuY29tcG9uZW50cwogICAqIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAgcmV0dXJuIHsKICAgIEJhc2VDb21wb25lbnQ6IEJhc2UsCiAgICBDb2xsZWN0aW9uQ29tcG9uZW50OiBDb2xsZWN0aW9uLAogICAgQ29tcG9zaXRlQ29tcG9uZW50OiBDb21wb3NpdGUsCiAgICBJdGVtQ29tcG9uZW50OiBJdGVtLAogICAgTGF5b3V0Q29tcG9uZW50OiBMYXlvdXQKICB9Owp9KF9iYXNlXywgX2NvbGxlY3Rpb25fLCBjb21wb3NpdGUsIGl0ZW0sIGxheW91dCk7CgpyZXR1cm4gbWFyaW9uZXR0ZUNvbXBvbmVudHM7CgoKfSkpOw==",
                "body": "KGZ1bmN0aW9uIChyb290LCBmYWN0b3J5KSB7CiAgaWYgKHR5cGVvZiBkZWZpbmUgPT09ICdmdW5jdGlvbicgJiYgZGVmaW5lLmFtZCkgewogICAgLy8gQU1ELiBSZWdpc3RlciBhcyBhbiBhbm9ueW1vdXMgbW9kdWxlLgogICAgZGVmaW5lKFtdLCBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiAocm9vdC5yZXR1cm5FeHBvcnRzR2xvYmFsID0gZmFjdG9yeSgpKTsKICAgIH0pOwogIH0gZWxzZSBpZiAodHlwZW9mIGV4cG9ydHMgPT09ICdvYmplY3QnKSB7CiAgICAvLyBOb2RlLiBEb2VzIG5vdCB3b3JrIHdpdGggc3RyaWN0IENvbW1vbkpTLCBidXQKICAgIC8vIG9ubHkgQ29tbW9uSlMtbGlrZSBlbnZpcm9tZW50cyB0aGF0IHN1cHBvcnQgbW9kdWxlLmV4cG9ydHMsCiAgICAvLyBsaWtlIE5vZGUuCiAgICBtb2R1bGUuZXhwb3J0cyA9IGZhY3RvcnkoKTsKICB9IGVsc2UgewogICAgcm9vdFsnTWFyaW9uZXR0ZUNvbXBvbmVudHMnXSA9IGZhY3RvcnkoKTsKICB9Cn0odGhpcywgZnVuY3Rpb24gKCkgewoKLy8gICAgIFVuZGVyc2NvcmUuanMgMS42LjAKLy8gICAgIGh0dHA6Ly91bmRlcnNjb3JlanMub3JnCi8vICAgICAoYykgMjAwOS0yMDE0IEplcmVteSBBc2hrZW5hcywgRG9jdW1lbnRDbG91ZCBhbmQgSW52ZXN0aWdhdGl2ZSBSZXBvcnRlcnMgJiBFZGl0b3JzCi8vICAgICBVbmRlcnNjb3JlIG1heSBiZSBmcmVlbHkgZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLgp2YXIgdW5kZXJzY29yZSwganF1ZXJ5LCBiYWNrYm9uZSwgYmFja2JvbmV3cmVxciwgYmFja2JvbmViYWJ5c2l0dGVyLCBiYWNrYm9uZW1hcmlvbmV0dGUsIF9iYXNlXywgX2NvbGxlY3Rpb25fLCBjb21wb3NpdGUsIGl0ZW0sIGxheW91dCwgbWFyaW9uZXR0ZWNvbXBvbmVudHM7CihmdW5jdGlvbiAoKSB7CiAgLy8gQmFzZWxpbmUgc2V0dXAKICAvLyAtLS0tLS0tLS0tLS0tLQogIC8vIEVzdGFibGlzaCB0aGUgcm9vdCBvYmplY3QsIGB3aW5kb3dgIGluIHRoZSBicm93c2VyLCBvciBgZXhwb3J0c2Agb24gdGhlIHNlcnZlci4KICB2YXIgcm9vdCA9IHRoaXM7CiAgLy8gU2F2ZSB0aGUgcHJldmlvdXMgdmFsdWUgb2YgdGhlIGBfYCB2YXJpYWJsZS4KICB2YXIgcHJldmlvdXNVbmRlcnNjb3JlID0gcm9vdC5fOwogIC8vIEVzdGFibGlzaCB0aGUgb2JqZWN0IHRoYXQgZ2V0cyByZXR1cm5lZCB0byBicmVhayBvdXQgb2YgYSBsb29wIGl0ZXJhdGlvbi4KICB2YXIgYnJlYWtlciA9IHt9OwogIC8vIFNhdmUgYnl0ZXMgaW4gdGhlIG1pbmlmaWVkIChidXQgbm90IGd6aXBwZWQpIHZlcnNpb246CiAgdmFyIEFycmF5UHJvdG8gPSBBcnJheS5wcm90b3R5cGUsIE9ialByb3RvID0gT2JqZWN0LnByb3RvdHlwZSwgRnVuY1Byb3RvID0gRnVuY3Rpb24ucHJvdG90eXBlOwogIC8vIENyZWF0ZSBxdWljayByZWZlcmVuY2UgdmFyaWFibGVzIGZvciBzcGVlZCBhY2Nlc3MgdG8gY29yZSBwcm90b3R5cGVzLgogIHZhciBwdXNoID0gQXJyYXlQcm90by5wdXNoLCBzbGljZSA9IEFycmF5UHJvdG8uc2xpY2UsIGNvbmNhdCA9IEFycmF5UHJvdG8uY29uY2F0LCB0b1N0cmluZyA9IE9ialByb3RvLnRvU3RyaW5nLCBoYXNPd25Qcm9wZXJ0eSA9IE9ialByb3RvLmhhc093blByb3BlcnR5OwogIC8vIEFsbCAqKkVDTUFTY3JpcHQgNSoqIG5hdGl2ZSBmdW5jdGlvbiBpbXBsZW1lbnRhdGlvbnMgdGhhdCB3ZSBob3BlIHRvIHVzZQogIC8vIGFyZSBkZWNsYXJlZCBoZXJlLgogIHZhciBuYXRpdmVGb3JFYWNoID0gQXJyYXlQcm90by5mb3JFYWNoLCBuYXRpdmVNYXAgPSBBcnJheVByb3RvLm1hcCwgbmF0aXZlUmVkdWNlID0gQXJyYXlQcm90by5yZWR1Y2UsIG5hdGl2ZVJlZHVjZVJpZ2h0ID0gQXJyYXlQcm90by5yZWR1Y2VSaWdodCwgbmF0aXZlRmlsdGVyID0gQXJyYXlQcm90by5maWx0ZXIsIG5hdGl2ZUV2ZXJ5ID0gQXJyYXlQcm90by5ldmVyeSwgbmF0aXZlU29tZSA9IEFycmF5UHJvdG8uc29tZSwgbmF0aXZlSW5kZXhPZiA9IEFycmF5UHJvdG8uaW5kZXhPZiwgbmF0aXZlTGFzdEluZGV4T2YgPSBBcnJheVByb3RvLmxhc3RJbmRleE9mLCBuYXRpdmVJc0FycmF5ID0gQXJyYXkuaXNBcnJheSwgbmF0aXZlS2V5cyA9IE9iamVjdC5rZXlzLCBuYXRpdmVCaW5kID0gRnVuY1Byb3RvLmJpbmQ7CiAgLy8gQ3JlYXRlIGEgc2FmZSByZWZlcmVuY2UgdG8gdGhlIFVuZGVyc2NvcmUgb2JqZWN0IGZvciB1c2UgYmVsb3cuCiAgdmFyIF8gPSBmdW5jdGlvbiAob2JqKSB7CiAgICBpZiAob2JqIGluc3RhbmNlb2YgXykKICAgICAgcmV0dXJuIG9iajsKICAgIGlmICghKHRoaXMgaW5zdGFuY2VvZiBfKSkKICAgICAgcmV0dXJuIG5ldyBfKG9iaik7CiAgICB0aGlzLl93cmFwcGVkID0gb2JqOwogIH07CiAgLy8gRXhwb3J0IHRoZSBVbmRlcnNjb3JlIG9iamVjdCBmb3IgKipOb2RlLmpzKiosIHdpdGgKICAvLyBiYWNrd2FyZHMtY29tcGF0aWJpbGl0eSBmb3IgdGhlIG9sZCBgcmVxdWlyZSgpYCBBUEkuIElmIHdlJ3JlIGluCiAgLy8gdGhlIGJyb3dzZXIsIGFkZCBgX2AgYXMgYSBnbG9iYWwgb2JqZWN0IHZpYSBhIHN0cmluZyBpZGVudGlmaWVyLAogIC8vIGZvciBDbG9zdXJlIENvbXBpbGVyICJhZHZhbmNlZCIgbW9kZS4KICBpZiAodHlwZW9mIGV4cG9ydHMgIT09ICd1bmRlZmluZWQnKSB7CiAgICBpZiAodHlwZW9mIG1vZHVsZSAhPT0gJ3VuZGVmaW5lZCcgJiYgbW9kdWxlLmV4cG9ydHMpIHsKICAgICAgZXhwb3J0cyA9IG1vZHVsZS5leHBvcnRzID0gXzsKICAgIH0KICAgIGV4cG9ydHMuXyA9IF87CiAgfSBlbHNlIHsKICAgIHJvb3QuXyA9IF87CiAgfQogIC8vIEN1cnJlbnQgdmVyc2lvbi4KICBfLlZFUlNJT04gPSAnMS42LjAnOwogIC8vIENvbGxlY3Rpb24gRnVuY3Rpb25zCiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAvLyBUaGUgY29ybmVyc3RvbmUsIGFuIGBlYWNoYCBpbXBsZW1lbnRhdGlvbiwgYWthIGBmb3JFYWNoYC4KICAvLyBIYW5kbGVzIG9iamVjdHMgd2l0aCB0aGUgYnVpbHQtaW4gYGZvckVhY2hgLCBhcnJheXMsIGFuZCByYXcgb2JqZWN0cy4KICAvLyBEZWxlZ2F0ZXMgdG8gKipFQ01BU2NyaXB0IDUqKidzIG5hdGl2ZSBgZm9yRWFjaGAgaWYgYXZhaWxhYmxlLgogIHZhciBlYWNoID0gXy5lYWNoID0gXy5mb3JFYWNoID0gZnVuY3Rpb24gKG9iaiwgaXRlcmF0b3IsIGNvbnRleHQpIHsKICAgIGlmIChvYmogPT0gbnVsbCkKICAgICAgcmV0dXJuIG9iajsKICAgIGlmIChuYXRpdmVGb3JFYWNoICYmIG9iai5mb3JFYWNoID09PSBuYXRpdmVGb3JFYWNoKSB7CiAgICAgIG9iai5mb3JFYWNoKGl0ZXJhdG9yLCBjb250ZXh0KTsKICAgIH0gZWxzZSBpZiAob2JqLmxlbmd0aCA9PT0gK29iai5sZW5ndGgpIHsKICAgICAgZm9yICh2YXIgaSA9IDAsIGxlbmd0aCA9IG9iai5sZW5ndGg7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgIGlmIChpdGVyYXRvci5jYWxsKGNvbnRleHQsIG9ialtpXSwgaSwgb2JqKSA9PT0gYnJlYWtlcikKICAgICAgICAgIHJldHVybjsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgdmFyIGtleXMgPSBfLmtleXMob2JqKTsKICAgICAgZm9yICh2YXIgaSA9IDAsIGxlbmd0aCA9IGtleXMubGVuZ3RoOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICBpZiAoaXRlcmF0b3IuY2FsbChjb250ZXh0LCBvYmpba2V5c1tpXV0sIGtleXNbaV0sIG9iaikgPT09IGJyZWFrZXIpCiAgICAgICAgICByZXR1cm47CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBvYmo7CiAgfTsKICAvLyBSZXR1cm4gdGhlIHJlc3VsdHMgb2YgYXBwbHlpbmcgdGhlIGl0ZXJhdG9yIHRvIGVhY2ggZWxlbWVudC4KICAvLyBEZWxlZ2F0ZXMgdG8gKipFQ01BU2NyaXB0IDUqKidzIG5hdGl2ZSBgbWFwYCBpZiBhdmFpbGFibGUuCiAgXy5tYXAgPSBfLmNvbGxlY3QgPSBmdW5jdGlvbiAob2JqLCBpdGVyYXRvciwgY29udGV4dCkgewogICAgdmFyIHJlc3VsdHMgPSBbXTsKICAgIGlmIChvYmogPT0gbnVsbCkKICAgICAgcmV0dXJuIHJlc3VsdHM7CiAgICBpZiAobmF0aXZlTWFwICYmIG9iai5tYXAgPT09IG5hdGl2ZU1hcCkKICAgICAgcmV0dXJuIG9iai5tYXAoaXRlcmF0b3IsIGNvbnRleHQpOwogICAgZWFjaChvYmosIGZ1bmN0aW9uICh2YWx1ZSwgaW5kZXgsIGxpc3QpIHsKICAgICAgcmVzdWx0cy5wdXNoKGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgdmFsdWUsIGluZGV4LCBsaXN0KSk7CiAgICB9KTsKICAgIHJldHVybiByZXN1bHRzOwogIH07CiAgdmFyIHJlZHVjZUVycm9yID0gJ1JlZHVjZSBvZiBlbXB0eSBhcnJheSB3aXRoIG5vIGluaXRpYWwgdmFsdWUnOwogIC8vICoqUmVkdWNlKiogYnVpbGRzIHVwIGEgc2luZ2xlIHJlc3VsdCBmcm9tIGEgbGlzdCBvZiB2YWx1ZXMsIGFrYSBgaW5qZWN0YCwKICAvLyBvciBgZm9sZGxgLiBEZWxlZ2F0ZXMgdG8gKipFQ01BU2NyaXB0IDUqKidzIG5hdGl2ZSBgcmVkdWNlYCBpZiBhdmFpbGFibGUuCiAgXy5yZWR1Y2UgPSBfLmZvbGRsID0gXy5pbmplY3QgPSBmdW5jdGlvbiAob2JqLCBpdGVyYXRvciwgbWVtbywgY29udGV4dCkgewogICAgdmFyIGluaXRpYWwgPSBhcmd1bWVudHMubGVuZ3RoID4gMjsKICAgIGlmIChvYmogPT0gbnVsbCkKICAgICAgb2JqID0gW107CiAgICBpZiAobmF0aXZlUmVkdWNlICYmIG9iai5yZWR1Y2UgPT09IG5hdGl2ZVJlZHVjZSkgewogICAgICBpZiAoY29udGV4dCkKICAgICAgICBpdGVyYXRvciA9IF8uYmluZChpdGVyYXRvciwgY29udGV4dCk7CiAgICAgIHJldHVybiBpbml0aWFsID8gb2JqLnJlZHVjZShpdGVyYXRvciwgbWVtbykgOiBvYmoucmVkdWNlKGl0ZXJhdG9yKTsKICAgIH0KICAgIGVhY2gob2JqLCBmdW5jdGlvbiAodmFsdWUsIGluZGV4LCBsaXN0KSB7CiAgICAgIGlmICghaW5pdGlhbCkgewogICAgICAgIG1lbW8gPSB2YWx1ZTsKICAgICAgICBpbml0aWFsID0gdHJ1ZTsKICAgICAgfSBlbHNlIHsKICAgICAgICBtZW1vID0gaXRlcmF0b3IuY2FsbChjb250ZXh0LCBtZW1vLCB2YWx1ZSwgaW5kZXgsIGxpc3QpOwogICAgICB9CiAgICB9KTsKICAgIGlmICghaW5pdGlhbCkKICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihyZWR1Y2VFcnJvcik7CiAgICByZXR1cm4gbWVtbzsKICB9OwogIC8vIFRoZSByaWdodC1hc3NvY2lhdGl2ZSB2ZXJzaW9uIG9mIHJlZHVjZSwgYWxzbyBrbm93biBhcyBgZm9sZHJgLgogIC8vIERlbGVnYXRlcyB0byAqKkVDTUFTY3JpcHQgNSoqJ3MgbmF0aXZlIGByZWR1Y2VSaWdodGAgaWYgYXZhaWxhYmxlLgogIF8ucmVkdWNlUmlnaHQgPSBfLmZvbGRyID0gZnVuY3Rpb24gKG9iaiwgaXRlcmF0b3IsIG1lbW8sIGNvbnRleHQpIHsKICAgIHZhciBpbml0aWFsID0gYXJndW1lbnRzLmxlbmd0aCA+IDI7CiAgICBpZiAob2JqID09IG51bGwpCiAgICAgIG9iaiA9IFtdOwogICAgaWYgKG5hdGl2ZVJlZHVjZVJpZ2h0ICYmIG9iai5yZWR1Y2VSaWdodCA9PT0gbmF0aXZlUmVkdWNlUmlnaHQpIHsKICAgICAgaWYgKGNvbnRleHQpCiAgICAgICAgaXRlcmF0b3IgPSBfLmJpbmQoaXRlcmF0b3IsIGNvbnRleHQpOwogICAgICByZXR1cm4gaW5pdGlhbCA/IG9iai5yZWR1Y2VSaWdodChpdGVyYXRvciwgbWVtbykgOiBvYmoucmVkdWNlUmlnaHQoaXRlcmF0b3IpOwogICAgfQogICAgdmFyIGxlbmd0aCA9IG9iai5sZW5ndGg7CiAgICBpZiAobGVuZ3RoICE9PSArbGVuZ3RoKSB7CiAgICAgIHZhciBrZXlzID0gXy5rZXlzKG9iaik7CiAgICAgIGxlbmd0aCA9IGtleXMubGVuZ3RoOwogICAgfQogICAgZWFjaChvYmosIGZ1bmN0aW9uICh2YWx1ZSwgaW5kZXgsIGxpc3QpIHsKICAgICAgaW5kZXggPSBrZXlzID8ga2V5c1stLWxlbmd0aF0gOiAtLWxlbmd0aDsKICAgICAgaWYgKCFpbml0aWFsKSB7CiAgICAgICAgbWVtbyA9IG9ialtpbmRleF07CiAgICAgICAgaW5pdGlhbCA9IHRydWU7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgbWVtbyA9IGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgbWVtbywgb2JqW2luZGV4XSwgaW5kZXgsIGxpc3QpOwogICAgICB9CiAgICB9KTsKICAgIGlmICghaW5pdGlhbCkKICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihyZWR1Y2VFcnJvcik7CiAgICByZXR1cm4gbWVtbzsKICB9OwogIC8vIFJldHVybiB0aGUgZmlyc3QgdmFsdWUgd2hpY2ggcGFzc2VzIGEgdHJ1dGggdGVzdC4gQWxpYXNlZCBhcyBgZGV0ZWN0YC4KICBfLmZpbmQgPSBfLmRldGVjdCA9IGZ1bmN0aW9uIChvYmosIHByZWRpY2F0ZSwgY29udGV4dCkgewogICAgdmFyIHJlc3VsdDsKICAgIGFueShvYmosIGZ1bmN0aW9uICh2YWx1ZSwgaW5kZXgsIGxpc3QpIHsKICAgICAgaWYgKHByZWRpY2F0ZS5jYWxsKGNvbnRleHQsIHZhbHVlLCBpbmRleCwgbGlzdCkpIHsKICAgICAgICByZXN1bHQgPSB2YWx1ZTsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgfSk7CiAgICByZXR1cm4gcmVzdWx0OwogIH07CiAgLy8gUmV0dXJuIGFsbCB0aGUgZWxlbWVudHMgdGhhdCBwYXNzIGEgdHJ1dGggdGVzdC4KICAvLyBEZWxlZ2F0ZXMgdG8gKipFQ01BU2NyaXB0IDUqKidzIG5hdGl2ZSBgZmlsdGVyYCBpZiBhdmFpbGFibGUuCiAgLy8gQWxpYXNlZCBhcyBgc2VsZWN0YC4KICBfLmZpbHRlciA9IF8uc2VsZWN0ID0gZnVuY3Rpb24gKG9iaiwgcHJlZGljYXRlLCBjb250ZXh0KSB7CiAgICB2YXIgcmVzdWx0cyA9IFtdOwogICAgaWYgKG9iaiA9PSBudWxsKQogICAgICByZXR1cm4gcmVzdWx0czsKICAgIGlmIChuYXRpdmVGaWx0ZXIgJiYgb2JqLmZpbHRlciA9PT0gbmF0aXZlRmlsdGVyKQogICAgICByZXR1cm4gb2JqLmZpbHRlcihwcmVkaWNhdGUsIGNvbnRleHQpOwogICAgZWFjaChvYmosIGZ1bmN0aW9uICh2YWx1ZSwgaW5kZXgsIGxpc3QpIHsKICAgICAgaWYgKHByZWRpY2F0ZS5jYWxsKGNvbnRleHQsIHZhbHVlLCBpbmRleCwgbGlzdCkpCiAgICAgICAgcmVzdWx0cy5wdXNoKHZhbHVlKTsKICAgIH0pOwogICAgcmV0dXJuIHJlc3VsdHM7CiAgfTsKICAvLyBSZXR1cm4gYWxsIHRoZSBlbGVtZW50cyBmb3Igd2hpY2ggYSB0cnV0aCB0ZXN0IGZhaWxzLgogIF8ucmVqZWN0ID0gZnVuY3Rpb24gKG9iaiwgcHJlZGljYXRlLCBjb250ZXh0KSB7CiAgICByZXR1cm4gXy5maWx0ZXIob2JqLCBmdW5jdGlvbiAodmFsdWUsIGluZGV4LCBsaXN0KSB7CiAgICAgIHJldHVybiAhcHJlZGljYXRlLmNhbGwoY29udGV4dCwgdmFsdWUsIGluZGV4LCBsaXN0KTsKICAgIH0sIGNvbnRleHQpOwogIH07CiAgLy8gRGV0ZXJtaW5lIHdoZXRoZXIgYWxsIG9mIHRoZSBlbGVtZW50cyBtYXRjaCBhIHRydXRoIHRlc3QuCiAgLy8gRGVsZWdhdGVzIHRvICoqRUNNQVNjcmlwdCA1KioncyBuYXRpdmUgYGV2ZXJ5YCBpZiBhdmFpbGFibGUuCiAgLy8gQWxpYXNlZCBhcyBgYWxsYC4KICBfLmV2ZXJ5ID0gXy5hbGwgPSBmdW5jdGlvbiAob2JqLCBwcmVkaWNhdGUsIGNvbnRleHQpIHsKICAgIHByZWRpY2F0ZSB8fCAocHJlZGljYXRlID0gXy5pZGVudGl0eSk7CiAgICB2YXIgcmVzdWx0ID0gdHJ1ZTsKICAgIGlmIChvYmogPT0gbnVsbCkKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIGlmIChuYXRpdmVFdmVyeSAmJiBvYmouZXZlcnkgPT09IG5hdGl2ZUV2ZXJ5KQogICAgICByZXR1cm4gb2JqLmV2ZXJ5KHByZWRpY2F0ZSwgY29udGV4dCk7CiAgICBlYWNoKG9iaiwgZnVuY3Rpb24gKHZhbHVlLCBpbmRleCwgbGlzdCkgewogICAgICBpZiAoIShyZXN1bHQgPSByZXN1bHQgJiYgcHJlZGljYXRlLmNhbGwoY29udGV4dCwgdmFsdWUsIGluZGV4LCBsaXN0KSkpCiAgICAgICAgcmV0dXJuIGJyZWFrZXI7CiAgICB9KTsKICAgIHJldHVybiAhIXJlc3VsdDsKICB9OwogIC8vIERldGVybWluZSBpZiBhdCBsZWFzdCBvbmUgZWxlbWVudCBpbiB0aGUgb2JqZWN0IG1hdGNoZXMgYSB0cnV0aCB0ZXN0LgogIC8vIERlbGVnYXRlcyB0byAqKkVDTUFTY3JpcHQgNSoqJ3MgbmF0aXZlIGBzb21lYCBpZiBhdmFpbGFibGUuCiAgLy8gQWxpYXNlZCBhcyBgYW55YC4KICB2YXIgYW55ID0gXy5zb21lID0gXy5hbnkgPSBmdW5jdGlvbiAob2JqLCBwcmVkaWNhdGUsIGNvbnRleHQpIHsKICAgIHByZWRpY2F0ZSB8fCAocHJlZGljYXRlID0gXy5pZGVudGl0eSk7CiAgICB2YXIgcmVzdWx0ID0gZmFsc2U7CiAgICBpZiAob2JqID09IG51bGwpCiAgICAgIHJldHVybiByZXN1bHQ7CiAgICBpZiAobmF0aXZlU29tZSAmJiBvYmouc29tZSA9PT0gbmF0aXZlU29tZSkKICAgICAgcmV0dXJuIG9iai5zb21lKHByZWRpY2F0ZSwgY29udGV4dCk7CiAgICBlYWNoKG9iaiwgZnVuY3Rpb24gKHZhbHVlLCBpbmRleCwgbGlzdCkgewogICAgICBpZiAocmVzdWx0IHx8IChyZXN1bHQgPSBwcmVkaWNhdGUuY2FsbChjb250ZXh0LCB2YWx1ZSwgaW5kZXgsIGxpc3QpKSkKICAgICAgICByZXR1cm4gYnJlYWtlcjsKICAgIH0pOwogICAgcmV0dXJuICEhcmVzdWx0OwogIH07CiAgLy8gRGV0ZXJtaW5lIGlmIHRoZSBhcnJheSBvciBvYmplY3QgY29udGFpbnMgYSBnaXZlbiB2YWx1ZSAodXNpbmcgYD09PWApLgogIC8vIEFsaWFzZWQgYXMgYGluY2x1ZGVgLgogIF8uY29udGFpbnMgPSBfLmluY2x1ZGUgPSBmdW5jdGlvbiAob2JqLCB0YXJnZXQpIHsKICAgIGlmIChvYmogPT0gbnVsbCkKICAgICAgcmV0dXJuIGZhbHNlOwogICAgaWYgKG5hdGl2ZUluZGV4T2YgJiYgb2JqLmluZGV4T2YgPT09IG5hdGl2ZUluZGV4T2YpCiAgICAgIHJldHVybiBvYmouaW5kZXhPZih0YXJnZXQpICE9IC0xOwogICAgcmV0dXJuIGFueShvYmosIGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICByZXR1cm4gdmFsdWUgPT09IHRhcmdldDsKICAgIH0pOwogIH07CiAgLy8gSW52b2tlIGEgbWV0aG9kICh3aXRoIGFyZ3VtZW50cykgb24gZXZlcnkgaXRlbSBpbiBhIGNvbGxlY3Rpb24uCiAgXy5pbnZva2UgPSBmdW5jdGlvbiAob2JqLCBtZXRob2QpIHsKICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDIpOwogICAgdmFyIGlzRnVuYyA9IF8uaXNGdW5jdGlvbihtZXRob2QpOwogICAgcmV0dXJuIF8ubWFwKG9iaiwgZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgIHJldHVybiAoaXNGdW5jID8gbWV0aG9kIDogdmFsdWVbbWV0aG9kXSkuYXBwbHkodmFsdWUsIGFyZ3MpOwogICAgfSk7CiAgfTsKICAvLyBDb252ZW5pZW5jZSB2ZXJzaW9uIG9mIGEgY29tbW9uIHVzZSBjYXNlIG9mIGBtYXBgOiBmZXRjaGluZyBhIHByb3BlcnR5LgogIF8ucGx1Y2sgPSBmdW5jdGlvbiAob2JqLCBrZXkpIHsKICAgIHJldHVybiBfLm1hcChvYmosIF8ucHJvcGVydHkoa2V5KSk7CiAgfTsKICAvLyBDb252ZW5pZW5jZSB2ZXJzaW9uIG9mIGEgY29tbW9uIHVzZSBjYXNlIG9mIGBmaWx0ZXJgOiBzZWxlY3Rpbmcgb25seSBvYmplY3RzCiAgLy8gY29udGFpbmluZyBzcGVjaWZpYyBga2V5OnZhbHVlYCBwYWlycy4KICBfLndoZXJlID0gZnVuY3Rpb24gKG9iaiwgYXR0cnMpIHsKICAgIHJldHVybiBfLmZpbHRlcihvYmosIF8ubWF0Y2hlcyhhdHRycykpOwogIH07CiAgLy8gQ29udmVuaWVuY2UgdmVyc2lvbiBvZiBhIGNvbW1vbiB1c2UgY2FzZSBvZiBgZmluZGA6IGdldHRpbmcgdGhlIGZpcnN0IG9iamVjdAogIC8vIGNvbnRhaW5pbmcgc3BlY2lmaWMgYGtleTp2YWx1ZWAgcGFpcnMuCiAgXy5maW5kV2hlcmUgPSBmdW5jdGlvbiAob2JqLCBhdHRycykgewogICAgcmV0dXJuIF8uZmluZChvYmosIF8ubWF0Y2hlcyhhdHRycykpOwogIH07CiAgLy8gUmV0dXJuIHRoZSBtYXhpbXVtIGVsZW1lbnQgb3IgKGVsZW1lbnQtYmFzZWQgY29tcHV0YXRpb24pLgogIC8vIENhbid0IG9wdGltaXplIGFycmF5cyBvZiBpbnRlZ2VycyBsb25nZXIgdGhhbiA2NSw1MzUgZWxlbWVudHMuCiAgLy8gU2VlIFtXZWJLaXQgQnVnIDgwNzk3XShodHRwczovL2J1Z3Mud2Via2l0Lm9yZy9zaG93X2J1Zy5jZ2k/aWQ9ODA3OTcpCiAgXy5tYXggPSBmdW5jdGlvbiAob2JqLCBpdGVyYXRvciwgY29udGV4dCkgewogICAgaWYgKCFpdGVyYXRvciAmJiBfLmlzQXJyYXkob2JqKSAmJiBvYmpbMF0gPT09ICtvYmpbMF0gJiYgb2JqLmxlbmd0aCA8IDY1NTM1KSB7CiAgICAgIHJldHVybiBNYXRoLm1heC5hcHBseShNYXRoLCBvYmopOwogICAgfQogICAgdmFyIHJlc3VsdCA9IC1JbmZpbml0eSwgbGFzdENvbXB1dGVkID0gLUluZmluaXR5OwogICAgZWFjaChvYmosIGZ1bmN0aW9uICh2YWx1ZSwgaW5kZXgsIGxpc3QpIHsKICAgICAgdmFyIGNvbXB1dGVkID0gaXRlcmF0b3IgPyBpdGVyYXRvci5jYWxsKGNvbnRleHQsIHZhbHVlLCBpbmRleCwgbGlzdCkgOiB2YWx1ZTsKICAgICAgaWYgKGNvbXB1dGVkID4gbGFzdENvbXB1dGVkKSB7CiAgICAgICAgcmVzdWx0ID0gdmFsdWU7CiAgICAgICAgbGFzdENvbXB1dGVkID0gY29tcHV0ZWQ7CiAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuIHJlc3VsdDsKICB9OwogIC8vIFJldHVybiB0aGUgbWluaW11bSBlbGVtZW50IChvciBlbGVtZW50LWJhc2VkIGNvbXB1dGF0aW9uKS4KICBfLm1pbiA9IGZ1bmN0aW9uIChvYmosIGl0ZXJhdG9yLCBjb250ZXh0KSB7CiAgICBpZiAoIWl0ZXJhdG9yICYmIF8uaXNBcnJheShvYmopICYmIG9ialswXSA9PT0gK29ialswXSAmJiBvYmoubGVuZ3RoIDwgNjU1MzUpIHsKICAgICAgcmV0dXJuIE1hdGgubWluLmFwcGx5KE1hdGgsIG9iaik7CiAgICB9CiAgICB2YXIgcmVzdWx0ID0gSW5maW5pdHksIGxhc3RDb21wdXRlZCA9IEluZmluaXR5OwogICAgZWFjaChvYmosIGZ1bmN0aW9uICh2YWx1ZSwgaW5kZXgsIGxpc3QpIHsKICAgICAgdmFyIGNvbXB1dGVkID0gaXRlcmF0b3IgPyBpdGVyYXRvci5jYWxsKGNvbnRleHQsIHZhbHVlLCBpbmRleCwgbGlzdCkgOiB2YWx1ZTsKICAgICAgaWYgKGNvbXB1dGVkIDwgbGFzdENvbXB1dGVkKSB7CiAgICAgICAgcmVzdWx0ID0gdmFsdWU7CiAgICAgICAgbGFzdENvbXB1dGVkID0gY29tcHV0ZWQ7CiAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuIHJlc3VsdDsKICB9OwogIC8vIFNodWZmbGUgYW4gYXJyYXksIHVzaW5nIHRoZSBtb2Rlcm4gdmVyc2lvbiBvZiB0aGUKICAvLyBbRmlzaGVyLVlhdGVzIHNodWZmbGVdKGh0dHA6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvRmlzaGVy4oCTWWF0ZXNfc2h1ZmZsZSkuCiAgXy5zaHVmZmxlID0gZnVuY3Rpb24gKG9iaikgewogICAgdmFyIHJhbmQ7CiAgICB2YXIgaW5kZXggPSAwOwogICAgdmFyIHNodWZmbGVkID0gW107CiAgICBlYWNoKG9iaiwgZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgIHJhbmQgPSBfLnJhbmRvbShpbmRleCsrKTsKICAgICAgc2h1ZmZsZWRbaW5kZXggLSAxXSA9IHNodWZmbGVkW3JhbmRdOwogICAgICBzaHVmZmxlZFtyYW5kXSA9IHZhbHVlOwogICAgfSk7CiAgICByZXR1cm4gc2h1ZmZsZWQ7CiAgfTsKICAvLyBTYW1wbGUgKipuKiogcmFuZG9tIHZhbHVlcyBmcm9tIGEgY29sbGVjdGlvbi4KICAvLyBJZiAqKm4qKiBpcyBub3Qgc3BlY2lmaWVkLCByZXR1cm5zIGEgc2luZ2xlIHJhbmRvbSBlbGVtZW50LgogIC8vIFRoZSBpbnRlcm5hbCBgZ3VhcmRgIGFyZ3VtZW50IGFsbG93cyBpdCB0byB3b3JrIHdpdGggYG1hcGAuCiAgXy5zYW1wbGUgPSBmdW5jdGlvbiAob2JqLCBuLCBndWFyZCkgewogICAgaWYgKG4gPT0gbnVsbCB8fCBndWFyZCkgewogICAgICBpZiAob2JqLmxlbmd0aCAhPT0gK29iai5sZW5ndGgpCiAgICAgICAgb2JqID0gXy52YWx1ZXMob2JqKTsKICAgICAgcmV0dXJuIG9ialtfLnJhbmRvbShvYmoubGVuZ3RoIC0gMSldOwogICAgfQogICAgcmV0dXJuIF8uc2h1ZmZsZShvYmopLnNsaWNlKDAsIE1hdGgubWF4KDAsIG4pKTsKICB9OwogIC8vIEFuIGludGVybmFsIGZ1bmN0aW9uIHRvIGdlbmVyYXRlIGxvb2t1cCBpdGVyYXRvcnMuCiAgdmFyIGxvb2t1cEl0ZXJhdG9yID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgICBpZiAodmFsdWUgPT0gbnVsbCkKICAgICAgcmV0dXJuIF8uaWRlbnRpdHk7CiAgICBpZiAoXy5pc0Z1bmN0aW9uKHZhbHVlKSkKICAgICAgcmV0dXJuIHZhbHVlOwogICAgcmV0dXJuIF8ucHJvcGVydHkodmFsdWUpOwogIH07CiAgLy8gU29ydCB0aGUgb2JqZWN0J3MgdmFsdWVzIGJ5IGEgY3JpdGVyaW9uIHByb2R1Y2VkIGJ5IGFuIGl0ZXJhdG9yLgogIF8uc29ydEJ5ID0gZnVuY3Rpb24gKG9iaiwgaXRlcmF0b3IsIGNvbnRleHQpIHsKICAgIGl0ZXJhdG9yID0gbG9va3VwSXRlcmF0b3IoaXRlcmF0b3IpOwogICAgcmV0dXJuIF8ucGx1Y2soXy5tYXAob2JqLCBmdW5jdGlvbiAodmFsdWUsIGluZGV4LCBsaXN0KSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgdmFsdWU6IHZhbHVlLAogICAgICAgIGluZGV4OiBpbmRleCwKICAgICAgICBjcml0ZXJpYTogaXRlcmF0b3IuY2FsbChjb250ZXh0LCB2YWx1ZSwgaW5kZXgsIGxpc3QpCiAgICAgIH07CiAgICB9KS5zb3J0KGZ1bmN0aW9uIChsZWZ0LCByaWdodCkgewogICAgICB2YXIgYSA9IGxlZnQuY3JpdGVyaWE7CiAgICAgIHZhciBiID0gcmlnaHQuY3JpdGVyaWE7CiAgICAgIGlmIChhICE9PSBiKSB7CiAgICAgICAgaWYgKGEgPiBiIHx8IGEgPT09IHZvaWQgMCkKICAgICAgICAgIHJldHVybiAxOwogICAgICAgIGlmIChhIDwgYiB8fCBiID09PSB2b2lkIDApCiAgICAgICAgICByZXR1cm4gLTE7CiAgICAgIH0KICAgICAgcmV0dXJuIGxlZnQuaW5kZXggLSByaWdodC5pbmRleDsKICAgIH0pLCAndmFsdWUnKTsKICB9OwogIC8vIEFuIGludGVybmFsIGZ1bmN0aW9uIHVzZWQgZm9yIGFnZ3JlZ2F0ZSAiZ3JvdXAgYnkiIG9wZXJhdGlvbnMuCiAgdmFyIGdyb3VwID0gZnVuY3Rpb24gKGJlaGF2aW9yKSB7CiAgICByZXR1cm4gZnVuY3Rpb24gKG9iaiwgaXRlcmF0b3IsIGNvbnRleHQpIHsKICAgICAgdmFyIHJlc3VsdCA9IHt9OwogICAgICBpdGVyYXRvciA9IGxvb2t1cEl0ZXJhdG9yKGl0ZXJhdG9yKTsKICAgICAgZWFjaChvYmosIGZ1bmN0aW9uICh2YWx1ZSwgaW5kZXgpIHsKICAgICAgICB2YXIga2V5ID0gaXRlcmF0b3IuY2FsbChjb250ZXh0LCB2YWx1ZSwgaW5kZXgsIG9iaik7CiAgICAgICAgYmVoYXZpb3IocmVzdWx0LCBrZXksIHZhbHVlKTsKICAgICAgfSk7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9OwogIH07CiAgLy8gR3JvdXBzIHRoZSBvYmplY3QncyB2YWx1ZXMgYnkgYSBjcml0ZXJpb24uIFBhc3MgZWl0aGVyIGEgc3RyaW5nIGF0dHJpYnV0ZQogIC8vIHRvIGdyb3VwIGJ5LCBvciBhIGZ1bmN0aW9uIHRoYXQgcmV0dXJucyB0aGUgY3JpdGVyaW9uLgogIF8uZ3JvdXBCeSA9IGdyb3VwKGZ1bmN0aW9uIChyZXN1bHQsIGtleSwgdmFsdWUpIHsKICAgIF8uaGFzKHJlc3VsdCwga2V5KSA/IHJlc3VsdFtrZXldLnB1c2godmFsdWUpIDogcmVzdWx0W2tleV0gPSBbdmFsdWVdOwogIH0pOwogIC8vIEluZGV4ZXMgdGhlIG9iamVjdCdzIHZhbHVlcyBieSBhIGNyaXRlcmlvbiwgc2ltaWxhciB0byBgZ3JvdXBCeWAsIGJ1dCBmb3IKICAvLyB3aGVuIHlvdSBrbm93IHRoYXQgeW91ciBpbmRleCB2YWx1ZXMgd2lsbCBiZSB1bmlxdWUuCiAgXy5pbmRleEJ5ID0gZ3JvdXAoZnVuY3Rpb24gKHJlc3VsdCwga2V5LCB2YWx1ZSkgewogICAgcmVzdWx0W2tleV0gPSB2YWx1ZTsKICB9KTsKICAvLyBDb3VudHMgaW5zdGFuY2VzIG9mIGFuIG9iamVjdCB0aGF0IGdyb3VwIGJ5IGEgY2VydGFpbiBjcml0ZXJpb24uIFBhc3MKICAvLyBlaXRoZXIgYSBzdHJpbmcgYXR0cmlidXRlIHRvIGNvdW50IGJ5LCBvciBhIGZ1bmN0aW9uIHRoYXQgcmV0dXJucyB0aGUKICAvLyBjcml0ZXJpb24uCiAgXy5jb3VudEJ5ID0gZ3JvdXAoZnVuY3Rpb24gKHJlc3VsdCwga2V5KSB7CiAgICBfLmhhcyhyZXN1bHQsIGtleSkgPyByZXN1bHRba2V5XSsrIDogcmVzdWx0W2tleV0gPSAxOwogIH0pOwogIC8vIFVzZSBhIGNvbXBhcmF0b3IgZnVuY3Rpb24gdG8gZmlndXJlIG91dCB0aGUgc21hbGxlc3QgaW5kZXggYXQgd2hpY2gKICAvLyBhbiBvYmplY3Qgc2hvdWxkIGJlIGluc2VydGVkIHNvIGFzIHRvIG1haW50YWluIG9yZGVyLiBVc2VzIGJpbmFyeSBzZWFyY2guCiAgXy5zb3J0ZWRJbmRleCA9IGZ1bmN0aW9uIChhcnJheSwgb2JqLCBpdGVyYXRvciwgY29udGV4dCkgewogICAgaXRlcmF0b3IgPSBsb29rdXBJdGVyYXRvcihpdGVyYXRvcik7CiAgICB2YXIgdmFsdWUgPSBpdGVyYXRvci5jYWxsKGNvbnRleHQsIG9iaik7CiAgICB2YXIgbG93ID0gMCwgaGlnaCA9IGFycmF5Lmxlbmd0aDsKICAgIHdoaWxlIChsb3cgPCBoaWdoKSB7CiAgICAgIHZhciBtaWQgPSBsb3cgKyBoaWdoID4+PiAxOwogICAgICBpdGVyYXRvci5jYWxsKGNvbnRleHQsIGFycmF5W21pZF0pIDwgdmFsdWUgPyBsb3cgPSBtaWQgKyAxIDogaGlnaCA9IG1pZDsKICAgIH0KICAgIHJldHVybiBsb3c7CiAgfTsKICAvLyBTYWZlbHkgY3JlYXRlIGEgcmVhbCwgbGl2ZSBhcnJheSBmcm9tIGFueXRoaW5nIGl0ZXJhYmxlLgogIF8udG9BcnJheSA9IGZ1bmN0aW9uIChvYmopIHsKICAgIGlmICghb2JqKQogICAgICByZXR1cm4gW107CiAgICBpZiAoXy5pc0FycmF5KG9iaikpCiAgICAgIHJldHVybiBzbGljZS5jYWxsKG9iaik7CiAgICBpZiAob2JqLmxlbmd0aCA9PT0gK29iai5sZW5ndGgpCiAgICAgIHJldHVybiBfLm1hcChvYmosIF8uaWRlbnRpdHkpOwogICAgcmV0dXJuIF8udmFsdWVzKG9iaik7CiAgfTsKICAvLyBSZXR1cm4gdGhlIG51bWJlciBvZiBlbGVtZW50cyBpbiBhbiBvYmplY3QuCiAgXy5zaXplID0gZnVuY3Rpb24gKG9iaikgewogICAgaWYgKG9iaiA9PSBudWxsKQogICAgICByZXR1cm4gMDsKICAgIHJldHVybiBvYmoubGVuZ3RoID09PSArb2JqLmxlbmd0aCA/IG9iai5sZW5ndGggOiBfLmtleXMob2JqKS5sZW5ndGg7CiAgfTsKICAvLyBBcnJheSBGdW5jdGlvbnMKICAvLyAtLS0tLS0tLS0tLS0tLS0KICAvLyBHZXQgdGhlIGZpcnN0IGVsZW1lbnQgb2YgYW4gYXJyYXkuIFBhc3NpbmcgKipuKiogd2lsbCByZXR1cm4gdGhlIGZpcnN0IE4KICAvLyB2YWx1ZXMgaW4gdGhlIGFycmF5LiBBbGlhc2VkIGFzIGBoZWFkYCBhbmQgYHRha2VgLiBUaGUgKipndWFyZCoqIGNoZWNrCiAgLy8gYWxsb3dzIGl0IHRvIHdvcmsgd2l0aCBgXy5tYXBgLgogIF8uZmlyc3QgPSBfLmhlYWQgPSBfLnRha2UgPSBmdW5jdGlvbiAoYXJyYXksIG4sIGd1YXJkKSB7CiAgICBpZiAoYXJyYXkgPT0gbnVsbCkKICAgICAgcmV0dXJuIHZvaWQgMDsKICAgIGlmIChuID09IG51bGwgfHwgZ3VhcmQpCiAgICAgIHJldHVybiBhcnJheVswXTsKICAgIGlmIChuIDwgMCkKICAgICAgcmV0dXJuIFtdOwogICAgcmV0dXJuIHNsaWNlLmNhbGwoYXJyYXksIDAsIG4pOwogIH07CiAgLy8gUmV0dXJucyBldmVyeXRoaW5nIGJ1dCB0aGUgbGFzdCBlbnRyeSBvZiB0aGUgYXJyYXkuIEVzcGVjaWFsbHkgdXNlZnVsIG9uCiAgLy8gdGhlIGFyZ3VtZW50cyBvYmplY3QuIFBhc3NpbmcgKipuKiogd2lsbCByZXR1cm4gYWxsIHRoZSB2YWx1ZXMgaW4KICAvLyB0aGUgYXJyYXksIGV4Y2x1ZGluZyB0aGUgbGFzdCBOLiBUaGUgKipndWFyZCoqIGNoZWNrIGFsbG93cyBpdCB0byB3b3JrIHdpdGgKICAvLyBgXy5tYXBgLgogIF8uaW5pdGlhbCA9IGZ1bmN0aW9uIChhcnJheSwgbiwgZ3VhcmQpIHsKICAgIHJldHVybiBzbGljZS5jYWxsKGFycmF5LCAwLCBhcnJheS5sZW5ndGggLSAobiA9PSBudWxsIHx8IGd1YXJkID8gMSA6IG4pKTsKICB9OwogIC8vIEdldCB0aGUgbGFzdCBlbGVtZW50IG9mIGFuIGFycmF5LiBQYXNzaW5nICoqbioqIHdpbGwgcmV0dXJuIHRoZSBsYXN0IE4KICAvLyB2YWx1ZXMgaW4gdGhlIGFycmF5LiBUaGUgKipndWFyZCoqIGNoZWNrIGFsbG93cyBpdCB0byB3b3JrIHdpdGggYF8ubWFwYC4KICBfLmxhc3QgPSBmdW5jdGlvbiAoYXJyYXksIG4sIGd1YXJkKSB7CiAgICBpZiAoYXJyYXkgPT0gbnVsbCkKICAgICAgcmV0dXJuIHZvaWQgMDsKICAgIGlmIChuID09IG51bGwgfHwgZ3VhcmQpCiAgICAgIHJldHVybiBhcnJheVthcnJheS5sZW5ndGggLSAxXTsKICAgIHJldHVybiBzbGljZS5jYWxsKGFycmF5LCBNYXRoLm1heChhcnJheS5sZW5ndGggLSBuLCAwKSk7CiAgfTsKICAvLyBSZXR1cm5zIGV2ZXJ5dGhpbmcgYnV0IHRoZSBmaXJzdCBlbnRyeSBvZiB0aGUgYXJyYXkuIEFsaWFzZWQgYXMgYHRhaWxgIGFuZCBgZHJvcGAuCiAgLy8gRXNwZWNpYWxseSB1c2VmdWwgb24gdGhlIGFyZ3VtZW50cyBvYmplY3QuIFBhc3NpbmcgYW4gKipuKiogd2lsbCByZXR1cm4KICAvLyB0aGUgcmVzdCBOIHZhbHVlcyBpbiB0aGUgYXJyYXkuIFRoZSAqKmd1YXJkKioKICAvLyBjaGVjayBhbGxvd3MgaXQgdG8gd29yayB3aXRoIGBfLm1hcGAuCiAgXy5yZXN0ID0gXy50YWlsID0gXy5kcm9wID0gZnVuY3Rpb24gKGFycmF5LCBuLCBndWFyZCkgewogICAgcmV0dXJuIHNsaWNlLmNhbGwoYXJyYXksIG4gPT0gbnVsbCB8fCBndWFyZCA/IDEgOiBuKTsKICB9OwogIC8vIFRyaW0gb3V0IGFsbCBmYWxzeSB2YWx1ZXMgZnJvbSBhbiBhcnJheS4KICBfLmNvbXBhY3QgPSBmdW5jdGlvbiAoYXJyYXkpIHsKICAgIHJldHVybiBfLmZpbHRlcihhcnJheSwgXy5pZGVudGl0eSk7CiAgfTsKICAvLyBJbnRlcm5hbCBpbXBsZW1lbnRhdGlvbiBvZiBhIHJlY3Vyc2l2ZSBgZmxhdHRlbmAgZnVuY3Rpb24uCiAgdmFyIGZsYXR0ZW4gPSBmdW5jdGlvbiAoaW5wdXQsIHNoYWxsb3csIG91dHB1dCkgewogICAgaWYgKHNoYWxsb3cgJiYgXy5ldmVyeShpbnB1dCwgXy5pc0FycmF5KSkgewogICAgICByZXR1cm4gY29uY2F0LmFwcGx5KG91dHB1dCwgaW5wdXQpOwogICAgfQogICAgZWFjaChpbnB1dCwgZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgIGlmIChfLmlzQXJyYXkodmFsdWUpIHx8IF8uaXNBcmd1bWVudHModmFsdWUpKSB7CiAgICAgICAgc2hhbGxvdyA/IHB1c2guYXBwbHkob3V0cHV0LCB2YWx1ZSkgOiBmbGF0dGVuKHZhbHVlLCBzaGFsbG93LCBvdXRwdXQpOwogICAgICB9IGVsc2UgewogICAgICAgIG91dHB1dC5wdXNoKHZhbHVlKTsKICAgICAgfQogICAgfSk7CiAgICByZXR1cm4gb3V0cHV0OwogIH07CiAgLy8gRmxhdHRlbiBvdXQgYW4gYXJyYXksIGVpdGhlciByZWN1cnNpdmVseSAoYnkgZGVmYXVsdCksIG9yIGp1c3Qgb25lIGxldmVsLgogIF8uZmxhdHRlbiA9IGZ1bmN0aW9uIChhcnJheSwgc2hhbGxvdykgewogICAgcmV0dXJuIGZsYXR0ZW4oYXJyYXksIHNoYWxsb3csIFtdKTsKICB9OwogIC8vIFJldHVybiBhIHZlcnNpb24gb2YgdGhlIGFycmF5IHRoYXQgZG9lcyBub3QgY29udGFpbiB0aGUgc3BlY2lmaWVkIHZhbHVlKHMpLgogIF8ud2l0aG91dCA9IGZ1bmN0aW9uIChhcnJheSkgewogICAgcmV0dXJuIF8uZGlmZmVyZW5jZShhcnJheSwgc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpKTsKICB9OwogIC8vIFNwbGl0IGFuIGFycmF5IGludG8gdHdvIGFycmF5czogb25lIHdob3NlIGVsZW1lbnRzIGFsbCBzYXRpc2Z5IHRoZSBnaXZlbgogIC8vIHByZWRpY2F0ZSwgYW5kIG9uZSB3aG9zZSBlbGVtZW50cyBhbGwgZG8gbm90IHNhdGlzZnkgdGhlIHByZWRpY2F0ZS4KICBfLnBhcnRpdGlvbiA9IGZ1bmN0aW9uIChhcnJheSwgcHJlZGljYXRlKSB7CiAgICB2YXIgcGFzcyA9IFtdLCBmYWlsID0gW107CiAgICBlYWNoKGFycmF5LCBmdW5jdGlvbiAoZWxlbSkgewogICAgICAocHJlZGljYXRlKGVsZW0pID8gcGFzcyA6IGZhaWwpLnB1c2goZWxlbSk7CiAgICB9KTsKICAgIHJldHVybiBbCiAgICAgIHBhc3MsCiAgICAgIGZhaWwKICAgIF07CiAgfTsKICAvLyBQcm9kdWNlIGEgZHVwbGljYXRlLWZyZWUgdmVyc2lvbiBvZiB0aGUgYXJyYXkuIElmIHRoZSBhcnJheSBoYXMgYWxyZWFkeQogIC8vIGJlZW4gc29ydGVkLCB5b3UgaGF2ZSB0aGUgb3B0aW9uIG9mIHVzaW5nIGEgZmFzdGVyIGFsZ29yaXRobS4KICAvLyBBbGlhc2VkIGFzIGB1bmlxdWVgLgogIF8udW5pcSA9IF8udW5pcXVlID0gZnVuY3Rpb24gKGFycmF5LCBpc1NvcnRlZCwgaXRlcmF0b3IsIGNvbnRleHQpIHsKICAgIGlmIChfLmlzRnVuY3Rpb24oaXNTb3J0ZWQpKSB7CiAgICAgIGNvbnRleHQgPSBpdGVyYXRvcjsKICAgICAgaXRlcmF0b3IgPSBpc1NvcnRlZDsKICAgICAgaXNTb3J0ZWQgPSBmYWxzZTsKICAgIH0KICAgIHZhciBpbml0aWFsID0gaXRlcmF0b3IgPyBfLm1hcChhcnJheSwgaXRlcmF0b3IsIGNvbnRleHQpIDogYXJyYXk7CiAgICB2YXIgcmVzdWx0cyA9IFtdOwogICAgdmFyIHNlZW4gPSBbXTsKICAgIGVhY2goaW5pdGlhbCwgZnVuY3Rpb24gKHZhbHVlLCBpbmRleCkgewogICAgICBpZiAoaXNTb3J0ZWQgPyAhaW5kZXggfHwgc2VlbltzZWVuLmxlbmd0aCAtIDFdICE9PSB2YWx1ZSA6ICFfLmNvbnRhaW5zKHNlZW4sIHZhbHVlKSkgewogICAgICAgIHNlZW4ucHVzaCh2YWx1ZSk7CiAgICAgICAgcmVzdWx0cy5wdXNoKGFycmF5W2luZGV4XSk7CiAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuIHJlc3VsdHM7CiAgfTsKICAvLyBQcm9kdWNlIGFuIGFycmF5IHRoYXQgY29udGFpbnMgdGhlIHVuaW9uOiBlYWNoIGRpc3RpbmN0IGVsZW1lbnQgZnJvbSBhbGwgb2YKICAvLyB0aGUgcGFzc2VkLWluIGFycmF5cy4KICBfLnVuaW9uID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIF8udW5pcShfLmZsYXR0ZW4oYXJndW1lbnRzLCB0cnVlKSk7CiAgfTsKICAvLyBQcm9kdWNlIGFuIGFycmF5IHRoYXQgY29udGFpbnMgZXZlcnkgaXRlbSBzaGFyZWQgYmV0d2VlbiBhbGwgdGhlCiAgLy8gcGFzc2VkLWluIGFycmF5cy4KICBfLmludGVyc2VjdGlvbiA9IGZ1bmN0aW9uIChhcnJheSkgewogICAgdmFyIHJlc3QgPSBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CiAgICByZXR1cm4gXy5maWx0ZXIoXy51bmlxKGFycmF5KSwgZnVuY3Rpb24gKGl0ZW0pIHsKICAgICAgcmV0dXJuIF8uZXZlcnkocmVzdCwgZnVuY3Rpb24gKG90aGVyKSB7CiAgICAgICAgcmV0dXJuIF8uY29udGFpbnMob3RoZXIsIGl0ZW0pOwogICAgICB9KTsKICAgIH0pOwogIH07CiAgLy8gVGFrZSB0aGUgZGlmZmVyZW5jZSBiZXR3ZWVuIG9uZSBhcnJheSBhbmQgYSBudW1iZXIgb2Ygb3RoZXIgYXJyYXlzLgogIC8vIE9ubHkgdGhlIGVsZW1lbnRzIHByZXNlbnQgaW4ganVzdCB0aGUgZmlyc3QgYXJyYXkgd2lsbCByZW1haW4uCiAgXy5kaWZmZXJlbmNlID0gZnVuY3Rpb24gKGFycmF5KSB7CiAgICB2YXIgcmVzdCA9IGNvbmNhdC5hcHBseShBcnJheVByb3RvLCBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSkpOwogICAgcmV0dXJuIF8uZmlsdGVyKGFycmF5LCBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgcmV0dXJuICFfLmNvbnRhaW5zKHJlc3QsIHZhbHVlKTsKICAgIH0pOwogIH07CiAgLy8gWmlwIHRvZ2V0aGVyIG11bHRpcGxlIGxpc3RzIGludG8gYSBzaW5nbGUgYXJyYXkgLS0gZWxlbWVudHMgdGhhdCBzaGFyZQogIC8vIGFuIGluZGV4IGdvIHRvZ2V0aGVyLgogIF8uemlwID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGxlbmd0aCA9IF8ubWF4KF8ucGx1Y2soYXJndW1lbnRzLCAnbGVuZ3RoJykuY29uY2F0KDApKTsKICAgIHZhciByZXN1bHRzID0gbmV3IEFycmF5KGxlbmd0aCk7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgIHJlc3VsdHNbaV0gPSBfLnBsdWNrKGFyZ3VtZW50cywgJycgKyBpKTsKICAgIH0KICAgIHJldHVybiByZXN1bHRzOwogIH07CiAgLy8gQ29udmVydHMgbGlzdHMgaW50byBvYmplY3RzLiBQYXNzIGVpdGhlciBhIHNpbmdsZSBhcnJheSBvZiBgW2tleSwgdmFsdWVdYAogIC8vIHBhaXJzLCBvciB0d28gcGFyYWxsZWwgYXJyYXlzIG9mIHRoZSBzYW1lIGxlbmd0aCAtLSBvbmUgb2Yga2V5cywgYW5kIG9uZSBvZgogIC8vIHRoZSBjb3JyZXNwb25kaW5nIHZhbHVlcy4KICBfLm9iamVjdCA9IGZ1bmN0aW9uIChsaXN0LCB2YWx1ZXMpIHsKICAgIGlmIChsaXN0ID09IG51bGwpCiAgICAgIHJldHVybiB7fTsKICAgIHZhciByZXN1bHQgPSB7fTsKICAgIGZvciAodmFyIGkgPSAwLCBsZW5ndGggPSBsaXN0Lmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgIGlmICh2YWx1ZXMpIHsKICAgICAgICByZXN1bHRbbGlzdFtpXV0gPSB2YWx1ZXNbaV07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmVzdWx0W2xpc3RbaV1bMF1dID0gbGlzdFtpXVsxXTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9OwogIC8vIElmIHRoZSBicm93c2VyIGRvZXNuJ3Qgc3VwcGx5IHVzIHdpdGggaW5kZXhPZiAoSSdtIGxvb2tpbmcgYXQgeW91LCAqKk1TSUUqKiksCiAgLy8gd2UgbmVlZCB0aGlzIGZ1bmN0aW9uLiBSZXR1cm4gdGhlIHBvc2l0aW9uIG9mIHRoZSBmaXJzdCBvY2N1cnJlbmNlIG9mIGFuCiAgLy8gaXRlbSBpbiBhbiBhcnJheSwgb3IgLTEgaWYgdGhlIGl0ZW0gaXMgbm90IGluY2x1ZGVkIGluIHRoZSBhcnJheS4KICAvLyBEZWxlZ2F0ZXMgdG8gKipFQ01BU2NyaXB0IDUqKidzIG5hdGl2ZSBgaW5kZXhPZmAgaWYgYXZhaWxhYmxlLgogIC8vIElmIHRoZSBhcnJheSBpcyBsYXJnZSBhbmQgYWxyZWFkeSBpbiBzb3J0IG9yZGVyLCBwYXNzIGB0cnVlYAogIC8vIGZvciAqKmlzU29ydGVkKiogdG8gdXNlIGJpbmFyeSBzZWFyY2guCiAgXy5pbmRleE9mID0gZnVuY3Rpb24gKGFycmF5LCBpdGVtLCBpc1NvcnRlZCkgewogICAgaWYgKGFycmF5ID09IG51bGwpCiAgICAgIHJldHVybiAtMTsKICAgIHZhciBpID0gMCwgbGVuZ3RoID0gYXJyYXkubGVuZ3RoOwogICAgaWYgKGlzU29ydGVkKSB7CiAgICAgIGlmICh0eXBlb2YgaXNTb3J0ZWQgPT0gJ251bWJlcicpIHsKICAgICAgICBpID0gaXNTb3J0ZWQgPCAwID8gTWF0aC5tYXgoMCwgbGVuZ3RoICsgaXNTb3J0ZWQpIDogaXNTb3J0ZWQ7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaSA9IF8uc29ydGVkSW5kZXgoYXJyYXksIGl0ZW0pOwogICAgICAgIHJldHVybiBhcnJheVtpXSA9PT0gaXRlbSA/IGkgOiAtMTsKICAgICAgfQogICAgfQogICAgaWYgKG5hdGl2ZUluZGV4T2YgJiYgYXJyYXkuaW5kZXhPZiA9PT0gbmF0aXZlSW5kZXhPZikKICAgICAgcmV0dXJuIGFycmF5LmluZGV4T2YoaXRlbSwgaXNTb3J0ZWQpOwogICAgZm9yICg7IGkgPCBsZW5ndGg7IGkrKykKICAgICAgaWYgKGFycmF5W2ldID09PSBpdGVtKQogICAgICAgIHJldHVybiBpOwogICAgcmV0dXJuIC0xOwogIH07CiAgLy8gRGVsZWdhdGVzIHRvICoqRUNNQVNjcmlwdCA1KioncyBuYXRpdmUgYGxhc3RJbmRleE9mYCBpZiBhdmFpbGFibGUuCiAgXy5sYXN0SW5kZXhPZiA9IGZ1bmN0aW9uIChhcnJheSwgaXRlbSwgZnJvbSkgewogICAgaWYgKGFycmF5ID09IG51bGwpCiAgICAgIHJldHVybiAtMTsKICAgIHZhciBoYXNJbmRleCA9IGZyb20gIT0gbnVsbDsKICAgIGlmIChuYXRpdmVMYXN0SW5kZXhPZiAmJiBhcnJheS5sYXN0SW5kZXhPZiA9PT0gbmF0aXZlTGFzdEluZGV4T2YpIHsKICAgICAgcmV0dXJuIGhhc0luZGV4ID8gYXJyYXkubGFzdEluZGV4T2YoaXRlbSwgZnJvbSkgOiBhcnJheS5sYXN0SW5kZXhPZihpdGVtKTsKICAgIH0KICAgIHZhciBpID0gaGFzSW5kZXggPyBmcm9tIDogYXJyYXkubGVuZ3RoOwogICAgd2hpbGUgKGktLSkKICAgICAgaWYgKGFycmF5W2ldID09PSBpdGVtKQogICAgICAgIHJldHVybiBpOwogICAgcmV0dXJuIC0xOwogIH07CiAgLy8gR2VuZXJhdGUgYW4gaW50ZWdlciBBcnJheSBjb250YWluaW5nIGFuIGFyaXRobWV0aWMgcHJvZ3Jlc3Npb24uIEEgcG9ydCBvZgogIC8vIHRoZSBuYXRpdmUgUHl0aG9uIGByYW5nZSgpYCBmdW5jdGlvbi4gU2VlCiAgLy8gW3RoZSBQeXRob24gZG9jdW1lbnRhdGlvbl0oaHR0cDovL2RvY3MucHl0aG9uLm9yZy9saWJyYXJ5L2Z1bmN0aW9ucy5odG1sI3JhbmdlKS4KICBfLnJhbmdlID0gZnVuY3Rpb24gKHN0YXJ0LCBzdG9wLCBzdGVwKSB7CiAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA8PSAxKSB7CiAgICAgIHN0b3AgPSBzdGFydCB8fCAwOwogICAgICBzdGFydCA9IDA7CiAgICB9CiAgICBzdGVwID0gYXJndW1lbnRzWzJdIHx8IDE7CiAgICB2YXIgbGVuZ3RoID0gTWF0aC5tYXgoTWF0aC5jZWlsKChzdG9wIC0gc3RhcnQpIC8gc3RlcCksIDApOwogICAgdmFyIGlkeCA9IDA7CiAgICB2YXIgcmFuZ2UgPSBuZXcgQXJyYXkobGVuZ3RoKTsKICAgIHdoaWxlIChpZHggPCBsZW5ndGgpIHsKICAgICAgcmFuZ2VbaWR4KytdID0gc3RhcnQ7CiAgICAgIHN0YXJ0ICs9IHN0ZXA7CiAgICB9CiAgICByZXR1cm4gcmFuZ2U7CiAgfTsKICAvLyBGdW5jdGlvbiAoYWhlbSkgRnVuY3Rpb25zCiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tCiAgLy8gUmV1c2FibGUgY29uc3RydWN0b3IgZnVuY3Rpb24gZm9yIHByb3RvdHlwZSBzZXR0aW5nLgogIHZhciBjdG9yID0gZnVuY3Rpb24gKCkgewogIH07CiAgLy8gQ3JlYXRlIGEgZnVuY3Rpb24gYm91bmQgdG8gYSBnaXZlbiBvYmplY3QgKGFzc2lnbmluZyBgdGhpc2AsIGFuZCBhcmd1bWVudHMsCiAgLy8gb3B0aW9uYWxseSkuIERlbGVnYXRlcyB0byAqKkVDTUFTY3JpcHQgNSoqJ3MgbmF0aXZlIGBGdW5jdGlvbi5iaW5kYCBpZgogIC8vIGF2YWlsYWJsZS4KICBfLmJpbmQgPSBmdW5jdGlvbiAoZnVuYywgY29udGV4dCkgewogICAgdmFyIGFyZ3MsIGJvdW5kOwogICAgaWYgKG5hdGl2ZUJpbmQgJiYgZnVuYy5iaW5kID09PSBuYXRpdmVCaW5kKQogICAgICByZXR1cm4gbmF0aXZlQmluZC5hcHBseShmdW5jLCBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSkpOwogICAgaWYgKCFfLmlzRnVuY3Rpb24oZnVuYykpCiAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoKTsKICAgIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cywgMik7CiAgICByZXR1cm4gYm91bmQgPSBmdW5jdGlvbiAoKSB7CiAgICAgIGlmICghKHRoaXMgaW5zdGFuY2VvZiBib3VuZCkpCiAgICAgICAgcmV0dXJuIGZ1bmMuYXBwbHkoY29udGV4dCwgYXJncy5jb25jYXQoc2xpY2UuY2FsbChhcmd1bWVudHMpKSk7CiAgICAgIGN0b3IucHJvdG90eXBlID0gZnVuYy5wcm90b3R5cGU7CiAgICAgIHZhciBzZWxmID0gbmV3IGN0b3IoKTsKICAgICAgY3Rvci5wcm90b3R5cGUgPSBudWxsOwogICAgICB2YXIgcmVzdWx0ID0gZnVuYy5hcHBseShzZWxmLCBhcmdzLmNvbmNhdChzbGljZS5jYWxsKGFyZ3VtZW50cykpKTsKICAgICAgaWYgKE9iamVjdChyZXN1bHQpID09PSByZXN1bHQpCiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgcmV0dXJuIHNlbGY7CiAgICB9OwogIH07CiAgLy8gUGFydGlhbGx5IGFwcGx5IGEgZnVuY3Rpb24gYnkgY3JlYXRpbmcgYSB2ZXJzaW9uIHRoYXQgaGFzIGhhZCBzb21lIG9mIGl0cwogIC8vIGFyZ3VtZW50cyBwcmUtZmlsbGVkLCB3aXRob3V0IGNoYW5naW5nIGl0cyBkeW5hbWljIGB0aGlzYCBjb250ZXh0LiBfIGFjdHMKICAvLyBhcyBhIHBsYWNlaG9sZGVyLCBhbGxvd2luZyBhbnkgY29tYmluYXRpb24gb2YgYXJndW1lbnRzIHRvIGJlIHByZS1maWxsZWQuCiAgXy5wYXJ0aWFsID0gZnVuY3Rpb24gKGZ1bmMpIHsKICAgIHZhciBib3VuZEFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CiAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICB2YXIgcG9zaXRpb24gPSAwOwogICAgICB2YXIgYXJncyA9IGJvdW5kQXJncy5zbGljZSgpOwogICAgICBmb3IgKHZhciBpID0gMCwgbGVuZ3RoID0gYXJncy5sZW5ndGg7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgIGlmIChhcmdzW2ldID09PSBfKQogICAgICAgICAgYXJnc1tpXSA9IGFyZ3VtZW50c1twb3NpdGlvbisrXTsKICAgICAgfQogICAgICB3aGlsZSAocG9zaXRpb24gPCBhcmd1bWVudHMubGVuZ3RoKQogICAgICAgIGFyZ3MucHVzaChhcmd1bWVudHNbcG9zaXRpb24rK10pOwogICAgICByZXR1cm4gZnVuYy5hcHBseSh0aGlzLCBhcmdzKTsKICAgIH07CiAgfTsKICAvLyBCaW5kIGEgbnVtYmVyIG9mIGFuIG9iamVjdCdzIG1ldGhvZHMgdG8gdGhhdCBvYmplY3QuIFJlbWFpbmluZyBhcmd1bWVudHMKICAvLyBhcmUgdGhlIG1ldGhvZCBuYW1lcyB0byBiZSBib3VuZC4gVXNlZnVsIGZvciBlbnN1cmluZyB0aGF0IGFsbCBjYWxsYmFja3MKICAvLyBkZWZpbmVkIG9uIGFuIG9iamVjdCBiZWxvbmcgdG8gaXQuCiAgXy5iaW5kQWxsID0gZnVuY3Rpb24gKG9iaikgewogICAgdmFyIGZ1bmNzID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwogICAgaWYgKGZ1bmNzLmxlbmd0aCA9PT0gMCkKICAgICAgdGhyb3cgbmV3IEVycm9yKCdiaW5kQWxsIG11c3QgYmUgcGFzc2VkIGZ1bmN0aW9uIG5hbWVzJyk7CiAgICBlYWNoKGZ1bmNzLCBmdW5jdGlvbiAoZikgewogICAgICBvYmpbZl0gPSBfLmJpbmQob2JqW2ZdLCBvYmopOwogICAgfSk7CiAgICByZXR1cm4gb2JqOwogIH07CiAgLy8gTWVtb2l6ZSBhbiBleHBlbnNpdmUgZnVuY3Rpb24gYnkgc3RvcmluZyBpdHMgcmVzdWx0cy4KICBfLm1lbW9pemUgPSBmdW5jdGlvbiAoZnVuYywgaGFzaGVyKSB7CiAgICB2YXIgbWVtbyA9IHt9OwogICAgaGFzaGVyIHx8IChoYXNoZXIgPSBfLmlkZW50aXR5KTsKICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBrZXkgPSBoYXNoZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgcmV0dXJuIF8uaGFzKG1lbW8sIGtleSkgPyBtZW1vW2tleV0gOiBtZW1vW2tleV0gPSBmdW5jLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9OwogIH07CiAgLy8gRGVsYXlzIGEgZnVuY3Rpb24gZm9yIHRoZSBnaXZlbiBudW1iZXIgb2YgbWlsbGlzZWNvbmRzLCBhbmQgdGhlbiBjYWxscwogIC8vIGl0IHdpdGggdGhlIGFyZ3VtZW50cyBzdXBwbGllZC4KICBfLmRlbGF5ID0gZnVuY3Rpb24gKGZ1bmMsIHdhaXQpIHsKICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDIpOwogICAgcmV0dXJuIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gZnVuYy5hcHBseShudWxsLCBhcmdzKTsKICAgIH0sIHdhaXQpOwogIH07CiAgLy8gRGVmZXJzIGEgZnVuY3Rpb24sIHNjaGVkdWxpbmcgaXQgdG8gcnVuIGFmdGVyIHRoZSBjdXJyZW50IGNhbGwgc3RhY2sgaGFzCiAgLy8gY2xlYXJlZC4KICBfLmRlZmVyID0gZnVuY3Rpb24gKGZ1bmMpIHsKICAgIHJldHVybiBfLmRlbGF5LmFwcGx5KF8sIFsKICAgICAgZnVuYywKICAgICAgMQogICAgXS5jb25jYXQoc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpKSk7CiAgfTsKICAvLyBSZXR1cm5zIGEgZnVuY3Rpb24sIHRoYXQsIHdoZW4gaW52b2tlZCwgd2lsbCBvbmx5IGJlIHRyaWdnZXJlZCBhdCBtb3N0IG9uY2UKICAvLyBkdXJpbmcgYSBnaXZlbiB3aW5kb3cgb2YgdGltZS4gTm9ybWFsbHksIHRoZSB0aHJvdHRsZWQgZnVuY3Rpb24gd2lsbCBydW4KICAvLyBhcyBtdWNoIGFzIGl0IGNhbiwgd2l0aG91dCBldmVyIGdvaW5nIG1vcmUgdGhhbiBvbmNlIHBlciBgd2FpdGAgZHVyYXRpb247CiAgLy8gYnV0IGlmIHlvdSdkIGxpa2UgdG8gZGlzYWJsZSB0aGUgZXhlY3V0aW9uIG9uIHRoZSBsZWFkaW5nIGVkZ2UsIHBhc3MKICAvLyBge2xlYWRpbmc6IGZhbHNlfWAuIFRvIGRpc2FibGUgZXhlY3V0aW9uIG9uIHRoZSB0cmFpbGluZyBlZGdlLCBkaXR0by4KICBfLnRocm90dGxlID0gZnVuY3Rpb24gKGZ1bmMsIHdhaXQsIG9wdGlvbnMpIHsKICAgIHZhciBjb250ZXh0LCBhcmdzLCByZXN1bHQ7CiAgICB2YXIgdGltZW91dCA9IG51bGw7CiAgICB2YXIgcHJldmlvdXMgPSAwOwogICAgb3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KTsKICAgIHZhciBsYXRlciA9IGZ1bmN0aW9uICgpIHsKICAgICAgcHJldmlvdXMgPSBvcHRpb25zLmxlYWRpbmcgPT09IGZhbHNlID8gMCA6IF8ubm93KCk7CiAgICAgIHRpbWVvdXQgPSBudWxsOwogICAgICByZXN1bHQgPSBmdW5jLmFwcGx5KGNvbnRleHQsIGFyZ3MpOwogICAgICBjb250ZXh0ID0gYXJncyA9IG51bGw7CiAgICB9OwogICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIG5vdyA9IF8ubm93KCk7CiAgICAgIGlmICghcHJldmlvdXMgJiYgb3B0aW9ucy5sZWFkaW5nID09PSBmYWxzZSkKICAgICAgICBwcmV2aW91cyA9IG5vdzsKICAgICAgdmFyIHJlbWFpbmluZyA9IHdhaXQgLSAobm93IC0gcHJldmlvdXMpOwogICAgICBjb250ZXh0ID0gdGhpczsKICAgICAgYXJncyA9IGFyZ3VtZW50czsKICAgICAgaWYgKHJlbWFpbmluZyA8PSAwKSB7CiAgICAgICAgY2xlYXJUaW1lb3V0KHRpbWVvdXQpOwogICAgICAgIHRpbWVvdXQgPSBudWxsOwogICAgICAgIHByZXZpb3VzID0gbm93OwogICAgICAgIHJlc3VsdCA9IGZ1bmMuYXBwbHkoY29udGV4dCwgYXJncyk7CiAgICAgICAgY29udGV4dCA9IGFyZ3MgPSBudWxsOwogICAgICB9IGVsc2UgaWYgKCF0aW1lb3V0ICYmIG9wdGlvbnMudHJhaWxpbmcgIT09IGZhbHNlKSB7CiAgICAgICAgdGltZW91dCA9IHNldFRpbWVvdXQobGF0ZXIsIHJlbWFpbmluZyk7CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH07CiAgfTsKICAvLyBSZXR1cm5zIGEgZnVuY3Rpb24sIHRoYXQsIGFzIGxvbmcgYXMgaXQgY29udGludWVzIHRvIGJlIGludm9rZWQsIHdpbGwgbm90CiAgLy8gYmUgdHJpZ2dlcmVkLiBUaGUgZnVuY3Rpb24gd2lsbCBiZSBjYWxsZWQgYWZ0ZXIgaXQgc3RvcHMgYmVpbmcgY2FsbGVkIGZvcgogIC8vIE4gbWlsbGlzZWNvbmRzLiBJZiBgaW1tZWRpYXRlYCBpcyBwYXNzZWQsIHRyaWdnZXIgdGhlIGZ1bmN0aW9uIG9uIHRoZQogIC8vIGxlYWRpbmcgZWRnZSwgaW5zdGVhZCBvZiB0aGUgdHJhaWxpbmcuCiAgXy5kZWJvdW5jZSA9IGZ1bmN0aW9uIChmdW5jLCB3YWl0LCBpbW1lZGlhdGUpIHsKICAgIHZhciB0aW1lb3V0LCBhcmdzLCBjb250ZXh0LCB0aW1lc3RhbXAsIHJlc3VsdDsKICAgIHZhciBsYXRlciA9IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIGxhc3QgPSBfLm5vdygpIC0gdGltZXN0YW1wOwogICAgICBpZiAobGFzdCA8IHdhaXQpIHsKICAgICAgICB0aW1lb3V0ID0gc2V0VGltZW91dChsYXRlciwgd2FpdCAtIGxhc3QpOwogICAgICB9IGVsc2UgewogICAgICAgIHRpbWVvdXQgPSBudWxsOwogICAgICAgIGlmICghaW1tZWRpYXRlKSB7CiAgICAgICAgICByZXN1bHQgPSBmdW5jLmFwcGx5KGNvbnRleHQsIGFyZ3MpOwogICAgICAgICAgY29udGV4dCA9IGFyZ3MgPSBudWxsOwogICAgICAgIH0KICAgICAgfQogICAgfTsKICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgIGNvbnRleHQgPSB0aGlzOwogICAgICBhcmdzID0gYXJndW1lbnRzOwogICAgICB0aW1lc3RhbXAgPSBfLm5vdygpOwogICAgICB2YXIgY2FsbE5vdyA9IGltbWVkaWF0ZSAmJiAhdGltZW91dDsKICAgICAgaWYgKCF0aW1lb3V0KSB7CiAgICAgICAgdGltZW91dCA9IHNldFRpbWVvdXQobGF0ZXIsIHdhaXQpOwogICAgICB9CiAgICAgIGlmIChjYWxsTm93KSB7CiAgICAgICAgcmVzdWx0ID0gZnVuYy5hcHBseShjb250ZXh0LCBhcmdzKTsKICAgICAgICBjb250ZXh0ID0gYXJncyA9IG51bGw7CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH07CiAgfTsKICAvLyBSZXR1cm5zIGEgZnVuY3Rpb24gdGhhdCB3aWxsIGJlIGV4ZWN1dGVkIGF0IG1vc3Qgb25lIHRpbWUsIG5vIG1hdHRlciBob3cKICAvLyBvZnRlbiB5b3UgY2FsbCBpdC4gVXNlZnVsIGZvciBsYXp5IGluaXRpYWxpemF0aW9uLgogIF8ub25jZSA9IGZ1bmN0aW9uIChmdW5jKSB7CiAgICB2YXIgcmFuID0gZmFsc2UsIG1lbW87CiAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICBpZiAocmFuKQogICAgICAgIHJldHVybiBtZW1vOwogICAgICByYW4gPSB0cnVlOwogICAgICBtZW1vID0gZnVuYy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICBmdW5jID0gbnVsbDsKICAgICAgcmV0dXJuIG1lbW87CiAgICB9OwogIH07CiAgLy8gUmV0dXJucyB0aGUgZmlyc3QgZnVuY3Rpb24gcGFzc2VkIGFzIGFuIGFyZ3VtZW50IHRvIHRoZSBzZWNvbmQsCiAgLy8gYWxsb3dpbmcgeW91IHRvIGFkanVzdCBhcmd1bWVudHMsIHJ1biBjb2RlIGJlZm9yZSBhbmQgYWZ0ZXIsIGFuZAogIC8vIGNvbmRpdGlvbmFsbHkgZXhlY3V0ZSB0aGUgb3JpZ2luYWwgZnVuY3Rpb24uCiAgXy53cmFwID0gZnVuY3Rpb24gKGZ1bmMsIHdyYXBwZXIpIHsKICAgIHJldHVybiBfLnBhcnRpYWwod3JhcHBlciwgZnVuYyk7CiAgfTsKICAvLyBSZXR1cm5zIGEgZnVuY3Rpb24gdGhhdCBpcyB0aGUgY29tcG9zaXRpb24gb2YgYSBsaXN0IG9mIGZ1bmN0aW9ucywgZWFjaAogIC8vIGNvbnN1bWluZyB0aGUgcmV0dXJuIHZhbHVlIG9mIHRoZSBmdW5jdGlvbiB0aGF0IGZvbGxvd3MuCiAgXy5jb21wb3NlID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGZ1bmNzID0gYXJndW1lbnRzOwogICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIGFyZ3MgPSBhcmd1bWVudHM7CiAgICAgIGZvciAodmFyIGkgPSBmdW5jcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICAgIGFyZ3MgPSBbZnVuY3NbaV0uYXBwbHkodGhpcywgYXJncyldOwogICAgICB9CiAgICAgIHJldHVybiBhcmdzWzBdOwogICAgfTsKICB9OwogIC8vIFJldHVybnMgYSBmdW5jdGlvbiB0aGF0IHdpbGwgb25seSBiZSBleGVjdXRlZCBhZnRlciBiZWluZyBjYWxsZWQgTiB0aW1lcy4KICBfLmFmdGVyID0gZnVuY3Rpb24gKHRpbWVzLCBmdW5jKSB7CiAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICBpZiAoLS10aW1lcyA8IDEpIHsKICAgICAgICByZXR1cm4gZnVuYy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9CiAgICB9OwogIH07CiAgLy8gT2JqZWN0IEZ1bmN0aW9ucwogIC8vIC0tLS0tLS0tLS0tLS0tLS0KICAvLyBSZXRyaWV2ZSB0aGUgbmFtZXMgb2YgYW4gb2JqZWN0J3MgcHJvcGVydGllcy4KICAvLyBEZWxlZ2F0ZXMgdG8gKipFQ01BU2NyaXB0IDUqKidzIG5hdGl2ZSBgT2JqZWN0LmtleXNgCiAgXy5rZXlzID0gZnVuY3Rpb24gKG9iaikgewogICAgaWYgKCFfLmlzT2JqZWN0KG9iaikpCiAgICAgIHJldHVybiBbXTsKICAgIGlmIChuYXRpdmVLZXlzKQogICAgICByZXR1cm4gbmF0aXZlS2V5cyhvYmopOwogICAgdmFyIGtleXMgPSBbXTsKICAgIGZvciAodmFyIGtleSBpbiBvYmopCiAgICAgIGlmIChfLmhhcyhvYmosIGtleSkpCiAgICAgICAga2V5cy5wdXNoKGtleSk7CiAgICByZXR1cm4ga2V5czsKICB9OwogIC8vIFJldHJpZXZlIHRoZSB2YWx1ZXMgb2YgYW4gb2JqZWN0J3MgcHJvcGVydGllcy4KICBfLnZhbHVlcyA9IGZ1bmN0aW9uIChvYmopIHsKICAgIHZhciBrZXlzID0gXy5rZXlzKG9iaik7CiAgICB2YXIgbGVuZ3RoID0ga2V5cy5sZW5ndGg7CiAgICB2YXIgdmFsdWVzID0gbmV3IEFycmF5KGxlbmd0aCk7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgIHZhbHVlc1tpXSA9IG9ialtrZXlzW2ldXTsKICAgIH0KICAgIHJldHVybiB2YWx1ZXM7CiAgfTsKICAvLyBDb252ZXJ0IGFuIG9iamVjdCBpbnRvIGEgbGlzdCBvZiBgW2tleSwgdmFsdWVdYCBwYWlycy4KICBfLnBhaXJzID0gZnVuY3Rpb24gKG9iaikgewogICAgdmFyIGtleXMgPSBfLmtleXMob2JqKTsKICAgIHZhciBsZW5ndGggPSBrZXlzLmxlbmd0aDsKICAgIHZhciBwYWlycyA9IG5ldyBBcnJheShsZW5ndGgpOwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICBwYWlyc1tpXSA9IFsKICAgICAgICBrZXlzW2ldLAogICAgICAgIG9ialtrZXlzW2ldXQogICAgICBdOwogICAgfQogICAgcmV0dXJuIHBhaXJzOwogIH07CiAgLy8gSW52ZXJ0IHRoZSBrZXlzIGFuZCB2YWx1ZXMgb2YgYW4gb2JqZWN0LiBUaGUgdmFsdWVzIG11c3QgYmUgc2VyaWFsaXphYmxlLgogIF8uaW52ZXJ0ID0gZnVuY3Rpb24gKG9iaikgewogICAgdmFyIHJlc3VsdCA9IHt9OwogICAgdmFyIGtleXMgPSBfLmtleXMob2JqKTsKICAgIGZvciAodmFyIGkgPSAwLCBsZW5ndGggPSBrZXlzLmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgIHJlc3VsdFtvYmpba2V5c1tpXV1dID0ga2V5c1tpXTsKICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfTsKICAvLyBSZXR1cm4gYSBzb3J0ZWQgbGlzdCBvZiB0aGUgZnVuY3Rpb24gbmFtZXMgYXZhaWxhYmxlIG9uIHRoZSBvYmplY3QuCiAgLy8gQWxpYXNlZCBhcyBgbWV0aG9kc2AKICBfLmZ1bmN0aW9ucyA9IF8ubWV0aG9kcyA9IGZ1bmN0aW9uIChvYmopIHsKICAgIHZhciBuYW1lcyA9IFtdOwogICAgZm9yICh2YXIga2V5IGluIG9iaikgewogICAgICBpZiAoXy5pc0Z1bmN0aW9uKG9ialtrZXldKSkKICAgICAgICBuYW1lcy5wdXNoKGtleSk7CiAgICB9CiAgICByZXR1cm4gbmFtZXMuc29ydCgpOwogIH07CiAgLy8gRXh0ZW5kIGEgZ2l2ZW4gb2JqZWN0IHdpdGggYWxsIHRoZSBwcm9wZXJ0aWVzIGluIHBhc3NlZC1pbiBvYmplY3QocykuCiAgXy5leHRlbmQgPSBmdW5jdGlvbiAob2JqKSB7CiAgICBlYWNoKHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSwgZnVuY3Rpb24gKHNvdXJjZSkgewogICAgICBpZiAoc291cmNlKSB7CiAgICAgICAgZm9yICh2YXIgcHJvcCBpbiBzb3VyY2UpIHsKICAgICAgICAgIG9ialtwcm9wXSA9IHNvdXJjZVtwcm9wXTsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuIG9iajsKICB9OwogIC8vIFJldHVybiBhIGNvcHkgb2YgdGhlIG9iamVjdCBvbmx5IGNvbnRhaW5pbmcgdGhlIHdoaXRlbGlzdGVkIHByb3BlcnRpZXMuCiAgXy5waWNrID0gZnVuY3Rpb24gKG9iaikgewogICAgdmFyIGNvcHkgPSB7fTsKICAgIHZhciBrZXlzID0gY29uY2F0LmFwcGx5KEFycmF5UHJvdG8sIHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSk7CiAgICBlYWNoKGtleXMsIGZ1bmN0aW9uIChrZXkpIHsKICAgICAgaWYgKGtleSBpbiBvYmopCiAgICAgICAgY29weVtrZXldID0gb2JqW2tleV07CiAgICB9KTsKICAgIHJldHVybiBjb3B5OwogIH07CiAgLy8gUmV0dXJuIGEgY29weSBvZiB0aGUgb2JqZWN0IHdpdGhvdXQgdGhlIGJsYWNrbGlzdGVkIHByb3BlcnRpZXMuCiAgXy5vbWl0ID0gZnVuY3Rpb24gKG9iaikgewogICAgdmFyIGNvcHkgPSB7fTsKICAgIHZhciBrZXlzID0gY29uY2F0LmFwcGx5KEFycmF5UHJvdG8sIHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSk7CiAgICBmb3IgKHZhciBrZXkgaW4gb2JqKSB7CiAgICAgIGlmICghXy5jb250YWlucyhrZXlzLCBrZXkpKQogICAgICAgIGNvcHlba2V5XSA9IG9ialtrZXldOwogICAgfQogICAgcmV0dXJuIGNvcHk7CiAgfTsKICAvLyBGaWxsIGluIGEgZ2l2ZW4gb2JqZWN0IHdpdGggZGVmYXVsdCBwcm9wZXJ0aWVzLgogIF8uZGVmYXVsdHMgPSBmdW5jdGlvbiAob2JqKSB7CiAgICBlYWNoKHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSwgZnVuY3Rpb24gKHNvdXJjZSkgewogICAgICBpZiAoc291cmNlKSB7CiAgICAgICAgZm9yICh2YXIgcHJvcCBpbiBzb3VyY2UpIHsKICAgICAgICAgIGlmIChvYmpbcHJvcF0gPT09IHZvaWQgMCkKICAgICAgICAgICAgb2JqW3Byb3BdID0gc291cmNlW3Byb3BdOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgICByZXR1cm4gb2JqOwogIH07CiAgLy8gQ3JlYXRlIGEgKHNoYWxsb3ctY2xvbmVkKSBkdXBsaWNhdGUgb2YgYW4gb2JqZWN0LgogIF8uY2xvbmUgPSBmdW5jdGlvbiAob2JqKSB7CiAgICBpZiAoIV8uaXNPYmplY3Qob2JqKSkKICAgICAgcmV0dXJuIG9iajsKICAgIHJldHVybiBfLmlzQXJyYXkob2JqKSA/IG9iai5zbGljZSgpIDogXy5leHRlbmQoe30sIG9iaik7CiAgfTsKICAvLyBJbnZva2VzIGludGVyY2VwdG9yIHdpdGggdGhlIG9iaiwgYW5kIHRoZW4gcmV0dXJucyBvYmouCiAgLy8gVGhlIHByaW1hcnkgcHVycG9zZSBvZiB0aGlzIG1ldGhvZCBpcyB0byAidGFwIGludG8iIGEgbWV0aG9kIGNoYWluLCBpbgogIC8vIG9yZGVyIHRvIHBlcmZvcm0gb3BlcmF0aW9ucyBvbiBpbnRlcm1lZGlhdGUgcmVzdWx0cyB3aXRoaW4gdGhlIGNoYWluLgogIF8udGFwID0gZnVuY3Rpb24gKG9iaiwgaW50ZXJjZXB0b3IpIHsKICAgIGludGVyY2VwdG9yKG9iaik7CiAgICByZXR1cm4gb2JqOwogIH07CiAgLy8gSW50ZXJuYWwgcmVjdXJzaXZlIGNvbXBhcmlzb24gZnVuY3Rpb24gZm9yIGBpc0VxdWFsYC4KICB2YXIgZXEgPSBmdW5jdGlvbiAoYSwgYiwgYVN0YWNrLCBiU3RhY2spIHsKICAgIC8vIElkZW50aWNhbCBvYmplY3RzIGFyZSBlcXVhbC4gYDAgPT09IC0wYCwgYnV0IHRoZXkgYXJlbid0IGlkZW50aWNhbC4KICAgIC8vIFNlZSB0aGUgW0hhcm1vbnkgYGVnYWxgIHByb3Bvc2FsXShodHRwOi8vd2lraS5lY21hc2NyaXB0Lm9yZy9kb2t1LnBocD9pZD1oYXJtb255OmVnYWwpLgogICAgaWYgKGEgPT09IGIpCiAgICAgIHJldHVybiBhICE9PSAwIHx8IDEgLyBhID09IDEgLyBiOwogICAgLy8gQSBzdHJpY3QgY29tcGFyaXNvbiBpcyBuZWNlc3NhcnkgYmVjYXVzZSBgbnVsbCA9PSB1bmRlZmluZWRgLgogICAgaWYgKGEgPT0gbnVsbCB8fCBiID09IG51bGwpCiAgICAgIHJldHVybiBhID09PSBiOwogICAgLy8gVW53cmFwIGFueSB3cmFwcGVkIG9iamVjdHMuCiAgICBpZiAoYSBpbnN0YW5jZW9mIF8pCiAgICAgIGEgPSBhLl93cmFwcGVkOwogICAgaWYgKGIgaW5zdGFuY2VvZiBfKQogICAgICBiID0gYi5fd3JhcHBlZDsKICAgIC8vIENvbXBhcmUgYFtbQ2xhc3NdXWAgbmFtZXMuCiAgICB2YXIgY2xhc3NOYW1lID0gdG9TdHJpbmcuY2FsbChhKTsKICAgIGlmIChjbGFzc05hbWUgIT0gdG9TdHJpbmcuY2FsbChiKSkKICAgICAgcmV0dXJuIGZhbHNlOwogICAgc3dpdGNoIChjbGFzc05hbWUpIHsKICAgIC8vIFN0cmluZ3MsIG51bWJlcnMsIGRhdGVzLCBhbmQgYm9vbGVhbnMgYXJlIGNvbXBhcmVkIGJ5IHZhbHVlLgogICAgY2FzZSAnW29iamVjdCBTdHJpbmddJzoKICAgICAgLy8gUHJpbWl0aXZlcyBhbmQgdGhlaXIgY29ycmVzcG9uZGluZyBvYmplY3Qgd3JhcHBlcnMgYXJlIGVxdWl2YWxlbnQ7IHRodXMsIGAiNSJgIGlzCiAgICAgIC8vIGVxdWl2YWxlbnQgdG8gYG5ldyBTdHJpbmcoIjUiKWAuCiAgICAgIHJldHVybiBhID09IFN0cmluZyhiKTsKICAgIGNhc2UgJ1tvYmplY3QgTnVtYmVyXSc6CiAgICAgIC8vIGBOYU5gcyBhcmUgZXF1aXZhbGVudCwgYnV0IG5vbi1yZWZsZXhpdmUuIEFuIGBlZ2FsYCBjb21wYXJpc29uIGlzIHBlcmZvcm1lZCBmb3IKICAgICAgLy8gb3RoZXIgbnVtZXJpYyB2YWx1ZXMuCiAgICAgIHJldHVybiBhICE9ICthID8gYiAhPSArYiA6IGEgPT0gMCA/IDEgLyBhID09IDEgLyBiIDogYSA9PSArYjsKICAgIGNhc2UgJ1tvYmplY3QgRGF0ZV0nOgogICAgY2FzZSAnW29iamVjdCBCb29sZWFuXSc6CiAgICAgIC8vIENvZXJjZSBkYXRlcyBhbmQgYm9vbGVhbnMgdG8gbnVtZXJpYyBwcmltaXRpdmUgdmFsdWVzLiBEYXRlcyBhcmUgY29tcGFyZWQgYnkgdGhlaXIKICAgICAgLy8gbWlsbGlzZWNvbmQgcmVwcmVzZW50YXRpb25zLiBOb3RlIHRoYXQgaW52YWxpZCBkYXRlcyB3aXRoIG1pbGxpc2Vjb25kIHJlcHJlc2VudGF0aW9ucwogICAgICAvLyBvZiBgTmFOYCBhcmUgbm90IGVxdWl2YWxlbnQuCiAgICAgIHJldHVybiArYSA9PSArYjsKICAgIC8vIFJlZ0V4cHMgYXJlIGNvbXBhcmVkIGJ5IHRoZWlyIHNvdXJjZSBwYXR0ZXJucyBhbmQgZmxhZ3MuCiAgICBjYXNlICdbb2JqZWN0IFJlZ0V4cF0nOgogICAgICByZXR1cm4gYS5zb3VyY2UgPT0gYi5zb3VyY2UgJiYgYS5nbG9iYWwgPT0gYi5nbG9iYWwgJiYgYS5tdWx0aWxpbmUgPT0gYi5tdWx0aWxpbmUgJiYgYS5pZ25vcmVDYXNlID09IGIuaWdub3JlQ2FzZTsKICAgIH0KICAgIGlmICh0eXBlb2YgYSAhPSAnb2JqZWN0JyB8fCB0eXBlb2YgYiAhPSAnb2JqZWN0JykKICAgICAgcmV0dXJuIGZhbHNlOwogICAgLy8gQXNzdW1lIGVxdWFsaXR5IGZvciBjeWNsaWMgc3RydWN0dXJlcy4gVGhlIGFsZ29yaXRobSBmb3IgZGV0ZWN0aW5nIGN5Y2xpYwogICAgLy8gc3RydWN0dXJlcyBpcyBhZGFwdGVkIGZyb20gRVMgNS4xIHNlY3Rpb24gMTUuMTIuMywgYWJzdHJhY3Qgb3BlcmF0aW9uIGBKT2AuCiAgICB2YXIgbGVuZ3RoID0gYVN0YWNrLmxlbmd0aDsKICAgIHdoaWxlIChsZW5ndGgtLSkgewogICAgICAvLyBMaW5lYXIgc2VhcmNoLiBQZXJmb3JtYW5jZSBpcyBpbnZlcnNlbHkgcHJvcG9ydGlvbmFsIHRvIHRoZSBudW1iZXIgb2YKICAgICAgLy8gdW5pcXVlIG5lc3RlZCBzdHJ1Y3R1cmVzLgogICAgICBpZiAoYVN0YWNrW2xlbmd0aF0gPT0gYSkKICAgICAgICByZXR1cm4gYlN0YWNrW2xlbmd0aF0gPT0gYjsKICAgIH0KICAgIC8vIE9iamVjdHMgd2l0aCBkaWZmZXJlbnQgY29uc3RydWN0b3JzIGFyZSBub3QgZXF1aXZhbGVudCwgYnV0IGBPYmplY3RgcwogICAgLy8gZnJvbSBkaWZmZXJlbnQgZnJhbWVzIGFyZS4KICAgIHZhciBhQ3RvciA9IGEuY29uc3RydWN0b3IsIGJDdG9yID0gYi5jb25zdHJ1Y3RvcjsKICAgIGlmIChhQ3RvciAhPT0gYkN0b3IgJiYgIShfLmlzRnVuY3Rpb24oYUN0b3IpICYmIGFDdG9yIGluc3RhbmNlb2YgYUN0b3IgJiYgXy5pc0Z1bmN0aW9uKGJDdG9yKSAmJiBiQ3RvciBpbnN0YW5jZW9mIGJDdG9yKSAmJiAoJ2NvbnN0cnVjdG9yJyBpbiBhICYmICdjb25zdHJ1Y3RvcicgaW4gYikpIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgLy8gQWRkIHRoZSBmaXJzdCBvYmplY3QgdG8gdGhlIHN0YWNrIG9mIHRyYXZlcnNlZCBvYmplY3RzLgogICAgYVN0YWNrLnB1c2goYSk7CiAgICBiU3RhY2sucHVzaChiKTsKICAgIHZhciBzaXplID0gMCwgcmVzdWx0ID0gdHJ1ZTsKICAgIC8vIFJlY3Vyc2l2ZWx5IGNvbXBhcmUgb2JqZWN0cyBhbmQgYXJyYXlzLgogICAgaWYgKGNsYXNzTmFtZSA9PSAnW29iamVjdCBBcnJheV0nKSB7CiAgICAgIC8vIENvbXBhcmUgYXJyYXkgbGVuZ3RocyB0byBkZXRlcm1pbmUgaWYgYSBkZWVwIGNvbXBhcmlzb24gaXMgbmVjZXNzYXJ5LgogICAgICBzaXplID0gYS5sZW5ndGg7CiAgICAgIHJlc3VsdCA9IHNpemUgPT0gYi5sZW5ndGg7CiAgICAgIGlmIChyZXN1bHQpIHsKICAgICAgICAvLyBEZWVwIGNvbXBhcmUgdGhlIGNvbnRlbnRzLCBpZ25vcmluZyBub24tbnVtZXJpYyBwcm9wZXJ0aWVzLgogICAgICAgIHdoaWxlIChzaXplLS0pIHsKICAgICAgICAgIGlmICghKHJlc3VsdCA9IGVxKGFbc2l6ZV0sIGJbc2l6ZV0sIGFTdGFjaywgYlN0YWNrKSkpCiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgLy8gRGVlcCBjb21wYXJlIG9iamVjdHMuCiAgICAgIGZvciAodmFyIGtleSBpbiBhKSB7CiAgICAgICAgaWYgKF8uaGFzKGEsIGtleSkpIHsKICAgICAgICAgIC8vIENvdW50IHRoZSBleHBlY3RlZCBudW1iZXIgb2YgcHJvcGVydGllcy4KICAgICAgICAgIHNpemUrKzsKICAgICAgICAgIC8vIERlZXAgY29tcGFyZSBlYWNoIG1lbWJlci4KICAgICAgICAgIGlmICghKHJlc3VsdCA9IF8uaGFzKGIsIGtleSkgJiYgZXEoYVtrZXldLCBiW2tleV0sIGFTdGFjaywgYlN0YWNrKSkpCiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgfQogICAgICAvLyBFbnN1cmUgdGhhdCBib3RoIG9iamVjdHMgY29udGFpbiB0aGUgc2FtZSBudW1iZXIgb2YgcHJvcGVydGllcy4KICAgICAgaWYgKHJlc3VsdCkgewogICAgICAgIGZvciAoa2V5IGluIGIpIHsKICAgICAgICAgIGlmIChfLmhhcyhiLCBrZXkpICYmICFzaXplLS0pCiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgICByZXN1bHQgPSAhc2l6ZTsKICAgICAgfQogICAgfQogICAgLy8gUmVtb3ZlIHRoZSBmaXJzdCBvYmplY3QgZnJvbSB0aGUgc3RhY2sgb2YgdHJhdmVyc2VkIG9iamVjdHMuCiAgICBhU3RhY2sucG9wKCk7CiAgICBiU3RhY2sucG9wKCk7CiAgICByZXR1cm4gcmVzdWx0OwogIH07CiAgLy8gUGVyZm9ybSBhIGRlZXAgY29tcGFyaXNvbiB0byBjaGVjayBpZiB0d28gb2JqZWN0cyBhcmUgZXF1YWwuCiAgXy5pc0VxdWFsID0gZnVuY3Rpb24gKGEsIGIpIHsKICAgIHJldHVybiBlcShhLCBiLCBbXSwgW10pOwogIH07CiAgLy8gSXMgYSBnaXZlbiBhcnJheSwgc3RyaW5nLCBvciBvYmplY3QgZW1wdHk/CiAgLy8gQW4gImVtcHR5IiBvYmplY3QgaGFzIG5vIGVudW1lcmFibGUgb3duLXByb3BlcnRpZXMuCiAgXy5pc0VtcHR5ID0gZnVuY3Rpb24gKG9iaikgewogICAgaWYgKG9iaiA9PSBudWxsKQogICAgICByZXR1cm4gdHJ1ZTsKICAgIGlmIChfLmlzQXJyYXkob2JqKSB8fCBfLmlzU3RyaW5nKG9iaikpCiAgICAgIHJldHVybiBvYmoubGVuZ3RoID09PSAwOwogICAgZm9yICh2YXIga2V5IGluIG9iaikKICAgICAgaWYgKF8uaGFzKG9iaiwga2V5KSkKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICByZXR1cm4gdHJ1ZTsKICB9OwogIC8vIElzIGEgZ2l2ZW4gdmFsdWUgYSBET00gZWxlbWVudD8KICBfLmlzRWxlbWVudCA9IGZ1bmN0aW9uIChvYmopIHsKICAgIHJldHVybiAhIShvYmogJiYgb2JqLm5vZGVUeXBlID09PSAxKTsKICB9OwogIC8vIElzIGEgZ2l2ZW4gdmFsdWUgYW4gYXJyYXk/CiAgLy8gRGVsZWdhdGVzIHRvIEVDTUE1J3MgbmF0aXZlIEFycmF5LmlzQXJyYXkKICBfLmlzQXJyYXkgPSBuYXRpdmVJc0FycmF5IHx8IGZ1bmN0aW9uIChvYmopIHsKICAgIHJldHVybiB0b1N0cmluZy5jYWxsKG9iaikgPT0gJ1tvYmplY3QgQXJyYXldJzsKICB9OwogIC8vIElzIGEgZ2l2ZW4gdmFyaWFibGUgYW4gb2JqZWN0PwogIF8uaXNPYmplY3QgPSBmdW5jdGlvbiAob2JqKSB7CiAgICByZXR1cm4gb2JqID09PSBPYmplY3Qob2JqKTsKICB9OwogIC8vIEFkZCBzb21lIGlzVHlwZSBtZXRob2RzOiBpc0FyZ3VtZW50cywgaXNGdW5jdGlvbiwgaXNTdHJpbmcsIGlzTnVtYmVyLCBpc0RhdGUsIGlzUmVnRXhwLgogIGVhY2goWwogICAgJ0FyZ3VtZW50cycsCiAgICAnRnVuY3Rpb24nLAogICAgJ1N0cmluZycsCiAgICAnTnVtYmVyJywKICAgICdEYXRlJywKICAgICdSZWdFeHAnCiAgXSwgZnVuY3Rpb24gKG5hbWUpIHsKICAgIF9bJ2lzJyArIG5hbWVdID0gZnVuY3Rpb24gKG9iaikgewogICAgICByZXR1cm4gdG9TdHJpbmcuY2FsbChvYmopID09ICdbb2JqZWN0ICcgKyBuYW1lICsgJ10nOwogICAgfTsKICB9KTsKICAvLyBEZWZpbmUgYSBmYWxsYmFjayB2ZXJzaW9uIG9mIHRoZSBtZXRob2QgaW4gYnJvd3NlcnMgKGFoZW0sIElFKSwgd2hlcmUKICAvLyB0aGVyZSBpc24ndCBhbnkgaW5zcGVjdGFibGUgIkFyZ3VtZW50cyIgdHlwZS4KICBpZiAoIV8uaXNBcmd1bWVudHMoYXJndW1lbnRzKSkgewogICAgXy5pc0FyZ3VtZW50cyA9IGZ1bmN0aW9uIChvYmopIHsKICAgICAgcmV0dXJuICEhKG9iaiAmJiBfLmhhcyhvYmosICdjYWxsZWUnKSk7CiAgICB9OwogIH0KICAvLyBPcHRpbWl6ZSBgaXNGdW5jdGlvbmAgaWYgYXBwcm9wcmlhdGUuCiAgaWYgKHR5cGVvZiAvLi8gIT09ICdmdW5jdGlvbicpIHsKICAgIF8uaXNGdW5jdGlvbiA9IGZ1bmN0aW9uIChvYmopIHsKICAgICAgcmV0dXJuIHR5cGVvZiBvYmogPT09ICdmdW5jdGlvbic7CiAgICB9OwogIH0KICAvLyBJcyBhIGdpdmVuIG9iamVjdCBhIGZpbml0ZSBudW1iZXI/CiAgXy5pc0Zpbml0ZSA9IGZ1bmN0aW9uIChvYmopIHsKICAgIHJldHVybiBpc0Zpbml0ZShvYmopICYmICFpc05hTihwYXJzZUZsb2F0KG9iaikpOwogIH07CiAgLy8gSXMgdGhlIGdpdmVuIHZhbHVlIGBOYU5gPyAoTmFOIGlzIHRoZSBvbmx5IG51bWJlciB3aGljaCBkb2VzIG5vdCBlcXVhbCBpdHNlbGYpLgogIF8uaXNOYU4gPSBmdW5jdGlvbiAob2JqKSB7CiAgICByZXR1cm4gXy5pc051bWJlcihvYmopICYmIG9iaiAhPSArb2JqOwogIH07CiAgLy8gSXMgYSBnaXZlbiB2YWx1ZSBhIGJvb2xlYW4/CiAgXy5pc0Jvb2xlYW4gPSBmdW5jdGlvbiAob2JqKSB7CiAgICByZXR1cm4gb2JqID09PSB0cnVlIHx8IG9iaiA9PT0gZmFsc2UgfHwgdG9TdHJpbmcuY2FsbChvYmopID09ICdbb2JqZWN0IEJvb2xlYW5dJzsKICB9OwogIC8vIElzIGEgZ2l2ZW4gdmFsdWUgZXF1YWwgdG8gbnVsbD8KICBfLmlzTnVsbCA9IGZ1bmN0aW9uIChvYmopIHsKICAgIHJldHVybiBvYmogPT09IG51bGw7CiAgfTsKICAvLyBJcyBhIGdpdmVuIHZhcmlhYmxlIHVuZGVmaW5lZD8KICBfLmlzVW5kZWZpbmVkID0gZnVuY3Rpb24gKG9iaikgewogICAgcmV0dXJuIG9iaiA9PT0gdm9pZCAwOwogIH07CiAgLy8gU2hvcnRjdXQgZnVuY3Rpb24gZm9yIGNoZWNraW5nIGlmIGFuIG9iamVjdCBoYXMgYSBnaXZlbiBwcm9wZXJ0eSBkaXJlY3RseQogIC8vIG9uIGl0c2VsZiAoaW4gb3RoZXIgd29yZHMsIG5vdCBvbiBhIHByb3RvdHlwZSkuCiAgXy5oYXMgPSBmdW5jdGlvbiAob2JqLCBrZXkpIHsKICAgIHJldHVybiBoYXNPd25Qcm9wZXJ0eS5jYWxsKG9iaiwga2V5KTsKICB9OwogIC8vIFV0aWxpdHkgRnVuY3Rpb25zCiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0KICAvLyBSdW4gVW5kZXJzY29yZS5qcyBpbiAqbm9Db25mbGljdCogbW9kZSwgcmV0dXJuaW5nIHRoZSBgX2AgdmFyaWFibGUgdG8gaXRzCiAgLy8gcHJldmlvdXMgb3duZXIuIFJldHVybnMgYSByZWZlcmVuY2UgdG8gdGhlIFVuZGVyc2NvcmUgb2JqZWN0LgogIF8ubm9Db25mbGljdCA9IGZ1bmN0aW9uICgpIHsKICAgIHJvb3QuXyA9IHByZXZpb3VzVW5kZXJzY29yZTsKICAgIHJldHVybiB0aGlzOwogIH07CiAgLy8gS2VlcCB0aGUgaWRlbnRpdHkgZnVuY3Rpb24gYXJvdW5kIGZvciBkZWZhdWx0IGl0ZXJhdG9ycy4KICBfLmlkZW50aXR5ID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgICByZXR1cm4gdmFsdWU7CiAgfTsKICBfLmNvbnN0YW50ID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gdmFsdWU7CiAgICB9OwogIH07CiAgXy5wcm9wZXJ0eSA9IGZ1bmN0aW9uIChrZXkpIHsKICAgIHJldHVybiBmdW5jdGlvbiAob2JqKSB7CiAgICAgIHJldHVybiBvYmpba2V5XTsKICAgIH07CiAgfTsKICAvLyBSZXR1cm5zIGEgcHJlZGljYXRlIGZvciBjaGVja2luZyB3aGV0aGVyIGFuIG9iamVjdCBoYXMgYSBnaXZlbiBzZXQgb2YgYGtleTp2YWx1ZWAgcGFpcnMuCiAgXy5tYXRjaGVzID0gZnVuY3Rpb24gKGF0dHJzKSB7CiAgICByZXR1cm4gZnVuY3Rpb24gKG9iaikgewogICAgICBpZiAob2JqID09PSBhdHRycykKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgLy9hdm9pZCBjb21wYXJpbmcgYW4gb2JqZWN0IHRvIGl0c2VsZi4KICAgICAgZm9yICh2YXIga2V5IGluIGF0dHJzKSB7CiAgICAgICAgaWYgKGF0dHJzW2tleV0gIT09IG9ialtrZXldKQogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIHJldHVybiB0cnVlOwogICAgfTsKICB9OwogIC8vIFJ1biBhIGZ1bmN0aW9uICoqbioqIHRpbWVzLgogIF8udGltZXMgPSBmdW5jdGlvbiAobiwgaXRlcmF0b3IsIGNvbnRleHQpIHsKICAgIHZhciBhY2N1bSA9IEFycmF5KE1hdGgubWF4KDAsIG4pKTsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbjsgaSsrKQogICAgICBhY2N1bVtpXSA9IGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgaSk7CiAgICByZXR1cm4gYWNjdW07CiAgfTsKICAvLyBSZXR1cm4gYSByYW5kb20gaW50ZWdlciBiZXR3ZWVuIG1pbiBhbmQgbWF4IChpbmNsdXNpdmUpLgogIF8ucmFuZG9tID0gZnVuY3Rpb24gKG1pbiwgbWF4KSB7CiAgICBpZiAobWF4ID09IG51bGwpIHsKICAgICAgbWF4ID0gbWluOwogICAgICBtaW4gPSAwOwogICAgfQogICAgcmV0dXJuIG1pbiArIE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIChtYXggLSBtaW4gKyAxKSk7CiAgfTsKICAvLyBBIChwb3NzaWJseSBmYXN0ZXIpIHdheSB0byBnZXQgdGhlIGN1cnJlbnQgdGltZXN0YW1wIGFzIGFuIGludGVnZXIuCiAgXy5ub3cgPSBEYXRlLm5vdyB8fCBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gbmV3IERhdGUoKS5nZXRUaW1lKCk7CiAgfTsKICAvLyBMaXN0IG9mIEhUTUwgZW50aXRpZXMgZm9yIGVzY2FwaW5nLgogIHZhciBlbnRpdHlNYXAgPSB7CiAgICBlc2NhcGU6IHsKICAgICAgJyYnOiAnJmFtcDsnLAogICAgICAnPCc6ICcmbHQ7JywKICAgICAgJz4nOiAnJmd0OycsCiAgICAgICciJzogJyZxdW90OycsCiAgICAgICdcJyc6ICcmI3gyNzsnCiAgICB9CiAgfTsKICBlbnRpdHlNYXAudW5lc2NhcGUgPSBfLmludmVydChlbnRpdHlNYXAuZXNjYXBlKTsKICAvLyBSZWdleGVzIGNvbnRhaW5pbmcgdGhlIGtleXMgYW5kIHZhbHVlcyBsaXN0ZWQgaW1tZWRpYXRlbHkgYWJvdmUuCiAgdmFyIGVudGl0eVJlZ2V4ZXMgPSB7CiAgICBlc2NhcGU6IG5ldyBSZWdFeHAoJ1snICsgXy5rZXlzKGVudGl0eU1hcC5lc2NhcGUpLmpvaW4oJycpICsgJ10nLCAnZycpLAogICAgdW5lc2NhcGU6IG5ldyBSZWdFeHAoJygnICsgXy5rZXlzKGVudGl0eU1hcC51bmVzY2FwZSkuam9pbignfCcpICsgJyknLCAnZycpCiAgfTsKICAvLyBGdW5jdGlvbnMgZm9yIGVzY2FwaW5nIGFuZCB1bmVzY2FwaW5nIHN0cmluZ3MgdG8vZnJvbSBIVE1MIGludGVycG9sYXRpb24uCiAgXy5lYWNoKFsKICAgICdlc2NhcGUnLAogICAgJ3VuZXNjYXBlJwogIF0sIGZ1bmN0aW9uIChtZXRob2QpIHsKICAgIF9bbWV0aG9kXSA9IGZ1bmN0aW9uIChzdHJpbmcpIHsKICAgICAgaWYgKHN0cmluZyA9PSBudWxsKQogICAgICAgIHJldHVybiAnJzsKICAgICAgcmV0dXJuICgnJyArIHN0cmluZykucmVwbGFjZShlbnRpdHlSZWdleGVzW21ldGhvZF0sIGZ1bmN0aW9uIChtYXRjaCkgewogICAgICAgIHJldHVybiBlbnRpdHlNYXBbbWV0aG9kXVttYXRjaF07CiAgICAgIH0pOwogICAgfTsKICB9KTsKICAvLyBJZiB0aGUgdmFsdWUgb2YgdGhlIG5hbWVkIGBwcm9wZXJ0eWAgaXMgYSBmdW5jdGlvbiB0aGVuIGludm9rZSBpdCB3aXRoIHRoZQogIC8vIGBvYmplY3RgIGFzIGNvbnRleHQ7IG90aGVyd2lzZSwgcmV0dXJuIGl0LgogIF8ucmVzdWx0ID0gZnVuY3Rpb24gKG9iamVjdCwgcHJvcGVydHkpIHsKICAgIGlmIChvYmplY3QgPT0gbnVsbCkKICAgICAgcmV0dXJuIHZvaWQgMDsKICAgIHZhciB2YWx1ZSA9IG9iamVjdFtwcm9wZXJ0eV07CiAgICByZXR1cm4gXy5pc0Z1bmN0aW9uKHZhbHVlKSA/IHZhbHVlLmNhbGwob2JqZWN0KSA6IHZhbHVlOwogIH07CiAgLy8gQWRkIHlvdXIgb3duIGN1c3RvbSBmdW5jdGlvbnMgdG8gdGhlIFVuZGVyc2NvcmUgb2JqZWN0LgogIF8ubWl4aW4gPSBmdW5jdGlvbiAob2JqKSB7CiAgICBlYWNoKF8uZnVuY3Rpb25zKG9iaiksIGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgIHZhciBmdW5jID0gX1tuYW1lXSA9IG9ialtuYW1lXTsKICAgICAgXy5wcm90b3R5cGVbbmFtZV0gPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIGFyZ3MgPSBbdGhpcy5fd3JhcHBlZF07CiAgICAgICAgcHVzaC5hcHBseShhcmdzLCBhcmd1bWVudHMpOwogICAgICAgIHJldHVybiByZXN1bHQuY2FsbCh0aGlzLCBmdW5jLmFwcGx5KF8sIGFyZ3MpKTsKICAgICAgfTsKICAgIH0pOwogIH07CiAgLy8gR2VuZXJhdGUgYSB1bmlxdWUgaW50ZWdlciBpZCAodW5pcXVlIHdpdGhpbiB0aGUgZW50aXJlIGNsaWVudCBzZXNzaW9uKS4KICAvLyBVc2VmdWwgZm9yIHRlbXBvcmFyeSBET00gaWRzLgogIHZhciBpZENvdW50ZXIgPSAwOwogIF8udW5pcXVlSWQgPSBmdW5jdGlvbiAocHJlZml4KSB7CiAgICB2YXIgaWQgPSArK2lkQ291bnRlciArICcnOwogICAgcmV0dXJuIHByZWZpeCA/IHByZWZpeCArIGlkIDogaWQ7CiAgfTsKICAvLyBCeSBkZWZhdWx0LCBVbmRlcnNjb3JlIHVzZXMgRVJCLXN0eWxlIHRlbXBsYXRlIGRlbGltaXRlcnMsIGNoYW5nZSB0aGUKICAvLyBmb2xsb3dpbmcgdGVtcGxhdGUgc2V0dGluZ3MgdG8gdXNlIGFsdGVybmF0aXZlIGRlbGltaXRlcnMuCiAgXy50ZW1wbGF0ZVNldHRpbmdzID0gewogICAgZXZhbHVhdGU6IC88JShbXHNcU10rPyklPi9nLAogICAgaW50ZXJwb2xhdGU6IC88JT0oW1xzXFNdKz8pJT4vZywKICAgIGVzY2FwZTogLzwlLShbXHNcU10rPyklPi9nCiAgfTsKICAvLyBXaGVuIGN1c3RvbWl6aW5nIGB0ZW1wbGF0ZVNldHRpbmdzYCwgaWYgeW91IGRvbid0IHdhbnQgdG8gZGVmaW5lIGFuCiAgLy8gaW50ZXJwb2xhdGlvbiwgZXZhbHVhdGlvbiBvciBlc2NhcGluZyByZWdleCwgd2UgbmVlZCBvbmUgdGhhdCBpcwogIC8vIGd1YXJhbnRlZWQgbm90IHRvIG1hdGNoLgogIHZhciBub01hdGNoID0gLyguKV4vOwogIC8vIENlcnRhaW4gY2hhcmFjdGVycyBuZWVkIHRvIGJlIGVzY2FwZWQgc28gdGhhdCB0aGV5IGNhbiBiZSBwdXQgaW50byBhCiAgLy8gc3RyaW5nIGxpdGVyYWwuCiAgdmFyIGVzY2FwZXMgPSB7CiAgICAnXCcnOiAnXCcnLAogICAgJ1xcJzogJ1xcJywKICAgICdccic6ICdyJywKICAgICdcbic6ICduJywKICAgICdcdCc6ICd0JywKICAgICdcdTIwMjgnOiAndTIwMjgnLAogICAgJ1x1MjAyOSc6ICd1MjAyOScKICB9OwogIHZhciBlc2NhcGVyID0gL1xcfCd8XHJ8XG58XHR8XHUyMDI4fFx1MjAyOS9nOwogIC8vIEphdmFTY3JpcHQgbWljcm8tdGVtcGxhdGluZywgc2ltaWxhciB0byBKb2huIFJlc2lnJ3MgaW1wbGVtZW50YXRpb24uCiAgLy8gVW5kZXJzY29yZSB0ZW1wbGF0aW5nIGhhbmRsZXMgYXJiaXRyYXJ5IGRlbGltaXRlcnMsIHByZXNlcnZlcyB3aGl0ZXNwYWNlLAogIC8vIGFuZCBjb3JyZWN0bHkgZXNjYXBlcyBxdW90ZXMgd2l0aGluIGludGVycG9sYXRlZCBjb2RlLgogIF8udGVtcGxhdGUgPSBmdW5jdGlvbiAodGV4dCwgZGF0YSwgc2V0dGluZ3MpIHsKICAgIHZhciByZW5kZXI7CiAgICBzZXR0aW5ncyA9IF8uZGVmYXVsdHMoe30sIHNldHRpbmdzLCBfLnRlbXBsYXRlU2V0dGluZ3MpOwogICAgLy8gQ29tYmluZSBkZWxpbWl0ZXJzIGludG8gb25lIHJlZ3VsYXIgZXhwcmVzc2lvbiB2aWEgYWx0ZXJuYXRpb24uCiAgICB2YXIgbWF0Y2hlciA9IG5ldyBSZWdFeHAoWwogICAgICAoc2V0dGluZ3MuZXNjYXBlIHx8IG5vTWF0Y2gpLnNvdXJjZSwKICAgICAgKHNldHRpbmdzLmludGVycG9sYXRlIHx8IG5vTWF0Y2gpLnNvdXJjZSwKICAgICAgKHNldHRpbmdzLmV2YWx1YXRlIHx8IG5vTWF0Y2gpLnNvdXJjZQogICAgXS5qb2luKCd8JykgKyAnfCQnLCAnZycpOwogICAgLy8gQ29tcGlsZSB0aGUgdGVtcGxhdGUgc291cmNlLCBlc2NhcGluZyBzdHJpbmcgbGl0ZXJhbHMgYXBwcm9wcmlhdGVseS4KICAgIHZhciBpbmRleCA9IDA7CiAgICB2YXIgc291cmNlID0gJ19fcCs9XCcnOwogICAgdGV4dC5yZXBsYWNlKG1hdGNoZXIsIGZ1bmN0aW9uIChtYXRjaCwgZXNjYXBlLCBpbnRlcnBvbGF0ZSwgZXZhbHVhdGUsIG9mZnNldCkgewogICAgICBzb3VyY2UgKz0gdGV4dC5zbGljZShpbmRleCwgb2Zmc2V0KS5yZXBsYWNlKGVzY2FwZXIsIGZ1bmN0aW9uIChtYXRjaCkgewogICAgICAgIHJldHVybiAnXFwnICsgZXNjYXBlc1ttYXRjaF07CiAgICAgIH0pOwogICAgICBpZiAoZXNjYXBlKSB7CiAgICAgICAgc291cmNlICs9ICdcJytcbigoX190PSgnICsgZXNjYXBlICsgJykpPT1udWxsP1wnXCc6Xy5lc2NhcGUoX190KSkrXG5cJyc7CiAgICAgIH0KICAgICAgaWYgKGludGVycG9sYXRlKSB7CiAgICAgICAgc291cmNlICs9ICdcJytcbigoX190PSgnICsgaW50ZXJwb2xhdGUgKyAnKSk9PW51bGw/XCdcJzpfX3QpK1xuXCcnOwogICAgICB9CiAgICAgIGlmIChldmFsdWF0ZSkgewogICAgICAgIHNvdXJjZSArPSAnXCc7XG4nICsgZXZhbHVhdGUgKyAnXG5fX3ArPVwnJzsKICAgICAgfQogICAgICBpbmRleCA9IG9mZnNldCArIG1hdGNoLmxlbmd0aDsKICAgICAgcmV0dXJuIG1hdGNoOwogICAgfSk7CiAgICBzb3VyY2UgKz0gJ1wnO1xuJzsKICAgIC8vIElmIGEgdmFyaWFibGUgaXMgbm90IHNwZWNpZmllZCwgcGxhY2UgZGF0YSB2YWx1ZXMgaW4gbG9jYWwgc2NvcGUuCiAgICBpZiAoIXNldHRpbmdzLnZhcmlhYmxlKQogICAgICBzb3VyY2UgPSAnd2l0aChvYmp8fHt9KXtcbicgKyBzb3VyY2UgKyAnfVxuJzsKICAgIHNvdXJjZSA9ICd2YXIgX190LF9fcD1cJ1wnLF9faj1BcnJheS5wcm90b3R5cGUuam9pbiwnICsgJ3ByaW50PWZ1bmN0aW9uKCl7X19wKz1fX2ouY2FsbChhcmd1bWVudHMsXCdcJyk7fTtcbicgKyBzb3VyY2UgKyAncmV0dXJuIF9fcDtcbic7CiAgICB0cnkgewogICAgICByZW5kZXIgPSBuZXcgRnVuY3Rpb24oc2V0dGluZ3MudmFyaWFibGUgfHwgJ29iaicsICdfJywgc291cmNlKTsKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgZS5zb3VyY2UgPSBzb3VyY2U7CiAgICAgIHRocm93IGU7CiAgICB9CiAgICBpZiAoZGF0YSkKICAgICAgcmV0dXJuIHJlbmRlcihkYXRhLCBfKTsKICAgIHZhciB0ZW1wbGF0ZSA9IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgIHJldHVybiByZW5kZXIuY2FsbCh0aGlzLCBkYXRhLCBfKTsKICAgIH07CiAgICAvLyBQcm92aWRlIHRoZSBjb21waWxlZCBmdW5jdGlvbiBzb3VyY2UgYXMgYSBjb252ZW5pZW5jZSBmb3IgcHJlY29tcGlsYXRpb24uCiAgICB0ZW1wbGF0ZS5zb3VyY2UgPSAnZnVuY3Rpb24oJyArIChzZXR0aW5ncy52YXJpYWJsZSB8fCAnb2JqJykgKyAnKXtcbicgKyBzb3VyY2UgKyAnfSc7CiAgICByZXR1cm4gdGVtcGxhdGU7CiAgfTsKICAvLyBBZGQgYSAiY2hhaW4iIGZ1bmN0aW9uLCB3aGljaCB3aWxsIGRlbGVnYXRlIHRvIHRoZSB3cmFwcGVyLgogIF8uY2hhaW4gPSBmdW5jdGlvbiAob2JqKSB7CiAgICByZXR1cm4gXyhvYmopLmNoYWluKCk7CiAgfTsKICAvLyBPT1AKICAvLyAtLS0tLS0tLS0tLS0tLS0KICAvLyBJZiBVbmRlcnNjb3JlIGlzIGNhbGxlZCBhcyBhIGZ1bmN0aW9uLCBpdCByZXR1cm5zIGEgd3JhcHBlZCBvYmplY3QgdGhhdAogIC8vIGNhbiBiZSB1c2VkIE9PLXN0eWxlLiBUaGlzIHdyYXBwZXIgaG9sZHMgYWx0ZXJlZCB2ZXJzaW9ucyBvZiBhbGwgdGhlCiAgLy8gdW5kZXJzY29yZSBmdW5jdGlvbnMuIFdyYXBwZWQgb2JqZWN0cyBtYXkgYmUgY2hhaW5lZC4KICAvLyBIZWxwZXIgZnVuY3Rpb24gdG8gY29udGludWUgY2hhaW5pbmcgaW50ZXJtZWRpYXRlIHJlc3VsdHMuCiAgdmFyIHJlc3VsdCA9IGZ1bmN0aW9uIChvYmopIHsKICAgIHJldHVybiB0aGlzLl9jaGFpbiA/IF8ob2JqKS5jaGFpbigpIDogb2JqOwogIH07CiAgLy8gQWRkIGFsbCBvZiB0aGUgVW5kZXJzY29yZSBmdW5jdGlvbnMgdG8gdGhlIHdyYXBwZXIgb2JqZWN0LgogIF8ubWl4aW4oXyk7CiAgLy8gQWRkIGFsbCBtdXRhdG9yIEFycmF5IGZ1bmN0aW9ucyB0byB0aGUgd3JhcHBlci4KICBlYWNoKFsKICAgICdwb3AnLAogICAgJ3B1c2gnLAogICAgJ3JldmVyc2UnLAogICAgJ3NoaWZ0JywKICAgICdzb3J0JywKICAgICdzcGxpY2UnLAogICAgJ3Vuc2hpZnQnCiAgXSwgZnVuY3Rpb24gKG5hbWUpIHsKICAgIHZhciBtZXRob2QgPSBBcnJheVByb3RvW25hbWVdOwogICAgXy5wcm90b3R5cGVbbmFtZV0gPSBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBvYmogPSB0aGlzLl93cmFwcGVkOwogICAgICBtZXRob2QuYXBwbHkob2JqLCBhcmd1bWVudHMpOwogICAgICBpZiAoKG5hbWUgPT0gJ3NoaWZ0JyB8fCBuYW1lID09ICdzcGxpY2UnKSAmJiBvYmoubGVuZ3RoID09PSAwKQogICAgICAgIGRlbGV0ZSBvYmpbMF07CiAgICAgIHJldHVybiByZXN1bHQuY2FsbCh0aGlzLCBvYmopOwogICAgfTsKICB9KTsKICAvLyBBZGQgYWxsIGFjY2Vzc29yIEFycmF5IGZ1bmN0aW9ucyB0byB0aGUgd3JhcHBlci4KICBlYWNoKFsKICAgICdjb25jYXQnLAogICAgJ2pvaW4nLAogICAgJ3NsaWNlJwogIF0sIGZ1bmN0aW9uIChuYW1lKSB7CiAgICB2YXIgbWV0aG9kID0gQXJyYXlQcm90b1tuYW1lXTsKICAgIF8ucHJvdG90eXBlW25hbWVdID0gZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gcmVzdWx0LmNhbGwodGhpcywgbWV0aG9kLmFwcGx5KHRoaXMuX3dyYXBwZWQsIGFyZ3VtZW50cykpOwogICAgfTsKICB9KTsKICBfLmV4dGVuZChfLnByb3RvdHlwZSwgewogICAgLy8gU3RhcnQgY2hhaW5pbmcgYSB3cmFwcGVkIFVuZGVyc2NvcmUgb2JqZWN0LgogICAgY2hhaW46IGZ1bmN0aW9uICgpIHsKICAgICAgdGhpcy5fY2hhaW4gPSB0cnVlOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgICAvLyBFeHRyYWN0cyB0aGUgcmVzdWx0IGZyb20gYSB3cmFwcGVkIGFuZCBjaGFpbmVkIG9iamVjdC4KICAgIHZhbHVlOiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiB0aGlzLl93cmFwcGVkOwogICAgfQogIH0pOwogIC8vIEFNRCByZWdpc3RyYXRpb24gaGFwcGVucyBhdCB0aGUgZW5kIGZvciBjb21wYXRpYmlsaXR5IHdpdGggQU1EIGxvYWRlcnMKICAvLyB0aGF0IG1heSBub3QgZW5mb3JjZSBuZXh0LXR1cm4gc2VtYW50aWNzIG9uIG1vZHVsZXMuIEV2ZW4gdGhvdWdoIGdlbmVyYWwKICAvLyBwcmFjdGljZSBmb3IgQU1EIHJlZ2lzdHJhdGlvbiBpcyB0byBiZSBhbm9ueW1vdXMsIHVuZGVyc2NvcmUgcmVnaXN0ZXJzCiAgLy8gYXMgYSBuYW1lZCBtb2R1bGUgYmVjYXVzZSwgbGlrZSBqUXVlcnksIGl0IGlzIGEgYmFzZSBsaWJyYXJ5IHRoYXQgaXMKICAvLyBwb3B1bGFyIGVub3VnaCB0byBiZSBidW5kbGVkIGluIGEgdGhpcmQgcGFydHkgbGliLCBidXQgbm90IGJlIHBhcnQgb2YKICAvLyBhbiBBTUQgbG9hZCByZXF1ZXN0LiBUaG9zZSBjYXNlcyBjb3VsZCBnZW5lcmF0ZSBhbiBlcnJvciB3aGVuIGFuCiAgLy8gYW5vbnltb3VzIGRlZmluZSgpIGlzIGNhbGxlZCBvdXRzaWRlIG9mIGEgbG9hZGVyIHJlcXVlc3QuCiAgaWYgKHRydWUpIHsKICAgIHVuZGVyc2NvcmUgPSBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBfOwogICAgfSgpOwogIH0KfS5jYWxsKHRoaXMpKTsKLyohCiAqIGpRdWVyeSBKYXZhU2NyaXB0IExpYnJhcnkgdjIuMS4xCiAqIGh0dHA6Ly9qcXVlcnkuY29tLwogKgogKiBJbmNsdWRlcyBTaXp6bGUuanMKICogaHR0cDovL3NpenpsZWpzLmNvbS8KICoKICogQ29weXJpZ2h0IDIwMDUsIDIwMTQgalF1ZXJ5IEZvdW5kYXRpb24sIEluYy4gYW5kIG90aGVyIGNvbnRyaWJ1dG9ycwogKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UKICogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQogKgogKiBEYXRlOiAyMDE0LTA1LTAxVDE3OjExWgogKi8KKGZ1bmN0aW9uIChnbG9iYWwsIGZhY3RvcnkpIHsKICBpZiAodHlwZW9mIG1vZHVsZSA9PT0gJ29iamVjdCcgJiYgdHlwZW9mIG1vZHVsZS5leHBvcnRzID09PSAnb2JqZWN0JykgewogICAgLy8gRm9yIENvbW1vbkpTIGFuZCBDb21tb25KUy1saWtlIGVudmlyb25tZW50cyB3aGVyZSBhIHByb3BlciB3aW5kb3cgaXMgcHJlc2VudCwKICAgIC8vIGV4ZWN1dGUgdGhlIGZhY3RvcnkgYW5kIGdldCBqUXVlcnkKICAgIC8vIEZvciBlbnZpcm9ubWVudHMgdGhhdCBkbyBub3QgaW5oZXJlbnRseSBwb3NzZXMgYSB3aW5kb3cgd2l0aCBhIGRvY3VtZW50CiAgICAvLyAoc3VjaCBhcyBOb2RlLmpzKSwgZXhwb3NlIGEgalF1ZXJ5LW1ha2luZyBmYWN0b3J5IGFzIG1vZHVsZS5leHBvcnRzCiAgICAvLyBUaGlzIGFjY2VudHVhdGVzIHRoZSBuZWVkIGZvciB0aGUgY3JlYXRpb24gb2YgYSByZWFsIHdpbmRvdwogICAgLy8gZS5nLiB2YXIgalF1ZXJ5ID0gcmVxdWlyZSgianF1ZXJ5Iikod2luZG93KTsKICAgIC8vIFNlZSB0aWNrZXQgIzE0NTQ5IGZvciBtb3JlIGluZm8KICAgIG1vZHVsZS5leHBvcnRzID0gZ2xvYmFsLmRvY3VtZW50ID8gZmFjdG9yeShnbG9iYWwsIHRydWUpIDogZnVuY3Rpb24gKHcpIHsKICAgICAgaWYgKCF3LmRvY3VtZW50KSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdqUXVlcnkgcmVxdWlyZXMgYSB3aW5kb3cgd2l0aCBhIGRvY3VtZW50Jyk7CiAgICAgIH0KICAgICAgcmV0dXJuIGZhY3Rvcnkodyk7CiAgICB9OwogIH0gZWxzZSB7CiAgICBmYWN0b3J5KGdsb2JhbCk7CiAgfSAgLy8gUGFzcyB0aGlzIGlmIHdpbmRvdyBpcyBub3QgZGVmaW5lZCB5ZXQKfSh0eXBlb2Ygd2luZG93ICE9PSAndW5kZWZpbmVkJyA/IHdpbmRvdyA6IHRoaXMsIGZ1bmN0aW9uICh3aW5kb3csIG5vR2xvYmFsKSB7CiAgLy8gQ2FuJ3QgZG8gdGhpcyBiZWNhdXNlIHNldmVyYWwgYXBwcyBpbmNsdWRpbmcgQVNQLk5FVCB0cmFjZQogIC8vIHRoZSBzdGFjayB2aWEgYXJndW1lbnRzLmNhbGxlci5jYWxsZWUgYW5kIEZpcmVmb3ggZGllcyBpZgogIC8vIHlvdSB0cnkgdG8gdHJhY2UgdGhyb3VnaCAidXNlIHN0cmljdCIgY2FsbCBjaGFpbnMuICgjMTMzMzUpCiAgLy8gU3VwcG9ydDogRmlyZWZveCAxOCsKICAvLwogIHZhciBhcnIgPSBbXTsKICB2YXIgc2xpY2UgPSBhcnIuc2xpY2U7CiAgdmFyIGNvbmNhdCA9IGFyci5jb25jYXQ7CiAgdmFyIHB1c2ggPSBhcnIucHVzaDsKICB2YXIgaW5kZXhPZiA9IGFyci5pbmRleE9mOwogIHZhciBjbGFzczJ0eXBlID0ge307CiAgdmFyIHRvU3RyaW5nID0gY2xhc3MydHlwZS50b1N0cmluZzsKICB2YXIgaGFzT3duID0gY2xhc3MydHlwZS5oYXNPd25Qcm9wZXJ0eTsKICB2YXIgc3VwcG9ydCA9IHt9OwogIHZhcgogICAgLy8gVXNlIHRoZSBjb3JyZWN0IGRvY3VtZW50IGFjY29yZGluZ2x5IHdpdGggd2luZG93IGFyZ3VtZW50IChzYW5kYm94KQogICAgZG9jdW1lbnQgPSB3aW5kb3cuZG9jdW1lbnQsIHZlcnNpb24gPSAnMi4xLjEnLAogICAgLy8gRGVmaW5lIGEgbG9jYWwgY29weSBvZiBqUXVlcnkKICAgIGpRdWVyeSA9IGZ1bmN0aW9uIChzZWxlY3RvciwgY29udGV4dCkgewogICAgICAvLyBUaGUgalF1ZXJ5IG9iamVjdCBpcyBhY3R1YWxseSBqdXN0IHRoZSBpbml0IGNvbnN0cnVjdG9yICdlbmhhbmNlZCcKICAgICAgLy8gTmVlZCBpbml0IGlmIGpRdWVyeSBpcyBjYWxsZWQgKGp1c3QgYWxsb3cgZXJyb3IgdG8gYmUgdGhyb3duIGlmIG5vdCBpbmNsdWRlZCkKICAgICAgcmV0dXJuIG5ldyBqUXVlcnkuZm4uaW5pdChzZWxlY3RvciwgY29udGV4dCk7CiAgICB9LAogICAgLy8gU3VwcG9ydDogQW5kcm9pZDw0LjEKICAgIC8vIE1ha2Ugc3VyZSB3ZSB0cmltIEJPTSBhbmQgTkJTUAogICAgcnRyaW0gPSAvXltcc1x1RkVGRlx4QTBdK3xbXHNcdUZFRkZceEEwXSskL2csCiAgICAvLyBNYXRjaGVzIGRhc2hlZCBzdHJpbmcgZm9yIGNhbWVsaXppbmcKICAgIHJtc1ByZWZpeCA9IC9eLW1zLS8sIHJkYXNoQWxwaGEgPSAvLShbXGRhLXpdKS9naSwKICAgIC8vIFVzZWQgYnkgalF1ZXJ5LmNhbWVsQ2FzZSBhcyBjYWxsYmFjayB0byByZXBsYWNlKCkKICAgIGZjYW1lbENhc2UgPSBmdW5jdGlvbiAoYWxsLCBsZXR0ZXIpIHsKICAgICAgcmV0dXJuIGxldHRlci50b1VwcGVyQ2FzZSgpOwogICAgfTsKICBqUXVlcnkuZm4gPSBqUXVlcnkucHJvdG90eXBlID0gewogICAgLy8gVGhlIGN1cnJlbnQgdmVyc2lvbiBvZiBqUXVlcnkgYmVpbmcgdXNlZAogICAganF1ZXJ5OiB2ZXJzaW9uLAogICAgY29uc3RydWN0b3I6IGpRdWVyeSwKICAgIC8vIFN0YXJ0IHdpdGggYW4gZW1wdHkgc2VsZWN0b3IKICAgIHNlbGVjdG9yOiAnJywKICAgIC8vIFRoZSBkZWZhdWx0IGxlbmd0aCBvZiBhIGpRdWVyeSBvYmplY3QgaXMgMAogICAgbGVuZ3RoOiAwLAogICAgdG9BcnJheTogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gc2xpY2UuY2FsbCh0aGlzKTsKICAgIH0sCiAgICAvLyBHZXQgdGhlIE50aCBlbGVtZW50IGluIHRoZSBtYXRjaGVkIGVsZW1lbnQgc2V0IE9SCiAgICAvLyBHZXQgdGhlIHdob2xlIG1hdGNoZWQgZWxlbWVudCBzZXQgYXMgYSBjbGVhbiBhcnJheQogICAgZ2V0OiBmdW5jdGlvbiAobnVtKSB7CiAgICAgIHJldHVybiBudW0gIT0gbnVsbCA/IG51bSA8IDAgPyB0aGlzW251bSArIHRoaXMubGVuZ3RoXSA6IHRoaXNbbnVtXSA6IC8vIFJldHVybiBhbGwgdGhlIGVsZW1lbnRzIGluIGEgY2xlYW4gYXJyYXkKICAgICAgc2xpY2UuY2FsbCh0aGlzKTsKICAgIH0sCiAgICAvLyBUYWtlIGFuIGFycmF5IG9mIGVsZW1lbnRzIGFuZCBwdXNoIGl0IG9udG8gdGhlIHN0YWNrCiAgICAvLyAocmV0dXJuaW5nIHRoZSBuZXcgbWF0Y2hlZCBlbGVtZW50IHNldCkKICAgIHB1c2hTdGFjazogZnVuY3Rpb24gKGVsZW1zKSB7CiAgICAgIC8vIEJ1aWxkIGEgbmV3IGpRdWVyeSBtYXRjaGVkIGVsZW1lbnQgc2V0CiAgICAgIHZhciByZXQgPSBqUXVlcnkubWVyZ2UodGhpcy5jb25zdHJ1Y3RvcigpLCBlbGVtcyk7CiAgICAgIC8vIEFkZCB0aGUgb2xkIG9iamVjdCBvbnRvIHRoZSBzdGFjayAoYXMgYSByZWZlcmVuY2UpCiAgICAgIHJldC5wcmV2T2JqZWN0ID0gdGhpczsKICAgICAgcmV0LmNvbnRleHQgPSB0aGlzLmNvbnRleHQ7CiAgICAgIC8vIFJldHVybiB0aGUgbmV3bHktZm9ybWVkIGVsZW1lbnQgc2V0CiAgICAgIHJldHVybiByZXQ7CiAgICB9LAogICAgLy8gRXhlY3V0ZSBhIGNhbGxiYWNrIGZvciBldmVyeSBlbGVtZW50IGluIHRoZSBtYXRjaGVkIHNldC4KICAgIC8vIChZb3UgY2FuIHNlZWQgdGhlIGFyZ3VtZW50cyB3aXRoIGFuIGFycmF5IG9mIGFyZ3MsIGJ1dCB0aGlzIGlzCiAgICAvLyBvbmx5IHVzZWQgaW50ZXJuYWxseS4pCiAgICBlYWNoOiBmdW5jdGlvbiAoY2FsbGJhY2ssIGFyZ3MpIHsKICAgICAgcmV0dXJuIGpRdWVyeS5lYWNoKHRoaXMsIGNhbGxiYWNrLCBhcmdzKTsKICAgIH0sCiAgICBtYXA6IGZ1bmN0aW9uIChjYWxsYmFjaykgewogICAgICByZXR1cm4gdGhpcy5wdXNoU3RhY2soalF1ZXJ5Lm1hcCh0aGlzLCBmdW5jdGlvbiAoZWxlbSwgaSkgewogICAgICAgIHJldHVybiBjYWxsYmFjay5jYWxsKGVsZW0sIGksIGVsZW0pOwogICAgICB9KSk7CiAgICB9LAogICAgc2xpY2U6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIHRoaXMucHVzaFN0YWNrKHNsaWNlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykpOwogICAgfSwKICAgIGZpcnN0OiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiB0aGlzLmVxKDApOwogICAgfSwKICAgIGxhc3Q6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIHRoaXMuZXEoLTEpOwogICAgfSwKICAgIGVxOiBmdW5jdGlvbiAoaSkgewogICAgICB2YXIgbGVuID0gdGhpcy5sZW5ndGgsIGogPSAraSArIChpIDwgMCA/IGxlbiA6IDApOwogICAgICByZXR1cm4gdGhpcy5wdXNoU3RhY2soaiA+PSAwICYmIGogPCBsZW4gPyBbdGhpc1tqXV0gOiBbXSk7CiAgICB9LAogICAgZW5kOiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiB0aGlzLnByZXZPYmplY3QgfHwgdGhpcy5jb25zdHJ1Y3RvcihudWxsKTsKICAgIH0sCiAgICAvLyBGb3IgaW50ZXJuYWwgdXNlIG9ubHkuCiAgICAvLyBCZWhhdmVzIGxpa2UgYW4gQXJyYXkncyBtZXRob2QsIG5vdCBsaWtlIGEgalF1ZXJ5IG1ldGhvZC4KICAgIHB1c2g6IHB1c2gsCiAgICBzb3J0OiBhcnIuc29ydCwKICAgIHNwbGljZTogYXJyLnNwbGljZQogIH07CiAgalF1ZXJ5LmV4dGVuZCA9IGpRdWVyeS5mbi5leHRlbmQgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgb3B0aW9ucywgbmFtZSwgc3JjLCBjb3B5LCBjb3B5SXNBcnJheSwgY2xvbmUsIHRhcmdldCA9IGFyZ3VtZW50c1swXSB8fCB7fSwgaSA9IDEsIGxlbmd0aCA9IGFyZ3VtZW50cy5sZW5ndGgsIGRlZXAgPSBmYWxzZTsKICAgIC8vIEhhbmRsZSBhIGRlZXAgY29weSBzaXR1YXRpb24KICAgIGlmICh0eXBlb2YgdGFyZ2V0ID09PSAnYm9vbGVhbicpIHsKICAgICAgZGVlcCA9IHRhcmdldDsKICAgICAgLy8gc2tpcCB0aGUgYm9vbGVhbiBhbmQgdGhlIHRhcmdldAogICAgICB0YXJnZXQgPSBhcmd1bWVudHNbaV0gfHwge307CiAgICAgIGkrKzsKICAgIH0KICAgIC8vIEhhbmRsZSBjYXNlIHdoZW4gdGFyZ2V0IGlzIGEgc3RyaW5nIG9yIHNvbWV0aGluZyAocG9zc2libGUgaW4gZGVlcCBjb3B5KQogICAgaWYgKHR5cGVvZiB0YXJnZXQgIT09ICdvYmplY3QnICYmICFqUXVlcnkuaXNGdW5jdGlvbih0YXJnZXQpKSB7CiAgICAgIHRhcmdldCA9IHt9OwogICAgfQogICAgLy8gZXh0ZW5kIGpRdWVyeSBpdHNlbGYgaWYgb25seSBvbmUgYXJndW1lbnQgaXMgcGFzc2VkCiAgICBpZiAoaSA9PT0gbGVuZ3RoKSB7CiAgICAgIHRhcmdldCA9IHRoaXM7CiAgICAgIGktLTsKICAgIH0KICAgIGZvciAoOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgLy8gT25seSBkZWFsIHdpdGggbm9uLW51bGwvdW5kZWZpbmVkIHZhbHVlcwogICAgICBpZiAoKG9wdGlvbnMgPSBhcmd1bWVudHNbaV0pICE9IG51bGwpIHsKICAgICAgICAvLyBFeHRlbmQgdGhlIGJhc2Ugb2JqZWN0CiAgICAgICAgZm9yIChuYW1lIGluIG9wdGlvbnMpIHsKICAgICAgICAgIHNyYyA9IHRhcmdldFtuYW1lXTsKICAgICAgICAgIGNvcHkgPSBvcHRpb25zW25hbWVdOwogICAgICAgICAgLy8gUHJldmVudCBuZXZlci1lbmRpbmcgbG9vcAogICAgICAgICAgaWYgKHRhcmdldCA9PT0gY29weSkgewogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KICAgICAgICAgIC8vIFJlY3Vyc2UgaWYgd2UncmUgbWVyZ2luZyBwbGFpbiBvYmplY3RzIG9yIGFycmF5cwogICAgICAgICAgaWYgKGRlZXAgJiYgY29weSAmJiAoalF1ZXJ5LmlzUGxhaW5PYmplY3QoY29weSkgfHwgKGNvcHlJc0FycmF5ID0galF1ZXJ5LmlzQXJyYXkoY29weSkpKSkgewogICAgICAgICAgICBpZiAoY29weUlzQXJyYXkpIHsKICAgICAgICAgICAgICBjb3B5SXNBcnJheSA9IGZhbHNlOwogICAgICAgICAgICAgIGNsb25lID0gc3JjICYmIGpRdWVyeS5pc0FycmF5KHNyYykgPyBzcmMgOiBbXTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBjbG9uZSA9IHNyYyAmJiBqUXVlcnkuaXNQbGFpbk9iamVjdChzcmMpID8gc3JjIDoge307CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gTmV2ZXIgbW92ZSBvcmlnaW5hbCBvYmplY3RzLCBjbG9uZSB0aGVtCiAgICAgICAgICAgIHRhcmdldFtuYW1lXSA9IGpRdWVyeS5leHRlbmQoZGVlcCwgY2xvbmUsIGNvcHkpOyAgLy8gRG9uJ3QgYnJpbmcgaW4gdW5kZWZpbmVkIHZhbHVlcwogICAgICAgICAgfSBlbHNlIGlmIChjb3B5ICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgdGFyZ2V0W25hbWVdID0gY29weTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIC8vIFJldHVybiB0aGUgbW9kaWZpZWQgb2JqZWN0CiAgICByZXR1cm4gdGFyZ2V0OwogIH07CiAgalF1ZXJ5LmV4dGVuZCh7CiAgICAvLyBVbmlxdWUgZm9yIGVhY2ggY29weSBvZiBqUXVlcnkgb24gdGhlIHBhZ2UKICAgIGV4cGFuZG86ICdqUXVlcnknICsgKHZlcnNpb24gKyBNYXRoLnJhbmRvbSgpKS5yZXBsYWNlKC9cRC9nLCAnJyksCiAgICAvLyBBc3N1bWUgalF1ZXJ5IGlzIHJlYWR5IHdpdGhvdXQgdGhlIHJlYWR5IG1vZHVsZQogICAgaXNSZWFkeTogdHJ1ZSwKICAgIGVycm9yOiBmdW5jdGlvbiAobXNnKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcihtc2cpOwogICAgfSwKICAgIG5vb3A6IGZ1bmN0aW9uICgpIHsKICAgIH0sCiAgICAvLyBTZWUgdGVzdC91bml0L2NvcmUuanMgZm9yIGRldGFpbHMgY29uY2VybmluZyBpc0Z1bmN0aW9uLgogICAgLy8gU2luY2UgdmVyc2lvbiAxLjMsIERPTSBtZXRob2RzIGFuZCBmdW5jdGlvbnMgbGlrZSBhbGVydAogICAgLy8gYXJlbid0IHN1cHBvcnRlZC4gVGhleSByZXR1cm4gZmFsc2Ugb24gSUUgKCMyOTY4KS4KICAgIGlzRnVuY3Rpb246IGZ1bmN0aW9uIChvYmopIHsKICAgICAgcmV0dXJuIGpRdWVyeS50eXBlKG9iaikgPT09ICdmdW5jdGlvbic7CiAgICB9LAogICAgaXNBcnJheTogQXJyYXkuaXNBcnJheSwKICAgIGlzV2luZG93OiBmdW5jdGlvbiAob2JqKSB7CiAgICAgIHJldHVybiBvYmogIT0gbnVsbCAmJiBvYmogPT09IG9iai53aW5kb3c7CiAgICB9LAogICAgaXNOdW1lcmljOiBmdW5jdGlvbiAob2JqKSB7CiAgICAgIC8vIHBhcnNlRmxvYXQgTmFOcyBudW1lcmljLWNhc3QgZmFsc2UgcG9zaXRpdmVzIChudWxsfHRydWV8ZmFsc2V8IiIpCiAgICAgIC8vIC4uLmJ1dCBtaXNpbnRlcnByZXRzIGxlYWRpbmctbnVtYmVyIHN0cmluZ3MsIHBhcnRpY3VsYXJseSBoZXggbGl0ZXJhbHMgKCIweC4uLiIpCiAgICAgIC8vIHN1YnRyYWN0aW9uIGZvcmNlcyBpbmZpbml0aWVzIHRvIE5hTgogICAgICByZXR1cm4gIWpRdWVyeS5pc0FycmF5KG9iaikgJiYgb2JqIC0gcGFyc2VGbG9hdChvYmopID49IDA7CiAgICB9LAogICAgaXNQbGFpbk9iamVjdDogZnVuY3Rpb24gKG9iaikgewogICAgICAvLyBOb3QgcGxhaW4gb2JqZWN0czoKICAgICAgLy8gLSBBbnkgb2JqZWN0IG9yIHZhbHVlIHdob3NlIGludGVybmFsIFtbQ2xhc3NdXSBwcm9wZXJ0eSBpcyBub3QgIltvYmplY3QgT2JqZWN0XSIKICAgICAgLy8gLSBET00gbm9kZXMKICAgICAgLy8gLSB3aW5kb3cKICAgICAgaWYgKGpRdWVyeS50eXBlKG9iaikgIT09ICdvYmplY3QnIHx8IG9iai5ub2RlVHlwZSB8fCBqUXVlcnkuaXNXaW5kb3cob2JqKSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICBpZiAob2JqLmNvbnN0cnVjdG9yICYmICFoYXNPd24uY2FsbChvYmouY29uc3RydWN0b3IucHJvdG90eXBlLCAnaXNQcm90b3R5cGVPZicpKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIC8vIElmIHRoZSBmdW5jdGlvbiBoYXNuJ3QgcmV0dXJuZWQgYWxyZWFkeSwgd2UncmUgY29uZmlkZW50IHRoYXQKICAgICAgLy8gfG9ianwgaXMgYSBwbGFpbiBvYmplY3QsIGNyZWF0ZWQgYnkge30gb3IgY29uc3RydWN0ZWQgd2l0aCBuZXcgT2JqZWN0CiAgICAgIHJldHVybiB0cnVlOwogICAgfSwKICAgIGlzRW1wdHlPYmplY3Q6IGZ1bmN0aW9uIChvYmopIHsKICAgICAgdmFyIG5hbWU7CiAgICAgIGZvciAobmFtZSBpbiBvYmopIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgICAgcmV0dXJuIHRydWU7CiAgICB9LAogICAgdHlwZTogZnVuY3Rpb24gKG9iaikgewogICAgICBpZiAob2JqID09IG51bGwpIHsKICAgICAgICByZXR1cm4gb2JqICsgJyc7CiAgICAgIH0KICAgICAgLy8gU3VwcG9ydDogQW5kcm9pZCA8IDQuMCwgaU9TIDwgNiAoZnVuY3Rpb25pc2ggUmVnRXhwKQogICAgICByZXR1cm4gdHlwZW9mIG9iaiA9PT0gJ29iamVjdCcgfHwgdHlwZW9mIG9iaiA9PT0gJ2Z1bmN0aW9uJyA/IGNsYXNzMnR5cGVbdG9TdHJpbmcuY2FsbChvYmopXSB8fCAnb2JqZWN0JyA6IHR5cGVvZiBvYmo7CiAgICB9LAogICAgLy8gRXZhbHVhdGVzIGEgc2NyaXB0IGluIGEgZ2xvYmFsIGNvbnRleHQKICAgIGdsb2JhbEV2YWw6IGZ1bmN0aW9uIChjb2RlKSB7CiAgICAgIHZhciBzY3JpcHQsIGluZGlyZWN0ID0gZXZhbDsKICAgICAgY29kZSA9IGpRdWVyeS50cmltKGNvZGUpOwogICAgICBpZiAoY29kZSkgewogICAgICAgIC8vIElmIHRoZSBjb2RlIGluY2x1ZGVzIGEgdmFsaWQsIHByb2xvZ3VlIHBvc2l0aW9uCiAgICAgICAgLy8gc3RyaWN0IG1vZGUgcHJhZ21hLCBleGVjdXRlIGNvZGUgYnkgaW5qZWN0aW5nIGEKICAgICAgICAvLyBzY3JpcHQgdGFnIGludG8gdGhlIGRvY3VtZW50LgogICAgICAgIGlmIChjb2RlLmluZGV4T2YoJ3VzZSBzdHJpY3QnKSA9PT0gMSkgewogICAgICAgICAgc2NyaXB0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc2NyaXB0Jyk7CiAgICAgICAgICBzY3JpcHQudGV4dCA9IGNvZGU7CiAgICAgICAgICBkb2N1bWVudC5oZWFkLmFwcGVuZENoaWxkKHNjcmlwdCkucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChzY3JpcHQpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAvLyBPdGhlcndpc2UsIGF2b2lkIHRoZSBET00gbm9kZSBjcmVhdGlvbiwgaW5zZXJ0aW9uCiAgICAgICAgICAvLyBhbmQgcmVtb3ZhbCBieSB1c2luZyBhbiBpbmRpcmVjdCBnbG9iYWwgZXZhbAogICAgICAgICAgaW5kaXJlY3QoY29kZSk7CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgLy8gQ29udmVydCBkYXNoZWQgdG8gY2FtZWxDYXNlOyB1c2VkIGJ5IHRoZSBjc3MgYW5kIGRhdGEgbW9kdWxlcwogICAgLy8gTWljcm9zb2Z0IGZvcmdvdCB0byBodW1wIHRoZWlyIHZlbmRvciBwcmVmaXggKCM5NTcyKQogICAgY2FtZWxDYXNlOiBmdW5jdGlvbiAoc3RyaW5nKSB7CiAgICAgIHJldHVybiBzdHJpbmcucmVwbGFjZShybXNQcmVmaXgsICdtcy0nKS5yZXBsYWNlKHJkYXNoQWxwaGEsIGZjYW1lbENhc2UpOwogICAgfSwKICAgIG5vZGVOYW1lOiBmdW5jdGlvbiAoZWxlbSwgbmFtZSkgewogICAgICByZXR1cm4gZWxlbS5ub2RlTmFtZSAmJiBlbGVtLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09IG5hbWUudG9Mb3dlckNhc2UoKTsKICAgIH0sCiAgICAvLyBhcmdzIGlzIGZvciBpbnRlcm5hbCB1c2FnZSBvbmx5CiAgICBlYWNoOiBmdW5jdGlvbiAob2JqLCBjYWxsYmFjaywgYXJncykgewogICAgICB2YXIgdmFsdWUsIGkgPSAwLCBsZW5ndGggPSBvYmoubGVuZ3RoLCBpc0FycmF5ID0gaXNBcnJheWxpa2Uob2JqKTsKICAgICAgaWYgKGFyZ3MpIHsKICAgICAgICBpZiAoaXNBcnJheSkgewogICAgICAgICAgZm9yICg7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgICB2YWx1ZSA9IGNhbGxiYWNrLmFwcGx5KG9ialtpXSwgYXJncyk7CiAgICAgICAgICAgIGlmICh2YWx1ZSA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBmb3IgKGkgaW4gb2JqKSB7CiAgICAgICAgICAgIHZhbHVlID0gY2FsbGJhY2suYXBwbHkob2JqW2ldLCBhcmdzKTsKICAgICAgICAgICAgaWYgKHZhbHVlID09PSBmYWxzZSkgewogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSAgLy8gQSBzcGVjaWFsLCBmYXN0LCBjYXNlIGZvciB0aGUgbW9zdCBjb21tb24gdXNlIG9mIGVhY2gKICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAoaXNBcnJheSkgewogICAgICAgICAgZm9yICg7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgICB2YWx1ZSA9IGNhbGxiYWNrLmNhbGwob2JqW2ldLCBpLCBvYmpbaV0pOwogICAgICAgICAgICBpZiAodmFsdWUgPT09IGZhbHNlKSB7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgZm9yIChpIGluIG9iaikgewogICAgICAgICAgICB2YWx1ZSA9IGNhbGxiYWNrLmNhbGwob2JqW2ldLCBpLCBvYmpbaV0pOwogICAgICAgICAgICBpZiAodmFsdWUgPT09IGZhbHNlKSB7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIG9iajsKICAgIH0sCiAgICAvLyBTdXBwb3J0OiBBbmRyb2lkPDQuMQogICAgdHJpbTogZnVuY3Rpb24gKHRleHQpIHsKICAgICAgcmV0dXJuIHRleHQgPT0gbnVsbCA/ICcnIDogKHRleHQgKyAnJykucmVwbGFjZShydHJpbSwgJycpOwogICAgfSwKICAgIC8vIHJlc3VsdHMgaXMgZm9yIGludGVybmFsIHVzYWdlIG9ubHkKICAgIG1ha2VBcnJheTogZnVuY3Rpb24gKGFyciwgcmVzdWx0cykgewogICAgICB2YXIgcmV0ID0gcmVzdWx0cyB8fCBbXTsKICAgICAgaWYgKGFyciAhPSBudWxsKSB7CiAgICAgICAgaWYgKGlzQXJyYXlsaWtlKE9iamVjdChhcnIpKSkgewogICAgICAgICAgalF1ZXJ5Lm1lcmdlKHJldCwgdHlwZW9mIGFyciA9PT0gJ3N0cmluZycgPyBbYXJyXSA6IGFycik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHB1c2guY2FsbChyZXQsIGFycik7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiByZXQ7CiAgICB9LAogICAgaW5BcnJheTogZnVuY3Rpb24gKGVsZW0sIGFyciwgaSkgewogICAgICByZXR1cm4gYXJyID09IG51bGwgPyAtMSA6IGluZGV4T2YuY2FsbChhcnIsIGVsZW0sIGkpOwogICAgfSwKICAgIG1lcmdlOiBmdW5jdGlvbiAoZmlyc3QsIHNlY29uZCkgewogICAgICB2YXIgbGVuID0gK3NlY29uZC5sZW5ndGgsIGogPSAwLCBpID0gZmlyc3QubGVuZ3RoOwogICAgICBmb3IgKDsgaiA8IGxlbjsgaisrKSB7CiAgICAgICAgZmlyc3RbaSsrXSA9IHNlY29uZFtqXTsKICAgICAgfQogICAgICBmaXJzdC5sZW5ndGggPSBpOwogICAgICByZXR1cm4gZmlyc3Q7CiAgICB9LAogICAgZ3JlcDogZnVuY3Rpb24gKGVsZW1zLCBjYWxsYmFjaywgaW52ZXJ0KSB7CiAgICAgIHZhciBjYWxsYmFja0ludmVyc2UsIG1hdGNoZXMgPSBbXSwgaSA9IDAsIGxlbmd0aCA9IGVsZW1zLmxlbmd0aCwgY2FsbGJhY2tFeHBlY3QgPSAhaW52ZXJ0OwogICAgICAvLyBHbyB0aHJvdWdoIHRoZSBhcnJheSwgb25seSBzYXZpbmcgdGhlIGl0ZW1zCiAgICAgIC8vIHRoYXQgcGFzcyB0aGUgdmFsaWRhdG9yIGZ1bmN0aW9uCiAgICAgIGZvciAoOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICBjYWxsYmFja0ludmVyc2UgPSAhY2FsbGJhY2soZWxlbXNbaV0sIGkpOwogICAgICAgIGlmIChjYWxsYmFja0ludmVyc2UgIT09IGNhbGxiYWNrRXhwZWN0KSB7CiAgICAgICAgICBtYXRjaGVzLnB1c2goZWxlbXNbaV0pOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gbWF0Y2hlczsKICAgIH0sCiAgICAvLyBhcmcgaXMgZm9yIGludGVybmFsIHVzYWdlIG9ubHkKICAgIG1hcDogZnVuY3Rpb24gKGVsZW1zLCBjYWxsYmFjaywgYXJnKSB7CiAgICAgIHZhciB2YWx1ZSwgaSA9IDAsIGxlbmd0aCA9IGVsZW1zLmxlbmd0aCwgaXNBcnJheSA9IGlzQXJyYXlsaWtlKGVsZW1zKSwgcmV0ID0gW107CiAgICAgIC8vIEdvIHRocm91Z2ggdGhlIGFycmF5LCB0cmFuc2xhdGluZyBlYWNoIG9mIHRoZSBpdGVtcyB0byB0aGVpciBuZXcgdmFsdWVzCiAgICAgIGlmIChpc0FycmF5KSB7CiAgICAgICAgZm9yICg7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgdmFsdWUgPSBjYWxsYmFjayhlbGVtc1tpXSwgaSwgYXJnKTsKICAgICAgICAgIGlmICh2YWx1ZSAhPSBudWxsKSB7CiAgICAgICAgICAgIHJldC5wdXNoKHZhbHVlKTsKICAgICAgICAgIH0KICAgICAgICB9ICAvLyBHbyB0aHJvdWdoIGV2ZXJ5IGtleSBvbiB0aGUgb2JqZWN0LAogICAgICB9IGVsc2UgewogICAgICAgIGZvciAoaSBpbiBlbGVtcykgewogICAgICAgICAgdmFsdWUgPSBjYWxsYmFjayhlbGVtc1tpXSwgaSwgYXJnKTsKICAgICAgICAgIGlmICh2YWx1ZSAhPSBudWxsKSB7CiAgICAgICAgICAgIHJldC5wdXNoKHZhbHVlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgLy8gRmxhdHRlbiBhbnkgbmVzdGVkIGFycmF5cwogICAgICByZXR1cm4gY29uY2F0LmFwcGx5KFtdLCByZXQpOwogICAgfSwKICAgIC8vIEEgZ2xvYmFsIEdVSUQgY291bnRlciBmb3Igb2JqZWN0cwogICAgZ3VpZDogMSwKICAgIC8vIEJpbmQgYSBmdW5jdGlvbiB0byBhIGNvbnRleHQsIG9wdGlvbmFsbHkgcGFydGlhbGx5IGFwcGx5aW5nIGFueQogICAgLy8gYXJndW1lbnRzLgogICAgcHJveHk6IGZ1bmN0aW9uIChmbiwgY29udGV4dCkgewogICAgICB2YXIgdG1wLCBhcmdzLCBwcm94eTsKICAgICAgaWYgKHR5cGVvZiBjb250ZXh0ID09PSAnc3RyaW5nJykgewogICAgICAgIHRtcCA9IGZuW2NvbnRleHRdOwogICAgICAgIGNvbnRleHQgPSBmbjsKICAgICAgICBmbiA9IHRtcDsKICAgICAgfQogICAgICAvLyBRdWljayBjaGVjayB0byBkZXRlcm1pbmUgaWYgdGFyZ2V0IGlzIGNhbGxhYmxlLCBpbiB0aGUgc3BlYwogICAgICAvLyB0aGlzIHRocm93cyBhIFR5cGVFcnJvciwgYnV0IHdlIHdpbGwganVzdCByZXR1cm4gdW5kZWZpbmVkLgogICAgICBpZiAoIWpRdWVyeS5pc0Z1bmN0aW9uKGZuKSkgewogICAgICAgIHJldHVybiB1bmRlZmluZWQ7CiAgICAgIH0KICAgICAgLy8gU2ltdWxhdGVkIGJpbmQKICAgICAgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAyKTsKICAgICAgcHJveHkgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIGZuLmFwcGx5KGNvbnRleHQgfHwgdGhpcywgYXJncy5jb25jYXQoc2xpY2UuY2FsbChhcmd1bWVudHMpKSk7CiAgICAgIH07CiAgICAgIC8vIFNldCB0aGUgZ3VpZCBvZiB1bmlxdWUgaGFuZGxlciB0byB0aGUgc2FtZSBvZiBvcmlnaW5hbCBoYW5kbGVyLCBzbyBpdCBjYW4gYmUgcmVtb3ZlZAogICAgICBwcm94eS5ndWlkID0gZm4uZ3VpZCA9IGZuLmd1aWQgfHwgalF1ZXJ5Lmd1aWQrKzsKICAgICAgcmV0dXJuIHByb3h5OwogICAgfSwKICAgIG5vdzogRGF0ZS5ub3csCiAgICAvLyBqUXVlcnkuc3VwcG9ydCBpcyBub3QgdXNlZCBpbiBDb3JlIGJ1dCBvdGhlciBwcm9qZWN0cyBhdHRhY2ggdGhlaXIKICAgIC8vIHByb3BlcnRpZXMgdG8gaXQgc28gaXQgbmVlZHMgdG8gZXhpc3QuCiAgICBzdXBwb3J0OiBzdXBwb3J0CiAgfSk7CiAgLy8gUG9wdWxhdGUgdGhlIGNsYXNzMnR5cGUgbWFwCiAgalF1ZXJ5LmVhY2goJ0Jvb2xlYW4gTnVtYmVyIFN0cmluZyBGdW5jdGlvbiBBcnJheSBEYXRlIFJlZ0V4cCBPYmplY3QgRXJyb3InLnNwbGl0KCcgJyksIGZ1bmN0aW9uIChpLCBuYW1lKSB7CiAgICBjbGFzczJ0eXBlWydbb2JqZWN0ICcgKyBuYW1lICsgJ10nXSA9IG5hbWUudG9Mb3dlckNhc2UoKTsKICB9KTsKICBmdW5jdGlvbiBpc0FycmF5bGlrZShvYmopIHsKICAgIHZhciBsZW5ndGggPSBvYmoubGVuZ3RoLCB0eXBlID0galF1ZXJ5LnR5cGUob2JqKTsKICAgIGlmICh0eXBlID09PSAnZnVuY3Rpb24nIHx8IGpRdWVyeS5pc1dpbmRvdyhvYmopKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIGlmIChvYmoubm9kZVR5cGUgPT09IDEgJiYgbGVuZ3RoKSB7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQogICAgcmV0dXJuIHR5cGUgPT09ICdhcnJheScgfHwgbGVuZ3RoID09PSAwIHx8IHR5cGVvZiBsZW5ndGggPT09ICdudW1iZXInICYmIGxlbmd0aCA+IDAgJiYgbGVuZ3RoIC0gMSBpbiBvYmo7CiAgfQogIHZhciBTaXp6bGUgPSAvKiEKICAgKiBTaXp6bGUgQ1NTIFNlbGVjdG9yIEVuZ2luZSB2MS4xMC4xOQogICAqIGh0dHA6Ly9zaXp6bGVqcy5jb20vCiAgICoKICAgKiBDb3B5cmlnaHQgMjAxMyBqUXVlcnkgRm91bmRhdGlvbiwgSW5jLiBhbmQgb3RoZXIgY29udHJpYnV0b3JzCiAgICogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlCiAgICogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQogICAqCiAgICogRGF0ZTogMjAxNC0wNC0xOAogICAqLwogIGZ1bmN0aW9uICh3aW5kb3cpIHsKICAgIHZhciBpLCBzdXBwb3J0LCBFeHByLCBnZXRUZXh0LCBpc1hNTCwgdG9rZW5pemUsIGNvbXBpbGUsIHNlbGVjdCwgb3V0ZXJtb3N0Q29udGV4dCwgc29ydElucHV0LCBoYXNEdXBsaWNhdGUsCiAgICAgIC8vIExvY2FsIGRvY3VtZW50IHZhcnMKICAgICAgc2V0RG9jdW1lbnQsIGRvY3VtZW50LCBkb2NFbGVtLCBkb2N1bWVudElzSFRNTCwgcmJ1Z2d5UVNBLCByYnVnZ3lNYXRjaGVzLCBtYXRjaGVzLCBjb250YWlucywKICAgICAgLy8gSW5zdGFuY2Utc3BlY2lmaWMgZGF0YQogICAgICBleHBhbmRvID0gJ3NpenpsZScgKyAtbmV3IERhdGUoKSwgcHJlZmVycmVkRG9jID0gd2luZG93LmRvY3VtZW50LCBkaXJydW5zID0gMCwgZG9uZSA9IDAsIGNsYXNzQ2FjaGUgPSBjcmVhdGVDYWNoZSgpLCB0b2tlbkNhY2hlID0gY3JlYXRlQ2FjaGUoKSwgY29tcGlsZXJDYWNoZSA9IGNyZWF0ZUNhY2hlKCksIHNvcnRPcmRlciA9IGZ1bmN0aW9uIChhLCBiKSB7CiAgICAgICAgaWYgKGEgPT09IGIpIHsKICAgICAgICAgIGhhc0R1cGxpY2F0ZSA9IHRydWU7CiAgICAgICAgfQogICAgICAgIHJldHVybiAwOwogICAgICB9LAogICAgICAvLyBHZW5lcmFsLXB1cnBvc2UgY29uc3RhbnRzCiAgICAgIHN0cnVuZGVmaW5lZCA9IHR5cGVvZiB1bmRlZmluZWQsIE1BWF9ORUdBVElWRSA9IDEgPDwgMzEsCiAgICAgIC8vIEluc3RhbmNlIG1ldGhvZHMKICAgICAgaGFzT3duID0ge30uaGFzT3duUHJvcGVydHksIGFyciA9IFtdLCBwb3AgPSBhcnIucG9wLCBwdXNoX25hdGl2ZSA9IGFyci5wdXNoLCBwdXNoID0gYXJyLnB1c2gsIHNsaWNlID0gYXJyLnNsaWNlLAogICAgICAvLyBVc2UgYSBzdHJpcHBlZC1kb3duIGluZGV4T2YgaWYgd2UgY2FuJ3QgdXNlIGEgbmF0aXZlIG9uZQogICAgICBpbmRleE9mID0gYXJyLmluZGV4T2YgfHwgZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICB2YXIgaSA9IDAsIGxlbiA9IHRoaXMubGVuZ3RoOwogICAgICAgIGZvciAoOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgIGlmICh0aGlzW2ldID09PSBlbGVtKSB7CiAgICAgICAgICAgIHJldHVybiBpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gLTE7CiAgICAgIH0sIGJvb2xlYW5zID0gJ2NoZWNrZWR8c2VsZWN0ZWR8YXN5bmN8YXV0b2ZvY3VzfGF1dG9wbGF5fGNvbnRyb2xzfGRlZmVyfGRpc2FibGVkfGhpZGRlbnxpc21hcHxsb29wfG11bHRpcGxlfG9wZW58cmVhZG9ubHl8cmVxdWlyZWR8c2NvcGVkJywKICAgICAgLy8gUmVndWxhciBleHByZXNzaW9ucwogICAgICAvLyBXaGl0ZXNwYWNlIGNoYXJhY3RlcnMgaHR0cDovL3d3dy53My5vcmcvVFIvY3NzMy1zZWxlY3RvcnMvI3doaXRlc3BhY2UKICAgICAgd2hpdGVzcGFjZSA9ICdbXFx4MjBcXHRcXHJcXG5cXGZdJywKICAgICAgLy8gaHR0cDovL3d3dy53My5vcmcvVFIvY3NzMy1zeW50YXgvI2NoYXJhY3RlcnMKICAgICAgY2hhcmFjdGVyRW5jb2RpbmcgPSAnKD86XFxcXC58W1xcdy1dfFteXFx4MDAtXFx4YTBdKSsnLAogICAgICAvLyBMb29zZWx5IG1vZGVsZWQgb24gQ1NTIGlkZW50aWZpZXIgY2hhcmFjdGVycwogICAgICAvLyBBbiB1bnF1b3RlZCB2YWx1ZSBzaG91bGQgYmUgYSBDU1MgaWRlbnRpZmllciBodHRwOi8vd3d3LnczLm9yZy9UUi9jc3MzLXNlbGVjdG9ycy8jYXR0cmlidXRlLXNlbGVjdG9ycwogICAgICAvLyBQcm9wZXIgc3ludGF4OiBodHRwOi8vd3d3LnczLm9yZy9UUi9DU1MyMS9zeW5kYXRhLmh0bWwjdmFsdWUtZGVmLWlkZW50aWZpZXIKICAgICAgaWRlbnRpZmllciA9IGNoYXJhY3RlckVuY29kaW5nLnJlcGxhY2UoJ3cnLCAndyMnKSwKICAgICAgLy8gQXR0cmlidXRlIHNlbGVjdG9yczogaHR0cDovL3d3dy53My5vcmcvVFIvc2VsZWN0b3JzLyNhdHRyaWJ1dGUtc2VsZWN0b3JzCiAgICAgIGF0dHJpYnV0ZXMgPSAnXFxbJyArIHdoaXRlc3BhY2UgKyAnKignICsgY2hhcmFjdGVyRW5jb2RpbmcgKyAnKSg/OicgKyB3aGl0ZXNwYWNlICsgLy8gT3BlcmF0b3IgKGNhcHR1cmUgMikKICAgICAgJyooWypeJHwhfl0/PSknICsgd2hpdGVzcGFjZSArIC8vICJBdHRyaWJ1dGUgdmFsdWVzIG11c3QgYmUgQ1NTIGlkZW50aWZpZXJzIFtjYXB0dXJlIDVdIG9yIHN0cmluZ3MgW2NhcHR1cmUgMyBvciBjYXB0dXJlIDRdIgogICAgICAnKig/OlwnKCg/OlxcXFwufFteXFxcXFwnXSkqKVwnfCIoKD86XFxcXC58W15cXFxcIl0pKikifCgnICsgaWRlbnRpZmllciArICcpKXwpJyArIHdoaXRlc3BhY2UgKyAnKlxcXScsIHBzZXVkb3MgPSAnOignICsgY2hhcmFjdGVyRW5jb2RpbmcgKyAnKSg/OlxcKCgnICsgLy8gVG8gcmVkdWNlIHRoZSBudW1iZXIgb2Ygc2VsZWN0b3JzIG5lZWRpbmcgdG9rZW5pemUgaW4gdGhlIHByZUZpbHRlciwgcHJlZmVyIGFyZ3VtZW50czoKICAgICAgLy8gMS4gcXVvdGVkIChjYXB0dXJlIDM7IGNhcHR1cmUgNCBvciBjYXB0dXJlIDUpCiAgICAgICcoXCcoKD86XFxcXC58W15cXFxcXCddKSopXCd8IigoPzpcXFxcLnxbXlxcXFwiXSkqKSIpfCcgKyAvLyAyLiBzaW1wbGUgKGNhcHR1cmUgNikKICAgICAgJygoPzpcXFxcLnxbXlxcXFwoKVtcXF1dfCcgKyBhdHRyaWJ1dGVzICsgJykqKXwnICsgLy8gMy4gYW55dGhpbmcgZWxzZSAoY2FwdHVyZSAyKQogICAgICAnLionICsgJylcXCl8KScsCiAgICAgIC8vIExlYWRpbmcgYW5kIG5vbi1lc2NhcGVkIHRyYWlsaW5nIHdoaXRlc3BhY2UsIGNhcHR1cmluZyBzb21lIG5vbi13aGl0ZXNwYWNlIGNoYXJhY3RlcnMgcHJlY2VkaW5nIHRoZSBsYXR0ZXIKICAgICAgcnRyaW0gPSBuZXcgUmVnRXhwKCdeJyArIHdoaXRlc3BhY2UgKyAnK3woKD86XnxbXlxcXFxdKSg/OlxcXFwuKSopJyArIHdoaXRlc3BhY2UgKyAnKyQnLCAnZycpLCByY29tbWEgPSBuZXcgUmVnRXhwKCdeJyArIHdoaXRlc3BhY2UgKyAnKiwnICsgd2hpdGVzcGFjZSArICcqJyksIHJjb21iaW5hdG9ycyA9IG5ldyBSZWdFeHAoJ14nICsgd2hpdGVzcGFjZSArICcqKFs+K35dfCcgKyB3aGl0ZXNwYWNlICsgJyknICsgd2hpdGVzcGFjZSArICcqJyksIHJhdHRyaWJ1dGVRdW90ZXMgPSBuZXcgUmVnRXhwKCc9JyArIHdoaXRlc3BhY2UgKyAnKihbXlxcXVwnIl0qPyknICsgd2hpdGVzcGFjZSArICcqXFxdJywgJ2cnKSwgcnBzZXVkbyA9IG5ldyBSZWdFeHAocHNldWRvcyksIHJpZGVudGlmaWVyID0gbmV3IFJlZ0V4cCgnXicgKyBpZGVudGlmaWVyICsgJyQnKSwgbWF0Y2hFeHByID0gewogICAgICAgICdJRCc6IG5ldyBSZWdFeHAoJ14jKCcgKyBjaGFyYWN0ZXJFbmNvZGluZyArICcpJyksCiAgICAgICAgJ0NMQVNTJzogbmV3IFJlZ0V4cCgnXlxcLignICsgY2hhcmFjdGVyRW5jb2RpbmcgKyAnKScpLAogICAgICAgICdUQUcnOiBuZXcgUmVnRXhwKCdeKCcgKyBjaGFyYWN0ZXJFbmNvZGluZy5yZXBsYWNlKCd3JywgJ3cqJykgKyAnKScpLAogICAgICAgICdBVFRSJzogbmV3IFJlZ0V4cCgnXicgKyBhdHRyaWJ1dGVzKSwKICAgICAgICAnUFNFVURPJzogbmV3IFJlZ0V4cCgnXicgKyBwc2V1ZG9zKSwKICAgICAgICAnQ0hJTEQnOiBuZXcgUmVnRXhwKCdeOihvbmx5fGZpcnN0fGxhc3R8bnRofG50aC1sYXN0KS0oY2hpbGR8b2YtdHlwZSkoPzpcXCgnICsgd2hpdGVzcGFjZSArICcqKGV2ZW58b2RkfCgoWystXXwpKFxcZCopbnwpJyArIHdoaXRlc3BhY2UgKyAnKig/OihbKy1dfCknICsgd2hpdGVzcGFjZSArICcqKFxcZCspfCkpJyArIHdoaXRlc3BhY2UgKyAnKlxcKXwpJywgJ2knKSwKICAgICAgICAnYm9vbCc6IG5ldyBSZWdFeHAoJ14oPzonICsgYm9vbGVhbnMgKyAnKSQnLCAnaScpLAogICAgICAgIC8vIEZvciB1c2UgaW4gbGlicmFyaWVzIGltcGxlbWVudGluZyAuaXMoKQogICAgICAgIC8vIFdlIHVzZSB0aGlzIGZvciBQT1MgbWF0Y2hpbmcgaW4gYHNlbGVjdGAKICAgICAgICAnbmVlZHNDb250ZXh0JzogbmV3IFJlZ0V4cCgnXicgKyB3aGl0ZXNwYWNlICsgJypbPit+XXw6KGV2ZW58b2RkfGVxfGd0fGx0fG50aHxmaXJzdHxsYXN0KSg/OlxcKCcgKyB3aGl0ZXNwYWNlICsgJyooKD86LVxcZCk/XFxkKiknICsgd2hpdGVzcGFjZSArICcqXFwpfCkoPz1bXi1dfCQpJywgJ2knKQogICAgICB9LCByaW5wdXRzID0gL14oPzppbnB1dHxzZWxlY3R8dGV4dGFyZWF8YnV0dG9uKSQvaSwgcmhlYWRlciA9IC9eaFxkJC9pLCBybmF0aXZlID0gL15bXntdK1x7XHMqXFtuYXRpdmUgXHcvLAogICAgICAvLyBFYXNpbHktcGFyc2VhYmxlL3JldHJpZXZhYmxlIElEIG9yIFRBRyBvciBDTEFTUyBzZWxlY3RvcnMKICAgICAgcnF1aWNrRXhwciA9IC9eKD86IyhbXHctXSspfChcdyspfFwuKFtcdy1dKykpJC8sIHJzaWJsaW5nID0gL1srfl0vLCByZXNjYXBlID0gLyd8XFwvZywKICAgICAgLy8gQ1NTIGVzY2FwZXMgaHR0cDovL3d3dy53My5vcmcvVFIvQ1NTMjEvc3luZGF0YS5odG1sI2VzY2FwZWQtY2hhcmFjdGVycwogICAgICBydW5lc2NhcGUgPSBuZXcgUmVnRXhwKCdcXFxcKFtcXGRhLWZdezEsNn0nICsgd2hpdGVzcGFjZSArICc/fCgnICsgd2hpdGVzcGFjZSArICcpfC4pJywgJ2lnJyksIGZ1bmVzY2FwZSA9IGZ1bmN0aW9uIChfLCBlc2NhcGVkLCBlc2NhcGVkV2hpdGVzcGFjZSkgewogICAgICAgIHZhciBoaWdoID0gJzB4JyArIGVzY2FwZWQgLSA2NTUzNjsKICAgICAgICAvLyBOYU4gbWVhbnMgbm9uLWNvZGVwb2ludAogICAgICAgIC8vIFN1cHBvcnQ6IEZpcmVmb3g8MjQKICAgICAgICAvLyBXb3JrYXJvdW5kIGVycm9uZW91cyBudW1lcmljIGludGVycHJldGF0aW9uIG9mICsiMHgiCiAgICAgICAgcmV0dXJuIGhpZ2ggIT09IGhpZ2ggfHwgZXNjYXBlZFdoaXRlc3BhY2UgPyBlc2NhcGVkIDogaGlnaCA8IDAgPyAvLyBCTVAgY29kZXBvaW50CiAgICAgICAgU3RyaW5nLmZyb21DaGFyQ29kZShoaWdoICsgNjU1MzYpIDogLy8gU3VwcGxlbWVudGFsIFBsYW5lIGNvZGVwb2ludCAoc3Vycm9nYXRlIHBhaXIpCiAgICAgICAgU3RyaW5nLmZyb21DaGFyQ29kZShoaWdoID4+IDEwIHwgNTUyOTYsIGhpZ2ggJiAxMDIzIHwgNTYzMjApOwogICAgICB9OwogICAgLy8gT3B0aW1pemUgZm9yIHB1c2guYXBwbHkoIF8sIE5vZGVMaXN0ICkKICAgIHRyeSB7CiAgICAgIHB1c2guYXBwbHkoYXJyID0gc2xpY2UuY2FsbChwcmVmZXJyZWREb2MuY2hpbGROb2RlcyksIHByZWZlcnJlZERvYy5jaGlsZE5vZGVzKTsKICAgICAgLy8gU3VwcG9ydDogQW5kcm9pZDw0LjAKICAgICAgLy8gRGV0ZWN0IHNpbGVudGx5IGZhaWxpbmcgcHVzaC5hcHBseQogICAgICBhcnJbcHJlZmVycmVkRG9jLmNoaWxkTm9kZXMubGVuZ3RoXS5ub2RlVHlwZTsKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgcHVzaCA9IHsKICAgICAgICBhcHBseTogYXJyLmxlbmd0aCA/IC8vIExldmVyYWdlIHNsaWNlIGlmIHBvc3NpYmxlCiAgICAgICAgZnVuY3Rpb24gKHRhcmdldCwgZWxzKSB7CiAgICAgICAgICBwdXNoX25hdGl2ZS5hcHBseSh0YXJnZXQsIHNsaWNlLmNhbGwoZWxzKSk7CiAgICAgICAgfSA6IC8vIFN1cHBvcnQ6IElFPDkKICAgICAgICAvLyBPdGhlcndpc2UgYXBwZW5kIGRpcmVjdGx5CiAgICAgICAgZnVuY3Rpb24gKHRhcmdldCwgZWxzKSB7CiAgICAgICAgICB2YXIgaiA9IHRhcmdldC5sZW5ndGgsIGkgPSAwOwogICAgICAgICAgLy8gQ2FuJ3QgdHJ1c3QgTm9kZUxpc3QubGVuZ3RoCiAgICAgICAgICB3aGlsZSAodGFyZ2V0W2orK10gPSBlbHNbaSsrXSkgewogICAgICAgICAgfQogICAgICAgICAgdGFyZ2V0Lmxlbmd0aCA9IGogLSAxOwogICAgICAgIH0KICAgICAgfTsKICAgIH0KICAgIGZ1bmN0aW9uIFNpenpsZShzZWxlY3RvciwgY29udGV4dCwgcmVzdWx0cywgc2VlZCkgewogICAgICB2YXIgbWF0Y2gsIGVsZW0sIG0sIG5vZGVUeXBlLAogICAgICAgIC8vIFFTQSB2YXJzCiAgICAgICAgaSwgZ3JvdXBzLCBvbGQsIG5pZCwgbmV3Q29udGV4dCwgbmV3U2VsZWN0b3I7CiAgICAgIGlmICgoY29udGV4dCA/IGNvbnRleHQub3duZXJEb2N1bWVudCB8fCBjb250ZXh0IDogcHJlZmVycmVkRG9jKSAhPT0gZG9jdW1lbnQpIHsKICAgICAgICBzZXREb2N1bWVudChjb250ZXh0KTsKICAgICAgfQogICAgICBjb250ZXh0ID0gY29udGV4dCB8fCBkb2N1bWVudDsKICAgICAgcmVzdWx0cyA9IHJlc3VsdHMgfHwgW107CiAgICAgIGlmICghc2VsZWN0b3IgfHwgdHlwZW9mIHNlbGVjdG9yICE9PSAnc3RyaW5nJykgewogICAgICAgIHJldHVybiByZXN1bHRzOwogICAgICB9CiAgICAgIGlmICgobm9kZVR5cGUgPSBjb250ZXh0Lm5vZGVUeXBlKSAhPT0gMSAmJiBub2RlVHlwZSAhPT0gOSkgewogICAgICAgIHJldHVybiBbXTsKICAgICAgfQogICAgICBpZiAoZG9jdW1lbnRJc0hUTUwgJiYgIXNlZWQpIHsKICAgICAgICAvLyBTaG9ydGN1dHMKICAgICAgICBpZiAobWF0Y2ggPSBycXVpY2tFeHByLmV4ZWMoc2VsZWN0b3IpKSB7CiAgICAgICAgICAvLyBTcGVlZC11cDogU2l6emxlKCIjSUQiKQogICAgICAgICAgaWYgKG0gPSBtYXRjaFsxXSkgewogICAgICAgICAgICBpZiAobm9kZVR5cGUgPT09IDkpIHsKICAgICAgICAgICAgICBlbGVtID0gY29udGV4dC5nZXRFbGVtZW50QnlJZChtKTsKICAgICAgICAgICAgICAvLyBDaGVjayBwYXJlbnROb2RlIHRvIGNhdGNoIHdoZW4gQmxhY2tiZXJyeSA0LjYgcmV0dXJucwogICAgICAgICAgICAgIC8vIG5vZGVzIHRoYXQgYXJlIG5vIGxvbmdlciBpbiB0aGUgZG9jdW1lbnQgKGpRdWVyeSAjNjk2MykKICAgICAgICAgICAgICBpZiAoZWxlbSAmJiBlbGVtLnBhcmVudE5vZGUpIHsKICAgICAgICAgICAgICAgIC8vIEhhbmRsZSB0aGUgY2FzZSB3aGVyZSBJRSwgT3BlcmEsIGFuZCBXZWJraXQgcmV0dXJuIGl0ZW1zCiAgICAgICAgICAgICAgICAvLyBieSBuYW1lIGluc3RlYWQgb2YgSUQKICAgICAgICAgICAgICAgIGlmIChlbGVtLmlkID09PSBtKSB7CiAgICAgICAgICAgICAgICAgIHJlc3VsdHMucHVzaChlbGVtKTsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdHM7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHRzOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAvLyBDb250ZXh0IGlzIG5vdCBhIGRvY3VtZW50CiAgICAgICAgICAgICAgaWYgKGNvbnRleHQub3duZXJEb2N1bWVudCAmJiAoZWxlbSA9IGNvbnRleHQub3duZXJEb2N1bWVudC5nZXRFbGVtZW50QnlJZChtKSkgJiYgY29udGFpbnMoY29udGV4dCwgZWxlbSkgJiYgZWxlbS5pZCA9PT0gbSkgewogICAgICAgICAgICAgICAgcmVzdWx0cy5wdXNoKGVsZW0pOwogICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdHM7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9ICAvLyBTcGVlZC11cDogU2l6emxlKCJUQUciKQogICAgICAgICAgfSBlbHNlIGlmIChtYXRjaFsyXSkgewogICAgICAgICAgICBwdXNoLmFwcGx5KHJlc3VsdHMsIGNvbnRleHQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoc2VsZWN0b3IpKTsKICAgICAgICAgICAgcmV0dXJuIHJlc3VsdHM7ICAvLyBTcGVlZC11cDogU2l6emxlKCIuQ0xBU1MiKQogICAgICAgICAgfSBlbHNlIGlmICgobSA9IG1hdGNoWzNdKSAmJiBzdXBwb3J0LmdldEVsZW1lbnRzQnlDbGFzc05hbWUgJiYgY29udGV4dC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKSB7CiAgICAgICAgICAgIHB1c2guYXBwbHkocmVzdWx0cywgY29udGV4dC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKG0pKTsKICAgICAgICAgICAgcmV0dXJuIHJlc3VsdHM7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIC8vIFFTQSBwYXRoCiAgICAgICAgaWYgKHN1cHBvcnQucXNhICYmICghcmJ1Z2d5UVNBIHx8ICFyYnVnZ3lRU0EudGVzdChzZWxlY3RvcikpKSB7CiAgICAgICAgICBuaWQgPSBvbGQgPSBleHBhbmRvOwogICAgICAgICAgbmV3Q29udGV4dCA9IGNvbnRleHQ7CiAgICAgICAgICBuZXdTZWxlY3RvciA9IG5vZGVUeXBlID09PSA5ICYmIHNlbGVjdG9yOwogICAgICAgICAgLy8gcVNBIHdvcmtzIHN0cmFuZ2VseSBvbiBFbGVtZW50LXJvb3RlZCBxdWVyaWVzCiAgICAgICAgICAvLyBXZSBjYW4gd29yayBhcm91bmQgdGhpcyBieSBzcGVjaWZ5aW5nIGFuIGV4dHJhIElEIG9uIHRoZSByb290CiAgICAgICAgICAvLyBhbmQgd29ya2luZyB1cCBmcm9tIHRoZXJlIChUaGFua3MgdG8gQW5kcmV3IER1cG9udCBmb3IgdGhlIHRlY2huaXF1ZSkKICAgICAgICAgIC8vIElFIDggZG9lc24ndCB3b3JrIG9uIG9iamVjdCBlbGVtZW50cwogICAgICAgICAgaWYgKG5vZGVUeXBlID09PSAxICYmIGNvbnRleHQubm9kZU5hbWUudG9Mb3dlckNhc2UoKSAhPT0gJ29iamVjdCcpIHsKICAgICAgICAgICAgZ3JvdXBzID0gdG9rZW5pemUoc2VsZWN0b3IpOwogICAgICAgICAgICBpZiAob2xkID0gY29udGV4dC5nZXRBdHRyaWJ1dGUoJ2lkJykpIHsKICAgICAgICAgICAgICBuaWQgPSBvbGQucmVwbGFjZShyZXNjYXBlLCAnXFwkJicpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGNvbnRleHQuc2V0QXR0cmlidXRlKCdpZCcsIG5pZCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbmlkID0gJ1tpZD1cJycgKyBuaWQgKyAnXCddICc7CiAgICAgICAgICAgIGkgPSBncm91cHMubGVuZ3RoOwogICAgICAgICAgICB3aGlsZSAoaS0tKSB7CiAgICAgICAgICAgICAgZ3JvdXBzW2ldID0gbmlkICsgdG9TZWxlY3Rvcihncm91cHNbaV0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG5ld0NvbnRleHQgPSByc2libGluZy50ZXN0KHNlbGVjdG9yKSAmJiB0ZXN0Q29udGV4dChjb250ZXh0LnBhcmVudE5vZGUpIHx8IGNvbnRleHQ7CiAgICAgICAgICAgIG5ld1NlbGVjdG9yID0gZ3JvdXBzLmpvaW4oJywnKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChuZXdTZWxlY3RvcikgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIHB1c2guYXBwbHkocmVzdWx0cywgbmV3Q29udGV4dC5xdWVyeVNlbGVjdG9yQWxsKG5ld1NlbGVjdG9yKSk7CiAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdHM7CiAgICAgICAgICAgIH0gY2F0Y2ggKHFzYUVycm9yKSB7CiAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgaWYgKCFvbGQpIHsKICAgICAgICAgICAgICAgIGNvbnRleHQucmVtb3ZlQXR0cmlidXRlKCdpZCcpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICAvLyBBbGwgb3RoZXJzCiAgICAgIHJldHVybiBzZWxlY3Qoc2VsZWN0b3IucmVwbGFjZShydHJpbSwgJyQxJyksIGNvbnRleHQsIHJlc3VsdHMsIHNlZWQpOwogICAgfQogICAgLyoqCiAgICAgKiBDcmVhdGUga2V5LXZhbHVlIGNhY2hlcyBvZiBsaW1pdGVkIHNpemUKICAgICAqIEByZXR1cm5zIHtGdW5jdGlvbihzdHJpbmcsIE9iamVjdCl9IFJldHVybnMgdGhlIE9iamVjdCBkYXRhIGFmdGVyIHN0b3JpbmcgaXQgb24gaXRzZWxmIHdpdGgKICAgICAqCXByb3BlcnR5IG5hbWUgdGhlIChzcGFjZS1zdWZmaXhlZCkgc3RyaW5nIGFuZCAoaWYgdGhlIGNhY2hlIGlzIGxhcmdlciB0aGFuIEV4cHIuY2FjaGVMZW5ndGgpCiAgICAgKglkZWxldGluZyB0aGUgb2xkZXN0IGVudHJ5CiAgICAgKi8KICAgIGZ1bmN0aW9uIGNyZWF0ZUNhY2hlKCkgewogICAgICB2YXIga2V5cyA9IFtdOwogICAgICBmdW5jdGlvbiBjYWNoZShrZXksIHZhbHVlKSB7CiAgICAgICAgLy8gVXNlIChrZXkgKyAiICIpIHRvIGF2b2lkIGNvbGxpc2lvbiB3aXRoIG5hdGl2ZSBwcm90b3R5cGUgcHJvcGVydGllcyAoc2VlIElzc3VlICMxNTcpCiAgICAgICAgaWYgKGtleXMucHVzaChrZXkgKyAnICcpID4gRXhwci5jYWNoZUxlbmd0aCkgewogICAgICAgICAgLy8gT25seSBrZWVwIHRoZSBtb3N0IHJlY2VudCBlbnRyaWVzCiAgICAgICAgICBkZWxldGUgY2FjaGVba2V5cy5zaGlmdCgpXTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGNhY2hlW2tleSArICcgJ10gPSB2YWx1ZTsKICAgICAgfQogICAgICByZXR1cm4gY2FjaGU7CiAgICB9CiAgICAvKioKICAgICAqIE1hcmsgYSBmdW5jdGlvbiBmb3Igc3BlY2lhbCB1c2UgYnkgU2l6emxlCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBmbiBUaGUgZnVuY3Rpb24gdG8gbWFyawogICAgICovCiAgICBmdW5jdGlvbiBtYXJrRnVuY3Rpb24oZm4pIHsKICAgICAgZm5bZXhwYW5kb10gPSB0cnVlOwogICAgICByZXR1cm4gZm47CiAgICB9CiAgICAvKioKICAgICAqIFN1cHBvcnQgdGVzdGluZyB1c2luZyBhbiBlbGVtZW50CiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBmbiBQYXNzZWQgdGhlIGNyZWF0ZWQgZGl2IGFuZCBleHBlY3RzIGEgYm9vbGVhbiByZXN1bHQKICAgICAqLwogICAgZnVuY3Rpb24gYXNzZXJ0KGZuKSB7CiAgICAgIHZhciBkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgICAgdHJ5IHsKICAgICAgICByZXR1cm4gISFmbihkaXYpOwogICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9IGZpbmFsbHkgewogICAgICAgIC8vIFJlbW92ZSBmcm9tIGl0cyBwYXJlbnQgYnkgZGVmYXVsdAogICAgICAgIGlmIChkaXYucGFyZW50Tm9kZSkgewogICAgICAgICAgZGl2LnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoZGl2KTsKICAgICAgICB9CiAgICAgICAgLy8gcmVsZWFzZSBtZW1vcnkgaW4gSUUKICAgICAgICBkaXYgPSBudWxsOwogICAgICB9CiAgICB9CiAgICAvKioKICAgICAqIEFkZHMgdGhlIHNhbWUgaGFuZGxlciBmb3IgYWxsIG9mIHRoZSBzcGVjaWZpZWQgYXR0cnMKICAgICAqIEBwYXJhbSB7U3RyaW5nfSBhdHRycyBQaXBlLXNlcGFyYXRlZCBsaXN0IG9mIGF0dHJpYnV0ZXMKICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGhhbmRsZXIgVGhlIG1ldGhvZCB0aGF0IHdpbGwgYmUgYXBwbGllZAogICAgICovCiAgICBmdW5jdGlvbiBhZGRIYW5kbGUoYXR0cnMsIGhhbmRsZXIpIHsKICAgICAgdmFyIGFyciA9IGF0dHJzLnNwbGl0KCd8JyksIGkgPSBhdHRycy5sZW5ndGg7CiAgICAgIHdoaWxlIChpLS0pIHsKICAgICAgICBFeHByLmF0dHJIYW5kbGVbYXJyW2ldXSA9IGhhbmRsZXI7CiAgICAgIH0KICAgIH0KICAgIC8qKgogICAgICogQ2hlY2tzIGRvY3VtZW50IG9yZGVyIG9mIHR3byBzaWJsaW5ncwogICAgICogQHBhcmFtIHtFbGVtZW50fSBhCiAgICAgKiBAcGFyYW0ge0VsZW1lbnR9IGIKICAgICAqIEByZXR1cm5zIHtOdW1iZXJ9IFJldHVybnMgbGVzcyB0aGFuIDAgaWYgYSBwcmVjZWRlcyBiLCBncmVhdGVyIHRoYW4gMCBpZiBhIGZvbGxvd3MgYgogICAgICovCiAgICBmdW5jdGlvbiBzaWJsaW5nQ2hlY2soYSwgYikgewogICAgICB2YXIgY3VyID0gYiAmJiBhLCBkaWZmID0gY3VyICYmIGEubm9kZVR5cGUgPT09IDEgJiYgYi5ub2RlVHlwZSA9PT0gMSAmJiAofmIuc291cmNlSW5kZXggfHwgTUFYX05FR0FUSVZFKSAtICh+YS5zb3VyY2VJbmRleCB8fCBNQVhfTkVHQVRJVkUpOwogICAgICAvLyBVc2UgSUUgc291cmNlSW5kZXggaWYgYXZhaWxhYmxlIG9uIGJvdGggbm9kZXMKICAgICAgaWYgKGRpZmYpIHsKICAgICAgICByZXR1cm4gZGlmZjsKICAgICAgfQogICAgICAvLyBDaGVjayBpZiBiIGZvbGxvd3MgYQogICAgICBpZiAoY3VyKSB7CiAgICAgICAgd2hpbGUgKGN1ciA9IGN1ci5uZXh0U2libGluZykgewogICAgICAgICAgaWYgKGN1ciA9PT0gYikgewogICAgICAgICAgICByZXR1cm4gLTE7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBhID8gMSA6IC0xOwogICAgfQogICAgLyoqCiAgICAgKiBSZXR1cm5zIGEgZnVuY3Rpb24gdG8gdXNlIGluIHBzZXVkb3MgZm9yIGlucHV0IHR5cGVzCiAgICAgKiBAcGFyYW0ge1N0cmluZ30gdHlwZQogICAgICovCiAgICBmdW5jdGlvbiBjcmVhdGVJbnB1dFBzZXVkbyh0eXBlKSB7CiAgICAgIHJldHVybiBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgIHZhciBuYW1lID0gZWxlbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpOwogICAgICAgIHJldHVybiBuYW1lID09PSAnaW5wdXQnICYmIGVsZW0udHlwZSA9PT0gdHlwZTsKICAgICAgfTsKICAgIH0KICAgIC8qKgogICAgICogUmV0dXJucyBhIGZ1bmN0aW9uIHRvIHVzZSBpbiBwc2V1ZG9zIGZvciBidXR0b25zCiAgICAgKiBAcGFyYW0ge1N0cmluZ30gdHlwZQogICAgICovCiAgICBmdW5jdGlvbiBjcmVhdGVCdXR0b25Qc2V1ZG8odHlwZSkgewogICAgICByZXR1cm4gZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICB2YXIgbmFtZSA9IGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKTsKICAgICAgICByZXR1cm4gKG5hbWUgPT09ICdpbnB1dCcgfHwgbmFtZSA9PT0gJ2J1dHRvbicpICYmIGVsZW0udHlwZSA9PT0gdHlwZTsKICAgICAgfTsKICAgIH0KICAgIC8qKgogICAgICogUmV0dXJucyBhIGZ1bmN0aW9uIHRvIHVzZSBpbiBwc2V1ZG9zIGZvciBwb3NpdGlvbmFscwogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gZm4KICAgICAqLwogICAgZnVuY3Rpb24gY3JlYXRlUG9zaXRpb25hbFBzZXVkbyhmbikgewogICAgICByZXR1cm4gbWFya0Z1bmN0aW9uKGZ1bmN0aW9uIChhcmd1bWVudCkgewogICAgICAgIGFyZ3VtZW50ID0gK2FyZ3VtZW50OwogICAgICAgIHJldHVybiBtYXJrRnVuY3Rpb24oZnVuY3Rpb24gKHNlZWQsIG1hdGNoZXMpIHsKICAgICAgICAgIHZhciBqLCBtYXRjaEluZGV4ZXMgPSBmbihbXSwgc2VlZC5sZW5ndGgsIGFyZ3VtZW50KSwgaSA9IG1hdGNoSW5kZXhlcy5sZW5ndGg7CiAgICAgICAgICAvLyBNYXRjaCBlbGVtZW50cyBmb3VuZCBhdCB0aGUgc3BlY2lmaWVkIGluZGV4ZXMKICAgICAgICAgIHdoaWxlIChpLS0pIHsKICAgICAgICAgICAgaWYgKHNlZWRbaiA9IG1hdGNoSW5kZXhlc1tpXV0pIHsKICAgICAgICAgICAgICBzZWVkW2pdID0gIShtYXRjaGVzW2pdID0gc2VlZFtqXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfSk7CiAgICB9CiAgICAvKioKICAgICAqIENoZWNrcyBhIG5vZGUgZm9yIHZhbGlkaXR5IGFzIGEgU2l6emxlIGNvbnRleHQKICAgICAqIEBwYXJhbSB7RWxlbWVudHxPYmplY3Q9fSBjb250ZXh0CiAgICAgKiBAcmV0dXJucyB7RWxlbWVudHxPYmplY3R8Qm9vbGVhbn0gVGhlIGlucHV0IG5vZGUgaWYgYWNjZXB0YWJsZSwgb3RoZXJ3aXNlIGEgZmFsc3kgdmFsdWUKICAgICAqLwogICAgZnVuY3Rpb24gdGVzdENvbnRleHQoY29udGV4dCkgewogICAgICByZXR1cm4gY29udGV4dCAmJiB0eXBlb2YgY29udGV4dC5nZXRFbGVtZW50c0J5VGFnTmFtZSAhPT0gc3RydW5kZWZpbmVkICYmIGNvbnRleHQ7CiAgICB9CiAgICAvLyBFeHBvc2Ugc3VwcG9ydCB2YXJzIGZvciBjb252ZW5pZW5jZQogICAgc3VwcG9ydCA9IFNpenpsZS5zdXBwb3J0ID0ge307CiAgICAvKioKICAgICAqIERldGVjdHMgWE1MIG5vZGVzCiAgICAgKiBAcGFyYW0ge0VsZW1lbnR8T2JqZWN0fSBlbGVtIEFuIGVsZW1lbnQgb3IgYSBkb2N1bWVudAogICAgICogQHJldHVybnMge0Jvb2xlYW59IFRydWUgaWZmIGVsZW0gaXMgYSBub24tSFRNTCBYTUwgbm9kZQogICAgICovCiAgICBpc1hNTCA9IFNpenpsZS5pc1hNTCA9IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgIC8vIGRvY3VtZW50RWxlbWVudCBpcyB2ZXJpZmllZCBmb3IgY2FzZXMgd2hlcmUgaXQgZG9lc24ndCB5ZXQgZXhpc3QKICAgICAgLy8gKHN1Y2ggYXMgbG9hZGluZyBpZnJhbWVzIGluIElFIC0gIzQ4MzMpCiAgICAgIHZhciBkb2N1bWVudEVsZW1lbnQgPSBlbGVtICYmIChlbGVtLm93bmVyRG9jdW1lbnQgfHwgZWxlbSkuZG9jdW1lbnRFbGVtZW50OwogICAgICByZXR1cm4gZG9jdW1lbnRFbGVtZW50ID8gZG9jdW1lbnRFbGVtZW50Lm5vZGVOYW1lICE9PSAnSFRNTCcgOiBmYWxzZTsKICAgIH07CiAgICAvKioKICAgICAqIFNldHMgZG9jdW1lbnQtcmVsYXRlZCB2YXJpYWJsZXMgb25jZSBiYXNlZCBvbiB0aGUgY3VycmVudCBkb2N1bWVudAogICAgICogQHBhcmFtIHtFbGVtZW50fE9iamVjdH0gW2RvY10gQW4gZWxlbWVudCBvciBkb2N1bWVudCBvYmplY3QgdG8gdXNlIHRvIHNldCB0aGUgZG9jdW1lbnQKICAgICAqIEByZXR1cm5zIHtPYmplY3R9IFJldHVybnMgdGhlIGN1cnJlbnQgZG9jdW1lbnQKICAgICAqLwogICAgc2V0RG9jdW1lbnQgPSBTaXp6bGUuc2V0RG9jdW1lbnQgPSBmdW5jdGlvbiAobm9kZSkgewogICAgICB2YXIgaGFzQ29tcGFyZSwgZG9jID0gbm9kZSA/IG5vZGUub3duZXJEb2N1bWVudCB8fCBub2RlIDogcHJlZmVycmVkRG9jLCBwYXJlbnQgPSBkb2MuZGVmYXVsdFZpZXc7CiAgICAgIC8vIElmIG5vIGRvY3VtZW50IGFuZCBkb2N1bWVudEVsZW1lbnQgaXMgYXZhaWxhYmxlLCByZXR1cm4KICAgICAgaWYgKGRvYyA9PT0gZG9jdW1lbnQgfHwgZG9jLm5vZGVUeXBlICE9PSA5IHx8ICFkb2MuZG9jdW1lbnRFbGVtZW50KSB7CiAgICAgICAgcmV0dXJuIGRvY3VtZW50OwogICAgICB9CiAgICAgIC8vIFNldCBvdXIgZG9jdW1lbnQKICAgICAgZG9jdW1lbnQgPSBkb2M7CiAgICAgIGRvY0VsZW0gPSBkb2MuZG9jdW1lbnRFbGVtZW50OwogICAgICAvLyBTdXBwb3J0IHRlc3RzCiAgICAgIGRvY3VtZW50SXNIVE1MID0gIWlzWE1MKGRvYyk7CiAgICAgIC8vIFN1cHBvcnQ6IElFPjgKICAgICAgLy8gSWYgaWZyYW1lIGRvY3VtZW50IGlzIGFzc2lnbmVkIHRvICJkb2N1bWVudCIgdmFyaWFibGUgYW5kIGlmIGlmcmFtZSBoYXMgYmVlbiByZWxvYWRlZCwKICAgICAgLy8gSUUgd2lsbCB0aHJvdyAicGVybWlzc2lvbiBkZW5pZWQiIGVycm9yIHdoZW4gYWNjZXNzaW5nICJkb2N1bWVudCIgdmFyaWFibGUsIHNlZSBqUXVlcnkgIzEzOTM2CiAgICAgIC8vIElFNi04IGRvIG5vdCBzdXBwb3J0IHRoZSBkZWZhdWx0VmlldyBwcm9wZXJ0eSBzbyBwYXJlbnQgd2lsbCBiZSB1bmRlZmluZWQKICAgICAgaWYgKHBhcmVudCAmJiBwYXJlbnQgIT09IHBhcmVudC50b3ApIHsKICAgICAgICAvLyBJRTExIGRvZXMgbm90IGhhdmUgYXR0YWNoRXZlbnQsIHNvIGFsbCBtdXN0IHN1ZmZlcgogICAgICAgIGlmIChwYXJlbnQuYWRkRXZlbnRMaXN0ZW5lcikgewogICAgICAgICAgcGFyZW50LmFkZEV2ZW50TGlzdGVuZXIoJ3VubG9hZCcsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgc2V0RG9jdW1lbnQoKTsKICAgICAgICAgIH0sIGZhbHNlKTsKICAgICAgICB9IGVsc2UgaWYgKHBhcmVudC5hdHRhY2hFdmVudCkgewogICAgICAgICAgcGFyZW50LmF0dGFjaEV2ZW50KCdvbnVubG9hZCcsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgc2V0RG9jdW1lbnQoKTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfQogICAgICAvKiBBdHRyaWJ1dGVzCiAgICAgIAktLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tICovCiAgICAgIC8vIFN1cHBvcnQ6IElFPDgKICAgICAgLy8gVmVyaWZ5IHRoYXQgZ2V0QXR0cmlidXRlIHJlYWxseSByZXR1cm5zIGF0dHJpYnV0ZXMgYW5kIG5vdCBwcm9wZXJ0aWVzIChleGNlcHRpbmcgSUU4IGJvb2xlYW5zKQogICAgICBzdXBwb3J0LmF0dHJpYnV0ZXMgPSBhc3NlcnQoZnVuY3Rpb24gKGRpdikgewogICAgICAgIGRpdi5jbGFzc05hbWUgPSAnaSc7CiAgICAgICAgcmV0dXJuICFkaXYuZ2V0QXR0cmlidXRlKCdjbGFzc05hbWUnKTsKICAgICAgfSk7CiAgICAgIC8qIGdldEVsZW1lbnQocylCeSoKICAgICAgCS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gKi8KICAgICAgLy8gQ2hlY2sgaWYgZ2V0RWxlbWVudHNCeVRhZ05hbWUoIioiKSByZXR1cm5zIG9ubHkgZWxlbWVudHMKICAgICAgc3VwcG9ydC5nZXRFbGVtZW50c0J5VGFnTmFtZSA9IGFzc2VydChmdW5jdGlvbiAoZGl2KSB7CiAgICAgICAgZGl2LmFwcGVuZENoaWxkKGRvYy5jcmVhdGVDb21tZW50KCcnKSk7CiAgICAgICAgcmV0dXJuICFkaXYuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJyonKS5sZW5ndGg7CiAgICAgIH0pOwogICAgICAvLyBDaGVjayBpZiBnZXRFbGVtZW50c0J5Q2xhc3NOYW1lIGNhbiBiZSB0cnVzdGVkCiAgICAgIHN1cHBvcnQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSA9IHJuYXRpdmUudGVzdChkb2MuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSkgJiYgYXNzZXJ0KGZ1bmN0aW9uIChkaXYpIHsKICAgICAgICBkaXYuaW5uZXJIVE1MID0gJzxkaXYgY2xhc3M9XCdhXCc+PC9kaXY+PGRpdiBjbGFzcz1cJ2EgaVwnPjwvZGl2Pic7CiAgICAgICAgLy8gU3VwcG9ydDogU2FmYXJpPDQKICAgICAgICAvLyBDYXRjaCBjbGFzcyBvdmVyLWNhY2hpbmcKICAgICAgICBkaXYuZmlyc3RDaGlsZC5jbGFzc05hbWUgPSAnaSc7CiAgICAgICAgLy8gU3VwcG9ydDogT3BlcmE8MTAKICAgICAgICAvLyBDYXRjaCBnRUJDTiBmYWlsdXJlIHRvIGZpbmQgbm9uLWxlYWRpbmcgY2xhc3NlcwogICAgICAgIHJldHVybiBkaXYuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSgnaScpLmxlbmd0aCA9PT0gMjsKICAgICAgfSk7CiAgICAgIC8vIFN1cHBvcnQ6IElFPDEwCiAgICAgIC8vIENoZWNrIGlmIGdldEVsZW1lbnRCeUlkIHJldHVybnMgZWxlbWVudHMgYnkgbmFtZQogICAgICAvLyBUaGUgYnJva2VuIGdldEVsZW1lbnRCeUlkIG1ldGhvZHMgZG9uJ3QgcGljayB1cCBwcm9ncmFtYXRpY2FsbHktc2V0IG5hbWVzLAogICAgICAvLyBzbyB1c2UgYSByb3VuZGFib3V0IGdldEVsZW1lbnRzQnlOYW1lIHRlc3QKICAgICAgc3VwcG9ydC5nZXRCeUlkID0gYXNzZXJ0KGZ1bmN0aW9uIChkaXYpIHsKICAgICAgICBkb2NFbGVtLmFwcGVuZENoaWxkKGRpdikuaWQgPSBleHBhbmRvOwogICAgICAgIHJldHVybiAhZG9jLmdldEVsZW1lbnRzQnlOYW1lIHx8ICFkb2MuZ2V0RWxlbWVudHNCeU5hbWUoZXhwYW5kbykubGVuZ3RoOwogICAgICB9KTsKICAgICAgLy8gSUQgZmluZCBhbmQgZmlsdGVyCiAgICAgIGlmIChzdXBwb3J0LmdldEJ5SWQpIHsKICAgICAgICBFeHByLmZpbmRbJ0lEJ10gPSBmdW5jdGlvbiAoaWQsIGNvbnRleHQpIHsKICAgICAgICAgIGlmICh0eXBlb2YgY29udGV4dC5nZXRFbGVtZW50QnlJZCAhPT0gc3RydW5kZWZpbmVkICYmIGRvY3VtZW50SXNIVE1MKSB7CiAgICAgICAgICAgIHZhciBtID0gY29udGV4dC5nZXRFbGVtZW50QnlJZChpZCk7CiAgICAgICAgICAgIC8vIENoZWNrIHBhcmVudE5vZGUgdG8gY2F0Y2ggd2hlbiBCbGFja2JlcnJ5IDQuNiByZXR1cm5zCiAgICAgICAgICAgIC8vIG5vZGVzIHRoYXQgYXJlIG5vIGxvbmdlciBpbiB0aGUgZG9jdW1lbnQgIzY5NjMKICAgICAgICAgICAgcmV0dXJuIG0gJiYgbS5wYXJlbnROb2RlID8gW21dIDogW107CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBFeHByLmZpbHRlclsnSUQnXSA9IGZ1bmN0aW9uIChpZCkgewogICAgICAgICAgdmFyIGF0dHJJZCA9IGlkLnJlcGxhY2UocnVuZXNjYXBlLCBmdW5lc2NhcGUpOwogICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgICAgIHJldHVybiBlbGVtLmdldEF0dHJpYnV0ZSgnaWQnKSA9PT0gYXR0cklkOwogICAgICAgICAgfTsKICAgICAgICB9OwogICAgICB9IGVsc2UgewogICAgICAgIC8vIFN1cHBvcnQ6IElFNi83CiAgICAgICAgLy8gZ2V0RWxlbWVudEJ5SWQgaXMgbm90IHJlbGlhYmxlIGFzIGEgZmluZCBzaG9ydGN1dAogICAgICAgIGRlbGV0ZSBFeHByLmZpbmRbJ0lEJ107CiAgICAgICAgRXhwci5maWx0ZXJbJ0lEJ10gPSBmdW5jdGlvbiAoaWQpIHsKICAgICAgICAgIHZhciBhdHRySWQgPSBpZC5yZXBsYWNlKHJ1bmVzY2FwZSwgZnVuZXNjYXBlKTsKICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgICB2YXIgbm9kZSA9IHR5cGVvZiBlbGVtLmdldEF0dHJpYnV0ZU5vZGUgIT09IHN0cnVuZGVmaW5lZCAmJiBlbGVtLmdldEF0dHJpYnV0ZU5vZGUoJ2lkJyk7CiAgICAgICAgICAgIHJldHVybiBub2RlICYmIG5vZGUudmFsdWUgPT09IGF0dHJJZDsKICAgICAgICAgIH07CiAgICAgICAgfTsKICAgICAgfQogICAgICAvLyBUYWcKICAgICAgRXhwci5maW5kWydUQUcnXSA9IHN1cHBvcnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUgPyBmdW5jdGlvbiAodGFnLCBjb250ZXh0KSB7CiAgICAgICAgaWYgKHR5cGVvZiBjb250ZXh0LmdldEVsZW1lbnRzQnlUYWdOYW1lICE9PSBzdHJ1bmRlZmluZWQpIHsKICAgICAgICAgIHJldHVybiBjb250ZXh0LmdldEVsZW1lbnRzQnlUYWdOYW1lKHRhZyk7CiAgICAgICAgfQogICAgICB9IDogZnVuY3Rpb24gKHRhZywgY29udGV4dCkgewogICAgICAgIHZhciBlbGVtLCB0bXAgPSBbXSwgaSA9IDAsIHJlc3VsdHMgPSBjb250ZXh0LmdldEVsZW1lbnRzQnlUYWdOYW1lKHRhZyk7CiAgICAgICAgLy8gRmlsdGVyIG91dCBwb3NzaWJsZSBjb21tZW50cwogICAgICAgIGlmICh0YWcgPT09ICcqJykgewogICAgICAgICAgd2hpbGUgKGVsZW0gPSByZXN1bHRzW2krK10pIHsKICAgICAgICAgICAgaWYgKGVsZW0ubm9kZVR5cGUgPT09IDEpIHsKICAgICAgICAgICAgICB0bXAucHVzaChlbGVtKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRtcDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdHM7CiAgICAgIH07CiAgICAgIC8vIENsYXNzCiAgICAgIEV4cHIuZmluZFsnQ0xBU1MnXSA9IHN1cHBvcnQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSAmJiBmdW5jdGlvbiAoY2xhc3NOYW1lLCBjb250ZXh0KSB7CiAgICAgICAgaWYgKHR5cGVvZiBjb250ZXh0LmdldEVsZW1lbnRzQnlDbGFzc05hbWUgIT09IHN0cnVuZGVmaW5lZCAmJiBkb2N1bWVudElzSFRNTCkgewogICAgICAgICAgcmV0dXJuIGNvbnRleHQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZShjbGFzc05hbWUpOwogICAgICAgIH0KICAgICAgfTsKICAgICAgLyogUVNBL21hdGNoZXNTZWxlY3RvcgogICAgICAJLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSAqLwogICAgICAvLyBRU0EgYW5kIG1hdGNoZXNTZWxlY3RvciBzdXBwb3J0CiAgICAgIC8vIG1hdGNoZXNTZWxlY3Rvcig6YWN0aXZlKSByZXBvcnRzIGZhbHNlIHdoZW4gdHJ1ZSAoSUU5L09wZXJhIDExLjUpCiAgICAgIHJidWdneU1hdGNoZXMgPSBbXTsKICAgICAgLy8gcVNhKDpmb2N1cykgcmVwb3J0cyBmYWxzZSB3aGVuIHRydWUgKENocm9tZSAyMSkKICAgICAgLy8gV2UgYWxsb3cgdGhpcyBiZWNhdXNlIG9mIGEgYnVnIGluIElFOC85IHRoYXQgdGhyb3dzIGFuIGVycm9yCiAgICAgIC8vIHdoZW5ldmVyIGBkb2N1bWVudC5hY3RpdmVFbGVtZW50YCBpcyBhY2Nlc3NlZCBvbiBhbiBpZnJhbWUKICAgICAgLy8gU28sIHdlIGFsbG93IDpmb2N1cyB0byBwYXNzIHRocm91Z2ggUVNBIGFsbCB0aGUgdGltZSB0byBhdm9pZCB0aGUgSUUgZXJyb3IKICAgICAgLy8gU2VlIGh0dHA6Ly9idWdzLmpxdWVyeS5jb20vdGlja2V0LzEzMzc4CiAgICAgIHJidWdneVFTQSA9IFtdOwogICAgICBpZiAoc3VwcG9ydC5xc2EgPSBybmF0aXZlLnRlc3QoZG9jLnF1ZXJ5U2VsZWN0b3JBbGwpKSB7CiAgICAgICAgLy8gQnVpbGQgUVNBIHJlZ2V4CiAgICAgICAgLy8gUmVnZXggc3RyYXRlZ3kgYWRvcHRlZCBmcm9tIERpZWdvIFBlcmluaQogICAgICAgIGFzc2VydChmdW5jdGlvbiAoZGl2KSB7CiAgICAgICAgICAvLyBTZWxlY3QgaXMgc2V0IHRvIGVtcHR5IHN0cmluZyBvbiBwdXJwb3NlCiAgICAgICAgICAvLyBUaGlzIGlzIHRvIHRlc3QgSUUncyB0cmVhdG1lbnQgb2Ygbm90IGV4cGxpY2l0bHkKICAgICAgICAgIC8vIHNldHRpbmcgYSBib29sZWFuIGNvbnRlbnQgYXR0cmlidXRlLAogICAgICAgICAgLy8gc2luY2UgaXRzIHByZXNlbmNlIHNob3VsZCBiZSBlbm91Z2gKICAgICAgICAgIC8vIGh0dHA6Ly9idWdzLmpxdWVyeS5jb20vdGlja2V0LzEyMzU5CiAgICAgICAgICBkaXYuaW5uZXJIVE1MID0gJzxzZWxlY3QgbXNhbGxvd2NsaXA9XCdcJz48b3B0aW9uIHNlbGVjdGVkPVwnXCc+PC9vcHRpb24+PC9zZWxlY3Q+JzsKICAgICAgICAgIC8vIFN1cHBvcnQ6IElFOCwgT3BlcmEgMTEtMTIuMTYKICAgICAgICAgIC8vIE5vdGhpbmcgc2hvdWxkIGJlIHNlbGVjdGVkIHdoZW4gZW1wdHkgc3RyaW5ncyBmb2xsb3cgXj0gb3IgJD0gb3IgKj0KICAgICAgICAgIC8vIFRoZSB0ZXN0IGF0dHJpYnV0ZSBtdXN0IGJlIHVua25vd24gaW4gT3BlcmEgYnV0ICJzYWZlIiBmb3IgV2luUlQKICAgICAgICAgIC8vIGh0dHA6Ly9tc2RuLm1pY3Jvc29mdC5jb20vZW4tdXMvbGlicmFyeS9pZS9oaDQ2NTM4OC5hc3B4I2F0dHJpYnV0ZV9zZWN0aW9uCiAgICAgICAgICBpZiAoZGl2LnF1ZXJ5U2VsZWN0b3JBbGwoJ1ttc2FsbG93Y2xpcF49XCdcJ10nKS5sZW5ndGgpIHsKICAgICAgICAgICAgcmJ1Z2d5UVNBLnB1c2goJ1sqXiRdPScgKyB3aGl0ZXNwYWNlICsgJyooPzpcJ1wnfCIiKScpOwogICAgICAgICAgfQogICAgICAgICAgLy8gU3VwcG9ydDogSUU4CiAgICAgICAgICAvLyBCb29sZWFuIGF0dHJpYnV0ZXMgYW5kICJ2YWx1ZSIgYXJlIG5vdCB0cmVhdGVkIGNvcnJlY3RseQogICAgICAgICAgaWYgKCFkaXYucXVlcnlTZWxlY3RvckFsbCgnW3NlbGVjdGVkXScpLmxlbmd0aCkgewogICAgICAgICAgICByYnVnZ3lRU0EucHVzaCgnXFxbJyArIHdoaXRlc3BhY2UgKyAnKig/OnZhbHVlfCcgKyBib29sZWFucyArICcpJyk7CiAgICAgICAgICB9CiAgICAgICAgICAvLyBXZWJraXQvT3BlcmEgLSA6Y2hlY2tlZCBzaG91bGQgcmV0dXJuIHNlbGVjdGVkIG9wdGlvbiBlbGVtZW50cwogICAgICAgICAgLy8gaHR0cDovL3d3dy53My5vcmcvVFIvMjAxMS9SRUMtY3NzMy1zZWxlY3RvcnMtMjAxMTA5MjkvI2NoZWNrZWQKICAgICAgICAgIC8vIElFOCB0aHJvd3MgZXJyb3IgaGVyZSBhbmQgd2lsbCBub3Qgc2VlIGxhdGVyIHRlc3RzCiAgICAgICAgICBpZiAoIWRpdi5xdWVyeVNlbGVjdG9yQWxsKCc6Y2hlY2tlZCcpLmxlbmd0aCkgewogICAgICAgICAgICByYnVnZ3lRU0EucHVzaCgnOmNoZWNrZWQnKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICBhc3NlcnQoZnVuY3Rpb24gKGRpdikgewogICAgICAgICAgLy8gU3VwcG9ydDogV2luZG93cyA4IE5hdGl2ZSBBcHBzCiAgICAgICAgICAvLyBUaGUgdHlwZSBhbmQgbmFtZSBhdHRyaWJ1dGVzIGFyZSByZXN0cmljdGVkIGR1cmluZyAuaW5uZXJIVE1MIGFzc2lnbm1lbnQKICAgICAgICAgIHZhciBpbnB1dCA9IGRvYy5jcmVhdGVFbGVtZW50KCdpbnB1dCcpOwogICAgICAgICAgaW5wdXQuc2V0QXR0cmlidXRlKCd0eXBlJywgJ2hpZGRlbicpOwogICAgICAgICAgZGl2LmFwcGVuZENoaWxkKGlucHV0KS5zZXRBdHRyaWJ1dGUoJ25hbWUnLCAnRCcpOwogICAgICAgICAgLy8gU3VwcG9ydDogSUU4CiAgICAgICAgICAvLyBFbmZvcmNlIGNhc2Utc2Vuc2l0aXZpdHkgb2YgbmFtZSBhdHRyaWJ1dGUKICAgICAgICAgIGlmIChkaXYucXVlcnlTZWxlY3RvckFsbCgnW25hbWU9ZF0nKS5sZW5ndGgpIHsKICAgICAgICAgICAgcmJ1Z2d5UVNBLnB1c2goJ25hbWUnICsgd2hpdGVzcGFjZSArICcqWypeJHwhfl0/PScpOwogICAgICAgICAgfQogICAgICAgICAgLy8gRkYgMy41IC0gOmVuYWJsZWQvOmRpc2FibGVkIGFuZCBoaWRkZW4gZWxlbWVudHMgKGhpZGRlbiBlbGVtZW50cyBhcmUgc3RpbGwgZW5hYmxlZCkKICAgICAgICAgIC8vIElFOCB0aHJvd3MgZXJyb3IgaGVyZSBhbmQgd2lsbCBub3Qgc2VlIGxhdGVyIHRlc3RzCiAgICAgICAgICBpZiAoIWRpdi5xdWVyeVNlbGVjdG9yQWxsKCc6ZW5hYmxlZCcpLmxlbmd0aCkgewogICAgICAgICAgICByYnVnZ3lRU0EucHVzaCgnOmVuYWJsZWQnLCAnOmRpc2FibGVkJyk7CiAgICAgICAgICB9CiAgICAgICAgICAvLyBPcGVyYSAxMC0xMSBkb2VzIG5vdCB0aHJvdyBvbiBwb3N0LWNvbW1hIGludmFsaWQgcHNldWRvcwogICAgICAgICAgZGl2LnF1ZXJ5U2VsZWN0b3JBbGwoJyosOngnKTsKICAgICAgICAgIHJidWdneVFTQS5wdXNoKCcsLio6Jyk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgaWYgKHN1cHBvcnQubWF0Y2hlc1NlbGVjdG9yID0gcm5hdGl2ZS50ZXN0KG1hdGNoZXMgPSBkb2NFbGVtLm1hdGNoZXMgfHwgZG9jRWxlbS53ZWJraXRNYXRjaGVzU2VsZWN0b3IgfHwgZG9jRWxlbS5tb3pNYXRjaGVzU2VsZWN0b3IgfHwgZG9jRWxlbS5vTWF0Y2hlc1NlbGVjdG9yIHx8IGRvY0VsZW0ubXNNYXRjaGVzU2VsZWN0b3IpKSB7CiAgICAgICAgYXNzZXJ0KGZ1bmN0aW9uIChkaXYpIHsKICAgICAgICAgIC8vIENoZWNrIHRvIHNlZSBpZiBpdCdzIHBvc3NpYmxlIHRvIGRvIG1hdGNoZXNTZWxlY3RvcgogICAgICAgICAgLy8gb24gYSBkaXNjb25uZWN0ZWQgbm9kZSAoSUUgOSkKICAgICAgICAgIHN1cHBvcnQuZGlzY29ubmVjdGVkTWF0Y2ggPSBtYXRjaGVzLmNhbGwoZGl2LCAnZGl2Jyk7CiAgICAgICAgICAvLyBUaGlzIHNob3VsZCBmYWlsIHdpdGggYW4gZXhjZXB0aW9uCiAgICAgICAgICAvLyBHZWNrbyBkb2VzIG5vdCBlcnJvciwgcmV0dXJucyBmYWxzZSBpbnN0ZWFkCiAgICAgICAgICBtYXRjaGVzLmNhbGwoZGl2LCAnW3MhPVwnXCddOngnKTsKICAgICAgICAgIHJidWdneU1hdGNoZXMucHVzaCgnIT0nLCBwc2V1ZG9zKTsKICAgICAgICB9KTsKICAgICAgfQogICAgICByYnVnZ3lRU0EgPSByYnVnZ3lRU0EubGVuZ3RoICYmIG5ldyBSZWdFeHAocmJ1Z2d5UVNBLmpvaW4oJ3wnKSk7CiAgICAgIHJidWdneU1hdGNoZXMgPSByYnVnZ3lNYXRjaGVzLmxlbmd0aCAmJiBuZXcgUmVnRXhwKHJidWdneU1hdGNoZXMuam9pbignfCcpKTsKICAgICAgLyogQ29udGFpbnMKICAgICAgCS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gKi8KICAgICAgaGFzQ29tcGFyZSA9IHJuYXRpdmUudGVzdChkb2NFbGVtLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uKTsKICAgICAgLy8gRWxlbWVudCBjb250YWlucyBhbm90aGVyCiAgICAgIC8vIFB1cnBvc2VmdWxseSBkb2VzIG5vdCBpbXBsZW1lbnQgaW5jbHVzaXZlIGRlc2NlbmRlbnQKICAgICAgLy8gQXMgaW4sIGFuIGVsZW1lbnQgZG9lcyBub3QgY29udGFpbiBpdHNlbGYKICAgICAgY29udGFpbnMgPSBoYXNDb21wYXJlIHx8IHJuYXRpdmUudGVzdChkb2NFbGVtLmNvbnRhaW5zKSA/IGZ1bmN0aW9uIChhLCBiKSB7CiAgICAgICAgdmFyIGFkb3duID0gYS5ub2RlVHlwZSA9PT0gOSA/IGEuZG9jdW1lbnRFbGVtZW50IDogYSwgYnVwID0gYiAmJiBiLnBhcmVudE5vZGU7CiAgICAgICAgcmV0dXJuIGEgPT09IGJ1cCB8fCAhIShidXAgJiYgYnVwLm5vZGVUeXBlID09PSAxICYmIChhZG93bi5jb250YWlucyA/IGFkb3duLmNvbnRhaW5zKGJ1cCkgOiBhLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uICYmIGEuY29tcGFyZURvY3VtZW50UG9zaXRpb24oYnVwKSAmIDE2KSk7CiAgICAgIH0gOiBmdW5jdGlvbiAoYSwgYikgewogICAgICAgIGlmIChiKSB7CiAgICAgICAgICB3aGlsZSAoYiA9IGIucGFyZW50Tm9kZSkgewogICAgICAgICAgICBpZiAoYiA9PT0gYSkgewogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfTsKICAgICAgLyogU29ydGluZwogICAgICAJLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSAqLwogICAgICAvLyBEb2N1bWVudCBvcmRlciBzb3J0aW5nCiAgICAgIHNvcnRPcmRlciA9IGhhc0NvbXBhcmUgPyBmdW5jdGlvbiAoYSwgYikgewogICAgICAgIC8vIEZsYWcgZm9yIGR1cGxpY2F0ZSByZW1vdmFsCiAgICAgICAgaWYgKGEgPT09IGIpIHsKICAgICAgICAgIGhhc0R1cGxpY2F0ZSA9IHRydWU7CiAgICAgICAgICByZXR1cm4gMDsKICAgICAgICB9CiAgICAgICAgLy8gU29ydCBvbiBtZXRob2QgZXhpc3RlbmNlIGlmIG9ubHkgb25lIGlucHV0IGhhcyBjb21wYXJlRG9jdW1lbnRQb3NpdGlvbgogICAgICAgIHZhciBjb21wYXJlID0gIWEuY29tcGFyZURvY3VtZW50UG9zaXRpb24gLSAhYi5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbjsKICAgICAgICBpZiAoY29tcGFyZSkgewogICAgICAgICAgcmV0dXJuIGNvbXBhcmU7CiAgICAgICAgfQogICAgICAgIC8vIENhbGN1bGF0ZSBwb3NpdGlvbiBpZiBib3RoIGlucHV0cyBiZWxvbmcgdG8gdGhlIHNhbWUgZG9jdW1lbnQKICAgICAgICBjb21wYXJlID0gKGEub3duZXJEb2N1bWVudCB8fCBhKSA9PT0gKGIub3duZXJEb2N1bWVudCB8fCBiKSA/IGEuY29tcGFyZURvY3VtZW50UG9zaXRpb24oYikgOiAvLyBPdGhlcndpc2Ugd2Uga25vdyB0aGV5IGFyZSBkaXNjb25uZWN0ZWQKICAgICAgICAxOwogICAgICAgIC8vIERpc2Nvbm5lY3RlZCBub2RlcwogICAgICAgIGlmIChjb21wYXJlICYgMSB8fCAhc3VwcG9ydC5zb3J0RGV0YWNoZWQgJiYgYi5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbihhKSA9PT0gY29tcGFyZSkgewogICAgICAgICAgLy8gQ2hvb3NlIHRoZSBmaXJzdCBlbGVtZW50IHRoYXQgaXMgcmVsYXRlZCB0byBvdXIgcHJlZmVycmVkIGRvY3VtZW50CiAgICAgICAgICBpZiAoYSA9PT0gZG9jIHx8IGEub3duZXJEb2N1bWVudCA9PT0gcHJlZmVycmVkRG9jICYmIGNvbnRhaW5zKHByZWZlcnJlZERvYywgYSkpIHsKICAgICAgICAgICAgcmV0dXJuIC0xOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGIgPT09IGRvYyB8fCBiLm93bmVyRG9jdW1lbnQgPT09IHByZWZlcnJlZERvYyAmJiBjb250YWlucyhwcmVmZXJyZWREb2MsIGIpKSB7CiAgICAgICAgICAgIHJldHVybiAxOwogICAgICAgICAgfQogICAgICAgICAgLy8gTWFpbnRhaW4gb3JpZ2luYWwgb3JkZXIKICAgICAgICAgIHJldHVybiBzb3J0SW5wdXQgPyBpbmRleE9mLmNhbGwoc29ydElucHV0LCBhKSAtIGluZGV4T2YuY2FsbChzb3J0SW5wdXQsIGIpIDogMDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGNvbXBhcmUgJiA0ID8gLTEgOiAxOwogICAgICB9IDogZnVuY3Rpb24gKGEsIGIpIHsKICAgICAgICAvLyBFeGl0IGVhcmx5IGlmIHRoZSBub2RlcyBhcmUgaWRlbnRpY2FsCiAgICAgICAgaWYgKGEgPT09IGIpIHsKICAgICAgICAgIGhhc0R1cGxpY2F0ZSA9IHRydWU7CiAgICAgICAgICByZXR1cm4gMDsKICAgICAgICB9CiAgICAgICAgdmFyIGN1ciwgaSA9IDAsIGF1cCA9IGEucGFyZW50Tm9kZSwgYnVwID0gYi5wYXJlbnROb2RlLCBhcCA9IFthXSwgYnAgPSBbYl07CiAgICAgICAgLy8gUGFyZW50bGVzcyBub2RlcyBhcmUgZWl0aGVyIGRvY3VtZW50cyBvciBkaXNjb25uZWN0ZWQKICAgICAgICBpZiAoIWF1cCB8fCAhYnVwKSB7CiAgICAgICAgICByZXR1cm4gYSA9PT0gZG9jID8gLTEgOiBiID09PSBkb2MgPyAxIDogYXVwID8gLTEgOiBidXAgPyAxIDogc29ydElucHV0ID8gaW5kZXhPZi5jYWxsKHNvcnRJbnB1dCwgYSkgLSBpbmRleE9mLmNhbGwoc29ydElucHV0LCBiKSA6IDA7ICAvLyBJZiB0aGUgbm9kZXMgYXJlIHNpYmxpbmdzLCB3ZSBjYW4gZG8gYSBxdWljayBjaGVjawogICAgICAgIH0gZWxzZSBpZiAoYXVwID09PSBidXApIHsKICAgICAgICAgIHJldHVybiBzaWJsaW5nQ2hlY2soYSwgYik7CiAgICAgICAgfQogICAgICAgIC8vIE90aGVyd2lzZSB3ZSBuZWVkIGZ1bGwgbGlzdHMgb2YgdGhlaXIgYW5jZXN0b3JzIGZvciBjb21wYXJpc29uCiAgICAgICAgY3VyID0gYTsKICAgICAgICB3aGlsZSAoY3VyID0gY3VyLnBhcmVudE5vZGUpIHsKICAgICAgICAgIGFwLnVuc2hpZnQoY3VyKTsKICAgICAgICB9CiAgICAgICAgY3VyID0gYjsKICAgICAgICB3aGlsZSAoY3VyID0gY3VyLnBhcmVudE5vZGUpIHsKICAgICAgICAgIGJwLnVuc2hpZnQoY3VyKTsKICAgICAgICB9CiAgICAgICAgLy8gV2FsayBkb3duIHRoZSB0cmVlIGxvb2tpbmcgZm9yIGEgZGlzY3JlcGFuY3kKICAgICAgICB3aGlsZSAoYXBbaV0gPT09IGJwW2ldKSB7CiAgICAgICAgICBpKys7CiAgICAgICAgfQogICAgICAgIHJldHVybiBpID8gLy8gRG8gYSBzaWJsaW5nIGNoZWNrIGlmIHRoZSBub2RlcyBoYXZlIGEgY29tbW9uIGFuY2VzdG9yCiAgICAgICAgc2libGluZ0NoZWNrKGFwW2ldLCBicFtpXSkgOiAvLyBPdGhlcndpc2Ugbm9kZXMgaW4gb3VyIGRvY3VtZW50IHNvcnQgZmlyc3QKICAgICAgICBhcFtpXSA9PT0gcHJlZmVycmVkRG9jID8gLTEgOiBicFtpXSA9PT0gcHJlZmVycmVkRG9jID8gMSA6IDA7CiAgICAgIH07CiAgICAgIHJldHVybiBkb2M7CiAgICB9OwogICAgU2l6emxlLm1hdGNoZXMgPSBmdW5jdGlvbiAoZXhwciwgZWxlbWVudHMpIHsKICAgICAgcmV0dXJuIFNpenpsZShleHByLCBudWxsLCBudWxsLCBlbGVtZW50cyk7CiAgICB9OwogICAgU2l6emxlLm1hdGNoZXNTZWxlY3RvciA9IGZ1bmN0aW9uIChlbGVtLCBleHByKSB7CiAgICAgIC8vIFNldCBkb2N1bWVudCB2YXJzIGlmIG5lZWRlZAogICAgICBpZiAoKGVsZW0ub3duZXJEb2N1bWVudCB8fCBlbGVtKSAhPT0gZG9jdW1lbnQpIHsKICAgICAgICBzZXREb2N1bWVudChlbGVtKTsKICAgICAgfQogICAgICAvLyBNYWtlIHN1cmUgdGhhdCBhdHRyaWJ1dGUgc2VsZWN0b3JzIGFyZSBxdW90ZWQKICAgICAgZXhwciA9IGV4cHIucmVwbGFjZShyYXR0cmlidXRlUXVvdGVzLCAnPVwnJDFcJ10nKTsKICAgICAgaWYgKHN1cHBvcnQubWF0Y2hlc1NlbGVjdG9yICYmIGRvY3VtZW50SXNIVE1MICYmICghcmJ1Z2d5TWF0Y2hlcyB8fCAhcmJ1Z2d5TWF0Y2hlcy50ZXN0KGV4cHIpKSAmJiAoIXJidWdneVFTQSB8fCAhcmJ1Z2d5UVNBLnRlc3QoZXhwcikpKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIHZhciByZXQgPSBtYXRjaGVzLmNhbGwoZWxlbSwgZXhwcik7CiAgICAgICAgICAvLyBJRSA5J3MgbWF0Y2hlc1NlbGVjdG9yIHJldHVybnMgZmFsc2Ugb24gZGlzY29ubmVjdGVkIG5vZGVzCiAgICAgICAgICBpZiAocmV0IHx8IHN1cHBvcnQuZGlzY29ubmVjdGVkTWF0Y2ggfHwgLy8gQXMgd2VsbCwgZGlzY29ubmVjdGVkIG5vZGVzIGFyZSBzYWlkIHRvIGJlIGluIGEgZG9jdW1lbnQKICAgICAgICAgICAgLy8gZnJhZ21lbnQgaW4gSUUgOQogICAgICAgICAgICBlbGVtLmRvY3VtZW50ICYmIGVsZW0uZG9jdW1lbnQubm9kZVR5cGUgIT09IDExKSB7CiAgICAgICAgICAgIHJldHVybiByZXQ7CiAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gU2l6emxlKGV4cHIsIGRvY3VtZW50LCBudWxsLCBbZWxlbV0pLmxlbmd0aCA+IDA7CiAgICB9OwogICAgU2l6emxlLmNvbnRhaW5zID0gZnVuY3Rpb24gKGNvbnRleHQsIGVsZW0pIHsKICAgICAgLy8gU2V0IGRvY3VtZW50IHZhcnMgaWYgbmVlZGVkCiAgICAgIGlmICgoY29udGV4dC5vd25lckRvY3VtZW50IHx8IGNvbnRleHQpICE9PSBkb2N1bWVudCkgewogICAgICAgIHNldERvY3VtZW50KGNvbnRleHQpOwogICAgICB9CiAgICAgIHJldHVybiBjb250YWlucyhjb250ZXh0LCBlbGVtKTsKICAgIH07CiAgICBTaXp6bGUuYXR0ciA9IGZ1bmN0aW9uIChlbGVtLCBuYW1lKSB7CiAgICAgIC8vIFNldCBkb2N1bWVudCB2YXJzIGlmIG5lZWRlZAogICAgICBpZiAoKGVsZW0ub3duZXJEb2N1bWVudCB8fCBlbGVtKSAhPT0gZG9jdW1lbnQpIHsKICAgICAgICBzZXREb2N1bWVudChlbGVtKTsKICAgICAgfQogICAgICB2YXIgZm4gPSBFeHByLmF0dHJIYW5kbGVbbmFtZS50b0xvd2VyQ2FzZSgpXSwKICAgICAgICAvLyBEb24ndCBnZXQgZm9vbGVkIGJ5IE9iamVjdC5wcm90b3R5cGUgcHJvcGVydGllcyAoalF1ZXJ5ICMxMzgwNykKICAgICAgICB2YWwgPSBmbiAmJiBoYXNPd24uY2FsbChFeHByLmF0dHJIYW5kbGUsIG5hbWUudG9Mb3dlckNhc2UoKSkgPyBmbihlbGVtLCBuYW1lLCAhZG9jdW1lbnRJc0hUTUwpIDogdW5kZWZpbmVkOwogICAgICByZXR1cm4gdmFsICE9PSB1bmRlZmluZWQgPyB2YWwgOiBzdXBwb3J0LmF0dHJpYnV0ZXMgfHwgIWRvY3VtZW50SXNIVE1MID8gZWxlbS5nZXRBdHRyaWJ1dGUobmFtZSkgOiAodmFsID0gZWxlbS5nZXRBdHRyaWJ1dGVOb2RlKG5hbWUpKSAmJiB2YWwuc3BlY2lmaWVkID8gdmFsLnZhbHVlIDogbnVsbDsKICAgIH07CiAgICBTaXp6bGUuZXJyb3IgPSBmdW5jdGlvbiAobXNnKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcignU3ludGF4IGVycm9yLCB1bnJlY29nbml6ZWQgZXhwcmVzc2lvbjogJyArIG1zZyk7CiAgICB9OwogICAgLyoqCiAgICAgKiBEb2N1bWVudCBzb3J0aW5nIGFuZCByZW1vdmluZyBkdXBsaWNhdGVzCiAgICAgKiBAcGFyYW0ge0FycmF5TGlrZX0gcmVzdWx0cwogICAgICovCiAgICBTaXp6bGUudW5pcXVlU29ydCA9IGZ1bmN0aW9uIChyZXN1bHRzKSB7CiAgICAgIHZhciBlbGVtLCBkdXBsaWNhdGVzID0gW10sIGogPSAwLCBpID0gMDsKICAgICAgLy8gVW5sZXNzIHdlICprbm93KiB3ZSBjYW4gZGV0ZWN0IGR1cGxpY2F0ZXMsIGFzc3VtZSB0aGVpciBwcmVzZW5jZQogICAgICBoYXNEdXBsaWNhdGUgPSAhc3VwcG9ydC5kZXRlY3REdXBsaWNhdGVzOwogICAgICBzb3J0SW5wdXQgPSAhc3VwcG9ydC5zb3J0U3RhYmxlICYmIHJlc3VsdHMuc2xpY2UoMCk7CiAgICAgIHJlc3VsdHMuc29ydChzb3J0T3JkZXIpOwogICAgICBpZiAoaGFzRHVwbGljYXRlKSB7CiAgICAgICAgd2hpbGUgKGVsZW0gPSByZXN1bHRzW2krK10pIHsKICAgICAgICAgIGlmIChlbGVtID09PSByZXN1bHRzW2ldKSB7CiAgICAgICAgICAgIGogPSBkdXBsaWNhdGVzLnB1c2goaSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHdoaWxlIChqLS0pIHsKICAgICAgICAgIHJlc3VsdHMuc3BsaWNlKGR1cGxpY2F0ZXNbal0sIDEpOwogICAgICAgIH0KICAgICAgfQogICAgICAvLyBDbGVhciBpbnB1dCBhZnRlciBzb3J0aW5nIHRvIHJlbGVhc2Ugb2JqZWN0cwogICAgICAvLyBTZWUgaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9zaXp6bGUvcHVsbC8yMjUKICAgICAgc29ydElucHV0ID0gbnVsbDsKICAgICAgcmV0dXJuIHJlc3VsdHM7CiAgICB9OwogICAgLyoqCiAgICAgKiBVdGlsaXR5IGZ1bmN0aW9uIGZvciByZXRyaWV2aW5nIHRoZSB0ZXh0IHZhbHVlIG9mIGFuIGFycmF5IG9mIERPTSBub2RlcwogICAgICogQHBhcmFtIHtBcnJheXxFbGVtZW50fSBlbGVtCiAgICAgKi8KICAgIGdldFRleHQgPSBTaXp6bGUuZ2V0VGV4dCA9IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgIHZhciBub2RlLCByZXQgPSAnJywgaSA9IDAsIG5vZGVUeXBlID0gZWxlbS5ub2RlVHlwZTsKICAgICAgaWYgKCFub2RlVHlwZSkgewogICAgICAgIC8vIElmIG5vIG5vZGVUeXBlLCB0aGlzIGlzIGV4cGVjdGVkIHRvIGJlIGFuIGFycmF5CiAgICAgICAgd2hpbGUgKG5vZGUgPSBlbGVtW2krK10pIHsKICAgICAgICAgIC8vIERvIG5vdCB0cmF2ZXJzZSBjb21tZW50IG5vZGVzCiAgICAgICAgICByZXQgKz0gZ2V0VGV4dChub2RlKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSBpZiAobm9kZVR5cGUgPT09IDEgfHwgbm9kZVR5cGUgPT09IDkgfHwgbm9kZVR5cGUgPT09IDExKSB7CiAgICAgICAgLy8gVXNlIHRleHRDb250ZW50IGZvciBlbGVtZW50cwogICAgICAgIC8vIGlubmVyVGV4dCB1c2FnZSByZW1vdmVkIGZvciBjb25zaXN0ZW5jeSBvZiBuZXcgbGluZXMgKGpRdWVyeSAjMTExNTMpCiAgICAgICAgaWYgKHR5cGVvZiBlbGVtLnRleHRDb250ZW50ID09PSAnc3RyaW5nJykgewogICAgICAgICAgcmV0dXJuIGVsZW0udGV4dENvbnRlbnQ7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIC8vIFRyYXZlcnNlIGl0cyBjaGlsZHJlbgogICAgICAgICAgZm9yIChlbGVtID0gZWxlbS5maXJzdENoaWxkOyBlbGVtOyBlbGVtID0gZWxlbS5uZXh0U2libGluZykgewogICAgICAgICAgICByZXQgKz0gZ2V0VGV4dChlbGVtKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0gZWxzZSBpZiAobm9kZVR5cGUgPT09IDMgfHwgbm9kZVR5cGUgPT09IDQpIHsKICAgICAgICByZXR1cm4gZWxlbS5ub2RlVmFsdWU7CiAgICAgIH0KICAgICAgLy8gRG8gbm90IGluY2x1ZGUgY29tbWVudCBvciBwcm9jZXNzaW5nIGluc3RydWN0aW9uIG5vZGVzCiAgICAgIHJldHVybiByZXQ7CiAgICB9OwogICAgRXhwciA9IFNpenpsZS5zZWxlY3RvcnMgPSB7CiAgICAgIC8vIENhbiBiZSBhZGp1c3RlZCBieSB0aGUgdXNlcgogICAgICBjYWNoZUxlbmd0aDogNTAsCiAgICAgIGNyZWF0ZVBzZXVkbzogbWFya0Z1bmN0aW9uLAogICAgICBtYXRjaDogbWF0Y2hFeHByLAogICAgICBhdHRySGFuZGxlOiB7fSwKICAgICAgZmluZDoge30sCiAgICAgIHJlbGF0aXZlOiB7CiAgICAgICAgJz4nOiB7CiAgICAgICAgICBkaXI6ICdwYXJlbnROb2RlJywKICAgICAgICAgIGZpcnN0OiB0cnVlCiAgICAgICAgfSwKICAgICAgICAnICc6IHsgZGlyOiAncGFyZW50Tm9kZScgfSwKICAgICAgICAnKyc6IHsKICAgICAgICAgIGRpcjogJ3ByZXZpb3VzU2libGluZycsCiAgICAgICAgICBmaXJzdDogdHJ1ZQogICAgICAgIH0sCiAgICAgICAgJ34nOiB7IGRpcjogJ3ByZXZpb3VzU2libGluZycgfQogICAgICB9LAogICAgICBwcmVGaWx0ZXI6IHsKICAgICAgICAnQVRUUic6IGZ1bmN0aW9uIChtYXRjaCkgewogICAgICAgICAgbWF0Y2hbMV0gPSBtYXRjaFsxXS5yZXBsYWNlKHJ1bmVzY2FwZSwgZnVuZXNjYXBlKTsKICAgICAgICAgIC8vIE1vdmUgdGhlIGdpdmVuIHZhbHVlIHRvIG1hdGNoWzNdIHdoZXRoZXIgcXVvdGVkIG9yIHVucXVvdGVkCiAgICAgICAgICBtYXRjaFszXSA9IChtYXRjaFszXSB8fCBtYXRjaFs0XSB8fCBtYXRjaFs1XSB8fCAnJykucmVwbGFjZShydW5lc2NhcGUsIGZ1bmVzY2FwZSk7CiAgICAgICAgICBpZiAobWF0Y2hbMl0gPT09ICd+PScpIHsKICAgICAgICAgICAgbWF0Y2hbM10gPSAnICcgKyBtYXRjaFszXSArICcgJzsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBtYXRjaC5zbGljZSgwLCA0KTsKICAgICAgICB9LAogICAgICAgICdDSElMRCc6IGZ1bmN0aW9uIChtYXRjaCkgewogICAgICAgICAgLyogbWF0Y2hlcyBmcm9tIG1hdGNoRXhwclsiQ0hJTEQiXQogICAgICAgICAgCQkxIHR5cGUgKG9ubHl8bnRofC4uLikKICAgICAgICAgIAkJMiB3aGF0IChjaGlsZHxvZi10eXBlKQogICAgICAgICAgCQkzIGFyZ3VtZW50IChldmVufG9kZHxcZCp8XGQqbihbKy1dXGQrKT98Li4uKQogICAgICAgICAgCQk0IHhuLWNvbXBvbmVudCBvZiB4bit5IGFyZ3VtZW50IChbKy1dP1xkKm58KQogICAgICAgICAgCQk1IHNpZ24gb2YgeG4tY29tcG9uZW50CiAgICAgICAgICAJCTYgeCBvZiB4bi1jb21wb25lbnQKICAgICAgICAgIAkJNyBzaWduIG9mIHktY29tcG9uZW50CiAgICAgICAgICAJCTggeSBvZiB5LWNvbXBvbmVudAogICAgICAgICAgCSovCiAgICAgICAgICBtYXRjaFsxXSA9IG1hdGNoWzFdLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICBpZiAobWF0Y2hbMV0uc2xpY2UoMCwgMykgPT09ICdudGgnKSB7CiAgICAgICAgICAgIC8vIG50aC0qIHJlcXVpcmVzIGFyZ3VtZW50CiAgICAgICAgICAgIGlmICghbWF0Y2hbM10pIHsKICAgICAgICAgICAgICBTaXp6bGUuZXJyb3IobWF0Y2hbMF0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIG51bWVyaWMgeCBhbmQgeSBwYXJhbWV0ZXJzIGZvciBFeHByLmZpbHRlci5DSElMRAogICAgICAgICAgICAvLyByZW1lbWJlciB0aGF0IGZhbHNlL3RydWUgY2FzdCByZXNwZWN0aXZlbHkgdG8gMC8xCiAgICAgICAgICAgIG1hdGNoWzRdID0gKyhtYXRjaFs0XSA/IG1hdGNoWzVdICsgKG1hdGNoWzZdIHx8IDEpIDogMiAqIChtYXRjaFszXSA9PT0gJ2V2ZW4nIHx8IG1hdGNoWzNdID09PSAnb2RkJykpOwogICAgICAgICAgICBtYXRjaFs1XSA9ICsobWF0Y2hbN10gKyBtYXRjaFs4XSB8fCBtYXRjaFszXSA9PT0gJ29kZCcpOyAgLy8gb3RoZXIgdHlwZXMgcHJvaGliaXQgYXJndW1lbnRzCiAgICAgICAgICB9IGVsc2UgaWYgKG1hdGNoWzNdKSB7CiAgICAgICAgICAgIFNpenpsZS5lcnJvcihtYXRjaFswXSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbWF0Y2g7CiAgICAgICAgfSwKICAgICAgICAnUFNFVURPJzogZnVuY3Rpb24gKG1hdGNoKSB7CiAgICAgICAgICB2YXIgZXhjZXNzLCB1bnF1b3RlZCA9ICFtYXRjaFs2XSAmJiBtYXRjaFsyXTsKICAgICAgICAgIGlmIChtYXRjaEV4cHJbJ0NISUxEJ10udGVzdChtYXRjaFswXSkpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICAvLyBBY2NlcHQgcXVvdGVkIGFyZ3VtZW50cyBhcy1pcwogICAgICAgICAgaWYgKG1hdGNoWzNdKSB7CiAgICAgICAgICAgIG1hdGNoWzJdID0gbWF0Y2hbNF0gfHwgbWF0Y2hbNV0gfHwgJyc7ICAvLyBTdHJpcCBleGNlc3MgY2hhcmFjdGVycyBmcm9tIHVucXVvdGVkIGFyZ3VtZW50cwogICAgICAgICAgfSBlbHNlIGlmICh1bnF1b3RlZCAmJiBycHNldWRvLnRlc3QodW5xdW90ZWQpICYmIChleGNlc3MgPSB0b2tlbml6ZSh1bnF1b3RlZCwgdHJ1ZSkpICYmIChleGNlc3MgPSB1bnF1b3RlZC5pbmRleE9mKCcpJywgdW5xdW90ZWQubGVuZ3RoIC0gZXhjZXNzKSAtIHVucXVvdGVkLmxlbmd0aCkpIHsKICAgICAgICAgICAgLy8gZXhjZXNzIGlzIGEgbmVnYXRpdmUgaW5kZXgKICAgICAgICAgICAgbWF0Y2hbMF0gPSBtYXRjaFswXS5zbGljZSgwLCBleGNlc3MpOwogICAgICAgICAgICBtYXRjaFsyXSA9IHVucXVvdGVkLnNsaWNlKDAsIGV4Y2Vzcyk7CiAgICAgICAgICB9CiAgICAgICAgICAvLyBSZXR1cm4gb25seSBjYXB0dXJlcyBuZWVkZWQgYnkgdGhlIHBzZXVkbyBmaWx0ZXIgbWV0aG9kICh0eXBlIGFuZCBhcmd1bWVudCkKICAgICAgICAgIHJldHVybiBtYXRjaC5zbGljZSgwLCAzKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIGZpbHRlcjogewogICAgICAgICdUQUcnOiBmdW5jdGlvbiAobm9kZU5hbWVTZWxlY3RvcikgewogICAgICAgICAgdmFyIG5vZGVOYW1lID0gbm9kZU5hbWVTZWxlY3Rvci5yZXBsYWNlKHJ1bmVzY2FwZSwgZnVuZXNjYXBlKS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgcmV0dXJuIG5vZGVOYW1lU2VsZWN0b3IgPT09ICcqJyA/IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9IDogZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICAgICAgcmV0dXJuIGVsZW0ubm9kZU5hbWUgJiYgZWxlbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpID09PSBub2RlTmFtZTsKICAgICAgICAgIH07CiAgICAgICAgfSwKICAgICAgICAnQ0xBU1MnOiBmdW5jdGlvbiAoY2xhc3NOYW1lKSB7CiAgICAgICAgICB2YXIgcGF0dGVybiA9IGNsYXNzQ2FjaGVbY2xhc3NOYW1lICsgJyAnXTsKICAgICAgICAgIHJldHVybiBwYXR0ZXJuIHx8IChwYXR0ZXJuID0gbmV3IFJlZ0V4cCgnKF58JyArIHdoaXRlc3BhY2UgKyAnKScgKyBjbGFzc05hbWUgKyAnKCcgKyB3aGl0ZXNwYWNlICsgJ3wkKScpKSAmJiBjbGFzc0NhY2hlKGNsYXNzTmFtZSwgZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICAgICAgcmV0dXJuIHBhdHRlcm4udGVzdCh0eXBlb2YgZWxlbS5jbGFzc05hbWUgPT09ICdzdHJpbmcnICYmIGVsZW0uY2xhc3NOYW1lIHx8IHR5cGVvZiBlbGVtLmdldEF0dHJpYnV0ZSAhPT0gc3RydW5kZWZpbmVkICYmIGVsZW0uZ2V0QXR0cmlidXRlKCdjbGFzcycpIHx8ICcnKTsKICAgICAgICAgIH0pOwogICAgICAgIH0sCiAgICAgICAgJ0FUVFInOiBmdW5jdGlvbiAobmFtZSwgb3BlcmF0b3IsIGNoZWNrKSB7CiAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICAgICAgdmFyIHJlc3VsdCA9IFNpenpsZS5hdHRyKGVsZW0sIG5hbWUpOwogICAgICAgICAgICBpZiAocmVzdWx0ID09IG51bGwpIHsKICAgICAgICAgICAgICByZXR1cm4gb3BlcmF0b3IgPT09ICchPSc7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCFvcGVyYXRvcikgewogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJlc3VsdCArPSAnJzsKICAgICAgICAgICAgcmV0dXJuIG9wZXJhdG9yID09PSAnPScgPyByZXN1bHQgPT09IGNoZWNrIDogb3BlcmF0b3IgPT09ICchPScgPyByZXN1bHQgIT09IGNoZWNrIDogb3BlcmF0b3IgPT09ICdePScgPyBjaGVjayAmJiByZXN1bHQuaW5kZXhPZihjaGVjaykgPT09IDAgOiBvcGVyYXRvciA9PT0gJyo9JyA/IGNoZWNrICYmIHJlc3VsdC5pbmRleE9mKGNoZWNrKSA+IC0xIDogb3BlcmF0b3IgPT09ICckPScgPyBjaGVjayAmJiByZXN1bHQuc2xpY2UoLWNoZWNrLmxlbmd0aCkgPT09IGNoZWNrIDogb3BlcmF0b3IgPT09ICd+PScgPyAoJyAnICsgcmVzdWx0ICsgJyAnKS5pbmRleE9mKGNoZWNrKSA+IC0xIDogb3BlcmF0b3IgPT09ICd8PScgPyByZXN1bHQgPT09IGNoZWNrIHx8IHJlc3VsdC5zbGljZSgwLCBjaGVjay5sZW5ndGggKyAxKSA9PT0gY2hlY2sgKyAnLScgOiBmYWxzZTsKICAgICAgICAgIH07CiAgICAgICAgfSwKICAgICAgICAnQ0hJTEQnOiBmdW5jdGlvbiAodHlwZSwgd2hhdCwgYXJndW1lbnQsIGZpcnN0LCBsYXN0KSB7CiAgICAgICAgICB2YXIgc2ltcGxlID0gdHlwZS5zbGljZSgwLCAzKSAhPT0gJ250aCcsIGZvcndhcmQgPSB0eXBlLnNsaWNlKC00KSAhPT0gJ2xhc3QnLCBvZlR5cGUgPSB3aGF0ID09PSAnb2YtdHlwZSc7CiAgICAgICAgICByZXR1cm4gZmlyc3QgPT09IDEgJiYgbGFzdCA9PT0gMCA/IC8vIFNob3J0Y3V0IGZvciA6bnRoLSoobikKICAgICAgICAgIGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgICAgIHJldHVybiAhIWVsZW0ucGFyZW50Tm9kZTsKICAgICAgICAgIH0gOiBmdW5jdGlvbiAoZWxlbSwgY29udGV4dCwgeG1sKSB7CiAgICAgICAgICAgIHZhciBjYWNoZSwgb3V0ZXJDYWNoZSwgbm9kZSwgZGlmZiwgbm9kZUluZGV4LCBzdGFydCwgZGlyID0gc2ltcGxlICE9PSBmb3J3YXJkID8gJ25leHRTaWJsaW5nJyA6ICdwcmV2aW91c1NpYmxpbmcnLCBwYXJlbnQgPSBlbGVtLnBhcmVudE5vZGUsIG5hbWUgPSBvZlR5cGUgJiYgZWxlbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpLCB1c2VDYWNoZSA9ICF4bWwgJiYgIW9mVHlwZTsKICAgICAgICAgICAgaWYgKHBhcmVudCkgewogICAgICAgICAgICAgIC8vIDooZmlyc3R8bGFzdHxvbmx5KS0oY2hpbGR8b2YtdHlwZSkKICAgICAgICAgICAgICBpZiAoc2ltcGxlKSB7CiAgICAgICAgICAgICAgICB3aGlsZSAoZGlyKSB7CiAgICAgICAgICAgICAgICAgIG5vZGUgPSBlbGVtOwogICAgICAgICAgICAgICAgICB3aGlsZSAobm9kZSA9IG5vZGVbZGlyXSkgewogICAgICAgICAgICAgICAgICAgIGlmIChvZlR5cGUgPyBub2RlLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09IG5hbWUgOiBub2RlLm5vZGVUeXBlID09PSAxKSB7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIC8vIFJldmVyc2UgZGlyZWN0aW9uIGZvciA6b25seS0qIChpZiB3ZSBoYXZlbid0IHlldCBkb25lIHNvKQogICAgICAgICAgICAgICAgICBzdGFydCA9IGRpciA9IHR5cGUgPT09ICdvbmx5JyAmJiAhc3RhcnQgJiYgJ25leHRTaWJsaW5nJzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBzdGFydCA9IFtmb3J3YXJkID8gcGFyZW50LmZpcnN0Q2hpbGQgOiBwYXJlbnQubGFzdENoaWxkXTsKICAgICAgICAgICAgICAvLyBub24teG1sIDpudGgtY2hpbGQoLi4uKSBzdG9yZXMgY2FjaGUgZGF0YSBvbiBgcGFyZW50YAogICAgICAgICAgICAgIGlmIChmb3J3YXJkICYmIHVzZUNhY2hlKSB7CiAgICAgICAgICAgICAgICAvLyBTZWVrIGBlbGVtYCBmcm9tIGEgcHJldmlvdXNseS1jYWNoZWQgaW5kZXgKICAgICAgICAgICAgICAgIG91dGVyQ2FjaGUgPSBwYXJlbnRbZXhwYW5kb10gfHwgKHBhcmVudFtleHBhbmRvXSA9IHt9KTsKICAgICAgICAgICAgICAgIGNhY2hlID0gb3V0ZXJDYWNoZVt0eXBlXSB8fCBbXTsKICAgICAgICAgICAgICAgIG5vZGVJbmRleCA9IGNhY2hlWzBdID09PSBkaXJydW5zICYmIGNhY2hlWzFdOwogICAgICAgICAgICAgICAgZGlmZiA9IGNhY2hlWzBdID09PSBkaXJydW5zICYmIGNhY2hlWzJdOwogICAgICAgICAgICAgICAgbm9kZSA9IG5vZGVJbmRleCAmJiBwYXJlbnQuY2hpbGROb2Rlc1tub2RlSW5kZXhdOwogICAgICAgICAgICAgICAgd2hpbGUgKG5vZGUgPSArK25vZGVJbmRleCAmJiBub2RlICYmIG5vZGVbZGlyXSB8fCAoZGlmZiA9IG5vZGVJbmRleCA9IDApIHx8IHN0YXJ0LnBvcCgpKSB7CiAgICAgICAgICAgICAgICAgIC8vIFdoZW4gZm91bmQsIGNhY2hlIGluZGV4ZXMgb24gYHBhcmVudGAgYW5kIGJyZWFrCiAgICAgICAgICAgICAgICAgIGlmIChub2RlLm5vZGVUeXBlID09PSAxICYmICsrZGlmZiAmJiBub2RlID09PSBlbGVtKSB7CiAgICAgICAgICAgICAgICAgICAgb3V0ZXJDYWNoZVt0eXBlXSA9IFsKICAgICAgICAgICAgICAgICAgICAgIGRpcnJ1bnMsCiAgICAgICAgICAgICAgICAgICAgICBub2RlSW5kZXgsCiAgICAgICAgICAgICAgICAgICAgICBkaWZmCiAgICAgICAgICAgICAgICAgICAgXTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSAgLy8gVXNlIHByZXZpb3VzbHktY2FjaGVkIGVsZW1lbnQgaW5kZXggaWYgYXZhaWxhYmxlCiAgICAgICAgICAgICAgfSBlbHNlIGlmICh1c2VDYWNoZSAmJiAoY2FjaGUgPSAoZWxlbVtleHBhbmRvXSB8fCAoZWxlbVtleHBhbmRvXSA9IHt9KSlbdHlwZV0pICYmIGNhY2hlWzBdID09PSBkaXJydW5zKSB7CiAgICAgICAgICAgICAgICBkaWZmID0gY2FjaGVbMV07ICAvLyB4bWwgOm50aC1jaGlsZCguLi4pIG9yIDpudGgtbGFzdC1jaGlsZCguLi4pIG9yIDpudGgoLWxhc3QpPy1vZi10eXBlKC4uLikKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gVXNlIHRoZSBzYW1lIGxvb3AgYXMgYWJvdmUgdG8gc2VlayBgZWxlbWAgZnJvbSB0aGUgc3RhcnQKICAgICAgICAgICAgICAgIHdoaWxlIChub2RlID0gKytub2RlSW5kZXggJiYgbm9kZSAmJiBub2RlW2Rpcl0gfHwgKGRpZmYgPSBub2RlSW5kZXggPSAwKSB8fCBzdGFydC5wb3AoKSkgewogICAgICAgICAgICAgICAgICBpZiAoKG9mVHlwZSA/IG5vZGUubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gbmFtZSA6IG5vZGUubm9kZVR5cGUgPT09IDEpICYmICsrZGlmZikgewogICAgICAgICAgICAgICAgICAgIC8vIENhY2hlIHRoZSBpbmRleCBvZiBlYWNoIGVuY291bnRlcmVkIGVsZW1lbnQKICAgICAgICAgICAgICAgICAgICBpZiAodXNlQ2FjaGUpIHsKICAgICAgICAgICAgICAgICAgICAgIChub2RlW2V4cGFuZG9dIHx8IChub2RlW2V4cGFuZG9dID0ge30pKVt0eXBlXSA9IFsKICAgICAgICAgICAgICAgICAgICAgICAgZGlycnVucywKICAgICAgICAgICAgICAgICAgICAgICAgZGlmZgogICAgICAgICAgICAgICAgICAgICAgXTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKG5vZGUgPT09IGVsZW0pIHsKICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAvLyBJbmNvcnBvcmF0ZSB0aGUgb2Zmc2V0LCB0aGVuIGNoZWNrIGFnYWluc3QgY3ljbGUgc2l6ZQogICAgICAgICAgICAgIGRpZmYgLT0gbGFzdDsKICAgICAgICAgICAgICByZXR1cm4gZGlmZiA9PT0gZmlyc3QgfHwgZGlmZiAlIGZpcnN0ID09PSAwICYmIGRpZmYgLyBmaXJzdCA+PSAwOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgIH0sCiAgICAgICAgJ1BTRVVETyc6IGZ1bmN0aW9uIChwc2V1ZG8sIGFyZ3VtZW50KSB7CiAgICAgICAgICAvLyBwc2V1ZG8tY2xhc3MgbmFtZXMgYXJlIGNhc2UtaW5zZW5zaXRpdmUKICAgICAgICAgIC8vIGh0dHA6Ly93d3cudzMub3JnL1RSL3NlbGVjdG9ycy8jcHNldWRvLWNsYXNzZXMKICAgICAgICAgIC8vIFByaW9yaXRpemUgYnkgY2FzZSBzZW5zaXRpdml0eSBpbiBjYXNlIGN1c3RvbSBwc2V1ZG9zIGFyZSBhZGRlZCB3aXRoIHVwcGVyY2FzZSBsZXR0ZXJzCiAgICAgICAgICAvLyBSZW1lbWJlciB0aGF0IHNldEZpbHRlcnMgaW5oZXJpdHMgZnJvbSBwc2V1ZG9zCiAgICAgICAgICB2YXIgYXJncywgZm4gPSBFeHByLnBzZXVkb3NbcHNldWRvXSB8fCBFeHByLnNldEZpbHRlcnNbcHNldWRvLnRvTG93ZXJDYXNlKCldIHx8IFNpenpsZS5lcnJvcigndW5zdXBwb3J0ZWQgcHNldWRvOiAnICsgcHNldWRvKTsKICAgICAgICAgIC8vIFRoZSB1c2VyIG1heSB1c2UgY3JlYXRlUHNldWRvIHRvIGluZGljYXRlIHRoYXQKICAgICAgICAgIC8vIGFyZ3VtZW50cyBhcmUgbmVlZGVkIHRvIGNyZWF0ZSB0aGUgZmlsdGVyIGZ1bmN0aW9uCiAgICAgICAgICAvLyBqdXN0IGFzIFNpenpsZSBkb2VzCiAgICAgICAgICBpZiAoZm5bZXhwYW5kb10pIHsKICAgICAgICAgICAgcmV0dXJuIGZuKGFyZ3VtZW50KTsKICAgICAgICAgIH0KICAgICAgICAgIC8vIEJ1dCBtYWludGFpbiBzdXBwb3J0IGZvciBvbGQgc2lnbmF0dXJlcwogICAgICAgICAgaWYgKGZuLmxlbmd0aCA+IDEpIHsKICAgICAgICAgICAgYXJncyA9IFsKICAgICAgICAgICAgICBwc2V1ZG8sCiAgICAgICAgICAgICAgcHNldWRvLAogICAgICAgICAgICAgICcnLAogICAgICAgICAgICAgIGFyZ3VtZW50CiAgICAgICAgICAgIF07CiAgICAgICAgICAgIHJldHVybiBFeHByLnNldEZpbHRlcnMuaGFzT3duUHJvcGVydHkocHNldWRvLnRvTG93ZXJDYXNlKCkpID8gbWFya0Z1bmN0aW9uKGZ1bmN0aW9uIChzZWVkLCBtYXRjaGVzKSB7CiAgICAgICAgICAgICAgdmFyIGlkeCwgbWF0Y2hlZCA9IGZuKHNlZWQsIGFyZ3VtZW50KSwgaSA9IG1hdGNoZWQubGVuZ3RoOwogICAgICAgICAgICAgIHdoaWxlIChpLS0pIHsKICAgICAgICAgICAgICAgIGlkeCA9IGluZGV4T2YuY2FsbChzZWVkLCBtYXRjaGVkW2ldKTsKICAgICAgICAgICAgICAgIHNlZWRbaWR4XSA9ICEobWF0Y2hlc1tpZHhdID0gbWF0Y2hlZFtpXSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KSA6IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZuKGVsZW0sIDAsIGFyZ3MpOwogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGZuOwogICAgICAgIH0KICAgICAgfSwKICAgICAgcHNldWRvczogewogICAgICAgIC8vIFBvdGVudGlhbGx5IGNvbXBsZXggcHNldWRvcwogICAgICAgICdub3QnOiBtYXJrRnVuY3Rpb24oZnVuY3Rpb24gKHNlbGVjdG9yKSB7CiAgICAgICAgICAvLyBUcmltIHRoZSBzZWxlY3RvciBwYXNzZWQgdG8gY29tcGlsZQogICAgICAgICAgLy8gdG8gYXZvaWQgdHJlYXRpbmcgbGVhZGluZyBhbmQgdHJhaWxpbmcKICAgICAgICAgIC8vIHNwYWNlcyBhcyBjb21iaW5hdG9ycwogICAgICAgICAgdmFyIGlucHV0ID0gW10sIHJlc3VsdHMgPSBbXSwgbWF0Y2hlciA9IGNvbXBpbGUoc2VsZWN0b3IucmVwbGFjZShydHJpbSwgJyQxJykpOwogICAgICAgICAgcmV0dXJuIG1hdGNoZXJbZXhwYW5kb10gPyBtYXJrRnVuY3Rpb24oZnVuY3Rpb24gKHNlZWQsIG1hdGNoZXMsIGNvbnRleHQsIHhtbCkgewogICAgICAgICAgICB2YXIgZWxlbSwgdW5tYXRjaGVkID0gbWF0Y2hlcihzZWVkLCBudWxsLCB4bWwsIFtdKSwgaSA9IHNlZWQubGVuZ3RoOwogICAgICAgICAgICAvLyBNYXRjaCBlbGVtZW50cyB1bm1hdGNoZWQgYnkgYG1hdGNoZXJgCiAgICAgICAgICAgIHdoaWxlIChpLS0pIHsKICAgICAgICAgICAgICBpZiAoZWxlbSA9IHVubWF0Y2hlZFtpXSkgewogICAgICAgICAgICAgICAgc2VlZFtpXSA9ICEobWF0Y2hlc1tpXSA9IGVsZW0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSkgOiBmdW5jdGlvbiAoZWxlbSwgY29udGV4dCwgeG1sKSB7CiAgICAgICAgICAgIGlucHV0WzBdID0gZWxlbTsKICAgICAgICAgICAgbWF0Y2hlcihpbnB1dCwgbnVsbCwgeG1sLCByZXN1bHRzKTsKICAgICAgICAgICAgcmV0dXJuICFyZXN1bHRzLnBvcCgpOwogICAgICAgICAgfTsKICAgICAgICB9KSwKICAgICAgICAnaGFzJzogbWFya0Z1bmN0aW9uKGZ1bmN0aW9uIChzZWxlY3RvcikgewogICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgICAgIHJldHVybiBTaXp6bGUoc2VsZWN0b3IsIGVsZW0pLmxlbmd0aCA+IDA7CiAgICAgICAgICB9OwogICAgICAgIH0pLAogICAgICAgICdjb250YWlucyc6IG1hcmtGdW5jdGlvbihmdW5jdGlvbiAodGV4dCkgewogICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgICAgIHJldHVybiAoZWxlbS50ZXh0Q29udGVudCB8fCBlbGVtLmlubmVyVGV4dCB8fCBnZXRUZXh0KGVsZW0pKS5pbmRleE9mKHRleHQpID4gLTE7CiAgICAgICAgICB9OwogICAgICAgIH0pLAogICAgICAgIC8vICJXaGV0aGVyIGFuIGVsZW1lbnQgaXMgcmVwcmVzZW50ZWQgYnkgYSA6bGFuZygpIHNlbGVjdG9yCiAgICAgICAgLy8gaXMgYmFzZWQgc29sZWx5IG9uIHRoZSBlbGVtZW50J3MgbGFuZ3VhZ2UgdmFsdWUKICAgICAgICAvLyBiZWluZyBlcXVhbCB0byB0aGUgaWRlbnRpZmllciBDLAogICAgICAgIC8vIG9yIGJlZ2lubmluZyB3aXRoIHRoZSBpZGVudGlmaWVyIEMgaW1tZWRpYXRlbHkgZm9sbG93ZWQgYnkgIi0iLgogICAgICAgIC8vIFRoZSBtYXRjaGluZyBvZiBDIGFnYWluc3QgdGhlIGVsZW1lbnQncyBsYW5ndWFnZSB2YWx1ZSBpcyBwZXJmb3JtZWQgY2FzZS1pbnNlbnNpdGl2ZWx5LgogICAgICAgIC8vIFRoZSBpZGVudGlmaWVyIEMgZG9lcyBub3QgaGF2ZSB0byBiZSBhIHZhbGlkIGxhbmd1YWdlIG5hbWUuIgogICAgICAgIC8vIGh0dHA6Ly93d3cudzMub3JnL1RSL3NlbGVjdG9ycy8jbGFuZy1wc2V1ZG8KICAgICAgICAnbGFuZyc6IG1hcmtGdW5jdGlvbihmdW5jdGlvbiAobGFuZykgewogICAgICAgICAgLy8gbGFuZyB2YWx1ZSBtdXN0IGJlIGEgdmFsaWQgaWRlbnRpZmllcgogICAgICAgICAgaWYgKCFyaWRlbnRpZmllci50ZXN0KGxhbmcgfHwgJycpKSB7CiAgICAgICAgICAgIFNpenpsZS5lcnJvcigndW5zdXBwb3J0ZWQgbGFuZzogJyArIGxhbmcpOwogICAgICAgICAgfQogICAgICAgICAgbGFuZyA9IGxhbmcucmVwbGFjZShydW5lc2NhcGUsIGZ1bmVzY2FwZSkudG9Mb3dlckNhc2UoKTsKICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgICB2YXIgZWxlbUxhbmc7CiAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICBpZiAoZWxlbUxhbmcgPSBkb2N1bWVudElzSFRNTCA/IGVsZW0ubGFuZyA6IGVsZW0uZ2V0QXR0cmlidXRlKCd4bWw6bGFuZycpIHx8IGVsZW0uZ2V0QXR0cmlidXRlKCdsYW5nJykpIHsKICAgICAgICAgICAgICAgIGVsZW1MYW5nID0gZWxlbUxhbmcudG9Mb3dlckNhc2UoKTsKICAgICAgICAgICAgICAgIHJldHVybiBlbGVtTGFuZyA9PT0gbGFuZyB8fCBlbGVtTGFuZy5pbmRleE9mKGxhbmcgKyAnLScpID09PSAwOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSB3aGlsZSAoKGVsZW0gPSBlbGVtLnBhcmVudE5vZGUpICYmIGVsZW0ubm9kZVR5cGUgPT09IDEpOwogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9OwogICAgICAgIH0pLAogICAgICAgIC8vIE1pc2NlbGxhbmVvdXMKICAgICAgICAndGFyZ2V0JzogZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICAgIHZhciBoYXNoID0gd2luZG93LmxvY2F0aW9uICYmIHdpbmRvdy5sb2NhdGlvbi5oYXNoOwogICAgICAgICAgcmV0dXJuIGhhc2ggJiYgaGFzaC5zbGljZSgxKSA9PT0gZWxlbS5pZDsKICAgICAgICB9LAogICAgICAgICdyb290JzogZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICAgIHJldHVybiBlbGVtID09PSBkb2NFbGVtOwogICAgICAgIH0sCiAgICAgICAgJ2ZvY3VzJzogZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICAgIHJldHVybiBlbGVtID09PSBkb2N1bWVudC5hY3RpdmVFbGVtZW50ICYmICghZG9jdW1lbnQuaGFzRm9jdXMgfHwgZG9jdW1lbnQuaGFzRm9jdXMoKSkgJiYgISEoZWxlbS50eXBlIHx8IGVsZW0uaHJlZiB8fCB+ZWxlbS50YWJJbmRleCk7CiAgICAgICAgfSwKICAgICAgICAvLyBCb29sZWFuIHByb3BlcnRpZXMKICAgICAgICAnZW5hYmxlZCc6IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgICByZXR1cm4gZWxlbS5kaXNhYmxlZCA9PT0gZmFsc2U7CiAgICAgICAgfSwKICAgICAgICAnZGlzYWJsZWQnOiBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgcmV0dXJuIGVsZW0uZGlzYWJsZWQgPT09IHRydWU7CiAgICAgICAgfSwKICAgICAgICAnY2hlY2tlZCc6IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgICAvLyBJbiBDU1MzLCA6Y2hlY2tlZCBzaG91bGQgcmV0dXJuIGJvdGggY2hlY2tlZCBhbmQgc2VsZWN0ZWQgZWxlbWVudHMKICAgICAgICAgIC8vIGh0dHA6Ly93d3cudzMub3JnL1RSLzIwMTEvUkVDLWNzczMtc2VsZWN0b3JzLTIwMTEwOTI5LyNjaGVja2VkCiAgICAgICAgICB2YXIgbm9kZU5hbWUgPSBlbGVtLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICByZXR1cm4gbm9kZU5hbWUgPT09ICdpbnB1dCcgJiYgISFlbGVtLmNoZWNrZWQgfHwgbm9kZU5hbWUgPT09ICdvcHRpb24nICYmICEhZWxlbS5zZWxlY3RlZDsKICAgICAgICB9LAogICAgICAgICdzZWxlY3RlZCc6IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgICAvLyBBY2Nlc3NpbmcgdGhpcyBwcm9wZXJ0eSBtYWtlcyBzZWxlY3RlZC1ieS1kZWZhdWx0CiAgICAgICAgICAvLyBvcHRpb25zIGluIFNhZmFyaSB3b3JrIHByb3Blcmx5CiAgICAgICAgICBpZiAoZWxlbS5wYXJlbnROb2RlKSB7CiAgICAgICAgICAgIGVsZW0ucGFyZW50Tm9kZS5zZWxlY3RlZEluZGV4OwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGVsZW0uc2VsZWN0ZWQgPT09IHRydWU7CiAgICAgICAgfSwKICAgICAgICAvLyBDb250ZW50cwogICAgICAgICdlbXB0eSc6IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgICAvLyBodHRwOi8vd3d3LnczLm9yZy9UUi9zZWxlY3RvcnMvI2VtcHR5LXBzZXVkbwogICAgICAgICAgLy8gOmVtcHR5IGlzIG5lZ2F0ZWQgYnkgZWxlbWVudCAoMSkgb3IgY29udGVudCBub2RlcyAodGV4dDogMzsgY2RhdGE6IDQ7IGVudGl0eSByZWY6IDUpLAogICAgICAgICAgLy8gICBidXQgbm90IGJ5IG90aGVycyAoY29tbWVudDogODsgcHJvY2Vzc2luZyBpbnN0cnVjdGlvbjogNzsgZXRjLikKICAgICAgICAgIC8vIG5vZGVUeXBlIDwgNiB3b3JrcyBiZWNhdXNlIGF0dHJpYnV0ZXMgKDIpIGRvIG5vdCBhcHBlYXIgYXMgY2hpbGRyZW4KICAgICAgICAgIGZvciAoZWxlbSA9IGVsZW0uZmlyc3RDaGlsZDsgZWxlbTsgZWxlbSA9IGVsZW0ubmV4dFNpYmxpbmcpIHsKICAgICAgICAgICAgaWYgKGVsZW0ubm9kZVR5cGUgPCA2KSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9LAogICAgICAgICdwYXJlbnQnOiBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgcmV0dXJuICFFeHByLnBzZXVkb3NbJ2VtcHR5J10oZWxlbSk7CiAgICAgICAgfSwKICAgICAgICAvLyBFbGVtZW50L2lucHV0IHR5cGVzCiAgICAgICAgJ2hlYWRlcic6IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgICByZXR1cm4gcmhlYWRlci50ZXN0KGVsZW0ubm9kZU5hbWUpOwogICAgICAgIH0sCiAgICAgICAgJ2lucHV0JzogZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICAgIHJldHVybiByaW5wdXRzLnRlc3QoZWxlbS5ub2RlTmFtZSk7CiAgICAgICAgfSwKICAgICAgICAnYnV0dG9uJzogZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICAgIHZhciBuYW1lID0gZWxlbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgcmV0dXJuIG5hbWUgPT09ICdpbnB1dCcgJiYgZWxlbS50eXBlID09PSAnYnV0dG9uJyB8fCBuYW1lID09PSAnYnV0dG9uJzsKICAgICAgICB9LAogICAgICAgICd0ZXh0JzogZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICAgIHZhciBhdHRyOwogICAgICAgICAgcmV0dXJuIGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gJ2lucHV0JyAmJiBlbGVtLnR5cGUgPT09ICd0ZXh0JyAmJiAoKGF0dHIgPSBlbGVtLmdldEF0dHJpYnV0ZSgndHlwZScpKSA9PSBudWxsIHx8IGF0dHIudG9Mb3dlckNhc2UoKSA9PT0gJ3RleHQnKTsKICAgICAgICB9LAogICAgICAgIC8vIFBvc2l0aW9uLWluLWNvbGxlY3Rpb24KICAgICAgICAnZmlyc3QnOiBjcmVhdGVQb3NpdGlvbmFsUHNldWRvKGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHJldHVybiBbMF07CiAgICAgICAgfSksCiAgICAgICAgJ2xhc3QnOiBjcmVhdGVQb3NpdGlvbmFsUHNldWRvKGZ1bmN0aW9uIChtYXRjaEluZGV4ZXMsIGxlbmd0aCkgewogICAgICAgICAgcmV0dXJuIFtsZW5ndGggLSAxXTsKICAgICAgICB9KSwKICAgICAgICAnZXEnOiBjcmVhdGVQb3NpdGlvbmFsUHNldWRvKGZ1bmN0aW9uIChtYXRjaEluZGV4ZXMsIGxlbmd0aCwgYXJndW1lbnQpIHsKICAgICAgICAgIHJldHVybiBbYXJndW1lbnQgPCAwID8gYXJndW1lbnQgKyBsZW5ndGggOiBhcmd1bWVudF07CiAgICAgICAgfSksCiAgICAgICAgJ2V2ZW4nOiBjcmVhdGVQb3NpdGlvbmFsUHNldWRvKGZ1bmN0aW9uIChtYXRjaEluZGV4ZXMsIGxlbmd0aCkgewogICAgICAgICAgdmFyIGkgPSAwOwogICAgICAgICAgZm9yICg7IGkgPCBsZW5ndGg7IGkgKz0gMikgewogICAgICAgICAgICBtYXRjaEluZGV4ZXMucHVzaChpKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBtYXRjaEluZGV4ZXM7CiAgICAgICAgfSksCiAgICAgICAgJ29kZCc6IGNyZWF0ZVBvc2l0aW9uYWxQc2V1ZG8oZnVuY3Rpb24gKG1hdGNoSW5kZXhlcywgbGVuZ3RoKSB7CiAgICAgICAgICB2YXIgaSA9IDE7CiAgICAgICAgICBmb3IgKDsgaSA8IGxlbmd0aDsgaSArPSAyKSB7CiAgICAgICAgICAgIG1hdGNoSW5kZXhlcy5wdXNoKGkpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG1hdGNoSW5kZXhlczsKICAgICAgICB9KSwKICAgICAgICAnbHQnOiBjcmVhdGVQb3NpdGlvbmFsUHNldWRvKGZ1bmN0aW9uIChtYXRjaEluZGV4ZXMsIGxlbmd0aCwgYXJndW1lbnQpIHsKICAgICAgICAgIHZhciBpID0gYXJndW1lbnQgPCAwID8gYXJndW1lbnQgKyBsZW5ndGggOiBhcmd1bWVudDsKICAgICAgICAgIGZvciAoOyAtLWkgPj0gMDspIHsKICAgICAgICAgICAgbWF0Y2hJbmRleGVzLnB1c2goaSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbWF0Y2hJbmRleGVzOwogICAgICAgIH0pLAogICAgICAgICdndCc6IGNyZWF0ZVBvc2l0aW9uYWxQc2V1ZG8oZnVuY3Rpb24gKG1hdGNoSW5kZXhlcywgbGVuZ3RoLCBhcmd1bWVudCkgewogICAgICAgICAgdmFyIGkgPSBhcmd1bWVudCA8IDAgPyBhcmd1bWVudCArIGxlbmd0aCA6IGFyZ3VtZW50OwogICAgICAgICAgZm9yICg7ICsraSA8IGxlbmd0aDspIHsKICAgICAgICAgICAgbWF0Y2hJbmRleGVzLnB1c2goaSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbWF0Y2hJbmRleGVzOwogICAgICAgIH0pCiAgICAgIH0KICAgIH07CiAgICBFeHByLnBzZXVkb3NbJ250aCddID0gRXhwci5wc2V1ZG9zWydlcSddOwogICAgLy8gQWRkIGJ1dHRvbi9pbnB1dCB0eXBlIHBzZXVkb3MKICAgIGZvciAoaSBpbiB7CiAgICAgICAgcmFkaW86IHRydWUsCiAgICAgICAgY2hlY2tib3g6IHRydWUsCiAgICAgICAgZmlsZTogdHJ1ZSwKICAgICAgICBwYXNzd29yZDogdHJ1ZSwKICAgICAgICBpbWFnZTogdHJ1ZQogICAgICB9KSB7CiAgICAgIEV4cHIucHNldWRvc1tpXSA9IGNyZWF0ZUlucHV0UHNldWRvKGkpOwogICAgfQogICAgZm9yIChpIGluIHsKICAgICAgICBzdWJtaXQ6IHRydWUsCiAgICAgICAgcmVzZXQ6IHRydWUKICAgICAgfSkgewogICAgICBFeHByLnBzZXVkb3NbaV0gPSBjcmVhdGVCdXR0b25Qc2V1ZG8oaSk7CiAgICB9CiAgICAvLyBFYXN5IEFQSSBmb3IgY3JlYXRpbmcgbmV3IHNldEZpbHRlcnMKICAgIGZ1bmN0aW9uIHNldEZpbHRlcnMoKSB7CiAgICB9CiAgICBzZXRGaWx0ZXJzLnByb3RvdHlwZSA9IEV4cHIuZmlsdGVycyA9IEV4cHIucHNldWRvczsKICAgIEV4cHIuc2V0RmlsdGVycyA9IG5ldyBzZXRGaWx0ZXJzKCk7CiAgICB0b2tlbml6ZSA9IFNpenpsZS50b2tlbml6ZSA9IGZ1bmN0aW9uIChzZWxlY3RvciwgcGFyc2VPbmx5KSB7CiAgICAgIHZhciBtYXRjaGVkLCBtYXRjaCwgdG9rZW5zLCB0eXBlLCBzb0ZhciwgZ3JvdXBzLCBwcmVGaWx0ZXJzLCBjYWNoZWQgPSB0b2tlbkNhY2hlW3NlbGVjdG9yICsgJyAnXTsKICAgICAgaWYgKGNhY2hlZCkgewogICAgICAgIHJldHVybiBwYXJzZU9ubHkgPyAwIDogY2FjaGVkLnNsaWNlKDApOwogICAgICB9CiAgICAgIHNvRmFyID0gc2VsZWN0b3I7CiAgICAgIGdyb3VwcyA9IFtdOwogICAgICBwcmVGaWx0ZXJzID0gRXhwci5wcmVGaWx0ZXI7CiAgICAgIHdoaWxlIChzb0ZhcikgewogICAgICAgIC8vIENvbW1hIGFuZCBmaXJzdCBydW4KICAgICAgICBpZiAoIW1hdGNoZWQgfHwgKG1hdGNoID0gcmNvbW1hLmV4ZWMoc29GYXIpKSkgewogICAgICAgICAgaWYgKG1hdGNoKSB7CiAgICAgICAgICAgIC8vIERvbid0IGNvbnN1bWUgdHJhaWxpbmcgY29tbWFzIGFzIHZhbGlkCiAgICAgICAgICAgIHNvRmFyID0gc29GYXIuc2xpY2UobWF0Y2hbMF0ubGVuZ3RoKSB8fCBzb0ZhcjsKICAgICAgICAgIH0KICAgICAgICAgIGdyb3Vwcy5wdXNoKHRva2VucyA9IFtdKTsKICAgICAgICB9CiAgICAgICAgbWF0Y2hlZCA9IGZhbHNlOwogICAgICAgIC8vIENvbWJpbmF0b3JzCiAgICAgICAgaWYgKG1hdGNoID0gcmNvbWJpbmF0b3JzLmV4ZWMoc29GYXIpKSB7CiAgICAgICAgICBtYXRjaGVkID0gbWF0Y2guc2hpZnQoKTsKICAgICAgICAgIHRva2Vucy5wdXNoKHsKICAgICAgICAgICAgdmFsdWU6IG1hdGNoZWQsCiAgICAgICAgICAgIC8vIENhc3QgZGVzY2VuZGFudCBjb21iaW5hdG9ycyB0byBzcGFjZQogICAgICAgICAgICB0eXBlOiBtYXRjaFswXS5yZXBsYWNlKHJ0cmltLCAnICcpCiAgICAgICAgICB9KTsKICAgICAgICAgIHNvRmFyID0gc29GYXIuc2xpY2UobWF0Y2hlZC5sZW5ndGgpOwogICAgICAgIH0KICAgICAgICAvLyBGaWx0ZXJzCiAgICAgICAgZm9yICh0eXBlIGluIEV4cHIuZmlsdGVyKSB7CiAgICAgICAgICBpZiAoKG1hdGNoID0gbWF0Y2hFeHByW3R5cGVdLmV4ZWMoc29GYXIpKSAmJiAoIXByZUZpbHRlcnNbdHlwZV0gfHwgKG1hdGNoID0gcHJlRmlsdGVyc1t0eXBlXShtYXRjaCkpKSkgewogICAgICAgICAgICBtYXRjaGVkID0gbWF0Y2guc2hpZnQoKTsKICAgICAgICAgICAgdG9rZW5zLnB1c2goewogICAgICAgICAgICAgIHZhbHVlOiBtYXRjaGVkLAogICAgICAgICAgICAgIHR5cGU6IHR5cGUsCiAgICAgICAgICAgICAgbWF0Y2hlczogbWF0Y2gKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHNvRmFyID0gc29GYXIuc2xpY2UobWF0Y2hlZC5sZW5ndGgpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoIW1hdGNoZWQpIHsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgfQogICAgICAvLyBSZXR1cm4gdGhlIGxlbmd0aCBvZiB0aGUgaW52YWxpZCBleGNlc3MKICAgICAgLy8gaWYgd2UncmUganVzdCBwYXJzaW5nCiAgICAgIC8vIE90aGVyd2lzZSwgdGhyb3cgYW4gZXJyb3Igb3IgcmV0dXJuIHRva2VucwogICAgICByZXR1cm4gcGFyc2VPbmx5ID8gc29GYXIubGVuZ3RoIDogc29GYXIgPyBTaXp6bGUuZXJyb3Ioc2VsZWN0b3IpIDogLy8gQ2FjaGUgdGhlIHRva2VucwogICAgICB0b2tlbkNhY2hlKHNlbGVjdG9yLCBncm91cHMpLnNsaWNlKDApOwogICAgfTsKICAgIGZ1bmN0aW9uIHRvU2VsZWN0b3IodG9rZW5zKSB7CiAgICAgIHZhciBpID0gMCwgbGVuID0gdG9rZW5zLmxlbmd0aCwgc2VsZWN0b3IgPSAnJzsKICAgICAgZm9yICg7IGkgPCBsZW47IGkrKykgewogICAgICAgIHNlbGVjdG9yICs9IHRva2Vuc1tpXS52YWx1ZTsKICAgICAgfQogICAgICByZXR1cm4gc2VsZWN0b3I7CiAgICB9CiAgICBmdW5jdGlvbiBhZGRDb21iaW5hdG9yKG1hdGNoZXIsIGNvbWJpbmF0b3IsIGJhc2UpIHsKICAgICAgdmFyIGRpciA9IGNvbWJpbmF0b3IuZGlyLCBjaGVja05vbkVsZW1lbnRzID0gYmFzZSAmJiBkaXIgPT09ICdwYXJlbnROb2RlJywgZG9uZU5hbWUgPSBkb25lKys7CiAgICAgIHJldHVybiBjb21iaW5hdG9yLmZpcnN0ID8gLy8gQ2hlY2sgYWdhaW5zdCBjbG9zZXN0IGFuY2VzdG9yL3ByZWNlZGluZyBlbGVtZW50CiAgICAgIGZ1bmN0aW9uIChlbGVtLCBjb250ZXh0LCB4bWwpIHsKICAgICAgICB3aGlsZSAoZWxlbSA9IGVsZW1bZGlyXSkgewogICAgICAgICAgaWYgKGVsZW0ubm9kZVR5cGUgPT09IDEgfHwgY2hlY2tOb25FbGVtZW50cykgewogICAgICAgICAgICByZXR1cm4gbWF0Y2hlcihlbGVtLCBjb250ZXh0LCB4bWwpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSA6IC8vIENoZWNrIGFnYWluc3QgYWxsIGFuY2VzdG9yL3ByZWNlZGluZyBlbGVtZW50cwogICAgICBmdW5jdGlvbiAoZWxlbSwgY29udGV4dCwgeG1sKSB7CiAgICAgICAgdmFyIG9sZENhY2hlLCBvdXRlckNhY2hlLCBuZXdDYWNoZSA9IFsKICAgICAgICAgICAgZGlycnVucywKICAgICAgICAgICAgZG9uZU5hbWUKICAgICAgICAgIF07CiAgICAgICAgLy8gV2UgY2FuJ3Qgc2V0IGFyYml0cmFyeSBkYXRhIG9uIFhNTCBub2Rlcywgc28gdGhleSBkb24ndCBiZW5lZml0IGZyb20gZGlyIGNhY2hpbmcKICAgICAgICBpZiAoeG1sKSB7CiAgICAgICAgICB3aGlsZSAoZWxlbSA9IGVsZW1bZGlyXSkgewogICAgICAgICAgICBpZiAoZWxlbS5ub2RlVHlwZSA9PT0gMSB8fCBjaGVja05vbkVsZW1lbnRzKSB7CiAgICAgICAgICAgICAgaWYgKG1hdGNoZXIoZWxlbSwgY29udGV4dCwgeG1sKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHdoaWxlIChlbGVtID0gZWxlbVtkaXJdKSB7CiAgICAgICAgICAgIGlmIChlbGVtLm5vZGVUeXBlID09PSAxIHx8IGNoZWNrTm9uRWxlbWVudHMpIHsKICAgICAgICAgICAgICBvdXRlckNhY2hlID0gZWxlbVtleHBhbmRvXSB8fCAoZWxlbVtleHBhbmRvXSA9IHt9KTsKICAgICAgICAgICAgICBpZiAoKG9sZENhY2hlID0gb3V0ZXJDYWNoZVtkaXJdKSAmJiBvbGRDYWNoZVswXSA9PT0gZGlycnVucyAmJiBvbGRDYWNoZVsxXSA9PT0gZG9uZU5hbWUpIHsKICAgICAgICAgICAgICAgIC8vIEFzc2lnbiB0byBuZXdDYWNoZSBzbyByZXN1bHRzIGJhY2stcHJvcGFnYXRlIHRvIHByZXZpb3VzIGVsZW1lbnRzCiAgICAgICAgICAgICAgICByZXR1cm4gbmV3Q2FjaGVbMl0gPSBvbGRDYWNoZVsyXTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gUmV1c2UgbmV3Y2FjaGUgc28gcmVzdWx0cyBiYWNrLXByb3BhZ2F0ZSB0byBwcmV2aW91cyBlbGVtZW50cwogICAgICAgICAgICAgICAgb3V0ZXJDYWNoZVtkaXJdID0gbmV3Q2FjaGU7CiAgICAgICAgICAgICAgICAvLyBBIG1hdGNoIG1lYW5zIHdlJ3JlIGRvbmU7IGEgZmFpbCBtZWFucyB3ZSBoYXZlIHRvIGtlZXAgY2hlY2tpbmcKICAgICAgICAgICAgICAgIGlmIChuZXdDYWNoZVsyXSA9IG1hdGNoZXIoZWxlbSwgY29udGV4dCwgeG1sKSkgewogICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH07CiAgICB9CiAgICBmdW5jdGlvbiBlbGVtZW50TWF0Y2hlcihtYXRjaGVycykgewogICAgICByZXR1cm4gbWF0Y2hlcnMubGVuZ3RoID4gMSA/IGZ1bmN0aW9uIChlbGVtLCBjb250ZXh0LCB4bWwpIHsKICAgICAgICB2YXIgaSA9IG1hdGNoZXJzLmxlbmd0aDsKICAgICAgICB3aGlsZSAoaS0tKSB7CiAgICAgICAgICBpZiAoIW1hdGNoZXJzW2ldKGVsZW0sIGNvbnRleHQsIHhtbCkpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfSA6IG1hdGNoZXJzWzBdOwogICAgfQogICAgZnVuY3Rpb24gbXVsdGlwbGVDb250ZXh0cyhzZWxlY3RvciwgY29udGV4dHMsIHJlc3VsdHMpIHsKICAgICAgdmFyIGkgPSAwLCBsZW4gPSBjb250ZXh0cy5sZW5ndGg7CiAgICAgIGZvciAoOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICBTaXp6bGUoc2VsZWN0b3IsIGNvbnRleHRzW2ldLCByZXN1bHRzKTsKICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0czsKICAgIH0KICAgIGZ1bmN0aW9uIGNvbmRlbnNlKHVubWF0Y2hlZCwgbWFwLCBmaWx0ZXIsIGNvbnRleHQsIHhtbCkgewogICAgICB2YXIgZWxlbSwgbmV3VW5tYXRjaGVkID0gW10sIGkgPSAwLCBsZW4gPSB1bm1hdGNoZWQubGVuZ3RoLCBtYXBwZWQgPSBtYXAgIT0gbnVsbDsKICAgICAgZm9yICg7IGkgPCBsZW47IGkrKykgewogICAgICAgIGlmIChlbGVtID0gdW5tYXRjaGVkW2ldKSB7CiAgICAgICAgICBpZiAoIWZpbHRlciB8fCBmaWx0ZXIoZWxlbSwgY29udGV4dCwgeG1sKSkgewogICAgICAgICAgICBuZXdVbm1hdGNoZWQucHVzaChlbGVtKTsKICAgICAgICAgICAgaWYgKG1hcHBlZCkgewogICAgICAgICAgICAgIG1hcC5wdXNoKGkpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBuZXdVbm1hdGNoZWQ7CiAgICB9CiAgICBmdW5jdGlvbiBzZXRNYXRjaGVyKHByZUZpbHRlciwgc2VsZWN0b3IsIG1hdGNoZXIsIHBvc3RGaWx0ZXIsIHBvc3RGaW5kZXIsIHBvc3RTZWxlY3RvcikgewogICAgICBpZiAocG9zdEZpbHRlciAmJiAhcG9zdEZpbHRlcltleHBhbmRvXSkgewogICAgICAgIHBvc3RGaWx0ZXIgPSBzZXRNYXRjaGVyKHBvc3RGaWx0ZXIpOwogICAgICB9CiAgICAgIGlmIChwb3N0RmluZGVyICYmICFwb3N0RmluZGVyW2V4cGFuZG9dKSB7CiAgICAgICAgcG9zdEZpbmRlciA9IHNldE1hdGNoZXIocG9zdEZpbmRlciwgcG9zdFNlbGVjdG9yKTsKICAgICAgfQogICAgICByZXR1cm4gbWFya0Z1bmN0aW9uKGZ1bmN0aW9uIChzZWVkLCByZXN1bHRzLCBjb250ZXh0LCB4bWwpIHsKICAgICAgICB2YXIgdGVtcCwgaSwgZWxlbSwgcHJlTWFwID0gW10sIHBvc3RNYXAgPSBbXSwgcHJlZXhpc3RpbmcgPSByZXN1bHRzLmxlbmd0aCwKICAgICAgICAgIC8vIEdldCBpbml0aWFsIGVsZW1lbnRzIGZyb20gc2VlZCBvciBjb250ZXh0CiAgICAgICAgICBlbGVtcyA9IHNlZWQgfHwgbXVsdGlwbGVDb250ZXh0cyhzZWxlY3RvciB8fCAnKicsIGNvbnRleHQubm9kZVR5cGUgPyBbY29udGV4dF0gOiBjb250ZXh0LCBbXSksCiAgICAgICAgICAvLyBQcmVmaWx0ZXIgdG8gZ2V0IG1hdGNoZXIgaW5wdXQsIHByZXNlcnZpbmcgYSBtYXAgZm9yIHNlZWQtcmVzdWx0cyBzeW5jaHJvbml6YXRpb24KICAgICAgICAgIG1hdGNoZXJJbiA9IHByZUZpbHRlciAmJiAoc2VlZCB8fCAhc2VsZWN0b3IpID8gY29uZGVuc2UoZWxlbXMsIHByZU1hcCwgcHJlRmlsdGVyLCBjb250ZXh0LCB4bWwpIDogZWxlbXMsIG1hdGNoZXJPdXQgPSBtYXRjaGVyID8gLy8gSWYgd2UgaGF2ZSBhIHBvc3RGaW5kZXIsIG9yIGZpbHRlcmVkIHNlZWQsIG9yIG5vbi1zZWVkIHBvc3RGaWx0ZXIgb3IgcHJlZXhpc3RpbmcgcmVzdWx0cywKICAgICAgICAgIHBvc3RGaW5kZXIgfHwgKHNlZWQgPyBwcmVGaWx0ZXIgOiBwcmVleGlzdGluZyB8fCBwb3N0RmlsdGVyKSA/IC8vIC4uLmludGVybWVkaWF0ZSBwcm9jZXNzaW5nIGlzIG5lY2Vzc2FyeQogICAgICAgICAgW10gOiAvLyAuLi5vdGhlcndpc2UgdXNlIHJlc3VsdHMgZGlyZWN0bHkKICAgICAgICAgIHJlc3VsdHMgOiBtYXRjaGVySW47CiAgICAgICAgLy8gRmluZCBwcmltYXJ5IG1hdGNoZXMKICAgICAgICBpZiAobWF0Y2hlcikgewogICAgICAgICAgbWF0Y2hlcihtYXRjaGVySW4sIG1hdGNoZXJPdXQsIGNvbnRleHQsIHhtbCk7CiAgICAgICAgfQogICAgICAgIC8vIEFwcGx5IHBvc3RGaWx0ZXIKICAgICAgICBpZiAocG9zdEZpbHRlcikgewogICAgICAgICAgdGVtcCA9IGNvbmRlbnNlKG1hdGNoZXJPdXQsIHBvc3RNYXApOwogICAgICAgICAgcG9zdEZpbHRlcih0ZW1wLCBbXSwgY29udGV4dCwgeG1sKTsKICAgICAgICAgIC8vIFVuLW1hdGNoIGZhaWxpbmcgZWxlbWVudHMgYnkgbW92aW5nIHRoZW0gYmFjayB0byBtYXRjaGVySW4KICAgICAgICAgIGkgPSB0ZW1wLmxlbmd0aDsKICAgICAgICAgIHdoaWxlIChpLS0pIHsKICAgICAgICAgICAgaWYgKGVsZW0gPSB0ZW1wW2ldKSB7CiAgICAgICAgICAgICAgbWF0Y2hlck91dFtwb3N0TWFwW2ldXSA9ICEobWF0Y2hlckluW3Bvc3RNYXBbaV1dID0gZWxlbSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKHNlZWQpIHsKICAgICAgICAgIGlmIChwb3N0RmluZGVyIHx8IHByZUZpbHRlcikgewogICAgICAgICAgICBpZiAocG9zdEZpbmRlcikgewogICAgICAgICAgICAgIC8vIEdldCB0aGUgZmluYWwgbWF0Y2hlck91dCBieSBjb25kZW5zaW5nIHRoaXMgaW50ZXJtZWRpYXRlIGludG8gcG9zdEZpbmRlciBjb250ZXh0cwogICAgICAgICAgICAgIHRlbXAgPSBbXTsKICAgICAgICAgICAgICBpID0gbWF0Y2hlck91dC5sZW5ndGg7CiAgICAgICAgICAgICAgd2hpbGUgKGktLSkgewogICAgICAgICAgICAgICAgaWYgKGVsZW0gPSBtYXRjaGVyT3V0W2ldKSB7CiAgICAgICAgICAgICAgICAgIC8vIFJlc3RvcmUgbWF0Y2hlckluIHNpbmNlIGVsZW0gaXMgbm90IHlldCBhIGZpbmFsIG1hdGNoCiAgICAgICAgICAgICAgICAgIHRlbXAucHVzaChtYXRjaGVySW5baV0gPSBlbGVtKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcG9zdEZpbmRlcihudWxsLCBtYXRjaGVyT3V0ID0gW10sIHRlbXAsIHhtbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gTW92ZSBtYXRjaGVkIGVsZW1lbnRzIGZyb20gc2VlZCB0byByZXN1bHRzIHRvIGtlZXAgdGhlbSBzeW5jaHJvbml6ZWQKICAgICAgICAgICAgaSA9IG1hdGNoZXJPdXQubGVuZ3RoOwogICAgICAgICAgICB3aGlsZSAoaS0tKSB7CiAgICAgICAgICAgICAgaWYgKChlbGVtID0gbWF0Y2hlck91dFtpXSkgJiYgKHRlbXAgPSBwb3N0RmluZGVyID8gaW5kZXhPZi5jYWxsKHNlZWQsIGVsZW0pIDogcHJlTWFwW2ldKSA+IC0xKSB7CiAgICAgICAgICAgICAgICBzZWVkW3RlbXBdID0gIShyZXN1bHRzW3RlbXBdID0gZWxlbSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9ICAvLyBBZGQgZWxlbWVudHMgdG8gcmVzdWx0cywgdGhyb3VnaCBwb3N0RmluZGVyIGlmIGRlZmluZWQKICAgICAgICB9IGVsc2UgewogICAgICAgICAgbWF0Y2hlck91dCA9IGNvbmRlbnNlKG1hdGNoZXJPdXQgPT09IHJlc3VsdHMgPyBtYXRjaGVyT3V0LnNwbGljZShwcmVleGlzdGluZywgbWF0Y2hlck91dC5sZW5ndGgpIDogbWF0Y2hlck91dCk7CiAgICAgICAgICBpZiAocG9zdEZpbmRlcikgewogICAgICAgICAgICBwb3N0RmluZGVyKG51bGwsIHJlc3VsdHMsIG1hdGNoZXJPdXQsIHhtbCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBwdXNoLmFwcGx5KHJlc3VsdHMsIG1hdGNoZXJPdXQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgICBmdW5jdGlvbiBtYXRjaGVyRnJvbVRva2Vucyh0b2tlbnMpIHsKICAgICAgdmFyIGNoZWNrQ29udGV4dCwgbWF0Y2hlciwgaiwgbGVuID0gdG9rZW5zLmxlbmd0aCwgbGVhZGluZ1JlbGF0aXZlID0gRXhwci5yZWxhdGl2ZVt0b2tlbnNbMF0udHlwZV0sIGltcGxpY2l0UmVsYXRpdmUgPSBsZWFkaW5nUmVsYXRpdmUgfHwgRXhwci5yZWxhdGl2ZVsnICddLCBpID0gbGVhZGluZ1JlbGF0aXZlID8gMSA6IDAsCiAgICAgICAgLy8gVGhlIGZvdW5kYXRpb25hbCBtYXRjaGVyIGVuc3VyZXMgdGhhdCBlbGVtZW50cyBhcmUgcmVhY2hhYmxlIGZyb20gdG9wLWxldmVsIGNvbnRleHQocykKICAgICAgICBtYXRjaENvbnRleHQgPSBhZGRDb21iaW5hdG9yKGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgICByZXR1cm4gZWxlbSA9PT0gY2hlY2tDb250ZXh0OwogICAgICAgIH0sIGltcGxpY2l0UmVsYXRpdmUsIHRydWUpLCBtYXRjaEFueUNvbnRleHQgPSBhZGRDb21iaW5hdG9yKGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgICByZXR1cm4gaW5kZXhPZi5jYWxsKGNoZWNrQ29udGV4dCwgZWxlbSkgPiAtMTsKICAgICAgICB9LCBpbXBsaWNpdFJlbGF0aXZlLCB0cnVlKSwgbWF0Y2hlcnMgPSBbZnVuY3Rpb24gKGVsZW0sIGNvbnRleHQsIHhtbCkgewogICAgICAgICAgICByZXR1cm4gIWxlYWRpbmdSZWxhdGl2ZSAmJiAoeG1sIHx8IGNvbnRleHQgIT09IG91dGVybW9zdENvbnRleHQpIHx8ICgoY2hlY2tDb250ZXh0ID0gY29udGV4dCkubm9kZVR5cGUgPyBtYXRjaENvbnRleHQoZWxlbSwgY29udGV4dCwgeG1sKSA6IG1hdGNoQW55Q29udGV4dChlbGVtLCBjb250ZXh0LCB4bWwpKTsKICAgICAgICAgIH1dOwogICAgICBmb3IgKDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgaWYgKG1hdGNoZXIgPSBFeHByLnJlbGF0aXZlW3Rva2Vuc1tpXS50eXBlXSkgewogICAgICAgICAgbWF0Y2hlcnMgPSBbYWRkQ29tYmluYXRvcihlbGVtZW50TWF0Y2hlcihtYXRjaGVycyksIG1hdGNoZXIpXTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgbWF0Y2hlciA9IEV4cHIuZmlsdGVyW3Rva2Vuc1tpXS50eXBlXS5hcHBseShudWxsLCB0b2tlbnNbaV0ubWF0Y2hlcyk7CiAgICAgICAgICAvLyBSZXR1cm4gc3BlY2lhbCB1cG9uIHNlZWluZyBhIHBvc2l0aW9uYWwgbWF0Y2hlcgogICAgICAgICAgaWYgKG1hdGNoZXJbZXhwYW5kb10pIHsKICAgICAgICAgICAgLy8gRmluZCB0aGUgbmV4dCByZWxhdGl2ZSBvcGVyYXRvciAoaWYgYW55KSBmb3IgcHJvcGVyIGhhbmRsaW5nCiAgICAgICAgICAgIGogPSArK2k7CiAgICAgICAgICAgIGZvciAoOyBqIDwgbGVuOyBqKyspIHsKICAgICAgICAgICAgICBpZiAoRXhwci5yZWxhdGl2ZVt0b2tlbnNbal0udHlwZV0pIHsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gc2V0TWF0Y2hlcihpID4gMSAmJiBlbGVtZW50TWF0Y2hlcihtYXRjaGVycyksIGkgPiAxICYmIHRvU2VsZWN0b3IoLy8gSWYgdGhlIHByZWNlZGluZyB0b2tlbiB3YXMgYSBkZXNjZW5kYW50IGNvbWJpbmF0b3IsIGluc2VydCBhbiBpbXBsaWNpdCBhbnktZWxlbWVudCBgKmAKICAgICAgICAgICAgdG9rZW5zLnNsaWNlKDAsIGkgLSAxKS5jb25jYXQoeyB2YWx1ZTogdG9rZW5zW2kgLSAyXS50eXBlID09PSAnICcgPyAnKicgOiAnJyB9KSkucmVwbGFjZShydHJpbSwgJyQxJyksIG1hdGNoZXIsIGkgPCBqICYmIG1hdGNoZXJGcm9tVG9rZW5zKHRva2Vucy5zbGljZShpLCBqKSksIGogPCBsZW4gJiYgbWF0Y2hlckZyb21Ub2tlbnModG9rZW5zID0gdG9rZW5zLnNsaWNlKGopKSwgaiA8IGxlbiAmJiB0b1NlbGVjdG9yKHRva2VucykpOwogICAgICAgICAgfQogICAgICAgICAgbWF0Y2hlcnMucHVzaChtYXRjaGVyKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIGVsZW1lbnRNYXRjaGVyKG1hdGNoZXJzKTsKICAgIH0KICAgIGZ1bmN0aW9uIG1hdGNoZXJGcm9tR3JvdXBNYXRjaGVycyhlbGVtZW50TWF0Y2hlcnMsIHNldE1hdGNoZXJzKSB7CiAgICAgIHZhciBieVNldCA9IHNldE1hdGNoZXJzLmxlbmd0aCA+IDAsIGJ5RWxlbWVudCA9IGVsZW1lbnRNYXRjaGVycy5sZW5ndGggPiAwLCBzdXBlck1hdGNoZXIgPSBmdW5jdGlvbiAoc2VlZCwgY29udGV4dCwgeG1sLCByZXN1bHRzLCBvdXRlcm1vc3QpIHsKICAgICAgICAgIHZhciBlbGVtLCBqLCBtYXRjaGVyLCBtYXRjaGVkQ291bnQgPSAwLCBpID0gJzAnLCB1bm1hdGNoZWQgPSBzZWVkICYmIFtdLCBzZXRNYXRjaGVkID0gW10sIGNvbnRleHRCYWNrdXAgPSBvdXRlcm1vc3RDb250ZXh0LAogICAgICAgICAgICAvLyBXZSBtdXN0IGFsd2F5cyBoYXZlIGVpdGhlciBzZWVkIGVsZW1lbnRzIG9yIG91dGVybW9zdCBjb250ZXh0CiAgICAgICAgICAgIGVsZW1zID0gc2VlZCB8fCBieUVsZW1lbnQgJiYgRXhwci5maW5kWydUQUcnXSgnKicsIG91dGVybW9zdCksCiAgICAgICAgICAgIC8vIFVzZSBpbnRlZ2VyIGRpcnJ1bnMgaWZmIHRoaXMgaXMgdGhlIG91dGVybW9zdCBtYXRjaGVyCiAgICAgICAgICAgIGRpcnJ1bnNVbmlxdWUgPSBkaXJydW5zICs9IGNvbnRleHRCYWNrdXAgPT0gbnVsbCA/IDEgOiBNYXRoLnJhbmRvbSgpIHx8IDAuMSwgbGVuID0gZWxlbXMubGVuZ3RoOwogICAgICAgICAgaWYgKG91dGVybW9zdCkgewogICAgICAgICAgICBvdXRlcm1vc3RDb250ZXh0ID0gY29udGV4dCAhPT0gZG9jdW1lbnQgJiYgY29udGV4dDsKICAgICAgICAgIH0KICAgICAgICAgIC8vIEFkZCBlbGVtZW50cyBwYXNzaW5nIGVsZW1lbnRNYXRjaGVycyBkaXJlY3RseSB0byByZXN1bHRzCiAgICAgICAgICAvLyBLZWVwIGBpYCBhIHN0cmluZyBpZiB0aGVyZSBhcmUgbm8gZWxlbWVudHMgc28gYG1hdGNoZWRDb3VudGAgd2lsbCBiZSAiMDAiIGJlbG93CiAgICAgICAgICAvLyBTdXBwb3J0OiBJRTw5LCBTYWZhcmkKICAgICAgICAgIC8vIFRvbGVyYXRlIE5vZGVMaXN0IHByb3BlcnRpZXMgKElFOiAibGVuZ3RoIjsgU2FmYXJpOiA8bnVtYmVyPikgbWF0Y2hpbmcgZWxlbWVudHMgYnkgaWQKICAgICAgICAgIGZvciAoOyBpICE9PSBsZW4gJiYgKGVsZW0gPSBlbGVtc1tpXSkgIT0gbnVsbDsgaSsrKSB7CiAgICAgICAgICAgIGlmIChieUVsZW1lbnQgJiYgZWxlbSkgewogICAgICAgICAgICAgIGogPSAwOwogICAgICAgICAgICAgIHdoaWxlIChtYXRjaGVyID0gZWxlbWVudE1hdGNoZXJzW2orK10pIHsKICAgICAgICAgICAgICAgIGlmIChtYXRjaGVyKGVsZW0sIGNvbnRleHQsIHhtbCkpIHsKICAgICAgICAgICAgICAgICAgcmVzdWx0cy5wdXNoKGVsZW0pOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKG91dGVybW9zdCkgewogICAgICAgICAgICAgICAgZGlycnVucyA9IGRpcnJ1bnNVbmlxdWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIFRyYWNrIHVubWF0Y2hlZCBlbGVtZW50cyBmb3Igc2V0IGZpbHRlcnMKICAgICAgICAgICAgaWYgKGJ5U2V0KSB7CiAgICAgICAgICAgICAgLy8gVGhleSB3aWxsIGhhdmUgZ29uZSB0aHJvdWdoIGFsbCBwb3NzaWJsZSBtYXRjaGVycwogICAgICAgICAgICAgIGlmIChlbGVtID0gIW1hdGNoZXIgJiYgZWxlbSkgewogICAgICAgICAgICAgICAgbWF0Y2hlZENvdW50LS07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIC8vIExlbmd0aGVuIHRoZSBhcnJheSBmb3IgZXZlcnkgZWxlbWVudCwgbWF0Y2hlZCBvciBub3QKICAgICAgICAgICAgICBpZiAoc2VlZCkgewogICAgICAgICAgICAgICAgdW5tYXRjaGVkLnB1c2goZWxlbSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICAvLyBBcHBseSBzZXQgZmlsdGVycyB0byB1bm1hdGNoZWQgZWxlbWVudHMKICAgICAgICAgIG1hdGNoZWRDb3VudCArPSBpOwogICAgICAgICAgaWYgKGJ5U2V0ICYmIGkgIT09IG1hdGNoZWRDb3VudCkgewogICAgICAgICAgICBqID0gMDsKICAgICAgICAgICAgd2hpbGUgKG1hdGNoZXIgPSBzZXRNYXRjaGVyc1tqKytdKSB7CiAgICAgICAgICAgICAgbWF0Y2hlcih1bm1hdGNoZWQsIHNldE1hdGNoZWQsIGNvbnRleHQsIHhtbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHNlZWQpIHsKICAgICAgICAgICAgICAvLyBSZWludGVncmF0ZSBlbGVtZW50IG1hdGNoZXMgdG8gZWxpbWluYXRlIHRoZSBuZWVkIGZvciBzb3J0aW5nCiAgICAgICAgICAgICAgaWYgKG1hdGNoZWRDb3VudCA+IDApIHsKICAgICAgICAgICAgICAgIHdoaWxlIChpLS0pIHsKICAgICAgICAgICAgICAgICAgaWYgKCEodW5tYXRjaGVkW2ldIHx8IHNldE1hdGNoZWRbaV0pKSB7CiAgICAgICAgICAgICAgICAgICAgc2V0TWF0Y2hlZFtpXSA9IHBvcC5jYWxsKHJlc3VsdHMpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIC8vIERpc2NhcmQgaW5kZXggcGxhY2Vob2xkZXIgdmFsdWVzIHRvIGdldCBvbmx5IGFjdHVhbCBtYXRjaGVzCiAgICAgICAgICAgICAgc2V0TWF0Y2hlZCA9IGNvbmRlbnNlKHNldE1hdGNoZWQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIEFkZCBtYXRjaGVzIHRvIHJlc3VsdHMKICAgICAgICAgICAgcHVzaC5hcHBseShyZXN1bHRzLCBzZXRNYXRjaGVkKTsKICAgICAgICAgICAgLy8gU2VlZGxlc3Mgc2V0IG1hdGNoZXMgc3VjY2VlZGluZyBtdWx0aXBsZSBzdWNjZXNzZnVsIG1hdGNoZXJzIHN0aXB1bGF0ZSBzb3J0aW5nCiAgICAgICAgICAgIGlmIChvdXRlcm1vc3QgJiYgIXNlZWQgJiYgc2V0TWF0Y2hlZC5sZW5ndGggPiAwICYmIG1hdGNoZWRDb3VudCArIHNldE1hdGNoZXJzLmxlbmd0aCA+IDEpIHsKICAgICAgICAgICAgICBTaXp6bGUudW5pcXVlU29ydChyZXN1bHRzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgLy8gT3ZlcnJpZGUgbWFuaXB1bGF0aW9uIG9mIGdsb2JhbHMgYnkgbmVzdGVkIG1hdGNoZXJzCiAgICAgICAgICBpZiAob3V0ZXJtb3N0KSB7CiAgICAgICAgICAgIGRpcnJ1bnMgPSBkaXJydW5zVW5pcXVlOwogICAgICAgICAgICBvdXRlcm1vc3RDb250ZXh0ID0gY29udGV4dEJhY2t1cDsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB1bm1hdGNoZWQ7CiAgICAgICAgfTsKICAgICAgcmV0dXJuIGJ5U2V0ID8gbWFya0Z1bmN0aW9uKHN1cGVyTWF0Y2hlcikgOiBzdXBlck1hdGNoZXI7CiAgICB9CiAgICBjb21waWxlID0gU2l6emxlLmNvbXBpbGUgPSBmdW5jdGlvbiAoc2VsZWN0b3IsIG1hdGNoKSB7CiAgICAgIHZhciBpLCBzZXRNYXRjaGVycyA9IFtdLCBlbGVtZW50TWF0Y2hlcnMgPSBbXSwgY2FjaGVkID0gY29tcGlsZXJDYWNoZVtzZWxlY3RvciArICcgJ107CiAgICAgIGlmICghY2FjaGVkKSB7CiAgICAgICAgLy8gR2VuZXJhdGUgYSBmdW5jdGlvbiBvZiByZWN1cnNpdmUgZnVuY3Rpb25zIHRoYXQgY2FuIGJlIHVzZWQgdG8gY2hlY2sgZWFjaCBlbGVtZW50CiAgICAgICAgaWYgKCFtYXRjaCkgewogICAgICAgICAgbWF0Y2ggPSB0b2tlbml6ZShzZWxlY3Rvcik7CiAgICAgICAgfQogICAgICAgIGkgPSBtYXRjaC5sZW5ndGg7CiAgICAgICAgd2hpbGUgKGktLSkgewogICAgICAgICAgY2FjaGVkID0gbWF0Y2hlckZyb21Ub2tlbnMobWF0Y2hbaV0pOwogICAgICAgICAgaWYgKGNhY2hlZFtleHBhbmRvXSkgewogICAgICAgICAgICBzZXRNYXRjaGVycy5wdXNoKGNhY2hlZCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBlbGVtZW50TWF0Y2hlcnMucHVzaChjYWNoZWQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAvLyBDYWNoZSB0aGUgY29tcGlsZWQgZnVuY3Rpb24KICAgICAgICBjYWNoZWQgPSBjb21waWxlckNhY2hlKHNlbGVjdG9yLCBtYXRjaGVyRnJvbUdyb3VwTWF0Y2hlcnMoZWxlbWVudE1hdGNoZXJzLCBzZXRNYXRjaGVycykpOwogICAgICAgIC8vIFNhdmUgc2VsZWN0b3IgYW5kIHRva2VuaXphdGlvbgogICAgICAgIGNhY2hlZC5zZWxlY3RvciA9IHNlbGVjdG9yOwogICAgICB9CiAgICAgIHJldHVybiBjYWNoZWQ7CiAgICB9OwogICAgLyoqCiAgICAgKiBBIGxvdy1sZXZlbCBzZWxlY3Rpb24gZnVuY3Rpb24gdGhhdCB3b3JrcyB3aXRoIFNpenpsZSdzIGNvbXBpbGVkCiAgICAgKiAgc2VsZWN0b3IgZnVuY3Rpb25zCiAgICAgKiBAcGFyYW0ge1N0cmluZ3xGdW5jdGlvbn0gc2VsZWN0b3IgQSBzZWxlY3RvciBvciBhIHByZS1jb21waWxlZAogICAgICogIHNlbGVjdG9yIGZ1bmN0aW9uIGJ1aWx0IHdpdGggU2l6emxlLmNvbXBpbGUKICAgICAqIEBwYXJhbSB7RWxlbWVudH0gY29udGV4dAogICAgICogQHBhcmFtIHtBcnJheX0gW3Jlc3VsdHNdCiAgICAgKiBAcGFyYW0ge0FycmF5fSBbc2VlZF0gQSBzZXQgb2YgZWxlbWVudHMgdG8gbWF0Y2ggYWdhaW5zdAogICAgICovCiAgICBzZWxlY3QgPSBTaXp6bGUuc2VsZWN0ID0gZnVuY3Rpb24gKHNlbGVjdG9yLCBjb250ZXh0LCByZXN1bHRzLCBzZWVkKSB7CiAgICAgIHZhciBpLCB0b2tlbnMsIHRva2VuLCB0eXBlLCBmaW5kLCBjb21waWxlZCA9IHR5cGVvZiBzZWxlY3RvciA9PT0gJ2Z1bmN0aW9uJyAmJiBzZWxlY3RvciwgbWF0Y2ggPSAhc2VlZCAmJiB0b2tlbml6ZShzZWxlY3RvciA9IGNvbXBpbGVkLnNlbGVjdG9yIHx8IHNlbGVjdG9yKTsKICAgICAgcmVzdWx0cyA9IHJlc3VsdHMgfHwgW107CiAgICAgIC8vIFRyeSB0byBtaW5pbWl6ZSBvcGVyYXRpb25zIGlmIHRoZXJlIGlzIG5vIHNlZWQgYW5kIG9ubHkgb25lIGdyb3VwCiAgICAgIGlmIChtYXRjaC5sZW5ndGggPT09IDEpIHsKICAgICAgICAvLyBUYWtlIGEgc2hvcnRjdXQgYW5kIHNldCB0aGUgY29udGV4dCBpZiB0aGUgcm9vdCBzZWxlY3RvciBpcyBhbiBJRAogICAgICAgIHRva2VucyA9IG1hdGNoWzBdID0gbWF0Y2hbMF0uc2xpY2UoMCk7CiAgICAgICAgaWYgKHRva2Vucy5sZW5ndGggPiAyICYmICh0b2tlbiA9IHRva2Vuc1swXSkudHlwZSA9PT0gJ0lEJyAmJiBzdXBwb3J0LmdldEJ5SWQgJiYgY29udGV4dC5ub2RlVHlwZSA9PT0gOSAmJiBkb2N1bWVudElzSFRNTCAmJiBFeHByLnJlbGF0aXZlW3Rva2Vuc1sxXS50eXBlXSkgewogICAgICAgICAgY29udGV4dCA9IChFeHByLmZpbmRbJ0lEJ10odG9rZW4ubWF0Y2hlc1swXS5yZXBsYWNlKHJ1bmVzY2FwZSwgZnVuZXNjYXBlKSwgY29udGV4dCkgfHwgW10pWzBdOwogICAgICAgICAgaWYgKCFjb250ZXh0KSB7CiAgICAgICAgICAgIHJldHVybiByZXN1bHRzOyAgLy8gUHJlY29tcGlsZWQgbWF0Y2hlcnMgd2lsbCBzdGlsbCB2ZXJpZnkgYW5jZXN0cnksIHNvIHN0ZXAgdXAgYSBsZXZlbAogICAgICAgICAgfSBlbHNlIGlmIChjb21waWxlZCkgewogICAgICAgICAgICBjb250ZXh0ID0gY29udGV4dC5wYXJlbnROb2RlOwogICAgICAgICAgfQogICAgICAgICAgc2VsZWN0b3IgPSBzZWxlY3Rvci5zbGljZSh0b2tlbnMuc2hpZnQoKS52YWx1ZS5sZW5ndGgpOwogICAgICAgIH0KICAgICAgICAvLyBGZXRjaCBhIHNlZWQgc2V0IGZvciByaWdodC10by1sZWZ0IG1hdGNoaW5nCiAgICAgICAgaSA9IG1hdGNoRXhwclsnbmVlZHNDb250ZXh0J10udGVzdChzZWxlY3RvcikgPyAwIDogdG9rZW5zLmxlbmd0aDsKICAgICAgICB3aGlsZSAoaS0tKSB7CiAgICAgICAgICB0b2tlbiA9IHRva2Vuc1tpXTsKICAgICAgICAgIC8vIEFib3J0IGlmIHdlIGhpdCBhIGNvbWJpbmF0b3IKICAgICAgICAgIGlmIChFeHByLnJlbGF0aXZlW3R5cGUgPSB0b2tlbi50eXBlXSkgewogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChmaW5kID0gRXhwci5maW5kW3R5cGVdKSB7CiAgICAgICAgICAgIC8vIFNlYXJjaCwgZXhwYW5kaW5nIGNvbnRleHQgZm9yIGxlYWRpbmcgc2libGluZyBjb21iaW5hdG9ycwogICAgICAgICAgICBpZiAoc2VlZCA9IGZpbmQodG9rZW4ubWF0Y2hlc1swXS5yZXBsYWNlKHJ1bmVzY2FwZSwgZnVuZXNjYXBlKSwgcnNpYmxpbmcudGVzdCh0b2tlbnNbMF0udHlwZSkgJiYgdGVzdENvbnRleHQoY29udGV4dC5wYXJlbnROb2RlKSB8fCBjb250ZXh0KSkgewogICAgICAgICAgICAgIC8vIElmIHNlZWQgaXMgZW1wdHkgb3Igbm8gdG9rZW5zIHJlbWFpbiwgd2UgY2FuIHJldHVybiBlYXJseQogICAgICAgICAgICAgIHRva2Vucy5zcGxpY2UoaSwgMSk7CiAgICAgICAgICAgICAgc2VsZWN0b3IgPSBzZWVkLmxlbmd0aCAmJiB0b1NlbGVjdG9yKHRva2Vucyk7CiAgICAgICAgICAgICAgaWYgKCFzZWxlY3RvcikgewogICAgICAgICAgICAgICAgcHVzaC5hcHBseShyZXN1bHRzLCBzZWVkKTsKICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHRzOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICAvLyBDb21waWxlIGFuZCBleGVjdXRlIGEgZmlsdGVyaW5nIGZ1bmN0aW9uIGlmIG9uZSBpcyBub3QgcHJvdmlkZWQKICAgICAgLy8gUHJvdmlkZSBgbWF0Y2hgIHRvIGF2b2lkIHJldG9rZW5pemF0aW9uIGlmIHdlIG1vZGlmaWVkIHRoZSBzZWxlY3RvciBhYm92ZQogICAgICAoY29tcGlsZWQgfHwgY29tcGlsZShzZWxlY3RvciwgbWF0Y2gpKShzZWVkLCBjb250ZXh0LCAhZG9jdW1lbnRJc0hUTUwsIHJlc3VsdHMsIHJzaWJsaW5nLnRlc3Qoc2VsZWN0b3IpICYmIHRlc3RDb250ZXh0KGNvbnRleHQucGFyZW50Tm9kZSkgfHwgY29udGV4dCk7CiAgICAgIHJldHVybiByZXN1bHRzOwogICAgfTsKICAgIC8vIE9uZS10aW1lIGFzc2lnbm1lbnRzCiAgICAvLyBTb3J0IHN0YWJpbGl0eQogICAgc3VwcG9ydC5zb3J0U3RhYmxlID0gZXhwYW5kby5zcGxpdCgnJykuc29ydChzb3J0T3JkZXIpLmpvaW4oJycpID09PSBleHBhbmRvOwogICAgLy8gU3VwcG9ydDogQ2hyb21lPDE0CiAgICAvLyBBbHdheXMgYXNzdW1lIGR1cGxpY2F0ZXMgaWYgdGhleSBhcmVuJ3QgcGFzc2VkIHRvIHRoZSBjb21wYXJpc29uIGZ1bmN0aW9uCiAgICBzdXBwb3J0LmRldGVjdER1cGxpY2F0ZXMgPSAhIWhhc0R1cGxpY2F0ZTsKICAgIC8vIEluaXRpYWxpemUgYWdhaW5zdCB0aGUgZGVmYXVsdCBkb2N1bWVudAogICAgc2V0RG9jdW1lbnQoKTsKICAgIC8vIFN1cHBvcnQ6IFdlYmtpdDw1MzcuMzIgLSBTYWZhcmkgNi4wLjMvQ2hyb21lIDI1IChmaXhlZCBpbiBDaHJvbWUgMjcpCiAgICAvLyBEZXRhY2hlZCBub2RlcyBjb25mb3VuZGluZ2x5IGZvbGxvdyAqZWFjaCBvdGhlcioKICAgIHN1cHBvcnQuc29ydERldGFjaGVkID0gYXNzZXJ0KGZ1bmN0aW9uIChkaXYxKSB7CiAgICAgIC8vIFNob3VsZCByZXR1cm4gMSwgYnV0IHJldHVybnMgNCAoZm9sbG93aW5nKQogICAgICByZXR1cm4gZGl2MS5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbihkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKSkgJiAxOwogICAgfSk7CiAgICAvLyBTdXBwb3J0OiBJRTw4CiAgICAvLyBQcmV2ZW50IGF0dHJpYnV0ZS9wcm9wZXJ0eSAiaW50ZXJwb2xhdGlvbiIKICAgIC8vIGh0dHA6Ly9tc2RuLm1pY3Jvc29mdC5jb20vZW4tdXMvbGlicmFyeS9tczUzNjQyOSUyOFZTLjg1JTI5LmFzcHgKICAgIGlmICghYXNzZXJ0KGZ1bmN0aW9uIChkaXYpIHsKICAgICAgICBkaXYuaW5uZXJIVE1MID0gJzxhIGhyZWY9XCcjXCc+PC9hPic7CiAgICAgICAgcmV0dXJuIGRpdi5maXJzdENoaWxkLmdldEF0dHJpYnV0ZSgnaHJlZicpID09PSAnIyc7CiAgICAgIH0pKSB7CiAgICAgIGFkZEhhbmRsZSgndHlwZXxocmVmfGhlaWdodHx3aWR0aCcsIGZ1bmN0aW9uIChlbGVtLCBuYW1lLCBpc1hNTCkgewogICAgICAgIGlmICghaXNYTUwpIHsKICAgICAgICAgIHJldHVybiBlbGVtLmdldEF0dHJpYnV0ZShuYW1lLCBuYW1lLnRvTG93ZXJDYXNlKCkgPT09ICd0eXBlJyA/IDEgOiAyKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQogICAgLy8gU3VwcG9ydDogSUU8OQogICAgLy8gVXNlIGRlZmF1bHRWYWx1ZSBpbiBwbGFjZSBvZiBnZXRBdHRyaWJ1dGUoInZhbHVlIikKICAgIGlmICghc3VwcG9ydC5hdHRyaWJ1dGVzIHx8ICFhc3NlcnQoZnVuY3Rpb24gKGRpdikgewogICAgICAgIGRpdi5pbm5lckhUTUwgPSAnPGlucHV0Lz4nOwogICAgICAgIGRpdi5maXJzdENoaWxkLnNldEF0dHJpYnV0ZSgndmFsdWUnLCAnJyk7CiAgICAgICAgcmV0dXJuIGRpdi5maXJzdENoaWxkLmdldEF0dHJpYnV0ZSgndmFsdWUnKSA9PT0gJyc7CiAgICAgIH0pKSB7CiAgICAgIGFkZEhhbmRsZSgndmFsdWUnLCBmdW5jdGlvbiAoZWxlbSwgbmFtZSwgaXNYTUwpIHsKICAgICAgICBpZiAoIWlzWE1MICYmIGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gJ2lucHV0JykgewogICAgICAgICAgcmV0dXJuIGVsZW0uZGVmYXVsdFZhbHVlOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgICAvLyBTdXBwb3J0OiBJRTw5CiAgICAvLyBVc2UgZ2V0QXR0cmlidXRlTm9kZSB0byBmZXRjaCBib29sZWFucyB3aGVuIGdldEF0dHJpYnV0ZSBsaWVzCiAgICBpZiAoIWFzc2VydChmdW5jdGlvbiAoZGl2KSB7CiAgICAgICAgcmV0dXJuIGRpdi5nZXRBdHRyaWJ1dGUoJ2Rpc2FibGVkJykgPT0gbnVsbDsKICAgICAgfSkpIHsKICAgICAgYWRkSGFuZGxlKGJvb2xlYW5zLCBmdW5jdGlvbiAoZWxlbSwgbmFtZSwgaXNYTUwpIHsKICAgICAgICB2YXIgdmFsOwogICAgICAgIGlmICghaXNYTUwpIHsKICAgICAgICAgIHJldHVybiBlbGVtW25hbWVdID09PSB0cnVlID8gbmFtZS50b0xvd2VyQ2FzZSgpIDogKHZhbCA9IGVsZW0uZ2V0QXR0cmlidXRlTm9kZShuYW1lKSkgJiYgdmFsLnNwZWNpZmllZCA/IHZhbC52YWx1ZSA6IG51bGw7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICAgIHJldHVybiBTaXp6bGU7CiAgfSh3aW5kb3cpOwogIGpRdWVyeS5maW5kID0gU2l6emxlOwogIGpRdWVyeS5leHByID0gU2l6emxlLnNlbGVjdG9yczsKICBqUXVlcnkuZXhwclsnOiddID0galF1ZXJ5LmV4cHIucHNldWRvczsKICBqUXVlcnkudW5pcXVlID0gU2l6emxlLnVuaXF1ZVNvcnQ7CiAgalF1ZXJ5LnRleHQgPSBTaXp6bGUuZ2V0VGV4dDsKICBqUXVlcnkuaXNYTUxEb2MgPSBTaXp6bGUuaXNYTUw7CiAgalF1ZXJ5LmNvbnRhaW5zID0gU2l6emxlLmNvbnRhaW5zOwogIHZhciBybmVlZHNDb250ZXh0ID0galF1ZXJ5LmV4cHIubWF0Y2gubmVlZHNDb250ZXh0OwogIHZhciByc2luZ2xlVGFnID0gL148KFx3KylccypcLz8+KD86PFwvXDE+fCkkLzsKICB2YXIgcmlzU2ltcGxlID0gL14uW146I1xbXC4sXSokLzsKICAvLyBJbXBsZW1lbnQgdGhlIGlkZW50aWNhbCBmdW5jdGlvbmFsaXR5IGZvciBmaWx0ZXIgYW5kIG5vdAogIGZ1bmN0aW9uIHdpbm5vdyhlbGVtZW50cywgcXVhbGlmaWVyLCBub3QpIHsKICAgIGlmIChqUXVlcnkuaXNGdW5jdGlvbihxdWFsaWZpZXIpKSB7CiAgICAgIHJldHVybiBqUXVlcnkuZ3JlcChlbGVtZW50cywgZnVuY3Rpb24gKGVsZW0sIGkpIHsKICAgICAgICAvKiBqc2hpbnQgLVcwMTggKi8KICAgICAgICByZXR1cm4gISFxdWFsaWZpZXIuY2FsbChlbGVtLCBpLCBlbGVtKSAhPT0gbm90OwogICAgICB9KTsKICAgIH0KICAgIGlmIChxdWFsaWZpZXIubm9kZVR5cGUpIHsKICAgICAgcmV0dXJuIGpRdWVyeS5ncmVwKGVsZW1lbnRzLCBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgIHJldHVybiBlbGVtID09PSBxdWFsaWZpZXIgIT09IG5vdDsKICAgICAgfSk7CiAgICB9CiAgICBpZiAodHlwZW9mIHF1YWxpZmllciA9PT0gJ3N0cmluZycpIHsKICAgICAgaWYgKHJpc1NpbXBsZS50ZXN0KHF1YWxpZmllcikpIHsKICAgICAgICByZXR1cm4galF1ZXJ5LmZpbHRlcihxdWFsaWZpZXIsIGVsZW1lbnRzLCBub3QpOwogICAgICB9CiAgICAgIHF1YWxpZmllciA9IGpRdWVyeS5maWx0ZXIocXVhbGlmaWVyLCBlbGVtZW50cyk7CiAgICB9CiAgICByZXR1cm4galF1ZXJ5LmdyZXAoZWxlbWVudHMsIGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgIHJldHVybiBpbmRleE9mLmNhbGwocXVhbGlmaWVyLCBlbGVtKSA+PSAwICE9PSBub3Q7CiAgICB9KTsKICB9CiAgalF1ZXJ5LmZpbHRlciA9IGZ1bmN0aW9uIChleHByLCBlbGVtcywgbm90KSB7CiAgICB2YXIgZWxlbSA9IGVsZW1zWzBdOwogICAgaWYgKG5vdCkgewogICAgICBleHByID0gJzpub3QoJyArIGV4cHIgKyAnKSc7CiAgICB9CiAgICByZXR1cm4gZWxlbXMubGVuZ3RoID09PSAxICYmIGVsZW0ubm9kZVR5cGUgPT09IDEgPyBqUXVlcnkuZmluZC5tYXRjaGVzU2VsZWN0b3IoZWxlbSwgZXhwcikgPyBbZWxlbV0gOiBbXSA6IGpRdWVyeS5maW5kLm1hdGNoZXMoZXhwciwgalF1ZXJ5LmdyZXAoZWxlbXMsIGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgIHJldHVybiBlbGVtLm5vZGVUeXBlID09PSAxOwogICAgfSkpOwogIH07CiAgalF1ZXJ5LmZuLmV4dGVuZCh7CiAgICBmaW5kOiBmdW5jdGlvbiAoc2VsZWN0b3IpIHsKICAgICAgdmFyIGksIGxlbiA9IHRoaXMubGVuZ3RoLCByZXQgPSBbXSwgc2VsZiA9IHRoaXM7CiAgICAgIGlmICh0eXBlb2Ygc2VsZWN0b3IgIT09ICdzdHJpbmcnKSB7CiAgICAgICAgcmV0dXJuIHRoaXMucHVzaFN0YWNrKGpRdWVyeShzZWxlY3RvcikuZmlsdGVyKGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW47IGkrKykgewogICAgICAgICAgICBpZiAoalF1ZXJ5LmNvbnRhaW5zKHNlbGZbaV0sIHRoaXMpKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9KSk7CiAgICAgIH0KICAgICAgZm9yIChpID0gMDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgalF1ZXJ5LmZpbmQoc2VsZWN0b3IsIHNlbGZbaV0sIHJldCk7CiAgICAgIH0KICAgICAgLy8gTmVlZGVkIGJlY2F1c2UgJCggc2VsZWN0b3IsIGNvbnRleHQgKSBiZWNvbWVzICQoIGNvbnRleHQgKS5maW5kKCBzZWxlY3RvciApCiAgICAgIHJldCA9IHRoaXMucHVzaFN0YWNrKGxlbiA+IDEgPyBqUXVlcnkudW5pcXVlKHJldCkgOiByZXQpOwogICAgICByZXQuc2VsZWN0b3IgPSB0aGlzLnNlbGVjdG9yID8gdGhpcy5zZWxlY3RvciArICcgJyArIHNlbGVjdG9yIDogc2VsZWN0b3I7CiAgICAgIHJldHVybiByZXQ7CiAgICB9LAogICAgZmlsdGVyOiBmdW5jdGlvbiAoc2VsZWN0b3IpIHsKICAgICAgcmV0dXJuIHRoaXMucHVzaFN0YWNrKHdpbm5vdyh0aGlzLCBzZWxlY3RvciB8fCBbXSwgZmFsc2UpKTsKICAgIH0sCiAgICBub3Q6IGZ1bmN0aW9uIChzZWxlY3RvcikgewogICAgICByZXR1cm4gdGhpcy5wdXNoU3RhY2sod2lubm93KHRoaXMsIHNlbGVjdG9yIHx8IFtdLCB0cnVlKSk7CiAgICB9LAogICAgaXM6IGZ1bmN0aW9uIChzZWxlY3RvcikgewogICAgICByZXR1cm4gISF3aW5ub3codGhpcywgLy8gSWYgdGhpcyBpcyBhIHBvc2l0aW9uYWwvcmVsYXRpdmUgc2VsZWN0b3IsIGNoZWNrIG1lbWJlcnNoaXAgaW4gdGhlIHJldHVybmVkIHNldAogICAgICAvLyBzbyAkKCJwOmZpcnN0IikuaXMoInA6bGFzdCIpIHdvbid0IHJldHVybiB0cnVlIGZvciBhIGRvYyB3aXRoIHR3byAicCIuCiAgICAgIHR5cGVvZiBzZWxlY3RvciA9PT0gJ3N0cmluZycgJiYgcm5lZWRzQ29udGV4dC50ZXN0KHNlbGVjdG9yKSA/IGpRdWVyeShzZWxlY3RvcikgOiBzZWxlY3RvciB8fCBbXSwgZmFsc2UpLmxlbmd0aDsKICAgIH0KICB9KTsKICAvLyBJbml0aWFsaXplIGEgalF1ZXJ5IG9iamVjdAogIC8vIEEgY2VudHJhbCByZWZlcmVuY2UgdG8gdGhlIHJvb3QgalF1ZXJ5KGRvY3VtZW50KQogIHZhciByb290alF1ZXJ5LAogICAgLy8gQSBzaW1wbGUgd2F5IHRvIGNoZWNrIGZvciBIVE1MIHN0cmluZ3MKICAgIC8vIFByaW9yaXRpemUgI2lkIG92ZXIgPHRhZz4gdG8gYXZvaWQgWFNTIHZpYSBsb2NhdGlvbi5oYXNoICgjOTUyMSkKICAgIC8vIFN0cmljdCBIVE1MIHJlY29nbml0aW9uICgjMTEyOTA6IG11c3Qgc3RhcnQgd2l0aCA8KQogICAgcnF1aWNrRXhwciA9IC9eKD86XHMqKDxbXHdcV10rPilbXj5dKnwjKFtcdy1dKikpJC8sIGluaXQgPSBqUXVlcnkuZm4uaW5pdCA9IGZ1bmN0aW9uIChzZWxlY3RvciwgY29udGV4dCkgewogICAgICB2YXIgbWF0Y2gsIGVsZW07CiAgICAgIC8vIEhBTkRMRTogJCgiIiksICQobnVsbCksICQodW5kZWZpbmVkKSwgJChmYWxzZSkKICAgICAgaWYgKCFzZWxlY3RvcikgewogICAgICAgIHJldHVybiB0aGlzOwogICAgICB9CiAgICAgIC8vIEhhbmRsZSBIVE1MIHN0cmluZ3MKICAgICAgaWYgKHR5cGVvZiBzZWxlY3RvciA9PT0gJ3N0cmluZycpIHsKICAgICAgICBpZiAoc2VsZWN0b3JbMF0gPT09ICc8JyAmJiBzZWxlY3RvcltzZWxlY3Rvci5sZW5ndGggLSAxXSA9PT0gJz4nICYmIHNlbGVjdG9yLmxlbmd0aCA+PSAzKSB7CiAgICAgICAgICAvLyBBc3N1bWUgdGhhdCBzdHJpbmdzIHRoYXQgc3RhcnQgYW5kIGVuZCB3aXRoIDw+IGFyZSBIVE1MIGFuZCBza2lwIHRoZSByZWdleCBjaGVjawogICAgICAgICAgbWF0Y2ggPSBbCiAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgIHNlbGVjdG9yLAogICAgICAgICAgICBudWxsCiAgICAgICAgICBdOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBtYXRjaCA9IHJxdWlja0V4cHIuZXhlYyhzZWxlY3Rvcik7CiAgICAgICAgfQogICAgICAgIC8vIE1hdGNoIGh0bWwgb3IgbWFrZSBzdXJlIG5vIGNvbnRleHQgaXMgc3BlY2lmaWVkIGZvciAjaWQKICAgICAgICBpZiAobWF0Y2ggJiYgKG1hdGNoWzFdIHx8ICFjb250ZXh0KSkgewogICAgICAgICAgLy8gSEFORExFOiAkKGh0bWwpIC0+ICQoYXJyYXkpCiAgICAgICAgICBpZiAobWF0Y2hbMV0pIHsKICAgICAgICAgICAgY29udGV4dCA9IGNvbnRleHQgaW5zdGFuY2VvZiBqUXVlcnkgPyBjb250ZXh0WzBdIDogY29udGV4dDsKICAgICAgICAgICAgLy8gc2NyaXB0cyBpcyB0cnVlIGZvciBiYWNrLWNvbXBhdAogICAgICAgICAgICAvLyBJbnRlbnRpb25hbGx5IGxldCB0aGUgZXJyb3IgYmUgdGhyb3duIGlmIHBhcnNlSFRNTCBpcyBub3QgcHJlc2VudAogICAgICAgICAgICBqUXVlcnkubWVyZ2UodGhpcywgalF1ZXJ5LnBhcnNlSFRNTChtYXRjaFsxXSwgY29udGV4dCAmJiBjb250ZXh0Lm5vZGVUeXBlID8gY29udGV4dC5vd25lckRvY3VtZW50IHx8IGNvbnRleHQgOiBkb2N1bWVudCwgdHJ1ZSkpOwogICAgICAgICAgICAvLyBIQU5ETEU6ICQoaHRtbCwgcHJvcHMpCiAgICAgICAgICAgIGlmIChyc2luZ2xlVGFnLnRlc3QobWF0Y2hbMV0pICYmIGpRdWVyeS5pc1BsYWluT2JqZWN0KGNvbnRleHQpKSB7CiAgICAgICAgICAgICAgZm9yIChtYXRjaCBpbiBjb250ZXh0KSB7CiAgICAgICAgICAgICAgICAvLyBQcm9wZXJ0aWVzIG9mIGNvbnRleHQgYXJlIGNhbGxlZCBhcyBtZXRob2RzIGlmIHBvc3NpYmxlCiAgICAgICAgICAgICAgICBpZiAoalF1ZXJ5LmlzRnVuY3Rpb24odGhpc1ttYXRjaF0pKSB7CiAgICAgICAgICAgICAgICAgIHRoaXNbbWF0Y2hdKGNvbnRleHRbbWF0Y2hdKTsgIC8vIC4uLmFuZCBvdGhlcndpc2Ugc2V0IGFzIGF0dHJpYnV0ZXMKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHRoaXMuYXR0cihtYXRjaCwgY29udGV4dFttYXRjaF0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGhpczsgIC8vIEhBTkRMRTogJCgjaWQpCiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBlbGVtID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQobWF0Y2hbMl0pOwogICAgICAgICAgICAvLyBDaGVjayBwYXJlbnROb2RlIHRvIGNhdGNoIHdoZW4gQmxhY2tiZXJyeSA0LjYgcmV0dXJucwogICAgICAgICAgICAvLyBub2RlcyB0aGF0IGFyZSBubyBsb25nZXIgaW4gdGhlIGRvY3VtZW50ICM2OTYzCiAgICAgICAgICAgIGlmIChlbGVtICYmIGVsZW0ucGFyZW50Tm9kZSkgewogICAgICAgICAgICAgIC8vIEluamVjdCB0aGUgZWxlbWVudCBkaXJlY3RseSBpbnRvIHRoZSBqUXVlcnkgb2JqZWN0CiAgICAgICAgICAgICAgdGhpcy5sZW5ndGggPSAxOwogICAgICAgICAgICAgIHRoaXNbMF0gPSBlbGVtOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuY29udGV4dCA9IGRvY3VtZW50OwogICAgICAgICAgICB0aGlzLnNlbGVjdG9yID0gc2VsZWN0b3I7CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgfSAgLy8gSEFORExFOiAkKGV4cHIsICQoLi4uKSkKICAgICAgICB9IGVsc2UgaWYgKCFjb250ZXh0IHx8IGNvbnRleHQuanF1ZXJ5KSB7CiAgICAgICAgICByZXR1cm4gKGNvbnRleHQgfHwgcm9vdGpRdWVyeSkuZmluZChzZWxlY3Rvcik7ICAvLyBIQU5ETEU6ICQoZXhwciwgY29udGV4dCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vICh3aGljaCBpcyBqdXN0IGVxdWl2YWxlbnQgdG86ICQoY29udGV4dCkuZmluZChleHByKQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXR1cm4gdGhpcy5jb25zdHJ1Y3Rvcihjb250ZXh0KS5maW5kKHNlbGVjdG9yKTsKICAgICAgICB9ICAvLyBIQU5ETEU6ICQoRE9NRWxlbWVudCkKICAgICAgfSBlbHNlIGlmIChzZWxlY3Rvci5ub2RlVHlwZSkgewogICAgICAgIHRoaXMuY29udGV4dCA9IHRoaXNbMF0gPSBzZWxlY3RvcjsKICAgICAgICB0aGlzLmxlbmd0aCA9IDE7CiAgICAgICAgcmV0dXJuIHRoaXM7ICAvLyBIQU5ETEU6ICQoZnVuY3Rpb24pCiAgICAgICAgICAgICAgICAgICAgICAvLyBTaG9ydGN1dCBmb3IgZG9jdW1lbnQgcmVhZHkKICAgICAgfSBlbHNlIGlmIChqUXVlcnkuaXNGdW5jdGlvbihzZWxlY3RvcikpIHsKICAgICAgICByZXR1cm4gdHlwZW9mIHJvb3RqUXVlcnkucmVhZHkgIT09ICd1bmRlZmluZWQnID8gcm9vdGpRdWVyeS5yZWFkeShzZWxlY3RvcikgOiAvLyBFeGVjdXRlIGltbWVkaWF0ZWx5IGlmIHJlYWR5IGlzIG5vdCBwcmVzZW50CiAgICAgICAgc2VsZWN0b3IoalF1ZXJ5KTsKICAgICAgfQogICAgICBpZiAoc2VsZWN0b3Iuc2VsZWN0b3IgIT09IHVuZGVmaW5lZCkgewogICAgICAgIHRoaXMuc2VsZWN0b3IgPSBzZWxlY3Rvci5zZWxlY3RvcjsKICAgICAgICB0aGlzLmNvbnRleHQgPSBzZWxlY3Rvci5jb250ZXh0OwogICAgICB9CiAgICAgIHJldHVybiBqUXVlcnkubWFrZUFycmF5KHNlbGVjdG9yLCB0aGlzKTsKICAgIH07CiAgLy8gR2l2ZSB0aGUgaW5pdCBmdW5jdGlvbiB0aGUgalF1ZXJ5IHByb3RvdHlwZSBmb3IgbGF0ZXIgaW5zdGFudGlhdGlvbgogIGluaXQucHJvdG90eXBlID0galF1ZXJ5LmZuOwogIC8vIEluaXRpYWxpemUgY2VudHJhbCByZWZlcmVuY2UKICByb290alF1ZXJ5ID0galF1ZXJ5KGRvY3VtZW50KTsKICB2YXIgcnBhcmVudHNwcmV2ID0gL14oPzpwYXJlbnRzfHByZXYoPzpVbnRpbHxBbGwpKS8sCiAgICAvLyBtZXRob2RzIGd1YXJhbnRlZWQgdG8gcHJvZHVjZSBhIHVuaXF1ZSBzZXQgd2hlbiBzdGFydGluZyBmcm9tIGEgdW5pcXVlIHNldAogICAgZ3VhcmFudGVlZFVuaXF1ZSA9IHsKICAgICAgY2hpbGRyZW46IHRydWUsCiAgICAgIGNvbnRlbnRzOiB0cnVlLAogICAgICBuZXh0OiB0cnVlLAogICAgICBwcmV2OiB0cnVlCiAgICB9OwogIGpRdWVyeS5leHRlbmQoewogICAgZGlyOiBmdW5jdGlvbiAoZWxlbSwgZGlyLCB1bnRpbCkgewogICAgICB2YXIgbWF0Y2hlZCA9IFtdLCB0cnVuY2F0ZSA9IHVudGlsICE9PSB1bmRlZmluZWQ7CiAgICAgIHdoaWxlICgoZWxlbSA9IGVsZW1bZGlyXSkgJiYgZWxlbS5ub2RlVHlwZSAhPT0gOSkgewogICAgICAgIGlmIChlbGVtLm5vZGVUeXBlID09PSAxKSB7CiAgICAgICAgICBpZiAodHJ1bmNhdGUgJiYgalF1ZXJ5KGVsZW0pLmlzKHVudGlsKSkgewogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICAgIG1hdGNoZWQucHVzaChlbGVtKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIG1hdGNoZWQ7CiAgICB9LAogICAgc2libGluZzogZnVuY3Rpb24gKG4sIGVsZW0pIHsKICAgICAgdmFyIG1hdGNoZWQgPSBbXTsKICAgICAgZm9yICg7IG47IG4gPSBuLm5leHRTaWJsaW5nKSB7CiAgICAgICAgaWYgKG4ubm9kZVR5cGUgPT09IDEgJiYgbiAhPT0gZWxlbSkgewogICAgICAgICAgbWF0Y2hlZC5wdXNoKG4pOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gbWF0Y2hlZDsKICAgIH0KICB9KTsKICBqUXVlcnkuZm4uZXh0ZW5kKHsKICAgIGhhczogZnVuY3Rpb24gKHRhcmdldCkgewogICAgICB2YXIgdGFyZ2V0cyA9IGpRdWVyeSh0YXJnZXQsIHRoaXMpLCBsID0gdGFyZ2V0cy5sZW5ndGg7CiAgICAgIHJldHVybiB0aGlzLmZpbHRlcihmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIGkgPSAwOwogICAgICAgIGZvciAoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgICBpZiAoalF1ZXJ5LmNvbnRhaW5zKHRoaXMsIHRhcmdldHNbaV0pKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICB9LAogICAgY2xvc2VzdDogZnVuY3Rpb24gKHNlbGVjdG9ycywgY29udGV4dCkgewogICAgICB2YXIgY3VyLCBpID0gMCwgbCA9IHRoaXMubGVuZ3RoLCBtYXRjaGVkID0gW10sIHBvcyA9IHJuZWVkc0NvbnRleHQudGVzdChzZWxlY3RvcnMpIHx8IHR5cGVvZiBzZWxlY3RvcnMgIT09ICdzdHJpbmcnID8galF1ZXJ5KHNlbGVjdG9ycywgY29udGV4dCB8fCB0aGlzLmNvbnRleHQpIDogMDsKICAgICAgZm9yICg7IGkgPCBsOyBpKyspIHsKICAgICAgICBmb3IgKGN1ciA9IHRoaXNbaV07IGN1ciAmJiBjdXIgIT09IGNvbnRleHQ7IGN1ciA9IGN1ci5wYXJlbnROb2RlKSB7CiAgICAgICAgICAvLyBBbHdheXMgc2tpcCBkb2N1bWVudCBmcmFnbWVudHMKICAgICAgICAgIGlmIChjdXIubm9kZVR5cGUgPCAxMSAmJiAocG9zID8gcG9zLmluZGV4KGN1cikgPiAtMSA6IC8vIERvbid0IHBhc3Mgbm9uLWVsZW1lbnRzIHRvIFNpenpsZQogICAgICAgICAgICBjdXIubm9kZVR5cGUgPT09IDEgJiYgalF1ZXJ5LmZpbmQubWF0Y2hlc1NlbGVjdG9yKGN1ciwgc2VsZWN0b3JzKSkpIHsKICAgICAgICAgICAgbWF0Y2hlZC5wdXNoKGN1cik7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gdGhpcy5wdXNoU3RhY2sobWF0Y2hlZC5sZW5ndGggPiAxID8galF1ZXJ5LnVuaXF1ZShtYXRjaGVkKSA6IG1hdGNoZWQpOwogICAgfSwKICAgIC8vIERldGVybWluZSB0aGUgcG9zaXRpb24gb2YgYW4gZWxlbWVudCB3aXRoaW4KICAgIC8vIHRoZSBtYXRjaGVkIHNldCBvZiBlbGVtZW50cwogICAgaW5kZXg6IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgIC8vIE5vIGFyZ3VtZW50LCByZXR1cm4gaW5kZXggaW4gcGFyZW50CiAgICAgIGlmICghZWxlbSkgewogICAgICAgIHJldHVybiB0aGlzWzBdICYmIHRoaXNbMF0ucGFyZW50Tm9kZSA/IHRoaXMuZmlyc3QoKS5wcmV2QWxsKCkubGVuZ3RoIDogLTE7CiAgICAgIH0KICAgICAgLy8gaW5kZXggaW4gc2VsZWN0b3IKICAgICAgaWYgKHR5cGVvZiBlbGVtID09PSAnc3RyaW5nJykgewogICAgICAgIHJldHVybiBpbmRleE9mLmNhbGwoalF1ZXJ5KGVsZW0pLCB0aGlzWzBdKTsKICAgICAgfQogICAgICAvLyBMb2NhdGUgdGhlIHBvc2l0aW9uIG9mIHRoZSBkZXNpcmVkIGVsZW1lbnQKICAgICAgcmV0dXJuIGluZGV4T2YuY2FsbCh0aGlzLCAvLyBJZiBpdCByZWNlaXZlcyBhIGpRdWVyeSBvYmplY3QsIHRoZSBmaXJzdCBlbGVtZW50IGlzIHVzZWQKICAgICAgZWxlbS5qcXVlcnkgPyBlbGVtWzBdIDogZWxlbSk7CiAgICB9LAogICAgYWRkOiBmdW5jdGlvbiAoc2VsZWN0b3IsIGNvbnRleHQpIHsKICAgICAgcmV0dXJuIHRoaXMucHVzaFN0YWNrKGpRdWVyeS51bmlxdWUoalF1ZXJ5Lm1lcmdlKHRoaXMuZ2V0KCksIGpRdWVyeShzZWxlY3RvciwgY29udGV4dCkpKSk7CiAgICB9LAogICAgYWRkQmFjazogZnVuY3Rpb24gKHNlbGVjdG9yKSB7CiAgICAgIHJldHVybiB0aGlzLmFkZChzZWxlY3RvciA9PSBudWxsID8gdGhpcy5wcmV2T2JqZWN0IDogdGhpcy5wcmV2T2JqZWN0LmZpbHRlcihzZWxlY3RvcikpOwogICAgfQogIH0pOwogIGZ1bmN0aW9uIHNpYmxpbmcoY3VyLCBkaXIpIHsKICAgIHdoaWxlICgoY3VyID0gY3VyW2Rpcl0pICYmIGN1ci5ub2RlVHlwZSAhPT0gMSkgewogICAgfQogICAgcmV0dXJuIGN1cjsKICB9CiAgalF1ZXJ5LmVhY2goewogICAgcGFyZW50OiBmdW5jdGlvbiAoZWxlbSkgewogICAgICB2YXIgcGFyZW50ID0gZWxlbS5wYXJlbnROb2RlOwogICAgICByZXR1cm4gcGFyZW50ICYmIHBhcmVudC5ub2RlVHlwZSAhPT0gMTEgPyBwYXJlbnQgOiBudWxsOwogICAgfSwKICAgIHBhcmVudHM6IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgIHJldHVybiBqUXVlcnkuZGlyKGVsZW0sICdwYXJlbnROb2RlJyk7CiAgICB9LAogICAgcGFyZW50c1VudGlsOiBmdW5jdGlvbiAoZWxlbSwgaSwgdW50aWwpIHsKICAgICAgcmV0dXJuIGpRdWVyeS5kaXIoZWxlbSwgJ3BhcmVudE5vZGUnLCB1bnRpbCk7CiAgICB9LAogICAgbmV4dDogZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgcmV0dXJuIHNpYmxpbmcoZWxlbSwgJ25leHRTaWJsaW5nJyk7CiAgICB9LAogICAgcHJldjogZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgcmV0dXJuIHNpYmxpbmcoZWxlbSwgJ3ByZXZpb3VzU2libGluZycpOwogICAgfSwKICAgIG5leHRBbGw6IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgIHJldHVybiBqUXVlcnkuZGlyKGVsZW0sICduZXh0U2libGluZycpOwogICAgfSwKICAgIHByZXZBbGw6IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgIHJldHVybiBqUXVlcnkuZGlyKGVsZW0sICdwcmV2aW91c1NpYmxpbmcnKTsKICAgIH0sCiAgICBuZXh0VW50aWw6IGZ1bmN0aW9uIChlbGVtLCBpLCB1bnRpbCkgewogICAgICByZXR1cm4galF1ZXJ5LmRpcihlbGVtLCAnbmV4dFNpYmxpbmcnLCB1bnRpbCk7CiAgICB9LAogICAgcHJldlVudGlsOiBmdW5jdGlvbiAoZWxlbSwgaSwgdW50aWwpIHsKICAgICAgcmV0dXJuIGpRdWVyeS5kaXIoZWxlbSwgJ3ByZXZpb3VzU2libGluZycsIHVudGlsKTsKICAgIH0sCiAgICBzaWJsaW5nczogZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgcmV0dXJuIGpRdWVyeS5zaWJsaW5nKChlbGVtLnBhcmVudE5vZGUgfHwge30pLmZpcnN0Q2hpbGQsIGVsZW0pOwogICAgfSwKICAgIGNoaWxkcmVuOiBmdW5jdGlvbiAoZWxlbSkgewogICAgICByZXR1cm4galF1ZXJ5LnNpYmxpbmcoZWxlbS5maXJzdENoaWxkKTsKICAgIH0sCiAgICBjb250ZW50czogZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgcmV0dXJuIGVsZW0uY29udGVudERvY3VtZW50IHx8IGpRdWVyeS5tZXJnZShbXSwgZWxlbS5jaGlsZE5vZGVzKTsKICAgIH0KICB9LCBmdW5jdGlvbiAobmFtZSwgZm4pIHsKICAgIGpRdWVyeS5mbltuYW1lXSA9IGZ1bmN0aW9uICh1bnRpbCwgc2VsZWN0b3IpIHsKICAgICAgdmFyIG1hdGNoZWQgPSBqUXVlcnkubWFwKHRoaXMsIGZuLCB1bnRpbCk7CiAgICAgIGlmIChuYW1lLnNsaWNlKC01KSAhPT0gJ1VudGlsJykgewogICAgICAgIHNlbGVjdG9yID0gdW50aWw7CiAgICAgIH0KICAgICAgaWYgKHNlbGVjdG9yICYmIHR5cGVvZiBzZWxlY3RvciA9PT0gJ3N0cmluZycpIHsKICAgICAgICBtYXRjaGVkID0galF1ZXJ5LmZpbHRlcihzZWxlY3RvciwgbWF0Y2hlZCk7CiAgICAgIH0KICAgICAgaWYgKHRoaXMubGVuZ3RoID4gMSkgewogICAgICAgIC8vIFJlbW92ZSBkdXBsaWNhdGVzCiAgICAgICAgaWYgKCFndWFyYW50ZWVkVW5pcXVlW25hbWVdKSB7CiAgICAgICAgICBqUXVlcnkudW5pcXVlKG1hdGNoZWQpOwogICAgICAgIH0KICAgICAgICAvLyBSZXZlcnNlIG9yZGVyIGZvciBwYXJlbnRzKiBhbmQgcHJldi1kZXJpdmF0aXZlcwogICAgICAgIGlmIChycGFyZW50c3ByZXYudGVzdChuYW1lKSkgewogICAgICAgICAgbWF0Y2hlZC5yZXZlcnNlKCk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiB0aGlzLnB1c2hTdGFjayhtYXRjaGVkKTsKICAgIH07CiAgfSk7CiAgdmFyIHJub3R3aGl0ZSA9IC9cUysvZzsKICAvLyBTdHJpbmcgdG8gT2JqZWN0IG9wdGlvbnMgZm9ybWF0IGNhY2hlCiAgdmFyIG9wdGlvbnNDYWNoZSA9IHt9OwogIC8vIENvbnZlcnQgU3RyaW5nLWZvcm1hdHRlZCBvcHRpb25zIGludG8gT2JqZWN0LWZvcm1hdHRlZCBvbmVzIGFuZCBzdG9yZSBpbiBjYWNoZQogIGZ1bmN0aW9uIGNyZWF0ZU9wdGlvbnMob3B0aW9ucykgewogICAgdmFyIG9iamVjdCA9IG9wdGlvbnNDYWNoZVtvcHRpb25zXSA9IHt9OwogICAgalF1ZXJ5LmVhY2gob3B0aW9ucy5tYXRjaChybm90d2hpdGUpIHx8IFtdLCBmdW5jdGlvbiAoXywgZmxhZykgewogICAgICBvYmplY3RbZmxhZ10gPSB0cnVlOwogICAgfSk7CiAgICByZXR1cm4gb2JqZWN0OwogIH0KICAvKgogICAqIENyZWF0ZSBhIGNhbGxiYWNrIGxpc3QgdXNpbmcgdGhlIGZvbGxvd2luZyBwYXJhbWV0ZXJzOgogICAqCiAgICoJb3B0aW9uczogYW4gb3B0aW9uYWwgbGlzdCBvZiBzcGFjZS1zZXBhcmF0ZWQgb3B0aW9ucyB0aGF0IHdpbGwgY2hhbmdlIGhvdwogICAqCQkJdGhlIGNhbGxiYWNrIGxpc3QgYmVoYXZlcyBvciBhIG1vcmUgdHJhZGl0aW9uYWwgb3B0aW9uIG9iamVjdAogICAqCiAgICogQnkgZGVmYXVsdCBhIGNhbGxiYWNrIGxpc3Qgd2lsbCBhY3QgbGlrZSBhbiBldmVudCBjYWxsYmFjayBsaXN0IGFuZCBjYW4gYmUKICAgKiAiZmlyZWQiIG11bHRpcGxlIHRpbWVzLgogICAqCiAgICogUG9zc2libGUgb3B0aW9uczoKICAgKgogICAqCW9uY2U6CQkJd2lsbCBlbnN1cmUgdGhlIGNhbGxiYWNrIGxpc3QgY2FuIG9ubHkgYmUgZmlyZWQgb25jZSAobGlrZSBhIERlZmVycmVkKQogICAqCiAgICoJbWVtb3J5OgkJCXdpbGwga2VlcCB0cmFjayBvZiBwcmV2aW91cyB2YWx1ZXMgYW5kIHdpbGwgY2FsbCBhbnkgY2FsbGJhY2sgYWRkZWQKICAgKgkJCQkJYWZ0ZXIgdGhlIGxpc3QgaGFzIGJlZW4gZmlyZWQgcmlnaHQgYXdheSB3aXRoIHRoZSBsYXRlc3QgIm1lbW9yaXplZCIKICAgKgkJCQkJdmFsdWVzIChsaWtlIGEgRGVmZXJyZWQpCiAgICoKICAgKgl1bmlxdWU6CQkJd2lsbCBlbnN1cmUgYSBjYWxsYmFjayBjYW4gb25seSBiZSBhZGRlZCBvbmNlIChubyBkdXBsaWNhdGUgaW4gdGhlIGxpc3QpCiAgICoKICAgKglzdG9wT25GYWxzZToJaW50ZXJydXB0IGNhbGxpbmdzIHdoZW4gYSBjYWxsYmFjayByZXR1cm5zIGZhbHNlCiAgICoKICAgKi8KICBqUXVlcnkuQ2FsbGJhY2tzID0gZnVuY3Rpb24gKG9wdGlvbnMpIHsKICAgIC8vIENvbnZlcnQgb3B0aW9ucyBmcm9tIFN0cmluZy1mb3JtYXR0ZWQgdG8gT2JqZWN0LWZvcm1hdHRlZCBpZiBuZWVkZWQKICAgIC8vICh3ZSBjaGVjayBpbiBjYWNoZSBmaXJzdCkKICAgIG9wdGlvbnMgPSB0eXBlb2Ygb3B0aW9ucyA9PT0gJ3N0cmluZycgPyBvcHRpb25zQ2FjaGVbb3B0aW9uc10gfHwgY3JlYXRlT3B0aW9ucyhvcHRpb25zKSA6IGpRdWVyeS5leHRlbmQoe30sIG9wdGlvbnMpOwogICAgdmFyCiAgICAgIC8vIExhc3QgZmlyZSB2YWx1ZSAoZm9yIG5vbi1mb3JnZXR0YWJsZSBsaXN0cykKICAgICAgbWVtb3J5LAogICAgICAvLyBGbGFnIHRvIGtub3cgaWYgbGlzdCB3YXMgYWxyZWFkeSBmaXJlZAogICAgICBmaXJlZCwKICAgICAgLy8gRmxhZyB0byBrbm93IGlmIGxpc3QgaXMgY3VycmVudGx5IGZpcmluZwogICAgICBmaXJpbmcsCiAgICAgIC8vIEZpcnN0IGNhbGxiYWNrIHRvIGZpcmUgKHVzZWQgaW50ZXJuYWxseSBieSBhZGQgYW5kIGZpcmVXaXRoKQogICAgICBmaXJpbmdTdGFydCwKICAgICAgLy8gRW5kIG9mIHRoZSBsb29wIHdoZW4gZmlyaW5nCiAgICAgIGZpcmluZ0xlbmd0aCwKICAgICAgLy8gSW5kZXggb2YgY3VycmVudGx5IGZpcmluZyBjYWxsYmFjayAobW9kaWZpZWQgYnkgcmVtb3ZlIGlmIG5lZWRlZCkKICAgICAgZmlyaW5nSW5kZXgsCiAgICAgIC8vIEFjdHVhbCBjYWxsYmFjayBsaXN0CiAgICAgIGxpc3QgPSBbXSwKICAgICAgLy8gU3RhY2sgb2YgZmlyZSBjYWxscyBmb3IgcmVwZWF0YWJsZSBsaXN0cwogICAgICBzdGFjayA9ICFvcHRpb25zLm9uY2UgJiYgW10sCiAgICAgIC8vIEZpcmUgY2FsbGJhY2tzCiAgICAgIGZpcmUgPSBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgIG1lbW9yeSA9IG9wdGlvbnMubWVtb3J5ICYmIGRhdGE7CiAgICAgICAgZmlyZWQgPSB0cnVlOwogICAgICAgIGZpcmluZ0luZGV4ID0gZmlyaW5nU3RhcnQgfHwgMDsKICAgICAgICBmaXJpbmdTdGFydCA9IDA7CiAgICAgICAgZmlyaW5nTGVuZ3RoID0gbGlzdC5sZW5ndGg7CiAgICAgICAgZmlyaW5nID0gdHJ1ZTsKICAgICAgICBmb3IgKDsgbGlzdCAmJiBmaXJpbmdJbmRleCA8IGZpcmluZ0xlbmd0aDsgZmlyaW5nSW5kZXgrKykgewogICAgICAgICAgaWYgKGxpc3RbZmlyaW5nSW5kZXhdLmFwcGx5KGRhdGFbMF0sIGRhdGFbMV0pID09PSBmYWxzZSAmJiBvcHRpb25zLnN0b3BPbkZhbHNlKSB7CiAgICAgICAgICAgIG1lbW9yeSA9IGZhbHNlOwogICAgICAgICAgICAvLyBUbyBwcmV2ZW50IGZ1cnRoZXIgY2FsbHMgdXNpbmcgYWRkCiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmaXJpbmcgPSBmYWxzZTsKICAgICAgICBpZiAobGlzdCkgewogICAgICAgICAgaWYgKHN0YWNrKSB7CiAgICAgICAgICAgIGlmIChzdGFjay5sZW5ndGgpIHsKICAgICAgICAgICAgICBmaXJlKHN0YWNrLnNoaWZ0KCkpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgaWYgKG1lbW9yeSkgewogICAgICAgICAgICBsaXN0ID0gW107CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzZWxmLmRpc2FibGUoKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgIC8vIEFjdHVhbCBDYWxsYmFja3Mgb2JqZWN0CiAgICAgIHNlbGYgPSB7CiAgICAgICAgLy8gQWRkIGEgY2FsbGJhY2sgb3IgYSBjb2xsZWN0aW9uIG9mIGNhbGxiYWNrcyB0byB0aGUgbGlzdAogICAgICAgIGFkZDogZnVuY3Rpb24gKCkgewogICAgICAgICAgaWYgKGxpc3QpIHsKICAgICAgICAgICAgLy8gRmlyc3QsIHdlIHNhdmUgdGhlIGN1cnJlbnQgbGVuZ3RoCiAgICAgICAgICAgIHZhciBzdGFydCA9IGxpc3QubGVuZ3RoOwogICAgICAgICAgICAoZnVuY3Rpb24gYWRkKGFyZ3MpIHsKICAgICAgICAgICAgICBqUXVlcnkuZWFjaChhcmdzLCBmdW5jdGlvbiAoXywgYXJnKSB7CiAgICAgICAgICAgICAgICB2YXIgdHlwZSA9IGpRdWVyeS50eXBlKGFyZyk7CiAgICAgICAgICAgICAgICBpZiAodHlwZSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICAgICAgICBpZiAoIW9wdGlvbnMudW5pcXVlIHx8ICFzZWxmLmhhcyhhcmcpKSB7CiAgICAgICAgICAgICAgICAgICAgbGlzdC5wdXNoKGFyZyk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoYXJnICYmIGFyZy5sZW5ndGggJiYgdHlwZSAhPT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgICAgICAgLy8gSW5zcGVjdCByZWN1cnNpdmVseQogICAgICAgICAgICAgICAgICBhZGQoYXJnKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfShhcmd1bWVudHMpKTsKICAgICAgICAgICAgLy8gRG8gd2UgbmVlZCB0byBhZGQgdGhlIGNhbGxiYWNrcyB0byB0aGUKICAgICAgICAgICAgLy8gY3VycmVudCBmaXJpbmcgYmF0Y2g/CiAgICAgICAgICAgIGlmIChmaXJpbmcpIHsKICAgICAgICAgICAgICBmaXJpbmdMZW5ndGggPSBsaXN0Lmxlbmd0aDsgIC8vIFdpdGggbWVtb3J5LCBpZiB3ZSdyZSBub3QgZmlyaW5nIHRoZW4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHdlIHNob3VsZCBjYWxsIHJpZ2h0IGF3YXkKICAgICAgICAgICAgfSBlbHNlIGlmIChtZW1vcnkpIHsKICAgICAgICAgICAgICBmaXJpbmdTdGFydCA9IHN0YXJ0OwogICAgICAgICAgICAgIGZpcmUobWVtb3J5KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSwKICAgICAgICAvLyBSZW1vdmUgYSBjYWxsYmFjayBmcm9tIHRoZSBsaXN0CiAgICAgICAgcmVtb3ZlOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBpZiAobGlzdCkgewogICAgICAgICAgICBqUXVlcnkuZWFjaChhcmd1bWVudHMsIGZ1bmN0aW9uIChfLCBhcmcpIHsKICAgICAgICAgICAgICB2YXIgaW5kZXg7CiAgICAgICAgICAgICAgd2hpbGUgKChpbmRleCA9IGpRdWVyeS5pbkFycmF5KGFyZywgbGlzdCwgaW5kZXgpKSA+IC0xKSB7CiAgICAgICAgICAgICAgICBsaXN0LnNwbGljZShpbmRleCwgMSk7CiAgICAgICAgICAgICAgICAvLyBIYW5kbGUgZmlyaW5nIGluZGV4ZXMKICAgICAgICAgICAgICAgIGlmIChmaXJpbmcpIHsKICAgICAgICAgICAgICAgICAgaWYgKGluZGV4IDw9IGZpcmluZ0xlbmd0aCkgewogICAgICAgICAgICAgICAgICAgIGZpcmluZ0xlbmd0aC0tOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmIChpbmRleCA8PSBmaXJpbmdJbmRleCkgewogICAgICAgICAgICAgICAgICAgIGZpcmluZ0luZGV4LS07CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSwKICAgICAgICAvLyBDaGVjayBpZiBhIGdpdmVuIGNhbGxiYWNrIGlzIGluIHRoZSBsaXN0LgogICAgICAgIC8vIElmIG5vIGFyZ3VtZW50IGlzIGdpdmVuLCByZXR1cm4gd2hldGhlciBvciBub3QgbGlzdCBoYXMgY2FsbGJhY2tzIGF0dGFjaGVkLgogICAgICAgIGhhczogZnVuY3Rpb24gKGZuKSB7CiAgICAgICAgICByZXR1cm4gZm4gPyBqUXVlcnkuaW5BcnJheShmbiwgbGlzdCkgPiAtMSA6ICEhKGxpc3QgJiYgbGlzdC5sZW5ndGgpOwogICAgICAgIH0sCiAgICAgICAgLy8gUmVtb3ZlIGFsbCBjYWxsYmFja3MgZnJvbSB0aGUgbGlzdAogICAgICAgIGVtcHR5OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBsaXN0ID0gW107CiAgICAgICAgICBmaXJpbmdMZW5ndGggPSAwOwogICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSwKICAgICAgICAvLyBIYXZlIHRoZSBsaXN0IGRvIG5vdGhpbmcgYW55bW9yZQogICAgICAgIGRpc2FibGU6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGxpc3QgPSBzdGFjayA9IG1lbW9yeSA9IHVuZGVmaW5lZDsKICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCiAgICAgICAgLy8gSXMgaXQgZGlzYWJsZWQ/CiAgICAgICAgZGlzYWJsZWQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHJldHVybiAhbGlzdDsKICAgICAgICB9LAogICAgICAgIC8vIExvY2sgdGhlIGxpc3QgaW4gaXRzIGN1cnJlbnQgc3RhdGUKICAgICAgICBsb2NrOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBzdGFjayA9IHVuZGVmaW5lZDsKICAgICAgICAgIGlmICghbWVtb3J5KSB7CiAgICAgICAgICAgIHNlbGYuZGlzYWJsZSgpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSwKICAgICAgICAvLyBJcyBpdCBsb2NrZWQ/CiAgICAgICAgbG9ja2VkOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICByZXR1cm4gIXN0YWNrOwogICAgICAgIH0sCiAgICAgICAgLy8gQ2FsbCBhbGwgY2FsbGJhY2tzIHdpdGggdGhlIGdpdmVuIGNvbnRleHQgYW5kIGFyZ3VtZW50cwogICAgICAgIGZpcmVXaXRoOiBmdW5jdGlvbiAoY29udGV4dCwgYXJncykgewogICAgICAgICAgaWYgKGxpc3QgJiYgKCFmaXJlZCB8fCBzdGFjaykpIHsKICAgICAgICAgICAgYXJncyA9IGFyZ3MgfHwgW107CiAgICAgICAgICAgIGFyZ3MgPSBbCiAgICAgICAgICAgICAgY29udGV4dCwKICAgICAgICAgICAgICBhcmdzLnNsaWNlID8gYXJncy5zbGljZSgpIDogYXJncwogICAgICAgICAgICBdOwogICAgICAgICAgICBpZiAoZmlyaW5nKSB7CiAgICAgICAgICAgICAgc3RhY2sucHVzaChhcmdzKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBmaXJlKGFyZ3MpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9LAogICAgICAgIC8vIENhbGwgYWxsIHRoZSBjYWxsYmFja3Mgd2l0aCB0aGUgZ2l2ZW4gYXJndW1lbnRzCiAgICAgICAgZmlyZTogZnVuY3Rpb24gKCkgewogICAgICAgICAgc2VsZi5maXJlV2l0aCh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSwKICAgICAgICAvLyBUbyBrbm93IGlmIHRoZSBjYWxsYmFja3MgaGF2ZSBhbHJlYWR5IGJlZW4gY2FsbGVkIGF0IGxlYXN0IG9uY2UKICAgICAgICBmaXJlZDogZnVuY3Rpb24gKCkgewogICAgICAgICAgcmV0dXJuICEhZmlyZWQ7CiAgICAgICAgfQogICAgICB9OwogICAgcmV0dXJuIHNlbGY7CiAgfTsKICBqUXVlcnkuZXh0ZW5kKHsKICAgIERlZmVycmVkOiBmdW5jdGlvbiAoZnVuYykgewogICAgICB2YXIgdHVwbGVzID0gWwogICAgICAgICAgLy8gYWN0aW9uLCBhZGQgbGlzdGVuZXIsIGxpc3RlbmVyIGxpc3QsIGZpbmFsIHN0YXRlCiAgICAgICAgICBbCiAgICAgICAgICAgICdyZXNvbHZlJywKICAgICAgICAgICAgJ2RvbmUnLAogICAgICAgICAgICBqUXVlcnkuQ2FsbGJhY2tzKCdvbmNlIG1lbW9yeScpLAogICAgICAgICAgICAncmVzb2x2ZWQnCiAgICAgICAgICBdLAogICAgICAgICAgWwogICAgICAgICAgICAncmVqZWN0JywKICAgICAgICAgICAgJ2ZhaWwnLAogICAgICAgICAgICBqUXVlcnkuQ2FsbGJhY2tzKCdvbmNlIG1lbW9yeScpLAogICAgICAgICAgICAncmVqZWN0ZWQnCiAgICAgICAgICBdLAogICAgICAgICAgWwogICAgICAgICAgICAnbm90aWZ5JywKICAgICAgICAgICAgJ3Byb2dyZXNzJywKICAgICAgICAgICAgalF1ZXJ5LkNhbGxiYWNrcygnbWVtb3J5JykKICAgICAgICAgIF0KICAgICAgICBdLCBzdGF0ZSA9ICdwZW5kaW5nJywgcHJvbWlzZSA9IHsKICAgICAgICAgIHN0YXRlOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiBzdGF0ZTsKICAgICAgICAgIH0sCiAgICAgICAgICBhbHdheXM6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgZGVmZXJyZWQuZG9uZShhcmd1bWVudHMpLmZhaWwoYXJndW1lbnRzKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICB9LAogICAgICAgICAgdGhlbjogZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgZm5zID0gYXJndW1lbnRzOwogICAgICAgICAgICByZXR1cm4galF1ZXJ5LkRlZmVycmVkKGZ1bmN0aW9uIChuZXdEZWZlcikgewogICAgICAgICAgICAgIGpRdWVyeS5lYWNoKHR1cGxlcywgZnVuY3Rpb24gKGksIHR1cGxlKSB7CiAgICAgICAgICAgICAgICB2YXIgZm4gPSBqUXVlcnkuaXNGdW5jdGlvbihmbnNbaV0pICYmIGZuc1tpXTsKICAgICAgICAgICAgICAgIC8vIGRlZmVycmVkWyBkb25lIHwgZmFpbCB8IHByb2dyZXNzIF0gZm9yIGZvcndhcmRpbmcgYWN0aW9ucyB0byBuZXdEZWZlcgogICAgICAgICAgICAgICAgZGVmZXJyZWRbdHVwbGVbMV1dKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgdmFyIHJldHVybmVkID0gZm4gJiYgZm4uYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgICAgICAgICAgaWYgKHJldHVybmVkICYmIGpRdWVyeS5pc0Z1bmN0aW9uKHJldHVybmVkLnByb21pc2UpKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuZWQucHJvbWlzZSgpLmRvbmUobmV3RGVmZXIucmVzb2x2ZSkuZmFpbChuZXdEZWZlci5yZWplY3QpLnByb2dyZXNzKG5ld0RlZmVyLm5vdGlmeSk7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgbmV3RGVmZXJbdHVwbGVbMF0gKyAnV2l0aCddKHRoaXMgPT09IHByb21pc2UgPyBuZXdEZWZlci5wcm9taXNlKCkgOiB0aGlzLCBmbiA/IFtyZXR1cm5lZF0gOiBhcmd1bWVudHMpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICBmbnMgPSBudWxsOwogICAgICAgICAgICB9KS5wcm9taXNlKCk7CiAgICAgICAgICB9LAogICAgICAgICAgLy8gR2V0IGEgcHJvbWlzZSBmb3IgdGhpcyBkZWZlcnJlZAogICAgICAgICAgLy8gSWYgb2JqIGlzIHByb3ZpZGVkLCB0aGUgcHJvbWlzZSBhc3BlY3QgaXMgYWRkZWQgdG8gdGhlIG9iamVjdAogICAgICAgICAgcHJvbWlzZTogZnVuY3Rpb24gKG9iaikgewogICAgICAgICAgICByZXR1cm4gb2JqICE9IG51bGwgPyBqUXVlcnkuZXh0ZW5kKG9iaiwgcHJvbWlzZSkgOiBwcm9taXNlOwogICAgICAgICAgfQogICAgICAgIH0sIGRlZmVycmVkID0ge307CiAgICAgIC8vIEtlZXAgcGlwZSBmb3IgYmFjay1jb21wYXQKICAgICAgcHJvbWlzZS5waXBlID0gcHJvbWlzZS50aGVuOwogICAgICAvLyBBZGQgbGlzdC1zcGVjaWZpYyBtZXRob2RzCiAgICAgIGpRdWVyeS5lYWNoKHR1cGxlcywgZnVuY3Rpb24gKGksIHR1cGxlKSB7CiAgICAgICAgdmFyIGxpc3QgPSB0dXBsZVsyXSwgc3RhdGVTdHJpbmcgPSB0dXBsZVszXTsKICAgICAgICAvLyBwcm9taXNlWyBkb25lIHwgZmFpbCB8IHByb2dyZXNzIF0gPSBsaXN0LmFkZAogICAgICAgIHByb21pc2VbdHVwbGVbMV1dID0gbGlzdC5hZGQ7CiAgICAgICAgLy8gSGFuZGxlIHN0YXRlCiAgICAgICAgaWYgKHN0YXRlU3RyaW5nKSB7CiAgICAgICAgICBsaXN0LmFkZChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIC8vIHN0YXRlID0gWyByZXNvbHZlZCB8IHJlamVjdGVkIF0KICAgICAgICAgICAgc3RhdGUgPSBzdGF0ZVN0cmluZzsgIC8vIFsgcmVqZWN0X2xpc3QgfCByZXNvbHZlX2xpc3QgXS5kaXNhYmxlOyBwcm9ncmVzc19saXN0LmxvY2sKICAgICAgICAgIH0sIHR1cGxlc1tpIF4gMV1bMl0uZGlzYWJsZSwgdHVwbGVzWzJdWzJdLmxvY2spOwogICAgICAgIH0KICAgICAgICAvLyBkZWZlcnJlZFsgcmVzb2x2ZSB8IHJlamVjdCB8IG5vdGlmeSBdCiAgICAgICAgZGVmZXJyZWRbdHVwbGVbMF1dID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgZGVmZXJyZWRbdHVwbGVbMF0gKyAnV2l0aCddKHRoaXMgPT09IGRlZmVycmVkID8gcHJvbWlzZSA6IHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9OwogICAgICAgIGRlZmVycmVkW3R1cGxlWzBdICsgJ1dpdGgnXSA9IGxpc3QuZmlyZVdpdGg7CiAgICAgIH0pOwogICAgICAvLyBNYWtlIHRoZSBkZWZlcnJlZCBhIHByb21pc2UKICAgICAgcHJvbWlzZS5wcm9taXNlKGRlZmVycmVkKTsKICAgICAgLy8gQ2FsbCBnaXZlbiBmdW5jIGlmIGFueQogICAgICBpZiAoZnVuYykgewogICAgICAgIGZ1bmMuY2FsbChkZWZlcnJlZCwgZGVmZXJyZWQpOwogICAgICB9CiAgICAgIC8vIEFsbCBkb25lIQogICAgICByZXR1cm4gZGVmZXJyZWQ7CiAgICB9LAogICAgLy8gRGVmZXJyZWQgaGVscGVyCiAgICB3aGVuOiBmdW5jdGlvbiAoc3Vib3JkaW5hdGUpIHsKICAgICAgdmFyIGkgPSAwLCByZXNvbHZlVmFsdWVzID0gc2xpY2UuY2FsbChhcmd1bWVudHMpLCBsZW5ndGggPSByZXNvbHZlVmFsdWVzLmxlbmd0aCwKICAgICAgICAvLyB0aGUgY291bnQgb2YgdW5jb21wbGV0ZWQgc3Vib3JkaW5hdGVzCiAgICAgICAgcmVtYWluaW5nID0gbGVuZ3RoICE9PSAxIHx8IHN1Ym9yZGluYXRlICYmIGpRdWVyeS5pc0Z1bmN0aW9uKHN1Ym9yZGluYXRlLnByb21pc2UpID8gbGVuZ3RoIDogMCwKICAgICAgICAvLyB0aGUgbWFzdGVyIERlZmVycmVkLiBJZiByZXNvbHZlVmFsdWVzIGNvbnNpc3Qgb2Ygb25seSBhIHNpbmdsZSBEZWZlcnJlZCwganVzdCB1c2UgdGhhdC4KICAgICAgICBkZWZlcnJlZCA9IHJlbWFpbmluZyA9PT0gMSA/IHN1Ym9yZGluYXRlIDogalF1ZXJ5LkRlZmVycmVkKCksCiAgICAgICAgLy8gVXBkYXRlIGZ1bmN0aW9uIGZvciBib3RoIHJlc29sdmUgYW5kIHByb2dyZXNzIHZhbHVlcwogICAgICAgIHVwZGF0ZUZ1bmMgPSBmdW5jdGlvbiAoaSwgY29udGV4dHMsIHZhbHVlcykgewogICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICBjb250ZXh0c1tpXSA9IHRoaXM7CiAgICAgICAgICAgIHZhbHVlc1tpXSA9IGFyZ3VtZW50cy5sZW5ndGggPiAxID8gc2xpY2UuY2FsbChhcmd1bWVudHMpIDogdmFsdWU7CiAgICAgICAgICAgIGlmICh2YWx1ZXMgPT09IHByb2dyZXNzVmFsdWVzKSB7CiAgICAgICAgICAgICAgZGVmZXJyZWQubm90aWZ5V2l0aChjb250ZXh0cywgdmFsdWVzKTsKICAgICAgICAgICAgfSBlbHNlIGlmICghLS1yZW1haW5pbmcpIHsKICAgICAgICAgICAgICBkZWZlcnJlZC5yZXNvbHZlV2l0aChjb250ZXh0cywgdmFsdWVzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICB9LCBwcm9ncmVzc1ZhbHVlcywgcHJvZ3Jlc3NDb250ZXh0cywgcmVzb2x2ZUNvbnRleHRzOwogICAgICAvLyBhZGQgbGlzdGVuZXJzIHRvIERlZmVycmVkIHN1Ym9yZGluYXRlczsgdHJlYXQgb3RoZXJzIGFzIHJlc29sdmVkCiAgICAgIGlmIChsZW5ndGggPiAxKSB7CiAgICAgICAgcHJvZ3Jlc3NWYWx1ZXMgPSBuZXcgQXJyYXkobGVuZ3RoKTsKICAgICAgICBwcm9ncmVzc0NvbnRleHRzID0gbmV3IEFycmF5KGxlbmd0aCk7CiAgICAgICAgcmVzb2x2ZUNvbnRleHRzID0gbmV3IEFycmF5KGxlbmd0aCk7CiAgICAgICAgZm9yICg7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgaWYgKHJlc29sdmVWYWx1ZXNbaV0gJiYgalF1ZXJ5LmlzRnVuY3Rpb24ocmVzb2x2ZVZhbHVlc1tpXS5wcm9taXNlKSkgewogICAgICAgICAgICByZXNvbHZlVmFsdWVzW2ldLnByb21pc2UoKS5kb25lKHVwZGF0ZUZ1bmMoaSwgcmVzb2x2ZUNvbnRleHRzLCByZXNvbHZlVmFsdWVzKSkuZmFpbChkZWZlcnJlZC5yZWplY3QpLnByb2dyZXNzKHVwZGF0ZUZ1bmMoaSwgcHJvZ3Jlc3NDb250ZXh0cywgcHJvZ3Jlc3NWYWx1ZXMpKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIC0tcmVtYWluaW5nOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICAvLyBpZiB3ZSdyZSBub3Qgd2FpdGluZyBvbiBhbnl0aGluZywgcmVzb2x2ZSB0aGUgbWFzdGVyCiAgICAgIGlmICghcmVtYWluaW5nKSB7CiAgICAgICAgZGVmZXJyZWQucmVzb2x2ZVdpdGgocmVzb2x2ZUNvbnRleHRzLCByZXNvbHZlVmFsdWVzKTsKICAgICAgfQogICAgICByZXR1cm4gZGVmZXJyZWQucHJvbWlzZSgpOwogICAgfQogIH0pOwogIC8vIFRoZSBkZWZlcnJlZCB1c2VkIG9uIERPTSByZWFkeQogIHZhciByZWFkeUxpc3Q7CiAgalF1ZXJ5LmZuLnJlYWR5ID0gZnVuY3Rpb24gKGZuKSB7CiAgICAvLyBBZGQgdGhlIGNhbGxiYWNrCiAgICBqUXVlcnkucmVhZHkucHJvbWlzZSgpLmRvbmUoZm4pOwogICAgcmV0dXJuIHRoaXM7CiAgfTsKICBqUXVlcnkuZXh0ZW5kKHsKICAgIC8vIElzIHRoZSBET00gcmVhZHkgdG8gYmUgdXNlZD8gU2V0IHRvIHRydWUgb25jZSBpdCBvY2N1cnMuCiAgICBpc1JlYWR5OiBmYWxzZSwKICAgIC8vIEEgY291bnRlciB0byB0cmFjayBob3cgbWFueSBpdGVtcyB0byB3YWl0IGZvciBiZWZvcmUKICAgIC8vIHRoZSByZWFkeSBldmVudCBmaXJlcy4gU2VlICM2NzgxCiAgICByZWFkeVdhaXQ6IDEsCiAgICAvLyBIb2xkIChvciByZWxlYXNlKSB0aGUgcmVhZHkgZXZlbnQKICAgIGhvbGRSZWFkeTogZnVuY3Rpb24gKGhvbGQpIHsKICAgICAgaWYgKGhvbGQpIHsKICAgICAgICBqUXVlcnkucmVhZHlXYWl0Kys7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgalF1ZXJ5LnJlYWR5KHRydWUpOwogICAgICB9CiAgICB9LAogICAgLy8gSGFuZGxlIHdoZW4gdGhlIERPTSBpcyByZWFkeQogICAgcmVhZHk6IGZ1bmN0aW9uICh3YWl0KSB7CiAgICAgIC8vIEFib3J0IGlmIHRoZXJlIGFyZSBwZW5kaW5nIGhvbGRzIG9yIHdlJ3JlIGFscmVhZHkgcmVhZHkKICAgICAgaWYgKHdhaXQgPT09IHRydWUgPyAtLWpRdWVyeS5yZWFkeVdhaXQgOiBqUXVlcnkuaXNSZWFkeSkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICAvLyBSZW1lbWJlciB0aGF0IHRoZSBET00gaXMgcmVhZHkKICAgICAgalF1ZXJ5LmlzUmVhZHkgPSB0cnVlOwogICAgICAvLyBJZiBhIG5vcm1hbCBET00gUmVhZHkgZXZlbnQgZmlyZWQsIGRlY3JlbWVudCwgYW5kIHdhaXQgaWYgbmVlZCBiZQogICAgICBpZiAod2FpdCAhPT0gdHJ1ZSAmJiAtLWpRdWVyeS5yZWFkeVdhaXQgPiAwKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIC8vIElmIHRoZXJlIGFyZSBmdW5jdGlvbnMgYm91bmQsIHRvIGV4ZWN1dGUKICAgICAgcmVhZHlMaXN0LnJlc29sdmVXaXRoKGRvY3VtZW50LCBbalF1ZXJ5XSk7CiAgICAgIC8vIFRyaWdnZXIgYW55IGJvdW5kIHJlYWR5IGV2ZW50cwogICAgICBpZiAoalF1ZXJ5LmZuLnRyaWdnZXJIYW5kbGVyKSB7CiAgICAgICAgalF1ZXJ5KGRvY3VtZW50KS50cmlnZ2VySGFuZGxlcigncmVhZHknKTsKICAgICAgICBqUXVlcnkoZG9jdW1lbnQpLm9mZigncmVhZHknKTsKICAgICAgfQogICAgfQogIH0pOwogIC8qKgogICAqIFRoZSByZWFkeSBldmVudCBoYW5kbGVyIGFuZCBzZWxmIGNsZWFudXAgbWV0aG9kCiAgICovCiAgZnVuY3Rpb24gY29tcGxldGVkKCkgewogICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcignRE9NQ29udGVudExvYWRlZCcsIGNvbXBsZXRlZCwgZmFsc2UpOwogICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2xvYWQnLCBjb21wbGV0ZWQsIGZhbHNlKTsKICAgIGpRdWVyeS5yZWFkeSgpOwogIH0KICBqUXVlcnkucmVhZHkucHJvbWlzZSA9IGZ1bmN0aW9uIChvYmopIHsKICAgIGlmICghcmVhZHlMaXN0KSB7CiAgICAgIHJlYWR5TGlzdCA9IGpRdWVyeS5EZWZlcnJlZCgpOwogICAgICAvLyBDYXRjaCBjYXNlcyB3aGVyZSAkKGRvY3VtZW50KS5yZWFkeSgpIGlzIGNhbGxlZCBhZnRlciB0aGUgYnJvd3NlciBldmVudCBoYXMgYWxyZWFkeSBvY2N1cnJlZC4KICAgICAgLy8gd2Ugb25jZSB0cmllZCB0byB1c2UgcmVhZHlTdGF0ZSAiaW50ZXJhY3RpdmUiIGhlcmUsIGJ1dCBpdCBjYXVzZWQgaXNzdWVzIGxpa2UgdGhlIG9uZQogICAgICAvLyBkaXNjb3ZlcmVkIGJ5IENocmlzUyBoZXJlOiBodHRwOi8vYnVncy5qcXVlcnkuY29tL3RpY2tldC8xMjI4MiNjb21tZW50OjE1CiAgICAgIGlmIChkb2N1bWVudC5yZWFkeVN0YXRlID09PSAnY29tcGxldGUnKSB7CiAgICAgICAgLy8gSGFuZGxlIGl0IGFzeW5jaHJvbm91c2x5IHRvIGFsbG93IHNjcmlwdHMgdGhlIG9wcG9ydHVuaXR5IHRvIGRlbGF5IHJlYWR5CiAgICAgICAgc2V0VGltZW91dChqUXVlcnkucmVhZHkpOwogICAgICB9IGVsc2UgewogICAgICAgIC8vIFVzZSB0aGUgaGFuZHkgZXZlbnQgY2FsbGJhY2sKICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdET01Db250ZW50TG9hZGVkJywgY29tcGxldGVkLCBmYWxzZSk7CiAgICAgICAgLy8gQSBmYWxsYmFjayB0byB3aW5kb3cub25sb2FkLCB0aGF0IHdpbGwgYWx3YXlzIHdvcmsKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbG9hZCcsIGNvbXBsZXRlZCwgZmFsc2UpOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gcmVhZHlMaXN0LnByb21pc2Uob2JqKTsKICB9OwogIC8vIEtpY2sgb2ZmIHRoZSBET00gcmVhZHkgY2hlY2sgZXZlbiBpZiB0aGUgdXNlciBkb2VzIG5vdAogIGpRdWVyeS5yZWFkeS5wcm9taXNlKCk7CiAgLy8gTXVsdGlmdW5jdGlvbmFsIG1ldGhvZCB0byBnZXQgYW5kIHNldCB2YWx1ZXMgb2YgYSBjb2xsZWN0aW9uCiAgLy8gVGhlIHZhbHVlL3MgY2FuIG9wdGlvbmFsbHkgYmUgZXhlY3V0ZWQgaWYgaXQncyBhIGZ1bmN0aW9uCiAgdmFyIGFjY2VzcyA9IGpRdWVyeS5hY2Nlc3MgPSBmdW5jdGlvbiAoZWxlbXMsIGZuLCBrZXksIHZhbHVlLCBjaGFpbmFibGUsIGVtcHR5R2V0LCByYXcpIHsKICAgIHZhciBpID0gMCwgbGVuID0gZWxlbXMubGVuZ3RoLCBidWxrID0ga2V5ID09IG51bGw7CiAgICAvLyBTZXRzIG1hbnkgdmFsdWVzCiAgICBpZiAoalF1ZXJ5LnR5cGUoa2V5KSA9PT0gJ29iamVjdCcpIHsKICAgICAgY2hhaW5hYmxlID0gdHJ1ZTsKICAgICAgZm9yIChpIGluIGtleSkgewogICAgICAgIGpRdWVyeS5hY2Nlc3MoZWxlbXMsIGZuLCBpLCBrZXlbaV0sIHRydWUsIGVtcHR5R2V0LCByYXcpOwogICAgICB9ICAvLyBTZXRzIG9uZSB2YWx1ZQogICAgfSBlbHNlIGlmICh2YWx1ZSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgIGNoYWluYWJsZSA9IHRydWU7CiAgICAgIGlmICghalF1ZXJ5LmlzRnVuY3Rpb24odmFsdWUpKSB7CiAgICAgICAgcmF3ID0gdHJ1ZTsKICAgICAgfQogICAgICBpZiAoYnVsaykgewogICAgICAgIC8vIEJ1bGsgb3BlcmF0aW9ucyBydW4gYWdhaW5zdCB0aGUgZW50aXJlIHNldAogICAgICAgIGlmIChyYXcpIHsKICAgICAgICAgIGZuLmNhbGwoZWxlbXMsIHZhbHVlKTsKICAgICAgICAgIGZuID0gbnVsbDsgIC8vIC4uLmV4Y2VwdCB3aGVuIGV4ZWN1dGluZyBmdW5jdGlvbiB2YWx1ZXMKICAgICAgICB9IGVsc2UgewogICAgICAgICAgYnVsayA9IGZuOwogICAgICAgICAgZm4gPSBmdW5jdGlvbiAoZWxlbSwga2V5LCB2YWx1ZSkgewogICAgICAgICAgICByZXR1cm4gYnVsay5jYWxsKGpRdWVyeShlbGVtKSwgdmFsdWUpOwogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKGZuKSB7CiAgICAgICAgZm9yICg7IGkgPCBsZW47IGkrKykgewogICAgICAgICAgZm4oZWxlbXNbaV0sIGtleSwgcmF3ID8gdmFsdWUgOiB2YWx1ZS5jYWxsKGVsZW1zW2ldLCBpLCBmbihlbGVtc1tpXSwga2V5KSkpOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgcmV0dXJuIGNoYWluYWJsZSA/IGVsZW1zIDogLy8gR2V0cwogICAgYnVsayA/IGZuLmNhbGwoZWxlbXMpIDogbGVuID8gZm4oZWxlbXNbMF0sIGtleSkgOiBlbXB0eUdldDsKICB9OwogIC8qKgogICAqIERldGVybWluZXMgd2hldGhlciBhbiBvYmplY3QgY2FuIGhhdmUgZGF0YQogICAqLwogIGpRdWVyeS5hY2NlcHREYXRhID0gZnVuY3Rpb24gKG93bmVyKSB7CiAgICAvLyBBY2NlcHRzIG9ubHk6CiAgICAvLyAgLSBOb2RlCiAgICAvLyAgICAtIE5vZGUuRUxFTUVOVF9OT0RFCiAgICAvLyAgICAtIE5vZGUuRE9DVU1FTlRfTk9ERQogICAgLy8gIC0gT2JqZWN0CiAgICAvLyAgICAtIEFueQogICAgLyoganNoaW50IC1XMDE4ICovCiAgICByZXR1cm4gb3duZXIubm9kZVR5cGUgPT09IDEgfHwgb3duZXIubm9kZVR5cGUgPT09IDkgfHwgIStvd25lci5ub2RlVHlwZTsKICB9OwogIGZ1bmN0aW9uIERhdGEoKSB7CiAgICAvLyBTdXBwb3J0OiBBbmRyb2lkIDwgNCwKICAgIC8vIE9sZCBXZWJLaXQgZG9lcyBub3QgaGF2ZSBPYmplY3QucHJldmVudEV4dGVuc2lvbnMvZnJlZXplIG1ldGhvZCwKICAgIC8vIHJldHVybiBuZXcgZW1wdHkgb2JqZWN0IGluc3RlYWQgd2l0aCBubyBbW3NldF1dIGFjY2Vzc29yCiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkodGhpcy5jYWNoZSA9IHt9LCAwLCB7CiAgICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB7fTsKICAgICAgfQogICAgfSk7CiAgICB0aGlzLmV4cGFuZG8gPSBqUXVlcnkuZXhwYW5kbyArIE1hdGgucmFuZG9tKCk7CiAgfQogIERhdGEudWlkID0gMTsKICBEYXRhLmFjY2VwdHMgPSBqUXVlcnkuYWNjZXB0RGF0YTsKICBEYXRhLnByb3RvdHlwZSA9IHsKICAgIGtleTogZnVuY3Rpb24gKG93bmVyKSB7CiAgICAgIC8vIFdlIGNhbiBhY2NlcHQgZGF0YSBmb3Igbm9uLWVsZW1lbnQgbm9kZXMgaW4gbW9kZXJuIGJyb3dzZXJzLAogICAgICAvLyBidXQgd2Ugc2hvdWxkIG5vdCwgc2VlICM4MzM1LgogICAgICAvLyBBbHdheXMgcmV0dXJuIHRoZSBrZXkgZm9yIGEgZnJvemVuIG9iamVjdC4KICAgICAgaWYgKCFEYXRhLmFjY2VwdHMob3duZXIpKSB7CiAgICAgICAgcmV0dXJuIDA7CiAgICAgIH0KICAgICAgdmFyIGRlc2NyaXB0b3IgPSB7fSwKICAgICAgICAvLyBDaGVjayBpZiB0aGUgb3duZXIgb2JqZWN0IGFscmVhZHkgaGFzIGEgY2FjaGUga2V5CiAgICAgICAgdW5sb2NrID0gb3duZXJbdGhpcy5leHBhbmRvXTsKICAgICAgLy8gSWYgbm90LCBjcmVhdGUgb25lCiAgICAgIGlmICghdW5sb2NrKSB7CiAgICAgICAgdW5sb2NrID0gRGF0YS51aWQrKzsKICAgICAgICAvLyBTZWN1cmUgaXQgaW4gYSBub24tZW51bWVyYWJsZSwgbm9uLXdyaXRhYmxlIHByb3BlcnR5CiAgICAgICAgdHJ5IHsKICAgICAgICAgIGRlc2NyaXB0b3JbdGhpcy5leHBhbmRvXSA9IHsgdmFsdWU6IHVubG9jayB9OwogICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXMob3duZXIsIGRlc2NyaXB0b3IpOyAgLy8gU3VwcG9ydDogQW5kcm9pZCA8IDQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIEZhbGxiYWNrIHRvIGEgbGVzcyBzZWN1cmUgZGVmaW5pdGlvbgogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgIGRlc2NyaXB0b3JbdGhpcy5leHBhbmRvXSA9IHVubG9jazsKICAgICAgICAgIGpRdWVyeS5leHRlbmQob3duZXIsIGRlc2NyaXB0b3IpOwogICAgICAgIH0KICAgICAgfQogICAgICAvLyBFbnN1cmUgdGhlIGNhY2hlIG9iamVjdAogICAgICBpZiAoIXRoaXMuY2FjaGVbdW5sb2NrXSkgewogICAgICAgIHRoaXMuY2FjaGVbdW5sb2NrXSA9IHt9OwogICAgICB9CiAgICAgIHJldHVybiB1bmxvY2s7CiAgICB9LAogICAgc2V0OiBmdW5jdGlvbiAob3duZXIsIGRhdGEsIHZhbHVlKSB7CiAgICAgIHZhciBwcm9wLAogICAgICAgIC8vIFRoZXJlIG1heSBiZSBhbiB1bmxvY2sgYXNzaWduZWQgdG8gdGhpcyBub2RlLAogICAgICAgIC8vIGlmIHRoZXJlIGlzIG5vIGVudHJ5IGZvciB0aGlzICJvd25lciIsIGNyZWF0ZSBvbmUgaW5saW5lCiAgICAgICAgLy8gYW5kIHNldCB0aGUgdW5sb2NrIGFzIHRob3VnaCBhbiBvd25lciBlbnRyeSBoYWQgYWx3YXlzIGV4aXN0ZWQKICAgICAgICB1bmxvY2sgPSB0aGlzLmtleShvd25lciksIGNhY2hlID0gdGhpcy5jYWNoZVt1bmxvY2tdOwogICAgICAvLyBIYW5kbGU6IFsgb3duZXIsIGtleSwgdmFsdWUgXSBhcmdzCiAgICAgIGlmICh0eXBlb2YgZGF0YSA9PT0gJ3N0cmluZycpIHsKICAgICAgICBjYWNoZVtkYXRhXSA9IHZhbHVlOyAgLy8gSGFuZGxlOiBbIG93bmVyLCB7IHByb3BlcnRpZXMgfSBdIGFyZ3MKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBGcmVzaCBhc3NpZ25tZW50cyBieSBvYmplY3QgYXJlIHNoYWxsb3cgY29waWVkCiAgICAgICAgaWYgKGpRdWVyeS5pc0VtcHR5T2JqZWN0KGNhY2hlKSkgewogICAgICAgICAgalF1ZXJ5LmV4dGVuZCh0aGlzLmNhY2hlW3VubG9ja10sIGRhdGEpOyAgLy8gT3RoZXJ3aXNlLCBjb3B5IHRoZSBwcm9wZXJ0aWVzIG9uZS1ieS1vbmUgdG8gdGhlIGNhY2hlIG9iamVjdAogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBmb3IgKHByb3AgaW4gZGF0YSkgewogICAgICAgICAgICBjYWNoZVtwcm9wXSA9IGRhdGFbcHJvcF07CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBjYWNoZTsKICAgIH0sCiAgICBnZXQ6IGZ1bmN0aW9uIChvd25lciwga2V5KSB7CiAgICAgIC8vIEVpdGhlciBhIHZhbGlkIGNhY2hlIGlzIGZvdW5kLCBvciB3aWxsIGJlIGNyZWF0ZWQuCiAgICAgIC8vIE5ldyBjYWNoZXMgd2lsbCBiZSBjcmVhdGVkIGFuZCB0aGUgdW5sb2NrIHJldHVybmVkLAogICAgICAvLyBhbGxvd2luZyBkaXJlY3QgYWNjZXNzIHRvIHRoZSBuZXdseSBjcmVhdGVkCiAgICAgIC8vIGVtcHR5IGRhdGEgb2JqZWN0LiBBIHZhbGlkIG93bmVyIG9iamVjdCBtdXN0IGJlIHByb3ZpZGVkLgogICAgICB2YXIgY2FjaGUgPSB0aGlzLmNhY2hlW3RoaXMua2V5KG93bmVyKV07CiAgICAgIHJldHVybiBrZXkgPT09IHVuZGVmaW5lZCA/IGNhY2hlIDogY2FjaGVba2V5XTsKICAgIH0sCiAgICBhY2Nlc3M6IGZ1bmN0aW9uIChvd25lciwga2V5LCB2YWx1ZSkgewogICAgICB2YXIgc3RvcmVkOwogICAgICAvLyBJbiBjYXNlcyB3aGVyZSBlaXRoZXI6CiAgICAgIC8vCiAgICAgIC8vICAgMS4gTm8ga2V5IHdhcyBzcGVjaWZpZWQKICAgICAgLy8gICAyLiBBIHN0cmluZyBrZXkgd2FzIHNwZWNpZmllZCwgYnV0IG5vIHZhbHVlIHByb3ZpZGVkCiAgICAgIC8vCiAgICAgIC8vIFRha2UgdGhlICJyZWFkIiBwYXRoIGFuZCBhbGxvdyB0aGUgZ2V0IG1ldGhvZCB0byBkZXRlcm1pbmUKICAgICAgLy8gd2hpY2ggdmFsdWUgdG8gcmV0dXJuLCByZXNwZWN0aXZlbHkgZWl0aGVyOgogICAgICAvLwogICAgICAvLyAgIDEuIFRoZSBlbnRpcmUgY2FjaGUgb2JqZWN0CiAgICAgIC8vICAgMi4gVGhlIGRhdGEgc3RvcmVkIGF0IHRoZSBrZXkKICAgICAgLy8KICAgICAgaWYgKGtleSA9PT0gdW5kZWZpbmVkIHx8IGtleSAmJiB0eXBlb2Yga2V5ID09PSAnc3RyaW5nJyAmJiB2YWx1ZSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgc3RvcmVkID0gdGhpcy5nZXQob3duZXIsIGtleSk7CiAgICAgICAgcmV0dXJuIHN0b3JlZCAhPT0gdW5kZWZpbmVkID8gc3RvcmVkIDogdGhpcy5nZXQob3duZXIsIGpRdWVyeS5jYW1lbENhc2Uoa2V5KSk7CiAgICAgIH0KICAgICAgLy8gWypdV2hlbiB0aGUga2V5IGlzIG5vdCBhIHN0cmluZywgb3IgYm90aCBhIGtleSBhbmQgdmFsdWUKICAgICAgLy8gYXJlIHNwZWNpZmllZCwgc2V0IG9yIGV4dGVuZCAoZXhpc3Rpbmcgb2JqZWN0cykgd2l0aCBlaXRoZXI6CiAgICAgIC8vCiAgICAgIC8vICAgMS4gQW4gb2JqZWN0IG9mIHByb3BlcnRpZXMKICAgICAgLy8gICAyLiBBIGtleSBhbmQgdmFsdWUKICAgICAgLy8KICAgICAgdGhpcy5zZXQob3duZXIsIGtleSwgdmFsdWUpOwogICAgICAvLyBTaW5jZSB0aGUgInNldCIgcGF0aCBjYW4gaGF2ZSB0d28gcG9zc2libGUgZW50cnkgcG9pbnRzCiAgICAgIC8vIHJldHVybiB0aGUgZXhwZWN0ZWQgZGF0YSBiYXNlZCBvbiB3aGljaCBwYXRoIHdhcyB0YWtlblsqXQogICAgICByZXR1cm4gdmFsdWUgIT09IHVuZGVmaW5lZCA/IHZhbHVlIDoga2V5OwogICAgfSwKICAgIHJlbW92ZTogZnVuY3Rpb24gKG93bmVyLCBrZXkpIHsKICAgICAgdmFyIGksIG5hbWUsIGNhbWVsLCB1bmxvY2sgPSB0aGlzLmtleShvd25lciksIGNhY2hlID0gdGhpcy5jYWNoZVt1bmxvY2tdOwogICAgICBpZiAoa2V5ID09PSB1bmRlZmluZWQpIHsKICAgICAgICB0aGlzLmNhY2hlW3VubG9ja10gPSB7fTsKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBTdXBwb3J0IGFycmF5IG9yIHNwYWNlIHNlcGFyYXRlZCBzdHJpbmcgb2Yga2V5cwogICAgICAgIGlmIChqUXVlcnkuaXNBcnJheShrZXkpKSB7CiAgICAgICAgICAvLyBJZiAibmFtZSIgaXMgYW4gYXJyYXkgb2Yga2V5cy4uLgogICAgICAgICAgLy8gV2hlbiBkYXRhIGlzIGluaXRpYWxseSBjcmVhdGVkLCB2aWEgKCJrZXkiLCAidmFsIikgc2lnbmF0dXJlLAogICAgICAgICAgLy8ga2V5cyB3aWxsIGJlIGNvbnZlcnRlZCB0byBjYW1lbENhc2UuCiAgICAgICAgICAvLyBTaW5jZSB0aGVyZSBpcyBubyB3YXkgdG8gdGVsbCBfaG93XyBhIGtleSB3YXMgYWRkZWQsIHJlbW92ZQogICAgICAgICAgLy8gYm90aCBwbGFpbiBrZXkgYW5kIGNhbWVsQ2FzZSBrZXkuICMxMjc4NgogICAgICAgICAgLy8gVGhpcyB3aWxsIG9ubHkgcGVuYWxpemUgdGhlIGFycmF5IGFyZ3VtZW50IHBhdGguCiAgICAgICAgICBuYW1lID0ga2V5LmNvbmNhdChrZXkubWFwKGpRdWVyeS5jYW1lbENhc2UpKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY2FtZWwgPSBqUXVlcnkuY2FtZWxDYXNlKGtleSk7CiAgICAgICAgICAvLyBUcnkgdGhlIHN0cmluZyBhcyBhIGtleSBiZWZvcmUgYW55IG1hbmlwdWxhdGlvbgogICAgICAgICAgaWYgKGtleSBpbiBjYWNoZSkgewogICAgICAgICAgICBuYW1lID0gWwogICAgICAgICAgICAgIGtleSwKICAgICAgICAgICAgICBjYW1lbAogICAgICAgICAgICBdOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgLy8gSWYgYSBrZXkgd2l0aCB0aGUgc3BhY2VzIGV4aXN0cywgdXNlIGl0LgogICAgICAgICAgICAvLyBPdGhlcndpc2UsIGNyZWF0ZSBhbiBhcnJheSBieSBtYXRjaGluZyBub24td2hpdGVzcGFjZQogICAgICAgICAgICBuYW1lID0gY2FtZWw7CiAgICAgICAgICAgIG5hbWUgPSBuYW1lIGluIGNhY2hlID8gW25hbWVdIDogbmFtZS5tYXRjaChybm90d2hpdGUpIHx8IFtdOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpID0gbmFtZS5sZW5ndGg7CiAgICAgICAgd2hpbGUgKGktLSkgewogICAgICAgICAgZGVsZXRlIGNhY2hlW25hbWVbaV1dOwogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgIGhhc0RhdGE6IGZ1bmN0aW9uIChvd25lcikgewogICAgICByZXR1cm4gIWpRdWVyeS5pc0VtcHR5T2JqZWN0KHRoaXMuY2FjaGVbb3duZXJbdGhpcy5leHBhbmRvXV0gfHwge30pOwogICAgfSwKICAgIGRpc2NhcmQ6IGZ1bmN0aW9uIChvd25lcikgewogICAgICBpZiAob3duZXJbdGhpcy5leHBhbmRvXSkgewogICAgICAgIGRlbGV0ZSB0aGlzLmNhY2hlW293bmVyW3RoaXMuZXhwYW5kb11dOwogICAgICB9CiAgICB9CiAgfTsKICB2YXIgZGF0YV9wcml2ID0gbmV3IERhdGEoKTsKICB2YXIgZGF0YV91c2VyID0gbmV3IERhdGEoKTsKICAvKgogIAlJbXBsZW1lbnRhdGlvbiBTdW1tYXJ5CiAgCiAgCTEuIEVuZm9yY2UgQVBJIHN1cmZhY2UgYW5kIHNlbWFudGljIGNvbXBhdGliaWxpdHkgd2l0aCAxLjkueCBicmFuY2gKICAJMi4gSW1wcm92ZSB0aGUgbW9kdWxlJ3MgbWFpbnRhaW5hYmlsaXR5IGJ5IHJlZHVjaW5nIHRoZSBzdG9yYWdlCiAgCQlwYXRocyB0byBhIHNpbmdsZSBtZWNoYW5pc20uCiAgCTMuIFVzZSB0aGUgc2FtZSBzaW5nbGUgbWVjaGFuaXNtIHRvIHN1cHBvcnQgInByaXZhdGUiIGFuZCAidXNlciIgZGF0YS4KICAJNC4gX05ldmVyXyBleHBvc2UgInByaXZhdGUiIGRhdGEgdG8gdXNlciBjb2RlIChUT0RPOiBEcm9wIF9kYXRhLCBfcmVtb3ZlRGF0YSkKICAJNS4gQXZvaWQgZXhwb3NpbmcgaW1wbGVtZW50YXRpb24gZGV0YWlscyBvbiB1c2VyIG9iamVjdHMgKGVnLiBleHBhbmRvIHByb3BlcnRpZXMpCiAgCTYuIFByb3ZpZGUgYSBjbGVhciBwYXRoIGZvciBpbXBsZW1lbnRhdGlvbiB1cGdyYWRlIHRvIFdlYWtNYXAgaW4gMjAxNAogICovCiAgdmFyIHJicmFjZSA9IC9eKD86XHtbXHdcV10qXH18XFtbXHdcV10qXF0pJC8sIHJtdWx0aURhc2ggPSAvKFtBLVpdKS9nOwogIGZ1bmN0aW9uIGRhdGFBdHRyKGVsZW0sIGtleSwgZGF0YSkgewogICAgdmFyIG5hbWU7CiAgICAvLyBJZiBub3RoaW5nIHdhcyBmb3VuZCBpbnRlcm5hbGx5LCB0cnkgdG8gZmV0Y2ggYW55CiAgICAvLyBkYXRhIGZyb20gdGhlIEhUTUw1IGRhdGEtKiBhdHRyaWJ1dGUKICAgIGlmIChkYXRhID09PSB1bmRlZmluZWQgJiYgZWxlbS5ub2RlVHlwZSA9PT0gMSkgewogICAgICBuYW1lID0gJ2RhdGEtJyArIGtleS5yZXBsYWNlKHJtdWx0aURhc2gsICctJDEnKS50b0xvd2VyQ2FzZSgpOwogICAgICBkYXRhID0gZWxlbS5nZXRBdHRyaWJ1dGUobmFtZSk7CiAgICAgIGlmICh0eXBlb2YgZGF0YSA9PT0gJ3N0cmluZycpIHsKICAgICAgICB0cnkgewogICAgICAgICAgZGF0YSA9IGRhdGEgPT09ICd0cnVlJyA/IHRydWUgOiBkYXRhID09PSAnZmFsc2UnID8gZmFsc2UgOiBkYXRhID09PSAnbnVsbCcgPyBudWxsIDogLy8gT25seSBjb252ZXJ0IHRvIGEgbnVtYmVyIGlmIGl0IGRvZXNuJ3QgY2hhbmdlIHRoZSBzdHJpbmcKICAgICAgICAgICtkYXRhICsgJycgPT09IGRhdGEgPyArZGF0YSA6IHJicmFjZS50ZXN0KGRhdGEpID8galF1ZXJ5LnBhcnNlSlNPTihkYXRhKSA6IGRhdGE7CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgIH0KICAgICAgICAvLyBNYWtlIHN1cmUgd2Ugc2V0IHRoZSBkYXRhIHNvIGl0IGlzbid0IGNoYW5nZWQgbGF0ZXIKICAgICAgICBkYXRhX3VzZXIuc2V0KGVsZW0sIGtleSwgZGF0YSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZGF0YSA9IHVuZGVmaW5lZDsKICAgICAgfQogICAgfQogICAgcmV0dXJuIGRhdGE7CiAgfQogIGpRdWVyeS5leHRlbmQoewogICAgaGFzRGF0YTogZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgcmV0dXJuIGRhdGFfdXNlci5oYXNEYXRhKGVsZW0pIHx8IGRhdGFfcHJpdi5oYXNEYXRhKGVsZW0pOwogICAgfSwKICAgIGRhdGE6IGZ1bmN0aW9uIChlbGVtLCBuYW1lLCBkYXRhKSB7CiAgICAgIHJldHVybiBkYXRhX3VzZXIuYWNjZXNzKGVsZW0sIG5hbWUsIGRhdGEpOwogICAgfSwKICAgIHJlbW92ZURhdGE6IGZ1bmN0aW9uIChlbGVtLCBuYW1lKSB7CiAgICAgIGRhdGFfdXNlci5yZW1vdmUoZWxlbSwgbmFtZSk7CiAgICB9LAogICAgLy8gVE9ETzogTm93IHRoYXQgYWxsIGNhbGxzIHRvIF9kYXRhIGFuZCBfcmVtb3ZlRGF0YSBoYXZlIGJlZW4gcmVwbGFjZWQKICAgIC8vIHdpdGggZGlyZWN0IGNhbGxzIHRvIGRhdGFfcHJpdiBtZXRob2RzLCB0aGVzZSBjYW4gYmUgZGVwcmVjYXRlZC4KICAgIF9kYXRhOiBmdW5jdGlvbiAoZWxlbSwgbmFtZSwgZGF0YSkgewogICAgICByZXR1cm4gZGF0YV9wcml2LmFjY2VzcyhlbGVtLCBuYW1lLCBkYXRhKTsKICAgIH0sCiAgICBfcmVtb3ZlRGF0YTogZnVuY3Rpb24gKGVsZW0sIG5hbWUpIHsKICAgICAgZGF0YV9wcml2LnJlbW92ZShlbGVtLCBuYW1lKTsKICAgIH0KICB9KTsKICBqUXVlcnkuZm4uZXh0ZW5kKHsKICAgIGRhdGE6IGZ1bmN0aW9uIChrZXksIHZhbHVlKSB7CiAgICAgIHZhciBpLCBuYW1lLCBkYXRhLCBlbGVtID0gdGhpc1swXSwgYXR0cnMgPSBlbGVtICYmIGVsZW0uYXR0cmlidXRlczsKICAgICAgLy8gR2V0cyBhbGwgdmFsdWVzCiAgICAgIGlmIChrZXkgPT09IHVuZGVmaW5lZCkgewogICAgICAgIGlmICh0aGlzLmxlbmd0aCkgewogICAgICAgICAgZGF0YSA9IGRhdGFfdXNlci5nZXQoZWxlbSk7CiAgICAgICAgICBpZiAoZWxlbS5ub2RlVHlwZSA9PT0gMSAmJiAhZGF0YV9wcml2LmdldChlbGVtLCAnaGFzRGF0YUF0dHJzJykpIHsKICAgICAgICAgICAgaSA9IGF0dHJzLmxlbmd0aDsKICAgICAgICAgICAgd2hpbGUgKGktLSkgewogICAgICAgICAgICAgIC8vIFN1cHBvcnQ6IElFMTErCiAgICAgICAgICAgICAgLy8gVGhlIGF0dHJzIGVsZW1lbnRzIGNhbiBiZSBudWxsICgjMTQ4OTQpCiAgICAgICAgICAgICAgaWYgKGF0dHJzW2ldKSB7CiAgICAgICAgICAgICAgICBuYW1lID0gYXR0cnNbaV0ubmFtZTsKICAgICAgICAgICAgICAgIGlmIChuYW1lLmluZGV4T2YoJ2RhdGEtJykgPT09IDApIHsKICAgICAgICAgICAgICAgICAgbmFtZSA9IGpRdWVyeS5jYW1lbENhc2UobmFtZS5zbGljZSg1KSk7CiAgICAgICAgICAgICAgICAgIGRhdGFBdHRyKGVsZW0sIG5hbWUsIGRhdGFbbmFtZV0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBkYXRhX3ByaXYuc2V0KGVsZW0sICdoYXNEYXRhQXR0cnMnLCB0cnVlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIGRhdGE7CiAgICAgIH0KICAgICAgLy8gU2V0cyBtdWx0aXBsZSB2YWx1ZXMKICAgICAgaWYgKHR5cGVvZiBrZXkgPT09ICdvYmplY3QnKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICBkYXRhX3VzZXIuc2V0KHRoaXMsIGtleSk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgcmV0dXJuIGFjY2Vzcyh0aGlzLCBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICB2YXIgZGF0YSwgY2FtZWxLZXkgPSBqUXVlcnkuY2FtZWxDYXNlKGtleSk7CiAgICAgICAgLy8gVGhlIGNhbGxpbmcgalF1ZXJ5IG9iamVjdCAoZWxlbWVudCBtYXRjaGVzKSBpcyBub3QgZW1wdHkKICAgICAgICAvLyAoYW5kIHRoZXJlZm9yZSBoYXMgYW4gZWxlbWVudCBhcHBlYXJzIGF0IHRoaXNbIDAgXSkgYW5kIHRoZQogICAgICAgIC8vIGB2YWx1ZWAgcGFyYW1ldGVyIHdhcyBub3QgdW5kZWZpbmVkLiBBbiBlbXB0eSBqUXVlcnkgb2JqZWN0CiAgICAgICAgLy8gd2lsbCByZXN1bHQgaW4gYHVuZGVmaW5lZGAgZm9yIGVsZW0gPSB0aGlzWyAwIF0gd2hpY2ggd2lsbAogICAgICAgIC8vIHRocm93IGFuIGV4Y2VwdGlvbiBpZiBhbiBhdHRlbXB0IHRvIHJlYWQgYSBkYXRhIGNhY2hlIGlzIG1hZGUuCiAgICAgICAgaWYgKGVsZW0gJiYgdmFsdWUgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgLy8gQXR0ZW1wdCB0byBnZXQgZGF0YSBmcm9tIHRoZSBjYWNoZQogICAgICAgICAgLy8gd2l0aCB0aGUga2V5IGFzLWlzCiAgICAgICAgICBkYXRhID0gZGF0YV91c2VyLmdldChlbGVtLCBrZXkpOwogICAgICAgICAgaWYgKGRhdGEgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICByZXR1cm4gZGF0YTsKICAgICAgICAgIH0KICAgICAgICAgIC8vIEF0dGVtcHQgdG8gZ2V0IGRhdGEgZnJvbSB0aGUgY2FjaGUKICAgICAgICAgIC8vIHdpdGggdGhlIGtleSBjYW1lbGl6ZWQKICAgICAgICAgIGRhdGEgPSBkYXRhX3VzZXIuZ2V0KGVsZW0sIGNhbWVsS2V5KTsKICAgICAgICAgIGlmIChkYXRhICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgcmV0dXJuIGRhdGE7CiAgICAgICAgICB9CiAgICAgICAgICAvLyBBdHRlbXB0IHRvICJkaXNjb3ZlciIgdGhlIGRhdGEgaW4KICAgICAgICAgIC8vIEhUTUw1IGN1c3RvbSBkYXRhLSogYXR0cnMKICAgICAgICAgIGRhdGEgPSBkYXRhQXR0cihlbGVtLCBjYW1lbEtleSwgdW5kZWZpbmVkKTsKICAgICAgICAgIGlmIChkYXRhICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgcmV0dXJuIGRhdGE7CiAgICAgICAgICB9CiAgICAgICAgICAvLyBXZSB0cmllZCByZWFsbHkgaGFyZCwgYnV0IHRoZSBkYXRhIGRvZXNuJ3QgZXhpc3QuCiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIC8vIFNldCB0aGUgZGF0YS4uLgogICAgICAgIHRoaXMuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAvLyBGaXJzdCwgYXR0ZW1wdCB0byBzdG9yZSBhIGNvcHkgb3IgcmVmZXJlbmNlIG9mIGFueQogICAgICAgICAgLy8gZGF0YSB0aGF0IG1pZ2h0J3ZlIGJlZW4gc3RvcmUgd2l0aCBhIGNhbWVsQ2FzZWQga2V5LgogICAgICAgICAgdmFyIGRhdGEgPSBkYXRhX3VzZXIuZ2V0KHRoaXMsIGNhbWVsS2V5KTsKICAgICAgICAgIC8vIEZvciBIVE1MNSBkYXRhLSogYXR0cmlidXRlIGludGVyb3AsIHdlIGhhdmUgdG8KICAgICAgICAgIC8vIHN0b3JlIHByb3BlcnR5IG5hbWVzIHdpdGggZGFzaGVzIGluIGEgY2FtZWxDYXNlIGZvcm0uCiAgICAgICAgICAvLyBUaGlzIG1pZ2h0IG5vdCBhcHBseSB0byBhbGwgcHJvcGVydGllcy4uLioKICAgICAgICAgIGRhdGFfdXNlci5zZXQodGhpcywgY2FtZWxLZXksIHZhbHVlKTsKICAgICAgICAgIC8vICouLi4gSW4gdGhlIGNhc2Ugb2YgcHJvcGVydGllcyB0aGF0IG1pZ2h0IF9hY3R1YWxseV8KICAgICAgICAgIC8vIGhhdmUgZGFzaGVzLCB3ZSBuZWVkIHRvIGFsc28gc3RvcmUgYSBjb3B5IG9mIHRoYXQKICAgICAgICAgIC8vIHVuY2hhbmdlZCBwcm9wZXJ0eS4KICAgICAgICAgIGlmIChrZXkuaW5kZXhPZignLScpICE9PSAtMSAmJiBkYXRhICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgZGF0YV91c2VyLnNldCh0aGlzLCBrZXksIHZhbHVlKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfSwgbnVsbCwgdmFsdWUsIGFyZ3VtZW50cy5sZW5ndGggPiAxLCBudWxsLCB0cnVlKTsKICAgIH0sCiAgICByZW1vdmVEYXRhOiBmdW5jdGlvbiAoa2V5KSB7CiAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24gKCkgewogICAgICAgIGRhdGFfdXNlci5yZW1vdmUodGhpcywga2V5KTsKICAgICAgfSk7CiAgICB9CiAgfSk7CiAgalF1ZXJ5LmV4dGVuZCh7CiAgICBxdWV1ZTogZnVuY3Rpb24gKGVsZW0sIHR5cGUsIGRhdGEpIHsKICAgICAgdmFyIHF1ZXVlOwogICAgICBpZiAoZWxlbSkgewogICAgICAgIHR5cGUgPSAodHlwZSB8fCAnZngnKSArICdxdWV1ZSc7CiAgICAgICAgcXVldWUgPSBkYXRhX3ByaXYuZ2V0KGVsZW0sIHR5cGUpOwogICAgICAgIC8vIFNwZWVkIHVwIGRlcXVldWUgYnkgZ2V0dGluZyBvdXQgcXVpY2tseSBpZiB0aGlzIGlzIGp1c3QgYSBsb29rdXAKICAgICAgICBpZiAoZGF0YSkgewogICAgICAgICAgaWYgKCFxdWV1ZSB8fCBqUXVlcnkuaXNBcnJheShkYXRhKSkgewogICAgICAgICAgICBxdWV1ZSA9IGRhdGFfcHJpdi5hY2Nlc3MoZWxlbSwgdHlwZSwgalF1ZXJ5Lm1ha2VBcnJheShkYXRhKSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBxdWV1ZS5wdXNoKGRhdGEpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gcXVldWUgfHwgW107CiAgICAgIH0KICAgIH0sCiAgICBkZXF1ZXVlOiBmdW5jdGlvbiAoZWxlbSwgdHlwZSkgewogICAgICB0eXBlID0gdHlwZSB8fCAnZngnOwogICAgICB2YXIgcXVldWUgPSBqUXVlcnkucXVldWUoZWxlbSwgdHlwZSksIHN0YXJ0TGVuZ3RoID0gcXVldWUubGVuZ3RoLCBmbiA9IHF1ZXVlLnNoaWZ0KCksIGhvb2tzID0galF1ZXJ5Ll9xdWV1ZUhvb2tzKGVsZW0sIHR5cGUpLCBuZXh0ID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgalF1ZXJ5LmRlcXVldWUoZWxlbSwgdHlwZSk7CiAgICAgICAgfTsKICAgICAgLy8gSWYgdGhlIGZ4IHF1ZXVlIGlzIGRlcXVldWVkLCBhbHdheXMgcmVtb3ZlIHRoZSBwcm9ncmVzcyBzZW50aW5lbAogICAgICBpZiAoZm4gPT09ICdpbnByb2dyZXNzJykgewogICAgICAgIGZuID0gcXVldWUuc2hpZnQoKTsKICAgICAgICBzdGFydExlbmd0aC0tOwogICAgICB9CiAgICAgIGlmIChmbikgewogICAgICAgIC8vIEFkZCBhIHByb2dyZXNzIHNlbnRpbmVsIHRvIHByZXZlbnQgdGhlIGZ4IHF1ZXVlIGZyb20gYmVpbmcKICAgICAgICAvLyBhdXRvbWF0aWNhbGx5IGRlcXVldWVkCiAgICAgICAgaWYgKHR5cGUgPT09ICdmeCcpIHsKICAgICAgICAgIHF1ZXVlLnVuc2hpZnQoJ2lucHJvZ3Jlc3MnKTsKICAgICAgICB9CiAgICAgICAgLy8gY2xlYXIgdXAgdGhlIGxhc3QgcXVldWUgc3RvcCBmdW5jdGlvbgogICAgICAgIGRlbGV0ZSBob29rcy5zdG9wOwogICAgICAgIGZuLmNhbGwoZWxlbSwgbmV4dCwgaG9va3MpOwogICAgICB9CiAgICAgIGlmICghc3RhcnRMZW5ndGggJiYgaG9va3MpIHsKICAgICAgICBob29rcy5lbXB0eS5maXJlKCk7CiAgICAgIH0KICAgIH0sCiAgICAvLyBub3QgaW50ZW5kZWQgZm9yIHB1YmxpYyBjb25zdW1wdGlvbiAtIGdlbmVyYXRlcyBhIHF1ZXVlSG9va3Mgb2JqZWN0LCBvciByZXR1cm5zIHRoZSBjdXJyZW50IG9uZQogICAgX3F1ZXVlSG9va3M6IGZ1bmN0aW9uIChlbGVtLCB0eXBlKSB7CiAgICAgIHZhciBrZXkgPSB0eXBlICsgJ3F1ZXVlSG9va3MnOwogICAgICByZXR1cm4gZGF0YV9wcml2LmdldChlbGVtLCBrZXkpIHx8IGRhdGFfcHJpdi5hY2Nlc3MoZWxlbSwga2V5LCB7CiAgICAgICAgZW1wdHk6IGpRdWVyeS5DYWxsYmFja3MoJ29uY2UgbWVtb3J5JykuYWRkKGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGRhdGFfcHJpdi5yZW1vdmUoZWxlbSwgWwogICAgICAgICAgICB0eXBlICsgJ3F1ZXVlJywKICAgICAgICAgICAga2V5CiAgICAgICAgICBdKTsKICAgICAgICB9KQogICAgICB9KTsKICAgIH0KICB9KTsKICBqUXVlcnkuZm4uZXh0ZW5kKHsKICAgIHF1ZXVlOiBmdW5jdGlvbiAodHlwZSwgZGF0YSkgewogICAgICB2YXIgc2V0dGVyID0gMjsKICAgICAgaWYgKHR5cGVvZiB0eXBlICE9PSAnc3RyaW5nJykgewogICAgICAgIGRhdGEgPSB0eXBlOwogICAgICAgIHR5cGUgPSAnZngnOwogICAgICAgIHNldHRlci0tOwogICAgICB9CiAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoIDwgc2V0dGVyKSB7CiAgICAgICAgcmV0dXJuIGpRdWVyeS5xdWV1ZSh0aGlzWzBdLCB0eXBlKTsKICAgICAgfQogICAgICByZXR1cm4gZGF0YSA9PT0gdW5kZWZpbmVkID8gdGhpcyA6IHRoaXMuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIHF1ZXVlID0galF1ZXJ5LnF1ZXVlKHRoaXMsIHR5cGUsIGRhdGEpOwogICAgICAgIC8vIGVuc3VyZSBhIGhvb2tzIGZvciB0aGlzIHF1ZXVlCiAgICAgICAgalF1ZXJ5Ll9xdWV1ZUhvb2tzKHRoaXMsIHR5cGUpOwogICAgICAgIGlmICh0eXBlID09PSAnZngnICYmIHF1ZXVlWzBdICE9PSAnaW5wcm9ncmVzcycpIHsKICAgICAgICAgIGpRdWVyeS5kZXF1ZXVlKHRoaXMsIHR5cGUpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9LAogICAgZGVxdWV1ZTogZnVuY3Rpb24gKHR5cGUpIHsKICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgalF1ZXJ5LmRlcXVldWUodGhpcywgdHlwZSk7CiAgICAgIH0pOwogICAgfSwKICAgIGNsZWFyUXVldWU6IGZ1bmN0aW9uICh0eXBlKSB7CiAgICAgIHJldHVybiB0aGlzLnF1ZXVlKHR5cGUgfHwgJ2Z4JywgW10pOwogICAgfSwKICAgIC8vIEdldCBhIHByb21pc2UgcmVzb2x2ZWQgd2hlbiBxdWV1ZXMgb2YgYSBjZXJ0YWluIHR5cGUKICAgIC8vIGFyZSBlbXB0aWVkIChmeCBpcyB0aGUgdHlwZSBieSBkZWZhdWx0KQogICAgcHJvbWlzZTogZnVuY3Rpb24gKHR5cGUsIG9iaikgewogICAgICB2YXIgdG1wLCBjb3VudCA9IDEsIGRlZmVyID0galF1ZXJ5LkRlZmVycmVkKCksIGVsZW1lbnRzID0gdGhpcywgaSA9IHRoaXMubGVuZ3RoLCByZXNvbHZlID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgaWYgKCEtLWNvdW50KSB7CiAgICAgICAgICAgIGRlZmVyLnJlc29sdmVXaXRoKGVsZW1lbnRzLCBbZWxlbWVudHNdKTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICBpZiAodHlwZW9mIHR5cGUgIT09ICdzdHJpbmcnKSB7CiAgICAgICAgb2JqID0gdHlwZTsKICAgICAgICB0eXBlID0gdW5kZWZpbmVkOwogICAgICB9CiAgICAgIHR5cGUgPSB0eXBlIHx8ICdmeCc7CiAgICAgIHdoaWxlIChpLS0pIHsKICAgICAgICB0bXAgPSBkYXRhX3ByaXYuZ2V0KGVsZW1lbnRzW2ldLCB0eXBlICsgJ3F1ZXVlSG9va3MnKTsKICAgICAgICBpZiAodG1wICYmIHRtcC5lbXB0eSkgewogICAgICAgICAgY291bnQrKzsKICAgICAgICAgIHRtcC5lbXB0eS5hZGQocmVzb2x2ZSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJlc29sdmUoKTsKICAgICAgcmV0dXJuIGRlZmVyLnByb21pc2Uob2JqKTsKICAgIH0KICB9KTsKICB2YXIgcG51bSA9IC9bKy1dPyg/OlxkKlwufClcZCsoPzpbZUVdWystXT9cZCt8KS8uc291cmNlOwogIHZhciBjc3NFeHBhbmQgPSBbCiAgICAnVG9wJywKICAgICdSaWdodCcsCiAgICAnQm90dG9tJywKICAgICdMZWZ0JwogIF07CiAgdmFyIGlzSGlkZGVuID0gZnVuY3Rpb24gKGVsZW0sIGVsKSB7CiAgICAvLyBpc0hpZGRlbiBtaWdodCBiZSBjYWxsZWQgZnJvbSBqUXVlcnkjZmlsdGVyIGZ1bmN0aW9uOwogICAgLy8gaW4gdGhhdCBjYXNlLCBlbGVtZW50IHdpbGwgYmUgc2Vjb25kIGFyZ3VtZW50CiAgICBlbGVtID0gZWwgfHwgZWxlbTsKICAgIHJldHVybiBqUXVlcnkuY3NzKGVsZW0sICdkaXNwbGF5JykgPT09ICdub25lJyB8fCAhalF1ZXJ5LmNvbnRhaW5zKGVsZW0ub3duZXJEb2N1bWVudCwgZWxlbSk7CiAgfTsKICB2YXIgcmNoZWNrYWJsZVR5cGUgPSAvXig/OmNoZWNrYm94fHJhZGlvKSQvaTsKICAoZnVuY3Rpb24gKCkgewogICAgdmFyIGZyYWdtZW50ID0gZG9jdW1lbnQuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpLCBkaXYgPSBmcmFnbWVudC5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKSksIGlucHV0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnaW5wdXQnKTsKICAgIC8vICMxMTIxNyAtIFdlYktpdCBsb3NlcyBjaGVjayB3aGVuIHRoZSBuYW1lIGlzIGFmdGVyIHRoZSBjaGVja2VkIGF0dHJpYnV0ZQogICAgLy8gU3VwcG9ydDogV2luZG93cyBXZWIgQXBwcyAoV1dBKQogICAgLy8gYG5hbWVgIGFuZCBgdHlwZWAgbmVlZCAuc2V0QXR0cmlidXRlIGZvciBXV0EKICAgIGlucHV0LnNldEF0dHJpYnV0ZSgndHlwZScsICdyYWRpbycpOwogICAgaW5wdXQuc2V0QXR0cmlidXRlKCdjaGVja2VkJywgJ2NoZWNrZWQnKTsKICAgIGlucHV0LnNldEF0dHJpYnV0ZSgnbmFtZScsICd0Jyk7CiAgICBkaXYuYXBwZW5kQ2hpbGQoaW5wdXQpOwogICAgLy8gU3VwcG9ydDogU2FmYXJpIDUuMSwgaU9TIDUuMSwgQW5kcm9pZCA0LngsIEFuZHJvaWQgMi4zCiAgICAvLyBvbGQgV2ViS2l0IGRvZXNuJ3QgY2xvbmUgY2hlY2tlZCBzdGF0ZSBjb3JyZWN0bHkgaW4gZnJhZ21lbnRzCiAgICBzdXBwb3J0LmNoZWNrQ2xvbmUgPSBkaXYuY2xvbmVOb2RlKHRydWUpLmNsb25lTm9kZSh0cnVlKS5sYXN0Q2hpbGQuY2hlY2tlZDsKICAgIC8vIE1ha2Ugc3VyZSB0ZXh0YXJlYSAoYW5kIGNoZWNrYm94KSBkZWZhdWx0VmFsdWUgaXMgcHJvcGVybHkgY2xvbmVkCiAgICAvLyBTdXBwb3J0OiBJRTktSUUxMSsKICAgIGRpdi5pbm5lckhUTUwgPSAnPHRleHRhcmVhPng8L3RleHRhcmVhPic7CiAgICBzdXBwb3J0Lm5vQ2xvbmVDaGVja2VkID0gISFkaXYuY2xvbmVOb2RlKHRydWUpLmxhc3RDaGlsZC5kZWZhdWx0VmFsdWU7CiAgfSgpKTsKICB2YXIgc3RydW5kZWZpbmVkID0gdHlwZW9mIHVuZGVmaW5lZDsKICBzdXBwb3J0LmZvY3VzaW5CdWJibGVzID0gJ29uZm9jdXNpbicgaW4gd2luZG93OwogIHZhciBya2V5RXZlbnQgPSAvXmtleS8sIHJtb3VzZUV2ZW50ID0gL14oPzptb3VzZXxwb2ludGVyfGNvbnRleHRtZW51KXxjbGljay8sIHJmb2N1c01vcnBoID0gL14oPzpmb2N1c2luZm9jdXN8Zm9jdXNvdXRibHVyKSQvLCBydHlwZW5hbWVzcGFjZSA9IC9eKFteLl0qKSg/OlwuKC4rKXwpJC87CiAgZnVuY3Rpb24gcmV0dXJuVHJ1ZSgpIHsKICAgIHJldHVybiB0cnVlOwogIH0KICBmdW5jdGlvbiByZXR1cm5GYWxzZSgpIHsKICAgIHJldHVybiBmYWxzZTsKICB9CiAgZnVuY3Rpb24gc2FmZUFjdGl2ZUVsZW1lbnQoKSB7CiAgICB0cnkgewogICAgICByZXR1cm4gZG9jdW1lbnQuYWN0aXZlRWxlbWVudDsKICAgIH0gY2F0Y2ggKGVycikgewogICAgfQogIH0KICAvKgogICAqIEhlbHBlciBmdW5jdGlvbnMgZm9yIG1hbmFnaW5nIGV2ZW50cyAtLSBub3QgcGFydCBvZiB0aGUgcHVibGljIGludGVyZmFjZS4KICAgKiBQcm9wcyB0byBEZWFuIEVkd2FyZHMnIGFkZEV2ZW50IGxpYnJhcnkgZm9yIG1hbnkgb2YgdGhlIGlkZWFzLgogICAqLwogIGpRdWVyeS5ldmVudCA9IHsKICAgIGdsb2JhbDoge30sCiAgICBhZGQ6IGZ1bmN0aW9uIChlbGVtLCB0eXBlcywgaGFuZGxlciwgZGF0YSwgc2VsZWN0b3IpIHsKICAgICAgdmFyIGhhbmRsZU9iakluLCBldmVudEhhbmRsZSwgdG1wLCBldmVudHMsIHQsIGhhbmRsZU9iaiwgc3BlY2lhbCwgaGFuZGxlcnMsIHR5cGUsIG5hbWVzcGFjZXMsIG9yaWdUeXBlLCBlbGVtRGF0YSA9IGRhdGFfcHJpdi5nZXQoZWxlbSk7CiAgICAgIC8vIERvbid0IGF0dGFjaCBldmVudHMgdG8gbm9EYXRhIG9yIHRleHQvY29tbWVudCBub2RlcyAoYnV0IGFsbG93IHBsYWluIG9iamVjdHMpCiAgICAgIGlmICghZWxlbURhdGEpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgLy8gQ2FsbGVyIGNhbiBwYXNzIGluIGFuIG9iamVjdCBvZiBjdXN0b20gZGF0YSBpbiBsaWV1IG9mIHRoZSBoYW5kbGVyCiAgICAgIGlmIChoYW5kbGVyLmhhbmRsZXIpIHsKICAgICAgICBoYW5kbGVPYmpJbiA9IGhhbmRsZXI7CiAgICAgICAgaGFuZGxlciA9IGhhbmRsZU9iakluLmhhbmRsZXI7CiAgICAgICAgc2VsZWN0b3IgPSBoYW5kbGVPYmpJbi5zZWxlY3RvcjsKICAgICAgfQogICAgICAvLyBNYWtlIHN1cmUgdGhhdCB0aGUgaGFuZGxlciBoYXMgYSB1bmlxdWUgSUQsIHVzZWQgdG8gZmluZC9yZW1vdmUgaXQgbGF0ZXIKICAgICAgaWYgKCFoYW5kbGVyLmd1aWQpIHsKICAgICAgICBoYW5kbGVyLmd1aWQgPSBqUXVlcnkuZ3VpZCsrOwogICAgICB9CiAgICAgIC8vIEluaXQgdGhlIGVsZW1lbnQncyBldmVudCBzdHJ1Y3R1cmUgYW5kIG1haW4gaGFuZGxlciwgaWYgdGhpcyBpcyB0aGUgZmlyc3QKICAgICAgaWYgKCEoZXZlbnRzID0gZWxlbURhdGEuZXZlbnRzKSkgewogICAgICAgIGV2ZW50cyA9IGVsZW1EYXRhLmV2ZW50cyA9IHt9OwogICAgICB9CiAgICAgIGlmICghKGV2ZW50SGFuZGxlID0gZWxlbURhdGEuaGFuZGxlKSkgewogICAgICAgIGV2ZW50SGFuZGxlID0gZWxlbURhdGEuaGFuZGxlID0gZnVuY3Rpb24gKGUpIHsKICAgICAgICAgIC8vIERpc2NhcmQgdGhlIHNlY29uZCBldmVudCBvZiBhIGpRdWVyeS5ldmVudC50cmlnZ2VyKCkgYW5kCiAgICAgICAgICAvLyB3aGVuIGFuIGV2ZW50IGlzIGNhbGxlZCBhZnRlciBhIHBhZ2UgaGFzIHVubG9hZGVkCiAgICAgICAgICByZXR1cm4gdHlwZW9mIGpRdWVyeSAhPT0gc3RydW5kZWZpbmVkICYmIGpRdWVyeS5ldmVudC50cmlnZ2VyZWQgIT09IGUudHlwZSA/IGpRdWVyeS5ldmVudC5kaXNwYXRjaC5hcHBseShlbGVtLCBhcmd1bWVudHMpIDogdW5kZWZpbmVkOwogICAgICAgIH07CiAgICAgIH0KICAgICAgLy8gSGFuZGxlIG11bHRpcGxlIGV2ZW50cyBzZXBhcmF0ZWQgYnkgYSBzcGFjZQogICAgICB0eXBlcyA9ICh0eXBlcyB8fCAnJykubWF0Y2gocm5vdHdoaXRlKSB8fCBbJyddOwogICAgICB0ID0gdHlwZXMubGVuZ3RoOwogICAgICB3aGlsZSAodC0tKSB7CiAgICAgICAgdG1wID0gcnR5cGVuYW1lc3BhY2UuZXhlYyh0eXBlc1t0XSkgfHwgW107CiAgICAgICAgdHlwZSA9IG9yaWdUeXBlID0gdG1wWzFdOwogICAgICAgIG5hbWVzcGFjZXMgPSAodG1wWzJdIHx8ICcnKS5zcGxpdCgnLicpLnNvcnQoKTsKICAgICAgICAvLyBUaGVyZSAqbXVzdCogYmUgYSB0eXBlLCBubyBhdHRhY2hpbmcgbmFtZXNwYWNlLW9ubHkgaGFuZGxlcnMKICAgICAgICBpZiAoIXR5cGUpIHsKICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIH0KICAgICAgICAvLyBJZiBldmVudCBjaGFuZ2VzIGl0cyB0eXBlLCB1c2UgdGhlIHNwZWNpYWwgZXZlbnQgaGFuZGxlcnMgZm9yIHRoZSBjaGFuZ2VkIHR5cGUKICAgICAgICBzcGVjaWFsID0galF1ZXJ5LmV2ZW50LnNwZWNpYWxbdHlwZV0gfHwge307CiAgICAgICAgLy8gSWYgc2VsZWN0b3IgZGVmaW5lZCwgZGV0ZXJtaW5lIHNwZWNpYWwgZXZlbnQgYXBpIHR5cGUsIG90aGVyd2lzZSBnaXZlbiB0eXBlCiAgICAgICAgdHlwZSA9IChzZWxlY3RvciA/IHNwZWNpYWwuZGVsZWdhdGVUeXBlIDogc3BlY2lhbC5iaW5kVHlwZSkgfHwgdHlwZTsKICAgICAgICAvLyBVcGRhdGUgc3BlY2lhbCBiYXNlZCBvbiBuZXdseSByZXNldCB0eXBlCiAgICAgICAgc3BlY2lhbCA9IGpRdWVyeS5ldmVudC5zcGVjaWFsW3R5cGVdIHx8IHt9OwogICAgICAgIC8vIGhhbmRsZU9iaiBpcyBwYXNzZWQgdG8gYWxsIGV2ZW50IGhhbmRsZXJzCiAgICAgICAgaGFuZGxlT2JqID0galF1ZXJ5LmV4dGVuZCh7CiAgICAgICAgICB0eXBlOiB0eXBlLAogICAgICAgICAgb3JpZ1R5cGU6IG9yaWdUeXBlLAogICAgICAgICAgZGF0YTogZGF0YSwKICAgICAgICAgIGhhbmRsZXI6IGhhbmRsZXIsCiAgICAgICAgICBndWlkOiBoYW5kbGVyLmd1aWQsCiAgICAgICAgICBzZWxlY3Rvcjogc2VsZWN0b3IsCiAgICAgICAgICBuZWVkc0NvbnRleHQ6IHNlbGVjdG9yICYmIGpRdWVyeS5leHByLm1hdGNoLm5lZWRzQ29udGV4dC50ZXN0KHNlbGVjdG9yKSwKICAgICAgICAgIG5hbWVzcGFjZTogbmFtZXNwYWNlcy5qb2luKCcuJykKICAgICAgICB9LCBoYW5kbGVPYmpJbik7CiAgICAgICAgLy8gSW5pdCB0aGUgZXZlbnQgaGFuZGxlciBxdWV1ZSBpZiB3ZSdyZSB0aGUgZmlyc3QKICAgICAgICBpZiAoIShoYW5kbGVycyA9IGV2ZW50c1t0eXBlXSkpIHsKICAgICAgICAgIGhhbmRsZXJzID0gZXZlbnRzW3R5cGVdID0gW107CiAgICAgICAgICBoYW5kbGVycy5kZWxlZ2F0ZUNvdW50ID0gMDsKICAgICAgICAgIC8vIE9ubHkgdXNlIGFkZEV2ZW50TGlzdGVuZXIgaWYgdGhlIHNwZWNpYWwgZXZlbnRzIGhhbmRsZXIgcmV0dXJucyBmYWxzZQogICAgICAgICAgaWYgKCFzcGVjaWFsLnNldHVwIHx8IHNwZWNpYWwuc2V0dXAuY2FsbChlbGVtLCBkYXRhLCBuYW1lc3BhY2VzLCBldmVudEhhbmRsZSkgPT09IGZhbHNlKSB7CiAgICAgICAgICAgIGlmIChlbGVtLmFkZEV2ZW50TGlzdGVuZXIpIHsKICAgICAgICAgICAgICBlbGVtLmFkZEV2ZW50TGlzdGVuZXIodHlwZSwgZXZlbnRIYW5kbGUsIGZhbHNlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoc3BlY2lhbC5hZGQpIHsKICAgICAgICAgIHNwZWNpYWwuYWRkLmNhbGwoZWxlbSwgaGFuZGxlT2JqKTsKICAgICAgICAgIGlmICghaGFuZGxlT2JqLmhhbmRsZXIuZ3VpZCkgewogICAgICAgICAgICBoYW5kbGVPYmouaGFuZGxlci5ndWlkID0gaGFuZGxlci5ndWlkOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAvLyBBZGQgdG8gdGhlIGVsZW1lbnQncyBoYW5kbGVyIGxpc3QsIGRlbGVnYXRlcyBpbiBmcm9udAogICAgICAgIGlmIChzZWxlY3RvcikgewogICAgICAgICAgaGFuZGxlcnMuc3BsaWNlKGhhbmRsZXJzLmRlbGVnYXRlQ291bnQrKywgMCwgaGFuZGxlT2JqKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgaGFuZGxlcnMucHVzaChoYW5kbGVPYmopOwogICAgICAgIH0KICAgICAgICAvLyBLZWVwIHRyYWNrIG9mIHdoaWNoIGV2ZW50cyBoYXZlIGV2ZXIgYmVlbiB1c2VkLCBmb3IgZXZlbnQgb3B0aW1pemF0aW9uCiAgICAgICAgalF1ZXJ5LmV2ZW50Lmdsb2JhbFt0eXBlXSA9IHRydWU7CiAgICAgIH0KICAgIH0sCiAgICAvLyBEZXRhY2ggYW4gZXZlbnQgb3Igc2V0IG9mIGV2ZW50cyBmcm9tIGFuIGVsZW1lbnQKICAgIHJlbW92ZTogZnVuY3Rpb24gKGVsZW0sIHR5cGVzLCBoYW5kbGVyLCBzZWxlY3RvciwgbWFwcGVkVHlwZXMpIHsKICAgICAgdmFyIGosIG9yaWdDb3VudCwgdG1wLCBldmVudHMsIHQsIGhhbmRsZU9iaiwgc3BlY2lhbCwgaGFuZGxlcnMsIHR5cGUsIG5hbWVzcGFjZXMsIG9yaWdUeXBlLCBlbGVtRGF0YSA9IGRhdGFfcHJpdi5oYXNEYXRhKGVsZW0pICYmIGRhdGFfcHJpdi5nZXQoZWxlbSk7CiAgICAgIGlmICghZWxlbURhdGEgfHwgIShldmVudHMgPSBlbGVtRGF0YS5ldmVudHMpKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIC8vIE9uY2UgZm9yIGVhY2ggdHlwZS5uYW1lc3BhY2UgaW4gdHlwZXM7IHR5cGUgbWF5IGJlIG9taXR0ZWQKICAgICAgdHlwZXMgPSAodHlwZXMgfHwgJycpLm1hdGNoKHJub3R3aGl0ZSkgfHwgWycnXTsKICAgICAgdCA9IHR5cGVzLmxlbmd0aDsKICAgICAgd2hpbGUgKHQtLSkgewogICAgICAgIHRtcCA9IHJ0eXBlbmFtZXNwYWNlLmV4ZWModHlwZXNbdF0pIHx8IFtdOwogICAgICAgIHR5cGUgPSBvcmlnVHlwZSA9IHRtcFsxXTsKICAgICAgICBuYW1lc3BhY2VzID0gKHRtcFsyXSB8fCAnJykuc3BsaXQoJy4nKS5zb3J0KCk7CiAgICAgICAgLy8gVW5iaW5kIGFsbCBldmVudHMgKG9uIHRoaXMgbmFtZXNwYWNlLCBpZiBwcm92aWRlZCkgZm9yIHRoZSBlbGVtZW50CiAgICAgICAgaWYgKCF0eXBlKSB7CiAgICAgICAgICBmb3IgKHR5cGUgaW4gZXZlbnRzKSB7CiAgICAgICAgICAgIGpRdWVyeS5ldmVudC5yZW1vdmUoZWxlbSwgdHlwZSArIHR5cGVzW3RdLCBoYW5kbGVyLCBzZWxlY3RvciwgdHJ1ZSk7CiAgICAgICAgICB9CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CiAgICAgICAgc3BlY2lhbCA9IGpRdWVyeS5ldmVudC5zcGVjaWFsW3R5cGVdIHx8IHt9OwogICAgICAgIHR5cGUgPSAoc2VsZWN0b3IgPyBzcGVjaWFsLmRlbGVnYXRlVHlwZSA6IHNwZWNpYWwuYmluZFR5cGUpIHx8IHR5cGU7CiAgICAgICAgaGFuZGxlcnMgPSBldmVudHNbdHlwZV0gfHwgW107CiAgICAgICAgdG1wID0gdG1wWzJdICYmIG5ldyBSZWdFeHAoJyhefFxcLiknICsgbmFtZXNwYWNlcy5qb2luKCdcXC4oPzouKlxcLnwpJykgKyAnKFxcLnwkKScpOwogICAgICAgIC8vIFJlbW92ZSBtYXRjaGluZyBldmVudHMKICAgICAgICBvcmlnQ291bnQgPSBqID0gaGFuZGxlcnMubGVuZ3RoOwogICAgICAgIHdoaWxlIChqLS0pIHsKICAgICAgICAgIGhhbmRsZU9iaiA9IGhhbmRsZXJzW2pdOwogICAgICAgICAgaWYgKChtYXBwZWRUeXBlcyB8fCBvcmlnVHlwZSA9PT0gaGFuZGxlT2JqLm9yaWdUeXBlKSAmJiAoIWhhbmRsZXIgfHwgaGFuZGxlci5ndWlkID09PSBoYW5kbGVPYmouZ3VpZCkgJiYgKCF0bXAgfHwgdG1wLnRlc3QoaGFuZGxlT2JqLm5hbWVzcGFjZSkpICYmICghc2VsZWN0b3IgfHwgc2VsZWN0b3IgPT09IGhhbmRsZU9iai5zZWxlY3RvciB8fCBzZWxlY3RvciA9PT0gJyoqJyAmJiBoYW5kbGVPYmouc2VsZWN0b3IpKSB7CiAgICAgICAgICAgIGhhbmRsZXJzLnNwbGljZShqLCAxKTsKICAgICAgICAgICAgaWYgKGhhbmRsZU9iai5zZWxlY3RvcikgewogICAgICAgICAgICAgIGhhbmRsZXJzLmRlbGVnYXRlQ291bnQtLTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoc3BlY2lhbC5yZW1vdmUpIHsKICAgICAgICAgICAgICBzcGVjaWFsLnJlbW92ZS5jYWxsKGVsZW0sIGhhbmRsZU9iaik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgLy8gUmVtb3ZlIGdlbmVyaWMgZXZlbnQgaGFuZGxlciBpZiB3ZSByZW1vdmVkIHNvbWV0aGluZyBhbmQgbm8gbW9yZSBoYW5kbGVycyBleGlzdAogICAgICAgIC8vIChhdm9pZHMgcG90ZW50aWFsIGZvciBlbmRsZXNzIHJlY3Vyc2lvbiBkdXJpbmcgcmVtb3ZhbCBvZiBzcGVjaWFsIGV2ZW50IGhhbmRsZXJzKQogICAgICAgIGlmIChvcmlnQ291bnQgJiYgIWhhbmRsZXJzLmxlbmd0aCkgewogICAgICAgICAgaWYgKCFzcGVjaWFsLnRlYXJkb3duIHx8IHNwZWNpYWwudGVhcmRvd24uY2FsbChlbGVtLCBuYW1lc3BhY2VzLCBlbGVtRGF0YS5oYW5kbGUpID09PSBmYWxzZSkgewogICAgICAgICAgICBqUXVlcnkucmVtb3ZlRXZlbnQoZWxlbSwgdHlwZSwgZWxlbURhdGEuaGFuZGxlKTsKICAgICAgICAgIH0KICAgICAgICAgIGRlbGV0ZSBldmVudHNbdHlwZV07CiAgICAgICAgfQogICAgICB9CiAgICAgIC8vIFJlbW92ZSB0aGUgZXhwYW5kbyBpZiBpdCdzIG5vIGxvbmdlciB1c2VkCiAgICAgIGlmIChqUXVlcnkuaXNFbXB0eU9iamVjdChldmVudHMpKSB7CiAgICAgICAgZGVsZXRlIGVsZW1EYXRhLmhhbmRsZTsKICAgICAgICBkYXRhX3ByaXYucmVtb3ZlKGVsZW0sICdldmVudHMnKTsKICAgICAgfQogICAgfSwKICAgIHRyaWdnZXI6IGZ1bmN0aW9uIChldmVudCwgZGF0YSwgZWxlbSwgb25seUhhbmRsZXJzKSB7CiAgICAgIHZhciBpLCBjdXIsIHRtcCwgYnViYmxlVHlwZSwgb250eXBlLCBoYW5kbGUsIHNwZWNpYWwsIGV2ZW50UGF0aCA9IFtlbGVtIHx8IGRvY3VtZW50XSwgdHlwZSA9IGhhc093bi5jYWxsKGV2ZW50LCAndHlwZScpID8gZXZlbnQudHlwZSA6IGV2ZW50LCBuYW1lc3BhY2VzID0gaGFzT3duLmNhbGwoZXZlbnQsICduYW1lc3BhY2UnKSA/IGV2ZW50Lm5hbWVzcGFjZS5zcGxpdCgnLicpIDogW107CiAgICAgIGN1ciA9IHRtcCA9IGVsZW0gPSBlbGVtIHx8IGRvY3VtZW50OwogICAgICAvLyBEb24ndCBkbyBldmVudHMgb24gdGV4dCBhbmQgY29tbWVudCBub2RlcwogICAgICBpZiAoZWxlbS5ub2RlVHlwZSA9PT0gMyB8fCBlbGVtLm5vZGVUeXBlID09PSA4KSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIC8vIGZvY3VzL2JsdXIgbW9ycGhzIHRvIGZvY3VzaW4vb3V0OyBlbnN1cmUgd2UncmUgbm90IGZpcmluZyB0aGVtIHJpZ2h0IG5vdwogICAgICBpZiAocmZvY3VzTW9ycGgudGVzdCh0eXBlICsgalF1ZXJ5LmV2ZW50LnRyaWdnZXJlZCkpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgaWYgKHR5cGUuaW5kZXhPZignLicpID49IDApIHsKICAgICAgICAvLyBOYW1lc3BhY2VkIHRyaWdnZXI7IGNyZWF0ZSBhIHJlZ2V4cCB0byBtYXRjaCBldmVudCB0eXBlIGluIGhhbmRsZSgpCiAgICAgICAgbmFtZXNwYWNlcyA9IHR5cGUuc3BsaXQoJy4nKTsKICAgICAgICB0eXBlID0gbmFtZXNwYWNlcy5zaGlmdCgpOwogICAgICAgIG5hbWVzcGFjZXMuc29ydCgpOwogICAgICB9CiAgICAgIG9udHlwZSA9IHR5cGUuaW5kZXhPZignOicpIDwgMCAmJiAnb24nICsgdHlwZTsKICAgICAgLy8gQ2FsbGVyIGNhbiBwYXNzIGluIGEgalF1ZXJ5LkV2ZW50IG9iamVjdCwgT2JqZWN0LCBvciBqdXN0IGFuIGV2ZW50IHR5cGUgc3RyaW5nCiAgICAgIGV2ZW50ID0gZXZlbnRbalF1ZXJ5LmV4cGFuZG9dID8gZXZlbnQgOiBuZXcgalF1ZXJ5LkV2ZW50KHR5cGUsIHR5cGVvZiBldmVudCA9PT0gJ29iamVjdCcgJiYgZXZlbnQpOwogICAgICAvLyBUcmlnZ2VyIGJpdG1hc2s6ICYgMSBmb3IgbmF0aXZlIGhhbmRsZXJzOyAmIDIgZm9yIGpRdWVyeSAoYWx3YXlzIHRydWUpCiAgICAgIGV2ZW50LmlzVHJpZ2dlciA9IG9ubHlIYW5kbGVycyA/IDIgOiAzOwogICAgICBldmVudC5uYW1lc3BhY2UgPSBuYW1lc3BhY2VzLmpvaW4oJy4nKTsKICAgICAgZXZlbnQubmFtZXNwYWNlX3JlID0gZXZlbnQubmFtZXNwYWNlID8gbmV3IFJlZ0V4cCgnKF58XFwuKScgKyBuYW1lc3BhY2VzLmpvaW4oJ1xcLig/Oi4qXFwufCknKSArICcoXFwufCQpJykgOiBudWxsOwogICAgICAvLyBDbGVhbiB1cCB0aGUgZXZlbnQgaW4gY2FzZSBpdCBpcyBiZWluZyByZXVzZWQKICAgICAgZXZlbnQucmVzdWx0ID0gdW5kZWZpbmVkOwogICAgICBpZiAoIWV2ZW50LnRhcmdldCkgewogICAgICAgIGV2ZW50LnRhcmdldCA9IGVsZW07CiAgICAgIH0KICAgICAgLy8gQ2xvbmUgYW55IGluY29taW5nIGRhdGEgYW5kIHByZXBlbmQgdGhlIGV2ZW50LCBjcmVhdGluZyB0aGUgaGFuZGxlciBhcmcgbGlzdAogICAgICBkYXRhID0gZGF0YSA9PSBudWxsID8gW2V2ZW50XSA6IGpRdWVyeS5tYWtlQXJyYXkoZGF0YSwgW2V2ZW50XSk7CiAgICAgIC8vIEFsbG93IHNwZWNpYWwgZXZlbnRzIHRvIGRyYXcgb3V0c2lkZSB0aGUgbGluZXMKICAgICAgc3BlY2lhbCA9IGpRdWVyeS5ldmVudC5zcGVjaWFsW3R5cGVdIHx8IHt9OwogICAgICBpZiAoIW9ubHlIYW5kbGVycyAmJiBzcGVjaWFsLnRyaWdnZXIgJiYgc3BlY2lhbC50cmlnZ2VyLmFwcGx5KGVsZW0sIGRhdGEpID09PSBmYWxzZSkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICAvLyBEZXRlcm1pbmUgZXZlbnQgcHJvcGFnYXRpb24gcGF0aCBpbiBhZHZhbmNlLCBwZXIgVzNDIGV2ZW50cyBzcGVjICgjOTk1MSkKICAgICAgLy8gQnViYmxlIHVwIHRvIGRvY3VtZW50LCB0aGVuIHRvIHdpbmRvdzsgd2F0Y2ggZm9yIGEgZ2xvYmFsIG93bmVyRG9jdW1lbnQgdmFyICgjOTcyNCkKICAgICAgaWYgKCFvbmx5SGFuZGxlcnMgJiYgIXNwZWNpYWwubm9CdWJibGUgJiYgIWpRdWVyeS5pc1dpbmRvdyhlbGVtKSkgewogICAgICAgIGJ1YmJsZVR5cGUgPSBzcGVjaWFsLmRlbGVnYXRlVHlwZSB8fCB0eXBlOwogICAgICAgIGlmICghcmZvY3VzTW9ycGgudGVzdChidWJibGVUeXBlICsgdHlwZSkpIHsKICAgICAgICAgIGN1ciA9IGN1ci5wYXJlbnROb2RlOwogICAgICAgIH0KICAgICAgICBmb3IgKDsgY3VyOyBjdXIgPSBjdXIucGFyZW50Tm9kZSkgewogICAgICAgICAgZXZlbnRQYXRoLnB1c2goY3VyKTsKICAgICAgICAgIHRtcCA9IGN1cjsKICAgICAgICB9CiAgICAgICAgLy8gT25seSBhZGQgd2luZG93IGlmIHdlIGdvdCB0byBkb2N1bWVudCAoZS5nLiwgbm90IHBsYWluIG9iaiBvciBkZXRhY2hlZCBET00pCiAgICAgICAgaWYgKHRtcCA9PT0gKGVsZW0ub3duZXJEb2N1bWVudCB8fCBkb2N1bWVudCkpIHsKICAgICAgICAgIGV2ZW50UGF0aC5wdXNoKHRtcC5kZWZhdWx0VmlldyB8fCB0bXAucGFyZW50V2luZG93IHx8IHdpbmRvdyk7CiAgICAgICAgfQogICAgICB9CiAgICAgIC8vIEZpcmUgaGFuZGxlcnMgb24gdGhlIGV2ZW50IHBhdGgKICAgICAgaSA9IDA7CiAgICAgIHdoaWxlICgoY3VyID0gZXZlbnRQYXRoW2krK10pICYmICFldmVudC5pc1Byb3BhZ2F0aW9uU3RvcHBlZCgpKSB7CiAgICAgICAgZXZlbnQudHlwZSA9IGkgPiAxID8gYnViYmxlVHlwZSA6IHNwZWNpYWwuYmluZFR5cGUgfHwgdHlwZTsKICAgICAgICAvLyBqUXVlcnkgaGFuZGxlcgogICAgICAgIGhhbmRsZSA9IChkYXRhX3ByaXYuZ2V0KGN1ciwgJ2V2ZW50cycpIHx8IHt9KVtldmVudC50eXBlXSAmJiBkYXRhX3ByaXYuZ2V0KGN1ciwgJ2hhbmRsZScpOwogICAgICAgIGlmIChoYW5kbGUpIHsKICAgICAgICAgIGhhbmRsZS5hcHBseShjdXIsIGRhdGEpOwogICAgICAgIH0KICAgICAgICAvLyBOYXRpdmUgaGFuZGxlcgogICAgICAgIGhhbmRsZSA9IG9udHlwZSAmJiBjdXJbb250eXBlXTsKICAgICAgICBpZiAoaGFuZGxlICYmIGhhbmRsZS5hcHBseSAmJiBqUXVlcnkuYWNjZXB0RGF0YShjdXIpKSB7CiAgICAgICAgICBldmVudC5yZXN1bHQgPSBoYW5kbGUuYXBwbHkoY3VyLCBkYXRhKTsKICAgICAgICAgIGlmIChldmVudC5yZXN1bHQgPT09IGZhbHNlKSB7CiAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIGV2ZW50LnR5cGUgPSB0eXBlOwogICAgICAvLyBJZiBub2JvZHkgcHJldmVudGVkIHRoZSBkZWZhdWx0IGFjdGlvbiwgZG8gaXQgbm93CiAgICAgIGlmICghb25seUhhbmRsZXJzICYmICFldmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSkgewogICAgICAgIGlmICgoIXNwZWNpYWwuX2RlZmF1bHQgfHwgc3BlY2lhbC5fZGVmYXVsdC5hcHBseShldmVudFBhdGgucG9wKCksIGRhdGEpID09PSBmYWxzZSkgJiYgalF1ZXJ5LmFjY2VwdERhdGEoZWxlbSkpIHsKICAgICAgICAgIC8vIENhbGwgYSBuYXRpdmUgRE9NIG1ldGhvZCBvbiB0aGUgdGFyZ2V0IHdpdGggdGhlIHNhbWUgbmFtZSBuYW1lIGFzIHRoZSBldmVudC4KICAgICAgICAgIC8vIERvbid0IGRvIGRlZmF1bHQgYWN0aW9ucyBvbiB3aW5kb3csIHRoYXQncyB3aGVyZSBnbG9iYWwgdmFyaWFibGVzIGJlICgjNjE3MCkKICAgICAgICAgIGlmIChvbnR5cGUgJiYgalF1ZXJ5LmlzRnVuY3Rpb24oZWxlbVt0eXBlXSkgJiYgIWpRdWVyeS5pc1dpbmRvdyhlbGVtKSkgewogICAgICAgICAgICAvLyBEb24ndCByZS10cmlnZ2VyIGFuIG9uRk9PIGV2ZW50IHdoZW4gd2UgY2FsbCBpdHMgRk9PKCkgbWV0aG9kCiAgICAgICAgICAgIHRtcCA9IGVsZW1bb250eXBlXTsKICAgICAgICAgICAgaWYgKHRtcCkgewogICAgICAgICAgICAgIGVsZW1bb250eXBlXSA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gUHJldmVudCByZS10cmlnZ2VyaW5nIG9mIHRoZSBzYW1lIGV2ZW50LCBzaW5jZSB3ZSBhbHJlYWR5IGJ1YmJsZWQgaXQgYWJvdmUKICAgICAgICAgICAgalF1ZXJ5LmV2ZW50LnRyaWdnZXJlZCA9IHR5cGU7CiAgICAgICAgICAgIGVsZW1bdHlwZV0oKTsKICAgICAgICAgICAgalF1ZXJ5LmV2ZW50LnRyaWdnZXJlZCA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgaWYgKHRtcCkgewogICAgICAgICAgICAgIGVsZW1bb250eXBlXSA9IHRtcDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gZXZlbnQucmVzdWx0OwogICAgfSwKICAgIGRpc3BhdGNoOiBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgLy8gTWFrZSBhIHdyaXRhYmxlIGpRdWVyeS5FdmVudCBmcm9tIHRoZSBuYXRpdmUgZXZlbnQgb2JqZWN0CiAgICAgIGV2ZW50ID0galF1ZXJ5LmV2ZW50LmZpeChldmVudCk7CiAgICAgIHZhciBpLCBqLCByZXQsIG1hdGNoZWQsIGhhbmRsZU9iaiwgaGFuZGxlclF1ZXVlID0gW10sIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cyksIGhhbmRsZXJzID0gKGRhdGFfcHJpdi5nZXQodGhpcywgJ2V2ZW50cycpIHx8IHt9KVtldmVudC50eXBlXSB8fCBbXSwgc3BlY2lhbCA9IGpRdWVyeS5ldmVudC5zcGVjaWFsW2V2ZW50LnR5cGVdIHx8IHt9OwogICAgICAvLyBVc2UgdGhlIGZpeC1lZCBqUXVlcnkuRXZlbnQgcmF0aGVyIHRoYW4gdGhlIChyZWFkLW9ubHkpIG5hdGl2ZSBldmVudAogICAgICBhcmdzWzBdID0gZXZlbnQ7CiAgICAgIGV2ZW50LmRlbGVnYXRlVGFyZ2V0ID0gdGhpczsKICAgICAgLy8gQ2FsbCB0aGUgcHJlRGlzcGF0Y2ggaG9vayBmb3IgdGhlIG1hcHBlZCB0eXBlLCBhbmQgbGV0IGl0IGJhaWwgaWYgZGVzaXJlZAogICAgICBpZiAoc3BlY2lhbC5wcmVEaXNwYXRjaCAmJiBzcGVjaWFsLnByZURpc3BhdGNoLmNhbGwodGhpcywgZXZlbnQpID09PSBmYWxzZSkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICAvLyBEZXRlcm1pbmUgaGFuZGxlcnMKICAgICAgaGFuZGxlclF1ZXVlID0galF1ZXJ5LmV2ZW50LmhhbmRsZXJzLmNhbGwodGhpcywgZXZlbnQsIGhhbmRsZXJzKTsKICAgICAgLy8gUnVuIGRlbGVnYXRlcyBmaXJzdDsgdGhleSBtYXkgd2FudCB0byBzdG9wIHByb3BhZ2F0aW9uIGJlbmVhdGggdXMKICAgICAgaSA9IDA7CiAgICAgIHdoaWxlICgobWF0Y2hlZCA9IGhhbmRsZXJRdWV1ZVtpKytdKSAmJiAhZXZlbnQuaXNQcm9wYWdhdGlvblN0b3BwZWQoKSkgewogICAgICAgIGV2ZW50LmN1cnJlbnRUYXJnZXQgPSBtYXRjaGVkLmVsZW07CiAgICAgICAgaiA9IDA7CiAgICAgICAgd2hpbGUgKChoYW5kbGVPYmogPSBtYXRjaGVkLmhhbmRsZXJzW2orK10pICYmICFldmVudC5pc0ltbWVkaWF0ZVByb3BhZ2F0aW9uU3RvcHBlZCgpKSB7CiAgICAgICAgICAvLyBUcmlnZ2VyZWQgZXZlbnQgbXVzdCBlaXRoZXIgMSkgaGF2ZSBubyBuYW1lc3BhY2UsIG9yCiAgICAgICAgICAvLyAyKSBoYXZlIG5hbWVzcGFjZShzKSBhIHN1YnNldCBvciBlcXVhbCB0byB0aG9zZSBpbiB0aGUgYm91bmQgZXZlbnQgKGJvdGggY2FuIGhhdmUgbm8gbmFtZXNwYWNlKS4KICAgICAgICAgIGlmICghZXZlbnQubmFtZXNwYWNlX3JlIHx8IGV2ZW50Lm5hbWVzcGFjZV9yZS50ZXN0KGhhbmRsZU9iai5uYW1lc3BhY2UpKSB7CiAgICAgICAgICAgIGV2ZW50LmhhbmRsZU9iaiA9IGhhbmRsZU9iajsKICAgICAgICAgICAgZXZlbnQuZGF0YSA9IGhhbmRsZU9iai5kYXRhOwogICAgICAgICAgICByZXQgPSAoKGpRdWVyeS5ldmVudC5zcGVjaWFsW2hhbmRsZU9iai5vcmlnVHlwZV0gfHwge30pLmhhbmRsZSB8fCBoYW5kbGVPYmouaGFuZGxlcikuYXBwbHkobWF0Y2hlZC5lbGVtLCBhcmdzKTsKICAgICAgICAgICAgaWYgKHJldCAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgaWYgKChldmVudC5yZXN1bHQgPSByZXQpID09PSBmYWxzZSkgewogICAgICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICAvLyBDYWxsIHRoZSBwb3N0RGlzcGF0Y2ggaG9vayBmb3IgdGhlIG1hcHBlZCB0eXBlCiAgICAgIGlmIChzcGVjaWFsLnBvc3REaXNwYXRjaCkgewogICAgICAgIHNwZWNpYWwucG9zdERpc3BhdGNoLmNhbGwodGhpcywgZXZlbnQpOwogICAgICB9CiAgICAgIHJldHVybiBldmVudC5yZXN1bHQ7CiAgICB9LAogICAgaGFuZGxlcnM6IGZ1bmN0aW9uIChldmVudCwgaGFuZGxlcnMpIHsKICAgICAgdmFyIGksIG1hdGNoZXMsIHNlbCwgaGFuZGxlT2JqLCBoYW5kbGVyUXVldWUgPSBbXSwgZGVsZWdhdGVDb3VudCA9IGhhbmRsZXJzLmRlbGVnYXRlQ291bnQsIGN1ciA9IGV2ZW50LnRhcmdldDsKICAgICAgLy8gRmluZCBkZWxlZ2F0ZSBoYW5kbGVycwogICAgICAvLyBCbGFjay1ob2xlIFNWRyA8dXNlPiBpbnN0YW5jZSB0cmVlcyAoIzEzMTgwKQogICAgICAvLyBBdm9pZCBub24tbGVmdC1jbGljayBidWJibGluZyBpbiBGaXJlZm94ICgjMzg2MSkKICAgICAgaWYgKGRlbGVnYXRlQ291bnQgJiYgY3VyLm5vZGVUeXBlICYmICghZXZlbnQuYnV0dG9uIHx8IGV2ZW50LnR5cGUgIT09ICdjbGljaycpKSB7CiAgICAgICAgZm9yICg7IGN1ciAhPT0gdGhpczsgY3VyID0gY3VyLnBhcmVudE5vZGUgfHwgdGhpcykgewogICAgICAgICAgLy8gRG9uJ3QgcHJvY2VzcyBjbGlja3Mgb24gZGlzYWJsZWQgZWxlbWVudHMgKCM2OTExLCAjODE2NSwgIzExMzgyLCAjMTE3NjQpCiAgICAgICAgICBpZiAoY3VyLmRpc2FibGVkICE9PSB0cnVlIHx8IGV2ZW50LnR5cGUgIT09ICdjbGljaycpIHsKICAgICAgICAgICAgbWF0Y2hlcyA9IFtdOwogICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgZGVsZWdhdGVDb3VudDsgaSsrKSB7CiAgICAgICAgICAgICAgaGFuZGxlT2JqID0gaGFuZGxlcnNbaV07CiAgICAgICAgICAgICAgLy8gRG9uJ3QgY29uZmxpY3Qgd2l0aCBPYmplY3QucHJvdG90eXBlIHByb3BlcnRpZXMgKCMxMzIwMykKICAgICAgICAgICAgICBzZWwgPSBoYW5kbGVPYmouc2VsZWN0b3IgKyAnICc7CiAgICAgICAgICAgICAgaWYgKG1hdGNoZXNbc2VsXSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICBtYXRjaGVzW3NlbF0gPSBoYW5kbGVPYmoubmVlZHNDb250ZXh0ID8galF1ZXJ5KHNlbCwgdGhpcykuaW5kZXgoY3VyKSA+PSAwIDogalF1ZXJ5LmZpbmQoc2VsLCB0aGlzLCBudWxsLCBbY3VyXSkubGVuZ3RoOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAobWF0Y2hlc1tzZWxdKSB7CiAgICAgICAgICAgICAgICBtYXRjaGVzLnB1c2goaGFuZGxlT2JqKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG1hdGNoZXMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgaGFuZGxlclF1ZXVlLnB1c2goewogICAgICAgICAgICAgICAgZWxlbTogY3VyLAogICAgICAgICAgICAgICAgaGFuZGxlcnM6IG1hdGNoZXMKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICAvLyBBZGQgdGhlIHJlbWFpbmluZyAoZGlyZWN0bHktYm91bmQpIGhhbmRsZXJzCiAgICAgIGlmIChkZWxlZ2F0ZUNvdW50IDwgaGFuZGxlcnMubGVuZ3RoKSB7CiAgICAgICAgaGFuZGxlclF1ZXVlLnB1c2goewogICAgICAgICAgZWxlbTogdGhpcywKICAgICAgICAgIGhhbmRsZXJzOiBoYW5kbGVycy5zbGljZShkZWxlZ2F0ZUNvdW50KQogICAgICAgIH0pOwogICAgICB9CiAgICAgIHJldHVybiBoYW5kbGVyUXVldWU7CiAgICB9LAogICAgLy8gSW5jbHVkZXMgc29tZSBldmVudCBwcm9wcyBzaGFyZWQgYnkgS2V5RXZlbnQgYW5kIE1vdXNlRXZlbnQKICAgIHByb3BzOiAnYWx0S2V5IGJ1YmJsZXMgY2FuY2VsYWJsZSBjdHJsS2V5IGN1cnJlbnRUYXJnZXQgZXZlbnRQaGFzZSBtZXRhS2V5IHJlbGF0ZWRUYXJnZXQgc2hpZnRLZXkgdGFyZ2V0IHRpbWVTdGFtcCB2aWV3IHdoaWNoJy5zcGxpdCgnICcpLAogICAgZml4SG9va3M6IHt9LAogICAga2V5SG9va3M6IHsKICAgICAgcHJvcHM6ICdjaGFyIGNoYXJDb2RlIGtleSBrZXlDb2RlJy5zcGxpdCgnICcpLAogICAgICBmaWx0ZXI6IGZ1bmN0aW9uIChldmVudCwgb3JpZ2luYWwpIHsKICAgICAgICAvLyBBZGQgd2hpY2ggZm9yIGtleSBldmVudHMKICAgICAgICBpZiAoZXZlbnQud2hpY2ggPT0gbnVsbCkgewogICAgICAgICAgZXZlbnQud2hpY2ggPSBvcmlnaW5hbC5jaGFyQ29kZSAhPSBudWxsID8gb3JpZ2luYWwuY2hhckNvZGUgOiBvcmlnaW5hbC5rZXlDb2RlOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZXZlbnQ7CiAgICAgIH0KICAgIH0sCiAgICBtb3VzZUhvb2tzOiB7CiAgICAgIHByb3BzOiAnYnV0dG9uIGJ1dHRvbnMgY2xpZW50WCBjbGllbnRZIG9mZnNldFggb2Zmc2V0WSBwYWdlWCBwYWdlWSBzY3JlZW5YIHNjcmVlblkgdG9FbGVtZW50Jy5zcGxpdCgnICcpLAogICAgICBmaWx0ZXI6IGZ1bmN0aW9uIChldmVudCwgb3JpZ2luYWwpIHsKICAgICAgICB2YXIgZXZlbnREb2MsIGRvYywgYm9keSwgYnV0dG9uID0gb3JpZ2luYWwuYnV0dG9uOwogICAgICAgIC8vIENhbGN1bGF0ZSBwYWdlWC9ZIGlmIG1pc3NpbmcgYW5kIGNsaWVudFgvWSBhdmFpbGFibGUKICAgICAgICBpZiAoZXZlbnQucGFnZVggPT0gbnVsbCAmJiBvcmlnaW5hbC5jbGllbnRYICE9IG51bGwpIHsKICAgICAgICAgIGV2ZW50RG9jID0gZXZlbnQudGFyZ2V0Lm93bmVyRG9jdW1lbnQgfHwgZG9jdW1lbnQ7CiAgICAgICAgICBkb2MgPSBldmVudERvYy5kb2N1bWVudEVsZW1lbnQ7CiAgICAgICAgICBib2R5ID0gZXZlbnREb2MuYm9keTsKICAgICAgICAgIGV2ZW50LnBhZ2VYID0gb3JpZ2luYWwuY2xpZW50WCArIChkb2MgJiYgZG9jLnNjcm9sbExlZnQgfHwgYm9keSAmJiBib2R5LnNjcm9sbExlZnQgfHwgMCkgLSAoZG9jICYmIGRvYy5jbGllbnRMZWZ0IHx8IGJvZHkgJiYgYm9keS5jbGllbnRMZWZ0IHx8IDApOwogICAgICAgICAgZXZlbnQucGFnZVkgPSBvcmlnaW5hbC5jbGllbnRZICsgKGRvYyAmJiBkb2Muc2Nyb2xsVG9wIHx8IGJvZHkgJiYgYm9keS5zY3JvbGxUb3AgfHwgMCkgLSAoZG9jICYmIGRvYy5jbGllbnRUb3AgfHwgYm9keSAmJiBib2R5LmNsaWVudFRvcCB8fCAwKTsKICAgICAgICB9CiAgICAgICAgLy8gQWRkIHdoaWNoIGZvciBjbGljazogMSA9PT0gbGVmdDsgMiA9PT0gbWlkZGxlOyAzID09PSByaWdodAogICAgICAgIC8vIE5vdGU6IGJ1dHRvbiBpcyBub3Qgbm9ybWFsaXplZCwgc28gZG9uJ3QgdXNlIGl0CiAgICAgICAgaWYgKCFldmVudC53aGljaCAmJiBidXR0b24gIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgZXZlbnQud2hpY2ggPSBidXR0b24gJiAxID8gMSA6IGJ1dHRvbiAmIDIgPyAzIDogYnV0dG9uICYgNCA/IDIgOiAwOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZXZlbnQ7CiAgICAgIH0KICAgIH0sCiAgICBmaXg6IGZ1bmN0aW9uIChldmVudCkgewogICAgICBpZiAoZXZlbnRbalF1ZXJ5LmV4cGFuZG9dKSB7CiAgICAgICAgcmV0dXJuIGV2ZW50OwogICAgICB9CiAgICAgIC8vIENyZWF0ZSBhIHdyaXRhYmxlIGNvcHkgb2YgdGhlIGV2ZW50IG9iamVjdCBhbmQgbm9ybWFsaXplIHNvbWUgcHJvcGVydGllcwogICAgICB2YXIgaSwgcHJvcCwgY29weSwgdHlwZSA9IGV2ZW50LnR5cGUsIG9yaWdpbmFsRXZlbnQgPSBldmVudCwgZml4SG9vayA9IHRoaXMuZml4SG9va3NbdHlwZV07CiAgICAgIGlmICghZml4SG9vaykgewogICAgICAgIHRoaXMuZml4SG9va3NbdHlwZV0gPSBmaXhIb29rID0gcm1vdXNlRXZlbnQudGVzdCh0eXBlKSA/IHRoaXMubW91c2VIb29rcyA6IHJrZXlFdmVudC50ZXN0KHR5cGUpID8gdGhpcy5rZXlIb29rcyA6IHt9OwogICAgICB9CiAgICAgIGNvcHkgPSBmaXhIb29rLnByb3BzID8gdGhpcy5wcm9wcy5jb25jYXQoZml4SG9vay5wcm9wcykgOiB0aGlzLnByb3BzOwogICAgICBldmVudCA9IG5ldyBqUXVlcnkuRXZlbnQob3JpZ2luYWxFdmVudCk7CiAgICAgIGkgPSBjb3B5Lmxlbmd0aDsKICAgICAgd2hpbGUgKGktLSkgewogICAgICAgIHByb3AgPSBjb3B5W2ldOwogICAgICAgIGV2ZW50W3Byb3BdID0gb3JpZ2luYWxFdmVudFtwcm9wXTsKICAgICAgfQogICAgICAvLyBTdXBwb3J0OiBDb3Jkb3ZhIDIuNSAoV2ViS2l0KSAoIzEzMjU1KQogICAgICAvLyBBbGwgZXZlbnRzIHNob3VsZCBoYXZlIGEgdGFyZ2V0OyBDb3Jkb3ZhIGRldmljZXJlYWR5IGRvZXNuJ3QKICAgICAgaWYgKCFldmVudC50YXJnZXQpIHsKICAgICAgICBldmVudC50YXJnZXQgPSBkb2N1bWVudDsKICAgICAgfQogICAgICAvLyBTdXBwb3J0OiBTYWZhcmkgNi4wKywgQ2hyb21lIDwgMjgKICAgICAgLy8gVGFyZ2V0IHNob3VsZCBub3QgYmUgYSB0ZXh0IG5vZGUgKCM1MDQsICMxMzE0MykKICAgICAgaWYgKGV2ZW50LnRhcmdldC5ub2RlVHlwZSA9PT0gMykgewogICAgICAgIGV2ZW50LnRhcmdldCA9IGV2ZW50LnRhcmdldC5wYXJlbnROb2RlOwogICAgICB9CiAgICAgIHJldHVybiBmaXhIb29rLmZpbHRlciA/IGZpeEhvb2suZmlsdGVyKGV2ZW50LCBvcmlnaW5hbEV2ZW50KSA6IGV2ZW50OwogICAgfSwKICAgIHNwZWNpYWw6IHsKICAgICAgbG9hZDogewogICAgICAgIC8vIFByZXZlbnQgdHJpZ2dlcmVkIGltYWdlLmxvYWQgZXZlbnRzIGZyb20gYnViYmxpbmcgdG8gd2luZG93LmxvYWQKICAgICAgICBub0J1YmJsZTogdHJ1ZQogICAgICB9LAogICAgICBmb2N1czogewogICAgICAgIC8vIEZpcmUgbmF0aXZlIGV2ZW50IGlmIHBvc3NpYmxlIHNvIGJsdXIvZm9jdXMgc2VxdWVuY2UgaXMgY29ycmVjdAogICAgICAgIHRyaWdnZXI6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGlmICh0aGlzICE9PSBzYWZlQWN0aXZlRWxlbWVudCgpICYmIHRoaXMuZm9jdXMpIHsKICAgICAgICAgICAgdGhpcy5mb2N1cygpOwogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBkZWxlZ2F0ZVR5cGU6ICdmb2N1c2luJwogICAgICB9LAogICAgICBibHVyOiB7CiAgICAgICAgdHJpZ2dlcjogZnVuY3Rpb24gKCkgewogICAgICAgICAgaWYgKHRoaXMgPT09IHNhZmVBY3RpdmVFbGVtZW50KCkgJiYgdGhpcy5ibHVyKSB7CiAgICAgICAgICAgIHRoaXMuYmx1cigpOwogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBkZWxlZ2F0ZVR5cGU6ICdmb2N1c291dCcKICAgICAgfSwKICAgICAgY2xpY2s6IHsKICAgICAgICAvLyBGb3IgY2hlY2tib3gsIGZpcmUgbmF0aXZlIGV2ZW50IHNvIGNoZWNrZWQgc3RhdGUgd2lsbCBiZSByaWdodAogICAgICAgIHRyaWdnZXI6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGlmICh0aGlzLnR5cGUgPT09ICdjaGVja2JveCcgJiYgdGhpcy5jbGljayAmJiBqUXVlcnkubm9kZU5hbWUodGhpcywgJ2lucHV0JykpIHsKICAgICAgICAgICAgdGhpcy5jbGljaygpOwogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAvLyBGb3IgY3Jvc3MtYnJvd3NlciBjb25zaXN0ZW5jeSwgZG9uJ3QgZmlyZSBuYXRpdmUgLmNsaWNrKCkgb24gbGlua3MKICAgICAgICBfZGVmYXVsdDogZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgICByZXR1cm4galF1ZXJ5Lm5vZGVOYW1lKGV2ZW50LnRhcmdldCwgJ2EnKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIGJlZm9yZXVubG9hZDogewogICAgICAgIHBvc3REaXNwYXRjaDogZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgICAvLyBTdXBwb3J0OiBGaXJlZm94IDIwKwogICAgICAgICAgLy8gRmlyZWZveCBkb2Vzbid0IGFsZXJ0IGlmIHRoZSByZXR1cm5WYWx1ZSBmaWVsZCBpcyBub3Qgc2V0LgogICAgICAgICAgaWYgKGV2ZW50LnJlc3VsdCAhPT0gdW5kZWZpbmVkICYmIGV2ZW50Lm9yaWdpbmFsRXZlbnQpIHsKICAgICAgICAgICAgZXZlbnQub3JpZ2luYWxFdmVudC5yZXR1cm5WYWx1ZSA9IGV2ZW50LnJlc3VsdDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICBzaW11bGF0ZTogZnVuY3Rpb24gKHR5cGUsIGVsZW0sIGV2ZW50LCBidWJibGUpIHsKICAgICAgLy8gUGlnZ3liYWNrIG9uIGEgZG9ub3IgZXZlbnQgdG8gc2ltdWxhdGUgYSBkaWZmZXJlbnQgb25lLgogICAgICAvLyBGYWtlIG9yaWdpbmFsRXZlbnQgdG8gYXZvaWQgZG9ub3IncyBzdG9wUHJvcGFnYXRpb24sIGJ1dCBpZiB0aGUKICAgICAgLy8gc2ltdWxhdGVkIGV2ZW50IHByZXZlbnRzIGRlZmF1bHQgdGhlbiB3ZSBkbyB0aGUgc2FtZSBvbiB0aGUgZG9ub3IuCiAgICAgIHZhciBlID0galF1ZXJ5LmV4dGVuZChuZXcgalF1ZXJ5LkV2ZW50KCksIGV2ZW50LCB7CiAgICAgICAgdHlwZTogdHlwZSwKICAgICAgICBpc1NpbXVsYXRlZDogdHJ1ZSwKICAgICAgICBvcmlnaW5hbEV2ZW50OiB7fQogICAgICB9KTsKICAgICAgaWYgKGJ1YmJsZSkgewogICAgICAgIGpRdWVyeS5ldmVudC50cmlnZ2VyKGUsIG51bGwsIGVsZW0pOwogICAgICB9IGVsc2UgewogICAgICAgIGpRdWVyeS5ldmVudC5kaXNwYXRjaC5jYWxsKGVsZW0sIGUpOwogICAgICB9CiAgICAgIGlmIChlLmlzRGVmYXVsdFByZXZlbnRlZCgpKSB7CiAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgfQogICAgfQogIH07CiAgalF1ZXJ5LnJlbW92ZUV2ZW50ID0gZnVuY3Rpb24gKGVsZW0sIHR5cGUsIGhhbmRsZSkgewogICAgaWYgKGVsZW0ucmVtb3ZlRXZlbnRMaXN0ZW5lcikgewogICAgICBlbGVtLnJlbW92ZUV2ZW50TGlzdGVuZXIodHlwZSwgaGFuZGxlLCBmYWxzZSk7CiAgICB9CiAgfTsKICBqUXVlcnkuRXZlbnQgPSBmdW5jdGlvbiAoc3JjLCBwcm9wcykgewogICAgLy8gQWxsb3cgaW5zdGFudGlhdGlvbiB3aXRob3V0IHRoZSAnbmV3JyBrZXl3b3JkCiAgICBpZiAoISh0aGlzIGluc3RhbmNlb2YgalF1ZXJ5LkV2ZW50KSkgewogICAgICByZXR1cm4gbmV3IGpRdWVyeS5FdmVudChzcmMsIHByb3BzKTsKICAgIH0KICAgIC8vIEV2ZW50IG9iamVjdAogICAgaWYgKHNyYyAmJiBzcmMudHlwZSkgewogICAgICB0aGlzLm9yaWdpbmFsRXZlbnQgPSBzcmM7CiAgICAgIHRoaXMudHlwZSA9IHNyYy50eXBlOwogICAgICAvLyBFdmVudHMgYnViYmxpbmcgdXAgdGhlIGRvY3VtZW50IG1heSBoYXZlIGJlZW4gbWFya2VkIGFzIHByZXZlbnRlZAogICAgICAvLyBieSBhIGhhbmRsZXIgbG93ZXIgZG93biB0aGUgdHJlZTsgcmVmbGVjdCB0aGUgY29ycmVjdCB2YWx1ZS4KICAgICAgdGhpcy5pc0RlZmF1bHRQcmV2ZW50ZWQgPSBzcmMuZGVmYXVsdFByZXZlbnRlZCB8fCBzcmMuZGVmYXVsdFByZXZlbnRlZCA9PT0gdW5kZWZpbmVkICYmIC8vIFN1cHBvcnQ6IEFuZHJvaWQgPCA0LjAKICAgICAgc3JjLnJldHVyblZhbHVlID09PSBmYWxzZSA/IHJldHVyblRydWUgOiByZXR1cm5GYWxzZTsgIC8vIEV2ZW50IHR5cGUKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMudHlwZSA9IHNyYzsKICAgIH0KICAgIC8vIFB1dCBleHBsaWNpdGx5IHByb3ZpZGVkIHByb3BlcnRpZXMgb250byB0aGUgZXZlbnQgb2JqZWN0CiAgICBpZiAocHJvcHMpIHsKICAgICAgalF1ZXJ5LmV4dGVuZCh0aGlzLCBwcm9wcyk7CiAgICB9CiAgICAvLyBDcmVhdGUgYSB0aW1lc3RhbXAgaWYgaW5jb21pbmcgZXZlbnQgZG9lc24ndCBoYXZlIG9uZQogICAgdGhpcy50aW1lU3RhbXAgPSBzcmMgJiYgc3JjLnRpbWVTdGFtcCB8fCBqUXVlcnkubm93KCk7CiAgICAvLyBNYXJrIGl0IGFzIGZpeGVkCiAgICB0aGlzW2pRdWVyeS5leHBhbmRvXSA9IHRydWU7CiAgfTsKICAvLyBqUXVlcnkuRXZlbnQgaXMgYmFzZWQgb24gRE9NMyBFdmVudHMgYXMgc3BlY2lmaWVkIGJ5IHRoZSBFQ01BU2NyaXB0IExhbmd1YWdlIEJpbmRpbmcKICAvLyBodHRwOi8vd3d3LnczLm9yZy9UUi8yMDAzL1dELURPTS1MZXZlbC0zLUV2ZW50cy0yMDAzMDMzMS9lY21hLXNjcmlwdC1iaW5kaW5nLmh0bWwKICBqUXVlcnkuRXZlbnQucHJvdG90eXBlID0gewogICAgaXNEZWZhdWx0UHJldmVudGVkOiByZXR1cm5GYWxzZSwKICAgIGlzUHJvcGFnYXRpb25TdG9wcGVkOiByZXR1cm5GYWxzZSwKICAgIGlzSW1tZWRpYXRlUHJvcGFnYXRpb25TdG9wcGVkOiByZXR1cm5GYWxzZSwKICAgIHByZXZlbnREZWZhdWx0OiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBlID0gdGhpcy5vcmlnaW5hbEV2ZW50OwogICAgICB0aGlzLmlzRGVmYXVsdFByZXZlbnRlZCA9IHJldHVyblRydWU7CiAgICAgIGlmIChlICYmIGUucHJldmVudERlZmF1bHQpIHsKICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgIH0KICAgIH0sCiAgICBzdG9wUHJvcGFnYXRpb246IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIGUgPSB0aGlzLm9yaWdpbmFsRXZlbnQ7CiAgICAgIHRoaXMuaXNQcm9wYWdhdGlvblN0b3BwZWQgPSByZXR1cm5UcnVlOwogICAgICBpZiAoZSAmJiBlLnN0b3BQcm9wYWdhdGlvbikgewogICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgIH0KICAgIH0sCiAgICBzdG9wSW1tZWRpYXRlUHJvcGFnYXRpb246IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIGUgPSB0aGlzLm9yaWdpbmFsRXZlbnQ7CiAgICAgIHRoaXMuaXNJbW1lZGlhdGVQcm9wYWdhdGlvblN0b3BwZWQgPSByZXR1cm5UcnVlOwogICAgICBpZiAoZSAmJiBlLnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbikgewogICAgICAgIGUuc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uKCk7CiAgICAgIH0KICAgICAgdGhpcy5zdG9wUHJvcGFnYXRpb24oKTsKICAgIH0KICB9OwogIC8vIENyZWF0ZSBtb3VzZWVudGVyL2xlYXZlIGV2ZW50cyB1c2luZyBtb3VzZW92ZXIvb3V0IGFuZCBldmVudC10aW1lIGNoZWNrcwogIC8vIFN1cHBvcnQ6IENocm9tZSAxNSsKICBqUXVlcnkuZWFjaCh7CiAgICBtb3VzZWVudGVyOiAnbW91c2VvdmVyJywKICAgIG1vdXNlbGVhdmU6ICdtb3VzZW91dCcsCiAgICBwb2ludGVyZW50ZXI6ICdwb2ludGVyb3ZlcicsCiAgICBwb2ludGVybGVhdmU6ICdwb2ludGVyb3V0JwogIH0sIGZ1bmN0aW9uIChvcmlnLCBmaXgpIHsKICAgIGpRdWVyeS5ldmVudC5zcGVjaWFsW29yaWddID0gewogICAgICBkZWxlZ2F0ZVR5cGU6IGZpeCwKICAgICAgYmluZFR5cGU6IGZpeCwKICAgICAgaGFuZGxlOiBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICB2YXIgcmV0LCB0YXJnZXQgPSB0aGlzLCByZWxhdGVkID0gZXZlbnQucmVsYXRlZFRhcmdldCwgaGFuZGxlT2JqID0gZXZlbnQuaGFuZGxlT2JqOwogICAgICAgIC8vIEZvciBtb3VzZW50ZXIvbGVhdmUgY2FsbCB0aGUgaGFuZGxlciBpZiByZWxhdGVkIGlzIG91dHNpZGUgdGhlIHRhcmdldC4KICAgICAgICAvLyBOQjogTm8gcmVsYXRlZFRhcmdldCBpZiB0aGUgbW91c2UgbGVmdC9lbnRlcmVkIHRoZSBicm93c2VyIHdpbmRvdwogICAgICAgIGlmICghcmVsYXRlZCB8fCByZWxhdGVkICE9PSB0YXJnZXQgJiYgIWpRdWVyeS5jb250YWlucyh0YXJnZXQsIHJlbGF0ZWQpKSB7CiAgICAgICAgICBldmVudC50eXBlID0gaGFuZGxlT2JqLm9yaWdUeXBlOwogICAgICAgICAgcmV0ID0gaGFuZGxlT2JqLmhhbmRsZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgIGV2ZW50LnR5cGUgPSBmaXg7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXQ7CiAgICAgIH0KICAgIH07CiAgfSk7CiAgLy8gQ3JlYXRlICJidWJibGluZyIgZm9jdXMgYW5kIGJsdXIgZXZlbnRzCiAgLy8gU3VwcG9ydDogRmlyZWZveCwgQ2hyb21lLCBTYWZhcmkKICBpZiAoIXN1cHBvcnQuZm9jdXNpbkJ1YmJsZXMpIHsKICAgIGpRdWVyeS5lYWNoKHsKICAgICAgZm9jdXM6ICdmb2N1c2luJywKICAgICAgYmx1cjogJ2ZvY3Vzb3V0JwogICAgfSwgZnVuY3Rpb24gKG9yaWcsIGZpeCkgewogICAgICAvLyBBdHRhY2ggYSBzaW5nbGUgY2FwdHVyaW5nIGhhbmRsZXIgb24gdGhlIGRvY3VtZW50IHdoaWxlIHNvbWVvbmUgd2FudHMgZm9jdXNpbi9mb2N1c291dAogICAgICB2YXIgaGFuZGxlciA9IGZ1bmN0aW9uIChldmVudCkgewogICAgICAgIGpRdWVyeS5ldmVudC5zaW11bGF0ZShmaXgsIGV2ZW50LnRhcmdldCwgalF1ZXJ5LmV2ZW50LmZpeChldmVudCksIHRydWUpOwogICAgICB9OwogICAgICBqUXVlcnkuZXZlbnQuc3BlY2lhbFtmaXhdID0gewogICAgICAgIHNldHVwOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICB2YXIgZG9jID0gdGhpcy5vd25lckRvY3VtZW50IHx8IHRoaXMsIGF0dGFjaGVzID0gZGF0YV9wcml2LmFjY2Vzcyhkb2MsIGZpeCk7CiAgICAgICAgICBpZiAoIWF0dGFjaGVzKSB7CiAgICAgICAgICAgIGRvYy5hZGRFdmVudExpc3RlbmVyKG9yaWcsIGhhbmRsZXIsIHRydWUpOwogICAgICAgICAgfQogICAgICAgICAgZGF0YV9wcml2LmFjY2Vzcyhkb2MsIGZpeCwgKGF0dGFjaGVzIHx8IDApICsgMSk7CiAgICAgICAgfSwKICAgICAgICB0ZWFyZG93bjogZnVuY3Rpb24gKCkgewogICAgICAgICAgdmFyIGRvYyA9IHRoaXMub3duZXJEb2N1bWVudCB8fCB0aGlzLCBhdHRhY2hlcyA9IGRhdGFfcHJpdi5hY2Nlc3MoZG9jLCBmaXgpIC0gMTsKICAgICAgICAgIGlmICghYXR0YWNoZXMpIHsKICAgICAgICAgICAgZG9jLnJlbW92ZUV2ZW50TGlzdGVuZXIob3JpZywgaGFuZGxlciwgdHJ1ZSk7CiAgICAgICAgICAgIGRhdGFfcHJpdi5yZW1vdmUoZG9jLCBmaXgpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZGF0YV9wcml2LmFjY2Vzcyhkb2MsIGZpeCwgYXR0YWNoZXMpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfTsKICAgIH0pOwogIH0KICBqUXVlcnkuZm4uZXh0ZW5kKHsKICAgIG9uOiBmdW5jdGlvbiAodHlwZXMsIHNlbGVjdG9yLCBkYXRhLCBmbiwgb25lKSB7CiAgICAgIHZhciBvcmlnRm4sIHR5cGU7CiAgICAgIC8vIFR5cGVzIGNhbiBiZSBhIG1hcCBvZiB0eXBlcy9oYW5kbGVycwogICAgICBpZiAodHlwZW9mIHR5cGVzID09PSAnb2JqZWN0JykgewogICAgICAgIC8vICggdHlwZXMtT2JqZWN0LCBzZWxlY3RvciwgZGF0YSApCiAgICAgICAgaWYgKHR5cGVvZiBzZWxlY3RvciAhPT0gJ3N0cmluZycpIHsKICAgICAgICAgIC8vICggdHlwZXMtT2JqZWN0LCBkYXRhICkKICAgICAgICAgIGRhdGEgPSBkYXRhIHx8IHNlbGVjdG9yOwogICAgICAgICAgc2VsZWN0b3IgPSB1bmRlZmluZWQ7CiAgICAgICAgfQogICAgICAgIGZvciAodHlwZSBpbiB0eXBlcykgewogICAgICAgICAgdGhpcy5vbih0eXBlLCBzZWxlY3RvciwgZGF0YSwgdHlwZXNbdHlwZV0sIG9uZSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzOwogICAgICB9CiAgICAgIGlmIChkYXRhID09IG51bGwgJiYgZm4gPT0gbnVsbCkgewogICAgICAgIC8vICggdHlwZXMsIGZuICkKICAgICAgICBmbiA9IHNlbGVjdG9yOwogICAgICAgIGRhdGEgPSBzZWxlY3RvciA9IHVuZGVmaW5lZDsKICAgICAgfSBlbHNlIGlmIChmbiA9PSBudWxsKSB7CiAgICAgICAgaWYgKHR5cGVvZiBzZWxlY3RvciA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgIC8vICggdHlwZXMsIHNlbGVjdG9yLCBmbiApCiAgICAgICAgICBmbiA9IGRhdGE7CiAgICAgICAgICBkYXRhID0gdW5kZWZpbmVkOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAvLyAoIHR5cGVzLCBkYXRhLCBmbiApCiAgICAgICAgICBmbiA9IGRhdGE7CiAgICAgICAgICBkYXRhID0gc2VsZWN0b3I7CiAgICAgICAgICBzZWxlY3RvciA9IHVuZGVmaW5lZDsKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKGZuID09PSBmYWxzZSkgewogICAgICAgIGZuID0gcmV0dXJuRmFsc2U7CiAgICAgIH0gZWxzZSBpZiAoIWZuKSB7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgIH0KICAgICAgaWYgKG9uZSA9PT0gMSkgewogICAgICAgIG9yaWdGbiA9IGZuOwogICAgICAgIGZuID0gZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgICAvLyBDYW4gdXNlIGFuIGVtcHR5IHNldCwgc2luY2UgZXZlbnQgY29udGFpbnMgdGhlIGluZm8KICAgICAgICAgIGpRdWVyeSgpLm9mZihldmVudCk7CiAgICAgICAgICByZXR1cm4gb3JpZ0ZuLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgfTsKICAgICAgICAvLyBVc2Ugc2FtZSBndWlkIHNvIGNhbGxlciBjYW4gcmVtb3ZlIHVzaW5nIG9yaWdGbgogICAgICAgIGZuLmd1aWQgPSBvcmlnRm4uZ3VpZCB8fCAob3JpZ0ZuLmd1aWQgPSBqUXVlcnkuZ3VpZCsrKTsKICAgICAgfQogICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgICBqUXVlcnkuZXZlbnQuYWRkKHRoaXMsIHR5cGVzLCBmbiwgZGF0YSwgc2VsZWN0b3IpOwogICAgICB9KTsKICAgIH0sCiAgICBvbmU6IGZ1bmN0aW9uICh0eXBlcywgc2VsZWN0b3IsIGRhdGEsIGZuKSB7CiAgICAgIHJldHVybiB0aGlzLm9uKHR5cGVzLCBzZWxlY3RvciwgZGF0YSwgZm4sIDEpOwogICAgfSwKICAgIG9mZjogZnVuY3Rpb24gKHR5cGVzLCBzZWxlY3RvciwgZm4pIHsKICAgICAgdmFyIGhhbmRsZU9iaiwgdHlwZTsKICAgICAgaWYgKHR5cGVzICYmIHR5cGVzLnByZXZlbnREZWZhdWx0ICYmIHR5cGVzLmhhbmRsZU9iaikgewogICAgICAgIC8vICggZXZlbnQgKSAgZGlzcGF0Y2hlZCBqUXVlcnkuRXZlbnQKICAgICAgICBoYW5kbGVPYmogPSB0eXBlcy5oYW5kbGVPYmo7CiAgICAgICAgalF1ZXJ5KHR5cGVzLmRlbGVnYXRlVGFyZ2V0KS5vZmYoaGFuZGxlT2JqLm5hbWVzcGFjZSA/IGhhbmRsZU9iai5vcmlnVHlwZSArICcuJyArIGhhbmRsZU9iai5uYW1lc3BhY2UgOiBoYW5kbGVPYmoub3JpZ1R5cGUsIGhhbmRsZU9iai5zZWxlY3RvciwgaGFuZGxlT2JqLmhhbmRsZXIpOwogICAgICAgIHJldHVybiB0aGlzOwogICAgICB9CiAgICAgIGlmICh0eXBlb2YgdHlwZXMgPT09ICdvYmplY3QnKSB7CiAgICAgICAgLy8gKCB0eXBlcy1vYmplY3QgWywgc2VsZWN0b3JdICkKICAgICAgICBmb3IgKHR5cGUgaW4gdHlwZXMpIHsKICAgICAgICAgIHRoaXMub2ZmKHR5cGUsIHNlbGVjdG9yLCB0eXBlc1t0eXBlXSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzOwogICAgICB9CiAgICAgIGlmIChzZWxlY3RvciA9PT0gZmFsc2UgfHwgdHlwZW9mIHNlbGVjdG9yID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgLy8gKCB0eXBlcyBbLCBmbl0gKQogICAgICAgIGZuID0gc2VsZWN0b3I7CiAgICAgICAgc2VsZWN0b3IgPSB1bmRlZmluZWQ7CiAgICAgIH0KICAgICAgaWYgKGZuID09PSBmYWxzZSkgewogICAgICAgIGZuID0gcmV0dXJuRmFsc2U7CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgalF1ZXJ5LmV2ZW50LnJlbW92ZSh0aGlzLCB0eXBlcywgZm4sIHNlbGVjdG9yKTsKICAgICAgfSk7CiAgICB9LAogICAgdHJpZ2dlcjogZnVuY3Rpb24gKHR5cGUsIGRhdGEpIHsKICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgalF1ZXJ5LmV2ZW50LnRyaWdnZXIodHlwZSwgZGF0YSwgdGhpcyk7CiAgICAgIH0pOwogICAgfSwKICAgIHRyaWdnZXJIYW5kbGVyOiBmdW5jdGlvbiAodHlwZSwgZGF0YSkgewogICAgICB2YXIgZWxlbSA9IHRoaXNbMF07CiAgICAgIGlmIChlbGVtKSB7CiAgICAgICAgcmV0dXJuIGpRdWVyeS5ldmVudC50cmlnZ2VyKHR5cGUsIGRhdGEsIGVsZW0sIHRydWUpOwogICAgICB9CiAgICB9CiAgfSk7CiAgdmFyIHJ4aHRtbFRhZyA9IC88KD8hYXJlYXxicnxjb2x8ZW1iZWR8aHJ8aW1nfGlucHV0fGxpbmt8bWV0YXxwYXJhbSkoKFtcdzpdKylbXj5dKilcLz4vZ2ksIHJ0YWdOYW1lID0gLzwoW1x3Ol0rKS8sIHJodG1sID0gLzx8JiM/XHcrOy8sIHJub0lubmVyaHRtbCA9IC88KD86c2NyaXB0fHN0eWxlfGxpbmspL2ksCiAgICAvLyBjaGVja2VkPSJjaGVja2VkIiBvciBjaGVja2VkCiAgICByY2hlY2tlZCA9IC9jaGVja2VkXHMqKD86W149XXw9XHMqLmNoZWNrZWQuKS9pLCByc2NyaXB0VHlwZSA9IC9eJHxcLyg/OmphdmF8ZWNtYSlzY3JpcHQvaSwgcnNjcmlwdFR5cGVNYXNrZWQgPSAvXnRydWVcLyguKikvLCByY2xlYW5TY3JpcHQgPSAvXlxzKjwhKD86XFtDREFUQVxbfC0tKXwoPzpcXVxdfC0tKT5ccyokL2csCiAgICAvLyBXZSBoYXZlIHRvIGNsb3NlIHRoZXNlIHRhZ3MgdG8gc3VwcG9ydCBYSFRNTCAoIzEzMjAwKQogICAgd3JhcE1hcCA9IHsKICAgICAgLy8gU3VwcG9ydDogSUUgOQogICAgICBvcHRpb246IFsKICAgICAgICAxLAogICAgICAgICc8c2VsZWN0IG11bHRpcGxlPVwnbXVsdGlwbGVcJz4nLAogICAgICAgICc8L3NlbGVjdD4nCiAgICAgIF0sCiAgICAgIHRoZWFkOiBbCiAgICAgICAgMSwKICAgICAgICAnPHRhYmxlPicsCiAgICAgICAgJzwvdGFibGU+JwogICAgICBdLAogICAgICBjb2w6IFsKICAgICAgICAyLAogICAgICAgICc8dGFibGU+PGNvbGdyb3VwPicsCiAgICAgICAgJzwvY29sZ3JvdXA+PC90YWJsZT4nCiAgICAgIF0sCiAgICAgIHRyOiBbCiAgICAgICAgMiwKICAgICAgICAnPHRhYmxlPjx0Ym9keT4nLAogICAgICAgICc8L3Rib2R5PjwvdGFibGU+JwogICAgICBdLAogICAgICB0ZDogWwogICAgICAgIDMsCiAgICAgICAgJzx0YWJsZT48dGJvZHk+PHRyPicsCiAgICAgICAgJzwvdHI+PC90Ym9keT48L3RhYmxlPicKICAgICAgXSwKICAgICAgX2RlZmF1bHQ6IFsKICAgICAgICAwLAogICAgICAgICcnLAogICAgICAgICcnCiAgICAgIF0KICAgIH07CiAgLy8gU3VwcG9ydDogSUUgOQogIHdyYXBNYXAub3B0Z3JvdXAgPSB3cmFwTWFwLm9wdGlvbjsKICB3cmFwTWFwLnRib2R5ID0gd3JhcE1hcC50Zm9vdCA9IHdyYXBNYXAuY29sZ3JvdXAgPSB3cmFwTWFwLmNhcHRpb24gPSB3cmFwTWFwLnRoZWFkOwogIHdyYXBNYXAudGggPSB3cmFwTWFwLnRkOwogIC8vIFN1cHBvcnQ6IDEueCBjb21wYXRpYmlsaXR5CiAgLy8gTWFuaXB1bGF0aW5nIHRhYmxlcyByZXF1aXJlcyBhIHRib2R5CiAgZnVuY3Rpb24gbWFuaXB1bGF0aW9uVGFyZ2V0KGVsZW0sIGNvbnRlbnQpIHsKICAgIHJldHVybiBqUXVlcnkubm9kZU5hbWUoZWxlbSwgJ3RhYmxlJykgJiYgalF1ZXJ5Lm5vZGVOYW1lKGNvbnRlbnQubm9kZVR5cGUgIT09IDExID8gY29udGVudCA6IGNvbnRlbnQuZmlyc3RDaGlsZCwgJ3RyJykgPyBlbGVtLmdldEVsZW1lbnRzQnlUYWdOYW1lKCd0Ym9keScpWzBdIHx8IGVsZW0uYXBwZW5kQ2hpbGQoZWxlbS5vd25lckRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3Rib2R5JykpIDogZWxlbTsKICB9CiAgLy8gUmVwbGFjZS9yZXN0b3JlIHRoZSB0eXBlIGF0dHJpYnV0ZSBvZiBzY3JpcHQgZWxlbWVudHMgZm9yIHNhZmUgRE9NIG1hbmlwdWxhdGlvbgogIGZ1bmN0aW9uIGRpc2FibGVTY3JpcHQoZWxlbSkgewogICAgZWxlbS50eXBlID0gKGVsZW0uZ2V0QXR0cmlidXRlKCd0eXBlJykgIT09IG51bGwpICsgJy8nICsgZWxlbS50eXBlOwogICAgcmV0dXJuIGVsZW07CiAgfQogIGZ1bmN0aW9uIHJlc3RvcmVTY3JpcHQoZWxlbSkgewogICAgdmFyIG1hdGNoID0gcnNjcmlwdFR5cGVNYXNrZWQuZXhlYyhlbGVtLnR5cGUpOwogICAgaWYgKG1hdGNoKSB7CiAgICAgIGVsZW0udHlwZSA9IG1hdGNoWzFdOwogICAgfSBlbHNlIHsKICAgICAgZWxlbS5yZW1vdmVBdHRyaWJ1dGUoJ3R5cGUnKTsKICAgIH0KICAgIHJldHVybiBlbGVtOwogIH0KICAvLyBNYXJrIHNjcmlwdHMgYXMgaGF2aW5nIGFscmVhZHkgYmVlbiBldmFsdWF0ZWQKICBmdW5jdGlvbiBzZXRHbG9iYWxFdmFsKGVsZW1zLCByZWZFbGVtZW50cykgewogICAgdmFyIGkgPSAwLCBsID0gZWxlbXMubGVuZ3RoOwogICAgZm9yICg7IGkgPCBsOyBpKyspIHsKICAgICAgZGF0YV9wcml2LnNldChlbGVtc1tpXSwgJ2dsb2JhbEV2YWwnLCAhcmVmRWxlbWVudHMgfHwgZGF0YV9wcml2LmdldChyZWZFbGVtZW50c1tpXSwgJ2dsb2JhbEV2YWwnKSk7CiAgICB9CiAgfQogIGZ1bmN0aW9uIGNsb25lQ29weUV2ZW50KHNyYywgZGVzdCkgewogICAgdmFyIGksIGwsIHR5cGUsIHBkYXRhT2xkLCBwZGF0YUN1ciwgdWRhdGFPbGQsIHVkYXRhQ3VyLCBldmVudHM7CiAgICBpZiAoZGVzdC5ub2RlVHlwZSAhPT0gMSkgewogICAgICByZXR1cm47CiAgICB9CiAgICAvLyAxLiBDb3B5IHByaXZhdGUgZGF0YTogZXZlbnRzLCBoYW5kbGVycywgZXRjLgogICAgaWYgKGRhdGFfcHJpdi5oYXNEYXRhKHNyYykpIHsKICAgICAgcGRhdGFPbGQgPSBkYXRhX3ByaXYuYWNjZXNzKHNyYyk7CiAgICAgIHBkYXRhQ3VyID0gZGF0YV9wcml2LnNldChkZXN0LCBwZGF0YU9sZCk7CiAgICAgIGV2ZW50cyA9IHBkYXRhT2xkLmV2ZW50czsKICAgICAgaWYgKGV2ZW50cykgewogICAgICAgIGRlbGV0ZSBwZGF0YUN1ci5oYW5kbGU7CiAgICAgICAgcGRhdGFDdXIuZXZlbnRzID0ge307CiAgICAgICAgZm9yICh0eXBlIGluIGV2ZW50cykgewogICAgICAgICAgZm9yIChpID0gMCwgbCA9IGV2ZW50c1t0eXBlXS5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgICAgalF1ZXJ5LmV2ZW50LmFkZChkZXN0LCB0eXBlLCBldmVudHNbdHlwZV1baV0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQogICAgLy8gMi4gQ29weSB1c2VyIGRhdGEKICAgIGlmIChkYXRhX3VzZXIuaGFzRGF0YShzcmMpKSB7CiAgICAgIHVkYXRhT2xkID0gZGF0YV91c2VyLmFjY2VzcyhzcmMpOwogICAgICB1ZGF0YUN1ciA9IGpRdWVyeS5leHRlbmQoe30sIHVkYXRhT2xkKTsKICAgICAgZGF0YV91c2VyLnNldChkZXN0LCB1ZGF0YUN1cik7CiAgICB9CiAgfQogIGZ1bmN0aW9uIGdldEFsbChjb250ZXh0LCB0YWcpIHsKICAgIHZhciByZXQgPSBjb250ZXh0LmdldEVsZW1lbnRzQnlUYWdOYW1lID8gY29udGV4dC5nZXRFbGVtZW50c0J5VGFnTmFtZSh0YWcgfHwgJyonKSA6IGNvbnRleHQucXVlcnlTZWxlY3RvckFsbCA/IGNvbnRleHQucXVlcnlTZWxlY3RvckFsbCh0YWcgfHwgJyonKSA6IFtdOwogICAgcmV0dXJuIHRhZyA9PT0gdW5kZWZpbmVkIHx8IHRhZyAmJiBqUXVlcnkubm9kZU5hbWUoY29udGV4dCwgdGFnKSA/IGpRdWVyeS5tZXJnZShbY29udGV4dF0sIHJldCkgOiByZXQ7CiAgfQogIC8vIFN1cHBvcnQ6IElFID49IDkKICBmdW5jdGlvbiBmaXhJbnB1dChzcmMsIGRlc3QpIHsKICAgIHZhciBub2RlTmFtZSA9IGRlc3Qubm9kZU5hbWUudG9Mb3dlckNhc2UoKTsKICAgIC8vIEZhaWxzIHRvIHBlcnNpc3QgdGhlIGNoZWNrZWQgc3RhdGUgb2YgYSBjbG9uZWQgY2hlY2tib3ggb3IgcmFkaW8gYnV0dG9uLgogICAgaWYgKG5vZGVOYW1lID09PSAnaW5wdXQnICYmIHJjaGVja2FibGVUeXBlLnRlc3Qoc3JjLnR5cGUpKSB7CiAgICAgIGRlc3QuY2hlY2tlZCA9IHNyYy5jaGVja2VkOyAgLy8gRmFpbHMgdG8gcmV0dXJuIHRoZSBzZWxlY3RlZCBvcHRpb24gdG8gdGhlIGRlZmF1bHQgc2VsZWN0ZWQgc3RhdGUgd2hlbiBjbG9uaW5nIG9wdGlvbnMKICAgIH0gZWxzZSBpZiAobm9kZU5hbWUgPT09ICdpbnB1dCcgfHwgbm9kZU5hbWUgPT09ICd0ZXh0YXJlYScpIHsKICAgICAgZGVzdC5kZWZhdWx0VmFsdWUgPSBzcmMuZGVmYXVsdFZhbHVlOwogICAgfQogIH0KICBqUXVlcnkuZXh0ZW5kKHsKICAgIGNsb25lOiBmdW5jdGlvbiAoZWxlbSwgZGF0YUFuZEV2ZW50cywgZGVlcERhdGFBbmRFdmVudHMpIHsKICAgICAgdmFyIGksIGwsIHNyY0VsZW1lbnRzLCBkZXN0RWxlbWVudHMsIGNsb25lID0gZWxlbS5jbG9uZU5vZGUodHJ1ZSksIGluUGFnZSA9IGpRdWVyeS5jb250YWlucyhlbGVtLm93bmVyRG9jdW1lbnQsIGVsZW0pOwogICAgICAvLyBTdXBwb3J0OiBJRSA+PSA5CiAgICAgIC8vIEZpeCBDbG9uaW5nIGlzc3VlcwogICAgICBpZiAoIXN1cHBvcnQubm9DbG9uZUNoZWNrZWQgJiYgKGVsZW0ubm9kZVR5cGUgPT09IDEgfHwgZWxlbS5ub2RlVHlwZSA9PT0gMTEpICYmICFqUXVlcnkuaXNYTUxEb2MoZWxlbSkpIHsKICAgICAgICAvLyBXZSBlc2NoZXcgU2l6emxlIGhlcmUgZm9yIHBlcmZvcm1hbmNlIHJlYXNvbnM6IGh0dHA6Ly9qc3BlcmYuY29tL2dldGFsbC12cy1zaXp6bGUvMgogICAgICAgIGRlc3RFbGVtZW50cyA9IGdldEFsbChjbG9uZSk7CiAgICAgICAgc3JjRWxlbWVudHMgPSBnZXRBbGwoZWxlbSk7CiAgICAgICAgZm9yIChpID0gMCwgbCA9IHNyY0VsZW1lbnRzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgZml4SW5wdXQoc3JjRWxlbWVudHNbaV0sIGRlc3RFbGVtZW50c1tpXSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIC8vIENvcHkgdGhlIGV2ZW50cyBmcm9tIHRoZSBvcmlnaW5hbCB0byB0aGUgY2xvbmUKICAgICAgaWYgKGRhdGFBbmRFdmVudHMpIHsKICAgICAgICBpZiAoZGVlcERhdGFBbmRFdmVudHMpIHsKICAgICAgICAgIHNyY0VsZW1lbnRzID0gc3JjRWxlbWVudHMgfHwgZ2V0QWxsKGVsZW0pOwogICAgICAgICAgZGVzdEVsZW1lbnRzID0gZGVzdEVsZW1lbnRzIHx8IGdldEFsbChjbG9uZSk7CiAgICAgICAgICBmb3IgKGkgPSAwLCBsID0gc3JjRWxlbWVudHMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgICAgIGNsb25lQ29weUV2ZW50KHNyY0VsZW1lbnRzW2ldLCBkZXN0RWxlbWVudHNbaV0pOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjbG9uZUNvcHlFdmVudChlbGVtLCBjbG9uZSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIC8vIFByZXNlcnZlIHNjcmlwdCBldmFsdWF0aW9uIGhpc3RvcnkKICAgICAgZGVzdEVsZW1lbnRzID0gZ2V0QWxsKGNsb25lLCAnc2NyaXB0Jyk7CiAgICAgIGlmIChkZXN0RWxlbWVudHMubGVuZ3RoID4gMCkgewogICAgICAgIHNldEdsb2JhbEV2YWwoZGVzdEVsZW1lbnRzLCAhaW5QYWdlICYmIGdldEFsbChlbGVtLCAnc2NyaXB0JykpOwogICAgICB9CiAgICAgIC8vIFJldHVybiB0aGUgY2xvbmVkIHNldAogICAgICByZXR1cm4gY2xvbmU7CiAgICB9LAogICAgYnVpbGRGcmFnbWVudDogZnVuY3Rpb24gKGVsZW1zLCBjb250ZXh0LCBzY3JpcHRzLCBzZWxlY3Rpb24pIHsKICAgICAgdmFyIGVsZW0sIHRtcCwgdGFnLCB3cmFwLCBjb250YWlucywgaiwgZnJhZ21lbnQgPSBjb250ZXh0LmNyZWF0ZURvY3VtZW50RnJhZ21lbnQoKSwgbm9kZXMgPSBbXSwgaSA9IDAsIGwgPSBlbGVtcy5sZW5ndGg7CiAgICAgIGZvciAoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgZWxlbSA9IGVsZW1zW2ldOwogICAgICAgIGlmIChlbGVtIHx8IGVsZW0gPT09IDApIHsKICAgICAgICAgIC8vIEFkZCBub2RlcyBkaXJlY3RseQogICAgICAgICAgaWYgKGpRdWVyeS50eXBlKGVsZW0pID09PSAnb2JqZWN0JykgewogICAgICAgICAgICAvLyBTdXBwb3J0OiBRdFdlYktpdAogICAgICAgICAgICAvLyBqUXVlcnkubWVyZ2UgYmVjYXVzZSBwdXNoLmFwcGx5KF8sIGFycmF5bGlrZSkgdGhyb3dzCiAgICAgICAgICAgIGpRdWVyeS5tZXJnZShub2RlcywgZWxlbS5ub2RlVHlwZSA/IFtlbGVtXSA6IGVsZW0pOyAgLy8gQ29udmVydCBub24taHRtbCBpbnRvIGEgdGV4dCBub2RlCiAgICAgICAgICB9IGVsc2UgaWYgKCFyaHRtbC50ZXN0KGVsZW0pKSB7CiAgICAgICAgICAgIG5vZGVzLnB1c2goY29udGV4dC5jcmVhdGVUZXh0Tm9kZShlbGVtKSk7ICAvLyBDb252ZXJ0IGh0bWwgaW50byBET00gbm9kZXMKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRtcCA9IHRtcCB8fCBmcmFnbWVudC5hcHBlbmRDaGlsZChjb250ZXh0LmNyZWF0ZUVsZW1lbnQoJ2RpdicpKTsKICAgICAgICAgICAgLy8gRGVzZXJpYWxpemUgYSBzdGFuZGFyZCByZXByZXNlbnRhdGlvbgogICAgICAgICAgICB0YWcgPSAocnRhZ05hbWUuZXhlYyhlbGVtKSB8fCBbCiAgICAgICAgICAgICAgJycsCiAgICAgICAgICAgICAgJycKICAgICAgICAgICAgXSlbMV0udG9Mb3dlckNhc2UoKTsKICAgICAgICAgICAgd3JhcCA9IHdyYXBNYXBbdGFnXSB8fCB3cmFwTWFwLl9kZWZhdWx0OwogICAgICAgICAgICB0bXAuaW5uZXJIVE1MID0gd3JhcFsxXSArIGVsZW0ucmVwbGFjZShyeGh0bWxUYWcsICc8JDE+PC8kMj4nKSArIHdyYXBbMl07CiAgICAgICAgICAgIC8vIERlc2NlbmQgdGhyb3VnaCB3cmFwcGVycyB0byB0aGUgcmlnaHQgY29udGVudAogICAgICAgICAgICBqID0gd3JhcFswXTsKICAgICAgICAgICAgd2hpbGUgKGotLSkgewogICAgICAgICAgICAgIHRtcCA9IHRtcC5sYXN0Q2hpbGQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gU3VwcG9ydDogUXRXZWJLaXQKICAgICAgICAgICAgLy8galF1ZXJ5Lm1lcmdlIGJlY2F1c2UgcHVzaC5hcHBseShfLCBhcnJheWxpa2UpIHRocm93cwogICAgICAgICAgICBqUXVlcnkubWVyZ2Uobm9kZXMsIHRtcC5jaGlsZE5vZGVzKTsKICAgICAgICAgICAgLy8gUmVtZW1iZXIgdGhlIHRvcC1sZXZlbCBjb250YWluZXIKICAgICAgICAgICAgdG1wID0gZnJhZ21lbnQuZmlyc3RDaGlsZDsKICAgICAgICAgICAgLy8gRml4ZXMgIzEyMzQ2CiAgICAgICAgICAgIC8vIFN1cHBvcnQ6IFdlYmtpdCwgSUUKICAgICAgICAgICAgdG1wLnRleHRDb250ZW50ID0gJyc7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIC8vIFJlbW92ZSB3cmFwcGVyIGZyb20gZnJhZ21lbnQKICAgICAgZnJhZ21lbnQudGV4dENvbnRlbnQgPSAnJzsKICAgICAgaSA9IDA7CiAgICAgIHdoaWxlIChlbGVtID0gbm9kZXNbaSsrXSkgewogICAgICAgIC8vICM0MDg3IC0gSWYgb3JpZ2luIGFuZCBkZXN0aW5hdGlvbiBlbGVtZW50cyBhcmUgdGhlIHNhbWUsIGFuZCB0aGlzIGlzCiAgICAgICAgLy8gdGhhdCBlbGVtZW50LCBkbyBub3QgZG8gYW55dGhpbmcKICAgICAgICBpZiAoc2VsZWN0aW9uICYmIGpRdWVyeS5pbkFycmF5KGVsZW0sIHNlbGVjdGlvbikgIT09IC0xKSB7CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CiAgICAgICAgY29udGFpbnMgPSBqUXVlcnkuY29udGFpbnMoZWxlbS5vd25lckRvY3VtZW50LCBlbGVtKTsKICAgICAgICAvLyBBcHBlbmQgdG8gZnJhZ21lbnQKICAgICAgICB0bXAgPSBnZXRBbGwoZnJhZ21lbnQuYXBwZW5kQ2hpbGQoZWxlbSksICdzY3JpcHQnKTsKICAgICAgICAvLyBQcmVzZXJ2ZSBzY3JpcHQgZXZhbHVhdGlvbiBoaXN0b3J5CiAgICAgICAgaWYgKGNvbnRhaW5zKSB7CiAgICAgICAgICBzZXRHbG9iYWxFdmFsKHRtcCk7CiAgICAgICAgfQogICAgICAgIC8vIENhcHR1cmUgZXhlY3V0YWJsZXMKICAgICAgICBpZiAoc2NyaXB0cykgewogICAgICAgICAgaiA9IDA7CiAgICAgICAgICB3aGlsZSAoZWxlbSA9IHRtcFtqKytdKSB7CiAgICAgICAgICAgIGlmIChyc2NyaXB0VHlwZS50ZXN0KGVsZW0udHlwZSB8fCAnJykpIHsKICAgICAgICAgICAgICBzY3JpcHRzLnB1c2goZWxlbSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIGZyYWdtZW50OwogICAgfSwKICAgIGNsZWFuRGF0YTogZnVuY3Rpb24gKGVsZW1zKSB7CiAgICAgIHZhciBkYXRhLCBlbGVtLCB0eXBlLCBrZXksIHNwZWNpYWwgPSBqUXVlcnkuZXZlbnQuc3BlY2lhbCwgaSA9IDA7CiAgICAgIGZvciAoOyAoZWxlbSA9IGVsZW1zW2ldKSAhPT0gdW5kZWZpbmVkOyBpKyspIHsKICAgICAgICBpZiAoalF1ZXJ5LmFjY2VwdERhdGEoZWxlbSkpIHsKICAgICAgICAgIGtleSA9IGVsZW1bZGF0YV9wcml2LmV4cGFuZG9dOwogICAgICAgICAgaWYgKGtleSAmJiAoZGF0YSA9IGRhdGFfcHJpdi5jYWNoZVtrZXldKSkgewogICAgICAgICAgICBpZiAoZGF0YS5ldmVudHMpIHsKICAgICAgICAgICAgICBmb3IgKHR5cGUgaW4gZGF0YS5ldmVudHMpIHsKICAgICAgICAgICAgICAgIGlmIChzcGVjaWFsW3R5cGVdKSB7CiAgICAgICAgICAgICAgICAgIGpRdWVyeS5ldmVudC5yZW1vdmUoZWxlbSwgdHlwZSk7ICAvLyBUaGlzIGlzIGEgc2hvcnRjdXQgdG8gYXZvaWQgalF1ZXJ5LmV2ZW50LnJlbW92ZSdzIG92ZXJoZWFkCiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBqUXVlcnkucmVtb3ZlRXZlbnQoZWxlbSwgdHlwZSwgZGF0YS5oYW5kbGUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZGF0YV9wcml2LmNhY2hlW2tleV0pIHsKICAgICAgICAgICAgICAvLyBEaXNjYXJkIGFueSByZW1haW5pbmcgYHByaXZhdGVgIGRhdGEKICAgICAgICAgICAgICBkZWxldGUgZGF0YV9wcml2LmNhY2hlW2tleV07CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgLy8gRGlzY2FyZCBhbnkgcmVtYWluaW5nIGB1c2VyYCBkYXRhCiAgICAgICAgZGVsZXRlIGRhdGFfdXNlci5jYWNoZVtlbGVtW2RhdGFfdXNlci5leHBhbmRvXV07CiAgICAgIH0KICAgIH0KICB9KTsKICBqUXVlcnkuZm4uZXh0ZW5kKHsKICAgIHRleHQ6IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICByZXR1cm4gYWNjZXNzKHRoaXMsIGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgIHJldHVybiB2YWx1ZSA9PT0gdW5kZWZpbmVkID8galF1ZXJ5LnRleHQodGhpcykgOiB0aGlzLmVtcHR5KCkuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICBpZiAodGhpcy5ub2RlVHlwZSA9PT0gMSB8fCB0aGlzLm5vZGVUeXBlID09PSAxMSB8fCB0aGlzLm5vZGVUeXBlID09PSA5KSB7CiAgICAgICAgICAgIHRoaXMudGV4dENvbnRlbnQgPSB2YWx1ZTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfSwgbnVsbCwgdmFsdWUsIGFyZ3VtZW50cy5sZW5ndGgpOwogICAgfSwKICAgIGFwcGVuZDogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gdGhpcy5kb21NYW5pcChhcmd1bWVudHMsIGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgaWYgKHRoaXMubm9kZVR5cGUgPT09IDEgfHwgdGhpcy5ub2RlVHlwZSA9PT0gMTEgfHwgdGhpcy5ub2RlVHlwZSA9PT0gOSkgewogICAgICAgICAgdmFyIHRhcmdldCA9IG1hbmlwdWxhdGlvblRhcmdldCh0aGlzLCBlbGVtKTsKICAgICAgICAgIHRhcmdldC5hcHBlbmRDaGlsZChlbGVtKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSwKICAgIHByZXBlbmQ6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIHRoaXMuZG9tTWFuaXAoYXJndW1lbnRzLCBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgIGlmICh0aGlzLm5vZGVUeXBlID09PSAxIHx8IHRoaXMubm9kZVR5cGUgPT09IDExIHx8IHRoaXMubm9kZVR5cGUgPT09IDkpIHsKICAgICAgICAgIHZhciB0YXJnZXQgPSBtYW5pcHVsYXRpb25UYXJnZXQodGhpcywgZWxlbSk7CiAgICAgICAgICB0YXJnZXQuaW5zZXJ0QmVmb3JlKGVsZW0sIHRhcmdldC5maXJzdENoaWxkKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSwKICAgIGJlZm9yZTogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gdGhpcy5kb21NYW5pcChhcmd1bWVudHMsIGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgaWYgKHRoaXMucGFyZW50Tm9kZSkgewogICAgICAgICAgdGhpcy5wYXJlbnROb2RlLmluc2VydEJlZm9yZShlbGVtLCB0aGlzKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSwKICAgIGFmdGVyOiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiB0aGlzLmRvbU1hbmlwKGFyZ3VtZW50cywgZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICBpZiAodGhpcy5wYXJlbnROb2RlKSB7CiAgICAgICAgICB0aGlzLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKGVsZW0sIHRoaXMubmV4dFNpYmxpbmcpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9LAogICAgcmVtb3ZlOiBmdW5jdGlvbiAoc2VsZWN0b3IsIGtlZXBEYXRhKSB7CiAgICAgIHZhciBlbGVtLCBlbGVtcyA9IHNlbGVjdG9yID8galF1ZXJ5LmZpbHRlcihzZWxlY3RvciwgdGhpcykgOiB0aGlzLCBpID0gMDsKICAgICAgZm9yICg7IChlbGVtID0gZWxlbXNbaV0pICE9IG51bGw7IGkrKykgewogICAgICAgIGlmICgha2VlcERhdGEgJiYgZWxlbS5ub2RlVHlwZSA9PT0gMSkgewogICAgICAgICAgalF1ZXJ5LmNsZWFuRGF0YShnZXRBbGwoZWxlbSkpOwogICAgICAgIH0KICAgICAgICBpZiAoZWxlbS5wYXJlbnROb2RlKSB7CiAgICAgICAgICBpZiAoa2VlcERhdGEgJiYgalF1ZXJ5LmNvbnRhaW5zKGVsZW0ub3duZXJEb2N1bWVudCwgZWxlbSkpIHsKICAgICAgICAgICAgc2V0R2xvYmFsRXZhbChnZXRBbGwoZWxlbSwgJ3NjcmlwdCcpKTsKICAgICAgICAgIH0KICAgICAgICAgIGVsZW0ucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChlbGVtKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogICAgZW1wdHk6IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIGVsZW0sIGkgPSAwOwogICAgICBmb3IgKDsgKGVsZW0gPSB0aGlzW2ldKSAhPSBudWxsOyBpKyspIHsKICAgICAgICBpZiAoZWxlbS5ub2RlVHlwZSA9PT0gMSkgewogICAgICAgICAgLy8gUHJldmVudCBtZW1vcnkgbGVha3MKICAgICAgICAgIGpRdWVyeS5jbGVhbkRhdGEoZ2V0QWxsKGVsZW0sIGZhbHNlKSk7CiAgICAgICAgICAvLyBSZW1vdmUgYW55IHJlbWFpbmluZyBub2RlcwogICAgICAgICAgZWxlbS50ZXh0Q29udGVudCA9ICcnOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgICBjbG9uZTogZnVuY3Rpb24gKGRhdGFBbmRFdmVudHMsIGRlZXBEYXRhQW5kRXZlbnRzKSB7CiAgICAgIGRhdGFBbmRFdmVudHMgPSBkYXRhQW5kRXZlbnRzID09IG51bGwgPyBmYWxzZSA6IGRhdGFBbmRFdmVudHM7CiAgICAgIGRlZXBEYXRhQW5kRXZlbnRzID0gZGVlcERhdGFBbmRFdmVudHMgPT0gbnVsbCA/IGRhdGFBbmRFdmVudHMgOiBkZWVwRGF0YUFuZEV2ZW50czsKICAgICAgcmV0dXJuIHRoaXMubWFwKGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4galF1ZXJ5LmNsb25lKHRoaXMsIGRhdGFBbmRFdmVudHMsIGRlZXBEYXRhQW5kRXZlbnRzKTsKICAgICAgfSk7CiAgICB9LAogICAgaHRtbDogZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgIHJldHVybiBhY2Nlc3ModGhpcywgZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgdmFyIGVsZW0gPSB0aGlzWzBdIHx8IHt9LCBpID0gMCwgbCA9IHRoaXMubGVuZ3RoOwogICAgICAgIGlmICh2YWx1ZSA9PT0gdW5kZWZpbmVkICYmIGVsZW0ubm9kZVR5cGUgPT09IDEpIHsKICAgICAgICAgIHJldHVybiBlbGVtLmlubmVySFRNTDsKICAgICAgICB9CiAgICAgICAgLy8gU2VlIGlmIHdlIGNhbiB0YWtlIGEgc2hvcnRjdXQgYW5kIGp1c3QgdXNlIGlubmVySFRNTAogICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICdzdHJpbmcnICYmICFybm9Jbm5lcmh0bWwudGVzdCh2YWx1ZSkgJiYgIXdyYXBNYXBbKHJ0YWdOYW1lLmV4ZWModmFsdWUpIHx8IFsKICAgICAgICAgICAgJycsCiAgICAgICAgICAgICcnCiAgICAgICAgICBdKVsxXS50b0xvd2VyQ2FzZSgpXSkgewogICAgICAgICAgdmFsdWUgPSB2YWx1ZS5yZXBsYWNlKHJ4aHRtbFRhZywgJzwkMT48LyQyPicpOwogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgZm9yICg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgICAgICBlbGVtID0gdGhpc1tpXSB8fCB7fTsKICAgICAgICAgICAgICAvLyBSZW1vdmUgZWxlbWVudCBub2RlcyBhbmQgcHJldmVudCBtZW1vcnkgbGVha3MKICAgICAgICAgICAgICBpZiAoZWxlbS5ub2RlVHlwZSA9PT0gMSkgewogICAgICAgICAgICAgICAgalF1ZXJ5LmNsZWFuRGF0YShnZXRBbGwoZWxlbSwgZmFsc2UpKTsKICAgICAgICAgICAgICAgIGVsZW0uaW5uZXJIVE1MID0gdmFsdWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsZW0gPSAwOyAgLy8gSWYgdXNpbmcgaW5uZXJIVE1MIHRocm93cyBhbiBleGNlcHRpb24sIHVzZSB0aGUgZmFsbGJhY2sgbWV0aG9kCiAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChlbGVtKSB7CiAgICAgICAgICB0aGlzLmVtcHR5KCkuYXBwZW5kKHZhbHVlKTsKICAgICAgICB9CiAgICAgIH0sIG51bGwsIHZhbHVlLCBhcmd1bWVudHMubGVuZ3RoKTsKICAgIH0sCiAgICByZXBsYWNlV2l0aDogZnVuY3Rpb24gKCkgewogICAgICB2YXIgYXJnID0gYXJndW1lbnRzWzBdOwogICAgICAvLyBNYWtlIHRoZSBjaGFuZ2VzLCByZXBsYWNpbmcgZWFjaCBjb250ZXh0IGVsZW1lbnQgd2l0aCB0aGUgbmV3IGNvbnRlbnQKICAgICAgdGhpcy5kb21NYW5pcChhcmd1bWVudHMsIGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgYXJnID0gdGhpcy5wYXJlbnROb2RlOwogICAgICAgIGpRdWVyeS5jbGVhbkRhdGEoZ2V0QWxsKHRoaXMpKTsKICAgICAgICBpZiAoYXJnKSB7CiAgICAgICAgICBhcmcucmVwbGFjZUNoaWxkKGVsZW0sIHRoaXMpOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIC8vIEZvcmNlIHJlbW92YWwgaWYgdGhlcmUgd2FzIG5vIG5ldyBjb250ZW50IChlLmcuLCBmcm9tIGVtcHR5IGFyZ3VtZW50cykKICAgICAgcmV0dXJuIGFyZyAmJiAoYXJnLmxlbmd0aCB8fCBhcmcubm9kZVR5cGUpID8gdGhpcyA6IHRoaXMucmVtb3ZlKCk7CiAgICB9LAogICAgZGV0YWNoOiBmdW5jdGlvbiAoc2VsZWN0b3IpIHsKICAgICAgcmV0dXJuIHRoaXMucmVtb3ZlKHNlbGVjdG9yLCB0cnVlKTsKICAgIH0sCiAgICBkb21NYW5pcDogZnVuY3Rpb24gKGFyZ3MsIGNhbGxiYWNrKSB7CiAgICAgIC8vIEZsYXR0ZW4gYW55IG5lc3RlZCBhcnJheXMKICAgICAgYXJncyA9IGNvbmNhdC5hcHBseShbXSwgYXJncyk7CiAgICAgIHZhciBmcmFnbWVudCwgZmlyc3QsIHNjcmlwdHMsIGhhc1NjcmlwdHMsIG5vZGUsIGRvYywgaSA9IDAsIGwgPSB0aGlzLmxlbmd0aCwgc2V0ID0gdGhpcywgaU5vQ2xvbmUgPSBsIC0gMSwgdmFsdWUgPSBhcmdzWzBdLCBpc0Z1bmN0aW9uID0galF1ZXJ5LmlzRnVuY3Rpb24odmFsdWUpOwogICAgICAvLyBXZSBjYW4ndCBjbG9uZU5vZGUgZnJhZ21lbnRzIHRoYXQgY29udGFpbiBjaGVja2VkLCBpbiBXZWJLaXQKICAgICAgaWYgKGlzRnVuY3Rpb24gfHwgbCA+IDEgJiYgdHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJyAmJiAhc3VwcG9ydC5jaGVja0Nsb25lICYmIHJjaGVja2VkLnRlc3QodmFsdWUpKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoaW5kZXgpIHsKICAgICAgICAgIHZhciBzZWxmID0gc2V0LmVxKGluZGV4KTsKICAgICAgICAgIGlmIChpc0Z1bmN0aW9uKSB7CiAgICAgICAgICAgIGFyZ3NbMF0gPSB2YWx1ZS5jYWxsKHRoaXMsIGluZGV4LCBzZWxmLmh0bWwoKSk7CiAgICAgICAgICB9CiAgICAgICAgICBzZWxmLmRvbU1hbmlwKGFyZ3MsIGNhbGxiYWNrKTsKICAgICAgICB9KTsKICAgICAgfQogICAgICBpZiAobCkgewogICAgICAgIGZyYWdtZW50ID0galF1ZXJ5LmJ1aWxkRnJhZ21lbnQoYXJncywgdGhpc1swXS5vd25lckRvY3VtZW50LCBmYWxzZSwgdGhpcyk7CiAgICAgICAgZmlyc3QgPSBmcmFnbWVudC5maXJzdENoaWxkOwogICAgICAgIGlmIChmcmFnbWVudC5jaGlsZE5vZGVzLmxlbmd0aCA9PT0gMSkgewogICAgICAgICAgZnJhZ21lbnQgPSBmaXJzdDsKICAgICAgICB9CiAgICAgICAgaWYgKGZpcnN0KSB7CiAgICAgICAgICBzY3JpcHRzID0galF1ZXJ5Lm1hcChnZXRBbGwoZnJhZ21lbnQsICdzY3JpcHQnKSwgZGlzYWJsZVNjcmlwdCk7CiAgICAgICAgICBoYXNTY3JpcHRzID0gc2NyaXB0cy5sZW5ndGg7CiAgICAgICAgICAvLyBVc2UgdGhlIG9yaWdpbmFsIGZyYWdtZW50IGZvciB0aGUgbGFzdCBpdGVtIGluc3RlYWQgb2YgdGhlIGZpcnN0IGJlY2F1c2UgaXQgY2FuIGVuZCB1cAogICAgICAgICAgLy8gYmVpbmcgZW1wdGllZCBpbmNvcnJlY3RseSBpbiBjZXJ0YWluIHNpdHVhdGlvbnMgKCM4MDcwKS4KICAgICAgICAgIGZvciAoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgICAgIG5vZGUgPSBmcmFnbWVudDsKICAgICAgICAgICAgaWYgKGkgIT09IGlOb0Nsb25lKSB7CiAgICAgICAgICAgICAgbm9kZSA9IGpRdWVyeS5jbG9uZShub2RlLCB0cnVlLCB0cnVlKTsKICAgICAgICAgICAgICAvLyBLZWVwIHJlZmVyZW5jZXMgdG8gY2xvbmVkIHNjcmlwdHMgZm9yIGxhdGVyIHJlc3RvcmF0aW9uCiAgICAgICAgICAgICAgaWYgKGhhc1NjcmlwdHMpIHsKICAgICAgICAgICAgICAgIC8vIFN1cHBvcnQ6IFF0V2ViS2l0CiAgICAgICAgICAgICAgICAvLyBqUXVlcnkubWVyZ2UgYmVjYXVzZSBwdXNoLmFwcGx5KF8sIGFycmF5bGlrZSkgdGhyb3dzCiAgICAgICAgICAgICAgICBqUXVlcnkubWVyZ2Uoc2NyaXB0cywgZ2V0QWxsKG5vZGUsICdzY3JpcHQnKSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhbGxiYWNrLmNhbGwodGhpc1tpXSwgbm9kZSwgaSk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaGFzU2NyaXB0cykgewogICAgICAgICAgICBkb2MgPSBzY3JpcHRzW3NjcmlwdHMubGVuZ3RoIC0gMV0ub3duZXJEb2N1bWVudDsKICAgICAgICAgICAgLy8gUmVlbmFibGUgc2NyaXB0cwogICAgICAgICAgICBqUXVlcnkubWFwKHNjcmlwdHMsIHJlc3RvcmVTY3JpcHQpOwogICAgICAgICAgICAvLyBFdmFsdWF0ZSBleGVjdXRhYmxlIHNjcmlwdHMgb24gZmlyc3QgZG9jdW1lbnQgaW5zZXJ0aW9uCiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBoYXNTY3JpcHRzOyBpKyspIHsKICAgICAgICAgICAgICBub2RlID0gc2NyaXB0c1tpXTsKICAgICAgICAgICAgICBpZiAocnNjcmlwdFR5cGUudGVzdChub2RlLnR5cGUgfHwgJycpICYmICFkYXRhX3ByaXYuYWNjZXNzKG5vZGUsICdnbG9iYWxFdmFsJykgJiYgalF1ZXJ5LmNvbnRhaW5zKGRvYywgbm9kZSkpIHsKICAgICAgICAgICAgICAgIGlmIChub2RlLnNyYykgewogICAgICAgICAgICAgICAgICAvLyBPcHRpb25hbCBBSkFYIGRlcGVuZGVuY3ksIGJ1dCB3b24ndCBydW4gc2NyaXB0cyBpZiBub3QgcHJlc2VudAogICAgICAgICAgICAgICAgICBpZiAoalF1ZXJ5Ll9ldmFsVXJsKSB7CiAgICAgICAgICAgICAgICAgICAgalF1ZXJ5Ll9ldmFsVXJsKG5vZGUuc3JjKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgalF1ZXJ5Lmdsb2JhbEV2YWwobm9kZS50ZXh0Q29udGVudC5yZXBsYWNlKHJjbGVhblNjcmlwdCwgJycpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgfSk7CiAgalF1ZXJ5LmVhY2goewogICAgYXBwZW5kVG86ICdhcHBlbmQnLAogICAgcHJlcGVuZFRvOiAncHJlcGVuZCcsCiAgICBpbnNlcnRCZWZvcmU6ICdiZWZvcmUnLAogICAgaW5zZXJ0QWZ0ZXI6ICdhZnRlcicsCiAgICByZXBsYWNlQWxsOiAncmVwbGFjZVdpdGgnCiAgfSwgZnVuY3Rpb24gKG5hbWUsIG9yaWdpbmFsKSB7CiAgICBqUXVlcnkuZm5bbmFtZV0gPSBmdW5jdGlvbiAoc2VsZWN0b3IpIHsKICAgICAgdmFyIGVsZW1zLCByZXQgPSBbXSwgaW5zZXJ0ID0galF1ZXJ5KHNlbGVjdG9yKSwgbGFzdCA9IGluc2VydC5sZW5ndGggLSAxLCBpID0gMDsKICAgICAgZm9yICg7IGkgPD0gbGFzdDsgaSsrKSB7CiAgICAgICAgZWxlbXMgPSBpID09PSBsYXN0ID8gdGhpcyA6IHRoaXMuY2xvbmUodHJ1ZSk7CiAgICAgICAgalF1ZXJ5KGluc2VydFtpXSlbb3JpZ2luYWxdKGVsZW1zKTsKICAgICAgICAvLyBTdXBwb3J0OiBRdFdlYktpdAogICAgICAgIC8vIC5nZXQoKSBiZWNhdXNlIHB1c2guYXBwbHkoXywgYXJyYXlsaWtlKSB0aHJvd3MKICAgICAgICBwdXNoLmFwcGx5KHJldCwgZWxlbXMuZ2V0KCkpOwogICAgICB9CiAgICAgIHJldHVybiB0aGlzLnB1c2hTdGFjayhyZXQpOwogICAgfTsKICB9KTsKICB2YXIgaWZyYW1lLCBlbGVtZGlzcGxheSA9IHt9OwogIC8qKgogICAqIFJldHJpZXZlIHRoZSBhY3R1YWwgZGlzcGxheSBvZiBhIGVsZW1lbnQKICAgKiBAcGFyYW0ge1N0cmluZ30gbmFtZSBub2RlTmFtZSBvZiB0aGUgZWxlbWVudAogICAqIEBwYXJhbSB7T2JqZWN0fSBkb2MgRG9jdW1lbnQgb2JqZWN0CiAgICovCiAgLy8gQ2FsbGVkIG9ubHkgZnJvbSB3aXRoaW4gZGVmYXVsdERpc3BsYXkKICBmdW5jdGlvbiBhY3R1YWxEaXNwbGF5KG5hbWUsIGRvYykgewogICAgdmFyIHN0eWxlLCBlbGVtID0galF1ZXJ5KGRvYy5jcmVhdGVFbGVtZW50KG5hbWUpKS5hcHBlbmRUbyhkb2MuYm9keSksCiAgICAgIC8vIGdldERlZmF1bHRDb21wdXRlZFN0eWxlIG1pZ2h0IGJlIHJlbGlhYmx5IHVzZWQgb25seSBvbiBhdHRhY2hlZCBlbGVtZW50CiAgICAgIGRpc3BsYXkgPSB3aW5kb3cuZ2V0RGVmYXVsdENvbXB1dGVkU3R5bGUgJiYgKHN0eWxlID0gd2luZG93LmdldERlZmF1bHRDb21wdXRlZFN0eWxlKGVsZW1bMF0pKSA/IC8vIFVzZSBvZiB0aGlzIG1ldGhvZCBpcyBhIHRlbXBvcmFyeSBmaXggKG1vcmUgbGlrZSBvcHRtaXphdGlvbikgdW50aWwgc29tZXRoaW5nIGJldHRlciBjb21lcyBhbG9uZywKICAgICAgLy8gc2luY2UgaXQgd2FzIHJlbW92ZWQgZnJvbSBzcGVjaWZpY2F0aW9uIGFuZCBzdXBwb3J0ZWQgb25seSBpbiBGRgogICAgICBzdHlsZS5kaXNwbGF5IDogalF1ZXJ5LmNzcyhlbGVtWzBdLCAnZGlzcGxheScpOwogICAgLy8gV2UgZG9uJ3QgaGF2ZSBhbnkgZGF0YSBzdG9yZWQgb24gdGhlIGVsZW1lbnQsCiAgICAvLyBzbyB1c2UgImRldGFjaCIgbWV0aG9kIGFzIGZhc3Qgd2F5IHRvIGdldCByaWQgb2YgdGhlIGVsZW1lbnQKICAgIGVsZW0uZGV0YWNoKCk7CiAgICByZXR1cm4gZGlzcGxheTsKICB9CiAgLyoqCiAgICogVHJ5IHRvIGRldGVybWluZSB0aGUgZGVmYXVsdCBkaXNwbGF5IHZhbHVlIG9mIGFuIGVsZW1lbnQKICAgKiBAcGFyYW0ge1N0cmluZ30gbm9kZU5hbWUKICAgKi8KICBmdW5jdGlvbiBkZWZhdWx0RGlzcGxheShub2RlTmFtZSkgewogICAgdmFyIGRvYyA9IGRvY3VtZW50LCBkaXNwbGF5ID0gZWxlbWRpc3BsYXlbbm9kZU5hbWVdOwogICAgaWYgKCFkaXNwbGF5KSB7CiAgICAgIGRpc3BsYXkgPSBhY3R1YWxEaXNwbGF5KG5vZGVOYW1lLCBkb2MpOwogICAgICAvLyBJZiB0aGUgc2ltcGxlIHdheSBmYWlscywgcmVhZCBmcm9tIGluc2lkZSBhbiBpZnJhbWUKICAgICAgaWYgKGRpc3BsYXkgPT09ICdub25lJyB8fCAhZGlzcGxheSkgewogICAgICAgIC8vIFVzZSB0aGUgYWxyZWFkeS1jcmVhdGVkIGlmcmFtZSBpZiBwb3NzaWJsZQogICAgICAgIGlmcmFtZSA9IChpZnJhbWUgfHwgalF1ZXJ5KCc8aWZyYW1lIGZyYW1lYm9yZGVyPVwnMFwnIHdpZHRoPVwnMFwnIGhlaWdodD1cJzBcJy8+JykpLmFwcGVuZFRvKGRvYy5kb2N1bWVudEVsZW1lbnQpOwogICAgICAgIC8vIEFsd2F5cyB3cml0ZSBhIG5ldyBIVE1MIHNrZWxldG9uIHNvIFdlYmtpdCBhbmQgRmlyZWZveCBkb24ndCBjaG9rZSBvbiByZXVzZQogICAgICAgIGRvYyA9IGlmcmFtZVswXS5jb250ZW50RG9jdW1lbnQ7CiAgICAgICAgLy8gU3VwcG9ydDogSUUKICAgICAgICBkb2Mud3JpdGUoKTsKICAgICAgICBkb2MuY2xvc2UoKTsKICAgICAgICBkaXNwbGF5ID0gYWN0dWFsRGlzcGxheShub2RlTmFtZSwgZG9jKTsKICAgICAgICBpZnJhbWUuZGV0YWNoKCk7CiAgICAgIH0KICAgICAgLy8gU3RvcmUgdGhlIGNvcnJlY3QgZGVmYXVsdCBkaXNwbGF5CiAgICAgIGVsZW1kaXNwbGF5W25vZGVOYW1lXSA9IGRpc3BsYXk7CiAgICB9CiAgICByZXR1cm4gZGlzcGxheTsKICB9CiAgdmFyIHJtYXJnaW4gPSAvXm1hcmdpbi87CiAgdmFyIHJudW1ub25weCA9IG5ldyBSZWdFeHAoJ14oJyArIHBudW0gKyAnKSg/IXB4KVthLXolXSskJywgJ2knKTsKICB2YXIgZ2V0U3R5bGVzID0gZnVuY3Rpb24gKGVsZW0pIHsKICAgIHJldHVybiBlbGVtLm93bmVyRG9jdW1lbnQuZGVmYXVsdFZpZXcuZ2V0Q29tcHV0ZWRTdHlsZShlbGVtLCBudWxsKTsKICB9OwogIGZ1bmN0aW9uIGN1ckNTUyhlbGVtLCBuYW1lLCBjb21wdXRlZCkgewogICAgdmFyIHdpZHRoLCBtaW5XaWR0aCwgbWF4V2lkdGgsIHJldCwgc3R5bGUgPSBlbGVtLnN0eWxlOwogICAgY29tcHV0ZWQgPSBjb21wdXRlZCB8fCBnZXRTdHlsZXMoZWxlbSk7CiAgICAvLyBTdXBwb3J0OiBJRTkKICAgIC8vIGdldFByb3BlcnR5VmFsdWUgaXMgb25seSBuZWVkZWQgZm9yIC5jc3MoJ2ZpbHRlcicpIGluIElFOSwgc2VlICMxMjUzNwogICAgaWYgKGNvbXB1dGVkKSB7CiAgICAgIHJldCA9IGNvbXB1dGVkLmdldFByb3BlcnR5VmFsdWUobmFtZSkgfHwgY29tcHV0ZWRbbmFtZV07CiAgICB9CiAgICBpZiAoY29tcHV0ZWQpIHsKICAgICAgaWYgKHJldCA9PT0gJycgJiYgIWpRdWVyeS5jb250YWlucyhlbGVtLm93bmVyRG9jdW1lbnQsIGVsZW0pKSB7CiAgICAgICAgcmV0ID0galF1ZXJ5LnN0eWxlKGVsZW0sIG5hbWUpOwogICAgICB9CiAgICAgIC8vIFN1cHBvcnQ6IGlPUyA8IDYKICAgICAgLy8gQSB0cmlidXRlIHRvIHRoZSAiYXdlc29tZSBoYWNrIGJ5IERlYW4gRWR3YXJkcyIKICAgICAgLy8gaU9TIDwgNiAoYXQgbGVhc3QpIHJldHVybnMgcGVyY2VudGFnZSBmb3IgYSBsYXJnZXIgc2V0IG9mIHZhbHVlcywgYnV0IHdpZHRoIHNlZW1zIHRvIGJlIHJlbGlhYmx5IHBpeGVscwogICAgICAvLyB0aGlzIGlzIGFnYWluc3QgdGhlIENTU09NIGRyYWZ0IHNwZWM6IGh0dHA6Ly9kZXYudzMub3JnL2Nzc3dnL2Nzc29tLyNyZXNvbHZlZC12YWx1ZXMKICAgICAgaWYgKHJudW1ub25weC50ZXN0KHJldCkgJiYgcm1hcmdpbi50ZXN0KG5hbWUpKSB7CiAgICAgICAgLy8gUmVtZW1iZXIgdGhlIG9yaWdpbmFsIHZhbHVlcwogICAgICAgIHdpZHRoID0gc3R5bGUud2lkdGg7CiAgICAgICAgbWluV2lkdGggPSBzdHlsZS5taW5XaWR0aDsKICAgICAgICBtYXhXaWR0aCA9IHN0eWxlLm1heFdpZHRoOwogICAgICAgIC8vIFB1dCBpbiB0aGUgbmV3IHZhbHVlcyB0byBnZXQgYSBjb21wdXRlZCB2YWx1ZSBvdXQKICAgICAgICBzdHlsZS5taW5XaWR0aCA9IHN0eWxlLm1heFdpZHRoID0gc3R5bGUud2lkdGggPSByZXQ7CiAgICAgICAgcmV0ID0gY29tcHV0ZWQud2lkdGg7CiAgICAgICAgLy8gUmV2ZXJ0IHRoZSBjaGFuZ2VkIHZhbHVlcwogICAgICAgIHN0eWxlLndpZHRoID0gd2lkdGg7CiAgICAgICAgc3R5bGUubWluV2lkdGggPSBtaW5XaWR0aDsKICAgICAgICBzdHlsZS5tYXhXaWR0aCA9IG1heFdpZHRoOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gcmV0ICE9PSB1bmRlZmluZWQgPyAvLyBTdXBwb3J0OiBJRQogICAgLy8gSUUgcmV0dXJucyB6SW5kZXggdmFsdWUgYXMgYW4gaW50ZWdlci4KICAgIHJldCArICcnIDogcmV0OwogIH0KICBmdW5jdGlvbiBhZGRHZXRIb29rSWYoY29uZGl0aW9uRm4sIGhvb2tGbikgewogICAgLy8gRGVmaW5lIHRoZSBob29rLCB3ZSdsbCBjaGVjayBvbiB0aGUgZmlyc3QgcnVuIGlmIGl0J3MgcmVhbGx5IG5lZWRlZC4KICAgIHJldHVybiB7CiAgICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIGlmIChjb25kaXRpb25GbigpKSB7CiAgICAgICAgICAvLyBIb29rIG5vdCBuZWVkZWQgKG9yIGl0J3Mgbm90IHBvc3NpYmxlIHRvIHVzZSBpdCBkdWUgdG8gbWlzc2luZyBkZXBlbmRlbmN5KSwKICAgICAgICAgIC8vIHJlbW92ZSBpdC4KICAgICAgICAgIC8vIFNpbmNlIHRoZXJlIGFyZSBubyBvdGhlciBob29rcyBmb3IgbWFyZ2luUmlnaHQsIHJlbW92ZSB0aGUgd2hvbGUgb2JqZWN0LgogICAgICAgICAgZGVsZXRlIHRoaXMuZ2V0OwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICAvLyBIb29rIG5lZWRlZDsgcmVkZWZpbmUgaXQgc28gdGhhdCB0aGUgc3VwcG9ydCB0ZXN0IGlzIG5vdCBleGVjdXRlZCBhZ2Fpbi4KICAgICAgICByZXR1cm4gKHRoaXMuZ2V0ID0gaG9va0ZuKS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9CiAgICB9OwogIH0KICAoZnVuY3Rpb24gKCkgewogICAgdmFyIHBpeGVsUG9zaXRpb25WYWwsIGJveFNpemluZ1JlbGlhYmxlVmFsLCBkb2NFbGVtID0gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LCBjb250YWluZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKSwgZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICBpZiAoIWRpdi5zdHlsZSkgewogICAgICByZXR1cm47CiAgICB9CiAgICBkaXYuc3R5bGUuYmFja2dyb3VuZENsaXAgPSAnY29udGVudC1ib3gnOwogICAgZGl2LmNsb25lTm9kZSh0cnVlKS5zdHlsZS5iYWNrZ3JvdW5kQ2xpcCA9ICcnOwogICAgc3VwcG9ydC5jbGVhckNsb25lU3R5bGUgPSBkaXYuc3R5bGUuYmFja2dyb3VuZENsaXAgPT09ICdjb250ZW50LWJveCc7CiAgICBjb250YWluZXIuc3R5bGUuY3NzVGV4dCA9ICdib3JkZXI6MDt3aWR0aDowO2hlaWdodDowO3RvcDowO2xlZnQ6LTk5OTlweDttYXJnaW4tdG9wOjFweDsnICsgJ3Bvc2l0aW9uOmFic29sdXRlJzsKICAgIGNvbnRhaW5lci5hcHBlbmRDaGlsZChkaXYpOwogICAgLy8gRXhlY3V0aW5nIGJvdGggcGl4ZWxQb3NpdGlvbiAmIGJveFNpemluZ1JlbGlhYmxlIHRlc3RzIHJlcXVpcmUgb25seSBvbmUgbGF5b3V0CiAgICAvLyBzbyB0aGV5J3JlIGV4ZWN1dGVkIGF0IHRoZSBzYW1lIHRpbWUgdG8gc2F2ZSB0aGUgc2Vjb25kIGNvbXB1dGF0aW9uLgogICAgZnVuY3Rpb24gY29tcHV0ZVBpeGVsUG9zaXRpb25BbmRCb3hTaXppbmdSZWxpYWJsZSgpIHsKICAgICAgZGl2LnN0eWxlLmNzc1RleHQgPSAvLyBTdXBwb3J0OiBGaXJlZm94PDI5LCBBbmRyb2lkIDIuMwogICAgICAvLyBWZW5kb3ItcHJlZml4IGJveC1zaXppbmcKICAgICAgJy13ZWJraXQtYm94LXNpemluZzpib3JkZXItYm94Oy1tb3otYm94LXNpemluZzpib3JkZXItYm94OycgKyAnYm94LXNpemluZzpib3JkZXItYm94O2Rpc3BsYXk6YmxvY2s7bWFyZ2luLXRvcDoxJTt0b3A6MSU7JyArICdib3JkZXI6MXB4O3BhZGRpbmc6MXB4O3dpZHRoOjRweDtwb3NpdGlvbjphYnNvbHV0ZSc7CiAgICAgIGRpdi5pbm5lckhUTUwgPSAnJzsKICAgICAgZG9jRWxlbS5hcHBlbmRDaGlsZChjb250YWluZXIpOwogICAgICB2YXIgZGl2U3R5bGUgPSB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZShkaXYsIG51bGwpOwogICAgICBwaXhlbFBvc2l0aW9uVmFsID0gZGl2U3R5bGUudG9wICE9PSAnMSUnOwogICAgICBib3hTaXppbmdSZWxpYWJsZVZhbCA9IGRpdlN0eWxlLndpZHRoID09PSAnNHB4JzsKICAgICAgZG9jRWxlbS5yZW1vdmVDaGlsZChjb250YWluZXIpOwogICAgfQogICAgLy8gU3VwcG9ydDogbm9kZS5qcyBqc2RvbQogICAgLy8gRG9uJ3QgYXNzdW1lIHRoYXQgZ2V0Q29tcHV0ZWRTdHlsZSBpcyBhIHByb3BlcnR5IG9mIHRoZSBnbG9iYWwgb2JqZWN0CiAgICBpZiAod2luZG93LmdldENvbXB1dGVkU3R5bGUpIHsKICAgICAgalF1ZXJ5LmV4dGVuZChzdXBwb3J0LCB7CiAgICAgICAgcGl4ZWxQb3NpdGlvbjogZnVuY3Rpb24gKCkgewogICAgICAgICAgLy8gVGhpcyB0ZXN0IGlzIGV4ZWN1dGVkIG9ubHkgb25jZSBidXQgd2Ugc3RpbGwgZG8gbWVtb2l6aW5nCiAgICAgICAgICAvLyBzaW5jZSB3ZSBjYW4gdXNlIHRoZSBib3hTaXppbmdSZWxpYWJsZSBwcmUtY29tcHV0aW5nLgogICAgICAgICAgLy8gTm8gbmVlZCB0byBjaGVjayBpZiB0aGUgdGVzdCB3YXMgYWxyZWFkeSBwZXJmb3JtZWQsIHRob3VnaC4KICAgICAgICAgIGNvbXB1dGVQaXhlbFBvc2l0aW9uQW5kQm94U2l6aW5nUmVsaWFibGUoKTsKICAgICAgICAgIHJldHVybiBwaXhlbFBvc2l0aW9uVmFsOwogICAgICAgIH0sCiAgICAgICAgYm94U2l6aW5nUmVsaWFibGU6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGlmIChib3hTaXppbmdSZWxpYWJsZVZhbCA9PSBudWxsKSB7CiAgICAgICAgICAgIGNvbXB1dGVQaXhlbFBvc2l0aW9uQW5kQm94U2l6aW5nUmVsaWFibGUoKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBib3hTaXppbmdSZWxpYWJsZVZhbDsKICAgICAgICB9LAogICAgICAgIHJlbGlhYmxlTWFyZ2luUmlnaHQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIC8vIFN1cHBvcnQ6IEFuZHJvaWQgMi4zCiAgICAgICAgICAvLyBDaGVjayBpZiBkaXYgd2l0aCBleHBsaWNpdCB3aWR0aCBhbmQgbm8gbWFyZ2luLXJpZ2h0IGluY29ycmVjdGx5CiAgICAgICAgICAvLyBnZXRzIGNvbXB1dGVkIG1hcmdpbi1yaWdodCBiYXNlZCBvbiB3aWR0aCBvZiBjb250YWluZXIuICgjMzMzMykKICAgICAgICAgIC8vIFdlYktpdCBCdWcgMTMzNDMgLSBnZXRDb21wdXRlZFN0eWxlIHJldHVybnMgd3JvbmcgdmFsdWUgZm9yIG1hcmdpbi1yaWdodAogICAgICAgICAgLy8gVGhpcyBzdXBwb3J0IGZ1bmN0aW9uIGlzIG9ubHkgZXhlY3V0ZWQgb25jZSBzbyBubyBtZW1vaXppbmcgaXMgbmVlZGVkLgogICAgICAgICAgdmFyIHJldCwgbWFyZ2luRGl2ID0gZGl2LmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpKTsKICAgICAgICAgIC8vIFJlc2V0IENTUzogYm94LXNpemluZzsgZGlzcGxheTsgbWFyZ2luOyBib3JkZXI7IHBhZGRpbmcKICAgICAgICAgIG1hcmdpbkRpdi5zdHlsZS5jc3NUZXh0ID0gZGl2LnN0eWxlLmNzc1RleHQgPSAvLyBTdXBwb3J0OiBGaXJlZm94PDI5LCBBbmRyb2lkIDIuMwogICAgICAgICAgLy8gVmVuZG9yLXByZWZpeCBib3gtc2l6aW5nCiAgICAgICAgICAnLXdlYmtpdC1ib3gtc2l6aW5nOmNvbnRlbnQtYm94Oy1tb3otYm94LXNpemluZzpjb250ZW50LWJveDsnICsgJ2JveC1zaXppbmc6Y29udGVudC1ib3g7ZGlzcGxheTpibG9jazttYXJnaW46MDtib3JkZXI6MDtwYWRkaW5nOjAnOwogICAgICAgICAgbWFyZ2luRGl2LnN0eWxlLm1hcmdpblJpZ2h0ID0gbWFyZ2luRGl2LnN0eWxlLndpZHRoID0gJzAnOwogICAgICAgICAgZGl2LnN0eWxlLndpZHRoID0gJzFweCc7CiAgICAgICAgICBkb2NFbGVtLmFwcGVuZENoaWxkKGNvbnRhaW5lcik7CiAgICAgICAgICByZXQgPSAhcGFyc2VGbG9hdCh3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZShtYXJnaW5EaXYsIG51bGwpLm1hcmdpblJpZ2h0KTsKICAgICAgICAgIGRvY0VsZW0ucmVtb3ZlQ2hpbGQoY29udGFpbmVyKTsKICAgICAgICAgIHJldHVybiByZXQ7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICB9KCkpOwogIC8vIEEgbWV0aG9kIGZvciBxdWlja2x5IHN3YXBwaW5nIGluL291dCBDU1MgcHJvcGVydGllcyB0byBnZXQgY29ycmVjdCBjYWxjdWxhdGlvbnMuCiAgalF1ZXJ5LnN3YXAgPSBmdW5jdGlvbiAoZWxlbSwgb3B0aW9ucywgY2FsbGJhY2ssIGFyZ3MpIHsKICAgIHZhciByZXQsIG5hbWUsIG9sZCA9IHt9OwogICAgLy8gUmVtZW1iZXIgdGhlIG9sZCB2YWx1ZXMsIGFuZCBpbnNlcnQgdGhlIG5ldyBvbmVzCiAgICBmb3IgKG5hbWUgaW4gb3B0aW9ucykgewogICAgICBvbGRbbmFtZV0gPSBlbGVtLnN0eWxlW25hbWVdOwogICAgICBlbGVtLnN0eWxlW25hbWVdID0gb3B0aW9uc1tuYW1lXTsKICAgIH0KICAgIHJldCA9IGNhbGxiYWNrLmFwcGx5KGVsZW0sIGFyZ3MgfHwgW10pOwogICAgLy8gUmV2ZXJ0IHRoZSBvbGQgdmFsdWVzCiAgICBmb3IgKG5hbWUgaW4gb3B0aW9ucykgewogICAgICBlbGVtLnN0eWxlW25hbWVdID0gb2xkW25hbWVdOwogICAgfQogICAgcmV0dXJuIHJldDsKICB9OwogIHZhcgogICAgLy8gc3dhcHBhYmxlIGlmIGRpc3BsYXkgaXMgbm9uZSBvciBzdGFydHMgd2l0aCB0YWJsZSBleGNlcHQgInRhYmxlIiwgInRhYmxlLWNlbGwiLCBvciAidGFibGUtY2FwdGlvbiIKICAgIC8vIHNlZSBoZXJlIGZvciBkaXNwbGF5IHZhbHVlczogaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9DU1MvZGlzcGxheQogICAgcmRpc3BsYXlzd2FwID0gL14obm9uZXx0YWJsZSg/IS1jW2VhXSkuKykvLCBybnVtc3BsaXQgPSBuZXcgUmVnRXhwKCdeKCcgKyBwbnVtICsgJykoLiopJCcsICdpJyksIHJyZWxOdW0gPSBuZXcgUmVnRXhwKCdeKFsrLV0pPSgnICsgcG51bSArICcpJywgJ2knKSwgY3NzU2hvdyA9IHsKICAgICAgcG9zaXRpb246ICdhYnNvbHV0ZScsCiAgICAgIHZpc2liaWxpdHk6ICdoaWRkZW4nLAogICAgICBkaXNwbGF5OiAnYmxvY2snCiAgICB9LCBjc3NOb3JtYWxUcmFuc2Zvcm0gPSB7CiAgICAgIGxldHRlclNwYWNpbmc6ICcwJywKICAgICAgZm9udFdlaWdodDogJzQwMCcKICAgIH0sIGNzc1ByZWZpeGVzID0gWwogICAgICAnV2Via2l0JywKICAgICAgJ08nLAogICAgICAnTW96JywKICAgICAgJ21zJwogICAgXTsKICAvLyByZXR1cm4gYSBjc3MgcHJvcGVydHkgbWFwcGVkIHRvIGEgcG90ZW50aWFsbHkgdmVuZG9yIHByZWZpeGVkIHByb3BlcnR5CiAgZnVuY3Rpb24gdmVuZG9yUHJvcE5hbWUoc3R5bGUsIG5hbWUpIHsKICAgIC8vIHNob3J0Y3V0IGZvciBuYW1lcyB0aGF0IGFyZSBub3QgdmVuZG9yIHByZWZpeGVkCiAgICBpZiAobmFtZSBpbiBzdHlsZSkgewogICAgICByZXR1cm4gbmFtZTsKICAgIH0KICAgIC8vIGNoZWNrIGZvciB2ZW5kb3IgcHJlZml4ZWQgbmFtZXMKICAgIHZhciBjYXBOYW1lID0gbmFtZVswXS50b1VwcGVyQ2FzZSgpICsgbmFtZS5zbGljZSgxKSwgb3JpZ05hbWUgPSBuYW1lLCBpID0gY3NzUHJlZml4ZXMubGVuZ3RoOwogICAgd2hpbGUgKGktLSkgewogICAgICBuYW1lID0gY3NzUHJlZml4ZXNbaV0gKyBjYXBOYW1lOwogICAgICBpZiAobmFtZSBpbiBzdHlsZSkgewogICAgICAgIHJldHVybiBuYW1lOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gb3JpZ05hbWU7CiAgfQogIGZ1bmN0aW9uIHNldFBvc2l0aXZlTnVtYmVyKGVsZW0sIHZhbHVlLCBzdWJ0cmFjdCkgewogICAgdmFyIG1hdGNoZXMgPSBybnVtc3BsaXQuZXhlYyh2YWx1ZSk7CiAgICByZXR1cm4gbWF0Y2hlcyA/IC8vIEd1YXJkIGFnYWluc3QgdW5kZWZpbmVkICJzdWJ0cmFjdCIsIGUuZy4sIHdoZW4gdXNlZCBhcyBpbiBjc3NIb29rcwogICAgTWF0aC5tYXgoMCwgbWF0Y2hlc1sxXSAtIChzdWJ0cmFjdCB8fCAwKSkgKyAobWF0Y2hlc1syXSB8fCAncHgnKSA6IHZhbHVlOwogIH0KICBmdW5jdGlvbiBhdWdtZW50V2lkdGhPckhlaWdodChlbGVtLCBuYW1lLCBleHRyYSwgaXNCb3JkZXJCb3gsIHN0eWxlcykgewogICAgdmFyIGkgPSBleHRyYSA9PT0gKGlzQm9yZGVyQm94ID8gJ2JvcmRlcicgOiAnY29udGVudCcpID8gLy8gSWYgd2UgYWxyZWFkeSBoYXZlIHRoZSByaWdodCBtZWFzdXJlbWVudCwgYXZvaWQgYXVnbWVudGF0aW9uCiAgICAgIDQgOiAvLyBPdGhlcndpc2UgaW5pdGlhbGl6ZSBmb3IgaG9yaXpvbnRhbCBvciB2ZXJ0aWNhbCBwcm9wZXJ0aWVzCiAgICAgIG5hbWUgPT09ICd3aWR0aCcgPyAxIDogMCwgdmFsID0gMDsKICAgIGZvciAoOyBpIDwgNDsgaSArPSAyKSB7CiAgICAgIC8vIGJvdGggYm94IG1vZGVscyBleGNsdWRlIG1hcmdpbiwgc28gYWRkIGl0IGlmIHdlIHdhbnQgaXQKICAgICAgaWYgKGV4dHJhID09PSAnbWFyZ2luJykgewogICAgICAgIHZhbCArPSBqUXVlcnkuY3NzKGVsZW0sIGV4dHJhICsgY3NzRXhwYW5kW2ldLCB0cnVlLCBzdHlsZXMpOwogICAgICB9CiAgICAgIGlmIChpc0JvcmRlckJveCkgewogICAgICAgIC8vIGJvcmRlci1ib3ggaW5jbHVkZXMgcGFkZGluZywgc28gcmVtb3ZlIGl0IGlmIHdlIHdhbnQgY29udGVudAogICAgICAgIGlmIChleHRyYSA9PT0gJ2NvbnRlbnQnKSB7CiAgICAgICAgICB2YWwgLT0galF1ZXJ5LmNzcyhlbGVtLCAncGFkZGluZycgKyBjc3NFeHBhbmRbaV0sIHRydWUsIHN0eWxlcyk7CiAgICAgICAgfQogICAgICAgIC8vIGF0IHRoaXMgcG9pbnQsIGV4dHJhIGlzbid0IGJvcmRlciBub3IgbWFyZ2luLCBzbyByZW1vdmUgYm9yZGVyCiAgICAgICAgaWYgKGV4dHJhICE9PSAnbWFyZ2luJykgewogICAgICAgICAgdmFsIC09IGpRdWVyeS5jc3MoZWxlbSwgJ2JvcmRlcicgKyBjc3NFeHBhbmRbaV0gKyAnV2lkdGgnLCB0cnVlLCBzdHlsZXMpOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBhdCB0aGlzIHBvaW50LCBleHRyYSBpc24ndCBjb250ZW50LCBzbyBhZGQgcGFkZGluZwogICAgICAgIHZhbCArPSBqUXVlcnkuY3NzKGVsZW0sICdwYWRkaW5nJyArIGNzc0V4cGFuZFtpXSwgdHJ1ZSwgc3R5bGVzKTsKICAgICAgICAvLyBhdCB0aGlzIHBvaW50LCBleHRyYSBpc24ndCBjb250ZW50IG5vciBwYWRkaW5nLCBzbyBhZGQgYm9yZGVyCiAgICAgICAgaWYgKGV4dHJhICE9PSAncGFkZGluZycpIHsKICAgICAgICAgIHZhbCArPSBqUXVlcnkuY3NzKGVsZW0sICdib3JkZXInICsgY3NzRXhwYW5kW2ldICsgJ1dpZHRoJywgdHJ1ZSwgc3R5bGVzKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIHJldHVybiB2YWw7CiAgfQogIGZ1bmN0aW9uIGdldFdpZHRoT3JIZWlnaHQoZWxlbSwgbmFtZSwgZXh0cmEpIHsKICAgIC8vIFN0YXJ0IHdpdGggb2Zmc2V0IHByb3BlcnR5LCB3aGljaCBpcyBlcXVpdmFsZW50IHRvIHRoZSBib3JkZXItYm94IHZhbHVlCiAgICB2YXIgdmFsdWVJc0JvcmRlckJveCA9IHRydWUsIHZhbCA9IG5hbWUgPT09ICd3aWR0aCcgPyBlbGVtLm9mZnNldFdpZHRoIDogZWxlbS5vZmZzZXRIZWlnaHQsIHN0eWxlcyA9IGdldFN0eWxlcyhlbGVtKSwgaXNCb3JkZXJCb3ggPSBqUXVlcnkuY3NzKGVsZW0sICdib3hTaXppbmcnLCBmYWxzZSwgc3R5bGVzKSA9PT0gJ2JvcmRlci1ib3gnOwogICAgLy8gc29tZSBub24taHRtbCBlbGVtZW50cyByZXR1cm4gdW5kZWZpbmVkIGZvciBvZmZzZXRXaWR0aCwgc28gY2hlY2sgZm9yIG51bGwvdW5kZWZpbmVkCiAgICAvLyBzdmcgLSBodHRwczovL2J1Z3ppbGxhLm1vemlsbGEub3JnL3Nob3dfYnVnLmNnaT9pZD02NDkyODUKICAgIC8vIE1hdGhNTCAtIGh0dHBzOi8vYnVnemlsbGEubW96aWxsYS5vcmcvc2hvd19idWcuY2dpP2lkPTQ5MTY2OAogICAgaWYgKHZhbCA8PSAwIHx8IHZhbCA9PSBudWxsKSB7CiAgICAgIC8vIEZhbGwgYmFjayB0byBjb21wdXRlZCB0aGVuIHVuY29tcHV0ZWQgY3NzIGlmIG5lY2Vzc2FyeQogICAgICB2YWwgPSBjdXJDU1MoZWxlbSwgbmFtZSwgc3R5bGVzKTsKICAgICAgaWYgKHZhbCA8IDAgfHwgdmFsID09IG51bGwpIHsKICAgICAgICB2YWwgPSBlbGVtLnN0eWxlW25hbWVdOwogICAgICB9CiAgICAgIC8vIENvbXB1dGVkIHVuaXQgaXMgbm90IHBpeGVscy4gU3RvcCBoZXJlIGFuZCByZXR1cm4uCiAgICAgIGlmIChybnVtbm9ucHgudGVzdCh2YWwpKSB7CiAgICAgICAgcmV0dXJuIHZhbDsKICAgICAgfQogICAgICAvLyB3ZSBuZWVkIHRoZSBjaGVjayBmb3Igc3R5bGUgaW4gY2FzZSBhIGJyb3dzZXIgd2hpY2ggcmV0dXJucyB1bnJlbGlhYmxlIHZhbHVlcwogICAgICAvLyBmb3IgZ2V0Q29tcHV0ZWRTdHlsZSBzaWxlbnRseSBmYWxscyBiYWNrIHRvIHRoZSByZWxpYWJsZSBlbGVtLnN0eWxlCiAgICAgIHZhbHVlSXNCb3JkZXJCb3ggPSBpc0JvcmRlckJveCAmJiAoc3VwcG9ydC5ib3hTaXppbmdSZWxpYWJsZSgpIHx8IHZhbCA9PT0gZWxlbS5zdHlsZVtuYW1lXSk7CiAgICAgIC8vIE5vcm1hbGl6ZSAiIiwgYXV0bywgYW5kIHByZXBhcmUgZm9yIGV4dHJhCiAgICAgIHZhbCA9IHBhcnNlRmxvYXQodmFsKSB8fCAwOwogICAgfQogICAgLy8gdXNlIHRoZSBhY3RpdmUgYm94LXNpemluZyBtb2RlbCB0byBhZGQvc3VidHJhY3QgaXJyZWxldmFudCBzdHlsZXMKICAgIHJldHVybiB2YWwgKyBhdWdtZW50V2lkdGhPckhlaWdodChlbGVtLCBuYW1lLCBleHRyYSB8fCAoaXNCb3JkZXJCb3ggPyAnYm9yZGVyJyA6ICdjb250ZW50JyksIHZhbHVlSXNCb3JkZXJCb3gsIHN0eWxlcykgKyAncHgnOwogIH0KICBmdW5jdGlvbiBzaG93SGlkZShlbGVtZW50cywgc2hvdykgewogICAgdmFyIGRpc3BsYXksIGVsZW0sIGhpZGRlbiwgdmFsdWVzID0gW10sIGluZGV4ID0gMCwgbGVuZ3RoID0gZWxlbWVudHMubGVuZ3RoOwogICAgZm9yICg7IGluZGV4IDwgbGVuZ3RoOyBpbmRleCsrKSB7CiAgICAgIGVsZW0gPSBlbGVtZW50c1tpbmRleF07CiAgICAgIGlmICghZWxlbS5zdHlsZSkgewogICAgICAgIGNvbnRpbnVlOwogICAgICB9CiAgICAgIHZhbHVlc1tpbmRleF0gPSBkYXRhX3ByaXYuZ2V0KGVsZW0sICdvbGRkaXNwbGF5Jyk7CiAgICAgIGRpc3BsYXkgPSBlbGVtLnN0eWxlLmRpc3BsYXk7CiAgICAgIGlmIChzaG93KSB7CiAgICAgICAgLy8gUmVzZXQgdGhlIGlubGluZSBkaXNwbGF5IG9mIHRoaXMgZWxlbWVudCB0byBsZWFybiBpZiBpdCBpcwogICAgICAgIC8vIGJlaW5nIGhpZGRlbiBieSBjYXNjYWRlZCBydWxlcyBvciBub3QKICAgICAgICBpZiAoIXZhbHVlc1tpbmRleF0gJiYgZGlzcGxheSA9PT0gJ25vbmUnKSB7CiAgICAgICAgICBlbGVtLnN0eWxlLmRpc3BsYXkgPSAnJzsKICAgICAgICB9CiAgICAgICAgLy8gU2V0IGVsZW1lbnRzIHdoaWNoIGhhdmUgYmVlbiBvdmVycmlkZGVuIHdpdGggZGlzcGxheTogbm9uZQogICAgICAgIC8vIGluIGEgc3R5bGVzaGVldCB0byB3aGF0ZXZlciB0aGUgZGVmYXVsdCBicm93c2VyIHN0eWxlIGlzCiAgICAgICAgLy8gZm9yIHN1Y2ggYW4gZWxlbWVudAogICAgICAgIGlmIChlbGVtLnN0eWxlLmRpc3BsYXkgPT09ICcnICYmIGlzSGlkZGVuKGVsZW0pKSB7CiAgICAgICAgICB2YWx1ZXNbaW5kZXhdID0gZGF0YV9wcml2LmFjY2VzcyhlbGVtLCAnb2xkZGlzcGxheScsIGRlZmF1bHREaXNwbGF5KGVsZW0ubm9kZU5hbWUpKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaGlkZGVuID0gaXNIaWRkZW4oZWxlbSk7CiAgICAgICAgaWYgKGRpc3BsYXkgIT09ICdub25lJyB8fCAhaGlkZGVuKSB7CiAgICAgICAgICBkYXRhX3ByaXYuc2V0KGVsZW0sICdvbGRkaXNwbGF5JywgaGlkZGVuID8gZGlzcGxheSA6IGpRdWVyeS5jc3MoZWxlbSwgJ2Rpc3BsYXknKSk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICAvLyBTZXQgdGhlIGRpc3BsYXkgb2YgbW9zdCBvZiB0aGUgZWxlbWVudHMgaW4gYSBzZWNvbmQgbG9vcAogICAgLy8gdG8gYXZvaWQgdGhlIGNvbnN0YW50IHJlZmxvdwogICAgZm9yIChpbmRleCA9IDA7IGluZGV4IDwgbGVuZ3RoOyBpbmRleCsrKSB7CiAgICAgIGVsZW0gPSBlbGVtZW50c1tpbmRleF07CiAgICAgIGlmICghZWxlbS5zdHlsZSkgewogICAgICAgIGNvbnRpbnVlOwogICAgICB9CiAgICAgIGlmICghc2hvdyB8fCBlbGVtLnN0eWxlLmRpc3BsYXkgPT09ICdub25lJyB8fCBlbGVtLnN0eWxlLmRpc3BsYXkgPT09ICcnKSB7CiAgICAgICAgZWxlbS5zdHlsZS5kaXNwbGF5ID0gc2hvdyA/IHZhbHVlc1tpbmRleF0gfHwgJycgOiAnbm9uZSc7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBlbGVtZW50czsKICB9CiAgalF1ZXJ5LmV4dGVuZCh7CiAgICAvLyBBZGQgaW4gc3R5bGUgcHJvcGVydHkgaG9va3MgZm9yIG92ZXJyaWRpbmcgdGhlIGRlZmF1bHQKICAgIC8vIGJlaGF2aW9yIG9mIGdldHRpbmcgYW5kIHNldHRpbmcgYSBzdHlsZSBwcm9wZXJ0eQogICAgY3NzSG9va3M6IHsKICAgICAgb3BhY2l0eTogewogICAgICAgIGdldDogZnVuY3Rpb24gKGVsZW0sIGNvbXB1dGVkKSB7CiAgICAgICAgICBpZiAoY29tcHV0ZWQpIHsKICAgICAgICAgICAgLy8gV2Ugc2hvdWxkIGFsd2F5cyBnZXQgYSBudW1iZXIgYmFjayBmcm9tIG9wYWNpdHkKICAgICAgICAgICAgdmFyIHJldCA9IGN1ckNTUyhlbGVtLCAnb3BhY2l0eScpOwogICAgICAgICAgICByZXR1cm4gcmV0ID09PSAnJyA/ICcxJyA6IHJldDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICAvLyBEb24ndCBhdXRvbWF0aWNhbGx5IGFkZCAicHgiIHRvIHRoZXNlIHBvc3NpYmx5LXVuaXRsZXNzIHByb3BlcnRpZXMKICAgIGNzc051bWJlcjogewogICAgICAnY29sdW1uQ291bnQnOiB0cnVlLAogICAgICAnZmlsbE9wYWNpdHknOiB0cnVlLAogICAgICAnZmxleEdyb3cnOiB0cnVlLAogICAgICAnZmxleFNocmluayc6IHRydWUsCiAgICAgICdmb250V2VpZ2h0JzogdHJ1ZSwKICAgICAgJ2xpbmVIZWlnaHQnOiB0cnVlLAogICAgICAnb3BhY2l0eSc6IHRydWUsCiAgICAgICdvcmRlcic6IHRydWUsCiAgICAgICdvcnBoYW5zJzogdHJ1ZSwKICAgICAgJ3dpZG93cyc6IHRydWUsCiAgICAgICd6SW5kZXgnOiB0cnVlLAogICAgICAnem9vbSc6IHRydWUKICAgIH0sCiAgICAvLyBBZGQgaW4gcHJvcGVydGllcyB3aG9zZSBuYW1lcyB5b3Ugd2lzaCB0byBmaXggYmVmb3JlCiAgICAvLyBzZXR0aW5nIG9yIGdldHRpbmcgdGhlIHZhbHVlCiAgICBjc3NQcm9wczogewogICAgICAvLyBub3JtYWxpemUgZmxvYXQgY3NzIHByb3BlcnR5CiAgICAgICdmbG9hdCc6ICdjc3NGbG9hdCcKICAgIH0sCiAgICAvLyBHZXQgYW5kIHNldCB0aGUgc3R5bGUgcHJvcGVydHkgb24gYSBET00gTm9kZQogICAgc3R5bGU6IGZ1bmN0aW9uIChlbGVtLCBuYW1lLCB2YWx1ZSwgZXh0cmEpIHsKICAgICAgLy8gRG9uJ3Qgc2V0IHN0eWxlcyBvbiB0ZXh0IGFuZCBjb21tZW50IG5vZGVzCiAgICAgIGlmICghZWxlbSB8fCBlbGVtLm5vZGVUeXBlID09PSAzIHx8IGVsZW0ubm9kZVR5cGUgPT09IDggfHwgIWVsZW0uc3R5bGUpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgLy8gTWFrZSBzdXJlIHRoYXQgd2UncmUgd29ya2luZyB3aXRoIHRoZSByaWdodCBuYW1lCiAgICAgIHZhciByZXQsIHR5cGUsIGhvb2tzLCBvcmlnTmFtZSA9IGpRdWVyeS5jYW1lbENhc2UobmFtZSksIHN0eWxlID0gZWxlbS5zdHlsZTsKICAgICAgbmFtZSA9IGpRdWVyeS5jc3NQcm9wc1tvcmlnTmFtZV0gfHwgKGpRdWVyeS5jc3NQcm9wc1tvcmlnTmFtZV0gPSB2ZW5kb3JQcm9wTmFtZShzdHlsZSwgb3JpZ05hbWUpKTsKICAgICAgLy8gZ2V0cyBob29rIGZvciB0aGUgcHJlZml4ZWQgdmVyc2lvbgogICAgICAvLyBmb2xsb3dlZCBieSB0aGUgdW5wcmVmaXhlZCB2ZXJzaW9uCiAgICAgIGhvb2tzID0galF1ZXJ5LmNzc0hvb2tzW25hbWVdIHx8IGpRdWVyeS5jc3NIb29rc1tvcmlnTmFtZV07CiAgICAgIC8vIENoZWNrIGlmIHdlJ3JlIHNldHRpbmcgYSB2YWx1ZQogICAgICBpZiAodmFsdWUgIT09IHVuZGVmaW5lZCkgewogICAgICAgIHR5cGUgPSB0eXBlb2YgdmFsdWU7CiAgICAgICAgLy8gY29udmVydCByZWxhdGl2ZSBudW1iZXIgc3RyaW5ncyAoKz0gb3IgLT0pIHRvIHJlbGF0aXZlIG51bWJlcnMuICM3MzQ1CiAgICAgICAgaWYgKHR5cGUgPT09ICdzdHJpbmcnICYmIChyZXQgPSBycmVsTnVtLmV4ZWModmFsdWUpKSkgewogICAgICAgICAgdmFsdWUgPSAocmV0WzFdICsgMSkgKiByZXRbMl0gKyBwYXJzZUZsb2F0KGpRdWVyeS5jc3MoZWxlbSwgbmFtZSkpOwogICAgICAgICAgLy8gRml4ZXMgYnVnICM5MjM3CiAgICAgICAgICB0eXBlID0gJ251bWJlcic7CiAgICAgICAgfQogICAgICAgIC8vIE1ha2Ugc3VyZSB0aGF0IG51bGwgYW5kIE5hTiB2YWx1ZXMgYXJlbid0IHNldC4gU2VlOiAjNzExNgogICAgICAgIGlmICh2YWx1ZSA9PSBudWxsIHx8IHZhbHVlICE9PSB2YWx1ZSkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICAvLyBJZiBhIG51bWJlciB3YXMgcGFzc2VkIGluLCBhZGQgJ3B4JyB0byB0aGUgKGV4Y2VwdCBmb3IgY2VydGFpbiBDU1MgcHJvcGVydGllcykKICAgICAgICBpZiAodHlwZSA9PT0gJ251bWJlcicgJiYgIWpRdWVyeS5jc3NOdW1iZXJbb3JpZ05hbWVdKSB7CiAgICAgICAgICB2YWx1ZSArPSAncHgnOwogICAgICAgIH0KICAgICAgICAvLyBGaXhlcyAjODkwOCwgaXQgY2FuIGJlIGRvbmUgbW9yZSBjb3JyZWN0bHkgYnkgc3BlY2lmeWluZyBzZXR0ZXJzIGluIGNzc0hvb2tzLAogICAgICAgIC8vIGJ1dCBpdCB3b3VsZCBtZWFuIHRvIGRlZmluZSBlaWdodCAoZm9yIGV2ZXJ5IHByb2JsZW1hdGljIHByb3BlcnR5KSBpZGVudGljYWwgZnVuY3Rpb25zCiAgICAgICAgaWYgKCFzdXBwb3J0LmNsZWFyQ2xvbmVTdHlsZSAmJiB2YWx1ZSA9PT0gJycgJiYgbmFtZS5pbmRleE9mKCdiYWNrZ3JvdW5kJykgPT09IDApIHsKICAgICAgICAgIHN0eWxlW25hbWVdID0gJ2luaGVyaXQnOwogICAgICAgIH0KICAgICAgICAvLyBJZiBhIGhvb2sgd2FzIHByb3ZpZGVkLCB1c2UgdGhhdCB2YWx1ZSwgb3RoZXJ3aXNlIGp1c3Qgc2V0IHRoZSBzcGVjaWZpZWQgdmFsdWUKICAgICAgICBpZiAoIWhvb2tzIHx8ICEoJ3NldCcgaW4gaG9va3MpIHx8ICh2YWx1ZSA9IGhvb2tzLnNldChlbGVtLCB2YWx1ZSwgZXh0cmEpKSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICBzdHlsZVtuYW1lXSA9IHZhbHVlOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBJZiBhIGhvb2sgd2FzIHByb3ZpZGVkIGdldCB0aGUgbm9uLWNvbXB1dGVkIHZhbHVlIGZyb20gdGhlcmUKICAgICAgICBpZiAoaG9va3MgJiYgJ2dldCcgaW4gaG9va3MgJiYgKHJldCA9IGhvb2tzLmdldChlbGVtLCBmYWxzZSwgZXh0cmEpKSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICByZXR1cm4gcmV0OwogICAgICAgIH0KICAgICAgICAvLyBPdGhlcndpc2UganVzdCBnZXQgdGhlIHZhbHVlIGZyb20gdGhlIHN0eWxlIG9iamVjdAogICAgICAgIHJldHVybiBzdHlsZVtuYW1lXTsKICAgICAgfQogICAgfSwKICAgIGNzczogZnVuY3Rpb24gKGVsZW0sIG5hbWUsIGV4dHJhLCBzdHlsZXMpIHsKICAgICAgdmFyIHZhbCwgbnVtLCBob29rcywgb3JpZ05hbWUgPSBqUXVlcnkuY2FtZWxDYXNlKG5hbWUpOwogICAgICAvLyBNYWtlIHN1cmUgdGhhdCB3ZSdyZSB3b3JraW5nIHdpdGggdGhlIHJpZ2h0IG5hbWUKICAgICAgbmFtZSA9IGpRdWVyeS5jc3NQcm9wc1tvcmlnTmFtZV0gfHwgKGpRdWVyeS5jc3NQcm9wc1tvcmlnTmFtZV0gPSB2ZW5kb3JQcm9wTmFtZShlbGVtLnN0eWxlLCBvcmlnTmFtZSkpOwogICAgICAvLyBnZXRzIGhvb2sgZm9yIHRoZSBwcmVmaXhlZCB2ZXJzaW9uCiAgICAgIC8vIGZvbGxvd2VkIGJ5IHRoZSB1bnByZWZpeGVkIHZlcnNpb24KICAgICAgaG9va3MgPSBqUXVlcnkuY3NzSG9va3NbbmFtZV0gfHwgalF1ZXJ5LmNzc0hvb2tzW29yaWdOYW1lXTsKICAgICAgLy8gSWYgYSBob29rIHdhcyBwcm92aWRlZCBnZXQgdGhlIGNvbXB1dGVkIHZhbHVlIGZyb20gdGhlcmUKICAgICAgaWYgKGhvb2tzICYmICdnZXQnIGluIGhvb2tzKSB7CiAgICAgICAgdmFsID0gaG9va3MuZ2V0KGVsZW0sIHRydWUsIGV4dHJhKTsKICAgICAgfQogICAgICAvLyBPdGhlcndpc2UsIGlmIGEgd2F5IHRvIGdldCB0aGUgY29tcHV0ZWQgdmFsdWUgZXhpc3RzLCB1c2UgdGhhdAogICAgICBpZiAodmFsID09PSB1bmRlZmluZWQpIHsKICAgICAgICB2YWwgPSBjdXJDU1MoZWxlbSwgbmFtZSwgc3R5bGVzKTsKICAgICAgfQogICAgICAvL2NvbnZlcnQgIm5vcm1hbCIgdG8gY29tcHV0ZWQgdmFsdWUKICAgICAgaWYgKHZhbCA9PT0gJ25vcm1hbCcgJiYgbmFtZSBpbiBjc3NOb3JtYWxUcmFuc2Zvcm0pIHsKICAgICAgICB2YWwgPSBjc3NOb3JtYWxUcmFuc2Zvcm1bbmFtZV07CiAgICAgIH0KICAgICAgLy8gUmV0dXJuLCBjb252ZXJ0aW5nIHRvIG51bWJlciBpZiBmb3JjZWQgb3IgYSBxdWFsaWZpZXIgd2FzIHByb3ZpZGVkIGFuZCB2YWwgbG9va3MgbnVtZXJpYwogICAgICBpZiAoZXh0cmEgPT09ICcnIHx8IGV4dHJhKSB7CiAgICAgICAgbnVtID0gcGFyc2VGbG9hdCh2YWwpOwogICAgICAgIHJldHVybiBleHRyYSA9PT0gdHJ1ZSB8fCBqUXVlcnkuaXNOdW1lcmljKG51bSkgPyBudW0gfHwgMCA6IHZhbDsKICAgICAgfQogICAgICByZXR1cm4gdmFsOwogICAgfQogIH0pOwogIGpRdWVyeS5lYWNoKFsKICAgICdoZWlnaHQnLAogICAgJ3dpZHRoJwogIF0sIGZ1bmN0aW9uIChpLCBuYW1lKSB7CiAgICBqUXVlcnkuY3NzSG9va3NbbmFtZV0gPSB7CiAgICAgIGdldDogZnVuY3Rpb24gKGVsZW0sIGNvbXB1dGVkLCBleHRyYSkgewogICAgICAgIGlmIChjb21wdXRlZCkgewogICAgICAgICAgLy8gY2VydGFpbiBlbGVtZW50cyBjYW4gaGF2ZSBkaW1lbnNpb24gaW5mbyBpZiB3ZSBpbnZpc2libHkgc2hvdyB0aGVtCiAgICAgICAgICAvLyBob3dldmVyLCBpdCBtdXN0IGhhdmUgYSBjdXJyZW50IGRpc3BsYXkgc3R5bGUgdGhhdCB3b3VsZCBiZW5lZml0IGZyb20gdGhpcwogICAgICAgICAgcmV0dXJuIHJkaXNwbGF5c3dhcC50ZXN0KGpRdWVyeS5jc3MoZWxlbSwgJ2Rpc3BsYXknKSkgJiYgZWxlbS5vZmZzZXRXaWR0aCA9PT0gMCA/IGpRdWVyeS5zd2FwKGVsZW0sIGNzc1Nob3csIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIGdldFdpZHRoT3JIZWlnaHQoZWxlbSwgbmFtZSwgZXh0cmEpOwogICAgICAgICAgfSkgOiBnZXRXaWR0aE9ySGVpZ2h0KGVsZW0sIG5hbWUsIGV4dHJhKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIHNldDogZnVuY3Rpb24gKGVsZW0sIHZhbHVlLCBleHRyYSkgewogICAgICAgIHZhciBzdHlsZXMgPSBleHRyYSAmJiBnZXRTdHlsZXMoZWxlbSk7CiAgICAgICAgcmV0dXJuIHNldFBvc2l0aXZlTnVtYmVyKGVsZW0sIHZhbHVlLCBleHRyYSA/IGF1Z21lbnRXaWR0aE9ySGVpZ2h0KGVsZW0sIG5hbWUsIGV4dHJhLCBqUXVlcnkuY3NzKGVsZW0sICdib3hTaXppbmcnLCBmYWxzZSwgc3R5bGVzKSA9PT0gJ2JvcmRlci1ib3gnLCBzdHlsZXMpIDogMCk7CiAgICAgIH0KICAgIH07CiAgfSk7CiAgLy8gU3VwcG9ydDogQW5kcm9pZCAyLjMKICBqUXVlcnkuY3NzSG9va3MubWFyZ2luUmlnaHQgPSBhZGRHZXRIb29rSWYoc3VwcG9ydC5yZWxpYWJsZU1hcmdpblJpZ2h0LCBmdW5jdGlvbiAoZWxlbSwgY29tcHV0ZWQpIHsKICAgIGlmIChjb21wdXRlZCkgewogICAgICAvLyBXZWJLaXQgQnVnIDEzMzQzIC0gZ2V0Q29tcHV0ZWRTdHlsZSByZXR1cm5zIHdyb25nIHZhbHVlIGZvciBtYXJnaW4tcmlnaHQKICAgICAgLy8gV29yayBhcm91bmQgYnkgdGVtcG9yYXJpbHkgc2V0dGluZyBlbGVtZW50IGRpc3BsYXkgdG8gaW5saW5lLWJsb2NrCiAgICAgIHJldHVybiBqUXVlcnkuc3dhcChlbGVtLCB7ICdkaXNwbGF5JzogJ2lubGluZS1ibG9jaycgfSwgY3VyQ1NTLCBbCiAgICAgICAgZWxlbSwKICAgICAgICAnbWFyZ2luUmlnaHQnCiAgICAgIF0pOwogICAgfQogIH0pOwogIC8vIFRoZXNlIGhvb2tzIGFyZSB1c2VkIGJ5IGFuaW1hdGUgdG8gZXhwYW5kIHByb3BlcnRpZXMKICBqUXVlcnkuZWFjaCh7CiAgICBtYXJnaW46ICcnLAogICAgcGFkZGluZzogJycsCiAgICBib3JkZXI6ICdXaWR0aCcKICB9LCBmdW5jdGlvbiAocHJlZml4LCBzdWZmaXgpIHsKICAgIGpRdWVyeS5jc3NIb29rc1twcmVmaXggKyBzdWZmaXhdID0gewogICAgICBleHBhbmQ6IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgIHZhciBpID0gMCwgZXhwYW5kZWQgPSB7fSwKICAgICAgICAgIC8vIGFzc3VtZXMgYSBzaW5nbGUgbnVtYmVyIGlmIG5vdCBhIHN0cmluZwogICAgICAgICAgcGFydHMgPSB0eXBlb2YgdmFsdWUgPT09ICdzdHJpbmcnID8gdmFsdWUuc3BsaXQoJyAnKSA6IFt2YWx1ZV07CiAgICAgICAgZm9yICg7IGkgPCA0OyBpKyspIHsKICAgICAgICAgIGV4cGFuZGVkW3ByZWZpeCArIGNzc0V4cGFuZFtpXSArIHN1ZmZpeF0gPSBwYXJ0c1tpXSB8fCBwYXJ0c1tpIC0gMl0gfHwgcGFydHNbMF07CiAgICAgICAgfQogICAgICAgIHJldHVybiBleHBhbmRlZDsKICAgICAgfQogICAgfTsKICAgIGlmICghcm1hcmdpbi50ZXN0KHByZWZpeCkpIHsKICAgICAgalF1ZXJ5LmNzc0hvb2tzW3ByZWZpeCArIHN1ZmZpeF0uc2V0ID0gc2V0UG9zaXRpdmVOdW1iZXI7CiAgICB9CiAgfSk7CiAgalF1ZXJ5LmZuLmV4dGVuZCh7CiAgICBjc3M6IGZ1bmN0aW9uIChuYW1lLCB2YWx1ZSkgewogICAgICByZXR1cm4gYWNjZXNzKHRoaXMsIGZ1bmN0aW9uIChlbGVtLCBuYW1lLCB2YWx1ZSkgewogICAgICAgIHZhciBzdHlsZXMsIGxlbiwgbWFwID0ge30sIGkgPSAwOwogICAgICAgIGlmIChqUXVlcnkuaXNBcnJheShuYW1lKSkgewogICAgICAgICAgc3R5bGVzID0gZ2V0U3R5bGVzKGVsZW0pOwogICAgICAgICAgbGVuID0gbmFtZS5sZW5ndGg7CiAgICAgICAgICBmb3IgKDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgICAgIG1hcFtuYW1lW2ldXSA9IGpRdWVyeS5jc3MoZWxlbSwgbmFtZVtpXSwgZmFsc2UsIHN0eWxlcyk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbWFwOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdmFsdWUgIT09IHVuZGVmaW5lZCA/IGpRdWVyeS5zdHlsZShlbGVtLCBuYW1lLCB2YWx1ZSkgOiBqUXVlcnkuY3NzKGVsZW0sIG5hbWUpOwogICAgICB9LCBuYW1lLCB2YWx1ZSwgYXJndW1lbnRzLmxlbmd0aCA+IDEpOwogICAgfSwKICAgIHNob3c6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIHNob3dIaWRlKHRoaXMsIHRydWUpOwogICAgfSwKICAgIGhpZGU6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIHNob3dIaWRlKHRoaXMpOwogICAgfSwKICAgIHRvZ2dsZTogZnVuY3Rpb24gKHN0YXRlKSB7CiAgICAgIGlmICh0eXBlb2Ygc3RhdGUgPT09ICdib29sZWFuJykgewogICAgICAgIHJldHVybiBzdGF0ZSA/IHRoaXMuc2hvdygpIDogdGhpcy5oaWRlKCk7CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgaWYgKGlzSGlkZGVuKHRoaXMpKSB7CiAgICAgICAgICBqUXVlcnkodGhpcykuc2hvdygpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBqUXVlcnkodGhpcykuaGlkZSgpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgfSk7CiAgZnVuY3Rpb24gVHdlZW4oZWxlbSwgb3B0aW9ucywgcHJvcCwgZW5kLCBlYXNpbmcpIHsKICAgIHJldHVybiBuZXcgVHdlZW4ucHJvdG90eXBlLmluaXQoZWxlbSwgb3B0aW9ucywgcHJvcCwgZW5kLCBlYXNpbmcpOwogIH0KICBqUXVlcnkuVHdlZW4gPSBUd2VlbjsKICBUd2Vlbi5wcm90b3R5cGUgPSB7CiAgICBjb25zdHJ1Y3RvcjogVHdlZW4sCiAgICBpbml0OiBmdW5jdGlvbiAoZWxlbSwgb3B0aW9ucywgcHJvcCwgZW5kLCBlYXNpbmcsIHVuaXQpIHsKICAgICAgdGhpcy5lbGVtID0gZWxlbTsKICAgICAgdGhpcy5wcm9wID0gcHJvcDsKICAgICAgdGhpcy5lYXNpbmcgPSBlYXNpbmcgfHwgJ3N3aW5nJzsKICAgICAgdGhpcy5vcHRpb25zID0gb3B0aW9uczsKICAgICAgdGhpcy5zdGFydCA9IHRoaXMubm93ID0gdGhpcy5jdXIoKTsKICAgICAgdGhpcy5lbmQgPSBlbmQ7CiAgICAgIHRoaXMudW5pdCA9IHVuaXQgfHwgKGpRdWVyeS5jc3NOdW1iZXJbcHJvcF0gPyAnJyA6ICdweCcpOwogICAgfSwKICAgIGN1cjogZnVuY3Rpb24gKCkgewogICAgICB2YXIgaG9va3MgPSBUd2Vlbi5wcm9wSG9va3NbdGhpcy5wcm9wXTsKICAgICAgcmV0dXJuIGhvb2tzICYmIGhvb2tzLmdldCA/IGhvb2tzLmdldCh0aGlzKSA6IFR3ZWVuLnByb3BIb29rcy5fZGVmYXVsdC5nZXQodGhpcyk7CiAgICB9LAogICAgcnVuOiBmdW5jdGlvbiAocGVyY2VudCkgewogICAgICB2YXIgZWFzZWQsIGhvb2tzID0gVHdlZW4ucHJvcEhvb2tzW3RoaXMucHJvcF07CiAgICAgIGlmICh0aGlzLm9wdGlvbnMuZHVyYXRpb24pIHsKICAgICAgICB0aGlzLnBvcyA9IGVhc2VkID0galF1ZXJ5LmVhc2luZ1t0aGlzLmVhc2luZ10ocGVyY2VudCwgdGhpcy5vcHRpb25zLmR1cmF0aW9uICogcGVyY2VudCwgMCwgMSwgdGhpcy5vcHRpb25zLmR1cmF0aW9uKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLnBvcyA9IGVhc2VkID0gcGVyY2VudDsKICAgICAgfQogICAgICB0aGlzLm5vdyA9ICh0aGlzLmVuZCAtIHRoaXMuc3RhcnQpICogZWFzZWQgKyB0aGlzLnN0YXJ0OwogICAgICBpZiAodGhpcy5vcHRpb25zLnN0ZXApIHsKICAgICAgICB0aGlzLm9wdGlvbnMuc3RlcC5jYWxsKHRoaXMuZWxlbSwgdGhpcy5ub3csIHRoaXMpOwogICAgICB9CiAgICAgIGlmIChob29rcyAmJiBob29rcy5zZXQpIHsKICAgICAgICBob29rcy5zZXQodGhpcyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgVHdlZW4ucHJvcEhvb2tzLl9kZWZhdWx0LnNldCh0aGlzKTsKICAgICAgfQogICAgICByZXR1cm4gdGhpczsKICAgIH0KICB9OwogIFR3ZWVuLnByb3RvdHlwZS5pbml0LnByb3RvdHlwZSA9IFR3ZWVuLnByb3RvdHlwZTsKICBUd2Vlbi5wcm9wSG9va3MgPSB7CiAgICBfZGVmYXVsdDogewogICAgICBnZXQ6IGZ1bmN0aW9uICh0d2VlbikgewogICAgICAgIHZhciByZXN1bHQ7CiAgICAgICAgaWYgKHR3ZWVuLmVsZW1bdHdlZW4ucHJvcF0gIT0gbnVsbCAmJiAoIXR3ZWVuLmVsZW0uc3R5bGUgfHwgdHdlZW4uZWxlbS5zdHlsZVt0d2Vlbi5wcm9wXSA9PSBudWxsKSkgewogICAgICAgICAgcmV0dXJuIHR3ZWVuLmVsZW1bdHdlZW4ucHJvcF07CiAgICAgICAgfQogICAgICAgIC8vIHBhc3NpbmcgYW4gZW1wdHkgc3RyaW5nIGFzIGEgM3JkIHBhcmFtZXRlciB0byAuY3NzIHdpbGwgYXV0b21hdGljYWxseQogICAgICAgIC8vIGF0dGVtcHQgYSBwYXJzZUZsb2F0IGFuZCBmYWxsYmFjayB0byBhIHN0cmluZyBpZiB0aGUgcGFyc2UgZmFpbHMKICAgICAgICAvLyBzbywgc2ltcGxlIHZhbHVlcyBzdWNoIGFzICIxMHB4IiBhcmUgcGFyc2VkIHRvIEZsb2F0LgogICAgICAgIC8vIGNvbXBsZXggdmFsdWVzIHN1Y2ggYXMgInJvdGF0ZSgxcmFkKSIgYXJlIHJldHVybmVkIGFzIGlzLgogICAgICAgIHJlc3VsdCA9IGpRdWVyeS5jc3ModHdlZW4uZWxlbSwgdHdlZW4ucHJvcCwgJycpOwogICAgICAgIC8vIEVtcHR5IHN0cmluZ3MsIG51bGwsIHVuZGVmaW5lZCBhbmQgImF1dG8iIGFyZSBjb252ZXJ0ZWQgdG8gMC4KICAgICAgICByZXR1cm4gIXJlc3VsdCB8fCByZXN1bHQgPT09ICdhdXRvJyA/IDAgOiByZXN1bHQ7CiAgICAgIH0sCiAgICAgIHNldDogZnVuY3Rpb24gKHR3ZWVuKSB7CiAgICAgICAgLy8gdXNlIHN0ZXAgaG9vayBmb3IgYmFjayBjb21wYXQgLSB1c2UgY3NzSG9vayBpZiBpdHMgdGhlcmUgLSB1c2UgLnN0eWxlIGlmIGl0cwogICAgICAgIC8vIGF2YWlsYWJsZSBhbmQgdXNlIHBsYWluIHByb3BlcnRpZXMgd2hlcmUgYXZhaWxhYmxlCiAgICAgICAgaWYgKGpRdWVyeS5meC5zdGVwW3R3ZWVuLnByb3BdKSB7CiAgICAgICAgICBqUXVlcnkuZnguc3RlcFt0d2Vlbi5wcm9wXSh0d2Vlbik7CiAgICAgICAgfSBlbHNlIGlmICh0d2Vlbi5lbGVtLnN0eWxlICYmICh0d2Vlbi5lbGVtLnN0eWxlW2pRdWVyeS5jc3NQcm9wc1t0d2Vlbi5wcm9wXV0gIT0gbnVsbCB8fCBqUXVlcnkuY3NzSG9va3NbdHdlZW4ucHJvcF0pKSB7CiAgICAgICAgICBqUXVlcnkuc3R5bGUodHdlZW4uZWxlbSwgdHdlZW4ucHJvcCwgdHdlZW4ubm93ICsgdHdlZW4udW5pdCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHR3ZWVuLmVsZW1bdHdlZW4ucHJvcF0gPSB0d2Vlbi5ub3c7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfTsKICAvLyBTdXBwb3J0OiBJRTkKICAvLyBQYW5pYyBiYXNlZCBhcHByb2FjaCB0byBzZXR0aW5nIHRoaW5ncyBvbiBkaXNjb25uZWN0ZWQgbm9kZXMKICBUd2Vlbi5wcm9wSG9va3Muc2Nyb2xsVG9wID0gVHdlZW4ucHJvcEhvb2tzLnNjcm9sbExlZnQgPSB7CiAgICBzZXQ6IGZ1bmN0aW9uICh0d2VlbikgewogICAgICBpZiAodHdlZW4uZWxlbS5ub2RlVHlwZSAmJiB0d2Vlbi5lbGVtLnBhcmVudE5vZGUpIHsKICAgICAgICB0d2Vlbi5lbGVtW3R3ZWVuLnByb3BdID0gdHdlZW4ubm93OwogICAgICB9CiAgICB9CiAgfTsKICBqUXVlcnkuZWFzaW5nID0gewogICAgbGluZWFyOiBmdW5jdGlvbiAocCkgewogICAgICByZXR1cm4gcDsKICAgIH0sCiAgICBzd2luZzogZnVuY3Rpb24gKHApIHsKICAgICAgcmV0dXJuIDAuNSAtIE1hdGguY29zKHAgKiBNYXRoLlBJKSAvIDI7CiAgICB9CiAgfTsKICBqUXVlcnkuZnggPSBUd2Vlbi5wcm90b3R5cGUuaW5pdDsKICAvLyBCYWNrIENvbXBhdCA8MS44IGV4dGVuc2lvbiBwb2ludAogIGpRdWVyeS5meC5zdGVwID0ge307CiAgdmFyIGZ4Tm93LCB0aW1lcklkLCByZnh0eXBlcyA9IC9eKD86dG9nZ2xlfHNob3d8aGlkZSkkLywgcmZ4bnVtID0gbmV3IFJlZ0V4cCgnXig/OihbKy1dKT18KSgnICsgcG51bSArICcpKFthLXolXSopJCcsICdpJyksIHJydW4gPSAvcXVldWVIb29rcyQvLCBhbmltYXRpb25QcmVmaWx0ZXJzID0gW2RlZmF1bHRQcmVmaWx0ZXJdLCB0d2VlbmVycyA9IHsKICAgICAgJyonOiBbZnVuY3Rpb24gKHByb3AsIHZhbHVlKSB7CiAgICAgICAgICB2YXIgdHdlZW4gPSB0aGlzLmNyZWF0ZVR3ZWVuKHByb3AsIHZhbHVlKSwgdGFyZ2V0ID0gdHdlZW4uY3VyKCksIHBhcnRzID0gcmZ4bnVtLmV4ZWModmFsdWUpLCB1bml0ID0gcGFydHMgJiYgcGFydHNbM10gfHwgKGpRdWVyeS5jc3NOdW1iZXJbcHJvcF0gPyAnJyA6ICdweCcpLAogICAgICAgICAgICAvLyBTdGFydGluZyB2YWx1ZSBjb21wdXRhdGlvbiBpcyByZXF1aXJlZCBmb3IgcG90ZW50aWFsIHVuaXQgbWlzbWF0Y2hlcwogICAgICAgICAgICBzdGFydCA9IChqUXVlcnkuY3NzTnVtYmVyW3Byb3BdIHx8IHVuaXQgIT09ICdweCcgJiYgK3RhcmdldCkgJiYgcmZ4bnVtLmV4ZWMoalF1ZXJ5LmNzcyh0d2Vlbi5lbGVtLCBwcm9wKSksIHNjYWxlID0gMSwgbWF4SXRlcmF0aW9ucyA9IDIwOwogICAgICAgICAgaWYgKHN0YXJ0ICYmIHN0YXJ0WzNdICE9PSB1bml0KSB7CiAgICAgICAgICAgIC8vIFRydXN0IHVuaXRzIHJlcG9ydGVkIGJ5IGpRdWVyeS5jc3MKICAgICAgICAgICAgdW5pdCA9IHVuaXQgfHwgc3RhcnRbM107CiAgICAgICAgICAgIC8vIE1ha2Ugc3VyZSB3ZSB1cGRhdGUgdGhlIHR3ZWVuIHByb3BlcnRpZXMgbGF0ZXIgb24KICAgICAgICAgICAgcGFydHMgPSBwYXJ0cyB8fCBbXTsKICAgICAgICAgICAgLy8gSXRlcmF0aXZlbHkgYXBwcm94aW1hdGUgZnJvbSBhIG5vbnplcm8gc3RhcnRpbmcgcG9pbnQKICAgICAgICAgICAgc3RhcnQgPSArdGFyZ2V0IHx8IDE7CiAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICAvLyBJZiBwcmV2aW91cyBpdGVyYXRpb24gemVyb2VkIG91dCwgZG91YmxlIHVudGlsIHdlIGdldCAqc29tZXRoaW5nKgogICAgICAgICAgICAgIC8vIFVzZSBhIHN0cmluZyBmb3IgZG91YmxpbmcgZmFjdG9yIHNvIHdlIGRvbid0IGFjY2lkZW50YWxseSBzZWUgc2NhbGUgYXMgdW5jaGFuZ2VkIGJlbG93CiAgICAgICAgICAgICAgc2NhbGUgPSBzY2FsZSB8fCAnLjUnOwogICAgICAgICAgICAgIC8vIEFkanVzdCBhbmQgYXBwbHkKICAgICAgICAgICAgICBzdGFydCA9IHN0YXJ0IC8gc2NhbGU7CiAgICAgICAgICAgICAgalF1ZXJ5LnN0eWxlKHR3ZWVuLmVsZW0sIHByb3AsIHN0YXJ0ICsgdW5pdCk7ICAvLyBVcGRhdGUgc2NhbGUsIHRvbGVyYXRpbmcgemVybyBvciBOYU4gZnJvbSB0d2Vlbi5jdXIoKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gQW5kIGJyZWFraW5nIHRoZSBsb29wIGlmIHNjYWxlIGlzIHVuY2hhbmdlZCBvciBwZXJmZWN0LCBvciBpZiB3ZSd2ZSBqdXN0IGhhZCBlbm91Z2gKICAgICAgICAgICAgfSB3aGlsZSAoc2NhbGUgIT09IChzY2FsZSA9IHR3ZWVuLmN1cigpIC8gdGFyZ2V0KSAmJiBzY2FsZSAhPT0gMSAmJiAtLW1heEl0ZXJhdGlvbnMpOwogICAgICAgICAgfQogICAgICAgICAgLy8gVXBkYXRlIHR3ZWVuIHByb3BlcnRpZXMKICAgICAgICAgIGlmIChwYXJ0cykgewogICAgICAgICAgICBzdGFydCA9IHR3ZWVuLnN0YXJ0ID0gK3N0YXJ0IHx8ICt0YXJnZXQgfHwgMDsKICAgICAgICAgICAgdHdlZW4udW5pdCA9IHVuaXQ7CiAgICAgICAgICAgIC8vIElmIGEgKz0vLT0gdG9rZW4gd2FzIHByb3ZpZGVkLCB3ZSdyZSBkb2luZyBhIHJlbGF0aXZlIGFuaW1hdGlvbgogICAgICAgICAgICB0d2Vlbi5lbmQgPSBwYXJ0c1sxXSA/IHN0YXJ0ICsgKHBhcnRzWzFdICsgMSkgKiBwYXJ0c1syXSA6ICtwYXJ0c1syXTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0d2VlbjsKICAgICAgICB9XQogICAgfTsKICAvLyBBbmltYXRpb25zIGNyZWF0ZWQgc3luY2hyb25vdXNseSB3aWxsIHJ1biBzeW5jaHJvbm91c2x5CiAgZnVuY3Rpb24gY3JlYXRlRnhOb3coKSB7CiAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgZnhOb3cgPSB1bmRlZmluZWQ7CiAgICB9KTsKICAgIHJldHVybiBmeE5vdyA9IGpRdWVyeS5ub3coKTsKICB9CiAgLy8gR2VuZXJhdGUgcGFyYW1ldGVycyB0byBjcmVhdGUgYSBzdGFuZGFyZCBhbmltYXRpb24KICBmdW5jdGlvbiBnZW5GeCh0eXBlLCBpbmNsdWRlV2lkdGgpIHsKICAgIHZhciB3aGljaCwgaSA9IDAsIGF0dHJzID0geyBoZWlnaHQ6IHR5cGUgfTsKICAgIC8vIGlmIHdlIGluY2x1ZGUgd2lkdGgsIHN0ZXAgdmFsdWUgaXMgMSB0byBkbyBhbGwgY3NzRXhwYW5kIHZhbHVlcywKICAgIC8vIGlmIHdlIGRvbid0IGluY2x1ZGUgd2lkdGgsIHN0ZXAgdmFsdWUgaXMgMiB0byBza2lwIG92ZXIgTGVmdCBhbmQgUmlnaHQKICAgIGluY2x1ZGVXaWR0aCA9IGluY2x1ZGVXaWR0aCA/IDEgOiAwOwogICAgZm9yICg7IGkgPCA0OyBpICs9IDIgLSBpbmNsdWRlV2lkdGgpIHsKICAgICAgd2hpY2ggPSBjc3NFeHBhbmRbaV07CiAgICAgIGF0dHJzWydtYXJnaW4nICsgd2hpY2hdID0gYXR0cnNbJ3BhZGRpbmcnICsgd2hpY2hdID0gdHlwZTsKICAgIH0KICAgIGlmIChpbmNsdWRlV2lkdGgpIHsKICAgICAgYXR0cnMub3BhY2l0eSA9IGF0dHJzLndpZHRoID0gdHlwZTsKICAgIH0KICAgIHJldHVybiBhdHRyczsKICB9CiAgZnVuY3Rpb24gY3JlYXRlVHdlZW4odmFsdWUsIHByb3AsIGFuaW1hdGlvbikgewogICAgdmFyIHR3ZWVuLCBjb2xsZWN0aW9uID0gKHR3ZWVuZXJzW3Byb3BdIHx8IFtdKS5jb25jYXQodHdlZW5lcnNbJyonXSksIGluZGV4ID0gMCwgbGVuZ3RoID0gY29sbGVjdGlvbi5sZW5ndGg7CiAgICBmb3IgKDsgaW5kZXggPCBsZW5ndGg7IGluZGV4KyspIHsKICAgICAgaWYgKHR3ZWVuID0gY29sbGVjdGlvbltpbmRleF0uY2FsbChhbmltYXRpb24sIHByb3AsIHZhbHVlKSkgewogICAgICAgIC8vIHdlJ3JlIGRvbmUgd2l0aCB0aGlzIHByb3BlcnR5CiAgICAgICAgcmV0dXJuIHR3ZWVuOwogICAgICB9CiAgICB9CiAgfQogIGZ1bmN0aW9uIGRlZmF1bHRQcmVmaWx0ZXIoZWxlbSwgcHJvcHMsIG9wdHMpIHsKICAgIC8qIGpzaGludCB2YWxpZHRoaXM6IHRydWUgKi8KICAgIHZhciBwcm9wLCB2YWx1ZSwgdG9nZ2xlLCB0d2VlbiwgaG9va3MsIG9sZGZpcmUsIGRpc3BsYXksIGNoZWNrRGlzcGxheSwgYW5pbSA9IHRoaXMsIG9yaWcgPSB7fSwgc3R5bGUgPSBlbGVtLnN0eWxlLCBoaWRkZW4gPSBlbGVtLm5vZGVUeXBlICYmIGlzSGlkZGVuKGVsZW0pLCBkYXRhU2hvdyA9IGRhdGFfcHJpdi5nZXQoZWxlbSwgJ2Z4c2hvdycpOwogICAgLy8gaGFuZGxlIHF1ZXVlOiBmYWxzZSBwcm9taXNlcwogICAgaWYgKCFvcHRzLnF1ZXVlKSB7CiAgICAgIGhvb2tzID0galF1ZXJ5Ll9xdWV1ZUhvb2tzKGVsZW0sICdmeCcpOwogICAgICBpZiAoaG9va3MudW5xdWV1ZWQgPT0gbnVsbCkgewogICAgICAgIGhvb2tzLnVucXVldWVkID0gMDsKICAgICAgICBvbGRmaXJlID0gaG9va3MuZW1wdHkuZmlyZTsKICAgICAgICBob29rcy5lbXB0eS5maXJlID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgaWYgKCFob29rcy51bnF1ZXVlZCkgewogICAgICAgICAgICBvbGRmaXJlKCk7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgfQogICAgICBob29rcy51bnF1ZXVlZCsrOwogICAgICBhbmltLmFsd2F5cyhmdW5jdGlvbiAoKSB7CiAgICAgICAgLy8gZG9pbmcgdGhpcyBtYWtlcyBzdXJlIHRoYXQgdGhlIGNvbXBsZXRlIGhhbmRsZXIgd2lsbCBiZSBjYWxsZWQKICAgICAgICAvLyBiZWZvcmUgdGhpcyBjb21wbGV0ZXMKICAgICAgICBhbmltLmFsd2F5cyhmdW5jdGlvbiAoKSB7CiAgICAgICAgICBob29rcy51bnF1ZXVlZC0tOwogICAgICAgICAgaWYgKCFqUXVlcnkucXVldWUoZWxlbSwgJ2Z4JykubGVuZ3RoKSB7CiAgICAgICAgICAgIGhvb2tzLmVtcHR5LmZpcmUoKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfSk7CiAgICB9CiAgICAvLyBoZWlnaHQvd2lkdGggb3ZlcmZsb3cgcGFzcwogICAgaWYgKGVsZW0ubm9kZVR5cGUgPT09IDEgJiYgKCdoZWlnaHQnIGluIHByb3BzIHx8ICd3aWR0aCcgaW4gcHJvcHMpKSB7CiAgICAgIC8vIE1ha2Ugc3VyZSB0aGF0IG5vdGhpbmcgc25lYWtzIG91dAogICAgICAvLyBSZWNvcmQgYWxsIDMgb3ZlcmZsb3cgYXR0cmlidXRlcyBiZWNhdXNlIElFOS0xMCBkbyBub3QKICAgICAgLy8gY2hhbmdlIHRoZSBvdmVyZmxvdyBhdHRyaWJ1dGUgd2hlbiBvdmVyZmxvd1ggYW5kCiAgICAgIC8vIG92ZXJmbG93WSBhcmUgc2V0IHRvIHRoZSBzYW1lIHZhbHVlCiAgICAgIG9wdHMub3ZlcmZsb3cgPSBbCiAgICAgICAgc3R5bGUub3ZlcmZsb3csCiAgICAgICAgc3R5bGUub3ZlcmZsb3dYLAogICAgICAgIHN0eWxlLm92ZXJmbG93WQogICAgICBdOwogICAgICAvLyBTZXQgZGlzcGxheSBwcm9wZXJ0eSB0byBpbmxpbmUtYmxvY2sgZm9yIGhlaWdodC93aWR0aAogICAgICAvLyBhbmltYXRpb25zIG9uIGlubGluZSBlbGVtZW50cyB0aGF0IGFyZSBoYXZpbmcgd2lkdGgvaGVpZ2h0IGFuaW1hdGVkCiAgICAgIGRpc3BsYXkgPSBqUXVlcnkuY3NzKGVsZW0sICdkaXNwbGF5Jyk7CiAgICAgIC8vIFRlc3QgZGVmYXVsdCBkaXNwbGF5IGlmIGRpc3BsYXkgaXMgY3VycmVudGx5ICJub25lIgogICAgICBjaGVja0Rpc3BsYXkgPSBkaXNwbGF5ID09PSAnbm9uZScgPyBkYXRhX3ByaXYuZ2V0KGVsZW0sICdvbGRkaXNwbGF5JykgfHwgZGVmYXVsdERpc3BsYXkoZWxlbS5ub2RlTmFtZSkgOiBkaXNwbGF5OwogICAgICBpZiAoY2hlY2tEaXNwbGF5ID09PSAnaW5saW5lJyAmJiBqUXVlcnkuY3NzKGVsZW0sICdmbG9hdCcpID09PSAnbm9uZScpIHsKICAgICAgICBzdHlsZS5kaXNwbGF5ID0gJ2lubGluZS1ibG9jayc7CiAgICAgIH0KICAgIH0KICAgIGlmIChvcHRzLm92ZXJmbG93KSB7CiAgICAgIHN0eWxlLm92ZXJmbG93ID0gJ2hpZGRlbic7CiAgICAgIGFuaW0uYWx3YXlzKGZ1bmN0aW9uICgpIHsKICAgICAgICBzdHlsZS5vdmVyZmxvdyA9IG9wdHMub3ZlcmZsb3dbMF07CiAgICAgICAgc3R5bGUub3ZlcmZsb3dYID0gb3B0cy5vdmVyZmxvd1sxXTsKICAgICAgICBzdHlsZS5vdmVyZmxvd1kgPSBvcHRzLm92ZXJmbG93WzJdOwogICAgICB9KTsKICAgIH0KICAgIC8vIHNob3cvaGlkZSBwYXNzCiAgICBmb3IgKHByb3AgaW4gcHJvcHMpIHsKICAgICAgdmFsdWUgPSBwcm9wc1twcm9wXTsKICAgICAgaWYgKHJmeHR5cGVzLmV4ZWModmFsdWUpKSB7CiAgICAgICAgZGVsZXRlIHByb3BzW3Byb3BdOwogICAgICAgIHRvZ2dsZSA9IHRvZ2dsZSB8fCB2YWx1ZSA9PT0gJ3RvZ2dsZSc7CiAgICAgICAgaWYgKHZhbHVlID09PSAoaGlkZGVuID8gJ2hpZGUnIDogJ3Nob3cnKSkgewogICAgICAgICAgLy8gSWYgdGhlcmUgaXMgZGF0YVNob3cgbGVmdCBvdmVyIGZyb20gYSBzdG9wcGVkIGhpZGUgb3Igc2hvdyBhbmQgd2UgYXJlIGdvaW5nIHRvIHByb2NlZWQgd2l0aCBzaG93LCB3ZSBzaG91bGQgcHJldGVuZCB0byBiZSBoaWRkZW4KICAgICAgICAgIGlmICh2YWx1ZSA9PT0gJ3Nob3cnICYmIGRhdGFTaG93ICYmIGRhdGFTaG93W3Byb3BdICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgaGlkZGVuID0gdHJ1ZTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBvcmlnW3Byb3BdID0gZGF0YVNob3cgJiYgZGF0YVNob3dbcHJvcF0gfHwgalF1ZXJ5LnN0eWxlKGVsZW0sIHByb3ApOyAgLy8gQW55IG5vbi1meCB2YWx1ZSBzdG9wcyB1cyBmcm9tIHJlc3RvcmluZyB0aGUgb3JpZ2luYWwgZGlzcGxheSB2YWx1ZQogICAgICB9IGVsc2UgewogICAgICAgIGRpc3BsYXkgPSB1bmRlZmluZWQ7CiAgICAgIH0KICAgIH0KICAgIGlmICghalF1ZXJ5LmlzRW1wdHlPYmplY3Qob3JpZykpIHsKICAgICAgaWYgKGRhdGFTaG93KSB7CiAgICAgICAgaWYgKCdoaWRkZW4nIGluIGRhdGFTaG93KSB7CiAgICAgICAgICBoaWRkZW4gPSBkYXRhU2hvdy5oaWRkZW47CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGRhdGFTaG93ID0gZGF0YV9wcml2LmFjY2VzcyhlbGVtLCAnZnhzaG93Jywge30pOwogICAgICB9CiAgICAgIC8vIHN0b3JlIHN0YXRlIGlmIGl0cyB0b2dnbGUgLSBlbmFibGVzIC5zdG9wKCkudG9nZ2xlKCkgdG8gInJldmVyc2UiCiAgICAgIGlmICh0b2dnbGUpIHsKICAgICAgICBkYXRhU2hvdy5oaWRkZW4gPSAhaGlkZGVuOwogICAgICB9CiAgICAgIGlmIChoaWRkZW4pIHsKICAgICAgICBqUXVlcnkoZWxlbSkuc2hvdygpOwogICAgICB9IGVsc2UgewogICAgICAgIGFuaW0uZG9uZShmdW5jdGlvbiAoKSB7CiAgICAgICAgICBqUXVlcnkoZWxlbSkuaGlkZSgpOwogICAgICAgIH0pOwogICAgICB9CiAgICAgIGFuaW0uZG9uZShmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIHByb3A7CiAgICAgICAgZGF0YV9wcml2LnJlbW92ZShlbGVtLCAnZnhzaG93Jyk7CiAgICAgICAgZm9yIChwcm9wIGluIG9yaWcpIHsKICAgICAgICAgIGpRdWVyeS5zdHlsZShlbGVtLCBwcm9wLCBvcmlnW3Byb3BdKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICBmb3IgKHByb3AgaW4gb3JpZykgewogICAgICAgIHR3ZWVuID0gY3JlYXRlVHdlZW4oaGlkZGVuID8gZGF0YVNob3dbcHJvcF0gOiAwLCBwcm9wLCBhbmltKTsKICAgICAgICBpZiAoIShwcm9wIGluIGRhdGFTaG93KSkgewogICAgICAgICAgZGF0YVNob3dbcHJvcF0gPSB0d2Vlbi5zdGFydDsKICAgICAgICAgIGlmIChoaWRkZW4pIHsKICAgICAgICAgICAgdHdlZW4uZW5kID0gdHdlZW4uc3RhcnQ7CiAgICAgICAgICAgIHR3ZWVuLnN0YXJ0ID0gcHJvcCA9PT0gJ3dpZHRoJyB8fCBwcm9wID09PSAnaGVpZ2h0JyA/IDEgOiAwOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSAgLy8gSWYgdGhpcyBpcyBhIG5vb3AgbGlrZSAuaGlkZSgpLmhpZGUoKSwgcmVzdG9yZSBhbiBvdmVyd3JpdHRlbiBkaXNwbGF5IHZhbHVlCiAgICB9IGVsc2UgaWYgKChkaXNwbGF5ID09PSAnbm9uZScgPyBkZWZhdWx0RGlzcGxheShlbGVtLm5vZGVOYW1lKSA6IGRpc3BsYXkpID09PSAnaW5saW5lJykgewogICAgICBzdHlsZS5kaXNwbGF5ID0gZGlzcGxheTsKICAgIH0KICB9CiAgZnVuY3Rpb24gcHJvcEZpbHRlcihwcm9wcywgc3BlY2lhbEVhc2luZykgewogICAgdmFyIGluZGV4LCBuYW1lLCBlYXNpbmcsIHZhbHVlLCBob29rczsKICAgIC8vIGNhbWVsQ2FzZSwgc3BlY2lhbEVhc2luZyBhbmQgZXhwYW5kIGNzc0hvb2sgcGFzcwogICAgZm9yIChpbmRleCBpbiBwcm9wcykgewogICAgICBuYW1lID0galF1ZXJ5LmNhbWVsQ2FzZShpbmRleCk7CiAgICAgIGVhc2luZyA9IHNwZWNpYWxFYXNpbmdbbmFtZV07CiAgICAgIHZhbHVlID0gcHJvcHNbaW5kZXhdOwogICAgICBpZiAoalF1ZXJ5LmlzQXJyYXkodmFsdWUpKSB7CiAgICAgICAgZWFzaW5nID0gdmFsdWVbMV07CiAgICAgICAgdmFsdWUgPSBwcm9wc1tpbmRleF0gPSB2YWx1ZVswXTsKICAgICAgfQogICAgICBpZiAoaW5kZXggIT09IG5hbWUpIHsKICAgICAgICBwcm9wc1tuYW1lXSA9IHZhbHVlOwogICAgICAgIGRlbGV0ZSBwcm9wc1tpbmRleF07CiAgICAgIH0KICAgICAgaG9va3MgPSBqUXVlcnkuY3NzSG9va3NbbmFtZV07CiAgICAgIGlmIChob29rcyAmJiAnZXhwYW5kJyBpbiBob29rcykgewogICAgICAgIHZhbHVlID0gaG9va3MuZXhwYW5kKHZhbHVlKTsKICAgICAgICBkZWxldGUgcHJvcHNbbmFtZV07CiAgICAgICAgLy8gbm90IHF1aXRlICQuZXh0ZW5kLCB0aGlzIHdvbnQgb3ZlcndyaXRlIGtleXMgYWxyZWFkeSBwcmVzZW50LgogICAgICAgIC8vIGFsc28gLSByZXVzaW5nICdpbmRleCcgZnJvbSBhYm92ZSBiZWNhdXNlIHdlIGhhdmUgdGhlIGNvcnJlY3QgIm5hbWUiCiAgICAgICAgZm9yIChpbmRleCBpbiB2YWx1ZSkgewogICAgICAgICAgaWYgKCEoaW5kZXggaW4gcHJvcHMpKSB7CiAgICAgICAgICAgIHByb3BzW2luZGV4XSA9IHZhbHVlW2luZGV4XTsKICAgICAgICAgICAgc3BlY2lhbEVhc2luZ1tpbmRleF0gPSBlYXNpbmc7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIHNwZWNpYWxFYXNpbmdbbmFtZV0gPSBlYXNpbmc7CiAgICAgIH0KICAgIH0KICB9CiAgZnVuY3Rpb24gQW5pbWF0aW9uKGVsZW0sIHByb3BlcnRpZXMsIG9wdGlvbnMpIHsKICAgIHZhciByZXN1bHQsIHN0b3BwZWQsIGluZGV4ID0gMCwgbGVuZ3RoID0gYW5pbWF0aW9uUHJlZmlsdGVycy5sZW5ndGgsIGRlZmVycmVkID0galF1ZXJ5LkRlZmVycmVkKCkuYWx3YXlzKGZ1bmN0aW9uICgpIHsKICAgICAgICAvLyBkb24ndCBtYXRjaCBlbGVtIGluIHRoZSA6YW5pbWF0ZWQgc2VsZWN0b3IKICAgICAgICBkZWxldGUgdGljay5lbGVtOwogICAgICB9KSwgdGljayA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBpZiAoc3RvcHBlZCkgewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICB2YXIgY3VycmVudFRpbWUgPSBmeE5vdyB8fCBjcmVhdGVGeE5vdygpLCByZW1haW5pbmcgPSBNYXRoLm1heCgwLCBhbmltYXRpb24uc3RhcnRUaW1lICsgYW5pbWF0aW9uLmR1cmF0aW9uIC0gY3VycmVudFRpbWUpLAogICAgICAgICAgLy8gYXJjaGFpYyBjcmFzaCBidWcgd29uJ3QgYWxsb3cgdXMgdG8gdXNlIDEgLSAoIDAuNSB8fCAwICkgKCMxMjQ5NykKICAgICAgICAgIHRlbXAgPSByZW1haW5pbmcgLyBhbmltYXRpb24uZHVyYXRpb24gfHwgMCwgcGVyY2VudCA9IDEgLSB0ZW1wLCBpbmRleCA9IDAsIGxlbmd0aCA9IGFuaW1hdGlvbi50d2VlbnMubGVuZ3RoOwogICAgICAgIGZvciAoOyBpbmRleCA8IGxlbmd0aDsgaW5kZXgrKykgewogICAgICAgICAgYW5pbWF0aW9uLnR3ZWVuc1tpbmRleF0ucnVuKHBlcmNlbnQpOwogICAgICAgIH0KICAgICAgICBkZWZlcnJlZC5ub3RpZnlXaXRoKGVsZW0sIFsKICAgICAgICAgIGFuaW1hdGlvbiwKICAgICAgICAgIHBlcmNlbnQsCiAgICAgICAgICByZW1haW5pbmcKICAgICAgICBdKTsKICAgICAgICBpZiAocGVyY2VudCA8IDEgJiYgbGVuZ3RoKSB7CiAgICAgICAgICByZXR1cm4gcmVtYWluaW5nOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBkZWZlcnJlZC5yZXNvbHZlV2l0aChlbGVtLCBbYW5pbWF0aW9uXSk7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICB9LCBhbmltYXRpb24gPSBkZWZlcnJlZC5wcm9taXNlKHsKICAgICAgICBlbGVtOiBlbGVtLAogICAgICAgIHByb3BzOiBqUXVlcnkuZXh0ZW5kKHt9LCBwcm9wZXJ0aWVzKSwKICAgICAgICBvcHRzOiBqUXVlcnkuZXh0ZW5kKHRydWUsIHsgc3BlY2lhbEVhc2luZzoge30gfSwgb3B0aW9ucyksCiAgICAgICAgb3JpZ2luYWxQcm9wZXJ0aWVzOiBwcm9wZXJ0aWVzLAogICAgICAgIG9yaWdpbmFsT3B0aW9uczogb3B0aW9ucywKICAgICAgICBzdGFydFRpbWU6IGZ4Tm93IHx8IGNyZWF0ZUZ4Tm93KCksCiAgICAgICAgZHVyYXRpb246IG9wdGlvbnMuZHVyYXRpb24sCiAgICAgICAgdHdlZW5zOiBbXSwKICAgICAgICBjcmVhdGVUd2VlbjogZnVuY3Rpb24gKHByb3AsIGVuZCkgewogICAgICAgICAgdmFyIHR3ZWVuID0galF1ZXJ5LlR3ZWVuKGVsZW0sIGFuaW1hdGlvbi5vcHRzLCBwcm9wLCBlbmQsIGFuaW1hdGlvbi5vcHRzLnNwZWNpYWxFYXNpbmdbcHJvcF0gfHwgYW5pbWF0aW9uLm9wdHMuZWFzaW5nKTsKICAgICAgICAgIGFuaW1hdGlvbi50d2VlbnMucHVzaCh0d2Vlbik7CiAgICAgICAgICByZXR1cm4gdHdlZW47CiAgICAgICAgfSwKICAgICAgICBzdG9wOiBmdW5jdGlvbiAoZ290b0VuZCkgewogICAgICAgICAgdmFyIGluZGV4ID0gMCwKICAgICAgICAgICAgLy8gaWYgd2UgYXJlIGdvaW5nIHRvIHRoZSBlbmQsIHdlIHdhbnQgdG8gcnVuIGFsbCB0aGUgdHdlZW5zCiAgICAgICAgICAgIC8vIG90aGVyd2lzZSB3ZSBza2lwIHRoaXMgcGFydAogICAgICAgICAgICBsZW5ndGggPSBnb3RvRW5kID8gYW5pbWF0aW9uLnR3ZWVucy5sZW5ndGggOiAwOwogICAgICAgICAgaWYgKHN0b3BwZWQpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICB9CiAgICAgICAgICBzdG9wcGVkID0gdHJ1ZTsKICAgICAgICAgIGZvciAoOyBpbmRleCA8IGxlbmd0aDsgaW5kZXgrKykgewogICAgICAgICAgICBhbmltYXRpb24udHdlZW5zW2luZGV4XS5ydW4oMSk7CiAgICAgICAgICB9CiAgICAgICAgICAvLyByZXNvbHZlIHdoZW4gd2UgcGxheWVkIHRoZSBsYXN0IGZyYW1lCiAgICAgICAgICAvLyBvdGhlcndpc2UsIHJlamVjdAogICAgICAgICAgaWYgKGdvdG9FbmQpIHsKICAgICAgICAgICAgZGVmZXJyZWQucmVzb2x2ZVdpdGgoZWxlbSwgWwogICAgICAgICAgICAgIGFuaW1hdGlvbiwKICAgICAgICAgICAgICBnb3RvRW5kCiAgICAgICAgICAgIF0pOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZGVmZXJyZWQucmVqZWN0V2l0aChlbGVtLCBbCiAgICAgICAgICAgICAgYW5pbWF0aW9uLAogICAgICAgICAgICAgIGdvdG9FbmQKICAgICAgICAgICAgXSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9CiAgICAgIH0pLCBwcm9wcyA9IGFuaW1hdGlvbi5wcm9wczsKICAgIHByb3BGaWx0ZXIocHJvcHMsIGFuaW1hdGlvbi5vcHRzLnNwZWNpYWxFYXNpbmcpOwogICAgZm9yICg7IGluZGV4IDwgbGVuZ3RoOyBpbmRleCsrKSB7CiAgICAgIHJlc3VsdCA9IGFuaW1hdGlvblByZWZpbHRlcnNbaW5kZXhdLmNhbGwoYW5pbWF0aW9uLCBlbGVtLCBwcm9wcywgYW5pbWF0aW9uLm9wdHMpOwogICAgICBpZiAocmVzdWx0KSB7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfQogICAgfQogICAgalF1ZXJ5Lm1hcChwcm9wcywgY3JlYXRlVHdlZW4sIGFuaW1hdGlvbik7CiAgICBpZiAoalF1ZXJ5LmlzRnVuY3Rpb24oYW5pbWF0aW9uLm9wdHMuc3RhcnQpKSB7CiAgICAgIGFuaW1hdGlvbi5vcHRzLnN0YXJ0LmNhbGwoZWxlbSwgYW5pbWF0aW9uKTsKICAgIH0KICAgIGpRdWVyeS5meC50aW1lcihqUXVlcnkuZXh0ZW5kKHRpY2ssIHsKICAgICAgZWxlbTogZWxlbSwKICAgICAgYW5pbTogYW5pbWF0aW9uLAogICAgICBxdWV1ZTogYW5pbWF0aW9uLm9wdHMucXVldWUKICAgIH0pKTsKICAgIC8vIGF0dGFjaCBjYWxsYmFja3MgZnJvbSBvcHRpb25zCiAgICByZXR1cm4gYW5pbWF0aW9uLnByb2dyZXNzKGFuaW1hdGlvbi5vcHRzLnByb2dyZXNzKS5kb25lKGFuaW1hdGlvbi5vcHRzLmRvbmUsIGFuaW1hdGlvbi5vcHRzLmNvbXBsZXRlKS5mYWlsKGFuaW1hdGlvbi5vcHRzLmZhaWwpLmFsd2F5cyhhbmltYXRpb24ub3B0cy5hbHdheXMpOwogIH0KICBqUXVlcnkuQW5pbWF0aW9uID0galF1ZXJ5LmV4dGVuZChBbmltYXRpb24sIHsKICAgIHR3ZWVuZXI6IGZ1bmN0aW9uIChwcm9wcywgY2FsbGJhY2spIHsKICAgICAgaWYgKGpRdWVyeS5pc0Z1bmN0aW9uKHByb3BzKSkgewogICAgICAgIGNhbGxiYWNrID0gcHJvcHM7CiAgICAgICAgcHJvcHMgPSBbJyonXTsKICAgICAgfSBlbHNlIHsKICAgICAgICBwcm9wcyA9IHByb3BzLnNwbGl0KCcgJyk7CiAgICAgIH0KICAgICAgdmFyIHByb3AsIGluZGV4ID0gMCwgbGVuZ3RoID0gcHJvcHMubGVuZ3RoOwogICAgICBmb3IgKDsgaW5kZXggPCBsZW5ndGg7IGluZGV4KyspIHsKICAgICAgICBwcm9wID0gcHJvcHNbaW5kZXhdOwogICAgICAgIHR3ZWVuZXJzW3Byb3BdID0gdHdlZW5lcnNbcHJvcF0gfHwgW107CiAgICAgICAgdHdlZW5lcnNbcHJvcF0udW5zaGlmdChjYWxsYmFjayk7CiAgICAgIH0KICAgIH0sCiAgICBwcmVmaWx0ZXI6IGZ1bmN0aW9uIChjYWxsYmFjaywgcHJlcGVuZCkgewogICAgICBpZiAocHJlcGVuZCkgewogICAgICAgIGFuaW1hdGlvblByZWZpbHRlcnMudW5zaGlmdChjYWxsYmFjayk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgYW5pbWF0aW9uUHJlZmlsdGVycy5wdXNoKGNhbGxiYWNrKTsKICAgICAgfQogICAgfQogIH0pOwogIGpRdWVyeS5zcGVlZCA9IGZ1bmN0aW9uIChzcGVlZCwgZWFzaW5nLCBmbikgewogICAgdmFyIG9wdCA9IHNwZWVkICYmIHR5cGVvZiBzcGVlZCA9PT0gJ29iamVjdCcgPyBqUXVlcnkuZXh0ZW5kKHt9LCBzcGVlZCkgOiB7CiAgICAgIGNvbXBsZXRlOiBmbiB8fCAhZm4gJiYgZWFzaW5nIHx8IGpRdWVyeS5pc0Z1bmN0aW9uKHNwZWVkKSAmJiBzcGVlZCwKICAgICAgZHVyYXRpb246IHNwZWVkLAogICAgICBlYXNpbmc6IGZuICYmIGVhc2luZyB8fCBlYXNpbmcgJiYgIWpRdWVyeS5pc0Z1bmN0aW9uKGVhc2luZykgJiYgZWFzaW5nCiAgICB9OwogICAgb3B0LmR1cmF0aW9uID0galF1ZXJ5LmZ4Lm9mZiA/IDAgOiB0eXBlb2Ygb3B0LmR1cmF0aW9uID09PSAnbnVtYmVyJyA/IG9wdC5kdXJhdGlvbiA6IG9wdC5kdXJhdGlvbiBpbiBqUXVlcnkuZnguc3BlZWRzID8galF1ZXJ5LmZ4LnNwZWVkc1tvcHQuZHVyYXRpb25dIDogalF1ZXJ5LmZ4LnNwZWVkcy5fZGVmYXVsdDsKICAgIC8vIG5vcm1hbGl6ZSBvcHQucXVldWUgLSB0cnVlL3VuZGVmaW5lZC9udWxsIC0+ICJmeCIKICAgIGlmIChvcHQucXVldWUgPT0gbnVsbCB8fCBvcHQucXVldWUgPT09IHRydWUpIHsKICAgICAgb3B0LnF1ZXVlID0gJ2Z4JzsKICAgIH0KICAgIC8vIFF1ZXVlaW5nCiAgICBvcHQub2xkID0gb3B0LmNvbXBsZXRlOwogICAgb3B0LmNvbXBsZXRlID0gZnVuY3Rpb24gKCkgewogICAgICBpZiAoalF1ZXJ5LmlzRnVuY3Rpb24ob3B0Lm9sZCkpIHsKICAgICAgICBvcHQub2xkLmNhbGwodGhpcyk7CiAgICAgIH0KICAgICAgaWYgKG9wdC5xdWV1ZSkgewogICAgICAgIGpRdWVyeS5kZXF1ZXVlKHRoaXMsIG9wdC5xdWV1ZSk7CiAgICAgIH0KICAgIH07CiAgICByZXR1cm4gb3B0OwogIH07CiAgalF1ZXJ5LmZuLmV4dGVuZCh7CiAgICBmYWRlVG86IGZ1bmN0aW9uIChzcGVlZCwgdG8sIGVhc2luZywgY2FsbGJhY2spIHsKICAgICAgLy8gc2hvdyBhbnkgaGlkZGVuIGVsZW1lbnRzIGFmdGVyIHNldHRpbmcgb3BhY2l0eSB0byAwCiAgICAgIHJldHVybiB0aGlzLmZpbHRlcihpc0hpZGRlbikuY3NzKCdvcGFjaXR5JywgMCkuc2hvdygpICAvLyBhbmltYXRlIHRvIHRoZSB2YWx1ZSBzcGVjaWZpZWQKLmVuZCgpLmFuaW1hdGUoeyBvcGFjaXR5OiB0byB9LCBzcGVlZCwgZWFzaW5nLCBjYWxsYmFjayk7CiAgICB9LAogICAgYW5pbWF0ZTogZnVuY3Rpb24gKHByb3AsIHNwZWVkLCBlYXNpbmcsIGNhbGxiYWNrKSB7CiAgICAgIHZhciBlbXB0eSA9IGpRdWVyeS5pc0VtcHR5T2JqZWN0KHByb3ApLCBvcHRhbGwgPSBqUXVlcnkuc3BlZWQoc3BlZWQsIGVhc2luZywgY2FsbGJhY2spLCBkb0FuaW1hdGlvbiA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIC8vIE9wZXJhdGUgb24gYSBjb3B5IG9mIHByb3Agc28gcGVyLXByb3BlcnR5IGVhc2luZyB3b24ndCBiZSBsb3N0CiAgICAgICAgICB2YXIgYW5pbSA9IEFuaW1hdGlvbih0aGlzLCBqUXVlcnkuZXh0ZW5kKHt9LCBwcm9wKSwgb3B0YWxsKTsKICAgICAgICAgIC8vIEVtcHR5IGFuaW1hdGlvbnMsIG9yIGZpbmlzaGluZyByZXNvbHZlcyBpbW1lZGlhdGVseQogICAgICAgICAgaWYgKGVtcHR5IHx8IGRhdGFfcHJpdi5nZXQodGhpcywgJ2ZpbmlzaCcpKSB7CiAgICAgICAgICAgIGFuaW0uc3RvcCh0cnVlKTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICBkb0FuaW1hdGlvbi5maW5pc2ggPSBkb0FuaW1hdGlvbjsKICAgICAgcmV0dXJuIGVtcHR5IHx8IG9wdGFsbC5xdWV1ZSA9PT0gZmFsc2UgPyB0aGlzLmVhY2goZG9BbmltYXRpb24pIDogdGhpcy5xdWV1ZShvcHRhbGwucXVldWUsIGRvQW5pbWF0aW9uKTsKICAgIH0sCiAgICBzdG9wOiBmdW5jdGlvbiAodHlwZSwgY2xlYXJRdWV1ZSwgZ290b0VuZCkgewogICAgICB2YXIgc3RvcFF1ZXVlID0gZnVuY3Rpb24gKGhvb2tzKSB7CiAgICAgICAgdmFyIHN0b3AgPSBob29rcy5zdG9wOwogICAgICAgIGRlbGV0ZSBob29rcy5zdG9wOwogICAgICAgIHN0b3AoZ290b0VuZCk7CiAgICAgIH07CiAgICAgIGlmICh0eXBlb2YgdHlwZSAhPT0gJ3N0cmluZycpIHsKICAgICAgICBnb3RvRW5kID0gY2xlYXJRdWV1ZTsKICAgICAgICBjbGVhclF1ZXVlID0gdHlwZTsKICAgICAgICB0eXBlID0gdW5kZWZpbmVkOwogICAgICB9CiAgICAgIGlmIChjbGVhclF1ZXVlICYmIHR5cGUgIT09IGZhbHNlKSB7CiAgICAgICAgdGhpcy5xdWV1ZSh0eXBlIHx8ICdmeCcsIFtdKTsKICAgICAgfQogICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgZGVxdWV1ZSA9IHRydWUsIGluZGV4ID0gdHlwZSAhPSBudWxsICYmIHR5cGUgKyAncXVldWVIb29rcycsIHRpbWVycyA9IGpRdWVyeS50aW1lcnMsIGRhdGEgPSBkYXRhX3ByaXYuZ2V0KHRoaXMpOwogICAgICAgIGlmIChpbmRleCkgewogICAgICAgICAgaWYgKGRhdGFbaW5kZXhdICYmIGRhdGFbaW5kZXhdLnN0b3ApIHsKICAgICAgICAgICAgc3RvcFF1ZXVlKGRhdGFbaW5kZXhdKTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgZm9yIChpbmRleCBpbiBkYXRhKSB7CiAgICAgICAgICAgIGlmIChkYXRhW2luZGV4XSAmJiBkYXRhW2luZGV4XS5zdG9wICYmIHJydW4udGVzdChpbmRleCkpIHsKICAgICAgICAgICAgICBzdG9wUXVldWUoZGF0YVtpbmRleF0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZvciAoaW5kZXggPSB0aW1lcnMubGVuZ3RoOyBpbmRleC0tOykgewogICAgICAgICAgaWYgKHRpbWVyc1tpbmRleF0uZWxlbSA9PT0gdGhpcyAmJiAodHlwZSA9PSBudWxsIHx8IHRpbWVyc1tpbmRleF0ucXVldWUgPT09IHR5cGUpKSB7CiAgICAgICAgICAgIHRpbWVyc1tpbmRleF0uYW5pbS5zdG9wKGdvdG9FbmQpOwogICAgICAgICAgICBkZXF1ZXVlID0gZmFsc2U7CiAgICAgICAgICAgIHRpbWVycy5zcGxpY2UoaW5kZXgsIDEpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAvLyBzdGFydCB0aGUgbmV4dCBpbiB0aGUgcXVldWUgaWYgdGhlIGxhc3Qgc3RlcCB3YXNuJ3QgZm9yY2VkCiAgICAgICAgLy8gdGltZXJzIGN1cnJlbnRseSB3aWxsIGNhbGwgdGhlaXIgY29tcGxldGUgY2FsbGJhY2tzLCB3aGljaCB3aWxsIGRlcXVldWUKICAgICAgICAvLyBidXQgb25seSBpZiB0aGV5IHdlcmUgZ290b0VuZAogICAgICAgIGlmIChkZXF1ZXVlIHx8ICFnb3RvRW5kKSB7CiAgICAgICAgICBqUXVlcnkuZGVxdWV1ZSh0aGlzLCB0eXBlKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSwKICAgIGZpbmlzaDogZnVuY3Rpb24gKHR5cGUpIHsKICAgICAgaWYgKHR5cGUgIT09IGZhbHNlKSB7CiAgICAgICAgdHlwZSA9IHR5cGUgfHwgJ2Z4JzsKICAgICAgfQogICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgaW5kZXgsIGRhdGEgPSBkYXRhX3ByaXYuZ2V0KHRoaXMpLCBxdWV1ZSA9IGRhdGFbdHlwZSArICdxdWV1ZSddLCBob29rcyA9IGRhdGFbdHlwZSArICdxdWV1ZUhvb2tzJ10sIHRpbWVycyA9IGpRdWVyeS50aW1lcnMsIGxlbmd0aCA9IHF1ZXVlID8gcXVldWUubGVuZ3RoIDogMDsKICAgICAgICAvLyBlbmFibGUgZmluaXNoaW5nIGZsYWcgb24gcHJpdmF0ZSBkYXRhCiAgICAgICAgZGF0YS5maW5pc2ggPSB0cnVlOwogICAgICAgIC8vIGVtcHR5IHRoZSBxdWV1ZSBmaXJzdAogICAgICAgIGpRdWVyeS5xdWV1ZSh0aGlzLCB0eXBlLCBbXSk7CiAgICAgICAgaWYgKGhvb2tzICYmIGhvb2tzLnN0b3ApIHsKICAgICAgICAgIGhvb2tzLnN0b3AuY2FsbCh0aGlzLCB0cnVlKTsKICAgICAgICB9CiAgICAgICAgLy8gbG9vayBmb3IgYW55IGFjdGl2ZSBhbmltYXRpb25zLCBhbmQgZmluaXNoIHRoZW0KICAgICAgICBmb3IgKGluZGV4ID0gdGltZXJzLmxlbmd0aDsgaW5kZXgtLTspIHsKICAgICAgICAgIGlmICh0aW1lcnNbaW5kZXhdLmVsZW0gPT09IHRoaXMgJiYgdGltZXJzW2luZGV4XS5xdWV1ZSA9PT0gdHlwZSkgewogICAgICAgICAgICB0aW1lcnNbaW5kZXhdLmFuaW0uc3RvcCh0cnVlKTsKICAgICAgICAgICAgdGltZXJzLnNwbGljZShpbmRleCwgMSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIC8vIGxvb2sgZm9yIGFueSBhbmltYXRpb25zIGluIHRoZSBvbGQgcXVldWUgYW5kIGZpbmlzaCB0aGVtCiAgICAgICAgZm9yIChpbmRleCA9IDA7IGluZGV4IDwgbGVuZ3RoOyBpbmRleCsrKSB7CiAgICAgICAgICBpZiAocXVldWVbaW5kZXhdICYmIHF1ZXVlW2luZGV4XS5maW5pc2gpIHsKICAgICAgICAgICAgcXVldWVbaW5kZXhdLmZpbmlzaC5jYWxsKHRoaXMpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAvLyB0dXJuIG9mZiBmaW5pc2hpbmcgZmxhZwogICAgICAgIGRlbGV0ZSBkYXRhLmZpbmlzaDsKICAgICAgfSk7CiAgICB9CiAgfSk7CiAgalF1ZXJ5LmVhY2goWwogICAgJ3RvZ2dsZScsCiAgICAnc2hvdycsCiAgICAnaGlkZScKICBdLCBmdW5jdGlvbiAoaSwgbmFtZSkgewogICAgdmFyIGNzc0ZuID0galF1ZXJ5LmZuW25hbWVdOwogICAgalF1ZXJ5LmZuW25hbWVdID0gZnVuY3Rpb24gKHNwZWVkLCBlYXNpbmcsIGNhbGxiYWNrKSB7CiAgICAgIHJldHVybiBzcGVlZCA9PSBudWxsIHx8IHR5cGVvZiBzcGVlZCA9PT0gJ2Jvb2xlYW4nID8gY3NzRm4uYXBwbHkodGhpcywgYXJndW1lbnRzKSA6IHRoaXMuYW5pbWF0ZShnZW5GeChuYW1lLCB0cnVlKSwgc3BlZWQsIGVhc2luZywgY2FsbGJhY2spOwogICAgfTsKICB9KTsKICAvLyBHZW5lcmF0ZSBzaG9ydGN1dHMgZm9yIGN1c3RvbSBhbmltYXRpb25zCiAgalF1ZXJ5LmVhY2goewogICAgc2xpZGVEb3duOiBnZW5GeCgnc2hvdycpLAogICAgc2xpZGVVcDogZ2VuRngoJ2hpZGUnKSwKICAgIHNsaWRlVG9nZ2xlOiBnZW5GeCgndG9nZ2xlJyksCiAgICBmYWRlSW46IHsgb3BhY2l0eTogJ3Nob3cnIH0sCiAgICBmYWRlT3V0OiB7IG9wYWNpdHk6ICdoaWRlJyB9LAogICAgZmFkZVRvZ2dsZTogeyBvcGFjaXR5OiAndG9nZ2xlJyB9CiAgfSwgZnVuY3Rpb24gKG5hbWUsIHByb3BzKSB7CiAgICBqUXVlcnkuZm5bbmFtZV0gPSBmdW5jdGlvbiAoc3BlZWQsIGVhc2luZywgY2FsbGJhY2spIHsKICAgICAgcmV0dXJuIHRoaXMuYW5pbWF0ZShwcm9wcywgc3BlZWQsIGVhc2luZywgY2FsbGJhY2spOwogICAgfTsKICB9KTsKICBqUXVlcnkudGltZXJzID0gW107CiAgalF1ZXJ5LmZ4LnRpY2sgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgdGltZXIsIGkgPSAwLCB0aW1lcnMgPSBqUXVlcnkudGltZXJzOwogICAgZnhOb3cgPSBqUXVlcnkubm93KCk7CiAgICBmb3IgKDsgaSA8IHRpbWVycy5sZW5ndGg7IGkrKykgewogICAgICB0aW1lciA9IHRpbWVyc1tpXTsKICAgICAgLy8gQ2hlY2tzIHRoZSB0aW1lciBoYXMgbm90IGFscmVhZHkgYmVlbiByZW1vdmVkCiAgICAgIGlmICghdGltZXIoKSAmJiB0aW1lcnNbaV0gPT09IHRpbWVyKSB7CiAgICAgICAgdGltZXJzLnNwbGljZShpLS0sIDEpOwogICAgICB9CiAgICB9CiAgICBpZiAoIXRpbWVycy5sZW5ndGgpIHsKICAgICAgalF1ZXJ5LmZ4LnN0b3AoKTsKICAgIH0KICAgIGZ4Tm93ID0gdW5kZWZpbmVkOwogIH07CiAgalF1ZXJ5LmZ4LnRpbWVyID0gZnVuY3Rpb24gKHRpbWVyKSB7CiAgICBqUXVlcnkudGltZXJzLnB1c2godGltZXIpOwogICAgaWYgKHRpbWVyKCkpIHsKICAgICAgalF1ZXJ5LmZ4LnN0YXJ0KCk7CiAgICB9IGVsc2UgewogICAgICBqUXVlcnkudGltZXJzLnBvcCgpOwogICAgfQogIH07CiAgalF1ZXJ5LmZ4LmludGVydmFsID0gMTM7CiAgalF1ZXJ5LmZ4LnN0YXJ0ID0gZnVuY3Rpb24gKCkgewogICAgaWYgKCF0aW1lcklkKSB7CiAgICAgIHRpbWVySWQgPSBzZXRJbnRlcnZhbChqUXVlcnkuZngudGljaywgalF1ZXJ5LmZ4LmludGVydmFsKTsKICAgIH0KICB9OwogIGpRdWVyeS5meC5zdG9wID0gZnVuY3Rpb24gKCkgewogICAgY2xlYXJJbnRlcnZhbCh0aW1lcklkKTsKICAgIHRpbWVySWQgPSBudWxsOwogIH07CiAgalF1ZXJ5LmZ4LnNwZWVkcyA9IHsKICAgIHNsb3c6IDYwMCwKICAgIGZhc3Q6IDIwMCwKICAgIC8vIERlZmF1bHQgc3BlZWQKICAgIF9kZWZhdWx0OiA0MDAKICB9OwogIC8vIEJhc2VkIG9mZiBvZiB0aGUgcGx1Z2luIGJ5IENsaW50IEhlbGZlcnMsIHdpdGggcGVybWlzc2lvbi4KICAvLyBodHRwOi8vYmxpbmRzaWduYWxzLmNvbS9pbmRleC5waHAvMjAwOS8wNy9qcXVlcnktZGVsYXkvCiAgalF1ZXJ5LmZuLmRlbGF5ID0gZnVuY3Rpb24gKHRpbWUsIHR5cGUpIHsKICAgIHRpbWUgPSBqUXVlcnkuZnggPyBqUXVlcnkuZnguc3BlZWRzW3RpbWVdIHx8IHRpbWUgOiB0aW1lOwogICAgdHlwZSA9IHR5cGUgfHwgJ2Z4JzsKICAgIHJldHVybiB0aGlzLnF1ZXVlKHR5cGUsIGZ1bmN0aW9uIChuZXh0LCBob29rcykgewogICAgICB2YXIgdGltZW91dCA9IHNldFRpbWVvdXQobmV4dCwgdGltZSk7CiAgICAgIGhvb2tzLnN0b3AgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgY2xlYXJUaW1lb3V0KHRpbWVvdXQpOwogICAgICB9OwogICAgfSk7CiAgfTsKICAoZnVuY3Rpb24gKCkgewogICAgdmFyIGlucHV0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnaW5wdXQnKSwgc2VsZWN0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc2VsZWN0JyksIG9wdCA9IHNlbGVjdC5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdvcHRpb24nKSk7CiAgICBpbnB1dC50eXBlID0gJ2NoZWNrYm94JzsKICAgIC8vIFN1cHBvcnQ6IGlPUyA1LjEsIEFuZHJvaWQgNC54LCBBbmRyb2lkIDIuMwogICAgLy8gQ2hlY2sgdGhlIGRlZmF1bHQgY2hlY2tib3gvcmFkaW8gdmFsdWUgKCIiIG9uIG9sZCBXZWJLaXQ7ICJvbiIgZWxzZXdoZXJlKQogICAgc3VwcG9ydC5jaGVja09uID0gaW5wdXQudmFsdWUgIT09ICcnOwogICAgLy8gTXVzdCBhY2Nlc3MgdGhlIHBhcmVudCB0byBtYWtlIGFuIG9wdGlvbiBzZWxlY3QgcHJvcGVybHkKICAgIC8vIFN1cHBvcnQ6IElFOSwgSUUxMAogICAgc3VwcG9ydC5vcHRTZWxlY3RlZCA9IG9wdC5zZWxlY3RlZDsKICAgIC8vIE1ha2Ugc3VyZSB0aGF0IHRoZSBvcHRpb25zIGluc2lkZSBkaXNhYmxlZCBzZWxlY3RzIGFyZW4ndCBtYXJrZWQgYXMgZGlzYWJsZWQKICAgIC8vIChXZWJLaXQgbWFya3MgdGhlbSBhcyBkaXNhYmxlZCkKICAgIHNlbGVjdC5kaXNhYmxlZCA9IHRydWU7CiAgICBzdXBwb3J0Lm9wdERpc2FibGVkID0gIW9wdC5kaXNhYmxlZDsKICAgIC8vIENoZWNrIGlmIGFuIGlucHV0IG1haW50YWlucyBpdHMgdmFsdWUgYWZ0ZXIgYmVjb21pbmcgYSByYWRpbwogICAgLy8gU3VwcG9ydDogSUU5LCBJRTEwCiAgICBpbnB1dCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2lucHV0Jyk7CiAgICBpbnB1dC52YWx1ZSA9ICd0JzsKICAgIGlucHV0LnR5cGUgPSAncmFkaW8nOwogICAgc3VwcG9ydC5yYWRpb1ZhbHVlID0gaW5wdXQudmFsdWUgPT09ICd0JzsKICB9KCkpOwogIHZhciBub2RlSG9vaywgYm9vbEhvb2ssIGF0dHJIYW5kbGUgPSBqUXVlcnkuZXhwci5hdHRySGFuZGxlOwogIGpRdWVyeS5mbi5leHRlbmQoewogICAgYXR0cjogZnVuY3Rpb24gKG5hbWUsIHZhbHVlKSB7CiAgICAgIHJldHVybiBhY2Nlc3ModGhpcywgalF1ZXJ5LmF0dHIsIG5hbWUsIHZhbHVlLCBhcmd1bWVudHMubGVuZ3RoID4gMSk7CiAgICB9LAogICAgcmVtb3ZlQXR0cjogZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgalF1ZXJ5LnJlbW92ZUF0dHIodGhpcywgbmFtZSk7CiAgICAgIH0pOwogICAgfQogIH0pOwogIGpRdWVyeS5leHRlbmQoewogICAgYXR0cjogZnVuY3Rpb24gKGVsZW0sIG5hbWUsIHZhbHVlKSB7CiAgICAgIHZhciBob29rcywgcmV0LCBuVHlwZSA9IGVsZW0ubm9kZVR5cGU7CiAgICAgIC8vIGRvbid0IGdldC9zZXQgYXR0cmlidXRlcyBvbiB0ZXh0LCBjb21tZW50IGFuZCBhdHRyaWJ1dGUgbm9kZXMKICAgICAgaWYgKCFlbGVtIHx8IG5UeXBlID09PSAzIHx8IG5UeXBlID09PSA4IHx8IG5UeXBlID09PSAyKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIC8vIEZhbGxiYWNrIHRvIHByb3Agd2hlbiBhdHRyaWJ1dGVzIGFyZSBub3Qgc3VwcG9ydGVkCiAgICAgIGlmICh0eXBlb2YgZWxlbS5nZXRBdHRyaWJ1dGUgPT09IHN0cnVuZGVmaW5lZCkgewogICAgICAgIHJldHVybiBqUXVlcnkucHJvcChlbGVtLCBuYW1lLCB2YWx1ZSk7CiAgICAgIH0KICAgICAgLy8gQWxsIGF0dHJpYnV0ZXMgYXJlIGxvd2VyY2FzZQogICAgICAvLyBHcmFiIG5lY2Vzc2FyeSBob29rIGlmIG9uZSBpcyBkZWZpbmVkCiAgICAgIGlmIChuVHlwZSAhPT0gMSB8fCAhalF1ZXJ5LmlzWE1MRG9jKGVsZW0pKSB7CiAgICAgICAgbmFtZSA9IG5hbWUudG9Mb3dlckNhc2UoKTsKICAgICAgICBob29rcyA9IGpRdWVyeS5hdHRySG9va3NbbmFtZV0gfHwgKGpRdWVyeS5leHByLm1hdGNoLmJvb2wudGVzdChuYW1lKSA/IGJvb2xIb29rIDogbm9kZUhvb2spOwogICAgICB9CiAgICAgIGlmICh2YWx1ZSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgaWYgKHZhbHVlID09PSBudWxsKSB7CiAgICAgICAgICBqUXVlcnkucmVtb3ZlQXR0cihlbGVtLCBuYW1lKTsKICAgICAgICB9IGVsc2UgaWYgKGhvb2tzICYmICdzZXQnIGluIGhvb2tzICYmIChyZXQgPSBob29rcy5zZXQoZWxlbSwgdmFsdWUsIG5hbWUpKSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICByZXR1cm4gcmV0OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBlbGVtLnNldEF0dHJpYnV0ZShuYW1lLCB2YWx1ZSArICcnKTsKICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICB9CiAgICAgIH0gZWxzZSBpZiAoaG9va3MgJiYgJ2dldCcgaW4gaG9va3MgJiYgKHJldCA9IGhvb2tzLmdldChlbGVtLCBuYW1lKSkgIT09IG51bGwpIHsKICAgICAgICByZXR1cm4gcmV0OwogICAgICB9IGVsc2UgewogICAgICAgIHJldCA9IGpRdWVyeS5maW5kLmF0dHIoZWxlbSwgbmFtZSk7CiAgICAgICAgLy8gTm9uLWV4aXN0ZW50IGF0dHJpYnV0ZXMgcmV0dXJuIG51bGwsIHdlIG5vcm1hbGl6ZSB0byB1bmRlZmluZWQKICAgICAgICByZXR1cm4gcmV0ID09IG51bGwgPyB1bmRlZmluZWQgOiByZXQ7CiAgICAgIH0KICAgIH0sCiAgICByZW1vdmVBdHRyOiBmdW5jdGlvbiAoZWxlbSwgdmFsdWUpIHsKICAgICAgdmFyIG5hbWUsIHByb3BOYW1lLCBpID0gMCwgYXR0ck5hbWVzID0gdmFsdWUgJiYgdmFsdWUubWF0Y2gocm5vdHdoaXRlKTsKICAgICAgaWYgKGF0dHJOYW1lcyAmJiBlbGVtLm5vZGVUeXBlID09PSAxKSB7CiAgICAgICAgd2hpbGUgKG5hbWUgPSBhdHRyTmFtZXNbaSsrXSkgewogICAgICAgICAgcHJvcE5hbWUgPSBqUXVlcnkucHJvcEZpeFtuYW1lXSB8fCBuYW1lOwogICAgICAgICAgLy8gQm9vbGVhbiBhdHRyaWJ1dGVzIGdldCBzcGVjaWFsIHRyZWF0bWVudCAoIzEwODcwKQogICAgICAgICAgaWYgKGpRdWVyeS5leHByLm1hdGNoLmJvb2wudGVzdChuYW1lKSkgewogICAgICAgICAgICAvLyBTZXQgY29ycmVzcG9uZGluZyBwcm9wZXJ0eSB0byBmYWxzZQogICAgICAgICAgICBlbGVtW3Byb3BOYW1lXSA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgZWxlbS5yZW1vdmVBdHRyaWJ1dGUobmFtZSk7CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgYXR0ckhvb2tzOiB7CiAgICAgIHR5cGU6IHsKICAgICAgICBzZXQ6IGZ1bmN0aW9uIChlbGVtLCB2YWx1ZSkgewogICAgICAgICAgaWYgKCFzdXBwb3J0LnJhZGlvVmFsdWUgJiYgdmFsdWUgPT09ICdyYWRpbycgJiYgalF1ZXJ5Lm5vZGVOYW1lKGVsZW0sICdpbnB1dCcpKSB7CiAgICAgICAgICAgIC8vIFNldHRpbmcgdGhlIHR5cGUgb24gYSByYWRpbyBidXR0b24gYWZ0ZXIgdGhlIHZhbHVlIHJlc2V0cyB0aGUgdmFsdWUgaW4gSUU2LTkKICAgICAgICAgICAgLy8gUmVzZXQgdmFsdWUgdG8gZGVmYXVsdCBpbiBjYXNlIHR5cGUgaXMgc2V0IGFmdGVyIHZhbHVlIGR1cmluZyBjcmVhdGlvbgogICAgICAgICAgICB2YXIgdmFsID0gZWxlbS52YWx1ZTsKICAgICAgICAgICAgZWxlbS5zZXRBdHRyaWJ1dGUoJ3R5cGUnLCB2YWx1ZSk7CiAgICAgICAgICAgIGlmICh2YWwpIHsKICAgICAgICAgICAgICBlbGVtLnZhbHVlID0gdmFsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9KTsKICAvLyBIb29rcyBmb3IgYm9vbGVhbiBhdHRyaWJ1dGVzCiAgYm9vbEhvb2sgPSB7CiAgICBzZXQ6IGZ1bmN0aW9uIChlbGVtLCB2YWx1ZSwgbmFtZSkgewogICAgICBpZiAodmFsdWUgPT09IGZhbHNlKSB7CiAgICAgICAgLy8gUmVtb3ZlIGJvb2xlYW4gYXR0cmlidXRlcyB3aGVuIHNldCB0byBmYWxzZQogICAgICAgIGpRdWVyeS5yZW1vdmVBdHRyKGVsZW0sIG5hbWUpOwogICAgICB9IGVsc2UgewogICAgICAgIGVsZW0uc2V0QXR0cmlidXRlKG5hbWUsIG5hbWUpOwogICAgICB9CiAgICAgIHJldHVybiBuYW1lOwogICAgfQogIH07CiAgalF1ZXJ5LmVhY2goalF1ZXJ5LmV4cHIubWF0Y2guYm9vbC5zb3VyY2UubWF0Y2goL1x3Ky9nKSwgZnVuY3Rpb24gKGksIG5hbWUpIHsKICAgIHZhciBnZXR0ZXIgPSBhdHRySGFuZGxlW25hbWVdIHx8IGpRdWVyeS5maW5kLmF0dHI7CiAgICBhdHRySGFuZGxlW25hbWVdID0gZnVuY3Rpb24gKGVsZW0sIG5hbWUsIGlzWE1MKSB7CiAgICAgIHZhciByZXQsIGhhbmRsZTsKICAgICAgaWYgKCFpc1hNTCkgewogICAgICAgIC8vIEF2b2lkIGFuIGluZmluaXRlIGxvb3AgYnkgdGVtcG9yYXJpbHkgcmVtb3ZpbmcgdGhpcyBmdW5jdGlvbiBmcm9tIHRoZSBnZXR0ZXIKICAgICAgICBoYW5kbGUgPSBhdHRySGFuZGxlW25hbWVdOwogICAgICAgIGF0dHJIYW5kbGVbbmFtZV0gPSByZXQ7CiAgICAgICAgcmV0ID0gZ2V0dGVyKGVsZW0sIG5hbWUsIGlzWE1MKSAhPSBudWxsID8gbmFtZS50b0xvd2VyQ2FzZSgpIDogbnVsbDsKICAgICAgICBhdHRySGFuZGxlW25hbWVdID0gaGFuZGxlOwogICAgICB9CiAgICAgIHJldHVybiByZXQ7CiAgICB9OwogIH0pOwogIHZhciByZm9jdXNhYmxlID0gL14oPzppbnB1dHxzZWxlY3R8dGV4dGFyZWF8YnV0dG9uKSQvaTsKICBqUXVlcnkuZm4uZXh0ZW5kKHsKICAgIHByb3A6IGZ1bmN0aW9uIChuYW1lLCB2YWx1ZSkgewogICAgICByZXR1cm4gYWNjZXNzKHRoaXMsIGpRdWVyeS5wcm9wLCBuYW1lLCB2YWx1ZSwgYXJndW1lbnRzLmxlbmd0aCA+IDEpOwogICAgfSwKICAgIHJlbW92ZVByb3A6IGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24gKCkgewogICAgICAgIGRlbGV0ZSB0aGlzW2pRdWVyeS5wcm9wRml4W25hbWVdIHx8IG5hbWVdOwogICAgICB9KTsKICAgIH0KICB9KTsKICBqUXVlcnkuZXh0ZW5kKHsKICAgIHByb3BGaXg6IHsKICAgICAgJ2Zvcic6ICdodG1sRm9yJywKICAgICAgJ2NsYXNzJzogJ2NsYXNzTmFtZScKICAgIH0sCiAgICBwcm9wOiBmdW5jdGlvbiAoZWxlbSwgbmFtZSwgdmFsdWUpIHsKICAgICAgdmFyIHJldCwgaG9va3MsIG5vdHhtbCwgblR5cGUgPSBlbGVtLm5vZGVUeXBlOwogICAgICAvLyBkb24ndCBnZXQvc2V0IHByb3BlcnRpZXMgb24gdGV4dCwgY29tbWVudCBhbmQgYXR0cmlidXRlIG5vZGVzCiAgICAgIGlmICghZWxlbSB8fCBuVHlwZSA9PT0gMyB8fCBuVHlwZSA9PT0gOCB8fCBuVHlwZSA9PT0gMikgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBub3R4bWwgPSBuVHlwZSAhPT0gMSB8fCAhalF1ZXJ5LmlzWE1MRG9jKGVsZW0pOwogICAgICBpZiAobm90eG1sKSB7CiAgICAgICAgLy8gRml4IG5hbWUgYW5kIGF0dGFjaCBob29rcwogICAgICAgIG5hbWUgPSBqUXVlcnkucHJvcEZpeFtuYW1lXSB8fCBuYW1lOwogICAgICAgIGhvb2tzID0galF1ZXJ5LnByb3BIb29rc1tuYW1lXTsKICAgICAgfQogICAgICBpZiAodmFsdWUgIT09IHVuZGVmaW5lZCkgewogICAgICAgIHJldHVybiBob29rcyAmJiAnc2V0JyBpbiBob29rcyAmJiAocmV0ID0gaG9va3Muc2V0KGVsZW0sIHZhbHVlLCBuYW1lKSkgIT09IHVuZGVmaW5lZCA/IHJldCA6IGVsZW1bbmFtZV0gPSB2YWx1ZTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gaG9va3MgJiYgJ2dldCcgaW4gaG9va3MgJiYgKHJldCA9IGhvb2tzLmdldChlbGVtLCBuYW1lKSkgIT09IG51bGwgPyByZXQgOiBlbGVtW25hbWVdOwogICAgICB9CiAgICB9LAogICAgcHJvcEhvb2tzOiB7CiAgICAgIHRhYkluZGV4OiB7CiAgICAgICAgZ2V0OiBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgcmV0dXJuIGVsZW0uaGFzQXR0cmlidXRlKCd0YWJpbmRleCcpIHx8IHJmb2N1c2FibGUudGVzdChlbGVtLm5vZGVOYW1lKSB8fCBlbGVtLmhyZWYgPyBlbGVtLnRhYkluZGV4IDogLTE7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfSk7CiAgLy8gU3VwcG9ydDogSUU5KwogIC8vIFNlbGVjdGVkbmVzcyBmb3IgYW4gb3B0aW9uIGluIGFuIG9wdGdyb3VwIGNhbiBiZSBpbmFjY3VyYXRlCiAgaWYgKCFzdXBwb3J0Lm9wdFNlbGVjdGVkKSB7CiAgICBqUXVlcnkucHJvcEhvb2tzLnNlbGVjdGVkID0gewogICAgICBnZXQ6IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgdmFyIHBhcmVudCA9IGVsZW0ucGFyZW50Tm9kZTsKICAgICAgICBpZiAocGFyZW50ICYmIHBhcmVudC5wYXJlbnROb2RlKSB7CiAgICAgICAgICBwYXJlbnQucGFyZW50Tm9kZS5zZWxlY3RlZEluZGV4OwogICAgICAgIH0KICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgfQogICAgfTsKICB9CiAgalF1ZXJ5LmVhY2goWwogICAgJ3RhYkluZGV4JywKICAgICdyZWFkT25seScsCiAgICAnbWF4TGVuZ3RoJywKICAgICdjZWxsU3BhY2luZycsCiAgICAnY2VsbFBhZGRpbmcnLAogICAgJ3Jvd1NwYW4nLAogICAgJ2NvbFNwYW4nLAogICAgJ3VzZU1hcCcsCiAgICAnZnJhbWVCb3JkZXInLAogICAgJ2NvbnRlbnRFZGl0YWJsZScKICBdLCBmdW5jdGlvbiAoKSB7CiAgICBqUXVlcnkucHJvcEZpeFt0aGlzLnRvTG93ZXJDYXNlKCldID0gdGhpczsKICB9KTsKICB2YXIgcmNsYXNzID0gL1tcdFxyXG5cZl0vZzsKICBqUXVlcnkuZm4uZXh0ZW5kKHsKICAgIGFkZENsYXNzOiBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgdmFyIGNsYXNzZXMsIGVsZW0sIGN1ciwgY2xhenosIGosIGZpbmFsVmFsdWUsIHByb2NlZWQgPSB0eXBlb2YgdmFsdWUgPT09ICdzdHJpbmcnICYmIHZhbHVlLCBpID0gMCwgbGVuID0gdGhpcy5sZW5ndGg7CiAgICAgIGlmIChqUXVlcnkuaXNGdW5jdGlvbih2YWx1ZSkpIHsKICAgICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uIChqKSB7CiAgICAgICAgICBqUXVlcnkodGhpcykuYWRkQ2xhc3ModmFsdWUuY2FsbCh0aGlzLCBqLCB0aGlzLmNsYXNzTmFtZSkpOwogICAgICAgIH0pOwogICAgICB9CiAgICAgIGlmIChwcm9jZWVkKSB7CiAgICAgICAgLy8gVGhlIGRpc2p1bmN0aW9uIGhlcmUgaXMgZm9yIGJldHRlciBjb21wcmVzc2liaWxpdHkgKHNlZSByZW1vdmVDbGFzcykKICAgICAgICBjbGFzc2VzID0gKHZhbHVlIHx8ICcnKS5tYXRjaChybm90d2hpdGUpIHx8IFtdOwogICAgICAgIGZvciAoOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgIGVsZW0gPSB0aGlzW2ldOwogICAgICAgICAgY3VyID0gZWxlbS5ub2RlVHlwZSA9PT0gMSAmJiAoZWxlbS5jbGFzc05hbWUgPyAoJyAnICsgZWxlbS5jbGFzc05hbWUgKyAnICcpLnJlcGxhY2UocmNsYXNzLCAnICcpIDogJyAnKTsKICAgICAgICAgIGlmIChjdXIpIHsKICAgICAgICAgICAgaiA9IDA7CiAgICAgICAgICAgIHdoaWxlIChjbGF6eiA9IGNsYXNzZXNbaisrXSkgewogICAgICAgICAgICAgIGlmIChjdXIuaW5kZXhPZignICcgKyBjbGF6eiArICcgJykgPCAwKSB7CiAgICAgICAgICAgICAgICBjdXIgKz0gY2xhenogKyAnICc7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIG9ubHkgYXNzaWduIGlmIGRpZmZlcmVudCB0byBhdm9pZCB1bm5lZWRlZCByZW5kZXJpbmcuCiAgICAgICAgICAgIGZpbmFsVmFsdWUgPSBqUXVlcnkudHJpbShjdXIpOwogICAgICAgICAgICBpZiAoZWxlbS5jbGFzc05hbWUgIT09IGZpbmFsVmFsdWUpIHsKICAgICAgICAgICAgICBlbGVtLmNsYXNzTmFtZSA9IGZpbmFsVmFsdWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogICAgcmVtb3ZlQ2xhc3M6IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICB2YXIgY2xhc3NlcywgZWxlbSwgY3VyLCBjbGF6eiwgaiwgZmluYWxWYWx1ZSwgcHJvY2VlZCA9IGFyZ3VtZW50cy5sZW5ndGggPT09IDAgfHwgdHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJyAmJiB2YWx1ZSwgaSA9IDAsIGxlbiA9IHRoaXMubGVuZ3RoOwogICAgICBpZiAoalF1ZXJ5LmlzRnVuY3Rpb24odmFsdWUpKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoaikgewogICAgICAgICAgalF1ZXJ5KHRoaXMpLnJlbW92ZUNsYXNzKHZhbHVlLmNhbGwodGhpcywgaiwgdGhpcy5jbGFzc05hbWUpKTsKICAgICAgICB9KTsKICAgICAgfQogICAgICBpZiAocHJvY2VlZCkgewogICAgICAgIGNsYXNzZXMgPSAodmFsdWUgfHwgJycpLm1hdGNoKHJub3R3aGl0ZSkgfHwgW107CiAgICAgICAgZm9yICg7IGkgPCBsZW47IGkrKykgewogICAgICAgICAgZWxlbSA9IHRoaXNbaV07CiAgICAgICAgICAvLyBUaGlzIGV4cHJlc3Npb24gaXMgaGVyZSBmb3IgYmV0dGVyIGNvbXByZXNzaWJpbGl0eSAoc2VlIGFkZENsYXNzKQogICAgICAgICAgY3VyID0gZWxlbS5ub2RlVHlwZSA9PT0gMSAmJiAoZWxlbS5jbGFzc05hbWUgPyAoJyAnICsgZWxlbS5jbGFzc05hbWUgKyAnICcpLnJlcGxhY2UocmNsYXNzLCAnICcpIDogJycpOwogICAgICAgICAgaWYgKGN1cikgewogICAgICAgICAgICBqID0gMDsKICAgICAgICAgICAgd2hpbGUgKGNsYXp6ID0gY2xhc3Nlc1tqKytdKSB7CiAgICAgICAgICAgICAgLy8gUmVtb3ZlICphbGwqIGluc3RhbmNlcwogICAgICAgICAgICAgIHdoaWxlIChjdXIuaW5kZXhPZignICcgKyBjbGF6eiArICcgJykgPj0gMCkgewogICAgICAgICAgICAgICAgY3VyID0gY3VyLnJlcGxhY2UoJyAnICsgY2xhenogKyAnICcsICcgJyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIG9ubHkgYXNzaWduIGlmIGRpZmZlcmVudCB0byBhdm9pZCB1bm5lZWRlZCByZW5kZXJpbmcuCiAgICAgICAgICAgIGZpbmFsVmFsdWUgPSB2YWx1ZSA/IGpRdWVyeS50cmltKGN1cikgOiAnJzsKICAgICAgICAgICAgaWYgKGVsZW0uY2xhc3NOYW1lICE9PSBmaW5hbFZhbHVlKSB7CiAgICAgICAgICAgICAgZWxlbS5jbGFzc05hbWUgPSBmaW5hbFZhbHVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAgIHRvZ2dsZUNsYXNzOiBmdW5jdGlvbiAodmFsdWUsIHN0YXRlVmFsKSB7CiAgICAgIHZhciB0eXBlID0gdHlwZW9mIHZhbHVlOwogICAgICBpZiAodHlwZW9mIHN0YXRlVmFsID09PSAnYm9vbGVhbicgJiYgdHlwZSA9PT0gJ3N0cmluZycpIHsKICAgICAgICByZXR1cm4gc3RhdGVWYWwgPyB0aGlzLmFkZENsYXNzKHZhbHVlKSA6IHRoaXMucmVtb3ZlQ2xhc3ModmFsdWUpOwogICAgICB9CiAgICAgIGlmIChqUXVlcnkuaXNGdW5jdGlvbih2YWx1ZSkpIHsKICAgICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uIChpKSB7CiAgICAgICAgICBqUXVlcnkodGhpcykudG9nZ2xlQ2xhc3ModmFsdWUuY2FsbCh0aGlzLCBpLCB0aGlzLmNsYXNzTmFtZSwgc3RhdGVWYWwpLCBzdGF0ZVZhbCk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgaWYgKHR5cGUgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAvLyB0b2dnbGUgaW5kaXZpZHVhbCBjbGFzcyBuYW1lcwogICAgICAgICAgdmFyIGNsYXNzTmFtZSwgaSA9IDAsIHNlbGYgPSBqUXVlcnkodGhpcyksIGNsYXNzTmFtZXMgPSB2YWx1ZS5tYXRjaChybm90d2hpdGUpIHx8IFtdOwogICAgICAgICAgd2hpbGUgKGNsYXNzTmFtZSA9IGNsYXNzTmFtZXNbaSsrXSkgewogICAgICAgICAgICAvLyBjaGVjayBlYWNoIGNsYXNzTmFtZSBnaXZlbiwgc3BhY2Ugc2VwYXJhdGVkIGxpc3QKICAgICAgICAgICAgaWYgKHNlbGYuaGFzQ2xhc3MoY2xhc3NOYW1lKSkgewogICAgICAgICAgICAgIHNlbGYucmVtb3ZlQ2xhc3MoY2xhc3NOYW1lKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBzZWxmLmFkZENsYXNzKGNsYXNzTmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gIC8vIFRvZ2dsZSB3aG9sZSBjbGFzcyBuYW1lCiAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSBzdHJ1bmRlZmluZWQgfHwgdHlwZSA9PT0gJ2Jvb2xlYW4nKSB7CiAgICAgICAgICBpZiAodGhpcy5jbGFzc05hbWUpIHsKICAgICAgICAgICAgLy8gc3RvcmUgY2xhc3NOYW1lIGlmIHNldAogICAgICAgICAgICBkYXRhX3ByaXYuc2V0KHRoaXMsICdfX2NsYXNzTmFtZV9fJywgdGhpcy5jbGFzc05hbWUpOwogICAgICAgICAgfQogICAgICAgICAgLy8gSWYgdGhlIGVsZW1lbnQgaGFzIGEgY2xhc3MgbmFtZSBvciBpZiB3ZSdyZSBwYXNzZWQgImZhbHNlIiwKICAgICAgICAgIC8vIHRoZW4gcmVtb3ZlIHRoZSB3aG9sZSBjbGFzc25hbWUgKGlmIHRoZXJlIHdhcyBvbmUsIHRoZSBhYm92ZSBzYXZlZCBpdCkuCiAgICAgICAgICAvLyBPdGhlcndpc2UgYnJpbmcgYmFjayB3aGF0ZXZlciB3YXMgcHJldmlvdXNseSBzYXZlZCAoaWYgYW55dGhpbmcpLAogICAgICAgICAgLy8gZmFsbGluZyBiYWNrIHRvIHRoZSBlbXB0eSBzdHJpbmcgaWYgbm90aGluZyB3YXMgc3RvcmVkLgogICAgICAgICAgdGhpcy5jbGFzc05hbWUgPSB0aGlzLmNsYXNzTmFtZSB8fCB2YWx1ZSA9PT0gZmFsc2UgPyAnJyA6IGRhdGFfcHJpdi5nZXQodGhpcywgJ19fY2xhc3NOYW1lX18nKSB8fCAnJzsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSwKICAgIGhhc0NsYXNzOiBmdW5jdGlvbiAoc2VsZWN0b3IpIHsKICAgICAgdmFyIGNsYXNzTmFtZSA9ICcgJyArIHNlbGVjdG9yICsgJyAnLCBpID0gMCwgbCA9IHRoaXMubGVuZ3RoOwogICAgICBmb3IgKDsgaSA8IGw7IGkrKykgewogICAgICAgIGlmICh0aGlzW2ldLm5vZGVUeXBlID09PSAxICYmICgnICcgKyB0aGlzW2ldLmNsYXNzTmFtZSArICcgJykucmVwbGFjZShyY2xhc3MsICcgJykuaW5kZXhPZihjbGFzc05hbWUpID49IDApIHsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgfSk7CiAgdmFyIHJyZXR1cm4gPSAvXHIvZzsKICBqUXVlcnkuZm4uZXh0ZW5kKHsKICAgIHZhbDogZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgIHZhciBob29rcywgcmV0LCBpc0Z1bmN0aW9uLCBlbGVtID0gdGhpc1swXTsKICAgICAgaWYgKCFhcmd1bWVudHMubGVuZ3RoKSB7CiAgICAgICAgaWYgKGVsZW0pIHsKICAgICAgICAgIGhvb2tzID0galF1ZXJ5LnZhbEhvb2tzW2VsZW0udHlwZV0gfHwgalF1ZXJ5LnZhbEhvb2tzW2VsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKV07CiAgICAgICAgICBpZiAoaG9va3MgJiYgJ2dldCcgaW4gaG9va3MgJiYgKHJldCA9IGhvb2tzLmdldChlbGVtLCAndmFsdWUnKSkgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICByZXR1cm4gcmV0OwogICAgICAgICAgfQogICAgICAgICAgcmV0ID0gZWxlbS52YWx1ZTsKICAgICAgICAgIHJldHVybiB0eXBlb2YgcmV0ID09PSAnc3RyaW5nJyA/IC8vIGhhbmRsZSBtb3N0IGNvbW1vbiBzdHJpbmcgY2FzZXMKICAgICAgICAgIHJldC5yZXBsYWNlKHJyZXR1cm4sICcnKSA6IC8vIGhhbmRsZSBjYXNlcyB3aGVyZSB2YWx1ZSBpcyBudWxsL3VuZGVmIG9yIG51bWJlcgogICAgICAgICAgcmV0ID09IG51bGwgPyAnJyA6IHJldDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIGlzRnVuY3Rpb24gPSBqUXVlcnkuaXNGdW5jdGlvbih2YWx1ZSk7CiAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24gKGkpIHsKICAgICAgICB2YXIgdmFsOwogICAgICAgIGlmICh0aGlzLm5vZGVUeXBlICE9PSAxKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGlmIChpc0Z1bmN0aW9uKSB7CiAgICAgICAgICB2YWwgPSB2YWx1ZS5jYWxsKHRoaXMsIGksIGpRdWVyeSh0aGlzKS52YWwoKSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHZhbCA9IHZhbHVlOwogICAgICAgIH0KICAgICAgICAvLyBUcmVhdCBudWxsL3VuZGVmaW5lZCBhcyAiIjsgY29udmVydCBudW1iZXJzIHRvIHN0cmluZwogICAgICAgIGlmICh2YWwgPT0gbnVsbCkgewogICAgICAgICAgdmFsID0gJyc7CiAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgdmFsID09PSAnbnVtYmVyJykgewogICAgICAgICAgdmFsICs9ICcnOwogICAgICAgIH0gZWxzZSBpZiAoalF1ZXJ5LmlzQXJyYXkodmFsKSkgewogICAgICAgICAgdmFsID0galF1ZXJ5Lm1hcCh2YWwsIGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICByZXR1cm4gdmFsdWUgPT0gbnVsbCA/ICcnIDogdmFsdWUgKyAnJzsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBob29rcyA9IGpRdWVyeS52YWxIb29rc1t0aGlzLnR5cGVdIHx8IGpRdWVyeS52YWxIb29rc1t0aGlzLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCldOwogICAgICAgIC8vIElmIHNldCByZXR1cm5zIHVuZGVmaW5lZCwgZmFsbCBiYWNrIHRvIG5vcm1hbCBzZXR0aW5nCiAgICAgICAgaWYgKCFob29rcyB8fCAhKCdzZXQnIGluIGhvb2tzKSB8fCBob29rcy5zZXQodGhpcywgdmFsLCAndmFsdWUnKSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICB0aGlzLnZhbHVlID0gdmFsOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgfSk7CiAgalF1ZXJ5LmV4dGVuZCh7CiAgICB2YWxIb29rczogewogICAgICBvcHRpb246IHsKICAgICAgICBnZXQ6IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgICB2YXIgdmFsID0galF1ZXJ5LmZpbmQuYXR0cihlbGVtLCAndmFsdWUnKTsKICAgICAgICAgIHJldHVybiB2YWwgIT0gbnVsbCA/IHZhbCA6IC8vIFN1cHBvcnQ6IElFMTAtMTErCiAgICAgICAgICAvLyBvcHRpb24udGV4dCB0aHJvd3MgZXhjZXB0aW9ucyAoIzE0Njg2LCAjMTQ4NTgpCiAgICAgICAgICBqUXVlcnkudHJpbShqUXVlcnkudGV4dChlbGVtKSk7CiAgICAgICAgfQogICAgICB9LAogICAgICBzZWxlY3Q6IHsKICAgICAgICBnZXQ6IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgICB2YXIgdmFsdWUsIG9wdGlvbiwgb3B0aW9ucyA9IGVsZW0ub3B0aW9ucywgaW5kZXggPSBlbGVtLnNlbGVjdGVkSW5kZXgsIG9uZSA9IGVsZW0udHlwZSA9PT0gJ3NlbGVjdC1vbmUnIHx8IGluZGV4IDwgMCwgdmFsdWVzID0gb25lID8gbnVsbCA6IFtdLCBtYXggPSBvbmUgPyBpbmRleCArIDEgOiBvcHRpb25zLmxlbmd0aCwgaSA9IGluZGV4IDwgMCA/IG1heCA6IG9uZSA/IGluZGV4IDogMDsKICAgICAgICAgIC8vIExvb3AgdGhyb3VnaCBhbGwgdGhlIHNlbGVjdGVkIG9wdGlvbnMKICAgICAgICAgIGZvciAoOyBpIDwgbWF4OyBpKyspIHsKICAgICAgICAgICAgb3B0aW9uID0gb3B0aW9uc1tpXTsKICAgICAgICAgICAgLy8gSUU2LTkgZG9lc24ndCB1cGRhdGUgc2VsZWN0ZWQgYWZ0ZXIgZm9ybSByZXNldCAoIzI1NTEpCiAgICAgICAgICAgIGlmICgob3B0aW9uLnNlbGVjdGVkIHx8IGkgPT09IGluZGV4KSAmJiAoc3VwcG9ydC5vcHREaXNhYmxlZCA/ICFvcHRpb24uZGlzYWJsZWQgOiBvcHRpb24uZ2V0QXR0cmlidXRlKCdkaXNhYmxlZCcpID09PSBudWxsKSAmJiAoIW9wdGlvbi5wYXJlbnROb2RlLmRpc2FibGVkIHx8ICFqUXVlcnkubm9kZU5hbWUob3B0aW9uLnBhcmVudE5vZGUsICdvcHRncm91cCcpKSkgewogICAgICAgICAgICAgIC8vIEdldCB0aGUgc3BlY2lmaWMgdmFsdWUgZm9yIHRoZSBvcHRpb24KICAgICAgICAgICAgICB2YWx1ZSA9IGpRdWVyeShvcHRpb24pLnZhbCgpOwogICAgICAgICAgICAgIC8vIFdlIGRvbid0IG5lZWQgYW4gYXJyYXkgZm9yIG9uZSBzZWxlY3RzCiAgICAgICAgICAgICAgaWYgKG9uZSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAvLyBNdWx0aS1TZWxlY3RzIHJldHVybiBhbiBhcnJheQogICAgICAgICAgICAgIHZhbHVlcy5wdXNoKHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHZhbHVlczsKICAgICAgICB9LAogICAgICAgIHNldDogZnVuY3Rpb24gKGVsZW0sIHZhbHVlKSB7CiAgICAgICAgICB2YXIgb3B0aW9uU2V0LCBvcHRpb24sIG9wdGlvbnMgPSBlbGVtLm9wdGlvbnMsIHZhbHVlcyA9IGpRdWVyeS5tYWtlQXJyYXkodmFsdWUpLCBpID0gb3B0aW9ucy5sZW5ndGg7CiAgICAgICAgICB3aGlsZSAoaS0tKSB7CiAgICAgICAgICAgIG9wdGlvbiA9IG9wdGlvbnNbaV07CiAgICAgICAgICAgIGlmIChvcHRpb24uc2VsZWN0ZWQgPSBqUXVlcnkuaW5BcnJheShvcHRpb24udmFsdWUsIHZhbHVlcykgPj0gMCkgewogICAgICAgICAgICAgIG9wdGlvblNldCA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIC8vIGZvcmNlIGJyb3dzZXJzIHRvIGJlaGF2ZSBjb25zaXN0ZW50bHkgd2hlbiBub24tbWF0Y2hpbmcgdmFsdWUgaXMgc2V0CiAgICAgICAgICBpZiAoIW9wdGlvblNldCkgewogICAgICAgICAgICBlbGVtLnNlbGVjdGVkSW5kZXggPSAtMTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB2YWx1ZXM7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfSk7CiAgLy8gUmFkaW9zIGFuZCBjaGVja2JveGVzIGdldHRlci9zZXR0ZXIKICBqUXVlcnkuZWFjaChbCiAgICAncmFkaW8nLAogICAgJ2NoZWNrYm94JwogIF0sIGZ1bmN0aW9uICgpIHsKICAgIGpRdWVyeS52YWxIb29rc1t0aGlzXSA9IHsKICAgICAgc2V0OiBmdW5jdGlvbiAoZWxlbSwgdmFsdWUpIHsKICAgICAgICBpZiAoalF1ZXJ5LmlzQXJyYXkodmFsdWUpKSB7CiAgICAgICAgICByZXR1cm4gZWxlbS5jaGVja2VkID0galF1ZXJ5LmluQXJyYXkoalF1ZXJ5KGVsZW0pLnZhbCgpLCB2YWx1ZSkgPj0gMDsKICAgICAgICB9CiAgICAgIH0KICAgIH07CiAgICBpZiAoIXN1cHBvcnQuY2hlY2tPbikgewogICAgICBqUXVlcnkudmFsSG9va3NbdGhpc10uZ2V0ID0gZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICAvLyBTdXBwb3J0OiBXZWJraXQKICAgICAgICAvLyAiIiBpcyByZXR1cm5lZCBpbnN0ZWFkIG9mICJvbiIgaWYgYSB2YWx1ZSBpc24ndCBzcGVjaWZpZWQKICAgICAgICByZXR1cm4gZWxlbS5nZXRBdHRyaWJ1dGUoJ3ZhbHVlJykgPT09IG51bGwgPyAnb24nIDogZWxlbS52YWx1ZTsKICAgICAgfTsKICAgIH0KICB9KTsKICAvLyBSZXR1cm4galF1ZXJ5IGZvciBhdHRyaWJ1dGVzLW9ubHkgaW5jbHVzaW9uCiAgalF1ZXJ5LmVhY2goKCdibHVyIGZvY3VzIGZvY3VzaW4gZm9jdXNvdXQgbG9hZCByZXNpemUgc2Nyb2xsIHVubG9hZCBjbGljayBkYmxjbGljayAnICsgJ21vdXNlZG93biBtb3VzZXVwIG1vdXNlbW92ZSBtb3VzZW92ZXIgbW91c2VvdXQgbW91c2VlbnRlciBtb3VzZWxlYXZlICcgKyAnY2hhbmdlIHNlbGVjdCBzdWJtaXQga2V5ZG93biBrZXlwcmVzcyBrZXl1cCBlcnJvciBjb250ZXh0bWVudScpLnNwbGl0KCcgJyksIGZ1bmN0aW9uIChpLCBuYW1lKSB7CiAgICAvLyBIYW5kbGUgZXZlbnQgYmluZGluZwogICAgalF1ZXJ5LmZuW25hbWVdID0gZnVuY3Rpb24gKGRhdGEsIGZuKSB7CiAgICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID4gMCA/IHRoaXMub24obmFtZSwgbnVsbCwgZGF0YSwgZm4pIDogdGhpcy50cmlnZ2VyKG5hbWUpOwogICAgfTsKICB9KTsKICBqUXVlcnkuZm4uZXh0ZW5kKHsKICAgIGhvdmVyOiBmdW5jdGlvbiAoZm5PdmVyLCBmbk91dCkgewogICAgICByZXR1cm4gdGhpcy5tb3VzZWVudGVyKGZuT3ZlcikubW91c2VsZWF2ZShmbk91dCB8fCBmbk92ZXIpOwogICAgfSwKICAgIGJpbmQ6IGZ1bmN0aW9uICh0eXBlcywgZGF0YSwgZm4pIHsKICAgICAgcmV0dXJuIHRoaXMub24odHlwZXMsIG51bGwsIGRhdGEsIGZuKTsKICAgIH0sCiAgICB1bmJpbmQ6IGZ1bmN0aW9uICh0eXBlcywgZm4pIHsKICAgICAgcmV0dXJuIHRoaXMub2ZmKHR5cGVzLCBudWxsLCBmbik7CiAgICB9LAogICAgZGVsZWdhdGU6IGZ1bmN0aW9uIChzZWxlY3RvciwgdHlwZXMsIGRhdGEsIGZuKSB7CiAgICAgIHJldHVybiB0aGlzLm9uKHR5cGVzLCBzZWxlY3RvciwgZGF0YSwgZm4pOwogICAgfSwKICAgIHVuZGVsZWdhdGU6IGZ1bmN0aW9uIChzZWxlY3RvciwgdHlwZXMsIGZuKSB7CiAgICAgIC8vICggbmFtZXNwYWNlICkgb3IgKCBzZWxlY3RvciwgdHlwZXMgWywgZm5dICkKICAgICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPT09IDEgPyB0aGlzLm9mZihzZWxlY3RvciwgJyoqJykgOiB0aGlzLm9mZih0eXBlcywgc2VsZWN0b3IgfHwgJyoqJywgZm4pOwogICAgfQogIH0pOwogIHZhciBub25jZSA9IGpRdWVyeS5ub3coKTsKICB2YXIgcnF1ZXJ5ID0gL1w/LzsKICAvLyBTdXBwb3J0OiBBbmRyb2lkIDIuMwogIC8vIFdvcmthcm91bmQgZmFpbHVyZSB0byBzdHJpbmctY2FzdCBudWxsIGlucHV0CiAgalF1ZXJ5LnBhcnNlSlNPTiA9IGZ1bmN0aW9uIChkYXRhKSB7CiAgICByZXR1cm4gSlNPTi5wYXJzZShkYXRhICsgJycpOwogIH07CiAgLy8gQ3Jvc3MtYnJvd3NlciB4bWwgcGFyc2luZwogIGpRdWVyeS5wYXJzZVhNTCA9IGZ1bmN0aW9uIChkYXRhKSB7CiAgICB2YXIgeG1sLCB0bXA7CiAgICBpZiAoIWRhdGEgfHwgdHlwZW9mIGRhdGEgIT09ICdzdHJpbmcnKSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfQogICAgLy8gU3VwcG9ydDogSUU5CiAgICB0cnkgewogICAgICB0bXAgPSBuZXcgRE9NUGFyc2VyKCk7CiAgICAgIHhtbCA9IHRtcC5wYXJzZUZyb21TdHJpbmcoZGF0YSwgJ3RleHQveG1sJyk7CiAgICB9IGNhdGNoIChlKSB7CiAgICAgIHhtbCA9IHVuZGVmaW5lZDsKICAgIH0KICAgIGlmICgheG1sIHx8IHhtbC5nZXRFbGVtZW50c0J5VGFnTmFtZSgncGFyc2VyZXJyb3InKS5sZW5ndGgpIHsKICAgICAgalF1ZXJ5LmVycm9yKCdJbnZhbGlkIFhNTDogJyArIGRhdGEpOwogICAgfQogICAgcmV0dXJuIHhtbDsKICB9OwogIHZhcgogICAgLy8gRG9jdW1lbnQgbG9jYXRpb24KICAgIGFqYXhMb2NQYXJ0cywgYWpheExvY2F0aW9uLCByaGFzaCA9IC8jLiokLywgcnRzID0gLyhbPyZdKV89W14mXSovLCByaGVhZGVycyA9IC9eKC4qPyk6WyBcdF0qKFteXHJcbl0qKSQvZ20sCiAgICAvLyAjNzY1MywgIzgxMjUsICM4MTUyOiBsb2NhbCBwcm90b2NvbCBkZXRlY3Rpb24KICAgIHJsb2NhbFByb3RvY29sID0gL14oPzphYm91dHxhcHB8YXBwLXN0b3JhZ2V8ListZXh0ZW5zaW9ufGZpbGV8cmVzfHdpZGdldCk6JC8sIHJub0NvbnRlbnQgPSAvXig/OkdFVHxIRUFEKSQvLCBycHJvdG9jb2wgPSAvXlwvXC8vLCBydXJsID0gL14oW1x3ListXSs6KSg/OlwvXC8oPzpbXlwvPyNdKkB8KShbXlwvPyM6XSopKD86OihcZCspfCl8KS8sCiAgICAvKiBQcmVmaWx0ZXJzCiAgICAqIDEpIFRoZXkgYXJlIHVzZWZ1bCB0byBpbnRyb2R1Y2UgY3VzdG9tIGRhdGFUeXBlcyAoc2VlIGFqYXgvanNvbnAuanMgZm9yIGFuIGV4YW1wbGUpCiAgICAqIDIpIFRoZXNlIGFyZSBjYWxsZWQ6CiAgICAqICAgIC0gQkVGT1JFIGFza2luZyBmb3IgYSB0cmFuc3BvcnQKICAgICogICAgLSBBRlRFUiBwYXJhbSBzZXJpYWxpemF0aW9uIChzLmRhdGEgaXMgYSBzdHJpbmcgaWYgcy5wcm9jZXNzRGF0YSBpcyB0cnVlKQogICAgKiAzKSBrZXkgaXMgdGhlIGRhdGFUeXBlCiAgICAqIDQpIHRoZSBjYXRjaGFsbCBzeW1ib2wgIioiIGNhbiBiZSB1c2VkCiAgICAqIDUpIGV4ZWN1dGlvbiB3aWxsIHN0YXJ0IHdpdGggdHJhbnNwb3J0IGRhdGFUeXBlIGFuZCBUSEVOIGNvbnRpbnVlIGRvd24gdG8gIioiIGlmIG5lZWRlZAogICAgKi8KICAgIHByZWZpbHRlcnMgPSB7fSwKICAgIC8qIFRyYW5zcG9ydHMgYmluZGluZ3MKICAgICogMSkga2V5IGlzIHRoZSBkYXRhVHlwZQogICAgKiAyKSB0aGUgY2F0Y2hhbGwgc3ltYm9sICIqIiBjYW4gYmUgdXNlZAogICAgKiAzKSBzZWxlY3Rpb24gd2lsbCBzdGFydCB3aXRoIHRyYW5zcG9ydCBkYXRhVHlwZSBhbmQgVEhFTiBnbyB0byAiKiIgaWYgbmVlZGVkCiAgICAqLwogICAgdHJhbnNwb3J0cyA9IHt9LAogICAgLy8gQXZvaWQgY29tbWVudC1wcm9sb2cgY2hhciBzZXF1ZW5jZSAoIzEwMDk4KTsgbXVzdCBhcHBlYXNlIGxpbnQgYW5kIGV2YWRlIGNvbXByZXNzaW9uCiAgICBhbGxUeXBlcyA9ICcqLycuY29uY2F0KCcqJyk7CiAgLy8gIzgxMzgsIElFIG1heSB0aHJvdyBhbiBleGNlcHRpb24gd2hlbiBhY2Nlc3NpbmcKICAvLyBhIGZpZWxkIGZyb20gd2luZG93LmxvY2F0aW9uIGlmIGRvY3VtZW50LmRvbWFpbiBoYXMgYmVlbiBzZXQKICB0cnkgewogICAgYWpheExvY2F0aW9uID0gbG9jYXRpb24uaHJlZjsKICB9IGNhdGNoIChlKSB7CiAgICAvLyBVc2UgdGhlIGhyZWYgYXR0cmlidXRlIG9mIGFuIEEgZWxlbWVudAogICAgLy8gc2luY2UgSUUgd2lsbCBtb2RpZnkgaXQgZ2l2ZW4gZG9jdW1lbnQubG9jYXRpb24KICAgIGFqYXhMb2NhdGlvbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2EnKTsKICAgIGFqYXhMb2NhdGlvbi5ocmVmID0gJyc7CiAgICBhamF4TG9jYXRpb24gPSBhamF4TG9jYXRpb24uaHJlZjsKICB9CiAgLy8gU2VnbWVudCBsb2NhdGlvbiBpbnRvIHBhcnRzCiAgYWpheExvY1BhcnRzID0gcnVybC5leGVjKGFqYXhMb2NhdGlvbi50b0xvd2VyQ2FzZSgpKSB8fCBbXTsKICAvLyBCYXNlICJjb25zdHJ1Y3RvciIgZm9yIGpRdWVyeS5hamF4UHJlZmlsdGVyIGFuZCBqUXVlcnkuYWpheFRyYW5zcG9ydAogIGZ1bmN0aW9uIGFkZFRvUHJlZmlsdGVyc09yVHJhbnNwb3J0cyhzdHJ1Y3R1cmUpIHsKICAgIC8vIGRhdGFUeXBlRXhwcmVzc2lvbiBpcyBvcHRpb25hbCBhbmQgZGVmYXVsdHMgdG8gIioiCiAgICByZXR1cm4gZnVuY3Rpb24gKGRhdGFUeXBlRXhwcmVzc2lvbiwgZnVuYykgewogICAgICBpZiAodHlwZW9mIGRhdGFUeXBlRXhwcmVzc2lvbiAhPT0gJ3N0cmluZycpIHsKICAgICAgICBmdW5jID0gZGF0YVR5cGVFeHByZXNzaW9uOwogICAgICAgIGRhdGFUeXBlRXhwcmVzc2lvbiA9ICcqJzsKICAgICAgfQogICAgICB2YXIgZGF0YVR5cGUsIGkgPSAwLCBkYXRhVHlwZXMgPSBkYXRhVHlwZUV4cHJlc3Npb24udG9Mb3dlckNhc2UoKS5tYXRjaChybm90d2hpdGUpIHx8IFtdOwogICAgICBpZiAoalF1ZXJ5LmlzRnVuY3Rpb24oZnVuYykpIHsKICAgICAgICAvLyBGb3IgZWFjaCBkYXRhVHlwZSBpbiB0aGUgZGF0YVR5cGVFeHByZXNzaW9uCiAgICAgICAgd2hpbGUgKGRhdGFUeXBlID0gZGF0YVR5cGVzW2krK10pIHsKICAgICAgICAgIC8vIFByZXBlbmQgaWYgcmVxdWVzdGVkCiAgICAgICAgICBpZiAoZGF0YVR5cGVbMF0gPT09ICcrJykgewogICAgICAgICAgICBkYXRhVHlwZSA9IGRhdGFUeXBlLnNsaWNlKDEpIHx8ICcqJzsKICAgICAgICAgICAgKHN0cnVjdHVyZVtkYXRhVHlwZV0gPSBzdHJ1Y3R1cmVbZGF0YVR5cGVdIHx8IFtdKS51bnNoaWZ0KGZ1bmMpOyAgLy8gT3RoZXJ3aXNlIGFwcGVuZAogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgKHN0cnVjdHVyZVtkYXRhVHlwZV0gPSBzdHJ1Y3R1cmVbZGF0YVR5cGVdIHx8IFtdKS5wdXNoKGZ1bmMpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfTsKICB9CiAgLy8gQmFzZSBpbnNwZWN0aW9uIGZ1bmN0aW9uIGZvciBwcmVmaWx0ZXJzIGFuZCB0cmFuc3BvcnRzCiAgZnVuY3Rpb24gaW5zcGVjdFByZWZpbHRlcnNPclRyYW5zcG9ydHMoc3RydWN0dXJlLCBvcHRpb25zLCBvcmlnaW5hbE9wdGlvbnMsIGpxWEhSKSB7CiAgICB2YXIgaW5zcGVjdGVkID0ge30sIHNlZWtpbmdUcmFuc3BvcnQgPSBzdHJ1Y3R1cmUgPT09IHRyYW5zcG9ydHM7CiAgICBmdW5jdGlvbiBpbnNwZWN0KGRhdGFUeXBlKSB7CiAgICAgIHZhciBzZWxlY3RlZDsKICAgICAgaW5zcGVjdGVkW2RhdGFUeXBlXSA9IHRydWU7CiAgICAgIGpRdWVyeS5lYWNoKHN0cnVjdHVyZVtkYXRhVHlwZV0gfHwgW10sIGZ1bmN0aW9uIChfLCBwcmVmaWx0ZXJPckZhY3RvcnkpIHsKICAgICAgICB2YXIgZGF0YVR5cGVPclRyYW5zcG9ydCA9IHByZWZpbHRlck9yRmFjdG9yeShvcHRpb25zLCBvcmlnaW5hbE9wdGlvbnMsIGpxWEhSKTsKICAgICAgICBpZiAodHlwZW9mIGRhdGFUeXBlT3JUcmFuc3BvcnQgPT09ICdzdHJpbmcnICYmICFzZWVraW5nVHJhbnNwb3J0ICYmICFpbnNwZWN0ZWRbZGF0YVR5cGVPclRyYW5zcG9ydF0pIHsKICAgICAgICAgIG9wdGlvbnMuZGF0YVR5cGVzLnVuc2hpZnQoZGF0YVR5cGVPclRyYW5zcG9ydCk7CiAgICAgICAgICBpbnNwZWN0KGRhdGFUeXBlT3JUcmFuc3BvcnQpOwogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0gZWxzZSBpZiAoc2Vla2luZ1RyYW5zcG9ydCkgewogICAgICAgICAgcmV0dXJuICEoc2VsZWN0ZWQgPSBkYXRhVHlwZU9yVHJhbnNwb3J0KTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICByZXR1cm4gc2VsZWN0ZWQ7CiAgICB9CiAgICByZXR1cm4gaW5zcGVjdChvcHRpb25zLmRhdGFUeXBlc1swXSkgfHwgIWluc3BlY3RlZFsnKiddICYmIGluc3BlY3QoJyonKTsKICB9CiAgLy8gQSBzcGVjaWFsIGV4dGVuZCBmb3IgYWpheCBvcHRpb25zCiAgLy8gdGhhdCB0YWtlcyAiZmxhdCIgb3B0aW9ucyAobm90IHRvIGJlIGRlZXAgZXh0ZW5kZWQpCiAgLy8gRml4ZXMgIzk4ODcKICBmdW5jdGlvbiBhamF4RXh0ZW5kKHRhcmdldCwgc3JjKSB7CiAgICB2YXIga2V5LCBkZWVwLCBmbGF0T3B0aW9ucyA9IGpRdWVyeS5hamF4U2V0dGluZ3MuZmxhdE9wdGlvbnMgfHwge307CiAgICBmb3IgKGtleSBpbiBzcmMpIHsKICAgICAgaWYgKHNyY1trZXldICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAoZmxhdE9wdGlvbnNba2V5XSA/IHRhcmdldCA6IGRlZXAgfHwgKGRlZXAgPSB7fSkpW2tleV0gPSBzcmNba2V5XTsKICAgICAgfQogICAgfQogICAgaWYgKGRlZXApIHsKICAgICAgalF1ZXJ5LmV4dGVuZCh0cnVlLCB0YXJnZXQsIGRlZXApOwogICAgfQogICAgcmV0dXJuIHRhcmdldDsKICB9CiAgLyogSGFuZGxlcyByZXNwb25zZXMgdG8gYW4gYWpheCByZXF1ZXN0OgogICAqIC0gZmluZHMgdGhlIHJpZ2h0IGRhdGFUeXBlIChtZWRpYXRlcyBiZXR3ZWVuIGNvbnRlbnQtdHlwZSBhbmQgZXhwZWN0ZWQgZGF0YVR5cGUpCiAgICogLSByZXR1cm5zIHRoZSBjb3JyZXNwb25kaW5nIHJlc3BvbnNlCiAgICovCiAgZnVuY3Rpb24gYWpheEhhbmRsZVJlc3BvbnNlcyhzLCBqcVhIUiwgcmVzcG9uc2VzKSB7CiAgICB2YXIgY3QsIHR5cGUsIGZpbmFsRGF0YVR5cGUsIGZpcnN0RGF0YVR5cGUsIGNvbnRlbnRzID0gcy5jb250ZW50cywgZGF0YVR5cGVzID0gcy5kYXRhVHlwZXM7CiAgICAvLyBSZW1vdmUgYXV0byBkYXRhVHlwZSBhbmQgZ2V0IGNvbnRlbnQtdHlwZSBpbiB0aGUgcHJvY2VzcwogICAgd2hpbGUgKGRhdGFUeXBlc1swXSA9PT0gJyonKSB7CiAgICAgIGRhdGFUeXBlcy5zaGlmdCgpOwogICAgICBpZiAoY3QgPT09IHVuZGVmaW5lZCkgewogICAgICAgIGN0ID0gcy5taW1lVHlwZSB8fCBqcVhIUi5nZXRSZXNwb25zZUhlYWRlcignQ29udGVudC1UeXBlJyk7CiAgICAgIH0KICAgIH0KICAgIC8vIENoZWNrIGlmIHdlJ3JlIGRlYWxpbmcgd2l0aCBhIGtub3duIGNvbnRlbnQtdHlwZQogICAgaWYgKGN0KSB7CiAgICAgIGZvciAodHlwZSBpbiBjb250ZW50cykgewogICAgICAgIGlmIChjb250ZW50c1t0eXBlXSAmJiBjb250ZW50c1t0eXBlXS50ZXN0KGN0KSkgewogICAgICAgICAgZGF0YVR5cGVzLnVuc2hpZnQodHlwZSk7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIC8vIENoZWNrIHRvIHNlZSBpZiB3ZSBoYXZlIGEgcmVzcG9uc2UgZm9yIHRoZSBleHBlY3RlZCBkYXRhVHlwZQogICAgaWYgKGRhdGFUeXBlc1swXSBpbiByZXNwb25zZXMpIHsKICAgICAgZmluYWxEYXRhVHlwZSA9IGRhdGFUeXBlc1swXTsKICAgIH0gZWxzZSB7CiAgICAgIC8vIFRyeSBjb252ZXJ0aWJsZSBkYXRhVHlwZXMKICAgICAgZm9yICh0eXBlIGluIHJlc3BvbnNlcykgewogICAgICAgIGlmICghZGF0YVR5cGVzWzBdIHx8IHMuY29udmVydGVyc1t0eXBlICsgJyAnICsgZGF0YVR5cGVzWzBdXSkgewogICAgICAgICAgZmluYWxEYXRhVHlwZSA9IHR5cGU7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgICAgaWYgKCFmaXJzdERhdGFUeXBlKSB7CiAgICAgICAgICBmaXJzdERhdGFUeXBlID0gdHlwZTsKICAgICAgICB9CiAgICAgIH0KICAgICAgLy8gT3IganVzdCB1c2UgZmlyc3Qgb25lCiAgICAgIGZpbmFsRGF0YVR5cGUgPSBmaW5hbERhdGFUeXBlIHx8IGZpcnN0RGF0YVR5cGU7CiAgICB9CiAgICAvLyBJZiB3ZSBmb3VuZCBhIGRhdGFUeXBlCiAgICAvLyBXZSBhZGQgdGhlIGRhdGFUeXBlIHRvIHRoZSBsaXN0IGlmIG5lZWRlZAogICAgLy8gYW5kIHJldHVybiB0aGUgY29ycmVzcG9uZGluZyByZXNwb25zZQogICAgaWYgKGZpbmFsRGF0YVR5cGUpIHsKICAgICAgaWYgKGZpbmFsRGF0YVR5cGUgIT09IGRhdGFUeXBlc1swXSkgewogICAgICAgIGRhdGFUeXBlcy51bnNoaWZ0KGZpbmFsRGF0YVR5cGUpOwogICAgICB9CiAgICAgIHJldHVybiByZXNwb25zZXNbZmluYWxEYXRhVHlwZV07CiAgICB9CiAgfQogIC8qIENoYWluIGNvbnZlcnNpb25zIGdpdmVuIHRoZSByZXF1ZXN0IGFuZCB0aGUgb3JpZ2luYWwgcmVzcG9uc2UKICAgKiBBbHNvIHNldHMgdGhlIHJlc3BvbnNlWFhYIGZpZWxkcyBvbiB0aGUganFYSFIgaW5zdGFuY2UKICAgKi8KICBmdW5jdGlvbiBhamF4Q29udmVydChzLCByZXNwb25zZSwganFYSFIsIGlzU3VjY2VzcykgewogICAgdmFyIGNvbnYyLCBjdXJyZW50LCBjb252LCB0bXAsIHByZXYsIGNvbnZlcnRlcnMgPSB7fSwKICAgICAgLy8gV29yayB3aXRoIGEgY29weSBvZiBkYXRhVHlwZXMgaW4gY2FzZSB3ZSBuZWVkIHRvIG1vZGlmeSBpdCBmb3IgY29udmVyc2lvbgogICAgICBkYXRhVHlwZXMgPSBzLmRhdGFUeXBlcy5zbGljZSgpOwogICAgLy8gQ3JlYXRlIGNvbnZlcnRlcnMgbWFwIHdpdGggbG93ZXJjYXNlZCBrZXlzCiAgICBpZiAoZGF0YVR5cGVzWzFdKSB7CiAgICAgIGZvciAoY29udiBpbiBzLmNvbnZlcnRlcnMpIHsKICAgICAgICBjb252ZXJ0ZXJzW2NvbnYudG9Mb3dlckNhc2UoKV0gPSBzLmNvbnZlcnRlcnNbY29udl07CiAgICAgIH0KICAgIH0KICAgIGN1cnJlbnQgPSBkYXRhVHlwZXMuc2hpZnQoKTsKICAgIC8vIENvbnZlcnQgdG8gZWFjaCBzZXF1ZW50aWFsIGRhdGFUeXBlCiAgICB3aGlsZSAoY3VycmVudCkgewogICAgICBpZiAocy5yZXNwb25zZUZpZWxkc1tjdXJyZW50XSkgewogICAgICAgIGpxWEhSW3MucmVzcG9uc2VGaWVsZHNbY3VycmVudF1dID0gcmVzcG9uc2U7CiAgICAgIH0KICAgICAgLy8gQXBwbHkgdGhlIGRhdGFGaWx0ZXIgaWYgcHJvdmlkZWQKICAgICAgaWYgKCFwcmV2ICYmIGlzU3VjY2VzcyAmJiBzLmRhdGFGaWx0ZXIpIHsKICAgICAgICByZXNwb25zZSA9IHMuZGF0YUZpbHRlcihyZXNwb25zZSwgcy5kYXRhVHlwZSk7CiAgICAgIH0KICAgICAgcHJldiA9IGN1cnJlbnQ7CiAgICAgIGN1cnJlbnQgPSBkYXRhVHlwZXMuc2hpZnQoKTsKICAgICAgaWYgKGN1cnJlbnQpIHsKICAgICAgICAvLyBUaGVyZSdzIG9ubHkgd29yayB0byBkbyBpZiBjdXJyZW50IGRhdGFUeXBlIGlzIG5vbi1hdXRvCiAgICAgICAgaWYgKGN1cnJlbnQgPT09ICcqJykgewogICAgICAgICAgY3VycmVudCA9IHByZXY7ICAvLyBDb252ZXJ0IHJlc3BvbnNlIGlmIHByZXYgZGF0YVR5cGUgaXMgbm9uLWF1dG8gYW5kIGRpZmZlcnMgZnJvbSBjdXJyZW50CiAgICAgICAgfSBlbHNlIGlmIChwcmV2ICE9PSAnKicgJiYgcHJldiAhPT0gY3VycmVudCkgewogICAgICAgICAgLy8gU2VlayBhIGRpcmVjdCBjb252ZXJ0ZXIKICAgICAgICAgIGNvbnYgPSBjb252ZXJ0ZXJzW3ByZXYgKyAnICcgKyBjdXJyZW50XSB8fCBjb252ZXJ0ZXJzWycqICcgKyBjdXJyZW50XTsKICAgICAgICAgIC8vIElmIG5vbmUgZm91bmQsIHNlZWsgYSBwYWlyCiAgICAgICAgICBpZiAoIWNvbnYpIHsKICAgICAgICAgICAgZm9yIChjb252MiBpbiBjb252ZXJ0ZXJzKSB7CiAgICAgICAgICAgICAgLy8gSWYgY29udjIgb3V0cHV0cyBjdXJyZW50CiAgICAgICAgICAgICAgdG1wID0gY29udjIuc3BsaXQoJyAnKTsKICAgICAgICAgICAgICBpZiAodG1wWzFdID09PSBjdXJyZW50KSB7CiAgICAgICAgICAgICAgICAvLyBJZiBwcmV2IGNhbiBiZSBjb252ZXJ0ZWQgdG8gYWNjZXB0ZWQgaW5wdXQKICAgICAgICAgICAgICAgIGNvbnYgPSBjb252ZXJ0ZXJzW3ByZXYgKyAnICcgKyB0bXBbMF1dIHx8IGNvbnZlcnRlcnNbJyogJyArIHRtcFswXV07CiAgICAgICAgICAgICAgICBpZiAoY29udikgewogICAgICAgICAgICAgICAgICAvLyBDb25kZW5zZSBlcXVpdmFsZW5jZSBjb252ZXJ0ZXJzCiAgICAgICAgICAgICAgICAgIGlmIChjb252ID09PSB0cnVlKSB7CiAgICAgICAgICAgICAgICAgICAgY29udiA9IGNvbnZlcnRlcnNbY29udjJdOyAgLy8gT3RoZXJ3aXNlLCBpbnNlcnQgdGhlIGludGVybWVkaWF0ZSBkYXRhVHlwZQogICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGNvbnZlcnRlcnNbY29udjJdICE9PSB0cnVlKSB7CiAgICAgICAgICAgICAgICAgICAgY3VycmVudCA9IHRtcFswXTsKICAgICAgICAgICAgICAgICAgICBkYXRhVHlwZXMudW5zaGlmdCh0bXBbMV0pOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgLy8gQXBwbHkgY29udmVydGVyIChpZiBub3QgYW4gZXF1aXZhbGVuY2UpCiAgICAgICAgICBpZiAoY29udiAhPT0gdHJ1ZSkgewogICAgICAgICAgICAvLyBVbmxlc3MgZXJyb3JzIGFyZSBhbGxvd2VkIHRvIGJ1YmJsZSwgY2F0Y2ggYW5kIHJldHVybiB0aGVtCiAgICAgICAgICAgIGlmIChjb252ICYmIHNbJ3Rocm93cyddKSB7CiAgICAgICAgICAgICAgcmVzcG9uc2UgPSBjb252KHJlc3BvbnNlKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmVzcG9uc2UgPSBjb252KHJlc3BvbnNlKTsKICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgICBzdGF0ZTogJ3BhcnNlcmVycm9yJywKICAgICAgICAgICAgICAgICAgZXJyb3I6IGNvbnYgPyBlIDogJ05vIGNvbnZlcnNpb24gZnJvbSAnICsgcHJldiArICcgdG8gJyArIGN1cnJlbnQKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICByZXR1cm4gewogICAgICBzdGF0ZTogJ3N1Y2Nlc3MnLAogICAgICBkYXRhOiByZXNwb25zZQogICAgfTsKICB9CiAgalF1ZXJ5LmV4dGVuZCh7CiAgICAvLyBDb3VudGVyIGZvciBob2xkaW5nIHRoZSBudW1iZXIgb2YgYWN0aXZlIHF1ZXJpZXMKICAgIGFjdGl2ZTogMCwKICAgIC8vIExhc3QtTW9kaWZpZWQgaGVhZGVyIGNhY2hlIGZvciBuZXh0IHJlcXVlc3QKICAgIGxhc3RNb2RpZmllZDoge30sCiAgICBldGFnOiB7fSwKICAgIGFqYXhTZXR0aW5nczogewogICAgICB1cmw6IGFqYXhMb2NhdGlvbiwKICAgICAgdHlwZTogJ0dFVCcsCiAgICAgIGlzTG9jYWw6IHJsb2NhbFByb3RvY29sLnRlc3QoYWpheExvY1BhcnRzWzFdKSwKICAgICAgZ2xvYmFsOiB0cnVlLAogICAgICBwcm9jZXNzRGF0YTogdHJ1ZSwKICAgICAgYXN5bmM6IHRydWUsCiAgICAgIGNvbnRlbnRUeXBlOiAnYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkOyBjaGFyc2V0PVVURi04JywKICAgICAgLyoKICAgICAgdGltZW91dDogMCwKICAgICAgZGF0YTogbnVsbCwKICAgICAgZGF0YVR5cGU6IG51bGwsCiAgICAgIHVzZXJuYW1lOiBudWxsLAogICAgICBwYXNzd29yZDogbnVsbCwKICAgICAgY2FjaGU6IG51bGwsCiAgICAgIHRocm93czogZmFsc2UsCiAgICAgIHRyYWRpdGlvbmFsOiBmYWxzZSwKICAgICAgaGVhZGVyczoge30sCiAgICAgICovCiAgICAgIGFjY2VwdHM6IHsKICAgICAgICAnKic6IGFsbFR5cGVzLAogICAgICAgIHRleHQ6ICd0ZXh0L3BsYWluJywKICAgICAgICBodG1sOiAndGV4dC9odG1sJywKICAgICAgICB4bWw6ICdhcHBsaWNhdGlvbi94bWwsIHRleHQveG1sJywKICAgICAgICBqc29uOiAnYXBwbGljYXRpb24vanNvbiwgdGV4dC9qYXZhc2NyaXB0JwogICAgICB9LAogICAgICBjb250ZW50czogewogICAgICAgIHhtbDogL3htbC8sCiAgICAgICAgaHRtbDogL2h0bWwvLAogICAgICAgIGpzb246IC9qc29uLwogICAgICB9LAogICAgICByZXNwb25zZUZpZWxkczogewogICAgICAgIHhtbDogJ3Jlc3BvbnNlWE1MJywKICAgICAgICB0ZXh0OiAncmVzcG9uc2VUZXh0JywKICAgICAgICBqc29uOiAncmVzcG9uc2VKU09OJwogICAgICB9LAogICAgICAvLyBEYXRhIGNvbnZlcnRlcnMKICAgICAgLy8gS2V5cyBzZXBhcmF0ZSBzb3VyY2UgKG9yIGNhdGNoYWxsICIqIikgYW5kIGRlc3RpbmF0aW9uIHR5cGVzIHdpdGggYSBzaW5nbGUgc3BhY2UKICAgICAgY29udmVydGVyczogewogICAgICAgIC8vIENvbnZlcnQgYW55dGhpbmcgdG8gdGV4dAogICAgICAgICcqIHRleHQnOiBTdHJpbmcsCiAgICAgICAgLy8gVGV4dCB0byBodG1sICh0cnVlID0gbm8gdHJhbnNmb3JtYXRpb24pCiAgICAgICAgJ3RleHQgaHRtbCc6IHRydWUsCiAgICAgICAgLy8gRXZhbHVhdGUgdGV4dCBhcyBhIGpzb24gZXhwcmVzc2lvbgogICAgICAgICd0ZXh0IGpzb24nOiBqUXVlcnkucGFyc2VKU09OLAogICAgICAgIC8vIFBhcnNlIHRleHQgYXMgeG1sCiAgICAgICAgJ3RleHQgeG1sJzogalF1ZXJ5LnBhcnNlWE1MCiAgICAgIH0sCiAgICAgIC8vIEZvciBvcHRpb25zIHRoYXQgc2hvdWxkbid0IGJlIGRlZXAgZXh0ZW5kZWQ6CiAgICAgIC8vIHlvdSBjYW4gYWRkIHlvdXIgb3duIGN1c3RvbSBvcHRpb25zIGhlcmUgaWYKICAgICAgLy8gYW5kIHdoZW4geW91IGNyZWF0ZSBvbmUgdGhhdCBzaG91bGRuJ3QgYmUKICAgICAgLy8gZGVlcCBleHRlbmRlZCAoc2VlIGFqYXhFeHRlbmQpCiAgICAgIGZsYXRPcHRpb25zOiB7CiAgICAgICAgdXJsOiB0cnVlLAogICAgICAgIGNvbnRleHQ6IHRydWUKICAgICAgfQogICAgfSwKICAgIC8vIENyZWF0ZXMgYSBmdWxsIGZsZWRnZWQgc2V0dGluZ3Mgb2JqZWN0IGludG8gdGFyZ2V0CiAgICAvLyB3aXRoIGJvdGggYWpheFNldHRpbmdzIGFuZCBzZXR0aW5ncyBmaWVsZHMuCiAgICAvLyBJZiB0YXJnZXQgaXMgb21pdHRlZCwgd3JpdGVzIGludG8gYWpheFNldHRpbmdzLgogICAgYWpheFNldHVwOiBmdW5jdGlvbiAodGFyZ2V0LCBzZXR0aW5ncykgewogICAgICByZXR1cm4gc2V0dGluZ3MgPyAvLyBCdWlsZGluZyBhIHNldHRpbmdzIG9iamVjdAogICAgICBhamF4RXh0ZW5kKGFqYXhFeHRlbmQodGFyZ2V0LCBqUXVlcnkuYWpheFNldHRpbmdzKSwgc2V0dGluZ3MpIDogLy8gRXh0ZW5kaW5nIGFqYXhTZXR0aW5ncwogICAgICBhamF4RXh0ZW5kKGpRdWVyeS5hamF4U2V0dGluZ3MsIHRhcmdldCk7CiAgICB9LAogICAgYWpheFByZWZpbHRlcjogYWRkVG9QcmVmaWx0ZXJzT3JUcmFuc3BvcnRzKHByZWZpbHRlcnMpLAogICAgYWpheFRyYW5zcG9ydDogYWRkVG9QcmVmaWx0ZXJzT3JUcmFuc3BvcnRzKHRyYW5zcG9ydHMpLAogICAgLy8gTWFpbiBtZXRob2QKICAgIGFqYXg6IGZ1bmN0aW9uICh1cmwsIG9wdGlvbnMpIHsKICAgICAgLy8gSWYgdXJsIGlzIGFuIG9iamVjdCwgc2ltdWxhdGUgcHJlLTEuNSBzaWduYXR1cmUKICAgICAgaWYgKHR5cGVvZiB1cmwgPT09ICdvYmplY3QnKSB7CiAgICAgICAgb3B0aW9ucyA9IHVybDsKICAgICAgICB1cmwgPSB1bmRlZmluZWQ7CiAgICAgIH0KICAgICAgLy8gRm9yY2Ugb3B0aW9ucyB0byBiZSBhbiBvYmplY3QKICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICAgIHZhciB0cmFuc3BvcnQsCiAgICAgICAgLy8gVVJMIHdpdGhvdXQgYW50aS1jYWNoZSBwYXJhbQogICAgICAgIGNhY2hlVVJMLAogICAgICAgIC8vIFJlc3BvbnNlIGhlYWRlcnMKICAgICAgICByZXNwb25zZUhlYWRlcnNTdHJpbmcsIHJlc3BvbnNlSGVhZGVycywKICAgICAgICAvLyB0aW1lb3V0IGhhbmRsZQogICAgICAgIHRpbWVvdXRUaW1lciwKICAgICAgICAvLyBDcm9zcy1kb21haW4gZGV0ZWN0aW9uIHZhcnMKICAgICAgICBwYXJ0cywKICAgICAgICAvLyBUbyBrbm93IGlmIGdsb2JhbCBldmVudHMgYXJlIHRvIGJlIGRpc3BhdGNoZWQKICAgICAgICBmaXJlR2xvYmFscywKICAgICAgICAvLyBMb29wIHZhcmlhYmxlCiAgICAgICAgaSwKICAgICAgICAvLyBDcmVhdGUgdGhlIGZpbmFsIG9wdGlvbnMgb2JqZWN0CiAgICAgICAgcyA9IGpRdWVyeS5hamF4U2V0dXAoe30sIG9wdGlvbnMpLAogICAgICAgIC8vIENhbGxiYWNrcyBjb250ZXh0CiAgICAgICAgY2FsbGJhY2tDb250ZXh0ID0gcy5jb250ZXh0IHx8IHMsCiAgICAgICAgLy8gQ29udGV4dCBmb3IgZ2xvYmFsIGV2ZW50cyBpcyBjYWxsYmFja0NvbnRleHQgaWYgaXQgaXMgYSBET00gbm9kZSBvciBqUXVlcnkgY29sbGVjdGlvbgogICAgICAgIGdsb2JhbEV2ZW50Q29udGV4dCA9IHMuY29udGV4dCAmJiAoY2FsbGJhY2tDb250ZXh0Lm5vZGVUeXBlIHx8IGNhbGxiYWNrQ29udGV4dC5qcXVlcnkpID8galF1ZXJ5KGNhbGxiYWNrQ29udGV4dCkgOiBqUXVlcnkuZXZlbnQsCiAgICAgICAgLy8gRGVmZXJyZWRzCiAgICAgICAgZGVmZXJyZWQgPSBqUXVlcnkuRGVmZXJyZWQoKSwgY29tcGxldGVEZWZlcnJlZCA9IGpRdWVyeS5DYWxsYmFja3MoJ29uY2UgbWVtb3J5JyksCiAgICAgICAgLy8gU3RhdHVzLWRlcGVuZGVudCBjYWxsYmFja3MKICAgICAgICBzdGF0dXNDb2RlID0gcy5zdGF0dXNDb2RlIHx8IHt9LAogICAgICAgIC8vIEhlYWRlcnMgKHRoZXkgYXJlIHNlbnQgYWxsIGF0IG9uY2UpCiAgICAgICAgcmVxdWVzdEhlYWRlcnMgPSB7fSwgcmVxdWVzdEhlYWRlcnNOYW1lcyA9IHt9LAogICAgICAgIC8vIFRoZSBqcVhIUiBzdGF0ZQogICAgICAgIHN0YXRlID0gMCwKICAgICAgICAvLyBEZWZhdWx0IGFib3J0IG1lc3NhZ2UKICAgICAgICBzdHJBYm9ydCA9ICdjYW5jZWxlZCcsCiAgICAgICAgLy8gRmFrZSB4aHIKICAgICAgICBqcVhIUiA9IHsKICAgICAgICAgIHJlYWR5U3RhdGU6IDAsCiAgICAgICAgICAvLyBCdWlsZHMgaGVhZGVycyBoYXNodGFibGUgaWYgbmVlZGVkCiAgICAgICAgICBnZXRSZXNwb25zZUhlYWRlcjogZnVuY3Rpb24gKGtleSkgewogICAgICAgICAgICB2YXIgbWF0Y2g7CiAgICAgICAgICAgIGlmIChzdGF0ZSA9PT0gMikgewogICAgICAgICAgICAgIGlmICghcmVzcG9uc2VIZWFkZXJzKSB7CiAgICAgICAgICAgICAgICByZXNwb25zZUhlYWRlcnMgPSB7fTsKICAgICAgICAgICAgICAgIHdoaWxlIChtYXRjaCA9IHJoZWFkZXJzLmV4ZWMocmVzcG9uc2VIZWFkZXJzU3RyaW5nKSkgewogICAgICAgICAgICAgICAgICByZXNwb25zZUhlYWRlcnNbbWF0Y2hbMV0udG9Mb3dlckNhc2UoKV0gPSBtYXRjaFsyXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbWF0Y2ggPSByZXNwb25zZUhlYWRlcnNba2V5LnRvTG93ZXJDYXNlKCldOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBtYXRjaCA9PSBudWxsID8gbnVsbCA6IG1hdGNoOwogICAgICAgICAgfSwKICAgICAgICAgIC8vIFJhdyBzdHJpbmcKICAgICAgICAgIGdldEFsbFJlc3BvbnNlSGVhZGVyczogZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gc3RhdGUgPT09IDIgPyByZXNwb25zZUhlYWRlcnNTdHJpbmcgOiBudWxsOwogICAgICAgICAgfSwKICAgICAgICAgIC8vIENhY2hlcyB0aGUgaGVhZGVyCiAgICAgICAgICBzZXRSZXF1ZXN0SGVhZGVyOiBmdW5jdGlvbiAobmFtZSwgdmFsdWUpIHsKICAgICAgICAgICAgdmFyIGxuYW1lID0gbmFtZS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICBpZiAoIXN0YXRlKSB7CiAgICAgICAgICAgICAgbmFtZSA9IHJlcXVlc3RIZWFkZXJzTmFtZXNbbG5hbWVdID0gcmVxdWVzdEhlYWRlcnNOYW1lc1tsbmFtZV0gfHwgbmFtZTsKICAgICAgICAgICAgICByZXF1ZXN0SGVhZGVyc1tuYW1lXSA9IHZhbHVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgfSwKICAgICAgICAgIC8vIE92ZXJyaWRlcyByZXNwb25zZSBjb250ZW50LXR5cGUgaGVhZGVyCiAgICAgICAgICBvdmVycmlkZU1pbWVUeXBlOiBmdW5jdGlvbiAodHlwZSkgewogICAgICAgICAgICBpZiAoIXN0YXRlKSB7CiAgICAgICAgICAgICAgcy5taW1lVHlwZSA9IHR5cGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICB9LAogICAgICAgICAgLy8gU3RhdHVzLWRlcGVuZGVudCBjYWxsYmFja3MKICAgICAgICAgIHN0YXR1c0NvZGU6IGZ1bmN0aW9uIChtYXApIHsKICAgICAgICAgICAgdmFyIGNvZGU7CiAgICAgICAgICAgIGlmIChtYXApIHsKICAgICAgICAgICAgICBpZiAoc3RhdGUgPCAyKSB7CiAgICAgICAgICAgICAgICBmb3IgKGNvZGUgaW4gbWFwKSB7CiAgICAgICAgICAgICAgICAgIC8vIExhenktYWRkIHRoZSBuZXcgY2FsbGJhY2sgaW4gYSB3YXkgdGhhdCBwcmVzZXJ2ZXMgb2xkIG9uZXMKICAgICAgICAgICAgICAgICAgc3RhdHVzQ29kZVtjb2RlXSA9IFsKICAgICAgICAgICAgICAgICAgICBzdGF0dXNDb2RlW2NvZGVdLAogICAgICAgICAgICAgICAgICAgIG1hcFtjb2RlXQogICAgICAgICAgICAgICAgICBdOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBFeGVjdXRlIHRoZSBhcHByb3ByaWF0ZSBjYWxsYmFja3MKICAgICAgICAgICAgICAgIGpxWEhSLmFsd2F5cyhtYXBbanFYSFIuc3RhdHVzXSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgfSwKICAgICAgICAgIC8vIENhbmNlbCB0aGUgcmVxdWVzdAogICAgICAgICAgYWJvcnQ6IGZ1bmN0aW9uIChzdGF0dXNUZXh0KSB7CiAgICAgICAgICAgIHZhciBmaW5hbFRleHQgPSBzdGF0dXNUZXh0IHx8IHN0ckFib3J0OwogICAgICAgICAgICBpZiAodHJhbnNwb3J0KSB7CiAgICAgICAgICAgICAgdHJhbnNwb3J0LmFib3J0KGZpbmFsVGV4dCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZG9uZSgwLCBmaW5hbFRleHQpOwogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAvLyBBdHRhY2ggZGVmZXJyZWRzCiAgICAgIGRlZmVycmVkLnByb21pc2UoanFYSFIpLmNvbXBsZXRlID0gY29tcGxldGVEZWZlcnJlZC5hZGQ7CiAgICAgIGpxWEhSLnN1Y2Nlc3MgPSBqcVhIUi5kb25lOwogICAgICBqcVhIUi5lcnJvciA9IGpxWEhSLmZhaWw7CiAgICAgIC8vIFJlbW92ZSBoYXNoIGNoYXJhY3RlciAoIzc1MzE6IGFuZCBzdHJpbmcgcHJvbW90aW9uKQogICAgICAvLyBBZGQgcHJvdG9jb2wgaWYgbm90IHByb3ZpZGVkIChwcmVmaWx0ZXJzIG1pZ2h0IGV4cGVjdCBpdCkKICAgICAgLy8gSGFuZGxlIGZhbHN5IHVybCBpbiB0aGUgc2V0dGluZ3Mgb2JqZWN0ICgjMTAwOTM6IGNvbnNpc3RlbmN5IHdpdGggb2xkIHNpZ25hdHVyZSkKICAgICAgLy8gV2UgYWxzbyB1c2UgdGhlIHVybCBwYXJhbWV0ZXIgaWYgYXZhaWxhYmxlCiAgICAgIHMudXJsID0gKCh1cmwgfHwgcy51cmwgfHwgYWpheExvY2F0aW9uKSArICcnKS5yZXBsYWNlKHJoYXNoLCAnJykucmVwbGFjZShycHJvdG9jb2wsIGFqYXhMb2NQYXJ0c1sxXSArICcvLycpOwogICAgICAvLyBBbGlhcyBtZXRob2Qgb3B0aW9uIHRvIHR5cGUgYXMgcGVyIHRpY2tldCAjMTIwMDQKICAgICAgcy50eXBlID0gb3B0aW9ucy5tZXRob2QgfHwgb3B0aW9ucy50eXBlIHx8IHMubWV0aG9kIHx8IHMudHlwZTsKICAgICAgLy8gRXh0cmFjdCBkYXRhVHlwZXMgbGlzdAogICAgICBzLmRhdGFUeXBlcyA9IGpRdWVyeS50cmltKHMuZGF0YVR5cGUgfHwgJyonKS50b0xvd2VyQ2FzZSgpLm1hdGNoKHJub3R3aGl0ZSkgfHwgWycnXTsKICAgICAgLy8gQSBjcm9zcy1kb21haW4gcmVxdWVzdCBpcyBpbiBvcmRlciB3aGVuIHdlIGhhdmUgYSBwcm90b2NvbDpob3N0OnBvcnQgbWlzbWF0Y2gKICAgICAgaWYgKHMuY3Jvc3NEb21haW4gPT0gbnVsbCkgewogICAgICAgIHBhcnRzID0gcnVybC5leGVjKHMudXJsLnRvTG93ZXJDYXNlKCkpOwogICAgICAgIHMuY3Jvc3NEb21haW4gPSAhIShwYXJ0cyAmJiAocGFydHNbMV0gIT09IGFqYXhMb2NQYXJ0c1sxXSB8fCBwYXJ0c1syXSAhPT0gYWpheExvY1BhcnRzWzJdIHx8IChwYXJ0c1szXSB8fCAocGFydHNbMV0gPT09ICdodHRwOicgPyAnODAnIDogJzQ0MycpKSAhPT0gKGFqYXhMb2NQYXJ0c1szXSB8fCAoYWpheExvY1BhcnRzWzFdID09PSAnaHR0cDonID8gJzgwJyA6ICc0NDMnKSkpKTsKICAgICAgfQogICAgICAvLyBDb252ZXJ0IGRhdGEgaWYgbm90IGFscmVhZHkgYSBzdHJpbmcKICAgICAgaWYgKHMuZGF0YSAmJiBzLnByb2Nlc3NEYXRhICYmIHR5cGVvZiBzLmRhdGEgIT09ICdzdHJpbmcnKSB7CiAgICAgICAgcy5kYXRhID0galF1ZXJ5LnBhcmFtKHMuZGF0YSwgcy50cmFkaXRpb25hbCk7CiAgICAgIH0KICAgICAgLy8gQXBwbHkgcHJlZmlsdGVycwogICAgICBpbnNwZWN0UHJlZmlsdGVyc09yVHJhbnNwb3J0cyhwcmVmaWx0ZXJzLCBzLCBvcHRpb25zLCBqcVhIUik7CiAgICAgIC8vIElmIHJlcXVlc3Qgd2FzIGFib3J0ZWQgaW5zaWRlIGEgcHJlZmlsdGVyLCBzdG9wIHRoZXJlCiAgICAgIGlmIChzdGF0ZSA9PT0gMikgewogICAgICAgIHJldHVybiBqcVhIUjsKICAgICAgfQogICAgICAvLyBXZSBjYW4gZmlyZSBnbG9iYWwgZXZlbnRzIGFzIG9mIG5vdyBpZiBhc2tlZCB0bwogICAgICBmaXJlR2xvYmFscyA9IHMuZ2xvYmFsOwogICAgICAvLyBXYXRjaCBmb3IgYSBuZXcgc2V0IG9mIHJlcXVlc3RzCiAgICAgIGlmIChmaXJlR2xvYmFscyAmJiBqUXVlcnkuYWN0aXZlKysgPT09IDApIHsKICAgICAgICBqUXVlcnkuZXZlbnQudHJpZ2dlcignYWpheFN0YXJ0Jyk7CiAgICAgIH0KICAgICAgLy8gVXBwZXJjYXNlIHRoZSB0eXBlCiAgICAgIHMudHlwZSA9IHMudHlwZS50b1VwcGVyQ2FzZSgpOwogICAgICAvLyBEZXRlcm1pbmUgaWYgcmVxdWVzdCBoYXMgY29udGVudAogICAgICBzLmhhc0NvbnRlbnQgPSAhcm5vQ29udGVudC50ZXN0KHMudHlwZSk7CiAgICAgIC8vIFNhdmUgdGhlIFVSTCBpbiBjYXNlIHdlJ3JlIHRveWluZyB3aXRoIHRoZSBJZi1Nb2RpZmllZC1TaW5jZQogICAgICAvLyBhbmQvb3IgSWYtTm9uZS1NYXRjaCBoZWFkZXIgbGF0ZXIgb24KICAgICAgY2FjaGVVUkwgPSBzLnVybDsKICAgICAgLy8gTW9yZSBvcHRpb25zIGhhbmRsaW5nIGZvciByZXF1ZXN0cyB3aXRoIG5vIGNvbnRlbnQKICAgICAgaWYgKCFzLmhhc0NvbnRlbnQpIHsKICAgICAgICAvLyBJZiBkYXRhIGlzIGF2YWlsYWJsZSwgYXBwZW5kIGRhdGEgdG8gdXJsCiAgICAgICAgaWYgKHMuZGF0YSkgewogICAgICAgICAgY2FjaGVVUkwgPSBzLnVybCArPSAocnF1ZXJ5LnRlc3QoY2FjaGVVUkwpID8gJyYnIDogJz8nKSArIHMuZGF0YTsKICAgICAgICAgIC8vICM5NjgyOiByZW1vdmUgZGF0YSBzbyB0aGF0IGl0J3Mgbm90IHVzZWQgaW4gYW4gZXZlbnR1YWwgcmV0cnkKICAgICAgICAgIGRlbGV0ZSBzLmRhdGE7CiAgICAgICAgfQogICAgICAgIC8vIEFkZCBhbnRpLWNhY2hlIGluIHVybCBpZiBuZWVkZWQKICAgICAgICBpZiAocy5jYWNoZSA9PT0gZmFsc2UpIHsKICAgICAgICAgIHMudXJsID0gcnRzLnRlc3QoY2FjaGVVUkwpID8gLy8gSWYgdGhlcmUgaXMgYWxyZWFkeSBhICdfJyBwYXJhbWV0ZXIsIHNldCBpdHMgdmFsdWUKICAgICAgICAgIGNhY2hlVVJMLnJlcGxhY2UocnRzLCAnJDFfPScgKyBub25jZSsrKSA6IC8vIE90aGVyd2lzZSBhZGQgb25lIHRvIHRoZSBlbmQKICAgICAgICAgIGNhY2hlVVJMICsgKHJxdWVyeS50ZXN0KGNhY2hlVVJMKSA/ICcmJyA6ICc/JykgKyAnXz0nICsgbm9uY2UrKzsKICAgICAgICB9CiAgICAgIH0KICAgICAgLy8gU2V0IHRoZSBJZi1Nb2RpZmllZC1TaW5jZSBhbmQvb3IgSWYtTm9uZS1NYXRjaCBoZWFkZXIsIGlmIGluIGlmTW9kaWZpZWQgbW9kZS4KICAgICAgaWYgKHMuaWZNb2RpZmllZCkgewogICAgICAgIGlmIChqUXVlcnkubGFzdE1vZGlmaWVkW2NhY2hlVVJMXSkgewogICAgICAgICAganFYSFIuc2V0UmVxdWVzdEhlYWRlcignSWYtTW9kaWZpZWQtU2luY2UnLCBqUXVlcnkubGFzdE1vZGlmaWVkW2NhY2hlVVJMXSk7CiAgICAgICAgfQogICAgICAgIGlmIChqUXVlcnkuZXRhZ1tjYWNoZVVSTF0pIHsKICAgICAgICAgIGpxWEhSLnNldFJlcXVlc3RIZWFkZXIoJ0lmLU5vbmUtTWF0Y2gnLCBqUXVlcnkuZXRhZ1tjYWNoZVVSTF0pOwogICAgICAgIH0KICAgICAgfQogICAgICAvLyBTZXQgdGhlIGNvcnJlY3QgaGVhZGVyLCBpZiBkYXRhIGlzIGJlaW5nIHNlbnQKICAgICAgaWYgKHMuZGF0YSAmJiBzLmhhc0NvbnRlbnQgJiYgcy5jb250ZW50VHlwZSAhPT0gZmFsc2UgfHwgb3B0aW9ucy5jb250ZW50VHlwZSkgewogICAgICAgIGpxWEhSLnNldFJlcXVlc3RIZWFkZXIoJ0NvbnRlbnQtVHlwZScsIHMuY29udGVudFR5cGUpOwogICAgICB9CiAgICAgIC8vIFNldCB0aGUgQWNjZXB0cyBoZWFkZXIgZm9yIHRoZSBzZXJ2ZXIsIGRlcGVuZGluZyBvbiB0aGUgZGF0YVR5cGUKICAgICAganFYSFIuc2V0UmVxdWVzdEhlYWRlcignQWNjZXB0Jywgcy5kYXRhVHlwZXNbMF0gJiYgcy5hY2NlcHRzW3MuZGF0YVR5cGVzWzBdXSA/IHMuYWNjZXB0c1tzLmRhdGFUeXBlc1swXV0gKyAocy5kYXRhVHlwZXNbMF0gIT09ICcqJyA/ICcsICcgKyBhbGxUeXBlcyArICc7IHE9MC4wMScgOiAnJykgOiBzLmFjY2VwdHNbJyonXSk7CiAgICAgIC8vIENoZWNrIGZvciBoZWFkZXJzIG9wdGlvbgogICAgICBmb3IgKGkgaW4gcy5oZWFkZXJzKSB7CiAgICAgICAganFYSFIuc2V0UmVxdWVzdEhlYWRlcihpLCBzLmhlYWRlcnNbaV0pOwogICAgICB9CiAgICAgIC8vIEFsbG93IGN1c3RvbSBoZWFkZXJzL21pbWV0eXBlcyBhbmQgZWFybHkgYWJvcnQKICAgICAgaWYgKHMuYmVmb3JlU2VuZCAmJiAocy5iZWZvcmVTZW5kLmNhbGwoY2FsbGJhY2tDb250ZXh0LCBqcVhIUiwgcykgPT09IGZhbHNlIHx8IHN0YXRlID09PSAyKSkgewogICAgICAgIC8vIEFib3J0IGlmIG5vdCBkb25lIGFscmVhZHkgYW5kIHJldHVybgogICAgICAgIHJldHVybiBqcVhIUi5hYm9ydCgpOwogICAgICB9CiAgICAgIC8vIGFib3J0aW5nIGlzIG5vIGxvbmdlciBhIGNhbmNlbGxhdGlvbgogICAgICBzdHJBYm9ydCA9ICdhYm9ydCc7CiAgICAgIC8vIEluc3RhbGwgY2FsbGJhY2tzIG9uIGRlZmVycmVkcwogICAgICBmb3IgKGkgaW4gewogICAgICAgICAgc3VjY2VzczogMSwKICAgICAgICAgIGVycm9yOiAxLAogICAgICAgICAgY29tcGxldGU6IDEKICAgICAgICB9KSB7CiAgICAgICAganFYSFJbaV0oc1tpXSk7CiAgICAgIH0KICAgICAgLy8gR2V0IHRyYW5zcG9ydAogICAgICB0cmFuc3BvcnQgPSBpbnNwZWN0UHJlZmlsdGVyc09yVHJhbnNwb3J0cyh0cmFuc3BvcnRzLCBzLCBvcHRpb25zLCBqcVhIUik7CiAgICAgIC8vIElmIG5vIHRyYW5zcG9ydCwgd2UgYXV0by1hYm9ydAogICAgICBpZiAoIXRyYW5zcG9ydCkgewogICAgICAgIGRvbmUoLTEsICdObyBUcmFuc3BvcnQnKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBqcVhIUi5yZWFkeVN0YXRlID0gMTsKICAgICAgICAvLyBTZW5kIGdsb2JhbCBldmVudAogICAgICAgIGlmIChmaXJlR2xvYmFscykgewogICAgICAgICAgZ2xvYmFsRXZlbnRDb250ZXh0LnRyaWdnZXIoJ2FqYXhTZW5kJywgWwogICAgICAgICAgICBqcVhIUiwKICAgICAgICAgICAgcwogICAgICAgICAgXSk7CiAgICAgICAgfQogICAgICAgIC8vIFRpbWVvdXQKICAgICAgICBpZiAocy5hc3luYyAmJiBzLnRpbWVvdXQgPiAwKSB7CiAgICAgICAgICB0aW1lb3V0VGltZXIgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAganFYSFIuYWJvcnQoJ3RpbWVvdXQnKTsKICAgICAgICAgIH0sIHMudGltZW91dCk7CiAgICAgICAgfQogICAgICAgIHRyeSB7CiAgICAgICAgICBzdGF0ZSA9IDE7CiAgICAgICAgICB0cmFuc3BvcnQuc2VuZChyZXF1ZXN0SGVhZGVycywgZG9uZSk7CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgLy8gUHJvcGFnYXRlIGV4Y2VwdGlvbiBhcyBlcnJvciBpZiBub3QgZG9uZQogICAgICAgICAgaWYgKHN0YXRlIDwgMikgewogICAgICAgICAgICBkb25lKC0xLCBlKTsgIC8vIFNpbXBseSByZXRocm93IG90aGVyd2lzZQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhyb3cgZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgLy8gQ2FsbGJhY2sgZm9yIHdoZW4gZXZlcnl0aGluZyBpcyBkb25lCiAgICAgIGZ1bmN0aW9uIGRvbmUoc3RhdHVzLCBuYXRpdmVTdGF0dXNUZXh0LCByZXNwb25zZXMsIGhlYWRlcnMpIHsKICAgICAgICB2YXIgaXNTdWNjZXNzLCBzdWNjZXNzLCBlcnJvciwgcmVzcG9uc2UsIG1vZGlmaWVkLCBzdGF0dXNUZXh0ID0gbmF0aXZlU3RhdHVzVGV4dDsKICAgICAgICAvLyBDYWxsZWQgb25jZQogICAgICAgIGlmIChzdGF0ZSA9PT0gMikgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICAvLyBTdGF0ZSBpcyAiZG9uZSIgbm93CiAgICAgICAgc3RhdGUgPSAyOwogICAgICAgIC8vIENsZWFyIHRpbWVvdXQgaWYgaXQgZXhpc3RzCiAgICAgICAgaWYgKHRpbWVvdXRUaW1lcikgewogICAgICAgICAgY2xlYXJUaW1lb3V0KHRpbWVvdXRUaW1lcik7CiAgICAgICAgfQogICAgICAgIC8vIERlcmVmZXJlbmNlIHRyYW5zcG9ydCBmb3IgZWFybHkgZ2FyYmFnZSBjb2xsZWN0aW9uCiAgICAgICAgLy8gKG5vIG1hdHRlciBob3cgbG9uZyB0aGUganFYSFIgb2JqZWN0IHdpbGwgYmUgdXNlZCkKICAgICAgICB0cmFuc3BvcnQgPSB1bmRlZmluZWQ7CiAgICAgICAgLy8gQ2FjaGUgcmVzcG9uc2UgaGVhZGVycwogICAgICAgIHJlc3BvbnNlSGVhZGVyc1N0cmluZyA9IGhlYWRlcnMgfHwgJyc7CiAgICAgICAgLy8gU2V0IHJlYWR5U3RhdGUKICAgICAgICBqcVhIUi5yZWFkeVN0YXRlID0gc3RhdHVzID4gMCA/IDQgOiAwOwogICAgICAgIC8vIERldGVybWluZSBpZiBzdWNjZXNzZnVsCiAgICAgICAgaXNTdWNjZXNzID0gc3RhdHVzID49IDIwMCAmJiBzdGF0dXMgPCAzMDAgfHwgc3RhdHVzID09PSAzMDQ7CiAgICAgICAgLy8gR2V0IHJlc3BvbnNlIGRhdGEKICAgICAgICBpZiAocmVzcG9uc2VzKSB7CiAgICAgICAgICByZXNwb25zZSA9IGFqYXhIYW5kbGVSZXNwb25zZXMocywganFYSFIsIHJlc3BvbnNlcyk7CiAgICAgICAgfQogICAgICAgIC8vIENvbnZlcnQgbm8gbWF0dGVyIHdoYXQgKHRoYXQgd2F5IHJlc3BvbnNlWFhYIGZpZWxkcyBhcmUgYWx3YXlzIHNldCkKICAgICAgICByZXNwb25zZSA9IGFqYXhDb252ZXJ0KHMsIHJlc3BvbnNlLCBqcVhIUiwgaXNTdWNjZXNzKTsKICAgICAgICAvLyBJZiBzdWNjZXNzZnVsLCBoYW5kbGUgdHlwZSBjaGFpbmluZwogICAgICAgIGlmIChpc1N1Y2Nlc3MpIHsKICAgICAgICAgIC8vIFNldCB0aGUgSWYtTW9kaWZpZWQtU2luY2UgYW5kL29yIElmLU5vbmUtTWF0Y2ggaGVhZGVyLCBpZiBpbiBpZk1vZGlmaWVkIG1vZGUuCiAgICAgICAgICBpZiAocy5pZk1vZGlmaWVkKSB7CiAgICAgICAgICAgIG1vZGlmaWVkID0ganFYSFIuZ2V0UmVzcG9uc2VIZWFkZXIoJ0xhc3QtTW9kaWZpZWQnKTsKICAgICAgICAgICAgaWYgKG1vZGlmaWVkKSB7CiAgICAgICAgICAgICAgalF1ZXJ5Lmxhc3RNb2RpZmllZFtjYWNoZVVSTF0gPSBtb2RpZmllZDsKICAgICAgICAgICAgfQogICAgICAgICAgICBtb2RpZmllZCA9IGpxWEhSLmdldFJlc3BvbnNlSGVhZGVyKCdldGFnJyk7CiAgICAgICAgICAgIGlmIChtb2RpZmllZCkgewogICAgICAgICAgICAgIGpRdWVyeS5ldGFnW2NhY2hlVVJMXSA9IG1vZGlmaWVkOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICAvLyBpZiBubyBjb250ZW50CiAgICAgICAgICBpZiAoc3RhdHVzID09PSAyMDQgfHwgcy50eXBlID09PSAnSEVBRCcpIHsKICAgICAgICAgICAgc3RhdHVzVGV4dCA9ICdub2NvbnRlbnQnOyAgLy8gaWYgbm90IG1vZGlmaWVkCiAgICAgICAgICB9IGVsc2UgaWYgKHN0YXR1cyA9PT0gMzA0KSB7CiAgICAgICAgICAgIHN0YXR1c1RleHQgPSAnbm90bW9kaWZpZWQnOyAgLy8gSWYgd2UgaGF2ZSBkYXRhLCBsZXQncyBjb252ZXJ0IGl0CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzdGF0dXNUZXh0ID0gcmVzcG9uc2Uuc3RhdGU7CiAgICAgICAgICAgIHN1Y2Nlc3MgPSByZXNwb25zZS5kYXRhOwogICAgICAgICAgICBlcnJvciA9IHJlc3BvbnNlLmVycm9yOwogICAgICAgICAgICBpc1N1Y2Nlc3MgPSAhZXJyb3I7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIC8vIFdlIGV4dHJhY3QgZXJyb3IgZnJvbSBzdGF0dXNUZXh0CiAgICAgICAgICAvLyB0aGVuIG5vcm1hbGl6ZSBzdGF0dXNUZXh0IGFuZCBzdGF0dXMgZm9yIG5vbi1hYm9ydHMKICAgICAgICAgIGVycm9yID0gc3RhdHVzVGV4dDsKICAgICAgICAgIGlmIChzdGF0dXMgfHwgIXN0YXR1c1RleHQpIHsKICAgICAgICAgICAgc3RhdHVzVGV4dCA9ICdlcnJvcic7CiAgICAgICAgICAgIGlmIChzdGF0dXMgPCAwKSB7CiAgICAgICAgICAgICAgc3RhdHVzID0gMDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAvLyBTZXQgZGF0YSBmb3IgdGhlIGZha2UgeGhyIG9iamVjdAogICAgICAgIGpxWEhSLnN0YXR1cyA9IHN0YXR1czsKICAgICAgICBqcVhIUi5zdGF0dXNUZXh0ID0gKG5hdGl2ZVN0YXR1c1RleHQgfHwgc3RhdHVzVGV4dCkgKyAnJzsKICAgICAgICAvLyBTdWNjZXNzL0Vycm9yCiAgICAgICAgaWYgKGlzU3VjY2VzcykgewogICAgICAgICAgZGVmZXJyZWQucmVzb2x2ZVdpdGgoY2FsbGJhY2tDb250ZXh0LCBbCiAgICAgICAgICAgIHN1Y2Nlc3MsCiAgICAgICAgICAgIHN0YXR1c1RleHQsCiAgICAgICAgICAgIGpxWEhSCiAgICAgICAgICBdKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZGVmZXJyZWQucmVqZWN0V2l0aChjYWxsYmFja0NvbnRleHQsIFsKICAgICAgICAgICAganFYSFIsCiAgICAgICAgICAgIHN0YXR1c1RleHQsCiAgICAgICAgICAgIGVycm9yCiAgICAgICAgICBdKTsKICAgICAgICB9CiAgICAgICAgLy8gU3RhdHVzLWRlcGVuZGVudCBjYWxsYmFja3MKICAgICAgICBqcVhIUi5zdGF0dXNDb2RlKHN0YXR1c0NvZGUpOwogICAgICAgIHN0YXR1c0NvZGUgPSB1bmRlZmluZWQ7CiAgICAgICAgaWYgKGZpcmVHbG9iYWxzKSB7CiAgICAgICAgICBnbG9iYWxFdmVudENvbnRleHQudHJpZ2dlcihpc1N1Y2Nlc3MgPyAnYWpheFN1Y2Nlc3MnIDogJ2FqYXhFcnJvcicsIFsKICAgICAgICAgICAganFYSFIsCiAgICAgICAgICAgIHMsCiAgICAgICAgICAgIGlzU3VjY2VzcyA/IHN1Y2Nlc3MgOiBlcnJvcgogICAgICAgICAgXSk7CiAgICAgICAgfQogICAgICAgIC8vIENvbXBsZXRlCiAgICAgICAgY29tcGxldGVEZWZlcnJlZC5maXJlV2l0aChjYWxsYmFja0NvbnRleHQsIFsKICAgICAgICAgIGpxWEhSLAogICAgICAgICAgc3RhdHVzVGV4dAogICAgICAgIF0pOwogICAgICAgIGlmIChmaXJlR2xvYmFscykgewogICAgICAgICAgZ2xvYmFsRXZlbnRDb250ZXh0LnRyaWdnZXIoJ2FqYXhDb21wbGV0ZScsIFsKICAgICAgICAgICAganFYSFIsCiAgICAgICAgICAgIHMKICAgICAgICAgIF0pOwogICAgICAgICAgLy8gSGFuZGxlIHRoZSBnbG9iYWwgQUpBWCBjb3VudGVyCiAgICAgICAgICBpZiAoIS0talF1ZXJ5LmFjdGl2ZSkgewogICAgICAgICAgICBqUXVlcnkuZXZlbnQudHJpZ2dlcignYWpheFN0b3AnKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIGpxWEhSOwogICAgfSwKICAgIGdldEpTT046IGZ1bmN0aW9uICh1cmwsIGRhdGEsIGNhbGxiYWNrKSB7CiAgICAgIHJldHVybiBqUXVlcnkuZ2V0KHVybCwgZGF0YSwgY2FsbGJhY2ssICdqc29uJyk7CiAgICB9LAogICAgZ2V0U2NyaXB0OiBmdW5jdGlvbiAodXJsLCBjYWxsYmFjaykgewogICAgICByZXR1cm4galF1ZXJ5LmdldCh1cmwsIHVuZGVmaW5lZCwgY2FsbGJhY2ssICdzY3JpcHQnKTsKICAgIH0KICB9KTsKICBqUXVlcnkuZWFjaChbCiAgICAnZ2V0JywKICAgICdwb3N0JwogIF0sIGZ1bmN0aW9uIChpLCBtZXRob2QpIHsKICAgIGpRdWVyeVttZXRob2RdID0gZnVuY3Rpb24gKHVybCwgZGF0YSwgY2FsbGJhY2ssIHR5cGUpIHsKICAgICAgLy8gc2hpZnQgYXJndW1lbnRzIGlmIGRhdGEgYXJndW1lbnQgd2FzIG9taXR0ZWQKICAgICAgaWYgKGpRdWVyeS5pc0Z1bmN0aW9uKGRhdGEpKSB7CiAgICAgICAgdHlwZSA9IHR5cGUgfHwgY2FsbGJhY2s7CiAgICAgICAgY2FsbGJhY2sgPSBkYXRhOwogICAgICAgIGRhdGEgPSB1bmRlZmluZWQ7CiAgICAgIH0KICAgICAgcmV0dXJuIGpRdWVyeS5hamF4KHsKICAgICAgICB1cmw6IHVybCwKICAgICAgICB0eXBlOiBtZXRob2QsCiAgICAgICAgZGF0YVR5cGU6IHR5cGUsCiAgICAgICAgZGF0YTogZGF0YSwKICAgICAgICBzdWNjZXNzOiBjYWxsYmFjawogICAgICB9KTsKICAgIH07CiAgfSk7CiAgLy8gQXR0YWNoIGEgYnVuY2ggb2YgZnVuY3Rpb25zIGZvciBoYW5kbGluZyBjb21tb24gQUpBWCBldmVudHMKICBqUXVlcnkuZWFjaChbCiAgICAnYWpheFN0YXJ0JywKICAgICdhamF4U3RvcCcsCiAgICAnYWpheENvbXBsZXRlJywKICAgICdhamF4RXJyb3InLAogICAgJ2FqYXhTdWNjZXNzJywKICAgICdhamF4U2VuZCcKICBdLCBmdW5jdGlvbiAoaSwgdHlwZSkgewogICAgalF1ZXJ5LmZuW3R5cGVdID0gZnVuY3Rpb24gKGZuKSB7CiAgICAgIHJldHVybiB0aGlzLm9uKHR5cGUsIGZuKTsKICAgIH07CiAgfSk7CiAgalF1ZXJ5Ll9ldmFsVXJsID0gZnVuY3Rpb24gKHVybCkgewogICAgcmV0dXJuIGpRdWVyeS5hamF4KHsKICAgICAgdXJsOiB1cmwsCiAgICAgIHR5cGU6ICdHRVQnLAogICAgICBkYXRhVHlwZTogJ3NjcmlwdCcsCiAgICAgIGFzeW5jOiBmYWxzZSwKICAgICAgZ2xvYmFsOiBmYWxzZSwKICAgICAgJ3Rocm93cyc6IHRydWUKICAgIH0pOwogIH07CiAgalF1ZXJ5LmZuLmV4dGVuZCh7CiAgICB3cmFwQWxsOiBmdW5jdGlvbiAoaHRtbCkgewogICAgICB2YXIgd3JhcDsKICAgICAgaWYgKGpRdWVyeS5pc0Z1bmN0aW9uKGh0bWwpKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoaSkgewogICAgICAgICAgalF1ZXJ5KHRoaXMpLndyYXBBbGwoaHRtbC5jYWxsKHRoaXMsIGkpKTsKICAgICAgICB9KTsKICAgICAgfQogICAgICBpZiAodGhpc1swXSkgewogICAgICAgIC8vIFRoZSBlbGVtZW50cyB0byB3cmFwIHRoZSB0YXJnZXQgYXJvdW5kCiAgICAgICAgd3JhcCA9IGpRdWVyeShodG1sLCB0aGlzWzBdLm93bmVyRG9jdW1lbnQpLmVxKDApLmNsb25lKHRydWUpOwogICAgICAgIGlmICh0aGlzWzBdLnBhcmVudE5vZGUpIHsKICAgICAgICAgIHdyYXAuaW5zZXJ0QmVmb3JlKHRoaXNbMF0pOwogICAgICAgIH0KICAgICAgICB3cmFwLm1hcChmdW5jdGlvbiAoKSB7CiAgICAgICAgICB2YXIgZWxlbSA9IHRoaXM7CiAgICAgICAgICB3aGlsZSAoZWxlbS5maXJzdEVsZW1lbnRDaGlsZCkgewogICAgICAgICAgICBlbGVtID0gZWxlbS5maXJzdEVsZW1lbnRDaGlsZDsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBlbGVtOwogICAgICAgIH0pLmFwcGVuZCh0aGlzKTsKICAgICAgfQogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgICB3cmFwSW5uZXI6IGZ1bmN0aW9uIChodG1sKSB7CiAgICAgIGlmIChqUXVlcnkuaXNGdW5jdGlvbihodG1sKSkgewogICAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24gKGkpIHsKICAgICAgICAgIGpRdWVyeSh0aGlzKS53cmFwSW5uZXIoaHRtbC5jYWxsKHRoaXMsIGkpKTsKICAgICAgICB9KTsKICAgICAgfQogICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgc2VsZiA9IGpRdWVyeSh0aGlzKSwgY29udGVudHMgPSBzZWxmLmNvbnRlbnRzKCk7CiAgICAgICAgaWYgKGNvbnRlbnRzLmxlbmd0aCkgewogICAgICAgICAgY29udGVudHMud3JhcEFsbChodG1sKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgc2VsZi5hcHBlbmQoaHRtbCk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0sCiAgICB3cmFwOiBmdW5jdGlvbiAoaHRtbCkgewogICAgICB2YXIgaXNGdW5jdGlvbiA9IGpRdWVyeS5pc0Z1bmN0aW9uKGh0bWwpOwogICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uIChpKSB7CiAgICAgICAgalF1ZXJ5KHRoaXMpLndyYXBBbGwoaXNGdW5jdGlvbiA/IGh0bWwuY2FsbCh0aGlzLCBpKSA6IGh0bWwpOwogICAgICB9KTsKICAgIH0sCiAgICB1bndyYXA6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIHRoaXMucGFyZW50KCkuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgaWYgKCFqUXVlcnkubm9kZU5hbWUodGhpcywgJ2JvZHknKSkgewogICAgICAgICAgalF1ZXJ5KHRoaXMpLnJlcGxhY2VXaXRoKHRoaXMuY2hpbGROb2Rlcyk7CiAgICAgICAgfQogICAgICB9KS5lbmQoKTsKICAgIH0KICB9KTsKICBqUXVlcnkuZXhwci5maWx0ZXJzLmhpZGRlbiA9IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAvLyBTdXBwb3J0OiBPcGVyYSA8PSAxMi4xMgogICAgLy8gT3BlcmEgcmVwb3J0cyBvZmZzZXRXaWR0aHMgYW5kIG9mZnNldEhlaWdodHMgbGVzcyB0aGFuIHplcm8gb24gc29tZSBlbGVtZW50cwogICAgcmV0dXJuIGVsZW0ub2Zmc2V0V2lkdGggPD0gMCAmJiBlbGVtLm9mZnNldEhlaWdodCA8PSAwOwogIH07CiAgalF1ZXJ5LmV4cHIuZmlsdGVycy52aXNpYmxlID0gZnVuY3Rpb24gKGVsZW0pIHsKICAgIHJldHVybiAhalF1ZXJ5LmV4cHIuZmlsdGVycy5oaWRkZW4oZWxlbSk7CiAgfTsKICB2YXIgcjIwID0gLyUyMC9nLCByYnJhY2tldCA9IC9cW1xdJC8sIHJDUkxGID0gL1xyP1xuL2csIHJzdWJtaXR0ZXJUeXBlcyA9IC9eKD86c3VibWl0fGJ1dHRvbnxpbWFnZXxyZXNldHxmaWxlKSQvaSwgcnN1Ym1pdHRhYmxlID0gL14oPzppbnB1dHxzZWxlY3R8dGV4dGFyZWF8a2V5Z2VuKS9pOwogIGZ1bmN0aW9uIGJ1aWxkUGFyYW1zKHByZWZpeCwgb2JqLCB0cmFkaXRpb25hbCwgYWRkKSB7CiAgICB2YXIgbmFtZTsKICAgIGlmIChqUXVlcnkuaXNBcnJheShvYmopKSB7CiAgICAgIC8vIFNlcmlhbGl6ZSBhcnJheSBpdGVtLgogICAgICBqUXVlcnkuZWFjaChvYmosIGZ1bmN0aW9uIChpLCB2KSB7CiAgICAgICAgaWYgKHRyYWRpdGlvbmFsIHx8IHJicmFja2V0LnRlc3QocHJlZml4KSkgewogICAgICAgICAgLy8gVHJlYXQgZWFjaCBhcnJheSBpdGVtIGFzIGEgc2NhbGFyLgogICAgICAgICAgYWRkKHByZWZpeCwgdik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIC8vIEl0ZW0gaXMgbm9uLXNjYWxhciAoYXJyYXkgb3Igb2JqZWN0KSwgZW5jb2RlIGl0cyBudW1lcmljIGluZGV4LgogICAgICAgICAgYnVpbGRQYXJhbXMocHJlZml4ICsgJ1snICsgKHR5cGVvZiB2ID09PSAnb2JqZWN0JyA/IGkgOiAnJykgKyAnXScsIHYsIHRyYWRpdGlvbmFsLCBhZGQpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9IGVsc2UgaWYgKCF0cmFkaXRpb25hbCAmJiBqUXVlcnkudHlwZShvYmopID09PSAnb2JqZWN0JykgewogICAgICAvLyBTZXJpYWxpemUgb2JqZWN0IGl0ZW0uCiAgICAgIGZvciAobmFtZSBpbiBvYmopIHsKICAgICAgICBidWlsZFBhcmFtcyhwcmVmaXggKyAnWycgKyBuYW1lICsgJ10nLCBvYmpbbmFtZV0sIHRyYWRpdGlvbmFsLCBhZGQpOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICAvLyBTZXJpYWxpemUgc2NhbGFyIGl0ZW0uCiAgICAgIGFkZChwcmVmaXgsIG9iaik7CiAgICB9CiAgfQogIC8vIFNlcmlhbGl6ZSBhbiBhcnJheSBvZiBmb3JtIGVsZW1lbnRzIG9yIGEgc2V0IG9mCiAgLy8ga2V5L3ZhbHVlcyBpbnRvIGEgcXVlcnkgc3RyaW5nCiAgalF1ZXJ5LnBhcmFtID0gZnVuY3Rpb24gKGEsIHRyYWRpdGlvbmFsKSB7CiAgICB2YXIgcHJlZml4LCBzID0gW10sIGFkZCA9IGZ1bmN0aW9uIChrZXksIHZhbHVlKSB7CiAgICAgICAgLy8gSWYgdmFsdWUgaXMgYSBmdW5jdGlvbiwgaW52b2tlIGl0IGFuZCByZXR1cm4gaXRzIHZhbHVlCiAgICAgICAgdmFsdWUgPSBqUXVlcnkuaXNGdW5jdGlvbih2YWx1ZSkgPyB2YWx1ZSgpIDogdmFsdWUgPT0gbnVsbCA/ICcnIDogdmFsdWU7CiAgICAgICAgc1tzLmxlbmd0aF0gPSBlbmNvZGVVUklDb21wb25lbnQoa2V5KSArICc9JyArIGVuY29kZVVSSUNvbXBvbmVudCh2YWx1ZSk7CiAgICAgIH07CiAgICAvLyBTZXQgdHJhZGl0aW9uYWwgdG8gdHJ1ZSBmb3IgalF1ZXJ5IDw9IDEuMy4yIGJlaGF2aW9yLgogICAgaWYgKHRyYWRpdGlvbmFsID09PSB1bmRlZmluZWQpIHsKICAgICAgdHJhZGl0aW9uYWwgPSBqUXVlcnkuYWpheFNldHRpbmdzICYmIGpRdWVyeS5hamF4U2V0dGluZ3MudHJhZGl0aW9uYWw7CiAgICB9CiAgICAvLyBJZiBhbiBhcnJheSB3YXMgcGFzc2VkIGluLCBhc3N1bWUgdGhhdCBpdCBpcyBhbiBhcnJheSBvZiBmb3JtIGVsZW1lbnRzLgogICAgaWYgKGpRdWVyeS5pc0FycmF5KGEpIHx8IGEuanF1ZXJ5ICYmICFqUXVlcnkuaXNQbGFpbk9iamVjdChhKSkgewogICAgICAvLyBTZXJpYWxpemUgdGhlIGZvcm0gZWxlbWVudHMKICAgICAgalF1ZXJ5LmVhY2goYSwgZnVuY3Rpb24gKCkgewogICAgICAgIGFkZCh0aGlzLm5hbWUsIHRoaXMudmFsdWUpOwogICAgICB9KTsKICAgIH0gZWxzZSB7CiAgICAgIC8vIElmIHRyYWRpdGlvbmFsLCBlbmNvZGUgdGhlICJvbGQiIHdheSAodGhlIHdheSAxLjMuMiBvciBvbGRlcgogICAgICAvLyBkaWQgaXQpLCBvdGhlcndpc2UgZW5jb2RlIHBhcmFtcyByZWN1cnNpdmVseS4KICAgICAgZm9yIChwcmVmaXggaW4gYSkgewogICAgICAgIGJ1aWxkUGFyYW1zKHByZWZpeCwgYVtwcmVmaXhdLCB0cmFkaXRpb25hbCwgYWRkKTsKICAgICAgfQogICAgfQogICAgLy8gUmV0dXJuIHRoZSByZXN1bHRpbmcgc2VyaWFsaXphdGlvbgogICAgcmV0dXJuIHMuam9pbignJicpLnJlcGxhY2UocjIwLCAnKycpOwogIH07CiAgalF1ZXJ5LmZuLmV4dGVuZCh7CiAgICBzZXJpYWxpemU6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIGpRdWVyeS5wYXJhbSh0aGlzLnNlcmlhbGl6ZUFycmF5KCkpOwogICAgfSwKICAgIHNlcmlhbGl6ZUFycmF5OiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiB0aGlzLm1hcChmdW5jdGlvbiAoKSB7CiAgICAgICAgLy8gQ2FuIGFkZCBwcm9wSG9vayBmb3IgImVsZW1lbnRzIiB0byBmaWx0ZXIgb3IgYWRkIGZvcm0gZWxlbWVudHMKICAgICAgICB2YXIgZWxlbWVudHMgPSBqUXVlcnkucHJvcCh0aGlzLCAnZWxlbWVudHMnKTsKICAgICAgICByZXR1cm4gZWxlbWVudHMgPyBqUXVlcnkubWFrZUFycmF5KGVsZW1lbnRzKSA6IHRoaXM7CiAgICAgIH0pLmZpbHRlcihmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIHR5cGUgPSB0aGlzLnR5cGU7CiAgICAgICAgLy8gVXNlIC5pcyggIjpkaXNhYmxlZCIgKSBzbyB0aGF0IGZpZWxkc2V0W2Rpc2FibGVkXSB3b3JrcwogICAgICAgIHJldHVybiB0aGlzLm5hbWUgJiYgIWpRdWVyeSh0aGlzKS5pcygnOmRpc2FibGVkJykgJiYgcnN1Ym1pdHRhYmxlLnRlc3QodGhpcy5ub2RlTmFtZSkgJiYgIXJzdWJtaXR0ZXJUeXBlcy50ZXN0KHR5cGUpICYmICh0aGlzLmNoZWNrZWQgfHwgIXJjaGVja2FibGVUeXBlLnRlc3QodHlwZSkpOwogICAgICB9KS5tYXAoZnVuY3Rpb24gKGksIGVsZW0pIHsKICAgICAgICB2YXIgdmFsID0galF1ZXJ5KHRoaXMpLnZhbCgpOwogICAgICAgIHJldHVybiB2YWwgPT0gbnVsbCA/IG51bGwgOiBqUXVlcnkuaXNBcnJheSh2YWwpID8galF1ZXJ5Lm1hcCh2YWwsIGZ1bmN0aW9uICh2YWwpIHsKICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIG5hbWU6IGVsZW0ubmFtZSwKICAgICAgICAgICAgdmFsdWU6IHZhbC5yZXBsYWNlKHJDUkxGLCAnXHJcbicpCiAgICAgICAgICB9OwogICAgICAgIH0pIDogewogICAgICAgICAgbmFtZTogZWxlbS5uYW1lLAogICAgICAgICAgdmFsdWU6IHZhbC5yZXBsYWNlKHJDUkxGLCAnXHJcbicpCiAgICAgICAgfTsKICAgICAgfSkuZ2V0KCk7CiAgICB9CiAgfSk7CiAgalF1ZXJ5LmFqYXhTZXR0aW5ncy54aHIgPSBmdW5jdGlvbiAoKSB7CiAgICB0cnkgewogICAgICByZXR1cm4gbmV3IFhNTEh0dHBSZXF1ZXN0KCk7CiAgICB9IGNhdGNoIChlKSB7CiAgICB9CiAgfTsKICB2YXIgeGhySWQgPSAwLCB4aHJDYWxsYmFja3MgPSB7fSwgeGhyU3VjY2Vzc1N0YXR1cyA9IHsKICAgICAgLy8gZmlsZSBwcm90b2NvbCBhbHdheXMgeWllbGRzIHN0YXR1cyBjb2RlIDAsIGFzc3VtZSAyMDAKICAgICAgMDogMjAwLAogICAgICAvLyBTdXBwb3J0OiBJRTkKICAgICAgLy8gIzE0NTA6IHNvbWV0aW1lcyBJRSByZXR1cm5zIDEyMjMgd2hlbiBpdCBzaG91bGQgYmUgMjA0CiAgICAgIDEyMjM6IDIwNAogICAgfSwgeGhyU3VwcG9ydGVkID0galF1ZXJ5LmFqYXhTZXR0aW5ncy54aHIoKTsKICAvLyBTdXBwb3J0OiBJRTkKICAvLyBPcGVuIHJlcXVlc3RzIG11c3QgYmUgbWFudWFsbHkgYWJvcnRlZCBvbiB1bmxvYWQgKCM1MjgwKQogIGlmICh3aW5kb3cuQWN0aXZlWE9iamVjdCkgewogICAgalF1ZXJ5KHdpbmRvdykub24oJ3VubG9hZCcsIGZ1bmN0aW9uICgpIHsKICAgICAgZm9yICh2YXIga2V5IGluIHhockNhbGxiYWNrcykgewogICAgICAgIHhockNhbGxiYWNrc1trZXldKCk7CiAgICAgIH0KICAgIH0pOwogIH0KICBzdXBwb3J0LmNvcnMgPSAhIXhoclN1cHBvcnRlZCAmJiAnd2l0aENyZWRlbnRpYWxzJyBpbiB4aHJTdXBwb3J0ZWQ7CiAgc3VwcG9ydC5hamF4ID0geGhyU3VwcG9ydGVkID0gISF4aHJTdXBwb3J0ZWQ7CiAgalF1ZXJ5LmFqYXhUcmFuc3BvcnQoZnVuY3Rpb24gKG9wdGlvbnMpIHsKICAgIHZhciBjYWxsYmFjazsKICAgIC8vIENyb3NzIGRvbWFpbiBvbmx5IGFsbG93ZWQgaWYgc3VwcG9ydGVkIHRocm91Z2ggWE1MSHR0cFJlcXVlc3QKICAgIGlmIChzdXBwb3J0LmNvcnMgfHwgeGhyU3VwcG9ydGVkICYmICFvcHRpb25zLmNyb3NzRG9tYWluKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgc2VuZDogZnVuY3Rpb24gKGhlYWRlcnMsIGNvbXBsZXRlKSB7CiAgICAgICAgICB2YXIgaSwgeGhyID0gb3B0aW9ucy54aHIoKSwgaWQgPSArK3hocklkOwogICAgICAgICAgeGhyLm9wZW4ob3B0aW9ucy50eXBlLCBvcHRpb25zLnVybCwgb3B0aW9ucy5hc3luYywgb3B0aW9ucy51c2VybmFtZSwgb3B0aW9ucy5wYXNzd29yZCk7CiAgICAgICAgICAvLyBBcHBseSBjdXN0b20gZmllbGRzIGlmIHByb3ZpZGVkCiAgICAgICAgICBpZiAob3B0aW9ucy54aHJGaWVsZHMpIHsKICAgICAgICAgICAgZm9yIChpIGluIG9wdGlvbnMueGhyRmllbGRzKSB7CiAgICAgICAgICAgICAgeGhyW2ldID0gb3B0aW9ucy54aHJGaWVsZHNbaV07CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIC8vIE92ZXJyaWRlIG1pbWUgdHlwZSBpZiBuZWVkZWQKICAgICAgICAgIGlmIChvcHRpb25zLm1pbWVUeXBlICYmIHhoci5vdmVycmlkZU1pbWVUeXBlKSB7CiAgICAgICAgICAgIHhoci5vdmVycmlkZU1pbWVUeXBlKG9wdGlvbnMubWltZVR5cGUpOwogICAgICAgICAgfQogICAgICAgICAgLy8gWC1SZXF1ZXN0ZWQtV2l0aCBoZWFkZXIKICAgICAgICAgIC8vIEZvciBjcm9zcy1kb21haW4gcmVxdWVzdHMsIHNlZWluZyBhcyBjb25kaXRpb25zIGZvciBhIHByZWZsaWdodCBhcmUKICAgICAgICAgIC8vIGFraW4gdG8gYSBqaWdzYXcgcHV6emxlLCB3ZSBzaW1wbHkgbmV2ZXIgc2V0IGl0IHRvIGJlIHN1cmUuCiAgICAgICAgICAvLyAoaXQgY2FuIGFsd2F5cyBiZSBzZXQgb24gYSBwZXItcmVxdWVzdCBiYXNpcyBvciBldmVuIHVzaW5nIGFqYXhTZXR1cCkKICAgICAgICAgIC8vIEZvciBzYW1lLWRvbWFpbiByZXF1ZXN0cywgd29uJ3QgY2hhbmdlIGhlYWRlciBpZiBhbHJlYWR5IHByb3ZpZGVkLgogICAgICAgICAgaWYgKCFvcHRpb25zLmNyb3NzRG9tYWluICYmICFoZWFkZXJzWydYLVJlcXVlc3RlZC1XaXRoJ10pIHsKICAgICAgICAgICAgaGVhZGVyc1snWC1SZXF1ZXN0ZWQtV2l0aCddID0gJ1hNTEh0dHBSZXF1ZXN0JzsKICAgICAgICAgIH0KICAgICAgICAgIC8vIFNldCBoZWFkZXJzCiAgICAgICAgICBmb3IgKGkgaW4gaGVhZGVycykgewogICAgICAgICAgICB4aHIuc2V0UmVxdWVzdEhlYWRlcihpLCBoZWFkZXJzW2ldKTsKICAgICAgICAgIH0KICAgICAgICAgIC8vIENhbGxiYWNrCiAgICAgICAgICBjYWxsYmFjayA9IGZ1bmN0aW9uICh0eXBlKSB7CiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgaWYgKGNhbGxiYWNrKSB7CiAgICAgICAgICAgICAgICBkZWxldGUgeGhyQ2FsbGJhY2tzW2lkXTsKICAgICAgICAgICAgICAgIGNhbGxiYWNrID0geGhyLm9ubG9hZCA9IHhoci5vbmVycm9yID0gbnVsbDsKICAgICAgICAgICAgICAgIGlmICh0eXBlID09PSAnYWJvcnQnKSB7CiAgICAgICAgICAgICAgICAgIHhoci5hYm9ydCgpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnZXJyb3InKSB7CiAgICAgICAgICAgICAgICAgIGNvbXBsZXRlKC8vIGZpbGU6IHByb3RvY29sIGFsd2F5cyB5aWVsZHMgc3RhdHVzIDA7IHNlZSAjODYwNSwgIzE0MjA3CiAgICAgICAgICAgICAgICAgIHhoci5zdGF0dXMsIHhoci5zdGF0dXNUZXh0KTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGNvbXBsZXRlKHhoclN1Y2Nlc3NTdGF0dXNbeGhyLnN0YXR1c10gfHwgeGhyLnN0YXR1cywgeGhyLnN0YXR1c1RleHQsIC8vIFN1cHBvcnQ6IElFOQogICAgICAgICAgICAgICAgICAvLyBBY2Nlc3NpbmcgYmluYXJ5LWRhdGEgcmVzcG9uc2VUZXh0IHRocm93cyBhbiBleGNlcHRpb24KICAgICAgICAgICAgICAgICAgLy8gKCMxMTQyNikKICAgICAgICAgICAgICAgICAgdHlwZW9mIHhoci5yZXNwb25zZVRleHQgPT09ICdzdHJpbmcnID8geyB0ZXh0OiB4aHIucmVzcG9uc2VUZXh0IH0gOiB1bmRlZmluZWQsIHhoci5nZXRBbGxSZXNwb25zZUhlYWRlcnMoKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgICAgfTsKICAgICAgICAgIC8vIExpc3RlbiB0byBldmVudHMKICAgICAgICAgIHhoci5vbmxvYWQgPSBjYWxsYmFjaygpOwogICAgICAgICAgeGhyLm9uZXJyb3IgPSBjYWxsYmFjaygnZXJyb3InKTsKICAgICAgICAgIC8vIENyZWF0ZSB0aGUgYWJvcnQgY2FsbGJhY2sKICAgICAgICAgIGNhbGxiYWNrID0geGhyQ2FsbGJhY2tzW2lkXSA9IGNhbGxiYWNrKCdhYm9ydCcpOwogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgLy8gRG8gc2VuZCB0aGUgcmVxdWVzdCAodGhpcyBtYXkgcmFpc2UgYW4gZXhjZXB0aW9uKQogICAgICAgICAgICB4aHIuc2VuZChvcHRpb25zLmhhc0NvbnRlbnQgJiYgb3B0aW9ucy5kYXRhIHx8IG51bGwpOwogICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAvLyAjMTQ2ODM6IE9ubHkgcmV0aHJvdyBpZiB0aGlzIGhhc24ndCBiZWVuIG5vdGlmaWVkIGFzIGFuIGVycm9yIHlldAogICAgICAgICAgICBpZiAoY2FsbGJhY2spIHsKICAgICAgICAgICAgICB0aHJvdyBlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBhYm9ydDogZnVuY3Rpb24gKCkgewogICAgICAgICAgaWYgKGNhbGxiYWNrKSB7CiAgICAgICAgICAgIGNhbGxiYWNrKCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9OwogICAgfQogIH0pOwogIC8vIEluc3RhbGwgc2NyaXB0IGRhdGFUeXBlCiAgalF1ZXJ5LmFqYXhTZXR1cCh7CiAgICBhY2NlcHRzOiB7IHNjcmlwdDogJ3RleHQvamF2YXNjcmlwdCwgYXBwbGljYXRpb24vamF2YXNjcmlwdCwgYXBwbGljYXRpb24vZWNtYXNjcmlwdCwgYXBwbGljYXRpb24veC1lY21hc2NyaXB0JyB9LAogICAgY29udGVudHM6IHsgc2NyaXB0OiAvKD86amF2YXxlY21hKXNjcmlwdC8gfSwKICAgIGNvbnZlcnRlcnM6IHsKICAgICAgJ3RleHQgc2NyaXB0JzogZnVuY3Rpb24gKHRleHQpIHsKICAgICAgICBqUXVlcnkuZ2xvYmFsRXZhbCh0ZXh0KTsKICAgICAgICByZXR1cm4gdGV4dDsKICAgICAgfQogICAgfQogIH0pOwogIC8vIEhhbmRsZSBjYWNoZSdzIHNwZWNpYWwgY2FzZSBhbmQgY3Jvc3NEb21haW4KICBqUXVlcnkuYWpheFByZWZpbHRlcignc2NyaXB0JywgZnVuY3Rpb24gKHMpIHsKICAgIGlmIChzLmNhY2hlID09PSB1bmRlZmluZWQpIHsKICAgICAgcy5jYWNoZSA9IGZhbHNlOwogICAgfQogICAgaWYgKHMuY3Jvc3NEb21haW4pIHsKICAgICAgcy50eXBlID0gJ0dFVCc7CiAgICB9CiAgfSk7CiAgLy8gQmluZCBzY3JpcHQgdGFnIGhhY2sgdHJhbnNwb3J0CiAgalF1ZXJ5LmFqYXhUcmFuc3BvcnQoJ3NjcmlwdCcsIGZ1bmN0aW9uIChzKSB7CiAgICAvLyBUaGlzIHRyYW5zcG9ydCBvbmx5IGRlYWxzIHdpdGggY3Jvc3MgZG9tYWluIHJlcXVlc3RzCiAgICBpZiAocy5jcm9zc0RvbWFpbikgewogICAgICB2YXIgc2NyaXB0LCBjYWxsYmFjazsKICAgICAgcmV0dXJuIHsKICAgICAgICBzZW5kOiBmdW5jdGlvbiAoXywgY29tcGxldGUpIHsKICAgICAgICAgIHNjcmlwdCA9IGpRdWVyeSgnPHNjcmlwdD4nKS5wcm9wKHsKICAgICAgICAgICAgYXN5bmM6IHRydWUsCiAgICAgICAgICAgIGNoYXJzZXQ6IHMuc2NyaXB0Q2hhcnNldCwKICAgICAgICAgICAgc3JjOiBzLnVybAogICAgICAgICAgfSkub24oJ2xvYWQgZXJyb3InLCBjYWxsYmFjayA9IGZ1bmN0aW9uIChldnQpIHsKICAgICAgICAgICAgc2NyaXB0LnJlbW92ZSgpOwogICAgICAgICAgICBjYWxsYmFjayA9IG51bGw7CiAgICAgICAgICAgIGlmIChldnQpIHsKICAgICAgICAgICAgICBjb21wbGV0ZShldnQudHlwZSA9PT0gJ2Vycm9yJyA/IDQwNCA6IDIwMCwgZXZ0LnR5cGUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICAgIGRvY3VtZW50LmhlYWQuYXBwZW5kQ2hpbGQoc2NyaXB0WzBdKTsKICAgICAgICB9LAogICAgICAgIGFib3J0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBpZiAoY2FsbGJhY2spIHsKICAgICAgICAgICAgY2FsbGJhY2soKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH07CiAgICB9CiAgfSk7CiAgdmFyIG9sZENhbGxiYWNrcyA9IFtdLCByanNvbnAgPSAvKD0pXD8oPz0mfCQpfFw/XD8vOwogIC8vIERlZmF1bHQganNvbnAgc2V0dGluZ3MKICBqUXVlcnkuYWpheFNldHVwKHsKICAgIGpzb25wOiAnY2FsbGJhY2snLAogICAganNvbnBDYWxsYmFjazogZnVuY3Rpb24gKCkgewogICAgICB2YXIgY2FsbGJhY2sgPSBvbGRDYWxsYmFja3MucG9wKCkgfHwgalF1ZXJ5LmV4cGFuZG8gKyAnXycgKyBub25jZSsrOwogICAgICB0aGlzW2NhbGxiYWNrXSA9IHRydWU7CiAgICAgIHJldHVybiBjYWxsYmFjazsKICAgIH0KICB9KTsKICAvLyBEZXRlY3QsIG5vcm1hbGl6ZSBvcHRpb25zIGFuZCBpbnN0YWxsIGNhbGxiYWNrcyBmb3IganNvbnAgcmVxdWVzdHMKICBqUXVlcnkuYWpheFByZWZpbHRlcignanNvbiBqc29ucCcsIGZ1bmN0aW9uIChzLCBvcmlnaW5hbFNldHRpbmdzLCBqcVhIUikgewogICAgdmFyIGNhbGxiYWNrTmFtZSwgb3ZlcndyaXR0ZW4sIHJlc3BvbnNlQ29udGFpbmVyLCBqc29uUHJvcCA9IHMuanNvbnAgIT09IGZhbHNlICYmIChyanNvbnAudGVzdChzLnVybCkgPyAndXJsJyA6IHR5cGVvZiBzLmRhdGEgPT09ICdzdHJpbmcnICYmICEocy5jb250ZW50VHlwZSB8fCAnJykuaW5kZXhPZignYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkJykgJiYgcmpzb25wLnRlc3Qocy5kYXRhKSAmJiAnZGF0YScpOwogICAgLy8gSGFuZGxlIGlmZiB0aGUgZXhwZWN0ZWQgZGF0YSB0eXBlIGlzICJqc29ucCIgb3Igd2UgaGF2ZSBhIHBhcmFtZXRlciB0byBzZXQKICAgIGlmIChqc29uUHJvcCB8fCBzLmRhdGFUeXBlc1swXSA9PT0gJ2pzb25wJykgewogICAgICAvLyBHZXQgY2FsbGJhY2sgbmFtZSwgcmVtZW1iZXJpbmcgcHJlZXhpc3RpbmcgdmFsdWUgYXNzb2NpYXRlZCB3aXRoIGl0CiAgICAgIGNhbGxiYWNrTmFtZSA9IHMuanNvbnBDYWxsYmFjayA9IGpRdWVyeS5pc0Z1bmN0aW9uKHMuanNvbnBDYWxsYmFjaykgPyBzLmpzb25wQ2FsbGJhY2soKSA6IHMuanNvbnBDYWxsYmFjazsKICAgICAgLy8gSW5zZXJ0IGNhbGxiYWNrIGludG8gdXJsIG9yIGZvcm0gZGF0YQogICAgICBpZiAoanNvblByb3ApIHsKICAgICAgICBzW2pzb25Qcm9wXSA9IHNbanNvblByb3BdLnJlcGxhY2Uocmpzb25wLCAnJDEnICsgY2FsbGJhY2tOYW1lKTsKICAgICAgfSBlbHNlIGlmIChzLmpzb25wICE9PSBmYWxzZSkgewogICAgICAgIHMudXJsICs9IChycXVlcnkudGVzdChzLnVybCkgPyAnJicgOiAnPycpICsgcy5qc29ucCArICc9JyArIGNhbGxiYWNrTmFtZTsKICAgICAgfQogICAgICAvLyBVc2UgZGF0YSBjb252ZXJ0ZXIgdG8gcmV0cmlldmUganNvbiBhZnRlciBzY3JpcHQgZXhlY3V0aW9uCiAgICAgIHMuY29udmVydGVyc1snc2NyaXB0IGpzb24nXSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBpZiAoIXJlc3BvbnNlQ29udGFpbmVyKSB7CiAgICAgICAgICBqUXVlcnkuZXJyb3IoY2FsbGJhY2tOYW1lICsgJyB3YXMgbm90IGNhbGxlZCcpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzcG9uc2VDb250YWluZXJbMF07CiAgICAgIH07CiAgICAgIC8vIGZvcmNlIGpzb24gZGF0YVR5cGUKICAgICAgcy5kYXRhVHlwZXNbMF0gPSAnanNvbic7CiAgICAgIC8vIEluc3RhbGwgY2FsbGJhY2sKICAgICAgb3ZlcndyaXR0ZW4gPSB3aW5kb3dbY2FsbGJhY2tOYW1lXTsKICAgICAgd2luZG93W2NhbGxiYWNrTmFtZV0gPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmVzcG9uc2VDb250YWluZXIgPSBhcmd1bWVudHM7CiAgICAgIH07CiAgICAgIC8vIENsZWFuLXVwIGZ1bmN0aW9uIChmaXJlcyBhZnRlciBjb252ZXJ0ZXJzKQogICAgICBqcVhIUi5hbHdheXMoZnVuY3Rpb24gKCkgewogICAgICAgIC8vIFJlc3RvcmUgcHJlZXhpc3RpbmcgdmFsdWUKICAgICAgICB3aW5kb3dbY2FsbGJhY2tOYW1lXSA9IG92ZXJ3cml0dGVuOwogICAgICAgIC8vIFNhdmUgYmFjayBhcyBmcmVlCiAgICAgICAgaWYgKHNbY2FsbGJhY2tOYW1lXSkgewogICAgICAgICAgLy8gbWFrZSBzdXJlIHRoYXQgcmUtdXNpbmcgdGhlIG9wdGlvbnMgZG9lc24ndCBzY3JldyB0aGluZ3MgYXJvdW5kCiAgICAgICAgICBzLmpzb25wQ2FsbGJhY2sgPSBvcmlnaW5hbFNldHRpbmdzLmpzb25wQ2FsbGJhY2s7CiAgICAgICAgICAvLyBzYXZlIHRoZSBjYWxsYmFjayBuYW1lIGZvciBmdXR1cmUgdXNlCiAgICAgICAgICBvbGRDYWxsYmFja3MucHVzaChjYWxsYmFja05hbWUpOwogICAgICAgIH0KICAgICAgICAvLyBDYWxsIGlmIGl0IHdhcyBhIGZ1bmN0aW9uIGFuZCB3ZSBoYXZlIGEgcmVzcG9uc2UKICAgICAgICBpZiAocmVzcG9uc2VDb250YWluZXIgJiYgalF1ZXJ5LmlzRnVuY3Rpb24ob3ZlcndyaXR0ZW4pKSB7CiAgICAgICAgICBvdmVyd3JpdHRlbihyZXNwb25zZUNvbnRhaW5lclswXSk7CiAgICAgICAgfQogICAgICAgIHJlc3BvbnNlQ29udGFpbmVyID0gb3ZlcndyaXR0ZW4gPSB1bmRlZmluZWQ7CiAgICAgIH0pOwogICAgICAvLyBEZWxlZ2F0ZSB0byBzY3JpcHQKICAgICAgcmV0dXJuICdzY3JpcHQnOwogICAgfQogIH0pOwogIC8vIGRhdGE6IHN0cmluZyBvZiBodG1sCiAgLy8gY29udGV4dCAob3B0aW9uYWwpOiBJZiBzcGVjaWZpZWQsIHRoZSBmcmFnbWVudCB3aWxsIGJlIGNyZWF0ZWQgaW4gdGhpcyBjb250ZXh0LCBkZWZhdWx0cyB0byBkb2N1bWVudAogIC8vIGtlZXBTY3JpcHRzIChvcHRpb25hbCk6IElmIHRydWUsIHdpbGwgaW5jbHVkZSBzY3JpcHRzIHBhc3NlZCBpbiB0aGUgaHRtbCBzdHJpbmcKICBqUXVlcnkucGFyc2VIVE1MID0gZnVuY3Rpb24gKGRhdGEsIGNvbnRleHQsIGtlZXBTY3JpcHRzKSB7CiAgICBpZiAoIWRhdGEgfHwgdHlwZW9mIGRhdGEgIT09ICdzdHJpbmcnKSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfQogICAgaWYgKHR5cGVvZiBjb250ZXh0ID09PSAnYm9vbGVhbicpIHsKICAgICAga2VlcFNjcmlwdHMgPSBjb250ZXh0OwogICAgICBjb250ZXh0ID0gZmFsc2U7CiAgICB9CiAgICBjb250ZXh0ID0gY29udGV4dCB8fCBkb2N1bWVudDsKICAgIHZhciBwYXJzZWQgPSByc2luZ2xlVGFnLmV4ZWMoZGF0YSksIHNjcmlwdHMgPSAha2VlcFNjcmlwdHMgJiYgW107CiAgICAvLyBTaW5nbGUgdGFnCiAgICBpZiAocGFyc2VkKSB7CiAgICAgIHJldHVybiBbY29udGV4dC5jcmVhdGVFbGVtZW50KHBhcnNlZFsxXSldOwogICAgfQogICAgcGFyc2VkID0galF1ZXJ5LmJ1aWxkRnJhZ21lbnQoW2RhdGFdLCBjb250ZXh0LCBzY3JpcHRzKTsKICAgIGlmIChzY3JpcHRzICYmIHNjcmlwdHMubGVuZ3RoKSB7CiAgICAgIGpRdWVyeShzY3JpcHRzKS5yZW1vdmUoKTsKICAgIH0KICAgIHJldHVybiBqUXVlcnkubWVyZ2UoW10sIHBhcnNlZC5jaGlsZE5vZGVzKTsKICB9OwogIC8vIEtlZXAgYSBjb3B5IG9mIHRoZSBvbGQgbG9hZCBtZXRob2QKICB2YXIgX2xvYWQgPSBqUXVlcnkuZm4ubG9hZDsKICAvKioKICAgKiBMb2FkIGEgdXJsIGludG8gYSBwYWdlCiAgICovCiAgalF1ZXJ5LmZuLmxvYWQgPSBmdW5jdGlvbiAodXJsLCBwYXJhbXMsIGNhbGxiYWNrKSB7CiAgICBpZiAodHlwZW9mIHVybCAhPT0gJ3N0cmluZycgJiYgX2xvYWQpIHsKICAgICAgcmV0dXJuIF9sb2FkLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9CiAgICB2YXIgc2VsZWN0b3IsIHR5cGUsIHJlc3BvbnNlLCBzZWxmID0gdGhpcywgb2ZmID0gdXJsLmluZGV4T2YoJyAnKTsKICAgIGlmIChvZmYgPj0gMCkgewogICAgICBzZWxlY3RvciA9IGpRdWVyeS50cmltKHVybC5zbGljZShvZmYpKTsKICAgICAgdXJsID0gdXJsLnNsaWNlKDAsIG9mZik7CiAgICB9CiAgICAvLyBJZiBpdCdzIGEgZnVuY3Rpb24KICAgIGlmIChqUXVlcnkuaXNGdW5jdGlvbihwYXJhbXMpKSB7CiAgICAgIC8vIFdlIGFzc3VtZSB0aGF0IGl0J3MgdGhlIGNhbGxiYWNrCiAgICAgIGNhbGxiYWNrID0gcGFyYW1zOwogICAgICBwYXJhbXMgPSB1bmRlZmluZWQ7ICAvLyBPdGhlcndpc2UsIGJ1aWxkIGEgcGFyYW0gc3RyaW5nCiAgICB9IGVsc2UgaWYgKHBhcmFtcyAmJiB0eXBlb2YgcGFyYW1zID09PSAnb2JqZWN0JykgewogICAgICB0eXBlID0gJ1BPU1QnOwogICAgfQogICAgLy8gSWYgd2UgaGF2ZSBlbGVtZW50cyB0byBtb2RpZnksIG1ha2UgdGhlIHJlcXVlc3QKICAgIGlmIChzZWxmLmxlbmd0aCA+IDApIHsKICAgICAgalF1ZXJ5LmFqYXgoewogICAgICAgIHVybDogdXJsLAogICAgICAgIC8vIGlmICJ0eXBlIiB2YXJpYWJsZSBpcyB1bmRlZmluZWQsIHRoZW4gIkdFVCIgbWV0aG9kIHdpbGwgYmUgdXNlZAogICAgICAgIHR5cGU6IHR5cGUsCiAgICAgICAgZGF0YVR5cGU6ICdodG1sJywKICAgICAgICBkYXRhOiBwYXJhbXMKICAgICAgfSkuZG9uZShmdW5jdGlvbiAocmVzcG9uc2VUZXh0KSB7CiAgICAgICAgLy8gU2F2ZSByZXNwb25zZSBmb3IgdXNlIGluIGNvbXBsZXRlIGNhbGxiYWNrCiAgICAgICAgcmVzcG9uc2UgPSBhcmd1bWVudHM7CiAgICAgICAgc2VsZi5odG1sKHNlbGVjdG9yID8gLy8gSWYgYSBzZWxlY3RvciB3YXMgc3BlY2lmaWVkLCBsb2NhdGUgdGhlIHJpZ2h0IGVsZW1lbnRzIGluIGEgZHVtbXkgZGl2CiAgICAgICAgLy8gRXhjbHVkZSBzY3JpcHRzIHRvIGF2b2lkIElFICdQZXJtaXNzaW9uIERlbmllZCcgZXJyb3JzCiAgICAgICAgalF1ZXJ5KCc8ZGl2PicpLmFwcGVuZChqUXVlcnkucGFyc2VIVE1MKHJlc3BvbnNlVGV4dCkpLmZpbmQoc2VsZWN0b3IpIDogLy8gT3RoZXJ3aXNlIHVzZSB0aGUgZnVsbCByZXN1bHQKICAgICAgICByZXNwb25zZVRleHQpOwogICAgICB9KS5jb21wbGV0ZShjYWxsYmFjayAmJiBmdW5jdGlvbiAoanFYSFIsIHN0YXR1cykgewogICAgICAgIHNlbGYuZWFjaChjYWxsYmFjaywgcmVzcG9uc2UgfHwgWwogICAgICAgICAganFYSFIucmVzcG9uc2VUZXh0LAogICAgICAgICAgc3RhdHVzLAogICAgICAgICAganFYSFIKICAgICAgICBdKTsKICAgICAgfSk7CiAgICB9CiAgICByZXR1cm4gdGhpczsKICB9OwogIGpRdWVyeS5leHByLmZpbHRlcnMuYW5pbWF0ZWQgPSBmdW5jdGlvbiAoZWxlbSkgewogICAgcmV0dXJuIGpRdWVyeS5ncmVwKGpRdWVyeS50aW1lcnMsIGZ1bmN0aW9uIChmbikgewogICAgICByZXR1cm4gZWxlbSA9PT0gZm4uZWxlbTsKICAgIH0pLmxlbmd0aDsKICB9OwogIHZhciBkb2NFbGVtID0gd2luZG93LmRvY3VtZW50LmRvY3VtZW50RWxlbWVudDsKICAvKioKICAgKiBHZXRzIGEgd2luZG93IGZyb20gYW4gZWxlbWVudAogICAqLwogIGZ1bmN0aW9uIGdldFdpbmRvdyhlbGVtKSB7CiAgICByZXR1cm4galF1ZXJ5LmlzV2luZG93KGVsZW0pID8gZWxlbSA6IGVsZW0ubm9kZVR5cGUgPT09IDkgJiYgZWxlbS5kZWZhdWx0VmlldzsKICB9CiAgalF1ZXJ5Lm9mZnNldCA9IHsKICAgIHNldE9mZnNldDogZnVuY3Rpb24gKGVsZW0sIG9wdGlvbnMsIGkpIHsKICAgICAgdmFyIGN1clBvc2l0aW9uLCBjdXJMZWZ0LCBjdXJDU1NUb3AsIGN1clRvcCwgY3VyT2Zmc2V0LCBjdXJDU1NMZWZ0LCBjYWxjdWxhdGVQb3NpdGlvbiwgcG9zaXRpb24gPSBqUXVlcnkuY3NzKGVsZW0sICdwb3NpdGlvbicpLCBjdXJFbGVtID0galF1ZXJ5KGVsZW0pLCBwcm9wcyA9IHt9OwogICAgICAvLyBTZXQgcG9zaXRpb24gZmlyc3QsIGluLWNhc2UgdG9wL2xlZnQgYXJlIHNldCBldmVuIG9uIHN0YXRpYyBlbGVtCiAgICAgIGlmIChwb3NpdGlvbiA9PT0gJ3N0YXRpYycpIHsKICAgICAgICBlbGVtLnN0eWxlLnBvc2l0aW9uID0gJ3JlbGF0aXZlJzsKICAgICAgfQogICAgICBjdXJPZmZzZXQgPSBjdXJFbGVtLm9mZnNldCgpOwogICAgICBjdXJDU1NUb3AgPSBqUXVlcnkuY3NzKGVsZW0sICd0b3AnKTsKICAgICAgY3VyQ1NTTGVmdCA9IGpRdWVyeS5jc3MoZWxlbSwgJ2xlZnQnKTsKICAgICAgY2FsY3VsYXRlUG9zaXRpb24gPSAocG9zaXRpb24gPT09ICdhYnNvbHV0ZScgfHwgcG9zaXRpb24gPT09ICdmaXhlZCcpICYmIChjdXJDU1NUb3AgKyBjdXJDU1NMZWZ0KS5pbmRleE9mKCdhdXRvJykgPiAtMTsKICAgICAgLy8gTmVlZCB0byBiZSBhYmxlIHRvIGNhbGN1bGF0ZSBwb3NpdGlvbiBpZiBlaXRoZXIgdG9wIG9yIGxlZnQgaXMgYXV0byBhbmQgcG9zaXRpb24gaXMgZWl0aGVyIGFic29sdXRlIG9yIGZpeGVkCiAgICAgIGlmIChjYWxjdWxhdGVQb3NpdGlvbikgewogICAgICAgIGN1clBvc2l0aW9uID0gY3VyRWxlbS5wb3NpdGlvbigpOwogICAgICAgIGN1clRvcCA9IGN1clBvc2l0aW9uLnRvcDsKICAgICAgICBjdXJMZWZ0ID0gY3VyUG9zaXRpb24ubGVmdDsKICAgICAgfSBlbHNlIHsKICAgICAgICBjdXJUb3AgPSBwYXJzZUZsb2F0KGN1ckNTU1RvcCkgfHwgMDsKICAgICAgICBjdXJMZWZ0ID0gcGFyc2VGbG9hdChjdXJDU1NMZWZ0KSB8fCAwOwogICAgICB9CiAgICAgIGlmIChqUXVlcnkuaXNGdW5jdGlvbihvcHRpb25zKSkgewogICAgICAgIG9wdGlvbnMgPSBvcHRpb25zLmNhbGwoZWxlbSwgaSwgY3VyT2Zmc2V0KTsKICAgICAgfQogICAgICBpZiAob3B0aW9ucy50b3AgIT0gbnVsbCkgewogICAgICAgIHByb3BzLnRvcCA9IG9wdGlvbnMudG9wIC0gY3VyT2Zmc2V0LnRvcCArIGN1clRvcDsKICAgICAgfQogICAgICBpZiAob3B0aW9ucy5sZWZ0ICE9IG51bGwpIHsKICAgICAgICBwcm9wcy5sZWZ0ID0gb3B0aW9ucy5sZWZ0IC0gY3VyT2Zmc2V0LmxlZnQgKyBjdXJMZWZ0OwogICAgICB9CiAgICAgIGlmICgndXNpbmcnIGluIG9wdGlvbnMpIHsKICAgICAgICBvcHRpb25zLnVzaW5nLmNhbGwoZWxlbSwgcHJvcHMpOwogICAgICB9IGVsc2UgewogICAgICAgIGN1ckVsZW0uY3NzKHByb3BzKTsKICAgICAgfQogICAgfQogIH07CiAgalF1ZXJ5LmZuLmV4dGVuZCh7CiAgICBvZmZzZXQ6IGZ1bmN0aW9uIChvcHRpb25zKSB7CiAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoKSB7CiAgICAgICAgcmV0dXJuIG9wdGlvbnMgPT09IHVuZGVmaW5lZCA/IHRoaXMgOiB0aGlzLmVhY2goZnVuY3Rpb24gKGkpIHsKICAgICAgICAgIGpRdWVyeS5vZmZzZXQuc2V0T2Zmc2V0KHRoaXMsIG9wdGlvbnMsIGkpOwogICAgICAgIH0pOwogICAgICB9CiAgICAgIHZhciBkb2NFbGVtLCB3aW4sIGVsZW0gPSB0aGlzWzBdLCBib3ggPSB7CiAgICAgICAgICB0b3A6IDAsCiAgICAgICAgICBsZWZ0OiAwCiAgICAgICAgfSwgZG9jID0gZWxlbSAmJiBlbGVtLm93bmVyRG9jdW1lbnQ7CiAgICAgIGlmICghZG9jKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIGRvY0VsZW0gPSBkb2MuZG9jdW1lbnRFbGVtZW50OwogICAgICAvLyBNYWtlIHN1cmUgaXQncyBub3QgYSBkaXNjb25uZWN0ZWQgRE9NIG5vZGUKICAgICAgaWYgKCFqUXVlcnkuY29udGFpbnMoZG9jRWxlbSwgZWxlbSkpIHsKICAgICAgICByZXR1cm4gYm94OwogICAgICB9CiAgICAgIC8vIElmIHdlIGRvbid0IGhhdmUgZ0JDUiwganVzdCB1c2UgMCwwIHJhdGhlciB0aGFuIGVycm9yCiAgICAgIC8vIEJsYWNrQmVycnkgNSwgaU9TIDMgKG9yaWdpbmFsIGlQaG9uZSkKICAgICAgaWYgKHR5cGVvZiBlbGVtLmdldEJvdW5kaW5nQ2xpZW50UmVjdCAhPT0gc3RydW5kZWZpbmVkKSB7CiAgICAgICAgYm94ID0gZWxlbS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsKICAgICAgfQogICAgICB3aW4gPSBnZXRXaW5kb3coZG9jKTsKICAgICAgcmV0dXJuIHsKICAgICAgICB0b3A6IGJveC50b3AgKyB3aW4ucGFnZVlPZmZzZXQgLSBkb2NFbGVtLmNsaWVudFRvcCwKICAgICAgICBsZWZ0OiBib3gubGVmdCArIHdpbi5wYWdlWE9mZnNldCAtIGRvY0VsZW0uY2xpZW50TGVmdAogICAgICB9OwogICAgfSwKICAgIHBvc2l0aW9uOiBmdW5jdGlvbiAoKSB7CiAgICAgIGlmICghdGhpc1swXSkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICB2YXIgb2Zmc2V0UGFyZW50LCBvZmZzZXQsIGVsZW0gPSB0aGlzWzBdLCBwYXJlbnRPZmZzZXQgPSB7CiAgICAgICAgICB0b3A6IDAsCiAgICAgICAgICBsZWZ0OiAwCiAgICAgICAgfTsKICAgICAgLy8gRml4ZWQgZWxlbWVudHMgYXJlIG9mZnNldCBmcm9tIHdpbmRvdyAocGFyZW50T2Zmc2V0ID0ge3RvcDowLCBsZWZ0OiAwfSwgYmVjYXVzZSBpdCBpcyBpdHMgb25seSBvZmZzZXQgcGFyZW50CiAgICAgIGlmIChqUXVlcnkuY3NzKGVsZW0sICdwb3NpdGlvbicpID09PSAnZml4ZWQnKSB7CiAgICAgICAgLy8gV2UgYXNzdW1lIHRoYXQgZ2V0Qm91bmRpbmdDbGllbnRSZWN0IGlzIGF2YWlsYWJsZSB3aGVuIGNvbXB1dGVkIHBvc2l0aW9uIGlzIGZpeGVkCiAgICAgICAgb2Zmc2V0ID0gZWxlbS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBHZXQgKnJlYWwqIG9mZnNldFBhcmVudAogICAgICAgIG9mZnNldFBhcmVudCA9IHRoaXMub2Zmc2V0UGFyZW50KCk7CiAgICAgICAgLy8gR2V0IGNvcnJlY3Qgb2Zmc2V0cwogICAgICAgIG9mZnNldCA9IHRoaXMub2Zmc2V0KCk7CiAgICAgICAgaWYgKCFqUXVlcnkubm9kZU5hbWUob2Zmc2V0UGFyZW50WzBdLCAnaHRtbCcpKSB7CiAgICAgICAgICBwYXJlbnRPZmZzZXQgPSBvZmZzZXRQYXJlbnQub2Zmc2V0KCk7CiAgICAgICAgfQogICAgICAgIC8vIEFkZCBvZmZzZXRQYXJlbnQgYm9yZGVycwogICAgICAgIHBhcmVudE9mZnNldC50b3AgKz0galF1ZXJ5LmNzcyhvZmZzZXRQYXJlbnRbMF0sICdib3JkZXJUb3BXaWR0aCcsIHRydWUpOwogICAgICAgIHBhcmVudE9mZnNldC5sZWZ0ICs9IGpRdWVyeS5jc3Mob2Zmc2V0UGFyZW50WzBdLCAnYm9yZGVyTGVmdFdpZHRoJywgdHJ1ZSk7CiAgICAgIH0KICAgICAgLy8gU3VidHJhY3QgcGFyZW50IG9mZnNldHMgYW5kIGVsZW1lbnQgbWFyZ2lucwogICAgICByZXR1cm4gewogICAgICAgIHRvcDogb2Zmc2V0LnRvcCAtIHBhcmVudE9mZnNldC50b3AgLSBqUXVlcnkuY3NzKGVsZW0sICdtYXJnaW5Ub3AnLCB0cnVlKSwKICAgICAgICBsZWZ0OiBvZmZzZXQubGVmdCAtIHBhcmVudE9mZnNldC5sZWZ0IC0galF1ZXJ5LmNzcyhlbGVtLCAnbWFyZ2luTGVmdCcsIHRydWUpCiAgICAgIH07CiAgICB9LAogICAgb2Zmc2V0UGFyZW50OiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiB0aGlzLm1hcChmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIG9mZnNldFBhcmVudCA9IHRoaXMub2Zmc2V0UGFyZW50IHx8IGRvY0VsZW07CiAgICAgICAgd2hpbGUgKG9mZnNldFBhcmVudCAmJiAoIWpRdWVyeS5ub2RlTmFtZShvZmZzZXRQYXJlbnQsICdodG1sJykgJiYgalF1ZXJ5LmNzcyhvZmZzZXRQYXJlbnQsICdwb3NpdGlvbicpID09PSAnc3RhdGljJykpIHsKICAgICAgICAgIG9mZnNldFBhcmVudCA9IG9mZnNldFBhcmVudC5vZmZzZXRQYXJlbnQ7CiAgICAgICAgfQogICAgICAgIHJldHVybiBvZmZzZXRQYXJlbnQgfHwgZG9jRWxlbTsKICAgICAgfSk7CiAgICB9CiAgfSk7CiAgLy8gQ3JlYXRlIHNjcm9sbExlZnQgYW5kIHNjcm9sbFRvcCBtZXRob2RzCiAgalF1ZXJ5LmVhY2goewogICAgc2Nyb2xsTGVmdDogJ3BhZ2VYT2Zmc2V0JywKICAgIHNjcm9sbFRvcDogJ3BhZ2VZT2Zmc2V0JwogIH0sIGZ1bmN0aW9uIChtZXRob2QsIHByb3ApIHsKICAgIHZhciB0b3AgPSAncGFnZVlPZmZzZXQnID09PSBwcm9wOwogICAgalF1ZXJ5LmZuW21ldGhvZF0gPSBmdW5jdGlvbiAodmFsKSB7CiAgICAgIHJldHVybiBhY2Nlc3ModGhpcywgZnVuY3Rpb24gKGVsZW0sIG1ldGhvZCwgdmFsKSB7CiAgICAgICAgdmFyIHdpbiA9IGdldFdpbmRvdyhlbGVtKTsKICAgICAgICBpZiAodmFsID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgIHJldHVybiB3aW4gPyB3aW5bcHJvcF0gOiBlbGVtW21ldGhvZF07CiAgICAgICAgfQogICAgICAgIGlmICh3aW4pIHsKICAgICAgICAgIHdpbi5zY3JvbGxUbyghdG9wID8gdmFsIDogd2luZG93LnBhZ2VYT2Zmc2V0LCB0b3AgPyB2YWwgOiB3aW5kb3cucGFnZVlPZmZzZXQpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBlbGVtW21ldGhvZF0gPSB2YWw7CiAgICAgICAgfQogICAgICB9LCBtZXRob2QsIHZhbCwgYXJndW1lbnRzLmxlbmd0aCwgbnVsbCk7CiAgICB9OwogIH0pOwogIC8vIEFkZCB0aGUgdG9wL2xlZnQgY3NzSG9va3MgdXNpbmcgalF1ZXJ5LmZuLnBvc2l0aW9uCiAgLy8gV2Via2l0IGJ1ZzogaHR0cHM6Ly9idWdzLndlYmtpdC5vcmcvc2hvd19idWcuY2dpP2lkPTI5MDg0CiAgLy8gZ2V0Q29tcHV0ZWRTdHlsZSByZXR1cm5zIHBlcmNlbnQgd2hlbiBzcGVjaWZpZWQgZm9yIHRvcC9sZWZ0L2JvdHRvbS9yaWdodAogIC8vIHJhdGhlciB0aGFuIG1ha2UgdGhlIGNzcyBtb2R1bGUgZGVwZW5kIG9uIHRoZSBvZmZzZXQgbW9kdWxlLCB3ZSBqdXN0IGNoZWNrIGZvciBpdCBoZXJlCiAgalF1ZXJ5LmVhY2goWwogICAgJ3RvcCcsCiAgICAnbGVmdCcKICBdLCBmdW5jdGlvbiAoaSwgcHJvcCkgewogICAgalF1ZXJ5LmNzc0hvb2tzW3Byb3BdID0gYWRkR2V0SG9va0lmKHN1cHBvcnQucGl4ZWxQb3NpdGlvbiwgZnVuY3Rpb24gKGVsZW0sIGNvbXB1dGVkKSB7CiAgICAgIGlmIChjb21wdXRlZCkgewogICAgICAgIGNvbXB1dGVkID0gY3VyQ1NTKGVsZW0sIHByb3ApOwogICAgICAgIC8vIGlmIGN1ckNTUyByZXR1cm5zIHBlcmNlbnRhZ2UsIGZhbGxiYWNrIHRvIG9mZnNldAogICAgICAgIHJldHVybiBybnVtbm9ucHgudGVzdChjb21wdXRlZCkgPyBqUXVlcnkoZWxlbSkucG9zaXRpb24oKVtwcm9wXSArICdweCcgOiBjb21wdXRlZDsKICAgICAgfQogICAgfSk7CiAgfSk7CiAgLy8gQ3JlYXRlIGlubmVySGVpZ2h0LCBpbm5lcldpZHRoLCBoZWlnaHQsIHdpZHRoLCBvdXRlckhlaWdodCBhbmQgb3V0ZXJXaWR0aCBtZXRob2RzCiAgalF1ZXJ5LmVhY2goewogICAgSGVpZ2h0OiAnaGVpZ2h0JywKICAgIFdpZHRoOiAnd2lkdGgnCiAgfSwgZnVuY3Rpb24gKG5hbWUsIHR5cGUpIHsKICAgIGpRdWVyeS5lYWNoKHsKICAgICAgcGFkZGluZzogJ2lubmVyJyArIG5hbWUsCiAgICAgIGNvbnRlbnQ6IHR5cGUsCiAgICAgICcnOiAnb3V0ZXInICsgbmFtZQogICAgfSwgZnVuY3Rpb24gKGRlZmF1bHRFeHRyYSwgZnVuY05hbWUpIHsKICAgICAgLy8gbWFyZ2luIGlzIG9ubHkgZm9yIG91dGVySGVpZ2h0LCBvdXRlcldpZHRoCiAgICAgIGpRdWVyeS5mbltmdW5jTmFtZV0gPSBmdW5jdGlvbiAobWFyZ2luLCB2YWx1ZSkgewogICAgICAgIHZhciBjaGFpbmFibGUgPSBhcmd1bWVudHMubGVuZ3RoICYmIChkZWZhdWx0RXh0cmEgfHwgdHlwZW9mIG1hcmdpbiAhPT0gJ2Jvb2xlYW4nKSwgZXh0cmEgPSBkZWZhdWx0RXh0cmEgfHwgKG1hcmdpbiA9PT0gdHJ1ZSB8fCB2YWx1ZSA9PT0gdHJ1ZSA/ICdtYXJnaW4nIDogJ2JvcmRlcicpOwogICAgICAgIHJldHVybiBhY2Nlc3ModGhpcywgZnVuY3Rpb24gKGVsZW0sIHR5cGUsIHZhbHVlKSB7CiAgICAgICAgICB2YXIgZG9jOwogICAgICAgICAgaWYgKGpRdWVyeS5pc1dpbmRvdyhlbGVtKSkgewogICAgICAgICAgICAvLyBBcyBvZiA1LzgvMjAxMiB0aGlzIHdpbGwgeWllbGQgaW5jb3JyZWN0IHJlc3VsdHMgZm9yIE1vYmlsZSBTYWZhcmksIGJ1dCB0aGVyZQogICAgICAgICAgICAvLyBpc24ndCBhIHdob2xlIGxvdCB3ZSBjYW4gZG8uIFNlZSBwdWxsIHJlcXVlc3QgYXQgdGhpcyBVUkwgZm9yIGRpc2N1c3Npb246CiAgICAgICAgICAgIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5L3B1bGwvNzY0CiAgICAgICAgICAgIHJldHVybiBlbGVtLmRvY3VtZW50LmRvY3VtZW50RWxlbWVudFsnY2xpZW50JyArIG5hbWVdOwogICAgICAgICAgfQogICAgICAgICAgLy8gR2V0IGRvY3VtZW50IHdpZHRoIG9yIGhlaWdodAogICAgICAgICAgaWYgKGVsZW0ubm9kZVR5cGUgPT09IDkpIHsKICAgICAgICAgICAgZG9jID0gZWxlbS5kb2N1bWVudEVsZW1lbnQ7CiAgICAgICAgICAgIC8vIEVpdGhlciBzY3JvbGxbV2lkdGgvSGVpZ2h0XSBvciBvZmZzZXRbV2lkdGgvSGVpZ2h0XSBvciBjbGllbnRbV2lkdGgvSGVpZ2h0XSwKICAgICAgICAgICAgLy8gd2hpY2hldmVyIGlzIGdyZWF0ZXN0CiAgICAgICAgICAgIHJldHVybiBNYXRoLm1heChlbGVtLmJvZHlbJ3Njcm9sbCcgKyBuYW1lXSwgZG9jWydzY3JvbGwnICsgbmFtZV0sIGVsZW0uYm9keVsnb2Zmc2V0JyArIG5hbWVdLCBkb2NbJ29mZnNldCcgKyBuYW1lXSwgZG9jWydjbGllbnQnICsgbmFtZV0pOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHZhbHVlID09PSB1bmRlZmluZWQgPyAvLyBHZXQgd2lkdGggb3IgaGVpZ2h0IG9uIHRoZSBlbGVtZW50LCByZXF1ZXN0aW5nIGJ1dCBub3QgZm9yY2luZyBwYXJzZUZsb2F0CiAgICAgICAgICBqUXVlcnkuY3NzKGVsZW0sIHR5cGUsIGV4dHJhKSA6IC8vIFNldCB3aWR0aCBvciBoZWlnaHQgb24gdGhlIGVsZW1lbnQKICAgICAgICAgIGpRdWVyeS5zdHlsZShlbGVtLCB0eXBlLCB2YWx1ZSwgZXh0cmEpOwogICAgICAgIH0sIHR5cGUsIGNoYWluYWJsZSA/IG1hcmdpbiA6IHVuZGVmaW5lZCwgY2hhaW5hYmxlLCBudWxsKTsKICAgICAgfTsKICAgIH0pOwogIH0pOwogIC8vIFRoZSBudW1iZXIgb2YgZWxlbWVudHMgY29udGFpbmVkIGluIHRoZSBtYXRjaGVkIGVsZW1lbnQgc2V0CiAgalF1ZXJ5LmZuLnNpemUgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5sZW5ndGg7CiAgfTsKICBqUXVlcnkuZm4uYW5kU2VsZiA9IGpRdWVyeS5mbi5hZGRCYWNrOwogIC8vIFJlZ2lzdGVyIGFzIGEgbmFtZWQgQU1EIG1vZHVsZSwgc2luY2UgalF1ZXJ5IGNhbiBiZSBjb25jYXRlbmF0ZWQgd2l0aCBvdGhlcgogIC8vIGZpbGVzIHRoYXQgbWF5IHVzZSBkZWZpbmUsIGJ1dCBub3QgdmlhIGEgcHJvcGVyIGNvbmNhdGVuYXRpb24gc2NyaXB0IHRoYXQKICAvLyB1bmRlcnN0YW5kcyBhbm9ueW1vdXMgQU1EIG1vZHVsZXMuIEEgbmFtZWQgQU1EIGlzIHNhZmVzdCBhbmQgbW9zdCByb2J1c3QKICAvLyB3YXkgdG8gcmVnaXN0ZXIuIExvd2VyY2FzZSBqcXVlcnkgaXMgdXNlZCBiZWNhdXNlIEFNRCBtb2R1bGUgbmFtZXMgYXJlCiAgLy8gZGVyaXZlZCBmcm9tIGZpbGUgbmFtZXMsIGFuZCBqUXVlcnkgaXMgbm9ybWFsbHkgZGVsaXZlcmVkIGluIGEgbG93ZXJjYXNlCiAgLy8gZmlsZSBuYW1lLiBEbyB0aGlzIGFmdGVyIGNyZWF0aW5nIHRoZSBnbG9iYWwgc28gdGhhdCBpZiBhbiBBTUQgbW9kdWxlIHdhbnRzCiAgLy8gdG8gY2FsbCBub0NvbmZsaWN0IHRvIGhpZGUgdGhpcyB2ZXJzaW9uIG9mIGpRdWVyeSwgaXQgd2lsbCB3b3JrLgogIC8vIE5vdGUgdGhhdCBmb3IgbWF4aW11bSBwb3J0YWJpbGl0eSwgbGlicmFyaWVzIHRoYXQgYXJlIG5vdCBqUXVlcnkgc2hvdWxkCiAgLy8gZGVjbGFyZSB0aGVtc2VsdmVzIGFzIGFub255bW91cyBtb2R1bGVzLCBhbmQgYXZvaWQgc2V0dGluZyBhIGdsb2JhbCBpZiBhbgogIC8vIEFNRCBsb2FkZXIgaXMgcHJlc2VudC4galF1ZXJ5IGlzIGEgc3BlY2lhbCBjYXNlLiBGb3IgbW9yZSBpbmZvcm1hdGlvbiwgc2VlCiAgLy8gaHR0cHM6Ly9naXRodWIuY29tL2pyYnVya2UvcmVxdWlyZWpzL3dpa2kvVXBkYXRpbmctZXhpc3RpbmctbGlicmFyaWVzI3dpa2ktYW5vbgogIGlmICh0cnVlKSB7CiAgICBqcXVlcnkgPSBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBqUXVlcnk7CiAgICB9KCk7CiAgfQogIHZhcgogICAgLy8gTWFwIG92ZXIgalF1ZXJ5IGluIGNhc2Ugb2Ygb3ZlcndyaXRlCiAgICBfalF1ZXJ5ID0gd2luZG93LmpRdWVyeSwKICAgIC8vIE1hcCBvdmVyIHRoZSAkIGluIGNhc2Ugb2Ygb3ZlcndyaXRlCiAgICBfJCA9IHdpbmRvdy4kOwogIGpRdWVyeS5ub0NvbmZsaWN0ID0gZnVuY3Rpb24gKGRlZXApIHsKICAgIGlmICh3aW5kb3cuJCA9PT0galF1ZXJ5KSB7CiAgICAgIHdpbmRvdy4kID0gXyQ7CiAgICB9CiAgICBpZiAoZGVlcCAmJiB3aW5kb3cualF1ZXJ5ID09PSBqUXVlcnkpIHsKICAgICAgd2luZG93LmpRdWVyeSA9IF9qUXVlcnk7CiAgICB9CiAgICByZXR1cm4galF1ZXJ5OwogIH07CiAgLy8gRXhwb3NlIGpRdWVyeSBhbmQgJCBpZGVudGlmaWVycywgZXZlbiBpbgogIC8vIEFNRCAoIzcxMDIjY29tbWVudDoxMCwgaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnkvcHVsbC81NTcpCiAgLy8gYW5kIENvbW1vbkpTIGZvciBicm93c2VyIGVtdWxhdG9ycyAoIzEzNTY2KQogIGlmICh0eXBlb2Ygbm9HbG9iYWwgPT09IHN0cnVuZGVmaW5lZCkgewogICAgd2luZG93LmpRdWVyeSA9IHdpbmRvdy4kID0galF1ZXJ5OwogIH0KICByZXR1cm4galF1ZXJ5Owp9KSk7Ci8vICAgICBCYWNrYm9uZS5qcyAxLjEuMgovLyAgICAgKGMpIDIwMTAtMjAxNCBKZXJlbXkgQXNoa2VuYXMsIERvY3VtZW50Q2xvdWQgYW5kIEludmVzdGlnYXRpdmUgUmVwb3J0ZXJzICYgRWRpdG9ycwovLyAgICAgQmFja2JvbmUgbWF5IGJlIGZyZWVseSBkaXN0cmlidXRlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuCi8vICAgICBGb3IgYWxsIGRldGFpbHMgYW5kIGRvY3VtZW50YXRpb246Ci8vICAgICBodHRwOi8vYmFja2JvbmVqcy5vcmcKKGZ1bmN0aW9uIChyb290LCBmYWN0b3J5KSB7CiAgLy8gU2V0IHVwIEJhY2tib25lIGFwcHJvcHJpYXRlbHkgZm9yIHRoZSBlbnZpcm9ubWVudC4gU3RhcnQgd2l0aCBBTUQuCiAgaWYgKHRydWUpIHsKICAgIGJhY2tib25lID0gZnVuY3Rpb24gKF8sICQsIGV4cG9ydHMpIHsKICAgICAgLy8gRXhwb3J0IGdsb2JhbCBldmVuIGluIEFNRCBjYXNlIGluIGNhc2UgdGhpcyBzY3JpcHQgaXMgbG9hZGVkIHdpdGgKICAgICAgLy8gb3RoZXJzIHRoYXQgbWF5IHN0aWxsIGV4cGVjdCBhIGdsb2JhbCBCYWNrYm9uZS4KICAgICAgcm9vdC5CYWNrYm9uZSA9IGZhY3Rvcnkocm9vdCwgZXhwb3J0cywgXywgJCk7CiAgICAgIHJldHVybiBleHBvcnRzOwogICAgfSh1bmRlcnNjb3JlLCBqcXVlcnksIHt9KTsKICB9IGVsc2UgaWYgKHR5cGVvZiBleHBvcnRzICE9PSAndW5kZWZpbmVkJykgewogICAgdmFyIF8gPSB1bmRlcnNjb3JlOwogICAgZmFjdG9yeShyb290LCBleHBvcnRzLCBfKTsKICB9IGVsc2UgewogICAgcm9vdC5CYWNrYm9uZSA9IGZhY3Rvcnkocm9vdCwge30sIHJvb3QuXywgcm9vdC5qUXVlcnkgfHwgcm9vdC5aZXB0byB8fCByb290LmVuZGVyIHx8IHJvb3QuJCk7CiAgfQp9KHRoaXMsIGZ1bmN0aW9uIChyb290LCBCYWNrYm9uZSwgXywgJCkgewogIC8vIEluaXRpYWwgU2V0dXAKICAvLyAtLS0tLS0tLS0tLS0tCiAgLy8gU2F2ZSB0aGUgcHJldmlvdXMgdmFsdWUgb2YgdGhlIGBCYWNrYm9uZWAgdmFyaWFibGUsIHNvIHRoYXQgaXQgY2FuIGJlCiAgLy8gcmVzdG9yZWQgbGF0ZXIgb24sIGlmIGBub0NvbmZsaWN0YCBpcyB1c2VkLgogIHZhciBwcmV2aW91c0JhY2tib25lID0gcm9vdC5CYWNrYm9uZTsKICAvLyBDcmVhdGUgbG9jYWwgcmVmZXJlbmNlcyB0byBhcnJheSBtZXRob2RzIHdlJ2xsIHdhbnQgdG8gdXNlIGxhdGVyLgogIHZhciBhcnJheSA9IFtdOwogIHZhciBwdXNoID0gYXJyYXkucHVzaDsKICB2YXIgc2xpY2UgPSBhcnJheS5zbGljZTsKICB2YXIgc3BsaWNlID0gYXJyYXkuc3BsaWNlOwogIC8vIEN1cnJlbnQgdmVyc2lvbiBvZiB0aGUgbGlicmFyeS4gS2VlcCBpbiBzeW5jIHdpdGggYHBhY2thZ2UuanNvbmAuCiAgQmFja2JvbmUuVkVSU0lPTiA9ICcxLjEuMic7CiAgLy8gRm9yIEJhY2tib25lJ3MgcHVycG9zZXMsIGpRdWVyeSwgWmVwdG8sIEVuZGVyLCBvciBNeSBMaWJyYXJ5IChraWRkaW5nKSBvd25zCiAgLy8gdGhlIGAkYCB2YXJpYWJsZS4KICBCYWNrYm9uZS4kID0gJDsKICAvLyBSdW5zIEJhY2tib25lLmpzIGluICpub0NvbmZsaWN0KiBtb2RlLCByZXR1cm5pbmcgdGhlIGBCYWNrYm9uZWAgdmFyaWFibGUKICAvLyB0byBpdHMgcHJldmlvdXMgb3duZXIuIFJldHVybnMgYSByZWZlcmVuY2UgdG8gdGhpcyBCYWNrYm9uZSBvYmplY3QuCiAgQmFja2JvbmUubm9Db25mbGljdCA9IGZ1bmN0aW9uICgpIHsKICAgIHJvb3QuQmFja2JvbmUgPSBwcmV2aW91c0JhY2tib25lOwogICAgcmV0dXJuIHRoaXM7CiAgfTsKICAvLyBUdXJuIG9uIGBlbXVsYXRlSFRUUGAgdG8gc3VwcG9ydCBsZWdhY3kgSFRUUCBzZXJ2ZXJzLiBTZXR0aW5nIHRoaXMgb3B0aW9uCiAgLy8gd2lsbCBmYWtlIGAiUEFUQ0giYCwgYCJQVVQiYCBhbmQgYCJERUxFVEUiYCByZXF1ZXN0cyB2aWEgdGhlIGBfbWV0aG9kYCBwYXJhbWV0ZXIgYW5kCiAgLy8gc2V0IGEgYFgtSHR0cC1NZXRob2QtT3ZlcnJpZGVgIGhlYWRlci4KICBCYWNrYm9uZS5lbXVsYXRlSFRUUCA9IGZhbHNlOwogIC8vIFR1cm4gb24gYGVtdWxhdGVKU09OYCB0byBzdXBwb3J0IGxlZ2FjeSBzZXJ2ZXJzIHRoYXQgY2FuJ3QgZGVhbCB3aXRoIGRpcmVjdAogIC8vIGBhcHBsaWNhdGlvbi9qc29uYCByZXF1ZXN0cyAuLi4gd2lsbCBlbmNvZGUgdGhlIGJvZHkgYXMKICAvLyBgYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkYCBpbnN0ZWFkIGFuZCB3aWxsIHNlbmQgdGhlIG1vZGVsIGluIGEKICAvLyBmb3JtIHBhcmFtIG5hbWVkIGBtb2RlbGAuCiAgQmFja2JvbmUuZW11bGF0ZUpTT04gPSBmYWxzZTsKICAvLyBCYWNrYm9uZS5FdmVudHMKICAvLyAtLS0tLS0tLS0tLS0tLS0KICAvLyBBIG1vZHVsZSB0aGF0IGNhbiBiZSBtaXhlZCBpbiB0byAqYW55IG9iamVjdCogaW4gb3JkZXIgdG8gcHJvdmlkZSBpdCB3aXRoCiAgLy8gY3VzdG9tIGV2ZW50cy4gWW91IG1heSBiaW5kIHdpdGggYG9uYCBvciByZW1vdmUgd2l0aCBgb2ZmYCBjYWxsYmFjawogIC8vIGZ1bmN0aW9ucyB0byBhbiBldmVudDsgYHRyaWdnZXJgLWluZyBhbiBldmVudCBmaXJlcyBhbGwgY2FsbGJhY2tzIGluCiAgLy8gc3VjY2Vzc2lvbi4KICAvLwogIC8vICAgICB2YXIgb2JqZWN0ID0ge307CiAgLy8gICAgIF8uZXh0ZW5kKG9iamVjdCwgQmFja2JvbmUuRXZlbnRzKTsKICAvLyAgICAgb2JqZWN0Lm9uKCdleHBhbmQnLCBmdW5jdGlvbigpeyBhbGVydCgnZXhwYW5kZWQnKTsgfSk7CiAgLy8gICAgIG9iamVjdC50cmlnZ2VyKCdleHBhbmQnKTsKICAvLwogIHZhciBFdmVudHMgPSBCYWNrYm9uZS5FdmVudHMgPSB7CiAgICAvLyBCaW5kIGFuIGV2ZW50IHRvIGEgYGNhbGxiYWNrYCBmdW5jdGlvbi4gUGFzc2luZyBgImFsbCJgIHdpbGwgYmluZAogICAgLy8gdGhlIGNhbGxiYWNrIHRvIGFsbCBldmVudHMgZmlyZWQuCiAgICBvbjogZnVuY3Rpb24gKG5hbWUsIGNhbGxiYWNrLCBjb250ZXh0KSB7CiAgICAgIGlmICghZXZlbnRzQXBpKHRoaXMsICdvbicsIG5hbWUsIFsKICAgICAgICAgIGNhbGxiYWNrLAogICAgICAgICAgY29udGV4dAogICAgICAgIF0pIHx8ICFjYWxsYmFjaykKICAgICAgICByZXR1cm4gdGhpczsKICAgICAgdGhpcy5fZXZlbnRzIHx8ICh0aGlzLl9ldmVudHMgPSB7fSk7CiAgICAgIHZhciBldmVudHMgPSB0aGlzLl9ldmVudHNbbmFtZV0gfHwgKHRoaXMuX2V2ZW50c1tuYW1lXSA9IFtdKTsKICAgICAgZXZlbnRzLnB1c2goewogICAgICAgIGNhbGxiYWNrOiBjYWxsYmFjaywKICAgICAgICBjb250ZXh0OiBjb250ZXh0LAogICAgICAgIGN0eDogY29udGV4dCB8fCB0aGlzCiAgICAgIH0pOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgICAvLyBCaW5kIGFuIGV2ZW50IHRvIG9ubHkgYmUgdHJpZ2dlcmVkIGEgc2luZ2xlIHRpbWUuIEFmdGVyIHRoZSBmaXJzdCB0aW1lCiAgICAvLyB0aGUgY2FsbGJhY2sgaXMgaW52b2tlZCwgaXQgd2lsbCBiZSByZW1vdmVkLgogICAgb25jZTogZnVuY3Rpb24gKG5hbWUsIGNhbGxiYWNrLCBjb250ZXh0KSB7CiAgICAgIGlmICghZXZlbnRzQXBpKHRoaXMsICdvbmNlJywgbmFtZSwgWwogICAgICAgICAgY2FsbGJhY2ssCiAgICAgICAgICBjb250ZXh0CiAgICAgICAgXSkgfHwgIWNhbGxiYWNrKQogICAgICAgIHJldHVybiB0aGlzOwogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIHZhciBvbmNlID0gXy5vbmNlKGZ1bmN0aW9uICgpIHsKICAgICAgICBzZWxmLm9mZihuYW1lLCBvbmNlKTsKICAgICAgICBjYWxsYmFjay5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9KTsKICAgICAgb25jZS5fY2FsbGJhY2sgPSBjYWxsYmFjazsKICAgICAgcmV0dXJuIHRoaXMub24obmFtZSwgb25jZSwgY29udGV4dCk7CiAgICB9LAogICAgLy8gUmVtb3ZlIG9uZSBvciBtYW55IGNhbGxiYWNrcy4gSWYgYGNvbnRleHRgIGlzIG51bGwsIHJlbW92ZXMgYWxsCiAgICAvLyBjYWxsYmFja3Mgd2l0aCB0aGF0IGZ1bmN0aW9uLiBJZiBgY2FsbGJhY2tgIGlzIG51bGwsIHJlbW92ZXMgYWxsCiAgICAvLyBjYWxsYmFja3MgZm9yIHRoZSBldmVudC4gSWYgYG5hbWVgIGlzIG51bGwsIHJlbW92ZXMgYWxsIGJvdW5kCiAgICAvLyBjYWxsYmFja3MgZm9yIGFsbCBldmVudHMuCiAgICBvZmY6IGZ1bmN0aW9uIChuYW1lLCBjYWxsYmFjaywgY29udGV4dCkgewogICAgICB2YXIgcmV0YWluLCBldiwgZXZlbnRzLCBuYW1lcywgaSwgbCwgaiwgazsKICAgICAgaWYgKCF0aGlzLl9ldmVudHMgfHwgIWV2ZW50c0FwaSh0aGlzLCAnb2ZmJywgbmFtZSwgWwogICAgICAgICAgY2FsbGJhY2ssCiAgICAgICAgICBjb250ZXh0CiAgICAgICAgXSkpCiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgIGlmICghbmFtZSAmJiAhY2FsbGJhY2sgJiYgIWNvbnRleHQpIHsKICAgICAgICB0aGlzLl9ldmVudHMgPSB2b2lkIDA7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgIH0KICAgICAgbmFtZXMgPSBuYW1lID8gW25hbWVdIDogXy5rZXlzKHRoaXMuX2V2ZW50cyk7CiAgICAgIGZvciAoaSA9IDAsIGwgPSBuYW1lcy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICBuYW1lID0gbmFtZXNbaV07CiAgICAgICAgaWYgKGV2ZW50cyA9IHRoaXMuX2V2ZW50c1tuYW1lXSkgewogICAgICAgICAgdGhpcy5fZXZlbnRzW25hbWVdID0gcmV0YWluID0gW107CiAgICAgICAgICBpZiAoY2FsbGJhY2sgfHwgY29udGV4dCkgewogICAgICAgICAgICBmb3IgKGogPSAwLCBrID0gZXZlbnRzLmxlbmd0aDsgaiA8IGs7IGorKykgewogICAgICAgICAgICAgIGV2ID0gZXZlbnRzW2pdOwogICAgICAgICAgICAgIGlmIChjYWxsYmFjayAmJiBjYWxsYmFjayAhPT0gZXYuY2FsbGJhY2sgJiYgY2FsbGJhY2sgIT09IGV2LmNhbGxiYWNrLl9jYWxsYmFjayB8fCBjb250ZXh0ICYmIGNvbnRleHQgIT09IGV2LmNvbnRleHQpIHsKICAgICAgICAgICAgICAgIHJldGFpbi5wdXNoKGV2KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICghcmV0YWluLmxlbmd0aCkKICAgICAgICAgICAgZGVsZXRlIHRoaXMuX2V2ZW50c1tuYW1lXTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogICAgLy8gVHJpZ2dlciBvbmUgb3IgbWFueSBldmVudHMsIGZpcmluZyBhbGwgYm91bmQgY2FsbGJhY2tzLiBDYWxsYmFja3MgYXJlCiAgICAvLyBwYXNzZWQgdGhlIHNhbWUgYXJndW1lbnRzIGFzIGB0cmlnZ2VyYCBpcywgYXBhcnQgZnJvbSB0aGUgZXZlbnQgbmFtZQogICAgLy8gKHVubGVzcyB5b3UncmUgbGlzdGVuaW5nIG9uIGAiYWxsImAsIHdoaWNoIHdpbGwgY2F1c2UgeW91ciBjYWxsYmFjayB0bwogICAgLy8gcmVjZWl2ZSB0aGUgdHJ1ZSBuYW1lIG9mIHRoZSBldmVudCBhcyB0aGUgZmlyc3QgYXJndW1lbnQpLgogICAgdHJpZ2dlcjogZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgaWYgKCF0aGlzLl9ldmVudHMpCiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwogICAgICBpZiAoIWV2ZW50c0FwaSh0aGlzLCAndHJpZ2dlcicsIG5hbWUsIGFyZ3MpKQogICAgICAgIHJldHVybiB0aGlzOwogICAgICB2YXIgZXZlbnRzID0gdGhpcy5fZXZlbnRzW25hbWVdOwogICAgICB2YXIgYWxsRXZlbnRzID0gdGhpcy5fZXZlbnRzLmFsbDsKICAgICAgaWYgKGV2ZW50cykKICAgICAgICB0cmlnZ2VyRXZlbnRzKGV2ZW50cywgYXJncyk7CiAgICAgIGlmIChhbGxFdmVudHMpCiAgICAgICAgdHJpZ2dlckV2ZW50cyhhbGxFdmVudHMsIGFyZ3VtZW50cyk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAgIC8vIFRlbGwgdGhpcyBvYmplY3QgdG8gc3RvcCBsaXN0ZW5pbmcgdG8gZWl0aGVyIHNwZWNpZmljIGV2ZW50cyAuLi4gb3IKICAgIC8vIHRvIGV2ZXJ5IG9iamVjdCBpdCdzIGN1cnJlbnRseSBsaXN0ZW5pbmcgdG8uCiAgICBzdG9wTGlzdGVuaW5nOiBmdW5jdGlvbiAob2JqLCBuYW1lLCBjYWxsYmFjaykgewogICAgICB2YXIgbGlzdGVuaW5nVG8gPSB0aGlzLl9saXN0ZW5pbmdUbzsKICAgICAgaWYgKCFsaXN0ZW5pbmdUbykKICAgICAgICByZXR1cm4gdGhpczsKICAgICAgdmFyIHJlbW92ZSA9ICFuYW1lICYmICFjYWxsYmFjazsKICAgICAgaWYgKCFjYWxsYmFjayAmJiB0eXBlb2YgbmFtZSA9PT0gJ29iamVjdCcpCiAgICAgICAgY2FsbGJhY2sgPSB0aGlzOwogICAgICBpZiAob2JqKQogICAgICAgIChsaXN0ZW5pbmdUbyA9IHt9KVtvYmouX2xpc3RlbklkXSA9IG9iajsKICAgICAgZm9yICh2YXIgaWQgaW4gbGlzdGVuaW5nVG8pIHsKICAgICAgICBvYmogPSBsaXN0ZW5pbmdUb1tpZF07CiAgICAgICAgb2JqLm9mZihuYW1lLCBjYWxsYmFjaywgdGhpcyk7CiAgICAgICAgaWYgKHJlbW92ZSB8fCBfLmlzRW1wdHkob2JqLl9ldmVudHMpKQogICAgICAgICAgZGVsZXRlIHRoaXMuX2xpc3RlbmluZ1RvW2lkXTsKICAgICAgfQogICAgICByZXR1cm4gdGhpczsKICAgIH0KICB9OwogIC8vIFJlZ3VsYXIgZXhwcmVzc2lvbiB1c2VkIHRvIHNwbGl0IGV2ZW50IHN0cmluZ3MuCiAgdmFyIGV2ZW50U3BsaXR0ZXIgPSAvXHMrLzsKICAvLyBJbXBsZW1lbnQgZmFuY3kgZmVhdHVyZXMgb2YgdGhlIEV2ZW50cyBBUEkgc3VjaCBhcyBtdWx0aXBsZSBldmVudAogIC8vIG5hbWVzIGAiY2hhbmdlIGJsdXIiYCBhbmQgalF1ZXJ5LXN0eWxlIGV2ZW50IG1hcHMgYHtjaGFuZ2U6IGFjdGlvbn1gCiAgLy8gaW4gdGVybXMgb2YgdGhlIGV4aXN0aW5nIEFQSS4KICB2YXIgZXZlbnRzQXBpID0gZnVuY3Rpb24gKG9iaiwgYWN0aW9uLCBuYW1lLCByZXN0KSB7CiAgICBpZiAoIW5hbWUpCiAgICAgIHJldHVybiB0cnVlOwogICAgLy8gSGFuZGxlIGV2ZW50IG1hcHMuCiAgICBpZiAodHlwZW9mIG5hbWUgPT09ICdvYmplY3QnKSB7CiAgICAgIGZvciAodmFyIGtleSBpbiBuYW1lKSB7CiAgICAgICAgb2JqW2FjdGlvbl0uYXBwbHkob2JqLCBbCiAgICAgICAgICBrZXksCiAgICAgICAgICBuYW1lW2tleV0KICAgICAgICBdLmNvbmNhdChyZXN0KSk7CiAgICAgIH0KICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgLy8gSGFuZGxlIHNwYWNlIHNlcGFyYXRlZCBldmVudCBuYW1lcy4KICAgIGlmIChldmVudFNwbGl0dGVyLnRlc3QobmFtZSkpIHsKICAgICAgdmFyIG5hbWVzID0gbmFtZS5zcGxpdChldmVudFNwbGl0dGVyKTsKICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSBuYW1lcy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICBvYmpbYWN0aW9uXS5hcHBseShvYmosIFtuYW1lc1tpXV0uY29uY2F0KHJlc3QpKTsKICAgICAgfQogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICByZXR1cm4gdHJ1ZTsKICB9OwogIC8vIEEgZGlmZmljdWx0LXRvLWJlbGlldmUsIGJ1dCBvcHRpbWl6ZWQgaW50ZXJuYWwgZGlzcGF0Y2ggZnVuY3Rpb24gZm9yCiAgLy8gdHJpZ2dlcmluZyBldmVudHMuIFRyaWVzIHRvIGtlZXAgdGhlIHVzdWFsIGNhc2VzIHNwZWVkeSAobW9zdCBpbnRlcm5hbAogIC8vIEJhY2tib25lIGV2ZW50cyBoYXZlIDMgYXJndW1lbnRzKS4KICB2YXIgdHJpZ2dlckV2ZW50cyA9IGZ1bmN0aW9uIChldmVudHMsIGFyZ3MpIHsKICAgIHZhciBldiwgaSA9IC0xLCBsID0gZXZlbnRzLmxlbmd0aCwgYTEgPSBhcmdzWzBdLCBhMiA9IGFyZ3NbMV0sIGEzID0gYXJnc1syXTsKICAgIHN3aXRjaCAoYXJncy5sZW5ndGgpIHsKICAgIGNhc2UgMDoKICAgICAgd2hpbGUgKCsraSA8IGwpCiAgICAgICAgKGV2ID0gZXZlbnRzW2ldKS5jYWxsYmFjay5jYWxsKGV2LmN0eCk7CiAgICAgIHJldHVybjsKICAgIGNhc2UgMToKICAgICAgd2hpbGUgKCsraSA8IGwpCiAgICAgICAgKGV2ID0gZXZlbnRzW2ldKS5jYWxsYmFjay5jYWxsKGV2LmN0eCwgYTEpOwogICAgICByZXR1cm47CiAgICBjYXNlIDI6CiAgICAgIHdoaWxlICgrK2kgPCBsKQogICAgICAgIChldiA9IGV2ZW50c1tpXSkuY2FsbGJhY2suY2FsbChldi5jdHgsIGExLCBhMik7CiAgICAgIHJldHVybjsKICAgIGNhc2UgMzoKICAgICAgd2hpbGUgKCsraSA8IGwpCiAgICAgICAgKGV2ID0gZXZlbnRzW2ldKS5jYWxsYmFjay5jYWxsKGV2LmN0eCwgYTEsIGEyLCBhMyk7CiAgICAgIHJldHVybjsKICAgIGRlZmF1bHQ6CiAgICAgIHdoaWxlICgrK2kgPCBsKQogICAgICAgIChldiA9IGV2ZW50c1tpXSkuY2FsbGJhY2suYXBwbHkoZXYuY3R4LCBhcmdzKTsKICAgICAgcmV0dXJuOwogICAgfQogIH07CiAgdmFyIGxpc3Rlbk1ldGhvZHMgPSB7CiAgICBsaXN0ZW5UbzogJ29uJywKICAgIGxpc3RlblRvT25jZTogJ29uY2UnCiAgfTsKICAvLyBJbnZlcnNpb24tb2YtY29udHJvbCB2ZXJzaW9ucyBvZiBgb25gIGFuZCBgb25jZWAuIFRlbGwgKnRoaXMqIG9iamVjdCB0bwogIC8vIGxpc3RlbiB0byBhbiBldmVudCBpbiBhbm90aGVyIG9iamVjdCAuLi4ga2VlcGluZyB0cmFjayBvZiB3aGF0IGl0J3MKICAvLyBsaXN0ZW5pbmcgdG8uCiAgXy5lYWNoKGxpc3Rlbk1ldGhvZHMsIGZ1bmN0aW9uIChpbXBsZW1lbnRhdGlvbiwgbWV0aG9kKSB7CiAgICBFdmVudHNbbWV0aG9kXSA9IGZ1bmN0aW9uIChvYmosIG5hbWUsIGNhbGxiYWNrKSB7CiAgICAgIHZhciBsaXN0ZW5pbmdUbyA9IHRoaXMuX2xpc3RlbmluZ1RvIHx8ICh0aGlzLl9saXN0ZW5pbmdUbyA9IHt9KTsKICAgICAgdmFyIGlkID0gb2JqLl9saXN0ZW5JZCB8fCAob2JqLl9saXN0ZW5JZCA9IF8udW5pcXVlSWQoJ2wnKSk7CiAgICAgIGxpc3RlbmluZ1RvW2lkXSA9IG9iajsKICAgICAgaWYgKCFjYWxsYmFjayAmJiB0eXBlb2YgbmFtZSA9PT0gJ29iamVjdCcpCiAgICAgICAgY2FsbGJhY2sgPSB0aGlzOwogICAgICBvYmpbaW1wbGVtZW50YXRpb25dKG5hbWUsIGNhbGxiYWNrLCB0aGlzKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9OwogIH0pOwogIC8vIEFsaWFzZXMgZm9yIGJhY2t3YXJkcyBjb21wYXRpYmlsaXR5LgogIEV2ZW50cy5iaW5kID0gRXZlbnRzLm9uOwogIEV2ZW50cy51bmJpbmQgPSBFdmVudHMub2ZmOwogIC8vIEFsbG93IHRoZSBgQmFja2JvbmVgIG9iamVjdCB0byBzZXJ2ZSBhcyBhIGdsb2JhbCBldmVudCBidXMsIGZvciBmb2xrcyB3aG8KICAvLyB3YW50IGdsb2JhbCAicHVic3ViIiBpbiBhIGNvbnZlbmllbnQgcGxhY2UuCiAgXy5leHRlbmQoQmFja2JvbmUsIEV2ZW50cyk7CiAgLy8gQmFja2JvbmUuTW9kZWwKICAvLyAtLS0tLS0tLS0tLS0tLQogIC8vIEJhY2tib25lICoqTW9kZWxzKiogYXJlIHRoZSBiYXNpYyBkYXRhIG9iamVjdCBpbiB0aGUgZnJhbWV3b3JrIC0tCiAgLy8gZnJlcXVlbnRseSByZXByZXNlbnRpbmcgYSByb3cgaW4gYSB0YWJsZSBpbiBhIGRhdGFiYXNlIG9uIHlvdXIgc2VydmVyLgogIC8vIEEgZGlzY3JldGUgY2h1bmsgb2YgZGF0YSBhbmQgYSBidW5jaCBvZiB1c2VmdWwsIHJlbGF0ZWQgbWV0aG9kcyBmb3IKICAvLyBwZXJmb3JtaW5nIGNvbXB1dGF0aW9ucyBhbmQgdHJhbnNmb3JtYXRpb25zIG9uIHRoYXQgZGF0YS4KICAvLyBDcmVhdGUgYSBuZXcgbW9kZWwgd2l0aCB0aGUgc3BlY2lmaWVkIGF0dHJpYnV0ZXMuIEEgY2xpZW50IGlkIChgY2lkYCkKICAvLyBpcyBhdXRvbWF0aWNhbGx5IGdlbmVyYXRlZCBhbmQgYXNzaWduZWQgZm9yIHlvdS4KICB2YXIgTW9kZWwgPSBCYWNrYm9uZS5Nb2RlbCA9IGZ1bmN0aW9uIChhdHRyaWJ1dGVzLCBvcHRpb25zKSB7CiAgICB2YXIgYXR0cnMgPSBhdHRyaWJ1dGVzIHx8IHt9OwogICAgb3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KTsKICAgIHRoaXMuY2lkID0gXy51bmlxdWVJZCgnYycpOwogICAgdGhpcy5hdHRyaWJ1dGVzID0ge307CiAgICBpZiAob3B0aW9ucy5jb2xsZWN0aW9uKQogICAgICB0aGlzLmNvbGxlY3Rpb24gPSBvcHRpb25zLmNvbGxlY3Rpb247CiAgICBpZiAob3B0aW9ucy5wYXJzZSkKICAgICAgYXR0cnMgPSB0aGlzLnBhcnNlKGF0dHJzLCBvcHRpb25zKSB8fCB7fTsKICAgIGF0dHJzID0gXy5kZWZhdWx0cyh7fSwgYXR0cnMsIF8ucmVzdWx0KHRoaXMsICdkZWZhdWx0cycpKTsKICAgIHRoaXMuc2V0KGF0dHJzLCBvcHRpb25zKTsKICAgIHRoaXMuY2hhbmdlZCA9IHt9OwogICAgdGhpcy5pbml0aWFsaXplLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgfTsKICAvLyBBdHRhY2ggYWxsIGluaGVyaXRhYmxlIG1ldGhvZHMgdG8gdGhlIE1vZGVsIHByb3RvdHlwZS4KICBfLmV4dGVuZChNb2RlbC5wcm90b3R5cGUsIEV2ZW50cywgewogICAgLy8gQSBoYXNoIG9mIGF0dHJpYnV0ZXMgd2hvc2UgY3VycmVudCBhbmQgcHJldmlvdXMgdmFsdWUgZGlmZmVyLgogICAgY2hhbmdlZDogbnVsbCwKICAgIC8vIFRoZSB2YWx1ZSByZXR1cm5lZCBkdXJpbmcgdGhlIGxhc3QgZmFpbGVkIHZhbGlkYXRpb24uCiAgICB2YWxpZGF0aW9uRXJyb3I6IG51bGwsCiAgICAvLyBUaGUgZGVmYXVsdCBuYW1lIGZvciB0aGUgSlNPTiBgaWRgIGF0dHJpYnV0ZSBpcyBgImlkImAuIE1vbmdvREIgYW5kCiAgICAvLyBDb3VjaERCIHVzZXJzIG1heSB3YW50IHRvIHNldCB0aGlzIHRvIGAiX2lkImAuCiAgICBpZEF0dHJpYnV0ZTogJ2lkJywKICAgIC8vIEluaXRpYWxpemUgaXMgYW4gZW1wdHkgZnVuY3Rpb24gYnkgZGVmYXVsdC4gT3ZlcnJpZGUgaXQgd2l0aCB5b3VyIG93bgogICAgLy8gaW5pdGlhbGl6YXRpb24gbG9naWMuCiAgICBpbml0aWFsaXplOiBmdW5jdGlvbiAoKSB7CiAgICB9LAogICAgLy8gUmV0dXJuIGEgY29weSBvZiB0aGUgbW9kZWwncyBgYXR0cmlidXRlc2Agb2JqZWN0LgogICAgdG9KU09OOiBmdW5jdGlvbiAob3B0aW9ucykgewogICAgICByZXR1cm4gXy5jbG9uZSh0aGlzLmF0dHJpYnV0ZXMpOwogICAgfSwKICAgIC8vIFByb3h5IGBCYWNrYm9uZS5zeW5jYCBieSBkZWZhdWx0IC0tIGJ1dCBvdmVycmlkZSB0aGlzIGlmIHlvdSBuZWVkCiAgICAvLyBjdXN0b20gc3luY2luZyBzZW1hbnRpY3MgZm9yICp0aGlzKiBwYXJ0aWN1bGFyIG1vZGVsLgogICAgc3luYzogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gQmFja2JvbmUuc3luYy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfSwKICAgIC8vIEdldCB0aGUgdmFsdWUgb2YgYW4gYXR0cmlidXRlLgogICAgZ2V0OiBmdW5jdGlvbiAoYXR0cikgewogICAgICByZXR1cm4gdGhpcy5hdHRyaWJ1dGVzW2F0dHJdOwogICAgfSwKICAgIC8vIEdldCB0aGUgSFRNTC1lc2NhcGVkIHZhbHVlIG9mIGFuIGF0dHJpYnV0ZS4KICAgIGVzY2FwZTogZnVuY3Rpb24gKGF0dHIpIHsKICAgICAgcmV0dXJuIF8uZXNjYXBlKHRoaXMuZ2V0KGF0dHIpKTsKICAgIH0sCiAgICAvLyBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgYXR0cmlidXRlIGNvbnRhaW5zIGEgdmFsdWUgdGhhdCBpcyBub3QgbnVsbAogICAgLy8gb3IgdW5kZWZpbmVkLgogICAgaGFzOiBmdW5jdGlvbiAoYXR0cikgewogICAgICByZXR1cm4gdGhpcy5nZXQoYXR0cikgIT0gbnVsbDsKICAgIH0sCiAgICAvLyBTZXQgYSBoYXNoIG9mIG1vZGVsIGF0dHJpYnV0ZXMgb24gdGhlIG9iamVjdCwgZmlyaW5nIGAiY2hhbmdlImAuIFRoaXMgaXMKICAgIC8vIHRoZSBjb3JlIHByaW1pdGl2ZSBvcGVyYXRpb24gb2YgYSBtb2RlbCwgdXBkYXRpbmcgdGhlIGRhdGEgYW5kIG5vdGlmeWluZwogICAgLy8gYW55b25lIHdobyBuZWVkcyB0byBrbm93IGFib3V0IHRoZSBjaGFuZ2UgaW4gc3RhdGUuIFRoZSBoZWFydCBvZiB0aGUgYmVhc3QuCiAgICBzZXQ6IGZ1bmN0aW9uIChrZXksIHZhbCwgb3B0aW9ucykgewogICAgICB2YXIgYXR0ciwgYXR0cnMsIHVuc2V0LCBjaGFuZ2VzLCBzaWxlbnQsIGNoYW5naW5nLCBwcmV2LCBjdXJyZW50OwogICAgICBpZiAoa2V5ID09IG51bGwpCiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgIC8vIEhhbmRsZSBib3RoIGAia2V5IiwgdmFsdWVgIGFuZCBge2tleTogdmFsdWV9YCAtc3R5bGUgYXJndW1lbnRzLgogICAgICBpZiAodHlwZW9mIGtleSA9PT0gJ29iamVjdCcpIHsKICAgICAgICBhdHRycyA9IGtleTsKICAgICAgICBvcHRpb25zID0gdmFsOwogICAgICB9IGVsc2UgewogICAgICAgIChhdHRycyA9IHt9KVtrZXldID0gdmFsOwogICAgICB9CiAgICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CiAgICAgIC8vIFJ1biB2YWxpZGF0aW9uLgogICAgICBpZiAoIXRoaXMuX3ZhbGlkYXRlKGF0dHJzLCBvcHRpb25zKSkKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIC8vIEV4dHJhY3QgYXR0cmlidXRlcyBhbmQgb3B0aW9ucy4KICAgICAgdW5zZXQgPSBvcHRpb25zLnVuc2V0OwogICAgICBzaWxlbnQgPSBvcHRpb25zLnNpbGVudDsKICAgICAgY2hhbmdlcyA9IFtdOwogICAgICBjaGFuZ2luZyA9IHRoaXMuX2NoYW5naW5nOwogICAgICB0aGlzLl9jaGFuZ2luZyA9IHRydWU7CiAgICAgIGlmICghY2hhbmdpbmcpIHsKICAgICAgICB0aGlzLl9wcmV2aW91c0F0dHJpYnV0ZXMgPSBfLmNsb25lKHRoaXMuYXR0cmlidXRlcyk7CiAgICAgICAgdGhpcy5jaGFuZ2VkID0ge307CiAgICAgIH0KICAgICAgY3VycmVudCA9IHRoaXMuYXR0cmlidXRlcywgcHJldiA9IHRoaXMuX3ByZXZpb3VzQXR0cmlidXRlczsKICAgICAgLy8gQ2hlY2sgZm9yIGNoYW5nZXMgb2YgYGlkYC4KICAgICAgaWYgKHRoaXMuaWRBdHRyaWJ1dGUgaW4gYXR0cnMpCiAgICAgICAgdGhpcy5pZCA9IGF0dHJzW3RoaXMuaWRBdHRyaWJ1dGVdOwogICAgICAvLyBGb3IgZWFjaCBgc2V0YCBhdHRyaWJ1dGUsIHVwZGF0ZSBvciBkZWxldGUgdGhlIGN1cnJlbnQgdmFsdWUuCiAgICAgIGZvciAoYXR0ciBpbiBhdHRycykgewogICAgICAgIHZhbCA9IGF0dHJzW2F0dHJdOwogICAgICAgIGlmICghXy5pc0VxdWFsKGN1cnJlbnRbYXR0cl0sIHZhbCkpCiAgICAgICAgICBjaGFuZ2VzLnB1c2goYXR0cik7CiAgICAgICAgaWYgKCFfLmlzRXF1YWwocHJldlthdHRyXSwgdmFsKSkgewogICAgICAgICAgdGhpcy5jaGFuZ2VkW2F0dHJdID0gdmFsOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBkZWxldGUgdGhpcy5jaGFuZ2VkW2F0dHJdOwogICAgICAgIH0KICAgICAgICB1bnNldCA/IGRlbGV0ZSBjdXJyZW50W2F0dHJdIDogY3VycmVudFthdHRyXSA9IHZhbDsKICAgICAgfQogICAgICAvLyBUcmlnZ2VyIGFsbCByZWxldmFudCBhdHRyaWJ1dGUgY2hhbmdlcy4KICAgICAgaWYgKCFzaWxlbnQpIHsKICAgICAgICBpZiAoY2hhbmdlcy5sZW5ndGgpCiAgICAgICAgICB0aGlzLl9wZW5kaW5nID0gb3B0aW9uczsKICAgICAgICBmb3IgKHZhciBpID0gMCwgbCA9IGNoYW5nZXMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgICB0aGlzLnRyaWdnZXIoJ2NoYW5nZTonICsgY2hhbmdlc1tpXSwgdGhpcywgY3VycmVudFtjaGFuZ2VzW2ldXSwgb3B0aW9ucyk7CiAgICAgICAgfQogICAgICB9CiAgICAgIC8vIFlvdSBtaWdodCBiZSB3b25kZXJpbmcgd2h5IHRoZXJlJ3MgYSBgd2hpbGVgIGxvb3AgaGVyZS4gQ2hhbmdlcyBjYW4KICAgICAgLy8gYmUgcmVjdXJzaXZlbHkgbmVzdGVkIHdpdGhpbiBgImNoYW5nZSJgIGV2ZW50cy4KICAgICAgaWYgKGNoYW5naW5nKQogICAgICAgIHJldHVybiB0aGlzOwogICAgICBpZiAoIXNpbGVudCkgewogICAgICAgIHdoaWxlICh0aGlzLl9wZW5kaW5nKSB7CiAgICAgICAgICBvcHRpb25zID0gdGhpcy5fcGVuZGluZzsKICAgICAgICAgIHRoaXMuX3BlbmRpbmcgPSBmYWxzZTsKICAgICAgICAgIHRoaXMudHJpZ2dlcignY2hhbmdlJywgdGhpcywgb3B0aW9ucyk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHRoaXMuX3BlbmRpbmcgPSBmYWxzZTsKICAgICAgdGhpcy5fY2hhbmdpbmcgPSBmYWxzZTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogICAgLy8gUmVtb3ZlIGFuIGF0dHJpYnV0ZSBmcm9tIHRoZSBtb2RlbCwgZmlyaW5nIGAiY2hhbmdlImAuIGB1bnNldGAgaXMgYSBub29wCiAgICAvLyBpZiB0aGUgYXR0cmlidXRlIGRvZXNuJ3QgZXhpc3QuCiAgICB1bnNldDogZnVuY3Rpb24gKGF0dHIsIG9wdGlvbnMpIHsKICAgICAgcmV0dXJuIHRoaXMuc2V0KGF0dHIsIHZvaWQgMCwgXy5leHRlbmQoe30sIG9wdGlvbnMsIHsgdW5zZXQ6IHRydWUgfSkpOwogICAgfSwKICAgIC8vIENsZWFyIGFsbCBhdHRyaWJ1dGVzIG9uIHRoZSBtb2RlbCwgZmlyaW5nIGAiY2hhbmdlImAuCiAgICBjbGVhcjogZnVuY3Rpb24gKG9wdGlvbnMpIHsKICAgICAgdmFyIGF0dHJzID0ge307CiAgICAgIGZvciAodmFyIGtleSBpbiB0aGlzLmF0dHJpYnV0ZXMpCiAgICAgICAgYXR0cnNba2V5XSA9IHZvaWQgMDsKICAgICAgcmV0dXJuIHRoaXMuc2V0KGF0dHJzLCBfLmV4dGVuZCh7fSwgb3B0aW9ucywgeyB1bnNldDogdHJ1ZSB9KSk7CiAgICB9LAogICAgLy8gRGV0ZXJtaW5lIGlmIHRoZSBtb2RlbCBoYXMgY2hhbmdlZCBzaW5jZSB0aGUgbGFzdCBgImNoYW5nZSJgIGV2ZW50LgogICAgLy8gSWYgeW91IHNwZWNpZnkgYW4gYXR0cmlidXRlIG5hbWUsIGRldGVybWluZSBpZiB0aGF0IGF0dHJpYnV0ZSBoYXMgY2hhbmdlZC4KICAgIGhhc0NoYW5nZWQ6IGZ1bmN0aW9uIChhdHRyKSB7CiAgICAgIGlmIChhdHRyID09IG51bGwpCiAgICAgICAgcmV0dXJuICFfLmlzRW1wdHkodGhpcy5jaGFuZ2VkKTsKICAgICAgcmV0dXJuIF8uaGFzKHRoaXMuY2hhbmdlZCwgYXR0cik7CiAgICB9LAogICAgLy8gUmV0dXJuIGFuIG9iamVjdCBjb250YWluaW5nIGFsbCB0aGUgYXR0cmlidXRlcyB0aGF0IGhhdmUgY2hhbmdlZCwgb3IKICAgIC8vIGZhbHNlIGlmIHRoZXJlIGFyZSBubyBjaGFuZ2VkIGF0dHJpYnV0ZXMuIFVzZWZ1bCBmb3IgZGV0ZXJtaW5pbmcgd2hhdAogICAgLy8gcGFydHMgb2YgYSB2aWV3IG5lZWQgdG8gYmUgdXBkYXRlZCBhbmQvb3Igd2hhdCBhdHRyaWJ1dGVzIG5lZWQgdG8gYmUKICAgIC8vIHBlcnNpc3RlZCB0byB0aGUgc2VydmVyLiBVbnNldCBhdHRyaWJ1dGVzIHdpbGwgYmUgc2V0IHRvIHVuZGVmaW5lZC4KICAgIC8vIFlvdSBjYW4gYWxzbyBwYXNzIGFuIGF0dHJpYnV0ZXMgb2JqZWN0IHRvIGRpZmYgYWdhaW5zdCB0aGUgbW9kZWwsCiAgICAvLyBkZXRlcm1pbmluZyBpZiB0aGVyZSAqd291bGQgYmUqIGEgY2hhbmdlLgogICAgY2hhbmdlZEF0dHJpYnV0ZXM6IGZ1bmN0aW9uIChkaWZmKSB7CiAgICAgIGlmICghZGlmZikKICAgICAgICByZXR1cm4gdGhpcy5oYXNDaGFuZ2VkKCkgPyBfLmNsb25lKHRoaXMuY2hhbmdlZCkgOiBmYWxzZTsKICAgICAgdmFyIHZhbCwgY2hhbmdlZCA9IGZhbHNlOwogICAgICB2YXIgb2xkID0gdGhpcy5fY2hhbmdpbmcgPyB0aGlzLl9wcmV2aW91c0F0dHJpYnV0ZXMgOiB0aGlzLmF0dHJpYnV0ZXM7CiAgICAgIGZvciAodmFyIGF0dHIgaW4gZGlmZikgewogICAgICAgIGlmIChfLmlzRXF1YWwob2xkW2F0dHJdLCB2YWwgPSBkaWZmW2F0dHJdKSkKICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIChjaGFuZ2VkIHx8IChjaGFuZ2VkID0ge30pKVthdHRyXSA9IHZhbDsKICAgICAgfQogICAgICByZXR1cm4gY2hhbmdlZDsKICAgIH0sCiAgICAvLyBHZXQgdGhlIHByZXZpb3VzIHZhbHVlIG9mIGFuIGF0dHJpYnV0ZSwgcmVjb3JkZWQgYXQgdGhlIHRpbWUgdGhlIGxhc3QKICAgIC8vIGAiY2hhbmdlImAgZXZlbnQgd2FzIGZpcmVkLgogICAgcHJldmlvdXM6IGZ1bmN0aW9uIChhdHRyKSB7CiAgICAgIGlmIChhdHRyID09IG51bGwgfHwgIXRoaXMuX3ByZXZpb3VzQXR0cmlidXRlcykKICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgcmV0dXJuIHRoaXMuX3ByZXZpb3VzQXR0cmlidXRlc1thdHRyXTsKICAgIH0sCiAgICAvLyBHZXQgYWxsIG9mIHRoZSBhdHRyaWJ1dGVzIG9mIHRoZSBtb2RlbCBhdCB0aGUgdGltZSBvZiB0aGUgcHJldmlvdXMKICAgIC8vIGAiY2hhbmdlImAgZXZlbnQuCiAgICBwcmV2aW91c0F0dHJpYnV0ZXM6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIF8uY2xvbmUodGhpcy5fcHJldmlvdXNBdHRyaWJ1dGVzKTsKICAgIH0sCiAgICAvLyBGZXRjaCB0aGUgbW9kZWwgZnJvbSB0aGUgc2VydmVyLiBJZiB0aGUgc2VydmVyJ3MgcmVwcmVzZW50YXRpb24gb2YgdGhlCiAgICAvLyBtb2RlbCBkaWZmZXJzIGZyb20gaXRzIGN1cnJlbnQgYXR0cmlidXRlcywgdGhleSB3aWxsIGJlIG92ZXJyaWRkZW4sCiAgICAvLyB0cmlnZ2VyaW5nIGEgYCJjaGFuZ2UiYCBldmVudC4KICAgIGZldGNoOiBmdW5jdGlvbiAob3B0aW9ucykgewogICAgICBvcHRpb25zID0gb3B0aW9ucyA/IF8uY2xvbmUob3B0aW9ucykgOiB7fTsKICAgICAgaWYgKG9wdGlvbnMucGFyc2UgPT09IHZvaWQgMCkKICAgICAgICBvcHRpb25zLnBhcnNlID0gdHJ1ZTsKICAgICAgdmFyIG1vZGVsID0gdGhpczsKICAgICAgdmFyIHN1Y2Nlc3MgPSBvcHRpb25zLnN1Y2Nlc3M7CiAgICAgIG9wdGlvbnMuc3VjY2VzcyA9IGZ1bmN0aW9uIChyZXNwKSB7CiAgICAgICAgaWYgKCFtb2RlbC5zZXQobW9kZWwucGFyc2UocmVzcCwgb3B0aW9ucyksIG9wdGlvbnMpKQogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIGlmIChzdWNjZXNzKQogICAgICAgICAgc3VjY2Vzcyhtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CiAgICAgICAgbW9kZWwudHJpZ2dlcignc3luYycsIG1vZGVsLCByZXNwLCBvcHRpb25zKTsKICAgICAgfTsKICAgICAgd3JhcEVycm9yKHRoaXMsIG9wdGlvbnMpOwogICAgICByZXR1cm4gdGhpcy5zeW5jKCdyZWFkJywgdGhpcywgb3B0aW9ucyk7CiAgICB9LAogICAgLy8gU2V0IGEgaGFzaCBvZiBtb2RlbCBhdHRyaWJ1dGVzLCBhbmQgc3luYyB0aGUgbW9kZWwgdG8gdGhlIHNlcnZlci4KICAgIC8vIElmIHRoZSBzZXJ2ZXIgcmV0dXJucyBhbiBhdHRyaWJ1dGVzIGhhc2ggdGhhdCBkaWZmZXJzLCB0aGUgbW9kZWwncwogICAgLy8gc3RhdGUgd2lsbCBiZSBgc2V0YCBhZ2Fpbi4KICAgIHNhdmU6IGZ1bmN0aW9uIChrZXksIHZhbCwgb3B0aW9ucykgewogICAgICB2YXIgYXR0cnMsIG1ldGhvZCwgeGhyLCBhdHRyaWJ1dGVzID0gdGhpcy5hdHRyaWJ1dGVzOwogICAgICAvLyBIYW5kbGUgYm90aCBgImtleSIsIHZhbHVlYCBhbmQgYHtrZXk6IHZhbHVlfWAgLXN0eWxlIGFyZ3VtZW50cy4KICAgICAgaWYgKGtleSA9PSBudWxsIHx8IHR5cGVvZiBrZXkgPT09ICdvYmplY3QnKSB7CiAgICAgICAgYXR0cnMgPSBrZXk7CiAgICAgICAgb3B0aW9ucyA9IHZhbDsKICAgICAgfSBlbHNlIHsKICAgICAgICAoYXR0cnMgPSB7fSlba2V5XSA9IHZhbDsKICAgICAgfQogICAgICBvcHRpb25zID0gXy5leHRlbmQoeyB2YWxpZGF0ZTogdHJ1ZSB9LCBvcHRpb25zKTsKICAgICAgLy8gSWYgd2UncmUgbm90IHdhaXRpbmcgYW5kIGF0dHJpYnV0ZXMgZXhpc3QsIHNhdmUgYWN0cyBhcwogICAgICAvLyBgc2V0KGF0dHIpLnNhdmUobnVsbCwgb3B0cylgIHdpdGggdmFsaWRhdGlvbi4gT3RoZXJ3aXNlLCBjaGVjayBpZgogICAgICAvLyB0aGUgbW9kZWwgd2lsbCBiZSB2YWxpZCB3aGVuIHRoZSBhdHRyaWJ1dGVzLCBpZiBhbnksIGFyZSBzZXQuCiAgICAgIGlmIChhdHRycyAmJiAhb3B0aW9ucy53YWl0KSB7CiAgICAgICAgaWYgKCF0aGlzLnNldChhdHRycywgb3B0aW9ucykpCiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKCF0aGlzLl92YWxpZGF0ZShhdHRycywgb3B0aW9ucykpCiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgICAgLy8gU2V0IHRlbXBvcmFyeSBhdHRyaWJ1dGVzIGlmIGB7d2FpdDogdHJ1ZX1gLgogICAgICBpZiAoYXR0cnMgJiYgb3B0aW9ucy53YWl0KSB7CiAgICAgICAgdGhpcy5hdHRyaWJ1dGVzID0gXy5leHRlbmQoe30sIGF0dHJpYnV0ZXMsIGF0dHJzKTsKICAgICAgfQogICAgICAvLyBBZnRlciBhIHN1Y2Nlc3NmdWwgc2VydmVyLXNpZGUgc2F2ZSwgdGhlIGNsaWVudCBpcyAob3B0aW9uYWxseSkKICAgICAgLy8gdXBkYXRlZCB3aXRoIHRoZSBzZXJ2ZXItc2lkZSBzdGF0ZS4KICAgICAgaWYgKG9wdGlvbnMucGFyc2UgPT09IHZvaWQgMCkKICAgICAgICBvcHRpb25zLnBhcnNlID0gdHJ1ZTsKICAgICAgdmFyIG1vZGVsID0gdGhpczsKICAgICAgdmFyIHN1Y2Nlc3MgPSBvcHRpb25zLnN1Y2Nlc3M7CiAgICAgIG9wdGlvbnMuc3VjY2VzcyA9IGZ1bmN0aW9uIChyZXNwKSB7CiAgICAgICAgLy8gRW5zdXJlIGF0dHJpYnV0ZXMgYXJlIHJlc3RvcmVkIGR1cmluZyBzeW5jaHJvbm91cyBzYXZlcy4KICAgICAgICBtb2RlbC5hdHRyaWJ1dGVzID0gYXR0cmlidXRlczsKICAgICAgICB2YXIgc2VydmVyQXR0cnMgPSBtb2RlbC5wYXJzZShyZXNwLCBvcHRpb25zKTsKICAgICAgICBpZiAob3B0aW9ucy53YWl0KQogICAgICAgICAgc2VydmVyQXR0cnMgPSBfLmV4dGVuZChhdHRycyB8fCB7fSwgc2VydmVyQXR0cnMpOwogICAgICAgIGlmIChfLmlzT2JqZWN0KHNlcnZlckF0dHJzKSAmJiAhbW9kZWwuc2V0KHNlcnZlckF0dHJzLCBvcHRpb25zKSkgewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICBpZiAoc3VjY2VzcykKICAgICAgICAgIHN1Y2Nlc3MobW9kZWwsIHJlc3AsIG9wdGlvbnMpOwogICAgICAgIG1vZGVsLnRyaWdnZXIoJ3N5bmMnLCBtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CiAgICAgIH07CiAgICAgIHdyYXBFcnJvcih0aGlzLCBvcHRpb25zKTsKICAgICAgbWV0aG9kID0gdGhpcy5pc05ldygpID8gJ2NyZWF0ZScgOiBvcHRpb25zLnBhdGNoID8gJ3BhdGNoJyA6ICd1cGRhdGUnOwogICAgICBpZiAobWV0aG9kID09PSAncGF0Y2gnKQogICAgICAgIG9wdGlvbnMuYXR0cnMgPSBhdHRyczsKICAgICAgeGhyID0gdGhpcy5zeW5jKG1ldGhvZCwgdGhpcywgb3B0aW9ucyk7CiAgICAgIC8vIFJlc3RvcmUgYXR0cmlidXRlcy4KICAgICAgaWYgKGF0dHJzICYmIG9wdGlvbnMud2FpdCkKICAgICAgICB0aGlzLmF0dHJpYnV0ZXMgPSBhdHRyaWJ1dGVzOwogICAgICByZXR1cm4geGhyOwogICAgfSwKICAgIC8vIERlc3Ryb3kgdGhpcyBtb2RlbCBvbiB0aGUgc2VydmVyIGlmIGl0IHdhcyBhbHJlYWR5IHBlcnNpc3RlZC4KICAgIC8vIE9wdGltaXN0aWNhbGx5IHJlbW92ZXMgdGhlIG1vZGVsIGZyb20gaXRzIGNvbGxlY3Rpb24sIGlmIGl0IGhhcyBvbmUuCiAgICAvLyBJZiBgd2FpdDogdHJ1ZWAgaXMgcGFzc2VkLCB3YWl0cyBmb3IgdGhlIHNlcnZlciB0byByZXNwb25kIGJlZm9yZSByZW1vdmFsLgogICAgZGVzdHJveTogZnVuY3Rpb24gKG9wdGlvbnMpIHsKICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgPyBfLmNsb25lKG9wdGlvbnMpIDoge307CiAgICAgIHZhciBtb2RlbCA9IHRoaXM7CiAgICAgIHZhciBzdWNjZXNzID0gb3B0aW9ucy5zdWNjZXNzOwogICAgICB2YXIgZGVzdHJveSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBtb2RlbC50cmlnZ2VyKCdkZXN0cm95JywgbW9kZWwsIG1vZGVsLmNvbGxlY3Rpb24sIG9wdGlvbnMpOwogICAgICB9OwogICAgICBvcHRpb25zLnN1Y2Nlc3MgPSBmdW5jdGlvbiAocmVzcCkgewogICAgICAgIGlmIChvcHRpb25zLndhaXQgfHwgbW9kZWwuaXNOZXcoKSkKICAgICAgICAgIGRlc3Ryb3koKTsKICAgICAgICBpZiAoc3VjY2VzcykKICAgICAgICAgIHN1Y2Nlc3MobW9kZWwsIHJlc3AsIG9wdGlvbnMpOwogICAgICAgIGlmICghbW9kZWwuaXNOZXcoKSkKICAgICAgICAgIG1vZGVsLnRyaWdnZXIoJ3N5bmMnLCBtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CiAgICAgIH07CiAgICAgIGlmICh0aGlzLmlzTmV3KCkpIHsKICAgICAgICBvcHRpb25zLnN1Y2Nlc3MoKTsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgICAgd3JhcEVycm9yKHRoaXMsIG9wdGlvbnMpOwogICAgICB2YXIgeGhyID0gdGhpcy5zeW5jKCdkZWxldGUnLCB0aGlzLCBvcHRpb25zKTsKICAgICAgaWYgKCFvcHRpb25zLndhaXQpCiAgICAgICAgZGVzdHJveSgpOwogICAgICByZXR1cm4geGhyOwogICAgfSwKICAgIC8vIERlZmF1bHQgVVJMIGZvciB0aGUgbW9kZWwncyByZXByZXNlbnRhdGlvbiBvbiB0aGUgc2VydmVyIC0tIGlmIHlvdSdyZQogICAgLy8gdXNpbmcgQmFja2JvbmUncyByZXN0ZnVsIG1ldGhvZHMsIG92ZXJyaWRlIHRoaXMgdG8gY2hhbmdlIHRoZSBlbmRwb2ludAogICAgLy8gdGhhdCB3aWxsIGJlIGNhbGxlZC4KICAgIHVybDogZnVuY3Rpb24gKCkgewogICAgICB2YXIgYmFzZSA9IF8ucmVzdWx0KHRoaXMsICd1cmxSb290JykgfHwgXy5yZXN1bHQodGhpcy5jb2xsZWN0aW9uLCAndXJsJykgfHwgdXJsRXJyb3IoKTsKICAgICAgaWYgKHRoaXMuaXNOZXcoKSkKICAgICAgICByZXR1cm4gYmFzZTsKICAgICAgcmV0dXJuIGJhc2UucmVwbGFjZSgvKFteXC9dKSQvLCAnJDEvJykgKyBlbmNvZGVVUklDb21wb25lbnQodGhpcy5pZCk7CiAgICB9LAogICAgLy8gKipwYXJzZSoqIGNvbnZlcnRzIGEgcmVzcG9uc2UgaW50byB0aGUgaGFzaCBvZiBhdHRyaWJ1dGVzIHRvIGJlIGBzZXRgIG9uCiAgICAvLyB0aGUgbW9kZWwuIFRoZSBkZWZhdWx0IGltcGxlbWVudGF0aW9uIGlzIGp1c3QgdG8gcGFzcyB0aGUgcmVzcG9uc2UgYWxvbmcuCiAgICBwYXJzZTogZnVuY3Rpb24gKHJlc3AsIG9wdGlvbnMpIHsKICAgICAgcmV0dXJuIHJlc3A7CiAgICB9LAogICAgLy8gQ3JlYXRlIGEgbmV3IG1vZGVsIHdpdGggaWRlbnRpY2FsIGF0dHJpYnV0ZXMgdG8gdGhpcyBvbmUuCiAgICBjbG9uZTogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gbmV3IHRoaXMuY29uc3RydWN0b3IodGhpcy5hdHRyaWJ1dGVzKTsKICAgIH0sCiAgICAvLyBBIG1vZGVsIGlzIG5ldyBpZiBpdCBoYXMgbmV2ZXIgYmVlbiBzYXZlZCB0byB0aGUgc2VydmVyLCBhbmQgbGFja3MgYW4gaWQuCiAgICBpc05ldzogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gIXRoaXMuaGFzKHRoaXMuaWRBdHRyaWJ1dGUpOwogICAgfSwKICAgIC8vIENoZWNrIGlmIHRoZSBtb2RlbCBpcyBjdXJyZW50bHkgaW4gYSB2YWxpZCBzdGF0ZS4KICAgIGlzVmFsaWQ6IGZ1bmN0aW9uIChvcHRpb25zKSB7CiAgICAgIHJldHVybiB0aGlzLl92YWxpZGF0ZSh7fSwgXy5leHRlbmQob3B0aW9ucyB8fCB7fSwgeyB2YWxpZGF0ZTogdHJ1ZSB9KSk7CiAgICB9LAogICAgLy8gUnVuIHZhbGlkYXRpb24gYWdhaW5zdCB0aGUgbmV4dCBjb21wbGV0ZSBzZXQgb2YgbW9kZWwgYXR0cmlidXRlcywKICAgIC8vIHJldHVybmluZyBgdHJ1ZWAgaWYgYWxsIGlzIHdlbGwuIE90aGVyd2lzZSwgZmlyZSBhbiBgImludmFsaWQiYCBldmVudC4KICAgIF92YWxpZGF0ZTogZnVuY3Rpb24gKGF0dHJzLCBvcHRpb25zKSB7CiAgICAgIGlmICghb3B0aW9ucy52YWxpZGF0ZSB8fCAhdGhpcy52YWxpZGF0ZSkKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgYXR0cnMgPSBfLmV4dGVuZCh7fSwgdGhpcy5hdHRyaWJ1dGVzLCBhdHRycyk7CiAgICAgIHZhciBlcnJvciA9IHRoaXMudmFsaWRhdGlvbkVycm9yID0gdGhpcy52YWxpZGF0ZShhdHRycywgb3B0aW9ucykgfHwgbnVsbDsKICAgICAgaWYgKCFlcnJvcikKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgdGhpcy50cmlnZ2VyKCdpbnZhbGlkJywgdGhpcywgZXJyb3IsIF8uZXh0ZW5kKG9wdGlvbnMsIHsgdmFsaWRhdGlvbkVycm9yOiBlcnJvciB9KSk7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICB9KTsKICAvLyBVbmRlcnNjb3JlIG1ldGhvZHMgdGhhdCB3ZSB3YW50IHRvIGltcGxlbWVudCBvbiB0aGUgTW9kZWwuCiAgdmFyIG1vZGVsTWV0aG9kcyA9IFsKICAgICdrZXlzJywKICAgICd2YWx1ZXMnLAogICAgJ3BhaXJzJywKICAgICdpbnZlcnQnLAogICAgJ3BpY2snLAogICAgJ29taXQnCiAgXTsKICAvLyBNaXggaW4gZWFjaCBVbmRlcnNjb3JlIG1ldGhvZCBhcyBhIHByb3h5IHRvIGBNb2RlbCNhdHRyaWJ1dGVzYC4KICBfLmVhY2gobW9kZWxNZXRob2RzLCBmdW5jdGlvbiAobWV0aG9kKSB7CiAgICBNb2RlbC5wcm90b3R5cGVbbWV0aG9kXSA9IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cyk7CiAgICAgIGFyZ3MudW5zaGlmdCh0aGlzLmF0dHJpYnV0ZXMpOwogICAgICByZXR1cm4gX1ttZXRob2RdLmFwcGx5KF8sIGFyZ3MpOwogICAgfTsKICB9KTsKICAvLyBCYWNrYm9uZS5Db2xsZWN0aW9uCiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLQogIC8vIElmIG1vZGVscyB0ZW5kIHRvIHJlcHJlc2VudCBhIHNpbmdsZSByb3cgb2YgZGF0YSwgYSBCYWNrYm9uZSBDb2xsZWN0aW9uIGlzCiAgLy8gbW9yZSBhbmFsYWdvdXMgdG8gYSB0YWJsZSBmdWxsIG9mIGRhdGEgLi4uIG9yIGEgc21hbGwgc2xpY2Ugb3IgcGFnZSBvZiB0aGF0CiAgLy8gdGFibGUsIG9yIGEgY29sbGVjdGlvbiBvZiByb3dzIHRoYXQgYmVsb25nIHRvZ2V0aGVyIGZvciBhIHBhcnRpY3VsYXIgcmVhc29uCiAgLy8gLS0gYWxsIG9mIHRoZSBtZXNzYWdlcyBpbiB0aGlzIHBhcnRpY3VsYXIgZm9sZGVyLCBhbGwgb2YgdGhlIGRvY3VtZW50cwogIC8vIGJlbG9uZ2luZyB0byB0aGlzIHBhcnRpY3VsYXIgYXV0aG9yLCBhbmQgc28gb24uIENvbGxlY3Rpb25zIG1haW50YWluCiAgLy8gaW5kZXhlcyBvZiB0aGVpciBtb2RlbHMsIGJvdGggaW4gb3JkZXIsIGFuZCBmb3IgbG9va3VwIGJ5IGBpZGAuCiAgLy8gQ3JlYXRlIGEgbmV3ICoqQ29sbGVjdGlvbioqLCBwZXJoYXBzIHRvIGNvbnRhaW4gYSBzcGVjaWZpYyB0eXBlIG9mIGBtb2RlbGAuCiAgLy8gSWYgYSBgY29tcGFyYXRvcmAgaXMgc3BlY2lmaWVkLCB0aGUgQ29sbGVjdGlvbiB3aWxsIG1haW50YWluCiAgLy8gaXRzIG1vZGVscyBpbiBzb3J0IG9yZGVyLCBhcyB0aGV5J3JlIGFkZGVkIGFuZCByZW1vdmVkLgogIHZhciBDb2xsZWN0aW9uID0gQmFja2JvbmUuQ29sbGVjdGlvbiA9IGZ1bmN0aW9uIChtb2RlbHMsIG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CiAgICBpZiAob3B0aW9ucy5tb2RlbCkKICAgICAgdGhpcy5tb2RlbCA9IG9wdGlvbnMubW9kZWw7CiAgICBpZiAob3B0aW9ucy5jb21wYXJhdG9yICE9PSB2b2lkIDApCiAgICAgIHRoaXMuY29tcGFyYXRvciA9IG9wdGlvbnMuY29tcGFyYXRvcjsKICAgIHRoaXMuX3Jlc2V0KCk7CiAgICB0aGlzLmluaXRpYWxpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIGlmIChtb2RlbHMpCiAgICAgIHRoaXMucmVzZXQobW9kZWxzLCBfLmV4dGVuZCh7IHNpbGVudDogdHJ1ZSB9LCBvcHRpb25zKSk7CiAgfTsKICAvLyBEZWZhdWx0IG9wdGlvbnMgZm9yIGBDb2xsZWN0aW9uI3NldGAuCiAgdmFyIHNldE9wdGlvbnMgPSB7CiAgICBhZGQ6IHRydWUsCiAgICByZW1vdmU6IHRydWUsCiAgICBtZXJnZTogdHJ1ZQogIH07CiAgdmFyIGFkZE9wdGlvbnMgPSB7CiAgICBhZGQ6IHRydWUsCiAgICByZW1vdmU6IGZhbHNlCiAgfTsKICAvLyBEZWZpbmUgdGhlIENvbGxlY3Rpb24ncyBpbmhlcml0YWJsZSBtZXRob2RzLgogIF8uZXh0ZW5kKENvbGxlY3Rpb24ucHJvdG90eXBlLCBFdmVudHMsIHsKICAgIC8vIFRoZSBkZWZhdWx0IG1vZGVsIGZvciBhIGNvbGxlY3Rpb24gaXMganVzdCBhICoqQmFja2JvbmUuTW9kZWwqKi4KICAgIC8vIFRoaXMgc2hvdWxkIGJlIG92ZXJyaWRkZW4gaW4gbW9zdCBjYXNlcy4KICAgIG1vZGVsOiBNb2RlbCwKICAgIC8vIEluaXRpYWxpemUgaXMgYW4gZW1wdHkgZnVuY3Rpb24gYnkgZGVmYXVsdC4gT3ZlcnJpZGUgaXQgd2l0aCB5b3VyIG93bgogICAgLy8gaW5pdGlhbGl6YXRpb24gbG9naWMuCiAgICBpbml0aWFsaXplOiBmdW5jdGlvbiAoKSB7CiAgICB9LAogICAgLy8gVGhlIEpTT04gcmVwcmVzZW50YXRpb24gb2YgYSBDb2xsZWN0aW9uIGlzIGFuIGFycmF5IG9mIHRoZQogICAgLy8gbW9kZWxzJyBhdHRyaWJ1dGVzLgogICAgdG9KU09OOiBmdW5jdGlvbiAob3B0aW9ucykgewogICAgICByZXR1cm4gdGhpcy5tYXAoZnVuY3Rpb24gKG1vZGVsKSB7CiAgICAgICAgcmV0dXJuIG1vZGVsLnRvSlNPTihvcHRpb25zKTsKICAgICAgfSk7CiAgICB9LAogICAgLy8gUHJveHkgYEJhY2tib25lLnN5bmNgIGJ5IGRlZmF1bHQuCiAgICBzeW5jOiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBCYWNrYm9uZS5zeW5jLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9LAogICAgLy8gQWRkIGEgbW9kZWwsIG9yIGxpc3Qgb2YgbW9kZWxzIHRvIHRoZSBzZXQuCiAgICBhZGQ6IGZ1bmN0aW9uIChtb2RlbHMsIG9wdGlvbnMpIHsKICAgICAgcmV0dXJuIHRoaXMuc2V0KG1vZGVscywgXy5leHRlbmQoeyBtZXJnZTogZmFsc2UgfSwgb3B0aW9ucywgYWRkT3B0aW9ucykpOwogICAgfSwKICAgIC8vIFJlbW92ZSBhIG1vZGVsLCBvciBhIGxpc3Qgb2YgbW9kZWxzIGZyb20gdGhlIHNldC4KICAgIHJlbW92ZTogZnVuY3Rpb24gKG1vZGVscywgb3B0aW9ucykgewogICAgICB2YXIgc2luZ3VsYXIgPSAhXy5pc0FycmF5KG1vZGVscyk7CiAgICAgIG1vZGVscyA9IHNpbmd1bGFyID8gW21vZGVsc10gOiBfLmNsb25lKG1vZGVscyk7CiAgICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CiAgICAgIHZhciBpLCBsLCBpbmRleCwgbW9kZWw7CiAgICAgIGZvciAoaSA9IDAsIGwgPSBtb2RlbHMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgbW9kZWwgPSBtb2RlbHNbaV0gPSB0aGlzLmdldChtb2RlbHNbaV0pOwogICAgICAgIGlmICghbW9kZWwpCiAgICAgICAgICBjb250aW51ZTsKICAgICAgICBkZWxldGUgdGhpcy5fYnlJZFttb2RlbC5pZF07CiAgICAgICAgZGVsZXRlIHRoaXMuX2J5SWRbbW9kZWwuY2lkXTsKICAgICAgICBpbmRleCA9IHRoaXMuaW5kZXhPZihtb2RlbCk7CiAgICAgICAgdGhpcy5tb2RlbHMuc3BsaWNlKGluZGV4LCAxKTsKICAgICAgICB0aGlzLmxlbmd0aC0tOwogICAgICAgIGlmICghb3B0aW9ucy5zaWxlbnQpIHsKICAgICAgICAgIG9wdGlvbnMuaW5kZXggPSBpbmRleDsKICAgICAgICAgIG1vZGVsLnRyaWdnZXIoJ3JlbW92ZScsIG1vZGVsLCB0aGlzLCBvcHRpb25zKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5fcmVtb3ZlUmVmZXJlbmNlKG1vZGVsLCBvcHRpb25zKTsKICAgICAgfQogICAgICByZXR1cm4gc2luZ3VsYXIgPyBtb2RlbHNbMF0gOiBtb2RlbHM7CiAgICB9LAogICAgLy8gVXBkYXRlIGEgY29sbGVjdGlvbiBieSBgc2V0YC1pbmcgYSBuZXcgbGlzdCBvZiBtb2RlbHMsIGFkZGluZyBuZXcgb25lcywKICAgIC8vIHJlbW92aW5nIG1vZGVscyB0aGF0IGFyZSBubyBsb25nZXIgcHJlc2VudCwgYW5kIG1lcmdpbmcgbW9kZWxzIHRoYXQKICAgIC8vIGFscmVhZHkgZXhpc3QgaW4gdGhlIGNvbGxlY3Rpb24sIGFzIG5lY2Vzc2FyeS4gU2ltaWxhciB0byAqKk1vZGVsI3NldCoqLAogICAgLy8gdGhlIGNvcmUgb3BlcmF0aW9uIGZvciB1cGRhdGluZyB0aGUgZGF0YSBjb250YWluZWQgYnkgdGhlIGNvbGxlY3Rpb24uCiAgICBzZXQ6IGZ1bmN0aW9uIChtb2RlbHMsIG9wdGlvbnMpIHsKICAgICAgb3B0aW9ucyA9IF8uZGVmYXVsdHMoe30sIG9wdGlvbnMsIHNldE9wdGlvbnMpOwogICAgICBpZiAob3B0aW9ucy5wYXJzZSkKICAgICAgICBtb2RlbHMgPSB0aGlzLnBhcnNlKG1vZGVscywgb3B0aW9ucyk7CiAgICAgIHZhciBzaW5ndWxhciA9ICFfLmlzQXJyYXkobW9kZWxzKTsKICAgICAgbW9kZWxzID0gc2luZ3VsYXIgPyBtb2RlbHMgPyBbbW9kZWxzXSA6IFtdIDogXy5jbG9uZShtb2RlbHMpOwogICAgICB2YXIgaSwgbCwgaWQsIG1vZGVsLCBhdHRycywgZXhpc3RpbmcsIHNvcnQ7CiAgICAgIHZhciBhdCA9IG9wdGlvbnMuYXQ7CiAgICAgIHZhciB0YXJnZXRNb2RlbCA9IHRoaXMubW9kZWw7CiAgICAgIHZhciBzb3J0YWJsZSA9IHRoaXMuY29tcGFyYXRvciAmJiBhdCA9PSBudWxsICYmIG9wdGlvbnMuc29ydCAhPT0gZmFsc2U7CiAgICAgIHZhciBzb3J0QXR0ciA9IF8uaXNTdHJpbmcodGhpcy5jb21wYXJhdG9yKSA/IHRoaXMuY29tcGFyYXRvciA6IG51bGw7CiAgICAgIHZhciB0b0FkZCA9IFtdLCB0b1JlbW92ZSA9IFtdLCBtb2RlbE1hcCA9IHt9OwogICAgICB2YXIgYWRkID0gb3B0aW9ucy5hZGQsIG1lcmdlID0gb3B0aW9ucy5tZXJnZSwgcmVtb3ZlID0gb3B0aW9ucy5yZW1vdmU7CiAgICAgIHZhciBvcmRlciA9ICFzb3J0YWJsZSAmJiBhZGQgJiYgcmVtb3ZlID8gW10gOiBmYWxzZTsKICAgICAgLy8gVHVybiBiYXJlIG9iamVjdHMgaW50byBtb2RlbCByZWZlcmVuY2VzLCBhbmQgcHJldmVudCBpbnZhbGlkIG1vZGVscwogICAgICAvLyBmcm9tIGJlaW5nIGFkZGVkLgogICAgICBmb3IgKGkgPSAwLCBsID0gbW9kZWxzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgIGF0dHJzID0gbW9kZWxzW2ldIHx8IHt9OwogICAgICAgIGlmIChhdHRycyBpbnN0YW5jZW9mIE1vZGVsKSB7CiAgICAgICAgICBpZCA9IG1vZGVsID0gYXR0cnM7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlkID0gYXR0cnNbdGFyZ2V0TW9kZWwucHJvdG90eXBlLmlkQXR0cmlidXRlIHx8ICdpZCddOwogICAgICAgIH0KICAgICAgICAvLyBJZiBhIGR1cGxpY2F0ZSBpcyBmb3VuZCwgcHJldmVudCBpdCBmcm9tIGJlaW5nIGFkZGVkIGFuZAogICAgICAgIC8vIG9wdGlvbmFsbHkgbWVyZ2UgaXQgaW50byB0aGUgZXhpc3RpbmcgbW9kZWwuCiAgICAgICAgaWYgKGV4aXN0aW5nID0gdGhpcy5nZXQoaWQpKSB7CiAgICAgICAgICBpZiAocmVtb3ZlKQogICAgICAgICAgICBtb2RlbE1hcFtleGlzdGluZy5jaWRdID0gdHJ1ZTsKICAgICAgICAgIGlmIChtZXJnZSkgewogICAgICAgICAgICBhdHRycyA9IGF0dHJzID09PSBtb2RlbCA/IG1vZGVsLmF0dHJpYnV0ZXMgOiBhdHRyczsKICAgICAgICAgICAgaWYgKG9wdGlvbnMucGFyc2UpCiAgICAgICAgICAgICAgYXR0cnMgPSBleGlzdGluZy5wYXJzZShhdHRycywgb3B0aW9ucyk7CiAgICAgICAgICAgIGV4aXN0aW5nLnNldChhdHRycywgb3B0aW9ucyk7CiAgICAgICAgICAgIGlmIChzb3J0YWJsZSAmJiAhc29ydCAmJiBleGlzdGluZy5oYXNDaGFuZ2VkKHNvcnRBdHRyKSkKICAgICAgICAgICAgICBzb3J0ID0gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICAgIG1vZGVsc1tpXSA9IGV4aXN0aW5nOyAgLy8gSWYgdGhpcyBpcyBhIG5ldywgdmFsaWQgbW9kZWwsIHB1c2ggaXQgdG8gdGhlIGB0b0FkZGAgbGlzdC4KICAgICAgICB9IGVsc2UgaWYgKGFkZCkgewogICAgICAgICAgbW9kZWwgPSBtb2RlbHNbaV0gPSB0aGlzLl9wcmVwYXJlTW9kZWwoYXR0cnMsIG9wdGlvbnMpOwogICAgICAgICAgaWYgKCFtb2RlbCkKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICB0b0FkZC5wdXNoKG1vZGVsKTsKICAgICAgICAgIHRoaXMuX2FkZFJlZmVyZW5jZShtb2RlbCwgb3B0aW9ucyk7CiAgICAgICAgfQogICAgICAgIC8vIERvIG5vdCBhZGQgbXVsdGlwbGUgbW9kZWxzIHdpdGggdGhlIHNhbWUgYGlkYC4KICAgICAgICBtb2RlbCA9IGV4aXN0aW5nIHx8IG1vZGVsOwogICAgICAgIGlmIChvcmRlciAmJiAobW9kZWwuaXNOZXcoKSB8fCAhbW9kZWxNYXBbbW9kZWwuaWRdKSkKICAgICAgICAgIG9yZGVyLnB1c2gobW9kZWwpOwogICAgICAgIG1vZGVsTWFwW21vZGVsLmlkXSA9IHRydWU7CiAgICAgIH0KICAgICAgLy8gUmVtb3ZlIG5vbmV4aXN0ZW50IG1vZGVscyBpZiBhcHByb3ByaWF0ZS4KICAgICAgaWYgKHJlbW92ZSkgewogICAgICAgIGZvciAoaSA9IDAsIGwgPSB0aGlzLmxlbmd0aDsgaSA8IGw7ICsraSkgewogICAgICAgICAgaWYgKCFtb2RlbE1hcFsobW9kZWwgPSB0aGlzLm1vZGVsc1tpXSkuY2lkXSkKICAgICAgICAgICAgdG9SZW1vdmUucHVzaChtb2RlbCk7CiAgICAgICAgfQogICAgICAgIGlmICh0b1JlbW92ZS5sZW5ndGgpCiAgICAgICAgICB0aGlzLnJlbW92ZSh0b1JlbW92ZSwgb3B0aW9ucyk7CiAgICAgIH0KICAgICAgLy8gU2VlIGlmIHNvcnRpbmcgaXMgbmVlZGVkLCB1cGRhdGUgYGxlbmd0aGAgYW5kIHNwbGljZSBpbiBuZXcgbW9kZWxzLgogICAgICBpZiAodG9BZGQubGVuZ3RoIHx8IG9yZGVyICYmIG9yZGVyLmxlbmd0aCkgewogICAgICAgIGlmIChzb3J0YWJsZSkKICAgICAgICAgIHNvcnQgPSB0cnVlOwogICAgICAgIHRoaXMubGVuZ3RoICs9IHRvQWRkLmxlbmd0aDsKICAgICAgICBpZiAoYXQgIT0gbnVsbCkgewogICAgICAgICAgZm9yIChpID0gMCwgbCA9IHRvQWRkLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgICB0aGlzLm1vZGVscy5zcGxpY2UoYXQgKyBpLCAwLCB0b0FkZFtpXSk7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlmIChvcmRlcikKICAgICAgICAgICAgdGhpcy5tb2RlbHMubGVuZ3RoID0gMDsKICAgICAgICAgIHZhciBvcmRlcmVkTW9kZWxzID0gb3JkZXIgfHwgdG9BZGQ7CiAgICAgICAgICBmb3IgKGkgPSAwLCBsID0gb3JkZXJlZE1vZGVscy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgICAgdGhpcy5tb2RlbHMucHVzaChvcmRlcmVkTW9kZWxzW2ldKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgLy8gU2lsZW50bHkgc29ydCB0aGUgY29sbGVjdGlvbiBpZiBhcHByb3ByaWF0ZS4KICAgICAgaWYgKHNvcnQpCiAgICAgICAgdGhpcy5zb3J0KHsgc2lsZW50OiB0cnVlIH0pOwogICAgICAvLyBVbmxlc3Mgc2lsZW5jZWQsIGl0J3MgdGltZSB0byBmaXJlIGFsbCBhcHByb3ByaWF0ZSBhZGQvc29ydCBldmVudHMuCiAgICAgIGlmICghb3B0aW9ucy5zaWxlbnQpIHsKICAgICAgICBmb3IgKGkgPSAwLCBsID0gdG9BZGQubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgICAobW9kZWwgPSB0b0FkZFtpXSkudHJpZ2dlcignYWRkJywgbW9kZWwsIHRoaXMsIG9wdGlvbnMpOwogICAgICAgIH0KICAgICAgICBpZiAoc29ydCB8fCBvcmRlciAmJiBvcmRlci5sZW5ndGgpCiAgICAgICAgICB0aGlzLnRyaWdnZXIoJ3NvcnQnLCB0aGlzLCBvcHRpb25zKTsKICAgICAgfQogICAgICAvLyBSZXR1cm4gdGhlIGFkZGVkIChvciBtZXJnZWQpIG1vZGVsIChvciBtb2RlbHMpLgogICAgICByZXR1cm4gc2luZ3VsYXIgPyBtb2RlbHNbMF0gOiBtb2RlbHM7CiAgICB9LAogICAgLy8gV2hlbiB5b3UgaGF2ZSBtb3JlIGl0ZW1zIHRoYW4geW91IHdhbnQgdG8gYWRkIG9yIHJlbW92ZSBpbmRpdmlkdWFsbHksCiAgICAvLyB5b3UgY2FuIHJlc2V0IHRoZSBlbnRpcmUgc2V0IHdpdGggYSBuZXcgbGlzdCBvZiBtb2RlbHMsIHdpdGhvdXQgZmlyaW5nCiAgICAvLyBhbnkgZ3JhbnVsYXIgYGFkZGAgb3IgYHJlbW92ZWAgZXZlbnRzLiBGaXJlcyBgcmVzZXRgIHdoZW4gZmluaXNoZWQuCiAgICAvLyBVc2VmdWwgZm9yIGJ1bGsgb3BlcmF0aW9ucyBhbmQgb3B0aW1pemF0aW9ucy4KICAgIHJlc2V0OiBmdW5jdGlvbiAobW9kZWxzLCBvcHRpb25zKSB7CiAgICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CiAgICAgIGZvciAodmFyIGkgPSAwLCBsID0gdGhpcy5tb2RlbHMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgdGhpcy5fcmVtb3ZlUmVmZXJlbmNlKHRoaXMubW9kZWxzW2ldLCBvcHRpb25zKTsKICAgICAgfQogICAgICBvcHRpb25zLnByZXZpb3VzTW9kZWxzID0gdGhpcy5tb2RlbHM7CiAgICAgIHRoaXMuX3Jlc2V0KCk7CiAgICAgIG1vZGVscyA9IHRoaXMuYWRkKG1vZGVscywgXy5leHRlbmQoeyBzaWxlbnQ6IHRydWUgfSwgb3B0aW9ucykpOwogICAgICBpZiAoIW9wdGlvbnMuc2lsZW50KQogICAgICAgIHRoaXMudHJpZ2dlcigncmVzZXQnLCB0aGlzLCBvcHRpb25zKTsKICAgICAgcmV0dXJuIG1vZGVsczsKICAgIH0sCiAgICAvLyBBZGQgYSBtb2RlbCB0byB0aGUgZW5kIG9mIHRoZSBjb2xsZWN0aW9uLgogICAgcHVzaDogZnVuY3Rpb24gKG1vZGVsLCBvcHRpb25zKSB7CiAgICAgIHJldHVybiB0aGlzLmFkZChtb2RlbCwgXy5leHRlbmQoeyBhdDogdGhpcy5sZW5ndGggfSwgb3B0aW9ucykpOwogICAgfSwKICAgIC8vIFJlbW92ZSBhIG1vZGVsIGZyb20gdGhlIGVuZCBvZiB0aGUgY29sbGVjdGlvbi4KICAgIHBvcDogZnVuY3Rpb24gKG9wdGlvbnMpIHsKICAgICAgdmFyIG1vZGVsID0gdGhpcy5hdCh0aGlzLmxlbmd0aCAtIDEpOwogICAgICB0aGlzLnJlbW92ZShtb2RlbCwgb3B0aW9ucyk7CiAgICAgIHJldHVybiBtb2RlbDsKICAgIH0sCiAgICAvLyBBZGQgYSBtb2RlbCB0byB0aGUgYmVnaW5uaW5nIG9mIHRoZSBjb2xsZWN0aW9uLgogICAgdW5zaGlmdDogZnVuY3Rpb24gKG1vZGVsLCBvcHRpb25zKSB7CiAgICAgIHJldHVybiB0aGlzLmFkZChtb2RlbCwgXy5leHRlbmQoeyBhdDogMCB9LCBvcHRpb25zKSk7CiAgICB9LAogICAgLy8gUmVtb3ZlIGEgbW9kZWwgZnJvbSB0aGUgYmVnaW5uaW5nIG9mIHRoZSBjb2xsZWN0aW9uLgogICAgc2hpZnQ6IGZ1bmN0aW9uIChvcHRpb25zKSB7CiAgICAgIHZhciBtb2RlbCA9IHRoaXMuYXQoMCk7CiAgICAgIHRoaXMucmVtb3ZlKG1vZGVsLCBvcHRpb25zKTsKICAgICAgcmV0dXJuIG1vZGVsOwogICAgfSwKICAgIC8vIFNsaWNlIG91dCBhIHN1Yi1hcnJheSBvZiBtb2RlbHMgZnJvbSB0aGUgY29sbGVjdGlvbi4KICAgIHNsaWNlOiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBzbGljZS5hcHBseSh0aGlzLm1vZGVscywgYXJndW1lbnRzKTsKICAgIH0sCiAgICAvLyBHZXQgYSBtb2RlbCBmcm9tIHRoZSBzZXQgYnkgaWQuCiAgICBnZXQ6IGZ1bmN0aW9uIChvYmopIHsKICAgICAgaWYgKG9iaiA9PSBudWxsKQogICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgIHJldHVybiB0aGlzLl9ieUlkW29ial0gfHwgdGhpcy5fYnlJZFtvYmouaWRdIHx8IHRoaXMuX2J5SWRbb2JqLmNpZF07CiAgICB9LAogICAgLy8gR2V0IHRoZSBtb2RlbCBhdCB0aGUgZ2l2ZW4gaW5kZXguCiAgICBhdDogZnVuY3Rpb24gKGluZGV4KSB7CiAgICAgIHJldHVybiB0aGlzLm1vZGVsc1tpbmRleF07CiAgICB9LAogICAgLy8gUmV0dXJuIG1vZGVscyB3aXRoIG1hdGNoaW5nIGF0dHJpYnV0ZXMuIFVzZWZ1bCBmb3Igc2ltcGxlIGNhc2VzIG9mCiAgICAvLyBgZmlsdGVyYC4KICAgIHdoZXJlOiBmdW5jdGlvbiAoYXR0cnMsIGZpcnN0KSB7CiAgICAgIGlmIChfLmlzRW1wdHkoYXR0cnMpKQogICAgICAgIHJldHVybiBmaXJzdCA/IHZvaWQgMCA6IFtdOwogICAgICByZXR1cm4gdGhpc1tmaXJzdCA/ICdmaW5kJyA6ICdmaWx0ZXInXShmdW5jdGlvbiAobW9kZWwpIHsKICAgICAgICBmb3IgKHZhciBrZXkgaW4gYXR0cnMpIHsKICAgICAgICAgIGlmIChhdHRyc1trZXldICE9PSBtb2RlbC5nZXQoa2V5KSkKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfSk7CiAgICB9LAogICAgLy8gUmV0dXJuIHRoZSBmaXJzdCBtb2RlbCB3aXRoIG1hdGNoaW5nIGF0dHJpYnV0ZXMuIFVzZWZ1bCBmb3Igc2ltcGxlIGNhc2VzCiAgICAvLyBvZiBgZmluZGAuCiAgICBmaW5kV2hlcmU6IGZ1bmN0aW9uIChhdHRycykgewogICAgICByZXR1cm4gdGhpcy53aGVyZShhdHRycywgdHJ1ZSk7CiAgICB9LAogICAgLy8gRm9yY2UgdGhlIGNvbGxlY3Rpb24gdG8gcmUtc29ydCBpdHNlbGYuIFlvdSBkb24ndCBuZWVkIHRvIGNhbGwgdGhpcyB1bmRlcgogICAgLy8gbm9ybWFsIGNpcmN1bXN0YW5jZXMsIGFzIHRoZSBzZXQgd2lsbCBtYWludGFpbiBzb3J0IG9yZGVyIGFzIGVhY2ggaXRlbQogICAgLy8gaXMgYWRkZWQuCiAgICBzb3J0OiBmdW5jdGlvbiAob3B0aW9ucykgewogICAgICBpZiAoIXRoaXMuY29tcGFyYXRvcikKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0Nhbm5vdCBzb3J0IGEgc2V0IHdpdGhvdXQgYSBjb21wYXJhdG9yJyk7CiAgICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CiAgICAgIC8vIFJ1biBzb3J0IGJhc2VkIG9uIHR5cGUgb2YgYGNvbXBhcmF0b3JgLgogICAgICBpZiAoXy5pc1N0cmluZyh0aGlzLmNvbXBhcmF0b3IpIHx8IHRoaXMuY29tcGFyYXRvci5sZW5ndGggPT09IDEpIHsKICAgICAgICB0aGlzLm1vZGVscyA9IHRoaXMuc29ydEJ5KHRoaXMuY29tcGFyYXRvciwgdGhpcyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5tb2RlbHMuc29ydChfLmJpbmQodGhpcy5jb21wYXJhdG9yLCB0aGlzKSk7CiAgICAgIH0KICAgICAgaWYgKCFvcHRpb25zLnNpbGVudCkKICAgICAgICB0aGlzLnRyaWdnZXIoJ3NvcnQnLCB0aGlzLCBvcHRpb25zKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogICAgLy8gUGx1Y2sgYW4gYXR0cmlidXRlIGZyb20gZWFjaCBtb2RlbCBpbiB0aGUgY29sbGVjdGlvbi4KICAgIHBsdWNrOiBmdW5jdGlvbiAoYXR0cikgewogICAgICByZXR1cm4gXy5pbnZva2UodGhpcy5tb2RlbHMsICdnZXQnLCBhdHRyKTsKICAgIH0sCiAgICAvLyBGZXRjaCB0aGUgZGVmYXVsdCBzZXQgb2YgbW9kZWxzIGZvciB0aGlzIGNvbGxlY3Rpb24sIHJlc2V0dGluZyB0aGUKICAgIC8vIGNvbGxlY3Rpb24gd2hlbiB0aGV5IGFycml2ZS4gSWYgYHJlc2V0OiB0cnVlYCBpcyBwYXNzZWQsIHRoZSByZXNwb25zZQogICAgLy8gZGF0YSB3aWxsIGJlIHBhc3NlZCB0aHJvdWdoIHRoZSBgcmVzZXRgIG1ldGhvZCBpbnN0ZWFkIG9mIGBzZXRgLgogICAgZmV0Y2g6IGZ1bmN0aW9uIChvcHRpb25zKSB7CiAgICAgIG9wdGlvbnMgPSBvcHRpb25zID8gXy5jbG9uZShvcHRpb25zKSA6IHt9OwogICAgICBpZiAob3B0aW9ucy5wYXJzZSA9PT0gdm9pZCAwKQogICAgICAgIG9wdGlvbnMucGFyc2UgPSB0cnVlOwogICAgICB2YXIgc3VjY2VzcyA9IG9wdGlvbnMuc3VjY2VzczsKICAgICAgdmFyIGNvbGxlY3Rpb24gPSB0aGlzOwogICAgICBvcHRpb25zLnN1Y2Nlc3MgPSBmdW5jdGlvbiAocmVzcCkgewogICAgICAgIHZhciBtZXRob2QgPSBvcHRpb25zLnJlc2V0ID8gJ3Jlc2V0JyA6ICdzZXQnOwogICAgICAgIGNvbGxlY3Rpb25bbWV0aG9kXShyZXNwLCBvcHRpb25zKTsKICAgICAgICBpZiAoc3VjY2VzcykKICAgICAgICAgIHN1Y2Nlc3MoY29sbGVjdGlvbiwgcmVzcCwgb3B0aW9ucyk7CiAgICAgICAgY29sbGVjdGlvbi50cmlnZ2VyKCdzeW5jJywgY29sbGVjdGlvbiwgcmVzcCwgb3B0aW9ucyk7CiAgICAgIH07CiAgICAgIHdyYXBFcnJvcih0aGlzLCBvcHRpb25zKTsKICAgICAgcmV0dXJuIHRoaXMuc3luYygncmVhZCcsIHRoaXMsIG9wdGlvbnMpOwogICAgfSwKICAgIC8vIENyZWF0ZSBhIG5ldyBpbnN0YW5jZSBvZiBhIG1vZGVsIGluIHRoaXMgY29sbGVjdGlvbi4gQWRkIHRoZSBtb2RlbCB0byB0aGUKICAgIC8vIGNvbGxlY3Rpb24gaW1tZWRpYXRlbHksIHVubGVzcyBgd2FpdDogdHJ1ZWAgaXMgcGFzc2VkLCBpbiB3aGljaCBjYXNlIHdlCiAgICAvLyB3YWl0IGZvciB0aGUgc2VydmVyIHRvIGFncmVlLgogICAgY3JlYXRlOiBmdW5jdGlvbiAobW9kZWwsIG9wdGlvbnMpIHsKICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgPyBfLmNsb25lKG9wdGlvbnMpIDoge307CiAgICAgIGlmICghKG1vZGVsID0gdGhpcy5fcHJlcGFyZU1vZGVsKG1vZGVsLCBvcHRpb25zKSkpCiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICBpZiAoIW9wdGlvbnMud2FpdCkKICAgICAgICB0aGlzLmFkZChtb2RlbCwgb3B0aW9ucyk7CiAgICAgIHZhciBjb2xsZWN0aW9uID0gdGhpczsKICAgICAgdmFyIHN1Y2Nlc3MgPSBvcHRpb25zLnN1Y2Nlc3M7CiAgICAgIG9wdGlvbnMuc3VjY2VzcyA9IGZ1bmN0aW9uIChtb2RlbCwgcmVzcCkgewogICAgICAgIGlmIChvcHRpb25zLndhaXQpCiAgICAgICAgICBjb2xsZWN0aW9uLmFkZChtb2RlbCwgb3B0aW9ucyk7CiAgICAgICAgaWYgKHN1Y2Nlc3MpCiAgICAgICAgICBzdWNjZXNzKG1vZGVsLCByZXNwLCBvcHRpb25zKTsKICAgICAgfTsKICAgICAgbW9kZWwuc2F2ZShudWxsLCBvcHRpb25zKTsKICAgICAgcmV0dXJuIG1vZGVsOwogICAgfSwKICAgIC8vICoqcGFyc2UqKiBjb252ZXJ0cyBhIHJlc3BvbnNlIGludG8gYSBsaXN0IG9mIG1vZGVscyB0byBiZSBhZGRlZCB0byB0aGUKICAgIC8vIGNvbGxlY3Rpb24uIFRoZSBkZWZhdWx0IGltcGxlbWVudGF0aW9uIGlzIGp1c3QgdG8gcGFzcyBpdCB0aHJvdWdoLgogICAgcGFyc2U6IGZ1bmN0aW9uIChyZXNwLCBvcHRpb25zKSB7CiAgICAgIHJldHVybiByZXNwOwogICAgfSwKICAgIC8vIENyZWF0ZSBhIG5ldyBjb2xsZWN0aW9uIHdpdGggYW4gaWRlbnRpY2FsIGxpc3Qgb2YgbW9kZWxzIGFzIHRoaXMgb25lLgogICAgY2xvbmU6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIG5ldyB0aGlzLmNvbnN0cnVjdG9yKHRoaXMubW9kZWxzKTsKICAgIH0sCiAgICAvLyBQcml2YXRlIG1ldGhvZCB0byByZXNldCBhbGwgaW50ZXJuYWwgc3RhdGUuIENhbGxlZCB3aGVuIHRoZSBjb2xsZWN0aW9uCiAgICAvLyBpcyBmaXJzdCBpbml0aWFsaXplZCBvciByZXNldC4KICAgIF9yZXNldDogZnVuY3Rpb24gKCkgewogICAgICB0aGlzLmxlbmd0aCA9IDA7CiAgICAgIHRoaXMubW9kZWxzID0gW107CiAgICAgIHRoaXMuX2J5SWQgPSB7fTsKICAgIH0sCiAgICAvLyBQcmVwYXJlIGEgaGFzaCBvZiBhdHRyaWJ1dGVzIChvciBvdGhlciBtb2RlbCkgdG8gYmUgYWRkZWQgdG8gdGhpcwogICAgLy8gY29sbGVjdGlvbi4KICAgIF9wcmVwYXJlTW9kZWw6IGZ1bmN0aW9uIChhdHRycywgb3B0aW9ucykgewogICAgICBpZiAoYXR0cnMgaW5zdGFuY2VvZiBNb2RlbCkKICAgICAgICByZXR1cm4gYXR0cnM7CiAgICAgIG9wdGlvbnMgPSBvcHRpb25zID8gXy5jbG9uZShvcHRpb25zKSA6IHt9OwogICAgICBvcHRpb25zLmNvbGxlY3Rpb24gPSB0aGlzOwogICAgICB2YXIgbW9kZWwgPSBuZXcgdGhpcy5tb2RlbChhdHRycywgb3B0aW9ucyk7CiAgICAgIGlmICghbW9kZWwudmFsaWRhdGlvbkVycm9yKQogICAgICAgIHJldHVybiBtb2RlbDsKICAgICAgdGhpcy50cmlnZ2VyKCdpbnZhbGlkJywgdGhpcywgbW9kZWwudmFsaWRhdGlvbkVycm9yLCBvcHRpb25zKTsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfSwKICAgIC8vIEludGVybmFsIG1ldGhvZCB0byBjcmVhdGUgYSBtb2RlbCdzIHRpZXMgdG8gYSBjb2xsZWN0aW9uLgogICAgX2FkZFJlZmVyZW5jZTogZnVuY3Rpb24gKG1vZGVsLCBvcHRpb25zKSB7CiAgICAgIHRoaXMuX2J5SWRbbW9kZWwuY2lkXSA9IG1vZGVsOwogICAgICBpZiAobW9kZWwuaWQgIT0gbnVsbCkKICAgICAgICB0aGlzLl9ieUlkW21vZGVsLmlkXSA9IG1vZGVsOwogICAgICBpZiAoIW1vZGVsLmNvbGxlY3Rpb24pCiAgICAgICAgbW9kZWwuY29sbGVjdGlvbiA9IHRoaXM7CiAgICAgIG1vZGVsLm9uKCdhbGwnLCB0aGlzLl9vbk1vZGVsRXZlbnQsIHRoaXMpOwogICAgfSwKICAgIC8vIEludGVybmFsIG1ldGhvZCB0byBzZXZlciBhIG1vZGVsJ3MgdGllcyB0byBhIGNvbGxlY3Rpb24uCiAgICBfcmVtb3ZlUmVmZXJlbmNlOiBmdW5jdGlvbiAobW9kZWwsIG9wdGlvbnMpIHsKICAgICAgaWYgKHRoaXMgPT09IG1vZGVsLmNvbGxlY3Rpb24pCiAgICAgICAgZGVsZXRlIG1vZGVsLmNvbGxlY3Rpb247CiAgICAgIG1vZGVsLm9mZignYWxsJywgdGhpcy5fb25Nb2RlbEV2ZW50LCB0aGlzKTsKICAgIH0sCiAgICAvLyBJbnRlcm5hbCBtZXRob2QgY2FsbGVkIGV2ZXJ5IHRpbWUgYSBtb2RlbCBpbiB0aGUgc2V0IGZpcmVzIGFuIGV2ZW50LgogICAgLy8gU2V0cyBuZWVkIHRvIHVwZGF0ZSB0aGVpciBpbmRleGVzIHdoZW4gbW9kZWxzIGNoYW5nZSBpZHMuIEFsbCBvdGhlcgogICAgLy8gZXZlbnRzIHNpbXBseSBwcm94eSB0aHJvdWdoLiAiYWRkIiBhbmQgInJlbW92ZSIgZXZlbnRzIHRoYXQgb3JpZ2luYXRlCiAgICAvLyBpbiBvdGhlciBjb2xsZWN0aW9ucyBhcmUgaWdub3JlZC4KICAgIF9vbk1vZGVsRXZlbnQ6IGZ1bmN0aW9uIChldmVudCwgbW9kZWwsIGNvbGxlY3Rpb24sIG9wdGlvbnMpIHsKICAgICAgaWYgKChldmVudCA9PT0gJ2FkZCcgfHwgZXZlbnQgPT09ICdyZW1vdmUnKSAmJiBjb2xsZWN0aW9uICE9PSB0aGlzKQogICAgICAgIHJldHVybjsKICAgICAgaWYgKGV2ZW50ID09PSAnZGVzdHJveScpCiAgICAgICAgdGhpcy5yZW1vdmUobW9kZWwsIG9wdGlvbnMpOwogICAgICBpZiAobW9kZWwgJiYgZXZlbnQgPT09ICdjaGFuZ2U6JyArIG1vZGVsLmlkQXR0cmlidXRlKSB7CiAgICAgICAgZGVsZXRlIHRoaXMuX2J5SWRbbW9kZWwucHJldmlvdXMobW9kZWwuaWRBdHRyaWJ1dGUpXTsKICAgICAgICBpZiAobW9kZWwuaWQgIT0gbnVsbCkKICAgICAgICAgIHRoaXMuX2J5SWRbbW9kZWwuaWRdID0gbW9kZWw7CiAgICAgIH0KICAgICAgdGhpcy50cmlnZ2VyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9CiAgfSk7CiAgLy8gVW5kZXJzY29yZSBtZXRob2RzIHRoYXQgd2Ugd2FudCB0byBpbXBsZW1lbnQgb24gdGhlIENvbGxlY3Rpb24uCiAgLy8gOTAlIG9mIHRoZSBjb3JlIHVzZWZ1bG5lc3Mgb2YgQmFja2JvbmUgQ29sbGVjdGlvbnMgaXMgYWN0dWFsbHkgaW1wbGVtZW50ZWQKICAvLyByaWdodCBoZXJlOgogIHZhciBtZXRob2RzID0gWwogICAgJ2ZvckVhY2gnLAogICAgJ2VhY2gnLAogICAgJ21hcCcsCiAgICAnY29sbGVjdCcsCiAgICAncmVkdWNlJywKICAgICdmb2xkbCcsCiAgICAnaW5qZWN0JywKICAgICdyZWR1Y2VSaWdodCcsCiAgICAnZm9sZHInLAogICAgJ2ZpbmQnLAogICAgJ2RldGVjdCcsCiAgICAnZmlsdGVyJywKICAgICdzZWxlY3QnLAogICAgJ3JlamVjdCcsCiAgICAnZXZlcnknLAogICAgJ2FsbCcsCiAgICAnc29tZScsCiAgICAnYW55JywKICAgICdpbmNsdWRlJywKICAgICdjb250YWlucycsCiAgICAnaW52b2tlJywKICAgICdtYXgnLAogICAgJ21pbicsCiAgICAndG9BcnJheScsCiAgICAnc2l6ZScsCiAgICAnZmlyc3QnLAogICAgJ2hlYWQnLAogICAgJ3Rha2UnLAogICAgJ2luaXRpYWwnLAogICAgJ3Jlc3QnLAogICAgJ3RhaWwnLAogICAgJ2Ryb3AnLAogICAgJ2xhc3QnLAogICAgJ3dpdGhvdXQnLAogICAgJ2RpZmZlcmVuY2UnLAogICAgJ2luZGV4T2YnLAogICAgJ3NodWZmbGUnLAogICAgJ2xhc3RJbmRleE9mJywKICAgICdpc0VtcHR5JywKICAgICdjaGFpbicsCiAgICAnc2FtcGxlJwogIF07CiAgLy8gTWl4IGluIGVhY2ggVW5kZXJzY29yZSBtZXRob2QgYXMgYSBwcm94eSB0byBgQ29sbGVjdGlvbiNtb2RlbHNgLgogIF8uZWFjaChtZXRob2RzLCBmdW5jdGlvbiAobWV0aG9kKSB7CiAgICBDb2xsZWN0aW9uLnByb3RvdHlwZVttZXRob2RdID0gZnVuY3Rpb24gKCkgewogICAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzKTsKICAgICAgYXJncy51bnNoaWZ0KHRoaXMubW9kZWxzKTsKICAgICAgcmV0dXJuIF9bbWV0aG9kXS5hcHBseShfLCBhcmdzKTsKICAgIH07CiAgfSk7CiAgLy8gVW5kZXJzY29yZSBtZXRob2RzIHRoYXQgdGFrZSBhIHByb3BlcnR5IG5hbWUgYXMgYW4gYXJndW1lbnQuCiAgdmFyIGF0dHJpYnV0ZU1ldGhvZHMgPSBbCiAgICAnZ3JvdXBCeScsCiAgICAnY291bnRCeScsCiAgICAnc29ydEJ5JywKICAgICdpbmRleEJ5JwogIF07CiAgLy8gVXNlIGF0dHJpYnV0ZXMgaW5zdGVhZCBvZiBwcm9wZXJ0aWVzLgogIF8uZWFjaChhdHRyaWJ1dGVNZXRob2RzLCBmdW5jdGlvbiAobWV0aG9kKSB7CiAgICBDb2xsZWN0aW9uLnByb3RvdHlwZVttZXRob2RdID0gZnVuY3Rpb24gKHZhbHVlLCBjb250ZXh0KSB7CiAgICAgIHZhciBpdGVyYXRvciA9IF8uaXNGdW5jdGlvbih2YWx1ZSkgPyB2YWx1ZSA6IGZ1bmN0aW9uIChtb2RlbCkgewogICAgICAgIHJldHVybiBtb2RlbC5nZXQodmFsdWUpOwogICAgICB9OwogICAgICByZXR1cm4gX1ttZXRob2RdKHRoaXMubW9kZWxzLCBpdGVyYXRvciwgY29udGV4dCk7CiAgICB9OwogIH0pOwogIC8vIEJhY2tib25lLlZpZXcKICAvLyAtLS0tLS0tLS0tLS0tCiAgLy8gQmFja2JvbmUgVmlld3MgYXJlIGFsbW9zdCBtb3JlIGNvbnZlbnRpb24gdGhhbiB0aGV5IGFyZSBhY3R1YWwgY29kZS4gQSBWaWV3CiAgLy8gaXMgc2ltcGx5IGEgSmF2YVNjcmlwdCBvYmplY3QgdGhhdCByZXByZXNlbnRzIGEgbG9naWNhbCBjaHVuayBvZiBVSSBpbiB0aGUKICAvLyBET00uIFRoaXMgbWlnaHQgYmUgYSBzaW5nbGUgaXRlbSwgYW4gZW50aXJlIGxpc3QsIGEgc2lkZWJhciBvciBwYW5lbCwgb3IKICAvLyBldmVuIHRoZSBzdXJyb3VuZGluZyBmcmFtZSB3aGljaCB3cmFwcyB5b3VyIHdob2xlIGFwcC4gRGVmaW5pbmcgYSBjaHVuayBvZgogIC8vIFVJIGFzIGEgKipWaWV3KiogYWxsb3dzIHlvdSB0byBkZWZpbmUgeW91ciBET00gZXZlbnRzIGRlY2xhcmF0aXZlbHksIHdpdGhvdXQKICAvLyBoYXZpbmcgdG8gd29ycnkgYWJvdXQgcmVuZGVyIG9yZGVyIC4uLiBhbmQgbWFrZXMgaXQgZWFzeSBmb3IgdGhlIHZpZXcgdG8KICAvLyByZWFjdCB0byBzcGVjaWZpYyBjaGFuZ2VzIGluIHRoZSBzdGF0ZSBvZiB5b3VyIG1vZGVscy4KICAvLyBDcmVhdGluZyBhIEJhY2tib25lLlZpZXcgY3JlYXRlcyBpdHMgaW5pdGlhbCBlbGVtZW50IG91dHNpZGUgb2YgdGhlIERPTSwKICAvLyBpZiBhbiBleGlzdGluZyBlbGVtZW50IGlzIG5vdCBwcm92aWRlZC4uLgogIHZhciBWaWV3ID0gQmFja2JvbmUuVmlldyA9IGZ1bmN0aW9uIChvcHRpb25zKSB7CiAgICB0aGlzLmNpZCA9IF8udW5pcXVlSWQoJ3ZpZXcnKTsKICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CiAgICBfLmV4dGVuZCh0aGlzLCBfLnBpY2sob3B0aW9ucywgdmlld09wdGlvbnMpKTsKICAgIHRoaXMuX2Vuc3VyZUVsZW1lbnQoKTsKICAgIHRoaXMuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgdGhpcy5kZWxlZ2F0ZUV2ZW50cygpOwogIH07CiAgLy8gQ2FjaGVkIHJlZ2V4IHRvIHNwbGl0IGtleXMgZm9yIGBkZWxlZ2F0ZWAuCiAgdmFyIGRlbGVnYXRlRXZlbnRTcGxpdHRlciA9IC9eKFxTKylccyooLiopJC87CiAgLy8gTGlzdCBvZiB2aWV3IG9wdGlvbnMgdG8gYmUgbWVyZ2VkIGFzIHByb3BlcnRpZXMuCiAgdmFyIHZpZXdPcHRpb25zID0gWwogICAgJ21vZGVsJywKICAgICdjb2xsZWN0aW9uJywKICAgICdlbCcsCiAgICAnaWQnLAogICAgJ2F0dHJpYnV0ZXMnLAogICAgJ2NsYXNzTmFtZScsCiAgICAndGFnTmFtZScsCiAgICAnZXZlbnRzJwogIF07CiAgLy8gU2V0IHVwIGFsbCBpbmhlcml0YWJsZSAqKkJhY2tib25lLlZpZXcqKiBwcm9wZXJ0aWVzIGFuZCBtZXRob2RzLgogIF8uZXh0ZW5kKFZpZXcucHJvdG90eXBlLCBFdmVudHMsIHsKICAgIC8vIFRoZSBkZWZhdWx0IGB0YWdOYW1lYCBvZiBhIFZpZXcncyBlbGVtZW50IGlzIGAiZGl2ImAuCiAgICB0YWdOYW1lOiAnZGl2JywKICAgIC8vIGpRdWVyeSBkZWxlZ2F0ZSBmb3IgZWxlbWVudCBsb29rdXAsIHNjb3BlZCB0byBET00gZWxlbWVudHMgd2l0aGluIHRoZQogICAgLy8gY3VycmVudCB2aWV3LiBUaGlzIHNob3VsZCBiZSBwcmVmZXJyZWQgdG8gZ2xvYmFsIGxvb2t1cHMgd2hlcmUgcG9zc2libGUuCiAgICAkOiBmdW5jdGlvbiAoc2VsZWN0b3IpIHsKICAgICAgcmV0dXJuIHRoaXMuJGVsLmZpbmQoc2VsZWN0b3IpOwogICAgfSwKICAgIC8vIEluaXRpYWxpemUgaXMgYW4gZW1wdHkgZnVuY3Rpb24gYnkgZGVmYXVsdC4gT3ZlcnJpZGUgaXQgd2l0aCB5b3VyIG93bgogICAgLy8gaW5pdGlhbGl6YXRpb24gbG9naWMuCiAgICBpbml0aWFsaXplOiBmdW5jdGlvbiAoKSB7CiAgICB9LAogICAgLy8gKipyZW5kZXIqKiBpcyB0aGUgY29yZSBmdW5jdGlvbiB0aGF0IHlvdXIgdmlldyBzaG91bGQgb3ZlcnJpZGUsIGluIG9yZGVyCiAgICAvLyB0byBwb3B1bGF0ZSBpdHMgZWxlbWVudCAoYHRoaXMuZWxgKSwgd2l0aCB0aGUgYXBwcm9wcmlhdGUgSFRNTC4gVGhlCiAgICAvLyBjb252ZW50aW9uIGlzIGZvciAqKnJlbmRlcioqIHRvIGFsd2F5cyByZXR1cm4gYHRoaXNgLgogICAgcmVuZGVyOiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAgIC8vIFJlbW92ZSB0aGlzIHZpZXcgYnkgdGFraW5nIHRoZSBlbGVtZW50IG91dCBvZiB0aGUgRE9NLCBhbmQgcmVtb3ZpbmcgYW55CiAgICAvLyBhcHBsaWNhYmxlIEJhY2tib25lLkV2ZW50cyBsaXN0ZW5lcnMuCiAgICByZW1vdmU6IGZ1bmN0aW9uICgpIHsKICAgICAgdGhpcy4kZWwucmVtb3ZlKCk7CiAgICAgIHRoaXMuc3RvcExpc3RlbmluZygpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgICAvLyBDaGFuZ2UgdGhlIHZpZXcncyBlbGVtZW50IChgdGhpcy5lbGAgcHJvcGVydHkpLCBpbmNsdWRpbmcgZXZlbnQKICAgIC8vIHJlLWRlbGVnYXRpb24uCiAgICBzZXRFbGVtZW50OiBmdW5jdGlvbiAoZWxlbWVudCwgZGVsZWdhdGUpIHsKICAgICAgaWYgKHRoaXMuJGVsKQogICAgICAgIHRoaXMudW5kZWxlZ2F0ZUV2ZW50cygpOwogICAgICB0aGlzLiRlbCA9IGVsZW1lbnQgaW5zdGFuY2VvZiBCYWNrYm9uZS4kID8gZWxlbWVudCA6IEJhY2tib25lLiQoZWxlbWVudCk7CiAgICAgIHRoaXMuZWwgPSB0aGlzLiRlbFswXTsKICAgICAgaWYgKGRlbGVnYXRlICE9PSBmYWxzZSkKICAgICAgICB0aGlzLmRlbGVnYXRlRXZlbnRzKCk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAgIC8vIFNldCBjYWxsYmFja3MsIHdoZXJlIGB0aGlzLmV2ZW50c2AgaXMgYSBoYXNoIG9mCiAgICAvLwogICAgLy8gKnsiZXZlbnQgc2VsZWN0b3IiOiAiY2FsbGJhY2sifSoKICAgIC8vCiAgICAvLyAgICAgewogICAgLy8gICAgICAgJ21vdXNlZG93biAudGl0bGUnOiAgJ2VkaXQnLAogICAgLy8gICAgICAgJ2NsaWNrIC5idXR0b24nOiAgICAgJ3NhdmUnLAogICAgLy8gICAgICAgJ2NsaWNrIC5vcGVuJzogICAgICAgZnVuY3Rpb24oZSkgeyAuLi4gfQogICAgLy8gICAgIH0KICAgIC8vCiAgICAvLyBwYWlycy4gQ2FsbGJhY2tzIHdpbGwgYmUgYm91bmQgdG8gdGhlIHZpZXcsIHdpdGggYHRoaXNgIHNldCBwcm9wZXJseS4KICAgIC8vIFVzZXMgZXZlbnQgZGVsZWdhdGlvbiBmb3IgZWZmaWNpZW5jeS4KICAgIC8vIE9taXR0aW5nIHRoZSBzZWxlY3RvciBiaW5kcyB0aGUgZXZlbnQgdG8gYHRoaXMuZWxgLgogICAgLy8gVGhpcyBvbmx5IHdvcmtzIGZvciBkZWxlZ2F0ZS1hYmxlIGV2ZW50czogbm90IGBmb2N1c2AsIGBibHVyYCwgYW5kCiAgICAvLyBub3QgYGNoYW5nZWAsIGBzdWJtaXRgLCBhbmQgYHJlc2V0YCBpbiBJbnRlcm5ldCBFeHBsb3Jlci4KICAgIGRlbGVnYXRlRXZlbnRzOiBmdW5jdGlvbiAoZXZlbnRzKSB7CiAgICAgIGlmICghKGV2ZW50cyB8fCAoZXZlbnRzID0gXy5yZXN1bHQodGhpcywgJ2V2ZW50cycpKSkpCiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgIHRoaXMudW5kZWxlZ2F0ZUV2ZW50cygpOwogICAgICBmb3IgKHZhciBrZXkgaW4gZXZlbnRzKSB7CiAgICAgICAgdmFyIG1ldGhvZCA9IGV2ZW50c1trZXldOwogICAgICAgIGlmICghXy5pc0Z1bmN0aW9uKG1ldGhvZCkpCiAgICAgICAgICBtZXRob2QgPSB0aGlzW2V2ZW50c1trZXldXTsKICAgICAgICBpZiAoIW1ldGhvZCkKICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIHZhciBtYXRjaCA9IGtleS5tYXRjaChkZWxlZ2F0ZUV2ZW50U3BsaXR0ZXIpOwogICAgICAgIHZhciBldmVudE5hbWUgPSBtYXRjaFsxXSwgc2VsZWN0b3IgPSBtYXRjaFsyXTsKICAgICAgICBtZXRob2QgPSBfLmJpbmQobWV0aG9kLCB0aGlzKTsKICAgICAgICBldmVudE5hbWUgKz0gJy5kZWxlZ2F0ZUV2ZW50cycgKyB0aGlzLmNpZDsKICAgICAgICBpZiAoc2VsZWN0b3IgPT09ICcnKSB7CiAgICAgICAgICB0aGlzLiRlbC5vbihldmVudE5hbWUsIG1ldGhvZCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXMuJGVsLm9uKGV2ZW50TmFtZSwgc2VsZWN0b3IsIG1ldGhvZCk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAgIC8vIENsZWFycyBhbGwgY2FsbGJhY2tzIHByZXZpb3VzbHkgYm91bmQgdG8gdGhlIHZpZXcgd2l0aCBgZGVsZWdhdGVFdmVudHNgLgogICAgLy8gWW91IHVzdWFsbHkgZG9uJ3QgbmVlZCB0byB1c2UgdGhpcywgYnV0IG1heSB3aXNoIHRvIGlmIHlvdSBoYXZlIG11bHRpcGxlCiAgICAvLyBCYWNrYm9uZSB2aWV3cyBhdHRhY2hlZCB0byB0aGUgc2FtZSBET00gZWxlbWVudC4KICAgIHVuZGVsZWdhdGVFdmVudHM6IGZ1bmN0aW9uICgpIHsKICAgICAgdGhpcy4kZWwub2ZmKCcuZGVsZWdhdGVFdmVudHMnICsgdGhpcy5jaWQpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgICAvLyBFbnN1cmUgdGhhdCB0aGUgVmlldyBoYXMgYSBET00gZWxlbWVudCB0byByZW5kZXIgaW50by4KICAgIC8vIElmIGB0aGlzLmVsYCBpcyBhIHN0cmluZywgcGFzcyBpdCB0aHJvdWdoIGAkKClgLCB0YWtlIHRoZSBmaXJzdAogICAgLy8gbWF0Y2hpbmcgZWxlbWVudCwgYW5kIHJlLWFzc2lnbiBpdCB0byBgZWxgLiBPdGhlcndpc2UsIGNyZWF0ZQogICAgLy8gYW4gZWxlbWVudCBmcm9tIHRoZSBgaWRgLCBgY2xhc3NOYW1lYCBhbmQgYHRhZ05hbWVgIHByb3BlcnRpZXMuCiAgICBfZW5zdXJlRWxlbWVudDogZnVuY3Rpb24gKCkgewogICAgICBpZiAoIXRoaXMuZWwpIHsKICAgICAgICB2YXIgYXR0cnMgPSBfLmV4dGVuZCh7fSwgXy5yZXN1bHQodGhpcywgJ2F0dHJpYnV0ZXMnKSk7CiAgICAgICAgaWYgKHRoaXMuaWQpCiAgICAgICAgICBhdHRycy5pZCA9IF8ucmVzdWx0KHRoaXMsICdpZCcpOwogICAgICAgIGlmICh0aGlzLmNsYXNzTmFtZSkKICAgICAgICAgIGF0dHJzWydjbGFzcyddID0gXy5yZXN1bHQodGhpcywgJ2NsYXNzTmFtZScpOwogICAgICAgIHZhciAkZWwgPSBCYWNrYm9uZS4kKCc8JyArIF8ucmVzdWx0KHRoaXMsICd0YWdOYW1lJykgKyAnPicpLmF0dHIoYXR0cnMpOwogICAgICAgIHRoaXMuc2V0RWxlbWVudCgkZWwsIGZhbHNlKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLnNldEVsZW1lbnQoXy5yZXN1bHQodGhpcywgJ2VsJyksIGZhbHNlKTsKICAgICAgfQogICAgfQogIH0pOwogIC8vIEJhY2tib25lLnN5bmMKICAvLyAtLS0tLS0tLS0tLS0tCiAgLy8gT3ZlcnJpZGUgdGhpcyBmdW5jdGlvbiB0byBjaGFuZ2UgdGhlIG1hbm5lciBpbiB3aGljaCBCYWNrYm9uZSBwZXJzaXN0cwogIC8vIG1vZGVscyB0byB0aGUgc2VydmVyLiBZb3Ugd2lsbCBiZSBwYXNzZWQgdGhlIHR5cGUgb2YgcmVxdWVzdCwgYW5kIHRoZQogIC8vIG1vZGVsIGluIHF1ZXN0aW9uLiBCeSBkZWZhdWx0LCBtYWtlcyBhIFJFU1RmdWwgQWpheCByZXF1ZXN0CiAgLy8gdG8gdGhlIG1vZGVsJ3MgYHVybCgpYC4gU29tZSBwb3NzaWJsZSBjdXN0b21pemF0aW9ucyBjb3VsZCBiZToKICAvLwogIC8vICogVXNlIGBzZXRUaW1lb3V0YCB0byBiYXRjaCByYXBpZC1maXJlIHVwZGF0ZXMgaW50byBhIHNpbmdsZSByZXF1ZXN0LgogIC8vICogU2VuZCB1cCB0aGUgbW9kZWxzIGFzIFhNTCBpbnN0ZWFkIG9mIEpTT04uCiAgLy8gKiBQZXJzaXN0IG1vZGVscyB2aWEgV2ViU29ja2V0cyBpbnN0ZWFkIG9mIEFqYXguCiAgLy8KICAvLyBUdXJuIG9uIGBCYWNrYm9uZS5lbXVsYXRlSFRUUGAgaW4gb3JkZXIgdG8gc2VuZCBgUFVUYCBhbmQgYERFTEVURWAgcmVxdWVzdHMKICAvLyBhcyBgUE9TVGAsIHdpdGggYSBgX21ldGhvZGAgcGFyYW1ldGVyIGNvbnRhaW5pbmcgdGhlIHRydWUgSFRUUCBtZXRob2QsCiAgLy8gYXMgd2VsbCBhcyBhbGwgcmVxdWVzdHMgd2l0aCB0aGUgYm9keSBhcyBgYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkYAogIC8vIGluc3RlYWQgb2YgYGFwcGxpY2F0aW9uL2pzb25gIHdpdGggdGhlIG1vZGVsIGluIGEgcGFyYW0gbmFtZWQgYG1vZGVsYC4KICAvLyBVc2VmdWwgd2hlbiBpbnRlcmZhY2luZyB3aXRoIHNlcnZlci1zaWRlIGxhbmd1YWdlcyBsaWtlICoqUEhQKiogdGhhdCBtYWtlCiAgLy8gaXQgZGlmZmljdWx0IHRvIHJlYWQgdGhlIGJvZHkgb2YgYFBVVGAgcmVxdWVzdHMuCiAgQmFja2JvbmUuc3luYyA9IGZ1bmN0aW9uIChtZXRob2QsIG1vZGVsLCBvcHRpb25zKSB7CiAgICB2YXIgdHlwZSA9IG1ldGhvZE1hcFttZXRob2RdOwogICAgLy8gRGVmYXVsdCBvcHRpb25zLCB1bmxlc3Mgc3BlY2lmaWVkLgogICAgXy5kZWZhdWx0cyhvcHRpb25zIHx8IChvcHRpb25zID0ge30pLCB7CiAgICAgIGVtdWxhdGVIVFRQOiBCYWNrYm9uZS5lbXVsYXRlSFRUUCwKICAgICAgZW11bGF0ZUpTT046IEJhY2tib25lLmVtdWxhdGVKU09OCiAgICB9KTsKICAgIC8vIERlZmF1bHQgSlNPTi1yZXF1ZXN0IG9wdGlvbnMuCiAgICB2YXIgcGFyYW1zID0gewogICAgICB0eXBlOiB0eXBlLAogICAgICBkYXRhVHlwZTogJ2pzb24nCiAgICB9OwogICAgLy8gRW5zdXJlIHRoYXQgd2UgaGF2ZSBhIFVSTC4KICAgIGlmICghb3B0aW9ucy51cmwpIHsKICAgICAgcGFyYW1zLnVybCA9IF8ucmVzdWx0KG1vZGVsLCAndXJsJykgfHwgdXJsRXJyb3IoKTsKICAgIH0KICAgIC8vIEVuc3VyZSB0aGF0IHdlIGhhdmUgdGhlIGFwcHJvcHJpYXRlIHJlcXVlc3QgZGF0YS4KICAgIGlmIChvcHRpb25zLmRhdGEgPT0gbnVsbCAmJiBtb2RlbCAmJiAobWV0aG9kID09PSAnY3JlYXRlJyB8fCBtZXRob2QgPT09ICd1cGRhdGUnIHx8IG1ldGhvZCA9PT0gJ3BhdGNoJykpIHsKICAgICAgcGFyYW1zLmNvbnRlbnRUeXBlID0gJ2FwcGxpY2F0aW9uL2pzb24nOwogICAgICBwYXJhbXMuZGF0YSA9IEpTT04uc3RyaW5naWZ5KG9wdGlvbnMuYXR0cnMgfHwgbW9kZWwudG9KU09OKG9wdGlvbnMpKTsKICAgIH0KICAgIC8vIEZvciBvbGRlciBzZXJ2ZXJzLCBlbXVsYXRlIEpTT04gYnkgZW5jb2RpbmcgdGhlIHJlcXVlc3QgaW50byBhbiBIVE1MLWZvcm0uCiAgICBpZiAob3B0aW9ucy5lbXVsYXRlSlNPTikgewogICAgICBwYXJhbXMuY29udGVudFR5cGUgPSAnYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkJzsKICAgICAgcGFyYW1zLmRhdGEgPSBwYXJhbXMuZGF0YSA/IHsgbW9kZWw6IHBhcmFtcy5kYXRhIH0gOiB7fTsKICAgIH0KICAgIC8vIEZvciBvbGRlciBzZXJ2ZXJzLCBlbXVsYXRlIEhUVFAgYnkgbWltaWNraW5nIHRoZSBIVFRQIG1ldGhvZCB3aXRoIGBfbWV0aG9kYAogICAgLy8gQW5kIGFuIGBYLUhUVFAtTWV0aG9kLU92ZXJyaWRlYCBoZWFkZXIuCiAgICBpZiAob3B0aW9ucy5lbXVsYXRlSFRUUCAmJiAodHlwZSA9PT0gJ1BVVCcgfHwgdHlwZSA9PT0gJ0RFTEVURScgfHwgdHlwZSA9PT0gJ1BBVENIJykpIHsKICAgICAgcGFyYW1zLnR5cGUgPSAnUE9TVCc7CiAgICAgIGlmIChvcHRpb25zLmVtdWxhdGVKU09OKQogICAgICAgIHBhcmFtcy5kYXRhLl9tZXRob2QgPSB0eXBlOwogICAgICB2YXIgYmVmb3JlU2VuZCA9IG9wdGlvbnMuYmVmb3JlU2VuZDsKICAgICAgb3B0aW9ucy5iZWZvcmVTZW5kID0gZnVuY3Rpb24gKHhocikgewogICAgICAgIHhoci5zZXRSZXF1ZXN0SGVhZGVyKCdYLUhUVFAtTWV0aG9kLU92ZXJyaWRlJywgdHlwZSk7CiAgICAgICAgaWYgKGJlZm9yZVNlbmQpCiAgICAgICAgICByZXR1cm4gYmVmb3JlU2VuZC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9OwogICAgfQogICAgLy8gRG9uJ3QgcHJvY2VzcyBkYXRhIG9uIGEgbm9uLUdFVCByZXF1ZXN0LgogICAgaWYgKHBhcmFtcy50eXBlICE9PSAnR0VUJyAmJiAhb3B0aW9ucy5lbXVsYXRlSlNPTikgewogICAgICBwYXJhbXMucHJvY2Vzc0RhdGEgPSBmYWxzZTsKICAgIH0KICAgIC8vIElmIHdlJ3JlIHNlbmRpbmcgYSBgUEFUQ0hgIHJlcXVlc3QsIGFuZCB3ZSdyZSBpbiBhbiBvbGQgSW50ZXJuZXQgRXhwbG9yZXIKICAgIC8vIHRoYXQgc3RpbGwgaGFzIEFjdGl2ZVggZW5hYmxlZCBieSBkZWZhdWx0LCBvdmVycmlkZSBqUXVlcnkgdG8gdXNlIHRoYXQKICAgIC8vIGZvciBYSFIgaW5zdGVhZC4gUmVtb3ZlIHRoaXMgbGluZSB3aGVuIGpRdWVyeSBzdXBwb3J0cyBgUEFUQ0hgIG9uIElFOC4KICAgIGlmIChwYXJhbXMudHlwZSA9PT0gJ1BBVENIJyAmJiBub1hoclBhdGNoKSB7CiAgICAgIHBhcmFtcy54aHIgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIG5ldyBBY3RpdmVYT2JqZWN0KCdNaWNyb3NvZnQuWE1MSFRUUCcpOwogICAgICB9OwogICAgfQogICAgLy8gTWFrZSB0aGUgcmVxdWVzdCwgYWxsb3dpbmcgdGhlIHVzZXIgdG8gb3ZlcnJpZGUgYW55IEFqYXggb3B0aW9ucy4KICAgIHZhciB4aHIgPSBvcHRpb25zLnhociA9IEJhY2tib25lLmFqYXgoXy5leHRlbmQocGFyYW1zLCBvcHRpb25zKSk7CiAgICBtb2RlbC50cmlnZ2VyKCdyZXF1ZXN0JywgbW9kZWwsIHhociwgb3B0aW9ucyk7CiAgICByZXR1cm4geGhyOwogIH07CiAgdmFyIG5vWGhyUGF0Y2ggPSB0eXBlb2Ygd2luZG93ICE9PSAndW5kZWZpbmVkJyAmJiAhIXdpbmRvdy5BY3RpdmVYT2JqZWN0ICYmICEod2luZG93LlhNTEh0dHBSZXF1ZXN0ICYmIG5ldyBYTUxIdHRwUmVxdWVzdCgpLmRpc3BhdGNoRXZlbnQpOwogIC8vIE1hcCBmcm9tIENSVUQgdG8gSFRUUCBmb3Igb3VyIGRlZmF1bHQgYEJhY2tib25lLnN5bmNgIGltcGxlbWVudGF0aW9uLgogIHZhciBtZXRob2RNYXAgPSB7CiAgICAnY3JlYXRlJzogJ1BPU1QnLAogICAgJ3VwZGF0ZSc6ICdQVVQnLAogICAgJ3BhdGNoJzogJ1BBVENIJywKICAgICdkZWxldGUnOiAnREVMRVRFJywKICAgICdyZWFkJzogJ0dFVCcKICB9OwogIC8vIFNldCB0aGUgZGVmYXVsdCBpbXBsZW1lbnRhdGlvbiBvZiBgQmFja2JvbmUuYWpheGAgdG8gcHJveHkgdGhyb3VnaCB0byBgJGAuCiAgLy8gT3ZlcnJpZGUgdGhpcyBpZiB5b3UnZCBsaWtlIHRvIHVzZSBhIGRpZmZlcmVudCBsaWJyYXJ5LgogIEJhY2tib25lLmFqYXggPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gQmFja2JvbmUuJC5hamF4LmFwcGx5KEJhY2tib25lLiQsIGFyZ3VtZW50cyk7CiAgfTsKICAvLyBCYWNrYm9uZS5Sb3V0ZXIKICAvLyAtLS0tLS0tLS0tLS0tLS0KICAvLyBSb3V0ZXJzIG1hcCBmYXV4LVVSTHMgdG8gYWN0aW9ucywgYW5kIGZpcmUgZXZlbnRzIHdoZW4gcm91dGVzIGFyZQogIC8vIG1hdGNoZWQuIENyZWF0aW5nIGEgbmV3IG9uZSBzZXRzIGl0cyBgcm91dGVzYCBoYXNoLCBpZiBub3Qgc2V0IHN0YXRpY2FsbHkuCiAgdmFyIFJvdXRlciA9IEJhY2tib25lLlJvdXRlciA9IGZ1bmN0aW9uIChvcHRpb25zKSB7CiAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwogICAgaWYgKG9wdGlvbnMucm91dGVzKQogICAgICB0aGlzLnJvdXRlcyA9IG9wdGlvbnMucm91dGVzOwogICAgdGhpcy5fYmluZFJvdXRlcygpOwogICAgdGhpcy5pbml0aWFsaXplLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgfTsKICAvLyBDYWNoZWQgcmVndWxhciBleHByZXNzaW9ucyBmb3IgbWF0Y2hpbmcgbmFtZWQgcGFyYW0gcGFydHMgYW5kIHNwbGF0dGVkCiAgLy8gcGFydHMgb2Ygcm91dGUgc3RyaW5ncy4KICB2YXIgb3B0aW9uYWxQYXJhbSA9IC9cKCguKj8pXCkvZzsKICB2YXIgbmFtZWRQYXJhbSA9IC8oXChcPyk/Olx3Ky9nOwogIHZhciBzcGxhdFBhcmFtID0gL1wqXHcrL2c7CiAgdmFyIGVzY2FwZVJlZ0V4cCA9IC9bXC17fVxbXF0rPy4sXFxcXiR8I1xzXS9nOwogIC8vIFNldCB1cCBhbGwgaW5oZXJpdGFibGUgKipCYWNrYm9uZS5Sb3V0ZXIqKiBwcm9wZXJ0aWVzIGFuZCBtZXRob2RzLgogIF8uZXh0ZW5kKFJvdXRlci5wcm90b3R5cGUsIEV2ZW50cywgewogICAgLy8gSW5pdGlhbGl6ZSBpcyBhbiBlbXB0eSBmdW5jdGlvbiBieSBkZWZhdWx0LiBPdmVycmlkZSBpdCB3aXRoIHlvdXIgb3duCiAgICAvLyBpbml0aWFsaXphdGlvbiBsb2dpYy4KICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uICgpIHsKICAgIH0sCiAgICAvLyBNYW51YWxseSBiaW5kIGEgc2luZ2xlIG5hbWVkIHJvdXRlIHRvIGEgY2FsbGJhY2suIEZvciBleGFtcGxlOgogICAgLy8KICAgIC8vICAgICB0aGlzLnJvdXRlKCdzZWFyY2gvOnF1ZXJ5L3A6bnVtJywgJ3NlYXJjaCcsIGZ1bmN0aW9uKHF1ZXJ5LCBudW0pIHsKICAgIC8vICAgICAgIC4uLgogICAgLy8gICAgIH0pOwogICAgLy8KICAgIHJvdXRlOiBmdW5jdGlvbiAocm91dGUsIG5hbWUsIGNhbGxiYWNrKSB7CiAgICAgIGlmICghXy5pc1JlZ0V4cChyb3V0ZSkpCiAgICAgICAgcm91dGUgPSB0aGlzLl9yb3V0ZVRvUmVnRXhwKHJvdXRlKTsKICAgICAgaWYgKF8uaXNGdW5jdGlvbihuYW1lKSkgewogICAgICAgIGNhbGxiYWNrID0gbmFtZTsKICAgICAgICBuYW1lID0gJyc7CiAgICAgIH0KICAgICAgaWYgKCFjYWxsYmFjaykKICAgICAgICBjYWxsYmFjayA9IHRoaXNbbmFtZV07CiAgICAgIHZhciByb3V0ZXIgPSB0aGlzOwogICAgICBCYWNrYm9uZS5oaXN0b3J5LnJvdXRlKHJvdXRlLCBmdW5jdGlvbiAoZnJhZ21lbnQpIHsKICAgICAgICB2YXIgYXJncyA9IHJvdXRlci5fZXh0cmFjdFBhcmFtZXRlcnMocm91dGUsIGZyYWdtZW50KTsKICAgICAgICByb3V0ZXIuZXhlY3V0ZShjYWxsYmFjaywgYXJncyk7CiAgICAgICAgcm91dGVyLnRyaWdnZXIuYXBwbHkocm91dGVyLCBbJ3JvdXRlOicgKyBuYW1lXS5jb25jYXQoYXJncykpOwogICAgICAgIHJvdXRlci50cmlnZ2VyKCdyb3V0ZScsIG5hbWUsIGFyZ3MpOwogICAgICAgIEJhY2tib25lLmhpc3RvcnkudHJpZ2dlcigncm91dGUnLCByb3V0ZXIsIG5hbWUsIGFyZ3MpOwogICAgICB9KTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogICAgLy8gRXhlY3V0ZSBhIHJvdXRlIGhhbmRsZXIgd2l0aCB0aGUgcHJvdmlkZWQgcGFyYW1ldGVycy4gIFRoaXMgaXMgYW4KICAgIC8vIGV4Y2VsbGVudCBwbGFjZSB0byBkbyBwcmUtcm91dGUgc2V0dXAgb3IgcG9zdC1yb3V0ZSBjbGVhbnVwLgogICAgZXhlY3V0ZTogZnVuY3Rpb24gKGNhbGxiYWNrLCBhcmdzKSB7CiAgICAgIGlmIChjYWxsYmFjaykKICAgICAgICBjYWxsYmFjay5hcHBseSh0aGlzLCBhcmdzKTsKICAgIH0sCiAgICAvLyBTaW1wbGUgcHJveHkgdG8gYEJhY2tib25lLmhpc3RvcnlgIHRvIHNhdmUgYSBmcmFnbWVudCBpbnRvIHRoZSBoaXN0b3J5LgogICAgbmF2aWdhdGU6IGZ1bmN0aW9uIChmcmFnbWVudCwgb3B0aW9ucykgewogICAgICBCYWNrYm9uZS5oaXN0b3J5Lm5hdmlnYXRlKGZyYWdtZW50LCBvcHRpb25zKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogICAgLy8gQmluZCBhbGwgZGVmaW5lZCByb3V0ZXMgdG8gYEJhY2tib25lLmhpc3RvcnlgLiBXZSBoYXZlIHRvIHJldmVyc2UgdGhlCiAgICAvLyBvcmRlciBvZiB0aGUgcm91dGVzIGhlcmUgdG8gc3VwcG9ydCBiZWhhdmlvciB3aGVyZSB0aGUgbW9zdCBnZW5lcmFsCiAgICAvLyByb3V0ZXMgY2FuIGJlIGRlZmluZWQgYXQgdGhlIGJvdHRvbSBvZiB0aGUgcm91dGUgbWFwLgogICAgX2JpbmRSb3V0ZXM6IGZ1bmN0aW9uICgpIHsKICAgICAgaWYgKCF0aGlzLnJvdXRlcykKICAgICAgICByZXR1cm47CiAgICAgIHRoaXMucm91dGVzID0gXy5yZXN1bHQodGhpcywgJ3JvdXRlcycpOwogICAgICB2YXIgcm91dGUsIHJvdXRlcyA9IF8ua2V5cyh0aGlzLnJvdXRlcyk7CiAgICAgIHdoaWxlICgocm91dGUgPSByb3V0ZXMucG9wKCkpICE9IG51bGwpIHsKICAgICAgICB0aGlzLnJvdXRlKHJvdXRlLCB0aGlzLnJvdXRlc1tyb3V0ZV0pOwogICAgICB9CiAgICB9LAogICAgLy8gQ29udmVydCBhIHJvdXRlIHN0cmluZyBpbnRvIGEgcmVndWxhciBleHByZXNzaW9uLCBzdWl0YWJsZSBmb3IgbWF0Y2hpbmcKICAgIC8vIGFnYWluc3QgdGhlIGN1cnJlbnQgbG9jYXRpb24gaGFzaC4KICAgIF9yb3V0ZVRvUmVnRXhwOiBmdW5jdGlvbiAocm91dGUpIHsKICAgICAgcm91dGUgPSByb3V0ZS5yZXBsYWNlKGVzY2FwZVJlZ0V4cCwgJ1xcJCYnKS5yZXBsYWNlKG9wdGlvbmFsUGFyYW0sICcoPzokMSk/JykucmVwbGFjZShuYW1lZFBhcmFtLCBmdW5jdGlvbiAobWF0Y2gsIG9wdGlvbmFsKSB7CiAgICAgICAgcmV0dXJuIG9wdGlvbmFsID8gbWF0Y2ggOiAnKFteLz9dKyknOwogICAgICB9KS5yZXBsYWNlKHNwbGF0UGFyYW0sICcoW14/XSo/KScpOwogICAgICByZXR1cm4gbmV3IFJlZ0V4cCgnXicgKyByb3V0ZSArICcoPzpcXD8oW1xcc1xcU10qKSk/JCcpOwogICAgfSwKICAgIC8vIEdpdmVuIGEgcm91dGUsIGFuZCBhIFVSTCBmcmFnbWVudCB0aGF0IGl0IG1hdGNoZXMsIHJldHVybiB0aGUgYXJyYXkgb2YKICAgIC8vIGV4dHJhY3RlZCBkZWNvZGVkIHBhcmFtZXRlcnMuIEVtcHR5IG9yIHVubWF0Y2hlZCBwYXJhbWV0ZXJzIHdpbGwgYmUKICAgIC8vIHRyZWF0ZWQgYXMgYG51bGxgIHRvIG5vcm1hbGl6ZSBjcm9zcy1icm93c2VyIGJlaGF2aW9yLgogICAgX2V4dHJhY3RQYXJhbWV0ZXJzOiBmdW5jdGlvbiAocm91dGUsIGZyYWdtZW50KSB7CiAgICAgIHZhciBwYXJhbXMgPSByb3V0ZS5leGVjKGZyYWdtZW50KS5zbGljZSgxKTsKICAgICAgcmV0dXJuIF8ubWFwKHBhcmFtcywgZnVuY3Rpb24gKHBhcmFtLCBpKSB7CiAgICAgICAgLy8gRG9uJ3QgZGVjb2RlIHRoZSBzZWFyY2ggcGFyYW1zLgogICAgICAgIGlmIChpID09PSBwYXJhbXMubGVuZ3RoIC0gMSkKICAgICAgICAgIHJldHVybiBwYXJhbSB8fCBudWxsOwogICAgICAgIHJldHVybiBwYXJhbSA/IGRlY29kZVVSSUNvbXBvbmVudChwYXJhbSkgOiBudWxsOwogICAgICB9KTsKICAgIH0KICB9KTsKICAvLyBCYWNrYm9uZS5IaXN0b3J5CiAgLy8gLS0tLS0tLS0tLS0tLS0tLQogIC8vIEhhbmRsZXMgY3Jvc3MtYnJvd3NlciBoaXN0b3J5IG1hbmFnZW1lbnQsIGJhc2VkIG9uIGVpdGhlcgogIC8vIFtwdXNoU3RhdGVdKGh0dHA6Ly9kaXZlaW50b2h0bWw1LmluZm8vaGlzdG9yeS5odG1sKSBhbmQgcmVhbCBVUkxzLCBvcgogIC8vIFtvbmhhc2hjaGFuZ2VdKGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvRE9NL3dpbmRvdy5vbmhhc2hjaGFuZ2UpCiAgLy8gYW5kIFVSTCBmcmFnbWVudHMuIElmIHRoZSBicm93c2VyIHN1cHBvcnRzIG5laXRoZXIgKG9sZCBJRSwgbmF0Y2gpLAogIC8vIGZhbGxzIGJhY2sgdG8gcG9sbGluZy4KICB2YXIgSGlzdG9yeSA9IEJhY2tib25lLkhpc3RvcnkgPSBmdW5jdGlvbiAoKSB7CiAgICB0aGlzLmhhbmRsZXJzID0gW107CiAgICBfLmJpbmRBbGwodGhpcywgJ2NoZWNrVXJsJyk7CiAgICAvLyBFbnN1cmUgdGhhdCBgSGlzdG9yeWAgY2FuIGJlIHVzZWQgb3V0c2lkZSBvZiB0aGUgYnJvd3Nlci4KICAgIGlmICh0eXBlb2Ygd2luZG93ICE9PSAndW5kZWZpbmVkJykgewogICAgICB0aGlzLmxvY2F0aW9uID0gd2luZG93LmxvY2F0aW9uOwogICAgICB0aGlzLmhpc3RvcnkgPSB3aW5kb3cuaGlzdG9yeTsKICAgIH0KICB9OwogIC8vIENhY2hlZCByZWdleCBmb3Igc3RyaXBwaW5nIGEgbGVhZGluZyBoYXNoL3NsYXNoIGFuZCB0cmFpbGluZyBzcGFjZS4KICB2YXIgcm91dGVTdHJpcHBlciA9IC9eWyNcL118XHMrJC9nOwogIC8vIENhY2hlZCByZWdleCBmb3Igc3RyaXBwaW5nIGxlYWRpbmcgYW5kIHRyYWlsaW5nIHNsYXNoZXMuCiAgdmFyIHJvb3RTdHJpcHBlciA9IC9eXC8rfFwvKyQvZzsKICAvLyBDYWNoZWQgcmVnZXggZm9yIGRldGVjdGluZyBNU0lFLgogIHZhciBpc0V4cGxvcmVyID0gL21zaWUgW1x3Ll0rLzsKICAvLyBDYWNoZWQgcmVnZXggZm9yIHJlbW92aW5nIGEgdHJhaWxpbmcgc2xhc2guCiAgdmFyIHRyYWlsaW5nU2xhc2ggPSAvXC8kLzsKICAvLyBDYWNoZWQgcmVnZXggZm9yIHN0cmlwcGluZyB1cmxzIG9mIGhhc2guCiAgdmFyIHBhdGhTdHJpcHBlciA9IC8jLiokLzsKICAvLyBIYXMgdGhlIGhpc3RvcnkgaGFuZGxpbmcgYWxyZWFkeSBiZWVuIHN0YXJ0ZWQ/CiAgSGlzdG9yeS5zdGFydGVkID0gZmFsc2U7CiAgLy8gU2V0IHVwIGFsbCBpbmhlcml0YWJsZSAqKkJhY2tib25lLkhpc3RvcnkqKiBwcm9wZXJ0aWVzIGFuZCBtZXRob2RzLgogIF8uZXh0ZW5kKEhpc3RvcnkucHJvdG90eXBlLCBFdmVudHMsIHsKICAgIC8vIFRoZSBkZWZhdWx0IGludGVydmFsIHRvIHBvbGwgZm9yIGhhc2ggY2hhbmdlcywgaWYgbmVjZXNzYXJ5LCBpcwogICAgLy8gdHdlbnR5IHRpbWVzIGEgc2Vjb25kLgogICAgaW50ZXJ2YWw6IDUwLAogICAgLy8gQXJlIHdlIGF0IHRoZSBhcHAgcm9vdD8KICAgIGF0Um9vdDogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gdGhpcy5sb2NhdGlvbi5wYXRobmFtZS5yZXBsYWNlKC9bXlwvXSQvLCAnJCYvJykgPT09IHRoaXMucm9vdDsKICAgIH0sCiAgICAvLyBHZXRzIHRoZSB0cnVlIGhhc2ggdmFsdWUuIENhbm5vdCB1c2UgbG9jYXRpb24uaGFzaCBkaXJlY3RseSBkdWUgdG8gYnVnCiAgICAvLyBpbiBGaXJlZm94IHdoZXJlIGxvY2F0aW9uLmhhc2ggd2lsbCBhbHdheXMgYmUgZGVjb2RlZC4KICAgIGdldEhhc2g6IGZ1bmN0aW9uICh3aW5kb3cpIHsKICAgICAgdmFyIG1hdGNoID0gKHdpbmRvdyB8fCB0aGlzKS5sb2NhdGlvbi5ocmVmLm1hdGNoKC8jKC4qKSQvKTsKICAgICAgcmV0dXJuIG1hdGNoID8gbWF0Y2hbMV0gOiAnJzsKICAgIH0sCiAgICAvLyBHZXQgdGhlIGNyb3NzLWJyb3dzZXIgbm9ybWFsaXplZCBVUkwgZnJhZ21lbnQsIGVpdGhlciBmcm9tIHRoZSBVUkwsCiAgICAvLyB0aGUgaGFzaCwgb3IgdGhlIG92ZXJyaWRlLgogICAgZ2V0RnJhZ21lbnQ6IGZ1bmN0aW9uIChmcmFnbWVudCwgZm9yY2VQdXNoU3RhdGUpIHsKICAgICAgaWYgKGZyYWdtZW50ID09IG51bGwpIHsKICAgICAgICBpZiAodGhpcy5faGFzUHVzaFN0YXRlIHx8ICF0aGlzLl93YW50c0hhc2hDaGFuZ2UgfHwgZm9yY2VQdXNoU3RhdGUpIHsKICAgICAgICAgIGZyYWdtZW50ID0gZGVjb2RlVVJJKHRoaXMubG9jYXRpb24ucGF0aG5hbWUgKyB0aGlzLmxvY2F0aW9uLnNlYXJjaCk7CiAgICAgICAgICB2YXIgcm9vdCA9IHRoaXMucm9vdC5yZXBsYWNlKHRyYWlsaW5nU2xhc2gsICcnKTsKICAgICAgICAgIGlmICghZnJhZ21lbnQuaW5kZXhPZihyb290KSkKICAgICAgICAgICAgZnJhZ21lbnQgPSBmcmFnbWVudC5zbGljZShyb290Lmxlbmd0aCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGZyYWdtZW50ID0gdGhpcy5nZXRIYXNoKCk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBmcmFnbWVudC5yZXBsYWNlKHJvdXRlU3RyaXBwZXIsICcnKTsKICAgIH0sCiAgICAvLyBTdGFydCB0aGUgaGFzaCBjaGFuZ2UgaGFuZGxpbmcsIHJldHVybmluZyBgdHJ1ZWAgaWYgdGhlIGN1cnJlbnQgVVJMIG1hdGNoZXMKICAgIC8vIGFuIGV4aXN0aW5nIHJvdXRlLCBhbmQgYGZhbHNlYCBvdGhlcndpc2UuCiAgICBzdGFydDogZnVuY3Rpb24gKG9wdGlvbnMpIHsKICAgICAgaWYgKEhpc3Rvcnkuc3RhcnRlZCkKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0JhY2tib25lLmhpc3RvcnkgaGFzIGFscmVhZHkgYmVlbiBzdGFydGVkJyk7CiAgICAgIEhpc3Rvcnkuc3RhcnRlZCA9IHRydWU7CiAgICAgIC8vIEZpZ3VyZSBvdXQgdGhlIGluaXRpYWwgY29uZmlndXJhdGlvbi4gRG8gd2UgbmVlZCBhbiBpZnJhbWU/CiAgICAgIC8vIElzIHB1c2hTdGF0ZSBkZXNpcmVkIC4uLiBpcyBpdCBhdmFpbGFibGU/CiAgICAgIHRoaXMub3B0aW9ucyA9IF8uZXh0ZW5kKHsgcm9vdDogJy8nIH0sIHRoaXMub3B0aW9ucywgb3B0aW9ucyk7CiAgICAgIHRoaXMucm9vdCA9IHRoaXMub3B0aW9ucy5yb290OwogICAgICB0aGlzLl93YW50c0hhc2hDaGFuZ2UgPSB0aGlzLm9wdGlvbnMuaGFzaENoYW5nZSAhPT0gZmFsc2U7CiAgICAgIHRoaXMuX3dhbnRzUHVzaFN0YXRlID0gISF0aGlzLm9wdGlvbnMucHVzaFN0YXRlOwogICAgICB0aGlzLl9oYXNQdXNoU3RhdGUgPSAhISh0aGlzLm9wdGlvbnMucHVzaFN0YXRlICYmIHRoaXMuaGlzdG9yeSAmJiB0aGlzLmhpc3RvcnkucHVzaFN0YXRlKTsKICAgICAgdmFyIGZyYWdtZW50ID0gdGhpcy5nZXRGcmFnbWVudCgpOwogICAgICB2YXIgZG9jTW9kZSA9IGRvY3VtZW50LmRvY3VtZW50TW9kZTsKICAgICAgdmFyIG9sZElFID0gaXNFeHBsb3Jlci5leGVjKG5hdmlnYXRvci51c2VyQWdlbnQudG9Mb3dlckNhc2UoKSkgJiYgKCFkb2NNb2RlIHx8IGRvY01vZGUgPD0gNyk7CiAgICAgIC8vIE5vcm1hbGl6ZSByb290IHRvIGFsd2F5cyBpbmNsdWRlIGEgbGVhZGluZyBhbmQgdHJhaWxpbmcgc2xhc2guCiAgICAgIHRoaXMucm9vdCA9ICgnLycgKyB0aGlzLnJvb3QgKyAnLycpLnJlcGxhY2Uocm9vdFN0cmlwcGVyLCAnLycpOwogICAgICBpZiAob2xkSUUgJiYgdGhpcy5fd2FudHNIYXNoQ2hhbmdlKSB7CiAgICAgICAgdmFyIGZyYW1lID0gQmFja2JvbmUuJCgnPGlmcmFtZSBzcmM9ImphdmFzY3JpcHQ6MCIgdGFiaW5kZXg9Ii0xIj4nKTsKICAgICAgICB0aGlzLmlmcmFtZSA9IGZyYW1lLmhpZGUoKS5hcHBlbmRUbygnYm9keScpWzBdLmNvbnRlbnRXaW5kb3c7CiAgICAgICAgdGhpcy5uYXZpZ2F0ZShmcmFnbWVudCk7CiAgICAgIH0KICAgICAgLy8gRGVwZW5kaW5nIG9uIHdoZXRoZXIgd2UncmUgdXNpbmcgcHVzaFN0YXRlIG9yIGhhc2hlcywgYW5kIHdoZXRoZXIKICAgICAgLy8gJ29uaGFzaGNoYW5nZScgaXMgc3VwcG9ydGVkLCBkZXRlcm1pbmUgaG93IHdlIGNoZWNrIHRoZSBVUkwgc3RhdGUuCiAgICAgIGlmICh0aGlzLl9oYXNQdXNoU3RhdGUpIHsKICAgICAgICBCYWNrYm9uZS4kKHdpbmRvdykub24oJ3BvcHN0YXRlJywgdGhpcy5jaGVja1VybCk7CiAgICAgIH0gZWxzZSBpZiAodGhpcy5fd2FudHNIYXNoQ2hhbmdlICYmICdvbmhhc2hjaGFuZ2UnIGluIHdpbmRvdyAmJiAhb2xkSUUpIHsKICAgICAgICBCYWNrYm9uZS4kKHdpbmRvdykub24oJ2hhc2hjaGFuZ2UnLCB0aGlzLmNoZWNrVXJsKTsKICAgICAgfSBlbHNlIGlmICh0aGlzLl93YW50c0hhc2hDaGFuZ2UpIHsKICAgICAgICB0aGlzLl9jaGVja1VybEludGVydmFsID0gc2V0SW50ZXJ2YWwodGhpcy5jaGVja1VybCwgdGhpcy5pbnRlcnZhbCk7CiAgICAgIH0KICAgICAgLy8gRGV0ZXJtaW5lIGlmIHdlIG5lZWQgdG8gY2hhbmdlIHRoZSBiYXNlIHVybCwgZm9yIGEgcHVzaFN0YXRlIGxpbmsKICAgICAgLy8gb3BlbmVkIGJ5IGEgbm9uLXB1c2hTdGF0ZSBicm93c2VyLgogICAgICB0aGlzLmZyYWdtZW50ID0gZnJhZ21lbnQ7CiAgICAgIHZhciBsb2MgPSB0aGlzLmxvY2F0aW9uOwogICAgICAvLyBUcmFuc2l0aW9uIGZyb20gaGFzaENoYW5nZSB0byBwdXNoU3RhdGUgb3IgdmljZSB2ZXJzYSBpZiBib3RoIGFyZQogICAgICAvLyByZXF1ZXN0ZWQuCiAgICAgIGlmICh0aGlzLl93YW50c0hhc2hDaGFuZ2UgJiYgdGhpcy5fd2FudHNQdXNoU3RhdGUpIHsKICAgICAgICAvLyBJZiB3ZSd2ZSBzdGFydGVkIG9mZiB3aXRoIGEgcm91dGUgZnJvbSBhIGBwdXNoU3RhdGVgLWVuYWJsZWQKICAgICAgICAvLyBicm93c2VyLCBidXQgd2UncmUgY3VycmVudGx5IGluIGEgYnJvd3NlciB0aGF0IGRvZXNuJ3Qgc3VwcG9ydCBpdC4uLgogICAgICAgIGlmICghdGhpcy5faGFzUHVzaFN0YXRlICYmICF0aGlzLmF0Um9vdCgpKSB7CiAgICAgICAgICB0aGlzLmZyYWdtZW50ID0gdGhpcy5nZXRGcmFnbWVudChudWxsLCB0cnVlKTsKICAgICAgICAgIHRoaXMubG9jYXRpb24ucmVwbGFjZSh0aGlzLnJvb3QgKyAnIycgKyB0aGlzLmZyYWdtZW50KTsKICAgICAgICAgIC8vIFJldHVybiBpbW1lZGlhdGVseSBhcyBicm93c2VyIHdpbGwgZG8gcmVkaXJlY3QgdG8gbmV3IHVybAogICAgICAgICAgcmV0dXJuIHRydWU7ICAvLyBPciBpZiB3ZSd2ZSBzdGFydGVkIG91dCB3aXRoIGEgaGFzaC1iYXNlZCByb3V0ZSwgYnV0IHdlJ3JlIGN1cnJlbnRseQogICAgICAgICAgICAgICAgICAgICAgICAvLyBpbiBhIGJyb3dzZXIgd2hlcmUgaXQgY291bGQgYmUgYHB1c2hTdGF0ZWAtYmFzZWQgaW5zdGVhZC4uLgogICAgICAgIH0gZWxzZSBpZiAodGhpcy5faGFzUHVzaFN0YXRlICYmIHRoaXMuYXRSb290KCkgJiYgbG9jLmhhc2gpIHsKICAgICAgICAgIHRoaXMuZnJhZ21lbnQgPSB0aGlzLmdldEhhc2goKS5yZXBsYWNlKHJvdXRlU3RyaXBwZXIsICcnKTsKICAgICAgICAgIHRoaXMuaGlzdG9yeS5yZXBsYWNlU3RhdGUoe30sIGRvY3VtZW50LnRpdGxlLCB0aGlzLnJvb3QgKyB0aGlzLmZyYWdtZW50KTsKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKCF0aGlzLm9wdGlvbnMuc2lsZW50KQogICAgICAgIHJldHVybiB0aGlzLmxvYWRVcmwoKTsKICAgIH0sCiAgICAvLyBEaXNhYmxlIEJhY2tib25lLmhpc3RvcnksIHBlcmhhcHMgdGVtcG9yYXJpbHkuIE5vdCB1c2VmdWwgaW4gYSByZWFsIGFwcCwKICAgIC8vIGJ1dCBwb3NzaWJseSB1c2VmdWwgZm9yIHVuaXQgdGVzdGluZyBSb3V0ZXJzLgogICAgc3RvcDogZnVuY3Rpb24gKCkgewogICAgICBCYWNrYm9uZS4kKHdpbmRvdykub2ZmKCdwb3BzdGF0ZScsIHRoaXMuY2hlY2tVcmwpLm9mZignaGFzaGNoYW5nZScsIHRoaXMuY2hlY2tVcmwpOwogICAgICBpZiAodGhpcy5fY2hlY2tVcmxJbnRlcnZhbCkKICAgICAgICBjbGVhckludGVydmFsKHRoaXMuX2NoZWNrVXJsSW50ZXJ2YWwpOwogICAgICBIaXN0b3J5LnN0YXJ0ZWQgPSBmYWxzZTsKICAgIH0sCiAgICAvLyBBZGQgYSByb3V0ZSB0byBiZSB0ZXN0ZWQgd2hlbiB0aGUgZnJhZ21lbnQgY2hhbmdlcy4gUm91dGVzIGFkZGVkIGxhdGVyCiAgICAvLyBtYXkgb3ZlcnJpZGUgcHJldmlvdXMgcm91dGVzLgogICAgcm91dGU6IGZ1bmN0aW9uIChyb3V0ZSwgY2FsbGJhY2spIHsKICAgICAgdGhpcy5oYW5kbGVycy51bnNoaWZ0KHsKICAgICAgICByb3V0ZTogcm91dGUsCiAgICAgICAgY2FsbGJhY2s6IGNhbGxiYWNrCiAgICAgIH0pOwogICAgfSwKICAgIC8vIENoZWNrcyB0aGUgY3VycmVudCBVUkwgdG8gc2VlIGlmIGl0IGhhcyBjaGFuZ2VkLCBhbmQgaWYgaXQgaGFzLAogICAgLy8gY2FsbHMgYGxvYWRVcmxgLCBub3JtYWxpemluZyBhY3Jvc3MgdGhlIGhpZGRlbiBpZnJhbWUuCiAgICBjaGVja1VybDogZnVuY3Rpb24gKGUpIHsKICAgICAgdmFyIGN1cnJlbnQgPSB0aGlzLmdldEZyYWdtZW50KCk7CiAgICAgIGlmIChjdXJyZW50ID09PSB0aGlzLmZyYWdtZW50ICYmIHRoaXMuaWZyYW1lKSB7CiAgICAgICAgY3VycmVudCA9IHRoaXMuZ2V0RnJhZ21lbnQodGhpcy5nZXRIYXNoKHRoaXMuaWZyYW1lKSk7CiAgICAgIH0KICAgICAgaWYgKGN1cnJlbnQgPT09IHRoaXMuZnJhZ21lbnQpCiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICBpZiAodGhpcy5pZnJhbWUpCiAgICAgICAgdGhpcy5uYXZpZ2F0ZShjdXJyZW50KTsKICAgICAgdGhpcy5sb2FkVXJsKCk7CiAgICB9LAogICAgLy8gQXR0ZW1wdCB0byBsb2FkIHRoZSBjdXJyZW50IFVSTCBmcmFnbWVudC4gSWYgYSByb3V0ZSBzdWNjZWVkcyB3aXRoIGEKICAgIC8vIG1hdGNoLCByZXR1cm5zIGB0cnVlYC4gSWYgbm8gZGVmaW5lZCByb3V0ZXMgbWF0Y2hlcyB0aGUgZnJhZ21lbnQsCiAgICAvLyByZXR1cm5zIGBmYWxzZWAuCiAgICBsb2FkVXJsOiBmdW5jdGlvbiAoZnJhZ21lbnQpIHsKICAgICAgZnJhZ21lbnQgPSB0aGlzLmZyYWdtZW50ID0gdGhpcy5nZXRGcmFnbWVudChmcmFnbWVudCk7CiAgICAgIHJldHVybiBfLmFueSh0aGlzLmhhbmRsZXJzLCBmdW5jdGlvbiAoaGFuZGxlcikgewogICAgICAgIGlmIChoYW5kbGVyLnJvdXRlLnRlc3QoZnJhZ21lbnQpKSB7CiAgICAgICAgICBoYW5kbGVyLmNhbGxiYWNrKGZyYWdtZW50KTsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9LAogICAgLy8gU2F2ZSBhIGZyYWdtZW50IGludG8gdGhlIGhhc2ggaGlzdG9yeSwgb3IgcmVwbGFjZSB0aGUgVVJMIHN0YXRlIGlmIHRoZQogICAgLy8gJ3JlcGxhY2UnIG9wdGlvbiBpcyBwYXNzZWQuIFlvdSBhcmUgcmVzcG9uc2libGUgZm9yIHByb3Blcmx5IFVSTC1lbmNvZGluZwogICAgLy8gdGhlIGZyYWdtZW50IGluIGFkdmFuY2UuCiAgICAvLwogICAgLy8gVGhlIG9wdGlvbnMgb2JqZWN0IGNhbiBjb250YWluIGB0cmlnZ2VyOiB0cnVlYCBpZiB5b3Ugd2lzaCB0byBoYXZlIHRoZQogICAgLy8gcm91dGUgY2FsbGJhY2sgYmUgZmlyZWQgKG5vdCB1c3VhbGx5IGRlc2lyYWJsZSksIG9yIGByZXBsYWNlOiB0cnVlYCwgaWYKICAgIC8vIHlvdSB3aXNoIHRvIG1vZGlmeSB0aGUgY3VycmVudCBVUkwgd2l0aG91dCBhZGRpbmcgYW4gZW50cnkgdG8gdGhlIGhpc3RvcnkuCiAgICBuYXZpZ2F0ZTogZnVuY3Rpb24gKGZyYWdtZW50LCBvcHRpb25zKSB7CiAgICAgIGlmICghSGlzdG9yeS5zdGFydGVkKQogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgaWYgKCFvcHRpb25zIHx8IG9wdGlvbnMgPT09IHRydWUpCiAgICAgICAgb3B0aW9ucyA9IHsgdHJpZ2dlcjogISFvcHRpb25zIH07CiAgICAgIHZhciB1cmwgPSB0aGlzLnJvb3QgKyAoZnJhZ21lbnQgPSB0aGlzLmdldEZyYWdtZW50KGZyYWdtZW50IHx8ICcnKSk7CiAgICAgIC8vIFN0cmlwIHRoZSBoYXNoIGZvciBtYXRjaGluZy4KICAgICAgZnJhZ21lbnQgPSBmcmFnbWVudC5yZXBsYWNlKHBhdGhTdHJpcHBlciwgJycpOwogICAgICBpZiAodGhpcy5mcmFnbWVudCA9PT0gZnJhZ21lbnQpCiAgICAgICAgcmV0dXJuOwogICAgICB0aGlzLmZyYWdtZW50ID0gZnJhZ21lbnQ7CiAgICAgIC8vIERvbid0IGluY2x1ZGUgYSB0cmFpbGluZyBzbGFzaCBvbiB0aGUgcm9vdC4KICAgICAgaWYgKGZyYWdtZW50ID09PSAnJyAmJiB1cmwgIT09ICcvJykKICAgICAgICB1cmwgPSB1cmwuc2xpY2UoMCwgLTEpOwogICAgICAvLyBJZiBwdXNoU3RhdGUgaXMgYXZhaWxhYmxlLCB3ZSB1c2UgaXQgdG8gc2V0IHRoZSBmcmFnbWVudCBhcyBhIHJlYWwgVVJMLgogICAgICBpZiAodGhpcy5faGFzUHVzaFN0YXRlKSB7CiAgICAgICAgdGhpcy5oaXN0b3J5W29wdGlvbnMucmVwbGFjZSA/ICdyZXBsYWNlU3RhdGUnIDogJ3B1c2hTdGF0ZSddKHt9LCBkb2N1bWVudC50aXRsZSwgdXJsKTsgIC8vIElmIGhhc2ggY2hhbmdlcyBoYXZlbid0IGJlZW4gZXhwbGljaXRseSBkaXNhYmxlZCwgdXBkYXRlIHRoZSBoYXNoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGZyYWdtZW50IHRvIHN0b3JlIGhpc3RvcnkuCiAgICAgIH0gZWxzZSBpZiAodGhpcy5fd2FudHNIYXNoQ2hhbmdlKSB7CiAgICAgICAgdGhpcy5fdXBkYXRlSGFzaCh0aGlzLmxvY2F0aW9uLCBmcmFnbWVudCwgb3B0aW9ucy5yZXBsYWNlKTsKICAgICAgICBpZiAodGhpcy5pZnJhbWUgJiYgZnJhZ21lbnQgIT09IHRoaXMuZ2V0RnJhZ21lbnQodGhpcy5nZXRIYXNoKHRoaXMuaWZyYW1lKSkpIHsKICAgICAgICAgIC8vIE9wZW5pbmcgYW5kIGNsb3NpbmcgdGhlIGlmcmFtZSB0cmlja3MgSUU3IGFuZCBlYXJsaWVyIHRvIHB1c2ggYQogICAgICAgICAgLy8gaGlzdG9yeSBlbnRyeSBvbiBoYXNoLXRhZyBjaGFuZ2UuICBXaGVuIHJlcGxhY2UgaXMgdHJ1ZSwgd2UgZG9uJ3QKICAgICAgICAgIC8vIHdhbnQgdGhpcy4KICAgICAgICAgIGlmICghb3B0aW9ucy5yZXBsYWNlKQogICAgICAgICAgICB0aGlzLmlmcmFtZS5kb2N1bWVudC5vcGVuKCkuY2xvc2UoKTsKICAgICAgICAgIHRoaXMuX3VwZGF0ZUhhc2godGhpcy5pZnJhbWUubG9jYXRpb24sIGZyYWdtZW50LCBvcHRpb25zLnJlcGxhY2UpOwogICAgICAgIH0gIC8vIElmIHlvdSd2ZSB0b2xkIHVzIHRoYXQgeW91IGV4cGxpY2l0bHkgZG9uJ3Qgd2FudCBmYWxsYmFjayBoYXNoY2hhbmdlLQogICAgICAgICAgIC8vIGJhc2VkIGhpc3RvcnksIHRoZW4gYG5hdmlnYXRlYCBiZWNvbWVzIGEgcGFnZSByZWZyZXNoLgogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiB0aGlzLmxvY2F0aW9uLmFzc2lnbih1cmwpOwogICAgICB9CiAgICAgIGlmIChvcHRpb25zLnRyaWdnZXIpCiAgICAgICAgcmV0dXJuIHRoaXMubG9hZFVybChmcmFnbWVudCk7CiAgICB9LAogICAgLy8gVXBkYXRlIHRoZSBoYXNoIGxvY2F0aW9uLCBlaXRoZXIgcmVwbGFjaW5nIHRoZSBjdXJyZW50IGVudHJ5LCBvciBhZGRpbmcKICAgIC8vIGEgbmV3IG9uZSB0byB0aGUgYnJvd3NlciBoaXN0b3J5LgogICAgX3VwZGF0ZUhhc2g6IGZ1bmN0aW9uIChsb2NhdGlvbiwgZnJhZ21lbnQsIHJlcGxhY2UpIHsKICAgICAgaWYgKHJlcGxhY2UpIHsKICAgICAgICB2YXIgaHJlZiA9IGxvY2F0aW9uLmhyZWYucmVwbGFjZSgvKGphdmFzY3JpcHQ6fCMpLiokLywgJycpOwogICAgICAgIGxvY2F0aW9uLnJlcGxhY2UoaHJlZiArICcjJyArIGZyYWdtZW50KTsKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBTb21lIGJyb3dzZXJzIHJlcXVpcmUgdGhhdCBgaGFzaGAgY29udGFpbnMgYSBsZWFkaW5nICMuCiAgICAgICAgbG9jYXRpb24uaGFzaCA9ICcjJyArIGZyYWdtZW50OwogICAgICB9CiAgICB9CiAgfSk7CiAgLy8gQ3JlYXRlIHRoZSBkZWZhdWx0IEJhY2tib25lLmhpc3RvcnkuCiAgQmFja2JvbmUuaGlzdG9yeSA9IG5ldyBIaXN0b3J5KCk7CiAgLy8gSGVscGVycwogIC8vIC0tLS0tLS0KICAvLyBIZWxwZXIgZnVuY3Rpb24gdG8gY29ycmVjdGx5IHNldCB1cCB0aGUgcHJvdG90eXBlIGNoYWluLCBmb3Igc3ViY2xhc3Nlcy4KICAvLyBTaW1pbGFyIHRvIGBnb29nLmluaGVyaXRzYCwgYnV0IHVzZXMgYSBoYXNoIG9mIHByb3RvdHlwZSBwcm9wZXJ0aWVzIGFuZAogIC8vIGNsYXNzIHByb3BlcnRpZXMgdG8gYmUgZXh0ZW5kZWQuCiAgdmFyIGV4dGVuZCA9IGZ1bmN0aW9uIChwcm90b1Byb3BzLCBzdGF0aWNQcm9wcykgewogICAgdmFyIHBhcmVudCA9IHRoaXM7CiAgICB2YXIgY2hpbGQ7CiAgICAvLyBUaGUgY29uc3RydWN0b3IgZnVuY3Rpb24gZm9yIHRoZSBuZXcgc3ViY2xhc3MgaXMgZWl0aGVyIGRlZmluZWQgYnkgeW91CiAgICAvLyAodGhlICJjb25zdHJ1Y3RvciIgcHJvcGVydHkgaW4geW91ciBgZXh0ZW5kYCBkZWZpbml0aW9uKSwgb3IgZGVmYXVsdGVkCiAgICAvLyBieSB1cyB0byBzaW1wbHkgY2FsbCB0aGUgcGFyZW50J3MgY29uc3RydWN0b3IuCiAgICBpZiAocHJvdG9Qcm9wcyAmJiBfLmhhcyhwcm90b1Byb3BzLCAnY29uc3RydWN0b3InKSkgewogICAgICBjaGlsZCA9IHByb3RvUHJvcHMuY29uc3RydWN0b3I7CiAgICB9IGVsc2UgewogICAgICBjaGlsZCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gcGFyZW50LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIH07CiAgICB9CiAgICAvLyBBZGQgc3RhdGljIHByb3BlcnRpZXMgdG8gdGhlIGNvbnN0cnVjdG9yIGZ1bmN0aW9uLCBpZiBzdXBwbGllZC4KICAgIF8uZXh0ZW5kKGNoaWxkLCBwYXJlbnQsIHN0YXRpY1Byb3BzKTsKICAgIC8vIFNldCB0aGUgcHJvdG90eXBlIGNoYWluIHRvIGluaGVyaXQgZnJvbSBgcGFyZW50YCwgd2l0aG91dCBjYWxsaW5nCiAgICAvLyBgcGFyZW50YCdzIGNvbnN0cnVjdG9yIGZ1bmN0aW9uLgogICAgdmFyIFN1cnJvZ2F0ZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgdGhpcy5jb25zdHJ1Y3RvciA9IGNoaWxkOwogICAgfTsKICAgIFN1cnJvZ2F0ZS5wcm90b3R5cGUgPSBwYXJlbnQucHJvdG90eXBlOwogICAgY2hpbGQucHJvdG90eXBlID0gbmV3IFN1cnJvZ2F0ZSgpOwogICAgLy8gQWRkIHByb3RvdHlwZSBwcm9wZXJ0aWVzIChpbnN0YW5jZSBwcm9wZXJ0aWVzKSB0byB0aGUgc3ViY2xhc3MsCiAgICAvLyBpZiBzdXBwbGllZC4KICAgIGlmIChwcm90b1Byb3BzKQogICAgICBfLmV4dGVuZChjaGlsZC5wcm90b3R5cGUsIHByb3RvUHJvcHMpOwogICAgLy8gU2V0IGEgY29udmVuaWVuY2UgcHJvcGVydHkgaW4gY2FzZSB0aGUgcGFyZW50J3MgcHJvdG90eXBlIGlzIG5lZWRlZAogICAgLy8gbGF0ZXIuCiAgICBjaGlsZC5fX3N1cGVyX18gPSBwYXJlbnQucHJvdG90eXBlOwogICAgcmV0dXJuIGNoaWxkOwogIH07CiAgLy8gU2V0IHVwIGluaGVyaXRhbmNlIGZvciB0aGUgbW9kZWwsIGNvbGxlY3Rpb24sIHJvdXRlciwgdmlldyBhbmQgaGlzdG9yeS4KICBNb2RlbC5leHRlbmQgPSBDb2xsZWN0aW9uLmV4dGVuZCA9IFJvdXRlci5leHRlbmQgPSBWaWV3LmV4dGVuZCA9IEhpc3RvcnkuZXh0ZW5kID0gZXh0ZW5kOwogIC8vIFRocm93IGFuIGVycm9yIHdoZW4gYSBVUkwgaXMgbmVlZGVkLCBhbmQgbm9uZSBpcyBzdXBwbGllZC4KICB2YXIgdXJsRXJyb3IgPSBmdW5jdGlvbiAoKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoJ0EgInVybCIgcHJvcGVydHkgb3IgZnVuY3Rpb24gbXVzdCBiZSBzcGVjaWZpZWQnKTsKICB9OwogIC8vIFdyYXAgYW4gb3B0aW9uYWwgZXJyb3IgY2FsbGJhY2sgd2l0aCBhIGZhbGxiYWNrIGVycm9yIGV2ZW50LgogIHZhciB3cmFwRXJyb3IgPSBmdW5jdGlvbiAobW9kZWwsIG9wdGlvbnMpIHsKICAgIHZhciBlcnJvciA9IG9wdGlvbnMuZXJyb3I7CiAgICBvcHRpb25zLmVycm9yID0gZnVuY3Rpb24gKHJlc3ApIHsKICAgICAgaWYgKGVycm9yKQogICAgICAgIGVycm9yKG1vZGVsLCByZXNwLCBvcHRpb25zKTsKICAgICAgbW9kZWwudHJpZ2dlcignZXJyb3InLCBtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CiAgICB9OwogIH07CiAgcmV0dXJuIEJhY2tib25lOwp9KSk7Ci8vIEJhY2tib25lLldyZXFyIChCYWNrYm9uZS5NYXJpb25ldHRlKQovLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCi8vIHYxLjMuMQovLwovLyBDb3B5cmlnaHQgKGMpMjAxNCBEZXJpY2sgQmFpbGV5LCBNdXRlZCBTb2x1dGlvbnMsIExMQy4KLy8gRGlzdHJpYnV0ZWQgdW5kZXIgTUlUIGxpY2Vuc2UKLy8KLy8gaHR0cDovL2dpdGh1Yi5jb20vbWFyaW9uZXR0ZWpzL2JhY2tib25lLndyZXFyCihmdW5jdGlvbiAocm9vdCwgZmFjdG9yeSkgewogIGlmICh0cnVlKSB7CiAgICBiYWNrYm9uZXdyZXFyID0gZnVuY3Rpb24gKEJhY2tib25lLCBfKSB7CiAgICAgIHJldHVybiBmYWN0b3J5KEJhY2tib25lLCBfKTsKICAgIH0oYmFja2JvbmUsIHVuZGVyc2NvcmUpOwogIH0gZWxzZSBpZiAodHlwZW9mIGV4cG9ydHMgIT09ICd1bmRlZmluZWQnKSB7CiAgICB2YXIgQmFja2JvbmUgPSBiYWNrYm9uZTsKICAgIHZhciBfID0gdW5kZXJzY29yZTsKICAgIG1vZHVsZS5leHBvcnRzID0gZmFjdG9yeShCYWNrYm9uZSwgXyk7CiAgfSBlbHNlIHsKICAgIGZhY3Rvcnkocm9vdC5CYWNrYm9uZSwgcm9vdC5fKTsKICB9Cn0odGhpcywgZnVuY3Rpb24gKEJhY2tib25lLCBfKSB7CiAgCiAgdmFyIHByZXZpb3VzV3JlcXIgPSBCYWNrYm9uZS5XcmVxcjsKICB2YXIgV3JlcXIgPSBCYWNrYm9uZS5XcmVxciA9IHt9OwogIEJhY2tib25lLldyZXFyLlZFUlNJT04gPSAnMS4zLjEnOwogIEJhY2tib25lLldyZXFyLm5vQ29uZmxpY3QgPSBmdW5jdGlvbiAoKSB7CiAgICBCYWNrYm9uZS5XcmVxciA9IHByZXZpb3VzV3JlcXI7CiAgICByZXR1cm4gdGhpczsKICB9OwogIC8vIEhhbmRsZXJzCiAgLy8gLS0tLS0tLS0KICAvLyBBIHJlZ2lzdHJ5IG9mIGZ1bmN0aW9ucyB0byBjYWxsLCBnaXZlbiBhIG5hbWUKICBXcmVxci5IYW5kbGVycyA9IGZ1bmN0aW9uIChCYWNrYm9uZSwgXykgewogICAgCiAgICAvLyBDb25zdHJ1Y3RvcgogICAgLy8gLS0tLS0tLS0tLS0KICAgIHZhciBIYW5kbGVycyA9IGZ1bmN0aW9uIChvcHRpb25zKSB7CiAgICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnM7CiAgICAgIHRoaXMuX3dyZXFySGFuZGxlcnMgPSB7fTsKICAgICAgaWYgKF8uaXNGdW5jdGlvbih0aGlzLmluaXRpYWxpemUpKSB7CiAgICAgICAgdGhpcy5pbml0aWFsaXplKG9wdGlvbnMpOwogICAgICB9CiAgICB9OwogICAgSGFuZGxlcnMuZXh0ZW5kID0gQmFja2JvbmUuTW9kZWwuZXh0ZW5kOwogICAgLy8gSW5zdGFuY2UgTWVtYmVycwogICAgLy8gLS0tLS0tLS0tLS0tLS0tLQogICAgXy5leHRlbmQoSGFuZGxlcnMucHJvdG90eXBlLCBCYWNrYm9uZS5FdmVudHMsIHsKICAgICAgLy8gQWRkIG11bHRpcGxlIGhhbmRsZXJzIHVzaW5nIGFuIG9iamVjdCBsaXRlcmFsIGNvbmZpZ3VyYXRpb24KICAgICAgc2V0SGFuZGxlcnM6IGZ1bmN0aW9uIChoYW5kbGVycykgewogICAgICAgIF8uZWFjaChoYW5kbGVycywgZnVuY3Rpb24gKGhhbmRsZXIsIG5hbWUpIHsKICAgICAgICAgIHZhciBjb250ZXh0ID0gbnVsbDsKICAgICAgICAgIGlmIChfLmlzT2JqZWN0KGhhbmRsZXIpICYmICFfLmlzRnVuY3Rpb24oaGFuZGxlcikpIHsKICAgICAgICAgICAgY29udGV4dCA9IGhhbmRsZXIuY29udGV4dDsKICAgICAgICAgICAgaGFuZGxlciA9IGhhbmRsZXIuY2FsbGJhY2s7CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLnNldEhhbmRsZXIobmFtZSwgaGFuZGxlciwgY29udGV4dCk7CiAgICAgICAgfSwgdGhpcyk7CiAgICAgIH0sCiAgICAgIC8vIEFkZCBhIGhhbmRsZXIgZm9yIHRoZSBnaXZlbiBuYW1lLCB3aXRoIGFuCiAgICAgIC8vIG9wdGlvbmFsIGNvbnRleHQgdG8gcnVuIHRoZSBoYW5kbGVyIHdpdGhpbgogICAgICBzZXRIYW5kbGVyOiBmdW5jdGlvbiAobmFtZSwgaGFuZGxlciwgY29udGV4dCkgewogICAgICAgIHZhciBjb25maWcgPSB7CiAgICAgICAgICBjYWxsYmFjazogaGFuZGxlciwKICAgICAgICAgIGNvbnRleHQ6IGNvbnRleHQKICAgICAgICB9OwogICAgICAgIHRoaXMuX3dyZXFySGFuZGxlcnNbbmFtZV0gPSBjb25maWc7CiAgICAgICAgdGhpcy50cmlnZ2VyKCdoYW5kbGVyOmFkZCcsIG5hbWUsIGhhbmRsZXIsIGNvbnRleHQpOwogICAgICB9LAogICAgICAvLyBEZXRlcm1pbmUgd2hldGhlciBvciBub3QgYSBoYW5kbGVyIGlzIHJlZ2lzdGVyZWQKICAgICAgaGFzSGFuZGxlcjogZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICByZXR1cm4gISF0aGlzLl93cmVxckhhbmRsZXJzW25hbWVdOwogICAgICB9LAogICAgICAvLyBHZXQgdGhlIGN1cnJlbnRseSByZWdpc3RlcmVkIGhhbmRsZXIgZm9yCiAgICAgIC8vIHRoZSBzcGVjaWZpZWQgbmFtZS4gVGhyb3dzIGFuIGV4Y2VwdGlvbiBpZgogICAgICAvLyBubyBoYW5kbGVyIGlzIGZvdW5kLgogICAgICBnZXRIYW5kbGVyOiBmdW5jdGlvbiAobmFtZSkgewogICAgICAgIHZhciBjb25maWcgPSB0aGlzLl93cmVxckhhbmRsZXJzW25hbWVdOwogICAgICAgIGlmICghY29uZmlnKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5hcHBseShhcmd1bWVudHMpOwogICAgICAgICAgcmV0dXJuIGNvbmZpZy5jYWxsYmFjay5hcHBseShjb25maWcuY29udGV4dCwgYXJncyk7CiAgICAgICAgfTsKICAgICAgfSwKICAgICAgLy8gUmVtb3ZlIGEgaGFuZGxlciBmb3IgdGhlIHNwZWNpZmllZCBuYW1lCiAgICAgIHJlbW92ZUhhbmRsZXI6IGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgZGVsZXRlIHRoaXMuX3dyZXFySGFuZGxlcnNbbmFtZV07CiAgICAgIH0sCiAgICAgIC8vIFJlbW92ZSBhbGwgaGFuZGxlcnMgZnJvbSB0aGlzIHJlZ2lzdHJ5CiAgICAgIHJlbW92ZUFsbEhhbmRsZXJzOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgdGhpcy5fd3JlcXJIYW5kbGVycyA9IHt9OwogICAgICB9CiAgICB9KTsKICAgIHJldHVybiBIYW5kbGVyczsKICB9KEJhY2tib25lLCBfKTsKICAvLyBXcmVxci5Db21tYW5kU3RvcmFnZQogIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgLy8KICAvLyBTdG9yZSBhbmQgcmV0cmlldmUgY29tbWFuZHMgZm9yIGV4ZWN1dGlvbi4KICBXcmVxci5Db21tYW5kU3RvcmFnZSA9IGZ1bmN0aW9uICgpIHsKICAgIAogICAgLy8gQ29uc3RydWN0b3IgZnVuY3Rpb24KICAgIHZhciBDb21tYW5kU3RvcmFnZSA9IGZ1bmN0aW9uIChvcHRpb25zKSB7CiAgICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnM7CiAgICAgIHRoaXMuX2NvbW1hbmRzID0ge307CiAgICAgIGlmIChfLmlzRnVuY3Rpb24odGhpcy5pbml0aWFsaXplKSkgewogICAgICAgIHRoaXMuaW5pdGlhbGl6ZShvcHRpb25zKTsKICAgICAgfQogICAgfTsKICAgIC8vIEluc3RhbmNlIG1ldGhvZHMKICAgIF8uZXh0ZW5kKENvbW1hbmRTdG9yYWdlLnByb3RvdHlwZSwgQmFja2JvbmUuRXZlbnRzLCB7CiAgICAgIC8vIEdldCBhbiBvYmplY3QgbGl0ZXJhbCBieSBjb21tYW5kIG5hbWUsIHRoYXQgY29udGFpbnMKICAgICAgLy8gdGhlIGBjb21tYW5kTmFtZWAgYW5kIHRoZSBgaW5zdGFuY2VzYCBvZiBhbGwgY29tbWFuZHMKICAgICAgLy8gcmVwcmVzZW50ZWQgYXMgYW4gYXJyYXkgb2YgYXJndW1lbnRzIHRvIHByb2Nlc3MKICAgICAgZ2V0Q29tbWFuZHM6IGZ1bmN0aW9uIChjb21tYW5kTmFtZSkgewogICAgICAgIHZhciBjb21tYW5kcyA9IHRoaXMuX2NvbW1hbmRzW2NvbW1hbmROYW1lXTsKICAgICAgICAvLyB3ZSBkb24ndCBoYXZlIGl0LCBzbyBhZGQgaXQKICAgICAgICBpZiAoIWNvbW1hbmRzKSB7CiAgICAgICAgICAvLyBidWlsZCB0aGUgY29uZmlndXJhdGlvbgogICAgICAgICAgY29tbWFuZHMgPSB7CiAgICAgICAgICAgIGNvbW1hbmQ6IGNvbW1hbmROYW1lLAogICAgICAgICAgICBpbnN0YW5jZXM6IFtdCiAgICAgICAgICB9OwogICAgICAgICAgLy8gc3RvcmUgaXQKICAgICAgICAgIHRoaXMuX2NvbW1hbmRzW2NvbW1hbmROYW1lXSA9IGNvbW1hbmRzOwogICAgICAgIH0KICAgICAgICByZXR1cm4gY29tbWFuZHM7CiAgICAgIH0sCiAgICAgIC8vIEFkZCBhIGNvbW1hbmQgYnkgbmFtZSwgdG8gdGhlIHN0b3JhZ2UgYW5kIHN0b3JlIHRoZQogICAgICAvLyBhcmdzIGZvciB0aGUgY29tbWFuZAogICAgICBhZGRDb21tYW5kOiBmdW5jdGlvbiAoY29tbWFuZE5hbWUsIGFyZ3MpIHsKICAgICAgICB2YXIgY29tbWFuZCA9IHRoaXMuZ2V0Q29tbWFuZHMoY29tbWFuZE5hbWUpOwogICAgICAgIGNvbW1hbmQuaW5zdGFuY2VzLnB1c2goYXJncyk7CiAgICAgIH0sCiAgICAgIC8vIENsZWFyIGFsbCBjb21tYW5kcyBmb3IgdGhlIGdpdmVuIGBjb21tYW5kTmFtZWAKICAgICAgY2xlYXJDb21tYW5kczogZnVuY3Rpb24gKGNvbW1hbmROYW1lKSB7CiAgICAgICAgdmFyIGNvbW1hbmQgPSB0aGlzLmdldENvbW1hbmRzKGNvbW1hbmROYW1lKTsKICAgICAgICBjb21tYW5kLmluc3RhbmNlcyA9IFtdOwogICAgICB9CiAgICB9KTsKICAgIHJldHVybiBDb21tYW5kU3RvcmFnZTsKICB9KCk7CiAgLy8gV3JlcXIuQ29tbWFuZHMKICAvLyAtLS0tLS0tLS0tLS0tLQogIC8vCiAgLy8gQSBzaW1wbGUgY29tbWFuZCBwYXR0ZXJuIGltcGxlbWVudGF0aW9uLiBSZWdpc3RlciBhIGNvbW1hbmQKICAvLyBoYW5kbGVyIGFuZCBleGVjdXRlIGl0LgogIFdyZXFyLkNvbW1hbmRzID0gZnVuY3Rpb24gKFdyZXFyKSB7CiAgICAKICAgIHJldHVybiBXcmVxci5IYW5kbGVycy5leHRlbmQoewogICAgICAvLyBkZWZhdWx0IHN0b3JhZ2UgdHlwZQogICAgICBzdG9yYWdlVHlwZTogV3JlcXIuQ29tbWFuZFN0b3JhZ2UsCiAgICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbiAob3B0aW9ucykgewogICAgICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICAgICAgdGhpcy5faW5pdGlhbGl6ZVN0b3JhZ2UodGhpcy5vcHRpb25zKTsKICAgICAgICB0aGlzLm9uKCdoYW5kbGVyOmFkZCcsIHRoaXMuX2V4ZWN1dGVDb21tYW5kcywgdGhpcyk7CiAgICAgICAgdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMpOwogICAgICAgIFdyZXFyLkhhbmRsZXJzLnByb3RvdHlwZS5jb25zdHJ1Y3Rvci5hcHBseSh0aGlzLCBhcmdzKTsKICAgICAgfSwKICAgICAgLy8gRXhlY3V0ZSBhIG5hbWVkIGNvbW1hbmQgd2l0aCB0aGUgc3VwcGxpZWQgYXJncwogICAgICBleGVjdXRlOiBmdW5jdGlvbiAobmFtZSwgYXJncykgewogICAgICAgIG5hbWUgPSBhcmd1bWVudHNbMF07CiAgICAgICAgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CiAgICAgICAgaWYgKHRoaXMuaGFzSGFuZGxlcihuYW1lKSkgewogICAgICAgICAgdGhpcy5nZXRIYW5kbGVyKG5hbWUpLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzLnN0b3JhZ2UuYWRkQ29tbWFuZChuYW1lLCBhcmdzKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIC8vIEludGVybmFsIG1ldGhvZCB0byBoYW5kbGUgYnVsayBleGVjdXRpb24gb2Ygc3RvcmVkIGNvbW1hbmRzCiAgICAgIF9leGVjdXRlQ29tbWFuZHM6IGZ1bmN0aW9uIChuYW1lLCBoYW5kbGVyLCBjb250ZXh0KSB7CiAgICAgICAgdmFyIGNvbW1hbmQgPSB0aGlzLnN0b3JhZ2UuZ2V0Q29tbWFuZHMobmFtZSk7CiAgICAgICAgLy8gbG9vcCB0aHJvdWdoIGFuZCBleGVjdXRlIGFsbCB0aGUgc3RvcmVkIGNvbW1hbmQgaW5zdGFuY2VzCiAgICAgICAgXy5lYWNoKGNvbW1hbmQuaW5zdGFuY2VzLCBmdW5jdGlvbiAoYXJncykgewogICAgICAgICAgaGFuZGxlci5hcHBseShjb250ZXh0LCBhcmdzKTsKICAgICAgICB9KTsKICAgICAgICB0aGlzLnN0b3JhZ2UuY2xlYXJDb21tYW5kcyhuYW1lKTsKICAgICAgfSwKICAgICAgLy8gSW50ZXJuYWwgbWV0aG9kIHRvIGluaXRpYWxpemUgc3RvcmFnZSBlaXRoZXIgZnJvbSB0aGUgdHlwZSdzCiAgICAgIC8vIGBzdG9yYWdlVHlwZWAgb3IgdGhlIGluc3RhbmNlIGBvcHRpb25zLnN0b3JhZ2VUeXBlYC4KICAgICAgX2luaXRpYWxpemVTdG9yYWdlOiBmdW5jdGlvbiAob3B0aW9ucykgewogICAgICAgIHZhciBzdG9yYWdlOwogICAgICAgIHZhciBTdG9yYWdlVHlwZSA9IG9wdGlvbnMuc3RvcmFnZVR5cGUgfHwgdGhpcy5zdG9yYWdlVHlwZTsKICAgICAgICBpZiAoXy5pc0Z1bmN0aW9uKFN0b3JhZ2VUeXBlKSkgewogICAgICAgICAgc3RvcmFnZSA9IG5ldyBTdG9yYWdlVHlwZSgpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBzdG9yYWdlID0gU3RvcmFnZVR5cGU7CiAgICAgICAgfQogICAgICAgIHRoaXMuc3RvcmFnZSA9IHN0b3JhZ2U7CiAgICAgIH0KICAgIH0pOwogIH0oV3JlcXIpOwogIC8vIFdyZXFyLlJlcXVlc3RSZXNwb25zZQogIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLQogIC8vCiAgLy8gQSBzaW1wbGUgcmVxdWVzdC9yZXNwb25zZSBpbXBsZW1lbnRhdGlvbi4gUmVnaXN0ZXIgYQogIC8vIHJlcXVlc3QgaGFuZGxlciwgYW5kIHJldHVybiBhIHJlc3BvbnNlIGZyb20gaXQKICBXcmVxci5SZXF1ZXN0UmVzcG9uc2UgPSBmdW5jdGlvbiAoV3JlcXIpIHsKICAgIAogICAgcmV0dXJuIFdyZXFyLkhhbmRsZXJzLmV4dGVuZCh7CiAgICAgIHJlcXVlc3Q6IGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgbmFtZSA9IGFyZ3VtZW50c1swXTsKICAgICAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CiAgICAgICAgaWYgKHRoaXMuaGFzSGFuZGxlcihuYW1lKSkgewogICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0SGFuZGxlcihuYW1lKS5hcHBseSh0aGlzLCBhcmdzKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogIH0oV3JlcXIpOwogIC8vIEV2ZW50IEFnZ3JlZ2F0b3IKICAvLyAtLS0tLS0tLS0tLS0tLS0tCiAgLy8gQSBwdWItc3ViIG9iamVjdCB0aGF0IGNhbiBiZSB1c2VkIHRvIGRlY291cGxlIHZhcmlvdXMgcGFydHMKICAvLyBvZiBhbiBhcHBsaWNhdGlvbiB0aHJvdWdoIGV2ZW50LWRyaXZlbiBhcmNoaXRlY3R1cmUuCiAgV3JlcXIuRXZlbnRBZ2dyZWdhdG9yID0gZnVuY3Rpb24gKEJhY2tib25lLCBfKSB7CiAgICAKICAgIHZhciBFQSA9IGZ1bmN0aW9uICgpIHsKICAgIH07CiAgICAvLyBDb3B5IHRoZSBgZXh0ZW5kYCBmdW5jdGlvbiB1c2VkIGJ5IEJhY2tib25lJ3MgY2xhc3NlcwogICAgRUEuZXh0ZW5kID0gQmFja2JvbmUuTW9kZWwuZXh0ZW5kOwogICAgLy8gQ29weSB0aGUgYmFzaWMgQmFja2JvbmUuRXZlbnRzIG9uIHRvIHRoZSBldmVudCBhZ2dyZWdhdG9yCiAgICBfLmV4dGVuZChFQS5wcm90b3R5cGUsIEJhY2tib25lLkV2ZW50cyk7CiAgICByZXR1cm4gRUE7CiAgfShCYWNrYm9uZSwgXyk7CiAgLy8gV3JlcXIuQ2hhbm5lbAogIC8vIC0tLS0tLS0tLS0tLS0tCiAgLy8KICAvLyBBbiBvYmplY3QgdGhhdCB3cmFwcyB0aGUgdGhyZWUgbWVzc2FnaW5nIHN5c3RlbXM6CiAgLy8gRXZlbnRBZ2dyZWdhdG9yLCBSZXF1ZXN0UmVzcG9uc2UsIENvbW1hbmRzCiAgV3JlcXIuQ2hhbm5lbCA9IGZ1bmN0aW9uIChXcmVxcikgewogICAgCiAgICB2YXIgQ2hhbm5lbCA9IGZ1bmN0aW9uIChjaGFubmVsTmFtZSkgewogICAgICB0aGlzLnZlbnQgPSBuZXcgQmFja2JvbmUuV3JlcXIuRXZlbnRBZ2dyZWdhdG9yKCk7CiAgICAgIHRoaXMucmVxcmVzID0gbmV3IEJhY2tib25lLldyZXFyLlJlcXVlc3RSZXNwb25zZSgpOwogICAgICB0aGlzLmNvbW1hbmRzID0gbmV3IEJhY2tib25lLldyZXFyLkNvbW1hbmRzKCk7CiAgICAgIHRoaXMuY2hhbm5lbE5hbWUgPSBjaGFubmVsTmFtZTsKICAgIH07CiAgICBfLmV4dGVuZChDaGFubmVsLnByb3RvdHlwZSwgewogICAgICAvLyBSZW1vdmUgYWxsIGhhbmRsZXJzIGZyb20gdGhlIG1lc3NhZ2luZyBzeXN0ZW1zIG9mIHRoaXMgY2hhbm5lbAogICAgICByZXNldDogZnVuY3Rpb24gKCkgewogICAgICAgIHRoaXMudmVudC5vZmYoKTsKICAgICAgICB0aGlzLnZlbnQuc3RvcExpc3RlbmluZygpOwogICAgICAgIHRoaXMucmVxcmVzLnJlbW92ZUFsbEhhbmRsZXJzKCk7CiAgICAgICAgdGhpcy5jb21tYW5kcy5yZW1vdmVBbGxIYW5kbGVycygpOwogICAgICAgIHJldHVybiB0aGlzOwogICAgICB9LAogICAgICAvLyBDb25uZWN0IGEgaGFzaCBvZiBldmVudHM7IG9uZSBmb3IgZWFjaCBtZXNzYWdpbmcgc3lzdGVtCiAgICAgIGNvbm5lY3RFdmVudHM6IGZ1bmN0aW9uIChoYXNoLCBjb250ZXh0KSB7CiAgICAgICAgdGhpcy5fY29ubmVjdCgndmVudCcsIGhhc2gsIGNvbnRleHQpOwogICAgICAgIHJldHVybiB0aGlzOwogICAgICB9LAogICAgICBjb25uZWN0Q29tbWFuZHM6IGZ1bmN0aW9uIChoYXNoLCBjb250ZXh0KSB7CiAgICAgICAgdGhpcy5fY29ubmVjdCgnY29tbWFuZHMnLCBoYXNoLCBjb250ZXh0KTsKICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfSwKICAgICAgY29ubmVjdFJlcXVlc3RzOiBmdW5jdGlvbiAoaGFzaCwgY29udGV4dCkgewogICAgICAgIHRoaXMuX2Nvbm5lY3QoJ3JlcXJlcycsIGhhc2gsIGNvbnRleHQpOwogICAgICAgIHJldHVybiB0aGlzOwogICAgICB9LAogICAgICAvLyBBdHRhY2ggdGhlIGhhbmRsZXJzIHRvIGEgZ2l2ZW4gbWVzc2FnZSBzeXN0ZW0gYHR5cGVgCiAgICAgIF9jb25uZWN0OiBmdW5jdGlvbiAodHlwZSwgaGFzaCwgY29udGV4dCkgewogICAgICAgIGlmICghaGFzaCkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBjb250ZXh0ID0gY29udGV4dCB8fCB0aGlzOwogICAgICAgIHZhciBtZXRob2QgPSB0eXBlID09PSAndmVudCcgPyAnb24nIDogJ3NldEhhbmRsZXInOwogICAgICAgIF8uZWFjaChoYXNoLCBmdW5jdGlvbiAoZm4sIGV2ZW50TmFtZSkgewogICAgICAgICAgdGhpc1t0eXBlXVttZXRob2RdKGV2ZW50TmFtZSwgXy5iaW5kKGZuLCBjb250ZXh0KSk7CiAgICAgICAgfSwgdGhpcyk7CiAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuIENoYW5uZWw7CiAgfShXcmVxcik7CiAgLy8gV3JlcXIuUmFkaW8KICAvLyAtLS0tLS0tLS0tLS0tLQogIC8vCiAgLy8gQW4gb2JqZWN0IHRoYXQgbGV0cyB5b3UgY29tbXVuaWNhdGUgd2l0aCBtYW55IGNoYW5uZWxzLgogIFdyZXFyLnJhZGlvID0gZnVuY3Rpb24gKFdyZXFyKSB7CiAgICAKICAgIHZhciBSYWRpbyA9IGZ1bmN0aW9uICgpIHsKICAgICAgdGhpcy5fY2hhbm5lbHMgPSB7fTsKICAgICAgdGhpcy52ZW50ID0ge307CiAgICAgIHRoaXMuY29tbWFuZHMgPSB7fTsKICAgICAgdGhpcy5yZXFyZXMgPSB7fTsKICAgICAgdGhpcy5fcHJveHlNZXRob2RzKCk7CiAgICB9OwogICAgXy5leHRlbmQoUmFkaW8ucHJvdG90eXBlLCB7CiAgICAgIGNoYW5uZWw6IGZ1bmN0aW9uIChjaGFubmVsTmFtZSkgewogICAgICAgIGlmICghY2hhbm5lbE5hbWUpIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcignQ2hhbm5lbCBtdXN0IHJlY2VpdmUgYSBuYW1lJyk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzLl9nZXRDaGFubmVsKGNoYW5uZWxOYW1lKTsKICAgICAgfSwKICAgICAgX2dldENoYW5uZWw6IGZ1bmN0aW9uIChjaGFubmVsTmFtZSkgewogICAgICAgIHZhciBjaGFubmVsID0gdGhpcy5fY2hhbm5lbHNbY2hhbm5lbE5hbWVdOwogICAgICAgIGlmICghY2hhbm5lbCkgewogICAgICAgICAgY2hhbm5lbCA9IG5ldyBXcmVxci5DaGFubmVsKGNoYW5uZWxOYW1lKTsKICAgICAgICAgIHRoaXMuX2NoYW5uZWxzW2NoYW5uZWxOYW1lXSA9IGNoYW5uZWw7CiAgICAgICAgfQogICAgICAgIHJldHVybiBjaGFubmVsOwogICAgICB9LAogICAgICBfcHJveHlNZXRob2RzOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgXy5lYWNoKFsKICAgICAgICAgICd2ZW50JywKICAgICAgICAgICdjb21tYW5kcycsCiAgICAgICAgICAncmVxcmVzJwogICAgICAgIF0sIGZ1bmN0aW9uIChzeXN0ZW0pIHsKICAgICAgICAgIF8uZWFjaChtZXNzYWdlU3lzdGVtc1tzeXN0ZW1dLCBmdW5jdGlvbiAobWV0aG9kKSB7CiAgICAgICAgICAgIHRoaXNbc3lzdGVtXVttZXRob2RdID0gcHJveHlNZXRob2QodGhpcywgc3lzdGVtLCBtZXRob2QpOwogICAgICAgICAgfSwgdGhpcyk7CiAgICAgICAgfSwgdGhpcyk7CiAgICAgIH0KICAgIH0pOwogICAgdmFyIG1lc3NhZ2VTeXN0ZW1zID0gewogICAgICB2ZW50OiBbCiAgICAgICAgJ29uJywKICAgICAgICAnb2ZmJywKICAgICAgICAndHJpZ2dlcicsCiAgICAgICAgJ29uY2UnLAogICAgICAgICdzdG9wTGlzdGVuaW5nJywKICAgICAgICAnbGlzdGVuVG8nLAogICAgICAgICdsaXN0ZW5Ub09uY2UnCiAgICAgIF0sCiAgICAgIGNvbW1hbmRzOiBbCiAgICAgICAgJ2V4ZWN1dGUnLAogICAgICAgICdzZXRIYW5kbGVyJywKICAgICAgICAnc2V0SGFuZGxlcnMnLAogICAgICAgICdyZW1vdmVIYW5kbGVyJywKICAgICAgICAncmVtb3ZlQWxsSGFuZGxlcnMnCiAgICAgIF0sCiAgICAgIHJlcXJlczogWwogICAgICAgICdyZXF1ZXN0JywKICAgICAgICAnc2V0SGFuZGxlcicsCiAgICAgICAgJ3NldEhhbmRsZXJzJywKICAgICAgICAncmVtb3ZlSGFuZGxlcicsCiAgICAgICAgJ3JlbW92ZUFsbEhhbmRsZXJzJwogICAgICBdCiAgICB9OwogICAgdmFyIHByb3h5TWV0aG9kID0gZnVuY3Rpb24gKHJhZGlvLCBzeXN0ZW0sIG1ldGhvZCkgewogICAgICByZXR1cm4gZnVuY3Rpb24gKGNoYW5uZWxOYW1lKSB7CiAgICAgICAgdmFyIG1lc3NhZ2VTeXN0ZW0gPSByYWRpby5fZ2V0Q2hhbm5lbChjaGFubmVsTmFtZSlbc3lzdGVtXTsKICAgICAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CiAgICAgICAgcmV0dXJuIG1lc3NhZ2VTeXN0ZW1bbWV0aG9kXS5hcHBseShtZXNzYWdlU3lzdGVtLCBhcmdzKTsKICAgICAgfTsKICAgIH07CiAgICByZXR1cm4gbmV3IFJhZGlvKCk7CiAgfShXcmVxcik7CiAgcmV0dXJuIEJhY2tib25lLldyZXFyOwp9KSk7Ci8vIEJhY2tib25lLkJhYnlTaXR0ZXIKLy8gLS0tLS0tLS0tLS0tLS0tLS0tLQovLyB2MC4xLjQKLy8KLy8gQ29weXJpZ2h0IChjKTIwMTQgRGVyaWNrIEJhaWxleSwgTXV0ZWQgU29sdXRpb25zLCBMTEMuCi8vIERpc3RyaWJ1dGVkIHVuZGVyIE1JVCBsaWNlbnNlCi8vCi8vIGh0dHA6Ly9naXRodWIuY29tL21hcmlvbmV0dGVqcy9iYWNrYm9uZS5iYWJ5c2l0dGVyCihmdW5jdGlvbiAocm9vdCwgZmFjdG9yeSkgewogIGlmICh0cnVlKSB7CiAgICBiYWNrYm9uZWJhYnlzaXR0ZXIgPSBmdW5jdGlvbiAoQmFja2JvbmUsIF8pIHsKICAgICAgcmV0dXJuIGZhY3RvcnkoQmFja2JvbmUsIF8pOwogICAgfShiYWNrYm9uZSwgdW5kZXJzY29yZSk7CiAgfSBlbHNlIGlmICh0eXBlb2YgZXhwb3J0cyAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgIHZhciBCYWNrYm9uZSA9IGJhY2tib25lOwogICAgdmFyIF8gPSB1bmRlcnNjb3JlOwogICAgbW9kdWxlLmV4cG9ydHMgPSBmYWN0b3J5KEJhY2tib25lLCBfKTsKICB9IGVsc2UgewogICAgZmFjdG9yeShyb290LkJhY2tib25lLCByb290Ll8pOwogIH0KfSh0aGlzLCBmdW5jdGlvbiAoQmFja2JvbmUsIF8pIHsKICAKICB2YXIgcHJldmlvdXNDaGlsZFZpZXdDb250YWluZXIgPSBCYWNrYm9uZS5DaGlsZFZpZXdDb250YWluZXI7CiAgLy8gQmFieVNpdHRlci5DaGlsZFZpZXdDb250YWluZXIKICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogIC8vCiAgLy8gUHJvdmlkZSBhIGNvbnRhaW5lciB0byBzdG9yZSwgcmV0cmlldmUgYW5kCiAgLy8gc2h1dCBkb3duIGNoaWxkIHZpZXdzLgogIEJhY2tib25lLkNoaWxkVmlld0NvbnRhaW5lciA9IGZ1bmN0aW9uIChCYWNrYm9uZSwgXykgewogICAgLy8gQ29udGFpbmVyIENvbnN0cnVjdG9yCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIHZhciBDb250YWluZXIgPSBmdW5jdGlvbiAodmlld3MpIHsKICAgICAgdGhpcy5fdmlld3MgPSB7fTsKICAgICAgdGhpcy5faW5kZXhCeU1vZGVsID0ge307CiAgICAgIHRoaXMuX2luZGV4QnlDdXN0b20gPSB7fTsKICAgICAgdGhpcy5fdXBkYXRlTGVuZ3RoKCk7CiAgICAgIF8uZWFjaCh2aWV3cywgdGhpcy5hZGQsIHRoaXMpOwogICAgfTsKICAgIC8vIENvbnRhaW5lciBNZXRob2RzCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLQogICAgXy5leHRlbmQoQ29udGFpbmVyLnByb3RvdHlwZSwgewogICAgICAvLyBBZGQgYSB2aWV3IHRvIHRoaXMgY29udGFpbmVyLiBTdG9yZXMgdGhlIHZpZXcKICAgICAgLy8gYnkgYGNpZGAgYW5kIG1ha2VzIGl0IHNlYXJjaGFibGUgYnkgdGhlIG1vZGVsCiAgICAgIC8vIGNpZCAoYW5kIG1vZGVsIGl0c2VsZikuIE9wdGlvbmFsbHkgc3BlY2lmeQogICAgICAvLyBhIGN1c3RvbSBrZXkgdG8gc3RvcmUgYW4gcmV0cmlldmUgdGhlIHZpZXcuCiAgICAgIGFkZDogZnVuY3Rpb24gKHZpZXcsIGN1c3RvbUluZGV4KSB7CiAgICAgICAgdmFyIHZpZXdDaWQgPSB2aWV3LmNpZDsKICAgICAgICAvLyBzdG9yZSB0aGUgdmlldwogICAgICAgIHRoaXMuX3ZpZXdzW3ZpZXdDaWRdID0gdmlldzsKICAgICAgICAvLyBpbmRleCBpdCBieSBtb2RlbAogICAgICAgIGlmICh2aWV3Lm1vZGVsKSB7CiAgICAgICAgICB0aGlzLl9pbmRleEJ5TW9kZWxbdmlldy5tb2RlbC5jaWRdID0gdmlld0NpZDsKICAgICAgICB9CiAgICAgICAgLy8gaW5kZXggYnkgY3VzdG9tCiAgICAgICAgaWYgKGN1c3RvbUluZGV4KSB7CiAgICAgICAgICB0aGlzLl9pbmRleEJ5Q3VzdG9tW2N1c3RvbUluZGV4XSA9IHZpZXdDaWQ7CiAgICAgICAgfQogICAgICAgIHRoaXMuX3VwZGF0ZUxlbmd0aCgpOwogICAgICAgIHJldHVybiB0aGlzOwogICAgICB9LAogICAgICAvLyBGaW5kIGEgdmlldyBieSB0aGUgbW9kZWwgdGhhdCB3YXMgYXR0YWNoZWQgdG8KICAgICAgLy8gaXQuIFVzZXMgdGhlIG1vZGVsJ3MgYGNpZGAgdG8gZmluZCBpdC4KICAgICAgZmluZEJ5TW9kZWw6IGZ1bmN0aW9uIChtb2RlbCkgewogICAgICAgIHJldHVybiB0aGlzLmZpbmRCeU1vZGVsQ2lkKG1vZGVsLmNpZCk7CiAgICAgIH0sCiAgICAgIC8vIEZpbmQgYSB2aWV3IGJ5IHRoZSBgY2lkYCBvZiB0aGUgbW9kZWwgdGhhdCB3YXMgYXR0YWNoZWQgdG8KICAgICAgLy8gaXQuIFVzZXMgdGhlIG1vZGVsJ3MgYGNpZGAgdG8gZmluZCB0aGUgdmlldyBgY2lkYCBhbmQKICAgICAgLy8gcmV0cmlldmUgdGhlIHZpZXcgdXNpbmcgaXQuCiAgICAgIGZpbmRCeU1vZGVsQ2lkOiBmdW5jdGlvbiAobW9kZWxDaWQpIHsKICAgICAgICB2YXIgdmlld0NpZCA9IHRoaXMuX2luZGV4QnlNb2RlbFttb2RlbENpZF07CiAgICAgICAgcmV0dXJuIHRoaXMuZmluZEJ5Q2lkKHZpZXdDaWQpOwogICAgICB9LAogICAgICAvLyBGaW5kIGEgdmlldyBieSBhIGN1c3RvbSBpbmRleGVyLgogICAgICBmaW5kQnlDdXN0b206IGZ1bmN0aW9uIChpbmRleCkgewogICAgICAgIHZhciB2aWV3Q2lkID0gdGhpcy5faW5kZXhCeUN1c3RvbVtpbmRleF07CiAgICAgICAgcmV0dXJuIHRoaXMuZmluZEJ5Q2lkKHZpZXdDaWQpOwogICAgICB9LAogICAgICAvLyBGaW5kIGJ5IGluZGV4LiBUaGlzIGlzIG5vdCBndWFyYW50ZWVkIHRvIGJlIGEKICAgICAgLy8gc3RhYmxlIGluZGV4LgogICAgICBmaW5kQnlJbmRleDogZnVuY3Rpb24gKGluZGV4KSB7CiAgICAgICAgcmV0dXJuIF8udmFsdWVzKHRoaXMuX3ZpZXdzKVtpbmRleF07CiAgICAgIH0sCiAgICAgIC8vIHJldHJpZXZlIGEgdmlldyBieSBpdHMgYGNpZGAgZGlyZWN0bHkKICAgICAgZmluZEJ5Q2lkOiBmdW5jdGlvbiAoY2lkKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3ZpZXdzW2NpZF07CiAgICAgIH0sCiAgICAgIC8vIFJlbW92ZSBhIHZpZXcKICAgICAgcmVtb3ZlOiBmdW5jdGlvbiAodmlldykgewogICAgICAgIHZhciB2aWV3Q2lkID0gdmlldy5jaWQ7CiAgICAgICAgLy8gZGVsZXRlIG1vZGVsIGluZGV4CiAgICAgICAgaWYgKHZpZXcubW9kZWwpIHsKICAgICAgICAgIGRlbGV0ZSB0aGlzLl9pbmRleEJ5TW9kZWxbdmlldy5tb2RlbC5jaWRdOwogICAgICAgIH0KICAgICAgICAvLyBkZWxldGUgY3VzdG9tIGluZGV4CiAgICAgICAgXy5hbnkodGhpcy5faW5kZXhCeUN1c3RvbSwgZnVuY3Rpb24gKGNpZCwga2V5KSB7CiAgICAgICAgICBpZiAoY2lkID09PSB2aWV3Q2lkKSB7CiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLl9pbmRleEJ5Q3VzdG9tW2tleV07CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0sIHRoaXMpOwogICAgICAgIC8vIHJlbW92ZSB0aGUgdmlldyBmcm9tIHRoZSBjb250YWluZXIKICAgICAgICBkZWxldGUgdGhpcy5fdmlld3Nbdmlld0NpZF07CiAgICAgICAgLy8gdXBkYXRlIHRoZSBsZW5ndGgKICAgICAgICB0aGlzLl91cGRhdGVMZW5ndGgoKTsKICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfSwKICAgICAgLy8gQ2FsbCBhIG1ldGhvZCBvbiBldmVyeSB2aWV3IGluIHRoZSBjb250YWluZXIsCiAgICAgIC8vIHBhc3NpbmcgcGFyYW1ldGVycyB0byB0aGUgY2FsbCBtZXRob2Qgb25lIGF0IGEKICAgICAgLy8gdGltZSwgbGlrZSBgZnVuY3Rpb24uY2FsbGAuCiAgICAgIGNhbGw6IGZ1bmN0aW9uIChtZXRob2QpIHsKICAgICAgICB0aGlzLmFwcGx5KG1ldGhvZCwgXy50YWlsKGFyZ3VtZW50cykpOwogICAgICB9LAogICAgICAvLyBBcHBseSBhIG1ldGhvZCBvbiBldmVyeSB2aWV3IGluIHRoZSBjb250YWluZXIsCiAgICAgIC8vIHBhc3NpbmcgcGFyYW1ldGVycyB0byB0aGUgY2FsbCBtZXRob2Qgb25lIGF0IGEKICAgICAgLy8gdGltZSwgbGlrZSBgZnVuY3Rpb24uYXBwbHlgLgogICAgICBhcHBseTogZnVuY3Rpb24gKG1ldGhvZCwgYXJncykgewogICAgICAgIF8uZWFjaCh0aGlzLl92aWV3cywgZnVuY3Rpb24gKHZpZXcpIHsKICAgICAgICAgIGlmIChfLmlzRnVuY3Rpb24odmlld1ttZXRob2RdKSkgewogICAgICAgICAgICB2aWV3W21ldGhvZF0uYXBwbHkodmlldywgYXJncyB8fCBbXSk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0sCiAgICAgIC8vIFVwZGF0ZSB0aGUgYC5sZW5ndGhgIGF0dHJpYnV0ZSBvbiB0aGlzIGNvbnRhaW5lcgogICAgICBfdXBkYXRlTGVuZ3RoOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgdGhpcy5sZW5ndGggPSBfLnNpemUodGhpcy5fdmlld3MpOwogICAgICB9CiAgICB9KTsKICAgIC8vIEJvcnJvd2luZyB0aGlzIGNvZGUgZnJvbSBCYWNrYm9uZS5Db2xsZWN0aW9uOgogICAgLy8gaHR0cDovL2JhY2tib25lanMub3JnL2RvY3MvYmFja2JvbmUuaHRtbCNzZWN0aW9uLTEwNgogICAgLy8KICAgIC8vIE1peCBpbiBtZXRob2RzIGZyb20gVW5kZXJzY29yZSwgZm9yIGl0ZXJhdGlvbiwgYW5kIG90aGVyCiAgICAvLyBjb2xsZWN0aW9uIHJlbGF0ZWQgZmVhdHVyZXMuCiAgICB2YXIgbWV0aG9kcyA9IFsKICAgICAgJ2ZvckVhY2gnLAogICAgICAnZWFjaCcsCiAgICAgICdtYXAnLAogICAgICAnZmluZCcsCiAgICAgICdkZXRlY3QnLAogICAgICAnZmlsdGVyJywKICAgICAgJ3NlbGVjdCcsCiAgICAgICdyZWplY3QnLAogICAgICAnZXZlcnknLAogICAgICAnYWxsJywKICAgICAgJ3NvbWUnLAogICAgICAnYW55JywKICAgICAgJ2luY2x1ZGUnLAogICAgICAnY29udGFpbnMnLAogICAgICAnaW52b2tlJywKICAgICAgJ3RvQXJyYXknLAogICAgICAnZmlyc3QnLAogICAgICAnaW5pdGlhbCcsCiAgICAgICdyZXN0JywKICAgICAgJ2xhc3QnLAogICAgICAnd2l0aG91dCcsCiAgICAgICdpc0VtcHR5JywKICAgICAgJ3BsdWNrJwogICAgXTsKICAgIF8uZWFjaChtZXRob2RzLCBmdW5jdGlvbiAobWV0aG9kKSB7CiAgICAgIENvbnRhaW5lci5wcm90b3R5cGVbbWV0aG9kXSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgdmlld3MgPSBfLnZhbHVlcyh0aGlzLl92aWV3cyk7CiAgICAgICAgdmFyIGFyZ3MgPSBbdmlld3NdLmNvbmNhdChfLnRvQXJyYXkoYXJndW1lbnRzKSk7CiAgICAgICAgcmV0dXJuIF9bbWV0aG9kXS5hcHBseShfLCBhcmdzKTsKICAgICAgfTsKICAgIH0pOwogICAgLy8gcmV0dXJuIHRoZSBwdWJsaWMgQVBJCiAgICByZXR1cm4gQ29udGFpbmVyOwogIH0oQmFja2JvbmUsIF8pOwogIEJhY2tib25lLkNoaWxkVmlld0NvbnRhaW5lci5WRVJTSU9OID0gJzAuMS40JzsKICBCYWNrYm9uZS5DaGlsZFZpZXdDb250YWluZXIubm9Db25mbGljdCA9IGZ1bmN0aW9uICgpIHsKICAgIEJhY2tib25lLkNoaWxkVmlld0NvbnRhaW5lciA9IHByZXZpb3VzQ2hpbGRWaWV3Q29udGFpbmVyOwogICAgcmV0dXJuIHRoaXM7CiAgfTsKICByZXR1cm4gQmFja2JvbmUuQ2hpbGRWaWV3Q29udGFpbmVyOwp9KSk7Ci8vIE1hcmlvbmV0dGVKUyAoQmFja2JvbmUuTWFyaW9uZXR0ZSkKLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQovLyB2Mi4yLjAKLy8KLy8gQ29weXJpZ2h0IChjKTIwMTQgRGVyaWNrIEJhaWxleSwgTXV0ZWQgU29sdXRpb25zLCBMTEMuCi8vIERpc3RyaWJ1dGVkIHVuZGVyIE1JVCBsaWNlbnNlCi8vCi8vIGh0dHA6Ly9tYXJpb25ldHRlanMuY29tCihmdW5jdGlvbiAocm9vdCwgZmFjdG9yeSkgewogIGlmICh0cnVlKSB7CiAgICBiYWNrYm9uZW1hcmlvbmV0dGUgPSBmdW5jdGlvbiAoQmFja2JvbmUsIF8pIHsKICAgICAgcmV0dXJuIHJvb3QuTWFyaW9uZXR0ZSA9IGZhY3Rvcnkocm9vdCwgQmFja2JvbmUsIF8pOwogICAgfShiYWNrYm9uZSwgdW5kZXJzY29yZSk7CiAgfSBlbHNlIGlmICh0eXBlb2YgZXhwb3J0cyAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgIHZhciBCYWNrYm9uZSA9IGJhY2tib25lOwogICAgdmFyIF8gPSB1bmRlcnNjb3JlOwogICAgdmFyIFdyZXFyID0gYmFja2JvbmV3cmVxcjsKICAgIHZhciBCYWJ5U2l0dGVyID0gYmFja2JvbmViYWJ5c2l0dGVyOwogICAgbW9kdWxlLmV4cG9ydHMgPSBmYWN0b3J5KHJvb3QsIEJhY2tib25lLCBfKTsKICB9IGVsc2UgewogICAgcm9vdC5NYXJpb25ldHRlID0gZmFjdG9yeShyb290LCByb290LkJhY2tib25lLCByb290Ll8pOwogIH0KfSh0aGlzLCBmdW5jdGlvbiAocm9vdCwgQmFja2JvbmUsIF8pIHsKICAKICB2YXIgcHJldmlvdXNNYXJpb25ldHRlID0gcm9vdC5NYXJpb25ldHRlOwogIHZhciBNYXJpb25ldHRlID0gQmFja2JvbmUuTWFyaW9uZXR0ZSA9IHt9OwogIE1hcmlvbmV0dGUuVkVSU0lPTiA9ICcyLjIuMCc7CiAgTWFyaW9uZXR0ZS5ub0NvbmZsaWN0ID0gZnVuY3Rpb24gKCkgewogICAgcm9vdC5NYXJpb25ldHRlID0gcHJldmlvdXNNYXJpb25ldHRlOwogICAgcmV0dXJuIHRoaXM7CiAgfTsKICAvLyBHZXQgdGhlIERlZmVycmVkIGNyZWF0b3IgZm9yIGxhdGVyIHVzZQogIE1hcmlvbmV0dGUuRGVmZXJyZWQgPSBCYWNrYm9uZS4kLkRlZmVycmVkOwogIC8qIGpzaGludCB1bnVzZWQ6IGZhbHNlICovCiAgLy8gSGVscGVycwogIC8vIC0tLS0tLS0KICAvLyBGb3Igc2xpY2luZyBgYXJndW1lbnRzYCBpbiBmdW5jdGlvbnMKICB2YXIgc2xpY2UgPSBBcnJheS5wcm90b3R5cGUuc2xpY2U7CiAgLy8gTWFyaW9uZXR0ZS5leHRlbmQKICAvLyAtLS0tLS0tLS0tLS0tLS0tLQogIC8vIEJvcnJvdyB0aGUgQmFja2JvbmUgYGV4dGVuZGAgbWV0aG9kIHNvIHdlIGNhbiB1c2UgaXQgYXMgbmVlZGVkCiAgTWFyaW9uZXR0ZS5leHRlbmQgPSBCYWNrYm9uZS5Nb2RlbC5leHRlbmQ7CiAgLy8gTWFyaW9uZXR0ZS5nZXRPcHRpb24KICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLQogIC8vIFJldHJpZXZlIGFuIG9iamVjdCwgZnVuY3Rpb24gb3Igb3RoZXIgdmFsdWUgZnJvbSBhIHRhcmdldAogIC8vIG9iamVjdCBvciBpdHMgYG9wdGlvbnNgLCB3aXRoIGBvcHRpb25zYCB0YWtpbmcgcHJlY2VkZW5jZS4KICBNYXJpb25ldHRlLmdldE9wdGlvbiA9IGZ1bmN0aW9uICh0YXJnZXQsIG9wdGlvbk5hbWUpIHsKICAgIGlmICghdGFyZ2V0IHx8ICFvcHRpb25OYW1lKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHZhciB2YWx1ZTsKICAgIGlmICh0YXJnZXQub3B0aW9ucyAmJiB0YXJnZXQub3B0aW9uc1tvcHRpb25OYW1lXSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgIHZhbHVlID0gdGFyZ2V0Lm9wdGlvbnNbb3B0aW9uTmFtZV07CiAgICB9IGVsc2UgewogICAgICB2YWx1ZSA9IHRhcmdldFtvcHRpb25OYW1lXTsKICAgIH0KICAgIHJldHVybiB2YWx1ZTsKICB9OwogIC8vIFByb3h5IGBNYXJpb25ldHRlLmdldE9wdGlvbmAKICBNYXJpb25ldHRlLnByb3h5R2V0T3B0aW9uID0gZnVuY3Rpb24gKG9wdGlvbk5hbWUpIHsKICAgIHJldHVybiBNYXJpb25ldHRlLmdldE9wdGlvbih0aGlzLCBvcHRpb25OYW1lKTsKICB9OwogIC8vIE1hcmlvbmV0dGUubm9ybWFsaXplTWV0aG9kcwogIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAvLyBQYXNzIGluIGEgbWFwcGluZyBvZiBldmVudHMgPT4gZnVuY3Rpb25zIG9yIGZ1bmN0aW9uIG5hbWVzCiAgLy8gYW5kIHJldHVybiBhIG1hcHBpbmcgb2YgZXZlbnRzID0+IGZ1bmN0aW9ucwogIE1hcmlvbmV0dGUubm9ybWFsaXplTWV0aG9kcyA9IGZ1bmN0aW9uIChoYXNoKSB7CiAgICB2YXIgbm9ybWFsaXplZEhhc2ggPSB7fTsKICAgIF8uZWFjaChoYXNoLCBmdW5jdGlvbiAobWV0aG9kLCBuYW1lKSB7CiAgICAgIGlmICghXy5pc0Z1bmN0aW9uKG1ldGhvZCkpIHsKICAgICAgICBtZXRob2QgPSB0aGlzW21ldGhvZF07CiAgICAgIH0KICAgICAgaWYgKCFtZXRob2QpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgbm9ybWFsaXplZEhhc2hbbmFtZV0gPSBtZXRob2Q7CiAgICB9LCB0aGlzKTsKICAgIHJldHVybiBub3JtYWxpemVkSGFzaDsKICB9OwogIC8vIHV0aWxpdHkgbWV0aG9kIGZvciBwYXJzaW5nIEB1aS4gc3ludGF4IHN0cmluZ3MKICAvLyBpbnRvIGFzc29jaWF0ZWQgc2VsZWN0b3IKICBNYXJpb25ldHRlLm5vcm1hbGl6ZVVJU3RyaW5nID0gZnVuY3Rpb24gKHVpU3RyaW5nLCB1aSkgewogICAgcmV0dXJuIHVpU3RyaW5nLnJlcGxhY2UoL0B1aVwuW2EtekEtWl8kMC05XSovZywgZnVuY3Rpb24gKHIpIHsKICAgICAgcmV0dXJuIHVpW3Iuc2xpY2UoNCldOwogICAgfSk7CiAgfTsKICAvLyBhbGxvd3MgZm9yIHRoZSB1c2Ugb2YgdGhlIEB1aS4gc3ludGF4IHdpdGhpbgogIC8vIGEgZ2l2ZW4ga2V5IGZvciB0cmlnZ2VycyBhbmQgZXZlbnRzCiAgLy8gc3dhcHMgdGhlIEB1aSB3aXRoIHRoZSBhc3NvY2lhdGVkIHNlbGVjdG9yLgogIC8vIFJldHVybnMgYSBuZXcsIG5vbi1tdXRhdGVkLCBwYXJzZWQgZXZlbnRzIGhhc2guCiAgTWFyaW9uZXR0ZS5ub3JtYWxpemVVSUtleXMgPSBmdW5jdGlvbiAoaGFzaCwgdWkpIHsKICAgIGlmICh0eXBlb2YgaGFzaCA9PT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgaGFzaCA9IF8uY2xvbmUoaGFzaCk7CiAgICBfLmVhY2goXy5rZXlzKGhhc2gpLCBmdW5jdGlvbiAoa2V5KSB7CiAgICAgIHZhciBub3JtYWxpemVkS2V5ID0gTWFyaW9uZXR0ZS5ub3JtYWxpemVVSVN0cmluZyhrZXksIHVpKTsKICAgICAgaWYgKG5vcm1hbGl6ZWRLZXkgIT09IGtleSkgewogICAgICAgIGhhc2hbbm9ybWFsaXplZEtleV0gPSBoYXNoW2tleV07CiAgICAgICAgZGVsZXRlIGhhc2hba2V5XTsKICAgICAgfQogICAgfSk7CiAgICByZXR1cm4gaGFzaDsKICB9OwogIC8vIGFsbG93cyBmb3IgdGhlIHVzZSBvZiB0aGUgQHVpLiBzeW50YXggd2l0aGluCiAgLy8gYSBnaXZlbiB2YWx1ZSBmb3IgcmVnaW9ucwogIC8vIHN3YXBzIHRoZSBAdWkgd2l0aCB0aGUgYXNzb2NpYXRlZCBzZWxlY3RvcgogIE1hcmlvbmV0dGUubm9ybWFsaXplVUlWYWx1ZXMgPSBmdW5jdGlvbiAoaGFzaCwgdWkpIHsKICAgIGlmICh0eXBlb2YgaGFzaCA9PT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgXy5lYWNoKGhhc2gsIGZ1bmN0aW9uICh2YWwsIGtleSkgewogICAgICBpZiAoXy5pc1N0cmluZyh2YWwpKSB7CiAgICAgICAgaGFzaFtrZXldID0gTWFyaW9uZXR0ZS5ub3JtYWxpemVVSVN0cmluZyh2YWwsIHVpKTsKICAgICAgfQogICAgfSk7CiAgICByZXR1cm4gaGFzaDsKICB9OwogIC8vIE1peCBpbiBtZXRob2RzIGZyb20gVW5kZXJzY29yZSwgZm9yIGl0ZXJhdGlvbiwgYW5kIG90aGVyCiAgLy8gY29sbGVjdGlvbiByZWxhdGVkIGZlYXR1cmVzLgogIC8vIEJvcnJvd2luZyB0aGlzIGNvZGUgZnJvbSBCYWNrYm9uZS5Db2xsZWN0aW9uOgogIC8vIGh0dHA6Ly9iYWNrYm9uZWpzLm9yZy9kb2NzL2JhY2tib25lLmh0bWwjc2VjdGlvbi0xMjEKICBNYXJpb25ldHRlLmFjdEFzQ29sbGVjdGlvbiA9IGZ1bmN0aW9uIChvYmplY3QsIGxpc3RQcm9wZXJ0eSkgewogICAgdmFyIG1ldGhvZHMgPSBbCiAgICAgICdmb3JFYWNoJywKICAgICAgJ2VhY2gnLAogICAgICAnbWFwJywKICAgICAgJ2ZpbmQnLAogICAgICAnZGV0ZWN0JywKICAgICAgJ2ZpbHRlcicsCiAgICAgICdzZWxlY3QnLAogICAgICAncmVqZWN0JywKICAgICAgJ2V2ZXJ5JywKICAgICAgJ2FsbCcsCiAgICAgICdzb21lJywKICAgICAgJ2FueScsCiAgICAgICdpbmNsdWRlJywKICAgICAgJ2NvbnRhaW5zJywKICAgICAgJ2ludm9rZScsCiAgICAgICd0b0FycmF5JywKICAgICAgJ2ZpcnN0JywKICAgICAgJ2luaXRpYWwnLAogICAgICAncmVzdCcsCiAgICAgICdsYXN0JywKICAgICAgJ3dpdGhvdXQnLAogICAgICAnaXNFbXB0eScsCiAgICAgICdwbHVjaycKICAgIF07CiAgICBfLmVhY2gobWV0aG9kcywgZnVuY3Rpb24gKG1ldGhvZCkgewogICAgICBvYmplY3RbbWV0aG9kXSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgbGlzdCA9IF8udmFsdWVzKF8ucmVzdWx0KHRoaXMsIGxpc3RQcm9wZXJ0eSkpOwogICAgICAgIHZhciBhcmdzID0gW2xpc3RdLmNvbmNhdChfLnRvQXJyYXkoYXJndW1lbnRzKSk7CiAgICAgICAgcmV0dXJuIF9bbWV0aG9kXS5hcHBseShfLCBhcmdzKTsKICAgICAgfTsKICAgIH0pOwogIH07CiAgLy8gVHJpZ2dlciBhbiBldmVudCBhbmQvb3IgYSBjb3JyZXNwb25kaW5nIG1ldGhvZCBuYW1lLiBFeGFtcGxlczoKICAvLwogIC8vIGB0aGlzLnRyaWdnZXJNZXRob2QoImZvbyIpYCB3aWxsIHRyaWdnZXIgdGhlICJmb28iIGV2ZW50IGFuZAogIC8vIGNhbGwgdGhlICJvbkZvbyIgbWV0aG9kLgogIC8vCiAgLy8gYHRoaXMudHJpZ2dlck1ldGhvZCgiZm9vOmJhciIpYCB3aWxsIHRyaWdnZXIgdGhlICJmb286YmFyIiBldmVudCBhbmQKICAvLyBjYWxsIHRoZSAib25Gb29CYXIiIG1ldGhvZC4KICBNYXJpb25ldHRlLnRyaWdnZXJNZXRob2QgPSBmdW5jdGlvbiAoZXZlbnQpIHsKICAgIC8vIHNwbGl0IHRoZSBldmVudCBuYW1lIG9uIHRoZSAiOiIKICAgIHZhciBzcGxpdHRlciA9IC8oXnw6KShcdykvZ2k7CiAgICAvLyB0YWtlIHRoZSBldmVudCBzZWN0aW9uICgic2VjdGlvbjE6c2VjdGlvbjI6c2VjdGlvbjMiKQogICAgLy8gYW5kIHR1cm4gaXQgaW4gdG8gdXBwZXJjYXNlIG5hbWUKICAgIGZ1bmN0aW9uIGdldEV2ZW50TmFtZShtYXRjaCwgcHJlZml4LCBldmVudE5hbWUpIHsKICAgICAgcmV0dXJuIGV2ZW50TmFtZS50b1VwcGVyQ2FzZSgpOwogICAgfQogICAgLy8gZ2V0IHRoZSBtZXRob2QgbmFtZSBmcm9tIHRoZSBldmVudCBuYW1lCiAgICB2YXIgbWV0aG9kTmFtZSA9ICdvbicgKyBldmVudC5yZXBsYWNlKHNwbGl0dGVyLCBnZXRFdmVudE5hbWUpOwogICAgdmFyIG1ldGhvZCA9IHRoaXNbbWV0aG9kTmFtZV07CiAgICB2YXIgcmVzdWx0OwogICAgLy8gY2FsbCB0aGUgb25NZXRob2ROYW1lIGlmIGl0IGV4aXN0cwogICAgaWYgKF8uaXNGdW5jdGlvbihtZXRob2QpKSB7CiAgICAgIC8vIHBhc3MgYWxsIGFyZ3VtZW50cywgZXhjZXB0IHRoZSBldmVudCBuYW1lCiAgICAgIHJlc3VsdCA9IG1ldGhvZC5hcHBseSh0aGlzLCBfLnRhaWwoYXJndW1lbnRzKSk7CiAgICB9CiAgICAvLyB0cmlnZ2VyIHRoZSBldmVudCwgaWYgYSB0cmlnZ2VyIG1ldGhvZCBleGlzdHMKICAgIGlmIChfLmlzRnVuY3Rpb24odGhpcy50cmlnZ2VyKSkgewogICAgICB0aGlzLnRyaWdnZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfTsKICAvLyB0cmlnZ2VyTWV0aG9kT24gaW52b2tlcyB0cmlnZ2VyTWV0aG9kIG9uIGEgc3BlY2lmaWMgY29udGV4dAogIC8vCiAgLy8gZS5nLiBgTWFyaW9uZXR0ZS50cmlnZ2VyTWV0aG9kT24odmlldywgJ3Nob3cnKWAKICAvLyB3aWxsIHRyaWdnZXIgYSAic2hvdyIgZXZlbnQgb3IgaW52b2tlIG9uU2hvdyB0aGUgdmlldy4KICBNYXJpb25ldHRlLnRyaWdnZXJNZXRob2RPbiA9IGZ1bmN0aW9uIChjb250ZXh0LCBldmVudCkgewogICAgdmFyIGFyZ3MgPSBfLnRhaWwoYXJndW1lbnRzLCAyKTsKICAgIHZhciBmbmM7CiAgICBpZiAoXy5pc0Z1bmN0aW9uKGNvbnRleHQudHJpZ2dlck1ldGhvZCkpIHsKICAgICAgZm5jID0gY29udGV4dC50cmlnZ2VyTWV0aG9kOwogICAgfSBlbHNlIHsKICAgICAgZm5jID0gTWFyaW9uZXR0ZS50cmlnZ2VyTWV0aG9kOwogICAgfQogICAgcmV0dXJuIGZuYy5hcHBseShjb250ZXh0LCBbZXZlbnRdLmNvbmNhdChhcmdzKSk7CiAgfTsKICAvLyBET01SZWZyZXNoCiAgLy8gLS0tLS0tLS0tLQogIC8vCiAgLy8gTW9uaXRvciBhIHZpZXcncyBzdGF0ZSwgYW5kIGFmdGVyIGl0IGhhcyBiZWVuIHJlbmRlcmVkIGFuZCBzaG93bgogIC8vIGluIHRoZSBET00sIHRyaWdnZXIgYSAiZG9tOnJlZnJlc2giIGV2ZW50IGV2ZXJ5IHRpbWUgaXQgaXMKICAvLyByZS1yZW5kZXJlZC4KICBNYXJpb25ldHRlLk1vbml0b3JET01SZWZyZXNoID0gZnVuY3Rpb24gKGRvY3VtZW50RWxlbWVudCkgewogICAgLy8gdHJhY2sgd2hlbiB0aGUgdmlldyBoYXMgYmVlbiBzaG93biBpbiB0aGUgRE9NLAogICAgLy8gdXNpbmcgYSBNYXJpb25ldHRlLlJlZ2lvbiAob3IgYnkgb3RoZXIgbWVhbnMgb2YgdHJpZ2dlcmluZyAic2hvdyIpCiAgICBmdW5jdGlvbiBoYW5kbGVTaG93KHZpZXcpIHsKICAgICAgdmlldy5faXNTaG93biA9IHRydWU7CiAgICAgIHRyaWdnZXJET01SZWZyZXNoKHZpZXcpOwogICAgfQogICAgLy8gdHJhY2sgd2hlbiB0aGUgdmlldyBoYXMgYmVlbiByZW5kZXJlZAogICAgZnVuY3Rpb24gaGFuZGxlUmVuZGVyKHZpZXcpIHsKICAgICAgdmlldy5faXNSZW5kZXJlZCA9IHRydWU7CiAgICAgIHRyaWdnZXJET01SZWZyZXNoKHZpZXcpOwogICAgfQogICAgLy8gVHJpZ2dlciB0aGUgImRvbTpyZWZyZXNoIiBldmVudCBhbmQgY29ycmVzcG9uZGluZyAib25Eb21SZWZyZXNoIiBtZXRob2QKICAgIGZ1bmN0aW9uIHRyaWdnZXJET01SZWZyZXNoKHZpZXcpIHsKICAgICAgaWYgKHZpZXcuX2lzU2hvd24gJiYgdmlldy5faXNSZW5kZXJlZCAmJiBpc0luRE9NKHZpZXcpKSB7CiAgICAgICAgaWYgKF8uaXNGdW5jdGlvbih2aWV3LnRyaWdnZXJNZXRob2QpKSB7CiAgICAgICAgICB2aWV3LnRyaWdnZXJNZXRob2QoJ2RvbTpyZWZyZXNoJyk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBmdW5jdGlvbiBpc0luRE9NKHZpZXcpIHsKICAgICAgcmV0dXJuIEJhY2tib25lLiQuY29udGFpbnMoZG9jdW1lbnRFbGVtZW50LCB2aWV3LmVsKTsKICAgIH0KICAgIC8vIEV4cG9ydCBwdWJsaWMgQVBJCiAgICByZXR1cm4gZnVuY3Rpb24gKHZpZXcpIHsKICAgICAgdmlldy5saXN0ZW5Ubyh2aWV3LCAnc2hvdycsIGZ1bmN0aW9uICgpIHsKICAgICAgICBoYW5kbGVTaG93KHZpZXcpOwogICAgICB9KTsKICAgICAgdmlldy5saXN0ZW5Ubyh2aWV3LCAncmVuZGVyJywgZnVuY3Rpb24gKCkgewogICAgICAgIGhhbmRsZVJlbmRlcih2aWV3KTsKICAgICAgfSk7CiAgICB9OwogIH0oZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50KTsKICAvKiBqc2hpbnQgbWF4cGFyYW1zOiA1ICovCiAgLy8gTWFyaW9uZXR0ZS5iaW5kRW50aXR5RXZlbnRzICYgdW5iaW5kRW50aXR5RXZlbnRzCiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgLy8KICAvLyBUaGVzZSBtZXRob2RzIGFyZSB1c2VkIHRvIGJpbmQvdW5iaW5kIGEgYmFja2JvbmUgImVudGl0eSIgKGNvbGxlY3Rpb24vbW9kZWwpCiAgLy8gdG8gbWV0aG9kcyBvbiBhIHRhcmdldCBvYmplY3QuCiAgLy8KICAvLyBUaGUgZmlyc3QgcGFyYW1ldGVyLCBgdGFyZ2V0YCwgbXVzdCBoYXZlIGEgYGxpc3RlblRvYCBtZXRob2QgZnJvbSB0aGUKICAvLyBFdmVudEJpbmRlciBvYmplY3QuCiAgLy8KICAvLyBUaGUgc2Vjb25kIHBhcmFtZXRlciBpcyB0aGUgZW50aXR5IChCYWNrYm9uZS5Nb2RlbCBvciBCYWNrYm9uZS5Db2xsZWN0aW9uKQogIC8vIHRvIGJpbmQgdGhlIGV2ZW50cyBmcm9tLgogIC8vCiAgLy8gVGhlIHRoaXJkIHBhcmFtZXRlciBpcyBhIGhhc2ggb2YgeyAiZXZlbnQ6bmFtZSI6ICJldmVudEhhbmRsZXIiIH0KICAvLyBjb25maWd1cmF0aW9uLiBNdWx0aXBsZSBoYW5kbGVycyBjYW4gYmUgc2VwYXJhdGVkIGJ5IGEgc3BhY2UuIEEKICAvLyBmdW5jdGlvbiBjYW4gYmUgc3VwcGxpZWQgaW5zdGVhZCBvZiBhIHN0cmluZyBoYW5kbGVyIG5hbWUuCiAgKGZ1bmN0aW9uIChNYXJpb25ldHRlKSB7CiAgICAKICAgIC8vIEJpbmQgdGhlIGV2ZW50IHRvIGhhbmRsZXJzIHNwZWNpZmllZCBhcyBhIHN0cmluZyBvZgogICAgLy8gaGFuZGxlciBuYW1lcyBvbiB0aGUgdGFyZ2V0IG9iamVjdAogICAgZnVuY3Rpb24gYmluZEZyb21TdHJpbmdzKHRhcmdldCwgZW50aXR5LCBldnQsIG1ldGhvZHMpIHsKICAgICAgdmFyIG1ldGhvZE5hbWVzID0gbWV0aG9kcy5zcGxpdCgvXHMrLyk7CiAgICAgIF8uZWFjaChtZXRob2ROYW1lcywgZnVuY3Rpb24gKG1ldGhvZE5hbWUpIHsKICAgICAgICB2YXIgbWV0aG9kID0gdGFyZ2V0W21ldGhvZE5hbWVdOwogICAgICAgIGlmICghbWV0aG9kKSB7CiAgICAgICAgICB0aHJvdyBuZXcgTWFyaW9uZXR0ZS5FcnJvcignTWV0aG9kICInICsgbWV0aG9kTmFtZSArICciIHdhcyBjb25maWd1cmVkIGFzIGFuIGV2ZW50IGhhbmRsZXIsIGJ1dCBkb2VzIG5vdCBleGlzdC4nKTsKICAgICAgICB9CiAgICAgICAgdGFyZ2V0Lmxpc3RlblRvKGVudGl0eSwgZXZ0LCBtZXRob2QpOwogICAgICB9KTsKICAgIH0KICAgIC8vIEJpbmQgdGhlIGV2ZW50IHRvIGEgc3VwcGxpZWQgY2FsbGJhY2sgZnVuY3Rpb24KICAgIGZ1bmN0aW9uIGJpbmRUb0Z1bmN0aW9uKHRhcmdldCwgZW50aXR5LCBldnQsIG1ldGhvZCkgewogICAgICB0YXJnZXQubGlzdGVuVG8oZW50aXR5LCBldnQsIG1ldGhvZCk7CiAgICB9CiAgICAvLyBCaW5kIHRoZSBldmVudCB0byBoYW5kbGVycyBzcGVjaWZpZWQgYXMgYSBzdHJpbmcgb2YKICAgIC8vIGhhbmRsZXIgbmFtZXMgb24gdGhlIHRhcmdldCBvYmplY3QKICAgIGZ1bmN0aW9uIHVuYmluZEZyb21TdHJpbmdzKHRhcmdldCwgZW50aXR5LCBldnQsIG1ldGhvZHMpIHsKICAgICAgdmFyIG1ldGhvZE5hbWVzID0gbWV0aG9kcy5zcGxpdCgvXHMrLyk7CiAgICAgIF8uZWFjaChtZXRob2ROYW1lcywgZnVuY3Rpb24gKG1ldGhvZE5hbWUpIHsKICAgICAgICB2YXIgbWV0aG9kID0gdGFyZ2V0W21ldGhvZE5hbWVdOwogICAgICAgIHRhcmdldC5zdG9wTGlzdGVuaW5nKGVudGl0eSwgZXZ0LCBtZXRob2QpOwogICAgICB9KTsKICAgIH0KICAgIC8vIEJpbmQgdGhlIGV2ZW50IHRvIGEgc3VwcGxpZWQgY2FsbGJhY2sgZnVuY3Rpb24KICAgIGZ1bmN0aW9uIHVuYmluZFRvRnVuY3Rpb24odGFyZ2V0LCBlbnRpdHksIGV2dCwgbWV0aG9kKSB7CiAgICAgIHRhcmdldC5zdG9wTGlzdGVuaW5nKGVudGl0eSwgZXZ0LCBtZXRob2QpOwogICAgfQogICAgLy8gZ2VuZXJpYyBsb29waW5nIGZ1bmN0aW9uCiAgICBmdW5jdGlvbiBpdGVyYXRlRXZlbnRzKHRhcmdldCwgZW50aXR5LCBiaW5kaW5ncywgZnVuY3Rpb25DYWxsYmFjaywgc3RyaW5nQ2FsbGJhY2spIHsKICAgICAgaWYgKCFlbnRpdHkgfHwgIWJpbmRpbmdzKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIC8vIHR5cGUtY2hlY2sgYmluZGluZ3MKICAgICAgaWYgKCFfLmlzRnVuY3Rpb24oYmluZGluZ3MpICYmICFfLmlzT2JqZWN0KGJpbmRpbmdzKSkgewogICAgICAgIHRocm93IG5ldyBNYXJpb25ldHRlLkVycm9yKHsKICAgICAgICAgIG1lc3NhZ2U6ICdCaW5kaW5ncyBtdXN0IGJlIGFuIG9iamVjdCBvciBmdW5jdGlvbi4nLAogICAgICAgICAgdXJsOiAnbWFyaW9uZXR0ZS5mdW5jdGlvbnMuaHRtbCNtYXJpb25ldHRlYmluZGVudGl0eWV2ZW50cycKICAgICAgICB9KTsKICAgICAgfQogICAgICAvLyBhbGxvdyB0aGUgYmluZGluZ3MgdG8gYmUgYSBmdW5jdGlvbgogICAgICBpZiAoXy5pc0Z1bmN0aW9uKGJpbmRpbmdzKSkgewogICAgICAgIGJpbmRpbmdzID0gYmluZGluZ3MuY2FsbCh0YXJnZXQpOwogICAgICB9CiAgICAgIC8vIGl0ZXJhdGUgdGhlIGJpbmRpbmdzIGFuZCBiaW5kIHRoZW0KICAgICAgXy5lYWNoKGJpbmRpbmdzLCBmdW5jdGlvbiAobWV0aG9kcywgZXZ0KSB7CiAgICAgICAgLy8gYWxsb3cgZm9yIGEgZnVuY3Rpb24gYXMgdGhlIGhhbmRsZXIsCiAgICAgICAgLy8gb3IgYSBsaXN0IG9mIGV2ZW50IG5hbWVzIGFzIGEgc3RyaW5nCiAgICAgICAgaWYgKF8uaXNGdW5jdGlvbihtZXRob2RzKSkgewogICAgICAgICAgZnVuY3Rpb25DYWxsYmFjayh0YXJnZXQsIGVudGl0eSwgZXZ0LCBtZXRob2RzKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgc3RyaW5nQ2FsbGJhY2sodGFyZ2V0LCBlbnRpdHksIGV2dCwgbWV0aG9kcyk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICAgIC8vIEV4cG9ydCBQdWJsaWMgQVBJCiAgICBNYXJpb25ldHRlLmJpbmRFbnRpdHlFdmVudHMgPSBmdW5jdGlvbiAodGFyZ2V0LCBlbnRpdHksIGJpbmRpbmdzKSB7CiAgICAgIGl0ZXJhdGVFdmVudHModGFyZ2V0LCBlbnRpdHksIGJpbmRpbmdzLCBiaW5kVG9GdW5jdGlvbiwgYmluZEZyb21TdHJpbmdzKTsKICAgIH07CiAgICBNYXJpb25ldHRlLnVuYmluZEVudGl0eUV2ZW50cyA9IGZ1bmN0aW9uICh0YXJnZXQsIGVudGl0eSwgYmluZGluZ3MpIHsKICAgICAgaXRlcmF0ZUV2ZW50cyh0YXJnZXQsIGVudGl0eSwgYmluZGluZ3MsIHVuYmluZFRvRnVuY3Rpb24sIHVuYmluZEZyb21TdHJpbmdzKTsKICAgIH07CiAgICAvLyBQcm94eSBgYmluZEVudGl0eUV2ZW50c2AKICAgIE1hcmlvbmV0dGUucHJveHlCaW5kRW50aXR5RXZlbnRzID0gZnVuY3Rpb24gKGVudGl0eSwgYmluZGluZ3MpIHsKICAgICAgcmV0dXJuIE1hcmlvbmV0dGUuYmluZEVudGl0eUV2ZW50cyh0aGlzLCBlbnRpdHksIGJpbmRpbmdzKTsKICAgIH07CiAgICAvLyBQcm94eSBgdW5iaW5kRW50aXR5RXZlbnRzYAogICAgTWFyaW9uZXR0ZS5wcm94eVVuYmluZEVudGl0eUV2ZW50cyA9IGZ1bmN0aW9uIChlbnRpdHksIGJpbmRpbmdzKSB7CiAgICAgIHJldHVybiBNYXJpb25ldHRlLnVuYmluZEVudGl0eUV2ZW50cyh0aGlzLCBlbnRpdHksIGJpbmRpbmdzKTsKICAgIH07CiAgfShNYXJpb25ldHRlKSk7CiAgdmFyIGVycm9yUHJvcHMgPSBbCiAgICAnZGVzY3JpcHRpb24nLAogICAgJ2ZpbGVOYW1lJywKICAgICdsaW5lTnVtYmVyJywKICAgICduYW1lJywKICAgICdtZXNzYWdlJywKICAgICdudW1iZXInCiAgXTsKICBNYXJpb25ldHRlLkVycm9yID0gTWFyaW9uZXR0ZS5leHRlbmQuY2FsbChFcnJvciwgewogICAgdXJsUm9vdDogJ2h0dHA6Ly9tYXJpb25ldHRlanMuY29tL2RvY3MvJyArIE1hcmlvbmV0dGUuVkVSU0lPTiArICcvJywKICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbiAobWVzc2FnZSwgb3B0aW9ucykgewogICAgICBpZiAoXy5pc09iamVjdChtZXNzYWdlKSkgewogICAgICAgIG9wdGlvbnMgPSBtZXNzYWdlOwogICAgICAgIG1lc3NhZ2UgPSBvcHRpb25zLm1lc3NhZ2U7CiAgICAgIH0gZWxzZSBpZiAoIW9wdGlvbnMpIHsKICAgICAgICBvcHRpb25zID0ge307CiAgICAgIH0KICAgICAgdmFyIGVycm9yID0gRXJyb3IuY2FsbCh0aGlzLCBtZXNzYWdlKTsKICAgICAgXy5leHRlbmQodGhpcywgXy5waWNrKGVycm9yLCBlcnJvclByb3BzKSwgXy5waWNrKG9wdGlvbnMsIGVycm9yUHJvcHMpKTsKICAgICAgdGhpcy5jYXB0dXJlU3RhY2tUcmFjZSgpOwogICAgICBpZiAob3B0aW9ucy51cmwpIHsKICAgICAgICB0aGlzLnVybCA9IHRoaXMudXJsUm9vdCArIG9wdGlvbnMudXJsOwogICAgICB9CiAgICB9LAogICAgY2FwdHVyZVN0YWNrVHJhY2U6IGZ1bmN0aW9uICgpIHsKICAgICAgaWYgKEVycm9yLmNhcHR1cmVTdGFja1RyYWNlKSB7CiAgICAgICAgRXJyb3IuY2FwdHVyZVN0YWNrVHJhY2UodGhpcywgTWFyaW9uZXR0ZS5FcnJvcik7CiAgICAgIH0KICAgIH0sCiAgICB0b1N0cmluZzogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gdGhpcy5uYW1lICsgJzogJyArIHRoaXMubWVzc2FnZSArICh0aGlzLnVybCA/ICcgU2VlOiAnICsgdGhpcy51cmwgOiAnJyk7CiAgICB9CiAgfSk7CiAgTWFyaW9uZXR0ZS5FcnJvci5leHRlbmQgPSBNYXJpb25ldHRlLmV4dGVuZDsKICAvLyBDYWxsYmFja3MKICAvLyAtLS0tLS0tLS0KICAvLyBBIHNpbXBsZSB3YXkgb2YgbWFuYWdpbmcgYSBjb2xsZWN0aW9uIG9mIGNhbGxiYWNrcwogIC8vIGFuZCBleGVjdXRpbmcgdGhlbSBhdCBhIGxhdGVyIHBvaW50IGluIHRpbWUsIHVzaW5nIGpRdWVyeSdzCiAgLy8gYERlZmVycmVkYCBvYmplY3QuCiAgTWFyaW9uZXR0ZS5DYWxsYmFja3MgPSBmdW5jdGlvbiAoKSB7CiAgICB0aGlzLl9kZWZlcnJlZCA9IE1hcmlvbmV0dGUuRGVmZXJyZWQoKTsKICAgIHRoaXMuX2NhbGxiYWNrcyA9IFtdOwogIH07CiAgXy5leHRlbmQoTWFyaW9uZXR0ZS5DYWxsYmFja3MucHJvdG90eXBlLCB7CiAgICAvLyBBZGQgYSBjYWxsYmFjayB0byBiZSBleGVjdXRlZC4gQ2FsbGJhY2tzIGFkZGVkIGhlcmUgYXJlCiAgICAvLyBndWFyYW50ZWVkIHRvIGV4ZWN1dGUsIGV2ZW4gaWYgdGhleSBhcmUgYWRkZWQgYWZ0ZXIgdGhlCiAgICAvLyBgcnVuYCBtZXRob2QgaXMgY2FsbGVkLgogICAgYWRkOiBmdW5jdGlvbiAoY2FsbGJhY2ssIGNvbnRleHRPdmVycmlkZSkgewogICAgICB2YXIgcHJvbWlzZSA9IF8ucmVzdWx0KHRoaXMuX2RlZmVycmVkLCAncHJvbWlzZScpOwogICAgICB0aGlzLl9jYWxsYmFja3MucHVzaCh7CiAgICAgICAgY2I6IGNhbGxiYWNrLAogICAgICAgIGN0eDogY29udGV4dE92ZXJyaWRlCiAgICAgIH0pOwogICAgICBwcm9taXNlLnRoZW4oZnVuY3Rpb24gKGFyZ3MpIHsKICAgICAgICBpZiAoY29udGV4dE92ZXJyaWRlKSB7CiAgICAgICAgICBhcmdzLmNvbnRleHQgPSBjb250ZXh0T3ZlcnJpZGU7CiAgICAgICAgfQogICAgICAgIGNhbGxiYWNrLmNhbGwoYXJncy5jb250ZXh0LCBhcmdzLm9wdGlvbnMpOwogICAgICB9KTsKICAgIH0sCiAgICAvLyBSdW4gYWxsIHJlZ2lzdGVyZWQgY2FsbGJhY2tzIHdpdGggdGhlIGNvbnRleHQgc3BlY2lmaWVkLgogICAgLy8gQWRkaXRpb25hbCBjYWxsYmFja3MgY2FuIGJlIGFkZGVkIGFmdGVyIHRoaXMgaGFzIGJlZW4gcnVuCiAgICAvLyBhbmQgdGhleSB3aWxsIHN0aWxsIGJlIGV4ZWN1dGVkLgogICAgcnVuOiBmdW5jdGlvbiAob3B0aW9ucywgY29udGV4dCkgewogICAgICB0aGlzLl9kZWZlcnJlZC5yZXNvbHZlKHsKICAgICAgICBvcHRpb25zOiBvcHRpb25zLAogICAgICAgIGNvbnRleHQ6IGNvbnRleHQKICAgICAgfSk7CiAgICB9LAogICAgLy8gUmVzZXRzIHRoZSBsaXN0IG9mIGNhbGxiYWNrcyB0byBiZSBydW4sIGFsbG93aW5nIHRoZSBzYW1lIGxpc3QKICAgIC8vIHRvIGJlIHJ1biBtdWx0aXBsZSB0aW1lcyAtIHdoZW5ldmVyIHRoZSBgcnVuYCBtZXRob2QgaXMgY2FsbGVkLgogICAgcmVzZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIGNhbGxiYWNrcyA9IHRoaXMuX2NhbGxiYWNrczsKICAgICAgdGhpcy5fZGVmZXJyZWQgPSBNYXJpb25ldHRlLkRlZmVycmVkKCk7CiAgICAgIHRoaXMuX2NhbGxiYWNrcyA9IFtdOwogICAgICBfLmVhY2goY2FsbGJhY2tzLCBmdW5jdGlvbiAoY2IpIHsKICAgICAgICB0aGlzLmFkZChjYi5jYiwgY2IuY3R4KTsKICAgICAgfSwgdGhpcyk7CiAgICB9CiAgfSk7CiAgLy8gTWFyaW9uZXR0ZSBDb250cm9sbGVyCiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgLy8KICAvLyBBIG11bHRpLXB1cnBvc2Ugb2JqZWN0IHRvIHVzZSBhcyBhIGNvbnRyb2xsZXIgZm9yCiAgLy8gbW9kdWxlcyBhbmQgcm91dGVycywgYW5kIGFzIGEgbWVkaWF0b3IgZm9yIHdvcmtmbG93CiAgLy8gYW5kIGNvb3JkaW5hdGlvbiBvZiBvdGhlciBvYmplY3RzLCB2aWV3cywgYW5kIG1vcmUuCiAgTWFyaW9uZXR0ZS5Db250cm9sbGVyID0gZnVuY3Rpb24gKG9wdGlvbnMpIHsKICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICBpZiAoXy5pc0Z1bmN0aW9uKHRoaXMuaW5pdGlhbGl6ZSkpIHsKICAgICAgdGhpcy5pbml0aWFsaXplKHRoaXMub3B0aW9ucyk7CiAgICB9CiAgfTsKICBNYXJpb25ldHRlLkNvbnRyb2xsZXIuZXh0ZW5kID0gTWFyaW9uZXR0ZS5leHRlbmQ7CiAgLy8gQ29udHJvbGxlciBNZXRob2RzCiAgLy8gLS0tLS0tLS0tLS0tLS0KICAvLyBFbnN1cmUgaXQgY2FuIHRyaWdnZXIgZXZlbnRzIHdpdGggQmFja2JvbmUuRXZlbnRzCiAgXy5leHRlbmQoTWFyaW9uZXR0ZS5Db250cm9sbGVyLnByb3RvdHlwZSwgQmFja2JvbmUuRXZlbnRzLCB7CiAgICBkZXN0cm95OiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMpOwogICAgICB0aGlzLnRyaWdnZXJNZXRob2QuYXBwbHkodGhpcywgWydiZWZvcmU6ZGVzdHJveSddLmNvbmNhdChhcmdzKSk7CiAgICAgIHRoaXMudHJpZ2dlck1ldGhvZC5hcHBseSh0aGlzLCBbJ2Rlc3Ryb3knXS5jb25jYXQoYXJncykpOwogICAgICB0aGlzLnN0b3BMaXN0ZW5pbmcoKTsKICAgICAgdGhpcy5vZmYoKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogICAgLy8gaW1wb3J0IHRoZSBgdHJpZ2dlck1ldGhvZGAgdG8gdHJpZ2dlciBldmVudHMgd2l0aCBjb3JyZXNwb25kaW5nCiAgICAvLyBtZXRob2RzIGlmIHRoZSBtZXRob2QgZXhpc3RzCiAgICB0cmlnZ2VyTWV0aG9kOiBNYXJpb25ldHRlLnRyaWdnZXJNZXRob2QsCiAgICAvLyBQcm94eSBgZ2V0T3B0aW9uYCB0byBlbmFibGUgZ2V0dGluZyBvcHRpb25zIGZyb20gdGhpcyBvciB0aGlzLm9wdGlvbnMgYnkgbmFtZS4KICAgIGdldE9wdGlvbjogTWFyaW9uZXR0ZS5wcm94eUdldE9wdGlvbgogIH0pOwogIC8vIE1hcmlvbmV0dGUgT2JqZWN0CiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgLy8KICAvLyBBIEJhc2UgQ2xhc3MgdGhhdCBvdGhlciBDbGFzc2VzIHNob3VsZCBkZXNjZW5kIGZyb20uCiAgLy8gT2JqZWN0IGJvcnJvd3MgbWFueSBjb252ZW50aW9ucyBhbmQgdXRpbGl0aWVzIGZyb20gQmFja2JvbmUuCiAgTWFyaW9uZXR0ZS5PYmplY3QgPSBmdW5jdGlvbiAob3B0aW9ucykgewogICAgdGhpcy5vcHRpb25zID0gXy5leHRlbmQoe30sIF8ucmVzdWx0KHRoaXMsICdvcHRpb25zJyksIG9wdGlvbnMpOwogICAgdGhpcy5pbml0aWFsaXplLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgfTsKICBNYXJpb25ldHRlLk9iamVjdC5leHRlbmQgPSBNYXJpb25ldHRlLmV4dGVuZDsKICAvLyBPYmplY3QgTWV0aG9kcwogIC8vIC0tLS0tLS0tLS0tLS0tCiAgXy5leHRlbmQoTWFyaW9uZXR0ZS5PYmplY3QucHJvdG90eXBlLCB7CiAgICAvL3RoaXMgaXMgYSBub29wIG1ldGhvZCBpbnRlbmRlZCB0byBiZSBvdmVycmlkZGVuIGJ5IGNsYXNzZXMgdGhhdCBleHRlbmQgZnJvbSB0aGlzIGJhc2UKICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uICgpIHsKICAgIH0sCiAgICBkZXN0cm95OiBmdW5jdGlvbiAoKSB7CiAgICAgIHRoaXMudHJpZ2dlck1ldGhvZCgnYmVmb3JlOmRlc3Ryb3knKTsKICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdkZXN0cm95Jyk7CiAgICAgIHRoaXMuc3RvcExpc3RlbmluZygpOwogICAgfSwKICAgIC8vIEltcG9ydCB0aGUgYHRyaWdnZXJNZXRob2RgIHRvIHRyaWdnZXIgZXZlbnRzIHdpdGggY29ycmVzcG9uZGluZwogICAgLy8gbWV0aG9kcyBpZiB0aGUgbWV0aG9kIGV4aXN0cwogICAgdHJpZ2dlck1ldGhvZDogTWFyaW9uZXR0ZS50cmlnZ2VyTWV0aG9kLAogICAgLy8gUHJveHkgYGdldE9wdGlvbmAgdG8gZW5hYmxlIGdldHRpbmcgb3B0aW9ucyBmcm9tIHRoaXMgb3IgdGhpcy5vcHRpb25zIGJ5IG5hbWUuCiAgICBnZXRPcHRpb246IE1hcmlvbmV0dGUucHJveHlHZXRPcHRpb24sCiAgICAvLyBQcm94eSBgdW5iaW5kRW50aXR5RXZlbnRzYCB0byBlbmFibGUgYmluZGluZyB2aWV3J3MgZXZlbnRzIGZyb20gYW5vdGhlciBlbnRpdHkuCiAgICBiaW5kRW50aXR5RXZlbnRzOiBNYXJpb25ldHRlLnByb3h5QmluZEVudGl0eUV2ZW50cywKICAgIC8vIFByb3h5IGB1bmJpbmRFbnRpdHlFdmVudHNgIHRvIGVuYWJsZSB1bmJpbmRpbmcgdmlldydzIGV2ZW50cyBmcm9tIGFub3RoZXIgZW50aXR5LgogICAgdW5iaW5kRW50aXR5RXZlbnRzOiBNYXJpb25ldHRlLnByb3h5VW5iaW5kRW50aXR5RXZlbnRzCiAgfSk7CiAgLy8gRW5zdXJlIGl0IGNhbiB0cmlnZ2VyIGV2ZW50cyB3aXRoIEJhY2tib25lLkV2ZW50cwogIF8uZXh0ZW5kKE1hcmlvbmV0dGUuT2JqZWN0LnByb3RvdHlwZSwgQmFja2JvbmUuRXZlbnRzKTsKICAvKiBqc2hpbnQgbWF4Y29tcGxleGl0eTogMTAsIG1heHN0YXRlbWVudHM6IDI5ICovCiAgLy8gUmVnaW9uCiAgLy8gLS0tLS0tCiAgLy8KICAvLyBNYW5hZ2UgdGhlIHZpc3VhbCByZWdpb25zIG9mIHlvdXIgY29tcG9zaXRlIGFwcGxpY2F0aW9uLiBTZWUKICAvLyBodHRwOi8vbG9zdGVjaGllcy5jb20vZGVyaWNrYmFpbGV5LzIwMTEvMTIvMTIvY29tcG9zaXRlLWpzLWFwcHMtcmVnaW9ucy1hbmQtcmVnaW9uLW1hbmFnZXJzLwogIE1hcmlvbmV0dGUuUmVnaW9uID0gZnVuY3Rpb24gKG9wdGlvbnMpIHsKICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICB0aGlzLmVsID0gdGhpcy5nZXRPcHRpb24oJ2VsJyk7CiAgICAvLyBIYW5kbGUgd2hlbiB0aGlzLmVsIGlzIHBhc3NlZCBpbiBhcyBhICQgd3JhcHBlZCBlbGVtZW50LgogICAgdGhpcy5lbCA9IHRoaXMuZWwgaW5zdGFuY2VvZiBCYWNrYm9uZS4kID8gdGhpcy5lbFswXSA6IHRoaXMuZWw7CiAgICBpZiAoIXRoaXMuZWwpIHsKICAgICAgdGhyb3cgbmV3IE1hcmlvbmV0dGUuRXJyb3IoewogICAgICAgIG5hbWU6ICdOb0VsRXJyb3InLAogICAgICAgIG1lc3NhZ2U6ICdBbiAiZWwiIG11c3QgYmUgc3BlY2lmaWVkIGZvciBhIHJlZ2lvbi4nCiAgICAgIH0pOwogICAgfQogICAgdGhpcy4kZWwgPSB0aGlzLmdldEVsKHRoaXMuZWwpOwogICAgaWYgKHRoaXMuaW5pdGlhbGl6ZSkgewogICAgICB2YXIgYXJncyA9IHNsaWNlLmFwcGx5KGFyZ3VtZW50cyk7CiAgICAgIHRoaXMuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmdzKTsKICAgIH0KICB9OwogIC8vIFJlZ2lvbiBDbGFzcyBtZXRob2RzCiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLQogIF8uZXh0ZW5kKE1hcmlvbmV0dGUuUmVnaW9uLCB7CiAgICAvLyBCdWlsZCBhbiBpbnN0YW5jZSBvZiBhIHJlZ2lvbiBieSBwYXNzaW5nIGluIGEgY29uZmlndXJhdGlvbiBvYmplY3QKICAgIC8vIGFuZCBhIGRlZmF1bHQgcmVnaW9uIGNsYXNzIHRvIHVzZSBpZiBub25lIGlzIHNwZWNpZmllZCBpbiB0aGUgY29uZmlnLgogICAgLy8KICAgIC8vIFRoZSBjb25maWcgb2JqZWN0IHNob3VsZCBlaXRoZXIgYmUgYSBzdHJpbmcgYXMgYSBqUXVlcnkgRE9NIHNlbGVjdG9yLAogICAgLy8gYSBSZWdpb24gY2xhc3MgZGlyZWN0bHksIG9yIGFuIG9iamVjdCBsaXRlcmFsIHRoYXQgc3BlY2lmaWVzIGJvdGgKICAgIC8vIGEgc2VsZWN0b3IgYW5kIHJlZ2lvbkNsYXNzOgogICAgLy8KICAgIC8vIGBgYGpzCiAgICAvLyB7CiAgICAvLyAgIHNlbGVjdG9yOiAiI2ZvbyIsCiAgICAvLyAgIHJlZ2lvbkNsYXNzOiBNeUN1c3RvbVJlZ2lvbgogICAgLy8gfQogICAgLy8gYGBgCiAgICAvLwogICAgYnVpbGRSZWdpb246IGZ1bmN0aW9uIChyZWdpb25Db25maWcsIERlZmF1bHRSZWdpb25DbGFzcykgewogICAgICBpZiAoXy5pc1N0cmluZyhyZWdpb25Db25maWcpKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2J1aWxkUmVnaW9uRnJvbVNlbGVjdG9yKHJlZ2lvbkNvbmZpZywgRGVmYXVsdFJlZ2lvbkNsYXNzKTsKICAgICAgfQogICAgICBpZiAocmVnaW9uQ29uZmlnLnNlbGVjdG9yIHx8IHJlZ2lvbkNvbmZpZy5lbCB8fCByZWdpb25Db25maWcucmVnaW9uQ2xhc3MpIHsKICAgICAgICByZXR1cm4gdGhpcy5fYnVpbGRSZWdpb25Gcm9tT2JqZWN0KHJlZ2lvbkNvbmZpZywgRGVmYXVsdFJlZ2lvbkNsYXNzKTsKICAgICAgfQogICAgICBpZiAoXy5pc0Z1bmN0aW9uKHJlZ2lvbkNvbmZpZykpIHsKICAgICAgICByZXR1cm4gdGhpcy5fYnVpbGRSZWdpb25Gcm9tUmVnaW9uQ2xhc3MocmVnaW9uQ29uZmlnKTsKICAgICAgfQogICAgICB0aHJvdyBuZXcgTWFyaW9uZXR0ZS5FcnJvcih7CiAgICAgICAgbWVzc2FnZTogJ0ltcHJvcGVyIHJlZ2lvbiBjb25maWd1cmF0aW9uIHR5cGUuJywKICAgICAgICB1cmw6ICdtYXJpb25ldHRlLnJlZ2lvbi5odG1sI3JlZ2lvbi1jb25maWd1cmF0aW9uLXR5cGVzJwogICAgICB9KTsKICAgIH0sCiAgICAvLyBCdWlsZCB0aGUgcmVnaW9uIGZyb20gYSBzdHJpbmcgc2VsZWN0b3IgbGlrZSAnI2Zvby1yZWdpb24nCiAgICBfYnVpbGRSZWdpb25Gcm9tU2VsZWN0b3I6IGZ1bmN0aW9uIChzZWxlY3RvciwgRGVmYXVsdFJlZ2lvbkNsYXNzKSB7CiAgICAgIHJldHVybiBuZXcgRGVmYXVsdFJlZ2lvbkNsYXNzKHsgZWw6IHNlbGVjdG9yIH0pOwogICAgfSwKICAgIC8vIEJ1aWxkIHRoZSByZWdpb24gZnJvbSBhIGNvbmZpZ3VyYXRpb24gb2JqZWN0CiAgICAvLyBgYGBqcwogICAgLy8geyBzZWxlY3RvcjogJyNmb28nLCByZWdpb25DbGFzczogRm9vUmVnaW9uIH0KICAgIC8vIGBgYAogICAgX2J1aWxkUmVnaW9uRnJvbU9iamVjdDogZnVuY3Rpb24gKHJlZ2lvbkNvbmZpZywgRGVmYXVsdFJlZ2lvbkNsYXNzKSB7CiAgICAgIHZhciBSZWdpb25DbGFzcyA9IHJlZ2lvbkNvbmZpZy5yZWdpb25DbGFzcyB8fCBEZWZhdWx0UmVnaW9uQ2xhc3M7CiAgICAgIHZhciBvcHRpb25zID0gXy5vbWl0KHJlZ2lvbkNvbmZpZywgJ3NlbGVjdG9yJywgJ3JlZ2lvbkNsYXNzJyk7CiAgICAgIGlmIChyZWdpb25Db25maWcuc2VsZWN0b3IgJiYgIW9wdGlvbnMuZWwpIHsKICAgICAgICBvcHRpb25zLmVsID0gcmVnaW9uQ29uZmlnLnNlbGVjdG9yOwogICAgICB9CiAgICAgIHZhciByZWdpb24gPSBuZXcgUmVnaW9uQ2xhc3Mob3B0aW9ucyk7CiAgICAgIC8vIG92ZXJyaWRlIHRoZSBgZ2V0RWxgIGZ1bmN0aW9uIGlmIHdlIGhhdmUgYSBwYXJlbnRFbAogICAgICAvLyB0aGlzIG11c3QgYmUgb3ZlcnJpZGRlbiB0byBlbnN1cmUgdGhlIHNlbGVjdG9yIGlzIGZvdW5kCiAgICAgIC8vIG9uIHRoZSBmaXJzdCB1c2Ugb2YgdGhlIHJlZ2lvbi4gaWYgd2UgdHJ5IHRvIGFzc2lnbiB0aGUKICAgICAgLy8gcmVnaW9uJ3MgYGVsYCB0byBgcGFyZW50RWwuZmluZChzZWxlY3RvcilgIGluIHRoZSBvYmplY3QKICAgICAgLy8gbGl0ZXJhbCB0byBidWlsZCB0aGUgcmVnaW9uLCB0aGUgZWxlbWVudCB3aWxsIG5vdCBiZQogICAgICAvLyBndWFyYW50ZWVkIHRvIGJlIGluIHRoZSBET00gYWxyZWFkeSwgYW5kIHdpbGwgY2F1c2UgcHJvYmxlbXMKICAgICAgaWYgKHJlZ2lvbkNvbmZpZy5wYXJlbnRFbCkgewogICAgICAgIHJlZ2lvbi5nZXRFbCA9IGZ1bmN0aW9uIChlbCkgewogICAgICAgICAgaWYgKF8uaXNPYmplY3QoZWwpKSB7CiAgICAgICAgICAgIHJldHVybiBCYWNrYm9uZS4kKGVsKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBwYXJlbnRFbCA9IHJlZ2lvbkNvbmZpZy5wYXJlbnRFbDsKICAgICAgICAgIGlmIChfLmlzRnVuY3Rpb24ocGFyZW50RWwpKSB7CiAgICAgICAgICAgIHBhcmVudEVsID0gcGFyZW50RWwoKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBwYXJlbnRFbC5maW5kKGVsKTsKICAgICAgICB9OwogICAgICB9CiAgICAgIHJldHVybiByZWdpb247CiAgICB9LAogICAgLy8gQnVpbGQgdGhlIHJlZ2lvbiBkaXJlY3RseSBmcm9tIGEgZ2l2ZW4gYFJlZ2lvbkNsYXNzYAogICAgX2J1aWxkUmVnaW9uRnJvbVJlZ2lvbkNsYXNzOiBmdW5jdGlvbiAoUmVnaW9uQ2xhc3MpIHsKICAgICAgcmV0dXJuIG5ldyBSZWdpb25DbGFzcygpOwogICAgfQogIH0pOwogIC8vIFJlZ2lvbiBJbnN0YW5jZSBNZXRob2RzCiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICBfLmV4dGVuZChNYXJpb25ldHRlLlJlZ2lvbi5wcm90b3R5cGUsIEJhY2tib25lLkV2ZW50cywgewogICAgLy8gRGlzcGxheXMgYSBiYWNrYm9uZSB2aWV3IGluc3RhbmNlIGluc2lkZSBvZiB0aGUgcmVnaW9uLgogICAgLy8gSGFuZGxlcyBjYWxsaW5nIHRoZSBgcmVuZGVyYCBtZXRob2QgZm9yIHlvdS4gUmVhZHMgY29udGVudAogICAgLy8gZGlyZWN0bHkgZnJvbSB0aGUgYGVsYCBhdHRyaWJ1dGUuIEFsc28gY2FsbHMgYW4gb3B0aW9uYWwKICAgIC8vIGBvblNob3dgIGFuZCBgb25EZXN0cm95YCBtZXRob2Qgb24geW91ciB2aWV3LCBqdXN0IGFmdGVyIHNob3dpbmcKICAgIC8vIG9yIGp1c3QgYmVmb3JlIGRlc3Ryb3lpbmcgdGhlIHZpZXcsIHJlc3BlY3RpdmVseS4KICAgIC8vIFRoZSBgcHJldmVudERlc3Ryb3lgIG9wdGlvbiBjYW4gYmUgdXNlZCB0byBwcmV2ZW50IGEgdmlldyBmcm9tCiAgICAvLyB0aGUgb2xkIHZpZXcgYmVpbmcgZGVzdHJveWVkIG9uIHNob3cuCiAgICAvLyBUaGUgYGZvcmNlU2hvd2Agb3B0aW9uIGNhbiBiZSB1c2VkIHRvIGZvcmNlIGEgdmlldyB0byBiZQogICAgLy8gcmUtcmVuZGVyZWQgaWYgaXQncyBhbHJlYWR5IHNob3duIGluIHRoZSByZWdpb24uCiAgICBzaG93OiBmdW5jdGlvbiAodmlldywgb3B0aW9ucykgewogICAgICB0aGlzLl9lbnN1cmVFbGVtZW50KCk7CiAgICAgIHZhciBzaG93T3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICAgIHZhciBpc0RpZmZlcmVudFZpZXcgPSB2aWV3ICE9PSB0aGlzLmN1cnJlbnRWaWV3OwogICAgICB2YXIgcHJldmVudERlc3Ryb3kgPSAhIXNob3dPcHRpb25zLnByZXZlbnREZXN0cm95OwogICAgICB2YXIgZm9yY2VTaG93ID0gISFzaG93T3B0aW9ucy5mb3JjZVNob3c7CiAgICAgIC8vIHdlIGFyZSBvbmx5IGNoYW5naW5nIHRoZSB2aWV3IGlmIHRoZXJlIGlzIGEgdmlldyB0byBjaGFuZ2UgdG8gYmVnaW4gd2l0aAogICAgICB2YXIgaXNDaGFuZ2luZ1ZpZXcgPSAhIXRoaXMuY3VycmVudFZpZXc7CiAgICAgIC8vIG9ubHkgZGVzdHJveSB0aGUgdmlldyBpZiB3ZSBkb24ndCB3YW50IHRvIHByZXZlbnREZXN0cm95IGFuZCB0aGUgdmlldyBpcyBkaWZmZXJlbnQKICAgICAgdmFyIF9zaG91bGREZXN0cm95VmlldyA9ICFwcmV2ZW50RGVzdHJveSAmJiBpc0RpZmZlcmVudFZpZXc7CiAgICAgIC8vIHNob3cgdGhlIHZpZXcgaWYgdGhlIHZpZXcgaXMgZGlmZmVyZW50IG9yIGlmIHlvdSB3YW50IHRvIHJlLXNob3cgdGhlIHZpZXcKICAgICAgdmFyIF9zaG91bGRTaG93VmlldyA9IGlzRGlmZmVyZW50VmlldyB8fCBmb3JjZVNob3c7CiAgICAgIGlmIChpc0NoYW5naW5nVmlldykgewogICAgICAgIHRoaXMudHJpZ2dlck1ldGhvZCgnYmVmb3JlOnN3YXBPdXQnLCB0aGlzLmN1cnJlbnRWaWV3KTsKICAgICAgfQogICAgICBpZiAoX3Nob3VsZERlc3Ryb3lWaWV3KSB7CiAgICAgICAgdGhpcy5lbXB0eSgpOwogICAgICB9CiAgICAgIGlmIChfc2hvdWxkU2hvd1ZpZXcpIHsKICAgICAgICAvLyBXZSBuZWVkIHRvIGxpc3RlbiBmb3IgaWYgYSB2aWV3IGlzIGRlc3Ryb3llZAogICAgICAgIC8vIGluIGEgd2F5IG90aGVyIHRoYW4gdGhyb3VnaCB0aGUgcmVnaW9uLgogICAgICAgIC8vIElmIHRoaXMgaGFwcGVucyB3ZSBuZWVkIHRvIHJlbW92ZSB0aGUgcmVmZXJlbmNlCiAgICAgICAgLy8gdG8gdGhlIGN1cnJlbnRWaWV3IHNpbmNlIG9uY2UgYSB2aWV3IGhhcyBiZWVuIGRlc3Ryb3llZAogICAgICAgIC8vIHdlIGNhbiBub3QgcmV1c2UgaXQuCiAgICAgICAgdmlldy5vbmNlKCdkZXN0cm95JywgXy5iaW5kKHRoaXMuZW1wdHksIHRoaXMpKTsKICAgICAgICB2aWV3LnJlbmRlcigpOwogICAgICAgIGlmIChpc0NoYW5naW5nVmlldykgewogICAgICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdiZWZvcmU6c3dhcCcsIHZpZXcpOwogICAgICAgIH0KICAgICAgICB0aGlzLnRyaWdnZXJNZXRob2QoJ2JlZm9yZTpzaG93Jywgdmlldyk7CiAgICAgICAgTWFyaW9uZXR0ZS50cmlnZ2VyTWV0aG9kT24odmlldywgJ2JlZm9yZTpzaG93Jyk7CiAgICAgICAgaWYgKGlzQ2hhbmdpbmdWaWV3KSB7CiAgICAgICAgICB0aGlzLnRyaWdnZXJNZXRob2QoJ3N3YXBPdXQnLCB0aGlzLmN1cnJlbnRWaWV3KTsKICAgICAgICB9CiAgICAgICAgdGhpcy5hdHRhY2hIdG1sKHZpZXcpOwogICAgICAgIHRoaXMuY3VycmVudFZpZXcgPSB2aWV3OwogICAgICAgIGlmIChpc0NoYW5naW5nVmlldykgewogICAgICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdzd2FwJywgdmlldyk7CiAgICAgICAgfQogICAgICAgIHRoaXMudHJpZ2dlck1ldGhvZCgnc2hvdycsIHZpZXcpOwogICAgICAgIE1hcmlvbmV0dGUudHJpZ2dlck1ldGhvZE9uKHZpZXcsICdzaG93Jyk7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogICAgX2Vuc3VyZUVsZW1lbnQ6IGZ1bmN0aW9uICgpIHsKICAgICAgaWYgKCFfLmlzT2JqZWN0KHRoaXMuZWwpKSB7CiAgICAgICAgdGhpcy4kZWwgPSB0aGlzLmdldEVsKHRoaXMuZWwpOwogICAgICAgIHRoaXMuZWwgPSB0aGlzLiRlbFswXTsKICAgICAgfQogICAgICBpZiAoIXRoaXMuJGVsIHx8IHRoaXMuJGVsLmxlbmd0aCA9PT0gMCkgewogICAgICAgIHRocm93IG5ldyBNYXJpb25ldHRlLkVycm9yKCdBbiAiZWwiICcgKyB0aGlzLiRlbC5zZWxlY3RvciArICcgbXVzdCBleGlzdCBpbiBET00nKTsKICAgICAgfQogICAgfSwKICAgIC8vIE92ZXJyaWRlIHRoaXMgbWV0aG9kIHRvIGNoYW5nZSBob3cgdGhlIHJlZ2lvbiBmaW5kcyB0aGUKICAgIC8vIERPTSBlbGVtZW50IHRoYXQgaXQgbWFuYWdlcy4gUmV0dXJuIGEgalF1ZXJ5IHNlbGVjdG9yIG9iamVjdC4KICAgIGdldEVsOiBmdW5jdGlvbiAoZWwpIHsKICAgICAgcmV0dXJuIEJhY2tib25lLiQoZWwpOwogICAgfSwKICAgIC8vIE92ZXJyaWRlIHRoaXMgbWV0aG9kIHRvIGNoYW5nZSBob3cgdGhlIG5ldyB2aWV3IGlzCiAgICAvLyBhcHBlbmRlZCB0byB0aGUgYCRlbGAgdGhhdCB0aGUgcmVnaW9uIGlzIG1hbmFnaW5nCiAgICBhdHRhY2hIdG1sOiBmdW5jdGlvbiAodmlldykgewogICAgICAvLyBlbXB0eSB0aGUgbm9kZSBhbmQgYXBwZW5kIG5ldyB2aWV3CiAgICAgIHRoaXMuZWwuaW5uZXJIVE1MID0gJyc7CiAgICAgIHRoaXMuZWwuYXBwZW5kQ2hpbGQodmlldy5lbCk7CiAgICB9LAogICAgLy8gRGVzdHJveSB0aGUgY3VycmVudCB2aWV3LCBpZiB0aGVyZSBpcyBvbmUuIElmIHRoZXJlIGlzIG5vCiAgICAvLyBjdXJyZW50IHZpZXcsIGl0IGRvZXMgbm90aGluZyBhbmQgcmV0dXJucyBpbW1lZGlhdGVseS4KICAgIGVtcHR5OiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciB2aWV3ID0gdGhpcy5jdXJyZW50VmlldzsKICAgICAgLy8gSWYgdGhlcmUgaXMgbm8gdmlldyBpbiB0aGUgcmVnaW9uCiAgICAgIC8vIHdlIHNob3VsZCBub3QgcmVtb3ZlIGFueXRoaW5nCiAgICAgIGlmICghdmlldykgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICB0aGlzLnRyaWdnZXJNZXRob2QoJ2JlZm9yZTplbXB0eScsIHZpZXcpOwogICAgICB0aGlzLl9kZXN0cm95VmlldygpOwogICAgICB0aGlzLnRyaWdnZXJNZXRob2QoJ2VtcHR5Jywgdmlldyk7CiAgICAgIC8vIFJlbW92ZSByZWdpb24gcG9pbnRlciB0byB0aGUgY3VycmVudFZpZXcKICAgICAgZGVsZXRlIHRoaXMuY3VycmVudFZpZXc7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAgIC8vIGNhbGwgJ2Rlc3Ryb3knIG9yICdyZW1vdmUnLCBkZXBlbmRpbmcgb24gd2hpY2ggaXMgZm91bmQKICAgIC8vIG9uIHRoZSB2aWV3IChpZiBzaG93aW5nIGEgcmF3IEJhY2tib25lIHZpZXcgb3IgYSBNYXJpb25ldHRlIFZpZXcpCiAgICBfZGVzdHJveVZpZXc6IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIHZpZXcgPSB0aGlzLmN1cnJlbnRWaWV3OwogICAgICBpZiAodmlldy5kZXN0cm95ICYmICF2aWV3LmlzRGVzdHJveWVkKSB7CiAgICAgICAgdmlldy5kZXN0cm95KCk7CiAgICAgIH0gZWxzZSBpZiAodmlldy5yZW1vdmUpIHsKICAgICAgICB2aWV3LnJlbW92ZSgpOwogICAgICB9CiAgICB9LAogICAgLy8gQXR0YWNoIGFuIGV4aXN0aW5nIHZpZXcgdG8gdGhlIHJlZ2lvbi4gVGhpcwogICAgLy8gd2lsbCBub3QgY2FsbCBgcmVuZGVyYCBvciBgb25TaG93YCBmb3IgdGhlIG5ldyB2aWV3LAogICAgLy8gYW5kIHdpbGwgbm90IHJlcGxhY2UgdGhlIGN1cnJlbnQgSFRNTCBmb3IgdGhlIGBlbGAKICAgIC8vIG9mIHRoZSByZWdpb24uCiAgICBhdHRhY2hWaWV3OiBmdW5jdGlvbiAodmlldykgewogICAgICB0aGlzLmN1cnJlbnRWaWV3ID0gdmlldzsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogICAgLy8gQ2hlY2tzIHdoZXRoZXIgYSB2aWV3IGlzIGN1cnJlbnRseSBwcmVzZW50IHdpdGhpbgogICAgLy8gdGhlIHJlZ2lvbi4gUmV0dXJucyBgdHJ1ZWAgaWYgdGhlcmUgaXMgYW5kIGBmYWxzZWAgaWYKICAgIC8vIG5vIHZpZXcgaXMgcHJlc2VudC4KICAgIGhhc1ZpZXc6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuICEhdGhpcy5jdXJyZW50VmlldzsKICAgIH0sCiAgICAvLyBSZXNldCB0aGUgcmVnaW9uIGJ5IGRlc3Ryb3lpbmcgYW55IGV4aXN0aW5nIHZpZXcgYW5kCiAgICAvLyBjbGVhcmluZyBvdXQgdGhlIGNhY2hlZCBgJGVsYC4gVGhlIG5leHQgdGltZSBhIHZpZXcKICAgIC8vIGlzIHNob3duIHZpYSB0aGlzIHJlZ2lvbiwgdGhlIHJlZ2lvbiB3aWxsIHJlLXF1ZXJ5IHRoZQogICAgLy8gRE9NIGZvciB0aGUgcmVnaW9uJ3MgYGVsYC4KICAgIHJlc2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgIHRoaXMuZW1wdHkoKTsKICAgICAgaWYgKHRoaXMuJGVsKSB7CiAgICAgICAgdGhpcy5lbCA9IHRoaXMuJGVsLnNlbGVjdG9yOwogICAgICB9CiAgICAgIGRlbGV0ZSB0aGlzLiRlbDsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogICAgLy8gUHJveHkgYGdldE9wdGlvbmAgdG8gZW5hYmxlIGdldHRpbmcgb3B0aW9ucyBmcm9tIHRoaXMgb3IgdGhpcy5vcHRpb25zIGJ5IG5hbWUuCiAgICBnZXRPcHRpb246IE1hcmlvbmV0dGUucHJveHlHZXRPcHRpb24sCiAgICAvLyBpbXBvcnQgdGhlIGB0cmlnZ2VyTWV0aG9kYCB0byB0cmlnZ2VyIGV2ZW50cyB3aXRoIGNvcnJlc3BvbmRpbmcKICAgIC8vIG1ldGhvZHMgaWYgdGhlIG1ldGhvZCBleGlzdHMKICAgIHRyaWdnZXJNZXRob2Q6IE1hcmlvbmV0dGUudHJpZ2dlck1ldGhvZAogIH0pOwogIC8vIENvcHkgdGhlIGBleHRlbmRgIGZ1bmN0aW9uIHVzZWQgYnkgQmFja2JvbmUncyBjbGFzc2VzCiAgTWFyaW9uZXR0ZS5SZWdpb24uZXh0ZW5kID0gTWFyaW9uZXR0ZS5leHRlbmQ7CiAgLy8gTWFyaW9uZXR0ZS5SZWdpb25NYW5hZ2VyCiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgLy8KICAvLyBNYW5hZ2Ugb25lIG9yIG1vcmUgcmVsYXRlZCBgTWFyaW9uZXR0ZS5SZWdpb25gIG9iamVjdHMuCiAgTWFyaW9uZXR0ZS5SZWdpb25NYW5hZ2VyID0gZnVuY3Rpb24gKE1hcmlvbmV0dGUpIHsKICAgIHZhciBSZWdpb25NYW5hZ2VyID0gTWFyaW9uZXR0ZS5Db250cm9sbGVyLmV4dGVuZCh7CiAgICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbiAob3B0aW9ucykgewogICAgICAgIHRoaXMuX3JlZ2lvbnMgPSB7fTsKICAgICAgICBNYXJpb25ldHRlLkNvbnRyb2xsZXIuY2FsbCh0aGlzLCBvcHRpb25zKTsKICAgICAgfSwKICAgICAgLy8gQWRkIG11bHRpcGxlIHJlZ2lvbnMgdXNpbmcgYW4gb2JqZWN0IGxpdGVyYWwgb3IgYQogICAgICAvLyBmdW5jdGlvbiB0aGF0IHJldHVybnMgYW4gb2JqZWN0IGxpdGVyYWwsIHdoZXJlCiAgICAgIC8vIGVhY2gga2V5IGJlY29tZXMgdGhlIHJlZ2lvbiBuYW1lLCBhbmQgZWFjaCB2YWx1ZSBpcwogICAgICAvLyB0aGUgcmVnaW9uIGRlZmluaXRpb24uCiAgICAgIGFkZFJlZ2lvbnM6IGZ1bmN0aW9uIChyZWdpb25EZWZpbml0aW9ucywgZGVmYXVsdHMpIHsKICAgICAgICBpZiAoXy5pc0Z1bmN0aW9uKHJlZ2lvbkRlZmluaXRpb25zKSkgewogICAgICAgICAgcmVnaW9uRGVmaW5pdGlvbnMgPSByZWdpb25EZWZpbml0aW9ucy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgIH0KICAgICAgICB2YXIgcmVnaW9ucyA9IHt9OwogICAgICAgIF8uZWFjaChyZWdpb25EZWZpbml0aW9ucywgZnVuY3Rpb24gKGRlZmluaXRpb24sIG5hbWUpIHsKICAgICAgICAgIGlmIChfLmlzU3RyaW5nKGRlZmluaXRpb24pKSB7CiAgICAgICAgICAgIGRlZmluaXRpb24gPSB7IHNlbGVjdG9yOiBkZWZpbml0aW9uIH07CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZGVmaW5pdGlvbi5zZWxlY3RvcikgewogICAgICAgICAgICBkZWZpbml0aW9uID0gXy5kZWZhdWx0cyh7fSwgZGVmaW5pdGlvbiwgZGVmYXVsdHMpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHJlZ2lvbiA9IHRoaXMuYWRkUmVnaW9uKG5hbWUsIGRlZmluaXRpb24pOwogICAgICAgICAgcmVnaW9uc1tuYW1lXSA9IHJlZ2lvbjsKICAgICAgICB9LCB0aGlzKTsKICAgICAgICByZXR1cm4gcmVnaW9uczsKICAgICAgfSwKICAgICAgLy8gQWRkIGFuIGluZGl2aWR1YWwgcmVnaW9uIHRvIHRoZSByZWdpb24gbWFuYWdlciwKICAgICAgLy8gYW5kIHJldHVybiB0aGUgcmVnaW9uIGluc3RhbmNlCiAgICAgIGFkZFJlZ2lvbjogZnVuY3Rpb24gKG5hbWUsIGRlZmluaXRpb24pIHsKICAgICAgICB2YXIgcmVnaW9uOwogICAgICAgIGlmIChkZWZpbml0aW9uIGluc3RhbmNlb2YgTWFyaW9uZXR0ZS5SZWdpb24pIHsKICAgICAgICAgIHJlZ2lvbiA9IGRlZmluaXRpb247CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJlZ2lvbiA9IE1hcmlvbmV0dGUuUmVnaW9uLmJ1aWxkUmVnaW9uKGRlZmluaXRpb24sIE1hcmlvbmV0dGUuUmVnaW9uKTsKICAgICAgICB9CiAgICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdiZWZvcmU6YWRkOnJlZ2lvbicsIG5hbWUsIHJlZ2lvbik7CiAgICAgICAgdGhpcy5fc3RvcmUobmFtZSwgcmVnaW9uKTsKICAgICAgICB0aGlzLnRyaWdnZXJNZXRob2QoJ2FkZDpyZWdpb24nLCBuYW1lLCByZWdpb24pOwogICAgICAgIHJldHVybiByZWdpb247CiAgICAgIH0sCiAgICAgIC8vIEdldCBhIHJlZ2lvbiBieSBuYW1lCiAgICAgIGdldDogZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICByZXR1cm4gdGhpcy5fcmVnaW9uc1tuYW1lXTsKICAgICAgfSwKICAgICAgLy8gR2V0cyBhbGwgdGhlIHJlZ2lvbnMgY29udGFpbmVkIHdpdGhpbgogICAgICAvLyB0aGUgYHJlZ2lvbk1hbmFnZXJgIGluc3RhbmNlLgogICAgICBnZXRSZWdpb25zOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIF8uY2xvbmUodGhpcy5fcmVnaW9ucyk7CiAgICAgIH0sCiAgICAgIC8vIFJlbW92ZSBhIHJlZ2lvbiBieSBuYW1lCiAgICAgIHJlbW92ZVJlZ2lvbjogZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICB2YXIgcmVnaW9uID0gdGhpcy5fcmVnaW9uc1tuYW1lXTsKICAgICAgICB0aGlzLl9yZW1vdmUobmFtZSwgcmVnaW9uKTsKICAgICAgICByZXR1cm4gcmVnaW9uOwogICAgICB9LAogICAgICAvLyBFbXB0eSBhbGwgcmVnaW9ucyBpbiB0aGUgcmVnaW9uIG1hbmFnZXIsIGFuZAogICAgICAvLyByZW1vdmUgdGhlbQogICAgICByZW1vdmVSZWdpb25zOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIHJlZ2lvbnMgPSB0aGlzLmdldFJlZ2lvbnMoKTsKICAgICAgICBfLmVhY2godGhpcy5fcmVnaW9ucywgZnVuY3Rpb24gKHJlZ2lvbiwgbmFtZSkgewogICAgICAgICAgdGhpcy5fcmVtb3ZlKG5hbWUsIHJlZ2lvbik7CiAgICAgICAgfSwgdGhpcyk7CiAgICAgICAgcmV0dXJuIHJlZ2lvbnM7CiAgICAgIH0sCiAgICAgIC8vIEVtcHR5IGFsbCByZWdpb25zIGluIHRoZSByZWdpb24gbWFuYWdlciwgYnV0CiAgICAgIC8vIGxlYXZlIHRoZW0gYXR0YWNoZWQKICAgICAgZW1wdHlSZWdpb25zOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIHJlZ2lvbnMgPSB0aGlzLmdldFJlZ2lvbnMoKTsKICAgICAgICBfLmVhY2gocmVnaW9ucywgZnVuY3Rpb24gKHJlZ2lvbikgewogICAgICAgICAgcmVnaW9uLmVtcHR5KCk7CiAgICAgICAgfSwgdGhpcyk7CiAgICAgICAgcmV0dXJuIHJlZ2lvbnM7CiAgICAgIH0sCiAgICAgIC8vIERlc3Ryb3kgYWxsIHJlZ2lvbnMgYW5kIHNodXQgZG93biB0aGUgcmVnaW9uCiAgICAgIC8vIG1hbmFnZXIgZW50aXJlbHkKICAgICAgZGVzdHJveTogZnVuY3Rpb24gKCkgewogICAgICAgIHRoaXMucmVtb3ZlUmVnaW9ucygpOwogICAgICAgIHJldHVybiBNYXJpb25ldHRlLkNvbnRyb2xsZXIucHJvdG90eXBlLmRlc3Ryb3kuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfSwKICAgICAgLy8gaW50ZXJuYWwgbWV0aG9kIHRvIHN0b3JlIHJlZ2lvbnMKICAgICAgX3N0b3JlOiBmdW5jdGlvbiAobmFtZSwgcmVnaW9uKSB7CiAgICAgICAgdGhpcy5fcmVnaW9uc1tuYW1lXSA9IHJlZ2lvbjsKICAgICAgICB0aGlzLl9zZXRMZW5ndGgoKTsKICAgICAgfSwKICAgICAgLy8gaW50ZXJuYWwgbWV0aG9kIHRvIHJlbW92ZSBhIHJlZ2lvbgogICAgICBfcmVtb3ZlOiBmdW5jdGlvbiAobmFtZSwgcmVnaW9uKSB7CiAgICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdiZWZvcmU6cmVtb3ZlOnJlZ2lvbicsIG5hbWUsIHJlZ2lvbik7CiAgICAgICAgcmVnaW9uLmVtcHR5KCk7CiAgICAgICAgcmVnaW9uLnN0b3BMaXN0ZW5pbmcoKTsKICAgICAgICBkZWxldGUgdGhpcy5fcmVnaW9uc1tuYW1lXTsKICAgICAgICB0aGlzLl9zZXRMZW5ndGgoKTsKICAgICAgICB0aGlzLnRyaWdnZXJNZXRob2QoJ3JlbW92ZTpyZWdpb24nLCBuYW1lLCByZWdpb24pOwogICAgICB9LAogICAgICAvLyBzZXQgdGhlIG51bWJlciBvZiByZWdpb25zIGN1cnJlbnQgaGVsZAogICAgICBfc2V0TGVuZ3RoOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgdGhpcy5sZW5ndGggPSBfLnNpemUodGhpcy5fcmVnaW9ucyk7CiAgICAgIH0KICAgIH0pOwogICAgTWFyaW9uZXR0ZS5hY3RBc0NvbGxlY3Rpb24oUmVnaW9uTWFuYWdlci5wcm90b3R5cGUsICdfcmVnaW9ucycpOwogICAgcmV0dXJuIFJlZ2lvbk1hbmFnZXI7CiAgfShNYXJpb25ldHRlKTsKICAvLyBUZW1wbGF0ZSBDYWNoZQogIC8vIC0tLS0tLS0tLS0tLS0tCiAgLy8gTWFuYWdlIHRlbXBsYXRlcyBzdG9yZWQgaW4gYDxzY3JpcHQ+YCBibG9ja3MsCiAgLy8gY2FjaGluZyB0aGVtIGZvciBmYXN0ZXIgYWNjZXNzLgogIE1hcmlvbmV0dGUuVGVtcGxhdGVDYWNoZSA9IGZ1bmN0aW9uICh0ZW1wbGF0ZUlkKSB7CiAgICB0aGlzLnRlbXBsYXRlSWQgPSB0ZW1wbGF0ZUlkOwogIH07CiAgLy8gVGVtcGxhdGVDYWNoZSBvYmplY3QtbGV2ZWwgbWV0aG9kcy4gTWFuYWdlIHRoZSB0ZW1wbGF0ZQogIC8vIGNhY2hlcyBmcm9tIHRoZXNlIG1ldGhvZCBjYWxscyBpbnN0ZWFkIG9mIGNyZWF0aW5nCiAgLy8geW91ciBvd24gVGVtcGxhdGVDYWNoZSBpbnN0YW5jZXMKICBfLmV4dGVuZChNYXJpb25ldHRlLlRlbXBsYXRlQ2FjaGUsIHsKICAgIHRlbXBsYXRlQ2FjaGVzOiB7fSwKICAgIC8vIEdldCB0aGUgc3BlY2lmaWVkIHRlbXBsYXRlIGJ5IGlkLiBFaXRoZXIKICAgIC8vIHJldHJpZXZlcyB0aGUgY2FjaGVkIHZlcnNpb24sIG9yIGxvYWRzIGl0CiAgICAvLyBmcm9tIHRoZSBET00uCiAgICBnZXQ6IGZ1bmN0aW9uICh0ZW1wbGF0ZUlkKSB7CiAgICAgIHZhciBjYWNoZWRUZW1wbGF0ZSA9IHRoaXMudGVtcGxhdGVDYWNoZXNbdGVtcGxhdGVJZF07CiAgICAgIGlmICghY2FjaGVkVGVtcGxhdGUpIHsKICAgICAgICBjYWNoZWRUZW1wbGF0ZSA9IG5ldyBNYXJpb25ldHRlLlRlbXBsYXRlQ2FjaGUodGVtcGxhdGVJZCk7CiAgICAgICAgdGhpcy50ZW1wbGF0ZUNhY2hlc1t0ZW1wbGF0ZUlkXSA9IGNhY2hlZFRlbXBsYXRlOwogICAgICB9CiAgICAgIHJldHVybiBjYWNoZWRUZW1wbGF0ZS5sb2FkKCk7CiAgICB9LAogICAgLy8gQ2xlYXIgdGVtcGxhdGVzIGZyb20gdGhlIGNhY2hlLiBJZiBubyBhcmd1bWVudHMKICAgIC8vIGFyZSBzcGVjaWZpZWQsIGNsZWFycyBhbGwgdGVtcGxhdGVzOgogICAgLy8gYGNsZWFyKClgCiAgICAvLwogICAgLy8gSWYgYXJndW1lbnRzIGFyZSBzcGVjaWZpZWQsIGNsZWFycyBlYWNoIG9mIHRoZQogICAgLy8gc3BlY2lmaWVkIHRlbXBsYXRlcyBmcm9tIHRoZSBjYWNoZToKICAgIC8vIGBjbGVhcigiI3QxIiwgIiN0MiIsICIuLi4iKWAKICAgIGNsZWFyOiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBpOwogICAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzKTsKICAgICAgdmFyIGxlbmd0aCA9IGFyZ3MubGVuZ3RoOwogICAgICBpZiAobGVuZ3RoID4gMCkgewogICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgZGVsZXRlIHRoaXMudGVtcGxhdGVDYWNoZXNbYXJnc1tpXV07CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMudGVtcGxhdGVDYWNoZXMgPSB7fTsKICAgICAgfQogICAgfQogIH0pOwogIC8vIFRlbXBsYXRlQ2FjaGUgaW5zdGFuY2UgbWV0aG9kcywgYWxsb3dpbmcgZWFjaAogIC8vIHRlbXBsYXRlIGNhY2hlIG9iamVjdCB0byBtYW5hZ2UgaXRzIG93biBzdGF0ZQogIC8vIGFuZCBrbm93IHdoZXRoZXIgb3Igbm90IGl0IGhhcyBiZWVuIGxvYWRlZAogIF8uZXh0ZW5kKE1hcmlvbmV0dGUuVGVtcGxhdGVDYWNoZS5wcm90b3R5cGUsIHsKICAgIC8vIEludGVybmFsIG1ldGhvZCB0byBsb2FkIHRoZSB0ZW1wbGF0ZQogICAgbG9hZDogZnVuY3Rpb24gKCkgewogICAgICAvLyBHdWFyZCBjbGF1c2UgdG8gcHJldmVudCBsb2FkaW5nIHRoaXMgdGVtcGxhdGUgbW9yZSB0aGFuIG9uY2UKICAgICAgaWYgKHRoaXMuY29tcGlsZWRUZW1wbGF0ZSkgewogICAgICAgIHJldHVybiB0aGlzLmNvbXBpbGVkVGVtcGxhdGU7CiAgICAgIH0KICAgICAgLy8gTG9hZCB0aGUgdGVtcGxhdGUgYW5kIGNvbXBpbGUgaXQKICAgICAgdmFyIHRlbXBsYXRlID0gdGhpcy5sb2FkVGVtcGxhdGUodGhpcy50ZW1wbGF0ZUlkKTsKICAgICAgdGhpcy5jb21waWxlZFRlbXBsYXRlID0gdGhpcy5jb21waWxlVGVtcGxhdGUodGVtcGxhdGUpOwogICAgICByZXR1cm4gdGhpcy5jb21waWxlZFRlbXBsYXRlOwogICAgfSwKICAgIC8vIExvYWQgYSB0ZW1wbGF0ZSBmcm9tIHRoZSBET00sIGJ5IGRlZmF1bHQuIE92ZXJyaWRlCiAgICAvLyB0aGlzIG1ldGhvZCB0byBwcm92aWRlIHlvdXIgb3duIHRlbXBsYXRlIHJldHJpZXZhbAogICAgLy8gRm9yIGFzeW5jaHJvbm91cyBsb2FkaW5nIHdpdGggQU1EL1JlcXVpcmVKUywgY29uc2lkZXIKICAgIC8vIHVzaW5nIGEgdGVtcGxhdGUtbG9hZGVyIHBsdWdpbiBhcyBkZXNjcmliZWQgaGVyZToKICAgIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS9tYXJpb25ldHRlanMvYmFja2JvbmUubWFyaW9uZXR0ZS93aWtpL1VzaW5nLW1hcmlvbmV0dGUtd2l0aC1yZXF1aXJlanMKICAgIGxvYWRUZW1wbGF0ZTogZnVuY3Rpb24gKHRlbXBsYXRlSWQpIHsKICAgICAgdmFyIHRlbXBsYXRlID0gQmFja2JvbmUuJCh0ZW1wbGF0ZUlkKS5odG1sKCk7CiAgICAgIGlmICghdGVtcGxhdGUgfHwgdGVtcGxhdGUubGVuZ3RoID09PSAwKSB7CiAgICAgICAgdGhyb3cgbmV3IE1hcmlvbmV0dGUuRXJyb3IoewogICAgICAgICAgbmFtZTogJ05vVGVtcGxhdGVFcnJvcicsCiAgICAgICAgICBtZXNzYWdlOiAnQ291bGQgbm90IGZpbmQgdGVtcGxhdGU6ICInICsgdGVtcGxhdGVJZCArICciJwogICAgICAgIH0pOwogICAgICB9CiAgICAgIHJldHVybiB0ZW1wbGF0ZTsKICAgIH0sCiAgICAvLyBQcmUtY29tcGlsZSB0aGUgdGVtcGxhdGUgYmVmb3JlIGNhY2hpbmcgaXQuIE92ZXJyaWRlCiAgICAvLyB0aGlzIG1ldGhvZCBpZiB5b3UgZG8gbm90IG5lZWQgdG8gcHJlLWNvbXBpbGUgYSB0ZW1wbGF0ZQogICAgLy8gKEpTVCAvIFJlcXVpcmVKUyBmb3IgZXhhbXBsZSkgb3IgaWYgeW91IHdhbnQgdG8gY2hhbmdlCiAgICAvLyB0aGUgdGVtcGxhdGUgZW5naW5lIHVzZWQgKEhhbmRlYmFycywgZXRjKS4KICAgIGNvbXBpbGVUZW1wbGF0ZTogZnVuY3Rpb24gKHJhd1RlbXBsYXRlKSB7CiAgICAgIHJldHVybiBfLnRlbXBsYXRlKHJhd1RlbXBsYXRlKTsKICAgIH0KICB9KTsKICAvLyBSZW5kZXJlcgogIC8vIC0tLS0tLS0tCiAgLy8gUmVuZGVyIGEgdGVtcGxhdGUgd2l0aCBkYXRhIGJ5IHBhc3NpbmcgaW4gdGhlIHRlbXBsYXRlCiAgLy8gc2VsZWN0b3IgYW5kIHRoZSBkYXRhIHRvIHJlbmRlci4KICBNYXJpb25ldHRlLlJlbmRlcmVyID0gewogICAgLy8gUmVuZGVyIGEgdGVtcGxhdGUgd2l0aCBkYXRhLiBUaGUgYHRlbXBsYXRlYCBwYXJhbWV0ZXIgaXMKICAgIC8vIHBhc3NlZCB0byB0aGUgYFRlbXBsYXRlQ2FjaGVgIG9iamVjdCB0byByZXRyaWV2ZSB0aGUKICAgIC8vIHRlbXBsYXRlIGZ1bmN0aW9uLiBPdmVycmlkZSB0aGlzIG1ldGhvZCB0byBwcm92aWRlIHlvdXIgb3duCiAgICAvLyBjdXN0b20gcmVuZGVyaW5nIGFuZCB0ZW1wbGF0ZSBoYW5kbGluZyBmb3IgYWxsIG9mIE1hcmlvbmV0dGUuCiAgICByZW5kZXI6IGZ1bmN0aW9uICh0ZW1wbGF0ZSwgZGF0YSkgewogICAgICBpZiAoIXRlbXBsYXRlKSB7CiAgICAgICAgdGhyb3cgbmV3IE1hcmlvbmV0dGUuRXJyb3IoewogICAgICAgICAgbmFtZTogJ1RlbXBsYXRlTm90Rm91bmRFcnJvcicsCiAgICAgICAgICBtZXNzYWdlOiAnQ2Fubm90IHJlbmRlciB0aGUgdGVtcGxhdGUgc2luY2UgaXRzIGZhbHNlLCBudWxsIG9yIHVuZGVmaW5lZC4nCiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgdmFyIHRlbXBsYXRlRnVuYzsKICAgICAgaWYgKHR5cGVvZiB0ZW1wbGF0ZSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgIHRlbXBsYXRlRnVuYyA9IHRlbXBsYXRlOwogICAgICB9IGVsc2UgewogICAgICAgIHRlbXBsYXRlRnVuYyA9IE1hcmlvbmV0dGUuVGVtcGxhdGVDYWNoZS5nZXQodGVtcGxhdGUpOwogICAgICB9CiAgICAgIHJldHVybiB0ZW1wbGF0ZUZ1bmMoZGF0YSk7CiAgICB9CiAgfTsKICAvKiBqc2hpbnQgbWF4bGVuOiAxMTQsIG5vbmV3OiBmYWxzZSAqLwogIC8vIE1hcmlvbmV0dGUuVmlldwogIC8vIC0tLS0tLS0tLS0tLS0tLQogIC8vIFRoZSBjb3JlIHZpZXcgY2xhc3MgdGhhdCBvdGhlciBNYXJpb25ldHRlIHZpZXdzIGV4dGVuZCBmcm9tLgogIE1hcmlvbmV0dGUuVmlldyA9IEJhY2tib25lLlZpZXcuZXh0ZW5kKHsKICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbiAob3B0aW9ucykgewogICAgICBfLmJpbmRBbGwodGhpcywgJ3JlbmRlcicpOwogICAgICAvLyB0aGlzIGV4cG9zZXMgdmlldyBvcHRpb25zIHRvIHRoZSB2aWV3IGluaXRpYWxpemVyCiAgICAgIC8vIHRoaXMgaXMgYSBiYWNrZmlsbCBzaW5jZSBiYWNrYm9uZSByZW1vdmVkIHRoZSBhc3NpZ25tZW50CiAgICAgIC8vIG9mIHRoaXMub3B0aW9ucwogICAgICAvLyBhdCBzb21lIHBvaW50IGhvd2V2ZXIgdGhpcyBtYXkgYmUgcmVtb3ZlZAogICAgICB0aGlzLm9wdGlvbnMgPSBfLmV4dGVuZCh7fSwgXy5yZXN1bHQodGhpcywgJ29wdGlvbnMnKSwgXy5pc0Z1bmN0aW9uKG9wdGlvbnMpID8gb3B0aW9ucy5jYWxsKHRoaXMpIDogb3B0aW9ucyk7CiAgICAgIHRoaXMuX2JlaGF2aW9ycyA9IE1hcmlvbmV0dGUuQmVoYXZpb3JzKHRoaXMpOwogICAgICBCYWNrYm9uZS5WaWV3LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIE1hcmlvbmV0dGUuTW9uaXRvckRPTVJlZnJlc2godGhpcyk7CiAgICAgIHRoaXMubGlzdGVuVG8odGhpcywgJ3Nob3cnLCB0aGlzLm9uU2hvd0NhbGxlZCk7CiAgICB9LAogICAgLy8gR2V0IHRoZSB0ZW1wbGF0ZSBmb3IgdGhpcyB2aWV3CiAgICAvLyBpbnN0YW5jZS4gWW91IGNhbiBzZXQgYSBgdGVtcGxhdGVgIGF0dHJpYnV0ZSBpbiB0aGUgdmlldwogICAgLy8gZGVmaW5pdGlvbiBvciBwYXNzIGEgYHRlbXBsYXRlOiAid2hhdGV2ZXIiYCBwYXJhbWV0ZXIgaW4KICAgIC8vIHRvIHRoZSBjb25zdHJ1Y3RvciBvcHRpb25zLgogICAgZ2V0VGVtcGxhdGU6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIHRoaXMuZ2V0T3B0aW9uKCd0ZW1wbGF0ZScpOwogICAgfSwKICAgIC8vIFNlcmlhbGl6ZSBhIG1vZGVsIGJ5IHJldHVybmluZyBpdHMgYXR0cmlidXRlcy4gQ2xvbmVzCiAgICAvLyB0aGUgYXR0cmlidXRlcyB0byBhbGxvdyBtb2RpZmljYXRpb24uCiAgICBzZXJpYWxpemVNb2RlbDogZnVuY3Rpb24gKG1vZGVsKSB7CiAgICAgIHJldHVybiBtb2RlbC50b0pTT04uYXBwbHkobW9kZWwsIHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSk7CiAgICB9LAogICAgLy8gTWl4IGluIHRlbXBsYXRlIGhlbHBlciBtZXRob2RzLiBMb29rcyBmb3IgYQogICAgLy8gYHRlbXBsYXRlSGVscGVyc2AgYXR0cmlidXRlLCB3aGljaCBjYW4gZWl0aGVyIGJlIGFuCiAgICAvLyBvYmplY3QgbGl0ZXJhbCwgb3IgYSBmdW5jdGlvbiB0aGF0IHJldHVybnMgYW4gb2JqZWN0CiAgICAvLyBsaXRlcmFsLiBBbGwgbWV0aG9kcyBhbmQgYXR0cmlidXRlcyBmcm9tIHRoaXMgb2JqZWN0CiAgICAvLyBhcmUgY29waWVzIHRvIHRoZSBvYmplY3QgcGFzc2VkIGluLgogICAgbWl4aW5UZW1wbGF0ZUhlbHBlcnM6IGZ1bmN0aW9uICh0YXJnZXQpIHsKICAgICAgdGFyZ2V0ID0gdGFyZ2V0IHx8IHt9OwogICAgICB2YXIgdGVtcGxhdGVIZWxwZXJzID0gdGhpcy5nZXRPcHRpb24oJ3RlbXBsYXRlSGVscGVycycpOwogICAgICBpZiAoXy5pc0Z1bmN0aW9uKHRlbXBsYXRlSGVscGVycykpIHsKICAgICAgICB0ZW1wbGF0ZUhlbHBlcnMgPSB0ZW1wbGF0ZUhlbHBlcnMuY2FsbCh0aGlzKTsKICAgICAgfQogICAgICByZXR1cm4gXy5leHRlbmQodGFyZ2V0LCB0ZW1wbGF0ZUhlbHBlcnMpOwogICAgfSwKICAgIC8vIG5vcm1hbGl6ZSB0aGUga2V5cyBvZiBwYXNzZWQgaGFzaCB3aXRoIHRoZSB2aWV3cyBgdWlgIHNlbGVjdG9ycy4KICAgIC8vIGB7IkB1aS5mb28iOiAiYmFyIn1gCiAgICBub3JtYWxpemVVSUtleXM6IGZ1bmN0aW9uIChoYXNoKSB7CiAgICAgIHZhciB1aSA9IF8ucmVzdWx0KHRoaXMsICd1aScpOwogICAgICB2YXIgdWlCaW5kaW5ncyA9IF8ucmVzdWx0KHRoaXMsICdfdWlCaW5kaW5ncycpOwogICAgICByZXR1cm4gTWFyaW9uZXR0ZS5ub3JtYWxpemVVSUtleXMoaGFzaCwgdWlCaW5kaW5ncyB8fCB1aSk7CiAgICB9LAogICAgLy8gbm9ybWFsaXplIHRoZSB2YWx1ZXMgb2YgcGFzc2VkIGhhc2ggd2l0aCB0aGUgdmlld3MgYHVpYCBzZWxlY3RvcnMuCiAgICAvLyBge2ZvbzogIkB1aS5iYXIifWAKICAgIG5vcm1hbGl6ZVVJVmFsdWVzOiBmdW5jdGlvbiAoaGFzaCkgewogICAgICB2YXIgdWkgPSBfLnJlc3VsdCh0aGlzLCAndWknKTsKICAgICAgdmFyIHVpQmluZGluZ3MgPSBfLnJlc3VsdCh0aGlzLCAnX3VpQmluZGluZ3MnKTsKICAgICAgcmV0dXJuIE1hcmlvbmV0dGUubm9ybWFsaXplVUlWYWx1ZXMoaGFzaCwgdWlCaW5kaW5ncyB8fCB1aSk7CiAgICB9LAogICAgLy8gQ29uZmlndXJlIGB0cmlnZ2Vyc2AgdG8gZm9yd2FyZCBET00gZXZlbnRzIHRvIHZpZXcKICAgIC8vIGV2ZW50cy4gYHRyaWdnZXJzOiB7ImNsaWNrIC5mb28iOiAiZG86Zm9vIn1gCiAgICBjb25maWd1cmVUcmlnZ2VyczogZnVuY3Rpb24gKCkgewogICAgICBpZiAoIXRoaXMudHJpZ2dlcnMpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgdmFyIHRyaWdnZXJFdmVudHMgPSB7fTsKICAgICAgLy8gQWxsb3cgYHRyaWdnZXJzYCB0byBiZSBjb25maWd1cmVkIGFzIGEgZnVuY3Rpb24KICAgICAgdmFyIHRyaWdnZXJzID0gdGhpcy5ub3JtYWxpemVVSUtleXMoXy5yZXN1bHQodGhpcywgJ3RyaWdnZXJzJykpOwogICAgICAvLyBDb25maWd1cmUgdGhlIHRyaWdnZXJzLCBwcmV2ZW50IGRlZmF1bHQKICAgICAgLy8gYWN0aW9uIGFuZCBzdG9wIHByb3BhZ2F0aW9uIG9mIERPTSBldmVudHMKICAgICAgXy5lYWNoKHRyaWdnZXJzLCBmdW5jdGlvbiAodmFsdWUsIGtleSkgewogICAgICAgIHRyaWdnZXJFdmVudHNba2V5XSA9IHRoaXMuX2J1aWxkVmlld1RyaWdnZXIodmFsdWUpOwogICAgICB9LCB0aGlzKTsKICAgICAgcmV0dXJuIHRyaWdnZXJFdmVudHM7CiAgICB9LAogICAgLy8gT3ZlcnJpZGluZyBCYWNrYm9uZS5WaWV3J3MgZGVsZWdhdGVFdmVudHMgdG8gaGFuZGxlCiAgICAvLyB0aGUgYHRyaWdnZXJzYCwgYG1vZGVsRXZlbnRzYCwgYW5kIGBjb2xsZWN0aW9uRXZlbnRzYCBjb25maWd1cmF0aW9uCiAgICBkZWxlZ2F0ZUV2ZW50czogZnVuY3Rpb24gKGV2ZW50cykgewogICAgICB0aGlzLl9kZWxlZ2F0ZURPTUV2ZW50cyhldmVudHMpOwogICAgICB0aGlzLmJpbmRFbnRpdHlFdmVudHModGhpcy5tb2RlbCwgdGhpcy5nZXRPcHRpb24oJ21vZGVsRXZlbnRzJykpOwogICAgICB0aGlzLmJpbmRFbnRpdHlFdmVudHModGhpcy5jb2xsZWN0aW9uLCB0aGlzLmdldE9wdGlvbignY29sbGVjdGlvbkV2ZW50cycpKTsKICAgICAgXy5lYWNoKHRoaXMuX2JlaGF2aW9ycywgZnVuY3Rpb24gKGJlaGF2aW9yKSB7CiAgICAgICAgYmVoYXZpb3IuYmluZEVudGl0eUV2ZW50cyh0aGlzLm1vZGVsLCBiZWhhdmlvci5nZXRPcHRpb24oJ21vZGVsRXZlbnRzJykpOwogICAgICAgIGJlaGF2aW9yLmJpbmRFbnRpdHlFdmVudHModGhpcy5jb2xsZWN0aW9uLCBiZWhhdmlvci5nZXRPcHRpb24oJ2NvbGxlY3Rpb25FdmVudHMnKSk7CiAgICAgIH0sIHRoaXMpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgICAvLyBpbnRlcm5hbCBtZXRob2QgdG8gZGVsZWdhdGUgRE9NIGV2ZW50cyBhbmQgdHJpZ2dlcnMKICAgIF9kZWxlZ2F0ZURPTUV2ZW50czogZnVuY3Rpb24gKGV2ZW50c0FyZykgewogICAgICB2YXIgZXZlbnRzID0gZXZlbnRzQXJnIHx8IHRoaXMuZXZlbnRzOwogICAgICBpZiAoXy5pc0Z1bmN0aW9uKGV2ZW50cykpIHsKICAgICAgICBldmVudHMgPSBldmVudHMuY2FsbCh0aGlzKTsKICAgICAgfQogICAgICAvLyBub3JtYWxpemUgdWkga2V5cwogICAgICBldmVudHMgPSB0aGlzLm5vcm1hbGl6ZVVJS2V5cyhldmVudHMpOwogICAgICBpZiAoXy5pc1VuZGVmaW5lZChldmVudHNBcmcpKSB7CiAgICAgICAgdGhpcy5ldmVudHMgPSBldmVudHM7CiAgICAgIH0KICAgICAgdmFyIGNvbWJpbmVkRXZlbnRzID0ge307CiAgICAgIC8vIGxvb2sgdXAgaWYgdGhpcyB2aWV3IGhhcyBiZWhhdmlvciBldmVudHMKICAgICAgdmFyIGJlaGF2aW9yRXZlbnRzID0gXy5yZXN1bHQodGhpcywgJ2JlaGF2aW9yRXZlbnRzJykgfHwge307CiAgICAgIHZhciB0cmlnZ2VycyA9IHRoaXMuY29uZmlndXJlVHJpZ2dlcnMoKTsKICAgICAgdmFyIGJlaGF2aW9yVHJpZ2dlcnMgPSBfLnJlc3VsdCh0aGlzLCAnYmVoYXZpb3JUcmlnZ2VycycpIHx8IHt9OwogICAgICAvLyBiZWhhdmlvciBldmVudHMgd2lsbCBiZSBvdmVycmlkZW4gYnkgdmlldyBldmVudHMgYW5kIG9yIHRyaWdnZXJzCiAgICAgIF8uZXh0ZW5kKGNvbWJpbmVkRXZlbnRzLCBiZWhhdmlvckV2ZW50cywgZXZlbnRzLCB0cmlnZ2VycywgYmVoYXZpb3JUcmlnZ2Vycyk7CiAgICAgIEJhY2tib25lLlZpZXcucHJvdG90eXBlLmRlbGVnYXRlRXZlbnRzLmNhbGwodGhpcywgY29tYmluZWRFdmVudHMpOwogICAgfSwKICAgIC8vIE92ZXJyaWRpbmcgQmFja2JvbmUuVmlldydzIHVuZGVsZWdhdGVFdmVudHMgdG8gaGFuZGxlIHVuYmluZGluZwogICAgLy8gdGhlIGB0cmlnZ2Vyc2AsIGBtb2RlbEV2ZW50c2AsIGFuZCBgY29sbGVjdGlvbkV2ZW50c2AgY29uZmlnCiAgICB1bmRlbGVnYXRlRXZlbnRzOiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMpOwogICAgICBCYWNrYm9uZS5WaWV3LnByb3RvdHlwZS51bmRlbGVnYXRlRXZlbnRzLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgICB0aGlzLnVuYmluZEVudGl0eUV2ZW50cyh0aGlzLm1vZGVsLCB0aGlzLmdldE9wdGlvbignbW9kZWxFdmVudHMnKSk7CiAgICAgIHRoaXMudW5iaW5kRW50aXR5RXZlbnRzKHRoaXMuY29sbGVjdGlvbiwgdGhpcy5nZXRPcHRpb24oJ2NvbGxlY3Rpb25FdmVudHMnKSk7CiAgICAgIF8uZWFjaCh0aGlzLl9iZWhhdmlvcnMsIGZ1bmN0aW9uIChiZWhhdmlvcikgewogICAgICAgIGJlaGF2aW9yLnVuYmluZEVudGl0eUV2ZW50cyh0aGlzLm1vZGVsLCBiZWhhdmlvci5nZXRPcHRpb24oJ21vZGVsRXZlbnRzJykpOwogICAgICAgIGJlaGF2aW9yLnVuYmluZEVudGl0eUV2ZW50cyh0aGlzLmNvbGxlY3Rpb24sIGJlaGF2aW9yLmdldE9wdGlvbignY29sbGVjdGlvbkV2ZW50cycpKTsKICAgICAgfSwgdGhpcyk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAgIC8vIEludGVybmFsIG1ldGhvZCwgaGFuZGxlcyB0aGUgYHNob3dgIGV2ZW50LgogICAgb25TaG93Q2FsbGVkOiBmdW5jdGlvbiAoKSB7CiAgICB9LAogICAgLy8gSW50ZXJuYWwgaGVscGVyIG1ldGhvZCB0byB2ZXJpZnkgd2hldGhlciB0aGUgdmlldyBoYXNuJ3QgYmVlbiBkZXN0cm95ZWQKICAgIF9lbnN1cmVWaWV3SXNJbnRhY3Q6IGZ1bmN0aW9uICgpIHsKICAgICAgaWYgKHRoaXMuaXNEZXN0cm95ZWQpIHsKICAgICAgICB0aHJvdyBuZXcgTWFyaW9uZXR0ZS5FcnJvcih7CiAgICAgICAgICBuYW1lOiAnVmlld0Rlc3Ryb3llZEVycm9yJywKICAgICAgICAgIG1lc3NhZ2U6ICdWaWV3IChjaWQ6ICInICsgdGhpcy5jaWQgKyAnIikgaGFzIGFscmVhZHkgYmVlbiBkZXN0cm95ZWQgYW5kIGNhbm5vdCBiZSB1c2VkLicKICAgICAgICB9KTsKICAgICAgfQogICAgfSwKICAgIC8vIERlZmF1bHQgYGRlc3Ryb3lgIGltcGxlbWVudGF0aW9uLCBmb3IgcmVtb3ZpbmcgYSB2aWV3IGZyb20gdGhlCiAgICAvLyBET00gYW5kIHVuYmluZGluZyBpdC4gUmVnaW9ucyB3aWxsIGNhbGwgdGhpcyBtZXRob2QKICAgIC8vIGZvciB5b3UuIFlvdSBjYW4gc3BlY2lmeSBhbiBgb25EZXN0cm95YCBtZXRob2QgaW4geW91ciB2aWV3IHRvCiAgICAvLyBhZGQgY3VzdG9tIGNvZGUgdGhhdCBpcyBjYWxsZWQgYWZ0ZXIgdGhlIHZpZXcgaXMgZGVzdHJveWVkLgogICAgZGVzdHJveTogZnVuY3Rpb24gKCkgewogICAgICBpZiAodGhpcy5pc0Rlc3Ryb3llZCkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzKTsKICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kLmFwcGx5KHRoaXMsIFsnYmVmb3JlOmRlc3Ryb3knXS5jb25jYXQoYXJncykpOwogICAgICAvLyBtYXJrIGFzIGRlc3Ryb3llZCBiZWZvcmUgZG9pbmcgdGhlIGFjdHVhbCBkZXN0cm95LCB0bwogICAgICAvLyBwcmV2ZW50IGluZmluaXRlIGxvb3BzIHdpdGhpbiAiZGVzdHJveSIgZXZlbnQgaGFuZGxlcnMKICAgICAgLy8gdGhhdCBhcmUgdHJ5aW5nIHRvIGRlc3Ryb3kgb3RoZXIgdmlld3MKICAgICAgdGhpcy5pc0Rlc3Ryb3llZCA9IHRydWU7CiAgICAgIHRoaXMudHJpZ2dlck1ldGhvZC5hcHBseSh0aGlzLCBbJ2Rlc3Ryb3knXS5jb25jYXQoYXJncykpOwogICAgICAvLyB1bmJpbmQgVUkgZWxlbWVudHMKICAgICAgdGhpcy51bmJpbmRVSUVsZW1lbnRzKCk7CiAgICAgIC8vIHJlbW92ZSB0aGUgdmlldyBmcm9tIHRoZSBET00KICAgICAgdGhpcy5yZW1vdmUoKTsKICAgICAgLy8gQ2FsbCBkZXN0cm95IG9uIGVhY2ggYmVoYXZpb3IgYWZ0ZXIKICAgICAgLy8gZGVzdHJveWluZyB0aGUgdmlldy4KICAgICAgLy8gVGhpcyB1bmJpbmRzIGV2ZW50IGxpc3RlbmVycwogICAgICAvLyB0aGF0IGJlaGF2aW9ycyBoYXZlIHJlZ2lzdGVyZCBmb3IuCiAgICAgIF8uaW52b2tlKHRoaXMuX2JlaGF2aW9ycywgJ2Rlc3Ryb3knLCBhcmdzKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogICAgYmluZFVJRWxlbWVudHM6IGZ1bmN0aW9uICgpIHsKICAgICAgdGhpcy5fYmluZFVJRWxlbWVudHMoKTsKICAgICAgXy5pbnZva2UodGhpcy5fYmVoYXZpb3JzLCB0aGlzLl9iaW5kVUlFbGVtZW50cyk7CiAgICB9LAogICAgLy8gVGhpcyBtZXRob2QgYmluZHMgdGhlIGVsZW1lbnRzIHNwZWNpZmllZCBpbiB0aGUgInVpIiBoYXNoIGluc2lkZSB0aGUgdmlldydzIGNvZGUgd2l0aAogICAgLy8gdGhlIGFzc29jaWF0ZWQgalF1ZXJ5IHNlbGVjdG9ycy4KICAgIF9iaW5kVUlFbGVtZW50czogZnVuY3Rpb24gKCkgewogICAgICBpZiAoIXRoaXMudWkpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgLy8gc3RvcmUgdGhlIHVpIGhhc2ggaW4gX3VpQmluZGluZ3Mgc28gdGhleSBjYW4gYmUgcmVzZXQgbGF0ZXIKICAgICAgLy8gYW5kIHNvIHJlLXJlbmRlcmluZyB0aGUgdmlldyB3aWxsIGJlIGFibGUgdG8gZmluZCB0aGUgYmluZGluZ3MKICAgICAgaWYgKCF0aGlzLl91aUJpbmRpbmdzKSB7CiAgICAgICAgdGhpcy5fdWlCaW5kaW5ncyA9IHRoaXMudWk7CiAgICAgIH0KICAgICAgLy8gZ2V0IHRoZSBiaW5kaW5ncyByZXN1bHQsIGFzIGEgZnVuY3Rpb24gb3Igb3RoZXJ3aXNlCiAgICAgIHZhciBiaW5kaW5ncyA9IF8ucmVzdWx0KHRoaXMsICdfdWlCaW5kaW5ncycpOwogICAgICAvLyBlbXB0eSB0aGUgdWkgc28gd2UgZG9uJ3QgaGF2ZSBhbnl0aGluZyB0byBzdGFydCB3aXRoCiAgICAgIHRoaXMudWkgPSB7fTsKICAgICAgLy8gYmluZCBlYWNoIG9mIHRoZSBzZWxlY3RvcnMKICAgICAgXy5lYWNoKF8ua2V5cyhiaW5kaW5ncyksIGZ1bmN0aW9uIChrZXkpIHsKICAgICAgICB2YXIgc2VsZWN0b3IgPSBiaW5kaW5nc1trZXldOwogICAgICAgIHRoaXMudWlba2V5XSA9IHRoaXMuJChzZWxlY3Rvcik7CiAgICAgIH0sIHRoaXMpOwogICAgfSwKICAgIC8vIFRoaXMgbWV0aG9kIHVuYmluZHMgdGhlIGVsZW1lbnRzIHNwZWNpZmllZCBpbiB0aGUgInVpIiBoYXNoCiAgICB1bmJpbmRVSUVsZW1lbnRzOiBmdW5jdGlvbiAoKSB7CiAgICAgIHRoaXMuX3VuYmluZFVJRWxlbWVudHMoKTsKICAgICAgXy5pbnZva2UodGhpcy5fYmVoYXZpb3JzLCB0aGlzLl91bmJpbmRVSUVsZW1lbnRzKTsKICAgIH0sCiAgICBfdW5iaW5kVUlFbGVtZW50czogZnVuY3Rpb24gKCkgewogICAgICBpZiAoIXRoaXMudWkgfHwgIXRoaXMuX3VpQmluZGluZ3MpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgLy8gZGVsZXRlIGFsbCBvZiB0aGUgZXhpc3RpbmcgdWkgYmluZGluZ3MKICAgICAgXy5lYWNoKHRoaXMudWksIGZ1bmN0aW9uICgkZWwsIG5hbWUpIHsKICAgICAgICBkZWxldGUgdGhpcy51aVtuYW1lXTsKICAgICAgfSwgdGhpcyk7CiAgICAgIC8vIHJlc2V0IHRoZSB1aSBlbGVtZW50IHRvIHRoZSBvcmlnaW5hbCBiaW5kaW5ncyBjb25maWd1cmF0aW9uCiAgICAgIHRoaXMudWkgPSB0aGlzLl91aUJpbmRpbmdzOwogICAgICBkZWxldGUgdGhpcy5fdWlCaW5kaW5nczsKICAgIH0sCiAgICAvLyBJbnRlcm5hbCBtZXRob2QgdG8gY3JlYXRlIGFuIGV2ZW50IGhhbmRsZXIgZm9yIGEgZ2l2ZW4gYHRyaWdnZXJEZWZgIGxpa2UKICAgIC8vICdjbGljazpmb28nCiAgICBfYnVpbGRWaWV3VHJpZ2dlcjogZnVuY3Rpb24gKHRyaWdnZXJEZWYpIHsKICAgICAgdmFyIGhhc09wdGlvbnMgPSBfLmlzT2JqZWN0KHRyaWdnZXJEZWYpOwogICAgICB2YXIgb3B0aW9ucyA9IF8uZGVmYXVsdHMoe30sIGhhc09wdGlvbnMgPyB0cmlnZ2VyRGVmIDoge30sIHsKICAgICAgICBwcmV2ZW50RGVmYXVsdDogdHJ1ZSwKICAgICAgICBzdG9wUHJvcGFnYXRpb246IHRydWUKICAgICAgfSk7CiAgICAgIHZhciBldmVudE5hbWUgPSBoYXNPcHRpb25zID8gb3B0aW9ucy5ldmVudCA6IHRyaWdnZXJEZWY7CiAgICAgIHJldHVybiBmdW5jdGlvbiAoZSkgewogICAgICAgIGlmIChlKSB7CiAgICAgICAgICBpZiAoZS5wcmV2ZW50RGVmYXVsdCAmJiBvcHRpb25zLnByZXZlbnREZWZhdWx0KSB7CiAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChlLnN0b3BQcm9wYWdhdGlvbiAmJiBvcHRpb25zLnN0b3BQcm9wYWdhdGlvbikgewogICAgICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgYXJncyA9IHsKICAgICAgICAgIHZpZXc6IHRoaXMsCiAgICAgICAgICBtb2RlbDogdGhpcy5tb2RlbCwKICAgICAgICAgIGNvbGxlY3Rpb246IHRoaXMuY29sbGVjdGlvbgogICAgICAgIH07CiAgICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKGV2ZW50TmFtZSwgYXJncyk7CiAgICAgIH07CiAgICB9LAogICAgc2V0RWxlbWVudDogZnVuY3Rpb24gKCkgewogICAgICB2YXIgcmV0ID0gQmFja2JvbmUuVmlldy5wcm90b3R5cGUuc2V0RWxlbWVudC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAvLyBwcm94eSBiZWhhdmlvciAkZWwgdG8gdGhlIHZpZXcncyAkZWwuCiAgICAgIC8vIFRoaXMgaXMgbmVlZGVkIGJlY2F1c2UgYSB2aWV3J3MgJGVsIHByb3h5CiAgICAgIC8vIGlzIG5vdCBzZXQgdW50aWwgYWZ0ZXIgc2V0RWxlbWVudCBpcyBjYWxsZWQuCiAgICAgIF8uaW52b2tlKHRoaXMuX2JlaGF2aW9ycywgJ3Byb3h5Vmlld1Byb3BlcnRpZXMnLCB0aGlzKTsKICAgICAgcmV0dXJuIHJldDsKICAgIH0sCiAgICAvLyBpbXBvcnQgdGhlIGB0cmlnZ2VyTWV0aG9kYCB0byB0cmlnZ2VyIGV2ZW50cyB3aXRoIGNvcnJlc3BvbmRpbmcKICAgIC8vIG1ldGhvZHMgaWYgdGhlIG1ldGhvZCBleGlzdHMKICAgIHRyaWdnZXJNZXRob2Q6IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIGFyZ3MgPSBhcmd1bWVudHM7CiAgICAgIHZhciB0cmlnZ2VyTWV0aG9kID0gTWFyaW9uZXR0ZS50cmlnZ2VyTWV0aG9kOwogICAgICB2YXIgcmV0ID0gdHJpZ2dlck1ldGhvZC5hcHBseSh0aGlzLCBhcmdzKTsKICAgICAgXy5lYWNoKHRoaXMuX2JlaGF2aW9ycywgZnVuY3Rpb24gKGIpIHsKICAgICAgICB0cmlnZ2VyTWV0aG9kLmFwcGx5KGIsIGFyZ3MpOwogICAgICB9KTsKICAgICAgcmV0dXJuIHJldDsKICAgIH0sCiAgICAvLyBJbXBvcnRzIHRoZSAibm9ybWFsaXplTWV0aG9kcyIgdG8gdHJhbnNmb3JtIGhhc2hlcyBvZgogICAgLy8gZXZlbnRzPT5mdW5jdGlvbiByZWZlcmVuY2VzL25hbWVzIHRvIGEgaGFzaCBvZiBldmVudHM9PmZ1bmN0aW9uIHJlZmVyZW5jZXMKICAgIG5vcm1hbGl6ZU1ldGhvZHM6IE1hcmlvbmV0dGUubm9ybWFsaXplTWV0aG9kcywKICAgIC8vIFByb3h5IGBnZXRPcHRpb25gIHRvIGVuYWJsZSBnZXR0aW5nIG9wdGlvbnMgZnJvbSB0aGlzIG9yIHRoaXMub3B0aW9ucyBieSBuYW1lLgogICAgZ2V0T3B0aW9uOiBNYXJpb25ldHRlLnByb3h5R2V0T3B0aW9uLAogICAgLy8gUHJveHkgYHVuYmluZEVudGl0eUV2ZW50c2AgdG8gZW5hYmxlIGJpbmRpbmcgdmlldydzIGV2ZW50cyBmcm9tIGFub3RoZXIgZW50aXR5LgogICAgYmluZEVudGl0eUV2ZW50czogTWFyaW9uZXR0ZS5wcm94eUJpbmRFbnRpdHlFdmVudHMsCiAgICAvLyBQcm94eSBgdW5iaW5kRW50aXR5RXZlbnRzYCB0byBlbmFibGUgdW5iaW5kaW5nIHZpZXcncyBldmVudHMgZnJvbSBhbm90aGVyIGVudGl0eS4KICAgIHVuYmluZEVudGl0eUV2ZW50czogTWFyaW9uZXR0ZS5wcm94eVVuYmluZEVudGl0eUV2ZW50cwogIH0pOwogIC8vIEl0ZW0gVmlldwogIC8vIC0tLS0tLS0tLQogIC8vIEEgc2luZ2xlIGl0ZW0gdmlldyBpbXBsZW1lbnRhdGlvbiB0aGF0IGNvbnRhaW5zIGNvZGUgZm9yIHJlbmRlcmluZwogIC8vIHdpdGggdW5kZXJzY29yZS5qcyB0ZW1wbGF0ZXMsIHNlcmlhbGl6aW5nIHRoZSB2aWV3J3MgbW9kZWwgb3IgY29sbGVjdGlvbiwKICAvLyBhbmQgY2FsbGluZyBzZXZlcmFsIG1ldGhvZHMgb24gZXh0ZW5kZWQgdmlld3MsIHN1Y2ggYXMgYG9uUmVuZGVyYC4KICBNYXJpb25ldHRlLkl0ZW1WaWV3ID0gTWFyaW9uZXR0ZS5WaWV3LmV4dGVuZCh7CiAgICAvLyBTZXR0aW5nIHVwIHRoZSBpbmhlcml0YW5jZSBjaGFpbiB3aGljaCBhbGxvd3MgY2hhbmdlcyB0bwogICAgLy8gTWFyaW9uZXR0ZS5WaWV3LnByb3RvdHlwZS5jb25zdHJ1Y3RvciB3aGljaCBhbGxvd3Mgb3ZlcnJpZGluZwogICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uICgpIHsKICAgICAgTWFyaW9uZXR0ZS5WaWV3LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9LAogICAgLy8gU2VyaWFsaXplIHRoZSBtb2RlbCBvciBjb2xsZWN0aW9uIGZvciB0aGUgdmlldy4gSWYgYSBtb2RlbCBpcwogICAgLy8gZm91bmQsIHRoZSB2aWV3J3MgYHNlcmlhbGl6ZU1vZGVsYCBpcyBjYWxsZWQuIElmIGEgY29sbGVjdGlvbiBpcyBmb3VuZCwKICAgIC8vIGVhY2ggbW9kZWwgaW4gdGhlIGNvbGxlY3Rpb24gaXMgc2VyaWFsaXplZCBieSBjYWxsaW5nCiAgICAvLyB0aGUgdmlldydzIGBzZXJpYWxpemVDb2xsZWN0aW9uYCBhbmQgcHV0IGludG8gYW4gYGl0ZW1zYCBhcnJheSBpbgogICAgLy8gdGhlIHJlc3VsdGluZyBkYXRhLiBJZiBib3RoIGFyZSBmb3VuZCwgZGVmYXVsdHMgdG8gdGhlIG1vZGVsLgogICAgLy8gWW91IGNhbiBvdmVycmlkZSB0aGUgYHNlcmlhbGl6ZURhdGFgIG1ldGhvZCBpbiB5b3VyIG93biB2aWV3IGRlZmluaXRpb24sCiAgICAvLyB0byBwcm92aWRlIGN1c3RvbSBzZXJpYWxpemF0aW9uIGZvciB5b3VyIHZpZXcncyBkYXRhLgogICAgc2VyaWFsaXplRGF0YTogZnVuY3Rpb24gKCkgewogICAgICB2YXIgZGF0YSA9IHt9OwogICAgICBpZiAodGhpcy5tb2RlbCkgewogICAgICAgIGRhdGEgPSBfLnBhcnRpYWwodGhpcy5zZXJpYWxpemVNb2RlbCwgdGhpcy5tb2RlbCkuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfSBlbHNlIGlmICh0aGlzLmNvbGxlY3Rpb24pIHsKICAgICAgICBkYXRhID0geyBpdGVtczogXy5wYXJ0aWFsKHRoaXMuc2VyaWFsaXplQ29sbGVjdGlvbiwgdGhpcy5jb2xsZWN0aW9uKS5hcHBseSh0aGlzLCBhcmd1bWVudHMpIH07CiAgICAgIH0KICAgICAgcmV0dXJuIGRhdGE7CiAgICB9LAogICAgLy8gU2VyaWFsaXplIGEgY29sbGVjdGlvbiBieSBzZXJpYWxpemluZyBlYWNoIG9mIGl0cyBtb2RlbHMuCiAgICBzZXJpYWxpemVDb2xsZWN0aW9uOiBmdW5jdGlvbiAoY29sbGVjdGlvbikgewogICAgICByZXR1cm4gY29sbGVjdGlvbi50b0pTT04uYXBwbHkoY29sbGVjdGlvbiwgc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpKTsKICAgIH0sCiAgICAvLyBSZW5kZXIgdGhlIHZpZXcsIGRlZmF1bHRpbmcgdG8gdW5kZXJzY29yZS5qcyB0ZW1wbGF0ZXMuCiAgICAvLyBZb3UgY2FuIG92ZXJyaWRlIHRoaXMgaW4geW91ciB2aWV3IGRlZmluaXRpb24gdG8gcHJvdmlkZQogICAgLy8gYSB2ZXJ5IHNwZWNpZmljIHJlbmRlcmluZyBmb3IgeW91ciB2aWV3LiBJbiBnZW5lcmFsLCB0aG91Z2gsCiAgICAvLyB5b3Ugc2hvdWxkIG92ZXJyaWRlIHRoZSBgTWFyaW9uZXR0ZS5SZW5kZXJlcmAgb2JqZWN0IHRvCiAgICAvLyBjaGFuZ2UgaG93IE1hcmlvbmV0dGUgcmVuZGVycyB2aWV3cy4KICAgIHJlbmRlcjogZnVuY3Rpb24gKCkgewogICAgICB0aGlzLl9lbnN1cmVWaWV3SXNJbnRhY3QoKTsKICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdiZWZvcmU6cmVuZGVyJywgdGhpcyk7CiAgICAgIHRoaXMuX3JlbmRlclRlbXBsYXRlKCk7CiAgICAgIHRoaXMuYmluZFVJRWxlbWVudHMoKTsKICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdyZW5kZXInLCB0aGlzKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogICAgLy8gSW50ZXJuYWwgbWV0aG9kIHRvIHJlbmRlciB0aGUgdGVtcGxhdGUgd2l0aCB0aGUgc2VyaWFsaXplZCBkYXRhCiAgICAvLyBhbmQgdGVtcGxhdGUgaGVscGVycyB2aWEgdGhlIGBNYXJpb25ldHRlLlJlbmRlcmVyYCBvYmplY3QuCiAgICAvLyBUaHJvd3MgYW4gYFVuZGVmaW5lZFRlbXBsYXRlRXJyb3JgIGVycm9yIGlmIHRoZSB0ZW1wbGF0ZSBpcwogICAgLy8gYW55IGZhbHNlbHkgdmFsdWUgYnV0IGxpdGVyYWwgYGZhbHNlYC4KICAgIF9yZW5kZXJUZW1wbGF0ZTogZnVuY3Rpb24gKCkgewogICAgICB2YXIgdGVtcGxhdGUgPSB0aGlzLmdldFRlbXBsYXRlKCk7CiAgICAgIC8vIEFsbG93IHRlbXBsYXRlLWxlc3MgaXRlbSB2aWV3cwogICAgICBpZiAodGVtcGxhdGUgPT09IGZhbHNlKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIGlmICghdGVtcGxhdGUpIHsKICAgICAgICB0aHJvdyBuZXcgTWFyaW9uZXR0ZS5FcnJvcih7CiAgICAgICAgICBuYW1lOiAnVW5kZWZpbmVkVGVtcGxhdGVFcnJvcicsCiAgICAgICAgICBtZXNzYWdlOiAnQ2Fubm90IHJlbmRlciB0aGUgdGVtcGxhdGUgc2luY2UgaXQgaXMgbnVsbCBvciB1bmRlZmluZWQuJwogICAgICAgIH0pOwogICAgICB9CiAgICAgIC8vIEFkZCBpbiBlbnRpdHkgZGF0YSBhbmQgdGVtcGxhdGUgaGVscGVycwogICAgICB2YXIgZGF0YSA9IHRoaXMuc2VyaWFsaXplRGF0YSgpOwogICAgICBkYXRhID0gdGhpcy5taXhpblRlbXBsYXRlSGVscGVycyhkYXRhKTsKICAgICAgLy8gUmVuZGVyIGFuZCBhZGQgdG8gZWwKICAgICAgdmFyIGh0bWwgPSBNYXJpb25ldHRlLlJlbmRlcmVyLnJlbmRlcih0ZW1wbGF0ZSwgZGF0YSwgdGhpcyk7CiAgICAgIHRoaXMuYXR0YWNoRWxDb250ZW50KGh0bWwpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgICAvLyBBdHRhY2hlcyB0aGUgY29udGVudCBvZiBhIGdpdmVuIHZpZXcuCiAgICAvLyBUaGlzIG1ldGhvZCBjYW4gYmUgb3ZlcnJpZGRlbiB0byBvcHRpbWl6ZSByZW5kZXJpbmcsCiAgICAvLyBvciB0byByZW5kZXIgaW4gYSBub24gc3RhbmRhcmQgd2F5LgogICAgLy8KICAgIC8vIEZvciBleGFtcGxlLCB1c2luZyBgaW5uZXJIVE1MYCBpbnN0ZWFkIG9mIGAkZWwuaHRtbGAKICAgIC8vCiAgICAvLyBgYGBqcwogICAgLy8gYXR0YWNoRWxDb250ZW50OiBmdW5jdGlvbihodG1sKSB7CiAgICAvLyAgIHRoaXMuZWwuaW5uZXJIVE1MID0gaHRtbDsKICAgIC8vICAgcmV0dXJuIHRoaXM7CiAgICAvLyB9CiAgICAvLyBgYGAKICAgIGF0dGFjaEVsQ29udGVudDogZnVuY3Rpb24gKGh0bWwpIHsKICAgICAgdGhpcy4kZWwuaHRtbChodG1sKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogICAgLy8gT3ZlcnJpZGUgdGhlIGRlZmF1bHQgZGVzdHJveSBldmVudCB0byBhZGQgYSBmZXcKICAgIC8vIG1vcmUgZXZlbnRzIHRoYXQgYXJlIHRyaWdnZXJlZC4KICAgIGRlc3Ryb3k6IGZ1bmN0aW9uICgpIHsKICAgICAgaWYgKHRoaXMuaXNEZXN0cm95ZWQpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgcmV0dXJuIE1hcmlvbmV0dGUuVmlldy5wcm90b3R5cGUuZGVzdHJveS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfQogIH0pOwogIC8qIGpzaGludCBtYXhzdGF0ZW1lbnRzOiAxNCAqLwogIC8qIGpzaGludCBtYXhsZW46IDIwMCAqLwogIC8vIENvbGxlY3Rpb24gVmlldwogIC8vIC0tLS0tLS0tLS0tLS0tLQogIC8vIEEgdmlldyB0aGF0IGl0ZXJhdGVzIG92ZXIgYSBCYWNrYm9uZS5Db2xsZWN0aW9uCiAgLy8gYW5kIHJlbmRlcnMgYW4gaW5kaXZpZHVhbCBjaGlsZCB2aWV3IGZvciBlYWNoIG1vZGVsLgogIE1hcmlvbmV0dGUuQ29sbGVjdGlvblZpZXcgPSBNYXJpb25ldHRlLlZpZXcuZXh0ZW5kKHsKICAgIC8vIHVzZWQgYXMgdGhlIHByZWZpeCBmb3IgY2hpbGQgdmlldyBldmVudHMKICAgIC8vIHRoYXQgYXJlIGZvcndhcmRlZCB0aHJvdWdoIHRoZSBjb2xsZWN0aW9udmlldwogICAgY2hpbGRWaWV3RXZlbnRQcmVmaXg6ICdjaGlsZHZpZXcnLAogICAgLy8gY29uc3RydWN0b3IKICAgIC8vIG9wdGlvbiB0byBwYXNzIGB7c29ydDogZmFsc2V9YCB0byBwcmV2ZW50IHRoZSBgQ29sbGVjdGlvblZpZXdgIGZyb20KICAgIC8vIG1haW50YWluaW5nIHRoZSBzb3J0ZWQgb3JkZXIgb2YgdGhlIGNvbGxlY3Rpb24uCiAgICAvLyBUaGlzIHdpbGwgZmFsbGJhY2sgb250byBhcHBlbmRpbmcgY2hpbGRWaWV3J3MgdG8gdGhlIGVuZC4KICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbiAob3B0aW9ucykgewogICAgICB2YXIgaW5pdE9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogICAgICB0aGlzLnNvcnQgPSBfLmlzVW5kZWZpbmVkKGluaXRPcHRpb25zLnNvcnQpID8gdHJ1ZSA6IGluaXRPcHRpb25zLnNvcnQ7CiAgICAgIGlmIChpbml0T3B0aW9ucy5jb2xsZWN0aW9uICYmICEoaW5pdE9wdGlvbnMuY29sbGVjdGlvbiBpbnN0YW5jZW9mIEJhY2tib25lLkNvbGxlY3Rpb24pKSB7CiAgICAgICAgdGhyb3cgbmV3IE1hcmlvbmV0dGUuRXJyb3IoJ1RoZSBDb2xsZWN0aW9uIG9wdGlvbiBwYXNzZWQgdG8gdGhpcyB2aWV3IG5lZWRzIHRvIGJlIGFuIGluc3RhbmNlIG9mIGEgQmFja2JvbmUuQ29sbGVjdGlvbicpOwogICAgICB9CiAgICAgIHRoaXMub25jZSgncmVuZGVyJywgdGhpcy5faW5pdGlhbEV2ZW50cyk7CiAgICAgIHRoaXMuX2luaXRDaGlsZFZpZXdTdG9yYWdlKCk7CiAgICAgIE1hcmlvbmV0dGUuVmlldy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB0aGlzLmluaXRSZW5kZXJCdWZmZXIoKTsKICAgIH0sCiAgICAvLyBJbnN0ZWFkIG9mIGluc2VydGluZyBlbGVtZW50cyBvbmUgYnkgb25lIGludG8gdGhlIHBhZ2UsCiAgICAvLyBpdCdzIG11Y2ggbW9yZSBwZXJmb3JtYW50IHRvIGluc2VydCBlbGVtZW50cyBpbnRvIGEgZG9jdW1lbnQKICAgIC8vIGZyYWdtZW50IGFuZCB0aGVuIGluc2VydCB0aGF0IGRvY3VtZW50IGZyYWdtZW50IGludG8gdGhlIHBhZ2UKICAgIGluaXRSZW5kZXJCdWZmZXI6IGZ1bmN0aW9uICgpIHsKICAgICAgdGhpcy5lbEJ1ZmZlciA9IGRvY3VtZW50LmNyZWF0ZURvY3VtZW50RnJhZ21lbnQoKTsKICAgICAgdGhpcy5fYnVmZmVyZWRDaGlsZHJlbiA9IFtdOwogICAgfSwKICAgIHN0YXJ0QnVmZmVyaW5nOiBmdW5jdGlvbiAoKSB7CiAgICAgIHRoaXMuaW5pdFJlbmRlckJ1ZmZlcigpOwogICAgICB0aGlzLmlzQnVmZmVyaW5nID0gdHJ1ZTsKICAgIH0sCiAgICBlbmRCdWZmZXJpbmc6IGZ1bmN0aW9uICgpIHsKICAgICAgdGhpcy5pc0J1ZmZlcmluZyA9IGZhbHNlOwogICAgICB0aGlzLl90cmlnZ2VyQmVmb3JlU2hvd0J1ZmZlcmVkQ2hpbGRyZW4oKTsKICAgICAgdGhpcy5hdHRhY2hCdWZmZXIodGhpcywgdGhpcy5lbEJ1ZmZlcik7CiAgICAgIHRoaXMuX3RyaWdnZXJTaG93QnVmZmVyZWRDaGlsZHJlbigpOwogICAgICB0aGlzLmluaXRSZW5kZXJCdWZmZXIoKTsKICAgIH0sCiAgICBfdHJpZ2dlckJlZm9yZVNob3dCdWZmZXJlZENoaWxkcmVuOiBmdW5jdGlvbiAoKSB7CiAgICAgIGlmICh0aGlzLl9pc1Nob3duKSB7CiAgICAgICAgXy5lYWNoKHRoaXMuX2J1ZmZlcmVkQ2hpbGRyZW4sIF8ucGFydGlhbCh0aGlzLl90cmlnZ2VyTWV0aG9kT25DaGlsZCwgJ2JlZm9yZTpzaG93JykpOwogICAgICB9CiAgICB9LAogICAgX3RyaWdnZXJTaG93QnVmZmVyZWRDaGlsZHJlbjogZnVuY3Rpb24gKCkgewogICAgICBpZiAodGhpcy5faXNTaG93bikgewogICAgICAgIF8uZWFjaCh0aGlzLl9idWZmZXJlZENoaWxkcmVuLCBfLnBhcnRpYWwodGhpcy5fdHJpZ2dlck1ldGhvZE9uQ2hpbGQsICdzaG93JykpOwogICAgICAgIHRoaXMuX2J1ZmZlcmVkQ2hpbGRyZW4gPSBbXTsKICAgICAgfQogICAgfSwKICAgIC8vIEludGVybmFsIG1ldGhvZCBmb3IgXy5lYWNoIGxvb3BzIHRvIGNhbGwgYE1hcmlvbmV0dGUudHJpZ2dlck1ldGhvZE9uYCBvbgogICAgLy8gYSBjaGlsZCB2aWV3CiAgICBfdHJpZ2dlck1ldGhvZE9uQ2hpbGQ6IGZ1bmN0aW9uIChldmVudCwgY2hpbGRWaWV3KSB7CiAgICAgIE1hcmlvbmV0dGUudHJpZ2dlck1ldGhvZE9uKGNoaWxkVmlldywgZXZlbnQpOwogICAgfSwKICAgIC8vIENvbmZpZ3VyZWQgdGhlIGluaXRpYWwgZXZlbnRzIHRoYXQgdGhlIGNvbGxlY3Rpb24gdmlldwogICAgLy8gYmluZHMgdG8uCiAgICBfaW5pdGlhbEV2ZW50czogZnVuY3Rpb24gKCkgewogICAgICBpZiAodGhpcy5jb2xsZWN0aW9uKSB7CiAgICAgICAgdGhpcy5saXN0ZW5Ubyh0aGlzLmNvbGxlY3Rpb24sICdhZGQnLCB0aGlzLl9vbkNvbGxlY3Rpb25BZGQpOwogICAgICAgIHRoaXMubGlzdGVuVG8odGhpcy5jb2xsZWN0aW9uLCAncmVtb3ZlJywgdGhpcy5fb25Db2xsZWN0aW9uUmVtb3ZlKTsKICAgICAgICB0aGlzLmxpc3RlblRvKHRoaXMuY29sbGVjdGlvbiwgJ3Jlc2V0JywgdGhpcy5yZW5kZXIpOwogICAgICAgIGlmICh0aGlzLnNvcnQpIHsKICAgICAgICAgIHRoaXMubGlzdGVuVG8odGhpcy5jb2xsZWN0aW9uLCAnc29ydCcsIHRoaXMuX3NvcnRWaWV3cyk7CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgLy8gSGFuZGxlIGEgY2hpbGQgYWRkZWQgdG8gdGhlIGNvbGxlY3Rpb24KICAgIF9vbkNvbGxlY3Rpb25BZGQ6IGZ1bmN0aW9uIChjaGlsZCkgewogICAgICB0aGlzLmRlc3Ryb3lFbXB0eVZpZXcoKTsKICAgICAgdmFyIENoaWxkVmlldyA9IHRoaXMuZ2V0Q2hpbGRWaWV3KGNoaWxkKTsKICAgICAgdmFyIGluZGV4ID0gdGhpcy5jb2xsZWN0aW9uLmluZGV4T2YoY2hpbGQpOwogICAgICB0aGlzLmFkZENoaWxkKGNoaWxkLCBDaGlsZFZpZXcsIGluZGV4KTsKICAgIH0sCiAgICAvLyBnZXQgdGhlIGNoaWxkIHZpZXcgYnkgbW9kZWwgaXQgaG9sZHMsIGFuZCByZW1vdmUgaXQKICAgIF9vbkNvbGxlY3Rpb25SZW1vdmU6IGZ1bmN0aW9uIChtb2RlbCkgewogICAgICB2YXIgdmlldyA9IHRoaXMuY2hpbGRyZW4uZmluZEJ5TW9kZWwobW9kZWwpOwogICAgICB0aGlzLnJlbW92ZUNoaWxkVmlldyh2aWV3KTsKICAgICAgdGhpcy5jaGVja0VtcHR5KCk7CiAgICB9LAogICAgLy8gT3ZlcnJpZGUgZnJvbSBgTWFyaW9uZXR0ZS5WaWV3YCB0byB0cmlnZ2VyIHNob3cgb24gY2hpbGQgdmlld3MKICAgIG9uU2hvd0NhbGxlZDogZnVuY3Rpb24gKCkgewogICAgICB0aGlzLmNoaWxkcmVuLmVhY2goXy5wYXJ0aWFsKHRoaXMuX3RyaWdnZXJNZXRob2RPbkNoaWxkLCAnc2hvdycpKTsKICAgIH0sCiAgICAvLyBSZW5kZXIgY2hpbGRyZW4gdmlld3MuIE92ZXJyaWRlIHRoaXMgbWV0aG9kIHRvCiAgICAvLyBwcm92aWRlIHlvdXIgb3duIGltcGxlbWVudGF0aW9uIG9mIGEgcmVuZGVyIGZ1bmN0aW9uIGZvcgogICAgLy8gdGhlIGNvbGxlY3Rpb24gdmlldy4KICAgIHJlbmRlcjogZnVuY3Rpb24gKCkgewogICAgICB0aGlzLl9lbnN1cmVWaWV3SXNJbnRhY3QoKTsKICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdiZWZvcmU6cmVuZGVyJywgdGhpcyk7CiAgICAgIHRoaXMuX3JlbmRlckNoaWxkcmVuKCk7CiAgICAgIHRoaXMudHJpZ2dlck1ldGhvZCgncmVuZGVyJywgdGhpcyk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAgIC8vIFJlbmRlciB2aWV3IGFmdGVyIHNvcnRpbmcuIE92ZXJyaWRlIHRoaXMgbWV0aG9kIHRvCiAgICAvLyBjaGFuZ2UgaG93IHRoZSB2aWV3IHJlbmRlcnMgYWZ0ZXIgYSBgc29ydGAgb24gdGhlIGNvbGxlY3Rpb24uCiAgICAvLyBBbiBleGFtcGxlIG9mIHRoaXMgd291bGQgYmUgdG8gb25seSBgcmVuZGVyQ2hpbGRyZW5gIGluIGEgYENvbXBvc2l0ZVZpZXdgCiAgICAvLyByYXRoZXIgdGhhbiB0aGUgZnVsbCB2aWV3LgogICAgcmVzb3J0VmlldzogZnVuY3Rpb24gKCkgewogICAgICB0aGlzLnJlbmRlcigpOwogICAgfSwKICAgIC8vIEludGVybmFsIG1ldGhvZC4gVGhpcyBjaGVja3MgZm9yIGFueSBjaGFuZ2VzIGluIHRoZSBvcmRlciBvZiB0aGUgY29sbGVjdGlvbi4KICAgIC8vIElmIHRoZSBpbmRleCBvZiBhbnkgdmlldyBkb2Vzbid0IG1hdGNoLCBpdCB3aWxsIHJlbmRlci4KICAgIF9zb3J0Vmlld3M6IGZ1bmN0aW9uICgpIHsKICAgICAgLy8gY2hlY2sgZm9yIGFueSBjaGFuZ2VzIGluIHNvcnQgb3JkZXIgb2Ygdmlld3MKICAgICAgdmFyIG9yZGVyQ2hhbmdlZCA9IHRoaXMuY29sbGVjdGlvbi5maW5kKGZ1bmN0aW9uIChpdGVtLCBpbmRleCkgewogICAgICAgIHZhciB2aWV3ID0gdGhpcy5jaGlsZHJlbi5maW5kQnlNb2RlbChpdGVtKTsKICAgICAgICByZXR1cm4gIXZpZXcgfHwgdmlldy5faW5kZXggIT09IGluZGV4OwogICAgICB9LCB0aGlzKTsKICAgICAgaWYgKG9yZGVyQ2hhbmdlZCkgewogICAgICAgIHRoaXMucmVzb3J0VmlldygpOwogICAgICB9CiAgICB9LAogICAgLy8gSW50ZXJuYWwgbWV0aG9kLiBTZXBhcmF0ZWQgc28gdGhhdCBDb21wb3NpdGVWaWV3IGNhbiBoYXZlCiAgICAvLyBtb3JlIGNvbnRyb2wgb3ZlciBldmVudHMgYmVpbmcgdHJpZ2dlcmVkLCBhcm91bmQgdGhlIHJlbmRlcmluZwogICAgLy8gcHJvY2VzcwogICAgX3JlbmRlckNoaWxkcmVuOiBmdW5jdGlvbiAoKSB7CiAgICAgIHRoaXMuZGVzdHJveUVtcHR5VmlldygpOwogICAgICB0aGlzLmRlc3Ryb3lDaGlsZHJlbigpOwogICAgICBpZiAodGhpcy5pc0VtcHR5KHRoaXMuY29sbGVjdGlvbikpIHsKICAgICAgICB0aGlzLnNob3dFbXB0eVZpZXcoKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLnRyaWdnZXJNZXRob2QoJ2JlZm9yZTpyZW5kZXI6Y29sbGVjdGlvbicsIHRoaXMpOwogICAgICAgIHRoaXMuc3RhcnRCdWZmZXJpbmcoKTsKICAgICAgICB0aGlzLnNob3dDb2xsZWN0aW9uKCk7CiAgICAgICAgdGhpcy5lbmRCdWZmZXJpbmcoKTsKICAgICAgICB0aGlzLnRyaWdnZXJNZXRob2QoJ3JlbmRlcjpjb2xsZWN0aW9uJywgdGhpcyk7CiAgICAgIH0KICAgIH0sCiAgICAvLyBJbnRlcm5hbCBtZXRob2QgdG8gbG9vcCB0aHJvdWdoIGNvbGxlY3Rpb24gYW5kIHNob3cgZWFjaCBjaGlsZCB2aWV3LgogICAgc2hvd0NvbGxlY3Rpb246IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIENoaWxkVmlldzsKICAgICAgdGhpcy5jb2xsZWN0aW9uLmVhY2goZnVuY3Rpb24gKGNoaWxkLCBpbmRleCkgewogICAgICAgIENoaWxkVmlldyA9IHRoaXMuZ2V0Q2hpbGRWaWV3KGNoaWxkKTsKICAgICAgICB0aGlzLmFkZENoaWxkKGNoaWxkLCBDaGlsZFZpZXcsIGluZGV4KTsKICAgICAgfSwgdGhpcyk7CiAgICB9LAogICAgLy8gSW50ZXJuYWwgbWV0aG9kIHRvIHNob3cgYW4gZW1wdHkgdmlldyBpbiBwbGFjZSBvZgogICAgLy8gYSBjb2xsZWN0aW9uIG9mIGNoaWxkIHZpZXdzLCB3aGVuIHRoZSBjb2xsZWN0aW9uIGlzIGVtcHR5CiAgICBzaG93RW1wdHlWaWV3OiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBFbXB0eVZpZXcgPSB0aGlzLmdldEVtcHR5VmlldygpOwogICAgICBpZiAoRW1wdHlWaWV3ICYmICF0aGlzLl9zaG93aW5nRW1wdHlWaWV3KSB7CiAgICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdiZWZvcmU6cmVuZGVyOmVtcHR5Jyk7CiAgICAgICAgdGhpcy5fc2hvd2luZ0VtcHR5VmlldyA9IHRydWU7CiAgICAgICAgdmFyIG1vZGVsID0gbmV3IEJhY2tib25lLk1vZGVsKCk7CiAgICAgICAgdGhpcy5hZGRFbXB0eVZpZXcobW9kZWwsIEVtcHR5Vmlldyk7CiAgICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdyZW5kZXI6ZW1wdHknKTsKICAgICAgfQogICAgfSwKICAgIC8vIEludGVybmFsIG1ldGhvZCB0byBkZXN0cm95IGFuIGV4aXN0aW5nIGVtcHR5VmlldyBpbnN0YW5jZQogICAgLy8gaWYgb25lIGV4aXN0cy4gQ2FsbGVkIHdoZW4gYSBjb2xsZWN0aW9uIHZpZXcgaGFzIGJlZW4KICAgIC8vIHJlbmRlcmVkIGVtcHR5LCBhbmQgdGhlbiBhIGNoaWxkIGlzIGFkZGVkIHRvIHRoZSBjb2xsZWN0aW9uLgogICAgZGVzdHJveUVtcHR5VmlldzogZnVuY3Rpb24gKCkgewogICAgICBpZiAodGhpcy5fc2hvd2luZ0VtcHR5VmlldykgewogICAgICAgIHRoaXMudHJpZ2dlck1ldGhvZCgnYmVmb3JlOnJlbW92ZTplbXB0eScpOwogICAgICAgIHRoaXMuZGVzdHJveUNoaWxkcmVuKCk7CiAgICAgICAgZGVsZXRlIHRoaXMuX3Nob3dpbmdFbXB0eVZpZXc7CiAgICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdyZW1vdmU6ZW1wdHknKTsKICAgICAgfQogICAgfSwKICAgIC8vIFJldHJpZXZlIHRoZSBlbXB0eSB2aWV3IGNsYXNzCiAgICBnZXRFbXB0eVZpZXc6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIHRoaXMuZ2V0T3B0aW9uKCdlbXB0eVZpZXcnKTsKICAgIH0sCiAgICAvLyBSZW5kZXIgYW5kIHNob3cgdGhlIGVtcHR5Vmlldy4gU2ltaWxhciB0byBhZGRDaGlsZCBtZXRob2QKICAgIC8vIGJ1dCAiY2hpbGQ6YWRkZWQiIGV2ZW50cyBhcmUgbm90IGZpcmVkLCBhbmQgdGhlIGV2ZW50IGZyb20KICAgIC8vIGVtcHR5VmlldyBhcmUgbm90IGZvcndhcmRlZAogICAgYWRkRW1wdHlWaWV3OiBmdW5jdGlvbiAoY2hpbGQsIEVtcHR5VmlldykgewogICAgICAvLyBnZXQgdGhlIGVtcHR5Vmlld09wdGlvbnMsIGZhbGxpbmcgYmFjayB0byBjaGlsZFZpZXdPcHRpb25zCiAgICAgIHZhciBlbXB0eVZpZXdPcHRpb25zID0gdGhpcy5nZXRPcHRpb24oJ2VtcHR5Vmlld09wdGlvbnMnKSB8fCB0aGlzLmdldE9wdGlvbignY2hpbGRWaWV3T3B0aW9ucycpOwogICAgICBpZiAoXy5pc0Z1bmN0aW9uKGVtcHR5Vmlld09wdGlvbnMpKSB7CiAgICAgICAgZW1wdHlWaWV3T3B0aW9ucyA9IGVtcHR5Vmlld09wdGlvbnMuY2FsbCh0aGlzKTsKICAgICAgfQogICAgICAvLyBidWlsZCB0aGUgZW1wdHkgdmlldwogICAgICB2YXIgdmlldyA9IHRoaXMuYnVpbGRDaGlsZFZpZXcoY2hpbGQsIEVtcHR5VmlldywgZW1wdHlWaWV3T3B0aW9ucyk7CiAgICAgIC8vIFByb3h5IGVtcHR5VmlldyBldmVudHMKICAgICAgdGhpcy5wcm94eUNoaWxkRXZlbnRzKHZpZXcpOwogICAgICAvLyB0cmlnZ2VyIHRoZSAnYmVmb3JlOnNob3cnIGV2ZW50IG9uIGB2aWV3YCBpZiB0aGUgY29sbGVjdGlvbiB2aWV3CiAgICAgIC8vIGhhcyBhbHJlYWR5IGJlZW4gc2hvd24KICAgICAgaWYgKHRoaXMuX2lzU2hvd24pIHsKICAgICAgICBNYXJpb25ldHRlLnRyaWdnZXJNZXRob2RPbih2aWV3LCAnYmVmb3JlOnNob3cnKTsKICAgICAgfQogICAgICAvLyBTdG9yZSB0aGUgYGVtcHR5Vmlld2AgbGlrZSBhIGBjaGlsZFZpZXdgIHNvIHdlIGNhbiBwcm9wZXJseQogICAgICAvLyByZW1vdmUgYW5kL29yIGNsb3NlIGl0IGxhdGVyCiAgICAgIHRoaXMuY2hpbGRyZW4uYWRkKHZpZXcpOwogICAgICAvLyBSZW5kZXIgaXQgYW5kIHNob3cgaXQKICAgICAgdGhpcy5yZW5kZXJDaGlsZFZpZXcodmlldywgLTEpOwogICAgICAvLyBjYWxsIHRoZSAnc2hvdycgbWV0aG9kIGlmIHRoZSBjb2xsZWN0aW9uIHZpZXcKICAgICAgLy8gaGFzIGFscmVhZHkgYmVlbiBzaG93bgogICAgICBpZiAodGhpcy5faXNTaG93bikgewogICAgICAgIE1hcmlvbmV0dGUudHJpZ2dlck1ldGhvZE9uKHZpZXcsICdzaG93Jyk7CiAgICAgIH0KICAgIH0sCiAgICAvLyBSZXRyaWV2ZSB0aGUgYGNoaWxkVmlld2AgY2xhc3MsIGVpdGhlciBmcm9tIGB0aGlzLm9wdGlvbnMuY2hpbGRWaWV3YAogICAgLy8gb3IgZnJvbSB0aGUgYGNoaWxkVmlld2AgaW4gdGhlIG9iamVjdCBkZWZpbml0aW9uLiBUaGUgIm9wdGlvbnMiCiAgICAvLyB0YWtlcyBwcmVjZWRlbmNlLgogICAgLy8gVGhpcyBtZXRob2QgcmVjZWl2ZXMgdGhlIG1vZGVsIHRoYXQgd2lsbCBiZSBwYXNzZWQgdG8gdGhlIGluc3RhbmNlCiAgICAvLyBjcmVhdGVkIGZyb20gdGhpcyBgY2hpbGRWaWV3YC4gT3ZlcnJpZGluZyBtZXRob2RzIG1heSB1c2UgdGhlIGNoaWxkCiAgICAvLyB0byBkZXRlcm1pbmUgd2hhdCBgY2hpbGRWaWV3YCBjbGFzcyB0byByZXR1cm4uCiAgICBnZXRDaGlsZFZpZXc6IGZ1bmN0aW9uIChjaGlsZCkgewogICAgICB2YXIgY2hpbGRWaWV3ID0gdGhpcy5nZXRPcHRpb24oJ2NoaWxkVmlldycpOwogICAgICBpZiAoIWNoaWxkVmlldykgewogICAgICAgIHRocm93IG5ldyBNYXJpb25ldHRlLkVycm9yKHsKICAgICAgICAgIG5hbWU6ICdOb0NoaWxkVmlld0Vycm9yJywKICAgICAgICAgIG1lc3NhZ2U6ICdBICJjaGlsZFZpZXciIG11c3QgYmUgc3BlY2lmaWVkJwogICAgICAgIH0pOwogICAgICB9CiAgICAgIHJldHVybiBjaGlsZFZpZXc7CiAgICB9LAogICAgLy8gUmVuZGVyIHRoZSBjaGlsZCdzIHZpZXcgYW5kIGFkZCBpdCB0byB0aGUKICAgIC8vIEhUTUwgZm9yIHRoZSBjb2xsZWN0aW9uIHZpZXcgYXQgYSBnaXZlbiBpbmRleC4KICAgIC8vIFRoaXMgd2lsbCBhbHNvIHVwZGF0ZSB0aGUgaW5kaWNlcyBvZiBsYXRlciB2aWV3cyBpbiB0aGUgY29sbGVjdGlvbgogICAgLy8gaW4gb3JkZXIgdG8ga2VlcCB0aGUgY2hpbGRyZW4gaW4gc3luYyB3aXRoIHRoZSBjb2xsZWN0aW9uLgogICAgYWRkQ2hpbGQ6IGZ1bmN0aW9uIChjaGlsZCwgQ2hpbGRWaWV3LCBpbmRleCkgewogICAgICB2YXIgY2hpbGRWaWV3T3B0aW9ucyA9IHRoaXMuZ2V0T3B0aW9uKCdjaGlsZFZpZXdPcHRpb25zJyk7CiAgICAgIGlmIChfLmlzRnVuY3Rpb24oY2hpbGRWaWV3T3B0aW9ucykpIHsKICAgICAgICBjaGlsZFZpZXdPcHRpb25zID0gY2hpbGRWaWV3T3B0aW9ucy5jYWxsKHRoaXMsIGNoaWxkLCBpbmRleCk7CiAgICAgIH0KICAgICAgdmFyIHZpZXcgPSB0aGlzLmJ1aWxkQ2hpbGRWaWV3KGNoaWxkLCBDaGlsZFZpZXcsIGNoaWxkVmlld09wdGlvbnMpOwogICAgICAvLyBpbmNyZW1lbnQgaW5kaWNlcyBvZiB2aWV3cyBhZnRlciB0aGlzIG9uZQogICAgICB0aGlzLl91cGRhdGVJbmRpY2VzKHZpZXcsIHRydWUsIGluZGV4KTsKICAgICAgdGhpcy5fYWRkQ2hpbGRWaWV3KHZpZXcsIGluZGV4KTsKICAgICAgcmV0dXJuIHZpZXc7CiAgICB9LAogICAgLy8gSW50ZXJuYWwgbWV0aG9kLiBUaGlzIGRlY3JlbWVudHMgb3IgaW5jcmVtZW50cyB0aGUgaW5kaWNlcyBvZiB2aWV3cyBhZnRlciB0aGUKICAgIC8vIGFkZGVkL3JlbW92ZWQgdmlldyB0byBrZWVwIGluIHN5bmMgd2l0aCB0aGUgY29sbGVjdGlvbi4KICAgIF91cGRhdGVJbmRpY2VzOiBmdW5jdGlvbiAodmlldywgaW5jcmVtZW50LCBpbmRleCkgewogICAgICBpZiAoIXRoaXMuc29ydCkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBpZiAoaW5jcmVtZW50KSB7CiAgICAgICAgLy8gYXNzaWduIHRoZSBpbmRleCB0byB0aGUgdmlldwogICAgICAgIHZpZXcuX2luZGV4ID0gaW5kZXg7CiAgICAgICAgLy8gaW5jcmVtZW50IHRoZSBpbmRleCBvZiB2aWV3cyBhZnRlciB0aGlzIG9uZQogICAgICAgIHRoaXMuY2hpbGRyZW4uZWFjaChmdW5jdGlvbiAobGF0ZXJWaWV3KSB7CiAgICAgICAgICBpZiAobGF0ZXJWaWV3Ll9pbmRleCA+PSB2aWV3Ll9pbmRleCkgewogICAgICAgICAgICBsYXRlclZpZXcuX2luZGV4Kys7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gZGVjcmVtZW50IHRoZSBpbmRleCBvZiB2aWV3cyBhZnRlciB0aGlzIG9uZQogICAgICAgIHRoaXMuY2hpbGRyZW4uZWFjaChmdW5jdGlvbiAobGF0ZXJWaWV3KSB7CiAgICAgICAgICBpZiAobGF0ZXJWaWV3Ll9pbmRleCA+PSB2aWV3Ll9pbmRleCkgewogICAgICAgICAgICBsYXRlclZpZXcuX2luZGV4LS07CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0sCiAgICAvLyBJbnRlcm5hbCBNZXRob2QuIEFkZCB0aGUgdmlldyB0byBjaGlsZHJlbiBhbmQgcmVuZGVyIGl0IGF0CiAgICAvLyB0aGUgZ2l2ZW4gaW5kZXguCiAgICBfYWRkQ2hpbGRWaWV3OiBmdW5jdGlvbiAodmlldywgaW5kZXgpIHsKICAgICAgLy8gc2V0IHVwIHRoZSBjaGlsZCB2aWV3IGV2ZW50IGZvcndhcmRpbmcKICAgICAgdGhpcy5wcm94eUNoaWxkRXZlbnRzKHZpZXcpOwogICAgICB0aGlzLnRyaWdnZXJNZXRob2QoJ2JlZm9yZTphZGQ6Y2hpbGQnLCB2aWV3KTsKICAgICAgLy8gU3RvcmUgdGhlIGNoaWxkIHZpZXcgaXRzZWxmIHNvIHdlIGNhbiBwcm9wZXJseQogICAgICAvLyByZW1vdmUgYW5kL29yIGRlc3Ryb3kgaXQgbGF0ZXIKICAgICAgdGhpcy5jaGlsZHJlbi5hZGQodmlldyk7CiAgICAgIHRoaXMucmVuZGVyQ2hpbGRWaWV3KHZpZXcsIGluZGV4KTsKICAgICAgaWYgKHRoaXMuX2lzU2hvd24gJiYgIXRoaXMuaXNCdWZmZXJpbmcpIHsKICAgICAgICBNYXJpb25ldHRlLnRyaWdnZXJNZXRob2RPbih2aWV3LCAnc2hvdycpOwogICAgICB9CiAgICAgIHRoaXMudHJpZ2dlck1ldGhvZCgnYWRkOmNoaWxkJywgdmlldyk7CiAgICB9LAogICAgLy8gcmVuZGVyIHRoZSBjaGlsZCB2aWV3CiAgICByZW5kZXJDaGlsZFZpZXc6IGZ1bmN0aW9uICh2aWV3LCBpbmRleCkgewogICAgICB2aWV3LnJlbmRlcigpOwogICAgICB0aGlzLmF0dGFjaEh0bWwodGhpcywgdmlldywgaW5kZXgpOwogICAgICByZXR1cm4gdmlldzsKICAgIH0sCiAgICAvLyBCdWlsZCBhIGBjaGlsZFZpZXdgIGZvciBhIG1vZGVsIGluIHRoZSBjb2xsZWN0aW9uLgogICAgYnVpbGRDaGlsZFZpZXc6IGZ1bmN0aW9uIChjaGlsZCwgQ2hpbGRWaWV3Q2xhc3MsIGNoaWxkVmlld09wdGlvbnMpIHsKICAgICAgdmFyIG9wdGlvbnMgPSBfLmV4dGVuZCh7IG1vZGVsOiBjaGlsZCB9LCBjaGlsZFZpZXdPcHRpb25zKTsKICAgICAgcmV0dXJuIG5ldyBDaGlsZFZpZXdDbGFzcyhvcHRpb25zKTsKICAgIH0sCiAgICAvLyBSZW1vdmUgdGhlIGNoaWxkIHZpZXcgYW5kIGRlc3Ryb3kgaXQuCiAgICAvLyBUaGlzIGZ1bmN0aW9uIGFsc28gdXBkYXRlcyB0aGUgaW5kaWNlcyBvZgogICAgLy8gbGF0ZXIgdmlld3MgaW4gdGhlIGNvbGxlY3Rpb24gaW4gb3JkZXIgdG8ga2VlcAogICAgLy8gdGhlIGNoaWxkcmVuIGluIHN5bmMgd2l0aCB0aGUgY29sbGVjdGlvbi4KICAgIHJlbW92ZUNoaWxkVmlldzogZnVuY3Rpb24gKHZpZXcpIHsKICAgICAgaWYgKHZpZXcpIHsKICAgICAgICB0aGlzLnRyaWdnZXJNZXRob2QoJ2JlZm9yZTpyZW1vdmU6Y2hpbGQnLCB2aWV3KTsKICAgICAgICAvLyBjYWxsICdkZXN0cm95JyBvciAncmVtb3ZlJywgZGVwZW5kaW5nIG9uIHdoaWNoIGlzIGZvdW5kCiAgICAgICAgaWYgKHZpZXcuZGVzdHJveSkgewogICAgICAgICAgdmlldy5kZXN0cm95KCk7CiAgICAgICAgfSBlbHNlIGlmICh2aWV3LnJlbW92ZSkgewogICAgICAgICAgdmlldy5yZW1vdmUoKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5zdG9wTGlzdGVuaW5nKHZpZXcpOwogICAgICAgIHRoaXMuY2hpbGRyZW4ucmVtb3ZlKHZpZXcpOwogICAgICAgIHRoaXMudHJpZ2dlck1ldGhvZCgncmVtb3ZlOmNoaWxkJywgdmlldyk7CiAgICAgICAgLy8gZGVjcmVtZW50IHRoZSBpbmRleCBvZiB2aWV3cyBhZnRlciB0aGlzIG9uZQogICAgICAgIHRoaXMuX3VwZGF0ZUluZGljZXModmlldywgZmFsc2UpOwogICAgICB9CiAgICAgIHJldHVybiB2aWV3OwogICAgfSwKICAgIC8vIGNoZWNrIGlmIHRoZSBjb2xsZWN0aW9uIGlzIGVtcHR5CiAgICBpc0VtcHR5OiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiAhdGhpcy5jb2xsZWN0aW9uIHx8IHRoaXMuY29sbGVjdGlvbi5sZW5ndGggPT09IDA7CiAgICB9LAogICAgLy8gSWYgZW1wdHksIHNob3cgdGhlIGVtcHR5IHZpZXcKICAgIGNoZWNrRW1wdHk6IGZ1bmN0aW9uICgpIHsKICAgICAgaWYgKHRoaXMuaXNFbXB0eSh0aGlzLmNvbGxlY3Rpb24pKSB7CiAgICAgICAgdGhpcy5zaG93RW1wdHlWaWV3KCk7CiAgICAgIH0KICAgIH0sCiAgICAvLyBZb3UgbWlnaHQgbmVlZCB0byBvdmVycmlkZSB0aGlzIGlmIHlvdSd2ZSBvdmVycmlkZGVuIGF0dGFjaEh0bWwKICAgIGF0dGFjaEJ1ZmZlcjogZnVuY3Rpb24gKGNvbGxlY3Rpb25WaWV3LCBidWZmZXIpIHsKICAgICAgY29sbGVjdGlvblZpZXcuJGVsLmFwcGVuZChidWZmZXIpOwogICAgfSwKICAgIC8vIEFwcGVuZCB0aGUgSFRNTCB0byB0aGUgY29sbGVjdGlvbidzIGBlbGAuCiAgICAvLyBPdmVycmlkZSB0aGlzIG1ldGhvZCB0byBkbyBzb21ldGhpbmcgb3RoZXIKICAgIC8vIHRoYW4gYC5hcHBlbmRgLgogICAgYXR0YWNoSHRtbDogZnVuY3Rpb24gKGNvbGxlY3Rpb25WaWV3LCBjaGlsZFZpZXcsIGluZGV4KSB7CiAgICAgIGlmIChjb2xsZWN0aW9uVmlldy5pc0J1ZmZlcmluZykgewogICAgICAgIC8vIGJ1ZmZlcmluZyBoYXBwZW5zIG9uIHJlc2V0IGV2ZW50cyBhbmQgaW5pdGlhbCByZW5kZXJzCiAgICAgICAgLy8gaW4gb3JkZXIgdG8gcmVkdWNlIHRoZSBudW1iZXIgb2YgaW5zZXJ0cyBpbnRvIHRoZQogICAgICAgIC8vIGRvY3VtZW50LCB3aGljaCBhcmUgZXhwZW5zaXZlLgogICAgICAgIGNvbGxlY3Rpb25WaWV3LmVsQnVmZmVyLmFwcGVuZENoaWxkKGNoaWxkVmlldy5lbCk7CiAgICAgICAgY29sbGVjdGlvblZpZXcuX2J1ZmZlcmVkQ2hpbGRyZW4ucHVzaChjaGlsZFZpZXcpOwogICAgICB9IGVsc2UgewogICAgICAgIC8vIElmIHdlJ3ZlIGFscmVhZHkgcmVuZGVyZWQgdGhlIG1haW4gY29sbGVjdGlvbiwgYXBwZW5kCiAgICAgICAgLy8gdGhlIG5ldyBjaGlsZCBpbnRvIHRoZSBjb3JyZWN0IG9yZGVyIGlmIHdlIG5lZWQgdG8uIE90aGVyd2lzZQogICAgICAgIC8vIGFwcGVuZCB0byB0aGUgZW5kLgogICAgICAgIGlmICghY29sbGVjdGlvblZpZXcuX2luc2VydEJlZm9yZShjaGlsZFZpZXcsIGluZGV4KSkgewogICAgICAgICAgY29sbGVjdGlvblZpZXcuX2luc2VydEFmdGVyKGNoaWxkVmlldyk7CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgLy8gSW50ZXJuYWwgbWV0aG9kLiBDaGVjayB3aGV0aGVyIHdlIG5lZWQgdG8gaW5zZXJ0IHRoZSB2aWV3IGludG8KICAgIC8vIHRoZSBjb3JyZWN0IHBvc2l0aW9uLgogICAgX2luc2VydEJlZm9yZTogZnVuY3Rpb24gKGNoaWxkVmlldywgaW5kZXgpIHsKICAgICAgdmFyIGN1cnJlbnRWaWV3OwogICAgICB2YXIgZmluZFBvc2l0aW9uID0gdGhpcy5zb3J0ICYmIGluZGV4IDwgdGhpcy5jaGlsZHJlbi5sZW5ndGggLSAxOwogICAgICBpZiAoZmluZFBvc2l0aW9uKSB7CiAgICAgICAgLy8gRmluZCB0aGUgdmlldyBhZnRlciB0aGlzIG9uZQogICAgICAgIGN1cnJlbnRWaWV3ID0gdGhpcy5jaGlsZHJlbi5maW5kKGZ1bmN0aW9uICh2aWV3KSB7CiAgICAgICAgICByZXR1cm4gdmlldy5faW5kZXggPT09IGluZGV4ICsgMTsKICAgICAgICB9KTsKICAgICAgfQogICAgICBpZiAoY3VycmVudFZpZXcpIHsKICAgICAgICBjdXJyZW50Vmlldy4kZWwuYmVmb3JlKGNoaWxkVmlldy5lbCk7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgICAgcmV0dXJuIGZhbHNlOwogICAgfSwKICAgIC8vIEludGVybmFsIG1ldGhvZC4gQXBwZW5kIGEgdmlldyB0byB0aGUgZW5kIG9mIHRoZSAkZWwKICAgIF9pbnNlcnRBZnRlcjogZnVuY3Rpb24gKGNoaWxkVmlldykgewogICAgICB0aGlzLiRlbC5hcHBlbmQoY2hpbGRWaWV3LmVsKTsKICAgIH0sCiAgICAvLyBJbnRlcm5hbCBtZXRob2QgdG8gc2V0IHVwIHRoZSBgY2hpbGRyZW5gIG9iamVjdCBmb3IKICAgIC8vIHN0b3JpbmcgYWxsIG9mIHRoZSBjaGlsZCB2aWV3cwogICAgX2luaXRDaGlsZFZpZXdTdG9yYWdlOiBmdW5jdGlvbiAoKSB7CiAgICAgIHRoaXMuY2hpbGRyZW4gPSBuZXcgQmFja2JvbmUuQ2hpbGRWaWV3Q29udGFpbmVyKCk7CiAgICB9LAogICAgLy8gSGFuZGxlIGNsZWFudXAgYW5kIG90aGVyIGRlc3Ryb3lpbmcgbmVlZHMgZm9yIHRoZSBjb2xsZWN0aW9uIG9mIHZpZXdzCiAgICBkZXN0cm95OiBmdW5jdGlvbiAoKSB7CiAgICAgIGlmICh0aGlzLmlzRGVzdHJveWVkKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIHRoaXMudHJpZ2dlck1ldGhvZCgnYmVmb3JlOmRlc3Ryb3k6Y29sbGVjdGlvbicpOwogICAgICB0aGlzLmRlc3Ryb3lDaGlsZHJlbigpOwogICAgICB0aGlzLnRyaWdnZXJNZXRob2QoJ2Rlc3Ryb3k6Y29sbGVjdGlvbicpOwogICAgICByZXR1cm4gTWFyaW9uZXR0ZS5WaWV3LnByb3RvdHlwZS5kZXN0cm95LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9LAogICAgLy8gRGVzdHJveSB0aGUgY2hpbGQgdmlld3MgdGhhdCB0aGlzIGNvbGxlY3Rpb24gdmlldwogICAgLy8gaXMgaG9sZGluZyBvbiB0bywgaWYgYW55CiAgICBkZXN0cm95Q2hpbGRyZW46IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIGNoaWxkVmlld3MgPSB0aGlzLmNoaWxkcmVuLm1hcChfLmlkZW50aXR5KTsKICAgICAgdGhpcy5jaGlsZHJlbi5lYWNoKHRoaXMucmVtb3ZlQ2hpbGRWaWV3LCB0aGlzKTsKICAgICAgdGhpcy5jaGVja0VtcHR5KCk7CiAgICAgIHJldHVybiBjaGlsZFZpZXdzOwogICAgfSwKICAgIC8vIFNldCB1cCB0aGUgY2hpbGQgdmlldyBldmVudCBmb3J3YXJkaW5nLiBVc2VzIGEgImNoaWxkdmlldzoiCiAgICAvLyBwcmVmaXggaW4gZnJvbnQgb2YgYWxsIGZvcndhcmRlZCBldmVudHMuCiAgICBwcm94eUNoaWxkRXZlbnRzOiBmdW5jdGlvbiAodmlldykgewogICAgICB2YXIgcHJlZml4ID0gdGhpcy5nZXRPcHRpb24oJ2NoaWxkVmlld0V2ZW50UHJlZml4Jyk7CiAgICAgIC8vIEZvcndhcmQgYWxsIGNoaWxkIHZpZXcgZXZlbnRzIHRocm91Z2ggdGhlIHBhcmVudCwKICAgICAgLy8gcHJlcGVuZGluZyAiY2hpbGR2aWV3OiIgdG8gdGhlIGV2ZW50IG5hbWUKICAgICAgdGhpcy5saXN0ZW5Ubyh2aWV3LCAnYWxsJywgZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMpOwogICAgICAgIHZhciByb290RXZlbnQgPSBhcmdzWzBdOwogICAgICAgIHZhciBjaGlsZEV2ZW50cyA9IHRoaXMubm9ybWFsaXplTWV0aG9kcyhfLnJlc3VsdCh0aGlzLCAnY2hpbGRFdmVudHMnKSk7CiAgICAgICAgYXJnc1swXSA9IHByZWZpeCArICc6JyArIHJvb3RFdmVudDsKICAgICAgICBhcmdzLnNwbGljZSgxLCAwLCB2aWV3KTsKICAgICAgICAvLyBjYWxsIGNvbGxlY3Rpb25WaWV3IGNoaWxkRXZlbnQgaWYgZGVmaW5lZAogICAgICAgIGlmICh0eXBlb2YgY2hpbGRFdmVudHMgIT09ICd1bmRlZmluZWQnICYmIF8uaXNGdW5jdGlvbihjaGlsZEV2ZW50c1tyb290RXZlbnRdKSkgewogICAgICAgICAgY2hpbGRFdmVudHNbcm9vdEV2ZW50XS5hcHBseSh0aGlzLCBhcmdzLnNsaWNlKDEpKTsKICAgICAgICB9CiAgICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgICB9LCB0aGlzKTsKICAgIH0KICB9KTsKICAvKiBqc2hpbnQgbWF4c3RhdGVtZW50czogMTcsIG1heGxlbjogMTE3ICovCiAgLy8gQ29tcG9zaXRlIFZpZXcKICAvLyAtLS0tLS0tLS0tLS0tLQogIC8vIFVzZWQgZm9yIHJlbmRlcmluZyBhIGJyYW5jaC1sZWFmLCBoaWVyYXJjaGljYWwgc3RydWN0dXJlLgogIC8vIEV4dGVuZHMgZGlyZWN0bHkgZnJvbSBDb2xsZWN0aW9uVmlldyBhbmQgYWxzbyByZW5kZXJzIGFuCiAgLy8gYSBjaGlsZCB2aWV3IGFzIGBtb2RlbFZpZXdgLCBmb3IgdGhlIHRvcCBsZWFmCiAgTWFyaW9uZXR0ZS5Db21wb3NpdGVWaWV3ID0gTWFyaW9uZXR0ZS5Db2xsZWN0aW9uVmlldy5leHRlbmQoewogICAgLy8gU2V0dGluZyB1cCB0aGUgaW5oZXJpdGFuY2UgY2hhaW4gd2hpY2ggYWxsb3dzIGNoYW5nZXMgdG8KICAgIC8vIE1hcmlvbmV0dGUuQ29sbGVjdGlvblZpZXcucHJvdG90eXBlLmNvbnN0cnVjdG9yIHdoaWNoIGFsbG93cyBvdmVycmlkaW5nCiAgICAvLyBvcHRpb24gdG8gcGFzcyAne3NvcnQ6IGZhbHNlfScgdG8gcHJldmVudCB0aGUgQ29tcG9zaXRlVmlldyBmcm9tCiAgICAvLyBtYWludGFpbmluZyB0aGUgc29ydGVkIG9yZGVyIG9mIHRoZSBjb2xsZWN0aW9uLgogICAgLy8gVGhpcyB3aWxsIGZhbGxiYWNrIG9udG8gYXBwZW5kaW5nIGNoaWxkVmlldydzIHRvIHRoZSBlbmQuCiAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24gKCkgewogICAgICBNYXJpb25ldHRlLkNvbGxlY3Rpb25WaWV3LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9LAogICAgLy8gQ29uZmlndXJlZCB0aGUgaW5pdGlhbCBldmVudHMgdGhhdCB0aGUgY29tcG9zaXRlIHZpZXcKICAgIC8vIGJpbmRzIHRvLiBPdmVycmlkZSB0aGlzIG1ldGhvZCB0byBwcmV2ZW50IHRoZSBpbml0aWFsCiAgICAvLyBldmVudHMsIG9yIHRvIGFkZCB5b3VyIG93biBpbml0aWFsIGV2ZW50cy4KICAgIF9pbml0aWFsRXZlbnRzOiBmdW5jdGlvbiAoKSB7CiAgICAgIC8vIEJpbmQgb25seSBhZnRlciBjb21wb3NpdGUgdmlldyBpcyByZW5kZXJlZCB0byBhdm9pZCBhZGRpbmcgY2hpbGQgdmlld3MKICAgICAgLy8gdG8gbm9uZXhpc3RlbnQgY2hpbGRWaWV3Q29udGFpbmVyCiAgICAgIGlmICh0aGlzLmNvbGxlY3Rpb24pIHsKICAgICAgICB0aGlzLmxpc3RlblRvKHRoaXMuY29sbGVjdGlvbiwgJ2FkZCcsIHRoaXMuX29uQ29sbGVjdGlvbkFkZCk7CiAgICAgICAgdGhpcy5saXN0ZW5Ubyh0aGlzLmNvbGxlY3Rpb24sICdyZW1vdmUnLCB0aGlzLl9vbkNvbGxlY3Rpb25SZW1vdmUpOwogICAgICAgIHRoaXMubGlzdGVuVG8odGhpcy5jb2xsZWN0aW9uLCAncmVzZXQnLCB0aGlzLl9yZW5kZXJDaGlsZHJlbik7CiAgICAgICAgaWYgKHRoaXMuc29ydCkgewogICAgICAgICAgdGhpcy5saXN0ZW5Ubyh0aGlzLmNvbGxlY3Rpb24sICdzb3J0JywgdGhpcy5fc29ydFZpZXdzKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICAvLyBSZXRyaWV2ZSB0aGUgYGNoaWxkVmlld2AgdG8gYmUgdXNlZCB3aGVuIHJlbmRlcmluZyBlYWNoIG9mCiAgICAvLyB0aGUgaXRlbXMgaW4gdGhlIGNvbGxlY3Rpb24uIFRoZSBkZWZhdWx0IGlzIHRvIHJldHVybgogICAgLy8gYHRoaXMuY2hpbGRWaWV3YCBvciBNYXJpb25ldHRlLkNvbXBvc2l0ZVZpZXcgaWYgbm8gYGNoaWxkVmlld2AKICAgIC8vIGhhcyBiZWVuIGRlZmluZWQKICAgIGdldENoaWxkVmlldzogZnVuY3Rpb24gKGNoaWxkKSB7CiAgICAgIHZhciBjaGlsZFZpZXcgPSB0aGlzLmdldE9wdGlvbignY2hpbGRWaWV3JykgfHwgdGhpcy5jb25zdHJ1Y3RvcjsKICAgICAgaWYgKCFjaGlsZFZpZXcpIHsKICAgICAgICB0aHJvdyBuZXcgTWFyaW9uZXR0ZS5FcnJvcih7CiAgICAgICAgICBuYW1lOiAnTm9DaGlsZFZpZXdFcnJvcicsCiAgICAgICAgICBtZXNzYWdlOiAnQSAiY2hpbGRWaWV3IiBtdXN0IGJlIHNwZWNpZmllZCcKICAgICAgICB9KTsKICAgICAgfQogICAgICByZXR1cm4gY2hpbGRWaWV3OwogICAgfSwKICAgIC8vIFNlcmlhbGl6ZSB0aGUgY29sbGVjdGlvbiBmb3IgdGhlIHZpZXcuCiAgICAvLyBZb3UgY2FuIG92ZXJyaWRlIHRoZSBgc2VyaWFsaXplRGF0YWAgbWV0aG9kIGluIHlvdXIgb3duIHZpZXcKICAgIC8vIGRlZmluaXRpb24sIHRvIHByb3ZpZGUgY3VzdG9tIHNlcmlhbGl6YXRpb24gZm9yIHlvdXIgdmlldydzIGRhdGEuCiAgICBzZXJpYWxpemVEYXRhOiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBkYXRhID0ge307CiAgICAgIGlmICh0aGlzLm1vZGVsKSB7CiAgICAgICAgZGF0YSA9IF8ucGFydGlhbCh0aGlzLnNlcmlhbGl6ZU1vZGVsLCB0aGlzLm1vZGVsKS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9CiAgICAgIHJldHVybiBkYXRhOwogICAgfSwKICAgIC8vIFJlbmRlcnMgdGhlIG1vZGVsIG9uY2UsIGFuZCB0aGUgY29sbGVjdGlvbiBvbmNlLiBDYWxsaW5nCiAgICAvLyB0aGlzIGFnYWluIHdpbGwgdGVsbCB0aGUgbW9kZWwncyB2aWV3IHRvIHJlLXJlbmRlciBpdHNlbGYKICAgIC8vIGJ1dCB0aGUgY29sbGVjdGlvbiB3aWxsIG5vdCByZS1yZW5kZXIuCiAgICByZW5kZXI6IGZ1bmN0aW9uICgpIHsKICAgICAgdGhpcy5fZW5zdXJlVmlld0lzSW50YWN0KCk7CiAgICAgIHRoaXMuaXNSZW5kZXJlZCA9IHRydWU7CiAgICAgIHRoaXMucmVzZXRDaGlsZFZpZXdDb250YWluZXIoKTsKICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdiZWZvcmU6cmVuZGVyJywgdGhpcyk7CiAgICAgIHRoaXMuX3JlbmRlclRlbXBsYXRlKCk7CiAgICAgIHRoaXMuX3JlbmRlckNoaWxkcmVuKCk7CiAgICAgIHRoaXMudHJpZ2dlck1ldGhvZCgncmVuZGVyJywgdGhpcyk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAgIF9yZW5kZXJDaGlsZHJlbjogZnVuY3Rpb24gKCkgewogICAgICBpZiAodGhpcy5pc1JlbmRlcmVkKSB7CiAgICAgICAgTWFyaW9uZXR0ZS5Db2xsZWN0aW9uVmlldy5wcm90b3R5cGUuX3JlbmRlckNoaWxkcmVuLmNhbGwodGhpcyk7CiAgICAgIH0KICAgIH0sCiAgICAvLyBSZW5kZXIgdGhlIHJvb3QgdGVtcGxhdGUgdGhhdCB0aGUgY2hpbGRyZW4KICAgIC8vIHZpZXdzIGFyZSBhcHBlbmRlZCB0bwogICAgX3JlbmRlclRlbXBsYXRlOiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBkYXRhID0ge307CiAgICAgIGRhdGEgPSB0aGlzLnNlcmlhbGl6ZURhdGEoKTsKICAgICAgZGF0YSA9IHRoaXMubWl4aW5UZW1wbGF0ZUhlbHBlcnMoZGF0YSk7CiAgICAgIHRoaXMudHJpZ2dlck1ldGhvZCgnYmVmb3JlOnJlbmRlcjp0ZW1wbGF0ZScpOwogICAgICB2YXIgdGVtcGxhdGUgPSB0aGlzLmdldFRlbXBsYXRlKCk7CiAgICAgIHZhciBodG1sID0gTWFyaW9uZXR0ZS5SZW5kZXJlci5yZW5kZXIodGVtcGxhdGUsIGRhdGEsIHRoaXMpOwogICAgICB0aGlzLmF0dGFjaEVsQ29udGVudChodG1sKTsKICAgICAgLy8gdGhlIHVpIGJpbmRpbmdzIGlzIGRvbmUgaGVyZSBhbmQgbm90IGF0IHRoZSBlbmQgb2YgcmVuZGVyIHNpbmNlIHRoZXkKICAgICAgLy8gd2lsbCBub3QgYmUgYXZhaWxhYmxlIHVudGlsIGFmdGVyIHRoZSBtb2RlbCBpcyByZW5kZXJlZCwgYnV0IHNob3VsZCBiZQogICAgICAvLyBhdmFpbGFibGUgYmVmb3JlIHRoZSBjb2xsZWN0aW9uIGlzIHJlbmRlcmVkLgogICAgICB0aGlzLmJpbmRVSUVsZW1lbnRzKCk7CiAgICAgIHRoaXMudHJpZ2dlck1ldGhvZCgncmVuZGVyOnRlbXBsYXRlJyk7CiAgICB9LAogICAgLy8gQXR0YWNoZXMgdGhlIGNvbnRlbnQgb2YgdGhlIHJvb3QuCiAgICAvLyBUaGlzIG1ldGhvZCBjYW4gYmUgb3ZlcnJpZGRlbiB0byBvcHRpbWl6ZSByZW5kZXJpbmcsCiAgICAvLyBvciB0byByZW5kZXIgaW4gYSBub24gc3RhbmRhcmQgd2F5LgogICAgLy8KICAgIC8vIEZvciBleGFtcGxlLCB1c2luZyBgaW5uZXJIVE1MYCBpbnN0ZWFkIG9mIGAkZWwuaHRtbGAKICAgIC8vCiAgICAvLyBgYGBqcwogICAgLy8gYXR0YWNoRWxDb250ZW50OiBmdW5jdGlvbihodG1sKSB7CiAgICAvLyAgIHRoaXMuZWwuaW5uZXJIVE1MID0gaHRtbDsKICAgIC8vICAgcmV0dXJuIHRoaXM7CiAgICAvLyB9CiAgICAvLyBgYGAKICAgIGF0dGFjaEVsQ29udGVudDogZnVuY3Rpb24gKGh0bWwpIHsKICAgICAgdGhpcy4kZWwuaHRtbChodG1sKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogICAgLy8gWW91IG1pZ2h0IG5lZWQgdG8gb3ZlcnJpZGUgdGhpcyBpZiB5b3UndmUgb3ZlcnJpZGRlbiBhdHRhY2hIdG1sCiAgICBhdHRhY2hCdWZmZXI6IGZ1bmN0aW9uIChjb21wb3NpdGVWaWV3LCBidWZmZXIpIHsKICAgICAgdmFyICRjb250YWluZXIgPSB0aGlzLmdldENoaWxkVmlld0NvbnRhaW5lcihjb21wb3NpdGVWaWV3KTsKICAgICAgJGNvbnRhaW5lci5hcHBlbmQoYnVmZmVyKTsKICAgIH0sCiAgICAvLyBJbnRlcm5hbCBtZXRob2QuIEFwcGVuZCBhIHZpZXcgdG8gdGhlIGVuZCBvZiB0aGUgJGVsLgogICAgLy8gT3ZlcmlkZGVuIGZyb20gQ29sbGVjdGlvblZpZXcgdG8gZW5zdXJlIHZpZXcgaXMgYXBwZW5kZWQgdG8KICAgIC8vIGNoaWxkVmlld0NvbnRhaW5lcgogICAgX2luc2VydEFmdGVyOiBmdW5jdGlvbiAoY2hpbGRWaWV3KSB7CiAgICAgIHZhciAkY29udGFpbmVyID0gdGhpcy5nZXRDaGlsZFZpZXdDb250YWluZXIodGhpcyk7CiAgICAgICRjb250YWluZXIuYXBwZW5kKGNoaWxkVmlldy5lbCk7CiAgICB9LAogICAgLy8gSW50ZXJuYWwgbWV0aG9kIHRvIGVuc3VyZSBhbiBgJGNoaWxkVmlld0NvbnRhaW5lcmAgZXhpc3RzLCBmb3IgdGhlCiAgICAvLyBgYXR0YWNoSHRtbGAgbWV0aG9kIHRvIHVzZS4KICAgIGdldENoaWxkVmlld0NvbnRhaW5lcjogZnVuY3Rpb24gKGNvbnRhaW5lclZpZXcpIHsKICAgICAgaWYgKCckY2hpbGRWaWV3Q29udGFpbmVyJyBpbiBjb250YWluZXJWaWV3KSB7CiAgICAgICAgcmV0dXJuIGNvbnRhaW5lclZpZXcuJGNoaWxkVmlld0NvbnRhaW5lcjsKICAgICAgfQogICAgICB2YXIgY29udGFpbmVyOwogICAgICB2YXIgY2hpbGRWaWV3Q29udGFpbmVyID0gTWFyaW9uZXR0ZS5nZXRPcHRpb24oY29udGFpbmVyVmlldywgJ2NoaWxkVmlld0NvbnRhaW5lcicpOwogICAgICBpZiAoY2hpbGRWaWV3Q29udGFpbmVyKSB7CiAgICAgICAgdmFyIHNlbGVjdG9yID0gXy5pc0Z1bmN0aW9uKGNoaWxkVmlld0NvbnRhaW5lcikgPyBjaGlsZFZpZXdDb250YWluZXIuY2FsbChjb250YWluZXJWaWV3KSA6IGNoaWxkVmlld0NvbnRhaW5lcjsKICAgICAgICBpZiAoc2VsZWN0b3IuY2hhckF0KDApID09PSAnQCcgJiYgY29udGFpbmVyVmlldy51aSkgewogICAgICAgICAgY29udGFpbmVyID0gY29udGFpbmVyVmlldy51aVtzZWxlY3Rvci5zdWJzdHIoNCldOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjb250YWluZXIgPSBjb250YWluZXJWaWV3LiQoc2VsZWN0b3IpOwogICAgICAgIH0KICAgICAgICBpZiAoY29udGFpbmVyLmxlbmd0aCA8PSAwKSB7CiAgICAgICAgICB0aHJvdyBuZXcgTWFyaW9uZXR0ZS5FcnJvcih7CiAgICAgICAgICAgIG5hbWU6ICdDaGlsZFZpZXdDb250YWluZXJNaXNzaW5nRXJyb3InLAogICAgICAgICAgICBtZXNzYWdlOiAnVGhlIHNwZWNpZmllZCAiY2hpbGRWaWV3Q29udGFpbmVyIiB3YXMgbm90IGZvdW5kOiAnICsgY29udGFpbmVyVmlldy5jaGlsZFZpZXdDb250YWluZXIKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBjb250YWluZXIgPSBjb250YWluZXJWaWV3LiRlbDsKICAgICAgfQogICAgICBjb250YWluZXJWaWV3LiRjaGlsZFZpZXdDb250YWluZXIgPSBjb250YWluZXI7CiAgICAgIHJldHVybiBjb250YWluZXI7CiAgICB9LAogICAgLy8gSW50ZXJuYWwgbWV0aG9kIHRvIHJlc2V0IHRoZSBgJGNoaWxkVmlld0NvbnRhaW5lcmAgb24gcmVuZGVyCiAgICByZXNldENoaWxkVmlld0NvbnRhaW5lcjogZnVuY3Rpb24gKCkgewogICAgICBpZiAodGhpcy4kY2hpbGRWaWV3Q29udGFpbmVyKSB7CiAgICAgICAgZGVsZXRlIHRoaXMuJGNoaWxkVmlld0NvbnRhaW5lcjsKICAgICAgfQogICAgfQogIH0pOwogIC8vIExheW91dFZpZXcKICAvLyAtLS0tLS0tLS0tCiAgLy8gVXNlZCBmb3IgbWFuYWdpbmcgYXBwbGljYXRpb24gbGF5b3V0Vmlld3MsIG5lc3RlZCBsYXlvdXRWaWV3cyBhbmQKICAvLyBtdWx0aXBsZSByZWdpb25zIHdpdGhpbiBhbiBhcHBsaWNhdGlvbiBvciBzdWItYXBwbGljYXRpb24uCiAgLy8KICAvLyBBIHNwZWNpYWxpemVkIHZpZXcgY2xhc3MgdGhhdCByZW5kZXJzIGFuIGFyZWEgb2YgSFRNTCBhbmQgdGhlbgogIC8vIGF0dGFjaGVzIGBSZWdpb25gIGluc3RhbmNlcyB0byB0aGUgc3BlY2lmaWVkIGByZWdpb25zYC4KICAvLyBVc2VkIGZvciBjb21wb3NpdGUgdmlldyBtYW5hZ2VtZW50IGFuZCBzdWItYXBwbGljYXRpb24gYXJlYXMuCiAgTWFyaW9uZXR0ZS5MYXlvdXRWaWV3ID0gTWFyaW9uZXR0ZS5JdGVtVmlldy5leHRlbmQoewogICAgcmVnaW9uQ2xhc3M6IE1hcmlvbmV0dGUuUmVnaW9uLAogICAgLy8gRW5zdXJlIHRoZSByZWdpb25zIGFyZSBhdmFpbGFibGUgd2hlbiB0aGUgYGluaXRpYWxpemVgIG1ldGhvZAogICAgLy8gaXMgY2FsbGVkLgogICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uIChvcHRpb25zKSB7CiAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogICAgICB0aGlzLl9maXJzdFJlbmRlciA9IHRydWU7CiAgICAgIHRoaXMuX2luaXRpYWxpemVSZWdpb25zKG9wdGlvbnMpOwogICAgICBNYXJpb25ldHRlLkl0ZW1WaWV3LmNhbGwodGhpcywgb3B0aW9ucyk7CiAgICB9LAogICAgLy8gTGF5b3V0VmlldydzIHJlbmRlciB3aWxsIHVzZSB0aGUgZXhpc3RpbmcgcmVnaW9uIG9iamVjdHMgdGhlCiAgICAvLyBmaXJzdCB0aW1lIGl0IGlzIGNhbGxlZC4gU3Vic2VxdWVudCBjYWxscyB3aWxsIGRlc3Ryb3kgdGhlCiAgICAvLyB2aWV3cyB0aGF0IHRoZSByZWdpb25zIGFyZSBzaG93aW5nIGFuZCB0aGVuIHJlc2V0IHRoZSBgZWxgCiAgICAvLyBmb3IgdGhlIHJlZ2lvbnMgdG8gdGhlIG5ld2x5IHJlbmRlcmVkIERPTSBlbGVtZW50cy4KICAgIHJlbmRlcjogZnVuY3Rpb24gKCkgewogICAgICB0aGlzLl9lbnN1cmVWaWV3SXNJbnRhY3QoKTsKICAgICAgaWYgKHRoaXMuX2ZpcnN0UmVuZGVyKSB7CiAgICAgICAgLy8gaWYgdGhpcyBpcyB0aGUgZmlyc3QgcmVuZGVyLCBkb24ndCBkbyBhbnl0aGluZyB0bwogICAgICAgIC8vIHJlc2V0IHRoZSByZWdpb25zCiAgICAgICAgdGhpcy5fZmlyc3RSZW5kZXIgPSBmYWxzZTsKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBJZiB0aGlzIGlzIG5vdCB0aGUgZmlyc3QgcmVuZGVyIGNhbGwsIHRoZW4gd2UgbmVlZCB0bwogICAgICAgIC8vIHJlLWluaXRpYWxpemUgdGhlIGBlbGAgZm9yIGVhY2ggcmVnaW9uCiAgICAgICAgdGhpcy5fcmVJbml0aWFsaXplUmVnaW9ucygpOwogICAgICB9CiAgICAgIHJldHVybiBNYXJpb25ldHRlLkl0ZW1WaWV3LnByb3RvdHlwZS5yZW5kZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH0sCiAgICAvLyBIYW5kbGUgZGVzdHJveWluZyByZWdpb25zLCBhbmQgdGhlbiBkZXN0cm95IHRoZSB2aWV3IGl0c2VsZi4KICAgIGRlc3Ryb3k6IGZ1bmN0aW9uICgpIHsKICAgICAgaWYgKHRoaXMuaXNEZXN0cm95ZWQpIHsKICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfQogICAgICB0aGlzLnJlZ2lvbk1hbmFnZXIuZGVzdHJveSgpOwogICAgICByZXR1cm4gTWFyaW9uZXR0ZS5JdGVtVmlldy5wcm90b3R5cGUuZGVzdHJveS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfSwKICAgIC8vIEFkZCBhIHNpbmdsZSByZWdpb24sIGJ5IG5hbWUsIHRvIHRoZSBsYXlvdXRWaWV3CiAgICBhZGRSZWdpb246IGZ1bmN0aW9uIChuYW1lLCBkZWZpbml0aW9uKSB7CiAgICAgIHRoaXMudHJpZ2dlck1ldGhvZCgnYmVmb3JlOnJlZ2lvbjphZGQnLCBuYW1lKTsKICAgICAgdmFyIHJlZ2lvbnMgPSB7fTsKICAgICAgcmVnaW9uc1tuYW1lXSA9IGRlZmluaXRpb247CiAgICAgIHJldHVybiB0aGlzLl9idWlsZFJlZ2lvbnMocmVnaW9ucylbbmFtZV07CiAgICB9LAogICAgLy8gQWRkIG11bHRpcGxlIHJlZ2lvbnMgYXMgYSB7bmFtZTogZGVmaW5pdGlvbiwgbmFtZTI6IGRlZjJ9IG9iamVjdCBsaXRlcmFsCiAgICBhZGRSZWdpb25zOiBmdW5jdGlvbiAocmVnaW9ucykgewogICAgICB0aGlzLnJlZ2lvbnMgPSBfLmV4dGVuZCh7fSwgdGhpcy5yZWdpb25zLCByZWdpb25zKTsKICAgICAgcmV0dXJuIHRoaXMuX2J1aWxkUmVnaW9ucyhyZWdpb25zKTsKICAgIH0sCiAgICAvLyBSZW1vdmUgYSBzaW5nbGUgcmVnaW9uIGZyb20gdGhlIExheW91dFZpZXcsIGJ5IG5hbWUKICAgIHJlbW92ZVJlZ2lvbjogZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdiZWZvcmU6cmVnaW9uOnJlbW92ZScsIG5hbWUpOwogICAgICBkZWxldGUgdGhpcy5yZWdpb25zW25hbWVdOwogICAgICByZXR1cm4gdGhpcy5yZWdpb25NYW5hZ2VyLnJlbW92ZVJlZ2lvbihuYW1lKTsKICAgIH0sCiAgICAvLyBQcm92aWRlcyBhbHRlcm5hdGl2ZSBhY2Nlc3MgdG8gcmVnaW9ucwogICAgLy8gQWNjZXB0cyB0aGUgcmVnaW9uIG5hbWUKICAgIC8vIGdldFJlZ2lvbignbWFpbicpCiAgICBnZXRSZWdpb246IGZ1bmN0aW9uIChyZWdpb24pIHsKICAgICAgcmV0dXJuIHRoaXMucmVnaW9uTWFuYWdlci5nZXQocmVnaW9uKTsKICAgIH0sCiAgICAvLyBHZXQgYWxsIHJlZ2lvbnMKICAgIGdldFJlZ2lvbnM6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIHRoaXMucmVnaW9uTWFuYWdlci5nZXRSZWdpb25zKCk7CiAgICB9LAogICAgLy8gaW50ZXJuYWwgbWV0aG9kIHRvIGJ1aWxkIHJlZ2lvbnMKICAgIF9idWlsZFJlZ2lvbnM6IGZ1bmN0aW9uIChyZWdpb25zKSB7CiAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgdmFyIGRlZmF1bHRzID0gewogICAgICAgIHJlZ2lvbkNsYXNzOiB0aGlzLmdldE9wdGlvbigncmVnaW9uQ2xhc3MnKSwKICAgICAgICBwYXJlbnRFbDogZnVuY3Rpb24gKCkgewogICAgICAgICAgcmV0dXJuIHRoYXQuJGVsOwogICAgICAgIH0KICAgICAgfTsKICAgICAgcmV0dXJuIHRoaXMucmVnaW9uTWFuYWdlci5hZGRSZWdpb25zKHJlZ2lvbnMsIGRlZmF1bHRzKTsKICAgIH0sCiAgICAvLyBJbnRlcm5hbCBtZXRob2QgdG8gaW5pdGlhbGl6ZSB0aGUgcmVnaW9ucyB0aGF0IGhhdmUgYmVlbiBkZWZpbmVkIGluIGEKICAgIC8vIGByZWdpb25zYCBhdHRyaWJ1dGUgb24gdGhpcyBsYXlvdXRWaWV3LgogICAgX2luaXRpYWxpemVSZWdpb25zOiBmdW5jdGlvbiAob3B0aW9ucykgewogICAgICB2YXIgcmVnaW9uczsKICAgICAgdGhpcy5faW5pdFJlZ2lvbk1hbmFnZXIoKTsKICAgICAgaWYgKF8uaXNGdW5jdGlvbih0aGlzLnJlZ2lvbnMpKSB7CiAgICAgICAgcmVnaW9ucyA9IHRoaXMucmVnaW9ucyhvcHRpb25zKTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZWdpb25zID0gdGhpcy5yZWdpb25zIHx8IHt9OwogICAgICB9CiAgICAgIC8vIEVuYWJsZSB1c2VycyB0byBkZWZpbmUgYHJlZ2lvbnNgIGFzIGluc3RhbmNlIG9wdGlvbnMuCiAgICAgIHZhciByZWdpb25PcHRpb25zID0gdGhpcy5nZXRPcHRpb24uY2FsbChvcHRpb25zLCAncmVnaW9ucycpOwogICAgICAvLyBlbmFibGUgcmVnaW9uIG9wdGlvbnMgdG8gYmUgYSBmdW5jdGlvbgogICAgICBpZiAoXy5pc0Z1bmN0aW9uKHJlZ2lvbk9wdGlvbnMpKSB7CiAgICAgICAgcmVnaW9uT3B0aW9ucyA9IHJlZ2lvbk9wdGlvbnMuY2FsbCh0aGlzLCBvcHRpb25zKTsKICAgICAgfQogICAgICBfLmV4dGVuZChyZWdpb25zLCByZWdpb25PcHRpb25zKTsKICAgICAgLy8gTm9ybWFsaXplIHJlZ2lvbiBzZWxlY3RvcnMgaGFzaCB0byBhbGxvdwogICAgICAvLyBhIHVzZXIgdG8gdXNlIHRoZSBAdWkuIHN5bnRheC4KICAgICAgcmVnaW9ucyA9IHRoaXMubm9ybWFsaXplVUlWYWx1ZXMocmVnaW9ucyk7CiAgICAgIHRoaXMuYWRkUmVnaW9ucyhyZWdpb25zKTsKICAgIH0sCiAgICAvLyBJbnRlcm5hbCBtZXRob2QgdG8gcmUtaW5pdGlhbGl6ZSBhbGwgb2YgdGhlIHJlZ2lvbnMgYnkgdXBkYXRpbmcgdGhlIGBlbGAgdGhhdAogICAgLy8gdGhleSBwb2ludCB0bwogICAgX3JlSW5pdGlhbGl6ZVJlZ2lvbnM6IGZ1bmN0aW9uICgpIHsKICAgICAgdGhpcy5yZWdpb25NYW5hZ2VyLmVtcHR5UmVnaW9ucygpOwogICAgICB0aGlzLnJlZ2lvbk1hbmFnZXIuZWFjaChmdW5jdGlvbiAocmVnaW9uKSB7CiAgICAgICAgcmVnaW9uLnJlc2V0KCk7CiAgICAgIH0pOwogICAgfSwKICAgIC8vIEVuYWJsZSBlYXN5IG92ZXJyaWRpbmcgb2YgdGhlIGRlZmF1bHQgYFJlZ2lvbk1hbmFnZXJgCiAgICAvLyBmb3IgY3VzdG9taXplZCByZWdpb24gaW50ZXJhY3Rpb25zIGFuZCBidXNpbmVzcyBzcGVjaWZpYwogICAgLy8gdmlldyBsb2dpYyBmb3IgYmV0dGVyIGNvbnRyb2wgb3ZlciBzaW5nbGUgcmVnaW9ucy4KICAgIGdldFJlZ2lvbk1hbmFnZXI6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIG5ldyBNYXJpb25ldHRlLlJlZ2lvbk1hbmFnZXIoKTsKICAgIH0sCiAgICAvLyBJbnRlcm5hbCBtZXRob2QgdG8gaW5pdGlhbGl6ZSB0aGUgcmVnaW9uIG1hbmFnZXIKICAgIC8vIGFuZCBhbGwgcmVnaW9ucyBpbiBpdAogICAgX2luaXRSZWdpb25NYW5hZ2VyOiBmdW5jdGlvbiAoKSB7CiAgICAgIHRoaXMucmVnaW9uTWFuYWdlciA9IHRoaXMuZ2V0UmVnaW9uTWFuYWdlcigpOwogICAgICB0aGlzLmxpc3RlblRvKHRoaXMucmVnaW9uTWFuYWdlciwgJ2JlZm9yZTphZGQ6cmVnaW9uJywgZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICB0aGlzLnRyaWdnZXJNZXRob2QoJ2JlZm9yZTphZGQ6cmVnaW9uJywgbmFtZSk7CiAgICAgIH0pOwogICAgICB0aGlzLmxpc3RlblRvKHRoaXMucmVnaW9uTWFuYWdlciwgJ2FkZDpyZWdpb24nLCBmdW5jdGlvbiAobmFtZSwgcmVnaW9uKSB7CiAgICAgICAgdGhpc1tuYW1lXSA9IHJlZ2lvbjsKICAgICAgICB0aGlzLnRyaWdnZXJNZXRob2QoJ2FkZDpyZWdpb24nLCBuYW1lLCByZWdpb24pOwogICAgICB9KTsKICAgICAgdGhpcy5saXN0ZW5Ubyh0aGlzLnJlZ2lvbk1hbmFnZXIsICdiZWZvcmU6cmVtb3ZlOnJlZ2lvbicsIGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdiZWZvcmU6cmVtb3ZlOnJlZ2lvbicsIG5hbWUpOwogICAgICB9KTsKICAgICAgdGhpcy5saXN0ZW5Ubyh0aGlzLnJlZ2lvbk1hbmFnZXIsICdyZW1vdmU6cmVnaW9uJywgZnVuY3Rpb24gKG5hbWUsIHJlZ2lvbikgewogICAgICAgIGRlbGV0ZSB0aGlzW25hbWVdOwogICAgICAgIHRoaXMudHJpZ2dlck1ldGhvZCgncmVtb3ZlOnJlZ2lvbicsIG5hbWUsIHJlZ2lvbik7CiAgICAgIH0pOwogICAgfQogIH0pOwogIC8vIEJlaGF2aW9yCiAgLy8gLS0tLS0tLS0tLS0KICAvLyBBIEJlaGF2aW9yIGlzIGFuIGlzb2xhdGVkIHNldCBvZiBET00gLwogIC8vIHVzZXIgaW50ZXJhY3Rpb25zIHRoYXQgY2FuIGJlIG1peGVkIGludG8gYW55IFZpZXcuCiAgLy8gQmVoYXZpb3JzIGFsbG93IHlvdSB0byBibGFja2JveCBWaWV3IHNwZWNpZmljIGludGVyYWN0aW9ucwogIC8vIGludG8gcG9ydGFibGUgbG9naWNhbCBjaHVua3MsIGtlZXBpbmcgeW91ciB2aWV3cyBzaW1wbGUgYW5kIHlvdXIgY29kZSBEUlkuCiAgTWFyaW9uZXR0ZS5CZWhhdmlvciA9IGZ1bmN0aW9uIChfLCBCYWNrYm9uZSkgewogICAgZnVuY3Rpb24gQmVoYXZpb3Iob3B0aW9ucywgdmlldykgewogICAgICAvLyBTZXR1cCByZWZlcmVuY2UgdG8gdGhlIHZpZXcuCiAgICAgIC8vIHRoaXMgY29tZXMgaW4gaGFuZGxlIHdoZW4gYSBiZWhhdmlvcgogICAgICAvLyB3YW50cyB0byBkaXJlY3RseSB0YWxrIHVwIHRoZSBjaGFpbgogICAgICAvLyB0byB0aGUgdmlldy4KICAgICAgdGhpcy52aWV3ID0gdmlldzsKICAgICAgdGhpcy5kZWZhdWx0cyA9IF8ucmVzdWx0KHRoaXMsICdkZWZhdWx0cycpIHx8IHt9OwogICAgICB0aGlzLm9wdGlvbnMgPSBfLmV4dGVuZCh7fSwgdGhpcy5kZWZhdWx0cywgb3B0aW9ucyk7CiAgICAgIC8vIHByb3h5IGJlaGF2aW9yICQgbWV0aG9kIHRvIHRoZSB2aWV3CiAgICAgIC8vIHRoaXMgaXMgdXNlZnVsIGZvciBkb2luZyBqcXVlcnkgRE9NIGxvb2t1cHMKICAgICAgLy8gc2NvcGVkIHRvIGJlaGF2aW9ycyB2aWV3LgogICAgICB0aGlzLiQgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMudmlldy4kLmFwcGx5KHRoaXMudmlldywgYXJndW1lbnRzKTsKICAgICAgfTsKICAgICAgLy8gQ2FsbCB0aGUgaW5pdGlhbGl6ZSBtZXRob2QgcGFzc2luZwogICAgICAvLyB0aGUgYXJndW1lbnRzIGZyb20gdGhlIGluc3RhbmNlIGNvbnN0cnVjdG9yCiAgICAgIHRoaXMuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfQogICAgXy5leHRlbmQoQmVoYXZpb3IucHJvdG90eXBlLCBCYWNrYm9uZS5FdmVudHMsIHsKICAgICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24gKCkgewogICAgICB9LAogICAgICAvLyBzdG9wTGlzdGVuaW5nIHRvIGJlaGF2aW9yIGBvbkxpc3RlbmAgZXZlbnRzLgogICAgICBkZXN0cm95OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgdGhpcy5zdG9wTGlzdGVuaW5nKCk7CiAgICAgIH0sCiAgICAgIHByb3h5Vmlld1Byb3BlcnRpZXM6IGZ1bmN0aW9uICh2aWV3KSB7CiAgICAgICAgdGhpcy4kZWwgPSB2aWV3LiRlbDsKICAgICAgICB0aGlzLmVsID0gdmlldy5lbDsKICAgICAgfSwKICAgICAgLy8gaW1wb3J0IHRoZSBgdHJpZ2dlck1ldGhvZGAgdG8gdHJpZ2dlciBldmVudHMgd2l0aCBjb3JyZXNwb25kaW5nCiAgICAgIC8vIG1ldGhvZHMgaWYgdGhlIG1ldGhvZCBleGlzdHMKICAgICAgdHJpZ2dlck1ldGhvZDogTWFyaW9uZXR0ZS50cmlnZ2VyTWV0aG9kLAogICAgICAvLyBQcm94eSBgZ2V0T3B0aW9uYCB0byBlbmFibGUgZ2V0dGluZyBvcHRpb25zIGZyb20gdGhpcyBvciB0aGlzLm9wdGlvbnMgYnkgbmFtZS4KICAgICAgZ2V0T3B0aW9uOiBNYXJpb25ldHRlLnByb3h5R2V0T3B0aW9uLAogICAgICAvLyBQcm94eSBgdW5iaW5kRW50aXR5RXZlbnRzYCB0byBlbmFibGUgYmluZGluZyB2aWV3J3MgZXZlbnRzIGZyb20gYW5vdGhlciBlbnRpdHkuCiAgICAgIGJpbmRFbnRpdHlFdmVudHM6IE1hcmlvbmV0dGUucHJveHlCaW5kRW50aXR5RXZlbnRzLAogICAgICAvLyBQcm94eSBgdW5iaW5kRW50aXR5RXZlbnRzYCB0byBlbmFibGUgdW5iaW5kaW5nIHZpZXcncyBldmVudHMgZnJvbSBhbm90aGVyIGVudGl0eS4KICAgICAgdW5iaW5kRW50aXR5RXZlbnRzOiBNYXJpb25ldHRlLnByb3h5VW5iaW5kRW50aXR5RXZlbnRzCiAgICB9KTsKICAgIC8vIEJvcnJvdyBCYWNrYm9uZXMgZXh0ZW5kIGltcGxlbWVudGF0aW9uCiAgICAvLyB0aGlzIGFsbG93cyB1cyB0byBzZXR1cCBhIHByb3BlcgogICAgLy8gaW5oZXJpdGFuY2UgcGF0dGVybiB0aGF0IGZvbGxvd3Mgc3VpdAogICAgLy8gd2l0aCB0aGUgcmVzdCBvZiBNYXJpb25ldHRlIHZpZXdzLgogICAgQmVoYXZpb3IuZXh0ZW5kID0gTWFyaW9uZXR0ZS5leHRlbmQ7CiAgICByZXR1cm4gQmVoYXZpb3I7CiAgfShfLCBCYWNrYm9uZSk7CiAgLyoganNoaW50IG1heGxlbjogMTQzICovCiAgLy8gTWFyaW9uZXR0ZS5CZWhhdmlvcnMKICAvLyAtLS0tLS0tLQogIC8vIEJlaGF2aW9ycyBpcyBhIHV0aWxpdHkgY2xhc3MgdGhhdCB0YWtlcyBjYXJlIG9mCiAgLy8gZ2x1aW5nIHlvdXIgYmVoYXZpb3IgaW5zdGFuY2VzIHRvIHRoZWlyIGdpdmVuIFZpZXcuCiAgLy8gVGhlIG1vc3QgaW1wb3J0YW50IHBhcnQgb2YgdGhpcyBjbGFzcyBpcyB0aGF0IHlvdQogIC8vICoqTVVTVCoqIG92ZXJyaWRlIHRoZSBjbGFzcyBsZXZlbCBiZWhhdmlvcnNMb29rdXAKICAvLyBtZXRob2QgZm9yIHRoaW5ncyB0byB3b3JrIHByb3Blcmx5LgogIE1hcmlvbmV0dGUuQmVoYXZpb3JzID0gZnVuY3Rpb24gKE1hcmlvbmV0dGUsIF8pIHsKICAgIGZ1bmN0aW9uIEJlaGF2aW9ycyh2aWV3LCBiZWhhdmlvcnMpIHsKICAgICAgaWYgKCFfLmlzT2JqZWN0KHZpZXcuYmVoYXZpb3JzKSkgewogICAgICAgIHJldHVybiB7fTsKICAgICAgfQogICAgICAvLyBCZWhhdmlvcnMgZGVmaW5lZCBvbiBhIHZpZXcgY2FuIGJlIGEgZmxhdCBvYmplY3QgbGl0ZXJhbAogICAgICAvLyBvciBpdCBjYW4gYmUgYSBmdW5jdGlvbiB0aGF0IHJldHVybnMgYW4gb2JqZWN0LgogICAgICBiZWhhdmlvcnMgPSBCZWhhdmlvcnMucGFyc2VCZWhhdmlvcnModmlldywgYmVoYXZpb3JzIHx8IF8ucmVzdWx0KHZpZXcsICdiZWhhdmlvcnMnKSk7CiAgICAgIC8vIFdyYXBzIHNldmVyYWwgb2YgdGhlIHZpZXcncyBtZXRob2RzCiAgICAgIC8vIGNhbGxpbmcgdGhlIG1ldGhvZHMgZmlyc3Qgb24gZWFjaCBiZWhhdmlvcgogICAgICAvLyBhbmQgdGhlbiBldmVudHVhbGx5IGNhbGxpbmcgdGhlIG1ldGhvZCBvbiB0aGUgdmlldy4KICAgICAgQmVoYXZpb3JzLndyYXAodmlldywgYmVoYXZpb3JzLCBfLmtleXMobWV0aG9kcykpOwogICAgICByZXR1cm4gYmVoYXZpb3JzOwogICAgfQogICAgdmFyIG1ldGhvZHMgPSB7CiAgICAgIGJlaGF2aW9yVHJpZ2dlcnM6IGZ1bmN0aW9uIChiZWhhdmlvclRyaWdnZXJzLCBiZWhhdmlvcnMpIHsKICAgICAgICB2YXIgdHJpZ2dlckJ1aWxkZXIgPSBuZXcgQmVoYXZpb3JUcmlnZ2Vyc0J1aWxkZXIodGhpcywgYmVoYXZpb3JzKTsKICAgICAgICByZXR1cm4gdHJpZ2dlckJ1aWxkZXIuYnVpbGRCZWhhdmlvclRyaWdnZXJzKCk7CiAgICAgIH0sCiAgICAgIGJlaGF2aW9yRXZlbnRzOiBmdW5jdGlvbiAoYmVoYXZpb3JFdmVudHMsIGJlaGF2aW9ycykgewogICAgICAgIHZhciBfYmVoYXZpb3JzRXZlbnRzID0ge307CiAgICAgICAgdmFyIHZpZXdVSSA9IF8ucmVzdWx0KHRoaXMsICd1aScpOwogICAgICAgIF8uZWFjaChiZWhhdmlvcnMsIGZ1bmN0aW9uIChiLCBpKSB7CiAgICAgICAgICB2YXIgX2V2ZW50cyA9IHt9OwogICAgICAgICAgdmFyIGJlaGF2aW9yRXZlbnRzID0gXy5jbG9uZShfLnJlc3VsdChiLCAnZXZlbnRzJykpIHx8IHt9OwogICAgICAgICAgdmFyIGJlaGF2aW9yVUkgPSBfLnJlc3VsdChiLCAndWknKTsKICAgICAgICAgIC8vIENvbnN0cnVjdCBhbiBpbnRlcm5hbCBVSSBoYXNoIGZpcnN0IHVzaW5nCiAgICAgICAgICAvLyB0aGUgdmlld3MgVUkgaGFzaCBhbmQgdGhlbiB0aGUgYmVoYXZpb3JzIFVJIGhhc2guCiAgICAgICAgICAvLyBUaGlzIGFsbG93cyB0aGUgdXNlciB0byB1c2UgVUkgaGFzaCBlbGVtZW50cwogICAgICAgICAgLy8gZGVmaW5lZCBpbiB0aGUgcGFyZW50IHZpZXcgYXMgd2VsbCBhcyB0aG9zZQogICAgICAgICAgLy8gZGVmaW5lZCBpbiB0aGUgZ2l2ZW4gYmVoYXZpb3IuCiAgICAgICAgICB2YXIgdWkgPSBfLmV4dGVuZCh7fSwgdmlld1VJLCBiZWhhdmlvclVJKTsKICAgICAgICAgIC8vIE5vcm1hbGl6ZSBiZWhhdmlvciBldmVudHMgaGFzaCB0byBhbGxvdwogICAgICAgICAgLy8gYSB1c2VyIHRvIHVzZSB0aGUgQHVpLiBzeW50YXguCiAgICAgICAgICBiZWhhdmlvckV2ZW50cyA9IE1hcmlvbmV0dGUubm9ybWFsaXplVUlLZXlzKGJlaGF2aW9yRXZlbnRzLCB1aSk7CiAgICAgICAgICBfLmVhY2goXy5rZXlzKGJlaGF2aW9yRXZlbnRzKSwgZnVuY3Rpb24gKGtleSkgewogICAgICAgICAgICAvLyBBcHBlbmQgd2hpdGUtc3BhY2UgYXQgdGhlIGVuZCBvZiBlYWNoIGtleSB0byBwcmV2ZW50IGJlaGF2aW9yIGtleSBjb2xsaXNpb25zLgogICAgICAgICAgICAvLyBUaGlzIGlzIHJlbHlpbmcgb24gdGhlIGZhY3QgdGhhdCBiYWNrYm9uZSBldmVudHMgY29uc2lkZXJzICJjbGljayAuZm9vIiB0aGUgc2FtZSBhcwogICAgICAgICAgICAvLyAiY2xpY2sgLmZvbyAiLgogICAgICAgICAgICAvLyArMiBpcyB1c2VkIGJlY2F1c2UgbmV3IEFycmF5KDEpIG9yIDAgaXMgIiIgYW5kIG5vdCAiICIKICAgICAgICAgICAgdmFyIHdoaXRlc3BhY2UgPSBuZXcgQXJyYXkoaSArIDIpLmpvaW4oJyAnKTsKICAgICAgICAgICAgdmFyIGV2ZW50S2V5ID0ga2V5ICsgd2hpdGVzcGFjZTsKICAgICAgICAgICAgdmFyIGhhbmRsZXIgPSBfLmlzRnVuY3Rpb24oYmVoYXZpb3JFdmVudHNba2V5XSkgPyBiZWhhdmlvckV2ZW50c1trZXldIDogYltiZWhhdmlvckV2ZW50c1trZXldXTsKICAgICAgICAgICAgX2V2ZW50c1tldmVudEtleV0gPSBfLmJpbmQoaGFuZGxlciwgYik7CiAgICAgICAgICB9KTsKICAgICAgICAgIF9iZWhhdmlvcnNFdmVudHMgPSBfLmV4dGVuZChfYmVoYXZpb3JzRXZlbnRzLCBfZXZlbnRzKTsKICAgICAgICB9KTsKICAgICAgICByZXR1cm4gX2JlaGF2aW9yc0V2ZW50czsKICAgICAgfQogICAgfTsKICAgIF8uZXh0ZW5kKEJlaGF2aW9ycywgewogICAgICAvLyBQbGFjZWhvbGRlciBtZXRob2QgdG8gYmUgZXh0ZW5kZWQgYnkgdGhlIHVzZXIuCiAgICAgIC8vIFRoZSBtZXRob2Qgc2hvdWxkIGRlZmluZSB0aGUgb2JqZWN0IHRoYXQgc3RvcmVzIHRoZSBiZWhhdmlvcnMuCiAgICAgIC8vIGkuZS4KICAgICAgLy8KICAgICAgLy8gYGBganMKICAgICAgLy8gTWFyaW9uZXR0ZS5CZWhhdmlvcnMuYmVoYXZpb3JzTG9va3VwOiBmdW5jdGlvbigpIHsKICAgICAgLy8gICByZXR1cm4gQXBwLkJlaGF2aW9ycwogICAgICAvLyB9CiAgICAgIC8vIGBgYAogICAgICBiZWhhdmlvcnNMb29rdXA6IGZ1bmN0aW9uICgpIHsKICAgICAgICB0aHJvdyBuZXcgTWFyaW9uZXR0ZS5FcnJvcih7CiAgICAgICAgICBtZXNzYWdlOiAnWW91IG11c3QgZGVmaW5lIHdoZXJlIHlvdXIgYmVoYXZpb3JzIGFyZSBzdG9yZWQuJywKICAgICAgICAgIHVybDogJ21hcmlvbmV0dGUuYmVoYXZpb3JzLmh0bWwjYmVoYXZpb3JzbG9va3VwJwogICAgICAgIH0pOwogICAgICB9LAogICAgICAvLyBUYWtlcyBjYXJlIG9mIGdldHRpbmcgdGhlIGJlaGF2aW9yIGNsYXNzCiAgICAgIC8vIGdpdmVuIG9wdGlvbnMgYW5kIGEga2V5LgogICAgICAvLyBJZiBhIHVzZXIgcGFzc2VzIGluIG9wdGlvbnMuYmVoYXZpb3JDbGFzcwogICAgICAvLyBkZWZhdWx0IHRvIHVzaW5nIHRoYXQuIE90aGVyd2lzZSBkZWxlZ2F0ZQogICAgICAvLyB0aGUgbG9va3VwIHRvIHRoZSB1c2VycyBgYmVoYXZpb3JzTG9va3VwYCBpbXBsZW1lbnRhdGlvbi4KICAgICAgZ2V0QmVoYXZpb3JDbGFzczogZnVuY3Rpb24gKG9wdGlvbnMsIGtleSkgewogICAgICAgIGlmIChvcHRpb25zLmJlaGF2aW9yQ2xhc3MpIHsKICAgICAgICAgIHJldHVybiBvcHRpb25zLmJlaGF2aW9yQ2xhc3M7CiAgICAgICAgfQogICAgICAgIC8vIEdldCBiZWhhdmlvciBjbGFzcyBjYW4gYmUgZWl0aGVyIGEgZmxhdCBvYmplY3Qgb3IgYSBtZXRob2QKICAgICAgICByZXR1cm4gXy5pc0Z1bmN0aW9uKEJlaGF2aW9ycy5iZWhhdmlvcnNMb29rdXApID8gQmVoYXZpb3JzLmJlaGF2aW9yc0xvb2t1cC5hcHBseSh0aGlzLCBhcmd1bWVudHMpW2tleV0gOiBCZWhhdmlvcnMuYmVoYXZpb3JzTG9va3VwW2tleV07CiAgICAgIH0sCiAgICAgIC8vIEl0ZXJhdGUgb3ZlciB0aGUgYmVoYXZpb3JzIG9iamVjdCwgZm9yIGVhY2ggYmVoYXZpb3IKICAgICAgLy8gaW5zdGFudGlhdGUgaXQgYW5kIGdldCBpdHMgZ3JvdXBlZCBiZWhhdmlvcnMuCiAgICAgIHBhcnNlQmVoYXZpb3JzOiBmdW5jdGlvbiAodmlldywgYmVoYXZpb3JzKSB7CiAgICAgICAgcmV0dXJuIF8uY2hhaW4oYmVoYXZpb3JzKS5tYXAoZnVuY3Rpb24gKG9wdGlvbnMsIGtleSkgewogICAgICAgICAgdmFyIEJlaGF2aW9yQ2xhc3MgPSBCZWhhdmlvcnMuZ2V0QmVoYXZpb3JDbGFzcyhvcHRpb25zLCBrZXkpOwogICAgICAgICAgdmFyIGJlaGF2aW9yID0gbmV3IEJlaGF2aW9yQ2xhc3Mob3B0aW9ucywgdmlldyk7CiAgICAgICAgICB2YXIgbmVzdGVkQmVoYXZpb3JzID0gQmVoYXZpb3JzLnBhcnNlQmVoYXZpb3JzKHZpZXcsIF8ucmVzdWx0KGJlaGF2aW9yLCAnYmVoYXZpb3JzJykpOwogICAgICAgICAgcmV0dXJuIFtiZWhhdmlvcl0uY29uY2F0KG5lc3RlZEJlaGF2aW9ycyk7CiAgICAgICAgfSkuZmxhdHRlbigpLnZhbHVlKCk7CiAgICAgIH0sCiAgICAgIC8vIFdyYXAgdmlldyBpbnRlcm5hbCBtZXRob2RzIHNvIHRoYXQgdGhleSBkZWxlZ2F0ZSB0byBiZWhhdmlvcnMuIEZvciBleGFtcGxlLAogICAgICAvLyBgb25EZXN0cm95YCBzaG91bGQgdHJpZ2dlciBkZXN0cm95IG9uIGFsbCBvZiB0aGUgYmVoYXZpb3JzIGFuZCB0aGVuIGRlc3Ryb3kgaXRzZWxmLgogICAgICAvLyBpLmUuCiAgICAgIC8vCiAgICAgIC8vIGB2aWV3LmRlbGVnYXRlRXZlbnRzID0gXy5wYXJ0aWFsKG1ldGhvZHMuZGVsZWdhdGVFdmVudHMsIHZpZXcuZGVsZWdhdGVFdmVudHMsIGJlaGF2aW9ycyk7YAogICAgICB3cmFwOiBmdW5jdGlvbiAodmlldywgYmVoYXZpb3JzLCBtZXRob2ROYW1lcykgewogICAgICAgIF8uZWFjaChtZXRob2ROYW1lcywgZnVuY3Rpb24gKG1ldGhvZE5hbWUpIHsKICAgICAgICAgIHZpZXdbbWV0aG9kTmFtZV0gPSBfLnBhcnRpYWwobWV0aG9kc1ttZXRob2ROYW1lXSwgdmlld1ttZXRob2ROYW1lXSwgYmVoYXZpb3JzKTsKICAgICAgICB9KTsKICAgICAgfQogICAgfSk7CiAgICAvLyBDbGFzcyB0byBidWlsZCBoYW5kbGVycyBmb3IgYHRyaWdnZXJzYCBvbiBiZWhhdmlvcnMKICAgIC8vIGZvciB2aWV3cwogICAgZnVuY3Rpb24gQmVoYXZpb3JUcmlnZ2Vyc0J1aWxkZXIodmlldywgYmVoYXZpb3JzKSB7CiAgICAgIHRoaXMuX3ZpZXcgPSB2aWV3OwogICAgICB0aGlzLl92aWV3VUkgPSBfLnJlc3VsdCh2aWV3LCAndWknKTsKICAgICAgdGhpcy5fYmVoYXZpb3JzID0gYmVoYXZpb3JzOwogICAgICB0aGlzLl90cmlnZ2VycyA9IHt9OwogICAgfQogICAgXy5leHRlbmQoQmVoYXZpb3JUcmlnZ2Vyc0J1aWxkZXIucHJvdG90eXBlLCB7CiAgICAgIC8vIE1haW4gbWV0aG9kIHRvIGJ1aWxkIHRoZSB0cmlnZ2VycyBoYXNoIHdpdGggZXZlbnQga2V5cyBhbmQgaGFuZGxlcnMKICAgICAgYnVpbGRCZWhhdmlvclRyaWdnZXJzOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgXy5lYWNoKHRoaXMuX2JlaGF2aW9ycywgdGhpcy5fYnVpbGRUcmlnZ2VySGFuZGxlcnNGb3JCZWhhdmlvciwgdGhpcyk7CiAgICAgICAgcmV0dXJuIHRoaXMuX3RyaWdnZXJzOwogICAgICB9LAogICAgICAvLyBJbnRlcm5hbCBtZXRob2QgdG8gYnVpbGQgYWxsIHRyaWdnZXIgaGFuZGxlcnMgZm9yIGEgZ2l2ZW4gYmVoYXZpb3IKICAgICAgX2J1aWxkVHJpZ2dlckhhbmRsZXJzRm9yQmVoYXZpb3I6IGZ1bmN0aW9uIChiZWhhdmlvciwgaSkgewogICAgICAgIHZhciB1aSA9IF8uZXh0ZW5kKHt9LCB0aGlzLl92aWV3VUksIF8ucmVzdWx0KGJlaGF2aW9yLCAndWknKSk7CiAgICAgICAgdmFyIHRyaWdnZXJzSGFzaCA9IF8uY2xvbmUoXy5yZXN1bHQoYmVoYXZpb3IsICd0cmlnZ2VycycpKSB8fCB7fTsKICAgICAgICB0cmlnZ2Vyc0hhc2ggPSBNYXJpb25ldHRlLm5vcm1hbGl6ZVVJS2V5cyh0cmlnZ2Vyc0hhc2gsIHVpKTsKICAgICAgICBfLmVhY2godHJpZ2dlcnNIYXNoLCBfLnBhcnRpYWwodGhpcy5fc2V0SGFuZGxlckZvckJlaGF2aW9yLCBiZWhhdmlvciwgaSksIHRoaXMpOwogICAgICB9LAogICAgICAvLyBJbnRlcm5hbCBtZXRob2QgdG8gY3JlYXRlIGFuZCBhc3NpZ24gdGhlIHRyaWdnZXIgaGFuZGxlciBmb3IgYSBnaXZlbgogICAgICAvLyBiZWhhdmlvcgogICAgICBfc2V0SGFuZGxlckZvckJlaGF2aW9yOiBmdW5jdGlvbiAoYmVoYXZpb3IsIGksIGV2ZW50TmFtZSwgdHJpZ2dlcikgewogICAgICAgIC8vIFVuaXF1ZSBpZGVudGlmaWVyIGZvciB0aGUgYHRoaXMuX3RyaWdnZXJzYCBoYXNoCiAgICAgICAgdmFyIHRyaWdnZXJLZXkgPSB0cmlnZ2VyLnJlcGxhY2UoL15cUysvLCBmdW5jdGlvbiAodHJpZ2dlck5hbWUpIHsKICAgICAgICAgIHJldHVybiB0cmlnZ2VyTmFtZSArICcuJyArICdiZWhhdmlvcnRyaWdnZXJzJyArIGk7CiAgICAgICAgfSk7CiAgICAgICAgdGhpcy5fdHJpZ2dlcnNbdHJpZ2dlcktleV0gPSB0aGlzLl92aWV3Ll9idWlsZFZpZXdUcmlnZ2VyKGV2ZW50TmFtZSk7CiAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuIEJlaGF2aW9yczsKICB9KE1hcmlvbmV0dGUsIF8pOwogIC8vIEFwcFJvdXRlcgogIC8vIC0tLS0tLS0tLQogIC8vIFJlZHVjZSB0aGUgYm9pbGVycGxhdGUgY29kZSBvZiBoYW5kbGluZyByb3V0ZSBldmVudHMKICAvLyBhbmQgdGhlbiBjYWxsaW5nIGEgc2luZ2xlIG1ldGhvZCBvbiBhbm90aGVyIG9iamVjdC4KICAvLyBIYXZlIHlvdXIgcm91dGVycyBjb25maWd1cmVkIHRvIGNhbGwgdGhlIG1ldGhvZCBvbgogIC8vIHlvdXIgb2JqZWN0LCBkaXJlY3RseS4KICAvLwogIC8vIENvbmZpZ3VyZSBhbiBBcHBSb3V0ZXIgd2l0aCBgYXBwUm91dGVzYC4KICAvLwogIC8vIEFwcCByb3V0ZXJzIGNhbiBvbmx5IHRha2Ugb25lIGBjb250cm9sbGVyYCBvYmplY3QuCiAgLy8gSXQgaXMgcmVjb21tZW5kZWQgdGhhdCB5b3UgZGl2aWRlIHlvdXIgY29udHJvbGxlcgogIC8vIG9iamVjdHMgaW4gdG8gc21hbGxlciBwaWVjZXMgb2YgcmVsYXRlZCBmdW5jdGlvbmFsaXR5CiAgLy8gYW5kIGhhdmUgbXVsdGlwbGUgcm91dGVycyAvIGNvbnRyb2xsZXJzLCBpbnN0ZWFkIG9mCiAgLy8ganVzdCBvbmUgZ2lhbnQgcm91dGVyIGFuZCBjb250cm9sbGVyLgogIC8vCiAgLy8gWW91IGNhbiBhbHNvIGFkZCBzdGFuZGFyZCByb3V0ZXMgdG8gYW4gQXBwUm91dGVyLgogIE1hcmlvbmV0dGUuQXBwUm91dGVyID0gQmFja2JvbmUuUm91dGVyLmV4dGVuZCh7CiAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24gKG9wdGlvbnMpIHsKICAgICAgQmFja2JvbmUuUm91dGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICAgIHZhciBhcHBSb3V0ZXMgPSB0aGlzLmdldE9wdGlvbignYXBwUm91dGVzJyk7CiAgICAgIHZhciBjb250cm9sbGVyID0gdGhpcy5fZ2V0Q29udHJvbGxlcigpOwogICAgICB0aGlzLnByb2Nlc3NBcHBSb3V0ZXMoY29udHJvbGxlciwgYXBwUm91dGVzKTsKICAgICAgdGhpcy5vbigncm91dGUnLCB0aGlzLl9wcm9jZXNzT25Sb3V0ZSwgdGhpcyk7CiAgICB9LAogICAgLy8gU2ltaWxhciB0byByb3V0ZSBtZXRob2Qgb24gYSBCYWNrYm9uZSBSb3V0ZXIgYnV0CiAgICAvLyBtZXRob2QgaXMgY2FsbGVkIG9uIHRoZSBjb250cm9sbGVyCiAgICBhcHBSb3V0ZTogZnVuY3Rpb24gKHJvdXRlLCBtZXRob2ROYW1lKSB7CiAgICAgIHZhciBjb250cm9sbGVyID0gdGhpcy5fZ2V0Q29udHJvbGxlcigpOwogICAgICB0aGlzLl9hZGRBcHBSb3V0ZShjb250cm9sbGVyLCByb3V0ZSwgbWV0aG9kTmFtZSk7CiAgICB9LAogICAgLy8gcHJvY2VzcyB0aGUgcm91dGUgZXZlbnQgYW5kIHRyaWdnZXIgdGhlIG9uUm91dGUKICAgIC8vIG1ldGhvZCBjYWxsLCBpZiBpdCBleGlzdHMKICAgIF9wcm9jZXNzT25Sb3V0ZTogZnVuY3Rpb24gKHJvdXRlTmFtZSwgcm91dGVBcmdzKSB7CiAgICAgIC8vIGZpbmQgdGhlIHBhdGggdGhhdCBtYXRjaGVkCiAgICAgIHZhciByb3V0ZVBhdGggPSBfLmludmVydCh0aGlzLmdldE9wdGlvbignYXBwUm91dGVzJykpW3JvdXRlTmFtZV07CiAgICAgIC8vIG1ha2Ugc3VyZSBhbiBvblJvdXRlIGlzIHRoZXJlLCBhbmQgY2FsbCBpdAogICAgICBpZiAoXy5pc0Z1bmN0aW9uKHRoaXMub25Sb3V0ZSkpIHsKICAgICAgICB0aGlzLm9uUm91dGUocm91dGVOYW1lLCByb3V0ZVBhdGgsIHJvdXRlQXJncyk7CiAgICAgIH0KICAgIH0sCiAgICAvLyBJbnRlcm5hbCBtZXRob2QgdG8gcHJvY2VzcyB0aGUgYGFwcFJvdXRlc2AgZm9yIHRoZQogICAgLy8gcm91dGVyLCBhbmQgdHVybiB0aGVtIGluIHRvIHJvdXRlcyB0aGF0IHRyaWdnZXIgdGhlCiAgICAvLyBzcGVjaWZpZWQgbWV0aG9kIG9uIHRoZSBzcGVjaWZpZWQgYGNvbnRyb2xsZXJgLgogICAgcHJvY2Vzc0FwcFJvdXRlczogZnVuY3Rpb24gKGNvbnRyb2xsZXIsIGFwcFJvdXRlcykgewogICAgICBpZiAoIWFwcFJvdXRlcykgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICB2YXIgcm91dGVOYW1lcyA9IF8ua2V5cyhhcHBSb3V0ZXMpLnJldmVyc2UoKTsKICAgICAgLy8gQmFja2JvbmUgcmVxdWlyZXMgcmV2ZXJ0ZWQgb3JkZXIgb2Ygcm91dGVzCiAgICAgIF8uZWFjaChyb3V0ZU5hbWVzLCBmdW5jdGlvbiAocm91dGUpIHsKICAgICAgICB0aGlzLl9hZGRBcHBSb3V0ZShjb250cm9sbGVyLCByb3V0ZSwgYXBwUm91dGVzW3JvdXRlXSk7CiAgICAgIH0sIHRoaXMpOwogICAgfSwKICAgIF9nZXRDb250cm9sbGVyOiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiB0aGlzLmdldE9wdGlvbignY29udHJvbGxlcicpOwogICAgfSwKICAgIF9hZGRBcHBSb3V0ZTogZnVuY3Rpb24gKGNvbnRyb2xsZXIsIHJvdXRlLCBtZXRob2ROYW1lKSB7CiAgICAgIHZhciBtZXRob2QgPSBjb250cm9sbGVyW21ldGhvZE5hbWVdOwogICAgICBpZiAoIW1ldGhvZCkgewogICAgICAgIHRocm93IG5ldyBNYXJpb25ldHRlLkVycm9yKCdNZXRob2QgIicgKyBtZXRob2ROYW1lICsgJyIgd2FzIG5vdCBmb3VuZCBvbiB0aGUgY29udHJvbGxlcicpOwogICAgICB9CiAgICAgIHRoaXMucm91dGUocm91dGUsIG1ldGhvZE5hbWUsIF8uYmluZChtZXRob2QsIGNvbnRyb2xsZXIpKTsKICAgIH0sCiAgICAvLyBQcm94eSBgZ2V0T3B0aW9uYCB0byBlbmFibGUgZ2V0dGluZyBvcHRpb25zIGZyb20gdGhpcyBvciB0aGlzLm9wdGlvbnMgYnkgbmFtZS4KICAgIGdldE9wdGlvbjogTWFyaW9uZXR0ZS5wcm94eUdldE9wdGlvbgogIH0pOwogIC8vIEFwcGxpY2F0aW9uCiAgLy8gLS0tLS0tLS0tLS0KICAvLyBDb250YWluIGFuZCBtYW5hZ2UgdGhlIGNvbXBvc2l0ZSBhcHBsaWNhdGlvbiBhcyBhIHdob2xlLgogIC8vIFN0b3JlcyBhbmQgc3RhcnRzIHVwIGBSZWdpb25gIG9iamVjdHMsIGluY2x1ZGVzIGFuCiAgLy8gZXZlbnQgYWdncmVnYXRvciBhcyBgYXBwLnZlbnRgCiAgTWFyaW9uZXR0ZS5BcHBsaWNhdGlvbiA9IGZ1bmN0aW9uIChvcHRpb25zKSB7CiAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zOwogICAgdGhpcy5faW5pdGlhbGl6ZVJlZ2lvbnMob3B0aW9ucyk7CiAgICB0aGlzLl9pbml0Q2FsbGJhY2tzID0gbmV3IE1hcmlvbmV0dGUuQ2FsbGJhY2tzKCk7CiAgICB0aGlzLnN1Ym1vZHVsZXMgPSB7fTsKICAgIF8uZXh0ZW5kKHRoaXMsIG9wdGlvbnMpOwogICAgdGhpcy5faW5pdENoYW5uZWwoKTsKICAgIHRoaXMuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIH07CiAgXy5leHRlbmQoTWFyaW9uZXR0ZS5BcHBsaWNhdGlvbi5wcm90b3R5cGUsIEJhY2tib25lLkV2ZW50cywgewogICAgLy8gSW5pdGlhbGl6ZSBpcyBhbiBlbXB0eSBmdW5jdGlvbiBieSBkZWZhdWx0LiBPdmVycmlkZSBpdCB3aXRoIHlvdXIgb3duCiAgICAvLyBpbml0aWFsaXphdGlvbiBsb2dpYy4KICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uICgpIHsKICAgIH0sCiAgICAvLyBDb21tYW5kIGV4ZWN1dGlvbiwgZmFjaWxpdGF0ZWQgYnkgQmFja2JvbmUuV3JlcXIuQ29tbWFuZHMKICAgIGV4ZWN1dGU6IGZ1bmN0aW9uICgpIHsKICAgICAgdGhpcy5jb21tYW5kcy5leGVjdXRlLmFwcGx5KHRoaXMuY29tbWFuZHMsIGFyZ3VtZW50cyk7CiAgICB9LAogICAgLy8gUmVxdWVzdC9yZXNwb25zZSwgZmFjaWxpdGF0ZWQgYnkgQmFja2JvbmUuV3JlcXIuUmVxdWVzdFJlc3BvbnNlCiAgICByZXF1ZXN0OiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiB0aGlzLnJlcXJlcy5yZXF1ZXN0LmFwcGx5KHRoaXMucmVxcmVzLCBhcmd1bWVudHMpOwogICAgfSwKICAgIC8vIEFkZCBhbiBpbml0aWFsaXplciB0aGF0IGlzIGVpdGhlciBydW4gYXQgd2hlbiB0aGUgYHN0YXJ0YAogICAgLy8gbWV0aG9kIGlzIGNhbGxlZCwgb3IgcnVuIGltbWVkaWF0ZWx5IGlmIGFkZGVkIGFmdGVyIGBzdGFydGAKICAgIC8vIGhhcyBhbHJlYWR5IGJlZW4gY2FsbGVkLgogICAgYWRkSW5pdGlhbGl6ZXI6IGZ1bmN0aW9uIChpbml0aWFsaXplcikgewogICAgICB0aGlzLl9pbml0Q2FsbGJhY2tzLmFkZChpbml0aWFsaXplcik7CiAgICB9LAogICAgLy8ga2ljayBvZmYgYWxsIG9mIHRoZSBhcHBsaWNhdGlvbidzIHByb2Nlc3Nlcy4KICAgIC8vIGluaXRpYWxpemVzIGFsbCBvZiB0aGUgcmVnaW9ucyB0aGF0IGhhdmUgYmVlbiBhZGRlZAogICAgLy8gdG8gdGhlIGFwcCwgYW5kIHJ1bnMgYWxsIG9mIHRoZSBpbml0aWFsaXplciBmdW5jdGlvbnMKICAgIHN0YXJ0OiBmdW5jdGlvbiAob3B0aW9ucykgewogICAgICB0aGlzLnRyaWdnZXJNZXRob2QoJ2JlZm9yZTpzdGFydCcsIG9wdGlvbnMpOwogICAgICB0aGlzLl9pbml0Q2FsbGJhY2tzLnJ1bihvcHRpb25zLCB0aGlzKTsKICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdzdGFydCcsIG9wdGlvbnMpOwogICAgfSwKICAgIC8vIEFkZCByZWdpb25zIHRvIHlvdXIgYXBwLgogICAgLy8gQWNjZXB0cyBhIGhhc2ggb2YgbmFtZWQgc3RyaW5ncyBvciBSZWdpb24gb2JqZWN0cwogICAgLy8gYWRkUmVnaW9ucyh7c29tZXRoaW5nOiAiI3NvbWVSZWdpb24ifSkKICAgIC8vIGFkZFJlZ2lvbnMoe3NvbWV0aGluZzogUmVnaW9uLmV4dGVuZCh7ZWw6ICIjc29tZVJlZ2lvbiJ9KSB9KTsKICAgIGFkZFJlZ2lvbnM6IGZ1bmN0aW9uIChyZWdpb25zKSB7CiAgICAgIHJldHVybiB0aGlzLl9yZWdpb25NYW5hZ2VyLmFkZFJlZ2lvbnMocmVnaW9ucyk7CiAgICB9LAogICAgLy8gRW1wdHkgYWxsIHJlZ2lvbnMgaW4gdGhlIGFwcCwgd2l0aG91dCByZW1vdmluZyB0aGVtCiAgICBlbXB0eVJlZ2lvbnM6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIHRoaXMuX3JlZ2lvbk1hbmFnZXIuZW1wdHlSZWdpb25zKCk7CiAgICB9LAogICAgLy8gUmVtb3ZlcyBhIHJlZ2lvbiBmcm9tIHlvdXIgYXBwLCBieSBuYW1lCiAgICAvLyBBY2NlcHRzIHRoZSByZWdpb25zIG5hbWUKICAgIC8vIHJlbW92ZVJlZ2lvbignbXlSZWdpb24nKQogICAgcmVtb3ZlUmVnaW9uOiBmdW5jdGlvbiAocmVnaW9uKSB7CiAgICAgIHJldHVybiB0aGlzLl9yZWdpb25NYW5hZ2VyLnJlbW92ZVJlZ2lvbihyZWdpb24pOwogICAgfSwKICAgIC8vIFByb3ZpZGVzIGFsdGVybmF0aXZlIGFjY2VzcyB0byByZWdpb25zCiAgICAvLyBBY2NlcHRzIHRoZSByZWdpb24gbmFtZQogICAgLy8gZ2V0UmVnaW9uKCdtYWluJykKICAgIGdldFJlZ2lvbjogZnVuY3Rpb24gKHJlZ2lvbikgewogICAgICByZXR1cm4gdGhpcy5fcmVnaW9uTWFuYWdlci5nZXQocmVnaW9uKTsKICAgIH0sCiAgICAvLyBHZXQgYWxsIHRoZSByZWdpb25zIGZyb20gdGhlIHJlZ2lvbiBtYW5hZ2VyCiAgICBnZXRSZWdpb25zOiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiB0aGlzLl9yZWdpb25NYW5hZ2VyLmdldFJlZ2lvbnMoKTsKICAgIH0sCiAgICAvLyBDcmVhdGUgYSBtb2R1bGUsIGF0dGFjaGVkIHRvIHRoZSBhcHBsaWNhdGlvbgogICAgbW9kdWxlOiBmdW5jdGlvbiAobW9kdWxlTmFtZXMsIG1vZHVsZURlZmluaXRpb24pIHsKICAgICAgLy8gT3ZlcndyaXRlIHRoZSBtb2R1bGUgY2xhc3MgaWYgdGhlIHVzZXIgc3BlY2lmaWVzIG9uZQogICAgICB2YXIgTW9kdWxlQ2xhc3MgPSBNYXJpb25ldHRlLk1vZHVsZS5nZXRDbGFzcyhtb2R1bGVEZWZpbml0aW9uKTsKICAgICAgLy8gc2xpY2UgdGhlIGFyZ3MsIGFuZCBhZGQgdGhpcyBhcHBsaWNhdGlvbiBvYmplY3QgYXMgdGhlCiAgICAgIC8vIGZpcnN0IGFyZ3VtZW50IG9mIHRoZSBhcnJheQogICAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzKTsKICAgICAgYXJncy51bnNoaWZ0KHRoaXMpOwogICAgICAvLyBzZWUgdGhlIE1hcmlvbmV0dGUuTW9kdWxlIG9iamVjdCBmb3IgbW9yZSBpbmZvcm1hdGlvbgogICAgICByZXR1cm4gTW9kdWxlQ2xhc3MuY3JlYXRlLmFwcGx5KE1vZHVsZUNsYXNzLCBhcmdzKTsKICAgIH0sCiAgICAvLyBFbmFibGUgZWFzeSBvdmVycmlkaW5nIG9mIHRoZSBkZWZhdWx0IGBSZWdpb25NYW5hZ2VyYAogICAgLy8gZm9yIGN1c3RvbWl6ZWQgcmVnaW9uIGludGVyYWN0aW9ucyBhbmQgYnVzaW5lc3Mtc3BlY2lmaWMKICAgIC8vIHZpZXcgbG9naWMgZm9yIGJldHRlciBjb250cm9sIG92ZXIgc2luZ2xlIHJlZ2lvbnMuCiAgICBnZXRSZWdpb25NYW5hZ2VyOiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBuZXcgTWFyaW9uZXR0ZS5SZWdpb25NYW5hZ2VyKCk7CiAgICB9LAogICAgLy8gSW50ZXJuYWwgbWV0aG9kIHRvIGluaXRpYWxpemUgdGhlIHJlZ2lvbnMgdGhhdCBoYXZlIGJlZW4gZGVmaW5lZCBpbiBhCiAgICAvLyBgcmVnaW9uc2AgYXR0cmlidXRlIG9uIHRoZSBhcHBsaWNhdGlvbiBpbnN0YW5jZQogICAgX2luaXRpYWxpemVSZWdpb25zOiBmdW5jdGlvbiAob3B0aW9ucykgewogICAgICB2YXIgcmVnaW9ucyA9IF8uaXNGdW5jdGlvbih0aGlzLnJlZ2lvbnMpID8gdGhpcy5yZWdpb25zKG9wdGlvbnMpIDogdGhpcy5yZWdpb25zIHx8IHt9OwogICAgICB0aGlzLl9pbml0UmVnaW9uTWFuYWdlcigpOwogICAgICAvLyBFbmFibGUgdXNlcnMgdG8gZGVmaW5lIGByZWdpb25zYCBpbiBpbnN0YW5jZSBvcHRpb25zLgogICAgICB2YXIgb3B0aW9uUmVnaW9ucyA9IE1hcmlvbmV0dGUuZ2V0T3B0aW9uKG9wdGlvbnMsICdyZWdpb25zJyk7CiAgICAgIC8vIEVuYWJsZSByZWdpb24gb3B0aW9ucyB0byBiZSBhIGZ1bmN0aW9uCiAgICAgIGlmIChfLmlzRnVuY3Rpb24ob3B0aW9uUmVnaW9ucykpIHsKICAgICAgICBvcHRpb25SZWdpb25zID0gb3B0aW9uUmVnaW9ucy5jYWxsKHRoaXMsIG9wdGlvbnMpOwogICAgICB9CiAgICAgIC8vIE92ZXJ3cml0ZSBjdXJyZW50IHJlZ2lvbnMgd2l0aCB0aG9zZSBwYXNzZWQgaW4gb3B0aW9ucwogICAgICBfLmV4dGVuZChyZWdpb25zLCBvcHRpb25SZWdpb25zKTsKICAgICAgdGhpcy5hZGRSZWdpb25zKHJlZ2lvbnMpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgICAvLyBJbnRlcm5hbCBtZXRob2QgdG8gc2V0IHVwIHRoZSByZWdpb24gbWFuYWdlcgogICAgX2luaXRSZWdpb25NYW5hZ2VyOiBmdW5jdGlvbiAoKSB7CiAgICAgIHRoaXMuX3JlZ2lvbk1hbmFnZXIgPSB0aGlzLmdldFJlZ2lvbk1hbmFnZXIoKTsKICAgICAgdGhpcy5saXN0ZW5Ubyh0aGlzLl9yZWdpb25NYW5hZ2VyLCAnYmVmb3JlOmFkZDpyZWdpb24nLCBmdW5jdGlvbiAobmFtZSkgewogICAgICAgIHRoaXMudHJpZ2dlck1ldGhvZCgnYmVmb3JlOmFkZDpyZWdpb24nLCBuYW1lKTsKICAgICAgfSk7CiAgICAgIHRoaXMubGlzdGVuVG8odGhpcy5fcmVnaW9uTWFuYWdlciwgJ2FkZDpyZWdpb24nLCBmdW5jdGlvbiAobmFtZSwgcmVnaW9uKSB7CiAgICAgICAgdGhpc1tuYW1lXSA9IHJlZ2lvbjsKICAgICAgICB0aGlzLnRyaWdnZXJNZXRob2QoJ2FkZDpyZWdpb24nLCBuYW1lLCByZWdpb24pOwogICAgICB9KTsKICAgICAgdGhpcy5saXN0ZW5Ubyh0aGlzLl9yZWdpb25NYW5hZ2VyLCAnYmVmb3JlOnJlbW92ZTpyZWdpb24nLCBmdW5jdGlvbiAobmFtZSkgewogICAgICAgIHRoaXMudHJpZ2dlck1ldGhvZCgnYmVmb3JlOnJlbW92ZTpyZWdpb24nLCBuYW1lKTsKICAgICAgfSk7CiAgICAgIHRoaXMubGlzdGVuVG8odGhpcy5fcmVnaW9uTWFuYWdlciwgJ3JlbW92ZTpyZWdpb24nLCBmdW5jdGlvbiAobmFtZSwgcmVnaW9uKSB7CiAgICAgICAgZGVsZXRlIHRoaXNbbmFtZV07CiAgICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdyZW1vdmU6cmVnaW9uJywgbmFtZSwgcmVnaW9uKTsKICAgICAgfSk7CiAgICB9LAogICAgLy8gSW50ZXJuYWwgbWV0aG9kIHRvIHNldHVwIHRoZSBXcmVxci5yYWRpbyBjaGFubmVsCiAgICBfaW5pdENoYW5uZWw6IGZ1bmN0aW9uICgpIHsKICAgICAgdGhpcy5jaGFubmVsTmFtZSA9IF8ucmVzdWx0KHRoaXMsICdjaGFubmVsTmFtZScpIHx8ICdnbG9iYWwnOwogICAgICB0aGlzLmNoYW5uZWwgPSBfLnJlc3VsdCh0aGlzLCAnY2hhbm5lbCcpIHx8IEJhY2tib25lLldyZXFyLnJhZGlvLmNoYW5uZWwodGhpcy5jaGFubmVsTmFtZSk7CiAgICAgIHRoaXMudmVudCA9IF8ucmVzdWx0KHRoaXMsICd2ZW50JykgfHwgdGhpcy5jaGFubmVsLnZlbnQ7CiAgICAgIHRoaXMuY29tbWFuZHMgPSBfLnJlc3VsdCh0aGlzLCAnY29tbWFuZHMnKSB8fCB0aGlzLmNoYW5uZWwuY29tbWFuZHM7CiAgICAgIHRoaXMucmVxcmVzID0gXy5yZXN1bHQodGhpcywgJ3JlcXJlcycpIHx8IHRoaXMuY2hhbm5lbC5yZXFyZXM7CiAgICB9LAogICAgLy8gaW1wb3J0IHRoZSBgdHJpZ2dlck1ldGhvZGAgdG8gdHJpZ2dlciBldmVudHMgd2l0aCBjb3JyZXNwb25kaW5nCiAgICAvLyBtZXRob2RzIGlmIHRoZSBtZXRob2QgZXhpc3RzCiAgICB0cmlnZ2VyTWV0aG9kOiBNYXJpb25ldHRlLnRyaWdnZXJNZXRob2QsCiAgICAvLyBQcm94eSBgZ2V0T3B0aW9uYCB0byBlbmFibGUgZ2V0dGluZyBvcHRpb25zIGZyb20gdGhpcyBvciB0aGlzLm9wdGlvbnMgYnkgbmFtZS4KICAgIGdldE9wdGlvbjogTWFyaW9uZXR0ZS5wcm94eUdldE9wdGlvbgogIH0pOwogIC8vIENvcHkgdGhlIGBleHRlbmRgIGZ1bmN0aW9uIHVzZWQgYnkgQmFja2JvbmUncyBjbGFzc2VzCiAgTWFyaW9uZXR0ZS5BcHBsaWNhdGlvbi5leHRlbmQgPSBNYXJpb25ldHRlLmV4dGVuZDsKICAvKiBqc2hpbnQgbWF4cGFyYW1zOiA5ICovCiAgLy8gTW9kdWxlCiAgLy8gLS0tLS0tCiAgLy8gQSBzaW1wbGUgbW9kdWxlIHN5c3RlbSwgdXNlZCB0byBjcmVhdGUgcHJpdmFjeSBhbmQgZW5jYXBzdWxhdGlvbiBpbgogIC8vIE1hcmlvbmV0dGUgYXBwbGljYXRpb25zCiAgTWFyaW9uZXR0ZS5Nb2R1bGUgPSBmdW5jdGlvbiAobW9kdWxlTmFtZSwgYXBwLCBvcHRpb25zKSB7CiAgICB0aGlzLm1vZHVsZU5hbWUgPSBtb2R1bGVOYW1lOwogICAgdGhpcy5vcHRpb25zID0gXy5leHRlbmQoe30sIHRoaXMub3B0aW9ucywgb3B0aW9ucyk7CiAgICAvLyBBbGxvdyBmb3IgYSB1c2VyIHRvIG92ZXJpZGUgdGhlIGluaXRpYWxpemUKICAgIC8vIGZvciBhIGdpdmVuIG1vZHVsZSBpbnN0YW5jZS4KICAgIHRoaXMuaW5pdGlhbGl6ZSA9IG9wdGlvbnMuaW5pdGlhbGl6ZSB8fCB0aGlzLmluaXRpYWxpemU7CiAgICAvLyBTZXQgdXAgYW4gaW50ZXJuYWwgc3RvcmUgZm9yIHN1Yi1tb2R1bGVzLgogICAgdGhpcy5zdWJtb2R1bGVzID0ge307CiAgICB0aGlzLl9zZXR1cEluaXRpYWxpemVyc0FuZEZpbmFsaXplcnMoKTsKICAgIC8vIFNldCBhbiBpbnRlcm5hbCByZWZlcmVuY2UgdG8gdGhlIGFwcAogICAgLy8gd2l0aGluIGEgbW9kdWxlLgogICAgdGhpcy5hcHAgPSBhcHA7CiAgICBpZiAoXy5pc0Z1bmN0aW9uKHRoaXMuaW5pdGlhbGl6ZSkpIHsKICAgICAgdGhpcy5pbml0aWFsaXplKG1vZHVsZU5hbWUsIGFwcCwgdGhpcy5vcHRpb25zKTsKICAgIH0KICB9OwogIE1hcmlvbmV0dGUuTW9kdWxlLmV4dGVuZCA9IE1hcmlvbmV0dGUuZXh0ZW5kOwogIC8vIEV4dGVuZCB0aGUgTW9kdWxlIHByb3RvdHlwZSB3aXRoIGV2ZW50cyAvIGxpc3RlblRvLCBzbyB0aGF0IHRoZSBtb2R1bGUKICAvLyBjYW4gYmUgdXNlZCBhcyBhbiBldmVudCBhZ2dyZWdhdG9yIG9yIHB1Yi9zdWIuCiAgXy5leHRlbmQoTWFyaW9uZXR0ZS5Nb2R1bGUucHJvdG90eXBlLCBCYWNrYm9uZS5FdmVudHMsIHsKICAgIC8vIEJ5IGRlZmF1bHQgbW9kdWxlcyBzdGFydCB3aXRoIHRoZWlyIHBhcmVudHMuCiAgICBzdGFydFdpdGhQYXJlbnQ6IHRydWUsCiAgICAvLyBJbml0aWFsaXplIGlzIGFuIGVtcHR5IGZ1bmN0aW9uIGJ5IGRlZmF1bHQuIE92ZXJyaWRlIGl0IHdpdGggeW91ciBvd24KICAgIC8vIGluaXRpYWxpemF0aW9uIGxvZ2ljIHdoZW4gZXh0ZW5kaW5nIE1hcmlvbmV0dGUuTW9kdWxlLgogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24gKCkgewogICAgfSwKICAgIC8vIEluaXRpYWxpemVyIGZvciBhIHNwZWNpZmljIG1vZHVsZS4gSW5pdGlhbGl6ZXJzIGFyZSBydW4gd2hlbiB0aGUKICAgIC8vIG1vZHVsZSdzIGBzdGFydGAgbWV0aG9kIGlzIGNhbGxlZC4KICAgIGFkZEluaXRpYWxpemVyOiBmdW5jdGlvbiAoY2FsbGJhY2spIHsKICAgICAgdGhpcy5faW5pdGlhbGl6ZXJDYWxsYmFja3MuYWRkKGNhbGxiYWNrKTsKICAgIH0sCiAgICAvLyBGaW5hbGl6ZXJzIGFyZSBydW4gd2hlbiBhIG1vZHVsZSBpcyBzdG9wcGVkLiBUaGV5IGFyZSB1c2VkIHRvIHRlYXJkb3duCiAgICAvLyBhbmQgZmluYWxpemUgYW55IHZhcmlhYmxlcywgcmVmZXJlbmNlcywgZXZlbnRzIGFuZCBvdGhlciBjb2RlIHRoYXQgdGhlCiAgICAvLyBtb2R1bGUgaGFkIHNldCB1cC4KICAgIGFkZEZpbmFsaXplcjogZnVuY3Rpb24gKGNhbGxiYWNrKSB7CiAgICAgIHRoaXMuX2ZpbmFsaXplckNhbGxiYWNrcy5hZGQoY2FsbGJhY2spOwogICAgfSwKICAgIC8vIFN0YXJ0IHRoZSBtb2R1bGUsIGFuZCBydW4gYWxsIG9mIGl0cyBpbml0aWFsaXplcnMKICAgIHN0YXJ0OiBmdW5jdGlvbiAob3B0aW9ucykgewogICAgICAvLyBQcmV2ZW50IHJlLXN0YXJ0aW5nIGEgbW9kdWxlIHRoYXQgaXMgYWxyZWFkeSBzdGFydGVkCiAgICAgIGlmICh0aGlzLl9pc0luaXRpYWxpemVkKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIC8vIHN0YXJ0IHRoZSBzdWItbW9kdWxlcyAoZGVwdGgtZmlyc3QgaGllcmFyY2h5KQogICAgICBfLmVhY2godGhpcy5zdWJtb2R1bGVzLCBmdW5jdGlvbiAobW9kKSB7CiAgICAgICAgLy8gY2hlY2sgdG8gc2VlIGlmIHdlIHNob3VsZCBzdGFydCB0aGUgc3ViLW1vZHVsZSB3aXRoIHRoaXMgcGFyZW50CiAgICAgICAgaWYgKG1vZC5zdGFydFdpdGhQYXJlbnQpIHsKICAgICAgICAgIG1vZC5zdGFydChvcHRpb25zKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICAvLyBydW4gdGhlIGNhbGxiYWNrcyB0byAic3RhcnQiIHRoZSBjdXJyZW50IG1vZHVsZQogICAgICB0aGlzLnRyaWdnZXJNZXRob2QoJ2JlZm9yZTpzdGFydCcsIG9wdGlvbnMpOwogICAgICB0aGlzLl9pbml0aWFsaXplckNhbGxiYWNrcy5ydW4ob3B0aW9ucywgdGhpcyk7CiAgICAgIHRoaXMuX2lzSW5pdGlhbGl6ZWQgPSB0cnVlOwogICAgICB0aGlzLnRyaWdnZXJNZXRob2QoJ3N0YXJ0Jywgb3B0aW9ucyk7CiAgICB9LAogICAgLy8gU3RvcCB0aGlzIG1vZHVsZSBieSBydW5uaW5nIGl0cyBmaW5hbGl6ZXJzIGFuZCB0aGVuIHN0b3AgYWxsIG9mCiAgICAvLyB0aGUgc3ViLW1vZHVsZXMgZm9yIHRoaXMgbW9kdWxlCiAgICBzdG9wOiBmdW5jdGlvbiAoKSB7CiAgICAgIC8vIGlmIHdlIGFyZSBub3QgaW5pdGlhbGl6ZWQsIGRvbid0IGJvdGhlciBmaW5hbGl6aW5nCiAgICAgIGlmICghdGhpcy5faXNJbml0aWFsaXplZCkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICB0aGlzLl9pc0luaXRpYWxpemVkID0gZmFsc2U7CiAgICAgIHRoaXMudHJpZ2dlck1ldGhvZCgnYmVmb3JlOnN0b3AnKTsKICAgICAgLy8gc3RvcCB0aGUgc3ViLW1vZHVsZXM7IGRlcHRoLWZpcnN0LCB0byBtYWtlIHN1cmUgdGhlCiAgICAgIC8vIHN1Yi1tb2R1bGVzIGFyZSBzdG9wcGVkIC8gZmluYWxpemVkIGJlZm9yZSBwYXJlbnRzCiAgICAgIF8uZWFjaCh0aGlzLnN1Ym1vZHVsZXMsIGZ1bmN0aW9uIChtb2QpIHsKICAgICAgICBtb2Quc3RvcCgpOwogICAgICB9KTsKICAgICAgLy8gcnVuIHRoZSBmaW5hbGl6ZXJzCiAgICAgIHRoaXMuX2ZpbmFsaXplckNhbGxiYWNrcy5ydW4odW5kZWZpbmVkLCB0aGlzKTsKICAgICAgLy8gcmVzZXQgdGhlIGluaXRpYWxpemVycyBhbmQgZmluYWxpemVycwogICAgICB0aGlzLl9pbml0aWFsaXplckNhbGxiYWNrcy5yZXNldCgpOwogICAgICB0aGlzLl9maW5hbGl6ZXJDYWxsYmFja3MucmVzZXQoKTsKICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdzdG9wJyk7CiAgICB9LAogICAgLy8gQ29uZmlndXJlIHRoZSBtb2R1bGUgd2l0aCBhIGRlZmluaXRpb24gZnVuY3Rpb24gYW5kIGFueSBjdXN0b20gYXJncwogICAgLy8gdGhhdCBhcmUgdG8gYmUgcGFzc2VkIGluIHRvIHRoZSBkZWZpbml0aW9uIGZ1bmN0aW9uCiAgICBhZGREZWZpbml0aW9uOiBmdW5jdGlvbiAobW9kdWxlRGVmaW5pdGlvbiwgY3VzdG9tQXJncykgewogICAgICB0aGlzLl9ydW5Nb2R1bGVEZWZpbml0aW9uKG1vZHVsZURlZmluaXRpb24sIGN1c3RvbUFyZ3MpOwogICAgfSwKICAgIC8vIEludGVybmFsIG1ldGhvZDogcnVuIHRoZSBtb2R1bGUgZGVmaW5pdGlvbiBmdW5jdGlvbiB3aXRoIHRoZSBjb3JyZWN0CiAgICAvLyBhcmd1bWVudHMKICAgIF9ydW5Nb2R1bGVEZWZpbml0aW9uOiBmdW5jdGlvbiAoZGVmaW5pdGlvbiwgY3VzdG9tQXJncykgewogICAgICAvLyBJZiB0aGVyZSBpcyBubyBkZWZpbml0aW9uIHNob3J0IGNpcmN1dCB0aGUgbWV0aG9kLgogICAgICBpZiAoIWRlZmluaXRpb24pIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgLy8gYnVpbGQgdGhlIGNvcnJlY3QgbGlzdCBvZiBhcmd1bWVudHMgZm9yIHRoZSBtb2R1bGUgZGVmaW5pdGlvbgogICAgICB2YXIgYXJncyA9IF8uZmxhdHRlbihbCiAgICAgICAgdGhpcywKICAgICAgICB0aGlzLmFwcCwKICAgICAgICBCYWNrYm9uZSwKICAgICAgICBNYXJpb25ldHRlLAogICAgICAgIEJhY2tib25lLiQsCiAgICAgICAgXywKICAgICAgICBjdXN0b21BcmdzCiAgICAgIF0pOwogICAgICBkZWZpbml0aW9uLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgfSwKICAgIC8vIEludGVybmFsIG1ldGhvZDogc2V0IHVwIG5ldyBjb3BpZXMgb2YgaW5pdGlhbGl6ZXJzIGFuZCBmaW5hbGl6ZXJzLgogICAgLy8gQ2FsbGluZyB0aGlzIG1ldGhvZCB3aWxsIHdpcGUgb3V0IGFsbCBleGlzdGluZyBpbml0aWFsaXplcnMgYW5kCiAgICAvLyBmaW5hbGl6ZXJzLgogICAgX3NldHVwSW5pdGlhbGl6ZXJzQW5kRmluYWxpemVyczogZnVuY3Rpb24gKCkgewogICAgICB0aGlzLl9pbml0aWFsaXplckNhbGxiYWNrcyA9IG5ldyBNYXJpb25ldHRlLkNhbGxiYWNrcygpOwogICAgICB0aGlzLl9maW5hbGl6ZXJDYWxsYmFja3MgPSBuZXcgTWFyaW9uZXR0ZS5DYWxsYmFja3MoKTsKICAgIH0sCiAgICAvLyBpbXBvcnQgdGhlIGB0cmlnZ2VyTWV0aG9kYCB0byB0cmlnZ2VyIGV2ZW50cyB3aXRoIGNvcnJlc3BvbmRpbmcKICAgIC8vIG1ldGhvZHMgaWYgdGhlIG1ldGhvZCBleGlzdHMKICAgIHRyaWdnZXJNZXRob2Q6IE1hcmlvbmV0dGUudHJpZ2dlck1ldGhvZAogIH0pOwogIC8vIENsYXNzIG1ldGhvZHMgdG8gY3JlYXRlIG1vZHVsZXMKICBfLmV4dGVuZChNYXJpb25ldHRlLk1vZHVsZSwgewogICAgLy8gQ3JlYXRlIGEgbW9kdWxlLCBoYW5naW5nIG9mZiB0aGUgYXBwIHBhcmFtZXRlciBhcyB0aGUgcGFyZW50IG9iamVjdC4KICAgIGNyZWF0ZTogZnVuY3Rpb24gKGFwcCwgbW9kdWxlTmFtZXMsIG1vZHVsZURlZmluaXRpb24pIHsKICAgICAgdmFyIG1vZHVsZSA9IGFwcDsKICAgICAgLy8gZ2V0IHRoZSBjdXN0b20gYXJncyBwYXNzZWQgaW4gYWZ0ZXIgdGhlIG1vZHVsZSBkZWZpbml0aW9uIGFuZAogICAgICAvLyBnZXQgcmlkIG9mIHRoZSBtb2R1bGUgbmFtZSBhbmQgZGVmaW5pdGlvbiBmdW5jdGlvbgogICAgICB2YXIgY3VzdG9tQXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzKTsKICAgICAgY3VzdG9tQXJncy5zcGxpY2UoMCwgMyk7CiAgICAgIC8vIFNwbGl0IHRoZSBtb2R1bGUgbmFtZXMgYW5kIGdldCB0aGUgbnVtYmVyIG9mIHN1Ym1vZHVsZXMuCiAgICAgIC8vIGkuZS4gYW4gZXhhbXBsZSBtb2R1bGUgbmFtZSBvZiBgRG9nZS5Xb3cuQW1hemVgIHdvdWxkCiAgICAgIC8vIHRoZW4gaGF2ZSB0aGUgcG90ZW50aWFsIGZvciAzIG1vZHVsZSBkZWZpbml0aW9ucy4KICAgICAgbW9kdWxlTmFtZXMgPSBtb2R1bGVOYW1lcy5zcGxpdCgnLicpOwogICAgICB2YXIgbGVuZ3RoID0gbW9kdWxlTmFtZXMubGVuZ3RoOwogICAgICAvLyBzdG9yZSB0aGUgbW9kdWxlIGRlZmluaXRpb24gZm9yIHRoZSBsYXN0IG1vZHVsZSBpbiB0aGUgY2hhaW4KICAgICAgdmFyIG1vZHVsZURlZmluaXRpb25zID0gW107CiAgICAgIG1vZHVsZURlZmluaXRpb25zW2xlbmd0aCAtIDFdID0gbW9kdWxlRGVmaW5pdGlvbjsKICAgICAgLy8gTG9vcCB0aHJvdWdoIGFsbCB0aGUgcGFydHMgb2YgdGhlIG1vZHVsZSBkZWZpbml0aW9uCiAgICAgIF8uZWFjaChtb2R1bGVOYW1lcywgZnVuY3Rpb24gKG1vZHVsZU5hbWUsIGkpIHsKICAgICAgICB2YXIgcGFyZW50TW9kdWxlID0gbW9kdWxlOwogICAgICAgIG1vZHVsZSA9IHRoaXMuX2dldE1vZHVsZShwYXJlbnRNb2R1bGUsIG1vZHVsZU5hbWUsIGFwcCwgbW9kdWxlRGVmaW5pdGlvbik7CiAgICAgICAgdGhpcy5fYWRkTW9kdWxlRGVmaW5pdGlvbihwYXJlbnRNb2R1bGUsIG1vZHVsZSwgbW9kdWxlRGVmaW5pdGlvbnNbaV0sIGN1c3RvbUFyZ3MpOwogICAgICB9LCB0aGlzKTsKICAgICAgLy8gUmV0dXJuIHRoZSBsYXN0IG1vZHVsZSBpbiB0aGUgZGVmaW5pdGlvbiBjaGFpbgogICAgICByZXR1cm4gbW9kdWxlOwogICAgfSwKICAgIF9nZXRNb2R1bGU6IGZ1bmN0aW9uIChwYXJlbnRNb2R1bGUsIG1vZHVsZU5hbWUsIGFwcCwgZGVmLCBhcmdzKSB7CiAgICAgIHZhciBvcHRpb25zID0gXy5leHRlbmQoe30sIGRlZik7CiAgICAgIHZhciBNb2R1bGVDbGFzcyA9IHRoaXMuZ2V0Q2xhc3MoZGVmKTsKICAgICAgLy8gR2V0IGFuIGV4aXN0aW5nIG1vZHVsZSBvZiB0aGlzIG5hbWUgaWYgd2UgaGF2ZSBvbmUKICAgICAgdmFyIG1vZHVsZSA9IHBhcmVudE1vZHVsZVttb2R1bGVOYW1lXTsKICAgICAgaWYgKCFtb2R1bGUpIHsKICAgICAgICAvLyBDcmVhdGUgYSBuZXcgbW9kdWxlIGlmIHdlIGRvbid0IGhhdmUgb25lCiAgICAgICAgbW9kdWxlID0gbmV3IE1vZHVsZUNsYXNzKG1vZHVsZU5hbWUsIGFwcCwgb3B0aW9ucyk7CiAgICAgICAgcGFyZW50TW9kdWxlW21vZHVsZU5hbWVdID0gbW9kdWxlOwogICAgICAgIC8vIHN0b3JlIHRoZSBtb2R1bGUgb24gdGhlIHBhcmVudAogICAgICAgIHBhcmVudE1vZHVsZS5zdWJtb2R1bGVzW21vZHVsZU5hbWVdID0gbW9kdWxlOwogICAgICB9CiAgICAgIHJldHVybiBtb2R1bGU7CiAgICB9LAogICAgLy8gIyMgTW9kdWxlIENsYXNzZXMKICAgIC8vCiAgICAvLyBNb2R1bGUgY2xhc3NlcyBjYW4gYmUgdXNlZCBhcyBhbiBhbHRlcm5hdGl2ZSB0byB0aGUgZGVmaW5lIHBhdHRlcm4uCiAgICAvLyBUaGUgZXh0ZW5kIGZ1bmN0aW9uIG9mIGEgTW9kdWxlIGlzIGlkZW50aWNhbCB0byB0aGUgZXh0ZW5kIGZ1bmN0aW9ucwogICAgLy8gb24gb3RoZXIgQmFja2JvbmUgYW5kIE1hcmlvbmV0dGUgY2xhc3Nlcy4KICAgIC8vIFRoaXMgYWxsb3dzIG1vZHVsZSBsaWZlY3lsZSBldmVudHMgbGlrZSBgb25TdGFydGAgYW5kIGBvblN0b3BgIHRvIGJlIGNhbGxlZCBkaXJlY3RseS4KICAgIGdldENsYXNzOiBmdW5jdGlvbiAobW9kdWxlRGVmaW5pdGlvbikgewogICAgICB2YXIgTW9kdWxlQ2xhc3MgPSBNYXJpb25ldHRlLk1vZHVsZTsKICAgICAgaWYgKCFtb2R1bGVEZWZpbml0aW9uKSB7CiAgICAgICAgcmV0dXJuIE1vZHVsZUNsYXNzOwogICAgICB9CiAgICAgIC8vIElmIGFsbCBvZiB0aGUgbW9kdWxlJ3MgZnVuY3Rpb25hbGl0eSBpcyBkZWZpbmVkIGluc2lkZSBpdHMgY2xhc3MsCiAgICAgIC8vIHRoZW4gdGhlIGNsYXNzIGNhbiBiZSBwYXNzZWQgaW4gZGlyZWN0bHkuIGBNeUFwcC5tb2R1bGUoIkZvbyIsIEZvb01vZHVsZSlgLgogICAgICBpZiAobW9kdWxlRGVmaW5pdGlvbi5wcm90b3R5cGUgaW5zdGFuY2VvZiBNb2R1bGVDbGFzcykgewogICAgICAgIHJldHVybiBtb2R1bGVEZWZpbml0aW9uOwogICAgICB9CiAgICAgIHJldHVybiBtb2R1bGVEZWZpbml0aW9uLm1vZHVsZUNsYXNzIHx8IE1vZHVsZUNsYXNzOwogICAgfSwKICAgIC8vIEFkZCB0aGUgbW9kdWxlIGRlZmluaXRpb24gYW5kIGFkZCBhIHN0YXJ0V2l0aFBhcmVudCBpbml0aWFsaXplciBmdW5jdGlvbi4KICAgIC8vIFRoaXMgaXMgY29tcGxpY2F0ZWQgYmVjYXVzZSBtb2R1bGUgZGVmaW5pdGlvbnMgYXJlIGhlYXZpbHkgb3ZlcmxvYWRlZAogICAgLy8gYW5kIHN1cHBvcnQgYW4gYW5vbnltb3VzIGZ1bmN0aW9uLCBtb2R1bGUgY2xhc3MsIG9yIG9wdGlvbnMgb2JqZWN0CiAgICBfYWRkTW9kdWxlRGVmaW5pdGlvbjogZnVuY3Rpb24gKHBhcmVudE1vZHVsZSwgbW9kdWxlLCBkZWYsIGFyZ3MpIHsKICAgICAgdmFyIGZuID0gdGhpcy5fZ2V0RGVmaW5lKGRlZik7CiAgICAgIHZhciBzdGFydFdpdGhQYXJlbnQgPSB0aGlzLl9nZXRTdGFydFdpdGhQYXJlbnQoZGVmLCBtb2R1bGUpOwogICAgICBpZiAoZm4pIHsKICAgICAgICBtb2R1bGUuYWRkRGVmaW5pdGlvbihmbiwgYXJncyk7CiAgICAgIH0KICAgICAgdGhpcy5fYWRkU3RhcnRXaXRoUGFyZW50KHBhcmVudE1vZHVsZSwgbW9kdWxlLCBzdGFydFdpdGhQYXJlbnQpOwogICAgfSwKICAgIF9nZXRTdGFydFdpdGhQYXJlbnQ6IGZ1bmN0aW9uIChkZWYsIG1vZHVsZSkgewogICAgICB2YXIgc3dwOwogICAgICBpZiAoXy5pc0Z1bmN0aW9uKGRlZikgJiYgZGVmLnByb3RvdHlwZSBpbnN0YW5jZW9mIE1hcmlvbmV0dGUuTW9kdWxlKSB7CiAgICAgICAgc3dwID0gbW9kdWxlLmNvbnN0cnVjdG9yLnByb3RvdHlwZS5zdGFydFdpdGhQYXJlbnQ7CiAgICAgICAgcmV0dXJuIF8uaXNVbmRlZmluZWQoc3dwKSA/IHRydWUgOiBzd3A7CiAgICAgIH0KICAgICAgaWYgKF8uaXNPYmplY3QoZGVmKSkgewogICAgICAgIHN3cCA9IGRlZi5zdGFydFdpdGhQYXJlbnQ7CiAgICAgICAgcmV0dXJuIF8uaXNVbmRlZmluZWQoc3dwKSA/IHRydWUgOiBzd3A7CiAgICAgIH0KICAgICAgcmV0dXJuIHRydWU7CiAgICB9LAogICAgX2dldERlZmluZTogZnVuY3Rpb24gKGRlZikgewogICAgICBpZiAoXy5pc0Z1bmN0aW9uKGRlZikgJiYgIShkZWYucHJvdG90eXBlIGluc3RhbmNlb2YgTWFyaW9uZXR0ZS5Nb2R1bGUpKSB7CiAgICAgICAgcmV0dXJuIGRlZjsKICAgICAgfQogICAgICBpZiAoXy5pc09iamVjdChkZWYpKSB7CiAgICAgICAgcmV0dXJuIGRlZi5kZWZpbmU7CiAgICAgIH0KICAgICAgcmV0dXJuIG51bGw7CiAgICB9LAogICAgX2FkZFN0YXJ0V2l0aFBhcmVudDogZnVuY3Rpb24gKHBhcmVudE1vZHVsZSwgbW9kdWxlLCBzdGFydFdpdGhQYXJlbnQpIHsKICAgICAgbW9kdWxlLnN0YXJ0V2l0aFBhcmVudCA9IG1vZHVsZS5zdGFydFdpdGhQYXJlbnQgJiYgc3RhcnRXaXRoUGFyZW50OwogICAgICBpZiAoIW1vZHVsZS5zdGFydFdpdGhQYXJlbnQgfHwgISFtb2R1bGUuc3RhcnRXaXRoUGFyZW50SXNDb25maWd1cmVkKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIG1vZHVsZS5zdGFydFdpdGhQYXJlbnRJc0NvbmZpZ3VyZWQgPSB0cnVlOwogICAgICBwYXJlbnRNb2R1bGUuYWRkSW5pdGlhbGl6ZXIoZnVuY3Rpb24gKG9wdGlvbnMpIHsKICAgICAgICBpZiAobW9kdWxlLnN0YXJ0V2l0aFBhcmVudCkgewogICAgICAgICAgbW9kdWxlLnN0YXJ0KG9wdGlvbnMpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgfSk7CiAgcmV0dXJuIE1hcmlvbmV0dGU7Cn0pKTsKLyohCiAqIGJhc2UuanMKICogCiAqIENvcHlyaWdodCAoYykgMjAxNAogKi8KX2Jhc2VfID0gZnVuY3Rpb24gKE1hcmlvbmV0dGUpIHsKICAvKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIEJhc2UKICAgKgogICAqIE5vdCBpbnRlbmRlZCB0byBiZSB1c2VkIGRpcmVjdGx5LiBQcm92aWRlcyBiYXNlIGZ1bmN0aW9uYWxpdHkgZm9yCiAgICogQ29sbGVjdGlvbkNvbXBvbmVudCwgQ29tcG9zaXRlQ29tcG9uZW50LCBJdGVtQ29tcG9uZW50LCBhbmQgTGF5b3V0Q29tcG9uZW50LgogICAqIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAgcmV0dXJuIE1hcmlvbmV0dGUuT2JqZWN0LmV4dGVuZCh7CiAgICAvKioKICAgICAqIE92ZXJ3cml0ZSBNYXJpb25ldHRlLk9iamVjdCBjb25zdHJ1Y3RvciB0byBhZGQgYSBjcmVhdGVDb21wb25lbnQKICAgICAqIHN0ZXAgaW5iZXR3ZWVuIHNldHRpbmcgb3B0aW9ucyBhbmQgaW5pdGlhbGl6ZSBjYWxsLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKiB2YXIgY29udHJvbGxlciA9IG5ldyBDb21wb25lbnQoeyBWaWV3OiBJdGVtVmlldyB9KTsKICAgICAqCiAgICAgKiBAY29uc3RydWN0b3IKICAgICAqIEBwdWJsaWMKICAgICAqCiAgICAgKiBAcGFyYW0ge29iamVjdH0gb3B0aW9ucyAtIE9iamVjdCBvcHRpb25zLgogICAgICovCiAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24gKG9wdGlvbnMpIHsKICAgICAgdGhpcy5vcHRpb25zID0gXy5leHRlbmQoe30sIF8ucmVzdWx0KHRoaXMsICdvcHRpb25zJyksIG9wdGlvbnMpOwogICAgICB0aGlzLmNyZWF0ZVZpZXcoKTsKICAgICAgdGhpcy5pbml0aWFsaXplLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9LAogICAgLyoqCiAgICAgKiBJbnN0bmF0aWF0ZSBvdXIgdmlldyBwYXNzaW5nIGluIGFueSBkZWZpbmVkIGVudGl0aWVzLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKgogICAgICogQHBhcmFtIHtvYmplY3R9IG9wdGlvbnMgLSBPYmplY3Qgb3B0aW9ucyBwYXNzZWQgdG8gY29uc3RydWN0b3IuCiAgICAgKi8KICAgIGNyZWF0ZVZpZXc6IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIFZpZXcgPSB0aGlzLmdldFJlcXVpcmVkKCdWaWV3Jyk7CiAgICAgIHZhciBkZWZhdWx0cyA9IHRoaXMuY3JlYXRlRW50aXRpZXMoKTsKICAgICAgdmFyIG9wdGlvbnMgPSB0aGlzLmdldE9wdGlvbigndmlld09wdGlvbnMnKTsKICAgICAgLy8gUmVuZGVyIHlvIQogICAgICB0aGlzLnZpZXcgPSBuZXcgVmlldyhfLmV4dGVuZCh7fSwgZGVmYXVsdHMsIG9wdGlvbnMpKTsKICAgICAgdGhpcy5fYmluZEluc3RhbmNlRXZlbnRzKCd2aWV3Jyk7CiAgICB9LAogICAgLyoqCiAgICAgKiBCaW5kIGluc3RhbmNlIGV2ZW50cyB0byBjb21wb25lbnQuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gaW5zdGFuY2VOYW1lIC0gTmFtZSBvZiBpbnN0YW5jZSB0byBiaW5kIGV2ZW50cyBmcm9tLgogICAgICovCiAgICBfYmluZEluc3RhbmNlRXZlbnRzOiBmdW5jdGlvbiAoaW5zdGFuY2VOYW1lKSB7CiAgICAgIHZhciBpbnN0YW5jZSA9IHRoaXNbaW5zdGFuY2VOYW1lXTsKICAgICAgdmFyIGV2ZW50c05hbWUgPSBpbnN0YW5jZU5hbWUgKyAnRXZlbnRzJzsKICAgICAgdGhpcy5iaW5kRW50aXR5RXZlbnRzKGluc3RhbmNlLCB0aGlzLmdldE9wdGlvbihldmVudHNOYW1lKSk7CiAgICB9LAogICAgLyoqCiAgICAgKiBDcmVhdGUgZW50aXRpZXMgdG8gYmUgcGFzc2VkIHRvIHlvdXIgdmlldy4gQmFzZSBjbGFzcyBieSBkZWZhdWx0CiAgICAgKiBkb2VzIG5vdCBjcmVhdGUgb3IgcmV0dXJuIGFueSBlbnRpdGllcy4gQ29sbGVjdGlvbkNvbXBvbmVudCBmb3IKICAgICAqIGV4YW1wbGUgd291bGQgYXR0YWNoIHRoaXMuY29sbGVjdGlvbiBhbmQgcmV0dXJuIGFuIG9iamVjdCB3aXRoCiAgICAgKiBhIGNvbGxlY3Rpb24ga2V5IHdob3MgdmFsdWUgaXMgdGhlIG5ld2x5IGNyZWF0ZWQgY29sbGVjdGlvbi4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICovCiAgICBjcmVhdGVFbnRpdGllczogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4ge307CiAgICB9LAogICAgLyoqCiAgICAgKiBDcmVhdGUgZW50aXR5IChpZiBub3QgeWV0IGNyZWF0ZWQpLiBBZGQgaW5zdGFuY2UgdG8gY29tcG9uZW50CiAgICAgKiBhbmQgYmluZCBhbGwgaW5zdGFuY2UgZXZlbnRzIHRvIGNvbXBvbmVudC4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBpbnN0YW5jZU5hbWUgLSBOYW1lIG9mIGNsYXNzIHRvIGNyZWF0ZS9yZXRyaWV2ZS4KICAgICAqLwogICAgX2NyZWF0ZUVudGl0eTogZnVuY3Rpb24gKGluc3RhbmNlTmFtZSkgewogICAgICB2YXIgaW5zdGFuY2UgPSB0aGlzW2luc3RhbmNlTmFtZV0gPSB0aGlzLl9nZXRFbnRpdHkoaW5zdGFuY2VOYW1lKTsKICAgICAgdGhpcy5fYmluZEluc3RhbmNlRXZlbnRzKGluc3RhbmNlTmFtZSk7CiAgICAgIHJldHVybiBpbnN0YW5jZTsKICAgIH0sCiAgICAvKioKICAgICAqIFJldHJlaXZlIHByZS1leGlzdGluZyBkZWNsYXJlZCBpbnN0YW5jZSwgb3IgY3JlYXRlIGEgbmV3CiAgICAgKiBpbnN0YW5jZS4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBpbnN0YW5jZU5hbWUgLSBOYW1lIG9mIGNsYXNzIHRvIGNyZWF0ZS9yZXRyaWV2ZS4KICAgICAqLwogICAgX2dldEVudGl0eTogZnVuY3Rpb24gKGluc3RhbmNlTmFtZSkgewogICAgICB2YXIgaW5zdGFuY2UgPSB0aGlzLmdldE9wdGlvbihpbnN0YW5jZU5hbWUpOwogICAgICBpZiAoaW5zdGFuY2UpIHsKICAgICAgICByZXR1cm4gaW5zdGFuY2U7CiAgICAgIH0KICAgICAgdmFyIG9iak5hbWUgPSBpbnN0YW5jZU5hbWUuc3Vic3RyaW5nKDAsIDEpLnRvVXBwZXJDYXNlKCkgKyBpbnN0YW5jZU5hbWUuc3Vic3RyaW5nKDEpOwogICAgICB2YXIgT2JqID0gdGhpcy5nZXRPcHRpb24ob2JqTmFtZSk7CiAgICAgIHJldHVybiBuZXcgT2JqKCk7CiAgICB9LAogICAgLyoqCiAgICAgKiBDb21wb25lbnQgY2xlYW4gdXAgYnkgZGVzdHJveWluZyBjaGlsZCB2aWV3LiBPYmplY3QucHJvdG90eXBlLmRlc3Ryb3kKICAgICAqIGF1dG9tYXRpY2FsbHkgc3RvcHMgbGlzdGVuaW5nIHRvIGFsbCBldmVudHMuCiAgICAgKgogICAgICogQHB1YmxpYwogICAgICovCiAgICBkZXN0cm95OiBmdW5jdGlvbiAoKSB7CiAgICAgIC8vIENsZWFuIHVwIGJ5IGRlc3Ryb3lpbmcgbmVzdGVkIHZpZXcuCiAgICAgIHRoaXMudmlldy5kZXN0cm95KCk7CiAgICAgIE1hcmlvbmV0dGUuT2JqZWN0LnByb3RvdHlwZS5kZXN0cm95LmFwcGx5KHRoaXMpOwogICAgfSwKICAgIC8qKgogICAgICogTWFrZSBzdXJlIHByb3AgaXMgZGVmaW5lZCBvbiBvdXIgaW5zdGFuY2Ugb3IKICAgICAqIGluIG91ciBpbnN0YW5jZSBvcHRpb25zIG9iamVjdC4KICAgICAqCiAgICAgKiBAcHVibGljCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgLSBOYW1lIG9mIHByb3BlcnR5IHdlIGFyZSBjaGVja2luZwogICAgICogICBleGlzdGFuY2Ugb2YuCiAgICAgKi8KICAgIGdldFJlcXVpcmVkOiBmdW5jdGlvbiAobmFtZSkgewogICAgICB2YXIgb3B0aW9uID0gdGhpcy5nZXRPcHRpb24obmFtZSk7CiAgICAgIGlmICghb3B0aW9uKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdgJyArIG5hbWUgKyAnYCBtdXN0IHRvIGJlIGRlZmluZWQuJyk7CiAgICAgIH0KICAgICAgcmV0dXJuIG9wdGlvbjsKICAgIH0KICB9KTsKfShiYWNrYm9uZW1hcmlvbmV0dGUpOwovKiEKICogY29sbGVjdGlvbi5qcwogKiAKICogQ29weXJpZ2h0IChjKSAyMDE0CiAqLwpfY29sbGVjdGlvbl8gPSBmdW5jdGlvbiAoQmFja2JvbmUsIE1hcmlvbmV0dGUsIEJhc2UpIHsKICAvKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIENvbGxlY3Rpb25Db21wb25lbnQKICAgKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwogIHJldHVybiBCYXNlLmV4dGVuZCh7CiAgICAvLyBEZWZhdWx0IHRvIENvbGxlY3Rpb25WaWV3CiAgICBWaWV3OiBNYXJpb25ldHRlLkNvbGxlY3Rpb25WaWV3LAogICAgQ29sbGVjdGlvbjogQmFja2JvbmUuQ29sbGVjdGlvbiwKICAgIC8qKgogICAgICogQXR0YWNoIGFuZCByZXR1cm4gb2JqZWN0IHdpdGggY29sbGVjdGlvbiBpbnN0YW5jZS4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICovCiAgICBjcmVhdGVFbnRpdGllczogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4geyBjb2xsZWN0aW9uOiB0aGlzLl9jcmVhdGVFbnRpdHkoJ2NvbGxlY3Rpb24nKSB9OwogICAgfQogIH0pOwp9KGJhY2tib25lLCBiYWNrYm9uZW1hcmlvbmV0dGUsIF9iYXNlXyk7Ci8qIQogKiBjb21wb3NpdGUuanMKICogCiAqIENvcHlyaWdodCAoYykgMjAxNAogKi8KY29tcG9zaXRlID0gZnVuY3Rpb24gKEJhY2tib25lLCBNYXJpb25ldHRlLCBCYXNlKSB7CiAgLyogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBDb21wb3NpdGVDb21wb25lbnQKICAgKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwogIHJldHVybiBCYXNlLmV4dGVuZCh7CiAgICAvLyBEZWZhdWx0IHRvIENvbXBvc2l0ZVZpZXcKICAgIFZpZXc6IE1hcmlvbmV0dGUuQ29tcG9zaXRlVmlldywKICAgIE1vZGVsOiBCYWNrYm9uZS5Nb2RlbCwKICAgIENvbGxlY3Rpb246IEJhY2tib25lLkNvbGxlY3Rpb24sCiAgICAvKioKICAgICAqIEF0dGFjaCBhbmQgcmV0dXJuIG9iamVjdCB3aXRoIGNvbGxlY3Rpb24gYW5kIG1vZGVsIGluc3RhbmNlcy4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICovCiAgICBjcmVhdGVFbnRpdGllczogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gewogICAgICAgIG1vZGVsOiB0aGlzLl9jcmVhdGVFbnRpdHkoJ21vZGVsJyksCiAgICAgICAgY29sbGVjdGlvbjogdGhpcy5fY3JlYXRlRW50aXR5KCdjb2xsZWN0aW9uJykKICAgICAgfTsKICAgIH0KICB9KTsKfShiYWNrYm9uZSwgYmFja2JvbmVtYXJpb25ldHRlLCBfYmFzZV8pOwovKiEKICogaXRlbS5qcwogKiAKICogQ29weXJpZ2h0IChjKSAyMDE0CiAqLwppdGVtID0gZnVuY3Rpb24gKEJhY2tib25lLCBNYXJpb25ldHRlLCBCYXNlKSB7CiAgLyogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBJdGVtQ29tcG9uZW50CiAgICogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICByZXR1cm4gQmFzZS5leHRlbmQoewogICAgLy8gRGVmYXVsdCB0byBJdGVtVmlldwogICAgVmlldzogTWFyaW9uZXR0ZS5JdGVtVmlldywKICAgIE1vZGVsOiBCYWNrYm9uZS5Nb2RlbCwKICAgIC8qKgogICAgICogQXR0YWNoIGFuZCByZXR1cm4gb2JqZWN0IHdpdGggbW9kZWwgaW5zdGFuY2UuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqLwogICAgY3JlYXRlRW50aXRpZXM6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIHsgbW9kZWw6IHRoaXMuX2NyZWF0ZUVudGl0eSgnbW9kZWwnKSB9OwogICAgfQogIH0pOwp9KGJhY2tib25lLCBiYWNrYm9uZW1hcmlvbmV0dGUsIF9iYXNlXyk7Ci8qIQogKiBsYXlvdXQuanMKICogCiAqIENvcHlyaWdodCAoYykgMjAxNAogKi8KbGF5b3V0ID0gZnVuY3Rpb24gKE1hcmlvbmV0dGUsIEl0ZW0pIHsKICAvKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIExheW91dENvbXBvbmVudAogICAqCiAgICogQ3VycmVudGx5IGJsYW5rIDovIE5lZWQgdG8gZGlnIHRocm91Z2ggbGF5b3V0VmlldyB0byBzZWUgcG9zc2libGUKICAgKiBpbnRlZ3JhdGlvbnMgZm9yIG1ha2luZyBpdCBlYXNpZXIgdG8gd29yayB3aXRoIHJlZ2lvbnMgZnJvbSBhIGNvbXBvbmVudC4KICAgKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwogIHJldHVybiBJdGVtLmV4dGVuZCh7CiAgICAvLyBEZWZhdWx0IHRvIExheW91dFZpZXcKICAgIFZpZXc6IE1hcmlvbmV0dGUuTGF5b3V0VmlldywKICAgIC8qKgogICAgICogU3VibGNhc3MgY29uc3RydWN0b3IgdG8gc3RvcmUgY3JlYXRlZCBjb21wb25lbnRzIHNvIHRoZXkKICAgICAqIGNhbiBiZSBpbnN0YW50aWF0ZWQgYW5kIGNsZWFuZWQgb24gZGVzdHJveS4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICogdmFyIGNvbnRyb2xsZXIgPSBuZXcgQ29tcG9uZW50KHsgVmlldzogSXRlbVZpZXcgfSk7CiAgICAgKgogICAgICogQGNvbnN0cnVjdG9yCiAgICAgKiBAcHVibGljCiAgICAgKgogICAgICogQHBhcmFtIHtvYmplY3R9IG9wdGlvbnMgLSBPYmplY3Qgb3B0aW9ucy4KICAgICAqLwogICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uICgpIHsKICAgICAgLy8gQ3JlYXRlIGFuIGVtcHR5IG9iamVjdCB0byBzdG9yZSBjcmVhdGVkIGNvbXBvbmVudHMuCiAgICAgIHRoaXMuY2hpbGRyZW4gPSB7fTsKICAgICAgLy8gQ3JlYXRlIGFuIGVtcHR5IG9iamVjdCB0byBzdG9yZSBjdXJyZW50bHkgc2hvd24KICAgICAgLy8gY29tcG9uZW50cyBpbiBlYWNoIHJlZ2lvbi4gS2V5IHJlcHJlc2VudHMgdGhlIHJlZ2lvbgogICAgICAvLyBhbmQgdmFsdWUgaXMgYSByZWZlcmVuY2UgdG8gdGhlIGNvbXBvbmVudCBzdG9yZWQgaW4KICAgICAgLy8gaW5zdGFuY2UgdmFyaWFibGUgYGNoaWxkcmVuYC4KICAgICAgdGhpcy5zaG93aW5nID0ge307CiAgICAgIEl0ZW0ucHJvdG90eXBlLmNvbnN0cnVjdG9yLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9LAogICAgLyogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAgKiBjcmVhdGUgJiBzaG93CiAgICAgKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICAgIC8qKgogICAgICogU2hvdyBhIGNvbXBvbmVudCB3aXRoaW4gYSBkZXNpZ25hdGVkIHJlZ2lvbi4KICAgICAqCiAgICAgKiBAcHVibGljCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IHJlZ2lvbk5hbWUgLSBOYW1lIG9mIHJlZ2lvbiB0byBkaXNwbGF5IGNvbXBvbmVudCB3aXRoaW4uCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gY29tcG9uZW50TmFtZSAtIE5hbWUgb2YgY29tcG9uZW50IHRvIGRpc3BsYXkgd2l0aGluIHJlZ2lvbi4KICAgICAqIEBwYXJhbSB7Y29uc3RydWN0b3J9IENvbXBvbmVudCAtIENsYXNzIG9mIGNvbXBvbmVudCB0byBpbnN0bmF0aWF0ZS4KICAgICAqIEBwYXJhbSB7b2JqZWN0fSBvcHRpb25zIC0gT3B0aW9ucyB0byBwYXNzIHRvIGNvbXBvbmVudCBhdCBpbnN0YW50aWF0aW9uLgogICAgICogQHBhcmFtIHtib29sZWFufSBwcmV2ZW50RGVzdHJveSAtIFdoZXRoZXIgb3Igbm90IHlvdSBzaG91bGQgZGVzdHJveSB0aGUKICAgICAqICAgcHJldmlvdXMgQ29tcG9uZW50LgogICAgICovCiAgICBzaG93OiBmdW5jdGlvbiAocmVnaW9uTmFtZSwgY29tcG9uZW50TmFtZSwgQ29tcG9uZW50LCBvcHRpb25zLCBwcmV2ZW50RGVzdHJveSkgewogICAgICB2YXIgcmVnaW9uID0gdGhpcy5nZXRSZWdpb24ocmVnaW9uTmFtZSk7CiAgICAgIHZhciBjdXJyZW50TmFtZSA9IHRoaXMuc2hvd2luZ1tyZWdpb25OYW1lXTsKICAgICAgdmFyIGN1cnJlbnRDb21wb25lbnQgPSByZWdpb25bY3VycmVudE5hbWVdOwogICAgICAvLyBsaWZlIGlzIGVhc3kgd2hlbiBub3RoaW5nIG5lZWRzIHRvIGNoYW5nZQogICAgICBpZiAoY3VycmVudE5hbWUgPT09IGNvbXBvbmVudE5hbWUpIHsKICAgICAgICByZXR1cm4gY3VycmVudENvbXBvbmVudDsKICAgICAgfQogICAgICAvLyBpZiBhbm90aGVyIHZpZXcgaXMgY3VycmVudGx5IGJlaW5nIHNob3cgYW5kIHdlIGRvbid0CiAgICAgIC8vIHdhbnQgdG8gcHJldmVudCBpdHMgZGVzdHJ1Y3Rpb24uLi4KICAgICAgaWYgKGN1cnJlbnROYW1lICYmICFwcmV2ZW50RGVzdHJveSkgewogICAgICAgIHRoaXMuZGVzdHJveUNoaWxkKGN1cnJlbnRDb21wb25lbnQsIHJlZ2lvbk5hbWUpOwogICAgICAgIGRlbGV0ZSByZWdpb25bY3VycmVudE5hbWVdOwogICAgICB9CiAgICAgIC8vIGlmIHdlIGRvbid0IGV4aXN0IHlldCwgd2Ugc2hvdWxkLgogICAgICBpZiAoIXJlZ2lvbltjb21wb25lbnROYW1lXSkgewogICAgICAgIHJlZ2lvbltjb21wb25lbnROYW1lXSA9IHRoaXMuY3JlYXRlQ2hpbGQoQ29tcG9uZW50LCBvcHRpb25zLCByZWdpb25OYW1lKTsKICAgICAgfQogICAgICAvLyBzaG93CiAgICAgIHRoaXMuc2hvd2luZ1tyZWdpb25OYW1lXSA9IGNvbXBvbmVudE5hbWU7CiAgICAgIHRoaXMudmlld1tyZWdpb25OYW1lXS5zaG93KHJlZ2lvbltjb21wb25lbnROYW1lXS52aWV3LCB7IHByZXZlbnREZXN0cm95OiBwcmV2ZW50RGVzdHJveSB9KTsKICAgICAgLy8gcmV0dXJuIHRoZSBuZXcgY29tcG9uZW50CiAgICAgIHJldHVybiByZWdpb25bY29tcG9uZW50TmFtZV07CiAgICB9LAogICAgLyoqCiAgICAgICAqIENyZWF0ZSBhIGNoaWxkIGNvbXBvbmVudC4gQW5kIGJpbmQgZW50aXR5IGV2ZW50cwogICAgICAgKiB0byBsYXlvdXQgY29tcG9uZW50LgogICAgICAgKgogICAgICAgKiBAcHJpdmF0ZQogICAgICAgKgogICAgICAgKiBAcGFyYW0ge2NvbnN0cnVjdG9yfSBDb21wb25lbnQgLSBDb21wb25lbnQgdG8gaW5zdGFudGlhdGUuCiAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBjb21wb25lbnROYW1lIC0gTmFtZSBvZiBjb21wb25lbnQgdG8gY3JlYXRlCiAgICAKICAgICAgICovCiAgICBjcmVhdGVDaGlsZDogZnVuY3Rpb24gKENvbXBvbmVudCwgb3B0aW9ucywgcmVnaW9uTmFtZSkgewogICAgICB2YXIgY29tcG9uZW50ID0gbmV3IENvbXBvbmVudChvcHRpb25zIHx8IHt9KTsKICAgICAgdmFyIGV2ZW50cyA9IHRoaXMuZ2V0UmVnaW9uRXZlbnRzKHJlZ2lvbk5hbWUpOwogICAgICB0aGlzLmJpbmRFbnRpdHlFdmVudHMoY29tcG9uZW50LCBldmVudHMpOwogICAgICByZXR1cm4gY29tcG9uZW50OwogICAgfSwKICAgIC8qIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgICogZW1wdHkKICAgICAqIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwogICAgLyoqCiAgICAgKiBMb29wIG92ZXIgYWxsIHJlZ2lvbnMgd2l0aCBjaGlsZHJlbiBjb21wb25lbnRzLCBhbmQgZGVzdHJveQogICAgICogY29tcG9uZW50cy9yZW1vdmUgZXZlbnQgYmluZGluZ3MuCiAgICAgKgogICAgICogQHB1YmxpYwogICAgICovCiAgICBlbXB0eTogZnVuY3Rpb24gKCkgewogICAgICBfLmVhY2godGhpcy5jaGlsZHJlbiwgZnVuY3Rpb24gKHJlZ2lvbnMsIHJlZ2lvbk5hbWUpIHsKICAgICAgICB0aGlzLmVtcHR5UmVnaW9uKHJlZ2lvbk5hbWUpOwogICAgICB9LCB0aGlzKTsKICAgIH0sCiAgICAvKioKICAgICAqIEVtcHR5IGEgZ2l2ZW4gcmVnaW9uIGJ5IG5hbWUuIElmIG5vIHJlZ2lvbiBpcyBwcm92aWRlZAogICAgICogYWxsIHJlZ2lvbnMgd2lsbCBiZSBlbXB0eS4gUHJldHR5IG11Y2gganVzdCBhIHdyYXBwZXIgYXJvdW5kCiAgICAgKiBkZXN0cm95UmVnaW9uQ2hpbGRyZW4uCiAgICAgKgogICAgICogQHB1YmxpYwogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSByZWdpb05hbWUgLSBOYW1lIG9mIHJlZ2lvbiB0byBlbXB0eQogICAgICovCiAgICBlbXB0eVJlZ2lvbjogZnVuY3Rpb24gKHJlZ2lvbk5hbWUpIHsKICAgICAgdGhpcy5kZXN0cm95UmVnaW9uQ2hpbGRyZW4odGhpcy5jaGlsZHJlbltyZWdpb25OYW1lXSwgcmVnaW9uTmFtZSk7CiAgICAgIGRlbGV0ZSB0aGlzLnNob3dpbmdbcmVnaW9uTmFtZV07CiAgICB9LAogICAgLyogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAgKiBkZXN0cm95CiAgICAgKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICAgIC8qKgogICAgICogQ2FsbGVkIG9uIGNvbnRyb2xsZXIgZGVzdHJveS4gVXNlZCB0byBkZXN0cm95IGNoaWxkcmVuCiAgICAgKiBjb21wb25lbnRzIGFuZCBjbGVhbiB1cCBhbnkgYm91bmQgZXZlbnRzLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKi8KICAgIGRlc3Ryb3k6IGZ1bmN0aW9uICgpIHsKICAgICAgXy5lYWNoKHRoaXMuY2hpbGRyZW4sIHRoaXMuZGVzdHJveVJlZ2lvbkNoaWxkcmVuLCB0aGlzKTsKICAgICAgSXRlbS5wcm90b3R5cGUuZGVzdHJveS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfSwKICAgIC8qKgogICAgICogRGVzdHJveSBhbGwgY29tcG9uZW50cyBpbiBhIGdpdmVuIHJlZ2lvbi4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICoKICAgICAqIEBwYXJhbSB7b2JqZWN0fSByZWdpb24gLSBjaGlsZHJlbiByZWdpb24gb2JqZWN0LgogICAgICogQHBhcmFtIHtzdHJpbmd9IHJlZ2lvbk5hbWUgLSBOYW1lIG9mIHJlZ2lvbiB0byBkZXN0cm95LgogICAgICovCiAgICBkZXN0cm95UmVnaW9uQ2hpbGRyZW46IGZ1bmN0aW9uIChyZWdpb24sIHJlZ2lvbk5hbWUpIHsKICAgICAgXy5lYWNoKHJlZ2lvbiwgZnVuY3Rpb24gKGNvbXBvbmVudCwgY29tcG9uZW50TmFtZSkgewogICAgICAgIHRoaXMuZGVzdHJveUNoaWxkKGNvbXBvbmVudCwgcmVnaW9uTmFtZSk7CiAgICAgIH0sIHRoaXMpOwogICAgICBkZWxldGUgdGhpcy5jaGlsZHJlbltyZWdpb25OYW1lXTsKICAgIH0sCiAgICAvKioKICAgICAqIERlc3Ryb3kgYSBjaGlsZCBjb21wb25lbnQuIEFuZCB1bmJpbmQgZW50aXR5IGV2ZW50cwogICAgICogZnJvbSBsYXlvdXQgY29tcG9uZW50LgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKgogICAgICogQHBhcmFtIHtvYmplY3R9IGNvbXBvbmVudCAtIGNvbXBvbmVudCB0byBkZXN0cm95LgogICAgICogQHBhcmFtIHtzdHJpbmd9IGNvbXBvbmVudE5hbWUgLSBOYW1lIG9mIGNvbXBvbmVudCB0byBkZXN0cm95LgogICAgICogQHBhcmFtIHtzdHJpbmd9IHJlZ2lvbk5hbWUgLSBOYW1lIG9mIHJlZ2lvbiB1c2VkIHRvIHVuYmluZCBjb21wb25lbnQKICAgICAqICAgZXZlbnRzLgogICAgICovCiAgICBkZXN0cm95Q2hpbGQ6IGZ1bmN0aW9uIChjb21wb25lbnQsIHJlZ2lvbk5hbWUpIHsKICAgICAgdmFyIGV2ZW50cyA9IHRoaXMuZ2V0UmVnaW9uRXZlbnRzKHJlZ2lvbk5hbWUpOwogICAgICB0aGlzLnVuYmluZEVudGl0eUV2ZW50cyhjb21wb25lbnQsIGV2ZW50cyk7CiAgICAgIGNvbXBvbmVudC5kZXN0cm95KCk7CiAgICB9LAogICAgLyogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAgKiB1dGlscwogICAgICogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAgICAvKioKICAgICAqIFJldHVybiB0aGUgY29tcG9uZW50IGJlaW5nIHNob3cgaW4gYSBnaXZlbiByZWdpb24uCiAgICAgKgogICAgICogQHB1YmxpYwogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSByZWdpb25OYW1lIC0gTmFtZSBvZiByZWdpb24gdG8gZ3JhYiBjdXJyZW50IHNob3duCiAgICAgKiAgIGNvbXBvbmVudCBmcm9tLgogICAgICovCiAgICBzaG93aW5nSW46IGZ1bmN0aW9uIChyZWdpb25OYW1lKSB7CiAgICAgIHZhciBjb21wb25lbnROYW1lID0gdGhpcy5zaG93aW5nW3JlZ2lvbk5hbWVdOwogICAgICByZXR1cm4gdGhpcy5jaGlsZHJlbltyZWdpb25OYW1lXVtjb21wb25lbnROYW1lXTsKICAgIH0sCiAgICAvKioKICAgICAqIFJldHVybiBldmVudHMgaGFzaCBmb3IgZ2l2ZW4gCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gcmVnaW9uTmFtZSAtIEdldCBldmVudHMgaGFzaCBmb3IgYSBnaXZlbiByZWdpb24uCiAgICAgKi8KICAgIGdldFJlZ2lvbkV2ZW50czogZnVuY3Rpb24gKHJlZ2lvbk5hbWUpIHsKICAgICAgcmV0dXJuIHRoaXMuZ2V0T3B0aW9uKHJlZ2lvbk5hbWUgKyAnRXZlbnRzJyk7CiAgICB9LAogICAgLyoqCiAgICAgKiBHZXQgcmVnaW9uIGNvbnRlbnRzIGZyb20gY2hpbGRyZW4uIElmIG5vIHJlZ2lvbiBleGlzdHMKICAgICAqIHNldCBhbmQgcmV0dXJuIGVtcHR5IG9iamVjdC4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSByZWdpb25OYW1lIC0gTmFtZSBvZiByZWdpb24gdG8gcmV0dXJuIGNoaWxkcmVuCiAgICAgKiAgIGNvbnRlbnRzIGZyb20uCiAgICAgKi8KICAgIGdldFJlZ2lvbjogZnVuY3Rpb24gKHJlZ2lvbk5hbWUpIHsKICAgICAgdmFyIHJlZ2lvbiA9IHRoaXMuY2hpbGRyZW5bcmVnaW9uTmFtZV0gPSB0aGlzLmNoaWxkcmVuW3JlZ2lvbk5hbWVdIHx8IHt9OwogICAgICByZXR1cm4gcmVnaW9uOwogICAgfQogIH0pOwp9KGJhY2tib25lbWFyaW9uZXR0ZSwgaXRlbSk7Ci8qIQogKiBtYXJpb25ldHRlLmNvbXBvbmVudHMuanMKICogCiAqIENvcHlyaWdodCAoYykgMjAxNAogKi8KbWFyaW9uZXR0ZWNvbXBvbmVudHMgPSBmdW5jdGlvbiAoQmFzZSwgQ29sbGVjdGlvbiwgQ29tcG9zaXRlLCBJdGVtLCBMYXlvdXQpIHsKICAvKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIG1hcmlvbmV0dGUuY29tcG9uZW50cwogICAqIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAgcmV0dXJuIHsKICAgIEJhc2VDb21wb25lbnQ6IEJhc2UsCiAgICBDb2xsZWN0aW9uQ29tcG9uZW50OiBDb2xsZWN0aW9uLAogICAgQ29tcG9zaXRlQ29tcG9uZW50OiBDb21wb3NpdGUsCiAgICBJdGVtQ29tcG9uZW50OiBJdGVtLAogICAgTGF5b3V0Q29tcG9uZW50OiBMYXlvdXQKICB9Owp9KF9iYXNlXywgX2NvbGxlY3Rpb25fLCBjb21wb3NpdGUsIGl0ZW0sIGxheW91dCk7CgpyZXR1cm4gbWFyaW9uZXR0ZUNvbXBvbmVudHM7CgoKfSkpOw==",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Fri, 07 Nov 2014 09:16:31 GMT",
                    "Content-Length": "510556",
                    "Date": "Fri, 07 Nov 2014 09:16:31 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}