{
    "url": "http://localhost:9999/kmalakoff/knockback/packages/nuget/Content/Scripts/knockback-core-stack.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Open redirection (DOM-based)",
    "issueType": 5243152,
    "severity": "Low",
    "confidence": "Firm",
    "issueBackground": "DOM-based open redirection vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this data into the target of a redirection in an unsafe way. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will cause a redirection to an arbitrary external domain. This behavior can be leveraged to facilitate phishing attacks against users of the application. The ability to use an authentic application URL, targeting the correct domain with a valid SSL certificate (if SSL is used) lends credibility to the phishing attack because many users, even if they verify these features, will not notice the subsequent redirection to a different domain.<br><br><b>Note:</b> If an attacker is able to control the start of the string that is passed to the redirection API, then it may be possible to escalate this vulnerability into a JavaScript injection attack, by using a URL with the javascript: pseudo-protocol to execute arbitrary script code when the URL is processed by the browser.",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based open redirection vulnerabilities is not to dynamically set redirection targets using data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing an arbitrary URL as a redirection target. In general, this is best achieved by using a whitelist of URLs that are permitted redirection targets, and strictly validating the target against this list before performing the redirection.",
    "issueDetail": "The application may be vulnerable to DOM-based open redirection. Data is read from <b>location.href</b> and written to <b>location.replace()</b> via the following statements:<ul><li>var href = location.href.replace(/(javascript:|#).*$/, '');</li><li>location.replace(href + '#' + fragment);</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/kmalakoff/knockback/packages/nuget/Content/Scripts/knockback-core-stack.js",
                "path": "/kmalakoff/knockback/packages/nuget/Content/Scripts/knockback-core-stack.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9rbWFsYWtvZmYva25vY2tiYWNrL3BhY2thZ2VzL251Z2V0L0NvbnRlbnQvU2NyaXB0cy9rbm9ja2JhY2stY29yZS1zdGFjay5qcyBIVFRQLzEuMQ0KSG9zdDogbG9jYWxob3N0Ojk5OTkNCg0K",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogNDc0OTk3DQpBY2NlcHQtUmFuZ2VzOiBieXRlcw0KQ29udGVudC1UeXBlOiBhcHBsaWNhdGlvbi9qYXZhc2NyaXB0DQpEYXRlOiBGcmksIDA3IE5vdiAyMDE0IDA4OjA5OjQ5IEdNVA0KTGFzdC1Nb2RpZmllZDogRnJpLCAwNyBOb3YgMjAxNCAwODowOTo0OCBHTVQNCg0KLyoKICBrbm9ja2JhY2stY29yZS1zdGFjay5qcyAwLjIwLjQKICBDb3B5cmlnaHQgKGMpICAyMDExLTIwMTQgS2V2aW4gTWFsYWtvZmYuCiAgTGljZW5zZTogTUlUIChodHRwOi8vd3d3Lm9wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL21pdC1saWNlbnNlLnBocCkKICBTb3VyY2U6IGh0dHBzOi8vZ2l0aHViLmNvbS9rbWFsYWtvZmYva25vY2tiYWNrCiAgRGVwZW5kZW5jaWVzOiBLbm9ja291dC5qcywgQmFja2JvbmUuanMsIGFuZCBVbmRlcnNjb3JlLmpzIChvciBMb0Rhc2guanMpLgogIE9wdGlvbmFsIGRlcGVuZGVuY2llczogQmFja2JvbmUuTW9kZWxSZWYuanMgYW5kIEJhY2tib25lT1JNLgoqLwooZnVuY3Rpb24gd2VicGFja1VuaXZlcnNhbE1vZHVsZURlZmluaXRpb24ocm9vdCwgZmFjdG9yeSkgewoJaWYodHlwZW9mIGV4cG9ydHMgPT09ICdvYmplY3QnICYmIHR5cGVvZiBtb2R1bGUgPT09ICdvYmplY3QnKQoJCW1vZHVsZS5leHBvcnRzID0gZmFjdG9yeShyZXF1aXJlKCJqcXVlcnkiKSk7CgllbHNlIGlmKHR5cGVvZiBkZWZpbmUgPT09ICdmdW5jdGlvbicgJiYgZGVmaW5lLmFtZCkKCQlkZWZpbmUoWyJqcXVlcnkiXSwgZmFjdG9yeSk7CgllbHNlIGlmKHR5cGVvZiBleHBvcnRzID09PSAnb2JqZWN0JykKCQlleHBvcnRzWyJrYiJdID0gZmFjdG9yeShyZXF1aXJlKCJqcXVlcnkiKSk7CgllbHNlCgkJcm9vdFsia2IiXSA9IGZhY3Rvcnkocm9vdFsialF1ZXJ5Il0pOwp9KSh0aGlzLCBmdW5jdGlvbihfX1dFQlBBQ0tfRVhURVJOQUxfTU9EVUxFXzE1X18pIHsKcmV0dXJuIC8qKioqKiovIChmdW5jdGlvbihtb2R1bGVzKSB7IC8vIHdlYnBhY2tCb290c3RyYXAKLyoqKioqKi8gCS8vIFRoZSBtb2R1bGUgY2FjaGUKLyoqKioqKi8gCXZhciBpbnN0YWxsZWRNb2R1bGVzID0ge307Ci8qKioqKiovCi8qKioqKiovIAkvLyBUaGUgcmVxdWlyZSBmdW5jdGlvbgovKioqKioqLyAJZnVuY3Rpb24gX193ZWJwYWNrX3JlcXVpcmVfXyhtb2R1bGVJZCkgewovKioqKioqLwovKioqKioqLyAJCS8vIENoZWNrIGlmIG1vZHVsZSBpcyBpbiBjYWNoZQovKioqKioqLyAJCWlmKGluc3RhbGxlZE1vZHVsZXNbbW9kdWxlSWRdKQovKioqKioqLyAJCQlyZXR1cm4gaW5zdGFsbGVkTW9kdWxlc1ttb2R1bGVJZF0uZXhwb3J0czsKLyoqKioqKi8KLyoqKioqKi8gCQkvLyBDcmVhdGUgYSBuZXcgbW9kdWxlIChhbmQgcHV0IGl0IGludG8gdGhlIGNhY2hlKQovKioqKioqLyAJCXZhciBtb2R1bGUgPSBpbnN0YWxsZWRNb2R1bGVzW21vZHVsZUlkXSA9IHsKLyoqKioqKi8gCQkJZXhwb3J0czoge30sCi8qKioqKiovIAkJCWlkOiBtb2R1bGVJZCwKLyoqKioqKi8gCQkJbG9hZGVkOiBmYWxzZQovKioqKioqLyAJCX07Ci8qKioqKiovCi8qKioqKiovIAkJLy8gRXhlY3V0ZSB0aGUgbW9kdWxlIGZ1bmN0aW9uCi8qKioqKiovIAkJbW9kdWxlc1ttb2R1bGVJZF0uY2FsbChtb2R1bGUuZXhwb3J0cywgbW9kdWxlLCBtb2R1bGUuZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXyk7Ci8qKioqKiovCi8qKioqKiovIAkJLy8gRmxhZyB0aGUgbW9kdWxlIGFzIGxvYWRlZAovKioqKioqLyAJCW1vZHVsZS5sb2FkZWQgPSB0cnVlOwovKioqKioqLwovKioqKioqLyAJCS8vIFJldHVybiB0aGUgZXhwb3J0cyBvZiB0aGUgbW9kdWxlCi8qKioqKiovIAkJcmV0dXJuIG1vZHVsZS5leHBvcnRzOwovKioqKioqLyAJfQovKioqKioqLwovKioqKioqLwovKioqKioqLyAJLy8gZXhwb3NlIHRoZSBtb2R1bGVzIG9iamVjdCAoX193ZWJwYWNrX21vZHVsZXNfXykKLyoqKioqKi8gCV9fd2VicGFja19yZXF1aXJlX18ubSA9IG1vZHVsZXM7Ci8qKioqKiovCi8qKioqKiovIAkvLyBleHBvc2UgdGhlIG1vZHVsZSBjYWNoZQovKioqKioqLyAJX193ZWJwYWNrX3JlcXVpcmVfXy5jID0gaW5zdGFsbGVkTW9kdWxlczsKLyoqKioqKi8KLyoqKioqKi8gCS8vIF9fd2VicGFja19wdWJsaWNfcGF0aF9fCi8qKioqKiovIAlfX3dlYnBhY2tfcmVxdWlyZV9fLnAgPSAiIjsKLyoqKioqKi8KLyoqKioqKi8gCS8vIExvYWQgZW50cnkgbW9kdWxlIGFuZCByZXR1cm4gZXhwb3J0cwovKioqKioqLyAJcmV0dXJuIF9fd2VicGFja19yZXF1aXJlX18oMCk7Ci8qKioqKiovIH0pCi8qKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKiovCi8qKioqKiovIChbCi8qIDAgKi8KLyoqKi8gZnVuY3Rpb24obW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CgoJX193ZWJwYWNrX3JlcXVpcmVfXygxKTsKCV9fd2VicGFja19yZXF1aXJlX18oMik7CglfX3dlYnBhY2tfcmVxdWlyZV9fKDMpOwoJX193ZWJwYWNrX3JlcXVpcmVfXyg0KTsKCV9fd2VicGFja19yZXF1aXJlX18oNSk7CglfX3dlYnBhY2tfcmVxdWlyZV9fKDYpOwoJX193ZWJwYWNrX3JlcXVpcmVfXyg3KTsKCV9fd2VicGFja19yZXF1aXJlX18oOCk7CglfX3dlYnBhY2tfcmVxdWlyZV9fKDkpOwoJX193ZWJwYWNrX3JlcXVpcmVfXygxMCk7CglfX3dlYnBhY2tfcmVxdWlyZV9fKDExKTsKCV9fd2VicGFja19yZXF1aXJlX18oMTIpOwoJX193ZWJwYWNrX3JlcXVpcmVfXygxMyk7Cgltb2R1bGUuZXhwb3J0cyA9IF9fd2VicGFja19yZXF1aXJlX18oMTQpOwoKCi8qKiovIH0sCi8qIDEgKi8KLyoqKi8gZnVuY3Rpb24obW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CgoJCgkvKgoJICBrbm9ja2JhY2suanMgMC4yMC40CgkgIENvcHlyaWdodCAoYykgIDIwMTEtMjAxNCBLZXZpbiBNYWxha29mZi4KCSAgTGljZW5zZTogTUlUIChodHRwOi8vd3d3Lm9wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL21pdC1saWNlbnNlLnBocCkKCSAgU291cmNlOiBodHRwczovL2dpdGh1Yi5jb20va21hbGFrb2ZmL2tub2NrYmFjawoJICBEZXBlbmRlbmNpZXM6IEtub2Nrb3V0LmpzLCBCYWNrYm9uZS5qcywgYW5kIFVuZGVyc2NvcmUuanMgKG9yIExvRGFzaC5qcykuCgkgIE9wdGlvbmFsIGRlcGVuZGVuY2llczogQmFja2JvbmUuTW9kZWxSZWYuanMgYW5kIEJhY2tib25lT1JNLgoJICovCgl2YXIgQ09NUEFSRV9BU0NFTkRJTkcsIENPTVBBUkVfREVTQ0VORElORywgQ09NUEFSRV9FUVVBTCwgS0VZU19QVUJMSVNILCBrYiwga28sIF8sIF9yZWYsCgkgIF9fYmluZCA9IGZ1bmN0aW9uKGZuLCBtZSl7IHJldHVybiBmdW5jdGlvbigpeyByZXR1cm4gZm4uYXBwbHkobWUsIGFyZ3VtZW50cyk7IH07IH0sCgkgIF9faW5kZXhPZiA9IFtdLmluZGV4T2YgfHwgZnVuY3Rpb24oaXRlbSkgeyBmb3IgKHZhciBpID0gMCwgbCA9IHRoaXMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7IGlmIChpIGluIHRoaXMgJiYgdGhpc1tpXSA9PT0gaXRlbSkgcmV0dXJuIGk7IH0gcmV0dXJuIC0xOyB9OwoKCV9yZWYgPSBrYiA9IF9fd2VicGFja19yZXF1aXJlX18oNiksIF8gPSBfcmVmLl8sIGtvID0gX3JlZi5rbzsKCglDT01QQVJFX0VRVUFMID0gMDsKCglDT01QQVJFX0FTQ0VORElORyA9IC0xOwoKCUNPTVBBUkVfREVTQ0VORElORyA9IDE7CgoJS0VZU19QVUJMSVNIID0gWydkZXN0cm95JywgJ3NoYXJlT3B0aW9ucycsICdmaWx0ZXJzJywgJ2NvbXBhcmF0b3InLCAnc29ydEF0dHJpYnV0ZScsICd2aWV3TW9kZWxCeU1vZGVsJywgJ2hhc1ZpZXdNb2RlbHMnXTsKCglrYi5jb21wYXJlID0gZnVuY3Rpb24odmFsdWVfYSwgdmFsdWVfYikgewoJICBpZiAoXy5pc1N0cmluZyh2YWx1ZV9hKSkgewoJICAgIHJldHVybiB2YWx1ZV9hLmxvY2FsZUNvbXBhcmUoIiIgKyB2YWx1ZV9iKTsKCSAgfQoJICBpZiAoXy5pc1N0cmluZyh2YWx1ZV9iKSkgewoJICAgIHJldHVybiB2YWx1ZV9iLmxvY2FsZUNvbXBhcmUoIiIgKyB2YWx1ZV9hKTsKCSAgfQoJICBpZiAodmFsdWVfYSA9PT0gdmFsdWVfYikgewoJICAgIHJldHVybiBDT01QQVJFX0VRVUFMOwoJICB9IGVsc2UgewoJICAgIGlmICh2YWx1ZV9hIDwgdmFsdWVfYikgewoJICAgICAgcmV0dXJuIENPTVBBUkVfQVNDRU5ESU5HOwoJICAgIH0gZWxzZSB7CgkgICAgICByZXR1cm4gQ09NUEFSRV9ERVNDRU5ESU5HOwoJICAgIH0KCSAgfQoJfTsKCglrYi5Db2xsZWN0aW9uT2JzZXJ2YWJsZSA9IChmdW5jdGlvbigpIHsKCSAgQ29sbGVjdGlvbk9ic2VydmFibGUuZXh0ZW5kID0ga2IuZXh0ZW5kOwoKCSAgZnVuY3Rpb24gQ29sbGVjdGlvbk9ic2VydmFibGUoY29sbGVjdGlvbiwgdmlld19tb2RlbCwgb3B0aW9ucykgewoJICAgIHRoaXMuX29uQ29sbGVjdGlvbkNoYW5nZSA9IF9fYmluZCh0aGlzLl9vbkNvbGxlY3Rpb25DaGFuZ2UsIHRoaXMpOwoJICAgIHZhciBhcmdzOwoJICAgIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChfLmlzQXJndW1lbnRzKGNvbGxlY3Rpb24pID8gY29sbGVjdGlvbiA6IGFyZ3VtZW50cyk7CgkgICAgcmV0dXJuIGtiLmlnbm9yZSgoZnVuY3Rpb24oX3RoaXMpIHsKCSAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKCSAgICAgICAgdmFyIGFyZywgY3JlYXRlX29wdGlvbnMsIG9ic2VydmFibGUsIF9pLCBfbGVuOwoJICAgICAgICBjb2xsZWN0aW9uID0gYXJnc1swXSBpbnN0YW5jZW9mIGtiLkNvbGxlY3Rpb24gPyBhcmdzLnNoaWZ0KCkgOiAoXy5pc0FycmF5KGFyZ3NbMF0pID8gbmV3IGtiLkNvbGxlY3Rpb24oYXJncy5zaGlmdCgpKSA6IG5ldyBrYi5Db2xsZWN0aW9uKCkpOwoJICAgICAgICBpZiAoXy5pc0Z1bmN0aW9uKGFyZ3NbMF0pKSB7CgkgICAgICAgICAgYXJnc1swXSA9IHsKCSAgICAgICAgICAgIHZpZXdfbW9kZWw6IGFyZ3NbMF0KCSAgICAgICAgICB9OwoJICAgICAgICB9CgkgICAgICAgIG9wdGlvbnMgPSB7fTsKCSAgICAgICAgZm9yIChfaSA9IDAsIF9sZW4gPSBhcmdzLmxlbmd0aDsgX2kgPCBfbGVuOyBfaSsrKSB7CgkgICAgICAgICAgYXJnID0gYXJnc1tfaV07CgkgICAgICAgICAgXy5leHRlbmQob3B0aW9ucywgYXJnKTsKCSAgICAgICAgfQoJICAgICAgICBvYnNlcnZhYmxlID0ga2IudXRpbHMud3JhcHBlZE9ic2VydmFibGUoX3RoaXMsIGtvLm9ic2VydmFibGVBcnJheShbXSkpOwoJICAgICAgICBvYnNlcnZhYmxlLl9fa2JfaXNfY28gPSB0cnVlOwoJICAgICAgICBfdGhpcy5pbl9lZGl0ID0gMDsKCSAgICAgICAgX3RoaXMuX19rYiB8fCAoX3RoaXMuX19rYiA9IHt9KTsKCSAgICAgICAgb3B0aW9ucyA9IGtiLnV0aWxzLmNvbGxhcHNlT3B0aW9ucyhvcHRpb25zKTsKCSAgICAgICAgaWYgKG9wdGlvbnMuYXV0b19jb21wYWN0KSB7CgkgICAgICAgICAgX3RoaXMuYXV0b19jb21wYWN0ID0gdHJ1ZTsKCSAgICAgICAgfQoJICAgICAgICBpZiAob3B0aW9ucy5zb3J0X2F0dHJpYnV0ZSkgewoJICAgICAgICAgIF90aGlzLl9jb21wYXJhdG9yID0ga28ub2JzZXJ2YWJsZShfdGhpcy5fYXR0cmlidXRlQ29tcGFyYXRvcihvcHRpb25zLnNvcnRfYXR0cmlidXRlKSk7CgkgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgX3RoaXMuX2NvbXBhcmF0b3IgPSBrby5vYnNlcnZhYmxlKG9wdGlvbnMuY29tcGFyYXRvcik7CgkgICAgICAgIH0KCSAgICAgICAgaWYgKG9wdGlvbnMuZmlsdGVycykgewoJICAgICAgICAgIF90aGlzLl9maWx0ZXJzID0ga28ub2JzZXJ2YWJsZUFycmF5KF8uaXNBcnJheShvcHRpb25zLmZpbHRlcnMpID8gb3B0aW9ucy5maWx0ZXJzIDogb3B0aW9ucy5maWx0ZXJzID8gW29wdGlvbnMuZmlsdGVyc10gOiB2b2lkIDApOwoJICAgICAgICB9IGVsc2UgewoJICAgICAgICAgIF90aGlzLl9maWx0ZXJzID0ga28ub2JzZXJ2YWJsZUFycmF5KFtdKTsKCSAgICAgICAgfQoJICAgICAgICBjcmVhdGVfb3B0aW9ucyA9IF90aGlzLmNyZWF0ZV9vcHRpb25zID0gewoJICAgICAgICAgIHN0b3JlOiBrYi5TdG9yZS51c2VPcHRpb25zT3JDcmVhdGUob3B0aW9ucywgY29sbGVjdGlvbiwgb2JzZXJ2YWJsZSkKCSAgICAgICAgfTsKCSAgICAgICAga2IudXRpbHMud3JhcHBlZE9iamVjdChvYnNlcnZhYmxlLCBjb2xsZWN0aW9uKTsKCSAgICAgICAgX3RoaXMucGF0aCA9IG9wdGlvbnMucGF0aDsKCSAgICAgICAgY3JlYXRlX29wdGlvbnMuZmFjdG9yeSA9IGtiLnV0aWxzLndyYXBwZWRGYWN0b3J5KG9ic2VydmFibGUsIF90aGlzLl9zaGFyZU9yQ3JlYXRlRmFjdG9yeShvcHRpb25zKSk7CgkgICAgICAgIGNyZWF0ZV9vcHRpb25zLnBhdGggPSBrYi51dGlscy5wYXRoSm9pbihvcHRpb25zLnBhdGgsICdtb2RlbHMnKTsKCSAgICAgICAgY3JlYXRlX29wdGlvbnMuY3JlYXRvciA9IGNyZWF0ZV9vcHRpb25zLmZhY3RvcnkuY3JlYXRvckZvclBhdGgobnVsbCwgY3JlYXRlX29wdGlvbnMucGF0aCk7CgkgICAgICAgIGlmIChjcmVhdGVfb3B0aW9ucy5jcmVhdG9yKSB7CgkgICAgICAgICAgX3RoaXMubW9kZWxzX29ubHkgPSBjcmVhdGVfb3B0aW9ucy5jcmVhdG9yLm1vZGVsc19vbmx5OwoJICAgICAgICB9CgkgICAgICAgIGtiLnB1Ymxpc2hNZXRob2RzKG9ic2VydmFibGUsIF90aGlzLCBLRVlTX1BVQkxJU0gpOwoJICAgICAgICBfdGhpcy5fY29sbGVjdGlvbiA9IGtvLm9ic2VydmFibGUoY29sbGVjdGlvbik7CgkgICAgICAgIG9ic2VydmFibGUuY29sbGVjdGlvbiA9IF90aGlzLmNvbGxlY3Rpb24gPSBrby5jb21wdXRlZCh7CgkgICAgICAgICAgcmVhZDogZnVuY3Rpb24oKSB7CgkgICAgICAgICAgICByZXR1cm4gX3RoaXMuX2NvbGxlY3Rpb24oKTsKCSAgICAgICAgICB9LAoJICAgICAgICAgIHdyaXRlOiBmdW5jdGlvbihuZXdfY29sbGVjdGlvbikgewoJICAgICAgICAgICAgcmV0dXJuIGtiLmlnbm9yZShmdW5jdGlvbigpIHsKCSAgICAgICAgICAgICAgdmFyIHByZXZpb3VzX2NvbGxlY3Rpb247CgkgICAgICAgICAgICAgIGlmICgocHJldmlvdXNfY29sbGVjdGlvbiA9IF90aGlzLl9jb2xsZWN0aW9uKCkpID09PSBuZXdfY29sbGVjdGlvbikgewoJICAgICAgICAgICAgICAgIHJldHVybjsKCSAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICBrYi51dGlscy53cmFwcGVkT2JqZWN0KG9ic2VydmFibGUsIG5ld19jb2xsZWN0aW9uKTsKCSAgICAgICAgICAgICAgaWYgKHByZXZpb3VzX2NvbGxlY3Rpb24pIHsKCSAgICAgICAgICAgICAgICBwcmV2aW91c19jb2xsZWN0aW9uLnVuYmluZCgnYWxsJywgX3RoaXMuX29uQ29sbGVjdGlvbkNoYW5nZSk7CgkgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgaWYgKG5ld19jb2xsZWN0aW9uKSB7CgkgICAgICAgICAgICAgICAgbmV3X2NvbGxlY3Rpb24uYmluZCgnYWxsJywgX3RoaXMuX29uQ29sbGVjdGlvbkNoYW5nZSk7CgkgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgcmV0dXJuIF90aGlzLl9jb2xsZWN0aW9uKG5ld19jb2xsZWN0aW9uKTsKCSAgICAgICAgICAgIH0pOwoJICAgICAgICAgIH0KCSAgICAgICAgfSk7CgkgICAgICAgIGlmIChjb2xsZWN0aW9uKSB7CgkgICAgICAgICAgY29sbGVjdGlvbi5iaW5kKCdhbGwnLCBfdGhpcy5fb25Db2xsZWN0aW9uQ2hhbmdlKTsKCSAgICAgICAgfQoJICAgICAgICBfdGhpcy5fbWFwcGVyID0ga28uY29tcHV0ZWQoZnVuY3Rpb24oKSB7CgkgICAgICAgICAgdmFyIGNvbXBhcmF0b3IsIGN1cnJlbnRfY29sbGVjdGlvbiwgZmlsdGVyLCBmaWx0ZXJzLCBtb2RlbHMsIHByZXZpb3VzX3ZpZXdfbW9kZWxzLCB2aWV3X21vZGVscywgX2osIF9sZW4xOwoJICAgICAgICAgIGNvbXBhcmF0b3IgPSBfdGhpcy5fY29tcGFyYXRvcigpOwoJICAgICAgICAgIGZpbHRlcnMgPSBfdGhpcy5fZmlsdGVycygpOwoJICAgICAgICAgIGlmIChmaWx0ZXJzKSB7CgkgICAgICAgICAgICBmb3IgKF9qID0gMCwgX2xlbjEgPSBmaWx0ZXJzLmxlbmd0aDsgX2ogPCBfbGVuMTsgX2orKykgewoJICAgICAgICAgICAgICBmaWx0ZXIgPSBmaWx0ZXJzW19qXTsKCSAgICAgICAgICAgICAga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZShmaWx0ZXIpOwoJICAgICAgICAgICAgfQoJICAgICAgICAgIH0KCSAgICAgICAgICBjdXJyZW50X2NvbGxlY3Rpb24gPSBfdGhpcy5fY29sbGVjdGlvbigpOwoJICAgICAgICAgIGlmIChfdGhpcy5pbl9lZGl0KSB7CgkgICAgICAgICAgICByZXR1cm47CgkgICAgICAgICAgfQoJICAgICAgICAgIG9ic2VydmFibGUgPSBrYi51dGlscy53cmFwcGVkT2JzZXJ2YWJsZShfdGhpcyk7CgkgICAgICAgICAgcHJldmlvdXNfdmlld19tb2RlbHMgPSBrYi5wZWVrKG9ic2VydmFibGUpOwoJICAgICAgICAgIGlmIChjdXJyZW50X2NvbGxlY3Rpb24pIHsKCSAgICAgICAgICAgIG1vZGVscyA9IGN1cnJlbnRfY29sbGVjdGlvbi5tb2RlbHM7CgkgICAgICAgICAgfQoJICAgICAgICAgIGlmICghbW9kZWxzIHx8IChjdXJyZW50X2NvbGxlY3Rpb24ubW9kZWxzLmxlbmd0aCA9PT0gMCkpIHsKCSAgICAgICAgICAgIHZpZXdfbW9kZWxzID0gW107CgkgICAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgIG1vZGVscyA9IF8uZmlsdGVyKG1vZGVscywgZnVuY3Rpb24obW9kZWwpIHsKCSAgICAgICAgICAgICAgcmV0dXJuICFmaWx0ZXJzLmxlbmd0aCB8fCBfdGhpcy5fc2VsZWN0TW9kZWwobW9kZWwpOwoJICAgICAgICAgICAgfSk7CgkgICAgICAgICAgICBpZiAoY29tcGFyYXRvcikgewoJICAgICAgICAgICAgICB2aWV3X21vZGVscyA9IF8ubWFwKG1vZGVscywgZnVuY3Rpb24obW9kZWwpIHsKCSAgICAgICAgICAgICAgICByZXR1cm4gX3RoaXMuX2NyZWF0ZVZpZXdNb2RlbChtb2RlbCk7CgkgICAgICAgICAgICAgIH0pLnNvcnQoY29tcGFyYXRvcik7CgkgICAgICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgICBpZiAoX3RoaXMubW9kZWxzX29ubHkpIHsKCSAgICAgICAgICAgICAgICB2aWV3X21vZGVscyA9IGZpbHRlcnMubGVuZ3RoID8gbW9kZWxzIDogbW9kZWxzLnNsaWNlKCk7CgkgICAgICAgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICAgICAgdmlld19tb2RlbHMgPSBfLm1hcChtb2RlbHMsIGZ1bmN0aW9uKG1vZGVsKSB7CgkgICAgICAgICAgICAgICAgICByZXR1cm4gX3RoaXMuX2NyZWF0ZVZpZXdNb2RlbChtb2RlbCk7CgkgICAgICAgICAgICAgICAgfSk7CgkgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgIH0KCSAgICAgICAgICB9CgkgICAgICAgICAgX3RoaXMuaW5fZWRpdCsrOwoJICAgICAgICAgIG9ic2VydmFibGUodmlld19tb2RlbHMpOwoJICAgICAgICAgIF90aGlzLmluX2VkaXQtLTsKCSAgICAgICAgfSk7CgkgICAgICAgIG9ic2VydmFibGUuc3Vic2NyaWJlKF8uYmluZChfdGhpcy5fb25PYnNlcnZhYmxlQXJyYXlDaGFuZ2UsIF90aGlzKSk7CgkgICAgICAgICFrYi5zdGF0aXN0aWNzIHx8IGtiLnN0YXRpc3RpY3MucmVnaXN0ZXIoJ0NvbGxlY3Rpb25PYnNlcnZhYmxlJywgX3RoaXMpOwoJICAgICAgICByZXR1cm4gb2JzZXJ2YWJsZTsKCSAgICAgIH07CgkgICAgfSkodGhpcykpOwoJICB9CgoJICBDb2xsZWN0aW9uT2JzZXJ2YWJsZS5wcm90b3R5cGUuZGVzdHJveSA9IGZ1bmN0aW9uKCkgewoJICAgIHZhciBhcnJheSwgY29sbGVjdGlvbiwgb2JzZXJ2YWJsZTsKCSAgICB0aGlzLl9fa2JfcmVsZWFzZWQgPSB0cnVlOwoJICAgIG9ic2VydmFibGUgPSBrYi51dGlscy53cmFwcGVkT2JzZXJ2YWJsZSh0aGlzKTsKCSAgICBjb2xsZWN0aW9uID0ga2IucGVlayh0aGlzLl9jb2xsZWN0aW9uKTsKCSAgICBrYi51dGlscy53cmFwcGVkT2JqZWN0KG9ic2VydmFibGUsIG51bGwpOwoJICAgIGlmIChjb2xsZWN0aW9uKSB7CgkgICAgICBjb2xsZWN0aW9uLnVuYmluZCgnYWxsJywgdGhpcy5fb25Db2xsZWN0aW9uQ2hhbmdlKTsKCSAgICAgIGFycmF5ID0ga2IucGVlayhvYnNlcnZhYmxlKTsKCSAgICAgIGFycmF5LnNwbGljZSgwLCBhcnJheS5sZW5ndGgpOwoJICAgIH0KCSAgICB0aGlzLmNvbGxlY3Rpb24uZGlzcG9zZSgpOwoJICAgIHRoaXMuX2NvbGxlY3Rpb24gPSBvYnNlcnZhYmxlLmNvbGxlY3Rpb24gPSB0aGlzLmNvbGxlY3Rpb24gPSBudWxsOwoJICAgIHRoaXMuX21hcHBlci5kaXNwb3NlKCk7CgkgICAgdGhpcy5fbWFwcGVyID0gbnVsbDsKCSAgICBrYi5yZWxlYXNlKHRoaXMuX2ZpbHRlcnMpOwoJICAgIHRoaXMuX2ZpbHRlcnMgPSBudWxsOwoJICAgIHRoaXMuX2NvbXBhcmF0b3IobnVsbCk7CgkgICAgdGhpcy5fY29tcGFyYXRvciA9IG51bGw7CgkgICAgdGhpcy5jcmVhdGVfb3B0aW9ucyA9IG51bGw7CgkgICAgb2JzZXJ2YWJsZS5jb2xsZWN0aW9uID0gbnVsbDsKCSAgICBrYi51dGlscy53cmFwcGVkRGVzdHJveSh0aGlzKTsKCSAgICByZXR1cm4gIWtiLnN0YXRpc3RpY3MgfHwga2Iuc3RhdGlzdGljcy51bnJlZ2lzdGVyKCdDb2xsZWN0aW9uT2JzZXJ2YWJsZScsIHRoaXMpOwoJICB9OwoKCSAgQ29sbGVjdGlvbk9ic2VydmFibGUucHJvdG90eXBlLnNoYXJlT3B0aW9ucyA9IGZ1bmN0aW9uKCkgewoJICAgIHZhciBvYnNlcnZhYmxlOwoJICAgIG9ic2VydmFibGUgPSBrYi51dGlscy53cmFwcGVkT2JzZXJ2YWJsZSh0aGlzKTsKCSAgICByZXR1cm4gewoJICAgICAgc3RvcmU6IGtiLnV0aWxzLndyYXBwZWRTdG9yZShvYnNlcnZhYmxlKSwKCSAgICAgIGZhY3Rvcnk6IGtiLnV0aWxzLndyYXBwZWRGYWN0b3J5KG9ic2VydmFibGUpCgkgICAgfTsKCSAgfTsKCgkgIENvbGxlY3Rpb25PYnNlcnZhYmxlLnByb3RvdHlwZS5maWx0ZXJzID0gZnVuY3Rpb24oZmlsdGVycykgewoJICAgIGlmIChmaWx0ZXJzKSB7CgkgICAgICByZXR1cm4gdGhpcy5fZmlsdGVycyhfLmlzQXJyYXkoZmlsdGVycykgPyBmaWx0ZXJzIDogW2ZpbHRlcnNdKTsKCSAgICB9IGVsc2UgewoJICAgICAgcmV0dXJuIHRoaXMuX2ZpbHRlcnMoW10pOwoJICAgIH0KCSAgfTsKCgkgIENvbGxlY3Rpb25PYnNlcnZhYmxlLnByb3RvdHlwZS5jb21wYXJhdG9yID0gZnVuY3Rpb24oY29tcGFyYXRvcikgewoJICAgIHJldHVybiB0aGlzLl9jb21wYXJhdG9yKGNvbXBhcmF0b3IpOwoJICB9OwoKCSAgQ29sbGVjdGlvbk9ic2VydmFibGUucHJvdG90eXBlLnNvcnRBdHRyaWJ1dGUgPSBmdW5jdGlvbihzb3J0X2F0dHJpYnV0ZSkgewoJICAgIHJldHVybiB0aGlzLl9jb21wYXJhdG9yKHNvcnRfYXR0cmlidXRlID8gdGhpcy5fYXR0cmlidXRlQ29tcGFyYXRvcihzb3J0X2F0dHJpYnV0ZSkgOiBudWxsKTsKCSAgfTsKCgkgIENvbGxlY3Rpb25PYnNlcnZhYmxlLnByb3RvdHlwZS52aWV3TW9kZWxCeU1vZGVsID0gZnVuY3Rpb24obW9kZWwpIHsKCSAgICB2YXIgaWRfYXR0cmlidXRlOwoJICAgIGlmICh0aGlzLm1vZGVsc19vbmx5KSB7CgkgICAgICByZXR1cm4gbnVsbDsKCSAgICB9CgkgICAgaWRfYXR0cmlidXRlID0gbW9kZWwuaGFzT3duUHJvcGVydHkobW9kZWwuaWRBdHRyaWJ1dGUpID8gbW9kZWwuaWRBdHRyaWJ1dGUgOiAnY2lkJzsKCSAgICByZXR1cm4gXy5maW5kKGtiLnBlZWsoa2IudXRpbHMud3JhcHBlZE9ic2VydmFibGUodGhpcykpLCBmdW5jdGlvbih0ZXN0KSB7CgkgICAgICB2YXIgX3JlZjE7CgkgICAgICBpZiAodGVzdCAhPSBudWxsID8gKF9yZWYxID0gdGVzdC5fX2tiKSAhPSBudWxsID8gX3JlZjEub2JqZWN0IDogdm9pZCAwIDogdm9pZCAwKSB7CgkgICAgICAgIHJldHVybiB0ZXN0Ll9fa2Iub2JqZWN0W2lkX2F0dHJpYnV0ZV0gPT09IG1vZGVsW2lkX2F0dHJpYnV0ZV07CgkgICAgICB9IGVsc2UgewoJICAgICAgICByZXR1cm4gZmFsc2U7CgkgICAgICB9CgkgICAgfSk7CgkgIH07CgoJICBDb2xsZWN0aW9uT2JzZXJ2YWJsZS5wcm90b3R5cGUuaGFzVmlld01vZGVscyA9IGZ1bmN0aW9uKCkgewoJICAgIHJldHVybiAhdGhpcy5tb2RlbHNfb25seTsKCSAgfTsKCgkgIENvbGxlY3Rpb25PYnNlcnZhYmxlLnByb3RvdHlwZS5jb21wYWN0ID0gZnVuY3Rpb24oKSB7CgkgICAgcmV0dXJuIGtiLmlnbm9yZSgoZnVuY3Rpb24oX3RoaXMpIHsKCSAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKCSAgICAgICAgdmFyIG9ic2VydmFibGU7CgkgICAgICAgIG9ic2VydmFibGUgPSBrYi51dGlscy53cmFwcGVkT2JzZXJ2YWJsZShfdGhpcyk7CgkgICAgICAgIGlmICgha2IudXRpbHMud3JhcHBlZFN0b3JlSXNPd25lZChvYnNlcnZhYmxlKSkgewoJICAgICAgICAgIHJldHVybjsKCSAgICAgICAgfQoJICAgICAgICBrYi51dGlscy53cmFwcGVkU3RvcmUob2JzZXJ2YWJsZSkuY2xlYXIoKTsKCSAgICAgICAgcmV0dXJuIF90aGlzLl9jb2xsZWN0aW9uLm5vdGlmeVN1YnNjcmliZXJzKF90aGlzLl9jb2xsZWN0aW9uKCkpOwoJICAgICAgfTsKCSAgICB9KSh0aGlzKSk7CgkgIH07CgoJICBDb2xsZWN0aW9uT2JzZXJ2YWJsZS5wcm90b3R5cGUuX3NoYXJlT3JDcmVhdGVGYWN0b3J5ID0gZnVuY3Rpb24ob3B0aW9ucykgewoJICAgIHZhciBhYnNvbHV0ZV9tb2RlbHNfcGF0aCwgZXhpc3RpbmdfY3JlYXRvciwgZmFjdG9yaWVzLCBmYWN0b3J5OwoJICAgIGFic29sdXRlX21vZGVsc19wYXRoID0ga2IudXRpbHMucGF0aEpvaW4ob3B0aW9ucy5wYXRoLCAnbW9kZWxzJyk7CgkgICAgZmFjdG9yaWVzID0gb3B0aW9ucy5mYWN0b3JpZXM7CgkgICAgaWYgKChmYWN0b3J5ID0gb3B0aW9ucy5mYWN0b3J5KSkgewoJICAgICAgaWYgKChleGlzdGluZ19jcmVhdG9yID0gZmFjdG9yeS5jcmVhdG9yRm9yUGF0aChudWxsLCBhYnNvbHV0ZV9tb2RlbHNfcGF0aCkpICYmICghZmFjdG9yaWVzIHx8IChmYWN0b3JpZXNbJ21vZGVscyddID09PSBleGlzdGluZ19jcmVhdG9yKSkpIHsKCSAgICAgICAgaWYgKCFmYWN0b3JpZXMpIHsKCSAgICAgICAgICByZXR1cm4gZmFjdG9yeTsKCSAgICAgICAgfQoJICAgICAgICBpZiAoZmFjdG9yeS5oYXNQYXRoTWFwcGluZ3MoZmFjdG9yaWVzLCBvcHRpb25zLnBhdGgpKSB7CgkgICAgICAgICAgcmV0dXJuIGZhY3Rvcnk7CgkgICAgICAgIH0KCSAgICAgIH0KCSAgICB9CgkgICAgZmFjdG9yeSA9IG5ldyBrYi5GYWN0b3J5KG9wdGlvbnMuZmFjdG9yeSk7CgkgICAgaWYgKGZhY3RvcmllcykgewoJICAgICAgZmFjdG9yeS5hZGRQYXRoTWFwcGluZ3MoZmFjdG9yaWVzLCBvcHRpb25zLnBhdGgpOwoJICAgIH0KCSAgICBpZiAoIWZhY3RvcnkuY3JlYXRvckZvclBhdGgobnVsbCwgYWJzb2x1dGVfbW9kZWxzX3BhdGgpKSB7CgkgICAgICBpZiAob3B0aW9ucy5oYXNPd25Qcm9wZXJ0eSgnbW9kZWxzX29ubHknKSkgewoJICAgICAgICBpZiAob3B0aW9ucy5tb2RlbHNfb25seSkgewoJICAgICAgICAgIGZhY3RvcnkuYWRkUGF0aE1hcHBpbmcoYWJzb2x1dGVfbW9kZWxzX3BhdGgsIHsKCSAgICAgICAgICAgIG1vZGVsc19vbmx5OiB0cnVlCgkgICAgICAgICAgfSk7CgkgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgZmFjdG9yeS5hZGRQYXRoTWFwcGluZyhhYnNvbHV0ZV9tb2RlbHNfcGF0aCwga2IuVmlld01vZGVsKTsKCSAgICAgICAgfQoJICAgICAgfSBlbHNlIGlmIChvcHRpb25zLnZpZXdfbW9kZWwpIHsKCSAgICAgICAgZmFjdG9yeS5hZGRQYXRoTWFwcGluZyhhYnNvbHV0ZV9tb2RlbHNfcGF0aCwgb3B0aW9ucy52aWV3X21vZGVsKTsKCSAgICAgIH0gZWxzZSBpZiAob3B0aW9ucy5jcmVhdGUpIHsKCSAgICAgICAgZmFjdG9yeS5hZGRQYXRoTWFwcGluZyhhYnNvbHV0ZV9tb2RlbHNfcGF0aCwgewoJICAgICAgICAgIGNyZWF0ZTogb3B0aW9ucy5jcmVhdGUKCSAgICAgICAgfSk7CgkgICAgICB9IGVsc2UgewoJICAgICAgICBmYWN0b3J5LmFkZFBhdGhNYXBwaW5nKGFic29sdXRlX21vZGVsc19wYXRoLCBrYi5WaWV3TW9kZWwpOwoJICAgICAgfQoJICAgIH0KCSAgICByZXR1cm4gZmFjdG9yeTsKCSAgfTsKCgkgIENvbGxlY3Rpb25PYnNlcnZhYmxlLnByb3RvdHlwZS5fb25Db2xsZWN0aW9uQ2hhbmdlID0gZnVuY3Rpb24oZXZlbnQsIGFyZykgewoJICAgIHJldHVybiBrYi5pZ25vcmUoKGZ1bmN0aW9uKF90aGlzKSB7CgkgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CgkgICAgICAgIHZhciBjb2xsZWN0aW9uLCBjb21wYXJhdG9yLCBvYnNlcnZhYmxlLCB2aWV3X21vZGVsOwoJICAgICAgICBpZiAoX3RoaXMuaW5fZWRpdCkgewoJICAgICAgICAgIHJldHVybjsKCSAgICAgICAgfQoJICAgICAgICBzd2l0Y2ggKGV2ZW50KSB7CgkgICAgICAgICAgY2FzZSAncmVzZXQnOgoJICAgICAgICAgICAgaWYgKF90aGlzLmF1dG9fY29tcGFjdCkgewoJICAgICAgICAgICAgICBfdGhpcy5jb21wYWN0KCk7CgkgICAgICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgICBfdGhpcy5fY29sbGVjdGlvbi5ub3RpZnlTdWJzY3JpYmVycyhfdGhpcy5fY29sbGVjdGlvbigpKTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIGJyZWFrOwoJICAgICAgICAgIGNhc2UgJ3NvcnQnOgoJICAgICAgICAgIGNhc2UgJ3Jlc29ydCc6CgkgICAgICAgICAgICBfdGhpcy5fY29sbGVjdGlvbi5ub3RpZnlTdWJzY3JpYmVycyhfdGhpcy5fY29sbGVjdGlvbigpKTsKCSAgICAgICAgICAgIGJyZWFrOwoJICAgICAgICAgIGNhc2UgJ25ldyc6CgkgICAgICAgICAgY2FzZSAnYWRkJzoKCSAgICAgICAgICAgIGlmICghX3RoaXMuX3NlbGVjdE1vZGVsKGFyZykpIHsKCSAgICAgICAgICAgICAgcmV0dXJuOwoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgb2JzZXJ2YWJsZSA9IGtiLnV0aWxzLndyYXBwZWRPYnNlcnZhYmxlKF90aGlzKTsKCSAgICAgICAgICAgIGNvbGxlY3Rpb24gPSBfdGhpcy5fY29sbGVjdGlvbigpOwoJICAgICAgICAgICAgaWYgKGNvbGxlY3Rpb24uaW5kZXhPZihhcmcpID09PSAtMSkgewoJICAgICAgICAgICAgICByZXR1cm47CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICBpZiAoKHZpZXdfbW9kZWwgPSBfdGhpcy52aWV3TW9kZWxCeU1vZGVsKGFyZykpKSB7CgkgICAgICAgICAgICAgIHJldHVybjsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIF90aGlzLmluX2VkaXQrKzsKCSAgICAgICAgICAgIGlmICgoY29tcGFyYXRvciA9IF90aGlzLl9jb21wYXJhdG9yKCkpKSB7CgkgICAgICAgICAgICAgIG9ic2VydmFibGUoKS5wdXNoKF90aGlzLl9jcmVhdGVWaWV3TW9kZWwoYXJnKSk7CgkgICAgICAgICAgICAgIG9ic2VydmFibGUuc29ydChjb21wYXJhdG9yKTsKCSAgICAgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICAgIG9ic2VydmFibGUuc3BsaWNlKGNvbGxlY3Rpb24uaW5kZXhPZihhcmcpLCAwLCBfdGhpcy5fY3JlYXRlVmlld01vZGVsKGFyZykpOwoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgX3RoaXMuaW5fZWRpdC0tOwoJICAgICAgICAgICAgYnJlYWs7CgkgICAgICAgICAgY2FzZSAncmVtb3ZlJzoKCSAgICAgICAgICBjYXNlICdkZXN0cm95JzoKCSAgICAgICAgICAgIF90aGlzLl9vbk1vZGVsUmVtb3ZlKGFyZyk7CgkgICAgICAgICAgICBicmVhazsKCSAgICAgICAgICBjYXNlICdjaGFuZ2UnOgoJICAgICAgICAgICAgaWYgKCFfdGhpcy5fc2VsZWN0TW9kZWwoYXJnKSkgewoJICAgICAgICAgICAgICByZXR1cm4gX3RoaXMuX29uTW9kZWxSZW1vdmUoYXJnKTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIHZpZXdfbW9kZWwgPSBfdGhpcy5tb2RlbHNfb25seSA/IGFyZyA6IF90aGlzLnZpZXdNb2RlbEJ5TW9kZWwoYXJnKTsKCSAgICAgICAgICAgIGlmICghdmlld19tb2RlbCkgewoJICAgICAgICAgICAgICByZXR1cm4gX3RoaXMuX29uQ29sbGVjdGlvbkNoYW5nZSgnYWRkJywgYXJnKTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIGlmICghKGNvbXBhcmF0b3IgPSBfdGhpcy5fY29tcGFyYXRvcigpKSkgewoJICAgICAgICAgICAgICByZXR1cm47CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICBfdGhpcy5pbl9lZGl0Kys7CgkgICAgICAgICAgICBrYi51dGlscy53cmFwcGVkT2JzZXJ2YWJsZShfdGhpcykuc29ydChjb21wYXJhdG9yKTsKCSAgICAgICAgICAgIF90aGlzLmluX2VkaXQtLTsKCSAgICAgICAgfQoJICAgICAgfTsKCSAgICB9KSh0aGlzKSk7CgkgIH07CgoJICBDb2xsZWN0aW9uT2JzZXJ2YWJsZS5wcm90b3R5cGUuX29uTW9kZWxSZW1vdmUgPSBmdW5jdGlvbihtb2RlbCkgewoJICAgIHZhciBvYnNlcnZhYmxlLCB2aWV3X21vZGVsOwoJICAgIHZpZXdfbW9kZWwgPSB0aGlzLm1vZGVsc19vbmx5ID8gbW9kZWwgOiB0aGlzLnZpZXdNb2RlbEJ5TW9kZWwobW9kZWwpOwoJICAgIGlmICghdmlld19tb2RlbCkgewoJICAgICAgcmV0dXJuOwoJICAgIH0KCSAgICBvYnNlcnZhYmxlID0ga2IudXRpbHMud3JhcHBlZE9ic2VydmFibGUodGhpcyk7CgkgICAgdGhpcy5pbl9lZGl0Kys7CgkgICAgb2JzZXJ2YWJsZS5yZW1vdmUodmlld19tb2RlbCk7CgkgICAgcmV0dXJuIHRoaXMuaW5fZWRpdC0tOwoJICB9OwoKCSAgQ29sbGVjdGlvbk9ic2VydmFibGUucHJvdG90eXBlLl9vbk9ic2VydmFibGVBcnJheUNoYW5nZSA9IGZ1bmN0aW9uKG1vZGVsc19vcl92aWV3X21vZGVscykgewoJICAgIHJldHVybiBrYi5pZ25vcmUoKGZ1bmN0aW9uKF90aGlzKSB7CgkgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CgkgICAgICAgIHZhciBjb2xsZWN0aW9uLCBjdXJyZW50X3ZpZXdfbW9kZWwsIGhhc19maWx0ZXJzLCBtb2RlbCwgbW9kZWxzLCBvYnNlcnZhYmxlLCB2aWV3X21vZGVsLCB2aWV3X21vZGVscywgX2ksIF9sZW47CgkgICAgICAgIGlmIChfdGhpcy5pbl9lZGl0KSB7CgkgICAgICAgICAgcmV0dXJuOwoJICAgICAgICB9CgkgICAgICAgIChfdGhpcy5tb2RlbHNfb25seSAmJiAoIW1vZGVsc19vcl92aWV3X21vZGVscy5sZW5ndGggfHwga2IuaXNNb2RlbChtb2RlbHNfb3Jfdmlld19tb2RlbHNbMF0pKSkgfHwgKCFfdGhpcy5tb2RlbHNfb25seSAmJiAoIW1vZGVsc19vcl92aWV3X21vZGVscy5sZW5ndGggfHwgKF8uaXNPYmplY3QobW9kZWxzX29yX3ZpZXdfbW9kZWxzWzBdKSAmJiAha2IuaXNNb2RlbChtb2RlbHNfb3Jfdmlld19tb2RlbHNbMF0pKSkpIHx8IGtiLl90aHJvd1VuZXhwZWN0ZWQoX3RoaXMsICdpbmNvcnJlY3QgdHlwZSBwYXNzZWQnKTsKCSAgICAgICAgb2JzZXJ2YWJsZSA9IGtiLnV0aWxzLndyYXBwZWRPYnNlcnZhYmxlKF90aGlzKTsKCSAgICAgICAgY29sbGVjdGlvbiA9IGtiLnBlZWsoX3RoaXMuX2NvbGxlY3Rpb24pOwoJICAgICAgICBoYXNfZmlsdGVycyA9IGtiLnBlZWsoX3RoaXMuX2ZpbHRlcnMpLmxlbmd0aDsKCSAgICAgICAgaWYgKCFjb2xsZWN0aW9uKSB7CgkgICAgICAgICAgcmV0dXJuOwoJICAgICAgICB9CgkgICAgICAgIHZpZXdfbW9kZWxzID0gbW9kZWxzX29yX3ZpZXdfbW9kZWxzOwoJICAgICAgICBpZiAoX3RoaXMubW9kZWxzX29ubHkpIHsKCSAgICAgICAgICBtb2RlbHMgPSBfLmZpbHRlcihtb2RlbHNfb3Jfdmlld19tb2RlbHMsIGZ1bmN0aW9uKG1vZGVsKSB7CgkgICAgICAgICAgICByZXR1cm4gIWhhc19maWx0ZXJzIHx8IF90aGlzLl9zZWxlY3RNb2RlbChtb2RlbCk7CgkgICAgICAgICAgfSk7CgkgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgIWhhc19maWx0ZXJzIHx8ICh2aWV3X21vZGVscyA9IFtdKTsKCSAgICAgICAgICBtb2RlbHMgPSBbXTsKCSAgICAgICAgICBmb3IgKF9pID0gMCwgX2xlbiA9IG1vZGVsc19vcl92aWV3X21vZGVscy5sZW5ndGg7IF9pIDwgX2xlbjsgX2krKykgewoJICAgICAgICAgICAgdmlld19tb2RlbCA9IG1vZGVsc19vcl92aWV3X21vZGVsc1tfaV07CgkgICAgICAgICAgICBtb2RlbCA9IGtiLnV0aWxzLndyYXBwZWRPYmplY3Qodmlld19tb2RlbCk7CgkgICAgICAgICAgICBpZiAoaGFzX2ZpbHRlcnMpIHsKCSAgICAgICAgICAgICAgaWYgKCFfdGhpcy5fc2VsZWN0TW9kZWwobW9kZWwpKSB7CgkgICAgICAgICAgICAgICAgY29udGludWU7CgkgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgdmlld19tb2RlbHMucHVzaCh2aWV3X21vZGVsKTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIGlmIChjdXJyZW50X3ZpZXdfbW9kZWwgPSBfdGhpcy5jcmVhdGVfb3B0aW9ucy5zdG9yZS5maW5kKG1vZGVsLCBfdGhpcy5jcmVhdGVfb3B0aW9ucy5jcmVhdG9yKSkgewoJICAgICAgICAgICAgICAoY3VycmVudF92aWV3X21vZGVsLmNvbnN0cnVjdG9yID09PSB2aWV3X21vZGVsLmNvbnN0cnVjdG9yKSB8fCBrYi5fdGhyb3dVbmV4cGVjdGVkKF90aGlzLCAncmVwbGFjaW5nIGRpZmZlcmVudCB0eXBlIG9mIHZpZXcgbW9kZWwnKTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIF90aGlzLmNyZWF0ZV9vcHRpb25zLnN0b3JlLnJldGFpbih2aWV3X21vZGVsLCBtb2RlbCwgX3RoaXMuY3JlYXRlX29wdGlvbnMuY3JlYXRvcik7CgkgICAgICAgICAgICBtb2RlbHMucHVzaChtb2RlbCk7CgkgICAgICAgICAgfQoJICAgICAgICB9CgkgICAgICAgIF90aGlzLmluX2VkaXQrKzsKCSAgICAgICAgKG1vZGVsc19vcl92aWV3X21vZGVscy5sZW5ndGggPT09IHZpZXdfbW9kZWxzLmxlbmd0aCkgfHwgb2JzZXJ2YWJsZSh2aWV3X21vZGVscyk7CgkgICAgICAgIF8uaXNFcXVhbChjb2xsZWN0aW9uLm1vZGVscywgbW9kZWxzKSB8fCBjb2xsZWN0aW9uLnJlc2V0KG1vZGVscyk7CgkgICAgICAgIF90aGlzLmluX2VkaXQtLTsKCSAgICAgIH07CgkgICAgfSkodGhpcykpOwoJICB9OwoKCSAgQ29sbGVjdGlvbk9ic2VydmFibGUucHJvdG90eXBlLl9hdHRyaWJ1dGVDb21wYXJhdG9yID0gZnVuY3Rpb24oc29ydF9hdHRyaWJ1dGUpIHsKCSAgICB2YXIgbW9kZWxBdHRyaWJ1dGVDb21wYXJlOwoJICAgIG1vZGVsQXR0cmlidXRlQ29tcGFyZSA9IGZ1bmN0aW9uKG1vZGVsX2EsIG1vZGVsX2IpIHsKCSAgICAgIHZhciBhdHRyaWJ1dGVfbmFtZTsKCSAgICAgIGF0dHJpYnV0ZV9uYW1lID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZShzb3J0X2F0dHJpYnV0ZSk7CgkgICAgICByZXR1cm4ga2IuY29tcGFyZShtb2RlbF9hLmdldChhdHRyaWJ1dGVfbmFtZSksIG1vZGVsX2IuZ2V0KGF0dHJpYnV0ZV9uYW1lKSk7CgkgICAgfTsKCSAgICByZXR1cm4gKHRoaXMubW9kZWxzX29ubHkgPyBtb2RlbEF0dHJpYnV0ZUNvbXBhcmUgOiBmdW5jdGlvbihtb2RlbF9hLCBtb2RlbF9iKSB7CgkgICAgICByZXR1cm4gbW9kZWxBdHRyaWJ1dGVDb21wYXJlKGtiLnV0aWxzLndyYXBwZWRNb2RlbChtb2RlbF9hKSwga2IudXRpbHMud3JhcHBlZE1vZGVsKG1vZGVsX2IpKTsKCSAgICB9KTsKCSAgfTsKCgkgIENvbGxlY3Rpb25PYnNlcnZhYmxlLnByb3RvdHlwZS5fY3JlYXRlVmlld01vZGVsID0gZnVuY3Rpb24obW9kZWwpIHsKCSAgICBpZiAodGhpcy5tb2RlbHNfb25seSkgewoJICAgICAgcmV0dXJuIG1vZGVsOwoJICAgIH0KCSAgICByZXR1cm4gdGhpcy5jcmVhdGVfb3B0aW9ucy5zdG9yZS5yZXRhaW5PckNyZWF0ZShtb2RlbCwgdGhpcy5jcmVhdGVfb3B0aW9ucyk7CgkgIH07CgoJICBDb2xsZWN0aW9uT2JzZXJ2YWJsZS5wcm90b3R5cGUuX3NlbGVjdE1vZGVsID0gZnVuY3Rpb24obW9kZWwpIHsKCSAgICB2YXIgZmlsdGVyLCBmaWx0ZXJzLCBfaSwgX2xlbiwgX3JlZjE7CgkgICAgZmlsdGVycyA9IGtiLnBlZWsodGhpcy5fZmlsdGVycyk7CgkgICAgZm9yIChfaSA9IDAsIF9sZW4gPSBmaWx0ZXJzLmxlbmd0aDsgX2kgPCBfbGVuOyBfaSsrKSB7CgkgICAgICBmaWx0ZXIgPSBmaWx0ZXJzW19pXTsKCSAgICAgIGZpbHRlciA9IGtiLnBlZWsoZmlsdGVyKTsKCSAgICAgIGlmIChfLmlzRnVuY3Rpb24oZmlsdGVyKSkgewoJICAgICAgICBpZiAoIWZpbHRlcihtb2RlbCkpIHsKCSAgICAgICAgICByZXR1cm4gZmFsc2U7CgkgICAgICAgIH0KCSAgICAgIH0gZWxzZSBpZiAoXy5pc0FycmF5KGZpbHRlcikpIHsKCSAgICAgICAgaWYgKF9yZWYxID0gbW9kZWwuaWQsIF9faW5kZXhPZi5jYWxsKGZpbHRlciwgX3JlZjEpIDwgMCkgewoJICAgICAgICAgIHJldHVybiBmYWxzZTsKCSAgICAgICAgfQoJICAgICAgfSBlbHNlIHsKCSAgICAgICAgaWYgKG1vZGVsLmlkICE9PSBmaWx0ZXIpIHsKCSAgICAgICAgICByZXR1cm4gZmFsc2U7CgkgICAgICAgIH0KCSAgICAgIH0KCSAgICB9CgkgICAgcmV0dXJuIHRydWU7CgkgIH07CgoJICByZXR1cm4gQ29sbGVjdGlvbk9ic2VydmFibGU7CgoJfSkoKTsKCglrYi5jb2xsZWN0aW9uT2JzZXJ2YWJsZSA9IGZ1bmN0aW9uKGNvbGxlY3Rpb24sIHZpZXdfbW9kZWwsIG9wdGlvbnMpIHsKCSAgcmV0dXJuIG5ldyBrYi5Db2xsZWN0aW9uT2JzZXJ2YWJsZShhcmd1bWVudHMpOwoJfTsKCgovKioqLyB9LAovKiAyICovCi8qKiovIGZ1bmN0aW9uKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewoKCXZhciBBTExfT1JNUywga2IsIGtleSwga28sIHZhbHVlLCBfLCBfcmVmOwoKCV9yZWYgPSBrYiA9IF9fd2VicGFja19yZXF1aXJlX18oNiksIF8gPSBfcmVmLl8sIGtvID0gX3JlZi5rbzsKCglBTExfT1JNUyA9IHsKCSAgImRlZmF1bHQiOiBudWxsLAoJICAnYmFja2JvbmUtb3JtJzogbnVsbCwKCSAgJ2JhY2tib25lLWFzc29jaWF0aW9ucyc6IF9fd2VicGFja19yZXF1aXJlX18oMTYpLAoJICAnYmFja2JvbmUtcmVsYXRpb25hbCc6IF9fd2VicGFja19yZXF1aXJlX18oMTcpLAoJICBzdXBlcm1vZGVsOiBfX3dlYnBhY2tfcmVxdWlyZV9fKDE4KQoJfTsKCglrYi5vcm0gPSBBTExfT1JNU1siZGVmYXVsdCJdOwoKCWZvciAoa2V5IGluIEFMTF9PUk1TKSB7CgkgIHZhbHVlID0gQUxMX09STVNba2V5XTsKCSAgaWYgKHZhbHVlICYmIHZhbHVlLmlzQXZhaWxhYmxlKCkpIHsKCSAgICBrYi5vcm0gPSB2YWx1ZTsKCSAgICBicmVhazsKCSAgfQoJfQoKCW1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24ob3B0aW9ucykgewoJICB2YXIgb3JtOwoJICBpZiAob3B0aW9ucyA9PSBudWxsKSB7CgkgICAgb3B0aW9ucyA9IHt9OwoJICB9CgkgIGZvciAoa2V5IGluIG9wdGlvbnMpIHsKCSAgICB2YWx1ZSA9IG9wdGlvbnNba2V5XTsKCSAgICBzd2l0Y2ggKGtleSkgewoJICAgICAgY2FzZSAnb3JtJzoKCSAgICAgICAgaWYgKF8uaXNTdHJpbmcodmFsdWUpKSB7CgkgICAgICAgICAgaWYgKCFBTExfT1JNUy5oYXNPd25Qcm9wZXJ0eSh2YWx1ZSkpIHsKCSAgICAgICAgICAgIGNvbnNvbGUubG9nKCJLbm9ja2JhY2sgY29uZmlndXJlOiBjb3VsZCBub3QgZmluZCBvcm06ICIgKyB2YWx1ZSArICIuIEF2YWlsYWJsZTogIiArIChfLmtleXMoQUxMX09STVMpLmpvaW4oJywgJykpKTsKCSAgICAgICAgICAgIGNvbnRpbnVlOwoJICAgICAgICAgIH0KCSAgICAgICAgICBpZiAoKG9ybSA9IEFMTF9PUk1TW3ZhbHVlXSkgJiYgIW9ybS5pc0F2YWlsYWJsZSgpKSB7CgkgICAgICAgICAgICBjb25zb2xlLmxvZygiS25vY2tiYWNrIGNvbmZpZ3VyZTogY291bGQgbm90IGVuYWJsZSBvcm0gIiArIHZhbHVlICsgIi4gTWFrZSBzdXJlIGl0IGlzIGluY2x1ZGVkIGJlZm9yZSBLbm9ja2JhY2siKTsKCSAgICAgICAgICAgIGNvbnRpbnVlOwoJICAgICAgICAgIH0KCSAgICAgICAgICBrYi5vcm0gPSBvcm07CgkgICAgICAgICAgY29udGludWU7CgkgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAga2Iub3JtID0gdmFsdWU7CgkgICAgICAgIH0KCSAgICAgICAgYnJlYWs7CgkgICAgICBkZWZhdWx0OgoJICAgICAgICBrYltrZXldID0gdmFsdWU7CgkgICAgfQoJICB9Cgl9OwoKCi8qKiovIH0sCi8qIDMgKi8KLyoqKi8gZnVuY3Rpb24obW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CgoJCgkvKgoJICBrbm9ja2JhY2suanMgMC4yMC40CgkgIENvcHlyaWdodCAoYykgIDIwMTEtMjAxNCBLZXZpbiBNYWxha29mZi4KCSAgTGljZW5zZTogTUlUIChodHRwOi8vd3d3Lm9wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL21pdC1saWNlbnNlLnBocCkKCSAgU291cmNlOiBodHRwczovL2dpdGh1Yi5jb20va21hbGFrb2ZmL2tub2NrYmFjawoJICBEZXBlbmRlbmNpZXM6IEtub2Nrb3V0LmpzLCBCYWNrYm9uZS5qcywgYW5kIFVuZGVyc2NvcmUuanMgKG9yIExvRGFzaC5qcykuCgkgIE9wdGlvbmFsIGRlcGVuZGVuY2llczogQmFja2JvbmUuTW9kZWxSZWYuanMgYW5kIEJhY2tib25lT1JNLgoJICovCgl2YXIga2IsIGtvLCBfLCBfcmVmLAoJICBfX2JpbmQgPSBmdW5jdGlvbihmbiwgbWUpeyByZXR1cm4gZnVuY3Rpb24oKXsgcmV0dXJuIGZuLmFwcGx5KG1lLCBhcmd1bWVudHMpOyB9OyB9OwoKCV9yZWYgPSBrYiA9IF9fd2VicGFja19yZXF1aXJlX18oNiksIF8gPSBfcmVmLl8sIGtvID0gX3JlZi5rbzsKCglrYi5FdmVudFdhdGNoZXIgPSAoZnVuY3Rpb24oKSB7CgkgIEV2ZW50V2F0Y2hlci51c2VPcHRpb25zT3JDcmVhdGUgPSBmdW5jdGlvbihvcHRpb25zLCBlbWl0dGVyLCBvYmosIGNhbGxiYWNrX29wdGlvbnMpIHsKCSAgICBpZiAob3B0aW9ucy5ldmVudF93YXRjaGVyKSB7CgkgICAgICBpZiAoIShvcHRpb25zLmV2ZW50X3dhdGNoZXIuZW1pdHRlcigpID09PSBlbWl0dGVyIHx8IChvcHRpb25zLmV2ZW50X3dhdGNoZXIubW9kZWxfcmVmID09PSBlbWl0dGVyKSkpIHsKCSAgICAgICAga2IuX3Rocm93VW5leHBlY3RlZCh0aGlzLCAnZW1pdHRlciBub3QgbWF0Y2hpbmcnKTsKCSAgICAgIH0KCSAgICAgIHJldHVybiBrYi51dGlscy53cmFwcGVkRXZlbnRXYXRjaGVyKG9iaiwgb3B0aW9ucy5ldmVudF93YXRjaGVyKS5yZWdpc3RlckNhbGxiYWNrcyhvYmosIGNhbGxiYWNrX29wdGlvbnMpOwoJICAgIH0gZWxzZSB7CgkgICAgICBrYi51dGlscy53cmFwcGVkRXZlbnRXYXRjaGVySXNPd25lZChvYmosIHRydWUpOwoJICAgICAgcmV0dXJuIGtiLnV0aWxzLndyYXBwZWRFdmVudFdhdGNoZXIob2JqLCBuZXcga2IuRXZlbnRXYXRjaGVyKGVtaXR0ZXIpKS5yZWdpc3RlckNhbGxiYWNrcyhvYmosIGNhbGxiYWNrX29wdGlvbnMpOwoJICAgIH0KCSAgfTsKCgkgIGZ1bmN0aW9uIEV2ZW50V2F0Y2hlcihlbWl0dGVyLCBvYmosIGNhbGxiYWNrX29wdGlvbnMpIHsKCSAgICB0aGlzLl91bmJpbmRDYWxsYmFja3MgPSBfX2JpbmQodGhpcy5fdW5iaW5kQ2FsbGJhY2tzLCB0aGlzKTsKCSAgICB0aGlzLl9vbk1vZGVsVW5sb2FkZWQgPSBfX2JpbmQodGhpcy5fb25Nb2RlbFVubG9hZGVkLCB0aGlzKTsKCSAgICB0aGlzLl9vbk1vZGVsTG9hZGVkID0gX19iaW5kKHRoaXMuX29uTW9kZWxMb2FkZWQsIHRoaXMpOwoJICAgIHRoaXMuX19rYiB8fCAodGhpcy5fX2tiID0ge30pOwoJICAgIHRoaXMuX19rYi5jYWxsYmFja3MgPSB7fTsKCSAgICB0aGlzLmVlID0gbnVsbDsKCSAgICBpZiAoY2FsbGJhY2tfb3B0aW9ucykgewoJICAgICAgdGhpcy5yZWdpc3RlckNhbGxiYWNrcyhvYmosIGNhbGxiYWNrX29wdGlvbnMpOwoJICAgIH0KCSAgICBpZiAoZW1pdHRlcikgewoJICAgICAgdGhpcy5lbWl0dGVyKGVtaXR0ZXIpOwoJICAgIH0KCSAgfQoKCSAgRXZlbnRXYXRjaGVyLnByb3RvdHlwZS5kZXN0cm95ID0gZnVuY3Rpb24oKSB7CgkgICAgdGhpcy5lbWl0dGVyKG51bGwpOwoJICAgIHRoaXMuX19rYi5jYWxsYmFja3MgPSBudWxsOwoJICAgIHJldHVybiBrYi51dGlscy53cmFwcGVkRGVzdHJveSh0aGlzKTsKCSAgfTsKCgkgIEV2ZW50V2F0Y2hlci5wcm90b3R5cGUuZW1pdHRlciA9IGZ1bmN0aW9uKG5ld19lbWl0dGVyKSB7CgkgICAgaWYgKChhcmd1bWVudHMubGVuZ3RoID09PSAwKSB8fCAodGhpcy5lZSA9PT0gbmV3X2VtaXR0ZXIpKSB7CgkgICAgICByZXR1cm4gdGhpcy5lZTsKCSAgICB9CgkgICAgaWYgKHRoaXMubW9kZWxfcmVmKSB7CgkgICAgICB0aGlzLm1vZGVsX3JlZi51bmJpbmQoJ2xvYWRlZCcsIHRoaXMuX29uTW9kZWxMb2FkZWQpOwoJICAgICAgdGhpcy5tb2RlbF9yZWYudW5iaW5kKCd1bmxvYWRlZCcsIHRoaXMuX29uTW9kZWxVbmxvYWRlZCk7CgkgICAgICB0aGlzLm1vZGVsX3JlZi5yZWxlYXNlKCk7CgkgICAgICB0aGlzLm1vZGVsX3JlZiA9IG51bGw7CgkgICAgfQoJICAgIGlmIChrYi5CYWNrYm9uZSAmJiBrYi5CYWNrYm9uZS5Nb2RlbFJlZiAmJiAobmV3X2VtaXR0ZXIgaW5zdGFuY2VvZiBrYi5CYWNrYm9uZS5Nb2RlbFJlZikpIHsKCSAgICAgIHRoaXMubW9kZWxfcmVmID0gbmV3X2VtaXR0ZXI7CgkgICAgICB0aGlzLm1vZGVsX3JlZi5yZXRhaW4oKTsKCSAgICAgIHRoaXMubW9kZWxfcmVmLmJpbmQoJ2xvYWRlZCcsIHRoaXMuX29uTW9kZWxMb2FkZWQpOwoJICAgICAgdGhpcy5tb2RlbF9yZWYuYmluZCgndW5sb2FkZWQnLCB0aGlzLl9vbk1vZGVsVW5sb2FkZWQpOwoJICAgICAgbmV3X2VtaXR0ZXIgPSB0aGlzLm1vZGVsX3JlZi5tb2RlbCgpIHx8IG51bGw7CgkgICAgfSBlbHNlIHsKCSAgICAgIGRlbGV0ZSB0aGlzLm1vZGVsX3JlZjsKCSAgICB9CgkgICAgaWYgKHRoaXMuZWUgIT09IG5ld19lbWl0dGVyKSB7CgkgICAgICBpZiAobmV3X2VtaXR0ZXIpIHsKCSAgICAgICAgdGhpcy5fb25Nb2RlbExvYWRlZChuZXdfZW1pdHRlcik7CgkgICAgICB9IGVsc2UgewoJICAgICAgICB0aGlzLl9vbk1vZGVsVW5sb2FkZWQodGhpcy5lZSk7CgkgICAgICB9CgkgICAgfQoJICAgIHJldHVybiBuZXdfZW1pdHRlcjsKCSAgfTsKCgkgIEV2ZW50V2F0Y2hlci5wcm90b3R5cGUucmVnaXN0ZXJDYWxsYmFja3MgPSBmdW5jdGlvbihvYmosIGNhbGxiYWNrX2luZm8pIHsKCSAgICB2YXIgZXZlbnRfbmFtZSwgZXZlbnRfbmFtZXMsIG1vZGVsLCBfZm4sIF9pLCBfbGVuOwoJICAgIG9iaiB8fCBrYi5fdGhyb3dNaXNzaW5nKHRoaXMsICdvYmonKTsKCSAgICBjYWxsYmFja19pbmZvIHx8IGtiLl90aHJvd01pc3NpbmcodGhpcywgJ2NhbGxiYWNrX2luZm8nKTsKCSAgICBldmVudF9uYW1lcyA9IGNhbGxiYWNrX2luZm8uZXZlbnRfc2VsZWN0b3IgPyBjYWxsYmFja19pbmZvLmV2ZW50X3NlbGVjdG9yLnNwbGl0KCcgJykgOiBbJ2NoYW5nZSddOwoJICAgIG1vZGVsID0gdGhpcy5lZTsKCSAgICBfZm4gPSAoZnVuY3Rpb24oX3RoaXMpIHsKCSAgICAgIHJldHVybiBmdW5jdGlvbihldmVudF9uYW1lKSB7CgkgICAgICAgIHZhciBjYWxsYmFja3MsIGluZm87CgkgICAgICAgIGlmICghKGNhbGxiYWNrcyA9IF90aGlzLl9fa2IuY2FsbGJhY2tzW2V2ZW50X25hbWVdKSkgewoJICAgICAgICAgIGNhbGxiYWNrcyA9IF90aGlzLl9fa2IuY2FsbGJhY2tzW2V2ZW50X25hbWVdID0gewoJICAgICAgICAgICAgbW9kZWw6IG51bGwsCgkgICAgICAgICAgICBsaXN0OiBbXSwKCSAgICAgICAgICAgIGZuOiBmdW5jdGlvbihtb2RlbCkgewoJICAgICAgICAgICAgICB2YXIgaW5mbywgX2osIF9sZW4xLCBfcmVmMTsKCSAgICAgICAgICAgICAgX3JlZjEgPSBjYWxsYmFja3MubGlzdDsKCSAgICAgICAgICAgICAgZm9yIChfaiA9IDAsIF9sZW4xID0gX3JlZjEubGVuZ3RoOyBfaiA8IF9sZW4xOyBfaisrKSB7CgkgICAgICAgICAgICAgICAgaW5mbyA9IF9yZWYxW19qXTsKCSAgICAgICAgICAgICAgICBpZiAoIWluZm8udXBkYXRlKSB7CgkgICAgICAgICAgICAgICAgICBjb250aW51ZTsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgaWYgKG1vZGVsICYmIGluZm8ua2V5ICYmIChtb2RlbC5oYXNDaGFuZ2VkICYmICFtb2RlbC5oYXNDaGFuZ2VkKGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUoaW5mby5rZXkpKSkpIHsKCSAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICAha2Iuc3RhdGlzdGljcyB8fCBrYi5zdGF0aXN0aWNzLmFkZE1vZGVsRXZlbnQoewoJICAgICAgICAgICAgICAgICAgbmFtZTogZXZlbnRfbmFtZSwKCSAgICAgICAgICAgICAgICAgIG1vZGVsOiBtb2RlbCwKCSAgICAgICAgICAgICAgICAgIGtleTogaW5mby5rZXksCgkgICAgICAgICAgICAgICAgICBwYXRoOiBpbmZvLnBhdGgKCSAgICAgICAgICAgICAgICB9KTsKCSAgICAgICAgICAgICAgICBpbmZvLnVwZGF0ZSgpOwoJICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgIHJldHVybiBudWxsOwoJICAgICAgICAgICAgfQoJICAgICAgICAgIH07CgkgICAgICAgIH0KCSAgICAgICAgY2FsbGJhY2tzLmxpc3QucHVzaChpbmZvID0gXy5kZWZhdWx0cyh7CgkgICAgICAgICAgb2JqOiBvYmoKCSAgICAgICAgfSwgY2FsbGJhY2tfaW5mbykpOwoJICAgICAgICBpZiAobW9kZWwpIHsKCSAgICAgICAgICByZXR1cm4gX3RoaXMuX29uTW9kZWxMb2FkZWQobW9kZWwpOwoJICAgICAgICB9CgkgICAgICB9OwoJICAgIH0pKHRoaXMpOwoJICAgIGZvciAoX2kgPSAwLCBfbGVuID0gZXZlbnRfbmFtZXMubGVuZ3RoOyBfaSA8IF9sZW47IF9pKyspIHsKCSAgICAgIGV2ZW50X25hbWUgPSBldmVudF9uYW1lc1tfaV07CgkgICAgICBpZiAoIWV2ZW50X25hbWUpIHsKCSAgICAgICAgY29udGludWU7CgkgICAgICB9CgkgICAgICBfZm4oZXZlbnRfbmFtZSk7CgkgICAgfQoJICAgIHJldHVybiB0aGlzOwoJICB9OwoKCSAgRXZlbnRXYXRjaGVyLnByb3RvdHlwZS5yZWxlYXNlQ2FsbGJhY2tzID0gZnVuY3Rpb24ob2JqKSB7CgkgICAgdmFyIGNhbGxiYWNrcywgZXZlbnRfbmFtZSwgX3JlZjE7CgkgICAgdGhpcy5lZSA9IG51bGw7CgkgICAgX3JlZjEgPSB0aGlzLl9fa2IuY2FsbGJhY2tzOwoJICAgIGZvciAoZXZlbnRfbmFtZSBpbiBfcmVmMSkgewoJICAgICAgY2FsbGJhY2tzID0gX3JlZjFbZXZlbnRfbmFtZV07CgkgICAgICB0aGlzLl91bmJpbmRDYWxsYmFja3MoZXZlbnRfbmFtZSwgY2FsbGJhY2tzLCBrYi53YXNSZWxlYXNlZChvYmopKTsKCSAgICB9CgkgICAgcmV0dXJuIGRlbGV0ZSB0aGlzLl9fa2IuY2FsbGJhY2tzOwoJICB9OwoKCSAgRXZlbnRXYXRjaGVyLnByb3RvdHlwZS5fb25Nb2RlbExvYWRlZCA9IGZ1bmN0aW9uKG1vZGVsKSB7CgkgICAgdmFyIGNhbGxiYWNrcywgZXZlbnRfbmFtZSwgaW5mbywgX2ksIF9sZW4sIF9yZWYxLCBfcmVmMiwgX3JlZjM7CgkgICAgdGhpcy5lZSA9IG1vZGVsOwoJICAgIF9yZWYxID0gdGhpcy5fX2tiLmNhbGxiYWNrczsKCSAgICBmb3IgKGV2ZW50X25hbWUgaW4gX3JlZjEpIHsKCSAgICAgIGNhbGxiYWNrcyA9IF9yZWYxW2V2ZW50X25hbWVdOwoJICAgICAgaWYgKGNhbGxiYWNrcy5tb2RlbCAmJiAoY2FsbGJhY2tzLm1vZGVsICE9PSBtb2RlbCkpIHsKCSAgICAgICAgdGhpcy5fdW5iaW5kQ2FsbGJhY2tzKGV2ZW50X25hbWUsIGNhbGxiYWNrcywgdHJ1ZSk7CgkgICAgICB9CgkgICAgICBpZiAoIWNhbGxiYWNrcy5tb2RlbCkgewoJICAgICAgICBjYWxsYmFja3MubW9kZWwgPSBtb2RlbDsKCSAgICAgICAgbW9kZWwuYmluZChldmVudF9uYW1lLCBjYWxsYmFja3MuZm4pOwoJICAgICAgfQoJICAgICAgX3JlZjIgPSBjYWxsYmFja3MubGlzdDsKCSAgICAgIGZvciAoX2kgPSAwLCBfbGVuID0gX3JlZjIubGVuZ3RoOyBfaSA8IF9sZW47IF9pKyspIHsKCSAgICAgICAgaW5mbyA9IF9yZWYyW19pXTsKCSAgICAgICAgaW5mby51bmJpbmRfZm4gfHwgKGluZm8udW5iaW5kX2ZuID0gKF9yZWYzID0ga2Iub3JtKSAhPSBudWxsID8gX3JlZjMuYmluZChtb2RlbCwgaW5mby5rZXksIGluZm8udXBkYXRlLCBpbmZvLnBhdGgpIDogdm9pZCAwKTsKCSAgICAgICAgaWYgKGluZm8uZW1pdHRlcikgewoJICAgICAgICAgIGluZm8uZW1pdHRlcihtb2RlbCk7CgkgICAgICAgIH0KCSAgICAgIH0KCSAgICB9CgkgIH07CgoJICBFdmVudFdhdGNoZXIucHJvdG90eXBlLl9vbk1vZGVsVW5sb2FkZWQgPSBmdW5jdGlvbihtb2RlbCkgewoJICAgIHZhciBjYWxsYmFja3MsIGV2ZW50X25hbWUsIF9yZWYxOwoJICAgIGlmICh0aGlzLmVlICE9PSBtb2RlbCkgewoJICAgICAgcmV0dXJuOwoJICAgIH0KCSAgICB0aGlzLmVlID0gbnVsbDsKCSAgICBfcmVmMSA9IHRoaXMuX19rYi5jYWxsYmFja3M7CgkgICAgZm9yIChldmVudF9uYW1lIGluIF9yZWYxKSB7CgkgICAgICBjYWxsYmFja3MgPSBfcmVmMVtldmVudF9uYW1lXTsKCSAgICAgIHRoaXMuX3VuYmluZENhbGxiYWNrcyhldmVudF9uYW1lLCBjYWxsYmFja3MpOwoJICAgIH0KCSAgfTsKCgkgIEV2ZW50V2F0Y2hlci5wcm90b3R5cGUuX3VuYmluZENhbGxiYWNrcyA9IGZ1bmN0aW9uKGV2ZW50X25hbWUsIGNhbGxiYWNrcywgc2tpcF9lbWl0dGVyKSB7CgkgICAgdmFyIGluZm8sIF9pLCBfbGVuLCBfcmVmMTsKCSAgICBpZiAoY2FsbGJhY2tzLm1vZGVsKSB7CgkgICAgICBjYWxsYmFja3MubW9kZWwudW5iaW5kKGV2ZW50X25hbWUsIGNhbGxiYWNrcy5mbik7CgkgICAgICBjYWxsYmFja3MubW9kZWwgPSBudWxsOwoJICAgIH0KCSAgICBfcmVmMSA9IGNhbGxiYWNrcy5saXN0OwoJICAgIGZvciAoX2kgPSAwLCBfbGVuID0gX3JlZjEubGVuZ3RoOyBfaSA8IF9sZW47IF9pKyspIHsKCSAgICAgIGluZm8gPSBfcmVmMVtfaV07CgkgICAgICBpZiAoaW5mby51bmJpbmRfZm4pIHsKCSAgICAgICAgaW5mby51bmJpbmRfZm4oKTsKCSAgICAgICAgaW5mby51bmJpbmRfZm4gPSBudWxsOwoJICAgICAgfQoJICAgICAgaWYgKGluZm8uZW1pdHRlciAmJiAhc2tpcF9lbWl0dGVyICYmICFrYi53YXNSZWxlYXNlZChpbmZvLm9iaikpIHsKCSAgICAgICAgaW5mby5lbWl0dGVyKG51bGwpOwoJICAgICAgfQoJICAgIH0KCSAgfTsKCgkgIHJldHVybiBFdmVudFdhdGNoZXI7CgoJfSkoKTsKCglrYi5lbWl0dGVyT2JzZXJ2YWJsZSA9IGZ1bmN0aW9uKGVtaXR0ZXIsIG9ic2VydmFibGUpIHsKCSAgcmV0dXJuIG5ldyBrYi5FdmVudFdhdGNoZXIoZW1pdHRlciwgb2JzZXJ2YWJsZSk7Cgl9OwoKCi8qKiovIH0sCi8qIDQgKi8KLyoqKi8gZnVuY3Rpb24obW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CgoJCgkvKgoJICBrbm9ja2JhY2suanMgMC4yMC40CgkgIENvcHlyaWdodCAoYykgIDIwMTEtMjAxNCBLZXZpbiBNYWxha29mZi4KCSAgTGljZW5zZTogTUlUIChodHRwOi8vd3d3Lm9wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL21pdC1saWNlbnNlLnBocCkKCSAgU291cmNlOiBodHRwczovL2dpdGh1Yi5jb20va21hbGFrb2ZmL2tub2NrYmFjawoJICBEZXBlbmRlbmNpZXM6IEtub2Nrb3V0LmpzLCBCYWNrYm9uZS5qcywgYW5kIFVuZGVyc2NvcmUuanMgKG9yIExvRGFzaC5qcykuCgkgIE9wdGlvbmFsIGRlcGVuZGVuY2llczogQmFja2JvbmUuTW9kZWxSZWYuanMgYW5kIEJhY2tib25lT1JNLgoJICovCgl2YXIga2IsIF87CgoJXyA9IChrYiA9IF9fd2VicGFja19yZXF1aXJlX18oNikpLl87CgoJa2IuRmFjdG9yeSA9IChmdW5jdGlvbigpIHsKCSAgRmFjdG9yeS51c2VPcHRpb25zT3JDcmVhdGUgPSBmdW5jdGlvbihvcHRpb25zLCBvYmosIG93bmVyX3BhdGgpIHsKCSAgICB2YXIgZmFjdG9yeTsKCSAgICBpZiAob3B0aW9ucy5mYWN0b3J5ICYmICghb3B0aW9ucy5mYWN0b3JpZXMgfHwgKG9wdGlvbnMuZmFjdG9yaWVzICYmIG9wdGlvbnMuZmFjdG9yeS5oYXNQYXRoTWFwcGluZ3Mob3B0aW9ucy5mYWN0b3JpZXMsIG93bmVyX3BhdGgpKSkpIHsKCSAgICAgIHJldHVybiBrYi51dGlscy53cmFwcGVkRmFjdG9yeShvYmosIG9wdGlvbnMuZmFjdG9yeSk7CgkgICAgfQoJICAgIGZhY3RvcnkgPSBrYi51dGlscy53cmFwcGVkRmFjdG9yeShvYmosIG5ldyBrYi5GYWN0b3J5KG9wdGlvbnMuZmFjdG9yeSkpOwoJICAgIGlmIChvcHRpb25zLmZhY3RvcmllcykgewoJICAgICAgZmFjdG9yeS5hZGRQYXRoTWFwcGluZ3Mob3B0aW9ucy5mYWN0b3JpZXMsIG93bmVyX3BhdGgpOwoJICAgIH0KCSAgICByZXR1cm4gZmFjdG9yeTsKCSAgfTsKCgkgIGZ1bmN0aW9uIEZhY3RvcnkocGFyZW50X2ZhY3RvcnkpIHsKCSAgICB0aGlzLnBhdGhzID0ge307CgkgICAgaWYgKHBhcmVudF9mYWN0b3J5KSB7CgkgICAgICB0aGlzLnBhcmVudF9mYWN0b3J5ID0gcGFyZW50X2ZhY3Rvcnk7CgkgICAgfQoJICB9CgoJICBGYWN0b3J5LnByb3RvdHlwZS5oYXNQYXRoID0gZnVuY3Rpb24ocGF0aCkgewoJICAgIHZhciBfcmVmOwoJICAgIHJldHVybiB0aGlzLnBhdGhzLmhhc093blByb3BlcnR5KHBhdGgpIHx8ICgoX3JlZiA9IHRoaXMucGFyZW50X2ZhY3RvcnkpICE9IG51bGwgPyBfcmVmLmhhc1BhdGgocGF0aCkgOiB2b2lkIDApOwoJICB9OwoKCSAgRmFjdG9yeS5wcm90b3R5cGUuYWRkUGF0aE1hcHBpbmcgPSBmdW5jdGlvbihwYXRoLCBjcmVhdGVfaW5mbykgewoJICAgIHJldHVybiB0aGlzLnBhdGhzW3BhdGhdID0gY3JlYXRlX2luZm87CgkgIH07CgoJICBGYWN0b3J5LnByb3RvdHlwZS5hZGRQYXRoTWFwcGluZ3MgPSBmdW5jdGlvbihmYWN0b3JpZXMsIG93bmVyX3BhdGgpIHsKCSAgICB2YXIgY3JlYXRlX2luZm8sIHBhdGg7CgkgICAgZm9yIChwYXRoIGluIGZhY3RvcmllcykgewoJICAgICAgY3JlYXRlX2luZm8gPSBmYWN0b3JpZXNbcGF0aF07CgkgICAgICB0aGlzLnBhdGhzW2tiLnV0aWxzLnBhdGhKb2luKG93bmVyX3BhdGgsIHBhdGgpXSA9IGNyZWF0ZV9pbmZvOwoJICAgIH0KCSAgfTsKCgkgIEZhY3RvcnkucHJvdG90eXBlLmhhc1BhdGhNYXBwaW5ncyA9IGZ1bmN0aW9uKGZhY3Rvcmllcywgb3duZXJfcGF0aCkgewoJICAgIHZhciBhbGxfZXhpc3QsIGNyZWF0b3IsIGV4aXN0aW5nX2NyZWF0b3IsIHBhdGg7CgkgICAgYWxsX2V4aXN0ID0gdHJ1ZTsKCSAgICBmb3IgKHBhdGggaW4gZmFjdG9yaWVzKSB7CgkgICAgICBjcmVhdG9yID0gZmFjdG9yaWVzW3BhdGhdOwoJICAgICAgYWxsX2V4aXN0ICY9IChleGlzdGluZ19jcmVhdG9yID0gdGhpcy5jcmVhdG9yRm9yUGF0aChudWxsLCBrYi51dGlscy5wYXRoSm9pbihvd25lcl9wYXRoLCBwYXRoKSkpICYmIChjcmVhdG9yID09PSBleGlzdGluZ19jcmVhdG9yKTsKCSAgICB9CgkgICAgcmV0dXJuIGFsbF9leGlzdDsKCSAgfTsKCgkgIEZhY3RvcnkucHJvdG90eXBlLmNyZWF0b3JGb3JQYXRoID0gZnVuY3Rpb24ob2JqLCBwYXRoKSB7CgkgICAgdmFyIGNyZWF0b3IsIF9yZWY7CgkgICAgaWYgKGNyZWF0b3IgPSB0aGlzLnBhdGhzW3BhdGhdKSB7CgkgICAgICByZXR1cm4gKGNyZWF0b3Iudmlld19tb2RlbCA/IGNyZWF0b3Iudmlld19tb2RlbCA6IGNyZWF0b3IpOwoJICAgIH0KCSAgICBpZiAoY3JlYXRvciA9IChfcmVmID0gdGhpcy5wYXJlbnRfZmFjdG9yeSkgIT0gbnVsbCA/IF9yZWYuY3JlYXRvckZvclBhdGgob2JqLCBwYXRoKSA6IHZvaWQgMCkgewoJICAgICAgcmV0dXJuIGNyZWF0b3I7CgkgICAgfQoJICAgIHJldHVybiBudWxsOwoJICB9OwoKCSAgcmV0dXJuIEZhY3Rvcnk7CgoJfSkoKTsKCgovKioqLyB9LAovKiA1ICovCi8qKiovIGZ1bmN0aW9uKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewoKCS8qIFdFQlBBQ0sgVkFSIElOSkVDVElPTiAqLyhmdW5jdGlvbihnbG9iYWwpIHsKCS8qCgkgIGtub2NrYmFjay5qcyAwLjIwLjQKCSAgQ29weXJpZ2h0IChjKSAgMjAxMS0yMDE0IEtldmluIE1hbGFrb2ZmLgoJICBMaWNlbnNlOiBNSVQgKGh0dHA6Ly93d3cub3BlbnNvdXJjZS5vcmcvbGljZW5zZXMvbWl0LWxpY2Vuc2UucGhwKQoJICBTb3VyY2U6IGh0dHBzOi8vZ2l0aHViLmNvbS9rbWFsYWtvZmYva25vY2tiYWNrCgkgIERlcGVuZGVuY2llczogS25vY2tvdXQuanMsIEJhY2tib25lLmpzLCBhbmQgVW5kZXJzY29yZS5qcyAob3IgTG9EYXNoLmpzKS4KCSAgT3B0aW9uYWwgZGVwZW5kZW5jaWVzOiBCYWNrYm9uZS5Nb2RlbFJlZi5qcyBhbmQgQmFja2JvbmVPUk0uCgkgKi8KCXZhciAkLCBrYiwga28sIG9uUmVhZHksIHdpbmRvdywgXywgX2tvX2FwcGx5QmluZGluZ3MsIF9yZWY7CgoJd2luZG93ID0gd2luZG93ICE9IG51bGwgPyB3aW5kb3cgOiBnbG9iYWw7CgoJX3JlZiA9IGtiID0gX193ZWJwYWNrX3JlcXVpcmVfXyg2KSwgXyA9IF9yZWYuXywga28gPSBfcmVmLmtvLCAkID0gX3JlZi4kOwoKCWtiLlJFQ1VTSVZFX0FVVE9fSU5KRUNUID0gdHJ1ZTsKCglrby5iaW5kaW5nSGFuZGxlcnNbJ2luamVjdCddID0gewoJICAnaW5pdCc6IGZ1bmN0aW9uKGVsZW1lbnQsIHZhbHVlX2FjY2Vzc29yLCBhbGxfYmluZGluZ3NfYWNjZXNzb3IsIHZpZXdfbW9kZWwpIHsKCSAgICByZXR1cm4ga2IuSW5qZWN0LmluamVjdChrby51dGlscy51bndyYXBPYnNlcnZhYmxlKHZhbHVlX2FjY2Vzc29yKCkpLCB2aWV3X21vZGVsLCBlbGVtZW50LCB2YWx1ZV9hY2Nlc3NvciwgYWxsX2JpbmRpbmdzX2FjY2Vzc29yKTsKCSAgfQoJfTsKCglrYi5JbmplY3QgPSAoZnVuY3Rpb24oKSB7CgkgIGZ1bmN0aW9uIEluamVjdCgpIHt9CgoJICBJbmplY3QuaW5qZWN0ID0gZnVuY3Rpb24oZGF0YSwgdmlld19tb2RlbCwgZWxlbWVudCwgdmFsdWVfYWNjZXNzb3IsIGFsbF9iaW5kaW5nc19hY2Nlc3NvciwgbmVzdGVkKSB7CgkgICAgdmFyIGluamVjdDsKCSAgICBpbmplY3QgPSBmdW5jdGlvbihkYXRhKSB7CgkgICAgICB2YXIga2V5LCB0YXJnZXQsIHZhbHVlOwoJICAgICAgaWYgKF8uaXNGdW5jdGlvbihkYXRhKSkgewoJICAgICAgICB2aWV3X21vZGVsID0gbmV3IGRhdGEodmlld19tb2RlbCwgZWxlbWVudCwgdmFsdWVfYWNjZXNzb3IsIGFsbF9iaW5kaW5nc19hY2Nlc3Nvcik7CgkgICAgICAgIGtiLnJlbGVhc2VPbk5vZGVSZW1vdmUodmlld19tb2RlbCwgZWxlbWVudCk7CgkgICAgICB9IGVsc2UgewoJICAgICAgICBpZiAoZGF0YS52aWV3X21vZGVsKSB7CgkgICAgICAgICAgdmlld19tb2RlbCA9IG5ldyBkYXRhLnZpZXdfbW9kZWwodmlld19tb2RlbCwgZWxlbWVudCwgdmFsdWVfYWNjZXNzb3IsIGFsbF9iaW5kaW5nc19hY2Nlc3Nvcik7CgkgICAgICAgICAga2IucmVsZWFzZU9uTm9kZVJlbW92ZSh2aWV3X21vZGVsLCBlbGVtZW50KTsKCSAgICAgICAgfQoJICAgICAgICBmb3IgKGtleSBpbiBkYXRhKSB7CgkgICAgICAgICAgdmFsdWUgPSBkYXRhW2tleV07CgkgICAgICAgICAgaWYgKGtleSA9PT0gJ3ZpZXdfbW9kZWwnKSB7CgkgICAgICAgICAgICBjb250aW51ZTsKCSAgICAgICAgICB9CgkgICAgICAgICAgaWYgKGtleSA9PT0gJ2NyZWF0ZScpIHsKCSAgICAgICAgICAgIHZhbHVlKHZpZXdfbW9kZWwsIGVsZW1lbnQsIHZhbHVlX2FjY2Vzc29yLCBhbGxfYmluZGluZ3NfYWNjZXNzb3IpOwoJICAgICAgICAgIH0gZWxzZSBpZiAoXy5pc09iamVjdCh2YWx1ZSkgJiYgIV8uaXNGdW5jdGlvbih2YWx1ZSkpIHsKCSAgICAgICAgICAgIHRhcmdldCA9IG5lc3RlZCB8fCAodmFsdWUgJiYgdmFsdWUuY3JlYXRlKSA/IHt9IDogdmlld19tb2RlbDsKCSAgICAgICAgICAgIHZpZXdfbW9kZWxba2V5XSA9IGtiLkluamVjdC5pbmplY3QodmFsdWUsIHRhcmdldCwgZWxlbWVudCwgdmFsdWVfYWNjZXNzb3IsIGFsbF9iaW5kaW5nc19hY2Nlc3NvciwgdHJ1ZSk7CgkgICAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgIHZpZXdfbW9kZWxba2V5XSA9IHZhbHVlOwoJICAgICAgICAgIH0KCSAgICAgICAgfQoJICAgICAgfQoJICAgICAgcmV0dXJuIHZpZXdfbW9kZWw7CgkgICAgfTsKCSAgICBpZiAobmVzdGVkKSB7CgkgICAgICByZXR1cm4gaW5qZWN0KGRhdGEpOwoJICAgIH0gZWxzZSB7CgkgICAgICByZXR1cm4ga2IuaWdub3JlKGZ1bmN0aW9uKCkgewoJICAgICAgICByZXR1cm4gaW5qZWN0KGRhdGEpOwoJICAgICAgfSk7CgkgICAgfQoJICB9OwoKCSAgSW5qZWN0LmluamVjdFZpZXdNb2RlbHMgPSBmdW5jdGlvbihyb290KSB7CgkgICAgdmFyIGFmdGVyQmluZGluZywgYXBwLCBiZWZvcmVCaW5kaW5nLCBkYXRhLCBleHByZXNzaW9uLCBmaW5kRWxlbWVudHMsIG9wdGlvbnMsIHJlc3VsdHMsIF9pLCBfbGVuOwoJICAgIHJlc3VsdHMgPSBbXTsKCSAgICBmaW5kRWxlbWVudHMgPSBmdW5jdGlvbihlbCkgewoJICAgICAgdmFyIGF0dHIsIGNoaWxkX2VsLCBfaSwgX2xlbiwgX3JlZjE7CgkgICAgICBpZiAoIWVsLl9fa2JfaW5qZWN0ZWQpIHsKCSAgICAgICAgaWYgKGVsLmF0dHJpYnV0ZXMgJiYgKGF0dHIgPSBfLmZpbmQoZWwuYXR0cmlidXRlcywgZnVuY3Rpb24oYXR0cikgewoJICAgICAgICAgIHJldHVybiBhdHRyLm5hbWUgPT09ICdrYi1pbmplY3QnOwoJICAgICAgICB9KSkpIHsKCSAgICAgICAgICBlbC5fX2tiX2luamVjdGVkID0gdHJ1ZTsKCSAgICAgICAgICByZXN1bHRzLnB1c2goewoJICAgICAgICAgICAgZWw6IGVsLAoJICAgICAgICAgICAgdmlld19tb2RlbDoge30sCgkgICAgICAgICAgICBiaW5kaW5nOiBhdHRyLnZhbHVlCgkgICAgICAgICAgfSk7CgkgICAgICAgIH0KCSAgICAgIH0KCSAgICAgIF9yZWYxID0gZWwuY2hpbGROb2RlczsKCSAgICAgIGZvciAoX2kgPSAwLCBfbGVuID0gX3JlZjEubGVuZ3RoOyBfaSA8IF9sZW47IF9pKyspIHsKCSAgICAgICAgY2hpbGRfZWwgPSBfcmVmMVtfaV07CgkgICAgICAgIGZpbmRFbGVtZW50cyhjaGlsZF9lbCk7CgkgICAgICB9CgkgICAgfTsKCSAgICBpZiAoIXJvb3QgJiYgKHdpbmRvdyAhPSBudWxsID8gd2luZG93LmRvY3VtZW50IDogdm9pZCAwKSkgewoJICAgICAgcm9vdCA9IHdpbmRvdy5kb2N1bWVudDsKCSAgICB9CgkgICAgZmluZEVsZW1lbnRzKHJvb3QpOwoJICAgIGZvciAoX2kgPSAwLCBfbGVuID0gcmVzdWx0cy5sZW5ndGg7IF9pIDwgX2xlbjsgX2krKykgewoJICAgICAgYXBwID0gcmVzdWx0c1tfaV07CgkgICAgICBpZiAoZXhwcmVzc2lvbiA9IGFwcC5iaW5kaW5nKSB7CgkgICAgICAgIChleHByZXNzaW9uLnNlYXJjaCgvWzpdLykgPCAwKSB8fCAoZXhwcmVzc2lvbiA9ICJ7IiArIGV4cHJlc3Npb24gKyAifSIpOwoJICAgICAgICBkYXRhID0gKG5ldyBGdW5jdGlvbigiIiwgInJldHVybiAoICIgKyBleHByZXNzaW9uICsgIiApIikpKCk7CgkgICAgICAgIGRhdGEgfHwgKGRhdGEgPSB7fSk7CgkgICAgICAgICghZGF0YS5vcHRpb25zKSB8fCAob3B0aW9ucyA9IGRhdGEub3B0aW9ucywgZGVsZXRlIGRhdGEub3B0aW9ucyk7CgkgICAgICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CgkgICAgICAgIGFwcC52aWV3X21vZGVsID0ga2IuSW5qZWN0LmluamVjdChkYXRhLCBhcHAudmlld19tb2RlbCwgYXBwLmVsLCBudWxsLCBudWxsLCB0cnVlKTsKCSAgICAgICAgYWZ0ZXJCaW5kaW5nID0gYXBwLnZpZXdfbW9kZWwuYWZ0ZXJCaW5kaW5nIHx8IG9wdGlvbnMuYWZ0ZXJCaW5kaW5nOwoJICAgICAgICBiZWZvcmVCaW5kaW5nID0gYXBwLnZpZXdfbW9kZWwuYmVmb3JlQmluZGluZyB8fCBvcHRpb25zLmJlZm9yZUJpbmRpbmc7CgkgICAgICB9CgkgICAgICBpZiAoYmVmb3JlQmluZGluZykgewoJICAgICAgICBiZWZvcmVCaW5kaW5nLmNhbGwoYXBwLnZpZXdfbW9kZWwsIGFwcC52aWV3X21vZGVsLCBhcHAuZWwsIG9wdGlvbnMpOwoJICAgICAgfQoJICAgICAga2IuYXBwbHlCaW5kaW5ncyhhcHAudmlld19tb2RlbCwgYXBwLmVsLCBvcHRpb25zKTsKCSAgICAgIGlmIChhZnRlckJpbmRpbmcpIHsKCSAgICAgICAgYWZ0ZXJCaW5kaW5nLmNhbGwoYXBwLnZpZXdfbW9kZWwsIGFwcC52aWV3X21vZGVsLCBhcHAuZWwsIG9wdGlvbnMpOwoJICAgICAgfQoJICAgIH0KCSAgICByZXR1cm4gcmVzdWx0czsKCSAgfTsKCgkgIHJldHVybiBJbmplY3Q7CgoJfSkoKTsKCglfa29fYXBwbHlCaW5kaW5ncyA9IGtvLmFwcGx5QmluZGluZ3M7CgoJa28uYXBwbHlCaW5kaW5ncyA9IGZ1bmN0aW9uKGNvbnRleHQsIGVsZW1lbnQpIHsKCSAgdmFyIHJlc3VsdHM7CgkgIHJlc3VsdHMgPSBrYi5SRUNVU0lWRV9BVVRPX0lOSkVDVCA/IGtiLmluamVjdFZpZXdNb2RlbHMoZWxlbWVudCkgOiBbXTsKCSAgaWYgKCFyZXN1bHRzLmxlbmd0aCkgewoJICAgIHJldHVybiBfa29fYXBwbHlCaW5kaW5ncy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoJICB9Cgl9OwoKCWtiLmluamVjdFZpZXdNb2RlbHMgPSBrYi5JbmplY3QuaW5qZWN0Vmlld01vZGVsczsKCglpZiAodHlwZW9mIGRvY3VtZW50ICE9PSAidW5kZWZpbmVkIiAmJiBkb2N1bWVudCAhPT0gbnVsbCkgewoJICBpZiAoJCkgewoJICAgICQoZnVuY3Rpb24oKSB7CgkgICAgICByZXR1cm4ga2IuaW5qZWN0Vmlld01vZGVscygpOwoJICAgIH0pOwoJICB9IGVsc2UgewoJICAgIChvblJlYWR5ID0gZnVuY3Rpb24oKSB7CgkgICAgICBpZiAoZG9jdW1lbnQucmVhZHlTdGF0ZSAhPT0gJ2NvbXBsZXRlJykgewoJICAgICAgICByZXR1cm4gc2V0VGltZW91dChvblJlYWR5LCAwKTsKCSAgICAgIH0KCSAgICAgIHJldHVybiBrYi5pbmplY3RWaWV3TW9kZWxzKCk7CgkgICAgfSkoKTsKCSAgfQoJfQoJCgkvKiBXRUJQQUNLIFZBUiBJTkpFQ1RJT04gKi99LmNhbGwoZXhwb3J0cywgKGZ1bmN0aW9uKCkgeyByZXR1cm4gdGhpczsgfSgpKSkpCgovKioqLyB9LAovKiA2ICovCi8qKiovIGZ1bmN0aW9uKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewoKCS8qIFdFQlBBQ0sgVkFSIElOSkVDVElPTiAqLyhmdW5jdGlvbihnbG9iYWwpIHsKCS8qCgkgIGtub2NrYmFjay5qcyAwLjIwLjQKCSAgQ29weXJpZ2h0IChjKSAgMjAxMS0yMDE0IEtldmluIE1hbGFrb2ZmLgoJICBMaWNlbnNlOiBNSVQgKGh0dHA6Ly93d3cub3BlbnNvdXJjZS5vcmcvbGljZW5zZXMvbWl0LWxpY2Vuc2UucGhwKQoJICBTb3VyY2U6IGh0dHBzOi8vZ2l0aHViLmNvbS9rbWFsYWtvZmYva25vY2tiYWNrCgkgIERlcGVuZGVuY2llczogS25vY2tvdXQuanMsIEJhY2tib25lLmpzLCBhbmQgVW5kZXJzY29yZS5qcyAob3IgTG9EYXNoLmpzKS4KCSAgT3B0aW9uYWwgZGVwZW5kZW5jaWVzOiBCYWNrYm9uZS5Nb2RlbFJlZi5qcyBhbmQgQmFja2JvbmVPUk0uCgkgKi8KCXZhciBCYWNrYm9uZSwgTElGRUNZQ0xFX01FVEhPRFMsIGtiLCBrbywgd2luZG93LCBfOwoKCXdpbmRvdyA9IHdpbmRvdyAhPSBudWxsID8gd2luZG93IDogZ2xvYmFsOwoKCWtvID0gX193ZWJwYWNrX3JlcXVpcmVfXygyNSk7CgoJTElGRUNZQ0xFX01FVEhPRFMgPSBbJ3JlbGVhc2UnLCAnZGVzdHJveScsICdkaXNwb3NlJ107CgoJbW9kdWxlLmV4cG9ydHMgPSBrYiA9IChmdW5jdGlvbigpIHsKCSAgdmFyIF9yZWY7CgoJICBmdW5jdGlvbiBrYigpIHt9CgoJICBrYi5WRVJTSU9OID0gJzAuMjAuNCc7CgoJICBrYi5UWVBFX1VOS05PV04gPSAwOwoKCSAga2IuVFlQRV9TSU1QTEUgPSAxOwoKCSAga2IuVFlQRV9BUlJBWSA9IDI7CgoJICBrYi5UWVBFX01PREVMID0gMzsKCgkgIGtiLlRZUEVfQ09MTEVDVElPTiA9IDQ7CgoJICBrYi53YXNSZWxlYXNlZCA9IGZ1bmN0aW9uKG9iaikgewoJICAgIHJldHVybiAhb2JqIHx8IG9iai5fX2tiX3JlbGVhc2VkOwoJICB9OwoKCSAga2IuaXNSZWxlYXNlYWJsZSA9IGZ1bmN0aW9uKG9iaiwgZGVwdGgpIHsKCSAgICB2YXIga2V5LCBtZXRob2QsIHZhbHVlLCBfaSwgX2xlbjsKCSAgICBpZiAoZGVwdGggPT0gbnVsbCkgewoJICAgICAgZGVwdGggPSAwOwoJICAgIH0KCSAgICBpZiAoKCFvYmogfHwgKG9iaiAhPT0gT2JqZWN0KG9iaikpKSB8fCBvYmouX19rYl9yZWxlYXNlZCkgewoJICAgICAgcmV0dXJuIGZhbHNlOwoJICAgIH0KCSAgICBpZiAoa28uaXNPYnNlcnZhYmxlKG9iaikgfHwgKG9iaiBpbnN0YW5jZW9mIGtiLlZpZXdNb2RlbCkpIHsKCSAgICAgIHJldHVybiB0cnVlOwoJICAgIH0KCSAgICBpZiAoKHR5cGVvZiBvYmogPT09ICdmdW5jdGlvbicpIHx8IGtiLmlzTW9kZWwob2JqKSB8fCBrYi5pc0NvbGxlY3Rpb24ob2JqKSkgewoJICAgICAgcmV0dXJuIGZhbHNlOwoJICAgIH0KCSAgICBmb3IgKF9pID0gMCwgX2xlbiA9IExJRkVDWUNMRV9NRVRIT0RTLmxlbmd0aDsgX2kgPCBfbGVuOyBfaSsrKSB7CgkgICAgICBtZXRob2QgPSBMSUZFQ1lDTEVfTUVUSE9EU1tfaV07CgkgICAgICBpZiAodHlwZW9mIG9ialttZXRob2RdID09PSAnZnVuY3Rpb24nKSB7CgkgICAgICAgIHJldHVybiB0cnVlOwoJICAgICAgfQoJICAgIH0KCSAgICBpZiAoZGVwdGggPiAwKSB7CgkgICAgICByZXR1cm4gZmFsc2U7CgkgICAgfQoJICAgIGZvciAoa2V5IGluIG9iaikgewoJICAgICAgdmFsdWUgPSBvYmpba2V5XTsKCSAgICAgIGlmICgoa2V5ICE9PSAnX19rYicpICYmIGtiLmlzUmVsZWFzZWFibGUodmFsdWUsIGRlcHRoICsgMSkpIHsKCSAgICAgICAgcmV0dXJuIHRydWU7CgkgICAgICB9CgkgICAgfQoJICAgIHJldHVybiBmYWxzZTsKCSAgfTsKCgkgIGtiLnJlbGVhc2UgPSBmdW5jdGlvbihvYmopIHsKCSAgICB2YXIgYXJyYXksIGluZGV4LCBtZXRob2QsIHZhbHVlLCBfaSwgX2xlbjsKCSAgICBpZiAoIWtiLmlzUmVsZWFzZWFibGUob2JqKSkgewoJICAgICAgcmV0dXJuOwoJICAgIH0KCSAgICBvYmouX19rYl9yZWxlYXNlZCA9IHRydWU7CgkgICAgaWYgKF8uaXNBcnJheShvYmopKSB7CgkgICAgICBmb3IgKGluZGV4IGluIG9iaikgewoJICAgICAgICB2YWx1ZSA9IG9ialtpbmRleF07CgkgICAgICAgIGlmIChrYi5pc1JlbGVhc2VhYmxlKHZhbHVlKSkgewoJICAgICAgICAgIG9ialtpbmRleF0gPSBudWxsOwoJICAgICAgICAgIGtiLnJlbGVhc2UodmFsdWUpOwoJICAgICAgICB9CgkgICAgICB9CgkgICAgICByZXR1cm47CgkgICAgfQoJICAgIGlmIChrby5pc09ic2VydmFibGUob2JqKSAmJiBfLmlzQXJyYXkoYXJyYXkgPSBrYi5wZWVrKG9iaikpKSB7CgkgICAgICBpZiAob2JqLl9fa2JfaXNfY28gfHwgKG9iai5fX2tiX2lzX28gJiYgKG9iai52YWx1ZVR5cGUoKSA9PT0ga2IuVFlQRV9DT0xMRUNUSU9OKSkpIHsKCSAgICAgICAgcmV0dXJuIHR5cGVvZiBvYmouZGVzdHJveSA9PT0gImZ1bmN0aW9uIiA/IG9iai5kZXN0cm95KCkgOiB2b2lkIDA7CgkgICAgICB9CgkgICAgICBmb3IgKGluZGV4IGluIGFycmF5KSB7CgkgICAgICAgIHZhbHVlID0gYXJyYXlbaW5kZXhdOwoJICAgICAgICBpZiAoa2IuaXNSZWxlYXNlYWJsZSh2YWx1ZSkpIHsKCSAgICAgICAgICBhcnJheVtpbmRleF0gPSBudWxsOwoJICAgICAgICAgIGtiLnJlbGVhc2UodmFsdWUpOwoJICAgICAgICB9CgkgICAgICB9CgkgICAgICBpZiAodHlwZW9mIG9iai5kaXNwb3NlID09PSAnZnVuY3Rpb24nKSB7CgkgICAgICAgIG9iai5kaXNwb3NlKCk7CgkgICAgICB9CgkgICAgICByZXR1cm47CgkgICAgfQoJICAgIGZvciAoX2kgPSAwLCBfbGVuID0gTElGRUNZQ0xFX01FVEhPRFMubGVuZ3RoOyBfaSA8IF9sZW47IF9pKyspIHsKCSAgICAgIG1ldGhvZCA9IExJRkVDWUNMRV9NRVRIT0RTW19pXTsKCSAgICAgIGlmICh0eXBlb2Ygb2JqW21ldGhvZF0gPT09ICdmdW5jdGlvbicpIHsKCSAgICAgICAgcmV0dXJuIG9ialttZXRob2RdLmNhbGwob2JqKTsKCSAgICAgIH0KCSAgICB9CgkgICAgaWYgKCFrby5pc09ic2VydmFibGUob2JqKSkgewoJICAgICAgcmV0dXJuIHRoaXMucmVsZWFzZUtleXMob2JqKTsKCSAgICB9CgkgIH07CgoJICBrYi5yZWxlYXNlS2V5cyA9IGZ1bmN0aW9uKG9iaikgewoJICAgIHZhciBrZXksIHZhbHVlOwoJICAgIGZvciAoa2V5IGluIG9iaikgewoJICAgICAgdmFsdWUgPSBvYmpba2V5XTsKCSAgICAgIGlmIChrZXkgIT09ICdfX2tiJyAmJiBrYi5pc1JlbGVhc2VhYmxlKHZhbHVlKSkgewoJICAgICAgICBvYmpba2V5XSA9IG51bGw7CgkgICAgICAgIGtiLnJlbGVhc2UodmFsdWUpOwoJICAgICAgfQoJICAgIH0KCSAgfTsKCgkgIGtiLnJlbGVhc2VPbk5vZGVSZW1vdmUgPSBmdW5jdGlvbih2aWV3X21vZGVsLCBub2RlKSB7CgkgICAgdmlld19tb2RlbCB8fCBrYi5fdGhyb3dVbmV4cGVjdGVkKHRoaXMsICdtaXNzaW5nIHZpZXcgbW9kZWwnKTsKCSAgICBub2RlIHx8IGtiLl90aHJvd1VuZXhwZWN0ZWQodGhpcywgJ21pc3Npbmcgbm9kZScpOwoJICAgIHJldHVybiBrby51dGlscy5kb21Ob2RlRGlzcG9zYWwuYWRkRGlzcG9zZUNhbGxiYWNrKG5vZGUsIGZ1bmN0aW9uKCkgewoJICAgICAgcmV0dXJuIGtiLnJlbGVhc2Uodmlld19tb2RlbCk7CgkgICAgfSk7CgkgIH07CgoJICBrYi5yZW5kZXJUZW1wbGF0ZSA9IGZ1bmN0aW9uKHRlbXBsYXRlLCB2aWV3X21vZGVsLCBvcHRpb25zKSB7CgkgICAgdmFyIGRvY3VtZW50LCBlbCwgb2JzZXJ2YWJsZTsKCSAgICBpZiAob3B0aW9ucyA9PSBudWxsKSB7CgkgICAgICBvcHRpb25zID0ge307CgkgICAgfQoJICAgIGlmICghKGRvY3VtZW50ID0gd2luZG93ICE9IG51bGwgPyB3aW5kb3cuZG9jdW1lbnQgOiB2b2lkIDApKSB7CgkgICAgICByZXR1cm4gdHlwZW9mIGNvbnNvbGUgIT09ICJ1bmRlZmluZWQiICYmIGNvbnNvbGUgIT09IG51bGwgPyBjb25zb2xlLmxvZygncmVuZGVyVGVtcGxhdGU6IGRvY3VtZW50IGlzIHVuZGVmaW5lZCcpIDogdm9pZCAwOwoJICAgIH0KCSAgICBlbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwoJICAgIG9ic2VydmFibGUgPSBrby5yZW5kZXJUZW1wbGF0ZSh0ZW1wbGF0ZSwgdmlld19tb2RlbCwgb3B0aW9ucywgZWwsICdyZXBsYWNlQ2hpbGRyZW4nKTsKCSAgICBpZiAoZWwuY2hpbGROb2Rlcy5sZW5ndGggPT09IDEpIHsKCSAgICAgIGVsID0gZWwuY2hpbGROb2Rlc1swXTsKCSAgICB9IGVsc2UgaWYgKGVsLmNoaWxkTm9kZXMubGVuZ3RoKSB7CgkgICAgICBrby5zdG9yZWRCaW5kaW5nQ29udGV4dEZvck5vZGUoZWwsIGtvLmNvbnRleHRGb3IoZWwuY2hpbGROb2Rlc1swXSkpOwoJICAgIH0KCSAgICBrYi5yZWxlYXNlT25Ob2RlUmVtb3ZlKHZpZXdfbW9kZWwsIGVsKTsKCSAgICBvYnNlcnZhYmxlLmRpc3Bvc2UoKTsKCSAgICBpZiAodmlld19tb2RlbC5hZnRlclJlbmRlciAmJiAhb3B0aW9ucy5hZnRlclJlbmRlcikgewoJICAgICAgdmlld19tb2RlbC5hZnRlclJlbmRlcihlbCk7CgkgICAgfQoJICAgIHJldHVybiBlbDsKCSAgfTsKCgkgIGtiLmFwcGx5QmluZGluZ3MgPSBmdW5jdGlvbih2aWV3X21vZGVsLCBub2RlKSB7CgkgICAgdmFyIGNoaWxkLCBjaGlsZHJlbiwgX2ksIF9sZW4sIF9yZWY7CgkgICAgaWYgKG5vZGUubGVuZ3RoKSB7CgkgICAgICBfcmVmID0gW2RvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpLCBub2RlXSwgbm9kZSA9IF9yZWZbMF0sIGNoaWxkcmVuID0gX3JlZlsxXTsKCSAgICAgIGZvciAoX2kgPSAwLCBfbGVuID0gY2hpbGRyZW4ubGVuZ3RoOyBfaSA8IF9sZW47IF9pKyspIHsKCSAgICAgICAgY2hpbGQgPSBjaGlsZHJlbltfaV07CgkgICAgICAgIG5vZGUuYXBwZW5kQ2hpbGQoY2hpbGQpOwoJICAgICAgfQoJICAgIH0KCSAgICBrby5hcHBseUJpbmRpbmdzKHZpZXdfbW9kZWwsIG5vZGUpOwoJICAgIGtiLnJlbGVhc2VPbk5vZGVSZW1vdmUodmlld19tb2RlbCwgbm9kZSk7CgkgICAgcmV0dXJuIG5vZGU7CgkgIH07CgoJICBrYi5nZXRWYWx1ZSA9IGZ1bmN0aW9uKG1vZGVsLCBrZXksIGFyZ3MpIHsKCSAgICB2YXIgX3JlZjsKCSAgICBpZiAoIW1vZGVsKSB7CgkgICAgICByZXR1cm47CgkgICAgfQoJICAgIGlmIChfLmlzRnVuY3Rpb24obW9kZWxba2V5XSkgJiYgKChfcmVmID0ga2Iub3JtKSAhPSBudWxsID8gX3JlZi51c2VGdW5jdGlvbihtb2RlbCwga2V5KSA6IHZvaWQgMCkpIHsKCSAgICAgIHJldHVybiBtb2RlbFtrZXldKCk7CgkgICAgfQoJICAgIGlmICghYXJncykgewoJICAgICAgcmV0dXJuIG1vZGVsLmdldChrZXkpOwoJICAgIH0KCSAgICByZXR1cm4gbW9kZWwuZ2V0LmFwcGx5KG1vZGVsLCBfLm1hcChba2V5XS5jb25jYXQoYXJncyksIGZ1bmN0aW9uKHZhbHVlKSB7CgkgICAgICByZXR1cm4ga2IucGVlayh2YWx1ZSk7CgkgICAgfSkpOwoJICB9OwoKCSAga2Iuc2V0VmFsdWUgPSBmdW5jdGlvbihtb2RlbCwga2V5LCB2YWx1ZSkgewoJICAgIHZhciBhdHRyaWJ1dGVzLCBfcmVmOwoJICAgIGlmICghbW9kZWwpIHsKCSAgICAgIHJldHVybjsKCSAgICB9CgkgICAgaWYgKF8uaXNGdW5jdGlvbihtb2RlbFtrZXldKSAmJiAoKF9yZWYgPSBrYi5vcm0pICE9IG51bGwgPyBfcmVmLnVzZUZ1bmN0aW9uKG1vZGVsLCBrZXkpIDogdm9pZCAwKSkgewoJICAgICAgcmV0dXJuIG1vZGVsW2tleV0odmFsdWUpOwoJICAgIH0KCSAgICAoYXR0cmlidXRlcyA9IHt9KVtrZXldID0gdmFsdWU7CgkgICAgcmV0dXJuIG1vZGVsLnNldChhdHRyaWJ1dGVzKTsKCSAgfTsKCgkgIGtiLmlnbm9yZSA9ICgoX3JlZiA9IGtvLmRlcGVuZGVuY3lEZXRlY3Rpb24pICE9IG51bGwgPyBfcmVmLmlnbm9yZSA6IHZvaWQgMCkgfHwgZnVuY3Rpb24oY2FsbGJhY2ssIGNhbGxiYWNrVGFyZ2V0LCBjYWxsYmFja0FyZ3MpIHsKCSAgICB2YXIgdmFsdWU7CgkgICAgdmFsdWUgPSBudWxsOwoJICAgIGtvLmNvbXB1dGVkKGZ1bmN0aW9uKCkgewoJICAgICAgcmV0dXJuIHZhbHVlID0gY2FsbGJhY2suYXBwbHkoY2FsbGJhY2tUYXJnZXQsIGNhbGxiYWNrQXJncyB8fCBbXSk7CgkgICAgfSkuZGlzcG9zZSgpOwoJICAgIHJldHVybiB2YWx1ZTsKCSAgfTsKCgkgIGtiLmV4dGVuZCA9IF9fd2VicGFja19yZXF1aXJlX18oMTkpOwoKCSAga2IuX3Rocm93TWlzc2luZyA9IGZ1bmN0aW9uKGluc3RhbmNlLCBtZXNzYWdlKSB7CgkgICAgdGhyb3cgIiIgKyAoXy5pc1N0cmluZyhpbnN0YW5jZSkgPyBpbnN0YW5jZSA6IGluc3RhbmNlLmNvbnN0cnVjdG9yLm5hbWUpICsgIjogIiArIG1lc3NhZ2UgKyAiIGlzIG1pc3NpbmciOwoJICB9OwoKCSAga2IuX3Rocm93VW5leHBlY3RlZCA9IGZ1bmN0aW9uKGluc3RhbmNlLCBtZXNzYWdlKSB7CgkgICAgdGhyb3cgIiIgKyAoXy5pc1N0cmluZyhpbnN0YW5jZSkgPyBpbnN0YW5jZSA6IGluc3RhbmNlLmNvbnN0cnVjdG9yLm5hbWUpICsgIjogIiArIG1lc3NhZ2UgKyAiIGlzIHVuZXhwZWN0ZWQiOwoJICB9OwoKCSAga2IucHVibGlzaE1ldGhvZHMgPSBmdW5jdGlvbihvYnNlcnZhYmxlLCBpbnN0YW5jZSwgbWV0aG9kcykgewoJICAgIHZhciBmbiwgX2ksIF9sZW47CgkgICAgZm9yIChfaSA9IDAsIF9sZW4gPSBtZXRob2RzLmxlbmd0aDsgX2kgPCBfbGVuOyBfaSsrKSB7CgkgICAgICBmbiA9IG1ldGhvZHNbX2ldOwoJICAgICAgb2JzZXJ2YWJsZVtmbl0gPSBrYi5fLmJpbmQoaW5zdGFuY2VbZm5dLCBpbnN0YW5jZSk7CgkgICAgfQoJICB9OwoKCSAga2IucGVlayA9IGZ1bmN0aW9uKG9icykgewoJICAgIGlmICgha28uaXNPYnNlcnZhYmxlKG9icykpIHsKCSAgICAgIHJldHVybiBvYnM7CgkgICAgfQoJICAgIGlmIChvYnMucGVlaykgewoJICAgICAgcmV0dXJuIG9icy5wZWVrKCk7CgkgICAgfQoJICAgIHJldHVybiBrYi5pZ25vcmUoZnVuY3Rpb24oKSB7CgkgICAgICByZXR1cm4gb2JzKCk7CgkgICAgfSk7CgkgIH07CgoJICBrYi5pc01vZGVsID0gZnVuY3Rpb24ob2JqKSB7CgkgICAgcmV0dXJuIG9iaiAmJiAoKG9iaiBpbnN0YW5jZW9mIGtiLk1vZGVsKSB8fCAoKHR5cGVvZiBvYmouZ2V0ID09PSAnZnVuY3Rpb24nKSAmJiAodHlwZW9mIG9iai5iaW5kID09PSAnZnVuY3Rpb24nKSkpOwoJICB9OwoKCSAga2IuaXNDb2xsZWN0aW9uID0gZnVuY3Rpb24ob2JqKSB7CgkgICAgcmV0dXJuIG9iaiAmJiAob2JqIGluc3RhbmNlb2Yga2IuQ29sbGVjdGlvbik7CgkgIH07CgoJICByZXR1cm4ga2I7CgoJfSkoKTsKCglpZiAod2luZG93LlBhcnNlKSB7CgkgIEJhY2tib25lID0ga2IuUGFyc2UgPSB3aW5kb3cuUGFyc2U7CgkgIF8gPSBrYi5fID0gd2luZG93LlBhcnNlLl87Cgl9IGVsc2UgewoJICBCYWNrYm9uZSA9IGtiLkJhY2tib25lID0gX193ZWJwYWNrX3JlcXVpcmVfXygyMyk7CgkgIF8gPSBrYi5fID0gX193ZWJwYWNrX3JlcXVpcmVfXygyNCk7Cgl9CgoJa2Iua28gPSBrbzsKCglrYi5Db2xsZWN0aW9uID0gQmFja2JvbmUuQ29sbGVjdGlvbjsKCglrYi5Nb2RlbCA9IEJhY2tib25lLk9iamVjdCB8fCBCYWNrYm9uZS5Nb2RlbDsKCglrYi5FdmVudHMgPSBCYWNrYm9uZS5FdmVudHM7CgoJa2IuJCA9IHdpbmRvdy5qUXVlcnkgfHwgd2luZG93LiQ7CgoJdHJ5IHsKCSAga2IuJCB8fCAoa2IuJCA9IF9fd2VicGFja19yZXF1aXJlX18oMTUpKTsKCX0gY2F0Y2ggKF9lcnJvcikge30KCQoJLyogV0VCUEFDSyBWQVIgSU5KRUNUSU9OICovfS5jYWxsKGV4cG9ydHMsIChmdW5jdGlvbigpIHsgcmV0dXJuIHRoaXM7IH0oKSkpKQoKLyoqKi8gfSwKLyogNyAqLwovKioqLyBmdW5jdGlvbihtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKCgkKCS8qCgkgIGtub2NrYmFjay5qcyAwLjIwLjQKCSAgQ29weXJpZ2h0IChjKSAgMjAxMS0yMDE0IEtldmluIE1hbGFrb2ZmLgoJICBMaWNlbnNlOiBNSVQgKGh0dHA6Ly93d3cub3BlbnNvdXJjZS5vcmcvbGljZW5zZXMvbWl0LWxpY2Vuc2UucGhwKQoJICBTb3VyY2U6IGh0dHBzOi8vZ2l0aHViLmNvbS9rbWFsYWtvZmYva25vY2tiYWNrCgkgIERlcGVuZGVuY2llczogS25vY2tvdXQuanMsIEJhY2tib25lLmpzLCBhbmQgVW5kZXJzY29yZS5qcyAob3IgTG9EYXNoLmpzKS4KCSAgT3B0aW9uYWwgZGVwZW5kZW5jaWVzOiBCYWNrYm9uZS5Nb2RlbFJlZi5qcyBhbmQgQmFja2JvbmVPUk0uCgkgKi8KCXZhciBrYiwga28sIF9leHRlbmQsIF9yZWYsIF9yZWYxOwoKCWtvID0gKGtiID0gX193ZWJwYWNrX3JlcXVpcmVfXyg2KSkua287CgoJaWYgKChfcmVmID0ga28uc3Vic2NyaWJhYmxlKSAhPSBudWxsID8gKF9yZWYxID0gX3JlZi5mbikgIT0gbnVsbCA/IF9yZWYxLmV4dGVuZCA6IHZvaWQgMCA6IHZvaWQgMCkgewoJICBfZXh0ZW5kID0ga28uc3Vic2NyaWJhYmxlLmZuLmV4dGVuZDsKCSAga28uc3Vic2NyaWJhYmxlLmZuLmV4dGVuZCA9IGZ1bmN0aW9uKCkgewoJICAgIHZhciB0YXJnZXQsIF9kaXNwb3NlOwoJICAgIHRhcmdldCA9IF9leHRlbmQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCSAgICBpZiAodGFyZ2V0ICE9PSB0aGlzICYmIGtiLmlzUmVsZWFzZWFibGUodGhpcykpIHsKCSAgICAgIF9kaXNwb3NlID0gdGFyZ2V0LmRpc3Bvc2U7CgkgICAgICB0YXJnZXQuZGlzcG9zZSA9IChmdW5jdGlvbihfdGhpcykgewoJICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CgkgICAgICAgICAgaWYgKF9kaXNwb3NlICE9IG51bGwpIHsKCSAgICAgICAgICAgIF9kaXNwb3NlLmFwcGx5KHRhcmdldCwgYXJndW1lbnRzKTsKCSAgICAgICAgICB9CgkgICAgICAgICAgcmV0dXJuIGtiLnJlbGVhc2UoX3RoaXMpOwoJICAgICAgICB9OwoJICAgICAgfSkodGhpcyk7CgkgICAgfQoJICAgIHJldHVybiB0YXJnZXQ7CgkgIH07Cgl9CgoKLyoqKi8gfSwKLyogOCAqLwovKioqLyBmdW5jdGlvbihtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKCgkKCS8qCgkgIGtub2NrYmFjay5qcyAwLjIwLjQKCSAgQ29weXJpZ2h0IChjKSAgMjAxMS0yMDE0IEtldmluIE1hbGFrb2ZmLgoJICBMaWNlbnNlOiBNSVQgKGh0dHA6Ly93d3cub3BlbnNvdXJjZS5vcmcvbGljZW5zZXMvbWl0LWxpY2Vuc2UucGhwKQoJICBTb3VyY2U6IGh0dHBzOi8vZ2l0aHViLmNvbS9rbWFsYWtvZmYva25vY2tiYWNrCgkgIERlcGVuZGVuY2llczogS25vY2tvdXQuanMsIEJhY2tib25lLmpzLCBhbmQgVW5kZXJzY29yZS5qcyAob3IgTG9EYXNoLmpzKS4KCSAgT3B0aW9uYWwgZGVwZW5kZW5jaWVzOiBCYWNrYm9uZS5Nb2RlbFJlZi5qcyBhbmQgQmFja2JvbmVPUk0uCgkgKi8KCXZhciBLRVlTX0lORk8sIEtFWVNfUFVCTElTSCwgVHlwZWRWYWx1ZSwga2IsIGtvLCBfLCBfcmVmOwoKCV9yZWYgPSBrYiA9IF9fd2VicGFja19yZXF1aXJlX18oNiksIF8gPSBfcmVmLl8sIGtvID0gX3JlZi5rbzsKCglUeXBlZFZhbHVlID0gX193ZWJwYWNrX3JlcXVpcmVfXygxMSk7CgoJS0VZU19QVUJMSVNIID0gWyd2YWx1ZScsICd2YWx1ZVR5cGUnLCAnZGVzdHJveSddOwoKCUtFWVNfSU5GTyA9IFsnYXJncycsICdyZWFkJywgJ3dyaXRlJ107CgoJa2IuT2JzZXJ2YWJsZSA9IChmdW5jdGlvbigpIHsKCSAgZnVuY3Rpb24gT2JzZXJ2YWJsZShtb2RlbCwga2V5X29yX2luZm8sIG9wdGlvbnMsIF92bSkgewoJICAgIHRoaXMuX3ZtID0gX3ZtICE9IG51bGwgPyBfdm0gOiB7fTsKCSAgICByZXR1cm4ga2IuaWdub3JlKChmdW5jdGlvbihfdGhpcykgewoJICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewoJICAgICAgICB2YXIgY3JlYXRlX29wdGlvbnMsIGV2ZW50X3dhdGNoZXIsIGtleSwgb2JzZXJ2YWJsZSwgX2ksIF9sZW47CgkgICAgICAgIGtleV9vcl9pbmZvIHx8IGtiLl90aHJvd01pc3NpbmcoX3RoaXMsICdrZXlfb3JfaW5mbycpOwoJICAgICAgICBfdGhpcy5rZXkgPSBrZXlfb3JfaW5mby5rZXkgfHwga2V5X29yX2luZm87CgkgICAgICAgIGZvciAoX2kgPSAwLCBfbGVuID0gS0VZU19JTkZPLmxlbmd0aDsgX2kgPCBfbGVuOyBfaSsrKSB7CgkgICAgICAgICAga2V5ID0gS0VZU19JTkZPW19pXTsKCSAgICAgICAgICBpZiAoa2V5X29yX2luZm9ba2V5XSkgewoJICAgICAgICAgICAgX3RoaXNba2V5XSA9IGtleV9vcl9pbmZvW2tleV07CgkgICAgICAgICAgfQoJICAgICAgICB9CgkgICAgICAgIGNyZWF0ZV9vcHRpb25zID0ga2IudXRpbHMuY29sbGFwc2VPcHRpb25zKG9wdGlvbnMpOwoJICAgICAgICBldmVudF93YXRjaGVyID0gY3JlYXRlX29wdGlvbnMuZXZlbnRfd2F0Y2hlcjsKCSAgICAgICAgZGVsZXRlIGNyZWF0ZV9vcHRpb25zLmV2ZW50X3dhdGNoZXI7CgkgICAgICAgIF90aGlzLl92YWx1ZSA9IG5ldyBUeXBlZFZhbHVlKGNyZWF0ZV9vcHRpb25zKTsKCSAgICAgICAgX3RoaXMuX21vZGVsID0ga28ub2JzZXJ2YWJsZSgpOwoJICAgICAgICBvYnNlcnZhYmxlID0ga2IudXRpbHMud3JhcHBlZE9ic2VydmFibGUoX3RoaXMsIGtvLmNvbXB1dGVkKHsKCSAgICAgICAgICByZWFkOiBmdW5jdGlvbigpIHsKCSAgICAgICAgICAgIHZhciBhcmcsIGFyZ3MsIF9qLCBfbGVuMSwgX21vZGVsLCBfcmVmMSwgX3JlZjI7CgkgICAgICAgICAgICBfbW9kZWwgPSBfdGhpcy5fbW9kZWwoKTsKCSAgICAgICAgICAgIF9yZWYxID0gYXJncyA9IFtfdGhpcy5rZXldLmNvbmNhdChfdGhpcy5hcmdzIHx8IFtdKTsKCSAgICAgICAgICAgIGZvciAoX2ogPSAwLCBfbGVuMSA9IF9yZWYxLmxlbmd0aDsgX2ogPCBfbGVuMTsgX2orKykgewoJICAgICAgICAgICAgICBhcmcgPSBfcmVmMVtfal07CgkgICAgICAgICAgICAgIGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUoYXJnKTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIGlmICgoX3JlZjIgPSBrYi51dGlscy53cmFwcGVkRXZlbnRXYXRjaGVyKF90aGlzKSkgIT0gbnVsbCkgewoJICAgICAgICAgICAgICBfcmVmMi5lbWl0dGVyKF9tb2RlbCB8fCBudWxsKTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIGlmIChfdGhpcy5yZWFkKSB7CgkgICAgICAgICAgICAgIF90aGlzLnVwZGF0ZShfdGhpcy5yZWFkLmFwcGx5KF90aGlzLl92bSwgYXJncykpOwoJICAgICAgICAgICAgfSBlbHNlIGlmICghXy5pc1VuZGVmaW5lZChfbW9kZWwpKSB7CgkgICAgICAgICAgICAgIGtiLmlnbm9yZShmdW5jdGlvbigpIHsKCSAgICAgICAgICAgICAgICByZXR1cm4gX3RoaXMudXBkYXRlKGtiLmdldFZhbHVlKF9tb2RlbCwga2IucGVlayhfdGhpcy5rZXkpLCBfdGhpcy5hcmdzKSk7CgkgICAgICAgICAgICAgIH0pOwoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgcmV0dXJuIF90aGlzLl92YWx1ZS52YWx1ZSgpOwoJICAgICAgICAgIH0sCgkgICAgICAgICAgd3JpdGU6IGZ1bmN0aW9uKG5ld192YWx1ZSkgewoJICAgICAgICAgICAgcmV0dXJuIGtiLmlnbm9yZShmdW5jdGlvbigpIHsKCSAgICAgICAgICAgICAgdmFyIHVud3JhcHBlZF9uZXdfdmFsdWUsIF9tb2RlbDsKCSAgICAgICAgICAgICAgdW53cmFwcGVkX25ld192YWx1ZSA9IGtiLnV0aWxzLnVud3JhcE1vZGVscyhuZXdfdmFsdWUpOwoJICAgICAgICAgICAgICBfbW9kZWwgPSBrYi5wZWVrKF90aGlzLl9tb2RlbCk7CgkgICAgICAgICAgICAgIGlmIChfdGhpcy53cml0ZSkgewoJICAgICAgICAgICAgICAgIF90aGlzLndyaXRlLmNhbGwoX3RoaXMuX3ZtLCB1bndyYXBwZWRfbmV3X3ZhbHVlKTsKCSAgICAgICAgICAgICAgICBuZXdfdmFsdWUgPSBrYi5nZXRWYWx1ZShfbW9kZWwsIGtiLnBlZWsoX3RoaXMua2V5KSwgX3RoaXMuYXJncyk7CgkgICAgICAgICAgICAgIH0gZWxzZSBpZiAoX21vZGVsKSB7CgkgICAgICAgICAgICAgICAga2Iuc2V0VmFsdWUoX21vZGVsLCBrYi5wZWVrKF90aGlzLmtleSksIHVud3JhcHBlZF9uZXdfdmFsdWUpOwoJICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgIHJldHVybiBfdGhpcy51cGRhdGUobmV3X3ZhbHVlKTsKCSAgICAgICAgICAgIH0pOwoJICAgICAgICAgIH0sCgkgICAgICAgICAgb3duZXI6IF90aGlzLl92bQoJICAgICAgICB9KSk7CgkgICAgICAgIG9ic2VydmFibGUuX19rYl9pc19vID0gdHJ1ZTsKCSAgICAgICAgY3JlYXRlX29wdGlvbnMuc3RvcmUgPSBrYi51dGlscy53cmFwcGVkU3RvcmUob2JzZXJ2YWJsZSwgY3JlYXRlX29wdGlvbnMuc3RvcmUpOwoJICAgICAgICBjcmVhdGVfb3B0aW9ucy5wYXRoID0ga2IudXRpbHMucGF0aEpvaW4oY3JlYXRlX29wdGlvbnMucGF0aCwgX3RoaXMua2V5KTsKCSAgICAgICAgaWYgKGNyZWF0ZV9vcHRpb25zLmZhY3RvcmllcyAmJiAoKHR5cGVvZiBjcmVhdGVfb3B0aW9ucy5mYWN0b3JpZXMgPT09ICdmdW5jdGlvbicpIHx8IGNyZWF0ZV9vcHRpb25zLmZhY3Rvcmllcy5jcmVhdGUpKSB7CgkgICAgICAgICAgY3JlYXRlX29wdGlvbnMuZmFjdG9yeSA9IGtiLnV0aWxzLndyYXBwZWRGYWN0b3J5KG9ic2VydmFibGUsIG5ldyBrYi5GYWN0b3J5KGNyZWF0ZV9vcHRpb25zLmZhY3RvcnkpKTsKCSAgICAgICAgICBjcmVhdGVfb3B0aW9ucy5mYWN0b3J5LmFkZFBhdGhNYXBwaW5nKGNyZWF0ZV9vcHRpb25zLnBhdGgsIGNyZWF0ZV9vcHRpb25zLmZhY3Rvcmllcyk7CgkgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgY3JlYXRlX29wdGlvbnMuZmFjdG9yeSA9IGtiLkZhY3RvcnkudXNlT3B0aW9uc09yQ3JlYXRlKGNyZWF0ZV9vcHRpb25zLCBvYnNlcnZhYmxlLCBjcmVhdGVfb3B0aW9ucy5wYXRoKTsKCSAgICAgICAgfQoJICAgICAgICBkZWxldGUgY3JlYXRlX29wdGlvbnMuZmFjdG9yaWVzOwoJICAgICAgICBrYi5wdWJsaXNoTWV0aG9kcyhvYnNlcnZhYmxlLCBfdGhpcywgS0VZU19QVUJMSVNIKTsKCSAgICAgICAgb2JzZXJ2YWJsZS5tb2RlbCA9IF90aGlzLm1vZGVsID0ga28uY29tcHV0ZWQoewoJICAgICAgICAgIHJlYWQ6IGZ1bmN0aW9uKCkgewoJICAgICAgICAgICAgcmV0dXJuIGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUoX3RoaXMuX21vZGVsKTsKCSAgICAgICAgICB9LAoJICAgICAgICAgIHdyaXRlOiBmdW5jdGlvbihuZXdfbW9kZWwpIHsKCSAgICAgICAgICAgIHJldHVybiBrYi5pZ25vcmUoZnVuY3Rpb24oKSB7CgkgICAgICAgICAgICAgIHZhciBuZXdfdmFsdWU7CgkgICAgICAgICAgICAgIGlmIChfdGhpcy5fX2tiX3JlbGVhc2VkIHx8IChrYi5wZWVrKF90aGlzLl9tb2RlbCkgPT09IG5ld19tb2RlbCkpIHsKCSAgICAgICAgICAgICAgICByZXR1cm47CgkgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgbmV3X3ZhbHVlID0ga2IuZ2V0VmFsdWUobmV3X21vZGVsLCBrYi5wZWVrKF90aGlzLmtleSksIF90aGlzLmFyZ3MpOwoJICAgICAgICAgICAgICBfdGhpcy5fbW9kZWwobmV3X21vZGVsKTsKCSAgICAgICAgICAgICAgaWYgKCFuZXdfbW9kZWwpIHsKCSAgICAgICAgICAgICAgICByZXR1cm4gX3RoaXMudXBkYXRlKG51bGwpOwoJICAgICAgICAgICAgICB9IGVsc2UgaWYgKCFfLmlzVW5kZWZpbmVkKG5ld192YWx1ZSkpIHsKCSAgICAgICAgICAgICAgICByZXR1cm4gX3RoaXMudXBkYXRlKG5ld192YWx1ZSk7CgkgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgIH0pOwoJICAgICAgICAgIH0KCSAgICAgICAgfSk7CgkgICAgICAgIGtiLkV2ZW50V2F0Y2hlci51c2VPcHRpb25zT3JDcmVhdGUoewoJICAgICAgICAgIGV2ZW50X3dhdGNoZXI6IGV2ZW50X3dhdGNoZXIKCSAgICAgICAgfSwgbW9kZWwgfHwgbnVsbCwgX3RoaXMsIHsKCSAgICAgICAgICBlbWl0dGVyOiBfdGhpcy5tb2RlbCwKCSAgICAgICAgICB1cGRhdGU6IChmdW5jdGlvbigpIHsKCSAgICAgICAgICAgIHJldHVybiBrYi5pZ25vcmUoZnVuY3Rpb24oKSB7CgkgICAgICAgICAgICAgIHJldHVybiBfdGhpcy51cGRhdGUoKTsKCSAgICAgICAgICAgIH0pOwoJICAgICAgICAgIH0pLAoJICAgICAgICAgIGtleTogX3RoaXMua2V5LAoJICAgICAgICAgIHBhdGg6IGNyZWF0ZV9vcHRpb25zLnBhdGgKCSAgICAgICAgfSk7CgkgICAgICAgIF90aGlzLl92YWx1ZS5yYXdWYWx1ZSgpIHx8IF90aGlzLl92YWx1ZS51cGRhdGUoKTsKCSAgICAgICAgaWYgKGtiLkxvY2FsaXplZE9ic2VydmFibGUgJiYga2V5X29yX2luZm8ubG9jYWxpemVyKSB7CgkgICAgICAgICAgb2JzZXJ2YWJsZSA9IG5ldyBrZXlfb3JfaW5mby5sb2NhbGl6ZXIob2JzZXJ2YWJsZSk7CgkgICAgICAgIH0KCSAgICAgICAgaWYgKGtiLkRlZmF1bHRPYnNlcnZhYmxlICYmIGtleV9vcl9pbmZvLmhhc093blByb3BlcnR5KCdkZWZhdWx0JykpIHsKCSAgICAgICAgICBvYnNlcnZhYmxlID0ga2IuZGVmYXVsdE9ic2VydmFibGUob2JzZXJ2YWJsZSwga2V5X29yX2luZm9bImRlZmF1bHQiXSk7CgkgICAgICAgIH0KCSAgICAgICAgcmV0dXJuIG9ic2VydmFibGU7CgkgICAgICB9OwoJICAgIH0pKHRoaXMpKTsKCSAgfQoKCSAgT2JzZXJ2YWJsZS5wcm90b3R5cGUuZGVzdHJveSA9IGZ1bmN0aW9uKCkgewoJICAgIHZhciBvYnNlcnZhYmxlOwoJICAgIG9ic2VydmFibGUgPSBrYi51dGlscy53cmFwcGVkT2JzZXJ2YWJsZSh0aGlzKTsKCSAgICB0aGlzLl9fa2JfcmVsZWFzZWQgPSB0cnVlOwoJICAgIHRoaXMuX3ZhbHVlLmRlc3Ryb3koKTsKCSAgICB0aGlzLl92YWx1ZSA9IG51bGw7CgkgICAgdGhpcy5tb2RlbC5kaXNwb3NlKCk7CgkgICAgdGhpcy5tb2RlbCA9IG9ic2VydmFibGUubW9kZWwgPSBudWxsOwoJICAgIHJldHVybiBrYi51dGlscy53cmFwcGVkRGVzdHJveSh0aGlzKTsKCSAgfTsKCgkgIE9ic2VydmFibGUucHJvdG90eXBlLnZhbHVlID0gZnVuY3Rpb24oKSB7CgkgICAgcmV0dXJuIHRoaXMuX3ZhbHVlLnJhd1ZhbHVlKCk7CgkgIH07CgoJICBPYnNlcnZhYmxlLnByb3RvdHlwZS52YWx1ZVR5cGUgPSBmdW5jdGlvbigpIHsKCSAgICByZXR1cm4gdGhpcy5fdmFsdWUudmFsdWVUeXBlKGtiLnBlZWsodGhpcy5fbW9kZWwpLCBrYi5wZWVrKHRoaXMua2V5KSk7CgkgIH07CgoJICBPYnNlcnZhYmxlLnByb3RvdHlwZS51cGRhdGUgPSBmdW5jdGlvbihuZXdfdmFsdWUpIHsKCSAgICBpZiAodGhpcy5fX2tiX3JlbGVhc2VkKSB7CgkgICAgICByZXR1cm47CgkgICAgfQoJICAgIGlmICghYXJndW1lbnRzLmxlbmd0aCkgewoJICAgICAgbmV3X3ZhbHVlID0ga2IuZ2V0VmFsdWUoa2IucGVlayh0aGlzLl9tb2RlbCksIGtiLnBlZWsodGhpcy5rZXkpKTsKCSAgICB9CgkgICAgcmV0dXJuIHRoaXMuX3ZhbHVlLnVwZGF0ZShuZXdfdmFsdWUpOwoJICB9OwoKCSAgcmV0dXJuIE9ic2VydmFibGU7CgoJfSkoKTsKCglrYi5vYnNlcnZhYmxlID0gZnVuY3Rpb24obW9kZWwsIGtleSwgb3B0aW9ucywgdmlld19tb2RlbCkgewoJICByZXR1cm4gbmV3IGtiLk9ic2VydmFibGUobW9kZWwsIGtleSwgb3B0aW9ucywgdmlld19tb2RlbCk7Cgl9OwoKCi8qKiovIH0sCi8qIDkgKi8KLyoqKi8gZnVuY3Rpb24obW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CgoJCgkvKgoJICBrbm9ja2JhY2suanMgMC4yMC40CgkgIENvcHlyaWdodCAoYykgIDIwMTEtMjAxNCBLZXZpbiBNYWxha29mZi4KCSAgTGljZW5zZTogTUlUIChodHRwOi8vd3d3Lm9wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL21pdC1saWNlbnNlLnBocCkKCSAgU291cmNlOiBodHRwczovL2dpdGh1Yi5jb20va21hbGFrb2ZmL2tub2NrYmFjawoJICBEZXBlbmRlbmNpZXM6IEtub2Nrb3V0LmpzLCBCYWNrYm9uZS5qcywgYW5kIFVuZGVyc2NvcmUuanMgKG9yIExvRGFzaC5qcykuCgkgIE9wdGlvbmFsIGRlcGVuZGVuY2llczogQmFja2JvbmUuTW9kZWxSZWYuanMgYW5kIEJhY2tib25lT1JNLgoJICovCgl2YXIga2IsIF87CgoJXyA9IChrYiA9IF9fd2VicGFja19yZXF1aXJlX18oNikpLl87CgoJbW9kdWxlLmV4cG9ydHMgPSBrYi5TdGF0aXN0aWNzID0gKGZ1bmN0aW9uKCkgewoJICBmdW5jdGlvbiBTdGF0aXN0aWNzKCkgewoJICAgIHRoaXMubW9kZWxfZXZlbnRzX3RyYWNrZXIgPSBbXTsKCSAgICB0aGlzLnJlZ2lzdGVyZWRfdHJhY2tlciA9IHt9OwoJICB9CgoJICBTdGF0aXN0aWNzLnByb3RvdHlwZS5jbGVhciA9IGZ1bmN0aW9uKCkgewoJICAgIHJldHVybiB0aGlzLm1vZGVsX2V2ZW50c190cmFja2VyID0gW107CgkgIH07CgoJICBTdGF0aXN0aWNzLnByb3RvdHlwZS5hZGRNb2RlbEV2ZW50ID0gZnVuY3Rpb24oZXZlbnQpIHsKCSAgICByZXR1cm4gdGhpcy5tb2RlbF9ldmVudHNfdHJhY2tlci5wdXNoKGV2ZW50KTsKCSAgfTsKCgkgIFN0YXRpc3RpY3MucHJvdG90eXBlLm1vZGVsRXZlbnRzU3RhdHNTdHJpbmcgPSBmdW5jdGlvbigpIHsKCSAgICB2YXIgZXZlbnRfZ3JvdXBzLCBrZXksIHN0YXRzX3N0cmluZywgdmFsdWU7CgkgICAgc3RhdHNfc3RyaW5nID0gJyc7CgkgICAgc3RhdHNfc3RyaW5nICs9ICJUb3RhbCBDb3VudDogIiArIHRoaXMubW9kZWxfZXZlbnRzX3RyYWNrZXIubGVuZ3RoOwoJICAgIGV2ZW50X2dyb3VwcyA9IF8uZ3JvdXBCeSh0aGlzLm1vZGVsX2V2ZW50c190cmFja2VyLCBmdW5jdGlvbih0ZXN0KSB7CgkgICAgICByZXR1cm4gImV2ZW50IG5hbWU6ICciICsgdGVzdC5uYW1lICsgIicsIGF0dHJpYnV0ZSBuYW1lOiAnIiArIHRlc3Qua2V5ICsgIiciOwoJICAgIH0pOwoJICAgIGZvciAoa2V5IGluIGV2ZW50X2dyb3VwcykgewoJICAgICAgdmFsdWUgPSBldmVudF9ncm91cHNba2V5XTsKCSAgICAgIHN0YXRzX3N0cmluZyArPSAiXG4gIiArIGtleSArICIsIGNvdW50OiAiICsgdmFsdWUubGVuZ3RoOwoJICAgIH0KCSAgICByZXR1cm4gc3RhdHNfc3RyaW5nOwoJICB9OwoKCSAgU3RhdGlzdGljcy5wcm90b3R5cGUucmVnaXN0ZXIgPSBmdW5jdGlvbihrZXksIG9iaikgewoJICAgIHJldHVybiB0aGlzLnJlZ2lzdGVyZWRUcmFja2VyKGtleSkucHVzaChvYmopOwoJICB9OwoKCSAgU3RhdGlzdGljcy5wcm90b3R5cGUudW5yZWdpc3RlciA9IGZ1bmN0aW9uKGtleSwgb2JqKSB7CgkgICAgdmFyIGluZGV4LCB0eXBlX3RyYWNrZXI7CgkgICAgdHlwZV90cmFja2VyID0gdGhpcy5yZWdpc3RlcmVkVHJhY2tlcihrZXkpOwoJICAgIGlmICgoaW5kZXggPSBfLmluZGV4T2YodHlwZV90cmFja2VyLCBvYmopKSA8IDApIHsKCSAgICAgIHJldHVybiB0eXBlb2YgY29uc29sZSAhPT0gInVuZGVmaW5lZCIgJiYgY29uc29sZSAhPT0gbnVsbCA/IGNvbnNvbGUubG9nKCJrYi5TdGF0aXN0aWNzOiBmYWlsZWQgdG8gdW5yZWdpc3RlciB0eXBlOiAiICsga2V5KSA6IHZvaWQgMDsKCSAgICB9CgkgICAgcmV0dXJuIHR5cGVfdHJhY2tlci5zcGxpY2UoaW5kZXgsIDEpOwoJICB9OwoKCSAgU3RhdGlzdGljcy5wcm90b3R5cGUucmVnaXN0ZXJlZENvdW50ID0gZnVuY3Rpb24odHlwZSkgewoJICAgIHZhciBjb3VudCwgdHlwZV90cmFja2VyLCBfcmVmOwoJICAgIGlmICh0eXBlKSB7CgkgICAgICByZXR1cm4gdGhpcy5yZWdpc3RlcmVkVHJhY2tlcih0eXBlKS5sZW5ndGg7CgkgICAgfQoJICAgIGNvdW50ID0gMDsKCSAgICBfcmVmID0gdGhpcy5yZWdpc3RlcmVkX3RyYWNrZXJbdHlwZV07CgkgICAgZm9yICh0eXBlIGluIF9yZWYpIHsKCSAgICAgIHR5cGVfdHJhY2tlciA9IF9yZWZbdHlwZV07CgkgICAgICBjb3VudCArPSB0eXBlX3RyYWNrZXIubGVuZ3RoOwoJICAgIH0KCSAgICByZXR1cm4gY291bnQ7CgkgIH07CgoJICBTdGF0aXN0aWNzLnByb3RvdHlwZS5yZWdpc3RlcmVkU3RhdHNTdHJpbmcgPSBmdW5jdGlvbihzdWNjZXNzX21lc3NhZ2UpIHsKCSAgICB2YXIgc3RhdHNfc3RyaW5nLCB0eXBlLCB0eXBlX3RyYWNrZXIsIHdyaXR0ZW4sIF9yZWY7CgkgICAgc3RhdHNfc3RyaW5nID0gJyc7CgkgICAgX3JlZiA9IHRoaXMucmVnaXN0ZXJlZF90cmFja2VyOwoJICAgIGZvciAodHlwZSBpbiBfcmVmKSB7CgkgICAgICB0eXBlX3RyYWNrZXIgPSBfcmVmW3R5cGVdOwoJICAgICAgaWYgKCF0eXBlX3RyYWNrZXIubGVuZ3RoKSB7CgkgICAgICAgIGNvbnRpbnVlOwoJICAgICAgfQoJICAgICAgaWYgKHdyaXR0ZW4pIHsKCSAgICAgICAgc3RhdHNfc3RyaW5nICs9ICdcbiAnOwoJICAgICAgfQoJICAgICAgc3RhdHNfc3RyaW5nICs9ICIiICsgKHR5cGUgPyB0eXBlIDogJ05vIE5hbWUnKSArICI6ICIgKyB0eXBlX3RyYWNrZXIubGVuZ3RoOwoJICAgICAgd3JpdHRlbiA9IHRydWU7CgkgICAgfQoJICAgIGlmIChzdGF0c19zdHJpbmcpIHsKCSAgICAgIHJldHVybiBzdGF0c19zdHJpbmc7CgkgICAgfSBlbHNlIHsKCSAgICAgIHJldHVybiBzdWNjZXNzX21lc3NhZ2U7CgkgICAgfQoJICB9OwoKCSAgU3RhdGlzdGljcy5wcm90b3R5cGUucmVnaXN0ZXJlZFRyYWNrZXIgPSBmdW5jdGlvbihrZXkpIHsKCSAgICB2YXIgdHlwZV90cmFja2VyOwoJICAgIGlmICh0aGlzLnJlZ2lzdGVyZWRfdHJhY2tlci5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CgkgICAgICByZXR1cm4gdGhpcy5yZWdpc3RlcmVkX3RyYWNrZXJba2V5XTsKCSAgICB9CgkgICAgdHlwZV90cmFja2VyID0gW107CgkgICAgdGhpcy5yZWdpc3RlcmVkX3RyYWNrZXJba2V5XSA9IHR5cGVfdHJhY2tlcjsKCSAgICByZXR1cm4gdHlwZV90cmFja2VyOwoJICB9OwoKCSAgU3RhdGlzdGljcy5ldmVudHNTdGF0cyA9IGZ1bmN0aW9uKG9iaiwga2V5KSB7CgkgICAgdmFyIGV2ZW50cywgbm9kZSwgc3RhdHMsIHRhaWwsIF9pLCBfbGVuLCBfcmVmOwoJICAgIHN0YXRzID0gewoJICAgICAgY291bnQ6IDAKCSAgICB9OwoJICAgIGV2ZW50cyA9IG9iai5fZXZlbnRzIHx8IG9iai5fY2FsbGJhY2tzIHx8IHt9OwoJICAgIF9yZWYgPSAoa2V5ID8gW2tleV0gOiBfLmtleXMoZXZlbnRzKSk7CgkgICAgZm9yIChfaSA9IDAsIF9sZW4gPSBfcmVmLmxlbmd0aDsgX2kgPCBfbGVuOyBfaSsrKSB7CgkgICAgICBrZXkgPSBfcmVmW19pXTsKCSAgICAgIGlmICghKG5vZGUgPSBldmVudHNba2V5XSkpIHsKCSAgICAgICAgY29udGludWU7CgkgICAgICB9CgkgICAgICBpZiAoXy5pc0FycmF5KG5vZGUpKSB7CgkgICAgICAgIHN0YXRzW2tleV0gPSBfLmNvbXBhY3Qobm9kZSkubGVuZ3RoOwoJICAgICAgfSBlbHNlIHsKCSAgICAgICAgc3RhdHNba2V5XSA9IDA7CgkgICAgICAgIHRhaWwgPSBub2RlLnRhaWw7CgkgICAgICAgIHdoaWxlICgobm9kZSA9IG5vZGUubmV4dCkgIT09IHRhaWwpIHsKCSAgICAgICAgICBzdGF0c1trZXldKys7CgkgICAgICAgIH0KCSAgICAgIH0KCSAgICAgIHN0YXRzLmNvdW50ICs9IHN0YXRzW2tleV07CgkgICAgfQoJICAgIHJldHVybiBzdGF0czsKCSAgfTsKCgkgIHJldHVybiBTdGF0aXN0aWNzOwoKCX0pKCk7CgoKLyoqKi8gfSwKLyogMTAgKi8KLyoqKi8gZnVuY3Rpb24obW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CgoJCgkvKgoJICBrbm9ja2JhY2suanMgMC4yMC40CgkgIENvcHlyaWdodCAoYykgIDIwMTEtMjAxNCBLZXZpbiBNYWxha29mZi4KCSAgTGljZW5zZTogTUlUIChodHRwOi8vd3d3Lm9wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL21pdC1saWNlbnNlLnBocCkKCSAgU291cmNlOiBodHRwczovL2dpdGh1Yi5jb20va21hbGFrb2ZmL2tub2NrYmFjawoJICBEZXBlbmRlbmNpZXM6IEtub2Nrb3V0LmpzLCBCYWNrYm9uZS5qcywgYW5kIFVuZGVyc2NvcmUuanMgKG9yIExvRGFzaC5qcykuCgkgIE9wdGlvbmFsIGRlcGVuZGVuY2llczogQmFja2JvbmUuTW9kZWxSZWYuanMgYW5kIEJhY2tib25lT1JNLgoJICovCgl2YXIga2IsIGtvLCBfLCBfcmVmOwoKCV9yZWYgPSBrYiA9IF9fd2VicGFja19yZXF1aXJlX18oNiksIF8gPSBfcmVmLl8sIGtvID0gX3JlZi5rbzsKCgltb2R1bGUuZXhwb3J0cyA9IGtiLlN0b3JlID0gKGZ1bmN0aW9uKCkgewoJICBTdG9yZS5pbnN0YW5jZXMgPSBbXTsKCgkgIFN0b3JlLnVzZU9wdGlvbnNPckNyZWF0ZSA9IGZ1bmN0aW9uKG9wdGlvbnMsIG9iaiwgb2JzZXJ2YWJsZSkgewoJICAgIHZhciBzdG9yZTsKCSAgICBpZiAoIW9wdGlvbnMuc3RvcmUpIHsKCSAgICAgIGtiLnV0aWxzLndyYXBwZWRTdG9yZUlzT3duZWQob2JzZXJ2YWJsZSwgdHJ1ZSk7CgkgICAgfQoJICAgIHN0b3JlID0ga2IudXRpbHMud3JhcHBlZFN0b3JlKG9ic2VydmFibGUsIG9wdGlvbnMuc3RvcmUgfHwgbmV3IGtiLlN0b3JlKCkpOwoJICAgIHN0b3JlLnJldGFpbihvYnNlcnZhYmxlLCBvYmosIG9wdGlvbnMuY3JlYXRvcik7CgkgICAgcmV0dXJuIHN0b3JlOwoJICB9OwoKCSAgZnVuY3Rpb24gU3RvcmUoKSB7CgkgICAgdGhpcy5vYnNlcnZhYmxlX3JlY29yZHMgPSB7fTsKCSAgICB0aGlzLnJlcGxhY2VkX29ic2VydmFibGVzID0gW107CgkgICAga2IuU3RvcmUuaW5zdGFuY2VzLnB1c2godGhpcyk7CgkgIH0KCgkgIFN0b3JlLnByb3RvdHlwZS5kZXN0cm95ID0gZnVuY3Rpb24oKSB7CgkgICAgdmFyIGluZGV4OwoJICAgIHRoaXMuX19rYl9yZWxlYXNlZCA9IHRydWU7CgkgICAgdGhpcy5jbGVhcigpOwoJICAgIGlmICgoaW5kZXggPSBfLmluZGV4T2Yoa2IuU3RvcmUuaW5zdGFuY2VzLCB0aGlzKSkgPj0gMCkgewoJICAgICAgcmV0dXJuIGtiLlN0b3JlLmluc3RhbmNlcy5zcGxpY2UoaW5kZXgsIDEpOwoJICAgIH0KCSAgfTsKCgkgIFN0b3JlLnByb3RvdHlwZS5jbGVhciA9IGZ1bmN0aW9uKCkgewoJICAgIHZhciBjaWQsIGNyZWF0b3JfaWQsIG9ic2VydmFibGUsIG9ic2VydmFibGVfcmVjb3JkcywgcmVjb3JkcywgcmVwbGFjZWRfb2JzZXJ2YWJsZXMsIF9pLCBfbGVuLCBfcmVmMSwgX3JlZjI7CgkgICAgX3JlZjEgPSBbdGhpcy5vYnNlcnZhYmxlX3JlY29yZHMsIHt9XSwgb2JzZXJ2YWJsZV9yZWNvcmRzID0gX3JlZjFbMF0sIHRoaXMub2JzZXJ2YWJsZV9yZWNvcmRzID0gX3JlZjFbMV07CgkgICAgZm9yIChjcmVhdG9yX2lkIGluIG9ic2VydmFibGVfcmVjb3JkcykgewoJICAgICAgcmVjb3JkcyA9IG9ic2VydmFibGVfcmVjb3Jkc1tjcmVhdG9yX2lkXTsKCSAgICAgIGZvciAoY2lkIGluIHJlY29yZHMpIHsKCSAgICAgICAgb2JzZXJ2YWJsZSA9IHJlY29yZHNbY2lkXTsKCSAgICAgICAgdGhpcy5yZWxlYXNlKG9ic2VydmFibGUsIHRydWUpOwoJICAgICAgfQoJICAgIH0KCSAgICBfcmVmMiA9IFt0aGlzLnJlcGxhY2VkX29ic2VydmFibGVzLCBbXV0sIHJlcGxhY2VkX29ic2VydmFibGVzID0gX3JlZjJbMF0sIHRoaXMucmVwbGFjZWRfb2JzZXJ2YWJsZXMgPSBfcmVmMlsxXTsKCSAgICBmb3IgKF9pID0gMCwgX2xlbiA9IHJlcGxhY2VkX29ic2VydmFibGVzLmxlbmd0aDsgX2kgPCBfbGVuOyBfaSsrKSB7CgkgICAgICBvYnNlcnZhYmxlID0gcmVwbGFjZWRfb2JzZXJ2YWJsZXNbX2ldOwoJICAgICAgaWYgKCFvYnNlcnZhYmxlLl9fa2JfcmVsZWFzZWQpIHsKCSAgICAgICAgdGhpcy5yZWxlYXNlKG9ic2VydmFibGUsIHRydWUpOwoJICAgICAgfQoJICAgIH0KCSAgfTsKCgkgIFN0b3JlLnByb3RvdHlwZS5jb21wYWN0ID0gZnVuY3Rpb24oKSB7CgkgICAgdmFyIGNpZCwgY3JlYXRvcl9pZCwgb2JzZXJ2YWJsZSwgcmVjb3JkcywgX3JlZjE7CgkgICAgX3JlZjEgPSB0aGlzLm9ic2VydmFibGVfcmVjb3JkczsKCSAgICBmb3IgKGNyZWF0b3JfaWQgaW4gX3JlZjEpIHsKCSAgICAgIHJlY29yZHMgPSBfcmVmMVtjcmVhdG9yX2lkXTsKCSAgICAgIGZvciAoY2lkIGluIHJlY29yZHMpIHsKCSAgICAgICAgb2JzZXJ2YWJsZSA9IHJlY29yZHNbY2lkXTsKCSAgICAgICAgaWYgKG9ic2VydmFibGUuX19rYl9yZWxlYXNlZCkgewoJICAgICAgICAgIGRlbGV0ZSByZWNvcmRzW2NpZF07CgkgICAgICAgIH0KCSAgICAgIH0KCSAgICB9CgkgIH07CgoJICBTdG9yZS5wcm90b3R5cGUucmV0YWluID0gZnVuY3Rpb24ob2JzZXJ2YWJsZSwgb2JqLCBjcmVhdG9yKSB7CgkgICAgdmFyIGN1cnJlbnRfb2JzZXJ2YWJsZTsKCSAgICBpZiAoIXRoaXMuX2NhblJlZ2lzdGVyKG9ic2VydmFibGUpKSB7CgkgICAgICByZXR1cm47CgkgICAgfQoJICAgIGNyZWF0b3IgfHwgKGNyZWF0b3IgPSBvYnNlcnZhYmxlLmNvbnN0cnVjdG9yKTsKCSAgICBpZiAoY3VycmVudF9vYnNlcnZhYmxlID0gdGhpcy5maW5kKG9iaiwgY3JlYXRvcikpIHsKCSAgICAgIGlmIChjdXJyZW50X29ic2VydmFibGUgPT09IG9ic2VydmFibGUpIHsKCSAgICAgICAgdGhpcy5fZ2V0T3JDcmVhdGVTdG9yZVJlZmVyZW5jZXMob2JzZXJ2YWJsZSkucmVmX2NvdW50Kys7CgkgICAgICAgIHJldHVybiBvYnNlcnZhYmxlOwoJICAgICAgfQoJICAgICAgdGhpcy5fcmV0aXJlKGN1cnJlbnRfb2JzZXJ2YWJsZSk7CgkgICAgfQoJICAgIHRoaXMuX2FkZChvYnNlcnZhYmxlLCBvYmosIGNyZWF0b3IpOwoJICAgIHRoaXMuX2dldE9yQ3JlYXRlU3RvcmVSZWZlcmVuY2VzKG9ic2VydmFibGUpLnJlZl9jb3VudCsrOwoJICAgIHJldHVybiBvYnNlcnZhYmxlOwoJICB9OwoKCSAgU3RvcmUucHJvdG90eXBlLnJldGFpbk9yQ3JlYXRlID0gZnVuY3Rpb24ob2JqLCBvcHRpb25zKSB7CgkgICAgdmFyIGNyZWF0b3IsIG9ic2VydmFibGU7CgkgICAgaWYgKCEoY3JlYXRvciA9IHRoaXMuX2NyZWF0b3Iob2JqLCBvcHRpb25zKSkpIHsKCSAgICAgIHJldHVybiBrYi51dGlscy5jcmVhdGVGcm9tRGVmYXVsdENyZWF0b3Iob2JqLCBvcHRpb25zKTsKCSAgICB9CgkgICAgaWYgKGNyZWF0b3IubW9kZWxzX29ubHkpIHsKCSAgICAgIHJldHVybiBvYmo7CgkgICAgfQoJICAgIGlmIChvYnNlcnZhYmxlID0gdGhpcy5maW5kKG9iaiwgY3JlYXRvcikpIHsKCSAgICAgIHJldHVybiBvYnNlcnZhYmxlOwoJICAgIH0KCSAgICBpZiAoIV8uaXNGdW5jdGlvbihjcmVhdG9yLmNyZWF0ZSB8fCBjcmVhdG9yKSkgewoJICAgICAgdGhyb3cgbmV3IEVycm9yKCJJbnZhbGlkIGZhY3RvcnkgZm9yIFwiIiArIG9wdGlvbnMucGF0aCArICJcIiIpOwoJICAgIH0KCSAgICBvYnNlcnZhYmxlID0ga2IuaWdub3JlKChmdW5jdGlvbihfdGhpcykgewoJICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewoJICAgICAgICBvcHRpb25zID0gXy5kZWZhdWx0cyh7CgkgICAgICAgICAgc3RvcmU6IF90aGlzLAoJICAgICAgICAgIGNyZWF0b3I6IGNyZWF0b3IKCSAgICAgICAgfSwgb3B0aW9ucyk7CgkgICAgICAgIG9ic2VydmFibGUgPSBjcmVhdG9yLmNyZWF0ZSA/IGNyZWF0b3IuY3JlYXRlKG9iaiwgb3B0aW9ucykgOiBuZXcgY3JlYXRvcihvYmosIG9wdGlvbnMpOwoJICAgICAgICByZXR1cm4gb2JzZXJ2YWJsZSB8fCBrby5vYnNlcnZhYmxlKG51bGwpOwoJICAgICAgfTsKCSAgICB9KSh0aGlzKSk7CgkgICAgdGhpcy5yZXRhaW4ob2JzZXJ2YWJsZSwgb2JqLCBjcmVhdG9yKTsKCSAgICByZXR1cm4gb2JzZXJ2YWJsZTsKCSAgfTsKCgkgIFN0b3JlLnByb3RvdHlwZS5yZXVzZSA9IGZ1bmN0aW9uKG9ic2VydmFibGUsIG9iaikgewoJICAgIHZhciBjcmVhdG9yLCBjdXJyZW50X29iaiwgY3VycmVudF9vYnNlcnZhYmxlOwoJICAgIGlmICgoY3VycmVudF9vYmogPSBrYi51dGlscy53cmFwcGVkT2JqZWN0KG9ic2VydmFibGUpKSA9PT0gb2JqKSB7CgkgICAgICByZXR1cm47CgkgICAgfQoJICAgIGlmICghdGhpcy5fY2FuUmVnaXN0ZXIob2JzZXJ2YWJsZSkpIHsKCSAgICAgIHRocm93IG5ldyBFcnJvcignQ2Fubm90IHJldXNlIGEgc2ltcGxlIG9ic2VydmFibGUnKTsKCSAgICB9CgkgICAgaWYgKHRoaXMuX3JlZkNvdW50KG9ic2VydmFibGUpICE9PSAxKSB7CgkgICAgICB0aHJvdyBuZXcgRXJyb3IoIlRyeWluZyB0byBjaGFuZ2UgYSBzaGFyZWQgdmlldyBtb2RlbC4gUmVmIGNvdW50OiAiICsgKHRoaXMuX3JlZkNvdW50KG9ic2VydmFibGUpKSk7CgkgICAgfQoJICAgIGNyZWF0b3IgPSBrYi51dGlscy53cmFwcGVkQ3JlYXRvcihvYnNlcnZhYmxlKSB8fCBvYnNlcnZhYmxlLmNvbnN0cnVjdG9yOwoJICAgIGlmICghXy5pc1VuZGVmaW5lZChjdXJyZW50X29iaikpIHsKCSAgICAgIGN1cnJlbnRfb2JzZXJ2YWJsZSA9IHRoaXMuZmluZChjdXJyZW50X29iaiwgY3JlYXRvcik7CgkgICAgfQoJICAgIHRoaXMucmV0YWluKG9ic2VydmFibGUsIG9iaiwgY3JlYXRvcik7CgkgICAgaWYgKGN1cnJlbnRfb2JzZXJ2YWJsZSkgewoJICAgICAgdGhpcy5yZWxlYXNlKGN1cnJlbnRfb2JzZXJ2YWJsZSk7CgkgICAgfQoJICB9OwoKCSAgU3RvcmUucHJvdG90eXBlLnJlbGVhc2UgPSBmdW5jdGlvbihvYnNlcnZhYmxlLCBmb3JjZSkgewoJICAgIHZhciBzdG9yZV9yZWZlcmVuY2VzOwoJICAgIGlmICghdGhpcy5fY2FuUmVnaXN0ZXIob2JzZXJ2YWJsZSkpIHsKCSAgICAgIHJldHVybiBrYi5yZWxlYXNlKG9ic2VydmFibGUpOwoJICAgIH0KCSAgICBpZiAoc3RvcmVfcmVmZXJlbmNlcyA9IHRoaXMuX3N0b3JlUmVmZXJlbmNlcyhvYnNlcnZhYmxlKSkgewoJICAgICAgaWYgKCFmb3JjZSAmJiAtLXN0b3JlX3JlZmVyZW5jZXMucmVmX2NvdW50ID4gMCkgewoJICAgICAgICByZXR1cm47CgkgICAgICB9CgkgICAgICB0aGlzLl9jbGVhclN0b3JlUmVmZXJlbmNlcyhvYnNlcnZhYmxlKTsKCSAgICB9CgkgICAgdGhpcy5fcmVtb3ZlKG9ic2VydmFibGUpOwoJICAgIGlmIChvYnNlcnZhYmxlLl9fa2JfcmVsZWFzZWQpIHsKCSAgICAgIHJldHVybjsKCSAgICB9CgkgICAgaWYgKGZvcmNlIHx8IHRoaXMuX3JlZkNvdW50KG9ic2VydmFibGUpIDw9IDEpIHsKCSAgICAgIHJldHVybiBrYi5yZWxlYXNlKG9ic2VydmFibGUpOwoJICAgIH0KCSAgfTsKCgkgIFN0b3JlLnByb3RvdHlwZS5maW5kID0gZnVuY3Rpb24ob2JqLCBjcmVhdG9yKSB7CgkgICAgdmFyIG9ic2VydmFibGUsIHJlY29yZHMsIF9yZWYxOwoJICAgIGlmICghKHJlY29yZHMgPSB0aGlzLm9ic2VydmFibGVfcmVjb3Jkc1t0aGlzLl9jcmVhdG9ySWQoY3JlYXRvcildKSkgewoJICAgICAgcmV0dXJuIG51bGw7CgkgICAgfQoJICAgIGlmICgoX3JlZjEgPSAob2JzZXJ2YWJsZSA9IHJlY29yZHNbdGhpcy5fY2lkKG9iaildKSkgIT0gbnVsbCA/IF9yZWYxLl9fa2JfcmVsZWFzZWQgOiB2b2lkIDApIHsKCSAgICAgIGRlbGV0ZSByZWNvcmRzW3RoaXMuX2NpZChvYmopXTsKCSAgICAgIHJldHVybiBudWxsOwoJICAgIH0KCSAgICByZXR1cm4gb2JzZXJ2YWJsZTsKCSAgfTsKCgkgIFN0b3JlLnByb3RvdHlwZS5fcmVmQ291bnQgPSBmdW5jdGlvbihvYnNlcnZhYmxlKSB7CgkgICAgdmFyIHN0b3Jlc19yZWZlcmVuY2VzOwoJICAgIGlmIChvYnNlcnZhYmxlLl9fa2JfcmVsZWFzZWQpIHsKCSAgICAgIGlmICh0eXBlb2YgY29uc29sZSAhPT0gInVuZGVmaW5lZCIgJiYgY29uc29sZSAhPT0gbnVsbCkgewoJICAgICAgICBjb25zb2xlLmxvZygnT2JzZXJ2YWJsZSBhbHJlYWR5IHJlbGVhc2VkJyk7CgkgICAgICB9CgkgICAgICByZXR1cm4gMDsKCSAgICB9CgkgICAgaWYgKCEoc3RvcmVzX3JlZmVyZW5jZXMgPSBrYi51dGlscy5nZXQob2JzZXJ2YWJsZSwgJ3N0b3Jlc19yZWZlcmVuY2VzJykpKSB7CgkgICAgICByZXR1cm4gMTsKCSAgICB9CgkgICAgcmV0dXJuIF8ucmVkdWNlKHN0b3Jlc19yZWZlcmVuY2VzLCAoZnVuY3Rpb24obWVtbywgc3RvcmVfcmVmZXJlbmNlcykgewoJICAgICAgcmV0dXJuIG1lbW8gKyBzdG9yZV9yZWZlcmVuY2VzLnJlZl9jb3VudDsKCSAgICB9KSwgMCk7CgkgIH07CgoJICBTdG9yZS5wcm90b3R5cGUuX2NhblJlZ2lzdGVyID0gZnVuY3Rpb24ob2JzZXJ2YWJsZSkgewoJICAgIHJldHVybiBvYnNlcnZhYmxlICYmICFrby5pc09ic2VydmFibGUob2JzZXJ2YWJsZSkgJiYgIW9ic2VydmFibGUuX19rYl9pc19jbzsKCSAgfTsKCgkgIFN0b3JlLnByb3RvdHlwZS5fY2lkID0gZnVuY3Rpb24ob2JqKSB7CgkgICAgdmFyIGNpZDsKCSAgICByZXR1cm4gY2lkID0gb2JqID8gb2JqLmNpZCB8fCAob2JqLmNpZCA9IF8udW5pcXVlSWQoJ2MnKSkgOiAnbnVsbCc7CgkgIH07CgoJICBTdG9yZS5wcm90b3R5cGUuX2NyZWF0b3JJZCA9IGZ1bmN0aW9uKGNyZWF0b3IpIHsKCSAgICB2YXIgY3JlYXRlLCBpdGVtLCBfaSwgX2xlbiwgX3JlZjE7CgkgICAgY3JlYXRlID0gY3JlYXRvci5jcmVhdGUgfHwgY3JlYXRvcjsKCSAgICBjcmVhdGUuX19rYl9jaWRzIHx8IChjcmVhdGUuX19rYl9jaWRzID0gW10pOwoJICAgIF9yZWYxID0gY3JlYXRlLl9fa2JfY2lkczsKCSAgICBmb3IgKF9pID0gMCwgX2xlbiA9IF9yZWYxLmxlbmd0aDsgX2kgPCBfbGVuOyBfaSsrKSB7CgkgICAgICBpdGVtID0gX3JlZjFbX2ldOwoJICAgICAgaWYgKGl0ZW0uY3JlYXRlID09PSBjcmVhdGUpIHsKCSAgICAgICAgcmV0dXJuIGl0ZW0uY2lkOwoJICAgICAgfQoJICAgIH0KCSAgICBjcmVhdGUuX19rYl9jaWRzLnB1c2goaXRlbSA9IHsKCSAgICAgIGNyZWF0ZTogY3JlYXRlLAoJICAgICAgY2lkOiBfLnVuaXF1ZUlkKCdrYicpCgkgICAgfSk7CgkgICAgcmV0dXJuIGl0ZW0uY2lkOwoJICB9OwoKCSAgU3RvcmUucHJvdG90eXBlLl9zdG9yZVJlZmVyZW5jZXMgPSBmdW5jdGlvbihvYnNlcnZhYmxlKSB7CgkgICAgdmFyIHN0b3Jlc19yZWZlcmVuY2VzOwoJICAgIGlmICghKHN0b3Jlc19yZWZlcmVuY2VzID0ga2IudXRpbHMuZ2V0KG9ic2VydmFibGUsICdzdG9yZXNfcmVmZXJlbmNlcycpKSkgewoJICAgICAgcmV0dXJuOwoJICAgIH0KCSAgICByZXR1cm4gXy5maW5kKHN0b3Jlc19yZWZlcmVuY2VzLCAoZnVuY3Rpb24oX3RoaXMpIHsKCSAgICAgIHJldHVybiBmdW5jdGlvbihzdG9yZV9yZWZlcmVuY2VzKSB7CgkgICAgICAgIHJldHVybiBzdG9yZV9yZWZlcmVuY2VzLnN0b3JlID09PSBfdGhpczsKCSAgICAgIH07CgkgICAgfSkodGhpcykpOwoJICB9OwoKCSAgU3RvcmUucHJvdG90eXBlLl9nZXRPckNyZWF0ZVN0b3JlUmVmZXJlbmNlcyA9IGZ1bmN0aW9uKG9ic2VydmFibGUpIHsKCSAgICB2YXIgc3RvcmVfcmVmZXJlbmNlcywgc3RvcmVzX3JlZmVyZW5jZXM7CgkgICAgc3RvcmVzX3JlZmVyZW5jZXMgPSBrYi51dGlscy5vclNldChvYnNlcnZhYmxlLCAnc3RvcmVzX3JlZmVyZW5jZXMnLCBbXSk7CgkgICAgaWYgKCEoc3RvcmVfcmVmZXJlbmNlcyA9IF8uZmluZChzdG9yZXNfcmVmZXJlbmNlcywgKGZ1bmN0aW9uKF90aGlzKSB7CgkgICAgICByZXR1cm4gZnVuY3Rpb24oc3RvcmVfcmVmZXJlbmNlcykgewoJICAgICAgICByZXR1cm4gc3RvcmVfcmVmZXJlbmNlcy5zdG9yZSA9PT0gX3RoaXM7CgkgICAgICB9OwoJICAgIH0pKHRoaXMpKSkpIHsKCSAgICAgIHN0b3Jlc19yZWZlcmVuY2VzLnB1c2goc3RvcmVfcmVmZXJlbmNlcyA9IHsKCSAgICAgICAgc3RvcmU6IHRoaXMsCgkgICAgICAgIHJlZl9jb3VudDogMCwKCSAgICAgICAgcmVsZWFzZTogKGZ1bmN0aW9uKF90aGlzKSB7CgkgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewoJICAgICAgICAgICAgcmV0dXJuIF90aGlzLnJlbGVhc2Uob2JzZXJ2YWJsZSk7CgkgICAgICAgICAgfTsKCSAgICAgICAgfSkodGhpcykKCSAgICAgIH0pOwoJICAgIH0KCSAgICByZXR1cm4gc3RvcmVfcmVmZXJlbmNlczsKCSAgfTsKCgkgIFN0b3JlLnByb3RvdHlwZS5fY2xlYXJTdG9yZVJlZmVyZW5jZXMgPSBmdW5jdGlvbihvYnNlcnZhYmxlKSB7CgkgICAgdmFyIGluZGV4LCBzdG9yZV9yZWZlcmVuY2VzLCBzdG9yZXNfcmVmZXJlbmNlcywgX3JlZjE7CgkgICAgaWYgKHN0b3Jlc19yZWZlcmVuY2VzID0ga2IudXRpbHMuZ2V0KG9ic2VydmFibGUsICdzdG9yZXNfcmVmZXJlbmNlcycpKSB7CgkgICAgICBfcmVmMSA9IG9ic2VydmFibGUuX19rYi5zdG9yZXNfcmVmZXJlbmNlczsKCSAgICAgIGZvciAoaW5kZXggaW4gX3JlZjEpIHsKCSAgICAgICAgc3RvcmVfcmVmZXJlbmNlcyA9IF9yZWYxW2luZGV4XTsKCSAgICAgICAgaWYgKHN0b3JlX3JlZmVyZW5jZXMuc3RvcmUgPT09IHRoaXMpIHsKCSAgICAgICAgICBvYnNlcnZhYmxlLl9fa2Iuc3RvcmVzX3JlZmVyZW5jZXMuc3BsaWNlKGluZGV4LCAxKTsKCSAgICAgICAgICBicmVhazsKCSAgICAgICAgfQoJICAgICAgfQoJICAgIH0KCSAgfTsKCgkgIFN0b3JlLnByb3RvdHlwZS5fcmV0aXJlID0gZnVuY3Rpb24ob2JzZXJ2YWJsZSkgewoJICAgIHRoaXMuX2NsZWFyU3RvcmVSZWZlcmVuY2VzKG9ic2VydmFibGUpOwoJICAgIHRoaXMucmVwbGFjZWRfb2JzZXJ2YWJsZXMucHVzaChvYnNlcnZhYmxlKTsKCSAgICByZXR1cm4gdGhpcy5fcmVtb3ZlKG9ic2VydmFibGUpOwoJICB9OwoKCSAgU3RvcmUucHJvdG90eXBlLl9hZGQgPSBmdW5jdGlvbihvYnNlcnZhYmxlLCBvYmosIGNyZWF0b3IpIHsKCSAgICB2YXIgX2Jhc2UsIF9uYW1lOwoJICAgIGNyZWF0b3IgfHwgKGNyZWF0b3IgPSBvYnNlcnZhYmxlLmNvbnN0cnVjdG9yKTsKCSAgICBrYi51dGlscy53cmFwcGVkT2JqZWN0KG9ic2VydmFibGUsIG9iaik7CgkgICAga2IudXRpbHMud3JhcHBlZENyZWF0b3Iob2JzZXJ2YWJsZSwgY3JlYXRvcik7CgkgICAgcmV0dXJuICgoX2Jhc2UgPSB0aGlzLm9ic2VydmFibGVfcmVjb3JkcylbX25hbWUgPSB0aGlzLl9jcmVhdG9ySWQoY3JlYXRvcildIHx8IChfYmFzZVtfbmFtZV0gPSB7fSkpW3RoaXMuX2NpZChvYmopXSA9IG9ic2VydmFibGU7CgkgIH07CgoJICBTdG9yZS5wcm90b3R5cGUuX3JlbW92ZSA9IGZ1bmN0aW9uKG9ic2VydmFibGUpIHsKCSAgICB2YXIgY3JlYXRvciwgY3VycmVudF9vYnNlcnZhYmxlLCBvYmo7CgkgICAgY3JlYXRvciA9IGtiLnV0aWxzLndyYXBwZWRDcmVhdG9yKG9ic2VydmFibGUpIHx8IG9ic2VydmFibGUuY29uc3RydWN0b3I7CgkgICAgaWYgKGN1cnJlbnRfb2JzZXJ2YWJsZSA9IHRoaXMuZmluZChvYmogPSBrYi51dGlscy53cmFwcGVkT2JqZWN0KG9ic2VydmFibGUpLCBjcmVhdG9yKSkgewoJICAgICAgaWYgKGN1cnJlbnRfb2JzZXJ2YWJsZSA9PT0gb2JzZXJ2YWJsZSkgewoJICAgICAgICBkZWxldGUgdGhpcy5vYnNlcnZhYmxlX3JlY29yZHNbdGhpcy5fY3JlYXRvcklkKGNyZWF0b3IpXVt0aGlzLl9jaWQob2JqKV07CgkgICAgICB9CgkgICAgfQoJICAgIGtiLnV0aWxzLndyYXBwZWRPYmplY3Qob2JzZXJ2YWJsZSwgbnVsbCk7CgkgICAgcmV0dXJuIGtiLnV0aWxzLndyYXBwZWRDcmVhdG9yKG9ic2VydmFibGUsIG51bGwpOwoJICB9OwoKCSAgU3RvcmUucHJvdG90eXBlLl9jcmVhdG9yID0gZnVuY3Rpb24ob2JqLCBvcHRpb25zKSB7CgkgICAgdmFyIGNyZWF0b3I7CgkgICAgaWYgKG9wdGlvbnMuY3JlYXRvcikgewoJICAgICAgcmV0dXJuIG9wdGlvbnMuY3JlYXRvcjsKCSAgICB9CgkgICAgaWYgKGNyZWF0b3IgPSBrYi51dGlscy5pbmZlckNyZWF0b3Iob2JqLCBvcHRpb25zLmZhY3RvcnksIG9wdGlvbnMucGF0aCkpIHsKCSAgICAgIHJldHVybiBjcmVhdG9yOwoJICAgIH0KCSAgICBpZiAoa2IuaXNNb2RlbChvYmopKSB7CgkgICAgICByZXR1cm4ga2IuVmlld01vZGVsOwoJICAgIH0KCSAgfTsKCgkgIHJldHVybiBTdG9yZTsKCgl9KSgpOwoKCi8qKiovIH0sCi8qIDExICovCi8qKiovIGZ1bmN0aW9uKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewoKCXZhciBUeXBlZFZhbHVlLCBrYiwga28sIF8sIF9yZWY7CgoJX3JlZiA9IGtiID0gX193ZWJwYWNrX3JlcXVpcmVfXyg2KSwgXyA9IF9yZWYuXywga28gPSBfcmVmLmtvOwoKCW1vZHVsZS5leHBvcnRzID0gVHlwZWRWYWx1ZSA9IChmdW5jdGlvbigpIHsKCSAgZnVuY3Rpb24gVHlwZWRWYWx1ZShjcmVhdGVfb3B0aW9ucykgewoJICAgIHRoaXMuY3JlYXRlX29wdGlvbnMgPSBjcmVhdGVfb3B0aW9uczsKCSAgICB0aGlzLl92byA9IGtvLm9ic2VydmFibGUobnVsbCk7CgkgIH0KCgkgIFR5cGVkVmFsdWUucHJvdG90eXBlLmRlc3Ryb3kgPSBmdW5jdGlvbigpIHsKCSAgICB2YXIgcHJldmlvdXNfdmFsdWU7CgkgICAgdGhpcy5fX2tiX3JlbGVhc2VkID0gdHJ1ZTsKCSAgICBpZiAocHJldmlvdXNfdmFsdWUgPSB0aGlzLl9fa2JfdmFsdWUpIHsKCSAgICAgIHRoaXMuX19rYl92YWx1ZSA9IG51bGw7CgkgICAgICBpZiAodGhpcy5jcmVhdGVfb3B0aW9ucy5zdG9yZSAmJiBrYi51dGlscy53cmFwcGVkQ3JlYXRvcihwcmV2aW91c192YWx1ZSkpIHsKCSAgICAgICAgdGhpcy5jcmVhdGVfb3B0aW9ucy5zdG9yZS5yZWxlYXNlKHByZXZpb3VzX3ZhbHVlKTsKCSAgICAgIH0gZWxzZSB7CgkgICAgICAgIGtiLnJlbGVhc2UocHJldmlvdXNfdmFsdWUpOwoJICAgICAgfQoJICAgIH0KCSAgICByZXR1cm4gdGhpcy5jcmVhdGVfb3B0aW9ucyA9IG51bGw7CgkgIH07CgoJICBUeXBlZFZhbHVlLnByb3RvdHlwZS52YWx1ZSA9IGZ1bmN0aW9uKCkgewoJICAgIHJldHVybiBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKHRoaXMuX3ZvKCkpOwoJICB9OwoKCSAgVHlwZWRWYWx1ZS5wcm90b3R5cGUucmF3VmFsdWUgPSBmdW5jdGlvbigpIHsKCSAgICByZXR1cm4gdGhpcy5fX2tiX3ZhbHVlOwoJICB9OwoKCSAgVHlwZWRWYWx1ZS5wcm90b3R5cGUudmFsdWVUeXBlID0gZnVuY3Rpb24obW9kZWwsIGtleSkgewoJICAgIHZhciBuZXdfdmFsdWU7CgkgICAgbmV3X3ZhbHVlID0ga2IuZ2V0VmFsdWUobW9kZWwsIGtleSk7CgkgICAgdGhpcy52YWx1ZV90eXBlIHx8IHRoaXMuX3VwZGF0ZVZhbHVlT2JzZXJ2YWJsZShuZXdfdmFsdWUpOwoJICAgIHJldHVybiB0aGlzLnZhbHVlX3R5cGU7CgkgIH07CgoJICBUeXBlZFZhbHVlLnByb3RvdHlwZS51cGRhdGUgPSBmdW5jdGlvbihuZXdfdmFsdWUpIHsKCSAgICB2YXIgbmV3X3R5cGUsIHZhbHVlLCBfcmVmMTsKCSAgICBpZiAodGhpcy5fX2tiX3JlbGVhc2VkKSB7CgkgICAgICByZXR1cm47CgkgICAgfQoJICAgIChuZXdfdmFsdWUgIT09IHZvaWQgMCkgfHwgKG5ld192YWx1ZSA9IG51bGwpOwoJICAgIG5ld190eXBlID0ga2IudXRpbHMudmFsdWVUeXBlKG5ld192YWx1ZSk7CgkgICAgaWYgKChfcmVmMSA9IHRoaXMuX19rYl92YWx1ZSkgIT0gbnVsbCA/IF9yZWYxLl9fa2JfcmVsZWFzZWQgOiB2b2lkIDApIHsKCSAgICAgIHRoaXMuX19rYl92YWx1ZSA9IHRoaXMudmFsdWVfdHlwZSA9IHZvaWQgMDsKCSAgICB9CgkgICAgdmFsdWUgPSB0aGlzLl9fa2JfdmFsdWU7CgkgICAgc3dpdGNoICh0aGlzLnZhbHVlX3R5cGUpIHsKCSAgICAgIGNhc2Uga2IuVFlQRV9DT0xMRUNUSU9OOgoJICAgICAgICBpZiAodGhpcy52YWx1ZV90eXBlID09PSBrYi5UWVBFX0NPTExFQ1RJT04gJiYgbmV3X3R5cGUgPT09IGtiLlRZUEVfQVJSQVkpIHsKCSAgICAgICAgICByZXR1cm4gdmFsdWUobmV3X3ZhbHVlKTsKCSAgICAgICAgfQoJICAgICAgICBpZiAobmV3X3R5cGUgPT09IGtiLlRZUEVfQ09MTEVDVElPTiB8fCBfLmlzTnVsbChuZXdfdmFsdWUpKSB7CgkgICAgICAgICAgaWYgKG5ld192YWx1ZSAmJiBuZXdfdmFsdWUgaW5zdGFuY2VvZiBrYi5Db2xsZWN0aW9uT2JzZXJ2YWJsZSkgewoJICAgICAgICAgICAgdGhpcy5fdXBkYXRlVmFsdWVPYnNlcnZhYmxlKGtiLnV0aWxzLndyYXBwZWRPYmplY3QobmV3X3ZhbHVlKSwgbmV3X3ZhbHVlKTsKCSAgICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgaWYgKGtiLnBlZWsodmFsdWUuY29sbGVjdGlvbikgIT09IG5ld192YWx1ZSkgewoJICAgICAgICAgICAgICB2YWx1ZS5jb2xsZWN0aW9uKG5ld192YWx1ZSk7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgfQoJICAgICAgICAgIHJldHVybjsKCSAgICAgICAgfQoJICAgICAgICBicmVhazsKCSAgICAgIGNhc2Uga2IuVFlQRV9NT0RFTDoKCSAgICAgICAgaWYgKG5ld190eXBlID09PSBrYi5UWVBFX01PREVMIHx8IF8uaXNOdWxsKG5ld192YWx1ZSkpIHsKCSAgICAgICAgICBpZiAobmV3X3ZhbHVlICYmICFrYi5pc01vZGVsKG5ld192YWx1ZSkpIHsKCSAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVZhbHVlT2JzZXJ2YWJsZShrYi51dGlscy53cmFwcGVkT2JqZWN0KG5ld192YWx1ZSksIG5ld192YWx1ZSk7CgkgICAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgIGlmIChrYi51dGlscy53cmFwcGVkT2JqZWN0KHZhbHVlKSAhPT0ga2IudXRpbHMucmVzb2x2ZU1vZGVsKG5ld192YWx1ZSkpIHsKCSAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlVmFsdWVPYnNlcnZhYmxlKG5ld192YWx1ZSk7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgfQoJICAgICAgICAgIHJldHVybjsKCSAgICAgICAgfQoJICAgIH0KCSAgICBpZiAodGhpcy52YWx1ZV90eXBlID09PSBuZXdfdHlwZSAmJiAhXy5pc1VuZGVmaW5lZCh0aGlzLnZhbHVlX3R5cGUpKSB7CgkgICAgICBpZiAoa2IucGVlayh2YWx1ZSkgIT09IG5ld192YWx1ZSkgewoJICAgICAgICByZXR1cm4gdmFsdWUobmV3X3ZhbHVlKTsKCSAgICAgIH0KCSAgICB9IGVsc2UgewoJICAgICAgaWYgKGtiLnBlZWsodmFsdWUpICE9PSBuZXdfdmFsdWUpIHsKCSAgICAgICAgcmV0dXJuIHRoaXMuX3VwZGF0ZVZhbHVlT2JzZXJ2YWJsZShuZXdfdmFsdWUpOwoJICAgICAgfQoJICAgIH0KCSAgfTsKCgkgIFR5cGVkVmFsdWUucHJvdG90eXBlLl91cGRhdGVWYWx1ZU9ic2VydmFibGUgPSBmdW5jdGlvbihuZXdfdmFsdWUsIG5ld19vYnNlcnZhYmxlKSB7CgkgICAgdmFyIGNyZWF0ZV9vcHRpb25zLCBjcmVhdG9yLCBwcmV2aW91c192YWx1ZSwgdmFsdWUsIHZhbHVlX3R5cGUsIF9yZWYxOwoJICAgIGNyZWF0ZV9vcHRpb25zID0gdGhpcy5jcmVhdGVfb3B0aW9uczsKCSAgICBjcmVhdG9yID0ga2IudXRpbHMuaW5mZXJDcmVhdG9yKG5ld192YWx1ZSwgY3JlYXRlX29wdGlvbnMuZmFjdG9yeSwgY3JlYXRlX29wdGlvbnMucGF0aCk7CgkgICAgaWYgKChuZXdfdmFsdWUgPT09IG51bGwpICYmICFjcmVhdG9yKSB7CgkgICAgICBpZiAodGhpcy52YWx1ZV90eXBlID09PSBrYi5UWVBFX01PREVMKSB7CgkgICAgICAgIGNyZWF0b3IgPSBrYi5WaWV3TW9kZWw7CgkgICAgICB9IGVsc2UgaWYgKHRoaXMudmFsdWVfdHlwZSA9PT0ga2IuVFlQRV9DT0xMRUNUSU9OKSB7CgkgICAgICAgIGNyZWF0b3IgPSBrYi5Db2xsZWN0aW9uT2JzZXJ2YWJsZTsKCSAgICAgIH0KCSAgICB9CgkgICAgY3JlYXRlX29wdGlvbnMuY3JlYXRvciA9IGNyZWF0b3I7CgkgICAgdmFsdWVfdHlwZSA9IGtiLlRZUEVfVU5LTk9XTjsKCSAgICBfcmVmMSA9IFt0aGlzLl9fa2JfdmFsdWUsIHZvaWQgMF0sIHByZXZpb3VzX3ZhbHVlID0gX3JlZjFbMF0sIHRoaXMuX19rYl92YWx1ZSA9IF9yZWYxWzFdOwoJICAgIGlmIChuZXdfb2JzZXJ2YWJsZSkgewoJICAgICAgdmFsdWUgPSBuZXdfb2JzZXJ2YWJsZTsKCSAgICAgIGlmIChjcmVhdGVfb3B0aW9ucy5zdG9yZSkgewoJICAgICAgICBjcmVhdGVfb3B0aW9ucy5zdG9yZS5yZXRhaW4obmV3X29ic2VydmFibGUsIG5ld192YWx1ZSwgY3JlYXRvcik7CgkgICAgICB9CgkgICAgfSBlbHNlIGlmIChjcmVhdG9yKSB7CgkgICAgICBpZiAoY3JlYXRlX29wdGlvbnMuc3RvcmUpIHsKCSAgICAgICAgdmFsdWUgPSBjcmVhdGVfb3B0aW9ucy5zdG9yZS5yZXRhaW5PckNyZWF0ZShuZXdfdmFsdWUsIGNyZWF0ZV9vcHRpb25zKTsKCSAgICAgIH0gZWxzZSB7CgkgICAgICAgIGlmIChjcmVhdG9yLm1vZGVsc19vbmx5KSB7CgkgICAgICAgICAgdmFsdWUgPSBuZXdfdmFsdWU7CgkgICAgICAgICAgdmFsdWVfdHlwZSA9IGtiLlRZUEVfU0lNUExFOwoJICAgICAgICB9IGVsc2UgaWYgKGNyZWF0b3IuY3JlYXRlKSB7CgkgICAgICAgICAgdmFsdWUgPSBjcmVhdG9yLmNyZWF0ZShuZXdfdmFsdWUsIGNyZWF0ZV9vcHRpb25zKTsKCSAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICB2YWx1ZSA9IG5ldyBjcmVhdG9yKG5ld192YWx1ZSwgY3JlYXRlX29wdGlvbnMpOwoJICAgICAgICB9CgkgICAgICB9CgkgICAgfSBlbHNlIHsKCSAgICAgIGlmIChfLmlzQXJyYXkobmV3X3ZhbHVlKSkgewoJICAgICAgICB2YWx1ZV90eXBlID0ga2IuVFlQRV9BUlJBWTsKCSAgICAgICAgdmFsdWUgPSBrby5vYnNlcnZhYmxlQXJyYXkobmV3X3ZhbHVlKTsKCSAgICAgIH0gZWxzZSB7CgkgICAgICAgIHZhbHVlX3R5cGUgPSBrYi5UWVBFX1NJTVBMRTsKCSAgICAgICAgdmFsdWUgPSBrby5vYnNlcnZhYmxlKG5ld192YWx1ZSk7CgkgICAgICB9CgkgICAgfQoJICAgIGlmICgodGhpcy52YWx1ZV90eXBlID0gdmFsdWVfdHlwZSkgPT09IGtiLlRZUEVfVU5LTk9XTikgewoJICAgICAgaWYgKCFrby5pc09ic2VydmFibGUodmFsdWUpKSB7CgkgICAgICAgIHRoaXMudmFsdWVfdHlwZSA9IGtiLlRZUEVfTU9ERUw7CgkgICAgICAgIGtiLnV0aWxzLndyYXBwZWRPYmplY3QodmFsdWUsIGtiLnV0aWxzLnJlc29sdmVNb2RlbChuZXdfdmFsdWUpKTsKCSAgICAgIH0gZWxzZSBpZiAodmFsdWUuX19rYl9pc19jbykgewoJICAgICAgICB0aGlzLnZhbHVlX3R5cGUgPSBrYi5UWVBFX0NPTExFQ1RJT047CgkgICAgICAgIGtiLnV0aWxzLndyYXBwZWRPYmplY3QodmFsdWUsIG5ld192YWx1ZSk7CgkgICAgICB9IGVsc2UgaWYgKCF0aGlzLnZhbHVlX3R5cGUpIHsKCSAgICAgICAgdGhpcy52YWx1ZV90eXBlID0ga2IuVFlQRV9TSU1QTEU7CgkgICAgICB9CgkgICAgfQoJICAgIGlmIChwcmV2aW91c192YWx1ZSkgewoJICAgICAgaWYgKHRoaXMuY3JlYXRlX29wdGlvbnMuc3RvcmUpIHsKCSAgICAgICAgdGhpcy5jcmVhdGVfb3B0aW9ucy5zdG9yZS5yZWxlYXNlKHByZXZpb3VzX3ZhbHVlKTsKCSAgICAgIH0gZWxzZSB7CgkgICAgICAgIGtiLnJlbGVhc2UocHJldmlvdXNfdmFsdWUpOwoJICAgICAgfQoJICAgIH0KCSAgICB0aGlzLl9fa2JfdmFsdWUgPSB2YWx1ZTsKCSAgICByZXR1cm4gdGhpcy5fdm8odmFsdWUpOwoJICB9OwoKCSAgVHlwZWRWYWx1ZS5wcm90b3R5cGUuX2luZmVyVHlwZSA9IGZ1bmN0aW9uKHZhbHVlKSB7fTsKCgkgIHJldHVybiBUeXBlZFZhbHVlOwoKCX0pKCk7CgoKLyoqKi8gfSwKLyogMTIgKi8KLyoqKi8gZnVuY3Rpb24obW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CgoJCgkvKgoJICBrbm9ja2JhY2suanMgMC4yMC40CgkgIENvcHlyaWdodCAoYykgIDIwMTEtMjAxNCBLZXZpbiBNYWxha29mZi4KCSAgTGljZW5zZTogTUlUIChodHRwOi8vd3d3Lm9wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL21pdC1saWNlbnNlLnBocCkKCSAgU291cmNlOiBodHRwczovL2dpdGh1Yi5jb20va21hbGFrb2ZmL2tub2NrYmFjawoJICBEZXBlbmRlbmNpZXM6IEtub2Nrb3V0LmpzLCBCYWNrYm9uZS5qcywgYW5kIFVuZGVyc2NvcmUuanMgKG9yIExvRGFzaC5qcykuCgkgIE9wdGlvbmFsIGRlcGVuZGVuY2llczogQmFja2JvbmUuTW9kZWxSZWYuanMgYW5kIEJhY2tib25lT1JNLgoJICovCgl2YXIga2IsIGtvLCBfLCBfcmVmOwoKCV9yZWYgPSBrYiA9IF9fd2VicGFja19yZXF1aXJlX18oNiksIF8gPSBfcmVmLl8sIGtvID0gX3JlZi5rbzsKCglrYi51dGlscyA9IChmdW5jdGlvbigpIHsKCSAgZnVuY3Rpb24gdXRpbHMoKSB7fQoKCSAgdXRpbHMuZ2V0ID0gZnVuY3Rpb24ob2JqLCBrZXksIGRlZmF1bHRfdmFsdWUpIHsKCSAgICBpZiAoIW9iai5fX2tiIHx8ICFvYmouX19rYi5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CgkgICAgICByZXR1cm4gZGVmYXVsdF92YWx1ZTsKCSAgICB9IGVsc2UgewoJICAgICAgcmV0dXJuIG9iai5fX2tiW2tleV07CgkgICAgfQoJICB9OwoKCSAgdXRpbHMuc2V0ID0gZnVuY3Rpb24ob2JqLCBrZXksIHZhbHVlKSB7CgkgICAgcmV0dXJuIChvYmouX19rYiB8fCAob2JqLl9fa2IgPSB7fSkpW2tleV0gPSB2YWx1ZTsKCSAgfTsKCgkgIHV0aWxzLm9yU2V0ID0gZnVuY3Rpb24ob2JqLCBrZXksIHZhbHVlKSB7CgkgICAgaWYgKCEob2JqLl9fa2IgfHwgKG9iai5fX2tiID0ge30pKS5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CgkgICAgICBvYmouX19rYltrZXldID0gdmFsdWU7CgkgICAgfQoJICAgIHJldHVybiBvYmouX19rYltrZXldOwoJICB9OwoKCSAgdXRpbHMuaGFzID0gZnVuY3Rpb24ob2JqLCBrZXkpIHsKCSAgICByZXR1cm4gb2JqLl9fa2IgJiYgb2JqLl9fa2IuaGFzT3duUHJvcGVydHkoa2V5KTsKCSAgfTsKCgkgIHV0aWxzLndyYXBwZWRPYnNlcnZhYmxlID0gZnVuY3Rpb24ob2JqLCB2YWx1ZSkgewoJICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAxKSB7CgkgICAgICByZXR1cm4ga2IudXRpbHMuZ2V0KG9iaiwgJ29ic2VydmFibGUnKTsKCSAgICB9IGVsc2UgewoJICAgICAgcmV0dXJuIGtiLnV0aWxzLnNldChvYmosICdvYnNlcnZhYmxlJywgdmFsdWUpOwoJICAgIH0KCSAgfTsKCgkgIHV0aWxzLndyYXBwZWRPYmplY3QgPSBmdW5jdGlvbihvYmosIHZhbHVlKSB7CgkgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDEpIHsKCSAgICAgIHJldHVybiBrYi51dGlscy5nZXQob2JqLCAnb2JqZWN0Jyk7CgkgICAgfSBlbHNlIHsKCSAgICAgIHJldHVybiBrYi51dGlscy5zZXQob2JqLCAnb2JqZWN0JywgdmFsdWUpOwoJICAgIH0KCSAgfTsKCgkgIHV0aWxzLndyYXBwZWRDcmVhdG9yID0gZnVuY3Rpb24ob2JqLCB2YWx1ZSkgewoJICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAxKSB7CgkgICAgICByZXR1cm4ga2IudXRpbHMuZ2V0KG9iaiwgJ2NyZWF0b3InKTsKCSAgICB9IGVsc2UgewoJICAgICAgcmV0dXJuIGtiLnV0aWxzLnNldChvYmosICdjcmVhdG9yJywgdmFsdWUpOwoJICAgIH0KCSAgfTsKCgkgIHV0aWxzLndyYXBwZWRNb2RlbCA9IGZ1bmN0aW9uKG9iaiwgdmFsdWUpIHsKCSAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMSkgewoJICAgICAgaWYgKF8uaXNVbmRlZmluZWQodmFsdWUgPSBrYi51dGlscy5nZXQob2JqLCAnb2JqZWN0JykpKSB7CgkgICAgICAgIHJldHVybiBvYmo7CgkgICAgICB9IGVsc2UgewoJICAgICAgICByZXR1cm4gdmFsdWU7CgkgICAgICB9CgkgICAgfSBlbHNlIHsKCSAgICAgIHJldHVybiBrYi51dGlscy5zZXQob2JqLCAnb2JqZWN0JywgdmFsdWUpOwoJICAgIH0KCSAgfTsKCgkgIHV0aWxzLndyYXBwZWRTdG9yZSA9IGZ1bmN0aW9uKG9iaiwgdmFsdWUpIHsKCSAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMSkgewoJICAgICAgcmV0dXJuIGtiLnV0aWxzLmdldChvYmosICdzdG9yZScpOwoJICAgIH0gZWxzZSB7CgkgICAgICByZXR1cm4ga2IudXRpbHMuc2V0KG9iaiwgJ3N0b3JlJywgdmFsdWUpOwoJICAgIH0KCSAgfTsKCgkgIHV0aWxzLndyYXBwZWRTdG9yZUlzT3duZWQgPSBmdW5jdGlvbihvYmosIHZhbHVlKSB7CgkgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDEpIHsKCSAgICAgIHJldHVybiBrYi51dGlscy5nZXQob2JqLCAnc3RvcmVfaXNfb3duZWQnKTsKCSAgICB9IGVsc2UgewoJICAgICAgcmV0dXJuIGtiLnV0aWxzLnNldChvYmosICdzdG9yZV9pc19vd25lZCcsIHZhbHVlKTsKCSAgICB9CgkgIH07CgoJICB1dGlscy53cmFwcGVkRmFjdG9yeSA9IGZ1bmN0aW9uKG9iaiwgdmFsdWUpIHsKCSAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMSkgewoJICAgICAgcmV0dXJuIGtiLnV0aWxzLmdldChvYmosICdmYWN0b3J5Jyk7CgkgICAgfSBlbHNlIHsKCSAgICAgIHJldHVybiBrYi51dGlscy5zZXQob2JqLCAnZmFjdG9yeScsIHZhbHVlKTsKCSAgICB9CgkgIH07CgoJICB1dGlscy53cmFwcGVkRXZlbnRXYXRjaGVyID0gZnVuY3Rpb24ob2JqLCB2YWx1ZSkgewoJICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAxKSB7CgkgICAgICByZXR1cm4ga2IudXRpbHMuZ2V0KG9iaiwgJ2V2ZW50X3dhdGNoZXInKTsKCSAgICB9IGVsc2UgewoJICAgICAgcmV0dXJuIGtiLnV0aWxzLnNldChvYmosICdldmVudF93YXRjaGVyJywgdmFsdWUpOwoJICAgIH0KCSAgfTsKCgkgIHV0aWxzLndyYXBwZWRFdmVudFdhdGNoZXJJc093bmVkID0gZnVuY3Rpb24ob2JqLCB2YWx1ZSkgewoJICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAxKSB7CgkgICAgICByZXR1cm4ga2IudXRpbHMuZ2V0KG9iaiwgJ2V2ZW50X3dhdGNoZXJfaXNfb3duZWQnKTsKCSAgICB9IGVsc2UgewoJICAgICAgcmV0dXJuIGtiLnV0aWxzLnNldChvYmosICdldmVudF93YXRjaGVyX2lzX293bmVkJywgdmFsdWUpOwoJICAgIH0KCSAgfTsKCgkgIHV0aWxzLndyYXBwZWREZXN0cm95ID0gX193ZWJwYWNrX3JlcXVpcmVfXygyMCk7CgoJICB1dGlscy52YWx1ZVR5cGUgPSBmdW5jdGlvbihvYnNlcnZhYmxlKSB7CgkgICAgaWYgKCFvYnNlcnZhYmxlKSB7CgkgICAgICByZXR1cm4ga2IuVFlQRV9VTktOT1dOOwoJICAgIH0KCSAgICBpZiAob2JzZXJ2YWJsZS5fX2tiX2lzX28pIHsKCSAgICAgIHJldHVybiBvYnNlcnZhYmxlLnZhbHVlVHlwZSgpOwoJICAgIH0KCSAgICBpZiAob2JzZXJ2YWJsZS5fX2tiX2lzX2NvIHx8IChvYnNlcnZhYmxlIGluc3RhbmNlb2Yga2IuQ29sbGVjdGlvbikpIHsKCSAgICAgIHJldHVybiBrYi5UWVBFX0NPTExFQ1RJT047CgkgICAgfQoJICAgIGlmICgob2JzZXJ2YWJsZSBpbnN0YW5jZW9mIGtiLlZpZXdNb2RlbCkgfHwgKG9ic2VydmFibGUgaW5zdGFuY2VvZiBrYi5Nb2RlbCkpIHsKCSAgICAgIHJldHVybiBrYi5UWVBFX01PREVMOwoJICAgIH0KCSAgICBpZiAoXy5pc0FycmF5KG9ic2VydmFibGUpKSB7CgkgICAgICByZXR1cm4ga2IuVFlQRV9BUlJBWTsKCSAgICB9CgkgICAgcmV0dXJuIGtiLlRZUEVfU0lNUExFOwoJICB9OwoKCSAgdXRpbHMucGF0aEpvaW4gPSBmdW5jdGlvbihwYXRoMSwgcGF0aDIpIHsKCSAgICByZXR1cm4gKHBhdGgxID8gKHBhdGgxW3BhdGgxLmxlbmd0aCAtIDFdICE9PSAnLicgPyAiIiArIHBhdGgxICsgIi4iIDogcGF0aDEpIDogJycpICsgcGF0aDI7CgkgIH07CgoJICB1dGlscy5vcHRpb25zUGF0aEpvaW4gPSBmdW5jdGlvbihvcHRpb25zLCBwYXRoKSB7CgkgICAgcmV0dXJuIF8uZGVmYXVsdHMoewoJICAgICAgcGF0aDogdGhpcy5wYXRoSm9pbihvcHRpb25zLnBhdGgsIHBhdGgpCgkgICAgfSwgb3B0aW9ucyk7CgkgIH07CgoJICB1dGlscy5pbmZlckNyZWF0b3IgPSBmdW5jdGlvbih2YWx1ZSwgZmFjdG9yeSwgcGF0aCkgewoJICAgIHZhciBjcmVhdG9yOwoJICAgIGlmIChmYWN0b3J5ICYmIChjcmVhdG9yID0gZmFjdG9yeS5jcmVhdG9yRm9yUGF0aCh2YWx1ZSwgcGF0aCkpKSB7CgkgICAgICByZXR1cm4gY3JlYXRvcjsKCSAgICB9CgkgICAgaWYgKCF2YWx1ZSkgewoJICAgICAgcmV0dXJuIG51bGw7CgkgICAgfQoJICAgIGlmICh2YWx1ZSBpbnN0YW5jZW9mIGtiLk1vZGVsKSB7CgkgICAgICByZXR1cm4ga2IuVmlld01vZGVsOwoJICAgIH0KCSAgICBpZiAodmFsdWUgaW5zdGFuY2VvZiBrYi5Db2xsZWN0aW9uKSB7CgkgICAgICByZXR1cm4ga2IuQ29sbGVjdGlvbk9ic2VydmFibGU7CgkgICAgfQoJICAgIHJldHVybiBudWxsOwoJICB9OwoKCSAgdXRpbHMuY3JlYXRlRnJvbURlZmF1bHRDcmVhdG9yID0gZnVuY3Rpb24ob2JqLCBvcHRpb25zKSB7CgkgICAgaWYgKGtiLmlzTW9kZWwob2JqKSkgewoJICAgICAgcmV0dXJuIGtiLnZpZXdNb2RlbChvYmosIG9wdGlvbnMpOwoJICAgIH0KCSAgICBpZiAoa2IuaXNDb2xsZWN0aW9uKG9iaikpIHsKCSAgICAgIHJldHVybiBrYi5jb2xsZWN0aW9uT2JzZXJ2YWJsZShvYmosIG9wdGlvbnMpOwoJICAgIH0KCSAgICBpZiAoXy5pc0FycmF5KG9iaikpIHsKCSAgICAgIHJldHVybiBrby5vYnNlcnZhYmxlQXJyYXkob2JqKTsKCSAgICB9CgkgICAgcmV0dXJuIGtvLm9ic2VydmFibGUob2JqKTsKCSAgfTsKCgkgIHV0aWxzLmNvbGxhcHNlT3B0aW9ucyA9IF9fd2VicGFja19yZXF1aXJlX18oMjEpOwoKCSAgdXRpbHMudW53cmFwTW9kZWxzID0gX193ZWJwYWNrX3JlcXVpcmVfXygyMik7CgoJICB1dGlscy5yZXNvbHZlTW9kZWwgPSBmdW5jdGlvbihtb2RlbCkgewoJICAgIGlmIChtb2RlbCAmJiBrYi5CYWNrYm9uZSAmJiBrYi5CYWNrYm9uZS5Nb2RlbFJlZiAmJiBtb2RlbCBpbnN0YW5jZW9mIGtiLkJhY2tib25lLk1vZGVsUmVmKSB7CgkgICAgICByZXR1cm4gbW9kZWwubW9kZWwoKTsKCSAgICB9IGVsc2UgewoJICAgICAgcmV0dXJuIG1vZGVsOwoJICAgIH0KCSAgfTsKCgkgIHJldHVybiB1dGlsczsKCgl9KSgpOwoKCi8qKiovIH0sCi8qIDEzICovCi8qKiovIGZ1bmN0aW9uKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewoKCQoJLyoKCSAga25vY2tiYWNrLmpzIDAuMjAuNAoJICBDb3B5cmlnaHQgKGMpICAyMDExLTIwMTQgS2V2aW4gTWFsYWtvZmYuCgkgIExpY2Vuc2U6IE1JVCAoaHR0cDovL3d3dy5vcGVuc291cmNlLm9yZy9saWNlbnNlcy9taXQtbGljZW5zZS5waHApCgkgIFNvdXJjZTogaHR0cHM6Ly9naXRodWIuY29tL2ttYWxha29mZi9rbm9ja2JhY2sKCSAgRGVwZW5kZW5jaWVzOiBLbm9ja291dC5qcywgQmFja2JvbmUuanMsIGFuZCBVbmRlcnNjb3JlLmpzIChvciBMb0Rhc2guanMpLgoJICBPcHRpb25hbCBkZXBlbmRlbmNpZXM6IEJhY2tib25lLk1vZGVsUmVmLmpzIGFuZCBCYWNrYm9uZU9STS4KCSAqLwoJdmFyIEtFWVNfT1BUSU9OUywgYXNzaWduVmlld01vZGVsS2V5LCBjcmVhdGVPYnNlcnZhYmxlLCBjcmVhdGVTdGF0aWNPYnNlcnZhYmxlcywga2IsIGtvLCBfLCBfcmVmOwoKCV9yZWYgPSBrYiA9IF9fd2VicGFja19yZXF1aXJlX18oNiksIF8gPSBfcmVmLl8sIGtvID0gX3JlZi5rbzsKCglhc3NpZ25WaWV3TW9kZWxLZXkgPSBmdW5jdGlvbih2bSwga2V5KSB7CgkgIHZhciB2bV9rZXk7CgkgIHZtX2tleSA9IHZtLl9fa2IuaW50ZXJuYWxzICYmIF8uY29udGFpbnModm0uX19rYi5pbnRlcm5hbHMsIGtleSkgPyAiXyIgKyBrZXkgOiBrZXk7CgkgIGlmICh2bS5fX2tiLnZpZXdfbW9kZWwuaGFzT3duUHJvcGVydHkodm1fa2V5KSkgewoJICAgIHJldHVybjsKCSAgfQoJICB2bS5fX2tiLnZpZXdfbW9kZWxbdm1fa2V5XSA9IG51bGw7CgkgIHJldHVybiB2bV9rZXk7Cgl9OwoKCWNyZWF0ZU9ic2VydmFibGUgPSBmdW5jdGlvbih2bSwgbW9kZWwsIGtleSwgY3JlYXRlX29wdGlvbnMpIHsKCSAgdmFyIHZtX2tleTsKCSAgaWYgKHZtLl9fa2IuZXhjbHVkZXMgJiYgXy5jb250YWlucyh2bS5fX2tiLmV4Y2x1ZGVzLCBrZXkpKSB7CgkgICAgcmV0dXJuOwoJICB9CgkgIGlmICh2bS5fX2tiLnN0YXRpY3MgJiYgXy5jb250YWlucyh2bS5fX2tiLnN0YXRpY3MsIGtleSkpIHsKCSAgICByZXR1cm47CgkgIH0KCSAgaWYgKCEodm1fa2V5ID0gYXNzaWduVmlld01vZGVsS2V5KHZtLCBrZXkpKSkgewoJICAgIHJldHVybjsKCSAgfQoJICByZXR1cm4gdm1bdm1fa2V5XSA9IHZtLl9fa2Iudmlld19tb2RlbFt2bV9rZXldID0ga2Iub2JzZXJ2YWJsZShtb2RlbCwga2V5LCBjcmVhdGVfb3B0aW9ucywgdm0pOwoJfTsKCgljcmVhdGVTdGF0aWNPYnNlcnZhYmxlcyA9IGZ1bmN0aW9uKHZtLCBtb2RlbCkgewoJICB2YXIga2V5LCB2bV9rZXksIF9pLCBfbGVuLCBfcmVmMTsKCSAgX3JlZjEgPSB2bS5fX2tiLnN0YXRpY3M7CgkgIGZvciAoX2kgPSAwLCBfbGVuID0gX3JlZjEubGVuZ3RoOyBfaSA8IF9sZW47IF9pKyspIHsKCSAgICBrZXkgPSBfcmVmMVtfaV07CgkgICAgaWYgKHZtX2tleSA9IGFzc2lnblZpZXdNb2RlbEtleSh2bSwga2V5KSkgewoJICAgICAgaWYgKG1vZGVsLmhhcyh2bV9rZXkpKSB7CgkgICAgICAgIHZtW3ZtX2tleV0gPSB2bS5fX2tiLnZpZXdfbW9kZWxbdm1fa2V5XSA9IG1vZGVsLmdldCh2bV9rZXkpOwoJICAgICAgfSBlbHNlIGlmICh2bS5fX2tiLnN0YXRpY19kZWZhdWx0cyAmJiB2bV9rZXkgaW4gdm0uX19rYi5zdGF0aWNfZGVmYXVsdHMpIHsKCSAgICAgICAgdm1bdm1fa2V5XSA9IHZtLl9fa2Iudmlld19tb2RlbFt2bV9rZXldID0gdm0uX19rYi5zdGF0aWNfZGVmYXVsdHNbdm1fa2V5XTsKCSAgICAgIH0gZWxzZSB7CgkgICAgICAgIGRlbGV0ZSB2bS5fX2tiLnZpZXdfbW9kZWxbdm1fa2V5XTsKCSAgICAgIH0KCSAgICB9CgkgIH0KCX07CgoJS0VZU19PUFRJT05TID0gWydrZXlzJywgJ2ludGVybmFscycsICdleGNsdWRlcycsICdzdGF0aWNzJywgJ3N0YXRpY19kZWZhdWx0cyddOwoKCWtiLlZpZXdNb2RlbCA9IChmdW5jdGlvbigpIHsKCSAgVmlld01vZGVsLmV4dGVuZCA9IGtiLmV4dGVuZDsKCgkgIGZ1bmN0aW9uIFZpZXdNb2RlbChtb2RlbCwgb3B0aW9ucywgdmlld19tb2RlbCkgewoJICAgIHZhciBhcmdzOwoJICAgIGlmIChvcHRpb25zID09IG51bGwpIHsKCSAgICAgIG9wdGlvbnMgPSB7fTsKCSAgICB9CgkgICAgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKF8uaXNBcmd1bWVudHMobW9kZWwpID8gbW9kZWwgOiBhcmd1bWVudHMpOwoJICAgIHJldHVybiBrYi5pZ25vcmUoKGZ1bmN0aW9uKF90aGlzKSB7CgkgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CgkgICAgICAgIHZhciBhcmcsIGV2ZW50X3dhdGNoZXIsIGtleSwgX2ksIF9qLCBfbGVuLCBfbGVuMSwgX21vZGVsOwoJICAgICAgICAhKG1vZGVsID0gYXJncy5zaGlmdCgpKSB8fCBrYi5pc01vZGVsKG1vZGVsKSB8fCBrYi5fdGhyb3dVbmV4cGVjdGVkKF90aGlzLCAnbm90IGEgbW9kZWwnKTsKCSAgICAgICAgaWYgKF8uaXNBcnJheShhcmdzWzBdKSkgewoJICAgICAgICAgIGFyZ3NbMF0gPSB7CgkgICAgICAgICAgICBrZXlzOiBhcmdzWzBdCgkgICAgICAgICAgfTsKCSAgICAgICAgfQoJICAgICAgICBfdGhpcy5fX2tiIHx8IChfdGhpcy5fX2tiID0ge30pOwoJICAgICAgICBfdGhpcy5fX2tiLnZpZXdfbW9kZWwgPSAoYXJncy5sZW5ndGggPiAxID8gYXJncy5wb3AoKSA6IF90aGlzKTsKCSAgICAgICAgb3B0aW9ucyA9IHt9OwoJICAgICAgICBmb3IgKF9pID0gMCwgX2xlbiA9IGFyZ3MubGVuZ3RoOyBfaSA8IF9sZW47IF9pKyspIHsKCSAgICAgICAgICBhcmcgPSBhcmdzW19pXTsKCSAgICAgICAgICBfLmV4dGVuZChvcHRpb25zLCBhcmcpOwoJICAgICAgICB9CgkgICAgICAgIG9wdGlvbnMgPSBrYi51dGlscy5jb2xsYXBzZU9wdGlvbnMob3B0aW9ucyk7CgkgICAgICAgIGZvciAoX2ogPSAwLCBfbGVuMSA9IEtFWVNfT1BUSU9OUy5sZW5ndGg7IF9qIDwgX2xlbjE7IF9qKyspIHsKCSAgICAgICAgICBrZXkgPSBLRVlTX09QVElPTlNbX2pdOwoJICAgICAgICAgIGlmIChvcHRpb25zLmhhc093blByb3BlcnR5KGtleSkpIHsKCSAgICAgICAgICAgIF90aGlzLl9fa2Jba2V5XSA9IG9wdGlvbnNba2V5XTsKCSAgICAgICAgICB9CgkgICAgICAgIH0KCSAgICAgICAga2IuU3RvcmUudXNlT3B0aW9uc09yQ3JlYXRlKG9wdGlvbnMsIG1vZGVsLCBfdGhpcyk7CgkgICAgICAgIF90aGlzLl9fa2IucGF0aCA9IG9wdGlvbnMucGF0aDsKCSAgICAgICAga2IuRmFjdG9yeS51c2VPcHRpb25zT3JDcmVhdGUob3B0aW9ucywgX3RoaXMsIG9wdGlvbnMucGF0aCk7CgkgICAgICAgIF9tb2RlbCA9IGtiLnV0aWxzLnNldChfdGhpcywgJ19tb2RlbCcsIGtvLm9ic2VydmFibGUoKSk7CgkgICAgICAgIF90aGlzLm1vZGVsID0ga28uY29tcHV0ZWQoewoJICAgICAgICAgIHJlYWQ6IGZ1bmN0aW9uKCkgewoJICAgICAgICAgICAgcmV0dXJuIGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUoX21vZGVsKTsKCSAgICAgICAgICB9LAoJICAgICAgICAgIHdyaXRlOiBmdW5jdGlvbihuZXdfbW9kZWwpIHsKCSAgICAgICAgICAgIHJldHVybiBrYi5pZ25vcmUoZnVuY3Rpb24oKSB7CgkgICAgICAgICAgICAgIGlmICgoa2IudXRpbHMud3JhcHBlZE9iamVjdChfdGhpcykgPT09IG5ld19tb2RlbCkgfHwga2Iud2FzUmVsZWFzZWQoX3RoaXMpIHx8ICFldmVudF93YXRjaGVyKSB7CgkgICAgICAgICAgICAgICAgcmV0dXJuOwoJICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgIF90aGlzLl9fa2Iuc3RvcmUucmV1c2UoX3RoaXMsIGtiLnV0aWxzLnJlc29sdmVNb2RlbChuZXdfbW9kZWwpKTsKCSAgICAgICAgICAgICAgZXZlbnRfd2F0Y2hlci5lbWl0dGVyKG5ld19tb2RlbCk7CgkgICAgICAgICAgICAgIF9tb2RlbChldmVudF93YXRjaGVyLmVlKTsKCSAgICAgICAgICAgICAgcmV0dXJuICFldmVudF93YXRjaGVyLmVlIHx8IF90aGlzLmNyZWF0ZU9ic2VydmFibGVzKGV2ZW50X3dhdGNoZXIuZWUpOwoJICAgICAgICAgICAgfSk7CgkgICAgICAgICAgfQoJICAgICAgICB9KTsKCSAgICAgICAgZXZlbnRfd2F0Y2hlciA9IGtiLnV0aWxzLndyYXBwZWRFdmVudFdhdGNoZXIoX3RoaXMsIG5ldyBrYi5FdmVudFdhdGNoZXIobW9kZWwsIF90aGlzLCB7CgkgICAgICAgICAgZW1pdHRlcjogX3RoaXMuX21vZGVsLAoJICAgICAgICAgIHVwZGF0ZTogKGZ1bmN0aW9uKCkgewoJICAgICAgICAgICAgcmV0dXJuIGtiLmlnbm9yZShmdW5jdGlvbigpIHsKCSAgICAgICAgICAgICAgcmV0dXJuICEoZXZlbnRfd2F0Y2hlciAhPSBudWxsID8gZXZlbnRfd2F0Y2hlci5lZSA6IHZvaWQgMCkgfHwgX3RoaXMuY3JlYXRlT2JzZXJ2YWJsZXMoZXZlbnRfd2F0Y2hlciAhPSBudWxsID8gZXZlbnRfd2F0Y2hlci5lZSA6IHZvaWQgMCk7CgkgICAgICAgICAgICB9KTsKCSAgICAgICAgICB9KQoJICAgICAgICB9KSk7CgkgICAgICAgIGtiLnV0aWxzLndyYXBwZWRPYmplY3QoX3RoaXMsIG1vZGVsID0gZXZlbnRfd2F0Y2hlci5lZSk7CgkgICAgICAgIF9tb2RlbChldmVudF93YXRjaGVyLmVlKTsKCSAgICAgICAgX3RoaXMuX19rYi5jcmVhdGVfb3B0aW9ucyA9IHsKCSAgICAgICAgICBzdG9yZToga2IudXRpbHMud3JhcHBlZFN0b3JlKF90aGlzKSwKCSAgICAgICAgICBmYWN0b3J5OiBrYi51dGlscy53cmFwcGVkRmFjdG9yeShfdGhpcyksCgkgICAgICAgICAgcGF0aDogX3RoaXMuX19rYi5wYXRoLAoJICAgICAgICAgIGV2ZW50X3dhdGNoZXI6IGtiLnV0aWxzLndyYXBwZWRFdmVudFdhdGNoZXIoX3RoaXMpCgkgICAgICAgIH07CgkgICAgICAgICFvcHRpb25zLnJlcXVpcmVzIHx8IF90aGlzLmNyZWF0ZU9ic2VydmFibGVzKG1vZGVsLCBvcHRpb25zLnJlcXVpcmVzKTsKCSAgICAgICAgIV90aGlzLl9fa2IuaW50ZXJuYWxzIHx8IF90aGlzLmNyZWF0ZU9ic2VydmFibGVzKG1vZGVsLCBfdGhpcy5fX2tiLmludGVybmFscyk7CgkgICAgICAgICFvcHRpb25zLm1hcHBpbmdzIHx8IF90aGlzLmNyZWF0ZU9ic2VydmFibGVzKG1vZGVsLCBvcHRpb25zLm1hcHBpbmdzKTsKCSAgICAgICAgIV90aGlzLl9fa2Iuc3RhdGljcyB8fCBjcmVhdGVTdGF0aWNPYnNlcnZhYmxlcyhfdGhpcywgbW9kZWwpOwoJICAgICAgICBfdGhpcy5jcmVhdGVPYnNlcnZhYmxlcyhtb2RlbCwgX3RoaXMuX19rYi5rZXlzKTsKCSAgICAgICAgIWtiLnN0YXRpc3RpY3MgfHwga2Iuc3RhdGlzdGljcy5yZWdpc3RlcignVmlld01vZGVsJywgX3RoaXMpOwoJICAgICAgICByZXR1cm4gX3RoaXM7CgkgICAgICB9OwoJICAgIH0pKHRoaXMpKTsKCSAgfQoKCSAgVmlld01vZGVsLnByb3RvdHlwZS5kZXN0cm95ID0gZnVuY3Rpb24oKSB7CgkgICAgdmFyIHZtX2tleTsKCSAgICB0aGlzLl9fa2JfcmVsZWFzZWQgPSB0cnVlOwoJICAgIGlmICh0aGlzLl9fa2Iudmlld19tb2RlbCAhPT0gdGhpcykgewoJICAgICAgZm9yICh2bV9rZXkgaW4gdGhpcy5fX2tiLnZtX2tleXMpIHsKCSAgICAgICAgdGhpcy5fX2tiLnZpZXdfbW9kZWxbdm1fa2V5XSA9IG51bGw7CgkgICAgICB9CgkgICAgfQoJICAgIHRoaXMuX19rYi52aWV3X21vZGVsID0gdGhpcy5fX2tiLmNyZWF0ZV9vcHRpb25zID0gbnVsbDsKCSAgICBrYi5yZWxlYXNlS2V5cyh0aGlzKTsKCSAgICBrYi51dGlscy53cmFwcGVkRGVzdHJveSh0aGlzKTsKCSAgICByZXR1cm4gIWtiLnN0YXRpc3RpY3MgfHwga2Iuc3RhdGlzdGljcy51bnJlZ2lzdGVyKCdWaWV3TW9kZWwnLCB0aGlzKTsKCSAgfTsKCgkgIFZpZXdNb2RlbC5wcm90b3R5cGUuc2hhcmVPcHRpb25zID0gZnVuY3Rpb24oKSB7CgkgICAgcmV0dXJuIHsKCSAgICAgIHN0b3JlOiBrYi51dGlscy53cmFwcGVkU3RvcmUodGhpcyksCgkgICAgICBmYWN0b3J5OiBrYi51dGlscy53cmFwcGVkRmFjdG9yeSh0aGlzKQoJICAgIH07CgkgIH07CgoJICBWaWV3TW9kZWwucHJvdG90eXBlLmNyZWF0ZU9ic2VydmFibGVzID0gZnVuY3Rpb24obW9kZWwsIGtleXMpIHsKCSAgICB2YXIga2V5LCBtYXBwaW5nX2luZm8sIHJlbF9rZXlzLCB2bV9rZXksIF9pLCBfaiwgX2xlbiwgX2xlbjEsIF9yZWYxOwoJICAgIGlmICgha2V5cykgewoJICAgICAgaWYgKHRoaXMuX19rYi5rZXlzIHx8ICFtb2RlbCkgewoJICAgICAgICByZXR1cm47CgkgICAgICB9CgkgICAgICBmb3IgKGtleSBpbiBtb2RlbC5hdHRyaWJ1dGVzKSB7CgkgICAgICAgIGNyZWF0ZU9ic2VydmFibGUodGhpcywgbW9kZWwsIGtleSwgdGhpcy5fX2tiLmNyZWF0ZV9vcHRpb25zKTsKCSAgICAgIH0KCSAgICAgIGlmIChyZWxfa2V5cyA9IChfcmVmMSA9IGtiLm9ybSkgIT0gbnVsbCA/IHR5cGVvZiBfcmVmMS5rZXlzID09PSAiZnVuY3Rpb24iID8gX3JlZjEua2V5cyhtb2RlbCkgOiB2b2lkIDAgOiB2b2lkIDApIHsKCSAgICAgICAgZm9yIChfaSA9IDAsIF9sZW4gPSByZWxfa2V5cy5sZW5ndGg7IF9pIDwgX2xlbjsgX2krKykgewoJICAgICAgICAgIGtleSA9IHJlbF9rZXlzW19pXTsKCSAgICAgICAgICBjcmVhdGVPYnNlcnZhYmxlKHRoaXMsIG1vZGVsLCBrZXksIHRoaXMuX19rYi5jcmVhdGVfb3B0aW9ucyk7CgkgICAgICAgIH0KCSAgICAgIH0KCSAgICB9IGVsc2UgaWYgKF8uaXNBcnJheShrZXlzKSkgewoJICAgICAgZm9yIChfaiA9IDAsIF9sZW4xID0ga2V5cy5sZW5ndGg7IF9qIDwgX2xlbjE7IF9qKyspIHsKCSAgICAgICAga2V5ID0ga2V5c1tfal07CgkgICAgICAgIGNyZWF0ZU9ic2VydmFibGUodGhpcywgbW9kZWwsIGtleSwgdGhpcy5fX2tiLmNyZWF0ZV9vcHRpb25zKTsKCSAgICAgIH0KCSAgICB9IGVsc2UgewoJICAgICAgZm9yIChrZXkgaW4ga2V5cykgewoJICAgICAgICBtYXBwaW5nX2luZm8gPSBrZXlzW2tleV07CgkgICAgICAgIGlmICghKHZtX2tleSA9IGFzc2lnblZpZXdNb2RlbEtleSh0aGlzLCBrZXkpKSkgewoJICAgICAgICAgIGNvbnRpbnVlOwoJICAgICAgICB9CgkgICAgICAgIGlmICghXy5pc1N0cmluZyhtYXBwaW5nX2luZm8pKSB7CgkgICAgICAgICAgbWFwcGluZ19pbmZvLmtleSB8fCAobWFwcGluZ19pbmZvLmtleSA9IHZtX2tleSk7CgkgICAgICAgIH0KCSAgICAgICAgdGhpc1t2bV9rZXldID0gdGhpcy5fX2tiLnZpZXdfbW9kZWxbdm1fa2V5XSA9IGtiLm9ic2VydmFibGUobW9kZWwsIG1hcHBpbmdfaW5mbywgdGhpcy5fX2tiLmNyZWF0ZV9vcHRpb25zLCB0aGlzKTsKCSAgICAgIH0KCSAgICB9CgkgIH07CgoJICByZXR1cm4gVmlld01vZGVsOwoKCX0pKCk7CgoJa2Iudmlld01vZGVsID0gZnVuY3Rpb24obW9kZWwsIG9wdGlvbnMsIHZpZXdfbW9kZWwpIHsKCSAgcmV0dXJuIG5ldyBrYi5WaWV3TW9kZWwoYXJndW1lbnRzKTsKCX07CgoKLyoqKi8gfSwKLyogMTQgKi8KLyoqKi8gZnVuY3Rpb24obW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CgoJCgkvKgoJICBrbm9ja2JhY2suanMgMC4yMC40CgkgIENvcHlyaWdodCAoYykgIDIwMTEtMjAxNCBLZXZpbiBNYWxha29mZi4KCSAgTGljZW5zZTogTUlUIChodHRwOi8vd3d3Lm9wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL21pdC1saWNlbnNlLnBocCkKCSAgU291cmNlOiBodHRwczovL2dpdGh1Yi5jb20va21hbGFrb2ZmL2tub2NrYmFjawoJICBEZXBlbmRlbmNpZXM6IEtub2Nrb3V0LmpzLCBCYWNrYm9uZS5qcywgYW5kIFVuZGVyc2NvcmUuanMgKG9yIExvRGFzaC5qcykuCgkgIE9wdGlvbmFsIGRlcGVuZGVuY2llczogQmFja2JvbmUuTW9kZWxSZWYuanMgYW5kIEJhY2tib25lT1JNLgoJICovCgl2YXIga2IsIGtleSwgX2ksIF9sZW4sIF9yZWY7CgoJbW9kdWxlLmV4cG9ydHMgPSBrYiA9IF9fd2VicGFja19yZXF1aXJlX18oNik7CgoJa2IuY29uZmlndXJlID0gX193ZWJwYWNrX3JlcXVpcmVfXygyKTsKCglrYi5tb2R1bGVzID0gewoJICB1bmRlcnNjb3JlOiBrYi5fLAoJICBiYWNrYm9uZToga2IuUGFyc2UgfHwga2IuQmFja2JvbmUsCgkgIGtub2Nrb3V0OiBrYi5rbwoJfTsKCglpZiAodHlwZW9mIHdpbmRvdyAhPT0gInVuZGVmaW5lZCIgJiYgd2luZG93ICE9PSBudWxsKSB7CgkgIF9yZWYgPSBbJ18nLCAnQmFja2JvbmUnLCAnUGFyc2UnLCAna28nLCAnJCddOwoJICBmb3IgKF9pID0gMCwgX2xlbiA9IF9yZWYubGVuZ3RoOyBfaSA8IF9sZW47IF9pKyspIHsKCSAgICBrZXkgPSBfcmVmW19pXTsKCSAgICBpZiAoa2Jba2V5XSAmJiAhT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHdpbmRvdywga2V5KSkgewoJICAgICAgd2luZG93W2tleV0gPSBrYltrZXldOwoJICAgIH0KCSAgfQoJfQoKCi8qKiovIH0sCi8qIDE1ICovCi8qKiovIGZ1bmN0aW9uKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewoKCW1vZHVsZS5leHBvcnRzID0gX19XRUJQQUNLX0VYVEVSTkFMX01PRFVMRV8xNV9fOwoKLyoqKi8gfSwKLyogMTYgKi8KLyoqKi8gZnVuY3Rpb24obW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CgoJCgkvKgoJICBrbm9ja2JhY2suanMgMC4yMC40CgkgIENvcHlyaWdodCAoYykgIDIwMTEtMjAxNCBLZXZpbiBNYWxha29mZi4KCSAgTGljZW5zZTogTUlUIChodHRwOi8vd3d3Lm9wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL21pdC1saWNlbnNlLnBocCkKCSAgU291cmNlOiBodHRwczovL2dpdGh1Yi5jb20va21hbGFrb2ZmL2tub2NrYmFjawoJICBEZXBlbmRlbmNpZXM6IEtub2Nrb3V0LmpzLCBCYWNrYm9uZS5qcywgYW5kIFVuZGVyc2NvcmUuanMgKG9yIExvRGFzaC5qcykuCgkgIE9wdGlvbmFsIGRlcGVuZGVuY2llczogQmFja2JvbmUuTW9kZWxSZWYuanMgYW5kIEJhY2tib25lT1JNLgoJICovCgl2YXIgQXNzb2NpYXRlZE1vZGVsLCBCYWNrYm9uZSwgQmFja2JvbmVBc3NvY2lhdGlvbnMsIGtiLCBfLCBfcmVmOwoKCV9yZWYgPSBrYiA9IF9fd2VicGFja19yZXF1aXJlX18oNiksIF8gPSBfcmVmLl8sIEJhY2tib25lID0gX3JlZi5CYWNrYm9uZTsKCglBc3NvY2lhdGVkTW9kZWwgPSBudWxsOwoKCW1vZHVsZS5leHBvcnRzID0gQmFja2JvbmVBc3NvY2lhdGlvbnMgPSAoZnVuY3Rpb24oKSB7CgkgIGZ1bmN0aW9uIEJhY2tib25lQXNzb2NpYXRpb25zKCkge30KCgkgIEJhY2tib25lQXNzb2NpYXRpb25zLmlzQXZhaWxhYmxlID0gZnVuY3Rpb24oKSB7CgkgICAgcmV0dXJuICEhKEFzc29jaWF0ZWRNb2RlbCA9IEJhY2tib25lICE9IG51bGwgPyBCYWNrYm9uZS5Bc3NvY2lhdGVkTW9kZWwgOiB2b2lkIDApOwoJICB9OwoKCSAgQmFja2JvbmVBc3NvY2lhdGlvbnMua2V5cyA9IGZ1bmN0aW9uKG1vZGVsKSB7CgkgICAgaWYgKCEobW9kZWwgaW5zdGFuY2VvZiBBc3NvY2lhdGVkTW9kZWwpKSB7CgkgICAgICByZXR1cm4gbnVsbDsKCSAgICB9CgkgICAgcmV0dXJuIF8ubWFwKG1vZGVsLnJlbGF0aW9ucywgZnVuY3Rpb24odGVzdCkgewoJICAgICAgcmV0dXJuIHRlc3Qua2V5OwoJICAgIH0pOwoJICB9OwoKCSAgQmFja2JvbmVBc3NvY2lhdGlvbnMucmVsYXRpb25UeXBlID0gZnVuY3Rpb24obW9kZWwsIGtleSkgewoJICAgIHZhciByZWxhdGlvbjsKCSAgICBpZiAoIShtb2RlbCBpbnN0YW5jZW9mIEFzc29jaWF0ZWRNb2RlbCkpIHsKCSAgICAgIHJldHVybiBudWxsOwoJICAgIH0KCSAgICBpZiAoIShyZWxhdGlvbiA9IF8uZmluZChtb2RlbC5yZWxhdGlvbnMsIGZ1bmN0aW9uKHRlc3QpIHsKCSAgICAgIHJldHVybiB0ZXN0LmtleSA9PT0ga2V5OwoJICAgIH0pKSkgewoJICAgICAgcmV0dXJuIG51bGw7CgkgICAgfQoJICAgIGlmIChyZWxhdGlvbi50eXBlID09PSAnTWFueScpIHsKCSAgICAgIHJldHVybiBrYi5UWVBFX0NPTExFQ1RJT047CgkgICAgfSBlbHNlIHsKCSAgICAgIHJldHVybiBrYi5UWVBFX01PREVMOwoJICAgIH0KCSAgfTsKCgkgIEJhY2tib25lQXNzb2NpYXRpb25zLnVzZUZ1bmN0aW9uID0gZnVuY3Rpb24oKSB7CgkgICAgcmV0dXJuIGZhbHNlOwoJICB9OwoKCSAgcmV0dXJuIEJhY2tib25lQXNzb2NpYXRpb25zOwoKCX0pKCk7CgoKLyoqKi8gfSwKLyogMTcgKi8KLyoqKi8gZnVuY3Rpb24obW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CgoJCgkvKgoJICBrbm9ja2JhY2suanMgMC4yMC40CgkgIENvcHlyaWdodCAoYykgIDIwMTEtMjAxNCBLZXZpbiBNYWxha29mZi4KCSAgTGljZW5zZTogTUlUIChodHRwOi8vd3d3Lm9wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL21pdC1saWNlbnNlLnBocCkKCSAgU291cmNlOiBodHRwczovL2dpdGh1Yi5jb20va21hbGFrb2ZmL2tub2NrYmFjawoJICBEZXBlbmRlbmNpZXM6IEtub2Nrb3V0LmpzLCBCYWNrYm9uZS5qcywgYW5kIFVuZGVyc2NvcmUuanMgKG9yIExvRGFzaC5qcykuCgkgIE9wdGlvbmFsIGRlcGVuZGVuY2llczogQmFja2JvbmUuTW9kZWxSZWYuanMgYW5kIEJhY2tib25lT1JNLgoJICovCgl2YXIgQmFja2JvbmUsIEJhY2tib25lUmVsYXRpb25hbCwgUmVsYXRpb25hbE1vZGVsLCBrYiwgXywgX3JlZjsKCglfcmVmID0ga2IgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDYpLCBfID0gX3JlZi5fLCBCYWNrYm9uZSA9IF9yZWYuQmFja2JvbmU7CgoJUmVsYXRpb25hbE1vZGVsID0gbnVsbDsKCgltb2R1bGUuZXhwb3J0cyA9IEJhY2tib25lUmVsYXRpb25hbCA9IChmdW5jdGlvbigpIHsKCSAgZnVuY3Rpb24gQmFja2JvbmVSZWxhdGlvbmFsKCkge30KCgkgIEJhY2tib25lUmVsYXRpb25hbC5pc0F2YWlsYWJsZSA9IGZ1bmN0aW9uKCkgewoJICAgIHJldHVybiAhIShSZWxhdGlvbmFsTW9kZWwgPSBCYWNrYm9uZSAhPSBudWxsID8gQmFja2JvbmUuUmVsYXRpb25hbE1vZGVsIDogdm9pZCAwKTsKCSAgfTsKCgkgIEJhY2tib25lUmVsYXRpb25hbC5yZWxhdGlvblR5cGUgPSBmdW5jdGlvbihtb2RlbCwga2V5KSB7CgkgICAgdmFyIHJlbGF0aW9uOwoJICAgIGlmICghKG1vZGVsIGluc3RhbmNlb2YgUmVsYXRpb25hbE1vZGVsKSkgewoJICAgICAgcmV0dXJuIG51bGw7CgkgICAgfQoJICAgIGlmICghKHJlbGF0aW9uID0gXy5maW5kKG1vZGVsLmdldFJlbGF0aW9ucygpLCBmdW5jdGlvbih0ZXN0KSB7CgkgICAgICByZXR1cm4gdGVzdC5rZXkgPT09IGtleTsKCSAgICB9KSkpIHsKCSAgICAgIHJldHVybiBudWxsOwoJICAgIH0KCSAgICBpZiAocmVsYXRpb24uY29sbGVjdGlvblR5cGUgfHwgXy5pc0FycmF5KHJlbGF0aW9uLmtleUNvbnRlbnRzKSkgewoJICAgICAgcmV0dXJuIGtiLlRZUEVfQ09MTEVDVElPTjsKCSAgICB9IGVsc2UgewoJICAgICAgcmV0dXJuIGtiLlRZUEVfTU9ERUw7CgkgICAgfQoJICB9OwoKCSAgQmFja2JvbmVSZWxhdGlvbmFsLmJpbmQgPSBmdW5jdGlvbihtb2RlbCwga2V5LCB1cGRhdGUsIHBhdGgpIHsKCSAgICB2YXIgZXZlbnQsIGV2ZW50cywgcmVsX2ZuLCB0eXBlLCBfaSwgX2xlbjsKCSAgICBpZiAoISh0eXBlID0gdGhpcy5yZWxhdGlvblR5cGUobW9kZWwsIGtleSkpKSB7CgkgICAgICByZXR1cm4gbnVsbDsKCSAgICB9CgkgICAgcmVsX2ZuID0gZnVuY3Rpb24obW9kZWwpIHsKCSAgICAgICFrYi5zdGF0aXN0aWNzIHx8IGtiLnN0YXRpc3RpY3MuYWRkTW9kZWxFdmVudCh7CgkgICAgICAgIG5hbWU6ICd1cGRhdGUgKHJlbGF0aW9uYWwpJywKCSAgICAgICAgbW9kZWw6IG1vZGVsLAoJICAgICAgICBrZXk6IGtleSwKCSAgICAgICAgcGF0aDogcGF0aAoJICAgICAgfSk7CgkgICAgICByZXR1cm4gdXBkYXRlKCk7CgkgICAgfTsKCSAgICBldmVudHMgPSBrYi5CYWNrYm9uZS5SZWxhdGlvbi5wcm90b3R5cGUuc2FuaXRpemVPcHRpb25zID8gWyd1cGRhdGUnLCAnYWRkJywgJ3JlbW92ZSddIDogWydjaGFuZ2UnLCAnYWRkJywgJ3JlbW92ZSddOwoJICAgIGlmICh0eXBlID09PSBrYi5UWVBFX0NPTExFQ1RJT04pIHsKCSAgICAgIGZvciAoX2kgPSAwLCBfbGVuID0gZXZlbnRzLmxlbmd0aDsgX2kgPCBfbGVuOyBfaSsrKSB7CgkgICAgICAgIGV2ZW50ID0gZXZlbnRzW19pXTsKCSAgICAgICAgbW9kZWwuYmluZCgiIiArIGV2ZW50ICsgIjoiICsga2V5LCByZWxfZm4pOwoJICAgICAgfQoJICAgIH0gZWxzZSB7CgkgICAgICBtb2RlbC5iaW5kKCIiICsgZXZlbnRzWzBdICsgIjoiICsga2V5LCByZWxfZm4pOwoJICAgIH0KCSAgICByZXR1cm4gZnVuY3Rpb24oKSB7CgkgICAgICB2YXIgX2osIF9sZW4xOwoJICAgICAgaWYgKHR5cGUgPT09IGtiLlRZUEVfQ09MTEVDVElPTikgewoJICAgICAgICBmb3IgKF9qID0gMCwgX2xlbjEgPSBldmVudHMubGVuZ3RoOyBfaiA8IF9sZW4xOyBfaisrKSB7CgkgICAgICAgICAgZXZlbnQgPSBldmVudHNbX2pdOwoJICAgICAgICAgIG1vZGVsLnVuYmluZCgiIiArIGV2ZW50ICsgIjoiICsga2V5LCByZWxfZm4pOwoJICAgICAgICB9CgkgICAgICB9IGVsc2UgewoJICAgICAgICBtb2RlbC51bmJpbmQoIiIgKyBldmVudHNbMF0gKyAiOiIgKyBrZXksIHJlbF9mbik7CgkgICAgICB9CgkgICAgfTsKCSAgfTsKCgkgIEJhY2tib25lUmVsYXRpb25hbC51c2VGdW5jdGlvbiA9IGZ1bmN0aW9uKCkgewoJICAgIHJldHVybiBmYWxzZTsKCSAgfTsKCgkgIHJldHVybiBCYWNrYm9uZVJlbGF0aW9uYWw7CgoJfSkoKTsKCgovKioqLyB9LAovKiAxOCAqLwovKioqLyBmdW5jdGlvbihtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKCgkvKiBXRUJQQUNLIFZBUiBJTkpFQ1RJT04gKi8oZnVuY3Rpb24oZ2xvYmFsKSB7CgkvKgoJICBrbm9ja2JhY2suanMgMC4yMC40CgkgIENvcHlyaWdodCAoYykgIDIwMTEtMjAxNCBLZXZpbiBNYWxha29mZi4KCSAgTGljZW5zZTogTUlUIChodHRwOi8vd3d3Lm9wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL21pdC1saWNlbnNlLnBocCkKCSAgU291cmNlOiBodHRwczovL2dpdGh1Yi5jb20va21hbGFrb2ZmL2tub2NrYmFjawoJICBEZXBlbmRlbmNpZXM6IEtub2Nrb3V0LmpzLCBCYWNrYm9uZS5qcywgYW5kIFVuZGVyc2NvcmUuanMgKG9yIExvRGFzaC5qcykuCgkgIE9wdGlvbmFsIGRlcGVuZGVuY2llczogQmFja2JvbmUuTW9kZWxSZWYuanMgYW5kIEJhY2tib25lT1JNLgoJICovCgl2YXIgU3VwZXJtb2RlbCwga2IsIHJvb3QsIF87CgoJcm9vdCA9IHR5cGVvZiB3aW5kb3cgIT09ICJ1bmRlZmluZWQiICYmIHdpbmRvdyAhPT0gbnVsbCA/IHdpbmRvdyA6IGdsb2JhbDsKCglfID0gKGtiID0gX193ZWJwYWNrX3JlcXVpcmVfXyg2KSkuXzsKCglTdXBlcm1vZGVsID0gbnVsbDsKCgltb2R1bGUuZXhwb3J0cyA9IFN1cGVybW9kZWwgPSAoZnVuY3Rpb24oKSB7CgkgIGZ1bmN0aW9uIFN1cGVybW9kZWwoKSB7fQoKCSAgU3VwZXJtb2RlbC5pc0F2YWlsYWJsZSA9IGZ1bmN0aW9uKCkgewoJICAgIHJldHVybiAhIShTdXBlcm1vZGVsID0gcm9vdC5TdXBlcm1vZGVsKTsKCSAgfTsKCgkgIFN1cGVybW9kZWwua2V5cyA9IGZ1bmN0aW9uKG1vZGVsKSB7CgkgICAgaWYgKCEobW9kZWwgaW5zdGFuY2VvZiBTdXBlcm1vZGVsLk1vZGVsKSkgewoJICAgICAgcmV0dXJuIG51bGw7CgkgICAgfQoJICAgIHJldHVybiBfLmtleXMobW9kZWwuY29uc3RydWN0b3IuYXNzb2NpYXRpb25zKCkpOwoJICB9OwoKCSAgU3VwZXJtb2RlbC5yZWxhdGlvblR5cGUgPSBmdW5jdGlvbihtb2RlbCwga2V5KSB7CgkgICAgdmFyIHJlbGF0aW9uOwoJICAgIGlmICghKG1vZGVsIGluc3RhbmNlb2YgU3VwZXJtb2RlbC5Nb2RlbCkpIHsKCSAgICAgIHJldHVybiBudWxsOwoJICAgIH0KCSAgICBpZiAoIShyZWxhdGlvbiA9IG1vZGVsLmNvbnN0cnVjdG9yLmFzc29jaWF0aW9ucygpW2tleV0pKSB7CgkgICAgICByZXR1cm4gbnVsbDsKCSAgICB9CgkgICAgaWYgKHJlbGF0aW9uLmFkZCkgewoJICAgICAgcmV0dXJuIGtiLlRZUEVfQ09MTEVDVElPTjsKCSAgICB9IGVsc2UgewoJICAgICAgcmV0dXJuIGtiLlRZUEVfTU9ERUw7CgkgICAgfQoJICB9OwoKCSAgU3VwZXJtb2RlbC5iaW5kID0gZnVuY3Rpb24obW9kZWwsIGtleSwgdXBkYXRlLCBwYXRoKSB7CgkgICAgdmFyIHJlbF9mbiwgdHlwZTsKCSAgICBpZiAoISh0eXBlID0gdGhpcy5yZWxhdGlvblR5cGUobW9kZWwsIGtleSkpKSB7CgkgICAgICByZXR1cm4gbnVsbDsKCSAgICB9CgkgICAgcmVsX2ZuID0gZnVuY3Rpb24obW9kZWwsIG90aGVyKSB7CgkgICAgICB2YXIgcHJldmlvdXMsIHJlbGF0aW9uOwoJICAgICAgIWtiLnN0YXRpc3RpY3MgfHwga2Iuc3RhdGlzdGljcy5hZGRNb2RlbEV2ZW50KHsKCSAgICAgICAgbmFtZTogJ3VwZGF0ZSAoc3VwZXJtb2RlbCknLAoJICAgICAgICBtb2RlbDogbW9kZWwsCgkgICAgICAgIGtleToga2V5LAoJICAgICAgICBwYXRoOiBwYXRoCgkgICAgICB9KTsKCSAgICAgIHJlbGF0aW9uID0gbW9kZWwuY29uc3RydWN0b3IuYXNzb2NpYXRpb25zKClba2V5XTsKCSAgICAgIHByZXZpb3VzID0gbW9kZWxbcmVsYXRpb24uc3RvcmVdOwoJICAgICAgbW9kZWxbcmVsYXRpb24uc3RvcmVdID0gb3RoZXI7CgkgICAgICB1cGRhdGUob3RoZXIpOwoJICAgICAgcmV0dXJuIG1vZGVsW3JlbGF0aW9uLnN0b3JlXSA9IHByZXZpb3VzOwoJICAgIH07CgkgICAgaWYgKHR5cGUgPT09IGtiLlRZUEVfTU9ERUwpIHsKCSAgICAgIG1vZGVsLmJpbmQoImFzc29jaWF0ZToiICsga2V5LCByZWxfZm4pOwoJICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewoJICAgICAgICByZXR1cm4gbW9kZWwudW5iaW5kKCJhc3NvY2lhdGU6IiArIGtleSwgcmVsX2ZuKTsKCSAgICAgIH07CgkgICAgfQoJICB9OwoKCSAgU3VwZXJtb2RlbC51c2VGdW5jdGlvbiA9IGZ1bmN0aW9uKG1vZGVsLCBrZXkpIHsKCSAgICByZXR1cm4gISF0aGlzLnJlbGF0aW9uVHlwZShtb2RlbCwga2V5KTsKCSAgfTsKCgkgIHJldHVybiBTdXBlcm1vZGVsOwoKCX0pKCk7CgkKCS8qIFdFQlBBQ0sgVkFSIElOSkVDVElPTiAqL30uY2FsbChleHBvcnRzLCAoZnVuY3Rpb24oKSB7IHJldHVybiB0aGlzOyB9KCkpKSkKCi8qKiovIH0sCi8qIDE5ICovCi8qKiovIGZ1bmN0aW9uKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewoKCQoJLyoKCSAga25vY2tiYWNrLmpzIDAuMjAuNAoJICBDb3B5cmlnaHQgKGMpICAyMDExLTIwMTQgS2V2aW4gTWFsYWtvZmYuCgkgIExpY2Vuc2U6IE1JVCAoaHR0cDovL3d3dy5vcGVuc291cmNlLm9yZy9saWNlbnNlcy9taXQtbGljZW5zZS5waHApCgkgIFNvdXJjZTogaHR0cHM6Ly9naXRodWIuY29tL2ttYWxha29mZi9rbm9ja2JhY2sKCSAgRGVwZW5kZW5jaWVzOiBLbm9ja291dC5qcywgQmFja2JvbmUuanMsIGFuZCBVbmRlcnNjb3JlLmpzIChvciBMb0Rhc2guanMpLgoJICBPcHRpb25hbCBkZXBlbmRlbmNpZXM6IEJhY2tib25lLk1vZGVsUmVmLmpzIGFuZCBCYWNrYm9uZU9STS4KCSAqLwoJdmFyIGNvcHlQcm9wczsKCgljb3B5UHJvcHMgPSBmdW5jdGlvbihkZXN0LCBzb3VyY2UpIHsKCSAgdmFyIGtleSwgdmFsdWU7CgkgIGZvciAoa2V5IGluIHNvdXJjZSkgewoJICAgIHZhbHVlID0gc291cmNlW2tleV07CgkgICAgZGVzdFtrZXldID0gdmFsdWU7CgkgIH0KCSAgcmV0dXJuIGRlc3Q7Cgl9OwoKCS8vIFNoYXJlZCBlbXB0eSBjb25zdHJ1Y3RvciBmdW5jdGlvbiB0byBhaWQgaW4gcHJvdG90eXBlLWNoYWluIGNyZWF0aW9uLgoJdmFyIGN0b3IgPSBmdW5jdGlvbigpe307CgoJLy8gSGVscGVyIGZ1bmN0aW9uIHRvIGNvcnJlY3RseSBzZXQgdXAgdGhlIHByb3RvdHlwZSBjaGFpbiwgZm9yIHN1YmNsYXNzZXMuCgkvLyBTaW1pbGFyIHRvICdnb29nLmluaGVyaXRzJywgYnV0IHVzZXMgYSBoYXNoIG9mIHByb3RvdHlwZSBwcm9wZXJ0aWVzIGFuZAoJLy8gY2xhc3MgcHJvcGVydGllcyB0byBiZSBleHRlbmRlZC4KCXZhciBpbmhlcml0cyA9IGZ1bmN0aW9uKHBhcmVudCwgcHJvdG9Qcm9wcywgc3RhdGljUHJvcHMpIHsKCSAgdmFyIGNoaWxkOwoKCSAgLy8gVGhlIGNvbnN0cnVjdG9yIGZ1bmN0aW9uIGZvciB0aGUgbmV3IHN1YmNsYXNzIGlzIGVpdGhlciBkZWZpbmVkIGJ5IHlvdQoJICAvLyAodGhlICJjb25zdHJ1Y3RvciIgcHJvcGVydHkgaW4geW91ciBleHRlbmQgZGVmaW5pdGlvbiksIG9yIGRlZmF1bHRlZAoJICAvLyBieSB1cyB0byBzaW1wbHkgY2FsbCB0aGUgcGFyZW50J3MgY29uc3RydWN0b3IuCgkgIGlmIChwcm90b1Byb3BzICYmIHByb3RvUHJvcHMuaGFzT3duUHJvcGVydHkoJ2NvbnN0cnVjdG9yJykpIHsKCSAgICBjaGlsZCA9IHByb3RvUHJvcHMuY29uc3RydWN0b3I7CgkgIH0gZWxzZSB7CgkgICAgY2hpbGQgPSBmdW5jdGlvbigpeyBwYXJlbnQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsgfTsKCSAgfQoKCSAgLy8gSW5oZXJpdCBjbGFzcyAoc3RhdGljKSBwcm9wZXJ0aWVzIGZyb20gcGFyZW50LgoJICBjb3B5UHJvcHMoY2hpbGQsIHBhcmVudCk7CgoJICAvLyBTZXQgdGhlIHByb3RvdHlwZSBjaGFpbiB0byBpbmhlcml0IGZyb20gcGFyZW50LCB3aXRob3V0IGNhbGxpbmcKCSAgLy8gcGFyZW50J3MgY29uc3RydWN0b3IgZnVuY3Rpb24uCgkgIGN0b3IucHJvdG90eXBlID0gcGFyZW50LnByb3RvdHlwZTsKCSAgY2hpbGQucHJvdG90eXBlID0gbmV3IGN0b3IoKTsKCgkgIC8vIEFkZCBwcm90b3R5cGUgcHJvcGVydGllcyAoaW5zdGFuY2UgcHJvcGVydGllcykgdG8gdGhlIHN1YmNsYXNzLAoJICAvLyBpZiBzdXBwbGllZC4KCSAgaWYgKHByb3RvUHJvcHMpIGNvcHlQcm9wcyhjaGlsZC5wcm90b3R5cGUsIHByb3RvUHJvcHMpOwoKCSAgLy8gQWRkIHN0YXRpYyBwcm9wZXJ0aWVzIHRvIHRoZSBjb25zdHJ1Y3RvciBmdW5jdGlvbiwgaWYgc3VwcGxpZWQuCgkgIGlmIChzdGF0aWNQcm9wcykgY29weVByb3BzKGNoaWxkLCBzdGF0aWNQcm9wcyk7CgoJICAvLyBDb3JyZWN0bHkgc2V0IGNoaWxkJ3MgJ3Byb3RvdHlwZS5jb25zdHJ1Y3RvcicuCgkgIGNoaWxkLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IGNoaWxkOwoKCSAgLy8gU2V0IGEgY29udmVuaWVuY2UgcHJvcGVydHkgaW4gY2FzZSB0aGUgcGFyZW50J3MgcHJvdG90eXBlIGlzIG5lZWRlZCBsYXRlci4KCSAgY2hpbGQuX19zdXBlcl9fID0gcGFyZW50LnByb3RvdHlwZTsKCgkgIHJldHVybiBjaGlsZDsKCX07CgoJLy8gVGhlIHNlbGYtcHJvcGFnYXRpbmcgZXh0ZW5kIGZ1bmN0aW9uIHRoYXQgQmFjTENvbmUgY2xhc3NlcyB1c2UuCgl2YXIgZXh0ZW5kID0gZnVuY3Rpb24gKHByb3RvUHJvcHMsIGNsYXNzUHJvcHMpIHsKCSAgdmFyIGNoaWxkID0gaW5oZXJpdHModGhpcywgcHJvdG9Qcm9wcywgY2xhc3NQcm9wcyk7CgkgIGNoaWxkLmV4dGVuZCA9IHRoaXMuZXh0ZW5kOwoJICByZXR1cm4gY2hpbGQ7Cgl9OwoJOwoKCW1vZHVsZS5leHBvcnRzID0gZXh0ZW5kOwoKCi8qKiovIH0sCi8qIDIwICovCi8qKiovIGZ1bmN0aW9uKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewoKCQoJLyoKCSAga25vY2tiYWNrLmpzIDAuMjAuNAoJICBDb3B5cmlnaHQgKGMpICAyMDExLTIwMTQgS2V2aW4gTWFsYWtvZmYuCgkgIExpY2Vuc2U6IE1JVCAoaHR0cDovL3d3dy5vcGVuc291cmNlLm9yZy9saWNlbnNlcy9taXQtbGljZW5zZS5waHApCgkgIFNvdXJjZTogaHR0cHM6Ly9naXRodWIuY29tL2ttYWxha29mZi9rbm9ja2JhY2sKCSAgRGVwZW5kZW5jaWVzOiBLbm9ja291dC5qcywgQmFja2JvbmUuanMsIGFuZCBVbmRlcnNjb3JlLmpzIChvciBMb0Rhc2guanMpLgoJICBPcHRpb25hbCBkZXBlbmRlbmNpZXM6IEJhY2tib25lLk1vZGVsUmVmLmpzIGFuZCBCYWNrYm9uZU9STS4KCSAqLwoJdmFyIHdyYXBwZWREZXN0cm95LCBfOwoKCV8gPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDYpLl87CgoJbW9kdWxlLmV4cG9ydHMgPSB3cmFwcGVkRGVzdHJveSA9IGZ1bmN0aW9uKG9iaikgewoJICB2YXIgc3RvcmVfcmVmZXJlbmNlcywgX19rYjsKCSAgaWYgKCFvYmouX19rYikgewoJICAgIHJldHVybjsKCSAgfQoJICBpZiAob2JqLl9fa2IuZXZlbnRfd2F0Y2hlcikgewoJICAgIG9iai5fX2tiLmV2ZW50X3dhdGNoZXIucmVsZWFzZUNhbGxiYWNrcyhvYmopOwoJICB9CgkgIF9fa2IgPSBvYmouX19rYjsKCSAgb2JqLl9fa2IgPSBudWxsOwoJICBpZiAoX19rYi5vYnNlcnZhYmxlKSB7CgkgICAgX19rYi5vYnNlcnZhYmxlLmRlc3Ryb3kgPSBfX2tiLm9ic2VydmFibGUucmVsZWFzZSA9IG51bGw7CgkgICAgd3JhcHBlZERlc3Ryb3koX19rYi5vYnNlcnZhYmxlKTsKCSAgICBfX2tiLm9ic2VydmFibGUgPSBudWxsOwoJICB9CgkgIF9fa2IuZmFjdG9yeSA9IG51bGw7CgkgIGlmIChfX2tiLmV2ZW50X3dhdGNoZXJfaXNfb3duZWQpIHsKCSAgICBfX2tiLmV2ZW50X3dhdGNoZXIuZGVzdHJveSgpOwoJICB9CgkgIF9fa2IuZXZlbnRfd2F0Y2hlciA9IG51bGw7CgkgIGlmIChfX2tiLnN0b3JlX2lzX293bmVkKSB7CgkgICAgX19rYi5zdG9yZS5kZXN0cm95KCk7CgkgIH0KCSAgX19rYi5zdG9yZSA9IG51bGw7CgkgIGlmIChfX2tiLnN0b3Jlc19yZWZlcmVuY2VzKSB7CgkgICAgd2hpbGUgKHN0b3JlX3JlZmVyZW5jZXMgPSBfX2tiLnN0b3Jlc19yZWZlcmVuY2VzLnBvcCgpKSB7CgkgICAgICBpZiAoIXN0b3JlX3JlZmVyZW5jZXMuc3RvcmUuX19rYl9yZWxlYXNlZCkgewoJICAgICAgICBzdG9yZV9yZWZlcmVuY2VzLnN0b3JlLnJlbGVhc2Uob2JqKTsKCSAgICAgIH0KCSAgICB9CgkgIH0KCX07CgoKLyoqKi8gfSwKLyogMjEgKi8KLyoqKi8gZnVuY3Rpb24obW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CgoJCgkvKgoJICBrbm9ja2JhY2suanMgMC4yMC40CgkgIENvcHlyaWdodCAoYykgIDIwMTEtMjAxNCBLZXZpbiBNYWxha29mZi4KCSAgTGljZW5zZTogTUlUIChodHRwOi8vd3d3Lm9wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL21pdC1saWNlbnNlLnBocCkKCSAgU291cmNlOiBodHRwczovL2dpdGh1Yi5jb20va21hbGFrb2ZmL2tub2NrYmFjawoJICBEZXBlbmRlbmNpZXM6IEtub2Nrb3V0LmpzLCBCYWNrYm9uZS5qcywgYW5kIFVuZGVyc2NvcmUuanMgKG9yIExvRGFzaC5qcykuCgkgIE9wdGlvbmFsIGRlcGVuZGVuY2llczogQmFja2JvbmUuTW9kZWxSZWYuanMgYW5kIEJhY2tib25lT1JNLgoJICovCgl2YXIgXywgX2tleUFycmF5VG9PYmplY3QsIF9tZXJnZUFycmF5LCBfbWVyZ2VPYmplY3QsIF9tZXJnZU9wdGlvbnM7CgoJXyA9IF9fd2VicGFja19yZXF1aXJlX18oNikuXzsKCglfbWVyZ2VBcnJheSA9IGZ1bmN0aW9uKHJlc3VsdCwga2V5LCB2YWx1ZSkgewoJICByZXN1bHRba2V5XSB8fCAocmVzdWx0W2tleV0gPSBbXSk7CgkgIGlmICghXy5pc0FycmF5KHZhbHVlKSkgewoJICAgIHZhbHVlID0gW3ZhbHVlXTsKCSAgfQoJICByZXN1bHRba2V5XSA9IHJlc3VsdFtrZXldLmxlbmd0aCA/IF8udW5pb24ocmVzdWx0W2tleV0sIHZhbHVlKSA6IHZhbHVlOwoJICByZXR1cm4gcmVzdWx0OwoJfTsKCglfbWVyZ2VPYmplY3QgPSBmdW5jdGlvbihyZXN1bHQsIGtleSwgdmFsdWUpIHsKCSAgcmVzdWx0W2tleV0gfHwgKHJlc3VsdFtrZXldID0ge30pOwoJICByZXR1cm4gXy5leHRlbmQocmVzdWx0W2tleV0sIHZhbHVlKTsKCX07CgoJX2tleUFycmF5VG9PYmplY3QgPSBmdW5jdGlvbih2YWx1ZSkgewoJICB2YXIgaXRlbSwgcmVzdWx0LCBfaSwgX2xlbjsKCSAgcmVzdWx0ID0ge307CgkgIGZvciAoX2kgPSAwLCBfbGVuID0gdmFsdWUubGVuZ3RoOyBfaSA8IF9sZW47IF9pKyspIHsKCSAgICBpdGVtID0gdmFsdWVbX2ldOwoJICAgIHJlc3VsdFtpdGVtXSA9IHsKCSAgICAgIGtleTogaXRlbQoJICAgIH07CgkgIH0KCSAgcmV0dXJuIHJlc3VsdDsKCX07CgoJX21lcmdlT3B0aW9ucyA9IGZ1bmN0aW9uKHJlc3VsdCwgb3B0aW9ucykgewoJICB2YXIga2V5LCB2YWx1ZTsKCSAgaWYgKCFvcHRpb25zKSB7CgkgICAgcmV0dXJuIHJlc3VsdDsKCSAgfQoJICBmb3IgKGtleSBpbiBvcHRpb25zKSB7CgkgICAgdmFsdWUgPSBvcHRpb25zW2tleV07CgkgICAgc3dpdGNoIChrZXkpIHsKCSAgICAgIGNhc2UgJ2ludGVybmFscyc6CgkgICAgICBjYXNlICdyZXF1aXJlcyc6CgkgICAgICBjYXNlICdleGNsdWRlcyc6CgkgICAgICBjYXNlICdzdGF0aWNzJzoKCSAgICAgICAgX21lcmdlQXJyYXkocmVzdWx0LCBrZXksIHZhbHVlKTsKCSAgICAgICAgYnJlYWs7CgkgICAgICBjYXNlICdrZXlzJzoKCSAgICAgICAgaWYgKChfLmlzT2JqZWN0KHZhbHVlKSAmJiAhXy5pc0FycmF5KHZhbHVlKSkgfHwgKF8uaXNPYmplY3QocmVzdWx0W2tleV0pICYmICFfLmlzQXJyYXkocmVzdWx0W2tleV0pKSkgewoJICAgICAgICAgIGlmICghXy5pc09iamVjdCh2YWx1ZSkpIHsKCSAgICAgICAgICAgIHZhbHVlID0gW3ZhbHVlXTsKCSAgICAgICAgICB9CgkgICAgICAgICAgaWYgKF8uaXNBcnJheSh2YWx1ZSkpIHsKCSAgICAgICAgICAgIHZhbHVlID0gX2tleUFycmF5VG9PYmplY3QodmFsdWUpOwoJICAgICAgICAgIH0KCSAgICAgICAgICBpZiAoXy5pc0FycmF5KHJlc3VsdFtrZXldKSkgewoJICAgICAgICAgICAgcmVzdWx0W2tleV0gPSBfa2V5QXJyYXlUb09iamVjdChyZXN1bHRba2V5XSk7CgkgICAgICAgICAgfQoJICAgICAgICAgIF9tZXJnZU9iamVjdChyZXN1bHQsIGtleSwgdmFsdWUpOwoJICAgICAgICB9IGVsc2UgewoJICAgICAgICAgIF9tZXJnZUFycmF5KHJlc3VsdCwga2V5LCB2YWx1ZSk7CgkgICAgICAgIH0KCSAgICAgICAgYnJlYWs7CgkgICAgICBjYXNlICdmYWN0b3JpZXMnOgoJICAgICAgICBpZiAoXy5pc0Z1bmN0aW9uKHZhbHVlKSkgewoJICAgICAgICAgIHJlc3VsdFtrZXldID0gdmFsdWU7CgkgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgX21lcmdlT2JqZWN0KHJlc3VsdCwga2V5LCB2YWx1ZSk7CgkgICAgICAgIH0KCSAgICAgICAgYnJlYWs7CgkgICAgICBjYXNlICdzdGF0aWNfZGVmYXVsdHMnOgoJICAgICAgICBfbWVyZ2VPYmplY3QocmVzdWx0LCBrZXksIHZhbHVlKTsKCSAgICAgICAgYnJlYWs7CgkgICAgICBjYXNlICdvcHRpb25zJzoKCSAgICAgICAgYnJlYWs7CgkgICAgICBkZWZhdWx0OgoJICAgICAgICByZXN1bHRba2V5XSA9IHZhbHVlOwoJICAgIH0KCSAgfQoJICByZXR1cm4gX21lcmdlT3B0aW9ucyhyZXN1bHQsIG9wdGlvbnMub3B0aW9ucyk7Cgl9OwoKCW1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24ob3B0aW9ucykgewoJICByZXR1cm4gX21lcmdlT3B0aW9ucyh7fSwgb3B0aW9ucyk7Cgl9OwoKCi8qKiovIH0sCi8qIDIyICovCi8qKiovIGZ1bmN0aW9uKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewoKCQoJLyoKCSAga25vY2tiYWNrLmpzIDAuMjAuNAoJICBDb3B5cmlnaHQgKGMpICAyMDExLTIwMTQgS2V2aW4gTWFsYWtvZmYuCgkgIExpY2Vuc2U6IE1JVCAoaHR0cDovL3d3dy5vcGVuc291cmNlLm9yZy9saWNlbnNlcy9taXQtbGljZW5zZS5waHApCgkgIFNvdXJjZTogaHR0cHM6Ly9naXRodWIuY29tL2ttYWxha29mZi9rbm9ja2JhY2sKCSAgRGVwZW5kZW5jaWVzOiBLbm9ja291dC5qcywgQmFja2JvbmUuanMsIGFuZCBVbmRlcnNjb3JlLmpzIChvciBMb0Rhc2guanMpLgoJICBPcHRpb25hbCBkZXBlbmRlbmNpZXM6IEJhY2tib25lLk1vZGVsUmVmLmpzIGFuZCBCYWNrYm9uZU9STS4KCSAqLwoJdmFyIHVud3JhcE1vZGVscywgXzsKCglfID0gX193ZWJwYWNrX3JlcXVpcmVfXyg2KS5fOwoKCW1vZHVsZS5leHBvcnRzID0gdW53cmFwTW9kZWxzID0gZnVuY3Rpb24ob2JqKSB7CgkgIHZhciBrZXksIHJlc3VsdCwgdmFsdWU7CgkgIGlmICghb2JqKSB7CgkgICAgcmV0dXJuIG9iajsKCSAgfQoJICBpZiAob2JqLl9fa2IpIHsKCSAgICByZXR1cm4gKG9iai5fX2tiLmhhc093blByb3BlcnR5KCdvYmplY3QnKSA/IG9iai5fX2tiLm9iamVjdCA6IG9iaik7CgkgIH0KCSAgaWYgKF8uaXNBcnJheShvYmopKSB7CgkgICAgcmV0dXJuIF8ubWFwKG9iaiwgZnVuY3Rpb24odGVzdCkgewoJICAgICAgcmV0dXJuIHVud3JhcE1vZGVscyh0ZXN0KTsKCSAgICB9KTsKCSAgfQoJICBpZiAoXy5pc09iamVjdChvYmopICYmIChvYmouY29uc3RydWN0b3IgPT09IHt9LmNvbnN0cnVjdG9yKSkgewoJICAgIHJlc3VsdCA9IHt9OwoJICAgIGZvciAoa2V5IGluIG9iaikgewoJICAgICAgdmFsdWUgPSBvYmpba2V5XTsKCSAgICAgIHJlc3VsdFtrZXldID0gdW53cmFwTW9kZWxzKHZhbHVlKTsKCSAgICB9CgkgICAgcmV0dXJuIHJlc3VsdDsKCSAgfQoJICByZXR1cm4gb2JqOwoJfTsKCgovKioqLyB9LAovKiAyMyAqLwovKioqLyBmdW5jdGlvbihtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKCgl2YXIgX19XRUJQQUNLX0FNRF9ERUZJTkVfQVJSQVlfXywgX19XRUJQQUNLX0FNRF9ERUZJTkVfUkVTVUxUX187Ly8gICAgIEJhY2tib25lLmpzIDEuMS4yCgoJLy8gICAgIChjKSAyMDEwLTIwMTQgSmVyZW15IEFzaGtlbmFzLCBEb2N1bWVudENsb3VkIGFuZCBJbnZlc3RpZ2F0aXZlIFJlcG9ydGVycyAmIEVkaXRvcnMKCS8vICAgICBCYWNrYm9uZSBtYXkgYmUgZnJlZWx5IGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS4KCS8vICAgICBGb3IgYWxsIGRldGFpbHMgYW5kIGRvY3VtZW50YXRpb246CgkvLyAgICAgaHR0cDovL2JhY2tib25lanMub3JnCgoJKGZ1bmN0aW9uKHJvb3QsIGZhY3RvcnkpIHsKCgkgIC8vIFNldCB1cCBCYWNrYm9uZSBhcHByb3ByaWF0ZWx5IGZvciB0aGUgZW52aXJvbm1lbnQuIFN0YXJ0IHdpdGggQU1ELgoJICBpZiAodHJ1ZSkgewoJICAgICEoX19XRUJQQUNLX0FNRF9ERUZJTkVfQVJSQVlfXyA9IFtfX3dlYnBhY2tfcmVxdWlyZV9fKDI0KSwgX193ZWJwYWNrX3JlcXVpcmVfXygxNSksIGV4cG9ydHNdLCBfX1dFQlBBQ0tfQU1EX0RFRklORV9SRVNVTFRfXyA9IGZ1bmN0aW9uKF8sICQsIGV4cG9ydHMpIHsKCSAgICAgIC8vIEV4cG9ydCBnbG9iYWwgZXZlbiBpbiBBTUQgY2FzZSBpbiBjYXNlIHRoaXMgc2NyaXB0IGlzIGxvYWRlZCB3aXRoCgkgICAgICAvLyBvdGhlcnMgdGhhdCBtYXkgc3RpbGwgZXhwZWN0IGEgZ2xvYmFsIEJhY2tib25lLgoJICAgICAgcm9vdC5CYWNrYm9uZSA9IGZhY3Rvcnkocm9vdCwgZXhwb3J0cywgXywgJCk7CgkgICAgfS5hcHBseShleHBvcnRzLCBfX1dFQlBBQ0tfQU1EX0RFRklORV9BUlJBWV9fKSwgX19XRUJQQUNLX0FNRF9ERUZJTkVfUkVTVUxUX18gIT09IHVuZGVmaW5lZCAmJiAobW9kdWxlLmV4cG9ydHMgPSBfX1dFQlBBQ0tfQU1EX0RFRklORV9SRVNVTFRfXykpOwoKCSAgLy8gTmV4dCBmb3IgTm9kZS5qcyBvciBDb21tb25KUy4galF1ZXJ5IG1heSBub3QgYmUgbmVlZGVkIGFzIGEgbW9kdWxlLgoJICB9IGVsc2UgaWYgKHR5cGVvZiBleHBvcnRzICE9PSAndW5kZWZpbmVkJykgewoJICAgIHZhciBfID0gcmVxdWlyZSgndW5kZXJzY29yZScpOwoJICAgIGZhY3Rvcnkocm9vdCwgZXhwb3J0cywgXyk7CgoJICAvLyBGaW5hbGx5LCBhcyBhIGJyb3dzZXIgZ2xvYmFsLgoJICB9IGVsc2UgewoJICAgIHJvb3QuQmFja2JvbmUgPSBmYWN0b3J5KHJvb3QsIHt9LCByb290Ll8sIChyb290LmpRdWVyeSB8fCByb290LlplcHRvIHx8IHJvb3QuZW5kZXIgfHwgcm9vdC4kKSk7CgkgIH0KCgl9KHRoaXMsIGZ1bmN0aW9uKHJvb3QsIEJhY2tib25lLCBfLCAkKSB7CgoJICAvLyBJbml0aWFsIFNldHVwCgkgIC8vIC0tLS0tLS0tLS0tLS0KCgkgIC8vIFNhdmUgdGhlIHByZXZpb3VzIHZhbHVlIG9mIHRoZSBgQmFja2JvbmVgIHZhcmlhYmxlLCBzbyB0aGF0IGl0IGNhbiBiZQoJICAvLyByZXN0b3JlZCBsYXRlciBvbiwgaWYgYG5vQ29uZmxpY3RgIGlzIHVzZWQuCgkgIHZhciBwcmV2aW91c0JhY2tib25lID0gcm9vdC5CYWNrYm9uZTsKCgkgIC8vIENyZWF0ZSBsb2NhbCByZWZlcmVuY2VzIHRvIGFycmF5IG1ldGhvZHMgd2UnbGwgd2FudCB0byB1c2UgbGF0ZXIuCgkgIHZhciBhcnJheSA9IFtdOwoJICB2YXIgcHVzaCA9IGFycmF5LnB1c2g7CgkgIHZhciBzbGljZSA9IGFycmF5LnNsaWNlOwoJICB2YXIgc3BsaWNlID0gYXJyYXkuc3BsaWNlOwoKCSAgLy8gQ3VycmVudCB2ZXJzaW9uIG9mIHRoZSBsaWJyYXJ5LiBLZWVwIGluIHN5bmMgd2l0aCBgcGFja2FnZS5qc29uYC4KCSAgQmFja2JvbmUuVkVSU0lPTiA9ICcxLjEuMic7CgoJICAvLyBGb3IgQmFja2JvbmUncyBwdXJwb3NlcywgalF1ZXJ5LCBaZXB0bywgRW5kZXIsIG9yIE15IExpYnJhcnkgKGtpZGRpbmcpIG93bnMKCSAgLy8gdGhlIGAkYCB2YXJpYWJsZS4KCSAgQmFja2JvbmUuJCA9ICQ7CgoJICAvLyBSdW5zIEJhY2tib25lLmpzIGluICpub0NvbmZsaWN0KiBtb2RlLCByZXR1cm5pbmcgdGhlIGBCYWNrYm9uZWAgdmFyaWFibGUKCSAgLy8gdG8gaXRzIHByZXZpb3VzIG93bmVyLiBSZXR1cm5zIGEgcmVmZXJlbmNlIHRvIHRoaXMgQmFja2JvbmUgb2JqZWN0LgoJICBCYWNrYm9uZS5ub0NvbmZsaWN0ID0gZnVuY3Rpb24oKSB7CgkgICAgcm9vdC5CYWNrYm9uZSA9IHByZXZpb3VzQmFja2JvbmU7CgkgICAgcmV0dXJuIHRoaXM7CgkgIH07CgoJICAvLyBUdXJuIG9uIGBlbXVsYXRlSFRUUGAgdG8gc3VwcG9ydCBsZWdhY3kgSFRUUCBzZXJ2ZXJzLiBTZXR0aW5nIHRoaXMgb3B0aW9uCgkgIC8vIHdpbGwgZmFrZSBgIlBBVENIImAsIGAiUFVUImAgYW5kIGAiREVMRVRFImAgcmVxdWVzdHMgdmlhIHRoZSBgX21ldGhvZGAgcGFyYW1ldGVyIGFuZAoJICAvLyBzZXQgYSBgWC1IdHRwLU1ldGhvZC1PdmVycmlkZWAgaGVhZGVyLgoJICBCYWNrYm9uZS5lbXVsYXRlSFRUUCA9IGZhbHNlOwoKCSAgLy8gVHVybiBvbiBgZW11bGF0ZUpTT05gIHRvIHN1cHBvcnQgbGVnYWN5IHNlcnZlcnMgdGhhdCBjYW4ndCBkZWFsIHdpdGggZGlyZWN0CgkgIC8vIGBhcHBsaWNhdGlvbi9qc29uYCByZXF1ZXN0cyAuLi4gd2lsbCBlbmNvZGUgdGhlIGJvZHkgYXMKCSAgLy8gYGFwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZGAgaW5zdGVhZCBhbmQgd2lsbCBzZW5kIHRoZSBtb2RlbCBpbiBhCgkgIC8vIGZvcm0gcGFyYW0gbmFtZWQgYG1vZGVsYC4KCSAgQmFja2JvbmUuZW11bGF0ZUpTT04gPSBmYWxzZTsKCgkgIC8vIEJhY2tib25lLkV2ZW50cwoJICAvLyAtLS0tLS0tLS0tLS0tLS0KCgkgIC8vIEEgbW9kdWxlIHRoYXQgY2FuIGJlIG1peGVkIGluIHRvICphbnkgb2JqZWN0KiBpbiBvcmRlciB0byBwcm92aWRlIGl0IHdpdGgKCSAgLy8gY3VzdG9tIGV2ZW50cy4gWW91IG1heSBiaW5kIHdpdGggYG9uYCBvciByZW1vdmUgd2l0aCBgb2ZmYCBjYWxsYmFjawoJICAvLyBmdW5jdGlvbnMgdG8gYW4gZXZlbnQ7IGB0cmlnZ2VyYC1pbmcgYW4gZXZlbnQgZmlyZXMgYWxsIGNhbGxiYWNrcyBpbgoJICAvLyBzdWNjZXNzaW9uLgoJICAvLwoJICAvLyAgICAgdmFyIG9iamVjdCA9IHt9OwoJICAvLyAgICAgXy5leHRlbmQob2JqZWN0LCBCYWNrYm9uZS5FdmVudHMpOwoJICAvLyAgICAgb2JqZWN0Lm9uKCdleHBhbmQnLCBmdW5jdGlvbigpeyBhbGVydCgnZXhwYW5kZWQnKTsgfSk7CgkgIC8vICAgICBvYmplY3QudHJpZ2dlcignZXhwYW5kJyk7CgkgIC8vCgkgIHZhciBFdmVudHMgPSBCYWNrYm9uZS5FdmVudHMgPSB7CgoJICAgIC8vIEJpbmQgYW4gZXZlbnQgdG8gYSBgY2FsbGJhY2tgIGZ1bmN0aW9uLiBQYXNzaW5nIGAiYWxsImAgd2lsbCBiaW5kCgkgICAgLy8gdGhlIGNhbGxiYWNrIHRvIGFsbCBldmVudHMgZmlyZWQuCgkgICAgb246IGZ1bmN0aW9uKG5hbWUsIGNhbGxiYWNrLCBjb250ZXh0KSB7CgkgICAgICBpZiAoIWV2ZW50c0FwaSh0aGlzLCAnb24nLCBuYW1lLCBbY2FsbGJhY2ssIGNvbnRleHRdKSB8fCAhY2FsbGJhY2spIHJldHVybiB0aGlzOwoJICAgICAgdGhpcy5fZXZlbnRzIHx8ICh0aGlzLl9ldmVudHMgPSB7fSk7CgkgICAgICB2YXIgZXZlbnRzID0gdGhpcy5fZXZlbnRzW25hbWVdIHx8ICh0aGlzLl9ldmVudHNbbmFtZV0gPSBbXSk7CgkgICAgICBldmVudHMucHVzaCh7Y2FsbGJhY2s6IGNhbGxiYWNrLCBjb250ZXh0OiBjb250ZXh0LCBjdHg6IGNvbnRleHQgfHwgdGhpc30pOwoJICAgICAgcmV0dXJuIHRoaXM7CgkgICAgfSwKCgkgICAgLy8gQmluZCBhbiBldmVudCB0byBvbmx5IGJlIHRyaWdnZXJlZCBhIHNpbmdsZSB0aW1lLiBBZnRlciB0aGUgZmlyc3QgdGltZQoJICAgIC8vIHRoZSBjYWxsYmFjayBpcyBpbnZva2VkLCBpdCB3aWxsIGJlIHJlbW92ZWQuCgkgICAgb25jZTogZnVuY3Rpb24obmFtZSwgY2FsbGJhY2ssIGNvbnRleHQpIHsKCSAgICAgIGlmICghZXZlbnRzQXBpKHRoaXMsICdvbmNlJywgbmFtZSwgW2NhbGxiYWNrLCBjb250ZXh0XSkgfHwgIWNhbGxiYWNrKSByZXR1cm4gdGhpczsKCSAgICAgIHZhciBzZWxmID0gdGhpczsKCSAgICAgIHZhciBvbmNlID0gXy5vbmNlKGZ1bmN0aW9uKCkgewoJICAgICAgICBzZWxmLm9mZihuYW1lLCBvbmNlKTsKCSAgICAgICAgY2FsbGJhY2suYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCSAgICAgIH0pOwoJICAgICAgb25jZS5fY2FsbGJhY2sgPSBjYWxsYmFjazsKCSAgICAgIHJldHVybiB0aGlzLm9uKG5hbWUsIG9uY2UsIGNvbnRleHQpOwoJICAgIH0sCgoJICAgIC8vIFJlbW92ZSBvbmUgb3IgbWFueSBjYWxsYmFja3MuIElmIGBjb250ZXh0YCBpcyBudWxsLCByZW1vdmVzIGFsbAoJICAgIC8vIGNhbGxiYWNrcyB3aXRoIHRoYXQgZnVuY3Rpb24uIElmIGBjYWxsYmFja2AgaXMgbnVsbCwgcmVtb3ZlcyBhbGwKCSAgICAvLyBjYWxsYmFja3MgZm9yIHRoZSBldmVudC4gSWYgYG5hbWVgIGlzIG51bGwsIHJlbW92ZXMgYWxsIGJvdW5kCgkgICAgLy8gY2FsbGJhY2tzIGZvciBhbGwgZXZlbnRzLgoJICAgIG9mZjogZnVuY3Rpb24obmFtZSwgY2FsbGJhY2ssIGNvbnRleHQpIHsKCSAgICAgIHZhciByZXRhaW4sIGV2LCBldmVudHMsIG5hbWVzLCBpLCBsLCBqLCBrOwoJICAgICAgaWYgKCF0aGlzLl9ldmVudHMgfHwgIWV2ZW50c0FwaSh0aGlzLCAnb2ZmJywgbmFtZSwgW2NhbGxiYWNrLCBjb250ZXh0XSkpIHJldHVybiB0aGlzOwoJICAgICAgaWYgKCFuYW1lICYmICFjYWxsYmFjayAmJiAhY29udGV4dCkgewoJICAgICAgICB0aGlzLl9ldmVudHMgPSB2b2lkIDA7CgkgICAgICAgIHJldHVybiB0aGlzOwoJICAgICAgfQoJICAgICAgbmFtZXMgPSBuYW1lID8gW25hbWVdIDogXy5rZXlzKHRoaXMuX2V2ZW50cyk7CgkgICAgICBmb3IgKGkgPSAwLCBsID0gbmFtZXMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CgkgICAgICAgIG5hbWUgPSBuYW1lc1tpXTsKCSAgICAgICAgaWYgKGV2ZW50cyA9IHRoaXMuX2V2ZW50c1tuYW1lXSkgewoJICAgICAgICAgIHRoaXMuX2V2ZW50c1tuYW1lXSA9IHJldGFpbiA9IFtdOwoJICAgICAgICAgIGlmIChjYWxsYmFjayB8fCBjb250ZXh0KSB7CgkgICAgICAgICAgICBmb3IgKGogPSAwLCBrID0gZXZlbnRzLmxlbmd0aDsgaiA8IGs7IGorKykgewoJICAgICAgICAgICAgICBldiA9IGV2ZW50c1tqXTsKCSAgICAgICAgICAgICAgaWYgKChjYWxsYmFjayAmJiBjYWxsYmFjayAhPT0gZXYuY2FsbGJhY2sgJiYgY2FsbGJhY2sgIT09IGV2LmNhbGxiYWNrLl9jYWxsYmFjaykgfHwKCSAgICAgICAgICAgICAgICAgIChjb250ZXh0ICYmIGNvbnRleHQgIT09IGV2LmNvbnRleHQpKSB7CgkgICAgICAgICAgICAgICAgcmV0YWluLnB1c2goZXYpOwoJICAgICAgICAgICAgICB9CgkgICAgICAgICAgICB9CgkgICAgICAgICAgfQoJICAgICAgICAgIGlmICghcmV0YWluLmxlbmd0aCkgZGVsZXRlIHRoaXMuX2V2ZW50c1tuYW1lXTsKCSAgICAgICAgfQoJICAgICAgfQoKCSAgICAgIHJldHVybiB0aGlzOwoJICAgIH0sCgoJICAgIC8vIFRyaWdnZXIgb25lIG9yIG1hbnkgZXZlbnRzLCBmaXJpbmcgYWxsIGJvdW5kIGNhbGxiYWNrcy4gQ2FsbGJhY2tzIGFyZQoJICAgIC8vIHBhc3NlZCB0aGUgc2FtZSBhcmd1bWVudHMgYXMgYHRyaWdnZXJgIGlzLCBhcGFydCBmcm9tIHRoZSBldmVudCBuYW1lCgkgICAgLy8gKHVubGVzcyB5b3UncmUgbGlzdGVuaW5nIG9uIGAiYWxsImAsIHdoaWNoIHdpbGwgY2F1c2UgeW91ciBjYWxsYmFjayB0bwoJICAgIC8vIHJlY2VpdmUgdGhlIHRydWUgbmFtZSBvZiB0aGUgZXZlbnQgYXMgdGhlIGZpcnN0IGFyZ3VtZW50KS4KCSAgICB0cmlnZ2VyOiBmdW5jdGlvbihuYW1lKSB7CgkgICAgICBpZiAoIXRoaXMuX2V2ZW50cykgcmV0dXJuIHRoaXM7CgkgICAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKCSAgICAgIGlmICghZXZlbnRzQXBpKHRoaXMsICd0cmlnZ2VyJywgbmFtZSwgYXJncykpIHJldHVybiB0aGlzOwoJICAgICAgdmFyIGV2ZW50cyA9IHRoaXMuX2V2ZW50c1tuYW1lXTsKCSAgICAgIHZhciBhbGxFdmVudHMgPSB0aGlzLl9ldmVudHMuYWxsOwoJICAgICAgaWYgKGV2ZW50cykgdHJpZ2dlckV2ZW50cyhldmVudHMsIGFyZ3MpOwoJICAgICAgaWYgKGFsbEV2ZW50cykgdHJpZ2dlckV2ZW50cyhhbGxFdmVudHMsIGFyZ3VtZW50cyk7CgkgICAgICByZXR1cm4gdGhpczsKCSAgICB9LAoKCSAgICAvLyBUZWxsIHRoaXMgb2JqZWN0IHRvIHN0b3AgbGlzdGVuaW5nIHRvIGVpdGhlciBzcGVjaWZpYyBldmVudHMgLi4uIG9yCgkgICAgLy8gdG8gZXZlcnkgb2JqZWN0IGl0J3MgY3VycmVudGx5IGxpc3RlbmluZyB0by4KCSAgICBzdG9wTGlzdGVuaW5nOiBmdW5jdGlvbihvYmosIG5hbWUsIGNhbGxiYWNrKSB7CgkgICAgICB2YXIgbGlzdGVuaW5nVG8gPSB0aGlzLl9saXN0ZW5pbmdUbzsKCSAgICAgIGlmICghbGlzdGVuaW5nVG8pIHJldHVybiB0aGlzOwoJICAgICAgdmFyIHJlbW92ZSA9ICFuYW1lICYmICFjYWxsYmFjazsKCSAgICAgIGlmICghY2FsbGJhY2sgJiYgdHlwZW9mIG5hbWUgPT09ICdvYmplY3QnKSBjYWxsYmFjayA9IHRoaXM7CgkgICAgICBpZiAob2JqKSAobGlzdGVuaW5nVG8gPSB7fSlbb2JqLl9saXN0ZW5JZF0gPSBvYmo7CgkgICAgICBmb3IgKHZhciBpZCBpbiBsaXN0ZW5pbmdUbykgewoJICAgICAgICBvYmogPSBsaXN0ZW5pbmdUb1tpZF07CgkgICAgICAgIG9iai5vZmYobmFtZSwgY2FsbGJhY2ssIHRoaXMpOwoJICAgICAgICBpZiAocmVtb3ZlIHx8IF8uaXNFbXB0eShvYmouX2V2ZW50cykpIGRlbGV0ZSB0aGlzLl9saXN0ZW5pbmdUb1tpZF07CgkgICAgICB9CgkgICAgICByZXR1cm4gdGhpczsKCSAgICB9CgoJICB9OwoKCSAgLy8gUmVndWxhciBleHByZXNzaW9uIHVzZWQgdG8gc3BsaXQgZXZlbnQgc3RyaW5ncy4KCSAgdmFyIGV2ZW50U3BsaXR0ZXIgPSAvXHMrLzsKCgkgIC8vIEltcGxlbWVudCBmYW5jeSBmZWF0dXJlcyBvZiB0aGUgRXZlbnRzIEFQSSBzdWNoIGFzIG11bHRpcGxlIGV2ZW50CgkgIC8vIG5hbWVzIGAiY2hhbmdlIGJsdXIiYCBhbmQgalF1ZXJ5LXN0eWxlIGV2ZW50IG1hcHMgYHtjaGFuZ2U6IGFjdGlvbn1gCgkgIC8vIGluIHRlcm1zIG9mIHRoZSBleGlzdGluZyBBUEkuCgkgIHZhciBldmVudHNBcGkgPSBmdW5jdGlvbihvYmosIGFjdGlvbiwgbmFtZSwgcmVzdCkgewoJICAgIGlmICghbmFtZSkgcmV0dXJuIHRydWU7CgoJICAgIC8vIEhhbmRsZSBldmVudCBtYXBzLgoJICAgIGlmICh0eXBlb2YgbmFtZSA9PT0gJ29iamVjdCcpIHsKCSAgICAgIGZvciAodmFyIGtleSBpbiBuYW1lKSB7CgkgICAgICAgIG9ialthY3Rpb25dLmFwcGx5KG9iaiwgW2tleSwgbmFtZVtrZXldXS5jb25jYXQocmVzdCkpOwoJICAgICAgfQoJICAgICAgcmV0dXJuIGZhbHNlOwoJICAgIH0KCgkgICAgLy8gSGFuZGxlIHNwYWNlIHNlcGFyYXRlZCBldmVudCBuYW1lcy4KCSAgICBpZiAoZXZlbnRTcGxpdHRlci50ZXN0KG5hbWUpKSB7CgkgICAgICB2YXIgbmFtZXMgPSBuYW1lLnNwbGl0KGV2ZW50U3BsaXR0ZXIpOwoJICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSBuYW1lcy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKCSAgICAgICAgb2JqW2FjdGlvbl0uYXBwbHkob2JqLCBbbmFtZXNbaV1dLmNvbmNhdChyZXN0KSk7CgkgICAgICB9CgkgICAgICByZXR1cm4gZmFsc2U7CgkgICAgfQoKCSAgICByZXR1cm4gdHJ1ZTsKCSAgfTsKCgkgIC8vIEEgZGlmZmljdWx0LXRvLWJlbGlldmUsIGJ1dCBvcHRpbWl6ZWQgaW50ZXJuYWwgZGlzcGF0Y2ggZnVuY3Rpb24gZm9yCgkgIC8vIHRyaWdnZXJpbmcgZXZlbnRzLiBUcmllcyB0byBrZWVwIHRoZSB1c3VhbCBjYXNlcyBzcGVlZHkgKG1vc3QgaW50ZXJuYWwKCSAgLy8gQmFja2JvbmUgZXZlbnRzIGhhdmUgMyBhcmd1bWVudHMpLgoJICB2YXIgdHJpZ2dlckV2ZW50cyA9IGZ1bmN0aW9uKGV2ZW50cywgYXJncykgewoJICAgIHZhciBldiwgaSA9IC0xLCBsID0gZXZlbnRzLmxlbmd0aCwgYTEgPSBhcmdzWzBdLCBhMiA9IGFyZ3NbMV0sIGEzID0gYXJnc1syXTsKCSAgICBzd2l0Y2ggKGFyZ3MubGVuZ3RoKSB7CgkgICAgICBjYXNlIDA6IHdoaWxlICgrK2kgPCBsKSAoZXYgPSBldmVudHNbaV0pLmNhbGxiYWNrLmNhbGwoZXYuY3R4KTsgcmV0dXJuOwoJICAgICAgY2FzZSAxOiB3aGlsZSAoKytpIDwgbCkgKGV2ID0gZXZlbnRzW2ldKS5jYWxsYmFjay5jYWxsKGV2LmN0eCwgYTEpOyByZXR1cm47CgkgICAgICBjYXNlIDI6IHdoaWxlICgrK2kgPCBsKSAoZXYgPSBldmVudHNbaV0pLmNhbGxiYWNrLmNhbGwoZXYuY3R4LCBhMSwgYTIpOyByZXR1cm47CgkgICAgICBjYXNlIDM6IHdoaWxlICgrK2kgPCBsKSAoZXYgPSBldmVudHNbaV0pLmNhbGxiYWNrLmNhbGwoZXYuY3R4LCBhMSwgYTIsIGEzKTsgcmV0dXJuOwoJICAgICAgZGVmYXVsdDogd2hpbGUgKCsraSA8IGwpIChldiA9IGV2ZW50c1tpXSkuY2FsbGJhY2suYXBwbHkoZXYuY3R4LCBhcmdzKTsgcmV0dXJuOwoJICAgIH0KCSAgfTsKCgkgIHZhciBsaXN0ZW5NZXRob2RzID0ge2xpc3RlblRvOiAnb24nLCBsaXN0ZW5Ub09uY2U6ICdvbmNlJ307CgoJICAvLyBJbnZlcnNpb24tb2YtY29udHJvbCB2ZXJzaW9ucyBvZiBgb25gIGFuZCBgb25jZWAuIFRlbGwgKnRoaXMqIG9iamVjdCB0bwoJICAvLyBsaXN0ZW4gdG8gYW4gZXZlbnQgaW4gYW5vdGhlciBvYmplY3QgLi4uIGtlZXBpbmcgdHJhY2sgb2Ygd2hhdCBpdCdzCgkgIC8vIGxpc3RlbmluZyB0by4KCSAgXy5lYWNoKGxpc3Rlbk1ldGhvZHMsIGZ1bmN0aW9uKGltcGxlbWVudGF0aW9uLCBtZXRob2QpIHsKCSAgICBFdmVudHNbbWV0aG9kXSA9IGZ1bmN0aW9uKG9iaiwgbmFtZSwgY2FsbGJhY2spIHsKCSAgICAgIHZhciBsaXN0ZW5pbmdUbyA9IHRoaXMuX2xpc3RlbmluZ1RvIHx8ICh0aGlzLl9saXN0ZW5pbmdUbyA9IHt9KTsKCSAgICAgIHZhciBpZCA9IG9iai5fbGlzdGVuSWQgfHwgKG9iai5fbGlzdGVuSWQgPSBfLnVuaXF1ZUlkKCdsJykpOwoJICAgICAgbGlzdGVuaW5nVG9baWRdID0gb2JqOwoJICAgICAgaWYgKCFjYWxsYmFjayAmJiB0eXBlb2YgbmFtZSA9PT0gJ29iamVjdCcpIGNhbGxiYWNrID0gdGhpczsKCSAgICAgIG9ialtpbXBsZW1lbnRhdGlvbl0obmFtZSwgY2FsbGJhY2ssIHRoaXMpOwoJICAgICAgcmV0dXJuIHRoaXM7CgkgICAgfTsKCSAgfSk7CgoJICAvLyBBbGlhc2VzIGZvciBiYWNrd2FyZHMgY29tcGF0aWJpbGl0eS4KCSAgRXZlbnRzLmJpbmQgICA9IEV2ZW50cy5vbjsKCSAgRXZlbnRzLnVuYmluZCA9IEV2ZW50cy5vZmY7CgoJICAvLyBBbGxvdyB0aGUgYEJhY2tib25lYCBvYmplY3QgdG8gc2VydmUgYXMgYSBnbG9iYWwgZXZlbnQgYnVzLCBmb3IgZm9sa3Mgd2hvCgkgIC8vIHdhbnQgZ2xvYmFsICJwdWJzdWIiIGluIGEgY29udmVuaWVudCBwbGFjZS4KCSAgXy5leHRlbmQoQmFja2JvbmUsIEV2ZW50cyk7CgoJICAvLyBCYWNrYm9uZS5Nb2RlbAoJICAvLyAtLS0tLS0tLS0tLS0tLQoKCSAgLy8gQmFja2JvbmUgKipNb2RlbHMqKiBhcmUgdGhlIGJhc2ljIGRhdGEgb2JqZWN0IGluIHRoZSBmcmFtZXdvcmsgLS0KCSAgLy8gZnJlcXVlbnRseSByZXByZXNlbnRpbmcgYSByb3cgaW4gYSB0YWJsZSBpbiBhIGRhdGFiYXNlIG9uIHlvdXIgc2VydmVyLgoJICAvLyBBIGRpc2NyZXRlIGNodW5rIG9mIGRhdGEgYW5kIGEgYnVuY2ggb2YgdXNlZnVsLCByZWxhdGVkIG1ldGhvZHMgZm9yCgkgIC8vIHBlcmZvcm1pbmcgY29tcHV0YXRpb25zIGFuZCB0cmFuc2Zvcm1hdGlvbnMgb24gdGhhdCBkYXRhLgoKCSAgLy8gQ3JlYXRlIGEgbmV3IG1vZGVsIHdpdGggdGhlIHNwZWNpZmllZCBhdHRyaWJ1dGVzLiBBIGNsaWVudCBpZCAoYGNpZGApCgkgIC8vIGlzIGF1dG9tYXRpY2FsbHkgZ2VuZXJhdGVkIGFuZCBhc3NpZ25lZCBmb3IgeW91LgoJICB2YXIgTW9kZWwgPSBCYWNrYm9uZS5Nb2RlbCA9IGZ1bmN0aW9uKGF0dHJpYnV0ZXMsIG9wdGlvbnMpIHsKCSAgICB2YXIgYXR0cnMgPSBhdHRyaWJ1dGVzIHx8IHt9OwoJICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CgkgICAgdGhpcy5jaWQgPSBfLnVuaXF1ZUlkKCdjJyk7CgkgICAgdGhpcy5hdHRyaWJ1dGVzID0ge307CgkgICAgaWYgKG9wdGlvbnMuY29sbGVjdGlvbikgdGhpcy5jb2xsZWN0aW9uID0gb3B0aW9ucy5jb2xsZWN0aW9uOwoJICAgIGlmIChvcHRpb25zLnBhcnNlKSBhdHRycyA9IHRoaXMucGFyc2UoYXR0cnMsIG9wdGlvbnMpIHx8IHt9OwoJICAgIGF0dHJzID0gXy5kZWZhdWx0cyh7fSwgYXR0cnMsIF8ucmVzdWx0KHRoaXMsICdkZWZhdWx0cycpKTsKCSAgICB0aGlzLnNldChhdHRycywgb3B0aW9ucyk7CgkgICAgdGhpcy5jaGFuZ2VkID0ge307CgkgICAgdGhpcy5pbml0aWFsaXplLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CgkgIH07CgoJICAvLyBBdHRhY2ggYWxsIGluaGVyaXRhYmxlIG1ldGhvZHMgdG8gdGhlIE1vZGVsIHByb3RvdHlwZS4KCSAgXy5leHRlbmQoTW9kZWwucHJvdG90eXBlLCBFdmVudHMsIHsKCgkgICAgLy8gQSBoYXNoIG9mIGF0dHJpYnV0ZXMgd2hvc2UgY3VycmVudCBhbmQgcHJldmlvdXMgdmFsdWUgZGlmZmVyLgoJICAgIGNoYW5nZWQ6IG51bGwsCgoJICAgIC8vIFRoZSB2YWx1ZSByZXR1cm5lZCBkdXJpbmcgdGhlIGxhc3QgZmFpbGVkIHZhbGlkYXRpb24uCgkgICAgdmFsaWRhdGlvbkVycm9yOiBudWxsLAoKCSAgICAvLyBUaGUgZGVmYXVsdCBuYW1lIGZvciB0aGUgSlNPTiBgaWRgIGF0dHJpYnV0ZSBpcyBgImlkImAuIE1vbmdvREIgYW5kCgkgICAgLy8gQ291Y2hEQiB1c2VycyBtYXkgd2FudCB0byBzZXQgdGhpcyB0byBgIl9pZCJgLgoJICAgIGlkQXR0cmlidXRlOiAnaWQnLAoKCSAgICAvLyBJbml0aWFsaXplIGlzIGFuIGVtcHR5IGZ1bmN0aW9uIGJ5IGRlZmF1bHQuIE92ZXJyaWRlIGl0IHdpdGggeW91ciBvd24KCSAgICAvLyBpbml0aWFsaXphdGlvbiBsb2dpYy4KCSAgICBpbml0aWFsaXplOiBmdW5jdGlvbigpe30sCgoJICAgIC8vIFJldHVybiBhIGNvcHkgb2YgdGhlIG1vZGVsJ3MgYGF0dHJpYnV0ZXNgIG9iamVjdC4KCSAgICB0b0pTT046IGZ1bmN0aW9uKG9wdGlvbnMpIHsKCSAgICAgIHJldHVybiBfLmNsb25lKHRoaXMuYXR0cmlidXRlcyk7CgkgICAgfSwKCgkgICAgLy8gUHJveHkgYEJhY2tib25lLnN5bmNgIGJ5IGRlZmF1bHQgLS0gYnV0IG92ZXJyaWRlIHRoaXMgaWYgeW91IG5lZWQKCSAgICAvLyBjdXN0b20gc3luY2luZyBzZW1hbnRpY3MgZm9yICp0aGlzKiBwYXJ0aWN1bGFyIG1vZGVsLgoJICAgIHN5bmM6IGZ1bmN0aW9uKCkgewoJICAgICAgcmV0dXJuIEJhY2tib25lLnN5bmMuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCSAgICB9LAoKCSAgICAvLyBHZXQgdGhlIHZhbHVlIG9mIGFuIGF0dHJpYnV0ZS4KCSAgICBnZXQ6IGZ1bmN0aW9uKGF0dHIpIHsKCSAgICAgIHJldHVybiB0aGlzLmF0dHJpYnV0ZXNbYXR0cl07CgkgICAgfSwKCgkgICAgLy8gR2V0IHRoZSBIVE1MLWVzY2FwZWQgdmFsdWUgb2YgYW4gYXR0cmlidXRlLgoJICAgIGVzY2FwZTogZnVuY3Rpb24oYXR0cikgewoJICAgICAgcmV0dXJuIF8uZXNjYXBlKHRoaXMuZ2V0KGF0dHIpKTsKCSAgICB9LAoKCSAgICAvLyBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgYXR0cmlidXRlIGNvbnRhaW5zIGEgdmFsdWUgdGhhdCBpcyBub3QgbnVsbAoJICAgIC8vIG9yIHVuZGVmaW5lZC4KCSAgICBoYXM6IGZ1bmN0aW9uKGF0dHIpIHsKCSAgICAgIHJldHVybiB0aGlzLmdldChhdHRyKSAhPSBudWxsOwoJICAgIH0sCgoJICAgIC8vIFNldCBhIGhhc2ggb2YgbW9kZWwgYXR0cmlidXRlcyBvbiB0aGUgb2JqZWN0LCBmaXJpbmcgYCJjaGFuZ2UiYC4gVGhpcyBpcwoJICAgIC8vIHRoZSBjb3JlIHByaW1pdGl2ZSBvcGVyYXRpb24gb2YgYSBtb2RlbCwgdXBkYXRpbmcgdGhlIGRhdGEgYW5kIG5vdGlmeWluZwoJICAgIC8vIGFueW9uZSB3aG8gbmVlZHMgdG8ga25vdyBhYm91dCB0aGUgY2hhbmdlIGluIHN0YXRlLiBUaGUgaGVhcnQgb2YgdGhlIGJlYXN0LgoJICAgIHNldDogZnVuY3Rpb24oa2V5LCB2YWwsIG9wdGlvbnMpIHsKCSAgICAgIHZhciBhdHRyLCBhdHRycywgdW5zZXQsIGNoYW5nZXMsIHNpbGVudCwgY2hhbmdpbmcsIHByZXYsIGN1cnJlbnQ7CgkgICAgICBpZiAoa2V5ID09IG51bGwpIHJldHVybiB0aGlzOwoKCSAgICAgIC8vIEhhbmRsZSBib3RoIGAia2V5IiwgdmFsdWVgIGFuZCBge2tleTogdmFsdWV9YCAtc3R5bGUgYXJndW1lbnRzLgoJICAgICAgaWYgKHR5cGVvZiBrZXkgPT09ICdvYmplY3QnKSB7CgkgICAgICAgIGF0dHJzID0ga2V5OwoJICAgICAgICBvcHRpb25zID0gdmFsOwoJICAgICAgfSBlbHNlIHsKCSAgICAgICAgKGF0dHJzID0ge30pW2tleV0gPSB2YWw7CgkgICAgICB9CgoJICAgICAgb3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KTsKCgkgICAgICAvLyBSdW4gdmFsaWRhdGlvbi4KCSAgICAgIGlmICghdGhpcy5fdmFsaWRhdGUoYXR0cnMsIG9wdGlvbnMpKSByZXR1cm4gZmFsc2U7CgoJICAgICAgLy8gRXh0cmFjdCBhdHRyaWJ1dGVzIGFuZCBvcHRpb25zLgoJICAgICAgdW5zZXQgICAgICAgICAgID0gb3B0aW9ucy51bnNldDsKCSAgICAgIHNpbGVudCAgICAgICAgICA9IG9wdGlvbnMuc2lsZW50OwoJICAgICAgY2hhbmdlcyAgICAgICAgID0gW107CgkgICAgICBjaGFuZ2luZyAgICAgICAgPSB0aGlzLl9jaGFuZ2luZzsKCSAgICAgIHRoaXMuX2NoYW5naW5nICA9IHRydWU7CgoJICAgICAgaWYgKCFjaGFuZ2luZykgewoJICAgICAgICB0aGlzLl9wcmV2aW91c0F0dHJpYnV0ZXMgPSBfLmNsb25lKHRoaXMuYXR0cmlidXRlcyk7CgkgICAgICAgIHRoaXMuY2hhbmdlZCA9IHt9OwoJICAgICAgfQoJICAgICAgY3VycmVudCA9IHRoaXMuYXR0cmlidXRlcywgcHJldiA9IHRoaXMuX3ByZXZpb3VzQXR0cmlidXRlczsKCgkgICAgICAvLyBDaGVjayBmb3IgY2hhbmdlcyBvZiBgaWRgLgoJICAgICAgaWYgKHRoaXMuaWRBdHRyaWJ1dGUgaW4gYXR0cnMpIHRoaXMuaWQgPSBhdHRyc1t0aGlzLmlkQXR0cmlidXRlXTsKCgkgICAgICAvLyBGb3IgZWFjaCBgc2V0YCBhdHRyaWJ1dGUsIHVwZGF0ZSBvciBkZWxldGUgdGhlIGN1cnJlbnQgdmFsdWUuCgkgICAgICBmb3IgKGF0dHIgaW4gYXR0cnMpIHsKCSAgICAgICAgdmFsID0gYXR0cnNbYXR0cl07CgkgICAgICAgIGlmICghXy5pc0VxdWFsKGN1cnJlbnRbYXR0cl0sIHZhbCkpIGNoYW5nZXMucHVzaChhdHRyKTsKCSAgICAgICAgaWYgKCFfLmlzRXF1YWwocHJldlthdHRyXSwgdmFsKSkgewoJICAgICAgICAgIHRoaXMuY2hhbmdlZFthdHRyXSA9IHZhbDsKCSAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICBkZWxldGUgdGhpcy5jaGFuZ2VkW2F0dHJdOwoJICAgICAgICB9CgkgICAgICAgIHVuc2V0ID8gZGVsZXRlIGN1cnJlbnRbYXR0cl0gOiBjdXJyZW50W2F0dHJdID0gdmFsOwoJICAgICAgfQoKCSAgICAgIC8vIFRyaWdnZXIgYWxsIHJlbGV2YW50IGF0dHJpYnV0ZSBjaGFuZ2VzLgoJICAgICAgaWYgKCFzaWxlbnQpIHsKCSAgICAgICAgaWYgKGNoYW5nZXMubGVuZ3RoKSB0aGlzLl9wZW5kaW5nID0gb3B0aW9uczsKCSAgICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSBjaGFuZ2VzLmxlbmd0aDsgaSA8IGw7IGkrKykgewoJICAgICAgICAgIHRoaXMudHJpZ2dlcignY2hhbmdlOicgKyBjaGFuZ2VzW2ldLCB0aGlzLCBjdXJyZW50W2NoYW5nZXNbaV1dLCBvcHRpb25zKTsKCSAgICAgICAgfQoJICAgICAgfQoKCSAgICAgIC8vIFlvdSBtaWdodCBiZSB3b25kZXJpbmcgd2h5IHRoZXJlJ3MgYSBgd2hpbGVgIGxvb3AgaGVyZS4gQ2hhbmdlcyBjYW4KCSAgICAgIC8vIGJlIHJlY3Vyc2l2ZWx5IG5lc3RlZCB3aXRoaW4gYCJjaGFuZ2UiYCBldmVudHMuCgkgICAgICBpZiAoY2hhbmdpbmcpIHJldHVybiB0aGlzOwoJICAgICAgaWYgKCFzaWxlbnQpIHsKCSAgICAgICAgd2hpbGUgKHRoaXMuX3BlbmRpbmcpIHsKCSAgICAgICAgICBvcHRpb25zID0gdGhpcy5fcGVuZGluZzsKCSAgICAgICAgICB0aGlzLl9wZW5kaW5nID0gZmFsc2U7CgkgICAgICAgICAgdGhpcy50cmlnZ2VyKCdjaGFuZ2UnLCB0aGlzLCBvcHRpb25zKTsKCSAgICAgICAgfQoJICAgICAgfQoJICAgICAgdGhpcy5fcGVuZGluZyA9IGZhbHNlOwoJICAgICAgdGhpcy5fY2hhbmdpbmcgPSBmYWxzZTsKCSAgICAgIHJldHVybiB0aGlzOwoJICAgIH0sCgoJICAgIC8vIFJlbW92ZSBhbiBhdHRyaWJ1dGUgZnJvbSB0aGUgbW9kZWwsIGZpcmluZyBgImNoYW5nZSJgLiBgdW5zZXRgIGlzIGEgbm9vcAoJICAgIC8vIGlmIHRoZSBhdHRyaWJ1dGUgZG9lc24ndCBleGlzdC4KCSAgICB1bnNldDogZnVuY3Rpb24oYXR0ciwgb3B0aW9ucykgewoJICAgICAgcmV0dXJuIHRoaXMuc2V0KGF0dHIsIHZvaWQgMCwgXy5leHRlbmQoe30sIG9wdGlvbnMsIHt1bnNldDogdHJ1ZX0pKTsKCSAgICB9LAoKCSAgICAvLyBDbGVhciBhbGwgYXR0cmlidXRlcyBvbiB0aGUgbW9kZWwsIGZpcmluZyBgImNoYW5nZSJgLgoJICAgIGNsZWFyOiBmdW5jdGlvbihvcHRpb25zKSB7CgkgICAgICB2YXIgYXR0cnMgPSB7fTsKCSAgICAgIGZvciAodmFyIGtleSBpbiB0aGlzLmF0dHJpYnV0ZXMpIGF0dHJzW2tleV0gPSB2b2lkIDA7CgkgICAgICByZXR1cm4gdGhpcy5zZXQoYXR0cnMsIF8uZXh0ZW5kKHt9LCBvcHRpb25zLCB7dW5zZXQ6IHRydWV9KSk7CgkgICAgfSwKCgkgICAgLy8gRGV0ZXJtaW5lIGlmIHRoZSBtb2RlbCBoYXMgY2hhbmdlZCBzaW5jZSB0aGUgbGFzdCBgImNoYW5nZSJgIGV2ZW50LgoJICAgIC8vIElmIHlvdSBzcGVjaWZ5IGFuIGF0dHJpYnV0ZSBuYW1lLCBkZXRlcm1pbmUgaWYgdGhhdCBhdHRyaWJ1dGUgaGFzIGNoYW5nZWQuCgkgICAgaGFzQ2hhbmdlZDogZnVuY3Rpb24oYXR0cikgewoJICAgICAgaWYgKGF0dHIgPT0gbnVsbCkgcmV0dXJuICFfLmlzRW1wdHkodGhpcy5jaGFuZ2VkKTsKCSAgICAgIHJldHVybiBfLmhhcyh0aGlzLmNoYW5nZWQsIGF0dHIpOwoJICAgIH0sCgoJICAgIC8vIFJldHVybiBhbiBvYmplY3QgY29udGFpbmluZyBhbGwgdGhlIGF0dHJpYnV0ZXMgdGhhdCBoYXZlIGNoYW5nZWQsIG9yCgkgICAgLy8gZmFsc2UgaWYgdGhlcmUgYXJlIG5vIGNoYW5nZWQgYXR0cmlidXRlcy4gVXNlZnVsIGZvciBkZXRlcm1pbmluZyB3aGF0CgkgICAgLy8gcGFydHMgb2YgYSB2aWV3IG5lZWQgdG8gYmUgdXBkYXRlZCBhbmQvb3Igd2hhdCBhdHRyaWJ1dGVzIG5lZWQgdG8gYmUKCSAgICAvLyBwZXJzaXN0ZWQgdG8gdGhlIHNlcnZlci4gVW5zZXQgYXR0cmlidXRlcyB3aWxsIGJlIHNldCB0byB1bmRlZmluZWQuCgkgICAgLy8gWW91IGNhbiBhbHNvIHBhc3MgYW4gYXR0cmlidXRlcyBvYmplY3QgdG8gZGlmZiBhZ2FpbnN0IHRoZSBtb2RlbCwKCSAgICAvLyBkZXRlcm1pbmluZyBpZiB0aGVyZSAqd291bGQgYmUqIGEgY2hhbmdlLgoJICAgIGNoYW5nZWRBdHRyaWJ1dGVzOiBmdW5jdGlvbihkaWZmKSB7CgkgICAgICBpZiAoIWRpZmYpIHJldHVybiB0aGlzLmhhc0NoYW5nZWQoKSA/IF8uY2xvbmUodGhpcy5jaGFuZ2VkKSA6IGZhbHNlOwoJICAgICAgdmFyIHZhbCwgY2hhbmdlZCA9IGZhbHNlOwoJICAgICAgdmFyIG9sZCA9IHRoaXMuX2NoYW5naW5nID8gdGhpcy5fcHJldmlvdXNBdHRyaWJ1dGVzIDogdGhpcy5hdHRyaWJ1dGVzOwoJICAgICAgZm9yICh2YXIgYXR0ciBpbiBkaWZmKSB7CgkgICAgICAgIGlmIChfLmlzRXF1YWwob2xkW2F0dHJdLCAodmFsID0gZGlmZlthdHRyXSkpKSBjb250aW51ZTsKCSAgICAgICAgKGNoYW5nZWQgfHwgKGNoYW5nZWQgPSB7fSkpW2F0dHJdID0gdmFsOwoJICAgICAgfQoJICAgICAgcmV0dXJuIGNoYW5nZWQ7CgkgICAgfSwKCgkgICAgLy8gR2V0IHRoZSBwcmV2aW91cyB2YWx1ZSBvZiBhbiBhdHRyaWJ1dGUsIHJlY29yZGVkIGF0IHRoZSB0aW1lIHRoZSBsYXN0CgkgICAgLy8gYCJjaGFuZ2UiYCBldmVudCB3YXMgZmlyZWQuCgkgICAgcHJldmlvdXM6IGZ1bmN0aW9uKGF0dHIpIHsKCSAgICAgIGlmIChhdHRyID09IG51bGwgfHwgIXRoaXMuX3ByZXZpb3VzQXR0cmlidXRlcykgcmV0dXJuIG51bGw7CgkgICAgICByZXR1cm4gdGhpcy5fcHJldmlvdXNBdHRyaWJ1dGVzW2F0dHJdOwoJICAgIH0sCgoJICAgIC8vIEdldCBhbGwgb2YgdGhlIGF0dHJpYnV0ZXMgb2YgdGhlIG1vZGVsIGF0IHRoZSB0aW1lIG9mIHRoZSBwcmV2aW91cwoJICAgIC8vIGAiY2hhbmdlImAgZXZlbnQuCgkgICAgcHJldmlvdXNBdHRyaWJ1dGVzOiBmdW5jdGlvbigpIHsKCSAgICAgIHJldHVybiBfLmNsb25lKHRoaXMuX3ByZXZpb3VzQXR0cmlidXRlcyk7CgkgICAgfSwKCgkgICAgLy8gRmV0Y2ggdGhlIG1vZGVsIGZyb20gdGhlIHNlcnZlci4gSWYgdGhlIHNlcnZlcidzIHJlcHJlc2VudGF0aW9uIG9mIHRoZQoJICAgIC8vIG1vZGVsIGRpZmZlcnMgZnJvbSBpdHMgY3VycmVudCBhdHRyaWJ1dGVzLCB0aGV5IHdpbGwgYmUgb3ZlcnJpZGRlbiwKCSAgICAvLyB0cmlnZ2VyaW5nIGEgYCJjaGFuZ2UiYCBldmVudC4KCSAgICBmZXRjaDogZnVuY3Rpb24ob3B0aW9ucykgewoJICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgPyBfLmNsb25lKG9wdGlvbnMpIDoge307CgkgICAgICBpZiAob3B0aW9ucy5wYXJzZSA9PT0gdm9pZCAwKSBvcHRpb25zLnBhcnNlID0gdHJ1ZTsKCSAgICAgIHZhciBtb2RlbCA9IHRoaXM7CgkgICAgICB2YXIgc3VjY2VzcyA9IG9wdGlvbnMuc3VjY2VzczsKCSAgICAgIG9wdGlvbnMuc3VjY2VzcyA9IGZ1bmN0aW9uKHJlc3ApIHsKCSAgICAgICAgaWYgKCFtb2RlbC5zZXQobW9kZWwucGFyc2UocmVzcCwgb3B0aW9ucyksIG9wdGlvbnMpKSByZXR1cm4gZmFsc2U7CgkgICAgICAgIGlmIChzdWNjZXNzKSBzdWNjZXNzKG1vZGVsLCByZXNwLCBvcHRpb25zKTsKCSAgICAgICAgbW9kZWwudHJpZ2dlcignc3luYycsIG1vZGVsLCByZXNwLCBvcHRpb25zKTsKCSAgICAgIH07CgkgICAgICB3cmFwRXJyb3IodGhpcywgb3B0aW9ucyk7CgkgICAgICByZXR1cm4gdGhpcy5zeW5jKCdyZWFkJywgdGhpcywgb3B0aW9ucyk7CgkgICAgfSwKCgkgICAgLy8gU2V0IGEgaGFzaCBvZiBtb2RlbCBhdHRyaWJ1dGVzLCBhbmQgc3luYyB0aGUgbW9kZWwgdG8gdGhlIHNlcnZlci4KCSAgICAvLyBJZiB0aGUgc2VydmVyIHJldHVybnMgYW4gYXR0cmlidXRlcyBoYXNoIHRoYXQgZGlmZmVycywgdGhlIG1vZGVsJ3MKCSAgICAvLyBzdGF0ZSB3aWxsIGJlIGBzZXRgIGFnYWluLgoJICAgIHNhdmU6IGZ1bmN0aW9uKGtleSwgdmFsLCBvcHRpb25zKSB7CgkgICAgICB2YXIgYXR0cnMsIG1ldGhvZCwgeGhyLCBhdHRyaWJ1dGVzID0gdGhpcy5hdHRyaWJ1dGVzOwoKCSAgICAgIC8vIEhhbmRsZSBib3RoIGAia2V5IiwgdmFsdWVgIGFuZCBge2tleTogdmFsdWV9YCAtc3R5bGUgYXJndW1lbnRzLgoJICAgICAgaWYgKGtleSA9PSBudWxsIHx8IHR5cGVvZiBrZXkgPT09ICdvYmplY3QnKSB7CgkgICAgICAgIGF0dHJzID0ga2V5OwoJICAgICAgICBvcHRpb25zID0gdmFsOwoJICAgICAgfSBlbHNlIHsKCSAgICAgICAgKGF0dHJzID0ge30pW2tleV0gPSB2YWw7CgkgICAgICB9CgoJICAgICAgb3B0aW9ucyA9IF8uZXh0ZW5kKHt2YWxpZGF0ZTogdHJ1ZX0sIG9wdGlvbnMpOwoKCSAgICAgIC8vIElmIHdlJ3JlIG5vdCB3YWl0aW5nIGFuZCBhdHRyaWJ1dGVzIGV4aXN0LCBzYXZlIGFjdHMgYXMKCSAgICAgIC8vIGBzZXQoYXR0cikuc2F2ZShudWxsLCBvcHRzKWAgd2l0aCB2YWxpZGF0aW9uLiBPdGhlcndpc2UsIGNoZWNrIGlmCgkgICAgICAvLyB0aGUgbW9kZWwgd2lsbCBiZSB2YWxpZCB3aGVuIHRoZSBhdHRyaWJ1dGVzLCBpZiBhbnksIGFyZSBzZXQuCgkgICAgICBpZiAoYXR0cnMgJiYgIW9wdGlvbnMud2FpdCkgewoJICAgICAgICBpZiAoIXRoaXMuc2V0KGF0dHJzLCBvcHRpb25zKSkgcmV0dXJuIGZhbHNlOwoJICAgICAgfSBlbHNlIHsKCSAgICAgICAgaWYgKCF0aGlzLl92YWxpZGF0ZShhdHRycywgb3B0aW9ucykpIHJldHVybiBmYWxzZTsKCSAgICAgIH0KCgkgICAgICAvLyBTZXQgdGVtcG9yYXJ5IGF0dHJpYnV0ZXMgaWYgYHt3YWl0OiB0cnVlfWAuCgkgICAgICBpZiAoYXR0cnMgJiYgb3B0aW9ucy53YWl0KSB7CgkgICAgICAgIHRoaXMuYXR0cmlidXRlcyA9IF8uZXh0ZW5kKHt9LCBhdHRyaWJ1dGVzLCBhdHRycyk7CgkgICAgICB9CgoJICAgICAgLy8gQWZ0ZXIgYSBzdWNjZXNzZnVsIHNlcnZlci1zaWRlIHNhdmUsIHRoZSBjbGllbnQgaXMgKG9wdGlvbmFsbHkpCgkgICAgICAvLyB1cGRhdGVkIHdpdGggdGhlIHNlcnZlci1zaWRlIHN0YXRlLgoJICAgICAgaWYgKG9wdGlvbnMucGFyc2UgPT09IHZvaWQgMCkgb3B0aW9ucy5wYXJzZSA9IHRydWU7CgkgICAgICB2YXIgbW9kZWwgPSB0aGlzOwoJICAgICAgdmFyIHN1Y2Nlc3MgPSBvcHRpb25zLnN1Y2Nlc3M7CgkgICAgICBvcHRpb25zLnN1Y2Nlc3MgPSBmdW5jdGlvbihyZXNwKSB7CgkgICAgICAgIC8vIEVuc3VyZSBhdHRyaWJ1dGVzIGFyZSByZXN0b3JlZCBkdXJpbmcgc3luY2hyb25vdXMgc2F2ZXMuCgkgICAgICAgIG1vZGVsLmF0dHJpYnV0ZXMgPSBhdHRyaWJ1dGVzOwoJICAgICAgICB2YXIgc2VydmVyQXR0cnMgPSBtb2RlbC5wYXJzZShyZXNwLCBvcHRpb25zKTsKCSAgICAgICAgaWYgKG9wdGlvbnMud2FpdCkgc2VydmVyQXR0cnMgPSBfLmV4dGVuZChhdHRycyB8fCB7fSwgc2VydmVyQXR0cnMpOwoJICAgICAgICBpZiAoXy5pc09iamVjdChzZXJ2ZXJBdHRycykgJiYgIW1vZGVsLnNldChzZXJ2ZXJBdHRycywgb3B0aW9ucykpIHsKCSAgICAgICAgICByZXR1cm4gZmFsc2U7CgkgICAgICAgIH0KCSAgICAgICAgaWYgKHN1Y2Nlc3MpIHN1Y2Nlc3MobW9kZWwsIHJlc3AsIG9wdGlvbnMpOwoJICAgICAgICBtb2RlbC50cmlnZ2VyKCdzeW5jJywgbW9kZWwsIHJlc3AsIG9wdGlvbnMpOwoJICAgICAgfTsKCSAgICAgIHdyYXBFcnJvcih0aGlzLCBvcHRpb25zKTsKCgkgICAgICBtZXRob2QgPSB0aGlzLmlzTmV3KCkgPyAnY3JlYXRlJyA6IChvcHRpb25zLnBhdGNoID8gJ3BhdGNoJyA6ICd1cGRhdGUnKTsKCSAgICAgIGlmIChtZXRob2QgPT09ICdwYXRjaCcpIG9wdGlvbnMuYXR0cnMgPSBhdHRyczsKCSAgICAgIHhociA9IHRoaXMuc3luYyhtZXRob2QsIHRoaXMsIG9wdGlvbnMpOwoKCSAgICAgIC8vIFJlc3RvcmUgYXR0cmlidXRlcy4KCSAgICAgIGlmIChhdHRycyAmJiBvcHRpb25zLndhaXQpIHRoaXMuYXR0cmlidXRlcyA9IGF0dHJpYnV0ZXM7CgoJICAgICAgcmV0dXJuIHhocjsKCSAgICB9LAoKCSAgICAvLyBEZXN0cm95IHRoaXMgbW9kZWwgb24gdGhlIHNlcnZlciBpZiBpdCB3YXMgYWxyZWFkeSBwZXJzaXN0ZWQuCgkgICAgLy8gT3B0aW1pc3RpY2FsbHkgcmVtb3ZlcyB0aGUgbW9kZWwgZnJvbSBpdHMgY29sbGVjdGlvbiwgaWYgaXQgaGFzIG9uZS4KCSAgICAvLyBJZiBgd2FpdDogdHJ1ZWAgaXMgcGFzc2VkLCB3YWl0cyBmb3IgdGhlIHNlcnZlciB0byByZXNwb25kIGJlZm9yZSByZW1vdmFsLgoJICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKCSAgICAgIG9wdGlvbnMgPSBvcHRpb25zID8gXy5jbG9uZShvcHRpb25zKSA6IHt9OwoJICAgICAgdmFyIG1vZGVsID0gdGhpczsKCSAgICAgIHZhciBzdWNjZXNzID0gb3B0aW9ucy5zdWNjZXNzOwoKCSAgICAgIHZhciBkZXN0cm95ID0gZnVuY3Rpb24oKSB7CgkgICAgICAgIG1vZGVsLnRyaWdnZXIoJ2Rlc3Ryb3knLCBtb2RlbCwgbW9kZWwuY29sbGVjdGlvbiwgb3B0aW9ucyk7CgkgICAgICB9OwoKCSAgICAgIG9wdGlvbnMuc3VjY2VzcyA9IGZ1bmN0aW9uKHJlc3ApIHsKCSAgICAgICAgaWYgKG9wdGlvbnMud2FpdCB8fCBtb2RlbC5pc05ldygpKSBkZXN0cm95KCk7CgkgICAgICAgIGlmIChzdWNjZXNzKSBzdWNjZXNzKG1vZGVsLCByZXNwLCBvcHRpb25zKTsKCSAgICAgICAgaWYgKCFtb2RlbC5pc05ldygpKSBtb2RlbC50cmlnZ2VyKCdzeW5jJywgbW9kZWwsIHJlc3AsIG9wdGlvbnMpOwoJICAgICAgfTsKCgkgICAgICBpZiAodGhpcy5pc05ldygpKSB7CgkgICAgICAgIG9wdGlvbnMuc3VjY2VzcygpOwoJICAgICAgICByZXR1cm4gZmFsc2U7CgkgICAgICB9CgkgICAgICB3cmFwRXJyb3IodGhpcywgb3B0aW9ucyk7CgoJICAgICAgdmFyIHhociA9IHRoaXMuc3luYygnZGVsZXRlJywgdGhpcywgb3B0aW9ucyk7CgkgICAgICBpZiAoIW9wdGlvbnMud2FpdCkgZGVzdHJveSgpOwoJICAgICAgcmV0dXJuIHhocjsKCSAgICB9LAoKCSAgICAvLyBEZWZhdWx0IFVSTCBmb3IgdGhlIG1vZGVsJ3MgcmVwcmVzZW50YXRpb24gb24gdGhlIHNlcnZlciAtLSBpZiB5b3UncmUKCSAgICAvLyB1c2luZyBCYWNrYm9uZSdzIHJlc3RmdWwgbWV0aG9kcywgb3ZlcnJpZGUgdGhpcyB0byBjaGFuZ2UgdGhlIGVuZHBvaW50CgkgICAgLy8gdGhhdCB3aWxsIGJlIGNhbGxlZC4KCSAgICB1cmw6IGZ1bmN0aW9uKCkgewoJICAgICAgdmFyIGJhc2UgPQoJICAgICAgICBfLnJlc3VsdCh0aGlzLCAndXJsUm9vdCcpIHx8CgkgICAgICAgIF8ucmVzdWx0KHRoaXMuY29sbGVjdGlvbiwgJ3VybCcpIHx8CgkgICAgICAgIHVybEVycm9yKCk7CgkgICAgICBpZiAodGhpcy5pc05ldygpKSByZXR1cm4gYmFzZTsKCSAgICAgIHJldHVybiBiYXNlLnJlcGxhY2UoLyhbXlwvXSkkLywgJyQxLycpICsgZW5jb2RlVVJJQ29tcG9uZW50KHRoaXMuaWQpOwoJICAgIH0sCgoJICAgIC8vICoqcGFyc2UqKiBjb252ZXJ0cyBhIHJlc3BvbnNlIGludG8gdGhlIGhhc2ggb2YgYXR0cmlidXRlcyB0byBiZSBgc2V0YCBvbgoJICAgIC8vIHRoZSBtb2RlbC4gVGhlIGRlZmF1bHQgaW1wbGVtZW50YXRpb24gaXMganVzdCB0byBwYXNzIHRoZSByZXNwb25zZSBhbG9uZy4KCSAgICBwYXJzZTogZnVuY3Rpb24ocmVzcCwgb3B0aW9ucykgewoJICAgICAgcmV0dXJuIHJlc3A7CgkgICAgfSwKCgkgICAgLy8gQ3JlYXRlIGEgbmV3IG1vZGVsIHdpdGggaWRlbnRpY2FsIGF0dHJpYnV0ZXMgdG8gdGhpcyBvbmUuCgkgICAgY2xvbmU6IGZ1bmN0aW9uKCkgewoJICAgICAgcmV0dXJuIG5ldyB0aGlzLmNvbnN0cnVjdG9yKHRoaXMuYXR0cmlidXRlcyk7CgkgICAgfSwKCgkgICAgLy8gQSBtb2RlbCBpcyBuZXcgaWYgaXQgaGFzIG5ldmVyIGJlZW4gc2F2ZWQgdG8gdGhlIHNlcnZlciwgYW5kIGxhY2tzIGFuIGlkLgoJICAgIGlzTmV3OiBmdW5jdGlvbigpIHsKCSAgICAgIHJldHVybiAhdGhpcy5oYXModGhpcy5pZEF0dHJpYnV0ZSk7CgkgICAgfSwKCgkgICAgLy8gQ2hlY2sgaWYgdGhlIG1vZGVsIGlzIGN1cnJlbnRseSBpbiBhIHZhbGlkIHN0YXRlLgoJICAgIGlzVmFsaWQ6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKCSAgICAgIHJldHVybiB0aGlzLl92YWxpZGF0ZSh7fSwgXy5leHRlbmQob3B0aW9ucyB8fCB7fSwgeyB2YWxpZGF0ZTogdHJ1ZSB9KSk7CgkgICAgfSwKCgkgICAgLy8gUnVuIHZhbGlkYXRpb24gYWdhaW5zdCB0aGUgbmV4dCBjb21wbGV0ZSBzZXQgb2YgbW9kZWwgYXR0cmlidXRlcywKCSAgICAvLyByZXR1cm5pbmcgYHRydWVgIGlmIGFsbCBpcyB3ZWxsLiBPdGhlcndpc2UsIGZpcmUgYW4gYCJpbnZhbGlkImAgZXZlbnQuCgkgICAgX3ZhbGlkYXRlOiBmdW5jdGlvbihhdHRycywgb3B0aW9ucykgewoJICAgICAgaWYgKCFvcHRpb25zLnZhbGlkYXRlIHx8ICF0aGlzLnZhbGlkYXRlKSByZXR1cm4gdHJ1ZTsKCSAgICAgIGF0dHJzID0gXy5leHRlbmQoe30sIHRoaXMuYXR0cmlidXRlcywgYXR0cnMpOwoJICAgICAgdmFyIGVycm9yID0gdGhpcy52YWxpZGF0aW9uRXJyb3IgPSB0aGlzLnZhbGlkYXRlKGF0dHJzLCBvcHRpb25zKSB8fCBudWxsOwoJICAgICAgaWYgKCFlcnJvcikgcmV0dXJuIHRydWU7CgkgICAgICB0aGlzLnRyaWdnZXIoJ2ludmFsaWQnLCB0aGlzLCBlcnJvciwgXy5leHRlbmQob3B0aW9ucywge3ZhbGlkYXRpb25FcnJvcjogZXJyb3J9KSk7CgkgICAgICByZXR1cm4gZmFsc2U7CgkgICAgfQoKCSAgfSk7CgoJICAvLyBVbmRlcnNjb3JlIG1ldGhvZHMgdGhhdCB3ZSB3YW50IHRvIGltcGxlbWVudCBvbiB0aGUgTW9kZWwuCgkgIHZhciBtb2RlbE1ldGhvZHMgPSBbJ2tleXMnLCAndmFsdWVzJywgJ3BhaXJzJywgJ2ludmVydCcsICdwaWNrJywgJ29taXQnXTsKCgkgIC8vIE1peCBpbiBlYWNoIFVuZGVyc2NvcmUgbWV0aG9kIGFzIGEgcHJveHkgdG8gYE1vZGVsI2F0dHJpYnV0ZXNgLgoJICBfLmVhY2gobW9kZWxNZXRob2RzLCBmdW5jdGlvbihtZXRob2QpIHsKCSAgICBNb2RlbC5wcm90b3R5cGVbbWV0aG9kXSA9IGZ1bmN0aW9uKCkgewoJICAgICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cyk7CgkgICAgICBhcmdzLnVuc2hpZnQodGhpcy5hdHRyaWJ1dGVzKTsKCSAgICAgIHJldHVybiBfW21ldGhvZF0uYXBwbHkoXywgYXJncyk7CgkgICAgfTsKCSAgfSk7CgoJICAvLyBCYWNrYm9uZS5Db2xsZWN0aW9uCgkgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0KCgkgIC8vIElmIG1vZGVscyB0ZW5kIHRvIHJlcHJlc2VudCBhIHNpbmdsZSByb3cgb2YgZGF0YSwgYSBCYWNrYm9uZSBDb2xsZWN0aW9uIGlzCgkgIC8vIG1vcmUgYW5hbGFnb3VzIHRvIGEgdGFibGUgZnVsbCBvZiBkYXRhIC4uLiBvciBhIHNtYWxsIHNsaWNlIG9yIHBhZ2Ugb2YgdGhhdAoJICAvLyB0YWJsZSwgb3IgYSBjb2xsZWN0aW9uIG9mIHJvd3MgdGhhdCBiZWxvbmcgdG9nZXRoZXIgZm9yIGEgcGFydGljdWxhciByZWFzb24KCSAgLy8gLS0gYWxsIG9mIHRoZSBtZXNzYWdlcyBpbiB0aGlzIHBhcnRpY3VsYXIgZm9sZGVyLCBhbGwgb2YgdGhlIGRvY3VtZW50cwoJICAvLyBiZWxvbmdpbmcgdG8gdGhpcyBwYXJ0aWN1bGFyIGF1dGhvciwgYW5kIHNvIG9uLiBDb2xsZWN0aW9ucyBtYWludGFpbgoJICAvLyBpbmRleGVzIG9mIHRoZWlyIG1vZGVscywgYm90aCBpbiBvcmRlciwgYW5kIGZvciBsb29rdXAgYnkgYGlkYC4KCgkgIC8vIENyZWF0ZSBhIG5ldyAqKkNvbGxlY3Rpb24qKiwgcGVyaGFwcyB0byBjb250YWluIGEgc3BlY2lmaWMgdHlwZSBvZiBgbW9kZWxgLgoJICAvLyBJZiBhIGBjb21wYXJhdG9yYCBpcyBzcGVjaWZpZWQsIHRoZSBDb2xsZWN0aW9uIHdpbGwgbWFpbnRhaW4KCSAgLy8gaXRzIG1vZGVscyBpbiBzb3J0IG9yZGVyLCBhcyB0aGV5J3JlIGFkZGVkIGFuZCByZW1vdmVkLgoJICB2YXIgQ29sbGVjdGlvbiA9IEJhY2tib25lLkNvbGxlY3Rpb24gPSBmdW5jdGlvbihtb2RlbHMsIG9wdGlvbnMpIHsKCSAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwoJICAgIGlmIChvcHRpb25zLm1vZGVsKSB0aGlzLm1vZGVsID0gb3B0aW9ucy5tb2RlbDsKCSAgICBpZiAob3B0aW9ucy5jb21wYXJhdG9yICE9PSB2b2lkIDApIHRoaXMuY29tcGFyYXRvciA9IG9wdGlvbnMuY29tcGFyYXRvcjsKCSAgICB0aGlzLl9yZXNldCgpOwoJICAgIHRoaXMuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoJICAgIGlmIChtb2RlbHMpIHRoaXMucmVzZXQobW9kZWxzLCBfLmV4dGVuZCh7c2lsZW50OiB0cnVlfSwgb3B0aW9ucykpOwoJICB9OwoKCSAgLy8gRGVmYXVsdCBvcHRpb25zIGZvciBgQ29sbGVjdGlvbiNzZXRgLgoJICB2YXIgc2V0T3B0aW9ucyA9IHthZGQ6IHRydWUsIHJlbW92ZTogdHJ1ZSwgbWVyZ2U6IHRydWV9OwoJICB2YXIgYWRkT3B0aW9ucyA9IHthZGQ6IHRydWUsIHJlbW92ZTogZmFsc2V9OwoKCSAgLy8gRGVmaW5lIHRoZSBDb2xsZWN0aW9uJ3MgaW5oZXJpdGFibGUgbWV0aG9kcy4KCSAgXy5leHRlbmQoQ29sbGVjdGlvbi5wcm90b3R5cGUsIEV2ZW50cywgewoKCSAgICAvLyBUaGUgZGVmYXVsdCBtb2RlbCBmb3IgYSBjb2xsZWN0aW9uIGlzIGp1c3QgYSAqKkJhY2tib25lLk1vZGVsKiouCgkgICAgLy8gVGhpcyBzaG91bGQgYmUgb3ZlcnJpZGRlbiBpbiBtb3N0IGNhc2VzLgoJICAgIG1vZGVsOiBNb2RlbCwKCgkgICAgLy8gSW5pdGlhbGl6ZSBpcyBhbiBlbXB0eSBmdW5jdGlvbiBieSBkZWZhdWx0LiBPdmVycmlkZSBpdCB3aXRoIHlvdXIgb3duCgkgICAgLy8gaW5pdGlhbGl6YXRpb24gbG9naWMuCgkgICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oKXt9LAoKCSAgICAvLyBUaGUgSlNPTiByZXByZXNlbnRhdGlvbiBvZiBhIENvbGxlY3Rpb24gaXMgYW4gYXJyYXkgb2YgdGhlCgkgICAgLy8gbW9kZWxzJyBhdHRyaWJ1dGVzLgoJICAgIHRvSlNPTjogZnVuY3Rpb24ob3B0aW9ucykgewoJICAgICAgcmV0dXJuIHRoaXMubWFwKGZ1bmN0aW9uKG1vZGVsKXsgcmV0dXJuIG1vZGVsLnRvSlNPTihvcHRpb25zKTsgfSk7CgkgICAgfSwKCgkgICAgLy8gUHJveHkgYEJhY2tib25lLnN5bmNgIGJ5IGRlZmF1bHQuCgkgICAgc3luYzogZnVuY3Rpb24oKSB7CgkgICAgICByZXR1cm4gQmFja2JvbmUuc3luYy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoJICAgIH0sCgoJICAgIC8vIEFkZCBhIG1vZGVsLCBvciBsaXN0IG9mIG1vZGVscyB0byB0aGUgc2V0LgoJICAgIGFkZDogZnVuY3Rpb24obW9kZWxzLCBvcHRpb25zKSB7CgkgICAgICByZXR1cm4gdGhpcy5zZXQobW9kZWxzLCBfLmV4dGVuZCh7bWVyZ2U6IGZhbHNlfSwgb3B0aW9ucywgYWRkT3B0aW9ucykpOwoJICAgIH0sCgoJICAgIC8vIFJlbW92ZSBhIG1vZGVsLCBvciBhIGxpc3Qgb2YgbW9kZWxzIGZyb20gdGhlIHNldC4KCSAgICByZW1vdmU6IGZ1bmN0aW9uKG1vZGVscywgb3B0aW9ucykgewoJICAgICAgdmFyIHNpbmd1bGFyID0gIV8uaXNBcnJheShtb2RlbHMpOwoJICAgICAgbW9kZWxzID0gc2luZ3VsYXIgPyBbbW9kZWxzXSA6IF8uY2xvbmUobW9kZWxzKTsKCSAgICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CgkgICAgICB2YXIgaSwgbCwgaW5kZXgsIG1vZGVsOwoJICAgICAgZm9yIChpID0gMCwgbCA9IG1vZGVscy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKCSAgICAgICAgbW9kZWwgPSBtb2RlbHNbaV0gPSB0aGlzLmdldChtb2RlbHNbaV0pOwoJICAgICAgICBpZiAoIW1vZGVsKSBjb250aW51ZTsKCSAgICAgICAgZGVsZXRlIHRoaXMuX2J5SWRbbW9kZWwuaWRdOwoJICAgICAgICBkZWxldGUgdGhpcy5fYnlJZFttb2RlbC5jaWRdOwoJICAgICAgICBpbmRleCA9IHRoaXMuaW5kZXhPZihtb2RlbCk7CgkgICAgICAgIHRoaXMubW9kZWxzLnNwbGljZShpbmRleCwgMSk7CgkgICAgICAgIHRoaXMubGVuZ3RoLS07CgkgICAgICAgIGlmICghb3B0aW9ucy5zaWxlbnQpIHsKCSAgICAgICAgICBvcHRpb25zLmluZGV4ID0gaW5kZXg7CgkgICAgICAgICAgbW9kZWwudHJpZ2dlcigncmVtb3ZlJywgbW9kZWwsIHRoaXMsIG9wdGlvbnMpOwoJICAgICAgICB9CgkgICAgICAgIHRoaXMuX3JlbW92ZVJlZmVyZW5jZShtb2RlbCwgb3B0aW9ucyk7CgkgICAgICB9CgkgICAgICByZXR1cm4gc2luZ3VsYXIgPyBtb2RlbHNbMF0gOiBtb2RlbHM7CgkgICAgfSwKCgkgICAgLy8gVXBkYXRlIGEgY29sbGVjdGlvbiBieSBgc2V0YC1pbmcgYSBuZXcgbGlzdCBvZiBtb2RlbHMsIGFkZGluZyBuZXcgb25lcywKCSAgICAvLyByZW1vdmluZyBtb2RlbHMgdGhhdCBhcmUgbm8gbG9uZ2VyIHByZXNlbnQsIGFuZCBtZXJnaW5nIG1vZGVscyB0aGF0CgkgICAgLy8gYWxyZWFkeSBleGlzdCBpbiB0aGUgY29sbGVjdGlvbiwgYXMgbmVjZXNzYXJ5LiBTaW1pbGFyIHRvICoqTW9kZWwjc2V0KiosCgkgICAgLy8gdGhlIGNvcmUgb3BlcmF0aW9uIGZvciB1cGRhdGluZyB0aGUgZGF0YSBjb250YWluZWQgYnkgdGhlIGNvbGxlY3Rpb24uCgkgICAgc2V0OiBmdW5jdGlvbihtb2RlbHMsIG9wdGlvbnMpIHsKCSAgICAgIG9wdGlvbnMgPSBfLmRlZmF1bHRzKHt9LCBvcHRpb25zLCBzZXRPcHRpb25zKTsKCSAgICAgIGlmIChvcHRpb25zLnBhcnNlKSBtb2RlbHMgPSB0aGlzLnBhcnNlKG1vZGVscywgb3B0aW9ucyk7CgkgICAgICB2YXIgc2luZ3VsYXIgPSAhXy5pc0FycmF5KG1vZGVscyk7CgkgICAgICBtb2RlbHMgPSBzaW5ndWxhciA/IChtb2RlbHMgPyBbbW9kZWxzXSA6IFtdKSA6IF8uY2xvbmUobW9kZWxzKTsKCSAgICAgIHZhciBpLCBsLCBpZCwgbW9kZWwsIGF0dHJzLCBleGlzdGluZywgc29ydDsKCSAgICAgIHZhciBhdCA9IG9wdGlvbnMuYXQ7CgkgICAgICB2YXIgdGFyZ2V0TW9kZWwgPSB0aGlzLm1vZGVsOwoJICAgICAgdmFyIHNvcnRhYmxlID0gdGhpcy5jb21wYXJhdG9yICYmIChhdCA9PSBudWxsKSAmJiBvcHRpb25zLnNvcnQgIT09IGZhbHNlOwoJICAgICAgdmFyIHNvcnRBdHRyID0gXy5pc1N0cmluZyh0aGlzLmNvbXBhcmF0b3IpID8gdGhpcy5jb21wYXJhdG9yIDogbnVsbDsKCSAgICAgIHZhciB0b0FkZCA9IFtdLCB0b1JlbW92ZSA9IFtdLCBtb2RlbE1hcCA9IHt9OwoJICAgICAgdmFyIGFkZCA9IG9wdGlvbnMuYWRkLCBtZXJnZSA9IG9wdGlvbnMubWVyZ2UsIHJlbW92ZSA9IG9wdGlvbnMucmVtb3ZlOwoJICAgICAgdmFyIG9yZGVyID0gIXNvcnRhYmxlICYmIGFkZCAmJiByZW1vdmUgPyBbXSA6IGZhbHNlOwoKCSAgICAgIC8vIFR1cm4gYmFyZSBvYmplY3RzIGludG8gbW9kZWwgcmVmZXJlbmNlcywgYW5kIHByZXZlbnQgaW52YWxpZCBtb2RlbHMKCSAgICAgIC8vIGZyb20gYmVpbmcgYWRkZWQuCgkgICAgICBmb3IgKGkgPSAwLCBsID0gbW9kZWxzLmxlbmd0aDsgaSA8IGw7IGkrKykgewoJICAgICAgICBhdHRycyA9IG1vZGVsc1tpXSB8fCB7fTsKCSAgICAgICAgaWYgKGF0dHJzIGluc3RhbmNlb2YgTW9kZWwpIHsKCSAgICAgICAgICBpZCA9IG1vZGVsID0gYXR0cnM7CgkgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgaWQgPSBhdHRyc1t0YXJnZXRNb2RlbC5wcm90b3R5cGUuaWRBdHRyaWJ1dGUgfHwgJ2lkJ107CgkgICAgICAgIH0KCgkgICAgICAgIC8vIElmIGEgZHVwbGljYXRlIGlzIGZvdW5kLCBwcmV2ZW50IGl0IGZyb20gYmVpbmcgYWRkZWQgYW5kCgkgICAgICAgIC8vIG9wdGlvbmFsbHkgbWVyZ2UgaXQgaW50byB0aGUgZXhpc3RpbmcgbW9kZWwuCgkgICAgICAgIGlmIChleGlzdGluZyA9IHRoaXMuZ2V0KGlkKSkgewoJICAgICAgICAgIGlmIChyZW1vdmUpIG1vZGVsTWFwW2V4aXN0aW5nLmNpZF0gPSB0cnVlOwoJICAgICAgICAgIGlmIChtZXJnZSkgewoJICAgICAgICAgICAgYXR0cnMgPSBhdHRycyA9PT0gbW9kZWwgPyBtb2RlbC5hdHRyaWJ1dGVzIDogYXR0cnM7CgkgICAgICAgICAgICBpZiAob3B0aW9ucy5wYXJzZSkgYXR0cnMgPSBleGlzdGluZy5wYXJzZShhdHRycywgb3B0aW9ucyk7CgkgICAgICAgICAgICBleGlzdGluZy5zZXQoYXR0cnMsIG9wdGlvbnMpOwoJICAgICAgICAgICAgaWYgKHNvcnRhYmxlICYmICFzb3J0ICYmIGV4aXN0aW5nLmhhc0NoYW5nZWQoc29ydEF0dHIpKSBzb3J0ID0gdHJ1ZTsKCSAgICAgICAgICB9CgkgICAgICAgICAgbW9kZWxzW2ldID0gZXhpc3Rpbmc7CgoJICAgICAgICAvLyBJZiB0aGlzIGlzIGEgbmV3LCB2YWxpZCBtb2RlbCwgcHVzaCBpdCB0byB0aGUgYHRvQWRkYCBsaXN0LgoJICAgICAgICB9IGVsc2UgaWYgKGFkZCkgewoJICAgICAgICAgIG1vZGVsID0gbW9kZWxzW2ldID0gdGhpcy5fcHJlcGFyZU1vZGVsKGF0dHJzLCBvcHRpb25zKTsKCSAgICAgICAgICBpZiAoIW1vZGVsKSBjb250aW51ZTsKCSAgICAgICAgICB0b0FkZC5wdXNoKG1vZGVsKTsKCSAgICAgICAgICB0aGlzLl9hZGRSZWZlcmVuY2UobW9kZWwsIG9wdGlvbnMpOwoJICAgICAgICB9CgoJICAgICAgICAvLyBEbyBub3QgYWRkIG11bHRpcGxlIG1vZGVscyB3aXRoIHRoZSBzYW1lIGBpZGAuCgkgICAgICAgIG1vZGVsID0gZXhpc3RpbmcgfHwgbW9kZWw7CgkgICAgICAgIGlmIChvcmRlciAmJiAobW9kZWwuaXNOZXcoKSB8fCAhbW9kZWxNYXBbbW9kZWwuaWRdKSkgb3JkZXIucHVzaChtb2RlbCk7CgkgICAgICAgIG1vZGVsTWFwW21vZGVsLmlkXSA9IHRydWU7CgkgICAgICB9CgoJICAgICAgLy8gUmVtb3ZlIG5vbmV4aXN0ZW50IG1vZGVscyBpZiBhcHByb3ByaWF0ZS4KCSAgICAgIGlmIChyZW1vdmUpIHsKCSAgICAgICAgZm9yIChpID0gMCwgbCA9IHRoaXMubGVuZ3RoOyBpIDwgbDsgKytpKSB7CgkgICAgICAgICAgaWYgKCFtb2RlbE1hcFsobW9kZWwgPSB0aGlzLm1vZGVsc1tpXSkuY2lkXSkgdG9SZW1vdmUucHVzaChtb2RlbCk7CgkgICAgICAgIH0KCSAgICAgICAgaWYgKHRvUmVtb3ZlLmxlbmd0aCkgdGhpcy5yZW1vdmUodG9SZW1vdmUsIG9wdGlvbnMpOwoJICAgICAgfQoKCSAgICAgIC8vIFNlZSBpZiBzb3J0aW5nIGlzIG5lZWRlZCwgdXBkYXRlIGBsZW5ndGhgIGFuZCBzcGxpY2UgaW4gbmV3IG1vZGVscy4KCSAgICAgIGlmICh0b0FkZC5sZW5ndGggfHwgKG9yZGVyICYmIG9yZGVyLmxlbmd0aCkpIHsKCSAgICAgICAgaWYgKHNvcnRhYmxlKSBzb3J0ID0gdHJ1ZTsKCSAgICAgICAgdGhpcy5sZW5ndGggKz0gdG9BZGQubGVuZ3RoOwoJICAgICAgICBpZiAoYXQgIT0gbnVsbCkgewoJICAgICAgICAgIGZvciAoaSA9IDAsIGwgPSB0b0FkZC5sZW5ndGg7IGkgPCBsOyBpKyspIHsKCSAgICAgICAgICAgIHRoaXMubW9kZWxzLnNwbGljZShhdCArIGksIDAsIHRvQWRkW2ldKTsKCSAgICAgICAgICB9CgkgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgaWYgKG9yZGVyKSB0aGlzLm1vZGVscy5sZW5ndGggPSAwOwoJICAgICAgICAgIHZhciBvcmRlcmVkTW9kZWxzID0gb3JkZXIgfHwgdG9BZGQ7CgkgICAgICAgICAgZm9yIChpID0gMCwgbCA9IG9yZGVyZWRNb2RlbHMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CgkgICAgICAgICAgICB0aGlzLm1vZGVscy5wdXNoKG9yZGVyZWRNb2RlbHNbaV0pOwoJICAgICAgICAgIH0KCSAgICAgICAgfQoJICAgICAgfQoKCSAgICAgIC8vIFNpbGVudGx5IHNvcnQgdGhlIGNvbGxlY3Rpb24gaWYgYXBwcm9wcmlhdGUuCgkgICAgICBpZiAoc29ydCkgdGhpcy5zb3J0KHtzaWxlbnQ6IHRydWV9KTsKCgkgICAgICAvLyBVbmxlc3Mgc2lsZW5jZWQsIGl0J3MgdGltZSB0byBmaXJlIGFsbCBhcHByb3ByaWF0ZSBhZGQvc29ydCBldmVudHMuCgkgICAgICBpZiAoIW9wdGlvbnMuc2lsZW50KSB7CgkgICAgICAgIGZvciAoaSA9IDAsIGwgPSB0b0FkZC5sZW5ndGg7IGkgPCBsOyBpKyspIHsKCSAgICAgICAgICAobW9kZWwgPSB0b0FkZFtpXSkudHJpZ2dlcignYWRkJywgbW9kZWwsIHRoaXMsIG9wdGlvbnMpOwoJICAgICAgICB9CgkgICAgICAgIGlmIChzb3J0IHx8IChvcmRlciAmJiBvcmRlci5sZW5ndGgpKSB0aGlzLnRyaWdnZXIoJ3NvcnQnLCB0aGlzLCBvcHRpb25zKTsKCSAgICAgIH0KCgkgICAgICAvLyBSZXR1cm4gdGhlIGFkZGVkIChvciBtZXJnZWQpIG1vZGVsIChvciBtb2RlbHMpLgoJICAgICAgcmV0dXJuIHNpbmd1bGFyID8gbW9kZWxzWzBdIDogbW9kZWxzOwoJICAgIH0sCgoJICAgIC8vIFdoZW4geW91IGhhdmUgbW9yZSBpdGVtcyB0aGFuIHlvdSB3YW50IHRvIGFkZCBvciByZW1vdmUgaW5kaXZpZHVhbGx5LAoJICAgIC8vIHlvdSBjYW4gcmVzZXQgdGhlIGVudGlyZSBzZXQgd2l0aCBhIG5ldyBsaXN0IG9mIG1vZGVscywgd2l0aG91dCBmaXJpbmcKCSAgICAvLyBhbnkgZ3JhbnVsYXIgYGFkZGAgb3IgYHJlbW92ZWAgZXZlbnRzLiBGaXJlcyBgcmVzZXRgIHdoZW4gZmluaXNoZWQuCgkgICAgLy8gVXNlZnVsIGZvciBidWxrIG9wZXJhdGlvbnMgYW5kIG9wdGltaXphdGlvbnMuCgkgICAgcmVzZXQ6IGZ1bmN0aW9uKG1vZGVscywgb3B0aW9ucykgewoJICAgICAgb3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KTsKCSAgICAgIGZvciAodmFyIGkgPSAwLCBsID0gdGhpcy5tb2RlbHMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CgkgICAgICAgIHRoaXMuX3JlbW92ZVJlZmVyZW5jZSh0aGlzLm1vZGVsc1tpXSwgb3B0aW9ucyk7CgkgICAgICB9CgkgICAgICBvcHRpb25zLnByZXZpb3VzTW9kZWxzID0gdGhpcy5tb2RlbHM7CgkgICAgICB0aGlzLl9yZXNldCgpOwoJICAgICAgbW9kZWxzID0gdGhpcy5hZGQobW9kZWxzLCBfLmV4dGVuZCh7c2lsZW50OiB0cnVlfSwgb3B0aW9ucykpOwoJICAgICAgaWYgKCFvcHRpb25zLnNpbGVudCkgdGhpcy50cmlnZ2VyKCdyZXNldCcsIHRoaXMsIG9wdGlvbnMpOwoJICAgICAgcmV0dXJuIG1vZGVsczsKCSAgICB9LAoKCSAgICAvLyBBZGQgYSBtb2RlbCB0byB0aGUgZW5kIG9mIHRoZSBjb2xsZWN0aW9uLgoJICAgIHB1c2g6IGZ1bmN0aW9uKG1vZGVsLCBvcHRpb25zKSB7CgkgICAgICByZXR1cm4gdGhpcy5hZGQobW9kZWwsIF8uZXh0ZW5kKHthdDogdGhpcy5sZW5ndGh9LCBvcHRpb25zKSk7CgkgICAgfSwKCgkgICAgLy8gUmVtb3ZlIGEgbW9kZWwgZnJvbSB0aGUgZW5kIG9mIHRoZSBjb2xsZWN0aW9uLgoJICAgIHBvcDogZnVuY3Rpb24ob3B0aW9ucykgewoJICAgICAgdmFyIG1vZGVsID0gdGhpcy5hdCh0aGlzLmxlbmd0aCAtIDEpOwoJICAgICAgdGhpcy5yZW1vdmUobW9kZWwsIG9wdGlvbnMpOwoJICAgICAgcmV0dXJuIG1vZGVsOwoJICAgIH0sCgoJICAgIC8vIEFkZCBhIG1vZGVsIHRvIHRoZSBiZWdpbm5pbmcgb2YgdGhlIGNvbGxlY3Rpb24uCgkgICAgdW5zaGlmdDogZnVuY3Rpb24obW9kZWwsIG9wdGlvbnMpIHsKCSAgICAgIHJldHVybiB0aGlzLmFkZChtb2RlbCwgXy5leHRlbmQoe2F0OiAwfSwgb3B0aW9ucykpOwoJICAgIH0sCgoJICAgIC8vIFJlbW92ZSBhIG1vZGVsIGZyb20gdGhlIGJlZ2lubmluZyBvZiB0aGUgY29sbGVjdGlvbi4KCSAgICBzaGlmdDogZnVuY3Rpb24ob3B0aW9ucykgewoJICAgICAgdmFyIG1vZGVsID0gdGhpcy5hdCgwKTsKCSAgICAgIHRoaXMucmVtb3ZlKG1vZGVsLCBvcHRpb25zKTsKCSAgICAgIHJldHVybiBtb2RlbDsKCSAgICB9LAoKCSAgICAvLyBTbGljZSBvdXQgYSBzdWItYXJyYXkgb2YgbW9kZWxzIGZyb20gdGhlIGNvbGxlY3Rpb24uCgkgICAgc2xpY2U6IGZ1bmN0aW9uKCkgewoJICAgICAgcmV0dXJuIHNsaWNlLmFwcGx5KHRoaXMubW9kZWxzLCBhcmd1bWVudHMpOwoJICAgIH0sCgoJICAgIC8vIEdldCBhIG1vZGVsIGZyb20gdGhlIHNldCBieSBpZC4KCSAgICBnZXQ6IGZ1bmN0aW9uKG9iaikgewoJICAgICAgaWYgKG9iaiA9PSBudWxsKSByZXR1cm4gdm9pZCAwOwoJICAgICAgcmV0dXJuIHRoaXMuX2J5SWRbb2JqXSB8fCB0aGlzLl9ieUlkW29iai5pZF0gfHwgdGhpcy5fYnlJZFtvYmouY2lkXTsKCSAgICB9LAoKCSAgICAvLyBHZXQgdGhlIG1vZGVsIGF0IHRoZSBnaXZlbiBpbmRleC4KCSAgICBhdDogZnVuY3Rpb24oaW5kZXgpIHsKCSAgICAgIHJldHVybiB0aGlzLm1vZGVsc1tpbmRleF07CgkgICAgfSwKCgkgICAgLy8gUmV0dXJuIG1vZGVscyB3aXRoIG1hdGNoaW5nIGF0dHJpYnV0ZXMuIFVzZWZ1bCBmb3Igc2ltcGxlIGNhc2VzIG9mCgkgICAgLy8gYGZpbHRlcmAuCgkgICAgd2hlcmU6IGZ1bmN0aW9uKGF0dHJzLCBmaXJzdCkgewoJICAgICAgaWYgKF8uaXNFbXB0eShhdHRycykpIHJldHVybiBmaXJzdCA/IHZvaWQgMCA6IFtdOwoJICAgICAgcmV0dXJuIHRoaXNbZmlyc3QgPyAnZmluZCcgOiAnZmlsdGVyJ10oZnVuY3Rpb24obW9kZWwpIHsKCSAgICAgICAgZm9yICh2YXIga2V5IGluIGF0dHJzKSB7CgkgICAgICAgICAgaWYgKGF0dHJzW2tleV0gIT09IG1vZGVsLmdldChrZXkpKSByZXR1cm4gZmFsc2U7CgkgICAgICAgIH0KCSAgICAgICAgcmV0dXJuIHRydWU7CgkgICAgICB9KTsKCSAgICB9LAoKCSAgICAvLyBSZXR1cm4gdGhlIGZpcnN0IG1vZGVsIHdpdGggbWF0Y2hpbmcgYXR0cmlidXRlcy4gVXNlZnVsIGZvciBzaW1wbGUgY2FzZXMKCSAgICAvLyBvZiBgZmluZGAuCgkgICAgZmluZFdoZXJlOiBmdW5jdGlvbihhdHRycykgewoJICAgICAgcmV0dXJuIHRoaXMud2hlcmUoYXR0cnMsIHRydWUpOwoJICAgIH0sCgoJICAgIC8vIEZvcmNlIHRoZSBjb2xsZWN0aW9uIHRvIHJlLXNvcnQgaXRzZWxmLiBZb3UgZG9uJ3QgbmVlZCB0byBjYWxsIHRoaXMgdW5kZXIKCSAgICAvLyBub3JtYWwgY2lyY3Vtc3RhbmNlcywgYXMgdGhlIHNldCB3aWxsIG1haW50YWluIHNvcnQgb3JkZXIgYXMgZWFjaCBpdGVtCgkgICAgLy8gaXMgYWRkZWQuCgkgICAgc29ydDogZnVuY3Rpb24ob3B0aW9ucykgewoJICAgICAgaWYgKCF0aGlzLmNvbXBhcmF0b3IpIHRocm93IG5ldyBFcnJvcignQ2Fubm90IHNvcnQgYSBzZXQgd2l0aG91dCBhIGNvbXBhcmF0b3InKTsKCSAgICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CgoJICAgICAgLy8gUnVuIHNvcnQgYmFzZWQgb24gdHlwZSBvZiBgY29tcGFyYXRvcmAuCgkgICAgICBpZiAoXy5pc1N0cmluZyh0aGlzLmNvbXBhcmF0b3IpIHx8IHRoaXMuY29tcGFyYXRvci5sZW5ndGggPT09IDEpIHsKCSAgICAgICAgdGhpcy5tb2RlbHMgPSB0aGlzLnNvcnRCeSh0aGlzLmNvbXBhcmF0b3IsIHRoaXMpOwoJICAgICAgfSBlbHNlIHsKCSAgICAgICAgdGhpcy5tb2RlbHMuc29ydChfLmJpbmQodGhpcy5jb21wYXJhdG9yLCB0aGlzKSk7CgkgICAgICB9CgoJICAgICAgaWYgKCFvcHRpb25zLnNpbGVudCkgdGhpcy50cmlnZ2VyKCdzb3J0JywgdGhpcywgb3B0aW9ucyk7CgkgICAgICByZXR1cm4gdGhpczsKCSAgICB9LAoKCSAgICAvLyBQbHVjayBhbiBhdHRyaWJ1dGUgZnJvbSBlYWNoIG1vZGVsIGluIHRoZSBjb2xsZWN0aW9uLgoJICAgIHBsdWNrOiBmdW5jdGlvbihhdHRyKSB7CgkgICAgICByZXR1cm4gXy5pbnZva2UodGhpcy5tb2RlbHMsICdnZXQnLCBhdHRyKTsKCSAgICB9LAoKCSAgICAvLyBGZXRjaCB0aGUgZGVmYXVsdCBzZXQgb2YgbW9kZWxzIGZvciB0aGlzIGNvbGxlY3Rpb24sIHJlc2V0dGluZyB0aGUKCSAgICAvLyBjb2xsZWN0aW9uIHdoZW4gdGhleSBhcnJpdmUuIElmIGByZXNldDogdHJ1ZWAgaXMgcGFzc2VkLCB0aGUgcmVzcG9uc2UKCSAgICAvLyBkYXRhIHdpbGwgYmUgcGFzc2VkIHRocm91Z2ggdGhlIGByZXNldGAgbWV0aG9kIGluc3RlYWQgb2YgYHNldGAuCgkgICAgZmV0Y2g6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKCSAgICAgIG9wdGlvbnMgPSBvcHRpb25zID8gXy5jbG9uZShvcHRpb25zKSA6IHt9OwoJICAgICAgaWYgKG9wdGlvbnMucGFyc2UgPT09IHZvaWQgMCkgb3B0aW9ucy5wYXJzZSA9IHRydWU7CgkgICAgICB2YXIgc3VjY2VzcyA9IG9wdGlvbnMuc3VjY2VzczsKCSAgICAgIHZhciBjb2xsZWN0aW9uID0gdGhpczsKCSAgICAgIG9wdGlvbnMuc3VjY2VzcyA9IGZ1bmN0aW9uKHJlc3ApIHsKCSAgICAgICAgdmFyIG1ldGhvZCA9IG9wdGlvbnMucmVzZXQgPyAncmVzZXQnIDogJ3NldCc7CgkgICAgICAgIGNvbGxlY3Rpb25bbWV0aG9kXShyZXNwLCBvcHRpb25zKTsKCSAgICAgICAgaWYgKHN1Y2Nlc3MpIHN1Y2Nlc3MoY29sbGVjdGlvbiwgcmVzcCwgb3B0aW9ucyk7CgkgICAgICAgIGNvbGxlY3Rpb24udHJpZ2dlcignc3luYycsIGNvbGxlY3Rpb24sIHJlc3AsIG9wdGlvbnMpOwoJICAgICAgfTsKCSAgICAgIHdyYXBFcnJvcih0aGlzLCBvcHRpb25zKTsKCSAgICAgIHJldHVybiB0aGlzLnN5bmMoJ3JlYWQnLCB0aGlzLCBvcHRpb25zKTsKCSAgICB9LAoKCSAgICAvLyBDcmVhdGUgYSBuZXcgaW5zdGFuY2Ugb2YgYSBtb2RlbCBpbiB0aGlzIGNvbGxlY3Rpb24uIEFkZCB0aGUgbW9kZWwgdG8gdGhlCgkgICAgLy8gY29sbGVjdGlvbiBpbW1lZGlhdGVseSwgdW5sZXNzIGB3YWl0OiB0cnVlYCBpcyBwYXNzZWQsIGluIHdoaWNoIGNhc2Ugd2UKCSAgICAvLyB3YWl0IGZvciB0aGUgc2VydmVyIHRvIGFncmVlLgoJICAgIGNyZWF0ZTogZnVuY3Rpb24obW9kZWwsIG9wdGlvbnMpIHsKCSAgICAgIG9wdGlvbnMgPSBvcHRpb25zID8gXy5jbG9uZShvcHRpb25zKSA6IHt9OwoJICAgICAgaWYgKCEobW9kZWwgPSB0aGlzLl9wcmVwYXJlTW9kZWwobW9kZWwsIG9wdGlvbnMpKSkgcmV0dXJuIGZhbHNlOwoJICAgICAgaWYgKCFvcHRpb25zLndhaXQpIHRoaXMuYWRkKG1vZGVsLCBvcHRpb25zKTsKCSAgICAgIHZhciBjb2xsZWN0aW9uID0gdGhpczsKCSAgICAgIHZhciBzdWNjZXNzID0gb3B0aW9ucy5zdWNjZXNzOwoJICAgICAgb3B0aW9ucy5zdWNjZXNzID0gZnVuY3Rpb24obW9kZWwsIHJlc3ApIHsKCSAgICAgICAgaWYgKG9wdGlvbnMud2FpdCkgY29sbGVjdGlvbi5hZGQobW9kZWwsIG9wdGlvbnMpOwoJICAgICAgICBpZiAoc3VjY2Vzcykgc3VjY2Vzcyhtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CgkgICAgICB9OwoJICAgICAgbW9kZWwuc2F2ZShudWxsLCBvcHRpb25zKTsKCSAgICAgIHJldHVybiBtb2RlbDsKCSAgICB9LAoKCSAgICAvLyAqKnBhcnNlKiogY29udmVydHMgYSByZXNwb25zZSBpbnRvIGEgbGlzdCBvZiBtb2RlbHMgdG8gYmUgYWRkZWQgdG8gdGhlCgkgICAgLy8gY29sbGVjdGlvbi4gVGhlIGRlZmF1bHQgaW1wbGVtZW50YXRpb24gaXMganVzdCB0byBwYXNzIGl0IHRocm91Z2guCgkgICAgcGFyc2U6IGZ1bmN0aW9uKHJlc3AsIG9wdGlvbnMpIHsKCSAgICAgIHJldHVybiByZXNwOwoJICAgIH0sCgoJICAgIC8vIENyZWF0ZSBhIG5ldyBjb2xsZWN0aW9uIHdpdGggYW4gaWRlbnRpY2FsIGxpc3Qgb2YgbW9kZWxzIGFzIHRoaXMgb25lLgoJICAgIGNsb25lOiBmdW5jdGlvbigpIHsKCSAgICAgIHJldHVybiBuZXcgdGhpcy5jb25zdHJ1Y3Rvcih0aGlzLm1vZGVscyk7CgkgICAgfSwKCgkgICAgLy8gUHJpdmF0ZSBtZXRob2QgdG8gcmVzZXQgYWxsIGludGVybmFsIHN0YXRlLiBDYWxsZWQgd2hlbiB0aGUgY29sbGVjdGlvbgoJICAgIC8vIGlzIGZpcnN0IGluaXRpYWxpemVkIG9yIHJlc2V0LgoJICAgIF9yZXNldDogZnVuY3Rpb24oKSB7CgkgICAgICB0aGlzLmxlbmd0aCA9IDA7CgkgICAgICB0aGlzLm1vZGVscyA9IFtdOwoJICAgICAgdGhpcy5fYnlJZCAgPSB7fTsKCSAgICB9LAoKCSAgICAvLyBQcmVwYXJlIGEgaGFzaCBvZiBhdHRyaWJ1dGVzIChvciBvdGhlciBtb2RlbCkgdG8gYmUgYWRkZWQgdG8gdGhpcwoJICAgIC8vIGNvbGxlY3Rpb24uCgkgICAgX3ByZXBhcmVNb2RlbDogZnVuY3Rpb24oYXR0cnMsIG9wdGlvbnMpIHsKCSAgICAgIGlmIChhdHRycyBpbnN0YW5jZW9mIE1vZGVsKSByZXR1cm4gYXR0cnM7CgkgICAgICBvcHRpb25zID0gb3B0aW9ucyA/IF8uY2xvbmUob3B0aW9ucykgOiB7fTsKCSAgICAgIG9wdGlvbnMuY29sbGVjdGlvbiA9IHRoaXM7CgkgICAgICB2YXIgbW9kZWwgPSBuZXcgdGhpcy5tb2RlbChhdHRycywgb3B0aW9ucyk7CgkgICAgICBpZiAoIW1vZGVsLnZhbGlkYXRpb25FcnJvcikgcmV0dXJuIG1vZGVsOwoJICAgICAgdGhpcy50cmlnZ2VyKCdpbnZhbGlkJywgdGhpcywgbW9kZWwudmFsaWRhdGlvbkVycm9yLCBvcHRpb25zKTsKCSAgICAgIHJldHVybiBmYWxzZTsKCSAgICB9LAoKCSAgICAvLyBJbnRlcm5hbCBtZXRob2QgdG8gY3JlYXRlIGEgbW9kZWwncyB0aWVzIHRvIGEgY29sbGVjdGlvbi4KCSAgICBfYWRkUmVmZXJlbmNlOiBmdW5jdGlvbihtb2RlbCwgb3B0aW9ucykgewoJICAgICAgdGhpcy5fYnlJZFttb2RlbC5jaWRdID0gbW9kZWw7CgkgICAgICBpZiAobW9kZWwuaWQgIT0gbnVsbCkgdGhpcy5fYnlJZFttb2RlbC5pZF0gPSBtb2RlbDsKCSAgICAgIGlmICghbW9kZWwuY29sbGVjdGlvbikgbW9kZWwuY29sbGVjdGlvbiA9IHRoaXM7CgkgICAgICBtb2RlbC5vbignYWxsJywgdGhpcy5fb25Nb2RlbEV2ZW50LCB0aGlzKTsKCSAgICB9LAoKCSAgICAvLyBJbnRlcm5hbCBtZXRob2QgdG8gc2V2ZXIgYSBtb2RlbCdzIHRpZXMgdG8gYSBjb2xsZWN0aW9uLgoJICAgIF9yZW1vdmVSZWZlcmVuY2U6IGZ1bmN0aW9uKG1vZGVsLCBvcHRpb25zKSB7CgkgICAgICBpZiAodGhpcyA9PT0gbW9kZWwuY29sbGVjdGlvbikgZGVsZXRlIG1vZGVsLmNvbGxlY3Rpb247CgkgICAgICBtb2RlbC5vZmYoJ2FsbCcsIHRoaXMuX29uTW9kZWxFdmVudCwgdGhpcyk7CgkgICAgfSwKCgkgICAgLy8gSW50ZXJuYWwgbWV0aG9kIGNhbGxlZCBldmVyeSB0aW1lIGEgbW9kZWwgaW4gdGhlIHNldCBmaXJlcyBhbiBldmVudC4KCSAgICAvLyBTZXRzIG5lZWQgdG8gdXBkYXRlIHRoZWlyIGluZGV4ZXMgd2hlbiBtb2RlbHMgY2hhbmdlIGlkcy4gQWxsIG90aGVyCgkgICAgLy8gZXZlbnRzIHNpbXBseSBwcm94eSB0aHJvdWdoLiAiYWRkIiBhbmQgInJlbW92ZSIgZXZlbnRzIHRoYXQgb3JpZ2luYXRlCgkgICAgLy8gaW4gb3RoZXIgY29sbGVjdGlvbnMgYXJlIGlnbm9yZWQuCgkgICAgX29uTW9kZWxFdmVudDogZnVuY3Rpb24oZXZlbnQsIG1vZGVsLCBjb2xsZWN0aW9uLCBvcHRpb25zKSB7CgkgICAgICBpZiAoKGV2ZW50ID09PSAnYWRkJyB8fCBldmVudCA9PT0gJ3JlbW92ZScpICYmIGNvbGxlY3Rpb24gIT09IHRoaXMpIHJldHVybjsKCSAgICAgIGlmIChldmVudCA9PT0gJ2Rlc3Ryb3knKSB0aGlzLnJlbW92ZShtb2RlbCwgb3B0aW9ucyk7CgkgICAgICBpZiAobW9kZWwgJiYgZXZlbnQgPT09ICdjaGFuZ2U6JyArIG1vZGVsLmlkQXR0cmlidXRlKSB7CgkgICAgICAgIGRlbGV0ZSB0aGlzLl9ieUlkW21vZGVsLnByZXZpb3VzKG1vZGVsLmlkQXR0cmlidXRlKV07CgkgICAgICAgIGlmIChtb2RlbC5pZCAhPSBudWxsKSB0aGlzLl9ieUlkW21vZGVsLmlkXSA9IG1vZGVsOwoJICAgICAgfQoJICAgICAgdGhpcy50cmlnZ2VyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CgkgICAgfQoKCSAgfSk7CgoJICAvLyBVbmRlcnNjb3JlIG1ldGhvZHMgdGhhdCB3ZSB3YW50IHRvIGltcGxlbWVudCBvbiB0aGUgQ29sbGVjdGlvbi4KCSAgLy8gOTAlIG9mIHRoZSBjb3JlIHVzZWZ1bG5lc3Mgb2YgQmFja2JvbmUgQ29sbGVjdGlvbnMgaXMgYWN0dWFsbHkgaW1wbGVtZW50ZWQKCSAgLy8gcmlnaHQgaGVyZToKCSAgdmFyIG1ldGhvZHMgPSBbJ2ZvckVhY2gnLCAnZWFjaCcsICdtYXAnLCAnY29sbGVjdCcsICdyZWR1Y2UnLCAnZm9sZGwnLAoJICAgICdpbmplY3QnLCAncmVkdWNlUmlnaHQnLCAnZm9sZHInLCAnZmluZCcsICdkZXRlY3QnLCAnZmlsdGVyJywgJ3NlbGVjdCcsCgkgICAgJ3JlamVjdCcsICdldmVyeScsICdhbGwnLCAnc29tZScsICdhbnknLCAnaW5jbHVkZScsICdjb250YWlucycsICdpbnZva2UnLAoJICAgICdtYXgnLCAnbWluJywgJ3RvQXJyYXknLCAnc2l6ZScsICdmaXJzdCcsICdoZWFkJywgJ3Rha2UnLCAnaW5pdGlhbCcsICdyZXN0JywKCSAgICAndGFpbCcsICdkcm9wJywgJ2xhc3QnLCAnd2l0aG91dCcsICdkaWZmZXJlbmNlJywgJ2luZGV4T2YnLCAnc2h1ZmZsZScsCgkgICAgJ2xhc3RJbmRleE9mJywgJ2lzRW1wdHknLCAnY2hhaW4nLCAnc2FtcGxlJ107CgoJICAvLyBNaXggaW4gZWFjaCBVbmRlcnNjb3JlIG1ldGhvZCBhcyBhIHByb3h5IHRvIGBDb2xsZWN0aW9uI21vZGVsc2AuCgkgIF8uZWFjaChtZXRob2RzLCBmdW5jdGlvbihtZXRob2QpIHsKCSAgICBDb2xsZWN0aW9uLnByb3RvdHlwZVttZXRob2RdID0gZnVuY3Rpb24oKSB7CgkgICAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzKTsKCSAgICAgIGFyZ3MudW5zaGlmdCh0aGlzLm1vZGVscyk7CgkgICAgICByZXR1cm4gX1ttZXRob2RdLmFwcGx5KF8sIGFyZ3MpOwoJICAgIH07CgkgIH0pOwoKCSAgLy8gVW5kZXJzY29yZSBtZXRob2RzIHRoYXQgdGFrZSBhIHByb3BlcnR5IG5hbWUgYXMgYW4gYXJndW1lbnQuCgkgIHZhciBhdHRyaWJ1dGVNZXRob2RzID0gWydncm91cEJ5JywgJ2NvdW50QnknLCAnc29ydEJ5JywgJ2luZGV4QnknXTsKCgkgIC8vIFVzZSBhdHRyaWJ1dGVzIGluc3RlYWQgb2YgcHJvcGVydGllcy4KCSAgXy5lYWNoKGF0dHJpYnV0ZU1ldGhvZHMsIGZ1bmN0aW9uKG1ldGhvZCkgewoJICAgIENvbGxlY3Rpb24ucHJvdG90eXBlW21ldGhvZF0gPSBmdW5jdGlvbih2YWx1ZSwgY29udGV4dCkgewoJICAgICAgdmFyIGl0ZXJhdG9yID0gXy5pc0Z1bmN0aW9uKHZhbHVlKSA/IHZhbHVlIDogZnVuY3Rpb24obW9kZWwpIHsKCSAgICAgICAgcmV0dXJuIG1vZGVsLmdldCh2YWx1ZSk7CgkgICAgICB9OwoJICAgICAgcmV0dXJuIF9bbWV0aG9kXSh0aGlzLm1vZGVscywgaXRlcmF0b3IsIGNvbnRleHQpOwoJICAgIH07CgkgIH0pOwoKCSAgLy8gQmFja2JvbmUuVmlldwoJICAvLyAtLS0tLS0tLS0tLS0tCgoJICAvLyBCYWNrYm9uZSBWaWV3cyBhcmUgYWxtb3N0IG1vcmUgY29udmVudGlvbiB0aGFuIHRoZXkgYXJlIGFjdHVhbCBjb2RlLiBBIFZpZXcKCSAgLy8gaXMgc2ltcGx5IGEgSmF2YVNjcmlwdCBvYmplY3QgdGhhdCByZXByZXNlbnRzIGEgbG9naWNhbCBjaHVuayBvZiBVSSBpbiB0aGUKCSAgLy8gRE9NLiBUaGlzIG1pZ2h0IGJlIGEgc2luZ2xlIGl0ZW0sIGFuIGVudGlyZSBsaXN0LCBhIHNpZGViYXIgb3IgcGFuZWwsIG9yCgkgIC8vIGV2ZW4gdGhlIHN1cnJvdW5kaW5nIGZyYW1lIHdoaWNoIHdyYXBzIHlvdXIgd2hvbGUgYXBwLiBEZWZpbmluZyBhIGNodW5rIG9mCgkgIC8vIFVJIGFzIGEgKipWaWV3KiogYWxsb3dzIHlvdSB0byBkZWZpbmUgeW91ciBET00gZXZlbnRzIGRlY2xhcmF0aXZlbHksIHdpdGhvdXQKCSAgLy8gaGF2aW5nIHRvIHdvcnJ5IGFib3V0IHJlbmRlciBvcmRlciAuLi4gYW5kIG1ha2VzIGl0IGVhc3kgZm9yIHRoZSB2aWV3IHRvCgkgIC8vIHJlYWN0IHRvIHNwZWNpZmljIGNoYW5nZXMgaW4gdGhlIHN0YXRlIG9mIHlvdXIgbW9kZWxzLgoKCSAgLy8gQ3JlYXRpbmcgYSBCYWNrYm9uZS5WaWV3IGNyZWF0ZXMgaXRzIGluaXRpYWwgZWxlbWVudCBvdXRzaWRlIG9mIHRoZSBET00sCgkgIC8vIGlmIGFuIGV4aXN0aW5nIGVsZW1lbnQgaXMgbm90IHByb3ZpZGVkLi4uCgkgIHZhciBWaWV3ID0gQmFja2JvbmUuVmlldyA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKCSAgICB0aGlzLmNpZCA9IF8udW5pcXVlSWQoJ3ZpZXcnKTsKCSAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwoJICAgIF8uZXh0ZW5kKHRoaXMsIF8ucGljayhvcHRpb25zLCB2aWV3T3B0aW9ucykpOwoJICAgIHRoaXMuX2Vuc3VyZUVsZW1lbnQoKTsKCSAgICB0aGlzLmluaXRpYWxpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCSAgICB0aGlzLmRlbGVnYXRlRXZlbnRzKCk7CgkgIH07CgoJICAvLyBDYWNoZWQgcmVnZXggdG8gc3BsaXQga2V5cyBmb3IgYGRlbGVnYXRlYC4KCSAgdmFyIGRlbGVnYXRlRXZlbnRTcGxpdHRlciA9IC9eKFxTKylccyooLiopJC87CgoJICAvLyBMaXN0IG9mIHZpZXcgb3B0aW9ucyB0byBiZSBtZXJnZWQgYXMgcHJvcGVydGllcy4KCSAgdmFyIHZpZXdPcHRpb25zID0gWydtb2RlbCcsICdjb2xsZWN0aW9uJywgJ2VsJywgJ2lkJywgJ2F0dHJpYnV0ZXMnLCAnY2xhc3NOYW1lJywgJ3RhZ05hbWUnLCAnZXZlbnRzJ107CgoJICAvLyBTZXQgdXAgYWxsIGluaGVyaXRhYmxlICoqQmFja2JvbmUuVmlldyoqIHByb3BlcnRpZXMgYW5kIG1ldGhvZHMuCgkgIF8uZXh0ZW5kKFZpZXcucHJvdG90eXBlLCBFdmVudHMsIHsKCgkgICAgLy8gVGhlIGRlZmF1bHQgYHRhZ05hbWVgIG9mIGEgVmlldydzIGVsZW1lbnQgaXMgYCJkaXYiYC4KCSAgICB0YWdOYW1lOiAnZGl2JywKCgkgICAgLy8galF1ZXJ5IGRlbGVnYXRlIGZvciBlbGVtZW50IGxvb2t1cCwgc2NvcGVkIHRvIERPTSBlbGVtZW50cyB3aXRoaW4gdGhlCgkgICAgLy8gY3VycmVudCB2aWV3LiBUaGlzIHNob3VsZCBiZSBwcmVmZXJyZWQgdG8gZ2xvYmFsIGxvb2t1cHMgd2hlcmUgcG9zc2libGUuCgkgICAgJDogZnVuY3Rpb24oc2VsZWN0b3IpIHsKCSAgICAgIHJldHVybiB0aGlzLiRlbC5maW5kKHNlbGVjdG9yKTsKCSAgICB9LAoKCSAgICAvLyBJbml0aWFsaXplIGlzIGFuIGVtcHR5IGZ1bmN0aW9uIGJ5IGRlZmF1bHQuIE92ZXJyaWRlIGl0IHdpdGggeW91ciBvd24KCSAgICAvLyBpbml0aWFsaXphdGlvbiBsb2dpYy4KCSAgICBpbml0aWFsaXplOiBmdW5jdGlvbigpe30sCgoJICAgIC8vICoqcmVuZGVyKiogaXMgdGhlIGNvcmUgZnVuY3Rpb24gdGhhdCB5b3VyIHZpZXcgc2hvdWxkIG92ZXJyaWRlLCBpbiBvcmRlcgoJICAgIC8vIHRvIHBvcHVsYXRlIGl0cyBlbGVtZW50IChgdGhpcy5lbGApLCB3aXRoIHRoZSBhcHByb3ByaWF0ZSBIVE1MLiBUaGUKCSAgICAvLyBjb252ZW50aW9uIGlzIGZvciAqKnJlbmRlcioqIHRvIGFsd2F5cyByZXR1cm4gYHRoaXNgLgoJICAgIHJlbmRlcjogZnVuY3Rpb24oKSB7CgkgICAgICByZXR1cm4gdGhpczsKCSAgICB9LAoKCSAgICAvLyBSZW1vdmUgdGhpcyB2aWV3IGJ5IHRha2luZyB0aGUgZWxlbWVudCBvdXQgb2YgdGhlIERPTSwgYW5kIHJlbW92aW5nIGFueQoJICAgIC8vIGFwcGxpY2FibGUgQmFja2JvbmUuRXZlbnRzIGxpc3RlbmVycy4KCSAgICByZW1vdmU6IGZ1bmN0aW9uKCkgewoJICAgICAgdGhpcy4kZWwucmVtb3ZlKCk7CgkgICAgICB0aGlzLnN0b3BMaXN0ZW5pbmcoKTsKCSAgICAgIHJldHVybiB0aGlzOwoJICAgIH0sCgoJICAgIC8vIENoYW5nZSB0aGUgdmlldydzIGVsZW1lbnQgKGB0aGlzLmVsYCBwcm9wZXJ0eSksIGluY2x1ZGluZyBldmVudAoJICAgIC8vIHJlLWRlbGVnYXRpb24uCgkgICAgc2V0RWxlbWVudDogZnVuY3Rpb24oZWxlbWVudCwgZGVsZWdhdGUpIHsKCSAgICAgIGlmICh0aGlzLiRlbCkgdGhpcy51bmRlbGVnYXRlRXZlbnRzKCk7CgkgICAgICB0aGlzLiRlbCA9IGVsZW1lbnQgaW5zdGFuY2VvZiBCYWNrYm9uZS4kID8gZWxlbWVudCA6IEJhY2tib25lLiQoZWxlbWVudCk7CgkgICAgICB0aGlzLmVsID0gdGhpcy4kZWxbMF07CgkgICAgICBpZiAoZGVsZWdhdGUgIT09IGZhbHNlKSB0aGlzLmRlbGVnYXRlRXZlbnRzKCk7CgkgICAgICByZXR1cm4gdGhpczsKCSAgICB9LAoKCSAgICAvLyBTZXQgY2FsbGJhY2tzLCB3aGVyZSBgdGhpcy5ldmVudHNgIGlzIGEgaGFzaCBvZgoJICAgIC8vCgkgICAgLy8gKnsiZXZlbnQgc2VsZWN0b3IiOiAiY2FsbGJhY2sifSoKCSAgICAvLwoJICAgIC8vICAgICB7CgkgICAgLy8gICAgICAgJ21vdXNlZG93biAudGl0bGUnOiAgJ2VkaXQnLAoJICAgIC8vICAgICAgICdjbGljayAuYnV0dG9uJzogICAgICdzYXZlJywKCSAgICAvLyAgICAgICAnY2xpY2sgLm9wZW4nOiAgICAgICBmdW5jdGlvbihlKSB7IC4uLiB9CgkgICAgLy8gICAgIH0KCSAgICAvLwoJICAgIC8vIHBhaXJzLiBDYWxsYmFja3Mgd2lsbCBiZSBib3VuZCB0byB0aGUgdmlldywgd2l0aCBgdGhpc2Agc2V0IHByb3Blcmx5LgoJICAgIC8vIFVzZXMgZXZlbnQgZGVsZWdhdGlvbiBmb3IgZWZmaWNpZW5jeS4KCSAgICAvLyBPbWl0dGluZyB0aGUgc2VsZWN0b3IgYmluZHMgdGhlIGV2ZW50IHRvIGB0aGlzLmVsYC4KCSAgICAvLyBUaGlzIG9ubHkgd29ya3MgZm9yIGRlbGVnYXRlLWFibGUgZXZlbnRzOiBub3QgYGZvY3VzYCwgYGJsdXJgLCBhbmQKCSAgICAvLyBub3QgYGNoYW5nZWAsIGBzdWJtaXRgLCBhbmQgYHJlc2V0YCBpbiBJbnRlcm5ldCBFeHBsb3Jlci4KCSAgICBkZWxlZ2F0ZUV2ZW50czogZnVuY3Rpb24oZXZlbnRzKSB7CgkgICAgICBpZiAoIShldmVudHMgfHwgKGV2ZW50cyA9IF8ucmVzdWx0KHRoaXMsICdldmVudHMnKSkpKSByZXR1cm4gdGhpczsKCSAgICAgIHRoaXMudW5kZWxlZ2F0ZUV2ZW50cygpOwoJICAgICAgZm9yICh2YXIga2V5IGluIGV2ZW50cykgewoJICAgICAgICB2YXIgbWV0aG9kID0gZXZlbnRzW2tleV07CgkgICAgICAgIGlmICghXy5pc0Z1bmN0aW9uKG1ldGhvZCkpIG1ldGhvZCA9IHRoaXNbZXZlbnRzW2tleV1dOwoJICAgICAgICBpZiAoIW1ldGhvZCkgY29udGludWU7CgoJICAgICAgICB2YXIgbWF0Y2ggPSBrZXkubWF0Y2goZGVsZWdhdGVFdmVudFNwbGl0dGVyKTsKCSAgICAgICAgdmFyIGV2ZW50TmFtZSA9IG1hdGNoWzFdLCBzZWxlY3RvciA9IG1hdGNoWzJdOwoJICAgICAgICBtZXRob2QgPSBfLmJpbmQobWV0aG9kLCB0aGlzKTsKCSAgICAgICAgZXZlbnROYW1lICs9ICcuZGVsZWdhdGVFdmVudHMnICsgdGhpcy5jaWQ7CgkgICAgICAgIGlmIChzZWxlY3RvciA9PT0gJycpIHsKCSAgICAgICAgICB0aGlzLiRlbC5vbihldmVudE5hbWUsIG1ldGhvZCk7CgkgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgdGhpcy4kZWwub24oZXZlbnROYW1lLCBzZWxlY3RvciwgbWV0aG9kKTsKCSAgICAgICAgfQoJICAgICAgfQoJICAgICAgcmV0dXJuIHRoaXM7CgkgICAgfSwKCgkgICAgLy8gQ2xlYXJzIGFsbCBjYWxsYmFja3MgcHJldmlvdXNseSBib3VuZCB0byB0aGUgdmlldyB3aXRoIGBkZWxlZ2F0ZUV2ZW50c2AuCgkgICAgLy8gWW91IHVzdWFsbHkgZG9uJ3QgbmVlZCB0byB1c2UgdGhpcywgYnV0IG1heSB3aXNoIHRvIGlmIHlvdSBoYXZlIG11bHRpcGxlCgkgICAgLy8gQmFja2JvbmUgdmlld3MgYXR0YWNoZWQgdG8gdGhlIHNhbWUgRE9NIGVsZW1lbnQuCgkgICAgdW5kZWxlZ2F0ZUV2ZW50czogZnVuY3Rpb24oKSB7CgkgICAgICB0aGlzLiRlbC5vZmYoJy5kZWxlZ2F0ZUV2ZW50cycgKyB0aGlzLmNpZCk7CgkgICAgICByZXR1cm4gdGhpczsKCSAgICB9LAoKCSAgICAvLyBFbnN1cmUgdGhhdCB0aGUgVmlldyBoYXMgYSBET00gZWxlbWVudCB0byByZW5kZXIgaW50by4KCSAgICAvLyBJZiBgdGhpcy5lbGAgaXMgYSBzdHJpbmcsIHBhc3MgaXQgdGhyb3VnaCBgJCgpYCwgdGFrZSB0aGUgZmlyc3QKCSAgICAvLyBtYXRjaGluZyBlbGVtZW50LCBhbmQgcmUtYXNzaWduIGl0IHRvIGBlbGAuIE90aGVyd2lzZSwgY3JlYXRlCgkgICAgLy8gYW4gZWxlbWVudCBmcm9tIHRoZSBgaWRgLCBgY2xhc3NOYW1lYCBhbmQgYHRhZ05hbWVgIHByb3BlcnRpZXMuCgkgICAgX2Vuc3VyZUVsZW1lbnQ6IGZ1bmN0aW9uKCkgewoJICAgICAgaWYgKCF0aGlzLmVsKSB7CgkgICAgICAgIHZhciBhdHRycyA9IF8uZXh0ZW5kKHt9LCBfLnJlc3VsdCh0aGlzLCAnYXR0cmlidXRlcycpKTsKCSAgICAgICAgaWYgKHRoaXMuaWQpIGF0dHJzLmlkID0gXy5yZXN1bHQodGhpcywgJ2lkJyk7CgkgICAgICAgIGlmICh0aGlzLmNsYXNzTmFtZSkgYXR0cnNbJ2NsYXNzJ10gPSBfLnJlc3VsdCh0aGlzLCAnY2xhc3NOYW1lJyk7CgkgICAgICAgIHZhciAkZWwgPSBCYWNrYm9uZS4kKCc8JyArIF8ucmVzdWx0KHRoaXMsICd0YWdOYW1lJykgKyAnPicpLmF0dHIoYXR0cnMpOwoJICAgICAgICB0aGlzLnNldEVsZW1lbnQoJGVsLCBmYWxzZSk7CgkgICAgICB9IGVsc2UgewoJICAgICAgICB0aGlzLnNldEVsZW1lbnQoXy5yZXN1bHQodGhpcywgJ2VsJyksIGZhbHNlKTsKCSAgICAgIH0KCSAgICB9CgoJICB9KTsKCgkgIC8vIEJhY2tib25lLnN5bmMKCSAgLy8gLS0tLS0tLS0tLS0tLQoKCSAgLy8gT3ZlcnJpZGUgdGhpcyBmdW5jdGlvbiB0byBjaGFuZ2UgdGhlIG1hbm5lciBpbiB3aGljaCBCYWNrYm9uZSBwZXJzaXN0cwoJICAvLyBtb2RlbHMgdG8gdGhlIHNlcnZlci4gWW91IHdpbGwgYmUgcGFzc2VkIHRoZSB0eXBlIG9mIHJlcXVlc3QsIGFuZCB0aGUKCSAgLy8gbW9kZWwgaW4gcXVlc3Rpb24uIEJ5IGRlZmF1bHQsIG1ha2VzIGEgUkVTVGZ1bCBBamF4IHJlcXVlc3QKCSAgLy8gdG8gdGhlIG1vZGVsJ3MgYHVybCgpYC4gU29tZSBwb3NzaWJsZSBjdXN0b21pemF0aW9ucyBjb3VsZCBiZToKCSAgLy8KCSAgLy8gKiBVc2UgYHNldFRpbWVvdXRgIHRvIGJhdGNoIHJhcGlkLWZpcmUgdXBkYXRlcyBpbnRvIGEgc2luZ2xlIHJlcXVlc3QuCgkgIC8vICogU2VuZCB1cCB0aGUgbW9kZWxzIGFzIFhNTCBpbnN0ZWFkIG9mIEpTT04uCgkgIC8vICogUGVyc2lzdCBtb2RlbHMgdmlhIFdlYlNvY2tldHMgaW5zdGVhZCBvZiBBamF4LgoJICAvLwoJICAvLyBUdXJuIG9uIGBCYWNrYm9uZS5lbXVsYXRlSFRUUGAgaW4gb3JkZXIgdG8gc2VuZCBgUFVUYCBhbmQgYERFTEVURWAgcmVxdWVzdHMKCSAgLy8gYXMgYFBPU1RgLCB3aXRoIGEgYF9tZXRob2RgIHBhcmFtZXRlciBjb250YWluaW5nIHRoZSB0cnVlIEhUVFAgbWV0aG9kLAoJICAvLyBhcyB3ZWxsIGFzIGFsbCByZXF1ZXN0cyB3aXRoIHRoZSBib2R5IGFzIGBhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWRgCgkgIC8vIGluc3RlYWQgb2YgYGFwcGxpY2F0aW9uL2pzb25gIHdpdGggdGhlIG1vZGVsIGluIGEgcGFyYW0gbmFtZWQgYG1vZGVsYC4KCSAgLy8gVXNlZnVsIHdoZW4gaW50ZXJmYWNpbmcgd2l0aCBzZXJ2ZXItc2lkZSBsYW5ndWFnZXMgbGlrZSAqKlBIUCoqIHRoYXQgbWFrZQoJICAvLyBpdCBkaWZmaWN1bHQgdG8gcmVhZCB0aGUgYm9keSBvZiBgUFVUYCByZXF1ZXN0cy4KCSAgQmFja2JvbmUuc3luYyA9IGZ1bmN0aW9uKG1ldGhvZCwgbW9kZWwsIG9wdGlvbnMpIHsKCSAgICB2YXIgdHlwZSA9IG1ldGhvZE1hcFttZXRob2RdOwoKCSAgICAvLyBEZWZhdWx0IG9wdGlvbnMsIHVubGVzcyBzcGVjaWZpZWQuCgkgICAgXy5kZWZhdWx0cyhvcHRpb25zIHx8IChvcHRpb25zID0ge30pLCB7CgkgICAgICBlbXVsYXRlSFRUUDogQmFja2JvbmUuZW11bGF0ZUhUVFAsCgkgICAgICBlbXVsYXRlSlNPTjogQmFja2JvbmUuZW11bGF0ZUpTT04KCSAgICB9KTsKCgkgICAgLy8gRGVmYXVsdCBKU09OLXJlcXVlc3Qgb3B0aW9ucy4KCSAgICB2YXIgcGFyYW1zID0ge3R5cGU6IHR5cGUsIGRhdGFUeXBlOiAnanNvbid9OwoKCSAgICAvLyBFbnN1cmUgdGhhdCB3ZSBoYXZlIGEgVVJMLgoJICAgIGlmICghb3B0aW9ucy51cmwpIHsKCSAgICAgIHBhcmFtcy51cmwgPSBfLnJlc3VsdChtb2RlbCwgJ3VybCcpIHx8IHVybEVycm9yKCk7CgkgICAgfQoKCSAgICAvLyBFbnN1cmUgdGhhdCB3ZSBoYXZlIHRoZSBhcHByb3ByaWF0ZSByZXF1ZXN0IGRhdGEuCgkgICAgaWYgKG9wdGlvbnMuZGF0YSA9PSBudWxsICYmIG1vZGVsICYmIChtZXRob2QgPT09ICdjcmVhdGUnIHx8IG1ldGhvZCA9PT0gJ3VwZGF0ZScgfHwgbWV0aG9kID09PSAncGF0Y2gnKSkgewoJICAgICAgcGFyYW1zLmNvbnRlbnRUeXBlID0gJ2FwcGxpY2F0aW9uL2pzb24nOwoJICAgICAgcGFyYW1zLmRhdGEgPSBKU09OLnN0cmluZ2lmeShvcHRpb25zLmF0dHJzIHx8IG1vZGVsLnRvSlNPTihvcHRpb25zKSk7CgkgICAgfQoKCSAgICAvLyBGb3Igb2xkZXIgc2VydmVycywgZW11bGF0ZSBKU09OIGJ5IGVuY29kaW5nIHRoZSByZXF1ZXN0IGludG8gYW4gSFRNTC1mb3JtLgoJICAgIGlmIChvcHRpb25zLmVtdWxhdGVKU09OKSB7CgkgICAgICBwYXJhbXMuY29udGVudFR5cGUgPSAnYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkJzsKCSAgICAgIHBhcmFtcy5kYXRhID0gcGFyYW1zLmRhdGEgPyB7bW9kZWw6IHBhcmFtcy5kYXRhfSA6IHt9OwoJICAgIH0KCgkgICAgLy8gRm9yIG9sZGVyIHNlcnZlcnMsIGVtdWxhdGUgSFRUUCBieSBtaW1pY2tpbmcgdGhlIEhUVFAgbWV0aG9kIHdpdGggYF9tZXRob2RgCgkgICAgLy8gQW5kIGFuIGBYLUhUVFAtTWV0aG9kLU92ZXJyaWRlYCBoZWFkZXIuCgkgICAgaWYgKG9wdGlvbnMuZW11bGF0ZUhUVFAgJiYgKHR5cGUgPT09ICdQVVQnIHx8IHR5cGUgPT09ICdERUxFVEUnIHx8IHR5cGUgPT09ICdQQVRDSCcpKSB7CgkgICAgICBwYXJhbXMudHlwZSA9ICdQT1NUJzsKCSAgICAgIGlmIChvcHRpb25zLmVtdWxhdGVKU09OKSBwYXJhbXMuZGF0YS5fbWV0aG9kID0gdHlwZTsKCSAgICAgIHZhciBiZWZvcmVTZW5kID0gb3B0aW9ucy5iZWZvcmVTZW5kOwoJICAgICAgb3B0aW9ucy5iZWZvcmVTZW5kID0gZnVuY3Rpb24oeGhyKSB7CgkgICAgICAgIHhoci5zZXRSZXF1ZXN0SGVhZGVyKCdYLUhUVFAtTWV0aG9kLU92ZXJyaWRlJywgdHlwZSk7CgkgICAgICAgIGlmIChiZWZvcmVTZW5kKSByZXR1cm4gYmVmb3JlU2VuZC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoJICAgICAgfTsKCSAgICB9CgoJICAgIC8vIERvbid0IHByb2Nlc3MgZGF0YSBvbiBhIG5vbi1HRVQgcmVxdWVzdC4KCSAgICBpZiAocGFyYW1zLnR5cGUgIT09ICdHRVQnICYmICFvcHRpb25zLmVtdWxhdGVKU09OKSB7CgkgICAgICBwYXJhbXMucHJvY2Vzc0RhdGEgPSBmYWxzZTsKCSAgICB9CgoJICAgIC8vIElmIHdlJ3JlIHNlbmRpbmcgYSBgUEFUQ0hgIHJlcXVlc3QsIGFuZCB3ZSdyZSBpbiBhbiBvbGQgSW50ZXJuZXQgRXhwbG9yZXIKCSAgICAvLyB0aGF0IHN0aWxsIGhhcyBBY3RpdmVYIGVuYWJsZWQgYnkgZGVmYXVsdCwgb3ZlcnJpZGUgalF1ZXJ5IHRvIHVzZSB0aGF0CgkgICAgLy8gZm9yIFhIUiBpbnN0ZWFkLiBSZW1vdmUgdGhpcyBsaW5lIHdoZW4galF1ZXJ5IHN1cHBvcnRzIGBQQVRDSGAgb24gSUU4LgoJICAgIGlmIChwYXJhbXMudHlwZSA9PT0gJ1BBVENIJyAmJiBub1hoclBhdGNoKSB7CgkgICAgICBwYXJhbXMueGhyID0gZnVuY3Rpb24oKSB7CgkgICAgICAgIHJldHVybiBuZXcgQWN0aXZlWE9iamVjdCgiTWljcm9zb2Z0LlhNTEhUVFAiKTsKCSAgICAgIH07CgkgICAgfQoKCSAgICAvLyBNYWtlIHRoZSByZXF1ZXN0LCBhbGxvd2luZyB0aGUgdXNlciB0byBvdmVycmlkZSBhbnkgQWpheCBvcHRpb25zLgoJICAgIHZhciB4aHIgPSBvcHRpb25zLnhociA9IEJhY2tib25lLmFqYXgoXy5leHRlbmQocGFyYW1zLCBvcHRpb25zKSk7CgkgICAgbW9kZWwudHJpZ2dlcigncmVxdWVzdCcsIG1vZGVsLCB4aHIsIG9wdGlvbnMpOwoJICAgIHJldHVybiB4aHI7CgkgIH07CgoJICB2YXIgbm9YaHJQYXRjaCA9CgkgICAgdHlwZW9mIHdpbmRvdyAhPT0gJ3VuZGVmaW5lZCcgJiYgISF3aW5kb3cuQWN0aXZlWE9iamVjdCAmJgoJICAgICAgISh3aW5kb3cuWE1MSHR0cFJlcXVlc3QgJiYgKG5ldyBYTUxIdHRwUmVxdWVzdCkuZGlzcGF0Y2hFdmVudCk7CgoJICAvLyBNYXAgZnJvbSBDUlVEIHRvIEhUVFAgZm9yIG91ciBkZWZhdWx0IGBCYWNrYm9uZS5zeW5jYCBpbXBsZW1lbnRhdGlvbi4KCSAgdmFyIG1ldGhvZE1hcCA9IHsKCSAgICAnY3JlYXRlJzogJ1BPU1QnLAoJICAgICd1cGRhdGUnOiAnUFVUJywKCSAgICAncGF0Y2gnOiAgJ1BBVENIJywKCSAgICAnZGVsZXRlJzogJ0RFTEVURScsCgkgICAgJ3JlYWQnOiAgICdHRVQnCgkgIH07CgoJICAvLyBTZXQgdGhlIGRlZmF1bHQgaW1wbGVtZW50YXRpb24gb2YgYEJhY2tib25lLmFqYXhgIHRvIHByb3h5IHRocm91Z2ggdG8gYCRgLgoJICAvLyBPdmVycmlkZSB0aGlzIGlmIHlvdSdkIGxpa2UgdG8gdXNlIGEgZGlmZmVyZW50IGxpYnJhcnkuCgkgIEJhY2tib25lLmFqYXggPSBmdW5jdGlvbigpIHsKCSAgICByZXR1cm4gQmFja2JvbmUuJC5hamF4LmFwcGx5KEJhY2tib25lLiQsIGFyZ3VtZW50cyk7CgkgIH07CgoJICAvLyBCYWNrYm9uZS5Sb3V0ZXIKCSAgLy8gLS0tLS0tLS0tLS0tLS0tCgoJICAvLyBSb3V0ZXJzIG1hcCBmYXV4LVVSTHMgdG8gYWN0aW9ucywgYW5kIGZpcmUgZXZlbnRzIHdoZW4gcm91dGVzIGFyZQoJICAvLyBtYXRjaGVkLiBDcmVhdGluZyBhIG5ldyBvbmUgc2V0cyBpdHMgYHJvdXRlc2AgaGFzaCwgaWYgbm90IHNldCBzdGF0aWNhbGx5LgoJICB2YXIgUm91dGVyID0gQmFja2JvbmUuUm91dGVyID0gZnVuY3Rpb24ob3B0aW9ucykgewoJICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CgkgICAgaWYgKG9wdGlvbnMucm91dGVzKSB0aGlzLnJvdXRlcyA9IG9wdGlvbnMucm91dGVzOwoJICAgIHRoaXMuX2JpbmRSb3V0ZXMoKTsKCSAgICB0aGlzLmluaXRpYWxpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCSAgfTsKCgkgIC8vIENhY2hlZCByZWd1bGFyIGV4cHJlc3Npb25zIGZvciBtYXRjaGluZyBuYW1lZCBwYXJhbSBwYXJ0cyBhbmQgc3BsYXR0ZWQKCSAgLy8gcGFydHMgb2Ygcm91dGUgc3RyaW5ncy4KCSAgdmFyIG9wdGlvbmFsUGFyYW0gPSAvXCgoLio/KVwpL2c7CgkgIHZhciBuYW1lZFBhcmFtICAgID0gLyhcKFw/KT86XHcrL2c7CgkgIHZhciBzcGxhdFBhcmFtICAgID0gL1wqXHcrL2c7CgkgIHZhciBlc2NhcGVSZWdFeHAgID0gL1tcLXt9XFtcXSs/LixcXFxeJHwjXHNdL2c7CgoJICAvLyBTZXQgdXAgYWxsIGluaGVyaXRhYmxlICoqQmFja2JvbmUuUm91dGVyKiogcHJvcGVydGllcyBhbmQgbWV0aG9kcy4KCSAgXy5leHRlbmQoUm91dGVyLnByb3RvdHlwZSwgRXZlbnRzLCB7CgoJICAgIC8vIEluaXRpYWxpemUgaXMgYW4gZW1wdHkgZnVuY3Rpb24gYnkgZGVmYXVsdC4gT3ZlcnJpZGUgaXQgd2l0aCB5b3VyIG93bgoJICAgIC8vIGluaXRpYWxpemF0aW9uIGxvZ2ljLgoJICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uKCl7fSwKCgkgICAgLy8gTWFudWFsbHkgYmluZCBhIHNpbmdsZSBuYW1lZCByb3V0ZSB0byBhIGNhbGxiYWNrLiBGb3IgZXhhbXBsZToKCSAgICAvLwoJICAgIC8vICAgICB0aGlzLnJvdXRlKCdzZWFyY2gvOnF1ZXJ5L3A6bnVtJywgJ3NlYXJjaCcsIGZ1bmN0aW9uKHF1ZXJ5LCBudW0pIHsKCSAgICAvLyAgICAgICAuLi4KCSAgICAvLyAgICAgfSk7CgkgICAgLy8KCSAgICByb3V0ZTogZnVuY3Rpb24ocm91dGUsIG5hbWUsIGNhbGxiYWNrKSB7CgkgICAgICBpZiAoIV8uaXNSZWdFeHAocm91dGUpKSByb3V0ZSA9IHRoaXMuX3JvdXRlVG9SZWdFeHAocm91dGUpOwoJICAgICAgaWYgKF8uaXNGdW5jdGlvbihuYW1lKSkgewoJICAgICAgICBjYWxsYmFjayA9IG5hbWU7CgkgICAgICAgIG5hbWUgPSAnJzsKCSAgICAgIH0KCSAgICAgIGlmICghY2FsbGJhY2spIGNhbGxiYWNrID0gdGhpc1tuYW1lXTsKCSAgICAgIHZhciByb3V0ZXIgPSB0aGlzOwoJICAgICAgQmFja2JvbmUuaGlzdG9yeS5yb3V0ZShyb3V0ZSwgZnVuY3Rpb24oZnJhZ21lbnQpIHsKCSAgICAgICAgdmFyIGFyZ3MgPSByb3V0ZXIuX2V4dHJhY3RQYXJhbWV0ZXJzKHJvdXRlLCBmcmFnbWVudCk7CgkgICAgICAgIHJvdXRlci5leGVjdXRlKGNhbGxiYWNrLCBhcmdzKTsKCSAgICAgICAgcm91dGVyLnRyaWdnZXIuYXBwbHkocm91dGVyLCBbJ3JvdXRlOicgKyBuYW1lXS5jb25jYXQoYXJncykpOwoJICAgICAgICByb3V0ZXIudHJpZ2dlcigncm91dGUnLCBuYW1lLCBhcmdzKTsKCSAgICAgICAgQmFja2JvbmUuaGlzdG9yeS50cmlnZ2VyKCdyb3V0ZScsIHJvdXRlciwgbmFtZSwgYXJncyk7CgkgICAgICB9KTsKCSAgICAgIHJldHVybiB0aGlzOwoJICAgIH0sCgoJICAgIC8vIEV4ZWN1dGUgYSByb3V0ZSBoYW5kbGVyIHdpdGggdGhlIHByb3ZpZGVkIHBhcmFtZXRlcnMuICBUaGlzIGlzIGFuCgkgICAgLy8gZXhjZWxsZW50IHBsYWNlIHRvIGRvIHByZS1yb3V0ZSBzZXR1cCBvciBwb3N0LXJvdXRlIGNsZWFudXAuCgkgICAgZXhlY3V0ZTogZnVuY3Rpb24oY2FsbGJhY2ssIGFyZ3MpIHsKCSAgICAgIGlmIChjYWxsYmFjaykgY2FsbGJhY2suYXBwbHkodGhpcywgYXJncyk7CgkgICAgfSwKCgkgICAgLy8gU2ltcGxlIHByb3h5IHRvIGBCYWNrYm9uZS5oaXN0b3J5YCB0byBzYXZlIGEgZnJhZ21lbnQgaW50byB0aGUgaGlzdG9yeS4KCSAgICBuYXZpZ2F0ZTogZnVuY3Rpb24oZnJhZ21lbnQsIG9wdGlvbnMpIHsKCSAgICAgIEJhY2tib25lLmhpc3RvcnkubmF2aWdhdGUoZnJhZ21lbnQsIG9wdGlvbnMpOwoJICAgICAgcmV0dXJuIHRoaXM7CgkgICAgfSwKCgkgICAgLy8gQmluZCBhbGwgZGVmaW5lZCByb3V0ZXMgdG8gYEJhY2tib25lLmhpc3RvcnlgLiBXZSBoYXZlIHRvIHJldmVyc2UgdGhlCgkgICAgLy8gb3JkZXIgb2YgdGhlIHJvdXRlcyBoZXJlIHRvIHN1cHBvcnQgYmVoYXZpb3Igd2hlcmUgdGhlIG1vc3QgZ2VuZXJhbAoJICAgIC8vIHJvdXRlcyBjYW4gYmUgZGVmaW5lZCBhdCB0aGUgYm90dG9tIG9mIHRoZSByb3V0ZSBtYXAuCgkgICAgX2JpbmRSb3V0ZXM6IGZ1bmN0aW9uKCkgewoJICAgICAgaWYgKCF0aGlzLnJvdXRlcykgcmV0dXJuOwoJICAgICAgdGhpcy5yb3V0ZXMgPSBfLnJlc3VsdCh0aGlzLCAncm91dGVzJyk7CgkgICAgICB2YXIgcm91dGUsIHJvdXRlcyA9IF8ua2V5cyh0aGlzLnJvdXRlcyk7CgkgICAgICB3aGlsZSAoKHJvdXRlID0gcm91dGVzLnBvcCgpKSAhPSBudWxsKSB7CgkgICAgICAgIHRoaXMucm91dGUocm91dGUsIHRoaXMucm91dGVzW3JvdXRlXSk7CgkgICAgICB9CgkgICAgfSwKCgkgICAgLy8gQ29udmVydCBhIHJvdXRlIHN0cmluZyBpbnRvIGEgcmVndWxhciBleHByZXNzaW9uLCBzdWl0YWJsZSBmb3IgbWF0Y2hpbmcKCSAgICAvLyBhZ2FpbnN0IHRoZSBjdXJyZW50IGxvY2F0aW9uIGhhc2guCgkgICAgX3JvdXRlVG9SZWdFeHA6IGZ1bmN0aW9uKHJvdXRlKSB7CgkgICAgICByb3V0ZSA9IHJvdXRlLnJlcGxhY2UoZXNjYXBlUmVnRXhwLCAnXFwkJicpCgkgICAgICAgICAgICAgICAgICAgLnJlcGxhY2Uob3B0aW9uYWxQYXJhbSwgJyg/OiQxKT8nKQoJICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKG5hbWVkUGFyYW0sIGZ1bmN0aW9uKG1hdGNoLCBvcHRpb25hbCkgewoJICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG9wdGlvbmFsID8gbWF0Y2ggOiAnKFteLz9dKyknOwoJICAgICAgICAgICAgICAgICAgIH0pCgkgICAgICAgICAgICAgICAgICAgLnJlcGxhY2Uoc3BsYXRQYXJhbSwgJyhbXj9dKj8pJyk7CgkgICAgICByZXR1cm4gbmV3IFJlZ0V4cCgnXicgKyByb3V0ZSArICcoPzpcXD8oW1xcc1xcU10qKSk/JCcpOwoJICAgIH0sCgoJICAgIC8vIEdpdmVuIGEgcm91dGUsIGFuZCBhIFVSTCBmcmFnbWVudCB0aGF0IGl0IG1hdGNoZXMsIHJldHVybiB0aGUgYXJyYXkgb2YKCSAgICAvLyBleHRyYWN0ZWQgZGVjb2RlZCBwYXJhbWV0ZXJzLiBFbXB0eSBvciB1bm1hdGNoZWQgcGFyYW1ldGVycyB3aWxsIGJlCgkgICAgLy8gdHJlYXRlZCBhcyBgbnVsbGAgdG8gbm9ybWFsaXplIGNyb3NzLWJyb3dzZXIgYmVoYXZpb3IuCgkgICAgX2V4dHJhY3RQYXJhbWV0ZXJzOiBmdW5jdGlvbihyb3V0ZSwgZnJhZ21lbnQpIHsKCSAgICAgIHZhciBwYXJhbXMgPSByb3V0ZS5leGVjKGZyYWdtZW50KS5zbGljZSgxKTsKCSAgICAgIHJldHVybiBfLm1hcChwYXJhbXMsIGZ1bmN0aW9uKHBhcmFtLCBpKSB7CgkgICAgICAgIC8vIERvbid0IGRlY29kZSB0aGUgc2VhcmNoIHBhcmFtcy4KCSAgICAgICAgaWYgKGkgPT09IHBhcmFtcy5sZW5ndGggLSAxKSByZXR1cm4gcGFyYW0gfHwgbnVsbDsKCSAgICAgICAgcmV0dXJuIHBhcmFtID8gZGVjb2RlVVJJQ29tcG9uZW50KHBhcmFtKSA6IG51bGw7CgkgICAgICB9KTsKCSAgICB9CgoJICB9KTsKCgkgIC8vIEJhY2tib25lLkhpc3RvcnkKCSAgLy8gLS0tLS0tLS0tLS0tLS0tLQoKCSAgLy8gSGFuZGxlcyBjcm9zcy1icm93c2VyIGhpc3RvcnkgbWFuYWdlbWVudCwgYmFzZWQgb24gZWl0aGVyCgkgIC8vIFtwdXNoU3RhdGVdKGh0dHA6Ly9kaXZlaW50b2h0bWw1LmluZm8vaGlzdG9yeS5odG1sKSBhbmQgcmVhbCBVUkxzLCBvcgoJICAvLyBbb25oYXNoY2hhbmdlXShodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL0RPTS93aW5kb3cub25oYXNoY2hhbmdlKQoJICAvLyBhbmQgVVJMIGZyYWdtZW50cy4gSWYgdGhlIGJyb3dzZXIgc3VwcG9ydHMgbmVpdGhlciAob2xkIElFLCBuYXRjaCksCgkgIC8vIGZhbGxzIGJhY2sgdG8gcG9sbGluZy4KCSAgdmFyIEhpc3RvcnkgPSBCYWNrYm9uZS5IaXN0b3J5ID0gZnVuY3Rpb24oKSB7CgkgICAgdGhpcy5oYW5kbGVycyA9IFtdOwoJICAgIF8uYmluZEFsbCh0aGlzLCAnY2hlY2tVcmwnKTsKCgkgICAgLy8gRW5zdXJlIHRoYXQgYEhpc3RvcnlgIGNhbiBiZSB1c2VkIG91dHNpZGUgb2YgdGhlIGJyb3dzZXIuCgkgICAgaWYgKHR5cGVvZiB3aW5kb3cgIT09ICd1bmRlZmluZWQnKSB7CgkgICAgICB0aGlzLmxvY2F0aW9uID0gd2luZG93LmxvY2F0aW9uOwoJICAgICAgdGhpcy5oaXN0b3J5ID0gd2luZG93Lmhpc3Rvcnk7CgkgICAgfQoJICB9OwoKCSAgLy8gQ2FjaGVkIHJlZ2V4IGZvciBzdHJpcHBpbmcgYSBsZWFkaW5nIGhhc2gvc2xhc2ggYW5kIHRyYWlsaW5nIHNwYWNlLgoJICB2YXIgcm91dGVTdHJpcHBlciA9IC9eWyNcL118XHMrJC9nOwoKCSAgLy8gQ2FjaGVkIHJlZ2V4IGZvciBzdHJpcHBpbmcgbGVhZGluZyBhbmQgdHJhaWxpbmcgc2xhc2hlcy4KCSAgdmFyIHJvb3RTdHJpcHBlciA9IC9eXC8rfFwvKyQvZzsKCgkgIC8vIENhY2hlZCByZWdleCBmb3IgZGV0ZWN0aW5nIE1TSUUuCgkgIHZhciBpc0V4cGxvcmVyID0gL21zaWUgW1x3Ll0rLzsKCgkgIC8vIENhY2hlZCByZWdleCBmb3IgcmVtb3ZpbmcgYSB0cmFpbGluZyBzbGFzaC4KCSAgdmFyIHRyYWlsaW5nU2xhc2ggPSAvXC8kLzsKCgkgIC8vIENhY2hlZCByZWdleCBmb3Igc3RyaXBwaW5nIHVybHMgb2YgaGFzaC4KCSAgdmFyIHBhdGhTdHJpcHBlciA9IC8jLiokLzsKCgkgIC8vIEhhcyB0aGUgaGlzdG9yeSBoYW5kbGluZyBhbHJlYWR5IGJlZW4gc3RhcnRlZD8KCSAgSGlzdG9yeS5zdGFydGVkID0gZmFsc2U7CgoJICAvLyBTZXQgdXAgYWxsIGluaGVyaXRhYmxlICoqQmFja2JvbmUuSGlzdG9yeSoqIHByb3BlcnRpZXMgYW5kIG1ldGhvZHMuCgkgIF8uZXh0ZW5kKEhpc3RvcnkucHJvdG90eXBlLCBFdmVudHMsIHsKCgkgICAgLy8gVGhlIGRlZmF1bHQgaW50ZXJ2YWwgdG8gcG9sbCBmb3IgaGFzaCBjaGFuZ2VzLCBpZiBuZWNlc3NhcnksIGlzCgkgICAgLy8gdHdlbnR5IHRpbWVzIGEgc2Vjb25kLgoJICAgIGludGVydmFsOiA1MCwKCgkgICAgLy8gQXJlIHdlIGF0IHRoZSBhcHAgcm9vdD8KCSAgICBhdFJvb3Q6IGZ1bmN0aW9uKCkgewoJICAgICAgcmV0dXJuIHRoaXMubG9jYXRpb24ucGF0aG5hbWUucmVwbGFjZSgvW15cL10kLywgJyQmLycpID09PSB0aGlzLnJvb3Q7CgkgICAgfSwKCgkgICAgLy8gR2V0cyB0aGUgdHJ1ZSBoYXNoIHZhbHVlLiBDYW5ub3QgdXNlIGxvY2F0aW9uLmhhc2ggZGlyZWN0bHkgZHVlIHRvIGJ1ZwoJICAgIC8vIGluIEZpcmVmb3ggd2hlcmUgbG9jYXRpb24uaGFzaCB3aWxsIGFsd2F5cyBiZSBkZWNvZGVkLgoJICAgIGdldEhhc2g6IGZ1bmN0aW9uKHdpbmRvdykgewoJICAgICAgdmFyIG1hdGNoID0gKHdpbmRvdyB8fCB0aGlzKS5sb2NhdGlvbi5ocmVmLm1hdGNoKC8jKC4qKSQvKTsKCSAgICAgIHJldHVybiBtYXRjaCA/IG1hdGNoWzFdIDogJyc7CgkgICAgfSwKCgkgICAgLy8gR2V0IHRoZSBjcm9zcy1icm93c2VyIG5vcm1hbGl6ZWQgVVJMIGZyYWdtZW50LCBlaXRoZXIgZnJvbSB0aGUgVVJMLAoJICAgIC8vIHRoZSBoYXNoLCBvciB0aGUgb3ZlcnJpZGUuCgkgICAgZ2V0RnJhZ21lbnQ6IGZ1bmN0aW9uKGZyYWdtZW50LCBmb3JjZVB1c2hTdGF0ZSkgewoJICAgICAgaWYgKGZyYWdtZW50ID09IG51bGwpIHsKCSAgICAgICAgaWYgKHRoaXMuX2hhc1B1c2hTdGF0ZSB8fCAhdGhpcy5fd2FudHNIYXNoQ2hhbmdlIHx8IGZvcmNlUHVzaFN0YXRlKSB7CgkgICAgICAgICAgZnJhZ21lbnQgPSBkZWNvZGVVUkkodGhpcy5sb2NhdGlvbi5wYXRobmFtZSArIHRoaXMubG9jYXRpb24uc2VhcmNoKTsKCSAgICAgICAgICB2YXIgcm9vdCA9IHRoaXMucm9vdC5yZXBsYWNlKHRyYWlsaW5nU2xhc2gsICcnKTsKCSAgICAgICAgICBpZiAoIWZyYWdtZW50LmluZGV4T2Yocm9vdCkpIGZyYWdtZW50ID0gZnJhZ21lbnQuc2xpY2Uocm9vdC5sZW5ndGgpOwoJICAgICAgICB9IGVsc2UgewoJICAgICAgICAgIGZyYWdtZW50ID0gdGhpcy5nZXRIYXNoKCk7CgkgICAgICAgIH0KCSAgICAgIH0KCSAgICAgIHJldHVybiBmcmFnbWVudC5yZXBsYWNlKHJvdXRlU3RyaXBwZXIsICcnKTsKCSAgICB9LAoKCSAgICAvLyBTdGFydCB0aGUgaGFzaCBjaGFuZ2UgaGFuZGxpbmcsIHJldHVybmluZyBgdHJ1ZWAgaWYgdGhlIGN1cnJlbnQgVVJMIG1hdGNoZXMKCSAgICAvLyBhbiBleGlzdGluZyByb3V0ZSwgYW5kIGBmYWxzZWAgb3RoZXJ3aXNlLgoJICAgIHN0YXJ0OiBmdW5jdGlvbihvcHRpb25zKSB7CgkgICAgICBpZiAoSGlzdG9yeS5zdGFydGVkKSB0aHJvdyBuZXcgRXJyb3IoIkJhY2tib25lLmhpc3RvcnkgaGFzIGFscmVhZHkgYmVlbiBzdGFydGVkIik7CgkgICAgICBIaXN0b3J5LnN0YXJ0ZWQgPSB0cnVlOwoKCSAgICAgIC8vIEZpZ3VyZSBvdXQgdGhlIGluaXRpYWwgY29uZmlndXJhdGlvbi4gRG8gd2UgbmVlZCBhbiBpZnJhbWU/CgkgICAgICAvLyBJcyBwdXNoU3RhdGUgZGVzaXJlZCAuLi4gaXMgaXQgYXZhaWxhYmxlPwoJICAgICAgdGhpcy5vcHRpb25zICAgICAgICAgID0gXy5leHRlbmQoe3Jvb3Q6ICcvJ30sIHRoaXMub3B0aW9ucywgb3B0aW9ucyk7CgkgICAgICB0aGlzLnJvb3QgICAgICAgICAgICAgPSB0aGlzLm9wdGlvbnMucm9vdDsKCSAgICAgIHRoaXMuX3dhbnRzSGFzaENoYW5nZSA9IHRoaXMub3B0aW9ucy5oYXNoQ2hhbmdlICE9PSBmYWxzZTsKCSAgICAgIHRoaXMuX3dhbnRzUHVzaFN0YXRlICA9ICEhdGhpcy5vcHRpb25zLnB1c2hTdGF0ZTsKCSAgICAgIHRoaXMuX2hhc1B1c2hTdGF0ZSAgICA9ICEhKHRoaXMub3B0aW9ucy5wdXNoU3RhdGUgJiYgdGhpcy5oaXN0b3J5ICYmIHRoaXMuaGlzdG9yeS5wdXNoU3RhdGUpOwoJICAgICAgdmFyIGZyYWdtZW50ICAgICAgICAgID0gdGhpcy5nZXRGcmFnbWVudCgpOwoJICAgICAgdmFyIGRvY01vZGUgICAgICAgICAgID0gZG9jdW1lbnQuZG9jdW1lbnRNb2RlOwoJICAgICAgdmFyIG9sZElFICAgICAgICAgICAgID0gKGlzRXhwbG9yZXIuZXhlYyhuYXZpZ2F0b3IudXNlckFnZW50LnRvTG93ZXJDYXNlKCkpICYmICghZG9jTW9kZSB8fCBkb2NNb2RlIDw9IDcpKTsKCgkgICAgICAvLyBOb3JtYWxpemUgcm9vdCB0byBhbHdheXMgaW5jbHVkZSBhIGxlYWRpbmcgYW5kIHRyYWlsaW5nIHNsYXNoLgoJICAgICAgdGhpcy5yb290ID0gKCcvJyArIHRoaXMucm9vdCArICcvJykucmVwbGFjZShyb290U3RyaXBwZXIsICcvJyk7CgoJICAgICAgaWYgKG9sZElFICYmIHRoaXMuX3dhbnRzSGFzaENoYW5nZSkgewoJICAgICAgICB2YXIgZnJhbWUgPSBCYWNrYm9uZS4kKCc8aWZyYW1lIHNyYz0iamF2YXNjcmlwdDowIiB0YWJpbmRleD0iLTEiPicpOwoJICAgICAgICB0aGlzLmlmcmFtZSA9IGZyYW1lLmhpZGUoKS5hcHBlbmRUbygnYm9keScpWzBdLmNvbnRlbnRXaW5kb3c7CgkgICAgICAgIHRoaXMubmF2aWdhdGUoZnJhZ21lbnQpOwoJICAgICAgfQoKCSAgICAgIC8vIERlcGVuZGluZyBvbiB3aGV0aGVyIHdlJ3JlIHVzaW5nIHB1c2hTdGF0ZSBvciBoYXNoZXMsIGFuZCB3aGV0aGVyCgkgICAgICAvLyAnb25oYXNoY2hhbmdlJyBpcyBzdXBwb3J0ZWQsIGRldGVybWluZSBob3cgd2UgY2hlY2sgdGhlIFVSTCBzdGF0ZS4KCSAgICAgIGlmICh0aGlzLl9oYXNQdXNoU3RhdGUpIHsKCSAgICAgICAgQmFja2JvbmUuJCh3aW5kb3cpLm9uKCdwb3BzdGF0ZScsIHRoaXMuY2hlY2tVcmwpOwoJICAgICAgfSBlbHNlIGlmICh0aGlzLl93YW50c0hhc2hDaGFuZ2UgJiYgKCdvbmhhc2hjaGFuZ2UnIGluIHdpbmRvdykgJiYgIW9sZElFKSB7CgkgICAgICAgIEJhY2tib25lLiQod2luZG93KS5vbignaGFzaGNoYW5nZScsIHRoaXMuY2hlY2tVcmwpOwoJICAgICAgfSBlbHNlIGlmICh0aGlzLl93YW50c0hhc2hDaGFuZ2UpIHsKCSAgICAgICAgdGhpcy5fY2hlY2tVcmxJbnRlcnZhbCA9IHNldEludGVydmFsKHRoaXMuY2hlY2tVcmwsIHRoaXMuaW50ZXJ2YWwpOwoJICAgICAgfQoKCSAgICAgIC8vIERldGVybWluZSBpZiB3ZSBuZWVkIHRvIGNoYW5nZSB0aGUgYmFzZSB1cmwsIGZvciBhIHB1c2hTdGF0ZSBsaW5rCgkgICAgICAvLyBvcGVuZWQgYnkgYSBub24tcHVzaFN0YXRlIGJyb3dzZXIuCgkgICAgICB0aGlzLmZyYWdtZW50ID0gZnJhZ21lbnQ7CgkgICAgICB2YXIgbG9jID0gdGhpcy5sb2NhdGlvbjsKCgkgICAgICAvLyBUcmFuc2l0aW9uIGZyb20gaGFzaENoYW5nZSB0byBwdXNoU3RhdGUgb3IgdmljZSB2ZXJzYSBpZiBib3RoIGFyZQoJICAgICAgLy8gcmVxdWVzdGVkLgoJICAgICAgaWYgKHRoaXMuX3dhbnRzSGFzaENoYW5nZSAmJiB0aGlzLl93YW50c1B1c2hTdGF0ZSkgewoKCSAgICAgICAgLy8gSWYgd2UndmUgc3RhcnRlZCBvZmYgd2l0aCBhIHJvdXRlIGZyb20gYSBgcHVzaFN0YXRlYC1lbmFibGVkCgkgICAgICAgIC8vIGJyb3dzZXIsIGJ1dCB3ZSdyZSBjdXJyZW50bHkgaW4gYSBicm93c2VyIHRoYXQgZG9lc24ndCBzdXBwb3J0IGl0Li4uCgkgICAgICAgIGlmICghdGhpcy5faGFzUHVzaFN0YXRlICYmICF0aGlzLmF0Um9vdCgpKSB7CgkgICAgICAgICAgdGhpcy5mcmFnbWVudCA9IHRoaXMuZ2V0RnJhZ21lbnQobnVsbCwgdHJ1ZSk7CgkgICAgICAgICAgdGhpcy5sb2NhdGlvbi5yZXBsYWNlKHRoaXMucm9vdCArICcjJyArIHRoaXMuZnJhZ21lbnQpOwoJICAgICAgICAgIC8vIFJldHVybiBpbW1lZGlhdGVseSBhcyBicm93c2VyIHdpbGwgZG8gcmVkaXJlY3QgdG8gbmV3IHVybAoJICAgICAgICAgIHJldHVybiB0cnVlOwoKCSAgICAgICAgLy8gT3IgaWYgd2UndmUgc3RhcnRlZCBvdXQgd2l0aCBhIGhhc2gtYmFzZWQgcm91dGUsIGJ1dCB3ZSdyZSBjdXJyZW50bHkKCSAgICAgICAgLy8gaW4gYSBicm93c2VyIHdoZXJlIGl0IGNvdWxkIGJlIGBwdXNoU3RhdGVgLWJhc2VkIGluc3RlYWQuLi4KCSAgICAgICAgfSBlbHNlIGlmICh0aGlzLl9oYXNQdXNoU3RhdGUgJiYgdGhpcy5hdFJvb3QoKSAmJiBsb2MuaGFzaCkgewoJICAgICAgICAgIHRoaXMuZnJhZ21lbnQgPSB0aGlzLmdldEhhc2goKS5yZXBsYWNlKHJvdXRlU3RyaXBwZXIsICcnKTsKCSAgICAgICAgICB0aGlzLmhpc3RvcnkucmVwbGFjZVN0YXRlKHt9LCBkb2N1bWVudC50aXRsZSwgdGhpcy5yb290ICsgdGhpcy5mcmFnbWVudCk7CgkgICAgICAgIH0KCgkgICAgICB9CgoJICAgICAgaWYgKCF0aGlzLm9wdGlvbnMuc2lsZW50KSByZXR1cm4gdGhpcy5sb2FkVXJsKCk7CgkgICAgfSwKCgkgICAgLy8gRGlzYWJsZSBCYWNrYm9uZS5oaXN0b3J5LCBwZXJoYXBzIHRlbXBvcmFyaWx5LiBOb3QgdXNlZnVsIGluIGEgcmVhbCBhcHAsCgkgICAgLy8gYnV0IHBvc3NpYmx5IHVzZWZ1bCBmb3IgdW5pdCB0ZXN0aW5nIFJvdXRlcnMuCgkgICAgc3RvcDogZnVuY3Rpb24oKSB7CgkgICAgICBCYWNrYm9uZS4kKHdpbmRvdykub2ZmKCdwb3BzdGF0ZScsIHRoaXMuY2hlY2tVcmwpLm9mZignaGFzaGNoYW5nZScsIHRoaXMuY2hlY2tVcmwpOwoJICAgICAgaWYgKHRoaXMuX2NoZWNrVXJsSW50ZXJ2YWwpIGNsZWFySW50ZXJ2YWwodGhpcy5fY2hlY2tVcmxJbnRlcnZhbCk7CgkgICAgICBIaXN0b3J5LnN0YXJ0ZWQgPSBmYWxzZTsKCSAgICB9LAoKCSAgICAvLyBBZGQgYSByb3V0ZSB0byBiZSB0ZXN0ZWQgd2hlbiB0aGUgZnJhZ21lbnQgY2hhbmdlcy4gUm91dGVzIGFkZGVkIGxhdGVyCgkgICAgLy8gbWF5IG92ZXJyaWRlIHByZXZpb3VzIHJvdXRlcy4KCSAgICByb3V0ZTogZnVuY3Rpb24ocm91dGUsIGNhbGxiYWNrKSB7CgkgICAgICB0aGlzLmhhbmRsZXJzLnVuc2hpZnQoe3JvdXRlOiByb3V0ZSwgY2FsbGJhY2s6IGNhbGxiYWNrfSk7CgkgICAgfSwKCgkgICAgLy8gQ2hlY2tzIHRoZSBjdXJyZW50IFVSTCB0byBzZWUgaWYgaXQgaGFzIGNoYW5nZWQsIGFuZCBpZiBpdCBoYXMsCgkgICAgLy8gY2FsbHMgYGxvYWRVcmxgLCBub3JtYWxpemluZyBhY3Jvc3MgdGhlIGhpZGRlbiBpZnJhbWUuCgkgICAgY2hlY2tVcmw6IGZ1bmN0aW9uKGUpIHsKCSAgICAgIHZhciBjdXJyZW50ID0gdGhpcy5nZXRGcmFnbWVudCgpOwoJICAgICAgaWYgKGN1cnJlbnQgPT09IHRoaXMuZnJhZ21lbnQgJiYgdGhpcy5pZnJhbWUpIHsKCSAgICAgICAgY3VycmVudCA9IHRoaXMuZ2V0RnJhZ21lbnQodGhpcy5nZXRIYXNoKHRoaXMuaWZyYW1lKSk7CgkgICAgICB9CgkgICAgICBpZiAoY3VycmVudCA9PT0gdGhpcy5mcmFnbWVudCkgcmV0dXJuIGZhbHNlOwoJICAgICAgaWYgKHRoaXMuaWZyYW1lKSB0aGlzLm5hdmlnYXRlKGN1cnJlbnQpOwoJICAgICAgdGhpcy5sb2FkVXJsKCk7CgkgICAgfSwKCgkgICAgLy8gQXR0ZW1wdCB0byBsb2FkIHRoZSBjdXJyZW50IFVSTCBmcmFnbWVudC4gSWYgYSByb3V0ZSBzdWNjZWVkcyB3aXRoIGEKCSAgICAvLyBtYXRjaCwgcmV0dXJucyBgdHJ1ZWAuIElmIG5vIGRlZmluZWQgcm91dGVzIG1hdGNoZXMgdGhlIGZyYWdtZW50LAoJICAgIC8vIHJldHVybnMgYGZhbHNlYC4KCSAgICBsb2FkVXJsOiBmdW5jdGlvbihmcmFnbWVudCkgewoJICAgICAgZnJhZ21lbnQgPSB0aGlzLmZyYWdtZW50ID0gdGhpcy5nZXRGcmFnbWVudChmcmFnbWVudCk7CgkgICAgICByZXR1cm4gXy5hbnkodGhpcy5oYW5kbGVycywgZnVuY3Rpb24oaGFuZGxlcikgewoJICAgICAgICBpZiAoaGFuZGxlci5yb3V0ZS50ZXN0KGZyYWdtZW50KSkgewoJICAgICAgICAgIGhhbmRsZXIuY2FsbGJhY2soZnJhZ21lbnQpOwoJICAgICAgICAgIHJldHVybiB0cnVlOwoJICAgICAgICB9CgkgICAgICB9KTsKCSAgICB9LAoKCSAgICAvLyBTYXZlIGEgZnJhZ21lbnQgaW50byB0aGUgaGFzaCBoaXN0b3J5LCBvciByZXBsYWNlIHRoZSBVUkwgc3RhdGUgaWYgdGhlCgkgICAgLy8gJ3JlcGxhY2UnIG9wdGlvbiBpcyBwYXNzZWQuIFlvdSBhcmUgcmVzcG9uc2libGUgZm9yIHByb3Blcmx5IFVSTC1lbmNvZGluZwoJICAgIC8vIHRoZSBmcmFnbWVudCBpbiBhZHZhbmNlLgoJICAgIC8vCgkgICAgLy8gVGhlIG9wdGlvbnMgb2JqZWN0IGNhbiBjb250YWluIGB0cmlnZ2VyOiB0cnVlYCBpZiB5b3Ugd2lzaCB0byBoYXZlIHRoZQoJICAgIC8vIHJvdXRlIGNhbGxiYWNrIGJlIGZpcmVkIChub3QgdXN1YWxseSBkZXNpcmFibGUpLCBvciBgcmVwbGFjZTogdHJ1ZWAsIGlmCgkgICAgLy8geW91IHdpc2ggdG8gbW9kaWZ5IHRoZSBjdXJyZW50IFVSTCB3aXRob3V0IGFkZGluZyBhbiBlbnRyeSB0byB0aGUgaGlzdG9yeS4KCSAgICBuYXZpZ2F0ZTogZnVuY3Rpb24oZnJhZ21lbnQsIG9wdGlvbnMpIHsKCSAgICAgIGlmICghSGlzdG9yeS5zdGFydGVkKSByZXR1cm4gZmFsc2U7CgkgICAgICBpZiAoIW9wdGlvbnMgfHwgb3B0aW9ucyA9PT0gdHJ1ZSkgb3B0aW9ucyA9IHt0cmlnZ2VyOiAhIW9wdGlvbnN9OwoKCSAgICAgIHZhciB1cmwgPSB0aGlzLnJvb3QgKyAoZnJhZ21lbnQgPSB0aGlzLmdldEZyYWdtZW50KGZyYWdtZW50IHx8ICcnKSk7CgoJICAgICAgLy8gU3RyaXAgdGhlIGhhc2ggZm9yIG1hdGNoaW5nLgoJICAgICAgZnJhZ21lbnQgPSBmcmFnbWVudC5yZXBsYWNlKHBhdGhTdHJpcHBlciwgJycpOwoKCSAgICAgIGlmICh0aGlzLmZyYWdtZW50ID09PSBmcmFnbWVudCkgcmV0dXJuOwoJICAgICAgdGhpcy5mcmFnbWVudCA9IGZyYWdtZW50OwoKCSAgICAgIC8vIERvbid0IGluY2x1ZGUgYSB0cmFpbGluZyBzbGFzaCBvbiB0aGUgcm9vdC4KCSAgICAgIGlmIChmcmFnbWVudCA9PT0gJycgJiYgdXJsICE9PSAnLycpIHVybCA9IHVybC5zbGljZSgwLCAtMSk7CgoJICAgICAgLy8gSWYgcHVzaFN0YXRlIGlzIGF2YWlsYWJsZSwgd2UgdXNlIGl0IHRvIHNldCB0aGUgZnJhZ21lbnQgYXMgYSByZWFsIFVSTC4KCSAgICAgIGlmICh0aGlzLl9oYXNQdXNoU3RhdGUpIHsKCSAgICAgICAgdGhpcy5oaXN0b3J5W29wdGlvbnMucmVwbGFjZSA/ICdyZXBsYWNlU3RhdGUnIDogJ3B1c2hTdGF0ZSddKHt9LCBkb2N1bWVudC50aXRsZSwgdXJsKTsKCgkgICAgICAvLyBJZiBoYXNoIGNoYW5nZXMgaGF2ZW4ndCBiZWVuIGV4cGxpY2l0bHkgZGlzYWJsZWQsIHVwZGF0ZSB0aGUgaGFzaAoJICAgICAgLy8gZnJhZ21lbnQgdG8gc3RvcmUgaGlzdG9yeS4KCSAgICAgIH0gZWxzZSBpZiAodGhpcy5fd2FudHNIYXNoQ2hhbmdlKSB7CgkgICAgICAgIHRoaXMuX3VwZGF0ZUhhc2godGhpcy5sb2NhdGlvbiwgZnJhZ21lbnQsIG9wdGlvbnMucmVwbGFjZSk7CgkgICAgICAgIGlmICh0aGlzLmlmcmFtZSAmJiAoZnJhZ21lbnQgIT09IHRoaXMuZ2V0RnJhZ21lbnQodGhpcy5nZXRIYXNoKHRoaXMuaWZyYW1lKSkpKSB7CgkgICAgICAgICAgLy8gT3BlbmluZyBhbmQgY2xvc2luZyB0aGUgaWZyYW1lIHRyaWNrcyBJRTcgYW5kIGVhcmxpZXIgdG8gcHVzaCBhCgkgICAgICAgICAgLy8gaGlzdG9yeSBlbnRyeSBvbiBoYXNoLXRhZyBjaGFuZ2UuICBXaGVuIHJlcGxhY2UgaXMgdHJ1ZSwgd2UgZG9uJ3QKCSAgICAgICAgICAvLyB3YW50IHRoaXMuCgkgICAgICAgICAgaWYoIW9wdGlvbnMucmVwbGFjZSkgdGhpcy5pZnJhbWUuZG9jdW1lbnQub3BlbigpLmNsb3NlKCk7CgkgICAgICAgICAgdGhpcy5fdXBkYXRlSGFzaCh0aGlzLmlmcmFtZS5sb2NhdGlvbiwgZnJhZ21lbnQsIG9wdGlvbnMucmVwbGFjZSk7CgkgICAgICAgIH0KCgkgICAgICAvLyBJZiB5b3UndmUgdG9sZCB1cyB0aGF0IHlvdSBleHBsaWNpdGx5IGRvbid0IHdhbnQgZmFsbGJhY2sgaGFzaGNoYW5nZS0KCSAgICAgIC8vIGJhc2VkIGhpc3RvcnksIHRoZW4gYG5hdmlnYXRlYCBiZWNvbWVzIGEgcGFnZSByZWZyZXNoLgoJICAgICAgfSBlbHNlIHsKCSAgICAgICAgcmV0dXJuIHRoaXMubG9jYXRpb24uYXNzaWduKHVybCk7CgkgICAgICB9CgkgICAgICBpZiAob3B0aW9ucy50cmlnZ2VyKSByZXR1cm4gdGhpcy5sb2FkVXJsKGZyYWdtZW50KTsKCSAgICB9LAoKCSAgICAvLyBVcGRhdGUgdGhlIGhhc2ggbG9jYXRpb24sIGVpdGhlciByZXBsYWNpbmcgdGhlIGN1cnJlbnQgZW50cnksIG9yIGFkZGluZwoJICAgIC8vIGEgbmV3IG9uZSB0byB0aGUgYnJvd3NlciBoaXN0b3J5LgoJICAgIF91cGRhdGVIYXNoOiBmdW5jdGlvbihsb2NhdGlvbiwgZnJhZ21lbnQsIHJlcGxhY2UpIHsKCSAgICAgIGlmIChyZXBsYWNlKSB7CgkgICAgICAgIHZhciBocmVmID0gbG9jYXRpb24uaHJlZi5yZXBsYWNlKC8oamF2YXNjcmlwdDp8IykuKiQvLCAnJyk7CgkgICAgICAgIGxvY2F0aW9uLnJlcGxhY2UoaHJlZiArICcjJyArIGZyYWdtZW50KTsKCSAgICAgIH0gZWxzZSB7CgkgICAgICAgIC8vIFNvbWUgYnJvd3NlcnMgcmVxdWlyZSB0aGF0IGBoYXNoYCBjb250YWlucyBhIGxlYWRpbmcgIy4KCSAgICAgICAgbG9jYXRpb24uaGFzaCA9ICcjJyArIGZyYWdtZW50OwoJICAgICAgfQoJICAgIH0KCgkgIH0pOwoKCSAgLy8gQ3JlYXRlIHRoZSBkZWZhdWx0IEJhY2tib25lLmhpc3RvcnkuCgkgIEJhY2tib25lLmhpc3RvcnkgPSBuZXcgSGlzdG9yeTsKCgkgIC8vIEhlbHBlcnMKCSAgLy8gLS0tLS0tLQoKCSAgLy8gSGVscGVyIGZ1bmN0aW9uIHRvIGNvcnJlY3RseSBzZXQgdXAgdGhlIHByb3RvdHlwZSBjaGFpbiwgZm9yIHN1YmNsYXNzZXMuCgkgIC8vIFNpbWlsYXIgdG8gYGdvb2cuaW5oZXJpdHNgLCBidXQgdXNlcyBhIGhhc2ggb2YgcHJvdG90eXBlIHByb3BlcnRpZXMgYW5kCgkgIC8vIGNsYXNzIHByb3BlcnRpZXMgdG8gYmUgZXh0ZW5kZWQuCgkgIHZhciBleHRlbmQgPSBmdW5jdGlvbihwcm90b1Byb3BzLCBzdGF0aWNQcm9wcykgewoJICAgIHZhciBwYXJlbnQgPSB0aGlzOwoJICAgIHZhciBjaGlsZDsKCgkgICAgLy8gVGhlIGNvbnN0cnVjdG9yIGZ1bmN0aW9uIGZvciB0aGUgbmV3IHN1YmNsYXNzIGlzIGVpdGhlciBkZWZpbmVkIGJ5IHlvdQoJICAgIC8vICh0aGUgImNvbnN0cnVjdG9yIiBwcm9wZXJ0eSBpbiB5b3VyIGBleHRlbmRgIGRlZmluaXRpb24pLCBvciBkZWZhdWx0ZWQKCSAgICAvLyBieSB1cyB0byBzaW1wbHkgY2FsbCB0aGUgcGFyZW50J3MgY29uc3RydWN0b3IuCgkgICAgaWYgKHByb3RvUHJvcHMgJiYgXy5oYXMocHJvdG9Qcm9wcywgJ2NvbnN0cnVjdG9yJykpIHsKCSAgICAgIGNoaWxkID0gcHJvdG9Qcm9wcy5jb25zdHJ1Y3RvcjsKCSAgICB9IGVsc2UgewoJICAgICAgY2hpbGQgPSBmdW5jdGlvbigpeyByZXR1cm4gcGFyZW50LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7IH07CgkgICAgfQoKCSAgICAvLyBBZGQgc3RhdGljIHByb3BlcnRpZXMgdG8gdGhlIGNvbnN0cnVjdG9yIGZ1bmN0aW9uLCBpZiBzdXBwbGllZC4KCSAgICBfLmV4dGVuZChjaGlsZCwgcGFyZW50LCBzdGF0aWNQcm9wcyk7CgoJICAgIC8vIFNldCB0aGUgcHJvdG90eXBlIGNoYWluIHRvIGluaGVyaXQgZnJvbSBgcGFyZW50YCwgd2l0aG91dCBjYWxsaW5nCgkgICAgLy8gYHBhcmVudGAncyBjb25zdHJ1Y3RvciBmdW5jdGlvbi4KCSAgICB2YXIgU3Vycm9nYXRlID0gZnVuY3Rpb24oKXsgdGhpcy5jb25zdHJ1Y3RvciA9IGNoaWxkOyB9OwoJICAgIFN1cnJvZ2F0ZS5wcm90b3R5cGUgPSBwYXJlbnQucHJvdG90eXBlOwoJICAgIGNoaWxkLnByb3RvdHlwZSA9IG5ldyBTdXJyb2dhdGU7CgoJICAgIC8vIEFkZCBwcm90b3R5cGUgcHJvcGVydGllcyAoaW5zdGFuY2UgcHJvcGVydGllcykgdG8gdGhlIHN1YmNsYXNzLAoJICAgIC8vIGlmIHN1cHBsaWVkLgoJICAgIGlmIChwcm90b1Byb3BzKSBfLmV4dGVuZChjaGlsZC5wcm90b3R5cGUsIHByb3RvUHJvcHMpOwoKCSAgICAvLyBTZXQgYSBjb252ZW5pZW5jZSBwcm9wZXJ0eSBpbiBjYXNlIHRoZSBwYXJlbnQncyBwcm90b3R5cGUgaXMgbmVlZGVkCgkgICAgLy8gbGF0ZXIuCgkgICAgY2hpbGQuX19zdXBlcl9fID0gcGFyZW50LnByb3RvdHlwZTsKCgkgICAgcmV0dXJuIGNoaWxkOwoJICB9OwoKCSAgLy8gU2V0IHVwIGluaGVyaXRhbmNlIGZvciB0aGUgbW9kZWwsIGNvbGxlY3Rpb24sIHJvdXRlciwgdmlldyBhbmQgaGlzdG9yeS4KCSAgTW9kZWwuZXh0ZW5kID0gQ29sbGVjdGlvbi5leHRlbmQgPSBSb3V0ZXIuZXh0ZW5kID0gVmlldy5leHRlbmQgPSBIaXN0b3J5LmV4dGVuZCA9IGV4dGVuZDsKCgkgIC8vIFRocm93IGFuIGVycm9yIHdoZW4gYSBVUkwgaXMgbmVlZGVkLCBhbmQgbm9uZSBpcyBzdXBwbGllZC4KCSAgdmFyIHVybEVycm9yID0gZnVuY3Rpb24oKSB7CgkgICAgdGhyb3cgbmV3IEVycm9yKCdBICJ1cmwiIHByb3BlcnR5IG9yIGZ1bmN0aW9uIG11c3QgYmUgc3BlY2lmaWVkJyk7CgkgIH07CgoJICAvLyBXcmFwIGFuIG9wdGlvbmFsIGVycm9yIGNhbGxiYWNrIHdpdGggYSBmYWxsYmFjayBlcnJvciBldmVudC4KCSAgdmFyIHdyYXBFcnJvciA9IGZ1bmN0aW9uKG1vZGVsLCBvcHRpb25zKSB7CgkgICAgdmFyIGVycm9yID0gb3B0aW9ucy5lcnJvcjsKCSAgICBvcHRpb25zLmVycm9yID0gZnVuY3Rpb24ocmVzcCkgewoJICAgICAgaWYgKGVycm9yKSBlcnJvcihtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CgkgICAgICBtb2RlbC50cmlnZ2VyKCdlcnJvcicsIG1vZGVsLCByZXNwLCBvcHRpb25zKTsKCSAgICB9OwoJICB9OwoKCSAgcmV0dXJuIEJhY2tib25lOwoKCX0pKTsKCgovKioqLyB9LAovKiAyNCAqLwovKioqLyBmdW5jdGlvbihtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKCgl2YXIgX19XRUJQQUNLX0FNRF9ERUZJTkVfQVJSQVlfXywgX19XRUJQQUNLX0FNRF9ERUZJTkVfUkVTVUxUX187Ly8gICAgIFVuZGVyc2NvcmUuanMgMS43LjAKCS8vICAgICBodHRwOi8vdW5kZXJzY29yZWpzLm9yZwoJLy8gICAgIChjKSAyMDA5LTIwMTQgSmVyZW15IEFzaGtlbmFzLCBEb2N1bWVudENsb3VkIGFuZCBJbnZlc3RpZ2F0aXZlIFJlcG9ydGVycyAmIEVkaXRvcnMKCS8vICAgICBVbmRlcnNjb3JlIG1heSBiZSBmcmVlbHkgZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLgoKCShmdW5jdGlvbigpIHsKCgkgIC8vIEJhc2VsaW5lIHNldHVwCgkgIC8vIC0tLS0tLS0tLS0tLS0tCgoJICAvLyBFc3RhYmxpc2ggdGhlIHJvb3Qgb2JqZWN0LCBgd2luZG93YCBpbiB0aGUgYnJvd3Nlciwgb3IgYGV4cG9ydHNgIG9uIHRoZSBzZXJ2ZXIuCgkgIHZhciByb290ID0gdGhpczsKCgkgIC8vIFNhdmUgdGhlIHByZXZpb3VzIHZhbHVlIG9mIHRoZSBgX2AgdmFyaWFibGUuCgkgIHZhciBwcmV2aW91c1VuZGVyc2NvcmUgPSByb290Ll87CgoJICAvLyBTYXZlIGJ5dGVzIGluIHRoZSBtaW5pZmllZCAoYnV0IG5vdCBnemlwcGVkKSB2ZXJzaW9uOgoJICB2YXIgQXJyYXlQcm90byA9IEFycmF5LnByb3RvdHlwZSwgT2JqUHJvdG8gPSBPYmplY3QucHJvdG90eXBlLCBGdW5jUHJvdG8gPSBGdW5jdGlvbi5wcm90b3R5cGU7CgoJICAvLyBDcmVhdGUgcXVpY2sgcmVmZXJlbmNlIHZhcmlhYmxlcyBmb3Igc3BlZWQgYWNjZXNzIHRvIGNvcmUgcHJvdG90eXBlcy4KCSAgdmFyCgkgICAgcHVzaCAgICAgICAgICAgICA9IEFycmF5UHJvdG8ucHVzaCwKCSAgICBzbGljZSAgICAgICAgICAgID0gQXJyYXlQcm90by5zbGljZSwKCSAgICBjb25jYXQgICAgICAgICAgID0gQXJyYXlQcm90by5jb25jYXQsCgkgICAgdG9TdHJpbmcgICAgICAgICA9IE9ialByb3RvLnRvU3RyaW5nLAoJICAgIGhhc093blByb3BlcnR5ICAgPSBPYmpQcm90by5oYXNPd25Qcm9wZXJ0eTsKCgkgIC8vIEFsbCAqKkVDTUFTY3JpcHQgNSoqIG5hdGl2ZSBmdW5jdGlvbiBpbXBsZW1lbnRhdGlvbnMgdGhhdCB3ZSBob3BlIHRvIHVzZQoJICAvLyBhcmUgZGVjbGFyZWQgaGVyZS4KCSAgdmFyCgkgICAgbmF0aXZlSXNBcnJheSAgICAgID0gQXJyYXkuaXNBcnJheSwKCSAgICBuYXRpdmVLZXlzICAgICAgICAgPSBPYmplY3Qua2V5cywKCSAgICBuYXRpdmVCaW5kICAgICAgICAgPSBGdW5jUHJvdG8uYmluZDsKCgkgIC8vIENyZWF0ZSBhIHNhZmUgcmVmZXJlbmNlIHRvIHRoZSBVbmRlcnNjb3JlIG9iamVjdCBmb3IgdXNlIGJlbG93LgoJICB2YXIgXyA9IGZ1bmN0aW9uKG9iaikgewoJICAgIGlmIChvYmogaW5zdGFuY2VvZiBfKSByZXR1cm4gb2JqOwoJICAgIGlmICghKHRoaXMgaW5zdGFuY2VvZiBfKSkgcmV0dXJuIG5ldyBfKG9iaik7CgkgICAgdGhpcy5fd3JhcHBlZCA9IG9iajsKCSAgfTsKCgkgIC8vIEV4cG9ydCB0aGUgVW5kZXJzY29yZSBvYmplY3QgZm9yICoqTm9kZS5qcyoqLCB3aXRoCgkgIC8vIGJhY2t3YXJkcy1jb21wYXRpYmlsaXR5IGZvciB0aGUgb2xkIGByZXF1aXJlKClgIEFQSS4gSWYgd2UncmUgaW4KCSAgLy8gdGhlIGJyb3dzZXIsIGFkZCBgX2AgYXMgYSBnbG9iYWwgb2JqZWN0LgoJICBpZiAodHJ1ZSkgewoJICAgIGlmICh0eXBlb2YgbW9kdWxlICE9PSAndW5kZWZpbmVkJyAmJiBtb2R1bGUuZXhwb3J0cykgewoJICAgICAgZXhwb3J0cyA9IG1vZHVsZS5leHBvcnRzID0gXzsKCSAgICB9CgkgICAgZXhwb3J0cy5fID0gXzsKCSAgfSBlbHNlIHsKCSAgICByb290Ll8gPSBfOwoJICB9CgoJICAvLyBDdXJyZW50IHZlcnNpb24uCgkgIF8uVkVSU0lPTiA9ICcxLjcuMCc7CgoJICAvLyBJbnRlcm5hbCBmdW5jdGlvbiB0aGF0IHJldHVybnMgYW4gZWZmaWNpZW50IChmb3IgY3VycmVudCBlbmdpbmVzKSB2ZXJzaW9uCgkgIC8vIG9mIHRoZSBwYXNzZWQtaW4gY2FsbGJhY2ssIHRvIGJlIHJlcGVhdGVkbHkgYXBwbGllZCBpbiBvdGhlciBVbmRlcnNjb3JlCgkgIC8vIGZ1bmN0aW9ucy4KCSAgdmFyIGNyZWF0ZUNhbGxiYWNrID0gZnVuY3Rpb24oZnVuYywgY29udGV4dCwgYXJnQ291bnQpIHsKCSAgICBpZiAoY29udGV4dCA9PT0gdm9pZCAwKSByZXR1cm4gZnVuYzsKCSAgICBzd2l0Y2ggKGFyZ0NvdW50ID09IG51bGwgPyAzIDogYXJnQ291bnQpIHsKCSAgICAgIGNhc2UgMTogcmV0dXJuIGZ1bmN0aW9uKHZhbHVlKSB7CgkgICAgICAgIHJldHVybiBmdW5jLmNhbGwoY29udGV4dCwgdmFsdWUpOwoJICAgICAgfTsKCSAgICAgIGNhc2UgMjogcmV0dXJuIGZ1bmN0aW9uKHZhbHVlLCBvdGhlcikgewoJICAgICAgICByZXR1cm4gZnVuYy5jYWxsKGNvbnRleHQsIHZhbHVlLCBvdGhlcik7CgkgICAgICB9OwoJICAgICAgY2FzZSAzOiByZXR1cm4gZnVuY3Rpb24odmFsdWUsIGluZGV4LCBjb2xsZWN0aW9uKSB7CgkgICAgICAgIHJldHVybiBmdW5jLmNhbGwoY29udGV4dCwgdmFsdWUsIGluZGV4LCBjb2xsZWN0aW9uKTsKCSAgICAgIH07CgkgICAgICBjYXNlIDQ6IHJldHVybiBmdW5jdGlvbihhY2N1bXVsYXRvciwgdmFsdWUsIGluZGV4LCBjb2xsZWN0aW9uKSB7CgkgICAgICAgIHJldHVybiBmdW5jLmNhbGwoY29udGV4dCwgYWNjdW11bGF0b3IsIHZhbHVlLCBpbmRleCwgY29sbGVjdGlvbik7CgkgICAgICB9OwoJICAgIH0KCSAgICByZXR1cm4gZnVuY3Rpb24oKSB7CgkgICAgICByZXR1cm4gZnVuYy5hcHBseShjb250ZXh0LCBhcmd1bWVudHMpOwoJICAgIH07CgkgIH07CgoJICAvLyBBIG1vc3RseS1pbnRlcm5hbCBmdW5jdGlvbiB0byBnZW5lcmF0ZSBjYWxsYmFja3MgdGhhdCBjYW4gYmUgYXBwbGllZAoJICAvLyB0byBlYWNoIGVsZW1lbnQgaW4gYSBjb2xsZWN0aW9uLCByZXR1cm5pbmcgdGhlIGRlc2lyZWQgcmVzdWx0IOKAlCBlaXRoZXIKCSAgLy8gaWRlbnRpdHksIGFuIGFyYml0cmFyeSBjYWxsYmFjaywgYSBwcm9wZXJ0eSBtYXRjaGVyLCBvciBhIHByb3BlcnR5IGFjY2Vzc29yLgoJICBfLml0ZXJhdGVlID0gZnVuY3Rpb24odmFsdWUsIGNvbnRleHQsIGFyZ0NvdW50KSB7CgkgICAgaWYgKHZhbHVlID09IG51bGwpIHJldHVybiBfLmlkZW50aXR5OwoJICAgIGlmIChfLmlzRnVuY3Rpb24odmFsdWUpKSByZXR1cm4gY3JlYXRlQ2FsbGJhY2sodmFsdWUsIGNvbnRleHQsIGFyZ0NvdW50KTsKCSAgICBpZiAoXy5pc09iamVjdCh2YWx1ZSkpIHJldHVybiBfLm1hdGNoZXModmFsdWUpOwoJICAgIHJldHVybiBfLnByb3BlcnR5KHZhbHVlKTsKCSAgfTsKCgkgIC8vIENvbGxlY3Rpb24gRnVuY3Rpb25zCgkgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tCgoJICAvLyBUaGUgY29ybmVyc3RvbmUsIGFuIGBlYWNoYCBpbXBsZW1lbnRhdGlvbiwgYWthIGBmb3JFYWNoYC4KCSAgLy8gSGFuZGxlcyByYXcgb2JqZWN0cyBpbiBhZGRpdGlvbiB0byBhcnJheS1saWtlcy4gVHJlYXRzIGFsbAoJICAvLyBzcGFyc2UgYXJyYXktbGlrZXMgYXMgaWYgdGhleSB3ZXJlIGRlbnNlLgoJICBfLmVhY2ggPSBfLmZvckVhY2ggPSBmdW5jdGlvbihvYmosIGl0ZXJhdGVlLCBjb250ZXh0KSB7CgkgICAgaWYgKG9iaiA9PSBudWxsKSByZXR1cm4gb2JqOwoJICAgIGl0ZXJhdGVlID0gY3JlYXRlQ2FsbGJhY2soaXRlcmF0ZWUsIGNvbnRleHQpOwoJICAgIHZhciBpLCBsZW5ndGggPSBvYmoubGVuZ3RoOwoJICAgIGlmIChsZW5ndGggPT09ICtsZW5ndGgpIHsKCSAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewoJICAgICAgICBpdGVyYXRlZShvYmpbaV0sIGksIG9iaik7CgkgICAgICB9CgkgICAgfSBlbHNlIHsKCSAgICAgIHZhciBrZXlzID0gXy5rZXlzKG9iaik7CgkgICAgICBmb3IgKGkgPSAwLCBsZW5ndGggPSBrZXlzLmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrKSB7CgkgICAgICAgIGl0ZXJhdGVlKG9ialtrZXlzW2ldXSwga2V5c1tpXSwgb2JqKTsKCSAgICAgIH0KCSAgICB9CgkgICAgcmV0dXJuIG9iajsKCSAgfTsKCgkgIC8vIFJldHVybiB0aGUgcmVzdWx0cyBvZiBhcHBseWluZyB0aGUgaXRlcmF0ZWUgdG8gZWFjaCBlbGVtZW50LgoJICBfLm1hcCA9IF8uY29sbGVjdCA9IGZ1bmN0aW9uKG9iaiwgaXRlcmF0ZWUsIGNvbnRleHQpIHsKCSAgICBpZiAob2JqID09IG51bGwpIHJldHVybiBbXTsKCSAgICBpdGVyYXRlZSA9IF8uaXRlcmF0ZWUoaXRlcmF0ZWUsIGNvbnRleHQpOwoJICAgIHZhciBrZXlzID0gb2JqLmxlbmd0aCAhPT0gK29iai5sZW5ndGggJiYgXy5rZXlzKG9iaiksCgkgICAgICAgIGxlbmd0aCA9IChrZXlzIHx8IG9iaikubGVuZ3RoLAoJICAgICAgICByZXN1bHRzID0gQXJyYXkobGVuZ3RoKSwKCSAgICAgICAgY3VycmVudEtleTsKCSAgICBmb3IgKHZhciBpbmRleCA9IDA7IGluZGV4IDwgbGVuZ3RoOyBpbmRleCsrKSB7CgkgICAgICBjdXJyZW50S2V5ID0ga2V5cyA/IGtleXNbaW5kZXhdIDogaW5kZXg7CgkgICAgICByZXN1bHRzW2luZGV4XSA9IGl0ZXJhdGVlKG9ialtjdXJyZW50S2V5XSwgY3VycmVudEtleSwgb2JqKTsKCSAgICB9CgkgICAgcmV0dXJuIHJlc3VsdHM7CgkgIH07CgoJICB2YXIgcmVkdWNlRXJyb3IgPSAnUmVkdWNlIG9mIGVtcHR5IGFycmF5IHdpdGggbm8gaW5pdGlhbCB2YWx1ZSc7CgoJICAvLyAqKlJlZHVjZSoqIGJ1aWxkcyB1cCBhIHNpbmdsZSByZXN1bHQgZnJvbSBhIGxpc3Qgb2YgdmFsdWVzLCBha2EgYGluamVjdGAsCgkgIC8vIG9yIGBmb2xkbGAuCgkgIF8ucmVkdWNlID0gXy5mb2xkbCA9IF8uaW5qZWN0ID0gZnVuY3Rpb24ob2JqLCBpdGVyYXRlZSwgbWVtbywgY29udGV4dCkgewoJICAgIGlmIChvYmogPT0gbnVsbCkgb2JqID0gW107CgkgICAgaXRlcmF0ZWUgPSBjcmVhdGVDYWxsYmFjayhpdGVyYXRlZSwgY29udGV4dCwgNCk7CgkgICAgdmFyIGtleXMgPSBvYmoubGVuZ3RoICE9PSArb2JqLmxlbmd0aCAmJiBfLmtleXMob2JqKSwKCSAgICAgICAgbGVuZ3RoID0gKGtleXMgfHwgb2JqKS5sZW5ndGgsCgkgICAgICAgIGluZGV4ID0gMCwgY3VycmVudEtleTsKCSAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA8IDMpIHsKCSAgICAgIGlmICghbGVuZ3RoKSB0aHJvdyBuZXcgVHlwZUVycm9yKHJlZHVjZUVycm9yKTsKCSAgICAgIG1lbW8gPSBvYmpba2V5cyA/IGtleXNbaW5kZXgrK10gOiBpbmRleCsrXTsKCSAgICB9CgkgICAgZm9yICg7IGluZGV4IDwgbGVuZ3RoOyBpbmRleCsrKSB7CgkgICAgICBjdXJyZW50S2V5ID0ga2V5cyA/IGtleXNbaW5kZXhdIDogaW5kZXg7CgkgICAgICBtZW1vID0gaXRlcmF0ZWUobWVtbywgb2JqW2N1cnJlbnRLZXldLCBjdXJyZW50S2V5LCBvYmopOwoJICAgIH0KCSAgICByZXR1cm4gbWVtbzsKCSAgfTsKCgkgIC8vIFRoZSByaWdodC1hc3NvY2lhdGl2ZSB2ZXJzaW9uIG9mIHJlZHVjZSwgYWxzbyBrbm93biBhcyBgZm9sZHJgLgoJICBfLnJlZHVjZVJpZ2h0ID0gXy5mb2xkciA9IGZ1bmN0aW9uKG9iaiwgaXRlcmF0ZWUsIG1lbW8sIGNvbnRleHQpIHsKCSAgICBpZiAob2JqID09IG51bGwpIG9iaiA9IFtdOwoJICAgIGl0ZXJhdGVlID0gY3JlYXRlQ2FsbGJhY2soaXRlcmF0ZWUsIGNvbnRleHQsIDQpOwoJICAgIHZhciBrZXlzID0gb2JqLmxlbmd0aCAhPT0gKyBvYmoubGVuZ3RoICYmIF8ua2V5cyhvYmopLAoJICAgICAgICBpbmRleCA9IChrZXlzIHx8IG9iaikubGVuZ3RoLAoJICAgICAgICBjdXJyZW50S2V5OwoJICAgIGlmIChhcmd1bWVudHMubGVuZ3RoIDwgMykgewoJICAgICAgaWYgKCFpbmRleCkgdGhyb3cgbmV3IFR5cGVFcnJvcihyZWR1Y2VFcnJvcik7CgkgICAgICBtZW1vID0gb2JqW2tleXMgPyBrZXlzWy0taW5kZXhdIDogLS1pbmRleF07CgkgICAgfQoJICAgIHdoaWxlIChpbmRleC0tKSB7CgkgICAgICBjdXJyZW50S2V5ID0ga2V5cyA/IGtleXNbaW5kZXhdIDogaW5kZXg7CgkgICAgICBtZW1vID0gaXRlcmF0ZWUobWVtbywgb2JqW2N1cnJlbnRLZXldLCBjdXJyZW50S2V5LCBvYmopOwoJICAgIH0KCSAgICByZXR1cm4gbWVtbzsKCSAgfTsKCgkgIC8vIFJldHVybiB0aGUgZmlyc3QgdmFsdWUgd2hpY2ggcGFzc2VzIGEgdHJ1dGggdGVzdC4gQWxpYXNlZCBhcyBgZGV0ZWN0YC4KCSAgXy5maW5kID0gXy5kZXRlY3QgPSBmdW5jdGlvbihvYmosIHByZWRpY2F0ZSwgY29udGV4dCkgewoJICAgIHZhciByZXN1bHQ7CgkgICAgcHJlZGljYXRlID0gXy5pdGVyYXRlZShwcmVkaWNhdGUsIGNvbnRleHQpOwoJICAgIF8uc29tZShvYmosIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgbGlzdCkgewoJICAgICAgaWYgKHByZWRpY2F0ZSh2YWx1ZSwgaW5kZXgsIGxpc3QpKSB7CgkgICAgICAgIHJlc3VsdCA9IHZhbHVlOwoJICAgICAgICByZXR1cm4gdHJ1ZTsKCSAgICAgIH0KCSAgICB9KTsKCSAgICByZXR1cm4gcmVzdWx0OwoJICB9OwoKCSAgLy8gUmV0dXJuIGFsbCB0aGUgZWxlbWVudHMgdGhhdCBwYXNzIGEgdHJ1dGggdGVzdC4KCSAgLy8gQWxpYXNlZCBhcyBgc2VsZWN0YC4KCSAgXy5maWx0ZXIgPSBfLnNlbGVjdCA9IGZ1bmN0aW9uKG9iaiwgcHJlZGljYXRlLCBjb250ZXh0KSB7CgkgICAgdmFyIHJlc3VsdHMgPSBbXTsKCSAgICBpZiAob2JqID09IG51bGwpIHJldHVybiByZXN1bHRzOwoJICAgIHByZWRpY2F0ZSA9IF8uaXRlcmF0ZWUocHJlZGljYXRlLCBjb250ZXh0KTsKCSAgICBfLmVhY2gob2JqLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGxpc3QpIHsKCSAgICAgIGlmIChwcmVkaWNhdGUodmFsdWUsIGluZGV4LCBsaXN0KSkgcmVzdWx0cy5wdXNoKHZhbHVlKTsKCSAgICB9KTsKCSAgICByZXR1cm4gcmVzdWx0czsKCSAgfTsKCgkgIC8vIFJldHVybiBhbGwgdGhlIGVsZW1lbnRzIGZvciB3aGljaCBhIHRydXRoIHRlc3QgZmFpbHMuCgkgIF8ucmVqZWN0ID0gZnVuY3Rpb24ob2JqLCBwcmVkaWNhdGUsIGNvbnRleHQpIHsKCSAgICByZXR1cm4gXy5maWx0ZXIob2JqLCBfLm5lZ2F0ZShfLml0ZXJhdGVlKHByZWRpY2F0ZSkpLCBjb250ZXh0KTsKCSAgfTsKCgkgIC8vIERldGVybWluZSB3aGV0aGVyIGFsbCBvZiB0aGUgZWxlbWVudHMgbWF0Y2ggYSB0cnV0aCB0ZXN0LgoJICAvLyBBbGlhc2VkIGFzIGBhbGxgLgoJICBfLmV2ZXJ5ID0gXy5hbGwgPSBmdW5jdGlvbihvYmosIHByZWRpY2F0ZSwgY29udGV4dCkgewoJICAgIGlmIChvYmogPT0gbnVsbCkgcmV0dXJuIHRydWU7CgkgICAgcHJlZGljYXRlID0gXy5pdGVyYXRlZShwcmVkaWNhdGUsIGNvbnRleHQpOwoJICAgIHZhciBrZXlzID0gb2JqLmxlbmd0aCAhPT0gK29iai5sZW5ndGggJiYgXy5rZXlzKG9iaiksCgkgICAgICAgIGxlbmd0aCA9IChrZXlzIHx8IG9iaikubGVuZ3RoLAoJICAgICAgICBpbmRleCwgY3VycmVudEtleTsKCSAgICBmb3IgKGluZGV4ID0gMDsgaW5kZXggPCBsZW5ndGg7IGluZGV4KyspIHsKCSAgICAgIGN1cnJlbnRLZXkgPSBrZXlzID8ga2V5c1tpbmRleF0gOiBpbmRleDsKCSAgICAgIGlmICghcHJlZGljYXRlKG9ialtjdXJyZW50S2V5XSwgY3VycmVudEtleSwgb2JqKSkgcmV0dXJuIGZhbHNlOwoJICAgIH0KCSAgICByZXR1cm4gdHJ1ZTsKCSAgfTsKCgkgIC8vIERldGVybWluZSBpZiBhdCBsZWFzdCBvbmUgZWxlbWVudCBpbiB0aGUgb2JqZWN0IG1hdGNoZXMgYSB0cnV0aCB0ZXN0LgoJICAvLyBBbGlhc2VkIGFzIGBhbnlgLgoJICBfLnNvbWUgPSBfLmFueSA9IGZ1bmN0aW9uKG9iaiwgcHJlZGljYXRlLCBjb250ZXh0KSB7CgkgICAgaWYgKG9iaiA9PSBudWxsKSByZXR1cm4gZmFsc2U7CgkgICAgcHJlZGljYXRlID0gXy5pdGVyYXRlZShwcmVkaWNhdGUsIGNvbnRleHQpOwoJICAgIHZhciBrZXlzID0gb2JqLmxlbmd0aCAhPT0gK29iai5sZW5ndGggJiYgXy5rZXlzKG9iaiksCgkgICAgICAgIGxlbmd0aCA9IChrZXlzIHx8IG9iaikubGVuZ3RoLAoJICAgICAgICBpbmRleCwgY3VycmVudEtleTsKCSAgICBmb3IgKGluZGV4ID0gMDsgaW5kZXggPCBsZW5ndGg7IGluZGV4KyspIHsKCSAgICAgIGN1cnJlbnRLZXkgPSBrZXlzID8ga2V5c1tpbmRleF0gOiBpbmRleDsKCSAgICAgIGlmIChwcmVkaWNhdGUob2JqW2N1cnJlbnRLZXldLCBjdXJyZW50S2V5LCBvYmopKSByZXR1cm4gdHJ1ZTsKCSAgICB9CgkgICAgcmV0dXJuIGZhbHNlOwoJICB9OwoKCSAgLy8gRGV0ZXJtaW5lIGlmIHRoZSBhcnJheSBvciBvYmplY3QgY29udGFpbnMgYSBnaXZlbiB2YWx1ZSAodXNpbmcgYD09PWApLgoJICAvLyBBbGlhc2VkIGFzIGBpbmNsdWRlYC4KCSAgXy5jb250YWlucyA9IF8uaW5jbHVkZSA9IGZ1bmN0aW9uKG9iaiwgdGFyZ2V0KSB7CgkgICAgaWYgKG9iaiA9PSBudWxsKSByZXR1cm4gZmFsc2U7CgkgICAgaWYgKG9iai5sZW5ndGggIT09ICtvYmoubGVuZ3RoKSBvYmogPSBfLnZhbHVlcyhvYmopOwoJICAgIHJldHVybiBfLmluZGV4T2Yob2JqLCB0YXJnZXQpID49IDA7CgkgIH07CgoJICAvLyBJbnZva2UgYSBtZXRob2QgKHdpdGggYXJndW1lbnRzKSBvbiBldmVyeSBpdGVtIGluIGEgY29sbGVjdGlvbi4KCSAgXy5pbnZva2UgPSBmdW5jdGlvbihvYmosIG1ldGhvZCkgewoJICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDIpOwoJICAgIHZhciBpc0Z1bmMgPSBfLmlzRnVuY3Rpb24obWV0aG9kKTsKCSAgICByZXR1cm4gXy5tYXAob2JqLCBmdW5jdGlvbih2YWx1ZSkgewoJICAgICAgcmV0dXJuIChpc0Z1bmMgPyBtZXRob2QgOiB2YWx1ZVttZXRob2RdKS5hcHBseSh2YWx1ZSwgYXJncyk7CgkgICAgfSk7CgkgIH07CgoJICAvLyBDb252ZW5pZW5jZSB2ZXJzaW9uIG9mIGEgY29tbW9uIHVzZSBjYXNlIG9mIGBtYXBgOiBmZXRjaGluZyBhIHByb3BlcnR5LgoJICBfLnBsdWNrID0gZnVuY3Rpb24ob2JqLCBrZXkpIHsKCSAgICByZXR1cm4gXy5tYXAob2JqLCBfLnByb3BlcnR5KGtleSkpOwoJICB9OwoKCSAgLy8gQ29udmVuaWVuY2UgdmVyc2lvbiBvZiBhIGNvbW1vbiB1c2UgY2FzZSBvZiBgZmlsdGVyYDogc2VsZWN0aW5nIG9ubHkgb2JqZWN0cwoJICAvLyBjb250YWluaW5nIHNwZWNpZmljIGBrZXk6dmFsdWVgIHBhaXJzLgoJICBfLndoZXJlID0gZnVuY3Rpb24ob2JqLCBhdHRycykgewoJICAgIHJldHVybiBfLmZpbHRlcihvYmosIF8ubWF0Y2hlcyhhdHRycykpOwoJICB9OwoKCSAgLy8gQ29udmVuaWVuY2UgdmVyc2lvbiBvZiBhIGNvbW1vbiB1c2UgY2FzZSBvZiBgZmluZGA6IGdldHRpbmcgdGhlIGZpcnN0IG9iamVjdAoJICAvLyBjb250YWluaW5nIHNwZWNpZmljIGBrZXk6dmFsdWVgIHBhaXJzLgoJICBfLmZpbmRXaGVyZSA9IGZ1bmN0aW9uKG9iaiwgYXR0cnMpIHsKCSAgICByZXR1cm4gXy5maW5kKG9iaiwgXy5tYXRjaGVzKGF0dHJzKSk7CgkgIH07CgoJICAvLyBSZXR1cm4gdGhlIG1heGltdW0gZWxlbWVudCAob3IgZWxlbWVudC1iYXNlZCBjb21wdXRhdGlvbikuCgkgIF8ubWF4ID0gZnVuY3Rpb24ob2JqLCBpdGVyYXRlZSwgY29udGV4dCkgewoJICAgIHZhciByZXN1bHQgPSAtSW5maW5pdHksIGxhc3RDb21wdXRlZCA9IC1JbmZpbml0eSwKCSAgICAgICAgdmFsdWUsIGNvbXB1dGVkOwoJICAgIGlmIChpdGVyYXRlZSA9PSBudWxsICYmIG9iaiAhPSBudWxsKSB7CgkgICAgICBvYmogPSBvYmoubGVuZ3RoID09PSArb2JqLmxlbmd0aCA/IG9iaiA6IF8udmFsdWVzKG9iaik7CgkgICAgICBmb3IgKHZhciBpID0gMCwgbGVuZ3RoID0gb2JqLmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrKSB7CgkgICAgICAgIHZhbHVlID0gb2JqW2ldOwoJICAgICAgICBpZiAodmFsdWUgPiByZXN1bHQpIHsKCSAgICAgICAgICByZXN1bHQgPSB2YWx1ZTsKCSAgICAgICAgfQoJICAgICAgfQoJICAgIH0gZWxzZSB7CgkgICAgICBpdGVyYXRlZSA9IF8uaXRlcmF0ZWUoaXRlcmF0ZWUsIGNvbnRleHQpOwoJICAgICAgXy5lYWNoKG9iaiwgZnVuY3Rpb24odmFsdWUsIGluZGV4LCBsaXN0KSB7CgkgICAgICAgIGNvbXB1dGVkID0gaXRlcmF0ZWUodmFsdWUsIGluZGV4LCBsaXN0KTsKCSAgICAgICAgaWYgKGNvbXB1dGVkID4gbGFzdENvbXB1dGVkIHx8IGNvbXB1dGVkID09PSAtSW5maW5pdHkgJiYgcmVzdWx0ID09PSAtSW5maW5pdHkpIHsKCSAgICAgICAgICByZXN1bHQgPSB2YWx1ZTsKCSAgICAgICAgICBsYXN0Q29tcHV0ZWQgPSBjb21wdXRlZDsKCSAgICAgICAgfQoJICAgICAgfSk7CgkgICAgfQoJICAgIHJldHVybiByZXN1bHQ7CgkgIH07CgoJICAvLyBSZXR1cm4gdGhlIG1pbmltdW0gZWxlbWVudCAob3IgZWxlbWVudC1iYXNlZCBjb21wdXRhdGlvbikuCgkgIF8ubWluID0gZnVuY3Rpb24ob2JqLCBpdGVyYXRlZSwgY29udGV4dCkgewoJICAgIHZhciByZXN1bHQgPSBJbmZpbml0eSwgbGFzdENvbXB1dGVkID0gSW5maW5pdHksCgkgICAgICAgIHZhbHVlLCBjb21wdXRlZDsKCSAgICBpZiAoaXRlcmF0ZWUgPT0gbnVsbCAmJiBvYmogIT0gbnVsbCkgewoJICAgICAgb2JqID0gb2JqLmxlbmd0aCA9PT0gK29iai5sZW5ndGggPyBvYmogOiBfLnZhbHVlcyhvYmopOwoJICAgICAgZm9yICh2YXIgaSA9IDAsIGxlbmd0aCA9IG9iai5sZW5ndGg7IGkgPCBsZW5ndGg7IGkrKykgewoJICAgICAgICB2YWx1ZSA9IG9ialtpXTsKCSAgICAgICAgaWYgKHZhbHVlIDwgcmVzdWx0KSB7CgkgICAgICAgICAgcmVzdWx0ID0gdmFsdWU7CgkgICAgICAgIH0KCSAgICAgIH0KCSAgICB9IGVsc2UgewoJICAgICAgaXRlcmF0ZWUgPSBfLml0ZXJhdGVlKGl0ZXJhdGVlLCBjb250ZXh0KTsKCSAgICAgIF8uZWFjaChvYmosIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgbGlzdCkgewoJICAgICAgICBjb21wdXRlZCA9IGl0ZXJhdGVlKHZhbHVlLCBpbmRleCwgbGlzdCk7CgkgICAgICAgIGlmIChjb21wdXRlZCA8IGxhc3RDb21wdXRlZCB8fCBjb21wdXRlZCA9PT0gSW5maW5pdHkgJiYgcmVzdWx0ID09PSBJbmZpbml0eSkgewoJICAgICAgICAgIHJlc3VsdCA9IHZhbHVlOwoJICAgICAgICAgIGxhc3RDb21wdXRlZCA9IGNvbXB1dGVkOwoJICAgICAgICB9CgkgICAgICB9KTsKCSAgICB9CgkgICAgcmV0dXJuIHJlc3VsdDsKCSAgfTsKCgkgIC8vIFNodWZmbGUgYSBjb2xsZWN0aW9uLCB1c2luZyB0aGUgbW9kZXJuIHZlcnNpb24gb2YgdGhlCgkgIC8vIFtGaXNoZXItWWF0ZXMgc2h1ZmZsZV0oaHR0cDovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9GaXNoZXLigJNZYXRlc19zaHVmZmxlKS4KCSAgXy5zaHVmZmxlID0gZnVuY3Rpb24ob2JqKSB7CgkgICAgdmFyIHNldCA9IG9iaiAmJiBvYmoubGVuZ3RoID09PSArb2JqLmxlbmd0aCA/IG9iaiA6IF8udmFsdWVzKG9iaik7CgkgICAgdmFyIGxlbmd0aCA9IHNldC5sZW5ndGg7CgkgICAgdmFyIHNodWZmbGVkID0gQXJyYXkobGVuZ3RoKTsKCSAgICBmb3IgKHZhciBpbmRleCA9IDAsIHJhbmQ7IGluZGV4IDwgbGVuZ3RoOyBpbmRleCsrKSB7CgkgICAgICByYW5kID0gXy5yYW5kb20oMCwgaW5kZXgpOwoJICAgICAgaWYgKHJhbmQgIT09IGluZGV4KSBzaHVmZmxlZFtpbmRleF0gPSBzaHVmZmxlZFtyYW5kXTsKCSAgICAgIHNodWZmbGVkW3JhbmRdID0gc2V0W2luZGV4XTsKCSAgICB9CgkgICAgcmV0dXJuIHNodWZmbGVkOwoJICB9OwoKCSAgLy8gU2FtcGxlICoqbioqIHJhbmRvbSB2YWx1ZXMgZnJvbSBhIGNvbGxlY3Rpb24uCgkgIC8vIElmICoqbioqIGlzIG5vdCBzcGVjaWZpZWQsIHJldHVybnMgYSBzaW5nbGUgcmFuZG9tIGVsZW1lbnQuCgkgIC8vIFRoZSBpbnRlcm5hbCBgZ3VhcmRgIGFyZ3VtZW50IGFsbG93cyBpdCB0byB3b3JrIHdpdGggYG1hcGAuCgkgIF8uc2FtcGxlID0gZnVuY3Rpb24ob2JqLCBuLCBndWFyZCkgewoJICAgIGlmIChuID09IG51bGwgfHwgZ3VhcmQpIHsKCSAgICAgIGlmIChvYmoubGVuZ3RoICE9PSArb2JqLmxlbmd0aCkgb2JqID0gXy52YWx1ZXMob2JqKTsKCSAgICAgIHJldHVybiBvYmpbXy5yYW5kb20ob2JqLmxlbmd0aCAtIDEpXTsKCSAgICB9CgkgICAgcmV0dXJuIF8uc2h1ZmZsZShvYmopLnNsaWNlKDAsIE1hdGgubWF4KDAsIG4pKTsKCSAgfTsKCgkgIC8vIFNvcnQgdGhlIG9iamVjdCdzIHZhbHVlcyBieSBhIGNyaXRlcmlvbiBwcm9kdWNlZCBieSBhbiBpdGVyYXRlZS4KCSAgXy5zb3J0QnkgPSBmdW5jdGlvbihvYmosIGl0ZXJhdGVlLCBjb250ZXh0KSB7CgkgICAgaXRlcmF0ZWUgPSBfLml0ZXJhdGVlKGl0ZXJhdGVlLCBjb250ZXh0KTsKCSAgICByZXR1cm4gXy5wbHVjayhfLm1hcChvYmosIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgbGlzdCkgewoJICAgICAgcmV0dXJuIHsKCSAgICAgICAgdmFsdWU6IHZhbHVlLAoJICAgICAgICBpbmRleDogaW5kZXgsCgkgICAgICAgIGNyaXRlcmlhOiBpdGVyYXRlZSh2YWx1ZSwgaW5kZXgsIGxpc3QpCgkgICAgICB9OwoJICAgIH0pLnNvcnQoZnVuY3Rpb24obGVmdCwgcmlnaHQpIHsKCSAgICAgIHZhciBhID0gbGVmdC5jcml0ZXJpYTsKCSAgICAgIHZhciBiID0gcmlnaHQuY3JpdGVyaWE7CgkgICAgICBpZiAoYSAhPT0gYikgewoJICAgICAgICBpZiAoYSA+IGIgfHwgYSA9PT0gdm9pZCAwKSByZXR1cm4gMTsKCSAgICAgICAgaWYgKGEgPCBiIHx8IGIgPT09IHZvaWQgMCkgcmV0dXJuIC0xOwoJICAgICAgfQoJICAgICAgcmV0dXJuIGxlZnQuaW5kZXggLSByaWdodC5pbmRleDsKCSAgICB9KSwgJ3ZhbHVlJyk7CgkgIH07CgoJICAvLyBBbiBpbnRlcm5hbCBmdW5jdGlvbiB1c2VkIGZvciBhZ2dyZWdhdGUgImdyb3VwIGJ5IiBvcGVyYXRpb25zLgoJICB2YXIgZ3JvdXAgPSBmdW5jdGlvbihiZWhhdmlvcikgewoJICAgIHJldHVybiBmdW5jdGlvbihvYmosIGl0ZXJhdGVlLCBjb250ZXh0KSB7CgkgICAgICB2YXIgcmVzdWx0ID0ge307CgkgICAgICBpdGVyYXRlZSA9IF8uaXRlcmF0ZWUoaXRlcmF0ZWUsIGNvbnRleHQpOwoJICAgICAgXy5lYWNoKG9iaiwgZnVuY3Rpb24odmFsdWUsIGluZGV4KSB7CgkgICAgICAgIHZhciBrZXkgPSBpdGVyYXRlZSh2YWx1ZSwgaW5kZXgsIG9iaik7CgkgICAgICAgIGJlaGF2aW9yKHJlc3VsdCwgdmFsdWUsIGtleSk7CgkgICAgICB9KTsKCSAgICAgIHJldHVybiByZXN1bHQ7CgkgICAgfTsKCSAgfTsKCgkgIC8vIEdyb3VwcyB0aGUgb2JqZWN0J3MgdmFsdWVzIGJ5IGEgY3JpdGVyaW9uLiBQYXNzIGVpdGhlciBhIHN0cmluZyBhdHRyaWJ1dGUKCSAgLy8gdG8gZ3JvdXAgYnksIG9yIGEgZnVuY3Rpb24gdGhhdCByZXR1cm5zIHRoZSBjcml0ZXJpb24uCgkgIF8uZ3JvdXBCeSA9IGdyb3VwKGZ1bmN0aW9uKHJlc3VsdCwgdmFsdWUsIGtleSkgewoJICAgIGlmIChfLmhhcyhyZXN1bHQsIGtleSkpIHJlc3VsdFtrZXldLnB1c2godmFsdWUpOyBlbHNlIHJlc3VsdFtrZXldID0gW3ZhbHVlXTsKCSAgfSk7CgoJICAvLyBJbmRleGVzIHRoZSBvYmplY3QncyB2YWx1ZXMgYnkgYSBjcml0ZXJpb24sIHNpbWlsYXIgdG8gYGdyb3VwQnlgLCBidXQgZm9yCgkgIC8vIHdoZW4geW91IGtub3cgdGhhdCB5b3VyIGluZGV4IHZhbHVlcyB3aWxsIGJlIHVuaXF1ZS4KCSAgXy5pbmRleEJ5ID0gZ3JvdXAoZnVuY3Rpb24ocmVzdWx0LCB2YWx1ZSwga2V5KSB7CgkgICAgcmVzdWx0W2tleV0gPSB2YWx1ZTsKCSAgfSk7CgoJICAvLyBDb3VudHMgaW5zdGFuY2VzIG9mIGFuIG9iamVjdCB0aGF0IGdyb3VwIGJ5IGEgY2VydGFpbiBjcml0ZXJpb24uIFBhc3MKCSAgLy8gZWl0aGVyIGEgc3RyaW5nIGF0dHJpYnV0ZSB0byBjb3VudCBieSwgb3IgYSBmdW5jdGlvbiB0aGF0IHJldHVybnMgdGhlCgkgIC8vIGNyaXRlcmlvbi4KCSAgXy5jb3VudEJ5ID0gZ3JvdXAoZnVuY3Rpb24ocmVzdWx0LCB2YWx1ZSwga2V5KSB7CgkgICAgaWYgKF8uaGFzKHJlc3VsdCwga2V5KSkgcmVzdWx0W2tleV0rKzsgZWxzZSByZXN1bHRba2V5XSA9IDE7CgkgIH0pOwoKCSAgLy8gVXNlIGEgY29tcGFyYXRvciBmdW5jdGlvbiB0byBmaWd1cmUgb3V0IHRoZSBzbWFsbGVzdCBpbmRleCBhdCB3aGljaAoJICAvLyBhbiBvYmplY3Qgc2hvdWxkIGJlIGluc2VydGVkIHNvIGFzIHRvIG1haW50YWluIG9yZGVyLiBVc2VzIGJpbmFyeSBzZWFyY2guCgkgIF8uc29ydGVkSW5kZXggPSBmdW5jdGlvbihhcnJheSwgb2JqLCBpdGVyYXRlZSwgY29udGV4dCkgewoJICAgIGl0ZXJhdGVlID0gXy5pdGVyYXRlZShpdGVyYXRlZSwgY29udGV4dCwgMSk7CgkgICAgdmFyIHZhbHVlID0gaXRlcmF0ZWUob2JqKTsKCSAgICB2YXIgbG93ID0gMCwgaGlnaCA9IGFycmF5Lmxlbmd0aDsKCSAgICB3aGlsZSAobG93IDwgaGlnaCkgewoJICAgICAgdmFyIG1pZCA9IGxvdyArIGhpZ2ggPj4+IDE7CgkgICAgICBpZiAoaXRlcmF0ZWUoYXJyYXlbbWlkXSkgPCB2YWx1ZSkgbG93ID0gbWlkICsgMTsgZWxzZSBoaWdoID0gbWlkOwoJICAgIH0KCSAgICByZXR1cm4gbG93OwoJICB9OwoKCSAgLy8gU2FmZWx5IGNyZWF0ZSBhIHJlYWwsIGxpdmUgYXJyYXkgZnJvbSBhbnl0aGluZyBpdGVyYWJsZS4KCSAgXy50b0FycmF5ID0gZnVuY3Rpb24ob2JqKSB7CgkgICAgaWYgKCFvYmopIHJldHVybiBbXTsKCSAgICBpZiAoXy5pc0FycmF5KG9iaikpIHJldHVybiBzbGljZS5jYWxsKG9iaik7CgkgICAgaWYgKG9iai5sZW5ndGggPT09ICtvYmoubGVuZ3RoKSByZXR1cm4gXy5tYXAob2JqLCBfLmlkZW50aXR5KTsKCSAgICByZXR1cm4gXy52YWx1ZXMob2JqKTsKCSAgfTsKCgkgIC8vIFJldHVybiB0aGUgbnVtYmVyIG9mIGVsZW1lbnRzIGluIGFuIG9iamVjdC4KCSAgXy5zaXplID0gZnVuY3Rpb24ob2JqKSB7CgkgICAgaWYgKG9iaiA9PSBudWxsKSByZXR1cm4gMDsKCSAgICByZXR1cm4gb2JqLmxlbmd0aCA9PT0gK29iai5sZW5ndGggPyBvYmoubGVuZ3RoIDogXy5rZXlzKG9iaikubGVuZ3RoOwoJICB9OwoKCSAgLy8gU3BsaXQgYSBjb2xsZWN0aW9uIGludG8gdHdvIGFycmF5czogb25lIHdob3NlIGVsZW1lbnRzIGFsbCBzYXRpc2Z5IHRoZSBnaXZlbgoJICAvLyBwcmVkaWNhdGUsIGFuZCBvbmUgd2hvc2UgZWxlbWVudHMgYWxsIGRvIG5vdCBzYXRpc2Z5IHRoZSBwcmVkaWNhdGUuCgkgIF8ucGFydGl0aW9uID0gZnVuY3Rpb24ob2JqLCBwcmVkaWNhdGUsIGNvbnRleHQpIHsKCSAgICBwcmVkaWNhdGUgPSBfLml0ZXJhdGVlKHByZWRpY2F0ZSwgY29udGV4dCk7CgkgICAgdmFyIHBhc3MgPSBbXSwgZmFpbCA9IFtdOwoJICAgIF8uZWFjaChvYmosIGZ1bmN0aW9uKHZhbHVlLCBrZXksIG9iaikgewoJICAgICAgKHByZWRpY2F0ZSh2YWx1ZSwga2V5LCBvYmopID8gcGFzcyA6IGZhaWwpLnB1c2godmFsdWUpOwoJICAgIH0pOwoJICAgIHJldHVybiBbcGFzcywgZmFpbF07CgkgIH07CgoJICAvLyBBcnJheSBGdW5jdGlvbnMKCSAgLy8gLS0tLS0tLS0tLS0tLS0tCgoJICAvLyBHZXQgdGhlIGZpcnN0IGVsZW1lbnQgb2YgYW4gYXJyYXkuIFBhc3NpbmcgKipuKiogd2lsbCByZXR1cm4gdGhlIGZpcnN0IE4KCSAgLy8gdmFsdWVzIGluIHRoZSBhcnJheS4gQWxpYXNlZCBhcyBgaGVhZGAgYW5kIGB0YWtlYC4gVGhlICoqZ3VhcmQqKiBjaGVjawoJICAvLyBhbGxvd3MgaXQgdG8gd29yayB3aXRoIGBfLm1hcGAuCgkgIF8uZmlyc3QgPSBfLmhlYWQgPSBfLnRha2UgPSBmdW5jdGlvbihhcnJheSwgbiwgZ3VhcmQpIHsKCSAgICBpZiAoYXJyYXkgPT0gbnVsbCkgcmV0dXJuIHZvaWQgMDsKCSAgICBpZiAobiA9PSBudWxsIHx8IGd1YXJkKSByZXR1cm4gYXJyYXlbMF07CgkgICAgaWYgKG4gPCAwKSByZXR1cm4gW107CgkgICAgcmV0dXJuIHNsaWNlLmNhbGwoYXJyYXksIDAsIG4pOwoJICB9OwoKCSAgLy8gUmV0dXJucyBldmVyeXRoaW5nIGJ1dCB0aGUgbGFzdCBlbnRyeSBvZiB0aGUgYXJyYXkuIEVzcGVjaWFsbHkgdXNlZnVsIG9uCgkgIC8vIHRoZSBhcmd1bWVudHMgb2JqZWN0LiBQYXNzaW5nICoqbioqIHdpbGwgcmV0dXJuIGFsbCB0aGUgdmFsdWVzIGluCgkgIC8vIHRoZSBhcnJheSwgZXhjbHVkaW5nIHRoZSBsYXN0IE4uIFRoZSAqKmd1YXJkKiogY2hlY2sgYWxsb3dzIGl0IHRvIHdvcmsgd2l0aAoJICAvLyBgXy5tYXBgLgoJICBfLmluaXRpYWwgPSBmdW5jdGlvbihhcnJheSwgbiwgZ3VhcmQpIHsKCSAgICByZXR1cm4gc2xpY2UuY2FsbChhcnJheSwgMCwgTWF0aC5tYXgoMCwgYXJyYXkubGVuZ3RoIC0gKG4gPT0gbnVsbCB8fCBndWFyZCA/IDEgOiBuKSkpOwoJICB9OwoKCSAgLy8gR2V0IHRoZSBsYXN0IGVsZW1lbnQgb2YgYW4gYXJyYXkuIFBhc3NpbmcgKipuKiogd2lsbCByZXR1cm4gdGhlIGxhc3QgTgoJICAvLyB2YWx1ZXMgaW4gdGhlIGFycmF5LiBUaGUgKipndWFyZCoqIGNoZWNrIGFsbG93cyBpdCB0byB3b3JrIHdpdGggYF8ubWFwYC4KCSAgXy5sYXN0ID0gZnVuY3Rpb24oYXJyYXksIG4sIGd1YXJkKSB7CgkgICAgaWYgKGFycmF5ID09IG51bGwpIHJldHVybiB2b2lkIDA7CgkgICAgaWYgKG4gPT0gbnVsbCB8fCBndWFyZCkgcmV0dXJuIGFycmF5W2FycmF5Lmxlbmd0aCAtIDFdOwoJICAgIHJldHVybiBzbGljZS5jYWxsKGFycmF5LCBNYXRoLm1heChhcnJheS5sZW5ndGggLSBuLCAwKSk7CgkgIH07CgoJICAvLyBSZXR1cm5zIGV2ZXJ5dGhpbmcgYnV0IHRoZSBmaXJzdCBlbnRyeSBvZiB0aGUgYXJyYXkuIEFsaWFzZWQgYXMgYHRhaWxgIGFuZCBgZHJvcGAuCgkgIC8vIEVzcGVjaWFsbHkgdXNlZnVsIG9uIHRoZSBhcmd1bWVudHMgb2JqZWN0LiBQYXNzaW5nIGFuICoqbioqIHdpbGwgcmV0dXJuCgkgIC8vIHRoZSByZXN0IE4gdmFsdWVzIGluIHRoZSBhcnJheS4gVGhlICoqZ3VhcmQqKgoJICAvLyBjaGVjayBhbGxvd3MgaXQgdG8gd29yayB3aXRoIGBfLm1hcGAuCgkgIF8ucmVzdCA9IF8udGFpbCA9IF8uZHJvcCA9IGZ1bmN0aW9uKGFycmF5LCBuLCBndWFyZCkgewoJICAgIHJldHVybiBzbGljZS5jYWxsKGFycmF5LCBuID09IG51bGwgfHwgZ3VhcmQgPyAxIDogbik7CgkgIH07CgoJICAvLyBUcmltIG91dCBhbGwgZmFsc3kgdmFsdWVzIGZyb20gYW4gYXJyYXkuCgkgIF8uY29tcGFjdCA9IGZ1bmN0aW9uKGFycmF5KSB7CgkgICAgcmV0dXJuIF8uZmlsdGVyKGFycmF5LCBfLmlkZW50aXR5KTsKCSAgfTsKCgkgIC8vIEludGVybmFsIGltcGxlbWVudGF0aW9uIG9mIGEgcmVjdXJzaXZlIGBmbGF0dGVuYCBmdW5jdGlvbi4KCSAgdmFyIGZsYXR0ZW4gPSBmdW5jdGlvbihpbnB1dCwgc2hhbGxvdywgc3RyaWN0LCBvdXRwdXQpIHsKCSAgICBpZiAoc2hhbGxvdyAmJiBfLmV2ZXJ5KGlucHV0LCBfLmlzQXJyYXkpKSB7CgkgICAgICByZXR1cm4gY29uY2F0LmFwcGx5KG91dHB1dCwgaW5wdXQpOwoJICAgIH0KCSAgICBmb3IgKHZhciBpID0gMCwgbGVuZ3RoID0gaW5wdXQubGVuZ3RoOyBpIDwgbGVuZ3RoOyBpKyspIHsKCSAgICAgIHZhciB2YWx1ZSA9IGlucHV0W2ldOwoJICAgICAgaWYgKCFfLmlzQXJyYXkodmFsdWUpICYmICFfLmlzQXJndW1lbnRzKHZhbHVlKSkgewoJICAgICAgICBpZiAoIXN0cmljdCkgb3V0cHV0LnB1c2godmFsdWUpOwoJICAgICAgfSBlbHNlIGlmIChzaGFsbG93KSB7CgkgICAgICAgIHB1c2guYXBwbHkob3V0cHV0LCB2YWx1ZSk7CgkgICAgICB9IGVsc2UgewoJICAgICAgICBmbGF0dGVuKHZhbHVlLCBzaGFsbG93LCBzdHJpY3QsIG91dHB1dCk7CgkgICAgICB9CgkgICAgfQoJICAgIHJldHVybiBvdXRwdXQ7CgkgIH07CgoJICAvLyBGbGF0dGVuIG91dCBhbiBhcnJheSwgZWl0aGVyIHJlY3Vyc2l2ZWx5IChieSBkZWZhdWx0KSwgb3IganVzdCBvbmUgbGV2ZWwuCgkgIF8uZmxhdHRlbiA9IGZ1bmN0aW9uKGFycmF5LCBzaGFsbG93KSB7CgkgICAgcmV0dXJuIGZsYXR0ZW4oYXJyYXksIHNoYWxsb3csIGZhbHNlLCBbXSk7CgkgIH07CgoJICAvLyBSZXR1cm4gYSB2ZXJzaW9uIG9mIHRoZSBhcnJheSB0aGF0IGRvZXMgbm90IGNvbnRhaW4gdGhlIHNwZWNpZmllZCB2YWx1ZShzKS4KCSAgXy53aXRob3V0ID0gZnVuY3Rpb24oYXJyYXkpIHsKCSAgICByZXR1cm4gXy5kaWZmZXJlbmNlKGFycmF5LCBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSkpOwoJICB9OwoKCSAgLy8gUHJvZHVjZSBhIGR1cGxpY2F0ZS1mcmVlIHZlcnNpb24gb2YgdGhlIGFycmF5LiBJZiB0aGUgYXJyYXkgaGFzIGFscmVhZHkKCSAgLy8gYmVlbiBzb3J0ZWQsIHlvdSBoYXZlIHRoZSBvcHRpb24gb2YgdXNpbmcgYSBmYXN0ZXIgYWxnb3JpdGhtLgoJICAvLyBBbGlhc2VkIGFzIGB1bmlxdWVgLgoJICBfLnVuaXEgPSBfLnVuaXF1ZSA9IGZ1bmN0aW9uKGFycmF5LCBpc1NvcnRlZCwgaXRlcmF0ZWUsIGNvbnRleHQpIHsKCSAgICBpZiAoYXJyYXkgPT0gbnVsbCkgcmV0dXJuIFtdOwoJICAgIGlmICghXy5pc0Jvb2xlYW4oaXNTb3J0ZWQpKSB7CgkgICAgICBjb250ZXh0ID0gaXRlcmF0ZWU7CgkgICAgICBpdGVyYXRlZSA9IGlzU29ydGVkOwoJICAgICAgaXNTb3J0ZWQgPSBmYWxzZTsKCSAgICB9CgkgICAgaWYgKGl0ZXJhdGVlICE9IG51bGwpIGl0ZXJhdGVlID0gXy5pdGVyYXRlZShpdGVyYXRlZSwgY29udGV4dCk7CgkgICAgdmFyIHJlc3VsdCA9IFtdOwoJICAgIHZhciBzZWVuID0gW107CgkgICAgZm9yICh2YXIgaSA9IDAsIGxlbmd0aCA9IGFycmF5Lmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrKSB7CgkgICAgICB2YXIgdmFsdWUgPSBhcnJheVtpXTsKCSAgICAgIGlmIChpc1NvcnRlZCkgewoJICAgICAgICBpZiAoIWkgfHwgc2VlbiAhPT0gdmFsdWUpIHJlc3VsdC5wdXNoKHZhbHVlKTsKCSAgICAgICAgc2VlbiA9IHZhbHVlOwoJICAgICAgfSBlbHNlIGlmIChpdGVyYXRlZSkgewoJICAgICAgICB2YXIgY29tcHV0ZWQgPSBpdGVyYXRlZSh2YWx1ZSwgaSwgYXJyYXkpOwoJICAgICAgICBpZiAoXy5pbmRleE9mKHNlZW4sIGNvbXB1dGVkKSA8IDApIHsKCSAgICAgICAgICBzZWVuLnB1c2goY29tcHV0ZWQpOwoJICAgICAgICAgIHJlc3VsdC5wdXNoKHZhbHVlKTsKCSAgICAgICAgfQoJICAgICAgfSBlbHNlIGlmIChfLmluZGV4T2YocmVzdWx0LCB2YWx1ZSkgPCAwKSB7CgkgICAgICAgIHJlc3VsdC5wdXNoKHZhbHVlKTsKCSAgICAgIH0KCSAgICB9CgkgICAgcmV0dXJuIHJlc3VsdDsKCSAgfTsKCgkgIC8vIFByb2R1Y2UgYW4gYXJyYXkgdGhhdCBjb250YWlucyB0aGUgdW5pb246IGVhY2ggZGlzdGluY3QgZWxlbWVudCBmcm9tIGFsbCBvZgoJICAvLyB0aGUgcGFzc2VkLWluIGFycmF5cy4KCSAgXy51bmlvbiA9IGZ1bmN0aW9uKCkgewoJICAgIHJldHVybiBfLnVuaXEoZmxhdHRlbihhcmd1bWVudHMsIHRydWUsIHRydWUsIFtdKSk7CgkgIH07CgoJICAvLyBQcm9kdWNlIGFuIGFycmF5IHRoYXQgY29udGFpbnMgZXZlcnkgaXRlbSBzaGFyZWQgYmV0d2VlbiBhbGwgdGhlCgkgIC8vIHBhc3NlZC1pbiBhcnJheXMuCgkgIF8uaW50ZXJzZWN0aW9uID0gZnVuY3Rpb24oYXJyYXkpIHsKCSAgICBpZiAoYXJyYXkgPT0gbnVsbCkgcmV0dXJuIFtdOwoJICAgIHZhciByZXN1bHQgPSBbXTsKCSAgICB2YXIgYXJnc0xlbmd0aCA9IGFyZ3VtZW50cy5sZW5ndGg7CgkgICAgZm9yICh2YXIgaSA9IDAsIGxlbmd0aCA9IGFycmF5Lmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrKSB7CgkgICAgICB2YXIgaXRlbSA9IGFycmF5W2ldOwoJICAgICAgaWYgKF8uY29udGFpbnMocmVzdWx0LCBpdGVtKSkgY29udGludWU7CgkgICAgICBmb3IgKHZhciBqID0gMTsgaiA8IGFyZ3NMZW5ndGg7IGorKykgewoJICAgICAgICBpZiAoIV8uY29udGFpbnMoYXJndW1lbnRzW2pdLCBpdGVtKSkgYnJlYWs7CgkgICAgICB9CgkgICAgICBpZiAoaiA9PT0gYXJnc0xlbmd0aCkgcmVzdWx0LnB1c2goaXRlbSk7CgkgICAgfQoJICAgIHJldHVybiByZXN1bHQ7CgkgIH07CgoJICAvLyBUYWtlIHRoZSBkaWZmZXJlbmNlIGJldHdlZW4gb25lIGFycmF5IGFuZCBhIG51bWJlciBvZiBvdGhlciBhcnJheXMuCgkgIC8vIE9ubHkgdGhlIGVsZW1lbnRzIHByZXNlbnQgaW4ganVzdCB0aGUgZmlyc3QgYXJyYXkgd2lsbCByZW1haW4uCgkgIF8uZGlmZmVyZW5jZSA9IGZ1bmN0aW9uKGFycmF5KSB7CgkgICAgdmFyIHJlc3QgPSBmbGF0dGVuKHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSwgdHJ1ZSwgdHJ1ZSwgW10pOwoJICAgIHJldHVybiBfLmZpbHRlcihhcnJheSwgZnVuY3Rpb24odmFsdWUpewoJICAgICAgcmV0dXJuICFfLmNvbnRhaW5zKHJlc3QsIHZhbHVlKTsKCSAgICB9KTsKCSAgfTsKCgkgIC8vIFppcCB0b2dldGhlciBtdWx0aXBsZSBsaXN0cyBpbnRvIGEgc2luZ2xlIGFycmF5IC0tIGVsZW1lbnRzIHRoYXQgc2hhcmUKCSAgLy8gYW4gaW5kZXggZ28gdG9nZXRoZXIuCgkgIF8uemlwID0gZnVuY3Rpb24oYXJyYXkpIHsKCSAgICBpZiAoYXJyYXkgPT0gbnVsbCkgcmV0dXJuIFtdOwoJICAgIHZhciBsZW5ndGggPSBfLm1heChhcmd1bWVudHMsICdsZW5ndGgnKS5sZW5ndGg7CgkgICAgdmFyIHJlc3VsdHMgPSBBcnJheShsZW5ndGgpOwoJICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKCSAgICAgIHJlc3VsdHNbaV0gPSBfLnBsdWNrKGFyZ3VtZW50cywgaSk7CgkgICAgfQoJICAgIHJldHVybiByZXN1bHRzOwoJICB9OwoKCSAgLy8gQ29udmVydHMgbGlzdHMgaW50byBvYmplY3RzLiBQYXNzIGVpdGhlciBhIHNpbmdsZSBhcnJheSBvZiBgW2tleSwgdmFsdWVdYAoJICAvLyBwYWlycywgb3IgdHdvIHBhcmFsbGVsIGFycmF5cyBvZiB0aGUgc2FtZSBsZW5ndGggLS0gb25lIG9mIGtleXMsIGFuZCBvbmUgb2YKCSAgLy8gdGhlIGNvcnJlc3BvbmRpbmcgdmFsdWVzLgoJICBfLm9iamVjdCA9IGZ1bmN0aW9uKGxpc3QsIHZhbHVlcykgewoJICAgIGlmIChsaXN0ID09IG51bGwpIHJldHVybiB7fTsKCSAgICB2YXIgcmVzdWx0ID0ge307CgkgICAgZm9yICh2YXIgaSA9IDAsIGxlbmd0aCA9IGxpc3QubGVuZ3RoOyBpIDwgbGVuZ3RoOyBpKyspIHsKCSAgICAgIGlmICh2YWx1ZXMpIHsKCSAgICAgICAgcmVzdWx0W2xpc3RbaV1dID0gdmFsdWVzW2ldOwoJICAgICAgfSBlbHNlIHsKCSAgICAgICAgcmVzdWx0W2xpc3RbaV1bMF1dID0gbGlzdFtpXVsxXTsKCSAgICAgIH0KCSAgICB9CgkgICAgcmV0dXJuIHJlc3VsdDsKCSAgfTsKCgkgIC8vIFJldHVybiB0aGUgcG9zaXRpb24gb2YgdGhlIGZpcnN0IG9jY3VycmVuY2Ugb2YgYW4gaXRlbSBpbiBhbiBhcnJheSwKCSAgLy8gb3IgLTEgaWYgdGhlIGl0ZW0gaXMgbm90IGluY2x1ZGVkIGluIHRoZSBhcnJheS4KCSAgLy8gSWYgdGhlIGFycmF5IGlzIGxhcmdlIGFuZCBhbHJlYWR5IGluIHNvcnQgb3JkZXIsIHBhc3MgYHRydWVgCgkgIC8vIGZvciAqKmlzU29ydGVkKiogdG8gdXNlIGJpbmFyeSBzZWFyY2guCgkgIF8uaW5kZXhPZiA9IGZ1bmN0aW9uKGFycmF5LCBpdGVtLCBpc1NvcnRlZCkgewoJICAgIGlmIChhcnJheSA9PSBudWxsKSByZXR1cm4gLTE7CgkgICAgdmFyIGkgPSAwLCBsZW5ndGggPSBhcnJheS5sZW5ndGg7CgkgICAgaWYgKGlzU29ydGVkKSB7CgkgICAgICBpZiAodHlwZW9mIGlzU29ydGVkID09ICdudW1iZXInKSB7CgkgICAgICAgIGkgPSBpc1NvcnRlZCA8IDAgPyBNYXRoLm1heCgwLCBsZW5ndGggKyBpc1NvcnRlZCkgOiBpc1NvcnRlZDsKCSAgICAgIH0gZWxzZSB7CgkgICAgICAgIGkgPSBfLnNvcnRlZEluZGV4KGFycmF5LCBpdGVtKTsKCSAgICAgICAgcmV0dXJuIGFycmF5W2ldID09PSBpdGVtID8gaSA6IC0xOwoJICAgICAgfQoJICAgIH0KCSAgICBmb3IgKDsgaSA8IGxlbmd0aDsgaSsrKSBpZiAoYXJyYXlbaV0gPT09IGl0ZW0pIHJldHVybiBpOwoJICAgIHJldHVybiAtMTsKCSAgfTsKCgkgIF8ubGFzdEluZGV4T2YgPSBmdW5jdGlvbihhcnJheSwgaXRlbSwgZnJvbSkgewoJICAgIGlmIChhcnJheSA9PSBudWxsKSByZXR1cm4gLTE7CgkgICAgdmFyIGlkeCA9IGFycmF5Lmxlbmd0aDsKCSAgICBpZiAodHlwZW9mIGZyb20gPT0gJ251bWJlcicpIHsKCSAgICAgIGlkeCA9IGZyb20gPCAwID8gaWR4ICsgZnJvbSArIDEgOiBNYXRoLm1pbihpZHgsIGZyb20gKyAxKTsKCSAgICB9CgkgICAgd2hpbGUgKC0taWR4ID49IDApIGlmIChhcnJheVtpZHhdID09PSBpdGVtKSByZXR1cm4gaWR4OwoJICAgIHJldHVybiAtMTsKCSAgfTsKCgkgIC8vIEdlbmVyYXRlIGFuIGludGVnZXIgQXJyYXkgY29udGFpbmluZyBhbiBhcml0aG1ldGljIHByb2dyZXNzaW9uLiBBIHBvcnQgb2YKCSAgLy8gdGhlIG5hdGl2ZSBQeXRob24gYHJhbmdlKClgIGZ1bmN0aW9uLiBTZWUKCSAgLy8gW3RoZSBQeXRob24gZG9jdW1lbnRhdGlvbl0oaHR0cDovL2RvY3MucHl0aG9uLm9yZy9saWJyYXJ5L2Z1bmN0aW9ucy5odG1sI3JhbmdlKS4KCSAgXy5yYW5nZSA9IGZ1bmN0aW9uKHN0YXJ0LCBzdG9wLCBzdGVwKSB7CgkgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPD0gMSkgewoJICAgICAgc3RvcCA9IHN0YXJ0IHx8IDA7CgkgICAgICBzdGFydCA9IDA7CgkgICAgfQoJICAgIHN0ZXAgPSBzdGVwIHx8IDE7CgoJICAgIHZhciBsZW5ndGggPSBNYXRoLm1heChNYXRoLmNlaWwoKHN0b3AgLSBzdGFydCkgLyBzdGVwKSwgMCk7CgkgICAgdmFyIHJhbmdlID0gQXJyYXkobGVuZ3RoKTsKCgkgICAgZm9yICh2YXIgaWR4ID0gMDsgaWR4IDwgbGVuZ3RoOyBpZHgrKywgc3RhcnQgKz0gc3RlcCkgewoJICAgICAgcmFuZ2VbaWR4XSA9IHN0YXJ0OwoJICAgIH0KCgkgICAgcmV0dXJuIHJhbmdlOwoJICB9OwoKCSAgLy8gRnVuY3Rpb24gKGFoZW0pIEZ1bmN0aW9ucwoJICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0KCgkgIC8vIFJldXNhYmxlIGNvbnN0cnVjdG9yIGZ1bmN0aW9uIGZvciBwcm90b3R5cGUgc2V0dGluZy4KCSAgdmFyIEN0b3IgPSBmdW5jdGlvbigpe307CgoJICAvLyBDcmVhdGUgYSBmdW5jdGlvbiBib3VuZCB0byBhIGdpdmVuIG9iamVjdCAoYXNzaWduaW5nIGB0aGlzYCwgYW5kIGFyZ3VtZW50cywKCSAgLy8gb3B0aW9uYWxseSkuIERlbGVnYXRlcyB0byAqKkVDTUFTY3JpcHQgNSoqJ3MgbmF0aXZlIGBGdW5jdGlvbi5iaW5kYCBpZgoJICAvLyBhdmFpbGFibGUuCgkgIF8uYmluZCA9IGZ1bmN0aW9uKGZ1bmMsIGNvbnRleHQpIHsKCSAgICB2YXIgYXJncywgYm91bmQ7CgkgICAgaWYgKG5hdGl2ZUJpbmQgJiYgZnVuYy5iaW5kID09PSBuYXRpdmVCaW5kKSByZXR1cm4gbmF0aXZlQmluZC5hcHBseShmdW5jLCBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSkpOwoJICAgIGlmICghXy5pc0Z1bmN0aW9uKGZ1bmMpKSB0aHJvdyBuZXcgVHlwZUVycm9yKCdCaW5kIG11c3QgYmUgY2FsbGVkIG9uIGEgZnVuY3Rpb24nKTsKCSAgICBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDIpOwoJICAgIGJvdW5kID0gZnVuY3Rpb24oKSB7CgkgICAgICBpZiAoISh0aGlzIGluc3RhbmNlb2YgYm91bmQpKSByZXR1cm4gZnVuYy5hcHBseShjb250ZXh0LCBhcmdzLmNvbmNhdChzbGljZS5jYWxsKGFyZ3VtZW50cykpKTsKCSAgICAgIEN0b3IucHJvdG90eXBlID0gZnVuYy5wcm90b3R5cGU7CgkgICAgICB2YXIgc2VsZiA9IG5ldyBDdG9yOwoJICAgICAgQ3Rvci5wcm90b3R5cGUgPSBudWxsOwoJICAgICAgdmFyIHJlc3VsdCA9IGZ1bmMuYXBwbHkoc2VsZiwgYXJncy5jb25jYXQoc2xpY2UuY2FsbChhcmd1bWVudHMpKSk7CgkgICAgICBpZiAoXy5pc09iamVjdChyZXN1bHQpKSByZXR1cm4gcmVzdWx0OwoJICAgICAgcmV0dXJuIHNlbGY7CgkgICAgfTsKCSAgICByZXR1cm4gYm91bmQ7CgkgIH07CgoJICAvLyBQYXJ0aWFsbHkgYXBwbHkgYSBmdW5jdGlvbiBieSBjcmVhdGluZyBhIHZlcnNpb24gdGhhdCBoYXMgaGFkIHNvbWUgb2YgaXRzCgkgIC8vIGFyZ3VtZW50cyBwcmUtZmlsbGVkLCB3aXRob3V0IGNoYW5naW5nIGl0cyBkeW5hbWljIGB0aGlzYCBjb250ZXh0LiBfIGFjdHMKCSAgLy8gYXMgYSBwbGFjZWhvbGRlciwgYWxsb3dpbmcgYW55IGNvbWJpbmF0aW9uIG9mIGFyZ3VtZW50cyB0byBiZSBwcmUtZmlsbGVkLgoJICBfLnBhcnRpYWwgPSBmdW5jdGlvbihmdW5jKSB7CgkgICAgdmFyIGJvdW5kQXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKCSAgICByZXR1cm4gZnVuY3Rpb24oKSB7CgkgICAgICB2YXIgcG9zaXRpb24gPSAwOwoJICAgICAgdmFyIGFyZ3MgPSBib3VuZEFyZ3Muc2xpY2UoKTsKCSAgICAgIGZvciAodmFyIGkgPSAwLCBsZW5ndGggPSBhcmdzLmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrKSB7CgkgICAgICAgIGlmIChhcmdzW2ldID09PSBfKSBhcmdzW2ldID0gYXJndW1lbnRzW3Bvc2l0aW9uKytdOwoJICAgICAgfQoJICAgICAgd2hpbGUgKHBvc2l0aW9uIDwgYXJndW1lbnRzLmxlbmd0aCkgYXJncy5wdXNoKGFyZ3VtZW50c1twb3NpdGlvbisrXSk7CgkgICAgICByZXR1cm4gZnVuYy5hcHBseSh0aGlzLCBhcmdzKTsKCSAgICB9OwoJICB9OwoKCSAgLy8gQmluZCBhIG51bWJlciBvZiBhbiBvYmplY3QncyBtZXRob2RzIHRvIHRoYXQgb2JqZWN0LiBSZW1haW5pbmcgYXJndW1lbnRzCgkgIC8vIGFyZSB0aGUgbWV0aG9kIG5hbWVzIHRvIGJlIGJvdW5kLiBVc2VmdWwgZm9yIGVuc3VyaW5nIHRoYXQgYWxsIGNhbGxiYWNrcwoJICAvLyBkZWZpbmVkIG9uIGFuIG9iamVjdCBiZWxvbmcgdG8gaXQuCgkgIF8uYmluZEFsbCA9IGZ1bmN0aW9uKG9iaikgewoJICAgIHZhciBpLCBsZW5ndGggPSBhcmd1bWVudHMubGVuZ3RoLCBrZXk7CgkgICAgaWYgKGxlbmd0aCA8PSAxKSB0aHJvdyBuZXcgRXJyb3IoJ2JpbmRBbGwgbXVzdCBiZSBwYXNzZWQgZnVuY3Rpb24gbmFtZXMnKTsKCSAgICBmb3IgKGkgPSAxOyBpIDwgbGVuZ3RoOyBpKyspIHsKCSAgICAgIGtleSA9IGFyZ3VtZW50c1tpXTsKCSAgICAgIG9ialtrZXldID0gXy5iaW5kKG9ialtrZXldLCBvYmopOwoJICAgIH0KCSAgICByZXR1cm4gb2JqOwoJICB9OwoKCSAgLy8gTWVtb2l6ZSBhbiBleHBlbnNpdmUgZnVuY3Rpb24gYnkgc3RvcmluZyBpdHMgcmVzdWx0cy4KCSAgXy5tZW1vaXplID0gZnVuY3Rpb24oZnVuYywgaGFzaGVyKSB7CgkgICAgdmFyIG1lbW9pemUgPSBmdW5jdGlvbihrZXkpIHsKCSAgICAgIHZhciBjYWNoZSA9IG1lbW9pemUuY2FjaGU7CgkgICAgICB2YXIgYWRkcmVzcyA9IGhhc2hlciA/IGhhc2hlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpIDoga2V5OwoJICAgICAgaWYgKCFfLmhhcyhjYWNoZSwgYWRkcmVzcykpIGNhY2hlW2FkZHJlc3NdID0gZnVuYy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoJICAgICAgcmV0dXJuIGNhY2hlW2FkZHJlc3NdOwoJICAgIH07CgkgICAgbWVtb2l6ZS5jYWNoZSA9IHt9OwoJICAgIHJldHVybiBtZW1vaXplOwoJICB9OwoKCSAgLy8gRGVsYXlzIGEgZnVuY3Rpb24gZm9yIHRoZSBnaXZlbiBudW1iZXIgb2YgbWlsbGlzZWNvbmRzLCBhbmQgdGhlbiBjYWxscwoJICAvLyBpdCB3aXRoIHRoZSBhcmd1bWVudHMgc3VwcGxpZWQuCgkgIF8uZGVsYXkgPSBmdW5jdGlvbihmdW5jLCB3YWl0KSB7CgkgICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cywgMik7CgkgICAgcmV0dXJuIHNldFRpbWVvdXQoZnVuY3Rpb24oKXsKCSAgICAgIHJldHVybiBmdW5jLmFwcGx5KG51bGwsIGFyZ3MpOwoJICAgIH0sIHdhaXQpOwoJICB9OwoKCSAgLy8gRGVmZXJzIGEgZnVuY3Rpb24sIHNjaGVkdWxpbmcgaXQgdG8gcnVuIGFmdGVyIHRoZSBjdXJyZW50IGNhbGwgc3RhY2sgaGFzCgkgIC8vIGNsZWFyZWQuCgkgIF8uZGVmZXIgPSBmdW5jdGlvbihmdW5jKSB7CgkgICAgcmV0dXJuIF8uZGVsYXkuYXBwbHkoXywgW2Z1bmMsIDFdLmNvbmNhdChzbGljZS5jYWxsKGFyZ3VtZW50cywgMSkpKTsKCSAgfTsKCgkgIC8vIFJldHVybnMgYSBmdW5jdGlvbiwgdGhhdCwgd2hlbiBpbnZva2VkLCB3aWxsIG9ubHkgYmUgdHJpZ2dlcmVkIGF0IG1vc3Qgb25jZQoJICAvLyBkdXJpbmcgYSBnaXZlbiB3aW5kb3cgb2YgdGltZS4gTm9ybWFsbHksIHRoZSB0aHJvdHRsZWQgZnVuY3Rpb24gd2lsbCBydW4KCSAgLy8gYXMgbXVjaCBhcyBpdCBjYW4sIHdpdGhvdXQgZXZlciBnb2luZyBtb3JlIHRoYW4gb25jZSBwZXIgYHdhaXRgIGR1cmF0aW9uOwoJICAvLyBidXQgaWYgeW91J2QgbGlrZSB0byBkaXNhYmxlIHRoZSBleGVjdXRpb24gb24gdGhlIGxlYWRpbmcgZWRnZSwgcGFzcwoJICAvLyBge2xlYWRpbmc6IGZhbHNlfWAuIFRvIGRpc2FibGUgZXhlY3V0aW9uIG9uIHRoZSB0cmFpbGluZyBlZGdlLCBkaXR0by4KCSAgXy50aHJvdHRsZSA9IGZ1bmN0aW9uKGZ1bmMsIHdhaXQsIG9wdGlvbnMpIHsKCSAgICB2YXIgY29udGV4dCwgYXJncywgcmVzdWx0OwoJICAgIHZhciB0aW1lb3V0ID0gbnVsbDsKCSAgICB2YXIgcHJldmlvdXMgPSAwOwoJICAgIGlmICghb3B0aW9ucykgb3B0aW9ucyA9IHt9OwoJICAgIHZhciBsYXRlciA9IGZ1bmN0aW9uKCkgewoJICAgICAgcHJldmlvdXMgPSBvcHRpb25zLmxlYWRpbmcgPT09IGZhbHNlID8gMCA6IF8ubm93KCk7CgkgICAgICB0aW1lb3V0ID0gbnVsbDsKCSAgICAgIHJlc3VsdCA9IGZ1bmMuYXBwbHkoY29udGV4dCwgYXJncyk7CgkgICAgICBpZiAoIXRpbWVvdXQpIGNvbnRleHQgPSBhcmdzID0gbnVsbDsKCSAgICB9OwoJICAgIHJldHVybiBmdW5jdGlvbigpIHsKCSAgICAgIHZhciBub3cgPSBfLm5vdygpOwoJICAgICAgaWYgKCFwcmV2aW91cyAmJiBvcHRpb25zLmxlYWRpbmcgPT09IGZhbHNlKSBwcmV2aW91cyA9IG5vdzsKCSAgICAgIHZhciByZW1haW5pbmcgPSB3YWl0IC0gKG5vdyAtIHByZXZpb3VzKTsKCSAgICAgIGNvbnRleHQgPSB0aGlzOwoJICAgICAgYXJncyA9IGFyZ3VtZW50czsKCSAgICAgIGlmIChyZW1haW5pbmcgPD0gMCB8fCByZW1haW5pbmcgPiB3YWl0KSB7CgkgICAgICAgIGNsZWFyVGltZW91dCh0aW1lb3V0KTsKCSAgICAgICAgdGltZW91dCA9IG51bGw7CgkgICAgICAgIHByZXZpb3VzID0gbm93OwoJICAgICAgICByZXN1bHQgPSBmdW5jLmFwcGx5KGNvbnRleHQsIGFyZ3MpOwoJICAgICAgICBpZiAoIXRpbWVvdXQpIGNvbnRleHQgPSBhcmdzID0gbnVsbDsKCSAgICAgIH0gZWxzZSBpZiAoIXRpbWVvdXQgJiYgb3B0aW9ucy50cmFpbGluZyAhPT0gZmFsc2UpIHsKCSAgICAgICAgdGltZW91dCA9IHNldFRpbWVvdXQobGF0ZXIsIHJlbWFpbmluZyk7CgkgICAgICB9CgkgICAgICByZXR1cm4gcmVzdWx0OwoJICAgIH07CgkgIH07CgoJICAvLyBSZXR1cm5zIGEgZnVuY3Rpb24sIHRoYXQsIGFzIGxvbmcgYXMgaXQgY29udGludWVzIHRvIGJlIGludm9rZWQsIHdpbGwgbm90CgkgIC8vIGJlIHRyaWdnZXJlZC4gVGhlIGZ1bmN0aW9uIHdpbGwgYmUgY2FsbGVkIGFmdGVyIGl0IHN0b3BzIGJlaW5nIGNhbGxlZCBmb3IKCSAgLy8gTiBtaWxsaXNlY29uZHMuIElmIGBpbW1lZGlhdGVgIGlzIHBhc3NlZCwgdHJpZ2dlciB0aGUgZnVuY3Rpb24gb24gdGhlCgkgIC8vIGxlYWRpbmcgZWRnZSwgaW5zdGVhZCBvZiB0aGUgdHJhaWxpbmcuCgkgIF8uZGVib3VuY2UgPSBmdW5jdGlvbihmdW5jLCB3YWl0LCBpbW1lZGlhdGUpIHsKCSAgICB2YXIgdGltZW91dCwgYXJncywgY29udGV4dCwgdGltZXN0YW1wLCByZXN1bHQ7CgoJICAgIHZhciBsYXRlciA9IGZ1bmN0aW9uKCkgewoJICAgICAgdmFyIGxhc3QgPSBfLm5vdygpIC0gdGltZXN0YW1wOwoKCSAgICAgIGlmIChsYXN0IDwgd2FpdCAmJiBsYXN0ID4gMCkgewoJICAgICAgICB0aW1lb3V0ID0gc2V0VGltZW91dChsYXRlciwgd2FpdCAtIGxhc3QpOwoJICAgICAgfSBlbHNlIHsKCSAgICAgICAgdGltZW91dCA9IG51bGw7CgkgICAgICAgIGlmICghaW1tZWRpYXRlKSB7CgkgICAgICAgICAgcmVzdWx0ID0gZnVuYy5hcHBseShjb250ZXh0LCBhcmdzKTsKCSAgICAgICAgICBpZiAoIXRpbWVvdXQpIGNvbnRleHQgPSBhcmdzID0gbnVsbDsKCSAgICAgICAgfQoJICAgICAgfQoJICAgIH07CgoJICAgIHJldHVybiBmdW5jdGlvbigpIHsKCSAgICAgIGNvbnRleHQgPSB0aGlzOwoJICAgICAgYXJncyA9IGFyZ3VtZW50czsKCSAgICAgIHRpbWVzdGFtcCA9IF8ubm93KCk7CgkgICAgICB2YXIgY2FsbE5vdyA9IGltbWVkaWF0ZSAmJiAhdGltZW91dDsKCSAgICAgIGlmICghdGltZW91dCkgdGltZW91dCA9IHNldFRpbWVvdXQobGF0ZXIsIHdhaXQpOwoJICAgICAgaWYgKGNhbGxOb3cpIHsKCSAgICAgICAgcmVzdWx0ID0gZnVuYy5hcHBseShjb250ZXh0LCBhcmdzKTsKCSAgICAgICAgY29udGV4dCA9IGFyZ3MgPSBudWxsOwoJICAgICAgfQoKCSAgICAgIHJldHVybiByZXN1bHQ7CgkgICAgfTsKCSAgfTsKCgkgIC8vIFJldHVybnMgdGhlIGZpcnN0IGZ1bmN0aW9uIHBhc3NlZCBhcyBhbiBhcmd1bWVudCB0byB0aGUgc2Vjb25kLAoJICAvLyBhbGxvd2luZyB5b3UgdG8gYWRqdXN0IGFyZ3VtZW50cywgcnVuIGNvZGUgYmVmb3JlIGFuZCBhZnRlciwgYW5kCgkgIC8vIGNvbmRpdGlvbmFsbHkgZXhlY3V0ZSB0aGUgb3JpZ2luYWwgZnVuY3Rpb24uCgkgIF8ud3JhcCA9IGZ1bmN0aW9uKGZ1bmMsIHdyYXBwZXIpIHsKCSAgICByZXR1cm4gXy5wYXJ0aWFsKHdyYXBwZXIsIGZ1bmMpOwoJICB9OwoKCSAgLy8gUmV0dXJucyBhIG5lZ2F0ZWQgdmVyc2lvbiBvZiB0aGUgcGFzc2VkLWluIHByZWRpY2F0ZS4KCSAgXy5uZWdhdGUgPSBmdW5jdGlvbihwcmVkaWNhdGUpIHsKCSAgICByZXR1cm4gZnVuY3Rpb24oKSB7CgkgICAgICByZXR1cm4gIXByZWRpY2F0ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoJICAgIH07CgkgIH07CgoJICAvLyBSZXR1cm5zIGEgZnVuY3Rpb24gdGhhdCBpcyB0aGUgY29tcG9zaXRpb24gb2YgYSBsaXN0IG9mIGZ1bmN0aW9ucywgZWFjaAoJICAvLyBjb25zdW1pbmcgdGhlIHJldHVybiB2YWx1ZSBvZiB0aGUgZnVuY3Rpb24gdGhhdCBmb2xsb3dzLgoJICBfLmNvbXBvc2UgPSBmdW5jdGlvbigpIHsKCSAgICB2YXIgYXJncyA9IGFyZ3VtZW50czsKCSAgICB2YXIgc3RhcnQgPSBhcmdzLmxlbmd0aCAtIDE7CgkgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewoJICAgICAgdmFyIGkgPSBzdGFydDsKCSAgICAgIHZhciByZXN1bHQgPSBhcmdzW3N0YXJ0XS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoJICAgICAgd2hpbGUgKGktLSkgcmVzdWx0ID0gYXJnc1tpXS5jYWxsKHRoaXMsIHJlc3VsdCk7CgkgICAgICByZXR1cm4gcmVzdWx0OwoJICAgIH07CgkgIH07CgoJICAvLyBSZXR1cm5zIGEgZnVuY3Rpb24gdGhhdCB3aWxsIG9ubHkgYmUgZXhlY3V0ZWQgYWZ0ZXIgYmVpbmcgY2FsbGVkIE4gdGltZXMuCgkgIF8uYWZ0ZXIgPSBmdW5jdGlvbih0aW1lcywgZnVuYykgewoJICAgIHJldHVybiBmdW5jdGlvbigpIHsKCSAgICAgIGlmICgtLXRpbWVzIDwgMSkgewoJICAgICAgICByZXR1cm4gZnVuYy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoJICAgICAgfQoJICAgIH07CgkgIH07CgoJICAvLyBSZXR1cm5zIGEgZnVuY3Rpb24gdGhhdCB3aWxsIG9ubHkgYmUgZXhlY3V0ZWQgYmVmb3JlIGJlaW5nIGNhbGxlZCBOIHRpbWVzLgoJICBfLmJlZm9yZSA9IGZ1bmN0aW9uKHRpbWVzLCBmdW5jKSB7CgkgICAgdmFyIG1lbW87CgkgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewoJICAgICAgaWYgKC0tdGltZXMgPiAwKSB7CgkgICAgICAgIG1lbW8gPSBmdW5jLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CgkgICAgICB9IGVsc2UgewoJICAgICAgICBmdW5jID0gbnVsbDsKCSAgICAgIH0KCSAgICAgIHJldHVybiBtZW1vOwoJICAgIH07CgkgIH07CgoJICAvLyBSZXR1cm5zIGEgZnVuY3Rpb24gdGhhdCB3aWxsIGJlIGV4ZWN1dGVkIGF0IG1vc3Qgb25lIHRpbWUsIG5vIG1hdHRlciBob3cKCSAgLy8gb2Z0ZW4geW91IGNhbGwgaXQuIFVzZWZ1bCBmb3IgbGF6eSBpbml0aWFsaXphdGlvbi4KCSAgXy5vbmNlID0gXy5wYXJ0aWFsKF8uYmVmb3JlLCAyKTsKCgkgIC8vIE9iamVjdCBGdW5jdGlvbnMKCSAgLy8gLS0tLS0tLS0tLS0tLS0tLQoKCSAgLy8gUmV0cmlldmUgdGhlIG5hbWVzIG9mIGFuIG9iamVjdCdzIHByb3BlcnRpZXMuCgkgIC8vIERlbGVnYXRlcyB0byAqKkVDTUFTY3JpcHQgNSoqJ3MgbmF0aXZlIGBPYmplY3Qua2V5c2AKCSAgXy5rZXlzID0gZnVuY3Rpb24ob2JqKSB7CgkgICAgaWYgKCFfLmlzT2JqZWN0KG9iaikpIHJldHVybiBbXTsKCSAgICBpZiAobmF0aXZlS2V5cykgcmV0dXJuIG5hdGl2ZUtleXMob2JqKTsKCSAgICB2YXIga2V5cyA9IFtdOwoJICAgIGZvciAodmFyIGtleSBpbiBvYmopIGlmIChfLmhhcyhvYmosIGtleSkpIGtleXMucHVzaChrZXkpOwoJICAgIHJldHVybiBrZXlzOwoJICB9OwoKCSAgLy8gUmV0cmlldmUgdGhlIHZhbHVlcyBvZiBhbiBvYmplY3QncyBwcm9wZXJ0aWVzLgoJICBfLnZhbHVlcyA9IGZ1bmN0aW9uKG9iaikgewoJICAgIHZhciBrZXlzID0gXy5rZXlzKG9iaik7CgkgICAgdmFyIGxlbmd0aCA9IGtleXMubGVuZ3RoOwoJICAgIHZhciB2YWx1ZXMgPSBBcnJheShsZW5ndGgpOwoJICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKCSAgICAgIHZhbHVlc1tpXSA9IG9ialtrZXlzW2ldXTsKCSAgICB9CgkgICAgcmV0dXJuIHZhbHVlczsKCSAgfTsKCgkgIC8vIENvbnZlcnQgYW4gb2JqZWN0IGludG8gYSBsaXN0IG9mIGBba2V5LCB2YWx1ZV1gIHBhaXJzLgoJICBfLnBhaXJzID0gZnVuY3Rpb24ob2JqKSB7CgkgICAgdmFyIGtleXMgPSBfLmtleXMob2JqKTsKCSAgICB2YXIgbGVuZ3RoID0ga2V5cy5sZW5ndGg7CgkgICAgdmFyIHBhaXJzID0gQXJyYXkobGVuZ3RoKTsKCSAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CgkgICAgICBwYWlyc1tpXSA9IFtrZXlzW2ldLCBvYmpba2V5c1tpXV1dOwoJICAgIH0KCSAgICByZXR1cm4gcGFpcnM7CgkgIH07CgoJICAvLyBJbnZlcnQgdGhlIGtleXMgYW5kIHZhbHVlcyBvZiBhbiBvYmplY3QuIFRoZSB2YWx1ZXMgbXVzdCBiZSBzZXJpYWxpemFibGUuCgkgIF8uaW52ZXJ0ID0gZnVuY3Rpb24ob2JqKSB7CgkgICAgdmFyIHJlc3VsdCA9IHt9OwoJICAgIHZhciBrZXlzID0gXy5rZXlzKG9iaik7CgkgICAgZm9yICh2YXIgaSA9IDAsIGxlbmd0aCA9IGtleXMubGVuZ3RoOyBpIDwgbGVuZ3RoOyBpKyspIHsKCSAgICAgIHJlc3VsdFtvYmpba2V5c1tpXV1dID0ga2V5c1tpXTsKCSAgICB9CgkgICAgcmV0dXJuIHJlc3VsdDsKCSAgfTsKCgkgIC8vIFJldHVybiBhIHNvcnRlZCBsaXN0IG9mIHRoZSBmdW5jdGlvbiBuYW1lcyBhdmFpbGFibGUgb24gdGhlIG9iamVjdC4KCSAgLy8gQWxpYXNlZCBhcyBgbWV0aG9kc2AKCSAgXy5mdW5jdGlvbnMgPSBfLm1ldGhvZHMgPSBmdW5jdGlvbihvYmopIHsKCSAgICB2YXIgbmFtZXMgPSBbXTsKCSAgICBmb3IgKHZhciBrZXkgaW4gb2JqKSB7CgkgICAgICBpZiAoXy5pc0Z1bmN0aW9uKG9ialtrZXldKSkgbmFtZXMucHVzaChrZXkpOwoJICAgIH0KCSAgICByZXR1cm4gbmFtZXMuc29ydCgpOwoJICB9OwoKCSAgLy8gRXh0ZW5kIGEgZ2l2ZW4gb2JqZWN0IHdpdGggYWxsIHRoZSBwcm9wZXJ0aWVzIGluIHBhc3NlZC1pbiBvYmplY3QocykuCgkgIF8uZXh0ZW5kID0gZnVuY3Rpb24ob2JqKSB7CgkgICAgaWYgKCFfLmlzT2JqZWN0KG9iaikpIHJldHVybiBvYmo7CgkgICAgdmFyIHNvdXJjZSwgcHJvcDsKCSAgICBmb3IgKHZhciBpID0gMSwgbGVuZ3RoID0gYXJndW1lbnRzLmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrKSB7CgkgICAgICBzb3VyY2UgPSBhcmd1bWVudHNbaV07CgkgICAgICBmb3IgKHByb3AgaW4gc291cmNlKSB7CgkgICAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKHNvdXJjZSwgcHJvcCkpIHsKCSAgICAgICAgICAgIG9ialtwcm9wXSA9IHNvdXJjZVtwcm9wXTsKCSAgICAgICAgfQoJICAgICAgfQoJICAgIH0KCSAgICByZXR1cm4gb2JqOwoJICB9OwoKCSAgLy8gUmV0dXJuIGEgY29weSBvZiB0aGUgb2JqZWN0IG9ubHkgY29udGFpbmluZyB0aGUgd2hpdGVsaXN0ZWQgcHJvcGVydGllcy4KCSAgXy5waWNrID0gZnVuY3Rpb24ob2JqLCBpdGVyYXRlZSwgY29udGV4dCkgewoJICAgIHZhciByZXN1bHQgPSB7fSwga2V5OwoJICAgIGlmIChvYmogPT0gbnVsbCkgcmV0dXJuIHJlc3VsdDsKCSAgICBpZiAoXy5pc0Z1bmN0aW9uKGl0ZXJhdGVlKSkgewoJICAgICAgaXRlcmF0ZWUgPSBjcmVhdGVDYWxsYmFjayhpdGVyYXRlZSwgY29udGV4dCk7CgkgICAgICBmb3IgKGtleSBpbiBvYmopIHsKCSAgICAgICAgdmFyIHZhbHVlID0gb2JqW2tleV07CgkgICAgICAgIGlmIChpdGVyYXRlZSh2YWx1ZSwga2V5LCBvYmopKSByZXN1bHRba2V5XSA9IHZhbHVlOwoJICAgICAgfQoJICAgIH0gZWxzZSB7CgkgICAgICB2YXIga2V5cyA9IGNvbmNhdC5hcHBseShbXSwgc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpKTsKCSAgICAgIG9iaiA9IG5ldyBPYmplY3Qob2JqKTsKCSAgICAgIGZvciAodmFyIGkgPSAwLCBsZW5ndGggPSBrZXlzLmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrKSB7CgkgICAgICAgIGtleSA9IGtleXNbaV07CgkgICAgICAgIGlmIChrZXkgaW4gb2JqKSByZXN1bHRba2V5XSA9IG9ialtrZXldOwoJICAgICAgfQoJICAgIH0KCSAgICByZXR1cm4gcmVzdWx0OwoJICB9OwoKCSAgIC8vIFJldHVybiBhIGNvcHkgb2YgdGhlIG9iamVjdCB3aXRob3V0IHRoZSBibGFja2xpc3RlZCBwcm9wZXJ0aWVzLgoJICBfLm9taXQgPSBmdW5jdGlvbihvYmosIGl0ZXJhdGVlLCBjb250ZXh0KSB7CgkgICAgaWYgKF8uaXNGdW5jdGlvbihpdGVyYXRlZSkpIHsKCSAgICAgIGl0ZXJhdGVlID0gXy5uZWdhdGUoaXRlcmF0ZWUpOwoJICAgIH0gZWxzZSB7CgkgICAgICB2YXIga2V5cyA9IF8ubWFwKGNvbmNhdC5hcHBseShbXSwgc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpKSwgU3RyaW5nKTsKCSAgICAgIGl0ZXJhdGVlID0gZnVuY3Rpb24odmFsdWUsIGtleSkgewoJICAgICAgICByZXR1cm4gIV8uY29udGFpbnMoa2V5cywga2V5KTsKCSAgICAgIH07CgkgICAgfQoJICAgIHJldHVybiBfLnBpY2sob2JqLCBpdGVyYXRlZSwgY29udGV4dCk7CgkgIH07CgoJICAvLyBGaWxsIGluIGEgZ2l2ZW4gb2JqZWN0IHdpdGggZGVmYXVsdCBwcm9wZXJ0aWVzLgoJICBfLmRlZmF1bHRzID0gZnVuY3Rpb24ob2JqKSB7CgkgICAgaWYgKCFfLmlzT2JqZWN0KG9iaikpIHJldHVybiBvYmo7CgkgICAgZm9yICh2YXIgaSA9IDEsIGxlbmd0aCA9IGFyZ3VtZW50cy5sZW5ndGg7IGkgPCBsZW5ndGg7IGkrKykgewoJICAgICAgdmFyIHNvdXJjZSA9IGFyZ3VtZW50c1tpXTsKCSAgICAgIGZvciAodmFyIHByb3AgaW4gc291cmNlKSB7CgkgICAgICAgIGlmIChvYmpbcHJvcF0gPT09IHZvaWQgMCkgb2JqW3Byb3BdID0gc291cmNlW3Byb3BdOwoJICAgICAgfQoJICAgIH0KCSAgICByZXR1cm4gb2JqOwoJICB9OwoKCSAgLy8gQ3JlYXRlIGEgKHNoYWxsb3ctY2xvbmVkKSBkdXBsaWNhdGUgb2YgYW4gb2JqZWN0LgoJICBfLmNsb25lID0gZnVuY3Rpb24ob2JqKSB7CgkgICAgaWYgKCFfLmlzT2JqZWN0KG9iaikpIHJldHVybiBvYmo7CgkgICAgcmV0dXJuIF8uaXNBcnJheShvYmopID8gb2JqLnNsaWNlKCkgOiBfLmV4dGVuZCh7fSwgb2JqKTsKCSAgfTsKCgkgIC8vIEludm9rZXMgaW50ZXJjZXB0b3Igd2l0aCB0aGUgb2JqLCBhbmQgdGhlbiByZXR1cm5zIG9iai4KCSAgLy8gVGhlIHByaW1hcnkgcHVycG9zZSBvZiB0aGlzIG1ldGhvZCBpcyB0byAidGFwIGludG8iIGEgbWV0aG9kIGNoYWluLCBpbgoJICAvLyBvcmRlciB0byBwZXJmb3JtIG9wZXJhdGlvbnMgb24gaW50ZXJtZWRpYXRlIHJlc3VsdHMgd2l0aGluIHRoZSBjaGFpbi4KCSAgXy50YXAgPSBmdW5jdGlvbihvYmosIGludGVyY2VwdG9yKSB7CgkgICAgaW50ZXJjZXB0b3Iob2JqKTsKCSAgICByZXR1cm4gb2JqOwoJICB9OwoKCSAgLy8gSW50ZXJuYWwgcmVjdXJzaXZlIGNvbXBhcmlzb24gZnVuY3Rpb24gZm9yIGBpc0VxdWFsYC4KCSAgdmFyIGVxID0gZnVuY3Rpb24oYSwgYiwgYVN0YWNrLCBiU3RhY2spIHsKCSAgICAvLyBJZGVudGljYWwgb2JqZWN0cyBhcmUgZXF1YWwuIGAwID09PSAtMGAsIGJ1dCB0aGV5IGFyZW4ndCBpZGVudGljYWwuCgkgICAgLy8gU2VlIHRoZSBbSGFybW9ueSBgZWdhbGAgcHJvcG9zYWxdKGh0dHA6Ly93aWtpLmVjbWFzY3JpcHQub3JnL2Rva3UucGhwP2lkPWhhcm1vbnk6ZWdhbCkuCgkgICAgaWYgKGEgPT09IGIpIHJldHVybiBhICE9PSAwIHx8IDEgLyBhID09PSAxIC8gYjsKCSAgICAvLyBBIHN0cmljdCBjb21wYXJpc29uIGlzIG5lY2Vzc2FyeSBiZWNhdXNlIGBudWxsID09IHVuZGVmaW5lZGAuCgkgICAgaWYgKGEgPT0gbnVsbCB8fCBiID09IG51bGwpIHJldHVybiBhID09PSBiOwoJICAgIC8vIFVud3JhcCBhbnkgd3JhcHBlZCBvYmplY3RzLgoJICAgIGlmIChhIGluc3RhbmNlb2YgXykgYSA9IGEuX3dyYXBwZWQ7CgkgICAgaWYgKGIgaW5zdGFuY2VvZiBfKSBiID0gYi5fd3JhcHBlZDsKCSAgICAvLyBDb21wYXJlIGBbW0NsYXNzXV1gIG5hbWVzLgoJICAgIHZhciBjbGFzc05hbWUgPSB0b1N0cmluZy5jYWxsKGEpOwoJICAgIGlmIChjbGFzc05hbWUgIT09IHRvU3RyaW5nLmNhbGwoYikpIHJldHVybiBmYWxzZTsKCSAgICBzd2l0Y2ggKGNsYXNzTmFtZSkgewoJICAgICAgLy8gU3RyaW5ncywgbnVtYmVycywgcmVndWxhciBleHByZXNzaW9ucywgZGF0ZXMsIGFuZCBib29sZWFucyBhcmUgY29tcGFyZWQgYnkgdmFsdWUuCgkgICAgICBjYXNlICdbb2JqZWN0IFJlZ0V4cF0nOgoJICAgICAgLy8gUmVnRXhwcyBhcmUgY29lcmNlZCB0byBzdHJpbmdzIGZvciBjb21wYXJpc29uIChOb3RlOiAnJyArIC9hL2kgPT09ICcvYS9pJykKCSAgICAgIGNhc2UgJ1tvYmplY3QgU3RyaW5nXSc6CgkgICAgICAgIC8vIFByaW1pdGl2ZXMgYW5kIHRoZWlyIGNvcnJlc3BvbmRpbmcgb2JqZWN0IHdyYXBwZXJzIGFyZSBlcXVpdmFsZW50OyB0aHVzLCBgIjUiYCBpcwoJICAgICAgICAvLyBlcXVpdmFsZW50IHRvIGBuZXcgU3RyaW5nKCI1IilgLgoJICAgICAgICByZXR1cm4gJycgKyBhID09PSAnJyArIGI7CgkgICAgICBjYXNlICdbb2JqZWN0IE51bWJlcl0nOgoJICAgICAgICAvLyBgTmFOYHMgYXJlIGVxdWl2YWxlbnQsIGJ1dCBub24tcmVmbGV4aXZlLgoJICAgICAgICAvLyBPYmplY3QoTmFOKSBpcyBlcXVpdmFsZW50IHRvIE5hTgoJICAgICAgICBpZiAoK2EgIT09ICthKSByZXR1cm4gK2IgIT09ICtiOwoJICAgICAgICAvLyBBbiBgZWdhbGAgY29tcGFyaXNvbiBpcyBwZXJmb3JtZWQgZm9yIG90aGVyIG51bWVyaWMgdmFsdWVzLgoJICAgICAgICByZXR1cm4gK2EgPT09IDAgPyAxIC8gK2EgPT09IDEgLyBiIDogK2EgPT09ICtiOwoJICAgICAgY2FzZSAnW29iamVjdCBEYXRlXSc6CgkgICAgICBjYXNlICdbb2JqZWN0IEJvb2xlYW5dJzoKCSAgICAgICAgLy8gQ29lcmNlIGRhdGVzIGFuZCBib29sZWFucyB0byBudW1lcmljIHByaW1pdGl2ZSB2YWx1ZXMuIERhdGVzIGFyZSBjb21wYXJlZCBieSB0aGVpcgoJICAgICAgICAvLyBtaWxsaXNlY29uZCByZXByZXNlbnRhdGlvbnMuIE5vdGUgdGhhdCBpbnZhbGlkIGRhdGVzIHdpdGggbWlsbGlzZWNvbmQgcmVwcmVzZW50YXRpb25zCgkgICAgICAgIC8vIG9mIGBOYU5gIGFyZSBub3QgZXF1aXZhbGVudC4KCSAgICAgICAgcmV0dXJuICthID09PSArYjsKCSAgICB9CgkgICAgaWYgKHR5cGVvZiBhICE9ICdvYmplY3QnIHx8IHR5cGVvZiBiICE9ICdvYmplY3QnKSByZXR1cm4gZmFsc2U7CgkgICAgLy8gQXNzdW1lIGVxdWFsaXR5IGZvciBjeWNsaWMgc3RydWN0dXJlcy4gVGhlIGFsZ29yaXRobSBmb3IgZGV0ZWN0aW5nIGN5Y2xpYwoJICAgIC8vIHN0cnVjdHVyZXMgaXMgYWRhcHRlZCBmcm9tIEVTIDUuMSBzZWN0aW9uIDE1LjEyLjMsIGFic3RyYWN0IG9wZXJhdGlvbiBgSk9gLgoJICAgIHZhciBsZW5ndGggPSBhU3RhY2subGVuZ3RoOwoJICAgIHdoaWxlIChsZW5ndGgtLSkgewoJICAgICAgLy8gTGluZWFyIHNlYXJjaC4gUGVyZm9ybWFuY2UgaXMgaW52ZXJzZWx5IHByb3BvcnRpb25hbCB0byB0aGUgbnVtYmVyIG9mCgkgICAgICAvLyB1bmlxdWUgbmVzdGVkIHN0cnVjdHVyZXMuCgkgICAgICBpZiAoYVN0YWNrW2xlbmd0aF0gPT09IGEpIHJldHVybiBiU3RhY2tbbGVuZ3RoXSA9PT0gYjsKCSAgICB9CgkgICAgLy8gT2JqZWN0cyB3aXRoIGRpZmZlcmVudCBjb25zdHJ1Y3RvcnMgYXJlIG5vdCBlcXVpdmFsZW50LCBidXQgYE9iamVjdGBzCgkgICAgLy8gZnJvbSBkaWZmZXJlbnQgZnJhbWVzIGFyZS4KCSAgICB2YXIgYUN0b3IgPSBhLmNvbnN0cnVjdG9yLCBiQ3RvciA9IGIuY29uc3RydWN0b3I7CgkgICAgaWYgKAoJICAgICAgYUN0b3IgIT09IGJDdG9yICYmCgkgICAgICAvLyBIYW5kbGUgT2JqZWN0LmNyZWF0ZSh4KSBjYXNlcwoJICAgICAgJ2NvbnN0cnVjdG9yJyBpbiBhICYmICdjb25zdHJ1Y3RvcicgaW4gYiAmJgoJICAgICAgIShfLmlzRnVuY3Rpb24oYUN0b3IpICYmIGFDdG9yIGluc3RhbmNlb2YgYUN0b3IgJiYKCSAgICAgICAgXy5pc0Z1bmN0aW9uKGJDdG9yKSAmJiBiQ3RvciBpbnN0YW5jZW9mIGJDdG9yKQoJICAgICkgewoJICAgICAgcmV0dXJuIGZhbHNlOwoJICAgIH0KCSAgICAvLyBBZGQgdGhlIGZpcnN0IG9iamVjdCB0byB0aGUgc3RhY2sgb2YgdHJhdmVyc2VkIG9iamVjdHMuCgkgICAgYVN0YWNrLnB1c2goYSk7CgkgICAgYlN0YWNrLnB1c2goYik7CgkgICAgdmFyIHNpemUsIHJlc3VsdDsKCSAgICAvLyBSZWN1cnNpdmVseSBjb21wYXJlIG9iamVjdHMgYW5kIGFycmF5cy4KCSAgICBpZiAoY2xhc3NOYW1lID09PSAnW29iamVjdCBBcnJheV0nKSB7CgkgICAgICAvLyBDb21wYXJlIGFycmF5IGxlbmd0aHMgdG8gZGV0ZXJtaW5lIGlmIGEgZGVlcCBjb21wYXJpc29uIGlzIG5lY2Vzc2FyeS4KCSAgICAgIHNpemUgPSBhLmxlbmd0aDsKCSAgICAgIHJlc3VsdCA9IHNpemUgPT09IGIubGVuZ3RoOwoJICAgICAgaWYgKHJlc3VsdCkgewoJICAgICAgICAvLyBEZWVwIGNvbXBhcmUgdGhlIGNvbnRlbnRzLCBpZ25vcmluZyBub24tbnVtZXJpYyBwcm9wZXJ0aWVzLgoJICAgICAgICB3aGlsZSAoc2l6ZS0tKSB7CgkgICAgICAgICAgaWYgKCEocmVzdWx0ID0gZXEoYVtzaXplXSwgYltzaXplXSwgYVN0YWNrLCBiU3RhY2spKSkgYnJlYWs7CgkgICAgICAgIH0KCSAgICAgIH0KCSAgICB9IGVsc2UgewoJICAgICAgLy8gRGVlcCBjb21wYXJlIG9iamVjdHMuCgkgICAgICB2YXIga2V5cyA9IF8ua2V5cyhhKSwga2V5OwoJICAgICAgc2l6ZSA9IGtleXMubGVuZ3RoOwoJICAgICAgLy8gRW5zdXJlIHRoYXQgYm90aCBvYmplY3RzIGNvbnRhaW4gdGhlIHNhbWUgbnVtYmVyIG9mIHByb3BlcnRpZXMgYmVmb3JlIGNvbXBhcmluZyBkZWVwIGVxdWFsaXR5LgoJICAgICAgcmVzdWx0ID0gXy5rZXlzKGIpLmxlbmd0aCA9PT0gc2l6ZTsKCSAgICAgIGlmIChyZXN1bHQpIHsKCSAgICAgICAgd2hpbGUgKHNpemUtLSkgewoJICAgICAgICAgIC8vIERlZXAgY29tcGFyZSBlYWNoIG1lbWJlcgoJICAgICAgICAgIGtleSA9IGtleXNbc2l6ZV07CgkgICAgICAgICAgaWYgKCEocmVzdWx0ID0gXy5oYXMoYiwga2V5KSAmJiBlcShhW2tleV0sIGJba2V5XSwgYVN0YWNrLCBiU3RhY2spKSkgYnJlYWs7CgkgICAgICAgIH0KCSAgICAgIH0KCSAgICB9CgkgICAgLy8gUmVtb3ZlIHRoZSBmaXJzdCBvYmplY3QgZnJvbSB0aGUgc3RhY2sgb2YgdHJhdmVyc2VkIG9iamVjdHMuCgkgICAgYVN0YWNrLnBvcCgpOwoJICAgIGJTdGFjay5wb3AoKTsKCSAgICByZXR1cm4gcmVzdWx0OwoJICB9OwoKCSAgLy8gUGVyZm9ybSBhIGRlZXAgY29tcGFyaXNvbiB0byBjaGVjayBpZiB0d28gb2JqZWN0cyBhcmUgZXF1YWwuCgkgIF8uaXNFcXVhbCA9IGZ1bmN0aW9uKGEsIGIpIHsKCSAgICByZXR1cm4gZXEoYSwgYiwgW10sIFtdKTsKCSAgfTsKCgkgIC8vIElzIGEgZ2l2ZW4gYXJyYXksIHN0cmluZywgb3Igb2JqZWN0IGVtcHR5PwoJICAvLyBBbiAiZW1wdHkiIG9iamVjdCBoYXMgbm8gZW51bWVyYWJsZSBvd24tcHJvcGVydGllcy4KCSAgXy5pc0VtcHR5ID0gZnVuY3Rpb24ob2JqKSB7CgkgICAgaWYgKG9iaiA9PSBudWxsKSByZXR1cm4gdHJ1ZTsKCSAgICBpZiAoXy5pc0FycmF5KG9iaikgfHwgXy5pc1N0cmluZyhvYmopIHx8IF8uaXNBcmd1bWVudHMob2JqKSkgcmV0dXJuIG9iai5sZW5ndGggPT09IDA7CgkgICAgZm9yICh2YXIga2V5IGluIG9iaikgaWYgKF8uaGFzKG9iaiwga2V5KSkgcmV0dXJuIGZhbHNlOwoJICAgIHJldHVybiB0cnVlOwoJICB9OwoKCSAgLy8gSXMgYSBnaXZlbiB2YWx1ZSBhIERPTSBlbGVtZW50PwoJICBfLmlzRWxlbWVudCA9IGZ1bmN0aW9uKG9iaikgewoJICAgIHJldHVybiAhIShvYmogJiYgb2JqLm5vZGVUeXBlID09PSAxKTsKCSAgfTsKCgkgIC8vIElzIGEgZ2l2ZW4gdmFsdWUgYW4gYXJyYXk/CgkgIC8vIERlbGVnYXRlcyB0byBFQ01BNSdzIG5hdGl2ZSBBcnJheS5pc0FycmF5CgkgIF8uaXNBcnJheSA9IG5hdGl2ZUlzQXJyYXkgfHwgZnVuY3Rpb24ob2JqKSB7CgkgICAgcmV0dXJuIHRvU3RyaW5nLmNhbGwob2JqKSA9PT0gJ1tvYmplY3QgQXJyYXldJzsKCSAgfTsKCgkgIC8vIElzIGEgZ2l2ZW4gdmFyaWFibGUgYW4gb2JqZWN0PwoJICBfLmlzT2JqZWN0ID0gZnVuY3Rpb24ob2JqKSB7CgkgICAgdmFyIHR5cGUgPSB0eXBlb2Ygb2JqOwoJICAgIHJldHVybiB0eXBlID09PSAnZnVuY3Rpb24nIHx8IHR5cGUgPT09ICdvYmplY3QnICYmICEhb2JqOwoJICB9OwoKCSAgLy8gQWRkIHNvbWUgaXNUeXBlIG1ldGhvZHM6IGlzQXJndW1lbnRzLCBpc0Z1bmN0aW9uLCBpc1N0cmluZywgaXNOdW1iZXIsIGlzRGF0ZSwgaXNSZWdFeHAuCgkgIF8uZWFjaChbJ0FyZ3VtZW50cycsICdGdW5jdGlvbicsICdTdHJpbmcnLCAnTnVtYmVyJywgJ0RhdGUnLCAnUmVnRXhwJ10sIGZ1bmN0aW9uKG5hbWUpIHsKCSAgICBfWydpcycgKyBuYW1lXSA9IGZ1bmN0aW9uKG9iaikgewoJICAgICAgcmV0dXJuIHRvU3RyaW5nLmNhbGwob2JqKSA9PT0gJ1tvYmplY3QgJyArIG5hbWUgKyAnXSc7CgkgICAgfTsKCSAgfSk7CgoJICAvLyBEZWZpbmUgYSBmYWxsYmFjayB2ZXJzaW9uIG9mIHRoZSBtZXRob2QgaW4gYnJvd3NlcnMgKGFoZW0sIElFKSwgd2hlcmUKCSAgLy8gdGhlcmUgaXNuJ3QgYW55IGluc3BlY3RhYmxlICJBcmd1bWVudHMiIHR5cGUuCgkgIGlmICghXy5pc0FyZ3VtZW50cyhhcmd1bWVudHMpKSB7CgkgICAgXy5pc0FyZ3VtZW50cyA9IGZ1bmN0aW9uKG9iaikgewoJICAgICAgcmV0dXJuIF8uaGFzKG9iaiwgJ2NhbGxlZScpOwoJICAgIH07CgkgIH0KCgkgIC8vIE9wdGltaXplIGBpc0Z1bmN0aW9uYCBpZiBhcHByb3ByaWF0ZS4gV29yayBhcm91bmQgYW4gSUUgMTEgYnVnLgoJICBpZiAodHJ1ZSkgewoJICAgIF8uaXNGdW5jdGlvbiA9IGZ1bmN0aW9uKG9iaikgewoJICAgICAgcmV0dXJuIHR5cGVvZiBvYmogPT0gJ2Z1bmN0aW9uJyB8fCBmYWxzZTsKCSAgICB9OwoJICB9CgoJICAvLyBJcyBhIGdpdmVuIG9iamVjdCBhIGZpbml0ZSBudW1iZXI/CgkgIF8uaXNGaW5pdGUgPSBmdW5jdGlvbihvYmopIHsKCSAgICByZXR1cm4gaXNGaW5pdGUob2JqKSAmJiAhaXNOYU4ocGFyc2VGbG9hdChvYmopKTsKCSAgfTsKCgkgIC8vIElzIHRoZSBnaXZlbiB2YWx1ZSBgTmFOYD8gKE5hTiBpcyB0aGUgb25seSBudW1iZXIgd2hpY2ggZG9lcyBub3QgZXF1YWwgaXRzZWxmKS4KCSAgXy5pc05hTiA9IGZ1bmN0aW9uKG9iaikgewoJICAgIHJldHVybiBfLmlzTnVtYmVyKG9iaikgJiYgb2JqICE9PSArb2JqOwoJICB9OwoKCSAgLy8gSXMgYSBnaXZlbiB2YWx1ZSBhIGJvb2xlYW4/CgkgIF8uaXNCb29sZWFuID0gZnVuY3Rpb24ob2JqKSB7CgkgICAgcmV0dXJuIG9iaiA9PT0gdHJ1ZSB8fCBvYmogPT09IGZhbHNlIHx8IHRvU3RyaW5nLmNhbGwob2JqKSA9PT0gJ1tvYmplY3QgQm9vbGVhbl0nOwoJICB9OwoKCSAgLy8gSXMgYSBnaXZlbiB2YWx1ZSBlcXVhbCB0byBudWxsPwoJICBfLmlzTnVsbCA9IGZ1bmN0aW9uKG9iaikgewoJICAgIHJldHVybiBvYmogPT09IG51bGw7CgkgIH07CgoJICAvLyBJcyBhIGdpdmVuIHZhcmlhYmxlIHVuZGVmaW5lZD8KCSAgXy5pc1VuZGVmaW5lZCA9IGZ1bmN0aW9uKG9iaikgewoJICAgIHJldHVybiBvYmogPT09IHZvaWQgMDsKCSAgfTsKCgkgIC8vIFNob3J0Y3V0IGZ1bmN0aW9uIGZvciBjaGVja2luZyBpZiBhbiBvYmplY3QgaGFzIGEgZ2l2ZW4gcHJvcGVydHkgZGlyZWN0bHkKCSAgLy8gb24gaXRzZWxmIChpbiBvdGhlciB3b3Jkcywgbm90IG9uIGEgcHJvdG90eXBlKS4KCSAgXy5oYXMgPSBmdW5jdGlvbihvYmosIGtleSkgewoJICAgIHJldHVybiBvYmogIT0gbnVsbCAmJiBoYXNPd25Qcm9wZXJ0eS5jYWxsKG9iaiwga2V5KTsKCSAgfTsKCgkgIC8vIFV0aWxpdHkgRnVuY3Rpb25zCgkgIC8vIC0tLS0tLS0tLS0tLS0tLS0tCgoJICAvLyBSdW4gVW5kZXJzY29yZS5qcyBpbiAqbm9Db25mbGljdCogbW9kZSwgcmV0dXJuaW5nIHRoZSBgX2AgdmFyaWFibGUgdG8gaXRzCgkgIC8vIHByZXZpb3VzIG93bmVyLiBSZXR1cm5zIGEgcmVmZXJlbmNlIHRvIHRoZSBVbmRlcnNjb3JlIG9iamVjdC4KCSAgXy5ub0NvbmZsaWN0ID0gZnVuY3Rpb24oKSB7CgkgICAgcm9vdC5fID0gcHJldmlvdXNVbmRlcnNjb3JlOwoJICAgIHJldHVybiB0aGlzOwoJICB9OwoKCSAgLy8gS2VlcCB0aGUgaWRlbnRpdHkgZnVuY3Rpb24gYXJvdW5kIGZvciBkZWZhdWx0IGl0ZXJhdGVlcy4KCSAgXy5pZGVudGl0eSA9IGZ1bmN0aW9uKHZhbHVlKSB7CgkgICAgcmV0dXJuIHZhbHVlOwoJICB9OwoKCSAgXy5jb25zdGFudCA9IGZ1bmN0aW9uKHZhbHVlKSB7CgkgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewoJICAgICAgcmV0dXJuIHZhbHVlOwoJICAgIH07CgkgIH07CgoJICBfLm5vb3AgPSBmdW5jdGlvbigpe307CgoJICBfLnByb3BlcnR5ID0gZnVuY3Rpb24oa2V5KSB7CgkgICAgcmV0dXJuIGZ1bmN0aW9uKG9iaikgewoJICAgICAgcmV0dXJuIG9ialtrZXldOwoJICAgIH07CgkgIH07CgoJICAvLyBSZXR1cm5zIGEgcHJlZGljYXRlIGZvciBjaGVja2luZyB3aGV0aGVyIGFuIG9iamVjdCBoYXMgYSBnaXZlbiBzZXQgb2YgYGtleTp2YWx1ZWAgcGFpcnMuCgkgIF8ubWF0Y2hlcyA9IGZ1bmN0aW9uKGF0dHJzKSB7CgkgICAgdmFyIHBhaXJzID0gXy5wYWlycyhhdHRycyksIGxlbmd0aCA9IHBhaXJzLmxlbmd0aDsKCSAgICByZXR1cm4gZnVuY3Rpb24ob2JqKSB7CgkgICAgICBpZiAob2JqID09IG51bGwpIHJldHVybiAhbGVuZ3RoOwoJICAgICAgb2JqID0gbmV3IE9iamVjdChvYmopOwoJICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewoJICAgICAgICB2YXIgcGFpciA9IHBhaXJzW2ldLCBrZXkgPSBwYWlyWzBdOwoJICAgICAgICBpZiAocGFpclsxXSAhPT0gb2JqW2tleV0gfHwgIShrZXkgaW4gb2JqKSkgcmV0dXJuIGZhbHNlOwoJICAgICAgfQoJICAgICAgcmV0dXJuIHRydWU7CgkgICAgfTsKCSAgfTsKCgkgIC8vIFJ1biBhIGZ1bmN0aW9uICoqbioqIHRpbWVzLgoJICBfLnRpbWVzID0gZnVuY3Rpb24obiwgaXRlcmF0ZWUsIGNvbnRleHQpIHsKCSAgICB2YXIgYWNjdW0gPSBBcnJheShNYXRoLm1heCgwLCBuKSk7CgkgICAgaXRlcmF0ZWUgPSBjcmVhdGVDYWxsYmFjayhpdGVyYXRlZSwgY29udGV4dCwgMSk7CgkgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBuOyBpKyspIGFjY3VtW2ldID0gaXRlcmF0ZWUoaSk7CgkgICAgcmV0dXJuIGFjY3VtOwoJICB9OwoKCSAgLy8gUmV0dXJuIGEgcmFuZG9tIGludGVnZXIgYmV0d2VlbiBtaW4gYW5kIG1heCAoaW5jbHVzaXZlKS4KCSAgXy5yYW5kb20gPSBmdW5jdGlvbihtaW4sIG1heCkgewoJICAgIGlmIChtYXggPT0gbnVsbCkgewoJICAgICAgbWF4ID0gbWluOwoJICAgICAgbWluID0gMDsKCSAgICB9CgkgICAgcmV0dXJuIG1pbiArIE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIChtYXggLSBtaW4gKyAxKSk7CgkgIH07CgoJICAvLyBBIChwb3NzaWJseSBmYXN0ZXIpIHdheSB0byBnZXQgdGhlIGN1cnJlbnQgdGltZXN0YW1wIGFzIGFuIGludGVnZXIuCgkgIF8ubm93ID0gRGF0ZS5ub3cgfHwgZnVuY3Rpb24oKSB7CgkgICAgcmV0dXJuIG5ldyBEYXRlKCkuZ2V0VGltZSgpOwoJICB9OwoKCSAgIC8vIExpc3Qgb2YgSFRNTCBlbnRpdGllcyBmb3IgZXNjYXBpbmcuCgkgIHZhciBlc2NhcGVNYXAgPSB7CgkgICAgJyYnOiAnJmFtcDsnLAoJICAgICc8JzogJyZsdDsnLAoJICAgICc+JzogJyZndDsnLAoJICAgICciJzogJyZxdW90OycsCgkgICAgIiciOiAnJiN4Mjc7JywKCSAgICAnYCc6ICcmI3g2MDsnCgkgIH07CgkgIHZhciB1bmVzY2FwZU1hcCA9IF8uaW52ZXJ0KGVzY2FwZU1hcCk7CgoJICAvLyBGdW5jdGlvbnMgZm9yIGVzY2FwaW5nIGFuZCB1bmVzY2FwaW5nIHN0cmluZ3MgdG8vZnJvbSBIVE1MIGludGVycG9sYXRpb24uCgkgIHZhciBjcmVhdGVFc2NhcGVyID0gZnVuY3Rpb24obWFwKSB7CgkgICAgdmFyIGVzY2FwZXIgPSBmdW5jdGlvbihtYXRjaCkgewoJICAgICAgcmV0dXJuIG1hcFttYXRjaF07CgkgICAgfTsKCSAgICAvLyBSZWdleGVzIGZvciBpZGVudGlmeWluZyBhIGtleSB0aGF0IG5lZWRzIHRvIGJlIGVzY2FwZWQKCSAgICB2YXIgc291cmNlID0gJyg/OicgKyBfLmtleXMobWFwKS5qb2luKCd8JykgKyAnKSc7CgkgICAgdmFyIHRlc3RSZWdleHAgPSBSZWdFeHAoc291cmNlKTsKCSAgICB2YXIgcmVwbGFjZVJlZ2V4cCA9IFJlZ0V4cChzb3VyY2UsICdnJyk7CgkgICAgcmV0dXJuIGZ1bmN0aW9uKHN0cmluZykgewoJICAgICAgc3RyaW5nID0gc3RyaW5nID09IG51bGwgPyAnJyA6ICcnICsgc3RyaW5nOwoJICAgICAgcmV0dXJuIHRlc3RSZWdleHAudGVzdChzdHJpbmcpID8gc3RyaW5nLnJlcGxhY2UocmVwbGFjZVJlZ2V4cCwgZXNjYXBlcikgOiBzdHJpbmc7CgkgICAgfTsKCSAgfTsKCSAgXy5lc2NhcGUgPSBjcmVhdGVFc2NhcGVyKGVzY2FwZU1hcCk7CgkgIF8udW5lc2NhcGUgPSBjcmVhdGVFc2NhcGVyKHVuZXNjYXBlTWFwKTsKCgkgIC8vIElmIHRoZSB2YWx1ZSBvZiB0aGUgbmFtZWQgYHByb3BlcnR5YCBpcyBhIGZ1bmN0aW9uIHRoZW4gaW52b2tlIGl0IHdpdGggdGhlCgkgIC8vIGBvYmplY3RgIGFzIGNvbnRleHQ7IG90aGVyd2lzZSwgcmV0dXJuIGl0LgoJICBfLnJlc3VsdCA9IGZ1bmN0aW9uKG9iamVjdCwgcHJvcGVydHkpIHsKCSAgICBpZiAob2JqZWN0ID09IG51bGwpIHJldHVybiB2b2lkIDA7CgkgICAgdmFyIHZhbHVlID0gb2JqZWN0W3Byb3BlcnR5XTsKCSAgICByZXR1cm4gXy5pc0Z1bmN0aW9uKHZhbHVlKSA/IG9iamVjdFtwcm9wZXJ0eV0oKSA6IHZhbHVlOwoJICB9OwoKCSAgLy8gR2VuZXJhdGUgYSB1bmlxdWUgaW50ZWdlciBpZCAodW5pcXVlIHdpdGhpbiB0aGUgZW50aXJlIGNsaWVudCBzZXNzaW9uKS4KCSAgLy8gVXNlZnVsIGZvciB0ZW1wb3JhcnkgRE9NIGlkcy4KCSAgdmFyIGlkQ291bnRlciA9IDA7CgkgIF8udW5pcXVlSWQgPSBmdW5jdGlvbihwcmVmaXgpIHsKCSAgICB2YXIgaWQgPSArK2lkQ291bnRlciArICcnOwoJICAgIHJldHVybiBwcmVmaXggPyBwcmVmaXggKyBpZCA6IGlkOwoJICB9OwoKCSAgLy8gQnkgZGVmYXVsdCwgVW5kZXJzY29yZSB1c2VzIEVSQi1zdHlsZSB0ZW1wbGF0ZSBkZWxpbWl0ZXJzLCBjaGFuZ2UgdGhlCgkgIC8vIGZvbGxvd2luZyB0ZW1wbGF0ZSBzZXR0aW5ncyB0byB1c2UgYWx0ZXJuYXRpdmUgZGVsaW1pdGVycy4KCSAgXy50ZW1wbGF0ZVNldHRpbmdzID0gewoJICAgIGV2YWx1YXRlICAgIDogLzwlKFtcc1xTXSs/KSU+L2csCgkgICAgaW50ZXJwb2xhdGUgOiAvPCU9KFtcc1xTXSs/KSU+L2csCgkgICAgZXNjYXBlICAgICAgOiAvPCUtKFtcc1xTXSs/KSU+L2cKCSAgfTsKCgkgIC8vIFdoZW4gY3VzdG9taXppbmcgYHRlbXBsYXRlU2V0dGluZ3NgLCBpZiB5b3UgZG9uJ3Qgd2FudCB0byBkZWZpbmUgYW4KCSAgLy8gaW50ZXJwb2xhdGlvbiwgZXZhbHVhdGlvbiBvciBlc2NhcGluZyByZWdleCwgd2UgbmVlZCBvbmUgdGhhdCBpcwoJICAvLyBndWFyYW50ZWVkIG5vdCB0byBtYXRjaC4KCSAgdmFyIG5vTWF0Y2ggPSAvKC4pXi87CgoJICAvLyBDZXJ0YWluIGNoYXJhY3RlcnMgbmVlZCB0byBiZSBlc2NhcGVkIHNvIHRoYXQgdGhleSBjYW4gYmUgcHV0IGludG8gYQoJICAvLyBzdHJpbmcgbGl0ZXJhbC4KCSAgdmFyIGVzY2FwZXMgPSB7CgkgICAgIiciOiAgICAgICInIiwKCSAgICAnXFwnOiAgICAgJ1xcJywKCSAgICAnXHInOiAgICAgJ3InLAoJICAgICdcbic6ICAgICAnbicsCgkgICAgJ1x1MjAyOCc6ICd1MjAyOCcsCgkgICAgJ1x1MjAyOSc6ICd1MjAyOScKCSAgfTsKCgkgIHZhciBlc2NhcGVyID0gL1xcfCd8XHJ8XG58XHUyMDI4fFx1MjAyOS9nOwoKCSAgdmFyIGVzY2FwZUNoYXIgPSBmdW5jdGlvbihtYXRjaCkgewoJICAgIHJldHVybiAnXFwnICsgZXNjYXBlc1ttYXRjaF07CgkgIH07CgoJICAvLyBKYXZhU2NyaXB0IG1pY3JvLXRlbXBsYXRpbmcsIHNpbWlsYXIgdG8gSm9obiBSZXNpZydzIGltcGxlbWVudGF0aW9uLgoJICAvLyBVbmRlcnNjb3JlIHRlbXBsYXRpbmcgaGFuZGxlcyBhcmJpdHJhcnkgZGVsaW1pdGVycywgcHJlc2VydmVzIHdoaXRlc3BhY2UsCgkgIC8vIGFuZCBjb3JyZWN0bHkgZXNjYXBlcyBxdW90ZXMgd2l0aGluIGludGVycG9sYXRlZCBjb2RlLgoJICAvLyBOQjogYG9sZFNldHRpbmdzYCBvbmx5IGV4aXN0cyBmb3IgYmFja3dhcmRzIGNvbXBhdGliaWxpdHkuCgkgIF8udGVtcGxhdGUgPSBmdW5jdGlvbih0ZXh0LCBzZXR0aW5ncywgb2xkU2V0dGluZ3MpIHsKCSAgICBpZiAoIXNldHRpbmdzICYmIG9sZFNldHRpbmdzKSBzZXR0aW5ncyA9IG9sZFNldHRpbmdzOwoJICAgIHNldHRpbmdzID0gXy5kZWZhdWx0cyh7fSwgc2V0dGluZ3MsIF8udGVtcGxhdGVTZXR0aW5ncyk7CgoJICAgIC8vIENvbWJpbmUgZGVsaW1pdGVycyBpbnRvIG9uZSByZWd1bGFyIGV4cHJlc3Npb24gdmlhIGFsdGVybmF0aW9uLgoJICAgIHZhciBtYXRjaGVyID0gUmVnRXhwKFsKCSAgICAgIChzZXR0aW5ncy5lc2NhcGUgfHwgbm9NYXRjaCkuc291cmNlLAoJICAgICAgKHNldHRpbmdzLmludGVycG9sYXRlIHx8IG5vTWF0Y2gpLnNvdXJjZSwKCSAgICAgIChzZXR0aW5ncy5ldmFsdWF0ZSB8fCBub01hdGNoKS5zb3VyY2UKCSAgICBdLmpvaW4oJ3wnKSArICd8JCcsICdnJyk7CgoJICAgIC8vIENvbXBpbGUgdGhlIHRlbXBsYXRlIHNvdXJjZSwgZXNjYXBpbmcgc3RyaW5nIGxpdGVyYWxzIGFwcHJvcHJpYXRlbHkuCgkgICAgdmFyIGluZGV4ID0gMDsKCSAgICB2YXIgc291cmNlID0gIl9fcCs9JyI7CgkgICAgdGV4dC5yZXBsYWNlKG1hdGNoZXIsIGZ1bmN0aW9uKG1hdGNoLCBlc2NhcGUsIGludGVycG9sYXRlLCBldmFsdWF0ZSwgb2Zmc2V0KSB7CgkgICAgICBzb3VyY2UgKz0gdGV4dC5zbGljZShpbmRleCwgb2Zmc2V0KS5yZXBsYWNlKGVzY2FwZXIsIGVzY2FwZUNoYXIpOwoJICAgICAgaW5kZXggPSBvZmZzZXQgKyBtYXRjaC5sZW5ndGg7CgoJICAgICAgaWYgKGVzY2FwZSkgewoJICAgICAgICBzb3VyY2UgKz0gIicrXG4oKF9fdD0oIiArIGVzY2FwZSArICIpKT09bnVsbD8nJzpfLmVzY2FwZShfX3QpKStcbiciOwoJICAgICAgfSBlbHNlIGlmIChpbnRlcnBvbGF0ZSkgewoJICAgICAgICBzb3VyY2UgKz0gIicrXG4oKF9fdD0oIiArIGludGVycG9sYXRlICsgIikpPT1udWxsPycnOl9fdCkrXG4nIjsKCSAgICAgIH0gZWxzZSBpZiAoZXZhbHVhdGUpIHsKCSAgICAgICAgc291cmNlICs9ICInO1xuIiArIGV2YWx1YXRlICsgIlxuX19wKz0nIjsKCSAgICAgIH0KCgkgICAgICAvLyBBZG9iZSBWTXMgbmVlZCB0aGUgbWF0Y2ggcmV0dXJuZWQgdG8gcHJvZHVjZSB0aGUgY29ycmVjdCBvZmZlc3QuCgkgICAgICByZXR1cm4gbWF0Y2g7CgkgICAgfSk7CgkgICAgc291cmNlICs9ICInO1xuIjsKCgkgICAgLy8gSWYgYSB2YXJpYWJsZSBpcyBub3Qgc3BlY2lmaWVkLCBwbGFjZSBkYXRhIHZhbHVlcyBpbiBsb2NhbCBzY29wZS4KCSAgICBpZiAoIXNldHRpbmdzLnZhcmlhYmxlKSBzb3VyY2UgPSAnd2l0aChvYmp8fHt9KXtcbicgKyBzb3VyY2UgKyAnfVxuJzsKCgkgICAgc291cmNlID0gInZhciBfX3QsX19wPScnLF9faj1BcnJheS5wcm90b3R5cGUuam9pbiwiICsKCSAgICAgICJwcmludD1mdW5jdGlvbigpe19fcCs9X19qLmNhbGwoYXJndW1lbnRzLCcnKTt9O1xuIiArCgkgICAgICBzb3VyY2UgKyAncmV0dXJuIF9fcDtcbic7CgoJICAgIHRyeSB7CgkgICAgICB2YXIgcmVuZGVyID0gbmV3IEZ1bmN0aW9uKHNldHRpbmdzLnZhcmlhYmxlIHx8ICdvYmonLCAnXycsIHNvdXJjZSk7CgkgICAgfSBjYXRjaCAoZSkgewoJICAgICAgZS5zb3VyY2UgPSBzb3VyY2U7CgkgICAgICB0aHJvdyBlOwoJICAgIH0KCgkgICAgdmFyIHRlbXBsYXRlID0gZnVuY3Rpb24oZGF0YSkgewoJICAgICAgcmV0dXJuIHJlbmRlci5jYWxsKHRoaXMsIGRhdGEsIF8pOwoJICAgIH07CgoJICAgIC8vIFByb3ZpZGUgdGhlIGNvbXBpbGVkIHNvdXJjZSBhcyBhIGNvbnZlbmllbmNlIGZvciBwcmVjb21waWxhdGlvbi4KCSAgICB2YXIgYXJndW1lbnQgPSBzZXR0aW5ncy52YXJpYWJsZSB8fCAnb2JqJzsKCSAgICB0ZW1wbGF0ZS5zb3VyY2UgPSAnZnVuY3Rpb24oJyArIGFyZ3VtZW50ICsgJyl7XG4nICsgc291cmNlICsgJ30nOwoKCSAgICByZXR1cm4gdGVtcGxhdGU7CgkgIH07CgoJICAvLyBBZGQgYSAiY2hhaW4iIGZ1bmN0aW9uLiBTdGFydCBjaGFpbmluZyBhIHdyYXBwZWQgVW5kZXJzY29yZSBvYmplY3QuCgkgIF8uY2hhaW4gPSBmdW5jdGlvbihvYmopIHsKCSAgICB2YXIgaW5zdGFuY2UgPSBfKG9iaik7CgkgICAgaW5zdGFuY2UuX2NoYWluID0gdHJ1ZTsKCSAgICByZXR1cm4gaW5zdGFuY2U7CgkgIH07CgoJICAvLyBPT1AKCSAgLy8gLS0tLS0tLS0tLS0tLS0tCgkgIC8vIElmIFVuZGVyc2NvcmUgaXMgY2FsbGVkIGFzIGEgZnVuY3Rpb24sIGl0IHJldHVybnMgYSB3cmFwcGVkIG9iamVjdCB0aGF0CgkgIC8vIGNhbiBiZSB1c2VkIE9PLXN0eWxlLiBUaGlzIHdyYXBwZXIgaG9sZHMgYWx0ZXJlZCB2ZXJzaW9ucyBvZiBhbGwgdGhlCgkgIC8vIHVuZGVyc2NvcmUgZnVuY3Rpb25zLiBXcmFwcGVkIG9iamVjdHMgbWF5IGJlIGNoYWluZWQuCgoJICAvLyBIZWxwZXIgZnVuY3Rpb24gdG8gY29udGludWUgY2hhaW5pbmcgaW50ZXJtZWRpYXRlIHJlc3VsdHMuCgkgIHZhciByZXN1bHQgPSBmdW5jdGlvbihvYmopIHsKCSAgICByZXR1cm4gdGhpcy5fY2hhaW4gPyBfKG9iaikuY2hhaW4oKSA6IG9iajsKCSAgfTsKCgkgIC8vIEFkZCB5b3VyIG93biBjdXN0b20gZnVuY3Rpb25zIHRvIHRoZSBVbmRlcnNjb3JlIG9iamVjdC4KCSAgXy5taXhpbiA9IGZ1bmN0aW9uKG9iaikgewoJICAgIF8uZWFjaChfLmZ1bmN0aW9ucyhvYmopLCBmdW5jdGlvbihuYW1lKSB7CgkgICAgICB2YXIgZnVuYyA9IF9bbmFtZV0gPSBvYmpbbmFtZV07CgkgICAgICBfLnByb3RvdHlwZVtuYW1lXSA9IGZ1bmN0aW9uKCkgewoJICAgICAgICB2YXIgYXJncyA9IFt0aGlzLl93cmFwcGVkXTsKCSAgICAgICAgcHVzaC5hcHBseShhcmdzLCBhcmd1bWVudHMpOwoJICAgICAgICByZXR1cm4gcmVzdWx0LmNhbGwodGhpcywgZnVuYy5hcHBseShfLCBhcmdzKSk7CgkgICAgICB9OwoJICAgIH0pOwoJICB9OwoKCSAgLy8gQWRkIGFsbCBvZiB0aGUgVW5kZXJzY29yZSBmdW5jdGlvbnMgdG8gdGhlIHdyYXBwZXIgb2JqZWN0LgoJICBfLm1peGluKF8pOwoKCSAgLy8gQWRkIGFsbCBtdXRhdG9yIEFycmF5IGZ1bmN0aW9ucyB0byB0aGUgd3JhcHBlci4KCSAgXy5lYWNoKFsncG9wJywgJ3B1c2gnLCAncmV2ZXJzZScsICdzaGlmdCcsICdzb3J0JywgJ3NwbGljZScsICd1bnNoaWZ0J10sIGZ1bmN0aW9uKG5hbWUpIHsKCSAgICB2YXIgbWV0aG9kID0gQXJyYXlQcm90b1tuYW1lXTsKCSAgICBfLnByb3RvdHlwZVtuYW1lXSA9IGZ1bmN0aW9uKCkgewoJICAgICAgdmFyIG9iaiA9IHRoaXMuX3dyYXBwZWQ7CgkgICAgICBtZXRob2QuYXBwbHkob2JqLCBhcmd1bWVudHMpOwoJICAgICAgaWYgKChuYW1lID09PSAnc2hpZnQnIHx8IG5hbWUgPT09ICdzcGxpY2UnKSAmJiBvYmoubGVuZ3RoID09PSAwKSBkZWxldGUgb2JqWzBdOwoJICAgICAgcmV0dXJuIHJlc3VsdC5jYWxsKHRoaXMsIG9iaik7CgkgICAgfTsKCSAgfSk7CgoJICAvLyBBZGQgYWxsIGFjY2Vzc29yIEFycmF5IGZ1bmN0aW9ucyB0byB0aGUgd3JhcHBlci4KCSAgXy5lYWNoKFsnY29uY2F0JywgJ2pvaW4nLCAnc2xpY2UnXSwgZnVuY3Rpb24obmFtZSkgewoJICAgIHZhciBtZXRob2QgPSBBcnJheVByb3RvW25hbWVdOwoJICAgIF8ucHJvdG90eXBlW25hbWVdID0gZnVuY3Rpb24oKSB7CgkgICAgICByZXR1cm4gcmVzdWx0LmNhbGwodGhpcywgbWV0aG9kLmFwcGx5KHRoaXMuX3dyYXBwZWQsIGFyZ3VtZW50cykpOwoJICAgIH07CgkgIH0pOwoKCSAgLy8gRXh0cmFjdHMgdGhlIHJlc3VsdCBmcm9tIGEgd3JhcHBlZCBhbmQgY2hhaW5lZCBvYmplY3QuCgkgIF8ucHJvdG90eXBlLnZhbHVlID0gZnVuY3Rpb24oKSB7CgkgICAgcmV0dXJuIHRoaXMuX3dyYXBwZWQ7CgkgIH07CgoJICAvLyBBTUQgcmVnaXN0cmF0aW9uIGhhcHBlbnMgYXQgdGhlIGVuZCBmb3IgY29tcGF0aWJpbGl0eSB3aXRoIEFNRCBsb2FkZXJzCgkgIC8vIHRoYXQgbWF5IG5vdCBlbmZvcmNlIG5leHQtdHVybiBzZW1hbnRpY3Mgb24gbW9kdWxlcy4gRXZlbiB0aG91Z2ggZ2VuZXJhbAoJICAvLyBwcmFjdGljZSBmb3IgQU1EIHJlZ2lzdHJhdGlvbiBpcyB0byBiZSBhbm9ueW1vdXMsIHVuZGVyc2NvcmUgcmVnaXN0ZXJzCgkgIC8vIGFzIGEgbmFtZWQgbW9kdWxlIGJlY2F1c2UsIGxpa2UgalF1ZXJ5LCBpdCBpcyBhIGJhc2UgbGlicmFyeSB0aGF0IGlzCgkgIC8vIHBvcHVsYXIgZW5vdWdoIHRvIGJlIGJ1bmRsZWQgaW4gYSB0aGlyZCBwYXJ0eSBsaWIsIGJ1dCBub3QgYmUgcGFydCBvZgoJICAvLyBhbiBBTUQgbG9hZCByZXF1ZXN0LiBUaG9zZSBjYXNlcyBjb3VsZCBnZW5lcmF0ZSBhbiBlcnJvciB3aGVuIGFuCgkgIC8vIGFub255bW91cyBkZWZpbmUoKSBpcyBjYWxsZWQgb3V0c2lkZSBvZiBhIGxvYWRlciByZXF1ZXN0LgoJICBpZiAodHJ1ZSkgewoJICAgICEoX19XRUJQQUNLX0FNRF9ERUZJTkVfQVJSQVlfXyA9IFtdLCBfX1dFQlBBQ0tfQU1EX0RFRklORV9SRVNVTFRfXyA9IGZ1bmN0aW9uKCkgewoJICAgICAgcmV0dXJuIF87CgkgICAgfS5hcHBseShleHBvcnRzLCBfX1dFQlBBQ0tfQU1EX0RFRklORV9BUlJBWV9fKSwgX19XRUJQQUNLX0FNRF9ERUZJTkVfUkVTVUxUX18gIT09IHVuZGVmaW5lZCAmJiAobW9kdWxlLmV4cG9ydHMgPSBfX1dFQlBBQ0tfQU1EX0RFRklORV9SRVNVTFRfXykpOwoJICB9Cgl9LmNhbGwodGhpcykpOwoKCi8qKiovIH0sCi8qIDI1ICovCi8qKiovIGZ1bmN0aW9uKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewoKCS8qKiogSU1QT1JUUyBGUk9NIGltcG9ydHMtbG9hZGVyICoqKi8KCXZhciByZXF1aXJlID0gX193ZWJwYWNrX3JlcXVpcmVfXzsKCgkvKiEKCSAqIEtub2Nrb3V0IEphdmFTY3JpcHQgbGlicmFyeSB2My4yLjAKCSAqIChjKSBTdGV2ZW4gU2FuZGVyc29uIC0gaHR0cDovL2tub2Nrb3V0anMuY29tLwoJICogTGljZW5zZTogTUlUIChodHRwOi8vd3d3Lm9wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL21pdC1saWNlbnNlLnBocCkKCSAqLwoKCShmdW5jdGlvbigpewoJdmFyIERFQlVHPXRydWU7CgkoZnVuY3Rpb24odW5kZWZpbmVkKXsKCSAgICAvLyAoMCwgZXZhbCkoJ3RoaXMnKSBpcyBhIHJvYnVzdCB3YXkgb2YgZ2V0dGluZyBhIHJlZmVyZW5jZSB0byB0aGUgZ2xvYmFsIG9iamVjdAoJICAgIC8vIEZvciBkZXRhaWxzLCBzZWUgaHR0cDovL3N0YWNrb3ZlcmZsb3cuY29tL3F1ZXN0aW9ucy8xNDExOTk4OC9yZXR1cm4tdGhpcy0wLWV2YWx0aGlzLzE0MTIwMDIzIzE0MTIwMDIzCgkgICAgdmFyIHdpbmRvdyA9IHRoaXMgfHwgKDAsIGV2YWwpKCd0aGlzJyksCgkgICAgICAgIGRvY3VtZW50ID0gd2luZG93Wydkb2N1bWVudCddLAoJICAgICAgICBuYXZpZ2F0b3IgPSB3aW5kb3dbJ25hdmlnYXRvciddLAoJICAgICAgICBqUXVlcnlJbnN0YW5jZSA9IHdpbmRvd1sialF1ZXJ5Il0sCgkgICAgICAgIEpTT04gPSB3aW5kb3dbIkpTT04iXTsKCShmdW5jdGlvbihmYWN0b3J5KSB7CgkgICAgLy8gU3VwcG9ydCB0aHJlZSBtb2R1bGUgbG9hZGluZyBzY2VuYXJpb3MKCSAgICBpZiAodHlwZW9mIHJlcXVpcmUgPT09ICdmdW5jdGlvbicgJiYgdHlwZW9mIGV4cG9ydHMgPT09ICdvYmplY3QnICYmIHR5cGVvZiBtb2R1bGUgPT09ICdvYmplY3QnKSB7CgkgICAgICAgIC8vIFsxXSBDb21tb25KUy9Ob2RlLmpzCgkgICAgICAgIHZhciB0YXJnZXQgPSBtb2R1bGVbJ2V4cG9ydHMnXSB8fCBleHBvcnRzOyAvLyBtb2R1bGUuZXhwb3J0cyBpcyBmb3IgTm9kZS5qcwoJICAgICAgICBmYWN0b3J5KHRhcmdldCwgcmVxdWlyZSk7CgkgICAgfSBlbHNlIGlmICh0eXBlb2YgZGVmaW5lID09PSAnZnVuY3Rpb24nICYmIGRlZmluZVsnYW1kJ10pIHsKCSAgICAgICAgLy8gWzJdIEFNRCBhbm9ueW1vdXMgbW9kdWxlCgkgICAgICAgIGRlZmluZShbJ2V4cG9ydHMnLCAncmVxdWlyZSddLCBmYWN0b3J5KTsKCSAgICB9IGVsc2UgewoJICAgICAgICAvLyBbM10gTm8gbW9kdWxlIGxvYWRlciAocGxhaW4gPHNjcmlwdD4gdGFnKSAtIHB1dCBkaXJlY3RseSBpbiBnbG9iYWwgbmFtZXNwYWNlCgkgICAgICAgIGZhY3Rvcnkod2luZG93WydrbyddID0ge30pOwoJICAgIH0KCX0oZnVuY3Rpb24oa29FeHBvcnRzLCByZXF1aXJlKXsKCS8vIEludGVybmFsbHksIGFsbCBLTyBvYmplY3RzIGFyZSBhdHRhY2hlZCB0byBrb0V4cG9ydHMgKGV2ZW4gdGhlIG5vbi1leHBvcnRlZCBvbmVzIHdob3NlIG5hbWVzIHdpbGwgYmUgbWluaWZpZWQgYnkgdGhlIGNsb3N1cmUgY29tcGlsZXIpLgoJLy8gSW4gdGhlIGZ1dHVyZSwgdGhlIGZvbGxvd2luZyAia28iIHZhcmlhYmxlIG1heSBiZSBtYWRlIGRpc3RpbmN0IGZyb20gImtvRXhwb3J0cyIgc28gdGhhdCBwcml2YXRlIG9iamVjdHMgYXJlIG5vdCBleHRlcm5hbGx5IHJlYWNoYWJsZS4KCXZhciBrbyA9IHR5cGVvZiBrb0V4cG9ydHMgIT09ICd1bmRlZmluZWQnID8ga29FeHBvcnRzIDoge307CgkvLyBHb29nbGUgQ2xvc3VyZSBDb21waWxlciBoZWxwZXJzICh1c2VkIG9ubHkgdG8gbWFrZSB0aGUgbWluaWZpZWQgZmlsZSBzbWFsbGVyKQoJa28uZXhwb3J0U3ltYm9sID0gZnVuY3Rpb24oa29QYXRoLCBvYmplY3QpIHsKCSAgICB2YXIgdG9rZW5zID0ga29QYXRoLnNwbGl0KCIuIik7CgoJICAgIC8vIEluIHRoZSBmdXR1cmUsICJrbyIgbWF5IGJlY29tZSBkaXN0aW5jdCBmcm9tICJrb0V4cG9ydHMiIChzbyB0aGF0IG5vbi1leHBvcnRlZCBvYmplY3RzIGFyZSBub3QgcmVhY2hhYmxlKQoJICAgIC8vIEF0IHRoYXQgcG9pbnQsICJ0YXJnZXQiIHdvdWxkIGJlIHNldCB0bzogKHR5cGVvZiBrb0V4cG9ydHMgIT09ICJ1bmRlZmluZWQiID8ga29FeHBvcnRzIDoga28pCgkgICAgdmFyIHRhcmdldCA9IGtvOwoKCSAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRva2Vucy5sZW5ndGggLSAxOyBpKyspCgkgICAgICAgIHRhcmdldCA9IHRhcmdldFt0b2tlbnNbaV1dOwoJICAgIHRhcmdldFt0b2tlbnNbdG9rZW5zLmxlbmd0aCAtIDFdXSA9IG9iamVjdDsKCX07Cglrby5leHBvcnRQcm9wZXJ0eSA9IGZ1bmN0aW9uKG93bmVyLCBwdWJsaWNOYW1lLCBvYmplY3QpIHsKCSAgICBvd25lcltwdWJsaWNOYW1lXSA9IG9iamVjdDsKCX07Cglrby52ZXJzaW9uID0gIjMuMi4wIjsKCglrby5leHBvcnRTeW1ib2woJ3ZlcnNpb24nLCBrby52ZXJzaW9uKTsKCWtvLnV0aWxzID0gKGZ1bmN0aW9uICgpIHsKCSAgICBmdW5jdGlvbiBvYmplY3RGb3JFYWNoKG9iaiwgYWN0aW9uKSB7CgkgICAgICAgIGZvciAodmFyIHByb3AgaW4gb2JqKSB7CgkgICAgICAgICAgICBpZiAob2JqLmhhc093blByb3BlcnR5KHByb3ApKSB7CgkgICAgICAgICAgICAgICAgYWN0aW9uKHByb3AsIG9ialtwcm9wXSk7CgkgICAgICAgICAgICB9CgkgICAgICAgIH0KCSAgICB9CgoJICAgIGZ1bmN0aW9uIGV4dGVuZCh0YXJnZXQsIHNvdXJjZSkgewoJICAgICAgICBpZiAoc291cmNlKSB7CgkgICAgICAgICAgICBmb3IodmFyIHByb3AgaW4gc291cmNlKSB7CgkgICAgICAgICAgICAgICAgaWYoc291cmNlLmhhc093blByb3BlcnR5KHByb3ApKSB7CgkgICAgICAgICAgICAgICAgICAgIHRhcmdldFtwcm9wXSA9IHNvdXJjZVtwcm9wXTsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICB9CgkgICAgICAgIH0KCSAgICAgICAgcmV0dXJuIHRhcmdldDsKCSAgICB9CgoJICAgIGZ1bmN0aW9uIHNldFByb3RvdHlwZU9mKG9iaiwgcHJvdG8pIHsKCSAgICAgICAgb2JqLl9fcHJvdG9fXyA9IHByb3RvOwoJICAgICAgICByZXR1cm4gb2JqOwoJICAgIH0KCgkgICAgdmFyIGNhblNldFByb3RvdHlwZSA9ICh7IF9fcHJvdG9fXzogW10gfSBpbnN0YW5jZW9mIEFycmF5KTsKCgkgICAgLy8gUmVwcmVzZW50IHRoZSBrbm93biBldmVudCB0eXBlcyBpbiBhIGNvbXBhY3Qgd2F5LCB0aGVuIGF0IHJ1bnRpbWUgdHJhbnNmb3JtIGl0IGludG8gYSBoYXNoIHdpdGggZXZlbnQgbmFtZSBhcyBrZXkgKGZvciBmYXN0IGxvb2t1cCkKCSAgICB2YXIga25vd25FdmVudHMgPSB7fSwga25vd25FdmVudFR5cGVzQnlFdmVudE5hbWUgPSB7fTsKCSAgICB2YXIga2V5RXZlbnRUeXBlTmFtZSA9IChuYXZpZ2F0b3IgJiYgL0ZpcmVmb3hcLzIvaS50ZXN0KG5hdmlnYXRvci51c2VyQWdlbnQpKSA/ICdLZXlib2FyZEV2ZW50JyA6ICdVSUV2ZW50cyc7CgkgICAga25vd25FdmVudHNba2V5RXZlbnRUeXBlTmFtZV0gPSBbJ2tleXVwJywgJ2tleWRvd24nLCAna2V5cHJlc3MnXTsKCSAgICBrbm93bkV2ZW50c1snTW91c2VFdmVudHMnXSA9IFsnY2xpY2snLCAnZGJsY2xpY2snLCAnbW91c2Vkb3duJywgJ21vdXNldXAnLCAnbW91c2Vtb3ZlJywgJ21vdXNlb3ZlcicsICdtb3VzZW91dCcsICdtb3VzZWVudGVyJywgJ21vdXNlbGVhdmUnXTsKCSAgICBvYmplY3RGb3JFYWNoKGtub3duRXZlbnRzLCBmdW5jdGlvbihldmVudFR5cGUsIGtub3duRXZlbnRzRm9yVHlwZSkgewoJICAgICAgICBpZiAoa25vd25FdmVudHNGb3JUeXBlLmxlbmd0aCkgewoJICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGogPSBrbm93bkV2ZW50c0ZvclR5cGUubGVuZ3RoOyBpIDwgajsgaSsrKQoJICAgICAgICAgICAgICAgIGtub3duRXZlbnRUeXBlc0J5RXZlbnROYW1lW2tub3duRXZlbnRzRm9yVHlwZVtpXV0gPSBldmVudFR5cGU7CgkgICAgICAgIH0KCSAgICB9KTsKCSAgICB2YXIgZXZlbnRzVGhhdE11c3RCZVJlZ2lzdGVyZWRVc2luZ0F0dGFjaEV2ZW50ID0geyAncHJvcGVydHljaGFuZ2UnOiB0cnVlIH07IC8vIFdvcmthcm91bmQgZm9yIGFuIElFOSBpc3N1ZSAtIGh0dHBzOi8vZ2l0aHViLmNvbS9TdGV2ZVNhbmRlcnNvbi9rbm9ja291dC9pc3N1ZXMvNDA2CgoJICAgIC8vIERldGVjdCBJRSB2ZXJzaW9ucyBmb3IgYnVnIHdvcmthcm91bmRzICh1c2VzIElFIGNvbmRpdGlvbmFscywgbm90IFVBIHN0cmluZywgZm9yIHJvYnVzdG5lc3MpCgkgICAgLy8gTm90ZSB0aGF0LCBzaW5jZSBJRSAxMCBkb2VzIG5vdCBzdXBwb3J0IGNvbmRpdGlvbmFsIGNvbW1lbnRzLCB0aGUgZm9sbG93aW5nIGxvZ2ljIG9ubHkgZGV0ZWN0cyBJRSA8IDEwLgoJICAgIC8vIEN1cnJlbnRseSB0aGlzIGlzIGJ5IGRlc2lnbiwgc2luY2UgSUUgMTArIGJlaGF2ZXMgY29ycmVjdGx5IHdoZW4gdHJlYXRlZCBhcyBhIHN0YW5kYXJkIGJyb3dzZXIuCgkgICAgLy8gSWYgdGhlcmUgaXMgYSBmdXR1cmUgbmVlZCB0byBkZXRlY3Qgc3BlY2lmaWMgdmVyc2lvbnMgb2YgSUUxMCssIHdlIHdpbGwgYW1lbmQgdGhpcy4KCSAgICB2YXIgaWVWZXJzaW9uID0gZG9jdW1lbnQgJiYgKGZ1bmN0aW9uKCkgewoJICAgICAgICB2YXIgdmVyc2lvbiA9IDMsIGRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpLCBpRWxlbXMgPSBkaXYuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ2knKTsKCgkgICAgICAgIC8vIEtlZXAgY29uc3RydWN0aW5nIGNvbmRpdGlvbmFsIEhUTUwgYmxvY2tzIHVudGlsIHdlIGhpdCBvbmUgdGhhdCByZXNvbHZlcyB0byBhbiBlbXB0eSBmcmFnbWVudAoJICAgICAgICB3aGlsZSAoCgkgICAgICAgICAgICBkaXYuaW5uZXJIVE1MID0gJzwhLS1baWYgZ3QgSUUgJyArICgrK3ZlcnNpb24pICsgJ10+PGk+PC9pPjwhW2VuZGlmXS0tPicsCgkgICAgICAgICAgICBpRWxlbXNbMF0KCSAgICAgICAgKSB7fQoJICAgICAgICByZXR1cm4gdmVyc2lvbiA+IDQgPyB2ZXJzaW9uIDogdW5kZWZpbmVkOwoJICAgIH0oKSk7CgkgICAgdmFyIGlzSWU2ID0gaWVWZXJzaW9uID09PSA2LAoJICAgICAgICBpc0llNyA9IGllVmVyc2lvbiA9PT0gNzsKCgkgICAgZnVuY3Rpb24gaXNDbGlja09uQ2hlY2thYmxlRWxlbWVudChlbGVtZW50LCBldmVudFR5cGUpIHsKCSAgICAgICAgaWYgKChrby51dGlscy50YWdOYW1lTG93ZXIoZWxlbWVudCkgIT09ICJpbnB1dCIpIHx8ICFlbGVtZW50LnR5cGUpIHJldHVybiBmYWxzZTsKCSAgICAgICAgaWYgKGV2ZW50VHlwZS50b0xvd2VyQ2FzZSgpICE9ICJjbGljayIpIHJldHVybiBmYWxzZTsKCSAgICAgICAgdmFyIGlucHV0VHlwZSA9IGVsZW1lbnQudHlwZTsKCSAgICAgICAgcmV0dXJuIChpbnB1dFR5cGUgPT0gImNoZWNrYm94IikgfHwgKGlucHV0VHlwZSA9PSAicmFkaW8iKTsKCSAgICB9CgoJICAgIHJldHVybiB7CgkgICAgICAgIGZpZWxkc0luY2x1ZGVkV2l0aEpzb25Qb3N0OiBbJ2F1dGhlbnRpY2l0eV90b2tlbicsIC9eX19SZXF1ZXN0VmVyaWZpY2F0aW9uVG9rZW4oXy4qKT8kL10sCgoJICAgICAgICBhcnJheUZvckVhY2g6IGZ1bmN0aW9uIChhcnJheSwgYWN0aW9uKSB7CgkgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaiA9IGFycmF5Lmxlbmd0aDsgaSA8IGo7IGkrKykKCSAgICAgICAgICAgICAgICBhY3Rpb24oYXJyYXlbaV0sIGkpOwoJICAgICAgICB9LAoKCSAgICAgICAgYXJyYXlJbmRleE9mOiBmdW5jdGlvbiAoYXJyYXksIGl0ZW0pIHsKCSAgICAgICAgICAgIGlmICh0eXBlb2YgQXJyYXkucHJvdG90eXBlLmluZGV4T2YgPT0gImZ1bmN0aW9uIikKCSAgICAgICAgICAgICAgICByZXR1cm4gQXJyYXkucHJvdG90eXBlLmluZGV4T2YuY2FsbChhcnJheSwgaXRlbSk7CgkgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaiA9IGFycmF5Lmxlbmd0aDsgaSA8IGo7IGkrKykKCSAgICAgICAgICAgICAgICBpZiAoYXJyYXlbaV0gPT09IGl0ZW0pCgkgICAgICAgICAgICAgICAgICAgIHJldHVybiBpOwoJICAgICAgICAgICAgcmV0dXJuIC0xOwoJICAgICAgICB9LAoKCSAgICAgICAgYXJyYXlGaXJzdDogZnVuY3Rpb24gKGFycmF5LCBwcmVkaWNhdGUsIHByZWRpY2F0ZU93bmVyKSB7CgkgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaiA9IGFycmF5Lmxlbmd0aDsgaSA8IGo7IGkrKykKCSAgICAgICAgICAgICAgICBpZiAocHJlZGljYXRlLmNhbGwocHJlZGljYXRlT3duZXIsIGFycmF5W2ldLCBpKSkKCSAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGFycmF5W2ldOwoJICAgICAgICAgICAgcmV0dXJuIG51bGw7CgkgICAgICAgIH0sCgoJICAgICAgICBhcnJheVJlbW92ZUl0ZW06IGZ1bmN0aW9uIChhcnJheSwgaXRlbVRvUmVtb3ZlKSB7CgkgICAgICAgICAgICB2YXIgaW5kZXggPSBrby51dGlscy5hcnJheUluZGV4T2YoYXJyYXksIGl0ZW1Ub1JlbW92ZSk7CgkgICAgICAgICAgICBpZiAoaW5kZXggPiAwKSB7CgkgICAgICAgICAgICAgICAgYXJyYXkuc3BsaWNlKGluZGV4LCAxKTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIGVsc2UgaWYgKGluZGV4ID09PSAwKSB7CgkgICAgICAgICAgICAgICAgYXJyYXkuc2hpZnQoKTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgfSwKCgkgICAgICAgIGFycmF5R2V0RGlzdGluY3RWYWx1ZXM6IGZ1bmN0aW9uIChhcnJheSkgewoJICAgICAgICAgICAgYXJyYXkgPSBhcnJheSB8fCBbXTsKCSAgICAgICAgICAgIHZhciByZXN1bHQgPSBbXTsKCSAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBqID0gYXJyYXkubGVuZ3RoOyBpIDwgajsgaSsrKSB7CgkgICAgICAgICAgICAgICAgaWYgKGtvLnV0aWxzLmFycmF5SW5kZXhPZihyZXN1bHQsIGFycmF5W2ldKSA8IDApCgkgICAgICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKGFycmF5W2ldKTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIHJldHVybiByZXN1bHQ7CgkgICAgICAgIH0sCgoJICAgICAgICBhcnJheU1hcDogZnVuY3Rpb24gKGFycmF5LCBtYXBwaW5nKSB7CgkgICAgICAgICAgICBhcnJheSA9IGFycmF5IHx8IFtdOwoJICAgICAgICAgICAgdmFyIHJlc3VsdCA9IFtdOwoJICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGogPSBhcnJheS5sZW5ndGg7IGkgPCBqOyBpKyspCgkgICAgICAgICAgICAgICAgcmVzdWx0LnB1c2gobWFwcGluZyhhcnJheVtpXSwgaSkpOwoJICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKCSAgICAgICAgfSwKCgkgICAgICAgIGFycmF5RmlsdGVyOiBmdW5jdGlvbiAoYXJyYXksIHByZWRpY2F0ZSkgewoJICAgICAgICAgICAgYXJyYXkgPSBhcnJheSB8fCBbXTsKCSAgICAgICAgICAgIHZhciByZXN1bHQgPSBbXTsKCSAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBqID0gYXJyYXkubGVuZ3RoOyBpIDwgajsgaSsrKQoJICAgICAgICAgICAgICAgIGlmIChwcmVkaWNhdGUoYXJyYXlbaV0sIGkpKQoJICAgICAgICAgICAgICAgICAgICByZXN1bHQucHVzaChhcnJheVtpXSk7CgkgICAgICAgICAgICByZXR1cm4gcmVzdWx0OwoJICAgICAgICB9LAoKCSAgICAgICAgYXJyYXlQdXNoQWxsOiBmdW5jdGlvbiAoYXJyYXksIHZhbHVlc1RvUHVzaCkgewoJICAgICAgICAgICAgaWYgKHZhbHVlc1RvUHVzaCBpbnN0YW5jZW9mIEFycmF5KQoJICAgICAgICAgICAgICAgIGFycmF5LnB1c2guYXBwbHkoYXJyYXksIHZhbHVlc1RvUHVzaCk7CgkgICAgICAgICAgICBlbHNlCgkgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGogPSB2YWx1ZXNUb1B1c2gubGVuZ3RoOyBpIDwgajsgaSsrKQoJICAgICAgICAgICAgICAgICAgICBhcnJheS5wdXNoKHZhbHVlc1RvUHVzaFtpXSk7CgkgICAgICAgICAgICByZXR1cm4gYXJyYXk7CgkgICAgICAgIH0sCgoJICAgICAgICBhZGRPclJlbW92ZUl0ZW06IGZ1bmN0aW9uKGFycmF5LCB2YWx1ZSwgaW5jbHVkZWQpIHsKCSAgICAgICAgICAgIHZhciBleGlzdGluZ0VudHJ5SW5kZXggPSBrby51dGlscy5hcnJheUluZGV4T2Yoa28udXRpbHMucGVla09ic2VydmFibGUoYXJyYXkpLCB2YWx1ZSk7CgkgICAgICAgICAgICBpZiAoZXhpc3RpbmdFbnRyeUluZGV4IDwgMCkgewoJICAgICAgICAgICAgICAgIGlmIChpbmNsdWRlZCkKCSAgICAgICAgICAgICAgICAgICAgYXJyYXkucHVzaCh2YWx1ZSk7CgkgICAgICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgICAgIGlmICghaW5jbHVkZWQpCgkgICAgICAgICAgICAgICAgICAgIGFycmF5LnNwbGljZShleGlzdGluZ0VudHJ5SW5kZXgsIDEpOwoJICAgICAgICAgICAgfQoJICAgICAgICB9LAoKCSAgICAgICAgY2FuU2V0UHJvdG90eXBlOiBjYW5TZXRQcm90b3R5cGUsCgoJICAgICAgICBleHRlbmQ6IGV4dGVuZCwKCgkgICAgICAgIHNldFByb3RvdHlwZU9mOiBzZXRQcm90b3R5cGVPZiwKCgkgICAgICAgIHNldFByb3RvdHlwZU9mT3JFeHRlbmQ6IGNhblNldFByb3RvdHlwZSA/IHNldFByb3RvdHlwZU9mIDogZXh0ZW5kLAoKCSAgICAgICAgb2JqZWN0Rm9yRWFjaDogb2JqZWN0Rm9yRWFjaCwKCgkgICAgICAgIG9iamVjdE1hcDogZnVuY3Rpb24oc291cmNlLCBtYXBwaW5nKSB7CgkgICAgICAgICAgICBpZiAoIXNvdXJjZSkKCSAgICAgICAgICAgICAgICByZXR1cm4gc291cmNlOwoJICAgICAgICAgICAgdmFyIHRhcmdldCA9IHt9OwoJICAgICAgICAgICAgZm9yICh2YXIgcHJvcCBpbiBzb3VyY2UpIHsKCSAgICAgICAgICAgICAgICBpZiAoc291cmNlLmhhc093blByb3BlcnR5KHByb3ApKSB7CgkgICAgICAgICAgICAgICAgICAgIHRhcmdldFtwcm9wXSA9IG1hcHBpbmcoc291cmNlW3Byb3BdLCBwcm9wLCBzb3VyY2UpOwoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIHJldHVybiB0YXJnZXQ7CgkgICAgICAgIH0sCgoJICAgICAgICBlbXB0eURvbU5vZGU6IGZ1bmN0aW9uIChkb21Ob2RlKSB7CgkgICAgICAgICAgICB3aGlsZSAoZG9tTm9kZS5maXJzdENoaWxkKSB7CgkgICAgICAgICAgICAgICAga28ucmVtb3ZlTm9kZShkb21Ob2RlLmZpcnN0Q2hpbGQpOwoJICAgICAgICAgICAgfQoJICAgICAgICB9LAoKCSAgICAgICAgbW92ZUNsZWFuZWROb2Rlc1RvQ29udGFpbmVyRWxlbWVudDogZnVuY3Rpb24obm9kZXMpIHsKCSAgICAgICAgICAgIC8vIEVuc3VyZSBpdCdzIGEgcmVhbCBhcnJheSwgYXMgd2UncmUgYWJvdXQgdG8gcmVwYXJlbnQgdGhlIG5vZGVzIGFuZAoJICAgICAgICAgICAgLy8gd2UgZG9uJ3Qgd2FudCB0aGUgdW5kZXJseWluZyBjb2xsZWN0aW9uIHRvIGNoYW5nZSB3aGlsZSB3ZSdyZSBkb2luZyB0aGF0LgoJICAgICAgICAgICAgdmFyIG5vZGVzQXJyYXkgPSBrby51dGlscy5tYWtlQXJyYXkobm9kZXMpOwoKCSAgICAgICAgICAgIHZhciBjb250YWluZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKCSAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBqID0gbm9kZXNBcnJheS5sZW5ndGg7IGkgPCBqOyBpKyspIHsKCSAgICAgICAgICAgICAgICBjb250YWluZXIuYXBwZW5kQ2hpbGQoa28uY2xlYW5Ob2RlKG5vZGVzQXJyYXlbaV0pKTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIHJldHVybiBjb250YWluZXI7CgkgICAgICAgIH0sCgoJICAgICAgICBjbG9uZU5vZGVzOiBmdW5jdGlvbiAobm9kZXNBcnJheSwgc2hvdWxkQ2xlYW5Ob2RlcykgewoJICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGogPSBub2Rlc0FycmF5Lmxlbmd0aCwgbmV3Tm9kZXNBcnJheSA9IFtdOyBpIDwgajsgaSsrKSB7CgkgICAgICAgICAgICAgICAgdmFyIGNsb25lZE5vZGUgPSBub2Rlc0FycmF5W2ldLmNsb25lTm9kZSh0cnVlKTsKCSAgICAgICAgICAgICAgICBuZXdOb2Rlc0FycmF5LnB1c2goc2hvdWxkQ2xlYW5Ob2RlcyA/IGtvLmNsZWFuTm9kZShjbG9uZWROb2RlKSA6IGNsb25lZE5vZGUpOwoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgcmV0dXJuIG5ld05vZGVzQXJyYXk7CgkgICAgICAgIH0sCgoJICAgICAgICBzZXREb21Ob2RlQ2hpbGRyZW46IGZ1bmN0aW9uIChkb21Ob2RlLCBjaGlsZE5vZGVzKSB7CgkgICAgICAgICAgICBrby51dGlscy5lbXB0eURvbU5vZGUoZG9tTm9kZSk7CgkgICAgICAgICAgICBpZiAoY2hpbGROb2RlcykgewoJICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBqID0gY2hpbGROb2Rlcy5sZW5ndGg7IGkgPCBqOyBpKyspCgkgICAgICAgICAgICAgICAgICAgIGRvbU5vZGUuYXBwZW5kQ2hpbGQoY2hpbGROb2Rlc1tpXSk7CgkgICAgICAgICAgICB9CgkgICAgICAgIH0sCgoJICAgICAgICByZXBsYWNlRG9tTm9kZXM6IGZ1bmN0aW9uIChub2RlVG9SZXBsYWNlT3JOb2RlQXJyYXksIG5ld05vZGVzQXJyYXkpIHsKCSAgICAgICAgICAgIHZhciBub2Rlc1RvUmVwbGFjZUFycmF5ID0gbm9kZVRvUmVwbGFjZU9yTm9kZUFycmF5Lm5vZGVUeXBlID8gW25vZGVUb1JlcGxhY2VPck5vZGVBcnJheV0gOiBub2RlVG9SZXBsYWNlT3JOb2RlQXJyYXk7CgkgICAgICAgICAgICBpZiAobm9kZXNUb1JlcGxhY2VBcnJheS5sZW5ndGggPiAwKSB7CgkgICAgICAgICAgICAgICAgdmFyIGluc2VydGlvblBvaW50ID0gbm9kZXNUb1JlcGxhY2VBcnJheVswXTsKCSAgICAgICAgICAgICAgICB2YXIgcGFyZW50ID0gaW5zZXJ0aW9uUG9pbnQucGFyZW50Tm9kZTsKCSAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaiA9IG5ld05vZGVzQXJyYXkubGVuZ3RoOyBpIDwgajsgaSsrKQoJICAgICAgICAgICAgICAgICAgICBwYXJlbnQuaW5zZXJ0QmVmb3JlKG5ld05vZGVzQXJyYXlbaV0sIGluc2VydGlvblBvaW50KTsKCSAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaiA9IG5vZGVzVG9SZXBsYWNlQXJyYXkubGVuZ3RoOyBpIDwgajsgaSsrKSB7CgkgICAgICAgICAgICAgICAgICAgIGtvLnJlbW92ZU5vZGUobm9kZXNUb1JlcGxhY2VBcnJheVtpXSk7CgkgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgfQoJICAgICAgICB9LAoKCSAgICAgICAgZml4VXBDb250aW51b3VzTm9kZUFycmF5OiBmdW5jdGlvbihjb250aW51b3VzTm9kZUFycmF5LCBwYXJlbnROb2RlKSB7CgkgICAgICAgICAgICAvLyBCZWZvcmUgYWN0aW5nIG9uIGEgc2V0IG9mIG5vZGVzIHRoYXQgd2VyZSBwcmV2aW91c2x5IG91dHB1dHRlZCBieSBhIHRlbXBsYXRlIGZ1bmN0aW9uLCB3ZSBoYXZlIHRvIHJlY29uY2lsZQoJICAgICAgICAgICAgLy8gdGhlbSBhZ2FpbnN0IHdoYXQgaXMgaW4gdGhlIERPTSByaWdodCBub3cuIEl0IG1heSBiZSB0aGF0IHNvbWUgb2YgdGhlIG5vZGVzIGhhdmUgYWxyZWFkeSBiZWVuIHJlbW92ZWQsIG9yIHRoYXQKCSAgICAgICAgICAgIC8vIG5ldyBub2RlcyBtaWdodCBoYXZlIGJlZW4gaW5zZXJ0ZWQgaW4gdGhlIG1pZGRsZSwgZm9yIGV4YW1wbGUgYnkgYSBiaW5kaW5nLiBBbHNvLCB0aGVyZSBtYXkgcHJldmlvdXNseSBoYXZlIGJlZW4KCSAgICAgICAgICAgIC8vIGxlYWRpbmcgY29tbWVudCBub2RlcyAoY3JlYXRlZCBieSByZXdyaXR0ZW4gc3RyaW5nLWJhc2VkIHRlbXBsYXRlcykgdGhhdCBoYXZlIHNpbmNlIGJlZW4gcmVtb3ZlZCBkdXJpbmcgYmluZGluZy4KCSAgICAgICAgICAgIC8vIFNvLCB0aGlzIGZ1bmN0aW9uIHRyYW5zbGF0ZXMgdGhlIG9sZCAibWFwIiBvdXRwdXQgYXJyYXkgaW50byBpdHMgYmVzdCBndWVzcyBvZiB0aGUgc2V0IG9mIGN1cnJlbnQgRE9NIG5vZGVzLgoJICAgICAgICAgICAgLy8KCSAgICAgICAgICAgIC8vIFJ1bGVzOgoJICAgICAgICAgICAgLy8gICBbQV0gQW55IGxlYWRpbmcgbm9kZXMgdGhhdCBoYXZlIGJlZW4gcmVtb3ZlZCBzaG91bGQgYmUgaWdub3JlZAoJICAgICAgICAgICAgLy8gICAgICAgVGhlc2UgbW9zdCBsaWtlbHkgY29ycmVzcG9uZCB0byBtZW1vaXphdGlvbiBub2RlcyB0aGF0IHdlcmUgYWxyZWFkeSByZW1vdmVkIGR1cmluZyBiaW5kaW5nCgkgICAgICAgICAgICAvLyAgICAgICBTZWUgaHR0cHM6Ly9naXRodWIuY29tL1N0ZXZlU2FuZGVyc29uL2tub2Nrb3V0L3B1bGwvNDQwCgkgICAgICAgICAgICAvLyAgIFtCXSBXZSB3YW50IHRvIG91dHB1dCBhIGNvbnRpbnVvdXMgc2VyaWVzIG9mIG5vZGVzLiBTbywgaWdub3JlIGFueSBub2RlcyB0aGF0IGhhdmUgYWxyZWFkeSBiZWVuIHJlbW92ZWQsCgkgICAgICAgICAgICAvLyAgICAgICBhbmQgaW5jbHVkZSBhbnkgbm9kZXMgdGhhdCBoYXZlIGJlZW4gaW5zZXJ0ZWQgYW1vbmcgdGhlIHByZXZpb3VzIGNvbGxlY3Rpb24KCgkgICAgICAgICAgICBpZiAoY29udGludW91c05vZGVBcnJheS5sZW5ndGgpIHsKCSAgICAgICAgICAgICAgICAvLyBUaGUgcGFyZW50IG5vZGUgY2FuIGJlIGEgdmlydHVhbCBlbGVtZW50OyBzbyBnZXQgdGhlIHJlYWwgcGFyZW50IG5vZGUKCSAgICAgICAgICAgICAgICBwYXJlbnROb2RlID0gKHBhcmVudE5vZGUubm9kZVR5cGUgPT09IDggJiYgcGFyZW50Tm9kZS5wYXJlbnROb2RlKSB8fCBwYXJlbnROb2RlOwoKCSAgICAgICAgICAgICAgICAvLyBSdWxlIFtBXQoJICAgICAgICAgICAgICAgIHdoaWxlIChjb250aW51b3VzTm9kZUFycmF5Lmxlbmd0aCAmJiBjb250aW51b3VzTm9kZUFycmF5WzBdLnBhcmVudE5vZGUgIT09IHBhcmVudE5vZGUpCgkgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVvdXNOb2RlQXJyYXkuc2hpZnQoKTsKCgkgICAgICAgICAgICAgICAgLy8gUnVsZSBbQl0KCSAgICAgICAgICAgICAgICBpZiAoY29udGludW91c05vZGVBcnJheS5sZW5ndGggPiAxKSB7CgkgICAgICAgICAgICAgICAgICAgIHZhciBjdXJyZW50ID0gY29udGludW91c05vZGVBcnJheVswXSwgbGFzdCA9IGNvbnRpbnVvdXNOb2RlQXJyYXlbY29udGludW91c05vZGVBcnJheS5sZW5ndGggLSAxXTsKCSAgICAgICAgICAgICAgICAgICAgLy8gUmVwbGFjZSB3aXRoIHRoZSBhY3R1YWwgbmV3IGNvbnRpbnVvdXMgbm9kZSBzZXQKCSAgICAgICAgICAgICAgICAgICAgY29udGludW91c05vZGVBcnJheS5sZW5ndGggPSAwOwoJICAgICAgICAgICAgICAgICAgICB3aGlsZSAoY3VycmVudCAhPT0gbGFzdCkgewoJICAgICAgICAgICAgICAgICAgICAgICAgY29udGludW91c05vZGVBcnJheS5wdXNoKGN1cnJlbnQpOwoJICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudCA9IGN1cnJlbnQubmV4dFNpYmxpbmc7CgkgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWN1cnJlbnQpIC8vIFdvbid0IGhhcHBlbiwgZXhjZXB0IGlmIHRoZSBkZXZlbG9wZXIgaGFzIG1hbnVhbGx5IHJlbW92ZWQgc29tZSBET00gZWxlbWVudHMgKHRoZW4gd2UncmUgaW4gYW4gdW5kZWZpbmVkIHNjZW5hcmlvKQoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKCSAgICAgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgICAgICBjb250aW51b3VzTm9kZUFycmF5LnB1c2gobGFzdCk7CgkgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgcmV0dXJuIGNvbnRpbnVvdXNOb2RlQXJyYXk7CgkgICAgICAgIH0sCgoJICAgICAgICBzZXRPcHRpb25Ob2RlU2VsZWN0aW9uU3RhdGU6IGZ1bmN0aW9uIChvcHRpb25Ob2RlLCBpc1NlbGVjdGVkKSB7CgkgICAgICAgICAgICAvLyBJRTYgc29tZXRpbWVzIHRocm93cyAidW5rbm93biBlcnJvciIgaWYgeW91IHRyeSB0byB3cml0ZSB0byAuc2VsZWN0ZWQgZGlyZWN0bHksIHdoZXJlYXMgRmlyZWZveCBzdHJ1Z2dsZXMgd2l0aCBzZXRBdHRyaWJ1dGUuIFBpY2sgb25lIGJhc2VkIG9uIGJyb3dzZXIuCgkgICAgICAgICAgICBpZiAoaWVWZXJzaW9uIDwgNykKCSAgICAgICAgICAgICAgICBvcHRpb25Ob2RlLnNldEF0dHJpYnV0ZSgic2VsZWN0ZWQiLCBpc1NlbGVjdGVkKTsKCSAgICAgICAgICAgIGVsc2UKCSAgICAgICAgICAgICAgICBvcHRpb25Ob2RlLnNlbGVjdGVkID0gaXNTZWxlY3RlZDsKCSAgICAgICAgfSwKCgkgICAgICAgIHN0cmluZ1RyaW06IGZ1bmN0aW9uIChzdHJpbmcpIHsKCSAgICAgICAgICAgIHJldHVybiBzdHJpbmcgPT09IG51bGwgfHwgc3RyaW5nID09PSB1bmRlZmluZWQgPyAnJyA6CgkgICAgICAgICAgICAgICAgc3RyaW5nLnRyaW0gPwoJICAgICAgICAgICAgICAgICAgICBzdHJpbmcudHJpbSgpIDoKCSAgICAgICAgICAgICAgICAgICAgc3RyaW5nLnRvU3RyaW5nKCkucmVwbGFjZSgvXltcc1x4YTBdK3xbXHNceGEwXSskL2csICcnKTsKCSAgICAgICAgfSwKCgkgICAgICAgIHN0cmluZ1N0YXJ0c1dpdGg6IGZ1bmN0aW9uIChzdHJpbmcsIHN0YXJ0c1dpdGgpIHsKCSAgICAgICAgICAgIHN0cmluZyA9IHN0cmluZyB8fCAiIjsKCSAgICAgICAgICAgIGlmIChzdGFydHNXaXRoLmxlbmd0aCA+IHN0cmluZy5sZW5ndGgpCgkgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwoJICAgICAgICAgICAgcmV0dXJuIHN0cmluZy5zdWJzdHJpbmcoMCwgc3RhcnRzV2l0aC5sZW5ndGgpID09PSBzdGFydHNXaXRoOwoJICAgICAgICB9LAoKCSAgICAgICAgZG9tTm9kZUlzQ29udGFpbmVkQnk6IGZ1bmN0aW9uIChub2RlLCBjb250YWluZWRCeU5vZGUpIHsKCSAgICAgICAgICAgIGlmIChub2RlID09PSBjb250YWluZWRCeU5vZGUpCgkgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CgkgICAgICAgICAgICBpZiAobm9kZS5ub2RlVHlwZSA9PT0gMTEpCgkgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOyAvLyBGaXhlcyBpc3N1ZSAjMTE2MiAtIGNhbid0IHVzZSBub2RlLmNvbnRhaW5zIGZvciBkb2N1bWVudCBmcmFnbWVudHMgb24gSUU4CgkgICAgICAgICAgICBpZiAoY29udGFpbmVkQnlOb2RlLmNvbnRhaW5zKQoJICAgICAgICAgICAgICAgIHJldHVybiBjb250YWluZWRCeU5vZGUuY29udGFpbnMobm9kZS5ub2RlVHlwZSA9PT0gMyA/IG5vZGUucGFyZW50Tm9kZSA6IG5vZGUpOwoJICAgICAgICAgICAgaWYgKGNvbnRhaW5lZEJ5Tm9kZS5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbikKCSAgICAgICAgICAgICAgICByZXR1cm4gKGNvbnRhaW5lZEJ5Tm9kZS5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbihub2RlKSAmIDE2KSA9PSAxNjsKCSAgICAgICAgICAgIHdoaWxlIChub2RlICYmIG5vZGUgIT0gY29udGFpbmVkQnlOb2RlKSB7CgkgICAgICAgICAgICAgICAgbm9kZSA9IG5vZGUucGFyZW50Tm9kZTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIHJldHVybiAhIW5vZGU7CgkgICAgICAgIH0sCgoJICAgICAgICBkb21Ob2RlSXNBdHRhY2hlZFRvRG9jdW1lbnQ6IGZ1bmN0aW9uIChub2RlKSB7CgkgICAgICAgICAgICByZXR1cm4ga28udXRpbHMuZG9tTm9kZUlzQ29udGFpbmVkQnkobm9kZSwgbm9kZS5vd25lckRvY3VtZW50LmRvY3VtZW50RWxlbWVudCk7CgkgICAgICAgIH0sCgoJICAgICAgICBhbnlEb21Ob2RlSXNBdHRhY2hlZFRvRG9jdW1lbnQ6IGZ1bmN0aW9uKG5vZGVzKSB7CgkgICAgICAgICAgICByZXR1cm4gISFrby51dGlscy5hcnJheUZpcnN0KG5vZGVzLCBrby51dGlscy5kb21Ob2RlSXNBdHRhY2hlZFRvRG9jdW1lbnQpOwoJICAgICAgICB9LAoKCSAgICAgICAgdGFnTmFtZUxvd2VyOiBmdW5jdGlvbihlbGVtZW50KSB7CgkgICAgICAgICAgICAvLyBGb3IgSFRNTCBlbGVtZW50cywgdGFnTmFtZSB3aWxsIGFsd2F5cyBiZSB1cHBlciBjYXNlOyBmb3IgWEhUTUwgZWxlbWVudHMsIGl0J2xsIGJlIGxvd2VyIGNhc2UuCgkgICAgICAgICAgICAvLyBQb3NzaWJsZSBmdXR1cmUgb3B0aW1pemF0aW9uOiBJZiB3ZSBrbm93IGl0J3MgYW4gZWxlbWVudCBmcm9tIGFuIFhIVE1MIGRvY3VtZW50IChub3QgSFRNTCksCgkgICAgICAgICAgICAvLyB3ZSBkb24ndCBuZWVkIHRvIGRvIHRoZSAudG9Mb3dlckNhc2UoKSBhcyBpdCB3aWxsIGFsd2F5cyBiZSBsb3dlciBjYXNlIGFueXdheS4KCSAgICAgICAgICAgIHJldHVybiBlbGVtZW50ICYmIGVsZW1lbnQudGFnTmFtZSAmJiBlbGVtZW50LnRhZ05hbWUudG9Mb3dlckNhc2UoKTsKCSAgICAgICAgfSwKCgkgICAgICAgIHJlZ2lzdGVyRXZlbnRIYW5kbGVyOiBmdW5jdGlvbiAoZWxlbWVudCwgZXZlbnRUeXBlLCBoYW5kbGVyKSB7CgkgICAgICAgICAgICB2YXIgbXVzdFVzZUF0dGFjaEV2ZW50ID0gaWVWZXJzaW9uICYmIGV2ZW50c1RoYXRNdXN0QmVSZWdpc3RlcmVkVXNpbmdBdHRhY2hFdmVudFtldmVudFR5cGVdOwoJICAgICAgICAgICAgaWYgKCFtdXN0VXNlQXR0YWNoRXZlbnQgJiYgalF1ZXJ5SW5zdGFuY2UpIHsKCSAgICAgICAgICAgICAgICBqUXVlcnlJbnN0YW5jZShlbGVtZW50KVsnYmluZCddKGV2ZW50VHlwZSwgaGFuZGxlcik7CgkgICAgICAgICAgICB9IGVsc2UgaWYgKCFtdXN0VXNlQXR0YWNoRXZlbnQgJiYgdHlwZW9mIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lciA9PSAiZnVuY3Rpb24iKQoJICAgICAgICAgICAgICAgIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcihldmVudFR5cGUsIGhhbmRsZXIsIGZhbHNlKTsKCSAgICAgICAgICAgIGVsc2UgaWYgKHR5cGVvZiBlbGVtZW50LmF0dGFjaEV2ZW50ICE9ICJ1bmRlZmluZWQiKSB7CgkgICAgICAgICAgICAgICAgdmFyIGF0dGFjaEV2ZW50SGFuZGxlciA9IGZ1bmN0aW9uIChldmVudCkgeyBoYW5kbGVyLmNhbGwoZWxlbWVudCwgZXZlbnQpOyB9LAoJICAgICAgICAgICAgICAgICAgICBhdHRhY2hFdmVudE5hbWUgPSAib24iICsgZXZlbnRUeXBlOwoJICAgICAgICAgICAgICAgIGVsZW1lbnQuYXR0YWNoRXZlbnQoYXR0YWNoRXZlbnROYW1lLCBhdHRhY2hFdmVudEhhbmRsZXIpOwoKCSAgICAgICAgICAgICAgICAvLyBJRSBkb2VzIG5vdCBkaXNwb3NlIGF0dGFjaEV2ZW50IGhhbmRsZXJzIGF1dG9tYXRpY2FsbHkgKHVubGlrZSB3aXRoIGFkZEV2ZW50TGlzdGVuZXIpCgkgICAgICAgICAgICAgICAgLy8gc28gdG8gYXZvaWQgbGVha3MsIHdlIGhhdmUgdG8gcmVtb3ZlIHRoZW0gbWFudWFsbHkuIFNlZSBidWcgIzg1NgoJICAgICAgICAgICAgICAgIGtvLnV0aWxzLmRvbU5vZGVEaXNwb3NhbC5hZGREaXNwb3NlQ2FsbGJhY2soZWxlbWVudCwgZnVuY3Rpb24oKSB7CgkgICAgICAgICAgICAgICAgICAgIGVsZW1lbnQuZGV0YWNoRXZlbnQoYXR0YWNoRXZlbnROYW1lLCBhdHRhY2hFdmVudEhhbmRsZXIpOwoJICAgICAgICAgICAgICAgIH0pOwoJICAgICAgICAgICAgfSBlbHNlCgkgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJCcm93c2VyIGRvZXNuJ3Qgc3VwcG9ydCBhZGRFdmVudExpc3RlbmVyIG9yIGF0dGFjaEV2ZW50Iik7CgkgICAgICAgIH0sCgoJICAgICAgICB0cmlnZ2VyRXZlbnQ6IGZ1bmN0aW9uIChlbGVtZW50LCBldmVudFR5cGUpIHsKCSAgICAgICAgICAgIGlmICghKGVsZW1lbnQgJiYgZWxlbWVudC5ub2RlVHlwZSkpCgkgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJlbGVtZW50IG11c3QgYmUgYSBET00gbm9kZSB3aGVuIGNhbGxpbmcgdHJpZ2dlckV2ZW50Iik7CgoJICAgICAgICAgICAgLy8gRm9yIGNsaWNrIGV2ZW50cyBvbiBjaGVja2JveGVzIGFuZCByYWRpbyBidXR0b25zLCBqUXVlcnkgdG9nZ2xlcyB0aGUgZWxlbWVudCBjaGVja2VkIHN0YXRlICphZnRlciogdGhlCgkgICAgICAgICAgICAvLyBldmVudCBoYW5kbGVyIHJ1bnMgaW5zdGVhZCBvZiAqYmVmb3JlKi4gKFRoaXMgd2FzIGZpeGVkIGluIDEuOSBmb3IgY2hlY2tib3hlcyBidXQgbm90IGZvciByYWRpbyBidXR0b25zLikKCSAgICAgICAgICAgIC8vIElFIGRvZXNuJ3QgY2hhbmdlIHRoZSBjaGVja2VkIHN0YXRlIHdoZW4geW91IHRyaWdnZXIgdGhlIGNsaWNrIGV2ZW50IHVzaW5nICJmaXJlRXZlbnQiLgoJICAgICAgICAgICAgLy8gSW4gYm90aCBjYXNlcywgd2UnbGwgdXNlIHRoZSBjbGljayBtZXRob2QgaW5zdGVhZC4KCSAgICAgICAgICAgIHZhciB1c2VDbGlja1dvcmthcm91bmQgPSBpc0NsaWNrT25DaGVja2FibGVFbGVtZW50KGVsZW1lbnQsIGV2ZW50VHlwZSk7CgoJICAgICAgICAgICAgaWYgKGpRdWVyeUluc3RhbmNlICYmICF1c2VDbGlja1dvcmthcm91bmQpIHsKCSAgICAgICAgICAgICAgICBqUXVlcnlJbnN0YW5jZShlbGVtZW50KVsndHJpZ2dlciddKGV2ZW50VHlwZSk7CgkgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBkb2N1bWVudC5jcmVhdGVFdmVudCA9PSAiZnVuY3Rpb24iKSB7CgkgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBlbGVtZW50LmRpc3BhdGNoRXZlbnQgPT0gImZ1bmN0aW9uIikgewoJICAgICAgICAgICAgICAgICAgICB2YXIgZXZlbnRDYXRlZ29yeSA9IGtub3duRXZlbnRUeXBlc0J5RXZlbnROYW1lW2V2ZW50VHlwZV0gfHwgIkhUTUxFdmVudHMiOwoJICAgICAgICAgICAgICAgICAgICB2YXIgZXZlbnQgPSBkb2N1bWVudC5jcmVhdGVFdmVudChldmVudENhdGVnb3J5KTsKCSAgICAgICAgICAgICAgICAgICAgZXZlbnQuaW5pdEV2ZW50KGV2ZW50VHlwZSwgdHJ1ZSwgdHJ1ZSwgd2luZG93LCAwLCAwLCAwLCAwLCAwLCBmYWxzZSwgZmFsc2UsIGZhbHNlLCBmYWxzZSwgMCwgZWxlbWVudCk7CgkgICAgICAgICAgICAgICAgICAgIGVsZW1lbnQuZGlzcGF0Y2hFdmVudChldmVudCk7CgkgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgIGVsc2UKCSAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUaGUgc3VwcGxpZWQgZWxlbWVudCBkb2Vzbid0IHN1cHBvcnQgZGlzcGF0Y2hFdmVudCIpOwoJICAgICAgICAgICAgfSBlbHNlIGlmICh1c2VDbGlja1dvcmthcm91bmQgJiYgZWxlbWVudC5jbGljaykgewoJICAgICAgICAgICAgICAgIGVsZW1lbnQuY2xpY2soKTsKCSAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGVsZW1lbnQuZmlyZUV2ZW50ICE9ICJ1bmRlZmluZWQiKSB7CgkgICAgICAgICAgICAgICAgZWxlbWVudC5maXJlRXZlbnQoIm9uIiArIGV2ZW50VHlwZSk7CgkgICAgICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQnJvd3NlciBkb2Vzbid0IHN1cHBvcnQgdHJpZ2dlcmluZyBldmVudHMiKTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgfSwKCgkgICAgICAgIHVud3JhcE9ic2VydmFibGU6IGZ1bmN0aW9uICh2YWx1ZSkgewoJICAgICAgICAgICAgcmV0dXJuIGtvLmlzT2JzZXJ2YWJsZSh2YWx1ZSkgPyB2YWx1ZSgpIDogdmFsdWU7CgkgICAgICAgIH0sCgoJICAgICAgICBwZWVrT2JzZXJ2YWJsZTogZnVuY3Rpb24gKHZhbHVlKSB7CgkgICAgICAgICAgICByZXR1cm4ga28uaXNPYnNlcnZhYmxlKHZhbHVlKSA/IHZhbHVlLnBlZWsoKSA6IHZhbHVlOwoJICAgICAgICB9LAoKCSAgICAgICAgdG9nZ2xlRG9tTm9kZUNzc0NsYXNzOiBmdW5jdGlvbiAobm9kZSwgY2xhc3NOYW1lcywgc2hvdWxkSGF2ZUNsYXNzKSB7CgkgICAgICAgICAgICBpZiAoY2xhc3NOYW1lcykgewoJICAgICAgICAgICAgICAgIHZhciBjc3NDbGFzc05hbWVSZWdleCA9IC9cUysvZywKCSAgICAgICAgICAgICAgICAgICAgY3VycmVudENsYXNzTmFtZXMgPSBub2RlLmNsYXNzTmFtZS5tYXRjaChjc3NDbGFzc05hbWVSZWdleCkgfHwgW107CgkgICAgICAgICAgICAgICAga28udXRpbHMuYXJyYXlGb3JFYWNoKGNsYXNzTmFtZXMubWF0Y2goY3NzQ2xhc3NOYW1lUmVnZXgpLCBmdW5jdGlvbihjbGFzc05hbWUpIHsKCSAgICAgICAgICAgICAgICAgICAga28udXRpbHMuYWRkT3JSZW1vdmVJdGVtKGN1cnJlbnRDbGFzc05hbWVzLCBjbGFzc05hbWUsIHNob3VsZEhhdmVDbGFzcyk7CgkgICAgICAgICAgICAgICAgfSk7CgkgICAgICAgICAgICAgICAgbm9kZS5jbGFzc05hbWUgPSBjdXJyZW50Q2xhc3NOYW1lcy5qb2luKCIgIik7CgkgICAgICAgICAgICB9CgkgICAgICAgIH0sCgoJICAgICAgICBzZXRUZXh0Q29udGVudDogZnVuY3Rpb24oZWxlbWVudCwgdGV4dENvbnRlbnQpIHsKCSAgICAgICAgICAgIHZhciB2YWx1ZSA9IGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUodGV4dENvbnRlbnQpOwoJICAgICAgICAgICAgaWYgKCh2YWx1ZSA9PT0gbnVsbCkgfHwgKHZhbHVlID09PSB1bmRlZmluZWQpKQoJICAgICAgICAgICAgICAgIHZhbHVlID0gIiI7CgoJICAgICAgICAgICAgLy8gV2UgbmVlZCB0aGVyZSB0byBiZSBleGFjdGx5IG9uZSBjaGlsZDogYSB0ZXh0IG5vZGUuCgkgICAgICAgICAgICAvLyBJZiB0aGVyZSBhcmUgbm8gY2hpbGRyZW4sIG1vcmUgdGhhbiBvbmUsIG9yIGlmIGl0J3Mgbm90IGEgdGV4dCBub2RlLAoJICAgICAgICAgICAgLy8gd2UnbGwgY2xlYXIgZXZlcnl0aGluZyBhbmQgY3JlYXRlIGEgc2luZ2xlIHRleHQgbm9kZS4KCSAgICAgICAgICAgIHZhciBpbm5lclRleHROb2RlID0ga28udmlydHVhbEVsZW1lbnRzLmZpcnN0Q2hpbGQoZWxlbWVudCk7CgkgICAgICAgICAgICBpZiAoIWlubmVyVGV4dE5vZGUgfHwgaW5uZXJUZXh0Tm9kZS5ub2RlVHlwZSAhPSAzIHx8IGtvLnZpcnR1YWxFbGVtZW50cy5uZXh0U2libGluZyhpbm5lclRleHROb2RlKSkgewoJICAgICAgICAgICAgICAgIGtvLnZpcnR1YWxFbGVtZW50cy5zZXREb21Ob2RlQ2hpbGRyZW4oZWxlbWVudCwgW2VsZW1lbnQub3duZXJEb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSh2YWx1ZSldKTsKCSAgICAgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICAgICAgaW5uZXJUZXh0Tm9kZS5kYXRhID0gdmFsdWU7CgkgICAgICAgICAgICB9CgoJICAgICAgICAgICAga28udXRpbHMuZm9yY2VSZWZyZXNoKGVsZW1lbnQpOwoJICAgICAgICB9LAoKCSAgICAgICAgc2V0RWxlbWVudE5hbWU6IGZ1bmN0aW9uKGVsZW1lbnQsIG5hbWUpIHsKCSAgICAgICAgICAgIGVsZW1lbnQubmFtZSA9IG5hbWU7CgoJICAgICAgICAgICAgLy8gV29ya2Fyb3VuZCBJRSA2LzcgaXNzdWUKCSAgICAgICAgICAgIC8vIC0gaHR0cHM6Ly9naXRodWIuY29tL1N0ZXZlU2FuZGVyc29uL2tub2Nrb3V0L2lzc3Vlcy8xOTcKCSAgICAgICAgICAgIC8vIC0gaHR0cDovL3d3dy5tYXR0czQxMS5jb20vcG9zdC9zZXR0aW5nX3RoZV9uYW1lX2F0dHJpYnV0ZV9pbl9pZV9kb20vCgkgICAgICAgICAgICBpZiAoaWVWZXJzaW9uIDw9IDcpIHsKCSAgICAgICAgICAgICAgICB0cnkgewoJICAgICAgICAgICAgICAgICAgICBlbGVtZW50Lm1lcmdlQXR0cmlidXRlcyhkb2N1bWVudC5jcmVhdGVFbGVtZW50KCI8aW5wdXQgbmFtZT0nIiArIGVsZW1lbnQubmFtZSArICInLz4iKSwgZmFsc2UpOwoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICBjYXRjaChlKSB7fSAvLyBGb3IgSUU5IHdpdGggZG9jIG1vZGUgIklFOSBTdGFuZGFyZHMiIGFuZCBicm93c2VyIG1vZGUgIklFOSBDb21wYXRpYmlsaXR5IFZpZXciCgkgICAgICAgICAgICB9CgkgICAgICAgIH0sCgoJICAgICAgICBmb3JjZVJlZnJlc2g6IGZ1bmN0aW9uKG5vZGUpIHsKCSAgICAgICAgICAgIC8vIFdvcmthcm91bmQgZm9yIGFuIElFOSByZW5kZXJpbmcgYnVnIC0gaHR0cHM6Ly9naXRodWIuY29tL1N0ZXZlU2FuZGVyc29uL2tub2Nrb3V0L2lzc3Vlcy8yMDkKCSAgICAgICAgICAgIGlmIChpZVZlcnNpb24gPj0gOSkgewoJICAgICAgICAgICAgICAgIC8vIEZvciB0ZXh0IG5vZGVzIGFuZCBjb21tZW50IG5vZGVzIChtb3N0IGxpa2VseSB2aXJ0dWFsIGVsZW1lbnRzKSwgd2Ugd2lsbCBoYXZlIHRvIHJlZnJlc2ggdGhlIGNvbnRhaW5lcgoJICAgICAgICAgICAgICAgIHZhciBlbGVtID0gbm9kZS5ub2RlVHlwZSA9PSAxID8gbm9kZSA6IG5vZGUucGFyZW50Tm9kZTsKCSAgICAgICAgICAgICAgICBpZiAoZWxlbS5zdHlsZSkKCSAgICAgICAgICAgICAgICAgICAgZWxlbS5zdHlsZS56b29tID0gZWxlbS5zdHlsZS56b29tOwoJICAgICAgICAgICAgfQoJICAgICAgICB9LAoKCSAgICAgICAgZW5zdXJlU2VsZWN0RWxlbWVudElzUmVuZGVyZWRDb3JyZWN0bHk6IGZ1bmN0aW9uKHNlbGVjdEVsZW1lbnQpIHsKCSAgICAgICAgICAgIC8vIFdvcmthcm91bmQgZm9yIElFOSByZW5kZXJpbmcgYnVnIC0gaXQgZG9lc24ndCByZWxpYWJseSBkaXNwbGF5IGFsbCB0aGUgdGV4dCBpbiBkeW5hbWljYWxseS1hZGRlZCBzZWxlY3QgYm94ZXMgdW5sZXNzIHlvdSBmb3JjZSBpdCB0byByZS1yZW5kZXIgYnkgdXBkYXRpbmcgdGhlIHdpZHRoLgoJICAgICAgICAgICAgLy8gKFNlZSBodHRwczovL2dpdGh1Yi5jb20vU3RldmVTYW5kZXJzb24va25vY2tvdXQvaXNzdWVzLzMxMiwgaHR0cDovL3N0YWNrb3ZlcmZsb3cuY29tL3F1ZXN0aW9ucy81OTA4NDk0L3NlbGVjdC1vbmx5LXNob3dzLWZpcnN0LWNoYXItb2Ytc2VsZWN0ZWQtb3B0aW9uKQoJICAgICAgICAgICAgLy8gQWxzbyBmaXhlcyBJRTcgYW5kIElFOCBidWcgdGhhdCBjYXVzZXMgc2VsZWN0cyB0byBiZSB6ZXJvIHdpZHRoIGlmIGVuY2xvc2VkIGJ5ICdpZicgb3IgJ3dpdGgnLiAoU2VlIGlzc3VlICM4MzkpCgkgICAgICAgICAgICBpZiAoaWVWZXJzaW9uKSB7CgkgICAgICAgICAgICAgICAgdmFyIG9yaWdpbmFsV2lkdGggPSBzZWxlY3RFbGVtZW50LnN0eWxlLndpZHRoOwoJICAgICAgICAgICAgICAgIHNlbGVjdEVsZW1lbnQuc3R5bGUud2lkdGggPSAwOwoJICAgICAgICAgICAgICAgIHNlbGVjdEVsZW1lbnQuc3R5bGUud2lkdGggPSBvcmlnaW5hbFdpZHRoOwoJICAgICAgICAgICAgfQoJICAgICAgICB9LAoKCSAgICAgICAgcmFuZ2U6IGZ1bmN0aW9uIChtaW4sIG1heCkgewoJICAgICAgICAgICAgbWluID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZShtaW4pOwoJICAgICAgICAgICAgbWF4ID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZShtYXgpOwoJICAgICAgICAgICAgdmFyIHJlc3VsdCA9IFtdOwoJICAgICAgICAgICAgZm9yICh2YXIgaSA9IG1pbjsgaSA8PSBtYXg7IGkrKykKCSAgICAgICAgICAgICAgICByZXN1bHQucHVzaChpKTsKCSAgICAgICAgICAgIHJldHVybiByZXN1bHQ7CgkgICAgICAgIH0sCgoJICAgICAgICBtYWtlQXJyYXk6IGZ1bmN0aW9uKGFycmF5TGlrZU9iamVjdCkgewoJICAgICAgICAgICAgdmFyIHJlc3VsdCA9IFtdOwoJICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGogPSBhcnJheUxpa2VPYmplY3QubGVuZ3RoOyBpIDwgajsgaSsrKSB7CgkgICAgICAgICAgICAgICAgcmVzdWx0LnB1c2goYXJyYXlMaWtlT2JqZWN0W2ldKTsKCSAgICAgICAgICAgIH07CgkgICAgICAgICAgICByZXR1cm4gcmVzdWx0OwoJICAgICAgICB9LAoKCSAgICAgICAgaXNJZTYgOiBpc0llNiwKCSAgICAgICAgaXNJZTcgOiBpc0llNywKCSAgICAgICAgaWVWZXJzaW9uIDogaWVWZXJzaW9uLAoKCSAgICAgICAgZ2V0Rm9ybUZpZWxkczogZnVuY3Rpb24oZm9ybSwgZmllbGROYW1lKSB7CgkgICAgICAgICAgICB2YXIgZmllbGRzID0ga28udXRpbHMubWFrZUFycmF5KGZvcm0uZ2V0RWxlbWVudHNCeVRhZ05hbWUoImlucHV0IikpLmNvbmNhdChrby51dGlscy5tYWtlQXJyYXkoZm9ybS5nZXRFbGVtZW50c0J5VGFnTmFtZSgidGV4dGFyZWEiKSkpOwoJICAgICAgICAgICAgdmFyIGlzTWF0Y2hpbmdGaWVsZCA9ICh0eXBlb2YgZmllbGROYW1lID09ICdzdHJpbmcnKQoJICAgICAgICAgICAgICAgID8gZnVuY3Rpb24oZmllbGQpIHsgcmV0dXJuIGZpZWxkLm5hbWUgPT09IGZpZWxkTmFtZSB9CgkgICAgICAgICAgICAgICAgOiBmdW5jdGlvbihmaWVsZCkgeyByZXR1cm4gZmllbGROYW1lLnRlc3QoZmllbGQubmFtZSkgfTsgLy8gVHJlYXQgZmllbGROYW1lIGFzIHJlZ2V4IG9yIG9iamVjdCBjb250YWluaW5nIHByZWRpY2F0ZQoJICAgICAgICAgICAgdmFyIG1hdGNoZXMgPSBbXTsKCSAgICAgICAgICAgIGZvciAodmFyIGkgPSBmaWVsZHMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKCSAgICAgICAgICAgICAgICBpZiAoaXNNYXRjaGluZ0ZpZWxkKGZpZWxkc1tpXSkpCgkgICAgICAgICAgICAgICAgICAgIG1hdGNoZXMucHVzaChmaWVsZHNbaV0pOwoJICAgICAgICAgICAgfTsKCSAgICAgICAgICAgIHJldHVybiBtYXRjaGVzOwoJICAgICAgICB9LAoKCSAgICAgICAgcGFyc2VKc29uOiBmdW5jdGlvbiAoanNvblN0cmluZykgewoJICAgICAgICAgICAgaWYgKHR5cGVvZiBqc29uU3RyaW5nID09ICJzdHJpbmciKSB7CgkgICAgICAgICAgICAgICAganNvblN0cmluZyA9IGtvLnV0aWxzLnN0cmluZ1RyaW0oanNvblN0cmluZyk7CgkgICAgICAgICAgICAgICAgaWYgKGpzb25TdHJpbmcpIHsKCSAgICAgICAgICAgICAgICAgICAgaWYgKEpTT04gJiYgSlNPTi5wYXJzZSkgLy8gVXNlIG5hdGl2ZSBwYXJzaW5nIHdoZXJlIGF2YWlsYWJsZQoJICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEpTT04ucGFyc2UoanNvblN0cmluZyk7CgkgICAgICAgICAgICAgICAgICAgIHJldHVybiAobmV3IEZ1bmN0aW9uKCJyZXR1cm4gIiArIGpzb25TdHJpbmcpKSgpOyAvLyBGYWxsYmFjayBvbiBsZXNzIHNhZmUgcGFyc2luZyBmb3Igb2xkZXIgYnJvd3NlcnMKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICByZXR1cm4gbnVsbDsKCSAgICAgICAgfSwKCgkgICAgICAgIHN0cmluZ2lmeUpzb246IGZ1bmN0aW9uIChkYXRhLCByZXBsYWNlciwgc3BhY2UpIHsgICAvLyByZXBsYWNlciBhbmQgc3BhY2UgYXJlIG9wdGlvbmFsCgkgICAgICAgICAgICBpZiAoIUpTT04gfHwgIUpTT04uc3RyaW5naWZ5KQoJICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQ2Fubm90IGZpbmQgSlNPTi5zdHJpbmdpZnkoKS4gU29tZSBicm93c2VycyAoZS5nLiwgSUUgPCA4KSBkb24ndCBzdXBwb3J0IGl0IG5hdGl2ZWx5LCBidXQgeW91IGNhbiBvdmVyY29tZSB0aGlzIGJ5IGFkZGluZyBhIHNjcmlwdCByZWZlcmVuY2UgdG8ganNvbjIuanMsIGRvd25sb2FkYWJsZSBmcm9tIGh0dHA6Ly93d3cuanNvbi5vcmcvanNvbjIuanMiKTsKCSAgICAgICAgICAgIHJldHVybiBKU09OLnN0cmluZ2lmeShrby51dGlscy51bndyYXBPYnNlcnZhYmxlKGRhdGEpLCByZXBsYWNlciwgc3BhY2UpOwoJICAgICAgICB9LAoKCSAgICAgICAgcG9zdEpzb246IGZ1bmN0aW9uICh1cmxPckZvcm0sIGRhdGEsIG9wdGlvbnMpIHsKCSAgICAgICAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoJICAgICAgICAgICAgdmFyIHBhcmFtcyA9IG9wdGlvbnNbJ3BhcmFtcyddIHx8IHt9OwoJICAgICAgICAgICAgdmFyIGluY2x1ZGVGaWVsZHMgPSBvcHRpb25zWydpbmNsdWRlRmllbGRzJ10gfHwgdGhpcy5maWVsZHNJbmNsdWRlZFdpdGhKc29uUG9zdDsKCSAgICAgICAgICAgIHZhciB1cmwgPSB1cmxPckZvcm07CgoJICAgICAgICAgICAgLy8gSWYgd2Ugd2VyZSBnaXZlbiBhIGZvcm0sIHVzZSBpdHMgJ2FjdGlvbicgVVJMIGFuZCBwaWNrIG91dCBhbnkgcmVxdWVzdGVkIGZpZWxkIHZhbHVlcwoJICAgICAgICAgICAgaWYoKHR5cGVvZiB1cmxPckZvcm0gPT0gJ29iamVjdCcpICYmIChrby51dGlscy50YWdOYW1lTG93ZXIodXJsT3JGb3JtKSA9PT0gImZvcm0iKSkgewoJICAgICAgICAgICAgICAgIHZhciBvcmlnaW5hbEZvcm0gPSB1cmxPckZvcm07CgkgICAgICAgICAgICAgICAgdXJsID0gb3JpZ2luYWxGb3JtLmFjdGlvbjsKCSAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gaW5jbHVkZUZpZWxkcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewoJICAgICAgICAgICAgICAgICAgICB2YXIgZmllbGRzID0ga28udXRpbHMuZ2V0Rm9ybUZpZWxkcyhvcmlnaW5hbEZvcm0sIGluY2x1ZGVGaWVsZHNbaV0pOwoJICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBqID0gZmllbGRzLmxlbmd0aCAtIDE7IGogPj0gMDsgai0tKQoJICAgICAgICAgICAgICAgICAgICAgICAgcGFyYW1zW2ZpZWxkc1tqXS5uYW1lXSA9IGZpZWxkc1tqXS52YWx1ZTsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICB9CgoJICAgICAgICAgICAgZGF0YSA9IGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUoZGF0YSk7CgkgICAgICAgICAgICB2YXIgZm9ybSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImZvcm0iKTsKCSAgICAgICAgICAgIGZvcm0uc3R5bGUuZGlzcGxheSA9ICJub25lIjsKCSAgICAgICAgICAgIGZvcm0uYWN0aW9uID0gdXJsOwoJICAgICAgICAgICAgZm9ybS5tZXRob2QgPSAicG9zdCI7CgkgICAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gZGF0YSkgewoJICAgICAgICAgICAgICAgIC8vIFNpbmNlICdkYXRhJyB0aGlzIGlzIGEgbW9kZWwgb2JqZWN0LCB3ZSBpbmNsdWRlIGFsbCBwcm9wZXJ0aWVzIGluY2x1ZGluZyB0aG9zZSBpbmhlcml0ZWQgZnJvbSBpdHMgcHJvdG90eXBlCgkgICAgICAgICAgICAgICAgdmFyIGlucHV0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiaW5wdXQiKTsKCSAgICAgICAgICAgICAgICBpbnB1dC50eXBlID0gImhpZGRlbiI7CgkgICAgICAgICAgICAgICAgaW5wdXQubmFtZSA9IGtleTsKCSAgICAgICAgICAgICAgICBpbnB1dC52YWx1ZSA9IGtvLnV0aWxzLnN0cmluZ2lmeUpzb24oa28udXRpbHMudW53cmFwT2JzZXJ2YWJsZShkYXRhW2tleV0pKTsKCSAgICAgICAgICAgICAgICBmb3JtLmFwcGVuZENoaWxkKGlucHV0KTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIG9iamVjdEZvckVhY2gocGFyYW1zLCBmdW5jdGlvbihrZXksIHZhbHVlKSB7CgkgICAgICAgICAgICAgICAgdmFyIGlucHV0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiaW5wdXQiKTsKCSAgICAgICAgICAgICAgICBpbnB1dC50eXBlID0gImhpZGRlbiI7CgkgICAgICAgICAgICAgICAgaW5wdXQubmFtZSA9IGtleTsKCSAgICAgICAgICAgICAgICBpbnB1dC52YWx1ZSA9IHZhbHVlOwoJICAgICAgICAgICAgICAgIGZvcm0uYXBwZW5kQ2hpbGQoaW5wdXQpOwoJICAgICAgICAgICAgfSk7CgkgICAgICAgICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKGZvcm0pOwoJICAgICAgICAgICAgb3B0aW9uc1snc3VibWl0dGVyJ10gPyBvcHRpb25zWydzdWJtaXR0ZXInXShmb3JtKSA6IGZvcm0uc3VibWl0KCk7CgkgICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsgZm9ybS5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKGZvcm0pOyB9LCAwKTsKCSAgICAgICAgfQoJICAgIH0KCX0oKSk7CgoJa28uZXhwb3J0U3ltYm9sKCd1dGlscycsIGtvLnV0aWxzKTsKCWtvLmV4cG9ydFN5bWJvbCgndXRpbHMuYXJyYXlGb3JFYWNoJywga28udXRpbHMuYXJyYXlGb3JFYWNoKTsKCWtvLmV4cG9ydFN5bWJvbCgndXRpbHMuYXJyYXlGaXJzdCcsIGtvLnV0aWxzLmFycmF5Rmlyc3QpOwoJa28uZXhwb3J0U3ltYm9sKCd1dGlscy5hcnJheUZpbHRlcicsIGtvLnV0aWxzLmFycmF5RmlsdGVyKTsKCWtvLmV4cG9ydFN5bWJvbCgndXRpbHMuYXJyYXlHZXREaXN0aW5jdFZhbHVlcycsIGtvLnV0aWxzLmFycmF5R2V0RGlzdGluY3RWYWx1ZXMpOwoJa28uZXhwb3J0U3ltYm9sKCd1dGlscy5hcnJheUluZGV4T2YnLCBrby51dGlscy5hcnJheUluZGV4T2YpOwoJa28uZXhwb3J0U3ltYm9sKCd1dGlscy5hcnJheU1hcCcsIGtvLnV0aWxzLmFycmF5TWFwKTsKCWtvLmV4cG9ydFN5bWJvbCgndXRpbHMuYXJyYXlQdXNoQWxsJywga28udXRpbHMuYXJyYXlQdXNoQWxsKTsKCWtvLmV4cG9ydFN5bWJvbCgndXRpbHMuYXJyYXlSZW1vdmVJdGVtJywga28udXRpbHMuYXJyYXlSZW1vdmVJdGVtKTsKCWtvLmV4cG9ydFN5bWJvbCgndXRpbHMuZXh0ZW5kJywga28udXRpbHMuZXh0ZW5kKTsKCWtvLmV4cG9ydFN5bWJvbCgndXRpbHMuZmllbGRzSW5jbHVkZWRXaXRoSnNvblBvc3QnLCBrby51dGlscy5maWVsZHNJbmNsdWRlZFdpdGhKc29uUG9zdCk7Cglrby5leHBvcnRTeW1ib2woJ3V0aWxzLmdldEZvcm1GaWVsZHMnLCBrby51dGlscy5nZXRGb3JtRmllbGRzKTsKCWtvLmV4cG9ydFN5bWJvbCgndXRpbHMucGVla09ic2VydmFibGUnLCBrby51dGlscy5wZWVrT2JzZXJ2YWJsZSk7Cglrby5leHBvcnRTeW1ib2woJ3V0aWxzLnBvc3RKc29uJywga28udXRpbHMucG9zdEpzb24pOwoJa28uZXhwb3J0U3ltYm9sKCd1dGlscy5wYXJzZUpzb24nLCBrby51dGlscy5wYXJzZUpzb24pOwoJa28uZXhwb3J0U3ltYm9sKCd1dGlscy5yZWdpc3RlckV2ZW50SGFuZGxlcicsIGtvLnV0aWxzLnJlZ2lzdGVyRXZlbnRIYW5kbGVyKTsKCWtvLmV4cG9ydFN5bWJvbCgndXRpbHMuc3RyaW5naWZ5SnNvbicsIGtvLnV0aWxzLnN0cmluZ2lmeUpzb24pOwoJa28uZXhwb3J0U3ltYm9sKCd1dGlscy5yYW5nZScsIGtvLnV0aWxzLnJhbmdlKTsKCWtvLmV4cG9ydFN5bWJvbCgndXRpbHMudG9nZ2xlRG9tTm9kZUNzc0NsYXNzJywga28udXRpbHMudG9nZ2xlRG9tTm9kZUNzc0NsYXNzKTsKCWtvLmV4cG9ydFN5bWJvbCgndXRpbHMudHJpZ2dlckV2ZW50Jywga28udXRpbHMudHJpZ2dlckV2ZW50KTsKCWtvLmV4cG9ydFN5bWJvbCgndXRpbHMudW53cmFwT2JzZXJ2YWJsZScsIGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUpOwoJa28uZXhwb3J0U3ltYm9sKCd1dGlscy5vYmplY3RGb3JFYWNoJywga28udXRpbHMub2JqZWN0Rm9yRWFjaCk7Cglrby5leHBvcnRTeW1ib2woJ3V0aWxzLmFkZE9yUmVtb3ZlSXRlbScsIGtvLnV0aWxzLmFkZE9yUmVtb3ZlSXRlbSk7Cglrby5leHBvcnRTeW1ib2woJ3Vud3JhcCcsIGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUpOyAvLyBDb252ZW5pZW50IHNob3J0aGFuZCwgYmVjYXVzZSB0aGlzIGlzIHVzZWQgc28gY29tbW9ubHkKCglpZiAoIUZ1bmN0aW9uLnByb3RvdHlwZVsnYmluZCddKSB7CgkgICAgLy8gRnVuY3Rpb24ucHJvdG90eXBlLmJpbmQgaXMgYSBzdGFuZGFyZCBwYXJ0IG9mIEVDTUFTY3JpcHQgNXRoIEVkaXRpb24gKERlY2VtYmVyIDIwMDksIGh0dHA6Ly93d3cuZWNtYS1pbnRlcm5hdGlvbmFsLm9yZy9wdWJsaWNhdGlvbnMvZmlsZXMvRUNNQS1TVC9FQ01BLTI2Mi5wZGYpCgkgICAgLy8gSW4gY2FzZSB0aGUgYnJvd3NlciBkb2Vzbid0IGltcGxlbWVudCBpdCBuYXRpdmVseSwgcHJvdmlkZSBhIEphdmFTY3JpcHQgaW1wbGVtZW50YXRpb24uIFRoaXMgaW1wbGVtZW50YXRpb24gaXMgYmFzZWQgb24gdGhlIG9uZSBpbiBwcm90b3R5cGUuanMKCSAgICBGdW5jdGlvbi5wcm90b3R5cGVbJ2JpbmQnXSA9IGZ1bmN0aW9uIChvYmplY3QpIHsKCSAgICAgICAgdmFyIG9yaWdpbmFsRnVuY3Rpb24gPSB0aGlzLCBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzKSwgb2JqZWN0ID0gYXJncy5zaGlmdCgpOwoJICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewoJICAgICAgICAgICAgcmV0dXJuIG9yaWdpbmFsRnVuY3Rpb24uYXBwbHkob2JqZWN0LCBhcmdzLmNvbmNhdChBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMpKSk7CgkgICAgICAgIH07CgkgICAgfTsKCX0KCglrby51dGlscy5kb21EYXRhID0gbmV3IChmdW5jdGlvbiAoKSB7CgkgICAgdmFyIHVuaXF1ZUlkID0gMDsKCSAgICB2YXIgZGF0YVN0b3JlS2V5RXhwYW5kb1Byb3BlcnR5TmFtZSA9ICJfX2tvX18iICsgKG5ldyBEYXRlKS5nZXRUaW1lKCk7CgkgICAgdmFyIGRhdGFTdG9yZSA9IHt9OwoKCSAgICBmdW5jdGlvbiBnZXRBbGwobm9kZSwgY3JlYXRlSWZOb3RGb3VuZCkgewoJICAgICAgICB2YXIgZGF0YVN0b3JlS2V5ID0gbm9kZVtkYXRhU3RvcmVLZXlFeHBhbmRvUHJvcGVydHlOYW1lXTsKCSAgICAgICAgdmFyIGhhc0V4aXN0aW5nRGF0YVN0b3JlID0gZGF0YVN0b3JlS2V5ICYmIChkYXRhU3RvcmVLZXkgIT09ICJudWxsIikgJiYgZGF0YVN0b3JlW2RhdGFTdG9yZUtleV07CgkgICAgICAgIGlmICghaGFzRXhpc3RpbmdEYXRhU3RvcmUpIHsKCSAgICAgICAgICAgIGlmICghY3JlYXRlSWZOb3RGb3VuZCkKCSAgICAgICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwoJICAgICAgICAgICAgZGF0YVN0b3JlS2V5ID0gbm9kZVtkYXRhU3RvcmVLZXlFeHBhbmRvUHJvcGVydHlOYW1lXSA9ICJrbyIgKyB1bmlxdWVJZCsrOwoJICAgICAgICAgICAgZGF0YVN0b3JlW2RhdGFTdG9yZUtleV0gPSB7fTsKCSAgICAgICAgfQoJICAgICAgICByZXR1cm4gZGF0YVN0b3JlW2RhdGFTdG9yZUtleV07CgkgICAgfQoKCSAgICByZXR1cm4gewoJICAgICAgICBnZXQ6IGZ1bmN0aW9uIChub2RlLCBrZXkpIHsKCSAgICAgICAgICAgIHZhciBhbGxEYXRhRm9yTm9kZSA9IGdldEFsbChub2RlLCBmYWxzZSk7CgkgICAgICAgICAgICByZXR1cm4gYWxsRGF0YUZvck5vZGUgPT09IHVuZGVmaW5lZCA/IHVuZGVmaW5lZCA6IGFsbERhdGFGb3JOb2RlW2tleV07CgkgICAgICAgIH0sCgkgICAgICAgIHNldDogZnVuY3Rpb24gKG5vZGUsIGtleSwgdmFsdWUpIHsKCSAgICAgICAgICAgIGlmICh2YWx1ZSA9PT0gdW5kZWZpbmVkKSB7CgkgICAgICAgICAgICAgICAgLy8gTWFrZSBzdXJlIHdlIGRvbid0IGFjdHVhbGx5IGNyZWF0ZSBhIG5ldyBkb21EYXRhIGtleSBpZiB3ZSBhcmUgYWN0dWFsbHkgZGVsZXRpbmcgYSB2YWx1ZQoJICAgICAgICAgICAgICAgIGlmIChnZXRBbGwobm9kZSwgZmFsc2UpID09PSB1bmRlZmluZWQpCgkgICAgICAgICAgICAgICAgICAgIHJldHVybjsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIHZhciBhbGxEYXRhRm9yTm9kZSA9IGdldEFsbChub2RlLCB0cnVlKTsKCSAgICAgICAgICAgIGFsbERhdGFGb3JOb2RlW2tleV0gPSB2YWx1ZTsKCSAgICAgICAgfSwKCSAgICAgICAgY2xlYXI6IGZ1bmN0aW9uIChub2RlKSB7CgkgICAgICAgICAgICB2YXIgZGF0YVN0b3JlS2V5ID0gbm9kZVtkYXRhU3RvcmVLZXlFeHBhbmRvUHJvcGVydHlOYW1lXTsKCSAgICAgICAgICAgIGlmIChkYXRhU3RvcmVLZXkpIHsKCSAgICAgICAgICAgICAgICBkZWxldGUgZGF0YVN0b3JlW2RhdGFTdG9yZUtleV07CgkgICAgICAgICAgICAgICAgbm9kZVtkYXRhU3RvcmVLZXlFeHBhbmRvUHJvcGVydHlOYW1lXSA9IG51bGw7CgkgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7IC8vIEV4cG9zaW5nICJkaWQgY2xlYW4iIGZsYWcgcHVyZWx5IHNvIHNwZWNzIGNhbiBpbmZlciB3aGV0aGVyIHRoaW5ncyBoYXZlIGJlZW4gY2xlYW5lZCB1cCBhcyBpbnRlbmRlZAoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwoJICAgICAgICB9LAoKCSAgICAgICAgbmV4dEtleTogZnVuY3Rpb24gKCkgewoJICAgICAgICAgICAgcmV0dXJuICh1bmlxdWVJZCsrKSArIGRhdGFTdG9yZUtleUV4cGFuZG9Qcm9wZXJ0eU5hbWU7CgkgICAgICAgIH0KCSAgICB9OwoJfSkoKTsKCglrby5leHBvcnRTeW1ib2woJ3V0aWxzLmRvbURhdGEnLCBrby51dGlscy5kb21EYXRhKTsKCWtvLmV4cG9ydFN5bWJvbCgndXRpbHMuZG9tRGF0YS5jbGVhcicsIGtvLnV0aWxzLmRvbURhdGEuY2xlYXIpOyAvLyBFeHBvcnRpbmcgb25seSBzbyBzcGVjcyBjYW4gY2xlYXIgdXAgYWZ0ZXIgdGhlbXNlbHZlcyBmdWxseQoKCWtvLnV0aWxzLmRvbU5vZGVEaXNwb3NhbCA9IG5ldyAoZnVuY3Rpb24gKCkgewoJICAgIHZhciBkb21EYXRhS2V5ID0ga28udXRpbHMuZG9tRGF0YS5uZXh0S2V5KCk7CgkgICAgdmFyIGNsZWFuYWJsZU5vZGVUeXBlcyA9IHsgMTogdHJ1ZSwgODogdHJ1ZSwgOTogdHJ1ZSB9OyAgICAgICAvLyBFbGVtZW50LCBDb21tZW50LCBEb2N1bWVudAoJICAgIHZhciBjbGVhbmFibGVOb2RlVHlwZXNXaXRoRGVzY2VuZGFudHMgPSB7IDE6IHRydWUsIDk6IHRydWUgfTsgLy8gRWxlbWVudCwgRG9jdW1lbnQKCgkgICAgZnVuY3Rpb24gZ2V0RGlzcG9zZUNhbGxiYWNrc0NvbGxlY3Rpb24obm9kZSwgY3JlYXRlSWZOb3RGb3VuZCkgewoJICAgICAgICB2YXIgYWxsRGlzcG9zZUNhbGxiYWNrcyA9IGtvLnV0aWxzLmRvbURhdGEuZ2V0KG5vZGUsIGRvbURhdGFLZXkpOwoJICAgICAgICBpZiAoKGFsbERpc3Bvc2VDYWxsYmFja3MgPT09IHVuZGVmaW5lZCkgJiYgY3JlYXRlSWZOb3RGb3VuZCkgewoJICAgICAgICAgICAgYWxsRGlzcG9zZUNhbGxiYWNrcyA9IFtdOwoJICAgICAgICAgICAga28udXRpbHMuZG9tRGF0YS5zZXQobm9kZSwgZG9tRGF0YUtleSwgYWxsRGlzcG9zZUNhbGxiYWNrcyk7CgkgICAgICAgIH0KCSAgICAgICAgcmV0dXJuIGFsbERpc3Bvc2VDYWxsYmFja3M7CgkgICAgfQoJICAgIGZ1bmN0aW9uIGRlc3Ryb3lDYWxsYmFja3NDb2xsZWN0aW9uKG5vZGUpIHsKCSAgICAgICAga28udXRpbHMuZG9tRGF0YS5zZXQobm9kZSwgZG9tRGF0YUtleSwgdW5kZWZpbmVkKTsKCSAgICB9CgoJICAgIGZ1bmN0aW9uIGNsZWFuU2luZ2xlTm9kZShub2RlKSB7CgkgICAgICAgIC8vIFJ1biBhbGwgdGhlIGRpc3Bvc2UgY2FsbGJhY2tzCgkgICAgICAgIHZhciBjYWxsYmFja3MgPSBnZXREaXNwb3NlQ2FsbGJhY2tzQ29sbGVjdGlvbihub2RlLCBmYWxzZSk7CgkgICAgICAgIGlmIChjYWxsYmFja3MpIHsKCSAgICAgICAgICAgIGNhbGxiYWNrcyA9IGNhbGxiYWNrcy5zbGljZSgwKTsgLy8gQ2xvbmUsIGFzIHRoZSBhcnJheSBtYXkgYmUgbW9kaWZpZWQgZHVyaW5nIGl0ZXJhdGlvbiAodHlwaWNhbGx5LCBjYWxsYmFja3Mgd2lsbCByZW1vdmUgdGhlbXNlbHZlcykKCSAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgY2FsbGJhY2tzLmxlbmd0aDsgaSsrKQoJICAgICAgICAgICAgICAgIGNhbGxiYWNrc1tpXShub2RlKTsKCSAgICAgICAgfQoKCSAgICAgICAgLy8gRXJhc2UgdGhlIERPTSBkYXRhCgkgICAgICAgIGtvLnV0aWxzLmRvbURhdGEuY2xlYXIobm9kZSk7CgoJICAgICAgICAvLyBQZXJmb3JtIGNsZWFudXAgbmVlZGVkIGJ5IGV4dGVybmFsIGxpYnJhcmllcyAoY3VycmVudGx5IG9ubHkgalF1ZXJ5LCBidXQgY2FuIGJlIGV4dGVuZGVkKQoJICAgICAgICBrby51dGlscy5kb21Ob2RlRGlzcG9zYWxbImNsZWFuRXh0ZXJuYWxEYXRhIl0obm9kZSk7CgoJICAgICAgICAvLyBDbGVhciBhbnkgaW1tZWRpYXRlLWNoaWxkIGNvbW1lbnQgbm9kZXMsIGFzIHRoZXNlIHdvdWxkbid0IGhhdmUgYmVlbiBmb3VuZCBieQoJICAgICAgICAvLyBub2RlLmdldEVsZW1lbnRzQnlUYWdOYW1lKCIqIikgaW4gY2xlYW5Ob2RlKCkgKGNvbW1lbnQgbm9kZXMgYXJlbid0IGVsZW1lbnRzKQoJICAgICAgICBpZiAoY2xlYW5hYmxlTm9kZVR5cGVzV2l0aERlc2NlbmRhbnRzW25vZGUubm9kZVR5cGVdKQoJICAgICAgICAgICAgY2xlYW5JbW1lZGlhdGVDb21tZW50VHlwZUNoaWxkcmVuKG5vZGUpOwoJICAgIH0KCgkgICAgZnVuY3Rpb24gY2xlYW5JbW1lZGlhdGVDb21tZW50VHlwZUNoaWxkcmVuKG5vZGVXaXRoQ2hpbGRyZW4pIHsKCSAgICAgICAgdmFyIGNoaWxkLCBuZXh0Q2hpbGQgPSBub2RlV2l0aENoaWxkcmVuLmZpcnN0Q2hpbGQ7CgkgICAgICAgIHdoaWxlIChjaGlsZCA9IG5leHRDaGlsZCkgewoJICAgICAgICAgICAgbmV4dENoaWxkID0gY2hpbGQubmV4dFNpYmxpbmc7CgkgICAgICAgICAgICBpZiAoY2hpbGQubm9kZVR5cGUgPT09IDgpCgkgICAgICAgICAgICAgICAgY2xlYW5TaW5nbGVOb2RlKGNoaWxkKTsKCSAgICAgICAgfQoJICAgIH0KCgkgICAgcmV0dXJuIHsKCSAgICAgICAgYWRkRGlzcG9zZUNhbGxiYWNrIDogZnVuY3Rpb24obm9kZSwgY2FsbGJhY2spIHsKCSAgICAgICAgICAgIGlmICh0eXBlb2YgY2FsbGJhY2sgIT0gImZ1bmN0aW9uIikKCSAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkNhbGxiYWNrIG11c3QgYmUgYSBmdW5jdGlvbiIpOwoJICAgICAgICAgICAgZ2V0RGlzcG9zZUNhbGxiYWNrc0NvbGxlY3Rpb24obm9kZSwgdHJ1ZSkucHVzaChjYWxsYmFjayk7CgkgICAgICAgIH0sCgoJICAgICAgICByZW1vdmVEaXNwb3NlQ2FsbGJhY2sgOiBmdW5jdGlvbihub2RlLCBjYWxsYmFjaykgewoJICAgICAgICAgICAgdmFyIGNhbGxiYWNrc0NvbGxlY3Rpb24gPSBnZXREaXNwb3NlQ2FsbGJhY2tzQ29sbGVjdGlvbihub2RlLCBmYWxzZSk7CgkgICAgICAgICAgICBpZiAoY2FsbGJhY2tzQ29sbGVjdGlvbikgewoJICAgICAgICAgICAgICAgIGtvLnV0aWxzLmFycmF5UmVtb3ZlSXRlbShjYWxsYmFja3NDb2xsZWN0aW9uLCBjYWxsYmFjayk7CgkgICAgICAgICAgICAgICAgaWYgKGNhbGxiYWNrc0NvbGxlY3Rpb24ubGVuZ3RoID09IDApCgkgICAgICAgICAgICAgICAgICAgIGRlc3Ryb3lDYWxsYmFja3NDb2xsZWN0aW9uKG5vZGUpOwoJICAgICAgICAgICAgfQoJICAgICAgICB9LAoKCSAgICAgICAgY2xlYW5Ob2RlIDogZnVuY3Rpb24obm9kZSkgewoJICAgICAgICAgICAgLy8gRmlyc3QgY2xlYW4gdGhpcyBub2RlLCB3aGVyZSBhcHBsaWNhYmxlCgkgICAgICAgICAgICBpZiAoY2xlYW5hYmxlTm9kZVR5cGVzW25vZGUubm9kZVR5cGVdKSB7CgkgICAgICAgICAgICAgICAgY2xlYW5TaW5nbGVOb2RlKG5vZGUpOwoKCSAgICAgICAgICAgICAgICAvLyAuLi4gdGhlbiBpdHMgZGVzY2VuZGFudHMsIHdoZXJlIGFwcGxpY2FibGUKCSAgICAgICAgICAgICAgICBpZiAoY2xlYW5hYmxlTm9kZVR5cGVzV2l0aERlc2NlbmRhbnRzW25vZGUubm9kZVR5cGVdKSB7CgkgICAgICAgICAgICAgICAgICAgIC8vIENsb25lIHRoZSBkZXNjZW5kYW50cyBsaXN0IGluIGNhc2UgaXQgY2hhbmdlcyBkdXJpbmcgaXRlcmF0aW9uCgkgICAgICAgICAgICAgICAgICAgIHZhciBkZXNjZW5kYW50cyA9IFtdOwoJICAgICAgICAgICAgICAgICAgICBrby51dGlscy5hcnJheVB1c2hBbGwoZGVzY2VuZGFudHMsIG5vZGUuZ2V0RWxlbWVudHNCeVRhZ05hbWUoIioiKSk7CgkgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBqID0gZGVzY2VuZGFudHMubGVuZ3RoOyBpIDwgajsgaSsrKQoJICAgICAgICAgICAgICAgICAgICAgICAgY2xlYW5TaW5nbGVOb2RlKGRlc2NlbmRhbnRzW2ldKTsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICByZXR1cm4gbm9kZTsKCSAgICAgICAgfSwKCgkgICAgICAgIHJlbW92ZU5vZGUgOiBmdW5jdGlvbihub2RlKSB7CgkgICAgICAgICAgICBrby5jbGVhbk5vZGUobm9kZSk7CgkgICAgICAgICAgICBpZiAobm9kZS5wYXJlbnROb2RlKQoJICAgICAgICAgICAgICAgIG5vZGUucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChub2RlKTsKCSAgICAgICAgfSwKCgkgICAgICAgICJjbGVhbkV4dGVybmFsRGF0YSIgOiBmdW5jdGlvbiAobm9kZSkgewoJICAgICAgICAgICAgLy8gU3BlY2lhbCBzdXBwb3J0IGZvciBqUXVlcnkgaGVyZSBiZWNhdXNlIGl0J3Mgc28gY29tbW9ubHkgdXNlZC4KCSAgICAgICAgICAgIC8vIE1hbnkgalF1ZXJ5IHBsdWdpbnMgKGluY2x1ZGluZyBqcXVlcnkudG1wbCkgc3RvcmUgZGF0YSB1c2luZyBqUXVlcnkncyBlcXVpdmFsZW50IG9mIGRvbURhdGEKCSAgICAgICAgICAgIC8vIHNvIG5vdGlmeSBpdCB0byB0ZWFyIGRvd24gYW55IHJlc291cmNlcyBhc3NvY2lhdGVkIHdpdGggdGhlIG5vZGUgJiBkZXNjZW5kYW50cyBoZXJlLgoJICAgICAgICAgICAgaWYgKGpRdWVyeUluc3RhbmNlICYmICh0eXBlb2YgalF1ZXJ5SW5zdGFuY2VbJ2NsZWFuRGF0YSddID09ICJmdW5jdGlvbiIpKQoJICAgICAgICAgICAgICAgIGpRdWVyeUluc3RhbmNlWydjbGVhbkRhdGEnXShbbm9kZV0pOwoJICAgICAgICB9CgkgICAgfQoJfSkoKTsKCWtvLmNsZWFuTm9kZSA9IGtvLnV0aWxzLmRvbU5vZGVEaXNwb3NhbC5jbGVhbk5vZGU7IC8vIFNob3J0aGFuZCBuYW1lIGZvciBjb252ZW5pZW5jZQoJa28ucmVtb3ZlTm9kZSA9IGtvLnV0aWxzLmRvbU5vZGVEaXNwb3NhbC5yZW1vdmVOb2RlOyAvLyBTaG9ydGhhbmQgbmFtZSBmb3IgY29udmVuaWVuY2UKCWtvLmV4cG9ydFN5bWJvbCgnY2xlYW5Ob2RlJywga28uY2xlYW5Ob2RlKTsKCWtvLmV4cG9ydFN5bWJvbCgncmVtb3ZlTm9kZScsIGtvLnJlbW92ZU5vZGUpOwoJa28uZXhwb3J0U3ltYm9sKCd1dGlscy5kb21Ob2RlRGlzcG9zYWwnLCBrby51dGlscy5kb21Ob2RlRGlzcG9zYWwpOwoJa28uZXhwb3J0U3ltYm9sKCd1dGlscy5kb21Ob2RlRGlzcG9zYWwuYWRkRGlzcG9zZUNhbGxiYWNrJywga28udXRpbHMuZG9tTm9kZURpc3Bvc2FsLmFkZERpc3Bvc2VDYWxsYmFjayk7Cglrby5leHBvcnRTeW1ib2woJ3V0aWxzLmRvbU5vZGVEaXNwb3NhbC5yZW1vdmVEaXNwb3NlQ2FsbGJhY2snLCBrby51dGlscy5kb21Ob2RlRGlzcG9zYWwucmVtb3ZlRGlzcG9zZUNhbGxiYWNrKTsKCShmdW5jdGlvbiAoKSB7CgkgICAgdmFyIGxlYWRpbmdDb21tZW50UmVnZXggPSAvXihccyopPCEtLSguKj8pLS0+LzsKCgkgICAgZnVuY3Rpb24gc2ltcGxlSHRtbFBhcnNlKGh0bWwpIHsKCSAgICAgICAgLy8gQmFzZWQgb24galF1ZXJ5J3MgImNsZWFuIiBmdW5jdGlvbiwgYnV0IG9ubHkgYWNjb3VudGluZyBmb3IgdGFibGUtcmVsYXRlZCBlbGVtZW50cy4KCSAgICAgICAgLy8gSWYgeW91IGhhdmUgcmVmZXJlbmNlZCBqUXVlcnksIHRoaXMgd29uJ3QgYmUgdXNlZCBhbnl3YXkgLSBLTyB3aWxsIHVzZSBqUXVlcnkncyAiY2xlYW4iIGZ1bmN0aW9uIGRpcmVjdGx5CgoJICAgICAgICAvLyBOb3RlIHRoYXQgdGhlcmUncyBzdGlsbCBhbiBpc3N1ZSBpbiBJRSA8IDkgd2hlcmVieSBpdCB3aWxsIGRpc2NhcmQgY29tbWVudCBub2RlcyB0aGF0IGFyZSB0aGUgZmlyc3QgY2hpbGQgb2YKCSAgICAgICAgLy8gYSBkZXNjZW5kYW50IG5vZGUuIEZvciBleGFtcGxlOiAiPGRpdj48IS0tIG15Y29tbWVudCAtLT5hYmM8L2Rpdj4iIHdpbGwgZ2V0IHBhcnNlZCBhcyAiPGRpdj5hYmM8L2Rpdj4iCgkgICAgICAgIC8vIFRoaXMgd29uJ3QgYWZmZWN0IGFueW9uZSB3aG8gaGFzIHJlZmVyZW5jZWQgalF1ZXJ5LCBhbmQgdGhlcmUncyBhbHdheXMgdGhlIHdvcmthcm91bmQgb2YgaW5zZXJ0aW5nIGEgZHVtbXkgbm9kZQoJICAgICAgICAvLyAocG9zc2libHkgYSB0ZXh0IG5vZGUpIGluIGZyb250IG9mIHRoZSBjb21tZW50LiBTbywgS08gZG9lcyBub3QgYXR0ZW1wdCB0byB3b3JrYXJvdW5kIHRoaXMgSUUgaXNzdWUgYXV0b21hdGljYWxseSBhdCBwcmVzZW50LgoKCSAgICAgICAgLy8gVHJpbSB3aGl0ZXNwYWNlLCBvdGhlcndpc2UgaW5kZXhPZiB3b24ndCB3b3JrIGFzIGV4cGVjdGVkCgkgICAgICAgIHZhciB0YWdzID0ga28udXRpbHMuc3RyaW5nVHJpbShodG1sKS50b0xvd2VyQ2FzZSgpLCBkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKCgkgICAgICAgIC8vIEZpbmRzIHRoZSBmaXJzdCBtYXRjaCBmcm9tIHRoZSBsZWZ0IGNvbHVtbiwgYW5kIHJldHVybnMgdGhlIGNvcnJlc3BvbmRpbmcgIndyYXAiIGRhdGEgZnJvbSB0aGUgcmlnaHQgY29sdW1uCgkgICAgICAgIHZhciB3cmFwID0gdGFncy5tYXRjaCgvXjwodGhlYWR8dGJvZHl8dGZvb3QpLykgICAgICAgICAgICAgICYmIFsxLCAiPHRhYmxlPiIsICI8L3RhYmxlPiJdIHx8CgkgICAgICAgICAgICAgICAgICAgIXRhZ3MuaW5kZXhPZigiPHRyIikgICAgICAgICAgICAgICAgICAgICAgICAgICAgICYmIFsyLCAiPHRhYmxlPjx0Ym9keT4iLCAiPC90Ym9keT48L3RhYmxlPiJdIHx8CgkgICAgICAgICAgICAgICAgICAgKCF0YWdzLmluZGV4T2YoIjx0ZCIpIHx8ICF0YWdzLmluZGV4T2YoIjx0aCIpKSAgICYmIFszLCAiPHRhYmxlPjx0Ym9keT48dHI+IiwgIjwvdHI+PC90Ym9keT48L3RhYmxlPiJdIHx8CgkgICAgICAgICAgICAgICAgICAgLyogYW55dGhpbmcgZWxzZSAqLyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFswLCAiIiwgIiJdOwoKCSAgICAgICAgLy8gR28gdG8gaHRtbCBhbmQgYmFjaywgdGhlbiBwZWVsIG9mZiBleHRyYSB3cmFwcGVycwoJICAgICAgICAvLyBOb3RlIHRoYXQgd2UgYWx3YXlzIHByZWZpeCB3aXRoIHNvbWUgZHVtbXkgdGV4dCwgYmVjYXVzZSBvdGhlcndpc2UsIElFPDkgd2lsbCBzdHJpcCBvdXQgbGVhZGluZyBjb21tZW50IG5vZGVzIGluIGRlc2NlbmRhbnRzLiBUb3RhbCBtYWRuZXNzLgoJICAgICAgICB2YXIgbWFya3VwID0gImlnbm9yZWQ8ZGl2PiIgKyB3cmFwWzFdICsgaHRtbCArIHdyYXBbMl0gKyAiPC9kaXY+IjsKCSAgICAgICAgaWYgKHR5cGVvZiB3aW5kb3dbJ2lubmVyU2hpdiddID09ICJmdW5jdGlvbiIpIHsKCSAgICAgICAgICAgIGRpdi5hcHBlbmRDaGlsZCh3aW5kb3dbJ2lubmVyU2hpdiddKG1hcmt1cCkpOwoJICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgZGl2LmlubmVySFRNTCA9IG1hcmt1cDsKCSAgICAgICAgfQoKCSAgICAgICAgLy8gTW92ZSB0byB0aGUgcmlnaHQgZGVwdGgKCSAgICAgICAgd2hpbGUgKHdyYXBbMF0tLSkKCSAgICAgICAgICAgIGRpdiA9IGRpdi5sYXN0Q2hpbGQ7CgoJICAgICAgICByZXR1cm4ga28udXRpbHMubWFrZUFycmF5KGRpdi5sYXN0Q2hpbGQuY2hpbGROb2Rlcyk7CgkgICAgfQoKCSAgICBmdW5jdGlvbiBqUXVlcnlIdG1sUGFyc2UoaHRtbCkgewoJICAgICAgICAvLyBqUXVlcnkncyAicGFyc2VIVE1MIiBmdW5jdGlvbiB3YXMgaW50cm9kdWNlZCBpbiBqUXVlcnkgMS44LjAgYW5kIGlzIGEgZG9jdW1lbnRlZCBwdWJsaWMgQVBJLgoJICAgICAgICBpZiAoalF1ZXJ5SW5zdGFuY2VbJ3BhcnNlSFRNTCddKSB7CgkgICAgICAgICAgICByZXR1cm4galF1ZXJ5SW5zdGFuY2VbJ3BhcnNlSFRNTCddKGh0bWwpIHx8IFtdOyAvLyBFbnN1cmUgd2UgYWx3YXlzIHJldHVybiBhbiBhcnJheSBhbmQgbmV2ZXIgbnVsbAoJICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgLy8gRm9yIGpRdWVyeSA8IDEuOC4wLCB3ZSBmYWxsIGJhY2sgb24gdGhlIHVuZG9jdW1lbnRlZCBpbnRlcm5hbCAiY2xlYW4iIGZ1bmN0aW9uLgoJICAgICAgICAgICAgdmFyIGVsZW1zID0galF1ZXJ5SW5zdGFuY2VbJ2NsZWFuJ10oW2h0bWxdKTsKCgkgICAgICAgICAgICAvLyBBcyBvZiBqUXVlcnkgMS43LjEsIGpRdWVyeSBwYXJzZXMgdGhlIEhUTUwgYnkgYXBwZW5kaW5nIGl0IHRvIHNvbWUgZHVtbXkgcGFyZW50IG5vZGVzIGhlbGQgaW4gYW4gaW4tbWVtb3J5IGRvY3VtZW50IGZyYWdtZW50LgoJICAgICAgICAgICAgLy8gVW5mb3J0dW5hdGVseSwgaXQgbmV2ZXIgY2xlYXJzIHRoZSBkdW1teSBwYXJlbnQgbm9kZXMgZnJvbSB0aGUgZG9jdW1lbnQgZnJhZ21lbnQsIHNvIGl0IGxlYWtzIG1lbW9yeSBvdmVyIHRpbWUuCgkgICAgICAgICAgICAvLyBGaXggdGhpcyBieSBmaW5kaW5nIHRoZSB0b3AtbW9zdCBkdW1teSBwYXJlbnQgZWxlbWVudCwgYW5kIGRldGFjaGluZyBpdCBmcm9tIGl0cyBvd25lciBmcmFnbWVudC4KCSAgICAgICAgICAgIGlmIChlbGVtcyAmJiBlbGVtc1swXSkgewoJICAgICAgICAgICAgICAgIC8vIEZpbmQgdGhlIHRvcC1tb3N0IHBhcmVudCBlbGVtZW50IHRoYXQncyBhIGRpcmVjdCBjaGlsZCBvZiBhIGRvY3VtZW50IGZyYWdtZW50CgkgICAgICAgICAgICAgICAgdmFyIGVsZW0gPSBlbGVtc1swXTsKCSAgICAgICAgICAgICAgICB3aGlsZSAoZWxlbS5wYXJlbnROb2RlICYmIGVsZW0ucGFyZW50Tm9kZS5ub2RlVHlwZSAhPT0gMTEgLyogaS5lLiwgRG9jdW1lbnRGcmFnbWVudCAqLykKCSAgICAgICAgICAgICAgICAgICAgZWxlbSA9IGVsZW0ucGFyZW50Tm9kZTsKCSAgICAgICAgICAgICAgICAvLyAuLi4gdGhlbiBkZXRhY2ggaXQKCSAgICAgICAgICAgICAgICBpZiAoZWxlbS5wYXJlbnROb2RlKQoJICAgICAgICAgICAgICAgICAgICBlbGVtLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoZWxlbSk7CgkgICAgICAgICAgICB9CgoJICAgICAgICAgICAgcmV0dXJuIGVsZW1zOwoJICAgICAgICB9CgkgICAgfQoKCSAgICBrby51dGlscy5wYXJzZUh0bWxGcmFnbWVudCA9IGZ1bmN0aW9uKGh0bWwpIHsKCSAgICAgICAgcmV0dXJuIGpRdWVyeUluc3RhbmNlID8galF1ZXJ5SHRtbFBhcnNlKGh0bWwpICAgLy8gQXMgYmVsb3csIGJlbmVmaXQgZnJvbSBqUXVlcnkncyBvcHRpbWlzYXRpb25zIHdoZXJlIHBvc3NpYmxlCgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA6IHNpbXBsZUh0bWxQYXJzZShodG1sKTsgIC8vIC4uLiBvdGhlcndpc2UsIHRoaXMgc2ltcGxlIGxvZ2ljIHdpbGwgZG8gaW4gbW9zdCBjb21tb24gY2FzZXMuCgkgICAgfTsKCgkgICAga28udXRpbHMuc2V0SHRtbCA9IGZ1bmN0aW9uKG5vZGUsIGh0bWwpIHsKCSAgICAgICAga28udXRpbHMuZW1wdHlEb21Ob2RlKG5vZGUpOwoKCSAgICAgICAgLy8gVGhlcmUncyBubyBsZWdpdGltYXRlIHJlYXNvbiB0byBkaXNwbGF5IGEgc3RyaW5naWZpZWQgb2JzZXJ2YWJsZSB3aXRob3V0IHVud3JhcHBpbmcgaXQsIHNvIHdlJ2xsIHVud3JhcCBpdAoJICAgICAgICBodG1sID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZShodG1sKTsKCgkgICAgICAgIGlmICgoaHRtbCAhPT0gbnVsbCkgJiYgKGh0bWwgIT09IHVuZGVmaW5lZCkpIHsKCSAgICAgICAgICAgIGlmICh0eXBlb2YgaHRtbCAhPSAnc3RyaW5nJykKCSAgICAgICAgICAgICAgICBodG1sID0gaHRtbC50b1N0cmluZygpOwoKCSAgICAgICAgICAgIC8vIGpRdWVyeSBjb250YWlucyBhIGxvdCBvZiBzb3BoaXN0aWNhdGVkIGNvZGUgdG8gcGFyc2UgYXJiaXRyYXJ5IEhUTUwgZnJhZ21lbnRzLAoJICAgICAgICAgICAgLy8gZm9yIGV4YW1wbGUgPHRyPiBlbGVtZW50cyB3aGljaCBhcmUgbm90IG5vcm1hbGx5IGFsbG93ZWQgdG8gZXhpc3Qgb24gdGhlaXIgb3duLgoJICAgICAgICAgICAgLy8gSWYgeW91J3ZlIHJlZmVyZW5jZWQgalF1ZXJ5IHdlJ2xsIHVzZSB0aGF0IHJhdGhlciB0aGFuIGR1cGxpY2F0aW5nIGl0cyBjb2RlLgoJICAgICAgICAgICAgaWYgKGpRdWVyeUluc3RhbmNlKSB7CgkgICAgICAgICAgICAgICAgalF1ZXJ5SW5zdGFuY2Uobm9kZSlbJ2h0bWwnXShodG1sKTsKCSAgICAgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICAgICAgLy8gLi4uIG90aGVyd2lzZSwgdXNlIEtPJ3Mgb3duIHBhcnNpbmcgbG9naWMuCgkgICAgICAgICAgICAgICAgdmFyIHBhcnNlZE5vZGVzID0ga28udXRpbHMucGFyc2VIdG1sRnJhZ21lbnQoaHRtbCk7CgkgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwYXJzZWROb2Rlcy5sZW5ndGg7IGkrKykKCSAgICAgICAgICAgICAgICAgICAgbm9kZS5hcHBlbmRDaGlsZChwYXJzZWROb2Rlc1tpXSk7CgkgICAgICAgICAgICB9CgkgICAgICAgIH0KCSAgICB9OwoJfSkoKTsKCglrby5leHBvcnRTeW1ib2woJ3V0aWxzLnBhcnNlSHRtbEZyYWdtZW50Jywga28udXRpbHMucGFyc2VIdG1sRnJhZ21lbnQpOwoJa28uZXhwb3J0U3ltYm9sKCd1dGlscy5zZXRIdG1sJywga28udXRpbHMuc2V0SHRtbCk7CgoJa28ubWVtb2l6YXRpb24gPSAoZnVuY3Rpb24gKCkgewoJICAgIHZhciBtZW1vcyA9IHt9OwoKCSAgICBmdW5jdGlvbiByYW5kb21NYXg4SGV4Q2hhcnMoKSB7CgkgICAgICAgIHJldHVybiAoKCgxICsgTWF0aC5yYW5kb20oKSkgKiAweDEwMDAwMDAwMCkgfCAwKS50b1N0cmluZygxNikuc3Vic3RyaW5nKDEpOwoJICAgIH0KCSAgICBmdW5jdGlvbiBnZW5lcmF0ZVJhbmRvbUlkKCkgewoJICAgICAgICByZXR1cm4gcmFuZG9tTWF4OEhleENoYXJzKCkgKyByYW5kb21NYXg4SGV4Q2hhcnMoKTsKCSAgICB9CgkgICAgZnVuY3Rpb24gZmluZE1lbW9Ob2Rlcyhyb290Tm9kZSwgYXBwZW5kVG9BcnJheSkgewoJICAgICAgICBpZiAoIXJvb3ROb2RlKQoJICAgICAgICAgICAgcmV0dXJuOwoJICAgICAgICBpZiAocm9vdE5vZGUubm9kZVR5cGUgPT0gOCkgewoJICAgICAgICAgICAgdmFyIG1lbW9JZCA9IGtvLm1lbW9pemF0aW9uLnBhcnNlTWVtb1RleHQocm9vdE5vZGUubm9kZVZhbHVlKTsKCSAgICAgICAgICAgIGlmIChtZW1vSWQgIT0gbnVsbCkKCSAgICAgICAgICAgICAgICBhcHBlbmRUb0FycmF5LnB1c2goeyBkb21Ob2RlOiByb290Tm9kZSwgbWVtb0lkOiBtZW1vSWQgfSk7CgkgICAgICAgIH0gZWxzZSBpZiAocm9vdE5vZGUubm9kZVR5cGUgPT0gMSkgewoJICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGNoaWxkTm9kZXMgPSByb290Tm9kZS5jaGlsZE5vZGVzLCBqID0gY2hpbGROb2Rlcy5sZW5ndGg7IGkgPCBqOyBpKyspCgkgICAgICAgICAgICAgICAgZmluZE1lbW9Ob2RlcyhjaGlsZE5vZGVzW2ldLCBhcHBlbmRUb0FycmF5KTsKCSAgICAgICAgfQoJICAgIH0KCgkgICAgcmV0dXJuIHsKCSAgICAgICAgbWVtb2l6ZTogZnVuY3Rpb24gKGNhbGxiYWNrKSB7CgkgICAgICAgICAgICBpZiAodHlwZW9mIGNhbGxiYWNrICE9ICJmdW5jdGlvbiIpCgkgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJZb3UgY2FuIG9ubHkgcGFzcyBhIGZ1bmN0aW9uIHRvIGtvLm1lbW9pemF0aW9uLm1lbW9pemUoKSIpOwoJICAgICAgICAgICAgdmFyIG1lbW9JZCA9IGdlbmVyYXRlUmFuZG9tSWQoKTsKCSAgICAgICAgICAgIG1lbW9zW21lbW9JZF0gPSBjYWxsYmFjazsKCSAgICAgICAgICAgIHJldHVybiAiPCEtLVtrb19tZW1vOiIgKyBtZW1vSWQgKyAiXS0tPiI7CgkgICAgICAgIH0sCgoJICAgICAgICB1bm1lbW9pemU6IGZ1bmN0aW9uIChtZW1vSWQsIGNhbGxiYWNrUGFyYW1zKSB7CgkgICAgICAgICAgICB2YXIgY2FsbGJhY2sgPSBtZW1vc1ttZW1vSWRdOwoJICAgICAgICAgICAgaWYgKGNhbGxiYWNrID09PSB1bmRlZmluZWQpCgkgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJDb3VsZG4ndCBmaW5kIGFueSBtZW1vIHdpdGggSUQgIiArIG1lbW9JZCArICIuIFBlcmhhcHMgaXQncyBhbHJlYWR5IGJlZW4gdW5tZW1vaXplZC4iKTsKCSAgICAgICAgICAgIHRyeSB7CgkgICAgICAgICAgICAgICAgY2FsbGJhY2suYXBwbHkobnVsbCwgY2FsbGJhY2tQYXJhbXMgfHwgW10pOwoJICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgZmluYWxseSB7IGRlbGV0ZSBtZW1vc1ttZW1vSWRdOyB9CgkgICAgICAgIH0sCgoJICAgICAgICB1bm1lbW9pemVEb21Ob2RlQW5kRGVzY2VuZGFudHM6IGZ1bmN0aW9uIChkb21Ob2RlLCBleHRyYUNhbGxiYWNrUGFyYW1zQXJyYXkpIHsKCSAgICAgICAgICAgIHZhciBtZW1vcyA9IFtdOwoJICAgICAgICAgICAgZmluZE1lbW9Ob2Rlcyhkb21Ob2RlLCBtZW1vcyk7CgkgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaiA9IG1lbW9zLmxlbmd0aDsgaSA8IGo7IGkrKykgewoJICAgICAgICAgICAgICAgIHZhciBub2RlID0gbWVtb3NbaV0uZG9tTm9kZTsKCSAgICAgICAgICAgICAgICB2YXIgY29tYmluZWRQYXJhbXMgPSBbbm9kZV07CgkgICAgICAgICAgICAgICAgaWYgKGV4dHJhQ2FsbGJhY2tQYXJhbXNBcnJheSkKCSAgICAgICAgICAgICAgICAgICAga28udXRpbHMuYXJyYXlQdXNoQWxsKGNvbWJpbmVkUGFyYW1zLCBleHRyYUNhbGxiYWNrUGFyYW1zQXJyYXkpOwoJICAgICAgICAgICAgICAgIGtvLm1lbW9pemF0aW9uLnVubWVtb2l6ZShtZW1vc1tpXS5tZW1vSWQsIGNvbWJpbmVkUGFyYW1zKTsKCSAgICAgICAgICAgICAgICBub2RlLm5vZGVWYWx1ZSA9ICIiOyAvLyBOZXV0ZXIgdGhpcyBub2RlIHNvIHdlIGRvbid0IHRyeSB0byB1bm1lbW9pemUgaXQgYWdhaW4KCSAgICAgICAgICAgICAgICBpZiAobm9kZS5wYXJlbnROb2RlKQoJICAgICAgICAgICAgICAgICAgICBub2RlLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQobm9kZSk7IC8vIElmIHBvc3NpYmxlLCBlcmFzZSBpdCB0b3RhbGx5IChub3QgYWx3YXlzIHBvc3NpYmxlIC0gc29tZW9uZSBlbHNlIG1pZ2h0IGp1c3QgaG9sZCBhIHJlZmVyZW5jZSB0byBpdCB0aGVuIGNhbGwgdW5tZW1vaXplRG9tTm9kZUFuZERlc2NlbmRhbnRzIGFnYWluKQoJICAgICAgICAgICAgfQoJICAgICAgICB9LAoKCSAgICAgICAgcGFyc2VNZW1vVGV4dDogZnVuY3Rpb24gKG1lbW9UZXh0KSB7CgkgICAgICAgICAgICB2YXIgbWF0Y2ggPSBtZW1vVGV4dC5tYXRjaCgvXlxba29fbWVtb1w6KC4qPylcXSQvKTsKCSAgICAgICAgICAgIHJldHVybiBtYXRjaCA/IG1hdGNoWzFdIDogbnVsbDsKCSAgICAgICAgfQoJICAgIH07Cgl9KSgpOwoKCWtvLmV4cG9ydFN5bWJvbCgnbWVtb2l6YXRpb24nLCBrby5tZW1vaXphdGlvbik7Cglrby5leHBvcnRTeW1ib2woJ21lbW9pemF0aW9uLm1lbW9pemUnLCBrby5tZW1vaXphdGlvbi5tZW1vaXplKTsKCWtvLmV4cG9ydFN5bWJvbCgnbWVtb2l6YXRpb24udW5tZW1vaXplJywga28ubWVtb2l6YXRpb24udW5tZW1vaXplKTsKCWtvLmV4cG9ydFN5bWJvbCgnbWVtb2l6YXRpb24ucGFyc2VNZW1vVGV4dCcsIGtvLm1lbW9pemF0aW9uLnBhcnNlTWVtb1RleHQpOwoJa28uZXhwb3J0U3ltYm9sKCdtZW1vaXphdGlvbi51bm1lbW9pemVEb21Ob2RlQW5kRGVzY2VuZGFudHMnLCBrby5tZW1vaXphdGlvbi51bm1lbW9pemVEb21Ob2RlQW5kRGVzY2VuZGFudHMpOwoJa28uZXh0ZW5kZXJzID0gewoJICAgICd0aHJvdHRsZSc6IGZ1bmN0aW9uKHRhcmdldCwgdGltZW91dCkgewoJICAgICAgICAvLyBUaHJvdHRsaW5nIG1lYW5zIHR3byB0aGluZ3M6CgoJICAgICAgICAvLyAoMSkgRm9yIGRlcGVuZGVudCBvYnNlcnZhYmxlcywgd2UgdGhyb3R0bGUgKmV2YWx1YXRpb25zKiBzbyB0aGF0LCBubyBtYXR0ZXIgaG93IGZhc3QgaXRzIGRlcGVuZGVuY2llcwoJICAgICAgICAvLyAgICAgbm90aWZ5IHVwZGF0ZXMsIHRoZSB0YXJnZXQgZG9lc24ndCByZS1ldmFsdWF0ZSAoYW5kIGhlbmNlIGRvZXNuJ3Qgbm90aWZ5KSBmYXN0ZXIgdGhhbiBhIGNlcnRhaW4gcmF0ZQoJICAgICAgICB0YXJnZXRbJ3Rocm90dGxlRXZhbHVhdGlvbiddID0gdGltZW91dDsKCgkgICAgICAgIC8vICgyKSBGb3Igd3JpdGFibGUgdGFyZ2V0cyAob2JzZXJ2YWJsZXMsIG9yIHdyaXRhYmxlIGRlcGVuZGVudCBvYnNlcnZhYmxlcyksIHdlIHRocm90dGxlICp3cml0ZXMqCgkgICAgICAgIC8vICAgICBzbyB0aGUgdGFyZ2V0IGNhbm5vdCBjaGFuZ2UgdmFsdWUgc3luY2hyb25vdXNseSBvciBmYXN0ZXIgdGhhbiBhIGNlcnRhaW4gcmF0ZQoJICAgICAgICB2YXIgd3JpdGVUaW1lb3V0SW5zdGFuY2UgPSBudWxsOwoJICAgICAgICByZXR1cm4ga28uZGVwZW5kZW50T2JzZXJ2YWJsZSh7CgkgICAgICAgICAgICAncmVhZCc6IHRhcmdldCwKCSAgICAgICAgICAgICd3cml0ZSc6IGZ1bmN0aW9uKHZhbHVlKSB7CgkgICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHdyaXRlVGltZW91dEluc3RhbmNlKTsKCSAgICAgICAgICAgICAgICB3cml0ZVRpbWVvdXRJbnN0YW5jZSA9IHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CgkgICAgICAgICAgICAgICAgICAgIHRhcmdldCh2YWx1ZSk7CgkgICAgICAgICAgICAgICAgfSwgdGltZW91dCk7CgkgICAgICAgICAgICB9CgkgICAgICAgIH0pOwoJICAgIH0sCgoJICAgICdyYXRlTGltaXQnOiBmdW5jdGlvbih0YXJnZXQsIG9wdGlvbnMpIHsKCSAgICAgICAgdmFyIHRpbWVvdXQsIG1ldGhvZCwgbGltaXRGdW5jdGlvbjsKCgkgICAgICAgIGlmICh0eXBlb2Ygb3B0aW9ucyA9PSAnbnVtYmVyJykgewoJICAgICAgICAgICAgdGltZW91dCA9IG9wdGlvbnM7CgkgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICB0aW1lb3V0ID0gb3B0aW9uc1sndGltZW91dCddOwoJICAgICAgICAgICAgbWV0aG9kID0gb3B0aW9uc1snbWV0aG9kJ107CgkgICAgICAgIH0KCgkgICAgICAgIGxpbWl0RnVuY3Rpb24gPSBtZXRob2QgPT0gJ25vdGlmeVdoZW5DaGFuZ2VzU3RvcCcgPyAgZGVib3VuY2UgOiB0aHJvdHRsZTsKCSAgICAgICAgdGFyZ2V0LmxpbWl0KGZ1bmN0aW9uKGNhbGxiYWNrKSB7CgkgICAgICAgICAgICByZXR1cm4gbGltaXRGdW5jdGlvbihjYWxsYmFjaywgdGltZW91dCk7CgkgICAgICAgIH0pOwoJICAgIH0sCgoJICAgICdub3RpZnknOiBmdW5jdGlvbih0YXJnZXQsIG5vdGlmeVdoZW4pIHsKCSAgICAgICAgdGFyZ2V0WyJlcXVhbGl0eUNvbXBhcmVyIl0gPSBub3RpZnlXaGVuID09ICJhbHdheXMiID8KCSAgICAgICAgICAgIG51bGwgOiAgLy8gbnVsbCBlcXVhbGl0eUNvbXBhcmVyIG1lYW5zIHRvIGFsd2F5cyBub3RpZnkKCSAgICAgICAgICAgIHZhbHVlc0FyZVByaW1pdGl2ZUFuZEVxdWFsOwoJICAgIH0KCX07CgoJdmFyIHByaW1pdGl2ZVR5cGVzID0geyAndW5kZWZpbmVkJzoxLCAnYm9vbGVhbic6MSwgJ251bWJlcic6MSwgJ3N0cmluZyc6MSB9OwoJZnVuY3Rpb24gdmFsdWVzQXJlUHJpbWl0aXZlQW5kRXF1YWwoYSwgYikgewoJICAgIHZhciBvbGRWYWx1ZUlzUHJpbWl0aXZlID0gKGEgPT09IG51bGwpIHx8ICh0eXBlb2YoYSkgaW4gcHJpbWl0aXZlVHlwZXMpOwoJICAgIHJldHVybiBvbGRWYWx1ZUlzUHJpbWl0aXZlID8gKGEgPT09IGIpIDogZmFsc2U7Cgl9CgoJZnVuY3Rpb24gdGhyb3R0bGUoY2FsbGJhY2ssIHRpbWVvdXQpIHsKCSAgICB2YXIgdGltZW91dEluc3RhbmNlOwoJICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CgkgICAgICAgIGlmICghdGltZW91dEluc3RhbmNlKSB7CgkgICAgICAgICAgICB0aW1lb3V0SW5zdGFuY2UgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoJICAgICAgICAgICAgICAgIHRpbWVvdXRJbnN0YW5jZSA9IHVuZGVmaW5lZDsKCSAgICAgICAgICAgICAgICBjYWxsYmFjaygpOwoJICAgICAgICAgICAgfSwgdGltZW91dCk7CgkgICAgICAgIH0KCSAgICB9OwoJfQoKCWZ1bmN0aW9uIGRlYm91bmNlKGNhbGxiYWNrLCB0aW1lb3V0KSB7CgkgICAgdmFyIHRpbWVvdXRJbnN0YW5jZTsKCSAgICByZXR1cm4gZnVuY3Rpb24gKCkgewoJICAgICAgICBjbGVhclRpbWVvdXQodGltZW91dEluc3RhbmNlKTsKCSAgICAgICAgdGltZW91dEluc3RhbmNlID0gc2V0VGltZW91dChjYWxsYmFjaywgdGltZW91dCk7CgkgICAgfTsKCX0KCglmdW5jdGlvbiBhcHBseUV4dGVuZGVycyhyZXF1ZXN0ZWRFeHRlbmRlcnMpIHsKCSAgICB2YXIgdGFyZ2V0ID0gdGhpczsKCSAgICBpZiAocmVxdWVzdGVkRXh0ZW5kZXJzKSB7CgkgICAgICAgIGtvLnV0aWxzLm9iamVjdEZvckVhY2gocmVxdWVzdGVkRXh0ZW5kZXJzLCBmdW5jdGlvbihrZXksIHZhbHVlKSB7CgkgICAgICAgICAgICB2YXIgZXh0ZW5kZXJIYW5kbGVyID0ga28uZXh0ZW5kZXJzW2tleV07CgkgICAgICAgICAgICBpZiAodHlwZW9mIGV4dGVuZGVySGFuZGxlciA9PSAnZnVuY3Rpb24nKSB7CgkgICAgICAgICAgICAgICAgdGFyZ2V0ID0gZXh0ZW5kZXJIYW5kbGVyKHRhcmdldCwgdmFsdWUpIHx8IHRhcmdldDsKCSAgICAgICAgICAgIH0KCSAgICAgICAgfSk7CgkgICAgfQoJICAgIHJldHVybiB0YXJnZXQ7Cgl9CgoJa28uZXhwb3J0U3ltYm9sKCdleHRlbmRlcnMnLCBrby5leHRlbmRlcnMpOwoKCWtvLnN1YnNjcmlwdGlvbiA9IGZ1bmN0aW9uICh0YXJnZXQsIGNhbGxiYWNrLCBkaXNwb3NlQ2FsbGJhY2spIHsKCSAgICB0aGlzLnRhcmdldCA9IHRhcmdldDsKCSAgICB0aGlzLmNhbGxiYWNrID0gY2FsbGJhY2s7CgkgICAgdGhpcy5kaXNwb3NlQ2FsbGJhY2sgPSBkaXNwb3NlQ2FsbGJhY2s7CgkgICAgdGhpcy5pc0Rpc3Bvc2VkID0gZmFsc2U7CgkgICAga28uZXhwb3J0UHJvcGVydHkodGhpcywgJ2Rpc3Bvc2UnLCB0aGlzLmRpc3Bvc2UpOwoJfTsKCWtvLnN1YnNjcmlwdGlvbi5wcm90b3R5cGUuZGlzcG9zZSA9IGZ1bmN0aW9uICgpIHsKCSAgICB0aGlzLmlzRGlzcG9zZWQgPSB0cnVlOwoJICAgIHRoaXMuZGlzcG9zZUNhbGxiYWNrKCk7Cgl9OwoKCWtvLnN1YnNjcmliYWJsZSA9IGZ1bmN0aW9uICgpIHsKCSAgICBrby51dGlscy5zZXRQcm90b3R5cGVPZk9yRXh0ZW5kKHRoaXMsIGtvLnN1YnNjcmliYWJsZVsnZm4nXSk7CgkgICAgdGhpcy5fc3Vic2NyaXB0aW9ucyA9IHt9OwoJfQoKCXZhciBkZWZhdWx0RXZlbnQgPSAiY2hhbmdlIjsKCgl2YXIga29fc3Vic2NyaWJhYmxlX2ZuID0gewoJICAgIHN1YnNjcmliZTogZnVuY3Rpb24gKGNhbGxiYWNrLCBjYWxsYmFja1RhcmdldCwgZXZlbnQpIHsKCSAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwoKCSAgICAgICAgZXZlbnQgPSBldmVudCB8fCBkZWZhdWx0RXZlbnQ7CgkgICAgICAgIHZhciBib3VuZENhbGxiYWNrID0gY2FsbGJhY2tUYXJnZXQgPyBjYWxsYmFjay5iaW5kKGNhbGxiYWNrVGFyZ2V0KSA6IGNhbGxiYWNrOwoKCSAgICAgICAgdmFyIHN1YnNjcmlwdGlvbiA9IG5ldyBrby5zdWJzY3JpcHRpb24oc2VsZiwgYm91bmRDYWxsYmFjaywgZnVuY3Rpb24gKCkgewoJICAgICAgICAgICAga28udXRpbHMuYXJyYXlSZW1vdmVJdGVtKHNlbGYuX3N1YnNjcmlwdGlvbnNbZXZlbnRdLCBzdWJzY3JpcHRpb24pOwoJICAgICAgICAgICAgaWYgKHNlbGYuYWZ0ZXJTdWJzY3JpcHRpb25SZW1vdmUpCgkgICAgICAgICAgICAgICAgc2VsZi5hZnRlclN1YnNjcmlwdGlvblJlbW92ZShldmVudCk7CgkgICAgICAgIH0pOwoKCSAgICAgICAgaWYgKHNlbGYuYmVmb3JlU3Vic2NyaXB0aW9uQWRkKQoJICAgICAgICAgICAgc2VsZi5iZWZvcmVTdWJzY3JpcHRpb25BZGQoZXZlbnQpOwoKCSAgICAgICAgaWYgKCFzZWxmLl9zdWJzY3JpcHRpb25zW2V2ZW50XSkKCSAgICAgICAgICAgIHNlbGYuX3N1YnNjcmlwdGlvbnNbZXZlbnRdID0gW107CgkgICAgICAgIHNlbGYuX3N1YnNjcmlwdGlvbnNbZXZlbnRdLnB1c2goc3Vic2NyaXB0aW9uKTsKCgkgICAgICAgIHJldHVybiBzdWJzY3JpcHRpb247CgkgICAgfSwKCgkgICAgIm5vdGlmeVN1YnNjcmliZXJzIjogZnVuY3Rpb24gKHZhbHVlVG9Ob3RpZnksIGV2ZW50KSB7CgkgICAgICAgIGV2ZW50ID0gZXZlbnQgfHwgZGVmYXVsdEV2ZW50OwoJICAgICAgICBpZiAodGhpcy5oYXNTdWJzY3JpcHRpb25zRm9yRXZlbnQoZXZlbnQpKSB7CgkgICAgICAgICAgICB0cnkgewoJICAgICAgICAgICAgICAgIGtvLmRlcGVuZGVuY3lEZXRlY3Rpb24uYmVnaW4oKTsgLy8gQmVnaW4gc3VwcHJlc3NpbmcgZGVwZW5kZW5jeSBkZXRlY3Rpb24gKGJ5IHNldHRpbmcgdGhlIHRvcCBmcmFtZSB0byB1bmRlZmluZWQpCgkgICAgICAgICAgICAgICAgZm9yICh2YXIgYSA9IHRoaXMuX3N1YnNjcmlwdGlvbnNbZXZlbnRdLnNsaWNlKDApLCBpID0gMCwgc3Vic2NyaXB0aW9uOyBzdWJzY3JpcHRpb24gPSBhW2ldOyArK2kpIHsKCSAgICAgICAgICAgICAgICAgICAgLy8gSW4gY2FzZSBhIHN1YnNjcmlwdGlvbiB3YXMgZGlzcG9zZWQgZHVyaW5nIHRoZSBhcnJheUZvckVhY2ggY3ljbGUsIGNoZWNrCgkgICAgICAgICAgICAgICAgICAgIC8vIGZvciBpc0Rpc3Bvc2VkIG9uIGVhY2ggc3Vic2NyaXB0aW9uIGJlZm9yZSBpbnZva2luZyBpdHMgY2FsbGJhY2sKCSAgICAgICAgICAgICAgICAgICAgaWYgKCFzdWJzY3JpcHRpb24uaXNEaXNwb3NlZCkKCSAgICAgICAgICAgICAgICAgICAgICAgIHN1YnNjcmlwdGlvbi5jYWxsYmFjayh2YWx1ZVRvTm90aWZ5KTsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICB9IGZpbmFsbHkgewoJICAgICAgICAgICAgICAgIGtvLmRlcGVuZGVuY3lEZXRlY3Rpb24uZW5kKCk7IC8vIEVuZCBzdXBwcmVzc2luZyBkZXBlbmRlbmN5IGRldGVjdGlvbgoJICAgICAgICAgICAgfQoJICAgICAgICB9CgkgICAgfSwKCgkgICAgbGltaXQ6IGZ1bmN0aW9uKGxpbWl0RnVuY3Rpb24pIHsKCSAgICAgICAgdmFyIHNlbGYgPSB0aGlzLCBzZWxmSXNPYnNlcnZhYmxlID0ga28uaXNPYnNlcnZhYmxlKHNlbGYpLAoJICAgICAgICAgICAgaXNQZW5kaW5nLCBwcmV2aW91c1ZhbHVlLCBwZW5kaW5nVmFsdWUsIGJlZm9yZUNoYW5nZSA9ICdiZWZvcmVDaGFuZ2UnOwoKCSAgICAgICAgaWYgKCFzZWxmLl9vcmlnTm90aWZ5U3Vic2NyaWJlcnMpIHsKCSAgICAgICAgICAgIHNlbGYuX29yaWdOb3RpZnlTdWJzY3JpYmVycyA9IHNlbGZbIm5vdGlmeVN1YnNjcmliZXJzIl07CgkgICAgICAgICAgICBzZWxmWyJub3RpZnlTdWJzY3JpYmVycyJdID0gZnVuY3Rpb24odmFsdWUsIGV2ZW50KSB7CgkgICAgICAgICAgICAgICAgaWYgKCFldmVudCB8fCBldmVudCA9PT0gZGVmYXVsdEV2ZW50KSB7CgkgICAgICAgICAgICAgICAgICAgIHNlbGYuX3JhdGVMaW1pdGVkQ2hhbmdlKHZhbHVlKTsKCSAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGV2ZW50ID09PSBiZWZvcmVDaGFuZ2UpIHsKCSAgICAgICAgICAgICAgICAgICAgc2VsZi5fcmF0ZUxpbWl0ZWRCZWZvcmVDaGFuZ2UodmFsdWUpOwoJICAgICAgICAgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICAgICAgICAgIHNlbGYuX29yaWdOb3RpZnlTdWJzY3JpYmVycyh2YWx1ZSwgZXZlbnQpOwoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgIH07CgkgICAgICAgIH0KCgkgICAgICAgIHZhciBmaW5pc2ggPSBsaW1pdEZ1bmN0aW9uKGZ1bmN0aW9uKCkgewoJICAgICAgICAgICAgLy8gSWYgYW4gb2JzZXJ2YWJsZSBwcm92aWRlZCBhIHJlZmVyZW5jZSB0byBpdHNlbGYsIGFjY2VzcyBpdCB0byBnZXQgdGhlIGxhdGVzdCB2YWx1ZS4KCSAgICAgICAgICAgIC8vIFRoaXMgYWxsb3dzIGNvbXB1dGVkIG9ic2VydmFibGVzIHRvIGRlbGF5IGNhbGN1bGF0aW5nIHRoZWlyIHZhbHVlIHVudGlsIG5lZWRlZC4KCSAgICAgICAgICAgIGlmIChzZWxmSXNPYnNlcnZhYmxlICYmIHBlbmRpbmdWYWx1ZSA9PT0gc2VsZikgewoJICAgICAgICAgICAgICAgIHBlbmRpbmdWYWx1ZSA9IHNlbGYoKTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIGlzUGVuZGluZyA9IGZhbHNlOwoJICAgICAgICAgICAgaWYgKHNlbGYuaXNEaWZmZXJlbnQocHJldmlvdXNWYWx1ZSwgcGVuZGluZ1ZhbHVlKSkgewoJICAgICAgICAgICAgICAgIHNlbGYuX29yaWdOb3RpZnlTdWJzY3JpYmVycyhwcmV2aW91c1ZhbHVlID0gcGVuZGluZ1ZhbHVlKTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgfSk7CgoJICAgICAgICBzZWxmLl9yYXRlTGltaXRlZENoYW5nZSA9IGZ1bmN0aW9uKHZhbHVlKSB7CgkgICAgICAgICAgICBpc1BlbmRpbmcgPSB0cnVlOwoJICAgICAgICAgICAgcGVuZGluZ1ZhbHVlID0gdmFsdWU7CgkgICAgICAgICAgICBmaW5pc2goKTsKCSAgICAgICAgfTsKCSAgICAgICAgc2VsZi5fcmF0ZUxpbWl0ZWRCZWZvcmVDaGFuZ2UgPSBmdW5jdGlvbih2YWx1ZSkgewoJICAgICAgICAgICAgaWYgKCFpc1BlbmRpbmcpIHsKCSAgICAgICAgICAgICAgICBwcmV2aW91c1ZhbHVlID0gdmFsdWU7CgkgICAgICAgICAgICAgICAgc2VsZi5fb3JpZ05vdGlmeVN1YnNjcmliZXJzKHZhbHVlLCBiZWZvcmVDaGFuZ2UpOwoJICAgICAgICAgICAgfQoJICAgICAgICB9OwoJICAgIH0sCgoJICAgIGhhc1N1YnNjcmlwdGlvbnNGb3JFdmVudDogZnVuY3Rpb24oZXZlbnQpIHsKCSAgICAgICAgcmV0dXJuIHRoaXMuX3N1YnNjcmlwdGlvbnNbZXZlbnRdICYmIHRoaXMuX3N1YnNjcmlwdGlvbnNbZXZlbnRdLmxlbmd0aDsKCSAgICB9LAoKCSAgICBnZXRTdWJzY3JpcHRpb25zQ291bnQ6IGZ1bmN0aW9uICgpIHsKCSAgICAgICAgdmFyIHRvdGFsID0gMDsKCSAgICAgICAga28udXRpbHMub2JqZWN0Rm9yRWFjaCh0aGlzLl9zdWJzY3JpcHRpb25zLCBmdW5jdGlvbihldmVudE5hbWUsIHN1YnNjcmlwdGlvbnMpIHsKCSAgICAgICAgICAgIHRvdGFsICs9IHN1YnNjcmlwdGlvbnMubGVuZ3RoOwoJICAgICAgICB9KTsKCSAgICAgICAgcmV0dXJuIHRvdGFsOwoJICAgIH0sCgoJICAgIGlzRGlmZmVyZW50OiBmdW5jdGlvbihvbGRWYWx1ZSwgbmV3VmFsdWUpIHsKCSAgICAgICAgcmV0dXJuICF0aGlzWydlcXVhbGl0eUNvbXBhcmVyJ10gfHwgIXRoaXNbJ2VxdWFsaXR5Q29tcGFyZXInXShvbGRWYWx1ZSwgbmV3VmFsdWUpOwoJICAgIH0sCgoJICAgIGV4dGVuZDogYXBwbHlFeHRlbmRlcnMKCX07CgoJa28uZXhwb3J0UHJvcGVydHkoa29fc3Vic2NyaWJhYmxlX2ZuLCAnc3Vic2NyaWJlJywga29fc3Vic2NyaWJhYmxlX2ZuLnN1YnNjcmliZSk7Cglrby5leHBvcnRQcm9wZXJ0eShrb19zdWJzY3JpYmFibGVfZm4sICdleHRlbmQnLCBrb19zdWJzY3JpYmFibGVfZm4uZXh0ZW5kKTsKCWtvLmV4cG9ydFByb3BlcnR5KGtvX3N1YnNjcmliYWJsZV9mbiwgJ2dldFN1YnNjcmlwdGlvbnNDb3VudCcsIGtvX3N1YnNjcmliYWJsZV9mbi5nZXRTdWJzY3JpcHRpb25zQ291bnQpOwoKCS8vIEZvciBicm93c2VycyB0aGF0IHN1cHBvcnQgcHJvdG8gYXNzaWdubWVudCwgd2Ugb3ZlcndyaXRlIHRoZSBwcm90b3R5cGUgb2YgZWFjaAoJLy8gb2JzZXJ2YWJsZSBpbnN0YW5jZS4gU2luY2Ugb2JzZXJ2YWJsZXMgYXJlIGZ1bmN0aW9ucywgd2UgbmVlZCBGdW5jdGlvbi5wcm90b3R5cGUKCS8vIHRvIHN0aWxsIGJlIGluIHRoZSBwcm90b3R5cGUgY2hhaW4uCglpZiAoa28udXRpbHMuY2FuU2V0UHJvdG90eXBlKSB7CgkgICAga28udXRpbHMuc2V0UHJvdG90eXBlT2Yoa29fc3Vic2NyaWJhYmxlX2ZuLCBGdW5jdGlvbi5wcm90b3R5cGUpOwoJfQoKCWtvLnN1YnNjcmliYWJsZVsnZm4nXSA9IGtvX3N1YnNjcmliYWJsZV9mbjsKCgoJa28uaXNTdWJzY3JpYmFibGUgPSBmdW5jdGlvbiAoaW5zdGFuY2UpIHsKCSAgICByZXR1cm4gaW5zdGFuY2UgIT0gbnVsbCAmJiB0eXBlb2YgaW5zdGFuY2Uuc3Vic2NyaWJlID09ICJmdW5jdGlvbiIgJiYgdHlwZW9mIGluc3RhbmNlWyJub3RpZnlTdWJzY3JpYmVycyJdID09ICJmdW5jdGlvbiI7Cgl9OwoKCWtvLmV4cG9ydFN5bWJvbCgnc3Vic2NyaWJhYmxlJywga28uc3Vic2NyaWJhYmxlKTsKCWtvLmV4cG9ydFN5bWJvbCgnaXNTdWJzY3JpYmFibGUnLCBrby5pc1N1YnNjcmliYWJsZSk7CgoJa28uY29tcHV0ZWRDb250ZXh0ID0ga28uZGVwZW5kZW5jeURldGVjdGlvbiA9IChmdW5jdGlvbiAoKSB7CgkgICAgdmFyIG91dGVyRnJhbWVzID0gW10sCgkgICAgICAgIGN1cnJlbnRGcmFtZSwKCSAgICAgICAgbGFzdElkID0gMDsKCgkgICAgLy8gUmV0dXJuIGEgdW5pcXVlIElEIHRoYXQgY2FuIGJlIGFzc2lnbmVkIHRvIGFuIG9ic2VydmFibGUgZm9yIGRlcGVuZGVuY3kgdHJhY2tpbmcuCgkgICAgLy8gVGhlb3JldGljYWxseSwgeW91IGNvdWxkIGV2ZW50dWFsbHkgb3ZlcmZsb3cgdGhlIG51bWJlciBzdG9yYWdlIHNpemUsIHJlc3VsdGluZwoJICAgIC8vIGluIGR1cGxpY2F0ZSBJRHMuIEJ1dCBpbiBKYXZhU2NyaXB0LCB0aGUgbGFyZ2VzdCBleGFjdCBpbnRlZ3JhbCB2YWx1ZSBpcyAyXjUzCgkgICAgLy8gb3IgOSwwMDcsMTk5LDI1NCw3NDAsOTkyLiBJZiB5b3UgY3JlYXRlZCAxLDAwMCwwMDAgSURzIHBlciBzZWNvbmQsIGl0IHdvdWxkCgkgICAgLy8gdGFrZSBvdmVyIDI4NSB5ZWFycyB0byByZWFjaCB0aGF0IG51bWJlci4KCSAgICAvLyBSZWZlcmVuY2UgaHR0cDovL2Jsb2cudmpldXguY29tLzIwMTAvamF2YXNjcmlwdC9qYXZhc2NyaXB0LW1heF9pbnQtbnVtYmVyLWxpbWl0cy5odG1sCgkgICAgZnVuY3Rpb24gZ2V0SWQoKSB7CgkgICAgICAgIHJldHVybiArK2xhc3RJZDsKCSAgICB9CgoJICAgIGZ1bmN0aW9uIGJlZ2luKG9wdGlvbnMpIHsKCSAgICAgICAgb3V0ZXJGcmFtZXMucHVzaChjdXJyZW50RnJhbWUpOwoJICAgICAgICBjdXJyZW50RnJhbWUgPSBvcHRpb25zOwoJICAgIH0KCgkgICAgZnVuY3Rpb24gZW5kKCkgewoJICAgICAgICBjdXJyZW50RnJhbWUgPSBvdXRlckZyYW1lcy5wb3AoKTsKCSAgICB9CgoJICAgIHJldHVybiB7CgkgICAgICAgIGJlZ2luOiBiZWdpbiwKCgkgICAgICAgIGVuZDogZW5kLAoKCSAgICAgICAgcmVnaXN0ZXJEZXBlbmRlbmN5OiBmdW5jdGlvbiAoc3Vic2NyaWJhYmxlKSB7CgkgICAgICAgICAgICBpZiAoY3VycmVudEZyYW1lKSB7CgkgICAgICAgICAgICAgICAgaWYgKCFrby5pc1N1YnNjcmliYWJsZShzdWJzY3JpYmFibGUpKQoJICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIk9ubHkgc3Vic2NyaWJhYmxlIHRoaW5ncyBjYW4gYWN0IGFzIGRlcGVuZGVuY2llcyIpOwoJICAgICAgICAgICAgICAgIGN1cnJlbnRGcmFtZS5jYWxsYmFjayhzdWJzY3JpYmFibGUsIHN1YnNjcmliYWJsZS5faWQgfHwgKHN1YnNjcmliYWJsZS5faWQgPSBnZXRJZCgpKSk7CgkgICAgICAgICAgICB9CgkgICAgICAgIH0sCgoJICAgICAgICBpZ25vcmU6IGZ1bmN0aW9uIChjYWxsYmFjaywgY2FsbGJhY2tUYXJnZXQsIGNhbGxiYWNrQXJncykgewoJICAgICAgICAgICAgdHJ5IHsKCSAgICAgICAgICAgICAgICBiZWdpbigpOwoJICAgICAgICAgICAgICAgIHJldHVybiBjYWxsYmFjay5hcHBseShjYWxsYmFja1RhcmdldCwgY2FsbGJhY2tBcmdzIHx8IFtdKTsKCSAgICAgICAgICAgIH0gZmluYWxseSB7CgkgICAgICAgICAgICAgICAgZW5kKCk7CgkgICAgICAgICAgICB9CgkgICAgICAgIH0sCgoJICAgICAgICBnZXREZXBlbmRlbmNpZXNDb3VudDogZnVuY3Rpb24gKCkgewoJICAgICAgICAgICAgaWYgKGN1cnJlbnRGcmFtZSkKCSAgICAgICAgICAgICAgICByZXR1cm4gY3VycmVudEZyYW1lLmNvbXB1dGVkLmdldERlcGVuZGVuY2llc0NvdW50KCk7CgkgICAgICAgIH0sCgoJICAgICAgICBpc0luaXRpYWw6IGZ1bmN0aW9uKCkgewoJICAgICAgICAgICAgaWYgKGN1cnJlbnRGcmFtZSkKCSAgICAgICAgICAgICAgICByZXR1cm4gY3VycmVudEZyYW1lLmlzSW5pdGlhbDsKCSAgICAgICAgfQoJICAgIH07Cgl9KSgpOwoKCWtvLmV4cG9ydFN5bWJvbCgnY29tcHV0ZWRDb250ZXh0Jywga28uY29tcHV0ZWRDb250ZXh0KTsKCWtvLmV4cG9ydFN5bWJvbCgnY29tcHV0ZWRDb250ZXh0LmdldERlcGVuZGVuY2llc0NvdW50Jywga28uY29tcHV0ZWRDb250ZXh0LmdldERlcGVuZGVuY2llc0NvdW50KTsKCWtvLmV4cG9ydFN5bWJvbCgnY29tcHV0ZWRDb250ZXh0LmlzSW5pdGlhbCcsIGtvLmNvbXB1dGVkQ29udGV4dC5pc0luaXRpYWwpOwoJa28uZXhwb3J0U3ltYm9sKCdjb21wdXRlZENvbnRleHQuaXNTbGVlcGluZycsIGtvLmNvbXB1dGVkQ29udGV4dC5pc1NsZWVwaW5nKTsKCWtvLm9ic2VydmFibGUgPSBmdW5jdGlvbiAoaW5pdGlhbFZhbHVlKSB7CgkgICAgdmFyIF9sYXRlc3RWYWx1ZSA9IGluaXRpYWxWYWx1ZTsKCgkgICAgZnVuY3Rpb24gb2JzZXJ2YWJsZSgpIHsKCSAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPiAwKSB7CgkgICAgICAgICAgICAvLyBXcml0ZQoKCSAgICAgICAgICAgIC8vIElnbm9yZSB3cml0ZXMgaWYgdGhlIHZhbHVlIGhhc24ndCBjaGFuZ2VkCgkgICAgICAgICAgICBpZiAob2JzZXJ2YWJsZS5pc0RpZmZlcmVudChfbGF0ZXN0VmFsdWUsIGFyZ3VtZW50c1swXSkpIHsKCSAgICAgICAgICAgICAgICBvYnNlcnZhYmxlLnZhbHVlV2lsbE11dGF0ZSgpOwoJICAgICAgICAgICAgICAgIF9sYXRlc3RWYWx1ZSA9IGFyZ3VtZW50c1swXTsKCSAgICAgICAgICAgICAgICBpZiAoREVCVUcpIG9ic2VydmFibGUuX2xhdGVzdFZhbHVlID0gX2xhdGVzdFZhbHVlOwoJICAgICAgICAgICAgICAgIG9ic2VydmFibGUudmFsdWVIYXNNdXRhdGVkKCk7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICByZXR1cm4gdGhpczsgLy8gUGVybWl0cyBjaGFpbmVkIGFzc2lnbm1lbnRzCgkgICAgICAgIH0KCSAgICAgICAgZWxzZSB7CgkgICAgICAgICAgICAvLyBSZWFkCgkgICAgICAgICAgICBrby5kZXBlbmRlbmN5RGV0ZWN0aW9uLnJlZ2lzdGVyRGVwZW5kZW5jeShvYnNlcnZhYmxlKTsgLy8gVGhlIGNhbGxlciBvbmx5IG5lZWRzIHRvIGJlIG5vdGlmaWVkIG9mIGNoYW5nZXMgaWYgdGhleSBkaWQgYSAicmVhZCIgb3BlcmF0aW9uCgkgICAgICAgICAgICByZXR1cm4gX2xhdGVzdFZhbHVlOwoJICAgICAgICB9CgkgICAgfQoJICAgIGtvLnN1YnNjcmliYWJsZS5jYWxsKG9ic2VydmFibGUpOwoJICAgIGtvLnV0aWxzLnNldFByb3RvdHlwZU9mT3JFeHRlbmQob2JzZXJ2YWJsZSwga28ub2JzZXJ2YWJsZVsnZm4nXSk7CgoJICAgIGlmIChERUJVRykgb2JzZXJ2YWJsZS5fbGF0ZXN0VmFsdWUgPSBfbGF0ZXN0VmFsdWU7CgkgICAgb2JzZXJ2YWJsZS5wZWVrID0gZnVuY3Rpb24oKSB7IHJldHVybiBfbGF0ZXN0VmFsdWUgfTsKCSAgICBvYnNlcnZhYmxlLnZhbHVlSGFzTXV0YXRlZCA9IGZ1bmN0aW9uICgpIHsgb2JzZXJ2YWJsZVsibm90aWZ5U3Vic2NyaWJlcnMiXShfbGF0ZXN0VmFsdWUpOyB9CgkgICAgb2JzZXJ2YWJsZS52YWx1ZVdpbGxNdXRhdGUgPSBmdW5jdGlvbiAoKSB7IG9ic2VydmFibGVbIm5vdGlmeVN1YnNjcmliZXJzIl0oX2xhdGVzdFZhbHVlLCAiYmVmb3JlQ2hhbmdlIik7IH0KCgkgICAga28uZXhwb3J0UHJvcGVydHkob2JzZXJ2YWJsZSwgJ3BlZWsnLCBvYnNlcnZhYmxlLnBlZWspOwoJICAgIGtvLmV4cG9ydFByb3BlcnR5KG9ic2VydmFibGUsICJ2YWx1ZUhhc011dGF0ZWQiLCBvYnNlcnZhYmxlLnZhbHVlSGFzTXV0YXRlZCk7CgkgICAga28uZXhwb3J0UHJvcGVydHkob2JzZXJ2YWJsZSwgInZhbHVlV2lsbE11dGF0ZSIsIG9ic2VydmFibGUudmFsdWVXaWxsTXV0YXRlKTsKCgkgICAgcmV0dXJuIG9ic2VydmFibGU7Cgl9CgoJa28ub2JzZXJ2YWJsZVsnZm4nXSA9IHsKCSAgICAiZXF1YWxpdHlDb21wYXJlciI6IHZhbHVlc0FyZVByaW1pdGl2ZUFuZEVxdWFsCgl9OwoKCXZhciBwcm90b1Byb3BlcnR5ID0ga28ub2JzZXJ2YWJsZS5wcm90b1Byb3BlcnR5ID0gIl9fa29fcHJvdG9fXyI7Cglrby5vYnNlcnZhYmxlWydmbiddW3Byb3RvUHJvcGVydHldID0ga28ub2JzZXJ2YWJsZTsKCgkvLyBOb3RlIHRoYXQgZm9yIGJyb3dzZXJzIHRoYXQgZG9uJ3Qgc3VwcG9ydCBwcm90byBhc3NpZ25tZW50LCB0aGUKCS8vIGluaGVyaXRhbmNlIGNoYWluIGlzIGNyZWF0ZWQgbWFudWFsbHkgaW4gdGhlIGtvLm9ic2VydmFibGUgY29uc3RydWN0b3IKCWlmIChrby51dGlscy5jYW5TZXRQcm90b3R5cGUpIHsKCSAgICBrby51dGlscy5zZXRQcm90b3R5cGVPZihrby5vYnNlcnZhYmxlWydmbiddLCBrby5zdWJzY3JpYmFibGVbJ2ZuJ10pOwoJfQoKCWtvLmhhc1Byb3RvdHlwZSA9IGZ1bmN0aW9uKGluc3RhbmNlLCBwcm90b3R5cGUpIHsKCSAgICBpZiAoKGluc3RhbmNlID09PSBudWxsKSB8fCAoaW5zdGFuY2UgPT09IHVuZGVmaW5lZCkgfHwgKGluc3RhbmNlW3Byb3RvUHJvcGVydHldID09PSB1bmRlZmluZWQpKSByZXR1cm4gZmFsc2U7CgkgICAgaWYgKGluc3RhbmNlW3Byb3RvUHJvcGVydHldID09PSBwcm90b3R5cGUpIHJldHVybiB0cnVlOwoJICAgIHJldHVybiBrby5oYXNQcm90b3R5cGUoaW5zdGFuY2VbcHJvdG9Qcm9wZXJ0eV0sIHByb3RvdHlwZSk7IC8vIFdhbGsgdGhlIHByb3RvdHlwZSBjaGFpbgoJfTsKCglrby5pc09ic2VydmFibGUgPSBmdW5jdGlvbiAoaW5zdGFuY2UpIHsKCSAgICByZXR1cm4ga28uaGFzUHJvdG90eXBlKGluc3RhbmNlLCBrby5vYnNlcnZhYmxlKTsKCX0KCWtvLmlzV3JpdGVhYmxlT2JzZXJ2YWJsZSA9IGZ1bmN0aW9uIChpbnN0YW5jZSkgewoJICAgIC8vIE9ic2VydmFibGUKCSAgICBpZiAoKHR5cGVvZiBpbnN0YW5jZSA9PSAiZnVuY3Rpb24iKSAmJiBpbnN0YW5jZVtwcm90b1Byb3BlcnR5XSA9PT0ga28ub2JzZXJ2YWJsZSkKCSAgICAgICAgcmV0dXJuIHRydWU7CgkgICAgLy8gV3JpdGVhYmxlIGRlcGVuZGVudCBvYnNlcnZhYmxlCgkgICAgaWYgKCh0eXBlb2YgaW5zdGFuY2UgPT0gImZ1bmN0aW9uIikgJiYgKGluc3RhbmNlW3Byb3RvUHJvcGVydHldID09PSBrby5kZXBlbmRlbnRPYnNlcnZhYmxlKSAmJiAoaW5zdGFuY2UuaGFzV3JpdGVGdW5jdGlvbikpCgkgICAgICAgIHJldHVybiB0cnVlOwoJICAgIC8vIEFueXRoaW5nIGVsc2UKCSAgICByZXR1cm4gZmFsc2U7Cgl9CgoKCWtvLmV4cG9ydFN5bWJvbCgnb2JzZXJ2YWJsZScsIGtvLm9ic2VydmFibGUpOwoJa28uZXhwb3J0U3ltYm9sKCdpc09ic2VydmFibGUnLCBrby5pc09ic2VydmFibGUpOwoJa28uZXhwb3J0U3ltYm9sKCdpc1dyaXRlYWJsZU9ic2VydmFibGUnLCBrby5pc1dyaXRlYWJsZU9ic2VydmFibGUpOwoJa28uZXhwb3J0U3ltYm9sKCdpc1dyaXRhYmxlT2JzZXJ2YWJsZScsIGtvLmlzV3JpdGVhYmxlT2JzZXJ2YWJsZSk7Cglrby5vYnNlcnZhYmxlQXJyYXkgPSBmdW5jdGlvbiAoaW5pdGlhbFZhbHVlcykgewoJICAgIGluaXRpYWxWYWx1ZXMgPSBpbml0aWFsVmFsdWVzIHx8IFtdOwoKCSAgICBpZiAodHlwZW9mIGluaXRpYWxWYWx1ZXMgIT0gJ29iamVjdCcgfHwgISgnbGVuZ3RoJyBpbiBpbml0aWFsVmFsdWVzKSkKCSAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUaGUgYXJndW1lbnQgcGFzc2VkIHdoZW4gaW5pdGlhbGl6aW5nIGFuIG9ic2VydmFibGUgYXJyYXkgbXVzdCBiZSBhbiBhcnJheSwgb3IgbnVsbCwgb3IgdW5kZWZpbmVkLiIpOwoKCSAgICB2YXIgcmVzdWx0ID0ga28ub2JzZXJ2YWJsZShpbml0aWFsVmFsdWVzKTsKCSAgICBrby51dGlscy5zZXRQcm90b3R5cGVPZk9yRXh0ZW5kKHJlc3VsdCwga28ub2JzZXJ2YWJsZUFycmF5WydmbiddKTsKCSAgICByZXR1cm4gcmVzdWx0LmV4dGVuZCh7J3RyYWNrQXJyYXlDaGFuZ2VzJzp0cnVlfSk7Cgl9OwoKCWtvLm9ic2VydmFibGVBcnJheVsnZm4nXSA9IHsKCSAgICAncmVtb3ZlJzogZnVuY3Rpb24gKHZhbHVlT3JQcmVkaWNhdGUpIHsKCSAgICAgICAgdmFyIHVuZGVybHlpbmdBcnJheSA9IHRoaXMucGVlaygpOwoJICAgICAgICB2YXIgcmVtb3ZlZFZhbHVlcyA9IFtdOwoJICAgICAgICB2YXIgcHJlZGljYXRlID0gdHlwZW9mIHZhbHVlT3JQcmVkaWNhdGUgPT0gImZ1bmN0aW9uIiAmJiAha28uaXNPYnNlcnZhYmxlKHZhbHVlT3JQcmVkaWNhdGUpID8gdmFsdWVPclByZWRpY2F0ZSA6IGZ1bmN0aW9uICh2YWx1ZSkgeyByZXR1cm4gdmFsdWUgPT09IHZhbHVlT3JQcmVkaWNhdGU7IH07CgkgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdW5kZXJseWluZ0FycmF5Lmxlbmd0aDsgaSsrKSB7CgkgICAgICAgICAgICB2YXIgdmFsdWUgPSB1bmRlcmx5aW5nQXJyYXlbaV07CgkgICAgICAgICAgICBpZiAocHJlZGljYXRlKHZhbHVlKSkgewoJICAgICAgICAgICAgICAgIGlmIChyZW1vdmVkVmFsdWVzLmxlbmd0aCA9PT0gMCkgewoJICAgICAgICAgICAgICAgICAgICB0aGlzLnZhbHVlV2lsbE11dGF0ZSgpOwoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICByZW1vdmVkVmFsdWVzLnB1c2godmFsdWUpOwoJICAgICAgICAgICAgICAgIHVuZGVybHlpbmdBcnJheS5zcGxpY2UoaSwgMSk7CgkgICAgICAgICAgICAgICAgaS0tOwoJICAgICAgICAgICAgfQoJICAgICAgICB9CgkgICAgICAgIGlmIChyZW1vdmVkVmFsdWVzLmxlbmd0aCkgewoJICAgICAgICAgICAgdGhpcy52YWx1ZUhhc011dGF0ZWQoKTsKCSAgICAgICAgfQoJICAgICAgICByZXR1cm4gcmVtb3ZlZFZhbHVlczsKCSAgICB9LAoKCSAgICAncmVtb3ZlQWxsJzogZnVuY3Rpb24gKGFycmF5T2ZWYWx1ZXMpIHsKCSAgICAgICAgLy8gSWYgeW91IHBhc3NlZCB6ZXJvIGFyZ3MsIHdlIHJlbW92ZSBldmVyeXRoaW5nCgkgICAgICAgIGlmIChhcnJheU9mVmFsdWVzID09PSB1bmRlZmluZWQpIHsKCSAgICAgICAgICAgIHZhciB1bmRlcmx5aW5nQXJyYXkgPSB0aGlzLnBlZWsoKTsKCSAgICAgICAgICAgIHZhciBhbGxWYWx1ZXMgPSB1bmRlcmx5aW5nQXJyYXkuc2xpY2UoMCk7CgkgICAgICAgICAgICB0aGlzLnZhbHVlV2lsbE11dGF0ZSgpOwoJICAgICAgICAgICAgdW5kZXJseWluZ0FycmF5LnNwbGljZSgwLCB1bmRlcmx5aW5nQXJyYXkubGVuZ3RoKTsKCSAgICAgICAgICAgIHRoaXMudmFsdWVIYXNNdXRhdGVkKCk7CgkgICAgICAgICAgICByZXR1cm4gYWxsVmFsdWVzOwoJICAgICAgICB9CgkgICAgICAgIC8vIElmIHlvdSBwYXNzZWQgYW4gYXJnLCB3ZSBpbnRlcnByZXQgaXQgYXMgYW4gYXJyYXkgb2YgZW50cmllcyB0byByZW1vdmUKCSAgICAgICAgaWYgKCFhcnJheU9mVmFsdWVzKQoJICAgICAgICAgICAgcmV0dXJuIFtdOwoJICAgICAgICByZXR1cm4gdGhpc1sncmVtb3ZlJ10oZnVuY3Rpb24gKHZhbHVlKSB7CgkgICAgICAgICAgICByZXR1cm4ga28udXRpbHMuYXJyYXlJbmRleE9mKGFycmF5T2ZWYWx1ZXMsIHZhbHVlKSA+PSAwOwoJICAgICAgICB9KTsKCSAgICB9LAoKCSAgICAnZGVzdHJveSc6IGZ1bmN0aW9uICh2YWx1ZU9yUHJlZGljYXRlKSB7CgkgICAgICAgIHZhciB1bmRlcmx5aW5nQXJyYXkgPSB0aGlzLnBlZWsoKTsKCSAgICAgICAgdmFyIHByZWRpY2F0ZSA9IHR5cGVvZiB2YWx1ZU9yUHJlZGljYXRlID09ICJmdW5jdGlvbiIgJiYgIWtvLmlzT2JzZXJ2YWJsZSh2YWx1ZU9yUHJlZGljYXRlKSA/IHZhbHVlT3JQcmVkaWNhdGUgOiBmdW5jdGlvbiAodmFsdWUpIHsgcmV0dXJuIHZhbHVlID09PSB2YWx1ZU9yUHJlZGljYXRlOyB9OwoJICAgICAgICB0aGlzLnZhbHVlV2lsbE11dGF0ZSgpOwoJICAgICAgICBmb3IgKHZhciBpID0gdW5kZXJseWluZ0FycmF5Lmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CgkgICAgICAgICAgICB2YXIgdmFsdWUgPSB1bmRlcmx5aW5nQXJyYXlbaV07CgkgICAgICAgICAgICBpZiAocHJlZGljYXRlKHZhbHVlKSkKCSAgICAgICAgICAgICAgICB1bmRlcmx5aW5nQXJyYXlbaV1bIl9kZXN0cm95Il0gPSB0cnVlOwoJICAgICAgICB9CgkgICAgICAgIHRoaXMudmFsdWVIYXNNdXRhdGVkKCk7CgkgICAgfSwKCgkgICAgJ2Rlc3Ryb3lBbGwnOiBmdW5jdGlvbiAoYXJyYXlPZlZhbHVlcykgewoJICAgICAgICAvLyBJZiB5b3UgcGFzc2VkIHplcm8gYXJncywgd2UgZGVzdHJveSBldmVyeXRoaW5nCgkgICAgICAgIGlmIChhcnJheU9mVmFsdWVzID09PSB1bmRlZmluZWQpCgkgICAgICAgICAgICByZXR1cm4gdGhpc1snZGVzdHJveSddKGZ1bmN0aW9uKCkgeyByZXR1cm4gdHJ1ZSB9KTsKCgkgICAgICAgIC8vIElmIHlvdSBwYXNzZWQgYW4gYXJnLCB3ZSBpbnRlcnByZXQgaXQgYXMgYW4gYXJyYXkgb2YgZW50cmllcyB0byBkZXN0cm95CgkgICAgICAgIGlmICghYXJyYXlPZlZhbHVlcykKCSAgICAgICAgICAgIHJldHVybiBbXTsKCSAgICAgICAgcmV0dXJuIHRoaXNbJ2Rlc3Ryb3knXShmdW5jdGlvbiAodmFsdWUpIHsKCSAgICAgICAgICAgIHJldHVybiBrby51dGlscy5hcnJheUluZGV4T2YoYXJyYXlPZlZhbHVlcywgdmFsdWUpID49IDA7CgkgICAgICAgIH0pOwoJICAgIH0sCgoJICAgICdpbmRleE9mJzogZnVuY3Rpb24gKGl0ZW0pIHsKCSAgICAgICAgdmFyIHVuZGVybHlpbmdBcnJheSA9IHRoaXMoKTsKCSAgICAgICAgcmV0dXJuIGtvLnV0aWxzLmFycmF5SW5kZXhPZih1bmRlcmx5aW5nQXJyYXksIGl0ZW0pOwoJICAgIH0sCgoJICAgICdyZXBsYWNlJzogZnVuY3Rpb24ob2xkSXRlbSwgbmV3SXRlbSkgewoJICAgICAgICB2YXIgaW5kZXggPSB0aGlzWydpbmRleE9mJ10ob2xkSXRlbSk7CgkgICAgICAgIGlmIChpbmRleCA+PSAwKSB7CgkgICAgICAgICAgICB0aGlzLnZhbHVlV2lsbE11dGF0ZSgpOwoJICAgICAgICAgICAgdGhpcy5wZWVrKClbaW5kZXhdID0gbmV3SXRlbTsKCSAgICAgICAgICAgIHRoaXMudmFsdWVIYXNNdXRhdGVkKCk7CgkgICAgICAgIH0KCSAgICB9Cgl9OwoKCS8vIFBvcHVsYXRlIGtvLm9ic2VydmFibGVBcnJheS5mbiB3aXRoIHJlYWQvd3JpdGUgZnVuY3Rpb25zIGZyb20gbmF0aXZlIGFycmF5cwoJLy8gSW1wb3J0YW50OiBEbyBub3QgYWRkIGFueSBhZGRpdGlvbmFsIGZ1bmN0aW9ucyBoZXJlIHRoYXQgbWF5IHJlYXNvbmFibHkgYmUgdXNlZCB0byAqcmVhZCogZGF0YSBmcm9tIHRoZSBhcnJheQoJLy8gYmVjYXVzZSB3ZSdsbCBldmFsIHRoZW0gd2l0aG91dCBjYXVzaW5nIHN1YnNjcmlwdGlvbnMsIHNvIGtvLmNvbXB1dGVkIG91dHB1dCBjb3VsZCBlbmQgdXAgZ2V0dGluZyBzdGFsZQoJa28udXRpbHMuYXJyYXlGb3JFYWNoKFsicG9wIiwgInB1c2giLCAicmV2ZXJzZSIsICJzaGlmdCIsICJzb3J0IiwgInNwbGljZSIsICJ1bnNoaWZ0Il0sIGZ1bmN0aW9uIChtZXRob2ROYW1lKSB7CgkgICAga28ub2JzZXJ2YWJsZUFycmF5WydmbiddW21ldGhvZE5hbWVdID0gZnVuY3Rpb24gKCkgewoJICAgICAgICAvLyBVc2UgInBlZWsiIHRvIGF2b2lkIGNyZWF0aW5nIGEgc3Vic2NyaXB0aW9uIGluIGFueSBjb21wdXRlZCB0aGF0IHdlJ3JlIGV4ZWN1dGluZyBpbiB0aGUgY29udGV4dCBvZgoJICAgICAgICAvLyAoZm9yIGNvbnNpc3RlbmN5IHdpdGggbXV0YXRpbmcgcmVndWxhciBvYnNlcnZhYmxlcykKCSAgICAgICAgdmFyIHVuZGVybHlpbmdBcnJheSA9IHRoaXMucGVlaygpOwoJICAgICAgICB0aGlzLnZhbHVlV2lsbE11dGF0ZSgpOwoJICAgICAgICB0aGlzLmNhY2hlRGlmZkZvcktub3duT3BlcmF0aW9uKHVuZGVybHlpbmdBcnJheSwgbWV0aG9kTmFtZSwgYXJndW1lbnRzKTsKCSAgICAgICAgdmFyIG1ldGhvZENhbGxSZXN1bHQgPSB1bmRlcmx5aW5nQXJyYXlbbWV0aG9kTmFtZV0uYXBwbHkodW5kZXJseWluZ0FycmF5LCBhcmd1bWVudHMpOwoJICAgICAgICB0aGlzLnZhbHVlSGFzTXV0YXRlZCgpOwoJICAgICAgICByZXR1cm4gbWV0aG9kQ2FsbFJlc3VsdDsKCSAgICB9OwoJfSk7CgoJLy8gUG9wdWxhdGUga28ub2JzZXJ2YWJsZUFycmF5LmZuIHdpdGggcmVhZC1vbmx5IGZ1bmN0aW9ucyBmcm9tIG5hdGl2ZSBhcnJheXMKCWtvLnV0aWxzLmFycmF5Rm9yRWFjaChbInNsaWNlIl0sIGZ1bmN0aW9uIChtZXRob2ROYW1lKSB7CgkgICAga28ub2JzZXJ2YWJsZUFycmF5WydmbiddW21ldGhvZE5hbWVdID0gZnVuY3Rpb24gKCkgewoJICAgICAgICB2YXIgdW5kZXJseWluZ0FycmF5ID0gdGhpcygpOwoJICAgICAgICByZXR1cm4gdW5kZXJseWluZ0FycmF5W21ldGhvZE5hbWVdLmFwcGx5KHVuZGVybHlpbmdBcnJheSwgYXJndW1lbnRzKTsKCSAgICB9OwoJfSk7CgoJLy8gTm90ZSB0aGF0IGZvciBicm93c2VycyB0aGF0IGRvbid0IHN1cHBvcnQgcHJvdG8gYXNzaWdubWVudCwgdGhlCgkvLyBpbmhlcml0YW5jZSBjaGFpbiBpcyBjcmVhdGVkIG1hbnVhbGx5IGluIHRoZSBrby5vYnNlcnZhYmxlQXJyYXkgY29uc3RydWN0b3IKCWlmIChrby51dGlscy5jYW5TZXRQcm90b3R5cGUpIHsKCSAgICBrby51dGlscy5zZXRQcm90b3R5cGVPZihrby5vYnNlcnZhYmxlQXJyYXlbJ2ZuJ10sIGtvLm9ic2VydmFibGVbJ2ZuJ10pOwoJfQoKCWtvLmV4cG9ydFN5bWJvbCgnb2JzZXJ2YWJsZUFycmF5Jywga28ub2JzZXJ2YWJsZUFycmF5KTsKCXZhciBhcnJheUNoYW5nZUV2ZW50TmFtZSA9ICdhcnJheUNoYW5nZSc7Cglrby5leHRlbmRlcnNbJ3RyYWNrQXJyYXlDaGFuZ2VzJ10gPSBmdW5jdGlvbih0YXJnZXQpIHsKCSAgICAvLyBPbmx5IG1vZGlmeSB0aGUgdGFyZ2V0IG9ic2VydmFibGUgb25jZQoJICAgIGlmICh0YXJnZXQuY2FjaGVEaWZmRm9yS25vd25PcGVyYXRpb24pIHsKCSAgICAgICAgcmV0dXJuOwoJICAgIH0KCSAgICB2YXIgdHJhY2tpbmdDaGFuZ2VzID0gZmFsc2UsCgkgICAgICAgIGNhY2hlZERpZmYgPSBudWxsLAoJICAgICAgICBwZW5kaW5nTm90aWZpY2F0aW9ucyA9IDAsCgkgICAgICAgIHVuZGVybHlpbmdTdWJzY3JpYmVGdW5jdGlvbiA9IHRhcmdldC5zdWJzY3JpYmU7CgoJICAgIC8vIEludGVyY2VwdCAic3Vic2NyaWJlIiBjYWxscywgYW5kIGZvciBhcnJheSBjaGFuZ2UgZXZlbnRzLCBlbnN1cmUgY2hhbmdlIHRyYWNraW5nIGlzIGVuYWJsZWQKCSAgICB0YXJnZXQuc3Vic2NyaWJlID0gdGFyZ2V0WydzdWJzY3JpYmUnXSA9IGZ1bmN0aW9uKGNhbGxiYWNrLCBjYWxsYmFja1RhcmdldCwgZXZlbnQpIHsKCSAgICAgICAgaWYgKGV2ZW50ID09PSBhcnJheUNoYW5nZUV2ZW50TmFtZSkgewoJICAgICAgICAgICAgdHJhY2tDaGFuZ2VzKCk7CgkgICAgICAgIH0KCSAgICAgICAgcmV0dXJuIHVuZGVybHlpbmdTdWJzY3JpYmVGdW5jdGlvbi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoJICAgIH07CgoJICAgIGZ1bmN0aW9uIHRyYWNrQ2hhbmdlcygpIHsKCSAgICAgICAgLy8gQ2FsbGluZyAndHJhY2tDaGFuZ2VzJyBtdWx0aXBsZSB0aW1lcyBpcyB0aGUgc2FtZSBhcyBjYWxsaW5nIGl0IG9uY2UKCSAgICAgICAgaWYgKHRyYWNraW5nQ2hhbmdlcykgewoJICAgICAgICAgICAgcmV0dXJuOwoJICAgICAgICB9CgoJICAgICAgICB0cmFja2luZ0NoYW5nZXMgPSB0cnVlOwoKCSAgICAgICAgLy8gSW50ZXJjZXB0ICJub3RpZnlTdWJzY3JpYmVycyIgdG8gdHJhY2sgaG93IG1hbnkgdGltZXMgaXQgd2FzIGNhbGxlZC4KCSAgICAgICAgdmFyIHVuZGVybHlpbmdOb3RpZnlTdWJzY3JpYmVyc0Z1bmN0aW9uID0gdGFyZ2V0Wydub3RpZnlTdWJzY3JpYmVycyddOwoJICAgICAgICB0YXJnZXRbJ25vdGlmeVN1YnNjcmliZXJzJ10gPSBmdW5jdGlvbih2YWx1ZVRvTm90aWZ5LCBldmVudCkgewoJICAgICAgICAgICAgaWYgKCFldmVudCB8fCBldmVudCA9PT0gZGVmYXVsdEV2ZW50KSB7CgkgICAgICAgICAgICAgICAgKytwZW5kaW5nTm90aWZpY2F0aW9uczsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIHJldHVybiB1bmRlcmx5aW5nTm90aWZ5U3Vic2NyaWJlcnNGdW5jdGlvbi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoJICAgICAgICB9OwoKCSAgICAgICAgLy8gRWFjaCB0aW1lIHRoZSBhcnJheSBjaGFuZ2VzIHZhbHVlLCBjYXB0dXJlIGEgY2xvbmUgc28gdGhhdCBvbiB0aGUgbmV4dAoJICAgICAgICAvLyBjaGFuZ2UgaXQncyBwb3NzaWJsZSB0byBwcm9kdWNlIGEgZGlmZgoJICAgICAgICB2YXIgcHJldmlvdXNDb250ZW50cyA9IFtdLmNvbmNhdCh0YXJnZXQucGVlaygpIHx8IFtdKTsKCSAgICAgICAgY2FjaGVkRGlmZiA9IG51bGw7CgkgICAgICAgIHRhcmdldC5zdWJzY3JpYmUoZnVuY3Rpb24oY3VycmVudENvbnRlbnRzKSB7CgkgICAgICAgICAgICAvLyBNYWtlIGEgY29weSBvZiB0aGUgY3VycmVudCBjb250ZW50cyBhbmQgZW5zdXJlIGl0J3MgYW4gYXJyYXkKCSAgICAgICAgICAgIGN1cnJlbnRDb250ZW50cyA9IFtdLmNvbmNhdChjdXJyZW50Q29udGVudHMgfHwgW10pOwoKCSAgICAgICAgICAgIC8vIENvbXB1dGUgdGhlIGRpZmYgYW5kIGlzc3VlIG5vdGlmaWNhdGlvbnMsIGJ1dCBvbmx5IGlmIHNvbWVvbmUgaXMgbGlzdGVuaW5nCgkgICAgICAgICAgICBpZiAodGFyZ2V0Lmhhc1N1YnNjcmlwdGlvbnNGb3JFdmVudChhcnJheUNoYW5nZUV2ZW50TmFtZSkpIHsKCSAgICAgICAgICAgICAgICB2YXIgY2hhbmdlcyA9IGdldENoYW5nZXMocHJldmlvdXNDb250ZW50cywgY3VycmVudENvbnRlbnRzKTsKCSAgICAgICAgICAgICAgICBpZiAoY2hhbmdlcy5sZW5ndGgpIHsKCSAgICAgICAgICAgICAgICAgICAgdGFyZ2V0Wydub3RpZnlTdWJzY3JpYmVycyddKGNoYW5nZXMsIGFycmF5Q2hhbmdlRXZlbnROYW1lKTsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICB9CgoJICAgICAgICAgICAgLy8gRWxpbWluYXRlIHJlZmVyZW5jZXMgdG8gdGhlIG9sZCwgcmVtb3ZlZCBpdGVtcywgc28gdGhleSBjYW4gYmUgR0NlZAoJICAgICAgICAgICAgcHJldmlvdXNDb250ZW50cyA9IGN1cnJlbnRDb250ZW50czsKCSAgICAgICAgICAgIGNhY2hlZERpZmYgPSBudWxsOwoJICAgICAgICAgICAgcGVuZGluZ05vdGlmaWNhdGlvbnMgPSAwOwoJICAgICAgICB9KTsKCSAgICB9CgoJICAgIGZ1bmN0aW9uIGdldENoYW5nZXMocHJldmlvdXNDb250ZW50cywgY3VycmVudENvbnRlbnRzKSB7CgkgICAgICAgIC8vIFdlIHRyeSB0byByZS11c2UgY2FjaGVkIGRpZmZzLgoJICAgICAgICAvLyBUaGUgc2NlbmFyaW9zIHdoZXJlIHBlbmRpbmdOb3RpZmljYXRpb25zID4gMSBhcmUgd2hlbiB1c2luZyByYXRlLWxpbWl0aW5nIG9yIHRoZSBEZWZlcnJlZCBVcGRhdGVzCgkgICAgICAgIC8vIHBsdWdpbiwgd2hpY2ggd2l0aG91dCB0aGlzIGNoZWNrIHdvdWxkIG5vdCBiZSBjb21wYXRpYmxlIHdpdGggYXJyYXlDaGFuZ2Ugbm90aWZpY2F0aW9ucy4gTm9ybWFsbHksCgkgICAgICAgIC8vIG5vdGlmaWNhdGlvbnMgYXJlIGlzc3VlZCBpbW1lZGlhdGVseSBzbyB3ZSB3b3VsZG4ndCBiZSBxdWV1ZWluZyB1cCBtb3JlIHRoYW4gb25lLgoJICAgICAgICBpZiAoIWNhY2hlZERpZmYgfHwgcGVuZGluZ05vdGlmaWNhdGlvbnMgPiAxKSB7CgkgICAgICAgICAgICBjYWNoZWREaWZmID0ga28udXRpbHMuY29tcGFyZUFycmF5cyhwcmV2aW91c0NvbnRlbnRzLCBjdXJyZW50Q29udGVudHMsIHsgJ3NwYXJzZSc6IHRydWUgfSk7CgkgICAgICAgIH0KCgkgICAgICAgIHJldHVybiBjYWNoZWREaWZmOwoJICAgIH0KCgkgICAgdGFyZ2V0LmNhY2hlRGlmZkZvcktub3duT3BlcmF0aW9uID0gZnVuY3Rpb24ocmF3QXJyYXksIG9wZXJhdGlvbk5hbWUsIGFyZ3MpIHsKCSAgICAgICAgLy8gT25seSBydW4gaWYgd2UncmUgY3VycmVudGx5IHRyYWNraW5nIGNoYW5nZXMgZm9yIHRoaXMgb2JzZXJ2YWJsZSBhcnJheQoJICAgICAgICAvLyBhbmQgdGhlcmUgYXJlbid0IGFueSBwZW5kaW5nIGRlZmVycmVkIG5vdGlmaWNhdGlvbnMuCgkgICAgICAgIGlmICghdHJhY2tpbmdDaGFuZ2VzIHx8IHBlbmRpbmdOb3RpZmljYXRpb25zKSB7CgkgICAgICAgICAgICByZXR1cm47CgkgICAgICAgIH0KCSAgICAgICAgdmFyIGRpZmYgPSBbXSwKCSAgICAgICAgICAgIGFycmF5TGVuZ3RoID0gcmF3QXJyYXkubGVuZ3RoLAoJICAgICAgICAgICAgYXJnc0xlbmd0aCA9IGFyZ3MubGVuZ3RoLAoJICAgICAgICAgICAgb2Zmc2V0ID0gMDsKCgkgICAgICAgIGZ1bmN0aW9uIHB1c2hEaWZmKHN0YXR1cywgdmFsdWUsIGluZGV4KSB7CgkgICAgICAgICAgICByZXR1cm4gZGlmZltkaWZmLmxlbmd0aF0gPSB7ICdzdGF0dXMnOiBzdGF0dXMsICd2YWx1ZSc6IHZhbHVlLCAnaW5kZXgnOiBpbmRleCB9OwoJICAgICAgICB9CgkgICAgICAgIHN3aXRjaCAob3BlcmF0aW9uTmFtZSkgewoJICAgICAgICAgICAgY2FzZSAncHVzaCc6CgkgICAgICAgICAgICAgICAgb2Zmc2V0ID0gYXJyYXlMZW5ndGg7CgkgICAgICAgICAgICBjYXNlICd1bnNoaWZ0JzoKCSAgICAgICAgICAgICAgICBmb3IgKHZhciBpbmRleCA9IDA7IGluZGV4IDwgYXJnc0xlbmd0aDsgaW5kZXgrKykgewoJICAgICAgICAgICAgICAgICAgICBwdXNoRGlmZignYWRkZWQnLCBhcmdzW2luZGV4XSwgb2Zmc2V0ICsgaW5kZXgpOwoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICBicmVhazsKCgkgICAgICAgICAgICBjYXNlICdwb3AnOgoJICAgICAgICAgICAgICAgIG9mZnNldCA9IGFycmF5TGVuZ3RoIC0gMTsKCSAgICAgICAgICAgIGNhc2UgJ3NoaWZ0JzoKCSAgICAgICAgICAgICAgICBpZiAoYXJyYXlMZW5ndGgpIHsKCSAgICAgICAgICAgICAgICAgICAgcHVzaERpZmYoJ2RlbGV0ZWQnLCByYXdBcnJheVtvZmZzZXRdLCBvZmZzZXQpOwoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICBicmVhazsKCgkgICAgICAgICAgICBjYXNlICdzcGxpY2UnOgoJICAgICAgICAgICAgICAgIC8vIE5lZ2F0aXZlIHN0YXJ0IGluZGV4IG1lYW5zICdmcm9tIGVuZCBvZiBhcnJheScuIEFmdGVyIHRoYXQgd2UgY2xhbXAgdG8gWzAuLi5hcnJheUxlbmd0aF0uCgkgICAgICAgICAgICAgICAgLy8gU2VlIGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvV2ViL0phdmFTY3JpcHQvUmVmZXJlbmNlL0dsb2JhbF9PYmplY3RzL0FycmF5L3NwbGljZQoJICAgICAgICAgICAgICAgIHZhciBzdGFydEluZGV4ID0gTWF0aC5taW4oTWF0aC5tYXgoMCwgYXJnc1swXSA8IDAgPyBhcnJheUxlbmd0aCArIGFyZ3NbMF0gOiBhcmdzWzBdKSwgYXJyYXlMZW5ndGgpLAoJICAgICAgICAgICAgICAgICAgICBlbmREZWxldGVJbmRleCA9IGFyZ3NMZW5ndGggPT09IDEgPyBhcnJheUxlbmd0aCA6IE1hdGgubWluKHN0YXJ0SW5kZXggKyAoYXJnc1sxXSB8fCAwKSwgYXJyYXlMZW5ndGgpLAoJICAgICAgICAgICAgICAgICAgICBlbmRBZGRJbmRleCA9IHN0YXJ0SW5kZXggKyBhcmdzTGVuZ3RoIC0gMiwKCSAgICAgICAgICAgICAgICAgICAgZW5kSW5kZXggPSBNYXRoLm1heChlbmREZWxldGVJbmRleCwgZW5kQWRkSW5kZXgpLAoJICAgICAgICAgICAgICAgICAgICBhZGRpdGlvbnMgPSBbXSwgZGVsZXRpb25zID0gW107CgkgICAgICAgICAgICAgICAgZm9yICh2YXIgaW5kZXggPSBzdGFydEluZGV4LCBhcmdzSW5kZXggPSAyOyBpbmRleCA8IGVuZEluZGV4OyArK2luZGV4LCArK2FyZ3NJbmRleCkgewoJICAgICAgICAgICAgICAgICAgICBpZiAoaW5kZXggPCBlbmREZWxldGVJbmRleCkKCSAgICAgICAgICAgICAgICAgICAgICAgIGRlbGV0aW9ucy5wdXNoKHB1c2hEaWZmKCdkZWxldGVkJywgcmF3QXJyYXlbaW5kZXhdLCBpbmRleCkpOwoJICAgICAgICAgICAgICAgICAgICBpZiAoaW5kZXggPCBlbmRBZGRJbmRleCkKCSAgICAgICAgICAgICAgICAgICAgICAgIGFkZGl0aW9ucy5wdXNoKHB1c2hEaWZmKCdhZGRlZCcsIGFyZ3NbYXJnc0luZGV4XSwgaW5kZXgpKTsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAga28udXRpbHMuZmluZE1vdmVzSW5BcnJheUNvbXBhcmlzb24oZGVsZXRpb25zLCBhZGRpdGlvbnMpOwoJICAgICAgICAgICAgICAgIGJyZWFrOwoKCSAgICAgICAgICAgIGRlZmF1bHQ6CgkgICAgICAgICAgICAgICAgcmV0dXJuOwoJICAgICAgICB9CgkgICAgICAgIGNhY2hlZERpZmYgPSBkaWZmOwoJICAgIH07Cgl9OwoJa28uY29tcHV0ZWQgPSBrby5kZXBlbmRlbnRPYnNlcnZhYmxlID0gZnVuY3Rpb24gKGV2YWx1YXRvckZ1bmN0aW9uT3JPcHRpb25zLCBldmFsdWF0b3JGdW5jdGlvblRhcmdldCwgb3B0aW9ucykgewoJICAgIHZhciBfbGF0ZXN0VmFsdWUsCgkgICAgICAgIF9uZWVkc0V2YWx1YXRpb24gPSB0cnVlLAoJICAgICAgICBfaXNCZWluZ0V2YWx1YXRlZCA9IGZhbHNlLAoJICAgICAgICBfc3VwcHJlc3NEaXNwb3NhbFVudGlsRGlzcG9zZVdoZW5SZXR1cm5zRmFsc2UgPSBmYWxzZSwKCSAgICAgICAgX2lzRGlzcG9zZWQgPSBmYWxzZSwKCSAgICAgICAgcmVhZEZ1bmN0aW9uID0gZXZhbHVhdG9yRnVuY3Rpb25Pck9wdGlvbnMsCgkgICAgICAgIHB1cmUgPSBmYWxzZSwKCSAgICAgICAgaXNTbGVlcGluZyA9IGZhbHNlOwoKCSAgICBpZiAocmVhZEZ1bmN0aW9uICYmIHR5cGVvZiByZWFkRnVuY3Rpb24gPT0gIm9iamVjdCIpIHsKCSAgICAgICAgLy8gU2luZ2xlLXBhcmFtZXRlciBzeW50YXggLSBldmVyeXRoaW5nIGlzIG9uIHRoaXMgIm9wdGlvbnMiIHBhcmFtCgkgICAgICAgIG9wdGlvbnMgPSByZWFkRnVuY3Rpb247CgkgICAgICAgIHJlYWRGdW5jdGlvbiA9IG9wdGlvbnNbInJlYWQiXTsKCSAgICB9IGVsc2UgewoJICAgICAgICAvLyBNdWx0aS1wYXJhbWV0ZXIgc3ludGF4IC0gY29uc3RydWN0IHRoZSBvcHRpb25zIGFjY29yZGluZyB0byB0aGUgcGFyYW1zIHBhc3NlZAoJICAgICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKCSAgICAgICAgaWYgKCFyZWFkRnVuY3Rpb24pCgkgICAgICAgICAgICByZWFkRnVuY3Rpb24gPSBvcHRpb25zWyJyZWFkIl07CgkgICAgfQoJICAgIGlmICh0eXBlb2YgcmVhZEZ1bmN0aW9uICE9ICJmdW5jdGlvbiIpCgkgICAgICAgIHRocm93IG5ldyBFcnJvcigiUGFzcyBhIGZ1bmN0aW9uIHRoYXQgcmV0dXJucyB0aGUgdmFsdWUgb2YgdGhlIGtvLmNvbXB1dGVkIik7CgoJICAgIGZ1bmN0aW9uIGFkZFN1YnNjcmlwdGlvblRvRGVwZW5kZW5jeShzdWJzY3JpYmFibGUsIGlkKSB7CgkgICAgICAgIGlmICghX3N1YnNjcmlwdGlvbnNUb0RlcGVuZGVuY2llc1tpZF0pIHsKCSAgICAgICAgICAgIF9zdWJzY3JpcHRpb25zVG9EZXBlbmRlbmNpZXNbaWRdID0gc3Vic2NyaWJhYmxlLnN1YnNjcmliZShldmFsdWF0ZVBvc3NpYmx5QXN5bmMpOwoJICAgICAgICAgICAgKytfZGVwZW5kZW5jaWVzQ291bnQ7CgkgICAgICAgIH0KCSAgICB9CgoJICAgIGZ1bmN0aW9uIGRpc3Bvc2VBbGxTdWJzY3JpcHRpb25zVG9EZXBlbmRlbmNpZXMoKSB7CgkgICAgICAgIGtvLnV0aWxzLm9iamVjdEZvckVhY2goX3N1YnNjcmlwdGlvbnNUb0RlcGVuZGVuY2llcywgZnVuY3Rpb24gKGlkLCBzdWJzY3JpcHRpb24pIHsKCSAgICAgICAgICAgIHN1YnNjcmlwdGlvbi5kaXNwb3NlKCk7CgkgICAgICAgIH0pOwoJICAgICAgICBfc3Vic2NyaXB0aW9uc1RvRGVwZW5kZW5jaWVzID0ge307CgkgICAgfQoKCSAgICBmdW5jdGlvbiBkaXNwb3NlQ29tcHV0ZWQoKSB7CgkgICAgICAgIGRpc3Bvc2VBbGxTdWJzY3JpcHRpb25zVG9EZXBlbmRlbmNpZXMoKTsKCSAgICAgICAgX2RlcGVuZGVuY2llc0NvdW50ID0gMDsKCSAgICAgICAgX2lzRGlzcG9zZWQgPSB0cnVlOwoJICAgICAgICBfbmVlZHNFdmFsdWF0aW9uID0gZmFsc2U7CgkgICAgfQoKCSAgICBmdW5jdGlvbiBldmFsdWF0ZVBvc3NpYmx5QXN5bmMoKSB7CgkgICAgICAgIHZhciB0aHJvdHRsZUV2YWx1YXRpb25UaW1lb3V0ID0gZGVwZW5kZW50T2JzZXJ2YWJsZVsndGhyb3R0bGVFdmFsdWF0aW9uJ107CgkgICAgICAgIGlmICh0aHJvdHRsZUV2YWx1YXRpb25UaW1lb3V0ICYmIHRocm90dGxlRXZhbHVhdGlvblRpbWVvdXQgPj0gMCkgewoJICAgICAgICAgICAgY2xlYXJUaW1lb3V0KGV2YWx1YXRpb25UaW1lb3V0SW5zdGFuY2UpOwoJICAgICAgICAgICAgZXZhbHVhdGlvblRpbWVvdXRJbnN0YW5jZSA9IHNldFRpbWVvdXQoZXZhbHVhdGVJbW1lZGlhdGUsIHRocm90dGxlRXZhbHVhdGlvblRpbWVvdXQpOwoJICAgICAgICB9IGVsc2UgaWYgKGRlcGVuZGVudE9ic2VydmFibGUuX2V2YWxSYXRlTGltaXRlZCkgewoJICAgICAgICAgICAgZGVwZW5kZW50T2JzZXJ2YWJsZS5fZXZhbFJhdGVMaW1pdGVkKCk7CgkgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICBldmFsdWF0ZUltbWVkaWF0ZSgpOwoJICAgICAgICB9CgkgICAgfQoKCSAgICBmdW5jdGlvbiBldmFsdWF0ZUltbWVkaWF0ZShzdXBwcmVzc0NoYW5nZU5vdGlmaWNhdGlvbikgewoJICAgICAgICBpZiAoX2lzQmVpbmdFdmFsdWF0ZWQpIHsKCSAgICAgICAgICAgIGlmIChwdXJlKSB7CgkgICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoIkEgJ3B1cmUnIGNvbXB1dGVkIG11c3Qgbm90IGJlIGNhbGxlZCByZWN1cnNpdmVseSIpOwoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgLy8gSWYgdGhlIGV2YWx1YXRpb24gb2YgYSBrby5jb21wdXRlZCBjYXVzZXMgc2lkZSBlZmZlY3RzLCBpdCdzIHBvc3NpYmxlIHRoYXQgaXQgd2lsbCB0cmlnZ2VyIGl0cyBvd24gcmUtZXZhbHVhdGlvbi4KCSAgICAgICAgICAgIC8vIFRoaXMgaXMgbm90IGRlc2lyYWJsZSAoaXQncyBoYXJkIGZvciBhIGRldmVsb3BlciB0byByZWFsaXNlIGEgY2hhaW4gb2YgZGVwZW5kZW5jaWVzIG1pZ2h0IGNhdXNlIHRoaXMsIGFuZCB0aGV5IGFsbW9zdAoJICAgICAgICAgICAgLy8gY2VydGFpbmx5IGRpZG4ndCBpbnRlbmQgaW5maW5pdGUgcmUtZXZhbHVhdGlvbnMpLiBTbywgZm9yIHByZWRpY3RhYmlsaXR5LCB3ZSBzaW1wbHkgcHJldmVudCBrby5jb21wdXRlZHMgZnJvbSBjYXVzaW5nCgkgICAgICAgICAgICAvLyB0aGVpciBvd24gcmUtZXZhbHVhdGlvbi4gRnVydGhlciBkaXNjdXNzaW9uIGF0IGh0dHBzOi8vZ2l0aHViLmNvbS9TdGV2ZVNhbmRlcnNvbi9rbm9ja291dC9wdWxsLzM4NwoJICAgICAgICAgICAgcmV0dXJuOwoJICAgICAgICB9CgoJICAgICAgICAvLyBEbyBub3QgZXZhbHVhdGUgKGFuZCBwb3NzaWJseSBjYXB0dXJlIG5ldyBkZXBlbmRlbmNpZXMpIGlmIGRpc3Bvc2VkCgkgICAgICAgIGlmIChfaXNEaXNwb3NlZCkgewoJICAgICAgICAgICAgcmV0dXJuOwoJICAgICAgICB9CgoJICAgICAgICBpZiAoZGlzcG9zZVdoZW4gJiYgZGlzcG9zZVdoZW4oKSkgewoJICAgICAgICAgICAgLy8gU2VlIGNvbW1lbnQgYmVsb3cgYWJvdXQgX3N1cHByZXNzRGlzcG9zYWxVbnRpbERpc3Bvc2VXaGVuUmV0dXJuc0ZhbHNlCgkgICAgICAgICAgICBpZiAoIV9zdXBwcmVzc0Rpc3Bvc2FsVW50aWxEaXNwb3NlV2hlblJldHVybnNGYWxzZSkgewoJICAgICAgICAgICAgICAgIGRpc3Bvc2UoKTsKCSAgICAgICAgICAgICAgICByZXR1cm47CgkgICAgICAgICAgICB9CgkgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICAvLyBJdCBqdXN0IGRpZCByZXR1cm4gZmFsc2UsIHNvIHdlIGNhbiBzdG9wIHN1cHByZXNzaW5nIG5vdwoJICAgICAgICAgICAgX3N1cHByZXNzRGlzcG9zYWxVbnRpbERpc3Bvc2VXaGVuUmV0dXJuc0ZhbHNlID0gZmFsc2U7CgkgICAgICAgIH0KCgkgICAgICAgIF9pc0JlaW5nRXZhbHVhdGVkID0gdHJ1ZTsKCgkgICAgICAgIC8vIFdoZW4gc2xlZXBpbmcsIHJlY2FsY3VsYXRlIHRoZSB2YWx1ZSBhbmQgcmV0dXJuLgoJICAgICAgICBpZiAoaXNTbGVlcGluZykgewoJICAgICAgICAgICAgdHJ5IHsKCSAgICAgICAgICAgICAgICB2YXIgZGVwZW5kZW5jeVRyYWNraW5nID0ge307CgkgICAgICAgICAgICAgICAga28uZGVwZW5kZW5jeURldGVjdGlvbi5iZWdpbih7CgkgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrOiBmdW5jdGlvbiAoc3Vic2NyaWJhYmxlLCBpZCkgewoJICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFkZXBlbmRlbmN5VHJhY2tpbmdbaWRdKSB7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVwZW5kZW5jeVRyYWNraW5nW2lkXSA9IDE7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgKytfZGVwZW5kZW5jaWVzQ291bnQ7CgkgICAgICAgICAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgICAgIH0sCgkgICAgICAgICAgICAgICAgICAgIGNvbXB1dGVkOiBkZXBlbmRlbnRPYnNlcnZhYmxlLAoJICAgICAgICAgICAgICAgICAgICBpc0luaXRpYWw6IHVuZGVmaW5lZAoJICAgICAgICAgICAgICAgIH0pOwoJICAgICAgICAgICAgICAgIF9kZXBlbmRlbmNpZXNDb3VudCA9IDA7CgkgICAgICAgICAgICAgICAgX2xhdGVzdFZhbHVlID0gcmVhZEZ1bmN0aW9uLmNhbGwoZXZhbHVhdG9yRnVuY3Rpb25UYXJnZXQpOwoJICAgICAgICAgICAgfSBmaW5hbGx5IHsKCSAgICAgICAgICAgICAgICBrby5kZXBlbmRlbmN5RGV0ZWN0aW9uLmVuZCgpOwoJICAgICAgICAgICAgICAgIF9pc0JlaW5nRXZhbHVhdGVkID0gZmFsc2U7CgkgICAgICAgICAgICB9CgkgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICB0cnkgewoJICAgICAgICAgICAgICAgIC8vIEluaXRpYWxseSwgd2UgYXNzdW1lIHRoYXQgbm9uZSBvZiB0aGUgc3Vic2NyaXB0aW9ucyBhcmUgc3RpbGwgYmVpbmcgdXNlZCAoaS5lLiwgYWxsIGFyZSBjYW5kaWRhdGVzIGZvciBkaXNwb3NhbCkuCgkgICAgICAgICAgICAgICAgLy8gVGhlbiwgZHVyaW5nIGV2YWx1YXRpb24sIHdlIGNyb3NzIG9mZiBhbnkgdGhhdCBhcmUgaW4gZmFjdCBzdGlsbCBiZWluZyB1c2VkLgoJICAgICAgICAgICAgICAgIHZhciBkaXNwb3NhbENhbmRpZGF0ZXMgPSBfc3Vic2NyaXB0aW9uc1RvRGVwZW5kZW5jaWVzLCBkaXNwb3NhbENvdW50ID0gX2RlcGVuZGVuY2llc0NvdW50OwoJICAgICAgICAgICAgICAgIGtvLmRlcGVuZGVuY3lEZXRlY3Rpb24uYmVnaW4oewoJICAgICAgICAgICAgICAgICAgICBjYWxsYmFjazogZnVuY3Rpb24oc3Vic2NyaWJhYmxlLCBpZCkgewoJICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFfaXNEaXNwb3NlZCkgewoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkaXNwb3NhbENvdW50ICYmIGRpc3Bvc2FsQ2FuZGlkYXRlc1tpZF0pIHsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gRG9uJ3Qgd2FudCB0byBkaXNwb3NlIHRoaXMgc3Vic2NyaXB0aW9uLCBhcyBpdCdzIHN0aWxsIGJlaW5nIHVzZWQKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgX3N1YnNjcmlwdGlvbnNUb0RlcGVuZGVuY2llc1tpZF0gPSBkaXNwb3NhbENhbmRpZGF0ZXNbaWRdOwoJICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICArK19kZXBlbmRlbmNpZXNDb3VudDsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGRpc3Bvc2FsQ2FuZGlkYXRlc1tpZF07CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0tZGlzcG9zYWxDb3VudDsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBCcmFuZCBuZXcgc3Vic2NyaXB0aW9uIC0gYWRkIGl0CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFkZFN1YnNjcmlwdGlvblRvRGVwZW5kZW5jeShzdWJzY3JpYmFibGUsIGlkKTsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgICAgIH0sCgkgICAgICAgICAgICAgICAgICAgIGNvbXB1dGVkOiBkZXBlbmRlbnRPYnNlcnZhYmxlLAoJICAgICAgICAgICAgICAgICAgICBpc0luaXRpYWw6IHB1cmUgPyB1bmRlZmluZWQgOiAhX2RlcGVuZGVuY2llc0NvdW50ICAgICAgICAvLyBJZiB3ZSdyZSBldmFsdWF0aW5nIHdoZW4gdGhlcmUgYXJlIG5vIHByZXZpb3VzIGRlcGVuZGVuY2llcywgaXQgbXVzdCBiZSB0aGUgZmlyc3QgdGltZQoJICAgICAgICAgICAgICAgIH0pOwoKCSAgICAgICAgICAgICAgICBfc3Vic2NyaXB0aW9uc1RvRGVwZW5kZW5jaWVzID0ge307CgkgICAgICAgICAgICAgICAgX2RlcGVuZGVuY2llc0NvdW50ID0gMDsKCgkgICAgICAgICAgICAgICAgdHJ5IHsKCSAgICAgICAgICAgICAgICAgICAgdmFyIG5ld1ZhbHVlID0gZXZhbHVhdG9yRnVuY3Rpb25UYXJnZXQgPyByZWFkRnVuY3Rpb24uY2FsbChldmFsdWF0b3JGdW5jdGlvblRhcmdldCkgOiByZWFkRnVuY3Rpb24oKTsKCgkgICAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKCSAgICAgICAgICAgICAgICAgICAga28uZGVwZW5kZW5jeURldGVjdGlvbi5lbmQoKTsKCgkgICAgICAgICAgICAgICAgICAgIC8vIEZvciBlYWNoIHN1YnNjcmlwdGlvbiBubyBsb25nZXIgYmVpbmcgdXNlZCwgcmVtb3ZlIGl0IGZyb20gdGhlIGFjdGl2ZSBzdWJzY3JpcHRpb25zIGxpc3QgYW5kIGRpc3Bvc2UgaXQKCSAgICAgICAgICAgICAgICAgICAgaWYgKGRpc3Bvc2FsQ291bnQpIHsKCSAgICAgICAgICAgICAgICAgICAgICAgIGtvLnV0aWxzLm9iamVjdEZvckVhY2goZGlzcG9zYWxDYW5kaWRhdGVzLCBmdW5jdGlvbihpZCwgdG9EaXNwb3NlKSB7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9EaXNwb3NlLmRpc3Bvc2UoKTsKCSAgICAgICAgICAgICAgICAgICAgICAgIH0pOwoJICAgICAgICAgICAgICAgICAgICB9CgoJICAgICAgICAgICAgICAgICAgICBfbmVlZHNFdmFsdWF0aW9uID0gZmFsc2U7CgkgICAgICAgICAgICAgICAgfQoKCSAgICAgICAgICAgICAgICBpZiAoZGVwZW5kZW50T2JzZXJ2YWJsZS5pc0RpZmZlcmVudChfbGF0ZXN0VmFsdWUsIG5ld1ZhbHVlKSkgewoJICAgICAgICAgICAgICAgICAgICBkZXBlbmRlbnRPYnNlcnZhYmxlWyJub3RpZnlTdWJzY3JpYmVycyJdKF9sYXRlc3RWYWx1ZSwgImJlZm9yZUNoYW5nZSIpOwoKCSAgICAgICAgICAgICAgICAgICAgX2xhdGVzdFZhbHVlID0gbmV3VmFsdWU7CgkgICAgICAgICAgICAgICAgICAgIGlmIChERUJVRykgZGVwZW5kZW50T2JzZXJ2YWJsZS5fbGF0ZXN0VmFsdWUgPSBfbGF0ZXN0VmFsdWU7CgoJICAgICAgICAgICAgICAgICAgICBpZiAoc3VwcHJlc3NDaGFuZ2VOb3RpZmljYXRpb24gIT09IHRydWUpIHsgIC8vIENoZWNrIGZvciBzdHJpY3QgdHJ1ZSB2YWx1ZSBzaW5jZSBzZXRUaW1lb3V0IGluIEZpcmVmb3ggcGFzc2VzIGEgbnVtZXJpYyB2YWx1ZSB0byB0aGUgZnVuY3Rpb24KCSAgICAgICAgICAgICAgICAgICAgICAgIGRlcGVuZGVudE9ic2VydmFibGVbIm5vdGlmeVN1YnNjcmliZXJzIl0oX2xhdGVzdFZhbHVlKTsKCSAgICAgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgIH0gZmluYWxseSB7CgkgICAgICAgICAgICAgICAgX2lzQmVpbmdFdmFsdWF0ZWQgPSBmYWxzZTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgfQoKCSAgICAgICAgaWYgKCFfZGVwZW5kZW5jaWVzQ291bnQpCgkgICAgICAgICAgICBkaXNwb3NlKCk7CgkgICAgfQoKCSAgICBmdW5jdGlvbiBkZXBlbmRlbnRPYnNlcnZhYmxlKCkgewoJICAgICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA+IDApIHsKCSAgICAgICAgICAgIGlmICh0eXBlb2Ygd3JpdGVGdW5jdGlvbiA9PT0gImZ1bmN0aW9uIikgewoJICAgICAgICAgICAgICAgIC8vIFdyaXRpbmcgYSB2YWx1ZQoJICAgICAgICAgICAgICAgIHdyaXRlRnVuY3Rpb24uYXBwbHkoZXZhbHVhdG9yRnVuY3Rpb25UYXJnZXQsIGFyZ3VtZW50cyk7CgkgICAgICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQ2Fubm90IHdyaXRlIGEgdmFsdWUgdG8gYSBrby5jb21wdXRlZCB1bmxlc3MgeW91IHNwZWNpZnkgYSAnd3JpdGUnIG9wdGlvbi4gSWYgeW91IHdpc2ggdG8gcmVhZCB0aGUgY3VycmVudCB2YWx1ZSwgZG9uJ3QgcGFzcyBhbnkgcGFyYW1ldGVycy4iKTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIHJldHVybiB0aGlzOyAvLyBQZXJtaXRzIGNoYWluZWQgYXNzaWdubWVudHMKCSAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgIC8vIFJlYWRpbmcgdGhlIHZhbHVlCgkgICAgICAgICAgICBrby5kZXBlbmRlbmN5RGV0ZWN0aW9uLnJlZ2lzdGVyRGVwZW5kZW5jeShkZXBlbmRlbnRPYnNlcnZhYmxlKTsKCSAgICAgICAgICAgIGlmIChfbmVlZHNFdmFsdWF0aW9uKQoJICAgICAgICAgICAgICAgIGV2YWx1YXRlSW1tZWRpYXRlKHRydWUgLyogc3VwcHJlc3NDaGFuZ2VOb3RpZmljYXRpb24gKi8pOwoJICAgICAgICAgICAgcmV0dXJuIF9sYXRlc3RWYWx1ZTsKCSAgICAgICAgfQoJICAgIH0KCgkgICAgZnVuY3Rpb24gcGVlaygpIHsKCSAgICAgICAgLy8gUGVlayB3b24ndCByZS1ldmFsdWF0ZSwgZXhjZXB0IHRvIGdldCB0aGUgaW5pdGlhbCB2YWx1ZSB3aGVuICJkZWZlckV2YWx1YXRpb24iIGlzIHNldCwgb3Igd2hpbGUgdGhlIGNvbXB1dGVkIGlzIHNsZWVwaW5nLgoJICAgICAgICAvLyBUaG9zZSBhcmUgdGhlIG9ubHkgdGltZXMgdGhhdCBib3RoIG9mIHRoZXNlIGNvbmRpdGlvbnMgd2lsbCBiZSBzYXRpc2ZpZWQuCgkgICAgICAgIGlmIChfbmVlZHNFdmFsdWF0aW9uICYmICFfZGVwZW5kZW5jaWVzQ291bnQpCgkgICAgICAgICAgICBldmFsdWF0ZUltbWVkaWF0ZSh0cnVlIC8qIHN1cHByZXNzQ2hhbmdlTm90aWZpY2F0aW9uICovKTsKCSAgICAgICAgcmV0dXJuIF9sYXRlc3RWYWx1ZTsKCSAgICB9CgoJICAgIGZ1bmN0aW9uIGlzQWN0aXZlKCkgewoJICAgICAgICByZXR1cm4gX25lZWRzRXZhbHVhdGlvbiB8fCBfZGVwZW5kZW5jaWVzQ291bnQgPiAwOwoJICAgIH0KCgkgICAgLy8gQnkgaGVyZSwgIm9wdGlvbnMiIGlzIGFsd2F5cyBub24tbnVsbAoJICAgIHZhciB3cml0ZUZ1bmN0aW9uID0gb3B0aW9uc1sid3JpdGUiXSwKCSAgICAgICAgZGlzcG9zZVdoZW5Ob2RlSXNSZW1vdmVkID0gb3B0aW9uc1siZGlzcG9zZVdoZW5Ob2RlSXNSZW1vdmVkIl0gfHwgb3B0aW9ucy5kaXNwb3NlV2hlbk5vZGVJc1JlbW92ZWQgfHwgbnVsbCwKCSAgICAgICAgZGlzcG9zZVdoZW5PcHRpb24gPSBvcHRpb25zWyJkaXNwb3NlV2hlbiJdIHx8IG9wdGlvbnMuZGlzcG9zZVdoZW4sCgkgICAgICAgIGRpc3Bvc2VXaGVuID0gZGlzcG9zZVdoZW5PcHRpb24sCgkgICAgICAgIGRpc3Bvc2UgPSBkaXNwb3NlQ29tcHV0ZWQsCgkgICAgICAgIF9zdWJzY3JpcHRpb25zVG9EZXBlbmRlbmNpZXMgPSB7fSwKCSAgICAgICAgX2RlcGVuZGVuY2llc0NvdW50ID0gMCwKCSAgICAgICAgZXZhbHVhdGlvblRpbWVvdXRJbnN0YW5jZSA9IG51bGw7CgoJICAgIGlmICghZXZhbHVhdG9yRnVuY3Rpb25UYXJnZXQpCgkgICAgICAgIGV2YWx1YXRvckZ1bmN0aW9uVGFyZ2V0ID0gb3B0aW9uc1sib3duZXIiXTsKCgkgICAga28uc3Vic2NyaWJhYmxlLmNhbGwoZGVwZW5kZW50T2JzZXJ2YWJsZSk7CgkgICAga28udXRpbHMuc2V0UHJvdG90eXBlT2ZPckV4dGVuZChkZXBlbmRlbnRPYnNlcnZhYmxlLCBrby5kZXBlbmRlbnRPYnNlcnZhYmxlWydmbiddKTsKCgkgICAgZGVwZW5kZW50T2JzZXJ2YWJsZS5wZWVrID0gcGVlazsKCSAgICBkZXBlbmRlbnRPYnNlcnZhYmxlLmdldERlcGVuZGVuY2llc0NvdW50ID0gZnVuY3Rpb24gKCkgeyByZXR1cm4gX2RlcGVuZGVuY2llc0NvdW50OyB9OwoJICAgIGRlcGVuZGVudE9ic2VydmFibGUuaGFzV3JpdGVGdW5jdGlvbiA9IHR5cGVvZiBvcHRpb25zWyJ3cml0ZSJdID09PSAiZnVuY3Rpb24iOwoJICAgIGRlcGVuZGVudE9ic2VydmFibGUuZGlzcG9zZSA9IGZ1bmN0aW9uICgpIHsgZGlzcG9zZSgpOyB9OwoJICAgIGRlcGVuZGVudE9ic2VydmFibGUuaXNBY3RpdmUgPSBpc0FjdGl2ZTsKCgkgICAgLy8gUmVwbGFjZSB0aGUgbGltaXQgZnVuY3Rpb24gd2l0aCBvbmUgdGhhdCBkZWxheXMgZXZhbHVhdGlvbiBhcyB3ZWxsLgoJICAgIHZhciBvcmlnaW5hbExpbWl0ID0gZGVwZW5kZW50T2JzZXJ2YWJsZS5saW1pdDsKCSAgICBkZXBlbmRlbnRPYnNlcnZhYmxlLmxpbWl0ID0gZnVuY3Rpb24obGltaXRGdW5jdGlvbikgewoJICAgICAgICBvcmlnaW5hbExpbWl0LmNhbGwoZGVwZW5kZW50T2JzZXJ2YWJsZSwgbGltaXRGdW5jdGlvbik7CgkgICAgICAgIGRlcGVuZGVudE9ic2VydmFibGUuX2V2YWxSYXRlTGltaXRlZCA9IGZ1bmN0aW9uKCkgewoJICAgICAgICAgICAgZGVwZW5kZW50T2JzZXJ2YWJsZS5fcmF0ZUxpbWl0ZWRCZWZvcmVDaGFuZ2UoX2xhdGVzdFZhbHVlKTsKCgkgICAgICAgICAgICBfbmVlZHNFdmFsdWF0aW9uID0gdHJ1ZTsgICAgLy8gTWFyayBhcyBkaXJ0eQoKCSAgICAgICAgICAgIC8vIFBhc3MgdGhlIG9ic2VydmFibGUgdG8gdGhlIHJhdGUtbGltaXQgY29kZSwgd2hpY2ggd2lsbCBhY2Nlc3MgaXQgd2hlbgoJICAgICAgICAgICAgLy8gaXQncyB0aW1lIHRvIGRvIHRoZSBub3RpZmljYXRpb24uCgkgICAgICAgICAgICBkZXBlbmRlbnRPYnNlcnZhYmxlLl9yYXRlTGltaXRlZENoYW5nZShkZXBlbmRlbnRPYnNlcnZhYmxlKTsKCSAgICAgICAgfQoJICAgIH07CgoJICAgIGlmIChvcHRpb25zWydwdXJlJ10pIHsKCSAgICAgICAgcHVyZSA9IHRydWU7CgkgICAgICAgIGlzU2xlZXBpbmcgPSB0cnVlOyAgICAgLy8gU3RhcnRzIG9mZiBzbGVlcGluZzsgd2lsbCBhd2FrZSBvbiB0aGUgZmlyc3Qgc3Vic2NyaXB0aW9uCgkgICAgICAgIGRlcGVuZGVudE9ic2VydmFibGUuYmVmb3JlU3Vic2NyaXB0aW9uQWRkID0gZnVuY3Rpb24gKCkgewoJICAgICAgICAgICAgLy8gSWYgYXNsZWVwLCB3YWtlIHVwIHRoZSBjb21wdXRlZCBhbmQgZXZhbHVhdGUgdG8gcmVnaXN0ZXIgYW55IGRlcGVuZGVuY2llcy4KCSAgICAgICAgICAgIGlmIChpc1NsZWVwaW5nKSB7CgkgICAgICAgICAgICAgICAgaXNTbGVlcGluZyA9IGZhbHNlOwoJICAgICAgICAgICAgICAgIGV2YWx1YXRlSW1tZWRpYXRlKHRydWUgLyogc3VwcHJlc3NDaGFuZ2VOb3RpZmljYXRpb24gKi8pOwoJICAgICAgICAgICAgfQoJICAgICAgICB9CgkgICAgICAgIGRlcGVuZGVudE9ic2VydmFibGUuYWZ0ZXJTdWJzY3JpcHRpb25SZW1vdmUgPSBmdW5jdGlvbiAoKSB7CgkgICAgICAgICAgICBpZiAoIWRlcGVuZGVudE9ic2VydmFibGUuZ2V0U3Vic2NyaXB0aW9uc0NvdW50KCkpIHsKCSAgICAgICAgICAgICAgICBkaXNwb3NlQWxsU3Vic2NyaXB0aW9uc1RvRGVwZW5kZW5jaWVzKCk7CgkgICAgICAgICAgICAgICAgaXNTbGVlcGluZyA9IF9uZWVkc0V2YWx1YXRpb24gPSB0cnVlOwoJICAgICAgICAgICAgfQoJICAgICAgICB9CgkgICAgfSBlbHNlIGlmIChvcHRpb25zWydkZWZlckV2YWx1YXRpb24nXSkgewoJICAgICAgICAvLyBUaGlzIHdpbGwgZm9yY2UgYSBjb21wdXRlZCB3aXRoIGRlZmVyRXZhbHVhdGlvbiB0byBldmFsdWF0ZSB3aGVuIHRoZSBmaXJzdCBzdWJzY3JpcHRpb25zIGlzIHJlZ2lzdGVyZWQuCgkgICAgICAgIGRlcGVuZGVudE9ic2VydmFibGUuYmVmb3JlU3Vic2NyaXB0aW9uQWRkID0gZnVuY3Rpb24gKCkgewoJICAgICAgICAgICAgcGVlaygpOwoJICAgICAgICAgICAgZGVsZXRlIGRlcGVuZGVudE9ic2VydmFibGUuYmVmb3JlU3Vic2NyaXB0aW9uQWRkOwoJICAgICAgICB9CgkgICAgfQoKCSAgICBrby5leHBvcnRQcm9wZXJ0eShkZXBlbmRlbnRPYnNlcnZhYmxlLCAncGVlaycsIGRlcGVuZGVudE9ic2VydmFibGUucGVlayk7CgkgICAga28uZXhwb3J0UHJvcGVydHkoZGVwZW5kZW50T2JzZXJ2YWJsZSwgJ2Rpc3Bvc2UnLCBkZXBlbmRlbnRPYnNlcnZhYmxlLmRpc3Bvc2UpOwoJICAgIGtvLmV4cG9ydFByb3BlcnR5KGRlcGVuZGVudE9ic2VydmFibGUsICdpc0FjdGl2ZScsIGRlcGVuZGVudE9ic2VydmFibGUuaXNBY3RpdmUpOwoJICAgIGtvLmV4cG9ydFByb3BlcnR5KGRlcGVuZGVudE9ic2VydmFibGUsICdnZXREZXBlbmRlbmNpZXNDb3VudCcsIGRlcGVuZGVudE9ic2VydmFibGUuZ2V0RGVwZW5kZW5jaWVzQ291bnQpOwoKCSAgICAvLyBBZGQgYSAiZGlzcG9zZVdoZW4iIGNhbGxiYWNrIHRoYXQsIG9uIGVhY2ggZXZhbHVhdGlvbiwgZGlzcG9zZXMgaWYgdGhlIG5vZGUgd2FzIHJlbW92ZWQgd2l0aG91dCB1c2luZyBrby5yZW1vdmVOb2RlLgoJICAgIGlmIChkaXNwb3NlV2hlbk5vZGVJc1JlbW92ZWQpIHsKCSAgICAgICAgLy8gU2luY2UgdGhpcyBjb21wdXRlZCBpcyBhc3NvY2lhdGVkIHdpdGggYSBET00gbm9kZSwgYW5kIHdlIGRvbid0IHdhbnQgdG8gZGlzcG9zZSB0aGUgY29tcHV0ZWQKCSAgICAgICAgLy8gdW50aWwgdGhlIERPTSBub2RlIGlzICpyZW1vdmVkKiBmcm9tIHRoZSBkb2N1bWVudCAoYXMgb3Bwb3NlZCB0byBuZXZlciBoYXZpbmcgYmVlbiBpbiB0aGUgZG9jdW1lbnQpLAoJICAgICAgICAvLyB3ZSdsbCBwcmV2ZW50IGRpc3Bvc2FsIHVudGlsICJkaXNwb3NlV2hlbiIgZmlyc3QgcmV0dXJucyBmYWxzZS4KCSAgICAgICAgX3N1cHByZXNzRGlzcG9zYWxVbnRpbERpc3Bvc2VXaGVuUmV0dXJuc0ZhbHNlID0gdHJ1ZTsKCgkgICAgICAgIC8vIE9ubHkgd2F0Y2ggZm9yIHRoZSBub2RlJ3MgZGlzcG9zYWwgaWYgdGhlIHZhbHVlIHJlYWxseSBpcyBhIG5vZGUuIEl0IG1pZ2h0IG5vdCBiZSwKCSAgICAgICAgLy8gZS5nLiwgeyBkaXNwb3NlV2hlbk5vZGVJc1JlbW92ZWQ6IHRydWUgfSBjYW4gYmUgdXNlZCB0byBvcHQgaW50byB0aGUgIm9ubHkgZGlzcG9zZQoJICAgICAgICAvLyBhZnRlciBmaXJzdCBmYWxzZSByZXN1bHQiIGJlaGF2aW91ciBldmVuIGlmIHRoZXJlJ3Mgbm8gc3BlY2lmaWMgbm9kZSB0byB3YXRjaC4gVGhpcwoJICAgICAgICAvLyB0ZWNobmlxdWUgaXMgaW50ZW5kZWQgZm9yIEtPJ3MgaW50ZXJuYWwgdXNlIG9ubHkgYW5kIHNob3VsZG4ndCBiZSBkb2N1bWVudGVkIG9yIHVzZWQKCSAgICAgICAgLy8gYnkgYXBwbGljYXRpb24gY29kZSwgYXMgaXQncyBsaWtlbHkgdG8gY2hhbmdlIGluIGEgZnV0dXJlIHZlcnNpb24gb2YgS08uCgkgICAgICAgIGlmIChkaXNwb3NlV2hlbk5vZGVJc1JlbW92ZWQubm9kZVR5cGUpIHsKCSAgICAgICAgICAgIGRpc3Bvc2VXaGVuID0gZnVuY3Rpb24gKCkgewoJICAgICAgICAgICAgICAgIHJldHVybiAha28udXRpbHMuZG9tTm9kZUlzQXR0YWNoZWRUb0RvY3VtZW50KGRpc3Bvc2VXaGVuTm9kZUlzUmVtb3ZlZCkgfHwgKGRpc3Bvc2VXaGVuT3B0aW9uICYmIGRpc3Bvc2VXaGVuT3B0aW9uKCkpOwoJICAgICAgICAgICAgfTsKCSAgICAgICAgfQoJICAgIH0KCgkgICAgLy8gRXZhbHVhdGUsIHVubGVzcyBzbGVlcGluZyBvciBkZWZlckV2YWx1YXRpb24gaXMgdHJ1ZQoJICAgIGlmICghaXNTbGVlcGluZyAmJiAhb3B0aW9uc1snZGVmZXJFdmFsdWF0aW9uJ10pCgkgICAgICAgIGV2YWx1YXRlSW1tZWRpYXRlKCk7CgoJICAgIC8vIEF0dGFjaCBhIERPTSBub2RlIGRpc3Bvc2FsIGNhbGxiYWNrIHNvIHRoYXQgdGhlIGNvbXB1dGVkIHdpbGwgYmUgcHJvYWN0aXZlbHkgZGlzcG9zZWQgYXMgc29vbiBhcyB0aGUgbm9kZSBpcwoJICAgIC8vIHJlbW92ZWQgdXNpbmcga28ucmVtb3ZlTm9kZS4gQnV0IHNraXAgaWYgaXNBY3RpdmUgaXMgZmFsc2UgKHRoZXJlIHdpbGwgbmV2ZXIgYmUgYW55IGRlcGVuZGVuY2llcyB0byBkaXNwb3NlKS4KCSAgICBpZiAoZGlzcG9zZVdoZW5Ob2RlSXNSZW1vdmVkICYmIGlzQWN0aXZlKCkgJiYgZGlzcG9zZVdoZW5Ob2RlSXNSZW1vdmVkLm5vZGVUeXBlKSB7CgkgICAgICAgIGRpc3Bvc2UgPSBmdW5jdGlvbigpIHsKCSAgICAgICAgICAgIGtvLnV0aWxzLmRvbU5vZGVEaXNwb3NhbC5yZW1vdmVEaXNwb3NlQ2FsbGJhY2soZGlzcG9zZVdoZW5Ob2RlSXNSZW1vdmVkLCBkaXNwb3NlKTsKCSAgICAgICAgICAgIGRpc3Bvc2VDb21wdXRlZCgpOwoJICAgICAgICB9OwoJICAgICAgICBrby51dGlscy5kb21Ob2RlRGlzcG9zYWwuYWRkRGlzcG9zZUNhbGxiYWNrKGRpc3Bvc2VXaGVuTm9kZUlzUmVtb3ZlZCwgZGlzcG9zZSk7CgkgICAgfQoKCSAgICByZXR1cm4gZGVwZW5kZW50T2JzZXJ2YWJsZTsKCX07CgoJa28uaXNDb21wdXRlZCA9IGZ1bmN0aW9uKGluc3RhbmNlKSB7CgkgICAgcmV0dXJuIGtvLmhhc1Byb3RvdHlwZShpbnN0YW5jZSwga28uZGVwZW5kZW50T2JzZXJ2YWJsZSk7Cgl9OwoKCXZhciBwcm90b1Byb3AgPSBrby5vYnNlcnZhYmxlLnByb3RvUHJvcGVydHk7IC8vID09ICJfX2tvX3Byb3RvX18iCglrby5kZXBlbmRlbnRPYnNlcnZhYmxlW3Byb3RvUHJvcF0gPSBrby5vYnNlcnZhYmxlOwoKCWtvLmRlcGVuZGVudE9ic2VydmFibGVbJ2ZuJ10gPSB7CgkgICAgImVxdWFsaXR5Q29tcGFyZXIiOiB2YWx1ZXNBcmVQcmltaXRpdmVBbmRFcXVhbAoJfTsKCWtvLmRlcGVuZGVudE9ic2VydmFibGVbJ2ZuJ11bcHJvdG9Qcm9wXSA9IGtvLmRlcGVuZGVudE9ic2VydmFibGU7CgoJLy8gTm90ZSB0aGF0IGZvciBicm93c2VycyB0aGF0IGRvbid0IHN1cHBvcnQgcHJvdG8gYXNzaWdubWVudCwgdGhlCgkvLyBpbmhlcml0YW5jZSBjaGFpbiBpcyBjcmVhdGVkIG1hbnVhbGx5IGluIHRoZSBrby5kZXBlbmRlbnRPYnNlcnZhYmxlIGNvbnN0cnVjdG9yCglpZiAoa28udXRpbHMuY2FuU2V0UHJvdG90eXBlKSB7CgkgICAga28udXRpbHMuc2V0UHJvdG90eXBlT2Yoa28uZGVwZW5kZW50T2JzZXJ2YWJsZVsnZm4nXSwga28uc3Vic2NyaWJhYmxlWydmbiddKTsKCX0KCglrby5leHBvcnRTeW1ib2woJ2RlcGVuZGVudE9ic2VydmFibGUnLCBrby5kZXBlbmRlbnRPYnNlcnZhYmxlKTsKCWtvLmV4cG9ydFN5bWJvbCgnY29tcHV0ZWQnLCBrby5kZXBlbmRlbnRPYnNlcnZhYmxlKTsgLy8gTWFrZSAia28uY29tcHV0ZWQiIGFuIGFsaWFzIGZvciAia28uZGVwZW5kZW50T2JzZXJ2YWJsZSIKCWtvLmV4cG9ydFN5bWJvbCgnaXNDb21wdXRlZCcsIGtvLmlzQ29tcHV0ZWQpOwoKCWtvLnB1cmVDb21wdXRlZCA9IGZ1bmN0aW9uIChldmFsdWF0b3JGdW5jdGlvbk9yT3B0aW9ucywgZXZhbHVhdG9yRnVuY3Rpb25UYXJnZXQpIHsKCSAgICBpZiAodHlwZW9mIGV2YWx1YXRvckZ1bmN0aW9uT3JPcHRpb25zID09PSAnZnVuY3Rpb24nKSB7CgkgICAgICAgIHJldHVybiBrby5jb21wdXRlZChldmFsdWF0b3JGdW5jdGlvbk9yT3B0aW9ucywgZXZhbHVhdG9yRnVuY3Rpb25UYXJnZXQsIHsncHVyZSc6dHJ1ZX0pOwoJICAgIH0gZWxzZSB7CgkgICAgICAgIGV2YWx1YXRvckZ1bmN0aW9uT3JPcHRpb25zID0ga28udXRpbHMuZXh0ZW5kKHt9LCBldmFsdWF0b3JGdW5jdGlvbk9yT3B0aW9ucyk7ICAgLy8gbWFrZSBhIGNvcHkgb2YgdGhlIHBhcmFtZXRlciBvYmplY3QKCSAgICAgICAgZXZhbHVhdG9yRnVuY3Rpb25Pck9wdGlvbnNbJ3B1cmUnXSA9IHRydWU7CgkgICAgICAgIHJldHVybiBrby5jb21wdXRlZChldmFsdWF0b3JGdW5jdGlvbk9yT3B0aW9ucywgZXZhbHVhdG9yRnVuY3Rpb25UYXJnZXQpOwoJICAgIH0KCX0KCWtvLmV4cG9ydFN5bWJvbCgncHVyZUNvbXB1dGVkJywga28ucHVyZUNvbXB1dGVkKTsKCgkoZnVuY3Rpb24oKSB7CgkgICAgdmFyIG1heE5lc3RlZE9ic2VydmFibGVEZXB0aCA9IDEwOyAvLyBFc2NhcGUgdGhlICh1bmxpa2VseSkgcGF0aGFsb2dpY2FsIGNhc2Ugd2hlcmUgYW4gb2JzZXJ2YWJsZSdzIGN1cnJlbnQgdmFsdWUgaXMgaXRzZWxmIChvciBzaW1pbGFyIHJlZmVyZW5jZSBjeWNsZSkKCgkgICAga28udG9KUyA9IGZ1bmN0aW9uKHJvb3RPYmplY3QpIHsKCSAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT0gMCkKCSAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiV2hlbiBjYWxsaW5nIGtvLnRvSlMsIHBhc3MgdGhlIG9iamVjdCB5b3Ugd2FudCB0byBjb252ZXJ0LiIpOwoKCSAgICAgICAgLy8gV2UganVzdCB1bndyYXAgZXZlcnl0aGluZyBhdCBldmVyeSBsZXZlbCBpbiB0aGUgb2JqZWN0IGdyYXBoCgkgICAgICAgIHJldHVybiBtYXBKc09iamVjdEdyYXBoKHJvb3RPYmplY3QsIGZ1bmN0aW9uKHZhbHVlVG9NYXApIHsKCSAgICAgICAgICAgIC8vIExvb3AgYmVjYXVzZSBhbiBvYnNlcnZhYmxlJ3MgdmFsdWUgbWlnaHQgaW4gdHVybiBiZSBhbm90aGVyIG9ic2VydmFibGUgd3JhcHBlcgoJICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGtvLmlzT2JzZXJ2YWJsZSh2YWx1ZVRvTWFwKSAmJiAoaSA8IG1heE5lc3RlZE9ic2VydmFibGVEZXB0aCk7IGkrKykKCSAgICAgICAgICAgICAgICB2YWx1ZVRvTWFwID0gdmFsdWVUb01hcCgpOwoJICAgICAgICAgICAgcmV0dXJuIHZhbHVlVG9NYXA7CgkgICAgICAgIH0pOwoJICAgIH07CgoJICAgIGtvLnRvSlNPTiA9IGZ1bmN0aW9uKHJvb3RPYmplY3QsIHJlcGxhY2VyLCBzcGFjZSkgeyAgICAgLy8gcmVwbGFjZXIgYW5kIHNwYWNlIGFyZSBvcHRpb25hbAoJICAgICAgICB2YXIgcGxhaW5KYXZhU2NyaXB0T2JqZWN0ID0ga28udG9KUyhyb290T2JqZWN0KTsKCSAgICAgICAgcmV0dXJuIGtvLnV0aWxzLnN0cmluZ2lmeUpzb24ocGxhaW5KYXZhU2NyaXB0T2JqZWN0LCByZXBsYWNlciwgc3BhY2UpOwoJICAgIH07CgoJICAgIGZ1bmN0aW9uIG1hcEpzT2JqZWN0R3JhcGgocm9vdE9iamVjdCwgbWFwSW5wdXRDYWxsYmFjaywgdmlzaXRlZE9iamVjdHMpIHsKCSAgICAgICAgdmlzaXRlZE9iamVjdHMgPSB2aXNpdGVkT2JqZWN0cyB8fCBuZXcgb2JqZWN0TG9va3VwKCk7CgoJICAgICAgICByb290T2JqZWN0ID0gbWFwSW5wdXRDYWxsYmFjayhyb290T2JqZWN0KTsKCSAgICAgICAgdmFyIGNhbkhhdmVQcm9wZXJ0aWVzID0gKHR5cGVvZiByb290T2JqZWN0ID09ICJvYmplY3QiKSAmJiAocm9vdE9iamVjdCAhPT0gbnVsbCkgJiYgKHJvb3RPYmplY3QgIT09IHVuZGVmaW5lZCkgJiYgKCEocm9vdE9iamVjdCBpbnN0YW5jZW9mIERhdGUpKSAmJiAoIShyb290T2JqZWN0IGluc3RhbmNlb2YgU3RyaW5nKSkgJiYgKCEocm9vdE9iamVjdCBpbnN0YW5jZW9mIE51bWJlcikpICYmICghKHJvb3RPYmplY3QgaW5zdGFuY2VvZiBCb29sZWFuKSk7CgkgICAgICAgIGlmICghY2FuSGF2ZVByb3BlcnRpZXMpCgkgICAgICAgICAgICByZXR1cm4gcm9vdE9iamVjdDsKCgkgICAgICAgIHZhciBvdXRwdXRQcm9wZXJ0aWVzID0gcm9vdE9iamVjdCBpbnN0YW5jZW9mIEFycmF5ID8gW10gOiB7fTsKCSAgICAgICAgdmlzaXRlZE9iamVjdHMuc2F2ZShyb290T2JqZWN0LCBvdXRwdXRQcm9wZXJ0aWVzKTsKCgkgICAgICAgIHZpc2l0UHJvcGVydGllc09yQXJyYXlFbnRyaWVzKHJvb3RPYmplY3QsIGZ1bmN0aW9uKGluZGV4ZXIpIHsKCSAgICAgICAgICAgIHZhciBwcm9wZXJ0eVZhbHVlID0gbWFwSW5wdXRDYWxsYmFjayhyb290T2JqZWN0W2luZGV4ZXJdKTsKCgkgICAgICAgICAgICBzd2l0Y2ggKHR5cGVvZiBwcm9wZXJ0eVZhbHVlKSB7CgkgICAgICAgICAgICAgICAgY2FzZSAiYm9vbGVhbiI6CgkgICAgICAgICAgICAgICAgY2FzZSAibnVtYmVyIjoKCSAgICAgICAgICAgICAgICBjYXNlICJzdHJpbmciOgoJICAgICAgICAgICAgICAgIGNhc2UgImZ1bmN0aW9uIjoKCSAgICAgICAgICAgICAgICAgICAgb3V0cHV0UHJvcGVydGllc1tpbmRleGVyXSA9IHByb3BlcnR5VmFsdWU7CgkgICAgICAgICAgICAgICAgICAgIGJyZWFrOwoJICAgICAgICAgICAgICAgIGNhc2UgIm9iamVjdCI6CgkgICAgICAgICAgICAgICAgY2FzZSAidW5kZWZpbmVkIjoKCSAgICAgICAgICAgICAgICAgICAgdmFyIHByZXZpb3VzbHlNYXBwZWRWYWx1ZSA9IHZpc2l0ZWRPYmplY3RzLmdldChwcm9wZXJ0eVZhbHVlKTsKCSAgICAgICAgICAgICAgICAgICAgb3V0cHV0UHJvcGVydGllc1tpbmRleGVyXSA9IChwcmV2aW91c2x5TWFwcGVkVmFsdWUgIT09IHVuZGVmaW5lZCkKCSAgICAgICAgICAgICAgICAgICAgICAgID8gcHJldmlvdXNseU1hcHBlZFZhbHVlCgkgICAgICAgICAgICAgICAgICAgICAgICA6IG1hcEpzT2JqZWN0R3JhcGgocHJvcGVydHlWYWx1ZSwgbWFwSW5wdXRDYWxsYmFjaywgdmlzaXRlZE9iamVjdHMpOwoJICAgICAgICAgICAgICAgICAgICBicmVhazsKCSAgICAgICAgICAgIH0KCSAgICAgICAgfSk7CgoJICAgICAgICByZXR1cm4gb3V0cHV0UHJvcGVydGllczsKCSAgICB9CgoJICAgIGZ1bmN0aW9uIHZpc2l0UHJvcGVydGllc09yQXJyYXlFbnRyaWVzKHJvb3RPYmplY3QsIHZpc2l0b3JDYWxsYmFjaykgewoJICAgICAgICBpZiAocm9vdE9iamVjdCBpbnN0YW5jZW9mIEFycmF5KSB7CgkgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJvb3RPYmplY3QubGVuZ3RoOyBpKyspCgkgICAgICAgICAgICAgICAgdmlzaXRvckNhbGxiYWNrKGkpOwoKCSAgICAgICAgICAgIC8vIEZvciBhcnJheXMsIGFsc28gcmVzcGVjdCB0b0pTT04gcHJvcGVydHkgZm9yIGN1c3RvbSBtYXBwaW5ncyAoZml4ZXMgIzI3OCkKCSAgICAgICAgICAgIGlmICh0eXBlb2Ygcm9vdE9iamVjdFsndG9KU09OJ10gPT0gJ2Z1bmN0aW9uJykKCSAgICAgICAgICAgICAgICB2aXNpdG9yQ2FsbGJhY2soJ3RvSlNPTicpOwoJICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgZm9yICh2YXIgcHJvcGVydHlOYW1lIGluIHJvb3RPYmplY3QpIHsKCSAgICAgICAgICAgICAgICB2aXNpdG9yQ2FsbGJhY2socHJvcGVydHlOYW1lKTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgfQoJICAgIH07CgoJICAgIGZ1bmN0aW9uIG9iamVjdExvb2t1cCgpIHsKCSAgICAgICAgdGhpcy5rZXlzID0gW107CgkgICAgICAgIHRoaXMudmFsdWVzID0gW107CgkgICAgfTsKCgkgICAgb2JqZWN0TG9va3VwLnByb3RvdHlwZSA9IHsKCSAgICAgICAgY29uc3RydWN0b3I6IG9iamVjdExvb2t1cCwKCSAgICAgICAgc2F2ZTogZnVuY3Rpb24oa2V5LCB2YWx1ZSkgewoJICAgICAgICAgICAgdmFyIGV4aXN0aW5nSW5kZXggPSBrby51dGlscy5hcnJheUluZGV4T2YodGhpcy5rZXlzLCBrZXkpOwoJICAgICAgICAgICAgaWYgKGV4aXN0aW5nSW5kZXggPj0gMCkKCSAgICAgICAgICAgICAgICB0aGlzLnZhbHVlc1tleGlzdGluZ0luZGV4XSA9IHZhbHVlOwoJICAgICAgICAgICAgZWxzZSB7CgkgICAgICAgICAgICAgICAgdGhpcy5rZXlzLnB1c2goa2V5KTsKCSAgICAgICAgICAgICAgICB0aGlzLnZhbHVlcy5wdXNoKHZhbHVlKTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgfSwKCSAgICAgICAgZ2V0OiBmdW5jdGlvbihrZXkpIHsKCSAgICAgICAgICAgIHZhciBleGlzdGluZ0luZGV4ID0ga28udXRpbHMuYXJyYXlJbmRleE9mKHRoaXMua2V5cywga2V5KTsKCSAgICAgICAgICAgIHJldHVybiAoZXhpc3RpbmdJbmRleCA+PSAwKSA/IHRoaXMudmFsdWVzW2V4aXN0aW5nSW5kZXhdIDogdW5kZWZpbmVkOwoJICAgICAgICB9CgkgICAgfTsKCX0pKCk7CgoJa28uZXhwb3J0U3ltYm9sKCd0b0pTJywga28udG9KUyk7Cglrby5leHBvcnRTeW1ib2woJ3RvSlNPTicsIGtvLnRvSlNPTik7CgkoZnVuY3Rpb24gKCkgewoJICAgIHZhciBoYXNEb21EYXRhRXhwYW5kb1Byb3BlcnR5ID0gJ19fa29fX2hhc0RvbURhdGFPcHRpb25WYWx1ZV9fJzsKCgkgICAgLy8gTm9ybWFsbHksIFNFTEVDVCBlbGVtZW50cyBhbmQgdGhlaXIgT1BUSU9OcyBjYW4gb25seSB0YWtlIHZhbHVlIG9mIHR5cGUgJ3N0cmluZycgKGJlY2F1c2UgdGhlIHZhbHVlcwoJICAgIC8vIGFyZSBzdG9yZWQgb24gRE9NIGF0dHJpYnV0ZXMpLiBrby5zZWxlY3RFeHRlbnNpb25zIHByb3ZpZGVzIGEgd2F5IGZvciBTRUxFQ1RzL09QVElPTnMgdG8gaGF2ZSB2YWx1ZXMKCSAgICAvLyB0aGF0IGFyZSBhcmJpdHJhcnkgb2JqZWN0cy4gVGhpcyBpcyB2ZXJ5IGNvbnZlbmllbnQgd2hlbiBpbXBsZW1lbnRpbmcgdGhpbmdzIGxpa2UgY2FzY2FkaW5nIGRyb3Bkb3ducy4KCSAgICBrby5zZWxlY3RFeHRlbnNpb25zID0gewoJICAgICAgICByZWFkVmFsdWUgOiBmdW5jdGlvbihlbGVtZW50KSB7CgkgICAgICAgICAgICBzd2l0Y2ggKGtvLnV0aWxzLnRhZ05hbWVMb3dlcihlbGVtZW50KSkgewoJICAgICAgICAgICAgICAgIGNhc2UgJ29wdGlvbic6CgkgICAgICAgICAgICAgICAgICAgIGlmIChlbGVtZW50W2hhc0RvbURhdGFFeHBhbmRvUHJvcGVydHldID09PSB0cnVlKQoJICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGtvLnV0aWxzLmRvbURhdGEuZ2V0KGVsZW1lbnQsIGtvLmJpbmRpbmdIYW5kbGVycy5vcHRpb25zLm9wdGlvblZhbHVlRG9tRGF0YUtleSk7CgkgICAgICAgICAgICAgICAgICAgIHJldHVybiBrby51dGlscy5pZVZlcnNpb24gPD0gNwoJICAgICAgICAgICAgICAgICAgICAgICAgPyAoZWxlbWVudC5nZXRBdHRyaWJ1dGVOb2RlKCd2YWx1ZScpICYmIGVsZW1lbnQuZ2V0QXR0cmlidXRlTm9kZSgndmFsdWUnKS5zcGVjaWZpZWQgPyBlbGVtZW50LnZhbHVlIDogZWxlbWVudC50ZXh0KQoJICAgICAgICAgICAgICAgICAgICAgICAgOiBlbGVtZW50LnZhbHVlOwoJICAgICAgICAgICAgICAgIGNhc2UgJ3NlbGVjdCc6CgkgICAgICAgICAgICAgICAgICAgIHJldHVybiBlbGVtZW50LnNlbGVjdGVkSW5kZXggPj0gMCA/IGtvLnNlbGVjdEV4dGVuc2lvbnMucmVhZFZhbHVlKGVsZW1lbnQub3B0aW9uc1tlbGVtZW50LnNlbGVjdGVkSW5kZXhdKSA6IHVuZGVmaW5lZDsKCSAgICAgICAgICAgICAgICBkZWZhdWx0OgoJICAgICAgICAgICAgICAgICAgICByZXR1cm4gZWxlbWVudC52YWx1ZTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgfSwKCgkgICAgICAgIHdyaXRlVmFsdWU6IGZ1bmN0aW9uKGVsZW1lbnQsIHZhbHVlLCBhbGxvd1Vuc2V0KSB7CgkgICAgICAgICAgICBzd2l0Y2ggKGtvLnV0aWxzLnRhZ05hbWVMb3dlcihlbGVtZW50KSkgewoJICAgICAgICAgICAgICAgIGNhc2UgJ29wdGlvbic6CgkgICAgICAgICAgICAgICAgICAgIHN3aXRjaCh0eXBlb2YgdmFsdWUpIHsKCSAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgInN0cmluZyI6CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAga28udXRpbHMuZG9tRGF0YS5zZXQoZWxlbWVudCwga28uYmluZGluZ0hhbmRsZXJzLm9wdGlvbnMub3B0aW9uVmFsdWVEb21EYXRhS2V5LCB1bmRlZmluZWQpOwoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChoYXNEb21EYXRhRXhwYW5kb1Byb3BlcnR5IGluIGVsZW1lbnQpIHsgLy8gSUUgPD0gOCB0aHJvd3MgZXJyb3JzIGlmIHlvdSBkZWxldGUgbm9uLWV4aXN0ZW50IHByb3BlcnRpZXMgZnJvbSBhIERPTSBub2RlCgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBlbGVtZW50W2hhc0RvbURhdGFFeHBhbmRvUHJvcGVydHldOwoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50LnZhbHVlID0gdmFsdWU7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CgkgICAgICAgICAgICAgICAgICAgICAgICBkZWZhdWx0OgoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFN0b3JlIGFyYml0cmFyeSBvYmplY3QgdXNpbmcgRG9tRGF0YQoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIGtvLnV0aWxzLmRvbURhdGEuc2V0KGVsZW1lbnQsIGtvLmJpbmRpbmdIYW5kbGVycy5vcHRpb25zLm9wdGlvblZhbHVlRG9tRGF0YUtleSwgdmFsdWUpOwoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnRbaGFzRG9tRGF0YUV4cGFuZG9Qcm9wZXJ0eV0gPSB0cnVlOwoKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBTcGVjaWFsIHRyZWF0bWVudCBvZiBudW1iZXJzIGlzIGp1c3QgZm9yIGJhY2t3YXJkIGNvbXBhdGliaWxpdHkuIEtPIDEuMi4xIHdyb3RlIG51bWVyaWNhbCB2YWx1ZXMgdG8gZWxlbWVudC52YWx1ZS4KCSAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50LnZhbHVlID0gdHlwZW9mIHZhbHVlID09PSAibnVtYmVyIiA/IHZhbHVlIDogIiI7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CgkgICAgICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICAgICAgYnJlYWs7CgkgICAgICAgICAgICAgICAgY2FzZSAnc2VsZWN0JzoKCSAgICAgICAgICAgICAgICAgICAgaWYgKHZhbHVlID09PSAiIiB8fCB2YWx1ZSA9PT0gbnVsbCkgICAgICAgLy8gQSBibGFuayBzdHJpbmcgb3IgbnVsbCB2YWx1ZSB3aWxsIHNlbGVjdCB0aGUgY2FwdGlvbgoJICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSB1bmRlZmluZWQ7CgkgICAgICAgICAgICAgICAgICAgIHZhciBzZWxlY3Rpb24gPSAtMTsKCSAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIG4gPSBlbGVtZW50Lm9wdGlvbnMubGVuZ3RoLCBvcHRpb25WYWx1ZTsgaSA8IG47ICsraSkgewoJICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9uVmFsdWUgPSBrby5zZWxlY3RFeHRlbnNpb25zLnJlYWRWYWx1ZShlbGVtZW50Lm9wdGlvbnNbaV0pOwoJICAgICAgICAgICAgICAgICAgICAgICAgLy8gSW5jbHVkZSBzcGVjaWFsIGNoZWNrIHRvIGhhbmRsZSBzZWxlY3RpbmcgYSBjYXB0aW9uIHdpdGggYSBibGFuayBzdHJpbmcgdmFsdWUKCSAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvcHRpb25WYWx1ZSA9PSB2YWx1ZSB8fCAob3B0aW9uVmFsdWUgPT0gIiIgJiYgdmFsdWUgPT09IHVuZGVmaW5lZCkpIHsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3Rpb24gPSBpOwoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwoJICAgICAgICAgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgICAgIGlmIChhbGxvd1Vuc2V0IHx8IHNlbGVjdGlvbiA+PSAwIHx8ICh2YWx1ZSA9PT0gdW5kZWZpbmVkICYmIGVsZW1lbnQuc2l6ZSA+IDEpKSB7CgkgICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50LnNlbGVjdGVkSW5kZXggPSBzZWxlY3Rpb247CgkgICAgICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICAgICAgYnJlYWs7CgkgICAgICAgICAgICAgICAgZGVmYXVsdDoKCSAgICAgICAgICAgICAgICAgICAgaWYgKCh2YWx1ZSA9PT0gbnVsbCkgfHwgKHZhbHVlID09PSB1bmRlZmluZWQpKQoJICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSAiIjsKCSAgICAgICAgICAgICAgICAgICAgZWxlbWVudC52YWx1ZSA9IHZhbHVlOwoJICAgICAgICAgICAgICAgICAgICBicmVhazsKCSAgICAgICAgICAgIH0KCSAgICAgICAgfQoJICAgIH07Cgl9KSgpOwoKCWtvLmV4cG9ydFN5bWJvbCgnc2VsZWN0RXh0ZW5zaW9ucycsIGtvLnNlbGVjdEV4dGVuc2lvbnMpOwoJa28uZXhwb3J0U3ltYm9sKCdzZWxlY3RFeHRlbnNpb25zLnJlYWRWYWx1ZScsIGtvLnNlbGVjdEV4dGVuc2lvbnMucmVhZFZhbHVlKTsKCWtvLmV4cG9ydFN5bWJvbCgnc2VsZWN0RXh0ZW5zaW9ucy53cml0ZVZhbHVlJywga28uc2VsZWN0RXh0ZW5zaW9ucy53cml0ZVZhbHVlKTsKCWtvLmV4cHJlc3Npb25SZXdyaXRpbmcgPSAoZnVuY3Rpb24gKCkgewoJICAgIHZhciBqYXZhU2NyaXB0UmVzZXJ2ZWRXb3JkcyA9IFsidHJ1ZSIsICJmYWxzZSIsICJudWxsIiwgInVuZGVmaW5lZCJdOwoKCSAgICAvLyBNYXRjaGVzIHNvbWV0aGluZyB0aGF0IGNhbiBiZSBhc3NpZ25lZCB0by0tZWl0aGVyIGFuIGlzb2xhdGVkIGlkZW50aWZpZXIgb3Igc29tZXRoaW5nIGVuZGluZyB3aXRoIGEgcHJvcGVydHkgYWNjZXNzb3IKCSAgICAvLyBUaGlzIGlzIGRlc2lnbmVkIHRvIGJlIHNpbXBsZSBhbmQgYXZvaWQgZmFsc2UgbmVnYXRpdmVzLCBidXQgY291bGQgcHJvZHVjZSBmYWxzZSBwb3NpdGl2ZXMgKGUuZy4sIGErYi5jKS4KCSAgICAvLyBUaGlzIGFsc28gd2lsbCBub3QgcHJvcGVybHkgaGFuZGxlIG5lc3RlZCBicmFja2V0cyAoZS5nLiwgb2JqMVtvYmoyWydwcm9wJ11dOyBzZWUgIzkxMSkuCgkgICAgdmFyIGphdmFTY3JpcHRBc3NpZ25tZW50VGFyZ2V0ID0gL14oPzpbJF9hLXpdWyRcd10qfCguKykoXC5ccypbJF9hLXpdWyRcd10qfFxbLitcXSkpJC9pOwoKCSAgICBmdW5jdGlvbiBnZXRXcml0ZWFibGVWYWx1ZShleHByZXNzaW9uKSB7CgkgICAgICAgIGlmIChrby51dGlscy5hcnJheUluZGV4T2YoamF2YVNjcmlwdFJlc2VydmVkV29yZHMsIGV4cHJlc3Npb24pID49IDApCgkgICAgICAgICAgICByZXR1cm4gZmFsc2U7CgkgICAgICAgIHZhciBtYXRjaCA9IGV4cHJlc3Npb24ubWF0Y2goamF2YVNjcmlwdEFzc2lnbm1lbnRUYXJnZXQpOwoJICAgICAgICByZXR1cm4gbWF0Y2ggPT09IG51bGwgPyBmYWxzZSA6IG1hdGNoWzFdID8gKCdPYmplY3QoJyArIG1hdGNoWzFdICsgJyknICsgbWF0Y2hbMl0pIDogZXhwcmVzc2lvbjsKCSAgICB9CgoJICAgIC8vIFRoZSBmb2xsb3dpbmcgcmVndWxhciBleHByZXNzaW9ucyB3aWxsIGJlIHVzZWQgdG8gc3BsaXQgYW4gb2JqZWN0LWxpdGVyYWwgc3RyaW5nIGludG8gdG9rZW5zCgoJICAgICAgICAvLyBUaGVzZSB0d28gbWF0Y2ggc3RyaW5ncywgZWl0aGVyIHdpdGggZG91YmxlIHF1b3RlcyBvciBzaW5nbGUgcXVvdGVzCgkgICAgdmFyIHN0cmluZ0RvdWJsZSA9ICciKD86W14iXFxcXF18XFxcXC4pKiInLAoJICAgICAgICBzdHJpbmdTaW5nbGUgPSAiJyg/OlteJ1xcXFxdfFxcXFwuKSonIiwKCSAgICAgICAgLy8gTWF0Y2hlcyBhIHJlZ3VsYXIgZXhwcmVzc2lvbiAodGV4dCBlbmNsb3NlZCBieSBzbGFzaGVzKSwgYnV0IHdpbGwgYWxzbyBtYXRjaCBzZXRzIG9mIGRpdmlzaW9ucwoJICAgICAgICAvLyBhcyBhIHJlZ3VsYXIgZXhwcmVzc2lvbiAodGhpcyBpcyBoYW5kbGVkIGJ5IHRoZSBwYXJzaW5nIGxvb3AgYmVsb3cpLgoJICAgICAgICBzdHJpbmdSZWdleHAgPSAnLyg/OlteL1xcXFxdfFxcXFwuKSovXHcqJywKCSAgICAgICAgLy8gVGhlc2UgY2hhcmFjdGVycyBoYXZlIHNwZWNpYWwgbWVhbmluZyB0byB0aGUgcGFyc2VyIGFuZCBtdXN0IG5vdCBhcHBlYXIgaW4gdGhlIG1pZGRsZSBvZiBhCgkgICAgICAgIC8vIHRva2VuLCBleGNlcHQgYXMgcGFydCBvZiBhIHN0cmluZy4KCSAgICAgICAgc3BlY2lhbHMgPSAnLCJcJ3t9KCkvOltcXF0nLAoJICAgICAgICAvLyBNYXRjaCB0ZXh0IChhdCBsZWFzdCB0d28gY2hhcmFjdGVycykgdGhhdCBkb2VzIG5vdCBjb250YWluIGFueSBvZiB0aGUgYWJvdmUgc3BlY2lhbCBjaGFyYWN0ZXJzLAoJICAgICAgICAvLyBhbHRob3VnaCBzb21lIG9mIHRoZSBzcGVjaWFsIGNoYXJhY3RlcnMgYXJlIGFsbG93ZWQgdG8gc3RhcnQgaXQgKGFsbCBidXQgdGhlIGNvbG9uIGFuZCBjb21tYSkuCgkgICAgICAgIC8vIFRoZSB0ZXh0IGNhbiBjb250YWluIHNwYWNlcywgYnV0IGxlYWRpbmcgb3IgdHJhaWxpbmcgc3BhY2VzIGFyZSBza2lwcGVkLgoJICAgICAgICBldmVyeVRoaW5nRWxzZSA9ICdbXlxcczosL11bXicgKyBzcGVjaWFscyArICddKlteXFxzJyArIHNwZWNpYWxzICsgJ10nLAoJICAgICAgICAvLyBNYXRjaCBhbnkgbm9uLXNwYWNlIGNoYXJhY3RlciBub3QgbWF0Y2hlZCBhbHJlYWR5LiBUaGlzIHdpbGwgbWF0Y2ggY29sb25zIGFuZCBjb21tYXMsIHNpbmNlIHRoZXkncmUKCSAgICAgICAgLy8gbm90IG1hdGNoZWQgYnkgImV2ZXJ5VGhpbmdFbHNlIiwgYnV0IHdpbGwgYWxzbyBtYXRjaCBhbnkgb3RoZXIgc2luZ2xlIGNoYXJhY3RlciB0aGF0IHdhc24ndCBhbHJlYWR5CgkgICAgICAgIC8vIG1hdGNoZWQgKGZvciBleGFtcGxlOiBpbiAiYTogMSwgYjogMiIsIGVhY2ggb2YgdGhlIG5vbi1zcGFjZSBjaGFyYWN0ZXJzIHdpbGwgYmUgbWF0Y2hlZCBieSBvbmVOb3RTcGFjZSkuCgkgICAgICAgIG9uZU5vdFNwYWNlID0gJ1teXFxzXScsCgoJICAgICAgICAvLyBDcmVhdGUgdGhlIGFjdHVhbCByZWd1bGFyIGV4cHJlc3Npb24gYnkgb3ItaW5nIHRoZSBhYm92ZSBzdHJpbmdzLiBUaGUgb3JkZXIgaXMgaW1wb3J0YW50LgoJICAgICAgICBiaW5kaW5nVG9rZW4gPSBSZWdFeHAoc3RyaW5nRG91YmxlICsgJ3wnICsgc3RyaW5nU2luZ2xlICsgJ3wnICsgc3RyaW5nUmVnZXhwICsgJ3wnICsgZXZlcnlUaGluZ0Vsc2UgKyAnfCcgKyBvbmVOb3RTcGFjZSwgJ2cnKSwKCgkgICAgICAgIC8vIE1hdGNoIGVuZCBvZiBwcmV2aW91cyB0b2tlbiB0byBkZXRlcm1pbmUgd2hldGhlciBhIHNsYXNoIGlzIGEgZGl2aXNpb24gb3IgcmVnZXguCgkgICAgICAgIGRpdmlzaW9uTG9va0JlaGluZCA9IC9bXF0pIidBLVphLXowLTlfJF0rJC8sCgkgICAgICAgIGtleXdvcmRSZWdleExvb2tCZWhpbmQgPSB7J2luJzoxLCdyZXR1cm4nOjEsJ3R5cGVvZic6MX07CgoJICAgIGZ1bmN0aW9uIHBhcnNlT2JqZWN0TGl0ZXJhbChvYmplY3RMaXRlcmFsU3RyaW5nKSB7CgkgICAgICAgIC8vIFRyaW0gbGVhZGluZyBhbmQgdHJhaWxpbmcgc3BhY2VzIGZyb20gdGhlIHN0cmluZwoJICAgICAgICB2YXIgc3RyID0ga28udXRpbHMuc3RyaW5nVHJpbShvYmplY3RMaXRlcmFsU3RyaW5nKTsKCgkgICAgICAgIC8vIFRyaW0gYnJhY2VzICd7JyBzdXJyb3VuZGluZyB0aGUgd2hvbGUgb2JqZWN0IGxpdGVyYWwKCSAgICAgICAgaWYgKHN0ci5jaGFyQ29kZUF0KDApID09PSAxMjMpIHN0ciA9IHN0ci5zbGljZSgxLCAtMSk7CgoJICAgICAgICAvLyBTcGxpdCBpbnRvIHRva2VucwoJICAgICAgICB2YXIgcmVzdWx0ID0gW10sIHRva3MgPSBzdHIubWF0Y2goYmluZGluZ1Rva2VuKSwga2V5LCB2YWx1ZXMsIGRlcHRoID0gMDsKCgkgICAgICAgIGlmICh0b2tzKSB7CgkgICAgICAgICAgICAvLyBBcHBlbmQgYSBjb21tYSBzbyB0aGF0IHdlIGRvbid0IG5lZWQgYSBzZXBhcmF0ZSBjb2RlIGJsb2NrIHRvIGRlYWwgd2l0aCB0aGUgbGFzdCBpdGVtCgkgICAgICAgICAgICB0b2tzLnB1c2goJywnKTsKCgkgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgdG9rOyB0b2sgPSB0b2tzW2ldOyArK2kpIHsKCSAgICAgICAgICAgICAgICB2YXIgYyA9IHRvay5jaGFyQ29kZUF0KDApOwoJICAgICAgICAgICAgICAgIC8vIEEgY29tbWEgc2lnbmFscyB0aGUgZW5kIG9mIGEga2V5L3ZhbHVlIHBhaXIgaWYgZGVwdGggaXMgemVybwoJICAgICAgICAgICAgICAgIGlmIChjID09PSA0NCkgeyAvLyAiLCIKCSAgICAgICAgICAgICAgICAgICAgaWYgKGRlcHRoIDw9IDApIHsKCSAgICAgICAgICAgICAgICAgICAgICAgIGlmIChrZXkpCgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0LnB1c2godmFsdWVzID8ge2tleToga2V5LCB2YWx1ZTogdmFsdWVzLmpvaW4oJycpfSA6IHsndW5rbm93bic6IGtleX0pOwoJICAgICAgICAgICAgICAgICAgICAgICAga2V5ID0gdmFsdWVzID0gZGVwdGggPSAwOwoJICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7CgkgICAgICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICAvLyBTaW1wbHkgc2tpcCB0aGUgY29sb24gdGhhdCBzZXBhcmF0ZXMgdGhlIG5hbWUgYW5kIHZhbHVlCgkgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChjID09PSA1OCkgeyAvLyAiOiIKCSAgICAgICAgICAgICAgICAgICAgaWYgKCF2YWx1ZXMpCgkgICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKCSAgICAgICAgICAgICAgICAvLyBBIHNldCBvZiBzbGFzaGVzIGlzIGluaXRpYWxseSBtYXRjaGVkIGFzIGEgcmVndWxhciBleHByZXNzaW9uLCBidXQgY291bGQgYmUgZGl2aXNpb24KCSAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGMgPT09IDQ3ICYmIGkgJiYgdG9rLmxlbmd0aCA+IDEpIHsgIC8vICIvIgoJICAgICAgICAgICAgICAgICAgICAvLyBMb29rIGF0IHRoZSBlbmQgb2YgdGhlIHByZXZpb3VzIHRva2VuIHRvIGRldGVybWluZSBpZiB0aGUgc2xhc2ggaXMgYWN0dWFsbHkgZGl2aXNpb24KCSAgICAgICAgICAgICAgICAgICAgdmFyIG1hdGNoID0gdG9rc1tpLTFdLm1hdGNoKGRpdmlzaW9uTG9va0JlaGluZCk7CgkgICAgICAgICAgICAgICAgICAgIGlmIChtYXRjaCAmJiAha2V5d29yZFJlZ2V4TG9va0JlaGluZFttYXRjaFswXV0pIHsKCSAgICAgICAgICAgICAgICAgICAgICAgIC8vIFRoZSBzbGFzaCBpcyBhY3R1YWxseSBhIGRpdmlzaW9uIHB1bmN0dWF0b3I7IHJlLXBhcnNlIHRoZSByZW1haW5kZXIgb2YgdGhlIHN0cmluZyAobm90IGluY2x1ZGluZyB0aGUgc2xhc2gpCgkgICAgICAgICAgICAgICAgICAgICAgICBzdHIgPSBzdHIuc3Vic3RyKHN0ci5pbmRleE9mKHRvaykgKyAxKTsKCSAgICAgICAgICAgICAgICAgICAgICAgIHRva3MgPSBzdHIubWF0Y2goYmluZGluZ1Rva2VuKTsKCSAgICAgICAgICAgICAgICAgICAgICAgIHRva3MucHVzaCgnLCcpOwoJICAgICAgICAgICAgICAgICAgICAgICAgaSA9IC0xOwoJICAgICAgICAgICAgICAgICAgICAgICAgLy8gQ29udGludWUgd2l0aCBqdXN0IHRoZSBzbGFzaAoJICAgICAgICAgICAgICAgICAgICAgICAgdG9rID0gJy8nOwoJICAgICAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgLy8gSW5jcmVtZW50IGRlcHRoIGZvciBwYXJlbnRoZXNlcywgYnJhY2VzLCBhbmQgYnJhY2tldHMgc28gdGhhdCBpbnRlcmlvciBjb21tYXMgYXJlIGlnbm9yZWQKCSAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGMgPT09IDQwIHx8IGMgPT09IDEyMyB8fCBjID09PSA5MSkgeyAvLyAnKCcsICd7JywgJ1snCgkgICAgICAgICAgICAgICAgICAgICsrZGVwdGg7CgkgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChjID09PSA0MSB8fCBjID09PSAxMjUgfHwgYyA9PT0gOTMpIHsgLy8gJyknLCAnfScsICddJwoJICAgICAgICAgICAgICAgICAgICAtLWRlcHRoOwoJICAgICAgICAgICAgICAgIC8vIFRoZSBrZXkgbXVzdCBiZSBhIHNpbmdsZSB0b2tlbjsgaWYgaXQncyBhIHN0cmluZywgdHJpbSB0aGUgcXVvdGVzCgkgICAgICAgICAgICAgICAgfSBlbHNlIGlmICgha2V5ICYmICF2YWx1ZXMpIHsKCSAgICAgICAgICAgICAgICAgICAga2V5ID0gKGMgPT09IDM0IHx8IGMgPT09IDM5KSAvKiAnIicsICInIiAqLyA/IHRvay5zbGljZSgxLCAtMSkgOiB0b2s7CgkgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICBpZiAodmFsdWVzKQoJICAgICAgICAgICAgICAgICAgICB2YWx1ZXMucHVzaCh0b2spOwoJICAgICAgICAgICAgICAgIGVsc2UKCSAgICAgICAgICAgICAgICAgICAgdmFsdWVzID0gW3Rva107CgkgICAgICAgICAgICB9CgkgICAgICAgIH0KCSAgICAgICAgcmV0dXJuIHJlc3VsdDsKCSAgICB9CgoJICAgIC8vIFR3by13YXkgYmluZGluZ3MgaW5jbHVkZSBhIHdyaXRlIGZ1bmN0aW9uIHRoYXQgYWxsb3cgdGhlIGhhbmRsZXIgdG8gdXBkYXRlIHRoZSB2YWx1ZSBldmVuIGlmIGl0J3Mgbm90IGFuIG9ic2VydmFibGUuCgkgICAgdmFyIHR3b1dheUJpbmRpbmdzID0ge307CgoJICAgIGZ1bmN0aW9uIHByZVByb2Nlc3NCaW5kaW5ncyhiaW5kaW5nc1N0cmluZ09yS2V5VmFsdWVBcnJheSwgYmluZGluZ09wdGlvbnMpIHsKCSAgICAgICAgYmluZGluZ09wdGlvbnMgPSBiaW5kaW5nT3B0aW9ucyB8fCB7fTsKCgkgICAgICAgIGZ1bmN0aW9uIHByb2Nlc3NLZXlWYWx1ZShrZXksIHZhbCkgewoJICAgICAgICAgICAgdmFyIHdyaXRhYmxlVmFsOwoJICAgICAgICAgICAgZnVuY3Rpb24gY2FsbFByZXByb2Nlc3NIb29rKG9iaikgewoJICAgICAgICAgICAgICAgIHJldHVybiAob2JqICYmIG9ialsncHJlcHJvY2VzcyddKSA/ICh2YWwgPSBvYmpbJ3ByZXByb2Nlc3MnXSh2YWwsIGtleSwgcHJvY2Vzc0tleVZhbHVlKSkgOiB0cnVlOwoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgaWYgKCFiaW5kaW5nUGFyYW1zKSB7CgkgICAgICAgICAgICAgICAgaWYgKCFjYWxsUHJlcHJvY2Vzc0hvb2soa29bJ2dldEJpbmRpbmdIYW5kbGVyJ10oa2V5KSkpCgkgICAgICAgICAgICAgICAgICAgIHJldHVybjsKCgkgICAgICAgICAgICAgICAgaWYgKHR3b1dheUJpbmRpbmdzW2tleV0gJiYgKHdyaXRhYmxlVmFsID0gZ2V0V3JpdGVhYmxlVmFsdWUodmFsKSkpIHsKCSAgICAgICAgICAgICAgICAgICAgLy8gRm9yIHR3by13YXkgYmluZGluZ3MsIHByb3ZpZGUgYSB3cml0ZSBtZXRob2QgaW4gY2FzZSB0aGUgdmFsdWUKCSAgICAgICAgICAgICAgICAgICAgLy8gaXNuJ3QgYSB3cml0YWJsZSBvYnNlcnZhYmxlLgoJICAgICAgICAgICAgICAgICAgICBwcm9wZXJ0eUFjY2Vzc29yUmVzdWx0U3RyaW5ncy5wdXNoKCInIiArIGtleSArICInOmZ1bmN0aW9uKF96KXsiICsgd3JpdGFibGVWYWwgKyAiPV96fSIpOwoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIC8vIFZhbHVlcyBhcmUgd3JhcHBlZCBpbiBhIGZ1bmN0aW9uIHNvIHRoYXQgZWFjaCB2YWx1ZSBjYW4gYmUgYWNjZXNzZWQgaW5kZXBlbmRlbnRseQoJICAgICAgICAgICAgaWYgKG1ha2VWYWx1ZUFjY2Vzc29ycykgewoJICAgICAgICAgICAgICAgIHZhbCA9ICdmdW5jdGlvbigpe3JldHVybiAnICsgdmFsICsgJyB9JzsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIHJlc3VsdFN0cmluZ3MucHVzaCgiJyIgKyBrZXkgKyAiJzoiICsgdmFsKTsKCSAgICAgICAgfQoKCSAgICAgICAgdmFyIHJlc3VsdFN0cmluZ3MgPSBbXSwKCSAgICAgICAgICAgIHByb3BlcnR5QWNjZXNzb3JSZXN1bHRTdHJpbmdzID0gW10sCgkgICAgICAgICAgICBtYWtlVmFsdWVBY2Nlc3NvcnMgPSBiaW5kaW5nT3B0aW9uc1sndmFsdWVBY2Nlc3NvcnMnXSwKCSAgICAgICAgICAgIGJpbmRpbmdQYXJhbXMgPSBiaW5kaW5nT3B0aW9uc1snYmluZGluZ1BhcmFtcyddLAoJICAgICAgICAgICAga2V5VmFsdWVBcnJheSA9IHR5cGVvZiBiaW5kaW5nc1N0cmluZ09yS2V5VmFsdWVBcnJheSA9PT0gInN0cmluZyIgPwoJICAgICAgICAgICAgICAgIHBhcnNlT2JqZWN0TGl0ZXJhbChiaW5kaW5nc1N0cmluZ09yS2V5VmFsdWVBcnJheSkgOiBiaW5kaW5nc1N0cmluZ09yS2V5VmFsdWVBcnJheTsKCgkgICAgICAgIGtvLnV0aWxzLmFycmF5Rm9yRWFjaChrZXlWYWx1ZUFycmF5LCBmdW5jdGlvbihrZXlWYWx1ZSkgewoJICAgICAgICAgICAgcHJvY2Vzc0tleVZhbHVlKGtleVZhbHVlLmtleSB8fCBrZXlWYWx1ZVsndW5rbm93biddLCBrZXlWYWx1ZS52YWx1ZSk7CgkgICAgICAgIH0pOwoKCSAgICAgICAgaWYgKHByb3BlcnR5QWNjZXNzb3JSZXN1bHRTdHJpbmdzLmxlbmd0aCkKCSAgICAgICAgICAgIHByb2Nlc3NLZXlWYWx1ZSgnX2tvX3Byb3BlcnR5X3dyaXRlcnMnLCAieyIgKyBwcm9wZXJ0eUFjY2Vzc29yUmVzdWx0U3RyaW5ncy5qb2luKCIsIikgKyAiIH0iKTsKCgkgICAgICAgIHJldHVybiByZXN1bHRTdHJpbmdzLmpvaW4oIiwiKTsKCSAgICB9CgoJICAgIHJldHVybiB7CgkgICAgICAgIGJpbmRpbmdSZXdyaXRlVmFsaWRhdG9yczogW10sCgoJICAgICAgICB0d29XYXlCaW5kaW5nczogdHdvV2F5QmluZGluZ3MsCgoJICAgICAgICBwYXJzZU9iamVjdExpdGVyYWw6IHBhcnNlT2JqZWN0TGl0ZXJhbCwKCgkgICAgICAgIHByZVByb2Nlc3NCaW5kaW5nczogcHJlUHJvY2Vzc0JpbmRpbmdzLAoKCSAgICAgICAga2V5VmFsdWVBcnJheUNvbnRhaW5zS2V5OiBmdW5jdGlvbihrZXlWYWx1ZUFycmF5LCBrZXkpIHsKCSAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwga2V5VmFsdWVBcnJheS5sZW5ndGg7IGkrKykKCSAgICAgICAgICAgICAgICBpZiAoa2V5VmFsdWVBcnJheVtpXVsna2V5J10gPT0ga2V5KQoJICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKCSAgICAgICAgICAgIHJldHVybiBmYWxzZTsKCSAgICAgICAgfSwKCgkgICAgICAgIC8vIEludGVybmFsLCBwcml2YXRlIEtPIHV0aWxpdHkgZm9yIHVwZGF0aW5nIG1vZGVsIHByb3BlcnRpZXMgZnJvbSB3aXRoaW4gYmluZGluZ3MKCSAgICAgICAgLy8gcHJvcGVydHk6ICAgICAgICAgICAgSWYgdGhlIHByb3BlcnR5IGJlaW5nIHVwZGF0ZWQgaXMgKG9yIG1pZ2h0IGJlKSBhbiBvYnNlcnZhYmxlLCBwYXNzIGl0IGhlcmUKCSAgICAgICAgLy8gICAgICAgICAgICAgICAgICAgICAgSWYgaXQgdHVybnMgb3V0IHRvIGJlIGEgd3JpdGFibGUgb2JzZXJ2YWJsZSwgaXQgd2lsbCBiZSB3cml0dGVuIHRvIGRpcmVjdGx5CgkgICAgICAgIC8vIGFsbEJpbmRpbmdzOiAgICAgICAgIEFuIG9iamVjdCB3aXRoIGEgZ2V0IG1ldGhvZCB0byByZXRyaWV2ZSBiaW5kaW5ncyBpbiB0aGUgY3VycmVudCBleGVjdXRpb24gY29udGV4dC4KCSAgICAgICAgLy8gICAgICAgICAgICAgICAgICAgICAgVGhpcyB3aWxsIGJlIHNlYXJjaGVkIGZvciBhICdfa29fcHJvcGVydHlfd3JpdGVycycgcHJvcGVydHkgaW4gY2FzZSB5b3UncmUgd3JpdGluZyB0byBhIG5vbi1vYnNlcnZhYmxlCgkgICAgICAgIC8vIGtleTogICAgICAgICAgICAgICAgIFRoZSBrZXkgaWRlbnRpZnlpbmcgdGhlIHByb3BlcnR5IHRvIGJlIHdyaXR0ZW4uIEV4YW1wbGU6IGZvciB7IGhhc0ZvY3VzOiBteVZhbHVlIH0sIHdyaXRlIHRvICdteVZhbHVlJyBieSBzcGVjaWZ5aW5nIHRoZSBrZXkgJ2hhc0ZvY3VzJwoJICAgICAgICAvLyB2YWx1ZTogICAgICAgICAgICAgICBUaGUgdmFsdWUgdG8gYmUgd3JpdHRlbgoJICAgICAgICAvLyBjaGVja0lmRGlmZmVyZW50OiAgICBJZiB0cnVlLCBhbmQgaWYgdGhlIHByb3BlcnR5IGJlaW5nIHdyaXR0ZW4gaXMgYSB3cml0YWJsZSBvYnNlcnZhYmxlLCB0aGUgdmFsdWUgd2lsbCBvbmx5IGJlIHdyaXR0ZW4gaWYKCSAgICAgICAgLy8gICAgICAgICAgICAgICAgICAgICAgaXQgaXMgIT09IGV4aXN0aW5nIHZhbHVlIG9uIHRoYXQgd3JpdGFibGUgb2JzZXJ2YWJsZQoJICAgICAgICB3cml0ZVZhbHVlVG9Qcm9wZXJ0eTogZnVuY3Rpb24ocHJvcGVydHksIGFsbEJpbmRpbmdzLCBrZXksIHZhbHVlLCBjaGVja0lmRGlmZmVyZW50KSB7CgkgICAgICAgICAgICBpZiAoIXByb3BlcnR5IHx8ICFrby5pc09ic2VydmFibGUocHJvcGVydHkpKSB7CgkgICAgICAgICAgICAgICAgdmFyIHByb3BXcml0ZXJzID0gYWxsQmluZGluZ3MuZ2V0KCdfa29fcHJvcGVydHlfd3JpdGVycycpOwoJICAgICAgICAgICAgICAgIGlmIChwcm9wV3JpdGVycyAmJiBwcm9wV3JpdGVyc1trZXldKQoJICAgICAgICAgICAgICAgICAgICBwcm9wV3JpdGVyc1trZXldKHZhbHVlKTsKCSAgICAgICAgICAgIH0gZWxzZSBpZiAoa28uaXNXcml0ZWFibGVPYnNlcnZhYmxlKHByb3BlcnR5KSAmJiAoIWNoZWNrSWZEaWZmZXJlbnQgfHwgcHJvcGVydHkucGVlaygpICE9PSB2YWx1ZSkpIHsKCSAgICAgICAgICAgICAgICBwcm9wZXJ0eSh2YWx1ZSk7CgkgICAgICAgICAgICB9CgkgICAgICAgIH0KCSAgICB9OwoJfSkoKTsKCglrby5leHBvcnRTeW1ib2woJ2V4cHJlc3Npb25SZXdyaXRpbmcnLCBrby5leHByZXNzaW9uUmV3cml0aW5nKTsKCWtvLmV4cG9ydFN5bWJvbCgnZXhwcmVzc2lvblJld3JpdGluZy5iaW5kaW5nUmV3cml0ZVZhbGlkYXRvcnMnLCBrby5leHByZXNzaW9uUmV3cml0aW5nLmJpbmRpbmdSZXdyaXRlVmFsaWRhdG9ycyk7Cglrby5leHBvcnRTeW1ib2woJ2V4cHJlc3Npb25SZXdyaXRpbmcucGFyc2VPYmplY3RMaXRlcmFsJywga28uZXhwcmVzc2lvblJld3JpdGluZy5wYXJzZU9iamVjdExpdGVyYWwpOwoJa28uZXhwb3J0U3ltYm9sKCdleHByZXNzaW9uUmV3cml0aW5nLnByZVByb2Nlc3NCaW5kaW5ncycsIGtvLmV4cHJlc3Npb25SZXdyaXRpbmcucHJlUHJvY2Vzc0JpbmRpbmdzKTsKCgkvLyBNYWtpbmcgYmluZGluZ3MgZXhwbGljaXRseSBkZWNsYXJlIHRoZW1zZWx2ZXMgYXMgInR3byB3YXkiIGlzbid0IGlkZWFsIGluIHRoZSBsb25nIHRlcm0gKGl0IHdvdWxkIGJlIGJldHRlciBpZgoJLy8gYWxsIGJpbmRpbmdzIGNvdWxkIHVzZSBhbiBvZmZpY2lhbCAncHJvcGVydHkgd3JpdGVyJyBBUEkgd2l0aG91dCBuZWVkaW5nIHRvIGRlY2xhcmUgdGhhdCB0aGV5IG1pZ2h0KS4gSG93ZXZlciwKCS8vIHNpbmNlIHRoaXMgaXMgbm90LCBhbmQgaGFzIG5ldmVyIGJlZW4sIGEgcHVibGljIEFQSSAoX2tvX3Byb3BlcnR5X3dyaXRlcnMgd2FzIG5ldmVyIGRvY3VtZW50ZWQpLCBpdCdzIGFjY2VwdGFibGUKCS8vIGFzIGFuIGludGVybmFsIGltcGxlbWVudGF0aW9uIGRldGFpbCBpbiB0aGUgc2hvcnQgdGVybS4KCS8vIEZvciB0aG9zZSBkZXZlbG9wZXJzIHdobyByZWx5IG9uIF9rb19wcm9wZXJ0eV93cml0ZXJzIGluIHRoZWlyIGN1c3RvbSBiaW5kaW5ncywgd2UgZXhwb3NlIF90d29XYXlCaW5kaW5ncyBhcyBhbgoJLy8gdW5kb2N1bWVudGVkIGZlYXR1cmUgdGhhdCBtYWtlcyBpdCByZWxhdGl2ZWx5IGVhc3kgdG8gdXBncmFkZSB0byBLTyAzLjAuIEhvd2V2ZXIsIHRoaXMgaXMgc3RpbGwgbm90IGFuIG9mZmljaWFsCgkvLyBwdWJsaWMgQVBJLCBhbmQgd2UgcmVzZXJ2ZSB0aGUgcmlnaHQgdG8gcmVtb3ZlIGl0IGF0IGFueSB0aW1lIGlmIHdlIGNyZWF0ZSBhIHJlYWwgcHVibGljIHByb3BlcnR5IHdyaXRlcnMgQVBJLgoJa28uZXhwb3J0U3ltYm9sKCdleHByZXNzaW9uUmV3cml0aW5nLl90d29XYXlCaW5kaW5ncycsIGtvLmV4cHJlc3Npb25SZXdyaXRpbmcudHdvV2F5QmluZGluZ3MpOwoKCS8vIEZvciBiYWNrd2FyZCBjb21wYXRpYmlsaXR5LCBkZWZpbmUgdGhlIGZvbGxvd2luZyBhbGlhc2VzLiAoUHJldmlvdXNseSwgdGhlc2UgZnVuY3Rpb24gbmFtZXMgd2VyZSBtaXNsZWFkaW5nIGJlY2F1c2UKCS8vIHRoZXkgcmVmZXJyZWQgdG8gSlNPTiBzcGVjaWZpY2FsbHksIGV2ZW4gdGhvdWdoIHRoZXkgYWN0dWFsbHkgd29yayB3aXRoIGFyYml0cmFyeSBKYXZhU2NyaXB0IG9iamVjdCBsaXRlcmFsIGV4cHJlc3Npb25zLikKCWtvLmV4cG9ydFN5bWJvbCgnanNvbkV4cHJlc3Npb25SZXdyaXRpbmcnLCBrby5leHByZXNzaW9uUmV3cml0aW5nKTsKCWtvLmV4cG9ydFN5bWJvbCgnanNvbkV4cHJlc3Npb25SZXdyaXRpbmcuaW5zZXJ0UHJvcGVydHlBY2Nlc3NvcnNJbnRvSnNvbicsIGtvLmV4cHJlc3Npb25SZXdyaXRpbmcucHJlUHJvY2Vzc0JpbmRpbmdzKTsKCShmdW5jdGlvbigpIHsKCSAgICAvLyAiVmlydHVhbCBlbGVtZW50cyIgaXMgYW4gYWJzdHJhY3Rpb24gb24gdG9wIG9mIHRoZSB1c3VhbCBET00gQVBJIHdoaWNoIHVuZGVyc3RhbmRzIHRoZSBub3Rpb24gdGhhdCBjb21tZW50IG5vZGVzCgkgICAgLy8gbWF5IGJlIHVzZWQgdG8gcmVwcmVzZW50IGhpZXJhcmNoeSAoaW4gYWRkaXRpb24gdG8gdGhlIERPTSdzIG5hdHVyYWwgaGllcmFyY2h5KS4KCSAgICAvLyBJZiB5b3UgY2FsbCB0aGUgRE9NLW1hbmlwdWxhdGluZyBmdW5jdGlvbnMgb24ga28udmlydHVhbEVsZW1lbnRzLCB5b3Ugd2lsbCBiZSBhYmxlIHRvIHJlYWQgYW5kIHdyaXRlIHRoZSBzdGF0ZQoJICAgIC8vIG9mIHRoYXQgdmlydHVhbCBoaWVyYXJjaHkKCSAgICAvLwoJICAgIC8vIFRoZSBwb2ludCBvZiBhbGwgdGhpcyBpcyB0byBzdXBwb3J0IGNvbnRhaW5lcmxlc3MgdGVtcGxhdGVzIChlLmcuLCA8IS0tIGtvIGZvcmVhY2g6c29tZUNvbGxlY3Rpb24gLS0+YmxhaDwhLS0gL2tvIC0tPikKCSAgICAvLyB3aXRob3V0IGhhdmluZyB0byBzY2F0dGVyIHNwZWNpYWwgY2FzZXMgYWxsIG92ZXIgdGhlIGJpbmRpbmcgYW5kIHRlbXBsYXRpbmcgY29kZS4KCgkgICAgLy8gSUUgOSBjYW5ub3QgcmVsaWFibHkgcmVhZCB0aGUgIm5vZGVWYWx1ZSIgcHJvcGVydHkgb2YgYSBjb21tZW50IG5vZGUgKHNlZSBodHRwczovL2dpdGh1Yi5jb20vU3RldmVTYW5kZXJzb24va25vY2tvdXQvaXNzdWVzLzE4NikKCSAgICAvLyBidXQgaXQgZG9lcyBnaXZlIHRoZW0gYSBub25zdGFuZGFyZCBhbHRlcm5hdGl2ZSBwcm9wZXJ0eSBjYWxsZWQgInRleHQiIHRoYXQgaXQgY2FuIHJlYWQgcmVsaWFibHkuIE90aGVyIGJyb3dzZXJzIGRvbid0IGhhdmUgdGhhdCBwcm9wZXJ0eS4KCSAgICAvLyBTbywgdXNlIG5vZGUudGV4dCB3aGVyZSBhdmFpbGFibGUsIGFuZCBub2RlLm5vZGVWYWx1ZSBlbHNld2hlcmUKCSAgICB2YXIgY29tbWVudE5vZGVzSGF2ZVRleHRQcm9wZXJ0eSA9IGRvY3VtZW50ICYmIGRvY3VtZW50LmNyZWF0ZUNvbW1lbnQoInRlc3QiKS50ZXh0ID09PSAiPCEtLXRlc3QtLT4iOwoKCSAgICB2YXIgc3RhcnRDb21tZW50UmVnZXggPSBjb21tZW50Tm9kZXNIYXZlVGV4dFByb3BlcnR5ID8gL148IS0tXHMqa28oPzpccysoW1xzXFNdKykpP1xzKi0tPiQvIDogL15ccyprbyg/OlxzKyhbXHNcU10rKSk/XHMqJC87CgkgICAgdmFyIGVuZENvbW1lbnRSZWdleCA9ICAgY29tbWVudE5vZGVzSGF2ZVRleHRQcm9wZXJ0eSA/IC9ePCEtLVxzKlwva29ccyotLT4kLyA6IC9eXHMqXC9rb1xzKiQvOwoJICAgIHZhciBodG1sVGFnc1dpdGhPcHRpb25hbGx5Q2xvc2luZ0NoaWxkcmVuID0geyAndWwnOiB0cnVlLCAnb2wnOiB0cnVlIH07CgoJICAgIGZ1bmN0aW9uIGlzU3RhcnRDb21tZW50KG5vZGUpIHsKCSAgICAgICAgcmV0dXJuIChub2RlLm5vZGVUeXBlID09IDgpICYmIHN0YXJ0Q29tbWVudFJlZ2V4LnRlc3QoY29tbWVudE5vZGVzSGF2ZVRleHRQcm9wZXJ0eSA/IG5vZGUudGV4dCA6IG5vZGUubm9kZVZhbHVlKTsKCSAgICB9CgoJICAgIGZ1bmN0aW9uIGlzRW5kQ29tbWVudChub2RlKSB7CgkgICAgICAgIHJldHVybiAobm9kZS5ub2RlVHlwZSA9PSA4KSAmJiBlbmRDb21tZW50UmVnZXgudGVzdChjb21tZW50Tm9kZXNIYXZlVGV4dFByb3BlcnR5ID8gbm9kZS50ZXh0IDogbm9kZS5ub2RlVmFsdWUpOwoJICAgIH0KCgkgICAgZnVuY3Rpb24gZ2V0VmlydHVhbENoaWxkcmVuKHN0YXJ0Q29tbWVudCwgYWxsb3dVbmJhbGFuY2VkKSB7CgkgICAgICAgIHZhciBjdXJyZW50Tm9kZSA9IHN0YXJ0Q29tbWVudDsKCSAgICAgICAgdmFyIGRlcHRoID0gMTsKCSAgICAgICAgdmFyIGNoaWxkcmVuID0gW107CgkgICAgICAgIHdoaWxlIChjdXJyZW50Tm9kZSA9IGN1cnJlbnROb2RlLm5leHRTaWJsaW5nKSB7CgkgICAgICAgICAgICBpZiAoaXNFbmRDb21tZW50KGN1cnJlbnROb2RlKSkgewoJICAgICAgICAgICAgICAgIGRlcHRoLS07CgkgICAgICAgICAgICAgICAgaWYgKGRlcHRoID09PSAwKQoJICAgICAgICAgICAgICAgICAgICByZXR1cm4gY2hpbGRyZW47CgkgICAgICAgICAgICB9CgoJICAgICAgICAgICAgY2hpbGRyZW4ucHVzaChjdXJyZW50Tm9kZSk7CgoJICAgICAgICAgICAgaWYgKGlzU3RhcnRDb21tZW50KGN1cnJlbnROb2RlKSkKCSAgICAgICAgICAgICAgICBkZXB0aCsrOwoJICAgICAgICB9CgkgICAgICAgIGlmICghYWxsb3dVbmJhbGFuY2VkKQoJICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJDYW5ub3QgZmluZCBjbG9zaW5nIGNvbW1lbnQgdGFnIHRvIG1hdGNoOiAiICsgc3RhcnRDb21tZW50Lm5vZGVWYWx1ZSk7CgkgICAgICAgIHJldHVybiBudWxsOwoJICAgIH0KCgkgICAgZnVuY3Rpb24gZ2V0TWF0Y2hpbmdFbmRDb21tZW50KHN0YXJ0Q29tbWVudCwgYWxsb3dVbmJhbGFuY2VkKSB7CgkgICAgICAgIHZhciBhbGxWaXJ0dWFsQ2hpbGRyZW4gPSBnZXRWaXJ0dWFsQ2hpbGRyZW4oc3RhcnRDb21tZW50LCBhbGxvd1VuYmFsYW5jZWQpOwoJICAgICAgICBpZiAoYWxsVmlydHVhbENoaWxkcmVuKSB7CgkgICAgICAgICAgICBpZiAoYWxsVmlydHVhbENoaWxkcmVuLmxlbmd0aCA+IDApCgkgICAgICAgICAgICAgICAgcmV0dXJuIGFsbFZpcnR1YWxDaGlsZHJlblthbGxWaXJ0dWFsQ2hpbGRyZW4ubGVuZ3RoIC0gMV0ubmV4dFNpYmxpbmc7CgkgICAgICAgICAgICByZXR1cm4gc3RhcnRDb21tZW50Lm5leHRTaWJsaW5nOwoJICAgICAgICB9IGVsc2UKCSAgICAgICAgICAgIHJldHVybiBudWxsOyAvLyBNdXN0IGhhdmUgbm8gbWF0Y2hpbmcgZW5kIGNvbW1lbnQsIGFuZCBhbGxvd1VuYmFsYW5jZWQgaXMgdHJ1ZQoJICAgIH0KCgkgICAgZnVuY3Rpb24gZ2V0VW5iYWxhbmNlZENoaWxkVGFncyhub2RlKSB7CgkgICAgICAgIC8vIGUuZy4sIGZyb20gPGRpdj5PSzwvZGl2PjwhLS0ga28gYmxhaCAtLT48c3Bhbj5Bbm90aGVyPC9zcGFuPiwgcmV0dXJuczogPCEtLSBrbyBibGFoIC0tPjxzcGFuPkFub3RoZXI8L3NwYW4+CgkgICAgICAgIC8vICAgICAgIGZyb20gPGRpdj5PSzwvZGl2PjwhLS0gL2tvIC0tPjwhLS0gL2tvIC0tPiwgICAgICAgICAgICAgcmV0dXJuczogPCEtLSAva28gLS0+PCEtLSAva28gLS0+CgkgICAgICAgIHZhciBjaGlsZE5vZGUgPSBub2RlLmZpcnN0Q2hpbGQsIGNhcHR1cmVSZW1haW5pbmcgPSBudWxsOwoJICAgICAgICBpZiAoY2hpbGROb2RlKSB7CgkgICAgICAgICAgICBkbyB7CgkgICAgICAgICAgICAgICAgaWYgKGNhcHR1cmVSZW1haW5pbmcpICAgICAgICAgICAgICAgICAgIC8vIFdlIGFscmVhZHkgaGl0IGFuIHVuYmFsYW5jZWQgbm9kZSBhbmQgYXJlIG5vdyBqdXN0IHNjb29waW5nIHVwIGFsbCBzdWJzZXF1ZW50IG5vZGVzCgkgICAgICAgICAgICAgICAgICAgIGNhcHR1cmVSZW1haW5pbmcucHVzaChjaGlsZE5vZGUpOwoJICAgICAgICAgICAgICAgIGVsc2UgaWYgKGlzU3RhcnRDb21tZW50KGNoaWxkTm9kZSkpIHsKCSAgICAgICAgICAgICAgICAgICAgdmFyIG1hdGNoaW5nRW5kQ29tbWVudCA9IGdldE1hdGNoaW5nRW5kQ29tbWVudChjaGlsZE5vZGUsIC8qIGFsbG93VW5iYWxhbmNlZDogKi8gdHJ1ZSk7CgkgICAgICAgICAgICAgICAgICAgIGlmIChtYXRjaGluZ0VuZENvbW1lbnQpICAgICAgICAgICAgIC8vIEl0J3MgYSBiYWxhbmNlZCB0YWcsIHNvIHNraXAgaW1tZWRpYXRlbHkgdG8gdGhlIGVuZCBvZiB0aGlzIHZpcnR1YWwgc2V0CgkgICAgICAgICAgICAgICAgICAgICAgICBjaGlsZE5vZGUgPSBtYXRjaGluZ0VuZENvbW1lbnQ7CgkgICAgICAgICAgICAgICAgICAgIGVsc2UKCSAgICAgICAgICAgICAgICAgICAgICAgIGNhcHR1cmVSZW1haW5pbmcgPSBbY2hpbGROb2RlXTsgLy8gSXQncyB1bmJhbGFuY2VkLCBzbyBzdGFydCBjYXB0dXJpbmcgZnJvbSB0aGlzIHBvaW50CgkgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChpc0VuZENvbW1lbnQoY2hpbGROb2RlKSkgewoJICAgICAgICAgICAgICAgICAgICBjYXB0dXJlUmVtYWluaW5nID0gW2NoaWxkTm9kZV07ICAgICAvLyBJdCdzIHVuYmFsYW5jZWQgKGlmIGl0IHdhc24ndCwgd2UnZCBoYXZlIHNraXBwZWQgb3ZlciBpdCBhbHJlYWR5KSwgc28gc3RhcnQgY2FwdHVyaW5nCgkgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgfSB3aGlsZSAoY2hpbGROb2RlID0gY2hpbGROb2RlLm5leHRTaWJsaW5nKTsKCSAgICAgICAgfQoJICAgICAgICByZXR1cm4gY2FwdHVyZVJlbWFpbmluZzsKCSAgICB9CgoJICAgIGtvLnZpcnR1YWxFbGVtZW50cyA9IHsKCSAgICAgICAgYWxsb3dlZEJpbmRpbmdzOiB7fSwKCgkgICAgICAgIGNoaWxkTm9kZXM6IGZ1bmN0aW9uKG5vZGUpIHsKCSAgICAgICAgICAgIHJldHVybiBpc1N0YXJ0Q29tbWVudChub2RlKSA/IGdldFZpcnR1YWxDaGlsZHJlbihub2RlKSA6IG5vZGUuY2hpbGROb2RlczsKCSAgICAgICAgfSwKCgkgICAgICAgIGVtcHR5Tm9kZTogZnVuY3Rpb24obm9kZSkgewoJICAgICAgICAgICAgaWYgKCFpc1N0YXJ0Q29tbWVudChub2RlKSkKCSAgICAgICAgICAgICAgICBrby51dGlscy5lbXB0eURvbU5vZGUobm9kZSk7CgkgICAgICAgICAgICBlbHNlIHsKCSAgICAgICAgICAgICAgICB2YXIgdmlydHVhbENoaWxkcmVuID0ga28udmlydHVhbEVsZW1lbnRzLmNoaWxkTm9kZXMobm9kZSk7CgkgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGogPSB2aXJ0dWFsQ2hpbGRyZW4ubGVuZ3RoOyBpIDwgajsgaSsrKQoJICAgICAgICAgICAgICAgICAgICBrby5yZW1vdmVOb2RlKHZpcnR1YWxDaGlsZHJlbltpXSk7CgkgICAgICAgICAgICB9CgkgICAgICAgIH0sCgoJICAgICAgICBzZXREb21Ob2RlQ2hpbGRyZW46IGZ1bmN0aW9uKG5vZGUsIGNoaWxkTm9kZXMpIHsKCSAgICAgICAgICAgIGlmICghaXNTdGFydENvbW1lbnQobm9kZSkpCgkgICAgICAgICAgICAgICAga28udXRpbHMuc2V0RG9tTm9kZUNoaWxkcmVuKG5vZGUsIGNoaWxkTm9kZXMpOwoJICAgICAgICAgICAgZWxzZSB7CgkgICAgICAgICAgICAgICAga28udmlydHVhbEVsZW1lbnRzLmVtcHR5Tm9kZShub2RlKTsKCSAgICAgICAgICAgICAgICB2YXIgZW5kQ29tbWVudE5vZGUgPSBub2RlLm5leHRTaWJsaW5nOyAvLyBNdXN0IGJlIHRoZSBuZXh0IHNpYmxpbmcsIGFzIHdlIGp1c3QgZW1wdGllZCB0aGUgY2hpbGRyZW4KCSAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaiA9IGNoaWxkTm9kZXMubGVuZ3RoOyBpIDwgajsgaSsrKQoJICAgICAgICAgICAgICAgICAgICBlbmRDb21tZW50Tm9kZS5wYXJlbnROb2RlLmluc2VydEJlZm9yZShjaGlsZE5vZGVzW2ldLCBlbmRDb21tZW50Tm9kZSk7CgkgICAgICAgICAgICB9CgkgICAgICAgIH0sCgoJICAgICAgICBwcmVwZW5kOiBmdW5jdGlvbihjb250YWluZXJOb2RlLCBub2RlVG9QcmVwZW5kKSB7CgkgICAgICAgICAgICBpZiAoIWlzU3RhcnRDb21tZW50KGNvbnRhaW5lck5vZGUpKSB7CgkgICAgICAgICAgICAgICAgaWYgKGNvbnRhaW5lck5vZGUuZmlyc3RDaGlsZCkKCSAgICAgICAgICAgICAgICAgICAgY29udGFpbmVyTm9kZS5pbnNlcnRCZWZvcmUobm9kZVRvUHJlcGVuZCwgY29udGFpbmVyTm9kZS5maXJzdENoaWxkKTsKCSAgICAgICAgICAgICAgICBlbHNlCgkgICAgICAgICAgICAgICAgICAgIGNvbnRhaW5lck5vZGUuYXBwZW5kQ2hpbGQobm9kZVRvUHJlcGVuZCk7CgkgICAgICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgICAgIC8vIFN0YXJ0IGNvbW1lbnRzIG11c3QgYWx3YXlzIGhhdmUgYSBwYXJlbnQgYW5kIGF0IGxlYXN0IG9uZSBmb2xsb3dpbmcgc2libGluZyAodGhlIGVuZCBjb21tZW50KQoJICAgICAgICAgICAgICAgIGNvbnRhaW5lck5vZGUucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUobm9kZVRvUHJlcGVuZCwgY29udGFpbmVyTm9kZS5uZXh0U2libGluZyk7CgkgICAgICAgICAgICB9CgkgICAgICAgIH0sCgoJICAgICAgICBpbnNlcnRBZnRlcjogZnVuY3Rpb24oY29udGFpbmVyTm9kZSwgbm9kZVRvSW5zZXJ0LCBpbnNlcnRBZnRlck5vZGUpIHsKCSAgICAgICAgICAgIGlmICghaW5zZXJ0QWZ0ZXJOb2RlKSB7CgkgICAgICAgICAgICAgICAga28udmlydHVhbEVsZW1lbnRzLnByZXBlbmQoY29udGFpbmVyTm9kZSwgbm9kZVRvSW5zZXJ0KTsKCSAgICAgICAgICAgIH0gZWxzZSBpZiAoIWlzU3RhcnRDb21tZW50KGNvbnRhaW5lck5vZGUpKSB7CgkgICAgICAgICAgICAgICAgLy8gSW5zZXJ0IGFmdGVyIGluc2VydGlvbiBwb2ludAoJICAgICAgICAgICAgICAgIGlmIChpbnNlcnRBZnRlck5vZGUubmV4dFNpYmxpbmcpCgkgICAgICAgICAgICAgICAgICAgIGNvbnRhaW5lck5vZGUuaW5zZXJ0QmVmb3JlKG5vZGVUb0luc2VydCwgaW5zZXJ0QWZ0ZXJOb2RlLm5leHRTaWJsaW5nKTsKCSAgICAgICAgICAgICAgICBlbHNlCgkgICAgICAgICAgICAgICAgICAgIGNvbnRhaW5lck5vZGUuYXBwZW5kQ2hpbGQobm9kZVRvSW5zZXJ0KTsKCSAgICAgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICAgICAgLy8gQ2hpbGRyZW4gb2Ygc3RhcnQgY29tbWVudHMgbXVzdCBhbHdheXMgaGF2ZSBhIHBhcmVudCBhbmQgYXQgbGVhc3Qgb25lIGZvbGxvd2luZyBzaWJsaW5nICh0aGUgZW5kIGNvbW1lbnQpCgkgICAgICAgICAgICAgICAgY29udGFpbmVyTm9kZS5wYXJlbnROb2RlLmluc2VydEJlZm9yZShub2RlVG9JbnNlcnQsIGluc2VydEFmdGVyTm9kZS5uZXh0U2libGluZyk7CgkgICAgICAgICAgICB9CgkgICAgICAgIH0sCgoJICAgICAgICBmaXJzdENoaWxkOiBmdW5jdGlvbihub2RlKSB7CgkgICAgICAgICAgICBpZiAoIWlzU3RhcnRDb21tZW50KG5vZGUpKQoJICAgICAgICAgICAgICAgIHJldHVybiBub2RlLmZpcnN0Q2hpbGQ7CgkgICAgICAgICAgICBpZiAoIW5vZGUubmV4dFNpYmxpbmcgfHwgaXNFbmRDb21tZW50KG5vZGUubmV4dFNpYmxpbmcpKQoJICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwoJICAgICAgICAgICAgcmV0dXJuIG5vZGUubmV4dFNpYmxpbmc7CgkgICAgICAgIH0sCgoJICAgICAgICBuZXh0U2libGluZzogZnVuY3Rpb24obm9kZSkgewoJICAgICAgICAgICAgaWYgKGlzU3RhcnRDb21tZW50KG5vZGUpKQoJICAgICAgICAgICAgICAgIG5vZGUgPSBnZXRNYXRjaGluZ0VuZENvbW1lbnQobm9kZSk7CgkgICAgICAgICAgICBpZiAobm9kZS5uZXh0U2libGluZyAmJiBpc0VuZENvbW1lbnQobm9kZS5uZXh0U2libGluZykpCgkgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CgkgICAgICAgICAgICByZXR1cm4gbm9kZS5uZXh0U2libGluZzsKCSAgICAgICAgfSwKCgkgICAgICAgIGhhc0JpbmRpbmdWYWx1ZTogaXNTdGFydENvbW1lbnQsCgoJICAgICAgICB2aXJ0dWFsTm9kZUJpbmRpbmdWYWx1ZTogZnVuY3Rpb24obm9kZSkgewoJICAgICAgICAgICAgdmFyIHJlZ2V4TWF0Y2ggPSAoY29tbWVudE5vZGVzSGF2ZVRleHRQcm9wZXJ0eSA/IG5vZGUudGV4dCA6IG5vZGUubm9kZVZhbHVlKS5tYXRjaChzdGFydENvbW1lbnRSZWdleCk7CgkgICAgICAgICAgICByZXR1cm4gcmVnZXhNYXRjaCA/IHJlZ2V4TWF0Y2hbMV0gOiBudWxsOwoJICAgICAgICB9LAoKCSAgICAgICAgbm9ybWFsaXNlVmlydHVhbEVsZW1lbnREb21TdHJ1Y3R1cmU6IGZ1bmN0aW9uKGVsZW1lbnRWZXJpZmllZCkgewoJICAgICAgICAgICAgLy8gV29ya2Fyb3VuZCBmb3IgaHR0cHM6Ly9naXRodWIuY29tL1N0ZXZlU2FuZGVyc29uL2tub2Nrb3V0L2lzc3Vlcy8xNTUKCSAgICAgICAgICAgIC8vIChJRSA8PSA4IG9yIElFIDkgcXVpcmtzIG1vZGUgcGFyc2VzIHlvdXIgSFRNTCB3ZWlyZGx5LCB0cmVhdGluZyBjbG9zaW5nIDwvbGk+IHRhZ3MgYXMgaWYgdGhleSBkb24ndCBleGlzdCwgdGhlcmVieSBtb3ZpbmcgY29tbWVudCBub2RlcwoJICAgICAgICAgICAgLy8gdGhhdCBhcmUgZGlyZWN0IGRlc2NlbmRhbnRzIG9mIDx1bD4gaW50byB0aGUgcHJlY2VkaW5nIDxsaT4pCgkgICAgICAgICAgICBpZiAoIWh0bWxUYWdzV2l0aE9wdGlvbmFsbHlDbG9zaW5nQ2hpbGRyZW5ba28udXRpbHMudGFnTmFtZUxvd2VyKGVsZW1lbnRWZXJpZmllZCldKQoJICAgICAgICAgICAgICAgIHJldHVybjsKCgkgICAgICAgICAgICAvLyBTY2FuIGltbWVkaWF0ZSBjaGlsZHJlbiB0byBzZWUgaWYgdGhleSBjb250YWluIHVuYmFsYW5jZWQgY29tbWVudCB0YWdzLiBJZiB0aGV5IGRvLCB0aG9zZSBjb21tZW50IHRhZ3MKCSAgICAgICAgICAgIC8vIG11c3QgYmUgaW50ZW5kZWQgdG8gYXBwZWFyICphZnRlciogdGhhdCBjaGlsZCwgc28gbW92ZSB0aGVtIHRoZXJlLgoJICAgICAgICAgICAgdmFyIGNoaWxkTm9kZSA9IGVsZW1lbnRWZXJpZmllZC5maXJzdENoaWxkOwoJICAgICAgICAgICAgaWYgKGNoaWxkTm9kZSkgewoJICAgICAgICAgICAgICAgIGRvIHsKCSAgICAgICAgICAgICAgICAgICAgaWYgKGNoaWxkTm9kZS5ub2RlVHlwZSA9PT0gMSkgewoJICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHVuYmFsYW5jZWRUYWdzID0gZ2V0VW5iYWxhbmNlZENoaWxkVGFncyhjaGlsZE5vZGUpOwoJICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHVuYmFsYW5jZWRUYWdzKSB7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gRml4IHVwIHRoZSBET00gYnkgbW92aW5nIHRoZSB1bmJhbGFuY2VkIHRhZ3MgdG8gd2hlcmUgdGhleSBtb3N0IGxpa2VseSB3ZXJlIGludGVuZGVkIHRvIGJlIHBsYWNlZCAtICphZnRlciogdGhlIGNoaWxkCgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG5vZGVUb0luc2VydEJlZm9yZSA9IGNoaWxkTm9kZS5uZXh0U2libGluZzsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHVuYmFsYW5jZWRUYWdzLmxlbmd0aDsgaSsrKSB7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChub2RlVG9JbnNlcnRCZWZvcmUpCgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50VmVyaWZpZWQuaW5zZXJ0QmVmb3JlKHVuYmFsYW5jZWRUYWdzW2ldLCBub2RlVG9JbnNlcnRCZWZvcmUpOwoJICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlCgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50VmVyaWZpZWQuYXBwZW5kQ2hpbGQodW5iYWxhbmNlZFRhZ3NbaV0pOwoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgIH0gd2hpbGUgKGNoaWxkTm9kZSA9IGNoaWxkTm9kZS5uZXh0U2libGluZyk7CgkgICAgICAgICAgICB9CgkgICAgICAgIH0KCSAgICB9OwoJfSkoKTsKCWtvLmV4cG9ydFN5bWJvbCgndmlydHVhbEVsZW1lbnRzJywga28udmlydHVhbEVsZW1lbnRzKTsKCWtvLmV4cG9ydFN5bWJvbCgndmlydHVhbEVsZW1lbnRzLmFsbG93ZWRCaW5kaW5ncycsIGtvLnZpcnR1YWxFbGVtZW50cy5hbGxvd2VkQmluZGluZ3MpOwoJa28uZXhwb3J0U3ltYm9sKCd2aXJ0dWFsRWxlbWVudHMuZW1wdHlOb2RlJywga28udmlydHVhbEVsZW1lbnRzLmVtcHR5Tm9kZSk7CgkvL2tvLmV4cG9ydFN5bWJvbCgndmlydHVhbEVsZW1lbnRzLmZpcnN0Q2hpbGQnLCBrby52aXJ0dWFsRWxlbWVudHMuZmlyc3RDaGlsZCk7ICAgICAvLyBmaXJzdENoaWxkIGlzIG5vdCBtaW5pZmllZAoJa28uZXhwb3J0U3ltYm9sKCd2aXJ0dWFsRWxlbWVudHMuaW5zZXJ0QWZ0ZXInLCBrby52aXJ0dWFsRWxlbWVudHMuaW5zZXJ0QWZ0ZXIpOwoJLy9rby5leHBvcnRTeW1ib2woJ3ZpcnR1YWxFbGVtZW50cy5uZXh0U2libGluZycsIGtvLnZpcnR1YWxFbGVtZW50cy5uZXh0U2libGluZyk7ICAgLy8gbmV4dFNpYmxpbmcgaXMgbm90IG1pbmlmaWVkCglrby5leHBvcnRTeW1ib2woJ3ZpcnR1YWxFbGVtZW50cy5wcmVwZW5kJywga28udmlydHVhbEVsZW1lbnRzLnByZXBlbmQpOwoJa28uZXhwb3J0U3ltYm9sKCd2aXJ0dWFsRWxlbWVudHMuc2V0RG9tTm9kZUNoaWxkcmVuJywga28udmlydHVhbEVsZW1lbnRzLnNldERvbU5vZGVDaGlsZHJlbik7CgkoZnVuY3Rpb24oKSB7CgkgICAgdmFyIGRlZmF1bHRCaW5kaW5nQXR0cmlidXRlTmFtZSA9ICJkYXRhLWJpbmQiOwoKCSAgICBrby5iaW5kaW5nUHJvdmlkZXIgPSBmdW5jdGlvbigpIHsKCSAgICAgICAgdGhpcy5iaW5kaW5nQ2FjaGUgPSB7fTsKCSAgICB9OwoKCSAgICBrby51dGlscy5leHRlbmQoa28uYmluZGluZ1Byb3ZpZGVyLnByb3RvdHlwZSwgewoJICAgICAgICAnbm9kZUhhc0JpbmRpbmdzJzogZnVuY3Rpb24obm9kZSkgewoJICAgICAgICAgICAgc3dpdGNoIChub2RlLm5vZGVUeXBlKSB7CgkgICAgICAgICAgICAgICAgY2FzZSAxOiAvLyBFbGVtZW50CgkgICAgICAgICAgICAgICAgICAgIHJldHVybiBub2RlLmdldEF0dHJpYnV0ZShkZWZhdWx0QmluZGluZ0F0dHJpYnV0ZU5hbWUpICE9IG51bGwKCSAgICAgICAgICAgICAgICAgICAgICAgIHx8IGtvLmNvbXBvbmVudHNbJ2dldENvbXBvbmVudE5hbWVGb3JOb2RlJ10obm9kZSk7CgkgICAgICAgICAgICAgICAgY2FzZSA4OiAvLyBDb21tZW50IG5vZGUKCSAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGtvLnZpcnR1YWxFbGVtZW50cy5oYXNCaW5kaW5nVmFsdWUobm9kZSk7CgkgICAgICAgICAgICAgICAgZGVmYXVsdDogcmV0dXJuIGZhbHNlOwoJICAgICAgICAgICAgfQoJICAgICAgICB9LAoKCSAgICAgICAgJ2dldEJpbmRpbmdzJzogZnVuY3Rpb24obm9kZSwgYmluZGluZ0NvbnRleHQpIHsKCSAgICAgICAgICAgIHZhciBiaW5kaW5nc1N0cmluZyA9IHRoaXNbJ2dldEJpbmRpbmdzU3RyaW5nJ10obm9kZSwgYmluZGluZ0NvbnRleHQpLAoJICAgICAgICAgICAgICAgIHBhcnNlZEJpbmRpbmdzID0gYmluZGluZ3NTdHJpbmcgPyB0aGlzWydwYXJzZUJpbmRpbmdzU3RyaW5nJ10oYmluZGluZ3NTdHJpbmcsIGJpbmRpbmdDb250ZXh0LCBub2RlKSA6IG51bGw7CgkgICAgICAgICAgICByZXR1cm4ga28uY29tcG9uZW50cy5hZGRCaW5kaW5nc0ZvckN1c3RvbUVsZW1lbnQocGFyc2VkQmluZGluZ3MsIG5vZGUsIGJpbmRpbmdDb250ZXh0LCAvKiB2YWx1ZUFjY2Vzc29ycyAqLyBmYWxzZSk7CgkgICAgICAgIH0sCgoJICAgICAgICAnZ2V0QmluZGluZ0FjY2Vzc29ycyc6IGZ1bmN0aW9uKG5vZGUsIGJpbmRpbmdDb250ZXh0KSB7CgkgICAgICAgICAgICB2YXIgYmluZGluZ3NTdHJpbmcgPSB0aGlzWydnZXRCaW5kaW5nc1N0cmluZyddKG5vZGUsIGJpbmRpbmdDb250ZXh0KSwKCSAgICAgICAgICAgICAgICBwYXJzZWRCaW5kaW5ncyA9IGJpbmRpbmdzU3RyaW5nID8gdGhpc1sncGFyc2VCaW5kaW5nc1N0cmluZyddKGJpbmRpbmdzU3RyaW5nLCBiaW5kaW5nQ29udGV4dCwgbm9kZSwgeyAndmFsdWVBY2Nlc3NvcnMnOiB0cnVlIH0pIDogbnVsbDsKCSAgICAgICAgICAgIHJldHVybiBrby5jb21wb25lbnRzLmFkZEJpbmRpbmdzRm9yQ3VzdG9tRWxlbWVudChwYXJzZWRCaW5kaW5ncywgbm9kZSwgYmluZGluZ0NvbnRleHQsIC8qIHZhbHVlQWNjZXNzb3JzICovIHRydWUpOwoJICAgICAgICB9LAoKCSAgICAgICAgLy8gVGhlIGZvbGxvd2luZyBmdW5jdGlvbiBpcyBvbmx5IHVzZWQgaW50ZXJuYWxseSBieSB0aGlzIGRlZmF1bHQgcHJvdmlkZXIuCgkgICAgICAgIC8vIEl0J3Mgbm90IHBhcnQgb2YgdGhlIGludGVyZmFjZSBkZWZpbml0aW9uIGZvciBhIGdlbmVyYWwgYmluZGluZyBwcm92aWRlci4KCSAgICAgICAgJ2dldEJpbmRpbmdzU3RyaW5nJzogZnVuY3Rpb24obm9kZSwgYmluZGluZ0NvbnRleHQpIHsKCSAgICAgICAgICAgIHN3aXRjaCAobm9kZS5ub2RlVHlwZSkgewoJICAgICAgICAgICAgICAgIGNhc2UgMTogcmV0dXJuIG5vZGUuZ2V0QXR0cmlidXRlKGRlZmF1bHRCaW5kaW5nQXR0cmlidXRlTmFtZSk7ICAgLy8gRWxlbWVudAoJICAgICAgICAgICAgICAgIGNhc2UgODogcmV0dXJuIGtvLnZpcnR1YWxFbGVtZW50cy52aXJ0dWFsTm9kZUJpbmRpbmdWYWx1ZShub2RlKTsgLy8gQ29tbWVudCBub2RlCgkgICAgICAgICAgICAgICAgZGVmYXVsdDogcmV0dXJuIG51bGw7CgkgICAgICAgICAgICB9CgkgICAgICAgIH0sCgoJICAgICAgICAvLyBUaGUgZm9sbG93aW5nIGZ1bmN0aW9uIGlzIG9ubHkgdXNlZCBpbnRlcm5hbGx5IGJ5IHRoaXMgZGVmYXVsdCBwcm92aWRlci4KCSAgICAgICAgLy8gSXQncyBub3QgcGFydCBvZiB0aGUgaW50ZXJmYWNlIGRlZmluaXRpb24gZm9yIGEgZ2VuZXJhbCBiaW5kaW5nIHByb3ZpZGVyLgoJICAgICAgICAncGFyc2VCaW5kaW5nc1N0cmluZyc6IGZ1bmN0aW9uKGJpbmRpbmdzU3RyaW5nLCBiaW5kaW5nQ29udGV4dCwgbm9kZSwgb3B0aW9ucykgewoJICAgICAgICAgICAgdHJ5IHsKCSAgICAgICAgICAgICAgICB2YXIgYmluZGluZ0Z1bmN0aW9uID0gY3JlYXRlQmluZGluZ3NTdHJpbmdFdmFsdWF0b3JWaWFDYWNoZShiaW5kaW5nc1N0cmluZywgdGhpcy5iaW5kaW5nQ2FjaGUsIG9wdGlvbnMpOwoJICAgICAgICAgICAgICAgIHJldHVybiBiaW5kaW5nRnVuY3Rpb24oYmluZGluZ0NvbnRleHQsIG5vZGUpOwoJICAgICAgICAgICAgfSBjYXRjaCAoZXgpIHsKCSAgICAgICAgICAgICAgICBleC5tZXNzYWdlID0gIlVuYWJsZSB0byBwYXJzZSBiaW5kaW5ncy5cbkJpbmRpbmdzIHZhbHVlOiAiICsgYmluZGluZ3NTdHJpbmcgKyAiXG5NZXNzYWdlOiAiICsgZXgubWVzc2FnZTsKCSAgICAgICAgICAgICAgICB0aHJvdyBleDsKCSAgICAgICAgICAgIH0KCSAgICAgICAgfQoJICAgIH0pOwoKCSAgICBrby5iaW5kaW5nUHJvdmlkZXJbJ2luc3RhbmNlJ10gPSBuZXcga28uYmluZGluZ1Byb3ZpZGVyKCk7CgoJICAgIGZ1bmN0aW9uIGNyZWF0ZUJpbmRpbmdzU3RyaW5nRXZhbHVhdG9yVmlhQ2FjaGUoYmluZGluZ3NTdHJpbmcsIGNhY2hlLCBvcHRpb25zKSB7CgkgICAgICAgIHZhciBjYWNoZUtleSA9IGJpbmRpbmdzU3RyaW5nICsgKG9wdGlvbnMgJiYgb3B0aW9uc1sndmFsdWVBY2Nlc3NvcnMnXSB8fCAnJyk7CgkgICAgICAgIHJldHVybiBjYWNoZVtjYWNoZUtleV0KCSAgICAgICAgICAgIHx8IChjYWNoZVtjYWNoZUtleV0gPSBjcmVhdGVCaW5kaW5nc1N0cmluZ0V2YWx1YXRvcihiaW5kaW5nc1N0cmluZywgb3B0aW9ucykpOwoJICAgIH0KCgkgICAgZnVuY3Rpb24gY3JlYXRlQmluZGluZ3NTdHJpbmdFdmFsdWF0b3IoYmluZGluZ3NTdHJpbmcsIG9wdGlvbnMpIHsKCSAgICAgICAgLy8gQnVpbGQgdGhlIHNvdXJjZSBmb3IgYSBmdW5jdGlvbiB0aGF0IGV2YWx1YXRlcyAiZXhwcmVzc2lvbiIKCSAgICAgICAgLy8gRm9yIGVhY2ggc2NvcGUgdmFyaWFibGUsIGFkZCBhbiBleHRyYSBsZXZlbCBvZiAid2l0aCIgbmVzdGluZwoJICAgICAgICAvLyBFeGFtcGxlIHJlc3VsdDogd2l0aChzYzEpIHsgd2l0aChzYzApIHsgcmV0dXJuIChleHByZXNzaW9uKSB9IH0KCSAgICAgICAgdmFyIHJld3JpdHRlbkJpbmRpbmdzID0ga28uZXhwcmVzc2lvblJld3JpdGluZy5wcmVQcm9jZXNzQmluZGluZ3MoYmluZGluZ3NTdHJpbmcsIG9wdGlvbnMpLAoJICAgICAgICAgICAgZnVuY3Rpb25Cb2R5ID0gIndpdGgoJGNvbnRleHQpe3dpdGgoJGRhdGF8fHt9KXtyZXR1cm57IiArIHJld3JpdHRlbkJpbmRpbmdzICsgIn19fSI7CgkgICAgICAgIHJldHVybiBuZXcgRnVuY3Rpb24oIiRjb250ZXh0IiwgIiRlbGVtZW50IiwgZnVuY3Rpb25Cb2R5KTsKCSAgICB9Cgl9KSgpOwoKCWtvLmV4cG9ydFN5bWJvbCgnYmluZGluZ1Byb3ZpZGVyJywga28uYmluZGluZ1Byb3ZpZGVyKTsKCShmdW5jdGlvbiAoKSB7CgkgICAga28uYmluZGluZ0hhbmRsZXJzID0ge307CgoJICAgIC8vIFRoZSBmb2xsb3dpbmcgZWxlbWVudCB0eXBlcyB3aWxsIG5vdCBiZSByZWN1cnNlZCBpbnRvIGR1cmluZyBiaW5kaW5nLiBJbiB0aGUgZnV0dXJlLCB3ZQoJICAgIC8vIG1heSBjb25zaWRlciBhZGRpbmcgPHRlbXBsYXRlPiB0byB0aGlzIGxpc3QsIGJlY2F1c2Ugc3VjaCBlbGVtZW50cycgY29udGVudHMgYXJlIGFsd2F5cwoJICAgIC8vIGludGVuZGVkIHRvIGJlIGJvdW5kIGluIGEgZGlmZmVyZW50IGNvbnRleHQgZnJvbSB3aGVyZSB0aGV5IGFwcGVhciBpbiB0aGUgZG9jdW1lbnQuCgkgICAgdmFyIGJpbmRpbmdEb2VzTm90UmVjdXJzZUludG9FbGVtZW50VHlwZXMgPSB7CgkgICAgICAgIC8vIERvbid0IHdhbnQgYmluZGluZ3MgdGhhdCBvcGVyYXRlIG9uIHRleHQgbm9kZXMgdG8gbXV0YXRlIDxzY3JpcHQ+IGNvbnRlbnRzLAoJICAgICAgICAvLyBiZWNhdXNlIGl0J3MgdW5leHBlY3RlZCBhbmQgYSBwb3RlbnRpYWwgWFNTIGlzc3VlCgkgICAgICAgICdzY3JpcHQnOiB0cnVlCgkgICAgfTsKCgkgICAgLy8gVXNlIGFuIG92ZXJyaWRhYmxlIG1ldGhvZCBmb3IgcmV0cmlldmluZyBiaW5kaW5nIGhhbmRsZXJzIHNvIHRoYXQgYSBwbHVnaW5zIG1heSBzdXBwb3J0IGR5bmFtaWNhbGx5IGNyZWF0ZWQgaGFuZGxlcnMKCSAgICBrb1snZ2V0QmluZGluZ0hhbmRsZXInXSA9IGZ1bmN0aW9uKGJpbmRpbmdLZXkpIHsKCSAgICAgICAgcmV0dXJuIGtvLmJpbmRpbmdIYW5kbGVyc1tiaW5kaW5nS2V5XTsKCSAgICB9OwoKCSAgICAvLyBUaGUga28uYmluZGluZ0NvbnRleHQgY29uc3RydWN0b3IgaXMgb25seSBjYWxsZWQgZGlyZWN0bHkgdG8gY3JlYXRlIHRoZSByb290IGNvbnRleHQuIEZvciBjaGlsZAoJICAgIC8vIGNvbnRleHRzLCB1c2UgYmluZGluZ0NvbnRleHQuY3JlYXRlQ2hpbGRDb250ZXh0IG9yIGJpbmRpbmdDb250ZXh0LmV4dGVuZC4KCSAgICBrby5iaW5kaW5nQ29udGV4dCA9IGZ1bmN0aW9uKGRhdGFJdGVtT3JBY2Nlc3NvciwgcGFyZW50Q29udGV4dCwgZGF0YUl0ZW1BbGlhcywgZXh0ZW5kQ2FsbGJhY2spIHsKCgkgICAgICAgIC8vIFRoZSBiaW5kaW5nIGNvbnRleHQgb2JqZWN0IGluY2x1ZGVzIHN0YXRpYyBwcm9wZXJ0aWVzIGZvciB0aGUgY3VycmVudCwgcGFyZW50LCBhbmQgcm9vdCB2aWV3IG1vZGVscy4KCSAgICAgICAgLy8gSWYgYSB2aWV3IG1vZGVsIGlzIGFjdHVhbGx5IHN0b3JlZCBpbiBhbiBvYnNlcnZhYmxlLCB0aGUgY29ycmVzcG9uZGluZyBiaW5kaW5nIGNvbnRleHQgb2JqZWN0LCBhbmQKCSAgICAgICAgLy8gYW55IGNoaWxkIGNvbnRleHRzLCBtdXN0IGJlIHVwZGF0ZWQgd2hlbiB0aGUgdmlldyBtb2RlbCBpcyBjaGFuZ2VkLgoJICAgICAgICBmdW5jdGlvbiB1cGRhdGVDb250ZXh0KCkgewoJICAgICAgICAgICAgLy8gTW9zdCBvZiB0aGUgdGltZSwgdGhlIGNvbnRleHQgd2lsbCBkaXJlY3RseSBnZXQgYSB2aWV3IG1vZGVsIG9iamVjdCwgYnV0IGlmIGEgZnVuY3Rpb24gaXMgZ2l2ZW4sCgkgICAgICAgICAgICAvLyB3ZSBjYWxsIHRoZSBmdW5jdGlvbiB0byByZXRyaWV2ZSB0aGUgdmlldyBtb2RlbC4gSWYgdGhlIGZ1bmN0aW9uIGFjY2Vzc2VzIGFueSBvYnNldmFibGVzIG9yIHJldHVybnMKCSAgICAgICAgICAgIC8vIGFuIG9ic2VydmFibGUsIHRoZSBkZXBlbmRlbmN5IGlzIHRyYWNrZWQsIGFuZCB0aG9zZSBvYnNlcnZhYmxlcyBjYW4gbGF0ZXIgY2F1c2UgdGhlIGJpbmRpbmcKCSAgICAgICAgICAgIC8vIGNvbnRleHQgdG8gYmUgdXBkYXRlZC4KCSAgICAgICAgICAgIHZhciBkYXRhSXRlbU9yT2JzZXJ2YWJsZSA9IGlzRnVuYyA/IGRhdGFJdGVtT3JBY2Nlc3NvcigpIDogZGF0YUl0ZW1PckFjY2Vzc29yLAoJICAgICAgICAgICAgICAgIGRhdGFJdGVtID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZShkYXRhSXRlbU9yT2JzZXJ2YWJsZSk7CgoJICAgICAgICAgICAgaWYgKHBhcmVudENvbnRleHQpIHsKCSAgICAgICAgICAgICAgICAvLyBXaGVuIGEgInBhcmVudCIgY29udGV4dCBpcyBnaXZlbiwgcmVnaXN0ZXIgYSBkZXBlbmRlbmN5IG9uIHRoZSBwYXJlbnQgY29udGV4dC4gVGh1cyB3aGVuZXZlciB0aGUKCSAgICAgICAgICAgICAgICAvLyBwYXJlbnQgY29udGV4dCBpcyB1cGRhdGVkLCB0aGlzIGNvbnRleHQgd2lsbCBhbHNvIGJlIHVwZGF0ZWQuCgkgICAgICAgICAgICAgICAgaWYgKHBhcmVudENvbnRleHQuX3N1YnNjcmliYWJsZSkKCSAgICAgICAgICAgICAgICAgICAgcGFyZW50Q29udGV4dC5fc3Vic2NyaWJhYmxlKCk7CgoJICAgICAgICAgICAgICAgIC8vIENvcHkgJHJvb3QgYW5kIGFueSBjdXN0b20gcHJvcGVydGllcyBmcm9tIHRoZSBwYXJlbnQgY29udGV4dAoJICAgICAgICAgICAgICAgIGtvLnV0aWxzLmV4dGVuZChzZWxmLCBwYXJlbnRDb250ZXh0KTsKCgkgICAgICAgICAgICAgICAgLy8gQmVjYXVzZSB0aGUgYWJvdmUgY29weSBvdmVyd3JpdGVzIG91ciBvd24gcHJvcGVydGllcywgd2UgbmVlZCB0byByZXNldCB0aGVtLgoJICAgICAgICAgICAgICAgIC8vIER1cmluZyB0aGUgZmlyc3QgZXhlY3V0aW9uLCAic3Vic2NyaWJhYmxlIiBpc24ndCBzZXQsIHNvIGRvbid0IGJvdGhlciBkb2luZyB0aGUgdXBkYXRlIHRoZW4uCgkgICAgICAgICAgICAgICAgaWYgKHN1YnNjcmliYWJsZSkgewoJICAgICAgICAgICAgICAgICAgICBzZWxmLl9zdWJzY3JpYmFibGUgPSBzdWJzY3JpYmFibGU7CgkgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgICAgICBzZWxmWyckcGFyZW50cyddID0gW107CgkgICAgICAgICAgICAgICAgc2VsZlsnJHJvb3QnXSA9IGRhdGFJdGVtOwoKCSAgICAgICAgICAgICAgICAvLyBFeHBvcnQgJ2tvJyBpbiB0aGUgYmluZGluZyBjb250ZXh0IHNvIGl0IHdpbGwgYmUgYXZhaWxhYmxlIGluIGJpbmRpbmdzIGFuZCB0ZW1wbGF0ZXMKCSAgICAgICAgICAgICAgICAvLyBldmVuIGlmICdrbycgaXNuJ3QgZXhwb3J0ZWQgYXMgYSBnbG9iYWwsIHN1Y2ggYXMgd2hlbiB1c2luZyBhbiBBTUQgbG9hZGVyLgoJICAgICAgICAgICAgICAgIC8vIFNlZSBodHRwczovL2dpdGh1Yi5jb20vU3RldmVTYW5kZXJzb24va25vY2tvdXQvaXNzdWVzLzQ5MAoJICAgICAgICAgICAgICAgIHNlbGZbJ2tvJ10gPSBrbzsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIHNlbGZbJyRyYXdEYXRhJ10gPSBkYXRhSXRlbU9yT2JzZXJ2YWJsZTsKCSAgICAgICAgICAgIHNlbGZbJyRkYXRhJ10gPSBkYXRhSXRlbTsKCSAgICAgICAgICAgIGlmIChkYXRhSXRlbUFsaWFzKQoJICAgICAgICAgICAgICAgIHNlbGZbZGF0YUl0ZW1BbGlhc10gPSBkYXRhSXRlbTsKCgkgICAgICAgICAgICAvLyBUaGUgZXh0ZW5kQ2FsbGJhY2sgZnVuY3Rpb24gaXMgcHJvdmlkZWQgd2hlbiBjcmVhdGluZyBhIGNoaWxkIGNvbnRleHQgb3IgZXh0ZW5kaW5nIGEgY29udGV4dC4KCSAgICAgICAgICAgIC8vIEl0IGhhbmRsZXMgdGhlIHNwZWNpZmljIGFjdGlvbnMgbmVlZGVkIHRvIGZpbmlzaCBzZXR0aW5nIHVwIHRoZSBiaW5kaW5nIGNvbnRleHQuIEFjdGlvbnMgaW4gdGhpcwoJICAgICAgICAgICAgLy8gZnVuY3Rpb24gY291bGQgYWxzbyBhZGQgZGVwZW5kZW5jaWVzIHRvIHRoaXMgYmluZGluZyBjb250ZXh0LgoJICAgICAgICAgICAgaWYgKGV4dGVuZENhbGxiYWNrKQoJICAgICAgICAgICAgICAgIGV4dGVuZENhbGxiYWNrKHNlbGYsIHBhcmVudENvbnRleHQsIGRhdGFJdGVtKTsKCgkgICAgICAgICAgICByZXR1cm4gc2VsZlsnJGRhdGEnXTsKCSAgICAgICAgfQoJICAgICAgICBmdW5jdGlvbiBkaXNwb3NlV2hlbigpIHsKCSAgICAgICAgICAgIHJldHVybiBub2RlcyAmJiAha28udXRpbHMuYW55RG9tTm9kZUlzQXR0YWNoZWRUb0RvY3VtZW50KG5vZGVzKTsKCSAgICAgICAgfQoKCSAgICAgICAgdmFyIHNlbGYgPSB0aGlzLAoJICAgICAgICAgICAgaXNGdW5jID0gdHlwZW9mKGRhdGFJdGVtT3JBY2Nlc3NvcikgPT0gImZ1bmN0aW9uIiAmJiAha28uaXNPYnNlcnZhYmxlKGRhdGFJdGVtT3JBY2Nlc3NvciksCgkgICAgICAgICAgICBub2RlcywKCSAgICAgICAgICAgIHN1YnNjcmliYWJsZSA9IGtvLmRlcGVuZGVudE9ic2VydmFibGUodXBkYXRlQ29udGV4dCwgbnVsbCwgeyBkaXNwb3NlV2hlbjogZGlzcG9zZVdoZW4sIGRpc3Bvc2VXaGVuTm9kZUlzUmVtb3ZlZDogdHJ1ZSB9KTsKCgkgICAgICAgIC8vIEF0IHRoaXMgcG9pbnQsIHRoZSBiaW5kaW5nIGNvbnRleHQgaGFzIGJlZW4gaW5pdGlhbGl6ZWQsIGFuZCB0aGUgInN1YnNjcmliYWJsZSIgY29tcHV0ZWQgb2JzZXJ2YWJsZSBpcwoJICAgICAgICAvLyBzdWJzY3JpYmVkIHRvIGFueSBvYnNlcnZhYmxlcyB0aGF0IHdlcmUgYWNjZXNzZWQgaW4gdGhlIHByb2Nlc3MuIElmIHRoZXJlIGlzIG5vdGhpbmcgdG8gdHJhY2ssIHRoZQoJICAgICAgICAvLyBjb21wdXRlZCB3aWxsIGJlIGluYWN0aXZlLCBhbmQgd2UgY2FuIHNhZmVseSB0aHJvdyBpdCBhd2F5LiBJZiBpdCdzIGFjdGl2ZSwgdGhlIGNvbXB1dGVkIGlzIHN0b3JlZCBpbgoJICAgICAgICAvLyB0aGUgY29udGV4dCBvYmplY3QuCgkgICAgICAgIGlmIChzdWJzY3JpYmFibGUuaXNBY3RpdmUoKSkgewoJICAgICAgICAgICAgc2VsZi5fc3Vic2NyaWJhYmxlID0gc3Vic2NyaWJhYmxlOwoKCSAgICAgICAgICAgIC8vIEFsd2F5cyBub3RpZnkgYmVjYXVzZSBldmVuIGlmIHRoZSBtb2RlbCAoJGRhdGEpIGhhc24ndCBjaGFuZ2VkLCBvdGhlciBjb250ZXh0IHByb3BlcnRpZXMgbWlnaHQgaGF2ZSBjaGFuZ2VkCgkgICAgICAgICAgICBzdWJzY3JpYmFibGVbJ2VxdWFsaXR5Q29tcGFyZXInXSA9IG51bGw7CgoJICAgICAgICAgICAgLy8gV2UgbmVlZCB0byBiZSBhYmxlIHRvIGRpc3Bvc2Ugb2YgdGhpcyBjb21wdXRlZCBvYnNlcnZhYmxlIHdoZW4gaXQncyBubyBsb25nZXIgbmVlZGVkLiBUaGlzIHdvdWxkIGJlCgkgICAgICAgICAgICAvLyBlYXN5IGlmIHdlIGhhZCBhIHNpbmdsZSBub2RlIHRvIHdhdGNoLCBidXQgYmluZGluZyBjb250ZXh0cyBjYW4gYmUgdXNlZCBieSBtYW55IGRpZmZlcmVudCBub2RlcywgYW5kCgkgICAgICAgICAgICAvLyB3ZSBjYW5ub3QgYXNzdW1lIHRoYXQgdGhvc2Ugbm9kZXMgaGF2ZSBhbnkgcmVsYXRpb24gdG8gZWFjaCBvdGhlci4gU28gaW5zdGVhZCB3ZSB0cmFjayBhbnkgbm9kZSB0aGF0CgkgICAgICAgICAgICAvLyB0aGUgY29udGV4dCBpcyBhdHRhY2hlZCB0bywgYW5kIGRpc3Bvc2UgdGhlIGNvbXB1dGVkIHdoZW4gYWxsIG9mIHRob3NlIG5vZGVzIGhhdmUgYmVlbiBjbGVhbmVkLgoKCSAgICAgICAgICAgIC8vIEFkZCBwcm9wZXJ0aWVzIHRvICpzdWJzY3JpYmFibGUqIGluc3RlYWQgb2YgKnNlbGYqIGJlY2F1c2UgYW55IHByb3BlcnRpZXMgYWRkZWQgdG8gKnNlbGYqIG1heSBiZSBvdmVyd3JpdHRlbiBvbiB1cGRhdGVzCgkgICAgICAgICAgICBub2RlcyA9IFtdOwoJICAgICAgICAgICAgc3Vic2NyaWJhYmxlLl9hZGROb2RlID0gZnVuY3Rpb24obm9kZSkgewoJICAgICAgICAgICAgICAgIG5vZGVzLnB1c2gobm9kZSk7CgkgICAgICAgICAgICAgICAga28udXRpbHMuZG9tTm9kZURpc3Bvc2FsLmFkZERpc3Bvc2VDYWxsYmFjayhub2RlLCBmdW5jdGlvbihub2RlKSB7CgkgICAgICAgICAgICAgICAgICAgIGtvLnV0aWxzLmFycmF5UmVtb3ZlSXRlbShub2Rlcywgbm9kZSk7CgkgICAgICAgICAgICAgICAgICAgIGlmICghbm9kZXMubGVuZ3RoKSB7CgkgICAgICAgICAgICAgICAgICAgICAgICBzdWJzY3JpYmFibGUuZGlzcG9zZSgpOwoJICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5fc3Vic2NyaWJhYmxlID0gc3Vic2NyaWJhYmxlID0gdW5kZWZpbmVkOwoJICAgICAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgfSk7CgkgICAgICAgICAgICB9OwoJICAgICAgICB9CgkgICAgfQoKCSAgICAvLyBFeHRlbmQgdGhlIGJpbmRpbmcgY29udGV4dCBoaWVyYXJjaHkgd2l0aCBhIG5ldyB2aWV3IG1vZGVsIG9iamVjdC4gSWYgdGhlIHBhcmVudCBjb250ZXh0IGlzIHdhdGNoaW5nCgkgICAgLy8gYW55IG9ic2V2YWJsZXMsIHRoZSBuZXcgY2hpbGQgY29udGV4dCB3aWxsIGF1dG9tYXRpY2FsbHkgZ2V0IGEgZGVwZW5kZW5jeSBvbiB0aGUgcGFyZW50IGNvbnRleHQuCgkgICAgLy8gQnV0IHRoaXMgZG9lcyBub3QgbWVhbiB0aGF0IHRoZSAkZGF0YSB2YWx1ZSBvZiB0aGUgY2hpbGQgY29udGV4dCB3aWxsIGFsc28gZ2V0IHVwZGF0ZWQuIElmIHRoZSBjaGlsZAoJICAgIC8vIHZpZXcgbW9kZWwgYWxzbyBkZXBlbmRzIG9uIHRoZSBwYXJlbnQgdmlldyBtb2RlbCwgeW91IG11c3QgcHJvdmlkZSBhIGZ1bmN0aW9uIHRoYXQgcmV0dXJucyB0aGUgY29ycmVjdAoJICAgIC8vIHZpZXcgbW9kZWwgb24gZWFjaCB1cGRhdGUuCgkgICAga28uYmluZGluZ0NvbnRleHQucHJvdG90eXBlWydjcmVhdGVDaGlsZENvbnRleHQnXSA9IGZ1bmN0aW9uIChkYXRhSXRlbU9yQWNjZXNzb3IsIGRhdGFJdGVtQWxpYXMsIGV4dGVuZENhbGxiYWNrKSB7CgkgICAgICAgIHJldHVybiBuZXcga28uYmluZGluZ0NvbnRleHQoZGF0YUl0ZW1PckFjY2Vzc29yLCB0aGlzLCBkYXRhSXRlbUFsaWFzLCBmdW5jdGlvbihzZWxmLCBwYXJlbnRDb250ZXh0KSB7CgkgICAgICAgICAgICAvLyBFeHRlbmQgdGhlIGNvbnRleHQgaGllcmFyY2h5IGJ5IHNldHRpbmcgdGhlIGFwcHJvcHJpYXRlIHBvaW50ZXJzCgkgICAgICAgICAgICBzZWxmWyckcGFyZW50Q29udGV4dCddID0gcGFyZW50Q29udGV4dDsKCSAgICAgICAgICAgIHNlbGZbJyRwYXJlbnQnXSA9IHBhcmVudENvbnRleHRbJyRkYXRhJ107CgkgICAgICAgICAgICBzZWxmWyckcGFyZW50cyddID0gKHBhcmVudENvbnRleHRbJyRwYXJlbnRzJ10gfHwgW10pLnNsaWNlKDApOwoJICAgICAgICAgICAgc2VsZlsnJHBhcmVudHMnXS51bnNoaWZ0KHNlbGZbJyRwYXJlbnQnXSk7CgkgICAgICAgICAgICBpZiAoZXh0ZW5kQ2FsbGJhY2spCgkgICAgICAgICAgICAgICAgZXh0ZW5kQ2FsbGJhY2soc2VsZik7CgkgICAgICAgIH0pOwoJICAgIH07CgoJICAgIC8vIEV4dGVuZCB0aGUgYmluZGluZyBjb250ZXh0IHdpdGggbmV3IGN1c3RvbSBwcm9wZXJ0aWVzLiBUaGlzIGRvZXNuJ3QgY2hhbmdlIHRoZSBjb250ZXh0IGhpZXJhcmNoeS4KCSAgICAvLyBTaW1pbGFybHkgdG8gImNoaWxkIiBjb250ZXh0cywgcHJvdmlkZSBhIGZ1bmN0aW9uIGhlcmUgdG8gbWFrZSBzdXJlIHRoYXQgdGhlIGNvcnJlY3QgdmFsdWVzIGFyZSBzZXQKCSAgICAvLyB3aGVuIGFuIG9ic2VydmFibGUgdmlldyBtb2RlbCBpcyB1cGRhdGVkLgoJICAgIGtvLmJpbmRpbmdDb250ZXh0LnByb3RvdHlwZVsnZXh0ZW5kJ10gPSBmdW5jdGlvbihwcm9wZXJ0aWVzKSB7CgkgICAgICAgIC8vIElmIHRoZSBwYXJlbnQgY29udGV4dCByZWZlcmVuY2VzIGFuIG9ic2VydmFibGUgdmlldyBtb2RlbCwgIl9zdWJzY3JpYmFibGUiIHdpbGwgYWx3YXlzIGJlIHRoZQoJICAgICAgICAvLyBsYXRlc3QgdmlldyBtb2RlbCBvYmplY3QuIElmIG5vdCwgIl9zdWJzY3JpYmFibGUiIGlzbid0IHNldCwgYW5kIHdlIGNhbiB1c2UgdGhlIHN0YXRpYyAiJGRhdGEiIHZhbHVlLgoJICAgICAgICByZXR1cm4gbmV3IGtvLmJpbmRpbmdDb250ZXh0KHRoaXMuX3N1YnNjcmliYWJsZSB8fCB0aGlzWyckZGF0YSddLCB0aGlzLCBudWxsLCBmdW5jdGlvbihzZWxmLCBwYXJlbnRDb250ZXh0KSB7CgkgICAgICAgICAgICAvLyBUaGlzICJjaGlsZCIgY29udGV4dCBkb2Vzbid0IGRpcmVjdGx5IHRyYWNrIGEgcGFyZW50IG9ic2VydmFibGUgdmlldyBtb2RlbCwKCSAgICAgICAgICAgIC8vIHNvIHdlIG5lZWQgdG8gbWFudWFsbHkgc2V0IHRoZSAkcmF3RGF0YSB2YWx1ZSB0byBtYXRjaCB0aGUgcGFyZW50LgoJICAgICAgICAgICAgc2VsZlsnJHJhd0RhdGEnXSA9IHBhcmVudENvbnRleHRbJyRyYXdEYXRhJ107CgkgICAgICAgICAgICBrby51dGlscy5leHRlbmQoc2VsZiwgdHlwZW9mKHByb3BlcnRpZXMpID09ICJmdW5jdGlvbiIgPyBwcm9wZXJ0aWVzKCkgOiBwcm9wZXJ0aWVzKTsKCSAgICAgICAgfSk7CgkgICAgfTsKCgkgICAgLy8gUmV0dXJucyB0aGUgdmFsdWVBY2Nlc29yIGZ1bmN0aW9uIGZvciBhIGJpbmRpbmcgdmFsdWUKCSAgICBmdW5jdGlvbiBtYWtlVmFsdWVBY2Nlc3Nvcih2YWx1ZSkgewoJICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CgkgICAgICAgICAgICByZXR1cm4gdmFsdWU7CgkgICAgICAgIH07CgkgICAgfQoKCSAgICAvLyBSZXR1cm5zIHRoZSB2YWx1ZSBvZiBhIHZhbHVlQWNjZXNzb3IgZnVuY3Rpb24KCSAgICBmdW5jdGlvbiBldmFsdWF0ZVZhbHVlQWNjZXNzb3IodmFsdWVBY2Nlc3NvcikgewoJICAgICAgICByZXR1cm4gdmFsdWVBY2Nlc3NvcigpOwoJICAgIH0KCgkgICAgLy8gR2l2ZW4gYSBmdW5jdGlvbiB0aGF0IHJldHVybnMgYmluZGluZ3MsIGNyZWF0ZSBhbmQgcmV0dXJuIGEgbmV3IG9iamVjdCB0aGF0IGNvbnRhaW5zCgkgICAgLy8gYmluZGluZyB2YWx1ZS1hY2Nlc3NvcnMgZnVuY3Rpb25zLiBFYWNoIGFjY2Vzc29yIGZ1bmN0aW9uIGNhbGxzIHRoZSBvcmlnaW5hbCBmdW5jdGlvbgoJICAgIC8vIHNvIHRoYXQgaXQgYWx3YXlzIGdldHMgdGhlIGxhdGVzdCB2YWx1ZSBhbmQgYWxsIGRlcGVuZGVuY2llcyBhcmUgY2FwdHVyZWQuIFRoaXMgaXMgdXNlZAoJICAgIC8vIGJ5IGtvLmFwcGx5QmluZGluZ3NUb05vZGUgYW5kIGdldEJpbmRpbmdzQW5kTWFrZUFjY2Vzc29ycy4KCSAgICBmdW5jdGlvbiBtYWtlQWNjZXNzb3JzRnJvbUZ1bmN0aW9uKGNhbGxiYWNrKSB7CgkgICAgICAgIHJldHVybiBrby51dGlscy5vYmplY3RNYXAoa28uZGVwZW5kZW5jeURldGVjdGlvbi5pZ25vcmUoY2FsbGJhY2spLCBmdW5jdGlvbih2YWx1ZSwga2V5KSB7CgkgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CgkgICAgICAgICAgICAgICAgcmV0dXJuIGNhbGxiYWNrKClba2V5XTsKCSAgICAgICAgICAgIH07CgkgICAgICAgIH0pOwoJICAgIH0KCgkgICAgLy8gR2l2ZW4gYSBiaW5kaW5ncyBmdW5jdGlvbiBvciBvYmplY3QsIGNyZWF0ZSBhbmQgcmV0dXJuIGEgbmV3IG9iamVjdCB0aGF0IGNvbnRhaW5zCgkgICAgLy8gYmluZGluZyB2YWx1ZS1hY2Nlc3NvcnMgZnVuY3Rpb25zLiBUaGlzIGlzIHVzZWQgYnkga28uYXBwbHlCaW5kaW5nc1RvTm9kZS4KCSAgICBmdW5jdGlvbiBtYWtlQmluZGluZ0FjY2Vzc29ycyhiaW5kaW5ncywgY29udGV4dCwgbm9kZSkgewoJICAgICAgICBpZiAodHlwZW9mIGJpbmRpbmdzID09PSAnZnVuY3Rpb24nKSB7CgkgICAgICAgICAgICByZXR1cm4gbWFrZUFjY2Vzc29yc0Zyb21GdW5jdGlvbihiaW5kaW5ncy5iaW5kKG51bGwsIGNvbnRleHQsIG5vZGUpKTsKCSAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgIHJldHVybiBrby51dGlscy5vYmplY3RNYXAoYmluZGluZ3MsIG1ha2VWYWx1ZUFjY2Vzc29yKTsKCSAgICAgICAgfQoJICAgIH0KCgkgICAgLy8gVGhpcyBmdW5jdGlvbiBpcyB1c2VkIGlmIHRoZSBiaW5kaW5nIHByb3ZpZGVyIGRvZXNuJ3QgaW5jbHVkZSBhIGdldEJpbmRpbmdBY2Nlc3NvcnMgZnVuY3Rpb24uCgkgICAgLy8gSXQgbXVzdCBiZSBjYWxsZWQgd2l0aCAndGhpcycgc2V0IHRvIHRoZSBwcm92aWRlciBpbnN0YW5jZS4KCSAgICBmdW5jdGlvbiBnZXRCaW5kaW5nc0FuZE1ha2VBY2Nlc3NvcnMobm9kZSwgY29udGV4dCkgewoJICAgICAgICByZXR1cm4gbWFrZUFjY2Vzc29yc0Zyb21GdW5jdGlvbih0aGlzWydnZXRCaW5kaW5ncyddLmJpbmQodGhpcywgbm9kZSwgY29udGV4dCkpOwoJICAgIH0KCgkgICAgZnVuY3Rpb24gdmFsaWRhdGVUaGF0QmluZGluZ0lzQWxsb3dlZEZvclZpcnR1YWxFbGVtZW50cyhiaW5kaW5nTmFtZSkgewoJICAgICAgICB2YXIgdmFsaWRhdG9yID0ga28udmlydHVhbEVsZW1lbnRzLmFsbG93ZWRCaW5kaW5nc1tiaW5kaW5nTmFtZV07CgkgICAgICAgIGlmICghdmFsaWRhdG9yKQoJICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUaGUgYmluZGluZyAnIiArIGJpbmRpbmdOYW1lICsgIicgY2Fubm90IGJlIHVzZWQgd2l0aCB2aXJ0dWFsIGVsZW1lbnRzIikKCSAgICB9CgoJICAgIGZ1bmN0aW9uIGFwcGx5QmluZGluZ3NUb0Rlc2NlbmRhbnRzSW50ZXJuYWwgKGJpbmRpbmdDb250ZXh0LCBlbGVtZW50T3JWaXJ0dWFsRWxlbWVudCwgYmluZGluZ0NvbnRleHRzTWF5RGlmZmVyRnJvbURvbVBhcmVudEVsZW1lbnQpIHsKCSAgICAgICAgdmFyIGN1cnJlbnRDaGlsZCwKCSAgICAgICAgICAgIG5leHRJblF1ZXVlID0ga28udmlydHVhbEVsZW1lbnRzLmZpcnN0Q2hpbGQoZWxlbWVudE9yVmlydHVhbEVsZW1lbnQpLAoJICAgICAgICAgICAgcHJvdmlkZXIgPSBrby5iaW5kaW5nUHJvdmlkZXJbJ2luc3RhbmNlJ10sCgkgICAgICAgICAgICBwcmVwcm9jZXNzTm9kZSA9IHByb3ZpZGVyWydwcmVwcm9jZXNzTm9kZSddOwoKCSAgICAgICAgLy8gUHJlcHJvY2Vzc2luZyBhbGxvd3MgYSBiaW5kaW5nIHByb3ZpZGVyIHRvIG11dGF0ZSBhIG5vZGUgYmVmb3JlIGJpbmRpbmdzIGFyZSBhcHBsaWVkIHRvIGl0LiBGb3IgZXhhbXBsZSBpdCdzCgkgICAgICAgIC8vIHBvc3NpYmxlIHRvIGluc2VydCBuZXcgc2libGluZ3MgYWZ0ZXIgaXQsIGFuZC9vciByZXBsYWNlIHRoZSBub2RlIHdpdGggYSBkaWZmZXJlbnQgb25lLiBUaGlzIGNhbiBiZSB1c2VkIHRvCgkgICAgICAgIC8vIGltcGxlbWVudCBjdXN0b20gYmluZGluZyBzeW50YXhlcywgc3VjaCBhcyB7eyB2YWx1ZSB9fSBmb3Igc3RyaW5nIGludGVycG9sYXRpb24sIG9yIGN1c3RvbSBlbGVtZW50IHR5cGVzIHRoYXQKCSAgICAgICAgLy8gdHJpZ2dlciBpbnNlcnRpb24gb2YgPHRlbXBsYXRlPiBjb250ZW50cyBhdCB0aGF0IHBvaW50IGluIHRoZSBkb2N1bWVudC4KCSAgICAgICAgaWYgKHByZXByb2Nlc3NOb2RlKSB7CgkgICAgICAgICAgICB3aGlsZSAoY3VycmVudENoaWxkID0gbmV4dEluUXVldWUpIHsKCSAgICAgICAgICAgICAgICBuZXh0SW5RdWV1ZSA9IGtvLnZpcnR1YWxFbGVtZW50cy5uZXh0U2libGluZyhjdXJyZW50Q2hpbGQpOwoJICAgICAgICAgICAgICAgIHByZXByb2Nlc3NOb2RlLmNhbGwocHJvdmlkZXIsIGN1cnJlbnRDaGlsZCk7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICAvLyBSZXNldCBuZXh0SW5RdWV1ZSBmb3IgdGhlIG5leHQgbG9vcAoJICAgICAgICAgICAgbmV4dEluUXVldWUgPSBrby52aXJ0dWFsRWxlbWVudHMuZmlyc3RDaGlsZChlbGVtZW50T3JWaXJ0dWFsRWxlbWVudCk7CgkgICAgICAgIH0KCgkgICAgICAgIHdoaWxlIChjdXJyZW50Q2hpbGQgPSBuZXh0SW5RdWV1ZSkgewoJICAgICAgICAgICAgLy8gS2VlcCBhIHJlY29yZCBvZiB0aGUgbmV4dCBjaGlsZCAqYmVmb3JlKiBhcHBseWluZyBiaW5kaW5ncywgaW4gY2FzZSB0aGUgYmluZGluZyByZW1vdmVzIHRoZSBjdXJyZW50IGNoaWxkIGZyb20gaXRzIHBvc2l0aW9uCgkgICAgICAgICAgICBuZXh0SW5RdWV1ZSA9IGtvLnZpcnR1YWxFbGVtZW50cy5uZXh0U2libGluZyhjdXJyZW50Q2hpbGQpOwoJICAgICAgICAgICAgYXBwbHlCaW5kaW5nc1RvTm9kZUFuZERlc2NlbmRhbnRzSW50ZXJuYWwoYmluZGluZ0NvbnRleHQsIGN1cnJlbnRDaGlsZCwgYmluZGluZ0NvbnRleHRzTWF5RGlmZmVyRnJvbURvbVBhcmVudEVsZW1lbnQpOwoJICAgICAgICB9CgkgICAgfQoKCSAgICBmdW5jdGlvbiBhcHBseUJpbmRpbmdzVG9Ob2RlQW5kRGVzY2VuZGFudHNJbnRlcm5hbCAoYmluZGluZ0NvbnRleHQsIG5vZGVWZXJpZmllZCwgYmluZGluZ0NvbnRleHRNYXlEaWZmZXJGcm9tRG9tUGFyZW50RWxlbWVudCkgewoJICAgICAgICB2YXIgc2hvdWxkQmluZERlc2NlbmRhbnRzID0gdHJ1ZTsKCgkgICAgICAgIC8vIFBlcmYgb3B0aW1pc2F0aW9uOiBBcHBseSBiaW5kaW5ncyBvbmx5IGlmLi4uCgkgICAgICAgIC8vICgxKSBXZSBuZWVkIHRvIHN0b3JlIHRoZSBiaW5kaW5nIGNvbnRleHQgb24gdGhpcyBub2RlIChiZWNhdXNlIGl0IG1heSBkaWZmZXIgZnJvbSB0aGUgRE9NIHBhcmVudCBub2RlJ3MgYmluZGluZyBjb250ZXh0KQoJICAgICAgICAvLyAgICAgTm90ZSB0aGF0IHdlIGNhbid0IHN0b3JlIGJpbmRpbmcgY29udGV4dHMgb24gbm9uLWVsZW1lbnRzIChlLmcuLCB0ZXh0IG5vZGVzKSwgYXMgSUUgZG9lc24ndCBhbGxvdyBleHBhbmRvIHByb3BlcnRpZXMgZm9yIHRob3NlCgkgICAgICAgIC8vICgyKSBJdCBtaWdodCBoYXZlIGJpbmRpbmdzIChlLmcuLCBpdCBoYXMgYSBkYXRhLWJpbmQgYXR0cmlidXRlLCBvciBpdCdzIGEgbWFya2VyIGZvciBhIGNvbnRhaW5lcmxlc3MgdGVtcGxhdGUpCgkgICAgICAgIHZhciBpc0VsZW1lbnQgPSAobm9kZVZlcmlmaWVkLm5vZGVUeXBlID09PSAxKTsKCSAgICAgICAgaWYgKGlzRWxlbWVudCkgLy8gV29ya2Fyb3VuZCBJRSA8PSA4IEhUTUwgcGFyc2luZyB3ZWlyZG5lc3MKCSAgICAgICAgICAgIGtvLnZpcnR1YWxFbGVtZW50cy5ub3JtYWxpc2VWaXJ0dWFsRWxlbWVudERvbVN0cnVjdHVyZShub2RlVmVyaWZpZWQpOwoKCSAgICAgICAgdmFyIHNob3VsZEFwcGx5QmluZGluZ3MgPSAoaXNFbGVtZW50ICYmIGJpbmRpbmdDb250ZXh0TWF5RGlmZmVyRnJvbURvbVBhcmVudEVsZW1lbnQpICAgICAgICAgICAgIC8vIENhc2UgKDEpCgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfHwga28uYmluZGluZ1Byb3ZpZGVyWydpbnN0YW5jZSddWydub2RlSGFzQmluZGluZ3MnXShub2RlVmVyaWZpZWQpOyAgICAgICAvLyBDYXNlICgyKQoJICAgICAgICBpZiAoc2hvdWxkQXBwbHlCaW5kaW5ncykKCSAgICAgICAgICAgIHNob3VsZEJpbmREZXNjZW5kYW50cyA9IGFwcGx5QmluZGluZ3NUb05vZGVJbnRlcm5hbChub2RlVmVyaWZpZWQsIG51bGwsIGJpbmRpbmdDb250ZXh0LCBiaW5kaW5nQ29udGV4dE1heURpZmZlckZyb21Eb21QYXJlbnRFbGVtZW50KVsnc2hvdWxkQmluZERlc2NlbmRhbnRzJ107CgoJICAgICAgICBpZiAoc2hvdWxkQmluZERlc2NlbmRhbnRzICYmICFiaW5kaW5nRG9lc05vdFJlY3Vyc2VJbnRvRWxlbWVudFR5cGVzW2tvLnV0aWxzLnRhZ05hbWVMb3dlcihub2RlVmVyaWZpZWQpXSkgewoJICAgICAgICAgICAgLy8gV2UncmUgcmVjdXJzaW5nIGF1dG9tYXRpY2FsbHkgaW50byAocmVhbCBvciB2aXJ0dWFsKSBjaGlsZCBub2RlcyB3aXRob3V0IGNoYW5naW5nIGJpbmRpbmcgY29udGV4dHMuIFNvLAoJICAgICAgICAgICAgLy8gICogRm9yIGNoaWxkcmVuIG9mIGEgKnJlYWwqIGVsZW1lbnQsIHRoZSBiaW5kaW5nIGNvbnRleHQgaXMgY2VydGFpbmx5IHRoZSBzYW1lIGFzIG9uIHRoZWlyIERPTSAucGFyZW50Tm9kZSwKCSAgICAgICAgICAgIC8vICAgIGhlbmNlIGJpbmRpbmdDb250ZXh0c01heURpZmZlckZyb21Eb21QYXJlbnRFbGVtZW50IGlzIGZhbHNlCgkgICAgICAgICAgICAvLyAgKiBGb3IgY2hpbGRyZW4gb2YgYSAqdmlydHVhbCogZWxlbWVudCwgd2UgY2FuJ3QgYmUgc3VyZS4gRXZhbHVhdGluZyAucGFyZW50Tm9kZSBvbiB0aG9zZSBjaGlsZHJlbiBtYXkKCSAgICAgICAgICAgIC8vICAgIHNraXAgb3ZlciBhbnkgbnVtYmVyIG9mIGludGVybWVkaWF0ZSB2aXJ0dWFsIGVsZW1lbnRzLCBhbnkgb2Ygd2hpY2ggbWlnaHQgZGVmaW5lIGEgY3VzdG9tIGJpbmRpbmcgY29udGV4dCwKCSAgICAgICAgICAgIC8vICAgIGhlbmNlIGJpbmRpbmdDb250ZXh0c01heURpZmZlckZyb21Eb21QYXJlbnRFbGVtZW50IGlzIHRydWUKCSAgICAgICAgICAgIGFwcGx5QmluZGluZ3NUb0Rlc2NlbmRhbnRzSW50ZXJuYWwoYmluZGluZ0NvbnRleHQsIG5vZGVWZXJpZmllZCwgLyogYmluZGluZ0NvbnRleHRzTWF5RGlmZmVyRnJvbURvbVBhcmVudEVsZW1lbnQ6ICovICFpc0VsZW1lbnQpOwoJICAgICAgICB9CgkgICAgfQoKCSAgICB2YXIgYm91bmRFbGVtZW50RG9tRGF0YUtleSA9IGtvLnV0aWxzLmRvbURhdGEubmV4dEtleSgpOwoKCgkgICAgZnVuY3Rpb24gdG9wb2xvZ2ljYWxTb3J0QmluZGluZ3MoYmluZGluZ3MpIHsKCSAgICAgICAgLy8gRGVwdGgtZmlyc3Qgc29ydAoJICAgICAgICB2YXIgcmVzdWx0ID0gW10sICAgICAgICAgICAgICAgIC8vIFRoZSBsaXN0IG9mIGtleS9oYW5kbGVyIHBhaXJzIHRoYXQgd2Ugd2lsbCByZXR1cm4KCSAgICAgICAgICAgIGJpbmRpbmdzQ29uc2lkZXJlZCA9IHt9LCAgICAvLyBBIHRlbXBvcmFyeSByZWNvcmQgb2Ygd2hpY2ggYmluZGluZ3MgYXJlIGFscmVhZHkgaW4gJ3Jlc3VsdCcKCSAgICAgICAgICAgIGN5Y2xpY0RlcGVuZGVuY3lTdGFjayA9IFtdOyAvLyBLZWVwcyB0cmFjayBvZiBhIGRlcHRoLXNlYXJjaCBzbyB0aGF0LCBpZiB0aGVyZSdzIGEgY3ljbGUsIHdlIGtub3cgd2hpY2ggYmluZGluZ3MgY2F1c2VkIGl0CgkgICAgICAgIGtvLnV0aWxzLm9iamVjdEZvckVhY2goYmluZGluZ3MsIGZ1bmN0aW9uIHB1c2hCaW5kaW5nKGJpbmRpbmdLZXkpIHsKCSAgICAgICAgICAgIGlmICghYmluZGluZ3NDb25zaWRlcmVkW2JpbmRpbmdLZXldKSB7CgkgICAgICAgICAgICAgICAgdmFyIGJpbmRpbmcgPSBrb1snZ2V0QmluZGluZ0hhbmRsZXInXShiaW5kaW5nS2V5KTsKCSAgICAgICAgICAgICAgICBpZiAoYmluZGluZykgewoJICAgICAgICAgICAgICAgICAgICAvLyBGaXJzdCBhZGQgZGVwZW5kZW5jaWVzIChpZiBhbnkpIG9mIHRoZSBjdXJyZW50IGJpbmRpbmcKCSAgICAgICAgICAgICAgICAgICAgaWYgKGJpbmRpbmdbJ2FmdGVyJ10pIHsKCSAgICAgICAgICAgICAgICAgICAgICAgIGN5Y2xpY0RlcGVuZGVuY3lTdGFjay5wdXNoKGJpbmRpbmdLZXkpOwoJICAgICAgICAgICAgICAgICAgICAgICAga28udXRpbHMuYXJyYXlGb3JFYWNoKGJpbmRpbmdbJ2FmdGVyJ10sIGZ1bmN0aW9uKGJpbmRpbmdEZXBlbmRlbmN5S2V5KSB7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGJpbmRpbmdzW2JpbmRpbmdEZXBlbmRlbmN5S2V5XSkgewoJICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoa28udXRpbHMuYXJyYXlJbmRleE9mKGN5Y2xpY0RlcGVuZGVuY3lTdGFjaywgYmluZGluZ0RlcGVuZGVuY3lLZXkpICE9PSAtMSkgewoJICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoIkNhbm5vdCBjb21iaW5lIHRoZSBmb2xsb3dpbmcgYmluZGluZ3MsIGJlY2F1c2UgdGhleSBoYXZlIGEgY3ljbGljIGRlcGVuZGVuY3k6ICIgKyBjeWNsaWNEZXBlbmRlbmN5U3RhY2suam9pbigiLCAiKSk7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwdXNoQmluZGluZyhiaW5kaW5nRGVwZW5kZW5jeUtleSk7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgICAgICAgICB9KTsKCSAgICAgICAgICAgICAgICAgICAgICAgIGN5Y2xpY0RlcGVuZGVuY3lTdGFjay5sZW5ndGgtLTsKCSAgICAgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgICAgICAvLyBOZXh0IGFkZCB0aGUgY3VycmVudCBiaW5kaW5nCgkgICAgICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKHsga2V5OiBiaW5kaW5nS2V5LCBoYW5kbGVyOiBiaW5kaW5nIH0pOwoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICBiaW5kaW5nc0NvbnNpZGVyZWRbYmluZGluZ0tleV0gPSB0cnVlOwoJICAgICAgICAgICAgfQoJICAgICAgICB9KTsKCgkgICAgICAgIHJldHVybiByZXN1bHQ7CgkgICAgfQoKCSAgICBmdW5jdGlvbiBhcHBseUJpbmRpbmdzVG9Ob2RlSW50ZXJuYWwobm9kZSwgc291cmNlQmluZGluZ3MsIGJpbmRpbmdDb250ZXh0LCBiaW5kaW5nQ29udGV4dE1heURpZmZlckZyb21Eb21QYXJlbnRFbGVtZW50KSB7CgkgICAgICAgIC8vIFByZXZlbnQgbXVsdGlwbGUgYXBwbHlCaW5kaW5ncyBjYWxscyBmb3IgdGhlIHNhbWUgbm9kZSwgZXhjZXB0IHdoZW4gYSBiaW5kaW5nIHZhbHVlIGlzIHNwZWNpZmllZAoJICAgICAgICB2YXIgYWxyZWFkeUJvdW5kID0ga28udXRpbHMuZG9tRGF0YS5nZXQobm9kZSwgYm91bmRFbGVtZW50RG9tRGF0YUtleSk7CgkgICAgICAgIGlmICghc291cmNlQmluZGluZ3MpIHsKCSAgICAgICAgICAgIGlmIChhbHJlYWR5Qm91bmQpIHsKCSAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcigiWW91IGNhbm5vdCBhcHBseSBiaW5kaW5ncyBtdWx0aXBsZSB0aW1lcyB0byB0aGUgc2FtZSBlbGVtZW50LiIpOwoJICAgICAgICAgICAgfQoJICAgICAgICAgICAga28udXRpbHMuZG9tRGF0YS5zZXQobm9kZSwgYm91bmRFbGVtZW50RG9tRGF0YUtleSwgdHJ1ZSk7CgkgICAgICAgIH0KCgkgICAgICAgIC8vIE9wdGltaXphdGlvbjogRG9uJ3Qgc3RvcmUgdGhlIGJpbmRpbmcgY29udGV4dCBvbiB0aGlzIG5vZGUgaWYgaXQncyBkZWZpbml0ZWx5IHRoZSBzYW1lIGFzIG9uIG5vZGUucGFyZW50Tm9kZSwgYmVjYXVzZQoJICAgICAgICAvLyB3ZSBjYW4gZWFzaWx5IHJlY292ZXIgaXQganVzdCBieSBzY2FubmluZyB1cCB0aGUgbm9kZSdzIGFuY2VzdG9ycyBpbiB0aGUgRE9NCgkgICAgICAgIC8vIChub3RlOiBoZXJlLCBwYXJlbnQgbm9kZSBtZWFucyAicmVhbCBET00gcGFyZW50IiBub3QgInZpcnR1YWwgcGFyZW50IiwgYXMgdGhlcmUncyBubyBPKDEpIHdheSB0byBmaW5kIHRoZSB2aXJ0dWFsIHBhcmVudCkKCSAgICAgICAgaWYgKCFhbHJlYWR5Qm91bmQgJiYgYmluZGluZ0NvbnRleHRNYXlEaWZmZXJGcm9tRG9tUGFyZW50RWxlbWVudCkKCSAgICAgICAgICAgIGtvLnN0b3JlZEJpbmRpbmdDb250ZXh0Rm9yTm9kZShub2RlLCBiaW5kaW5nQ29udGV4dCk7CgoJICAgICAgICAvLyBVc2UgYmluZGluZ3MgaWYgZ2l2ZW4sIG90aGVyd2lzZSBmYWxsIGJhY2sgb24gYXNraW5nIHRoZSBiaW5kaW5ncyBwcm92aWRlciB0byBnaXZlIHVzIHNvbWUgYmluZGluZ3MKCSAgICAgICAgdmFyIGJpbmRpbmdzOwoJICAgICAgICBpZiAoc291cmNlQmluZGluZ3MgJiYgdHlwZW9mIHNvdXJjZUJpbmRpbmdzICE9PSAnZnVuY3Rpb24nKSB7CgkgICAgICAgICAgICBiaW5kaW5ncyA9IHNvdXJjZUJpbmRpbmdzOwoJICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgdmFyIHByb3ZpZGVyID0ga28uYmluZGluZ1Byb3ZpZGVyWydpbnN0YW5jZSddLAoJICAgICAgICAgICAgICAgIGdldEJpbmRpbmdzID0gcHJvdmlkZXJbJ2dldEJpbmRpbmdBY2Nlc3NvcnMnXSB8fCBnZXRCaW5kaW5nc0FuZE1ha2VBY2Nlc3NvcnM7CgoJICAgICAgICAgICAgLy8gR2V0IHRoZSBiaW5kaW5nIGZyb20gdGhlIHByb3ZpZGVyIHdpdGhpbiBhIGNvbXB1dGVkIG9ic2VydmFibGUgc28gdGhhdCB3ZSBjYW4gdXBkYXRlIHRoZSBiaW5kaW5ncyB3aGVuZXZlcgoJICAgICAgICAgICAgLy8gdGhlIGJpbmRpbmcgY29udGV4dCBpcyB1cGRhdGVkIG9yIGlmIHRoZSBiaW5kaW5nIHByb3ZpZGVyIGFjY2Vzc2VzIG9ic2VydmFibGVzLgoJICAgICAgICAgICAgdmFyIGJpbmRpbmdzVXBkYXRlciA9IGtvLmRlcGVuZGVudE9ic2VydmFibGUoCgkgICAgICAgICAgICAgICAgZnVuY3Rpb24oKSB7CgkgICAgICAgICAgICAgICAgICAgIGJpbmRpbmdzID0gc291cmNlQmluZGluZ3MgPyBzb3VyY2VCaW5kaW5ncyhiaW5kaW5nQ29udGV4dCwgbm9kZSkgOiBnZXRCaW5kaW5ncy5jYWxsKHByb3ZpZGVyLCBub2RlLCBiaW5kaW5nQ29udGV4dCk7CgkgICAgICAgICAgICAgICAgICAgIC8vIFJlZ2lzdGVyIGEgZGVwZW5kZW5jeSBvbiB0aGUgYmluZGluZyBjb250ZXh0IHRvIHN1cHBvcnQgb2JzZXZhYmxlIHZpZXcgbW9kZWxzLgoJICAgICAgICAgICAgICAgICAgICBpZiAoYmluZGluZ3MgJiYgYmluZGluZ0NvbnRleHQuX3N1YnNjcmliYWJsZSkKCSAgICAgICAgICAgICAgICAgICAgICAgIGJpbmRpbmdDb250ZXh0Ll9zdWJzY3JpYmFibGUoKTsKCSAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGJpbmRpbmdzOwoJICAgICAgICAgICAgICAgIH0sCgkgICAgICAgICAgICAgICAgbnVsbCwgeyBkaXNwb3NlV2hlbk5vZGVJc1JlbW92ZWQ6IG5vZGUgfQoJICAgICAgICAgICAgKTsKCgkgICAgICAgICAgICBpZiAoIWJpbmRpbmdzIHx8ICFiaW5kaW5nc1VwZGF0ZXIuaXNBY3RpdmUoKSkKCSAgICAgICAgICAgICAgICBiaW5kaW5nc1VwZGF0ZXIgPSBudWxsOwoJICAgICAgICB9CgoJICAgICAgICB2YXIgYmluZGluZ0hhbmRsZXJUaGF0Q29udHJvbHNEZXNjZW5kYW50QmluZGluZ3M7CgkgICAgICAgIGlmIChiaW5kaW5ncykgewoJICAgICAgICAgICAgLy8gUmV0dXJuIHRoZSB2YWx1ZSBhY2Nlc3NvciBmb3IgYSBnaXZlbiBiaW5kaW5nLiBXaGVuIGJpbmRpbmdzIGFyZSBzdGF0aWMgKHdvbid0IGJlIHVwZGF0ZWQgYmVjYXVzZSBvZiBhIGJpbmRpbmcKCSAgICAgICAgICAgIC8vIGNvbnRleHQgdXBkYXRlKSwganVzdCByZXR1cm4gdGhlIHZhbHVlIGFjY2Vzc29yIGZyb20gdGhlIGJpbmRpbmcuIE90aGVyd2lzZSwgcmV0dXJuIGEgZnVuY3Rpb24gdGhhdCBhbHdheXMgZ2V0cwoJICAgICAgICAgICAgLy8gdGhlIGxhdGVzdCBiaW5kaW5nIHZhbHVlIGFuZCByZWdpc3RlcnMgYSBkZXBlbmRlbmN5IG9uIHRoZSBiaW5kaW5nIHVwZGF0ZXIuCgkgICAgICAgICAgICB2YXIgZ2V0VmFsdWVBY2Nlc3NvciA9IGJpbmRpbmdzVXBkYXRlcgoJICAgICAgICAgICAgICAgID8gZnVuY3Rpb24oYmluZGluZ0tleSkgewoJICAgICAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CgkgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZXZhbHVhdGVWYWx1ZUFjY2Vzc29yKGJpbmRpbmdzVXBkYXRlcigpW2JpbmRpbmdLZXldKTsKCSAgICAgICAgICAgICAgICAgICAgfTsKCSAgICAgICAgICAgICAgICB9IDogZnVuY3Rpb24oYmluZGluZ0tleSkgewoJICAgICAgICAgICAgICAgICAgICByZXR1cm4gYmluZGluZ3NbYmluZGluZ0tleV07CgkgICAgICAgICAgICAgICAgfTsKCgkgICAgICAgICAgICAvLyBVc2Ugb2YgYWxsQmluZGluZ3MgYXMgYSBmdW5jdGlvbiBpcyBtYWludGFpbmVkIGZvciBiYWNrd2FyZHMgY29tcGF0aWJpbGl0eSwgYnV0IGl0cyB1c2UgaXMgZGVwcmVjYXRlZAoJICAgICAgICAgICAgZnVuY3Rpb24gYWxsQmluZGluZ3MoKSB7CgkgICAgICAgICAgICAgICAgcmV0dXJuIGtvLnV0aWxzLm9iamVjdE1hcChiaW5kaW5nc1VwZGF0ZXIgPyBiaW5kaW5nc1VwZGF0ZXIoKSA6IGJpbmRpbmdzLCBldmFsdWF0ZVZhbHVlQWNjZXNzb3IpOwoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgLy8gVGhlIGZvbGxvd2luZyBpcyB0aGUgMy54IGFsbEJpbmRpbmdzIEFQSQoJICAgICAgICAgICAgYWxsQmluZGluZ3NbJ2dldCddID0gZnVuY3Rpb24oa2V5KSB7CgkgICAgICAgICAgICAgICAgcmV0dXJuIGJpbmRpbmdzW2tleV0gJiYgZXZhbHVhdGVWYWx1ZUFjY2Vzc29yKGdldFZhbHVlQWNjZXNzb3Ioa2V5KSk7CgkgICAgICAgICAgICB9OwoJICAgICAgICAgICAgYWxsQmluZGluZ3NbJ2hhcyddID0gZnVuY3Rpb24oa2V5KSB7CgkgICAgICAgICAgICAgICAgcmV0dXJuIGtleSBpbiBiaW5kaW5nczsKCSAgICAgICAgICAgIH07CgoJICAgICAgICAgICAgLy8gRmlyc3QgcHV0IHRoZSBiaW5kaW5ncyBpbnRvIHRoZSByaWdodCBvcmRlcgoJICAgICAgICAgICAgdmFyIG9yZGVyZWRCaW5kaW5ncyA9IHRvcG9sb2dpY2FsU29ydEJpbmRpbmdzKGJpbmRpbmdzKTsKCgkgICAgICAgICAgICAvLyBHbyB0aHJvdWdoIHRoZSBzb3J0ZWQgYmluZGluZ3MsIGNhbGxpbmcgaW5pdCBhbmQgdXBkYXRlIGZvciBlYWNoCgkgICAgICAgICAgICBrby51dGlscy5hcnJheUZvckVhY2gob3JkZXJlZEJpbmRpbmdzLCBmdW5jdGlvbihiaW5kaW5nS2V5QW5kSGFuZGxlcikgewoJICAgICAgICAgICAgICAgIC8vIE5vdGUgdGhhdCB0b3BvbG9naWNhbFNvcnRCaW5kaW5ncyBoYXMgYWxyZWFkeSBmaWx0ZXJlZCBvdXQgYW55IG5vbmV4aXN0ZW50IGJpbmRpbmcgaGFuZGxlcnMsCgkgICAgICAgICAgICAgICAgLy8gc28gYmluZGluZ0tleUFuZEhhbmRsZXIuaGFuZGxlciB3aWxsIGFsd2F5cyBiZSBub25udWxsLgoJICAgICAgICAgICAgICAgIHZhciBoYW5kbGVySW5pdEZuID0gYmluZGluZ0tleUFuZEhhbmRsZXIuaGFuZGxlclsiaW5pdCJdLAoJICAgICAgICAgICAgICAgICAgICBoYW5kbGVyVXBkYXRlRm4gPSBiaW5kaW5nS2V5QW5kSGFuZGxlci5oYW5kbGVyWyJ1cGRhdGUiXSwKCSAgICAgICAgICAgICAgICAgICAgYmluZGluZ0tleSA9IGJpbmRpbmdLZXlBbmRIYW5kbGVyLmtleTsKCgkgICAgICAgICAgICAgICAgaWYgKG5vZGUubm9kZVR5cGUgPT09IDgpIHsKCSAgICAgICAgICAgICAgICAgICAgdmFsaWRhdGVUaGF0QmluZGluZ0lzQWxsb3dlZEZvclZpcnR1YWxFbGVtZW50cyhiaW5kaW5nS2V5KTsKCSAgICAgICAgICAgICAgICB9CgoJICAgICAgICAgICAgICAgIHRyeSB7CgkgICAgICAgICAgICAgICAgICAgIC8vIFJ1biBpbml0LCBpZ25vcmluZyBhbnkgZGVwZW5kZW5jaWVzCgkgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgaGFuZGxlckluaXRGbiA9PSAiZnVuY3Rpb24iKSB7CgkgICAgICAgICAgICAgICAgICAgICAgICBrby5kZXBlbmRlbmN5RGV0ZWN0aW9uLmlnbm9yZShmdW5jdGlvbigpIHsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgaW5pdFJlc3VsdCA9IGhhbmRsZXJJbml0Rm4obm9kZSwgZ2V0VmFsdWVBY2Nlc3NvcihiaW5kaW5nS2V5KSwgYWxsQmluZGluZ3MsIGJpbmRpbmdDb250ZXh0WyckZGF0YSddLCBiaW5kaW5nQ29udGV4dCk7CgoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIElmIHRoaXMgYmluZGluZyBoYW5kbGVyIGNsYWltcyB0byBjb250cm9sIGRlc2NlbmRhbnQgYmluZGluZ3MsIG1ha2UgYSBub3RlIG9mIHRoaXMKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaW5pdFJlc3VsdCAmJiBpbml0UmVzdWx0Wydjb250cm9sc0Rlc2NlbmRhbnRCaW5kaW5ncyddKSB7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChiaW5kaW5nSGFuZGxlclRoYXRDb250cm9sc0Rlc2NlbmRhbnRCaW5kaW5ncyAhPT0gdW5kZWZpbmVkKQoJICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJNdWx0aXBsZSBiaW5kaW5ncyAoIiArIGJpbmRpbmdIYW5kbGVyVGhhdENvbnRyb2xzRGVzY2VuZGFudEJpbmRpbmdzICsgIiBhbmQgIiArIGJpbmRpbmdLZXkgKyAiKSBhcmUgdHJ5aW5nIHRvIGNvbnRyb2wgZGVzY2VuZGFudCBiaW5kaW5ncyBvZiB0aGUgc2FtZSBlbGVtZW50LiBZb3UgY2Fubm90IHVzZSB0aGVzZSBiaW5kaW5ncyB0b2dldGhlciBvbiB0aGUgc2FtZSBlbGVtZW50LiIpOwoJICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiaW5kaW5nSGFuZGxlclRoYXRDb250cm9sc0Rlc2NlbmRhbnRCaW5kaW5ncyA9IGJpbmRpbmdLZXk7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgICAgICAgICAgfSk7CgkgICAgICAgICAgICAgICAgICAgIH0KCgkgICAgICAgICAgICAgICAgICAgIC8vIFJ1biB1cGRhdGUgaW4gaXRzIG93biBjb21wdXRlZCB3cmFwcGVyCgkgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgaGFuZGxlclVwZGF0ZUZuID09ICJmdW5jdGlvbiIpIHsKCSAgICAgICAgICAgICAgICAgICAgICAgIGtvLmRlcGVuZGVudE9ic2VydmFibGUoCgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24oKSB7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhhbmRsZXJVcGRhdGVGbihub2RlLCBnZXRWYWx1ZUFjY2Vzc29yKGJpbmRpbmdLZXkpLCBhbGxCaW5kaW5ncywgYmluZGluZ0NvbnRleHRbJyRkYXRhJ10sIGJpbmRpbmdDb250ZXh0KTsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIG51bGwsCgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgeyBkaXNwb3NlV2hlbk5vZGVJc1JlbW92ZWQ6IG5vZGUgfQoJICAgICAgICAgICAgICAgICAgICAgICAgKTsKCSAgICAgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGV4KSB7CgkgICAgICAgICAgICAgICAgICAgIGV4Lm1lc3NhZ2UgPSAiVW5hYmxlIHRvIHByb2Nlc3MgYmluZGluZyBcIiIgKyBiaW5kaW5nS2V5ICsgIjogIiArIGJpbmRpbmdzW2JpbmRpbmdLZXldICsgIlwiXG5NZXNzYWdlOiAiICsgZXgubWVzc2FnZTsKCSAgICAgICAgICAgICAgICAgICAgdGhyb3cgZXg7CgkgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgfSk7CgkgICAgICAgIH0KCgkgICAgICAgIHJldHVybiB7CgkgICAgICAgICAgICAnc2hvdWxkQmluZERlc2NlbmRhbnRzJzogYmluZGluZ0hhbmRsZXJUaGF0Q29udHJvbHNEZXNjZW5kYW50QmluZGluZ3MgPT09IHVuZGVmaW5lZAoJICAgICAgICB9OwoJICAgIH07CgoJICAgIHZhciBzdG9yZWRCaW5kaW5nQ29udGV4dERvbURhdGFLZXkgPSBrby51dGlscy5kb21EYXRhLm5leHRLZXkoKTsKCSAgICBrby5zdG9yZWRCaW5kaW5nQ29udGV4dEZvck5vZGUgPSBmdW5jdGlvbiAobm9kZSwgYmluZGluZ0NvbnRleHQpIHsKCSAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT0gMikgewoJICAgICAgICAgICAga28udXRpbHMuZG9tRGF0YS5zZXQobm9kZSwgc3RvcmVkQmluZGluZ0NvbnRleHREb21EYXRhS2V5LCBiaW5kaW5nQ29udGV4dCk7CgkgICAgICAgICAgICBpZiAoYmluZGluZ0NvbnRleHQuX3N1YnNjcmliYWJsZSkKCSAgICAgICAgICAgICAgICBiaW5kaW5nQ29udGV4dC5fc3Vic2NyaWJhYmxlLl9hZGROb2RlKG5vZGUpOwoJICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgcmV0dXJuIGtvLnV0aWxzLmRvbURhdGEuZ2V0KG5vZGUsIHN0b3JlZEJpbmRpbmdDb250ZXh0RG9tRGF0YUtleSk7CgkgICAgICAgIH0KCSAgICB9CgoJICAgIGZ1bmN0aW9uIGdldEJpbmRpbmdDb250ZXh0KHZpZXdNb2RlbE9yQmluZGluZ0NvbnRleHQpIHsKCSAgICAgICAgcmV0dXJuIHZpZXdNb2RlbE9yQmluZGluZ0NvbnRleHQgJiYgKHZpZXdNb2RlbE9yQmluZGluZ0NvbnRleHQgaW5zdGFuY2VvZiBrby5iaW5kaW5nQ29udGV4dCkKCSAgICAgICAgICAgID8gdmlld01vZGVsT3JCaW5kaW5nQ29udGV4dAoJICAgICAgICAgICAgOiBuZXcga28uYmluZGluZ0NvbnRleHQodmlld01vZGVsT3JCaW5kaW5nQ29udGV4dCk7CgkgICAgfQoKCSAgICBrby5hcHBseUJpbmRpbmdBY2Nlc3NvcnNUb05vZGUgPSBmdW5jdGlvbiAobm9kZSwgYmluZGluZ3MsIHZpZXdNb2RlbE9yQmluZGluZ0NvbnRleHQpIHsKCSAgICAgICAgaWYgKG5vZGUubm9kZVR5cGUgPT09IDEpIC8vIElmIGl0J3MgYW4gZWxlbWVudCwgd29ya2Fyb3VuZCBJRSA8PSA4IEhUTUwgcGFyc2luZyB3ZWlyZG5lc3MKCSAgICAgICAgICAgIGtvLnZpcnR1YWxFbGVtZW50cy5ub3JtYWxpc2VWaXJ0dWFsRWxlbWVudERvbVN0cnVjdHVyZShub2RlKTsKCSAgICAgICAgcmV0dXJuIGFwcGx5QmluZGluZ3NUb05vZGVJbnRlcm5hbChub2RlLCBiaW5kaW5ncywgZ2V0QmluZGluZ0NvbnRleHQodmlld01vZGVsT3JCaW5kaW5nQ29udGV4dCksIHRydWUpOwoJICAgIH07CgoJICAgIGtvLmFwcGx5QmluZGluZ3NUb05vZGUgPSBmdW5jdGlvbiAobm9kZSwgYmluZGluZ3MsIHZpZXdNb2RlbE9yQmluZGluZ0NvbnRleHQpIHsKCSAgICAgICAgdmFyIGNvbnRleHQgPSBnZXRCaW5kaW5nQ29udGV4dCh2aWV3TW9kZWxPckJpbmRpbmdDb250ZXh0KTsKCSAgICAgICAgcmV0dXJuIGtvLmFwcGx5QmluZGluZ0FjY2Vzc29yc1RvTm9kZShub2RlLCBtYWtlQmluZGluZ0FjY2Vzc29ycyhiaW5kaW5ncywgY29udGV4dCwgbm9kZSksIGNvbnRleHQpOwoJICAgIH07CgoJICAgIGtvLmFwcGx5QmluZGluZ3NUb0Rlc2NlbmRhbnRzID0gZnVuY3Rpb24odmlld01vZGVsT3JCaW5kaW5nQ29udGV4dCwgcm9vdE5vZGUpIHsKCSAgICAgICAgaWYgKHJvb3ROb2RlLm5vZGVUeXBlID09PSAxIHx8IHJvb3ROb2RlLm5vZGVUeXBlID09PSA4KQoJICAgICAgICAgICAgYXBwbHlCaW5kaW5nc1RvRGVzY2VuZGFudHNJbnRlcm5hbChnZXRCaW5kaW5nQ29udGV4dCh2aWV3TW9kZWxPckJpbmRpbmdDb250ZXh0KSwgcm9vdE5vZGUsIHRydWUpOwoJICAgIH07CgoJICAgIGtvLmFwcGx5QmluZGluZ3MgPSBmdW5jdGlvbiAodmlld01vZGVsT3JCaW5kaW5nQ29udGV4dCwgcm9vdE5vZGUpIHsKCSAgICAgICAgLy8gSWYgalF1ZXJ5IGlzIGxvYWRlZCBhZnRlciBLbm9ja291dCwgd2Ugd29uJ3QgaW5pdGlhbGx5IGhhdmUgYWNjZXNzIHRvIGl0LiBTbyBzYXZlIGl0IGhlcmUuCgkgICAgICAgIGlmICghalF1ZXJ5SW5zdGFuY2UgJiYgd2luZG93WydqUXVlcnknXSkgewoJICAgICAgICAgICAgalF1ZXJ5SW5zdGFuY2UgPSB3aW5kb3dbJ2pRdWVyeSddOwoJICAgICAgICB9CgoJICAgICAgICBpZiAocm9vdE5vZGUgJiYgKHJvb3ROb2RlLm5vZGVUeXBlICE9PSAxKSAmJiAocm9vdE5vZGUubm9kZVR5cGUgIT09IDgpKQoJICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJrby5hcHBseUJpbmRpbmdzOiBmaXJzdCBwYXJhbWV0ZXIgc2hvdWxkIGJlIHlvdXIgdmlldyBtb2RlbDsgc2Vjb25kIHBhcmFtZXRlciBzaG91bGQgYmUgYSBET00gbm9kZSIpOwoJICAgICAgICByb290Tm9kZSA9IHJvb3ROb2RlIHx8IHdpbmRvdy5kb2N1bWVudC5ib2R5OyAvLyBNYWtlICJyb290Tm9kZSIgcGFyYW1ldGVyIG9wdGlvbmFsCgoJICAgICAgICBhcHBseUJpbmRpbmdzVG9Ob2RlQW5kRGVzY2VuZGFudHNJbnRlcm5hbChnZXRCaW5kaW5nQ29udGV4dCh2aWV3TW9kZWxPckJpbmRpbmdDb250ZXh0KSwgcm9vdE5vZGUsIHRydWUpOwoJICAgIH07CgoJICAgIC8vIFJldHJpZXZpbmcgYmluZGluZyBjb250ZXh0IGZyb20gYXJiaXRyYXJ5IG5vZGVzCgkgICAga28uY29udGV4dEZvciA9IGZ1bmN0aW9uKG5vZGUpIHsKCSAgICAgICAgLy8gV2UgY2FuIG9ubHkgZG8gc29tZXRoaW5nIG1lYW5pbmdmdWwgZm9yIGVsZW1lbnRzIGFuZCBjb21tZW50IG5vZGVzIChpbiBwYXJ0aWN1bGFyLCBub3QgdGV4dCBub2RlcywgYXMgSUUgY2FuJ3Qgc3RvcmUgZG9tZGF0YSBmb3IgdGhlbSkKCSAgICAgICAgc3dpdGNoIChub2RlLm5vZGVUeXBlKSB7CgkgICAgICAgICAgICBjYXNlIDE6CgkgICAgICAgICAgICBjYXNlIDg6CgkgICAgICAgICAgICAgICAgdmFyIGNvbnRleHQgPSBrby5zdG9yZWRCaW5kaW5nQ29udGV4dEZvck5vZGUobm9kZSk7CgkgICAgICAgICAgICAgICAgaWYgKGNvbnRleHQpIHJldHVybiBjb250ZXh0OwoJICAgICAgICAgICAgICAgIGlmIChub2RlLnBhcmVudE5vZGUpIHJldHVybiBrby5jb250ZXh0Rm9yKG5vZGUucGFyZW50Tm9kZSk7CgkgICAgICAgICAgICAgICAgYnJlYWs7CgkgICAgICAgIH0KCSAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKCSAgICB9OwoJICAgIGtvLmRhdGFGb3IgPSBmdW5jdGlvbihub2RlKSB7CgkgICAgICAgIHZhciBjb250ZXh0ID0ga28uY29udGV4dEZvcihub2RlKTsKCSAgICAgICAgcmV0dXJuIGNvbnRleHQgPyBjb250ZXh0WyckZGF0YSddIDogdW5kZWZpbmVkOwoJICAgIH07CgoJICAgIGtvLmV4cG9ydFN5bWJvbCgnYmluZGluZ0hhbmRsZXJzJywga28uYmluZGluZ0hhbmRsZXJzKTsKCSAgICBrby5leHBvcnRTeW1ib2woJ2FwcGx5QmluZGluZ3MnLCBrby5hcHBseUJpbmRpbmdzKTsKCSAgICBrby5leHBvcnRTeW1ib2woJ2FwcGx5QmluZGluZ3NUb0Rlc2NlbmRhbnRzJywga28uYXBwbHlCaW5kaW5nc1RvRGVzY2VuZGFudHMpOwoJICAgIGtvLmV4cG9ydFN5bWJvbCgnYXBwbHlCaW5kaW5nQWNjZXNzb3JzVG9Ob2RlJywga28uYXBwbHlCaW5kaW5nQWNjZXNzb3JzVG9Ob2RlKTsKCSAgICBrby5leHBvcnRTeW1ib2woJ2FwcGx5QmluZGluZ3NUb05vZGUnLCBrby5hcHBseUJpbmRpbmdzVG9Ob2RlKTsKCSAgICBrby5leHBvcnRTeW1ib2woJ2NvbnRleHRGb3InLCBrby5jb250ZXh0Rm9yKTsKCSAgICBrby5leHBvcnRTeW1ib2woJ2RhdGFGb3InLCBrby5kYXRhRm9yKTsKCX0pKCk7CgkoZnVuY3Rpb24odW5kZWZpbmVkKSB7CgkgICAgdmFyIGxvYWRpbmdTdWJzY3JpYmFibGVzQ2FjaGUgPSB7fSwgLy8gVHJhY2tzIGNvbXBvbmVudCBsb2FkcyB0aGF0IGFyZSBjdXJyZW50bHkgaW4gZmxpZ2h0CgkgICAgICAgIGxvYWRlZERlZmluaXRpb25zQ2FjaGUgPSB7fTsgICAgLy8gVHJhY2tzIGNvbXBvbmVudCBsb2FkcyB0aGF0IGhhdmUgYWxyZWFkeSBjb21wbGV0ZWQKCgkgICAga28uY29tcG9uZW50cyA9IHsKCSAgICAgICAgZ2V0OiBmdW5jdGlvbihjb21wb25lbnROYW1lLCBjYWxsYmFjaykgewoJICAgICAgICAgICAgdmFyIGNhY2hlZERlZmluaXRpb24gPSBnZXRPYmplY3RPd25Qcm9wZXJ0eShsb2FkZWREZWZpbml0aW9uc0NhY2hlLCBjb21wb25lbnROYW1lKTsKCSAgICAgICAgICAgIGlmIChjYWNoZWREZWZpbml0aW9uKSB7CgkgICAgICAgICAgICAgICAgLy8gSXQncyBhbHJlYWR5IGxvYWRlZCBhbmQgY2FjaGVkLiBSZXVzZSB0aGUgc2FtZSBkZWZpbml0aW9uIG9iamVjdC4KCSAgICAgICAgICAgICAgICAvLyBOb3RlIHRoYXQgZm9yIEFQSSBjb25zaXN0ZW5jeSwgZXZlbiBjYWNoZSBoaXRzIGNvbXBsZXRlIGFzeW5jaHJvbm91c2x5LgoJICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7IGNhbGxiYWNrKGNhY2hlZERlZmluaXRpb24pIH0sIDApOwoJICAgICAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgICAgICAvLyBKb2luIHRoZSBsb2FkaW5nIHByb2Nlc3MgdGhhdCBpcyBhbHJlYWR5IHVuZGVyd2F5LCBvciBzdGFydCBhIG5ldyBvbmUuCgkgICAgICAgICAgICAgICAgbG9hZENvbXBvbmVudEFuZE5vdGlmeShjb21wb25lbnROYW1lLCBjYWxsYmFjayk7CgkgICAgICAgICAgICB9CgkgICAgICAgIH0sCgoJICAgICAgICBjbGVhckNhY2hlZERlZmluaXRpb246IGZ1bmN0aW9uKGNvbXBvbmVudE5hbWUpIHsKCSAgICAgICAgICAgIGRlbGV0ZSBsb2FkZWREZWZpbml0aW9uc0NhY2hlW2NvbXBvbmVudE5hbWVdOwoJICAgICAgICB9LAoKCSAgICAgICAgX2dldEZpcnN0UmVzdWx0RnJvbUxvYWRlcnM6IGdldEZpcnN0UmVzdWx0RnJvbUxvYWRlcnMKCSAgICB9OwoKCSAgICBmdW5jdGlvbiBnZXRPYmplY3RPd25Qcm9wZXJ0eShvYmosIHByb3BOYW1lKSB7CgkgICAgICAgIHJldHVybiBvYmouaGFzT3duUHJvcGVydHkocHJvcE5hbWUpID8gb2JqW3Byb3BOYW1lXSA6IHVuZGVmaW5lZDsKCSAgICB9CgoJICAgIGZ1bmN0aW9uIGxvYWRDb21wb25lbnRBbmROb3RpZnkoY29tcG9uZW50TmFtZSwgY2FsbGJhY2spIHsKCSAgICAgICAgdmFyIHN1YnNjcmliYWJsZSA9IGdldE9iamVjdE93blByb3BlcnR5KGxvYWRpbmdTdWJzY3JpYmFibGVzQ2FjaGUsIGNvbXBvbmVudE5hbWUpLAoJICAgICAgICAgICAgY29tcGxldGVkQXN5bmM7CgkgICAgICAgIGlmICghc3Vic2NyaWJhYmxlKSB7CgkgICAgICAgICAgICAvLyBJdCdzIG5vdCBzdGFydGVkIGxvYWRpbmcgeWV0LiBTdGFydCBsb2FkaW5nLCBhbmQgd2hlbiBpdCdzIGRvbmUsIG1vdmUgaXQgdG8gbG9hZGVkRGVmaW5pdGlvbnNDYWNoZS4KCSAgICAgICAgICAgIHN1YnNjcmliYWJsZSA9IGxvYWRpbmdTdWJzY3JpYmFibGVzQ2FjaGVbY29tcG9uZW50TmFtZV0gPSBuZXcga28uc3Vic2NyaWJhYmxlKCk7CgkgICAgICAgICAgICBiZWdpbkxvYWRpbmdDb21wb25lbnQoY29tcG9uZW50TmFtZSwgZnVuY3Rpb24oZGVmaW5pdGlvbikgewoJICAgICAgICAgICAgICAgIGxvYWRlZERlZmluaXRpb25zQ2FjaGVbY29tcG9uZW50TmFtZV0gPSBkZWZpbml0aW9uOwoJICAgICAgICAgICAgICAgIGRlbGV0ZSBsb2FkaW5nU3Vic2NyaWJhYmxlc0NhY2hlW2NvbXBvbmVudE5hbWVdOwoKCSAgICAgICAgICAgICAgICAvLyBGb3IgQVBJIGNvbnNpc3RlbmN5LCBhbGwgbG9hZHMgY29tcGxldGUgYXN5bmNocm9ub3VzbHkuIEhvd2V2ZXIgd2Ugd2FudCB0byBhdm9pZAoJICAgICAgICAgICAgICAgIC8vIGFkZGluZyBhbiBleHRyYSBzZXRUaW1lb3V0IGlmIGl0J3MgdW5uZWNlc3NhcnkgKGkuZS4sIHRoZSBjb21wbGV0aW9uIGlzIGFscmVhZHkKCSAgICAgICAgICAgICAgICAvLyBhc3luYykgc2luY2Ugc2V0VGltZW91dCguLi4sIDApIHN0aWxsIHRha2VzIGFib3V0IDE2bXMgb3IgbW9yZSBvbiBtb3N0IGJyb3dzZXJzLgoJICAgICAgICAgICAgICAgIGlmIChjb21wbGV0ZWRBc3luYykgewoJICAgICAgICAgICAgICAgICAgICBzdWJzY3JpYmFibGVbJ25vdGlmeVN1YnNjcmliZXJzJ10oZGVmaW5pdGlvbik7CgkgICAgICAgICAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpIHsKCSAgICAgICAgICAgICAgICAgICAgICAgIHN1YnNjcmliYWJsZVsnbm90aWZ5U3Vic2NyaWJlcnMnXShkZWZpbml0aW9uKTsKCSAgICAgICAgICAgICAgICAgICAgfSwgMCk7CgkgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgfSk7CgkgICAgICAgICAgICBjb21wbGV0ZWRBc3luYyA9IHRydWU7CgkgICAgICAgIH0KCSAgICAgICAgc3Vic2NyaWJhYmxlLnN1YnNjcmliZShjYWxsYmFjayk7CgkgICAgfQoKCSAgICBmdW5jdGlvbiBiZWdpbkxvYWRpbmdDb21wb25lbnQoY29tcG9uZW50TmFtZSwgY2FsbGJhY2spIHsKCSAgICAgICAgZ2V0Rmlyc3RSZXN1bHRGcm9tTG9hZGVycygnZ2V0Q29uZmlnJywgW2NvbXBvbmVudE5hbWVdLCBmdW5jdGlvbihjb25maWcpIHsKCSAgICAgICAgICAgIGlmIChjb25maWcpIHsKCSAgICAgICAgICAgICAgICAvLyBXZSBoYXZlIGEgY29uZmlnLCBzbyBub3cgbG9hZCBpdHMgZGVmaW5pdGlvbgoJICAgICAgICAgICAgICAgIGdldEZpcnN0UmVzdWx0RnJvbUxvYWRlcnMoJ2xvYWRDb21wb25lbnQnLCBbY29tcG9uZW50TmFtZSwgY29uZmlnXSwgZnVuY3Rpb24oZGVmaW5pdGlvbikgewoJICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayhkZWZpbml0aW9uKTsKCSAgICAgICAgICAgICAgICB9KTsKCSAgICAgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICAgICAgLy8gVGhlIGNvbXBvbmVudCBoYXMgbm8gY29uZmlnIC0gaXQncyB1bmtub3duIHRvIGFsbCB0aGUgbG9hZGVycy4KCSAgICAgICAgICAgICAgICAvLyBOb3RlIHRoYXQgdGhpcyBpcyBub3QgYW4gZXJyb3IgKGUuZy4sIGEgbW9kdWxlIGxvYWRpbmcgZXJyb3IpIC0gdGhhdCB3b3VsZCBhYm9ydCB0aGUKCSAgICAgICAgICAgICAgICAvLyBwcm9jZXNzIGFuZCB0aGlzIGNhbGxiYWNrIHdvdWxkIG5vdCBydW4uIEZvciB0aGlzIGNhbGxiYWNrIHRvIHJ1biwgYWxsIGxvYWRlcnMgbXVzdAoJICAgICAgICAgICAgICAgIC8vIGhhdmUgY29uZmlybWVkIHRoZXkgZG9uJ3Qga25vdyBhYm91dCB0aGlzIGNvbXBvbmVudC4KCSAgICAgICAgICAgICAgICBjYWxsYmFjayhudWxsKTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgfSk7CgkgICAgfQoKCSAgICBmdW5jdGlvbiBnZXRGaXJzdFJlc3VsdEZyb21Mb2FkZXJzKG1ldGhvZE5hbWUsIGFyZ3NFeGNlcHRDYWxsYmFjaywgY2FsbGJhY2ssIGNhbmRpZGF0ZUxvYWRlcnMpIHsKCSAgICAgICAgLy8gT24gdGhlIGZpcnN0IGNhbGwgaW4gdGhlIHN0YWNrLCBzdGFydCB3aXRoIHRoZSBmdWxsIHNldCBvZiBsb2FkZXJzCgkgICAgICAgIGlmICghY2FuZGlkYXRlTG9hZGVycykgewoJICAgICAgICAgICAgY2FuZGlkYXRlTG9hZGVycyA9IGtvLmNvbXBvbmVudHNbJ2xvYWRlcnMnXS5zbGljZSgwKTsgLy8gVXNlIGEgY29weSwgYmVjYXVzZSB3ZSdsbCBiZSBtdXRhdGluZyB0aGlzIGFycmF5CgkgICAgICAgIH0KCgkgICAgICAgIC8vIFRyeSB0aGUgbmV4dCBjYW5kaWRhdGUKCSAgICAgICAgdmFyIGN1cnJlbnRDYW5kaWRhdGVMb2FkZXIgPSBjYW5kaWRhdGVMb2FkZXJzLnNoaWZ0KCk7CgkgICAgICAgIGlmIChjdXJyZW50Q2FuZGlkYXRlTG9hZGVyKSB7CgkgICAgICAgICAgICB2YXIgbWV0aG9kSW5zdGFuY2UgPSBjdXJyZW50Q2FuZGlkYXRlTG9hZGVyW21ldGhvZE5hbWVdOwoJICAgICAgICAgICAgaWYgKG1ldGhvZEluc3RhbmNlKSB7CgkgICAgICAgICAgICAgICAgdmFyIHdhc0Fib3J0ZWQgPSBmYWxzZSwKCSAgICAgICAgICAgICAgICAgICAgc3luY2hyb25vdXNSZXR1cm5WYWx1ZSA9IG1ldGhvZEluc3RhbmNlLmFwcGx5KGN1cnJlbnRDYW5kaWRhdGVMb2FkZXIsIGFyZ3NFeGNlcHRDYWxsYmFjay5jb25jYXQoZnVuY3Rpb24ocmVzdWx0KSB7CgkgICAgICAgICAgICAgICAgICAgICAgICBpZiAod2FzQWJvcnRlZCkgewoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKG51bGwpOwoJICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChyZXN1bHQgIT09IG51bGwpIHsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBUaGlzIGNhbmRpZGF0ZSByZXR1cm5lZCBhIHZhbHVlLiBVc2UgaXQuCgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2socmVzdWx0KTsKCSAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gVHJ5IHRoZSBuZXh0IGNhbmRpZGF0ZQoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdldEZpcnN0UmVzdWx0RnJvbUxvYWRlcnMobWV0aG9kTmFtZSwgYXJnc0V4Y2VwdENhbGxiYWNrLCBjYWxsYmFjaywgY2FuZGlkYXRlTG9hZGVycyk7CgkgICAgICAgICAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgICAgIH0pKTsKCgkgICAgICAgICAgICAgICAgLy8gQ3VycmVudGx5LCBsb2FkZXJzIG1heSBub3QgcmV0dXJuIGFueXRoaW5nIHN5bmNocm9ub3VzbHkuIFRoaXMgbGVhdmVzIG9wZW4gdGhlIHBvc3NpYmlsaXR5CgkgICAgICAgICAgICAgICAgLy8gdGhhdCB3ZSdsbCBleHRlbmQgdGhlIEFQSSB0byBzdXBwb3J0IHN5bmNocm9ub3VzIHJldHVybiB2YWx1ZXMgaW4gdGhlIGZ1dHVyZS4gSXQgd29uJ3QgYmUKCSAgICAgICAgICAgICAgICAvLyBhIGJyZWFraW5nIGNoYW5nZSwgYmVjYXVzZSBjdXJyZW50bHkgbm8gbG9hZGVyIGlzIGFsbG93ZWQgdG8gcmV0dXJuIGFueXRoaW5nIGV4Y2VwdCB1bmRlZmluZWQuCgkgICAgICAgICAgICAgICAgaWYgKHN5bmNocm9ub3VzUmV0dXJuVmFsdWUgIT09IHVuZGVmaW5lZCkgewoJICAgICAgICAgICAgICAgICAgICB3YXNBYm9ydGVkID0gdHJ1ZTsKCgkgICAgICAgICAgICAgICAgICAgIC8vIE1ldGhvZCB0byBzdXBwcmVzcyBleGNlcHRpb25zIHdpbGwgcmVtYWluIHVuZG9jdW1lbnRlZC4gVGhpcyBpcyBvbmx5IHRvIGtlZXAKCSAgICAgICAgICAgICAgICAgICAgLy8gS08ncyBzcGVjcyBydW5uaW5nIHRpZGlseSwgc2luY2Ugd2UgY2FuIG9ic2VydmUgdGhlIGxvYWRpbmcgZ290IGFib3J0ZWQgd2l0aG91dAoJICAgICAgICAgICAgICAgICAgICAvLyBoYXZpbmcgZXhjZXB0aW9ucyBjbHV0dGVyaW5nIHVwIHRoZSBjb25zb2xlIHRvby4KCSAgICAgICAgICAgICAgICAgICAgaWYgKCFjdXJyZW50Q2FuZGlkYXRlTG9hZGVyWydzdXBwcmVzc0xvYWRlckV4Y2VwdGlvbnMnXSkgewoJICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdDb21wb25lbnQgbG9hZGVycyBtdXN0IHN1cHBseSB2YWx1ZXMgYnkgaW52b2tpbmcgdGhlIGNhbGxiYWNrLCBub3QgYnkgcmV0dXJuaW5nIHZhbHVlcyBzeW5jaHJvbm91c2x5LicpOwoJICAgICAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgICAgICAvLyBUaGlzIGNhbmRpZGF0ZSBkb2Vzbid0IGhhdmUgdGhlIHJlbGV2YW50IGhhbmRsZXIuIFN5bmNocm9ub3VzbHkgbW92ZSBvbiB0byB0aGUgbmV4dCBvbmUuCgkgICAgICAgICAgICAgICAgZ2V0Rmlyc3RSZXN1bHRGcm9tTG9hZGVycyhtZXRob2ROYW1lLCBhcmdzRXhjZXB0Q2FsbGJhY2ssIGNhbGxiYWNrLCBjYW5kaWRhdGVMb2FkZXJzKTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgIC8vIE5vIGNhbmRpZGF0ZXMgcmV0dXJuZWQgYSB2YWx1ZQoJICAgICAgICAgICAgY2FsbGJhY2sobnVsbCk7CgkgICAgICAgIH0KCSAgICB9CgoJICAgIC8vIFJlZmVyZW5jZSB0aGUgbG9hZGVycyB2aWEgc3RyaW5nIG5hbWUgc28gaXQncyBwb3NzaWJsZSBmb3IgZGV2ZWxvcGVycwoJICAgIC8vIHRvIHJlcGxhY2UgdGhlIHdob2xlIGFycmF5IGJ5IGFzc2lnbmluZyB0byBrby5jb21wb25lbnRzLmxvYWRlcnMKCSAgICBrby5jb21wb25lbnRzWydsb2FkZXJzJ10gPSBbXTsKCgkgICAga28uZXhwb3J0U3ltYm9sKCdjb21wb25lbnRzJywga28uY29tcG9uZW50cyk7CgkgICAga28uZXhwb3J0U3ltYm9sKCdjb21wb25lbnRzLmdldCcsIGtvLmNvbXBvbmVudHMuZ2V0KTsKCSAgICBrby5leHBvcnRTeW1ib2woJ2NvbXBvbmVudHMuY2xlYXJDYWNoZWREZWZpbml0aW9uJywga28uY29tcG9uZW50cy5jbGVhckNhY2hlZERlZmluaXRpb24pOwoJfSkoKTsKCShmdW5jdGlvbih1bmRlZmluZWQpIHsKCgkgICAgLy8gVGhlIGRlZmF1bHQgbG9hZGVyIGlzIHJlc3BvbnNpYmxlIGZvciB0d28gdGhpbmdzOgoJICAgIC8vIDEuIE1haW50YWluaW5nIHRoZSBkZWZhdWx0IGluLW1lbW9yeSByZWdpc3RyeSBvZiBjb21wb25lbnQgY29uZmlndXJhdGlvbiBvYmplY3RzCgkgICAgLy8gICAgKGkuZS4sIHRoZSB0aGluZyB5b3UncmUgd3JpdGluZyB0byB3aGVuIHlvdSBjYWxsIGtvLmNvbXBvbmVudHMucmVnaXN0ZXIoc29tZU5hbWUsIC4uLikpCgkgICAgLy8gMi4gQW5zd2VyaW5nIHJlcXVlc3RzIGZvciBjb21wb25lbnRzIGJ5IGZldGNoaW5nIGNvbmZpZ3VyYXRpb24gb2JqZWN0cwoJICAgIC8vICAgIGZyb20gdGhhdCBkZWZhdWx0IGluLW1lbW9yeSByZWdpc3RyeSBhbmQgcmVzb2x2aW5nIHRoZW0gaW50byBzdGFuZGFyZAoJICAgIC8vICAgIGNvbXBvbmVudCBkZWZpbml0aW9uIG9iamVjdHMgKG9mIHRoZSBmb3JtIHsgY3JlYXRlVmlld01vZGVsOiAuLi4sIHRlbXBsYXRlOiAuLi4gfSkKCSAgICAvLyBDdXN0b20gbG9hZGVycyBtYXkgb3ZlcnJpZGUgZWl0aGVyIG9mIHRoZXNlIGZhY2lsaXRpZXMsIGkuZS4sCgkgICAgLy8gMS4gVG8gc3VwcGx5IGNvbmZpZ3VyYXRpb24gb2JqZWN0cyBmcm9tIHNvbWUgb3RoZXIgc291cmNlIChlLmcuLCBjb252ZW50aW9ucykKCSAgICAvLyAyLiBPciwgdG8gcmVzb2x2ZSBjb25maWd1cmF0aW9uIG9iamVjdHMgYnkgbG9hZGluZyB2aWV3bW9kZWxzL3RlbXBsYXRlcyB2aWEgYXJiaXRyYXJ5IGxvZ2ljLgoKCSAgICB2YXIgZGVmYXVsdENvbmZpZ1JlZ2lzdHJ5ID0ge307CgoJICAgIGtvLmNvbXBvbmVudHMucmVnaXN0ZXIgPSBmdW5jdGlvbihjb21wb25lbnROYW1lLCBjb25maWcpIHsKCSAgICAgICAgaWYgKCFjb25maWcpIHsKCSAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZCBjb25maWd1cmF0aW9uIGZvciAnICsgY29tcG9uZW50TmFtZSk7CgkgICAgICAgIH0KCgkgICAgICAgIGlmIChrby5jb21wb25lbnRzLmlzUmVnaXN0ZXJlZChjb21wb25lbnROYW1lKSkgewoJICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdDb21wb25lbnQgJyArIGNvbXBvbmVudE5hbWUgKyAnIGlzIGFscmVhZHkgcmVnaXN0ZXJlZCcpOwoJICAgICAgICB9CgoJICAgICAgICBkZWZhdWx0Q29uZmlnUmVnaXN0cnlbY29tcG9uZW50TmFtZV0gPSBjb25maWc7CgkgICAgfQoKCSAgICBrby5jb21wb25lbnRzLmlzUmVnaXN0ZXJlZCA9IGZ1bmN0aW9uKGNvbXBvbmVudE5hbWUpIHsKCSAgICAgICAgcmV0dXJuIGNvbXBvbmVudE5hbWUgaW4gZGVmYXVsdENvbmZpZ1JlZ2lzdHJ5OwoJICAgIH0KCgkgICAga28uY29tcG9uZW50cy51bnJlZ2lzdGVyID0gZnVuY3Rpb24oY29tcG9uZW50TmFtZSkgewoJICAgICAgICBkZWxldGUgZGVmYXVsdENvbmZpZ1JlZ2lzdHJ5W2NvbXBvbmVudE5hbWVdOwoJICAgICAgICBrby5jb21wb25lbnRzLmNsZWFyQ2FjaGVkRGVmaW5pdGlvbihjb21wb25lbnROYW1lKTsKCSAgICB9CgoJICAgIGtvLmNvbXBvbmVudHMuZGVmYXVsdExvYWRlciA9IHsKCSAgICAgICAgJ2dldENvbmZpZyc6IGZ1bmN0aW9uKGNvbXBvbmVudE5hbWUsIGNhbGxiYWNrKSB7CgkgICAgICAgICAgICB2YXIgcmVzdWx0ID0gZGVmYXVsdENvbmZpZ1JlZ2lzdHJ5Lmhhc093blByb3BlcnR5KGNvbXBvbmVudE5hbWUpCgkgICAgICAgICAgICAgICAgPyBkZWZhdWx0Q29uZmlnUmVnaXN0cnlbY29tcG9uZW50TmFtZV0KCSAgICAgICAgICAgICAgICA6IG51bGw7CgkgICAgICAgICAgICBjYWxsYmFjayhyZXN1bHQpOwoJICAgICAgICB9LAoKCSAgICAgICAgJ2xvYWRDb21wb25lbnQnOiBmdW5jdGlvbihjb21wb25lbnROYW1lLCBjb25maWcsIGNhbGxiYWNrKSB7CgkgICAgICAgICAgICB2YXIgZXJyb3JDYWxsYmFjayA9IG1ha2VFcnJvckNhbGxiYWNrKGNvbXBvbmVudE5hbWUpOwoJICAgICAgICAgICAgcG9zc2libHlHZXRDb25maWdGcm9tQW1kKGVycm9yQ2FsbGJhY2ssIGNvbmZpZywgZnVuY3Rpb24obG9hZGVkQ29uZmlnKSB7CgkgICAgICAgICAgICAgICAgcmVzb2x2ZUNvbmZpZyhjb21wb25lbnROYW1lLCBlcnJvckNhbGxiYWNrLCBsb2FkZWRDb25maWcsIGNhbGxiYWNrKTsKCSAgICAgICAgICAgIH0pOwoJICAgICAgICB9LAoKCSAgICAgICAgJ2xvYWRUZW1wbGF0ZSc6IGZ1bmN0aW9uKGNvbXBvbmVudE5hbWUsIHRlbXBsYXRlQ29uZmlnLCBjYWxsYmFjaykgewoJICAgICAgICAgICAgcmVzb2x2ZVRlbXBsYXRlKG1ha2VFcnJvckNhbGxiYWNrKGNvbXBvbmVudE5hbWUpLCB0ZW1wbGF0ZUNvbmZpZywgY2FsbGJhY2spOwoJICAgICAgICB9LAoKCSAgICAgICAgJ2xvYWRWaWV3TW9kZWwnOiBmdW5jdGlvbihjb21wb25lbnROYW1lLCB2aWV3TW9kZWxDb25maWcsIGNhbGxiYWNrKSB7CgkgICAgICAgICAgICByZXNvbHZlVmlld01vZGVsKG1ha2VFcnJvckNhbGxiYWNrKGNvbXBvbmVudE5hbWUpLCB2aWV3TW9kZWxDb25maWcsIGNhbGxiYWNrKTsKCSAgICAgICAgfQoJICAgIH07CgoJICAgIHZhciBjcmVhdGVWaWV3TW9kZWxLZXkgPSAnY3JlYXRlVmlld01vZGVsJzsKCgkgICAgLy8gVGFrZXMgYSBjb25maWcgb2JqZWN0IG9mIHRoZSBmb3JtIHsgdGVtcGxhdGU6IC4uLiwgdmlld01vZGVsOiAuLi4gfSwgYW5kIGFzeW5jaHJvbm91c2x5IGNvbnZlcnQgaXQKCSAgICAvLyBpbnRvIHRoZSBzdGFuZGFyZCBjb21wb25lbnQgZGVmaW5pdGlvbiBmb3JtYXQ6CgkgICAgLy8gICAgeyB0ZW1wbGF0ZTogPEFycmF5T2ZEb21Ob2Rlcz4sIGNyZWF0ZVZpZXdNb2RlbDogZnVuY3Rpb24ocGFyYW1zLCBjb21wb25lbnRJbmZvKSB7IC4uLiB9IH0uCgkgICAgLy8gU2luY2UgYm90aCB0ZW1wbGF0ZSBhbmQgdmlld01vZGVsIG1heSBuZWVkIHRvIGJlIHJlc29sdmVkIGFzeW5jaHJvbm91c2x5LCBib3RoIHRhc2tzIGFyZSBwZXJmb3JtZWQKCSAgICAvLyBpbiBwYXJhbGxlbCwgYW5kIHRoZSByZXN1bHRzIGpvaW5lZCB3aGVuIGJvdGggYXJlIHJlYWR5LiBXZSBkb24ndCBkZXBlbmQgb24gYW55IHByb21pc2VzIGluZnJhc3RydWN0dXJlLAoJICAgIC8vIHNvIHRoaXMgaXMgaW1wbGVtZW50ZWQgbWFudWFsbHkgYmVsb3cuCgkgICAgZnVuY3Rpb24gcmVzb2x2ZUNvbmZpZyhjb21wb25lbnROYW1lLCBlcnJvckNhbGxiYWNrLCBjb25maWcsIGNhbGxiYWNrKSB7CgkgICAgICAgIHZhciByZXN1bHQgPSB7fSwKCSAgICAgICAgICAgIG1ha2VDYWxsQmFja1doZW5aZXJvID0gMiwKCSAgICAgICAgICAgIHRyeUlzc3VlQ2FsbGJhY2sgPSBmdW5jdGlvbigpIHsKCSAgICAgICAgICAgICAgICBpZiAoLS1tYWtlQ2FsbEJhY2tXaGVuWmVybyA9PT0gMCkgewoJICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayhyZXN1bHQpOwoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgIH0sCgkgICAgICAgICAgICB0ZW1wbGF0ZUNvbmZpZyA9IGNvbmZpZ1sndGVtcGxhdGUnXSwKCSAgICAgICAgICAgIHZpZXdNb2RlbENvbmZpZyA9IGNvbmZpZ1sndmlld01vZGVsJ107CgoJICAgICAgICBpZiAodGVtcGxhdGVDb25maWcpIHsKCSAgICAgICAgICAgIHBvc3NpYmx5R2V0Q29uZmlnRnJvbUFtZChlcnJvckNhbGxiYWNrLCB0ZW1wbGF0ZUNvbmZpZywgZnVuY3Rpb24obG9hZGVkQ29uZmlnKSB7CgkgICAgICAgICAgICAgICAga28uY29tcG9uZW50cy5fZ2V0Rmlyc3RSZXN1bHRGcm9tTG9hZGVycygnbG9hZFRlbXBsYXRlJywgW2NvbXBvbmVudE5hbWUsIGxvYWRlZENvbmZpZ10sIGZ1bmN0aW9uKHJlc29sdmVkVGVtcGxhdGUpIHsKCSAgICAgICAgICAgICAgICAgICAgcmVzdWx0Wyd0ZW1wbGF0ZSddID0gcmVzb2x2ZWRUZW1wbGF0ZTsKCSAgICAgICAgICAgICAgICAgICAgdHJ5SXNzdWVDYWxsYmFjaygpOwoJICAgICAgICAgICAgICAgIH0pOwoJICAgICAgICAgICAgfSk7CgkgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICB0cnlJc3N1ZUNhbGxiYWNrKCk7CgkgICAgICAgIH0KCgkgICAgICAgIGlmICh2aWV3TW9kZWxDb25maWcpIHsKCSAgICAgICAgICAgIHBvc3NpYmx5R2V0Q29uZmlnRnJvbUFtZChlcnJvckNhbGxiYWNrLCB2aWV3TW9kZWxDb25maWcsIGZ1bmN0aW9uKGxvYWRlZENvbmZpZykgewoJICAgICAgICAgICAgICAgIGtvLmNvbXBvbmVudHMuX2dldEZpcnN0UmVzdWx0RnJvbUxvYWRlcnMoJ2xvYWRWaWV3TW9kZWwnLCBbY29tcG9uZW50TmFtZSwgbG9hZGVkQ29uZmlnXSwgZnVuY3Rpb24ocmVzb2x2ZWRWaWV3TW9kZWwpIHsKCSAgICAgICAgICAgICAgICAgICAgcmVzdWx0W2NyZWF0ZVZpZXdNb2RlbEtleV0gPSByZXNvbHZlZFZpZXdNb2RlbDsKCSAgICAgICAgICAgICAgICAgICAgdHJ5SXNzdWVDYWxsYmFjaygpOwoJICAgICAgICAgICAgICAgIH0pOwoJICAgICAgICAgICAgfSk7CgkgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICB0cnlJc3N1ZUNhbGxiYWNrKCk7CgkgICAgICAgIH0KCSAgICB9CgoJICAgIGZ1bmN0aW9uIHJlc29sdmVUZW1wbGF0ZShlcnJvckNhbGxiYWNrLCB0ZW1wbGF0ZUNvbmZpZywgY2FsbGJhY2spIHsKCSAgICAgICAgaWYgKHR5cGVvZiB0ZW1wbGF0ZUNvbmZpZyA9PT0gJ3N0cmluZycpIHsKCSAgICAgICAgICAgIC8vIE1hcmt1cCAtIHBhcnNlIGl0CgkgICAgICAgICAgICBjYWxsYmFjayhrby51dGlscy5wYXJzZUh0bWxGcmFnbWVudCh0ZW1wbGF0ZUNvbmZpZykpOwoJICAgICAgICB9IGVsc2UgaWYgKHRlbXBsYXRlQ29uZmlnIGluc3RhbmNlb2YgQXJyYXkpIHsKCSAgICAgICAgICAgIC8vIEFzc3VtZSBhbHJlYWR5IGFuIGFycmF5IG9mIERPTSBub2RlcyAtIHBhc3MgdGhyb3VnaCB1bmNoYW5nZWQKCSAgICAgICAgICAgIGNhbGxiYWNrKHRlbXBsYXRlQ29uZmlnKTsKCSAgICAgICAgfSBlbHNlIGlmIChpc0RvY3VtZW50RnJhZ21lbnQodGVtcGxhdGVDb25maWcpKSB7CgkgICAgICAgICAgICAvLyBEb2N1bWVudCBmcmFnbWVudCAtIHVzZSBpdHMgY2hpbGQgbm9kZXMKCSAgICAgICAgICAgIGNhbGxiYWNrKGtvLnV0aWxzLm1ha2VBcnJheSh0ZW1wbGF0ZUNvbmZpZy5jaGlsZE5vZGVzKSk7CgkgICAgICAgIH0gZWxzZSBpZiAodGVtcGxhdGVDb25maWdbJ2VsZW1lbnQnXSkgewoJICAgICAgICAgICAgdmFyIGVsZW1lbnQgPSB0ZW1wbGF0ZUNvbmZpZ1snZWxlbWVudCddOwoJICAgICAgICAgICAgaWYgKGlzRG9tRWxlbWVudChlbGVtZW50KSkgewoJICAgICAgICAgICAgICAgIC8vIEVsZW1lbnQgaW5zdGFuY2UgLSBjb3B5IGl0cyBjaGlsZCBub2RlcwoJICAgICAgICAgICAgICAgIGNhbGxiYWNrKGNsb25lTm9kZXNGcm9tVGVtcGxhdGVTb3VyY2VFbGVtZW50KGVsZW1lbnQpKTsKCSAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGVsZW1lbnQgPT09ICdzdHJpbmcnKSB7CgkgICAgICAgICAgICAgICAgLy8gRWxlbWVudCBJRCAtIGZpbmQgaXQsIHRoZW4gY29weSBpdHMgY2hpbGQgbm9kZXMKCSAgICAgICAgICAgICAgICB2YXIgZWxlbUluc3RhbmNlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoZWxlbWVudCk7CgkgICAgICAgICAgICAgICAgaWYgKGVsZW1JbnN0YW5jZSkgewoJICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayhjbG9uZU5vZGVzRnJvbVRlbXBsYXRlU291cmNlRWxlbWVudChlbGVtSW5zdGFuY2UpKTsKCSAgICAgICAgICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgICAgICAgICBlcnJvckNhbGxiYWNrKCdDYW5ub3QgZmluZCBlbGVtZW50IHdpdGggSUQgJyArIGVsZW1lbnQpOwoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICAgICAgZXJyb3JDYWxsYmFjaygnVW5rbm93biBlbGVtZW50IHR5cGU6ICcgKyBlbGVtZW50KTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgIGVycm9yQ2FsbGJhY2soJ1Vua25vd24gdGVtcGxhdGUgdmFsdWU6ICcgKyB0ZW1wbGF0ZUNvbmZpZyk7CgkgICAgICAgIH0KCSAgICB9CgoJICAgIGZ1bmN0aW9uIHJlc29sdmVWaWV3TW9kZWwoZXJyb3JDYWxsYmFjaywgdmlld01vZGVsQ29uZmlnLCBjYWxsYmFjaykgewoJICAgICAgICBpZiAodHlwZW9mIHZpZXdNb2RlbENvbmZpZyA9PT0gJ2Z1bmN0aW9uJykgewoJICAgICAgICAgICAgLy8gQ29uc3RydWN0b3IgLSBjb252ZXJ0IHRvIHN0YW5kYXJkIGZhY3RvcnkgZnVuY3Rpb24gZm9ybWF0CgkgICAgICAgICAgICAvLyBCeSBkZXNpZ24sIHRoaXMgZG9lcyAqbm90KiBzdXBwbHkgY29tcG9uZW50SW5mbyB0byB0aGUgY29uc3RydWN0b3IsIGFzIHRoZSBpbnRlbnQgaXMgdGhhdAoJICAgICAgICAgICAgLy8gY29tcG9uZW50SW5mbyBjb250YWlucyBub24tdmlld21vZGVsIGRhdGEgKGUuZy4sIHRoZSBjb21wb25lbnQncyBlbGVtZW50KSB0aGF0IHNob3VsZCBvbmx5CgkgICAgICAgICAgICAvLyBiZSB1c2VkIGluIGZhY3RvcnkgZnVuY3Rpb25zLCBub3Qgdmlld21vZGVsIGNvbnN0cnVjdG9ycy4KCSAgICAgICAgICAgIGNhbGxiYWNrKGZ1bmN0aW9uIChwYXJhbXMgLyosIGNvbXBvbmVudEluZm8gKi8pIHsKCSAgICAgICAgICAgICAgICByZXR1cm4gbmV3IHZpZXdNb2RlbENvbmZpZyhwYXJhbXMpOwoJICAgICAgICAgICAgfSk7CgkgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHZpZXdNb2RlbENvbmZpZ1tjcmVhdGVWaWV3TW9kZWxLZXldID09PSAnZnVuY3Rpb24nKSB7CgkgICAgICAgICAgICAvLyBBbHJlYWR5IGEgZmFjdG9yeSBmdW5jdGlvbiAtIHVzZSBpdCBhcy1pcwoJICAgICAgICAgICAgY2FsbGJhY2sodmlld01vZGVsQ29uZmlnW2NyZWF0ZVZpZXdNb2RlbEtleV0pOwoJICAgICAgICB9IGVsc2UgaWYgKCdpbnN0YW5jZScgaW4gdmlld01vZGVsQ29uZmlnKSB7CgkgICAgICAgICAgICAvLyBGaXhlZCBvYmplY3QgaW5zdGFuY2UgLSBwcm9tb3RlIHRvIGNyZWF0ZVZpZXdNb2RlbCBmb3JtYXQgZm9yIEFQSSBjb25zaXN0ZW5jeQoJICAgICAgICAgICAgdmFyIGZpeGVkSW5zdGFuY2UgPSB2aWV3TW9kZWxDb25maWdbJ2luc3RhbmNlJ107CgkgICAgICAgICAgICBjYWxsYmFjayhmdW5jdGlvbiAocGFyYW1zLCBjb21wb25lbnRJbmZvKSB7CgkgICAgICAgICAgICAgICAgcmV0dXJuIGZpeGVkSW5zdGFuY2U7CgkgICAgICAgICAgICB9KTsKCSAgICAgICAgfSBlbHNlIGlmICgndmlld01vZGVsJyBpbiB2aWV3TW9kZWxDb25maWcpIHsKCSAgICAgICAgICAgIC8vIFJlc29sdmVkIEFNRCBtb2R1bGUgd2hvc2UgdmFsdWUgaXMgb2YgdGhlIGZvcm0geyB2aWV3TW9kZWw6IC4uLiB9CgkgICAgICAgICAgICByZXNvbHZlVmlld01vZGVsKGVycm9yQ2FsbGJhY2ssIHZpZXdNb2RlbENvbmZpZ1sndmlld01vZGVsJ10sIGNhbGxiYWNrKTsKCSAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgIGVycm9yQ2FsbGJhY2soJ1Vua25vd24gdmlld01vZGVsIHZhbHVlOiAnICsgdmlld01vZGVsQ29uZmlnKTsKCSAgICAgICAgfQoJICAgIH0KCgkgICAgZnVuY3Rpb24gY2xvbmVOb2Rlc0Zyb21UZW1wbGF0ZVNvdXJjZUVsZW1lbnQoZWxlbUluc3RhbmNlKSB7CgkgICAgICAgIHN3aXRjaCAoa28udXRpbHMudGFnTmFtZUxvd2VyKGVsZW1JbnN0YW5jZSkpIHsKCSAgICAgICAgICAgIGNhc2UgJ3NjcmlwdCc6CgkgICAgICAgICAgICAgICAgcmV0dXJuIGtvLnV0aWxzLnBhcnNlSHRtbEZyYWdtZW50KGVsZW1JbnN0YW5jZS50ZXh0KTsKCSAgICAgICAgICAgIGNhc2UgJ3RleHRhcmVhJzoKCSAgICAgICAgICAgICAgICByZXR1cm4ga28udXRpbHMucGFyc2VIdG1sRnJhZ21lbnQoZWxlbUluc3RhbmNlLnZhbHVlKTsKCSAgICAgICAgICAgIGNhc2UgJ3RlbXBsYXRlJzoKCSAgICAgICAgICAgICAgICAvLyBGb3IgYnJvd3NlcnMgd2l0aCBwcm9wZXIgPHRlbXBsYXRlPiBlbGVtZW50IHN1cHBvcnQgKGkuZS4sIHdoZXJlIHRoZSAuY29udGVudCBwcm9wZXJ0eQoJICAgICAgICAgICAgICAgIC8vIGdpdmVzIGEgZG9jdW1lbnQgZnJhZ21lbnQpLCB1c2UgdGhhdCBkb2N1bWVudCBmcmFnbWVudC4KCSAgICAgICAgICAgICAgICBpZiAoaXNEb2N1bWVudEZyYWdtZW50KGVsZW1JbnN0YW5jZS5jb250ZW50KSkgewoJICAgICAgICAgICAgICAgICAgICByZXR1cm4ga28udXRpbHMuY2xvbmVOb2RlcyhlbGVtSW5zdGFuY2UuY29udGVudC5jaGlsZE5vZGVzKTsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgIH0KCgkgICAgICAgIC8vIFJlZ3VsYXIgZWxlbWVudHMgc3VjaCBhcyA8ZGl2PiwgYW5kIDx0ZW1wbGF0ZT4gZWxlbWVudHMgb24gb2xkIGJyb3dzZXJzIHRoYXQgZG9uJ3QgcmVhbGx5CgkgICAgICAgIC8vIHVuZGVyc3RhbmQgPHRlbXBsYXRlPiBhbmQganVzdCB0cmVhdCBpdCBhcyBhIHJlZ3VsYXIgY29udGFpbmVyCgkgICAgICAgIHJldHVybiBrby51dGlscy5jbG9uZU5vZGVzKGVsZW1JbnN0YW5jZS5jaGlsZE5vZGVzKTsKCSAgICB9CgoJICAgIGZ1bmN0aW9uIGlzRG9tRWxlbWVudChvYmopIHsKCSAgICAgICAgaWYgKHdpbmRvd1snSFRNTEVsZW1lbnQnXSkgewoJICAgICAgICAgICAgcmV0dXJuIG9iaiBpbnN0YW5jZW9mIEhUTUxFbGVtZW50OwoJICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgcmV0dXJuIG9iaiAmJiBvYmoudGFnTmFtZSAmJiBvYmoubm9kZVR5cGUgPT09IDE7CgkgICAgICAgIH0KCSAgICB9CgoJICAgIGZ1bmN0aW9uIGlzRG9jdW1lbnRGcmFnbWVudChvYmopIHsKCSAgICAgICAgaWYgKHdpbmRvd1snRG9jdW1lbnRGcmFnbWVudCddKSB7CgkgICAgICAgICAgICByZXR1cm4gb2JqIGluc3RhbmNlb2YgRG9jdW1lbnRGcmFnbWVudDsKCSAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgIHJldHVybiBvYmogJiYgb2JqLm5vZGVUeXBlID09PSAxMTsKCSAgICAgICAgfQoJICAgIH0KCgkgICAgZnVuY3Rpb24gcG9zc2libHlHZXRDb25maWdGcm9tQW1kKGVycm9yQ2FsbGJhY2ssIGNvbmZpZywgY2FsbGJhY2spIHsKCSAgICAgICAgaWYgKHR5cGVvZiBjb25maWdbJ3JlcXVpcmUnXSA9PT0gJ3N0cmluZycpIHsKCSAgICAgICAgICAgIC8vIFRoZSBjb25maWcgaXMgdGhlIHZhbHVlIG9mIGFuIEFNRCBtb2R1bGUKCSAgICAgICAgICAgIGlmIChyZXF1aXJlIHx8IHdpbmRvd1sncmVxdWlyZSddKSB7CgkgICAgICAgICAgICAgICAgKHJlcXVpcmUgfHwgd2luZG93WydyZXF1aXJlJ10pKFtjb25maWdbJ3JlcXVpcmUnXV0sIGNhbGxiYWNrKTsKCSAgICAgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICAgICAgZXJyb3JDYWxsYmFjaygnVXNlcyByZXF1aXJlLCBidXQgbm8gQU1EIGxvYWRlciBpcyBwcmVzZW50Jyk7CgkgICAgICAgICAgICB9CgkgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICBjYWxsYmFjayhjb25maWcpOwoJICAgICAgICB9CgkgICAgfQoKCSAgICBmdW5jdGlvbiBtYWtlRXJyb3JDYWxsYmFjayhjb21wb25lbnROYW1lKSB7CgkgICAgICAgIHJldHVybiBmdW5jdGlvbiAobWVzc2FnZSkgewoJICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdDb21wb25lbnQgXCcnICsgY29tcG9uZW50TmFtZSArICdcJzogJyArIG1lc3NhZ2UpOwoJICAgICAgICB9OwoJICAgIH0KCgkgICAga28uZXhwb3J0U3ltYm9sKCdjb21wb25lbnRzLnJlZ2lzdGVyJywga28uY29tcG9uZW50cy5yZWdpc3Rlcik7CgkgICAga28uZXhwb3J0U3ltYm9sKCdjb21wb25lbnRzLmlzUmVnaXN0ZXJlZCcsIGtvLmNvbXBvbmVudHMuaXNSZWdpc3RlcmVkKTsKCSAgICBrby5leHBvcnRTeW1ib2woJ2NvbXBvbmVudHMudW5yZWdpc3RlcicsIGtvLmNvbXBvbmVudHMudW5yZWdpc3Rlcik7CgoJICAgIC8vIEV4cG9zZSB0aGUgZGVmYXVsdCBsb2FkZXIgc28gdGhhdCBkZXZlbG9wZXJzIGNhbiBkaXJlY3RseSBhc2sgaXQgZm9yIGNvbmZpZ3VyYXRpb24KCSAgICAvLyBvciB0byByZXNvbHZlIGNvbmZpZ3VyYXRpb24KCSAgICBrby5leHBvcnRTeW1ib2woJ2NvbXBvbmVudHMuZGVmYXVsdExvYWRlcicsIGtvLmNvbXBvbmVudHMuZGVmYXVsdExvYWRlcik7CgoJICAgIC8vIEJ5IGRlZmF1bHQsIHRoZSBkZWZhdWx0IGxvYWRlciBpcyB0aGUgb25seSByZWdpc3RlcmVkIGNvbXBvbmVudCBsb2FkZXIKCSAgICBrby5jb21wb25lbnRzWydsb2FkZXJzJ10ucHVzaChrby5jb21wb25lbnRzLmRlZmF1bHRMb2FkZXIpOwoKCSAgICAvLyBQcml2YXRlbHkgZXhwb3NlIHRoZSB1bmRlcmx5aW5nIGNvbmZpZyByZWdpc3RyeSBmb3IgdXNlIGluIG9sZC1JRSBzaGltCgkgICAga28uY29tcG9uZW50cy5fYWxsUmVnaXN0ZXJlZENvbXBvbmVudHMgPSBkZWZhdWx0Q29uZmlnUmVnaXN0cnk7Cgl9KSgpOwoJKGZ1bmN0aW9uICh1bmRlZmluZWQpIHsKCSAgICAvLyBPdmVycmlkYWJsZSBBUEkgZm9yIGRldGVybWluaW5nIHdoaWNoIGNvbXBvbmVudCBuYW1lIGFwcGxpZXMgdG8gYSBnaXZlbiBub2RlLiBCeSBvdmVycmlkaW5nIHRoaXMsCgkgICAgLy8geW91IGNhbiBmb3IgZXhhbXBsZSBtYXAgc3BlY2lmaWMgdGFnTmFtZXMgdG8gY29tcG9uZW50cyB0aGF0IGFyZSBub3QgcHJlcmVnaXN0ZXJlZC4KCSAgICBrby5jb21wb25lbnRzWydnZXRDb21wb25lbnROYW1lRm9yTm9kZSddID0gZnVuY3Rpb24obm9kZSkgewoJICAgICAgICB2YXIgdGFnTmFtZUxvd2VyID0ga28udXRpbHMudGFnTmFtZUxvd2VyKG5vZGUpOwoJICAgICAgICByZXR1cm4ga28uY29tcG9uZW50cy5pc1JlZ2lzdGVyZWQodGFnTmFtZUxvd2VyKSAmJiB0YWdOYW1lTG93ZXI7CgkgICAgfTsKCgkgICAga28uY29tcG9uZW50cy5hZGRCaW5kaW5nc0ZvckN1c3RvbUVsZW1lbnQgPSBmdW5jdGlvbihhbGxCaW5kaW5ncywgbm9kZSwgYmluZGluZ0NvbnRleHQsIHZhbHVlQWNjZXNzb3JzKSB7CgkgICAgICAgIC8vIERldGVybWluZSBpZiBpdCdzIHJlYWxseSBhIGN1c3RvbSBlbGVtZW50IG1hdGNoaW5nIGEgY29tcG9uZW50CgkgICAgICAgIGlmIChub2RlLm5vZGVUeXBlID09PSAxKSB7CgkgICAgICAgICAgICB2YXIgY29tcG9uZW50TmFtZSA9IGtvLmNvbXBvbmVudHNbJ2dldENvbXBvbmVudE5hbWVGb3JOb2RlJ10obm9kZSk7CgkgICAgICAgICAgICBpZiAoY29tcG9uZW50TmFtZSkgewoJICAgICAgICAgICAgICAgIC8vIEl0IGRvZXMgcmVwcmVzZW50IGEgY29tcG9uZW50LCBzbyBhZGQgYSBjb21wb25lbnQgYmluZGluZyBmb3IgaXQKCSAgICAgICAgICAgICAgICBhbGxCaW5kaW5ncyA9IGFsbEJpbmRpbmdzIHx8IHt9OwoKCSAgICAgICAgICAgICAgICBpZiAoYWxsQmluZGluZ3NbJ2NvbXBvbmVudCddKSB7CgkgICAgICAgICAgICAgICAgICAgIC8vIEF2b2lkIHNpbGVudGx5IG92ZXJ3cml0aW5nIHNvbWUgb3RoZXIgJ2NvbXBvbmVudCcgYmluZGluZyB0aGF0IG1heSBhbHJlYWR5IGJlIG9uIHRoZSBlbGVtZW50CgkgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignQ2Fubm90IHVzZSB0aGUgImNvbXBvbmVudCIgYmluZGluZyBvbiBhIGN1c3RvbSBlbGVtZW50IG1hdGNoaW5nIGEgY29tcG9uZW50Jyk7CgkgICAgICAgICAgICAgICAgfQoKCSAgICAgICAgICAgICAgICB2YXIgY29tcG9uZW50QmluZGluZ1ZhbHVlID0geyAnbmFtZSc6IGNvbXBvbmVudE5hbWUsICdwYXJhbXMnOiBnZXRDb21wb25lbnRQYXJhbXNGcm9tQ3VzdG9tRWxlbWVudChub2RlLCBiaW5kaW5nQ29udGV4dCkgfTsKCgkgICAgICAgICAgICAgICAgYWxsQmluZGluZ3NbJ2NvbXBvbmVudCddID0gdmFsdWVBY2Nlc3NvcnMKCSAgICAgICAgICAgICAgICAgICAgPyBmdW5jdGlvbigpIHsgcmV0dXJuIGNvbXBvbmVudEJpbmRpbmdWYWx1ZTsgfQoJICAgICAgICAgICAgICAgICAgICA6IGNvbXBvbmVudEJpbmRpbmdWYWx1ZTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgfQoKCSAgICAgICAgcmV0dXJuIGFsbEJpbmRpbmdzOwoJICAgIH0KCgkgICAgdmFyIG5hdGl2ZUJpbmRpbmdQcm92aWRlckluc3RhbmNlID0gbmV3IGtvLmJpbmRpbmdQcm92aWRlcigpOwoKCSAgICBmdW5jdGlvbiBnZXRDb21wb25lbnRQYXJhbXNGcm9tQ3VzdG9tRWxlbWVudChlbGVtLCBiaW5kaW5nQ29udGV4dCkgewoJICAgICAgICB2YXIgcGFyYW1zQXR0cmlidXRlID0gZWxlbS5nZXRBdHRyaWJ1dGUoJ3BhcmFtcycpOwoKCSAgICAgICAgaWYgKHBhcmFtc0F0dHJpYnV0ZSkgewoJICAgICAgICAgICAgdmFyIHBhcmFtcyA9IG5hdGl2ZUJpbmRpbmdQcm92aWRlckluc3RhbmNlWydwYXJzZUJpbmRpbmdzU3RyaW5nJ10ocGFyYW1zQXR0cmlidXRlLCBiaW5kaW5nQ29udGV4dCwgZWxlbSwgeyAndmFsdWVBY2Nlc3NvcnMnOiB0cnVlLCAnYmluZGluZ1BhcmFtcyc6IHRydWUgfSksCgkgICAgICAgICAgICAgICAgcmF3UGFyYW1Db21wdXRlZFZhbHVlcyA9IGtvLnV0aWxzLm9iamVjdE1hcChwYXJhbXMsIGZ1bmN0aW9uKHBhcmFtVmFsdWUsIHBhcmFtTmFtZSkgewoJICAgICAgICAgICAgICAgICAgICByZXR1cm4ga28uY29tcHV0ZWQocGFyYW1WYWx1ZSwgbnVsbCwgeyBkaXNwb3NlV2hlbk5vZGVJc1JlbW92ZWQ6IGVsZW0gfSk7CgkgICAgICAgICAgICAgICAgfSksCgkgICAgICAgICAgICAgICAgcmVzdWx0ID0ga28udXRpbHMub2JqZWN0TWFwKHJhd1BhcmFtQ29tcHV0ZWRWYWx1ZXMsIGZ1bmN0aW9uKHBhcmFtVmFsdWVDb21wdXRlZCwgcGFyYW1OYW1lKSB7CgkgICAgICAgICAgICAgICAgICAgIC8vIERvZXMgdGhlIGV2YWx1YXRpb24gb2YgdGhlIHBhcmFtZXRlciB2YWx1ZSB1bndyYXAgYW55IG9ic2VydmFibGVzPwoJICAgICAgICAgICAgICAgICAgICBpZiAoIXBhcmFtVmFsdWVDb21wdXRlZC5pc0FjdGl2ZSgpKSB7CgkgICAgICAgICAgICAgICAgICAgICAgICAvLyBObyBpdCBkb2Vzbid0LCBzbyB0aGVyZSdzIG5vIG5lZWQgZm9yIGFueSBjb21wdXRlZCB3cmFwcGVyLiBKdXN0IHBhc3MgdGhyb3VnaCB0aGUgc3VwcGxpZWQgdmFsdWUgZGlyZWN0bHkuCgkgICAgICAgICAgICAgICAgICAgICAgICAvLyBFeGFtcGxlOiAic29tZVZhbDogZmlyc3ROYW1lLCBhZ2U6IDEyMyIgKHdoZXRoZXIgb3Igbm90IGZpcnN0TmFtZSBpcyBhbiBvYnNlcnZhYmxlL2NvbXB1dGVkKQoJICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHBhcmFtVmFsdWVDb21wdXRlZC5wZWVrKCk7CgkgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICAgICAgICAgICAgICAvLyBZZXMgaXQgZG9lcy4gU3VwcGx5IGEgY29tcHV0ZWQgcHJvcGVydHkgdGhhdCB1bndyYXBzIGJvdGggdGhlIG91dGVyIChiaW5kaW5nIGV4cHJlc3Npb24pCgkgICAgICAgICAgICAgICAgICAgICAgICAvLyBsZXZlbCBvZiBvYnNlcnZhYmlsaXR5LCBhbmQgYW55IGlubmVyIChyZXN1bHRpbmcgbW9kZWwgdmFsdWUpIGxldmVsIG9mIG9ic2VydmFiaWxpdHkuCgkgICAgICAgICAgICAgICAgICAgICAgICAvLyBUaGlzIG1lYW5zIHRoZSBjb21wb25lbnQgZG9lc24ndCBoYXZlIHRvIHdvcnJ5IGFib3V0IG11bHRpcGxlIHVud3JhcHBpbmcuCgkgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4ga28uY29tcHV0ZWQoZnVuY3Rpb24oKSB7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUocGFyYW1WYWx1ZUNvbXB1dGVkKCkpOwoJICAgICAgICAgICAgICAgICAgICAgICAgfSwgbnVsbCwgeyBkaXNwb3NlV2hlbk5vZGVJc1JlbW92ZWQ6IGVsZW0gfSk7CgkgICAgICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICB9KTsKCgkgICAgICAgICAgICAvLyBHaXZlIGFjY2VzcyB0byB0aGUgcmF3IGNvbXB1dGVkcywgYXMgbG9uZyBhcyB0aGF0IHdvdWxkbid0IG92ZXJ3cml0ZSBhbnkgY3VzdG9tIHBhcmFtIGFsc28gY2FsbGVkICckcmF3JwoJICAgICAgICAgICAgLy8gVGhpcyBpcyBpbiBjYXNlIHRoZSBkZXZlbG9wZXIgd2FudHMgdG8gcmVhY3QgdG8gb3V0ZXIgKGJpbmRpbmcpIG9ic2VydmFiaWxpdHkgc2VwYXJhdGVseSBmcm9tIGlubmVyCgkgICAgICAgICAgICAvLyAobW9kZWwgdmFsdWUpIG9ic2VydmFiaWxpdHksIG9yIGluIGNhc2UgdGhlIG1vZGVsIHZhbHVlIG9ic2VydmFibGUgaGFzIHN1Ym9ic2VydmFibGVzLgoJICAgICAgICAgICAgaWYgKCFyZXN1bHQuaGFzT3duUHJvcGVydHkoJyRyYXcnKSkgewoJICAgICAgICAgICAgICAgIHJlc3VsdFsnJHJhdyddID0gcmF3UGFyYW1Db21wdXRlZFZhbHVlczsKCSAgICAgICAgICAgIH0KCgkgICAgICAgICAgICByZXR1cm4gcmVzdWx0OwoJICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgLy8gRm9yIGNvbnNpc3RlbmN5LCBhYnNlbmNlIG9mIGEgInBhcmFtcyIgYXR0cmlidXRlIGlzIHRyZWF0ZWQgdGhlIHNhbWUgYXMgdGhlIHByZXNlbmNlIG9mCgkgICAgICAgICAgICAvLyBhbnkgZW1wdHkgb25lLiBPdGhlcndpc2UgY29tcG9uZW50IHZpZXdtb2RlbHMgbmVlZCBzcGVjaWFsIGNvZGUgdG8gY2hlY2sgd2hldGhlciBvciBub3QKCSAgICAgICAgICAgIC8vICdwYXJhbXMnIG9yICdwYXJhbXMuJHJhdycgaXMgbnVsbC91bmRlZmluZWQgYmVmb3JlIHJlYWRpbmcgc3VicHJvcGVydGllcywgd2hpY2ggaXMgYW5ub3lpbmcuCgkgICAgICAgICAgICByZXR1cm4geyAnJHJhdyc6IHt9IH07CgkgICAgICAgIH0KCSAgICB9CgoJICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCgkgICAgLy8gQ29tcGF0aWJpbGl0eSBjb2RlIGZvciBvbGRlciAocHJlLUhUTUw1KSBJRSBicm93c2VycwoKCSAgICBpZiAoa28udXRpbHMuaWVWZXJzaW9uIDwgOSkgewoJICAgICAgICAvLyBXaGVuZXZlciB5b3UgcHJlcmVnaXN0ZXIgYSBjb21wb25lbnQsIGVuYWJsZSBpdCBhcyBhIGN1c3RvbSBlbGVtZW50IGluIHRoZSBjdXJyZW50IGRvY3VtZW50CgkgICAgICAgIGtvLmNvbXBvbmVudHNbJ3JlZ2lzdGVyJ10gPSAoZnVuY3Rpb24ob3JpZ2luYWxGdW5jdGlvbikgewoJICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKGNvbXBvbmVudE5hbWUpIHsKCSAgICAgICAgICAgICAgICBkb2N1bWVudC5jcmVhdGVFbGVtZW50KGNvbXBvbmVudE5hbWUpOyAvLyBBbGxvd3MgSUU8OSB0byBwYXJzZSBtYXJrdXAgY29udGFpbmluZyB0aGUgY3VzdG9tIGVsZW1lbnQKCSAgICAgICAgICAgICAgICByZXR1cm4gb3JpZ2luYWxGdW5jdGlvbi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoJICAgICAgICAgICAgfQoJICAgICAgICB9KShrby5jb21wb25lbnRzWydyZWdpc3RlciddKTsKCgkgICAgICAgIC8vIFdoZW5ldmVyIHlvdSBjcmVhdGUgYSBkb2N1bWVudCBmcmFnbWVudCwgZW5hYmxlIGFsbCBwcmVyZWdpc3RlcmVkIGNvbXBvbmVudCBuYW1lcyBhcyBjdXN0b20gZWxlbWVudHMKCSAgICAgICAgLy8gVGhpcyBpcyBuZWVkZWQgdG8gbWFrZSBpbm5lclNoaXYvalF1ZXJ5IEhUTUwgcGFyc2luZyBjb3JyZWN0bHkgaGFuZGxlIHRoZSBjdXN0b20gZWxlbWVudHMKCSAgICAgICAgZG9jdW1lbnQuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCA9IChmdW5jdGlvbihvcmlnaW5hbEZ1bmN0aW9uKSB7CgkgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CgkgICAgICAgICAgICAgICAgdmFyIG5ld0RvY0ZyYWcgPSBvcmlnaW5hbEZ1bmN0aW9uKCksCgkgICAgICAgICAgICAgICAgICAgIGFsbENvbXBvbmVudHMgPSBrby5jb21wb25lbnRzLl9hbGxSZWdpc3RlcmVkQ29tcG9uZW50czsKCSAgICAgICAgICAgICAgICBmb3IgKHZhciBjb21wb25lbnROYW1lIGluIGFsbENvbXBvbmVudHMpIHsKCSAgICAgICAgICAgICAgICAgICAgaWYgKGFsbENvbXBvbmVudHMuaGFzT3duUHJvcGVydHkoY29tcG9uZW50TmFtZSkpIHsKCSAgICAgICAgICAgICAgICAgICAgICAgIG5ld0RvY0ZyYWcuY3JlYXRlRWxlbWVudChjb21wb25lbnROYW1lKTsKCSAgICAgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICByZXR1cm4gbmV3RG9jRnJhZzsKCSAgICAgICAgICAgIH07CgkgICAgICAgIH0pKGRvY3VtZW50LmNyZWF0ZURvY3VtZW50RnJhZ21lbnQpOwoJICAgIH0KCX0pKCk7KGZ1bmN0aW9uKHVuZGVmaW5lZCkgewoKCSAgICB2YXIgY29tcG9uZW50TG9hZGluZ09wZXJhdGlvblVuaXF1ZUlkID0gMDsKCgkgICAga28uYmluZGluZ0hhbmRsZXJzWydjb21wb25lbnQnXSA9IHsKCSAgICAgICAgJ2luaXQnOiBmdW5jdGlvbihlbGVtZW50LCB2YWx1ZUFjY2Vzc29yLCBpZ25vcmVkMSwgaWdub3JlZDIsIGJpbmRpbmdDb250ZXh0KSB7CgkgICAgICAgICAgICB2YXIgY3VycmVudFZpZXdNb2RlbCwKCSAgICAgICAgICAgICAgICBjdXJyZW50TG9hZGluZ09wZXJhdGlvbklkLAoJICAgICAgICAgICAgICAgIGRpc3Bvc2VBc3NvY2lhdGVkQ29tcG9uZW50Vmlld01vZGVsID0gZnVuY3Rpb24gKCkgewoJICAgICAgICAgICAgICAgICAgICB2YXIgY3VycmVudFZpZXdNb2RlbERpc3Bvc2UgPSBjdXJyZW50Vmlld01vZGVsICYmIGN1cnJlbnRWaWV3TW9kZWxbJ2Rpc3Bvc2UnXTsKCSAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBjdXJyZW50Vmlld01vZGVsRGlzcG9zZSA9PT0gJ2Z1bmN0aW9uJykgewoJICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudFZpZXdNb2RlbERpc3Bvc2UuY2FsbChjdXJyZW50Vmlld01vZGVsKTsKCSAgICAgICAgICAgICAgICAgICAgfQoKCSAgICAgICAgICAgICAgICAgICAgLy8gQW55IGluLWZsaWdodCBsb2FkaW5nIG9wZXJhdGlvbiBpcyBubyBsb25nZXIgcmVsZXZhbnQsIHNvIG1ha2Ugc3VyZSB3ZSBpZ25vcmUgaXRzIGNvbXBsZXRpb24KCSAgICAgICAgICAgICAgICAgICAgY3VycmVudExvYWRpbmdPcGVyYXRpb25JZCA9IG51bGw7CgkgICAgICAgICAgICAgICAgfTsKCgkgICAgICAgICAgICBrby51dGlscy5kb21Ob2RlRGlzcG9zYWwuYWRkRGlzcG9zZUNhbGxiYWNrKGVsZW1lbnQsIGRpc3Bvc2VBc3NvY2lhdGVkQ29tcG9uZW50Vmlld01vZGVsKTsKCgkgICAgICAgICAgICBrby5jb21wdXRlZChmdW5jdGlvbiAoKSB7CgkgICAgICAgICAgICAgICAgdmFyIHZhbHVlID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZSh2YWx1ZUFjY2Vzc29yKCkpLAoJICAgICAgICAgICAgICAgICAgICBjb21wb25lbnROYW1lLCBjb21wb25lbnRQYXJhbXM7CgoJICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICdzdHJpbmcnKSB7CgkgICAgICAgICAgICAgICAgICAgIGNvbXBvbmVudE5hbWUgPSB2YWx1ZTsKCSAgICAgICAgICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgICAgICAgICBjb21wb25lbnROYW1lID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZSh2YWx1ZVsnbmFtZSddKTsKCSAgICAgICAgICAgICAgICAgICAgY29tcG9uZW50UGFyYW1zID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZSh2YWx1ZVsncGFyYW1zJ10pOwoJICAgICAgICAgICAgICAgIH0KCgkgICAgICAgICAgICAgICAgaWYgKCFjb21wb25lbnROYW1lKSB7CgkgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignTm8gY29tcG9uZW50IG5hbWUgc3BlY2lmaWVkJyk7CgkgICAgICAgICAgICAgICAgfQoKCSAgICAgICAgICAgICAgICB2YXIgbG9hZGluZ09wZXJhdGlvbklkID0gY3VycmVudExvYWRpbmdPcGVyYXRpb25JZCA9ICsrY29tcG9uZW50TG9hZGluZ09wZXJhdGlvblVuaXF1ZUlkOwoJICAgICAgICAgICAgICAgIGtvLmNvbXBvbmVudHMuZ2V0KGNvbXBvbmVudE5hbWUsIGZ1bmN0aW9uKGNvbXBvbmVudERlZmluaXRpb24pIHsKCSAgICAgICAgICAgICAgICAgICAgLy8gSWYgdGhpcyBpcyBub3QgdGhlIGN1cnJlbnQgbG9hZCBvcGVyYXRpb24gZm9yIHRoaXMgZWxlbWVudCwgaWdub3JlIGl0LgoJICAgICAgICAgICAgICAgICAgICBpZiAoY3VycmVudExvYWRpbmdPcGVyYXRpb25JZCAhPT0gbG9hZGluZ09wZXJhdGlvbklkKSB7CgkgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CgkgICAgICAgICAgICAgICAgICAgIH0KCgkgICAgICAgICAgICAgICAgICAgIC8vIENsZWFuIHVwIHByZXZpb3VzIHN0YXRlCgkgICAgICAgICAgICAgICAgICAgIGRpc3Bvc2VBc3NvY2lhdGVkQ29tcG9uZW50Vmlld01vZGVsKCk7CgoJICAgICAgICAgICAgICAgICAgICAvLyBJbnN0YW50aWF0ZSBhbmQgYmluZCBuZXcgY29tcG9uZW50LiBJbXBsaWNpdGx5IHRoaXMgY2xlYW5zIGFueSBvbGQgRE9NIG5vZGVzLgoJICAgICAgICAgICAgICAgICAgICBpZiAoIWNvbXBvbmVudERlZmluaXRpb24pIHsKCSAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignVW5rbm93biBjb21wb25lbnQgXCcnICsgY29tcG9uZW50TmFtZSArICdcJycpOwoJICAgICAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgICAgIGNsb25lVGVtcGxhdGVJbnRvRWxlbWVudChjb21wb25lbnROYW1lLCBjb21wb25lbnREZWZpbml0aW9uLCBlbGVtZW50KTsKCSAgICAgICAgICAgICAgICAgICAgdmFyIGNvbXBvbmVudFZpZXdNb2RlbCA9IGNyZWF0ZVZpZXdNb2RlbChjb21wb25lbnREZWZpbml0aW9uLCBlbGVtZW50LCBjb21wb25lbnRQYXJhbXMpLAoJICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRCaW5kaW5nQ29udGV4dCA9IGJpbmRpbmdDb250ZXh0WydjcmVhdGVDaGlsZENvbnRleHQnXShjb21wb25lbnRWaWV3TW9kZWwpOwoJICAgICAgICAgICAgICAgICAgICBjdXJyZW50Vmlld01vZGVsID0gY29tcG9uZW50Vmlld01vZGVsOwoJICAgICAgICAgICAgICAgICAgICBrby5hcHBseUJpbmRpbmdzVG9EZXNjZW5kYW50cyhjaGlsZEJpbmRpbmdDb250ZXh0LCBlbGVtZW50KTsKCSAgICAgICAgICAgICAgICB9KTsKCSAgICAgICAgICAgIH0sIG51bGwsIHsgZGlzcG9zZVdoZW5Ob2RlSXNSZW1vdmVkOiBlbGVtZW50IH0pOwoKCSAgICAgICAgICAgIHJldHVybiB7ICdjb250cm9sc0Rlc2NlbmRhbnRCaW5kaW5ncyc6IHRydWUgfTsKCSAgICAgICAgfQoJICAgIH07CgoJICAgIGtvLnZpcnR1YWxFbGVtZW50cy5hbGxvd2VkQmluZGluZ3NbJ2NvbXBvbmVudCddID0gdHJ1ZTsKCgkgICAgZnVuY3Rpb24gY2xvbmVUZW1wbGF0ZUludG9FbGVtZW50KGNvbXBvbmVudE5hbWUsIGNvbXBvbmVudERlZmluaXRpb24sIGVsZW1lbnQpIHsKCSAgICAgICAgdmFyIHRlbXBsYXRlID0gY29tcG9uZW50RGVmaW5pdGlvblsndGVtcGxhdGUnXTsKCSAgICAgICAgaWYgKCF0ZW1wbGF0ZSkgewoJICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdDb21wb25lbnQgXCcnICsgY29tcG9uZW50TmFtZSArICdcJyBoYXMgbm8gdGVtcGxhdGUnKTsKCSAgICAgICAgfQoKCSAgICAgICAgdmFyIGNsb25lZE5vZGVzQXJyYXkgPSBrby51dGlscy5jbG9uZU5vZGVzKHRlbXBsYXRlKTsKCSAgICAgICAga28udmlydHVhbEVsZW1lbnRzLnNldERvbU5vZGVDaGlsZHJlbihlbGVtZW50LCBjbG9uZWROb2Rlc0FycmF5KTsKCSAgICB9CgoJICAgIGZ1bmN0aW9uIGNyZWF0ZVZpZXdNb2RlbChjb21wb25lbnREZWZpbml0aW9uLCBlbGVtZW50LCBjb21wb25lbnRQYXJhbXMpIHsKCSAgICAgICAgdmFyIGNvbXBvbmVudFZpZXdNb2RlbEZhY3RvcnkgPSBjb21wb25lbnREZWZpbml0aW9uWydjcmVhdGVWaWV3TW9kZWwnXTsKCSAgICAgICAgcmV0dXJuIGNvbXBvbmVudFZpZXdNb2RlbEZhY3RvcnkKCSAgICAgICAgICAgID8gY29tcG9uZW50Vmlld01vZGVsRmFjdG9yeS5jYWxsKGNvbXBvbmVudERlZmluaXRpb24sIGNvbXBvbmVudFBhcmFtcywgeyBlbGVtZW50OiBlbGVtZW50IH0pCgkgICAgICAgICAgICA6IGNvbXBvbmVudFBhcmFtczsgLy8gVGVtcGxhdGUtb25seSBjb21wb25lbnQKCSAgICB9CgoJfSkoKTsKCXZhciBhdHRySHRtbFRvSmF2YXNjcmlwdE1hcCA9IHsgJ2NsYXNzJzogJ2NsYXNzTmFtZScsICdmb3InOiAnaHRtbEZvcicgfTsKCWtvLmJpbmRpbmdIYW5kbGVyc1snYXR0ciddID0gewoJICAgICd1cGRhdGUnOiBmdW5jdGlvbihlbGVtZW50LCB2YWx1ZUFjY2Vzc29yLCBhbGxCaW5kaW5ncykgewoJICAgICAgICB2YXIgdmFsdWUgPSBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKHZhbHVlQWNjZXNzb3IoKSkgfHwge307CgkgICAgICAgIGtvLnV0aWxzLm9iamVjdEZvckVhY2godmFsdWUsIGZ1bmN0aW9uKGF0dHJOYW1lLCBhdHRyVmFsdWUpIHsKCSAgICAgICAgICAgIGF0dHJWYWx1ZSA9IGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUoYXR0clZhbHVlKTsKCgkgICAgICAgICAgICAvLyBUbyBjb3ZlciBjYXNlcyBsaWtlICJhdHRyOiB7IGNoZWNrZWQ6c29tZVByb3AgfSIsIHdlIHdhbnQgdG8gcmVtb3ZlIHRoZSBhdHRyaWJ1dGUgZW50aXJlbHkKCSAgICAgICAgICAgIC8vIHdoZW4gc29tZVByb3AgaXMgYSAibm8gdmFsdWUiLWxpa2UgdmFsdWUgKHN0cmljdGx5IG51bGwsIGZhbHNlLCBvciB1bmRlZmluZWQpCgkgICAgICAgICAgICAvLyAoYmVjYXVzZSB0aGUgYWJzZW5jZSBvZiB0aGUgImNoZWNrZWQiIGF0dHIgaXMgaG93IHRvIG1hcmsgYW4gZWxlbWVudCBhcyBub3QgY2hlY2tlZCwgZXRjLikKCSAgICAgICAgICAgIHZhciB0b1JlbW92ZSA9IChhdHRyVmFsdWUgPT09IGZhbHNlKSB8fCAoYXR0clZhbHVlID09PSBudWxsKSB8fCAoYXR0clZhbHVlID09PSB1bmRlZmluZWQpOwoJICAgICAgICAgICAgaWYgKHRvUmVtb3ZlKQoJICAgICAgICAgICAgICAgIGVsZW1lbnQucmVtb3ZlQXR0cmlidXRlKGF0dHJOYW1lKTsKCgkgICAgICAgICAgICAvLyBJbiBJRSA8PSA3IGFuZCBJRTggUXVpcmtzIE1vZGUsIHlvdSBoYXZlIHRvIHVzZSB0aGUgSmF2YXNjcmlwdCBwcm9wZXJ0eSBuYW1lIGluc3RlYWQgb2YgdGhlCgkgICAgICAgICAgICAvLyBIVE1MIGF0dHJpYnV0ZSBuYW1lIGZvciBjZXJ0YWluIGF0dHJpYnV0ZXMuIElFOCBTdGFuZGFyZHMgTW9kZSBzdXBwb3J0cyB0aGUgY29ycmVjdCBiZWhhdmlvciwKCSAgICAgICAgICAgIC8vIGJ1dCBpbnN0ZWFkIG9mIGZpZ3VyaW5nIG91dCB0aGUgbW9kZSwgd2UnbGwganVzdCBzZXQgdGhlIGF0dHJpYnV0ZSB0aHJvdWdoIHRoZSBKYXZhc2NyaXB0CgkgICAgICAgICAgICAvLyBwcm9wZXJ0eSBmb3IgSUUgPD0gOC4KCSAgICAgICAgICAgIGlmIChrby51dGlscy5pZVZlcnNpb24gPD0gOCAmJiBhdHRyTmFtZSBpbiBhdHRySHRtbFRvSmF2YXNjcmlwdE1hcCkgewoJICAgICAgICAgICAgICAgIGF0dHJOYW1lID0gYXR0ckh0bWxUb0phdmFzY3JpcHRNYXBbYXR0ck5hbWVdOwoJICAgICAgICAgICAgICAgIGlmICh0b1JlbW92ZSkKCSAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5yZW1vdmVBdHRyaWJ1dGUoYXR0ck5hbWUpOwoJICAgICAgICAgICAgICAgIGVsc2UKCSAgICAgICAgICAgICAgICAgICAgZWxlbWVudFthdHRyTmFtZV0gPSBhdHRyVmFsdWU7CgkgICAgICAgICAgICB9IGVsc2UgaWYgKCF0b1JlbW92ZSkgewoJICAgICAgICAgICAgICAgIGVsZW1lbnQuc2V0QXR0cmlidXRlKGF0dHJOYW1lLCBhdHRyVmFsdWUudG9TdHJpbmcoKSk7CgkgICAgICAgICAgICB9CgoJICAgICAgICAgICAgLy8gVHJlYXQgIm5hbWUiIHNwZWNpYWxseSAtIGFsdGhvdWdoIHlvdSBjYW4gdGhpbmsgb2YgaXQgYXMgYW4gYXR0cmlidXRlLCBpdCBhbHNvIG5lZWRzCgkgICAgICAgICAgICAvLyBzcGVjaWFsIGhhbmRsaW5nIG9uIG9sZGVyIHZlcnNpb25zIG9mIElFIChodHRwczovL2dpdGh1Yi5jb20vU3RldmVTYW5kZXJzb24va25vY2tvdXQvcHVsbC8zMzMpCgkgICAgICAgICAgICAvLyBEZWxpYmVyYXRlbHkgYmVpbmcgY2FzZS1zZW5zaXRpdmUgaGVyZSBiZWNhdXNlIFhIVE1MIHdvdWxkIHJlZ2FyZCAiTmFtZSIgYXMgYSBkaWZmZXJlbnQgdGhpbmcKCSAgICAgICAgICAgIC8vIGVudGlyZWx5LCBhbmQgdGhlcmUncyBubyBzdHJvbmcgcmVhc29uIHRvIGFsbG93IGZvciBzdWNoIGNhc2luZyBpbiBIVE1MLgoJICAgICAgICAgICAgaWYgKGF0dHJOYW1lID09PSAibmFtZSIpIHsKCSAgICAgICAgICAgICAgICBrby51dGlscy5zZXRFbGVtZW50TmFtZShlbGVtZW50LCB0b1JlbW92ZSA/ICIiIDogYXR0clZhbHVlLnRvU3RyaW5nKCkpOwoJICAgICAgICAgICAgfQoJICAgICAgICB9KTsKCSAgICB9Cgl9OwoJKGZ1bmN0aW9uKCkgewoKCWtvLmJpbmRpbmdIYW5kbGVyc1snY2hlY2tlZCddID0gewoJICAgICdhZnRlcic6IFsndmFsdWUnLCAnYXR0ciddLAoJICAgICdpbml0JzogZnVuY3Rpb24gKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IsIGFsbEJpbmRpbmdzKSB7CgkgICAgICAgIHZhciBjaGVja2VkVmFsdWUgPSBrby5wdXJlQ29tcHV0ZWQoZnVuY3Rpb24oKSB7CgkgICAgICAgICAgICAvLyBUcmVhdCAidmFsdWUiIGxpa2UgImNoZWNrZWRWYWx1ZSIgd2hlbiBpdCBpcyBpbmNsdWRlZCB3aXRoICJjaGVja2VkIiBiaW5kaW5nCgkgICAgICAgICAgICBpZiAoYWxsQmluZGluZ3NbJ2hhcyddKCdjaGVja2VkVmFsdWUnKSkgewoJICAgICAgICAgICAgICAgIHJldHVybiBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKGFsbEJpbmRpbmdzLmdldCgnY2hlY2tlZFZhbHVlJykpOwoJICAgICAgICAgICAgfSBlbHNlIGlmIChhbGxCaW5kaW5nc1snaGFzJ10oJ3ZhbHVlJykpIHsKCSAgICAgICAgICAgICAgICByZXR1cm4ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZShhbGxCaW5kaW5ncy5nZXQoJ3ZhbHVlJykpOwoJICAgICAgICAgICAgfQoKCSAgICAgICAgICAgIHJldHVybiBlbGVtZW50LnZhbHVlOwoJICAgICAgICB9KTsKCgkgICAgICAgIGZ1bmN0aW9uIHVwZGF0ZU1vZGVsKCkgewoJICAgICAgICAgICAgLy8gVGhpcyB1cGRhdGVzIHRoZSBtb2RlbCB2YWx1ZSBmcm9tIHRoZSB2aWV3IHZhbHVlLgoJICAgICAgICAgICAgLy8gSXQgcnVucyBpbiByZXNwb25zZSB0byBET00gZXZlbnRzIChjbGljaykgYW5kIGNoYW5nZXMgaW4gY2hlY2tlZFZhbHVlLgoJICAgICAgICAgICAgdmFyIGlzQ2hlY2tlZCA9IGVsZW1lbnQuY2hlY2tlZCwKCSAgICAgICAgICAgICAgICBlbGVtVmFsdWUgPSB1c2VDaGVja2VkVmFsdWUgPyBjaGVja2VkVmFsdWUoKSA6IGlzQ2hlY2tlZDsKCgkgICAgICAgICAgICAvLyBXaGVuIHdlJ3JlIGZpcnN0IHNldHRpbmcgdXAgdGhpcyBjb21wdXRlZCwgZG9uJ3QgY2hhbmdlIGFueSBtb2RlbCBzdGF0ZS4KCSAgICAgICAgICAgIGlmIChrby5jb21wdXRlZENvbnRleHQuaXNJbml0aWFsKCkpIHsKCSAgICAgICAgICAgICAgICByZXR1cm47CgkgICAgICAgICAgICB9CgoJICAgICAgICAgICAgLy8gV2UgY2FuIGlnbm9yZSB1bmNoZWNrZWQgcmFkaW8gYnV0dG9ucywgYmVjYXVzZSBzb21lIG90aGVyIHJhZGlvCgkgICAgICAgICAgICAvLyBidXR0b24gd2lsbCBiZSBnZXR0aW5nIGNoZWNrZWQsIGFuZCB0aGF0IG9uZSBjYW4gdGFrZSBjYXJlIG9mIHVwZGF0aW5nIHN0YXRlLgoJICAgICAgICAgICAgaWYgKGlzUmFkaW8gJiYgIWlzQ2hlY2tlZCkgewoJICAgICAgICAgICAgICAgIHJldHVybjsKCSAgICAgICAgICAgIH0KCgkgICAgICAgICAgICB2YXIgbW9kZWxWYWx1ZSA9IGtvLmRlcGVuZGVuY3lEZXRlY3Rpb24uaWdub3JlKHZhbHVlQWNjZXNzb3IpOwoJICAgICAgICAgICAgaWYgKGlzVmFsdWVBcnJheSkgewoJICAgICAgICAgICAgICAgIGlmIChvbGRFbGVtVmFsdWUgIT09IGVsZW1WYWx1ZSkgewoJICAgICAgICAgICAgICAgICAgICAvLyBXaGVuIHdlJ3JlIHJlc3BvbmRpbmcgdG8gdGhlIGNoZWNrZWRWYWx1ZSBjaGFuZ2luZywgYW5kIHRoZSBlbGVtZW50IGlzCgkgICAgICAgICAgICAgICAgICAgIC8vIGN1cnJlbnRseSBjaGVja2VkLCByZXBsYWNlIHRoZSBvbGQgZWxlbSB2YWx1ZSB3aXRoIHRoZSBuZXcgZWxlbSB2YWx1ZQoJICAgICAgICAgICAgICAgICAgICAvLyBpbiB0aGUgbW9kZWwgYXJyYXkuCgkgICAgICAgICAgICAgICAgICAgIGlmIChpc0NoZWNrZWQpIHsKCSAgICAgICAgICAgICAgICAgICAgICAgIGtvLnV0aWxzLmFkZE9yUmVtb3ZlSXRlbShtb2RlbFZhbHVlLCBlbGVtVmFsdWUsIHRydWUpOwoJICAgICAgICAgICAgICAgICAgICAgICAga28udXRpbHMuYWRkT3JSZW1vdmVJdGVtKG1vZGVsVmFsdWUsIG9sZEVsZW1WYWx1ZSwgZmFsc2UpOwoJICAgICAgICAgICAgICAgICAgICB9CgoJICAgICAgICAgICAgICAgICAgICBvbGRFbGVtVmFsdWUgPSBlbGVtVmFsdWU7CgkgICAgICAgICAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgICAgICAgICAgLy8gV2hlbiB3ZSdyZSByZXNwb25kaW5nIHRvIHRoZSB1c2VyIGhhdmluZyBjaGVja2VkL3VuY2hlY2tlZCBhIGNoZWNrYm94LAoJICAgICAgICAgICAgICAgICAgICAvLyBhZGQvcmVtb3ZlIHRoZSBlbGVtZW50IHZhbHVlIHRvIHRoZSBtb2RlbCBhcnJheS4KCSAgICAgICAgICAgICAgICAgICAga28udXRpbHMuYWRkT3JSZW1vdmVJdGVtKG1vZGVsVmFsdWUsIGVsZW1WYWx1ZSwgaXNDaGVja2VkKTsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgICAgIGtvLmV4cHJlc3Npb25SZXdyaXRpbmcud3JpdGVWYWx1ZVRvUHJvcGVydHkobW9kZWxWYWx1ZSwgYWxsQmluZGluZ3MsICdjaGVja2VkJywgZWxlbVZhbHVlLCB0cnVlKTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgfTsKCgkgICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVZpZXcoKSB7CgkgICAgICAgICAgICAvLyBUaGlzIHVwZGF0ZXMgdGhlIHZpZXcgdmFsdWUgZnJvbSB0aGUgbW9kZWwgdmFsdWUuCgkgICAgICAgICAgICAvLyBJdCBydW5zIGluIHJlc3BvbnNlIHRvIGNoYW5nZXMgaW4gdGhlIGJvdW5kIChjaGVja2VkKSB2YWx1ZS4KCSAgICAgICAgICAgIHZhciBtb2RlbFZhbHVlID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZSh2YWx1ZUFjY2Vzc29yKCkpOwoKCSAgICAgICAgICAgIGlmIChpc1ZhbHVlQXJyYXkpIHsKCSAgICAgICAgICAgICAgICAvLyBXaGVuIGEgY2hlY2tib3ggaXMgYm91bmQgdG8gYW4gYXJyYXksIGJlaW5nIGNoZWNrZWQgcmVwcmVzZW50cyBpdHMgdmFsdWUgYmVpbmcgcHJlc2VudCBpbiB0aGF0IGFycmF5CgkgICAgICAgICAgICAgICAgZWxlbWVudC5jaGVja2VkID0ga28udXRpbHMuYXJyYXlJbmRleE9mKG1vZGVsVmFsdWUsIGNoZWNrZWRWYWx1ZSgpKSA+PSAwOwoJICAgICAgICAgICAgfSBlbHNlIGlmIChpc0NoZWNrYm94KSB7CgkgICAgICAgICAgICAgICAgLy8gV2hlbiBhIGNoZWNrYm94IGlzIGJvdW5kIHRvIGFueSBvdGhlciB2YWx1ZSAobm90IGFuIGFycmF5KSwgYmVpbmcgY2hlY2tlZCByZXByZXNlbnRzIHRoZSB2YWx1ZSBiZWluZyB0cnVlaXNoCgkgICAgICAgICAgICAgICAgZWxlbWVudC5jaGVja2VkID0gbW9kZWxWYWx1ZTsKCSAgICAgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICAgICAgLy8gRm9yIHJhZGlvIGJ1dHRvbnMsIGJlaW5nIGNoZWNrZWQgbWVhbnMgdGhhdCB0aGUgcmFkaW8gYnV0dG9uJ3MgdmFsdWUgY29ycmVzcG9uZHMgdG8gdGhlIG1vZGVsIHZhbHVlCgkgICAgICAgICAgICAgICAgZWxlbWVudC5jaGVja2VkID0gKGNoZWNrZWRWYWx1ZSgpID09PSBtb2RlbFZhbHVlKTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgfTsKCgkgICAgICAgIHZhciBpc0NoZWNrYm94ID0gZWxlbWVudC50eXBlID09ICJjaGVja2JveCIsCgkgICAgICAgICAgICBpc1JhZGlvID0gZWxlbWVudC50eXBlID09ICJyYWRpbyI7CgoJICAgICAgICAvLyBPbmx5IGJpbmQgdG8gY2hlY2sgYm94ZXMgYW5kIHJhZGlvIGJ1dHRvbnMKCSAgICAgICAgaWYgKCFpc0NoZWNrYm94ICYmICFpc1JhZGlvKSB7CgkgICAgICAgICAgICByZXR1cm47CgkgICAgICAgIH0KCgkgICAgICAgIHZhciBpc1ZhbHVlQXJyYXkgPSBpc0NoZWNrYm94ICYmIChrby51dGlscy51bndyYXBPYnNlcnZhYmxlKHZhbHVlQWNjZXNzb3IoKSkgaW5zdGFuY2VvZiBBcnJheSksCgkgICAgICAgICAgICBvbGRFbGVtVmFsdWUgPSBpc1ZhbHVlQXJyYXkgPyBjaGVja2VkVmFsdWUoKSA6IHVuZGVmaW5lZCwKCSAgICAgICAgICAgIHVzZUNoZWNrZWRWYWx1ZSA9IGlzUmFkaW8gfHwgaXNWYWx1ZUFycmF5OwoKCSAgICAgICAgLy8gSUUgNiB3b24ndCBhbGxvdyByYWRpbyBidXR0b25zIHRvIGJlIHNlbGVjdGVkIHVubGVzcyB0aGV5IGhhdmUgYSBuYW1lCgkgICAgICAgIGlmIChpc1JhZGlvICYmICFlbGVtZW50Lm5hbWUpCgkgICAgICAgICAgICBrby5iaW5kaW5nSGFuZGxlcnNbJ3VuaXF1ZU5hbWUnXVsnaW5pdCddKGVsZW1lbnQsIGZ1bmN0aW9uKCkgeyByZXR1cm4gdHJ1ZSB9KTsKCgkgICAgICAgIC8vIFNldCB1cCB0d28gY29tcHV0ZWRzIHRvIHVwZGF0ZSB0aGUgYmluZGluZzoKCgkgICAgICAgIC8vIFRoZSBmaXJzdCByZXNwb25kcyB0byBjaGFuZ2VzIGluIHRoZSBjaGVja2VkVmFsdWUgdmFsdWUgYW5kIHRvIGVsZW1lbnQgY2xpY2tzCgkgICAgICAgIGtvLmNvbXB1dGVkKHVwZGF0ZU1vZGVsLCBudWxsLCB7IGRpc3Bvc2VXaGVuTm9kZUlzUmVtb3ZlZDogZWxlbWVudCB9KTsKCSAgICAgICAga28udXRpbHMucmVnaXN0ZXJFdmVudEhhbmRsZXIoZWxlbWVudCwgImNsaWNrIiwgdXBkYXRlTW9kZWwpOwoKCSAgICAgICAgLy8gVGhlIHNlY29uZCByZXNwb25kcyB0byBjaGFuZ2VzIGluIHRoZSBtb2RlbCB2YWx1ZSAodGhlIG9uZSBhc3NvY2lhdGVkIHdpdGggdGhlIGNoZWNrZWQgYmluZGluZykKCSAgICAgICAga28uY29tcHV0ZWQodXBkYXRlVmlldywgbnVsbCwgeyBkaXNwb3NlV2hlbk5vZGVJc1JlbW92ZWQ6IGVsZW1lbnQgfSk7CgkgICAgfQoJfTsKCWtvLmV4cHJlc3Npb25SZXdyaXRpbmcudHdvV2F5QmluZGluZ3NbJ2NoZWNrZWQnXSA9IHRydWU7CgoJa28uYmluZGluZ0hhbmRsZXJzWydjaGVja2VkVmFsdWUnXSA9IHsKCSAgICAndXBkYXRlJzogZnVuY3Rpb24gKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IpIHsKCSAgICAgICAgZWxlbWVudC52YWx1ZSA9IGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUodmFsdWVBY2Nlc3NvcigpKTsKCSAgICB9Cgl9OwoKCX0pKCk7dmFyIGNsYXNzZXNXcml0dGVuQnlCaW5kaW5nS2V5ID0gJ19fa29fX2Nzc1ZhbHVlJzsKCWtvLmJpbmRpbmdIYW5kbGVyc1snY3NzJ10gPSB7CgkgICAgJ3VwZGF0ZSc6IGZ1bmN0aW9uIChlbGVtZW50LCB2YWx1ZUFjY2Vzc29yKSB7CgkgICAgICAgIHZhciB2YWx1ZSA9IGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUodmFsdWVBY2Nlc3NvcigpKTsKCSAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PSAib2JqZWN0IikgewoJICAgICAgICAgICAga28udXRpbHMub2JqZWN0Rm9yRWFjaCh2YWx1ZSwgZnVuY3Rpb24oY2xhc3NOYW1lLCBzaG91bGRIYXZlQ2xhc3MpIHsKCSAgICAgICAgICAgICAgICBzaG91bGRIYXZlQ2xhc3MgPSBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKHNob3VsZEhhdmVDbGFzcyk7CgkgICAgICAgICAgICAgICAga28udXRpbHMudG9nZ2xlRG9tTm9kZUNzc0NsYXNzKGVsZW1lbnQsIGNsYXNzTmFtZSwgc2hvdWxkSGF2ZUNsYXNzKTsKCSAgICAgICAgICAgIH0pOwoJICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgdmFsdWUgPSBTdHJpbmcodmFsdWUgfHwgJycpOyAvLyBNYWtlIHN1cmUgd2UgZG9uJ3QgdHJ5IHRvIHN0b3JlIG9yIHNldCBhIG5vbi1zdHJpbmcgdmFsdWUKCSAgICAgICAgICAgIGtvLnV0aWxzLnRvZ2dsZURvbU5vZGVDc3NDbGFzcyhlbGVtZW50LCBlbGVtZW50W2NsYXNzZXNXcml0dGVuQnlCaW5kaW5nS2V5XSwgZmFsc2UpOwoJICAgICAgICAgICAgZWxlbWVudFtjbGFzc2VzV3JpdHRlbkJ5QmluZGluZ0tleV0gPSB2YWx1ZTsKCSAgICAgICAgICAgIGtvLnV0aWxzLnRvZ2dsZURvbU5vZGVDc3NDbGFzcyhlbGVtZW50LCB2YWx1ZSwgdHJ1ZSk7CgkgICAgICAgIH0KCSAgICB9Cgl9OwoJa28uYmluZGluZ0hhbmRsZXJzWydlbmFibGUnXSA9IHsKCSAgICAndXBkYXRlJzogZnVuY3Rpb24gKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IpIHsKCSAgICAgICAgdmFyIHZhbHVlID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZSh2YWx1ZUFjY2Vzc29yKCkpOwoJICAgICAgICBpZiAodmFsdWUgJiYgZWxlbWVudC5kaXNhYmxlZCkKCSAgICAgICAgICAgIGVsZW1lbnQucmVtb3ZlQXR0cmlidXRlKCJkaXNhYmxlZCIpOwoJICAgICAgICBlbHNlIGlmICgoIXZhbHVlKSAmJiAoIWVsZW1lbnQuZGlzYWJsZWQpKQoJICAgICAgICAgICAgZWxlbWVudC5kaXNhYmxlZCA9IHRydWU7CgkgICAgfQoJfTsKCglrby5iaW5kaW5nSGFuZGxlcnNbJ2Rpc2FibGUnXSA9IHsKCSAgICAndXBkYXRlJzogZnVuY3Rpb24gKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IpIHsKCSAgICAgICAga28uYmluZGluZ0hhbmRsZXJzWydlbmFibGUnXVsndXBkYXRlJ10oZWxlbWVudCwgZnVuY3Rpb24oKSB7IHJldHVybiAha28udXRpbHMudW53cmFwT2JzZXJ2YWJsZSh2YWx1ZUFjY2Vzc29yKCkpIH0pOwoJICAgIH0KCX07CgkvLyBGb3IgY2VydGFpbiBjb21tb24gZXZlbnRzIChjdXJyZW50bHkganVzdCAnY2xpY2snKSwgYWxsb3cgYSBzaW1wbGlmaWVkIGRhdGEtYmluZGluZyBzeW50YXgKCS8vIGUuZy4gY2xpY2s6aGFuZGxlciBpbnN0ZWFkIG9mIHRoZSB1c3VhbCBmdWxsLWxlbmd0aCBldmVudDp7Y2xpY2s6aGFuZGxlcn0KCWZ1bmN0aW9uIG1ha2VFdmVudEhhbmRsZXJTaG9ydGN1dChldmVudE5hbWUpIHsKCSAgICBrby5iaW5kaW5nSGFuZGxlcnNbZXZlbnROYW1lXSA9IHsKCSAgICAgICAgJ2luaXQnOiBmdW5jdGlvbihlbGVtZW50LCB2YWx1ZUFjY2Vzc29yLCBhbGxCaW5kaW5ncywgdmlld01vZGVsLCBiaW5kaW5nQ29udGV4dCkgewoJICAgICAgICAgICAgdmFyIG5ld1ZhbHVlQWNjZXNzb3IgPSBmdW5jdGlvbiAoKSB7CgkgICAgICAgICAgICAgICAgdmFyIHJlc3VsdCA9IHt9OwoJICAgICAgICAgICAgICAgIHJlc3VsdFtldmVudE5hbWVdID0gdmFsdWVBY2Nlc3NvcigpOwoJICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHQ7CgkgICAgICAgICAgICB9OwoJICAgICAgICAgICAgcmV0dXJuIGtvLmJpbmRpbmdIYW5kbGVyc1snZXZlbnQnXVsnaW5pdCddLmNhbGwodGhpcywgZWxlbWVudCwgbmV3VmFsdWVBY2Nlc3NvciwgYWxsQmluZGluZ3MsIHZpZXdNb2RlbCwgYmluZGluZ0NvbnRleHQpOwoJICAgICAgICB9CgkgICAgfQoJfQoKCWtvLmJpbmRpbmdIYW5kbGVyc1snZXZlbnQnXSA9IHsKCSAgICAnaW5pdCcgOiBmdW5jdGlvbiAoZWxlbWVudCwgdmFsdWVBY2Nlc3NvciwgYWxsQmluZGluZ3MsIHZpZXdNb2RlbCwgYmluZGluZ0NvbnRleHQpIHsKCSAgICAgICAgdmFyIGV2ZW50c1RvSGFuZGxlID0gdmFsdWVBY2Nlc3NvcigpIHx8IHt9OwoJICAgICAgICBrby51dGlscy5vYmplY3RGb3JFYWNoKGV2ZW50c1RvSGFuZGxlLCBmdW5jdGlvbihldmVudE5hbWUpIHsKCSAgICAgICAgICAgIGlmICh0eXBlb2YgZXZlbnROYW1lID09ICJzdHJpbmciKSB7CgkgICAgICAgICAgICAgICAga28udXRpbHMucmVnaXN0ZXJFdmVudEhhbmRsZXIoZWxlbWVudCwgZXZlbnROYW1lLCBmdW5jdGlvbiAoZXZlbnQpIHsKCSAgICAgICAgICAgICAgICAgICAgdmFyIGhhbmRsZXJSZXR1cm5WYWx1ZTsKCSAgICAgICAgICAgICAgICAgICAgdmFyIGhhbmRsZXJGdW5jdGlvbiA9IHZhbHVlQWNjZXNzb3IoKVtldmVudE5hbWVdOwoJICAgICAgICAgICAgICAgICAgICBpZiAoIWhhbmRsZXJGdW5jdGlvbikKCSAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKCgkgICAgICAgICAgICAgICAgICAgIHRyeSB7CgkgICAgICAgICAgICAgICAgICAgICAgICAvLyBUYWtlIGFsbCB0aGUgZXZlbnQgYXJncywgYW5kIHByZWZpeCB3aXRoIHRoZSB2aWV3bW9kZWwKCSAgICAgICAgICAgICAgICAgICAgICAgIHZhciBhcmdzRm9ySGFuZGxlciA9IGtvLnV0aWxzLm1ha2VBcnJheShhcmd1bWVudHMpOwoJICAgICAgICAgICAgICAgICAgICAgICAgdmlld01vZGVsID0gYmluZGluZ0NvbnRleHRbJyRkYXRhJ107CgkgICAgICAgICAgICAgICAgICAgICAgICBhcmdzRm9ySGFuZGxlci51bnNoaWZ0KHZpZXdNb2RlbCk7CgkgICAgICAgICAgICAgICAgICAgICAgICBoYW5kbGVyUmV0dXJuVmFsdWUgPSBoYW5kbGVyRnVuY3Rpb24uYXBwbHkodmlld01vZGVsLCBhcmdzRm9ySGFuZGxlcik7CgkgICAgICAgICAgICAgICAgICAgIH0gZmluYWxseSB7CgkgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaGFuZGxlclJldHVyblZhbHVlICE9PSB0cnVlKSB7IC8vIE5vcm1hbGx5IHdlIHdhbnQgdG8gcHJldmVudCBkZWZhdWx0IGFjdGlvbi4gRGV2ZWxvcGVyIGNhbiBvdmVycmlkZSB0aGlzIGJlIGV4cGxpY2l0bHkgcmV0dXJuaW5nIHRydWUuCgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGV2ZW50LnByZXZlbnREZWZhdWx0KQoJICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQucmV0dXJuVmFsdWUgPSBmYWxzZTsKCSAgICAgICAgICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICAgICAgfQoKCSAgICAgICAgICAgICAgICAgICAgdmFyIGJ1YmJsZSA9IGFsbEJpbmRpbmdzLmdldChldmVudE5hbWUgKyAnQnViYmxlJykgIT09IGZhbHNlOwoJICAgICAgICAgICAgICAgICAgICBpZiAoIWJ1YmJsZSkgewoJICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQuY2FuY2VsQnViYmxlID0gdHJ1ZTsKCSAgICAgICAgICAgICAgICAgICAgICAgIGlmIChldmVudC5zdG9wUHJvcGFnYXRpb24pCgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7CgkgICAgICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICB9KTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgfSk7CgkgICAgfQoJfTsKCS8vICJmb3JlYWNoOiBzb21lRXhwcmVzc2lvbiIgaXMgZXF1aXZhbGVudCB0byAidGVtcGxhdGU6IHsgZm9yZWFjaDogc29tZUV4cHJlc3Npb24gfSIKCS8vICJmb3JlYWNoOiB7IGRhdGE6IHNvbWVFeHByZXNzaW9uLCBhZnRlckFkZDogbXlmbiB9IiBpcyBlcXVpdmFsZW50IHRvICJ0ZW1wbGF0ZTogeyBmb3JlYWNoOiBzb21lRXhwcmVzc2lvbiwgYWZ0ZXJBZGQ6IG15Zm4gfSIKCWtvLmJpbmRpbmdIYW5kbGVyc1snZm9yZWFjaCddID0gewoJICAgIG1ha2VUZW1wbGF0ZVZhbHVlQWNjZXNzb3I6IGZ1bmN0aW9uKHZhbHVlQWNjZXNzb3IpIHsKCSAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewoJICAgICAgICAgICAgdmFyIG1vZGVsVmFsdWUgPSB2YWx1ZUFjY2Vzc29yKCksCgkgICAgICAgICAgICAgICAgdW53cmFwcGVkVmFsdWUgPSBrby51dGlscy5wZWVrT2JzZXJ2YWJsZShtb2RlbFZhbHVlKTsgICAgLy8gVW53cmFwIHdpdGhvdXQgc2V0dGluZyBhIGRlcGVuZGVuY3kgaGVyZQoKCSAgICAgICAgICAgIC8vIElmIHVud3JhcHBlZFZhbHVlIGlzIHRoZSBhcnJheSwgcGFzcyBpbiB0aGUgd3JhcHBlZCB2YWx1ZSBvbiBpdHMgb3duCgkgICAgICAgICAgICAvLyBUaGUgdmFsdWUgd2lsbCBiZSB1bndyYXBwZWQgYW5kIHRyYWNrZWQgd2l0aGluIHRoZSB0ZW1wbGF0ZSBiaW5kaW5nCgkgICAgICAgICAgICAvLyAoU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9TdGV2ZVNhbmRlcnNvbi9rbm9ja291dC9pc3N1ZXMvNTIzKQoJICAgICAgICAgICAgaWYgKCghdW53cmFwcGVkVmFsdWUpIHx8IHR5cGVvZiB1bndyYXBwZWRWYWx1ZS5sZW5ndGggPT0gIm51bWJlciIpCgkgICAgICAgICAgICAgICAgcmV0dXJuIHsgJ2ZvcmVhY2gnOiBtb2RlbFZhbHVlLCAndGVtcGxhdGVFbmdpbmUnOiBrby5uYXRpdmVUZW1wbGF0ZUVuZ2luZS5pbnN0YW5jZSB9OwoKCSAgICAgICAgICAgIC8vIElmIHVud3JhcHBlZFZhbHVlLmRhdGEgaXMgdGhlIGFycmF5LCBwcmVzZXJ2ZSBhbGwgcmVsZXZhbnQgb3B0aW9ucyBhbmQgdW53cmFwIGFnYWluIHZhbHVlIHNvIHdlIGdldCB1cGRhdGVzCgkgICAgICAgICAgICBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKG1vZGVsVmFsdWUpOwoJICAgICAgICAgICAgcmV0dXJuIHsKCSAgICAgICAgICAgICAgICAnZm9yZWFjaCc6IHVud3JhcHBlZFZhbHVlWydkYXRhJ10sCgkgICAgICAgICAgICAgICAgJ2FzJzogdW53cmFwcGVkVmFsdWVbJ2FzJ10sCgkgICAgICAgICAgICAgICAgJ2luY2x1ZGVEZXN0cm95ZWQnOiB1bndyYXBwZWRWYWx1ZVsnaW5jbHVkZURlc3Ryb3llZCddLAoJICAgICAgICAgICAgICAgICdhZnRlckFkZCc6IHVud3JhcHBlZFZhbHVlWydhZnRlckFkZCddLAoJICAgICAgICAgICAgICAgICdiZWZvcmVSZW1vdmUnOiB1bndyYXBwZWRWYWx1ZVsnYmVmb3JlUmVtb3ZlJ10sCgkgICAgICAgICAgICAgICAgJ2FmdGVyUmVuZGVyJzogdW53cmFwcGVkVmFsdWVbJ2FmdGVyUmVuZGVyJ10sCgkgICAgICAgICAgICAgICAgJ2JlZm9yZU1vdmUnOiB1bndyYXBwZWRWYWx1ZVsnYmVmb3JlTW92ZSddLAoJICAgICAgICAgICAgICAgICdhZnRlck1vdmUnOiB1bndyYXBwZWRWYWx1ZVsnYWZ0ZXJNb3ZlJ10sCgkgICAgICAgICAgICAgICAgJ3RlbXBsYXRlRW5naW5lJzoga28ubmF0aXZlVGVtcGxhdGVFbmdpbmUuaW5zdGFuY2UKCSAgICAgICAgICAgIH07CgkgICAgICAgIH07CgkgICAgfSwKCSAgICAnaW5pdCc6IGZ1bmN0aW9uKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IsIGFsbEJpbmRpbmdzLCB2aWV3TW9kZWwsIGJpbmRpbmdDb250ZXh0KSB7CgkgICAgICAgIHJldHVybiBrby5iaW5kaW5nSGFuZGxlcnNbJ3RlbXBsYXRlJ11bJ2luaXQnXShlbGVtZW50LCBrby5iaW5kaW5nSGFuZGxlcnNbJ2ZvcmVhY2gnXS5tYWtlVGVtcGxhdGVWYWx1ZUFjY2Vzc29yKHZhbHVlQWNjZXNzb3IpKTsKCSAgICB9LAoJICAgICd1cGRhdGUnOiBmdW5jdGlvbihlbGVtZW50LCB2YWx1ZUFjY2Vzc29yLCBhbGxCaW5kaW5ncywgdmlld01vZGVsLCBiaW5kaW5nQ29udGV4dCkgewoJICAgICAgICByZXR1cm4ga28uYmluZGluZ0hhbmRsZXJzWyd0ZW1wbGF0ZSddWyd1cGRhdGUnXShlbGVtZW50LCBrby5iaW5kaW5nSGFuZGxlcnNbJ2ZvcmVhY2gnXS5tYWtlVGVtcGxhdGVWYWx1ZUFjY2Vzc29yKHZhbHVlQWNjZXNzb3IpLCBhbGxCaW5kaW5ncywgdmlld01vZGVsLCBiaW5kaW5nQ29udGV4dCk7CgkgICAgfQoJfTsKCWtvLmV4cHJlc3Npb25SZXdyaXRpbmcuYmluZGluZ1Jld3JpdGVWYWxpZGF0b3JzWydmb3JlYWNoJ10gPSBmYWxzZTsgLy8gQ2FuJ3QgcmV3cml0ZSBjb250cm9sIGZsb3cgYmluZGluZ3MKCWtvLnZpcnR1YWxFbGVtZW50cy5hbGxvd2VkQmluZGluZ3NbJ2ZvcmVhY2gnXSA9IHRydWU7Cgl2YXIgaGFzZm9jdXNVcGRhdGluZ1Byb3BlcnR5ID0gJ19fa29faGFzZm9jdXNVcGRhdGluZyc7Cgl2YXIgaGFzZm9jdXNMYXN0VmFsdWUgPSAnX19rb19oYXNmb2N1c0xhc3RWYWx1ZSc7Cglrby5iaW5kaW5nSGFuZGxlcnNbJ2hhc2ZvY3VzJ10gPSB7CgkgICAgJ2luaXQnOiBmdW5jdGlvbihlbGVtZW50LCB2YWx1ZUFjY2Vzc29yLCBhbGxCaW5kaW5ncykgewoJICAgICAgICB2YXIgaGFuZGxlRWxlbWVudEZvY3VzQ2hhbmdlID0gZnVuY3Rpb24oaXNGb2N1c2VkKSB7CgkgICAgICAgICAgICAvLyBXaGVyZSBwb3NzaWJsZSwgaWdub3JlIHdoaWNoIGV2ZW50IHdhcyByYWlzZWQgYW5kIGRldGVybWluZSBmb2N1cyBzdGF0ZSB1c2luZyBhY3RpdmVFbGVtZW50LAoJICAgICAgICAgICAgLy8gYXMgdGhpcyBhdm9pZHMgcGhhbnRvbSBmb2N1cy9ibHVyIGV2ZW50cyByYWlzZWQgd2hlbiBjaGFuZ2luZyB0YWJzIGluIG1vZGVybiBicm93c2Vycy4KCSAgICAgICAgICAgIC8vIEhvd2V2ZXIsIG5vdCBhbGwgS08tdGFyZ2V0ZWQgYnJvd3NlcnMgKEZpcmVmb3ggMikgc3VwcG9ydCBhY3RpdmVFbGVtZW50LiBGb3IgdGhvc2UgYnJvd3NlcnMsCgkgICAgICAgICAgICAvLyBwcmV2ZW50IGEgbG9zcyBvZiBmb2N1cyB3aGVuIGNoYW5naW5nIHRhYnMvd2luZG93cyBieSBzZXR0aW5nIGEgZmxhZyB0aGF0IHByZXZlbnRzIGhhc2ZvY3VzCgkgICAgICAgICAgICAvLyBmcm9tIGNhbGxpbmcgJ2JsdXIoKScgb24gdGhlIGVsZW1lbnQgd2hlbiBpdCBsb3NlcyBmb2N1cy4KCSAgICAgICAgICAgIC8vIERpc2N1c3Npb24gYXQgaHR0cHM6Ly9naXRodWIuY29tL1N0ZXZlU2FuZGVyc29uL2tub2Nrb3V0L3B1bGwvMzUyCgkgICAgICAgICAgICBlbGVtZW50W2hhc2ZvY3VzVXBkYXRpbmdQcm9wZXJ0eV0gPSB0cnVlOwoJICAgICAgICAgICAgdmFyIG93bmVyRG9jID0gZWxlbWVudC5vd25lckRvY3VtZW50OwoJICAgICAgICAgICAgaWYgKCJhY3RpdmVFbGVtZW50IiBpbiBvd25lckRvYykgewoJICAgICAgICAgICAgICAgIHZhciBhY3RpdmU7CgkgICAgICAgICAgICAgICAgdHJ5IHsKCSAgICAgICAgICAgICAgICAgICAgYWN0aXZlID0gb3duZXJEb2MuYWN0aXZlRWxlbWVudDsKCSAgICAgICAgICAgICAgICB9IGNhdGNoKGUpIHsKCSAgICAgICAgICAgICAgICAgICAgLy8gSUU5IHRocm93cyBpZiB5b3UgYWNjZXNzIGFjdGl2ZUVsZW1lbnQgZHVyaW5nIHBhZ2UgbG9hZCAoc2VlIGlzc3VlICM3MDMpCgkgICAgICAgICAgICAgICAgICAgIGFjdGl2ZSA9IG93bmVyRG9jLmJvZHk7CgkgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgIGlzRm9jdXNlZCA9IChhY3RpdmUgPT09IGVsZW1lbnQpOwoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgdmFyIG1vZGVsVmFsdWUgPSB2YWx1ZUFjY2Vzc29yKCk7CgkgICAgICAgICAgICBrby5leHByZXNzaW9uUmV3cml0aW5nLndyaXRlVmFsdWVUb1Byb3BlcnR5KG1vZGVsVmFsdWUsIGFsbEJpbmRpbmdzLCAnaGFzZm9jdXMnLCBpc0ZvY3VzZWQsIHRydWUpOwoKCSAgICAgICAgICAgIC8vY2FjaGUgdGhlIGxhdGVzdCB2YWx1ZSwgc28gd2UgY2FuIGF2b2lkIHVubmVjZXNzYXJpbHkgY2FsbGluZyBmb2N1cy9ibHVyIGluIHRoZSB1cGRhdGUgZnVuY3Rpb24KCSAgICAgICAgICAgIGVsZW1lbnRbaGFzZm9jdXNMYXN0VmFsdWVdID0gaXNGb2N1c2VkOwoJICAgICAgICAgICAgZWxlbWVudFtoYXNmb2N1c1VwZGF0aW5nUHJvcGVydHldID0gZmFsc2U7CgkgICAgICAgIH07CgkgICAgICAgIHZhciBoYW5kbGVFbGVtZW50Rm9jdXNJbiA9IGhhbmRsZUVsZW1lbnRGb2N1c0NoYW5nZS5iaW5kKG51bGwsIHRydWUpOwoJICAgICAgICB2YXIgaGFuZGxlRWxlbWVudEZvY3VzT3V0ID0gaGFuZGxlRWxlbWVudEZvY3VzQ2hhbmdlLmJpbmQobnVsbCwgZmFsc2UpOwoKCSAgICAgICAga28udXRpbHMucmVnaXN0ZXJFdmVudEhhbmRsZXIoZWxlbWVudCwgImZvY3VzIiwgaGFuZGxlRWxlbWVudEZvY3VzSW4pOwoJICAgICAgICBrby51dGlscy5yZWdpc3RlckV2ZW50SGFuZGxlcihlbGVtZW50LCAiZm9jdXNpbiIsIGhhbmRsZUVsZW1lbnRGb2N1c0luKTsgLy8gRm9yIElFCgkgICAgICAgIGtvLnV0aWxzLnJlZ2lzdGVyRXZlbnRIYW5kbGVyKGVsZW1lbnQsICJibHVyIiwgIGhhbmRsZUVsZW1lbnRGb2N1c091dCk7CgkgICAgICAgIGtvLnV0aWxzLnJlZ2lzdGVyRXZlbnRIYW5kbGVyKGVsZW1lbnQsICJmb2N1c291dCIsICBoYW5kbGVFbGVtZW50Rm9jdXNPdXQpOyAvLyBGb3IgSUUKCSAgICB9LAoJICAgICd1cGRhdGUnOiBmdW5jdGlvbihlbGVtZW50LCB2YWx1ZUFjY2Vzc29yKSB7CgkgICAgICAgIHZhciB2YWx1ZSA9ICEha28udXRpbHMudW53cmFwT2JzZXJ2YWJsZSh2YWx1ZUFjY2Vzc29yKCkpOyAvL2ZvcmNlIGJvb2xlYW4gdG8gY29tcGFyZSB3aXRoIGxhc3QgdmFsdWUKCSAgICAgICAgaWYgKCFlbGVtZW50W2hhc2ZvY3VzVXBkYXRpbmdQcm9wZXJ0eV0gJiYgZWxlbWVudFtoYXNmb2N1c0xhc3RWYWx1ZV0gIT09IHZhbHVlKSB7CgkgICAgICAgICAgICB2YWx1ZSA/IGVsZW1lbnQuZm9jdXMoKSA6IGVsZW1lbnQuYmx1cigpOwoJICAgICAgICAgICAga28uZGVwZW5kZW5jeURldGVjdGlvbi5pZ25vcmUoa28udXRpbHMudHJpZ2dlckV2ZW50LCBudWxsLCBbZWxlbWVudCwgdmFsdWUgPyAiZm9jdXNpbiIgOiAiZm9jdXNvdXQiXSk7IC8vIEZvciBJRSwgd2hpY2ggZG9lc24ndCByZWxpYWJseSBmaXJlICJmb2N1cyIgb3IgImJsdXIiIGV2ZW50cyBzeW5jaHJvbm91c2x5CgkgICAgICAgIH0KCSAgICB9Cgl9OwoJa28uZXhwcmVzc2lvblJld3JpdGluZy50d29XYXlCaW5kaW5nc1snaGFzZm9jdXMnXSA9IHRydWU7CgoJa28uYmluZGluZ0hhbmRsZXJzWydoYXNGb2N1cyddID0ga28uYmluZGluZ0hhbmRsZXJzWydoYXNmb2N1cyddOyAvLyBNYWtlICJoYXNGb2N1cyIgYW4gYWxpYXMKCWtvLmV4cHJlc3Npb25SZXdyaXRpbmcudHdvV2F5QmluZGluZ3NbJ2hhc0ZvY3VzJ10gPSB0cnVlOwoJa28uYmluZGluZ0hhbmRsZXJzWydodG1sJ10gPSB7CgkgICAgJ2luaXQnOiBmdW5jdGlvbigpIHsKCSAgICAgICAgLy8gUHJldmVudCBiaW5kaW5nIG9uIHRoZSBkeW5hbWljYWxseS1pbmplY3RlZCBIVE1MIChhcyBkZXZlbG9wZXJzIGFyZSB1bmxpa2VseSB0byBleHBlY3QgdGhhdCwgYW5kIGl0IGhhcyBzZWN1cml0eSBpbXBsaWNhdGlvbnMpCgkgICAgICAgIHJldHVybiB7ICdjb250cm9sc0Rlc2NlbmRhbnRCaW5kaW5ncyc6IHRydWUgfTsKCSAgICB9LAoJICAgICd1cGRhdGUnOiBmdW5jdGlvbiAoZWxlbWVudCwgdmFsdWVBY2Nlc3NvcikgewoJICAgICAgICAvLyBzZXRIdG1sIHdpbGwgdW53cmFwIHRoZSB2YWx1ZSBpZiBuZWVkZWQKCSAgICAgICAga28udXRpbHMuc2V0SHRtbChlbGVtZW50LCB2YWx1ZUFjY2Vzc29yKCkpOwoJICAgIH0KCX07CgkvLyBNYWtlcyBhIGJpbmRpbmcgbGlrZSB3aXRoIG9yIGlmCglmdW5jdGlvbiBtYWtlV2l0aElmQmluZGluZyhiaW5kaW5nS2V5LCBpc1dpdGgsIGlzTm90LCBtYWtlQ29udGV4dENhbGxiYWNrKSB7CgkgICAga28uYmluZGluZ0hhbmRsZXJzW2JpbmRpbmdLZXldID0gewoJICAgICAgICAnaW5pdCc6IGZ1bmN0aW9uKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IsIGFsbEJpbmRpbmdzLCB2aWV3TW9kZWwsIGJpbmRpbmdDb250ZXh0KSB7CgkgICAgICAgICAgICB2YXIgZGlkRGlzcGxheU9uTGFzdFVwZGF0ZSwKCSAgICAgICAgICAgICAgICBzYXZlZE5vZGVzOwoJICAgICAgICAgICAga28uY29tcHV0ZWQoZnVuY3Rpb24oKSB7CgkgICAgICAgICAgICAgICAgdmFyIGRhdGFWYWx1ZSA9IGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUodmFsdWVBY2Nlc3NvcigpKSwKCSAgICAgICAgICAgICAgICAgICAgc2hvdWxkRGlzcGxheSA9ICFpc05vdCAhPT0gIWRhdGFWYWx1ZSwgLy8gZXF1aXZhbGVudCB0byBpc05vdCA/ICFkYXRhVmFsdWUgOiAhIWRhdGFWYWx1ZQoJICAgICAgICAgICAgICAgICAgICBpc0ZpcnN0UmVuZGVyID0gIXNhdmVkTm9kZXMsCgkgICAgICAgICAgICAgICAgICAgIG5lZWRzUmVmcmVzaCA9IGlzRmlyc3RSZW5kZXIgfHwgaXNXaXRoIHx8IChzaG91bGREaXNwbGF5ICE9PSBkaWREaXNwbGF5T25MYXN0VXBkYXRlKTsKCgkgICAgICAgICAgICAgICAgaWYgKG5lZWRzUmVmcmVzaCkgewoJICAgICAgICAgICAgICAgICAgICAvLyBTYXZlIGEgY29weSBvZiB0aGUgaW5uZXIgbm9kZXMgb24gdGhlIGluaXRpYWwgdXBkYXRlLCBidXQgb25seSBpZiB3ZSBoYXZlIGRlcGVuZGVuY2llcy4KCSAgICAgICAgICAgICAgICAgICAgaWYgKGlzRmlyc3RSZW5kZXIgJiYga28uY29tcHV0ZWRDb250ZXh0LmdldERlcGVuZGVuY2llc0NvdW50KCkpIHsKCSAgICAgICAgICAgICAgICAgICAgICAgIHNhdmVkTm9kZXMgPSBrby51dGlscy5jbG9uZU5vZGVzKGtvLnZpcnR1YWxFbGVtZW50cy5jaGlsZE5vZGVzKGVsZW1lbnQpLCB0cnVlIC8qIHNob3VsZENsZWFuTm9kZXMgKi8pOwoJICAgICAgICAgICAgICAgICAgICB9CgoJICAgICAgICAgICAgICAgICAgICBpZiAoc2hvdWxkRGlzcGxheSkgewoJICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFpc0ZpcnN0UmVuZGVyKSB7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAga28udmlydHVhbEVsZW1lbnRzLnNldERvbU5vZGVDaGlsZHJlbihlbGVtZW50LCBrby51dGlscy5jbG9uZU5vZGVzKHNhdmVkTm9kZXMpKTsKCSAgICAgICAgICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICAgICAgICAgIGtvLmFwcGx5QmluZGluZ3NUb0Rlc2NlbmRhbnRzKG1ha2VDb250ZXh0Q2FsbGJhY2sgPyBtYWtlQ29udGV4dENhbGxiYWNrKGJpbmRpbmdDb250ZXh0LCBkYXRhVmFsdWUpIDogYmluZGluZ0NvbnRleHQsIGVsZW1lbnQpOwoJICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgICAgICAgICAgICAga28udmlydHVhbEVsZW1lbnRzLmVtcHR5Tm9kZShlbGVtZW50KTsKCSAgICAgICAgICAgICAgICAgICAgfQoKCSAgICAgICAgICAgICAgICAgICAgZGlkRGlzcGxheU9uTGFzdFVwZGF0ZSA9IHNob3VsZERpc3BsYXk7CgkgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgfSwgbnVsbCwgeyBkaXNwb3NlV2hlbk5vZGVJc1JlbW92ZWQ6IGVsZW1lbnQgfSk7CgkgICAgICAgICAgICByZXR1cm4geyAnY29udHJvbHNEZXNjZW5kYW50QmluZGluZ3MnOiB0cnVlIH07CgkgICAgICAgIH0KCSAgICB9OwoJICAgIGtvLmV4cHJlc3Npb25SZXdyaXRpbmcuYmluZGluZ1Jld3JpdGVWYWxpZGF0b3JzW2JpbmRpbmdLZXldID0gZmFsc2U7IC8vIENhbid0IHJld3JpdGUgY29udHJvbCBmbG93IGJpbmRpbmdzCgkgICAga28udmlydHVhbEVsZW1lbnRzLmFsbG93ZWRCaW5kaW5nc1tiaW5kaW5nS2V5XSA9IHRydWU7Cgl9CgoJLy8gQ29uc3RydWN0IHRoZSBhY3R1YWwgYmluZGluZyBoYW5kbGVycwoJbWFrZVdpdGhJZkJpbmRpbmcoJ2lmJyk7CgltYWtlV2l0aElmQmluZGluZygnaWZub3QnLCBmYWxzZSAvKiBpc1dpdGggKi8sIHRydWUgLyogaXNOb3QgKi8pOwoJbWFrZVdpdGhJZkJpbmRpbmcoJ3dpdGgnLCB0cnVlIC8qIGlzV2l0aCAqLywgZmFsc2UgLyogaXNOb3QgKi8sCgkgICAgZnVuY3Rpb24oYmluZGluZ0NvbnRleHQsIGRhdGFWYWx1ZSkgewoJICAgICAgICByZXR1cm4gYmluZGluZ0NvbnRleHRbJ2NyZWF0ZUNoaWxkQ29udGV4dCddKGRhdGFWYWx1ZSk7CgkgICAgfQoJKTsKCXZhciBjYXB0aW9uUGxhY2Vob2xkZXIgPSB7fTsKCWtvLmJpbmRpbmdIYW5kbGVyc1snb3B0aW9ucyddID0gewoJICAgICdpbml0JzogZnVuY3Rpb24oZWxlbWVudCkgewoJICAgICAgICBpZiAoa28udXRpbHMudGFnTmFtZUxvd2VyKGVsZW1lbnQpICE9PSAic2VsZWN0IikKCSAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigib3B0aW9ucyBiaW5kaW5nIGFwcGxpZXMgb25seSB0byBTRUxFQ1QgZWxlbWVudHMiKTsKCgkgICAgICAgIC8vIFJlbW92ZSBhbGwgZXhpc3RpbmcgPG9wdGlvbj5zLgoJICAgICAgICB3aGlsZSAoZWxlbWVudC5sZW5ndGggPiAwKSB7CgkgICAgICAgICAgICBlbGVtZW50LnJlbW92ZSgwKTsKCSAgICAgICAgfQoKCSAgICAgICAgLy8gRW5zdXJlcyB0aGF0IHRoZSBiaW5kaW5nIHByb2Nlc3NvciBkb2Vzbid0IHRyeSB0byBiaW5kIHRoZSBvcHRpb25zCgkgICAgICAgIHJldHVybiB7ICdjb250cm9sc0Rlc2NlbmRhbnRCaW5kaW5ncyc6IHRydWUgfTsKCSAgICB9LAoJICAgICd1cGRhdGUnOiBmdW5jdGlvbiAoZWxlbWVudCwgdmFsdWVBY2Nlc3NvciwgYWxsQmluZGluZ3MpIHsKCSAgICAgICAgZnVuY3Rpb24gc2VsZWN0ZWRPcHRpb25zKCkgewoJICAgICAgICAgICAgcmV0dXJuIGtvLnV0aWxzLmFycmF5RmlsdGVyKGVsZW1lbnQub3B0aW9ucywgZnVuY3Rpb24gKG5vZGUpIHsgcmV0dXJuIG5vZGUuc2VsZWN0ZWQ7IH0pOwoJICAgICAgICB9CgoJICAgICAgICB2YXIgc2VsZWN0V2FzUHJldmlvdXNseUVtcHR5ID0gZWxlbWVudC5sZW5ndGggPT0gMDsKCSAgICAgICAgdmFyIHByZXZpb3VzU2Nyb2xsVG9wID0gKCFzZWxlY3RXYXNQcmV2aW91c2x5RW1wdHkgJiYgZWxlbWVudC5tdWx0aXBsZSkgPyBlbGVtZW50LnNjcm9sbFRvcCA6IG51bGw7CgkgICAgICAgIHZhciB1bndyYXBwZWRBcnJheSA9IGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUodmFsdWVBY2Nlc3NvcigpKTsKCSAgICAgICAgdmFyIGluY2x1ZGVEZXN0cm95ZWQgPSBhbGxCaW5kaW5ncy5nZXQoJ29wdGlvbnNJbmNsdWRlRGVzdHJveWVkJyk7CgkgICAgICAgIHZhciBhcnJheVRvRG9tTm9kZUNoaWxkcmVuT3B0aW9ucyA9IHt9OwoJICAgICAgICB2YXIgY2FwdGlvblZhbHVlOwoJICAgICAgICB2YXIgZmlsdGVyZWRBcnJheTsKCSAgICAgICAgdmFyIHByZXZpb3VzU2VsZWN0ZWRWYWx1ZXM7CgoJICAgICAgICBpZiAoZWxlbWVudC5tdWx0aXBsZSkgewoJICAgICAgICAgICAgcHJldmlvdXNTZWxlY3RlZFZhbHVlcyA9IGtvLnV0aWxzLmFycmF5TWFwKHNlbGVjdGVkT3B0aW9ucygpLCBrby5zZWxlY3RFeHRlbnNpb25zLnJlYWRWYWx1ZSk7CgkgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICBwcmV2aW91c1NlbGVjdGVkVmFsdWVzID0gZWxlbWVudC5zZWxlY3RlZEluZGV4ID49IDAgPyBbIGtvLnNlbGVjdEV4dGVuc2lvbnMucmVhZFZhbHVlKGVsZW1lbnQub3B0aW9uc1tlbGVtZW50LnNlbGVjdGVkSW5kZXhdKSBdIDogW107CgkgICAgICAgIH0KCgkgICAgICAgIGlmICh1bndyYXBwZWRBcnJheSkgewoJICAgICAgICAgICAgaWYgKHR5cGVvZiB1bndyYXBwZWRBcnJheS5sZW5ndGggPT0gInVuZGVmaW5lZCIpIC8vIENvZXJjZSBzaW5nbGUgdmFsdWUgaW50byBhcnJheQoJICAgICAgICAgICAgICAgIHVud3JhcHBlZEFycmF5ID0gW3Vud3JhcHBlZEFycmF5XTsKCgkgICAgICAgICAgICAvLyBGaWx0ZXIgb3V0IGFueSBlbnRyaWVzIG1hcmtlZCBhcyBkZXN0cm95ZWQKCSAgICAgICAgICAgIGZpbHRlcmVkQXJyYXkgPSBrby51dGlscy5hcnJheUZpbHRlcih1bndyYXBwZWRBcnJheSwgZnVuY3Rpb24oaXRlbSkgewoJICAgICAgICAgICAgICAgIHJldHVybiBpbmNsdWRlRGVzdHJveWVkIHx8IGl0ZW0gPT09IHVuZGVmaW5lZCB8fCBpdGVtID09PSBudWxsIHx8ICFrby51dGlscy51bndyYXBPYnNlcnZhYmxlKGl0ZW1bJ19kZXN0cm95J10pOwoJICAgICAgICAgICAgfSk7CgoJICAgICAgICAgICAgLy8gSWYgY2FwdGlvbiBpcyBpbmNsdWRlZCwgYWRkIGl0IHRvIHRoZSBhcnJheQoJICAgICAgICAgICAgaWYgKGFsbEJpbmRpbmdzWydoYXMnXSgnb3B0aW9uc0NhcHRpb24nKSkgewoJICAgICAgICAgICAgICAgIGNhcHRpb25WYWx1ZSA9IGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUoYWxsQmluZGluZ3MuZ2V0KCdvcHRpb25zQ2FwdGlvbicpKTsKCSAgICAgICAgICAgICAgICAvLyBJZiBjYXB0aW9uIHZhbHVlIGlzIG51bGwgb3IgdW5kZWZpbmVkLCBkb24ndCBzaG93IGEgY2FwdGlvbgoJICAgICAgICAgICAgICAgIGlmIChjYXB0aW9uVmFsdWUgIT09IG51bGwgJiYgY2FwdGlvblZhbHVlICE9PSB1bmRlZmluZWQpIHsKCSAgICAgICAgICAgICAgICAgICAgZmlsdGVyZWRBcnJheS51bnNoaWZ0KGNhcHRpb25QbGFjZWhvbGRlcik7CgkgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgfQoJICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgLy8gSWYgYSBmYWxzeSB2YWx1ZSBpcyBwcm92aWRlZCAoZS5nLiBudWxsKSwgd2UnbGwgc2ltcGx5IGVtcHR5IHRoZSBzZWxlY3QgZWxlbWVudAoJICAgICAgICB9CgoJICAgICAgICBmdW5jdGlvbiBhcHBseVRvT2JqZWN0KG9iamVjdCwgcHJlZGljYXRlLCBkZWZhdWx0VmFsdWUpIHsKCSAgICAgICAgICAgIHZhciBwcmVkaWNhdGVUeXBlID0gdHlwZW9mIHByZWRpY2F0ZTsKCSAgICAgICAgICAgIGlmIChwcmVkaWNhdGVUeXBlID09ICJmdW5jdGlvbiIpICAgIC8vIEdpdmVuIGEgZnVuY3Rpb247IHJ1biBpdCBhZ2FpbnN0IHRoZSBkYXRhIHZhbHVlCgkgICAgICAgICAgICAgICAgcmV0dXJuIHByZWRpY2F0ZShvYmplY3QpOwoJICAgICAgICAgICAgZWxzZSBpZiAocHJlZGljYXRlVHlwZSA9PSAic3RyaW5nIikgLy8gR2l2ZW4gYSBzdHJpbmc7IHRyZWF0IGl0IGFzIGEgcHJvcGVydHkgbmFtZSBvbiB0aGUgZGF0YSB2YWx1ZQoJICAgICAgICAgICAgICAgIHJldHVybiBvYmplY3RbcHJlZGljYXRlXTsKCSAgICAgICAgICAgIGVsc2UgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIEdpdmVuIG5vIG9wdGlvbnNUZXh0IGFyZzsgdXNlIHRoZSBkYXRhIHZhbHVlIGl0c2VsZgoJICAgICAgICAgICAgICAgIHJldHVybiBkZWZhdWx0VmFsdWU7CgkgICAgICAgIH0KCgkgICAgICAgIC8vIFRoZSBmb2xsb3dpbmcgZnVuY3Rpb25zIGNhbiBydW4gYXQgdHdvIGRpZmZlcmVudCB0aW1lczoKCSAgICAgICAgLy8gVGhlIGZpcnN0IGlzIHdoZW4gdGhlIHdob2xlIGFycmF5IGlzIGJlaW5nIHVwZGF0ZWQgZGlyZWN0bHkgZnJvbSB0aGlzIGJpbmRpbmcgaGFuZGxlci4KCSAgICAgICAgLy8gVGhlIHNlY29uZCBpcyB3aGVuIGFuIG9ic2VydmFibGUgdmFsdWUgZm9yIGEgc3BlY2lmaWMgYXJyYXkgZW50cnkgaXMgdXBkYXRlZC4KCSAgICAgICAgLy8gb2xkT3B0aW9ucyB3aWxsIGJlIGVtcHR5IGluIHRoZSBmaXJzdCBjYXNlLCBidXQgd2lsbCBiZSBmaWxsZWQgd2l0aCB0aGUgcHJldmlvdXNseSBnZW5lcmF0ZWQgb3B0aW9uIGluIHRoZSBzZWNvbmQuCgkgICAgICAgIHZhciBpdGVtVXBkYXRlID0gZmFsc2U7CgkgICAgICAgIGZ1bmN0aW9uIG9wdGlvbkZvckFycmF5SXRlbShhcnJheUVudHJ5LCBpbmRleCwgb2xkT3B0aW9ucykgewoJICAgICAgICAgICAgaWYgKG9sZE9wdGlvbnMubGVuZ3RoKSB7CgkgICAgICAgICAgICAgICAgcHJldmlvdXNTZWxlY3RlZFZhbHVlcyA9IG9sZE9wdGlvbnNbMF0uc2VsZWN0ZWQgPyBbIGtvLnNlbGVjdEV4dGVuc2lvbnMucmVhZFZhbHVlKG9sZE9wdGlvbnNbMF0pIF0gOiBbXTsKCSAgICAgICAgICAgICAgICBpdGVtVXBkYXRlID0gdHJ1ZTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIHZhciBvcHRpb24gPSBlbGVtZW50Lm93bmVyRG9jdW1lbnQuY3JlYXRlRWxlbWVudCgib3B0aW9uIik7CgkgICAgICAgICAgICBpZiAoYXJyYXlFbnRyeSA9PT0gY2FwdGlvblBsYWNlaG9sZGVyKSB7CgkgICAgICAgICAgICAgICAga28udXRpbHMuc2V0VGV4dENvbnRlbnQob3B0aW9uLCBhbGxCaW5kaW5ncy5nZXQoJ29wdGlvbnNDYXB0aW9uJykpOwoJICAgICAgICAgICAgICAgIGtvLnNlbGVjdEV4dGVuc2lvbnMud3JpdGVWYWx1ZShvcHRpb24sIHVuZGVmaW5lZCk7CgkgICAgICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgICAgIC8vIEFwcGx5IGEgdmFsdWUgdG8gdGhlIG9wdGlvbiBlbGVtZW50CgkgICAgICAgICAgICAgICAgdmFyIG9wdGlvblZhbHVlID0gYXBwbHlUb09iamVjdChhcnJheUVudHJ5LCBhbGxCaW5kaW5ncy5nZXQoJ29wdGlvbnNWYWx1ZScpLCBhcnJheUVudHJ5KTsKCSAgICAgICAgICAgICAgICBrby5zZWxlY3RFeHRlbnNpb25zLndyaXRlVmFsdWUob3B0aW9uLCBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKG9wdGlvblZhbHVlKSk7CgoJICAgICAgICAgICAgICAgIC8vIEFwcGx5IHNvbWUgdGV4dCB0byB0aGUgb3B0aW9uIGVsZW1lbnQKCSAgICAgICAgICAgICAgICB2YXIgb3B0aW9uVGV4dCA9IGFwcGx5VG9PYmplY3QoYXJyYXlFbnRyeSwgYWxsQmluZGluZ3MuZ2V0KCdvcHRpb25zVGV4dCcpLCBvcHRpb25WYWx1ZSk7CgkgICAgICAgICAgICAgICAga28udXRpbHMuc2V0VGV4dENvbnRlbnQob3B0aW9uLCBvcHRpb25UZXh0KTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIHJldHVybiBbb3B0aW9uXTsKCSAgICAgICAgfQoKCSAgICAgICAgLy8gQnkgdXNpbmcgYSBiZWZvcmVSZW1vdmUgY2FsbGJhY2ssIHdlIGRlbGF5IHRoZSByZW1vdmFsIHVudGlsIGFmdGVyIG5ldyBpdGVtcyBhcmUgYWRkZWQuIFRoaXMgZml4ZXMgYSBzZWxlY3Rpb24KCSAgICAgICAgLy8gcHJvYmxlbSBpbiBJRTw9OCBhbmQgRmlyZWZveC4gU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9rbm9ja291dC9rbm9ja291dC9pc3N1ZXMvMTIwOAoJICAgICAgICBhcnJheVRvRG9tTm9kZUNoaWxkcmVuT3B0aW9uc1snYmVmb3JlUmVtb3ZlJ10gPQoJICAgICAgICAgICAgZnVuY3Rpb24gKG9wdGlvbikgewoJICAgICAgICAgICAgICAgIGVsZW1lbnQucmVtb3ZlQ2hpbGQob3B0aW9uKTsKCSAgICAgICAgICAgIH07CgoJICAgICAgICBmdW5jdGlvbiBzZXRTZWxlY3Rpb25DYWxsYmFjayhhcnJheUVudHJ5LCBuZXdPcHRpb25zKSB7CgkgICAgICAgICAgICAvLyBJRTYgZG9lc24ndCBsaWtlIHVzIHRvIGFzc2lnbiBzZWxlY3Rpb24gdG8gT1BUSU9OIG5vZGVzIGJlZm9yZSB0aGV5J3JlIGFkZGVkIHRvIHRoZSBkb2N1bWVudC4KCSAgICAgICAgICAgIC8vIFRoYXQncyB3aHkgd2UgZmlyc3QgYWRkZWQgdGhlbSB3aXRob3V0IHNlbGVjdGlvbi4gTm93IGl0J3MgdGltZSB0byBzZXQgdGhlIHNlbGVjdGlvbi4KCSAgICAgICAgICAgIGlmIChwcmV2aW91c1NlbGVjdGVkVmFsdWVzLmxlbmd0aCkgewoJICAgICAgICAgICAgICAgIHZhciBpc1NlbGVjdGVkID0ga28udXRpbHMuYXJyYXlJbmRleE9mKHByZXZpb3VzU2VsZWN0ZWRWYWx1ZXMsIGtvLnNlbGVjdEV4dGVuc2lvbnMucmVhZFZhbHVlKG5ld09wdGlvbnNbMF0pKSA+PSAwOwoJICAgICAgICAgICAgICAgIGtvLnV0aWxzLnNldE9wdGlvbk5vZGVTZWxlY3Rpb25TdGF0ZShuZXdPcHRpb25zWzBdLCBpc1NlbGVjdGVkKTsKCgkgICAgICAgICAgICAgICAgLy8gSWYgdGhpcyBvcHRpb24gd2FzIGNoYW5nZWQgZnJvbSBiZWluZyBzZWxlY3RlZCBkdXJpbmcgYSBzaW5nbGUtaXRlbSB1cGRhdGUsIG5vdGlmeSB0aGUgY2hhbmdlCgkgICAgICAgICAgICAgICAgaWYgKGl0ZW1VcGRhdGUgJiYgIWlzU2VsZWN0ZWQpCgkgICAgICAgICAgICAgICAgICAgIGtvLmRlcGVuZGVuY3lEZXRlY3Rpb24uaWdub3JlKGtvLnV0aWxzLnRyaWdnZXJFdmVudCwgbnVsbCwgW2VsZW1lbnQsICJjaGFuZ2UiXSk7CgkgICAgICAgICAgICB9CgkgICAgICAgIH0KCgkgICAgICAgIHZhciBjYWxsYmFjayA9IHNldFNlbGVjdGlvbkNhbGxiYWNrOwoJICAgICAgICBpZiAoYWxsQmluZGluZ3NbJ2hhcyddKCdvcHRpb25zQWZ0ZXJSZW5kZXInKSkgewoJICAgICAgICAgICAgY2FsbGJhY2sgPSBmdW5jdGlvbihhcnJheUVudHJ5LCBuZXdPcHRpb25zKSB7CgkgICAgICAgICAgICAgICAgc2V0U2VsZWN0aW9uQ2FsbGJhY2soYXJyYXlFbnRyeSwgbmV3T3B0aW9ucyk7CgkgICAgICAgICAgICAgICAga28uZGVwZW5kZW5jeURldGVjdGlvbi5pZ25vcmUoYWxsQmluZGluZ3MuZ2V0KCdvcHRpb25zQWZ0ZXJSZW5kZXInKSwgbnVsbCwgW25ld09wdGlvbnNbMF0sIGFycmF5RW50cnkgIT09IGNhcHRpb25QbGFjZWhvbGRlciA/IGFycmF5RW50cnkgOiB1bmRlZmluZWRdKTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgfQoKCSAgICAgICAga28udXRpbHMuc2V0RG9tTm9kZUNoaWxkcmVuRnJvbUFycmF5TWFwcGluZyhlbGVtZW50LCBmaWx0ZXJlZEFycmF5LCBvcHRpb25Gb3JBcnJheUl0ZW0sIGFycmF5VG9Eb21Ob2RlQ2hpbGRyZW5PcHRpb25zLCBjYWxsYmFjayk7CgoJICAgICAgICBrby5kZXBlbmRlbmN5RGV0ZWN0aW9uLmlnbm9yZShmdW5jdGlvbiAoKSB7CgkgICAgICAgICAgICBpZiAoYWxsQmluZGluZ3MuZ2V0KCd2YWx1ZUFsbG93VW5zZXQnKSAmJiBhbGxCaW5kaW5nc1snaGFzJ10oJ3ZhbHVlJykpIHsKCSAgICAgICAgICAgICAgICAvLyBUaGUgbW9kZWwgdmFsdWUgaXMgYXV0aG9yaXRhdGl2ZSwgc28gbWFrZSBzdXJlIGl0cyB2YWx1ZSBpcyB0aGUgb25lIHNlbGVjdGVkCgkgICAgICAgICAgICAgICAga28uc2VsZWN0RXh0ZW5zaW9ucy53cml0ZVZhbHVlKGVsZW1lbnQsIGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUoYWxsQmluZGluZ3MuZ2V0KCd2YWx1ZScpKSwgdHJ1ZSAvKiBhbGxvd1Vuc2V0ICovKTsKCSAgICAgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICAgICAgLy8gRGV0ZXJtaW5lIGlmIHRoZSBzZWxlY3Rpb24gaGFzIGNoYW5nZWQgYXMgYSByZXN1bHQgb2YgdXBkYXRpbmcgdGhlIG9wdGlvbnMgbGlzdAoJICAgICAgICAgICAgICAgIHZhciBzZWxlY3Rpb25DaGFuZ2VkOwoJICAgICAgICAgICAgICAgIGlmIChlbGVtZW50Lm11bHRpcGxlKSB7CgkgICAgICAgICAgICAgICAgICAgIC8vIEZvciBhIG11bHRpcGxlLXNlbGVjdCBib3gsIGNvbXBhcmUgdGhlIG5ldyBzZWxlY3Rpb24gY291bnQgdG8gdGhlIHByZXZpb3VzIG9uZQoJICAgICAgICAgICAgICAgICAgICAvLyBCdXQgaWYgbm90aGluZyB3YXMgc2VsZWN0ZWQgYmVmb3JlLCB0aGUgc2VsZWN0aW9uIGNhbid0IGhhdmUgY2hhbmdlZAoJICAgICAgICAgICAgICAgICAgICBzZWxlY3Rpb25DaGFuZ2VkID0gcHJldmlvdXNTZWxlY3RlZFZhbHVlcy5sZW5ndGggJiYgc2VsZWN0ZWRPcHRpb25zKCkubGVuZ3RoIDwgcHJldmlvdXNTZWxlY3RlZFZhbHVlcy5sZW5ndGg7CgkgICAgICAgICAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgICAgICAgICAgLy8gRm9yIGEgc2luZ2xlLXNlbGVjdCBib3gsIGNvbXBhcmUgdGhlIGN1cnJlbnQgdmFsdWUgdG8gdGhlIHByZXZpb3VzIHZhbHVlCgkgICAgICAgICAgICAgICAgICAgIC8vIEJ1dCBpZiBub3RoaW5nIHdhcyBzZWxlY3RlZCBiZWZvcmUgb3Igbm90aGluZyBpcyBzZWxlY3RlZCBub3csIGp1c3QgbG9vayBmb3IgYSBjaGFuZ2UgaW4gc2VsZWN0aW9uCgkgICAgICAgICAgICAgICAgICAgIHNlbGVjdGlvbkNoYW5nZWQgPSAocHJldmlvdXNTZWxlY3RlZFZhbHVlcy5sZW5ndGggJiYgZWxlbWVudC5zZWxlY3RlZEluZGV4ID49IDApCgkgICAgICAgICAgICAgICAgICAgICAgICA/IChrby5zZWxlY3RFeHRlbnNpb25zLnJlYWRWYWx1ZShlbGVtZW50Lm9wdGlvbnNbZWxlbWVudC5zZWxlY3RlZEluZGV4XSkgIT09IHByZXZpb3VzU2VsZWN0ZWRWYWx1ZXNbMF0pCgkgICAgICAgICAgICAgICAgICAgICAgICA6IChwcmV2aW91c1NlbGVjdGVkVmFsdWVzLmxlbmd0aCB8fCBlbGVtZW50LnNlbGVjdGVkSW5kZXggPj0gMCk7CgkgICAgICAgICAgICAgICAgfQoKCSAgICAgICAgICAgICAgICAvLyBFbnN1cmUgY29uc2lzdGVuY3kgYmV0d2VlbiBtb2RlbCB2YWx1ZSBhbmQgc2VsZWN0ZWQgb3B0aW9uLgoJICAgICAgICAgICAgICAgIC8vIElmIHRoZSBkcm9wZG93biB3YXMgY2hhbmdlZCBzbyB0aGF0IHNlbGVjdGlvbiBpcyBubyBsb25nZXIgdGhlIHNhbWUsCgkgICAgICAgICAgICAgICAgLy8gbm90aWZ5IHRoZSB2YWx1ZSBvciBzZWxlY3RlZE9wdGlvbnMgYmluZGluZy4KCSAgICAgICAgICAgICAgICBpZiAoc2VsZWN0aW9uQ2hhbmdlZCkgewoJICAgICAgICAgICAgICAgICAgICBrby51dGlscy50cmlnZ2VyRXZlbnQoZWxlbWVudCwgImNoYW5nZSIpOwoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgIH0KCSAgICAgICAgfSk7CgoJICAgICAgICAvLyBXb3JrYXJvdW5kIGZvciBJRSBidWcKCSAgICAgICAga28udXRpbHMuZW5zdXJlU2VsZWN0RWxlbWVudElzUmVuZGVyZWRDb3JyZWN0bHkoZWxlbWVudCk7CgoJICAgICAgICBpZiAocHJldmlvdXNTY3JvbGxUb3AgJiYgTWF0aC5hYnMocHJldmlvdXNTY3JvbGxUb3AgLSBlbGVtZW50LnNjcm9sbFRvcCkgPiAyMCkKCSAgICAgICAgICAgIGVsZW1lbnQuc2Nyb2xsVG9wID0gcHJldmlvdXNTY3JvbGxUb3A7CgkgICAgfQoJfTsKCWtvLmJpbmRpbmdIYW5kbGVyc1snb3B0aW9ucyddLm9wdGlvblZhbHVlRG9tRGF0YUtleSA9IGtvLnV0aWxzLmRvbURhdGEubmV4dEtleSgpOwoJa28uYmluZGluZ0hhbmRsZXJzWydzZWxlY3RlZE9wdGlvbnMnXSA9IHsKCSAgICAnYWZ0ZXInOiBbJ29wdGlvbnMnLCAnZm9yZWFjaCddLAoJICAgICdpbml0JzogZnVuY3Rpb24gKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IsIGFsbEJpbmRpbmdzKSB7CgkgICAgICAgIGtvLnV0aWxzLnJlZ2lzdGVyRXZlbnRIYW5kbGVyKGVsZW1lbnQsICJjaGFuZ2UiLCBmdW5jdGlvbiAoKSB7CgkgICAgICAgICAgICB2YXIgdmFsdWUgPSB2YWx1ZUFjY2Vzc29yKCksIHZhbHVlVG9Xcml0ZSA9IFtdOwoJICAgICAgICAgICAga28udXRpbHMuYXJyYXlGb3JFYWNoKGVsZW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoIm9wdGlvbiIpLCBmdW5jdGlvbihub2RlKSB7CgkgICAgICAgICAgICAgICAgaWYgKG5vZGUuc2VsZWN0ZWQpCgkgICAgICAgICAgICAgICAgICAgIHZhbHVlVG9Xcml0ZS5wdXNoKGtvLnNlbGVjdEV4dGVuc2lvbnMucmVhZFZhbHVlKG5vZGUpKTsKCSAgICAgICAgICAgIH0pOwoJICAgICAgICAgICAga28uZXhwcmVzc2lvblJld3JpdGluZy53cml0ZVZhbHVlVG9Qcm9wZXJ0eSh2YWx1ZSwgYWxsQmluZGluZ3MsICdzZWxlY3RlZE9wdGlvbnMnLCB2YWx1ZVRvV3JpdGUpOwoJICAgICAgICB9KTsKCSAgICB9LAoJICAgICd1cGRhdGUnOiBmdW5jdGlvbiAoZWxlbWVudCwgdmFsdWVBY2Nlc3NvcikgewoJICAgICAgICBpZiAoa28udXRpbHMudGFnTmFtZUxvd2VyKGVsZW1lbnQpICE9ICJzZWxlY3QiKQoJICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJ2YWx1ZXMgYmluZGluZyBhcHBsaWVzIG9ubHkgdG8gU0VMRUNUIGVsZW1lbnRzIik7CgoJICAgICAgICB2YXIgbmV3VmFsdWUgPSBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKHZhbHVlQWNjZXNzb3IoKSk7CgkgICAgICAgIGlmIChuZXdWYWx1ZSAmJiB0eXBlb2YgbmV3VmFsdWUubGVuZ3RoID09ICJudW1iZXIiKSB7CgkgICAgICAgICAgICBrby51dGlscy5hcnJheUZvckVhY2goZWxlbWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgib3B0aW9uIiksIGZ1bmN0aW9uKG5vZGUpIHsKCSAgICAgICAgICAgICAgICB2YXIgaXNTZWxlY3RlZCA9IGtvLnV0aWxzLmFycmF5SW5kZXhPZihuZXdWYWx1ZSwga28uc2VsZWN0RXh0ZW5zaW9ucy5yZWFkVmFsdWUobm9kZSkpID49IDA7CgkgICAgICAgICAgICAgICAga28udXRpbHMuc2V0T3B0aW9uTm9kZVNlbGVjdGlvblN0YXRlKG5vZGUsIGlzU2VsZWN0ZWQpOwoJICAgICAgICAgICAgfSk7CgkgICAgICAgIH0KCSAgICB9Cgl9OwoJa28uZXhwcmVzc2lvblJld3JpdGluZy50d29XYXlCaW5kaW5nc1snc2VsZWN0ZWRPcHRpb25zJ10gPSB0cnVlOwoJa28uYmluZGluZ0hhbmRsZXJzWydzdHlsZSddID0gewoJICAgICd1cGRhdGUnOiBmdW5jdGlvbiAoZWxlbWVudCwgdmFsdWVBY2Nlc3NvcikgewoJICAgICAgICB2YXIgdmFsdWUgPSBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKHZhbHVlQWNjZXNzb3IoKSB8fCB7fSk7CgkgICAgICAgIGtvLnV0aWxzLm9iamVjdEZvckVhY2godmFsdWUsIGZ1bmN0aW9uKHN0eWxlTmFtZSwgc3R5bGVWYWx1ZSkgewoJICAgICAgICAgICAgc3R5bGVWYWx1ZSA9IGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUoc3R5bGVWYWx1ZSk7CgoJICAgICAgICAgICAgaWYgKHN0eWxlVmFsdWUgPT09IG51bGwgfHwgc3R5bGVWYWx1ZSA9PT0gdW5kZWZpbmVkIHx8IHN0eWxlVmFsdWUgPT09IGZhbHNlKSB7CgkgICAgICAgICAgICAgICAgLy8gRW1wdHkgc3RyaW5nIHJlbW92ZXMgdGhlIHZhbHVlLCB3aGVyZWFzIG51bGwvdW5kZWZpbmVkIGhhdmUgbm8gZWZmZWN0CgkgICAgICAgICAgICAgICAgc3R5bGVWYWx1ZSA9ICIiOwoJICAgICAgICAgICAgfQoKCSAgICAgICAgICAgIGVsZW1lbnQuc3R5bGVbc3R5bGVOYW1lXSA9IHN0eWxlVmFsdWU7CgkgICAgICAgIH0pOwoJICAgIH0KCX07Cglrby5iaW5kaW5nSGFuZGxlcnNbJ3N1Ym1pdCddID0gewoJICAgICdpbml0JzogZnVuY3Rpb24gKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IsIGFsbEJpbmRpbmdzLCB2aWV3TW9kZWwsIGJpbmRpbmdDb250ZXh0KSB7CgkgICAgICAgIGlmICh0eXBlb2YgdmFsdWVBY2Nlc3NvcigpICE9ICJmdW5jdGlvbiIpCgkgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlRoZSB2YWx1ZSBmb3IgYSBzdWJtaXQgYmluZGluZyBtdXN0IGJlIGEgZnVuY3Rpb24iKTsKCSAgICAgICAga28udXRpbHMucmVnaXN0ZXJFdmVudEhhbmRsZXIoZWxlbWVudCwgInN1Ym1pdCIsIGZ1bmN0aW9uIChldmVudCkgewoJICAgICAgICAgICAgdmFyIGhhbmRsZXJSZXR1cm5WYWx1ZTsKCSAgICAgICAgICAgIHZhciB2YWx1ZSA9IHZhbHVlQWNjZXNzb3IoKTsKCSAgICAgICAgICAgIHRyeSB7IGhhbmRsZXJSZXR1cm5WYWx1ZSA9IHZhbHVlLmNhbGwoYmluZGluZ0NvbnRleHRbJyRkYXRhJ10sIGVsZW1lbnQpOyB9CgkgICAgICAgICAgICBmaW5hbGx5IHsKCSAgICAgICAgICAgICAgICBpZiAoaGFuZGxlclJldHVyblZhbHVlICE9PSB0cnVlKSB7IC8vIE5vcm1hbGx5IHdlIHdhbnQgdG8gcHJldmVudCBkZWZhdWx0IGFjdGlvbi4gRGV2ZWxvcGVyIGNhbiBvdmVycmlkZSB0aGlzIGJlIGV4cGxpY2l0bHkgcmV0dXJuaW5nIHRydWUuCgkgICAgICAgICAgICAgICAgICAgIGlmIChldmVudC5wcmV2ZW50RGVmYXVsdCkKCSAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkgICAgICAgICAgICAgICAgICAgIGVsc2UKCSAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50LnJldHVyblZhbHVlID0gZmFsc2U7CgkgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgfQoJICAgICAgICB9KTsKCSAgICB9Cgl9OwoJa28uYmluZGluZ0hhbmRsZXJzWyd0ZXh0J10gPSB7CgkgICAgJ2luaXQnOiBmdW5jdGlvbigpIHsKCSAgICAgICAgLy8gUHJldmVudCBiaW5kaW5nIG9uIHRoZSBkeW5hbWljYWxseS1pbmplY3RlZCB0ZXh0IG5vZGUgKGFzIGRldmVsb3BlcnMgYXJlIHVubGlrZWx5IHRvIGV4cGVjdCB0aGF0LCBhbmQgaXQgaGFzIHNlY3VyaXR5IGltcGxpY2F0aW9ucykuCgkgICAgICAgIC8vIEl0IHNob3VsZCBhbHNvIG1ha2UgdGhpbmdzIGZhc3RlciwgYXMgd2Ugbm8gbG9uZ2VyIGhhdmUgdG8gY29uc2lkZXIgd2hldGhlciB0aGUgdGV4dCBub2RlIG1pZ2h0IGJlIGJpbmRhYmxlLgoJICAgICAgICByZXR1cm4geyAnY29udHJvbHNEZXNjZW5kYW50QmluZGluZ3MnOiB0cnVlIH07CgkgICAgfSwKCSAgICAndXBkYXRlJzogZnVuY3Rpb24gKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IpIHsKCSAgICAgICAga28udXRpbHMuc2V0VGV4dENvbnRlbnQoZWxlbWVudCwgdmFsdWVBY2Nlc3NvcigpKTsKCSAgICB9Cgl9OwoJa28udmlydHVhbEVsZW1lbnRzLmFsbG93ZWRCaW5kaW5nc1sndGV4dCddID0gdHJ1ZTsKCShmdW5jdGlvbiAoKSB7CgoJaWYgKHdpbmRvdyAmJiB3aW5kb3cubmF2aWdhdG9yKSB7CgkgICAgdmFyIHBhcnNlVmVyc2lvbiA9IGZ1bmN0aW9uIChtYXRjaGVzKSB7CgkgICAgICAgIGlmIChtYXRjaGVzKSB7CgkgICAgICAgICAgICByZXR1cm4gcGFyc2VGbG9hdChtYXRjaGVzWzFdKTsKCSAgICAgICAgfQoJICAgIH07CgoJICAgIC8vIERldGVjdCB2YXJpb3VzIGJyb3dzZXIgdmVyc2lvbnMgYmVjYXVzZSBzb21lIG9sZCB2ZXJzaW9ucyBkb24ndCBmdWxseSBzdXBwb3J0IHRoZSAnaW5wdXQnIGV2ZW50CgkgICAgdmFyIG9wZXJhVmVyc2lvbiA9IHdpbmRvdy5vcGVyYSAmJiB3aW5kb3cub3BlcmEudmVyc2lvbiAmJiBwYXJzZUludCh3aW5kb3cub3BlcmEudmVyc2lvbigpKSwKCSAgICAgICAgdXNlckFnZW50ID0gd2luZG93Lm5hdmlnYXRvci51c2VyQWdlbnQsCgkgICAgICAgIHNhZmFyaVZlcnNpb24gPSBwYXJzZVZlcnNpb24odXNlckFnZW50Lm1hdGNoKC9eKD86KD8hY2hyb21lKS4pKnZlcnNpb25cLyhbXiBdKikgc2FmYXJpL2kpKSwKCSAgICAgICAgZmlyZWZveFZlcnNpb24gPSBwYXJzZVZlcnNpb24odXNlckFnZW50Lm1hdGNoKC9GaXJlZm94XC8oW14gXSopLykpOwoJfQoKCS8vIElFIDggYW5kIDkgaGF2ZSBidWdzIHRoYXQgcHJldmVudCB0aGUgbm9ybWFsIGV2ZW50cyBmcm9tIGZpcmluZyB3aGVuIHRoZSB2YWx1ZSBjaGFuZ2VzLgoJLy8gQnV0IGl0IGRvZXMgZmlyZSB0aGUgJ3NlbGVjdGlvbmNoYW5nZScgZXZlbnQgb24gbWFueSBvZiB0aG9zZSwgcHJlc3VtYWJseSBiZWNhdXNlIHRoZQoJLy8gY3Vyc29yIGlzIG1vdmluZyBhbmQgdGhhdCBjb3VudHMgYXMgdGhlIHNlbGVjdGlvbiBjaGFuZ2luZy4gVGhlICdzZWxlY3Rpb25jaGFuZ2UnIGV2ZW50IGlzCgkvLyBmaXJlZCBhdCB0aGUgZG9jdW1lbnQgbGV2ZWwgb25seSBhbmQgZG9lc24ndCBkaXJlY3RseSBpbmRpY2F0ZSB3aGljaCBlbGVtZW50IGNoYW5nZWQuIFdlCgkvLyBzZXQgdXAganVzdCBvbmUgZXZlbnQgaGFuZGxlciBmb3IgdGhlIGRvY3VtZW50IGFuZCB1c2UgJ2FjdGl2ZUVsZW1lbnQnIHRvIGRldGVybWluZSB3aGljaAoJLy8gZWxlbWVudCB3YXMgY2hhbmdlZC4KCWlmIChrby51dGlscy5pZVZlcnNpb24gPCAxMCkgewoJICAgIHZhciBzZWxlY3Rpb25DaGFuZ2VSZWdpc3RlcmVkTmFtZSA9IGtvLnV0aWxzLmRvbURhdGEubmV4dEtleSgpLAoJICAgICAgICBzZWxlY3Rpb25DaGFuZ2VIYW5kbGVyTmFtZSA9IGtvLnV0aWxzLmRvbURhdGEubmV4dEtleSgpOwoJICAgIHZhciBzZWxlY3Rpb25DaGFuZ2VIYW5kbGVyID0gZnVuY3Rpb24oZXZlbnQpIHsKCSAgICAgICAgdmFyIHRhcmdldCA9IHRoaXMuYWN0aXZlRWxlbWVudCwKCSAgICAgICAgICAgIGhhbmRsZXIgPSB0YXJnZXQgJiYga28udXRpbHMuZG9tRGF0YS5nZXQodGFyZ2V0LCBzZWxlY3Rpb25DaGFuZ2VIYW5kbGVyTmFtZSk7CgkgICAgICAgIGlmIChoYW5kbGVyKSB7CgkgICAgICAgICAgICBoYW5kbGVyKGV2ZW50KTsKCSAgICAgICAgfQoJICAgIH07CgkgICAgdmFyIHJlZ2lzdGVyRm9yU2VsZWN0aW9uQ2hhbmdlRXZlbnQgPSBmdW5jdGlvbiAoZWxlbWVudCwgaGFuZGxlcikgewoJICAgICAgICB2YXIgb3duZXJEb2MgPSBlbGVtZW50Lm93bmVyRG9jdW1lbnQ7CgkgICAgICAgIGlmICgha28udXRpbHMuZG9tRGF0YS5nZXQob3duZXJEb2MsIHNlbGVjdGlvbkNoYW5nZVJlZ2lzdGVyZWROYW1lKSkgewoJICAgICAgICAgICAga28udXRpbHMuZG9tRGF0YS5zZXQob3duZXJEb2MsIHNlbGVjdGlvbkNoYW5nZVJlZ2lzdGVyZWROYW1lLCB0cnVlKTsKCSAgICAgICAgICAgIGtvLnV0aWxzLnJlZ2lzdGVyRXZlbnRIYW5kbGVyKG93bmVyRG9jLCAnc2VsZWN0aW9uY2hhbmdlJywgc2VsZWN0aW9uQ2hhbmdlSGFuZGxlcik7CgkgICAgICAgIH0KCSAgICAgICAga28udXRpbHMuZG9tRGF0YS5zZXQoZWxlbWVudCwgc2VsZWN0aW9uQ2hhbmdlSGFuZGxlck5hbWUsIGhhbmRsZXIpOwoJICAgIH07Cgl9CgoJa28uYmluZGluZ0hhbmRsZXJzWyd0ZXh0SW5wdXQnXSA9IHsKCSAgICAnaW5pdCc6IGZ1bmN0aW9uIChlbGVtZW50LCB2YWx1ZUFjY2Vzc29yLCBhbGxCaW5kaW5ncykgewoKCSAgICAgICAgdmFyIHByZXZpb3VzRWxlbWVudFZhbHVlID0gZWxlbWVudC52YWx1ZSwKCSAgICAgICAgICAgIHRpbWVvdXRIYW5kbGUsCgkgICAgICAgICAgICBlbGVtZW50VmFsdWVCZWZvcmVFdmVudDsKCgkgICAgICAgIHZhciB1cGRhdGVNb2RlbCA9IGZ1bmN0aW9uIChldmVudCkgewoJICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHRpbWVvdXRIYW5kbGUpOwoJICAgICAgICAgICAgZWxlbWVudFZhbHVlQmVmb3JlRXZlbnQgPSB0aW1lb3V0SGFuZGxlID0gdW5kZWZpbmVkOwoKCSAgICAgICAgICAgIHZhciBlbGVtZW50VmFsdWUgPSBlbGVtZW50LnZhbHVlOwoJICAgICAgICAgICAgaWYgKHByZXZpb3VzRWxlbWVudFZhbHVlICE9PSBlbGVtZW50VmFsdWUpIHsKCSAgICAgICAgICAgICAgICAvLyBQcm92aWRlIGEgd2F5IGZvciB0ZXN0cyB0byBrbm93IGV4YWN0bHkgd2hpY2ggZXZlbnQgd2FzIHByb2Nlc3NlZAoJICAgICAgICAgICAgICAgIGlmIChERUJVRyAmJiBldmVudCkgZWxlbWVudFsnX2tvX3RleHRJbnB1dFByb2Nlc3NlZEV2ZW50J10gPSBldmVudC50eXBlOwoJICAgICAgICAgICAgICAgIHByZXZpb3VzRWxlbWVudFZhbHVlID0gZWxlbWVudFZhbHVlOwoJICAgICAgICAgICAgICAgIGtvLmV4cHJlc3Npb25SZXdyaXRpbmcud3JpdGVWYWx1ZVRvUHJvcGVydHkodmFsdWVBY2Nlc3NvcigpLCBhbGxCaW5kaW5ncywgJ3RleHRJbnB1dCcsIGVsZW1lbnRWYWx1ZSk7CgkgICAgICAgICAgICB9CgkgICAgICAgIH07CgoJICAgICAgICB2YXIgZGVmZXJVcGRhdGVNb2RlbCA9IGZ1bmN0aW9uIChldmVudCkgewoJICAgICAgICAgICAgaWYgKCF0aW1lb3V0SGFuZGxlKSB7CgkgICAgICAgICAgICAgICAgLy8gVGhlIGVsZW1lbnRWYWx1ZUJlZm9yZUV2ZW50IHZhcmlhYmxlIGlzIHNldCAqb25seSogZHVyaW5nIHRoZSBicmllZiBnYXAgYmV0d2VlbiBhbgoJICAgICAgICAgICAgICAgIC8vIGV2ZW50IGZpcmluZyBhbmQgdGhlIHVwZGF0ZU1vZGVsIGZ1bmN0aW9uIHJ1bm5pbmcuIFRoaXMgYWxsb3dzIHVzIHRvIGlnbm9yZSBtb2RlbAoJICAgICAgICAgICAgICAgIC8vIHVwZGF0ZXMgdGhhdCBhcmUgZnJvbSB0aGUgcHJldmlvdXMgc3RhdGUgb2YgdGhlIGVsZW1lbnQsIHVzdWFsbHkgZHVlIHRvIHRlY2huaXF1ZXMKCSAgICAgICAgICAgICAgICAvLyBzdWNoIGFzIHJhdGVMaW1pdC4gU3VjaCB1cGRhdGVzLCBpZiBub3QgaWdub3JlZCwgY2FuIGNhdXNlIGtleXN0cm9rZXMgdG8gYmUgbG9zdC4KCSAgICAgICAgICAgICAgICBlbGVtZW50VmFsdWVCZWZvcmVFdmVudCA9IGVsZW1lbnQudmFsdWU7CgkgICAgICAgICAgICAgICAgdmFyIGhhbmRsZXIgPSBERUJVRyA/IHVwZGF0ZU1vZGVsLmJpbmQoZWxlbWVudCwge3R5cGU6IGV2ZW50LnR5cGV9KSA6IHVwZGF0ZU1vZGVsOwoJICAgICAgICAgICAgICAgIHRpbWVvdXRIYW5kbGUgPSBzZXRUaW1lb3V0KGhhbmRsZXIsIDQpOwoJICAgICAgICAgICAgfQoJICAgICAgICB9OwoKCSAgICAgICAgdmFyIHVwZGF0ZVZpZXcgPSBmdW5jdGlvbiAoKSB7CgkgICAgICAgICAgICB2YXIgbW9kZWxWYWx1ZSA9IGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUodmFsdWVBY2Nlc3NvcigpKTsKCgkgICAgICAgICAgICBpZiAobW9kZWxWYWx1ZSA9PT0gbnVsbCB8fCBtb2RlbFZhbHVlID09PSB1bmRlZmluZWQpIHsKCSAgICAgICAgICAgICAgICBtb2RlbFZhbHVlID0gJyc7CgkgICAgICAgICAgICB9CgoJICAgICAgICAgICAgaWYgKGVsZW1lbnRWYWx1ZUJlZm9yZUV2ZW50ICE9PSB1bmRlZmluZWQgJiYgbW9kZWxWYWx1ZSA9PT0gZWxlbWVudFZhbHVlQmVmb3JlRXZlbnQpIHsKCSAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KHVwZGF0ZVZpZXcsIDQpOwoJICAgICAgICAgICAgICAgIHJldHVybjsKCSAgICAgICAgICAgIH0KCgkgICAgICAgICAgICAvLyBVcGRhdGUgdGhlIGVsZW1lbnQgb25seSBpZiB0aGUgZWxlbWVudCBhbmQgbW9kZWwgYXJlIGRpZmZlcmVudC4gT24gc29tZSBicm93c2VycywgdXBkYXRpbmcgdGhlIHZhbHVlCgkgICAgICAgICAgICAvLyB3aWxsIG1vdmUgdGhlIGN1cnNvciB0byB0aGUgZW5kIG9mIHRoZSBpbnB1dCwgd2hpY2ggd291bGQgYmUgYmFkIHdoaWxlIHRoZSB1c2VyIGlzIHR5cGluZy4KCSAgICAgICAgICAgIGlmIChlbGVtZW50LnZhbHVlICE9PSBtb2RlbFZhbHVlKSB7CgkgICAgICAgICAgICAgICAgcHJldmlvdXNFbGVtZW50VmFsdWUgPSBtb2RlbFZhbHVlOyAgLy8gTWFrZSBzdXJlIHdlIGlnbm9yZSBldmVudHMgKHByb3BlcnR5Y2hhbmdlKSB0aGF0IHJlc3VsdCBmcm9tIHVwZGF0aW5nIHRoZSB2YWx1ZQoJICAgICAgICAgICAgICAgIGVsZW1lbnQudmFsdWUgPSBtb2RlbFZhbHVlOwoJICAgICAgICAgICAgfQoJICAgICAgICB9OwoKCSAgICAgICAgdmFyIG9uRXZlbnQgPSBmdW5jdGlvbiAoZXZlbnQsIGhhbmRsZXIpIHsKCSAgICAgICAgICAgIGtvLnV0aWxzLnJlZ2lzdGVyRXZlbnRIYW5kbGVyKGVsZW1lbnQsIGV2ZW50LCBoYW5kbGVyKTsKCSAgICAgICAgfTsKCgkgICAgICAgIGlmIChERUJVRyAmJiBrby5iaW5kaW5nSGFuZGxlcnNbJ3RleHRJbnB1dCddWydfZm9yY2VVcGRhdGVPbiddKSB7CgkgICAgICAgICAgICAvLyBQcm92aWRlIGEgd2F5IGZvciB0ZXN0cyB0byBzcGVjaWZ5IGV4YWN0bHkgd2hpY2ggZXZlbnRzIGFyZSBib3VuZAoJICAgICAgICAgICAga28udXRpbHMuYXJyYXlGb3JFYWNoKGtvLmJpbmRpbmdIYW5kbGVyc1sndGV4dElucHV0J11bJ19mb3JjZVVwZGF0ZU9uJ10sIGZ1bmN0aW9uKGV2ZW50TmFtZSkgewoJICAgICAgICAgICAgICAgIGlmIChldmVudE5hbWUuc2xpY2UoMCw1KSA9PSAnYWZ0ZXInKSB7CgkgICAgICAgICAgICAgICAgICAgIG9uRXZlbnQoZXZlbnROYW1lLnNsaWNlKDUpLCBkZWZlclVwZGF0ZU1vZGVsKTsKCSAgICAgICAgICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgICAgICAgICBvbkV2ZW50KGV2ZW50TmFtZSwgdXBkYXRlTW9kZWwpOwoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgIH0pOwoJICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgaWYgKGtvLnV0aWxzLmllVmVyc2lvbiA8IDEwKSB7CgkgICAgICAgICAgICAgICAgLy8gSW50ZXJuZXQgRXhwbG9yZXIgPD0gOCBkb2Vzbid0IHN1cHBvcnQgdGhlICdpbnB1dCcgZXZlbnQsIGJ1dCBkb2VzIGluY2x1ZGUgJ3Byb3BlcnR5Y2hhbmdlJyB0aGF0IGZpcmVzIHdoZW5ldmVyCgkgICAgICAgICAgICAgICAgLy8gYW55IHByb3BlcnR5IG9mIGFuIGVsZW1lbnQgY2hhbmdlcy4gVW5saWtlICdpbnB1dCcsIGl0IGFsc28gZmlyZXMgaWYgYSBwcm9wZXJ0eSBpcyBjaGFuZ2VkIGZyb20gSmF2YVNjcmlwdCBjb2RlLAoJICAgICAgICAgICAgICAgIC8vIGJ1dCB0aGF0J3MgYW4gYWNjZXB0YWJsZSBjb21wcm9taXNlIGZvciB0aGlzIGJpbmRpbmcuIElFIDkgZG9lcyBzdXBwb3J0ICdpbnB1dCcsIGJ1dCBzaW5jZSBpdCBkb2Vzbid0IGZpcmUgaXQKCSAgICAgICAgICAgICAgICAvLyB3aGVuIHVzaW5nIGF1dG9jb21wbGV0ZSwgd2UnbGwgdXNlICdwcm9wZXJ0eWNoYW5nZScgZm9yIGl0IGFsc28uCgkgICAgICAgICAgICAgICAgb25FdmVudCgncHJvcGVydHljaGFuZ2UnLCBmdW5jdGlvbihldmVudCkgewoJICAgICAgICAgICAgICAgICAgICBpZiAoZXZlbnQucHJvcGVydHlOYW1lID09PSAndmFsdWUnKSB7CgkgICAgICAgICAgICAgICAgICAgICAgICB1cGRhdGVNb2RlbChldmVudCk7CgkgICAgICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICB9KTsKCgkgICAgICAgICAgICAgICAgaWYgKGtvLnV0aWxzLmllVmVyc2lvbiA9PSA4KSB7CgkgICAgICAgICAgICAgICAgICAgIC8vIElFIDggaGFzIGEgYnVnIHdoZXJlIGl0IGZhaWxzIHRvIGZpcmUgJ3Byb3BlcnR5Y2hhbmdlJyBvbiB0aGUgZmlyc3QgdXBkYXRlIGZvbGxvd2luZyBhIHZhbHVlIGNoYW5nZSBmcm9tCgkgICAgICAgICAgICAgICAgICAgIC8vIEphdmFTY3JpcHQgY29kZS4gSXQgYWxzbyBkb2Vzbid0IGZpcmUgaWYgeW91IGNsZWFyIHRoZSBlbnRpcmUgdmFsdWUuIFRvIGZpeCB0aGlzLCB3ZSBiaW5kIHRvIHRoZSBmb2xsb3dpbmcKCSAgICAgICAgICAgICAgICAgICAgLy8gZXZlbnRzIHRvby4KCSAgICAgICAgICAgICAgICAgICAgb25FdmVudCgna2V5dXAnLCB1cGRhdGVNb2RlbCk7ICAgICAgLy8gQSBzaW5nbGUga2V5c3Rva2UKCSAgICAgICAgICAgICAgICAgICAgb25FdmVudCgna2V5ZG93bicsIHVwZGF0ZU1vZGVsKTsgICAgLy8gVGhlIGZpcnN0IGNoYXJhY3RlciB3aGVuIGEga2V5IGlzIGhlbGQgZG93bgoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICBpZiAoa28udXRpbHMuaWVWZXJzaW9uID49IDgpIHsKCSAgICAgICAgICAgICAgICAgICAgLy8gSW50ZXJuZXQgRXhwbG9yZXIgOSBkb2Vzbid0IGZpcmUgdGhlICdpbnB1dCcgZXZlbnQgd2hlbiBkZWxldGluZyB0ZXh0LCBpbmNsdWRpbmcgdXNpbmcKCSAgICAgICAgICAgICAgICAgICAgLy8gdGhlIGJhY2tzcGFjZSwgZGVsZXRlLCBvciBjdHJsLXgga2V5cywgY2xpY2tpbmcgdGhlICd4JyB0byBjbGVhciB0aGUgaW5wdXQsIGRyYWdnaW5nIHRleHQKCSAgICAgICAgICAgICAgICAgICAgLy8gb3V0IG9mIHRoZSBmaWVsZCwgYW5kIGN1dHRpbmcgb3IgZGVsZXRpbmcgdGV4dCB1c2luZyB0aGUgY29udGV4dCBtZW51LiAnc2VsZWN0aW9uY2hhbmdlJwoJICAgICAgICAgICAgICAgICAgICAvLyBjYW4gZGV0ZWN0IGFsbCBvZiB0aG9zZSBleGNlcHQgZHJhZ2dpbmcgdGV4dCBvdXQgb2YgdGhlIGZpZWxkLCBmb3Igd2hpY2ggd2UgdXNlICdkcmFnZW5kJy4KCSAgICAgICAgICAgICAgICAgICAgLy8gVGhlc2UgYXJlIGFsc28gbmVlZGVkIGluIElFOCBiZWNhdXNlIG9mIHRoZSBidWcgZGVzY3JpYmVkIGFib3ZlLgoJICAgICAgICAgICAgICAgICAgICByZWdpc3RlckZvclNlbGVjdGlvbkNoYW5nZUV2ZW50KGVsZW1lbnQsIHVwZGF0ZU1vZGVsKTsgIC8vICdzZWxlY3Rpb25jaGFuZ2UnIGNvdmVycyBjdXQsIHBhc3RlLCBkcm9wLCBkZWxldGUsIGV0Yy4KCSAgICAgICAgICAgICAgICAgICAgb25FdmVudCgnZHJhZ2VuZCcsIGRlZmVyVXBkYXRlTW9kZWwpOwoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICAgICAgLy8gQWxsIG90aGVyIHN1cHBvcnRlZCBicm93c2VycyBzdXBwb3J0IHRoZSAnaW5wdXQnIGV2ZW50LCB3aGljaCBmaXJlcyB3aGVuZXZlciB0aGUgY29udGVudCBvZiB0aGUgZWxlbWVudCBpcyBjaGFuZ2VkCgkgICAgICAgICAgICAgICAgLy8gdGhyb3VnaCB0aGUgdXNlciBpbnRlcmZhY2UuCgkgICAgICAgICAgICAgICAgb25FdmVudCgnaW5wdXQnLCB1cGRhdGVNb2RlbCk7CgoJICAgICAgICAgICAgICAgIGlmIChzYWZhcmlWZXJzaW9uIDwgNSAmJiBrby51dGlscy50YWdOYW1lTG93ZXIoZWxlbWVudCkgPT09ICJ0ZXh0YXJlYSIpIHsKCSAgICAgICAgICAgICAgICAgICAgLy8gU2FmYXJpIDw1IGRvZXNuJ3QgZmlyZSB0aGUgJ2lucHV0JyBldmVudCBmb3IgPHRleHRhcmVhPiBlbGVtZW50cyAoaXQgZG9lcyBmaXJlICd0ZXh0SW5wdXQnCgkgICAgICAgICAgICAgICAgICAgIC8vIGJ1dCBvbmx5IHdoZW4gdHlwaW5nKS4gU28gd2UnbGwganVzdCBjYXRjaCBhcyBtdWNoIGFzIHdlIGNhbiB3aXRoIGtleWRvd24sIGN1dCwgYW5kIHBhc3RlLgoJICAgICAgICAgICAgICAgICAgICBvbkV2ZW50KCdrZXlkb3duJywgZGVmZXJVcGRhdGVNb2RlbCk7CgkgICAgICAgICAgICAgICAgICAgIG9uRXZlbnQoJ3Bhc3RlJywgZGVmZXJVcGRhdGVNb2RlbCk7CgkgICAgICAgICAgICAgICAgICAgIG9uRXZlbnQoJ2N1dCcsIGRlZmVyVXBkYXRlTW9kZWwpOwoJICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAob3BlcmFWZXJzaW9uIDwgMTEpIHsKCSAgICAgICAgICAgICAgICAgICAgLy8gT3BlcmEgMTAgZG9lc24ndCBhbHdheXMgZmlyZSB0aGUgJ2lucHV0JyBldmVudCBmb3IgY3V0LCBwYXN0ZSwgdW5kbyAmIGRyb3Agb3BlcmF0aW9ucy4KCSAgICAgICAgICAgICAgICAgICAgLy8gV2UgY2FuIHRyeSB0byBjYXRjaCBzb21lIG9mIHRob3NlIHVzaW5nICdrZXlkb3duJy4KCSAgICAgICAgICAgICAgICAgICAgb25FdmVudCgna2V5ZG93bicsIGRlZmVyVXBkYXRlTW9kZWwpOwoJICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoZmlyZWZveFZlcnNpb24gPCA0LjApIHsKCSAgICAgICAgICAgICAgICAgICAgLy8gRmlyZWZveCA8PSAzLjYgZG9lc24ndCBmaXJlIHRoZSAnaW5wdXQnIGV2ZW50IHdoZW4gdGV4dCBpcyBmaWxsZWQgaW4gdGhyb3VnaCBhdXRvY29tcGxldGUKCSAgICAgICAgICAgICAgICAgICAgb25FdmVudCgnRE9NQXV0b0NvbXBsZXRlJywgdXBkYXRlTW9kZWwpOwoKCSAgICAgICAgICAgICAgICAgICAgLy8gRmlyZWZveCA8PTMuNSBkb2Vzbid0IGZpcmUgdGhlICdpbnB1dCcgZXZlbnQgd2hlbiB0ZXh0IGlzIGRyb3BwZWQgaW50byB0aGUgaW5wdXQuCgkgICAgICAgICAgICAgICAgICAgIG9uRXZlbnQoJ2RyYWdkcm9wJywgdXBkYXRlTW9kZWwpOyAgICAgICAvLyA8My41CgkgICAgICAgICAgICAgICAgICAgIG9uRXZlbnQoJ2Ryb3AnLCB1cGRhdGVNb2RlbCk7ICAgICAgICAgICAvLyAzLjUKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICB9CgkgICAgICAgIH0KCgkgICAgICAgIC8vIEJpbmQgdG8gdGhlIGNoYW5nZSBldmVudCBzbyB0aGF0IHdlIGNhbiBjYXRjaCBwcm9ncmFtbWF0aWMgdXBkYXRlcyBvZiB0aGUgdmFsdWUgdGhhdCBmaXJlIHRoaXMgZXZlbnQuCgkgICAgICAgIG9uRXZlbnQoJ2NoYW5nZScsIHVwZGF0ZU1vZGVsKTsKCgkgICAgICAgIGtvLmNvbXB1dGVkKHVwZGF0ZVZpZXcsIG51bGwsIHsgZGlzcG9zZVdoZW5Ob2RlSXNSZW1vdmVkOiBlbGVtZW50IH0pOwoJICAgIH0KCX07Cglrby5leHByZXNzaW9uUmV3cml0aW5nLnR3b1dheUJpbmRpbmdzWyd0ZXh0SW5wdXQnXSA9IHRydWU7CgoJLy8gdGV4dGlucHV0IGlzIGFuIGFsaWFzIGZvciB0ZXh0SW5wdXQKCWtvLmJpbmRpbmdIYW5kbGVyc1sndGV4dGlucHV0J10gPSB7CgkgICAgLy8gcHJlcHJvY2VzcyBpcyB0aGUgb25seSB3YXkgdG8gc2V0IHVwIGEgZnVsbCBhbGlhcwoJICAgICdwcmVwcm9jZXNzJzogZnVuY3Rpb24gKHZhbHVlLCBuYW1lLCBhZGRCaW5kaW5nKSB7CgkgICAgICAgIGFkZEJpbmRpbmcoJ3RleHRJbnB1dCcsIHZhbHVlKTsKCSAgICB9Cgl9OwoKCX0pKCk7a28uYmluZGluZ0hhbmRsZXJzWyd1bmlxdWVOYW1lJ10gPSB7CgkgICAgJ2luaXQnOiBmdW5jdGlvbiAoZWxlbWVudCwgdmFsdWVBY2Nlc3NvcikgewoJICAgICAgICBpZiAodmFsdWVBY2Nlc3NvcigpKSB7CgkgICAgICAgICAgICB2YXIgbmFtZSA9ICJrb191bmlxdWVfIiArICgrK2tvLmJpbmRpbmdIYW5kbGVyc1sndW5pcXVlTmFtZSddLmN1cnJlbnRJbmRleCk7CgkgICAgICAgICAgICBrby51dGlscy5zZXRFbGVtZW50TmFtZShlbGVtZW50LCBuYW1lKTsKCSAgICAgICAgfQoJICAgIH0KCX07Cglrby5iaW5kaW5nSGFuZGxlcnNbJ3VuaXF1ZU5hbWUnXS5jdXJyZW50SW5kZXggPSAwOwoJa28uYmluZGluZ0hhbmRsZXJzWyd2YWx1ZSddID0gewoJICAgICdhZnRlcic6IFsnb3B0aW9ucycsICdmb3JlYWNoJ10sCgkgICAgJ2luaXQnOiBmdW5jdGlvbiAoZWxlbWVudCwgdmFsdWVBY2Nlc3NvciwgYWxsQmluZGluZ3MpIHsKCSAgICAgICAgLy8gSWYgdGhlIHZhbHVlIGJpbmRpbmcgaXMgcGxhY2VkIG9uIGEgcmFkaW8vY2hlY2tib3gsIHRoZW4ganVzdCBwYXNzIHRocm91Z2ggdG8gY2hlY2tlZFZhbHVlIGFuZCBxdWl0CgkgICAgICAgIGlmIChlbGVtZW50LnRhZ05hbWUudG9Mb3dlckNhc2UoKSA9PSAiaW5wdXQiICYmIChlbGVtZW50LnR5cGUgPT0gImNoZWNrYm94IiB8fCBlbGVtZW50LnR5cGUgPT0gInJhZGlvIikpIHsKCSAgICAgICAgICAgIGtvLmFwcGx5QmluZGluZ0FjY2Vzc29yc1RvTm9kZShlbGVtZW50LCB7ICdjaGVja2VkVmFsdWUnOiB2YWx1ZUFjY2Vzc29yIH0pOwoJICAgICAgICAgICAgcmV0dXJuOwoJICAgICAgICB9CgoJICAgICAgICAvLyBBbHdheXMgY2F0Y2ggImNoYW5nZSIgZXZlbnQ7IHBvc3NpYmx5IG90aGVyIGV2ZW50cyB0b28gaWYgYXNrZWQKCSAgICAgICAgdmFyIGV2ZW50c1RvQ2F0Y2ggPSBbImNoYW5nZSJdOwoJICAgICAgICB2YXIgcmVxdWVzdGVkRXZlbnRzVG9DYXRjaCA9IGFsbEJpbmRpbmdzLmdldCgidmFsdWVVcGRhdGUiKTsKCSAgICAgICAgdmFyIHByb3BlcnR5Q2hhbmdlZEZpcmVkID0gZmFsc2U7CgkgICAgICAgIHZhciBlbGVtZW50VmFsdWVCZWZvcmVFdmVudCA9IG51bGw7CgoJICAgICAgICBpZiAocmVxdWVzdGVkRXZlbnRzVG9DYXRjaCkgewoJICAgICAgICAgICAgaWYgKHR5cGVvZiByZXF1ZXN0ZWRFdmVudHNUb0NhdGNoID09ICJzdHJpbmciKSAvLyBBbGxvdyBib3RoIGluZGl2aWR1YWwgZXZlbnQgbmFtZXMsIGFuZCBhcnJheXMgb2YgZXZlbnQgbmFtZXMKCSAgICAgICAgICAgICAgICByZXF1ZXN0ZWRFdmVudHNUb0NhdGNoID0gW3JlcXVlc3RlZEV2ZW50c1RvQ2F0Y2hdOwoJICAgICAgICAgICAga28udXRpbHMuYXJyYXlQdXNoQWxsKGV2ZW50c1RvQ2F0Y2gsIHJlcXVlc3RlZEV2ZW50c1RvQ2F0Y2gpOwoJICAgICAgICAgICAgZXZlbnRzVG9DYXRjaCA9IGtvLnV0aWxzLmFycmF5R2V0RGlzdGluY3RWYWx1ZXMoZXZlbnRzVG9DYXRjaCk7CgkgICAgICAgIH0KCgkgICAgICAgIHZhciB2YWx1ZVVwZGF0ZUhhbmRsZXIgPSBmdW5jdGlvbigpIHsKCSAgICAgICAgICAgIGVsZW1lbnRWYWx1ZUJlZm9yZUV2ZW50ID0gbnVsbDsKCSAgICAgICAgICAgIHByb3BlcnR5Q2hhbmdlZEZpcmVkID0gZmFsc2U7CgkgICAgICAgICAgICB2YXIgbW9kZWxWYWx1ZSA9IHZhbHVlQWNjZXNzb3IoKTsKCSAgICAgICAgICAgIHZhciBlbGVtZW50VmFsdWUgPSBrby5zZWxlY3RFeHRlbnNpb25zLnJlYWRWYWx1ZShlbGVtZW50KTsKCSAgICAgICAgICAgIGtvLmV4cHJlc3Npb25SZXdyaXRpbmcud3JpdGVWYWx1ZVRvUHJvcGVydHkobW9kZWxWYWx1ZSwgYWxsQmluZGluZ3MsICd2YWx1ZScsIGVsZW1lbnRWYWx1ZSk7CgkgICAgICAgIH0KCgkgICAgICAgIC8vIFdvcmthcm91bmQgZm9yIGh0dHBzOi8vZ2l0aHViLmNvbS9TdGV2ZVNhbmRlcnNvbi9rbm9ja291dC9pc3N1ZXMvMTIyCgkgICAgICAgIC8vIElFIGRvZXNuJ3QgZmlyZSAiY2hhbmdlIiBldmVudHMgb24gdGV4dGJveGVzIGlmIHRoZSB1c2VyIHNlbGVjdHMgYSB2YWx1ZSBmcm9tIGl0cyBhdXRvY29tcGxldGUgbGlzdAoJICAgICAgICB2YXIgaWVBdXRvQ29tcGxldGVIYWNrTmVlZGVkID0ga28udXRpbHMuaWVWZXJzaW9uICYmIGVsZW1lbnQudGFnTmFtZS50b0xvd2VyQ2FzZSgpID09ICJpbnB1dCIgJiYgZWxlbWVudC50eXBlID09ICJ0ZXh0IgoJICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJiYgZWxlbWVudC5hdXRvY29tcGxldGUgIT0gIm9mZiIgJiYgKCFlbGVtZW50LmZvcm0gfHwgZWxlbWVudC5mb3JtLmF1dG9jb21wbGV0ZSAhPSAib2ZmIik7CgkgICAgICAgIGlmIChpZUF1dG9Db21wbGV0ZUhhY2tOZWVkZWQgJiYga28udXRpbHMuYXJyYXlJbmRleE9mKGV2ZW50c1RvQ2F0Y2gsICJwcm9wZXJ0eWNoYW5nZSIpID09IC0xKSB7CgkgICAgICAgICAgICBrby51dGlscy5yZWdpc3RlckV2ZW50SGFuZGxlcihlbGVtZW50LCAicHJvcGVydHljaGFuZ2UiLCBmdW5jdGlvbiAoKSB7IHByb3BlcnR5Q2hhbmdlZEZpcmVkID0gdHJ1ZSB9KTsKCSAgICAgICAgICAgIGtvLnV0aWxzLnJlZ2lzdGVyRXZlbnRIYW5kbGVyKGVsZW1lbnQsICJmb2N1cyIsIGZ1bmN0aW9uICgpIHsgcHJvcGVydHlDaGFuZ2VkRmlyZWQgPSBmYWxzZSB9KTsKCSAgICAgICAgICAgIGtvLnV0aWxzLnJlZ2lzdGVyRXZlbnRIYW5kbGVyKGVsZW1lbnQsICJibHVyIiwgZnVuY3Rpb24oKSB7CgkgICAgICAgICAgICAgICAgaWYgKHByb3BlcnR5Q2hhbmdlZEZpcmVkKSB7CgkgICAgICAgICAgICAgICAgICAgIHZhbHVlVXBkYXRlSGFuZGxlcigpOwoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgIH0pOwoJICAgICAgICB9CgoJICAgICAgICBrby51dGlscy5hcnJheUZvckVhY2goZXZlbnRzVG9DYXRjaCwgZnVuY3Rpb24oZXZlbnROYW1lKSB7CgkgICAgICAgICAgICAvLyBUaGUgc3ludGF4ICJhZnRlcjxldmVudG5hbWU+IiBtZWFucyAicnVuIHRoZSBoYW5kbGVyIGFzeW5jaHJvbm91c2x5IGFmdGVyIHRoZSBldmVudCIKCSAgICAgICAgICAgIC8vIFRoaXMgaXMgdXNlZnVsLCBmb3IgZXhhbXBsZSwgdG8gY2F0Y2ggImtleWRvd24iIGV2ZW50cyBhZnRlciB0aGUgYnJvd3NlciBoYXMgdXBkYXRlZCB0aGUgY29udHJvbAoJICAgICAgICAgICAgLy8gKG90aGVyd2lzZSwga28uc2VsZWN0RXh0ZW5zaW9ucy5yZWFkVmFsdWUodGhpcykgd2lsbCByZWNlaXZlIHRoZSBjb250cm9sJ3MgdmFsdWUgKmJlZm9yZSogdGhlIGtleSBldmVudCkKCSAgICAgICAgICAgIHZhciBoYW5kbGVyID0gdmFsdWVVcGRhdGVIYW5kbGVyOwoJICAgICAgICAgICAgaWYgKGtvLnV0aWxzLnN0cmluZ1N0YXJ0c1dpdGgoZXZlbnROYW1lLCAiYWZ0ZXIiKSkgewoJICAgICAgICAgICAgICAgIGhhbmRsZXIgPSBmdW5jdGlvbigpIHsKCSAgICAgICAgICAgICAgICAgICAgLy8gVGhlIGVsZW1lbnRWYWx1ZUJlZm9yZUV2ZW50IHZhcmlhYmxlIGlzIG5vbi1udWxsICpvbmx5KiBkdXJpbmcgdGhlIGJyaWVmIGdhcCBiZXR3ZWVuCgkgICAgICAgICAgICAgICAgICAgIC8vIGEga2V5WCBldmVudCBmaXJpbmcgYW5kIHRoZSB2YWx1ZVVwZGF0ZUhhbmRsZXIgcnVubmluZywgd2hpY2ggaXMgc2NoZWR1bGVkIHRvIGhhcHBlbgoJICAgICAgICAgICAgICAgICAgICAvLyBhdCB0aGUgZWFybGllc3QgYXN5bmNocm9ub3VzIG9wcG9ydHVuaXR5LiBXZSBzdG9yZSB0aGlzIHRlbXBvcmFyeSBpbmZvcm1hdGlvbiBzbyB0aGF0CgkgICAgICAgICAgICAgICAgICAgIC8vIGlmLCBiZXR3ZWVuIGtleVggYW5kIHZhbHVlVXBkYXRlSGFuZGxlciwgdGhlIHVuZGVybHlpbmcgbW9kZWwgdmFsdWUgY2hhbmdlcyBzZXBhcmF0ZWx5LAoJICAgICAgICAgICAgICAgICAgICAvLyB3ZSBjYW4gb3ZlcndyaXRlIHRoYXQgbW9kZWwgdmFsdWUgY2hhbmdlIHdpdGggdGhlIHZhbHVlIHRoZSB1c2VyIGp1c3QgdHlwZWQuIE90aGVyd2lzZSwKCSAgICAgICAgICAgICAgICAgICAgLy8gdGVjaG5pcXVlcyBsaWtlIHJhdGVMaW1pdCBjYW4gdHJpZ2dlciBtb2RlbCBjaGFuZ2VzIGF0IGNyaXRpY2FsIG1vbWVudHMgdGhhdCB3aWxsCgkgICAgICAgICAgICAgICAgICAgIC8vIG92ZXJyaWRlIHRoZSB1c2VyJ3MgaW5wdXRzLCBjYXVzaW5nIGtleXN0cm9rZXMgdG8gYmUgbG9zdC4KCSAgICAgICAgICAgICAgICAgICAgZWxlbWVudFZhbHVlQmVmb3JlRXZlbnQgPSBrby5zZWxlY3RFeHRlbnNpb25zLnJlYWRWYWx1ZShlbGVtZW50KTsKCSAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dCh2YWx1ZVVwZGF0ZUhhbmRsZXIsIDApOwoJICAgICAgICAgICAgICAgIH07CgkgICAgICAgICAgICAgICAgZXZlbnROYW1lID0gZXZlbnROYW1lLnN1YnN0cmluZygiYWZ0ZXIiLmxlbmd0aCk7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICBrby51dGlscy5yZWdpc3RlckV2ZW50SGFuZGxlcihlbGVtZW50LCBldmVudE5hbWUsIGhhbmRsZXIpOwoJICAgICAgICB9KTsKCgkgICAgICAgIHZhciB1cGRhdGVGcm9tTW9kZWwgPSBmdW5jdGlvbiAoKSB7CgkgICAgICAgICAgICB2YXIgbmV3VmFsdWUgPSBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKHZhbHVlQWNjZXNzb3IoKSk7CgkgICAgICAgICAgICB2YXIgZWxlbWVudFZhbHVlID0ga28uc2VsZWN0RXh0ZW5zaW9ucy5yZWFkVmFsdWUoZWxlbWVudCk7CgoJICAgICAgICAgICAgaWYgKGVsZW1lbnRWYWx1ZUJlZm9yZUV2ZW50ICE9PSBudWxsICYmIG5ld1ZhbHVlID09PSBlbGVtZW50VmFsdWVCZWZvcmVFdmVudCkgewoJICAgICAgICAgICAgICAgIHNldFRpbWVvdXQodXBkYXRlRnJvbU1vZGVsLCAwKTsKCSAgICAgICAgICAgICAgICByZXR1cm47CgkgICAgICAgICAgICB9CgoJICAgICAgICAgICAgdmFyIHZhbHVlSGFzQ2hhbmdlZCA9IChuZXdWYWx1ZSAhPT0gZWxlbWVudFZhbHVlKTsKCgkgICAgICAgICAgICBpZiAodmFsdWVIYXNDaGFuZ2VkKSB7CgkgICAgICAgICAgICAgICAgaWYgKGtvLnV0aWxzLnRhZ05hbWVMb3dlcihlbGVtZW50KSA9PT0gInNlbGVjdCIpIHsKCSAgICAgICAgICAgICAgICAgICAgdmFyIGFsbG93VW5zZXQgPSBhbGxCaW5kaW5ncy5nZXQoJ3ZhbHVlQWxsb3dVbnNldCcpOwoJICAgICAgICAgICAgICAgICAgICB2YXIgYXBwbHlWYWx1ZUFjdGlvbiA9IGZ1bmN0aW9uICgpIHsKCSAgICAgICAgICAgICAgICAgICAgICAgIGtvLnNlbGVjdEV4dGVuc2lvbnMud3JpdGVWYWx1ZShlbGVtZW50LCBuZXdWYWx1ZSwgYWxsb3dVbnNldCk7CgkgICAgICAgICAgICAgICAgICAgIH07CgkgICAgICAgICAgICAgICAgICAgIGFwcGx5VmFsdWVBY3Rpb24oKTsKCgkgICAgICAgICAgICAgICAgICAgIGlmICghYWxsb3dVbnNldCAmJiBuZXdWYWx1ZSAhPT0ga28uc2VsZWN0RXh0ZW5zaW9ucy5yZWFkVmFsdWUoZWxlbWVudCkpIHsKCSAgICAgICAgICAgICAgICAgICAgICAgIC8vIElmIHlvdSB0cnkgdG8gc2V0IGEgbW9kZWwgdmFsdWUgdGhhdCBjYW4ndCBiZSByZXByZXNlbnRlZCBpbiBhbiBhbHJlYWR5LXBvcHVsYXRlZCBkcm9wZG93biwgcmVqZWN0IHRoYXQgY2hhbmdlLAoJICAgICAgICAgICAgICAgICAgICAgICAgLy8gYmVjYXVzZSB5b3UncmUgbm90IGFsbG93ZWQgdG8gaGF2ZSBhIG1vZGVsIHZhbHVlIHRoYXQgZGlzYWdyZWVzIHdpdGggYSB2aXNpYmxlIFVJIHNlbGVjdGlvbi4KCSAgICAgICAgICAgICAgICAgICAgICAgIGtvLmRlcGVuZGVuY3lEZXRlY3Rpb24uaWdub3JlKGtvLnV0aWxzLnRyaWdnZXJFdmVudCwgbnVsbCwgW2VsZW1lbnQsICJjaGFuZ2UiXSk7CgkgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICAgICAgICAgICAgICAvLyBXb3JrYXJvdW5kIGZvciBJRTYgYnVnOiBJdCB3b24ndCByZWxpYWJseSBhcHBseSB2YWx1ZXMgdG8gU0VMRUNUIG5vZGVzIGR1cmluZyB0aGUgc2FtZSBleGVjdXRpb24gdGhyZWFkCgkgICAgICAgICAgICAgICAgICAgICAgICAvLyByaWdodCBhZnRlciB5b3UndmUgY2hhbmdlZCB0aGUgc2V0IG9mIE9QVElPTiBub2RlcyBvbiBpdC4gU28gZm9yIHRoYXQgbm9kZSB0eXBlLCB3ZSdsbCBzY2hlZHVsZSBhIHNlY29uZCB0aHJlYWQKCSAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRvIGFwcGx5IHRoZSB2YWx1ZSBhcyB3ZWxsLgoJICAgICAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dChhcHBseVZhbHVlQWN0aW9uLCAwKTsKCSAgICAgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICAgICAgICAgIGtvLnNlbGVjdEV4dGVuc2lvbnMud3JpdGVWYWx1ZShlbGVtZW50LCBuZXdWYWx1ZSk7CgkgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgfQoJICAgICAgICB9OwoKCSAgICAgICAga28uY29tcHV0ZWQodXBkYXRlRnJvbU1vZGVsLCBudWxsLCB7IGRpc3Bvc2VXaGVuTm9kZUlzUmVtb3ZlZDogZWxlbWVudCB9KTsKCSAgICB9LAoJICAgICd1cGRhdGUnOiBmdW5jdGlvbigpIHt9IC8vIEtlZXAgZm9yIGJhY2t3YXJkcyBjb21wYXRpYmlsaXR5IHdpdGggY29kZSB0aGF0IG1heSBoYXZlIHdyYXBwZWQgdmFsdWUgYmluZGluZwoJfTsKCWtvLmV4cHJlc3Npb25SZXdyaXRpbmcudHdvV2F5QmluZGluZ3NbJ3ZhbHVlJ10gPSB0cnVlOwoJa28uYmluZGluZ0hhbmRsZXJzWyd2aXNpYmxlJ10gPSB7CgkgICAgJ3VwZGF0ZSc6IGZ1bmN0aW9uIChlbGVtZW50LCB2YWx1ZUFjY2Vzc29yKSB7CgkgICAgICAgIHZhciB2YWx1ZSA9IGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUodmFsdWVBY2Nlc3NvcigpKTsKCSAgICAgICAgdmFyIGlzQ3VycmVudGx5VmlzaWJsZSA9ICEoZWxlbWVudC5zdHlsZS5kaXNwbGF5ID09ICJub25lIik7CgkgICAgICAgIGlmICh2YWx1ZSAmJiAhaXNDdXJyZW50bHlWaXNpYmxlKQoJICAgICAgICAgICAgZWxlbWVudC5zdHlsZS5kaXNwbGF5ID0gIiI7CgkgICAgICAgIGVsc2UgaWYgKCghdmFsdWUpICYmIGlzQ3VycmVudGx5VmlzaWJsZSkKCSAgICAgICAgICAgIGVsZW1lbnQuc3R5bGUuZGlzcGxheSA9ICJub25lIjsKCSAgICB9Cgl9OwoJLy8gJ2NsaWNrJyBpcyBqdXN0IGEgc2hvcnRoYW5kIGZvciB0aGUgdXN1YWwgZnVsbC1sZW5ndGggZXZlbnQ6e2NsaWNrOmhhbmRsZXJ9CgltYWtlRXZlbnRIYW5kbGVyU2hvcnRjdXQoJ2NsaWNrJyk7CgkvLyBJZiB5b3Ugd2FudCB0byBtYWtlIGEgY3VzdG9tIHRlbXBsYXRlIGVuZ2luZSwKCS8vCgkvLyBbMV0gSW5oZXJpdCBmcm9tIHRoaXMgY2xhc3MgKGxpa2Uga28ubmF0aXZlVGVtcGxhdGVFbmdpbmUgZG9lcykKCS8vIFsyXSBPdmVycmlkZSAncmVuZGVyVGVtcGxhdGVTb3VyY2UnLCBzdXBwbHlpbmcgYSBmdW5jdGlvbiB3aXRoIHRoaXMgc2lnbmF0dXJlOgoJLy8KCS8vICAgICAgICBmdW5jdGlvbiAodGVtcGxhdGVTb3VyY2UsIGJpbmRpbmdDb250ZXh0LCBvcHRpb25zKSB7CgkvLyAgICAgICAgICAgIC8vIC0gdGVtcGxhdGVTb3VyY2UudGV4dCgpIGlzIHRoZSB0ZXh0IG9mIHRoZSB0ZW1wbGF0ZSB5b3Ugc2hvdWxkIHJlbmRlcgoJLy8gICAgICAgICAgICAvLyAtIGJpbmRpbmdDb250ZXh0LiRkYXRhIGlzIHRoZSBkYXRhIHlvdSBzaG91bGQgcGFzcyBpbnRvIHRoZSB0ZW1wbGF0ZQoJLy8gICAgICAgICAgICAvLyAgIC0geW91IG1pZ2h0IGFsc28gd2FudCB0byBtYWtlIGJpbmRpbmdDb250ZXh0LiRwYXJlbnQsIGJpbmRpbmdDb250ZXh0LiRwYXJlbnRzLAoJLy8gICAgICAgICAgICAvLyAgICAgYW5kIGJpbmRpbmdDb250ZXh0LiRyb290IGF2YWlsYWJsZSBpbiB0aGUgdGVtcGxhdGUgdG9vCgkvLyAgICAgICAgICAgIC8vIC0gb3B0aW9ucyBnaXZlcyB5b3UgYWNjZXNzIHRvIGFueSBvdGhlciBwcm9wZXJ0aWVzIHNldCBvbiAiZGF0YS1iaW5kOiB7IHRlbXBsYXRlOiBvcHRpb25zIH0iCgkvLyAgICAgICAgICAgIC8vCgkvLyAgICAgICAgICAgIC8vIFJldHVybiB2YWx1ZTogYW4gYXJyYXkgb2YgRE9NIG5vZGVzCgkvLyAgICAgICAgfQoJLy8KCS8vIFszXSBPdmVycmlkZSAnY3JlYXRlSmF2YVNjcmlwdEV2YWx1YXRvckJsb2NrJywgc3VwcGx5aW5nIGEgZnVuY3Rpb24gd2l0aCB0aGlzIHNpZ25hdHVyZToKCS8vCgkvLyAgICAgICAgZnVuY3Rpb24gKHNjcmlwdCkgewoJLy8gICAgICAgICAgICAvLyBSZXR1cm4gdmFsdWU6IFdoYXRldmVyIHN5bnRheCBtZWFucyAiRXZhbHVhdGUgdGhlIEphdmFTY3JpcHQgc3RhdGVtZW50ICdzY3JpcHQnIGFuZCBvdXRwdXQgdGhlIHJlc3VsdCIKCS8vICAgICAgICAgICAgLy8gICAgICAgICAgICAgICBGb3IgZXhhbXBsZSwgdGhlIGpxdWVyeS50bXBsIHRlbXBsYXRlIGVuZ2luZSBjb252ZXJ0cyAnc29tZVNjcmlwdCcgdG8gJyR7IHNvbWVTY3JpcHQgfScKCS8vICAgICAgICB9CgkvLwoJLy8gICAgIFRoaXMgaXMgb25seSBuZWNlc3NhcnkgaWYgeW91IHdhbnQgdG8gYWxsb3cgZGF0YS1iaW5kIGF0dHJpYnV0ZXMgdG8gcmVmZXJlbmNlIGFyYml0cmFyeSB0ZW1wbGF0ZSB2YXJpYWJsZXMuCgkvLyAgICAgSWYgeW91IGRvbid0IHdhbnQgdG8gYWxsb3cgdGhhdCwgeW91IGNhbiBzZXQgdGhlIHByb3BlcnR5ICdhbGxvd1RlbXBsYXRlUmV3cml0aW5nJyB0byBmYWxzZSAobGlrZSBrby5uYXRpdmVUZW1wbGF0ZUVuZ2luZSBkb2VzKQoJLy8gICAgIGFuZCB0aGVuIHlvdSBkb24ndCBuZWVkIHRvIG92ZXJyaWRlICdjcmVhdGVKYXZhU2NyaXB0RXZhbHVhdG9yQmxvY2snLgoKCWtvLnRlbXBsYXRlRW5naW5lID0gZnVuY3Rpb24gKCkgeyB9OwoKCWtvLnRlbXBsYXRlRW5naW5lLnByb3RvdHlwZVsncmVuZGVyVGVtcGxhdGVTb3VyY2UnXSA9IGZ1bmN0aW9uICh0ZW1wbGF0ZVNvdXJjZSwgYmluZGluZ0NvbnRleHQsIG9wdGlvbnMpIHsKCSAgICB0aHJvdyBuZXcgRXJyb3IoIk92ZXJyaWRlIHJlbmRlclRlbXBsYXRlU291cmNlIik7Cgl9OwoKCWtvLnRlbXBsYXRlRW5naW5lLnByb3RvdHlwZVsnY3JlYXRlSmF2YVNjcmlwdEV2YWx1YXRvckJsb2NrJ10gPSBmdW5jdGlvbiAoc2NyaXB0KSB7CgkgICAgdGhyb3cgbmV3IEVycm9yKCJPdmVycmlkZSBjcmVhdGVKYXZhU2NyaXB0RXZhbHVhdG9yQmxvY2siKTsKCX07CgoJa28udGVtcGxhdGVFbmdpbmUucHJvdG90eXBlWydtYWtlVGVtcGxhdGVTb3VyY2UnXSA9IGZ1bmN0aW9uKHRlbXBsYXRlLCB0ZW1wbGF0ZURvY3VtZW50KSB7CgkgICAgLy8gTmFtZWQgdGVtcGxhdGUKCSAgICBpZiAodHlwZW9mIHRlbXBsYXRlID09ICJzdHJpbmciKSB7CgkgICAgICAgIHRlbXBsYXRlRG9jdW1lbnQgPSB0ZW1wbGF0ZURvY3VtZW50IHx8IGRvY3VtZW50OwoJICAgICAgICB2YXIgZWxlbSA9IHRlbXBsYXRlRG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQodGVtcGxhdGUpOwoJICAgICAgICBpZiAoIWVsZW0pCgkgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkNhbm5vdCBmaW5kIHRlbXBsYXRlIHdpdGggSUQgIiArIHRlbXBsYXRlKTsKCSAgICAgICAgcmV0dXJuIG5ldyBrby50ZW1wbGF0ZVNvdXJjZXMuZG9tRWxlbWVudChlbGVtKTsKCSAgICB9IGVsc2UgaWYgKCh0ZW1wbGF0ZS5ub2RlVHlwZSA9PSAxKSB8fCAodGVtcGxhdGUubm9kZVR5cGUgPT0gOCkpIHsKCSAgICAgICAgLy8gQW5vbnltb3VzIHRlbXBsYXRlCgkgICAgICAgIHJldHVybiBuZXcga28udGVtcGxhdGVTb3VyY2VzLmFub255bW91c1RlbXBsYXRlKHRlbXBsYXRlKTsKCSAgICB9IGVsc2UKCSAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbmtub3duIHRlbXBsYXRlIHR5cGU6ICIgKyB0ZW1wbGF0ZSk7Cgl9OwoKCWtvLnRlbXBsYXRlRW5naW5lLnByb3RvdHlwZVsncmVuZGVyVGVtcGxhdGUnXSA9IGZ1bmN0aW9uICh0ZW1wbGF0ZSwgYmluZGluZ0NvbnRleHQsIG9wdGlvbnMsIHRlbXBsYXRlRG9jdW1lbnQpIHsKCSAgICB2YXIgdGVtcGxhdGVTb3VyY2UgPSB0aGlzWydtYWtlVGVtcGxhdGVTb3VyY2UnXSh0ZW1wbGF0ZSwgdGVtcGxhdGVEb2N1bWVudCk7CgkgICAgcmV0dXJuIHRoaXNbJ3JlbmRlclRlbXBsYXRlU291cmNlJ10odGVtcGxhdGVTb3VyY2UsIGJpbmRpbmdDb250ZXh0LCBvcHRpb25zKTsKCX07CgoJa28udGVtcGxhdGVFbmdpbmUucHJvdG90eXBlWydpc1RlbXBsYXRlUmV3cml0dGVuJ10gPSBmdW5jdGlvbiAodGVtcGxhdGUsIHRlbXBsYXRlRG9jdW1lbnQpIHsKCSAgICAvLyBTa2lwIHJld3JpdGluZyBpZiByZXF1ZXN0ZWQKCSAgICBpZiAodGhpc1snYWxsb3dUZW1wbGF0ZVJld3JpdGluZyddID09PSBmYWxzZSkKCSAgICAgICAgcmV0dXJuIHRydWU7CgkgICAgcmV0dXJuIHRoaXNbJ21ha2VUZW1wbGF0ZVNvdXJjZSddKHRlbXBsYXRlLCB0ZW1wbGF0ZURvY3VtZW50KVsnZGF0YSddKCJpc1Jld3JpdHRlbiIpOwoJfTsKCglrby50ZW1wbGF0ZUVuZ2luZS5wcm90b3R5cGVbJ3Jld3JpdGVUZW1wbGF0ZSddID0gZnVuY3Rpb24gKHRlbXBsYXRlLCByZXdyaXRlckNhbGxiYWNrLCB0ZW1wbGF0ZURvY3VtZW50KSB7CgkgICAgdmFyIHRlbXBsYXRlU291cmNlID0gdGhpc1snbWFrZVRlbXBsYXRlU291cmNlJ10odGVtcGxhdGUsIHRlbXBsYXRlRG9jdW1lbnQpOwoJICAgIHZhciByZXdyaXR0ZW4gPSByZXdyaXRlckNhbGxiYWNrKHRlbXBsYXRlU291cmNlWyd0ZXh0J10oKSk7CgkgICAgdGVtcGxhdGVTb3VyY2VbJ3RleHQnXShyZXdyaXR0ZW4pOwoJICAgIHRlbXBsYXRlU291cmNlWydkYXRhJ10oImlzUmV3cml0dGVuIiwgdHJ1ZSk7Cgl9OwoKCWtvLmV4cG9ydFN5bWJvbCgndGVtcGxhdGVFbmdpbmUnLCBrby50ZW1wbGF0ZUVuZ2luZSk7CgoJa28udGVtcGxhdGVSZXdyaXRpbmcgPSAoZnVuY3Rpb24gKCkgewoJICAgIHZhciBtZW1vaXplRGF0YUJpbmRpbmdBdHRyaWJ1dGVTeW50YXhSZWdleCA9IC8oPChbYS16XStcZCopKD86XHMrKD8hZGF0YS1iaW5kXHMqPVxzKilbYS16MC05XC1dKyg/Oj0oPzpcIlteXCJdKlwifFwnW15cJ10qXCcpKT8pKlxzKylkYXRhLWJpbmRccyo9XHMqKFsiJ10pKFtcc1xTXSo/KVwzL2dpOwoJICAgIHZhciBtZW1vaXplVmlydHVhbENvbnRhaW5lckJpbmRpbmdTeW50YXhSZWdleCA9IC88IS0tXHMqa29cYlxzKihbXHNcU10qPylccyotLT4vZzsKCgkgICAgZnVuY3Rpb24gdmFsaWRhdGVEYXRhQmluZFZhbHVlc0ZvclJld3JpdGluZyhrZXlWYWx1ZUFycmF5KSB7CgkgICAgICAgIHZhciBhbGxWYWxpZGF0b3JzID0ga28uZXhwcmVzc2lvblJld3JpdGluZy5iaW5kaW5nUmV3cml0ZVZhbGlkYXRvcnM7CgkgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwga2V5VmFsdWVBcnJheS5sZW5ndGg7IGkrKykgewoJICAgICAgICAgICAgdmFyIGtleSA9IGtleVZhbHVlQXJyYXlbaV1bJ2tleSddOwoJICAgICAgICAgICAgaWYgKGFsbFZhbGlkYXRvcnMuaGFzT3duUHJvcGVydHkoa2V5KSkgewoJICAgICAgICAgICAgICAgIHZhciB2YWxpZGF0b3IgPSBhbGxWYWxpZGF0b3JzW2tleV07CgoJICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdmFsaWRhdG9yID09PSAiZnVuY3Rpb24iKSB7CgkgICAgICAgICAgICAgICAgICAgIHZhciBwb3NzaWJsZUVycm9yTWVzc2FnZSA9IHZhbGlkYXRvcihrZXlWYWx1ZUFycmF5W2ldWyd2YWx1ZSddKTsKCSAgICAgICAgICAgICAgICAgICAgaWYgKHBvc3NpYmxlRXJyb3JNZXNzYWdlKQoJICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKHBvc3NpYmxlRXJyb3JNZXNzYWdlKTsKCSAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCF2YWxpZGF0b3IpIHsKCSAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUaGlzIHRlbXBsYXRlIGVuZ2luZSBkb2VzIG5vdCBzdXBwb3J0IHRoZSAnIiArIGtleSArICInIGJpbmRpbmcgd2l0aGluIGl0cyB0ZW1wbGF0ZXMiKTsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICB9CgkgICAgICAgIH0KCSAgICB9CgoJICAgIGZ1bmN0aW9uIGNvbnN0cnVjdE1lbW9pemVkVGFnUmVwbGFjZW1lbnQoZGF0YUJpbmRBdHRyaWJ1dGVWYWx1ZSwgdGFnVG9SZXRhaW4sIG5vZGVOYW1lLCB0ZW1wbGF0ZUVuZ2luZSkgewoJICAgICAgICB2YXIgZGF0YUJpbmRLZXlWYWx1ZUFycmF5ID0ga28uZXhwcmVzc2lvblJld3JpdGluZy5wYXJzZU9iamVjdExpdGVyYWwoZGF0YUJpbmRBdHRyaWJ1dGVWYWx1ZSk7CgkgICAgICAgIHZhbGlkYXRlRGF0YUJpbmRWYWx1ZXNGb3JSZXdyaXRpbmcoZGF0YUJpbmRLZXlWYWx1ZUFycmF5KTsKCSAgICAgICAgdmFyIHJld3JpdHRlbkRhdGFCaW5kQXR0cmlidXRlVmFsdWUgPSBrby5leHByZXNzaW9uUmV3cml0aW5nLnByZVByb2Nlc3NCaW5kaW5ncyhkYXRhQmluZEtleVZhbHVlQXJyYXksIHsndmFsdWVBY2Nlc3NvcnMnOnRydWV9KTsKCgkgICAgICAgIC8vIEZvciBubyBvYnZpb3VzIHJlYXNvbiwgT3BlcmEgZmFpbHMgdG8gZXZhbHVhdGUgcmV3cml0dGVuRGF0YUJpbmRBdHRyaWJ1dGVWYWx1ZSB1bmxlc3MgaXQncyB3cmFwcGVkIGluIGFuIGFkZGl0aW9uYWwKCSAgICAgICAgLy8gYW5vbnltb3VzIGZ1bmN0aW9uLCBldmVuIHRob3VnaCBPcGVyYSdzIGJ1aWx0LWluIGRlYnVnZ2VyIGNhbiBldmFsdWF0ZSBpdCBhbnl3YXkuIE5vIG90aGVyIGJyb3dzZXIgcmVxdWlyZXMgdGhpcwoJICAgICAgICAvLyBleHRyYSBpbmRpcmVjdGlvbi4KCSAgICAgICAgdmFyIGFwcGx5QmluZGluZ3NUb05leHRTaWJsaW5nU2NyaXB0ID0KCSAgICAgICAgICAgICJrby5fX3RyX2FtYnRucyhmdW5jdGlvbigkY29udGV4dCwkZWxlbWVudCl7cmV0dXJuKGZ1bmN0aW9uKCl7cmV0dXJueyAiICsgcmV3cml0dGVuRGF0YUJpbmRBdHRyaWJ1dGVWYWx1ZSArICIgfSB9KSgpfSwnIiArIG5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgKyAiJykiOwoJICAgICAgICByZXR1cm4gdGVtcGxhdGVFbmdpbmVbJ2NyZWF0ZUphdmFTY3JpcHRFdmFsdWF0b3JCbG9jayddKGFwcGx5QmluZGluZ3NUb05leHRTaWJsaW5nU2NyaXB0KSArIHRhZ1RvUmV0YWluOwoJICAgIH0KCgkgICAgcmV0dXJuIHsKCSAgICAgICAgZW5zdXJlVGVtcGxhdGVJc1Jld3JpdHRlbjogZnVuY3Rpb24gKHRlbXBsYXRlLCB0ZW1wbGF0ZUVuZ2luZSwgdGVtcGxhdGVEb2N1bWVudCkgewoJICAgICAgICAgICAgaWYgKCF0ZW1wbGF0ZUVuZ2luZVsnaXNUZW1wbGF0ZVJld3JpdHRlbiddKHRlbXBsYXRlLCB0ZW1wbGF0ZURvY3VtZW50KSkKCSAgICAgICAgICAgICAgICB0ZW1wbGF0ZUVuZ2luZVsncmV3cml0ZVRlbXBsYXRlJ10odGVtcGxhdGUsIGZ1bmN0aW9uIChodG1sU3RyaW5nKSB7CgkgICAgICAgICAgICAgICAgICAgIHJldHVybiBrby50ZW1wbGF0ZVJld3JpdGluZy5tZW1vaXplQmluZGluZ0F0dHJpYnV0ZVN5bnRheChodG1sU3RyaW5nLCB0ZW1wbGF0ZUVuZ2luZSk7CgkgICAgICAgICAgICAgICAgfSwgdGVtcGxhdGVEb2N1bWVudCk7CgkgICAgICAgIH0sCgoJICAgICAgICBtZW1vaXplQmluZGluZ0F0dHJpYnV0ZVN5bnRheDogZnVuY3Rpb24gKGh0bWxTdHJpbmcsIHRlbXBsYXRlRW5naW5lKSB7CgkgICAgICAgICAgICByZXR1cm4gaHRtbFN0cmluZy5yZXBsYWNlKG1lbW9pemVEYXRhQmluZGluZ0F0dHJpYnV0ZVN5bnRheFJlZ2V4LCBmdW5jdGlvbiAoKSB7CgkgICAgICAgICAgICAgICAgcmV0dXJuIGNvbnN0cnVjdE1lbW9pemVkVGFnUmVwbGFjZW1lbnQoLyogZGF0YUJpbmRBdHRyaWJ1dGVWYWx1ZTogKi8gYXJndW1lbnRzWzRdLCAvKiB0YWdUb1JldGFpbjogKi8gYXJndW1lbnRzWzFdLCAvKiBub2RlTmFtZTogKi8gYXJndW1lbnRzWzJdLCB0ZW1wbGF0ZUVuZ2luZSk7CgkgICAgICAgICAgICB9KS5yZXBsYWNlKG1lbW9pemVWaXJ0dWFsQ29udGFpbmVyQmluZGluZ1N5bnRheFJlZ2V4LCBmdW5jdGlvbigpIHsKCSAgICAgICAgICAgICAgICByZXR1cm4gY29uc3RydWN0TWVtb2l6ZWRUYWdSZXBsYWNlbWVudCgvKiBkYXRhQmluZEF0dHJpYnV0ZVZhbHVlOiAqLyBhcmd1bWVudHNbMV0sIC8qIHRhZ1RvUmV0YWluOiAqLyAiPCEtLSBrbyAtLT4iLCAvKiBub2RlTmFtZTogKi8gIiNjb21tZW50IiwgdGVtcGxhdGVFbmdpbmUpOwoJICAgICAgICAgICAgfSk7CgkgICAgICAgIH0sCgoJICAgICAgICBhcHBseU1lbW9pemVkQmluZGluZ3NUb05leHRTaWJsaW5nOiBmdW5jdGlvbiAoYmluZGluZ3MsIG5vZGVOYW1lKSB7CgkgICAgICAgICAgICByZXR1cm4ga28ubWVtb2l6YXRpb24ubWVtb2l6ZShmdW5jdGlvbiAoZG9tTm9kZSwgYmluZGluZ0NvbnRleHQpIHsKCSAgICAgICAgICAgICAgICB2YXIgbm9kZVRvQmluZCA9IGRvbU5vZGUubmV4dFNpYmxpbmc7CgkgICAgICAgICAgICAgICAgaWYgKG5vZGVUb0JpbmQgJiYgbm9kZVRvQmluZC5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpID09PSBub2RlTmFtZSkgewoJICAgICAgICAgICAgICAgICAgICBrby5hcHBseUJpbmRpbmdBY2Nlc3NvcnNUb05vZGUobm9kZVRvQmluZCwgYmluZGluZ3MsIGJpbmRpbmdDb250ZXh0KTsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICB9KTsKCSAgICAgICAgfQoJICAgIH0KCX0pKCk7CgoKCS8vIEV4cG9ydGVkIG9ubHkgYmVjYXVzZSBpdCBoYXMgdG8gYmUgcmVmZXJlbmNlZCBieSBzdHJpbmcgbG9va3VwIGZyb20gd2l0aGluIHJld3JpdHRlbiB0ZW1wbGF0ZQoJa28uZXhwb3J0U3ltYm9sKCdfX3RyX2FtYnRucycsIGtvLnRlbXBsYXRlUmV3cml0aW5nLmFwcGx5TWVtb2l6ZWRCaW5kaW5nc1RvTmV4dFNpYmxpbmcpOwoJKGZ1bmN0aW9uKCkgewoJICAgIC8vIEEgdGVtcGxhdGUgc291cmNlIHJlcHJlc2VudHMgYSByZWFkL3dyaXRlIHdheSBvZiBhY2Nlc3NpbmcgYSB0ZW1wbGF0ZS4gVGhpcyBpcyB0byBlbGltaW5hdGUgdGhlIG5lZWQgZm9yIHRlbXBsYXRlIGxvYWRpbmcvc2F2aW5nCgkgICAgLy8gbG9naWMgdG8gYmUgZHVwbGljYXRlZCBpbiBldmVyeSB0ZW1wbGF0ZSBlbmdpbmUgKGFuZCBtZWFucyB0aGV5IGNhbiBhbGwgd29yayB3aXRoIGFub255bW91cyB0ZW1wbGF0ZXMsIGV0Yy4pCgkgICAgLy8KCSAgICAvLyBUd28gYXJlIHByb3ZpZGVkIGJ5IGRlZmF1bHQ6CgkgICAgLy8gIDEuIGtvLnRlbXBsYXRlU291cmNlcy5kb21FbGVtZW50ICAgICAgIC0gcmVhZHMvd3JpdGVzIHRoZSB0ZXh0IGNvbnRlbnQgb2YgYW4gYXJiaXRyYXJ5IERPTSBlbGVtZW50CgkgICAgLy8gIDIuIGtvLnRlbXBsYXRlU291cmNlcy5hbm9ueW1vdXNFbGVtZW50IC0gdXNlcyBrby51dGlscy5kb21EYXRhIHRvIHJlYWQvd3JpdGUgdGV4dCAqYXNzb2NpYXRlZCogd2l0aCB0aGUgRE9NIGVsZW1lbnQsIGJ1dAoJICAgIC8vICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpdGhvdXQgcmVhZGluZy93cml0aW5nIHRoZSBhY3R1YWwgZWxlbWVudCB0ZXh0IGNvbnRlbnQsIHNpbmNlIGl0IHdpbGwgYmUgb3ZlcndyaXR0ZW4KCSAgICAvLyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aXRoIHRoZSByZW5kZXJlZCB0ZW1wbGF0ZSBvdXRwdXQuCgkgICAgLy8gWW91IGNhbiBpbXBsZW1lbnQgeW91ciBvd24gdGVtcGxhdGUgc291cmNlIGlmIHlvdSB3YW50IHRvIGZldGNoL3N0b3JlIHRlbXBsYXRlcyBzb21ld2hlcmUgb3RoZXIgdGhhbiBpbiBET00gZWxlbWVudHMuCgkgICAgLy8gVGVtcGxhdGUgc291cmNlcyBuZWVkIHRvIGhhdmUgdGhlIGZvbGxvd2luZyBmdW5jdGlvbnM6CgkgICAgLy8gICB0ZXh0KCkgCQkJLSByZXR1cm5zIHRoZSB0ZW1wbGF0ZSB0ZXh0IGZyb20geW91ciBzdG9yYWdlIGxvY2F0aW9uCgkgICAgLy8gICB0ZXh0KHZhbHVlKQkJLSB3cml0ZXMgdGhlIHN1cHBsaWVkIHRlbXBsYXRlIHRleHQgdG8geW91ciBzdG9yYWdlIGxvY2F0aW9uCgkgICAgLy8gICBkYXRhKGtleSkJCQktIHJlYWRzIHZhbHVlcyBzdG9yZWQgdXNpbmcgZGF0YShrZXksIHZhbHVlKSAtIHNlZSBiZWxvdwoJICAgIC8vICAgZGF0YShrZXksIHZhbHVlKQktIGFzc29jaWF0ZXMgInZhbHVlIiB3aXRoIHRoaXMgdGVtcGxhdGUgYW5kIHRoZSBrZXkgImtleSIuIElzIHVzZWQgdG8gc3RvcmUgaW5mb3JtYXRpb24gbGlrZSAiaXNSZXdyaXR0ZW4iLgoJICAgIC8vCgkgICAgLy8gT3B0aW9uYWxseSwgdGVtcGxhdGUgc291cmNlcyBjYW4gYWxzbyBoYXZlIHRoZSBmb2xsb3dpbmcgZnVuY3Rpb25zOgoJICAgIC8vICAgbm9kZXMoKSAgICAgICAgICAgIC0gcmV0dXJucyBhIERPTSBlbGVtZW50IGNvbnRhaW5pbmcgdGhlIG5vZGVzIG9mIHRoaXMgdGVtcGxhdGUsIHdoZXJlIGF2YWlsYWJsZQoJICAgIC8vICAgbm9kZXModmFsdWUpICAgICAgIC0gd3JpdGVzIHRoZSBnaXZlbiBET00gZWxlbWVudCB0byB5b3VyIHN0b3JhZ2UgbG9jYXRpb24KCSAgICAvLyBJZiBhIERPTSBlbGVtZW50IGlzIGF2YWlsYWJsZSBmb3IgYSBnaXZlbiB0ZW1wbGF0ZSBzb3VyY2UsIHRlbXBsYXRlIGVuZ2luZXMgYXJlIGVuY291cmFnZWQgdG8gdXNlIGl0IGluIHByZWZlcmVuY2Ugb3ZlciB0ZXh0KCkKCSAgICAvLyBmb3IgaW1wcm92ZWQgc3BlZWQuIEhvd2V2ZXIsIGFsbCB0ZW1wbGF0ZVNvdXJjZXMgbXVzdCBzdXBwbHkgdGV4dCgpIGV2ZW4gaWYgdGhleSBkb24ndCBzdXBwbHkgbm9kZXMoKS4KCSAgICAvLwoJICAgIC8vIE9uY2UgeW91J3ZlIGltcGxlbWVudGVkIGEgdGVtcGxhdGVTb3VyY2UsIG1ha2UgeW91ciB0ZW1wbGF0ZSBlbmdpbmUgdXNlIGl0IGJ5IHN1YmNsYXNzaW5nIHdoYXRldmVyIHRlbXBsYXRlIGVuZ2luZSB5b3Ugd2VyZQoJICAgIC8vIHVzaW5nIGFuZCBvdmVycmlkaW5nICJtYWtlVGVtcGxhdGVTb3VyY2UiIHRvIHJldHVybiBhbiBpbnN0YW5jZSBvZiB5b3VyIGN1c3RvbSB0ZW1wbGF0ZSBzb3VyY2UuCgoJICAgIGtvLnRlbXBsYXRlU291cmNlcyA9IHt9OwoKCSAgICAvLyAtLS0tIGtvLnRlbXBsYXRlU291cmNlcy5kb21FbGVtZW50IC0tLS0tCgoJICAgIGtvLnRlbXBsYXRlU291cmNlcy5kb21FbGVtZW50ID0gZnVuY3Rpb24oZWxlbWVudCkgewoJICAgICAgICB0aGlzLmRvbUVsZW1lbnQgPSBlbGVtZW50OwoJICAgIH0KCgkgICAga28udGVtcGxhdGVTb3VyY2VzLmRvbUVsZW1lbnQucHJvdG90eXBlWyd0ZXh0J10gPSBmdW5jdGlvbigvKiB2YWx1ZVRvV3JpdGUgKi8pIHsKCSAgICAgICAgdmFyIHRhZ05hbWVMb3dlciA9IGtvLnV0aWxzLnRhZ05hbWVMb3dlcih0aGlzLmRvbUVsZW1lbnQpLAoJICAgICAgICAgICAgZWxlbUNvbnRlbnRzUHJvcGVydHkgPSB0YWdOYW1lTG93ZXIgPT09ICJzY3JpcHQiID8gInRleHQiCgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA6IHRhZ05hbWVMb3dlciA9PT0gInRleHRhcmVhIiA/ICJ2YWx1ZSIKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogImlubmVySFRNTCI7CgoJICAgICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PSAwKSB7CgkgICAgICAgICAgICByZXR1cm4gdGhpcy5kb21FbGVtZW50W2VsZW1Db250ZW50c1Byb3BlcnR5XTsKCSAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgIHZhciB2YWx1ZVRvV3JpdGUgPSBhcmd1bWVudHNbMF07CgkgICAgICAgICAgICBpZiAoZWxlbUNvbnRlbnRzUHJvcGVydHkgPT09ICJpbm5lckhUTUwiKQoJICAgICAgICAgICAgICAgIGtvLnV0aWxzLnNldEh0bWwodGhpcy5kb21FbGVtZW50LCB2YWx1ZVRvV3JpdGUpOwoJICAgICAgICAgICAgZWxzZQoJICAgICAgICAgICAgICAgIHRoaXMuZG9tRWxlbWVudFtlbGVtQ29udGVudHNQcm9wZXJ0eV0gPSB2YWx1ZVRvV3JpdGU7CgkgICAgICAgIH0KCSAgICB9OwoKCSAgICB2YXIgZGF0YURvbURhdGFQcmVmaXggPSBrby51dGlscy5kb21EYXRhLm5leHRLZXkoKSArICJfIjsKCSAgICBrby50ZW1wbGF0ZVNvdXJjZXMuZG9tRWxlbWVudC5wcm90b3R5cGVbJ2RhdGEnXSA9IGZ1bmN0aW9uKGtleSAvKiwgdmFsdWVUb1dyaXRlICovKSB7CgkgICAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAxKSB7CgkgICAgICAgICAgICByZXR1cm4ga28udXRpbHMuZG9tRGF0YS5nZXQodGhpcy5kb21FbGVtZW50LCBkYXRhRG9tRGF0YVByZWZpeCArIGtleSk7CgkgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICBrby51dGlscy5kb21EYXRhLnNldCh0aGlzLmRvbUVsZW1lbnQsIGRhdGFEb21EYXRhUHJlZml4ICsga2V5LCBhcmd1bWVudHNbMV0pOwoJICAgICAgICB9CgkgICAgfTsKCgkgICAgLy8gLS0tLSBrby50ZW1wbGF0ZVNvdXJjZXMuYW5vbnltb3VzVGVtcGxhdGUgLS0tLS0KCSAgICAvLyBBbm9ueW1vdXMgdGVtcGxhdGVzIGFyZSBub3JtYWxseSBzYXZlZC9yZXRyaWV2ZWQgYXMgRE9NIG5vZGVzIHRocm91Z2ggIm5vZGVzIi4KCSAgICAvLyBGb3IgY29tcGF0aWJpbGl0eSwgeW91IGNhbiBhbHNvIHJlYWQgInRleHQiOyBpdCB3aWxsIGJlIHNlcmlhbGl6ZWQgZnJvbSB0aGUgbm9kZXMgb24gZGVtYW5kLgoJICAgIC8vIFdyaXRpbmcgdG8gInRleHQiIGlzIHN0aWxsIHN1cHBvcnRlZCwgYnV0IHRoZW4gdGhlIHRlbXBsYXRlIGRhdGEgd2lsbCBub3QgYmUgYXZhaWxhYmxlIGFzIERPTSBub2Rlcy4KCgkgICAgdmFyIGFub255bW91c1RlbXBsYXRlc0RvbURhdGFLZXkgPSBrby51dGlscy5kb21EYXRhLm5leHRLZXkoKTsKCSAgICBrby50ZW1wbGF0ZVNvdXJjZXMuYW5vbnltb3VzVGVtcGxhdGUgPSBmdW5jdGlvbihlbGVtZW50KSB7CgkgICAgICAgIHRoaXMuZG9tRWxlbWVudCA9IGVsZW1lbnQ7CgkgICAgfQoJICAgIGtvLnRlbXBsYXRlU291cmNlcy5hbm9ueW1vdXNUZW1wbGF0ZS5wcm90b3R5cGUgPSBuZXcga28udGVtcGxhdGVTb3VyY2VzLmRvbUVsZW1lbnQoKTsKCSAgICBrby50ZW1wbGF0ZVNvdXJjZXMuYW5vbnltb3VzVGVtcGxhdGUucHJvdG90eXBlLmNvbnN0cnVjdG9yID0ga28udGVtcGxhdGVTb3VyY2VzLmFub255bW91c1RlbXBsYXRlOwoJICAgIGtvLnRlbXBsYXRlU291cmNlcy5hbm9ueW1vdXNUZW1wbGF0ZS5wcm90b3R5cGVbJ3RleHQnXSA9IGZ1bmN0aW9uKC8qIHZhbHVlVG9Xcml0ZSAqLykgewoJICAgICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PSAwKSB7CgkgICAgICAgICAgICB2YXIgdGVtcGxhdGVEYXRhID0ga28udXRpbHMuZG9tRGF0YS5nZXQodGhpcy5kb21FbGVtZW50LCBhbm9ueW1vdXNUZW1wbGF0ZXNEb21EYXRhS2V5KSB8fCB7fTsKCSAgICAgICAgICAgIGlmICh0ZW1wbGF0ZURhdGEudGV4dERhdGEgPT09IHVuZGVmaW5lZCAmJiB0ZW1wbGF0ZURhdGEuY29udGFpbmVyRGF0YSkKCSAgICAgICAgICAgICAgICB0ZW1wbGF0ZURhdGEudGV4dERhdGEgPSB0ZW1wbGF0ZURhdGEuY29udGFpbmVyRGF0YS5pbm5lckhUTUw7CgkgICAgICAgICAgICByZXR1cm4gdGVtcGxhdGVEYXRhLnRleHREYXRhOwoJICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgdmFyIHZhbHVlVG9Xcml0ZSA9IGFyZ3VtZW50c1swXTsKCSAgICAgICAgICAgIGtvLnV0aWxzLmRvbURhdGEuc2V0KHRoaXMuZG9tRWxlbWVudCwgYW5vbnltb3VzVGVtcGxhdGVzRG9tRGF0YUtleSwge3RleHREYXRhOiB2YWx1ZVRvV3JpdGV9KTsKCSAgICAgICAgfQoJICAgIH07CgkgICAga28udGVtcGxhdGVTb3VyY2VzLmRvbUVsZW1lbnQucHJvdG90eXBlWydub2RlcyddID0gZnVuY3Rpb24oLyogdmFsdWVUb1dyaXRlICovKSB7CgkgICAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09IDApIHsKCSAgICAgICAgICAgIHZhciB0ZW1wbGF0ZURhdGEgPSBrby51dGlscy5kb21EYXRhLmdldCh0aGlzLmRvbUVsZW1lbnQsIGFub255bW91c1RlbXBsYXRlc0RvbURhdGFLZXkpIHx8IHt9OwoJICAgICAgICAgICAgcmV0dXJuIHRlbXBsYXRlRGF0YS5jb250YWluZXJEYXRhOwoJICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgdmFyIHZhbHVlVG9Xcml0ZSA9IGFyZ3VtZW50c1swXTsKCSAgICAgICAgICAgIGtvLnV0aWxzLmRvbURhdGEuc2V0KHRoaXMuZG9tRWxlbWVudCwgYW5vbnltb3VzVGVtcGxhdGVzRG9tRGF0YUtleSwge2NvbnRhaW5lckRhdGE6IHZhbHVlVG9Xcml0ZX0pOwoJICAgICAgICB9CgkgICAgfTsKCgkgICAga28uZXhwb3J0U3ltYm9sKCd0ZW1wbGF0ZVNvdXJjZXMnLCBrby50ZW1wbGF0ZVNvdXJjZXMpOwoJICAgIGtvLmV4cG9ydFN5bWJvbCgndGVtcGxhdGVTb3VyY2VzLmRvbUVsZW1lbnQnLCBrby50ZW1wbGF0ZVNvdXJjZXMuZG9tRWxlbWVudCk7CgkgICAga28uZXhwb3J0U3ltYm9sKCd0ZW1wbGF0ZVNvdXJjZXMuYW5vbnltb3VzVGVtcGxhdGUnLCBrby50ZW1wbGF0ZVNvdXJjZXMuYW5vbnltb3VzVGVtcGxhdGUpOwoJfSkoKTsKCShmdW5jdGlvbiAoKSB7CgkgICAgdmFyIF90ZW1wbGF0ZUVuZ2luZTsKCSAgICBrby5zZXRUZW1wbGF0ZUVuZ2luZSA9IGZ1bmN0aW9uICh0ZW1wbGF0ZUVuZ2luZSkgewoJICAgICAgICBpZiAoKHRlbXBsYXRlRW5naW5lICE9IHVuZGVmaW5lZCkgJiYgISh0ZW1wbGF0ZUVuZ2luZSBpbnN0YW5jZW9mIGtvLnRlbXBsYXRlRW5naW5lKSkKCSAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigidGVtcGxhdGVFbmdpbmUgbXVzdCBpbmhlcml0IGZyb20ga28udGVtcGxhdGVFbmdpbmUiKTsKCSAgICAgICAgX3RlbXBsYXRlRW5naW5lID0gdGVtcGxhdGVFbmdpbmU7CgkgICAgfQoKCSAgICBmdW5jdGlvbiBpbnZva2VGb3JFYWNoTm9kZUluQ29udGludW91c1JhbmdlKGZpcnN0Tm9kZSwgbGFzdE5vZGUsIGFjdGlvbikgewoJICAgICAgICB2YXIgbm9kZSwgbmV4dEluUXVldWUgPSBmaXJzdE5vZGUsIGZpcnN0T3V0T2ZSYW5nZU5vZGUgPSBrby52aXJ0dWFsRWxlbWVudHMubmV4dFNpYmxpbmcobGFzdE5vZGUpOwoJICAgICAgICB3aGlsZSAobmV4dEluUXVldWUgJiYgKChub2RlID0gbmV4dEluUXVldWUpICE9PSBmaXJzdE91dE9mUmFuZ2VOb2RlKSkgewoJICAgICAgICAgICAgbmV4dEluUXVldWUgPSBrby52aXJ0dWFsRWxlbWVudHMubmV4dFNpYmxpbmcobm9kZSk7CgkgICAgICAgICAgICBhY3Rpb24obm9kZSwgbmV4dEluUXVldWUpOwoJICAgICAgICB9CgkgICAgfQoKCSAgICBmdW5jdGlvbiBhY3RpdmF0ZUJpbmRpbmdzT25Db250aW51b3VzTm9kZUFycmF5KGNvbnRpbnVvdXNOb2RlQXJyYXksIGJpbmRpbmdDb250ZXh0KSB7CgkgICAgICAgIC8vIFRvIGJlIHVzZWQgb24gYW55IG5vZGVzIHRoYXQgaGF2ZSBiZWVuIHJlbmRlcmVkIGJ5IGEgdGVtcGxhdGUgYW5kIGhhdmUgYmVlbiBpbnNlcnRlZCBpbnRvIHNvbWUgcGFyZW50IGVsZW1lbnQKCSAgICAgICAgLy8gV2Fsa3MgdGhyb3VnaCBjb250aW51b3VzTm9kZUFycmF5ICh3aGljaCAqbXVzdCogYmUgY29udGludW91cywgaS5lLiwgYW4gdW5pbnRlcnJ1cHRlZCBzZXF1ZW5jZSBvZiBzaWJsaW5nIG5vZGVzLCBiZWNhdXNlCgkgICAgICAgIC8vIHRoZSBhbGdvcml0aG0gZm9yIHdhbGtpbmcgdGhlbSByZWxpZXMgb24gdGhpcyksIGFuZCBmb3IgZWFjaCB0b3AtbGV2ZWwgaXRlbSBpbiB0aGUgdmlydHVhbC1lbGVtZW50IHNlbnNlLAoJICAgICAgICAvLyAoMSkgRG9lcyBhIHJlZ3VsYXIgImFwcGx5QmluZGluZ3MiIHRvIGFzc29jaWF0ZSBiaW5kaW5nQ29udGV4dCB3aXRoIHRoaXMgbm9kZSBhbmQgdG8gYWN0aXZhdGUgYW55IG5vbi1tZW1vaXplZCBiaW5kaW5ncwoJICAgICAgICAvLyAoMikgVW5tZW1vaXplcyBhbnkgbWVtb3MgaW4gdGhlIERPTSBzdWJ0cmVlIChlLmcuLCB0byBhY3RpdmF0ZSBiaW5kaW5ncyB0aGF0IGhhZCBiZWVuIG1lbW9pemVkIGR1cmluZyB0ZW1wbGF0ZSByZXdyaXRpbmcpCgoJICAgICAgICBpZiAoY29udGludW91c05vZGVBcnJheS5sZW5ndGgpIHsKCSAgICAgICAgICAgIHZhciBmaXJzdE5vZGUgPSBjb250aW51b3VzTm9kZUFycmF5WzBdLAoJICAgICAgICAgICAgICAgIGxhc3ROb2RlID0gY29udGludW91c05vZGVBcnJheVtjb250aW51b3VzTm9kZUFycmF5Lmxlbmd0aCAtIDFdLAoJICAgICAgICAgICAgICAgIHBhcmVudE5vZGUgPSBmaXJzdE5vZGUucGFyZW50Tm9kZSwKCSAgICAgICAgICAgICAgICBwcm92aWRlciA9IGtvLmJpbmRpbmdQcm92aWRlclsnaW5zdGFuY2UnXSwKCSAgICAgICAgICAgICAgICBwcmVwcm9jZXNzTm9kZSA9IHByb3ZpZGVyWydwcmVwcm9jZXNzTm9kZSddOwoKCSAgICAgICAgICAgIGlmIChwcmVwcm9jZXNzTm9kZSkgewoJICAgICAgICAgICAgICAgIGludm9rZUZvckVhY2hOb2RlSW5Db250aW51b3VzUmFuZ2UoZmlyc3ROb2RlLCBsYXN0Tm9kZSwgZnVuY3Rpb24obm9kZSwgbmV4dE5vZGVJblJhbmdlKSB7CgkgICAgICAgICAgICAgICAgICAgIHZhciBub2RlUHJldmlvdXNTaWJsaW5nID0gbm9kZS5wcmV2aW91c1NpYmxpbmc7CgkgICAgICAgICAgICAgICAgICAgIHZhciBuZXdOb2RlcyA9IHByZXByb2Nlc3NOb2RlLmNhbGwocHJvdmlkZXIsIG5vZGUpOwoJICAgICAgICAgICAgICAgICAgICBpZiAobmV3Tm9kZXMpIHsKCSAgICAgICAgICAgICAgICAgICAgICAgIGlmIChub2RlID09PSBmaXJzdE5vZGUpCgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlyc3ROb2RlID0gbmV3Tm9kZXNbMF0gfHwgbmV4dE5vZGVJblJhbmdlOwoJICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5vZGUgPT09IGxhc3ROb2RlKQoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhc3ROb2RlID0gbmV3Tm9kZXNbbmV3Tm9kZXMubGVuZ3RoIC0gMV0gfHwgbm9kZVByZXZpb3VzU2libGluZzsKCSAgICAgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgIH0pOwoKCSAgICAgICAgICAgICAgICAvLyBCZWNhdXNlIHByZXByb2Nlc3NOb2RlIGNhbiBjaGFuZ2UgdGhlIG5vZGVzLCBpbmNsdWRpbmcgdGhlIGZpcnN0IGFuZCBsYXN0IG5vZGVzLCB1cGRhdGUgY29udGludW91c05vZGVBcnJheSB0byBtYXRjaC4KCSAgICAgICAgICAgICAgICAvLyBXZSBuZWVkIHRoZSBmdWxsIHNldCwgaW5jbHVkaW5nIGlubmVyIG5vZGVzLCBiZWNhdXNlIHRoZSB1bm1lbW9pemUgc3RlcCBtaWdodCByZW1vdmUgdGhlIGZpcnN0IG5vZGUgKGFuZCBzbyB0aGUgcmVhbAoJICAgICAgICAgICAgICAgIC8vIGZpcnN0IG5vZGUgbmVlZHMgdG8gYmUgaW4gdGhlIGFycmF5KS4KCSAgICAgICAgICAgICAgICBjb250aW51b3VzTm9kZUFycmF5Lmxlbmd0aCA9IDA7CgkgICAgICAgICAgICAgICAgaWYgKCFmaXJzdE5vZGUpIHsgLy8gcHJlcHJvY2Vzc05vZGUgbWlnaHQgaGF2ZSByZW1vdmVkIGFsbCB0aGUgbm9kZXMsIGluIHdoaWNoIGNhc2UgdGhlcmUncyBub3RoaW5nIGxlZnQgdG8gZG8KCSAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICBpZiAoZmlyc3ROb2RlID09PSBsYXN0Tm9kZSkgewoJICAgICAgICAgICAgICAgICAgICBjb250aW51b3VzTm9kZUFycmF5LnB1c2goZmlyc3ROb2RlKTsKCSAgICAgICAgICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgICAgICAgICBjb250aW51b3VzTm9kZUFycmF5LnB1c2goZmlyc3ROb2RlLCBsYXN0Tm9kZSk7CgkgICAgICAgICAgICAgICAgICAgIGtvLnV0aWxzLmZpeFVwQ29udGludW91c05vZGVBcnJheShjb250aW51b3VzTm9kZUFycmF5LCBwYXJlbnROb2RlKTsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICB9CgoJICAgICAgICAgICAgLy8gTmVlZCB0byBhcHBseUJpbmRpbmdzICpiZWZvcmUqIHVubWVtb3ppYXRpb24sIGJlY2F1c2UgdW5tZW1vaXphdGlvbiBtaWdodCBpbnRyb2R1Y2UgZXh0cmEgbm9kZXMgKHRoYXQgd2UgZG9uJ3Qgd2FudCB0byByZS1iaW5kKQoJICAgICAgICAgICAgLy8gd2hlcmVhcyBhIHJlZ3VsYXIgYXBwbHlCaW5kaW5ncyB3b24ndCBpbnRyb2R1Y2UgbmV3IG1lbW9pemVkIG5vZGVzCgkgICAgICAgICAgICBpbnZva2VGb3JFYWNoTm9kZUluQ29udGludW91c1JhbmdlKGZpcnN0Tm9kZSwgbGFzdE5vZGUsIGZ1bmN0aW9uKG5vZGUpIHsKCSAgICAgICAgICAgICAgICBpZiAobm9kZS5ub2RlVHlwZSA9PT0gMSB8fCBub2RlLm5vZGVUeXBlID09PSA4KQoJICAgICAgICAgICAgICAgICAgICBrby5hcHBseUJpbmRpbmdzKGJpbmRpbmdDb250ZXh0LCBub2RlKTsKCSAgICAgICAgICAgIH0pOwoJICAgICAgICAgICAgaW52b2tlRm9yRWFjaE5vZGVJbkNvbnRpbnVvdXNSYW5nZShmaXJzdE5vZGUsIGxhc3ROb2RlLCBmdW5jdGlvbihub2RlKSB7CgkgICAgICAgICAgICAgICAgaWYgKG5vZGUubm9kZVR5cGUgPT09IDEgfHwgbm9kZS5ub2RlVHlwZSA9PT0gOCkKCSAgICAgICAgICAgICAgICAgICAga28ubWVtb2l6YXRpb24udW5tZW1vaXplRG9tTm9kZUFuZERlc2NlbmRhbnRzKG5vZGUsIFtiaW5kaW5nQ29udGV4dF0pOwoJICAgICAgICAgICAgfSk7CgoJICAgICAgICAgICAgLy8gTWFrZSBzdXJlIGFueSBjaGFuZ2VzIGRvbmUgYnkgYXBwbHlCaW5kaW5ncyBvciB1bm1lbW9pemUgYXJlIHJlZmxlY3RlZCBpbiB0aGUgYXJyYXkKCSAgICAgICAgICAgIGtvLnV0aWxzLmZpeFVwQ29udGludW91c05vZGVBcnJheShjb250aW51b3VzTm9kZUFycmF5LCBwYXJlbnROb2RlKTsKCSAgICAgICAgfQoJICAgIH0KCgkgICAgZnVuY3Rpb24gZ2V0Rmlyc3ROb2RlRnJvbVBvc3NpYmxlQXJyYXkobm9kZU9yTm9kZUFycmF5KSB7CgkgICAgICAgIHJldHVybiBub2RlT3JOb2RlQXJyYXkubm9kZVR5cGUgPyBub2RlT3JOb2RlQXJyYXkKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA6IG5vZGVPck5vZGVBcnJheS5sZW5ndGggPiAwID8gbm9kZU9yTm9kZUFycmF5WzBdCgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgOiBudWxsOwoJICAgIH0KCgkgICAgZnVuY3Rpb24gZXhlY3V0ZVRlbXBsYXRlKHRhcmdldE5vZGVPck5vZGVBcnJheSwgcmVuZGVyTW9kZSwgdGVtcGxhdGUsIGJpbmRpbmdDb250ZXh0LCBvcHRpb25zKSB7CgkgICAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoJICAgICAgICB2YXIgZmlyc3RUYXJnZXROb2RlID0gdGFyZ2V0Tm9kZU9yTm9kZUFycmF5ICYmIGdldEZpcnN0Tm9kZUZyb21Qb3NzaWJsZUFycmF5KHRhcmdldE5vZGVPck5vZGVBcnJheSk7CgkgICAgICAgIHZhciB0ZW1wbGF0ZURvY3VtZW50ID0gZmlyc3RUYXJnZXROb2RlICYmIGZpcnN0VGFyZ2V0Tm9kZS5vd25lckRvY3VtZW50OwoJICAgICAgICB2YXIgdGVtcGxhdGVFbmdpbmVUb1VzZSA9IChvcHRpb25zWyd0ZW1wbGF0ZUVuZ2luZSddIHx8IF90ZW1wbGF0ZUVuZ2luZSk7CgkgICAgICAgIGtvLnRlbXBsYXRlUmV3cml0aW5nLmVuc3VyZVRlbXBsYXRlSXNSZXdyaXR0ZW4odGVtcGxhdGUsIHRlbXBsYXRlRW5naW5lVG9Vc2UsIHRlbXBsYXRlRG9jdW1lbnQpOwoJICAgICAgICB2YXIgcmVuZGVyZWROb2Rlc0FycmF5ID0gdGVtcGxhdGVFbmdpbmVUb1VzZVsncmVuZGVyVGVtcGxhdGUnXSh0ZW1wbGF0ZSwgYmluZGluZ0NvbnRleHQsIG9wdGlvbnMsIHRlbXBsYXRlRG9jdW1lbnQpOwoKCSAgICAgICAgLy8gTG9vc2VseSBjaGVjayByZXN1bHQgaXMgYW4gYXJyYXkgb2YgRE9NIG5vZGVzCgkgICAgICAgIGlmICgodHlwZW9mIHJlbmRlcmVkTm9kZXNBcnJheS5sZW5ndGggIT0gIm51bWJlciIpIHx8IChyZW5kZXJlZE5vZGVzQXJyYXkubGVuZ3RoID4gMCAmJiB0eXBlb2YgcmVuZGVyZWROb2Rlc0FycmF5WzBdLm5vZGVUeXBlICE9ICJudW1iZXIiKSkKCSAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVGVtcGxhdGUgZW5naW5lIG11c3QgcmV0dXJuIGFuIGFycmF5IG9mIERPTSBub2RlcyIpOwoKCSAgICAgICAgdmFyIGhhdmVBZGRlZE5vZGVzVG9QYXJlbnQgPSBmYWxzZTsKCSAgICAgICAgc3dpdGNoIChyZW5kZXJNb2RlKSB7CgkgICAgICAgICAgICBjYXNlICJyZXBsYWNlQ2hpbGRyZW4iOgoJICAgICAgICAgICAgICAgIGtvLnZpcnR1YWxFbGVtZW50cy5zZXREb21Ob2RlQ2hpbGRyZW4odGFyZ2V0Tm9kZU9yTm9kZUFycmF5LCByZW5kZXJlZE5vZGVzQXJyYXkpOwoJICAgICAgICAgICAgICAgIGhhdmVBZGRlZE5vZGVzVG9QYXJlbnQgPSB0cnVlOwoJICAgICAgICAgICAgICAgIGJyZWFrOwoJICAgICAgICAgICAgY2FzZSAicmVwbGFjZU5vZGUiOgoJICAgICAgICAgICAgICAgIGtvLnV0aWxzLnJlcGxhY2VEb21Ob2Rlcyh0YXJnZXROb2RlT3JOb2RlQXJyYXksIHJlbmRlcmVkTm9kZXNBcnJheSk7CgkgICAgICAgICAgICAgICAgaGF2ZUFkZGVkTm9kZXNUb1BhcmVudCA9IHRydWU7CgkgICAgICAgICAgICAgICAgYnJlYWs7CgkgICAgICAgICAgICBjYXNlICJpZ25vcmVUYXJnZXROb2RlIjogYnJlYWs7CgkgICAgICAgICAgICBkZWZhdWx0OgoJICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVW5rbm93biByZW5kZXJNb2RlOiAiICsgcmVuZGVyTW9kZSk7CgkgICAgICAgIH0KCgkgICAgICAgIGlmIChoYXZlQWRkZWROb2Rlc1RvUGFyZW50KSB7CgkgICAgICAgICAgICBhY3RpdmF0ZUJpbmRpbmdzT25Db250aW51b3VzTm9kZUFycmF5KHJlbmRlcmVkTm9kZXNBcnJheSwgYmluZGluZ0NvbnRleHQpOwoJICAgICAgICAgICAgaWYgKG9wdGlvbnNbJ2FmdGVyUmVuZGVyJ10pCgkgICAgICAgICAgICAgICAga28uZGVwZW5kZW5jeURldGVjdGlvbi5pZ25vcmUob3B0aW9uc1snYWZ0ZXJSZW5kZXInXSwgbnVsbCwgW3JlbmRlcmVkTm9kZXNBcnJheSwgYmluZGluZ0NvbnRleHRbJyRkYXRhJ11dKTsKCSAgICAgICAgfQoKCSAgICAgICAgcmV0dXJuIHJlbmRlcmVkTm9kZXNBcnJheTsKCSAgICB9CgoJICAgIGZ1bmN0aW9uIHJlc29sdmVUZW1wbGF0ZU5hbWUodGVtcGxhdGUsIGRhdGEsIGNvbnRleHQpIHsKCSAgICAgICAgLy8gVGhlIHRlbXBsYXRlIGNhbiBiZSBzcGVjaWZpZWQgYXM6CgkgICAgICAgIGlmIChrby5pc09ic2VydmFibGUodGVtcGxhdGUpKSB7CgkgICAgICAgICAgICAvLyAxLiBBbiBvYnNlcnZhYmxlLCB3aXRoIHN0cmluZyB2YWx1ZQoJICAgICAgICAgICAgcmV0dXJuIHRlbXBsYXRlKCk7CgkgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHRlbXBsYXRlID09PSAnZnVuY3Rpb24nKSB7CgkgICAgICAgICAgICAvLyAyLiBBIGZ1bmN0aW9uIG9mIChkYXRhLCBjb250ZXh0KSByZXR1cm5pbmcgYSBzdHJpbmcKCSAgICAgICAgICAgIHJldHVybiB0ZW1wbGF0ZShkYXRhLCBjb250ZXh0KTsKCSAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgIC8vIDMuIEEgc3RyaW5nCgkgICAgICAgICAgICByZXR1cm4gdGVtcGxhdGU7CgkgICAgICAgIH0KCSAgICB9CgoJICAgIGtvLnJlbmRlclRlbXBsYXRlID0gZnVuY3Rpb24gKHRlbXBsYXRlLCBkYXRhT3JCaW5kaW5nQ29udGV4dCwgb3B0aW9ucywgdGFyZ2V0Tm9kZU9yTm9kZUFycmF5LCByZW5kZXJNb2RlKSB7CgkgICAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoJICAgICAgICBpZiAoKG9wdGlvbnNbJ3RlbXBsYXRlRW5naW5lJ10gfHwgX3RlbXBsYXRlRW5naW5lKSA9PSB1bmRlZmluZWQpCgkgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlNldCBhIHRlbXBsYXRlIGVuZ2luZSBiZWZvcmUgY2FsbGluZyByZW5kZXJUZW1wbGF0ZSIpOwoJICAgICAgICByZW5kZXJNb2RlID0gcmVuZGVyTW9kZSB8fCAicmVwbGFjZUNoaWxkcmVuIjsKCgkgICAgICAgIGlmICh0YXJnZXROb2RlT3JOb2RlQXJyYXkpIHsKCSAgICAgICAgICAgIHZhciBmaXJzdFRhcmdldE5vZGUgPSBnZXRGaXJzdE5vZGVGcm9tUG9zc2libGVBcnJheSh0YXJnZXROb2RlT3JOb2RlQXJyYXkpOwoKCSAgICAgICAgICAgIHZhciB3aGVuVG9EaXNwb3NlID0gZnVuY3Rpb24gKCkgeyByZXR1cm4gKCFmaXJzdFRhcmdldE5vZGUpIHx8ICFrby51dGlscy5kb21Ob2RlSXNBdHRhY2hlZFRvRG9jdW1lbnQoZmlyc3RUYXJnZXROb2RlKTsgfTsgLy8gUGFzc2l2ZSBkaXNwb3NhbCAob24gbmV4dCBldmFsdWF0aW9uKQoJICAgICAgICAgICAgdmFyIGFjdGl2ZWx5RGlzcG9zZVdoZW5Ob2RlSXNSZW1vdmVkID0gKGZpcnN0VGFyZ2V0Tm9kZSAmJiByZW5kZXJNb2RlID09ICJyZXBsYWNlTm9kZSIpID8gZmlyc3RUYXJnZXROb2RlLnBhcmVudE5vZGUgOiBmaXJzdFRhcmdldE5vZGU7CgoJICAgICAgICAgICAgcmV0dXJuIGtvLmRlcGVuZGVudE9ic2VydmFibGUoIC8vIFNvIHRoZSBET00gaXMgYXV0b21hdGljYWxseSB1cGRhdGVkIHdoZW4gYW55IGRlcGVuZGVuY3kgY2hhbmdlcwoJICAgICAgICAgICAgICAgIGZ1bmN0aW9uICgpIHsKCSAgICAgICAgICAgICAgICAgICAgLy8gRW5zdXJlIHdlJ3ZlIGdvdCBhIHByb3BlciBiaW5kaW5nIGNvbnRleHQgdG8gd29yayB3aXRoCgkgICAgICAgICAgICAgICAgICAgIHZhciBiaW5kaW5nQ29udGV4dCA9IChkYXRhT3JCaW5kaW5nQ29udGV4dCAmJiAoZGF0YU9yQmluZGluZ0NvbnRleHQgaW5zdGFuY2VvZiBrby5iaW5kaW5nQ29udGV4dCkpCgkgICAgICAgICAgICAgICAgICAgICAgICA/IGRhdGFPckJpbmRpbmdDb250ZXh0CgkgICAgICAgICAgICAgICAgICAgICAgICA6IG5ldyBrby5iaW5kaW5nQ29udGV4dChrby51dGlscy51bndyYXBPYnNlcnZhYmxlKGRhdGFPckJpbmRpbmdDb250ZXh0KSk7CgoJICAgICAgICAgICAgICAgICAgICB2YXIgdGVtcGxhdGVOYW1lID0gcmVzb2x2ZVRlbXBsYXRlTmFtZSh0ZW1wbGF0ZSwgYmluZGluZ0NvbnRleHRbJyRkYXRhJ10sIGJpbmRpbmdDb250ZXh0KSwKCSAgICAgICAgICAgICAgICAgICAgICAgIHJlbmRlcmVkTm9kZXNBcnJheSA9IGV4ZWN1dGVUZW1wbGF0ZSh0YXJnZXROb2RlT3JOb2RlQXJyYXksIHJlbmRlck1vZGUsIHRlbXBsYXRlTmFtZSwgYmluZGluZ0NvbnRleHQsIG9wdGlvbnMpOwoKCSAgICAgICAgICAgICAgICAgICAgaWYgKHJlbmRlck1vZGUgPT0gInJlcGxhY2VOb2RlIikgewoJICAgICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0Tm9kZU9yTm9kZUFycmF5ID0gcmVuZGVyZWROb2Rlc0FycmF5OwoJICAgICAgICAgICAgICAgICAgICAgICAgZmlyc3RUYXJnZXROb2RlID0gZ2V0Rmlyc3ROb2RlRnJvbVBvc3NpYmxlQXJyYXkodGFyZ2V0Tm9kZU9yTm9kZUFycmF5KTsKCSAgICAgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgIH0sCgkgICAgICAgICAgICAgICAgbnVsbCwKCSAgICAgICAgICAgICAgICB7IGRpc3Bvc2VXaGVuOiB3aGVuVG9EaXNwb3NlLCBkaXNwb3NlV2hlbk5vZGVJc1JlbW92ZWQ6IGFjdGl2ZWx5RGlzcG9zZVdoZW5Ob2RlSXNSZW1vdmVkIH0KCSAgICAgICAgICAgICk7CgkgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICAvLyBXZSBkb24ndCB5ZXQgaGF2ZSBhIERPTSBub2RlIHRvIGV2YWx1YXRlLCBzbyB1c2UgYSBtZW1vIGFuZCByZW5kZXIgdGhlIHRlbXBsYXRlIGxhdGVyIHdoZW4gdGhlcmUgaXMgYSBET00gbm9kZQoJICAgICAgICAgICAgcmV0dXJuIGtvLm1lbW9pemF0aW9uLm1lbW9pemUoZnVuY3Rpb24gKGRvbU5vZGUpIHsKCSAgICAgICAgICAgICAgICBrby5yZW5kZXJUZW1wbGF0ZSh0ZW1wbGF0ZSwgZGF0YU9yQmluZGluZ0NvbnRleHQsIG9wdGlvbnMsIGRvbU5vZGUsICJyZXBsYWNlTm9kZSIpOwoJICAgICAgICAgICAgfSk7CgkgICAgICAgIH0KCSAgICB9OwoKCSAgICBrby5yZW5kZXJUZW1wbGF0ZUZvckVhY2ggPSBmdW5jdGlvbiAodGVtcGxhdGUsIGFycmF5T3JPYnNlcnZhYmxlQXJyYXksIG9wdGlvbnMsIHRhcmdldE5vZGUsIHBhcmVudEJpbmRpbmdDb250ZXh0KSB7CgkgICAgICAgIC8vIFNpbmNlIHNldERvbU5vZGVDaGlsZHJlbkZyb21BcnJheU1hcHBpbmcgYWx3YXlzIGNhbGxzIGV4ZWN1dGVUZW1wbGF0ZUZvckFycmF5SXRlbSBhbmQgdGhlbgoJICAgICAgICAvLyBhY3RpdmF0ZUJpbmRpbmdzQ2FsbGJhY2sgZm9yIGFkZGVkIGl0ZW1zLCB3ZSBjYW4gc3RvcmUgdGhlIGJpbmRpbmcgY29udGV4dCBpbiB0aGUgZm9ybWVyIHRvIHVzZSBpbiB0aGUgbGF0dGVyLgoJICAgICAgICB2YXIgYXJyYXlJdGVtQ29udGV4dDsKCgkgICAgICAgIC8vIFRoaXMgd2lsbCBiZSBjYWxsZWQgYnkgc2V0RG9tTm9kZUNoaWxkcmVuRnJvbUFycmF5TWFwcGluZyB0byBnZXQgdGhlIG5vZGVzIHRvIGFkZCB0byB0YXJnZXROb2RlCgkgICAgICAgIHZhciBleGVjdXRlVGVtcGxhdGVGb3JBcnJheUl0ZW0gPSBmdW5jdGlvbiAoYXJyYXlWYWx1ZSwgaW5kZXgpIHsKCSAgICAgICAgICAgIC8vIFN1cHBvcnQgc2VsZWN0aW5nIHRlbXBsYXRlIGFzIGEgZnVuY3Rpb24gb2YgdGhlIGRhdGEgYmVpbmcgcmVuZGVyZWQKCSAgICAgICAgICAgIGFycmF5SXRlbUNvbnRleHQgPSBwYXJlbnRCaW5kaW5nQ29udGV4dFsnY3JlYXRlQ2hpbGRDb250ZXh0J10oYXJyYXlWYWx1ZSwgb3B0aW9uc1snYXMnXSwgZnVuY3Rpb24oY29udGV4dCkgewoJICAgICAgICAgICAgICAgIGNvbnRleHRbJyRpbmRleCddID0gaW5kZXg7CgkgICAgICAgICAgICB9KTsKCgkgICAgICAgICAgICB2YXIgdGVtcGxhdGVOYW1lID0gcmVzb2x2ZVRlbXBsYXRlTmFtZSh0ZW1wbGF0ZSwgYXJyYXlWYWx1ZSwgYXJyYXlJdGVtQ29udGV4dCk7CgkgICAgICAgICAgICByZXR1cm4gZXhlY3V0ZVRlbXBsYXRlKG51bGwsICJpZ25vcmVUYXJnZXROb2RlIiwgdGVtcGxhdGVOYW1lLCBhcnJheUl0ZW1Db250ZXh0LCBvcHRpb25zKTsKCSAgICAgICAgfQoKCSAgICAgICAgLy8gVGhpcyB3aWxsIGJlIGNhbGxlZCB3aGVuZXZlciBzZXREb21Ob2RlQ2hpbGRyZW5Gcm9tQXJyYXlNYXBwaW5nIGhhcyBhZGRlZCBub2RlcyB0byB0YXJnZXROb2RlCgkgICAgICAgIHZhciBhY3RpdmF0ZUJpbmRpbmdzQ2FsbGJhY2sgPSBmdW5jdGlvbihhcnJheVZhbHVlLCBhZGRlZE5vZGVzQXJyYXksIGluZGV4KSB7CgkgICAgICAgICAgICBhY3RpdmF0ZUJpbmRpbmdzT25Db250aW51b3VzTm9kZUFycmF5KGFkZGVkTm9kZXNBcnJheSwgYXJyYXlJdGVtQ29udGV4dCk7CgkgICAgICAgICAgICBpZiAob3B0aW9uc1snYWZ0ZXJSZW5kZXInXSkKCSAgICAgICAgICAgICAgICBvcHRpb25zWydhZnRlclJlbmRlciddKGFkZGVkTm9kZXNBcnJheSwgYXJyYXlWYWx1ZSk7CgkgICAgICAgIH07CgoJICAgICAgICByZXR1cm4ga28uZGVwZW5kZW50T2JzZXJ2YWJsZShmdW5jdGlvbiAoKSB7CgkgICAgICAgICAgICB2YXIgdW53cmFwcGVkQXJyYXkgPSBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKGFycmF5T3JPYnNlcnZhYmxlQXJyYXkpIHx8IFtdOwoJICAgICAgICAgICAgaWYgKHR5cGVvZiB1bndyYXBwZWRBcnJheS5sZW5ndGggPT0gInVuZGVmaW5lZCIpIC8vIENvZXJjZSBzaW5nbGUgdmFsdWUgaW50byBhcnJheQoJICAgICAgICAgICAgICAgIHVud3JhcHBlZEFycmF5ID0gW3Vud3JhcHBlZEFycmF5XTsKCgkgICAgICAgICAgICAvLyBGaWx0ZXIgb3V0IGFueSBlbnRyaWVzIG1hcmtlZCBhcyBkZXN0cm95ZWQKCSAgICAgICAgICAgIHZhciBmaWx0ZXJlZEFycmF5ID0ga28udXRpbHMuYXJyYXlGaWx0ZXIodW53cmFwcGVkQXJyYXksIGZ1bmN0aW9uKGl0ZW0pIHsKCSAgICAgICAgICAgICAgICByZXR1cm4gb3B0aW9uc1snaW5jbHVkZURlc3Ryb3llZCddIHx8IGl0ZW0gPT09IHVuZGVmaW5lZCB8fCBpdGVtID09PSBudWxsIHx8ICFrby51dGlscy51bndyYXBPYnNlcnZhYmxlKGl0ZW1bJ19kZXN0cm95J10pOwoJICAgICAgICAgICAgfSk7CgoJICAgICAgICAgICAgLy8gQ2FsbCBzZXREb21Ob2RlQ2hpbGRyZW5Gcm9tQXJyYXlNYXBwaW5nLCBpZ25vcmluZyBhbnkgb2JzZXJ2YWJsZXMgdW53cmFwcGVkIHdpdGhpbiAobW9zdCBsaWtlbHkgZnJvbSBhIGNhbGxiYWNrIGZ1bmN0aW9uKS4KCSAgICAgICAgICAgIC8vIElmIHRoZSBhcnJheSBpdGVtcyBhcmUgb2JzZXJ2YWJsZXMsIHRob3VnaCwgdGhleSB3aWxsIGJlIHVud3JhcHBlZCBpbiBleGVjdXRlVGVtcGxhdGVGb3JBcnJheUl0ZW0gYW5kIG1hbmFnZWQgd2l0aGluIHNldERvbU5vZGVDaGlsZHJlbkZyb21BcnJheU1hcHBpbmcuCgkgICAgICAgICAgICBrby5kZXBlbmRlbmN5RGV0ZWN0aW9uLmlnbm9yZShrby51dGlscy5zZXREb21Ob2RlQ2hpbGRyZW5Gcm9tQXJyYXlNYXBwaW5nLCBudWxsLCBbdGFyZ2V0Tm9kZSwgZmlsdGVyZWRBcnJheSwgZXhlY3V0ZVRlbXBsYXRlRm9yQXJyYXlJdGVtLCBvcHRpb25zLCBhY3RpdmF0ZUJpbmRpbmdzQ2FsbGJhY2tdKTsKCgkgICAgICAgIH0sIG51bGwsIHsgZGlzcG9zZVdoZW5Ob2RlSXNSZW1vdmVkOiB0YXJnZXROb2RlIH0pOwoJICAgIH07CgoJICAgIHZhciB0ZW1wbGF0ZUNvbXB1dGVkRG9tRGF0YUtleSA9IGtvLnV0aWxzLmRvbURhdGEubmV4dEtleSgpOwoJICAgIGZ1bmN0aW9uIGRpc3Bvc2VPbGRDb21wdXRlZEFuZFN0b3JlTmV3T25lKGVsZW1lbnQsIG5ld0NvbXB1dGVkKSB7CgkgICAgICAgIHZhciBvbGRDb21wdXRlZCA9IGtvLnV0aWxzLmRvbURhdGEuZ2V0KGVsZW1lbnQsIHRlbXBsYXRlQ29tcHV0ZWREb21EYXRhS2V5KTsKCSAgICAgICAgaWYgKG9sZENvbXB1dGVkICYmICh0eXBlb2Yob2xkQ29tcHV0ZWQuZGlzcG9zZSkgPT0gJ2Z1bmN0aW9uJykpCgkgICAgICAgICAgICBvbGRDb21wdXRlZC5kaXNwb3NlKCk7CgkgICAgICAgIGtvLnV0aWxzLmRvbURhdGEuc2V0KGVsZW1lbnQsIHRlbXBsYXRlQ29tcHV0ZWREb21EYXRhS2V5LCAobmV3Q29tcHV0ZWQgJiYgbmV3Q29tcHV0ZWQuaXNBY3RpdmUoKSkgPyBuZXdDb21wdXRlZCA6IHVuZGVmaW5lZCk7CgkgICAgfQoKCSAgICBrby5iaW5kaW5nSGFuZGxlcnNbJ3RlbXBsYXRlJ10gPSB7CgkgICAgICAgICdpbml0JzogZnVuY3Rpb24oZWxlbWVudCwgdmFsdWVBY2Nlc3NvcikgewoJICAgICAgICAgICAgLy8gU3VwcG9ydCBhbm9ueW1vdXMgdGVtcGxhdGVzCgkgICAgICAgICAgICB2YXIgYmluZGluZ1ZhbHVlID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZSh2YWx1ZUFjY2Vzc29yKCkpOwoJICAgICAgICAgICAgaWYgKHR5cGVvZiBiaW5kaW5nVmFsdWUgPT0gInN0cmluZyIgfHwgYmluZGluZ1ZhbHVlWyduYW1lJ10pIHsKCSAgICAgICAgICAgICAgICAvLyBJdCdzIGEgbmFtZWQgdGVtcGxhdGUgLSBjbGVhciB0aGUgZWxlbWVudAoJICAgICAgICAgICAgICAgIGtvLnZpcnR1YWxFbGVtZW50cy5lbXB0eU5vZGUoZWxlbWVudCk7CgkgICAgICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgICAgIC8vIEl0J3MgYW4gYW5vbnltb3VzIHRlbXBsYXRlIC0gc3RvcmUgdGhlIGVsZW1lbnQgY29udGVudHMsIHRoZW4gY2xlYXIgdGhlIGVsZW1lbnQKCSAgICAgICAgICAgICAgICB2YXIgdGVtcGxhdGVOb2RlcyA9IGtvLnZpcnR1YWxFbGVtZW50cy5jaGlsZE5vZGVzKGVsZW1lbnQpLAoJICAgICAgICAgICAgICAgICAgICBjb250YWluZXIgPSBrby51dGlscy5tb3ZlQ2xlYW5lZE5vZGVzVG9Db250YWluZXJFbGVtZW50KHRlbXBsYXRlTm9kZXMpOyAvLyBUaGlzIGFsc28gcmVtb3ZlcyB0aGUgbm9kZXMgZnJvbSB0aGVpciBjdXJyZW50IHBhcmVudAoJICAgICAgICAgICAgICAgIG5ldyBrby50ZW1wbGF0ZVNvdXJjZXMuYW5vbnltb3VzVGVtcGxhdGUoZWxlbWVudClbJ25vZGVzJ10oY29udGFpbmVyKTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIHJldHVybiB7ICdjb250cm9sc0Rlc2NlbmRhbnRCaW5kaW5ncyc6IHRydWUgfTsKCSAgICAgICAgfSwKCSAgICAgICAgJ3VwZGF0ZSc6IGZ1bmN0aW9uIChlbGVtZW50LCB2YWx1ZUFjY2Vzc29yLCBhbGxCaW5kaW5ncywgdmlld01vZGVsLCBiaW5kaW5nQ29udGV4dCkgewoJICAgICAgICAgICAgdmFyIHZhbHVlID0gdmFsdWVBY2Nlc3NvcigpLAoJICAgICAgICAgICAgICAgIGRhdGFWYWx1ZSwKCSAgICAgICAgICAgICAgICBvcHRpb25zID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZSh2YWx1ZSksCgkgICAgICAgICAgICAgICAgc2hvdWxkRGlzcGxheSA9IHRydWUsCgkgICAgICAgICAgICAgICAgdGVtcGxhdGVDb21wdXRlZCA9IG51bGwsCgkgICAgICAgICAgICAgICAgdGVtcGxhdGVOYW1lOwoKCSAgICAgICAgICAgIGlmICh0eXBlb2Ygb3B0aW9ucyA9PSAic3RyaW5nIikgewoJICAgICAgICAgICAgICAgIHRlbXBsYXRlTmFtZSA9IHZhbHVlOwoJICAgICAgICAgICAgICAgIG9wdGlvbnMgPSB7fTsKCSAgICAgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICAgICAgdGVtcGxhdGVOYW1lID0gb3B0aW9uc1snbmFtZSddOwoKCSAgICAgICAgICAgICAgICAvLyBTdXBwb3J0ICJpZiIvImlmbm90IiBjb25kaXRpb25zCgkgICAgICAgICAgICAgICAgaWYgKCdpZicgaW4gb3B0aW9ucykKCSAgICAgICAgICAgICAgICAgICAgc2hvdWxkRGlzcGxheSA9IGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUob3B0aW9uc1snaWYnXSk7CgkgICAgICAgICAgICAgICAgaWYgKHNob3VsZERpc3BsYXkgJiYgJ2lmbm90JyBpbiBvcHRpb25zKQoJICAgICAgICAgICAgICAgICAgICBzaG91bGREaXNwbGF5ID0gIWtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUob3B0aW9uc1snaWZub3QnXSk7CgoJICAgICAgICAgICAgICAgIGRhdGFWYWx1ZSA9IGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUob3B0aW9uc1snZGF0YSddKTsKCSAgICAgICAgICAgIH0KCgkgICAgICAgICAgICBpZiAoJ2ZvcmVhY2gnIGluIG9wdGlvbnMpIHsKCSAgICAgICAgICAgICAgICAvLyBSZW5kZXIgb25jZSBmb3IgZWFjaCBkYXRhIHBvaW50ICh0cmVhdGluZyBkYXRhIHNldCBhcyBlbXB0eSBpZiBzaG91bGREaXNwbGF5PT1mYWxzZSkKCSAgICAgICAgICAgICAgICB2YXIgZGF0YUFycmF5ID0gKHNob3VsZERpc3BsYXkgJiYgb3B0aW9uc1snZm9yZWFjaCddKSB8fCBbXTsKCSAgICAgICAgICAgICAgICB0ZW1wbGF0ZUNvbXB1dGVkID0ga28ucmVuZGVyVGVtcGxhdGVGb3JFYWNoKHRlbXBsYXRlTmFtZSB8fCBlbGVtZW50LCBkYXRhQXJyYXksIG9wdGlvbnMsIGVsZW1lbnQsIGJpbmRpbmdDb250ZXh0KTsKCSAgICAgICAgICAgIH0gZWxzZSBpZiAoIXNob3VsZERpc3BsYXkpIHsKCSAgICAgICAgICAgICAgICBrby52aXJ0dWFsRWxlbWVudHMuZW1wdHlOb2RlKGVsZW1lbnQpOwoJICAgICAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgICAgICAvLyBSZW5kZXIgb25jZSBmb3IgdGhpcyBzaW5nbGUgZGF0YSBwb2ludCAob3IgdXNlIHRoZSB2aWV3TW9kZWwgaWYgbm8gZGF0YSB3YXMgcHJvdmlkZWQpCgkgICAgICAgICAgICAgICAgdmFyIGlubmVyQmluZGluZ0NvbnRleHQgPSAoJ2RhdGEnIGluIG9wdGlvbnMpID8KCSAgICAgICAgICAgICAgICAgICAgYmluZGluZ0NvbnRleHRbJ2NyZWF0ZUNoaWxkQ29udGV4dCddKGRhdGFWYWx1ZSwgb3B0aW9uc1snYXMnXSkgOiAgLy8gR2l2ZW4gYW4gZXhwbGl0aXQgJ2RhdGEnIHZhbHVlLCB3ZSBjcmVhdGUgYSBjaGlsZCBiaW5kaW5nIGNvbnRleHQgZm9yIGl0CgkgICAgICAgICAgICAgICAgICAgIGJpbmRpbmdDb250ZXh0OyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gR2l2ZW4gbm8gZXhwbGljaXQgJ2RhdGEnIHZhbHVlLCB3ZSByZXRhaW4gdGhlIHNhbWUgYmluZGluZyBjb250ZXh0CgkgICAgICAgICAgICAgICAgdGVtcGxhdGVDb21wdXRlZCA9IGtvLnJlbmRlclRlbXBsYXRlKHRlbXBsYXRlTmFtZSB8fCBlbGVtZW50LCBpbm5lckJpbmRpbmdDb250ZXh0LCBvcHRpb25zLCBlbGVtZW50KTsKCSAgICAgICAgICAgIH0KCgkgICAgICAgICAgICAvLyBJdCBvbmx5IG1ha2VzIHNlbnNlIHRvIGhhdmUgYSBzaW5nbGUgdGVtcGxhdGUgY29tcHV0ZWQgcGVyIGVsZW1lbnQgKG90aGVyd2lzZSB3aGljaCBvbmUgc2hvdWxkIGhhdmUgaXRzIG91dHB1dCBkaXNwbGF5ZWQ/KQoJICAgICAgICAgICAgZGlzcG9zZU9sZENvbXB1dGVkQW5kU3RvcmVOZXdPbmUoZWxlbWVudCwgdGVtcGxhdGVDb21wdXRlZCk7CgkgICAgICAgIH0KCSAgICB9OwoKCSAgICAvLyBBbm9ueW1vdXMgdGVtcGxhdGVzIGNhbid0IGJlIHJld3JpdHRlbi4gR2l2ZSBhIG5pY2UgZXJyb3IgbWVzc2FnZSBpZiB5b3UgdHJ5IHRvIGRvIGl0LgoJICAgIGtvLmV4cHJlc3Npb25SZXdyaXRpbmcuYmluZGluZ1Jld3JpdGVWYWxpZGF0b3JzWyd0ZW1wbGF0ZSddID0gZnVuY3Rpb24oYmluZGluZ1ZhbHVlKSB7CgkgICAgICAgIHZhciBwYXJzZWRCaW5kaW5nVmFsdWUgPSBrby5leHByZXNzaW9uUmV3cml0aW5nLnBhcnNlT2JqZWN0TGl0ZXJhbChiaW5kaW5nVmFsdWUpOwoKCSAgICAgICAgaWYgKChwYXJzZWRCaW5kaW5nVmFsdWUubGVuZ3RoID09IDEpICYmIHBhcnNlZEJpbmRpbmdWYWx1ZVswXVsndW5rbm93biddKQoJICAgICAgICAgICAgcmV0dXJuIG51bGw7IC8vIEl0IGxvb2tzIGxpa2UgYSBzdHJpbmcgbGl0ZXJhbCwgbm90IGFuIG9iamVjdCBsaXRlcmFsLCBzbyB0cmVhdCBpdCBhcyBhIG5hbWVkIHRlbXBsYXRlICh3aGljaCBpcyBhbGxvd2VkIGZvciByZXdyaXRpbmcpCgoJICAgICAgICBpZiAoa28uZXhwcmVzc2lvblJld3JpdGluZy5rZXlWYWx1ZUFycmF5Q29udGFpbnNLZXkocGFyc2VkQmluZGluZ1ZhbHVlLCAibmFtZSIpKQoJICAgICAgICAgICAgcmV0dXJuIG51bGw7IC8vIE5hbWVkIHRlbXBsYXRlcyBjYW4gYmUgcmV3cml0dGVuLCBzbyByZXR1cm4gIm5vIGVycm9yIgoJICAgICAgICByZXR1cm4gIlRoaXMgdGVtcGxhdGUgZW5naW5lIGRvZXMgbm90IHN1cHBvcnQgYW5vbnltb3VzIHRlbXBsYXRlcyBuZXN0ZWQgd2l0aGluIGl0cyB0ZW1wbGF0ZXMiOwoJICAgIH07CgoJICAgIGtvLnZpcnR1YWxFbGVtZW50cy5hbGxvd2VkQmluZGluZ3NbJ3RlbXBsYXRlJ10gPSB0cnVlOwoJfSkoKTsKCglrby5leHBvcnRTeW1ib2woJ3NldFRlbXBsYXRlRW5naW5lJywga28uc2V0VGVtcGxhdGVFbmdpbmUpOwoJa28uZXhwb3J0U3ltYm9sKCdyZW5kZXJUZW1wbGF0ZScsIGtvLnJlbmRlclRlbXBsYXRlKTsKCS8vIEdvIHRocm91Z2ggdGhlIGl0ZW1zIHRoYXQgaGF2ZSBiZWVuIGFkZGVkIGFuZCBkZWxldGVkIGFuZCB0cnkgdG8gZmluZCBtYXRjaGVzIGJldHdlZW4gdGhlbS4KCWtvLnV0aWxzLmZpbmRNb3Zlc0luQXJyYXlDb21wYXJpc29uID0gZnVuY3Rpb24gKGxlZnQsIHJpZ2h0LCBsaW1pdEZhaWxlZENvbXBhcmVzKSB7CgkgICAgaWYgKGxlZnQubGVuZ3RoICYmIHJpZ2h0Lmxlbmd0aCkgewoJICAgICAgICB2YXIgZmFpbGVkQ29tcGFyZXMsIGwsIHIsIGxlZnRJdGVtLCByaWdodEl0ZW07CgkgICAgICAgIGZvciAoZmFpbGVkQ29tcGFyZXMgPSBsID0gMDsgKCFsaW1pdEZhaWxlZENvbXBhcmVzIHx8IGZhaWxlZENvbXBhcmVzIDwgbGltaXRGYWlsZWRDb21wYXJlcykgJiYgKGxlZnRJdGVtID0gbGVmdFtsXSk7ICsrbCkgewoJICAgICAgICAgICAgZm9yIChyID0gMDsgcmlnaHRJdGVtID0gcmlnaHRbcl07ICsrcikgewoJICAgICAgICAgICAgICAgIGlmIChsZWZ0SXRlbVsndmFsdWUnXSA9PT0gcmlnaHRJdGVtWyd2YWx1ZSddKSB7CgkgICAgICAgICAgICAgICAgICAgIGxlZnRJdGVtWydtb3ZlZCddID0gcmlnaHRJdGVtWydpbmRleCddOwoJICAgICAgICAgICAgICAgICAgICByaWdodEl0ZW1bJ21vdmVkJ10gPSBsZWZ0SXRlbVsnaW5kZXgnXTsKCSAgICAgICAgICAgICAgICAgICAgcmlnaHQuc3BsaWNlKHIsIDEpOyAgICAgICAgIC8vIFRoaXMgaXRlbSBpcyBtYXJrZWQgYXMgbW92ZWQ7IHNvIHJlbW92ZSBpdCBmcm9tIHJpZ2h0IGxpc3QKCSAgICAgICAgICAgICAgICAgICAgZmFpbGVkQ29tcGFyZXMgPSByID0gMDsgICAgIC8vIFJlc2V0IGZhaWxlZCBjb21wYXJlcyBjb3VudCBiZWNhdXNlIHdlJ3JlIGNoZWNraW5nIGZvciBjb25zZWN1dGl2ZSBmYWlsdXJlcwoJICAgICAgICAgICAgICAgICAgICBicmVhazsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICBmYWlsZWRDb21wYXJlcyArPSByOwoJICAgICAgICB9CgkgICAgfQoJfTsKCglrby51dGlscy5jb21wYXJlQXJyYXlzID0gKGZ1bmN0aW9uICgpIHsKCSAgICB2YXIgc3RhdHVzTm90SW5PbGQgPSAnYWRkZWQnLCBzdGF0dXNOb3RJbk5ldyA9ICdkZWxldGVkJzsKCgkgICAgLy8gU2ltcGxlIGNhbGN1bGF0aW9uIGJhc2VkIG9uIExldmVuc2h0ZWluIGRpc3RhbmNlLgoJICAgIGZ1bmN0aW9uIGNvbXBhcmVBcnJheXMob2xkQXJyYXksIG5ld0FycmF5LCBvcHRpb25zKSB7CgkgICAgICAgIC8vIEZvciBiYWNrd2FyZCBjb21wYXRpYmlsaXR5LCBpZiB0aGUgdGhpcmQgYXJnIGlzIGFjdHVhbGx5IGEgYm9vbCwgaW50ZXJwcmV0CgkgICAgICAgIC8vIGl0IGFzIHRoZSBvbGQgcGFyYW1ldGVyICdkb250TGltaXRNb3ZlcycuIE5ld2VyIGNvZGUgc2hvdWxkIHVzZSB7IGRvbnRMaW1pdE1vdmVzOiB0cnVlIH0uCgkgICAgICAgIG9wdGlvbnMgPSAodHlwZW9mIG9wdGlvbnMgPT09ICdib29sZWFuJykgPyB7ICdkb250TGltaXRNb3Zlcyc6IG9wdGlvbnMgfSA6IChvcHRpb25zIHx8IHt9KTsKCSAgICAgICAgb2xkQXJyYXkgPSBvbGRBcnJheSB8fCBbXTsKCSAgICAgICAgbmV3QXJyYXkgPSBuZXdBcnJheSB8fCBbXTsKCgkgICAgICAgIGlmIChvbGRBcnJheS5sZW5ndGggPD0gbmV3QXJyYXkubGVuZ3RoKQoJICAgICAgICAgICAgcmV0dXJuIGNvbXBhcmVTbWFsbEFycmF5VG9CaWdBcnJheShvbGRBcnJheSwgbmV3QXJyYXksIHN0YXR1c05vdEluT2xkLCBzdGF0dXNOb3RJbk5ldywgb3B0aW9ucyk7CgkgICAgICAgIGVsc2UKCSAgICAgICAgICAgIHJldHVybiBjb21wYXJlU21hbGxBcnJheVRvQmlnQXJyYXkobmV3QXJyYXksIG9sZEFycmF5LCBzdGF0dXNOb3RJbk5ldywgc3RhdHVzTm90SW5PbGQsIG9wdGlvbnMpOwoJICAgIH0KCgkgICAgZnVuY3Rpb24gY29tcGFyZVNtYWxsQXJyYXlUb0JpZ0FycmF5KHNtbEFycmF5LCBiaWdBcnJheSwgc3RhdHVzTm90SW5TbWwsIHN0YXR1c05vdEluQmlnLCBvcHRpb25zKSB7CgkgICAgICAgIHZhciBteU1pbiA9IE1hdGgubWluLAoJICAgICAgICAgICAgbXlNYXggPSBNYXRoLm1heCwKCSAgICAgICAgICAgIGVkaXREaXN0YW5jZU1hdHJpeCA9IFtdLAoJICAgICAgICAgICAgc21sSW5kZXgsIHNtbEluZGV4TWF4ID0gc21sQXJyYXkubGVuZ3RoLAoJICAgICAgICAgICAgYmlnSW5kZXgsIGJpZ0luZGV4TWF4ID0gYmlnQXJyYXkubGVuZ3RoLAoJICAgICAgICAgICAgY29tcGFyZVJhbmdlID0gKGJpZ0luZGV4TWF4IC0gc21sSW5kZXhNYXgpIHx8IDEsCgkgICAgICAgICAgICBtYXhEaXN0YW5jZSA9IHNtbEluZGV4TWF4ICsgYmlnSW5kZXhNYXggKyAxLAoJICAgICAgICAgICAgdGhpc1JvdywgbGFzdFJvdywKCSAgICAgICAgICAgIGJpZ0luZGV4TWF4Rm9yUm93LCBiaWdJbmRleE1pbkZvclJvdzsKCgkgICAgICAgIGZvciAoc21sSW5kZXggPSAwOyBzbWxJbmRleCA8PSBzbWxJbmRleE1heDsgc21sSW5kZXgrKykgewoJICAgICAgICAgICAgbGFzdFJvdyA9IHRoaXNSb3c7CgkgICAgICAgICAgICBlZGl0RGlzdGFuY2VNYXRyaXgucHVzaCh0aGlzUm93ID0gW10pOwoJICAgICAgICAgICAgYmlnSW5kZXhNYXhGb3JSb3cgPSBteU1pbihiaWdJbmRleE1heCwgc21sSW5kZXggKyBjb21wYXJlUmFuZ2UpOwoJICAgICAgICAgICAgYmlnSW5kZXhNaW5Gb3JSb3cgPSBteU1heCgwLCBzbWxJbmRleCAtIDEpOwoJICAgICAgICAgICAgZm9yIChiaWdJbmRleCA9IGJpZ0luZGV4TWluRm9yUm93OyBiaWdJbmRleCA8PSBiaWdJbmRleE1heEZvclJvdzsgYmlnSW5kZXgrKykgewoJICAgICAgICAgICAgICAgIGlmICghYmlnSW5kZXgpCgkgICAgICAgICAgICAgICAgICAgIHRoaXNSb3dbYmlnSW5kZXhdID0gc21sSW5kZXggKyAxOwoJICAgICAgICAgICAgICAgIGVsc2UgaWYgKCFzbWxJbmRleCkgIC8vIFRvcCByb3cgLSB0cmFuc2Zvcm0gZW1wdHkgYXJyYXkgaW50byBuZXcgYXJyYXkgdmlhIGFkZGl0aW9ucwoJICAgICAgICAgICAgICAgICAgICB0aGlzUm93W2JpZ0luZGV4XSA9IGJpZ0luZGV4ICsgMTsKCSAgICAgICAgICAgICAgICBlbHNlIGlmIChzbWxBcnJheVtzbWxJbmRleCAtIDFdID09PSBiaWdBcnJheVtiaWdJbmRleCAtIDFdKQoJICAgICAgICAgICAgICAgICAgICB0aGlzUm93W2JpZ0luZGV4XSA9IGxhc3RSb3dbYmlnSW5kZXggLSAxXTsgICAgICAgICAgICAgICAgICAvLyBjb3B5IHZhbHVlIChubyBlZGl0KQoJICAgICAgICAgICAgICAgIGVsc2UgewoJICAgICAgICAgICAgICAgICAgICB2YXIgbm9ydGhEaXN0YW5jZSA9IGxhc3RSb3dbYmlnSW5kZXhdIHx8IG1heERpc3RhbmNlOyAgICAgICAvLyBub3QgaW4gYmlnIChkZWxldGlvbikKCSAgICAgICAgICAgICAgICAgICAgdmFyIHdlc3REaXN0YW5jZSA9IHRoaXNSb3dbYmlnSW5kZXggLSAxXSB8fCBtYXhEaXN0YW5jZTsgICAgLy8gbm90IGluIHNtYWxsIChhZGRpdGlvbikKCSAgICAgICAgICAgICAgICAgICAgdGhpc1Jvd1tiaWdJbmRleF0gPSBteU1pbihub3J0aERpc3RhbmNlLCB3ZXN0RGlzdGFuY2UpICsgMTsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICB9CgkgICAgICAgIH0KCgkgICAgICAgIHZhciBlZGl0U2NyaXB0ID0gW10sIG1lTWludXNPbmUsIG5vdEluU21sID0gW10sIG5vdEluQmlnID0gW107CgkgICAgICAgIGZvciAoc21sSW5kZXggPSBzbWxJbmRleE1heCwgYmlnSW5kZXggPSBiaWdJbmRleE1heDsgc21sSW5kZXggfHwgYmlnSW5kZXg7KSB7CgkgICAgICAgICAgICBtZU1pbnVzT25lID0gZWRpdERpc3RhbmNlTWF0cml4W3NtbEluZGV4XVtiaWdJbmRleF0gLSAxOwoJICAgICAgICAgICAgaWYgKGJpZ0luZGV4ICYmIG1lTWludXNPbmUgPT09IGVkaXREaXN0YW5jZU1hdHJpeFtzbWxJbmRleF1bYmlnSW5kZXgtMV0pIHsKCSAgICAgICAgICAgICAgICBub3RJblNtbC5wdXNoKGVkaXRTY3JpcHRbZWRpdFNjcmlwdC5sZW5ndGhdID0geyAgICAgLy8gYWRkZWQKCSAgICAgICAgICAgICAgICAgICAgJ3N0YXR1cyc6IHN0YXR1c05vdEluU21sLAoJICAgICAgICAgICAgICAgICAgICAndmFsdWUnOiBiaWdBcnJheVstLWJpZ0luZGV4XSwKCSAgICAgICAgICAgICAgICAgICAgJ2luZGV4JzogYmlnSW5kZXggfSk7CgkgICAgICAgICAgICB9IGVsc2UgaWYgKHNtbEluZGV4ICYmIG1lTWludXNPbmUgPT09IGVkaXREaXN0YW5jZU1hdHJpeFtzbWxJbmRleCAtIDFdW2JpZ0luZGV4XSkgewoJICAgICAgICAgICAgICAgIG5vdEluQmlnLnB1c2goZWRpdFNjcmlwdFtlZGl0U2NyaXB0Lmxlbmd0aF0gPSB7ICAgICAvLyBkZWxldGVkCgkgICAgICAgICAgICAgICAgICAgICdzdGF0dXMnOiBzdGF0dXNOb3RJbkJpZywKCSAgICAgICAgICAgICAgICAgICAgJ3ZhbHVlJzogc21sQXJyYXlbLS1zbWxJbmRleF0sCgkgICAgICAgICAgICAgICAgICAgICdpbmRleCc6IHNtbEluZGV4IH0pOwoJICAgICAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgICAgICAtLWJpZ0luZGV4OwoJICAgICAgICAgICAgICAgIC0tc21sSW5kZXg7CgkgICAgICAgICAgICAgICAgaWYgKCFvcHRpb25zWydzcGFyc2UnXSkgewoJICAgICAgICAgICAgICAgICAgICBlZGl0U2NyaXB0LnB1c2goewoJICAgICAgICAgICAgICAgICAgICAgICAgJ3N0YXR1cyc6ICJyZXRhaW5lZCIsCgkgICAgICAgICAgICAgICAgICAgICAgICAndmFsdWUnOiBiaWdBcnJheVtiaWdJbmRleF0gfSk7CgkgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgfQoJICAgICAgICB9CgoJICAgICAgICAvLyBTZXQgYSBsaW1pdCBvbiB0aGUgbnVtYmVyIG9mIGNvbnNlY3V0aXZlIG5vbi1tYXRjaGluZyBjb21wYXJpc29uczsgaGF2aW5nIGl0IGEgbXVsdGlwbGUgb2YKCSAgICAgICAgLy8gc21sSW5kZXhNYXgga2VlcHMgdGhlIHRpbWUgY29tcGxleGl0eSBvZiB0aGlzIGFsZ29yaXRobSBsaW5lYXIuCgkgICAgICAgIGtvLnV0aWxzLmZpbmRNb3Zlc0luQXJyYXlDb21wYXJpc29uKG5vdEluU21sLCBub3RJbkJpZywgc21sSW5kZXhNYXggKiAxMCk7CgoJICAgICAgICByZXR1cm4gZWRpdFNjcmlwdC5yZXZlcnNlKCk7CgkgICAgfQoKCSAgICByZXR1cm4gY29tcGFyZUFycmF5czsKCX0pKCk7CgoJa28uZXhwb3J0U3ltYm9sKCd1dGlscy5jb21wYXJlQXJyYXlzJywga28udXRpbHMuY29tcGFyZUFycmF5cyk7CgkoZnVuY3Rpb24gKCkgewoJICAgIC8vIE9iamVjdGl2ZToKCSAgICAvLyAqIEdpdmVuIGFuIGlucHV0IGFycmF5LCBhIGNvbnRhaW5lciBET00gbm9kZSwgYW5kIGEgZnVuY3Rpb24gZnJvbSBhcnJheSBlbGVtZW50cyB0byBhcnJheXMgb2YgRE9NIG5vZGVzLAoJICAgIC8vICAgbWFwIHRoZSBhcnJheSBlbGVtZW50cyB0byBhcnJheXMgb2YgRE9NIG5vZGVzLCBjb25jYXRlbmF0ZSB0b2dldGhlciBhbGwgdGhlc2UgYXJyYXlzLCBhbmQgdXNlIHRoZW0gdG8gcG9wdWxhdGUgdGhlIGNvbnRhaW5lciBET00gbm9kZQoJICAgIC8vICogTmV4dCB0aW1lIHdlJ3JlIGdpdmVuIHRoZSBzYW1lIGNvbWJpbmF0aW9uIG9mIHRoaW5ncyAod2l0aCB0aGUgYXJyYXkgcG9zc2libHkgaGF2aW5nIG11dGF0ZWQpLCB1cGRhdGUgdGhlIGNvbnRhaW5lciBET00gbm9kZQoJICAgIC8vICAgc28gdGhhdCBpdHMgY2hpbGRyZW4gaXMgYWdhaW4gdGhlIGNvbmNhdGVuYXRpb24gb2YgdGhlIG1hcHBpbmdzIG9mIHRoZSBhcnJheSBlbGVtZW50cywgYnV0IGRvbid0IHJlLW1hcCBhbnkgYXJyYXkgZWxlbWVudHMgdGhhdCB3ZQoJICAgIC8vICAgcHJldmlvdXNseSBtYXBwZWQgLSByZXRhaW4gdGhvc2Ugbm9kZXMsIGFuZCBqdXN0IGluc2VydC9kZWxldGUgb3RoZXIgb25lcwoKCSAgICAvLyAiY2FsbGJhY2tBZnRlckFkZGluZ05vZGVzIiB3aWxsIGJlIGludm9rZWQgYWZ0ZXIgYW55ICJtYXBwaW5nIi1nZW5lcmF0ZWQgbm9kZXMgYXJlIGluc2VydGVkIGludG8gdGhlIGNvbnRhaW5lciBub2RlCgkgICAgLy8gWW91IGNhbiB1c2UgdGhpcywgZm9yIGV4YW1wbGUsIHRvIGFjdGl2YXRlIGJpbmRpbmdzIG9uIHRob3NlIG5vZGVzLgoKCSAgICBmdW5jdGlvbiBtYXBOb2RlQW5kUmVmcmVzaFdoZW5DaGFuZ2VkKGNvbnRhaW5lck5vZGUsIG1hcHBpbmcsIHZhbHVlVG9NYXAsIGNhbGxiYWNrQWZ0ZXJBZGRpbmdOb2RlcywgaW5kZXgpIHsKCSAgICAgICAgLy8gTWFwIHRoaXMgYXJyYXkgdmFsdWUgaW5zaWRlIGEgZGVwZW5kZW50T2JzZXJ2YWJsZSBzbyB3ZSByZS1tYXAgd2hlbiBhbnkgZGVwZW5kZW5jeSBjaGFuZ2VzCgkgICAgICAgIHZhciBtYXBwZWROb2RlcyA9IFtdOwoJICAgICAgICB2YXIgZGVwZW5kZW50T2JzZXJ2YWJsZSA9IGtvLmRlcGVuZGVudE9ic2VydmFibGUoZnVuY3Rpb24oKSB7CgkgICAgICAgICAgICB2YXIgbmV3TWFwcGVkTm9kZXMgPSBtYXBwaW5nKHZhbHVlVG9NYXAsIGluZGV4LCBrby51dGlscy5maXhVcENvbnRpbnVvdXNOb2RlQXJyYXkobWFwcGVkTm9kZXMsIGNvbnRhaW5lck5vZGUpKSB8fCBbXTsKCgkgICAgICAgICAgICAvLyBPbiBzdWJzZXF1ZW50IGV2YWx1YXRpb25zLCBqdXN0IHJlcGxhY2UgdGhlIHByZXZpb3VzbHktaW5zZXJ0ZWQgRE9NIG5vZGVzCgkgICAgICAgICAgICBpZiAobWFwcGVkTm9kZXMubGVuZ3RoID4gMCkgewoJICAgICAgICAgICAgICAgIGtvLnV0aWxzLnJlcGxhY2VEb21Ob2RlcyhtYXBwZWROb2RlcywgbmV3TWFwcGVkTm9kZXMpOwoJICAgICAgICAgICAgICAgIGlmIChjYWxsYmFja0FmdGVyQWRkaW5nTm9kZXMpCgkgICAgICAgICAgICAgICAgICAgIGtvLmRlcGVuZGVuY3lEZXRlY3Rpb24uaWdub3JlKGNhbGxiYWNrQWZ0ZXJBZGRpbmdOb2RlcywgbnVsbCwgW3ZhbHVlVG9NYXAsIG5ld01hcHBlZE5vZGVzLCBpbmRleF0pOwoJICAgICAgICAgICAgfQoKCSAgICAgICAgICAgIC8vIFJlcGxhY2UgdGhlIGNvbnRlbnRzIG9mIHRoZSBtYXBwZWROb2RlcyBhcnJheSwgdGhlcmVieSB1cGRhdGluZyB0aGUgcmVjb3JkCgkgICAgICAgICAgICAvLyBvZiB3aGljaCBub2RlcyB3b3VsZCBiZSBkZWxldGVkIGlmIHZhbHVlVG9NYXAgd2FzIGl0c2VsZiBsYXRlciByZW1vdmVkCgkgICAgICAgICAgICBtYXBwZWROb2Rlcy5sZW5ndGggPSAwOwoJICAgICAgICAgICAga28udXRpbHMuYXJyYXlQdXNoQWxsKG1hcHBlZE5vZGVzLCBuZXdNYXBwZWROb2Rlcyk7CgkgICAgICAgIH0sIG51bGwsIHsgZGlzcG9zZVdoZW5Ob2RlSXNSZW1vdmVkOiBjb250YWluZXJOb2RlLCBkaXNwb3NlV2hlbjogZnVuY3Rpb24oKSB7IHJldHVybiAha28udXRpbHMuYW55RG9tTm9kZUlzQXR0YWNoZWRUb0RvY3VtZW50KG1hcHBlZE5vZGVzKTsgfSB9KTsKCSAgICAgICAgcmV0dXJuIHsgbWFwcGVkTm9kZXMgOiBtYXBwZWROb2RlcywgZGVwZW5kZW50T2JzZXJ2YWJsZSA6IChkZXBlbmRlbnRPYnNlcnZhYmxlLmlzQWN0aXZlKCkgPyBkZXBlbmRlbnRPYnNlcnZhYmxlIDogdW5kZWZpbmVkKSB9OwoJICAgIH0KCgkgICAgdmFyIGxhc3RNYXBwaW5nUmVzdWx0RG9tRGF0YUtleSA9IGtvLnV0aWxzLmRvbURhdGEubmV4dEtleSgpOwoKCSAgICBrby51dGlscy5zZXREb21Ob2RlQ2hpbGRyZW5Gcm9tQXJyYXlNYXBwaW5nID0gZnVuY3Rpb24gKGRvbU5vZGUsIGFycmF5LCBtYXBwaW5nLCBvcHRpb25zLCBjYWxsYmFja0FmdGVyQWRkaW5nTm9kZXMpIHsKCSAgICAgICAgLy8gQ29tcGFyZSB0aGUgcHJvdmlkZWQgYXJyYXkgYWdhaW5zdCB0aGUgcHJldmlvdXMgb25lCgkgICAgICAgIGFycmF5ID0gYXJyYXkgfHwgW107CgkgICAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoJICAgICAgICB2YXIgaXNGaXJzdEV4ZWN1dGlvbiA9IGtvLnV0aWxzLmRvbURhdGEuZ2V0KGRvbU5vZGUsIGxhc3RNYXBwaW5nUmVzdWx0RG9tRGF0YUtleSkgPT09IHVuZGVmaW5lZDsKCSAgICAgICAgdmFyIGxhc3RNYXBwaW5nUmVzdWx0ID0ga28udXRpbHMuZG9tRGF0YS5nZXQoZG9tTm9kZSwgbGFzdE1hcHBpbmdSZXN1bHREb21EYXRhS2V5KSB8fCBbXTsKCSAgICAgICAgdmFyIGxhc3RBcnJheSA9IGtvLnV0aWxzLmFycmF5TWFwKGxhc3RNYXBwaW5nUmVzdWx0LCBmdW5jdGlvbiAoeCkgeyByZXR1cm4geC5hcnJheUVudHJ5OyB9KTsKCSAgICAgICAgdmFyIGVkaXRTY3JpcHQgPSBrby51dGlscy5jb21wYXJlQXJyYXlzKGxhc3RBcnJheSwgYXJyYXksIG9wdGlvbnNbJ2RvbnRMaW1pdE1vdmVzJ10pOwoKCSAgICAgICAgLy8gQnVpbGQgdGhlIG5ldyBtYXBwaW5nIHJlc3VsdAoJICAgICAgICB2YXIgbmV3TWFwcGluZ1Jlc3VsdCA9IFtdOwoJICAgICAgICB2YXIgbGFzdE1hcHBpbmdSZXN1bHRJbmRleCA9IDA7CgkgICAgICAgIHZhciBuZXdNYXBwaW5nUmVzdWx0SW5kZXggPSAwOwoKCSAgICAgICAgdmFyIG5vZGVzVG9EZWxldGUgPSBbXTsKCSAgICAgICAgdmFyIGl0ZW1zVG9Qcm9jZXNzID0gW107CgkgICAgICAgIHZhciBpdGVtc0ZvckJlZm9yZVJlbW92ZUNhbGxiYWNrcyA9IFtdOwoJICAgICAgICB2YXIgaXRlbXNGb3JNb3ZlQ2FsbGJhY2tzID0gW107CgkgICAgICAgIHZhciBpdGVtc0ZvckFmdGVyQWRkQ2FsbGJhY2tzID0gW107CgkgICAgICAgIHZhciBtYXBEYXRhOwoKCSAgICAgICAgZnVuY3Rpb24gaXRlbU1vdmVkT3JSZXRhaW5lZChlZGl0U2NyaXB0SW5kZXgsIG9sZFBvc2l0aW9uKSB7CgkgICAgICAgICAgICBtYXBEYXRhID0gbGFzdE1hcHBpbmdSZXN1bHRbb2xkUG9zaXRpb25dOwoJICAgICAgICAgICAgaWYgKG5ld01hcHBpbmdSZXN1bHRJbmRleCAhPT0gb2xkUG9zaXRpb24pCgkgICAgICAgICAgICAgICAgaXRlbXNGb3JNb3ZlQ2FsbGJhY2tzW2VkaXRTY3JpcHRJbmRleF0gPSBtYXBEYXRhOwoJICAgICAgICAgICAgLy8gU2luY2UgdXBkYXRpbmcgdGhlIGluZGV4IG1pZ2h0IGNoYW5nZSB0aGUgbm9kZXMsIGRvIHNvIGJlZm9yZSBjYWxsaW5nIGZpeFVwQ29udGludW91c05vZGVBcnJheQoJICAgICAgICAgICAgbWFwRGF0YS5pbmRleE9ic2VydmFibGUobmV3TWFwcGluZ1Jlc3VsdEluZGV4KyspOwoJICAgICAgICAgICAga28udXRpbHMuZml4VXBDb250aW51b3VzTm9kZUFycmF5KG1hcERhdGEubWFwcGVkTm9kZXMsIGRvbU5vZGUpOwoJICAgICAgICAgICAgbmV3TWFwcGluZ1Jlc3VsdC5wdXNoKG1hcERhdGEpOwoJICAgICAgICAgICAgaXRlbXNUb1Byb2Nlc3MucHVzaChtYXBEYXRhKTsKCSAgICAgICAgfQoKCSAgICAgICAgZnVuY3Rpb24gY2FsbENhbGxiYWNrKGNhbGxiYWNrLCBpdGVtcykgewoJICAgICAgICAgICAgaWYgKGNhbGxiYWNrKSB7CgkgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIG4gPSBpdGVtcy5sZW5ndGg7IGkgPCBuOyBpKyspIHsKCSAgICAgICAgICAgICAgICAgICAgaWYgKGl0ZW1zW2ldKSB7CgkgICAgICAgICAgICAgICAgICAgICAgICBrby51dGlscy5hcnJheUZvckVhY2goaXRlbXNbaV0ubWFwcGVkTm9kZXMsIGZ1bmN0aW9uKG5vZGUpIHsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayhub2RlLCBpLCBpdGVtc1tpXS5hcnJheUVudHJ5KTsKCSAgICAgICAgICAgICAgICAgICAgICAgIH0pOwoJICAgICAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgfQoJICAgICAgICB9CgoJICAgICAgICBmb3IgKHZhciBpID0gMCwgZWRpdFNjcmlwdEl0ZW0sIG1vdmVkSW5kZXg7IGVkaXRTY3JpcHRJdGVtID0gZWRpdFNjcmlwdFtpXTsgaSsrKSB7CgkgICAgICAgICAgICBtb3ZlZEluZGV4ID0gZWRpdFNjcmlwdEl0ZW1bJ21vdmVkJ107CgkgICAgICAgICAgICBzd2l0Y2ggKGVkaXRTY3JpcHRJdGVtWydzdGF0dXMnXSkgewoJICAgICAgICAgICAgICAgIGNhc2UgImRlbGV0ZWQiOgoJICAgICAgICAgICAgICAgICAgICBpZiAobW92ZWRJbmRleCA9PT0gdW5kZWZpbmVkKSB7CgkgICAgICAgICAgICAgICAgICAgICAgICBtYXBEYXRhID0gbGFzdE1hcHBpbmdSZXN1bHRbbGFzdE1hcHBpbmdSZXN1bHRJbmRleF07CgoJICAgICAgICAgICAgICAgICAgICAgICAgLy8gU3RvcCB0cmFja2luZyBjaGFuZ2VzIHRvIHRoZSBtYXBwaW5nIGZvciB0aGVzZSBub2RlcwoJICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1hcERhdGEuZGVwZW5kZW50T2JzZXJ2YWJsZSkKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXBEYXRhLmRlcGVuZGVudE9ic2VydmFibGUuZGlzcG9zZSgpOwoKCSAgICAgICAgICAgICAgICAgICAgICAgIC8vIFF1ZXVlIHRoZXNlIG5vZGVzIGZvciBsYXRlciByZW1vdmFsCgkgICAgICAgICAgICAgICAgICAgICAgICBub2Rlc1RvRGVsZXRlLnB1c2guYXBwbHkobm9kZXNUb0RlbGV0ZSwga28udXRpbHMuZml4VXBDb250aW51b3VzTm9kZUFycmF5KG1hcERhdGEubWFwcGVkTm9kZXMsIGRvbU5vZGUpKTsKCSAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvcHRpb25zWydiZWZvcmVSZW1vdmUnXSkgewoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW1zRm9yQmVmb3JlUmVtb3ZlQ2FsbGJhY2tzW2ldID0gbWFwRGF0YTsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICBpdGVtc1RvUHJvY2Vzcy5wdXNoKG1hcERhdGEpOwoJICAgICAgICAgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgICAgIGxhc3RNYXBwaW5nUmVzdWx0SW5kZXgrKzsKCSAgICAgICAgICAgICAgICAgICAgYnJlYWs7CgoJICAgICAgICAgICAgICAgIGNhc2UgInJldGFpbmVkIjoKCSAgICAgICAgICAgICAgICAgICAgaXRlbU1vdmVkT3JSZXRhaW5lZChpLCBsYXN0TWFwcGluZ1Jlc3VsdEluZGV4KyspOwoJICAgICAgICAgICAgICAgICAgICBicmVhazsKCgkgICAgICAgICAgICAgICAgY2FzZSAiYWRkZWQiOgoJICAgICAgICAgICAgICAgICAgICBpZiAobW92ZWRJbmRleCAhPT0gdW5kZWZpbmVkKSB7CgkgICAgICAgICAgICAgICAgICAgICAgICBpdGVtTW92ZWRPclJldGFpbmVkKGksIG1vdmVkSW5kZXgpOwoJICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgICAgICAgICAgICAgbWFwRGF0YSA9IHsgYXJyYXlFbnRyeTogZWRpdFNjcmlwdEl0ZW1bJ3ZhbHVlJ10sIGluZGV4T2JzZXJ2YWJsZToga28ub2JzZXJ2YWJsZShuZXdNYXBwaW5nUmVzdWx0SW5kZXgrKykgfTsKCSAgICAgICAgICAgICAgICAgICAgICAgIG5ld01hcHBpbmdSZXN1bHQucHVzaChtYXBEYXRhKTsKCSAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW1zVG9Qcm9jZXNzLnB1c2gobWFwRGF0YSk7CgkgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWlzRmlyc3RFeGVjdXRpb24pCgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgaXRlbXNGb3JBZnRlckFkZENhbGxiYWNrc1tpXSA9IG1hcERhdGE7CgkgICAgICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICAgICAgYnJlYWs7CgkgICAgICAgICAgICB9CgkgICAgICAgIH0KCgkgICAgICAgIC8vIENhbGwgYmVmb3JlTW92ZSBmaXJzdCBiZWZvcmUgYW55IGNoYW5nZXMgaGF2ZSBiZWVuIG1hZGUgdG8gdGhlIERPTQoJICAgICAgICBjYWxsQ2FsbGJhY2sob3B0aW9uc1snYmVmb3JlTW92ZSddLCBpdGVtc0Zvck1vdmVDYWxsYmFja3MpOwoKCSAgICAgICAgLy8gTmV4dCByZW1vdmUgbm9kZXMgZm9yIGRlbGV0ZWQgaXRlbXMgKG9yIGp1c3QgY2xlYW4gaWYgdGhlcmUncyBhIGJlZm9yZVJlbW92ZSBjYWxsYmFjaykKCSAgICAgICAga28udXRpbHMuYXJyYXlGb3JFYWNoKG5vZGVzVG9EZWxldGUsIG9wdGlvbnNbJ2JlZm9yZVJlbW92ZSddID8ga28uY2xlYW5Ob2RlIDoga28ucmVtb3ZlTm9kZSk7CgoJICAgICAgICAvLyBOZXh0IGFkZC9yZW9yZGVyIHRoZSByZW1haW5pbmcgaXRlbXMgKHdpbGwgaW5jbHVkZSBkZWxldGVkIGl0ZW1zIGlmIHRoZXJlJ3MgYSBiZWZvcmVSZW1vdmUgY2FsbGJhY2spCgkgICAgICAgIGZvciAodmFyIGkgPSAwLCBuZXh0Tm9kZSA9IGtvLnZpcnR1YWxFbGVtZW50cy5maXJzdENoaWxkKGRvbU5vZGUpLCBsYXN0Tm9kZSwgbm9kZTsgbWFwRGF0YSA9IGl0ZW1zVG9Qcm9jZXNzW2ldOyBpKyspIHsKCSAgICAgICAgICAgIC8vIEdldCBub2RlcyBmb3IgbmV3bHkgYWRkZWQgaXRlbXMKCSAgICAgICAgICAgIGlmICghbWFwRGF0YS5tYXBwZWROb2RlcykKCSAgICAgICAgICAgICAgICBrby51dGlscy5leHRlbmQobWFwRGF0YSwgbWFwTm9kZUFuZFJlZnJlc2hXaGVuQ2hhbmdlZChkb21Ob2RlLCBtYXBwaW5nLCBtYXBEYXRhLmFycmF5RW50cnksIGNhbGxiYWNrQWZ0ZXJBZGRpbmdOb2RlcywgbWFwRGF0YS5pbmRleE9ic2VydmFibGUpKTsKCgkgICAgICAgICAgICAvLyBQdXQgbm9kZXMgaW4gdGhlIHJpZ2h0IHBsYWNlIGlmIHRoZXkgYXJlbid0IHRoZXJlIGFscmVhZHkKCSAgICAgICAgICAgIGZvciAodmFyIGogPSAwOyBub2RlID0gbWFwRGF0YS5tYXBwZWROb2Rlc1tqXTsgbmV4dE5vZGUgPSBub2RlLm5leHRTaWJsaW5nLCBsYXN0Tm9kZSA9IG5vZGUsIGorKykgewoJICAgICAgICAgICAgICAgIGlmIChub2RlICE9PSBuZXh0Tm9kZSkKCSAgICAgICAgICAgICAgICAgICAga28udmlydHVhbEVsZW1lbnRzLmluc2VydEFmdGVyKGRvbU5vZGUsIG5vZGUsIGxhc3ROb2RlKTsKCSAgICAgICAgICAgIH0KCgkgICAgICAgICAgICAvLyBSdW4gdGhlIGNhbGxiYWNrcyBmb3IgbmV3bHkgYWRkZWQgbm9kZXMgKGZvciBleGFtcGxlLCB0byBhcHBseSBiaW5kaW5ncywgZXRjLikKCSAgICAgICAgICAgIGlmICghbWFwRGF0YS5pbml0aWFsaXplZCAmJiBjYWxsYmFja0FmdGVyQWRkaW5nTm9kZXMpIHsKCSAgICAgICAgICAgICAgICBjYWxsYmFja0FmdGVyQWRkaW5nTm9kZXMobWFwRGF0YS5hcnJheUVudHJ5LCBtYXBEYXRhLm1hcHBlZE5vZGVzLCBtYXBEYXRhLmluZGV4T2JzZXJ2YWJsZSk7CgkgICAgICAgICAgICAgICAgbWFwRGF0YS5pbml0aWFsaXplZCA9IHRydWU7CgkgICAgICAgICAgICB9CgkgICAgICAgIH0KCgkgICAgICAgIC8vIElmIHRoZXJlJ3MgYSBiZWZvcmVSZW1vdmUgY2FsbGJhY2ssIGNhbGwgaXQgYWZ0ZXIgcmVvcmRlcmluZy4KCSAgICAgICAgLy8gTm90ZSB0aGF0IHdlIGFzc3VtZSB0aGF0IHRoZSBiZWZvcmVSZW1vdmUgY2FsbGJhY2sgd2lsbCB1c3VhbGx5IGJlIHVzZWQgdG8gcmVtb3ZlIHRoZSBub2RlcyB1c2luZwoJICAgICAgICAvLyBzb21lIHNvcnQgb2YgYW5pbWF0aW9uLCB3aGljaCBpcyB3aHkgd2UgZmlyc3QgcmVvcmRlciB0aGUgbm9kZXMgdGhhdCB3aWxsIGJlIHJlbW92ZWQuIElmIHRoZQoJICAgICAgICAvLyBjYWxsYmFjayBpbnN0ZWFkIHJlbW92ZXMgdGhlIG5vZGVzIHJpZ2h0IGF3YXksIGl0IHdvdWxkIGJlIG1vcmUgZWZmaWNpZW50IHRvIHNraXAgcmVvcmRlcmluZyB0aGVtLgoJICAgICAgICAvLyBQZXJoYXBzIHdlJ2xsIG1ha2UgdGhhdCBjaGFuZ2UgaW4gdGhlIGZ1dHVyZSBpZiB0aGlzIHNjZW5hcmlvIGJlY29tZXMgbW9yZSBjb21tb24uCgkgICAgICAgIGNhbGxDYWxsYmFjayhvcHRpb25zWydiZWZvcmVSZW1vdmUnXSwgaXRlbXNGb3JCZWZvcmVSZW1vdmVDYWxsYmFja3MpOwoKCSAgICAgICAgLy8gRmluYWxseSBjYWxsIGFmdGVyTW92ZSBhbmQgYWZ0ZXJBZGQgY2FsbGJhY2tzCgkgICAgICAgIGNhbGxDYWxsYmFjayhvcHRpb25zWydhZnRlck1vdmUnXSwgaXRlbXNGb3JNb3ZlQ2FsbGJhY2tzKTsKCSAgICAgICAgY2FsbENhbGxiYWNrKG9wdGlvbnNbJ2FmdGVyQWRkJ10sIGl0ZW1zRm9yQWZ0ZXJBZGRDYWxsYmFja3MpOwoKCSAgICAgICAgLy8gU3RvcmUgYSBjb3B5IG9mIHRoZSBhcnJheSBpdGVtcyB3ZSBqdXN0IGNvbnNpZGVyZWQgc28gd2UgY2FuIGRpZmZlcmVuY2UgaXQgbmV4dCB0aW1lCgkgICAgICAgIGtvLnV0aWxzLmRvbURhdGEuc2V0KGRvbU5vZGUsIGxhc3RNYXBwaW5nUmVzdWx0RG9tRGF0YUtleSwgbmV3TWFwcGluZ1Jlc3VsdCk7CgkgICAgfQoJfSkoKTsKCglrby5leHBvcnRTeW1ib2woJ3V0aWxzLnNldERvbU5vZGVDaGlsZHJlbkZyb21BcnJheU1hcHBpbmcnLCBrby51dGlscy5zZXREb21Ob2RlQ2hpbGRyZW5Gcm9tQXJyYXlNYXBwaW5nKTsKCWtvLm5hdGl2ZVRlbXBsYXRlRW5naW5lID0gZnVuY3Rpb24gKCkgewoJICAgIHRoaXNbJ2FsbG93VGVtcGxhdGVSZXdyaXRpbmcnXSA9IGZhbHNlOwoJfQoKCWtvLm5hdGl2ZVRlbXBsYXRlRW5naW5lLnByb3RvdHlwZSA9IG5ldyBrby50ZW1wbGF0ZUVuZ2luZSgpOwoJa28ubmF0aXZlVGVtcGxhdGVFbmdpbmUucHJvdG90eXBlLmNvbnN0cnVjdG9yID0ga28ubmF0aXZlVGVtcGxhdGVFbmdpbmU7Cglrby5uYXRpdmVUZW1wbGF0ZUVuZ2luZS5wcm90b3R5cGVbJ3JlbmRlclRlbXBsYXRlU291cmNlJ10gPSBmdW5jdGlvbiAodGVtcGxhdGVTb3VyY2UsIGJpbmRpbmdDb250ZXh0LCBvcHRpb25zKSB7CgkgICAgdmFyIHVzZU5vZGVzSWZBdmFpbGFibGUgPSAhKGtvLnV0aWxzLmllVmVyc2lvbiA8IDkpLCAvLyBJRTw5IGNsb25lTm9kZSBkb2Vzbid0IHdvcmsgcHJvcGVybHkKCSAgICAgICAgdGVtcGxhdGVOb2Rlc0Z1bmMgPSB1c2VOb2Rlc0lmQXZhaWxhYmxlID8gdGVtcGxhdGVTb3VyY2VbJ25vZGVzJ10gOiBudWxsLAoJICAgICAgICB0ZW1wbGF0ZU5vZGVzID0gdGVtcGxhdGVOb2Rlc0Z1bmMgPyB0ZW1wbGF0ZVNvdXJjZVsnbm9kZXMnXSgpIDogbnVsbDsKCgkgICAgaWYgKHRlbXBsYXRlTm9kZXMpIHsKCSAgICAgICAgcmV0dXJuIGtvLnV0aWxzLm1ha2VBcnJheSh0ZW1wbGF0ZU5vZGVzLmNsb25lTm9kZSh0cnVlKS5jaGlsZE5vZGVzKTsKCSAgICB9IGVsc2UgewoJICAgICAgICB2YXIgdGVtcGxhdGVUZXh0ID0gdGVtcGxhdGVTb3VyY2VbJ3RleHQnXSgpOwoJICAgICAgICByZXR1cm4ga28udXRpbHMucGFyc2VIdG1sRnJhZ21lbnQodGVtcGxhdGVUZXh0KTsKCSAgICB9Cgl9OwoKCWtvLm5hdGl2ZVRlbXBsYXRlRW5naW5lLmluc3RhbmNlID0gbmV3IGtvLm5hdGl2ZVRlbXBsYXRlRW5naW5lKCk7Cglrby5zZXRUZW1wbGF0ZUVuZ2luZShrby5uYXRpdmVUZW1wbGF0ZUVuZ2luZS5pbnN0YW5jZSk7CgoJa28uZXhwb3J0U3ltYm9sKCduYXRpdmVUZW1wbGF0ZUVuZ2luZScsIGtvLm5hdGl2ZVRlbXBsYXRlRW5naW5lKTsKCShmdW5jdGlvbigpIHsKCSAgICBrby5qcXVlcnlUbXBsVGVtcGxhdGVFbmdpbmUgPSBmdW5jdGlvbiAoKSB7CgkgICAgICAgIC8vIERldGVjdCB3aGljaCB2ZXJzaW9uIG9mIGpxdWVyeS10bXBsIHlvdSdyZSB1c2luZy4gVW5mb3J0dW5hdGVseSBqcXVlcnktdG1wbAoJICAgICAgICAvLyBkb2Vzbid0IGV4cG9zZSBhIHZlcnNpb24gbnVtYmVyLCBzbyB3ZSBoYXZlIHRvIGluZmVyIGl0LgoJICAgICAgICAvLyBOb3RlIHRoYXQgYXMgb2YgS25vY2tvdXQgMS4zLCB3ZSBvbmx5IHN1cHBvcnQgalF1ZXJ5LnRtcGwgMS4wLjBwcmUgYW5kIGxhdGVyLAoJICAgICAgICAvLyB3aGljaCBLTyBpbnRlcm5hbGx5IHJlZmVycyB0byBhcyB2ZXJzaW9uICIyIiwgc28gb2xkZXIgdmVyc2lvbnMgYXJlIG5vIGxvbmdlciBkZXRlY3RlZC4KCSAgICAgICAgdmFyIGpRdWVyeVRtcGxWZXJzaW9uID0gdGhpcy5qUXVlcnlUbXBsVmVyc2lvbiA9IChmdW5jdGlvbigpIHsKCSAgICAgICAgICAgIGlmICghalF1ZXJ5SW5zdGFuY2UgfHwgIShqUXVlcnlJbnN0YW5jZVsndG1wbCddKSkKCSAgICAgICAgICAgICAgICByZXR1cm4gMDsKCSAgICAgICAgICAgIC8vIFNpbmNlIGl0IGV4cG9zZXMgbm8gb2ZmaWNpYWwgdmVyc2lvbiBudW1iZXIsIHdlIHVzZSBvdXIgb3duIG51bWJlcmluZyBzeXN0ZW0uIFRvIGJlIHVwZGF0ZWQgYXMganF1ZXJ5LXRtcGwgZXZvbHZlcy4KCSAgICAgICAgICAgIHRyeSB7CgkgICAgICAgICAgICAgICAgaWYgKGpRdWVyeUluc3RhbmNlWyd0bXBsJ11bJ3RhZyddWyd0bXBsJ11bJ29wZW4nXS50b1N0cmluZygpLmluZGV4T2YoJ19fJykgPj0gMCkgewoJICAgICAgICAgICAgICAgICAgICAvLyBTaW5jZSAxLjAuMHByZSwgY3VzdG9tIHRhZ3Mgc2hvdWxkIGFwcGVuZCBtYXJrdXAgdG8gYW4gYXJyYXkgY2FsbGVkICJfXyIKCSAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDI7IC8vIEZpbmFsIHZlcnNpb24gb2YganF1ZXJ5LnRtcGwKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICB9IGNhdGNoKGV4KSB7IC8qIEFwcGFyZW50bHkgbm90IHRoZSB2ZXJzaW9uIHdlIHdlcmUgbG9va2luZyBmb3IgKi8gfQoKCSAgICAgICAgICAgIHJldHVybiAxOyAvLyBBbnkgb2xkZXIgdmVyc2lvbiB0aGF0IHdlIGRvbid0IHN1cHBvcnQKCSAgICAgICAgfSkoKTsKCgkgICAgICAgIGZ1bmN0aW9uIGVuc3VyZUhhc1JlZmVyZW5jZWRKUXVlcnlUZW1wbGF0ZXMoKSB7CgkgICAgICAgICAgICBpZiAoalF1ZXJ5VG1wbFZlcnNpb24gPCAyKQoJICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiWW91ciB2ZXJzaW9uIG9mIGpRdWVyeS50bXBsIGlzIHRvbyBvbGQuIFBsZWFzZSB1cGdyYWRlIHRvIGpRdWVyeS50bXBsIDEuMC4wcHJlIG9yIGxhdGVyLiIpOwoJICAgICAgICB9CgoJICAgICAgICBmdW5jdGlvbiBleGVjdXRlVGVtcGxhdGUoY29tcGlsZWRUZW1wbGF0ZSwgZGF0YSwgalF1ZXJ5VGVtcGxhdGVPcHRpb25zKSB7CgkgICAgICAgICAgICByZXR1cm4galF1ZXJ5SW5zdGFuY2VbJ3RtcGwnXShjb21waWxlZFRlbXBsYXRlLCBkYXRhLCBqUXVlcnlUZW1wbGF0ZU9wdGlvbnMpOwoJICAgICAgICB9CgoJICAgICAgICB0aGlzWydyZW5kZXJUZW1wbGF0ZVNvdXJjZSddID0gZnVuY3Rpb24odGVtcGxhdGVTb3VyY2UsIGJpbmRpbmdDb250ZXh0LCBvcHRpb25zKSB7CgkgICAgICAgICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKCSAgICAgICAgICAgIGVuc3VyZUhhc1JlZmVyZW5jZWRKUXVlcnlUZW1wbGF0ZXMoKTsKCgkgICAgICAgICAgICAvLyBFbnN1cmUgd2UgaGF2ZSBzdG9yZWQgYSBwcmVjb21waWxlZCB2ZXJzaW9uIG9mIHRoaXMgdGVtcGxhdGUgKGRvbid0IHdhbnQgdG8gcmVwYXJzZSBvbiBldmVyeSByZW5kZXIpCgkgICAgICAgICAgICB2YXIgcHJlY29tcGlsZWQgPSB0ZW1wbGF0ZVNvdXJjZVsnZGF0YSddKCdwcmVjb21waWxlZCcpOwoJICAgICAgICAgICAgaWYgKCFwcmVjb21waWxlZCkgewoJICAgICAgICAgICAgICAgIHZhciB0ZW1wbGF0ZVRleHQgPSB0ZW1wbGF0ZVNvdXJjZVsndGV4dCddKCkgfHwgIiI7CgkgICAgICAgICAgICAgICAgLy8gV3JhcCBpbiAid2l0aCgkd2hhdGV2ZXIua29CaW5kaW5nQ29udGV4dCkgeyAuLi4gfSIKCSAgICAgICAgICAgICAgICB0ZW1wbGF0ZVRleHQgPSAie3trb193aXRoICRpdGVtLmtvQmluZGluZ0NvbnRleHR9fSIgKyB0ZW1wbGF0ZVRleHQgKyAie3sva29fd2l0aH19IjsKCgkgICAgICAgICAgICAgICAgcHJlY29tcGlsZWQgPSBqUXVlcnlJbnN0YW5jZVsndGVtcGxhdGUnXShudWxsLCB0ZW1wbGF0ZVRleHQpOwoJICAgICAgICAgICAgICAgIHRlbXBsYXRlU291cmNlWydkYXRhJ10oJ3ByZWNvbXBpbGVkJywgcHJlY29tcGlsZWQpOwoJICAgICAgICAgICAgfQoKCSAgICAgICAgICAgIHZhciBkYXRhID0gW2JpbmRpbmdDb250ZXh0WyckZGF0YSddXTsgLy8gUHJld3JhcCB0aGUgZGF0YSBpbiBhbiBhcnJheSB0byBzdG9wIGpxdWVyeS50bXBsIGZyb20gdHJ5aW5nIHRvIHVud3JhcCBhbnkgYXJyYXlzCgkgICAgICAgICAgICB2YXIgalF1ZXJ5VGVtcGxhdGVPcHRpb25zID0galF1ZXJ5SW5zdGFuY2VbJ2V4dGVuZCddKHsgJ2tvQmluZGluZ0NvbnRleHQnOiBiaW5kaW5nQ29udGV4dCB9LCBvcHRpb25zWyd0ZW1wbGF0ZU9wdGlvbnMnXSk7CgoJICAgICAgICAgICAgdmFyIHJlc3VsdE5vZGVzID0gZXhlY3V0ZVRlbXBsYXRlKHByZWNvbXBpbGVkLCBkYXRhLCBqUXVlcnlUZW1wbGF0ZU9wdGlvbnMpOwoJICAgICAgICAgICAgcmVzdWx0Tm9kZXNbJ2FwcGVuZFRvJ10oZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2IikpOyAvLyBVc2luZyAiYXBwZW5kVG8iIGZvcmNlcyBqUXVlcnkvalF1ZXJ5LnRtcGwgdG8gcGVyZm9ybSBuZWNlc3NhcnkgY2xlYW51cCB3b3JrCgoJICAgICAgICAgICAgalF1ZXJ5SW5zdGFuY2VbJ2ZyYWdtZW50cyddID0ge307IC8vIENsZWFyIGpRdWVyeSdzIGZyYWdtZW50IGNhY2hlIHRvIGF2b2lkIGEgbWVtb3J5IGxlYWsgYWZ0ZXIgYSBsYXJnZSBudW1iZXIgb2YgdGVtcGxhdGUgcmVuZGVycwoJICAgICAgICAgICAgcmV0dXJuIHJlc3VsdE5vZGVzOwoJICAgICAgICB9OwoKCSAgICAgICAgdGhpc1snY3JlYXRlSmF2YVNjcmlwdEV2YWx1YXRvckJsb2NrJ10gPSBmdW5jdGlvbihzY3JpcHQpIHsKCSAgICAgICAgICAgIHJldHVybiAie3trb19jb2RlICgoZnVuY3Rpb24oKSB7IHJldHVybiAiICsgc2NyaXB0ICsgIiB9KSgpKSB9fSI7CgkgICAgICAgIH07CgoJICAgICAgICB0aGlzWydhZGRUZW1wbGF0ZSddID0gZnVuY3Rpb24odGVtcGxhdGVOYW1lLCB0ZW1wbGF0ZU1hcmt1cCkgewoJICAgICAgICAgICAgZG9jdW1lbnQud3JpdGUoIjxzY3JpcHQgdHlwZT0ndGV4dC9odG1sJyBpZD0nIiArIHRlbXBsYXRlTmFtZSArICInPiIgKyB0ZW1wbGF0ZU1hcmt1cCArICI8IiArICIvc2NyaXB0PiIpOwoJICAgICAgICB9OwoKCSAgICAgICAgaWYgKGpRdWVyeVRtcGxWZXJzaW9uID4gMCkgewoJICAgICAgICAgICAgalF1ZXJ5SW5zdGFuY2VbJ3RtcGwnXVsndGFnJ11bJ2tvX2NvZGUnXSA9IHsKCSAgICAgICAgICAgICAgICBvcGVuOiAiX18ucHVzaCgkMSB8fCAnJyk7IgoJICAgICAgICAgICAgfTsKCSAgICAgICAgICAgIGpRdWVyeUluc3RhbmNlWyd0bXBsJ11bJ3RhZyddWydrb193aXRoJ10gPSB7CgkgICAgICAgICAgICAgICAgb3BlbjogIndpdGgoJDEpIHsiLAoJICAgICAgICAgICAgICAgIGNsb3NlOiAifSAiCgkgICAgICAgICAgICB9OwoJICAgICAgICB9CgkgICAgfTsKCgkgICAga28uanF1ZXJ5VG1wbFRlbXBsYXRlRW5naW5lLnByb3RvdHlwZSA9IG5ldyBrby50ZW1wbGF0ZUVuZ2luZSgpOwoJICAgIGtvLmpxdWVyeVRtcGxUZW1wbGF0ZUVuZ2luZS5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBrby5qcXVlcnlUbXBsVGVtcGxhdGVFbmdpbmU7CgoJICAgIC8vIFVzZSB0aGlzIG9uZSBieSBkZWZhdWx0ICpvbmx5IGlmIGpxdWVyeS50bXBsIGlzIHJlZmVyZW5jZWQqCgkgICAgdmFyIGpxdWVyeVRtcGxUZW1wbGF0ZUVuZ2luZUluc3RhbmNlID0gbmV3IGtvLmpxdWVyeVRtcGxUZW1wbGF0ZUVuZ2luZSgpOwoJICAgIGlmIChqcXVlcnlUbXBsVGVtcGxhdGVFbmdpbmVJbnN0YW5jZS5qUXVlcnlUbXBsVmVyc2lvbiA+IDApCgkgICAgICAgIGtvLnNldFRlbXBsYXRlRW5naW5lKGpxdWVyeVRtcGxUZW1wbGF0ZUVuZ2luZUluc3RhbmNlKTsKCgkgICAga28uZXhwb3J0U3ltYm9sKCdqcXVlcnlUbXBsVGVtcGxhdGVFbmdpbmUnLCBrby5qcXVlcnlUbXBsVGVtcGxhdGVFbmdpbmUpOwoJfSkoKTsKCX0pKTsKCX0oKSk7Cgl9KSgpOwoKCi8qKiovIH0KLyoqKioqKi8gXSkKfSk7Cg==",
                "body": "LyoKICBrbm9ja2JhY2stY29yZS1zdGFjay5qcyAwLjIwLjQKICBDb3B5cmlnaHQgKGMpICAyMDExLTIwMTQgS2V2aW4gTWFsYWtvZmYuCiAgTGljZW5zZTogTUlUIChodHRwOi8vd3d3Lm9wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL21pdC1saWNlbnNlLnBocCkKICBTb3VyY2U6IGh0dHBzOi8vZ2l0aHViLmNvbS9rbWFsYWtvZmYva25vY2tiYWNrCiAgRGVwZW5kZW5jaWVzOiBLbm9ja291dC5qcywgQmFja2JvbmUuanMsIGFuZCBVbmRlcnNjb3JlLmpzIChvciBMb0Rhc2guanMpLgogIE9wdGlvbmFsIGRlcGVuZGVuY2llczogQmFja2JvbmUuTW9kZWxSZWYuanMgYW5kIEJhY2tib25lT1JNLgoqLwooZnVuY3Rpb24gd2VicGFja1VuaXZlcnNhbE1vZHVsZURlZmluaXRpb24ocm9vdCwgZmFjdG9yeSkgewoJaWYodHlwZW9mIGV4cG9ydHMgPT09ICdvYmplY3QnICYmIHR5cGVvZiBtb2R1bGUgPT09ICdvYmplY3QnKQoJCW1vZHVsZS5leHBvcnRzID0gZmFjdG9yeShyZXF1aXJlKCJqcXVlcnkiKSk7CgllbHNlIGlmKHR5cGVvZiBkZWZpbmUgPT09ICdmdW5jdGlvbicgJiYgZGVmaW5lLmFtZCkKCQlkZWZpbmUoWyJqcXVlcnkiXSwgZmFjdG9yeSk7CgllbHNlIGlmKHR5cGVvZiBleHBvcnRzID09PSAnb2JqZWN0JykKCQlleHBvcnRzWyJrYiJdID0gZmFjdG9yeShyZXF1aXJlKCJqcXVlcnkiKSk7CgllbHNlCgkJcm9vdFsia2IiXSA9IGZhY3Rvcnkocm9vdFsialF1ZXJ5Il0pOwp9KSh0aGlzLCBmdW5jdGlvbihfX1dFQlBBQ0tfRVhURVJOQUxfTU9EVUxFXzE1X18pIHsKcmV0dXJuIC8qKioqKiovIChmdW5jdGlvbihtb2R1bGVzKSB7IC8vIHdlYnBhY2tCb290c3RyYXAKLyoqKioqKi8gCS8vIFRoZSBtb2R1bGUgY2FjaGUKLyoqKioqKi8gCXZhciBpbnN0YWxsZWRNb2R1bGVzID0ge307Ci8qKioqKiovCi8qKioqKiovIAkvLyBUaGUgcmVxdWlyZSBmdW5jdGlvbgovKioqKioqLyAJZnVuY3Rpb24gX193ZWJwYWNrX3JlcXVpcmVfXyhtb2R1bGVJZCkgewovKioqKioqLwovKioqKioqLyAJCS8vIENoZWNrIGlmIG1vZHVsZSBpcyBpbiBjYWNoZQovKioqKioqLyAJCWlmKGluc3RhbGxlZE1vZHVsZXNbbW9kdWxlSWRdKQovKioqKioqLyAJCQlyZXR1cm4gaW5zdGFsbGVkTW9kdWxlc1ttb2R1bGVJZF0uZXhwb3J0czsKLyoqKioqKi8KLyoqKioqKi8gCQkvLyBDcmVhdGUgYSBuZXcgbW9kdWxlIChhbmQgcHV0IGl0IGludG8gdGhlIGNhY2hlKQovKioqKioqLyAJCXZhciBtb2R1bGUgPSBpbnN0YWxsZWRNb2R1bGVzW21vZHVsZUlkXSA9IHsKLyoqKioqKi8gCQkJZXhwb3J0czoge30sCi8qKioqKiovIAkJCWlkOiBtb2R1bGVJZCwKLyoqKioqKi8gCQkJbG9hZGVkOiBmYWxzZQovKioqKioqLyAJCX07Ci8qKioqKiovCi8qKioqKiovIAkJLy8gRXhlY3V0ZSB0aGUgbW9kdWxlIGZ1bmN0aW9uCi8qKioqKiovIAkJbW9kdWxlc1ttb2R1bGVJZF0uY2FsbChtb2R1bGUuZXhwb3J0cywgbW9kdWxlLCBtb2R1bGUuZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXyk7Ci8qKioqKiovCi8qKioqKiovIAkJLy8gRmxhZyB0aGUgbW9kdWxlIGFzIGxvYWRlZAovKioqKioqLyAJCW1vZHVsZS5sb2FkZWQgPSB0cnVlOwovKioqKioqLwovKioqKioqLyAJCS8vIFJldHVybiB0aGUgZXhwb3J0cyBvZiB0aGUgbW9kdWxlCi8qKioqKiovIAkJcmV0dXJuIG1vZHVsZS5leHBvcnRzOwovKioqKioqLyAJfQovKioqKioqLwovKioqKioqLwovKioqKioqLyAJLy8gZXhwb3NlIHRoZSBtb2R1bGVzIG9iamVjdCAoX193ZWJwYWNrX21vZHVsZXNfXykKLyoqKioqKi8gCV9fd2VicGFja19yZXF1aXJlX18ubSA9IG1vZHVsZXM7Ci8qKioqKiovCi8qKioqKiovIAkvLyBleHBvc2UgdGhlIG1vZHVsZSBjYWNoZQovKioqKioqLyAJX193ZWJwYWNrX3JlcXVpcmVfXy5jID0gaW5zdGFsbGVkTW9kdWxlczsKLyoqKioqKi8KLyoqKioqKi8gCS8vIF9fd2VicGFja19wdWJsaWNfcGF0aF9fCi8qKioqKiovIAlfX3dlYnBhY2tfcmVxdWlyZV9fLnAgPSAiIjsKLyoqKioqKi8KLyoqKioqKi8gCS8vIExvYWQgZW50cnkgbW9kdWxlIGFuZCByZXR1cm4gZXhwb3J0cwovKioqKioqLyAJcmV0dXJuIF9fd2VicGFja19yZXF1aXJlX18oMCk7Ci8qKioqKiovIH0pCi8qKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKiovCi8qKioqKiovIChbCi8qIDAgKi8KLyoqKi8gZnVuY3Rpb24obW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CgoJX193ZWJwYWNrX3JlcXVpcmVfXygxKTsKCV9fd2VicGFja19yZXF1aXJlX18oMik7CglfX3dlYnBhY2tfcmVxdWlyZV9fKDMpOwoJX193ZWJwYWNrX3JlcXVpcmVfXyg0KTsKCV9fd2VicGFja19yZXF1aXJlX18oNSk7CglfX3dlYnBhY2tfcmVxdWlyZV9fKDYpOwoJX193ZWJwYWNrX3JlcXVpcmVfXyg3KTsKCV9fd2VicGFja19yZXF1aXJlX18oOCk7CglfX3dlYnBhY2tfcmVxdWlyZV9fKDkpOwoJX193ZWJwYWNrX3JlcXVpcmVfXygxMCk7CglfX3dlYnBhY2tfcmVxdWlyZV9fKDExKTsKCV9fd2VicGFja19yZXF1aXJlX18oMTIpOwoJX193ZWJwYWNrX3JlcXVpcmVfXygxMyk7Cgltb2R1bGUuZXhwb3J0cyA9IF9fd2VicGFja19yZXF1aXJlX18oMTQpOwoKCi8qKiovIH0sCi8qIDEgKi8KLyoqKi8gZnVuY3Rpb24obW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CgoJCgkvKgoJICBrbm9ja2JhY2suanMgMC4yMC40CgkgIENvcHlyaWdodCAoYykgIDIwMTEtMjAxNCBLZXZpbiBNYWxha29mZi4KCSAgTGljZW5zZTogTUlUIChodHRwOi8vd3d3Lm9wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL21pdC1saWNlbnNlLnBocCkKCSAgU291cmNlOiBodHRwczovL2dpdGh1Yi5jb20va21hbGFrb2ZmL2tub2NrYmFjawoJICBEZXBlbmRlbmNpZXM6IEtub2Nrb3V0LmpzLCBCYWNrYm9uZS5qcywgYW5kIFVuZGVyc2NvcmUuanMgKG9yIExvRGFzaC5qcykuCgkgIE9wdGlvbmFsIGRlcGVuZGVuY2llczogQmFja2JvbmUuTW9kZWxSZWYuanMgYW5kIEJhY2tib25lT1JNLgoJICovCgl2YXIgQ09NUEFSRV9BU0NFTkRJTkcsIENPTVBBUkVfREVTQ0VORElORywgQ09NUEFSRV9FUVVBTCwgS0VZU19QVUJMSVNILCBrYiwga28sIF8sIF9yZWYsCgkgIF9fYmluZCA9IGZ1bmN0aW9uKGZuLCBtZSl7IHJldHVybiBmdW5jdGlvbigpeyByZXR1cm4gZm4uYXBwbHkobWUsIGFyZ3VtZW50cyk7IH07IH0sCgkgIF9faW5kZXhPZiA9IFtdLmluZGV4T2YgfHwgZnVuY3Rpb24oaXRlbSkgeyBmb3IgKHZhciBpID0gMCwgbCA9IHRoaXMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7IGlmIChpIGluIHRoaXMgJiYgdGhpc1tpXSA9PT0gaXRlbSkgcmV0dXJuIGk7IH0gcmV0dXJuIC0xOyB9OwoKCV9yZWYgPSBrYiA9IF9fd2VicGFja19yZXF1aXJlX18oNiksIF8gPSBfcmVmLl8sIGtvID0gX3JlZi5rbzsKCglDT01QQVJFX0VRVUFMID0gMDsKCglDT01QQVJFX0FTQ0VORElORyA9IC0xOwoKCUNPTVBBUkVfREVTQ0VORElORyA9IDE7CgoJS0VZU19QVUJMSVNIID0gWydkZXN0cm95JywgJ3NoYXJlT3B0aW9ucycsICdmaWx0ZXJzJywgJ2NvbXBhcmF0b3InLCAnc29ydEF0dHJpYnV0ZScsICd2aWV3TW9kZWxCeU1vZGVsJywgJ2hhc1ZpZXdNb2RlbHMnXTsKCglrYi5jb21wYXJlID0gZnVuY3Rpb24odmFsdWVfYSwgdmFsdWVfYikgewoJICBpZiAoXy5pc1N0cmluZyh2YWx1ZV9hKSkgewoJICAgIHJldHVybiB2YWx1ZV9hLmxvY2FsZUNvbXBhcmUoIiIgKyB2YWx1ZV9iKTsKCSAgfQoJICBpZiAoXy5pc1N0cmluZyh2YWx1ZV9iKSkgewoJICAgIHJldHVybiB2YWx1ZV9iLmxvY2FsZUNvbXBhcmUoIiIgKyB2YWx1ZV9hKTsKCSAgfQoJICBpZiAodmFsdWVfYSA9PT0gdmFsdWVfYikgewoJICAgIHJldHVybiBDT01QQVJFX0VRVUFMOwoJICB9IGVsc2UgewoJICAgIGlmICh2YWx1ZV9hIDwgdmFsdWVfYikgewoJICAgICAgcmV0dXJuIENPTVBBUkVfQVNDRU5ESU5HOwoJICAgIH0gZWxzZSB7CgkgICAgICByZXR1cm4gQ09NUEFSRV9ERVNDRU5ESU5HOwoJICAgIH0KCSAgfQoJfTsKCglrYi5Db2xsZWN0aW9uT2JzZXJ2YWJsZSA9IChmdW5jdGlvbigpIHsKCSAgQ29sbGVjdGlvbk9ic2VydmFibGUuZXh0ZW5kID0ga2IuZXh0ZW5kOwoKCSAgZnVuY3Rpb24gQ29sbGVjdGlvbk9ic2VydmFibGUoY29sbGVjdGlvbiwgdmlld19tb2RlbCwgb3B0aW9ucykgewoJICAgIHRoaXMuX29uQ29sbGVjdGlvbkNoYW5nZSA9IF9fYmluZCh0aGlzLl9vbkNvbGxlY3Rpb25DaGFuZ2UsIHRoaXMpOwoJICAgIHZhciBhcmdzOwoJICAgIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChfLmlzQXJndW1lbnRzKGNvbGxlY3Rpb24pID8gY29sbGVjdGlvbiA6IGFyZ3VtZW50cyk7CgkgICAgcmV0dXJuIGtiLmlnbm9yZSgoZnVuY3Rpb24oX3RoaXMpIHsKCSAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKCSAgICAgICAgdmFyIGFyZywgY3JlYXRlX29wdGlvbnMsIG9ic2VydmFibGUsIF9pLCBfbGVuOwoJICAgICAgICBjb2xsZWN0aW9uID0gYXJnc1swXSBpbnN0YW5jZW9mIGtiLkNvbGxlY3Rpb24gPyBhcmdzLnNoaWZ0KCkgOiAoXy5pc0FycmF5KGFyZ3NbMF0pID8gbmV3IGtiLkNvbGxlY3Rpb24oYXJncy5zaGlmdCgpKSA6IG5ldyBrYi5Db2xsZWN0aW9uKCkpOwoJICAgICAgICBpZiAoXy5pc0Z1bmN0aW9uKGFyZ3NbMF0pKSB7CgkgICAgICAgICAgYXJnc1swXSA9IHsKCSAgICAgICAgICAgIHZpZXdfbW9kZWw6IGFyZ3NbMF0KCSAgICAgICAgICB9OwoJICAgICAgICB9CgkgICAgICAgIG9wdGlvbnMgPSB7fTsKCSAgICAgICAgZm9yIChfaSA9IDAsIF9sZW4gPSBhcmdzLmxlbmd0aDsgX2kgPCBfbGVuOyBfaSsrKSB7CgkgICAgICAgICAgYXJnID0gYXJnc1tfaV07CgkgICAgICAgICAgXy5leHRlbmQob3B0aW9ucywgYXJnKTsKCSAgICAgICAgfQoJICAgICAgICBvYnNlcnZhYmxlID0ga2IudXRpbHMud3JhcHBlZE9ic2VydmFibGUoX3RoaXMsIGtvLm9ic2VydmFibGVBcnJheShbXSkpOwoJICAgICAgICBvYnNlcnZhYmxlLl9fa2JfaXNfY28gPSB0cnVlOwoJICAgICAgICBfdGhpcy5pbl9lZGl0ID0gMDsKCSAgICAgICAgX3RoaXMuX19rYiB8fCAoX3RoaXMuX19rYiA9IHt9KTsKCSAgICAgICAgb3B0aW9ucyA9IGtiLnV0aWxzLmNvbGxhcHNlT3B0aW9ucyhvcHRpb25zKTsKCSAgICAgICAgaWYgKG9wdGlvbnMuYXV0b19jb21wYWN0KSB7CgkgICAgICAgICAgX3RoaXMuYXV0b19jb21wYWN0ID0gdHJ1ZTsKCSAgICAgICAgfQoJICAgICAgICBpZiAob3B0aW9ucy5zb3J0X2F0dHJpYnV0ZSkgewoJICAgICAgICAgIF90aGlzLl9jb21wYXJhdG9yID0ga28ub2JzZXJ2YWJsZShfdGhpcy5fYXR0cmlidXRlQ29tcGFyYXRvcihvcHRpb25zLnNvcnRfYXR0cmlidXRlKSk7CgkgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgX3RoaXMuX2NvbXBhcmF0b3IgPSBrby5vYnNlcnZhYmxlKG9wdGlvbnMuY29tcGFyYXRvcik7CgkgICAgICAgIH0KCSAgICAgICAgaWYgKG9wdGlvbnMuZmlsdGVycykgewoJICAgICAgICAgIF90aGlzLl9maWx0ZXJzID0ga28ub2JzZXJ2YWJsZUFycmF5KF8uaXNBcnJheShvcHRpb25zLmZpbHRlcnMpID8gb3B0aW9ucy5maWx0ZXJzIDogb3B0aW9ucy5maWx0ZXJzID8gW29wdGlvbnMuZmlsdGVyc10gOiB2b2lkIDApOwoJICAgICAgICB9IGVsc2UgewoJICAgICAgICAgIF90aGlzLl9maWx0ZXJzID0ga28ub2JzZXJ2YWJsZUFycmF5KFtdKTsKCSAgICAgICAgfQoJICAgICAgICBjcmVhdGVfb3B0aW9ucyA9IF90aGlzLmNyZWF0ZV9vcHRpb25zID0gewoJICAgICAgICAgIHN0b3JlOiBrYi5TdG9yZS51c2VPcHRpb25zT3JDcmVhdGUob3B0aW9ucywgY29sbGVjdGlvbiwgb2JzZXJ2YWJsZSkKCSAgICAgICAgfTsKCSAgICAgICAga2IudXRpbHMud3JhcHBlZE9iamVjdChvYnNlcnZhYmxlLCBjb2xsZWN0aW9uKTsKCSAgICAgICAgX3RoaXMucGF0aCA9IG9wdGlvbnMucGF0aDsKCSAgICAgICAgY3JlYXRlX29wdGlvbnMuZmFjdG9yeSA9IGtiLnV0aWxzLndyYXBwZWRGYWN0b3J5KG9ic2VydmFibGUsIF90aGlzLl9zaGFyZU9yQ3JlYXRlRmFjdG9yeShvcHRpb25zKSk7CgkgICAgICAgIGNyZWF0ZV9vcHRpb25zLnBhdGggPSBrYi51dGlscy5wYXRoSm9pbihvcHRpb25zLnBhdGgsICdtb2RlbHMnKTsKCSAgICAgICAgY3JlYXRlX29wdGlvbnMuY3JlYXRvciA9IGNyZWF0ZV9vcHRpb25zLmZhY3RvcnkuY3JlYXRvckZvclBhdGgobnVsbCwgY3JlYXRlX29wdGlvbnMucGF0aCk7CgkgICAgICAgIGlmIChjcmVhdGVfb3B0aW9ucy5jcmVhdG9yKSB7CgkgICAgICAgICAgX3RoaXMubW9kZWxzX29ubHkgPSBjcmVhdGVfb3B0aW9ucy5jcmVhdG9yLm1vZGVsc19vbmx5OwoJICAgICAgICB9CgkgICAgICAgIGtiLnB1Ymxpc2hNZXRob2RzKG9ic2VydmFibGUsIF90aGlzLCBLRVlTX1BVQkxJU0gpOwoJICAgICAgICBfdGhpcy5fY29sbGVjdGlvbiA9IGtvLm9ic2VydmFibGUoY29sbGVjdGlvbik7CgkgICAgICAgIG9ic2VydmFibGUuY29sbGVjdGlvbiA9IF90aGlzLmNvbGxlY3Rpb24gPSBrby5jb21wdXRlZCh7CgkgICAgICAgICAgcmVhZDogZnVuY3Rpb24oKSB7CgkgICAgICAgICAgICByZXR1cm4gX3RoaXMuX2NvbGxlY3Rpb24oKTsKCSAgICAgICAgICB9LAoJICAgICAgICAgIHdyaXRlOiBmdW5jdGlvbihuZXdfY29sbGVjdGlvbikgewoJICAgICAgICAgICAgcmV0dXJuIGtiLmlnbm9yZShmdW5jdGlvbigpIHsKCSAgICAgICAgICAgICAgdmFyIHByZXZpb3VzX2NvbGxlY3Rpb247CgkgICAgICAgICAgICAgIGlmICgocHJldmlvdXNfY29sbGVjdGlvbiA9IF90aGlzLl9jb2xsZWN0aW9uKCkpID09PSBuZXdfY29sbGVjdGlvbikgewoJICAgICAgICAgICAgICAgIHJldHVybjsKCSAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICBrYi51dGlscy53cmFwcGVkT2JqZWN0KG9ic2VydmFibGUsIG5ld19jb2xsZWN0aW9uKTsKCSAgICAgICAgICAgICAgaWYgKHByZXZpb3VzX2NvbGxlY3Rpb24pIHsKCSAgICAgICAgICAgICAgICBwcmV2aW91c19jb2xsZWN0aW9uLnVuYmluZCgnYWxsJywgX3RoaXMuX29uQ29sbGVjdGlvbkNoYW5nZSk7CgkgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgaWYgKG5ld19jb2xsZWN0aW9uKSB7CgkgICAgICAgICAgICAgICAgbmV3X2NvbGxlY3Rpb24uYmluZCgnYWxsJywgX3RoaXMuX29uQ29sbGVjdGlvbkNoYW5nZSk7CgkgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgcmV0dXJuIF90aGlzLl9jb2xsZWN0aW9uKG5ld19jb2xsZWN0aW9uKTsKCSAgICAgICAgICAgIH0pOwoJICAgICAgICAgIH0KCSAgICAgICAgfSk7CgkgICAgICAgIGlmIChjb2xsZWN0aW9uKSB7CgkgICAgICAgICAgY29sbGVjdGlvbi5iaW5kKCdhbGwnLCBfdGhpcy5fb25Db2xsZWN0aW9uQ2hhbmdlKTsKCSAgICAgICAgfQoJICAgICAgICBfdGhpcy5fbWFwcGVyID0ga28uY29tcHV0ZWQoZnVuY3Rpb24oKSB7CgkgICAgICAgICAgdmFyIGNvbXBhcmF0b3IsIGN1cnJlbnRfY29sbGVjdGlvbiwgZmlsdGVyLCBmaWx0ZXJzLCBtb2RlbHMsIHByZXZpb3VzX3ZpZXdfbW9kZWxzLCB2aWV3X21vZGVscywgX2osIF9sZW4xOwoJICAgICAgICAgIGNvbXBhcmF0b3IgPSBfdGhpcy5fY29tcGFyYXRvcigpOwoJICAgICAgICAgIGZpbHRlcnMgPSBfdGhpcy5fZmlsdGVycygpOwoJICAgICAgICAgIGlmIChmaWx0ZXJzKSB7CgkgICAgICAgICAgICBmb3IgKF9qID0gMCwgX2xlbjEgPSBmaWx0ZXJzLmxlbmd0aDsgX2ogPCBfbGVuMTsgX2orKykgewoJICAgICAgICAgICAgICBmaWx0ZXIgPSBmaWx0ZXJzW19qXTsKCSAgICAgICAgICAgICAga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZShmaWx0ZXIpOwoJICAgICAgICAgICAgfQoJICAgICAgICAgIH0KCSAgICAgICAgICBjdXJyZW50X2NvbGxlY3Rpb24gPSBfdGhpcy5fY29sbGVjdGlvbigpOwoJICAgICAgICAgIGlmIChfdGhpcy5pbl9lZGl0KSB7CgkgICAgICAgICAgICByZXR1cm47CgkgICAgICAgICAgfQoJICAgICAgICAgIG9ic2VydmFibGUgPSBrYi51dGlscy53cmFwcGVkT2JzZXJ2YWJsZShfdGhpcyk7CgkgICAgICAgICAgcHJldmlvdXNfdmlld19tb2RlbHMgPSBrYi5wZWVrKG9ic2VydmFibGUpOwoJICAgICAgICAgIGlmIChjdXJyZW50X2NvbGxlY3Rpb24pIHsKCSAgICAgICAgICAgIG1vZGVscyA9IGN1cnJlbnRfY29sbGVjdGlvbi5tb2RlbHM7CgkgICAgICAgICAgfQoJICAgICAgICAgIGlmICghbW9kZWxzIHx8IChjdXJyZW50X2NvbGxlY3Rpb24ubW9kZWxzLmxlbmd0aCA9PT0gMCkpIHsKCSAgICAgICAgICAgIHZpZXdfbW9kZWxzID0gW107CgkgICAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgIG1vZGVscyA9IF8uZmlsdGVyKG1vZGVscywgZnVuY3Rpb24obW9kZWwpIHsKCSAgICAgICAgICAgICAgcmV0dXJuICFmaWx0ZXJzLmxlbmd0aCB8fCBfdGhpcy5fc2VsZWN0TW9kZWwobW9kZWwpOwoJICAgICAgICAgICAgfSk7CgkgICAgICAgICAgICBpZiAoY29tcGFyYXRvcikgewoJICAgICAgICAgICAgICB2aWV3X21vZGVscyA9IF8ubWFwKG1vZGVscywgZnVuY3Rpb24obW9kZWwpIHsKCSAgICAgICAgICAgICAgICByZXR1cm4gX3RoaXMuX2NyZWF0ZVZpZXdNb2RlbChtb2RlbCk7CgkgICAgICAgICAgICAgIH0pLnNvcnQoY29tcGFyYXRvcik7CgkgICAgICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgICBpZiAoX3RoaXMubW9kZWxzX29ubHkpIHsKCSAgICAgICAgICAgICAgICB2aWV3X21vZGVscyA9IGZpbHRlcnMubGVuZ3RoID8gbW9kZWxzIDogbW9kZWxzLnNsaWNlKCk7CgkgICAgICAgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICAgICAgdmlld19tb2RlbHMgPSBfLm1hcChtb2RlbHMsIGZ1bmN0aW9uKG1vZGVsKSB7CgkgICAgICAgICAgICAgICAgICByZXR1cm4gX3RoaXMuX2NyZWF0ZVZpZXdNb2RlbChtb2RlbCk7CgkgICAgICAgICAgICAgICAgfSk7CgkgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgIH0KCSAgICAgICAgICB9CgkgICAgICAgICAgX3RoaXMuaW5fZWRpdCsrOwoJICAgICAgICAgIG9ic2VydmFibGUodmlld19tb2RlbHMpOwoJICAgICAgICAgIF90aGlzLmluX2VkaXQtLTsKCSAgICAgICAgfSk7CgkgICAgICAgIG9ic2VydmFibGUuc3Vic2NyaWJlKF8uYmluZChfdGhpcy5fb25PYnNlcnZhYmxlQXJyYXlDaGFuZ2UsIF90aGlzKSk7CgkgICAgICAgICFrYi5zdGF0aXN0aWNzIHx8IGtiLnN0YXRpc3RpY3MucmVnaXN0ZXIoJ0NvbGxlY3Rpb25PYnNlcnZhYmxlJywgX3RoaXMpOwoJICAgICAgICByZXR1cm4gb2JzZXJ2YWJsZTsKCSAgICAgIH07CgkgICAgfSkodGhpcykpOwoJICB9CgoJICBDb2xsZWN0aW9uT2JzZXJ2YWJsZS5wcm90b3R5cGUuZGVzdHJveSA9IGZ1bmN0aW9uKCkgewoJICAgIHZhciBhcnJheSwgY29sbGVjdGlvbiwgb2JzZXJ2YWJsZTsKCSAgICB0aGlzLl9fa2JfcmVsZWFzZWQgPSB0cnVlOwoJICAgIG9ic2VydmFibGUgPSBrYi51dGlscy53cmFwcGVkT2JzZXJ2YWJsZSh0aGlzKTsKCSAgICBjb2xsZWN0aW9uID0ga2IucGVlayh0aGlzLl9jb2xsZWN0aW9uKTsKCSAgICBrYi51dGlscy53cmFwcGVkT2JqZWN0KG9ic2VydmFibGUsIG51bGwpOwoJICAgIGlmIChjb2xsZWN0aW9uKSB7CgkgICAgICBjb2xsZWN0aW9uLnVuYmluZCgnYWxsJywgdGhpcy5fb25Db2xsZWN0aW9uQ2hhbmdlKTsKCSAgICAgIGFycmF5ID0ga2IucGVlayhvYnNlcnZhYmxlKTsKCSAgICAgIGFycmF5LnNwbGljZSgwLCBhcnJheS5sZW5ndGgpOwoJICAgIH0KCSAgICB0aGlzLmNvbGxlY3Rpb24uZGlzcG9zZSgpOwoJICAgIHRoaXMuX2NvbGxlY3Rpb24gPSBvYnNlcnZhYmxlLmNvbGxlY3Rpb24gPSB0aGlzLmNvbGxlY3Rpb24gPSBudWxsOwoJICAgIHRoaXMuX21hcHBlci5kaXNwb3NlKCk7CgkgICAgdGhpcy5fbWFwcGVyID0gbnVsbDsKCSAgICBrYi5yZWxlYXNlKHRoaXMuX2ZpbHRlcnMpOwoJICAgIHRoaXMuX2ZpbHRlcnMgPSBudWxsOwoJICAgIHRoaXMuX2NvbXBhcmF0b3IobnVsbCk7CgkgICAgdGhpcy5fY29tcGFyYXRvciA9IG51bGw7CgkgICAgdGhpcy5jcmVhdGVfb3B0aW9ucyA9IG51bGw7CgkgICAgb2JzZXJ2YWJsZS5jb2xsZWN0aW9uID0gbnVsbDsKCSAgICBrYi51dGlscy53cmFwcGVkRGVzdHJveSh0aGlzKTsKCSAgICByZXR1cm4gIWtiLnN0YXRpc3RpY3MgfHwga2Iuc3RhdGlzdGljcy51bnJlZ2lzdGVyKCdDb2xsZWN0aW9uT2JzZXJ2YWJsZScsIHRoaXMpOwoJICB9OwoKCSAgQ29sbGVjdGlvbk9ic2VydmFibGUucHJvdG90eXBlLnNoYXJlT3B0aW9ucyA9IGZ1bmN0aW9uKCkgewoJICAgIHZhciBvYnNlcnZhYmxlOwoJICAgIG9ic2VydmFibGUgPSBrYi51dGlscy53cmFwcGVkT2JzZXJ2YWJsZSh0aGlzKTsKCSAgICByZXR1cm4gewoJICAgICAgc3RvcmU6IGtiLnV0aWxzLndyYXBwZWRTdG9yZShvYnNlcnZhYmxlKSwKCSAgICAgIGZhY3Rvcnk6IGtiLnV0aWxzLndyYXBwZWRGYWN0b3J5KG9ic2VydmFibGUpCgkgICAgfTsKCSAgfTsKCgkgIENvbGxlY3Rpb25PYnNlcnZhYmxlLnByb3RvdHlwZS5maWx0ZXJzID0gZnVuY3Rpb24oZmlsdGVycykgewoJICAgIGlmIChmaWx0ZXJzKSB7CgkgICAgICByZXR1cm4gdGhpcy5fZmlsdGVycyhfLmlzQXJyYXkoZmlsdGVycykgPyBmaWx0ZXJzIDogW2ZpbHRlcnNdKTsKCSAgICB9IGVsc2UgewoJICAgICAgcmV0dXJuIHRoaXMuX2ZpbHRlcnMoW10pOwoJICAgIH0KCSAgfTsKCgkgIENvbGxlY3Rpb25PYnNlcnZhYmxlLnByb3RvdHlwZS5jb21wYXJhdG9yID0gZnVuY3Rpb24oY29tcGFyYXRvcikgewoJICAgIHJldHVybiB0aGlzLl9jb21wYXJhdG9yKGNvbXBhcmF0b3IpOwoJICB9OwoKCSAgQ29sbGVjdGlvbk9ic2VydmFibGUucHJvdG90eXBlLnNvcnRBdHRyaWJ1dGUgPSBmdW5jdGlvbihzb3J0X2F0dHJpYnV0ZSkgewoJICAgIHJldHVybiB0aGlzLl9jb21wYXJhdG9yKHNvcnRfYXR0cmlidXRlID8gdGhpcy5fYXR0cmlidXRlQ29tcGFyYXRvcihzb3J0X2F0dHJpYnV0ZSkgOiBudWxsKTsKCSAgfTsKCgkgIENvbGxlY3Rpb25PYnNlcnZhYmxlLnByb3RvdHlwZS52aWV3TW9kZWxCeU1vZGVsID0gZnVuY3Rpb24obW9kZWwpIHsKCSAgICB2YXIgaWRfYXR0cmlidXRlOwoJICAgIGlmICh0aGlzLm1vZGVsc19vbmx5KSB7CgkgICAgICByZXR1cm4gbnVsbDsKCSAgICB9CgkgICAgaWRfYXR0cmlidXRlID0gbW9kZWwuaGFzT3duUHJvcGVydHkobW9kZWwuaWRBdHRyaWJ1dGUpID8gbW9kZWwuaWRBdHRyaWJ1dGUgOiAnY2lkJzsKCSAgICByZXR1cm4gXy5maW5kKGtiLnBlZWsoa2IudXRpbHMud3JhcHBlZE9ic2VydmFibGUodGhpcykpLCBmdW5jdGlvbih0ZXN0KSB7CgkgICAgICB2YXIgX3JlZjE7CgkgICAgICBpZiAodGVzdCAhPSBudWxsID8gKF9yZWYxID0gdGVzdC5fX2tiKSAhPSBudWxsID8gX3JlZjEub2JqZWN0IDogdm9pZCAwIDogdm9pZCAwKSB7CgkgICAgICAgIHJldHVybiB0ZXN0Ll9fa2Iub2JqZWN0W2lkX2F0dHJpYnV0ZV0gPT09IG1vZGVsW2lkX2F0dHJpYnV0ZV07CgkgICAgICB9IGVsc2UgewoJICAgICAgICByZXR1cm4gZmFsc2U7CgkgICAgICB9CgkgICAgfSk7CgkgIH07CgoJICBDb2xsZWN0aW9uT2JzZXJ2YWJsZS5wcm90b3R5cGUuaGFzVmlld01vZGVscyA9IGZ1bmN0aW9uKCkgewoJICAgIHJldHVybiAhdGhpcy5tb2RlbHNfb25seTsKCSAgfTsKCgkgIENvbGxlY3Rpb25PYnNlcnZhYmxlLnByb3RvdHlwZS5jb21wYWN0ID0gZnVuY3Rpb24oKSB7CgkgICAgcmV0dXJuIGtiLmlnbm9yZSgoZnVuY3Rpb24oX3RoaXMpIHsKCSAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKCSAgICAgICAgdmFyIG9ic2VydmFibGU7CgkgICAgICAgIG9ic2VydmFibGUgPSBrYi51dGlscy53cmFwcGVkT2JzZXJ2YWJsZShfdGhpcyk7CgkgICAgICAgIGlmICgha2IudXRpbHMud3JhcHBlZFN0b3JlSXNPd25lZChvYnNlcnZhYmxlKSkgewoJICAgICAgICAgIHJldHVybjsKCSAgICAgICAgfQoJICAgICAgICBrYi51dGlscy53cmFwcGVkU3RvcmUob2JzZXJ2YWJsZSkuY2xlYXIoKTsKCSAgICAgICAgcmV0dXJuIF90aGlzLl9jb2xsZWN0aW9uLm5vdGlmeVN1YnNjcmliZXJzKF90aGlzLl9jb2xsZWN0aW9uKCkpOwoJICAgICAgfTsKCSAgICB9KSh0aGlzKSk7CgkgIH07CgoJICBDb2xsZWN0aW9uT2JzZXJ2YWJsZS5wcm90b3R5cGUuX3NoYXJlT3JDcmVhdGVGYWN0b3J5ID0gZnVuY3Rpb24ob3B0aW9ucykgewoJICAgIHZhciBhYnNvbHV0ZV9tb2RlbHNfcGF0aCwgZXhpc3RpbmdfY3JlYXRvciwgZmFjdG9yaWVzLCBmYWN0b3J5OwoJICAgIGFic29sdXRlX21vZGVsc19wYXRoID0ga2IudXRpbHMucGF0aEpvaW4ob3B0aW9ucy5wYXRoLCAnbW9kZWxzJyk7CgkgICAgZmFjdG9yaWVzID0gb3B0aW9ucy5mYWN0b3JpZXM7CgkgICAgaWYgKChmYWN0b3J5ID0gb3B0aW9ucy5mYWN0b3J5KSkgewoJICAgICAgaWYgKChleGlzdGluZ19jcmVhdG9yID0gZmFjdG9yeS5jcmVhdG9yRm9yUGF0aChudWxsLCBhYnNvbHV0ZV9tb2RlbHNfcGF0aCkpICYmICghZmFjdG9yaWVzIHx8IChmYWN0b3JpZXNbJ21vZGVscyddID09PSBleGlzdGluZ19jcmVhdG9yKSkpIHsKCSAgICAgICAgaWYgKCFmYWN0b3JpZXMpIHsKCSAgICAgICAgICByZXR1cm4gZmFjdG9yeTsKCSAgICAgICAgfQoJICAgICAgICBpZiAoZmFjdG9yeS5oYXNQYXRoTWFwcGluZ3MoZmFjdG9yaWVzLCBvcHRpb25zLnBhdGgpKSB7CgkgICAgICAgICAgcmV0dXJuIGZhY3Rvcnk7CgkgICAgICAgIH0KCSAgICAgIH0KCSAgICB9CgkgICAgZmFjdG9yeSA9IG5ldyBrYi5GYWN0b3J5KG9wdGlvbnMuZmFjdG9yeSk7CgkgICAgaWYgKGZhY3RvcmllcykgewoJICAgICAgZmFjdG9yeS5hZGRQYXRoTWFwcGluZ3MoZmFjdG9yaWVzLCBvcHRpb25zLnBhdGgpOwoJICAgIH0KCSAgICBpZiAoIWZhY3RvcnkuY3JlYXRvckZvclBhdGgobnVsbCwgYWJzb2x1dGVfbW9kZWxzX3BhdGgpKSB7CgkgICAgICBpZiAob3B0aW9ucy5oYXNPd25Qcm9wZXJ0eSgnbW9kZWxzX29ubHknKSkgewoJICAgICAgICBpZiAob3B0aW9ucy5tb2RlbHNfb25seSkgewoJICAgICAgICAgIGZhY3RvcnkuYWRkUGF0aE1hcHBpbmcoYWJzb2x1dGVfbW9kZWxzX3BhdGgsIHsKCSAgICAgICAgICAgIG1vZGVsc19vbmx5OiB0cnVlCgkgICAgICAgICAgfSk7CgkgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgZmFjdG9yeS5hZGRQYXRoTWFwcGluZyhhYnNvbHV0ZV9tb2RlbHNfcGF0aCwga2IuVmlld01vZGVsKTsKCSAgICAgICAgfQoJICAgICAgfSBlbHNlIGlmIChvcHRpb25zLnZpZXdfbW9kZWwpIHsKCSAgICAgICAgZmFjdG9yeS5hZGRQYXRoTWFwcGluZyhhYnNvbHV0ZV9tb2RlbHNfcGF0aCwgb3B0aW9ucy52aWV3X21vZGVsKTsKCSAgICAgIH0gZWxzZSBpZiAob3B0aW9ucy5jcmVhdGUpIHsKCSAgICAgICAgZmFjdG9yeS5hZGRQYXRoTWFwcGluZyhhYnNvbHV0ZV9tb2RlbHNfcGF0aCwgewoJICAgICAgICAgIGNyZWF0ZTogb3B0aW9ucy5jcmVhdGUKCSAgICAgICAgfSk7CgkgICAgICB9IGVsc2UgewoJICAgICAgICBmYWN0b3J5LmFkZFBhdGhNYXBwaW5nKGFic29sdXRlX21vZGVsc19wYXRoLCBrYi5WaWV3TW9kZWwpOwoJICAgICAgfQoJICAgIH0KCSAgICByZXR1cm4gZmFjdG9yeTsKCSAgfTsKCgkgIENvbGxlY3Rpb25PYnNlcnZhYmxlLnByb3RvdHlwZS5fb25Db2xsZWN0aW9uQ2hhbmdlID0gZnVuY3Rpb24oZXZlbnQsIGFyZykgewoJICAgIHJldHVybiBrYi5pZ25vcmUoKGZ1bmN0aW9uKF90aGlzKSB7CgkgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CgkgICAgICAgIHZhciBjb2xsZWN0aW9uLCBjb21wYXJhdG9yLCBvYnNlcnZhYmxlLCB2aWV3X21vZGVsOwoJICAgICAgICBpZiAoX3RoaXMuaW5fZWRpdCkgewoJICAgICAgICAgIHJldHVybjsKCSAgICAgICAgfQoJICAgICAgICBzd2l0Y2ggKGV2ZW50KSB7CgkgICAgICAgICAgY2FzZSAncmVzZXQnOgoJICAgICAgICAgICAgaWYgKF90aGlzLmF1dG9fY29tcGFjdCkgewoJICAgICAgICAgICAgICBfdGhpcy5jb21wYWN0KCk7CgkgICAgICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgICBfdGhpcy5fY29sbGVjdGlvbi5ub3RpZnlTdWJzY3JpYmVycyhfdGhpcy5fY29sbGVjdGlvbigpKTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIGJyZWFrOwoJICAgICAgICAgIGNhc2UgJ3NvcnQnOgoJICAgICAgICAgIGNhc2UgJ3Jlc29ydCc6CgkgICAgICAgICAgICBfdGhpcy5fY29sbGVjdGlvbi5ub3RpZnlTdWJzY3JpYmVycyhfdGhpcy5fY29sbGVjdGlvbigpKTsKCSAgICAgICAgICAgIGJyZWFrOwoJICAgICAgICAgIGNhc2UgJ25ldyc6CgkgICAgICAgICAgY2FzZSAnYWRkJzoKCSAgICAgICAgICAgIGlmICghX3RoaXMuX3NlbGVjdE1vZGVsKGFyZykpIHsKCSAgICAgICAgICAgICAgcmV0dXJuOwoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgb2JzZXJ2YWJsZSA9IGtiLnV0aWxzLndyYXBwZWRPYnNlcnZhYmxlKF90aGlzKTsKCSAgICAgICAgICAgIGNvbGxlY3Rpb24gPSBfdGhpcy5fY29sbGVjdGlvbigpOwoJICAgICAgICAgICAgaWYgKGNvbGxlY3Rpb24uaW5kZXhPZihhcmcpID09PSAtMSkgewoJICAgICAgICAgICAgICByZXR1cm47CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICBpZiAoKHZpZXdfbW9kZWwgPSBfdGhpcy52aWV3TW9kZWxCeU1vZGVsKGFyZykpKSB7CgkgICAgICAgICAgICAgIHJldHVybjsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIF90aGlzLmluX2VkaXQrKzsKCSAgICAgICAgICAgIGlmICgoY29tcGFyYXRvciA9IF90aGlzLl9jb21wYXJhdG9yKCkpKSB7CgkgICAgICAgICAgICAgIG9ic2VydmFibGUoKS5wdXNoKF90aGlzLl9jcmVhdGVWaWV3TW9kZWwoYXJnKSk7CgkgICAgICAgICAgICAgIG9ic2VydmFibGUuc29ydChjb21wYXJhdG9yKTsKCSAgICAgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICAgIG9ic2VydmFibGUuc3BsaWNlKGNvbGxlY3Rpb24uaW5kZXhPZihhcmcpLCAwLCBfdGhpcy5fY3JlYXRlVmlld01vZGVsKGFyZykpOwoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgX3RoaXMuaW5fZWRpdC0tOwoJICAgICAgICAgICAgYnJlYWs7CgkgICAgICAgICAgY2FzZSAncmVtb3ZlJzoKCSAgICAgICAgICBjYXNlICdkZXN0cm95JzoKCSAgICAgICAgICAgIF90aGlzLl9vbk1vZGVsUmVtb3ZlKGFyZyk7CgkgICAgICAgICAgICBicmVhazsKCSAgICAgICAgICBjYXNlICdjaGFuZ2UnOgoJICAgICAgICAgICAgaWYgKCFfdGhpcy5fc2VsZWN0TW9kZWwoYXJnKSkgewoJICAgICAgICAgICAgICByZXR1cm4gX3RoaXMuX29uTW9kZWxSZW1vdmUoYXJnKTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIHZpZXdfbW9kZWwgPSBfdGhpcy5tb2RlbHNfb25seSA/IGFyZyA6IF90aGlzLnZpZXdNb2RlbEJ5TW9kZWwoYXJnKTsKCSAgICAgICAgICAgIGlmICghdmlld19tb2RlbCkgewoJICAgICAgICAgICAgICByZXR1cm4gX3RoaXMuX29uQ29sbGVjdGlvbkNoYW5nZSgnYWRkJywgYXJnKTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIGlmICghKGNvbXBhcmF0b3IgPSBfdGhpcy5fY29tcGFyYXRvcigpKSkgewoJICAgICAgICAgICAgICByZXR1cm47CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICBfdGhpcy5pbl9lZGl0Kys7CgkgICAgICAgICAgICBrYi51dGlscy53cmFwcGVkT2JzZXJ2YWJsZShfdGhpcykuc29ydChjb21wYXJhdG9yKTsKCSAgICAgICAgICAgIF90aGlzLmluX2VkaXQtLTsKCSAgICAgICAgfQoJICAgICAgfTsKCSAgICB9KSh0aGlzKSk7CgkgIH07CgoJICBDb2xsZWN0aW9uT2JzZXJ2YWJsZS5wcm90b3R5cGUuX29uTW9kZWxSZW1vdmUgPSBmdW5jdGlvbihtb2RlbCkgewoJICAgIHZhciBvYnNlcnZhYmxlLCB2aWV3X21vZGVsOwoJICAgIHZpZXdfbW9kZWwgPSB0aGlzLm1vZGVsc19vbmx5ID8gbW9kZWwgOiB0aGlzLnZpZXdNb2RlbEJ5TW9kZWwobW9kZWwpOwoJICAgIGlmICghdmlld19tb2RlbCkgewoJICAgICAgcmV0dXJuOwoJICAgIH0KCSAgICBvYnNlcnZhYmxlID0ga2IudXRpbHMud3JhcHBlZE9ic2VydmFibGUodGhpcyk7CgkgICAgdGhpcy5pbl9lZGl0Kys7CgkgICAgb2JzZXJ2YWJsZS5yZW1vdmUodmlld19tb2RlbCk7CgkgICAgcmV0dXJuIHRoaXMuaW5fZWRpdC0tOwoJICB9OwoKCSAgQ29sbGVjdGlvbk9ic2VydmFibGUucHJvdG90eXBlLl9vbk9ic2VydmFibGVBcnJheUNoYW5nZSA9IGZ1bmN0aW9uKG1vZGVsc19vcl92aWV3X21vZGVscykgewoJICAgIHJldHVybiBrYi5pZ25vcmUoKGZ1bmN0aW9uKF90aGlzKSB7CgkgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CgkgICAgICAgIHZhciBjb2xsZWN0aW9uLCBjdXJyZW50X3ZpZXdfbW9kZWwsIGhhc19maWx0ZXJzLCBtb2RlbCwgbW9kZWxzLCBvYnNlcnZhYmxlLCB2aWV3X21vZGVsLCB2aWV3X21vZGVscywgX2ksIF9sZW47CgkgICAgICAgIGlmIChfdGhpcy5pbl9lZGl0KSB7CgkgICAgICAgICAgcmV0dXJuOwoJICAgICAgICB9CgkgICAgICAgIChfdGhpcy5tb2RlbHNfb25seSAmJiAoIW1vZGVsc19vcl92aWV3X21vZGVscy5sZW5ndGggfHwga2IuaXNNb2RlbChtb2RlbHNfb3Jfdmlld19tb2RlbHNbMF0pKSkgfHwgKCFfdGhpcy5tb2RlbHNfb25seSAmJiAoIW1vZGVsc19vcl92aWV3X21vZGVscy5sZW5ndGggfHwgKF8uaXNPYmplY3QobW9kZWxzX29yX3ZpZXdfbW9kZWxzWzBdKSAmJiAha2IuaXNNb2RlbChtb2RlbHNfb3Jfdmlld19tb2RlbHNbMF0pKSkpIHx8IGtiLl90aHJvd1VuZXhwZWN0ZWQoX3RoaXMsICdpbmNvcnJlY3QgdHlwZSBwYXNzZWQnKTsKCSAgICAgICAgb2JzZXJ2YWJsZSA9IGtiLnV0aWxzLndyYXBwZWRPYnNlcnZhYmxlKF90aGlzKTsKCSAgICAgICAgY29sbGVjdGlvbiA9IGtiLnBlZWsoX3RoaXMuX2NvbGxlY3Rpb24pOwoJICAgICAgICBoYXNfZmlsdGVycyA9IGtiLnBlZWsoX3RoaXMuX2ZpbHRlcnMpLmxlbmd0aDsKCSAgICAgICAgaWYgKCFjb2xsZWN0aW9uKSB7CgkgICAgICAgICAgcmV0dXJuOwoJICAgICAgICB9CgkgICAgICAgIHZpZXdfbW9kZWxzID0gbW9kZWxzX29yX3ZpZXdfbW9kZWxzOwoJICAgICAgICBpZiAoX3RoaXMubW9kZWxzX29ubHkpIHsKCSAgICAgICAgICBtb2RlbHMgPSBfLmZpbHRlcihtb2RlbHNfb3Jfdmlld19tb2RlbHMsIGZ1bmN0aW9uKG1vZGVsKSB7CgkgICAgICAgICAgICByZXR1cm4gIWhhc19maWx0ZXJzIHx8IF90aGlzLl9zZWxlY3RNb2RlbChtb2RlbCk7CgkgICAgICAgICAgfSk7CgkgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgIWhhc19maWx0ZXJzIHx8ICh2aWV3X21vZGVscyA9IFtdKTsKCSAgICAgICAgICBtb2RlbHMgPSBbXTsKCSAgICAgICAgICBmb3IgKF9pID0gMCwgX2xlbiA9IG1vZGVsc19vcl92aWV3X21vZGVscy5sZW5ndGg7IF9pIDwgX2xlbjsgX2krKykgewoJICAgICAgICAgICAgdmlld19tb2RlbCA9IG1vZGVsc19vcl92aWV3X21vZGVsc1tfaV07CgkgICAgICAgICAgICBtb2RlbCA9IGtiLnV0aWxzLndyYXBwZWRPYmplY3Qodmlld19tb2RlbCk7CgkgICAgICAgICAgICBpZiAoaGFzX2ZpbHRlcnMpIHsKCSAgICAgICAgICAgICAgaWYgKCFfdGhpcy5fc2VsZWN0TW9kZWwobW9kZWwpKSB7CgkgICAgICAgICAgICAgICAgY29udGludWU7CgkgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgdmlld19tb2RlbHMucHVzaCh2aWV3X21vZGVsKTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIGlmIChjdXJyZW50X3ZpZXdfbW9kZWwgPSBfdGhpcy5jcmVhdGVfb3B0aW9ucy5zdG9yZS5maW5kKG1vZGVsLCBfdGhpcy5jcmVhdGVfb3B0aW9ucy5jcmVhdG9yKSkgewoJICAgICAgICAgICAgICAoY3VycmVudF92aWV3X21vZGVsLmNvbnN0cnVjdG9yID09PSB2aWV3X21vZGVsLmNvbnN0cnVjdG9yKSB8fCBrYi5fdGhyb3dVbmV4cGVjdGVkKF90aGlzLCAncmVwbGFjaW5nIGRpZmZlcmVudCB0eXBlIG9mIHZpZXcgbW9kZWwnKTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIF90aGlzLmNyZWF0ZV9vcHRpb25zLnN0b3JlLnJldGFpbih2aWV3X21vZGVsLCBtb2RlbCwgX3RoaXMuY3JlYXRlX29wdGlvbnMuY3JlYXRvcik7CgkgICAgICAgICAgICBtb2RlbHMucHVzaChtb2RlbCk7CgkgICAgICAgICAgfQoJICAgICAgICB9CgkgICAgICAgIF90aGlzLmluX2VkaXQrKzsKCSAgICAgICAgKG1vZGVsc19vcl92aWV3X21vZGVscy5sZW5ndGggPT09IHZpZXdfbW9kZWxzLmxlbmd0aCkgfHwgb2JzZXJ2YWJsZSh2aWV3X21vZGVscyk7CgkgICAgICAgIF8uaXNFcXVhbChjb2xsZWN0aW9uLm1vZGVscywgbW9kZWxzKSB8fCBjb2xsZWN0aW9uLnJlc2V0KG1vZGVscyk7CgkgICAgICAgIF90aGlzLmluX2VkaXQtLTsKCSAgICAgIH07CgkgICAgfSkodGhpcykpOwoJICB9OwoKCSAgQ29sbGVjdGlvbk9ic2VydmFibGUucHJvdG90eXBlLl9hdHRyaWJ1dGVDb21wYXJhdG9yID0gZnVuY3Rpb24oc29ydF9hdHRyaWJ1dGUpIHsKCSAgICB2YXIgbW9kZWxBdHRyaWJ1dGVDb21wYXJlOwoJICAgIG1vZGVsQXR0cmlidXRlQ29tcGFyZSA9IGZ1bmN0aW9uKG1vZGVsX2EsIG1vZGVsX2IpIHsKCSAgICAgIHZhciBhdHRyaWJ1dGVfbmFtZTsKCSAgICAgIGF0dHJpYnV0ZV9uYW1lID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZShzb3J0X2F0dHJpYnV0ZSk7CgkgICAgICByZXR1cm4ga2IuY29tcGFyZShtb2RlbF9hLmdldChhdHRyaWJ1dGVfbmFtZSksIG1vZGVsX2IuZ2V0KGF0dHJpYnV0ZV9uYW1lKSk7CgkgICAgfTsKCSAgICByZXR1cm4gKHRoaXMubW9kZWxzX29ubHkgPyBtb2RlbEF0dHJpYnV0ZUNvbXBhcmUgOiBmdW5jdGlvbihtb2RlbF9hLCBtb2RlbF9iKSB7CgkgICAgICByZXR1cm4gbW9kZWxBdHRyaWJ1dGVDb21wYXJlKGtiLnV0aWxzLndyYXBwZWRNb2RlbChtb2RlbF9hKSwga2IudXRpbHMud3JhcHBlZE1vZGVsKG1vZGVsX2IpKTsKCSAgICB9KTsKCSAgfTsKCgkgIENvbGxlY3Rpb25PYnNlcnZhYmxlLnByb3RvdHlwZS5fY3JlYXRlVmlld01vZGVsID0gZnVuY3Rpb24obW9kZWwpIHsKCSAgICBpZiAodGhpcy5tb2RlbHNfb25seSkgewoJICAgICAgcmV0dXJuIG1vZGVsOwoJICAgIH0KCSAgICByZXR1cm4gdGhpcy5jcmVhdGVfb3B0aW9ucy5zdG9yZS5yZXRhaW5PckNyZWF0ZShtb2RlbCwgdGhpcy5jcmVhdGVfb3B0aW9ucyk7CgkgIH07CgoJICBDb2xsZWN0aW9uT2JzZXJ2YWJsZS5wcm90b3R5cGUuX3NlbGVjdE1vZGVsID0gZnVuY3Rpb24obW9kZWwpIHsKCSAgICB2YXIgZmlsdGVyLCBmaWx0ZXJzLCBfaSwgX2xlbiwgX3JlZjE7CgkgICAgZmlsdGVycyA9IGtiLnBlZWsodGhpcy5fZmlsdGVycyk7CgkgICAgZm9yIChfaSA9IDAsIF9sZW4gPSBmaWx0ZXJzLmxlbmd0aDsgX2kgPCBfbGVuOyBfaSsrKSB7CgkgICAgICBmaWx0ZXIgPSBmaWx0ZXJzW19pXTsKCSAgICAgIGZpbHRlciA9IGtiLnBlZWsoZmlsdGVyKTsKCSAgICAgIGlmIChfLmlzRnVuY3Rpb24oZmlsdGVyKSkgewoJICAgICAgICBpZiAoIWZpbHRlcihtb2RlbCkpIHsKCSAgICAgICAgICByZXR1cm4gZmFsc2U7CgkgICAgICAgIH0KCSAgICAgIH0gZWxzZSBpZiAoXy5pc0FycmF5KGZpbHRlcikpIHsKCSAgICAgICAgaWYgKF9yZWYxID0gbW9kZWwuaWQsIF9faW5kZXhPZi5jYWxsKGZpbHRlciwgX3JlZjEpIDwgMCkgewoJICAgICAgICAgIHJldHVybiBmYWxzZTsKCSAgICAgICAgfQoJICAgICAgfSBlbHNlIHsKCSAgICAgICAgaWYgKG1vZGVsLmlkICE9PSBmaWx0ZXIpIHsKCSAgICAgICAgICByZXR1cm4gZmFsc2U7CgkgICAgICAgIH0KCSAgICAgIH0KCSAgICB9CgkgICAgcmV0dXJuIHRydWU7CgkgIH07CgoJICByZXR1cm4gQ29sbGVjdGlvbk9ic2VydmFibGU7CgoJfSkoKTsKCglrYi5jb2xsZWN0aW9uT2JzZXJ2YWJsZSA9IGZ1bmN0aW9uKGNvbGxlY3Rpb24sIHZpZXdfbW9kZWwsIG9wdGlvbnMpIHsKCSAgcmV0dXJuIG5ldyBrYi5Db2xsZWN0aW9uT2JzZXJ2YWJsZShhcmd1bWVudHMpOwoJfTsKCgovKioqLyB9LAovKiAyICovCi8qKiovIGZ1bmN0aW9uKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewoKCXZhciBBTExfT1JNUywga2IsIGtleSwga28sIHZhbHVlLCBfLCBfcmVmOwoKCV9yZWYgPSBrYiA9IF9fd2VicGFja19yZXF1aXJlX18oNiksIF8gPSBfcmVmLl8sIGtvID0gX3JlZi5rbzsKCglBTExfT1JNUyA9IHsKCSAgImRlZmF1bHQiOiBudWxsLAoJICAnYmFja2JvbmUtb3JtJzogbnVsbCwKCSAgJ2JhY2tib25lLWFzc29jaWF0aW9ucyc6IF9fd2VicGFja19yZXF1aXJlX18oMTYpLAoJICAnYmFja2JvbmUtcmVsYXRpb25hbCc6IF9fd2VicGFja19yZXF1aXJlX18oMTcpLAoJICBzdXBlcm1vZGVsOiBfX3dlYnBhY2tfcmVxdWlyZV9fKDE4KQoJfTsKCglrYi5vcm0gPSBBTExfT1JNU1siZGVmYXVsdCJdOwoKCWZvciAoa2V5IGluIEFMTF9PUk1TKSB7CgkgIHZhbHVlID0gQUxMX09STVNba2V5XTsKCSAgaWYgKHZhbHVlICYmIHZhbHVlLmlzQXZhaWxhYmxlKCkpIHsKCSAgICBrYi5vcm0gPSB2YWx1ZTsKCSAgICBicmVhazsKCSAgfQoJfQoKCW1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24ob3B0aW9ucykgewoJICB2YXIgb3JtOwoJICBpZiAob3B0aW9ucyA9PSBudWxsKSB7CgkgICAgb3B0aW9ucyA9IHt9OwoJICB9CgkgIGZvciAoa2V5IGluIG9wdGlvbnMpIHsKCSAgICB2YWx1ZSA9IG9wdGlvbnNba2V5XTsKCSAgICBzd2l0Y2ggKGtleSkgewoJICAgICAgY2FzZSAnb3JtJzoKCSAgICAgICAgaWYgKF8uaXNTdHJpbmcodmFsdWUpKSB7CgkgICAgICAgICAgaWYgKCFBTExfT1JNUy5oYXNPd25Qcm9wZXJ0eSh2YWx1ZSkpIHsKCSAgICAgICAgICAgIGNvbnNvbGUubG9nKCJLbm9ja2JhY2sgY29uZmlndXJlOiBjb3VsZCBub3QgZmluZCBvcm06ICIgKyB2YWx1ZSArICIuIEF2YWlsYWJsZTogIiArIChfLmtleXMoQUxMX09STVMpLmpvaW4oJywgJykpKTsKCSAgICAgICAgICAgIGNvbnRpbnVlOwoJICAgICAgICAgIH0KCSAgICAgICAgICBpZiAoKG9ybSA9IEFMTF9PUk1TW3ZhbHVlXSkgJiYgIW9ybS5pc0F2YWlsYWJsZSgpKSB7CgkgICAgICAgICAgICBjb25zb2xlLmxvZygiS25vY2tiYWNrIGNvbmZpZ3VyZTogY291bGQgbm90IGVuYWJsZSBvcm0gIiArIHZhbHVlICsgIi4gTWFrZSBzdXJlIGl0IGlzIGluY2x1ZGVkIGJlZm9yZSBLbm9ja2JhY2siKTsKCSAgICAgICAgICAgIGNvbnRpbnVlOwoJICAgICAgICAgIH0KCSAgICAgICAgICBrYi5vcm0gPSBvcm07CgkgICAgICAgICAgY29udGludWU7CgkgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAga2Iub3JtID0gdmFsdWU7CgkgICAgICAgIH0KCSAgICAgICAgYnJlYWs7CgkgICAgICBkZWZhdWx0OgoJICAgICAgICBrYltrZXldID0gdmFsdWU7CgkgICAgfQoJICB9Cgl9OwoKCi8qKiovIH0sCi8qIDMgKi8KLyoqKi8gZnVuY3Rpb24obW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CgoJCgkvKgoJICBrbm9ja2JhY2suanMgMC4yMC40CgkgIENvcHlyaWdodCAoYykgIDIwMTEtMjAxNCBLZXZpbiBNYWxha29mZi4KCSAgTGljZW5zZTogTUlUIChodHRwOi8vd3d3Lm9wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL21pdC1saWNlbnNlLnBocCkKCSAgU291cmNlOiBodHRwczovL2dpdGh1Yi5jb20va21hbGFrb2ZmL2tub2NrYmFjawoJICBEZXBlbmRlbmNpZXM6IEtub2Nrb3V0LmpzLCBCYWNrYm9uZS5qcywgYW5kIFVuZGVyc2NvcmUuanMgKG9yIExvRGFzaC5qcykuCgkgIE9wdGlvbmFsIGRlcGVuZGVuY2llczogQmFja2JvbmUuTW9kZWxSZWYuanMgYW5kIEJhY2tib25lT1JNLgoJICovCgl2YXIga2IsIGtvLCBfLCBfcmVmLAoJICBfX2JpbmQgPSBmdW5jdGlvbihmbiwgbWUpeyByZXR1cm4gZnVuY3Rpb24oKXsgcmV0dXJuIGZuLmFwcGx5KG1lLCBhcmd1bWVudHMpOyB9OyB9OwoKCV9yZWYgPSBrYiA9IF9fd2VicGFja19yZXF1aXJlX18oNiksIF8gPSBfcmVmLl8sIGtvID0gX3JlZi5rbzsKCglrYi5FdmVudFdhdGNoZXIgPSAoZnVuY3Rpb24oKSB7CgkgIEV2ZW50V2F0Y2hlci51c2VPcHRpb25zT3JDcmVhdGUgPSBmdW5jdGlvbihvcHRpb25zLCBlbWl0dGVyLCBvYmosIGNhbGxiYWNrX29wdGlvbnMpIHsKCSAgICBpZiAob3B0aW9ucy5ldmVudF93YXRjaGVyKSB7CgkgICAgICBpZiAoIShvcHRpb25zLmV2ZW50X3dhdGNoZXIuZW1pdHRlcigpID09PSBlbWl0dGVyIHx8IChvcHRpb25zLmV2ZW50X3dhdGNoZXIubW9kZWxfcmVmID09PSBlbWl0dGVyKSkpIHsKCSAgICAgICAga2IuX3Rocm93VW5leHBlY3RlZCh0aGlzLCAnZW1pdHRlciBub3QgbWF0Y2hpbmcnKTsKCSAgICAgIH0KCSAgICAgIHJldHVybiBrYi51dGlscy53cmFwcGVkRXZlbnRXYXRjaGVyKG9iaiwgb3B0aW9ucy5ldmVudF93YXRjaGVyKS5yZWdpc3RlckNhbGxiYWNrcyhvYmosIGNhbGxiYWNrX29wdGlvbnMpOwoJICAgIH0gZWxzZSB7CgkgICAgICBrYi51dGlscy53cmFwcGVkRXZlbnRXYXRjaGVySXNPd25lZChvYmosIHRydWUpOwoJICAgICAgcmV0dXJuIGtiLnV0aWxzLndyYXBwZWRFdmVudFdhdGNoZXIob2JqLCBuZXcga2IuRXZlbnRXYXRjaGVyKGVtaXR0ZXIpKS5yZWdpc3RlckNhbGxiYWNrcyhvYmosIGNhbGxiYWNrX29wdGlvbnMpOwoJICAgIH0KCSAgfTsKCgkgIGZ1bmN0aW9uIEV2ZW50V2F0Y2hlcihlbWl0dGVyLCBvYmosIGNhbGxiYWNrX29wdGlvbnMpIHsKCSAgICB0aGlzLl91bmJpbmRDYWxsYmFja3MgPSBfX2JpbmQodGhpcy5fdW5iaW5kQ2FsbGJhY2tzLCB0aGlzKTsKCSAgICB0aGlzLl9vbk1vZGVsVW5sb2FkZWQgPSBfX2JpbmQodGhpcy5fb25Nb2RlbFVubG9hZGVkLCB0aGlzKTsKCSAgICB0aGlzLl9vbk1vZGVsTG9hZGVkID0gX19iaW5kKHRoaXMuX29uTW9kZWxMb2FkZWQsIHRoaXMpOwoJICAgIHRoaXMuX19rYiB8fCAodGhpcy5fX2tiID0ge30pOwoJICAgIHRoaXMuX19rYi5jYWxsYmFja3MgPSB7fTsKCSAgICB0aGlzLmVlID0gbnVsbDsKCSAgICBpZiAoY2FsbGJhY2tfb3B0aW9ucykgewoJICAgICAgdGhpcy5yZWdpc3RlckNhbGxiYWNrcyhvYmosIGNhbGxiYWNrX29wdGlvbnMpOwoJICAgIH0KCSAgICBpZiAoZW1pdHRlcikgewoJICAgICAgdGhpcy5lbWl0dGVyKGVtaXR0ZXIpOwoJICAgIH0KCSAgfQoKCSAgRXZlbnRXYXRjaGVyLnByb3RvdHlwZS5kZXN0cm95ID0gZnVuY3Rpb24oKSB7CgkgICAgdGhpcy5lbWl0dGVyKG51bGwpOwoJICAgIHRoaXMuX19rYi5jYWxsYmFja3MgPSBudWxsOwoJICAgIHJldHVybiBrYi51dGlscy53cmFwcGVkRGVzdHJveSh0aGlzKTsKCSAgfTsKCgkgIEV2ZW50V2F0Y2hlci5wcm90b3R5cGUuZW1pdHRlciA9IGZ1bmN0aW9uKG5ld19lbWl0dGVyKSB7CgkgICAgaWYgKChhcmd1bWVudHMubGVuZ3RoID09PSAwKSB8fCAodGhpcy5lZSA9PT0gbmV3X2VtaXR0ZXIpKSB7CgkgICAgICByZXR1cm4gdGhpcy5lZTsKCSAgICB9CgkgICAgaWYgKHRoaXMubW9kZWxfcmVmKSB7CgkgICAgICB0aGlzLm1vZGVsX3JlZi51bmJpbmQoJ2xvYWRlZCcsIHRoaXMuX29uTW9kZWxMb2FkZWQpOwoJICAgICAgdGhpcy5tb2RlbF9yZWYudW5iaW5kKCd1bmxvYWRlZCcsIHRoaXMuX29uTW9kZWxVbmxvYWRlZCk7CgkgICAgICB0aGlzLm1vZGVsX3JlZi5yZWxlYXNlKCk7CgkgICAgICB0aGlzLm1vZGVsX3JlZiA9IG51bGw7CgkgICAgfQoJICAgIGlmIChrYi5CYWNrYm9uZSAmJiBrYi5CYWNrYm9uZS5Nb2RlbFJlZiAmJiAobmV3X2VtaXR0ZXIgaW5zdGFuY2VvZiBrYi5CYWNrYm9uZS5Nb2RlbFJlZikpIHsKCSAgICAgIHRoaXMubW9kZWxfcmVmID0gbmV3X2VtaXR0ZXI7CgkgICAgICB0aGlzLm1vZGVsX3JlZi5yZXRhaW4oKTsKCSAgICAgIHRoaXMubW9kZWxfcmVmLmJpbmQoJ2xvYWRlZCcsIHRoaXMuX29uTW9kZWxMb2FkZWQpOwoJICAgICAgdGhpcy5tb2RlbF9yZWYuYmluZCgndW5sb2FkZWQnLCB0aGlzLl9vbk1vZGVsVW5sb2FkZWQpOwoJICAgICAgbmV3X2VtaXR0ZXIgPSB0aGlzLm1vZGVsX3JlZi5tb2RlbCgpIHx8IG51bGw7CgkgICAgfSBlbHNlIHsKCSAgICAgIGRlbGV0ZSB0aGlzLm1vZGVsX3JlZjsKCSAgICB9CgkgICAgaWYgKHRoaXMuZWUgIT09IG5ld19lbWl0dGVyKSB7CgkgICAgICBpZiAobmV3X2VtaXR0ZXIpIHsKCSAgICAgICAgdGhpcy5fb25Nb2RlbExvYWRlZChuZXdfZW1pdHRlcik7CgkgICAgICB9IGVsc2UgewoJICAgICAgICB0aGlzLl9vbk1vZGVsVW5sb2FkZWQodGhpcy5lZSk7CgkgICAgICB9CgkgICAgfQoJICAgIHJldHVybiBuZXdfZW1pdHRlcjsKCSAgfTsKCgkgIEV2ZW50V2F0Y2hlci5wcm90b3R5cGUucmVnaXN0ZXJDYWxsYmFja3MgPSBmdW5jdGlvbihvYmosIGNhbGxiYWNrX2luZm8pIHsKCSAgICB2YXIgZXZlbnRfbmFtZSwgZXZlbnRfbmFtZXMsIG1vZGVsLCBfZm4sIF9pLCBfbGVuOwoJICAgIG9iaiB8fCBrYi5fdGhyb3dNaXNzaW5nKHRoaXMsICdvYmonKTsKCSAgICBjYWxsYmFja19pbmZvIHx8IGtiLl90aHJvd01pc3NpbmcodGhpcywgJ2NhbGxiYWNrX2luZm8nKTsKCSAgICBldmVudF9uYW1lcyA9IGNhbGxiYWNrX2luZm8uZXZlbnRfc2VsZWN0b3IgPyBjYWxsYmFja19pbmZvLmV2ZW50X3NlbGVjdG9yLnNwbGl0KCcgJykgOiBbJ2NoYW5nZSddOwoJICAgIG1vZGVsID0gdGhpcy5lZTsKCSAgICBfZm4gPSAoZnVuY3Rpb24oX3RoaXMpIHsKCSAgICAgIHJldHVybiBmdW5jdGlvbihldmVudF9uYW1lKSB7CgkgICAgICAgIHZhciBjYWxsYmFja3MsIGluZm87CgkgICAgICAgIGlmICghKGNhbGxiYWNrcyA9IF90aGlzLl9fa2IuY2FsbGJhY2tzW2V2ZW50X25hbWVdKSkgewoJICAgICAgICAgIGNhbGxiYWNrcyA9IF90aGlzLl9fa2IuY2FsbGJhY2tzW2V2ZW50X25hbWVdID0gewoJICAgICAgICAgICAgbW9kZWw6IG51bGwsCgkgICAgICAgICAgICBsaXN0OiBbXSwKCSAgICAgICAgICAgIGZuOiBmdW5jdGlvbihtb2RlbCkgewoJICAgICAgICAgICAgICB2YXIgaW5mbywgX2osIF9sZW4xLCBfcmVmMTsKCSAgICAgICAgICAgICAgX3JlZjEgPSBjYWxsYmFja3MubGlzdDsKCSAgICAgICAgICAgICAgZm9yIChfaiA9IDAsIF9sZW4xID0gX3JlZjEubGVuZ3RoOyBfaiA8IF9sZW4xOyBfaisrKSB7CgkgICAgICAgICAgICAgICAgaW5mbyA9IF9yZWYxW19qXTsKCSAgICAgICAgICAgICAgICBpZiAoIWluZm8udXBkYXRlKSB7CgkgICAgICAgICAgICAgICAgICBjb250aW51ZTsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgaWYgKG1vZGVsICYmIGluZm8ua2V5ICYmIChtb2RlbC5oYXNDaGFuZ2VkICYmICFtb2RlbC5oYXNDaGFuZ2VkKGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUoaW5mby5rZXkpKSkpIHsKCSAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICAha2Iuc3RhdGlzdGljcyB8fCBrYi5zdGF0aXN0aWNzLmFkZE1vZGVsRXZlbnQoewoJICAgICAgICAgICAgICAgICAgbmFtZTogZXZlbnRfbmFtZSwKCSAgICAgICAgICAgICAgICAgIG1vZGVsOiBtb2RlbCwKCSAgICAgICAgICAgICAgICAgIGtleTogaW5mby5rZXksCgkgICAgICAgICAgICAgICAgICBwYXRoOiBpbmZvLnBhdGgKCSAgICAgICAgICAgICAgICB9KTsKCSAgICAgICAgICAgICAgICBpbmZvLnVwZGF0ZSgpOwoJICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgIHJldHVybiBudWxsOwoJICAgICAgICAgICAgfQoJICAgICAgICAgIH07CgkgICAgICAgIH0KCSAgICAgICAgY2FsbGJhY2tzLmxpc3QucHVzaChpbmZvID0gXy5kZWZhdWx0cyh7CgkgICAgICAgICAgb2JqOiBvYmoKCSAgICAgICAgfSwgY2FsbGJhY2tfaW5mbykpOwoJICAgICAgICBpZiAobW9kZWwpIHsKCSAgICAgICAgICByZXR1cm4gX3RoaXMuX29uTW9kZWxMb2FkZWQobW9kZWwpOwoJICAgICAgICB9CgkgICAgICB9OwoJICAgIH0pKHRoaXMpOwoJICAgIGZvciAoX2kgPSAwLCBfbGVuID0gZXZlbnRfbmFtZXMubGVuZ3RoOyBfaSA8IF9sZW47IF9pKyspIHsKCSAgICAgIGV2ZW50X25hbWUgPSBldmVudF9uYW1lc1tfaV07CgkgICAgICBpZiAoIWV2ZW50X25hbWUpIHsKCSAgICAgICAgY29udGludWU7CgkgICAgICB9CgkgICAgICBfZm4oZXZlbnRfbmFtZSk7CgkgICAgfQoJICAgIHJldHVybiB0aGlzOwoJICB9OwoKCSAgRXZlbnRXYXRjaGVyLnByb3RvdHlwZS5yZWxlYXNlQ2FsbGJhY2tzID0gZnVuY3Rpb24ob2JqKSB7CgkgICAgdmFyIGNhbGxiYWNrcywgZXZlbnRfbmFtZSwgX3JlZjE7CgkgICAgdGhpcy5lZSA9IG51bGw7CgkgICAgX3JlZjEgPSB0aGlzLl9fa2IuY2FsbGJhY2tzOwoJICAgIGZvciAoZXZlbnRfbmFtZSBpbiBfcmVmMSkgewoJICAgICAgY2FsbGJhY2tzID0gX3JlZjFbZXZlbnRfbmFtZV07CgkgICAgICB0aGlzLl91bmJpbmRDYWxsYmFja3MoZXZlbnRfbmFtZSwgY2FsbGJhY2tzLCBrYi53YXNSZWxlYXNlZChvYmopKTsKCSAgICB9CgkgICAgcmV0dXJuIGRlbGV0ZSB0aGlzLl9fa2IuY2FsbGJhY2tzOwoJICB9OwoKCSAgRXZlbnRXYXRjaGVyLnByb3RvdHlwZS5fb25Nb2RlbExvYWRlZCA9IGZ1bmN0aW9uKG1vZGVsKSB7CgkgICAgdmFyIGNhbGxiYWNrcywgZXZlbnRfbmFtZSwgaW5mbywgX2ksIF9sZW4sIF9yZWYxLCBfcmVmMiwgX3JlZjM7CgkgICAgdGhpcy5lZSA9IG1vZGVsOwoJICAgIF9yZWYxID0gdGhpcy5fX2tiLmNhbGxiYWNrczsKCSAgICBmb3IgKGV2ZW50X25hbWUgaW4gX3JlZjEpIHsKCSAgICAgIGNhbGxiYWNrcyA9IF9yZWYxW2V2ZW50X25hbWVdOwoJICAgICAgaWYgKGNhbGxiYWNrcy5tb2RlbCAmJiAoY2FsbGJhY2tzLm1vZGVsICE9PSBtb2RlbCkpIHsKCSAgICAgICAgdGhpcy5fdW5iaW5kQ2FsbGJhY2tzKGV2ZW50X25hbWUsIGNhbGxiYWNrcywgdHJ1ZSk7CgkgICAgICB9CgkgICAgICBpZiAoIWNhbGxiYWNrcy5tb2RlbCkgewoJICAgICAgICBjYWxsYmFja3MubW9kZWwgPSBtb2RlbDsKCSAgICAgICAgbW9kZWwuYmluZChldmVudF9uYW1lLCBjYWxsYmFja3MuZm4pOwoJICAgICAgfQoJICAgICAgX3JlZjIgPSBjYWxsYmFja3MubGlzdDsKCSAgICAgIGZvciAoX2kgPSAwLCBfbGVuID0gX3JlZjIubGVuZ3RoOyBfaSA8IF9sZW47IF9pKyspIHsKCSAgICAgICAgaW5mbyA9IF9yZWYyW19pXTsKCSAgICAgICAgaW5mby51bmJpbmRfZm4gfHwgKGluZm8udW5iaW5kX2ZuID0gKF9yZWYzID0ga2Iub3JtKSAhPSBudWxsID8gX3JlZjMuYmluZChtb2RlbCwgaW5mby5rZXksIGluZm8udXBkYXRlLCBpbmZvLnBhdGgpIDogdm9pZCAwKTsKCSAgICAgICAgaWYgKGluZm8uZW1pdHRlcikgewoJICAgICAgICAgIGluZm8uZW1pdHRlcihtb2RlbCk7CgkgICAgICAgIH0KCSAgICAgIH0KCSAgICB9CgkgIH07CgoJICBFdmVudFdhdGNoZXIucHJvdG90eXBlLl9vbk1vZGVsVW5sb2FkZWQgPSBmdW5jdGlvbihtb2RlbCkgewoJICAgIHZhciBjYWxsYmFja3MsIGV2ZW50X25hbWUsIF9yZWYxOwoJICAgIGlmICh0aGlzLmVlICE9PSBtb2RlbCkgewoJICAgICAgcmV0dXJuOwoJICAgIH0KCSAgICB0aGlzLmVlID0gbnVsbDsKCSAgICBfcmVmMSA9IHRoaXMuX19rYi5jYWxsYmFja3M7CgkgICAgZm9yIChldmVudF9uYW1lIGluIF9yZWYxKSB7CgkgICAgICBjYWxsYmFja3MgPSBfcmVmMVtldmVudF9uYW1lXTsKCSAgICAgIHRoaXMuX3VuYmluZENhbGxiYWNrcyhldmVudF9uYW1lLCBjYWxsYmFja3MpOwoJICAgIH0KCSAgfTsKCgkgIEV2ZW50V2F0Y2hlci5wcm90b3R5cGUuX3VuYmluZENhbGxiYWNrcyA9IGZ1bmN0aW9uKGV2ZW50X25hbWUsIGNhbGxiYWNrcywgc2tpcF9lbWl0dGVyKSB7CgkgICAgdmFyIGluZm8sIF9pLCBfbGVuLCBfcmVmMTsKCSAgICBpZiAoY2FsbGJhY2tzLm1vZGVsKSB7CgkgICAgICBjYWxsYmFja3MubW9kZWwudW5iaW5kKGV2ZW50X25hbWUsIGNhbGxiYWNrcy5mbik7CgkgICAgICBjYWxsYmFja3MubW9kZWwgPSBudWxsOwoJICAgIH0KCSAgICBfcmVmMSA9IGNhbGxiYWNrcy5saXN0OwoJICAgIGZvciAoX2kgPSAwLCBfbGVuID0gX3JlZjEubGVuZ3RoOyBfaSA8IF9sZW47IF9pKyspIHsKCSAgICAgIGluZm8gPSBfcmVmMVtfaV07CgkgICAgICBpZiAoaW5mby51bmJpbmRfZm4pIHsKCSAgICAgICAgaW5mby51bmJpbmRfZm4oKTsKCSAgICAgICAgaW5mby51bmJpbmRfZm4gPSBudWxsOwoJICAgICAgfQoJICAgICAgaWYgKGluZm8uZW1pdHRlciAmJiAhc2tpcF9lbWl0dGVyICYmICFrYi53YXNSZWxlYXNlZChpbmZvLm9iaikpIHsKCSAgICAgICAgaW5mby5lbWl0dGVyKG51bGwpOwoJICAgICAgfQoJICAgIH0KCSAgfTsKCgkgIHJldHVybiBFdmVudFdhdGNoZXI7CgoJfSkoKTsKCglrYi5lbWl0dGVyT2JzZXJ2YWJsZSA9IGZ1bmN0aW9uKGVtaXR0ZXIsIG9ic2VydmFibGUpIHsKCSAgcmV0dXJuIG5ldyBrYi5FdmVudFdhdGNoZXIoZW1pdHRlciwgb2JzZXJ2YWJsZSk7Cgl9OwoKCi8qKiovIH0sCi8qIDQgKi8KLyoqKi8gZnVuY3Rpb24obW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CgoJCgkvKgoJICBrbm9ja2JhY2suanMgMC4yMC40CgkgIENvcHlyaWdodCAoYykgIDIwMTEtMjAxNCBLZXZpbiBNYWxha29mZi4KCSAgTGljZW5zZTogTUlUIChodHRwOi8vd3d3Lm9wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL21pdC1saWNlbnNlLnBocCkKCSAgU291cmNlOiBodHRwczovL2dpdGh1Yi5jb20va21hbGFrb2ZmL2tub2NrYmFjawoJICBEZXBlbmRlbmNpZXM6IEtub2Nrb3V0LmpzLCBCYWNrYm9uZS5qcywgYW5kIFVuZGVyc2NvcmUuanMgKG9yIExvRGFzaC5qcykuCgkgIE9wdGlvbmFsIGRlcGVuZGVuY2llczogQmFja2JvbmUuTW9kZWxSZWYuanMgYW5kIEJhY2tib25lT1JNLgoJICovCgl2YXIga2IsIF87CgoJXyA9IChrYiA9IF9fd2VicGFja19yZXF1aXJlX18oNikpLl87CgoJa2IuRmFjdG9yeSA9IChmdW5jdGlvbigpIHsKCSAgRmFjdG9yeS51c2VPcHRpb25zT3JDcmVhdGUgPSBmdW5jdGlvbihvcHRpb25zLCBvYmosIG93bmVyX3BhdGgpIHsKCSAgICB2YXIgZmFjdG9yeTsKCSAgICBpZiAob3B0aW9ucy5mYWN0b3J5ICYmICghb3B0aW9ucy5mYWN0b3JpZXMgfHwgKG9wdGlvbnMuZmFjdG9yaWVzICYmIG9wdGlvbnMuZmFjdG9yeS5oYXNQYXRoTWFwcGluZ3Mob3B0aW9ucy5mYWN0b3JpZXMsIG93bmVyX3BhdGgpKSkpIHsKCSAgICAgIHJldHVybiBrYi51dGlscy53cmFwcGVkRmFjdG9yeShvYmosIG9wdGlvbnMuZmFjdG9yeSk7CgkgICAgfQoJICAgIGZhY3RvcnkgPSBrYi51dGlscy53cmFwcGVkRmFjdG9yeShvYmosIG5ldyBrYi5GYWN0b3J5KG9wdGlvbnMuZmFjdG9yeSkpOwoJICAgIGlmIChvcHRpb25zLmZhY3RvcmllcykgewoJICAgICAgZmFjdG9yeS5hZGRQYXRoTWFwcGluZ3Mob3B0aW9ucy5mYWN0b3JpZXMsIG93bmVyX3BhdGgpOwoJICAgIH0KCSAgICByZXR1cm4gZmFjdG9yeTsKCSAgfTsKCgkgIGZ1bmN0aW9uIEZhY3RvcnkocGFyZW50X2ZhY3RvcnkpIHsKCSAgICB0aGlzLnBhdGhzID0ge307CgkgICAgaWYgKHBhcmVudF9mYWN0b3J5KSB7CgkgICAgICB0aGlzLnBhcmVudF9mYWN0b3J5ID0gcGFyZW50X2ZhY3Rvcnk7CgkgICAgfQoJICB9CgoJICBGYWN0b3J5LnByb3RvdHlwZS5oYXNQYXRoID0gZnVuY3Rpb24ocGF0aCkgewoJICAgIHZhciBfcmVmOwoJICAgIHJldHVybiB0aGlzLnBhdGhzLmhhc093blByb3BlcnR5KHBhdGgpIHx8ICgoX3JlZiA9IHRoaXMucGFyZW50X2ZhY3RvcnkpICE9IG51bGwgPyBfcmVmLmhhc1BhdGgocGF0aCkgOiB2b2lkIDApOwoJICB9OwoKCSAgRmFjdG9yeS5wcm90b3R5cGUuYWRkUGF0aE1hcHBpbmcgPSBmdW5jdGlvbihwYXRoLCBjcmVhdGVfaW5mbykgewoJICAgIHJldHVybiB0aGlzLnBhdGhzW3BhdGhdID0gY3JlYXRlX2luZm87CgkgIH07CgoJICBGYWN0b3J5LnByb3RvdHlwZS5hZGRQYXRoTWFwcGluZ3MgPSBmdW5jdGlvbihmYWN0b3JpZXMsIG93bmVyX3BhdGgpIHsKCSAgICB2YXIgY3JlYXRlX2luZm8sIHBhdGg7CgkgICAgZm9yIChwYXRoIGluIGZhY3RvcmllcykgewoJICAgICAgY3JlYXRlX2luZm8gPSBmYWN0b3JpZXNbcGF0aF07CgkgICAgICB0aGlzLnBhdGhzW2tiLnV0aWxzLnBhdGhKb2luKG93bmVyX3BhdGgsIHBhdGgpXSA9IGNyZWF0ZV9pbmZvOwoJICAgIH0KCSAgfTsKCgkgIEZhY3RvcnkucHJvdG90eXBlLmhhc1BhdGhNYXBwaW5ncyA9IGZ1bmN0aW9uKGZhY3Rvcmllcywgb3duZXJfcGF0aCkgewoJICAgIHZhciBhbGxfZXhpc3QsIGNyZWF0b3IsIGV4aXN0aW5nX2NyZWF0b3IsIHBhdGg7CgkgICAgYWxsX2V4aXN0ID0gdHJ1ZTsKCSAgICBmb3IgKHBhdGggaW4gZmFjdG9yaWVzKSB7CgkgICAgICBjcmVhdG9yID0gZmFjdG9yaWVzW3BhdGhdOwoJICAgICAgYWxsX2V4aXN0ICY9IChleGlzdGluZ19jcmVhdG9yID0gdGhpcy5jcmVhdG9yRm9yUGF0aChudWxsLCBrYi51dGlscy5wYXRoSm9pbihvd25lcl9wYXRoLCBwYXRoKSkpICYmIChjcmVhdG9yID09PSBleGlzdGluZ19jcmVhdG9yKTsKCSAgICB9CgkgICAgcmV0dXJuIGFsbF9leGlzdDsKCSAgfTsKCgkgIEZhY3RvcnkucHJvdG90eXBlLmNyZWF0b3JGb3JQYXRoID0gZnVuY3Rpb24ob2JqLCBwYXRoKSB7CgkgICAgdmFyIGNyZWF0b3IsIF9yZWY7CgkgICAgaWYgKGNyZWF0b3IgPSB0aGlzLnBhdGhzW3BhdGhdKSB7CgkgICAgICByZXR1cm4gKGNyZWF0b3Iudmlld19tb2RlbCA/IGNyZWF0b3Iudmlld19tb2RlbCA6IGNyZWF0b3IpOwoJICAgIH0KCSAgICBpZiAoY3JlYXRvciA9IChfcmVmID0gdGhpcy5wYXJlbnRfZmFjdG9yeSkgIT0gbnVsbCA/IF9yZWYuY3JlYXRvckZvclBhdGgob2JqLCBwYXRoKSA6IHZvaWQgMCkgewoJICAgICAgcmV0dXJuIGNyZWF0b3I7CgkgICAgfQoJICAgIHJldHVybiBudWxsOwoJICB9OwoKCSAgcmV0dXJuIEZhY3Rvcnk7CgoJfSkoKTsKCgovKioqLyB9LAovKiA1ICovCi8qKiovIGZ1bmN0aW9uKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewoKCS8qIFdFQlBBQ0sgVkFSIElOSkVDVElPTiAqLyhmdW5jdGlvbihnbG9iYWwpIHsKCS8qCgkgIGtub2NrYmFjay5qcyAwLjIwLjQKCSAgQ29weXJpZ2h0IChjKSAgMjAxMS0yMDE0IEtldmluIE1hbGFrb2ZmLgoJICBMaWNlbnNlOiBNSVQgKGh0dHA6Ly93d3cub3BlbnNvdXJjZS5vcmcvbGljZW5zZXMvbWl0LWxpY2Vuc2UucGhwKQoJICBTb3VyY2U6IGh0dHBzOi8vZ2l0aHViLmNvbS9rbWFsYWtvZmYva25vY2tiYWNrCgkgIERlcGVuZGVuY2llczogS25vY2tvdXQuanMsIEJhY2tib25lLmpzLCBhbmQgVW5kZXJzY29yZS5qcyAob3IgTG9EYXNoLmpzKS4KCSAgT3B0aW9uYWwgZGVwZW5kZW5jaWVzOiBCYWNrYm9uZS5Nb2RlbFJlZi5qcyBhbmQgQmFja2JvbmVPUk0uCgkgKi8KCXZhciAkLCBrYiwga28sIG9uUmVhZHksIHdpbmRvdywgXywgX2tvX2FwcGx5QmluZGluZ3MsIF9yZWY7CgoJd2luZG93ID0gd2luZG93ICE9IG51bGwgPyB3aW5kb3cgOiBnbG9iYWw7CgoJX3JlZiA9IGtiID0gX193ZWJwYWNrX3JlcXVpcmVfXyg2KSwgXyA9IF9yZWYuXywga28gPSBfcmVmLmtvLCAkID0gX3JlZi4kOwoKCWtiLlJFQ1VTSVZFX0FVVE9fSU5KRUNUID0gdHJ1ZTsKCglrby5iaW5kaW5nSGFuZGxlcnNbJ2luamVjdCddID0gewoJICAnaW5pdCc6IGZ1bmN0aW9uKGVsZW1lbnQsIHZhbHVlX2FjY2Vzc29yLCBhbGxfYmluZGluZ3NfYWNjZXNzb3IsIHZpZXdfbW9kZWwpIHsKCSAgICByZXR1cm4ga2IuSW5qZWN0LmluamVjdChrby51dGlscy51bndyYXBPYnNlcnZhYmxlKHZhbHVlX2FjY2Vzc29yKCkpLCB2aWV3X21vZGVsLCBlbGVtZW50LCB2YWx1ZV9hY2Nlc3NvciwgYWxsX2JpbmRpbmdzX2FjY2Vzc29yKTsKCSAgfQoJfTsKCglrYi5JbmplY3QgPSAoZnVuY3Rpb24oKSB7CgkgIGZ1bmN0aW9uIEluamVjdCgpIHt9CgoJICBJbmplY3QuaW5qZWN0ID0gZnVuY3Rpb24oZGF0YSwgdmlld19tb2RlbCwgZWxlbWVudCwgdmFsdWVfYWNjZXNzb3IsIGFsbF9iaW5kaW5nc19hY2Nlc3NvciwgbmVzdGVkKSB7CgkgICAgdmFyIGluamVjdDsKCSAgICBpbmplY3QgPSBmdW5jdGlvbihkYXRhKSB7CgkgICAgICB2YXIga2V5LCB0YXJnZXQsIHZhbHVlOwoJICAgICAgaWYgKF8uaXNGdW5jdGlvbihkYXRhKSkgewoJICAgICAgICB2aWV3X21vZGVsID0gbmV3IGRhdGEodmlld19tb2RlbCwgZWxlbWVudCwgdmFsdWVfYWNjZXNzb3IsIGFsbF9iaW5kaW5nc19hY2Nlc3Nvcik7CgkgICAgICAgIGtiLnJlbGVhc2VPbk5vZGVSZW1vdmUodmlld19tb2RlbCwgZWxlbWVudCk7CgkgICAgICB9IGVsc2UgewoJICAgICAgICBpZiAoZGF0YS52aWV3X21vZGVsKSB7CgkgICAgICAgICAgdmlld19tb2RlbCA9IG5ldyBkYXRhLnZpZXdfbW9kZWwodmlld19tb2RlbCwgZWxlbWVudCwgdmFsdWVfYWNjZXNzb3IsIGFsbF9iaW5kaW5nc19hY2Nlc3Nvcik7CgkgICAgICAgICAga2IucmVsZWFzZU9uTm9kZVJlbW92ZSh2aWV3X21vZGVsLCBlbGVtZW50KTsKCSAgICAgICAgfQoJICAgICAgICBmb3IgKGtleSBpbiBkYXRhKSB7CgkgICAgICAgICAgdmFsdWUgPSBkYXRhW2tleV07CgkgICAgICAgICAgaWYgKGtleSA9PT0gJ3ZpZXdfbW9kZWwnKSB7CgkgICAgICAgICAgICBjb250aW51ZTsKCSAgICAgICAgICB9CgkgICAgICAgICAgaWYgKGtleSA9PT0gJ2NyZWF0ZScpIHsKCSAgICAgICAgICAgIHZhbHVlKHZpZXdfbW9kZWwsIGVsZW1lbnQsIHZhbHVlX2FjY2Vzc29yLCBhbGxfYmluZGluZ3NfYWNjZXNzb3IpOwoJICAgICAgICAgIH0gZWxzZSBpZiAoXy5pc09iamVjdCh2YWx1ZSkgJiYgIV8uaXNGdW5jdGlvbih2YWx1ZSkpIHsKCSAgICAgICAgICAgIHRhcmdldCA9IG5lc3RlZCB8fCAodmFsdWUgJiYgdmFsdWUuY3JlYXRlKSA/IHt9IDogdmlld19tb2RlbDsKCSAgICAgICAgICAgIHZpZXdfbW9kZWxba2V5XSA9IGtiLkluamVjdC5pbmplY3QodmFsdWUsIHRhcmdldCwgZWxlbWVudCwgdmFsdWVfYWNjZXNzb3IsIGFsbF9iaW5kaW5nc19hY2Nlc3NvciwgdHJ1ZSk7CgkgICAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgIHZpZXdfbW9kZWxba2V5XSA9IHZhbHVlOwoJICAgICAgICAgIH0KCSAgICAgICAgfQoJICAgICAgfQoJICAgICAgcmV0dXJuIHZpZXdfbW9kZWw7CgkgICAgfTsKCSAgICBpZiAobmVzdGVkKSB7CgkgICAgICByZXR1cm4gaW5qZWN0KGRhdGEpOwoJICAgIH0gZWxzZSB7CgkgICAgICByZXR1cm4ga2IuaWdub3JlKGZ1bmN0aW9uKCkgewoJICAgICAgICByZXR1cm4gaW5qZWN0KGRhdGEpOwoJICAgICAgfSk7CgkgICAgfQoJICB9OwoKCSAgSW5qZWN0LmluamVjdFZpZXdNb2RlbHMgPSBmdW5jdGlvbihyb290KSB7CgkgICAgdmFyIGFmdGVyQmluZGluZywgYXBwLCBiZWZvcmVCaW5kaW5nLCBkYXRhLCBleHByZXNzaW9uLCBmaW5kRWxlbWVudHMsIG9wdGlvbnMsIHJlc3VsdHMsIF9pLCBfbGVuOwoJICAgIHJlc3VsdHMgPSBbXTsKCSAgICBmaW5kRWxlbWVudHMgPSBmdW5jdGlvbihlbCkgewoJICAgICAgdmFyIGF0dHIsIGNoaWxkX2VsLCBfaSwgX2xlbiwgX3JlZjE7CgkgICAgICBpZiAoIWVsLl9fa2JfaW5qZWN0ZWQpIHsKCSAgICAgICAgaWYgKGVsLmF0dHJpYnV0ZXMgJiYgKGF0dHIgPSBfLmZpbmQoZWwuYXR0cmlidXRlcywgZnVuY3Rpb24oYXR0cikgewoJICAgICAgICAgIHJldHVybiBhdHRyLm5hbWUgPT09ICdrYi1pbmplY3QnOwoJICAgICAgICB9KSkpIHsKCSAgICAgICAgICBlbC5fX2tiX2luamVjdGVkID0gdHJ1ZTsKCSAgICAgICAgICByZXN1bHRzLnB1c2goewoJICAgICAgICAgICAgZWw6IGVsLAoJICAgICAgICAgICAgdmlld19tb2RlbDoge30sCgkgICAgICAgICAgICBiaW5kaW5nOiBhdHRyLnZhbHVlCgkgICAgICAgICAgfSk7CgkgICAgICAgIH0KCSAgICAgIH0KCSAgICAgIF9yZWYxID0gZWwuY2hpbGROb2RlczsKCSAgICAgIGZvciAoX2kgPSAwLCBfbGVuID0gX3JlZjEubGVuZ3RoOyBfaSA8IF9sZW47IF9pKyspIHsKCSAgICAgICAgY2hpbGRfZWwgPSBfcmVmMVtfaV07CgkgICAgICAgIGZpbmRFbGVtZW50cyhjaGlsZF9lbCk7CgkgICAgICB9CgkgICAgfTsKCSAgICBpZiAoIXJvb3QgJiYgKHdpbmRvdyAhPSBudWxsID8gd2luZG93LmRvY3VtZW50IDogdm9pZCAwKSkgewoJICAgICAgcm9vdCA9IHdpbmRvdy5kb2N1bWVudDsKCSAgICB9CgkgICAgZmluZEVsZW1lbnRzKHJvb3QpOwoJICAgIGZvciAoX2kgPSAwLCBfbGVuID0gcmVzdWx0cy5sZW5ndGg7IF9pIDwgX2xlbjsgX2krKykgewoJICAgICAgYXBwID0gcmVzdWx0c1tfaV07CgkgICAgICBpZiAoZXhwcmVzc2lvbiA9IGFwcC5iaW5kaW5nKSB7CgkgICAgICAgIChleHByZXNzaW9uLnNlYXJjaCgvWzpdLykgPCAwKSB8fCAoZXhwcmVzc2lvbiA9ICJ7IiArIGV4cHJlc3Npb24gKyAifSIpOwoJICAgICAgICBkYXRhID0gKG5ldyBGdW5jdGlvbigiIiwgInJldHVybiAoICIgKyBleHByZXNzaW9uICsgIiApIikpKCk7CgkgICAgICAgIGRhdGEgfHwgKGRhdGEgPSB7fSk7CgkgICAgICAgICghZGF0YS5vcHRpb25zKSB8fCAob3B0aW9ucyA9IGRhdGEub3B0aW9ucywgZGVsZXRlIGRhdGEub3B0aW9ucyk7CgkgICAgICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CgkgICAgICAgIGFwcC52aWV3X21vZGVsID0ga2IuSW5qZWN0LmluamVjdChkYXRhLCBhcHAudmlld19tb2RlbCwgYXBwLmVsLCBudWxsLCBudWxsLCB0cnVlKTsKCSAgICAgICAgYWZ0ZXJCaW5kaW5nID0gYXBwLnZpZXdfbW9kZWwuYWZ0ZXJCaW5kaW5nIHx8IG9wdGlvbnMuYWZ0ZXJCaW5kaW5nOwoJICAgICAgICBiZWZvcmVCaW5kaW5nID0gYXBwLnZpZXdfbW9kZWwuYmVmb3JlQmluZGluZyB8fCBvcHRpb25zLmJlZm9yZUJpbmRpbmc7CgkgICAgICB9CgkgICAgICBpZiAoYmVmb3JlQmluZGluZykgewoJICAgICAgICBiZWZvcmVCaW5kaW5nLmNhbGwoYXBwLnZpZXdfbW9kZWwsIGFwcC52aWV3X21vZGVsLCBhcHAuZWwsIG9wdGlvbnMpOwoJICAgICAgfQoJICAgICAga2IuYXBwbHlCaW5kaW5ncyhhcHAudmlld19tb2RlbCwgYXBwLmVsLCBvcHRpb25zKTsKCSAgICAgIGlmIChhZnRlckJpbmRpbmcpIHsKCSAgICAgICAgYWZ0ZXJCaW5kaW5nLmNhbGwoYXBwLnZpZXdfbW9kZWwsIGFwcC52aWV3X21vZGVsLCBhcHAuZWwsIG9wdGlvbnMpOwoJICAgICAgfQoJICAgIH0KCSAgICByZXR1cm4gcmVzdWx0czsKCSAgfTsKCgkgIHJldHVybiBJbmplY3Q7CgoJfSkoKTsKCglfa29fYXBwbHlCaW5kaW5ncyA9IGtvLmFwcGx5QmluZGluZ3M7CgoJa28uYXBwbHlCaW5kaW5ncyA9IGZ1bmN0aW9uKGNvbnRleHQsIGVsZW1lbnQpIHsKCSAgdmFyIHJlc3VsdHM7CgkgIHJlc3VsdHMgPSBrYi5SRUNVU0lWRV9BVVRPX0lOSkVDVCA/IGtiLmluamVjdFZpZXdNb2RlbHMoZWxlbWVudCkgOiBbXTsKCSAgaWYgKCFyZXN1bHRzLmxlbmd0aCkgewoJICAgIHJldHVybiBfa29fYXBwbHlCaW5kaW5ncy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoJICB9Cgl9OwoKCWtiLmluamVjdFZpZXdNb2RlbHMgPSBrYi5JbmplY3QuaW5qZWN0Vmlld01vZGVsczsKCglpZiAodHlwZW9mIGRvY3VtZW50ICE9PSAidW5kZWZpbmVkIiAmJiBkb2N1bWVudCAhPT0gbnVsbCkgewoJICBpZiAoJCkgewoJICAgICQoZnVuY3Rpb24oKSB7CgkgICAgICByZXR1cm4ga2IuaW5qZWN0Vmlld01vZGVscygpOwoJICAgIH0pOwoJICB9IGVsc2UgewoJICAgIChvblJlYWR5ID0gZnVuY3Rpb24oKSB7CgkgICAgICBpZiAoZG9jdW1lbnQucmVhZHlTdGF0ZSAhPT0gJ2NvbXBsZXRlJykgewoJICAgICAgICByZXR1cm4gc2V0VGltZW91dChvblJlYWR5LCAwKTsKCSAgICAgIH0KCSAgICAgIHJldHVybiBrYi5pbmplY3RWaWV3TW9kZWxzKCk7CgkgICAgfSkoKTsKCSAgfQoJfQoJCgkvKiBXRUJQQUNLIFZBUiBJTkpFQ1RJT04gKi99LmNhbGwoZXhwb3J0cywgKGZ1bmN0aW9uKCkgeyByZXR1cm4gdGhpczsgfSgpKSkpCgovKioqLyB9LAovKiA2ICovCi8qKiovIGZ1bmN0aW9uKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewoKCS8qIFdFQlBBQ0sgVkFSIElOSkVDVElPTiAqLyhmdW5jdGlvbihnbG9iYWwpIHsKCS8qCgkgIGtub2NrYmFjay5qcyAwLjIwLjQKCSAgQ29weXJpZ2h0IChjKSAgMjAxMS0yMDE0IEtldmluIE1hbGFrb2ZmLgoJICBMaWNlbnNlOiBNSVQgKGh0dHA6Ly93d3cub3BlbnNvdXJjZS5vcmcvbGljZW5zZXMvbWl0LWxpY2Vuc2UucGhwKQoJICBTb3VyY2U6IGh0dHBzOi8vZ2l0aHViLmNvbS9rbWFsYWtvZmYva25vY2tiYWNrCgkgIERlcGVuZGVuY2llczogS25vY2tvdXQuanMsIEJhY2tib25lLmpzLCBhbmQgVW5kZXJzY29yZS5qcyAob3IgTG9EYXNoLmpzKS4KCSAgT3B0aW9uYWwgZGVwZW5kZW5jaWVzOiBCYWNrYm9uZS5Nb2RlbFJlZi5qcyBhbmQgQmFja2JvbmVPUk0uCgkgKi8KCXZhciBCYWNrYm9uZSwgTElGRUNZQ0xFX01FVEhPRFMsIGtiLCBrbywgd2luZG93LCBfOwoKCXdpbmRvdyA9IHdpbmRvdyAhPSBudWxsID8gd2luZG93IDogZ2xvYmFsOwoKCWtvID0gX193ZWJwYWNrX3JlcXVpcmVfXygyNSk7CgoJTElGRUNZQ0xFX01FVEhPRFMgPSBbJ3JlbGVhc2UnLCAnZGVzdHJveScsICdkaXNwb3NlJ107CgoJbW9kdWxlLmV4cG9ydHMgPSBrYiA9IChmdW5jdGlvbigpIHsKCSAgdmFyIF9yZWY7CgoJICBmdW5jdGlvbiBrYigpIHt9CgoJICBrYi5WRVJTSU9OID0gJzAuMjAuNCc7CgoJICBrYi5UWVBFX1VOS05PV04gPSAwOwoKCSAga2IuVFlQRV9TSU1QTEUgPSAxOwoKCSAga2IuVFlQRV9BUlJBWSA9IDI7CgoJICBrYi5UWVBFX01PREVMID0gMzsKCgkgIGtiLlRZUEVfQ09MTEVDVElPTiA9IDQ7CgoJICBrYi53YXNSZWxlYXNlZCA9IGZ1bmN0aW9uKG9iaikgewoJICAgIHJldHVybiAhb2JqIHx8IG9iai5fX2tiX3JlbGVhc2VkOwoJICB9OwoKCSAga2IuaXNSZWxlYXNlYWJsZSA9IGZ1bmN0aW9uKG9iaiwgZGVwdGgpIHsKCSAgICB2YXIga2V5LCBtZXRob2QsIHZhbHVlLCBfaSwgX2xlbjsKCSAgICBpZiAoZGVwdGggPT0gbnVsbCkgewoJICAgICAgZGVwdGggPSAwOwoJICAgIH0KCSAgICBpZiAoKCFvYmogfHwgKG9iaiAhPT0gT2JqZWN0KG9iaikpKSB8fCBvYmouX19rYl9yZWxlYXNlZCkgewoJICAgICAgcmV0dXJuIGZhbHNlOwoJICAgIH0KCSAgICBpZiAoa28uaXNPYnNlcnZhYmxlKG9iaikgfHwgKG9iaiBpbnN0YW5jZW9mIGtiLlZpZXdNb2RlbCkpIHsKCSAgICAgIHJldHVybiB0cnVlOwoJICAgIH0KCSAgICBpZiAoKHR5cGVvZiBvYmogPT09ICdmdW5jdGlvbicpIHx8IGtiLmlzTW9kZWwob2JqKSB8fCBrYi5pc0NvbGxlY3Rpb24ob2JqKSkgewoJICAgICAgcmV0dXJuIGZhbHNlOwoJICAgIH0KCSAgICBmb3IgKF9pID0gMCwgX2xlbiA9IExJRkVDWUNMRV9NRVRIT0RTLmxlbmd0aDsgX2kgPCBfbGVuOyBfaSsrKSB7CgkgICAgICBtZXRob2QgPSBMSUZFQ1lDTEVfTUVUSE9EU1tfaV07CgkgICAgICBpZiAodHlwZW9mIG9ialttZXRob2RdID09PSAnZnVuY3Rpb24nKSB7CgkgICAgICAgIHJldHVybiB0cnVlOwoJICAgICAgfQoJICAgIH0KCSAgICBpZiAoZGVwdGggPiAwKSB7CgkgICAgICByZXR1cm4gZmFsc2U7CgkgICAgfQoJICAgIGZvciAoa2V5IGluIG9iaikgewoJICAgICAgdmFsdWUgPSBvYmpba2V5XTsKCSAgICAgIGlmICgoa2V5ICE9PSAnX19rYicpICYmIGtiLmlzUmVsZWFzZWFibGUodmFsdWUsIGRlcHRoICsgMSkpIHsKCSAgICAgICAgcmV0dXJuIHRydWU7CgkgICAgICB9CgkgICAgfQoJICAgIHJldHVybiBmYWxzZTsKCSAgfTsKCgkgIGtiLnJlbGVhc2UgPSBmdW5jdGlvbihvYmopIHsKCSAgICB2YXIgYXJyYXksIGluZGV4LCBtZXRob2QsIHZhbHVlLCBfaSwgX2xlbjsKCSAgICBpZiAoIWtiLmlzUmVsZWFzZWFibGUob2JqKSkgewoJICAgICAgcmV0dXJuOwoJICAgIH0KCSAgICBvYmouX19rYl9yZWxlYXNlZCA9IHRydWU7CgkgICAgaWYgKF8uaXNBcnJheShvYmopKSB7CgkgICAgICBmb3IgKGluZGV4IGluIG9iaikgewoJICAgICAgICB2YWx1ZSA9IG9ialtpbmRleF07CgkgICAgICAgIGlmIChrYi5pc1JlbGVhc2VhYmxlKHZhbHVlKSkgewoJICAgICAgICAgIG9ialtpbmRleF0gPSBudWxsOwoJICAgICAgICAgIGtiLnJlbGVhc2UodmFsdWUpOwoJICAgICAgICB9CgkgICAgICB9CgkgICAgICByZXR1cm47CgkgICAgfQoJICAgIGlmIChrby5pc09ic2VydmFibGUob2JqKSAmJiBfLmlzQXJyYXkoYXJyYXkgPSBrYi5wZWVrKG9iaikpKSB7CgkgICAgICBpZiAob2JqLl9fa2JfaXNfY28gfHwgKG9iai5fX2tiX2lzX28gJiYgKG9iai52YWx1ZVR5cGUoKSA9PT0ga2IuVFlQRV9DT0xMRUNUSU9OKSkpIHsKCSAgICAgICAgcmV0dXJuIHR5cGVvZiBvYmouZGVzdHJveSA9PT0gImZ1bmN0aW9uIiA/IG9iai5kZXN0cm95KCkgOiB2b2lkIDA7CgkgICAgICB9CgkgICAgICBmb3IgKGluZGV4IGluIGFycmF5KSB7CgkgICAgICAgIHZhbHVlID0gYXJyYXlbaW5kZXhdOwoJICAgICAgICBpZiAoa2IuaXNSZWxlYXNlYWJsZSh2YWx1ZSkpIHsKCSAgICAgICAgICBhcnJheVtpbmRleF0gPSBudWxsOwoJICAgICAgICAgIGtiLnJlbGVhc2UodmFsdWUpOwoJICAgICAgICB9CgkgICAgICB9CgkgICAgICBpZiAodHlwZW9mIG9iai5kaXNwb3NlID09PSAnZnVuY3Rpb24nKSB7CgkgICAgICAgIG9iai5kaXNwb3NlKCk7CgkgICAgICB9CgkgICAgICByZXR1cm47CgkgICAgfQoJICAgIGZvciAoX2kgPSAwLCBfbGVuID0gTElGRUNZQ0xFX01FVEhPRFMubGVuZ3RoOyBfaSA8IF9sZW47IF9pKyspIHsKCSAgICAgIG1ldGhvZCA9IExJRkVDWUNMRV9NRVRIT0RTW19pXTsKCSAgICAgIGlmICh0eXBlb2Ygb2JqW21ldGhvZF0gPT09ICdmdW5jdGlvbicpIHsKCSAgICAgICAgcmV0dXJuIG9ialttZXRob2RdLmNhbGwob2JqKTsKCSAgICAgIH0KCSAgICB9CgkgICAgaWYgKCFrby5pc09ic2VydmFibGUob2JqKSkgewoJICAgICAgcmV0dXJuIHRoaXMucmVsZWFzZUtleXMob2JqKTsKCSAgICB9CgkgIH07CgoJICBrYi5yZWxlYXNlS2V5cyA9IGZ1bmN0aW9uKG9iaikgewoJICAgIHZhciBrZXksIHZhbHVlOwoJICAgIGZvciAoa2V5IGluIG9iaikgewoJICAgICAgdmFsdWUgPSBvYmpba2V5XTsKCSAgICAgIGlmIChrZXkgIT09ICdfX2tiJyAmJiBrYi5pc1JlbGVhc2VhYmxlKHZhbHVlKSkgewoJICAgICAgICBvYmpba2V5XSA9IG51bGw7CgkgICAgICAgIGtiLnJlbGVhc2UodmFsdWUpOwoJICAgICAgfQoJICAgIH0KCSAgfTsKCgkgIGtiLnJlbGVhc2VPbk5vZGVSZW1vdmUgPSBmdW5jdGlvbih2aWV3X21vZGVsLCBub2RlKSB7CgkgICAgdmlld19tb2RlbCB8fCBrYi5fdGhyb3dVbmV4cGVjdGVkKHRoaXMsICdtaXNzaW5nIHZpZXcgbW9kZWwnKTsKCSAgICBub2RlIHx8IGtiLl90aHJvd1VuZXhwZWN0ZWQodGhpcywgJ21pc3Npbmcgbm9kZScpOwoJICAgIHJldHVybiBrby51dGlscy5kb21Ob2RlRGlzcG9zYWwuYWRkRGlzcG9zZUNhbGxiYWNrKG5vZGUsIGZ1bmN0aW9uKCkgewoJICAgICAgcmV0dXJuIGtiLnJlbGVhc2Uodmlld19tb2RlbCk7CgkgICAgfSk7CgkgIH07CgoJICBrYi5yZW5kZXJUZW1wbGF0ZSA9IGZ1bmN0aW9uKHRlbXBsYXRlLCB2aWV3X21vZGVsLCBvcHRpb25zKSB7CgkgICAgdmFyIGRvY3VtZW50LCBlbCwgb2JzZXJ2YWJsZTsKCSAgICBpZiAob3B0aW9ucyA9PSBudWxsKSB7CgkgICAgICBvcHRpb25zID0ge307CgkgICAgfQoJICAgIGlmICghKGRvY3VtZW50ID0gd2luZG93ICE9IG51bGwgPyB3aW5kb3cuZG9jdW1lbnQgOiB2b2lkIDApKSB7CgkgICAgICByZXR1cm4gdHlwZW9mIGNvbnNvbGUgIT09ICJ1bmRlZmluZWQiICYmIGNvbnNvbGUgIT09IG51bGwgPyBjb25zb2xlLmxvZygncmVuZGVyVGVtcGxhdGU6IGRvY3VtZW50IGlzIHVuZGVmaW5lZCcpIDogdm9pZCAwOwoJICAgIH0KCSAgICBlbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwoJICAgIG9ic2VydmFibGUgPSBrby5yZW5kZXJUZW1wbGF0ZSh0ZW1wbGF0ZSwgdmlld19tb2RlbCwgb3B0aW9ucywgZWwsICdyZXBsYWNlQ2hpbGRyZW4nKTsKCSAgICBpZiAoZWwuY2hpbGROb2Rlcy5sZW5ndGggPT09IDEpIHsKCSAgICAgIGVsID0gZWwuY2hpbGROb2Rlc1swXTsKCSAgICB9IGVsc2UgaWYgKGVsLmNoaWxkTm9kZXMubGVuZ3RoKSB7CgkgICAgICBrby5zdG9yZWRCaW5kaW5nQ29udGV4dEZvck5vZGUoZWwsIGtvLmNvbnRleHRGb3IoZWwuY2hpbGROb2Rlc1swXSkpOwoJICAgIH0KCSAgICBrYi5yZWxlYXNlT25Ob2RlUmVtb3ZlKHZpZXdfbW9kZWwsIGVsKTsKCSAgICBvYnNlcnZhYmxlLmRpc3Bvc2UoKTsKCSAgICBpZiAodmlld19tb2RlbC5hZnRlclJlbmRlciAmJiAhb3B0aW9ucy5hZnRlclJlbmRlcikgewoJICAgICAgdmlld19tb2RlbC5hZnRlclJlbmRlcihlbCk7CgkgICAgfQoJICAgIHJldHVybiBlbDsKCSAgfTsKCgkgIGtiLmFwcGx5QmluZGluZ3MgPSBmdW5jdGlvbih2aWV3X21vZGVsLCBub2RlKSB7CgkgICAgdmFyIGNoaWxkLCBjaGlsZHJlbiwgX2ksIF9sZW4sIF9yZWY7CgkgICAgaWYgKG5vZGUubGVuZ3RoKSB7CgkgICAgICBfcmVmID0gW2RvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpLCBub2RlXSwgbm9kZSA9IF9yZWZbMF0sIGNoaWxkcmVuID0gX3JlZlsxXTsKCSAgICAgIGZvciAoX2kgPSAwLCBfbGVuID0gY2hpbGRyZW4ubGVuZ3RoOyBfaSA8IF9sZW47IF9pKyspIHsKCSAgICAgICAgY2hpbGQgPSBjaGlsZHJlbltfaV07CgkgICAgICAgIG5vZGUuYXBwZW5kQ2hpbGQoY2hpbGQpOwoJICAgICAgfQoJICAgIH0KCSAgICBrby5hcHBseUJpbmRpbmdzKHZpZXdfbW9kZWwsIG5vZGUpOwoJICAgIGtiLnJlbGVhc2VPbk5vZGVSZW1vdmUodmlld19tb2RlbCwgbm9kZSk7CgkgICAgcmV0dXJuIG5vZGU7CgkgIH07CgoJICBrYi5nZXRWYWx1ZSA9IGZ1bmN0aW9uKG1vZGVsLCBrZXksIGFyZ3MpIHsKCSAgICB2YXIgX3JlZjsKCSAgICBpZiAoIW1vZGVsKSB7CgkgICAgICByZXR1cm47CgkgICAgfQoJICAgIGlmIChfLmlzRnVuY3Rpb24obW9kZWxba2V5XSkgJiYgKChfcmVmID0ga2Iub3JtKSAhPSBudWxsID8gX3JlZi51c2VGdW5jdGlvbihtb2RlbCwga2V5KSA6IHZvaWQgMCkpIHsKCSAgICAgIHJldHVybiBtb2RlbFtrZXldKCk7CgkgICAgfQoJICAgIGlmICghYXJncykgewoJICAgICAgcmV0dXJuIG1vZGVsLmdldChrZXkpOwoJICAgIH0KCSAgICByZXR1cm4gbW9kZWwuZ2V0LmFwcGx5KG1vZGVsLCBfLm1hcChba2V5XS5jb25jYXQoYXJncyksIGZ1bmN0aW9uKHZhbHVlKSB7CgkgICAgICByZXR1cm4ga2IucGVlayh2YWx1ZSk7CgkgICAgfSkpOwoJICB9OwoKCSAga2Iuc2V0VmFsdWUgPSBmdW5jdGlvbihtb2RlbCwga2V5LCB2YWx1ZSkgewoJICAgIHZhciBhdHRyaWJ1dGVzLCBfcmVmOwoJICAgIGlmICghbW9kZWwpIHsKCSAgICAgIHJldHVybjsKCSAgICB9CgkgICAgaWYgKF8uaXNGdW5jdGlvbihtb2RlbFtrZXldKSAmJiAoKF9yZWYgPSBrYi5vcm0pICE9IG51bGwgPyBfcmVmLnVzZUZ1bmN0aW9uKG1vZGVsLCBrZXkpIDogdm9pZCAwKSkgewoJICAgICAgcmV0dXJuIG1vZGVsW2tleV0odmFsdWUpOwoJICAgIH0KCSAgICAoYXR0cmlidXRlcyA9IHt9KVtrZXldID0gdmFsdWU7CgkgICAgcmV0dXJuIG1vZGVsLnNldChhdHRyaWJ1dGVzKTsKCSAgfTsKCgkgIGtiLmlnbm9yZSA9ICgoX3JlZiA9IGtvLmRlcGVuZGVuY3lEZXRlY3Rpb24pICE9IG51bGwgPyBfcmVmLmlnbm9yZSA6IHZvaWQgMCkgfHwgZnVuY3Rpb24oY2FsbGJhY2ssIGNhbGxiYWNrVGFyZ2V0LCBjYWxsYmFja0FyZ3MpIHsKCSAgICB2YXIgdmFsdWU7CgkgICAgdmFsdWUgPSBudWxsOwoJICAgIGtvLmNvbXB1dGVkKGZ1bmN0aW9uKCkgewoJICAgICAgcmV0dXJuIHZhbHVlID0gY2FsbGJhY2suYXBwbHkoY2FsbGJhY2tUYXJnZXQsIGNhbGxiYWNrQXJncyB8fCBbXSk7CgkgICAgfSkuZGlzcG9zZSgpOwoJICAgIHJldHVybiB2YWx1ZTsKCSAgfTsKCgkgIGtiLmV4dGVuZCA9IF9fd2VicGFja19yZXF1aXJlX18oMTkpOwoKCSAga2IuX3Rocm93TWlzc2luZyA9IGZ1bmN0aW9uKGluc3RhbmNlLCBtZXNzYWdlKSB7CgkgICAgdGhyb3cgIiIgKyAoXy5pc1N0cmluZyhpbnN0YW5jZSkgPyBpbnN0YW5jZSA6IGluc3RhbmNlLmNvbnN0cnVjdG9yLm5hbWUpICsgIjogIiArIG1lc3NhZ2UgKyAiIGlzIG1pc3NpbmciOwoJICB9OwoKCSAga2IuX3Rocm93VW5leHBlY3RlZCA9IGZ1bmN0aW9uKGluc3RhbmNlLCBtZXNzYWdlKSB7CgkgICAgdGhyb3cgIiIgKyAoXy5pc1N0cmluZyhpbnN0YW5jZSkgPyBpbnN0YW5jZSA6IGluc3RhbmNlLmNvbnN0cnVjdG9yLm5hbWUpICsgIjogIiArIG1lc3NhZ2UgKyAiIGlzIHVuZXhwZWN0ZWQiOwoJICB9OwoKCSAga2IucHVibGlzaE1ldGhvZHMgPSBmdW5jdGlvbihvYnNlcnZhYmxlLCBpbnN0YW5jZSwgbWV0aG9kcykgewoJICAgIHZhciBmbiwgX2ksIF9sZW47CgkgICAgZm9yIChfaSA9IDAsIF9sZW4gPSBtZXRob2RzLmxlbmd0aDsgX2kgPCBfbGVuOyBfaSsrKSB7CgkgICAgICBmbiA9IG1ldGhvZHNbX2ldOwoJICAgICAgb2JzZXJ2YWJsZVtmbl0gPSBrYi5fLmJpbmQoaW5zdGFuY2VbZm5dLCBpbnN0YW5jZSk7CgkgICAgfQoJICB9OwoKCSAga2IucGVlayA9IGZ1bmN0aW9uKG9icykgewoJICAgIGlmICgha28uaXNPYnNlcnZhYmxlKG9icykpIHsKCSAgICAgIHJldHVybiBvYnM7CgkgICAgfQoJICAgIGlmIChvYnMucGVlaykgewoJICAgICAgcmV0dXJuIG9icy5wZWVrKCk7CgkgICAgfQoJICAgIHJldHVybiBrYi5pZ25vcmUoZnVuY3Rpb24oKSB7CgkgICAgICByZXR1cm4gb2JzKCk7CgkgICAgfSk7CgkgIH07CgoJICBrYi5pc01vZGVsID0gZnVuY3Rpb24ob2JqKSB7CgkgICAgcmV0dXJuIG9iaiAmJiAoKG9iaiBpbnN0YW5jZW9mIGtiLk1vZGVsKSB8fCAoKHR5cGVvZiBvYmouZ2V0ID09PSAnZnVuY3Rpb24nKSAmJiAodHlwZW9mIG9iai5iaW5kID09PSAnZnVuY3Rpb24nKSkpOwoJICB9OwoKCSAga2IuaXNDb2xsZWN0aW9uID0gZnVuY3Rpb24ob2JqKSB7CgkgICAgcmV0dXJuIG9iaiAmJiAob2JqIGluc3RhbmNlb2Yga2IuQ29sbGVjdGlvbik7CgkgIH07CgoJICByZXR1cm4ga2I7CgoJfSkoKTsKCglpZiAod2luZG93LlBhcnNlKSB7CgkgIEJhY2tib25lID0ga2IuUGFyc2UgPSB3aW5kb3cuUGFyc2U7CgkgIF8gPSBrYi5fID0gd2luZG93LlBhcnNlLl87Cgl9IGVsc2UgewoJICBCYWNrYm9uZSA9IGtiLkJhY2tib25lID0gX193ZWJwYWNrX3JlcXVpcmVfXygyMyk7CgkgIF8gPSBrYi5fID0gX193ZWJwYWNrX3JlcXVpcmVfXygyNCk7Cgl9CgoJa2Iua28gPSBrbzsKCglrYi5Db2xsZWN0aW9uID0gQmFja2JvbmUuQ29sbGVjdGlvbjsKCglrYi5Nb2RlbCA9IEJhY2tib25lLk9iamVjdCB8fCBCYWNrYm9uZS5Nb2RlbDsKCglrYi5FdmVudHMgPSBCYWNrYm9uZS5FdmVudHM7CgoJa2IuJCA9IHdpbmRvdy5qUXVlcnkgfHwgd2luZG93LiQ7CgoJdHJ5IHsKCSAga2IuJCB8fCAoa2IuJCA9IF9fd2VicGFja19yZXF1aXJlX18oMTUpKTsKCX0gY2F0Y2ggKF9lcnJvcikge30KCQoJLyogV0VCUEFDSyBWQVIgSU5KRUNUSU9OICovfS5jYWxsKGV4cG9ydHMsIChmdW5jdGlvbigpIHsgcmV0dXJuIHRoaXM7IH0oKSkpKQoKLyoqKi8gfSwKLyogNyAqLwovKioqLyBmdW5jdGlvbihtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKCgkKCS8qCgkgIGtub2NrYmFjay5qcyAwLjIwLjQKCSAgQ29weXJpZ2h0IChjKSAgMjAxMS0yMDE0IEtldmluIE1hbGFrb2ZmLgoJICBMaWNlbnNlOiBNSVQgKGh0dHA6Ly93d3cub3BlbnNvdXJjZS5vcmcvbGljZW5zZXMvbWl0LWxpY2Vuc2UucGhwKQoJICBTb3VyY2U6IGh0dHBzOi8vZ2l0aHViLmNvbS9rbWFsYWtvZmYva25vY2tiYWNrCgkgIERlcGVuZGVuY2llczogS25vY2tvdXQuanMsIEJhY2tib25lLmpzLCBhbmQgVW5kZXJzY29yZS5qcyAob3IgTG9EYXNoLmpzKS4KCSAgT3B0aW9uYWwgZGVwZW5kZW5jaWVzOiBCYWNrYm9uZS5Nb2RlbFJlZi5qcyBhbmQgQmFja2JvbmVPUk0uCgkgKi8KCXZhciBrYiwga28sIF9leHRlbmQsIF9yZWYsIF9yZWYxOwoKCWtvID0gKGtiID0gX193ZWJwYWNrX3JlcXVpcmVfXyg2KSkua287CgoJaWYgKChfcmVmID0ga28uc3Vic2NyaWJhYmxlKSAhPSBudWxsID8gKF9yZWYxID0gX3JlZi5mbikgIT0gbnVsbCA/IF9yZWYxLmV4dGVuZCA6IHZvaWQgMCA6IHZvaWQgMCkgewoJICBfZXh0ZW5kID0ga28uc3Vic2NyaWJhYmxlLmZuLmV4dGVuZDsKCSAga28uc3Vic2NyaWJhYmxlLmZuLmV4dGVuZCA9IGZ1bmN0aW9uKCkgewoJICAgIHZhciB0YXJnZXQsIF9kaXNwb3NlOwoJICAgIHRhcmdldCA9IF9leHRlbmQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCSAgICBpZiAodGFyZ2V0ICE9PSB0aGlzICYmIGtiLmlzUmVsZWFzZWFibGUodGhpcykpIHsKCSAgICAgIF9kaXNwb3NlID0gdGFyZ2V0LmRpc3Bvc2U7CgkgICAgICB0YXJnZXQuZGlzcG9zZSA9IChmdW5jdGlvbihfdGhpcykgewoJICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CgkgICAgICAgICAgaWYgKF9kaXNwb3NlICE9IG51bGwpIHsKCSAgICAgICAgICAgIF9kaXNwb3NlLmFwcGx5KHRhcmdldCwgYXJndW1lbnRzKTsKCSAgICAgICAgICB9CgkgICAgICAgICAgcmV0dXJuIGtiLnJlbGVhc2UoX3RoaXMpOwoJICAgICAgICB9OwoJICAgICAgfSkodGhpcyk7CgkgICAgfQoJICAgIHJldHVybiB0YXJnZXQ7CgkgIH07Cgl9CgoKLyoqKi8gfSwKLyogOCAqLwovKioqLyBmdW5jdGlvbihtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKCgkKCS8qCgkgIGtub2NrYmFjay5qcyAwLjIwLjQKCSAgQ29weXJpZ2h0IChjKSAgMjAxMS0yMDE0IEtldmluIE1hbGFrb2ZmLgoJICBMaWNlbnNlOiBNSVQgKGh0dHA6Ly93d3cub3BlbnNvdXJjZS5vcmcvbGljZW5zZXMvbWl0LWxpY2Vuc2UucGhwKQoJICBTb3VyY2U6IGh0dHBzOi8vZ2l0aHViLmNvbS9rbWFsYWtvZmYva25vY2tiYWNrCgkgIERlcGVuZGVuY2llczogS25vY2tvdXQuanMsIEJhY2tib25lLmpzLCBhbmQgVW5kZXJzY29yZS5qcyAob3IgTG9EYXNoLmpzKS4KCSAgT3B0aW9uYWwgZGVwZW5kZW5jaWVzOiBCYWNrYm9uZS5Nb2RlbFJlZi5qcyBhbmQgQmFja2JvbmVPUk0uCgkgKi8KCXZhciBLRVlTX0lORk8sIEtFWVNfUFVCTElTSCwgVHlwZWRWYWx1ZSwga2IsIGtvLCBfLCBfcmVmOwoKCV9yZWYgPSBrYiA9IF9fd2VicGFja19yZXF1aXJlX18oNiksIF8gPSBfcmVmLl8sIGtvID0gX3JlZi5rbzsKCglUeXBlZFZhbHVlID0gX193ZWJwYWNrX3JlcXVpcmVfXygxMSk7CgoJS0VZU19QVUJMSVNIID0gWyd2YWx1ZScsICd2YWx1ZVR5cGUnLCAnZGVzdHJveSddOwoKCUtFWVNfSU5GTyA9IFsnYXJncycsICdyZWFkJywgJ3dyaXRlJ107CgoJa2IuT2JzZXJ2YWJsZSA9IChmdW5jdGlvbigpIHsKCSAgZnVuY3Rpb24gT2JzZXJ2YWJsZShtb2RlbCwga2V5X29yX2luZm8sIG9wdGlvbnMsIF92bSkgewoJICAgIHRoaXMuX3ZtID0gX3ZtICE9IG51bGwgPyBfdm0gOiB7fTsKCSAgICByZXR1cm4ga2IuaWdub3JlKChmdW5jdGlvbihfdGhpcykgewoJICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewoJICAgICAgICB2YXIgY3JlYXRlX29wdGlvbnMsIGV2ZW50X3dhdGNoZXIsIGtleSwgb2JzZXJ2YWJsZSwgX2ksIF9sZW47CgkgICAgICAgIGtleV9vcl9pbmZvIHx8IGtiLl90aHJvd01pc3NpbmcoX3RoaXMsICdrZXlfb3JfaW5mbycpOwoJICAgICAgICBfdGhpcy5rZXkgPSBrZXlfb3JfaW5mby5rZXkgfHwga2V5X29yX2luZm87CgkgICAgICAgIGZvciAoX2kgPSAwLCBfbGVuID0gS0VZU19JTkZPLmxlbmd0aDsgX2kgPCBfbGVuOyBfaSsrKSB7CgkgICAgICAgICAga2V5ID0gS0VZU19JTkZPW19pXTsKCSAgICAgICAgICBpZiAoa2V5X29yX2luZm9ba2V5XSkgewoJICAgICAgICAgICAgX3RoaXNba2V5XSA9IGtleV9vcl9pbmZvW2tleV07CgkgICAgICAgICAgfQoJICAgICAgICB9CgkgICAgICAgIGNyZWF0ZV9vcHRpb25zID0ga2IudXRpbHMuY29sbGFwc2VPcHRpb25zKG9wdGlvbnMpOwoJICAgICAgICBldmVudF93YXRjaGVyID0gY3JlYXRlX29wdGlvbnMuZXZlbnRfd2F0Y2hlcjsKCSAgICAgICAgZGVsZXRlIGNyZWF0ZV9vcHRpb25zLmV2ZW50X3dhdGNoZXI7CgkgICAgICAgIF90aGlzLl92YWx1ZSA9IG5ldyBUeXBlZFZhbHVlKGNyZWF0ZV9vcHRpb25zKTsKCSAgICAgICAgX3RoaXMuX21vZGVsID0ga28ub2JzZXJ2YWJsZSgpOwoJICAgICAgICBvYnNlcnZhYmxlID0ga2IudXRpbHMud3JhcHBlZE9ic2VydmFibGUoX3RoaXMsIGtvLmNvbXB1dGVkKHsKCSAgICAgICAgICByZWFkOiBmdW5jdGlvbigpIHsKCSAgICAgICAgICAgIHZhciBhcmcsIGFyZ3MsIF9qLCBfbGVuMSwgX21vZGVsLCBfcmVmMSwgX3JlZjI7CgkgICAgICAgICAgICBfbW9kZWwgPSBfdGhpcy5fbW9kZWwoKTsKCSAgICAgICAgICAgIF9yZWYxID0gYXJncyA9IFtfdGhpcy5rZXldLmNvbmNhdChfdGhpcy5hcmdzIHx8IFtdKTsKCSAgICAgICAgICAgIGZvciAoX2ogPSAwLCBfbGVuMSA9IF9yZWYxLmxlbmd0aDsgX2ogPCBfbGVuMTsgX2orKykgewoJICAgICAgICAgICAgICBhcmcgPSBfcmVmMVtfal07CgkgICAgICAgICAgICAgIGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUoYXJnKTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIGlmICgoX3JlZjIgPSBrYi51dGlscy53cmFwcGVkRXZlbnRXYXRjaGVyKF90aGlzKSkgIT0gbnVsbCkgewoJICAgICAgICAgICAgICBfcmVmMi5lbWl0dGVyKF9tb2RlbCB8fCBudWxsKTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIGlmIChfdGhpcy5yZWFkKSB7CgkgICAgICAgICAgICAgIF90aGlzLnVwZGF0ZShfdGhpcy5yZWFkLmFwcGx5KF90aGlzLl92bSwgYXJncykpOwoJICAgICAgICAgICAgfSBlbHNlIGlmICghXy5pc1VuZGVmaW5lZChfbW9kZWwpKSB7CgkgICAgICAgICAgICAgIGtiLmlnbm9yZShmdW5jdGlvbigpIHsKCSAgICAgICAgICAgICAgICByZXR1cm4gX3RoaXMudXBkYXRlKGtiLmdldFZhbHVlKF9tb2RlbCwga2IucGVlayhfdGhpcy5rZXkpLCBfdGhpcy5hcmdzKSk7CgkgICAgICAgICAgICAgIH0pOwoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgcmV0dXJuIF90aGlzLl92YWx1ZS52YWx1ZSgpOwoJICAgICAgICAgIH0sCgkgICAgICAgICAgd3JpdGU6IGZ1bmN0aW9uKG5ld192YWx1ZSkgewoJICAgICAgICAgICAgcmV0dXJuIGtiLmlnbm9yZShmdW5jdGlvbigpIHsKCSAgICAgICAgICAgICAgdmFyIHVud3JhcHBlZF9uZXdfdmFsdWUsIF9tb2RlbDsKCSAgICAgICAgICAgICAgdW53cmFwcGVkX25ld192YWx1ZSA9IGtiLnV0aWxzLnVud3JhcE1vZGVscyhuZXdfdmFsdWUpOwoJICAgICAgICAgICAgICBfbW9kZWwgPSBrYi5wZWVrKF90aGlzLl9tb2RlbCk7CgkgICAgICAgICAgICAgIGlmIChfdGhpcy53cml0ZSkgewoJICAgICAgICAgICAgICAgIF90aGlzLndyaXRlLmNhbGwoX3RoaXMuX3ZtLCB1bndyYXBwZWRfbmV3X3ZhbHVlKTsKCSAgICAgICAgICAgICAgICBuZXdfdmFsdWUgPSBrYi5nZXRWYWx1ZShfbW9kZWwsIGtiLnBlZWsoX3RoaXMua2V5KSwgX3RoaXMuYXJncyk7CgkgICAgICAgICAgICAgIH0gZWxzZSBpZiAoX21vZGVsKSB7CgkgICAgICAgICAgICAgICAga2Iuc2V0VmFsdWUoX21vZGVsLCBrYi5wZWVrKF90aGlzLmtleSksIHVud3JhcHBlZF9uZXdfdmFsdWUpOwoJICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgIHJldHVybiBfdGhpcy51cGRhdGUobmV3X3ZhbHVlKTsKCSAgICAgICAgICAgIH0pOwoJICAgICAgICAgIH0sCgkgICAgICAgICAgb3duZXI6IF90aGlzLl92bQoJICAgICAgICB9KSk7CgkgICAgICAgIG9ic2VydmFibGUuX19rYl9pc19vID0gdHJ1ZTsKCSAgICAgICAgY3JlYXRlX29wdGlvbnMuc3RvcmUgPSBrYi51dGlscy53cmFwcGVkU3RvcmUob2JzZXJ2YWJsZSwgY3JlYXRlX29wdGlvbnMuc3RvcmUpOwoJICAgICAgICBjcmVhdGVfb3B0aW9ucy5wYXRoID0ga2IudXRpbHMucGF0aEpvaW4oY3JlYXRlX29wdGlvbnMucGF0aCwgX3RoaXMua2V5KTsKCSAgICAgICAgaWYgKGNyZWF0ZV9vcHRpb25zLmZhY3RvcmllcyAmJiAoKHR5cGVvZiBjcmVhdGVfb3B0aW9ucy5mYWN0b3JpZXMgPT09ICdmdW5jdGlvbicpIHx8IGNyZWF0ZV9vcHRpb25zLmZhY3Rvcmllcy5jcmVhdGUpKSB7CgkgICAgICAgICAgY3JlYXRlX29wdGlvbnMuZmFjdG9yeSA9IGtiLnV0aWxzLndyYXBwZWRGYWN0b3J5KG9ic2VydmFibGUsIG5ldyBrYi5GYWN0b3J5KGNyZWF0ZV9vcHRpb25zLmZhY3RvcnkpKTsKCSAgICAgICAgICBjcmVhdGVfb3B0aW9ucy5mYWN0b3J5LmFkZFBhdGhNYXBwaW5nKGNyZWF0ZV9vcHRpb25zLnBhdGgsIGNyZWF0ZV9vcHRpb25zLmZhY3Rvcmllcyk7CgkgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgY3JlYXRlX29wdGlvbnMuZmFjdG9yeSA9IGtiLkZhY3RvcnkudXNlT3B0aW9uc09yQ3JlYXRlKGNyZWF0ZV9vcHRpb25zLCBvYnNlcnZhYmxlLCBjcmVhdGVfb3B0aW9ucy5wYXRoKTsKCSAgICAgICAgfQoJICAgICAgICBkZWxldGUgY3JlYXRlX29wdGlvbnMuZmFjdG9yaWVzOwoJICAgICAgICBrYi5wdWJsaXNoTWV0aG9kcyhvYnNlcnZhYmxlLCBfdGhpcywgS0VZU19QVUJMSVNIKTsKCSAgICAgICAgb2JzZXJ2YWJsZS5tb2RlbCA9IF90aGlzLm1vZGVsID0ga28uY29tcHV0ZWQoewoJICAgICAgICAgIHJlYWQ6IGZ1bmN0aW9uKCkgewoJICAgICAgICAgICAgcmV0dXJuIGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUoX3RoaXMuX21vZGVsKTsKCSAgICAgICAgICB9LAoJICAgICAgICAgIHdyaXRlOiBmdW5jdGlvbihuZXdfbW9kZWwpIHsKCSAgICAgICAgICAgIHJldHVybiBrYi5pZ25vcmUoZnVuY3Rpb24oKSB7CgkgICAgICAgICAgICAgIHZhciBuZXdfdmFsdWU7CgkgICAgICAgICAgICAgIGlmIChfdGhpcy5fX2tiX3JlbGVhc2VkIHx8IChrYi5wZWVrKF90aGlzLl9tb2RlbCkgPT09IG5ld19tb2RlbCkpIHsKCSAgICAgICAgICAgICAgICByZXR1cm47CgkgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgbmV3X3ZhbHVlID0ga2IuZ2V0VmFsdWUobmV3X21vZGVsLCBrYi5wZWVrKF90aGlzLmtleSksIF90aGlzLmFyZ3MpOwoJICAgICAgICAgICAgICBfdGhpcy5fbW9kZWwobmV3X21vZGVsKTsKCSAgICAgICAgICAgICAgaWYgKCFuZXdfbW9kZWwpIHsKCSAgICAgICAgICAgICAgICByZXR1cm4gX3RoaXMudXBkYXRlKG51bGwpOwoJICAgICAgICAgICAgICB9IGVsc2UgaWYgKCFfLmlzVW5kZWZpbmVkKG5ld192YWx1ZSkpIHsKCSAgICAgICAgICAgICAgICByZXR1cm4gX3RoaXMudXBkYXRlKG5ld192YWx1ZSk7CgkgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgIH0pOwoJICAgICAgICAgIH0KCSAgICAgICAgfSk7CgkgICAgICAgIGtiLkV2ZW50V2F0Y2hlci51c2VPcHRpb25zT3JDcmVhdGUoewoJICAgICAgICAgIGV2ZW50X3dhdGNoZXI6IGV2ZW50X3dhdGNoZXIKCSAgICAgICAgfSwgbW9kZWwgfHwgbnVsbCwgX3RoaXMsIHsKCSAgICAgICAgICBlbWl0dGVyOiBfdGhpcy5tb2RlbCwKCSAgICAgICAgICB1cGRhdGU6IChmdW5jdGlvbigpIHsKCSAgICAgICAgICAgIHJldHVybiBrYi5pZ25vcmUoZnVuY3Rpb24oKSB7CgkgICAgICAgICAgICAgIHJldHVybiBfdGhpcy51cGRhdGUoKTsKCSAgICAgICAgICAgIH0pOwoJICAgICAgICAgIH0pLAoJICAgICAgICAgIGtleTogX3RoaXMua2V5LAoJICAgICAgICAgIHBhdGg6IGNyZWF0ZV9vcHRpb25zLnBhdGgKCSAgICAgICAgfSk7CgkgICAgICAgIF90aGlzLl92YWx1ZS5yYXdWYWx1ZSgpIHx8IF90aGlzLl92YWx1ZS51cGRhdGUoKTsKCSAgICAgICAgaWYgKGtiLkxvY2FsaXplZE9ic2VydmFibGUgJiYga2V5X29yX2luZm8ubG9jYWxpemVyKSB7CgkgICAgICAgICAgb2JzZXJ2YWJsZSA9IG5ldyBrZXlfb3JfaW5mby5sb2NhbGl6ZXIob2JzZXJ2YWJsZSk7CgkgICAgICAgIH0KCSAgICAgICAgaWYgKGtiLkRlZmF1bHRPYnNlcnZhYmxlICYmIGtleV9vcl9pbmZvLmhhc093blByb3BlcnR5KCdkZWZhdWx0JykpIHsKCSAgICAgICAgICBvYnNlcnZhYmxlID0ga2IuZGVmYXVsdE9ic2VydmFibGUob2JzZXJ2YWJsZSwga2V5X29yX2luZm9bImRlZmF1bHQiXSk7CgkgICAgICAgIH0KCSAgICAgICAgcmV0dXJuIG9ic2VydmFibGU7CgkgICAgICB9OwoJICAgIH0pKHRoaXMpKTsKCSAgfQoKCSAgT2JzZXJ2YWJsZS5wcm90b3R5cGUuZGVzdHJveSA9IGZ1bmN0aW9uKCkgewoJICAgIHZhciBvYnNlcnZhYmxlOwoJICAgIG9ic2VydmFibGUgPSBrYi51dGlscy53cmFwcGVkT2JzZXJ2YWJsZSh0aGlzKTsKCSAgICB0aGlzLl9fa2JfcmVsZWFzZWQgPSB0cnVlOwoJICAgIHRoaXMuX3ZhbHVlLmRlc3Ryb3koKTsKCSAgICB0aGlzLl92YWx1ZSA9IG51bGw7CgkgICAgdGhpcy5tb2RlbC5kaXNwb3NlKCk7CgkgICAgdGhpcy5tb2RlbCA9IG9ic2VydmFibGUubW9kZWwgPSBudWxsOwoJICAgIHJldHVybiBrYi51dGlscy53cmFwcGVkRGVzdHJveSh0aGlzKTsKCSAgfTsKCgkgIE9ic2VydmFibGUucHJvdG90eXBlLnZhbHVlID0gZnVuY3Rpb24oKSB7CgkgICAgcmV0dXJuIHRoaXMuX3ZhbHVlLnJhd1ZhbHVlKCk7CgkgIH07CgoJICBPYnNlcnZhYmxlLnByb3RvdHlwZS52YWx1ZVR5cGUgPSBmdW5jdGlvbigpIHsKCSAgICByZXR1cm4gdGhpcy5fdmFsdWUudmFsdWVUeXBlKGtiLnBlZWsodGhpcy5fbW9kZWwpLCBrYi5wZWVrKHRoaXMua2V5KSk7CgkgIH07CgoJICBPYnNlcnZhYmxlLnByb3RvdHlwZS51cGRhdGUgPSBmdW5jdGlvbihuZXdfdmFsdWUpIHsKCSAgICBpZiAodGhpcy5fX2tiX3JlbGVhc2VkKSB7CgkgICAgICByZXR1cm47CgkgICAgfQoJICAgIGlmICghYXJndW1lbnRzLmxlbmd0aCkgewoJICAgICAgbmV3X3ZhbHVlID0ga2IuZ2V0VmFsdWUoa2IucGVlayh0aGlzLl9tb2RlbCksIGtiLnBlZWsodGhpcy5rZXkpKTsKCSAgICB9CgkgICAgcmV0dXJuIHRoaXMuX3ZhbHVlLnVwZGF0ZShuZXdfdmFsdWUpOwoJICB9OwoKCSAgcmV0dXJuIE9ic2VydmFibGU7CgoJfSkoKTsKCglrYi5vYnNlcnZhYmxlID0gZnVuY3Rpb24obW9kZWwsIGtleSwgb3B0aW9ucywgdmlld19tb2RlbCkgewoJICByZXR1cm4gbmV3IGtiLk9ic2VydmFibGUobW9kZWwsIGtleSwgb3B0aW9ucywgdmlld19tb2RlbCk7Cgl9OwoKCi8qKiovIH0sCi8qIDkgKi8KLyoqKi8gZnVuY3Rpb24obW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CgoJCgkvKgoJICBrbm9ja2JhY2suanMgMC4yMC40CgkgIENvcHlyaWdodCAoYykgIDIwMTEtMjAxNCBLZXZpbiBNYWxha29mZi4KCSAgTGljZW5zZTogTUlUIChodHRwOi8vd3d3Lm9wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL21pdC1saWNlbnNlLnBocCkKCSAgU291cmNlOiBodHRwczovL2dpdGh1Yi5jb20va21hbGFrb2ZmL2tub2NrYmFjawoJICBEZXBlbmRlbmNpZXM6IEtub2Nrb3V0LmpzLCBCYWNrYm9uZS5qcywgYW5kIFVuZGVyc2NvcmUuanMgKG9yIExvRGFzaC5qcykuCgkgIE9wdGlvbmFsIGRlcGVuZGVuY2llczogQmFja2JvbmUuTW9kZWxSZWYuanMgYW5kIEJhY2tib25lT1JNLgoJICovCgl2YXIga2IsIF87CgoJXyA9IChrYiA9IF9fd2VicGFja19yZXF1aXJlX18oNikpLl87CgoJbW9kdWxlLmV4cG9ydHMgPSBrYi5TdGF0aXN0aWNzID0gKGZ1bmN0aW9uKCkgewoJICBmdW5jdGlvbiBTdGF0aXN0aWNzKCkgewoJICAgIHRoaXMubW9kZWxfZXZlbnRzX3RyYWNrZXIgPSBbXTsKCSAgICB0aGlzLnJlZ2lzdGVyZWRfdHJhY2tlciA9IHt9OwoJICB9CgoJICBTdGF0aXN0aWNzLnByb3RvdHlwZS5jbGVhciA9IGZ1bmN0aW9uKCkgewoJICAgIHJldHVybiB0aGlzLm1vZGVsX2V2ZW50c190cmFja2VyID0gW107CgkgIH07CgoJICBTdGF0aXN0aWNzLnByb3RvdHlwZS5hZGRNb2RlbEV2ZW50ID0gZnVuY3Rpb24oZXZlbnQpIHsKCSAgICByZXR1cm4gdGhpcy5tb2RlbF9ldmVudHNfdHJhY2tlci5wdXNoKGV2ZW50KTsKCSAgfTsKCgkgIFN0YXRpc3RpY3MucHJvdG90eXBlLm1vZGVsRXZlbnRzU3RhdHNTdHJpbmcgPSBmdW5jdGlvbigpIHsKCSAgICB2YXIgZXZlbnRfZ3JvdXBzLCBrZXksIHN0YXRzX3N0cmluZywgdmFsdWU7CgkgICAgc3RhdHNfc3RyaW5nID0gJyc7CgkgICAgc3RhdHNfc3RyaW5nICs9ICJUb3RhbCBDb3VudDogIiArIHRoaXMubW9kZWxfZXZlbnRzX3RyYWNrZXIubGVuZ3RoOwoJICAgIGV2ZW50X2dyb3VwcyA9IF8uZ3JvdXBCeSh0aGlzLm1vZGVsX2V2ZW50c190cmFja2VyLCBmdW5jdGlvbih0ZXN0KSB7CgkgICAgICByZXR1cm4gImV2ZW50IG5hbWU6ICciICsgdGVzdC5uYW1lICsgIicsIGF0dHJpYnV0ZSBuYW1lOiAnIiArIHRlc3Qua2V5ICsgIiciOwoJICAgIH0pOwoJICAgIGZvciAoa2V5IGluIGV2ZW50X2dyb3VwcykgewoJICAgICAgdmFsdWUgPSBldmVudF9ncm91cHNba2V5XTsKCSAgICAgIHN0YXRzX3N0cmluZyArPSAiXG4gIiArIGtleSArICIsIGNvdW50OiAiICsgdmFsdWUubGVuZ3RoOwoJICAgIH0KCSAgICByZXR1cm4gc3RhdHNfc3RyaW5nOwoJICB9OwoKCSAgU3RhdGlzdGljcy5wcm90b3R5cGUucmVnaXN0ZXIgPSBmdW5jdGlvbihrZXksIG9iaikgewoJICAgIHJldHVybiB0aGlzLnJlZ2lzdGVyZWRUcmFja2VyKGtleSkucHVzaChvYmopOwoJICB9OwoKCSAgU3RhdGlzdGljcy5wcm90b3R5cGUudW5yZWdpc3RlciA9IGZ1bmN0aW9uKGtleSwgb2JqKSB7CgkgICAgdmFyIGluZGV4LCB0eXBlX3RyYWNrZXI7CgkgICAgdHlwZV90cmFja2VyID0gdGhpcy5yZWdpc3RlcmVkVHJhY2tlcihrZXkpOwoJICAgIGlmICgoaW5kZXggPSBfLmluZGV4T2YodHlwZV90cmFja2VyLCBvYmopKSA8IDApIHsKCSAgICAgIHJldHVybiB0eXBlb2YgY29uc29sZSAhPT0gInVuZGVmaW5lZCIgJiYgY29uc29sZSAhPT0gbnVsbCA/IGNvbnNvbGUubG9nKCJrYi5TdGF0aXN0aWNzOiBmYWlsZWQgdG8gdW5yZWdpc3RlciB0eXBlOiAiICsga2V5KSA6IHZvaWQgMDsKCSAgICB9CgkgICAgcmV0dXJuIHR5cGVfdHJhY2tlci5zcGxpY2UoaW5kZXgsIDEpOwoJICB9OwoKCSAgU3RhdGlzdGljcy5wcm90b3R5cGUucmVnaXN0ZXJlZENvdW50ID0gZnVuY3Rpb24odHlwZSkgewoJICAgIHZhciBjb3VudCwgdHlwZV90cmFja2VyLCBfcmVmOwoJICAgIGlmICh0eXBlKSB7CgkgICAgICByZXR1cm4gdGhpcy5yZWdpc3RlcmVkVHJhY2tlcih0eXBlKS5sZW5ndGg7CgkgICAgfQoJICAgIGNvdW50ID0gMDsKCSAgICBfcmVmID0gdGhpcy5yZWdpc3RlcmVkX3RyYWNrZXJbdHlwZV07CgkgICAgZm9yICh0eXBlIGluIF9yZWYpIHsKCSAgICAgIHR5cGVfdHJhY2tlciA9IF9yZWZbdHlwZV07CgkgICAgICBjb3VudCArPSB0eXBlX3RyYWNrZXIubGVuZ3RoOwoJICAgIH0KCSAgICByZXR1cm4gY291bnQ7CgkgIH07CgoJICBTdGF0aXN0aWNzLnByb3RvdHlwZS5yZWdpc3RlcmVkU3RhdHNTdHJpbmcgPSBmdW5jdGlvbihzdWNjZXNzX21lc3NhZ2UpIHsKCSAgICB2YXIgc3RhdHNfc3RyaW5nLCB0eXBlLCB0eXBlX3RyYWNrZXIsIHdyaXR0ZW4sIF9yZWY7CgkgICAgc3RhdHNfc3RyaW5nID0gJyc7CgkgICAgX3JlZiA9IHRoaXMucmVnaXN0ZXJlZF90cmFja2VyOwoJICAgIGZvciAodHlwZSBpbiBfcmVmKSB7CgkgICAgICB0eXBlX3RyYWNrZXIgPSBfcmVmW3R5cGVdOwoJICAgICAgaWYgKCF0eXBlX3RyYWNrZXIubGVuZ3RoKSB7CgkgICAgICAgIGNvbnRpbnVlOwoJICAgICAgfQoJICAgICAgaWYgKHdyaXR0ZW4pIHsKCSAgICAgICAgc3RhdHNfc3RyaW5nICs9ICdcbiAnOwoJICAgICAgfQoJICAgICAgc3RhdHNfc3RyaW5nICs9ICIiICsgKHR5cGUgPyB0eXBlIDogJ05vIE5hbWUnKSArICI6ICIgKyB0eXBlX3RyYWNrZXIubGVuZ3RoOwoJICAgICAgd3JpdHRlbiA9IHRydWU7CgkgICAgfQoJICAgIGlmIChzdGF0c19zdHJpbmcpIHsKCSAgICAgIHJldHVybiBzdGF0c19zdHJpbmc7CgkgICAgfSBlbHNlIHsKCSAgICAgIHJldHVybiBzdWNjZXNzX21lc3NhZ2U7CgkgICAgfQoJICB9OwoKCSAgU3RhdGlzdGljcy5wcm90b3R5cGUucmVnaXN0ZXJlZFRyYWNrZXIgPSBmdW5jdGlvbihrZXkpIHsKCSAgICB2YXIgdHlwZV90cmFja2VyOwoJICAgIGlmICh0aGlzLnJlZ2lzdGVyZWRfdHJhY2tlci5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CgkgICAgICByZXR1cm4gdGhpcy5yZWdpc3RlcmVkX3RyYWNrZXJba2V5XTsKCSAgICB9CgkgICAgdHlwZV90cmFja2VyID0gW107CgkgICAgdGhpcy5yZWdpc3RlcmVkX3RyYWNrZXJba2V5XSA9IHR5cGVfdHJhY2tlcjsKCSAgICByZXR1cm4gdHlwZV90cmFja2VyOwoJICB9OwoKCSAgU3RhdGlzdGljcy5ldmVudHNTdGF0cyA9IGZ1bmN0aW9uKG9iaiwga2V5KSB7CgkgICAgdmFyIGV2ZW50cywgbm9kZSwgc3RhdHMsIHRhaWwsIF9pLCBfbGVuLCBfcmVmOwoJICAgIHN0YXRzID0gewoJICAgICAgY291bnQ6IDAKCSAgICB9OwoJICAgIGV2ZW50cyA9IG9iai5fZXZlbnRzIHx8IG9iai5fY2FsbGJhY2tzIHx8IHt9OwoJICAgIF9yZWYgPSAoa2V5ID8gW2tleV0gOiBfLmtleXMoZXZlbnRzKSk7CgkgICAgZm9yIChfaSA9IDAsIF9sZW4gPSBfcmVmLmxlbmd0aDsgX2kgPCBfbGVuOyBfaSsrKSB7CgkgICAgICBrZXkgPSBfcmVmW19pXTsKCSAgICAgIGlmICghKG5vZGUgPSBldmVudHNba2V5XSkpIHsKCSAgICAgICAgY29udGludWU7CgkgICAgICB9CgkgICAgICBpZiAoXy5pc0FycmF5KG5vZGUpKSB7CgkgICAgICAgIHN0YXRzW2tleV0gPSBfLmNvbXBhY3Qobm9kZSkubGVuZ3RoOwoJICAgICAgfSBlbHNlIHsKCSAgICAgICAgc3RhdHNba2V5XSA9IDA7CgkgICAgICAgIHRhaWwgPSBub2RlLnRhaWw7CgkgICAgICAgIHdoaWxlICgobm9kZSA9IG5vZGUubmV4dCkgIT09IHRhaWwpIHsKCSAgICAgICAgICBzdGF0c1trZXldKys7CgkgICAgICAgIH0KCSAgICAgIH0KCSAgICAgIHN0YXRzLmNvdW50ICs9IHN0YXRzW2tleV07CgkgICAgfQoJICAgIHJldHVybiBzdGF0czsKCSAgfTsKCgkgIHJldHVybiBTdGF0aXN0aWNzOwoKCX0pKCk7CgoKLyoqKi8gfSwKLyogMTAgKi8KLyoqKi8gZnVuY3Rpb24obW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CgoJCgkvKgoJICBrbm9ja2JhY2suanMgMC4yMC40CgkgIENvcHlyaWdodCAoYykgIDIwMTEtMjAxNCBLZXZpbiBNYWxha29mZi4KCSAgTGljZW5zZTogTUlUIChodHRwOi8vd3d3Lm9wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL21pdC1saWNlbnNlLnBocCkKCSAgU291cmNlOiBodHRwczovL2dpdGh1Yi5jb20va21hbGFrb2ZmL2tub2NrYmFjawoJICBEZXBlbmRlbmNpZXM6IEtub2Nrb3V0LmpzLCBCYWNrYm9uZS5qcywgYW5kIFVuZGVyc2NvcmUuanMgKG9yIExvRGFzaC5qcykuCgkgIE9wdGlvbmFsIGRlcGVuZGVuY2llczogQmFja2JvbmUuTW9kZWxSZWYuanMgYW5kIEJhY2tib25lT1JNLgoJICovCgl2YXIga2IsIGtvLCBfLCBfcmVmOwoKCV9yZWYgPSBrYiA9IF9fd2VicGFja19yZXF1aXJlX18oNiksIF8gPSBfcmVmLl8sIGtvID0gX3JlZi5rbzsKCgltb2R1bGUuZXhwb3J0cyA9IGtiLlN0b3JlID0gKGZ1bmN0aW9uKCkgewoJICBTdG9yZS5pbnN0YW5jZXMgPSBbXTsKCgkgIFN0b3JlLnVzZU9wdGlvbnNPckNyZWF0ZSA9IGZ1bmN0aW9uKG9wdGlvbnMsIG9iaiwgb2JzZXJ2YWJsZSkgewoJICAgIHZhciBzdG9yZTsKCSAgICBpZiAoIW9wdGlvbnMuc3RvcmUpIHsKCSAgICAgIGtiLnV0aWxzLndyYXBwZWRTdG9yZUlzT3duZWQob2JzZXJ2YWJsZSwgdHJ1ZSk7CgkgICAgfQoJICAgIHN0b3JlID0ga2IudXRpbHMud3JhcHBlZFN0b3JlKG9ic2VydmFibGUsIG9wdGlvbnMuc3RvcmUgfHwgbmV3IGtiLlN0b3JlKCkpOwoJICAgIHN0b3JlLnJldGFpbihvYnNlcnZhYmxlLCBvYmosIG9wdGlvbnMuY3JlYXRvcik7CgkgICAgcmV0dXJuIHN0b3JlOwoJICB9OwoKCSAgZnVuY3Rpb24gU3RvcmUoKSB7CgkgICAgdGhpcy5vYnNlcnZhYmxlX3JlY29yZHMgPSB7fTsKCSAgICB0aGlzLnJlcGxhY2VkX29ic2VydmFibGVzID0gW107CgkgICAga2IuU3RvcmUuaW5zdGFuY2VzLnB1c2godGhpcyk7CgkgIH0KCgkgIFN0b3JlLnByb3RvdHlwZS5kZXN0cm95ID0gZnVuY3Rpb24oKSB7CgkgICAgdmFyIGluZGV4OwoJICAgIHRoaXMuX19rYl9yZWxlYXNlZCA9IHRydWU7CgkgICAgdGhpcy5jbGVhcigpOwoJICAgIGlmICgoaW5kZXggPSBfLmluZGV4T2Yoa2IuU3RvcmUuaW5zdGFuY2VzLCB0aGlzKSkgPj0gMCkgewoJICAgICAgcmV0dXJuIGtiLlN0b3JlLmluc3RhbmNlcy5zcGxpY2UoaW5kZXgsIDEpOwoJICAgIH0KCSAgfTsKCgkgIFN0b3JlLnByb3RvdHlwZS5jbGVhciA9IGZ1bmN0aW9uKCkgewoJICAgIHZhciBjaWQsIGNyZWF0b3JfaWQsIG9ic2VydmFibGUsIG9ic2VydmFibGVfcmVjb3JkcywgcmVjb3JkcywgcmVwbGFjZWRfb2JzZXJ2YWJsZXMsIF9pLCBfbGVuLCBfcmVmMSwgX3JlZjI7CgkgICAgX3JlZjEgPSBbdGhpcy5vYnNlcnZhYmxlX3JlY29yZHMsIHt9XSwgb2JzZXJ2YWJsZV9yZWNvcmRzID0gX3JlZjFbMF0sIHRoaXMub2JzZXJ2YWJsZV9yZWNvcmRzID0gX3JlZjFbMV07CgkgICAgZm9yIChjcmVhdG9yX2lkIGluIG9ic2VydmFibGVfcmVjb3JkcykgewoJICAgICAgcmVjb3JkcyA9IG9ic2VydmFibGVfcmVjb3Jkc1tjcmVhdG9yX2lkXTsKCSAgICAgIGZvciAoY2lkIGluIHJlY29yZHMpIHsKCSAgICAgICAgb2JzZXJ2YWJsZSA9IHJlY29yZHNbY2lkXTsKCSAgICAgICAgdGhpcy5yZWxlYXNlKG9ic2VydmFibGUsIHRydWUpOwoJICAgICAgfQoJICAgIH0KCSAgICBfcmVmMiA9IFt0aGlzLnJlcGxhY2VkX29ic2VydmFibGVzLCBbXV0sIHJlcGxhY2VkX29ic2VydmFibGVzID0gX3JlZjJbMF0sIHRoaXMucmVwbGFjZWRfb2JzZXJ2YWJsZXMgPSBfcmVmMlsxXTsKCSAgICBmb3IgKF9pID0gMCwgX2xlbiA9IHJlcGxhY2VkX29ic2VydmFibGVzLmxlbmd0aDsgX2kgPCBfbGVuOyBfaSsrKSB7CgkgICAgICBvYnNlcnZhYmxlID0gcmVwbGFjZWRfb2JzZXJ2YWJsZXNbX2ldOwoJICAgICAgaWYgKCFvYnNlcnZhYmxlLl9fa2JfcmVsZWFzZWQpIHsKCSAgICAgICAgdGhpcy5yZWxlYXNlKG9ic2VydmFibGUsIHRydWUpOwoJICAgICAgfQoJICAgIH0KCSAgfTsKCgkgIFN0b3JlLnByb3RvdHlwZS5jb21wYWN0ID0gZnVuY3Rpb24oKSB7CgkgICAgdmFyIGNpZCwgY3JlYXRvcl9pZCwgb2JzZXJ2YWJsZSwgcmVjb3JkcywgX3JlZjE7CgkgICAgX3JlZjEgPSB0aGlzLm9ic2VydmFibGVfcmVjb3JkczsKCSAgICBmb3IgKGNyZWF0b3JfaWQgaW4gX3JlZjEpIHsKCSAgICAgIHJlY29yZHMgPSBfcmVmMVtjcmVhdG9yX2lkXTsKCSAgICAgIGZvciAoY2lkIGluIHJlY29yZHMpIHsKCSAgICAgICAgb2JzZXJ2YWJsZSA9IHJlY29yZHNbY2lkXTsKCSAgICAgICAgaWYgKG9ic2VydmFibGUuX19rYl9yZWxlYXNlZCkgewoJICAgICAgICAgIGRlbGV0ZSByZWNvcmRzW2NpZF07CgkgICAgICAgIH0KCSAgICAgIH0KCSAgICB9CgkgIH07CgoJICBTdG9yZS5wcm90b3R5cGUucmV0YWluID0gZnVuY3Rpb24ob2JzZXJ2YWJsZSwgb2JqLCBjcmVhdG9yKSB7CgkgICAgdmFyIGN1cnJlbnRfb2JzZXJ2YWJsZTsKCSAgICBpZiAoIXRoaXMuX2NhblJlZ2lzdGVyKG9ic2VydmFibGUpKSB7CgkgICAgICByZXR1cm47CgkgICAgfQoJICAgIGNyZWF0b3IgfHwgKGNyZWF0b3IgPSBvYnNlcnZhYmxlLmNvbnN0cnVjdG9yKTsKCSAgICBpZiAoY3VycmVudF9vYnNlcnZhYmxlID0gdGhpcy5maW5kKG9iaiwgY3JlYXRvcikpIHsKCSAgICAgIGlmIChjdXJyZW50X29ic2VydmFibGUgPT09IG9ic2VydmFibGUpIHsKCSAgICAgICAgdGhpcy5fZ2V0T3JDcmVhdGVTdG9yZVJlZmVyZW5jZXMob2JzZXJ2YWJsZSkucmVmX2NvdW50Kys7CgkgICAgICAgIHJldHVybiBvYnNlcnZhYmxlOwoJICAgICAgfQoJICAgICAgdGhpcy5fcmV0aXJlKGN1cnJlbnRfb2JzZXJ2YWJsZSk7CgkgICAgfQoJICAgIHRoaXMuX2FkZChvYnNlcnZhYmxlLCBvYmosIGNyZWF0b3IpOwoJICAgIHRoaXMuX2dldE9yQ3JlYXRlU3RvcmVSZWZlcmVuY2VzKG9ic2VydmFibGUpLnJlZl9jb3VudCsrOwoJICAgIHJldHVybiBvYnNlcnZhYmxlOwoJICB9OwoKCSAgU3RvcmUucHJvdG90eXBlLnJldGFpbk9yQ3JlYXRlID0gZnVuY3Rpb24ob2JqLCBvcHRpb25zKSB7CgkgICAgdmFyIGNyZWF0b3IsIG9ic2VydmFibGU7CgkgICAgaWYgKCEoY3JlYXRvciA9IHRoaXMuX2NyZWF0b3Iob2JqLCBvcHRpb25zKSkpIHsKCSAgICAgIHJldHVybiBrYi51dGlscy5jcmVhdGVGcm9tRGVmYXVsdENyZWF0b3Iob2JqLCBvcHRpb25zKTsKCSAgICB9CgkgICAgaWYgKGNyZWF0b3IubW9kZWxzX29ubHkpIHsKCSAgICAgIHJldHVybiBvYmo7CgkgICAgfQoJICAgIGlmIChvYnNlcnZhYmxlID0gdGhpcy5maW5kKG9iaiwgY3JlYXRvcikpIHsKCSAgICAgIHJldHVybiBvYnNlcnZhYmxlOwoJICAgIH0KCSAgICBpZiAoIV8uaXNGdW5jdGlvbihjcmVhdG9yLmNyZWF0ZSB8fCBjcmVhdG9yKSkgewoJICAgICAgdGhyb3cgbmV3IEVycm9yKCJJbnZhbGlkIGZhY3RvcnkgZm9yIFwiIiArIG9wdGlvbnMucGF0aCArICJcIiIpOwoJICAgIH0KCSAgICBvYnNlcnZhYmxlID0ga2IuaWdub3JlKChmdW5jdGlvbihfdGhpcykgewoJICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewoJICAgICAgICBvcHRpb25zID0gXy5kZWZhdWx0cyh7CgkgICAgICAgICAgc3RvcmU6IF90aGlzLAoJICAgICAgICAgIGNyZWF0b3I6IGNyZWF0b3IKCSAgICAgICAgfSwgb3B0aW9ucyk7CgkgICAgICAgIG9ic2VydmFibGUgPSBjcmVhdG9yLmNyZWF0ZSA/IGNyZWF0b3IuY3JlYXRlKG9iaiwgb3B0aW9ucykgOiBuZXcgY3JlYXRvcihvYmosIG9wdGlvbnMpOwoJICAgICAgICByZXR1cm4gb2JzZXJ2YWJsZSB8fCBrby5vYnNlcnZhYmxlKG51bGwpOwoJICAgICAgfTsKCSAgICB9KSh0aGlzKSk7CgkgICAgdGhpcy5yZXRhaW4ob2JzZXJ2YWJsZSwgb2JqLCBjcmVhdG9yKTsKCSAgICByZXR1cm4gb2JzZXJ2YWJsZTsKCSAgfTsKCgkgIFN0b3JlLnByb3RvdHlwZS5yZXVzZSA9IGZ1bmN0aW9uKG9ic2VydmFibGUsIG9iaikgewoJICAgIHZhciBjcmVhdG9yLCBjdXJyZW50X29iaiwgY3VycmVudF9vYnNlcnZhYmxlOwoJICAgIGlmICgoY3VycmVudF9vYmogPSBrYi51dGlscy53cmFwcGVkT2JqZWN0KG9ic2VydmFibGUpKSA9PT0gb2JqKSB7CgkgICAgICByZXR1cm47CgkgICAgfQoJICAgIGlmICghdGhpcy5fY2FuUmVnaXN0ZXIob2JzZXJ2YWJsZSkpIHsKCSAgICAgIHRocm93IG5ldyBFcnJvcignQ2Fubm90IHJldXNlIGEgc2ltcGxlIG9ic2VydmFibGUnKTsKCSAgICB9CgkgICAgaWYgKHRoaXMuX3JlZkNvdW50KG9ic2VydmFibGUpICE9PSAxKSB7CgkgICAgICB0aHJvdyBuZXcgRXJyb3IoIlRyeWluZyB0byBjaGFuZ2UgYSBzaGFyZWQgdmlldyBtb2RlbC4gUmVmIGNvdW50OiAiICsgKHRoaXMuX3JlZkNvdW50KG9ic2VydmFibGUpKSk7CgkgICAgfQoJICAgIGNyZWF0b3IgPSBrYi51dGlscy53cmFwcGVkQ3JlYXRvcihvYnNlcnZhYmxlKSB8fCBvYnNlcnZhYmxlLmNvbnN0cnVjdG9yOwoJICAgIGlmICghXy5pc1VuZGVmaW5lZChjdXJyZW50X29iaikpIHsKCSAgICAgIGN1cnJlbnRfb2JzZXJ2YWJsZSA9IHRoaXMuZmluZChjdXJyZW50X29iaiwgY3JlYXRvcik7CgkgICAgfQoJICAgIHRoaXMucmV0YWluKG9ic2VydmFibGUsIG9iaiwgY3JlYXRvcik7CgkgICAgaWYgKGN1cnJlbnRfb2JzZXJ2YWJsZSkgewoJICAgICAgdGhpcy5yZWxlYXNlKGN1cnJlbnRfb2JzZXJ2YWJsZSk7CgkgICAgfQoJICB9OwoKCSAgU3RvcmUucHJvdG90eXBlLnJlbGVhc2UgPSBmdW5jdGlvbihvYnNlcnZhYmxlLCBmb3JjZSkgewoJICAgIHZhciBzdG9yZV9yZWZlcmVuY2VzOwoJICAgIGlmICghdGhpcy5fY2FuUmVnaXN0ZXIob2JzZXJ2YWJsZSkpIHsKCSAgICAgIHJldHVybiBrYi5yZWxlYXNlKG9ic2VydmFibGUpOwoJICAgIH0KCSAgICBpZiAoc3RvcmVfcmVmZXJlbmNlcyA9IHRoaXMuX3N0b3JlUmVmZXJlbmNlcyhvYnNlcnZhYmxlKSkgewoJICAgICAgaWYgKCFmb3JjZSAmJiAtLXN0b3JlX3JlZmVyZW5jZXMucmVmX2NvdW50ID4gMCkgewoJICAgICAgICByZXR1cm47CgkgICAgICB9CgkgICAgICB0aGlzLl9jbGVhclN0b3JlUmVmZXJlbmNlcyhvYnNlcnZhYmxlKTsKCSAgICB9CgkgICAgdGhpcy5fcmVtb3ZlKG9ic2VydmFibGUpOwoJICAgIGlmIChvYnNlcnZhYmxlLl9fa2JfcmVsZWFzZWQpIHsKCSAgICAgIHJldHVybjsKCSAgICB9CgkgICAgaWYgKGZvcmNlIHx8IHRoaXMuX3JlZkNvdW50KG9ic2VydmFibGUpIDw9IDEpIHsKCSAgICAgIHJldHVybiBrYi5yZWxlYXNlKG9ic2VydmFibGUpOwoJICAgIH0KCSAgfTsKCgkgIFN0b3JlLnByb3RvdHlwZS5maW5kID0gZnVuY3Rpb24ob2JqLCBjcmVhdG9yKSB7CgkgICAgdmFyIG9ic2VydmFibGUsIHJlY29yZHMsIF9yZWYxOwoJICAgIGlmICghKHJlY29yZHMgPSB0aGlzLm9ic2VydmFibGVfcmVjb3Jkc1t0aGlzLl9jcmVhdG9ySWQoY3JlYXRvcildKSkgewoJICAgICAgcmV0dXJuIG51bGw7CgkgICAgfQoJICAgIGlmICgoX3JlZjEgPSAob2JzZXJ2YWJsZSA9IHJlY29yZHNbdGhpcy5fY2lkKG9iaildKSkgIT0gbnVsbCA/IF9yZWYxLl9fa2JfcmVsZWFzZWQgOiB2b2lkIDApIHsKCSAgICAgIGRlbGV0ZSByZWNvcmRzW3RoaXMuX2NpZChvYmopXTsKCSAgICAgIHJldHVybiBudWxsOwoJICAgIH0KCSAgICByZXR1cm4gb2JzZXJ2YWJsZTsKCSAgfTsKCgkgIFN0b3JlLnByb3RvdHlwZS5fcmVmQ291bnQgPSBmdW5jdGlvbihvYnNlcnZhYmxlKSB7CgkgICAgdmFyIHN0b3Jlc19yZWZlcmVuY2VzOwoJICAgIGlmIChvYnNlcnZhYmxlLl9fa2JfcmVsZWFzZWQpIHsKCSAgICAgIGlmICh0eXBlb2YgY29uc29sZSAhPT0gInVuZGVmaW5lZCIgJiYgY29uc29sZSAhPT0gbnVsbCkgewoJICAgICAgICBjb25zb2xlLmxvZygnT2JzZXJ2YWJsZSBhbHJlYWR5IHJlbGVhc2VkJyk7CgkgICAgICB9CgkgICAgICByZXR1cm4gMDsKCSAgICB9CgkgICAgaWYgKCEoc3RvcmVzX3JlZmVyZW5jZXMgPSBrYi51dGlscy5nZXQob2JzZXJ2YWJsZSwgJ3N0b3Jlc19yZWZlcmVuY2VzJykpKSB7CgkgICAgICByZXR1cm4gMTsKCSAgICB9CgkgICAgcmV0dXJuIF8ucmVkdWNlKHN0b3Jlc19yZWZlcmVuY2VzLCAoZnVuY3Rpb24obWVtbywgc3RvcmVfcmVmZXJlbmNlcykgewoJICAgICAgcmV0dXJuIG1lbW8gKyBzdG9yZV9yZWZlcmVuY2VzLnJlZl9jb3VudDsKCSAgICB9KSwgMCk7CgkgIH07CgoJICBTdG9yZS5wcm90b3R5cGUuX2NhblJlZ2lzdGVyID0gZnVuY3Rpb24ob2JzZXJ2YWJsZSkgewoJICAgIHJldHVybiBvYnNlcnZhYmxlICYmICFrby5pc09ic2VydmFibGUob2JzZXJ2YWJsZSkgJiYgIW9ic2VydmFibGUuX19rYl9pc19jbzsKCSAgfTsKCgkgIFN0b3JlLnByb3RvdHlwZS5fY2lkID0gZnVuY3Rpb24ob2JqKSB7CgkgICAgdmFyIGNpZDsKCSAgICByZXR1cm4gY2lkID0gb2JqID8gb2JqLmNpZCB8fCAob2JqLmNpZCA9IF8udW5pcXVlSWQoJ2MnKSkgOiAnbnVsbCc7CgkgIH07CgoJICBTdG9yZS5wcm90b3R5cGUuX2NyZWF0b3JJZCA9IGZ1bmN0aW9uKGNyZWF0b3IpIHsKCSAgICB2YXIgY3JlYXRlLCBpdGVtLCBfaSwgX2xlbiwgX3JlZjE7CgkgICAgY3JlYXRlID0gY3JlYXRvci5jcmVhdGUgfHwgY3JlYXRvcjsKCSAgICBjcmVhdGUuX19rYl9jaWRzIHx8IChjcmVhdGUuX19rYl9jaWRzID0gW10pOwoJICAgIF9yZWYxID0gY3JlYXRlLl9fa2JfY2lkczsKCSAgICBmb3IgKF9pID0gMCwgX2xlbiA9IF9yZWYxLmxlbmd0aDsgX2kgPCBfbGVuOyBfaSsrKSB7CgkgICAgICBpdGVtID0gX3JlZjFbX2ldOwoJICAgICAgaWYgKGl0ZW0uY3JlYXRlID09PSBjcmVhdGUpIHsKCSAgICAgICAgcmV0dXJuIGl0ZW0uY2lkOwoJICAgICAgfQoJICAgIH0KCSAgICBjcmVhdGUuX19rYl9jaWRzLnB1c2goaXRlbSA9IHsKCSAgICAgIGNyZWF0ZTogY3JlYXRlLAoJICAgICAgY2lkOiBfLnVuaXF1ZUlkKCdrYicpCgkgICAgfSk7CgkgICAgcmV0dXJuIGl0ZW0uY2lkOwoJICB9OwoKCSAgU3RvcmUucHJvdG90eXBlLl9zdG9yZVJlZmVyZW5jZXMgPSBmdW5jdGlvbihvYnNlcnZhYmxlKSB7CgkgICAgdmFyIHN0b3Jlc19yZWZlcmVuY2VzOwoJICAgIGlmICghKHN0b3Jlc19yZWZlcmVuY2VzID0ga2IudXRpbHMuZ2V0KG9ic2VydmFibGUsICdzdG9yZXNfcmVmZXJlbmNlcycpKSkgewoJICAgICAgcmV0dXJuOwoJICAgIH0KCSAgICByZXR1cm4gXy5maW5kKHN0b3Jlc19yZWZlcmVuY2VzLCAoZnVuY3Rpb24oX3RoaXMpIHsKCSAgICAgIHJldHVybiBmdW5jdGlvbihzdG9yZV9yZWZlcmVuY2VzKSB7CgkgICAgICAgIHJldHVybiBzdG9yZV9yZWZlcmVuY2VzLnN0b3JlID09PSBfdGhpczsKCSAgICAgIH07CgkgICAgfSkodGhpcykpOwoJICB9OwoKCSAgU3RvcmUucHJvdG90eXBlLl9nZXRPckNyZWF0ZVN0b3JlUmVmZXJlbmNlcyA9IGZ1bmN0aW9uKG9ic2VydmFibGUpIHsKCSAgICB2YXIgc3RvcmVfcmVmZXJlbmNlcywgc3RvcmVzX3JlZmVyZW5jZXM7CgkgICAgc3RvcmVzX3JlZmVyZW5jZXMgPSBrYi51dGlscy5vclNldChvYnNlcnZhYmxlLCAnc3RvcmVzX3JlZmVyZW5jZXMnLCBbXSk7CgkgICAgaWYgKCEoc3RvcmVfcmVmZXJlbmNlcyA9IF8uZmluZChzdG9yZXNfcmVmZXJlbmNlcywgKGZ1bmN0aW9uKF90aGlzKSB7CgkgICAgICByZXR1cm4gZnVuY3Rpb24oc3RvcmVfcmVmZXJlbmNlcykgewoJICAgICAgICByZXR1cm4gc3RvcmVfcmVmZXJlbmNlcy5zdG9yZSA9PT0gX3RoaXM7CgkgICAgICB9OwoJICAgIH0pKHRoaXMpKSkpIHsKCSAgICAgIHN0b3Jlc19yZWZlcmVuY2VzLnB1c2goc3RvcmVfcmVmZXJlbmNlcyA9IHsKCSAgICAgICAgc3RvcmU6IHRoaXMsCgkgICAgICAgIHJlZl9jb3VudDogMCwKCSAgICAgICAgcmVsZWFzZTogKGZ1bmN0aW9uKF90aGlzKSB7CgkgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewoJICAgICAgICAgICAgcmV0dXJuIF90aGlzLnJlbGVhc2Uob2JzZXJ2YWJsZSk7CgkgICAgICAgICAgfTsKCSAgICAgICAgfSkodGhpcykKCSAgICAgIH0pOwoJICAgIH0KCSAgICByZXR1cm4gc3RvcmVfcmVmZXJlbmNlczsKCSAgfTsKCgkgIFN0b3JlLnByb3RvdHlwZS5fY2xlYXJTdG9yZVJlZmVyZW5jZXMgPSBmdW5jdGlvbihvYnNlcnZhYmxlKSB7CgkgICAgdmFyIGluZGV4LCBzdG9yZV9yZWZlcmVuY2VzLCBzdG9yZXNfcmVmZXJlbmNlcywgX3JlZjE7CgkgICAgaWYgKHN0b3Jlc19yZWZlcmVuY2VzID0ga2IudXRpbHMuZ2V0KG9ic2VydmFibGUsICdzdG9yZXNfcmVmZXJlbmNlcycpKSB7CgkgICAgICBfcmVmMSA9IG9ic2VydmFibGUuX19rYi5zdG9yZXNfcmVmZXJlbmNlczsKCSAgICAgIGZvciAoaW5kZXggaW4gX3JlZjEpIHsKCSAgICAgICAgc3RvcmVfcmVmZXJlbmNlcyA9IF9yZWYxW2luZGV4XTsKCSAgICAgICAgaWYgKHN0b3JlX3JlZmVyZW5jZXMuc3RvcmUgPT09IHRoaXMpIHsKCSAgICAgICAgICBvYnNlcnZhYmxlLl9fa2Iuc3RvcmVzX3JlZmVyZW5jZXMuc3BsaWNlKGluZGV4LCAxKTsKCSAgICAgICAgICBicmVhazsKCSAgICAgICAgfQoJICAgICAgfQoJICAgIH0KCSAgfTsKCgkgIFN0b3JlLnByb3RvdHlwZS5fcmV0aXJlID0gZnVuY3Rpb24ob2JzZXJ2YWJsZSkgewoJICAgIHRoaXMuX2NsZWFyU3RvcmVSZWZlcmVuY2VzKG9ic2VydmFibGUpOwoJICAgIHRoaXMucmVwbGFjZWRfb2JzZXJ2YWJsZXMucHVzaChvYnNlcnZhYmxlKTsKCSAgICByZXR1cm4gdGhpcy5fcmVtb3ZlKG9ic2VydmFibGUpOwoJICB9OwoKCSAgU3RvcmUucHJvdG90eXBlLl9hZGQgPSBmdW5jdGlvbihvYnNlcnZhYmxlLCBvYmosIGNyZWF0b3IpIHsKCSAgICB2YXIgX2Jhc2UsIF9uYW1lOwoJICAgIGNyZWF0b3IgfHwgKGNyZWF0b3IgPSBvYnNlcnZhYmxlLmNvbnN0cnVjdG9yKTsKCSAgICBrYi51dGlscy53cmFwcGVkT2JqZWN0KG9ic2VydmFibGUsIG9iaik7CgkgICAga2IudXRpbHMud3JhcHBlZENyZWF0b3Iob2JzZXJ2YWJsZSwgY3JlYXRvcik7CgkgICAgcmV0dXJuICgoX2Jhc2UgPSB0aGlzLm9ic2VydmFibGVfcmVjb3JkcylbX25hbWUgPSB0aGlzLl9jcmVhdG9ySWQoY3JlYXRvcildIHx8IChfYmFzZVtfbmFtZV0gPSB7fSkpW3RoaXMuX2NpZChvYmopXSA9IG9ic2VydmFibGU7CgkgIH07CgoJICBTdG9yZS5wcm90b3R5cGUuX3JlbW92ZSA9IGZ1bmN0aW9uKG9ic2VydmFibGUpIHsKCSAgICB2YXIgY3JlYXRvciwgY3VycmVudF9vYnNlcnZhYmxlLCBvYmo7CgkgICAgY3JlYXRvciA9IGtiLnV0aWxzLndyYXBwZWRDcmVhdG9yKG9ic2VydmFibGUpIHx8IG9ic2VydmFibGUuY29uc3RydWN0b3I7CgkgICAgaWYgKGN1cnJlbnRfb2JzZXJ2YWJsZSA9IHRoaXMuZmluZChvYmogPSBrYi51dGlscy53cmFwcGVkT2JqZWN0KG9ic2VydmFibGUpLCBjcmVhdG9yKSkgewoJICAgICAgaWYgKGN1cnJlbnRfb2JzZXJ2YWJsZSA9PT0gb2JzZXJ2YWJsZSkgewoJICAgICAgICBkZWxldGUgdGhpcy5vYnNlcnZhYmxlX3JlY29yZHNbdGhpcy5fY3JlYXRvcklkKGNyZWF0b3IpXVt0aGlzLl9jaWQob2JqKV07CgkgICAgICB9CgkgICAgfQoJICAgIGtiLnV0aWxzLndyYXBwZWRPYmplY3Qob2JzZXJ2YWJsZSwgbnVsbCk7CgkgICAgcmV0dXJuIGtiLnV0aWxzLndyYXBwZWRDcmVhdG9yKG9ic2VydmFibGUsIG51bGwpOwoJICB9OwoKCSAgU3RvcmUucHJvdG90eXBlLl9jcmVhdG9yID0gZnVuY3Rpb24ob2JqLCBvcHRpb25zKSB7CgkgICAgdmFyIGNyZWF0b3I7CgkgICAgaWYgKG9wdGlvbnMuY3JlYXRvcikgewoJICAgICAgcmV0dXJuIG9wdGlvbnMuY3JlYXRvcjsKCSAgICB9CgkgICAgaWYgKGNyZWF0b3IgPSBrYi51dGlscy5pbmZlckNyZWF0b3Iob2JqLCBvcHRpb25zLmZhY3RvcnksIG9wdGlvbnMucGF0aCkpIHsKCSAgICAgIHJldHVybiBjcmVhdG9yOwoJICAgIH0KCSAgICBpZiAoa2IuaXNNb2RlbChvYmopKSB7CgkgICAgICByZXR1cm4ga2IuVmlld01vZGVsOwoJICAgIH0KCSAgfTsKCgkgIHJldHVybiBTdG9yZTsKCgl9KSgpOwoKCi8qKiovIH0sCi8qIDExICovCi8qKiovIGZ1bmN0aW9uKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewoKCXZhciBUeXBlZFZhbHVlLCBrYiwga28sIF8sIF9yZWY7CgoJX3JlZiA9IGtiID0gX193ZWJwYWNrX3JlcXVpcmVfXyg2KSwgXyA9IF9yZWYuXywga28gPSBfcmVmLmtvOwoKCW1vZHVsZS5leHBvcnRzID0gVHlwZWRWYWx1ZSA9IChmdW5jdGlvbigpIHsKCSAgZnVuY3Rpb24gVHlwZWRWYWx1ZShjcmVhdGVfb3B0aW9ucykgewoJICAgIHRoaXMuY3JlYXRlX29wdGlvbnMgPSBjcmVhdGVfb3B0aW9uczsKCSAgICB0aGlzLl92byA9IGtvLm9ic2VydmFibGUobnVsbCk7CgkgIH0KCgkgIFR5cGVkVmFsdWUucHJvdG90eXBlLmRlc3Ryb3kgPSBmdW5jdGlvbigpIHsKCSAgICB2YXIgcHJldmlvdXNfdmFsdWU7CgkgICAgdGhpcy5fX2tiX3JlbGVhc2VkID0gdHJ1ZTsKCSAgICBpZiAocHJldmlvdXNfdmFsdWUgPSB0aGlzLl9fa2JfdmFsdWUpIHsKCSAgICAgIHRoaXMuX19rYl92YWx1ZSA9IG51bGw7CgkgICAgICBpZiAodGhpcy5jcmVhdGVfb3B0aW9ucy5zdG9yZSAmJiBrYi51dGlscy53cmFwcGVkQ3JlYXRvcihwcmV2aW91c192YWx1ZSkpIHsKCSAgICAgICAgdGhpcy5jcmVhdGVfb3B0aW9ucy5zdG9yZS5yZWxlYXNlKHByZXZpb3VzX3ZhbHVlKTsKCSAgICAgIH0gZWxzZSB7CgkgICAgICAgIGtiLnJlbGVhc2UocHJldmlvdXNfdmFsdWUpOwoJICAgICAgfQoJICAgIH0KCSAgICByZXR1cm4gdGhpcy5jcmVhdGVfb3B0aW9ucyA9IG51bGw7CgkgIH07CgoJICBUeXBlZFZhbHVlLnByb3RvdHlwZS52YWx1ZSA9IGZ1bmN0aW9uKCkgewoJICAgIHJldHVybiBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKHRoaXMuX3ZvKCkpOwoJICB9OwoKCSAgVHlwZWRWYWx1ZS5wcm90b3R5cGUucmF3VmFsdWUgPSBmdW5jdGlvbigpIHsKCSAgICByZXR1cm4gdGhpcy5fX2tiX3ZhbHVlOwoJICB9OwoKCSAgVHlwZWRWYWx1ZS5wcm90b3R5cGUudmFsdWVUeXBlID0gZnVuY3Rpb24obW9kZWwsIGtleSkgewoJICAgIHZhciBuZXdfdmFsdWU7CgkgICAgbmV3X3ZhbHVlID0ga2IuZ2V0VmFsdWUobW9kZWwsIGtleSk7CgkgICAgdGhpcy52YWx1ZV90eXBlIHx8IHRoaXMuX3VwZGF0ZVZhbHVlT2JzZXJ2YWJsZShuZXdfdmFsdWUpOwoJICAgIHJldHVybiB0aGlzLnZhbHVlX3R5cGU7CgkgIH07CgoJICBUeXBlZFZhbHVlLnByb3RvdHlwZS51cGRhdGUgPSBmdW5jdGlvbihuZXdfdmFsdWUpIHsKCSAgICB2YXIgbmV3X3R5cGUsIHZhbHVlLCBfcmVmMTsKCSAgICBpZiAodGhpcy5fX2tiX3JlbGVhc2VkKSB7CgkgICAgICByZXR1cm47CgkgICAgfQoJICAgIChuZXdfdmFsdWUgIT09IHZvaWQgMCkgfHwgKG5ld192YWx1ZSA9IG51bGwpOwoJICAgIG5ld190eXBlID0ga2IudXRpbHMudmFsdWVUeXBlKG5ld192YWx1ZSk7CgkgICAgaWYgKChfcmVmMSA9IHRoaXMuX19rYl92YWx1ZSkgIT0gbnVsbCA/IF9yZWYxLl9fa2JfcmVsZWFzZWQgOiB2b2lkIDApIHsKCSAgICAgIHRoaXMuX19rYl92YWx1ZSA9IHRoaXMudmFsdWVfdHlwZSA9IHZvaWQgMDsKCSAgICB9CgkgICAgdmFsdWUgPSB0aGlzLl9fa2JfdmFsdWU7CgkgICAgc3dpdGNoICh0aGlzLnZhbHVlX3R5cGUpIHsKCSAgICAgIGNhc2Uga2IuVFlQRV9DT0xMRUNUSU9OOgoJICAgICAgICBpZiAodGhpcy52YWx1ZV90eXBlID09PSBrYi5UWVBFX0NPTExFQ1RJT04gJiYgbmV3X3R5cGUgPT09IGtiLlRZUEVfQVJSQVkpIHsKCSAgICAgICAgICByZXR1cm4gdmFsdWUobmV3X3ZhbHVlKTsKCSAgICAgICAgfQoJICAgICAgICBpZiAobmV3X3R5cGUgPT09IGtiLlRZUEVfQ09MTEVDVElPTiB8fCBfLmlzTnVsbChuZXdfdmFsdWUpKSB7CgkgICAgICAgICAgaWYgKG5ld192YWx1ZSAmJiBuZXdfdmFsdWUgaW5zdGFuY2VvZiBrYi5Db2xsZWN0aW9uT2JzZXJ2YWJsZSkgewoJICAgICAgICAgICAgdGhpcy5fdXBkYXRlVmFsdWVPYnNlcnZhYmxlKGtiLnV0aWxzLndyYXBwZWRPYmplY3QobmV3X3ZhbHVlKSwgbmV3X3ZhbHVlKTsKCSAgICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgaWYgKGtiLnBlZWsodmFsdWUuY29sbGVjdGlvbikgIT09IG5ld192YWx1ZSkgewoJICAgICAgICAgICAgICB2YWx1ZS5jb2xsZWN0aW9uKG5ld192YWx1ZSk7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgfQoJICAgICAgICAgIHJldHVybjsKCSAgICAgICAgfQoJICAgICAgICBicmVhazsKCSAgICAgIGNhc2Uga2IuVFlQRV9NT0RFTDoKCSAgICAgICAgaWYgKG5ld190eXBlID09PSBrYi5UWVBFX01PREVMIHx8IF8uaXNOdWxsKG5ld192YWx1ZSkpIHsKCSAgICAgICAgICBpZiAobmV3X3ZhbHVlICYmICFrYi5pc01vZGVsKG5ld192YWx1ZSkpIHsKCSAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVZhbHVlT2JzZXJ2YWJsZShrYi51dGlscy53cmFwcGVkT2JqZWN0KG5ld192YWx1ZSksIG5ld192YWx1ZSk7CgkgICAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgIGlmIChrYi51dGlscy53cmFwcGVkT2JqZWN0KHZhbHVlKSAhPT0ga2IudXRpbHMucmVzb2x2ZU1vZGVsKG5ld192YWx1ZSkpIHsKCSAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlVmFsdWVPYnNlcnZhYmxlKG5ld192YWx1ZSk7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgfQoJICAgICAgICAgIHJldHVybjsKCSAgICAgICAgfQoJICAgIH0KCSAgICBpZiAodGhpcy52YWx1ZV90eXBlID09PSBuZXdfdHlwZSAmJiAhXy5pc1VuZGVmaW5lZCh0aGlzLnZhbHVlX3R5cGUpKSB7CgkgICAgICBpZiAoa2IucGVlayh2YWx1ZSkgIT09IG5ld192YWx1ZSkgewoJICAgICAgICByZXR1cm4gdmFsdWUobmV3X3ZhbHVlKTsKCSAgICAgIH0KCSAgICB9IGVsc2UgewoJICAgICAgaWYgKGtiLnBlZWsodmFsdWUpICE9PSBuZXdfdmFsdWUpIHsKCSAgICAgICAgcmV0dXJuIHRoaXMuX3VwZGF0ZVZhbHVlT2JzZXJ2YWJsZShuZXdfdmFsdWUpOwoJICAgICAgfQoJICAgIH0KCSAgfTsKCgkgIFR5cGVkVmFsdWUucHJvdG90eXBlLl91cGRhdGVWYWx1ZU9ic2VydmFibGUgPSBmdW5jdGlvbihuZXdfdmFsdWUsIG5ld19vYnNlcnZhYmxlKSB7CgkgICAgdmFyIGNyZWF0ZV9vcHRpb25zLCBjcmVhdG9yLCBwcmV2aW91c192YWx1ZSwgdmFsdWUsIHZhbHVlX3R5cGUsIF9yZWYxOwoJICAgIGNyZWF0ZV9vcHRpb25zID0gdGhpcy5jcmVhdGVfb3B0aW9uczsKCSAgICBjcmVhdG9yID0ga2IudXRpbHMuaW5mZXJDcmVhdG9yKG5ld192YWx1ZSwgY3JlYXRlX29wdGlvbnMuZmFjdG9yeSwgY3JlYXRlX29wdGlvbnMucGF0aCk7CgkgICAgaWYgKChuZXdfdmFsdWUgPT09IG51bGwpICYmICFjcmVhdG9yKSB7CgkgICAgICBpZiAodGhpcy52YWx1ZV90eXBlID09PSBrYi5UWVBFX01PREVMKSB7CgkgICAgICAgIGNyZWF0b3IgPSBrYi5WaWV3TW9kZWw7CgkgICAgICB9IGVsc2UgaWYgKHRoaXMudmFsdWVfdHlwZSA9PT0ga2IuVFlQRV9DT0xMRUNUSU9OKSB7CgkgICAgICAgIGNyZWF0b3IgPSBrYi5Db2xsZWN0aW9uT2JzZXJ2YWJsZTsKCSAgICAgIH0KCSAgICB9CgkgICAgY3JlYXRlX29wdGlvbnMuY3JlYXRvciA9IGNyZWF0b3I7CgkgICAgdmFsdWVfdHlwZSA9IGtiLlRZUEVfVU5LTk9XTjsKCSAgICBfcmVmMSA9IFt0aGlzLl9fa2JfdmFsdWUsIHZvaWQgMF0sIHByZXZpb3VzX3ZhbHVlID0gX3JlZjFbMF0sIHRoaXMuX19rYl92YWx1ZSA9IF9yZWYxWzFdOwoJICAgIGlmIChuZXdfb2JzZXJ2YWJsZSkgewoJICAgICAgdmFsdWUgPSBuZXdfb2JzZXJ2YWJsZTsKCSAgICAgIGlmIChjcmVhdGVfb3B0aW9ucy5zdG9yZSkgewoJICAgICAgICBjcmVhdGVfb3B0aW9ucy5zdG9yZS5yZXRhaW4obmV3X29ic2VydmFibGUsIG5ld192YWx1ZSwgY3JlYXRvcik7CgkgICAgICB9CgkgICAgfSBlbHNlIGlmIChjcmVhdG9yKSB7CgkgICAgICBpZiAoY3JlYXRlX29wdGlvbnMuc3RvcmUpIHsKCSAgICAgICAgdmFsdWUgPSBjcmVhdGVfb3B0aW9ucy5zdG9yZS5yZXRhaW5PckNyZWF0ZShuZXdfdmFsdWUsIGNyZWF0ZV9vcHRpb25zKTsKCSAgICAgIH0gZWxzZSB7CgkgICAgICAgIGlmIChjcmVhdG9yLm1vZGVsc19vbmx5KSB7CgkgICAgICAgICAgdmFsdWUgPSBuZXdfdmFsdWU7CgkgICAgICAgICAgdmFsdWVfdHlwZSA9IGtiLlRZUEVfU0lNUExFOwoJICAgICAgICB9IGVsc2UgaWYgKGNyZWF0b3IuY3JlYXRlKSB7CgkgICAgICAgICAgdmFsdWUgPSBjcmVhdG9yLmNyZWF0ZShuZXdfdmFsdWUsIGNyZWF0ZV9vcHRpb25zKTsKCSAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICB2YWx1ZSA9IG5ldyBjcmVhdG9yKG5ld192YWx1ZSwgY3JlYXRlX29wdGlvbnMpOwoJICAgICAgICB9CgkgICAgICB9CgkgICAgfSBlbHNlIHsKCSAgICAgIGlmIChfLmlzQXJyYXkobmV3X3ZhbHVlKSkgewoJICAgICAgICB2YWx1ZV90eXBlID0ga2IuVFlQRV9BUlJBWTsKCSAgICAgICAgdmFsdWUgPSBrby5vYnNlcnZhYmxlQXJyYXkobmV3X3ZhbHVlKTsKCSAgICAgIH0gZWxzZSB7CgkgICAgICAgIHZhbHVlX3R5cGUgPSBrYi5UWVBFX1NJTVBMRTsKCSAgICAgICAgdmFsdWUgPSBrby5vYnNlcnZhYmxlKG5ld192YWx1ZSk7CgkgICAgICB9CgkgICAgfQoJICAgIGlmICgodGhpcy52YWx1ZV90eXBlID0gdmFsdWVfdHlwZSkgPT09IGtiLlRZUEVfVU5LTk9XTikgewoJICAgICAgaWYgKCFrby5pc09ic2VydmFibGUodmFsdWUpKSB7CgkgICAgICAgIHRoaXMudmFsdWVfdHlwZSA9IGtiLlRZUEVfTU9ERUw7CgkgICAgICAgIGtiLnV0aWxzLndyYXBwZWRPYmplY3QodmFsdWUsIGtiLnV0aWxzLnJlc29sdmVNb2RlbChuZXdfdmFsdWUpKTsKCSAgICAgIH0gZWxzZSBpZiAodmFsdWUuX19rYl9pc19jbykgewoJICAgICAgICB0aGlzLnZhbHVlX3R5cGUgPSBrYi5UWVBFX0NPTExFQ1RJT047CgkgICAgICAgIGtiLnV0aWxzLndyYXBwZWRPYmplY3QodmFsdWUsIG5ld192YWx1ZSk7CgkgICAgICB9IGVsc2UgaWYgKCF0aGlzLnZhbHVlX3R5cGUpIHsKCSAgICAgICAgdGhpcy52YWx1ZV90eXBlID0ga2IuVFlQRV9TSU1QTEU7CgkgICAgICB9CgkgICAgfQoJICAgIGlmIChwcmV2aW91c192YWx1ZSkgewoJICAgICAgaWYgKHRoaXMuY3JlYXRlX29wdGlvbnMuc3RvcmUpIHsKCSAgICAgICAgdGhpcy5jcmVhdGVfb3B0aW9ucy5zdG9yZS5yZWxlYXNlKHByZXZpb3VzX3ZhbHVlKTsKCSAgICAgIH0gZWxzZSB7CgkgICAgICAgIGtiLnJlbGVhc2UocHJldmlvdXNfdmFsdWUpOwoJICAgICAgfQoJICAgIH0KCSAgICB0aGlzLl9fa2JfdmFsdWUgPSB2YWx1ZTsKCSAgICByZXR1cm4gdGhpcy5fdm8odmFsdWUpOwoJICB9OwoKCSAgVHlwZWRWYWx1ZS5wcm90b3R5cGUuX2luZmVyVHlwZSA9IGZ1bmN0aW9uKHZhbHVlKSB7fTsKCgkgIHJldHVybiBUeXBlZFZhbHVlOwoKCX0pKCk7CgoKLyoqKi8gfSwKLyogMTIgKi8KLyoqKi8gZnVuY3Rpb24obW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CgoJCgkvKgoJICBrbm9ja2JhY2suanMgMC4yMC40CgkgIENvcHlyaWdodCAoYykgIDIwMTEtMjAxNCBLZXZpbiBNYWxha29mZi4KCSAgTGljZW5zZTogTUlUIChodHRwOi8vd3d3Lm9wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL21pdC1saWNlbnNlLnBocCkKCSAgU291cmNlOiBodHRwczovL2dpdGh1Yi5jb20va21hbGFrb2ZmL2tub2NrYmFjawoJICBEZXBlbmRlbmNpZXM6IEtub2Nrb3V0LmpzLCBCYWNrYm9uZS5qcywgYW5kIFVuZGVyc2NvcmUuanMgKG9yIExvRGFzaC5qcykuCgkgIE9wdGlvbmFsIGRlcGVuZGVuY2llczogQmFja2JvbmUuTW9kZWxSZWYuanMgYW5kIEJhY2tib25lT1JNLgoJICovCgl2YXIga2IsIGtvLCBfLCBfcmVmOwoKCV9yZWYgPSBrYiA9IF9fd2VicGFja19yZXF1aXJlX18oNiksIF8gPSBfcmVmLl8sIGtvID0gX3JlZi5rbzsKCglrYi51dGlscyA9IChmdW5jdGlvbigpIHsKCSAgZnVuY3Rpb24gdXRpbHMoKSB7fQoKCSAgdXRpbHMuZ2V0ID0gZnVuY3Rpb24ob2JqLCBrZXksIGRlZmF1bHRfdmFsdWUpIHsKCSAgICBpZiAoIW9iai5fX2tiIHx8ICFvYmouX19rYi5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CgkgICAgICByZXR1cm4gZGVmYXVsdF92YWx1ZTsKCSAgICB9IGVsc2UgewoJICAgICAgcmV0dXJuIG9iai5fX2tiW2tleV07CgkgICAgfQoJICB9OwoKCSAgdXRpbHMuc2V0ID0gZnVuY3Rpb24ob2JqLCBrZXksIHZhbHVlKSB7CgkgICAgcmV0dXJuIChvYmouX19rYiB8fCAob2JqLl9fa2IgPSB7fSkpW2tleV0gPSB2YWx1ZTsKCSAgfTsKCgkgIHV0aWxzLm9yU2V0ID0gZnVuY3Rpb24ob2JqLCBrZXksIHZhbHVlKSB7CgkgICAgaWYgKCEob2JqLl9fa2IgfHwgKG9iai5fX2tiID0ge30pKS5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CgkgICAgICBvYmouX19rYltrZXldID0gdmFsdWU7CgkgICAgfQoJICAgIHJldHVybiBvYmouX19rYltrZXldOwoJICB9OwoKCSAgdXRpbHMuaGFzID0gZnVuY3Rpb24ob2JqLCBrZXkpIHsKCSAgICByZXR1cm4gb2JqLl9fa2IgJiYgb2JqLl9fa2IuaGFzT3duUHJvcGVydHkoa2V5KTsKCSAgfTsKCgkgIHV0aWxzLndyYXBwZWRPYnNlcnZhYmxlID0gZnVuY3Rpb24ob2JqLCB2YWx1ZSkgewoJICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAxKSB7CgkgICAgICByZXR1cm4ga2IudXRpbHMuZ2V0KG9iaiwgJ29ic2VydmFibGUnKTsKCSAgICB9IGVsc2UgewoJICAgICAgcmV0dXJuIGtiLnV0aWxzLnNldChvYmosICdvYnNlcnZhYmxlJywgdmFsdWUpOwoJICAgIH0KCSAgfTsKCgkgIHV0aWxzLndyYXBwZWRPYmplY3QgPSBmdW5jdGlvbihvYmosIHZhbHVlKSB7CgkgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDEpIHsKCSAgICAgIHJldHVybiBrYi51dGlscy5nZXQob2JqLCAnb2JqZWN0Jyk7CgkgICAgfSBlbHNlIHsKCSAgICAgIHJldHVybiBrYi51dGlscy5zZXQob2JqLCAnb2JqZWN0JywgdmFsdWUpOwoJICAgIH0KCSAgfTsKCgkgIHV0aWxzLndyYXBwZWRDcmVhdG9yID0gZnVuY3Rpb24ob2JqLCB2YWx1ZSkgewoJICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAxKSB7CgkgICAgICByZXR1cm4ga2IudXRpbHMuZ2V0KG9iaiwgJ2NyZWF0b3InKTsKCSAgICB9IGVsc2UgewoJICAgICAgcmV0dXJuIGtiLnV0aWxzLnNldChvYmosICdjcmVhdG9yJywgdmFsdWUpOwoJICAgIH0KCSAgfTsKCgkgIHV0aWxzLndyYXBwZWRNb2RlbCA9IGZ1bmN0aW9uKG9iaiwgdmFsdWUpIHsKCSAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMSkgewoJICAgICAgaWYgKF8uaXNVbmRlZmluZWQodmFsdWUgPSBrYi51dGlscy5nZXQob2JqLCAnb2JqZWN0JykpKSB7CgkgICAgICAgIHJldHVybiBvYmo7CgkgICAgICB9IGVsc2UgewoJICAgICAgICByZXR1cm4gdmFsdWU7CgkgICAgICB9CgkgICAgfSBlbHNlIHsKCSAgICAgIHJldHVybiBrYi51dGlscy5zZXQob2JqLCAnb2JqZWN0JywgdmFsdWUpOwoJICAgIH0KCSAgfTsKCgkgIHV0aWxzLndyYXBwZWRTdG9yZSA9IGZ1bmN0aW9uKG9iaiwgdmFsdWUpIHsKCSAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMSkgewoJICAgICAgcmV0dXJuIGtiLnV0aWxzLmdldChvYmosICdzdG9yZScpOwoJICAgIH0gZWxzZSB7CgkgICAgICByZXR1cm4ga2IudXRpbHMuc2V0KG9iaiwgJ3N0b3JlJywgdmFsdWUpOwoJICAgIH0KCSAgfTsKCgkgIHV0aWxzLndyYXBwZWRTdG9yZUlzT3duZWQgPSBmdW5jdGlvbihvYmosIHZhbHVlKSB7CgkgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDEpIHsKCSAgICAgIHJldHVybiBrYi51dGlscy5nZXQob2JqLCAnc3RvcmVfaXNfb3duZWQnKTsKCSAgICB9IGVsc2UgewoJICAgICAgcmV0dXJuIGtiLnV0aWxzLnNldChvYmosICdzdG9yZV9pc19vd25lZCcsIHZhbHVlKTsKCSAgICB9CgkgIH07CgoJICB1dGlscy53cmFwcGVkRmFjdG9yeSA9IGZ1bmN0aW9uKG9iaiwgdmFsdWUpIHsKCSAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMSkgewoJICAgICAgcmV0dXJuIGtiLnV0aWxzLmdldChvYmosICdmYWN0b3J5Jyk7CgkgICAgfSBlbHNlIHsKCSAgICAgIHJldHVybiBrYi51dGlscy5zZXQob2JqLCAnZmFjdG9yeScsIHZhbHVlKTsKCSAgICB9CgkgIH07CgoJICB1dGlscy53cmFwcGVkRXZlbnRXYXRjaGVyID0gZnVuY3Rpb24ob2JqLCB2YWx1ZSkgewoJICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAxKSB7CgkgICAgICByZXR1cm4ga2IudXRpbHMuZ2V0KG9iaiwgJ2V2ZW50X3dhdGNoZXInKTsKCSAgICB9IGVsc2UgewoJICAgICAgcmV0dXJuIGtiLnV0aWxzLnNldChvYmosICdldmVudF93YXRjaGVyJywgdmFsdWUpOwoJICAgIH0KCSAgfTsKCgkgIHV0aWxzLndyYXBwZWRFdmVudFdhdGNoZXJJc093bmVkID0gZnVuY3Rpb24ob2JqLCB2YWx1ZSkgewoJICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAxKSB7CgkgICAgICByZXR1cm4ga2IudXRpbHMuZ2V0KG9iaiwgJ2V2ZW50X3dhdGNoZXJfaXNfb3duZWQnKTsKCSAgICB9IGVsc2UgewoJICAgICAgcmV0dXJuIGtiLnV0aWxzLnNldChvYmosICdldmVudF93YXRjaGVyX2lzX293bmVkJywgdmFsdWUpOwoJICAgIH0KCSAgfTsKCgkgIHV0aWxzLndyYXBwZWREZXN0cm95ID0gX193ZWJwYWNrX3JlcXVpcmVfXygyMCk7CgoJICB1dGlscy52YWx1ZVR5cGUgPSBmdW5jdGlvbihvYnNlcnZhYmxlKSB7CgkgICAgaWYgKCFvYnNlcnZhYmxlKSB7CgkgICAgICByZXR1cm4ga2IuVFlQRV9VTktOT1dOOwoJICAgIH0KCSAgICBpZiAob2JzZXJ2YWJsZS5fX2tiX2lzX28pIHsKCSAgICAgIHJldHVybiBvYnNlcnZhYmxlLnZhbHVlVHlwZSgpOwoJICAgIH0KCSAgICBpZiAob2JzZXJ2YWJsZS5fX2tiX2lzX2NvIHx8IChvYnNlcnZhYmxlIGluc3RhbmNlb2Yga2IuQ29sbGVjdGlvbikpIHsKCSAgICAgIHJldHVybiBrYi5UWVBFX0NPTExFQ1RJT047CgkgICAgfQoJICAgIGlmICgob2JzZXJ2YWJsZSBpbnN0YW5jZW9mIGtiLlZpZXdNb2RlbCkgfHwgKG9ic2VydmFibGUgaW5zdGFuY2VvZiBrYi5Nb2RlbCkpIHsKCSAgICAgIHJldHVybiBrYi5UWVBFX01PREVMOwoJICAgIH0KCSAgICBpZiAoXy5pc0FycmF5KG9ic2VydmFibGUpKSB7CgkgICAgICByZXR1cm4ga2IuVFlQRV9BUlJBWTsKCSAgICB9CgkgICAgcmV0dXJuIGtiLlRZUEVfU0lNUExFOwoJICB9OwoKCSAgdXRpbHMucGF0aEpvaW4gPSBmdW5jdGlvbihwYXRoMSwgcGF0aDIpIHsKCSAgICByZXR1cm4gKHBhdGgxID8gKHBhdGgxW3BhdGgxLmxlbmd0aCAtIDFdICE9PSAnLicgPyAiIiArIHBhdGgxICsgIi4iIDogcGF0aDEpIDogJycpICsgcGF0aDI7CgkgIH07CgoJICB1dGlscy5vcHRpb25zUGF0aEpvaW4gPSBmdW5jdGlvbihvcHRpb25zLCBwYXRoKSB7CgkgICAgcmV0dXJuIF8uZGVmYXVsdHMoewoJICAgICAgcGF0aDogdGhpcy5wYXRoSm9pbihvcHRpb25zLnBhdGgsIHBhdGgpCgkgICAgfSwgb3B0aW9ucyk7CgkgIH07CgoJICB1dGlscy5pbmZlckNyZWF0b3IgPSBmdW5jdGlvbih2YWx1ZSwgZmFjdG9yeSwgcGF0aCkgewoJICAgIHZhciBjcmVhdG9yOwoJICAgIGlmIChmYWN0b3J5ICYmIChjcmVhdG9yID0gZmFjdG9yeS5jcmVhdG9yRm9yUGF0aCh2YWx1ZSwgcGF0aCkpKSB7CgkgICAgICByZXR1cm4gY3JlYXRvcjsKCSAgICB9CgkgICAgaWYgKCF2YWx1ZSkgewoJICAgICAgcmV0dXJuIG51bGw7CgkgICAgfQoJICAgIGlmICh2YWx1ZSBpbnN0YW5jZW9mIGtiLk1vZGVsKSB7CgkgICAgICByZXR1cm4ga2IuVmlld01vZGVsOwoJICAgIH0KCSAgICBpZiAodmFsdWUgaW5zdGFuY2VvZiBrYi5Db2xsZWN0aW9uKSB7CgkgICAgICByZXR1cm4ga2IuQ29sbGVjdGlvbk9ic2VydmFibGU7CgkgICAgfQoJICAgIHJldHVybiBudWxsOwoJICB9OwoKCSAgdXRpbHMuY3JlYXRlRnJvbURlZmF1bHRDcmVhdG9yID0gZnVuY3Rpb24ob2JqLCBvcHRpb25zKSB7CgkgICAgaWYgKGtiLmlzTW9kZWwob2JqKSkgewoJICAgICAgcmV0dXJuIGtiLnZpZXdNb2RlbChvYmosIG9wdGlvbnMpOwoJICAgIH0KCSAgICBpZiAoa2IuaXNDb2xsZWN0aW9uKG9iaikpIHsKCSAgICAgIHJldHVybiBrYi5jb2xsZWN0aW9uT2JzZXJ2YWJsZShvYmosIG9wdGlvbnMpOwoJICAgIH0KCSAgICBpZiAoXy5pc0FycmF5KG9iaikpIHsKCSAgICAgIHJldHVybiBrby5vYnNlcnZhYmxlQXJyYXkob2JqKTsKCSAgICB9CgkgICAgcmV0dXJuIGtvLm9ic2VydmFibGUob2JqKTsKCSAgfTsKCgkgIHV0aWxzLmNvbGxhcHNlT3B0aW9ucyA9IF9fd2VicGFja19yZXF1aXJlX18oMjEpOwoKCSAgdXRpbHMudW53cmFwTW9kZWxzID0gX193ZWJwYWNrX3JlcXVpcmVfXygyMik7CgoJICB1dGlscy5yZXNvbHZlTW9kZWwgPSBmdW5jdGlvbihtb2RlbCkgewoJICAgIGlmIChtb2RlbCAmJiBrYi5CYWNrYm9uZSAmJiBrYi5CYWNrYm9uZS5Nb2RlbFJlZiAmJiBtb2RlbCBpbnN0YW5jZW9mIGtiLkJhY2tib25lLk1vZGVsUmVmKSB7CgkgICAgICByZXR1cm4gbW9kZWwubW9kZWwoKTsKCSAgICB9IGVsc2UgewoJICAgICAgcmV0dXJuIG1vZGVsOwoJICAgIH0KCSAgfTsKCgkgIHJldHVybiB1dGlsczsKCgl9KSgpOwoKCi8qKiovIH0sCi8qIDEzICovCi8qKiovIGZ1bmN0aW9uKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewoKCQoJLyoKCSAga25vY2tiYWNrLmpzIDAuMjAuNAoJICBDb3B5cmlnaHQgKGMpICAyMDExLTIwMTQgS2V2aW4gTWFsYWtvZmYuCgkgIExpY2Vuc2U6IE1JVCAoaHR0cDovL3d3dy5vcGVuc291cmNlLm9yZy9saWNlbnNlcy9taXQtbGljZW5zZS5waHApCgkgIFNvdXJjZTogaHR0cHM6Ly9naXRodWIuY29tL2ttYWxha29mZi9rbm9ja2JhY2sKCSAgRGVwZW5kZW5jaWVzOiBLbm9ja291dC5qcywgQmFja2JvbmUuanMsIGFuZCBVbmRlcnNjb3JlLmpzIChvciBMb0Rhc2guanMpLgoJICBPcHRpb25hbCBkZXBlbmRlbmNpZXM6IEJhY2tib25lLk1vZGVsUmVmLmpzIGFuZCBCYWNrYm9uZU9STS4KCSAqLwoJdmFyIEtFWVNfT1BUSU9OUywgYXNzaWduVmlld01vZGVsS2V5LCBjcmVhdGVPYnNlcnZhYmxlLCBjcmVhdGVTdGF0aWNPYnNlcnZhYmxlcywga2IsIGtvLCBfLCBfcmVmOwoKCV9yZWYgPSBrYiA9IF9fd2VicGFja19yZXF1aXJlX18oNiksIF8gPSBfcmVmLl8sIGtvID0gX3JlZi5rbzsKCglhc3NpZ25WaWV3TW9kZWxLZXkgPSBmdW5jdGlvbih2bSwga2V5KSB7CgkgIHZhciB2bV9rZXk7CgkgIHZtX2tleSA9IHZtLl9fa2IuaW50ZXJuYWxzICYmIF8uY29udGFpbnModm0uX19rYi5pbnRlcm5hbHMsIGtleSkgPyAiXyIgKyBrZXkgOiBrZXk7CgkgIGlmICh2bS5fX2tiLnZpZXdfbW9kZWwuaGFzT3duUHJvcGVydHkodm1fa2V5KSkgewoJICAgIHJldHVybjsKCSAgfQoJICB2bS5fX2tiLnZpZXdfbW9kZWxbdm1fa2V5XSA9IG51bGw7CgkgIHJldHVybiB2bV9rZXk7Cgl9OwoKCWNyZWF0ZU9ic2VydmFibGUgPSBmdW5jdGlvbih2bSwgbW9kZWwsIGtleSwgY3JlYXRlX29wdGlvbnMpIHsKCSAgdmFyIHZtX2tleTsKCSAgaWYgKHZtLl9fa2IuZXhjbHVkZXMgJiYgXy5jb250YWlucyh2bS5fX2tiLmV4Y2x1ZGVzLCBrZXkpKSB7CgkgICAgcmV0dXJuOwoJICB9CgkgIGlmICh2bS5fX2tiLnN0YXRpY3MgJiYgXy5jb250YWlucyh2bS5fX2tiLnN0YXRpY3MsIGtleSkpIHsKCSAgICByZXR1cm47CgkgIH0KCSAgaWYgKCEodm1fa2V5ID0gYXNzaWduVmlld01vZGVsS2V5KHZtLCBrZXkpKSkgewoJICAgIHJldHVybjsKCSAgfQoJICByZXR1cm4gdm1bdm1fa2V5XSA9IHZtLl9fa2Iudmlld19tb2RlbFt2bV9rZXldID0ga2Iub2JzZXJ2YWJsZShtb2RlbCwga2V5LCBjcmVhdGVfb3B0aW9ucywgdm0pOwoJfTsKCgljcmVhdGVTdGF0aWNPYnNlcnZhYmxlcyA9IGZ1bmN0aW9uKHZtLCBtb2RlbCkgewoJICB2YXIga2V5LCB2bV9rZXksIF9pLCBfbGVuLCBfcmVmMTsKCSAgX3JlZjEgPSB2bS5fX2tiLnN0YXRpY3M7CgkgIGZvciAoX2kgPSAwLCBfbGVuID0gX3JlZjEubGVuZ3RoOyBfaSA8IF9sZW47IF9pKyspIHsKCSAgICBrZXkgPSBfcmVmMVtfaV07CgkgICAgaWYgKHZtX2tleSA9IGFzc2lnblZpZXdNb2RlbEtleSh2bSwga2V5KSkgewoJICAgICAgaWYgKG1vZGVsLmhhcyh2bV9rZXkpKSB7CgkgICAgICAgIHZtW3ZtX2tleV0gPSB2bS5fX2tiLnZpZXdfbW9kZWxbdm1fa2V5XSA9IG1vZGVsLmdldCh2bV9rZXkpOwoJICAgICAgfSBlbHNlIGlmICh2bS5fX2tiLnN0YXRpY19kZWZhdWx0cyAmJiB2bV9rZXkgaW4gdm0uX19rYi5zdGF0aWNfZGVmYXVsdHMpIHsKCSAgICAgICAgdm1bdm1fa2V5XSA9IHZtLl9fa2Iudmlld19tb2RlbFt2bV9rZXldID0gdm0uX19rYi5zdGF0aWNfZGVmYXVsdHNbdm1fa2V5XTsKCSAgICAgIH0gZWxzZSB7CgkgICAgICAgIGRlbGV0ZSB2bS5fX2tiLnZpZXdfbW9kZWxbdm1fa2V5XTsKCSAgICAgIH0KCSAgICB9CgkgIH0KCX07CgoJS0VZU19PUFRJT05TID0gWydrZXlzJywgJ2ludGVybmFscycsICdleGNsdWRlcycsICdzdGF0aWNzJywgJ3N0YXRpY19kZWZhdWx0cyddOwoKCWtiLlZpZXdNb2RlbCA9IChmdW5jdGlvbigpIHsKCSAgVmlld01vZGVsLmV4dGVuZCA9IGtiLmV4dGVuZDsKCgkgIGZ1bmN0aW9uIFZpZXdNb2RlbChtb2RlbCwgb3B0aW9ucywgdmlld19tb2RlbCkgewoJICAgIHZhciBhcmdzOwoJICAgIGlmIChvcHRpb25zID09IG51bGwpIHsKCSAgICAgIG9wdGlvbnMgPSB7fTsKCSAgICB9CgkgICAgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKF8uaXNBcmd1bWVudHMobW9kZWwpID8gbW9kZWwgOiBhcmd1bWVudHMpOwoJICAgIHJldHVybiBrYi5pZ25vcmUoKGZ1bmN0aW9uKF90aGlzKSB7CgkgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CgkgICAgICAgIHZhciBhcmcsIGV2ZW50X3dhdGNoZXIsIGtleSwgX2ksIF9qLCBfbGVuLCBfbGVuMSwgX21vZGVsOwoJICAgICAgICAhKG1vZGVsID0gYXJncy5zaGlmdCgpKSB8fCBrYi5pc01vZGVsKG1vZGVsKSB8fCBrYi5fdGhyb3dVbmV4cGVjdGVkKF90aGlzLCAnbm90IGEgbW9kZWwnKTsKCSAgICAgICAgaWYgKF8uaXNBcnJheShhcmdzWzBdKSkgewoJICAgICAgICAgIGFyZ3NbMF0gPSB7CgkgICAgICAgICAgICBrZXlzOiBhcmdzWzBdCgkgICAgICAgICAgfTsKCSAgICAgICAgfQoJICAgICAgICBfdGhpcy5fX2tiIHx8IChfdGhpcy5fX2tiID0ge30pOwoJICAgICAgICBfdGhpcy5fX2tiLnZpZXdfbW9kZWwgPSAoYXJncy5sZW5ndGggPiAxID8gYXJncy5wb3AoKSA6IF90aGlzKTsKCSAgICAgICAgb3B0aW9ucyA9IHt9OwoJICAgICAgICBmb3IgKF9pID0gMCwgX2xlbiA9IGFyZ3MubGVuZ3RoOyBfaSA8IF9sZW47IF9pKyspIHsKCSAgICAgICAgICBhcmcgPSBhcmdzW19pXTsKCSAgICAgICAgICBfLmV4dGVuZChvcHRpb25zLCBhcmcpOwoJICAgICAgICB9CgkgICAgICAgIG9wdGlvbnMgPSBrYi51dGlscy5jb2xsYXBzZU9wdGlvbnMob3B0aW9ucyk7CgkgICAgICAgIGZvciAoX2ogPSAwLCBfbGVuMSA9IEtFWVNfT1BUSU9OUy5sZW5ndGg7IF9qIDwgX2xlbjE7IF9qKyspIHsKCSAgICAgICAgICBrZXkgPSBLRVlTX09QVElPTlNbX2pdOwoJICAgICAgICAgIGlmIChvcHRpb25zLmhhc093blByb3BlcnR5KGtleSkpIHsKCSAgICAgICAgICAgIF90aGlzLl9fa2Jba2V5XSA9IG9wdGlvbnNba2V5XTsKCSAgICAgICAgICB9CgkgICAgICAgIH0KCSAgICAgICAga2IuU3RvcmUudXNlT3B0aW9uc09yQ3JlYXRlKG9wdGlvbnMsIG1vZGVsLCBfdGhpcyk7CgkgICAgICAgIF90aGlzLl9fa2IucGF0aCA9IG9wdGlvbnMucGF0aDsKCSAgICAgICAga2IuRmFjdG9yeS51c2VPcHRpb25zT3JDcmVhdGUob3B0aW9ucywgX3RoaXMsIG9wdGlvbnMucGF0aCk7CgkgICAgICAgIF9tb2RlbCA9IGtiLnV0aWxzLnNldChfdGhpcywgJ19tb2RlbCcsIGtvLm9ic2VydmFibGUoKSk7CgkgICAgICAgIF90aGlzLm1vZGVsID0ga28uY29tcHV0ZWQoewoJICAgICAgICAgIHJlYWQ6IGZ1bmN0aW9uKCkgewoJICAgICAgICAgICAgcmV0dXJuIGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUoX21vZGVsKTsKCSAgICAgICAgICB9LAoJICAgICAgICAgIHdyaXRlOiBmdW5jdGlvbihuZXdfbW9kZWwpIHsKCSAgICAgICAgICAgIHJldHVybiBrYi5pZ25vcmUoZnVuY3Rpb24oKSB7CgkgICAgICAgICAgICAgIGlmICgoa2IudXRpbHMud3JhcHBlZE9iamVjdChfdGhpcykgPT09IG5ld19tb2RlbCkgfHwga2Iud2FzUmVsZWFzZWQoX3RoaXMpIHx8ICFldmVudF93YXRjaGVyKSB7CgkgICAgICAgICAgICAgICAgcmV0dXJuOwoJICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgIF90aGlzLl9fa2Iuc3RvcmUucmV1c2UoX3RoaXMsIGtiLnV0aWxzLnJlc29sdmVNb2RlbChuZXdfbW9kZWwpKTsKCSAgICAgICAgICAgICAgZXZlbnRfd2F0Y2hlci5lbWl0dGVyKG5ld19tb2RlbCk7CgkgICAgICAgICAgICAgIF9tb2RlbChldmVudF93YXRjaGVyLmVlKTsKCSAgICAgICAgICAgICAgcmV0dXJuICFldmVudF93YXRjaGVyLmVlIHx8IF90aGlzLmNyZWF0ZU9ic2VydmFibGVzKGV2ZW50X3dhdGNoZXIuZWUpOwoJICAgICAgICAgICAgfSk7CgkgICAgICAgICAgfQoJICAgICAgICB9KTsKCSAgICAgICAgZXZlbnRfd2F0Y2hlciA9IGtiLnV0aWxzLndyYXBwZWRFdmVudFdhdGNoZXIoX3RoaXMsIG5ldyBrYi5FdmVudFdhdGNoZXIobW9kZWwsIF90aGlzLCB7CgkgICAgICAgICAgZW1pdHRlcjogX3RoaXMuX21vZGVsLAoJICAgICAgICAgIHVwZGF0ZTogKGZ1bmN0aW9uKCkgewoJICAgICAgICAgICAgcmV0dXJuIGtiLmlnbm9yZShmdW5jdGlvbigpIHsKCSAgICAgICAgICAgICAgcmV0dXJuICEoZXZlbnRfd2F0Y2hlciAhPSBudWxsID8gZXZlbnRfd2F0Y2hlci5lZSA6IHZvaWQgMCkgfHwgX3RoaXMuY3JlYXRlT2JzZXJ2YWJsZXMoZXZlbnRfd2F0Y2hlciAhPSBudWxsID8gZXZlbnRfd2F0Y2hlci5lZSA6IHZvaWQgMCk7CgkgICAgICAgICAgICB9KTsKCSAgICAgICAgICB9KQoJICAgICAgICB9KSk7CgkgICAgICAgIGtiLnV0aWxzLndyYXBwZWRPYmplY3QoX3RoaXMsIG1vZGVsID0gZXZlbnRfd2F0Y2hlci5lZSk7CgkgICAgICAgIF9tb2RlbChldmVudF93YXRjaGVyLmVlKTsKCSAgICAgICAgX3RoaXMuX19rYi5jcmVhdGVfb3B0aW9ucyA9IHsKCSAgICAgICAgICBzdG9yZToga2IudXRpbHMud3JhcHBlZFN0b3JlKF90aGlzKSwKCSAgICAgICAgICBmYWN0b3J5OiBrYi51dGlscy53cmFwcGVkRmFjdG9yeShfdGhpcyksCgkgICAgICAgICAgcGF0aDogX3RoaXMuX19rYi5wYXRoLAoJICAgICAgICAgIGV2ZW50X3dhdGNoZXI6IGtiLnV0aWxzLndyYXBwZWRFdmVudFdhdGNoZXIoX3RoaXMpCgkgICAgICAgIH07CgkgICAgICAgICFvcHRpb25zLnJlcXVpcmVzIHx8IF90aGlzLmNyZWF0ZU9ic2VydmFibGVzKG1vZGVsLCBvcHRpb25zLnJlcXVpcmVzKTsKCSAgICAgICAgIV90aGlzLl9fa2IuaW50ZXJuYWxzIHx8IF90aGlzLmNyZWF0ZU9ic2VydmFibGVzKG1vZGVsLCBfdGhpcy5fX2tiLmludGVybmFscyk7CgkgICAgICAgICFvcHRpb25zLm1hcHBpbmdzIHx8IF90aGlzLmNyZWF0ZU9ic2VydmFibGVzKG1vZGVsLCBvcHRpb25zLm1hcHBpbmdzKTsKCSAgICAgICAgIV90aGlzLl9fa2Iuc3RhdGljcyB8fCBjcmVhdGVTdGF0aWNPYnNlcnZhYmxlcyhfdGhpcywgbW9kZWwpOwoJICAgICAgICBfdGhpcy5jcmVhdGVPYnNlcnZhYmxlcyhtb2RlbCwgX3RoaXMuX19rYi5rZXlzKTsKCSAgICAgICAgIWtiLnN0YXRpc3RpY3MgfHwga2Iuc3RhdGlzdGljcy5yZWdpc3RlcignVmlld01vZGVsJywgX3RoaXMpOwoJICAgICAgICByZXR1cm4gX3RoaXM7CgkgICAgICB9OwoJICAgIH0pKHRoaXMpKTsKCSAgfQoKCSAgVmlld01vZGVsLnByb3RvdHlwZS5kZXN0cm95ID0gZnVuY3Rpb24oKSB7CgkgICAgdmFyIHZtX2tleTsKCSAgICB0aGlzLl9fa2JfcmVsZWFzZWQgPSB0cnVlOwoJICAgIGlmICh0aGlzLl9fa2Iudmlld19tb2RlbCAhPT0gdGhpcykgewoJICAgICAgZm9yICh2bV9rZXkgaW4gdGhpcy5fX2tiLnZtX2tleXMpIHsKCSAgICAgICAgdGhpcy5fX2tiLnZpZXdfbW9kZWxbdm1fa2V5XSA9IG51bGw7CgkgICAgICB9CgkgICAgfQoJICAgIHRoaXMuX19rYi52aWV3X21vZGVsID0gdGhpcy5fX2tiLmNyZWF0ZV9vcHRpb25zID0gbnVsbDsKCSAgICBrYi5yZWxlYXNlS2V5cyh0aGlzKTsKCSAgICBrYi51dGlscy53cmFwcGVkRGVzdHJveSh0aGlzKTsKCSAgICByZXR1cm4gIWtiLnN0YXRpc3RpY3MgfHwga2Iuc3RhdGlzdGljcy51bnJlZ2lzdGVyKCdWaWV3TW9kZWwnLCB0aGlzKTsKCSAgfTsKCgkgIFZpZXdNb2RlbC5wcm90b3R5cGUuc2hhcmVPcHRpb25zID0gZnVuY3Rpb24oKSB7CgkgICAgcmV0dXJuIHsKCSAgICAgIHN0b3JlOiBrYi51dGlscy53cmFwcGVkU3RvcmUodGhpcyksCgkgICAgICBmYWN0b3J5OiBrYi51dGlscy53cmFwcGVkRmFjdG9yeSh0aGlzKQoJICAgIH07CgkgIH07CgoJICBWaWV3TW9kZWwucHJvdG90eXBlLmNyZWF0ZU9ic2VydmFibGVzID0gZnVuY3Rpb24obW9kZWwsIGtleXMpIHsKCSAgICB2YXIga2V5LCBtYXBwaW5nX2luZm8sIHJlbF9rZXlzLCB2bV9rZXksIF9pLCBfaiwgX2xlbiwgX2xlbjEsIF9yZWYxOwoJICAgIGlmICgha2V5cykgewoJICAgICAgaWYgKHRoaXMuX19rYi5rZXlzIHx8ICFtb2RlbCkgewoJICAgICAgICByZXR1cm47CgkgICAgICB9CgkgICAgICBmb3IgKGtleSBpbiBtb2RlbC5hdHRyaWJ1dGVzKSB7CgkgICAgICAgIGNyZWF0ZU9ic2VydmFibGUodGhpcywgbW9kZWwsIGtleSwgdGhpcy5fX2tiLmNyZWF0ZV9vcHRpb25zKTsKCSAgICAgIH0KCSAgICAgIGlmIChyZWxfa2V5cyA9IChfcmVmMSA9IGtiLm9ybSkgIT0gbnVsbCA/IHR5cGVvZiBfcmVmMS5rZXlzID09PSAiZnVuY3Rpb24iID8gX3JlZjEua2V5cyhtb2RlbCkgOiB2b2lkIDAgOiB2b2lkIDApIHsKCSAgICAgICAgZm9yIChfaSA9IDAsIF9sZW4gPSByZWxfa2V5cy5sZW5ndGg7IF9pIDwgX2xlbjsgX2krKykgewoJICAgICAgICAgIGtleSA9IHJlbF9rZXlzW19pXTsKCSAgICAgICAgICBjcmVhdGVPYnNlcnZhYmxlKHRoaXMsIG1vZGVsLCBrZXksIHRoaXMuX19rYi5jcmVhdGVfb3B0aW9ucyk7CgkgICAgICAgIH0KCSAgICAgIH0KCSAgICB9IGVsc2UgaWYgKF8uaXNBcnJheShrZXlzKSkgewoJICAgICAgZm9yIChfaiA9IDAsIF9sZW4xID0ga2V5cy5sZW5ndGg7IF9qIDwgX2xlbjE7IF9qKyspIHsKCSAgICAgICAga2V5ID0ga2V5c1tfal07CgkgICAgICAgIGNyZWF0ZU9ic2VydmFibGUodGhpcywgbW9kZWwsIGtleSwgdGhpcy5fX2tiLmNyZWF0ZV9vcHRpb25zKTsKCSAgICAgIH0KCSAgICB9IGVsc2UgewoJICAgICAgZm9yIChrZXkgaW4ga2V5cykgewoJICAgICAgICBtYXBwaW5nX2luZm8gPSBrZXlzW2tleV07CgkgICAgICAgIGlmICghKHZtX2tleSA9IGFzc2lnblZpZXdNb2RlbEtleSh0aGlzLCBrZXkpKSkgewoJICAgICAgICAgIGNvbnRpbnVlOwoJICAgICAgICB9CgkgICAgICAgIGlmICghXy5pc1N0cmluZyhtYXBwaW5nX2luZm8pKSB7CgkgICAgICAgICAgbWFwcGluZ19pbmZvLmtleSB8fCAobWFwcGluZ19pbmZvLmtleSA9IHZtX2tleSk7CgkgICAgICAgIH0KCSAgICAgICAgdGhpc1t2bV9rZXldID0gdGhpcy5fX2tiLnZpZXdfbW9kZWxbdm1fa2V5XSA9IGtiLm9ic2VydmFibGUobW9kZWwsIG1hcHBpbmdfaW5mbywgdGhpcy5fX2tiLmNyZWF0ZV9vcHRpb25zLCB0aGlzKTsKCSAgICAgIH0KCSAgICB9CgkgIH07CgoJICByZXR1cm4gVmlld01vZGVsOwoKCX0pKCk7CgoJa2Iudmlld01vZGVsID0gZnVuY3Rpb24obW9kZWwsIG9wdGlvbnMsIHZpZXdfbW9kZWwpIHsKCSAgcmV0dXJuIG5ldyBrYi5WaWV3TW9kZWwoYXJndW1lbnRzKTsKCX07CgoKLyoqKi8gfSwKLyogMTQgKi8KLyoqKi8gZnVuY3Rpb24obW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CgoJCgkvKgoJICBrbm9ja2JhY2suanMgMC4yMC40CgkgIENvcHlyaWdodCAoYykgIDIwMTEtMjAxNCBLZXZpbiBNYWxha29mZi4KCSAgTGljZW5zZTogTUlUIChodHRwOi8vd3d3Lm9wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL21pdC1saWNlbnNlLnBocCkKCSAgU291cmNlOiBodHRwczovL2dpdGh1Yi5jb20va21hbGFrb2ZmL2tub2NrYmFjawoJICBEZXBlbmRlbmNpZXM6IEtub2Nrb3V0LmpzLCBCYWNrYm9uZS5qcywgYW5kIFVuZGVyc2NvcmUuanMgKG9yIExvRGFzaC5qcykuCgkgIE9wdGlvbmFsIGRlcGVuZGVuY2llczogQmFja2JvbmUuTW9kZWxSZWYuanMgYW5kIEJhY2tib25lT1JNLgoJICovCgl2YXIga2IsIGtleSwgX2ksIF9sZW4sIF9yZWY7CgoJbW9kdWxlLmV4cG9ydHMgPSBrYiA9IF9fd2VicGFja19yZXF1aXJlX18oNik7CgoJa2IuY29uZmlndXJlID0gX193ZWJwYWNrX3JlcXVpcmVfXygyKTsKCglrYi5tb2R1bGVzID0gewoJICB1bmRlcnNjb3JlOiBrYi5fLAoJICBiYWNrYm9uZToga2IuUGFyc2UgfHwga2IuQmFja2JvbmUsCgkgIGtub2Nrb3V0OiBrYi5rbwoJfTsKCglpZiAodHlwZW9mIHdpbmRvdyAhPT0gInVuZGVmaW5lZCIgJiYgd2luZG93ICE9PSBudWxsKSB7CgkgIF9yZWYgPSBbJ18nLCAnQmFja2JvbmUnLCAnUGFyc2UnLCAna28nLCAnJCddOwoJICBmb3IgKF9pID0gMCwgX2xlbiA9IF9yZWYubGVuZ3RoOyBfaSA8IF9sZW47IF9pKyspIHsKCSAgICBrZXkgPSBfcmVmW19pXTsKCSAgICBpZiAoa2Jba2V5XSAmJiAhT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHdpbmRvdywga2V5KSkgewoJICAgICAgd2luZG93W2tleV0gPSBrYltrZXldOwoJICAgIH0KCSAgfQoJfQoKCi8qKiovIH0sCi8qIDE1ICovCi8qKiovIGZ1bmN0aW9uKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewoKCW1vZHVsZS5leHBvcnRzID0gX19XRUJQQUNLX0VYVEVSTkFMX01PRFVMRV8xNV9fOwoKLyoqKi8gfSwKLyogMTYgKi8KLyoqKi8gZnVuY3Rpb24obW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CgoJCgkvKgoJICBrbm9ja2JhY2suanMgMC4yMC40CgkgIENvcHlyaWdodCAoYykgIDIwMTEtMjAxNCBLZXZpbiBNYWxha29mZi4KCSAgTGljZW5zZTogTUlUIChodHRwOi8vd3d3Lm9wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL21pdC1saWNlbnNlLnBocCkKCSAgU291cmNlOiBodHRwczovL2dpdGh1Yi5jb20va21hbGFrb2ZmL2tub2NrYmFjawoJICBEZXBlbmRlbmNpZXM6IEtub2Nrb3V0LmpzLCBCYWNrYm9uZS5qcywgYW5kIFVuZGVyc2NvcmUuanMgKG9yIExvRGFzaC5qcykuCgkgIE9wdGlvbmFsIGRlcGVuZGVuY2llczogQmFja2JvbmUuTW9kZWxSZWYuanMgYW5kIEJhY2tib25lT1JNLgoJICovCgl2YXIgQXNzb2NpYXRlZE1vZGVsLCBCYWNrYm9uZSwgQmFja2JvbmVBc3NvY2lhdGlvbnMsIGtiLCBfLCBfcmVmOwoKCV9yZWYgPSBrYiA9IF9fd2VicGFja19yZXF1aXJlX18oNiksIF8gPSBfcmVmLl8sIEJhY2tib25lID0gX3JlZi5CYWNrYm9uZTsKCglBc3NvY2lhdGVkTW9kZWwgPSBudWxsOwoKCW1vZHVsZS5leHBvcnRzID0gQmFja2JvbmVBc3NvY2lhdGlvbnMgPSAoZnVuY3Rpb24oKSB7CgkgIGZ1bmN0aW9uIEJhY2tib25lQXNzb2NpYXRpb25zKCkge30KCgkgIEJhY2tib25lQXNzb2NpYXRpb25zLmlzQXZhaWxhYmxlID0gZnVuY3Rpb24oKSB7CgkgICAgcmV0dXJuICEhKEFzc29jaWF0ZWRNb2RlbCA9IEJhY2tib25lICE9IG51bGwgPyBCYWNrYm9uZS5Bc3NvY2lhdGVkTW9kZWwgOiB2b2lkIDApOwoJICB9OwoKCSAgQmFja2JvbmVBc3NvY2lhdGlvbnMua2V5cyA9IGZ1bmN0aW9uKG1vZGVsKSB7CgkgICAgaWYgKCEobW9kZWwgaW5zdGFuY2VvZiBBc3NvY2lhdGVkTW9kZWwpKSB7CgkgICAgICByZXR1cm4gbnVsbDsKCSAgICB9CgkgICAgcmV0dXJuIF8ubWFwKG1vZGVsLnJlbGF0aW9ucywgZnVuY3Rpb24odGVzdCkgewoJICAgICAgcmV0dXJuIHRlc3Qua2V5OwoJICAgIH0pOwoJICB9OwoKCSAgQmFja2JvbmVBc3NvY2lhdGlvbnMucmVsYXRpb25UeXBlID0gZnVuY3Rpb24obW9kZWwsIGtleSkgewoJICAgIHZhciByZWxhdGlvbjsKCSAgICBpZiAoIShtb2RlbCBpbnN0YW5jZW9mIEFzc29jaWF0ZWRNb2RlbCkpIHsKCSAgICAgIHJldHVybiBudWxsOwoJICAgIH0KCSAgICBpZiAoIShyZWxhdGlvbiA9IF8uZmluZChtb2RlbC5yZWxhdGlvbnMsIGZ1bmN0aW9uKHRlc3QpIHsKCSAgICAgIHJldHVybiB0ZXN0LmtleSA9PT0ga2V5OwoJICAgIH0pKSkgewoJICAgICAgcmV0dXJuIG51bGw7CgkgICAgfQoJICAgIGlmIChyZWxhdGlvbi50eXBlID09PSAnTWFueScpIHsKCSAgICAgIHJldHVybiBrYi5UWVBFX0NPTExFQ1RJT047CgkgICAgfSBlbHNlIHsKCSAgICAgIHJldHVybiBrYi5UWVBFX01PREVMOwoJICAgIH0KCSAgfTsKCgkgIEJhY2tib25lQXNzb2NpYXRpb25zLnVzZUZ1bmN0aW9uID0gZnVuY3Rpb24oKSB7CgkgICAgcmV0dXJuIGZhbHNlOwoJICB9OwoKCSAgcmV0dXJuIEJhY2tib25lQXNzb2NpYXRpb25zOwoKCX0pKCk7CgoKLyoqKi8gfSwKLyogMTcgKi8KLyoqKi8gZnVuY3Rpb24obW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CgoJCgkvKgoJICBrbm9ja2JhY2suanMgMC4yMC40CgkgIENvcHlyaWdodCAoYykgIDIwMTEtMjAxNCBLZXZpbiBNYWxha29mZi4KCSAgTGljZW5zZTogTUlUIChodHRwOi8vd3d3Lm9wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL21pdC1saWNlbnNlLnBocCkKCSAgU291cmNlOiBodHRwczovL2dpdGh1Yi5jb20va21hbGFrb2ZmL2tub2NrYmFjawoJICBEZXBlbmRlbmNpZXM6IEtub2Nrb3V0LmpzLCBCYWNrYm9uZS5qcywgYW5kIFVuZGVyc2NvcmUuanMgKG9yIExvRGFzaC5qcykuCgkgIE9wdGlvbmFsIGRlcGVuZGVuY2llczogQmFja2JvbmUuTW9kZWxSZWYuanMgYW5kIEJhY2tib25lT1JNLgoJICovCgl2YXIgQmFja2JvbmUsIEJhY2tib25lUmVsYXRpb25hbCwgUmVsYXRpb25hbE1vZGVsLCBrYiwgXywgX3JlZjsKCglfcmVmID0ga2IgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDYpLCBfID0gX3JlZi5fLCBCYWNrYm9uZSA9IF9yZWYuQmFja2JvbmU7CgoJUmVsYXRpb25hbE1vZGVsID0gbnVsbDsKCgltb2R1bGUuZXhwb3J0cyA9IEJhY2tib25lUmVsYXRpb25hbCA9IChmdW5jdGlvbigpIHsKCSAgZnVuY3Rpb24gQmFja2JvbmVSZWxhdGlvbmFsKCkge30KCgkgIEJhY2tib25lUmVsYXRpb25hbC5pc0F2YWlsYWJsZSA9IGZ1bmN0aW9uKCkgewoJICAgIHJldHVybiAhIShSZWxhdGlvbmFsTW9kZWwgPSBCYWNrYm9uZSAhPSBudWxsID8gQmFja2JvbmUuUmVsYXRpb25hbE1vZGVsIDogdm9pZCAwKTsKCSAgfTsKCgkgIEJhY2tib25lUmVsYXRpb25hbC5yZWxhdGlvblR5cGUgPSBmdW5jdGlvbihtb2RlbCwga2V5KSB7CgkgICAgdmFyIHJlbGF0aW9uOwoJICAgIGlmICghKG1vZGVsIGluc3RhbmNlb2YgUmVsYXRpb25hbE1vZGVsKSkgewoJICAgICAgcmV0dXJuIG51bGw7CgkgICAgfQoJICAgIGlmICghKHJlbGF0aW9uID0gXy5maW5kKG1vZGVsLmdldFJlbGF0aW9ucygpLCBmdW5jdGlvbih0ZXN0KSB7CgkgICAgICByZXR1cm4gdGVzdC5rZXkgPT09IGtleTsKCSAgICB9KSkpIHsKCSAgICAgIHJldHVybiBudWxsOwoJICAgIH0KCSAgICBpZiAocmVsYXRpb24uY29sbGVjdGlvblR5cGUgfHwgXy5pc0FycmF5KHJlbGF0aW9uLmtleUNvbnRlbnRzKSkgewoJICAgICAgcmV0dXJuIGtiLlRZUEVfQ09MTEVDVElPTjsKCSAgICB9IGVsc2UgewoJICAgICAgcmV0dXJuIGtiLlRZUEVfTU9ERUw7CgkgICAgfQoJICB9OwoKCSAgQmFja2JvbmVSZWxhdGlvbmFsLmJpbmQgPSBmdW5jdGlvbihtb2RlbCwga2V5LCB1cGRhdGUsIHBhdGgpIHsKCSAgICB2YXIgZXZlbnQsIGV2ZW50cywgcmVsX2ZuLCB0eXBlLCBfaSwgX2xlbjsKCSAgICBpZiAoISh0eXBlID0gdGhpcy5yZWxhdGlvblR5cGUobW9kZWwsIGtleSkpKSB7CgkgICAgICByZXR1cm4gbnVsbDsKCSAgICB9CgkgICAgcmVsX2ZuID0gZnVuY3Rpb24obW9kZWwpIHsKCSAgICAgICFrYi5zdGF0aXN0aWNzIHx8IGtiLnN0YXRpc3RpY3MuYWRkTW9kZWxFdmVudCh7CgkgICAgICAgIG5hbWU6ICd1cGRhdGUgKHJlbGF0aW9uYWwpJywKCSAgICAgICAgbW9kZWw6IG1vZGVsLAoJICAgICAgICBrZXk6IGtleSwKCSAgICAgICAgcGF0aDogcGF0aAoJICAgICAgfSk7CgkgICAgICByZXR1cm4gdXBkYXRlKCk7CgkgICAgfTsKCSAgICBldmVudHMgPSBrYi5CYWNrYm9uZS5SZWxhdGlvbi5wcm90b3R5cGUuc2FuaXRpemVPcHRpb25zID8gWyd1cGRhdGUnLCAnYWRkJywgJ3JlbW92ZSddIDogWydjaGFuZ2UnLCAnYWRkJywgJ3JlbW92ZSddOwoJICAgIGlmICh0eXBlID09PSBrYi5UWVBFX0NPTExFQ1RJT04pIHsKCSAgICAgIGZvciAoX2kgPSAwLCBfbGVuID0gZXZlbnRzLmxlbmd0aDsgX2kgPCBfbGVuOyBfaSsrKSB7CgkgICAgICAgIGV2ZW50ID0gZXZlbnRzW19pXTsKCSAgICAgICAgbW9kZWwuYmluZCgiIiArIGV2ZW50ICsgIjoiICsga2V5LCByZWxfZm4pOwoJICAgICAgfQoJICAgIH0gZWxzZSB7CgkgICAgICBtb2RlbC5iaW5kKCIiICsgZXZlbnRzWzBdICsgIjoiICsga2V5LCByZWxfZm4pOwoJICAgIH0KCSAgICByZXR1cm4gZnVuY3Rpb24oKSB7CgkgICAgICB2YXIgX2osIF9sZW4xOwoJICAgICAgaWYgKHR5cGUgPT09IGtiLlRZUEVfQ09MTEVDVElPTikgewoJICAgICAgICBmb3IgKF9qID0gMCwgX2xlbjEgPSBldmVudHMubGVuZ3RoOyBfaiA8IF9sZW4xOyBfaisrKSB7CgkgICAgICAgICAgZXZlbnQgPSBldmVudHNbX2pdOwoJICAgICAgICAgIG1vZGVsLnVuYmluZCgiIiArIGV2ZW50ICsgIjoiICsga2V5LCByZWxfZm4pOwoJICAgICAgICB9CgkgICAgICB9IGVsc2UgewoJICAgICAgICBtb2RlbC51bmJpbmQoIiIgKyBldmVudHNbMF0gKyAiOiIgKyBrZXksIHJlbF9mbik7CgkgICAgICB9CgkgICAgfTsKCSAgfTsKCgkgIEJhY2tib25lUmVsYXRpb25hbC51c2VGdW5jdGlvbiA9IGZ1bmN0aW9uKCkgewoJICAgIHJldHVybiBmYWxzZTsKCSAgfTsKCgkgIHJldHVybiBCYWNrYm9uZVJlbGF0aW9uYWw7CgoJfSkoKTsKCgovKioqLyB9LAovKiAxOCAqLwovKioqLyBmdW5jdGlvbihtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKCgkvKiBXRUJQQUNLIFZBUiBJTkpFQ1RJT04gKi8oZnVuY3Rpb24oZ2xvYmFsKSB7CgkvKgoJICBrbm9ja2JhY2suanMgMC4yMC40CgkgIENvcHlyaWdodCAoYykgIDIwMTEtMjAxNCBLZXZpbiBNYWxha29mZi4KCSAgTGljZW5zZTogTUlUIChodHRwOi8vd3d3Lm9wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL21pdC1saWNlbnNlLnBocCkKCSAgU291cmNlOiBodHRwczovL2dpdGh1Yi5jb20va21hbGFrb2ZmL2tub2NrYmFjawoJICBEZXBlbmRlbmNpZXM6IEtub2Nrb3V0LmpzLCBCYWNrYm9uZS5qcywgYW5kIFVuZGVyc2NvcmUuanMgKG9yIExvRGFzaC5qcykuCgkgIE9wdGlvbmFsIGRlcGVuZGVuY2llczogQmFja2JvbmUuTW9kZWxSZWYuanMgYW5kIEJhY2tib25lT1JNLgoJICovCgl2YXIgU3VwZXJtb2RlbCwga2IsIHJvb3QsIF87CgoJcm9vdCA9IHR5cGVvZiB3aW5kb3cgIT09ICJ1bmRlZmluZWQiICYmIHdpbmRvdyAhPT0gbnVsbCA/IHdpbmRvdyA6IGdsb2JhbDsKCglfID0gKGtiID0gX193ZWJwYWNrX3JlcXVpcmVfXyg2KSkuXzsKCglTdXBlcm1vZGVsID0gbnVsbDsKCgltb2R1bGUuZXhwb3J0cyA9IFN1cGVybW9kZWwgPSAoZnVuY3Rpb24oKSB7CgkgIGZ1bmN0aW9uIFN1cGVybW9kZWwoKSB7fQoKCSAgU3VwZXJtb2RlbC5pc0F2YWlsYWJsZSA9IGZ1bmN0aW9uKCkgewoJICAgIHJldHVybiAhIShTdXBlcm1vZGVsID0gcm9vdC5TdXBlcm1vZGVsKTsKCSAgfTsKCgkgIFN1cGVybW9kZWwua2V5cyA9IGZ1bmN0aW9uKG1vZGVsKSB7CgkgICAgaWYgKCEobW9kZWwgaW5zdGFuY2VvZiBTdXBlcm1vZGVsLk1vZGVsKSkgewoJICAgICAgcmV0dXJuIG51bGw7CgkgICAgfQoJICAgIHJldHVybiBfLmtleXMobW9kZWwuY29uc3RydWN0b3IuYXNzb2NpYXRpb25zKCkpOwoJICB9OwoKCSAgU3VwZXJtb2RlbC5yZWxhdGlvblR5cGUgPSBmdW5jdGlvbihtb2RlbCwga2V5KSB7CgkgICAgdmFyIHJlbGF0aW9uOwoJICAgIGlmICghKG1vZGVsIGluc3RhbmNlb2YgU3VwZXJtb2RlbC5Nb2RlbCkpIHsKCSAgICAgIHJldHVybiBudWxsOwoJICAgIH0KCSAgICBpZiAoIShyZWxhdGlvbiA9IG1vZGVsLmNvbnN0cnVjdG9yLmFzc29jaWF0aW9ucygpW2tleV0pKSB7CgkgICAgICByZXR1cm4gbnVsbDsKCSAgICB9CgkgICAgaWYgKHJlbGF0aW9uLmFkZCkgewoJICAgICAgcmV0dXJuIGtiLlRZUEVfQ09MTEVDVElPTjsKCSAgICB9IGVsc2UgewoJICAgICAgcmV0dXJuIGtiLlRZUEVfTU9ERUw7CgkgICAgfQoJICB9OwoKCSAgU3VwZXJtb2RlbC5iaW5kID0gZnVuY3Rpb24obW9kZWwsIGtleSwgdXBkYXRlLCBwYXRoKSB7CgkgICAgdmFyIHJlbF9mbiwgdHlwZTsKCSAgICBpZiAoISh0eXBlID0gdGhpcy5yZWxhdGlvblR5cGUobW9kZWwsIGtleSkpKSB7CgkgICAgICByZXR1cm4gbnVsbDsKCSAgICB9CgkgICAgcmVsX2ZuID0gZnVuY3Rpb24obW9kZWwsIG90aGVyKSB7CgkgICAgICB2YXIgcHJldmlvdXMsIHJlbGF0aW9uOwoJICAgICAgIWtiLnN0YXRpc3RpY3MgfHwga2Iuc3RhdGlzdGljcy5hZGRNb2RlbEV2ZW50KHsKCSAgICAgICAgbmFtZTogJ3VwZGF0ZSAoc3VwZXJtb2RlbCknLAoJICAgICAgICBtb2RlbDogbW9kZWwsCgkgICAgICAgIGtleToga2V5LAoJICAgICAgICBwYXRoOiBwYXRoCgkgICAgICB9KTsKCSAgICAgIHJlbGF0aW9uID0gbW9kZWwuY29uc3RydWN0b3IuYXNzb2NpYXRpb25zKClba2V5XTsKCSAgICAgIHByZXZpb3VzID0gbW9kZWxbcmVsYXRpb24uc3RvcmVdOwoJICAgICAgbW9kZWxbcmVsYXRpb24uc3RvcmVdID0gb3RoZXI7CgkgICAgICB1cGRhdGUob3RoZXIpOwoJICAgICAgcmV0dXJuIG1vZGVsW3JlbGF0aW9uLnN0b3JlXSA9IHByZXZpb3VzOwoJICAgIH07CgkgICAgaWYgKHR5cGUgPT09IGtiLlRZUEVfTU9ERUwpIHsKCSAgICAgIG1vZGVsLmJpbmQoImFzc29jaWF0ZToiICsga2V5LCByZWxfZm4pOwoJICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewoJICAgICAgICByZXR1cm4gbW9kZWwudW5iaW5kKCJhc3NvY2lhdGU6IiArIGtleSwgcmVsX2ZuKTsKCSAgICAgIH07CgkgICAgfQoJICB9OwoKCSAgU3VwZXJtb2RlbC51c2VGdW5jdGlvbiA9IGZ1bmN0aW9uKG1vZGVsLCBrZXkpIHsKCSAgICByZXR1cm4gISF0aGlzLnJlbGF0aW9uVHlwZShtb2RlbCwga2V5KTsKCSAgfTsKCgkgIHJldHVybiBTdXBlcm1vZGVsOwoKCX0pKCk7CgkKCS8qIFdFQlBBQ0sgVkFSIElOSkVDVElPTiAqL30uY2FsbChleHBvcnRzLCAoZnVuY3Rpb24oKSB7IHJldHVybiB0aGlzOyB9KCkpKSkKCi8qKiovIH0sCi8qIDE5ICovCi8qKiovIGZ1bmN0aW9uKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewoKCQoJLyoKCSAga25vY2tiYWNrLmpzIDAuMjAuNAoJICBDb3B5cmlnaHQgKGMpICAyMDExLTIwMTQgS2V2aW4gTWFsYWtvZmYuCgkgIExpY2Vuc2U6IE1JVCAoaHR0cDovL3d3dy5vcGVuc291cmNlLm9yZy9saWNlbnNlcy9taXQtbGljZW5zZS5waHApCgkgIFNvdXJjZTogaHR0cHM6Ly9naXRodWIuY29tL2ttYWxha29mZi9rbm9ja2JhY2sKCSAgRGVwZW5kZW5jaWVzOiBLbm9ja291dC5qcywgQmFja2JvbmUuanMsIGFuZCBVbmRlcnNjb3JlLmpzIChvciBMb0Rhc2guanMpLgoJICBPcHRpb25hbCBkZXBlbmRlbmNpZXM6IEJhY2tib25lLk1vZGVsUmVmLmpzIGFuZCBCYWNrYm9uZU9STS4KCSAqLwoJdmFyIGNvcHlQcm9wczsKCgljb3B5UHJvcHMgPSBmdW5jdGlvbihkZXN0LCBzb3VyY2UpIHsKCSAgdmFyIGtleSwgdmFsdWU7CgkgIGZvciAoa2V5IGluIHNvdXJjZSkgewoJICAgIHZhbHVlID0gc291cmNlW2tleV07CgkgICAgZGVzdFtrZXldID0gdmFsdWU7CgkgIH0KCSAgcmV0dXJuIGRlc3Q7Cgl9OwoKCS8vIFNoYXJlZCBlbXB0eSBjb25zdHJ1Y3RvciBmdW5jdGlvbiB0byBhaWQgaW4gcHJvdG90eXBlLWNoYWluIGNyZWF0aW9uLgoJdmFyIGN0b3IgPSBmdW5jdGlvbigpe307CgoJLy8gSGVscGVyIGZ1bmN0aW9uIHRvIGNvcnJlY3RseSBzZXQgdXAgdGhlIHByb3RvdHlwZSBjaGFpbiwgZm9yIHN1YmNsYXNzZXMuCgkvLyBTaW1pbGFyIHRvICdnb29nLmluaGVyaXRzJywgYnV0IHVzZXMgYSBoYXNoIG9mIHByb3RvdHlwZSBwcm9wZXJ0aWVzIGFuZAoJLy8gY2xhc3MgcHJvcGVydGllcyB0byBiZSBleHRlbmRlZC4KCXZhciBpbmhlcml0cyA9IGZ1bmN0aW9uKHBhcmVudCwgcHJvdG9Qcm9wcywgc3RhdGljUHJvcHMpIHsKCSAgdmFyIGNoaWxkOwoKCSAgLy8gVGhlIGNvbnN0cnVjdG9yIGZ1bmN0aW9uIGZvciB0aGUgbmV3IHN1YmNsYXNzIGlzIGVpdGhlciBkZWZpbmVkIGJ5IHlvdQoJICAvLyAodGhlICJjb25zdHJ1Y3RvciIgcHJvcGVydHkgaW4geW91ciBleHRlbmQgZGVmaW5pdGlvbiksIG9yIGRlZmF1bHRlZAoJICAvLyBieSB1cyB0byBzaW1wbHkgY2FsbCB0aGUgcGFyZW50J3MgY29uc3RydWN0b3IuCgkgIGlmIChwcm90b1Byb3BzICYmIHByb3RvUHJvcHMuaGFzT3duUHJvcGVydHkoJ2NvbnN0cnVjdG9yJykpIHsKCSAgICBjaGlsZCA9IHByb3RvUHJvcHMuY29uc3RydWN0b3I7CgkgIH0gZWxzZSB7CgkgICAgY2hpbGQgPSBmdW5jdGlvbigpeyBwYXJlbnQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsgfTsKCSAgfQoKCSAgLy8gSW5oZXJpdCBjbGFzcyAoc3RhdGljKSBwcm9wZXJ0aWVzIGZyb20gcGFyZW50LgoJICBjb3B5UHJvcHMoY2hpbGQsIHBhcmVudCk7CgoJICAvLyBTZXQgdGhlIHByb3RvdHlwZSBjaGFpbiB0byBpbmhlcml0IGZyb20gcGFyZW50LCB3aXRob3V0IGNhbGxpbmcKCSAgLy8gcGFyZW50J3MgY29uc3RydWN0b3IgZnVuY3Rpb24uCgkgIGN0b3IucHJvdG90eXBlID0gcGFyZW50LnByb3RvdHlwZTsKCSAgY2hpbGQucHJvdG90eXBlID0gbmV3IGN0b3IoKTsKCgkgIC8vIEFkZCBwcm90b3R5cGUgcHJvcGVydGllcyAoaW5zdGFuY2UgcHJvcGVydGllcykgdG8gdGhlIHN1YmNsYXNzLAoJICAvLyBpZiBzdXBwbGllZC4KCSAgaWYgKHByb3RvUHJvcHMpIGNvcHlQcm9wcyhjaGlsZC5wcm90b3R5cGUsIHByb3RvUHJvcHMpOwoKCSAgLy8gQWRkIHN0YXRpYyBwcm9wZXJ0aWVzIHRvIHRoZSBjb25zdHJ1Y3RvciBmdW5jdGlvbiwgaWYgc3VwcGxpZWQuCgkgIGlmIChzdGF0aWNQcm9wcykgY29weVByb3BzKGNoaWxkLCBzdGF0aWNQcm9wcyk7CgoJICAvLyBDb3JyZWN0bHkgc2V0IGNoaWxkJ3MgJ3Byb3RvdHlwZS5jb25zdHJ1Y3RvcicuCgkgIGNoaWxkLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IGNoaWxkOwoKCSAgLy8gU2V0IGEgY29udmVuaWVuY2UgcHJvcGVydHkgaW4gY2FzZSB0aGUgcGFyZW50J3MgcHJvdG90eXBlIGlzIG5lZWRlZCBsYXRlci4KCSAgY2hpbGQuX19zdXBlcl9fID0gcGFyZW50LnByb3RvdHlwZTsKCgkgIHJldHVybiBjaGlsZDsKCX07CgoJLy8gVGhlIHNlbGYtcHJvcGFnYXRpbmcgZXh0ZW5kIGZ1bmN0aW9uIHRoYXQgQmFjTENvbmUgY2xhc3NlcyB1c2UuCgl2YXIgZXh0ZW5kID0gZnVuY3Rpb24gKHByb3RvUHJvcHMsIGNsYXNzUHJvcHMpIHsKCSAgdmFyIGNoaWxkID0gaW5oZXJpdHModGhpcywgcHJvdG9Qcm9wcywgY2xhc3NQcm9wcyk7CgkgIGNoaWxkLmV4dGVuZCA9IHRoaXMuZXh0ZW5kOwoJICByZXR1cm4gY2hpbGQ7Cgl9OwoJOwoKCW1vZHVsZS5leHBvcnRzID0gZXh0ZW5kOwoKCi8qKiovIH0sCi8qIDIwICovCi8qKiovIGZ1bmN0aW9uKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewoKCQoJLyoKCSAga25vY2tiYWNrLmpzIDAuMjAuNAoJICBDb3B5cmlnaHQgKGMpICAyMDExLTIwMTQgS2V2aW4gTWFsYWtvZmYuCgkgIExpY2Vuc2U6IE1JVCAoaHR0cDovL3d3dy5vcGVuc291cmNlLm9yZy9saWNlbnNlcy9taXQtbGljZW5zZS5waHApCgkgIFNvdXJjZTogaHR0cHM6Ly9naXRodWIuY29tL2ttYWxha29mZi9rbm9ja2JhY2sKCSAgRGVwZW5kZW5jaWVzOiBLbm9ja291dC5qcywgQmFja2JvbmUuanMsIGFuZCBVbmRlcnNjb3JlLmpzIChvciBMb0Rhc2guanMpLgoJICBPcHRpb25hbCBkZXBlbmRlbmNpZXM6IEJhY2tib25lLk1vZGVsUmVmLmpzIGFuZCBCYWNrYm9uZU9STS4KCSAqLwoJdmFyIHdyYXBwZWREZXN0cm95LCBfOwoKCV8gPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDYpLl87CgoJbW9kdWxlLmV4cG9ydHMgPSB3cmFwcGVkRGVzdHJveSA9IGZ1bmN0aW9uKG9iaikgewoJICB2YXIgc3RvcmVfcmVmZXJlbmNlcywgX19rYjsKCSAgaWYgKCFvYmouX19rYikgewoJICAgIHJldHVybjsKCSAgfQoJICBpZiAob2JqLl9fa2IuZXZlbnRfd2F0Y2hlcikgewoJICAgIG9iai5fX2tiLmV2ZW50X3dhdGNoZXIucmVsZWFzZUNhbGxiYWNrcyhvYmopOwoJICB9CgkgIF9fa2IgPSBvYmouX19rYjsKCSAgb2JqLl9fa2IgPSBudWxsOwoJICBpZiAoX19rYi5vYnNlcnZhYmxlKSB7CgkgICAgX19rYi5vYnNlcnZhYmxlLmRlc3Ryb3kgPSBfX2tiLm9ic2VydmFibGUucmVsZWFzZSA9IG51bGw7CgkgICAgd3JhcHBlZERlc3Ryb3koX19rYi5vYnNlcnZhYmxlKTsKCSAgICBfX2tiLm9ic2VydmFibGUgPSBudWxsOwoJICB9CgkgIF9fa2IuZmFjdG9yeSA9IG51bGw7CgkgIGlmIChfX2tiLmV2ZW50X3dhdGNoZXJfaXNfb3duZWQpIHsKCSAgICBfX2tiLmV2ZW50X3dhdGNoZXIuZGVzdHJveSgpOwoJICB9CgkgIF9fa2IuZXZlbnRfd2F0Y2hlciA9IG51bGw7CgkgIGlmIChfX2tiLnN0b3JlX2lzX293bmVkKSB7CgkgICAgX19rYi5zdG9yZS5kZXN0cm95KCk7CgkgIH0KCSAgX19rYi5zdG9yZSA9IG51bGw7CgkgIGlmIChfX2tiLnN0b3Jlc19yZWZlcmVuY2VzKSB7CgkgICAgd2hpbGUgKHN0b3JlX3JlZmVyZW5jZXMgPSBfX2tiLnN0b3Jlc19yZWZlcmVuY2VzLnBvcCgpKSB7CgkgICAgICBpZiAoIXN0b3JlX3JlZmVyZW5jZXMuc3RvcmUuX19rYl9yZWxlYXNlZCkgewoJICAgICAgICBzdG9yZV9yZWZlcmVuY2VzLnN0b3JlLnJlbGVhc2Uob2JqKTsKCSAgICAgIH0KCSAgICB9CgkgIH0KCX07CgoKLyoqKi8gfSwKLyogMjEgKi8KLyoqKi8gZnVuY3Rpb24obW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CgoJCgkvKgoJICBrbm9ja2JhY2suanMgMC4yMC40CgkgIENvcHlyaWdodCAoYykgIDIwMTEtMjAxNCBLZXZpbiBNYWxha29mZi4KCSAgTGljZW5zZTogTUlUIChodHRwOi8vd3d3Lm9wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL21pdC1saWNlbnNlLnBocCkKCSAgU291cmNlOiBodHRwczovL2dpdGh1Yi5jb20va21hbGFrb2ZmL2tub2NrYmFjawoJICBEZXBlbmRlbmNpZXM6IEtub2Nrb3V0LmpzLCBCYWNrYm9uZS5qcywgYW5kIFVuZGVyc2NvcmUuanMgKG9yIExvRGFzaC5qcykuCgkgIE9wdGlvbmFsIGRlcGVuZGVuY2llczogQmFja2JvbmUuTW9kZWxSZWYuanMgYW5kIEJhY2tib25lT1JNLgoJICovCgl2YXIgXywgX2tleUFycmF5VG9PYmplY3QsIF9tZXJnZUFycmF5LCBfbWVyZ2VPYmplY3QsIF9tZXJnZU9wdGlvbnM7CgoJXyA9IF9fd2VicGFja19yZXF1aXJlX18oNikuXzsKCglfbWVyZ2VBcnJheSA9IGZ1bmN0aW9uKHJlc3VsdCwga2V5LCB2YWx1ZSkgewoJICByZXN1bHRba2V5XSB8fCAocmVzdWx0W2tleV0gPSBbXSk7CgkgIGlmICghXy5pc0FycmF5KHZhbHVlKSkgewoJICAgIHZhbHVlID0gW3ZhbHVlXTsKCSAgfQoJICByZXN1bHRba2V5XSA9IHJlc3VsdFtrZXldLmxlbmd0aCA/IF8udW5pb24ocmVzdWx0W2tleV0sIHZhbHVlKSA6IHZhbHVlOwoJICByZXR1cm4gcmVzdWx0OwoJfTsKCglfbWVyZ2VPYmplY3QgPSBmdW5jdGlvbihyZXN1bHQsIGtleSwgdmFsdWUpIHsKCSAgcmVzdWx0W2tleV0gfHwgKHJlc3VsdFtrZXldID0ge30pOwoJICByZXR1cm4gXy5leHRlbmQocmVzdWx0W2tleV0sIHZhbHVlKTsKCX07CgoJX2tleUFycmF5VG9PYmplY3QgPSBmdW5jdGlvbih2YWx1ZSkgewoJICB2YXIgaXRlbSwgcmVzdWx0LCBfaSwgX2xlbjsKCSAgcmVzdWx0ID0ge307CgkgIGZvciAoX2kgPSAwLCBfbGVuID0gdmFsdWUubGVuZ3RoOyBfaSA8IF9sZW47IF9pKyspIHsKCSAgICBpdGVtID0gdmFsdWVbX2ldOwoJICAgIHJlc3VsdFtpdGVtXSA9IHsKCSAgICAgIGtleTogaXRlbQoJICAgIH07CgkgIH0KCSAgcmV0dXJuIHJlc3VsdDsKCX07CgoJX21lcmdlT3B0aW9ucyA9IGZ1bmN0aW9uKHJlc3VsdCwgb3B0aW9ucykgewoJICB2YXIga2V5LCB2YWx1ZTsKCSAgaWYgKCFvcHRpb25zKSB7CgkgICAgcmV0dXJuIHJlc3VsdDsKCSAgfQoJICBmb3IgKGtleSBpbiBvcHRpb25zKSB7CgkgICAgdmFsdWUgPSBvcHRpb25zW2tleV07CgkgICAgc3dpdGNoIChrZXkpIHsKCSAgICAgIGNhc2UgJ2ludGVybmFscyc6CgkgICAgICBjYXNlICdyZXF1aXJlcyc6CgkgICAgICBjYXNlICdleGNsdWRlcyc6CgkgICAgICBjYXNlICdzdGF0aWNzJzoKCSAgICAgICAgX21lcmdlQXJyYXkocmVzdWx0LCBrZXksIHZhbHVlKTsKCSAgICAgICAgYnJlYWs7CgkgICAgICBjYXNlICdrZXlzJzoKCSAgICAgICAgaWYgKChfLmlzT2JqZWN0KHZhbHVlKSAmJiAhXy5pc0FycmF5KHZhbHVlKSkgfHwgKF8uaXNPYmplY3QocmVzdWx0W2tleV0pICYmICFfLmlzQXJyYXkocmVzdWx0W2tleV0pKSkgewoJICAgICAgICAgIGlmICghXy5pc09iamVjdCh2YWx1ZSkpIHsKCSAgICAgICAgICAgIHZhbHVlID0gW3ZhbHVlXTsKCSAgICAgICAgICB9CgkgICAgICAgICAgaWYgKF8uaXNBcnJheSh2YWx1ZSkpIHsKCSAgICAgICAgICAgIHZhbHVlID0gX2tleUFycmF5VG9PYmplY3QodmFsdWUpOwoJICAgICAgICAgIH0KCSAgICAgICAgICBpZiAoXy5pc0FycmF5KHJlc3VsdFtrZXldKSkgewoJICAgICAgICAgICAgcmVzdWx0W2tleV0gPSBfa2V5QXJyYXlUb09iamVjdChyZXN1bHRba2V5XSk7CgkgICAgICAgICAgfQoJICAgICAgICAgIF9tZXJnZU9iamVjdChyZXN1bHQsIGtleSwgdmFsdWUpOwoJICAgICAgICB9IGVsc2UgewoJICAgICAgICAgIF9tZXJnZUFycmF5KHJlc3VsdCwga2V5LCB2YWx1ZSk7CgkgICAgICAgIH0KCSAgICAgICAgYnJlYWs7CgkgICAgICBjYXNlICdmYWN0b3JpZXMnOgoJICAgICAgICBpZiAoXy5pc0Z1bmN0aW9uKHZhbHVlKSkgewoJICAgICAgICAgIHJlc3VsdFtrZXldID0gdmFsdWU7CgkgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgX21lcmdlT2JqZWN0KHJlc3VsdCwga2V5LCB2YWx1ZSk7CgkgICAgICAgIH0KCSAgICAgICAgYnJlYWs7CgkgICAgICBjYXNlICdzdGF0aWNfZGVmYXVsdHMnOgoJICAgICAgICBfbWVyZ2VPYmplY3QocmVzdWx0LCBrZXksIHZhbHVlKTsKCSAgICAgICAgYnJlYWs7CgkgICAgICBjYXNlICdvcHRpb25zJzoKCSAgICAgICAgYnJlYWs7CgkgICAgICBkZWZhdWx0OgoJICAgICAgICByZXN1bHRba2V5XSA9IHZhbHVlOwoJICAgIH0KCSAgfQoJICByZXR1cm4gX21lcmdlT3B0aW9ucyhyZXN1bHQsIG9wdGlvbnMub3B0aW9ucyk7Cgl9OwoKCW1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24ob3B0aW9ucykgewoJICByZXR1cm4gX21lcmdlT3B0aW9ucyh7fSwgb3B0aW9ucyk7Cgl9OwoKCi8qKiovIH0sCi8qIDIyICovCi8qKiovIGZ1bmN0aW9uKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewoKCQoJLyoKCSAga25vY2tiYWNrLmpzIDAuMjAuNAoJICBDb3B5cmlnaHQgKGMpICAyMDExLTIwMTQgS2V2aW4gTWFsYWtvZmYuCgkgIExpY2Vuc2U6IE1JVCAoaHR0cDovL3d3dy5vcGVuc291cmNlLm9yZy9saWNlbnNlcy9taXQtbGljZW5zZS5waHApCgkgIFNvdXJjZTogaHR0cHM6Ly9naXRodWIuY29tL2ttYWxha29mZi9rbm9ja2JhY2sKCSAgRGVwZW5kZW5jaWVzOiBLbm9ja291dC5qcywgQmFja2JvbmUuanMsIGFuZCBVbmRlcnNjb3JlLmpzIChvciBMb0Rhc2guanMpLgoJICBPcHRpb25hbCBkZXBlbmRlbmNpZXM6IEJhY2tib25lLk1vZGVsUmVmLmpzIGFuZCBCYWNrYm9uZU9STS4KCSAqLwoJdmFyIHVud3JhcE1vZGVscywgXzsKCglfID0gX193ZWJwYWNrX3JlcXVpcmVfXyg2KS5fOwoKCW1vZHVsZS5leHBvcnRzID0gdW53cmFwTW9kZWxzID0gZnVuY3Rpb24ob2JqKSB7CgkgIHZhciBrZXksIHJlc3VsdCwgdmFsdWU7CgkgIGlmICghb2JqKSB7CgkgICAgcmV0dXJuIG9iajsKCSAgfQoJICBpZiAob2JqLl9fa2IpIHsKCSAgICByZXR1cm4gKG9iai5fX2tiLmhhc093blByb3BlcnR5KCdvYmplY3QnKSA/IG9iai5fX2tiLm9iamVjdCA6IG9iaik7CgkgIH0KCSAgaWYgKF8uaXNBcnJheShvYmopKSB7CgkgICAgcmV0dXJuIF8ubWFwKG9iaiwgZnVuY3Rpb24odGVzdCkgewoJICAgICAgcmV0dXJuIHVud3JhcE1vZGVscyh0ZXN0KTsKCSAgICB9KTsKCSAgfQoJICBpZiAoXy5pc09iamVjdChvYmopICYmIChvYmouY29uc3RydWN0b3IgPT09IHt9LmNvbnN0cnVjdG9yKSkgewoJICAgIHJlc3VsdCA9IHt9OwoJICAgIGZvciAoa2V5IGluIG9iaikgewoJICAgICAgdmFsdWUgPSBvYmpba2V5XTsKCSAgICAgIHJlc3VsdFtrZXldID0gdW53cmFwTW9kZWxzKHZhbHVlKTsKCSAgICB9CgkgICAgcmV0dXJuIHJlc3VsdDsKCSAgfQoJICByZXR1cm4gb2JqOwoJfTsKCgovKioqLyB9LAovKiAyMyAqLwovKioqLyBmdW5jdGlvbihtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKCgl2YXIgX19XRUJQQUNLX0FNRF9ERUZJTkVfQVJSQVlfXywgX19XRUJQQUNLX0FNRF9ERUZJTkVfUkVTVUxUX187Ly8gICAgIEJhY2tib25lLmpzIDEuMS4yCgoJLy8gICAgIChjKSAyMDEwLTIwMTQgSmVyZW15IEFzaGtlbmFzLCBEb2N1bWVudENsb3VkIGFuZCBJbnZlc3RpZ2F0aXZlIFJlcG9ydGVycyAmIEVkaXRvcnMKCS8vICAgICBCYWNrYm9uZSBtYXkgYmUgZnJlZWx5IGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS4KCS8vICAgICBGb3IgYWxsIGRldGFpbHMgYW5kIGRvY3VtZW50YXRpb246CgkvLyAgICAgaHR0cDovL2JhY2tib25lanMub3JnCgoJKGZ1bmN0aW9uKHJvb3QsIGZhY3RvcnkpIHsKCgkgIC8vIFNldCB1cCBCYWNrYm9uZSBhcHByb3ByaWF0ZWx5IGZvciB0aGUgZW52aXJvbm1lbnQuIFN0YXJ0IHdpdGggQU1ELgoJICBpZiAodHJ1ZSkgewoJICAgICEoX19XRUJQQUNLX0FNRF9ERUZJTkVfQVJSQVlfXyA9IFtfX3dlYnBhY2tfcmVxdWlyZV9fKDI0KSwgX193ZWJwYWNrX3JlcXVpcmVfXygxNSksIGV4cG9ydHNdLCBfX1dFQlBBQ0tfQU1EX0RFRklORV9SRVNVTFRfXyA9IGZ1bmN0aW9uKF8sICQsIGV4cG9ydHMpIHsKCSAgICAgIC8vIEV4cG9ydCBnbG9iYWwgZXZlbiBpbiBBTUQgY2FzZSBpbiBjYXNlIHRoaXMgc2NyaXB0IGlzIGxvYWRlZCB3aXRoCgkgICAgICAvLyBvdGhlcnMgdGhhdCBtYXkgc3RpbGwgZXhwZWN0IGEgZ2xvYmFsIEJhY2tib25lLgoJICAgICAgcm9vdC5CYWNrYm9uZSA9IGZhY3Rvcnkocm9vdCwgZXhwb3J0cywgXywgJCk7CgkgICAgfS5hcHBseShleHBvcnRzLCBfX1dFQlBBQ0tfQU1EX0RFRklORV9BUlJBWV9fKSwgX19XRUJQQUNLX0FNRF9ERUZJTkVfUkVTVUxUX18gIT09IHVuZGVmaW5lZCAmJiAobW9kdWxlLmV4cG9ydHMgPSBfX1dFQlBBQ0tfQU1EX0RFRklORV9SRVNVTFRfXykpOwoKCSAgLy8gTmV4dCBmb3IgTm9kZS5qcyBvciBDb21tb25KUy4galF1ZXJ5IG1heSBub3QgYmUgbmVlZGVkIGFzIGEgbW9kdWxlLgoJICB9IGVsc2UgaWYgKHR5cGVvZiBleHBvcnRzICE9PSAndW5kZWZpbmVkJykgewoJICAgIHZhciBfID0gcmVxdWlyZSgndW5kZXJzY29yZScpOwoJICAgIGZhY3Rvcnkocm9vdCwgZXhwb3J0cywgXyk7CgoJICAvLyBGaW5hbGx5LCBhcyBhIGJyb3dzZXIgZ2xvYmFsLgoJICB9IGVsc2UgewoJICAgIHJvb3QuQmFja2JvbmUgPSBmYWN0b3J5KHJvb3QsIHt9LCByb290Ll8sIChyb290LmpRdWVyeSB8fCByb290LlplcHRvIHx8IHJvb3QuZW5kZXIgfHwgcm9vdC4kKSk7CgkgIH0KCgl9KHRoaXMsIGZ1bmN0aW9uKHJvb3QsIEJhY2tib25lLCBfLCAkKSB7CgoJICAvLyBJbml0aWFsIFNldHVwCgkgIC8vIC0tLS0tLS0tLS0tLS0KCgkgIC8vIFNhdmUgdGhlIHByZXZpb3VzIHZhbHVlIG9mIHRoZSBgQmFja2JvbmVgIHZhcmlhYmxlLCBzbyB0aGF0IGl0IGNhbiBiZQoJICAvLyByZXN0b3JlZCBsYXRlciBvbiwgaWYgYG5vQ29uZmxpY3RgIGlzIHVzZWQuCgkgIHZhciBwcmV2aW91c0JhY2tib25lID0gcm9vdC5CYWNrYm9uZTsKCgkgIC8vIENyZWF0ZSBsb2NhbCByZWZlcmVuY2VzIHRvIGFycmF5IG1ldGhvZHMgd2UnbGwgd2FudCB0byB1c2UgbGF0ZXIuCgkgIHZhciBhcnJheSA9IFtdOwoJICB2YXIgcHVzaCA9IGFycmF5LnB1c2g7CgkgIHZhciBzbGljZSA9IGFycmF5LnNsaWNlOwoJICB2YXIgc3BsaWNlID0gYXJyYXkuc3BsaWNlOwoKCSAgLy8gQ3VycmVudCB2ZXJzaW9uIG9mIHRoZSBsaWJyYXJ5LiBLZWVwIGluIHN5bmMgd2l0aCBgcGFja2FnZS5qc29uYC4KCSAgQmFja2JvbmUuVkVSU0lPTiA9ICcxLjEuMic7CgoJICAvLyBGb3IgQmFja2JvbmUncyBwdXJwb3NlcywgalF1ZXJ5LCBaZXB0bywgRW5kZXIsIG9yIE15IExpYnJhcnkgKGtpZGRpbmcpIG93bnMKCSAgLy8gdGhlIGAkYCB2YXJpYWJsZS4KCSAgQmFja2JvbmUuJCA9ICQ7CgoJICAvLyBSdW5zIEJhY2tib25lLmpzIGluICpub0NvbmZsaWN0KiBtb2RlLCByZXR1cm5pbmcgdGhlIGBCYWNrYm9uZWAgdmFyaWFibGUKCSAgLy8gdG8gaXRzIHByZXZpb3VzIG93bmVyLiBSZXR1cm5zIGEgcmVmZXJlbmNlIHRvIHRoaXMgQmFja2JvbmUgb2JqZWN0LgoJICBCYWNrYm9uZS5ub0NvbmZsaWN0ID0gZnVuY3Rpb24oKSB7CgkgICAgcm9vdC5CYWNrYm9uZSA9IHByZXZpb3VzQmFja2JvbmU7CgkgICAgcmV0dXJuIHRoaXM7CgkgIH07CgoJICAvLyBUdXJuIG9uIGBlbXVsYXRlSFRUUGAgdG8gc3VwcG9ydCBsZWdhY3kgSFRUUCBzZXJ2ZXJzLiBTZXR0aW5nIHRoaXMgb3B0aW9uCgkgIC8vIHdpbGwgZmFrZSBgIlBBVENIImAsIGAiUFVUImAgYW5kIGAiREVMRVRFImAgcmVxdWVzdHMgdmlhIHRoZSBgX21ldGhvZGAgcGFyYW1ldGVyIGFuZAoJICAvLyBzZXQgYSBgWC1IdHRwLU1ldGhvZC1PdmVycmlkZWAgaGVhZGVyLgoJICBCYWNrYm9uZS5lbXVsYXRlSFRUUCA9IGZhbHNlOwoKCSAgLy8gVHVybiBvbiBgZW11bGF0ZUpTT05gIHRvIHN1cHBvcnQgbGVnYWN5IHNlcnZlcnMgdGhhdCBjYW4ndCBkZWFsIHdpdGggZGlyZWN0CgkgIC8vIGBhcHBsaWNhdGlvbi9qc29uYCByZXF1ZXN0cyAuLi4gd2lsbCBlbmNvZGUgdGhlIGJvZHkgYXMKCSAgLy8gYGFwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZGAgaW5zdGVhZCBhbmQgd2lsbCBzZW5kIHRoZSBtb2RlbCBpbiBhCgkgIC8vIGZvcm0gcGFyYW0gbmFtZWQgYG1vZGVsYC4KCSAgQmFja2JvbmUuZW11bGF0ZUpTT04gPSBmYWxzZTsKCgkgIC8vIEJhY2tib25lLkV2ZW50cwoJICAvLyAtLS0tLS0tLS0tLS0tLS0KCgkgIC8vIEEgbW9kdWxlIHRoYXQgY2FuIGJlIG1peGVkIGluIHRvICphbnkgb2JqZWN0KiBpbiBvcmRlciB0byBwcm92aWRlIGl0IHdpdGgKCSAgLy8gY3VzdG9tIGV2ZW50cy4gWW91IG1heSBiaW5kIHdpdGggYG9uYCBvciByZW1vdmUgd2l0aCBgb2ZmYCBjYWxsYmFjawoJICAvLyBmdW5jdGlvbnMgdG8gYW4gZXZlbnQ7IGB0cmlnZ2VyYC1pbmcgYW4gZXZlbnQgZmlyZXMgYWxsIGNhbGxiYWNrcyBpbgoJICAvLyBzdWNjZXNzaW9uLgoJICAvLwoJICAvLyAgICAgdmFyIG9iamVjdCA9IHt9OwoJICAvLyAgICAgXy5leHRlbmQob2JqZWN0LCBCYWNrYm9uZS5FdmVudHMpOwoJICAvLyAgICAgb2JqZWN0Lm9uKCdleHBhbmQnLCBmdW5jdGlvbigpeyBhbGVydCgnZXhwYW5kZWQnKTsgfSk7CgkgIC8vICAgICBvYmplY3QudHJpZ2dlcignZXhwYW5kJyk7CgkgIC8vCgkgIHZhciBFdmVudHMgPSBCYWNrYm9uZS5FdmVudHMgPSB7CgoJICAgIC8vIEJpbmQgYW4gZXZlbnQgdG8gYSBgY2FsbGJhY2tgIGZ1bmN0aW9uLiBQYXNzaW5nIGAiYWxsImAgd2lsbCBiaW5kCgkgICAgLy8gdGhlIGNhbGxiYWNrIHRvIGFsbCBldmVudHMgZmlyZWQuCgkgICAgb246IGZ1bmN0aW9uKG5hbWUsIGNhbGxiYWNrLCBjb250ZXh0KSB7CgkgICAgICBpZiAoIWV2ZW50c0FwaSh0aGlzLCAnb24nLCBuYW1lLCBbY2FsbGJhY2ssIGNvbnRleHRdKSB8fCAhY2FsbGJhY2spIHJldHVybiB0aGlzOwoJICAgICAgdGhpcy5fZXZlbnRzIHx8ICh0aGlzLl9ldmVudHMgPSB7fSk7CgkgICAgICB2YXIgZXZlbnRzID0gdGhpcy5fZXZlbnRzW25hbWVdIHx8ICh0aGlzLl9ldmVudHNbbmFtZV0gPSBbXSk7CgkgICAgICBldmVudHMucHVzaCh7Y2FsbGJhY2s6IGNhbGxiYWNrLCBjb250ZXh0OiBjb250ZXh0LCBjdHg6IGNvbnRleHQgfHwgdGhpc30pOwoJICAgICAgcmV0dXJuIHRoaXM7CgkgICAgfSwKCgkgICAgLy8gQmluZCBhbiBldmVudCB0byBvbmx5IGJlIHRyaWdnZXJlZCBhIHNpbmdsZSB0aW1lLiBBZnRlciB0aGUgZmlyc3QgdGltZQoJICAgIC8vIHRoZSBjYWxsYmFjayBpcyBpbnZva2VkLCBpdCB3aWxsIGJlIHJlbW92ZWQuCgkgICAgb25jZTogZnVuY3Rpb24obmFtZSwgY2FsbGJhY2ssIGNvbnRleHQpIHsKCSAgICAgIGlmICghZXZlbnRzQXBpKHRoaXMsICdvbmNlJywgbmFtZSwgW2NhbGxiYWNrLCBjb250ZXh0XSkgfHwgIWNhbGxiYWNrKSByZXR1cm4gdGhpczsKCSAgICAgIHZhciBzZWxmID0gdGhpczsKCSAgICAgIHZhciBvbmNlID0gXy5vbmNlKGZ1bmN0aW9uKCkgewoJICAgICAgICBzZWxmLm9mZihuYW1lLCBvbmNlKTsKCSAgICAgICAgY2FsbGJhY2suYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCSAgICAgIH0pOwoJICAgICAgb25jZS5fY2FsbGJhY2sgPSBjYWxsYmFjazsKCSAgICAgIHJldHVybiB0aGlzLm9uKG5hbWUsIG9uY2UsIGNvbnRleHQpOwoJICAgIH0sCgoJICAgIC8vIFJlbW92ZSBvbmUgb3IgbWFueSBjYWxsYmFja3MuIElmIGBjb250ZXh0YCBpcyBudWxsLCByZW1vdmVzIGFsbAoJICAgIC8vIGNhbGxiYWNrcyB3aXRoIHRoYXQgZnVuY3Rpb24uIElmIGBjYWxsYmFja2AgaXMgbnVsbCwgcmVtb3ZlcyBhbGwKCSAgICAvLyBjYWxsYmFja3MgZm9yIHRoZSBldmVudC4gSWYgYG5hbWVgIGlzIG51bGwsIHJlbW92ZXMgYWxsIGJvdW5kCgkgICAgLy8gY2FsbGJhY2tzIGZvciBhbGwgZXZlbnRzLgoJICAgIG9mZjogZnVuY3Rpb24obmFtZSwgY2FsbGJhY2ssIGNvbnRleHQpIHsKCSAgICAgIHZhciByZXRhaW4sIGV2LCBldmVudHMsIG5hbWVzLCBpLCBsLCBqLCBrOwoJICAgICAgaWYgKCF0aGlzLl9ldmVudHMgfHwgIWV2ZW50c0FwaSh0aGlzLCAnb2ZmJywgbmFtZSwgW2NhbGxiYWNrLCBjb250ZXh0XSkpIHJldHVybiB0aGlzOwoJICAgICAgaWYgKCFuYW1lICYmICFjYWxsYmFjayAmJiAhY29udGV4dCkgewoJICAgICAgICB0aGlzLl9ldmVudHMgPSB2b2lkIDA7CgkgICAgICAgIHJldHVybiB0aGlzOwoJICAgICAgfQoJICAgICAgbmFtZXMgPSBuYW1lID8gW25hbWVdIDogXy5rZXlzKHRoaXMuX2V2ZW50cyk7CgkgICAgICBmb3IgKGkgPSAwLCBsID0gbmFtZXMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CgkgICAgICAgIG5hbWUgPSBuYW1lc1tpXTsKCSAgICAgICAgaWYgKGV2ZW50cyA9IHRoaXMuX2V2ZW50c1tuYW1lXSkgewoJICAgICAgICAgIHRoaXMuX2V2ZW50c1tuYW1lXSA9IHJldGFpbiA9IFtdOwoJICAgICAgICAgIGlmIChjYWxsYmFjayB8fCBjb250ZXh0KSB7CgkgICAgICAgICAgICBmb3IgKGogPSAwLCBrID0gZXZlbnRzLmxlbmd0aDsgaiA8IGs7IGorKykgewoJICAgICAgICAgICAgICBldiA9IGV2ZW50c1tqXTsKCSAgICAgICAgICAgICAgaWYgKChjYWxsYmFjayAmJiBjYWxsYmFjayAhPT0gZXYuY2FsbGJhY2sgJiYgY2FsbGJhY2sgIT09IGV2LmNhbGxiYWNrLl9jYWxsYmFjaykgfHwKCSAgICAgICAgICAgICAgICAgIChjb250ZXh0ICYmIGNvbnRleHQgIT09IGV2LmNvbnRleHQpKSB7CgkgICAgICAgICAgICAgICAgcmV0YWluLnB1c2goZXYpOwoJICAgICAgICAgICAgICB9CgkgICAgICAgICAgICB9CgkgICAgICAgICAgfQoJICAgICAgICAgIGlmICghcmV0YWluLmxlbmd0aCkgZGVsZXRlIHRoaXMuX2V2ZW50c1tuYW1lXTsKCSAgICAgICAgfQoJICAgICAgfQoKCSAgICAgIHJldHVybiB0aGlzOwoJICAgIH0sCgoJICAgIC8vIFRyaWdnZXIgb25lIG9yIG1hbnkgZXZlbnRzLCBmaXJpbmcgYWxsIGJvdW5kIGNhbGxiYWNrcy4gQ2FsbGJhY2tzIGFyZQoJICAgIC8vIHBhc3NlZCB0aGUgc2FtZSBhcmd1bWVudHMgYXMgYHRyaWdnZXJgIGlzLCBhcGFydCBmcm9tIHRoZSBldmVudCBuYW1lCgkgICAgLy8gKHVubGVzcyB5b3UncmUgbGlzdGVuaW5nIG9uIGAiYWxsImAsIHdoaWNoIHdpbGwgY2F1c2UgeW91ciBjYWxsYmFjayB0bwoJICAgIC8vIHJlY2VpdmUgdGhlIHRydWUgbmFtZSBvZiB0aGUgZXZlbnQgYXMgdGhlIGZpcnN0IGFyZ3VtZW50KS4KCSAgICB0cmlnZ2VyOiBmdW5jdGlvbihuYW1lKSB7CgkgICAgICBpZiAoIXRoaXMuX2V2ZW50cykgcmV0dXJuIHRoaXM7CgkgICAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKCSAgICAgIGlmICghZXZlbnRzQXBpKHRoaXMsICd0cmlnZ2VyJywgbmFtZSwgYXJncykpIHJldHVybiB0aGlzOwoJICAgICAgdmFyIGV2ZW50cyA9IHRoaXMuX2V2ZW50c1tuYW1lXTsKCSAgICAgIHZhciBhbGxFdmVudHMgPSB0aGlzLl9ldmVudHMuYWxsOwoJICAgICAgaWYgKGV2ZW50cykgdHJpZ2dlckV2ZW50cyhldmVudHMsIGFyZ3MpOwoJICAgICAgaWYgKGFsbEV2ZW50cykgdHJpZ2dlckV2ZW50cyhhbGxFdmVudHMsIGFyZ3VtZW50cyk7CgkgICAgICByZXR1cm4gdGhpczsKCSAgICB9LAoKCSAgICAvLyBUZWxsIHRoaXMgb2JqZWN0IHRvIHN0b3AgbGlzdGVuaW5nIHRvIGVpdGhlciBzcGVjaWZpYyBldmVudHMgLi4uIG9yCgkgICAgLy8gdG8gZXZlcnkgb2JqZWN0IGl0J3MgY3VycmVudGx5IGxpc3RlbmluZyB0by4KCSAgICBzdG9wTGlzdGVuaW5nOiBmdW5jdGlvbihvYmosIG5hbWUsIGNhbGxiYWNrKSB7CgkgICAgICB2YXIgbGlzdGVuaW5nVG8gPSB0aGlzLl9saXN0ZW5pbmdUbzsKCSAgICAgIGlmICghbGlzdGVuaW5nVG8pIHJldHVybiB0aGlzOwoJICAgICAgdmFyIHJlbW92ZSA9ICFuYW1lICYmICFjYWxsYmFjazsKCSAgICAgIGlmICghY2FsbGJhY2sgJiYgdHlwZW9mIG5hbWUgPT09ICdvYmplY3QnKSBjYWxsYmFjayA9IHRoaXM7CgkgICAgICBpZiAob2JqKSAobGlzdGVuaW5nVG8gPSB7fSlbb2JqLl9saXN0ZW5JZF0gPSBvYmo7CgkgICAgICBmb3IgKHZhciBpZCBpbiBsaXN0ZW5pbmdUbykgewoJICAgICAgICBvYmogPSBsaXN0ZW5pbmdUb1tpZF07CgkgICAgICAgIG9iai5vZmYobmFtZSwgY2FsbGJhY2ssIHRoaXMpOwoJICAgICAgICBpZiAocmVtb3ZlIHx8IF8uaXNFbXB0eShvYmouX2V2ZW50cykpIGRlbGV0ZSB0aGlzLl9saXN0ZW5pbmdUb1tpZF07CgkgICAgICB9CgkgICAgICByZXR1cm4gdGhpczsKCSAgICB9CgoJICB9OwoKCSAgLy8gUmVndWxhciBleHByZXNzaW9uIHVzZWQgdG8gc3BsaXQgZXZlbnQgc3RyaW5ncy4KCSAgdmFyIGV2ZW50U3BsaXR0ZXIgPSAvXHMrLzsKCgkgIC8vIEltcGxlbWVudCBmYW5jeSBmZWF0dXJlcyBvZiB0aGUgRXZlbnRzIEFQSSBzdWNoIGFzIG11bHRpcGxlIGV2ZW50CgkgIC8vIG5hbWVzIGAiY2hhbmdlIGJsdXIiYCBhbmQgalF1ZXJ5LXN0eWxlIGV2ZW50IG1hcHMgYHtjaGFuZ2U6IGFjdGlvbn1gCgkgIC8vIGluIHRlcm1zIG9mIHRoZSBleGlzdGluZyBBUEkuCgkgIHZhciBldmVudHNBcGkgPSBmdW5jdGlvbihvYmosIGFjdGlvbiwgbmFtZSwgcmVzdCkgewoJICAgIGlmICghbmFtZSkgcmV0dXJuIHRydWU7CgoJICAgIC8vIEhhbmRsZSBldmVudCBtYXBzLgoJICAgIGlmICh0eXBlb2YgbmFtZSA9PT0gJ29iamVjdCcpIHsKCSAgICAgIGZvciAodmFyIGtleSBpbiBuYW1lKSB7CgkgICAgICAgIG9ialthY3Rpb25dLmFwcGx5KG9iaiwgW2tleSwgbmFtZVtrZXldXS5jb25jYXQocmVzdCkpOwoJICAgICAgfQoJICAgICAgcmV0dXJuIGZhbHNlOwoJICAgIH0KCgkgICAgLy8gSGFuZGxlIHNwYWNlIHNlcGFyYXRlZCBldmVudCBuYW1lcy4KCSAgICBpZiAoZXZlbnRTcGxpdHRlci50ZXN0KG5hbWUpKSB7CgkgICAgICB2YXIgbmFtZXMgPSBuYW1lLnNwbGl0KGV2ZW50U3BsaXR0ZXIpOwoJICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSBuYW1lcy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKCSAgICAgICAgb2JqW2FjdGlvbl0uYXBwbHkob2JqLCBbbmFtZXNbaV1dLmNvbmNhdChyZXN0KSk7CgkgICAgICB9CgkgICAgICByZXR1cm4gZmFsc2U7CgkgICAgfQoKCSAgICByZXR1cm4gdHJ1ZTsKCSAgfTsKCgkgIC8vIEEgZGlmZmljdWx0LXRvLWJlbGlldmUsIGJ1dCBvcHRpbWl6ZWQgaW50ZXJuYWwgZGlzcGF0Y2ggZnVuY3Rpb24gZm9yCgkgIC8vIHRyaWdnZXJpbmcgZXZlbnRzLiBUcmllcyB0byBrZWVwIHRoZSB1c3VhbCBjYXNlcyBzcGVlZHkgKG1vc3QgaW50ZXJuYWwKCSAgLy8gQmFja2JvbmUgZXZlbnRzIGhhdmUgMyBhcmd1bWVudHMpLgoJICB2YXIgdHJpZ2dlckV2ZW50cyA9IGZ1bmN0aW9uKGV2ZW50cywgYXJncykgewoJICAgIHZhciBldiwgaSA9IC0xLCBsID0gZXZlbnRzLmxlbmd0aCwgYTEgPSBhcmdzWzBdLCBhMiA9IGFyZ3NbMV0sIGEzID0gYXJnc1syXTsKCSAgICBzd2l0Y2ggKGFyZ3MubGVuZ3RoKSB7CgkgICAgICBjYXNlIDA6IHdoaWxlICgrK2kgPCBsKSAoZXYgPSBldmVudHNbaV0pLmNhbGxiYWNrLmNhbGwoZXYuY3R4KTsgcmV0dXJuOwoJICAgICAgY2FzZSAxOiB3aGlsZSAoKytpIDwgbCkgKGV2ID0gZXZlbnRzW2ldKS5jYWxsYmFjay5jYWxsKGV2LmN0eCwgYTEpOyByZXR1cm47CgkgICAgICBjYXNlIDI6IHdoaWxlICgrK2kgPCBsKSAoZXYgPSBldmVudHNbaV0pLmNhbGxiYWNrLmNhbGwoZXYuY3R4LCBhMSwgYTIpOyByZXR1cm47CgkgICAgICBjYXNlIDM6IHdoaWxlICgrK2kgPCBsKSAoZXYgPSBldmVudHNbaV0pLmNhbGxiYWNrLmNhbGwoZXYuY3R4LCBhMSwgYTIsIGEzKTsgcmV0dXJuOwoJICAgICAgZGVmYXVsdDogd2hpbGUgKCsraSA8IGwpIChldiA9IGV2ZW50c1tpXSkuY2FsbGJhY2suYXBwbHkoZXYuY3R4LCBhcmdzKTsgcmV0dXJuOwoJICAgIH0KCSAgfTsKCgkgIHZhciBsaXN0ZW5NZXRob2RzID0ge2xpc3RlblRvOiAnb24nLCBsaXN0ZW5Ub09uY2U6ICdvbmNlJ307CgoJICAvLyBJbnZlcnNpb24tb2YtY29udHJvbCB2ZXJzaW9ucyBvZiBgb25gIGFuZCBgb25jZWAuIFRlbGwgKnRoaXMqIG9iamVjdCB0bwoJICAvLyBsaXN0ZW4gdG8gYW4gZXZlbnQgaW4gYW5vdGhlciBvYmplY3QgLi4uIGtlZXBpbmcgdHJhY2sgb2Ygd2hhdCBpdCdzCgkgIC8vIGxpc3RlbmluZyB0by4KCSAgXy5lYWNoKGxpc3Rlbk1ldGhvZHMsIGZ1bmN0aW9uKGltcGxlbWVudGF0aW9uLCBtZXRob2QpIHsKCSAgICBFdmVudHNbbWV0aG9kXSA9IGZ1bmN0aW9uKG9iaiwgbmFtZSwgY2FsbGJhY2spIHsKCSAgICAgIHZhciBsaXN0ZW5pbmdUbyA9IHRoaXMuX2xpc3RlbmluZ1RvIHx8ICh0aGlzLl9saXN0ZW5pbmdUbyA9IHt9KTsKCSAgICAgIHZhciBpZCA9IG9iai5fbGlzdGVuSWQgfHwgKG9iai5fbGlzdGVuSWQgPSBfLnVuaXF1ZUlkKCdsJykpOwoJICAgICAgbGlzdGVuaW5nVG9baWRdID0gb2JqOwoJICAgICAgaWYgKCFjYWxsYmFjayAmJiB0eXBlb2YgbmFtZSA9PT0gJ29iamVjdCcpIGNhbGxiYWNrID0gdGhpczsKCSAgICAgIG9ialtpbXBsZW1lbnRhdGlvbl0obmFtZSwgY2FsbGJhY2ssIHRoaXMpOwoJICAgICAgcmV0dXJuIHRoaXM7CgkgICAgfTsKCSAgfSk7CgoJICAvLyBBbGlhc2VzIGZvciBiYWNrd2FyZHMgY29tcGF0aWJpbGl0eS4KCSAgRXZlbnRzLmJpbmQgICA9IEV2ZW50cy5vbjsKCSAgRXZlbnRzLnVuYmluZCA9IEV2ZW50cy5vZmY7CgoJICAvLyBBbGxvdyB0aGUgYEJhY2tib25lYCBvYmplY3QgdG8gc2VydmUgYXMgYSBnbG9iYWwgZXZlbnQgYnVzLCBmb3IgZm9sa3Mgd2hvCgkgIC8vIHdhbnQgZ2xvYmFsICJwdWJzdWIiIGluIGEgY29udmVuaWVudCBwbGFjZS4KCSAgXy5leHRlbmQoQmFja2JvbmUsIEV2ZW50cyk7CgoJICAvLyBCYWNrYm9uZS5Nb2RlbAoJICAvLyAtLS0tLS0tLS0tLS0tLQoKCSAgLy8gQmFja2JvbmUgKipNb2RlbHMqKiBhcmUgdGhlIGJhc2ljIGRhdGEgb2JqZWN0IGluIHRoZSBmcmFtZXdvcmsgLS0KCSAgLy8gZnJlcXVlbnRseSByZXByZXNlbnRpbmcgYSByb3cgaW4gYSB0YWJsZSBpbiBhIGRhdGFiYXNlIG9uIHlvdXIgc2VydmVyLgoJICAvLyBBIGRpc2NyZXRlIGNodW5rIG9mIGRhdGEgYW5kIGEgYnVuY2ggb2YgdXNlZnVsLCByZWxhdGVkIG1ldGhvZHMgZm9yCgkgIC8vIHBlcmZvcm1pbmcgY29tcHV0YXRpb25zIGFuZCB0cmFuc2Zvcm1hdGlvbnMgb24gdGhhdCBkYXRhLgoKCSAgLy8gQ3JlYXRlIGEgbmV3IG1vZGVsIHdpdGggdGhlIHNwZWNpZmllZCBhdHRyaWJ1dGVzLiBBIGNsaWVudCBpZCAoYGNpZGApCgkgIC8vIGlzIGF1dG9tYXRpY2FsbHkgZ2VuZXJhdGVkIGFuZCBhc3NpZ25lZCBmb3IgeW91LgoJICB2YXIgTW9kZWwgPSBCYWNrYm9uZS5Nb2RlbCA9IGZ1bmN0aW9uKGF0dHJpYnV0ZXMsIG9wdGlvbnMpIHsKCSAgICB2YXIgYXR0cnMgPSBhdHRyaWJ1dGVzIHx8IHt9OwoJICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CgkgICAgdGhpcy5jaWQgPSBfLnVuaXF1ZUlkKCdjJyk7CgkgICAgdGhpcy5hdHRyaWJ1dGVzID0ge307CgkgICAgaWYgKG9wdGlvbnMuY29sbGVjdGlvbikgdGhpcy5jb2xsZWN0aW9uID0gb3B0aW9ucy5jb2xsZWN0aW9uOwoJICAgIGlmIChvcHRpb25zLnBhcnNlKSBhdHRycyA9IHRoaXMucGFyc2UoYXR0cnMsIG9wdGlvbnMpIHx8IHt9OwoJICAgIGF0dHJzID0gXy5kZWZhdWx0cyh7fSwgYXR0cnMsIF8ucmVzdWx0KHRoaXMsICdkZWZhdWx0cycpKTsKCSAgICB0aGlzLnNldChhdHRycywgb3B0aW9ucyk7CgkgICAgdGhpcy5jaGFuZ2VkID0ge307CgkgICAgdGhpcy5pbml0aWFsaXplLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CgkgIH07CgoJICAvLyBBdHRhY2ggYWxsIGluaGVyaXRhYmxlIG1ldGhvZHMgdG8gdGhlIE1vZGVsIHByb3RvdHlwZS4KCSAgXy5leHRlbmQoTW9kZWwucHJvdG90eXBlLCBFdmVudHMsIHsKCgkgICAgLy8gQSBoYXNoIG9mIGF0dHJpYnV0ZXMgd2hvc2UgY3VycmVudCBhbmQgcHJldmlvdXMgdmFsdWUgZGlmZmVyLgoJICAgIGNoYW5nZWQ6IG51bGwsCgoJICAgIC8vIFRoZSB2YWx1ZSByZXR1cm5lZCBkdXJpbmcgdGhlIGxhc3QgZmFpbGVkIHZhbGlkYXRpb24uCgkgICAgdmFsaWRhdGlvbkVycm9yOiBudWxsLAoKCSAgICAvLyBUaGUgZGVmYXVsdCBuYW1lIGZvciB0aGUgSlNPTiBgaWRgIGF0dHJpYnV0ZSBpcyBgImlkImAuIE1vbmdvREIgYW5kCgkgICAgLy8gQ291Y2hEQiB1c2VycyBtYXkgd2FudCB0byBzZXQgdGhpcyB0byBgIl9pZCJgLgoJICAgIGlkQXR0cmlidXRlOiAnaWQnLAoKCSAgICAvLyBJbml0aWFsaXplIGlzIGFuIGVtcHR5IGZ1bmN0aW9uIGJ5IGRlZmF1bHQuIE92ZXJyaWRlIGl0IHdpdGggeW91ciBvd24KCSAgICAvLyBpbml0aWFsaXphdGlvbiBsb2dpYy4KCSAgICBpbml0aWFsaXplOiBmdW5jdGlvbigpe30sCgoJICAgIC8vIFJldHVybiBhIGNvcHkgb2YgdGhlIG1vZGVsJ3MgYGF0dHJpYnV0ZXNgIG9iamVjdC4KCSAgICB0b0pTT046IGZ1bmN0aW9uKG9wdGlvbnMpIHsKCSAgICAgIHJldHVybiBfLmNsb25lKHRoaXMuYXR0cmlidXRlcyk7CgkgICAgfSwKCgkgICAgLy8gUHJveHkgYEJhY2tib25lLnN5bmNgIGJ5IGRlZmF1bHQgLS0gYnV0IG92ZXJyaWRlIHRoaXMgaWYgeW91IG5lZWQKCSAgICAvLyBjdXN0b20gc3luY2luZyBzZW1hbnRpY3MgZm9yICp0aGlzKiBwYXJ0aWN1bGFyIG1vZGVsLgoJICAgIHN5bmM6IGZ1bmN0aW9uKCkgewoJICAgICAgcmV0dXJuIEJhY2tib25lLnN5bmMuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCSAgICB9LAoKCSAgICAvLyBHZXQgdGhlIHZhbHVlIG9mIGFuIGF0dHJpYnV0ZS4KCSAgICBnZXQ6IGZ1bmN0aW9uKGF0dHIpIHsKCSAgICAgIHJldHVybiB0aGlzLmF0dHJpYnV0ZXNbYXR0cl07CgkgICAgfSwKCgkgICAgLy8gR2V0IHRoZSBIVE1MLWVzY2FwZWQgdmFsdWUgb2YgYW4gYXR0cmlidXRlLgoJICAgIGVzY2FwZTogZnVuY3Rpb24oYXR0cikgewoJICAgICAgcmV0dXJuIF8uZXNjYXBlKHRoaXMuZ2V0KGF0dHIpKTsKCSAgICB9LAoKCSAgICAvLyBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgYXR0cmlidXRlIGNvbnRhaW5zIGEgdmFsdWUgdGhhdCBpcyBub3QgbnVsbAoJICAgIC8vIG9yIHVuZGVmaW5lZC4KCSAgICBoYXM6IGZ1bmN0aW9uKGF0dHIpIHsKCSAgICAgIHJldHVybiB0aGlzLmdldChhdHRyKSAhPSBudWxsOwoJICAgIH0sCgoJICAgIC8vIFNldCBhIGhhc2ggb2YgbW9kZWwgYXR0cmlidXRlcyBvbiB0aGUgb2JqZWN0LCBmaXJpbmcgYCJjaGFuZ2UiYC4gVGhpcyBpcwoJICAgIC8vIHRoZSBjb3JlIHByaW1pdGl2ZSBvcGVyYXRpb24gb2YgYSBtb2RlbCwgdXBkYXRpbmcgdGhlIGRhdGEgYW5kIG5vdGlmeWluZwoJICAgIC8vIGFueW9uZSB3aG8gbmVlZHMgdG8ga25vdyBhYm91dCB0aGUgY2hhbmdlIGluIHN0YXRlLiBUaGUgaGVhcnQgb2YgdGhlIGJlYXN0LgoJICAgIHNldDogZnVuY3Rpb24oa2V5LCB2YWwsIG9wdGlvbnMpIHsKCSAgICAgIHZhciBhdHRyLCBhdHRycywgdW5zZXQsIGNoYW5nZXMsIHNpbGVudCwgY2hhbmdpbmcsIHByZXYsIGN1cnJlbnQ7CgkgICAgICBpZiAoa2V5ID09IG51bGwpIHJldHVybiB0aGlzOwoKCSAgICAgIC8vIEhhbmRsZSBib3RoIGAia2V5IiwgdmFsdWVgIGFuZCBge2tleTogdmFsdWV9YCAtc3R5bGUgYXJndW1lbnRzLgoJICAgICAgaWYgKHR5cGVvZiBrZXkgPT09ICdvYmplY3QnKSB7CgkgICAgICAgIGF0dHJzID0ga2V5OwoJICAgICAgICBvcHRpb25zID0gdmFsOwoJICAgICAgfSBlbHNlIHsKCSAgICAgICAgKGF0dHJzID0ge30pW2tleV0gPSB2YWw7CgkgICAgICB9CgoJICAgICAgb3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KTsKCgkgICAgICAvLyBSdW4gdmFsaWRhdGlvbi4KCSAgICAgIGlmICghdGhpcy5fdmFsaWRhdGUoYXR0cnMsIG9wdGlvbnMpKSByZXR1cm4gZmFsc2U7CgoJICAgICAgLy8gRXh0cmFjdCBhdHRyaWJ1dGVzIGFuZCBvcHRpb25zLgoJICAgICAgdW5zZXQgICAgICAgICAgID0gb3B0aW9ucy51bnNldDsKCSAgICAgIHNpbGVudCAgICAgICAgICA9IG9wdGlvbnMuc2lsZW50OwoJICAgICAgY2hhbmdlcyAgICAgICAgID0gW107CgkgICAgICBjaGFuZ2luZyAgICAgICAgPSB0aGlzLl9jaGFuZ2luZzsKCSAgICAgIHRoaXMuX2NoYW5naW5nICA9IHRydWU7CgoJICAgICAgaWYgKCFjaGFuZ2luZykgewoJICAgICAgICB0aGlzLl9wcmV2aW91c0F0dHJpYnV0ZXMgPSBfLmNsb25lKHRoaXMuYXR0cmlidXRlcyk7CgkgICAgICAgIHRoaXMuY2hhbmdlZCA9IHt9OwoJICAgICAgfQoJICAgICAgY3VycmVudCA9IHRoaXMuYXR0cmlidXRlcywgcHJldiA9IHRoaXMuX3ByZXZpb3VzQXR0cmlidXRlczsKCgkgICAgICAvLyBDaGVjayBmb3IgY2hhbmdlcyBvZiBgaWRgLgoJICAgICAgaWYgKHRoaXMuaWRBdHRyaWJ1dGUgaW4gYXR0cnMpIHRoaXMuaWQgPSBhdHRyc1t0aGlzLmlkQXR0cmlidXRlXTsKCgkgICAgICAvLyBGb3IgZWFjaCBgc2V0YCBhdHRyaWJ1dGUsIHVwZGF0ZSBvciBkZWxldGUgdGhlIGN1cnJlbnQgdmFsdWUuCgkgICAgICBmb3IgKGF0dHIgaW4gYXR0cnMpIHsKCSAgICAgICAgdmFsID0gYXR0cnNbYXR0cl07CgkgICAgICAgIGlmICghXy5pc0VxdWFsKGN1cnJlbnRbYXR0cl0sIHZhbCkpIGNoYW5nZXMucHVzaChhdHRyKTsKCSAgICAgICAgaWYgKCFfLmlzRXF1YWwocHJldlthdHRyXSwgdmFsKSkgewoJICAgICAgICAgIHRoaXMuY2hhbmdlZFthdHRyXSA9IHZhbDsKCSAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICBkZWxldGUgdGhpcy5jaGFuZ2VkW2F0dHJdOwoJICAgICAgICB9CgkgICAgICAgIHVuc2V0ID8gZGVsZXRlIGN1cnJlbnRbYXR0cl0gOiBjdXJyZW50W2F0dHJdID0gdmFsOwoJICAgICAgfQoKCSAgICAgIC8vIFRyaWdnZXIgYWxsIHJlbGV2YW50IGF0dHJpYnV0ZSBjaGFuZ2VzLgoJICAgICAgaWYgKCFzaWxlbnQpIHsKCSAgICAgICAgaWYgKGNoYW5nZXMubGVuZ3RoKSB0aGlzLl9wZW5kaW5nID0gb3B0aW9uczsKCSAgICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSBjaGFuZ2VzLmxlbmd0aDsgaSA8IGw7IGkrKykgewoJICAgICAgICAgIHRoaXMudHJpZ2dlcignY2hhbmdlOicgKyBjaGFuZ2VzW2ldLCB0aGlzLCBjdXJyZW50W2NoYW5nZXNbaV1dLCBvcHRpb25zKTsKCSAgICAgICAgfQoJICAgICAgfQoKCSAgICAgIC8vIFlvdSBtaWdodCBiZSB3b25kZXJpbmcgd2h5IHRoZXJlJ3MgYSBgd2hpbGVgIGxvb3AgaGVyZS4gQ2hhbmdlcyBjYW4KCSAgICAgIC8vIGJlIHJlY3Vyc2l2ZWx5IG5lc3RlZCB3aXRoaW4gYCJjaGFuZ2UiYCBldmVudHMuCgkgICAgICBpZiAoY2hhbmdpbmcpIHJldHVybiB0aGlzOwoJICAgICAgaWYgKCFzaWxlbnQpIHsKCSAgICAgICAgd2hpbGUgKHRoaXMuX3BlbmRpbmcpIHsKCSAgICAgICAgICBvcHRpb25zID0gdGhpcy5fcGVuZGluZzsKCSAgICAgICAgICB0aGlzLl9wZW5kaW5nID0gZmFsc2U7CgkgICAgICAgICAgdGhpcy50cmlnZ2VyKCdjaGFuZ2UnLCB0aGlzLCBvcHRpb25zKTsKCSAgICAgICAgfQoJICAgICAgfQoJICAgICAgdGhpcy5fcGVuZGluZyA9IGZhbHNlOwoJICAgICAgdGhpcy5fY2hhbmdpbmcgPSBmYWxzZTsKCSAgICAgIHJldHVybiB0aGlzOwoJICAgIH0sCgoJICAgIC8vIFJlbW92ZSBhbiBhdHRyaWJ1dGUgZnJvbSB0aGUgbW9kZWwsIGZpcmluZyBgImNoYW5nZSJgLiBgdW5zZXRgIGlzIGEgbm9vcAoJICAgIC8vIGlmIHRoZSBhdHRyaWJ1dGUgZG9lc24ndCBleGlzdC4KCSAgICB1bnNldDogZnVuY3Rpb24oYXR0ciwgb3B0aW9ucykgewoJICAgICAgcmV0dXJuIHRoaXMuc2V0KGF0dHIsIHZvaWQgMCwgXy5leHRlbmQoe30sIG9wdGlvbnMsIHt1bnNldDogdHJ1ZX0pKTsKCSAgICB9LAoKCSAgICAvLyBDbGVhciBhbGwgYXR0cmlidXRlcyBvbiB0aGUgbW9kZWwsIGZpcmluZyBgImNoYW5nZSJgLgoJICAgIGNsZWFyOiBmdW5jdGlvbihvcHRpb25zKSB7CgkgICAgICB2YXIgYXR0cnMgPSB7fTsKCSAgICAgIGZvciAodmFyIGtleSBpbiB0aGlzLmF0dHJpYnV0ZXMpIGF0dHJzW2tleV0gPSB2b2lkIDA7CgkgICAgICByZXR1cm4gdGhpcy5zZXQoYXR0cnMsIF8uZXh0ZW5kKHt9LCBvcHRpb25zLCB7dW5zZXQ6IHRydWV9KSk7CgkgICAgfSwKCgkgICAgLy8gRGV0ZXJtaW5lIGlmIHRoZSBtb2RlbCBoYXMgY2hhbmdlZCBzaW5jZSB0aGUgbGFzdCBgImNoYW5nZSJgIGV2ZW50LgoJICAgIC8vIElmIHlvdSBzcGVjaWZ5IGFuIGF0dHJpYnV0ZSBuYW1lLCBkZXRlcm1pbmUgaWYgdGhhdCBhdHRyaWJ1dGUgaGFzIGNoYW5nZWQuCgkgICAgaGFzQ2hhbmdlZDogZnVuY3Rpb24oYXR0cikgewoJICAgICAgaWYgKGF0dHIgPT0gbnVsbCkgcmV0dXJuICFfLmlzRW1wdHkodGhpcy5jaGFuZ2VkKTsKCSAgICAgIHJldHVybiBfLmhhcyh0aGlzLmNoYW5nZWQsIGF0dHIpOwoJICAgIH0sCgoJICAgIC8vIFJldHVybiBhbiBvYmplY3QgY29udGFpbmluZyBhbGwgdGhlIGF0dHJpYnV0ZXMgdGhhdCBoYXZlIGNoYW5nZWQsIG9yCgkgICAgLy8gZmFsc2UgaWYgdGhlcmUgYXJlIG5vIGNoYW5nZWQgYXR0cmlidXRlcy4gVXNlZnVsIGZvciBkZXRlcm1pbmluZyB3aGF0CgkgICAgLy8gcGFydHMgb2YgYSB2aWV3IG5lZWQgdG8gYmUgdXBkYXRlZCBhbmQvb3Igd2hhdCBhdHRyaWJ1dGVzIG5lZWQgdG8gYmUKCSAgICAvLyBwZXJzaXN0ZWQgdG8gdGhlIHNlcnZlci4gVW5zZXQgYXR0cmlidXRlcyB3aWxsIGJlIHNldCB0byB1bmRlZmluZWQuCgkgICAgLy8gWW91IGNhbiBhbHNvIHBhc3MgYW4gYXR0cmlidXRlcyBvYmplY3QgdG8gZGlmZiBhZ2FpbnN0IHRoZSBtb2RlbCwKCSAgICAvLyBkZXRlcm1pbmluZyBpZiB0aGVyZSAqd291bGQgYmUqIGEgY2hhbmdlLgoJICAgIGNoYW5nZWRBdHRyaWJ1dGVzOiBmdW5jdGlvbihkaWZmKSB7CgkgICAgICBpZiAoIWRpZmYpIHJldHVybiB0aGlzLmhhc0NoYW5nZWQoKSA/IF8uY2xvbmUodGhpcy5jaGFuZ2VkKSA6IGZhbHNlOwoJICAgICAgdmFyIHZhbCwgY2hhbmdlZCA9IGZhbHNlOwoJICAgICAgdmFyIG9sZCA9IHRoaXMuX2NoYW5naW5nID8gdGhpcy5fcHJldmlvdXNBdHRyaWJ1dGVzIDogdGhpcy5hdHRyaWJ1dGVzOwoJICAgICAgZm9yICh2YXIgYXR0ciBpbiBkaWZmKSB7CgkgICAgICAgIGlmIChfLmlzRXF1YWwob2xkW2F0dHJdLCAodmFsID0gZGlmZlthdHRyXSkpKSBjb250aW51ZTsKCSAgICAgICAgKGNoYW5nZWQgfHwgKGNoYW5nZWQgPSB7fSkpW2F0dHJdID0gdmFsOwoJICAgICAgfQoJICAgICAgcmV0dXJuIGNoYW5nZWQ7CgkgICAgfSwKCgkgICAgLy8gR2V0IHRoZSBwcmV2aW91cyB2YWx1ZSBvZiBhbiBhdHRyaWJ1dGUsIHJlY29yZGVkIGF0IHRoZSB0aW1lIHRoZSBsYXN0CgkgICAgLy8gYCJjaGFuZ2UiYCBldmVudCB3YXMgZmlyZWQuCgkgICAgcHJldmlvdXM6IGZ1bmN0aW9uKGF0dHIpIHsKCSAgICAgIGlmIChhdHRyID09IG51bGwgfHwgIXRoaXMuX3ByZXZpb3VzQXR0cmlidXRlcykgcmV0dXJuIG51bGw7CgkgICAgICByZXR1cm4gdGhpcy5fcHJldmlvdXNBdHRyaWJ1dGVzW2F0dHJdOwoJICAgIH0sCgoJICAgIC8vIEdldCBhbGwgb2YgdGhlIGF0dHJpYnV0ZXMgb2YgdGhlIG1vZGVsIGF0IHRoZSB0aW1lIG9mIHRoZSBwcmV2aW91cwoJICAgIC8vIGAiY2hhbmdlImAgZXZlbnQuCgkgICAgcHJldmlvdXNBdHRyaWJ1dGVzOiBmdW5jdGlvbigpIHsKCSAgICAgIHJldHVybiBfLmNsb25lKHRoaXMuX3ByZXZpb3VzQXR0cmlidXRlcyk7CgkgICAgfSwKCgkgICAgLy8gRmV0Y2ggdGhlIG1vZGVsIGZyb20gdGhlIHNlcnZlci4gSWYgdGhlIHNlcnZlcidzIHJlcHJlc2VudGF0aW9uIG9mIHRoZQoJICAgIC8vIG1vZGVsIGRpZmZlcnMgZnJvbSBpdHMgY3VycmVudCBhdHRyaWJ1dGVzLCB0aGV5IHdpbGwgYmUgb3ZlcnJpZGRlbiwKCSAgICAvLyB0cmlnZ2VyaW5nIGEgYCJjaGFuZ2UiYCBldmVudC4KCSAgICBmZXRjaDogZnVuY3Rpb24ob3B0aW9ucykgewoJICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgPyBfLmNsb25lKG9wdGlvbnMpIDoge307CgkgICAgICBpZiAob3B0aW9ucy5wYXJzZSA9PT0gdm9pZCAwKSBvcHRpb25zLnBhcnNlID0gdHJ1ZTsKCSAgICAgIHZhciBtb2RlbCA9IHRoaXM7CgkgICAgICB2YXIgc3VjY2VzcyA9IG9wdGlvbnMuc3VjY2VzczsKCSAgICAgIG9wdGlvbnMuc3VjY2VzcyA9IGZ1bmN0aW9uKHJlc3ApIHsKCSAgICAgICAgaWYgKCFtb2RlbC5zZXQobW9kZWwucGFyc2UocmVzcCwgb3B0aW9ucyksIG9wdGlvbnMpKSByZXR1cm4gZmFsc2U7CgkgICAgICAgIGlmIChzdWNjZXNzKSBzdWNjZXNzKG1vZGVsLCByZXNwLCBvcHRpb25zKTsKCSAgICAgICAgbW9kZWwudHJpZ2dlcignc3luYycsIG1vZGVsLCByZXNwLCBvcHRpb25zKTsKCSAgICAgIH07CgkgICAgICB3cmFwRXJyb3IodGhpcywgb3B0aW9ucyk7CgkgICAgICByZXR1cm4gdGhpcy5zeW5jKCdyZWFkJywgdGhpcywgb3B0aW9ucyk7CgkgICAgfSwKCgkgICAgLy8gU2V0IGEgaGFzaCBvZiBtb2RlbCBhdHRyaWJ1dGVzLCBhbmQgc3luYyB0aGUgbW9kZWwgdG8gdGhlIHNlcnZlci4KCSAgICAvLyBJZiB0aGUgc2VydmVyIHJldHVybnMgYW4gYXR0cmlidXRlcyBoYXNoIHRoYXQgZGlmZmVycywgdGhlIG1vZGVsJ3MKCSAgICAvLyBzdGF0ZSB3aWxsIGJlIGBzZXRgIGFnYWluLgoJICAgIHNhdmU6IGZ1bmN0aW9uKGtleSwgdmFsLCBvcHRpb25zKSB7CgkgICAgICB2YXIgYXR0cnMsIG1ldGhvZCwgeGhyLCBhdHRyaWJ1dGVzID0gdGhpcy5hdHRyaWJ1dGVzOwoKCSAgICAgIC8vIEhhbmRsZSBib3RoIGAia2V5IiwgdmFsdWVgIGFuZCBge2tleTogdmFsdWV9YCAtc3R5bGUgYXJndW1lbnRzLgoJICAgICAgaWYgKGtleSA9PSBudWxsIHx8IHR5cGVvZiBrZXkgPT09ICdvYmplY3QnKSB7CgkgICAgICAgIGF0dHJzID0ga2V5OwoJICAgICAgICBvcHRpb25zID0gdmFsOwoJICAgICAgfSBlbHNlIHsKCSAgICAgICAgKGF0dHJzID0ge30pW2tleV0gPSB2YWw7CgkgICAgICB9CgoJICAgICAgb3B0aW9ucyA9IF8uZXh0ZW5kKHt2YWxpZGF0ZTogdHJ1ZX0sIG9wdGlvbnMpOwoKCSAgICAgIC8vIElmIHdlJ3JlIG5vdCB3YWl0aW5nIGFuZCBhdHRyaWJ1dGVzIGV4aXN0LCBzYXZlIGFjdHMgYXMKCSAgICAgIC8vIGBzZXQoYXR0cikuc2F2ZShudWxsLCBvcHRzKWAgd2l0aCB2YWxpZGF0aW9uLiBPdGhlcndpc2UsIGNoZWNrIGlmCgkgICAgICAvLyB0aGUgbW9kZWwgd2lsbCBiZSB2YWxpZCB3aGVuIHRoZSBhdHRyaWJ1dGVzLCBpZiBhbnksIGFyZSBzZXQuCgkgICAgICBpZiAoYXR0cnMgJiYgIW9wdGlvbnMud2FpdCkgewoJICAgICAgICBpZiAoIXRoaXMuc2V0KGF0dHJzLCBvcHRpb25zKSkgcmV0dXJuIGZhbHNlOwoJICAgICAgfSBlbHNlIHsKCSAgICAgICAgaWYgKCF0aGlzLl92YWxpZGF0ZShhdHRycywgb3B0aW9ucykpIHJldHVybiBmYWxzZTsKCSAgICAgIH0KCgkgICAgICAvLyBTZXQgdGVtcG9yYXJ5IGF0dHJpYnV0ZXMgaWYgYHt3YWl0OiB0cnVlfWAuCgkgICAgICBpZiAoYXR0cnMgJiYgb3B0aW9ucy53YWl0KSB7CgkgICAgICAgIHRoaXMuYXR0cmlidXRlcyA9IF8uZXh0ZW5kKHt9LCBhdHRyaWJ1dGVzLCBhdHRycyk7CgkgICAgICB9CgoJICAgICAgLy8gQWZ0ZXIgYSBzdWNjZXNzZnVsIHNlcnZlci1zaWRlIHNhdmUsIHRoZSBjbGllbnQgaXMgKG9wdGlvbmFsbHkpCgkgICAgICAvLyB1cGRhdGVkIHdpdGggdGhlIHNlcnZlci1zaWRlIHN0YXRlLgoJICAgICAgaWYgKG9wdGlvbnMucGFyc2UgPT09IHZvaWQgMCkgb3B0aW9ucy5wYXJzZSA9IHRydWU7CgkgICAgICB2YXIgbW9kZWwgPSB0aGlzOwoJICAgICAgdmFyIHN1Y2Nlc3MgPSBvcHRpb25zLnN1Y2Nlc3M7CgkgICAgICBvcHRpb25zLnN1Y2Nlc3MgPSBmdW5jdGlvbihyZXNwKSB7CgkgICAgICAgIC8vIEVuc3VyZSBhdHRyaWJ1dGVzIGFyZSByZXN0b3JlZCBkdXJpbmcgc3luY2hyb25vdXMgc2F2ZXMuCgkgICAgICAgIG1vZGVsLmF0dHJpYnV0ZXMgPSBhdHRyaWJ1dGVzOwoJICAgICAgICB2YXIgc2VydmVyQXR0cnMgPSBtb2RlbC5wYXJzZShyZXNwLCBvcHRpb25zKTsKCSAgICAgICAgaWYgKG9wdGlvbnMud2FpdCkgc2VydmVyQXR0cnMgPSBfLmV4dGVuZChhdHRycyB8fCB7fSwgc2VydmVyQXR0cnMpOwoJICAgICAgICBpZiAoXy5pc09iamVjdChzZXJ2ZXJBdHRycykgJiYgIW1vZGVsLnNldChzZXJ2ZXJBdHRycywgb3B0aW9ucykpIHsKCSAgICAgICAgICByZXR1cm4gZmFsc2U7CgkgICAgICAgIH0KCSAgICAgICAgaWYgKHN1Y2Nlc3MpIHN1Y2Nlc3MobW9kZWwsIHJlc3AsIG9wdGlvbnMpOwoJICAgICAgICBtb2RlbC50cmlnZ2VyKCdzeW5jJywgbW9kZWwsIHJlc3AsIG9wdGlvbnMpOwoJICAgICAgfTsKCSAgICAgIHdyYXBFcnJvcih0aGlzLCBvcHRpb25zKTsKCgkgICAgICBtZXRob2QgPSB0aGlzLmlzTmV3KCkgPyAnY3JlYXRlJyA6IChvcHRpb25zLnBhdGNoID8gJ3BhdGNoJyA6ICd1cGRhdGUnKTsKCSAgICAgIGlmIChtZXRob2QgPT09ICdwYXRjaCcpIG9wdGlvbnMuYXR0cnMgPSBhdHRyczsKCSAgICAgIHhociA9IHRoaXMuc3luYyhtZXRob2QsIHRoaXMsIG9wdGlvbnMpOwoKCSAgICAgIC8vIFJlc3RvcmUgYXR0cmlidXRlcy4KCSAgICAgIGlmIChhdHRycyAmJiBvcHRpb25zLndhaXQpIHRoaXMuYXR0cmlidXRlcyA9IGF0dHJpYnV0ZXM7CgoJICAgICAgcmV0dXJuIHhocjsKCSAgICB9LAoKCSAgICAvLyBEZXN0cm95IHRoaXMgbW9kZWwgb24gdGhlIHNlcnZlciBpZiBpdCB3YXMgYWxyZWFkeSBwZXJzaXN0ZWQuCgkgICAgLy8gT3B0aW1pc3RpY2FsbHkgcmVtb3ZlcyB0aGUgbW9kZWwgZnJvbSBpdHMgY29sbGVjdGlvbiwgaWYgaXQgaGFzIG9uZS4KCSAgICAvLyBJZiBgd2FpdDogdHJ1ZWAgaXMgcGFzc2VkLCB3YWl0cyBmb3IgdGhlIHNlcnZlciB0byByZXNwb25kIGJlZm9yZSByZW1vdmFsLgoJICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKCSAgICAgIG9wdGlvbnMgPSBvcHRpb25zID8gXy5jbG9uZShvcHRpb25zKSA6IHt9OwoJICAgICAgdmFyIG1vZGVsID0gdGhpczsKCSAgICAgIHZhciBzdWNjZXNzID0gb3B0aW9ucy5zdWNjZXNzOwoKCSAgICAgIHZhciBkZXN0cm95ID0gZnVuY3Rpb24oKSB7CgkgICAgICAgIG1vZGVsLnRyaWdnZXIoJ2Rlc3Ryb3knLCBtb2RlbCwgbW9kZWwuY29sbGVjdGlvbiwgb3B0aW9ucyk7CgkgICAgICB9OwoKCSAgICAgIG9wdGlvbnMuc3VjY2VzcyA9IGZ1bmN0aW9uKHJlc3ApIHsKCSAgICAgICAgaWYgKG9wdGlvbnMud2FpdCB8fCBtb2RlbC5pc05ldygpKSBkZXN0cm95KCk7CgkgICAgICAgIGlmIChzdWNjZXNzKSBzdWNjZXNzKG1vZGVsLCByZXNwLCBvcHRpb25zKTsKCSAgICAgICAgaWYgKCFtb2RlbC5pc05ldygpKSBtb2RlbC50cmlnZ2VyKCdzeW5jJywgbW9kZWwsIHJlc3AsIG9wdGlvbnMpOwoJICAgICAgfTsKCgkgICAgICBpZiAodGhpcy5pc05ldygpKSB7CgkgICAgICAgIG9wdGlvbnMuc3VjY2VzcygpOwoJICAgICAgICByZXR1cm4gZmFsc2U7CgkgICAgICB9CgkgICAgICB3cmFwRXJyb3IodGhpcywgb3B0aW9ucyk7CgoJICAgICAgdmFyIHhociA9IHRoaXMuc3luYygnZGVsZXRlJywgdGhpcywgb3B0aW9ucyk7CgkgICAgICBpZiAoIW9wdGlvbnMud2FpdCkgZGVzdHJveSgpOwoJICAgICAgcmV0dXJuIHhocjsKCSAgICB9LAoKCSAgICAvLyBEZWZhdWx0IFVSTCBmb3IgdGhlIG1vZGVsJ3MgcmVwcmVzZW50YXRpb24gb24gdGhlIHNlcnZlciAtLSBpZiB5b3UncmUKCSAgICAvLyB1c2luZyBCYWNrYm9uZSdzIHJlc3RmdWwgbWV0aG9kcywgb3ZlcnJpZGUgdGhpcyB0byBjaGFuZ2UgdGhlIGVuZHBvaW50CgkgICAgLy8gdGhhdCB3aWxsIGJlIGNhbGxlZC4KCSAgICB1cmw6IGZ1bmN0aW9uKCkgewoJICAgICAgdmFyIGJhc2UgPQoJICAgICAgICBfLnJlc3VsdCh0aGlzLCAndXJsUm9vdCcpIHx8CgkgICAgICAgIF8ucmVzdWx0KHRoaXMuY29sbGVjdGlvbiwgJ3VybCcpIHx8CgkgICAgICAgIHVybEVycm9yKCk7CgkgICAgICBpZiAodGhpcy5pc05ldygpKSByZXR1cm4gYmFzZTsKCSAgICAgIHJldHVybiBiYXNlLnJlcGxhY2UoLyhbXlwvXSkkLywgJyQxLycpICsgZW5jb2RlVVJJQ29tcG9uZW50KHRoaXMuaWQpOwoJICAgIH0sCgoJICAgIC8vICoqcGFyc2UqKiBjb252ZXJ0cyBhIHJlc3BvbnNlIGludG8gdGhlIGhhc2ggb2YgYXR0cmlidXRlcyB0byBiZSBgc2V0YCBvbgoJICAgIC8vIHRoZSBtb2RlbC4gVGhlIGRlZmF1bHQgaW1wbGVtZW50YXRpb24gaXMganVzdCB0byBwYXNzIHRoZSByZXNwb25zZSBhbG9uZy4KCSAgICBwYXJzZTogZnVuY3Rpb24ocmVzcCwgb3B0aW9ucykgewoJICAgICAgcmV0dXJuIHJlc3A7CgkgICAgfSwKCgkgICAgLy8gQ3JlYXRlIGEgbmV3IG1vZGVsIHdpdGggaWRlbnRpY2FsIGF0dHJpYnV0ZXMgdG8gdGhpcyBvbmUuCgkgICAgY2xvbmU6IGZ1bmN0aW9uKCkgewoJICAgICAgcmV0dXJuIG5ldyB0aGlzLmNvbnN0cnVjdG9yKHRoaXMuYXR0cmlidXRlcyk7CgkgICAgfSwKCgkgICAgLy8gQSBtb2RlbCBpcyBuZXcgaWYgaXQgaGFzIG5ldmVyIGJlZW4gc2F2ZWQgdG8gdGhlIHNlcnZlciwgYW5kIGxhY2tzIGFuIGlkLgoJICAgIGlzTmV3OiBmdW5jdGlvbigpIHsKCSAgICAgIHJldHVybiAhdGhpcy5oYXModGhpcy5pZEF0dHJpYnV0ZSk7CgkgICAgfSwKCgkgICAgLy8gQ2hlY2sgaWYgdGhlIG1vZGVsIGlzIGN1cnJlbnRseSBpbiBhIHZhbGlkIHN0YXRlLgoJICAgIGlzVmFsaWQ6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKCSAgICAgIHJldHVybiB0aGlzLl92YWxpZGF0ZSh7fSwgXy5leHRlbmQob3B0aW9ucyB8fCB7fSwgeyB2YWxpZGF0ZTogdHJ1ZSB9KSk7CgkgICAgfSwKCgkgICAgLy8gUnVuIHZhbGlkYXRpb24gYWdhaW5zdCB0aGUgbmV4dCBjb21wbGV0ZSBzZXQgb2YgbW9kZWwgYXR0cmlidXRlcywKCSAgICAvLyByZXR1cm5pbmcgYHRydWVgIGlmIGFsbCBpcyB3ZWxsLiBPdGhlcndpc2UsIGZpcmUgYW4gYCJpbnZhbGlkImAgZXZlbnQuCgkgICAgX3ZhbGlkYXRlOiBmdW5jdGlvbihhdHRycywgb3B0aW9ucykgewoJICAgICAgaWYgKCFvcHRpb25zLnZhbGlkYXRlIHx8ICF0aGlzLnZhbGlkYXRlKSByZXR1cm4gdHJ1ZTsKCSAgICAgIGF0dHJzID0gXy5leHRlbmQoe30sIHRoaXMuYXR0cmlidXRlcywgYXR0cnMpOwoJICAgICAgdmFyIGVycm9yID0gdGhpcy52YWxpZGF0aW9uRXJyb3IgPSB0aGlzLnZhbGlkYXRlKGF0dHJzLCBvcHRpb25zKSB8fCBudWxsOwoJICAgICAgaWYgKCFlcnJvcikgcmV0dXJuIHRydWU7CgkgICAgICB0aGlzLnRyaWdnZXIoJ2ludmFsaWQnLCB0aGlzLCBlcnJvciwgXy5leHRlbmQob3B0aW9ucywge3ZhbGlkYXRpb25FcnJvcjogZXJyb3J9KSk7CgkgICAgICByZXR1cm4gZmFsc2U7CgkgICAgfQoKCSAgfSk7CgoJICAvLyBVbmRlcnNjb3JlIG1ldGhvZHMgdGhhdCB3ZSB3YW50IHRvIGltcGxlbWVudCBvbiB0aGUgTW9kZWwuCgkgIHZhciBtb2RlbE1ldGhvZHMgPSBbJ2tleXMnLCAndmFsdWVzJywgJ3BhaXJzJywgJ2ludmVydCcsICdwaWNrJywgJ29taXQnXTsKCgkgIC8vIE1peCBpbiBlYWNoIFVuZGVyc2NvcmUgbWV0aG9kIGFzIGEgcHJveHkgdG8gYE1vZGVsI2F0dHJpYnV0ZXNgLgoJICBfLmVhY2gobW9kZWxNZXRob2RzLCBmdW5jdGlvbihtZXRob2QpIHsKCSAgICBNb2RlbC5wcm90b3R5cGVbbWV0aG9kXSA9IGZ1bmN0aW9uKCkgewoJICAgICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cyk7CgkgICAgICBhcmdzLnVuc2hpZnQodGhpcy5hdHRyaWJ1dGVzKTsKCSAgICAgIHJldHVybiBfW21ldGhvZF0uYXBwbHkoXywgYXJncyk7CgkgICAgfTsKCSAgfSk7CgoJICAvLyBCYWNrYm9uZS5Db2xsZWN0aW9uCgkgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0KCgkgIC8vIElmIG1vZGVscyB0ZW5kIHRvIHJlcHJlc2VudCBhIHNpbmdsZSByb3cgb2YgZGF0YSwgYSBCYWNrYm9uZSBDb2xsZWN0aW9uIGlzCgkgIC8vIG1vcmUgYW5hbGFnb3VzIHRvIGEgdGFibGUgZnVsbCBvZiBkYXRhIC4uLiBvciBhIHNtYWxsIHNsaWNlIG9yIHBhZ2Ugb2YgdGhhdAoJICAvLyB0YWJsZSwgb3IgYSBjb2xsZWN0aW9uIG9mIHJvd3MgdGhhdCBiZWxvbmcgdG9nZXRoZXIgZm9yIGEgcGFydGljdWxhciByZWFzb24KCSAgLy8gLS0gYWxsIG9mIHRoZSBtZXNzYWdlcyBpbiB0aGlzIHBhcnRpY3VsYXIgZm9sZGVyLCBhbGwgb2YgdGhlIGRvY3VtZW50cwoJICAvLyBiZWxvbmdpbmcgdG8gdGhpcyBwYXJ0aWN1bGFyIGF1dGhvciwgYW5kIHNvIG9uLiBDb2xsZWN0aW9ucyBtYWludGFpbgoJICAvLyBpbmRleGVzIG9mIHRoZWlyIG1vZGVscywgYm90aCBpbiBvcmRlciwgYW5kIGZvciBsb29rdXAgYnkgYGlkYC4KCgkgIC8vIENyZWF0ZSBhIG5ldyAqKkNvbGxlY3Rpb24qKiwgcGVyaGFwcyB0byBjb250YWluIGEgc3BlY2lmaWMgdHlwZSBvZiBgbW9kZWxgLgoJICAvLyBJZiBhIGBjb21wYXJhdG9yYCBpcyBzcGVjaWZpZWQsIHRoZSBDb2xsZWN0aW9uIHdpbGwgbWFpbnRhaW4KCSAgLy8gaXRzIG1vZGVscyBpbiBzb3J0IG9yZGVyLCBhcyB0aGV5J3JlIGFkZGVkIGFuZCByZW1vdmVkLgoJICB2YXIgQ29sbGVjdGlvbiA9IEJhY2tib25lLkNvbGxlY3Rpb24gPSBmdW5jdGlvbihtb2RlbHMsIG9wdGlvbnMpIHsKCSAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwoJICAgIGlmIChvcHRpb25zLm1vZGVsKSB0aGlzLm1vZGVsID0gb3B0aW9ucy5tb2RlbDsKCSAgICBpZiAob3B0aW9ucy5jb21wYXJhdG9yICE9PSB2b2lkIDApIHRoaXMuY29tcGFyYXRvciA9IG9wdGlvbnMuY29tcGFyYXRvcjsKCSAgICB0aGlzLl9yZXNldCgpOwoJICAgIHRoaXMuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoJICAgIGlmIChtb2RlbHMpIHRoaXMucmVzZXQobW9kZWxzLCBfLmV4dGVuZCh7c2lsZW50OiB0cnVlfSwgb3B0aW9ucykpOwoJICB9OwoKCSAgLy8gRGVmYXVsdCBvcHRpb25zIGZvciBgQ29sbGVjdGlvbiNzZXRgLgoJICB2YXIgc2V0T3B0aW9ucyA9IHthZGQ6IHRydWUsIHJlbW92ZTogdHJ1ZSwgbWVyZ2U6IHRydWV9OwoJICB2YXIgYWRkT3B0aW9ucyA9IHthZGQ6IHRydWUsIHJlbW92ZTogZmFsc2V9OwoKCSAgLy8gRGVmaW5lIHRoZSBDb2xsZWN0aW9uJ3MgaW5oZXJpdGFibGUgbWV0aG9kcy4KCSAgXy5leHRlbmQoQ29sbGVjdGlvbi5wcm90b3R5cGUsIEV2ZW50cywgewoKCSAgICAvLyBUaGUgZGVmYXVsdCBtb2RlbCBmb3IgYSBjb2xsZWN0aW9uIGlzIGp1c3QgYSAqKkJhY2tib25lLk1vZGVsKiouCgkgICAgLy8gVGhpcyBzaG91bGQgYmUgb3ZlcnJpZGRlbiBpbiBtb3N0IGNhc2VzLgoJICAgIG1vZGVsOiBNb2RlbCwKCgkgICAgLy8gSW5pdGlhbGl6ZSBpcyBhbiBlbXB0eSBmdW5jdGlvbiBieSBkZWZhdWx0LiBPdmVycmlkZSBpdCB3aXRoIHlvdXIgb3duCgkgICAgLy8gaW5pdGlhbGl6YXRpb24gbG9naWMuCgkgICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oKXt9LAoKCSAgICAvLyBUaGUgSlNPTiByZXByZXNlbnRhdGlvbiBvZiBhIENvbGxlY3Rpb24gaXMgYW4gYXJyYXkgb2YgdGhlCgkgICAgLy8gbW9kZWxzJyBhdHRyaWJ1dGVzLgoJICAgIHRvSlNPTjogZnVuY3Rpb24ob3B0aW9ucykgewoJICAgICAgcmV0dXJuIHRoaXMubWFwKGZ1bmN0aW9uKG1vZGVsKXsgcmV0dXJuIG1vZGVsLnRvSlNPTihvcHRpb25zKTsgfSk7CgkgICAgfSwKCgkgICAgLy8gUHJveHkgYEJhY2tib25lLnN5bmNgIGJ5IGRlZmF1bHQuCgkgICAgc3luYzogZnVuY3Rpb24oKSB7CgkgICAgICByZXR1cm4gQmFja2JvbmUuc3luYy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoJICAgIH0sCgoJICAgIC8vIEFkZCBhIG1vZGVsLCBvciBsaXN0IG9mIG1vZGVscyB0byB0aGUgc2V0LgoJICAgIGFkZDogZnVuY3Rpb24obW9kZWxzLCBvcHRpb25zKSB7CgkgICAgICByZXR1cm4gdGhpcy5zZXQobW9kZWxzLCBfLmV4dGVuZCh7bWVyZ2U6IGZhbHNlfSwgb3B0aW9ucywgYWRkT3B0aW9ucykpOwoJICAgIH0sCgoJICAgIC8vIFJlbW92ZSBhIG1vZGVsLCBvciBhIGxpc3Qgb2YgbW9kZWxzIGZyb20gdGhlIHNldC4KCSAgICByZW1vdmU6IGZ1bmN0aW9uKG1vZGVscywgb3B0aW9ucykgewoJICAgICAgdmFyIHNpbmd1bGFyID0gIV8uaXNBcnJheShtb2RlbHMpOwoJICAgICAgbW9kZWxzID0gc2luZ3VsYXIgPyBbbW9kZWxzXSA6IF8uY2xvbmUobW9kZWxzKTsKCSAgICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CgkgICAgICB2YXIgaSwgbCwgaW5kZXgsIG1vZGVsOwoJICAgICAgZm9yIChpID0gMCwgbCA9IG1vZGVscy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKCSAgICAgICAgbW9kZWwgPSBtb2RlbHNbaV0gPSB0aGlzLmdldChtb2RlbHNbaV0pOwoJICAgICAgICBpZiAoIW1vZGVsKSBjb250aW51ZTsKCSAgICAgICAgZGVsZXRlIHRoaXMuX2J5SWRbbW9kZWwuaWRdOwoJICAgICAgICBkZWxldGUgdGhpcy5fYnlJZFttb2RlbC5jaWRdOwoJICAgICAgICBpbmRleCA9IHRoaXMuaW5kZXhPZihtb2RlbCk7CgkgICAgICAgIHRoaXMubW9kZWxzLnNwbGljZShpbmRleCwgMSk7CgkgICAgICAgIHRoaXMubGVuZ3RoLS07CgkgICAgICAgIGlmICghb3B0aW9ucy5zaWxlbnQpIHsKCSAgICAgICAgICBvcHRpb25zLmluZGV4ID0gaW5kZXg7CgkgICAgICAgICAgbW9kZWwudHJpZ2dlcigncmVtb3ZlJywgbW9kZWwsIHRoaXMsIG9wdGlvbnMpOwoJICAgICAgICB9CgkgICAgICAgIHRoaXMuX3JlbW92ZVJlZmVyZW5jZShtb2RlbCwgb3B0aW9ucyk7CgkgICAgICB9CgkgICAgICByZXR1cm4gc2luZ3VsYXIgPyBtb2RlbHNbMF0gOiBtb2RlbHM7CgkgICAgfSwKCgkgICAgLy8gVXBkYXRlIGEgY29sbGVjdGlvbiBieSBgc2V0YC1pbmcgYSBuZXcgbGlzdCBvZiBtb2RlbHMsIGFkZGluZyBuZXcgb25lcywKCSAgICAvLyByZW1vdmluZyBtb2RlbHMgdGhhdCBhcmUgbm8gbG9uZ2VyIHByZXNlbnQsIGFuZCBtZXJnaW5nIG1vZGVscyB0aGF0CgkgICAgLy8gYWxyZWFkeSBleGlzdCBpbiB0aGUgY29sbGVjdGlvbiwgYXMgbmVjZXNzYXJ5LiBTaW1pbGFyIHRvICoqTW9kZWwjc2V0KiosCgkgICAgLy8gdGhlIGNvcmUgb3BlcmF0aW9uIGZvciB1cGRhdGluZyB0aGUgZGF0YSBjb250YWluZWQgYnkgdGhlIGNvbGxlY3Rpb24uCgkgICAgc2V0OiBmdW5jdGlvbihtb2RlbHMsIG9wdGlvbnMpIHsKCSAgICAgIG9wdGlvbnMgPSBfLmRlZmF1bHRzKHt9LCBvcHRpb25zLCBzZXRPcHRpb25zKTsKCSAgICAgIGlmIChvcHRpb25zLnBhcnNlKSBtb2RlbHMgPSB0aGlzLnBhcnNlKG1vZGVscywgb3B0aW9ucyk7CgkgICAgICB2YXIgc2luZ3VsYXIgPSAhXy5pc0FycmF5KG1vZGVscyk7CgkgICAgICBtb2RlbHMgPSBzaW5ndWxhciA/IChtb2RlbHMgPyBbbW9kZWxzXSA6IFtdKSA6IF8uY2xvbmUobW9kZWxzKTsKCSAgICAgIHZhciBpLCBsLCBpZCwgbW9kZWwsIGF0dHJzLCBleGlzdGluZywgc29ydDsKCSAgICAgIHZhciBhdCA9IG9wdGlvbnMuYXQ7CgkgICAgICB2YXIgdGFyZ2V0TW9kZWwgPSB0aGlzLm1vZGVsOwoJICAgICAgdmFyIHNvcnRhYmxlID0gdGhpcy5jb21wYXJhdG9yICYmIChhdCA9PSBudWxsKSAmJiBvcHRpb25zLnNvcnQgIT09IGZhbHNlOwoJICAgICAgdmFyIHNvcnRBdHRyID0gXy5pc1N0cmluZyh0aGlzLmNvbXBhcmF0b3IpID8gdGhpcy5jb21wYXJhdG9yIDogbnVsbDsKCSAgICAgIHZhciB0b0FkZCA9IFtdLCB0b1JlbW92ZSA9IFtdLCBtb2RlbE1hcCA9IHt9OwoJICAgICAgdmFyIGFkZCA9IG9wdGlvbnMuYWRkLCBtZXJnZSA9IG9wdGlvbnMubWVyZ2UsIHJlbW92ZSA9IG9wdGlvbnMucmVtb3ZlOwoJICAgICAgdmFyIG9yZGVyID0gIXNvcnRhYmxlICYmIGFkZCAmJiByZW1vdmUgPyBbXSA6IGZhbHNlOwoKCSAgICAgIC8vIFR1cm4gYmFyZSBvYmplY3RzIGludG8gbW9kZWwgcmVmZXJlbmNlcywgYW5kIHByZXZlbnQgaW52YWxpZCBtb2RlbHMKCSAgICAgIC8vIGZyb20gYmVpbmcgYWRkZWQuCgkgICAgICBmb3IgKGkgPSAwLCBsID0gbW9kZWxzLmxlbmd0aDsgaSA8IGw7IGkrKykgewoJICAgICAgICBhdHRycyA9IG1vZGVsc1tpXSB8fCB7fTsKCSAgICAgICAgaWYgKGF0dHJzIGluc3RhbmNlb2YgTW9kZWwpIHsKCSAgICAgICAgICBpZCA9IG1vZGVsID0gYXR0cnM7CgkgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgaWQgPSBhdHRyc1t0YXJnZXRNb2RlbC5wcm90b3R5cGUuaWRBdHRyaWJ1dGUgfHwgJ2lkJ107CgkgICAgICAgIH0KCgkgICAgICAgIC8vIElmIGEgZHVwbGljYXRlIGlzIGZvdW5kLCBwcmV2ZW50IGl0IGZyb20gYmVpbmcgYWRkZWQgYW5kCgkgICAgICAgIC8vIG9wdGlvbmFsbHkgbWVyZ2UgaXQgaW50byB0aGUgZXhpc3RpbmcgbW9kZWwuCgkgICAgICAgIGlmIChleGlzdGluZyA9IHRoaXMuZ2V0KGlkKSkgewoJICAgICAgICAgIGlmIChyZW1vdmUpIG1vZGVsTWFwW2V4aXN0aW5nLmNpZF0gPSB0cnVlOwoJICAgICAgICAgIGlmIChtZXJnZSkgewoJICAgICAgICAgICAgYXR0cnMgPSBhdHRycyA9PT0gbW9kZWwgPyBtb2RlbC5hdHRyaWJ1dGVzIDogYXR0cnM7CgkgICAgICAgICAgICBpZiAob3B0aW9ucy5wYXJzZSkgYXR0cnMgPSBleGlzdGluZy5wYXJzZShhdHRycywgb3B0aW9ucyk7CgkgICAgICAgICAgICBleGlzdGluZy5zZXQoYXR0cnMsIG9wdGlvbnMpOwoJICAgICAgICAgICAgaWYgKHNvcnRhYmxlICYmICFzb3J0ICYmIGV4aXN0aW5nLmhhc0NoYW5nZWQoc29ydEF0dHIpKSBzb3J0ID0gdHJ1ZTsKCSAgICAgICAgICB9CgkgICAgICAgICAgbW9kZWxzW2ldID0gZXhpc3Rpbmc7CgoJICAgICAgICAvLyBJZiB0aGlzIGlzIGEgbmV3LCB2YWxpZCBtb2RlbCwgcHVzaCBpdCB0byB0aGUgYHRvQWRkYCBsaXN0LgoJICAgICAgICB9IGVsc2UgaWYgKGFkZCkgewoJICAgICAgICAgIG1vZGVsID0gbW9kZWxzW2ldID0gdGhpcy5fcHJlcGFyZU1vZGVsKGF0dHJzLCBvcHRpb25zKTsKCSAgICAgICAgICBpZiAoIW1vZGVsKSBjb250aW51ZTsKCSAgICAgICAgICB0b0FkZC5wdXNoKG1vZGVsKTsKCSAgICAgICAgICB0aGlzLl9hZGRSZWZlcmVuY2UobW9kZWwsIG9wdGlvbnMpOwoJICAgICAgICB9CgoJICAgICAgICAvLyBEbyBub3QgYWRkIG11bHRpcGxlIG1vZGVscyB3aXRoIHRoZSBzYW1lIGBpZGAuCgkgICAgICAgIG1vZGVsID0gZXhpc3RpbmcgfHwgbW9kZWw7CgkgICAgICAgIGlmIChvcmRlciAmJiAobW9kZWwuaXNOZXcoKSB8fCAhbW9kZWxNYXBbbW9kZWwuaWRdKSkgb3JkZXIucHVzaChtb2RlbCk7CgkgICAgICAgIG1vZGVsTWFwW21vZGVsLmlkXSA9IHRydWU7CgkgICAgICB9CgoJICAgICAgLy8gUmVtb3ZlIG5vbmV4aXN0ZW50IG1vZGVscyBpZiBhcHByb3ByaWF0ZS4KCSAgICAgIGlmIChyZW1vdmUpIHsKCSAgICAgICAgZm9yIChpID0gMCwgbCA9IHRoaXMubGVuZ3RoOyBpIDwgbDsgKytpKSB7CgkgICAgICAgICAgaWYgKCFtb2RlbE1hcFsobW9kZWwgPSB0aGlzLm1vZGVsc1tpXSkuY2lkXSkgdG9SZW1vdmUucHVzaChtb2RlbCk7CgkgICAgICAgIH0KCSAgICAgICAgaWYgKHRvUmVtb3ZlLmxlbmd0aCkgdGhpcy5yZW1vdmUodG9SZW1vdmUsIG9wdGlvbnMpOwoJICAgICAgfQoKCSAgICAgIC8vIFNlZSBpZiBzb3J0aW5nIGlzIG5lZWRlZCwgdXBkYXRlIGBsZW5ndGhgIGFuZCBzcGxpY2UgaW4gbmV3IG1vZGVscy4KCSAgICAgIGlmICh0b0FkZC5sZW5ndGggfHwgKG9yZGVyICYmIG9yZGVyLmxlbmd0aCkpIHsKCSAgICAgICAgaWYgKHNvcnRhYmxlKSBzb3J0ID0gdHJ1ZTsKCSAgICAgICAgdGhpcy5sZW5ndGggKz0gdG9BZGQubGVuZ3RoOwoJICAgICAgICBpZiAoYXQgIT0gbnVsbCkgewoJICAgICAgICAgIGZvciAoaSA9IDAsIGwgPSB0b0FkZC5sZW5ndGg7IGkgPCBsOyBpKyspIHsKCSAgICAgICAgICAgIHRoaXMubW9kZWxzLnNwbGljZShhdCArIGksIDAsIHRvQWRkW2ldKTsKCSAgICAgICAgICB9CgkgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgaWYgKG9yZGVyKSB0aGlzLm1vZGVscy5sZW5ndGggPSAwOwoJICAgICAgICAgIHZhciBvcmRlcmVkTW9kZWxzID0gb3JkZXIgfHwgdG9BZGQ7CgkgICAgICAgICAgZm9yIChpID0gMCwgbCA9IG9yZGVyZWRNb2RlbHMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CgkgICAgICAgICAgICB0aGlzLm1vZGVscy5wdXNoKG9yZGVyZWRNb2RlbHNbaV0pOwoJICAgICAgICAgIH0KCSAgICAgICAgfQoJICAgICAgfQoKCSAgICAgIC8vIFNpbGVudGx5IHNvcnQgdGhlIGNvbGxlY3Rpb24gaWYgYXBwcm9wcmlhdGUuCgkgICAgICBpZiAoc29ydCkgdGhpcy5zb3J0KHtzaWxlbnQ6IHRydWV9KTsKCgkgICAgICAvLyBVbmxlc3Mgc2lsZW5jZWQsIGl0J3MgdGltZSB0byBmaXJlIGFsbCBhcHByb3ByaWF0ZSBhZGQvc29ydCBldmVudHMuCgkgICAgICBpZiAoIW9wdGlvbnMuc2lsZW50KSB7CgkgICAgICAgIGZvciAoaSA9IDAsIGwgPSB0b0FkZC5sZW5ndGg7IGkgPCBsOyBpKyspIHsKCSAgICAgICAgICAobW9kZWwgPSB0b0FkZFtpXSkudHJpZ2dlcignYWRkJywgbW9kZWwsIHRoaXMsIG9wdGlvbnMpOwoJICAgICAgICB9CgkgICAgICAgIGlmIChzb3J0IHx8IChvcmRlciAmJiBvcmRlci5sZW5ndGgpKSB0aGlzLnRyaWdnZXIoJ3NvcnQnLCB0aGlzLCBvcHRpb25zKTsKCSAgICAgIH0KCgkgICAgICAvLyBSZXR1cm4gdGhlIGFkZGVkIChvciBtZXJnZWQpIG1vZGVsIChvciBtb2RlbHMpLgoJICAgICAgcmV0dXJuIHNpbmd1bGFyID8gbW9kZWxzWzBdIDogbW9kZWxzOwoJICAgIH0sCgoJICAgIC8vIFdoZW4geW91IGhhdmUgbW9yZSBpdGVtcyB0aGFuIHlvdSB3YW50IHRvIGFkZCBvciByZW1vdmUgaW5kaXZpZHVhbGx5LAoJICAgIC8vIHlvdSBjYW4gcmVzZXQgdGhlIGVudGlyZSBzZXQgd2l0aCBhIG5ldyBsaXN0IG9mIG1vZGVscywgd2l0aG91dCBmaXJpbmcKCSAgICAvLyBhbnkgZ3JhbnVsYXIgYGFkZGAgb3IgYHJlbW92ZWAgZXZlbnRzLiBGaXJlcyBgcmVzZXRgIHdoZW4gZmluaXNoZWQuCgkgICAgLy8gVXNlZnVsIGZvciBidWxrIG9wZXJhdGlvbnMgYW5kIG9wdGltaXphdGlvbnMuCgkgICAgcmVzZXQ6IGZ1bmN0aW9uKG1vZGVscywgb3B0aW9ucykgewoJICAgICAgb3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KTsKCSAgICAgIGZvciAodmFyIGkgPSAwLCBsID0gdGhpcy5tb2RlbHMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CgkgICAgICAgIHRoaXMuX3JlbW92ZVJlZmVyZW5jZSh0aGlzLm1vZGVsc1tpXSwgb3B0aW9ucyk7CgkgICAgICB9CgkgICAgICBvcHRpb25zLnByZXZpb3VzTW9kZWxzID0gdGhpcy5tb2RlbHM7CgkgICAgICB0aGlzLl9yZXNldCgpOwoJICAgICAgbW9kZWxzID0gdGhpcy5hZGQobW9kZWxzLCBfLmV4dGVuZCh7c2lsZW50OiB0cnVlfSwgb3B0aW9ucykpOwoJICAgICAgaWYgKCFvcHRpb25zLnNpbGVudCkgdGhpcy50cmlnZ2VyKCdyZXNldCcsIHRoaXMsIG9wdGlvbnMpOwoJICAgICAgcmV0dXJuIG1vZGVsczsKCSAgICB9LAoKCSAgICAvLyBBZGQgYSBtb2RlbCB0byB0aGUgZW5kIG9mIHRoZSBjb2xsZWN0aW9uLgoJICAgIHB1c2g6IGZ1bmN0aW9uKG1vZGVsLCBvcHRpb25zKSB7CgkgICAgICByZXR1cm4gdGhpcy5hZGQobW9kZWwsIF8uZXh0ZW5kKHthdDogdGhpcy5sZW5ndGh9LCBvcHRpb25zKSk7CgkgICAgfSwKCgkgICAgLy8gUmVtb3ZlIGEgbW9kZWwgZnJvbSB0aGUgZW5kIG9mIHRoZSBjb2xsZWN0aW9uLgoJICAgIHBvcDogZnVuY3Rpb24ob3B0aW9ucykgewoJICAgICAgdmFyIG1vZGVsID0gdGhpcy5hdCh0aGlzLmxlbmd0aCAtIDEpOwoJICAgICAgdGhpcy5yZW1vdmUobW9kZWwsIG9wdGlvbnMpOwoJICAgICAgcmV0dXJuIG1vZGVsOwoJICAgIH0sCgoJICAgIC8vIEFkZCBhIG1vZGVsIHRvIHRoZSBiZWdpbm5pbmcgb2YgdGhlIGNvbGxlY3Rpb24uCgkgICAgdW5zaGlmdDogZnVuY3Rpb24obW9kZWwsIG9wdGlvbnMpIHsKCSAgICAgIHJldHVybiB0aGlzLmFkZChtb2RlbCwgXy5leHRlbmQoe2F0OiAwfSwgb3B0aW9ucykpOwoJICAgIH0sCgoJICAgIC8vIFJlbW92ZSBhIG1vZGVsIGZyb20gdGhlIGJlZ2lubmluZyBvZiB0aGUgY29sbGVjdGlvbi4KCSAgICBzaGlmdDogZnVuY3Rpb24ob3B0aW9ucykgewoJICAgICAgdmFyIG1vZGVsID0gdGhpcy5hdCgwKTsKCSAgICAgIHRoaXMucmVtb3ZlKG1vZGVsLCBvcHRpb25zKTsKCSAgICAgIHJldHVybiBtb2RlbDsKCSAgICB9LAoKCSAgICAvLyBTbGljZSBvdXQgYSBzdWItYXJyYXkgb2YgbW9kZWxzIGZyb20gdGhlIGNvbGxlY3Rpb24uCgkgICAgc2xpY2U6IGZ1bmN0aW9uKCkgewoJICAgICAgcmV0dXJuIHNsaWNlLmFwcGx5KHRoaXMubW9kZWxzLCBhcmd1bWVudHMpOwoJICAgIH0sCgoJICAgIC8vIEdldCBhIG1vZGVsIGZyb20gdGhlIHNldCBieSBpZC4KCSAgICBnZXQ6IGZ1bmN0aW9uKG9iaikgewoJICAgICAgaWYgKG9iaiA9PSBudWxsKSByZXR1cm4gdm9pZCAwOwoJICAgICAgcmV0dXJuIHRoaXMuX2J5SWRbb2JqXSB8fCB0aGlzLl9ieUlkW29iai5pZF0gfHwgdGhpcy5fYnlJZFtvYmouY2lkXTsKCSAgICB9LAoKCSAgICAvLyBHZXQgdGhlIG1vZGVsIGF0IHRoZSBnaXZlbiBpbmRleC4KCSAgICBhdDogZnVuY3Rpb24oaW5kZXgpIHsKCSAgICAgIHJldHVybiB0aGlzLm1vZGVsc1tpbmRleF07CgkgICAgfSwKCgkgICAgLy8gUmV0dXJuIG1vZGVscyB3aXRoIG1hdGNoaW5nIGF0dHJpYnV0ZXMuIFVzZWZ1bCBmb3Igc2ltcGxlIGNhc2VzIG9mCgkgICAgLy8gYGZpbHRlcmAuCgkgICAgd2hlcmU6IGZ1bmN0aW9uKGF0dHJzLCBmaXJzdCkgewoJICAgICAgaWYgKF8uaXNFbXB0eShhdHRycykpIHJldHVybiBmaXJzdCA/IHZvaWQgMCA6IFtdOwoJICAgICAgcmV0dXJuIHRoaXNbZmlyc3QgPyAnZmluZCcgOiAnZmlsdGVyJ10oZnVuY3Rpb24obW9kZWwpIHsKCSAgICAgICAgZm9yICh2YXIga2V5IGluIGF0dHJzKSB7CgkgICAgICAgICAgaWYgKGF0dHJzW2tleV0gIT09IG1vZGVsLmdldChrZXkpKSByZXR1cm4gZmFsc2U7CgkgICAgICAgIH0KCSAgICAgICAgcmV0dXJuIHRydWU7CgkgICAgICB9KTsKCSAgICB9LAoKCSAgICAvLyBSZXR1cm4gdGhlIGZpcnN0IG1vZGVsIHdpdGggbWF0Y2hpbmcgYXR0cmlidXRlcy4gVXNlZnVsIGZvciBzaW1wbGUgY2FzZXMKCSAgICAvLyBvZiBgZmluZGAuCgkgICAgZmluZFdoZXJlOiBmdW5jdGlvbihhdHRycykgewoJICAgICAgcmV0dXJuIHRoaXMud2hlcmUoYXR0cnMsIHRydWUpOwoJICAgIH0sCgoJICAgIC8vIEZvcmNlIHRoZSBjb2xsZWN0aW9uIHRvIHJlLXNvcnQgaXRzZWxmLiBZb3UgZG9uJ3QgbmVlZCB0byBjYWxsIHRoaXMgdW5kZXIKCSAgICAvLyBub3JtYWwgY2lyY3Vtc3RhbmNlcywgYXMgdGhlIHNldCB3aWxsIG1haW50YWluIHNvcnQgb3JkZXIgYXMgZWFjaCBpdGVtCgkgICAgLy8gaXMgYWRkZWQuCgkgICAgc29ydDogZnVuY3Rpb24ob3B0aW9ucykgewoJICAgICAgaWYgKCF0aGlzLmNvbXBhcmF0b3IpIHRocm93IG5ldyBFcnJvcignQ2Fubm90IHNvcnQgYSBzZXQgd2l0aG91dCBhIGNvbXBhcmF0b3InKTsKCSAgICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CgoJICAgICAgLy8gUnVuIHNvcnQgYmFzZWQgb24gdHlwZSBvZiBgY29tcGFyYXRvcmAuCgkgICAgICBpZiAoXy5pc1N0cmluZyh0aGlzLmNvbXBhcmF0b3IpIHx8IHRoaXMuY29tcGFyYXRvci5sZW5ndGggPT09IDEpIHsKCSAgICAgICAgdGhpcy5tb2RlbHMgPSB0aGlzLnNvcnRCeSh0aGlzLmNvbXBhcmF0b3IsIHRoaXMpOwoJICAgICAgfSBlbHNlIHsKCSAgICAgICAgdGhpcy5tb2RlbHMuc29ydChfLmJpbmQodGhpcy5jb21wYXJhdG9yLCB0aGlzKSk7CgkgICAgICB9CgoJICAgICAgaWYgKCFvcHRpb25zLnNpbGVudCkgdGhpcy50cmlnZ2VyKCdzb3J0JywgdGhpcywgb3B0aW9ucyk7CgkgICAgICByZXR1cm4gdGhpczsKCSAgICB9LAoKCSAgICAvLyBQbHVjayBhbiBhdHRyaWJ1dGUgZnJvbSBlYWNoIG1vZGVsIGluIHRoZSBjb2xsZWN0aW9uLgoJICAgIHBsdWNrOiBmdW5jdGlvbihhdHRyKSB7CgkgICAgICByZXR1cm4gXy5pbnZva2UodGhpcy5tb2RlbHMsICdnZXQnLCBhdHRyKTsKCSAgICB9LAoKCSAgICAvLyBGZXRjaCB0aGUgZGVmYXVsdCBzZXQgb2YgbW9kZWxzIGZvciB0aGlzIGNvbGxlY3Rpb24sIHJlc2V0dGluZyB0aGUKCSAgICAvLyBjb2xsZWN0aW9uIHdoZW4gdGhleSBhcnJpdmUuIElmIGByZXNldDogdHJ1ZWAgaXMgcGFzc2VkLCB0aGUgcmVzcG9uc2UKCSAgICAvLyBkYXRhIHdpbGwgYmUgcGFzc2VkIHRocm91Z2ggdGhlIGByZXNldGAgbWV0aG9kIGluc3RlYWQgb2YgYHNldGAuCgkgICAgZmV0Y2g6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKCSAgICAgIG9wdGlvbnMgPSBvcHRpb25zID8gXy5jbG9uZShvcHRpb25zKSA6IHt9OwoJICAgICAgaWYgKG9wdGlvbnMucGFyc2UgPT09IHZvaWQgMCkgb3B0aW9ucy5wYXJzZSA9IHRydWU7CgkgICAgICB2YXIgc3VjY2VzcyA9IG9wdGlvbnMuc3VjY2VzczsKCSAgICAgIHZhciBjb2xsZWN0aW9uID0gdGhpczsKCSAgICAgIG9wdGlvbnMuc3VjY2VzcyA9IGZ1bmN0aW9uKHJlc3ApIHsKCSAgICAgICAgdmFyIG1ldGhvZCA9IG9wdGlvbnMucmVzZXQgPyAncmVzZXQnIDogJ3NldCc7CgkgICAgICAgIGNvbGxlY3Rpb25bbWV0aG9kXShyZXNwLCBvcHRpb25zKTsKCSAgICAgICAgaWYgKHN1Y2Nlc3MpIHN1Y2Nlc3MoY29sbGVjdGlvbiwgcmVzcCwgb3B0aW9ucyk7CgkgICAgICAgIGNvbGxlY3Rpb24udHJpZ2dlcignc3luYycsIGNvbGxlY3Rpb24sIHJlc3AsIG9wdGlvbnMpOwoJICAgICAgfTsKCSAgICAgIHdyYXBFcnJvcih0aGlzLCBvcHRpb25zKTsKCSAgICAgIHJldHVybiB0aGlzLnN5bmMoJ3JlYWQnLCB0aGlzLCBvcHRpb25zKTsKCSAgICB9LAoKCSAgICAvLyBDcmVhdGUgYSBuZXcgaW5zdGFuY2Ugb2YgYSBtb2RlbCBpbiB0aGlzIGNvbGxlY3Rpb24uIEFkZCB0aGUgbW9kZWwgdG8gdGhlCgkgICAgLy8gY29sbGVjdGlvbiBpbW1lZGlhdGVseSwgdW5sZXNzIGB3YWl0OiB0cnVlYCBpcyBwYXNzZWQsIGluIHdoaWNoIGNhc2Ugd2UKCSAgICAvLyB3YWl0IGZvciB0aGUgc2VydmVyIHRvIGFncmVlLgoJICAgIGNyZWF0ZTogZnVuY3Rpb24obW9kZWwsIG9wdGlvbnMpIHsKCSAgICAgIG9wdGlvbnMgPSBvcHRpb25zID8gXy5jbG9uZShvcHRpb25zKSA6IHt9OwoJICAgICAgaWYgKCEobW9kZWwgPSB0aGlzLl9wcmVwYXJlTW9kZWwobW9kZWwsIG9wdGlvbnMpKSkgcmV0dXJuIGZhbHNlOwoJICAgICAgaWYgKCFvcHRpb25zLndhaXQpIHRoaXMuYWRkKG1vZGVsLCBvcHRpb25zKTsKCSAgICAgIHZhciBjb2xsZWN0aW9uID0gdGhpczsKCSAgICAgIHZhciBzdWNjZXNzID0gb3B0aW9ucy5zdWNjZXNzOwoJICAgICAgb3B0aW9ucy5zdWNjZXNzID0gZnVuY3Rpb24obW9kZWwsIHJlc3ApIHsKCSAgICAgICAgaWYgKG9wdGlvbnMud2FpdCkgY29sbGVjdGlvbi5hZGQobW9kZWwsIG9wdGlvbnMpOwoJICAgICAgICBpZiAoc3VjY2Vzcykgc3VjY2Vzcyhtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CgkgICAgICB9OwoJICAgICAgbW9kZWwuc2F2ZShudWxsLCBvcHRpb25zKTsKCSAgICAgIHJldHVybiBtb2RlbDsKCSAgICB9LAoKCSAgICAvLyAqKnBhcnNlKiogY29udmVydHMgYSByZXNwb25zZSBpbnRvIGEgbGlzdCBvZiBtb2RlbHMgdG8gYmUgYWRkZWQgdG8gdGhlCgkgICAgLy8gY29sbGVjdGlvbi4gVGhlIGRlZmF1bHQgaW1wbGVtZW50YXRpb24gaXMganVzdCB0byBwYXNzIGl0IHRocm91Z2guCgkgICAgcGFyc2U6IGZ1bmN0aW9uKHJlc3AsIG9wdGlvbnMpIHsKCSAgICAgIHJldHVybiByZXNwOwoJICAgIH0sCgoJICAgIC8vIENyZWF0ZSBhIG5ldyBjb2xsZWN0aW9uIHdpdGggYW4gaWRlbnRpY2FsIGxpc3Qgb2YgbW9kZWxzIGFzIHRoaXMgb25lLgoJICAgIGNsb25lOiBmdW5jdGlvbigpIHsKCSAgICAgIHJldHVybiBuZXcgdGhpcy5jb25zdHJ1Y3Rvcih0aGlzLm1vZGVscyk7CgkgICAgfSwKCgkgICAgLy8gUHJpdmF0ZSBtZXRob2QgdG8gcmVzZXQgYWxsIGludGVybmFsIHN0YXRlLiBDYWxsZWQgd2hlbiB0aGUgY29sbGVjdGlvbgoJICAgIC8vIGlzIGZpcnN0IGluaXRpYWxpemVkIG9yIHJlc2V0LgoJICAgIF9yZXNldDogZnVuY3Rpb24oKSB7CgkgICAgICB0aGlzLmxlbmd0aCA9IDA7CgkgICAgICB0aGlzLm1vZGVscyA9IFtdOwoJICAgICAgdGhpcy5fYnlJZCAgPSB7fTsKCSAgICB9LAoKCSAgICAvLyBQcmVwYXJlIGEgaGFzaCBvZiBhdHRyaWJ1dGVzIChvciBvdGhlciBtb2RlbCkgdG8gYmUgYWRkZWQgdG8gdGhpcwoJICAgIC8vIGNvbGxlY3Rpb24uCgkgICAgX3ByZXBhcmVNb2RlbDogZnVuY3Rpb24oYXR0cnMsIG9wdGlvbnMpIHsKCSAgICAgIGlmIChhdHRycyBpbnN0YW5jZW9mIE1vZGVsKSByZXR1cm4gYXR0cnM7CgkgICAgICBvcHRpb25zID0gb3B0aW9ucyA/IF8uY2xvbmUob3B0aW9ucykgOiB7fTsKCSAgICAgIG9wdGlvbnMuY29sbGVjdGlvbiA9IHRoaXM7CgkgICAgICB2YXIgbW9kZWwgPSBuZXcgdGhpcy5tb2RlbChhdHRycywgb3B0aW9ucyk7CgkgICAgICBpZiAoIW1vZGVsLnZhbGlkYXRpb25FcnJvcikgcmV0dXJuIG1vZGVsOwoJICAgICAgdGhpcy50cmlnZ2VyKCdpbnZhbGlkJywgdGhpcywgbW9kZWwudmFsaWRhdGlvbkVycm9yLCBvcHRpb25zKTsKCSAgICAgIHJldHVybiBmYWxzZTsKCSAgICB9LAoKCSAgICAvLyBJbnRlcm5hbCBtZXRob2QgdG8gY3JlYXRlIGEgbW9kZWwncyB0aWVzIHRvIGEgY29sbGVjdGlvbi4KCSAgICBfYWRkUmVmZXJlbmNlOiBmdW5jdGlvbihtb2RlbCwgb3B0aW9ucykgewoJICAgICAgdGhpcy5fYnlJZFttb2RlbC5jaWRdID0gbW9kZWw7CgkgICAgICBpZiAobW9kZWwuaWQgIT0gbnVsbCkgdGhpcy5fYnlJZFttb2RlbC5pZF0gPSBtb2RlbDsKCSAgICAgIGlmICghbW9kZWwuY29sbGVjdGlvbikgbW9kZWwuY29sbGVjdGlvbiA9IHRoaXM7CgkgICAgICBtb2RlbC5vbignYWxsJywgdGhpcy5fb25Nb2RlbEV2ZW50LCB0aGlzKTsKCSAgICB9LAoKCSAgICAvLyBJbnRlcm5hbCBtZXRob2QgdG8gc2V2ZXIgYSBtb2RlbCdzIHRpZXMgdG8gYSBjb2xsZWN0aW9uLgoJICAgIF9yZW1vdmVSZWZlcmVuY2U6IGZ1bmN0aW9uKG1vZGVsLCBvcHRpb25zKSB7CgkgICAgICBpZiAodGhpcyA9PT0gbW9kZWwuY29sbGVjdGlvbikgZGVsZXRlIG1vZGVsLmNvbGxlY3Rpb247CgkgICAgICBtb2RlbC5vZmYoJ2FsbCcsIHRoaXMuX29uTW9kZWxFdmVudCwgdGhpcyk7CgkgICAgfSwKCgkgICAgLy8gSW50ZXJuYWwgbWV0aG9kIGNhbGxlZCBldmVyeSB0aW1lIGEgbW9kZWwgaW4gdGhlIHNldCBmaXJlcyBhbiBldmVudC4KCSAgICAvLyBTZXRzIG5lZWQgdG8gdXBkYXRlIHRoZWlyIGluZGV4ZXMgd2hlbiBtb2RlbHMgY2hhbmdlIGlkcy4gQWxsIG90aGVyCgkgICAgLy8gZXZlbnRzIHNpbXBseSBwcm94eSB0aHJvdWdoLiAiYWRkIiBhbmQgInJlbW92ZSIgZXZlbnRzIHRoYXQgb3JpZ2luYXRlCgkgICAgLy8gaW4gb3RoZXIgY29sbGVjdGlvbnMgYXJlIGlnbm9yZWQuCgkgICAgX29uTW9kZWxFdmVudDogZnVuY3Rpb24oZXZlbnQsIG1vZGVsLCBjb2xsZWN0aW9uLCBvcHRpb25zKSB7CgkgICAgICBpZiAoKGV2ZW50ID09PSAnYWRkJyB8fCBldmVudCA9PT0gJ3JlbW92ZScpICYmIGNvbGxlY3Rpb24gIT09IHRoaXMpIHJldHVybjsKCSAgICAgIGlmIChldmVudCA9PT0gJ2Rlc3Ryb3knKSB0aGlzLnJlbW92ZShtb2RlbCwgb3B0aW9ucyk7CgkgICAgICBpZiAobW9kZWwgJiYgZXZlbnQgPT09ICdjaGFuZ2U6JyArIG1vZGVsLmlkQXR0cmlidXRlKSB7CgkgICAgICAgIGRlbGV0ZSB0aGlzLl9ieUlkW21vZGVsLnByZXZpb3VzKG1vZGVsLmlkQXR0cmlidXRlKV07CgkgICAgICAgIGlmIChtb2RlbC5pZCAhPSBudWxsKSB0aGlzLl9ieUlkW21vZGVsLmlkXSA9IG1vZGVsOwoJICAgICAgfQoJICAgICAgdGhpcy50cmlnZ2VyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CgkgICAgfQoKCSAgfSk7CgoJICAvLyBVbmRlcnNjb3JlIG1ldGhvZHMgdGhhdCB3ZSB3YW50IHRvIGltcGxlbWVudCBvbiB0aGUgQ29sbGVjdGlvbi4KCSAgLy8gOTAlIG9mIHRoZSBjb3JlIHVzZWZ1bG5lc3Mgb2YgQmFja2JvbmUgQ29sbGVjdGlvbnMgaXMgYWN0dWFsbHkgaW1wbGVtZW50ZWQKCSAgLy8gcmlnaHQgaGVyZToKCSAgdmFyIG1ldGhvZHMgPSBbJ2ZvckVhY2gnLCAnZWFjaCcsICdtYXAnLCAnY29sbGVjdCcsICdyZWR1Y2UnLCAnZm9sZGwnLAoJICAgICdpbmplY3QnLCAncmVkdWNlUmlnaHQnLCAnZm9sZHInLCAnZmluZCcsICdkZXRlY3QnLCAnZmlsdGVyJywgJ3NlbGVjdCcsCgkgICAgJ3JlamVjdCcsICdldmVyeScsICdhbGwnLCAnc29tZScsICdhbnknLCAnaW5jbHVkZScsICdjb250YWlucycsICdpbnZva2UnLAoJICAgICdtYXgnLCAnbWluJywgJ3RvQXJyYXknLCAnc2l6ZScsICdmaXJzdCcsICdoZWFkJywgJ3Rha2UnLCAnaW5pdGlhbCcsICdyZXN0JywKCSAgICAndGFpbCcsICdkcm9wJywgJ2xhc3QnLCAnd2l0aG91dCcsICdkaWZmZXJlbmNlJywgJ2luZGV4T2YnLCAnc2h1ZmZsZScsCgkgICAgJ2xhc3RJbmRleE9mJywgJ2lzRW1wdHknLCAnY2hhaW4nLCAnc2FtcGxlJ107CgoJICAvLyBNaXggaW4gZWFjaCBVbmRlcnNjb3JlIG1ldGhvZCBhcyBhIHByb3h5IHRvIGBDb2xsZWN0aW9uI21vZGVsc2AuCgkgIF8uZWFjaChtZXRob2RzLCBmdW5jdGlvbihtZXRob2QpIHsKCSAgICBDb2xsZWN0aW9uLnByb3RvdHlwZVttZXRob2RdID0gZnVuY3Rpb24oKSB7CgkgICAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzKTsKCSAgICAgIGFyZ3MudW5zaGlmdCh0aGlzLm1vZGVscyk7CgkgICAgICByZXR1cm4gX1ttZXRob2RdLmFwcGx5KF8sIGFyZ3MpOwoJICAgIH07CgkgIH0pOwoKCSAgLy8gVW5kZXJzY29yZSBtZXRob2RzIHRoYXQgdGFrZSBhIHByb3BlcnR5IG5hbWUgYXMgYW4gYXJndW1lbnQuCgkgIHZhciBhdHRyaWJ1dGVNZXRob2RzID0gWydncm91cEJ5JywgJ2NvdW50QnknLCAnc29ydEJ5JywgJ2luZGV4QnknXTsKCgkgIC8vIFVzZSBhdHRyaWJ1dGVzIGluc3RlYWQgb2YgcHJvcGVydGllcy4KCSAgXy5lYWNoKGF0dHJpYnV0ZU1ldGhvZHMsIGZ1bmN0aW9uKG1ldGhvZCkgewoJICAgIENvbGxlY3Rpb24ucHJvdG90eXBlW21ldGhvZF0gPSBmdW5jdGlvbih2YWx1ZSwgY29udGV4dCkgewoJICAgICAgdmFyIGl0ZXJhdG9yID0gXy5pc0Z1bmN0aW9uKHZhbHVlKSA/IHZhbHVlIDogZnVuY3Rpb24obW9kZWwpIHsKCSAgICAgICAgcmV0dXJuIG1vZGVsLmdldCh2YWx1ZSk7CgkgICAgICB9OwoJICAgICAgcmV0dXJuIF9bbWV0aG9kXSh0aGlzLm1vZGVscywgaXRlcmF0b3IsIGNvbnRleHQpOwoJICAgIH07CgkgIH0pOwoKCSAgLy8gQmFja2JvbmUuVmlldwoJICAvLyAtLS0tLS0tLS0tLS0tCgoJICAvLyBCYWNrYm9uZSBWaWV3cyBhcmUgYWxtb3N0IG1vcmUgY29udmVudGlvbiB0aGFuIHRoZXkgYXJlIGFjdHVhbCBjb2RlLiBBIFZpZXcKCSAgLy8gaXMgc2ltcGx5IGEgSmF2YVNjcmlwdCBvYmplY3QgdGhhdCByZXByZXNlbnRzIGEgbG9naWNhbCBjaHVuayBvZiBVSSBpbiB0aGUKCSAgLy8gRE9NLiBUaGlzIG1pZ2h0IGJlIGEgc2luZ2xlIGl0ZW0sIGFuIGVudGlyZSBsaXN0LCBhIHNpZGViYXIgb3IgcGFuZWwsIG9yCgkgIC8vIGV2ZW4gdGhlIHN1cnJvdW5kaW5nIGZyYW1lIHdoaWNoIHdyYXBzIHlvdXIgd2hvbGUgYXBwLiBEZWZpbmluZyBhIGNodW5rIG9mCgkgIC8vIFVJIGFzIGEgKipWaWV3KiogYWxsb3dzIHlvdSB0byBkZWZpbmUgeW91ciBET00gZXZlbnRzIGRlY2xhcmF0aXZlbHksIHdpdGhvdXQKCSAgLy8gaGF2aW5nIHRvIHdvcnJ5IGFib3V0IHJlbmRlciBvcmRlciAuLi4gYW5kIG1ha2VzIGl0IGVhc3kgZm9yIHRoZSB2aWV3IHRvCgkgIC8vIHJlYWN0IHRvIHNwZWNpZmljIGNoYW5nZXMgaW4gdGhlIHN0YXRlIG9mIHlvdXIgbW9kZWxzLgoKCSAgLy8gQ3JlYXRpbmcgYSBCYWNrYm9uZS5WaWV3IGNyZWF0ZXMgaXRzIGluaXRpYWwgZWxlbWVudCBvdXRzaWRlIG9mIHRoZSBET00sCgkgIC8vIGlmIGFuIGV4aXN0aW5nIGVsZW1lbnQgaXMgbm90IHByb3ZpZGVkLi4uCgkgIHZhciBWaWV3ID0gQmFja2JvbmUuVmlldyA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKCSAgICB0aGlzLmNpZCA9IF8udW5pcXVlSWQoJ3ZpZXcnKTsKCSAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwoJICAgIF8uZXh0ZW5kKHRoaXMsIF8ucGljayhvcHRpb25zLCB2aWV3T3B0aW9ucykpOwoJICAgIHRoaXMuX2Vuc3VyZUVsZW1lbnQoKTsKCSAgICB0aGlzLmluaXRpYWxpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCSAgICB0aGlzLmRlbGVnYXRlRXZlbnRzKCk7CgkgIH07CgoJICAvLyBDYWNoZWQgcmVnZXggdG8gc3BsaXQga2V5cyBmb3IgYGRlbGVnYXRlYC4KCSAgdmFyIGRlbGVnYXRlRXZlbnRTcGxpdHRlciA9IC9eKFxTKylccyooLiopJC87CgoJICAvLyBMaXN0IG9mIHZpZXcgb3B0aW9ucyB0byBiZSBtZXJnZWQgYXMgcHJvcGVydGllcy4KCSAgdmFyIHZpZXdPcHRpb25zID0gWydtb2RlbCcsICdjb2xsZWN0aW9uJywgJ2VsJywgJ2lkJywgJ2F0dHJpYnV0ZXMnLCAnY2xhc3NOYW1lJywgJ3RhZ05hbWUnLCAnZXZlbnRzJ107CgoJICAvLyBTZXQgdXAgYWxsIGluaGVyaXRhYmxlICoqQmFja2JvbmUuVmlldyoqIHByb3BlcnRpZXMgYW5kIG1ldGhvZHMuCgkgIF8uZXh0ZW5kKFZpZXcucHJvdG90eXBlLCBFdmVudHMsIHsKCgkgICAgLy8gVGhlIGRlZmF1bHQgYHRhZ05hbWVgIG9mIGEgVmlldydzIGVsZW1lbnQgaXMgYCJkaXYiYC4KCSAgICB0YWdOYW1lOiAnZGl2JywKCgkgICAgLy8galF1ZXJ5IGRlbGVnYXRlIGZvciBlbGVtZW50IGxvb2t1cCwgc2NvcGVkIHRvIERPTSBlbGVtZW50cyB3aXRoaW4gdGhlCgkgICAgLy8gY3VycmVudCB2aWV3LiBUaGlzIHNob3VsZCBiZSBwcmVmZXJyZWQgdG8gZ2xvYmFsIGxvb2t1cHMgd2hlcmUgcG9zc2libGUuCgkgICAgJDogZnVuY3Rpb24oc2VsZWN0b3IpIHsKCSAgICAgIHJldHVybiB0aGlzLiRlbC5maW5kKHNlbGVjdG9yKTsKCSAgICB9LAoKCSAgICAvLyBJbml0aWFsaXplIGlzIGFuIGVtcHR5IGZ1bmN0aW9uIGJ5IGRlZmF1bHQuIE92ZXJyaWRlIGl0IHdpdGggeW91ciBvd24KCSAgICAvLyBpbml0aWFsaXphdGlvbiBsb2dpYy4KCSAgICBpbml0aWFsaXplOiBmdW5jdGlvbigpe30sCgoJICAgIC8vICoqcmVuZGVyKiogaXMgdGhlIGNvcmUgZnVuY3Rpb24gdGhhdCB5b3VyIHZpZXcgc2hvdWxkIG92ZXJyaWRlLCBpbiBvcmRlcgoJICAgIC8vIHRvIHBvcHVsYXRlIGl0cyBlbGVtZW50IChgdGhpcy5lbGApLCB3aXRoIHRoZSBhcHByb3ByaWF0ZSBIVE1MLiBUaGUKCSAgICAvLyBjb252ZW50aW9uIGlzIGZvciAqKnJlbmRlcioqIHRvIGFsd2F5cyByZXR1cm4gYHRoaXNgLgoJICAgIHJlbmRlcjogZnVuY3Rpb24oKSB7CgkgICAgICByZXR1cm4gdGhpczsKCSAgICB9LAoKCSAgICAvLyBSZW1vdmUgdGhpcyB2aWV3IGJ5IHRha2luZyB0aGUgZWxlbWVudCBvdXQgb2YgdGhlIERPTSwgYW5kIHJlbW92aW5nIGFueQoJICAgIC8vIGFwcGxpY2FibGUgQmFja2JvbmUuRXZlbnRzIGxpc3RlbmVycy4KCSAgICByZW1vdmU6IGZ1bmN0aW9uKCkgewoJICAgICAgdGhpcy4kZWwucmVtb3ZlKCk7CgkgICAgICB0aGlzLnN0b3BMaXN0ZW5pbmcoKTsKCSAgICAgIHJldHVybiB0aGlzOwoJICAgIH0sCgoJICAgIC8vIENoYW5nZSB0aGUgdmlldydzIGVsZW1lbnQgKGB0aGlzLmVsYCBwcm9wZXJ0eSksIGluY2x1ZGluZyBldmVudAoJICAgIC8vIHJlLWRlbGVnYXRpb24uCgkgICAgc2V0RWxlbWVudDogZnVuY3Rpb24oZWxlbWVudCwgZGVsZWdhdGUpIHsKCSAgICAgIGlmICh0aGlzLiRlbCkgdGhpcy51bmRlbGVnYXRlRXZlbnRzKCk7CgkgICAgICB0aGlzLiRlbCA9IGVsZW1lbnQgaW5zdGFuY2VvZiBCYWNrYm9uZS4kID8gZWxlbWVudCA6IEJhY2tib25lLiQoZWxlbWVudCk7CgkgICAgICB0aGlzLmVsID0gdGhpcy4kZWxbMF07CgkgICAgICBpZiAoZGVsZWdhdGUgIT09IGZhbHNlKSB0aGlzLmRlbGVnYXRlRXZlbnRzKCk7CgkgICAgICByZXR1cm4gdGhpczsKCSAgICB9LAoKCSAgICAvLyBTZXQgY2FsbGJhY2tzLCB3aGVyZSBgdGhpcy5ldmVudHNgIGlzIGEgaGFzaCBvZgoJICAgIC8vCgkgICAgLy8gKnsiZXZlbnQgc2VsZWN0b3IiOiAiY2FsbGJhY2sifSoKCSAgICAvLwoJICAgIC8vICAgICB7CgkgICAgLy8gICAgICAgJ21vdXNlZG93biAudGl0bGUnOiAgJ2VkaXQnLAoJICAgIC8vICAgICAgICdjbGljayAuYnV0dG9uJzogICAgICdzYXZlJywKCSAgICAvLyAgICAgICAnY2xpY2sgLm9wZW4nOiAgICAgICBmdW5jdGlvbihlKSB7IC4uLiB9CgkgICAgLy8gICAgIH0KCSAgICAvLwoJICAgIC8vIHBhaXJzLiBDYWxsYmFja3Mgd2lsbCBiZSBib3VuZCB0byB0aGUgdmlldywgd2l0aCBgdGhpc2Agc2V0IHByb3Blcmx5LgoJICAgIC8vIFVzZXMgZXZlbnQgZGVsZWdhdGlvbiBmb3IgZWZmaWNpZW5jeS4KCSAgICAvLyBPbWl0dGluZyB0aGUgc2VsZWN0b3IgYmluZHMgdGhlIGV2ZW50IHRvIGB0aGlzLmVsYC4KCSAgICAvLyBUaGlzIG9ubHkgd29ya3MgZm9yIGRlbGVnYXRlLWFibGUgZXZlbnRzOiBub3QgYGZvY3VzYCwgYGJsdXJgLCBhbmQKCSAgICAvLyBub3QgYGNoYW5nZWAsIGBzdWJtaXRgLCBhbmQgYHJlc2V0YCBpbiBJbnRlcm5ldCBFeHBsb3Jlci4KCSAgICBkZWxlZ2F0ZUV2ZW50czogZnVuY3Rpb24oZXZlbnRzKSB7CgkgICAgICBpZiAoIShldmVudHMgfHwgKGV2ZW50cyA9IF8ucmVzdWx0KHRoaXMsICdldmVudHMnKSkpKSByZXR1cm4gdGhpczsKCSAgICAgIHRoaXMudW5kZWxlZ2F0ZUV2ZW50cygpOwoJICAgICAgZm9yICh2YXIga2V5IGluIGV2ZW50cykgewoJICAgICAgICB2YXIgbWV0aG9kID0gZXZlbnRzW2tleV07CgkgICAgICAgIGlmICghXy5pc0Z1bmN0aW9uKG1ldGhvZCkpIG1ldGhvZCA9IHRoaXNbZXZlbnRzW2tleV1dOwoJICAgICAgICBpZiAoIW1ldGhvZCkgY29udGludWU7CgoJICAgICAgICB2YXIgbWF0Y2ggPSBrZXkubWF0Y2goZGVsZWdhdGVFdmVudFNwbGl0dGVyKTsKCSAgICAgICAgdmFyIGV2ZW50TmFtZSA9IG1hdGNoWzFdLCBzZWxlY3RvciA9IG1hdGNoWzJdOwoJICAgICAgICBtZXRob2QgPSBfLmJpbmQobWV0aG9kLCB0aGlzKTsKCSAgICAgICAgZXZlbnROYW1lICs9ICcuZGVsZWdhdGVFdmVudHMnICsgdGhpcy5jaWQ7CgkgICAgICAgIGlmIChzZWxlY3RvciA9PT0gJycpIHsKCSAgICAgICAgICB0aGlzLiRlbC5vbihldmVudE5hbWUsIG1ldGhvZCk7CgkgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgdGhpcy4kZWwub24oZXZlbnROYW1lLCBzZWxlY3RvciwgbWV0aG9kKTsKCSAgICAgICAgfQoJICAgICAgfQoJICAgICAgcmV0dXJuIHRoaXM7CgkgICAgfSwKCgkgICAgLy8gQ2xlYXJzIGFsbCBjYWxsYmFja3MgcHJldmlvdXNseSBib3VuZCB0byB0aGUgdmlldyB3aXRoIGBkZWxlZ2F0ZUV2ZW50c2AuCgkgICAgLy8gWW91IHVzdWFsbHkgZG9uJ3QgbmVlZCB0byB1c2UgdGhpcywgYnV0IG1heSB3aXNoIHRvIGlmIHlvdSBoYXZlIG11bHRpcGxlCgkgICAgLy8gQmFja2JvbmUgdmlld3MgYXR0YWNoZWQgdG8gdGhlIHNhbWUgRE9NIGVsZW1lbnQuCgkgICAgdW5kZWxlZ2F0ZUV2ZW50czogZnVuY3Rpb24oKSB7CgkgICAgICB0aGlzLiRlbC5vZmYoJy5kZWxlZ2F0ZUV2ZW50cycgKyB0aGlzLmNpZCk7CgkgICAgICByZXR1cm4gdGhpczsKCSAgICB9LAoKCSAgICAvLyBFbnN1cmUgdGhhdCB0aGUgVmlldyBoYXMgYSBET00gZWxlbWVudCB0byByZW5kZXIgaW50by4KCSAgICAvLyBJZiBgdGhpcy5lbGAgaXMgYSBzdHJpbmcsIHBhc3MgaXQgdGhyb3VnaCBgJCgpYCwgdGFrZSB0aGUgZmlyc3QKCSAgICAvLyBtYXRjaGluZyBlbGVtZW50LCBhbmQgcmUtYXNzaWduIGl0IHRvIGBlbGAuIE90aGVyd2lzZSwgY3JlYXRlCgkgICAgLy8gYW4gZWxlbWVudCBmcm9tIHRoZSBgaWRgLCBgY2xhc3NOYW1lYCBhbmQgYHRhZ05hbWVgIHByb3BlcnRpZXMuCgkgICAgX2Vuc3VyZUVsZW1lbnQ6IGZ1bmN0aW9uKCkgewoJICAgICAgaWYgKCF0aGlzLmVsKSB7CgkgICAgICAgIHZhciBhdHRycyA9IF8uZXh0ZW5kKHt9LCBfLnJlc3VsdCh0aGlzLCAnYXR0cmlidXRlcycpKTsKCSAgICAgICAgaWYgKHRoaXMuaWQpIGF0dHJzLmlkID0gXy5yZXN1bHQodGhpcywgJ2lkJyk7CgkgICAgICAgIGlmICh0aGlzLmNsYXNzTmFtZSkgYXR0cnNbJ2NsYXNzJ10gPSBfLnJlc3VsdCh0aGlzLCAnY2xhc3NOYW1lJyk7CgkgICAgICAgIHZhciAkZWwgPSBCYWNrYm9uZS4kKCc8JyArIF8ucmVzdWx0KHRoaXMsICd0YWdOYW1lJykgKyAnPicpLmF0dHIoYXR0cnMpOwoJICAgICAgICB0aGlzLnNldEVsZW1lbnQoJGVsLCBmYWxzZSk7CgkgICAgICB9IGVsc2UgewoJICAgICAgICB0aGlzLnNldEVsZW1lbnQoXy5yZXN1bHQodGhpcywgJ2VsJyksIGZhbHNlKTsKCSAgICAgIH0KCSAgICB9CgoJICB9KTsKCgkgIC8vIEJhY2tib25lLnN5bmMKCSAgLy8gLS0tLS0tLS0tLS0tLQoKCSAgLy8gT3ZlcnJpZGUgdGhpcyBmdW5jdGlvbiB0byBjaGFuZ2UgdGhlIG1hbm5lciBpbiB3aGljaCBCYWNrYm9uZSBwZXJzaXN0cwoJICAvLyBtb2RlbHMgdG8gdGhlIHNlcnZlci4gWW91IHdpbGwgYmUgcGFzc2VkIHRoZSB0eXBlIG9mIHJlcXVlc3QsIGFuZCB0aGUKCSAgLy8gbW9kZWwgaW4gcXVlc3Rpb24uIEJ5IGRlZmF1bHQsIG1ha2VzIGEgUkVTVGZ1bCBBamF4IHJlcXVlc3QKCSAgLy8gdG8gdGhlIG1vZGVsJ3MgYHVybCgpYC4gU29tZSBwb3NzaWJsZSBjdXN0b21pemF0aW9ucyBjb3VsZCBiZToKCSAgLy8KCSAgLy8gKiBVc2UgYHNldFRpbWVvdXRgIHRvIGJhdGNoIHJhcGlkLWZpcmUgdXBkYXRlcyBpbnRvIGEgc2luZ2xlIHJlcXVlc3QuCgkgIC8vICogU2VuZCB1cCB0aGUgbW9kZWxzIGFzIFhNTCBpbnN0ZWFkIG9mIEpTT04uCgkgIC8vICogUGVyc2lzdCBtb2RlbHMgdmlhIFdlYlNvY2tldHMgaW5zdGVhZCBvZiBBamF4LgoJICAvLwoJICAvLyBUdXJuIG9uIGBCYWNrYm9uZS5lbXVsYXRlSFRUUGAgaW4gb3JkZXIgdG8gc2VuZCBgUFVUYCBhbmQgYERFTEVURWAgcmVxdWVzdHMKCSAgLy8gYXMgYFBPU1RgLCB3aXRoIGEgYF9tZXRob2RgIHBhcmFtZXRlciBjb250YWluaW5nIHRoZSB0cnVlIEhUVFAgbWV0aG9kLAoJICAvLyBhcyB3ZWxsIGFzIGFsbCByZXF1ZXN0cyB3aXRoIHRoZSBib2R5IGFzIGBhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWRgCgkgIC8vIGluc3RlYWQgb2YgYGFwcGxpY2F0aW9uL2pzb25gIHdpdGggdGhlIG1vZGVsIGluIGEgcGFyYW0gbmFtZWQgYG1vZGVsYC4KCSAgLy8gVXNlZnVsIHdoZW4gaW50ZXJmYWNpbmcgd2l0aCBzZXJ2ZXItc2lkZSBsYW5ndWFnZXMgbGlrZSAqKlBIUCoqIHRoYXQgbWFrZQoJICAvLyBpdCBkaWZmaWN1bHQgdG8gcmVhZCB0aGUgYm9keSBvZiBgUFVUYCByZXF1ZXN0cy4KCSAgQmFja2JvbmUuc3luYyA9IGZ1bmN0aW9uKG1ldGhvZCwgbW9kZWwsIG9wdGlvbnMpIHsKCSAgICB2YXIgdHlwZSA9IG1ldGhvZE1hcFttZXRob2RdOwoKCSAgICAvLyBEZWZhdWx0IG9wdGlvbnMsIHVubGVzcyBzcGVjaWZpZWQuCgkgICAgXy5kZWZhdWx0cyhvcHRpb25zIHx8IChvcHRpb25zID0ge30pLCB7CgkgICAgICBlbXVsYXRlSFRUUDogQmFja2JvbmUuZW11bGF0ZUhUVFAsCgkgICAgICBlbXVsYXRlSlNPTjogQmFja2JvbmUuZW11bGF0ZUpTT04KCSAgICB9KTsKCgkgICAgLy8gRGVmYXVsdCBKU09OLXJlcXVlc3Qgb3B0aW9ucy4KCSAgICB2YXIgcGFyYW1zID0ge3R5cGU6IHR5cGUsIGRhdGFUeXBlOiAnanNvbid9OwoKCSAgICAvLyBFbnN1cmUgdGhhdCB3ZSBoYXZlIGEgVVJMLgoJICAgIGlmICghb3B0aW9ucy51cmwpIHsKCSAgICAgIHBhcmFtcy51cmwgPSBfLnJlc3VsdChtb2RlbCwgJ3VybCcpIHx8IHVybEVycm9yKCk7CgkgICAgfQoKCSAgICAvLyBFbnN1cmUgdGhhdCB3ZSBoYXZlIHRoZSBhcHByb3ByaWF0ZSByZXF1ZXN0IGRhdGEuCgkgICAgaWYgKG9wdGlvbnMuZGF0YSA9PSBudWxsICYmIG1vZGVsICYmIChtZXRob2QgPT09ICdjcmVhdGUnIHx8IG1ldGhvZCA9PT0gJ3VwZGF0ZScgfHwgbWV0aG9kID09PSAncGF0Y2gnKSkgewoJICAgICAgcGFyYW1zLmNvbnRlbnRUeXBlID0gJ2FwcGxpY2F0aW9uL2pzb24nOwoJICAgICAgcGFyYW1zLmRhdGEgPSBKU09OLnN0cmluZ2lmeShvcHRpb25zLmF0dHJzIHx8IG1vZGVsLnRvSlNPTihvcHRpb25zKSk7CgkgICAgfQoKCSAgICAvLyBGb3Igb2xkZXIgc2VydmVycywgZW11bGF0ZSBKU09OIGJ5IGVuY29kaW5nIHRoZSByZXF1ZXN0IGludG8gYW4gSFRNTC1mb3JtLgoJICAgIGlmIChvcHRpb25zLmVtdWxhdGVKU09OKSB7CgkgICAgICBwYXJhbXMuY29udGVudFR5cGUgPSAnYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkJzsKCSAgICAgIHBhcmFtcy5kYXRhID0gcGFyYW1zLmRhdGEgPyB7bW9kZWw6IHBhcmFtcy5kYXRhfSA6IHt9OwoJICAgIH0KCgkgICAgLy8gRm9yIG9sZGVyIHNlcnZlcnMsIGVtdWxhdGUgSFRUUCBieSBtaW1pY2tpbmcgdGhlIEhUVFAgbWV0aG9kIHdpdGggYF9tZXRob2RgCgkgICAgLy8gQW5kIGFuIGBYLUhUVFAtTWV0aG9kLU92ZXJyaWRlYCBoZWFkZXIuCgkgICAgaWYgKG9wdGlvbnMuZW11bGF0ZUhUVFAgJiYgKHR5cGUgPT09ICdQVVQnIHx8IHR5cGUgPT09ICdERUxFVEUnIHx8IHR5cGUgPT09ICdQQVRDSCcpKSB7CgkgICAgICBwYXJhbXMudHlwZSA9ICdQT1NUJzsKCSAgICAgIGlmIChvcHRpb25zLmVtdWxhdGVKU09OKSBwYXJhbXMuZGF0YS5fbWV0aG9kID0gdHlwZTsKCSAgICAgIHZhciBiZWZvcmVTZW5kID0gb3B0aW9ucy5iZWZvcmVTZW5kOwoJICAgICAgb3B0aW9ucy5iZWZvcmVTZW5kID0gZnVuY3Rpb24oeGhyKSB7CgkgICAgICAgIHhoci5zZXRSZXF1ZXN0SGVhZGVyKCdYLUhUVFAtTWV0aG9kLU92ZXJyaWRlJywgdHlwZSk7CgkgICAgICAgIGlmIChiZWZvcmVTZW5kKSByZXR1cm4gYmVmb3JlU2VuZC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoJICAgICAgfTsKCSAgICB9CgoJICAgIC8vIERvbid0IHByb2Nlc3MgZGF0YSBvbiBhIG5vbi1HRVQgcmVxdWVzdC4KCSAgICBpZiAocGFyYW1zLnR5cGUgIT09ICdHRVQnICYmICFvcHRpb25zLmVtdWxhdGVKU09OKSB7CgkgICAgICBwYXJhbXMucHJvY2Vzc0RhdGEgPSBmYWxzZTsKCSAgICB9CgoJICAgIC8vIElmIHdlJ3JlIHNlbmRpbmcgYSBgUEFUQ0hgIHJlcXVlc3QsIGFuZCB3ZSdyZSBpbiBhbiBvbGQgSW50ZXJuZXQgRXhwbG9yZXIKCSAgICAvLyB0aGF0IHN0aWxsIGhhcyBBY3RpdmVYIGVuYWJsZWQgYnkgZGVmYXVsdCwgb3ZlcnJpZGUgalF1ZXJ5IHRvIHVzZSB0aGF0CgkgICAgLy8gZm9yIFhIUiBpbnN0ZWFkLiBSZW1vdmUgdGhpcyBsaW5lIHdoZW4galF1ZXJ5IHN1cHBvcnRzIGBQQVRDSGAgb24gSUU4LgoJICAgIGlmIChwYXJhbXMudHlwZSA9PT0gJ1BBVENIJyAmJiBub1hoclBhdGNoKSB7CgkgICAgICBwYXJhbXMueGhyID0gZnVuY3Rpb24oKSB7CgkgICAgICAgIHJldHVybiBuZXcgQWN0aXZlWE9iamVjdCgiTWljcm9zb2Z0LlhNTEhUVFAiKTsKCSAgICAgIH07CgkgICAgfQoKCSAgICAvLyBNYWtlIHRoZSByZXF1ZXN0LCBhbGxvd2luZyB0aGUgdXNlciB0byBvdmVycmlkZSBhbnkgQWpheCBvcHRpb25zLgoJICAgIHZhciB4aHIgPSBvcHRpb25zLnhociA9IEJhY2tib25lLmFqYXgoXy5leHRlbmQocGFyYW1zLCBvcHRpb25zKSk7CgkgICAgbW9kZWwudHJpZ2dlcigncmVxdWVzdCcsIG1vZGVsLCB4aHIsIG9wdGlvbnMpOwoJICAgIHJldHVybiB4aHI7CgkgIH07CgoJICB2YXIgbm9YaHJQYXRjaCA9CgkgICAgdHlwZW9mIHdpbmRvdyAhPT0gJ3VuZGVmaW5lZCcgJiYgISF3aW5kb3cuQWN0aXZlWE9iamVjdCAmJgoJICAgICAgISh3aW5kb3cuWE1MSHR0cFJlcXVlc3QgJiYgKG5ldyBYTUxIdHRwUmVxdWVzdCkuZGlzcGF0Y2hFdmVudCk7CgoJICAvLyBNYXAgZnJvbSBDUlVEIHRvIEhUVFAgZm9yIG91ciBkZWZhdWx0IGBCYWNrYm9uZS5zeW5jYCBpbXBsZW1lbnRhdGlvbi4KCSAgdmFyIG1ldGhvZE1hcCA9IHsKCSAgICAnY3JlYXRlJzogJ1BPU1QnLAoJICAgICd1cGRhdGUnOiAnUFVUJywKCSAgICAncGF0Y2gnOiAgJ1BBVENIJywKCSAgICAnZGVsZXRlJzogJ0RFTEVURScsCgkgICAgJ3JlYWQnOiAgICdHRVQnCgkgIH07CgoJICAvLyBTZXQgdGhlIGRlZmF1bHQgaW1wbGVtZW50YXRpb24gb2YgYEJhY2tib25lLmFqYXhgIHRvIHByb3h5IHRocm91Z2ggdG8gYCRgLgoJICAvLyBPdmVycmlkZSB0aGlzIGlmIHlvdSdkIGxpa2UgdG8gdXNlIGEgZGlmZmVyZW50IGxpYnJhcnkuCgkgIEJhY2tib25lLmFqYXggPSBmdW5jdGlvbigpIHsKCSAgICByZXR1cm4gQmFja2JvbmUuJC5hamF4LmFwcGx5KEJhY2tib25lLiQsIGFyZ3VtZW50cyk7CgkgIH07CgoJICAvLyBCYWNrYm9uZS5Sb3V0ZXIKCSAgLy8gLS0tLS0tLS0tLS0tLS0tCgoJICAvLyBSb3V0ZXJzIG1hcCBmYXV4LVVSTHMgdG8gYWN0aW9ucywgYW5kIGZpcmUgZXZlbnRzIHdoZW4gcm91dGVzIGFyZQoJICAvLyBtYXRjaGVkLiBDcmVhdGluZyBhIG5ldyBvbmUgc2V0cyBpdHMgYHJvdXRlc2AgaGFzaCwgaWYgbm90IHNldCBzdGF0aWNhbGx5LgoJICB2YXIgUm91dGVyID0gQmFja2JvbmUuUm91dGVyID0gZnVuY3Rpb24ob3B0aW9ucykgewoJICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CgkgICAgaWYgKG9wdGlvbnMucm91dGVzKSB0aGlzLnJvdXRlcyA9IG9wdGlvbnMucm91dGVzOwoJICAgIHRoaXMuX2JpbmRSb3V0ZXMoKTsKCSAgICB0aGlzLmluaXRpYWxpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCSAgfTsKCgkgIC8vIENhY2hlZCByZWd1bGFyIGV4cHJlc3Npb25zIGZvciBtYXRjaGluZyBuYW1lZCBwYXJhbSBwYXJ0cyBhbmQgc3BsYXR0ZWQKCSAgLy8gcGFydHMgb2Ygcm91dGUgc3RyaW5ncy4KCSAgdmFyIG9wdGlvbmFsUGFyYW0gPSAvXCgoLio/KVwpL2c7CgkgIHZhciBuYW1lZFBhcmFtICAgID0gLyhcKFw/KT86XHcrL2c7CgkgIHZhciBzcGxhdFBhcmFtICAgID0gL1wqXHcrL2c7CgkgIHZhciBlc2NhcGVSZWdFeHAgID0gL1tcLXt9XFtcXSs/LixcXFxeJHwjXHNdL2c7CgoJICAvLyBTZXQgdXAgYWxsIGluaGVyaXRhYmxlICoqQmFja2JvbmUuUm91dGVyKiogcHJvcGVydGllcyBhbmQgbWV0aG9kcy4KCSAgXy5leHRlbmQoUm91dGVyLnByb3RvdHlwZSwgRXZlbnRzLCB7CgoJICAgIC8vIEluaXRpYWxpemUgaXMgYW4gZW1wdHkgZnVuY3Rpb24gYnkgZGVmYXVsdC4gT3ZlcnJpZGUgaXQgd2l0aCB5b3VyIG93bgoJICAgIC8vIGluaXRpYWxpemF0aW9uIGxvZ2ljLgoJICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uKCl7fSwKCgkgICAgLy8gTWFudWFsbHkgYmluZCBhIHNpbmdsZSBuYW1lZCByb3V0ZSB0byBhIGNhbGxiYWNrLiBGb3IgZXhhbXBsZToKCSAgICAvLwoJICAgIC8vICAgICB0aGlzLnJvdXRlKCdzZWFyY2gvOnF1ZXJ5L3A6bnVtJywgJ3NlYXJjaCcsIGZ1bmN0aW9uKHF1ZXJ5LCBudW0pIHsKCSAgICAvLyAgICAgICAuLi4KCSAgICAvLyAgICAgfSk7CgkgICAgLy8KCSAgICByb3V0ZTogZnVuY3Rpb24ocm91dGUsIG5hbWUsIGNhbGxiYWNrKSB7CgkgICAgICBpZiAoIV8uaXNSZWdFeHAocm91dGUpKSByb3V0ZSA9IHRoaXMuX3JvdXRlVG9SZWdFeHAocm91dGUpOwoJICAgICAgaWYgKF8uaXNGdW5jdGlvbihuYW1lKSkgewoJICAgICAgICBjYWxsYmFjayA9IG5hbWU7CgkgICAgICAgIG5hbWUgPSAnJzsKCSAgICAgIH0KCSAgICAgIGlmICghY2FsbGJhY2spIGNhbGxiYWNrID0gdGhpc1tuYW1lXTsKCSAgICAgIHZhciByb3V0ZXIgPSB0aGlzOwoJICAgICAgQmFja2JvbmUuaGlzdG9yeS5yb3V0ZShyb3V0ZSwgZnVuY3Rpb24oZnJhZ21lbnQpIHsKCSAgICAgICAgdmFyIGFyZ3MgPSByb3V0ZXIuX2V4dHJhY3RQYXJhbWV0ZXJzKHJvdXRlLCBmcmFnbWVudCk7CgkgICAgICAgIHJvdXRlci5leGVjdXRlKGNhbGxiYWNrLCBhcmdzKTsKCSAgICAgICAgcm91dGVyLnRyaWdnZXIuYXBwbHkocm91dGVyLCBbJ3JvdXRlOicgKyBuYW1lXS5jb25jYXQoYXJncykpOwoJICAgICAgICByb3V0ZXIudHJpZ2dlcigncm91dGUnLCBuYW1lLCBhcmdzKTsKCSAgICAgICAgQmFja2JvbmUuaGlzdG9yeS50cmlnZ2VyKCdyb3V0ZScsIHJvdXRlciwgbmFtZSwgYXJncyk7CgkgICAgICB9KTsKCSAgICAgIHJldHVybiB0aGlzOwoJICAgIH0sCgoJICAgIC8vIEV4ZWN1dGUgYSByb3V0ZSBoYW5kbGVyIHdpdGggdGhlIHByb3ZpZGVkIHBhcmFtZXRlcnMuICBUaGlzIGlzIGFuCgkgICAgLy8gZXhjZWxsZW50IHBsYWNlIHRvIGRvIHByZS1yb3V0ZSBzZXR1cCBvciBwb3N0LXJvdXRlIGNsZWFudXAuCgkgICAgZXhlY3V0ZTogZnVuY3Rpb24oY2FsbGJhY2ssIGFyZ3MpIHsKCSAgICAgIGlmIChjYWxsYmFjaykgY2FsbGJhY2suYXBwbHkodGhpcywgYXJncyk7CgkgICAgfSwKCgkgICAgLy8gU2ltcGxlIHByb3h5IHRvIGBCYWNrYm9uZS5oaXN0b3J5YCB0byBzYXZlIGEgZnJhZ21lbnQgaW50byB0aGUgaGlzdG9yeS4KCSAgICBuYXZpZ2F0ZTogZnVuY3Rpb24oZnJhZ21lbnQsIG9wdGlvbnMpIHsKCSAgICAgIEJhY2tib25lLmhpc3RvcnkubmF2aWdhdGUoZnJhZ21lbnQsIG9wdGlvbnMpOwoJICAgICAgcmV0dXJuIHRoaXM7CgkgICAgfSwKCgkgICAgLy8gQmluZCBhbGwgZGVmaW5lZCByb3V0ZXMgdG8gYEJhY2tib25lLmhpc3RvcnlgLiBXZSBoYXZlIHRvIHJldmVyc2UgdGhlCgkgICAgLy8gb3JkZXIgb2YgdGhlIHJvdXRlcyBoZXJlIHRvIHN1cHBvcnQgYmVoYXZpb3Igd2hlcmUgdGhlIG1vc3QgZ2VuZXJhbAoJICAgIC8vIHJvdXRlcyBjYW4gYmUgZGVmaW5lZCBhdCB0aGUgYm90dG9tIG9mIHRoZSByb3V0ZSBtYXAuCgkgICAgX2JpbmRSb3V0ZXM6IGZ1bmN0aW9uKCkgewoJICAgICAgaWYgKCF0aGlzLnJvdXRlcykgcmV0dXJuOwoJICAgICAgdGhpcy5yb3V0ZXMgPSBfLnJlc3VsdCh0aGlzLCAncm91dGVzJyk7CgkgICAgICB2YXIgcm91dGUsIHJvdXRlcyA9IF8ua2V5cyh0aGlzLnJvdXRlcyk7CgkgICAgICB3aGlsZSAoKHJvdXRlID0gcm91dGVzLnBvcCgpKSAhPSBudWxsKSB7CgkgICAgICAgIHRoaXMucm91dGUocm91dGUsIHRoaXMucm91dGVzW3JvdXRlXSk7CgkgICAgICB9CgkgICAgfSwKCgkgICAgLy8gQ29udmVydCBhIHJvdXRlIHN0cmluZyBpbnRvIGEgcmVndWxhciBleHByZXNzaW9uLCBzdWl0YWJsZSBmb3IgbWF0Y2hpbmcKCSAgICAvLyBhZ2FpbnN0IHRoZSBjdXJyZW50IGxvY2F0aW9uIGhhc2guCgkgICAgX3JvdXRlVG9SZWdFeHA6IGZ1bmN0aW9uKHJvdXRlKSB7CgkgICAgICByb3V0ZSA9IHJvdXRlLnJlcGxhY2UoZXNjYXBlUmVnRXhwLCAnXFwkJicpCgkgICAgICAgICAgICAgICAgICAgLnJlcGxhY2Uob3B0aW9uYWxQYXJhbSwgJyg/OiQxKT8nKQoJICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKG5hbWVkUGFyYW0sIGZ1bmN0aW9uKG1hdGNoLCBvcHRpb25hbCkgewoJICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG9wdGlvbmFsID8gbWF0Y2ggOiAnKFteLz9dKyknOwoJICAgICAgICAgICAgICAgICAgIH0pCgkgICAgICAgICAgICAgICAgICAgLnJlcGxhY2Uoc3BsYXRQYXJhbSwgJyhbXj9dKj8pJyk7CgkgICAgICByZXR1cm4gbmV3IFJlZ0V4cCgnXicgKyByb3V0ZSArICcoPzpcXD8oW1xcc1xcU10qKSk/JCcpOwoJICAgIH0sCgoJICAgIC8vIEdpdmVuIGEgcm91dGUsIGFuZCBhIFVSTCBmcmFnbWVudCB0aGF0IGl0IG1hdGNoZXMsIHJldHVybiB0aGUgYXJyYXkgb2YKCSAgICAvLyBleHRyYWN0ZWQgZGVjb2RlZCBwYXJhbWV0ZXJzLiBFbXB0eSBvciB1bm1hdGNoZWQgcGFyYW1ldGVycyB3aWxsIGJlCgkgICAgLy8gdHJlYXRlZCBhcyBgbnVsbGAgdG8gbm9ybWFsaXplIGNyb3NzLWJyb3dzZXIgYmVoYXZpb3IuCgkgICAgX2V4dHJhY3RQYXJhbWV0ZXJzOiBmdW5jdGlvbihyb3V0ZSwgZnJhZ21lbnQpIHsKCSAgICAgIHZhciBwYXJhbXMgPSByb3V0ZS5leGVjKGZyYWdtZW50KS5zbGljZSgxKTsKCSAgICAgIHJldHVybiBfLm1hcChwYXJhbXMsIGZ1bmN0aW9uKHBhcmFtLCBpKSB7CgkgICAgICAgIC8vIERvbid0IGRlY29kZSB0aGUgc2VhcmNoIHBhcmFtcy4KCSAgICAgICAgaWYgKGkgPT09IHBhcmFtcy5sZW5ndGggLSAxKSByZXR1cm4gcGFyYW0gfHwgbnVsbDsKCSAgICAgICAgcmV0dXJuIHBhcmFtID8gZGVjb2RlVVJJQ29tcG9uZW50KHBhcmFtKSA6IG51bGw7CgkgICAgICB9KTsKCSAgICB9CgoJICB9KTsKCgkgIC8vIEJhY2tib25lLkhpc3RvcnkKCSAgLy8gLS0tLS0tLS0tLS0tLS0tLQoKCSAgLy8gSGFuZGxlcyBjcm9zcy1icm93c2VyIGhpc3RvcnkgbWFuYWdlbWVudCwgYmFzZWQgb24gZWl0aGVyCgkgIC8vIFtwdXNoU3RhdGVdKGh0dHA6Ly9kaXZlaW50b2h0bWw1LmluZm8vaGlzdG9yeS5odG1sKSBhbmQgcmVhbCBVUkxzLCBvcgoJICAvLyBbb25oYXNoY2hhbmdlXShodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL0RPTS93aW5kb3cub25oYXNoY2hhbmdlKQoJICAvLyBhbmQgVVJMIGZyYWdtZW50cy4gSWYgdGhlIGJyb3dzZXIgc3VwcG9ydHMgbmVpdGhlciAob2xkIElFLCBuYXRjaCksCgkgIC8vIGZhbGxzIGJhY2sgdG8gcG9sbGluZy4KCSAgdmFyIEhpc3RvcnkgPSBCYWNrYm9uZS5IaXN0b3J5ID0gZnVuY3Rpb24oKSB7CgkgICAgdGhpcy5oYW5kbGVycyA9IFtdOwoJICAgIF8uYmluZEFsbCh0aGlzLCAnY2hlY2tVcmwnKTsKCgkgICAgLy8gRW5zdXJlIHRoYXQgYEhpc3RvcnlgIGNhbiBiZSB1c2VkIG91dHNpZGUgb2YgdGhlIGJyb3dzZXIuCgkgICAgaWYgKHR5cGVvZiB3aW5kb3cgIT09ICd1bmRlZmluZWQnKSB7CgkgICAgICB0aGlzLmxvY2F0aW9uID0gd2luZG93LmxvY2F0aW9uOwoJICAgICAgdGhpcy5oaXN0b3J5ID0gd2luZG93Lmhpc3Rvcnk7CgkgICAgfQoJICB9OwoKCSAgLy8gQ2FjaGVkIHJlZ2V4IGZvciBzdHJpcHBpbmcgYSBsZWFkaW5nIGhhc2gvc2xhc2ggYW5kIHRyYWlsaW5nIHNwYWNlLgoJICB2YXIgcm91dGVTdHJpcHBlciA9IC9eWyNcL118XHMrJC9nOwoKCSAgLy8gQ2FjaGVkIHJlZ2V4IGZvciBzdHJpcHBpbmcgbGVhZGluZyBhbmQgdHJhaWxpbmcgc2xhc2hlcy4KCSAgdmFyIHJvb3RTdHJpcHBlciA9IC9eXC8rfFwvKyQvZzsKCgkgIC8vIENhY2hlZCByZWdleCBmb3IgZGV0ZWN0aW5nIE1TSUUuCgkgIHZhciBpc0V4cGxvcmVyID0gL21zaWUgW1x3Ll0rLzsKCgkgIC8vIENhY2hlZCByZWdleCBmb3IgcmVtb3ZpbmcgYSB0cmFpbGluZyBzbGFzaC4KCSAgdmFyIHRyYWlsaW5nU2xhc2ggPSAvXC8kLzsKCgkgIC8vIENhY2hlZCByZWdleCBmb3Igc3RyaXBwaW5nIHVybHMgb2YgaGFzaC4KCSAgdmFyIHBhdGhTdHJpcHBlciA9IC8jLiokLzsKCgkgIC8vIEhhcyB0aGUgaGlzdG9yeSBoYW5kbGluZyBhbHJlYWR5IGJlZW4gc3RhcnRlZD8KCSAgSGlzdG9yeS5zdGFydGVkID0gZmFsc2U7CgoJICAvLyBTZXQgdXAgYWxsIGluaGVyaXRhYmxlICoqQmFja2JvbmUuSGlzdG9yeSoqIHByb3BlcnRpZXMgYW5kIG1ldGhvZHMuCgkgIF8uZXh0ZW5kKEhpc3RvcnkucHJvdG90eXBlLCBFdmVudHMsIHsKCgkgICAgLy8gVGhlIGRlZmF1bHQgaW50ZXJ2YWwgdG8gcG9sbCBmb3IgaGFzaCBjaGFuZ2VzLCBpZiBuZWNlc3NhcnksIGlzCgkgICAgLy8gdHdlbnR5IHRpbWVzIGEgc2Vjb25kLgoJICAgIGludGVydmFsOiA1MCwKCgkgICAgLy8gQXJlIHdlIGF0IHRoZSBhcHAgcm9vdD8KCSAgICBhdFJvb3Q6IGZ1bmN0aW9uKCkgewoJICAgICAgcmV0dXJuIHRoaXMubG9jYXRpb24ucGF0aG5hbWUucmVwbGFjZSgvW15cL10kLywgJyQmLycpID09PSB0aGlzLnJvb3Q7CgkgICAgfSwKCgkgICAgLy8gR2V0cyB0aGUgdHJ1ZSBoYXNoIHZhbHVlLiBDYW5ub3QgdXNlIGxvY2F0aW9uLmhhc2ggZGlyZWN0bHkgZHVlIHRvIGJ1ZwoJICAgIC8vIGluIEZpcmVmb3ggd2hlcmUgbG9jYXRpb24uaGFzaCB3aWxsIGFsd2F5cyBiZSBkZWNvZGVkLgoJICAgIGdldEhhc2g6IGZ1bmN0aW9uKHdpbmRvdykgewoJICAgICAgdmFyIG1hdGNoID0gKHdpbmRvdyB8fCB0aGlzKS5sb2NhdGlvbi5ocmVmLm1hdGNoKC8jKC4qKSQvKTsKCSAgICAgIHJldHVybiBtYXRjaCA/IG1hdGNoWzFdIDogJyc7CgkgICAgfSwKCgkgICAgLy8gR2V0IHRoZSBjcm9zcy1icm93c2VyIG5vcm1hbGl6ZWQgVVJMIGZyYWdtZW50LCBlaXRoZXIgZnJvbSB0aGUgVVJMLAoJICAgIC8vIHRoZSBoYXNoLCBvciB0aGUgb3ZlcnJpZGUuCgkgICAgZ2V0RnJhZ21lbnQ6IGZ1bmN0aW9uKGZyYWdtZW50LCBmb3JjZVB1c2hTdGF0ZSkgewoJICAgICAgaWYgKGZyYWdtZW50ID09IG51bGwpIHsKCSAgICAgICAgaWYgKHRoaXMuX2hhc1B1c2hTdGF0ZSB8fCAhdGhpcy5fd2FudHNIYXNoQ2hhbmdlIHx8IGZvcmNlUHVzaFN0YXRlKSB7CgkgICAgICAgICAgZnJhZ21lbnQgPSBkZWNvZGVVUkkodGhpcy5sb2NhdGlvbi5wYXRobmFtZSArIHRoaXMubG9jYXRpb24uc2VhcmNoKTsKCSAgICAgICAgICB2YXIgcm9vdCA9IHRoaXMucm9vdC5yZXBsYWNlKHRyYWlsaW5nU2xhc2gsICcnKTsKCSAgICAgICAgICBpZiAoIWZyYWdtZW50LmluZGV4T2Yocm9vdCkpIGZyYWdtZW50ID0gZnJhZ21lbnQuc2xpY2Uocm9vdC5sZW5ndGgpOwoJICAgICAgICB9IGVsc2UgewoJICAgICAgICAgIGZyYWdtZW50ID0gdGhpcy5nZXRIYXNoKCk7CgkgICAgICAgIH0KCSAgICAgIH0KCSAgICAgIHJldHVybiBmcmFnbWVudC5yZXBsYWNlKHJvdXRlU3RyaXBwZXIsICcnKTsKCSAgICB9LAoKCSAgICAvLyBTdGFydCB0aGUgaGFzaCBjaGFuZ2UgaGFuZGxpbmcsIHJldHVybmluZyBgdHJ1ZWAgaWYgdGhlIGN1cnJlbnQgVVJMIG1hdGNoZXMKCSAgICAvLyBhbiBleGlzdGluZyByb3V0ZSwgYW5kIGBmYWxzZWAgb3RoZXJ3aXNlLgoJICAgIHN0YXJ0OiBmdW5jdGlvbihvcHRpb25zKSB7CgkgICAgICBpZiAoSGlzdG9yeS5zdGFydGVkKSB0aHJvdyBuZXcgRXJyb3IoIkJhY2tib25lLmhpc3RvcnkgaGFzIGFscmVhZHkgYmVlbiBzdGFydGVkIik7CgkgICAgICBIaXN0b3J5LnN0YXJ0ZWQgPSB0cnVlOwoKCSAgICAgIC8vIEZpZ3VyZSBvdXQgdGhlIGluaXRpYWwgY29uZmlndXJhdGlvbi4gRG8gd2UgbmVlZCBhbiBpZnJhbWU/CgkgICAgICAvLyBJcyBwdXNoU3RhdGUgZGVzaXJlZCAuLi4gaXMgaXQgYXZhaWxhYmxlPwoJICAgICAgdGhpcy5vcHRpb25zICAgICAgICAgID0gXy5leHRlbmQoe3Jvb3Q6ICcvJ30sIHRoaXMub3B0aW9ucywgb3B0aW9ucyk7CgkgICAgICB0aGlzLnJvb3QgICAgICAgICAgICAgPSB0aGlzLm9wdGlvbnMucm9vdDsKCSAgICAgIHRoaXMuX3dhbnRzSGFzaENoYW5nZSA9IHRoaXMub3B0aW9ucy5oYXNoQ2hhbmdlICE9PSBmYWxzZTsKCSAgICAgIHRoaXMuX3dhbnRzUHVzaFN0YXRlICA9ICEhdGhpcy5vcHRpb25zLnB1c2hTdGF0ZTsKCSAgICAgIHRoaXMuX2hhc1B1c2hTdGF0ZSAgICA9ICEhKHRoaXMub3B0aW9ucy5wdXNoU3RhdGUgJiYgdGhpcy5oaXN0b3J5ICYmIHRoaXMuaGlzdG9yeS5wdXNoU3RhdGUpOwoJICAgICAgdmFyIGZyYWdtZW50ICAgICAgICAgID0gdGhpcy5nZXRGcmFnbWVudCgpOwoJICAgICAgdmFyIGRvY01vZGUgICAgICAgICAgID0gZG9jdW1lbnQuZG9jdW1lbnRNb2RlOwoJICAgICAgdmFyIG9sZElFICAgICAgICAgICAgID0gKGlzRXhwbG9yZXIuZXhlYyhuYXZpZ2F0b3IudXNlckFnZW50LnRvTG93ZXJDYXNlKCkpICYmICghZG9jTW9kZSB8fCBkb2NNb2RlIDw9IDcpKTsKCgkgICAgICAvLyBOb3JtYWxpemUgcm9vdCB0byBhbHdheXMgaW5jbHVkZSBhIGxlYWRpbmcgYW5kIHRyYWlsaW5nIHNsYXNoLgoJICAgICAgdGhpcy5yb290ID0gKCcvJyArIHRoaXMucm9vdCArICcvJykucmVwbGFjZShyb290U3RyaXBwZXIsICcvJyk7CgoJICAgICAgaWYgKG9sZElFICYmIHRoaXMuX3dhbnRzSGFzaENoYW5nZSkgewoJICAgICAgICB2YXIgZnJhbWUgPSBCYWNrYm9uZS4kKCc8aWZyYW1lIHNyYz0iamF2YXNjcmlwdDowIiB0YWJpbmRleD0iLTEiPicpOwoJICAgICAgICB0aGlzLmlmcmFtZSA9IGZyYW1lLmhpZGUoKS5hcHBlbmRUbygnYm9keScpWzBdLmNvbnRlbnRXaW5kb3c7CgkgICAgICAgIHRoaXMubmF2aWdhdGUoZnJhZ21lbnQpOwoJICAgICAgfQoKCSAgICAgIC8vIERlcGVuZGluZyBvbiB3aGV0aGVyIHdlJ3JlIHVzaW5nIHB1c2hTdGF0ZSBvciBoYXNoZXMsIGFuZCB3aGV0aGVyCgkgICAgICAvLyAnb25oYXNoY2hhbmdlJyBpcyBzdXBwb3J0ZWQsIGRldGVybWluZSBob3cgd2UgY2hlY2sgdGhlIFVSTCBzdGF0ZS4KCSAgICAgIGlmICh0aGlzLl9oYXNQdXNoU3RhdGUpIHsKCSAgICAgICAgQmFja2JvbmUuJCh3aW5kb3cpLm9uKCdwb3BzdGF0ZScsIHRoaXMuY2hlY2tVcmwpOwoJICAgICAgfSBlbHNlIGlmICh0aGlzLl93YW50c0hhc2hDaGFuZ2UgJiYgKCdvbmhhc2hjaGFuZ2UnIGluIHdpbmRvdykgJiYgIW9sZElFKSB7CgkgICAgICAgIEJhY2tib25lLiQod2luZG93KS5vbignaGFzaGNoYW5nZScsIHRoaXMuY2hlY2tVcmwpOwoJICAgICAgfSBlbHNlIGlmICh0aGlzLl93YW50c0hhc2hDaGFuZ2UpIHsKCSAgICAgICAgdGhpcy5fY2hlY2tVcmxJbnRlcnZhbCA9IHNldEludGVydmFsKHRoaXMuY2hlY2tVcmwsIHRoaXMuaW50ZXJ2YWwpOwoJICAgICAgfQoKCSAgICAgIC8vIERldGVybWluZSBpZiB3ZSBuZWVkIHRvIGNoYW5nZSB0aGUgYmFzZSB1cmwsIGZvciBhIHB1c2hTdGF0ZSBsaW5rCgkgICAgICAvLyBvcGVuZWQgYnkgYSBub24tcHVzaFN0YXRlIGJyb3dzZXIuCgkgICAgICB0aGlzLmZyYWdtZW50ID0gZnJhZ21lbnQ7CgkgICAgICB2YXIgbG9jID0gdGhpcy5sb2NhdGlvbjsKCgkgICAgICAvLyBUcmFuc2l0aW9uIGZyb20gaGFzaENoYW5nZSB0byBwdXNoU3RhdGUgb3IgdmljZSB2ZXJzYSBpZiBib3RoIGFyZQoJICAgICAgLy8gcmVxdWVzdGVkLgoJICAgICAgaWYgKHRoaXMuX3dhbnRzSGFzaENoYW5nZSAmJiB0aGlzLl93YW50c1B1c2hTdGF0ZSkgewoKCSAgICAgICAgLy8gSWYgd2UndmUgc3RhcnRlZCBvZmYgd2l0aCBhIHJvdXRlIGZyb20gYSBgcHVzaFN0YXRlYC1lbmFibGVkCgkgICAgICAgIC8vIGJyb3dzZXIsIGJ1dCB3ZSdyZSBjdXJyZW50bHkgaW4gYSBicm93c2VyIHRoYXQgZG9lc24ndCBzdXBwb3J0IGl0Li4uCgkgICAgICAgIGlmICghdGhpcy5faGFzUHVzaFN0YXRlICYmICF0aGlzLmF0Um9vdCgpKSB7CgkgICAgICAgICAgdGhpcy5mcmFnbWVudCA9IHRoaXMuZ2V0RnJhZ21lbnQobnVsbCwgdHJ1ZSk7CgkgICAgICAgICAgdGhpcy5sb2NhdGlvbi5yZXBsYWNlKHRoaXMucm9vdCArICcjJyArIHRoaXMuZnJhZ21lbnQpOwoJICAgICAgICAgIC8vIFJldHVybiBpbW1lZGlhdGVseSBhcyBicm93c2VyIHdpbGwgZG8gcmVkaXJlY3QgdG8gbmV3IHVybAoJICAgICAgICAgIHJldHVybiB0cnVlOwoKCSAgICAgICAgLy8gT3IgaWYgd2UndmUgc3RhcnRlZCBvdXQgd2l0aCBhIGhhc2gtYmFzZWQgcm91dGUsIGJ1dCB3ZSdyZSBjdXJyZW50bHkKCSAgICAgICAgLy8gaW4gYSBicm93c2VyIHdoZXJlIGl0IGNvdWxkIGJlIGBwdXNoU3RhdGVgLWJhc2VkIGluc3RlYWQuLi4KCSAgICAgICAgfSBlbHNlIGlmICh0aGlzLl9oYXNQdXNoU3RhdGUgJiYgdGhpcy5hdFJvb3QoKSAmJiBsb2MuaGFzaCkgewoJICAgICAgICAgIHRoaXMuZnJhZ21lbnQgPSB0aGlzLmdldEhhc2goKS5yZXBsYWNlKHJvdXRlU3RyaXBwZXIsICcnKTsKCSAgICAgICAgICB0aGlzLmhpc3RvcnkucmVwbGFjZVN0YXRlKHt9LCBkb2N1bWVudC50aXRsZSwgdGhpcy5yb290ICsgdGhpcy5mcmFnbWVudCk7CgkgICAgICAgIH0KCgkgICAgICB9CgoJICAgICAgaWYgKCF0aGlzLm9wdGlvbnMuc2lsZW50KSByZXR1cm4gdGhpcy5sb2FkVXJsKCk7CgkgICAgfSwKCgkgICAgLy8gRGlzYWJsZSBCYWNrYm9uZS5oaXN0b3J5LCBwZXJoYXBzIHRlbXBvcmFyaWx5LiBOb3QgdXNlZnVsIGluIGEgcmVhbCBhcHAsCgkgICAgLy8gYnV0IHBvc3NpYmx5IHVzZWZ1bCBmb3IgdW5pdCB0ZXN0aW5nIFJvdXRlcnMuCgkgICAgc3RvcDogZnVuY3Rpb24oKSB7CgkgICAgICBCYWNrYm9uZS4kKHdpbmRvdykub2ZmKCdwb3BzdGF0ZScsIHRoaXMuY2hlY2tVcmwpLm9mZignaGFzaGNoYW5nZScsIHRoaXMuY2hlY2tVcmwpOwoJICAgICAgaWYgKHRoaXMuX2NoZWNrVXJsSW50ZXJ2YWwpIGNsZWFySW50ZXJ2YWwodGhpcy5fY2hlY2tVcmxJbnRlcnZhbCk7CgkgICAgICBIaXN0b3J5LnN0YXJ0ZWQgPSBmYWxzZTsKCSAgICB9LAoKCSAgICAvLyBBZGQgYSByb3V0ZSB0byBiZSB0ZXN0ZWQgd2hlbiB0aGUgZnJhZ21lbnQgY2hhbmdlcy4gUm91dGVzIGFkZGVkIGxhdGVyCgkgICAgLy8gbWF5IG92ZXJyaWRlIHByZXZpb3VzIHJvdXRlcy4KCSAgICByb3V0ZTogZnVuY3Rpb24ocm91dGUsIGNhbGxiYWNrKSB7CgkgICAgICB0aGlzLmhhbmRsZXJzLnVuc2hpZnQoe3JvdXRlOiByb3V0ZSwgY2FsbGJhY2s6IGNhbGxiYWNrfSk7CgkgICAgfSwKCgkgICAgLy8gQ2hlY2tzIHRoZSBjdXJyZW50IFVSTCB0byBzZWUgaWYgaXQgaGFzIGNoYW5nZWQsIGFuZCBpZiBpdCBoYXMsCgkgICAgLy8gY2FsbHMgYGxvYWRVcmxgLCBub3JtYWxpemluZyBhY3Jvc3MgdGhlIGhpZGRlbiBpZnJhbWUuCgkgICAgY2hlY2tVcmw6IGZ1bmN0aW9uKGUpIHsKCSAgICAgIHZhciBjdXJyZW50ID0gdGhpcy5nZXRGcmFnbWVudCgpOwoJICAgICAgaWYgKGN1cnJlbnQgPT09IHRoaXMuZnJhZ21lbnQgJiYgdGhpcy5pZnJhbWUpIHsKCSAgICAgICAgY3VycmVudCA9IHRoaXMuZ2V0RnJhZ21lbnQodGhpcy5nZXRIYXNoKHRoaXMuaWZyYW1lKSk7CgkgICAgICB9CgkgICAgICBpZiAoY3VycmVudCA9PT0gdGhpcy5mcmFnbWVudCkgcmV0dXJuIGZhbHNlOwoJICAgICAgaWYgKHRoaXMuaWZyYW1lKSB0aGlzLm5hdmlnYXRlKGN1cnJlbnQpOwoJICAgICAgdGhpcy5sb2FkVXJsKCk7CgkgICAgfSwKCgkgICAgLy8gQXR0ZW1wdCB0byBsb2FkIHRoZSBjdXJyZW50IFVSTCBmcmFnbWVudC4gSWYgYSByb3V0ZSBzdWNjZWVkcyB3aXRoIGEKCSAgICAvLyBtYXRjaCwgcmV0dXJucyBgdHJ1ZWAuIElmIG5vIGRlZmluZWQgcm91dGVzIG1hdGNoZXMgdGhlIGZyYWdtZW50LAoJICAgIC8vIHJldHVybnMgYGZhbHNlYC4KCSAgICBsb2FkVXJsOiBmdW5jdGlvbihmcmFnbWVudCkgewoJICAgICAgZnJhZ21lbnQgPSB0aGlzLmZyYWdtZW50ID0gdGhpcy5nZXRGcmFnbWVudChmcmFnbWVudCk7CgkgICAgICByZXR1cm4gXy5hbnkodGhpcy5oYW5kbGVycywgZnVuY3Rpb24oaGFuZGxlcikgewoJICAgICAgICBpZiAoaGFuZGxlci5yb3V0ZS50ZXN0KGZyYWdtZW50KSkgewoJICAgICAgICAgIGhhbmRsZXIuY2FsbGJhY2soZnJhZ21lbnQpOwoJICAgICAgICAgIHJldHVybiB0cnVlOwoJICAgICAgICB9CgkgICAgICB9KTsKCSAgICB9LAoKCSAgICAvLyBTYXZlIGEgZnJhZ21lbnQgaW50byB0aGUgaGFzaCBoaXN0b3J5LCBvciByZXBsYWNlIHRoZSBVUkwgc3RhdGUgaWYgdGhlCgkgICAgLy8gJ3JlcGxhY2UnIG9wdGlvbiBpcyBwYXNzZWQuIFlvdSBhcmUgcmVzcG9uc2libGUgZm9yIHByb3Blcmx5IFVSTC1lbmNvZGluZwoJICAgIC8vIHRoZSBmcmFnbWVudCBpbiBhZHZhbmNlLgoJICAgIC8vCgkgICAgLy8gVGhlIG9wdGlvbnMgb2JqZWN0IGNhbiBjb250YWluIGB0cmlnZ2VyOiB0cnVlYCBpZiB5b3Ugd2lzaCB0byBoYXZlIHRoZQoJICAgIC8vIHJvdXRlIGNhbGxiYWNrIGJlIGZpcmVkIChub3QgdXN1YWxseSBkZXNpcmFibGUpLCBvciBgcmVwbGFjZTogdHJ1ZWAsIGlmCgkgICAgLy8geW91IHdpc2ggdG8gbW9kaWZ5IHRoZSBjdXJyZW50IFVSTCB3aXRob3V0IGFkZGluZyBhbiBlbnRyeSB0byB0aGUgaGlzdG9yeS4KCSAgICBuYXZpZ2F0ZTogZnVuY3Rpb24oZnJhZ21lbnQsIG9wdGlvbnMpIHsKCSAgICAgIGlmICghSGlzdG9yeS5zdGFydGVkKSByZXR1cm4gZmFsc2U7CgkgICAgICBpZiAoIW9wdGlvbnMgfHwgb3B0aW9ucyA9PT0gdHJ1ZSkgb3B0aW9ucyA9IHt0cmlnZ2VyOiAhIW9wdGlvbnN9OwoKCSAgICAgIHZhciB1cmwgPSB0aGlzLnJvb3QgKyAoZnJhZ21lbnQgPSB0aGlzLmdldEZyYWdtZW50KGZyYWdtZW50IHx8ICcnKSk7CgoJICAgICAgLy8gU3RyaXAgdGhlIGhhc2ggZm9yIG1hdGNoaW5nLgoJICAgICAgZnJhZ21lbnQgPSBmcmFnbWVudC5yZXBsYWNlKHBhdGhTdHJpcHBlciwgJycpOwoKCSAgICAgIGlmICh0aGlzLmZyYWdtZW50ID09PSBmcmFnbWVudCkgcmV0dXJuOwoJICAgICAgdGhpcy5mcmFnbWVudCA9IGZyYWdtZW50OwoKCSAgICAgIC8vIERvbid0IGluY2x1ZGUgYSB0cmFpbGluZyBzbGFzaCBvbiB0aGUgcm9vdC4KCSAgICAgIGlmIChmcmFnbWVudCA9PT0gJycgJiYgdXJsICE9PSAnLycpIHVybCA9IHVybC5zbGljZSgwLCAtMSk7CgoJICAgICAgLy8gSWYgcHVzaFN0YXRlIGlzIGF2YWlsYWJsZSwgd2UgdXNlIGl0IHRvIHNldCB0aGUgZnJhZ21lbnQgYXMgYSByZWFsIFVSTC4KCSAgICAgIGlmICh0aGlzLl9oYXNQdXNoU3RhdGUpIHsKCSAgICAgICAgdGhpcy5oaXN0b3J5W29wdGlvbnMucmVwbGFjZSA/ICdyZXBsYWNlU3RhdGUnIDogJ3B1c2hTdGF0ZSddKHt9LCBkb2N1bWVudC50aXRsZSwgdXJsKTsKCgkgICAgICAvLyBJZiBoYXNoIGNoYW5nZXMgaGF2ZW4ndCBiZWVuIGV4cGxpY2l0bHkgZGlzYWJsZWQsIHVwZGF0ZSB0aGUgaGFzaAoJICAgICAgLy8gZnJhZ21lbnQgdG8gc3RvcmUgaGlzdG9yeS4KCSAgICAgIH0gZWxzZSBpZiAodGhpcy5fd2FudHNIYXNoQ2hhbmdlKSB7CgkgICAgICAgIHRoaXMuX3VwZGF0ZUhhc2godGhpcy5sb2NhdGlvbiwgZnJhZ21lbnQsIG9wdGlvbnMucmVwbGFjZSk7CgkgICAgICAgIGlmICh0aGlzLmlmcmFtZSAmJiAoZnJhZ21lbnQgIT09IHRoaXMuZ2V0RnJhZ21lbnQodGhpcy5nZXRIYXNoKHRoaXMuaWZyYW1lKSkpKSB7CgkgICAgICAgICAgLy8gT3BlbmluZyBhbmQgY2xvc2luZyB0aGUgaWZyYW1lIHRyaWNrcyBJRTcgYW5kIGVhcmxpZXIgdG8gcHVzaCBhCgkgICAgICAgICAgLy8gaGlzdG9yeSBlbnRyeSBvbiBoYXNoLXRhZyBjaGFuZ2UuICBXaGVuIHJlcGxhY2UgaXMgdHJ1ZSwgd2UgZG9uJ3QKCSAgICAgICAgICAvLyB3YW50IHRoaXMuCgkgICAgICAgICAgaWYoIW9wdGlvbnMucmVwbGFjZSkgdGhpcy5pZnJhbWUuZG9jdW1lbnQub3BlbigpLmNsb3NlKCk7CgkgICAgICAgICAgdGhpcy5fdXBkYXRlSGFzaCh0aGlzLmlmcmFtZS5sb2NhdGlvbiwgZnJhZ21lbnQsIG9wdGlvbnMucmVwbGFjZSk7CgkgICAgICAgIH0KCgkgICAgICAvLyBJZiB5b3UndmUgdG9sZCB1cyB0aGF0IHlvdSBleHBsaWNpdGx5IGRvbid0IHdhbnQgZmFsbGJhY2sgaGFzaGNoYW5nZS0KCSAgICAgIC8vIGJhc2VkIGhpc3RvcnksIHRoZW4gYG5hdmlnYXRlYCBiZWNvbWVzIGEgcGFnZSByZWZyZXNoLgoJICAgICAgfSBlbHNlIHsKCSAgICAgICAgcmV0dXJuIHRoaXMubG9jYXRpb24uYXNzaWduKHVybCk7CgkgICAgICB9CgkgICAgICBpZiAob3B0aW9ucy50cmlnZ2VyKSByZXR1cm4gdGhpcy5sb2FkVXJsKGZyYWdtZW50KTsKCSAgICB9LAoKCSAgICAvLyBVcGRhdGUgdGhlIGhhc2ggbG9jYXRpb24sIGVpdGhlciByZXBsYWNpbmcgdGhlIGN1cnJlbnQgZW50cnksIG9yIGFkZGluZwoJICAgIC8vIGEgbmV3IG9uZSB0byB0aGUgYnJvd3NlciBoaXN0b3J5LgoJICAgIF91cGRhdGVIYXNoOiBmdW5jdGlvbihsb2NhdGlvbiwgZnJhZ21lbnQsIHJlcGxhY2UpIHsKCSAgICAgIGlmIChyZXBsYWNlKSB7CgkgICAgICAgIHZhciBocmVmID0gbG9jYXRpb24uaHJlZi5yZXBsYWNlKC8oamF2YXNjcmlwdDp8IykuKiQvLCAnJyk7CgkgICAgICAgIGxvY2F0aW9uLnJlcGxhY2UoaHJlZiArICcjJyArIGZyYWdtZW50KTsKCSAgICAgIH0gZWxzZSB7CgkgICAgICAgIC8vIFNvbWUgYnJvd3NlcnMgcmVxdWlyZSB0aGF0IGBoYXNoYCBjb250YWlucyBhIGxlYWRpbmcgIy4KCSAgICAgICAgbG9jYXRpb24uaGFzaCA9ICcjJyArIGZyYWdtZW50OwoJICAgICAgfQoJICAgIH0KCgkgIH0pOwoKCSAgLy8gQ3JlYXRlIHRoZSBkZWZhdWx0IEJhY2tib25lLmhpc3RvcnkuCgkgIEJhY2tib25lLmhpc3RvcnkgPSBuZXcgSGlzdG9yeTsKCgkgIC8vIEhlbHBlcnMKCSAgLy8gLS0tLS0tLQoKCSAgLy8gSGVscGVyIGZ1bmN0aW9uIHRvIGNvcnJlY3RseSBzZXQgdXAgdGhlIHByb3RvdHlwZSBjaGFpbiwgZm9yIHN1YmNsYXNzZXMuCgkgIC8vIFNpbWlsYXIgdG8gYGdvb2cuaW5oZXJpdHNgLCBidXQgdXNlcyBhIGhhc2ggb2YgcHJvdG90eXBlIHByb3BlcnRpZXMgYW5kCgkgIC8vIGNsYXNzIHByb3BlcnRpZXMgdG8gYmUgZXh0ZW5kZWQuCgkgIHZhciBleHRlbmQgPSBmdW5jdGlvbihwcm90b1Byb3BzLCBzdGF0aWNQcm9wcykgewoJICAgIHZhciBwYXJlbnQgPSB0aGlzOwoJICAgIHZhciBjaGlsZDsKCgkgICAgLy8gVGhlIGNvbnN0cnVjdG9yIGZ1bmN0aW9uIGZvciB0aGUgbmV3IHN1YmNsYXNzIGlzIGVpdGhlciBkZWZpbmVkIGJ5IHlvdQoJICAgIC8vICh0aGUgImNvbnN0cnVjdG9yIiBwcm9wZXJ0eSBpbiB5b3VyIGBleHRlbmRgIGRlZmluaXRpb24pLCBvciBkZWZhdWx0ZWQKCSAgICAvLyBieSB1cyB0byBzaW1wbHkgY2FsbCB0aGUgcGFyZW50J3MgY29uc3RydWN0b3IuCgkgICAgaWYgKHByb3RvUHJvcHMgJiYgXy5oYXMocHJvdG9Qcm9wcywgJ2NvbnN0cnVjdG9yJykpIHsKCSAgICAgIGNoaWxkID0gcHJvdG9Qcm9wcy5jb25zdHJ1Y3RvcjsKCSAgICB9IGVsc2UgewoJICAgICAgY2hpbGQgPSBmdW5jdGlvbigpeyByZXR1cm4gcGFyZW50LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7IH07CgkgICAgfQoKCSAgICAvLyBBZGQgc3RhdGljIHByb3BlcnRpZXMgdG8gdGhlIGNvbnN0cnVjdG9yIGZ1bmN0aW9uLCBpZiBzdXBwbGllZC4KCSAgICBfLmV4dGVuZChjaGlsZCwgcGFyZW50LCBzdGF0aWNQcm9wcyk7CgoJICAgIC8vIFNldCB0aGUgcHJvdG90eXBlIGNoYWluIHRvIGluaGVyaXQgZnJvbSBgcGFyZW50YCwgd2l0aG91dCBjYWxsaW5nCgkgICAgLy8gYHBhcmVudGAncyBjb25zdHJ1Y3RvciBmdW5jdGlvbi4KCSAgICB2YXIgU3Vycm9nYXRlID0gZnVuY3Rpb24oKXsgdGhpcy5jb25zdHJ1Y3RvciA9IGNoaWxkOyB9OwoJICAgIFN1cnJvZ2F0ZS5wcm90b3R5cGUgPSBwYXJlbnQucHJvdG90eXBlOwoJICAgIGNoaWxkLnByb3RvdHlwZSA9IG5ldyBTdXJyb2dhdGU7CgoJICAgIC8vIEFkZCBwcm90b3R5cGUgcHJvcGVydGllcyAoaW5zdGFuY2UgcHJvcGVydGllcykgdG8gdGhlIHN1YmNsYXNzLAoJICAgIC8vIGlmIHN1cHBsaWVkLgoJICAgIGlmIChwcm90b1Byb3BzKSBfLmV4dGVuZChjaGlsZC5wcm90b3R5cGUsIHByb3RvUHJvcHMpOwoKCSAgICAvLyBTZXQgYSBjb252ZW5pZW5jZSBwcm9wZXJ0eSBpbiBjYXNlIHRoZSBwYXJlbnQncyBwcm90b3R5cGUgaXMgbmVlZGVkCgkgICAgLy8gbGF0ZXIuCgkgICAgY2hpbGQuX19zdXBlcl9fID0gcGFyZW50LnByb3RvdHlwZTsKCgkgICAgcmV0dXJuIGNoaWxkOwoJICB9OwoKCSAgLy8gU2V0IHVwIGluaGVyaXRhbmNlIGZvciB0aGUgbW9kZWwsIGNvbGxlY3Rpb24sIHJvdXRlciwgdmlldyBhbmQgaGlzdG9yeS4KCSAgTW9kZWwuZXh0ZW5kID0gQ29sbGVjdGlvbi5leHRlbmQgPSBSb3V0ZXIuZXh0ZW5kID0gVmlldy5leHRlbmQgPSBIaXN0b3J5LmV4dGVuZCA9IGV4dGVuZDsKCgkgIC8vIFRocm93IGFuIGVycm9yIHdoZW4gYSBVUkwgaXMgbmVlZGVkLCBhbmQgbm9uZSBpcyBzdXBwbGllZC4KCSAgdmFyIHVybEVycm9yID0gZnVuY3Rpb24oKSB7CgkgICAgdGhyb3cgbmV3IEVycm9yKCdBICJ1cmwiIHByb3BlcnR5IG9yIGZ1bmN0aW9uIG11c3QgYmUgc3BlY2lmaWVkJyk7CgkgIH07CgoJICAvLyBXcmFwIGFuIG9wdGlvbmFsIGVycm9yIGNhbGxiYWNrIHdpdGggYSBmYWxsYmFjayBlcnJvciBldmVudC4KCSAgdmFyIHdyYXBFcnJvciA9IGZ1bmN0aW9uKG1vZGVsLCBvcHRpb25zKSB7CgkgICAgdmFyIGVycm9yID0gb3B0aW9ucy5lcnJvcjsKCSAgICBvcHRpb25zLmVycm9yID0gZnVuY3Rpb24ocmVzcCkgewoJICAgICAgaWYgKGVycm9yKSBlcnJvcihtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CgkgICAgICBtb2RlbC50cmlnZ2VyKCdlcnJvcicsIG1vZGVsLCByZXNwLCBvcHRpb25zKTsKCSAgICB9OwoJICB9OwoKCSAgcmV0dXJuIEJhY2tib25lOwoKCX0pKTsKCgovKioqLyB9LAovKiAyNCAqLwovKioqLyBmdW5jdGlvbihtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKCgl2YXIgX19XRUJQQUNLX0FNRF9ERUZJTkVfQVJSQVlfXywgX19XRUJQQUNLX0FNRF9ERUZJTkVfUkVTVUxUX187Ly8gICAgIFVuZGVyc2NvcmUuanMgMS43LjAKCS8vICAgICBodHRwOi8vdW5kZXJzY29yZWpzLm9yZwoJLy8gICAgIChjKSAyMDA5LTIwMTQgSmVyZW15IEFzaGtlbmFzLCBEb2N1bWVudENsb3VkIGFuZCBJbnZlc3RpZ2F0aXZlIFJlcG9ydGVycyAmIEVkaXRvcnMKCS8vICAgICBVbmRlcnNjb3JlIG1heSBiZSBmcmVlbHkgZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLgoKCShmdW5jdGlvbigpIHsKCgkgIC8vIEJhc2VsaW5lIHNldHVwCgkgIC8vIC0tLS0tLS0tLS0tLS0tCgoJICAvLyBFc3RhYmxpc2ggdGhlIHJvb3Qgb2JqZWN0LCBgd2luZG93YCBpbiB0aGUgYnJvd3Nlciwgb3IgYGV4cG9ydHNgIG9uIHRoZSBzZXJ2ZXIuCgkgIHZhciByb290ID0gdGhpczsKCgkgIC8vIFNhdmUgdGhlIHByZXZpb3VzIHZhbHVlIG9mIHRoZSBgX2AgdmFyaWFibGUuCgkgIHZhciBwcmV2aW91c1VuZGVyc2NvcmUgPSByb290Ll87CgoJICAvLyBTYXZlIGJ5dGVzIGluIHRoZSBtaW5pZmllZCAoYnV0IG5vdCBnemlwcGVkKSB2ZXJzaW9uOgoJICB2YXIgQXJyYXlQcm90byA9IEFycmF5LnByb3RvdHlwZSwgT2JqUHJvdG8gPSBPYmplY3QucHJvdG90eXBlLCBGdW5jUHJvdG8gPSBGdW5jdGlvbi5wcm90b3R5cGU7CgoJICAvLyBDcmVhdGUgcXVpY2sgcmVmZXJlbmNlIHZhcmlhYmxlcyBmb3Igc3BlZWQgYWNjZXNzIHRvIGNvcmUgcHJvdG90eXBlcy4KCSAgdmFyCgkgICAgcHVzaCAgICAgICAgICAgICA9IEFycmF5UHJvdG8ucHVzaCwKCSAgICBzbGljZSAgICAgICAgICAgID0gQXJyYXlQcm90by5zbGljZSwKCSAgICBjb25jYXQgICAgICAgICAgID0gQXJyYXlQcm90by5jb25jYXQsCgkgICAgdG9TdHJpbmcgICAgICAgICA9IE9ialByb3RvLnRvU3RyaW5nLAoJICAgIGhhc093blByb3BlcnR5ICAgPSBPYmpQcm90by5oYXNPd25Qcm9wZXJ0eTsKCgkgIC8vIEFsbCAqKkVDTUFTY3JpcHQgNSoqIG5hdGl2ZSBmdW5jdGlvbiBpbXBsZW1lbnRhdGlvbnMgdGhhdCB3ZSBob3BlIHRvIHVzZQoJICAvLyBhcmUgZGVjbGFyZWQgaGVyZS4KCSAgdmFyCgkgICAgbmF0aXZlSXNBcnJheSAgICAgID0gQXJyYXkuaXNBcnJheSwKCSAgICBuYXRpdmVLZXlzICAgICAgICAgPSBPYmplY3Qua2V5cywKCSAgICBuYXRpdmVCaW5kICAgICAgICAgPSBGdW5jUHJvdG8uYmluZDsKCgkgIC8vIENyZWF0ZSBhIHNhZmUgcmVmZXJlbmNlIHRvIHRoZSBVbmRlcnNjb3JlIG9iamVjdCBmb3IgdXNlIGJlbG93LgoJICB2YXIgXyA9IGZ1bmN0aW9uKG9iaikgewoJICAgIGlmIChvYmogaW5zdGFuY2VvZiBfKSByZXR1cm4gb2JqOwoJICAgIGlmICghKHRoaXMgaW5zdGFuY2VvZiBfKSkgcmV0dXJuIG5ldyBfKG9iaik7CgkgICAgdGhpcy5fd3JhcHBlZCA9IG9iajsKCSAgfTsKCgkgIC8vIEV4cG9ydCB0aGUgVW5kZXJzY29yZSBvYmplY3QgZm9yICoqTm9kZS5qcyoqLCB3aXRoCgkgIC8vIGJhY2t3YXJkcy1jb21wYXRpYmlsaXR5IGZvciB0aGUgb2xkIGByZXF1aXJlKClgIEFQSS4gSWYgd2UncmUgaW4KCSAgLy8gdGhlIGJyb3dzZXIsIGFkZCBgX2AgYXMgYSBnbG9iYWwgb2JqZWN0LgoJICBpZiAodHJ1ZSkgewoJICAgIGlmICh0eXBlb2YgbW9kdWxlICE9PSAndW5kZWZpbmVkJyAmJiBtb2R1bGUuZXhwb3J0cykgewoJICAgICAgZXhwb3J0cyA9IG1vZHVsZS5leHBvcnRzID0gXzsKCSAgICB9CgkgICAgZXhwb3J0cy5fID0gXzsKCSAgfSBlbHNlIHsKCSAgICByb290Ll8gPSBfOwoJICB9CgoJICAvLyBDdXJyZW50IHZlcnNpb24uCgkgIF8uVkVSU0lPTiA9ICcxLjcuMCc7CgoJICAvLyBJbnRlcm5hbCBmdW5jdGlvbiB0aGF0IHJldHVybnMgYW4gZWZmaWNpZW50IChmb3IgY3VycmVudCBlbmdpbmVzKSB2ZXJzaW9uCgkgIC8vIG9mIHRoZSBwYXNzZWQtaW4gY2FsbGJhY2ssIHRvIGJlIHJlcGVhdGVkbHkgYXBwbGllZCBpbiBvdGhlciBVbmRlcnNjb3JlCgkgIC8vIGZ1bmN0aW9ucy4KCSAgdmFyIGNyZWF0ZUNhbGxiYWNrID0gZnVuY3Rpb24oZnVuYywgY29udGV4dCwgYXJnQ291bnQpIHsKCSAgICBpZiAoY29udGV4dCA9PT0gdm9pZCAwKSByZXR1cm4gZnVuYzsKCSAgICBzd2l0Y2ggKGFyZ0NvdW50ID09IG51bGwgPyAzIDogYXJnQ291bnQpIHsKCSAgICAgIGNhc2UgMTogcmV0dXJuIGZ1bmN0aW9uKHZhbHVlKSB7CgkgICAgICAgIHJldHVybiBmdW5jLmNhbGwoY29udGV4dCwgdmFsdWUpOwoJICAgICAgfTsKCSAgICAgIGNhc2UgMjogcmV0dXJuIGZ1bmN0aW9uKHZhbHVlLCBvdGhlcikgewoJICAgICAgICByZXR1cm4gZnVuYy5jYWxsKGNvbnRleHQsIHZhbHVlLCBvdGhlcik7CgkgICAgICB9OwoJICAgICAgY2FzZSAzOiByZXR1cm4gZnVuY3Rpb24odmFsdWUsIGluZGV4LCBjb2xsZWN0aW9uKSB7CgkgICAgICAgIHJldHVybiBmdW5jLmNhbGwoY29udGV4dCwgdmFsdWUsIGluZGV4LCBjb2xsZWN0aW9uKTsKCSAgICAgIH07CgkgICAgICBjYXNlIDQ6IHJldHVybiBmdW5jdGlvbihhY2N1bXVsYXRvciwgdmFsdWUsIGluZGV4LCBjb2xsZWN0aW9uKSB7CgkgICAgICAgIHJldHVybiBmdW5jLmNhbGwoY29udGV4dCwgYWNjdW11bGF0b3IsIHZhbHVlLCBpbmRleCwgY29sbGVjdGlvbik7CgkgICAgICB9OwoJICAgIH0KCSAgICByZXR1cm4gZnVuY3Rpb24oKSB7CgkgICAgICByZXR1cm4gZnVuYy5hcHBseShjb250ZXh0LCBhcmd1bWVudHMpOwoJICAgIH07CgkgIH07CgoJICAvLyBBIG1vc3RseS1pbnRlcm5hbCBmdW5jdGlvbiB0byBnZW5lcmF0ZSBjYWxsYmFja3MgdGhhdCBjYW4gYmUgYXBwbGllZAoJICAvLyB0byBlYWNoIGVsZW1lbnQgaW4gYSBjb2xsZWN0aW9uLCByZXR1cm5pbmcgdGhlIGRlc2lyZWQgcmVzdWx0IOKAlCBlaXRoZXIKCSAgLy8gaWRlbnRpdHksIGFuIGFyYml0cmFyeSBjYWxsYmFjaywgYSBwcm9wZXJ0eSBtYXRjaGVyLCBvciBhIHByb3BlcnR5IGFjY2Vzc29yLgoJICBfLml0ZXJhdGVlID0gZnVuY3Rpb24odmFsdWUsIGNvbnRleHQsIGFyZ0NvdW50KSB7CgkgICAgaWYgKHZhbHVlID09IG51bGwpIHJldHVybiBfLmlkZW50aXR5OwoJICAgIGlmIChfLmlzRnVuY3Rpb24odmFsdWUpKSByZXR1cm4gY3JlYXRlQ2FsbGJhY2sodmFsdWUsIGNvbnRleHQsIGFyZ0NvdW50KTsKCSAgICBpZiAoXy5pc09iamVjdCh2YWx1ZSkpIHJldHVybiBfLm1hdGNoZXModmFsdWUpOwoJICAgIHJldHVybiBfLnByb3BlcnR5KHZhbHVlKTsKCSAgfTsKCgkgIC8vIENvbGxlY3Rpb24gRnVuY3Rpb25zCgkgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tCgoJICAvLyBUaGUgY29ybmVyc3RvbmUsIGFuIGBlYWNoYCBpbXBsZW1lbnRhdGlvbiwgYWthIGBmb3JFYWNoYC4KCSAgLy8gSGFuZGxlcyByYXcgb2JqZWN0cyBpbiBhZGRpdGlvbiB0byBhcnJheS1saWtlcy4gVHJlYXRzIGFsbAoJICAvLyBzcGFyc2UgYXJyYXktbGlrZXMgYXMgaWYgdGhleSB3ZXJlIGRlbnNlLgoJICBfLmVhY2ggPSBfLmZvckVhY2ggPSBmdW5jdGlvbihvYmosIGl0ZXJhdGVlLCBjb250ZXh0KSB7CgkgICAgaWYgKG9iaiA9PSBudWxsKSByZXR1cm4gb2JqOwoJICAgIGl0ZXJhdGVlID0gY3JlYXRlQ2FsbGJhY2soaXRlcmF0ZWUsIGNvbnRleHQpOwoJICAgIHZhciBpLCBsZW5ndGggPSBvYmoubGVuZ3RoOwoJICAgIGlmIChsZW5ndGggPT09ICtsZW5ndGgpIHsKCSAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewoJICAgICAgICBpdGVyYXRlZShvYmpbaV0sIGksIG9iaik7CgkgICAgICB9CgkgICAgfSBlbHNlIHsKCSAgICAgIHZhciBrZXlzID0gXy5rZXlzKG9iaik7CgkgICAgICBmb3IgKGkgPSAwLCBsZW5ndGggPSBrZXlzLmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrKSB7CgkgICAgICAgIGl0ZXJhdGVlKG9ialtrZXlzW2ldXSwga2V5c1tpXSwgb2JqKTsKCSAgICAgIH0KCSAgICB9CgkgICAgcmV0dXJuIG9iajsKCSAgfTsKCgkgIC8vIFJldHVybiB0aGUgcmVzdWx0cyBvZiBhcHBseWluZyB0aGUgaXRlcmF0ZWUgdG8gZWFjaCBlbGVtZW50LgoJICBfLm1hcCA9IF8uY29sbGVjdCA9IGZ1bmN0aW9uKG9iaiwgaXRlcmF0ZWUsIGNvbnRleHQpIHsKCSAgICBpZiAob2JqID09IG51bGwpIHJldHVybiBbXTsKCSAgICBpdGVyYXRlZSA9IF8uaXRlcmF0ZWUoaXRlcmF0ZWUsIGNvbnRleHQpOwoJICAgIHZhciBrZXlzID0gb2JqLmxlbmd0aCAhPT0gK29iai5sZW5ndGggJiYgXy5rZXlzKG9iaiksCgkgICAgICAgIGxlbmd0aCA9IChrZXlzIHx8IG9iaikubGVuZ3RoLAoJICAgICAgICByZXN1bHRzID0gQXJyYXkobGVuZ3RoKSwKCSAgICAgICAgY3VycmVudEtleTsKCSAgICBmb3IgKHZhciBpbmRleCA9IDA7IGluZGV4IDwgbGVuZ3RoOyBpbmRleCsrKSB7CgkgICAgICBjdXJyZW50S2V5ID0ga2V5cyA/IGtleXNbaW5kZXhdIDogaW5kZXg7CgkgICAgICByZXN1bHRzW2luZGV4XSA9IGl0ZXJhdGVlKG9ialtjdXJyZW50S2V5XSwgY3VycmVudEtleSwgb2JqKTsKCSAgICB9CgkgICAgcmV0dXJuIHJlc3VsdHM7CgkgIH07CgoJICB2YXIgcmVkdWNlRXJyb3IgPSAnUmVkdWNlIG9mIGVtcHR5IGFycmF5IHdpdGggbm8gaW5pdGlhbCB2YWx1ZSc7CgoJICAvLyAqKlJlZHVjZSoqIGJ1aWxkcyB1cCBhIHNpbmdsZSByZXN1bHQgZnJvbSBhIGxpc3Qgb2YgdmFsdWVzLCBha2EgYGluamVjdGAsCgkgIC8vIG9yIGBmb2xkbGAuCgkgIF8ucmVkdWNlID0gXy5mb2xkbCA9IF8uaW5qZWN0ID0gZnVuY3Rpb24ob2JqLCBpdGVyYXRlZSwgbWVtbywgY29udGV4dCkgewoJICAgIGlmIChvYmogPT0gbnVsbCkgb2JqID0gW107CgkgICAgaXRlcmF0ZWUgPSBjcmVhdGVDYWxsYmFjayhpdGVyYXRlZSwgY29udGV4dCwgNCk7CgkgICAgdmFyIGtleXMgPSBvYmoubGVuZ3RoICE9PSArb2JqLmxlbmd0aCAmJiBfLmtleXMob2JqKSwKCSAgICAgICAgbGVuZ3RoID0gKGtleXMgfHwgb2JqKS5sZW5ndGgsCgkgICAgICAgIGluZGV4ID0gMCwgY3VycmVudEtleTsKCSAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA8IDMpIHsKCSAgICAgIGlmICghbGVuZ3RoKSB0aHJvdyBuZXcgVHlwZUVycm9yKHJlZHVjZUVycm9yKTsKCSAgICAgIG1lbW8gPSBvYmpba2V5cyA/IGtleXNbaW5kZXgrK10gOiBpbmRleCsrXTsKCSAgICB9CgkgICAgZm9yICg7IGluZGV4IDwgbGVuZ3RoOyBpbmRleCsrKSB7CgkgICAgICBjdXJyZW50S2V5ID0ga2V5cyA/IGtleXNbaW5kZXhdIDogaW5kZXg7CgkgICAgICBtZW1vID0gaXRlcmF0ZWUobWVtbywgb2JqW2N1cnJlbnRLZXldLCBjdXJyZW50S2V5LCBvYmopOwoJICAgIH0KCSAgICByZXR1cm4gbWVtbzsKCSAgfTsKCgkgIC8vIFRoZSByaWdodC1hc3NvY2lhdGl2ZSB2ZXJzaW9uIG9mIHJlZHVjZSwgYWxzbyBrbm93biBhcyBgZm9sZHJgLgoJICBfLnJlZHVjZVJpZ2h0ID0gXy5mb2xkciA9IGZ1bmN0aW9uKG9iaiwgaXRlcmF0ZWUsIG1lbW8sIGNvbnRleHQpIHsKCSAgICBpZiAob2JqID09IG51bGwpIG9iaiA9IFtdOwoJICAgIGl0ZXJhdGVlID0gY3JlYXRlQ2FsbGJhY2soaXRlcmF0ZWUsIGNvbnRleHQsIDQpOwoJICAgIHZhciBrZXlzID0gb2JqLmxlbmd0aCAhPT0gKyBvYmoubGVuZ3RoICYmIF8ua2V5cyhvYmopLAoJICAgICAgICBpbmRleCA9IChrZXlzIHx8IG9iaikubGVuZ3RoLAoJICAgICAgICBjdXJyZW50S2V5OwoJICAgIGlmIChhcmd1bWVudHMubGVuZ3RoIDwgMykgewoJICAgICAgaWYgKCFpbmRleCkgdGhyb3cgbmV3IFR5cGVFcnJvcihyZWR1Y2VFcnJvcik7CgkgICAgICBtZW1vID0gb2JqW2tleXMgPyBrZXlzWy0taW5kZXhdIDogLS1pbmRleF07CgkgICAgfQoJICAgIHdoaWxlIChpbmRleC0tKSB7CgkgICAgICBjdXJyZW50S2V5ID0ga2V5cyA/IGtleXNbaW5kZXhdIDogaW5kZXg7CgkgICAgICBtZW1vID0gaXRlcmF0ZWUobWVtbywgb2JqW2N1cnJlbnRLZXldLCBjdXJyZW50S2V5LCBvYmopOwoJICAgIH0KCSAgICByZXR1cm4gbWVtbzsKCSAgfTsKCgkgIC8vIFJldHVybiB0aGUgZmlyc3QgdmFsdWUgd2hpY2ggcGFzc2VzIGEgdHJ1dGggdGVzdC4gQWxpYXNlZCBhcyBgZGV0ZWN0YC4KCSAgXy5maW5kID0gXy5kZXRlY3QgPSBmdW5jdGlvbihvYmosIHByZWRpY2F0ZSwgY29udGV4dCkgewoJICAgIHZhciByZXN1bHQ7CgkgICAgcHJlZGljYXRlID0gXy5pdGVyYXRlZShwcmVkaWNhdGUsIGNvbnRleHQpOwoJICAgIF8uc29tZShvYmosIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgbGlzdCkgewoJICAgICAgaWYgKHByZWRpY2F0ZSh2YWx1ZSwgaW5kZXgsIGxpc3QpKSB7CgkgICAgICAgIHJlc3VsdCA9IHZhbHVlOwoJICAgICAgICByZXR1cm4gdHJ1ZTsKCSAgICAgIH0KCSAgICB9KTsKCSAgICByZXR1cm4gcmVzdWx0OwoJICB9OwoKCSAgLy8gUmV0dXJuIGFsbCB0aGUgZWxlbWVudHMgdGhhdCBwYXNzIGEgdHJ1dGggdGVzdC4KCSAgLy8gQWxpYXNlZCBhcyBgc2VsZWN0YC4KCSAgXy5maWx0ZXIgPSBfLnNlbGVjdCA9IGZ1bmN0aW9uKG9iaiwgcHJlZGljYXRlLCBjb250ZXh0KSB7CgkgICAgdmFyIHJlc3VsdHMgPSBbXTsKCSAgICBpZiAob2JqID09IG51bGwpIHJldHVybiByZXN1bHRzOwoJICAgIHByZWRpY2F0ZSA9IF8uaXRlcmF0ZWUocHJlZGljYXRlLCBjb250ZXh0KTsKCSAgICBfLmVhY2gob2JqLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGxpc3QpIHsKCSAgICAgIGlmIChwcmVkaWNhdGUodmFsdWUsIGluZGV4LCBsaXN0KSkgcmVzdWx0cy5wdXNoKHZhbHVlKTsKCSAgICB9KTsKCSAgICByZXR1cm4gcmVzdWx0czsKCSAgfTsKCgkgIC8vIFJldHVybiBhbGwgdGhlIGVsZW1lbnRzIGZvciB3aGljaCBhIHRydXRoIHRlc3QgZmFpbHMuCgkgIF8ucmVqZWN0ID0gZnVuY3Rpb24ob2JqLCBwcmVkaWNhdGUsIGNvbnRleHQpIHsKCSAgICByZXR1cm4gXy5maWx0ZXIob2JqLCBfLm5lZ2F0ZShfLml0ZXJhdGVlKHByZWRpY2F0ZSkpLCBjb250ZXh0KTsKCSAgfTsKCgkgIC8vIERldGVybWluZSB3aGV0aGVyIGFsbCBvZiB0aGUgZWxlbWVudHMgbWF0Y2ggYSB0cnV0aCB0ZXN0LgoJICAvLyBBbGlhc2VkIGFzIGBhbGxgLgoJICBfLmV2ZXJ5ID0gXy5hbGwgPSBmdW5jdGlvbihvYmosIHByZWRpY2F0ZSwgY29udGV4dCkgewoJICAgIGlmIChvYmogPT0gbnVsbCkgcmV0dXJuIHRydWU7CgkgICAgcHJlZGljYXRlID0gXy5pdGVyYXRlZShwcmVkaWNhdGUsIGNvbnRleHQpOwoJICAgIHZhciBrZXlzID0gb2JqLmxlbmd0aCAhPT0gK29iai5sZW5ndGggJiYgXy5rZXlzKG9iaiksCgkgICAgICAgIGxlbmd0aCA9IChrZXlzIHx8IG9iaikubGVuZ3RoLAoJICAgICAgICBpbmRleCwgY3VycmVudEtleTsKCSAgICBmb3IgKGluZGV4ID0gMDsgaW5kZXggPCBsZW5ndGg7IGluZGV4KyspIHsKCSAgICAgIGN1cnJlbnRLZXkgPSBrZXlzID8ga2V5c1tpbmRleF0gOiBpbmRleDsKCSAgICAgIGlmICghcHJlZGljYXRlKG9ialtjdXJyZW50S2V5XSwgY3VycmVudEtleSwgb2JqKSkgcmV0dXJuIGZhbHNlOwoJICAgIH0KCSAgICByZXR1cm4gdHJ1ZTsKCSAgfTsKCgkgIC8vIERldGVybWluZSBpZiBhdCBsZWFzdCBvbmUgZWxlbWVudCBpbiB0aGUgb2JqZWN0IG1hdGNoZXMgYSB0cnV0aCB0ZXN0LgoJICAvLyBBbGlhc2VkIGFzIGBhbnlgLgoJICBfLnNvbWUgPSBfLmFueSA9IGZ1bmN0aW9uKG9iaiwgcHJlZGljYXRlLCBjb250ZXh0KSB7CgkgICAgaWYgKG9iaiA9PSBudWxsKSByZXR1cm4gZmFsc2U7CgkgICAgcHJlZGljYXRlID0gXy5pdGVyYXRlZShwcmVkaWNhdGUsIGNvbnRleHQpOwoJICAgIHZhciBrZXlzID0gb2JqLmxlbmd0aCAhPT0gK29iai5sZW5ndGggJiYgXy5rZXlzKG9iaiksCgkgICAgICAgIGxlbmd0aCA9IChrZXlzIHx8IG9iaikubGVuZ3RoLAoJICAgICAgICBpbmRleCwgY3VycmVudEtleTsKCSAgICBmb3IgKGluZGV4ID0gMDsgaW5kZXggPCBsZW5ndGg7IGluZGV4KyspIHsKCSAgICAgIGN1cnJlbnRLZXkgPSBrZXlzID8ga2V5c1tpbmRleF0gOiBpbmRleDsKCSAgICAgIGlmIChwcmVkaWNhdGUob2JqW2N1cnJlbnRLZXldLCBjdXJyZW50S2V5LCBvYmopKSByZXR1cm4gdHJ1ZTsKCSAgICB9CgkgICAgcmV0dXJuIGZhbHNlOwoJICB9OwoKCSAgLy8gRGV0ZXJtaW5lIGlmIHRoZSBhcnJheSBvciBvYmplY3QgY29udGFpbnMgYSBnaXZlbiB2YWx1ZSAodXNpbmcgYD09PWApLgoJICAvLyBBbGlhc2VkIGFzIGBpbmNsdWRlYC4KCSAgXy5jb250YWlucyA9IF8uaW5jbHVkZSA9IGZ1bmN0aW9uKG9iaiwgdGFyZ2V0KSB7CgkgICAgaWYgKG9iaiA9PSBudWxsKSByZXR1cm4gZmFsc2U7CgkgICAgaWYgKG9iai5sZW5ndGggIT09ICtvYmoubGVuZ3RoKSBvYmogPSBfLnZhbHVlcyhvYmopOwoJICAgIHJldHVybiBfLmluZGV4T2Yob2JqLCB0YXJnZXQpID49IDA7CgkgIH07CgoJICAvLyBJbnZva2UgYSBtZXRob2QgKHdpdGggYXJndW1lbnRzKSBvbiBldmVyeSBpdGVtIGluIGEgY29sbGVjdGlvbi4KCSAgXy5pbnZva2UgPSBmdW5jdGlvbihvYmosIG1ldGhvZCkgewoJICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDIpOwoJICAgIHZhciBpc0Z1bmMgPSBfLmlzRnVuY3Rpb24obWV0aG9kKTsKCSAgICByZXR1cm4gXy5tYXAob2JqLCBmdW5jdGlvbih2YWx1ZSkgewoJICAgICAgcmV0dXJuIChpc0Z1bmMgPyBtZXRob2QgOiB2YWx1ZVttZXRob2RdKS5hcHBseSh2YWx1ZSwgYXJncyk7CgkgICAgfSk7CgkgIH07CgoJICAvLyBDb252ZW5pZW5jZSB2ZXJzaW9uIG9mIGEgY29tbW9uIHVzZSBjYXNlIG9mIGBtYXBgOiBmZXRjaGluZyBhIHByb3BlcnR5LgoJICBfLnBsdWNrID0gZnVuY3Rpb24ob2JqLCBrZXkpIHsKCSAgICByZXR1cm4gXy5tYXAob2JqLCBfLnByb3BlcnR5KGtleSkpOwoJICB9OwoKCSAgLy8gQ29udmVuaWVuY2UgdmVyc2lvbiBvZiBhIGNvbW1vbiB1c2UgY2FzZSBvZiBgZmlsdGVyYDogc2VsZWN0aW5nIG9ubHkgb2JqZWN0cwoJICAvLyBjb250YWluaW5nIHNwZWNpZmljIGBrZXk6dmFsdWVgIHBhaXJzLgoJICBfLndoZXJlID0gZnVuY3Rpb24ob2JqLCBhdHRycykgewoJICAgIHJldHVybiBfLmZpbHRlcihvYmosIF8ubWF0Y2hlcyhhdHRycykpOwoJICB9OwoKCSAgLy8gQ29udmVuaWVuY2UgdmVyc2lvbiBvZiBhIGNvbW1vbiB1c2UgY2FzZSBvZiBgZmluZGA6IGdldHRpbmcgdGhlIGZpcnN0IG9iamVjdAoJICAvLyBjb250YWluaW5nIHNwZWNpZmljIGBrZXk6dmFsdWVgIHBhaXJzLgoJICBfLmZpbmRXaGVyZSA9IGZ1bmN0aW9uKG9iaiwgYXR0cnMpIHsKCSAgICByZXR1cm4gXy5maW5kKG9iaiwgXy5tYXRjaGVzKGF0dHJzKSk7CgkgIH07CgoJICAvLyBSZXR1cm4gdGhlIG1heGltdW0gZWxlbWVudCAob3IgZWxlbWVudC1iYXNlZCBjb21wdXRhdGlvbikuCgkgIF8ubWF4ID0gZnVuY3Rpb24ob2JqLCBpdGVyYXRlZSwgY29udGV4dCkgewoJICAgIHZhciByZXN1bHQgPSAtSW5maW5pdHksIGxhc3RDb21wdXRlZCA9IC1JbmZpbml0eSwKCSAgICAgICAgdmFsdWUsIGNvbXB1dGVkOwoJICAgIGlmIChpdGVyYXRlZSA9PSBudWxsICYmIG9iaiAhPSBudWxsKSB7CgkgICAgICBvYmogPSBvYmoubGVuZ3RoID09PSArb2JqLmxlbmd0aCA/IG9iaiA6IF8udmFsdWVzKG9iaik7CgkgICAgICBmb3IgKHZhciBpID0gMCwgbGVuZ3RoID0gb2JqLmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrKSB7CgkgICAgICAgIHZhbHVlID0gb2JqW2ldOwoJICAgICAgICBpZiAodmFsdWUgPiByZXN1bHQpIHsKCSAgICAgICAgICByZXN1bHQgPSB2YWx1ZTsKCSAgICAgICAgfQoJICAgICAgfQoJICAgIH0gZWxzZSB7CgkgICAgICBpdGVyYXRlZSA9IF8uaXRlcmF0ZWUoaXRlcmF0ZWUsIGNvbnRleHQpOwoJICAgICAgXy5lYWNoKG9iaiwgZnVuY3Rpb24odmFsdWUsIGluZGV4LCBsaXN0KSB7CgkgICAgICAgIGNvbXB1dGVkID0gaXRlcmF0ZWUodmFsdWUsIGluZGV4LCBsaXN0KTsKCSAgICAgICAgaWYgKGNvbXB1dGVkID4gbGFzdENvbXB1dGVkIHx8IGNvbXB1dGVkID09PSAtSW5maW5pdHkgJiYgcmVzdWx0ID09PSAtSW5maW5pdHkpIHsKCSAgICAgICAgICByZXN1bHQgPSB2YWx1ZTsKCSAgICAgICAgICBsYXN0Q29tcHV0ZWQgPSBjb21wdXRlZDsKCSAgICAgICAgfQoJICAgICAgfSk7CgkgICAgfQoJICAgIHJldHVybiByZXN1bHQ7CgkgIH07CgoJICAvLyBSZXR1cm4gdGhlIG1pbmltdW0gZWxlbWVudCAob3IgZWxlbWVudC1iYXNlZCBjb21wdXRhdGlvbikuCgkgIF8ubWluID0gZnVuY3Rpb24ob2JqLCBpdGVyYXRlZSwgY29udGV4dCkgewoJICAgIHZhciByZXN1bHQgPSBJbmZpbml0eSwgbGFzdENvbXB1dGVkID0gSW5maW5pdHksCgkgICAgICAgIHZhbHVlLCBjb21wdXRlZDsKCSAgICBpZiAoaXRlcmF0ZWUgPT0gbnVsbCAmJiBvYmogIT0gbnVsbCkgewoJICAgICAgb2JqID0gb2JqLmxlbmd0aCA9PT0gK29iai5sZW5ndGggPyBvYmogOiBfLnZhbHVlcyhvYmopOwoJICAgICAgZm9yICh2YXIgaSA9IDAsIGxlbmd0aCA9IG9iai5sZW5ndGg7IGkgPCBsZW5ndGg7IGkrKykgewoJICAgICAgICB2YWx1ZSA9IG9ialtpXTsKCSAgICAgICAgaWYgKHZhbHVlIDwgcmVzdWx0KSB7CgkgICAgICAgICAgcmVzdWx0ID0gdmFsdWU7CgkgICAgICAgIH0KCSAgICAgIH0KCSAgICB9IGVsc2UgewoJICAgICAgaXRlcmF0ZWUgPSBfLml0ZXJhdGVlKGl0ZXJhdGVlLCBjb250ZXh0KTsKCSAgICAgIF8uZWFjaChvYmosIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgbGlzdCkgewoJICAgICAgICBjb21wdXRlZCA9IGl0ZXJhdGVlKHZhbHVlLCBpbmRleCwgbGlzdCk7CgkgICAgICAgIGlmIChjb21wdXRlZCA8IGxhc3RDb21wdXRlZCB8fCBjb21wdXRlZCA9PT0gSW5maW5pdHkgJiYgcmVzdWx0ID09PSBJbmZpbml0eSkgewoJICAgICAgICAgIHJlc3VsdCA9IHZhbHVlOwoJICAgICAgICAgIGxhc3RDb21wdXRlZCA9IGNvbXB1dGVkOwoJICAgICAgICB9CgkgICAgICB9KTsKCSAgICB9CgkgICAgcmV0dXJuIHJlc3VsdDsKCSAgfTsKCgkgIC8vIFNodWZmbGUgYSBjb2xsZWN0aW9uLCB1c2luZyB0aGUgbW9kZXJuIHZlcnNpb24gb2YgdGhlCgkgIC8vIFtGaXNoZXItWWF0ZXMgc2h1ZmZsZV0oaHR0cDovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9GaXNoZXLigJNZYXRlc19zaHVmZmxlKS4KCSAgXy5zaHVmZmxlID0gZnVuY3Rpb24ob2JqKSB7CgkgICAgdmFyIHNldCA9IG9iaiAmJiBvYmoubGVuZ3RoID09PSArb2JqLmxlbmd0aCA/IG9iaiA6IF8udmFsdWVzKG9iaik7CgkgICAgdmFyIGxlbmd0aCA9IHNldC5sZW5ndGg7CgkgICAgdmFyIHNodWZmbGVkID0gQXJyYXkobGVuZ3RoKTsKCSAgICBmb3IgKHZhciBpbmRleCA9IDAsIHJhbmQ7IGluZGV4IDwgbGVuZ3RoOyBpbmRleCsrKSB7CgkgICAgICByYW5kID0gXy5yYW5kb20oMCwgaW5kZXgpOwoJICAgICAgaWYgKHJhbmQgIT09IGluZGV4KSBzaHVmZmxlZFtpbmRleF0gPSBzaHVmZmxlZFtyYW5kXTsKCSAgICAgIHNodWZmbGVkW3JhbmRdID0gc2V0W2luZGV4XTsKCSAgICB9CgkgICAgcmV0dXJuIHNodWZmbGVkOwoJICB9OwoKCSAgLy8gU2FtcGxlICoqbioqIHJhbmRvbSB2YWx1ZXMgZnJvbSBhIGNvbGxlY3Rpb24uCgkgIC8vIElmICoqbioqIGlzIG5vdCBzcGVjaWZpZWQsIHJldHVybnMgYSBzaW5nbGUgcmFuZG9tIGVsZW1lbnQuCgkgIC8vIFRoZSBpbnRlcm5hbCBgZ3VhcmRgIGFyZ3VtZW50IGFsbG93cyBpdCB0byB3b3JrIHdpdGggYG1hcGAuCgkgIF8uc2FtcGxlID0gZnVuY3Rpb24ob2JqLCBuLCBndWFyZCkgewoJICAgIGlmIChuID09IG51bGwgfHwgZ3VhcmQpIHsKCSAgICAgIGlmIChvYmoubGVuZ3RoICE9PSArb2JqLmxlbmd0aCkgb2JqID0gXy52YWx1ZXMob2JqKTsKCSAgICAgIHJldHVybiBvYmpbXy5yYW5kb20ob2JqLmxlbmd0aCAtIDEpXTsKCSAgICB9CgkgICAgcmV0dXJuIF8uc2h1ZmZsZShvYmopLnNsaWNlKDAsIE1hdGgubWF4KDAsIG4pKTsKCSAgfTsKCgkgIC8vIFNvcnQgdGhlIG9iamVjdCdzIHZhbHVlcyBieSBhIGNyaXRlcmlvbiBwcm9kdWNlZCBieSBhbiBpdGVyYXRlZS4KCSAgXy5zb3J0QnkgPSBmdW5jdGlvbihvYmosIGl0ZXJhdGVlLCBjb250ZXh0KSB7CgkgICAgaXRlcmF0ZWUgPSBfLml0ZXJhdGVlKGl0ZXJhdGVlLCBjb250ZXh0KTsKCSAgICByZXR1cm4gXy5wbHVjayhfLm1hcChvYmosIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgbGlzdCkgewoJICAgICAgcmV0dXJuIHsKCSAgICAgICAgdmFsdWU6IHZhbHVlLAoJICAgICAgICBpbmRleDogaW5kZXgsCgkgICAgICAgIGNyaXRlcmlhOiBpdGVyYXRlZSh2YWx1ZSwgaW5kZXgsIGxpc3QpCgkgICAgICB9OwoJICAgIH0pLnNvcnQoZnVuY3Rpb24obGVmdCwgcmlnaHQpIHsKCSAgICAgIHZhciBhID0gbGVmdC5jcml0ZXJpYTsKCSAgICAgIHZhciBiID0gcmlnaHQuY3JpdGVyaWE7CgkgICAgICBpZiAoYSAhPT0gYikgewoJICAgICAgICBpZiAoYSA+IGIgfHwgYSA9PT0gdm9pZCAwKSByZXR1cm4gMTsKCSAgICAgICAgaWYgKGEgPCBiIHx8IGIgPT09IHZvaWQgMCkgcmV0dXJuIC0xOwoJICAgICAgfQoJICAgICAgcmV0dXJuIGxlZnQuaW5kZXggLSByaWdodC5pbmRleDsKCSAgICB9KSwgJ3ZhbHVlJyk7CgkgIH07CgoJICAvLyBBbiBpbnRlcm5hbCBmdW5jdGlvbiB1c2VkIGZvciBhZ2dyZWdhdGUgImdyb3VwIGJ5IiBvcGVyYXRpb25zLgoJICB2YXIgZ3JvdXAgPSBmdW5jdGlvbihiZWhhdmlvcikgewoJICAgIHJldHVybiBmdW5jdGlvbihvYmosIGl0ZXJhdGVlLCBjb250ZXh0KSB7CgkgICAgICB2YXIgcmVzdWx0ID0ge307CgkgICAgICBpdGVyYXRlZSA9IF8uaXRlcmF0ZWUoaXRlcmF0ZWUsIGNvbnRleHQpOwoJICAgICAgXy5lYWNoKG9iaiwgZnVuY3Rpb24odmFsdWUsIGluZGV4KSB7CgkgICAgICAgIHZhciBrZXkgPSBpdGVyYXRlZSh2YWx1ZSwgaW5kZXgsIG9iaik7CgkgICAgICAgIGJlaGF2aW9yKHJlc3VsdCwgdmFsdWUsIGtleSk7CgkgICAgICB9KTsKCSAgICAgIHJldHVybiByZXN1bHQ7CgkgICAgfTsKCSAgfTsKCgkgIC8vIEdyb3VwcyB0aGUgb2JqZWN0J3MgdmFsdWVzIGJ5IGEgY3JpdGVyaW9uLiBQYXNzIGVpdGhlciBhIHN0cmluZyBhdHRyaWJ1dGUKCSAgLy8gdG8gZ3JvdXAgYnksIG9yIGEgZnVuY3Rpb24gdGhhdCByZXR1cm5zIHRoZSBjcml0ZXJpb24uCgkgIF8uZ3JvdXBCeSA9IGdyb3VwKGZ1bmN0aW9uKHJlc3VsdCwgdmFsdWUsIGtleSkgewoJICAgIGlmIChfLmhhcyhyZXN1bHQsIGtleSkpIHJlc3VsdFtrZXldLnB1c2godmFsdWUpOyBlbHNlIHJlc3VsdFtrZXldID0gW3ZhbHVlXTsKCSAgfSk7CgoJICAvLyBJbmRleGVzIHRoZSBvYmplY3QncyB2YWx1ZXMgYnkgYSBjcml0ZXJpb24sIHNpbWlsYXIgdG8gYGdyb3VwQnlgLCBidXQgZm9yCgkgIC8vIHdoZW4geW91IGtub3cgdGhhdCB5b3VyIGluZGV4IHZhbHVlcyB3aWxsIGJlIHVuaXF1ZS4KCSAgXy5pbmRleEJ5ID0gZ3JvdXAoZnVuY3Rpb24ocmVzdWx0LCB2YWx1ZSwga2V5KSB7CgkgICAgcmVzdWx0W2tleV0gPSB2YWx1ZTsKCSAgfSk7CgoJICAvLyBDb3VudHMgaW5zdGFuY2VzIG9mIGFuIG9iamVjdCB0aGF0IGdyb3VwIGJ5IGEgY2VydGFpbiBjcml0ZXJpb24uIFBhc3MKCSAgLy8gZWl0aGVyIGEgc3RyaW5nIGF0dHJpYnV0ZSB0byBjb3VudCBieSwgb3IgYSBmdW5jdGlvbiB0aGF0IHJldHVybnMgdGhlCgkgIC8vIGNyaXRlcmlvbi4KCSAgXy5jb3VudEJ5ID0gZ3JvdXAoZnVuY3Rpb24ocmVzdWx0LCB2YWx1ZSwga2V5KSB7CgkgICAgaWYgKF8uaGFzKHJlc3VsdCwga2V5KSkgcmVzdWx0W2tleV0rKzsgZWxzZSByZXN1bHRba2V5XSA9IDE7CgkgIH0pOwoKCSAgLy8gVXNlIGEgY29tcGFyYXRvciBmdW5jdGlvbiB0byBmaWd1cmUgb3V0IHRoZSBzbWFsbGVzdCBpbmRleCBhdCB3aGljaAoJICAvLyBhbiBvYmplY3Qgc2hvdWxkIGJlIGluc2VydGVkIHNvIGFzIHRvIG1haW50YWluIG9yZGVyLiBVc2VzIGJpbmFyeSBzZWFyY2guCgkgIF8uc29ydGVkSW5kZXggPSBmdW5jdGlvbihhcnJheSwgb2JqLCBpdGVyYXRlZSwgY29udGV4dCkgewoJICAgIGl0ZXJhdGVlID0gXy5pdGVyYXRlZShpdGVyYXRlZSwgY29udGV4dCwgMSk7CgkgICAgdmFyIHZhbHVlID0gaXRlcmF0ZWUob2JqKTsKCSAgICB2YXIgbG93ID0gMCwgaGlnaCA9IGFycmF5Lmxlbmd0aDsKCSAgICB3aGlsZSAobG93IDwgaGlnaCkgewoJICAgICAgdmFyIG1pZCA9IGxvdyArIGhpZ2ggPj4+IDE7CgkgICAgICBpZiAoaXRlcmF0ZWUoYXJyYXlbbWlkXSkgPCB2YWx1ZSkgbG93ID0gbWlkICsgMTsgZWxzZSBoaWdoID0gbWlkOwoJICAgIH0KCSAgICByZXR1cm4gbG93OwoJICB9OwoKCSAgLy8gU2FmZWx5IGNyZWF0ZSBhIHJlYWwsIGxpdmUgYXJyYXkgZnJvbSBhbnl0aGluZyBpdGVyYWJsZS4KCSAgXy50b0FycmF5ID0gZnVuY3Rpb24ob2JqKSB7CgkgICAgaWYgKCFvYmopIHJldHVybiBbXTsKCSAgICBpZiAoXy5pc0FycmF5KG9iaikpIHJldHVybiBzbGljZS5jYWxsKG9iaik7CgkgICAgaWYgKG9iai5sZW5ndGggPT09ICtvYmoubGVuZ3RoKSByZXR1cm4gXy5tYXAob2JqLCBfLmlkZW50aXR5KTsKCSAgICByZXR1cm4gXy52YWx1ZXMob2JqKTsKCSAgfTsKCgkgIC8vIFJldHVybiB0aGUgbnVtYmVyIG9mIGVsZW1lbnRzIGluIGFuIG9iamVjdC4KCSAgXy5zaXplID0gZnVuY3Rpb24ob2JqKSB7CgkgICAgaWYgKG9iaiA9PSBudWxsKSByZXR1cm4gMDsKCSAgICByZXR1cm4gb2JqLmxlbmd0aCA9PT0gK29iai5sZW5ndGggPyBvYmoubGVuZ3RoIDogXy5rZXlzKG9iaikubGVuZ3RoOwoJICB9OwoKCSAgLy8gU3BsaXQgYSBjb2xsZWN0aW9uIGludG8gdHdvIGFycmF5czogb25lIHdob3NlIGVsZW1lbnRzIGFsbCBzYXRpc2Z5IHRoZSBnaXZlbgoJICAvLyBwcmVkaWNhdGUsIGFuZCBvbmUgd2hvc2UgZWxlbWVudHMgYWxsIGRvIG5vdCBzYXRpc2Z5IHRoZSBwcmVkaWNhdGUuCgkgIF8ucGFydGl0aW9uID0gZnVuY3Rpb24ob2JqLCBwcmVkaWNhdGUsIGNvbnRleHQpIHsKCSAgICBwcmVkaWNhdGUgPSBfLml0ZXJhdGVlKHByZWRpY2F0ZSwgY29udGV4dCk7CgkgICAgdmFyIHBhc3MgPSBbXSwgZmFpbCA9IFtdOwoJICAgIF8uZWFjaChvYmosIGZ1bmN0aW9uKHZhbHVlLCBrZXksIG9iaikgewoJICAgICAgKHByZWRpY2F0ZSh2YWx1ZSwga2V5LCBvYmopID8gcGFzcyA6IGZhaWwpLnB1c2godmFsdWUpOwoJICAgIH0pOwoJICAgIHJldHVybiBbcGFzcywgZmFpbF07CgkgIH07CgoJICAvLyBBcnJheSBGdW5jdGlvbnMKCSAgLy8gLS0tLS0tLS0tLS0tLS0tCgoJICAvLyBHZXQgdGhlIGZpcnN0IGVsZW1lbnQgb2YgYW4gYXJyYXkuIFBhc3NpbmcgKipuKiogd2lsbCByZXR1cm4gdGhlIGZpcnN0IE4KCSAgLy8gdmFsdWVzIGluIHRoZSBhcnJheS4gQWxpYXNlZCBhcyBgaGVhZGAgYW5kIGB0YWtlYC4gVGhlICoqZ3VhcmQqKiBjaGVjawoJICAvLyBhbGxvd3MgaXQgdG8gd29yayB3aXRoIGBfLm1hcGAuCgkgIF8uZmlyc3QgPSBfLmhlYWQgPSBfLnRha2UgPSBmdW5jdGlvbihhcnJheSwgbiwgZ3VhcmQpIHsKCSAgICBpZiAoYXJyYXkgPT0gbnVsbCkgcmV0dXJuIHZvaWQgMDsKCSAgICBpZiAobiA9PSBudWxsIHx8IGd1YXJkKSByZXR1cm4gYXJyYXlbMF07CgkgICAgaWYgKG4gPCAwKSByZXR1cm4gW107CgkgICAgcmV0dXJuIHNsaWNlLmNhbGwoYXJyYXksIDAsIG4pOwoJICB9OwoKCSAgLy8gUmV0dXJucyBldmVyeXRoaW5nIGJ1dCB0aGUgbGFzdCBlbnRyeSBvZiB0aGUgYXJyYXkuIEVzcGVjaWFsbHkgdXNlZnVsIG9uCgkgIC8vIHRoZSBhcmd1bWVudHMgb2JqZWN0LiBQYXNzaW5nICoqbioqIHdpbGwgcmV0dXJuIGFsbCB0aGUgdmFsdWVzIGluCgkgIC8vIHRoZSBhcnJheSwgZXhjbHVkaW5nIHRoZSBsYXN0IE4uIFRoZSAqKmd1YXJkKiogY2hlY2sgYWxsb3dzIGl0IHRvIHdvcmsgd2l0aAoJICAvLyBgXy5tYXBgLgoJICBfLmluaXRpYWwgPSBmdW5jdGlvbihhcnJheSwgbiwgZ3VhcmQpIHsKCSAgICByZXR1cm4gc2xpY2UuY2FsbChhcnJheSwgMCwgTWF0aC5tYXgoMCwgYXJyYXkubGVuZ3RoIC0gKG4gPT0gbnVsbCB8fCBndWFyZCA/IDEgOiBuKSkpOwoJICB9OwoKCSAgLy8gR2V0IHRoZSBsYXN0IGVsZW1lbnQgb2YgYW4gYXJyYXkuIFBhc3NpbmcgKipuKiogd2lsbCByZXR1cm4gdGhlIGxhc3QgTgoJICAvLyB2YWx1ZXMgaW4gdGhlIGFycmF5LiBUaGUgKipndWFyZCoqIGNoZWNrIGFsbG93cyBpdCB0byB3b3JrIHdpdGggYF8ubWFwYC4KCSAgXy5sYXN0ID0gZnVuY3Rpb24oYXJyYXksIG4sIGd1YXJkKSB7CgkgICAgaWYgKGFycmF5ID09IG51bGwpIHJldHVybiB2b2lkIDA7CgkgICAgaWYgKG4gPT0gbnVsbCB8fCBndWFyZCkgcmV0dXJuIGFycmF5W2FycmF5Lmxlbmd0aCAtIDFdOwoJICAgIHJldHVybiBzbGljZS5jYWxsKGFycmF5LCBNYXRoLm1heChhcnJheS5sZW5ndGggLSBuLCAwKSk7CgkgIH07CgoJICAvLyBSZXR1cm5zIGV2ZXJ5dGhpbmcgYnV0IHRoZSBmaXJzdCBlbnRyeSBvZiB0aGUgYXJyYXkuIEFsaWFzZWQgYXMgYHRhaWxgIGFuZCBgZHJvcGAuCgkgIC8vIEVzcGVjaWFsbHkgdXNlZnVsIG9uIHRoZSBhcmd1bWVudHMgb2JqZWN0LiBQYXNzaW5nIGFuICoqbioqIHdpbGwgcmV0dXJuCgkgIC8vIHRoZSByZXN0IE4gdmFsdWVzIGluIHRoZSBhcnJheS4gVGhlICoqZ3VhcmQqKgoJICAvLyBjaGVjayBhbGxvd3MgaXQgdG8gd29yayB3aXRoIGBfLm1hcGAuCgkgIF8ucmVzdCA9IF8udGFpbCA9IF8uZHJvcCA9IGZ1bmN0aW9uKGFycmF5LCBuLCBndWFyZCkgewoJICAgIHJldHVybiBzbGljZS5jYWxsKGFycmF5LCBuID09IG51bGwgfHwgZ3VhcmQgPyAxIDogbik7CgkgIH07CgoJICAvLyBUcmltIG91dCBhbGwgZmFsc3kgdmFsdWVzIGZyb20gYW4gYXJyYXkuCgkgIF8uY29tcGFjdCA9IGZ1bmN0aW9uKGFycmF5KSB7CgkgICAgcmV0dXJuIF8uZmlsdGVyKGFycmF5LCBfLmlkZW50aXR5KTsKCSAgfTsKCgkgIC8vIEludGVybmFsIGltcGxlbWVudGF0aW9uIG9mIGEgcmVjdXJzaXZlIGBmbGF0dGVuYCBmdW5jdGlvbi4KCSAgdmFyIGZsYXR0ZW4gPSBmdW5jdGlvbihpbnB1dCwgc2hhbGxvdywgc3RyaWN0LCBvdXRwdXQpIHsKCSAgICBpZiAoc2hhbGxvdyAmJiBfLmV2ZXJ5KGlucHV0LCBfLmlzQXJyYXkpKSB7CgkgICAgICByZXR1cm4gY29uY2F0LmFwcGx5KG91dHB1dCwgaW5wdXQpOwoJICAgIH0KCSAgICBmb3IgKHZhciBpID0gMCwgbGVuZ3RoID0gaW5wdXQubGVuZ3RoOyBpIDwgbGVuZ3RoOyBpKyspIHsKCSAgICAgIHZhciB2YWx1ZSA9IGlucHV0W2ldOwoJICAgICAgaWYgKCFfLmlzQXJyYXkodmFsdWUpICYmICFfLmlzQXJndW1lbnRzKHZhbHVlKSkgewoJICAgICAgICBpZiAoIXN0cmljdCkgb3V0cHV0LnB1c2godmFsdWUpOwoJICAgICAgfSBlbHNlIGlmIChzaGFsbG93KSB7CgkgICAgICAgIHB1c2guYXBwbHkob3V0cHV0LCB2YWx1ZSk7CgkgICAgICB9IGVsc2UgewoJICAgICAgICBmbGF0dGVuKHZhbHVlLCBzaGFsbG93LCBzdHJpY3QsIG91dHB1dCk7CgkgICAgICB9CgkgICAgfQoJICAgIHJldHVybiBvdXRwdXQ7CgkgIH07CgoJICAvLyBGbGF0dGVuIG91dCBhbiBhcnJheSwgZWl0aGVyIHJlY3Vyc2l2ZWx5IChieSBkZWZhdWx0KSwgb3IganVzdCBvbmUgbGV2ZWwuCgkgIF8uZmxhdHRlbiA9IGZ1bmN0aW9uKGFycmF5LCBzaGFsbG93KSB7CgkgICAgcmV0dXJuIGZsYXR0ZW4oYXJyYXksIHNoYWxsb3csIGZhbHNlLCBbXSk7CgkgIH07CgoJICAvLyBSZXR1cm4gYSB2ZXJzaW9uIG9mIHRoZSBhcnJheSB0aGF0IGRvZXMgbm90IGNvbnRhaW4gdGhlIHNwZWNpZmllZCB2YWx1ZShzKS4KCSAgXy53aXRob3V0ID0gZnVuY3Rpb24oYXJyYXkpIHsKCSAgICByZXR1cm4gXy5kaWZmZXJlbmNlKGFycmF5LCBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSkpOwoJICB9OwoKCSAgLy8gUHJvZHVjZSBhIGR1cGxpY2F0ZS1mcmVlIHZlcnNpb24gb2YgdGhlIGFycmF5LiBJZiB0aGUgYXJyYXkgaGFzIGFscmVhZHkKCSAgLy8gYmVlbiBzb3J0ZWQsIHlvdSBoYXZlIHRoZSBvcHRpb24gb2YgdXNpbmcgYSBmYXN0ZXIgYWxnb3JpdGhtLgoJICAvLyBBbGlhc2VkIGFzIGB1bmlxdWVgLgoJICBfLnVuaXEgPSBfLnVuaXF1ZSA9IGZ1bmN0aW9uKGFycmF5LCBpc1NvcnRlZCwgaXRlcmF0ZWUsIGNvbnRleHQpIHsKCSAgICBpZiAoYXJyYXkgPT0gbnVsbCkgcmV0dXJuIFtdOwoJICAgIGlmICghXy5pc0Jvb2xlYW4oaXNTb3J0ZWQpKSB7CgkgICAgICBjb250ZXh0ID0gaXRlcmF0ZWU7CgkgICAgICBpdGVyYXRlZSA9IGlzU29ydGVkOwoJICAgICAgaXNTb3J0ZWQgPSBmYWxzZTsKCSAgICB9CgkgICAgaWYgKGl0ZXJhdGVlICE9IG51bGwpIGl0ZXJhdGVlID0gXy5pdGVyYXRlZShpdGVyYXRlZSwgY29udGV4dCk7CgkgICAgdmFyIHJlc3VsdCA9IFtdOwoJICAgIHZhciBzZWVuID0gW107CgkgICAgZm9yICh2YXIgaSA9IDAsIGxlbmd0aCA9IGFycmF5Lmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrKSB7CgkgICAgICB2YXIgdmFsdWUgPSBhcnJheVtpXTsKCSAgICAgIGlmIChpc1NvcnRlZCkgewoJICAgICAgICBpZiAoIWkgfHwgc2VlbiAhPT0gdmFsdWUpIHJlc3VsdC5wdXNoKHZhbHVlKTsKCSAgICAgICAgc2VlbiA9IHZhbHVlOwoJICAgICAgfSBlbHNlIGlmIChpdGVyYXRlZSkgewoJICAgICAgICB2YXIgY29tcHV0ZWQgPSBpdGVyYXRlZSh2YWx1ZSwgaSwgYXJyYXkpOwoJICAgICAgICBpZiAoXy5pbmRleE9mKHNlZW4sIGNvbXB1dGVkKSA8IDApIHsKCSAgICAgICAgICBzZWVuLnB1c2goY29tcHV0ZWQpOwoJICAgICAgICAgIHJlc3VsdC5wdXNoKHZhbHVlKTsKCSAgICAgICAgfQoJICAgICAgfSBlbHNlIGlmIChfLmluZGV4T2YocmVzdWx0LCB2YWx1ZSkgPCAwKSB7CgkgICAgICAgIHJlc3VsdC5wdXNoKHZhbHVlKTsKCSAgICAgIH0KCSAgICB9CgkgICAgcmV0dXJuIHJlc3VsdDsKCSAgfTsKCgkgIC8vIFByb2R1Y2UgYW4gYXJyYXkgdGhhdCBjb250YWlucyB0aGUgdW5pb246IGVhY2ggZGlzdGluY3QgZWxlbWVudCBmcm9tIGFsbCBvZgoJICAvLyB0aGUgcGFzc2VkLWluIGFycmF5cy4KCSAgXy51bmlvbiA9IGZ1bmN0aW9uKCkgewoJICAgIHJldHVybiBfLnVuaXEoZmxhdHRlbihhcmd1bWVudHMsIHRydWUsIHRydWUsIFtdKSk7CgkgIH07CgoJICAvLyBQcm9kdWNlIGFuIGFycmF5IHRoYXQgY29udGFpbnMgZXZlcnkgaXRlbSBzaGFyZWQgYmV0d2VlbiBhbGwgdGhlCgkgIC8vIHBhc3NlZC1pbiBhcnJheXMuCgkgIF8uaW50ZXJzZWN0aW9uID0gZnVuY3Rpb24oYXJyYXkpIHsKCSAgICBpZiAoYXJyYXkgPT0gbnVsbCkgcmV0dXJuIFtdOwoJICAgIHZhciByZXN1bHQgPSBbXTsKCSAgICB2YXIgYXJnc0xlbmd0aCA9IGFyZ3VtZW50cy5sZW5ndGg7CgkgICAgZm9yICh2YXIgaSA9IDAsIGxlbmd0aCA9IGFycmF5Lmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrKSB7CgkgICAgICB2YXIgaXRlbSA9IGFycmF5W2ldOwoJICAgICAgaWYgKF8uY29udGFpbnMocmVzdWx0LCBpdGVtKSkgY29udGludWU7CgkgICAgICBmb3IgKHZhciBqID0gMTsgaiA8IGFyZ3NMZW5ndGg7IGorKykgewoJICAgICAgICBpZiAoIV8uY29udGFpbnMoYXJndW1lbnRzW2pdLCBpdGVtKSkgYnJlYWs7CgkgICAgICB9CgkgICAgICBpZiAoaiA9PT0gYXJnc0xlbmd0aCkgcmVzdWx0LnB1c2goaXRlbSk7CgkgICAgfQoJICAgIHJldHVybiByZXN1bHQ7CgkgIH07CgoJICAvLyBUYWtlIHRoZSBkaWZmZXJlbmNlIGJldHdlZW4gb25lIGFycmF5IGFuZCBhIG51bWJlciBvZiBvdGhlciBhcnJheXMuCgkgIC8vIE9ubHkgdGhlIGVsZW1lbnRzIHByZXNlbnQgaW4ganVzdCB0aGUgZmlyc3QgYXJyYXkgd2lsbCByZW1haW4uCgkgIF8uZGlmZmVyZW5jZSA9IGZ1bmN0aW9uKGFycmF5KSB7CgkgICAgdmFyIHJlc3QgPSBmbGF0dGVuKHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSwgdHJ1ZSwgdHJ1ZSwgW10pOwoJICAgIHJldHVybiBfLmZpbHRlcihhcnJheSwgZnVuY3Rpb24odmFsdWUpewoJICAgICAgcmV0dXJuICFfLmNvbnRhaW5zKHJlc3QsIHZhbHVlKTsKCSAgICB9KTsKCSAgfTsKCgkgIC8vIFppcCB0b2dldGhlciBtdWx0aXBsZSBsaXN0cyBpbnRvIGEgc2luZ2xlIGFycmF5IC0tIGVsZW1lbnRzIHRoYXQgc2hhcmUKCSAgLy8gYW4gaW5kZXggZ28gdG9nZXRoZXIuCgkgIF8uemlwID0gZnVuY3Rpb24oYXJyYXkpIHsKCSAgICBpZiAoYXJyYXkgPT0gbnVsbCkgcmV0dXJuIFtdOwoJICAgIHZhciBsZW5ndGggPSBfLm1heChhcmd1bWVudHMsICdsZW5ndGgnKS5sZW5ndGg7CgkgICAgdmFyIHJlc3VsdHMgPSBBcnJheShsZW5ndGgpOwoJICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKCSAgICAgIHJlc3VsdHNbaV0gPSBfLnBsdWNrKGFyZ3VtZW50cywgaSk7CgkgICAgfQoJICAgIHJldHVybiByZXN1bHRzOwoJICB9OwoKCSAgLy8gQ29udmVydHMgbGlzdHMgaW50byBvYmplY3RzLiBQYXNzIGVpdGhlciBhIHNpbmdsZSBhcnJheSBvZiBgW2tleSwgdmFsdWVdYAoJICAvLyBwYWlycywgb3IgdHdvIHBhcmFsbGVsIGFycmF5cyBvZiB0aGUgc2FtZSBsZW5ndGggLS0gb25lIG9mIGtleXMsIGFuZCBvbmUgb2YKCSAgLy8gdGhlIGNvcnJlc3BvbmRpbmcgdmFsdWVzLgoJICBfLm9iamVjdCA9IGZ1bmN0aW9uKGxpc3QsIHZhbHVlcykgewoJICAgIGlmIChsaXN0ID09IG51bGwpIHJldHVybiB7fTsKCSAgICB2YXIgcmVzdWx0ID0ge307CgkgICAgZm9yICh2YXIgaSA9IDAsIGxlbmd0aCA9IGxpc3QubGVuZ3RoOyBpIDwgbGVuZ3RoOyBpKyspIHsKCSAgICAgIGlmICh2YWx1ZXMpIHsKCSAgICAgICAgcmVzdWx0W2xpc3RbaV1dID0gdmFsdWVzW2ldOwoJICAgICAgfSBlbHNlIHsKCSAgICAgICAgcmVzdWx0W2xpc3RbaV1bMF1dID0gbGlzdFtpXVsxXTsKCSAgICAgIH0KCSAgICB9CgkgICAgcmV0dXJuIHJlc3VsdDsKCSAgfTsKCgkgIC8vIFJldHVybiB0aGUgcG9zaXRpb24gb2YgdGhlIGZpcnN0IG9jY3VycmVuY2Ugb2YgYW4gaXRlbSBpbiBhbiBhcnJheSwKCSAgLy8gb3IgLTEgaWYgdGhlIGl0ZW0gaXMgbm90IGluY2x1ZGVkIGluIHRoZSBhcnJheS4KCSAgLy8gSWYgdGhlIGFycmF5IGlzIGxhcmdlIGFuZCBhbHJlYWR5IGluIHNvcnQgb3JkZXIsIHBhc3MgYHRydWVgCgkgIC8vIGZvciAqKmlzU29ydGVkKiogdG8gdXNlIGJpbmFyeSBzZWFyY2guCgkgIF8uaW5kZXhPZiA9IGZ1bmN0aW9uKGFycmF5LCBpdGVtLCBpc1NvcnRlZCkgewoJICAgIGlmIChhcnJheSA9PSBudWxsKSByZXR1cm4gLTE7CgkgICAgdmFyIGkgPSAwLCBsZW5ndGggPSBhcnJheS5sZW5ndGg7CgkgICAgaWYgKGlzU29ydGVkKSB7CgkgICAgICBpZiAodHlwZW9mIGlzU29ydGVkID09ICdudW1iZXInKSB7CgkgICAgICAgIGkgPSBpc1NvcnRlZCA8IDAgPyBNYXRoLm1heCgwLCBsZW5ndGggKyBpc1NvcnRlZCkgOiBpc1NvcnRlZDsKCSAgICAgIH0gZWxzZSB7CgkgICAgICAgIGkgPSBfLnNvcnRlZEluZGV4KGFycmF5LCBpdGVtKTsKCSAgICAgICAgcmV0dXJuIGFycmF5W2ldID09PSBpdGVtID8gaSA6IC0xOwoJICAgICAgfQoJICAgIH0KCSAgICBmb3IgKDsgaSA8IGxlbmd0aDsgaSsrKSBpZiAoYXJyYXlbaV0gPT09IGl0ZW0pIHJldHVybiBpOwoJICAgIHJldHVybiAtMTsKCSAgfTsKCgkgIF8ubGFzdEluZGV4T2YgPSBmdW5jdGlvbihhcnJheSwgaXRlbSwgZnJvbSkgewoJICAgIGlmIChhcnJheSA9PSBudWxsKSByZXR1cm4gLTE7CgkgICAgdmFyIGlkeCA9IGFycmF5Lmxlbmd0aDsKCSAgICBpZiAodHlwZW9mIGZyb20gPT0gJ251bWJlcicpIHsKCSAgICAgIGlkeCA9IGZyb20gPCAwID8gaWR4ICsgZnJvbSArIDEgOiBNYXRoLm1pbihpZHgsIGZyb20gKyAxKTsKCSAgICB9CgkgICAgd2hpbGUgKC0taWR4ID49IDApIGlmIChhcnJheVtpZHhdID09PSBpdGVtKSByZXR1cm4gaWR4OwoJICAgIHJldHVybiAtMTsKCSAgfTsKCgkgIC8vIEdlbmVyYXRlIGFuIGludGVnZXIgQXJyYXkgY29udGFpbmluZyBhbiBhcml0aG1ldGljIHByb2dyZXNzaW9uLiBBIHBvcnQgb2YKCSAgLy8gdGhlIG5hdGl2ZSBQeXRob24gYHJhbmdlKClgIGZ1bmN0aW9uLiBTZWUKCSAgLy8gW3RoZSBQeXRob24gZG9jdW1lbnRhdGlvbl0oaHR0cDovL2RvY3MucHl0aG9uLm9yZy9saWJyYXJ5L2Z1bmN0aW9ucy5odG1sI3JhbmdlKS4KCSAgXy5yYW5nZSA9IGZ1bmN0aW9uKHN0YXJ0LCBzdG9wLCBzdGVwKSB7CgkgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPD0gMSkgewoJICAgICAgc3RvcCA9IHN0YXJ0IHx8IDA7CgkgICAgICBzdGFydCA9IDA7CgkgICAgfQoJICAgIHN0ZXAgPSBzdGVwIHx8IDE7CgoJICAgIHZhciBsZW5ndGggPSBNYXRoLm1heChNYXRoLmNlaWwoKHN0b3AgLSBzdGFydCkgLyBzdGVwKSwgMCk7CgkgICAgdmFyIHJhbmdlID0gQXJyYXkobGVuZ3RoKTsKCgkgICAgZm9yICh2YXIgaWR4ID0gMDsgaWR4IDwgbGVuZ3RoOyBpZHgrKywgc3RhcnQgKz0gc3RlcCkgewoJICAgICAgcmFuZ2VbaWR4XSA9IHN0YXJ0OwoJICAgIH0KCgkgICAgcmV0dXJuIHJhbmdlOwoJICB9OwoKCSAgLy8gRnVuY3Rpb24gKGFoZW0pIEZ1bmN0aW9ucwoJICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0KCgkgIC8vIFJldXNhYmxlIGNvbnN0cnVjdG9yIGZ1bmN0aW9uIGZvciBwcm90b3R5cGUgc2V0dGluZy4KCSAgdmFyIEN0b3IgPSBmdW5jdGlvbigpe307CgoJICAvLyBDcmVhdGUgYSBmdW5jdGlvbiBib3VuZCB0byBhIGdpdmVuIG9iamVjdCAoYXNzaWduaW5nIGB0aGlzYCwgYW5kIGFyZ3VtZW50cywKCSAgLy8gb3B0aW9uYWxseSkuIERlbGVnYXRlcyB0byAqKkVDTUFTY3JpcHQgNSoqJ3MgbmF0aXZlIGBGdW5jdGlvbi5iaW5kYCBpZgoJICAvLyBhdmFpbGFibGUuCgkgIF8uYmluZCA9IGZ1bmN0aW9uKGZ1bmMsIGNvbnRleHQpIHsKCSAgICB2YXIgYXJncywgYm91bmQ7CgkgICAgaWYgKG5hdGl2ZUJpbmQgJiYgZnVuYy5iaW5kID09PSBuYXRpdmVCaW5kKSByZXR1cm4gbmF0aXZlQmluZC5hcHBseShmdW5jLCBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSkpOwoJICAgIGlmICghXy5pc0Z1bmN0aW9uKGZ1bmMpKSB0aHJvdyBuZXcgVHlwZUVycm9yKCdCaW5kIG11c3QgYmUgY2FsbGVkIG9uIGEgZnVuY3Rpb24nKTsKCSAgICBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDIpOwoJICAgIGJvdW5kID0gZnVuY3Rpb24oKSB7CgkgICAgICBpZiAoISh0aGlzIGluc3RhbmNlb2YgYm91bmQpKSByZXR1cm4gZnVuYy5hcHBseShjb250ZXh0LCBhcmdzLmNvbmNhdChzbGljZS5jYWxsKGFyZ3VtZW50cykpKTsKCSAgICAgIEN0b3IucHJvdG90eXBlID0gZnVuYy5wcm90b3R5cGU7CgkgICAgICB2YXIgc2VsZiA9IG5ldyBDdG9yOwoJICAgICAgQ3Rvci5wcm90b3R5cGUgPSBudWxsOwoJICAgICAgdmFyIHJlc3VsdCA9IGZ1bmMuYXBwbHkoc2VsZiwgYXJncy5jb25jYXQoc2xpY2UuY2FsbChhcmd1bWVudHMpKSk7CgkgICAgICBpZiAoXy5pc09iamVjdChyZXN1bHQpKSByZXR1cm4gcmVzdWx0OwoJICAgICAgcmV0dXJuIHNlbGY7CgkgICAgfTsKCSAgICByZXR1cm4gYm91bmQ7CgkgIH07CgoJICAvLyBQYXJ0aWFsbHkgYXBwbHkgYSBmdW5jdGlvbiBieSBjcmVhdGluZyBhIHZlcnNpb24gdGhhdCBoYXMgaGFkIHNvbWUgb2YgaXRzCgkgIC8vIGFyZ3VtZW50cyBwcmUtZmlsbGVkLCB3aXRob3V0IGNoYW5naW5nIGl0cyBkeW5hbWljIGB0aGlzYCBjb250ZXh0LiBfIGFjdHMKCSAgLy8gYXMgYSBwbGFjZWhvbGRlciwgYWxsb3dpbmcgYW55IGNvbWJpbmF0aW9uIG9mIGFyZ3VtZW50cyB0byBiZSBwcmUtZmlsbGVkLgoJICBfLnBhcnRpYWwgPSBmdW5jdGlvbihmdW5jKSB7CgkgICAgdmFyIGJvdW5kQXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKCSAgICByZXR1cm4gZnVuY3Rpb24oKSB7CgkgICAgICB2YXIgcG9zaXRpb24gPSAwOwoJICAgICAgdmFyIGFyZ3MgPSBib3VuZEFyZ3Muc2xpY2UoKTsKCSAgICAgIGZvciAodmFyIGkgPSAwLCBsZW5ndGggPSBhcmdzLmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrKSB7CgkgICAgICAgIGlmIChhcmdzW2ldID09PSBfKSBhcmdzW2ldID0gYXJndW1lbnRzW3Bvc2l0aW9uKytdOwoJICAgICAgfQoJICAgICAgd2hpbGUgKHBvc2l0aW9uIDwgYXJndW1lbnRzLmxlbmd0aCkgYXJncy5wdXNoKGFyZ3VtZW50c1twb3NpdGlvbisrXSk7CgkgICAgICByZXR1cm4gZnVuYy5hcHBseSh0aGlzLCBhcmdzKTsKCSAgICB9OwoJICB9OwoKCSAgLy8gQmluZCBhIG51bWJlciBvZiBhbiBvYmplY3QncyBtZXRob2RzIHRvIHRoYXQgb2JqZWN0LiBSZW1haW5pbmcgYXJndW1lbnRzCgkgIC8vIGFyZSB0aGUgbWV0aG9kIG5hbWVzIHRvIGJlIGJvdW5kLiBVc2VmdWwgZm9yIGVuc3VyaW5nIHRoYXQgYWxsIGNhbGxiYWNrcwoJICAvLyBkZWZpbmVkIG9uIGFuIG9iamVjdCBiZWxvbmcgdG8gaXQuCgkgIF8uYmluZEFsbCA9IGZ1bmN0aW9uKG9iaikgewoJICAgIHZhciBpLCBsZW5ndGggPSBhcmd1bWVudHMubGVuZ3RoLCBrZXk7CgkgICAgaWYgKGxlbmd0aCA8PSAxKSB0aHJvdyBuZXcgRXJyb3IoJ2JpbmRBbGwgbXVzdCBiZSBwYXNzZWQgZnVuY3Rpb24gbmFtZXMnKTsKCSAgICBmb3IgKGkgPSAxOyBpIDwgbGVuZ3RoOyBpKyspIHsKCSAgICAgIGtleSA9IGFyZ3VtZW50c1tpXTsKCSAgICAgIG9ialtrZXldID0gXy5iaW5kKG9ialtrZXldLCBvYmopOwoJICAgIH0KCSAgICByZXR1cm4gb2JqOwoJICB9OwoKCSAgLy8gTWVtb2l6ZSBhbiBleHBlbnNpdmUgZnVuY3Rpb24gYnkgc3RvcmluZyBpdHMgcmVzdWx0cy4KCSAgXy5tZW1vaXplID0gZnVuY3Rpb24oZnVuYywgaGFzaGVyKSB7CgkgICAgdmFyIG1lbW9pemUgPSBmdW5jdGlvbihrZXkpIHsKCSAgICAgIHZhciBjYWNoZSA9IG1lbW9pemUuY2FjaGU7CgkgICAgICB2YXIgYWRkcmVzcyA9IGhhc2hlciA/IGhhc2hlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpIDoga2V5OwoJICAgICAgaWYgKCFfLmhhcyhjYWNoZSwgYWRkcmVzcykpIGNhY2hlW2FkZHJlc3NdID0gZnVuYy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoJICAgICAgcmV0dXJuIGNhY2hlW2FkZHJlc3NdOwoJICAgIH07CgkgICAgbWVtb2l6ZS5jYWNoZSA9IHt9OwoJICAgIHJldHVybiBtZW1vaXplOwoJICB9OwoKCSAgLy8gRGVsYXlzIGEgZnVuY3Rpb24gZm9yIHRoZSBnaXZlbiBudW1iZXIgb2YgbWlsbGlzZWNvbmRzLCBhbmQgdGhlbiBjYWxscwoJICAvLyBpdCB3aXRoIHRoZSBhcmd1bWVudHMgc3VwcGxpZWQuCgkgIF8uZGVsYXkgPSBmdW5jdGlvbihmdW5jLCB3YWl0KSB7CgkgICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cywgMik7CgkgICAgcmV0dXJuIHNldFRpbWVvdXQoZnVuY3Rpb24oKXsKCSAgICAgIHJldHVybiBmdW5jLmFwcGx5KG51bGwsIGFyZ3MpOwoJICAgIH0sIHdhaXQpOwoJICB9OwoKCSAgLy8gRGVmZXJzIGEgZnVuY3Rpb24sIHNjaGVkdWxpbmcgaXQgdG8gcnVuIGFmdGVyIHRoZSBjdXJyZW50IGNhbGwgc3RhY2sgaGFzCgkgIC8vIGNsZWFyZWQuCgkgIF8uZGVmZXIgPSBmdW5jdGlvbihmdW5jKSB7CgkgICAgcmV0dXJuIF8uZGVsYXkuYXBwbHkoXywgW2Z1bmMsIDFdLmNvbmNhdChzbGljZS5jYWxsKGFyZ3VtZW50cywgMSkpKTsKCSAgfTsKCgkgIC8vIFJldHVybnMgYSBmdW5jdGlvbiwgdGhhdCwgd2hlbiBpbnZva2VkLCB3aWxsIG9ubHkgYmUgdHJpZ2dlcmVkIGF0IG1vc3Qgb25jZQoJICAvLyBkdXJpbmcgYSBnaXZlbiB3aW5kb3cgb2YgdGltZS4gTm9ybWFsbHksIHRoZSB0aHJvdHRsZWQgZnVuY3Rpb24gd2lsbCBydW4KCSAgLy8gYXMgbXVjaCBhcyBpdCBjYW4sIHdpdGhvdXQgZXZlciBnb2luZyBtb3JlIHRoYW4gb25jZSBwZXIgYHdhaXRgIGR1cmF0aW9uOwoJICAvLyBidXQgaWYgeW91J2QgbGlrZSB0byBkaXNhYmxlIHRoZSBleGVjdXRpb24gb24gdGhlIGxlYWRpbmcgZWRnZSwgcGFzcwoJICAvLyBge2xlYWRpbmc6IGZhbHNlfWAuIFRvIGRpc2FibGUgZXhlY3V0aW9uIG9uIHRoZSB0cmFpbGluZyBlZGdlLCBkaXR0by4KCSAgXy50aHJvdHRsZSA9IGZ1bmN0aW9uKGZ1bmMsIHdhaXQsIG9wdGlvbnMpIHsKCSAgICB2YXIgY29udGV4dCwgYXJncywgcmVzdWx0OwoJICAgIHZhciB0aW1lb3V0ID0gbnVsbDsKCSAgICB2YXIgcHJldmlvdXMgPSAwOwoJICAgIGlmICghb3B0aW9ucykgb3B0aW9ucyA9IHt9OwoJICAgIHZhciBsYXRlciA9IGZ1bmN0aW9uKCkgewoJICAgICAgcHJldmlvdXMgPSBvcHRpb25zLmxlYWRpbmcgPT09IGZhbHNlID8gMCA6IF8ubm93KCk7CgkgICAgICB0aW1lb3V0ID0gbnVsbDsKCSAgICAgIHJlc3VsdCA9IGZ1bmMuYXBwbHkoY29udGV4dCwgYXJncyk7CgkgICAgICBpZiAoIXRpbWVvdXQpIGNvbnRleHQgPSBhcmdzID0gbnVsbDsKCSAgICB9OwoJICAgIHJldHVybiBmdW5jdGlvbigpIHsKCSAgICAgIHZhciBub3cgPSBfLm5vdygpOwoJICAgICAgaWYgKCFwcmV2aW91cyAmJiBvcHRpb25zLmxlYWRpbmcgPT09IGZhbHNlKSBwcmV2aW91cyA9IG5vdzsKCSAgICAgIHZhciByZW1haW5pbmcgPSB3YWl0IC0gKG5vdyAtIHByZXZpb3VzKTsKCSAgICAgIGNvbnRleHQgPSB0aGlzOwoJICAgICAgYXJncyA9IGFyZ3VtZW50czsKCSAgICAgIGlmIChyZW1haW5pbmcgPD0gMCB8fCByZW1haW5pbmcgPiB3YWl0KSB7CgkgICAgICAgIGNsZWFyVGltZW91dCh0aW1lb3V0KTsKCSAgICAgICAgdGltZW91dCA9IG51bGw7CgkgICAgICAgIHByZXZpb3VzID0gbm93OwoJICAgICAgICByZXN1bHQgPSBmdW5jLmFwcGx5KGNvbnRleHQsIGFyZ3MpOwoJICAgICAgICBpZiAoIXRpbWVvdXQpIGNvbnRleHQgPSBhcmdzID0gbnVsbDsKCSAgICAgIH0gZWxzZSBpZiAoIXRpbWVvdXQgJiYgb3B0aW9ucy50cmFpbGluZyAhPT0gZmFsc2UpIHsKCSAgICAgICAgdGltZW91dCA9IHNldFRpbWVvdXQobGF0ZXIsIHJlbWFpbmluZyk7CgkgICAgICB9CgkgICAgICByZXR1cm4gcmVzdWx0OwoJICAgIH07CgkgIH07CgoJICAvLyBSZXR1cm5zIGEgZnVuY3Rpb24sIHRoYXQsIGFzIGxvbmcgYXMgaXQgY29udGludWVzIHRvIGJlIGludm9rZWQsIHdpbGwgbm90CgkgIC8vIGJlIHRyaWdnZXJlZC4gVGhlIGZ1bmN0aW9uIHdpbGwgYmUgY2FsbGVkIGFmdGVyIGl0IHN0b3BzIGJlaW5nIGNhbGxlZCBmb3IKCSAgLy8gTiBtaWxsaXNlY29uZHMuIElmIGBpbW1lZGlhdGVgIGlzIHBhc3NlZCwgdHJpZ2dlciB0aGUgZnVuY3Rpb24gb24gdGhlCgkgIC8vIGxlYWRpbmcgZWRnZSwgaW5zdGVhZCBvZiB0aGUgdHJhaWxpbmcuCgkgIF8uZGVib3VuY2UgPSBmdW5jdGlvbihmdW5jLCB3YWl0LCBpbW1lZGlhdGUpIHsKCSAgICB2YXIgdGltZW91dCwgYXJncywgY29udGV4dCwgdGltZXN0YW1wLCByZXN1bHQ7CgoJICAgIHZhciBsYXRlciA9IGZ1bmN0aW9uKCkgewoJICAgICAgdmFyIGxhc3QgPSBfLm5vdygpIC0gdGltZXN0YW1wOwoKCSAgICAgIGlmIChsYXN0IDwgd2FpdCAmJiBsYXN0ID4gMCkgewoJICAgICAgICB0aW1lb3V0ID0gc2V0VGltZW91dChsYXRlciwgd2FpdCAtIGxhc3QpOwoJICAgICAgfSBlbHNlIHsKCSAgICAgICAgdGltZW91dCA9IG51bGw7CgkgICAgICAgIGlmICghaW1tZWRpYXRlKSB7CgkgICAgICAgICAgcmVzdWx0ID0gZnVuYy5hcHBseShjb250ZXh0LCBhcmdzKTsKCSAgICAgICAgICBpZiAoIXRpbWVvdXQpIGNvbnRleHQgPSBhcmdzID0gbnVsbDsKCSAgICAgICAgfQoJICAgICAgfQoJICAgIH07CgoJICAgIHJldHVybiBmdW5jdGlvbigpIHsKCSAgICAgIGNvbnRleHQgPSB0aGlzOwoJICAgICAgYXJncyA9IGFyZ3VtZW50czsKCSAgICAgIHRpbWVzdGFtcCA9IF8ubm93KCk7CgkgICAgICB2YXIgY2FsbE5vdyA9IGltbWVkaWF0ZSAmJiAhdGltZW91dDsKCSAgICAgIGlmICghdGltZW91dCkgdGltZW91dCA9IHNldFRpbWVvdXQobGF0ZXIsIHdhaXQpOwoJICAgICAgaWYgKGNhbGxOb3cpIHsKCSAgICAgICAgcmVzdWx0ID0gZnVuYy5hcHBseShjb250ZXh0LCBhcmdzKTsKCSAgICAgICAgY29udGV4dCA9IGFyZ3MgPSBudWxsOwoJICAgICAgfQoKCSAgICAgIHJldHVybiByZXN1bHQ7CgkgICAgfTsKCSAgfTsKCgkgIC8vIFJldHVybnMgdGhlIGZpcnN0IGZ1bmN0aW9uIHBhc3NlZCBhcyBhbiBhcmd1bWVudCB0byB0aGUgc2Vjb25kLAoJICAvLyBhbGxvd2luZyB5b3UgdG8gYWRqdXN0IGFyZ3VtZW50cywgcnVuIGNvZGUgYmVmb3JlIGFuZCBhZnRlciwgYW5kCgkgIC8vIGNvbmRpdGlvbmFsbHkgZXhlY3V0ZSB0aGUgb3JpZ2luYWwgZnVuY3Rpb24uCgkgIF8ud3JhcCA9IGZ1bmN0aW9uKGZ1bmMsIHdyYXBwZXIpIHsKCSAgICByZXR1cm4gXy5wYXJ0aWFsKHdyYXBwZXIsIGZ1bmMpOwoJICB9OwoKCSAgLy8gUmV0dXJucyBhIG5lZ2F0ZWQgdmVyc2lvbiBvZiB0aGUgcGFzc2VkLWluIHByZWRpY2F0ZS4KCSAgXy5uZWdhdGUgPSBmdW5jdGlvbihwcmVkaWNhdGUpIHsKCSAgICByZXR1cm4gZnVuY3Rpb24oKSB7CgkgICAgICByZXR1cm4gIXByZWRpY2F0ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoJICAgIH07CgkgIH07CgoJICAvLyBSZXR1cm5zIGEgZnVuY3Rpb24gdGhhdCBpcyB0aGUgY29tcG9zaXRpb24gb2YgYSBsaXN0IG9mIGZ1bmN0aW9ucywgZWFjaAoJICAvLyBjb25zdW1pbmcgdGhlIHJldHVybiB2YWx1ZSBvZiB0aGUgZnVuY3Rpb24gdGhhdCBmb2xsb3dzLgoJICBfLmNvbXBvc2UgPSBmdW5jdGlvbigpIHsKCSAgICB2YXIgYXJncyA9IGFyZ3VtZW50czsKCSAgICB2YXIgc3RhcnQgPSBhcmdzLmxlbmd0aCAtIDE7CgkgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewoJICAgICAgdmFyIGkgPSBzdGFydDsKCSAgICAgIHZhciByZXN1bHQgPSBhcmdzW3N0YXJ0XS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoJICAgICAgd2hpbGUgKGktLSkgcmVzdWx0ID0gYXJnc1tpXS5jYWxsKHRoaXMsIHJlc3VsdCk7CgkgICAgICByZXR1cm4gcmVzdWx0OwoJICAgIH07CgkgIH07CgoJICAvLyBSZXR1cm5zIGEgZnVuY3Rpb24gdGhhdCB3aWxsIG9ubHkgYmUgZXhlY3V0ZWQgYWZ0ZXIgYmVpbmcgY2FsbGVkIE4gdGltZXMuCgkgIF8uYWZ0ZXIgPSBmdW5jdGlvbih0aW1lcywgZnVuYykgewoJICAgIHJldHVybiBmdW5jdGlvbigpIHsKCSAgICAgIGlmICgtLXRpbWVzIDwgMSkgewoJICAgICAgICByZXR1cm4gZnVuYy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoJICAgICAgfQoJICAgIH07CgkgIH07CgoJICAvLyBSZXR1cm5zIGEgZnVuY3Rpb24gdGhhdCB3aWxsIG9ubHkgYmUgZXhlY3V0ZWQgYmVmb3JlIGJlaW5nIGNhbGxlZCBOIHRpbWVzLgoJICBfLmJlZm9yZSA9IGZ1bmN0aW9uKHRpbWVzLCBmdW5jKSB7CgkgICAgdmFyIG1lbW87CgkgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewoJICAgICAgaWYgKC0tdGltZXMgPiAwKSB7CgkgICAgICAgIG1lbW8gPSBmdW5jLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CgkgICAgICB9IGVsc2UgewoJICAgICAgICBmdW5jID0gbnVsbDsKCSAgICAgIH0KCSAgICAgIHJldHVybiBtZW1vOwoJICAgIH07CgkgIH07CgoJICAvLyBSZXR1cm5zIGEgZnVuY3Rpb24gdGhhdCB3aWxsIGJlIGV4ZWN1dGVkIGF0IG1vc3Qgb25lIHRpbWUsIG5vIG1hdHRlciBob3cKCSAgLy8gb2Z0ZW4geW91IGNhbGwgaXQuIFVzZWZ1bCBmb3IgbGF6eSBpbml0aWFsaXphdGlvbi4KCSAgXy5vbmNlID0gXy5wYXJ0aWFsKF8uYmVmb3JlLCAyKTsKCgkgIC8vIE9iamVjdCBGdW5jdGlvbnMKCSAgLy8gLS0tLS0tLS0tLS0tLS0tLQoKCSAgLy8gUmV0cmlldmUgdGhlIG5hbWVzIG9mIGFuIG9iamVjdCdzIHByb3BlcnRpZXMuCgkgIC8vIERlbGVnYXRlcyB0byAqKkVDTUFTY3JpcHQgNSoqJ3MgbmF0aXZlIGBPYmplY3Qua2V5c2AKCSAgXy5rZXlzID0gZnVuY3Rpb24ob2JqKSB7CgkgICAgaWYgKCFfLmlzT2JqZWN0KG9iaikpIHJldHVybiBbXTsKCSAgICBpZiAobmF0aXZlS2V5cykgcmV0dXJuIG5hdGl2ZUtleXMob2JqKTsKCSAgICB2YXIga2V5cyA9IFtdOwoJICAgIGZvciAodmFyIGtleSBpbiBvYmopIGlmIChfLmhhcyhvYmosIGtleSkpIGtleXMucHVzaChrZXkpOwoJICAgIHJldHVybiBrZXlzOwoJICB9OwoKCSAgLy8gUmV0cmlldmUgdGhlIHZhbHVlcyBvZiBhbiBvYmplY3QncyBwcm9wZXJ0aWVzLgoJICBfLnZhbHVlcyA9IGZ1bmN0aW9uKG9iaikgewoJICAgIHZhciBrZXlzID0gXy5rZXlzKG9iaik7CgkgICAgdmFyIGxlbmd0aCA9IGtleXMubGVuZ3RoOwoJICAgIHZhciB2YWx1ZXMgPSBBcnJheShsZW5ndGgpOwoJICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKCSAgICAgIHZhbHVlc1tpXSA9IG9ialtrZXlzW2ldXTsKCSAgICB9CgkgICAgcmV0dXJuIHZhbHVlczsKCSAgfTsKCgkgIC8vIENvbnZlcnQgYW4gb2JqZWN0IGludG8gYSBsaXN0IG9mIGBba2V5LCB2YWx1ZV1gIHBhaXJzLgoJICBfLnBhaXJzID0gZnVuY3Rpb24ob2JqKSB7CgkgICAgdmFyIGtleXMgPSBfLmtleXMob2JqKTsKCSAgICB2YXIgbGVuZ3RoID0ga2V5cy5sZW5ndGg7CgkgICAgdmFyIHBhaXJzID0gQXJyYXkobGVuZ3RoKTsKCSAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CgkgICAgICBwYWlyc1tpXSA9IFtrZXlzW2ldLCBvYmpba2V5c1tpXV1dOwoJICAgIH0KCSAgICByZXR1cm4gcGFpcnM7CgkgIH07CgoJICAvLyBJbnZlcnQgdGhlIGtleXMgYW5kIHZhbHVlcyBvZiBhbiBvYmplY3QuIFRoZSB2YWx1ZXMgbXVzdCBiZSBzZXJpYWxpemFibGUuCgkgIF8uaW52ZXJ0ID0gZnVuY3Rpb24ob2JqKSB7CgkgICAgdmFyIHJlc3VsdCA9IHt9OwoJICAgIHZhciBrZXlzID0gXy5rZXlzKG9iaik7CgkgICAgZm9yICh2YXIgaSA9IDAsIGxlbmd0aCA9IGtleXMubGVuZ3RoOyBpIDwgbGVuZ3RoOyBpKyspIHsKCSAgICAgIHJlc3VsdFtvYmpba2V5c1tpXV1dID0ga2V5c1tpXTsKCSAgICB9CgkgICAgcmV0dXJuIHJlc3VsdDsKCSAgfTsKCgkgIC8vIFJldHVybiBhIHNvcnRlZCBsaXN0IG9mIHRoZSBmdW5jdGlvbiBuYW1lcyBhdmFpbGFibGUgb24gdGhlIG9iamVjdC4KCSAgLy8gQWxpYXNlZCBhcyBgbWV0aG9kc2AKCSAgXy5mdW5jdGlvbnMgPSBfLm1ldGhvZHMgPSBmdW5jdGlvbihvYmopIHsKCSAgICB2YXIgbmFtZXMgPSBbXTsKCSAgICBmb3IgKHZhciBrZXkgaW4gb2JqKSB7CgkgICAgICBpZiAoXy5pc0Z1bmN0aW9uKG9ialtrZXldKSkgbmFtZXMucHVzaChrZXkpOwoJICAgIH0KCSAgICByZXR1cm4gbmFtZXMuc29ydCgpOwoJICB9OwoKCSAgLy8gRXh0ZW5kIGEgZ2l2ZW4gb2JqZWN0IHdpdGggYWxsIHRoZSBwcm9wZXJ0aWVzIGluIHBhc3NlZC1pbiBvYmplY3QocykuCgkgIF8uZXh0ZW5kID0gZnVuY3Rpb24ob2JqKSB7CgkgICAgaWYgKCFfLmlzT2JqZWN0KG9iaikpIHJldHVybiBvYmo7CgkgICAgdmFyIHNvdXJjZSwgcHJvcDsKCSAgICBmb3IgKHZhciBpID0gMSwgbGVuZ3RoID0gYXJndW1lbnRzLmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrKSB7CgkgICAgICBzb3VyY2UgPSBhcmd1bWVudHNbaV07CgkgICAgICBmb3IgKHByb3AgaW4gc291cmNlKSB7CgkgICAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKHNvdXJjZSwgcHJvcCkpIHsKCSAgICAgICAgICAgIG9ialtwcm9wXSA9IHNvdXJjZVtwcm9wXTsKCSAgICAgICAgfQoJICAgICAgfQoJICAgIH0KCSAgICByZXR1cm4gb2JqOwoJICB9OwoKCSAgLy8gUmV0dXJuIGEgY29weSBvZiB0aGUgb2JqZWN0IG9ubHkgY29udGFpbmluZyB0aGUgd2hpdGVsaXN0ZWQgcHJvcGVydGllcy4KCSAgXy5waWNrID0gZnVuY3Rpb24ob2JqLCBpdGVyYXRlZSwgY29udGV4dCkgewoJICAgIHZhciByZXN1bHQgPSB7fSwga2V5OwoJICAgIGlmIChvYmogPT0gbnVsbCkgcmV0dXJuIHJlc3VsdDsKCSAgICBpZiAoXy5pc0Z1bmN0aW9uKGl0ZXJhdGVlKSkgewoJICAgICAgaXRlcmF0ZWUgPSBjcmVhdGVDYWxsYmFjayhpdGVyYXRlZSwgY29udGV4dCk7CgkgICAgICBmb3IgKGtleSBpbiBvYmopIHsKCSAgICAgICAgdmFyIHZhbHVlID0gb2JqW2tleV07CgkgICAgICAgIGlmIChpdGVyYXRlZSh2YWx1ZSwga2V5LCBvYmopKSByZXN1bHRba2V5XSA9IHZhbHVlOwoJICAgICAgfQoJICAgIH0gZWxzZSB7CgkgICAgICB2YXIga2V5cyA9IGNvbmNhdC5hcHBseShbXSwgc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpKTsKCSAgICAgIG9iaiA9IG5ldyBPYmplY3Qob2JqKTsKCSAgICAgIGZvciAodmFyIGkgPSAwLCBsZW5ndGggPSBrZXlzLmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrKSB7CgkgICAgICAgIGtleSA9IGtleXNbaV07CgkgICAgICAgIGlmIChrZXkgaW4gb2JqKSByZXN1bHRba2V5XSA9IG9ialtrZXldOwoJICAgICAgfQoJICAgIH0KCSAgICByZXR1cm4gcmVzdWx0OwoJICB9OwoKCSAgIC8vIFJldHVybiBhIGNvcHkgb2YgdGhlIG9iamVjdCB3aXRob3V0IHRoZSBibGFja2xpc3RlZCBwcm9wZXJ0aWVzLgoJICBfLm9taXQgPSBmdW5jdGlvbihvYmosIGl0ZXJhdGVlLCBjb250ZXh0KSB7CgkgICAgaWYgKF8uaXNGdW5jdGlvbihpdGVyYXRlZSkpIHsKCSAgICAgIGl0ZXJhdGVlID0gXy5uZWdhdGUoaXRlcmF0ZWUpOwoJICAgIH0gZWxzZSB7CgkgICAgICB2YXIga2V5cyA9IF8ubWFwKGNvbmNhdC5hcHBseShbXSwgc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpKSwgU3RyaW5nKTsKCSAgICAgIGl0ZXJhdGVlID0gZnVuY3Rpb24odmFsdWUsIGtleSkgewoJICAgICAgICByZXR1cm4gIV8uY29udGFpbnMoa2V5cywga2V5KTsKCSAgICAgIH07CgkgICAgfQoJICAgIHJldHVybiBfLnBpY2sob2JqLCBpdGVyYXRlZSwgY29udGV4dCk7CgkgIH07CgoJICAvLyBGaWxsIGluIGEgZ2l2ZW4gb2JqZWN0IHdpdGggZGVmYXVsdCBwcm9wZXJ0aWVzLgoJICBfLmRlZmF1bHRzID0gZnVuY3Rpb24ob2JqKSB7CgkgICAgaWYgKCFfLmlzT2JqZWN0KG9iaikpIHJldHVybiBvYmo7CgkgICAgZm9yICh2YXIgaSA9IDEsIGxlbmd0aCA9IGFyZ3VtZW50cy5sZW5ndGg7IGkgPCBsZW5ndGg7IGkrKykgewoJICAgICAgdmFyIHNvdXJjZSA9IGFyZ3VtZW50c1tpXTsKCSAgICAgIGZvciAodmFyIHByb3AgaW4gc291cmNlKSB7CgkgICAgICAgIGlmIChvYmpbcHJvcF0gPT09IHZvaWQgMCkgb2JqW3Byb3BdID0gc291cmNlW3Byb3BdOwoJICAgICAgfQoJICAgIH0KCSAgICByZXR1cm4gb2JqOwoJICB9OwoKCSAgLy8gQ3JlYXRlIGEgKHNoYWxsb3ctY2xvbmVkKSBkdXBsaWNhdGUgb2YgYW4gb2JqZWN0LgoJICBfLmNsb25lID0gZnVuY3Rpb24ob2JqKSB7CgkgICAgaWYgKCFfLmlzT2JqZWN0KG9iaikpIHJldHVybiBvYmo7CgkgICAgcmV0dXJuIF8uaXNBcnJheShvYmopID8gb2JqLnNsaWNlKCkgOiBfLmV4dGVuZCh7fSwgb2JqKTsKCSAgfTsKCgkgIC8vIEludm9rZXMgaW50ZXJjZXB0b3Igd2l0aCB0aGUgb2JqLCBhbmQgdGhlbiByZXR1cm5zIG9iai4KCSAgLy8gVGhlIHByaW1hcnkgcHVycG9zZSBvZiB0aGlzIG1ldGhvZCBpcyB0byAidGFwIGludG8iIGEgbWV0aG9kIGNoYWluLCBpbgoJICAvLyBvcmRlciB0byBwZXJmb3JtIG9wZXJhdGlvbnMgb24gaW50ZXJtZWRpYXRlIHJlc3VsdHMgd2l0aGluIHRoZSBjaGFpbi4KCSAgXy50YXAgPSBmdW5jdGlvbihvYmosIGludGVyY2VwdG9yKSB7CgkgICAgaW50ZXJjZXB0b3Iob2JqKTsKCSAgICByZXR1cm4gb2JqOwoJICB9OwoKCSAgLy8gSW50ZXJuYWwgcmVjdXJzaXZlIGNvbXBhcmlzb24gZnVuY3Rpb24gZm9yIGBpc0VxdWFsYC4KCSAgdmFyIGVxID0gZnVuY3Rpb24oYSwgYiwgYVN0YWNrLCBiU3RhY2spIHsKCSAgICAvLyBJZGVudGljYWwgb2JqZWN0cyBhcmUgZXF1YWwuIGAwID09PSAtMGAsIGJ1dCB0aGV5IGFyZW4ndCBpZGVudGljYWwuCgkgICAgLy8gU2VlIHRoZSBbSGFybW9ueSBgZWdhbGAgcHJvcG9zYWxdKGh0dHA6Ly93aWtpLmVjbWFzY3JpcHQub3JnL2Rva3UucGhwP2lkPWhhcm1vbnk6ZWdhbCkuCgkgICAgaWYgKGEgPT09IGIpIHJldHVybiBhICE9PSAwIHx8IDEgLyBhID09PSAxIC8gYjsKCSAgICAvLyBBIHN0cmljdCBjb21wYXJpc29uIGlzIG5lY2Vzc2FyeSBiZWNhdXNlIGBudWxsID09IHVuZGVmaW5lZGAuCgkgICAgaWYgKGEgPT0gbnVsbCB8fCBiID09IG51bGwpIHJldHVybiBhID09PSBiOwoJICAgIC8vIFVud3JhcCBhbnkgd3JhcHBlZCBvYmplY3RzLgoJICAgIGlmIChhIGluc3RhbmNlb2YgXykgYSA9IGEuX3dyYXBwZWQ7CgkgICAgaWYgKGIgaW5zdGFuY2VvZiBfKSBiID0gYi5fd3JhcHBlZDsKCSAgICAvLyBDb21wYXJlIGBbW0NsYXNzXV1gIG5hbWVzLgoJICAgIHZhciBjbGFzc05hbWUgPSB0b1N0cmluZy5jYWxsKGEpOwoJICAgIGlmIChjbGFzc05hbWUgIT09IHRvU3RyaW5nLmNhbGwoYikpIHJldHVybiBmYWxzZTsKCSAgICBzd2l0Y2ggKGNsYXNzTmFtZSkgewoJICAgICAgLy8gU3RyaW5ncywgbnVtYmVycywgcmVndWxhciBleHByZXNzaW9ucywgZGF0ZXMsIGFuZCBib29sZWFucyBhcmUgY29tcGFyZWQgYnkgdmFsdWUuCgkgICAgICBjYXNlICdbb2JqZWN0IFJlZ0V4cF0nOgoJICAgICAgLy8gUmVnRXhwcyBhcmUgY29lcmNlZCB0byBzdHJpbmdzIGZvciBjb21wYXJpc29uIChOb3RlOiAnJyArIC9hL2kgPT09ICcvYS9pJykKCSAgICAgIGNhc2UgJ1tvYmplY3QgU3RyaW5nXSc6CgkgICAgICAgIC8vIFByaW1pdGl2ZXMgYW5kIHRoZWlyIGNvcnJlc3BvbmRpbmcgb2JqZWN0IHdyYXBwZXJzIGFyZSBlcXVpdmFsZW50OyB0aHVzLCBgIjUiYCBpcwoJICAgICAgICAvLyBlcXVpdmFsZW50IHRvIGBuZXcgU3RyaW5nKCI1IilgLgoJICAgICAgICByZXR1cm4gJycgKyBhID09PSAnJyArIGI7CgkgICAgICBjYXNlICdbb2JqZWN0IE51bWJlcl0nOgoJICAgICAgICAvLyBgTmFOYHMgYXJlIGVxdWl2YWxlbnQsIGJ1dCBub24tcmVmbGV4aXZlLgoJICAgICAgICAvLyBPYmplY3QoTmFOKSBpcyBlcXVpdmFsZW50IHRvIE5hTgoJICAgICAgICBpZiAoK2EgIT09ICthKSByZXR1cm4gK2IgIT09ICtiOwoJICAgICAgICAvLyBBbiBgZWdhbGAgY29tcGFyaXNvbiBpcyBwZXJmb3JtZWQgZm9yIG90aGVyIG51bWVyaWMgdmFsdWVzLgoJICAgICAgICByZXR1cm4gK2EgPT09IDAgPyAxIC8gK2EgPT09IDEgLyBiIDogK2EgPT09ICtiOwoJICAgICAgY2FzZSAnW29iamVjdCBEYXRlXSc6CgkgICAgICBjYXNlICdbb2JqZWN0IEJvb2xlYW5dJzoKCSAgICAgICAgLy8gQ29lcmNlIGRhdGVzIGFuZCBib29sZWFucyB0byBudW1lcmljIHByaW1pdGl2ZSB2YWx1ZXMuIERhdGVzIGFyZSBjb21wYXJlZCBieSB0aGVpcgoJICAgICAgICAvLyBtaWxsaXNlY29uZCByZXByZXNlbnRhdGlvbnMuIE5vdGUgdGhhdCBpbnZhbGlkIGRhdGVzIHdpdGggbWlsbGlzZWNvbmQgcmVwcmVzZW50YXRpb25zCgkgICAgICAgIC8vIG9mIGBOYU5gIGFyZSBub3QgZXF1aXZhbGVudC4KCSAgICAgICAgcmV0dXJuICthID09PSArYjsKCSAgICB9CgkgICAgaWYgKHR5cGVvZiBhICE9ICdvYmplY3QnIHx8IHR5cGVvZiBiICE9ICdvYmplY3QnKSByZXR1cm4gZmFsc2U7CgkgICAgLy8gQXNzdW1lIGVxdWFsaXR5IGZvciBjeWNsaWMgc3RydWN0dXJlcy4gVGhlIGFsZ29yaXRobSBmb3IgZGV0ZWN0aW5nIGN5Y2xpYwoJICAgIC8vIHN0cnVjdHVyZXMgaXMgYWRhcHRlZCBmcm9tIEVTIDUuMSBzZWN0aW9uIDE1LjEyLjMsIGFic3RyYWN0IG9wZXJhdGlvbiBgSk9gLgoJICAgIHZhciBsZW5ndGggPSBhU3RhY2subGVuZ3RoOwoJICAgIHdoaWxlIChsZW5ndGgtLSkgewoJICAgICAgLy8gTGluZWFyIHNlYXJjaC4gUGVyZm9ybWFuY2UgaXMgaW52ZXJzZWx5IHByb3BvcnRpb25hbCB0byB0aGUgbnVtYmVyIG9mCgkgICAgICAvLyB1bmlxdWUgbmVzdGVkIHN0cnVjdHVyZXMuCgkgICAgICBpZiAoYVN0YWNrW2xlbmd0aF0gPT09IGEpIHJldHVybiBiU3RhY2tbbGVuZ3RoXSA9PT0gYjsKCSAgICB9CgkgICAgLy8gT2JqZWN0cyB3aXRoIGRpZmZlcmVudCBjb25zdHJ1Y3RvcnMgYXJlIG5vdCBlcXVpdmFsZW50LCBidXQgYE9iamVjdGBzCgkgICAgLy8gZnJvbSBkaWZmZXJlbnQgZnJhbWVzIGFyZS4KCSAgICB2YXIgYUN0b3IgPSBhLmNvbnN0cnVjdG9yLCBiQ3RvciA9IGIuY29uc3RydWN0b3I7CgkgICAgaWYgKAoJICAgICAgYUN0b3IgIT09IGJDdG9yICYmCgkgICAgICAvLyBIYW5kbGUgT2JqZWN0LmNyZWF0ZSh4KSBjYXNlcwoJICAgICAgJ2NvbnN0cnVjdG9yJyBpbiBhICYmICdjb25zdHJ1Y3RvcicgaW4gYiAmJgoJICAgICAgIShfLmlzRnVuY3Rpb24oYUN0b3IpICYmIGFDdG9yIGluc3RhbmNlb2YgYUN0b3IgJiYKCSAgICAgICAgXy5pc0Z1bmN0aW9uKGJDdG9yKSAmJiBiQ3RvciBpbnN0YW5jZW9mIGJDdG9yKQoJICAgICkgewoJICAgICAgcmV0dXJuIGZhbHNlOwoJICAgIH0KCSAgICAvLyBBZGQgdGhlIGZpcnN0IG9iamVjdCB0byB0aGUgc3RhY2sgb2YgdHJhdmVyc2VkIG9iamVjdHMuCgkgICAgYVN0YWNrLnB1c2goYSk7CgkgICAgYlN0YWNrLnB1c2goYik7CgkgICAgdmFyIHNpemUsIHJlc3VsdDsKCSAgICAvLyBSZWN1cnNpdmVseSBjb21wYXJlIG9iamVjdHMgYW5kIGFycmF5cy4KCSAgICBpZiAoY2xhc3NOYW1lID09PSAnW29iamVjdCBBcnJheV0nKSB7CgkgICAgICAvLyBDb21wYXJlIGFycmF5IGxlbmd0aHMgdG8gZGV0ZXJtaW5lIGlmIGEgZGVlcCBjb21wYXJpc29uIGlzIG5lY2Vzc2FyeS4KCSAgICAgIHNpemUgPSBhLmxlbmd0aDsKCSAgICAgIHJlc3VsdCA9IHNpemUgPT09IGIubGVuZ3RoOwoJICAgICAgaWYgKHJlc3VsdCkgewoJICAgICAgICAvLyBEZWVwIGNvbXBhcmUgdGhlIGNvbnRlbnRzLCBpZ25vcmluZyBub24tbnVtZXJpYyBwcm9wZXJ0aWVzLgoJICAgICAgICB3aGlsZSAoc2l6ZS0tKSB7CgkgICAgICAgICAgaWYgKCEocmVzdWx0ID0gZXEoYVtzaXplXSwgYltzaXplXSwgYVN0YWNrLCBiU3RhY2spKSkgYnJlYWs7CgkgICAgICAgIH0KCSAgICAgIH0KCSAgICB9IGVsc2UgewoJICAgICAgLy8gRGVlcCBjb21wYXJlIG9iamVjdHMuCgkgICAgICB2YXIga2V5cyA9IF8ua2V5cyhhKSwga2V5OwoJICAgICAgc2l6ZSA9IGtleXMubGVuZ3RoOwoJICAgICAgLy8gRW5zdXJlIHRoYXQgYm90aCBvYmplY3RzIGNvbnRhaW4gdGhlIHNhbWUgbnVtYmVyIG9mIHByb3BlcnRpZXMgYmVmb3JlIGNvbXBhcmluZyBkZWVwIGVxdWFsaXR5LgoJICAgICAgcmVzdWx0ID0gXy5rZXlzKGIpLmxlbmd0aCA9PT0gc2l6ZTsKCSAgICAgIGlmIChyZXN1bHQpIHsKCSAgICAgICAgd2hpbGUgKHNpemUtLSkgewoJICAgICAgICAgIC8vIERlZXAgY29tcGFyZSBlYWNoIG1lbWJlcgoJICAgICAgICAgIGtleSA9IGtleXNbc2l6ZV07CgkgICAgICAgICAgaWYgKCEocmVzdWx0ID0gXy5oYXMoYiwga2V5KSAmJiBlcShhW2tleV0sIGJba2V5XSwgYVN0YWNrLCBiU3RhY2spKSkgYnJlYWs7CgkgICAgICAgIH0KCSAgICAgIH0KCSAgICB9CgkgICAgLy8gUmVtb3ZlIHRoZSBmaXJzdCBvYmplY3QgZnJvbSB0aGUgc3RhY2sgb2YgdHJhdmVyc2VkIG9iamVjdHMuCgkgICAgYVN0YWNrLnBvcCgpOwoJICAgIGJTdGFjay5wb3AoKTsKCSAgICByZXR1cm4gcmVzdWx0OwoJICB9OwoKCSAgLy8gUGVyZm9ybSBhIGRlZXAgY29tcGFyaXNvbiB0byBjaGVjayBpZiB0d28gb2JqZWN0cyBhcmUgZXF1YWwuCgkgIF8uaXNFcXVhbCA9IGZ1bmN0aW9uKGEsIGIpIHsKCSAgICByZXR1cm4gZXEoYSwgYiwgW10sIFtdKTsKCSAgfTsKCgkgIC8vIElzIGEgZ2l2ZW4gYXJyYXksIHN0cmluZywgb3Igb2JqZWN0IGVtcHR5PwoJICAvLyBBbiAiZW1wdHkiIG9iamVjdCBoYXMgbm8gZW51bWVyYWJsZSBvd24tcHJvcGVydGllcy4KCSAgXy5pc0VtcHR5ID0gZnVuY3Rpb24ob2JqKSB7CgkgICAgaWYgKG9iaiA9PSBudWxsKSByZXR1cm4gdHJ1ZTsKCSAgICBpZiAoXy5pc0FycmF5KG9iaikgfHwgXy5pc1N0cmluZyhvYmopIHx8IF8uaXNBcmd1bWVudHMob2JqKSkgcmV0dXJuIG9iai5sZW5ndGggPT09IDA7CgkgICAgZm9yICh2YXIga2V5IGluIG9iaikgaWYgKF8uaGFzKG9iaiwga2V5KSkgcmV0dXJuIGZhbHNlOwoJICAgIHJldHVybiB0cnVlOwoJICB9OwoKCSAgLy8gSXMgYSBnaXZlbiB2YWx1ZSBhIERPTSBlbGVtZW50PwoJICBfLmlzRWxlbWVudCA9IGZ1bmN0aW9uKG9iaikgewoJICAgIHJldHVybiAhIShvYmogJiYgb2JqLm5vZGVUeXBlID09PSAxKTsKCSAgfTsKCgkgIC8vIElzIGEgZ2l2ZW4gdmFsdWUgYW4gYXJyYXk/CgkgIC8vIERlbGVnYXRlcyB0byBFQ01BNSdzIG5hdGl2ZSBBcnJheS5pc0FycmF5CgkgIF8uaXNBcnJheSA9IG5hdGl2ZUlzQXJyYXkgfHwgZnVuY3Rpb24ob2JqKSB7CgkgICAgcmV0dXJuIHRvU3RyaW5nLmNhbGwob2JqKSA9PT0gJ1tvYmplY3QgQXJyYXldJzsKCSAgfTsKCgkgIC8vIElzIGEgZ2l2ZW4gdmFyaWFibGUgYW4gb2JqZWN0PwoJICBfLmlzT2JqZWN0ID0gZnVuY3Rpb24ob2JqKSB7CgkgICAgdmFyIHR5cGUgPSB0eXBlb2Ygb2JqOwoJICAgIHJldHVybiB0eXBlID09PSAnZnVuY3Rpb24nIHx8IHR5cGUgPT09ICdvYmplY3QnICYmICEhb2JqOwoJICB9OwoKCSAgLy8gQWRkIHNvbWUgaXNUeXBlIG1ldGhvZHM6IGlzQXJndW1lbnRzLCBpc0Z1bmN0aW9uLCBpc1N0cmluZywgaXNOdW1iZXIsIGlzRGF0ZSwgaXNSZWdFeHAuCgkgIF8uZWFjaChbJ0FyZ3VtZW50cycsICdGdW5jdGlvbicsICdTdHJpbmcnLCAnTnVtYmVyJywgJ0RhdGUnLCAnUmVnRXhwJ10sIGZ1bmN0aW9uKG5hbWUpIHsKCSAgICBfWydpcycgKyBuYW1lXSA9IGZ1bmN0aW9uKG9iaikgewoJICAgICAgcmV0dXJuIHRvU3RyaW5nLmNhbGwob2JqKSA9PT0gJ1tvYmplY3QgJyArIG5hbWUgKyAnXSc7CgkgICAgfTsKCSAgfSk7CgoJICAvLyBEZWZpbmUgYSBmYWxsYmFjayB2ZXJzaW9uIG9mIHRoZSBtZXRob2QgaW4gYnJvd3NlcnMgKGFoZW0sIElFKSwgd2hlcmUKCSAgLy8gdGhlcmUgaXNuJ3QgYW55IGluc3BlY3RhYmxlICJBcmd1bWVudHMiIHR5cGUuCgkgIGlmICghXy5pc0FyZ3VtZW50cyhhcmd1bWVudHMpKSB7CgkgICAgXy5pc0FyZ3VtZW50cyA9IGZ1bmN0aW9uKG9iaikgewoJICAgICAgcmV0dXJuIF8uaGFzKG9iaiwgJ2NhbGxlZScpOwoJICAgIH07CgkgIH0KCgkgIC8vIE9wdGltaXplIGBpc0Z1bmN0aW9uYCBpZiBhcHByb3ByaWF0ZS4gV29yayBhcm91bmQgYW4gSUUgMTEgYnVnLgoJICBpZiAodHJ1ZSkgewoJICAgIF8uaXNGdW5jdGlvbiA9IGZ1bmN0aW9uKG9iaikgewoJICAgICAgcmV0dXJuIHR5cGVvZiBvYmogPT0gJ2Z1bmN0aW9uJyB8fCBmYWxzZTsKCSAgICB9OwoJICB9CgoJICAvLyBJcyBhIGdpdmVuIG9iamVjdCBhIGZpbml0ZSBudW1iZXI/CgkgIF8uaXNGaW5pdGUgPSBmdW5jdGlvbihvYmopIHsKCSAgICByZXR1cm4gaXNGaW5pdGUob2JqKSAmJiAhaXNOYU4ocGFyc2VGbG9hdChvYmopKTsKCSAgfTsKCgkgIC8vIElzIHRoZSBnaXZlbiB2YWx1ZSBgTmFOYD8gKE5hTiBpcyB0aGUgb25seSBudW1iZXIgd2hpY2ggZG9lcyBub3QgZXF1YWwgaXRzZWxmKS4KCSAgXy5pc05hTiA9IGZ1bmN0aW9uKG9iaikgewoJICAgIHJldHVybiBfLmlzTnVtYmVyKG9iaikgJiYgb2JqICE9PSArb2JqOwoJICB9OwoKCSAgLy8gSXMgYSBnaXZlbiB2YWx1ZSBhIGJvb2xlYW4/CgkgIF8uaXNCb29sZWFuID0gZnVuY3Rpb24ob2JqKSB7CgkgICAgcmV0dXJuIG9iaiA9PT0gdHJ1ZSB8fCBvYmogPT09IGZhbHNlIHx8IHRvU3RyaW5nLmNhbGwob2JqKSA9PT0gJ1tvYmplY3QgQm9vbGVhbl0nOwoJICB9OwoKCSAgLy8gSXMgYSBnaXZlbiB2YWx1ZSBlcXVhbCB0byBudWxsPwoJICBfLmlzTnVsbCA9IGZ1bmN0aW9uKG9iaikgewoJICAgIHJldHVybiBvYmogPT09IG51bGw7CgkgIH07CgoJICAvLyBJcyBhIGdpdmVuIHZhcmlhYmxlIHVuZGVmaW5lZD8KCSAgXy5pc1VuZGVmaW5lZCA9IGZ1bmN0aW9uKG9iaikgewoJICAgIHJldHVybiBvYmogPT09IHZvaWQgMDsKCSAgfTsKCgkgIC8vIFNob3J0Y3V0IGZ1bmN0aW9uIGZvciBjaGVja2luZyBpZiBhbiBvYmplY3QgaGFzIGEgZ2l2ZW4gcHJvcGVydHkgZGlyZWN0bHkKCSAgLy8gb24gaXRzZWxmIChpbiBvdGhlciB3b3Jkcywgbm90IG9uIGEgcHJvdG90eXBlKS4KCSAgXy5oYXMgPSBmdW5jdGlvbihvYmosIGtleSkgewoJICAgIHJldHVybiBvYmogIT0gbnVsbCAmJiBoYXNPd25Qcm9wZXJ0eS5jYWxsKG9iaiwga2V5KTsKCSAgfTsKCgkgIC8vIFV0aWxpdHkgRnVuY3Rpb25zCgkgIC8vIC0tLS0tLS0tLS0tLS0tLS0tCgoJICAvLyBSdW4gVW5kZXJzY29yZS5qcyBpbiAqbm9Db25mbGljdCogbW9kZSwgcmV0dXJuaW5nIHRoZSBgX2AgdmFyaWFibGUgdG8gaXRzCgkgIC8vIHByZXZpb3VzIG93bmVyLiBSZXR1cm5zIGEgcmVmZXJlbmNlIHRvIHRoZSBVbmRlcnNjb3JlIG9iamVjdC4KCSAgXy5ub0NvbmZsaWN0ID0gZnVuY3Rpb24oKSB7CgkgICAgcm9vdC5fID0gcHJldmlvdXNVbmRlcnNjb3JlOwoJICAgIHJldHVybiB0aGlzOwoJICB9OwoKCSAgLy8gS2VlcCB0aGUgaWRlbnRpdHkgZnVuY3Rpb24gYXJvdW5kIGZvciBkZWZhdWx0IGl0ZXJhdGVlcy4KCSAgXy5pZGVudGl0eSA9IGZ1bmN0aW9uKHZhbHVlKSB7CgkgICAgcmV0dXJuIHZhbHVlOwoJICB9OwoKCSAgXy5jb25zdGFudCA9IGZ1bmN0aW9uKHZhbHVlKSB7CgkgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewoJICAgICAgcmV0dXJuIHZhbHVlOwoJICAgIH07CgkgIH07CgoJICBfLm5vb3AgPSBmdW5jdGlvbigpe307CgoJICBfLnByb3BlcnR5ID0gZnVuY3Rpb24oa2V5KSB7CgkgICAgcmV0dXJuIGZ1bmN0aW9uKG9iaikgewoJICAgICAgcmV0dXJuIG9ialtrZXldOwoJICAgIH07CgkgIH07CgoJICAvLyBSZXR1cm5zIGEgcHJlZGljYXRlIGZvciBjaGVja2luZyB3aGV0aGVyIGFuIG9iamVjdCBoYXMgYSBnaXZlbiBzZXQgb2YgYGtleTp2YWx1ZWAgcGFpcnMuCgkgIF8ubWF0Y2hlcyA9IGZ1bmN0aW9uKGF0dHJzKSB7CgkgICAgdmFyIHBhaXJzID0gXy5wYWlycyhhdHRycyksIGxlbmd0aCA9IHBhaXJzLmxlbmd0aDsKCSAgICByZXR1cm4gZnVuY3Rpb24ob2JqKSB7CgkgICAgICBpZiAob2JqID09IG51bGwpIHJldHVybiAhbGVuZ3RoOwoJICAgICAgb2JqID0gbmV3IE9iamVjdChvYmopOwoJICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewoJICAgICAgICB2YXIgcGFpciA9IHBhaXJzW2ldLCBrZXkgPSBwYWlyWzBdOwoJICAgICAgICBpZiAocGFpclsxXSAhPT0gb2JqW2tleV0gfHwgIShrZXkgaW4gb2JqKSkgcmV0dXJuIGZhbHNlOwoJICAgICAgfQoJICAgICAgcmV0dXJuIHRydWU7CgkgICAgfTsKCSAgfTsKCgkgIC8vIFJ1biBhIGZ1bmN0aW9uICoqbioqIHRpbWVzLgoJICBfLnRpbWVzID0gZnVuY3Rpb24obiwgaXRlcmF0ZWUsIGNvbnRleHQpIHsKCSAgICB2YXIgYWNjdW0gPSBBcnJheShNYXRoLm1heCgwLCBuKSk7CgkgICAgaXRlcmF0ZWUgPSBjcmVhdGVDYWxsYmFjayhpdGVyYXRlZSwgY29udGV4dCwgMSk7CgkgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBuOyBpKyspIGFjY3VtW2ldID0gaXRlcmF0ZWUoaSk7CgkgICAgcmV0dXJuIGFjY3VtOwoJICB9OwoKCSAgLy8gUmV0dXJuIGEgcmFuZG9tIGludGVnZXIgYmV0d2VlbiBtaW4gYW5kIG1heCAoaW5jbHVzaXZlKS4KCSAgXy5yYW5kb20gPSBmdW5jdGlvbihtaW4sIG1heCkgewoJICAgIGlmIChtYXggPT0gbnVsbCkgewoJICAgICAgbWF4ID0gbWluOwoJICAgICAgbWluID0gMDsKCSAgICB9CgkgICAgcmV0dXJuIG1pbiArIE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIChtYXggLSBtaW4gKyAxKSk7CgkgIH07CgoJICAvLyBBIChwb3NzaWJseSBmYXN0ZXIpIHdheSB0byBnZXQgdGhlIGN1cnJlbnQgdGltZXN0YW1wIGFzIGFuIGludGVnZXIuCgkgIF8ubm93ID0gRGF0ZS5ub3cgfHwgZnVuY3Rpb24oKSB7CgkgICAgcmV0dXJuIG5ldyBEYXRlKCkuZ2V0VGltZSgpOwoJICB9OwoKCSAgIC8vIExpc3Qgb2YgSFRNTCBlbnRpdGllcyBmb3IgZXNjYXBpbmcuCgkgIHZhciBlc2NhcGVNYXAgPSB7CgkgICAgJyYnOiAnJmFtcDsnLAoJICAgICc8JzogJyZsdDsnLAoJICAgICc+JzogJyZndDsnLAoJICAgICciJzogJyZxdW90OycsCgkgICAgIiciOiAnJiN4Mjc7JywKCSAgICAnYCc6ICcmI3g2MDsnCgkgIH07CgkgIHZhciB1bmVzY2FwZU1hcCA9IF8uaW52ZXJ0KGVzY2FwZU1hcCk7CgoJICAvLyBGdW5jdGlvbnMgZm9yIGVzY2FwaW5nIGFuZCB1bmVzY2FwaW5nIHN0cmluZ3MgdG8vZnJvbSBIVE1MIGludGVycG9sYXRpb24uCgkgIHZhciBjcmVhdGVFc2NhcGVyID0gZnVuY3Rpb24obWFwKSB7CgkgICAgdmFyIGVzY2FwZXIgPSBmdW5jdGlvbihtYXRjaCkgewoJICAgICAgcmV0dXJuIG1hcFttYXRjaF07CgkgICAgfTsKCSAgICAvLyBSZWdleGVzIGZvciBpZGVudGlmeWluZyBhIGtleSB0aGF0IG5lZWRzIHRvIGJlIGVzY2FwZWQKCSAgICB2YXIgc291cmNlID0gJyg/OicgKyBfLmtleXMobWFwKS5qb2luKCd8JykgKyAnKSc7CgkgICAgdmFyIHRlc3RSZWdleHAgPSBSZWdFeHAoc291cmNlKTsKCSAgICB2YXIgcmVwbGFjZVJlZ2V4cCA9IFJlZ0V4cChzb3VyY2UsICdnJyk7CgkgICAgcmV0dXJuIGZ1bmN0aW9uKHN0cmluZykgewoJICAgICAgc3RyaW5nID0gc3RyaW5nID09IG51bGwgPyAnJyA6ICcnICsgc3RyaW5nOwoJICAgICAgcmV0dXJuIHRlc3RSZWdleHAudGVzdChzdHJpbmcpID8gc3RyaW5nLnJlcGxhY2UocmVwbGFjZVJlZ2V4cCwgZXNjYXBlcikgOiBzdHJpbmc7CgkgICAgfTsKCSAgfTsKCSAgXy5lc2NhcGUgPSBjcmVhdGVFc2NhcGVyKGVzY2FwZU1hcCk7CgkgIF8udW5lc2NhcGUgPSBjcmVhdGVFc2NhcGVyKHVuZXNjYXBlTWFwKTsKCgkgIC8vIElmIHRoZSB2YWx1ZSBvZiB0aGUgbmFtZWQgYHByb3BlcnR5YCBpcyBhIGZ1bmN0aW9uIHRoZW4gaW52b2tlIGl0IHdpdGggdGhlCgkgIC8vIGBvYmplY3RgIGFzIGNvbnRleHQ7IG90aGVyd2lzZSwgcmV0dXJuIGl0LgoJICBfLnJlc3VsdCA9IGZ1bmN0aW9uKG9iamVjdCwgcHJvcGVydHkpIHsKCSAgICBpZiAob2JqZWN0ID09IG51bGwpIHJldHVybiB2b2lkIDA7CgkgICAgdmFyIHZhbHVlID0gb2JqZWN0W3Byb3BlcnR5XTsKCSAgICByZXR1cm4gXy5pc0Z1bmN0aW9uKHZhbHVlKSA/IG9iamVjdFtwcm9wZXJ0eV0oKSA6IHZhbHVlOwoJICB9OwoKCSAgLy8gR2VuZXJhdGUgYSB1bmlxdWUgaW50ZWdlciBpZCAodW5pcXVlIHdpdGhpbiB0aGUgZW50aXJlIGNsaWVudCBzZXNzaW9uKS4KCSAgLy8gVXNlZnVsIGZvciB0ZW1wb3JhcnkgRE9NIGlkcy4KCSAgdmFyIGlkQ291bnRlciA9IDA7CgkgIF8udW5pcXVlSWQgPSBmdW5jdGlvbihwcmVmaXgpIHsKCSAgICB2YXIgaWQgPSArK2lkQ291bnRlciArICcnOwoJICAgIHJldHVybiBwcmVmaXggPyBwcmVmaXggKyBpZCA6IGlkOwoJICB9OwoKCSAgLy8gQnkgZGVmYXVsdCwgVW5kZXJzY29yZSB1c2VzIEVSQi1zdHlsZSB0ZW1wbGF0ZSBkZWxpbWl0ZXJzLCBjaGFuZ2UgdGhlCgkgIC8vIGZvbGxvd2luZyB0ZW1wbGF0ZSBzZXR0aW5ncyB0byB1c2UgYWx0ZXJuYXRpdmUgZGVsaW1pdGVycy4KCSAgXy50ZW1wbGF0ZVNldHRpbmdzID0gewoJICAgIGV2YWx1YXRlICAgIDogLzwlKFtcc1xTXSs/KSU+L2csCgkgICAgaW50ZXJwb2xhdGUgOiAvPCU9KFtcc1xTXSs/KSU+L2csCgkgICAgZXNjYXBlICAgICAgOiAvPCUtKFtcc1xTXSs/KSU+L2cKCSAgfTsKCgkgIC8vIFdoZW4gY3VzdG9taXppbmcgYHRlbXBsYXRlU2V0dGluZ3NgLCBpZiB5b3UgZG9uJ3Qgd2FudCB0byBkZWZpbmUgYW4KCSAgLy8gaW50ZXJwb2xhdGlvbiwgZXZhbHVhdGlvbiBvciBlc2NhcGluZyByZWdleCwgd2UgbmVlZCBvbmUgdGhhdCBpcwoJICAvLyBndWFyYW50ZWVkIG5vdCB0byBtYXRjaC4KCSAgdmFyIG5vTWF0Y2ggPSAvKC4pXi87CgoJICAvLyBDZXJ0YWluIGNoYXJhY3RlcnMgbmVlZCB0byBiZSBlc2NhcGVkIHNvIHRoYXQgdGhleSBjYW4gYmUgcHV0IGludG8gYQoJICAvLyBzdHJpbmcgbGl0ZXJhbC4KCSAgdmFyIGVzY2FwZXMgPSB7CgkgICAgIiciOiAgICAgICInIiwKCSAgICAnXFwnOiAgICAgJ1xcJywKCSAgICAnXHInOiAgICAgJ3InLAoJICAgICdcbic6ICAgICAnbicsCgkgICAgJ1x1MjAyOCc6ICd1MjAyOCcsCgkgICAgJ1x1MjAyOSc6ICd1MjAyOScKCSAgfTsKCgkgIHZhciBlc2NhcGVyID0gL1xcfCd8XHJ8XG58XHUyMDI4fFx1MjAyOS9nOwoKCSAgdmFyIGVzY2FwZUNoYXIgPSBmdW5jdGlvbihtYXRjaCkgewoJICAgIHJldHVybiAnXFwnICsgZXNjYXBlc1ttYXRjaF07CgkgIH07CgoJICAvLyBKYXZhU2NyaXB0IG1pY3JvLXRlbXBsYXRpbmcsIHNpbWlsYXIgdG8gSm9obiBSZXNpZydzIGltcGxlbWVudGF0aW9uLgoJICAvLyBVbmRlcnNjb3JlIHRlbXBsYXRpbmcgaGFuZGxlcyBhcmJpdHJhcnkgZGVsaW1pdGVycywgcHJlc2VydmVzIHdoaXRlc3BhY2UsCgkgIC8vIGFuZCBjb3JyZWN0bHkgZXNjYXBlcyBxdW90ZXMgd2l0aGluIGludGVycG9sYXRlZCBjb2RlLgoJICAvLyBOQjogYG9sZFNldHRpbmdzYCBvbmx5IGV4aXN0cyBmb3IgYmFja3dhcmRzIGNvbXBhdGliaWxpdHkuCgkgIF8udGVtcGxhdGUgPSBmdW5jdGlvbih0ZXh0LCBzZXR0aW5ncywgb2xkU2V0dGluZ3MpIHsKCSAgICBpZiAoIXNldHRpbmdzICYmIG9sZFNldHRpbmdzKSBzZXR0aW5ncyA9IG9sZFNldHRpbmdzOwoJICAgIHNldHRpbmdzID0gXy5kZWZhdWx0cyh7fSwgc2V0dGluZ3MsIF8udGVtcGxhdGVTZXR0aW5ncyk7CgoJICAgIC8vIENvbWJpbmUgZGVsaW1pdGVycyBpbnRvIG9uZSByZWd1bGFyIGV4cHJlc3Npb24gdmlhIGFsdGVybmF0aW9uLgoJICAgIHZhciBtYXRjaGVyID0gUmVnRXhwKFsKCSAgICAgIChzZXR0aW5ncy5lc2NhcGUgfHwgbm9NYXRjaCkuc291cmNlLAoJICAgICAgKHNldHRpbmdzLmludGVycG9sYXRlIHx8IG5vTWF0Y2gpLnNvdXJjZSwKCSAgICAgIChzZXR0aW5ncy5ldmFsdWF0ZSB8fCBub01hdGNoKS5zb3VyY2UKCSAgICBdLmpvaW4oJ3wnKSArICd8JCcsICdnJyk7CgoJICAgIC8vIENvbXBpbGUgdGhlIHRlbXBsYXRlIHNvdXJjZSwgZXNjYXBpbmcgc3RyaW5nIGxpdGVyYWxzIGFwcHJvcHJpYXRlbHkuCgkgICAgdmFyIGluZGV4ID0gMDsKCSAgICB2YXIgc291cmNlID0gIl9fcCs9JyI7CgkgICAgdGV4dC5yZXBsYWNlKG1hdGNoZXIsIGZ1bmN0aW9uKG1hdGNoLCBlc2NhcGUsIGludGVycG9sYXRlLCBldmFsdWF0ZSwgb2Zmc2V0KSB7CgkgICAgICBzb3VyY2UgKz0gdGV4dC5zbGljZShpbmRleCwgb2Zmc2V0KS5yZXBsYWNlKGVzY2FwZXIsIGVzY2FwZUNoYXIpOwoJICAgICAgaW5kZXggPSBvZmZzZXQgKyBtYXRjaC5sZW5ndGg7CgoJICAgICAgaWYgKGVzY2FwZSkgewoJICAgICAgICBzb3VyY2UgKz0gIicrXG4oKF9fdD0oIiArIGVzY2FwZSArICIpKT09bnVsbD8nJzpfLmVzY2FwZShfX3QpKStcbiciOwoJICAgICAgfSBlbHNlIGlmIChpbnRlcnBvbGF0ZSkgewoJICAgICAgICBzb3VyY2UgKz0gIicrXG4oKF9fdD0oIiArIGludGVycG9sYXRlICsgIikpPT1udWxsPycnOl9fdCkrXG4nIjsKCSAgICAgIH0gZWxzZSBpZiAoZXZhbHVhdGUpIHsKCSAgICAgICAgc291cmNlICs9ICInO1xuIiArIGV2YWx1YXRlICsgIlxuX19wKz0nIjsKCSAgICAgIH0KCgkgICAgICAvLyBBZG9iZSBWTXMgbmVlZCB0aGUgbWF0Y2ggcmV0dXJuZWQgdG8gcHJvZHVjZSB0aGUgY29ycmVjdCBvZmZlc3QuCgkgICAgICByZXR1cm4gbWF0Y2g7CgkgICAgfSk7CgkgICAgc291cmNlICs9ICInO1xuIjsKCgkgICAgLy8gSWYgYSB2YXJpYWJsZSBpcyBub3Qgc3BlY2lmaWVkLCBwbGFjZSBkYXRhIHZhbHVlcyBpbiBsb2NhbCBzY29wZS4KCSAgICBpZiAoIXNldHRpbmdzLnZhcmlhYmxlKSBzb3VyY2UgPSAnd2l0aChvYmp8fHt9KXtcbicgKyBzb3VyY2UgKyAnfVxuJzsKCgkgICAgc291cmNlID0gInZhciBfX3QsX19wPScnLF9faj1BcnJheS5wcm90b3R5cGUuam9pbiwiICsKCSAgICAgICJwcmludD1mdW5jdGlvbigpe19fcCs9X19qLmNhbGwoYXJndW1lbnRzLCcnKTt9O1xuIiArCgkgICAgICBzb3VyY2UgKyAncmV0dXJuIF9fcDtcbic7CgoJICAgIHRyeSB7CgkgICAgICB2YXIgcmVuZGVyID0gbmV3IEZ1bmN0aW9uKHNldHRpbmdzLnZhcmlhYmxlIHx8ICdvYmonLCAnXycsIHNvdXJjZSk7CgkgICAgfSBjYXRjaCAoZSkgewoJICAgICAgZS5zb3VyY2UgPSBzb3VyY2U7CgkgICAgICB0aHJvdyBlOwoJICAgIH0KCgkgICAgdmFyIHRlbXBsYXRlID0gZnVuY3Rpb24oZGF0YSkgewoJICAgICAgcmV0dXJuIHJlbmRlci5jYWxsKHRoaXMsIGRhdGEsIF8pOwoJICAgIH07CgoJICAgIC8vIFByb3ZpZGUgdGhlIGNvbXBpbGVkIHNvdXJjZSBhcyBhIGNvbnZlbmllbmNlIGZvciBwcmVjb21waWxhdGlvbi4KCSAgICB2YXIgYXJndW1lbnQgPSBzZXR0aW5ncy52YXJpYWJsZSB8fCAnb2JqJzsKCSAgICB0ZW1wbGF0ZS5zb3VyY2UgPSAnZnVuY3Rpb24oJyArIGFyZ3VtZW50ICsgJyl7XG4nICsgc291cmNlICsgJ30nOwoKCSAgICByZXR1cm4gdGVtcGxhdGU7CgkgIH07CgoJICAvLyBBZGQgYSAiY2hhaW4iIGZ1bmN0aW9uLiBTdGFydCBjaGFpbmluZyBhIHdyYXBwZWQgVW5kZXJzY29yZSBvYmplY3QuCgkgIF8uY2hhaW4gPSBmdW5jdGlvbihvYmopIHsKCSAgICB2YXIgaW5zdGFuY2UgPSBfKG9iaik7CgkgICAgaW5zdGFuY2UuX2NoYWluID0gdHJ1ZTsKCSAgICByZXR1cm4gaW5zdGFuY2U7CgkgIH07CgoJICAvLyBPT1AKCSAgLy8gLS0tLS0tLS0tLS0tLS0tCgkgIC8vIElmIFVuZGVyc2NvcmUgaXMgY2FsbGVkIGFzIGEgZnVuY3Rpb24sIGl0IHJldHVybnMgYSB3cmFwcGVkIG9iamVjdCB0aGF0CgkgIC8vIGNhbiBiZSB1c2VkIE9PLXN0eWxlLiBUaGlzIHdyYXBwZXIgaG9sZHMgYWx0ZXJlZCB2ZXJzaW9ucyBvZiBhbGwgdGhlCgkgIC8vIHVuZGVyc2NvcmUgZnVuY3Rpb25zLiBXcmFwcGVkIG9iamVjdHMgbWF5IGJlIGNoYWluZWQuCgoJICAvLyBIZWxwZXIgZnVuY3Rpb24gdG8gY29udGludWUgY2hhaW5pbmcgaW50ZXJtZWRpYXRlIHJlc3VsdHMuCgkgIHZhciByZXN1bHQgPSBmdW5jdGlvbihvYmopIHsKCSAgICByZXR1cm4gdGhpcy5fY2hhaW4gPyBfKG9iaikuY2hhaW4oKSA6IG9iajsKCSAgfTsKCgkgIC8vIEFkZCB5b3VyIG93biBjdXN0b20gZnVuY3Rpb25zIHRvIHRoZSBVbmRlcnNjb3JlIG9iamVjdC4KCSAgXy5taXhpbiA9IGZ1bmN0aW9uKG9iaikgewoJICAgIF8uZWFjaChfLmZ1bmN0aW9ucyhvYmopLCBmdW5jdGlvbihuYW1lKSB7CgkgICAgICB2YXIgZnVuYyA9IF9bbmFtZV0gPSBvYmpbbmFtZV07CgkgICAgICBfLnByb3RvdHlwZVtuYW1lXSA9IGZ1bmN0aW9uKCkgewoJICAgICAgICB2YXIgYXJncyA9IFt0aGlzLl93cmFwcGVkXTsKCSAgICAgICAgcHVzaC5hcHBseShhcmdzLCBhcmd1bWVudHMpOwoJICAgICAgICByZXR1cm4gcmVzdWx0LmNhbGwodGhpcywgZnVuYy5hcHBseShfLCBhcmdzKSk7CgkgICAgICB9OwoJICAgIH0pOwoJICB9OwoKCSAgLy8gQWRkIGFsbCBvZiB0aGUgVW5kZXJzY29yZSBmdW5jdGlvbnMgdG8gdGhlIHdyYXBwZXIgb2JqZWN0LgoJICBfLm1peGluKF8pOwoKCSAgLy8gQWRkIGFsbCBtdXRhdG9yIEFycmF5IGZ1bmN0aW9ucyB0byB0aGUgd3JhcHBlci4KCSAgXy5lYWNoKFsncG9wJywgJ3B1c2gnLCAncmV2ZXJzZScsICdzaGlmdCcsICdzb3J0JywgJ3NwbGljZScsICd1bnNoaWZ0J10sIGZ1bmN0aW9uKG5hbWUpIHsKCSAgICB2YXIgbWV0aG9kID0gQXJyYXlQcm90b1tuYW1lXTsKCSAgICBfLnByb3RvdHlwZVtuYW1lXSA9IGZ1bmN0aW9uKCkgewoJICAgICAgdmFyIG9iaiA9IHRoaXMuX3dyYXBwZWQ7CgkgICAgICBtZXRob2QuYXBwbHkob2JqLCBhcmd1bWVudHMpOwoJICAgICAgaWYgKChuYW1lID09PSAnc2hpZnQnIHx8IG5hbWUgPT09ICdzcGxpY2UnKSAmJiBvYmoubGVuZ3RoID09PSAwKSBkZWxldGUgb2JqWzBdOwoJICAgICAgcmV0dXJuIHJlc3VsdC5jYWxsKHRoaXMsIG9iaik7CgkgICAgfTsKCSAgfSk7CgoJICAvLyBBZGQgYWxsIGFjY2Vzc29yIEFycmF5IGZ1bmN0aW9ucyB0byB0aGUgd3JhcHBlci4KCSAgXy5lYWNoKFsnY29uY2F0JywgJ2pvaW4nLCAnc2xpY2UnXSwgZnVuY3Rpb24obmFtZSkgewoJICAgIHZhciBtZXRob2QgPSBBcnJheVByb3RvW25hbWVdOwoJICAgIF8ucHJvdG90eXBlW25hbWVdID0gZnVuY3Rpb24oKSB7CgkgICAgICByZXR1cm4gcmVzdWx0LmNhbGwodGhpcywgbWV0aG9kLmFwcGx5KHRoaXMuX3dyYXBwZWQsIGFyZ3VtZW50cykpOwoJICAgIH07CgkgIH0pOwoKCSAgLy8gRXh0cmFjdHMgdGhlIHJlc3VsdCBmcm9tIGEgd3JhcHBlZCBhbmQgY2hhaW5lZCBvYmplY3QuCgkgIF8ucHJvdG90eXBlLnZhbHVlID0gZnVuY3Rpb24oKSB7CgkgICAgcmV0dXJuIHRoaXMuX3dyYXBwZWQ7CgkgIH07CgoJICAvLyBBTUQgcmVnaXN0cmF0aW9uIGhhcHBlbnMgYXQgdGhlIGVuZCBmb3IgY29tcGF0aWJpbGl0eSB3aXRoIEFNRCBsb2FkZXJzCgkgIC8vIHRoYXQgbWF5IG5vdCBlbmZvcmNlIG5leHQtdHVybiBzZW1hbnRpY3Mgb24gbW9kdWxlcy4gRXZlbiB0aG91Z2ggZ2VuZXJhbAoJICAvLyBwcmFjdGljZSBmb3IgQU1EIHJlZ2lzdHJhdGlvbiBpcyB0byBiZSBhbm9ueW1vdXMsIHVuZGVyc2NvcmUgcmVnaXN0ZXJzCgkgIC8vIGFzIGEgbmFtZWQgbW9kdWxlIGJlY2F1c2UsIGxpa2UgalF1ZXJ5LCBpdCBpcyBhIGJhc2UgbGlicmFyeSB0aGF0IGlzCgkgIC8vIHBvcHVsYXIgZW5vdWdoIHRvIGJlIGJ1bmRsZWQgaW4gYSB0aGlyZCBwYXJ0eSBsaWIsIGJ1dCBub3QgYmUgcGFydCBvZgoJICAvLyBhbiBBTUQgbG9hZCByZXF1ZXN0LiBUaG9zZSBjYXNlcyBjb3VsZCBnZW5lcmF0ZSBhbiBlcnJvciB3aGVuIGFuCgkgIC8vIGFub255bW91cyBkZWZpbmUoKSBpcyBjYWxsZWQgb3V0c2lkZSBvZiBhIGxvYWRlciByZXF1ZXN0LgoJICBpZiAodHJ1ZSkgewoJICAgICEoX19XRUJQQUNLX0FNRF9ERUZJTkVfQVJSQVlfXyA9IFtdLCBfX1dFQlBBQ0tfQU1EX0RFRklORV9SRVNVTFRfXyA9IGZ1bmN0aW9uKCkgewoJICAgICAgcmV0dXJuIF87CgkgICAgfS5hcHBseShleHBvcnRzLCBfX1dFQlBBQ0tfQU1EX0RFRklORV9BUlJBWV9fKSwgX19XRUJQQUNLX0FNRF9ERUZJTkVfUkVTVUxUX18gIT09IHVuZGVmaW5lZCAmJiAobW9kdWxlLmV4cG9ydHMgPSBfX1dFQlBBQ0tfQU1EX0RFRklORV9SRVNVTFRfXykpOwoJICB9Cgl9LmNhbGwodGhpcykpOwoKCi8qKiovIH0sCi8qIDI1ICovCi8qKiovIGZ1bmN0aW9uKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewoKCS8qKiogSU1QT1JUUyBGUk9NIGltcG9ydHMtbG9hZGVyICoqKi8KCXZhciByZXF1aXJlID0gX193ZWJwYWNrX3JlcXVpcmVfXzsKCgkvKiEKCSAqIEtub2Nrb3V0IEphdmFTY3JpcHQgbGlicmFyeSB2My4yLjAKCSAqIChjKSBTdGV2ZW4gU2FuZGVyc29uIC0gaHR0cDovL2tub2Nrb3V0anMuY29tLwoJICogTGljZW5zZTogTUlUIChodHRwOi8vd3d3Lm9wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL21pdC1saWNlbnNlLnBocCkKCSAqLwoKCShmdW5jdGlvbigpewoJdmFyIERFQlVHPXRydWU7CgkoZnVuY3Rpb24odW5kZWZpbmVkKXsKCSAgICAvLyAoMCwgZXZhbCkoJ3RoaXMnKSBpcyBhIHJvYnVzdCB3YXkgb2YgZ2V0dGluZyBhIHJlZmVyZW5jZSB0byB0aGUgZ2xvYmFsIG9iamVjdAoJICAgIC8vIEZvciBkZXRhaWxzLCBzZWUgaHR0cDovL3N0YWNrb3ZlcmZsb3cuY29tL3F1ZXN0aW9ucy8xNDExOTk4OC9yZXR1cm4tdGhpcy0wLWV2YWx0aGlzLzE0MTIwMDIzIzE0MTIwMDIzCgkgICAgdmFyIHdpbmRvdyA9IHRoaXMgfHwgKDAsIGV2YWwpKCd0aGlzJyksCgkgICAgICAgIGRvY3VtZW50ID0gd2luZG93Wydkb2N1bWVudCddLAoJICAgICAgICBuYXZpZ2F0b3IgPSB3aW5kb3dbJ25hdmlnYXRvciddLAoJICAgICAgICBqUXVlcnlJbnN0YW5jZSA9IHdpbmRvd1sialF1ZXJ5Il0sCgkgICAgICAgIEpTT04gPSB3aW5kb3dbIkpTT04iXTsKCShmdW5jdGlvbihmYWN0b3J5KSB7CgkgICAgLy8gU3VwcG9ydCB0aHJlZSBtb2R1bGUgbG9hZGluZyBzY2VuYXJpb3MKCSAgICBpZiAodHlwZW9mIHJlcXVpcmUgPT09ICdmdW5jdGlvbicgJiYgdHlwZW9mIGV4cG9ydHMgPT09ICdvYmplY3QnICYmIHR5cGVvZiBtb2R1bGUgPT09ICdvYmplY3QnKSB7CgkgICAgICAgIC8vIFsxXSBDb21tb25KUy9Ob2RlLmpzCgkgICAgICAgIHZhciB0YXJnZXQgPSBtb2R1bGVbJ2V4cG9ydHMnXSB8fCBleHBvcnRzOyAvLyBtb2R1bGUuZXhwb3J0cyBpcyBmb3IgTm9kZS5qcwoJICAgICAgICBmYWN0b3J5KHRhcmdldCwgcmVxdWlyZSk7CgkgICAgfSBlbHNlIGlmICh0eXBlb2YgZGVmaW5lID09PSAnZnVuY3Rpb24nICYmIGRlZmluZVsnYW1kJ10pIHsKCSAgICAgICAgLy8gWzJdIEFNRCBhbm9ueW1vdXMgbW9kdWxlCgkgICAgICAgIGRlZmluZShbJ2V4cG9ydHMnLCAncmVxdWlyZSddLCBmYWN0b3J5KTsKCSAgICB9IGVsc2UgewoJICAgICAgICAvLyBbM10gTm8gbW9kdWxlIGxvYWRlciAocGxhaW4gPHNjcmlwdD4gdGFnKSAtIHB1dCBkaXJlY3RseSBpbiBnbG9iYWwgbmFtZXNwYWNlCgkgICAgICAgIGZhY3Rvcnkod2luZG93WydrbyddID0ge30pOwoJICAgIH0KCX0oZnVuY3Rpb24oa29FeHBvcnRzLCByZXF1aXJlKXsKCS8vIEludGVybmFsbHksIGFsbCBLTyBvYmplY3RzIGFyZSBhdHRhY2hlZCB0byBrb0V4cG9ydHMgKGV2ZW4gdGhlIG5vbi1leHBvcnRlZCBvbmVzIHdob3NlIG5hbWVzIHdpbGwgYmUgbWluaWZpZWQgYnkgdGhlIGNsb3N1cmUgY29tcGlsZXIpLgoJLy8gSW4gdGhlIGZ1dHVyZSwgdGhlIGZvbGxvd2luZyAia28iIHZhcmlhYmxlIG1heSBiZSBtYWRlIGRpc3RpbmN0IGZyb20gImtvRXhwb3J0cyIgc28gdGhhdCBwcml2YXRlIG9iamVjdHMgYXJlIG5vdCBleHRlcm5hbGx5IHJlYWNoYWJsZS4KCXZhciBrbyA9IHR5cGVvZiBrb0V4cG9ydHMgIT09ICd1bmRlZmluZWQnID8ga29FeHBvcnRzIDoge307CgkvLyBHb29nbGUgQ2xvc3VyZSBDb21waWxlciBoZWxwZXJzICh1c2VkIG9ubHkgdG8gbWFrZSB0aGUgbWluaWZpZWQgZmlsZSBzbWFsbGVyKQoJa28uZXhwb3J0U3ltYm9sID0gZnVuY3Rpb24oa29QYXRoLCBvYmplY3QpIHsKCSAgICB2YXIgdG9rZW5zID0ga29QYXRoLnNwbGl0KCIuIik7CgoJICAgIC8vIEluIHRoZSBmdXR1cmUsICJrbyIgbWF5IGJlY29tZSBkaXN0aW5jdCBmcm9tICJrb0V4cG9ydHMiIChzbyB0aGF0IG5vbi1leHBvcnRlZCBvYmplY3RzIGFyZSBub3QgcmVhY2hhYmxlKQoJICAgIC8vIEF0IHRoYXQgcG9pbnQsICJ0YXJnZXQiIHdvdWxkIGJlIHNldCB0bzogKHR5cGVvZiBrb0V4cG9ydHMgIT09ICJ1bmRlZmluZWQiID8ga29FeHBvcnRzIDoga28pCgkgICAgdmFyIHRhcmdldCA9IGtvOwoKCSAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRva2Vucy5sZW5ndGggLSAxOyBpKyspCgkgICAgICAgIHRhcmdldCA9IHRhcmdldFt0b2tlbnNbaV1dOwoJICAgIHRhcmdldFt0b2tlbnNbdG9rZW5zLmxlbmd0aCAtIDFdXSA9IG9iamVjdDsKCX07Cglrby5leHBvcnRQcm9wZXJ0eSA9IGZ1bmN0aW9uKG93bmVyLCBwdWJsaWNOYW1lLCBvYmplY3QpIHsKCSAgICBvd25lcltwdWJsaWNOYW1lXSA9IG9iamVjdDsKCX07Cglrby52ZXJzaW9uID0gIjMuMi4wIjsKCglrby5leHBvcnRTeW1ib2woJ3ZlcnNpb24nLCBrby52ZXJzaW9uKTsKCWtvLnV0aWxzID0gKGZ1bmN0aW9uICgpIHsKCSAgICBmdW5jdGlvbiBvYmplY3RGb3JFYWNoKG9iaiwgYWN0aW9uKSB7CgkgICAgICAgIGZvciAodmFyIHByb3AgaW4gb2JqKSB7CgkgICAgICAgICAgICBpZiAob2JqLmhhc093blByb3BlcnR5KHByb3ApKSB7CgkgICAgICAgICAgICAgICAgYWN0aW9uKHByb3AsIG9ialtwcm9wXSk7CgkgICAgICAgICAgICB9CgkgICAgICAgIH0KCSAgICB9CgoJICAgIGZ1bmN0aW9uIGV4dGVuZCh0YXJnZXQsIHNvdXJjZSkgewoJICAgICAgICBpZiAoc291cmNlKSB7CgkgICAgICAgICAgICBmb3IodmFyIHByb3AgaW4gc291cmNlKSB7CgkgICAgICAgICAgICAgICAgaWYoc291cmNlLmhhc093blByb3BlcnR5KHByb3ApKSB7CgkgICAgICAgICAgICAgICAgICAgIHRhcmdldFtwcm9wXSA9IHNvdXJjZVtwcm9wXTsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICB9CgkgICAgICAgIH0KCSAgICAgICAgcmV0dXJuIHRhcmdldDsKCSAgICB9CgoJICAgIGZ1bmN0aW9uIHNldFByb3RvdHlwZU9mKG9iaiwgcHJvdG8pIHsKCSAgICAgICAgb2JqLl9fcHJvdG9fXyA9IHByb3RvOwoJICAgICAgICByZXR1cm4gb2JqOwoJICAgIH0KCgkgICAgdmFyIGNhblNldFByb3RvdHlwZSA9ICh7IF9fcHJvdG9fXzogW10gfSBpbnN0YW5jZW9mIEFycmF5KTsKCgkgICAgLy8gUmVwcmVzZW50IHRoZSBrbm93biBldmVudCB0eXBlcyBpbiBhIGNvbXBhY3Qgd2F5LCB0aGVuIGF0IHJ1bnRpbWUgdHJhbnNmb3JtIGl0IGludG8gYSBoYXNoIHdpdGggZXZlbnQgbmFtZSBhcyBrZXkgKGZvciBmYXN0IGxvb2t1cCkKCSAgICB2YXIga25vd25FdmVudHMgPSB7fSwga25vd25FdmVudFR5cGVzQnlFdmVudE5hbWUgPSB7fTsKCSAgICB2YXIga2V5RXZlbnRUeXBlTmFtZSA9IChuYXZpZ2F0b3IgJiYgL0ZpcmVmb3hcLzIvaS50ZXN0KG5hdmlnYXRvci51c2VyQWdlbnQpKSA/ICdLZXlib2FyZEV2ZW50JyA6ICdVSUV2ZW50cyc7CgkgICAga25vd25FdmVudHNba2V5RXZlbnRUeXBlTmFtZV0gPSBbJ2tleXVwJywgJ2tleWRvd24nLCAna2V5cHJlc3MnXTsKCSAgICBrbm93bkV2ZW50c1snTW91c2VFdmVudHMnXSA9IFsnY2xpY2snLCAnZGJsY2xpY2snLCAnbW91c2Vkb3duJywgJ21vdXNldXAnLCAnbW91c2Vtb3ZlJywgJ21vdXNlb3ZlcicsICdtb3VzZW91dCcsICdtb3VzZWVudGVyJywgJ21vdXNlbGVhdmUnXTsKCSAgICBvYmplY3RGb3JFYWNoKGtub3duRXZlbnRzLCBmdW5jdGlvbihldmVudFR5cGUsIGtub3duRXZlbnRzRm9yVHlwZSkgewoJICAgICAgICBpZiAoa25vd25FdmVudHNGb3JUeXBlLmxlbmd0aCkgewoJICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGogPSBrbm93bkV2ZW50c0ZvclR5cGUubGVuZ3RoOyBpIDwgajsgaSsrKQoJICAgICAgICAgICAgICAgIGtub3duRXZlbnRUeXBlc0J5RXZlbnROYW1lW2tub3duRXZlbnRzRm9yVHlwZVtpXV0gPSBldmVudFR5cGU7CgkgICAgICAgIH0KCSAgICB9KTsKCSAgICB2YXIgZXZlbnRzVGhhdE11c3RCZVJlZ2lzdGVyZWRVc2luZ0F0dGFjaEV2ZW50ID0geyAncHJvcGVydHljaGFuZ2UnOiB0cnVlIH07IC8vIFdvcmthcm91bmQgZm9yIGFuIElFOSBpc3N1ZSAtIGh0dHBzOi8vZ2l0aHViLmNvbS9TdGV2ZVNhbmRlcnNvbi9rbm9ja291dC9pc3N1ZXMvNDA2CgoJICAgIC8vIERldGVjdCBJRSB2ZXJzaW9ucyBmb3IgYnVnIHdvcmthcm91bmRzICh1c2VzIElFIGNvbmRpdGlvbmFscywgbm90IFVBIHN0cmluZywgZm9yIHJvYnVzdG5lc3MpCgkgICAgLy8gTm90ZSB0aGF0LCBzaW5jZSBJRSAxMCBkb2VzIG5vdCBzdXBwb3J0IGNvbmRpdGlvbmFsIGNvbW1lbnRzLCB0aGUgZm9sbG93aW5nIGxvZ2ljIG9ubHkgZGV0ZWN0cyBJRSA8IDEwLgoJICAgIC8vIEN1cnJlbnRseSB0aGlzIGlzIGJ5IGRlc2lnbiwgc2luY2UgSUUgMTArIGJlaGF2ZXMgY29ycmVjdGx5IHdoZW4gdHJlYXRlZCBhcyBhIHN0YW5kYXJkIGJyb3dzZXIuCgkgICAgLy8gSWYgdGhlcmUgaXMgYSBmdXR1cmUgbmVlZCB0byBkZXRlY3Qgc3BlY2lmaWMgdmVyc2lvbnMgb2YgSUUxMCssIHdlIHdpbGwgYW1lbmQgdGhpcy4KCSAgICB2YXIgaWVWZXJzaW9uID0gZG9jdW1lbnQgJiYgKGZ1bmN0aW9uKCkgewoJICAgICAgICB2YXIgdmVyc2lvbiA9IDMsIGRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpLCBpRWxlbXMgPSBkaXYuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ2knKTsKCgkgICAgICAgIC8vIEtlZXAgY29uc3RydWN0aW5nIGNvbmRpdGlvbmFsIEhUTUwgYmxvY2tzIHVudGlsIHdlIGhpdCBvbmUgdGhhdCByZXNvbHZlcyB0byBhbiBlbXB0eSBmcmFnbWVudAoJICAgICAgICB3aGlsZSAoCgkgICAgICAgICAgICBkaXYuaW5uZXJIVE1MID0gJzwhLS1baWYgZ3QgSUUgJyArICgrK3ZlcnNpb24pICsgJ10+PGk+PC9pPjwhW2VuZGlmXS0tPicsCgkgICAgICAgICAgICBpRWxlbXNbMF0KCSAgICAgICAgKSB7fQoJICAgICAgICByZXR1cm4gdmVyc2lvbiA+IDQgPyB2ZXJzaW9uIDogdW5kZWZpbmVkOwoJICAgIH0oKSk7CgkgICAgdmFyIGlzSWU2ID0gaWVWZXJzaW9uID09PSA2LAoJICAgICAgICBpc0llNyA9IGllVmVyc2lvbiA9PT0gNzsKCgkgICAgZnVuY3Rpb24gaXNDbGlja09uQ2hlY2thYmxlRWxlbWVudChlbGVtZW50LCBldmVudFR5cGUpIHsKCSAgICAgICAgaWYgKChrby51dGlscy50YWdOYW1lTG93ZXIoZWxlbWVudCkgIT09ICJpbnB1dCIpIHx8ICFlbGVtZW50LnR5cGUpIHJldHVybiBmYWxzZTsKCSAgICAgICAgaWYgKGV2ZW50VHlwZS50b0xvd2VyQ2FzZSgpICE9ICJjbGljayIpIHJldHVybiBmYWxzZTsKCSAgICAgICAgdmFyIGlucHV0VHlwZSA9IGVsZW1lbnQudHlwZTsKCSAgICAgICAgcmV0dXJuIChpbnB1dFR5cGUgPT0gImNoZWNrYm94IikgfHwgKGlucHV0VHlwZSA9PSAicmFkaW8iKTsKCSAgICB9CgoJICAgIHJldHVybiB7CgkgICAgICAgIGZpZWxkc0luY2x1ZGVkV2l0aEpzb25Qb3N0OiBbJ2F1dGhlbnRpY2l0eV90b2tlbicsIC9eX19SZXF1ZXN0VmVyaWZpY2F0aW9uVG9rZW4oXy4qKT8kL10sCgoJICAgICAgICBhcnJheUZvckVhY2g6IGZ1bmN0aW9uIChhcnJheSwgYWN0aW9uKSB7CgkgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaiA9IGFycmF5Lmxlbmd0aDsgaSA8IGo7IGkrKykKCSAgICAgICAgICAgICAgICBhY3Rpb24oYXJyYXlbaV0sIGkpOwoJICAgICAgICB9LAoKCSAgICAgICAgYXJyYXlJbmRleE9mOiBmdW5jdGlvbiAoYXJyYXksIGl0ZW0pIHsKCSAgICAgICAgICAgIGlmICh0eXBlb2YgQXJyYXkucHJvdG90eXBlLmluZGV4T2YgPT0gImZ1bmN0aW9uIikKCSAgICAgICAgICAgICAgICByZXR1cm4gQXJyYXkucHJvdG90eXBlLmluZGV4T2YuY2FsbChhcnJheSwgaXRlbSk7CgkgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaiA9IGFycmF5Lmxlbmd0aDsgaSA8IGo7IGkrKykKCSAgICAgICAgICAgICAgICBpZiAoYXJyYXlbaV0gPT09IGl0ZW0pCgkgICAgICAgICAgICAgICAgICAgIHJldHVybiBpOwoJICAgICAgICAgICAgcmV0dXJuIC0xOwoJICAgICAgICB9LAoKCSAgICAgICAgYXJyYXlGaXJzdDogZnVuY3Rpb24gKGFycmF5LCBwcmVkaWNhdGUsIHByZWRpY2F0ZU93bmVyKSB7CgkgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaiA9IGFycmF5Lmxlbmd0aDsgaSA8IGo7IGkrKykKCSAgICAgICAgICAgICAgICBpZiAocHJlZGljYXRlLmNhbGwocHJlZGljYXRlT3duZXIsIGFycmF5W2ldLCBpKSkKCSAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGFycmF5W2ldOwoJICAgICAgICAgICAgcmV0dXJuIG51bGw7CgkgICAgICAgIH0sCgoJICAgICAgICBhcnJheVJlbW92ZUl0ZW06IGZ1bmN0aW9uIChhcnJheSwgaXRlbVRvUmVtb3ZlKSB7CgkgICAgICAgICAgICB2YXIgaW5kZXggPSBrby51dGlscy5hcnJheUluZGV4T2YoYXJyYXksIGl0ZW1Ub1JlbW92ZSk7CgkgICAgICAgICAgICBpZiAoaW5kZXggPiAwKSB7CgkgICAgICAgICAgICAgICAgYXJyYXkuc3BsaWNlKGluZGV4LCAxKTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIGVsc2UgaWYgKGluZGV4ID09PSAwKSB7CgkgICAgICAgICAgICAgICAgYXJyYXkuc2hpZnQoKTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgfSwKCgkgICAgICAgIGFycmF5R2V0RGlzdGluY3RWYWx1ZXM6IGZ1bmN0aW9uIChhcnJheSkgewoJICAgICAgICAgICAgYXJyYXkgPSBhcnJheSB8fCBbXTsKCSAgICAgICAgICAgIHZhciByZXN1bHQgPSBbXTsKCSAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBqID0gYXJyYXkubGVuZ3RoOyBpIDwgajsgaSsrKSB7CgkgICAgICAgICAgICAgICAgaWYgKGtvLnV0aWxzLmFycmF5SW5kZXhPZihyZXN1bHQsIGFycmF5W2ldKSA8IDApCgkgICAgICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKGFycmF5W2ldKTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIHJldHVybiByZXN1bHQ7CgkgICAgICAgIH0sCgoJICAgICAgICBhcnJheU1hcDogZnVuY3Rpb24gKGFycmF5LCBtYXBwaW5nKSB7CgkgICAgICAgICAgICBhcnJheSA9IGFycmF5IHx8IFtdOwoJICAgICAgICAgICAgdmFyIHJlc3VsdCA9IFtdOwoJICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGogPSBhcnJheS5sZW5ndGg7IGkgPCBqOyBpKyspCgkgICAgICAgICAgICAgICAgcmVzdWx0LnB1c2gobWFwcGluZyhhcnJheVtpXSwgaSkpOwoJICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKCSAgICAgICAgfSwKCgkgICAgICAgIGFycmF5RmlsdGVyOiBmdW5jdGlvbiAoYXJyYXksIHByZWRpY2F0ZSkgewoJICAgICAgICAgICAgYXJyYXkgPSBhcnJheSB8fCBbXTsKCSAgICAgICAgICAgIHZhciByZXN1bHQgPSBbXTsKCSAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBqID0gYXJyYXkubGVuZ3RoOyBpIDwgajsgaSsrKQoJICAgICAgICAgICAgICAgIGlmIChwcmVkaWNhdGUoYXJyYXlbaV0sIGkpKQoJICAgICAgICAgICAgICAgICAgICByZXN1bHQucHVzaChhcnJheVtpXSk7CgkgICAgICAgICAgICByZXR1cm4gcmVzdWx0OwoJICAgICAgICB9LAoKCSAgICAgICAgYXJyYXlQdXNoQWxsOiBmdW5jdGlvbiAoYXJyYXksIHZhbHVlc1RvUHVzaCkgewoJICAgICAgICAgICAgaWYgKHZhbHVlc1RvUHVzaCBpbnN0YW5jZW9mIEFycmF5KQoJICAgICAgICAgICAgICAgIGFycmF5LnB1c2guYXBwbHkoYXJyYXksIHZhbHVlc1RvUHVzaCk7CgkgICAgICAgICAgICBlbHNlCgkgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGogPSB2YWx1ZXNUb1B1c2gubGVuZ3RoOyBpIDwgajsgaSsrKQoJICAgICAgICAgICAgICAgICAgICBhcnJheS5wdXNoKHZhbHVlc1RvUHVzaFtpXSk7CgkgICAgICAgICAgICByZXR1cm4gYXJyYXk7CgkgICAgICAgIH0sCgoJICAgICAgICBhZGRPclJlbW92ZUl0ZW06IGZ1bmN0aW9uKGFycmF5LCB2YWx1ZSwgaW5jbHVkZWQpIHsKCSAgICAgICAgICAgIHZhciBleGlzdGluZ0VudHJ5SW5kZXggPSBrby51dGlscy5hcnJheUluZGV4T2Yoa28udXRpbHMucGVla09ic2VydmFibGUoYXJyYXkpLCB2YWx1ZSk7CgkgICAgICAgICAgICBpZiAoZXhpc3RpbmdFbnRyeUluZGV4IDwgMCkgewoJICAgICAgICAgICAgICAgIGlmIChpbmNsdWRlZCkKCSAgICAgICAgICAgICAgICAgICAgYXJyYXkucHVzaCh2YWx1ZSk7CgkgICAgICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgICAgIGlmICghaW5jbHVkZWQpCgkgICAgICAgICAgICAgICAgICAgIGFycmF5LnNwbGljZShleGlzdGluZ0VudHJ5SW5kZXgsIDEpOwoJICAgICAgICAgICAgfQoJICAgICAgICB9LAoKCSAgICAgICAgY2FuU2V0UHJvdG90eXBlOiBjYW5TZXRQcm90b3R5cGUsCgoJICAgICAgICBleHRlbmQ6IGV4dGVuZCwKCgkgICAgICAgIHNldFByb3RvdHlwZU9mOiBzZXRQcm90b3R5cGVPZiwKCgkgICAgICAgIHNldFByb3RvdHlwZU9mT3JFeHRlbmQ6IGNhblNldFByb3RvdHlwZSA/IHNldFByb3RvdHlwZU9mIDogZXh0ZW5kLAoKCSAgICAgICAgb2JqZWN0Rm9yRWFjaDogb2JqZWN0Rm9yRWFjaCwKCgkgICAgICAgIG9iamVjdE1hcDogZnVuY3Rpb24oc291cmNlLCBtYXBwaW5nKSB7CgkgICAgICAgICAgICBpZiAoIXNvdXJjZSkKCSAgICAgICAgICAgICAgICByZXR1cm4gc291cmNlOwoJICAgICAgICAgICAgdmFyIHRhcmdldCA9IHt9OwoJICAgICAgICAgICAgZm9yICh2YXIgcHJvcCBpbiBzb3VyY2UpIHsKCSAgICAgICAgICAgICAgICBpZiAoc291cmNlLmhhc093blByb3BlcnR5KHByb3ApKSB7CgkgICAgICAgICAgICAgICAgICAgIHRhcmdldFtwcm9wXSA9IG1hcHBpbmcoc291cmNlW3Byb3BdLCBwcm9wLCBzb3VyY2UpOwoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIHJldHVybiB0YXJnZXQ7CgkgICAgICAgIH0sCgoJICAgICAgICBlbXB0eURvbU5vZGU6IGZ1bmN0aW9uIChkb21Ob2RlKSB7CgkgICAgICAgICAgICB3aGlsZSAoZG9tTm9kZS5maXJzdENoaWxkKSB7CgkgICAgICAgICAgICAgICAga28ucmVtb3ZlTm9kZShkb21Ob2RlLmZpcnN0Q2hpbGQpOwoJICAgICAgICAgICAgfQoJICAgICAgICB9LAoKCSAgICAgICAgbW92ZUNsZWFuZWROb2Rlc1RvQ29udGFpbmVyRWxlbWVudDogZnVuY3Rpb24obm9kZXMpIHsKCSAgICAgICAgICAgIC8vIEVuc3VyZSBpdCdzIGEgcmVhbCBhcnJheSwgYXMgd2UncmUgYWJvdXQgdG8gcmVwYXJlbnQgdGhlIG5vZGVzIGFuZAoJICAgICAgICAgICAgLy8gd2UgZG9uJ3Qgd2FudCB0aGUgdW5kZXJseWluZyBjb2xsZWN0aW9uIHRvIGNoYW5nZSB3aGlsZSB3ZSdyZSBkb2luZyB0aGF0LgoJICAgICAgICAgICAgdmFyIG5vZGVzQXJyYXkgPSBrby51dGlscy5tYWtlQXJyYXkobm9kZXMpOwoKCSAgICAgICAgICAgIHZhciBjb250YWluZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKCSAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBqID0gbm9kZXNBcnJheS5sZW5ndGg7IGkgPCBqOyBpKyspIHsKCSAgICAgICAgICAgICAgICBjb250YWluZXIuYXBwZW5kQ2hpbGQoa28uY2xlYW5Ob2RlKG5vZGVzQXJyYXlbaV0pKTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIHJldHVybiBjb250YWluZXI7CgkgICAgICAgIH0sCgoJICAgICAgICBjbG9uZU5vZGVzOiBmdW5jdGlvbiAobm9kZXNBcnJheSwgc2hvdWxkQ2xlYW5Ob2RlcykgewoJICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGogPSBub2Rlc0FycmF5Lmxlbmd0aCwgbmV3Tm9kZXNBcnJheSA9IFtdOyBpIDwgajsgaSsrKSB7CgkgICAgICAgICAgICAgICAgdmFyIGNsb25lZE5vZGUgPSBub2Rlc0FycmF5W2ldLmNsb25lTm9kZSh0cnVlKTsKCSAgICAgICAgICAgICAgICBuZXdOb2Rlc0FycmF5LnB1c2goc2hvdWxkQ2xlYW5Ob2RlcyA/IGtvLmNsZWFuTm9kZShjbG9uZWROb2RlKSA6IGNsb25lZE5vZGUpOwoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgcmV0dXJuIG5ld05vZGVzQXJyYXk7CgkgICAgICAgIH0sCgoJICAgICAgICBzZXREb21Ob2RlQ2hpbGRyZW46IGZ1bmN0aW9uIChkb21Ob2RlLCBjaGlsZE5vZGVzKSB7CgkgICAgICAgICAgICBrby51dGlscy5lbXB0eURvbU5vZGUoZG9tTm9kZSk7CgkgICAgICAgICAgICBpZiAoY2hpbGROb2RlcykgewoJICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBqID0gY2hpbGROb2Rlcy5sZW5ndGg7IGkgPCBqOyBpKyspCgkgICAgICAgICAgICAgICAgICAgIGRvbU5vZGUuYXBwZW5kQ2hpbGQoY2hpbGROb2Rlc1tpXSk7CgkgICAgICAgICAgICB9CgkgICAgICAgIH0sCgoJICAgICAgICByZXBsYWNlRG9tTm9kZXM6IGZ1bmN0aW9uIChub2RlVG9SZXBsYWNlT3JOb2RlQXJyYXksIG5ld05vZGVzQXJyYXkpIHsKCSAgICAgICAgICAgIHZhciBub2Rlc1RvUmVwbGFjZUFycmF5ID0gbm9kZVRvUmVwbGFjZU9yTm9kZUFycmF5Lm5vZGVUeXBlID8gW25vZGVUb1JlcGxhY2VPck5vZGVBcnJheV0gOiBub2RlVG9SZXBsYWNlT3JOb2RlQXJyYXk7CgkgICAgICAgICAgICBpZiAobm9kZXNUb1JlcGxhY2VBcnJheS5sZW5ndGggPiAwKSB7CgkgICAgICAgICAgICAgICAgdmFyIGluc2VydGlvblBvaW50ID0gbm9kZXNUb1JlcGxhY2VBcnJheVswXTsKCSAgICAgICAgICAgICAgICB2YXIgcGFyZW50ID0gaW5zZXJ0aW9uUG9pbnQucGFyZW50Tm9kZTsKCSAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaiA9IG5ld05vZGVzQXJyYXkubGVuZ3RoOyBpIDwgajsgaSsrKQoJICAgICAgICAgICAgICAgICAgICBwYXJlbnQuaW5zZXJ0QmVmb3JlKG5ld05vZGVzQXJyYXlbaV0sIGluc2VydGlvblBvaW50KTsKCSAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaiA9IG5vZGVzVG9SZXBsYWNlQXJyYXkubGVuZ3RoOyBpIDwgajsgaSsrKSB7CgkgICAgICAgICAgICAgICAgICAgIGtvLnJlbW92ZU5vZGUobm9kZXNUb1JlcGxhY2VBcnJheVtpXSk7CgkgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgfQoJICAgICAgICB9LAoKCSAgICAgICAgZml4VXBDb250aW51b3VzTm9kZUFycmF5OiBmdW5jdGlvbihjb250aW51b3VzTm9kZUFycmF5LCBwYXJlbnROb2RlKSB7CgkgICAgICAgICAgICAvLyBCZWZvcmUgYWN0aW5nIG9uIGEgc2V0IG9mIG5vZGVzIHRoYXQgd2VyZSBwcmV2aW91c2x5IG91dHB1dHRlZCBieSBhIHRlbXBsYXRlIGZ1bmN0aW9uLCB3ZSBoYXZlIHRvIHJlY29uY2lsZQoJICAgICAgICAgICAgLy8gdGhlbSBhZ2FpbnN0IHdoYXQgaXMgaW4gdGhlIERPTSByaWdodCBub3cuIEl0IG1heSBiZSB0aGF0IHNvbWUgb2YgdGhlIG5vZGVzIGhhdmUgYWxyZWFkeSBiZWVuIHJlbW92ZWQsIG9yIHRoYXQKCSAgICAgICAgICAgIC8vIG5ldyBub2RlcyBtaWdodCBoYXZlIGJlZW4gaW5zZXJ0ZWQgaW4gdGhlIG1pZGRsZSwgZm9yIGV4YW1wbGUgYnkgYSBiaW5kaW5nLiBBbHNvLCB0aGVyZSBtYXkgcHJldmlvdXNseSBoYXZlIGJlZW4KCSAgICAgICAgICAgIC8vIGxlYWRpbmcgY29tbWVudCBub2RlcyAoY3JlYXRlZCBieSByZXdyaXR0ZW4gc3RyaW5nLWJhc2VkIHRlbXBsYXRlcykgdGhhdCBoYXZlIHNpbmNlIGJlZW4gcmVtb3ZlZCBkdXJpbmcgYmluZGluZy4KCSAgICAgICAgICAgIC8vIFNvLCB0aGlzIGZ1bmN0aW9uIHRyYW5zbGF0ZXMgdGhlIG9sZCAibWFwIiBvdXRwdXQgYXJyYXkgaW50byBpdHMgYmVzdCBndWVzcyBvZiB0aGUgc2V0IG9mIGN1cnJlbnQgRE9NIG5vZGVzLgoJICAgICAgICAgICAgLy8KCSAgICAgICAgICAgIC8vIFJ1bGVzOgoJICAgICAgICAgICAgLy8gICBbQV0gQW55IGxlYWRpbmcgbm9kZXMgdGhhdCBoYXZlIGJlZW4gcmVtb3ZlZCBzaG91bGQgYmUgaWdub3JlZAoJICAgICAgICAgICAgLy8gICAgICAgVGhlc2UgbW9zdCBsaWtlbHkgY29ycmVzcG9uZCB0byBtZW1vaXphdGlvbiBub2RlcyB0aGF0IHdlcmUgYWxyZWFkeSByZW1vdmVkIGR1cmluZyBiaW5kaW5nCgkgICAgICAgICAgICAvLyAgICAgICBTZWUgaHR0cHM6Ly9naXRodWIuY29tL1N0ZXZlU2FuZGVyc29uL2tub2Nrb3V0L3B1bGwvNDQwCgkgICAgICAgICAgICAvLyAgIFtCXSBXZSB3YW50IHRvIG91dHB1dCBhIGNvbnRpbnVvdXMgc2VyaWVzIG9mIG5vZGVzLiBTbywgaWdub3JlIGFueSBub2RlcyB0aGF0IGhhdmUgYWxyZWFkeSBiZWVuIHJlbW92ZWQsCgkgICAgICAgICAgICAvLyAgICAgICBhbmQgaW5jbHVkZSBhbnkgbm9kZXMgdGhhdCBoYXZlIGJlZW4gaW5zZXJ0ZWQgYW1vbmcgdGhlIHByZXZpb3VzIGNvbGxlY3Rpb24KCgkgICAgICAgICAgICBpZiAoY29udGludW91c05vZGVBcnJheS5sZW5ndGgpIHsKCSAgICAgICAgICAgICAgICAvLyBUaGUgcGFyZW50IG5vZGUgY2FuIGJlIGEgdmlydHVhbCBlbGVtZW50OyBzbyBnZXQgdGhlIHJlYWwgcGFyZW50IG5vZGUKCSAgICAgICAgICAgICAgICBwYXJlbnROb2RlID0gKHBhcmVudE5vZGUubm9kZVR5cGUgPT09IDggJiYgcGFyZW50Tm9kZS5wYXJlbnROb2RlKSB8fCBwYXJlbnROb2RlOwoKCSAgICAgICAgICAgICAgICAvLyBSdWxlIFtBXQoJICAgICAgICAgICAgICAgIHdoaWxlIChjb250aW51b3VzTm9kZUFycmF5Lmxlbmd0aCAmJiBjb250aW51b3VzTm9kZUFycmF5WzBdLnBhcmVudE5vZGUgIT09IHBhcmVudE5vZGUpCgkgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVvdXNOb2RlQXJyYXkuc2hpZnQoKTsKCgkgICAgICAgICAgICAgICAgLy8gUnVsZSBbQl0KCSAgICAgICAgICAgICAgICBpZiAoY29udGludW91c05vZGVBcnJheS5sZW5ndGggPiAxKSB7CgkgICAgICAgICAgICAgICAgICAgIHZhciBjdXJyZW50ID0gY29udGludW91c05vZGVBcnJheVswXSwgbGFzdCA9IGNvbnRpbnVvdXNOb2RlQXJyYXlbY29udGludW91c05vZGVBcnJheS5sZW5ndGggLSAxXTsKCSAgICAgICAgICAgICAgICAgICAgLy8gUmVwbGFjZSB3aXRoIHRoZSBhY3R1YWwgbmV3IGNvbnRpbnVvdXMgbm9kZSBzZXQKCSAgICAgICAgICAgICAgICAgICAgY29udGludW91c05vZGVBcnJheS5sZW5ndGggPSAwOwoJICAgICAgICAgICAgICAgICAgICB3aGlsZSAoY3VycmVudCAhPT0gbGFzdCkgewoJICAgICAgICAgICAgICAgICAgICAgICAgY29udGludW91c05vZGVBcnJheS5wdXNoKGN1cnJlbnQpOwoJICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudCA9IGN1cnJlbnQubmV4dFNpYmxpbmc7CgkgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWN1cnJlbnQpIC8vIFdvbid0IGhhcHBlbiwgZXhjZXB0IGlmIHRoZSBkZXZlbG9wZXIgaGFzIG1hbnVhbGx5IHJlbW92ZWQgc29tZSBET00gZWxlbWVudHMgKHRoZW4gd2UncmUgaW4gYW4gdW5kZWZpbmVkIHNjZW5hcmlvKQoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKCSAgICAgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgICAgICBjb250aW51b3VzTm9kZUFycmF5LnB1c2gobGFzdCk7CgkgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgcmV0dXJuIGNvbnRpbnVvdXNOb2RlQXJyYXk7CgkgICAgICAgIH0sCgoJICAgICAgICBzZXRPcHRpb25Ob2RlU2VsZWN0aW9uU3RhdGU6IGZ1bmN0aW9uIChvcHRpb25Ob2RlLCBpc1NlbGVjdGVkKSB7CgkgICAgICAgICAgICAvLyBJRTYgc29tZXRpbWVzIHRocm93cyAidW5rbm93biBlcnJvciIgaWYgeW91IHRyeSB0byB3cml0ZSB0byAuc2VsZWN0ZWQgZGlyZWN0bHksIHdoZXJlYXMgRmlyZWZveCBzdHJ1Z2dsZXMgd2l0aCBzZXRBdHRyaWJ1dGUuIFBpY2sgb25lIGJhc2VkIG9uIGJyb3dzZXIuCgkgICAgICAgICAgICBpZiAoaWVWZXJzaW9uIDwgNykKCSAgICAgICAgICAgICAgICBvcHRpb25Ob2RlLnNldEF0dHJpYnV0ZSgic2VsZWN0ZWQiLCBpc1NlbGVjdGVkKTsKCSAgICAgICAgICAgIGVsc2UKCSAgICAgICAgICAgICAgICBvcHRpb25Ob2RlLnNlbGVjdGVkID0gaXNTZWxlY3RlZDsKCSAgICAgICAgfSwKCgkgICAgICAgIHN0cmluZ1RyaW06IGZ1bmN0aW9uIChzdHJpbmcpIHsKCSAgICAgICAgICAgIHJldHVybiBzdHJpbmcgPT09IG51bGwgfHwgc3RyaW5nID09PSB1bmRlZmluZWQgPyAnJyA6CgkgICAgICAgICAgICAgICAgc3RyaW5nLnRyaW0gPwoJICAgICAgICAgICAgICAgICAgICBzdHJpbmcudHJpbSgpIDoKCSAgICAgICAgICAgICAgICAgICAgc3RyaW5nLnRvU3RyaW5nKCkucmVwbGFjZSgvXltcc1x4YTBdK3xbXHNceGEwXSskL2csICcnKTsKCSAgICAgICAgfSwKCgkgICAgICAgIHN0cmluZ1N0YXJ0c1dpdGg6IGZ1bmN0aW9uIChzdHJpbmcsIHN0YXJ0c1dpdGgpIHsKCSAgICAgICAgICAgIHN0cmluZyA9IHN0cmluZyB8fCAiIjsKCSAgICAgICAgICAgIGlmIChzdGFydHNXaXRoLmxlbmd0aCA+IHN0cmluZy5sZW5ndGgpCgkgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwoJICAgICAgICAgICAgcmV0dXJuIHN0cmluZy5zdWJzdHJpbmcoMCwgc3RhcnRzV2l0aC5sZW5ndGgpID09PSBzdGFydHNXaXRoOwoJICAgICAgICB9LAoKCSAgICAgICAgZG9tTm9kZUlzQ29udGFpbmVkQnk6IGZ1bmN0aW9uIChub2RlLCBjb250YWluZWRCeU5vZGUpIHsKCSAgICAgICAgICAgIGlmIChub2RlID09PSBjb250YWluZWRCeU5vZGUpCgkgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CgkgICAgICAgICAgICBpZiAobm9kZS5ub2RlVHlwZSA9PT0gMTEpCgkgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOyAvLyBGaXhlcyBpc3N1ZSAjMTE2MiAtIGNhbid0IHVzZSBub2RlLmNvbnRhaW5zIGZvciBkb2N1bWVudCBmcmFnbWVudHMgb24gSUU4CgkgICAgICAgICAgICBpZiAoY29udGFpbmVkQnlOb2RlLmNvbnRhaW5zKQoJICAgICAgICAgICAgICAgIHJldHVybiBjb250YWluZWRCeU5vZGUuY29udGFpbnMobm9kZS5ub2RlVHlwZSA9PT0gMyA/IG5vZGUucGFyZW50Tm9kZSA6IG5vZGUpOwoJICAgICAgICAgICAgaWYgKGNvbnRhaW5lZEJ5Tm9kZS5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbikKCSAgICAgICAgICAgICAgICByZXR1cm4gKGNvbnRhaW5lZEJ5Tm9kZS5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbihub2RlKSAmIDE2KSA9PSAxNjsKCSAgICAgICAgICAgIHdoaWxlIChub2RlICYmIG5vZGUgIT0gY29udGFpbmVkQnlOb2RlKSB7CgkgICAgICAgICAgICAgICAgbm9kZSA9IG5vZGUucGFyZW50Tm9kZTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIHJldHVybiAhIW5vZGU7CgkgICAgICAgIH0sCgoJICAgICAgICBkb21Ob2RlSXNBdHRhY2hlZFRvRG9jdW1lbnQ6IGZ1bmN0aW9uIChub2RlKSB7CgkgICAgICAgICAgICByZXR1cm4ga28udXRpbHMuZG9tTm9kZUlzQ29udGFpbmVkQnkobm9kZSwgbm9kZS5vd25lckRvY3VtZW50LmRvY3VtZW50RWxlbWVudCk7CgkgICAgICAgIH0sCgoJICAgICAgICBhbnlEb21Ob2RlSXNBdHRhY2hlZFRvRG9jdW1lbnQ6IGZ1bmN0aW9uKG5vZGVzKSB7CgkgICAgICAgICAgICByZXR1cm4gISFrby51dGlscy5hcnJheUZpcnN0KG5vZGVzLCBrby51dGlscy5kb21Ob2RlSXNBdHRhY2hlZFRvRG9jdW1lbnQpOwoJICAgICAgICB9LAoKCSAgICAgICAgdGFnTmFtZUxvd2VyOiBmdW5jdGlvbihlbGVtZW50KSB7CgkgICAgICAgICAgICAvLyBGb3IgSFRNTCBlbGVtZW50cywgdGFnTmFtZSB3aWxsIGFsd2F5cyBiZSB1cHBlciBjYXNlOyBmb3IgWEhUTUwgZWxlbWVudHMsIGl0J2xsIGJlIGxvd2VyIGNhc2UuCgkgICAgICAgICAgICAvLyBQb3NzaWJsZSBmdXR1cmUgb3B0aW1pemF0aW9uOiBJZiB3ZSBrbm93IGl0J3MgYW4gZWxlbWVudCBmcm9tIGFuIFhIVE1MIGRvY3VtZW50IChub3QgSFRNTCksCgkgICAgICAgICAgICAvLyB3ZSBkb24ndCBuZWVkIHRvIGRvIHRoZSAudG9Mb3dlckNhc2UoKSBhcyBpdCB3aWxsIGFsd2F5cyBiZSBsb3dlciBjYXNlIGFueXdheS4KCSAgICAgICAgICAgIHJldHVybiBlbGVtZW50ICYmIGVsZW1lbnQudGFnTmFtZSAmJiBlbGVtZW50LnRhZ05hbWUudG9Mb3dlckNhc2UoKTsKCSAgICAgICAgfSwKCgkgICAgICAgIHJlZ2lzdGVyRXZlbnRIYW5kbGVyOiBmdW5jdGlvbiAoZWxlbWVudCwgZXZlbnRUeXBlLCBoYW5kbGVyKSB7CgkgICAgICAgICAgICB2YXIgbXVzdFVzZUF0dGFjaEV2ZW50ID0gaWVWZXJzaW9uICYmIGV2ZW50c1RoYXRNdXN0QmVSZWdpc3RlcmVkVXNpbmdBdHRhY2hFdmVudFtldmVudFR5cGVdOwoJICAgICAgICAgICAgaWYgKCFtdXN0VXNlQXR0YWNoRXZlbnQgJiYgalF1ZXJ5SW5zdGFuY2UpIHsKCSAgICAgICAgICAgICAgICBqUXVlcnlJbnN0YW5jZShlbGVtZW50KVsnYmluZCddKGV2ZW50VHlwZSwgaGFuZGxlcik7CgkgICAgICAgICAgICB9IGVsc2UgaWYgKCFtdXN0VXNlQXR0YWNoRXZlbnQgJiYgdHlwZW9mIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lciA9PSAiZnVuY3Rpb24iKQoJICAgICAgICAgICAgICAgIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcihldmVudFR5cGUsIGhhbmRsZXIsIGZhbHNlKTsKCSAgICAgICAgICAgIGVsc2UgaWYgKHR5cGVvZiBlbGVtZW50LmF0dGFjaEV2ZW50ICE9ICJ1bmRlZmluZWQiKSB7CgkgICAgICAgICAgICAgICAgdmFyIGF0dGFjaEV2ZW50SGFuZGxlciA9IGZ1bmN0aW9uIChldmVudCkgeyBoYW5kbGVyLmNhbGwoZWxlbWVudCwgZXZlbnQpOyB9LAoJICAgICAgICAgICAgICAgICAgICBhdHRhY2hFdmVudE5hbWUgPSAib24iICsgZXZlbnRUeXBlOwoJICAgICAgICAgICAgICAgIGVsZW1lbnQuYXR0YWNoRXZlbnQoYXR0YWNoRXZlbnROYW1lLCBhdHRhY2hFdmVudEhhbmRsZXIpOwoKCSAgICAgICAgICAgICAgICAvLyBJRSBkb2VzIG5vdCBkaXNwb3NlIGF0dGFjaEV2ZW50IGhhbmRsZXJzIGF1dG9tYXRpY2FsbHkgKHVubGlrZSB3aXRoIGFkZEV2ZW50TGlzdGVuZXIpCgkgICAgICAgICAgICAgICAgLy8gc28gdG8gYXZvaWQgbGVha3MsIHdlIGhhdmUgdG8gcmVtb3ZlIHRoZW0gbWFudWFsbHkuIFNlZSBidWcgIzg1NgoJICAgICAgICAgICAgICAgIGtvLnV0aWxzLmRvbU5vZGVEaXNwb3NhbC5hZGREaXNwb3NlQ2FsbGJhY2soZWxlbWVudCwgZnVuY3Rpb24oKSB7CgkgICAgICAgICAgICAgICAgICAgIGVsZW1lbnQuZGV0YWNoRXZlbnQoYXR0YWNoRXZlbnROYW1lLCBhdHRhY2hFdmVudEhhbmRsZXIpOwoJICAgICAgICAgICAgICAgIH0pOwoJICAgICAgICAgICAgfSBlbHNlCgkgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJCcm93c2VyIGRvZXNuJ3Qgc3VwcG9ydCBhZGRFdmVudExpc3RlbmVyIG9yIGF0dGFjaEV2ZW50Iik7CgkgICAgICAgIH0sCgoJICAgICAgICB0cmlnZ2VyRXZlbnQ6IGZ1bmN0aW9uIChlbGVtZW50LCBldmVudFR5cGUpIHsKCSAgICAgICAgICAgIGlmICghKGVsZW1lbnQgJiYgZWxlbWVudC5ub2RlVHlwZSkpCgkgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJlbGVtZW50IG11c3QgYmUgYSBET00gbm9kZSB3aGVuIGNhbGxpbmcgdHJpZ2dlckV2ZW50Iik7CgoJICAgICAgICAgICAgLy8gRm9yIGNsaWNrIGV2ZW50cyBvbiBjaGVja2JveGVzIGFuZCByYWRpbyBidXR0b25zLCBqUXVlcnkgdG9nZ2xlcyB0aGUgZWxlbWVudCBjaGVja2VkIHN0YXRlICphZnRlciogdGhlCgkgICAgICAgICAgICAvLyBldmVudCBoYW5kbGVyIHJ1bnMgaW5zdGVhZCBvZiAqYmVmb3JlKi4gKFRoaXMgd2FzIGZpeGVkIGluIDEuOSBmb3IgY2hlY2tib3hlcyBidXQgbm90IGZvciByYWRpbyBidXR0b25zLikKCSAgICAgICAgICAgIC8vIElFIGRvZXNuJ3QgY2hhbmdlIHRoZSBjaGVja2VkIHN0YXRlIHdoZW4geW91IHRyaWdnZXIgdGhlIGNsaWNrIGV2ZW50IHVzaW5nICJmaXJlRXZlbnQiLgoJICAgICAgICAgICAgLy8gSW4gYm90aCBjYXNlcywgd2UnbGwgdXNlIHRoZSBjbGljayBtZXRob2QgaW5zdGVhZC4KCSAgICAgICAgICAgIHZhciB1c2VDbGlja1dvcmthcm91bmQgPSBpc0NsaWNrT25DaGVja2FibGVFbGVtZW50KGVsZW1lbnQsIGV2ZW50VHlwZSk7CgoJICAgICAgICAgICAgaWYgKGpRdWVyeUluc3RhbmNlICYmICF1c2VDbGlja1dvcmthcm91bmQpIHsKCSAgICAgICAgICAgICAgICBqUXVlcnlJbnN0YW5jZShlbGVtZW50KVsndHJpZ2dlciddKGV2ZW50VHlwZSk7CgkgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBkb2N1bWVudC5jcmVhdGVFdmVudCA9PSAiZnVuY3Rpb24iKSB7CgkgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBlbGVtZW50LmRpc3BhdGNoRXZlbnQgPT0gImZ1bmN0aW9uIikgewoJICAgICAgICAgICAgICAgICAgICB2YXIgZXZlbnRDYXRlZ29yeSA9IGtub3duRXZlbnRUeXBlc0J5RXZlbnROYW1lW2V2ZW50VHlwZV0gfHwgIkhUTUxFdmVudHMiOwoJICAgICAgICAgICAgICAgICAgICB2YXIgZXZlbnQgPSBkb2N1bWVudC5jcmVhdGVFdmVudChldmVudENhdGVnb3J5KTsKCSAgICAgICAgICAgICAgICAgICAgZXZlbnQuaW5pdEV2ZW50KGV2ZW50VHlwZSwgdHJ1ZSwgdHJ1ZSwgd2luZG93LCAwLCAwLCAwLCAwLCAwLCBmYWxzZSwgZmFsc2UsIGZhbHNlLCBmYWxzZSwgMCwgZWxlbWVudCk7CgkgICAgICAgICAgICAgICAgICAgIGVsZW1lbnQuZGlzcGF0Y2hFdmVudChldmVudCk7CgkgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgIGVsc2UKCSAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUaGUgc3VwcGxpZWQgZWxlbWVudCBkb2Vzbid0IHN1cHBvcnQgZGlzcGF0Y2hFdmVudCIpOwoJICAgICAgICAgICAgfSBlbHNlIGlmICh1c2VDbGlja1dvcmthcm91bmQgJiYgZWxlbWVudC5jbGljaykgewoJICAgICAgICAgICAgICAgIGVsZW1lbnQuY2xpY2soKTsKCSAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGVsZW1lbnQuZmlyZUV2ZW50ICE9ICJ1bmRlZmluZWQiKSB7CgkgICAgICAgICAgICAgICAgZWxlbWVudC5maXJlRXZlbnQoIm9uIiArIGV2ZW50VHlwZSk7CgkgICAgICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQnJvd3NlciBkb2Vzbid0IHN1cHBvcnQgdHJpZ2dlcmluZyBldmVudHMiKTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgfSwKCgkgICAgICAgIHVud3JhcE9ic2VydmFibGU6IGZ1bmN0aW9uICh2YWx1ZSkgewoJICAgICAgICAgICAgcmV0dXJuIGtvLmlzT2JzZXJ2YWJsZSh2YWx1ZSkgPyB2YWx1ZSgpIDogdmFsdWU7CgkgICAgICAgIH0sCgoJICAgICAgICBwZWVrT2JzZXJ2YWJsZTogZnVuY3Rpb24gKHZhbHVlKSB7CgkgICAgICAgICAgICByZXR1cm4ga28uaXNPYnNlcnZhYmxlKHZhbHVlKSA/IHZhbHVlLnBlZWsoKSA6IHZhbHVlOwoJICAgICAgICB9LAoKCSAgICAgICAgdG9nZ2xlRG9tTm9kZUNzc0NsYXNzOiBmdW5jdGlvbiAobm9kZSwgY2xhc3NOYW1lcywgc2hvdWxkSGF2ZUNsYXNzKSB7CgkgICAgICAgICAgICBpZiAoY2xhc3NOYW1lcykgewoJICAgICAgICAgICAgICAgIHZhciBjc3NDbGFzc05hbWVSZWdleCA9IC9cUysvZywKCSAgICAgICAgICAgICAgICAgICAgY3VycmVudENsYXNzTmFtZXMgPSBub2RlLmNsYXNzTmFtZS5tYXRjaChjc3NDbGFzc05hbWVSZWdleCkgfHwgW107CgkgICAgICAgICAgICAgICAga28udXRpbHMuYXJyYXlGb3JFYWNoKGNsYXNzTmFtZXMubWF0Y2goY3NzQ2xhc3NOYW1lUmVnZXgpLCBmdW5jdGlvbihjbGFzc05hbWUpIHsKCSAgICAgICAgICAgICAgICAgICAga28udXRpbHMuYWRkT3JSZW1vdmVJdGVtKGN1cnJlbnRDbGFzc05hbWVzLCBjbGFzc05hbWUsIHNob3VsZEhhdmVDbGFzcyk7CgkgICAgICAgICAgICAgICAgfSk7CgkgICAgICAgICAgICAgICAgbm9kZS5jbGFzc05hbWUgPSBjdXJyZW50Q2xhc3NOYW1lcy5qb2luKCIgIik7CgkgICAgICAgICAgICB9CgkgICAgICAgIH0sCgoJICAgICAgICBzZXRUZXh0Q29udGVudDogZnVuY3Rpb24oZWxlbWVudCwgdGV4dENvbnRlbnQpIHsKCSAgICAgICAgICAgIHZhciB2YWx1ZSA9IGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUodGV4dENvbnRlbnQpOwoJICAgICAgICAgICAgaWYgKCh2YWx1ZSA9PT0gbnVsbCkgfHwgKHZhbHVlID09PSB1bmRlZmluZWQpKQoJICAgICAgICAgICAgICAgIHZhbHVlID0gIiI7CgoJICAgICAgICAgICAgLy8gV2UgbmVlZCB0aGVyZSB0byBiZSBleGFjdGx5IG9uZSBjaGlsZDogYSB0ZXh0IG5vZGUuCgkgICAgICAgICAgICAvLyBJZiB0aGVyZSBhcmUgbm8gY2hpbGRyZW4sIG1vcmUgdGhhbiBvbmUsIG9yIGlmIGl0J3Mgbm90IGEgdGV4dCBub2RlLAoJICAgICAgICAgICAgLy8gd2UnbGwgY2xlYXIgZXZlcnl0aGluZyBhbmQgY3JlYXRlIGEgc2luZ2xlIHRleHQgbm9kZS4KCSAgICAgICAgICAgIHZhciBpbm5lclRleHROb2RlID0ga28udmlydHVhbEVsZW1lbnRzLmZpcnN0Q2hpbGQoZWxlbWVudCk7CgkgICAgICAgICAgICBpZiAoIWlubmVyVGV4dE5vZGUgfHwgaW5uZXJUZXh0Tm9kZS5ub2RlVHlwZSAhPSAzIHx8IGtvLnZpcnR1YWxFbGVtZW50cy5uZXh0U2libGluZyhpbm5lclRleHROb2RlKSkgewoJICAgICAgICAgICAgICAgIGtvLnZpcnR1YWxFbGVtZW50cy5zZXREb21Ob2RlQ2hpbGRyZW4oZWxlbWVudCwgW2VsZW1lbnQub3duZXJEb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSh2YWx1ZSldKTsKCSAgICAgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICAgICAgaW5uZXJUZXh0Tm9kZS5kYXRhID0gdmFsdWU7CgkgICAgICAgICAgICB9CgoJICAgICAgICAgICAga28udXRpbHMuZm9yY2VSZWZyZXNoKGVsZW1lbnQpOwoJICAgICAgICB9LAoKCSAgICAgICAgc2V0RWxlbWVudE5hbWU6IGZ1bmN0aW9uKGVsZW1lbnQsIG5hbWUpIHsKCSAgICAgICAgICAgIGVsZW1lbnQubmFtZSA9IG5hbWU7CgoJICAgICAgICAgICAgLy8gV29ya2Fyb3VuZCBJRSA2LzcgaXNzdWUKCSAgICAgICAgICAgIC8vIC0gaHR0cHM6Ly9naXRodWIuY29tL1N0ZXZlU2FuZGVyc29uL2tub2Nrb3V0L2lzc3Vlcy8xOTcKCSAgICAgICAgICAgIC8vIC0gaHR0cDovL3d3dy5tYXR0czQxMS5jb20vcG9zdC9zZXR0aW5nX3RoZV9uYW1lX2F0dHJpYnV0ZV9pbl9pZV9kb20vCgkgICAgICAgICAgICBpZiAoaWVWZXJzaW9uIDw9IDcpIHsKCSAgICAgICAgICAgICAgICB0cnkgewoJICAgICAgICAgICAgICAgICAgICBlbGVtZW50Lm1lcmdlQXR0cmlidXRlcyhkb2N1bWVudC5jcmVhdGVFbGVtZW50KCI8aW5wdXQgbmFtZT0nIiArIGVsZW1lbnQubmFtZSArICInLz4iKSwgZmFsc2UpOwoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICBjYXRjaChlKSB7fSAvLyBGb3IgSUU5IHdpdGggZG9jIG1vZGUgIklFOSBTdGFuZGFyZHMiIGFuZCBicm93c2VyIG1vZGUgIklFOSBDb21wYXRpYmlsaXR5IFZpZXciCgkgICAgICAgICAgICB9CgkgICAgICAgIH0sCgoJICAgICAgICBmb3JjZVJlZnJlc2g6IGZ1bmN0aW9uKG5vZGUpIHsKCSAgICAgICAgICAgIC8vIFdvcmthcm91bmQgZm9yIGFuIElFOSByZW5kZXJpbmcgYnVnIC0gaHR0cHM6Ly9naXRodWIuY29tL1N0ZXZlU2FuZGVyc29uL2tub2Nrb3V0L2lzc3Vlcy8yMDkKCSAgICAgICAgICAgIGlmIChpZVZlcnNpb24gPj0gOSkgewoJICAgICAgICAgICAgICAgIC8vIEZvciB0ZXh0IG5vZGVzIGFuZCBjb21tZW50IG5vZGVzIChtb3N0IGxpa2VseSB2aXJ0dWFsIGVsZW1lbnRzKSwgd2Ugd2lsbCBoYXZlIHRvIHJlZnJlc2ggdGhlIGNvbnRhaW5lcgoJICAgICAgICAgICAgICAgIHZhciBlbGVtID0gbm9kZS5ub2RlVHlwZSA9PSAxID8gbm9kZSA6IG5vZGUucGFyZW50Tm9kZTsKCSAgICAgICAgICAgICAgICBpZiAoZWxlbS5zdHlsZSkKCSAgICAgICAgICAgICAgICAgICAgZWxlbS5zdHlsZS56b29tID0gZWxlbS5zdHlsZS56b29tOwoJICAgICAgICAgICAgfQoJICAgICAgICB9LAoKCSAgICAgICAgZW5zdXJlU2VsZWN0RWxlbWVudElzUmVuZGVyZWRDb3JyZWN0bHk6IGZ1bmN0aW9uKHNlbGVjdEVsZW1lbnQpIHsKCSAgICAgICAgICAgIC8vIFdvcmthcm91bmQgZm9yIElFOSByZW5kZXJpbmcgYnVnIC0gaXQgZG9lc24ndCByZWxpYWJseSBkaXNwbGF5IGFsbCB0aGUgdGV4dCBpbiBkeW5hbWljYWxseS1hZGRlZCBzZWxlY3QgYm94ZXMgdW5sZXNzIHlvdSBmb3JjZSBpdCB0byByZS1yZW5kZXIgYnkgdXBkYXRpbmcgdGhlIHdpZHRoLgoJICAgICAgICAgICAgLy8gKFNlZSBodHRwczovL2dpdGh1Yi5jb20vU3RldmVTYW5kZXJzb24va25vY2tvdXQvaXNzdWVzLzMxMiwgaHR0cDovL3N0YWNrb3ZlcmZsb3cuY29tL3F1ZXN0aW9ucy81OTA4NDk0L3NlbGVjdC1vbmx5LXNob3dzLWZpcnN0LWNoYXItb2Ytc2VsZWN0ZWQtb3B0aW9uKQoJICAgICAgICAgICAgLy8gQWxzbyBmaXhlcyBJRTcgYW5kIElFOCBidWcgdGhhdCBjYXVzZXMgc2VsZWN0cyB0byBiZSB6ZXJvIHdpZHRoIGlmIGVuY2xvc2VkIGJ5ICdpZicgb3IgJ3dpdGgnLiAoU2VlIGlzc3VlICM4MzkpCgkgICAgICAgICAgICBpZiAoaWVWZXJzaW9uKSB7CgkgICAgICAgICAgICAgICAgdmFyIG9yaWdpbmFsV2lkdGggPSBzZWxlY3RFbGVtZW50LnN0eWxlLndpZHRoOwoJICAgICAgICAgICAgICAgIHNlbGVjdEVsZW1lbnQuc3R5bGUud2lkdGggPSAwOwoJICAgICAgICAgICAgICAgIHNlbGVjdEVsZW1lbnQuc3R5bGUud2lkdGggPSBvcmlnaW5hbFdpZHRoOwoJICAgICAgICAgICAgfQoJICAgICAgICB9LAoKCSAgICAgICAgcmFuZ2U6IGZ1bmN0aW9uIChtaW4sIG1heCkgewoJICAgICAgICAgICAgbWluID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZShtaW4pOwoJICAgICAgICAgICAgbWF4ID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZShtYXgpOwoJICAgICAgICAgICAgdmFyIHJlc3VsdCA9IFtdOwoJICAgICAgICAgICAgZm9yICh2YXIgaSA9IG1pbjsgaSA8PSBtYXg7IGkrKykKCSAgICAgICAgICAgICAgICByZXN1bHQucHVzaChpKTsKCSAgICAgICAgICAgIHJldHVybiByZXN1bHQ7CgkgICAgICAgIH0sCgoJICAgICAgICBtYWtlQXJyYXk6IGZ1bmN0aW9uKGFycmF5TGlrZU9iamVjdCkgewoJICAgICAgICAgICAgdmFyIHJlc3VsdCA9IFtdOwoJICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGogPSBhcnJheUxpa2VPYmplY3QubGVuZ3RoOyBpIDwgajsgaSsrKSB7CgkgICAgICAgICAgICAgICAgcmVzdWx0LnB1c2goYXJyYXlMaWtlT2JqZWN0W2ldKTsKCSAgICAgICAgICAgIH07CgkgICAgICAgICAgICByZXR1cm4gcmVzdWx0OwoJICAgICAgICB9LAoKCSAgICAgICAgaXNJZTYgOiBpc0llNiwKCSAgICAgICAgaXNJZTcgOiBpc0llNywKCSAgICAgICAgaWVWZXJzaW9uIDogaWVWZXJzaW9uLAoKCSAgICAgICAgZ2V0Rm9ybUZpZWxkczogZnVuY3Rpb24oZm9ybSwgZmllbGROYW1lKSB7CgkgICAgICAgICAgICB2YXIgZmllbGRzID0ga28udXRpbHMubWFrZUFycmF5KGZvcm0uZ2V0RWxlbWVudHNCeVRhZ05hbWUoImlucHV0IikpLmNvbmNhdChrby51dGlscy5tYWtlQXJyYXkoZm9ybS5nZXRFbGVtZW50c0J5VGFnTmFtZSgidGV4dGFyZWEiKSkpOwoJICAgICAgICAgICAgdmFyIGlzTWF0Y2hpbmdGaWVsZCA9ICh0eXBlb2YgZmllbGROYW1lID09ICdzdHJpbmcnKQoJICAgICAgICAgICAgICAgID8gZnVuY3Rpb24oZmllbGQpIHsgcmV0dXJuIGZpZWxkLm5hbWUgPT09IGZpZWxkTmFtZSB9CgkgICAgICAgICAgICAgICAgOiBmdW5jdGlvbihmaWVsZCkgeyByZXR1cm4gZmllbGROYW1lLnRlc3QoZmllbGQubmFtZSkgfTsgLy8gVHJlYXQgZmllbGROYW1lIGFzIHJlZ2V4IG9yIG9iamVjdCBjb250YWluaW5nIHByZWRpY2F0ZQoJICAgICAgICAgICAgdmFyIG1hdGNoZXMgPSBbXTsKCSAgICAgICAgICAgIGZvciAodmFyIGkgPSBmaWVsZHMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKCSAgICAgICAgICAgICAgICBpZiAoaXNNYXRjaGluZ0ZpZWxkKGZpZWxkc1tpXSkpCgkgICAgICAgICAgICAgICAgICAgIG1hdGNoZXMucHVzaChmaWVsZHNbaV0pOwoJICAgICAgICAgICAgfTsKCSAgICAgICAgICAgIHJldHVybiBtYXRjaGVzOwoJICAgICAgICB9LAoKCSAgICAgICAgcGFyc2VKc29uOiBmdW5jdGlvbiAoanNvblN0cmluZykgewoJICAgICAgICAgICAgaWYgKHR5cGVvZiBqc29uU3RyaW5nID09ICJzdHJpbmciKSB7CgkgICAgICAgICAgICAgICAganNvblN0cmluZyA9IGtvLnV0aWxzLnN0cmluZ1RyaW0oanNvblN0cmluZyk7CgkgICAgICAgICAgICAgICAgaWYgKGpzb25TdHJpbmcpIHsKCSAgICAgICAgICAgICAgICAgICAgaWYgKEpTT04gJiYgSlNPTi5wYXJzZSkgLy8gVXNlIG5hdGl2ZSBwYXJzaW5nIHdoZXJlIGF2YWlsYWJsZQoJICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEpTT04ucGFyc2UoanNvblN0cmluZyk7CgkgICAgICAgICAgICAgICAgICAgIHJldHVybiAobmV3IEZ1bmN0aW9uKCJyZXR1cm4gIiArIGpzb25TdHJpbmcpKSgpOyAvLyBGYWxsYmFjayBvbiBsZXNzIHNhZmUgcGFyc2luZyBmb3Igb2xkZXIgYnJvd3NlcnMKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICByZXR1cm4gbnVsbDsKCSAgICAgICAgfSwKCgkgICAgICAgIHN0cmluZ2lmeUpzb246IGZ1bmN0aW9uIChkYXRhLCByZXBsYWNlciwgc3BhY2UpIHsgICAvLyByZXBsYWNlciBhbmQgc3BhY2UgYXJlIG9wdGlvbmFsCgkgICAgICAgICAgICBpZiAoIUpTT04gfHwgIUpTT04uc3RyaW5naWZ5KQoJICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQ2Fubm90IGZpbmQgSlNPTi5zdHJpbmdpZnkoKS4gU29tZSBicm93c2VycyAoZS5nLiwgSUUgPCA4KSBkb24ndCBzdXBwb3J0IGl0IG5hdGl2ZWx5LCBidXQgeW91IGNhbiBvdmVyY29tZSB0aGlzIGJ5IGFkZGluZyBhIHNjcmlwdCByZWZlcmVuY2UgdG8ganNvbjIuanMsIGRvd25sb2FkYWJsZSBmcm9tIGh0dHA6Ly93d3cuanNvbi5vcmcvanNvbjIuanMiKTsKCSAgICAgICAgICAgIHJldHVybiBKU09OLnN0cmluZ2lmeShrby51dGlscy51bndyYXBPYnNlcnZhYmxlKGRhdGEpLCByZXBsYWNlciwgc3BhY2UpOwoJICAgICAgICB9LAoKCSAgICAgICAgcG9zdEpzb246IGZ1bmN0aW9uICh1cmxPckZvcm0sIGRhdGEsIG9wdGlvbnMpIHsKCSAgICAgICAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoJICAgICAgICAgICAgdmFyIHBhcmFtcyA9IG9wdGlvbnNbJ3BhcmFtcyddIHx8IHt9OwoJICAgICAgICAgICAgdmFyIGluY2x1ZGVGaWVsZHMgPSBvcHRpb25zWydpbmNsdWRlRmllbGRzJ10gfHwgdGhpcy5maWVsZHNJbmNsdWRlZFdpdGhKc29uUG9zdDsKCSAgICAgICAgICAgIHZhciB1cmwgPSB1cmxPckZvcm07CgoJICAgICAgICAgICAgLy8gSWYgd2Ugd2VyZSBnaXZlbiBhIGZvcm0sIHVzZSBpdHMgJ2FjdGlvbicgVVJMIGFuZCBwaWNrIG91dCBhbnkgcmVxdWVzdGVkIGZpZWxkIHZhbHVlcwoJICAgICAgICAgICAgaWYoKHR5cGVvZiB1cmxPckZvcm0gPT0gJ29iamVjdCcpICYmIChrby51dGlscy50YWdOYW1lTG93ZXIodXJsT3JGb3JtKSA9PT0gImZvcm0iKSkgewoJICAgICAgICAgICAgICAgIHZhciBvcmlnaW5hbEZvcm0gPSB1cmxPckZvcm07CgkgICAgICAgICAgICAgICAgdXJsID0gb3JpZ2luYWxGb3JtLmFjdGlvbjsKCSAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gaW5jbHVkZUZpZWxkcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewoJICAgICAgICAgICAgICAgICAgICB2YXIgZmllbGRzID0ga28udXRpbHMuZ2V0Rm9ybUZpZWxkcyhvcmlnaW5hbEZvcm0sIGluY2x1ZGVGaWVsZHNbaV0pOwoJICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBqID0gZmllbGRzLmxlbmd0aCAtIDE7IGogPj0gMDsgai0tKQoJICAgICAgICAgICAgICAgICAgICAgICAgcGFyYW1zW2ZpZWxkc1tqXS5uYW1lXSA9IGZpZWxkc1tqXS52YWx1ZTsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICB9CgoJICAgICAgICAgICAgZGF0YSA9IGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUoZGF0YSk7CgkgICAgICAgICAgICB2YXIgZm9ybSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImZvcm0iKTsKCSAgICAgICAgICAgIGZvcm0uc3R5bGUuZGlzcGxheSA9ICJub25lIjsKCSAgICAgICAgICAgIGZvcm0uYWN0aW9uID0gdXJsOwoJICAgICAgICAgICAgZm9ybS5tZXRob2QgPSAicG9zdCI7CgkgICAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gZGF0YSkgewoJICAgICAgICAgICAgICAgIC8vIFNpbmNlICdkYXRhJyB0aGlzIGlzIGEgbW9kZWwgb2JqZWN0LCB3ZSBpbmNsdWRlIGFsbCBwcm9wZXJ0aWVzIGluY2x1ZGluZyB0aG9zZSBpbmhlcml0ZWQgZnJvbSBpdHMgcHJvdG90eXBlCgkgICAgICAgICAgICAgICAgdmFyIGlucHV0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiaW5wdXQiKTsKCSAgICAgICAgICAgICAgICBpbnB1dC50eXBlID0gImhpZGRlbiI7CgkgICAgICAgICAgICAgICAgaW5wdXQubmFtZSA9IGtleTsKCSAgICAgICAgICAgICAgICBpbnB1dC52YWx1ZSA9IGtvLnV0aWxzLnN0cmluZ2lmeUpzb24oa28udXRpbHMudW53cmFwT2JzZXJ2YWJsZShkYXRhW2tleV0pKTsKCSAgICAgICAgICAgICAgICBmb3JtLmFwcGVuZENoaWxkKGlucHV0KTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIG9iamVjdEZvckVhY2gocGFyYW1zLCBmdW5jdGlvbihrZXksIHZhbHVlKSB7CgkgICAgICAgICAgICAgICAgdmFyIGlucHV0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiaW5wdXQiKTsKCSAgICAgICAgICAgICAgICBpbnB1dC50eXBlID0gImhpZGRlbiI7CgkgICAgICAgICAgICAgICAgaW5wdXQubmFtZSA9IGtleTsKCSAgICAgICAgICAgICAgICBpbnB1dC52YWx1ZSA9IHZhbHVlOwoJICAgICAgICAgICAgICAgIGZvcm0uYXBwZW5kQ2hpbGQoaW5wdXQpOwoJICAgICAgICAgICAgfSk7CgkgICAgICAgICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKGZvcm0pOwoJICAgICAgICAgICAgb3B0aW9uc1snc3VibWl0dGVyJ10gPyBvcHRpb25zWydzdWJtaXR0ZXInXShmb3JtKSA6IGZvcm0uc3VibWl0KCk7CgkgICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsgZm9ybS5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKGZvcm0pOyB9LCAwKTsKCSAgICAgICAgfQoJICAgIH0KCX0oKSk7CgoJa28uZXhwb3J0U3ltYm9sKCd1dGlscycsIGtvLnV0aWxzKTsKCWtvLmV4cG9ydFN5bWJvbCgndXRpbHMuYXJyYXlGb3JFYWNoJywga28udXRpbHMuYXJyYXlGb3JFYWNoKTsKCWtvLmV4cG9ydFN5bWJvbCgndXRpbHMuYXJyYXlGaXJzdCcsIGtvLnV0aWxzLmFycmF5Rmlyc3QpOwoJa28uZXhwb3J0U3ltYm9sKCd1dGlscy5hcnJheUZpbHRlcicsIGtvLnV0aWxzLmFycmF5RmlsdGVyKTsKCWtvLmV4cG9ydFN5bWJvbCgndXRpbHMuYXJyYXlHZXREaXN0aW5jdFZhbHVlcycsIGtvLnV0aWxzLmFycmF5R2V0RGlzdGluY3RWYWx1ZXMpOwoJa28uZXhwb3J0U3ltYm9sKCd1dGlscy5hcnJheUluZGV4T2YnLCBrby51dGlscy5hcnJheUluZGV4T2YpOwoJa28uZXhwb3J0U3ltYm9sKCd1dGlscy5hcnJheU1hcCcsIGtvLnV0aWxzLmFycmF5TWFwKTsKCWtvLmV4cG9ydFN5bWJvbCgndXRpbHMuYXJyYXlQdXNoQWxsJywga28udXRpbHMuYXJyYXlQdXNoQWxsKTsKCWtvLmV4cG9ydFN5bWJvbCgndXRpbHMuYXJyYXlSZW1vdmVJdGVtJywga28udXRpbHMuYXJyYXlSZW1vdmVJdGVtKTsKCWtvLmV4cG9ydFN5bWJvbCgndXRpbHMuZXh0ZW5kJywga28udXRpbHMuZXh0ZW5kKTsKCWtvLmV4cG9ydFN5bWJvbCgndXRpbHMuZmllbGRzSW5jbHVkZWRXaXRoSnNvblBvc3QnLCBrby51dGlscy5maWVsZHNJbmNsdWRlZFdpdGhKc29uUG9zdCk7Cglrby5leHBvcnRTeW1ib2woJ3V0aWxzLmdldEZvcm1GaWVsZHMnLCBrby51dGlscy5nZXRGb3JtRmllbGRzKTsKCWtvLmV4cG9ydFN5bWJvbCgndXRpbHMucGVla09ic2VydmFibGUnLCBrby51dGlscy5wZWVrT2JzZXJ2YWJsZSk7Cglrby5leHBvcnRTeW1ib2woJ3V0aWxzLnBvc3RKc29uJywga28udXRpbHMucG9zdEpzb24pOwoJa28uZXhwb3J0U3ltYm9sKCd1dGlscy5wYXJzZUpzb24nLCBrby51dGlscy5wYXJzZUpzb24pOwoJa28uZXhwb3J0U3ltYm9sKCd1dGlscy5yZWdpc3RlckV2ZW50SGFuZGxlcicsIGtvLnV0aWxzLnJlZ2lzdGVyRXZlbnRIYW5kbGVyKTsKCWtvLmV4cG9ydFN5bWJvbCgndXRpbHMuc3RyaW5naWZ5SnNvbicsIGtvLnV0aWxzLnN0cmluZ2lmeUpzb24pOwoJa28uZXhwb3J0U3ltYm9sKCd1dGlscy5yYW5nZScsIGtvLnV0aWxzLnJhbmdlKTsKCWtvLmV4cG9ydFN5bWJvbCgndXRpbHMudG9nZ2xlRG9tTm9kZUNzc0NsYXNzJywga28udXRpbHMudG9nZ2xlRG9tTm9kZUNzc0NsYXNzKTsKCWtvLmV4cG9ydFN5bWJvbCgndXRpbHMudHJpZ2dlckV2ZW50Jywga28udXRpbHMudHJpZ2dlckV2ZW50KTsKCWtvLmV4cG9ydFN5bWJvbCgndXRpbHMudW53cmFwT2JzZXJ2YWJsZScsIGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUpOwoJa28uZXhwb3J0U3ltYm9sKCd1dGlscy5vYmplY3RGb3JFYWNoJywga28udXRpbHMub2JqZWN0Rm9yRWFjaCk7Cglrby5leHBvcnRTeW1ib2woJ3V0aWxzLmFkZE9yUmVtb3ZlSXRlbScsIGtvLnV0aWxzLmFkZE9yUmVtb3ZlSXRlbSk7Cglrby5leHBvcnRTeW1ib2woJ3Vud3JhcCcsIGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUpOyAvLyBDb252ZW5pZW50IHNob3J0aGFuZCwgYmVjYXVzZSB0aGlzIGlzIHVzZWQgc28gY29tbW9ubHkKCglpZiAoIUZ1bmN0aW9uLnByb3RvdHlwZVsnYmluZCddKSB7CgkgICAgLy8gRnVuY3Rpb24ucHJvdG90eXBlLmJpbmQgaXMgYSBzdGFuZGFyZCBwYXJ0IG9mIEVDTUFTY3JpcHQgNXRoIEVkaXRpb24gKERlY2VtYmVyIDIwMDksIGh0dHA6Ly93d3cuZWNtYS1pbnRlcm5hdGlvbmFsLm9yZy9wdWJsaWNhdGlvbnMvZmlsZXMvRUNNQS1TVC9FQ01BLTI2Mi5wZGYpCgkgICAgLy8gSW4gY2FzZSB0aGUgYnJvd3NlciBkb2Vzbid0IGltcGxlbWVudCBpdCBuYXRpdmVseSwgcHJvdmlkZSBhIEphdmFTY3JpcHQgaW1wbGVtZW50YXRpb24uIFRoaXMgaW1wbGVtZW50YXRpb24gaXMgYmFzZWQgb24gdGhlIG9uZSBpbiBwcm90b3R5cGUuanMKCSAgICBGdW5jdGlvbi5wcm90b3R5cGVbJ2JpbmQnXSA9IGZ1bmN0aW9uIChvYmplY3QpIHsKCSAgICAgICAgdmFyIG9yaWdpbmFsRnVuY3Rpb24gPSB0aGlzLCBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzKSwgb2JqZWN0ID0gYXJncy5zaGlmdCgpOwoJICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewoJICAgICAgICAgICAgcmV0dXJuIG9yaWdpbmFsRnVuY3Rpb24uYXBwbHkob2JqZWN0LCBhcmdzLmNvbmNhdChBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMpKSk7CgkgICAgICAgIH07CgkgICAgfTsKCX0KCglrby51dGlscy5kb21EYXRhID0gbmV3IChmdW5jdGlvbiAoKSB7CgkgICAgdmFyIHVuaXF1ZUlkID0gMDsKCSAgICB2YXIgZGF0YVN0b3JlS2V5RXhwYW5kb1Byb3BlcnR5TmFtZSA9ICJfX2tvX18iICsgKG5ldyBEYXRlKS5nZXRUaW1lKCk7CgkgICAgdmFyIGRhdGFTdG9yZSA9IHt9OwoKCSAgICBmdW5jdGlvbiBnZXRBbGwobm9kZSwgY3JlYXRlSWZOb3RGb3VuZCkgewoJICAgICAgICB2YXIgZGF0YVN0b3JlS2V5ID0gbm9kZVtkYXRhU3RvcmVLZXlFeHBhbmRvUHJvcGVydHlOYW1lXTsKCSAgICAgICAgdmFyIGhhc0V4aXN0aW5nRGF0YVN0b3JlID0gZGF0YVN0b3JlS2V5ICYmIChkYXRhU3RvcmVLZXkgIT09ICJudWxsIikgJiYgZGF0YVN0b3JlW2RhdGFTdG9yZUtleV07CgkgICAgICAgIGlmICghaGFzRXhpc3RpbmdEYXRhU3RvcmUpIHsKCSAgICAgICAgICAgIGlmICghY3JlYXRlSWZOb3RGb3VuZCkKCSAgICAgICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwoJICAgICAgICAgICAgZGF0YVN0b3JlS2V5ID0gbm9kZVtkYXRhU3RvcmVLZXlFeHBhbmRvUHJvcGVydHlOYW1lXSA9ICJrbyIgKyB1bmlxdWVJZCsrOwoJICAgICAgICAgICAgZGF0YVN0b3JlW2RhdGFTdG9yZUtleV0gPSB7fTsKCSAgICAgICAgfQoJICAgICAgICByZXR1cm4gZGF0YVN0b3JlW2RhdGFTdG9yZUtleV07CgkgICAgfQoKCSAgICByZXR1cm4gewoJICAgICAgICBnZXQ6IGZ1bmN0aW9uIChub2RlLCBrZXkpIHsKCSAgICAgICAgICAgIHZhciBhbGxEYXRhRm9yTm9kZSA9IGdldEFsbChub2RlLCBmYWxzZSk7CgkgICAgICAgICAgICByZXR1cm4gYWxsRGF0YUZvck5vZGUgPT09IHVuZGVmaW5lZCA/IHVuZGVmaW5lZCA6IGFsbERhdGFGb3JOb2RlW2tleV07CgkgICAgICAgIH0sCgkgICAgICAgIHNldDogZnVuY3Rpb24gKG5vZGUsIGtleSwgdmFsdWUpIHsKCSAgICAgICAgICAgIGlmICh2YWx1ZSA9PT0gdW5kZWZpbmVkKSB7CgkgICAgICAgICAgICAgICAgLy8gTWFrZSBzdXJlIHdlIGRvbid0IGFjdHVhbGx5IGNyZWF0ZSBhIG5ldyBkb21EYXRhIGtleSBpZiB3ZSBhcmUgYWN0dWFsbHkgZGVsZXRpbmcgYSB2YWx1ZQoJICAgICAgICAgICAgICAgIGlmIChnZXRBbGwobm9kZSwgZmFsc2UpID09PSB1bmRlZmluZWQpCgkgICAgICAgICAgICAgICAgICAgIHJldHVybjsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIHZhciBhbGxEYXRhRm9yTm9kZSA9IGdldEFsbChub2RlLCB0cnVlKTsKCSAgICAgICAgICAgIGFsbERhdGFGb3JOb2RlW2tleV0gPSB2YWx1ZTsKCSAgICAgICAgfSwKCSAgICAgICAgY2xlYXI6IGZ1bmN0aW9uIChub2RlKSB7CgkgICAgICAgICAgICB2YXIgZGF0YVN0b3JlS2V5ID0gbm9kZVtkYXRhU3RvcmVLZXlFeHBhbmRvUHJvcGVydHlOYW1lXTsKCSAgICAgICAgICAgIGlmIChkYXRhU3RvcmVLZXkpIHsKCSAgICAgICAgICAgICAgICBkZWxldGUgZGF0YVN0b3JlW2RhdGFTdG9yZUtleV07CgkgICAgICAgICAgICAgICAgbm9kZVtkYXRhU3RvcmVLZXlFeHBhbmRvUHJvcGVydHlOYW1lXSA9IG51bGw7CgkgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7IC8vIEV4cG9zaW5nICJkaWQgY2xlYW4iIGZsYWcgcHVyZWx5IHNvIHNwZWNzIGNhbiBpbmZlciB3aGV0aGVyIHRoaW5ncyBoYXZlIGJlZW4gY2xlYW5lZCB1cCBhcyBpbnRlbmRlZAoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwoJICAgICAgICB9LAoKCSAgICAgICAgbmV4dEtleTogZnVuY3Rpb24gKCkgewoJICAgICAgICAgICAgcmV0dXJuICh1bmlxdWVJZCsrKSArIGRhdGFTdG9yZUtleUV4cGFuZG9Qcm9wZXJ0eU5hbWU7CgkgICAgICAgIH0KCSAgICB9OwoJfSkoKTsKCglrby5leHBvcnRTeW1ib2woJ3V0aWxzLmRvbURhdGEnLCBrby51dGlscy5kb21EYXRhKTsKCWtvLmV4cG9ydFN5bWJvbCgndXRpbHMuZG9tRGF0YS5jbGVhcicsIGtvLnV0aWxzLmRvbURhdGEuY2xlYXIpOyAvLyBFeHBvcnRpbmcgb25seSBzbyBzcGVjcyBjYW4gY2xlYXIgdXAgYWZ0ZXIgdGhlbXNlbHZlcyBmdWxseQoKCWtvLnV0aWxzLmRvbU5vZGVEaXNwb3NhbCA9IG5ldyAoZnVuY3Rpb24gKCkgewoJICAgIHZhciBkb21EYXRhS2V5ID0ga28udXRpbHMuZG9tRGF0YS5uZXh0S2V5KCk7CgkgICAgdmFyIGNsZWFuYWJsZU5vZGVUeXBlcyA9IHsgMTogdHJ1ZSwgODogdHJ1ZSwgOTogdHJ1ZSB9OyAgICAgICAvLyBFbGVtZW50LCBDb21tZW50LCBEb2N1bWVudAoJICAgIHZhciBjbGVhbmFibGVOb2RlVHlwZXNXaXRoRGVzY2VuZGFudHMgPSB7IDE6IHRydWUsIDk6IHRydWUgfTsgLy8gRWxlbWVudCwgRG9jdW1lbnQKCgkgICAgZnVuY3Rpb24gZ2V0RGlzcG9zZUNhbGxiYWNrc0NvbGxlY3Rpb24obm9kZSwgY3JlYXRlSWZOb3RGb3VuZCkgewoJICAgICAgICB2YXIgYWxsRGlzcG9zZUNhbGxiYWNrcyA9IGtvLnV0aWxzLmRvbURhdGEuZ2V0KG5vZGUsIGRvbURhdGFLZXkpOwoJICAgICAgICBpZiAoKGFsbERpc3Bvc2VDYWxsYmFja3MgPT09IHVuZGVmaW5lZCkgJiYgY3JlYXRlSWZOb3RGb3VuZCkgewoJICAgICAgICAgICAgYWxsRGlzcG9zZUNhbGxiYWNrcyA9IFtdOwoJICAgICAgICAgICAga28udXRpbHMuZG9tRGF0YS5zZXQobm9kZSwgZG9tRGF0YUtleSwgYWxsRGlzcG9zZUNhbGxiYWNrcyk7CgkgICAgICAgIH0KCSAgICAgICAgcmV0dXJuIGFsbERpc3Bvc2VDYWxsYmFja3M7CgkgICAgfQoJICAgIGZ1bmN0aW9uIGRlc3Ryb3lDYWxsYmFja3NDb2xsZWN0aW9uKG5vZGUpIHsKCSAgICAgICAga28udXRpbHMuZG9tRGF0YS5zZXQobm9kZSwgZG9tRGF0YUtleSwgdW5kZWZpbmVkKTsKCSAgICB9CgoJICAgIGZ1bmN0aW9uIGNsZWFuU2luZ2xlTm9kZShub2RlKSB7CgkgICAgICAgIC8vIFJ1biBhbGwgdGhlIGRpc3Bvc2UgY2FsbGJhY2tzCgkgICAgICAgIHZhciBjYWxsYmFja3MgPSBnZXREaXNwb3NlQ2FsbGJhY2tzQ29sbGVjdGlvbihub2RlLCBmYWxzZSk7CgkgICAgICAgIGlmIChjYWxsYmFja3MpIHsKCSAgICAgICAgICAgIGNhbGxiYWNrcyA9IGNhbGxiYWNrcy5zbGljZSgwKTsgLy8gQ2xvbmUsIGFzIHRoZSBhcnJheSBtYXkgYmUgbW9kaWZpZWQgZHVyaW5nIGl0ZXJhdGlvbiAodHlwaWNhbGx5LCBjYWxsYmFja3Mgd2lsbCByZW1vdmUgdGhlbXNlbHZlcykKCSAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgY2FsbGJhY2tzLmxlbmd0aDsgaSsrKQoJICAgICAgICAgICAgICAgIGNhbGxiYWNrc1tpXShub2RlKTsKCSAgICAgICAgfQoKCSAgICAgICAgLy8gRXJhc2UgdGhlIERPTSBkYXRhCgkgICAgICAgIGtvLnV0aWxzLmRvbURhdGEuY2xlYXIobm9kZSk7CgoJICAgICAgICAvLyBQZXJmb3JtIGNsZWFudXAgbmVlZGVkIGJ5IGV4dGVybmFsIGxpYnJhcmllcyAoY3VycmVudGx5IG9ubHkgalF1ZXJ5LCBidXQgY2FuIGJlIGV4dGVuZGVkKQoJICAgICAgICBrby51dGlscy5kb21Ob2RlRGlzcG9zYWxbImNsZWFuRXh0ZXJuYWxEYXRhIl0obm9kZSk7CgoJICAgICAgICAvLyBDbGVhciBhbnkgaW1tZWRpYXRlLWNoaWxkIGNvbW1lbnQgbm9kZXMsIGFzIHRoZXNlIHdvdWxkbid0IGhhdmUgYmVlbiBmb3VuZCBieQoJICAgICAgICAvLyBub2RlLmdldEVsZW1lbnRzQnlUYWdOYW1lKCIqIikgaW4gY2xlYW5Ob2RlKCkgKGNvbW1lbnQgbm9kZXMgYXJlbid0IGVsZW1lbnRzKQoJICAgICAgICBpZiAoY2xlYW5hYmxlTm9kZVR5cGVzV2l0aERlc2NlbmRhbnRzW25vZGUubm9kZVR5cGVdKQoJICAgICAgICAgICAgY2xlYW5JbW1lZGlhdGVDb21tZW50VHlwZUNoaWxkcmVuKG5vZGUpOwoJICAgIH0KCgkgICAgZnVuY3Rpb24gY2xlYW5JbW1lZGlhdGVDb21tZW50VHlwZUNoaWxkcmVuKG5vZGVXaXRoQ2hpbGRyZW4pIHsKCSAgICAgICAgdmFyIGNoaWxkLCBuZXh0Q2hpbGQgPSBub2RlV2l0aENoaWxkcmVuLmZpcnN0Q2hpbGQ7CgkgICAgICAgIHdoaWxlIChjaGlsZCA9IG5leHRDaGlsZCkgewoJICAgICAgICAgICAgbmV4dENoaWxkID0gY2hpbGQubmV4dFNpYmxpbmc7CgkgICAgICAgICAgICBpZiAoY2hpbGQubm9kZVR5cGUgPT09IDgpCgkgICAgICAgICAgICAgICAgY2xlYW5TaW5nbGVOb2RlKGNoaWxkKTsKCSAgICAgICAgfQoJICAgIH0KCgkgICAgcmV0dXJuIHsKCSAgICAgICAgYWRkRGlzcG9zZUNhbGxiYWNrIDogZnVuY3Rpb24obm9kZSwgY2FsbGJhY2spIHsKCSAgICAgICAgICAgIGlmICh0eXBlb2YgY2FsbGJhY2sgIT0gImZ1bmN0aW9uIikKCSAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkNhbGxiYWNrIG11c3QgYmUgYSBmdW5jdGlvbiIpOwoJICAgICAgICAgICAgZ2V0RGlzcG9zZUNhbGxiYWNrc0NvbGxlY3Rpb24obm9kZSwgdHJ1ZSkucHVzaChjYWxsYmFjayk7CgkgICAgICAgIH0sCgoJICAgICAgICByZW1vdmVEaXNwb3NlQ2FsbGJhY2sgOiBmdW5jdGlvbihub2RlLCBjYWxsYmFjaykgewoJICAgICAgICAgICAgdmFyIGNhbGxiYWNrc0NvbGxlY3Rpb24gPSBnZXREaXNwb3NlQ2FsbGJhY2tzQ29sbGVjdGlvbihub2RlLCBmYWxzZSk7CgkgICAgICAgICAgICBpZiAoY2FsbGJhY2tzQ29sbGVjdGlvbikgewoJICAgICAgICAgICAgICAgIGtvLnV0aWxzLmFycmF5UmVtb3ZlSXRlbShjYWxsYmFja3NDb2xsZWN0aW9uLCBjYWxsYmFjayk7CgkgICAgICAgICAgICAgICAgaWYgKGNhbGxiYWNrc0NvbGxlY3Rpb24ubGVuZ3RoID09IDApCgkgICAgICAgICAgICAgICAgICAgIGRlc3Ryb3lDYWxsYmFja3NDb2xsZWN0aW9uKG5vZGUpOwoJICAgICAgICAgICAgfQoJICAgICAgICB9LAoKCSAgICAgICAgY2xlYW5Ob2RlIDogZnVuY3Rpb24obm9kZSkgewoJICAgICAgICAgICAgLy8gRmlyc3QgY2xlYW4gdGhpcyBub2RlLCB3aGVyZSBhcHBsaWNhYmxlCgkgICAgICAgICAgICBpZiAoY2xlYW5hYmxlTm9kZVR5cGVzW25vZGUubm9kZVR5cGVdKSB7CgkgICAgICAgICAgICAgICAgY2xlYW5TaW5nbGVOb2RlKG5vZGUpOwoKCSAgICAgICAgICAgICAgICAvLyAuLi4gdGhlbiBpdHMgZGVzY2VuZGFudHMsIHdoZXJlIGFwcGxpY2FibGUKCSAgICAgICAgICAgICAgICBpZiAoY2xlYW5hYmxlTm9kZVR5cGVzV2l0aERlc2NlbmRhbnRzW25vZGUubm9kZVR5cGVdKSB7CgkgICAgICAgICAgICAgICAgICAgIC8vIENsb25lIHRoZSBkZXNjZW5kYW50cyBsaXN0IGluIGNhc2UgaXQgY2hhbmdlcyBkdXJpbmcgaXRlcmF0aW9uCgkgICAgICAgICAgICAgICAgICAgIHZhciBkZXNjZW5kYW50cyA9IFtdOwoJICAgICAgICAgICAgICAgICAgICBrby51dGlscy5hcnJheVB1c2hBbGwoZGVzY2VuZGFudHMsIG5vZGUuZ2V0RWxlbWVudHNCeVRhZ05hbWUoIioiKSk7CgkgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBqID0gZGVzY2VuZGFudHMubGVuZ3RoOyBpIDwgajsgaSsrKQoJICAgICAgICAgICAgICAgICAgICAgICAgY2xlYW5TaW5nbGVOb2RlKGRlc2NlbmRhbnRzW2ldKTsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICByZXR1cm4gbm9kZTsKCSAgICAgICAgfSwKCgkgICAgICAgIHJlbW92ZU5vZGUgOiBmdW5jdGlvbihub2RlKSB7CgkgICAgICAgICAgICBrby5jbGVhbk5vZGUobm9kZSk7CgkgICAgICAgICAgICBpZiAobm9kZS5wYXJlbnROb2RlKQoJICAgICAgICAgICAgICAgIG5vZGUucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChub2RlKTsKCSAgICAgICAgfSwKCgkgICAgICAgICJjbGVhbkV4dGVybmFsRGF0YSIgOiBmdW5jdGlvbiAobm9kZSkgewoJICAgICAgICAgICAgLy8gU3BlY2lhbCBzdXBwb3J0IGZvciBqUXVlcnkgaGVyZSBiZWNhdXNlIGl0J3Mgc28gY29tbW9ubHkgdXNlZC4KCSAgICAgICAgICAgIC8vIE1hbnkgalF1ZXJ5IHBsdWdpbnMgKGluY2x1ZGluZyBqcXVlcnkudG1wbCkgc3RvcmUgZGF0YSB1c2luZyBqUXVlcnkncyBlcXVpdmFsZW50IG9mIGRvbURhdGEKCSAgICAgICAgICAgIC8vIHNvIG5vdGlmeSBpdCB0byB0ZWFyIGRvd24gYW55IHJlc291cmNlcyBhc3NvY2lhdGVkIHdpdGggdGhlIG5vZGUgJiBkZXNjZW5kYW50cyBoZXJlLgoJICAgICAgICAgICAgaWYgKGpRdWVyeUluc3RhbmNlICYmICh0eXBlb2YgalF1ZXJ5SW5zdGFuY2VbJ2NsZWFuRGF0YSddID09ICJmdW5jdGlvbiIpKQoJICAgICAgICAgICAgICAgIGpRdWVyeUluc3RhbmNlWydjbGVhbkRhdGEnXShbbm9kZV0pOwoJICAgICAgICB9CgkgICAgfQoJfSkoKTsKCWtvLmNsZWFuTm9kZSA9IGtvLnV0aWxzLmRvbU5vZGVEaXNwb3NhbC5jbGVhbk5vZGU7IC8vIFNob3J0aGFuZCBuYW1lIGZvciBjb252ZW5pZW5jZQoJa28ucmVtb3ZlTm9kZSA9IGtvLnV0aWxzLmRvbU5vZGVEaXNwb3NhbC5yZW1vdmVOb2RlOyAvLyBTaG9ydGhhbmQgbmFtZSBmb3IgY29udmVuaWVuY2UKCWtvLmV4cG9ydFN5bWJvbCgnY2xlYW5Ob2RlJywga28uY2xlYW5Ob2RlKTsKCWtvLmV4cG9ydFN5bWJvbCgncmVtb3ZlTm9kZScsIGtvLnJlbW92ZU5vZGUpOwoJa28uZXhwb3J0U3ltYm9sKCd1dGlscy5kb21Ob2RlRGlzcG9zYWwnLCBrby51dGlscy5kb21Ob2RlRGlzcG9zYWwpOwoJa28uZXhwb3J0U3ltYm9sKCd1dGlscy5kb21Ob2RlRGlzcG9zYWwuYWRkRGlzcG9zZUNhbGxiYWNrJywga28udXRpbHMuZG9tTm9kZURpc3Bvc2FsLmFkZERpc3Bvc2VDYWxsYmFjayk7Cglrby5leHBvcnRTeW1ib2woJ3V0aWxzLmRvbU5vZGVEaXNwb3NhbC5yZW1vdmVEaXNwb3NlQ2FsbGJhY2snLCBrby51dGlscy5kb21Ob2RlRGlzcG9zYWwucmVtb3ZlRGlzcG9zZUNhbGxiYWNrKTsKCShmdW5jdGlvbiAoKSB7CgkgICAgdmFyIGxlYWRpbmdDb21tZW50UmVnZXggPSAvXihccyopPCEtLSguKj8pLS0+LzsKCgkgICAgZnVuY3Rpb24gc2ltcGxlSHRtbFBhcnNlKGh0bWwpIHsKCSAgICAgICAgLy8gQmFzZWQgb24galF1ZXJ5J3MgImNsZWFuIiBmdW5jdGlvbiwgYnV0IG9ubHkgYWNjb3VudGluZyBmb3IgdGFibGUtcmVsYXRlZCBlbGVtZW50cy4KCSAgICAgICAgLy8gSWYgeW91IGhhdmUgcmVmZXJlbmNlZCBqUXVlcnksIHRoaXMgd29uJ3QgYmUgdXNlZCBhbnl3YXkgLSBLTyB3aWxsIHVzZSBqUXVlcnkncyAiY2xlYW4iIGZ1bmN0aW9uIGRpcmVjdGx5CgoJICAgICAgICAvLyBOb3RlIHRoYXQgdGhlcmUncyBzdGlsbCBhbiBpc3N1ZSBpbiBJRSA8IDkgd2hlcmVieSBpdCB3aWxsIGRpc2NhcmQgY29tbWVudCBub2RlcyB0aGF0IGFyZSB0aGUgZmlyc3QgY2hpbGQgb2YKCSAgICAgICAgLy8gYSBkZXNjZW5kYW50IG5vZGUuIEZvciBleGFtcGxlOiAiPGRpdj48IS0tIG15Y29tbWVudCAtLT5hYmM8L2Rpdj4iIHdpbGwgZ2V0IHBhcnNlZCBhcyAiPGRpdj5hYmM8L2Rpdj4iCgkgICAgICAgIC8vIFRoaXMgd29uJ3QgYWZmZWN0IGFueW9uZSB3aG8gaGFzIHJlZmVyZW5jZWQgalF1ZXJ5LCBhbmQgdGhlcmUncyBhbHdheXMgdGhlIHdvcmthcm91bmQgb2YgaW5zZXJ0aW5nIGEgZHVtbXkgbm9kZQoJICAgICAgICAvLyAocG9zc2libHkgYSB0ZXh0IG5vZGUpIGluIGZyb250IG9mIHRoZSBjb21tZW50LiBTbywgS08gZG9lcyBub3QgYXR0ZW1wdCB0byB3b3JrYXJvdW5kIHRoaXMgSUUgaXNzdWUgYXV0b21hdGljYWxseSBhdCBwcmVzZW50LgoKCSAgICAgICAgLy8gVHJpbSB3aGl0ZXNwYWNlLCBvdGhlcndpc2UgaW5kZXhPZiB3b24ndCB3b3JrIGFzIGV4cGVjdGVkCgkgICAgICAgIHZhciB0YWdzID0ga28udXRpbHMuc3RyaW5nVHJpbShodG1sKS50b0xvd2VyQ2FzZSgpLCBkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKCgkgICAgICAgIC8vIEZpbmRzIHRoZSBmaXJzdCBtYXRjaCBmcm9tIHRoZSBsZWZ0IGNvbHVtbiwgYW5kIHJldHVybnMgdGhlIGNvcnJlc3BvbmRpbmcgIndyYXAiIGRhdGEgZnJvbSB0aGUgcmlnaHQgY29sdW1uCgkgICAgICAgIHZhciB3cmFwID0gdGFncy5tYXRjaCgvXjwodGhlYWR8dGJvZHl8dGZvb3QpLykgICAgICAgICAgICAgICYmIFsxLCAiPHRhYmxlPiIsICI8L3RhYmxlPiJdIHx8CgkgICAgICAgICAgICAgICAgICAgIXRhZ3MuaW5kZXhPZigiPHRyIikgICAgICAgICAgICAgICAgICAgICAgICAgICAgICYmIFsyLCAiPHRhYmxlPjx0Ym9keT4iLCAiPC90Ym9keT48L3RhYmxlPiJdIHx8CgkgICAgICAgICAgICAgICAgICAgKCF0YWdzLmluZGV4T2YoIjx0ZCIpIHx8ICF0YWdzLmluZGV4T2YoIjx0aCIpKSAgICYmIFszLCAiPHRhYmxlPjx0Ym9keT48dHI+IiwgIjwvdHI+PC90Ym9keT48L3RhYmxlPiJdIHx8CgkgICAgICAgICAgICAgICAgICAgLyogYW55dGhpbmcgZWxzZSAqLyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFswLCAiIiwgIiJdOwoKCSAgICAgICAgLy8gR28gdG8gaHRtbCBhbmQgYmFjaywgdGhlbiBwZWVsIG9mZiBleHRyYSB3cmFwcGVycwoJICAgICAgICAvLyBOb3RlIHRoYXQgd2UgYWx3YXlzIHByZWZpeCB3aXRoIHNvbWUgZHVtbXkgdGV4dCwgYmVjYXVzZSBvdGhlcndpc2UsIElFPDkgd2lsbCBzdHJpcCBvdXQgbGVhZGluZyBjb21tZW50IG5vZGVzIGluIGRlc2NlbmRhbnRzLiBUb3RhbCBtYWRuZXNzLgoJICAgICAgICB2YXIgbWFya3VwID0gImlnbm9yZWQ8ZGl2PiIgKyB3cmFwWzFdICsgaHRtbCArIHdyYXBbMl0gKyAiPC9kaXY+IjsKCSAgICAgICAgaWYgKHR5cGVvZiB3aW5kb3dbJ2lubmVyU2hpdiddID09ICJmdW5jdGlvbiIpIHsKCSAgICAgICAgICAgIGRpdi5hcHBlbmRDaGlsZCh3aW5kb3dbJ2lubmVyU2hpdiddKG1hcmt1cCkpOwoJICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgZGl2LmlubmVySFRNTCA9IG1hcmt1cDsKCSAgICAgICAgfQoKCSAgICAgICAgLy8gTW92ZSB0byB0aGUgcmlnaHQgZGVwdGgKCSAgICAgICAgd2hpbGUgKHdyYXBbMF0tLSkKCSAgICAgICAgICAgIGRpdiA9IGRpdi5sYXN0Q2hpbGQ7CgoJICAgICAgICByZXR1cm4ga28udXRpbHMubWFrZUFycmF5KGRpdi5sYXN0Q2hpbGQuY2hpbGROb2Rlcyk7CgkgICAgfQoKCSAgICBmdW5jdGlvbiBqUXVlcnlIdG1sUGFyc2UoaHRtbCkgewoJICAgICAgICAvLyBqUXVlcnkncyAicGFyc2VIVE1MIiBmdW5jdGlvbiB3YXMgaW50cm9kdWNlZCBpbiBqUXVlcnkgMS44LjAgYW5kIGlzIGEgZG9jdW1lbnRlZCBwdWJsaWMgQVBJLgoJICAgICAgICBpZiAoalF1ZXJ5SW5zdGFuY2VbJ3BhcnNlSFRNTCddKSB7CgkgICAgICAgICAgICByZXR1cm4galF1ZXJ5SW5zdGFuY2VbJ3BhcnNlSFRNTCddKGh0bWwpIHx8IFtdOyAvLyBFbnN1cmUgd2UgYWx3YXlzIHJldHVybiBhbiBhcnJheSBhbmQgbmV2ZXIgbnVsbAoJICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgLy8gRm9yIGpRdWVyeSA8IDEuOC4wLCB3ZSBmYWxsIGJhY2sgb24gdGhlIHVuZG9jdW1lbnRlZCBpbnRlcm5hbCAiY2xlYW4iIGZ1bmN0aW9uLgoJICAgICAgICAgICAgdmFyIGVsZW1zID0galF1ZXJ5SW5zdGFuY2VbJ2NsZWFuJ10oW2h0bWxdKTsKCgkgICAgICAgICAgICAvLyBBcyBvZiBqUXVlcnkgMS43LjEsIGpRdWVyeSBwYXJzZXMgdGhlIEhUTUwgYnkgYXBwZW5kaW5nIGl0IHRvIHNvbWUgZHVtbXkgcGFyZW50IG5vZGVzIGhlbGQgaW4gYW4gaW4tbWVtb3J5IGRvY3VtZW50IGZyYWdtZW50LgoJICAgICAgICAgICAgLy8gVW5mb3J0dW5hdGVseSwgaXQgbmV2ZXIgY2xlYXJzIHRoZSBkdW1teSBwYXJlbnQgbm9kZXMgZnJvbSB0aGUgZG9jdW1lbnQgZnJhZ21lbnQsIHNvIGl0IGxlYWtzIG1lbW9yeSBvdmVyIHRpbWUuCgkgICAgICAgICAgICAvLyBGaXggdGhpcyBieSBmaW5kaW5nIHRoZSB0b3AtbW9zdCBkdW1teSBwYXJlbnQgZWxlbWVudCwgYW5kIGRldGFjaGluZyBpdCBmcm9tIGl0cyBvd25lciBmcmFnbWVudC4KCSAgICAgICAgICAgIGlmIChlbGVtcyAmJiBlbGVtc1swXSkgewoJICAgICAgICAgICAgICAgIC8vIEZpbmQgdGhlIHRvcC1tb3N0IHBhcmVudCBlbGVtZW50IHRoYXQncyBhIGRpcmVjdCBjaGlsZCBvZiBhIGRvY3VtZW50IGZyYWdtZW50CgkgICAgICAgICAgICAgICAgdmFyIGVsZW0gPSBlbGVtc1swXTsKCSAgICAgICAgICAgICAgICB3aGlsZSAoZWxlbS5wYXJlbnROb2RlICYmIGVsZW0ucGFyZW50Tm9kZS5ub2RlVHlwZSAhPT0gMTEgLyogaS5lLiwgRG9jdW1lbnRGcmFnbWVudCAqLykKCSAgICAgICAgICAgICAgICAgICAgZWxlbSA9IGVsZW0ucGFyZW50Tm9kZTsKCSAgICAgICAgICAgICAgICAvLyAuLi4gdGhlbiBkZXRhY2ggaXQKCSAgICAgICAgICAgICAgICBpZiAoZWxlbS5wYXJlbnROb2RlKQoJICAgICAgICAgICAgICAgICAgICBlbGVtLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoZWxlbSk7CgkgICAgICAgICAgICB9CgoJICAgICAgICAgICAgcmV0dXJuIGVsZW1zOwoJICAgICAgICB9CgkgICAgfQoKCSAgICBrby51dGlscy5wYXJzZUh0bWxGcmFnbWVudCA9IGZ1bmN0aW9uKGh0bWwpIHsKCSAgICAgICAgcmV0dXJuIGpRdWVyeUluc3RhbmNlID8galF1ZXJ5SHRtbFBhcnNlKGh0bWwpICAgLy8gQXMgYmVsb3csIGJlbmVmaXQgZnJvbSBqUXVlcnkncyBvcHRpbWlzYXRpb25zIHdoZXJlIHBvc3NpYmxlCgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA6IHNpbXBsZUh0bWxQYXJzZShodG1sKTsgIC8vIC4uLiBvdGhlcndpc2UsIHRoaXMgc2ltcGxlIGxvZ2ljIHdpbGwgZG8gaW4gbW9zdCBjb21tb24gY2FzZXMuCgkgICAgfTsKCgkgICAga28udXRpbHMuc2V0SHRtbCA9IGZ1bmN0aW9uKG5vZGUsIGh0bWwpIHsKCSAgICAgICAga28udXRpbHMuZW1wdHlEb21Ob2RlKG5vZGUpOwoKCSAgICAgICAgLy8gVGhlcmUncyBubyBsZWdpdGltYXRlIHJlYXNvbiB0byBkaXNwbGF5IGEgc3RyaW5naWZpZWQgb2JzZXJ2YWJsZSB3aXRob3V0IHVud3JhcHBpbmcgaXQsIHNvIHdlJ2xsIHVud3JhcCBpdAoJICAgICAgICBodG1sID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZShodG1sKTsKCgkgICAgICAgIGlmICgoaHRtbCAhPT0gbnVsbCkgJiYgKGh0bWwgIT09IHVuZGVmaW5lZCkpIHsKCSAgICAgICAgICAgIGlmICh0eXBlb2YgaHRtbCAhPSAnc3RyaW5nJykKCSAgICAgICAgICAgICAgICBodG1sID0gaHRtbC50b1N0cmluZygpOwoKCSAgICAgICAgICAgIC8vIGpRdWVyeSBjb250YWlucyBhIGxvdCBvZiBzb3BoaXN0aWNhdGVkIGNvZGUgdG8gcGFyc2UgYXJiaXRyYXJ5IEhUTUwgZnJhZ21lbnRzLAoJICAgICAgICAgICAgLy8gZm9yIGV4YW1wbGUgPHRyPiBlbGVtZW50cyB3aGljaCBhcmUgbm90IG5vcm1hbGx5IGFsbG93ZWQgdG8gZXhpc3Qgb24gdGhlaXIgb3duLgoJICAgICAgICAgICAgLy8gSWYgeW91J3ZlIHJlZmVyZW5jZWQgalF1ZXJ5IHdlJ2xsIHVzZSB0aGF0IHJhdGhlciB0aGFuIGR1cGxpY2F0aW5nIGl0cyBjb2RlLgoJICAgICAgICAgICAgaWYgKGpRdWVyeUluc3RhbmNlKSB7CgkgICAgICAgICAgICAgICAgalF1ZXJ5SW5zdGFuY2Uobm9kZSlbJ2h0bWwnXShodG1sKTsKCSAgICAgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICAgICAgLy8gLi4uIG90aGVyd2lzZSwgdXNlIEtPJ3Mgb3duIHBhcnNpbmcgbG9naWMuCgkgICAgICAgICAgICAgICAgdmFyIHBhcnNlZE5vZGVzID0ga28udXRpbHMucGFyc2VIdG1sRnJhZ21lbnQoaHRtbCk7CgkgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwYXJzZWROb2Rlcy5sZW5ndGg7IGkrKykKCSAgICAgICAgICAgICAgICAgICAgbm9kZS5hcHBlbmRDaGlsZChwYXJzZWROb2Rlc1tpXSk7CgkgICAgICAgICAgICB9CgkgICAgICAgIH0KCSAgICB9OwoJfSkoKTsKCglrby5leHBvcnRTeW1ib2woJ3V0aWxzLnBhcnNlSHRtbEZyYWdtZW50Jywga28udXRpbHMucGFyc2VIdG1sRnJhZ21lbnQpOwoJa28uZXhwb3J0U3ltYm9sKCd1dGlscy5zZXRIdG1sJywga28udXRpbHMuc2V0SHRtbCk7CgoJa28ubWVtb2l6YXRpb24gPSAoZnVuY3Rpb24gKCkgewoJICAgIHZhciBtZW1vcyA9IHt9OwoKCSAgICBmdW5jdGlvbiByYW5kb21NYXg4SGV4Q2hhcnMoKSB7CgkgICAgICAgIHJldHVybiAoKCgxICsgTWF0aC5yYW5kb20oKSkgKiAweDEwMDAwMDAwMCkgfCAwKS50b1N0cmluZygxNikuc3Vic3RyaW5nKDEpOwoJICAgIH0KCSAgICBmdW5jdGlvbiBnZW5lcmF0ZVJhbmRvbUlkKCkgewoJICAgICAgICByZXR1cm4gcmFuZG9tTWF4OEhleENoYXJzKCkgKyByYW5kb21NYXg4SGV4Q2hhcnMoKTsKCSAgICB9CgkgICAgZnVuY3Rpb24gZmluZE1lbW9Ob2Rlcyhyb290Tm9kZSwgYXBwZW5kVG9BcnJheSkgewoJICAgICAgICBpZiAoIXJvb3ROb2RlKQoJICAgICAgICAgICAgcmV0dXJuOwoJICAgICAgICBpZiAocm9vdE5vZGUubm9kZVR5cGUgPT0gOCkgewoJICAgICAgICAgICAgdmFyIG1lbW9JZCA9IGtvLm1lbW9pemF0aW9uLnBhcnNlTWVtb1RleHQocm9vdE5vZGUubm9kZVZhbHVlKTsKCSAgICAgICAgICAgIGlmIChtZW1vSWQgIT0gbnVsbCkKCSAgICAgICAgICAgICAgICBhcHBlbmRUb0FycmF5LnB1c2goeyBkb21Ob2RlOiByb290Tm9kZSwgbWVtb0lkOiBtZW1vSWQgfSk7CgkgICAgICAgIH0gZWxzZSBpZiAocm9vdE5vZGUubm9kZVR5cGUgPT0gMSkgewoJICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGNoaWxkTm9kZXMgPSByb290Tm9kZS5jaGlsZE5vZGVzLCBqID0gY2hpbGROb2Rlcy5sZW5ndGg7IGkgPCBqOyBpKyspCgkgICAgICAgICAgICAgICAgZmluZE1lbW9Ob2RlcyhjaGlsZE5vZGVzW2ldLCBhcHBlbmRUb0FycmF5KTsKCSAgICAgICAgfQoJICAgIH0KCgkgICAgcmV0dXJuIHsKCSAgICAgICAgbWVtb2l6ZTogZnVuY3Rpb24gKGNhbGxiYWNrKSB7CgkgICAgICAgICAgICBpZiAodHlwZW9mIGNhbGxiYWNrICE9ICJmdW5jdGlvbiIpCgkgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJZb3UgY2FuIG9ubHkgcGFzcyBhIGZ1bmN0aW9uIHRvIGtvLm1lbW9pemF0aW9uLm1lbW9pemUoKSIpOwoJICAgICAgICAgICAgdmFyIG1lbW9JZCA9IGdlbmVyYXRlUmFuZG9tSWQoKTsKCSAgICAgICAgICAgIG1lbW9zW21lbW9JZF0gPSBjYWxsYmFjazsKCSAgICAgICAgICAgIHJldHVybiAiPCEtLVtrb19tZW1vOiIgKyBtZW1vSWQgKyAiXS0tPiI7CgkgICAgICAgIH0sCgoJICAgICAgICB1bm1lbW9pemU6IGZ1bmN0aW9uIChtZW1vSWQsIGNhbGxiYWNrUGFyYW1zKSB7CgkgICAgICAgICAgICB2YXIgY2FsbGJhY2sgPSBtZW1vc1ttZW1vSWRdOwoJICAgICAgICAgICAgaWYgKGNhbGxiYWNrID09PSB1bmRlZmluZWQpCgkgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJDb3VsZG4ndCBmaW5kIGFueSBtZW1vIHdpdGggSUQgIiArIG1lbW9JZCArICIuIFBlcmhhcHMgaXQncyBhbHJlYWR5IGJlZW4gdW5tZW1vaXplZC4iKTsKCSAgICAgICAgICAgIHRyeSB7CgkgICAgICAgICAgICAgICAgY2FsbGJhY2suYXBwbHkobnVsbCwgY2FsbGJhY2tQYXJhbXMgfHwgW10pOwoJICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgZmluYWxseSB7IGRlbGV0ZSBtZW1vc1ttZW1vSWRdOyB9CgkgICAgICAgIH0sCgoJICAgICAgICB1bm1lbW9pemVEb21Ob2RlQW5kRGVzY2VuZGFudHM6IGZ1bmN0aW9uIChkb21Ob2RlLCBleHRyYUNhbGxiYWNrUGFyYW1zQXJyYXkpIHsKCSAgICAgICAgICAgIHZhciBtZW1vcyA9IFtdOwoJICAgICAgICAgICAgZmluZE1lbW9Ob2Rlcyhkb21Ob2RlLCBtZW1vcyk7CgkgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaiA9IG1lbW9zLmxlbmd0aDsgaSA8IGo7IGkrKykgewoJICAgICAgICAgICAgICAgIHZhciBub2RlID0gbWVtb3NbaV0uZG9tTm9kZTsKCSAgICAgICAgICAgICAgICB2YXIgY29tYmluZWRQYXJhbXMgPSBbbm9kZV07CgkgICAgICAgICAgICAgICAgaWYgKGV4dHJhQ2FsbGJhY2tQYXJhbXNBcnJheSkKCSAgICAgICAgICAgICAgICAgICAga28udXRpbHMuYXJyYXlQdXNoQWxsKGNvbWJpbmVkUGFyYW1zLCBleHRyYUNhbGxiYWNrUGFyYW1zQXJyYXkpOwoJICAgICAgICAgICAgICAgIGtvLm1lbW9pemF0aW9uLnVubWVtb2l6ZShtZW1vc1tpXS5tZW1vSWQsIGNvbWJpbmVkUGFyYW1zKTsKCSAgICAgICAgICAgICAgICBub2RlLm5vZGVWYWx1ZSA9ICIiOyAvLyBOZXV0ZXIgdGhpcyBub2RlIHNvIHdlIGRvbid0IHRyeSB0byB1bm1lbW9pemUgaXQgYWdhaW4KCSAgICAgICAgICAgICAgICBpZiAobm9kZS5wYXJlbnROb2RlKQoJICAgICAgICAgICAgICAgICAgICBub2RlLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQobm9kZSk7IC8vIElmIHBvc3NpYmxlLCBlcmFzZSBpdCB0b3RhbGx5IChub3QgYWx3YXlzIHBvc3NpYmxlIC0gc29tZW9uZSBlbHNlIG1pZ2h0IGp1c3QgaG9sZCBhIHJlZmVyZW5jZSB0byBpdCB0aGVuIGNhbGwgdW5tZW1vaXplRG9tTm9kZUFuZERlc2NlbmRhbnRzIGFnYWluKQoJICAgICAgICAgICAgfQoJICAgICAgICB9LAoKCSAgICAgICAgcGFyc2VNZW1vVGV4dDogZnVuY3Rpb24gKG1lbW9UZXh0KSB7CgkgICAgICAgICAgICB2YXIgbWF0Y2ggPSBtZW1vVGV4dC5tYXRjaCgvXlxba29fbWVtb1w6KC4qPylcXSQvKTsKCSAgICAgICAgICAgIHJldHVybiBtYXRjaCA/IG1hdGNoWzFdIDogbnVsbDsKCSAgICAgICAgfQoJICAgIH07Cgl9KSgpOwoKCWtvLmV4cG9ydFN5bWJvbCgnbWVtb2l6YXRpb24nLCBrby5tZW1vaXphdGlvbik7Cglrby5leHBvcnRTeW1ib2woJ21lbW9pemF0aW9uLm1lbW9pemUnLCBrby5tZW1vaXphdGlvbi5tZW1vaXplKTsKCWtvLmV4cG9ydFN5bWJvbCgnbWVtb2l6YXRpb24udW5tZW1vaXplJywga28ubWVtb2l6YXRpb24udW5tZW1vaXplKTsKCWtvLmV4cG9ydFN5bWJvbCgnbWVtb2l6YXRpb24ucGFyc2VNZW1vVGV4dCcsIGtvLm1lbW9pemF0aW9uLnBhcnNlTWVtb1RleHQpOwoJa28uZXhwb3J0U3ltYm9sKCdtZW1vaXphdGlvbi51bm1lbW9pemVEb21Ob2RlQW5kRGVzY2VuZGFudHMnLCBrby5tZW1vaXphdGlvbi51bm1lbW9pemVEb21Ob2RlQW5kRGVzY2VuZGFudHMpOwoJa28uZXh0ZW5kZXJzID0gewoJICAgICd0aHJvdHRsZSc6IGZ1bmN0aW9uKHRhcmdldCwgdGltZW91dCkgewoJICAgICAgICAvLyBUaHJvdHRsaW5nIG1lYW5zIHR3byB0aGluZ3M6CgoJICAgICAgICAvLyAoMSkgRm9yIGRlcGVuZGVudCBvYnNlcnZhYmxlcywgd2UgdGhyb3R0bGUgKmV2YWx1YXRpb25zKiBzbyB0aGF0LCBubyBtYXR0ZXIgaG93IGZhc3QgaXRzIGRlcGVuZGVuY2llcwoJICAgICAgICAvLyAgICAgbm90aWZ5IHVwZGF0ZXMsIHRoZSB0YXJnZXQgZG9lc24ndCByZS1ldmFsdWF0ZSAoYW5kIGhlbmNlIGRvZXNuJ3Qgbm90aWZ5KSBmYXN0ZXIgdGhhbiBhIGNlcnRhaW4gcmF0ZQoJICAgICAgICB0YXJnZXRbJ3Rocm90dGxlRXZhbHVhdGlvbiddID0gdGltZW91dDsKCgkgICAgICAgIC8vICgyKSBGb3Igd3JpdGFibGUgdGFyZ2V0cyAob2JzZXJ2YWJsZXMsIG9yIHdyaXRhYmxlIGRlcGVuZGVudCBvYnNlcnZhYmxlcyksIHdlIHRocm90dGxlICp3cml0ZXMqCgkgICAgICAgIC8vICAgICBzbyB0aGUgdGFyZ2V0IGNhbm5vdCBjaGFuZ2UgdmFsdWUgc3luY2hyb25vdXNseSBvciBmYXN0ZXIgdGhhbiBhIGNlcnRhaW4gcmF0ZQoJICAgICAgICB2YXIgd3JpdGVUaW1lb3V0SW5zdGFuY2UgPSBudWxsOwoJICAgICAgICByZXR1cm4ga28uZGVwZW5kZW50T2JzZXJ2YWJsZSh7CgkgICAgICAgICAgICAncmVhZCc6IHRhcmdldCwKCSAgICAgICAgICAgICd3cml0ZSc6IGZ1bmN0aW9uKHZhbHVlKSB7CgkgICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHdyaXRlVGltZW91dEluc3RhbmNlKTsKCSAgICAgICAgICAgICAgICB3cml0ZVRpbWVvdXRJbnN0YW5jZSA9IHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CgkgICAgICAgICAgICAgICAgICAgIHRhcmdldCh2YWx1ZSk7CgkgICAgICAgICAgICAgICAgfSwgdGltZW91dCk7CgkgICAgICAgICAgICB9CgkgICAgICAgIH0pOwoJICAgIH0sCgoJICAgICdyYXRlTGltaXQnOiBmdW5jdGlvbih0YXJnZXQsIG9wdGlvbnMpIHsKCSAgICAgICAgdmFyIHRpbWVvdXQsIG1ldGhvZCwgbGltaXRGdW5jdGlvbjsKCgkgICAgICAgIGlmICh0eXBlb2Ygb3B0aW9ucyA9PSAnbnVtYmVyJykgewoJICAgICAgICAgICAgdGltZW91dCA9IG9wdGlvbnM7CgkgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICB0aW1lb3V0ID0gb3B0aW9uc1sndGltZW91dCddOwoJICAgICAgICAgICAgbWV0aG9kID0gb3B0aW9uc1snbWV0aG9kJ107CgkgICAgICAgIH0KCgkgICAgICAgIGxpbWl0RnVuY3Rpb24gPSBtZXRob2QgPT0gJ25vdGlmeVdoZW5DaGFuZ2VzU3RvcCcgPyAgZGVib3VuY2UgOiB0aHJvdHRsZTsKCSAgICAgICAgdGFyZ2V0LmxpbWl0KGZ1bmN0aW9uKGNhbGxiYWNrKSB7CgkgICAgICAgICAgICByZXR1cm4gbGltaXRGdW5jdGlvbihjYWxsYmFjaywgdGltZW91dCk7CgkgICAgICAgIH0pOwoJICAgIH0sCgoJICAgICdub3RpZnknOiBmdW5jdGlvbih0YXJnZXQsIG5vdGlmeVdoZW4pIHsKCSAgICAgICAgdGFyZ2V0WyJlcXVhbGl0eUNvbXBhcmVyIl0gPSBub3RpZnlXaGVuID09ICJhbHdheXMiID8KCSAgICAgICAgICAgIG51bGwgOiAgLy8gbnVsbCBlcXVhbGl0eUNvbXBhcmVyIG1lYW5zIHRvIGFsd2F5cyBub3RpZnkKCSAgICAgICAgICAgIHZhbHVlc0FyZVByaW1pdGl2ZUFuZEVxdWFsOwoJICAgIH0KCX07CgoJdmFyIHByaW1pdGl2ZVR5cGVzID0geyAndW5kZWZpbmVkJzoxLCAnYm9vbGVhbic6MSwgJ251bWJlcic6MSwgJ3N0cmluZyc6MSB9OwoJZnVuY3Rpb24gdmFsdWVzQXJlUHJpbWl0aXZlQW5kRXF1YWwoYSwgYikgewoJICAgIHZhciBvbGRWYWx1ZUlzUHJpbWl0aXZlID0gKGEgPT09IG51bGwpIHx8ICh0eXBlb2YoYSkgaW4gcHJpbWl0aXZlVHlwZXMpOwoJICAgIHJldHVybiBvbGRWYWx1ZUlzUHJpbWl0aXZlID8gKGEgPT09IGIpIDogZmFsc2U7Cgl9CgoJZnVuY3Rpb24gdGhyb3R0bGUoY2FsbGJhY2ssIHRpbWVvdXQpIHsKCSAgICB2YXIgdGltZW91dEluc3RhbmNlOwoJICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CgkgICAgICAgIGlmICghdGltZW91dEluc3RhbmNlKSB7CgkgICAgICAgICAgICB0aW1lb3V0SW5zdGFuY2UgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoJICAgICAgICAgICAgICAgIHRpbWVvdXRJbnN0YW5jZSA9IHVuZGVmaW5lZDsKCSAgICAgICAgICAgICAgICBjYWxsYmFjaygpOwoJICAgICAgICAgICAgfSwgdGltZW91dCk7CgkgICAgICAgIH0KCSAgICB9OwoJfQoKCWZ1bmN0aW9uIGRlYm91bmNlKGNhbGxiYWNrLCB0aW1lb3V0KSB7CgkgICAgdmFyIHRpbWVvdXRJbnN0YW5jZTsKCSAgICByZXR1cm4gZnVuY3Rpb24gKCkgewoJICAgICAgICBjbGVhclRpbWVvdXQodGltZW91dEluc3RhbmNlKTsKCSAgICAgICAgdGltZW91dEluc3RhbmNlID0gc2V0VGltZW91dChjYWxsYmFjaywgdGltZW91dCk7CgkgICAgfTsKCX0KCglmdW5jdGlvbiBhcHBseUV4dGVuZGVycyhyZXF1ZXN0ZWRFeHRlbmRlcnMpIHsKCSAgICB2YXIgdGFyZ2V0ID0gdGhpczsKCSAgICBpZiAocmVxdWVzdGVkRXh0ZW5kZXJzKSB7CgkgICAgICAgIGtvLnV0aWxzLm9iamVjdEZvckVhY2gocmVxdWVzdGVkRXh0ZW5kZXJzLCBmdW5jdGlvbihrZXksIHZhbHVlKSB7CgkgICAgICAgICAgICB2YXIgZXh0ZW5kZXJIYW5kbGVyID0ga28uZXh0ZW5kZXJzW2tleV07CgkgICAgICAgICAgICBpZiAodHlwZW9mIGV4dGVuZGVySGFuZGxlciA9PSAnZnVuY3Rpb24nKSB7CgkgICAgICAgICAgICAgICAgdGFyZ2V0ID0gZXh0ZW5kZXJIYW5kbGVyKHRhcmdldCwgdmFsdWUpIHx8IHRhcmdldDsKCSAgICAgICAgICAgIH0KCSAgICAgICAgfSk7CgkgICAgfQoJICAgIHJldHVybiB0YXJnZXQ7Cgl9CgoJa28uZXhwb3J0U3ltYm9sKCdleHRlbmRlcnMnLCBrby5leHRlbmRlcnMpOwoKCWtvLnN1YnNjcmlwdGlvbiA9IGZ1bmN0aW9uICh0YXJnZXQsIGNhbGxiYWNrLCBkaXNwb3NlQ2FsbGJhY2spIHsKCSAgICB0aGlzLnRhcmdldCA9IHRhcmdldDsKCSAgICB0aGlzLmNhbGxiYWNrID0gY2FsbGJhY2s7CgkgICAgdGhpcy5kaXNwb3NlQ2FsbGJhY2sgPSBkaXNwb3NlQ2FsbGJhY2s7CgkgICAgdGhpcy5pc0Rpc3Bvc2VkID0gZmFsc2U7CgkgICAga28uZXhwb3J0UHJvcGVydHkodGhpcywgJ2Rpc3Bvc2UnLCB0aGlzLmRpc3Bvc2UpOwoJfTsKCWtvLnN1YnNjcmlwdGlvbi5wcm90b3R5cGUuZGlzcG9zZSA9IGZ1bmN0aW9uICgpIHsKCSAgICB0aGlzLmlzRGlzcG9zZWQgPSB0cnVlOwoJICAgIHRoaXMuZGlzcG9zZUNhbGxiYWNrKCk7Cgl9OwoKCWtvLnN1YnNjcmliYWJsZSA9IGZ1bmN0aW9uICgpIHsKCSAgICBrby51dGlscy5zZXRQcm90b3R5cGVPZk9yRXh0ZW5kKHRoaXMsIGtvLnN1YnNjcmliYWJsZVsnZm4nXSk7CgkgICAgdGhpcy5fc3Vic2NyaXB0aW9ucyA9IHt9OwoJfQoKCXZhciBkZWZhdWx0RXZlbnQgPSAiY2hhbmdlIjsKCgl2YXIga29fc3Vic2NyaWJhYmxlX2ZuID0gewoJICAgIHN1YnNjcmliZTogZnVuY3Rpb24gKGNhbGxiYWNrLCBjYWxsYmFja1RhcmdldCwgZXZlbnQpIHsKCSAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwoKCSAgICAgICAgZXZlbnQgPSBldmVudCB8fCBkZWZhdWx0RXZlbnQ7CgkgICAgICAgIHZhciBib3VuZENhbGxiYWNrID0gY2FsbGJhY2tUYXJnZXQgPyBjYWxsYmFjay5iaW5kKGNhbGxiYWNrVGFyZ2V0KSA6IGNhbGxiYWNrOwoKCSAgICAgICAgdmFyIHN1YnNjcmlwdGlvbiA9IG5ldyBrby5zdWJzY3JpcHRpb24oc2VsZiwgYm91bmRDYWxsYmFjaywgZnVuY3Rpb24gKCkgewoJICAgICAgICAgICAga28udXRpbHMuYXJyYXlSZW1vdmVJdGVtKHNlbGYuX3N1YnNjcmlwdGlvbnNbZXZlbnRdLCBzdWJzY3JpcHRpb24pOwoJICAgICAgICAgICAgaWYgKHNlbGYuYWZ0ZXJTdWJzY3JpcHRpb25SZW1vdmUpCgkgICAgICAgICAgICAgICAgc2VsZi5hZnRlclN1YnNjcmlwdGlvblJlbW92ZShldmVudCk7CgkgICAgICAgIH0pOwoKCSAgICAgICAgaWYgKHNlbGYuYmVmb3JlU3Vic2NyaXB0aW9uQWRkKQoJICAgICAgICAgICAgc2VsZi5iZWZvcmVTdWJzY3JpcHRpb25BZGQoZXZlbnQpOwoKCSAgICAgICAgaWYgKCFzZWxmLl9zdWJzY3JpcHRpb25zW2V2ZW50XSkKCSAgICAgICAgICAgIHNlbGYuX3N1YnNjcmlwdGlvbnNbZXZlbnRdID0gW107CgkgICAgICAgIHNlbGYuX3N1YnNjcmlwdGlvbnNbZXZlbnRdLnB1c2goc3Vic2NyaXB0aW9uKTsKCgkgICAgICAgIHJldHVybiBzdWJzY3JpcHRpb247CgkgICAgfSwKCgkgICAgIm5vdGlmeVN1YnNjcmliZXJzIjogZnVuY3Rpb24gKHZhbHVlVG9Ob3RpZnksIGV2ZW50KSB7CgkgICAgICAgIGV2ZW50ID0gZXZlbnQgfHwgZGVmYXVsdEV2ZW50OwoJICAgICAgICBpZiAodGhpcy5oYXNTdWJzY3JpcHRpb25zRm9yRXZlbnQoZXZlbnQpKSB7CgkgICAgICAgICAgICB0cnkgewoJICAgICAgICAgICAgICAgIGtvLmRlcGVuZGVuY3lEZXRlY3Rpb24uYmVnaW4oKTsgLy8gQmVnaW4gc3VwcHJlc3NpbmcgZGVwZW5kZW5jeSBkZXRlY3Rpb24gKGJ5IHNldHRpbmcgdGhlIHRvcCBmcmFtZSB0byB1bmRlZmluZWQpCgkgICAgICAgICAgICAgICAgZm9yICh2YXIgYSA9IHRoaXMuX3N1YnNjcmlwdGlvbnNbZXZlbnRdLnNsaWNlKDApLCBpID0gMCwgc3Vic2NyaXB0aW9uOyBzdWJzY3JpcHRpb24gPSBhW2ldOyArK2kpIHsKCSAgICAgICAgICAgICAgICAgICAgLy8gSW4gY2FzZSBhIHN1YnNjcmlwdGlvbiB3YXMgZGlzcG9zZWQgZHVyaW5nIHRoZSBhcnJheUZvckVhY2ggY3ljbGUsIGNoZWNrCgkgICAgICAgICAgICAgICAgICAgIC8vIGZvciBpc0Rpc3Bvc2VkIG9uIGVhY2ggc3Vic2NyaXB0aW9uIGJlZm9yZSBpbnZva2luZyBpdHMgY2FsbGJhY2sKCSAgICAgICAgICAgICAgICAgICAgaWYgKCFzdWJzY3JpcHRpb24uaXNEaXNwb3NlZCkKCSAgICAgICAgICAgICAgICAgICAgICAgIHN1YnNjcmlwdGlvbi5jYWxsYmFjayh2YWx1ZVRvTm90aWZ5KTsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICB9IGZpbmFsbHkgewoJICAgICAgICAgICAgICAgIGtvLmRlcGVuZGVuY3lEZXRlY3Rpb24uZW5kKCk7IC8vIEVuZCBzdXBwcmVzc2luZyBkZXBlbmRlbmN5IGRldGVjdGlvbgoJICAgICAgICAgICAgfQoJICAgICAgICB9CgkgICAgfSwKCgkgICAgbGltaXQ6IGZ1bmN0aW9uKGxpbWl0RnVuY3Rpb24pIHsKCSAgICAgICAgdmFyIHNlbGYgPSB0aGlzLCBzZWxmSXNPYnNlcnZhYmxlID0ga28uaXNPYnNlcnZhYmxlKHNlbGYpLAoJICAgICAgICAgICAgaXNQZW5kaW5nLCBwcmV2aW91c1ZhbHVlLCBwZW5kaW5nVmFsdWUsIGJlZm9yZUNoYW5nZSA9ICdiZWZvcmVDaGFuZ2UnOwoKCSAgICAgICAgaWYgKCFzZWxmLl9vcmlnTm90aWZ5U3Vic2NyaWJlcnMpIHsKCSAgICAgICAgICAgIHNlbGYuX29yaWdOb3RpZnlTdWJzY3JpYmVycyA9IHNlbGZbIm5vdGlmeVN1YnNjcmliZXJzIl07CgkgICAgICAgICAgICBzZWxmWyJub3RpZnlTdWJzY3JpYmVycyJdID0gZnVuY3Rpb24odmFsdWUsIGV2ZW50KSB7CgkgICAgICAgICAgICAgICAgaWYgKCFldmVudCB8fCBldmVudCA9PT0gZGVmYXVsdEV2ZW50KSB7CgkgICAgICAgICAgICAgICAgICAgIHNlbGYuX3JhdGVMaW1pdGVkQ2hhbmdlKHZhbHVlKTsKCSAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGV2ZW50ID09PSBiZWZvcmVDaGFuZ2UpIHsKCSAgICAgICAgICAgICAgICAgICAgc2VsZi5fcmF0ZUxpbWl0ZWRCZWZvcmVDaGFuZ2UodmFsdWUpOwoJICAgICAgICAgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICAgICAgICAgIHNlbGYuX29yaWdOb3RpZnlTdWJzY3JpYmVycyh2YWx1ZSwgZXZlbnQpOwoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgIH07CgkgICAgICAgIH0KCgkgICAgICAgIHZhciBmaW5pc2ggPSBsaW1pdEZ1bmN0aW9uKGZ1bmN0aW9uKCkgewoJICAgICAgICAgICAgLy8gSWYgYW4gb2JzZXJ2YWJsZSBwcm92aWRlZCBhIHJlZmVyZW5jZSB0byBpdHNlbGYsIGFjY2VzcyBpdCB0byBnZXQgdGhlIGxhdGVzdCB2YWx1ZS4KCSAgICAgICAgICAgIC8vIFRoaXMgYWxsb3dzIGNvbXB1dGVkIG9ic2VydmFibGVzIHRvIGRlbGF5IGNhbGN1bGF0aW5nIHRoZWlyIHZhbHVlIHVudGlsIG5lZWRlZC4KCSAgICAgICAgICAgIGlmIChzZWxmSXNPYnNlcnZhYmxlICYmIHBlbmRpbmdWYWx1ZSA9PT0gc2VsZikgewoJICAgICAgICAgICAgICAgIHBlbmRpbmdWYWx1ZSA9IHNlbGYoKTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIGlzUGVuZGluZyA9IGZhbHNlOwoJICAgICAgICAgICAgaWYgKHNlbGYuaXNEaWZmZXJlbnQocHJldmlvdXNWYWx1ZSwgcGVuZGluZ1ZhbHVlKSkgewoJICAgICAgICAgICAgICAgIHNlbGYuX29yaWdOb3RpZnlTdWJzY3JpYmVycyhwcmV2aW91c1ZhbHVlID0gcGVuZGluZ1ZhbHVlKTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgfSk7CgoJICAgICAgICBzZWxmLl9yYXRlTGltaXRlZENoYW5nZSA9IGZ1bmN0aW9uKHZhbHVlKSB7CgkgICAgICAgICAgICBpc1BlbmRpbmcgPSB0cnVlOwoJICAgICAgICAgICAgcGVuZGluZ1ZhbHVlID0gdmFsdWU7CgkgICAgICAgICAgICBmaW5pc2goKTsKCSAgICAgICAgfTsKCSAgICAgICAgc2VsZi5fcmF0ZUxpbWl0ZWRCZWZvcmVDaGFuZ2UgPSBmdW5jdGlvbih2YWx1ZSkgewoJICAgICAgICAgICAgaWYgKCFpc1BlbmRpbmcpIHsKCSAgICAgICAgICAgICAgICBwcmV2aW91c1ZhbHVlID0gdmFsdWU7CgkgICAgICAgICAgICAgICAgc2VsZi5fb3JpZ05vdGlmeVN1YnNjcmliZXJzKHZhbHVlLCBiZWZvcmVDaGFuZ2UpOwoJICAgICAgICAgICAgfQoJICAgICAgICB9OwoJICAgIH0sCgoJICAgIGhhc1N1YnNjcmlwdGlvbnNGb3JFdmVudDogZnVuY3Rpb24oZXZlbnQpIHsKCSAgICAgICAgcmV0dXJuIHRoaXMuX3N1YnNjcmlwdGlvbnNbZXZlbnRdICYmIHRoaXMuX3N1YnNjcmlwdGlvbnNbZXZlbnRdLmxlbmd0aDsKCSAgICB9LAoKCSAgICBnZXRTdWJzY3JpcHRpb25zQ291bnQ6IGZ1bmN0aW9uICgpIHsKCSAgICAgICAgdmFyIHRvdGFsID0gMDsKCSAgICAgICAga28udXRpbHMub2JqZWN0Rm9yRWFjaCh0aGlzLl9zdWJzY3JpcHRpb25zLCBmdW5jdGlvbihldmVudE5hbWUsIHN1YnNjcmlwdGlvbnMpIHsKCSAgICAgICAgICAgIHRvdGFsICs9IHN1YnNjcmlwdGlvbnMubGVuZ3RoOwoJICAgICAgICB9KTsKCSAgICAgICAgcmV0dXJuIHRvdGFsOwoJICAgIH0sCgoJICAgIGlzRGlmZmVyZW50OiBmdW5jdGlvbihvbGRWYWx1ZSwgbmV3VmFsdWUpIHsKCSAgICAgICAgcmV0dXJuICF0aGlzWydlcXVhbGl0eUNvbXBhcmVyJ10gfHwgIXRoaXNbJ2VxdWFsaXR5Q29tcGFyZXInXShvbGRWYWx1ZSwgbmV3VmFsdWUpOwoJICAgIH0sCgoJICAgIGV4dGVuZDogYXBwbHlFeHRlbmRlcnMKCX07CgoJa28uZXhwb3J0UHJvcGVydHkoa29fc3Vic2NyaWJhYmxlX2ZuLCAnc3Vic2NyaWJlJywga29fc3Vic2NyaWJhYmxlX2ZuLnN1YnNjcmliZSk7Cglrby5leHBvcnRQcm9wZXJ0eShrb19zdWJzY3JpYmFibGVfZm4sICdleHRlbmQnLCBrb19zdWJzY3JpYmFibGVfZm4uZXh0ZW5kKTsKCWtvLmV4cG9ydFByb3BlcnR5KGtvX3N1YnNjcmliYWJsZV9mbiwgJ2dldFN1YnNjcmlwdGlvbnNDb3VudCcsIGtvX3N1YnNjcmliYWJsZV9mbi5nZXRTdWJzY3JpcHRpb25zQ291bnQpOwoKCS8vIEZvciBicm93c2VycyB0aGF0IHN1cHBvcnQgcHJvdG8gYXNzaWdubWVudCwgd2Ugb3ZlcndyaXRlIHRoZSBwcm90b3R5cGUgb2YgZWFjaAoJLy8gb2JzZXJ2YWJsZSBpbnN0YW5jZS4gU2luY2Ugb2JzZXJ2YWJsZXMgYXJlIGZ1bmN0aW9ucywgd2UgbmVlZCBGdW5jdGlvbi5wcm90b3R5cGUKCS8vIHRvIHN0aWxsIGJlIGluIHRoZSBwcm90b3R5cGUgY2hhaW4uCglpZiAoa28udXRpbHMuY2FuU2V0UHJvdG90eXBlKSB7CgkgICAga28udXRpbHMuc2V0UHJvdG90eXBlT2Yoa29fc3Vic2NyaWJhYmxlX2ZuLCBGdW5jdGlvbi5wcm90b3R5cGUpOwoJfQoKCWtvLnN1YnNjcmliYWJsZVsnZm4nXSA9IGtvX3N1YnNjcmliYWJsZV9mbjsKCgoJa28uaXNTdWJzY3JpYmFibGUgPSBmdW5jdGlvbiAoaW5zdGFuY2UpIHsKCSAgICByZXR1cm4gaW5zdGFuY2UgIT0gbnVsbCAmJiB0eXBlb2YgaW5zdGFuY2Uuc3Vic2NyaWJlID09ICJmdW5jdGlvbiIgJiYgdHlwZW9mIGluc3RhbmNlWyJub3RpZnlTdWJzY3JpYmVycyJdID09ICJmdW5jdGlvbiI7Cgl9OwoKCWtvLmV4cG9ydFN5bWJvbCgnc3Vic2NyaWJhYmxlJywga28uc3Vic2NyaWJhYmxlKTsKCWtvLmV4cG9ydFN5bWJvbCgnaXNTdWJzY3JpYmFibGUnLCBrby5pc1N1YnNjcmliYWJsZSk7CgoJa28uY29tcHV0ZWRDb250ZXh0ID0ga28uZGVwZW5kZW5jeURldGVjdGlvbiA9IChmdW5jdGlvbiAoKSB7CgkgICAgdmFyIG91dGVyRnJhbWVzID0gW10sCgkgICAgICAgIGN1cnJlbnRGcmFtZSwKCSAgICAgICAgbGFzdElkID0gMDsKCgkgICAgLy8gUmV0dXJuIGEgdW5pcXVlIElEIHRoYXQgY2FuIGJlIGFzc2lnbmVkIHRvIGFuIG9ic2VydmFibGUgZm9yIGRlcGVuZGVuY3kgdHJhY2tpbmcuCgkgICAgLy8gVGhlb3JldGljYWxseSwgeW91IGNvdWxkIGV2ZW50dWFsbHkgb3ZlcmZsb3cgdGhlIG51bWJlciBzdG9yYWdlIHNpemUsIHJlc3VsdGluZwoJICAgIC8vIGluIGR1cGxpY2F0ZSBJRHMuIEJ1dCBpbiBKYXZhU2NyaXB0LCB0aGUgbGFyZ2VzdCBleGFjdCBpbnRlZ3JhbCB2YWx1ZSBpcyAyXjUzCgkgICAgLy8gb3IgOSwwMDcsMTk5LDI1NCw3NDAsOTkyLiBJZiB5b3UgY3JlYXRlZCAxLDAwMCwwMDAgSURzIHBlciBzZWNvbmQsIGl0IHdvdWxkCgkgICAgLy8gdGFrZSBvdmVyIDI4NSB5ZWFycyB0byByZWFjaCB0aGF0IG51bWJlci4KCSAgICAvLyBSZWZlcmVuY2UgaHR0cDovL2Jsb2cudmpldXguY29tLzIwMTAvamF2YXNjcmlwdC9qYXZhc2NyaXB0LW1heF9pbnQtbnVtYmVyLWxpbWl0cy5odG1sCgkgICAgZnVuY3Rpb24gZ2V0SWQoKSB7CgkgICAgICAgIHJldHVybiArK2xhc3RJZDsKCSAgICB9CgoJICAgIGZ1bmN0aW9uIGJlZ2luKG9wdGlvbnMpIHsKCSAgICAgICAgb3V0ZXJGcmFtZXMucHVzaChjdXJyZW50RnJhbWUpOwoJICAgICAgICBjdXJyZW50RnJhbWUgPSBvcHRpb25zOwoJICAgIH0KCgkgICAgZnVuY3Rpb24gZW5kKCkgewoJICAgICAgICBjdXJyZW50RnJhbWUgPSBvdXRlckZyYW1lcy5wb3AoKTsKCSAgICB9CgoJICAgIHJldHVybiB7CgkgICAgICAgIGJlZ2luOiBiZWdpbiwKCgkgICAgICAgIGVuZDogZW5kLAoKCSAgICAgICAgcmVnaXN0ZXJEZXBlbmRlbmN5OiBmdW5jdGlvbiAoc3Vic2NyaWJhYmxlKSB7CgkgICAgICAgICAgICBpZiAoY3VycmVudEZyYW1lKSB7CgkgICAgICAgICAgICAgICAgaWYgKCFrby5pc1N1YnNjcmliYWJsZShzdWJzY3JpYmFibGUpKQoJICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIk9ubHkgc3Vic2NyaWJhYmxlIHRoaW5ncyBjYW4gYWN0IGFzIGRlcGVuZGVuY2llcyIpOwoJICAgICAgICAgICAgICAgIGN1cnJlbnRGcmFtZS5jYWxsYmFjayhzdWJzY3JpYmFibGUsIHN1YnNjcmliYWJsZS5faWQgfHwgKHN1YnNjcmliYWJsZS5faWQgPSBnZXRJZCgpKSk7CgkgICAgICAgICAgICB9CgkgICAgICAgIH0sCgoJICAgICAgICBpZ25vcmU6IGZ1bmN0aW9uIChjYWxsYmFjaywgY2FsbGJhY2tUYXJnZXQsIGNhbGxiYWNrQXJncykgewoJICAgICAgICAgICAgdHJ5IHsKCSAgICAgICAgICAgICAgICBiZWdpbigpOwoJICAgICAgICAgICAgICAgIHJldHVybiBjYWxsYmFjay5hcHBseShjYWxsYmFja1RhcmdldCwgY2FsbGJhY2tBcmdzIHx8IFtdKTsKCSAgICAgICAgICAgIH0gZmluYWxseSB7CgkgICAgICAgICAgICAgICAgZW5kKCk7CgkgICAgICAgICAgICB9CgkgICAgICAgIH0sCgoJICAgICAgICBnZXREZXBlbmRlbmNpZXNDb3VudDogZnVuY3Rpb24gKCkgewoJICAgICAgICAgICAgaWYgKGN1cnJlbnRGcmFtZSkKCSAgICAgICAgICAgICAgICByZXR1cm4gY3VycmVudEZyYW1lLmNvbXB1dGVkLmdldERlcGVuZGVuY2llc0NvdW50KCk7CgkgICAgICAgIH0sCgoJICAgICAgICBpc0luaXRpYWw6IGZ1bmN0aW9uKCkgewoJICAgICAgICAgICAgaWYgKGN1cnJlbnRGcmFtZSkKCSAgICAgICAgICAgICAgICByZXR1cm4gY3VycmVudEZyYW1lLmlzSW5pdGlhbDsKCSAgICAgICAgfQoJICAgIH07Cgl9KSgpOwoKCWtvLmV4cG9ydFN5bWJvbCgnY29tcHV0ZWRDb250ZXh0Jywga28uY29tcHV0ZWRDb250ZXh0KTsKCWtvLmV4cG9ydFN5bWJvbCgnY29tcHV0ZWRDb250ZXh0LmdldERlcGVuZGVuY2llc0NvdW50Jywga28uY29tcHV0ZWRDb250ZXh0LmdldERlcGVuZGVuY2llc0NvdW50KTsKCWtvLmV4cG9ydFN5bWJvbCgnY29tcHV0ZWRDb250ZXh0LmlzSW5pdGlhbCcsIGtvLmNvbXB1dGVkQ29udGV4dC5pc0luaXRpYWwpOwoJa28uZXhwb3J0U3ltYm9sKCdjb21wdXRlZENvbnRleHQuaXNTbGVlcGluZycsIGtvLmNvbXB1dGVkQ29udGV4dC5pc1NsZWVwaW5nKTsKCWtvLm9ic2VydmFibGUgPSBmdW5jdGlvbiAoaW5pdGlhbFZhbHVlKSB7CgkgICAgdmFyIF9sYXRlc3RWYWx1ZSA9IGluaXRpYWxWYWx1ZTsKCgkgICAgZnVuY3Rpb24gb2JzZXJ2YWJsZSgpIHsKCSAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPiAwKSB7CgkgICAgICAgICAgICAvLyBXcml0ZQoKCSAgICAgICAgICAgIC8vIElnbm9yZSB3cml0ZXMgaWYgdGhlIHZhbHVlIGhhc24ndCBjaGFuZ2VkCgkgICAgICAgICAgICBpZiAob2JzZXJ2YWJsZS5pc0RpZmZlcmVudChfbGF0ZXN0VmFsdWUsIGFyZ3VtZW50c1swXSkpIHsKCSAgICAgICAgICAgICAgICBvYnNlcnZhYmxlLnZhbHVlV2lsbE11dGF0ZSgpOwoJICAgICAgICAgICAgICAgIF9sYXRlc3RWYWx1ZSA9IGFyZ3VtZW50c1swXTsKCSAgICAgICAgICAgICAgICBpZiAoREVCVUcpIG9ic2VydmFibGUuX2xhdGVzdFZhbHVlID0gX2xhdGVzdFZhbHVlOwoJICAgICAgICAgICAgICAgIG9ic2VydmFibGUudmFsdWVIYXNNdXRhdGVkKCk7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICByZXR1cm4gdGhpczsgLy8gUGVybWl0cyBjaGFpbmVkIGFzc2lnbm1lbnRzCgkgICAgICAgIH0KCSAgICAgICAgZWxzZSB7CgkgICAgICAgICAgICAvLyBSZWFkCgkgICAgICAgICAgICBrby5kZXBlbmRlbmN5RGV0ZWN0aW9uLnJlZ2lzdGVyRGVwZW5kZW5jeShvYnNlcnZhYmxlKTsgLy8gVGhlIGNhbGxlciBvbmx5IG5lZWRzIHRvIGJlIG5vdGlmaWVkIG9mIGNoYW5nZXMgaWYgdGhleSBkaWQgYSAicmVhZCIgb3BlcmF0aW9uCgkgICAgICAgICAgICByZXR1cm4gX2xhdGVzdFZhbHVlOwoJICAgICAgICB9CgkgICAgfQoJICAgIGtvLnN1YnNjcmliYWJsZS5jYWxsKG9ic2VydmFibGUpOwoJICAgIGtvLnV0aWxzLnNldFByb3RvdHlwZU9mT3JFeHRlbmQob2JzZXJ2YWJsZSwga28ub2JzZXJ2YWJsZVsnZm4nXSk7CgoJICAgIGlmIChERUJVRykgb2JzZXJ2YWJsZS5fbGF0ZXN0VmFsdWUgPSBfbGF0ZXN0VmFsdWU7CgkgICAgb2JzZXJ2YWJsZS5wZWVrID0gZnVuY3Rpb24oKSB7IHJldHVybiBfbGF0ZXN0VmFsdWUgfTsKCSAgICBvYnNlcnZhYmxlLnZhbHVlSGFzTXV0YXRlZCA9IGZ1bmN0aW9uICgpIHsgb2JzZXJ2YWJsZVsibm90aWZ5U3Vic2NyaWJlcnMiXShfbGF0ZXN0VmFsdWUpOyB9CgkgICAgb2JzZXJ2YWJsZS52YWx1ZVdpbGxNdXRhdGUgPSBmdW5jdGlvbiAoKSB7IG9ic2VydmFibGVbIm5vdGlmeVN1YnNjcmliZXJzIl0oX2xhdGVzdFZhbHVlLCAiYmVmb3JlQ2hhbmdlIik7IH0KCgkgICAga28uZXhwb3J0UHJvcGVydHkob2JzZXJ2YWJsZSwgJ3BlZWsnLCBvYnNlcnZhYmxlLnBlZWspOwoJICAgIGtvLmV4cG9ydFByb3BlcnR5KG9ic2VydmFibGUsICJ2YWx1ZUhhc011dGF0ZWQiLCBvYnNlcnZhYmxlLnZhbHVlSGFzTXV0YXRlZCk7CgkgICAga28uZXhwb3J0UHJvcGVydHkob2JzZXJ2YWJsZSwgInZhbHVlV2lsbE11dGF0ZSIsIG9ic2VydmFibGUudmFsdWVXaWxsTXV0YXRlKTsKCgkgICAgcmV0dXJuIG9ic2VydmFibGU7Cgl9CgoJa28ub2JzZXJ2YWJsZVsnZm4nXSA9IHsKCSAgICAiZXF1YWxpdHlDb21wYXJlciI6IHZhbHVlc0FyZVByaW1pdGl2ZUFuZEVxdWFsCgl9OwoKCXZhciBwcm90b1Byb3BlcnR5ID0ga28ub2JzZXJ2YWJsZS5wcm90b1Byb3BlcnR5ID0gIl9fa29fcHJvdG9fXyI7Cglrby5vYnNlcnZhYmxlWydmbiddW3Byb3RvUHJvcGVydHldID0ga28ub2JzZXJ2YWJsZTsKCgkvLyBOb3RlIHRoYXQgZm9yIGJyb3dzZXJzIHRoYXQgZG9uJ3Qgc3VwcG9ydCBwcm90byBhc3NpZ25tZW50LCB0aGUKCS8vIGluaGVyaXRhbmNlIGNoYWluIGlzIGNyZWF0ZWQgbWFudWFsbHkgaW4gdGhlIGtvLm9ic2VydmFibGUgY29uc3RydWN0b3IKCWlmIChrby51dGlscy5jYW5TZXRQcm90b3R5cGUpIHsKCSAgICBrby51dGlscy5zZXRQcm90b3R5cGVPZihrby5vYnNlcnZhYmxlWydmbiddLCBrby5zdWJzY3JpYmFibGVbJ2ZuJ10pOwoJfQoKCWtvLmhhc1Byb3RvdHlwZSA9IGZ1bmN0aW9uKGluc3RhbmNlLCBwcm90b3R5cGUpIHsKCSAgICBpZiAoKGluc3RhbmNlID09PSBudWxsKSB8fCAoaW5zdGFuY2UgPT09IHVuZGVmaW5lZCkgfHwgKGluc3RhbmNlW3Byb3RvUHJvcGVydHldID09PSB1bmRlZmluZWQpKSByZXR1cm4gZmFsc2U7CgkgICAgaWYgKGluc3RhbmNlW3Byb3RvUHJvcGVydHldID09PSBwcm90b3R5cGUpIHJldHVybiB0cnVlOwoJICAgIHJldHVybiBrby5oYXNQcm90b3R5cGUoaW5zdGFuY2VbcHJvdG9Qcm9wZXJ0eV0sIHByb3RvdHlwZSk7IC8vIFdhbGsgdGhlIHByb3RvdHlwZSBjaGFpbgoJfTsKCglrby5pc09ic2VydmFibGUgPSBmdW5jdGlvbiAoaW5zdGFuY2UpIHsKCSAgICByZXR1cm4ga28uaGFzUHJvdG90eXBlKGluc3RhbmNlLCBrby5vYnNlcnZhYmxlKTsKCX0KCWtvLmlzV3JpdGVhYmxlT2JzZXJ2YWJsZSA9IGZ1bmN0aW9uIChpbnN0YW5jZSkgewoJICAgIC8vIE9ic2VydmFibGUKCSAgICBpZiAoKHR5cGVvZiBpbnN0YW5jZSA9PSAiZnVuY3Rpb24iKSAmJiBpbnN0YW5jZVtwcm90b1Byb3BlcnR5XSA9PT0ga28ub2JzZXJ2YWJsZSkKCSAgICAgICAgcmV0dXJuIHRydWU7CgkgICAgLy8gV3JpdGVhYmxlIGRlcGVuZGVudCBvYnNlcnZhYmxlCgkgICAgaWYgKCh0eXBlb2YgaW5zdGFuY2UgPT0gImZ1bmN0aW9uIikgJiYgKGluc3RhbmNlW3Byb3RvUHJvcGVydHldID09PSBrby5kZXBlbmRlbnRPYnNlcnZhYmxlKSAmJiAoaW5zdGFuY2UuaGFzV3JpdGVGdW5jdGlvbikpCgkgICAgICAgIHJldHVybiB0cnVlOwoJICAgIC8vIEFueXRoaW5nIGVsc2UKCSAgICByZXR1cm4gZmFsc2U7Cgl9CgoKCWtvLmV4cG9ydFN5bWJvbCgnb2JzZXJ2YWJsZScsIGtvLm9ic2VydmFibGUpOwoJa28uZXhwb3J0U3ltYm9sKCdpc09ic2VydmFibGUnLCBrby5pc09ic2VydmFibGUpOwoJa28uZXhwb3J0U3ltYm9sKCdpc1dyaXRlYWJsZU9ic2VydmFibGUnLCBrby5pc1dyaXRlYWJsZU9ic2VydmFibGUpOwoJa28uZXhwb3J0U3ltYm9sKCdpc1dyaXRhYmxlT2JzZXJ2YWJsZScsIGtvLmlzV3JpdGVhYmxlT2JzZXJ2YWJsZSk7Cglrby5vYnNlcnZhYmxlQXJyYXkgPSBmdW5jdGlvbiAoaW5pdGlhbFZhbHVlcykgewoJICAgIGluaXRpYWxWYWx1ZXMgPSBpbml0aWFsVmFsdWVzIHx8IFtdOwoKCSAgICBpZiAodHlwZW9mIGluaXRpYWxWYWx1ZXMgIT0gJ29iamVjdCcgfHwgISgnbGVuZ3RoJyBpbiBpbml0aWFsVmFsdWVzKSkKCSAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUaGUgYXJndW1lbnQgcGFzc2VkIHdoZW4gaW5pdGlhbGl6aW5nIGFuIG9ic2VydmFibGUgYXJyYXkgbXVzdCBiZSBhbiBhcnJheSwgb3IgbnVsbCwgb3IgdW5kZWZpbmVkLiIpOwoKCSAgICB2YXIgcmVzdWx0ID0ga28ub2JzZXJ2YWJsZShpbml0aWFsVmFsdWVzKTsKCSAgICBrby51dGlscy5zZXRQcm90b3R5cGVPZk9yRXh0ZW5kKHJlc3VsdCwga28ub2JzZXJ2YWJsZUFycmF5WydmbiddKTsKCSAgICByZXR1cm4gcmVzdWx0LmV4dGVuZCh7J3RyYWNrQXJyYXlDaGFuZ2VzJzp0cnVlfSk7Cgl9OwoKCWtvLm9ic2VydmFibGVBcnJheVsnZm4nXSA9IHsKCSAgICAncmVtb3ZlJzogZnVuY3Rpb24gKHZhbHVlT3JQcmVkaWNhdGUpIHsKCSAgICAgICAgdmFyIHVuZGVybHlpbmdBcnJheSA9IHRoaXMucGVlaygpOwoJICAgICAgICB2YXIgcmVtb3ZlZFZhbHVlcyA9IFtdOwoJICAgICAgICB2YXIgcHJlZGljYXRlID0gdHlwZW9mIHZhbHVlT3JQcmVkaWNhdGUgPT0gImZ1bmN0aW9uIiAmJiAha28uaXNPYnNlcnZhYmxlKHZhbHVlT3JQcmVkaWNhdGUpID8gdmFsdWVPclByZWRpY2F0ZSA6IGZ1bmN0aW9uICh2YWx1ZSkgeyByZXR1cm4gdmFsdWUgPT09IHZhbHVlT3JQcmVkaWNhdGU7IH07CgkgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdW5kZXJseWluZ0FycmF5Lmxlbmd0aDsgaSsrKSB7CgkgICAgICAgICAgICB2YXIgdmFsdWUgPSB1bmRlcmx5aW5nQXJyYXlbaV07CgkgICAgICAgICAgICBpZiAocHJlZGljYXRlKHZhbHVlKSkgewoJICAgICAgICAgICAgICAgIGlmIChyZW1vdmVkVmFsdWVzLmxlbmd0aCA9PT0gMCkgewoJICAgICAgICAgICAgICAgICAgICB0aGlzLnZhbHVlV2lsbE11dGF0ZSgpOwoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICByZW1vdmVkVmFsdWVzLnB1c2godmFsdWUpOwoJICAgICAgICAgICAgICAgIHVuZGVybHlpbmdBcnJheS5zcGxpY2UoaSwgMSk7CgkgICAgICAgICAgICAgICAgaS0tOwoJICAgICAgICAgICAgfQoJICAgICAgICB9CgkgICAgICAgIGlmIChyZW1vdmVkVmFsdWVzLmxlbmd0aCkgewoJICAgICAgICAgICAgdGhpcy52YWx1ZUhhc011dGF0ZWQoKTsKCSAgICAgICAgfQoJICAgICAgICByZXR1cm4gcmVtb3ZlZFZhbHVlczsKCSAgICB9LAoKCSAgICAncmVtb3ZlQWxsJzogZnVuY3Rpb24gKGFycmF5T2ZWYWx1ZXMpIHsKCSAgICAgICAgLy8gSWYgeW91IHBhc3NlZCB6ZXJvIGFyZ3MsIHdlIHJlbW92ZSBldmVyeXRoaW5nCgkgICAgICAgIGlmIChhcnJheU9mVmFsdWVzID09PSB1bmRlZmluZWQpIHsKCSAgICAgICAgICAgIHZhciB1bmRlcmx5aW5nQXJyYXkgPSB0aGlzLnBlZWsoKTsKCSAgICAgICAgICAgIHZhciBhbGxWYWx1ZXMgPSB1bmRlcmx5aW5nQXJyYXkuc2xpY2UoMCk7CgkgICAgICAgICAgICB0aGlzLnZhbHVlV2lsbE11dGF0ZSgpOwoJICAgICAgICAgICAgdW5kZXJseWluZ0FycmF5LnNwbGljZSgwLCB1bmRlcmx5aW5nQXJyYXkubGVuZ3RoKTsKCSAgICAgICAgICAgIHRoaXMudmFsdWVIYXNNdXRhdGVkKCk7CgkgICAgICAgICAgICByZXR1cm4gYWxsVmFsdWVzOwoJICAgICAgICB9CgkgICAgICAgIC8vIElmIHlvdSBwYXNzZWQgYW4gYXJnLCB3ZSBpbnRlcnByZXQgaXQgYXMgYW4gYXJyYXkgb2YgZW50cmllcyB0byByZW1vdmUKCSAgICAgICAgaWYgKCFhcnJheU9mVmFsdWVzKQoJICAgICAgICAgICAgcmV0dXJuIFtdOwoJICAgICAgICByZXR1cm4gdGhpc1sncmVtb3ZlJ10oZnVuY3Rpb24gKHZhbHVlKSB7CgkgICAgICAgICAgICByZXR1cm4ga28udXRpbHMuYXJyYXlJbmRleE9mKGFycmF5T2ZWYWx1ZXMsIHZhbHVlKSA+PSAwOwoJICAgICAgICB9KTsKCSAgICB9LAoKCSAgICAnZGVzdHJveSc6IGZ1bmN0aW9uICh2YWx1ZU9yUHJlZGljYXRlKSB7CgkgICAgICAgIHZhciB1bmRlcmx5aW5nQXJyYXkgPSB0aGlzLnBlZWsoKTsKCSAgICAgICAgdmFyIHByZWRpY2F0ZSA9IHR5cGVvZiB2YWx1ZU9yUHJlZGljYXRlID09ICJmdW5jdGlvbiIgJiYgIWtvLmlzT2JzZXJ2YWJsZSh2YWx1ZU9yUHJlZGljYXRlKSA/IHZhbHVlT3JQcmVkaWNhdGUgOiBmdW5jdGlvbiAodmFsdWUpIHsgcmV0dXJuIHZhbHVlID09PSB2YWx1ZU9yUHJlZGljYXRlOyB9OwoJICAgICAgICB0aGlzLnZhbHVlV2lsbE11dGF0ZSgpOwoJICAgICAgICBmb3IgKHZhciBpID0gdW5kZXJseWluZ0FycmF5Lmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CgkgICAgICAgICAgICB2YXIgdmFsdWUgPSB1bmRlcmx5aW5nQXJyYXlbaV07CgkgICAgICAgICAgICBpZiAocHJlZGljYXRlKHZhbHVlKSkKCSAgICAgICAgICAgICAgICB1bmRlcmx5aW5nQXJyYXlbaV1bIl9kZXN0cm95Il0gPSB0cnVlOwoJICAgICAgICB9CgkgICAgICAgIHRoaXMudmFsdWVIYXNNdXRhdGVkKCk7CgkgICAgfSwKCgkgICAgJ2Rlc3Ryb3lBbGwnOiBmdW5jdGlvbiAoYXJyYXlPZlZhbHVlcykgewoJICAgICAgICAvLyBJZiB5b3UgcGFzc2VkIHplcm8gYXJncywgd2UgZGVzdHJveSBldmVyeXRoaW5nCgkgICAgICAgIGlmIChhcnJheU9mVmFsdWVzID09PSB1bmRlZmluZWQpCgkgICAgICAgICAgICByZXR1cm4gdGhpc1snZGVzdHJveSddKGZ1bmN0aW9uKCkgeyByZXR1cm4gdHJ1ZSB9KTsKCgkgICAgICAgIC8vIElmIHlvdSBwYXNzZWQgYW4gYXJnLCB3ZSBpbnRlcnByZXQgaXQgYXMgYW4gYXJyYXkgb2YgZW50cmllcyB0byBkZXN0cm95CgkgICAgICAgIGlmICghYXJyYXlPZlZhbHVlcykKCSAgICAgICAgICAgIHJldHVybiBbXTsKCSAgICAgICAgcmV0dXJuIHRoaXNbJ2Rlc3Ryb3knXShmdW5jdGlvbiAodmFsdWUpIHsKCSAgICAgICAgICAgIHJldHVybiBrby51dGlscy5hcnJheUluZGV4T2YoYXJyYXlPZlZhbHVlcywgdmFsdWUpID49IDA7CgkgICAgICAgIH0pOwoJICAgIH0sCgoJICAgICdpbmRleE9mJzogZnVuY3Rpb24gKGl0ZW0pIHsKCSAgICAgICAgdmFyIHVuZGVybHlpbmdBcnJheSA9IHRoaXMoKTsKCSAgICAgICAgcmV0dXJuIGtvLnV0aWxzLmFycmF5SW5kZXhPZih1bmRlcmx5aW5nQXJyYXksIGl0ZW0pOwoJICAgIH0sCgoJICAgICdyZXBsYWNlJzogZnVuY3Rpb24ob2xkSXRlbSwgbmV3SXRlbSkgewoJICAgICAgICB2YXIgaW5kZXggPSB0aGlzWydpbmRleE9mJ10ob2xkSXRlbSk7CgkgICAgICAgIGlmIChpbmRleCA+PSAwKSB7CgkgICAgICAgICAgICB0aGlzLnZhbHVlV2lsbE11dGF0ZSgpOwoJICAgICAgICAgICAgdGhpcy5wZWVrKClbaW5kZXhdID0gbmV3SXRlbTsKCSAgICAgICAgICAgIHRoaXMudmFsdWVIYXNNdXRhdGVkKCk7CgkgICAgICAgIH0KCSAgICB9Cgl9OwoKCS8vIFBvcHVsYXRlIGtvLm9ic2VydmFibGVBcnJheS5mbiB3aXRoIHJlYWQvd3JpdGUgZnVuY3Rpb25zIGZyb20gbmF0aXZlIGFycmF5cwoJLy8gSW1wb3J0YW50OiBEbyBub3QgYWRkIGFueSBhZGRpdGlvbmFsIGZ1bmN0aW9ucyBoZXJlIHRoYXQgbWF5IHJlYXNvbmFibHkgYmUgdXNlZCB0byAqcmVhZCogZGF0YSBmcm9tIHRoZSBhcnJheQoJLy8gYmVjYXVzZSB3ZSdsbCBldmFsIHRoZW0gd2l0aG91dCBjYXVzaW5nIHN1YnNjcmlwdGlvbnMsIHNvIGtvLmNvbXB1dGVkIG91dHB1dCBjb3VsZCBlbmQgdXAgZ2V0dGluZyBzdGFsZQoJa28udXRpbHMuYXJyYXlGb3JFYWNoKFsicG9wIiwgInB1c2giLCAicmV2ZXJzZSIsICJzaGlmdCIsICJzb3J0IiwgInNwbGljZSIsICJ1bnNoaWZ0Il0sIGZ1bmN0aW9uIChtZXRob2ROYW1lKSB7CgkgICAga28ub2JzZXJ2YWJsZUFycmF5WydmbiddW21ldGhvZE5hbWVdID0gZnVuY3Rpb24gKCkgewoJICAgICAgICAvLyBVc2UgInBlZWsiIHRvIGF2b2lkIGNyZWF0aW5nIGEgc3Vic2NyaXB0aW9uIGluIGFueSBjb21wdXRlZCB0aGF0IHdlJ3JlIGV4ZWN1dGluZyBpbiB0aGUgY29udGV4dCBvZgoJICAgICAgICAvLyAoZm9yIGNvbnNpc3RlbmN5IHdpdGggbXV0YXRpbmcgcmVndWxhciBvYnNlcnZhYmxlcykKCSAgICAgICAgdmFyIHVuZGVybHlpbmdBcnJheSA9IHRoaXMucGVlaygpOwoJICAgICAgICB0aGlzLnZhbHVlV2lsbE11dGF0ZSgpOwoJICAgICAgICB0aGlzLmNhY2hlRGlmZkZvcktub3duT3BlcmF0aW9uKHVuZGVybHlpbmdBcnJheSwgbWV0aG9kTmFtZSwgYXJndW1lbnRzKTsKCSAgICAgICAgdmFyIG1ldGhvZENhbGxSZXN1bHQgPSB1bmRlcmx5aW5nQXJyYXlbbWV0aG9kTmFtZV0uYXBwbHkodW5kZXJseWluZ0FycmF5LCBhcmd1bWVudHMpOwoJICAgICAgICB0aGlzLnZhbHVlSGFzTXV0YXRlZCgpOwoJICAgICAgICByZXR1cm4gbWV0aG9kQ2FsbFJlc3VsdDsKCSAgICB9OwoJfSk7CgoJLy8gUG9wdWxhdGUga28ub2JzZXJ2YWJsZUFycmF5LmZuIHdpdGggcmVhZC1vbmx5IGZ1bmN0aW9ucyBmcm9tIG5hdGl2ZSBhcnJheXMKCWtvLnV0aWxzLmFycmF5Rm9yRWFjaChbInNsaWNlIl0sIGZ1bmN0aW9uIChtZXRob2ROYW1lKSB7CgkgICAga28ub2JzZXJ2YWJsZUFycmF5WydmbiddW21ldGhvZE5hbWVdID0gZnVuY3Rpb24gKCkgewoJICAgICAgICB2YXIgdW5kZXJseWluZ0FycmF5ID0gdGhpcygpOwoJICAgICAgICByZXR1cm4gdW5kZXJseWluZ0FycmF5W21ldGhvZE5hbWVdLmFwcGx5KHVuZGVybHlpbmdBcnJheSwgYXJndW1lbnRzKTsKCSAgICB9OwoJfSk7CgoJLy8gTm90ZSB0aGF0IGZvciBicm93c2VycyB0aGF0IGRvbid0IHN1cHBvcnQgcHJvdG8gYXNzaWdubWVudCwgdGhlCgkvLyBpbmhlcml0YW5jZSBjaGFpbiBpcyBjcmVhdGVkIG1hbnVhbGx5IGluIHRoZSBrby5vYnNlcnZhYmxlQXJyYXkgY29uc3RydWN0b3IKCWlmIChrby51dGlscy5jYW5TZXRQcm90b3R5cGUpIHsKCSAgICBrby51dGlscy5zZXRQcm90b3R5cGVPZihrby5vYnNlcnZhYmxlQXJyYXlbJ2ZuJ10sIGtvLm9ic2VydmFibGVbJ2ZuJ10pOwoJfQoKCWtvLmV4cG9ydFN5bWJvbCgnb2JzZXJ2YWJsZUFycmF5Jywga28ub2JzZXJ2YWJsZUFycmF5KTsKCXZhciBhcnJheUNoYW5nZUV2ZW50TmFtZSA9ICdhcnJheUNoYW5nZSc7Cglrby5leHRlbmRlcnNbJ3RyYWNrQXJyYXlDaGFuZ2VzJ10gPSBmdW5jdGlvbih0YXJnZXQpIHsKCSAgICAvLyBPbmx5IG1vZGlmeSB0aGUgdGFyZ2V0IG9ic2VydmFibGUgb25jZQoJICAgIGlmICh0YXJnZXQuY2FjaGVEaWZmRm9yS25vd25PcGVyYXRpb24pIHsKCSAgICAgICAgcmV0dXJuOwoJICAgIH0KCSAgICB2YXIgdHJhY2tpbmdDaGFuZ2VzID0gZmFsc2UsCgkgICAgICAgIGNhY2hlZERpZmYgPSBudWxsLAoJICAgICAgICBwZW5kaW5nTm90aWZpY2F0aW9ucyA9IDAsCgkgICAgICAgIHVuZGVybHlpbmdTdWJzY3JpYmVGdW5jdGlvbiA9IHRhcmdldC5zdWJzY3JpYmU7CgoJICAgIC8vIEludGVyY2VwdCAic3Vic2NyaWJlIiBjYWxscywgYW5kIGZvciBhcnJheSBjaGFuZ2UgZXZlbnRzLCBlbnN1cmUgY2hhbmdlIHRyYWNraW5nIGlzIGVuYWJsZWQKCSAgICB0YXJnZXQuc3Vic2NyaWJlID0gdGFyZ2V0WydzdWJzY3JpYmUnXSA9IGZ1bmN0aW9uKGNhbGxiYWNrLCBjYWxsYmFja1RhcmdldCwgZXZlbnQpIHsKCSAgICAgICAgaWYgKGV2ZW50ID09PSBhcnJheUNoYW5nZUV2ZW50TmFtZSkgewoJICAgICAgICAgICAgdHJhY2tDaGFuZ2VzKCk7CgkgICAgICAgIH0KCSAgICAgICAgcmV0dXJuIHVuZGVybHlpbmdTdWJzY3JpYmVGdW5jdGlvbi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoJICAgIH07CgoJICAgIGZ1bmN0aW9uIHRyYWNrQ2hhbmdlcygpIHsKCSAgICAgICAgLy8gQ2FsbGluZyAndHJhY2tDaGFuZ2VzJyBtdWx0aXBsZSB0aW1lcyBpcyB0aGUgc2FtZSBhcyBjYWxsaW5nIGl0IG9uY2UKCSAgICAgICAgaWYgKHRyYWNraW5nQ2hhbmdlcykgewoJICAgICAgICAgICAgcmV0dXJuOwoJICAgICAgICB9CgoJICAgICAgICB0cmFja2luZ0NoYW5nZXMgPSB0cnVlOwoKCSAgICAgICAgLy8gSW50ZXJjZXB0ICJub3RpZnlTdWJzY3JpYmVycyIgdG8gdHJhY2sgaG93IG1hbnkgdGltZXMgaXQgd2FzIGNhbGxlZC4KCSAgICAgICAgdmFyIHVuZGVybHlpbmdOb3RpZnlTdWJzY3JpYmVyc0Z1bmN0aW9uID0gdGFyZ2V0Wydub3RpZnlTdWJzY3JpYmVycyddOwoJICAgICAgICB0YXJnZXRbJ25vdGlmeVN1YnNjcmliZXJzJ10gPSBmdW5jdGlvbih2YWx1ZVRvTm90aWZ5LCBldmVudCkgewoJICAgICAgICAgICAgaWYgKCFldmVudCB8fCBldmVudCA9PT0gZGVmYXVsdEV2ZW50KSB7CgkgICAgICAgICAgICAgICAgKytwZW5kaW5nTm90aWZpY2F0aW9uczsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIHJldHVybiB1bmRlcmx5aW5nTm90aWZ5U3Vic2NyaWJlcnNGdW5jdGlvbi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoJICAgICAgICB9OwoKCSAgICAgICAgLy8gRWFjaCB0aW1lIHRoZSBhcnJheSBjaGFuZ2VzIHZhbHVlLCBjYXB0dXJlIGEgY2xvbmUgc28gdGhhdCBvbiB0aGUgbmV4dAoJICAgICAgICAvLyBjaGFuZ2UgaXQncyBwb3NzaWJsZSB0byBwcm9kdWNlIGEgZGlmZgoJICAgICAgICB2YXIgcHJldmlvdXNDb250ZW50cyA9IFtdLmNvbmNhdCh0YXJnZXQucGVlaygpIHx8IFtdKTsKCSAgICAgICAgY2FjaGVkRGlmZiA9IG51bGw7CgkgICAgICAgIHRhcmdldC5zdWJzY3JpYmUoZnVuY3Rpb24oY3VycmVudENvbnRlbnRzKSB7CgkgICAgICAgICAgICAvLyBNYWtlIGEgY29weSBvZiB0aGUgY3VycmVudCBjb250ZW50cyBhbmQgZW5zdXJlIGl0J3MgYW4gYXJyYXkKCSAgICAgICAgICAgIGN1cnJlbnRDb250ZW50cyA9IFtdLmNvbmNhdChjdXJyZW50Q29udGVudHMgfHwgW10pOwoKCSAgICAgICAgICAgIC8vIENvbXB1dGUgdGhlIGRpZmYgYW5kIGlzc3VlIG5vdGlmaWNhdGlvbnMsIGJ1dCBvbmx5IGlmIHNvbWVvbmUgaXMgbGlzdGVuaW5nCgkgICAgICAgICAgICBpZiAodGFyZ2V0Lmhhc1N1YnNjcmlwdGlvbnNGb3JFdmVudChhcnJheUNoYW5nZUV2ZW50TmFtZSkpIHsKCSAgICAgICAgICAgICAgICB2YXIgY2hhbmdlcyA9IGdldENoYW5nZXMocHJldmlvdXNDb250ZW50cywgY3VycmVudENvbnRlbnRzKTsKCSAgICAgICAgICAgICAgICBpZiAoY2hhbmdlcy5sZW5ndGgpIHsKCSAgICAgICAgICAgICAgICAgICAgdGFyZ2V0Wydub3RpZnlTdWJzY3JpYmVycyddKGNoYW5nZXMsIGFycmF5Q2hhbmdlRXZlbnROYW1lKTsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICB9CgoJICAgICAgICAgICAgLy8gRWxpbWluYXRlIHJlZmVyZW5jZXMgdG8gdGhlIG9sZCwgcmVtb3ZlZCBpdGVtcywgc28gdGhleSBjYW4gYmUgR0NlZAoJICAgICAgICAgICAgcHJldmlvdXNDb250ZW50cyA9IGN1cnJlbnRDb250ZW50czsKCSAgICAgICAgICAgIGNhY2hlZERpZmYgPSBudWxsOwoJICAgICAgICAgICAgcGVuZGluZ05vdGlmaWNhdGlvbnMgPSAwOwoJICAgICAgICB9KTsKCSAgICB9CgoJICAgIGZ1bmN0aW9uIGdldENoYW5nZXMocHJldmlvdXNDb250ZW50cywgY3VycmVudENvbnRlbnRzKSB7CgkgICAgICAgIC8vIFdlIHRyeSB0byByZS11c2UgY2FjaGVkIGRpZmZzLgoJICAgICAgICAvLyBUaGUgc2NlbmFyaW9zIHdoZXJlIHBlbmRpbmdOb3RpZmljYXRpb25zID4gMSBhcmUgd2hlbiB1c2luZyByYXRlLWxpbWl0aW5nIG9yIHRoZSBEZWZlcnJlZCBVcGRhdGVzCgkgICAgICAgIC8vIHBsdWdpbiwgd2hpY2ggd2l0aG91dCB0aGlzIGNoZWNrIHdvdWxkIG5vdCBiZSBjb21wYXRpYmxlIHdpdGggYXJyYXlDaGFuZ2Ugbm90aWZpY2F0aW9ucy4gTm9ybWFsbHksCgkgICAgICAgIC8vIG5vdGlmaWNhdGlvbnMgYXJlIGlzc3VlZCBpbW1lZGlhdGVseSBzbyB3ZSB3b3VsZG4ndCBiZSBxdWV1ZWluZyB1cCBtb3JlIHRoYW4gb25lLgoJICAgICAgICBpZiAoIWNhY2hlZERpZmYgfHwgcGVuZGluZ05vdGlmaWNhdGlvbnMgPiAxKSB7CgkgICAgICAgICAgICBjYWNoZWREaWZmID0ga28udXRpbHMuY29tcGFyZUFycmF5cyhwcmV2aW91c0NvbnRlbnRzLCBjdXJyZW50Q29udGVudHMsIHsgJ3NwYXJzZSc6IHRydWUgfSk7CgkgICAgICAgIH0KCgkgICAgICAgIHJldHVybiBjYWNoZWREaWZmOwoJICAgIH0KCgkgICAgdGFyZ2V0LmNhY2hlRGlmZkZvcktub3duT3BlcmF0aW9uID0gZnVuY3Rpb24ocmF3QXJyYXksIG9wZXJhdGlvbk5hbWUsIGFyZ3MpIHsKCSAgICAgICAgLy8gT25seSBydW4gaWYgd2UncmUgY3VycmVudGx5IHRyYWNraW5nIGNoYW5nZXMgZm9yIHRoaXMgb2JzZXJ2YWJsZSBhcnJheQoJICAgICAgICAvLyBhbmQgdGhlcmUgYXJlbid0IGFueSBwZW5kaW5nIGRlZmVycmVkIG5vdGlmaWNhdGlvbnMuCgkgICAgICAgIGlmICghdHJhY2tpbmdDaGFuZ2VzIHx8IHBlbmRpbmdOb3RpZmljYXRpb25zKSB7CgkgICAgICAgICAgICByZXR1cm47CgkgICAgICAgIH0KCSAgICAgICAgdmFyIGRpZmYgPSBbXSwKCSAgICAgICAgICAgIGFycmF5TGVuZ3RoID0gcmF3QXJyYXkubGVuZ3RoLAoJICAgICAgICAgICAgYXJnc0xlbmd0aCA9IGFyZ3MubGVuZ3RoLAoJICAgICAgICAgICAgb2Zmc2V0ID0gMDsKCgkgICAgICAgIGZ1bmN0aW9uIHB1c2hEaWZmKHN0YXR1cywgdmFsdWUsIGluZGV4KSB7CgkgICAgICAgICAgICByZXR1cm4gZGlmZltkaWZmLmxlbmd0aF0gPSB7ICdzdGF0dXMnOiBzdGF0dXMsICd2YWx1ZSc6IHZhbHVlLCAnaW5kZXgnOiBpbmRleCB9OwoJICAgICAgICB9CgkgICAgICAgIHN3aXRjaCAob3BlcmF0aW9uTmFtZSkgewoJICAgICAgICAgICAgY2FzZSAncHVzaCc6CgkgICAgICAgICAgICAgICAgb2Zmc2V0ID0gYXJyYXlMZW5ndGg7CgkgICAgICAgICAgICBjYXNlICd1bnNoaWZ0JzoKCSAgICAgICAgICAgICAgICBmb3IgKHZhciBpbmRleCA9IDA7IGluZGV4IDwgYXJnc0xlbmd0aDsgaW5kZXgrKykgewoJICAgICAgICAgICAgICAgICAgICBwdXNoRGlmZignYWRkZWQnLCBhcmdzW2luZGV4XSwgb2Zmc2V0ICsgaW5kZXgpOwoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICBicmVhazsKCgkgICAgICAgICAgICBjYXNlICdwb3AnOgoJICAgICAgICAgICAgICAgIG9mZnNldCA9IGFycmF5TGVuZ3RoIC0gMTsKCSAgICAgICAgICAgIGNhc2UgJ3NoaWZ0JzoKCSAgICAgICAgICAgICAgICBpZiAoYXJyYXlMZW5ndGgpIHsKCSAgICAgICAgICAgICAgICAgICAgcHVzaERpZmYoJ2RlbGV0ZWQnLCByYXdBcnJheVtvZmZzZXRdLCBvZmZzZXQpOwoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICBicmVhazsKCgkgICAgICAgICAgICBjYXNlICdzcGxpY2UnOgoJICAgICAgICAgICAgICAgIC8vIE5lZ2F0aXZlIHN0YXJ0IGluZGV4IG1lYW5zICdmcm9tIGVuZCBvZiBhcnJheScuIEFmdGVyIHRoYXQgd2UgY2xhbXAgdG8gWzAuLi5hcnJheUxlbmd0aF0uCgkgICAgICAgICAgICAgICAgLy8gU2VlIGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvV2ViL0phdmFTY3JpcHQvUmVmZXJlbmNlL0dsb2JhbF9PYmplY3RzL0FycmF5L3NwbGljZQoJICAgICAgICAgICAgICAgIHZhciBzdGFydEluZGV4ID0gTWF0aC5taW4oTWF0aC5tYXgoMCwgYXJnc1swXSA8IDAgPyBhcnJheUxlbmd0aCArIGFyZ3NbMF0gOiBhcmdzWzBdKSwgYXJyYXlMZW5ndGgpLAoJICAgICAgICAgICAgICAgICAgICBlbmREZWxldGVJbmRleCA9IGFyZ3NMZW5ndGggPT09IDEgPyBhcnJheUxlbmd0aCA6IE1hdGgubWluKHN0YXJ0SW5kZXggKyAoYXJnc1sxXSB8fCAwKSwgYXJyYXlMZW5ndGgpLAoJICAgICAgICAgICAgICAgICAgICBlbmRBZGRJbmRleCA9IHN0YXJ0SW5kZXggKyBhcmdzTGVuZ3RoIC0gMiwKCSAgICAgICAgICAgICAgICAgICAgZW5kSW5kZXggPSBNYXRoLm1heChlbmREZWxldGVJbmRleCwgZW5kQWRkSW5kZXgpLAoJICAgICAgICAgICAgICAgICAgICBhZGRpdGlvbnMgPSBbXSwgZGVsZXRpb25zID0gW107CgkgICAgICAgICAgICAgICAgZm9yICh2YXIgaW5kZXggPSBzdGFydEluZGV4LCBhcmdzSW5kZXggPSAyOyBpbmRleCA8IGVuZEluZGV4OyArK2luZGV4LCArK2FyZ3NJbmRleCkgewoJICAgICAgICAgICAgICAgICAgICBpZiAoaW5kZXggPCBlbmREZWxldGVJbmRleCkKCSAgICAgICAgICAgICAgICAgICAgICAgIGRlbGV0aW9ucy5wdXNoKHB1c2hEaWZmKCdkZWxldGVkJywgcmF3QXJyYXlbaW5kZXhdLCBpbmRleCkpOwoJICAgICAgICAgICAgICAgICAgICBpZiAoaW5kZXggPCBlbmRBZGRJbmRleCkKCSAgICAgICAgICAgICAgICAgICAgICAgIGFkZGl0aW9ucy5wdXNoKHB1c2hEaWZmKCdhZGRlZCcsIGFyZ3NbYXJnc0luZGV4XSwgaW5kZXgpKTsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAga28udXRpbHMuZmluZE1vdmVzSW5BcnJheUNvbXBhcmlzb24oZGVsZXRpb25zLCBhZGRpdGlvbnMpOwoJICAgICAgICAgICAgICAgIGJyZWFrOwoKCSAgICAgICAgICAgIGRlZmF1bHQ6CgkgICAgICAgICAgICAgICAgcmV0dXJuOwoJICAgICAgICB9CgkgICAgICAgIGNhY2hlZERpZmYgPSBkaWZmOwoJICAgIH07Cgl9OwoJa28uY29tcHV0ZWQgPSBrby5kZXBlbmRlbnRPYnNlcnZhYmxlID0gZnVuY3Rpb24gKGV2YWx1YXRvckZ1bmN0aW9uT3JPcHRpb25zLCBldmFsdWF0b3JGdW5jdGlvblRhcmdldCwgb3B0aW9ucykgewoJICAgIHZhciBfbGF0ZXN0VmFsdWUsCgkgICAgICAgIF9uZWVkc0V2YWx1YXRpb24gPSB0cnVlLAoJICAgICAgICBfaXNCZWluZ0V2YWx1YXRlZCA9IGZhbHNlLAoJICAgICAgICBfc3VwcHJlc3NEaXNwb3NhbFVudGlsRGlzcG9zZVdoZW5SZXR1cm5zRmFsc2UgPSBmYWxzZSwKCSAgICAgICAgX2lzRGlzcG9zZWQgPSBmYWxzZSwKCSAgICAgICAgcmVhZEZ1bmN0aW9uID0gZXZhbHVhdG9yRnVuY3Rpb25Pck9wdGlvbnMsCgkgICAgICAgIHB1cmUgPSBmYWxzZSwKCSAgICAgICAgaXNTbGVlcGluZyA9IGZhbHNlOwoKCSAgICBpZiAocmVhZEZ1bmN0aW9uICYmIHR5cGVvZiByZWFkRnVuY3Rpb24gPT0gIm9iamVjdCIpIHsKCSAgICAgICAgLy8gU2luZ2xlLXBhcmFtZXRlciBzeW50YXggLSBldmVyeXRoaW5nIGlzIG9uIHRoaXMgIm9wdGlvbnMiIHBhcmFtCgkgICAgICAgIG9wdGlvbnMgPSByZWFkRnVuY3Rpb247CgkgICAgICAgIHJlYWRGdW5jdGlvbiA9IG9wdGlvbnNbInJlYWQiXTsKCSAgICB9IGVsc2UgewoJICAgICAgICAvLyBNdWx0aS1wYXJhbWV0ZXIgc3ludGF4IC0gY29uc3RydWN0IHRoZSBvcHRpb25zIGFjY29yZGluZyB0byB0aGUgcGFyYW1zIHBhc3NlZAoJICAgICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKCSAgICAgICAgaWYgKCFyZWFkRnVuY3Rpb24pCgkgICAgICAgICAgICByZWFkRnVuY3Rpb24gPSBvcHRpb25zWyJyZWFkIl07CgkgICAgfQoJICAgIGlmICh0eXBlb2YgcmVhZEZ1bmN0aW9uICE9ICJmdW5jdGlvbiIpCgkgICAgICAgIHRocm93IG5ldyBFcnJvcigiUGFzcyBhIGZ1bmN0aW9uIHRoYXQgcmV0dXJucyB0aGUgdmFsdWUgb2YgdGhlIGtvLmNvbXB1dGVkIik7CgoJICAgIGZ1bmN0aW9uIGFkZFN1YnNjcmlwdGlvblRvRGVwZW5kZW5jeShzdWJzY3JpYmFibGUsIGlkKSB7CgkgICAgICAgIGlmICghX3N1YnNjcmlwdGlvbnNUb0RlcGVuZGVuY2llc1tpZF0pIHsKCSAgICAgICAgICAgIF9zdWJzY3JpcHRpb25zVG9EZXBlbmRlbmNpZXNbaWRdID0gc3Vic2NyaWJhYmxlLnN1YnNjcmliZShldmFsdWF0ZVBvc3NpYmx5QXN5bmMpOwoJICAgICAgICAgICAgKytfZGVwZW5kZW5jaWVzQ291bnQ7CgkgICAgICAgIH0KCSAgICB9CgoJICAgIGZ1bmN0aW9uIGRpc3Bvc2VBbGxTdWJzY3JpcHRpb25zVG9EZXBlbmRlbmNpZXMoKSB7CgkgICAgICAgIGtvLnV0aWxzLm9iamVjdEZvckVhY2goX3N1YnNjcmlwdGlvbnNUb0RlcGVuZGVuY2llcywgZnVuY3Rpb24gKGlkLCBzdWJzY3JpcHRpb24pIHsKCSAgICAgICAgICAgIHN1YnNjcmlwdGlvbi5kaXNwb3NlKCk7CgkgICAgICAgIH0pOwoJICAgICAgICBfc3Vic2NyaXB0aW9uc1RvRGVwZW5kZW5jaWVzID0ge307CgkgICAgfQoKCSAgICBmdW5jdGlvbiBkaXNwb3NlQ29tcHV0ZWQoKSB7CgkgICAgICAgIGRpc3Bvc2VBbGxTdWJzY3JpcHRpb25zVG9EZXBlbmRlbmNpZXMoKTsKCSAgICAgICAgX2RlcGVuZGVuY2llc0NvdW50ID0gMDsKCSAgICAgICAgX2lzRGlzcG9zZWQgPSB0cnVlOwoJICAgICAgICBfbmVlZHNFdmFsdWF0aW9uID0gZmFsc2U7CgkgICAgfQoKCSAgICBmdW5jdGlvbiBldmFsdWF0ZVBvc3NpYmx5QXN5bmMoKSB7CgkgICAgICAgIHZhciB0aHJvdHRsZUV2YWx1YXRpb25UaW1lb3V0ID0gZGVwZW5kZW50T2JzZXJ2YWJsZVsndGhyb3R0bGVFdmFsdWF0aW9uJ107CgkgICAgICAgIGlmICh0aHJvdHRsZUV2YWx1YXRpb25UaW1lb3V0ICYmIHRocm90dGxlRXZhbHVhdGlvblRpbWVvdXQgPj0gMCkgewoJICAgICAgICAgICAgY2xlYXJUaW1lb3V0KGV2YWx1YXRpb25UaW1lb3V0SW5zdGFuY2UpOwoJICAgICAgICAgICAgZXZhbHVhdGlvblRpbWVvdXRJbnN0YW5jZSA9IHNldFRpbWVvdXQoZXZhbHVhdGVJbW1lZGlhdGUsIHRocm90dGxlRXZhbHVhdGlvblRpbWVvdXQpOwoJICAgICAgICB9IGVsc2UgaWYgKGRlcGVuZGVudE9ic2VydmFibGUuX2V2YWxSYXRlTGltaXRlZCkgewoJICAgICAgICAgICAgZGVwZW5kZW50T2JzZXJ2YWJsZS5fZXZhbFJhdGVMaW1pdGVkKCk7CgkgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICBldmFsdWF0ZUltbWVkaWF0ZSgpOwoJICAgICAgICB9CgkgICAgfQoKCSAgICBmdW5jdGlvbiBldmFsdWF0ZUltbWVkaWF0ZShzdXBwcmVzc0NoYW5nZU5vdGlmaWNhdGlvbikgewoJICAgICAgICBpZiAoX2lzQmVpbmdFdmFsdWF0ZWQpIHsKCSAgICAgICAgICAgIGlmIChwdXJlKSB7CgkgICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoIkEgJ3B1cmUnIGNvbXB1dGVkIG11c3Qgbm90IGJlIGNhbGxlZCByZWN1cnNpdmVseSIpOwoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgLy8gSWYgdGhlIGV2YWx1YXRpb24gb2YgYSBrby5jb21wdXRlZCBjYXVzZXMgc2lkZSBlZmZlY3RzLCBpdCdzIHBvc3NpYmxlIHRoYXQgaXQgd2lsbCB0cmlnZ2VyIGl0cyBvd24gcmUtZXZhbHVhdGlvbi4KCSAgICAgICAgICAgIC8vIFRoaXMgaXMgbm90IGRlc2lyYWJsZSAoaXQncyBoYXJkIGZvciBhIGRldmVsb3BlciB0byByZWFsaXNlIGEgY2hhaW4gb2YgZGVwZW5kZW5jaWVzIG1pZ2h0IGNhdXNlIHRoaXMsIGFuZCB0aGV5IGFsbW9zdAoJICAgICAgICAgICAgLy8gY2VydGFpbmx5IGRpZG4ndCBpbnRlbmQgaW5maW5pdGUgcmUtZXZhbHVhdGlvbnMpLiBTbywgZm9yIHByZWRpY3RhYmlsaXR5LCB3ZSBzaW1wbHkgcHJldmVudCBrby5jb21wdXRlZHMgZnJvbSBjYXVzaW5nCgkgICAgICAgICAgICAvLyB0aGVpciBvd24gcmUtZXZhbHVhdGlvbi4gRnVydGhlciBkaXNjdXNzaW9uIGF0IGh0dHBzOi8vZ2l0aHViLmNvbS9TdGV2ZVNhbmRlcnNvbi9rbm9ja291dC9wdWxsLzM4NwoJICAgICAgICAgICAgcmV0dXJuOwoJICAgICAgICB9CgoJICAgICAgICAvLyBEbyBub3QgZXZhbHVhdGUgKGFuZCBwb3NzaWJseSBjYXB0dXJlIG5ldyBkZXBlbmRlbmNpZXMpIGlmIGRpc3Bvc2VkCgkgICAgICAgIGlmIChfaXNEaXNwb3NlZCkgewoJICAgICAgICAgICAgcmV0dXJuOwoJICAgICAgICB9CgoJICAgICAgICBpZiAoZGlzcG9zZVdoZW4gJiYgZGlzcG9zZVdoZW4oKSkgewoJICAgICAgICAgICAgLy8gU2VlIGNvbW1lbnQgYmVsb3cgYWJvdXQgX3N1cHByZXNzRGlzcG9zYWxVbnRpbERpc3Bvc2VXaGVuUmV0dXJuc0ZhbHNlCgkgICAgICAgICAgICBpZiAoIV9zdXBwcmVzc0Rpc3Bvc2FsVW50aWxEaXNwb3NlV2hlblJldHVybnNGYWxzZSkgewoJICAgICAgICAgICAgICAgIGRpc3Bvc2UoKTsKCSAgICAgICAgICAgICAgICByZXR1cm47CgkgICAgICAgICAgICB9CgkgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICAvLyBJdCBqdXN0IGRpZCByZXR1cm4gZmFsc2UsIHNvIHdlIGNhbiBzdG9wIHN1cHByZXNzaW5nIG5vdwoJICAgICAgICAgICAgX3N1cHByZXNzRGlzcG9zYWxVbnRpbERpc3Bvc2VXaGVuUmV0dXJuc0ZhbHNlID0gZmFsc2U7CgkgICAgICAgIH0KCgkgICAgICAgIF9pc0JlaW5nRXZhbHVhdGVkID0gdHJ1ZTsKCgkgICAgICAgIC8vIFdoZW4gc2xlZXBpbmcsIHJlY2FsY3VsYXRlIHRoZSB2YWx1ZSBhbmQgcmV0dXJuLgoJICAgICAgICBpZiAoaXNTbGVlcGluZykgewoJICAgICAgICAgICAgdHJ5IHsKCSAgICAgICAgICAgICAgICB2YXIgZGVwZW5kZW5jeVRyYWNraW5nID0ge307CgkgICAgICAgICAgICAgICAga28uZGVwZW5kZW5jeURldGVjdGlvbi5iZWdpbih7CgkgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrOiBmdW5jdGlvbiAoc3Vic2NyaWJhYmxlLCBpZCkgewoJICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFkZXBlbmRlbmN5VHJhY2tpbmdbaWRdKSB7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVwZW5kZW5jeVRyYWNraW5nW2lkXSA9IDE7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgKytfZGVwZW5kZW5jaWVzQ291bnQ7CgkgICAgICAgICAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgICAgIH0sCgkgICAgICAgICAgICAgICAgICAgIGNvbXB1dGVkOiBkZXBlbmRlbnRPYnNlcnZhYmxlLAoJICAgICAgICAgICAgICAgICAgICBpc0luaXRpYWw6IHVuZGVmaW5lZAoJICAgICAgICAgICAgICAgIH0pOwoJICAgICAgICAgICAgICAgIF9kZXBlbmRlbmNpZXNDb3VudCA9IDA7CgkgICAgICAgICAgICAgICAgX2xhdGVzdFZhbHVlID0gcmVhZEZ1bmN0aW9uLmNhbGwoZXZhbHVhdG9yRnVuY3Rpb25UYXJnZXQpOwoJICAgICAgICAgICAgfSBmaW5hbGx5IHsKCSAgICAgICAgICAgICAgICBrby5kZXBlbmRlbmN5RGV0ZWN0aW9uLmVuZCgpOwoJICAgICAgICAgICAgICAgIF9pc0JlaW5nRXZhbHVhdGVkID0gZmFsc2U7CgkgICAgICAgICAgICB9CgkgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICB0cnkgewoJICAgICAgICAgICAgICAgIC8vIEluaXRpYWxseSwgd2UgYXNzdW1lIHRoYXQgbm9uZSBvZiB0aGUgc3Vic2NyaXB0aW9ucyBhcmUgc3RpbGwgYmVpbmcgdXNlZCAoaS5lLiwgYWxsIGFyZSBjYW5kaWRhdGVzIGZvciBkaXNwb3NhbCkuCgkgICAgICAgICAgICAgICAgLy8gVGhlbiwgZHVyaW5nIGV2YWx1YXRpb24sIHdlIGNyb3NzIG9mZiBhbnkgdGhhdCBhcmUgaW4gZmFjdCBzdGlsbCBiZWluZyB1c2VkLgoJICAgICAgICAgICAgICAgIHZhciBkaXNwb3NhbENhbmRpZGF0ZXMgPSBfc3Vic2NyaXB0aW9uc1RvRGVwZW5kZW5jaWVzLCBkaXNwb3NhbENvdW50ID0gX2RlcGVuZGVuY2llc0NvdW50OwoJICAgICAgICAgICAgICAgIGtvLmRlcGVuZGVuY3lEZXRlY3Rpb24uYmVnaW4oewoJICAgICAgICAgICAgICAgICAgICBjYWxsYmFjazogZnVuY3Rpb24oc3Vic2NyaWJhYmxlLCBpZCkgewoJICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFfaXNEaXNwb3NlZCkgewoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkaXNwb3NhbENvdW50ICYmIGRpc3Bvc2FsQ2FuZGlkYXRlc1tpZF0pIHsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gRG9uJ3Qgd2FudCB0byBkaXNwb3NlIHRoaXMgc3Vic2NyaXB0aW9uLCBhcyBpdCdzIHN0aWxsIGJlaW5nIHVzZWQKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgX3N1YnNjcmlwdGlvbnNUb0RlcGVuZGVuY2llc1tpZF0gPSBkaXNwb3NhbENhbmRpZGF0ZXNbaWRdOwoJICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICArK19kZXBlbmRlbmNpZXNDb3VudDsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGRpc3Bvc2FsQ2FuZGlkYXRlc1tpZF07CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0tZGlzcG9zYWxDb3VudDsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBCcmFuZCBuZXcgc3Vic2NyaXB0aW9uIC0gYWRkIGl0CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFkZFN1YnNjcmlwdGlvblRvRGVwZW5kZW5jeShzdWJzY3JpYmFibGUsIGlkKTsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgICAgIH0sCgkgICAgICAgICAgICAgICAgICAgIGNvbXB1dGVkOiBkZXBlbmRlbnRPYnNlcnZhYmxlLAoJICAgICAgICAgICAgICAgICAgICBpc0luaXRpYWw6IHB1cmUgPyB1bmRlZmluZWQgOiAhX2RlcGVuZGVuY2llc0NvdW50ICAgICAgICAvLyBJZiB3ZSdyZSBldmFsdWF0aW5nIHdoZW4gdGhlcmUgYXJlIG5vIHByZXZpb3VzIGRlcGVuZGVuY2llcywgaXQgbXVzdCBiZSB0aGUgZmlyc3QgdGltZQoJICAgICAgICAgICAgICAgIH0pOwoKCSAgICAgICAgICAgICAgICBfc3Vic2NyaXB0aW9uc1RvRGVwZW5kZW5jaWVzID0ge307CgkgICAgICAgICAgICAgICAgX2RlcGVuZGVuY2llc0NvdW50ID0gMDsKCgkgICAgICAgICAgICAgICAgdHJ5IHsKCSAgICAgICAgICAgICAgICAgICAgdmFyIG5ld1ZhbHVlID0gZXZhbHVhdG9yRnVuY3Rpb25UYXJnZXQgPyByZWFkRnVuY3Rpb24uY2FsbChldmFsdWF0b3JGdW5jdGlvblRhcmdldCkgOiByZWFkRnVuY3Rpb24oKTsKCgkgICAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKCSAgICAgICAgICAgICAgICAgICAga28uZGVwZW5kZW5jeURldGVjdGlvbi5lbmQoKTsKCgkgICAgICAgICAgICAgICAgICAgIC8vIEZvciBlYWNoIHN1YnNjcmlwdGlvbiBubyBsb25nZXIgYmVpbmcgdXNlZCwgcmVtb3ZlIGl0IGZyb20gdGhlIGFjdGl2ZSBzdWJzY3JpcHRpb25zIGxpc3QgYW5kIGRpc3Bvc2UgaXQKCSAgICAgICAgICAgICAgICAgICAgaWYgKGRpc3Bvc2FsQ291bnQpIHsKCSAgICAgICAgICAgICAgICAgICAgICAgIGtvLnV0aWxzLm9iamVjdEZvckVhY2goZGlzcG9zYWxDYW5kaWRhdGVzLCBmdW5jdGlvbihpZCwgdG9EaXNwb3NlKSB7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9EaXNwb3NlLmRpc3Bvc2UoKTsKCSAgICAgICAgICAgICAgICAgICAgICAgIH0pOwoJICAgICAgICAgICAgICAgICAgICB9CgoJICAgICAgICAgICAgICAgICAgICBfbmVlZHNFdmFsdWF0aW9uID0gZmFsc2U7CgkgICAgICAgICAgICAgICAgfQoKCSAgICAgICAgICAgICAgICBpZiAoZGVwZW5kZW50T2JzZXJ2YWJsZS5pc0RpZmZlcmVudChfbGF0ZXN0VmFsdWUsIG5ld1ZhbHVlKSkgewoJICAgICAgICAgICAgICAgICAgICBkZXBlbmRlbnRPYnNlcnZhYmxlWyJub3RpZnlTdWJzY3JpYmVycyJdKF9sYXRlc3RWYWx1ZSwgImJlZm9yZUNoYW5nZSIpOwoKCSAgICAgICAgICAgICAgICAgICAgX2xhdGVzdFZhbHVlID0gbmV3VmFsdWU7CgkgICAgICAgICAgICAgICAgICAgIGlmIChERUJVRykgZGVwZW5kZW50T2JzZXJ2YWJsZS5fbGF0ZXN0VmFsdWUgPSBfbGF0ZXN0VmFsdWU7CgoJICAgICAgICAgICAgICAgICAgICBpZiAoc3VwcHJlc3NDaGFuZ2VOb3RpZmljYXRpb24gIT09IHRydWUpIHsgIC8vIENoZWNrIGZvciBzdHJpY3QgdHJ1ZSB2YWx1ZSBzaW5jZSBzZXRUaW1lb3V0IGluIEZpcmVmb3ggcGFzc2VzIGEgbnVtZXJpYyB2YWx1ZSB0byB0aGUgZnVuY3Rpb24KCSAgICAgICAgICAgICAgICAgICAgICAgIGRlcGVuZGVudE9ic2VydmFibGVbIm5vdGlmeVN1YnNjcmliZXJzIl0oX2xhdGVzdFZhbHVlKTsKCSAgICAgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgIH0gZmluYWxseSB7CgkgICAgICAgICAgICAgICAgX2lzQmVpbmdFdmFsdWF0ZWQgPSBmYWxzZTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgfQoKCSAgICAgICAgaWYgKCFfZGVwZW5kZW5jaWVzQ291bnQpCgkgICAgICAgICAgICBkaXNwb3NlKCk7CgkgICAgfQoKCSAgICBmdW5jdGlvbiBkZXBlbmRlbnRPYnNlcnZhYmxlKCkgewoJICAgICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA+IDApIHsKCSAgICAgICAgICAgIGlmICh0eXBlb2Ygd3JpdGVGdW5jdGlvbiA9PT0gImZ1bmN0aW9uIikgewoJICAgICAgICAgICAgICAgIC8vIFdyaXRpbmcgYSB2YWx1ZQoJICAgICAgICAgICAgICAgIHdyaXRlRnVuY3Rpb24uYXBwbHkoZXZhbHVhdG9yRnVuY3Rpb25UYXJnZXQsIGFyZ3VtZW50cyk7CgkgICAgICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQ2Fubm90IHdyaXRlIGEgdmFsdWUgdG8gYSBrby5jb21wdXRlZCB1bmxlc3MgeW91IHNwZWNpZnkgYSAnd3JpdGUnIG9wdGlvbi4gSWYgeW91IHdpc2ggdG8gcmVhZCB0aGUgY3VycmVudCB2YWx1ZSwgZG9uJ3QgcGFzcyBhbnkgcGFyYW1ldGVycy4iKTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIHJldHVybiB0aGlzOyAvLyBQZXJtaXRzIGNoYWluZWQgYXNzaWdubWVudHMKCSAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgIC8vIFJlYWRpbmcgdGhlIHZhbHVlCgkgICAgICAgICAgICBrby5kZXBlbmRlbmN5RGV0ZWN0aW9uLnJlZ2lzdGVyRGVwZW5kZW5jeShkZXBlbmRlbnRPYnNlcnZhYmxlKTsKCSAgICAgICAgICAgIGlmIChfbmVlZHNFdmFsdWF0aW9uKQoJICAgICAgICAgICAgICAgIGV2YWx1YXRlSW1tZWRpYXRlKHRydWUgLyogc3VwcHJlc3NDaGFuZ2VOb3RpZmljYXRpb24gKi8pOwoJICAgICAgICAgICAgcmV0dXJuIF9sYXRlc3RWYWx1ZTsKCSAgICAgICAgfQoJICAgIH0KCgkgICAgZnVuY3Rpb24gcGVlaygpIHsKCSAgICAgICAgLy8gUGVlayB3b24ndCByZS1ldmFsdWF0ZSwgZXhjZXB0IHRvIGdldCB0aGUgaW5pdGlhbCB2YWx1ZSB3aGVuICJkZWZlckV2YWx1YXRpb24iIGlzIHNldCwgb3Igd2hpbGUgdGhlIGNvbXB1dGVkIGlzIHNsZWVwaW5nLgoJICAgICAgICAvLyBUaG9zZSBhcmUgdGhlIG9ubHkgdGltZXMgdGhhdCBib3RoIG9mIHRoZXNlIGNvbmRpdGlvbnMgd2lsbCBiZSBzYXRpc2ZpZWQuCgkgICAgICAgIGlmIChfbmVlZHNFdmFsdWF0aW9uICYmICFfZGVwZW5kZW5jaWVzQ291bnQpCgkgICAgICAgICAgICBldmFsdWF0ZUltbWVkaWF0ZSh0cnVlIC8qIHN1cHByZXNzQ2hhbmdlTm90aWZpY2F0aW9uICovKTsKCSAgICAgICAgcmV0dXJuIF9sYXRlc3RWYWx1ZTsKCSAgICB9CgoJICAgIGZ1bmN0aW9uIGlzQWN0aXZlKCkgewoJICAgICAgICByZXR1cm4gX25lZWRzRXZhbHVhdGlvbiB8fCBfZGVwZW5kZW5jaWVzQ291bnQgPiAwOwoJICAgIH0KCgkgICAgLy8gQnkgaGVyZSwgIm9wdGlvbnMiIGlzIGFsd2F5cyBub24tbnVsbAoJICAgIHZhciB3cml0ZUZ1bmN0aW9uID0gb3B0aW9uc1sid3JpdGUiXSwKCSAgICAgICAgZGlzcG9zZVdoZW5Ob2RlSXNSZW1vdmVkID0gb3B0aW9uc1siZGlzcG9zZVdoZW5Ob2RlSXNSZW1vdmVkIl0gfHwgb3B0aW9ucy5kaXNwb3NlV2hlbk5vZGVJc1JlbW92ZWQgfHwgbnVsbCwKCSAgICAgICAgZGlzcG9zZVdoZW5PcHRpb24gPSBvcHRpb25zWyJkaXNwb3NlV2hlbiJdIHx8IG9wdGlvbnMuZGlzcG9zZVdoZW4sCgkgICAgICAgIGRpc3Bvc2VXaGVuID0gZGlzcG9zZVdoZW5PcHRpb24sCgkgICAgICAgIGRpc3Bvc2UgPSBkaXNwb3NlQ29tcHV0ZWQsCgkgICAgICAgIF9zdWJzY3JpcHRpb25zVG9EZXBlbmRlbmNpZXMgPSB7fSwKCSAgICAgICAgX2RlcGVuZGVuY2llc0NvdW50ID0gMCwKCSAgICAgICAgZXZhbHVhdGlvblRpbWVvdXRJbnN0YW5jZSA9IG51bGw7CgoJICAgIGlmICghZXZhbHVhdG9yRnVuY3Rpb25UYXJnZXQpCgkgICAgICAgIGV2YWx1YXRvckZ1bmN0aW9uVGFyZ2V0ID0gb3B0aW9uc1sib3duZXIiXTsKCgkgICAga28uc3Vic2NyaWJhYmxlLmNhbGwoZGVwZW5kZW50T2JzZXJ2YWJsZSk7CgkgICAga28udXRpbHMuc2V0UHJvdG90eXBlT2ZPckV4dGVuZChkZXBlbmRlbnRPYnNlcnZhYmxlLCBrby5kZXBlbmRlbnRPYnNlcnZhYmxlWydmbiddKTsKCgkgICAgZGVwZW5kZW50T2JzZXJ2YWJsZS5wZWVrID0gcGVlazsKCSAgICBkZXBlbmRlbnRPYnNlcnZhYmxlLmdldERlcGVuZGVuY2llc0NvdW50ID0gZnVuY3Rpb24gKCkgeyByZXR1cm4gX2RlcGVuZGVuY2llc0NvdW50OyB9OwoJICAgIGRlcGVuZGVudE9ic2VydmFibGUuaGFzV3JpdGVGdW5jdGlvbiA9IHR5cGVvZiBvcHRpb25zWyJ3cml0ZSJdID09PSAiZnVuY3Rpb24iOwoJICAgIGRlcGVuZGVudE9ic2VydmFibGUuZGlzcG9zZSA9IGZ1bmN0aW9uICgpIHsgZGlzcG9zZSgpOyB9OwoJICAgIGRlcGVuZGVudE9ic2VydmFibGUuaXNBY3RpdmUgPSBpc0FjdGl2ZTsKCgkgICAgLy8gUmVwbGFjZSB0aGUgbGltaXQgZnVuY3Rpb24gd2l0aCBvbmUgdGhhdCBkZWxheXMgZXZhbHVhdGlvbiBhcyB3ZWxsLgoJICAgIHZhciBvcmlnaW5hbExpbWl0ID0gZGVwZW5kZW50T2JzZXJ2YWJsZS5saW1pdDsKCSAgICBkZXBlbmRlbnRPYnNlcnZhYmxlLmxpbWl0ID0gZnVuY3Rpb24obGltaXRGdW5jdGlvbikgewoJICAgICAgICBvcmlnaW5hbExpbWl0LmNhbGwoZGVwZW5kZW50T2JzZXJ2YWJsZSwgbGltaXRGdW5jdGlvbik7CgkgICAgICAgIGRlcGVuZGVudE9ic2VydmFibGUuX2V2YWxSYXRlTGltaXRlZCA9IGZ1bmN0aW9uKCkgewoJICAgICAgICAgICAgZGVwZW5kZW50T2JzZXJ2YWJsZS5fcmF0ZUxpbWl0ZWRCZWZvcmVDaGFuZ2UoX2xhdGVzdFZhbHVlKTsKCgkgICAgICAgICAgICBfbmVlZHNFdmFsdWF0aW9uID0gdHJ1ZTsgICAgLy8gTWFyayBhcyBkaXJ0eQoKCSAgICAgICAgICAgIC8vIFBhc3MgdGhlIG9ic2VydmFibGUgdG8gdGhlIHJhdGUtbGltaXQgY29kZSwgd2hpY2ggd2lsbCBhY2Nlc3MgaXQgd2hlbgoJICAgICAgICAgICAgLy8gaXQncyB0aW1lIHRvIGRvIHRoZSBub3RpZmljYXRpb24uCgkgICAgICAgICAgICBkZXBlbmRlbnRPYnNlcnZhYmxlLl9yYXRlTGltaXRlZENoYW5nZShkZXBlbmRlbnRPYnNlcnZhYmxlKTsKCSAgICAgICAgfQoJICAgIH07CgoJICAgIGlmIChvcHRpb25zWydwdXJlJ10pIHsKCSAgICAgICAgcHVyZSA9IHRydWU7CgkgICAgICAgIGlzU2xlZXBpbmcgPSB0cnVlOyAgICAgLy8gU3RhcnRzIG9mZiBzbGVlcGluZzsgd2lsbCBhd2FrZSBvbiB0aGUgZmlyc3Qgc3Vic2NyaXB0aW9uCgkgICAgICAgIGRlcGVuZGVudE9ic2VydmFibGUuYmVmb3JlU3Vic2NyaXB0aW9uQWRkID0gZnVuY3Rpb24gKCkgewoJICAgICAgICAgICAgLy8gSWYgYXNsZWVwLCB3YWtlIHVwIHRoZSBjb21wdXRlZCBhbmQgZXZhbHVhdGUgdG8gcmVnaXN0ZXIgYW55IGRlcGVuZGVuY2llcy4KCSAgICAgICAgICAgIGlmIChpc1NsZWVwaW5nKSB7CgkgICAgICAgICAgICAgICAgaXNTbGVlcGluZyA9IGZhbHNlOwoJICAgICAgICAgICAgICAgIGV2YWx1YXRlSW1tZWRpYXRlKHRydWUgLyogc3VwcHJlc3NDaGFuZ2VOb3RpZmljYXRpb24gKi8pOwoJICAgICAgICAgICAgfQoJICAgICAgICB9CgkgICAgICAgIGRlcGVuZGVudE9ic2VydmFibGUuYWZ0ZXJTdWJzY3JpcHRpb25SZW1vdmUgPSBmdW5jdGlvbiAoKSB7CgkgICAgICAgICAgICBpZiAoIWRlcGVuZGVudE9ic2VydmFibGUuZ2V0U3Vic2NyaXB0aW9uc0NvdW50KCkpIHsKCSAgICAgICAgICAgICAgICBkaXNwb3NlQWxsU3Vic2NyaXB0aW9uc1RvRGVwZW5kZW5jaWVzKCk7CgkgICAgICAgICAgICAgICAgaXNTbGVlcGluZyA9IF9uZWVkc0V2YWx1YXRpb24gPSB0cnVlOwoJICAgICAgICAgICAgfQoJICAgICAgICB9CgkgICAgfSBlbHNlIGlmIChvcHRpb25zWydkZWZlckV2YWx1YXRpb24nXSkgewoJICAgICAgICAvLyBUaGlzIHdpbGwgZm9yY2UgYSBjb21wdXRlZCB3aXRoIGRlZmVyRXZhbHVhdGlvbiB0byBldmFsdWF0ZSB3aGVuIHRoZSBmaXJzdCBzdWJzY3JpcHRpb25zIGlzIHJlZ2lzdGVyZWQuCgkgICAgICAgIGRlcGVuZGVudE9ic2VydmFibGUuYmVmb3JlU3Vic2NyaXB0aW9uQWRkID0gZnVuY3Rpb24gKCkgewoJICAgICAgICAgICAgcGVlaygpOwoJICAgICAgICAgICAgZGVsZXRlIGRlcGVuZGVudE9ic2VydmFibGUuYmVmb3JlU3Vic2NyaXB0aW9uQWRkOwoJICAgICAgICB9CgkgICAgfQoKCSAgICBrby5leHBvcnRQcm9wZXJ0eShkZXBlbmRlbnRPYnNlcnZhYmxlLCAncGVlaycsIGRlcGVuZGVudE9ic2VydmFibGUucGVlayk7CgkgICAga28uZXhwb3J0UHJvcGVydHkoZGVwZW5kZW50T2JzZXJ2YWJsZSwgJ2Rpc3Bvc2UnLCBkZXBlbmRlbnRPYnNlcnZhYmxlLmRpc3Bvc2UpOwoJICAgIGtvLmV4cG9ydFByb3BlcnR5KGRlcGVuZGVudE9ic2VydmFibGUsICdpc0FjdGl2ZScsIGRlcGVuZGVudE9ic2VydmFibGUuaXNBY3RpdmUpOwoJICAgIGtvLmV4cG9ydFByb3BlcnR5KGRlcGVuZGVudE9ic2VydmFibGUsICdnZXREZXBlbmRlbmNpZXNDb3VudCcsIGRlcGVuZGVudE9ic2VydmFibGUuZ2V0RGVwZW5kZW5jaWVzQ291bnQpOwoKCSAgICAvLyBBZGQgYSAiZGlzcG9zZVdoZW4iIGNhbGxiYWNrIHRoYXQsIG9uIGVhY2ggZXZhbHVhdGlvbiwgZGlzcG9zZXMgaWYgdGhlIG5vZGUgd2FzIHJlbW92ZWQgd2l0aG91dCB1c2luZyBrby5yZW1vdmVOb2RlLgoJICAgIGlmIChkaXNwb3NlV2hlbk5vZGVJc1JlbW92ZWQpIHsKCSAgICAgICAgLy8gU2luY2UgdGhpcyBjb21wdXRlZCBpcyBhc3NvY2lhdGVkIHdpdGggYSBET00gbm9kZSwgYW5kIHdlIGRvbid0IHdhbnQgdG8gZGlzcG9zZSB0aGUgY29tcHV0ZWQKCSAgICAgICAgLy8gdW50aWwgdGhlIERPTSBub2RlIGlzICpyZW1vdmVkKiBmcm9tIHRoZSBkb2N1bWVudCAoYXMgb3Bwb3NlZCB0byBuZXZlciBoYXZpbmcgYmVlbiBpbiB0aGUgZG9jdW1lbnQpLAoJICAgICAgICAvLyB3ZSdsbCBwcmV2ZW50IGRpc3Bvc2FsIHVudGlsICJkaXNwb3NlV2hlbiIgZmlyc3QgcmV0dXJucyBmYWxzZS4KCSAgICAgICAgX3N1cHByZXNzRGlzcG9zYWxVbnRpbERpc3Bvc2VXaGVuUmV0dXJuc0ZhbHNlID0gdHJ1ZTsKCgkgICAgICAgIC8vIE9ubHkgd2F0Y2ggZm9yIHRoZSBub2RlJ3MgZGlzcG9zYWwgaWYgdGhlIHZhbHVlIHJlYWxseSBpcyBhIG5vZGUuIEl0IG1pZ2h0IG5vdCBiZSwKCSAgICAgICAgLy8gZS5nLiwgeyBkaXNwb3NlV2hlbk5vZGVJc1JlbW92ZWQ6IHRydWUgfSBjYW4gYmUgdXNlZCB0byBvcHQgaW50byB0aGUgIm9ubHkgZGlzcG9zZQoJICAgICAgICAvLyBhZnRlciBmaXJzdCBmYWxzZSByZXN1bHQiIGJlaGF2aW91ciBldmVuIGlmIHRoZXJlJ3Mgbm8gc3BlY2lmaWMgbm9kZSB0byB3YXRjaC4gVGhpcwoJICAgICAgICAvLyB0ZWNobmlxdWUgaXMgaW50ZW5kZWQgZm9yIEtPJ3MgaW50ZXJuYWwgdXNlIG9ubHkgYW5kIHNob3VsZG4ndCBiZSBkb2N1bWVudGVkIG9yIHVzZWQKCSAgICAgICAgLy8gYnkgYXBwbGljYXRpb24gY29kZSwgYXMgaXQncyBsaWtlbHkgdG8gY2hhbmdlIGluIGEgZnV0dXJlIHZlcnNpb24gb2YgS08uCgkgICAgICAgIGlmIChkaXNwb3NlV2hlbk5vZGVJc1JlbW92ZWQubm9kZVR5cGUpIHsKCSAgICAgICAgICAgIGRpc3Bvc2VXaGVuID0gZnVuY3Rpb24gKCkgewoJICAgICAgICAgICAgICAgIHJldHVybiAha28udXRpbHMuZG9tTm9kZUlzQXR0YWNoZWRUb0RvY3VtZW50KGRpc3Bvc2VXaGVuTm9kZUlzUmVtb3ZlZCkgfHwgKGRpc3Bvc2VXaGVuT3B0aW9uICYmIGRpc3Bvc2VXaGVuT3B0aW9uKCkpOwoJICAgICAgICAgICAgfTsKCSAgICAgICAgfQoJICAgIH0KCgkgICAgLy8gRXZhbHVhdGUsIHVubGVzcyBzbGVlcGluZyBvciBkZWZlckV2YWx1YXRpb24gaXMgdHJ1ZQoJICAgIGlmICghaXNTbGVlcGluZyAmJiAhb3B0aW9uc1snZGVmZXJFdmFsdWF0aW9uJ10pCgkgICAgICAgIGV2YWx1YXRlSW1tZWRpYXRlKCk7CgoJICAgIC8vIEF0dGFjaCBhIERPTSBub2RlIGRpc3Bvc2FsIGNhbGxiYWNrIHNvIHRoYXQgdGhlIGNvbXB1dGVkIHdpbGwgYmUgcHJvYWN0aXZlbHkgZGlzcG9zZWQgYXMgc29vbiBhcyB0aGUgbm9kZSBpcwoJICAgIC8vIHJlbW92ZWQgdXNpbmcga28ucmVtb3ZlTm9kZS4gQnV0IHNraXAgaWYgaXNBY3RpdmUgaXMgZmFsc2UgKHRoZXJlIHdpbGwgbmV2ZXIgYmUgYW55IGRlcGVuZGVuY2llcyB0byBkaXNwb3NlKS4KCSAgICBpZiAoZGlzcG9zZVdoZW5Ob2RlSXNSZW1vdmVkICYmIGlzQWN0aXZlKCkgJiYgZGlzcG9zZVdoZW5Ob2RlSXNSZW1vdmVkLm5vZGVUeXBlKSB7CgkgICAgICAgIGRpc3Bvc2UgPSBmdW5jdGlvbigpIHsKCSAgICAgICAgICAgIGtvLnV0aWxzLmRvbU5vZGVEaXNwb3NhbC5yZW1vdmVEaXNwb3NlQ2FsbGJhY2soZGlzcG9zZVdoZW5Ob2RlSXNSZW1vdmVkLCBkaXNwb3NlKTsKCSAgICAgICAgICAgIGRpc3Bvc2VDb21wdXRlZCgpOwoJICAgICAgICB9OwoJICAgICAgICBrby51dGlscy5kb21Ob2RlRGlzcG9zYWwuYWRkRGlzcG9zZUNhbGxiYWNrKGRpc3Bvc2VXaGVuTm9kZUlzUmVtb3ZlZCwgZGlzcG9zZSk7CgkgICAgfQoKCSAgICByZXR1cm4gZGVwZW5kZW50T2JzZXJ2YWJsZTsKCX07CgoJa28uaXNDb21wdXRlZCA9IGZ1bmN0aW9uKGluc3RhbmNlKSB7CgkgICAgcmV0dXJuIGtvLmhhc1Byb3RvdHlwZShpbnN0YW5jZSwga28uZGVwZW5kZW50T2JzZXJ2YWJsZSk7Cgl9OwoKCXZhciBwcm90b1Byb3AgPSBrby5vYnNlcnZhYmxlLnByb3RvUHJvcGVydHk7IC8vID09ICJfX2tvX3Byb3RvX18iCglrby5kZXBlbmRlbnRPYnNlcnZhYmxlW3Byb3RvUHJvcF0gPSBrby5vYnNlcnZhYmxlOwoKCWtvLmRlcGVuZGVudE9ic2VydmFibGVbJ2ZuJ10gPSB7CgkgICAgImVxdWFsaXR5Q29tcGFyZXIiOiB2YWx1ZXNBcmVQcmltaXRpdmVBbmRFcXVhbAoJfTsKCWtvLmRlcGVuZGVudE9ic2VydmFibGVbJ2ZuJ11bcHJvdG9Qcm9wXSA9IGtvLmRlcGVuZGVudE9ic2VydmFibGU7CgoJLy8gTm90ZSB0aGF0IGZvciBicm93c2VycyB0aGF0IGRvbid0IHN1cHBvcnQgcHJvdG8gYXNzaWdubWVudCwgdGhlCgkvLyBpbmhlcml0YW5jZSBjaGFpbiBpcyBjcmVhdGVkIG1hbnVhbGx5IGluIHRoZSBrby5kZXBlbmRlbnRPYnNlcnZhYmxlIGNvbnN0cnVjdG9yCglpZiAoa28udXRpbHMuY2FuU2V0UHJvdG90eXBlKSB7CgkgICAga28udXRpbHMuc2V0UHJvdG90eXBlT2Yoa28uZGVwZW5kZW50T2JzZXJ2YWJsZVsnZm4nXSwga28uc3Vic2NyaWJhYmxlWydmbiddKTsKCX0KCglrby5leHBvcnRTeW1ib2woJ2RlcGVuZGVudE9ic2VydmFibGUnLCBrby5kZXBlbmRlbnRPYnNlcnZhYmxlKTsKCWtvLmV4cG9ydFN5bWJvbCgnY29tcHV0ZWQnLCBrby5kZXBlbmRlbnRPYnNlcnZhYmxlKTsgLy8gTWFrZSAia28uY29tcHV0ZWQiIGFuIGFsaWFzIGZvciAia28uZGVwZW5kZW50T2JzZXJ2YWJsZSIKCWtvLmV4cG9ydFN5bWJvbCgnaXNDb21wdXRlZCcsIGtvLmlzQ29tcHV0ZWQpOwoKCWtvLnB1cmVDb21wdXRlZCA9IGZ1bmN0aW9uIChldmFsdWF0b3JGdW5jdGlvbk9yT3B0aW9ucywgZXZhbHVhdG9yRnVuY3Rpb25UYXJnZXQpIHsKCSAgICBpZiAodHlwZW9mIGV2YWx1YXRvckZ1bmN0aW9uT3JPcHRpb25zID09PSAnZnVuY3Rpb24nKSB7CgkgICAgICAgIHJldHVybiBrby5jb21wdXRlZChldmFsdWF0b3JGdW5jdGlvbk9yT3B0aW9ucywgZXZhbHVhdG9yRnVuY3Rpb25UYXJnZXQsIHsncHVyZSc6dHJ1ZX0pOwoJICAgIH0gZWxzZSB7CgkgICAgICAgIGV2YWx1YXRvckZ1bmN0aW9uT3JPcHRpb25zID0ga28udXRpbHMuZXh0ZW5kKHt9LCBldmFsdWF0b3JGdW5jdGlvbk9yT3B0aW9ucyk7ICAgLy8gbWFrZSBhIGNvcHkgb2YgdGhlIHBhcmFtZXRlciBvYmplY3QKCSAgICAgICAgZXZhbHVhdG9yRnVuY3Rpb25Pck9wdGlvbnNbJ3B1cmUnXSA9IHRydWU7CgkgICAgICAgIHJldHVybiBrby5jb21wdXRlZChldmFsdWF0b3JGdW5jdGlvbk9yT3B0aW9ucywgZXZhbHVhdG9yRnVuY3Rpb25UYXJnZXQpOwoJICAgIH0KCX0KCWtvLmV4cG9ydFN5bWJvbCgncHVyZUNvbXB1dGVkJywga28ucHVyZUNvbXB1dGVkKTsKCgkoZnVuY3Rpb24oKSB7CgkgICAgdmFyIG1heE5lc3RlZE9ic2VydmFibGVEZXB0aCA9IDEwOyAvLyBFc2NhcGUgdGhlICh1bmxpa2VseSkgcGF0aGFsb2dpY2FsIGNhc2Ugd2hlcmUgYW4gb2JzZXJ2YWJsZSdzIGN1cnJlbnQgdmFsdWUgaXMgaXRzZWxmIChvciBzaW1pbGFyIHJlZmVyZW5jZSBjeWNsZSkKCgkgICAga28udG9KUyA9IGZ1bmN0aW9uKHJvb3RPYmplY3QpIHsKCSAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT0gMCkKCSAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiV2hlbiBjYWxsaW5nIGtvLnRvSlMsIHBhc3MgdGhlIG9iamVjdCB5b3Ugd2FudCB0byBjb252ZXJ0LiIpOwoKCSAgICAgICAgLy8gV2UganVzdCB1bndyYXAgZXZlcnl0aGluZyBhdCBldmVyeSBsZXZlbCBpbiB0aGUgb2JqZWN0IGdyYXBoCgkgICAgICAgIHJldHVybiBtYXBKc09iamVjdEdyYXBoKHJvb3RPYmplY3QsIGZ1bmN0aW9uKHZhbHVlVG9NYXApIHsKCSAgICAgICAgICAgIC8vIExvb3AgYmVjYXVzZSBhbiBvYnNlcnZhYmxlJ3MgdmFsdWUgbWlnaHQgaW4gdHVybiBiZSBhbm90aGVyIG9ic2VydmFibGUgd3JhcHBlcgoJICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGtvLmlzT2JzZXJ2YWJsZSh2YWx1ZVRvTWFwKSAmJiAoaSA8IG1heE5lc3RlZE9ic2VydmFibGVEZXB0aCk7IGkrKykKCSAgICAgICAgICAgICAgICB2YWx1ZVRvTWFwID0gdmFsdWVUb01hcCgpOwoJICAgICAgICAgICAgcmV0dXJuIHZhbHVlVG9NYXA7CgkgICAgICAgIH0pOwoJICAgIH07CgoJICAgIGtvLnRvSlNPTiA9IGZ1bmN0aW9uKHJvb3RPYmplY3QsIHJlcGxhY2VyLCBzcGFjZSkgeyAgICAgLy8gcmVwbGFjZXIgYW5kIHNwYWNlIGFyZSBvcHRpb25hbAoJICAgICAgICB2YXIgcGxhaW5KYXZhU2NyaXB0T2JqZWN0ID0ga28udG9KUyhyb290T2JqZWN0KTsKCSAgICAgICAgcmV0dXJuIGtvLnV0aWxzLnN0cmluZ2lmeUpzb24ocGxhaW5KYXZhU2NyaXB0T2JqZWN0LCByZXBsYWNlciwgc3BhY2UpOwoJICAgIH07CgoJICAgIGZ1bmN0aW9uIG1hcEpzT2JqZWN0R3JhcGgocm9vdE9iamVjdCwgbWFwSW5wdXRDYWxsYmFjaywgdmlzaXRlZE9iamVjdHMpIHsKCSAgICAgICAgdmlzaXRlZE9iamVjdHMgPSB2aXNpdGVkT2JqZWN0cyB8fCBuZXcgb2JqZWN0TG9va3VwKCk7CgoJICAgICAgICByb290T2JqZWN0ID0gbWFwSW5wdXRDYWxsYmFjayhyb290T2JqZWN0KTsKCSAgICAgICAgdmFyIGNhbkhhdmVQcm9wZXJ0aWVzID0gKHR5cGVvZiByb290T2JqZWN0ID09ICJvYmplY3QiKSAmJiAocm9vdE9iamVjdCAhPT0gbnVsbCkgJiYgKHJvb3RPYmplY3QgIT09IHVuZGVmaW5lZCkgJiYgKCEocm9vdE9iamVjdCBpbnN0YW5jZW9mIERhdGUpKSAmJiAoIShyb290T2JqZWN0IGluc3RhbmNlb2YgU3RyaW5nKSkgJiYgKCEocm9vdE9iamVjdCBpbnN0YW5jZW9mIE51bWJlcikpICYmICghKHJvb3RPYmplY3QgaW5zdGFuY2VvZiBCb29sZWFuKSk7CgkgICAgICAgIGlmICghY2FuSGF2ZVByb3BlcnRpZXMpCgkgICAgICAgICAgICByZXR1cm4gcm9vdE9iamVjdDsKCgkgICAgICAgIHZhciBvdXRwdXRQcm9wZXJ0aWVzID0gcm9vdE9iamVjdCBpbnN0YW5jZW9mIEFycmF5ID8gW10gOiB7fTsKCSAgICAgICAgdmlzaXRlZE9iamVjdHMuc2F2ZShyb290T2JqZWN0LCBvdXRwdXRQcm9wZXJ0aWVzKTsKCgkgICAgICAgIHZpc2l0UHJvcGVydGllc09yQXJyYXlFbnRyaWVzKHJvb3RPYmplY3QsIGZ1bmN0aW9uKGluZGV4ZXIpIHsKCSAgICAgICAgICAgIHZhciBwcm9wZXJ0eVZhbHVlID0gbWFwSW5wdXRDYWxsYmFjayhyb290T2JqZWN0W2luZGV4ZXJdKTsKCgkgICAgICAgICAgICBzd2l0Y2ggKHR5cGVvZiBwcm9wZXJ0eVZhbHVlKSB7CgkgICAgICAgICAgICAgICAgY2FzZSAiYm9vbGVhbiI6CgkgICAgICAgICAgICAgICAgY2FzZSAibnVtYmVyIjoKCSAgICAgICAgICAgICAgICBjYXNlICJzdHJpbmciOgoJICAgICAgICAgICAgICAgIGNhc2UgImZ1bmN0aW9uIjoKCSAgICAgICAgICAgICAgICAgICAgb3V0cHV0UHJvcGVydGllc1tpbmRleGVyXSA9IHByb3BlcnR5VmFsdWU7CgkgICAgICAgICAgICAgICAgICAgIGJyZWFrOwoJICAgICAgICAgICAgICAgIGNhc2UgIm9iamVjdCI6CgkgICAgICAgICAgICAgICAgY2FzZSAidW5kZWZpbmVkIjoKCSAgICAgICAgICAgICAgICAgICAgdmFyIHByZXZpb3VzbHlNYXBwZWRWYWx1ZSA9IHZpc2l0ZWRPYmplY3RzLmdldChwcm9wZXJ0eVZhbHVlKTsKCSAgICAgICAgICAgICAgICAgICAgb3V0cHV0UHJvcGVydGllc1tpbmRleGVyXSA9IChwcmV2aW91c2x5TWFwcGVkVmFsdWUgIT09IHVuZGVmaW5lZCkKCSAgICAgICAgICAgICAgICAgICAgICAgID8gcHJldmlvdXNseU1hcHBlZFZhbHVlCgkgICAgICAgICAgICAgICAgICAgICAgICA6IG1hcEpzT2JqZWN0R3JhcGgocHJvcGVydHlWYWx1ZSwgbWFwSW5wdXRDYWxsYmFjaywgdmlzaXRlZE9iamVjdHMpOwoJICAgICAgICAgICAgICAgICAgICBicmVhazsKCSAgICAgICAgICAgIH0KCSAgICAgICAgfSk7CgoJICAgICAgICByZXR1cm4gb3V0cHV0UHJvcGVydGllczsKCSAgICB9CgoJICAgIGZ1bmN0aW9uIHZpc2l0UHJvcGVydGllc09yQXJyYXlFbnRyaWVzKHJvb3RPYmplY3QsIHZpc2l0b3JDYWxsYmFjaykgewoJICAgICAgICBpZiAocm9vdE9iamVjdCBpbnN0YW5jZW9mIEFycmF5KSB7CgkgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJvb3RPYmplY3QubGVuZ3RoOyBpKyspCgkgICAgICAgICAgICAgICAgdmlzaXRvckNhbGxiYWNrKGkpOwoKCSAgICAgICAgICAgIC8vIEZvciBhcnJheXMsIGFsc28gcmVzcGVjdCB0b0pTT04gcHJvcGVydHkgZm9yIGN1c3RvbSBtYXBwaW5ncyAoZml4ZXMgIzI3OCkKCSAgICAgICAgICAgIGlmICh0eXBlb2Ygcm9vdE9iamVjdFsndG9KU09OJ10gPT0gJ2Z1bmN0aW9uJykKCSAgICAgICAgICAgICAgICB2aXNpdG9yQ2FsbGJhY2soJ3RvSlNPTicpOwoJICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgZm9yICh2YXIgcHJvcGVydHlOYW1lIGluIHJvb3RPYmplY3QpIHsKCSAgICAgICAgICAgICAgICB2aXNpdG9yQ2FsbGJhY2socHJvcGVydHlOYW1lKTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgfQoJICAgIH07CgoJICAgIGZ1bmN0aW9uIG9iamVjdExvb2t1cCgpIHsKCSAgICAgICAgdGhpcy5rZXlzID0gW107CgkgICAgICAgIHRoaXMudmFsdWVzID0gW107CgkgICAgfTsKCgkgICAgb2JqZWN0TG9va3VwLnByb3RvdHlwZSA9IHsKCSAgICAgICAgY29uc3RydWN0b3I6IG9iamVjdExvb2t1cCwKCSAgICAgICAgc2F2ZTogZnVuY3Rpb24oa2V5LCB2YWx1ZSkgewoJICAgICAgICAgICAgdmFyIGV4aXN0aW5nSW5kZXggPSBrby51dGlscy5hcnJheUluZGV4T2YodGhpcy5rZXlzLCBrZXkpOwoJICAgICAgICAgICAgaWYgKGV4aXN0aW5nSW5kZXggPj0gMCkKCSAgICAgICAgICAgICAgICB0aGlzLnZhbHVlc1tleGlzdGluZ0luZGV4XSA9IHZhbHVlOwoJICAgICAgICAgICAgZWxzZSB7CgkgICAgICAgICAgICAgICAgdGhpcy5rZXlzLnB1c2goa2V5KTsKCSAgICAgICAgICAgICAgICB0aGlzLnZhbHVlcy5wdXNoKHZhbHVlKTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgfSwKCSAgICAgICAgZ2V0OiBmdW5jdGlvbihrZXkpIHsKCSAgICAgICAgICAgIHZhciBleGlzdGluZ0luZGV4ID0ga28udXRpbHMuYXJyYXlJbmRleE9mKHRoaXMua2V5cywga2V5KTsKCSAgICAgICAgICAgIHJldHVybiAoZXhpc3RpbmdJbmRleCA+PSAwKSA/IHRoaXMudmFsdWVzW2V4aXN0aW5nSW5kZXhdIDogdW5kZWZpbmVkOwoJICAgICAgICB9CgkgICAgfTsKCX0pKCk7CgoJa28uZXhwb3J0U3ltYm9sKCd0b0pTJywga28udG9KUyk7Cglrby5leHBvcnRTeW1ib2woJ3RvSlNPTicsIGtvLnRvSlNPTik7CgkoZnVuY3Rpb24gKCkgewoJICAgIHZhciBoYXNEb21EYXRhRXhwYW5kb1Byb3BlcnR5ID0gJ19fa29fX2hhc0RvbURhdGFPcHRpb25WYWx1ZV9fJzsKCgkgICAgLy8gTm9ybWFsbHksIFNFTEVDVCBlbGVtZW50cyBhbmQgdGhlaXIgT1BUSU9OcyBjYW4gb25seSB0YWtlIHZhbHVlIG9mIHR5cGUgJ3N0cmluZycgKGJlY2F1c2UgdGhlIHZhbHVlcwoJICAgIC8vIGFyZSBzdG9yZWQgb24gRE9NIGF0dHJpYnV0ZXMpLiBrby5zZWxlY3RFeHRlbnNpb25zIHByb3ZpZGVzIGEgd2F5IGZvciBTRUxFQ1RzL09QVElPTnMgdG8gaGF2ZSB2YWx1ZXMKCSAgICAvLyB0aGF0IGFyZSBhcmJpdHJhcnkgb2JqZWN0cy4gVGhpcyBpcyB2ZXJ5IGNvbnZlbmllbnQgd2hlbiBpbXBsZW1lbnRpbmcgdGhpbmdzIGxpa2UgY2FzY2FkaW5nIGRyb3Bkb3ducy4KCSAgICBrby5zZWxlY3RFeHRlbnNpb25zID0gewoJICAgICAgICByZWFkVmFsdWUgOiBmdW5jdGlvbihlbGVtZW50KSB7CgkgICAgICAgICAgICBzd2l0Y2ggKGtvLnV0aWxzLnRhZ05hbWVMb3dlcihlbGVtZW50KSkgewoJICAgICAgICAgICAgICAgIGNhc2UgJ29wdGlvbic6CgkgICAgICAgICAgICAgICAgICAgIGlmIChlbGVtZW50W2hhc0RvbURhdGFFeHBhbmRvUHJvcGVydHldID09PSB0cnVlKQoJICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGtvLnV0aWxzLmRvbURhdGEuZ2V0KGVsZW1lbnQsIGtvLmJpbmRpbmdIYW5kbGVycy5vcHRpb25zLm9wdGlvblZhbHVlRG9tRGF0YUtleSk7CgkgICAgICAgICAgICAgICAgICAgIHJldHVybiBrby51dGlscy5pZVZlcnNpb24gPD0gNwoJICAgICAgICAgICAgICAgICAgICAgICAgPyAoZWxlbWVudC5nZXRBdHRyaWJ1dGVOb2RlKCd2YWx1ZScpICYmIGVsZW1lbnQuZ2V0QXR0cmlidXRlTm9kZSgndmFsdWUnKS5zcGVjaWZpZWQgPyBlbGVtZW50LnZhbHVlIDogZWxlbWVudC50ZXh0KQoJICAgICAgICAgICAgICAgICAgICAgICAgOiBlbGVtZW50LnZhbHVlOwoJICAgICAgICAgICAgICAgIGNhc2UgJ3NlbGVjdCc6CgkgICAgICAgICAgICAgICAgICAgIHJldHVybiBlbGVtZW50LnNlbGVjdGVkSW5kZXggPj0gMCA/IGtvLnNlbGVjdEV4dGVuc2lvbnMucmVhZFZhbHVlKGVsZW1lbnQub3B0aW9uc1tlbGVtZW50LnNlbGVjdGVkSW5kZXhdKSA6IHVuZGVmaW5lZDsKCSAgICAgICAgICAgICAgICBkZWZhdWx0OgoJICAgICAgICAgICAgICAgICAgICByZXR1cm4gZWxlbWVudC52YWx1ZTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgfSwKCgkgICAgICAgIHdyaXRlVmFsdWU6IGZ1bmN0aW9uKGVsZW1lbnQsIHZhbHVlLCBhbGxvd1Vuc2V0KSB7CgkgICAgICAgICAgICBzd2l0Y2ggKGtvLnV0aWxzLnRhZ05hbWVMb3dlcihlbGVtZW50KSkgewoJICAgICAgICAgICAgICAgIGNhc2UgJ29wdGlvbic6CgkgICAgICAgICAgICAgICAgICAgIHN3aXRjaCh0eXBlb2YgdmFsdWUpIHsKCSAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgInN0cmluZyI6CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAga28udXRpbHMuZG9tRGF0YS5zZXQoZWxlbWVudCwga28uYmluZGluZ0hhbmRsZXJzLm9wdGlvbnMub3B0aW9uVmFsdWVEb21EYXRhS2V5LCB1bmRlZmluZWQpOwoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChoYXNEb21EYXRhRXhwYW5kb1Byb3BlcnR5IGluIGVsZW1lbnQpIHsgLy8gSUUgPD0gOCB0aHJvd3MgZXJyb3JzIGlmIHlvdSBkZWxldGUgbm9uLWV4aXN0ZW50IHByb3BlcnRpZXMgZnJvbSBhIERPTSBub2RlCgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBlbGVtZW50W2hhc0RvbURhdGFFeHBhbmRvUHJvcGVydHldOwoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50LnZhbHVlID0gdmFsdWU7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CgkgICAgICAgICAgICAgICAgICAgICAgICBkZWZhdWx0OgoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFN0b3JlIGFyYml0cmFyeSBvYmplY3QgdXNpbmcgRG9tRGF0YQoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIGtvLnV0aWxzLmRvbURhdGEuc2V0KGVsZW1lbnQsIGtvLmJpbmRpbmdIYW5kbGVycy5vcHRpb25zLm9wdGlvblZhbHVlRG9tRGF0YUtleSwgdmFsdWUpOwoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnRbaGFzRG9tRGF0YUV4cGFuZG9Qcm9wZXJ0eV0gPSB0cnVlOwoKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBTcGVjaWFsIHRyZWF0bWVudCBvZiBudW1iZXJzIGlzIGp1c3QgZm9yIGJhY2t3YXJkIGNvbXBhdGliaWxpdHkuIEtPIDEuMi4xIHdyb3RlIG51bWVyaWNhbCB2YWx1ZXMgdG8gZWxlbWVudC52YWx1ZS4KCSAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50LnZhbHVlID0gdHlwZW9mIHZhbHVlID09PSAibnVtYmVyIiA/IHZhbHVlIDogIiI7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CgkgICAgICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICAgICAgYnJlYWs7CgkgICAgICAgICAgICAgICAgY2FzZSAnc2VsZWN0JzoKCSAgICAgICAgICAgICAgICAgICAgaWYgKHZhbHVlID09PSAiIiB8fCB2YWx1ZSA9PT0gbnVsbCkgICAgICAgLy8gQSBibGFuayBzdHJpbmcgb3IgbnVsbCB2YWx1ZSB3aWxsIHNlbGVjdCB0aGUgY2FwdGlvbgoJICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSB1bmRlZmluZWQ7CgkgICAgICAgICAgICAgICAgICAgIHZhciBzZWxlY3Rpb24gPSAtMTsKCSAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIG4gPSBlbGVtZW50Lm9wdGlvbnMubGVuZ3RoLCBvcHRpb25WYWx1ZTsgaSA8IG47ICsraSkgewoJICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9uVmFsdWUgPSBrby5zZWxlY3RFeHRlbnNpb25zLnJlYWRWYWx1ZShlbGVtZW50Lm9wdGlvbnNbaV0pOwoJICAgICAgICAgICAgICAgICAgICAgICAgLy8gSW5jbHVkZSBzcGVjaWFsIGNoZWNrIHRvIGhhbmRsZSBzZWxlY3RpbmcgYSBjYXB0aW9uIHdpdGggYSBibGFuayBzdHJpbmcgdmFsdWUKCSAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvcHRpb25WYWx1ZSA9PSB2YWx1ZSB8fCAob3B0aW9uVmFsdWUgPT0gIiIgJiYgdmFsdWUgPT09IHVuZGVmaW5lZCkpIHsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3Rpb24gPSBpOwoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwoJICAgICAgICAgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgICAgIGlmIChhbGxvd1Vuc2V0IHx8IHNlbGVjdGlvbiA+PSAwIHx8ICh2YWx1ZSA9PT0gdW5kZWZpbmVkICYmIGVsZW1lbnQuc2l6ZSA+IDEpKSB7CgkgICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50LnNlbGVjdGVkSW5kZXggPSBzZWxlY3Rpb247CgkgICAgICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICAgICAgYnJlYWs7CgkgICAgICAgICAgICAgICAgZGVmYXVsdDoKCSAgICAgICAgICAgICAgICAgICAgaWYgKCh2YWx1ZSA9PT0gbnVsbCkgfHwgKHZhbHVlID09PSB1bmRlZmluZWQpKQoJICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSAiIjsKCSAgICAgICAgICAgICAgICAgICAgZWxlbWVudC52YWx1ZSA9IHZhbHVlOwoJICAgICAgICAgICAgICAgICAgICBicmVhazsKCSAgICAgICAgICAgIH0KCSAgICAgICAgfQoJICAgIH07Cgl9KSgpOwoKCWtvLmV4cG9ydFN5bWJvbCgnc2VsZWN0RXh0ZW5zaW9ucycsIGtvLnNlbGVjdEV4dGVuc2lvbnMpOwoJa28uZXhwb3J0U3ltYm9sKCdzZWxlY3RFeHRlbnNpb25zLnJlYWRWYWx1ZScsIGtvLnNlbGVjdEV4dGVuc2lvbnMucmVhZFZhbHVlKTsKCWtvLmV4cG9ydFN5bWJvbCgnc2VsZWN0RXh0ZW5zaW9ucy53cml0ZVZhbHVlJywga28uc2VsZWN0RXh0ZW5zaW9ucy53cml0ZVZhbHVlKTsKCWtvLmV4cHJlc3Npb25SZXdyaXRpbmcgPSAoZnVuY3Rpb24gKCkgewoJICAgIHZhciBqYXZhU2NyaXB0UmVzZXJ2ZWRXb3JkcyA9IFsidHJ1ZSIsICJmYWxzZSIsICJudWxsIiwgInVuZGVmaW5lZCJdOwoKCSAgICAvLyBNYXRjaGVzIHNvbWV0aGluZyB0aGF0IGNhbiBiZSBhc3NpZ25lZCB0by0tZWl0aGVyIGFuIGlzb2xhdGVkIGlkZW50aWZpZXIgb3Igc29tZXRoaW5nIGVuZGluZyB3aXRoIGEgcHJvcGVydHkgYWNjZXNzb3IKCSAgICAvLyBUaGlzIGlzIGRlc2lnbmVkIHRvIGJlIHNpbXBsZSBhbmQgYXZvaWQgZmFsc2UgbmVnYXRpdmVzLCBidXQgY291bGQgcHJvZHVjZSBmYWxzZSBwb3NpdGl2ZXMgKGUuZy4sIGErYi5jKS4KCSAgICAvLyBUaGlzIGFsc28gd2lsbCBub3QgcHJvcGVybHkgaGFuZGxlIG5lc3RlZCBicmFja2V0cyAoZS5nLiwgb2JqMVtvYmoyWydwcm9wJ11dOyBzZWUgIzkxMSkuCgkgICAgdmFyIGphdmFTY3JpcHRBc3NpZ25tZW50VGFyZ2V0ID0gL14oPzpbJF9hLXpdWyRcd10qfCguKykoXC5ccypbJF9hLXpdWyRcd10qfFxbLitcXSkpJC9pOwoKCSAgICBmdW5jdGlvbiBnZXRXcml0ZWFibGVWYWx1ZShleHByZXNzaW9uKSB7CgkgICAgICAgIGlmIChrby51dGlscy5hcnJheUluZGV4T2YoamF2YVNjcmlwdFJlc2VydmVkV29yZHMsIGV4cHJlc3Npb24pID49IDApCgkgICAgICAgICAgICByZXR1cm4gZmFsc2U7CgkgICAgICAgIHZhciBtYXRjaCA9IGV4cHJlc3Npb24ubWF0Y2goamF2YVNjcmlwdEFzc2lnbm1lbnRUYXJnZXQpOwoJICAgICAgICByZXR1cm4gbWF0Y2ggPT09IG51bGwgPyBmYWxzZSA6IG1hdGNoWzFdID8gKCdPYmplY3QoJyArIG1hdGNoWzFdICsgJyknICsgbWF0Y2hbMl0pIDogZXhwcmVzc2lvbjsKCSAgICB9CgoJICAgIC8vIFRoZSBmb2xsb3dpbmcgcmVndWxhciBleHByZXNzaW9ucyB3aWxsIGJlIHVzZWQgdG8gc3BsaXQgYW4gb2JqZWN0LWxpdGVyYWwgc3RyaW5nIGludG8gdG9rZW5zCgoJICAgICAgICAvLyBUaGVzZSB0d28gbWF0Y2ggc3RyaW5ncywgZWl0aGVyIHdpdGggZG91YmxlIHF1b3RlcyBvciBzaW5nbGUgcXVvdGVzCgkgICAgdmFyIHN0cmluZ0RvdWJsZSA9ICciKD86W14iXFxcXF18XFxcXC4pKiInLAoJICAgICAgICBzdHJpbmdTaW5nbGUgPSAiJyg/OlteJ1xcXFxdfFxcXFwuKSonIiwKCSAgICAgICAgLy8gTWF0Y2hlcyBhIHJlZ3VsYXIgZXhwcmVzc2lvbiAodGV4dCBlbmNsb3NlZCBieSBzbGFzaGVzKSwgYnV0IHdpbGwgYWxzbyBtYXRjaCBzZXRzIG9mIGRpdmlzaW9ucwoJICAgICAgICAvLyBhcyBhIHJlZ3VsYXIgZXhwcmVzc2lvbiAodGhpcyBpcyBoYW5kbGVkIGJ5IHRoZSBwYXJzaW5nIGxvb3AgYmVsb3cpLgoJICAgICAgICBzdHJpbmdSZWdleHAgPSAnLyg/OlteL1xcXFxdfFxcXFwuKSovXHcqJywKCSAgICAgICAgLy8gVGhlc2UgY2hhcmFjdGVycyBoYXZlIHNwZWNpYWwgbWVhbmluZyB0byB0aGUgcGFyc2VyIGFuZCBtdXN0IG5vdCBhcHBlYXIgaW4gdGhlIG1pZGRsZSBvZiBhCgkgICAgICAgIC8vIHRva2VuLCBleGNlcHQgYXMgcGFydCBvZiBhIHN0cmluZy4KCSAgICAgICAgc3BlY2lhbHMgPSAnLCJcJ3t9KCkvOltcXF0nLAoJICAgICAgICAvLyBNYXRjaCB0ZXh0IChhdCBsZWFzdCB0d28gY2hhcmFjdGVycykgdGhhdCBkb2VzIG5vdCBjb250YWluIGFueSBvZiB0aGUgYWJvdmUgc3BlY2lhbCBjaGFyYWN0ZXJzLAoJICAgICAgICAvLyBhbHRob3VnaCBzb21lIG9mIHRoZSBzcGVjaWFsIGNoYXJhY3RlcnMgYXJlIGFsbG93ZWQgdG8gc3RhcnQgaXQgKGFsbCBidXQgdGhlIGNvbG9uIGFuZCBjb21tYSkuCgkgICAgICAgIC8vIFRoZSB0ZXh0IGNhbiBjb250YWluIHNwYWNlcywgYnV0IGxlYWRpbmcgb3IgdHJhaWxpbmcgc3BhY2VzIGFyZSBza2lwcGVkLgoJICAgICAgICBldmVyeVRoaW5nRWxzZSA9ICdbXlxcczosL11bXicgKyBzcGVjaWFscyArICddKlteXFxzJyArIHNwZWNpYWxzICsgJ10nLAoJICAgICAgICAvLyBNYXRjaCBhbnkgbm9uLXNwYWNlIGNoYXJhY3RlciBub3QgbWF0Y2hlZCBhbHJlYWR5LiBUaGlzIHdpbGwgbWF0Y2ggY29sb25zIGFuZCBjb21tYXMsIHNpbmNlIHRoZXkncmUKCSAgICAgICAgLy8gbm90IG1hdGNoZWQgYnkgImV2ZXJ5VGhpbmdFbHNlIiwgYnV0IHdpbGwgYWxzbyBtYXRjaCBhbnkgb3RoZXIgc2luZ2xlIGNoYXJhY3RlciB0aGF0IHdhc24ndCBhbHJlYWR5CgkgICAgICAgIC8vIG1hdGNoZWQgKGZvciBleGFtcGxlOiBpbiAiYTogMSwgYjogMiIsIGVhY2ggb2YgdGhlIG5vbi1zcGFjZSBjaGFyYWN0ZXJzIHdpbGwgYmUgbWF0Y2hlZCBieSBvbmVOb3RTcGFjZSkuCgkgICAgICAgIG9uZU5vdFNwYWNlID0gJ1teXFxzXScsCgoJICAgICAgICAvLyBDcmVhdGUgdGhlIGFjdHVhbCByZWd1bGFyIGV4cHJlc3Npb24gYnkgb3ItaW5nIHRoZSBhYm92ZSBzdHJpbmdzLiBUaGUgb3JkZXIgaXMgaW1wb3J0YW50LgoJICAgICAgICBiaW5kaW5nVG9rZW4gPSBSZWdFeHAoc3RyaW5nRG91YmxlICsgJ3wnICsgc3RyaW5nU2luZ2xlICsgJ3wnICsgc3RyaW5nUmVnZXhwICsgJ3wnICsgZXZlcnlUaGluZ0Vsc2UgKyAnfCcgKyBvbmVOb3RTcGFjZSwgJ2cnKSwKCgkgICAgICAgIC8vIE1hdGNoIGVuZCBvZiBwcmV2aW91cyB0b2tlbiB0byBkZXRlcm1pbmUgd2hldGhlciBhIHNsYXNoIGlzIGEgZGl2aXNpb24gb3IgcmVnZXguCgkgICAgICAgIGRpdmlzaW9uTG9va0JlaGluZCA9IC9bXF0pIidBLVphLXowLTlfJF0rJC8sCgkgICAgICAgIGtleXdvcmRSZWdleExvb2tCZWhpbmQgPSB7J2luJzoxLCdyZXR1cm4nOjEsJ3R5cGVvZic6MX07CgoJICAgIGZ1bmN0aW9uIHBhcnNlT2JqZWN0TGl0ZXJhbChvYmplY3RMaXRlcmFsU3RyaW5nKSB7CgkgICAgICAgIC8vIFRyaW0gbGVhZGluZyBhbmQgdHJhaWxpbmcgc3BhY2VzIGZyb20gdGhlIHN0cmluZwoJICAgICAgICB2YXIgc3RyID0ga28udXRpbHMuc3RyaW5nVHJpbShvYmplY3RMaXRlcmFsU3RyaW5nKTsKCgkgICAgICAgIC8vIFRyaW0gYnJhY2VzICd7JyBzdXJyb3VuZGluZyB0aGUgd2hvbGUgb2JqZWN0IGxpdGVyYWwKCSAgICAgICAgaWYgKHN0ci5jaGFyQ29kZUF0KDApID09PSAxMjMpIHN0ciA9IHN0ci5zbGljZSgxLCAtMSk7CgoJICAgICAgICAvLyBTcGxpdCBpbnRvIHRva2VucwoJICAgICAgICB2YXIgcmVzdWx0ID0gW10sIHRva3MgPSBzdHIubWF0Y2goYmluZGluZ1Rva2VuKSwga2V5LCB2YWx1ZXMsIGRlcHRoID0gMDsKCgkgICAgICAgIGlmICh0b2tzKSB7CgkgICAgICAgICAgICAvLyBBcHBlbmQgYSBjb21tYSBzbyB0aGF0IHdlIGRvbid0IG5lZWQgYSBzZXBhcmF0ZSBjb2RlIGJsb2NrIHRvIGRlYWwgd2l0aCB0aGUgbGFzdCBpdGVtCgkgICAgICAgICAgICB0b2tzLnB1c2goJywnKTsKCgkgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgdG9rOyB0b2sgPSB0b2tzW2ldOyArK2kpIHsKCSAgICAgICAgICAgICAgICB2YXIgYyA9IHRvay5jaGFyQ29kZUF0KDApOwoJICAgICAgICAgICAgICAgIC8vIEEgY29tbWEgc2lnbmFscyB0aGUgZW5kIG9mIGEga2V5L3ZhbHVlIHBhaXIgaWYgZGVwdGggaXMgemVybwoJICAgICAgICAgICAgICAgIGlmIChjID09PSA0NCkgeyAvLyAiLCIKCSAgICAgICAgICAgICAgICAgICAgaWYgKGRlcHRoIDw9IDApIHsKCSAgICAgICAgICAgICAgICAgICAgICAgIGlmIChrZXkpCgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0LnB1c2godmFsdWVzID8ge2tleToga2V5LCB2YWx1ZTogdmFsdWVzLmpvaW4oJycpfSA6IHsndW5rbm93bic6IGtleX0pOwoJICAgICAgICAgICAgICAgICAgICAgICAga2V5ID0gdmFsdWVzID0gZGVwdGggPSAwOwoJICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7CgkgICAgICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICAvLyBTaW1wbHkgc2tpcCB0aGUgY29sb24gdGhhdCBzZXBhcmF0ZXMgdGhlIG5hbWUgYW5kIHZhbHVlCgkgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChjID09PSA1OCkgeyAvLyAiOiIKCSAgICAgICAgICAgICAgICAgICAgaWYgKCF2YWx1ZXMpCgkgICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKCSAgICAgICAgICAgICAgICAvLyBBIHNldCBvZiBzbGFzaGVzIGlzIGluaXRpYWxseSBtYXRjaGVkIGFzIGEgcmVndWxhciBleHByZXNzaW9uLCBidXQgY291bGQgYmUgZGl2aXNpb24KCSAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGMgPT09IDQ3ICYmIGkgJiYgdG9rLmxlbmd0aCA+IDEpIHsgIC8vICIvIgoJICAgICAgICAgICAgICAgICAgICAvLyBMb29rIGF0IHRoZSBlbmQgb2YgdGhlIHByZXZpb3VzIHRva2VuIHRvIGRldGVybWluZSBpZiB0aGUgc2xhc2ggaXMgYWN0dWFsbHkgZGl2aXNpb24KCSAgICAgICAgICAgICAgICAgICAgdmFyIG1hdGNoID0gdG9rc1tpLTFdLm1hdGNoKGRpdmlzaW9uTG9va0JlaGluZCk7CgkgICAgICAgICAgICAgICAgICAgIGlmIChtYXRjaCAmJiAha2V5d29yZFJlZ2V4TG9va0JlaGluZFttYXRjaFswXV0pIHsKCSAgICAgICAgICAgICAgICAgICAgICAgIC8vIFRoZSBzbGFzaCBpcyBhY3R1YWxseSBhIGRpdmlzaW9uIHB1bmN0dWF0b3I7IHJlLXBhcnNlIHRoZSByZW1haW5kZXIgb2YgdGhlIHN0cmluZyAobm90IGluY2x1ZGluZyB0aGUgc2xhc2gpCgkgICAgICAgICAgICAgICAgICAgICAgICBzdHIgPSBzdHIuc3Vic3RyKHN0ci5pbmRleE9mKHRvaykgKyAxKTsKCSAgICAgICAgICAgICAgICAgICAgICAgIHRva3MgPSBzdHIubWF0Y2goYmluZGluZ1Rva2VuKTsKCSAgICAgICAgICAgICAgICAgICAgICAgIHRva3MucHVzaCgnLCcpOwoJICAgICAgICAgICAgICAgICAgICAgICAgaSA9IC0xOwoJICAgICAgICAgICAgICAgICAgICAgICAgLy8gQ29udGludWUgd2l0aCBqdXN0IHRoZSBzbGFzaAoJICAgICAgICAgICAgICAgICAgICAgICAgdG9rID0gJy8nOwoJICAgICAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgLy8gSW5jcmVtZW50IGRlcHRoIGZvciBwYXJlbnRoZXNlcywgYnJhY2VzLCBhbmQgYnJhY2tldHMgc28gdGhhdCBpbnRlcmlvciBjb21tYXMgYXJlIGlnbm9yZWQKCSAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGMgPT09IDQwIHx8IGMgPT09IDEyMyB8fCBjID09PSA5MSkgeyAvLyAnKCcsICd7JywgJ1snCgkgICAgICAgICAgICAgICAgICAgICsrZGVwdGg7CgkgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChjID09PSA0MSB8fCBjID09PSAxMjUgfHwgYyA9PT0gOTMpIHsgLy8gJyknLCAnfScsICddJwoJICAgICAgICAgICAgICAgICAgICAtLWRlcHRoOwoJICAgICAgICAgICAgICAgIC8vIFRoZSBrZXkgbXVzdCBiZSBhIHNpbmdsZSB0b2tlbjsgaWYgaXQncyBhIHN0cmluZywgdHJpbSB0aGUgcXVvdGVzCgkgICAgICAgICAgICAgICAgfSBlbHNlIGlmICgha2V5ICYmICF2YWx1ZXMpIHsKCSAgICAgICAgICAgICAgICAgICAga2V5ID0gKGMgPT09IDM0IHx8IGMgPT09IDM5KSAvKiAnIicsICInIiAqLyA/IHRvay5zbGljZSgxLCAtMSkgOiB0b2s7CgkgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICBpZiAodmFsdWVzKQoJICAgICAgICAgICAgICAgICAgICB2YWx1ZXMucHVzaCh0b2spOwoJICAgICAgICAgICAgICAgIGVsc2UKCSAgICAgICAgICAgICAgICAgICAgdmFsdWVzID0gW3Rva107CgkgICAgICAgICAgICB9CgkgICAgICAgIH0KCSAgICAgICAgcmV0dXJuIHJlc3VsdDsKCSAgICB9CgoJICAgIC8vIFR3by13YXkgYmluZGluZ3MgaW5jbHVkZSBhIHdyaXRlIGZ1bmN0aW9uIHRoYXQgYWxsb3cgdGhlIGhhbmRsZXIgdG8gdXBkYXRlIHRoZSB2YWx1ZSBldmVuIGlmIGl0J3Mgbm90IGFuIG9ic2VydmFibGUuCgkgICAgdmFyIHR3b1dheUJpbmRpbmdzID0ge307CgoJICAgIGZ1bmN0aW9uIHByZVByb2Nlc3NCaW5kaW5ncyhiaW5kaW5nc1N0cmluZ09yS2V5VmFsdWVBcnJheSwgYmluZGluZ09wdGlvbnMpIHsKCSAgICAgICAgYmluZGluZ09wdGlvbnMgPSBiaW5kaW5nT3B0aW9ucyB8fCB7fTsKCgkgICAgICAgIGZ1bmN0aW9uIHByb2Nlc3NLZXlWYWx1ZShrZXksIHZhbCkgewoJICAgICAgICAgICAgdmFyIHdyaXRhYmxlVmFsOwoJICAgICAgICAgICAgZnVuY3Rpb24gY2FsbFByZXByb2Nlc3NIb29rKG9iaikgewoJICAgICAgICAgICAgICAgIHJldHVybiAob2JqICYmIG9ialsncHJlcHJvY2VzcyddKSA/ICh2YWwgPSBvYmpbJ3ByZXByb2Nlc3MnXSh2YWwsIGtleSwgcHJvY2Vzc0tleVZhbHVlKSkgOiB0cnVlOwoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgaWYgKCFiaW5kaW5nUGFyYW1zKSB7CgkgICAgICAgICAgICAgICAgaWYgKCFjYWxsUHJlcHJvY2Vzc0hvb2soa29bJ2dldEJpbmRpbmdIYW5kbGVyJ10oa2V5KSkpCgkgICAgICAgICAgICAgICAgICAgIHJldHVybjsKCgkgICAgICAgICAgICAgICAgaWYgKHR3b1dheUJpbmRpbmdzW2tleV0gJiYgKHdyaXRhYmxlVmFsID0gZ2V0V3JpdGVhYmxlVmFsdWUodmFsKSkpIHsKCSAgICAgICAgICAgICAgICAgICAgLy8gRm9yIHR3by13YXkgYmluZGluZ3MsIHByb3ZpZGUgYSB3cml0ZSBtZXRob2QgaW4gY2FzZSB0aGUgdmFsdWUKCSAgICAgICAgICAgICAgICAgICAgLy8gaXNuJ3QgYSB3cml0YWJsZSBvYnNlcnZhYmxlLgoJICAgICAgICAgICAgICAgICAgICBwcm9wZXJ0eUFjY2Vzc29yUmVzdWx0U3RyaW5ncy5wdXNoKCInIiArIGtleSArICInOmZ1bmN0aW9uKF96KXsiICsgd3JpdGFibGVWYWwgKyAiPV96fSIpOwoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIC8vIFZhbHVlcyBhcmUgd3JhcHBlZCBpbiBhIGZ1bmN0aW9uIHNvIHRoYXQgZWFjaCB2YWx1ZSBjYW4gYmUgYWNjZXNzZWQgaW5kZXBlbmRlbnRseQoJICAgICAgICAgICAgaWYgKG1ha2VWYWx1ZUFjY2Vzc29ycykgewoJICAgICAgICAgICAgICAgIHZhbCA9ICdmdW5jdGlvbigpe3JldHVybiAnICsgdmFsICsgJyB9JzsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIHJlc3VsdFN0cmluZ3MucHVzaCgiJyIgKyBrZXkgKyAiJzoiICsgdmFsKTsKCSAgICAgICAgfQoKCSAgICAgICAgdmFyIHJlc3VsdFN0cmluZ3MgPSBbXSwKCSAgICAgICAgICAgIHByb3BlcnR5QWNjZXNzb3JSZXN1bHRTdHJpbmdzID0gW10sCgkgICAgICAgICAgICBtYWtlVmFsdWVBY2Nlc3NvcnMgPSBiaW5kaW5nT3B0aW9uc1sndmFsdWVBY2Nlc3NvcnMnXSwKCSAgICAgICAgICAgIGJpbmRpbmdQYXJhbXMgPSBiaW5kaW5nT3B0aW9uc1snYmluZGluZ1BhcmFtcyddLAoJICAgICAgICAgICAga2V5VmFsdWVBcnJheSA9IHR5cGVvZiBiaW5kaW5nc1N0cmluZ09yS2V5VmFsdWVBcnJheSA9PT0gInN0cmluZyIgPwoJICAgICAgICAgICAgICAgIHBhcnNlT2JqZWN0TGl0ZXJhbChiaW5kaW5nc1N0cmluZ09yS2V5VmFsdWVBcnJheSkgOiBiaW5kaW5nc1N0cmluZ09yS2V5VmFsdWVBcnJheTsKCgkgICAgICAgIGtvLnV0aWxzLmFycmF5Rm9yRWFjaChrZXlWYWx1ZUFycmF5LCBmdW5jdGlvbihrZXlWYWx1ZSkgewoJICAgICAgICAgICAgcHJvY2Vzc0tleVZhbHVlKGtleVZhbHVlLmtleSB8fCBrZXlWYWx1ZVsndW5rbm93biddLCBrZXlWYWx1ZS52YWx1ZSk7CgkgICAgICAgIH0pOwoKCSAgICAgICAgaWYgKHByb3BlcnR5QWNjZXNzb3JSZXN1bHRTdHJpbmdzLmxlbmd0aCkKCSAgICAgICAgICAgIHByb2Nlc3NLZXlWYWx1ZSgnX2tvX3Byb3BlcnR5X3dyaXRlcnMnLCAieyIgKyBwcm9wZXJ0eUFjY2Vzc29yUmVzdWx0U3RyaW5ncy5qb2luKCIsIikgKyAiIH0iKTsKCgkgICAgICAgIHJldHVybiByZXN1bHRTdHJpbmdzLmpvaW4oIiwiKTsKCSAgICB9CgoJICAgIHJldHVybiB7CgkgICAgICAgIGJpbmRpbmdSZXdyaXRlVmFsaWRhdG9yczogW10sCgoJICAgICAgICB0d29XYXlCaW5kaW5nczogdHdvV2F5QmluZGluZ3MsCgoJICAgICAgICBwYXJzZU9iamVjdExpdGVyYWw6IHBhcnNlT2JqZWN0TGl0ZXJhbCwKCgkgICAgICAgIHByZVByb2Nlc3NCaW5kaW5nczogcHJlUHJvY2Vzc0JpbmRpbmdzLAoKCSAgICAgICAga2V5VmFsdWVBcnJheUNvbnRhaW5zS2V5OiBmdW5jdGlvbihrZXlWYWx1ZUFycmF5LCBrZXkpIHsKCSAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwga2V5VmFsdWVBcnJheS5sZW5ndGg7IGkrKykKCSAgICAgICAgICAgICAgICBpZiAoa2V5VmFsdWVBcnJheVtpXVsna2V5J10gPT0ga2V5KQoJICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKCSAgICAgICAgICAgIHJldHVybiBmYWxzZTsKCSAgICAgICAgfSwKCgkgICAgICAgIC8vIEludGVybmFsLCBwcml2YXRlIEtPIHV0aWxpdHkgZm9yIHVwZGF0aW5nIG1vZGVsIHByb3BlcnRpZXMgZnJvbSB3aXRoaW4gYmluZGluZ3MKCSAgICAgICAgLy8gcHJvcGVydHk6ICAgICAgICAgICAgSWYgdGhlIHByb3BlcnR5IGJlaW5nIHVwZGF0ZWQgaXMgKG9yIG1pZ2h0IGJlKSBhbiBvYnNlcnZhYmxlLCBwYXNzIGl0IGhlcmUKCSAgICAgICAgLy8gICAgICAgICAgICAgICAgICAgICAgSWYgaXQgdHVybnMgb3V0IHRvIGJlIGEgd3JpdGFibGUgb2JzZXJ2YWJsZSwgaXQgd2lsbCBiZSB3cml0dGVuIHRvIGRpcmVjdGx5CgkgICAgICAgIC8vIGFsbEJpbmRpbmdzOiAgICAgICAgIEFuIG9iamVjdCB3aXRoIGEgZ2V0IG1ldGhvZCB0byByZXRyaWV2ZSBiaW5kaW5ncyBpbiB0aGUgY3VycmVudCBleGVjdXRpb24gY29udGV4dC4KCSAgICAgICAgLy8gICAgICAgICAgICAgICAgICAgICAgVGhpcyB3aWxsIGJlIHNlYXJjaGVkIGZvciBhICdfa29fcHJvcGVydHlfd3JpdGVycycgcHJvcGVydHkgaW4gY2FzZSB5b3UncmUgd3JpdGluZyB0byBhIG5vbi1vYnNlcnZhYmxlCgkgICAgICAgIC8vIGtleTogICAgICAgICAgICAgICAgIFRoZSBrZXkgaWRlbnRpZnlpbmcgdGhlIHByb3BlcnR5IHRvIGJlIHdyaXR0ZW4uIEV4YW1wbGU6IGZvciB7IGhhc0ZvY3VzOiBteVZhbHVlIH0sIHdyaXRlIHRvICdteVZhbHVlJyBieSBzcGVjaWZ5aW5nIHRoZSBrZXkgJ2hhc0ZvY3VzJwoJICAgICAgICAvLyB2YWx1ZTogICAgICAgICAgICAgICBUaGUgdmFsdWUgdG8gYmUgd3JpdHRlbgoJICAgICAgICAvLyBjaGVja0lmRGlmZmVyZW50OiAgICBJZiB0cnVlLCBhbmQgaWYgdGhlIHByb3BlcnR5IGJlaW5nIHdyaXR0ZW4gaXMgYSB3cml0YWJsZSBvYnNlcnZhYmxlLCB0aGUgdmFsdWUgd2lsbCBvbmx5IGJlIHdyaXR0ZW4gaWYKCSAgICAgICAgLy8gICAgICAgICAgICAgICAgICAgICAgaXQgaXMgIT09IGV4aXN0aW5nIHZhbHVlIG9uIHRoYXQgd3JpdGFibGUgb2JzZXJ2YWJsZQoJICAgICAgICB3cml0ZVZhbHVlVG9Qcm9wZXJ0eTogZnVuY3Rpb24ocHJvcGVydHksIGFsbEJpbmRpbmdzLCBrZXksIHZhbHVlLCBjaGVja0lmRGlmZmVyZW50KSB7CgkgICAgICAgICAgICBpZiAoIXByb3BlcnR5IHx8ICFrby5pc09ic2VydmFibGUocHJvcGVydHkpKSB7CgkgICAgICAgICAgICAgICAgdmFyIHByb3BXcml0ZXJzID0gYWxsQmluZGluZ3MuZ2V0KCdfa29fcHJvcGVydHlfd3JpdGVycycpOwoJICAgICAgICAgICAgICAgIGlmIChwcm9wV3JpdGVycyAmJiBwcm9wV3JpdGVyc1trZXldKQoJICAgICAgICAgICAgICAgICAgICBwcm9wV3JpdGVyc1trZXldKHZhbHVlKTsKCSAgICAgICAgICAgIH0gZWxzZSBpZiAoa28uaXNXcml0ZWFibGVPYnNlcnZhYmxlKHByb3BlcnR5KSAmJiAoIWNoZWNrSWZEaWZmZXJlbnQgfHwgcHJvcGVydHkucGVlaygpICE9PSB2YWx1ZSkpIHsKCSAgICAgICAgICAgICAgICBwcm9wZXJ0eSh2YWx1ZSk7CgkgICAgICAgICAgICB9CgkgICAgICAgIH0KCSAgICB9OwoJfSkoKTsKCglrby5leHBvcnRTeW1ib2woJ2V4cHJlc3Npb25SZXdyaXRpbmcnLCBrby5leHByZXNzaW9uUmV3cml0aW5nKTsKCWtvLmV4cG9ydFN5bWJvbCgnZXhwcmVzc2lvblJld3JpdGluZy5iaW5kaW5nUmV3cml0ZVZhbGlkYXRvcnMnLCBrby5leHByZXNzaW9uUmV3cml0aW5nLmJpbmRpbmdSZXdyaXRlVmFsaWRhdG9ycyk7Cglrby5leHBvcnRTeW1ib2woJ2V4cHJlc3Npb25SZXdyaXRpbmcucGFyc2VPYmplY3RMaXRlcmFsJywga28uZXhwcmVzc2lvblJld3JpdGluZy5wYXJzZU9iamVjdExpdGVyYWwpOwoJa28uZXhwb3J0U3ltYm9sKCdleHByZXNzaW9uUmV3cml0aW5nLnByZVByb2Nlc3NCaW5kaW5ncycsIGtvLmV4cHJlc3Npb25SZXdyaXRpbmcucHJlUHJvY2Vzc0JpbmRpbmdzKTsKCgkvLyBNYWtpbmcgYmluZGluZ3MgZXhwbGljaXRseSBkZWNsYXJlIHRoZW1zZWx2ZXMgYXMgInR3byB3YXkiIGlzbid0IGlkZWFsIGluIHRoZSBsb25nIHRlcm0gKGl0IHdvdWxkIGJlIGJldHRlciBpZgoJLy8gYWxsIGJpbmRpbmdzIGNvdWxkIHVzZSBhbiBvZmZpY2lhbCAncHJvcGVydHkgd3JpdGVyJyBBUEkgd2l0aG91dCBuZWVkaW5nIHRvIGRlY2xhcmUgdGhhdCB0aGV5IG1pZ2h0KS4gSG93ZXZlciwKCS8vIHNpbmNlIHRoaXMgaXMgbm90LCBhbmQgaGFzIG5ldmVyIGJlZW4sIGEgcHVibGljIEFQSSAoX2tvX3Byb3BlcnR5X3dyaXRlcnMgd2FzIG5ldmVyIGRvY3VtZW50ZWQpLCBpdCdzIGFjY2VwdGFibGUKCS8vIGFzIGFuIGludGVybmFsIGltcGxlbWVudGF0aW9uIGRldGFpbCBpbiB0aGUgc2hvcnQgdGVybS4KCS8vIEZvciB0aG9zZSBkZXZlbG9wZXJzIHdobyByZWx5IG9uIF9rb19wcm9wZXJ0eV93cml0ZXJzIGluIHRoZWlyIGN1c3RvbSBiaW5kaW5ncywgd2UgZXhwb3NlIF90d29XYXlCaW5kaW5ncyBhcyBhbgoJLy8gdW5kb2N1bWVudGVkIGZlYXR1cmUgdGhhdCBtYWtlcyBpdCByZWxhdGl2ZWx5IGVhc3kgdG8gdXBncmFkZSB0byBLTyAzLjAuIEhvd2V2ZXIsIHRoaXMgaXMgc3RpbGwgbm90IGFuIG9mZmljaWFsCgkvLyBwdWJsaWMgQVBJLCBhbmQgd2UgcmVzZXJ2ZSB0aGUgcmlnaHQgdG8gcmVtb3ZlIGl0IGF0IGFueSB0aW1lIGlmIHdlIGNyZWF0ZSBhIHJlYWwgcHVibGljIHByb3BlcnR5IHdyaXRlcnMgQVBJLgoJa28uZXhwb3J0U3ltYm9sKCdleHByZXNzaW9uUmV3cml0aW5nLl90d29XYXlCaW5kaW5ncycsIGtvLmV4cHJlc3Npb25SZXdyaXRpbmcudHdvV2F5QmluZGluZ3MpOwoKCS8vIEZvciBiYWNrd2FyZCBjb21wYXRpYmlsaXR5LCBkZWZpbmUgdGhlIGZvbGxvd2luZyBhbGlhc2VzLiAoUHJldmlvdXNseSwgdGhlc2UgZnVuY3Rpb24gbmFtZXMgd2VyZSBtaXNsZWFkaW5nIGJlY2F1c2UKCS8vIHRoZXkgcmVmZXJyZWQgdG8gSlNPTiBzcGVjaWZpY2FsbHksIGV2ZW4gdGhvdWdoIHRoZXkgYWN0dWFsbHkgd29yayB3aXRoIGFyYml0cmFyeSBKYXZhU2NyaXB0IG9iamVjdCBsaXRlcmFsIGV4cHJlc3Npb25zLikKCWtvLmV4cG9ydFN5bWJvbCgnanNvbkV4cHJlc3Npb25SZXdyaXRpbmcnLCBrby5leHByZXNzaW9uUmV3cml0aW5nKTsKCWtvLmV4cG9ydFN5bWJvbCgnanNvbkV4cHJlc3Npb25SZXdyaXRpbmcuaW5zZXJ0UHJvcGVydHlBY2Nlc3NvcnNJbnRvSnNvbicsIGtvLmV4cHJlc3Npb25SZXdyaXRpbmcucHJlUHJvY2Vzc0JpbmRpbmdzKTsKCShmdW5jdGlvbigpIHsKCSAgICAvLyAiVmlydHVhbCBlbGVtZW50cyIgaXMgYW4gYWJzdHJhY3Rpb24gb24gdG9wIG9mIHRoZSB1c3VhbCBET00gQVBJIHdoaWNoIHVuZGVyc3RhbmRzIHRoZSBub3Rpb24gdGhhdCBjb21tZW50IG5vZGVzCgkgICAgLy8gbWF5IGJlIHVzZWQgdG8gcmVwcmVzZW50IGhpZXJhcmNoeSAoaW4gYWRkaXRpb24gdG8gdGhlIERPTSdzIG5hdHVyYWwgaGllcmFyY2h5KS4KCSAgICAvLyBJZiB5b3UgY2FsbCB0aGUgRE9NLW1hbmlwdWxhdGluZyBmdW5jdGlvbnMgb24ga28udmlydHVhbEVsZW1lbnRzLCB5b3Ugd2lsbCBiZSBhYmxlIHRvIHJlYWQgYW5kIHdyaXRlIHRoZSBzdGF0ZQoJICAgIC8vIG9mIHRoYXQgdmlydHVhbCBoaWVyYXJjaHkKCSAgICAvLwoJICAgIC8vIFRoZSBwb2ludCBvZiBhbGwgdGhpcyBpcyB0byBzdXBwb3J0IGNvbnRhaW5lcmxlc3MgdGVtcGxhdGVzIChlLmcuLCA8IS0tIGtvIGZvcmVhY2g6c29tZUNvbGxlY3Rpb24gLS0+YmxhaDwhLS0gL2tvIC0tPikKCSAgICAvLyB3aXRob3V0IGhhdmluZyB0byBzY2F0dGVyIHNwZWNpYWwgY2FzZXMgYWxsIG92ZXIgdGhlIGJpbmRpbmcgYW5kIHRlbXBsYXRpbmcgY29kZS4KCgkgICAgLy8gSUUgOSBjYW5ub3QgcmVsaWFibHkgcmVhZCB0aGUgIm5vZGVWYWx1ZSIgcHJvcGVydHkgb2YgYSBjb21tZW50IG5vZGUgKHNlZSBodHRwczovL2dpdGh1Yi5jb20vU3RldmVTYW5kZXJzb24va25vY2tvdXQvaXNzdWVzLzE4NikKCSAgICAvLyBidXQgaXQgZG9lcyBnaXZlIHRoZW0gYSBub25zdGFuZGFyZCBhbHRlcm5hdGl2ZSBwcm9wZXJ0eSBjYWxsZWQgInRleHQiIHRoYXQgaXQgY2FuIHJlYWQgcmVsaWFibHkuIE90aGVyIGJyb3dzZXJzIGRvbid0IGhhdmUgdGhhdCBwcm9wZXJ0eS4KCSAgICAvLyBTbywgdXNlIG5vZGUudGV4dCB3aGVyZSBhdmFpbGFibGUsIGFuZCBub2RlLm5vZGVWYWx1ZSBlbHNld2hlcmUKCSAgICB2YXIgY29tbWVudE5vZGVzSGF2ZVRleHRQcm9wZXJ0eSA9IGRvY3VtZW50ICYmIGRvY3VtZW50LmNyZWF0ZUNvbW1lbnQoInRlc3QiKS50ZXh0ID09PSAiPCEtLXRlc3QtLT4iOwoKCSAgICB2YXIgc3RhcnRDb21tZW50UmVnZXggPSBjb21tZW50Tm9kZXNIYXZlVGV4dFByb3BlcnR5ID8gL148IS0tXHMqa28oPzpccysoW1xzXFNdKykpP1xzKi0tPiQvIDogL15ccyprbyg/OlxzKyhbXHNcU10rKSk/XHMqJC87CgkgICAgdmFyIGVuZENvbW1lbnRSZWdleCA9ICAgY29tbWVudE5vZGVzSGF2ZVRleHRQcm9wZXJ0eSA/IC9ePCEtLVxzKlwva29ccyotLT4kLyA6IC9eXHMqXC9rb1xzKiQvOwoJICAgIHZhciBodG1sVGFnc1dpdGhPcHRpb25hbGx5Q2xvc2luZ0NoaWxkcmVuID0geyAndWwnOiB0cnVlLCAnb2wnOiB0cnVlIH07CgoJICAgIGZ1bmN0aW9uIGlzU3RhcnRDb21tZW50KG5vZGUpIHsKCSAgICAgICAgcmV0dXJuIChub2RlLm5vZGVUeXBlID09IDgpICYmIHN0YXJ0Q29tbWVudFJlZ2V4LnRlc3QoY29tbWVudE5vZGVzSGF2ZVRleHRQcm9wZXJ0eSA/IG5vZGUudGV4dCA6IG5vZGUubm9kZVZhbHVlKTsKCSAgICB9CgoJICAgIGZ1bmN0aW9uIGlzRW5kQ29tbWVudChub2RlKSB7CgkgICAgICAgIHJldHVybiAobm9kZS5ub2RlVHlwZSA9PSA4KSAmJiBlbmRDb21tZW50UmVnZXgudGVzdChjb21tZW50Tm9kZXNIYXZlVGV4dFByb3BlcnR5ID8gbm9kZS50ZXh0IDogbm9kZS5ub2RlVmFsdWUpOwoJICAgIH0KCgkgICAgZnVuY3Rpb24gZ2V0VmlydHVhbENoaWxkcmVuKHN0YXJ0Q29tbWVudCwgYWxsb3dVbmJhbGFuY2VkKSB7CgkgICAgICAgIHZhciBjdXJyZW50Tm9kZSA9IHN0YXJ0Q29tbWVudDsKCSAgICAgICAgdmFyIGRlcHRoID0gMTsKCSAgICAgICAgdmFyIGNoaWxkcmVuID0gW107CgkgICAgICAgIHdoaWxlIChjdXJyZW50Tm9kZSA9IGN1cnJlbnROb2RlLm5leHRTaWJsaW5nKSB7CgkgICAgICAgICAgICBpZiAoaXNFbmRDb21tZW50KGN1cnJlbnROb2RlKSkgewoJICAgICAgICAgICAgICAgIGRlcHRoLS07CgkgICAgICAgICAgICAgICAgaWYgKGRlcHRoID09PSAwKQoJICAgICAgICAgICAgICAgICAgICByZXR1cm4gY2hpbGRyZW47CgkgICAgICAgICAgICB9CgoJICAgICAgICAgICAgY2hpbGRyZW4ucHVzaChjdXJyZW50Tm9kZSk7CgoJICAgICAgICAgICAgaWYgKGlzU3RhcnRDb21tZW50KGN1cnJlbnROb2RlKSkKCSAgICAgICAgICAgICAgICBkZXB0aCsrOwoJICAgICAgICB9CgkgICAgICAgIGlmICghYWxsb3dVbmJhbGFuY2VkKQoJICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJDYW5ub3QgZmluZCBjbG9zaW5nIGNvbW1lbnQgdGFnIHRvIG1hdGNoOiAiICsgc3RhcnRDb21tZW50Lm5vZGVWYWx1ZSk7CgkgICAgICAgIHJldHVybiBudWxsOwoJICAgIH0KCgkgICAgZnVuY3Rpb24gZ2V0TWF0Y2hpbmdFbmRDb21tZW50KHN0YXJ0Q29tbWVudCwgYWxsb3dVbmJhbGFuY2VkKSB7CgkgICAgICAgIHZhciBhbGxWaXJ0dWFsQ2hpbGRyZW4gPSBnZXRWaXJ0dWFsQ2hpbGRyZW4oc3RhcnRDb21tZW50LCBhbGxvd1VuYmFsYW5jZWQpOwoJICAgICAgICBpZiAoYWxsVmlydHVhbENoaWxkcmVuKSB7CgkgICAgICAgICAgICBpZiAoYWxsVmlydHVhbENoaWxkcmVuLmxlbmd0aCA+IDApCgkgICAgICAgICAgICAgICAgcmV0dXJuIGFsbFZpcnR1YWxDaGlsZHJlblthbGxWaXJ0dWFsQ2hpbGRyZW4ubGVuZ3RoIC0gMV0ubmV4dFNpYmxpbmc7CgkgICAgICAgICAgICByZXR1cm4gc3RhcnRDb21tZW50Lm5leHRTaWJsaW5nOwoJICAgICAgICB9IGVsc2UKCSAgICAgICAgICAgIHJldHVybiBudWxsOyAvLyBNdXN0IGhhdmUgbm8gbWF0Y2hpbmcgZW5kIGNvbW1lbnQsIGFuZCBhbGxvd1VuYmFsYW5jZWQgaXMgdHJ1ZQoJICAgIH0KCgkgICAgZnVuY3Rpb24gZ2V0VW5iYWxhbmNlZENoaWxkVGFncyhub2RlKSB7CgkgICAgICAgIC8vIGUuZy4sIGZyb20gPGRpdj5PSzwvZGl2PjwhLS0ga28gYmxhaCAtLT48c3Bhbj5Bbm90aGVyPC9zcGFuPiwgcmV0dXJuczogPCEtLSBrbyBibGFoIC0tPjxzcGFuPkFub3RoZXI8L3NwYW4+CgkgICAgICAgIC8vICAgICAgIGZyb20gPGRpdj5PSzwvZGl2PjwhLS0gL2tvIC0tPjwhLS0gL2tvIC0tPiwgICAgICAgICAgICAgcmV0dXJuczogPCEtLSAva28gLS0+PCEtLSAva28gLS0+CgkgICAgICAgIHZhciBjaGlsZE5vZGUgPSBub2RlLmZpcnN0Q2hpbGQsIGNhcHR1cmVSZW1haW5pbmcgPSBudWxsOwoJICAgICAgICBpZiAoY2hpbGROb2RlKSB7CgkgICAgICAgICAgICBkbyB7CgkgICAgICAgICAgICAgICAgaWYgKGNhcHR1cmVSZW1haW5pbmcpICAgICAgICAgICAgICAgICAgIC8vIFdlIGFscmVhZHkgaGl0IGFuIHVuYmFsYW5jZWQgbm9kZSBhbmQgYXJlIG5vdyBqdXN0IHNjb29waW5nIHVwIGFsbCBzdWJzZXF1ZW50IG5vZGVzCgkgICAgICAgICAgICAgICAgICAgIGNhcHR1cmVSZW1haW5pbmcucHVzaChjaGlsZE5vZGUpOwoJICAgICAgICAgICAgICAgIGVsc2UgaWYgKGlzU3RhcnRDb21tZW50KGNoaWxkTm9kZSkpIHsKCSAgICAgICAgICAgICAgICAgICAgdmFyIG1hdGNoaW5nRW5kQ29tbWVudCA9IGdldE1hdGNoaW5nRW5kQ29tbWVudChjaGlsZE5vZGUsIC8qIGFsbG93VW5iYWxhbmNlZDogKi8gdHJ1ZSk7CgkgICAgICAgICAgICAgICAgICAgIGlmIChtYXRjaGluZ0VuZENvbW1lbnQpICAgICAgICAgICAgIC8vIEl0J3MgYSBiYWxhbmNlZCB0YWcsIHNvIHNraXAgaW1tZWRpYXRlbHkgdG8gdGhlIGVuZCBvZiB0aGlzIHZpcnR1YWwgc2V0CgkgICAgICAgICAgICAgICAgICAgICAgICBjaGlsZE5vZGUgPSBtYXRjaGluZ0VuZENvbW1lbnQ7CgkgICAgICAgICAgICAgICAgICAgIGVsc2UKCSAgICAgICAgICAgICAgICAgICAgICAgIGNhcHR1cmVSZW1haW5pbmcgPSBbY2hpbGROb2RlXTsgLy8gSXQncyB1bmJhbGFuY2VkLCBzbyBzdGFydCBjYXB0dXJpbmcgZnJvbSB0aGlzIHBvaW50CgkgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChpc0VuZENvbW1lbnQoY2hpbGROb2RlKSkgewoJICAgICAgICAgICAgICAgICAgICBjYXB0dXJlUmVtYWluaW5nID0gW2NoaWxkTm9kZV07ICAgICAvLyBJdCdzIHVuYmFsYW5jZWQgKGlmIGl0IHdhc24ndCwgd2UnZCBoYXZlIHNraXBwZWQgb3ZlciBpdCBhbHJlYWR5KSwgc28gc3RhcnQgY2FwdHVyaW5nCgkgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgfSB3aGlsZSAoY2hpbGROb2RlID0gY2hpbGROb2RlLm5leHRTaWJsaW5nKTsKCSAgICAgICAgfQoJICAgICAgICByZXR1cm4gY2FwdHVyZVJlbWFpbmluZzsKCSAgICB9CgoJICAgIGtvLnZpcnR1YWxFbGVtZW50cyA9IHsKCSAgICAgICAgYWxsb3dlZEJpbmRpbmdzOiB7fSwKCgkgICAgICAgIGNoaWxkTm9kZXM6IGZ1bmN0aW9uKG5vZGUpIHsKCSAgICAgICAgICAgIHJldHVybiBpc1N0YXJ0Q29tbWVudChub2RlKSA/IGdldFZpcnR1YWxDaGlsZHJlbihub2RlKSA6IG5vZGUuY2hpbGROb2RlczsKCSAgICAgICAgfSwKCgkgICAgICAgIGVtcHR5Tm9kZTogZnVuY3Rpb24obm9kZSkgewoJICAgICAgICAgICAgaWYgKCFpc1N0YXJ0Q29tbWVudChub2RlKSkKCSAgICAgICAgICAgICAgICBrby51dGlscy5lbXB0eURvbU5vZGUobm9kZSk7CgkgICAgICAgICAgICBlbHNlIHsKCSAgICAgICAgICAgICAgICB2YXIgdmlydHVhbENoaWxkcmVuID0ga28udmlydHVhbEVsZW1lbnRzLmNoaWxkTm9kZXMobm9kZSk7CgkgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGogPSB2aXJ0dWFsQ2hpbGRyZW4ubGVuZ3RoOyBpIDwgajsgaSsrKQoJICAgICAgICAgICAgICAgICAgICBrby5yZW1vdmVOb2RlKHZpcnR1YWxDaGlsZHJlbltpXSk7CgkgICAgICAgICAgICB9CgkgICAgICAgIH0sCgoJICAgICAgICBzZXREb21Ob2RlQ2hpbGRyZW46IGZ1bmN0aW9uKG5vZGUsIGNoaWxkTm9kZXMpIHsKCSAgICAgICAgICAgIGlmICghaXNTdGFydENvbW1lbnQobm9kZSkpCgkgICAgICAgICAgICAgICAga28udXRpbHMuc2V0RG9tTm9kZUNoaWxkcmVuKG5vZGUsIGNoaWxkTm9kZXMpOwoJICAgICAgICAgICAgZWxzZSB7CgkgICAgICAgICAgICAgICAga28udmlydHVhbEVsZW1lbnRzLmVtcHR5Tm9kZShub2RlKTsKCSAgICAgICAgICAgICAgICB2YXIgZW5kQ29tbWVudE5vZGUgPSBub2RlLm5leHRTaWJsaW5nOyAvLyBNdXN0IGJlIHRoZSBuZXh0IHNpYmxpbmcsIGFzIHdlIGp1c3QgZW1wdGllZCB0aGUgY2hpbGRyZW4KCSAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaiA9IGNoaWxkTm9kZXMubGVuZ3RoOyBpIDwgajsgaSsrKQoJICAgICAgICAgICAgICAgICAgICBlbmRDb21tZW50Tm9kZS5wYXJlbnROb2RlLmluc2VydEJlZm9yZShjaGlsZE5vZGVzW2ldLCBlbmRDb21tZW50Tm9kZSk7CgkgICAgICAgICAgICB9CgkgICAgICAgIH0sCgoJICAgICAgICBwcmVwZW5kOiBmdW5jdGlvbihjb250YWluZXJOb2RlLCBub2RlVG9QcmVwZW5kKSB7CgkgICAgICAgICAgICBpZiAoIWlzU3RhcnRDb21tZW50KGNvbnRhaW5lck5vZGUpKSB7CgkgICAgICAgICAgICAgICAgaWYgKGNvbnRhaW5lck5vZGUuZmlyc3RDaGlsZCkKCSAgICAgICAgICAgICAgICAgICAgY29udGFpbmVyTm9kZS5pbnNlcnRCZWZvcmUobm9kZVRvUHJlcGVuZCwgY29udGFpbmVyTm9kZS5maXJzdENoaWxkKTsKCSAgICAgICAgICAgICAgICBlbHNlCgkgICAgICAgICAgICAgICAgICAgIGNvbnRhaW5lck5vZGUuYXBwZW5kQ2hpbGQobm9kZVRvUHJlcGVuZCk7CgkgICAgICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgICAgIC8vIFN0YXJ0IGNvbW1lbnRzIG11c3QgYWx3YXlzIGhhdmUgYSBwYXJlbnQgYW5kIGF0IGxlYXN0IG9uZSBmb2xsb3dpbmcgc2libGluZyAodGhlIGVuZCBjb21tZW50KQoJICAgICAgICAgICAgICAgIGNvbnRhaW5lck5vZGUucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUobm9kZVRvUHJlcGVuZCwgY29udGFpbmVyTm9kZS5uZXh0U2libGluZyk7CgkgICAgICAgICAgICB9CgkgICAgICAgIH0sCgoJICAgICAgICBpbnNlcnRBZnRlcjogZnVuY3Rpb24oY29udGFpbmVyTm9kZSwgbm9kZVRvSW5zZXJ0LCBpbnNlcnRBZnRlck5vZGUpIHsKCSAgICAgICAgICAgIGlmICghaW5zZXJ0QWZ0ZXJOb2RlKSB7CgkgICAgICAgICAgICAgICAga28udmlydHVhbEVsZW1lbnRzLnByZXBlbmQoY29udGFpbmVyTm9kZSwgbm9kZVRvSW5zZXJ0KTsKCSAgICAgICAgICAgIH0gZWxzZSBpZiAoIWlzU3RhcnRDb21tZW50KGNvbnRhaW5lck5vZGUpKSB7CgkgICAgICAgICAgICAgICAgLy8gSW5zZXJ0IGFmdGVyIGluc2VydGlvbiBwb2ludAoJICAgICAgICAgICAgICAgIGlmIChpbnNlcnRBZnRlck5vZGUubmV4dFNpYmxpbmcpCgkgICAgICAgICAgICAgICAgICAgIGNvbnRhaW5lck5vZGUuaW5zZXJ0QmVmb3JlKG5vZGVUb0luc2VydCwgaW5zZXJ0QWZ0ZXJOb2RlLm5leHRTaWJsaW5nKTsKCSAgICAgICAgICAgICAgICBlbHNlCgkgICAgICAgICAgICAgICAgICAgIGNvbnRhaW5lck5vZGUuYXBwZW5kQ2hpbGQobm9kZVRvSW5zZXJ0KTsKCSAgICAgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICAgICAgLy8gQ2hpbGRyZW4gb2Ygc3RhcnQgY29tbWVudHMgbXVzdCBhbHdheXMgaGF2ZSBhIHBhcmVudCBhbmQgYXQgbGVhc3Qgb25lIGZvbGxvd2luZyBzaWJsaW5nICh0aGUgZW5kIGNvbW1lbnQpCgkgICAgICAgICAgICAgICAgY29udGFpbmVyTm9kZS5wYXJlbnROb2RlLmluc2VydEJlZm9yZShub2RlVG9JbnNlcnQsIGluc2VydEFmdGVyTm9kZS5uZXh0U2libGluZyk7CgkgICAgICAgICAgICB9CgkgICAgICAgIH0sCgoJICAgICAgICBmaXJzdENoaWxkOiBmdW5jdGlvbihub2RlKSB7CgkgICAgICAgICAgICBpZiAoIWlzU3RhcnRDb21tZW50KG5vZGUpKQoJICAgICAgICAgICAgICAgIHJldHVybiBub2RlLmZpcnN0Q2hpbGQ7CgkgICAgICAgICAgICBpZiAoIW5vZGUubmV4dFNpYmxpbmcgfHwgaXNFbmRDb21tZW50KG5vZGUubmV4dFNpYmxpbmcpKQoJICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwoJICAgICAgICAgICAgcmV0dXJuIG5vZGUubmV4dFNpYmxpbmc7CgkgICAgICAgIH0sCgoJICAgICAgICBuZXh0U2libGluZzogZnVuY3Rpb24obm9kZSkgewoJICAgICAgICAgICAgaWYgKGlzU3RhcnRDb21tZW50KG5vZGUpKQoJICAgICAgICAgICAgICAgIG5vZGUgPSBnZXRNYXRjaGluZ0VuZENvbW1lbnQobm9kZSk7CgkgICAgICAgICAgICBpZiAobm9kZS5uZXh0U2libGluZyAmJiBpc0VuZENvbW1lbnQobm9kZS5uZXh0U2libGluZykpCgkgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CgkgICAgICAgICAgICByZXR1cm4gbm9kZS5uZXh0U2libGluZzsKCSAgICAgICAgfSwKCgkgICAgICAgIGhhc0JpbmRpbmdWYWx1ZTogaXNTdGFydENvbW1lbnQsCgoJICAgICAgICB2aXJ0dWFsTm9kZUJpbmRpbmdWYWx1ZTogZnVuY3Rpb24obm9kZSkgewoJICAgICAgICAgICAgdmFyIHJlZ2V4TWF0Y2ggPSAoY29tbWVudE5vZGVzSGF2ZVRleHRQcm9wZXJ0eSA/IG5vZGUudGV4dCA6IG5vZGUubm9kZVZhbHVlKS5tYXRjaChzdGFydENvbW1lbnRSZWdleCk7CgkgICAgICAgICAgICByZXR1cm4gcmVnZXhNYXRjaCA/IHJlZ2V4TWF0Y2hbMV0gOiBudWxsOwoJICAgICAgICB9LAoKCSAgICAgICAgbm9ybWFsaXNlVmlydHVhbEVsZW1lbnREb21TdHJ1Y3R1cmU6IGZ1bmN0aW9uKGVsZW1lbnRWZXJpZmllZCkgewoJICAgICAgICAgICAgLy8gV29ya2Fyb3VuZCBmb3IgaHR0cHM6Ly9naXRodWIuY29tL1N0ZXZlU2FuZGVyc29uL2tub2Nrb3V0L2lzc3Vlcy8xNTUKCSAgICAgICAgICAgIC8vIChJRSA8PSA4IG9yIElFIDkgcXVpcmtzIG1vZGUgcGFyc2VzIHlvdXIgSFRNTCB3ZWlyZGx5LCB0cmVhdGluZyBjbG9zaW5nIDwvbGk+IHRhZ3MgYXMgaWYgdGhleSBkb24ndCBleGlzdCwgdGhlcmVieSBtb3ZpbmcgY29tbWVudCBub2RlcwoJICAgICAgICAgICAgLy8gdGhhdCBhcmUgZGlyZWN0IGRlc2NlbmRhbnRzIG9mIDx1bD4gaW50byB0aGUgcHJlY2VkaW5nIDxsaT4pCgkgICAgICAgICAgICBpZiAoIWh0bWxUYWdzV2l0aE9wdGlvbmFsbHlDbG9zaW5nQ2hpbGRyZW5ba28udXRpbHMudGFnTmFtZUxvd2VyKGVsZW1lbnRWZXJpZmllZCldKQoJICAgICAgICAgICAgICAgIHJldHVybjsKCgkgICAgICAgICAgICAvLyBTY2FuIGltbWVkaWF0ZSBjaGlsZHJlbiB0byBzZWUgaWYgdGhleSBjb250YWluIHVuYmFsYW5jZWQgY29tbWVudCB0YWdzLiBJZiB0aGV5IGRvLCB0aG9zZSBjb21tZW50IHRhZ3MKCSAgICAgICAgICAgIC8vIG11c3QgYmUgaW50ZW5kZWQgdG8gYXBwZWFyICphZnRlciogdGhhdCBjaGlsZCwgc28gbW92ZSB0aGVtIHRoZXJlLgoJICAgICAgICAgICAgdmFyIGNoaWxkTm9kZSA9IGVsZW1lbnRWZXJpZmllZC5maXJzdENoaWxkOwoJICAgICAgICAgICAgaWYgKGNoaWxkTm9kZSkgewoJICAgICAgICAgICAgICAgIGRvIHsKCSAgICAgICAgICAgICAgICAgICAgaWYgKGNoaWxkTm9kZS5ub2RlVHlwZSA9PT0gMSkgewoJICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHVuYmFsYW5jZWRUYWdzID0gZ2V0VW5iYWxhbmNlZENoaWxkVGFncyhjaGlsZE5vZGUpOwoJICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHVuYmFsYW5jZWRUYWdzKSB7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gRml4IHVwIHRoZSBET00gYnkgbW92aW5nIHRoZSB1bmJhbGFuY2VkIHRhZ3MgdG8gd2hlcmUgdGhleSBtb3N0IGxpa2VseSB3ZXJlIGludGVuZGVkIHRvIGJlIHBsYWNlZCAtICphZnRlciogdGhlIGNoaWxkCgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG5vZGVUb0luc2VydEJlZm9yZSA9IGNoaWxkTm9kZS5uZXh0U2libGluZzsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHVuYmFsYW5jZWRUYWdzLmxlbmd0aDsgaSsrKSB7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChub2RlVG9JbnNlcnRCZWZvcmUpCgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50VmVyaWZpZWQuaW5zZXJ0QmVmb3JlKHVuYmFsYW5jZWRUYWdzW2ldLCBub2RlVG9JbnNlcnRCZWZvcmUpOwoJICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlCgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50VmVyaWZpZWQuYXBwZW5kQ2hpbGQodW5iYWxhbmNlZFRhZ3NbaV0pOwoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgIH0gd2hpbGUgKGNoaWxkTm9kZSA9IGNoaWxkTm9kZS5uZXh0U2libGluZyk7CgkgICAgICAgICAgICB9CgkgICAgICAgIH0KCSAgICB9OwoJfSkoKTsKCWtvLmV4cG9ydFN5bWJvbCgndmlydHVhbEVsZW1lbnRzJywga28udmlydHVhbEVsZW1lbnRzKTsKCWtvLmV4cG9ydFN5bWJvbCgndmlydHVhbEVsZW1lbnRzLmFsbG93ZWRCaW5kaW5ncycsIGtvLnZpcnR1YWxFbGVtZW50cy5hbGxvd2VkQmluZGluZ3MpOwoJa28uZXhwb3J0U3ltYm9sKCd2aXJ0dWFsRWxlbWVudHMuZW1wdHlOb2RlJywga28udmlydHVhbEVsZW1lbnRzLmVtcHR5Tm9kZSk7CgkvL2tvLmV4cG9ydFN5bWJvbCgndmlydHVhbEVsZW1lbnRzLmZpcnN0Q2hpbGQnLCBrby52aXJ0dWFsRWxlbWVudHMuZmlyc3RDaGlsZCk7ICAgICAvLyBmaXJzdENoaWxkIGlzIG5vdCBtaW5pZmllZAoJa28uZXhwb3J0U3ltYm9sKCd2aXJ0dWFsRWxlbWVudHMuaW5zZXJ0QWZ0ZXInLCBrby52aXJ0dWFsRWxlbWVudHMuaW5zZXJ0QWZ0ZXIpOwoJLy9rby5leHBvcnRTeW1ib2woJ3ZpcnR1YWxFbGVtZW50cy5uZXh0U2libGluZycsIGtvLnZpcnR1YWxFbGVtZW50cy5uZXh0U2libGluZyk7ICAgLy8gbmV4dFNpYmxpbmcgaXMgbm90IG1pbmlmaWVkCglrby5leHBvcnRTeW1ib2woJ3ZpcnR1YWxFbGVtZW50cy5wcmVwZW5kJywga28udmlydHVhbEVsZW1lbnRzLnByZXBlbmQpOwoJa28uZXhwb3J0U3ltYm9sKCd2aXJ0dWFsRWxlbWVudHMuc2V0RG9tTm9kZUNoaWxkcmVuJywga28udmlydHVhbEVsZW1lbnRzLnNldERvbU5vZGVDaGlsZHJlbik7CgkoZnVuY3Rpb24oKSB7CgkgICAgdmFyIGRlZmF1bHRCaW5kaW5nQXR0cmlidXRlTmFtZSA9ICJkYXRhLWJpbmQiOwoKCSAgICBrby5iaW5kaW5nUHJvdmlkZXIgPSBmdW5jdGlvbigpIHsKCSAgICAgICAgdGhpcy5iaW5kaW5nQ2FjaGUgPSB7fTsKCSAgICB9OwoKCSAgICBrby51dGlscy5leHRlbmQoa28uYmluZGluZ1Byb3ZpZGVyLnByb3RvdHlwZSwgewoJICAgICAgICAnbm9kZUhhc0JpbmRpbmdzJzogZnVuY3Rpb24obm9kZSkgewoJICAgICAgICAgICAgc3dpdGNoIChub2RlLm5vZGVUeXBlKSB7CgkgICAgICAgICAgICAgICAgY2FzZSAxOiAvLyBFbGVtZW50CgkgICAgICAgICAgICAgICAgICAgIHJldHVybiBub2RlLmdldEF0dHJpYnV0ZShkZWZhdWx0QmluZGluZ0F0dHJpYnV0ZU5hbWUpICE9IG51bGwKCSAgICAgICAgICAgICAgICAgICAgICAgIHx8IGtvLmNvbXBvbmVudHNbJ2dldENvbXBvbmVudE5hbWVGb3JOb2RlJ10obm9kZSk7CgkgICAgICAgICAgICAgICAgY2FzZSA4OiAvLyBDb21tZW50IG5vZGUKCSAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGtvLnZpcnR1YWxFbGVtZW50cy5oYXNCaW5kaW5nVmFsdWUobm9kZSk7CgkgICAgICAgICAgICAgICAgZGVmYXVsdDogcmV0dXJuIGZhbHNlOwoJICAgICAgICAgICAgfQoJICAgICAgICB9LAoKCSAgICAgICAgJ2dldEJpbmRpbmdzJzogZnVuY3Rpb24obm9kZSwgYmluZGluZ0NvbnRleHQpIHsKCSAgICAgICAgICAgIHZhciBiaW5kaW5nc1N0cmluZyA9IHRoaXNbJ2dldEJpbmRpbmdzU3RyaW5nJ10obm9kZSwgYmluZGluZ0NvbnRleHQpLAoJICAgICAgICAgICAgICAgIHBhcnNlZEJpbmRpbmdzID0gYmluZGluZ3NTdHJpbmcgPyB0aGlzWydwYXJzZUJpbmRpbmdzU3RyaW5nJ10oYmluZGluZ3NTdHJpbmcsIGJpbmRpbmdDb250ZXh0LCBub2RlKSA6IG51bGw7CgkgICAgICAgICAgICByZXR1cm4ga28uY29tcG9uZW50cy5hZGRCaW5kaW5nc0ZvckN1c3RvbUVsZW1lbnQocGFyc2VkQmluZGluZ3MsIG5vZGUsIGJpbmRpbmdDb250ZXh0LCAvKiB2YWx1ZUFjY2Vzc29ycyAqLyBmYWxzZSk7CgkgICAgICAgIH0sCgoJICAgICAgICAnZ2V0QmluZGluZ0FjY2Vzc29ycyc6IGZ1bmN0aW9uKG5vZGUsIGJpbmRpbmdDb250ZXh0KSB7CgkgICAgICAgICAgICB2YXIgYmluZGluZ3NTdHJpbmcgPSB0aGlzWydnZXRCaW5kaW5nc1N0cmluZyddKG5vZGUsIGJpbmRpbmdDb250ZXh0KSwKCSAgICAgICAgICAgICAgICBwYXJzZWRCaW5kaW5ncyA9IGJpbmRpbmdzU3RyaW5nID8gdGhpc1sncGFyc2VCaW5kaW5nc1N0cmluZyddKGJpbmRpbmdzU3RyaW5nLCBiaW5kaW5nQ29udGV4dCwgbm9kZSwgeyAndmFsdWVBY2Nlc3NvcnMnOiB0cnVlIH0pIDogbnVsbDsKCSAgICAgICAgICAgIHJldHVybiBrby5jb21wb25lbnRzLmFkZEJpbmRpbmdzRm9yQ3VzdG9tRWxlbWVudChwYXJzZWRCaW5kaW5ncywgbm9kZSwgYmluZGluZ0NvbnRleHQsIC8qIHZhbHVlQWNjZXNzb3JzICovIHRydWUpOwoJICAgICAgICB9LAoKCSAgICAgICAgLy8gVGhlIGZvbGxvd2luZyBmdW5jdGlvbiBpcyBvbmx5IHVzZWQgaW50ZXJuYWxseSBieSB0aGlzIGRlZmF1bHQgcHJvdmlkZXIuCgkgICAgICAgIC8vIEl0J3Mgbm90IHBhcnQgb2YgdGhlIGludGVyZmFjZSBkZWZpbml0aW9uIGZvciBhIGdlbmVyYWwgYmluZGluZyBwcm92aWRlci4KCSAgICAgICAgJ2dldEJpbmRpbmdzU3RyaW5nJzogZnVuY3Rpb24obm9kZSwgYmluZGluZ0NvbnRleHQpIHsKCSAgICAgICAgICAgIHN3aXRjaCAobm9kZS5ub2RlVHlwZSkgewoJICAgICAgICAgICAgICAgIGNhc2UgMTogcmV0dXJuIG5vZGUuZ2V0QXR0cmlidXRlKGRlZmF1bHRCaW5kaW5nQXR0cmlidXRlTmFtZSk7ICAgLy8gRWxlbWVudAoJICAgICAgICAgICAgICAgIGNhc2UgODogcmV0dXJuIGtvLnZpcnR1YWxFbGVtZW50cy52aXJ0dWFsTm9kZUJpbmRpbmdWYWx1ZShub2RlKTsgLy8gQ29tbWVudCBub2RlCgkgICAgICAgICAgICAgICAgZGVmYXVsdDogcmV0dXJuIG51bGw7CgkgICAgICAgICAgICB9CgkgICAgICAgIH0sCgoJICAgICAgICAvLyBUaGUgZm9sbG93aW5nIGZ1bmN0aW9uIGlzIG9ubHkgdXNlZCBpbnRlcm5hbGx5IGJ5IHRoaXMgZGVmYXVsdCBwcm92aWRlci4KCSAgICAgICAgLy8gSXQncyBub3QgcGFydCBvZiB0aGUgaW50ZXJmYWNlIGRlZmluaXRpb24gZm9yIGEgZ2VuZXJhbCBiaW5kaW5nIHByb3ZpZGVyLgoJICAgICAgICAncGFyc2VCaW5kaW5nc1N0cmluZyc6IGZ1bmN0aW9uKGJpbmRpbmdzU3RyaW5nLCBiaW5kaW5nQ29udGV4dCwgbm9kZSwgb3B0aW9ucykgewoJICAgICAgICAgICAgdHJ5IHsKCSAgICAgICAgICAgICAgICB2YXIgYmluZGluZ0Z1bmN0aW9uID0gY3JlYXRlQmluZGluZ3NTdHJpbmdFdmFsdWF0b3JWaWFDYWNoZShiaW5kaW5nc1N0cmluZywgdGhpcy5iaW5kaW5nQ2FjaGUsIG9wdGlvbnMpOwoJICAgICAgICAgICAgICAgIHJldHVybiBiaW5kaW5nRnVuY3Rpb24oYmluZGluZ0NvbnRleHQsIG5vZGUpOwoJICAgICAgICAgICAgfSBjYXRjaCAoZXgpIHsKCSAgICAgICAgICAgICAgICBleC5tZXNzYWdlID0gIlVuYWJsZSB0byBwYXJzZSBiaW5kaW5ncy5cbkJpbmRpbmdzIHZhbHVlOiAiICsgYmluZGluZ3NTdHJpbmcgKyAiXG5NZXNzYWdlOiAiICsgZXgubWVzc2FnZTsKCSAgICAgICAgICAgICAgICB0aHJvdyBleDsKCSAgICAgICAgICAgIH0KCSAgICAgICAgfQoJICAgIH0pOwoKCSAgICBrby5iaW5kaW5nUHJvdmlkZXJbJ2luc3RhbmNlJ10gPSBuZXcga28uYmluZGluZ1Byb3ZpZGVyKCk7CgoJICAgIGZ1bmN0aW9uIGNyZWF0ZUJpbmRpbmdzU3RyaW5nRXZhbHVhdG9yVmlhQ2FjaGUoYmluZGluZ3NTdHJpbmcsIGNhY2hlLCBvcHRpb25zKSB7CgkgICAgICAgIHZhciBjYWNoZUtleSA9IGJpbmRpbmdzU3RyaW5nICsgKG9wdGlvbnMgJiYgb3B0aW9uc1sndmFsdWVBY2Nlc3NvcnMnXSB8fCAnJyk7CgkgICAgICAgIHJldHVybiBjYWNoZVtjYWNoZUtleV0KCSAgICAgICAgICAgIHx8IChjYWNoZVtjYWNoZUtleV0gPSBjcmVhdGVCaW5kaW5nc1N0cmluZ0V2YWx1YXRvcihiaW5kaW5nc1N0cmluZywgb3B0aW9ucykpOwoJICAgIH0KCgkgICAgZnVuY3Rpb24gY3JlYXRlQmluZGluZ3NTdHJpbmdFdmFsdWF0b3IoYmluZGluZ3NTdHJpbmcsIG9wdGlvbnMpIHsKCSAgICAgICAgLy8gQnVpbGQgdGhlIHNvdXJjZSBmb3IgYSBmdW5jdGlvbiB0aGF0IGV2YWx1YXRlcyAiZXhwcmVzc2lvbiIKCSAgICAgICAgLy8gRm9yIGVhY2ggc2NvcGUgdmFyaWFibGUsIGFkZCBhbiBleHRyYSBsZXZlbCBvZiAid2l0aCIgbmVzdGluZwoJICAgICAgICAvLyBFeGFtcGxlIHJlc3VsdDogd2l0aChzYzEpIHsgd2l0aChzYzApIHsgcmV0dXJuIChleHByZXNzaW9uKSB9IH0KCSAgICAgICAgdmFyIHJld3JpdHRlbkJpbmRpbmdzID0ga28uZXhwcmVzc2lvblJld3JpdGluZy5wcmVQcm9jZXNzQmluZGluZ3MoYmluZGluZ3NTdHJpbmcsIG9wdGlvbnMpLAoJICAgICAgICAgICAgZnVuY3Rpb25Cb2R5ID0gIndpdGgoJGNvbnRleHQpe3dpdGgoJGRhdGF8fHt9KXtyZXR1cm57IiArIHJld3JpdHRlbkJpbmRpbmdzICsgIn19fSI7CgkgICAgICAgIHJldHVybiBuZXcgRnVuY3Rpb24oIiRjb250ZXh0IiwgIiRlbGVtZW50IiwgZnVuY3Rpb25Cb2R5KTsKCSAgICB9Cgl9KSgpOwoKCWtvLmV4cG9ydFN5bWJvbCgnYmluZGluZ1Byb3ZpZGVyJywga28uYmluZGluZ1Byb3ZpZGVyKTsKCShmdW5jdGlvbiAoKSB7CgkgICAga28uYmluZGluZ0hhbmRsZXJzID0ge307CgoJICAgIC8vIFRoZSBmb2xsb3dpbmcgZWxlbWVudCB0eXBlcyB3aWxsIG5vdCBiZSByZWN1cnNlZCBpbnRvIGR1cmluZyBiaW5kaW5nLiBJbiB0aGUgZnV0dXJlLCB3ZQoJICAgIC8vIG1heSBjb25zaWRlciBhZGRpbmcgPHRlbXBsYXRlPiB0byB0aGlzIGxpc3QsIGJlY2F1c2Ugc3VjaCBlbGVtZW50cycgY29udGVudHMgYXJlIGFsd2F5cwoJICAgIC8vIGludGVuZGVkIHRvIGJlIGJvdW5kIGluIGEgZGlmZmVyZW50IGNvbnRleHQgZnJvbSB3aGVyZSB0aGV5IGFwcGVhciBpbiB0aGUgZG9jdW1lbnQuCgkgICAgdmFyIGJpbmRpbmdEb2VzTm90UmVjdXJzZUludG9FbGVtZW50VHlwZXMgPSB7CgkgICAgICAgIC8vIERvbid0IHdhbnQgYmluZGluZ3MgdGhhdCBvcGVyYXRlIG9uIHRleHQgbm9kZXMgdG8gbXV0YXRlIDxzY3JpcHQ+IGNvbnRlbnRzLAoJICAgICAgICAvLyBiZWNhdXNlIGl0J3MgdW5leHBlY3RlZCBhbmQgYSBwb3RlbnRpYWwgWFNTIGlzc3VlCgkgICAgICAgICdzY3JpcHQnOiB0cnVlCgkgICAgfTsKCgkgICAgLy8gVXNlIGFuIG92ZXJyaWRhYmxlIG1ldGhvZCBmb3IgcmV0cmlldmluZyBiaW5kaW5nIGhhbmRsZXJzIHNvIHRoYXQgYSBwbHVnaW5zIG1heSBzdXBwb3J0IGR5bmFtaWNhbGx5IGNyZWF0ZWQgaGFuZGxlcnMKCSAgICBrb1snZ2V0QmluZGluZ0hhbmRsZXInXSA9IGZ1bmN0aW9uKGJpbmRpbmdLZXkpIHsKCSAgICAgICAgcmV0dXJuIGtvLmJpbmRpbmdIYW5kbGVyc1tiaW5kaW5nS2V5XTsKCSAgICB9OwoKCSAgICAvLyBUaGUga28uYmluZGluZ0NvbnRleHQgY29uc3RydWN0b3IgaXMgb25seSBjYWxsZWQgZGlyZWN0bHkgdG8gY3JlYXRlIHRoZSByb290IGNvbnRleHQuIEZvciBjaGlsZAoJICAgIC8vIGNvbnRleHRzLCB1c2UgYmluZGluZ0NvbnRleHQuY3JlYXRlQ2hpbGRDb250ZXh0IG9yIGJpbmRpbmdDb250ZXh0LmV4dGVuZC4KCSAgICBrby5iaW5kaW5nQ29udGV4dCA9IGZ1bmN0aW9uKGRhdGFJdGVtT3JBY2Nlc3NvciwgcGFyZW50Q29udGV4dCwgZGF0YUl0ZW1BbGlhcywgZXh0ZW5kQ2FsbGJhY2spIHsKCgkgICAgICAgIC8vIFRoZSBiaW5kaW5nIGNvbnRleHQgb2JqZWN0IGluY2x1ZGVzIHN0YXRpYyBwcm9wZXJ0aWVzIGZvciB0aGUgY3VycmVudCwgcGFyZW50LCBhbmQgcm9vdCB2aWV3IG1vZGVscy4KCSAgICAgICAgLy8gSWYgYSB2aWV3IG1vZGVsIGlzIGFjdHVhbGx5IHN0b3JlZCBpbiBhbiBvYnNlcnZhYmxlLCB0aGUgY29ycmVzcG9uZGluZyBiaW5kaW5nIGNvbnRleHQgb2JqZWN0LCBhbmQKCSAgICAgICAgLy8gYW55IGNoaWxkIGNvbnRleHRzLCBtdXN0IGJlIHVwZGF0ZWQgd2hlbiB0aGUgdmlldyBtb2RlbCBpcyBjaGFuZ2VkLgoJICAgICAgICBmdW5jdGlvbiB1cGRhdGVDb250ZXh0KCkgewoJICAgICAgICAgICAgLy8gTW9zdCBvZiB0aGUgdGltZSwgdGhlIGNvbnRleHQgd2lsbCBkaXJlY3RseSBnZXQgYSB2aWV3IG1vZGVsIG9iamVjdCwgYnV0IGlmIGEgZnVuY3Rpb24gaXMgZ2l2ZW4sCgkgICAgICAgICAgICAvLyB3ZSBjYWxsIHRoZSBmdW5jdGlvbiB0byByZXRyaWV2ZSB0aGUgdmlldyBtb2RlbC4gSWYgdGhlIGZ1bmN0aW9uIGFjY2Vzc2VzIGFueSBvYnNldmFibGVzIG9yIHJldHVybnMKCSAgICAgICAgICAgIC8vIGFuIG9ic2VydmFibGUsIHRoZSBkZXBlbmRlbmN5IGlzIHRyYWNrZWQsIGFuZCB0aG9zZSBvYnNlcnZhYmxlcyBjYW4gbGF0ZXIgY2F1c2UgdGhlIGJpbmRpbmcKCSAgICAgICAgICAgIC8vIGNvbnRleHQgdG8gYmUgdXBkYXRlZC4KCSAgICAgICAgICAgIHZhciBkYXRhSXRlbU9yT2JzZXJ2YWJsZSA9IGlzRnVuYyA/IGRhdGFJdGVtT3JBY2Nlc3NvcigpIDogZGF0YUl0ZW1PckFjY2Vzc29yLAoJICAgICAgICAgICAgICAgIGRhdGFJdGVtID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZShkYXRhSXRlbU9yT2JzZXJ2YWJsZSk7CgoJICAgICAgICAgICAgaWYgKHBhcmVudENvbnRleHQpIHsKCSAgICAgICAgICAgICAgICAvLyBXaGVuIGEgInBhcmVudCIgY29udGV4dCBpcyBnaXZlbiwgcmVnaXN0ZXIgYSBkZXBlbmRlbmN5IG9uIHRoZSBwYXJlbnQgY29udGV4dC4gVGh1cyB3aGVuZXZlciB0aGUKCSAgICAgICAgICAgICAgICAvLyBwYXJlbnQgY29udGV4dCBpcyB1cGRhdGVkLCB0aGlzIGNvbnRleHQgd2lsbCBhbHNvIGJlIHVwZGF0ZWQuCgkgICAgICAgICAgICAgICAgaWYgKHBhcmVudENvbnRleHQuX3N1YnNjcmliYWJsZSkKCSAgICAgICAgICAgICAgICAgICAgcGFyZW50Q29udGV4dC5fc3Vic2NyaWJhYmxlKCk7CgoJICAgICAgICAgICAgICAgIC8vIENvcHkgJHJvb3QgYW5kIGFueSBjdXN0b20gcHJvcGVydGllcyBmcm9tIHRoZSBwYXJlbnQgY29udGV4dAoJICAgICAgICAgICAgICAgIGtvLnV0aWxzLmV4dGVuZChzZWxmLCBwYXJlbnRDb250ZXh0KTsKCgkgICAgICAgICAgICAgICAgLy8gQmVjYXVzZSB0aGUgYWJvdmUgY29weSBvdmVyd3JpdGVzIG91ciBvd24gcHJvcGVydGllcywgd2UgbmVlZCB0byByZXNldCB0aGVtLgoJICAgICAgICAgICAgICAgIC8vIER1cmluZyB0aGUgZmlyc3QgZXhlY3V0aW9uLCAic3Vic2NyaWJhYmxlIiBpc24ndCBzZXQsIHNvIGRvbid0IGJvdGhlciBkb2luZyB0aGUgdXBkYXRlIHRoZW4uCgkgICAgICAgICAgICAgICAgaWYgKHN1YnNjcmliYWJsZSkgewoJICAgICAgICAgICAgICAgICAgICBzZWxmLl9zdWJzY3JpYmFibGUgPSBzdWJzY3JpYmFibGU7CgkgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgICAgICBzZWxmWyckcGFyZW50cyddID0gW107CgkgICAgICAgICAgICAgICAgc2VsZlsnJHJvb3QnXSA9IGRhdGFJdGVtOwoKCSAgICAgICAgICAgICAgICAvLyBFeHBvcnQgJ2tvJyBpbiB0aGUgYmluZGluZyBjb250ZXh0IHNvIGl0IHdpbGwgYmUgYXZhaWxhYmxlIGluIGJpbmRpbmdzIGFuZCB0ZW1wbGF0ZXMKCSAgICAgICAgICAgICAgICAvLyBldmVuIGlmICdrbycgaXNuJ3QgZXhwb3J0ZWQgYXMgYSBnbG9iYWwsIHN1Y2ggYXMgd2hlbiB1c2luZyBhbiBBTUQgbG9hZGVyLgoJICAgICAgICAgICAgICAgIC8vIFNlZSBodHRwczovL2dpdGh1Yi5jb20vU3RldmVTYW5kZXJzb24va25vY2tvdXQvaXNzdWVzLzQ5MAoJICAgICAgICAgICAgICAgIHNlbGZbJ2tvJ10gPSBrbzsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIHNlbGZbJyRyYXdEYXRhJ10gPSBkYXRhSXRlbU9yT2JzZXJ2YWJsZTsKCSAgICAgICAgICAgIHNlbGZbJyRkYXRhJ10gPSBkYXRhSXRlbTsKCSAgICAgICAgICAgIGlmIChkYXRhSXRlbUFsaWFzKQoJICAgICAgICAgICAgICAgIHNlbGZbZGF0YUl0ZW1BbGlhc10gPSBkYXRhSXRlbTsKCgkgICAgICAgICAgICAvLyBUaGUgZXh0ZW5kQ2FsbGJhY2sgZnVuY3Rpb24gaXMgcHJvdmlkZWQgd2hlbiBjcmVhdGluZyBhIGNoaWxkIGNvbnRleHQgb3IgZXh0ZW5kaW5nIGEgY29udGV4dC4KCSAgICAgICAgICAgIC8vIEl0IGhhbmRsZXMgdGhlIHNwZWNpZmljIGFjdGlvbnMgbmVlZGVkIHRvIGZpbmlzaCBzZXR0aW5nIHVwIHRoZSBiaW5kaW5nIGNvbnRleHQuIEFjdGlvbnMgaW4gdGhpcwoJICAgICAgICAgICAgLy8gZnVuY3Rpb24gY291bGQgYWxzbyBhZGQgZGVwZW5kZW5jaWVzIHRvIHRoaXMgYmluZGluZyBjb250ZXh0LgoJICAgICAgICAgICAgaWYgKGV4dGVuZENhbGxiYWNrKQoJICAgICAgICAgICAgICAgIGV4dGVuZENhbGxiYWNrKHNlbGYsIHBhcmVudENvbnRleHQsIGRhdGFJdGVtKTsKCgkgICAgICAgICAgICByZXR1cm4gc2VsZlsnJGRhdGEnXTsKCSAgICAgICAgfQoJICAgICAgICBmdW5jdGlvbiBkaXNwb3NlV2hlbigpIHsKCSAgICAgICAgICAgIHJldHVybiBub2RlcyAmJiAha28udXRpbHMuYW55RG9tTm9kZUlzQXR0YWNoZWRUb0RvY3VtZW50KG5vZGVzKTsKCSAgICAgICAgfQoKCSAgICAgICAgdmFyIHNlbGYgPSB0aGlzLAoJICAgICAgICAgICAgaXNGdW5jID0gdHlwZW9mKGRhdGFJdGVtT3JBY2Nlc3NvcikgPT0gImZ1bmN0aW9uIiAmJiAha28uaXNPYnNlcnZhYmxlKGRhdGFJdGVtT3JBY2Nlc3NvciksCgkgICAgICAgICAgICBub2RlcywKCSAgICAgICAgICAgIHN1YnNjcmliYWJsZSA9IGtvLmRlcGVuZGVudE9ic2VydmFibGUodXBkYXRlQ29udGV4dCwgbnVsbCwgeyBkaXNwb3NlV2hlbjogZGlzcG9zZVdoZW4sIGRpc3Bvc2VXaGVuTm9kZUlzUmVtb3ZlZDogdHJ1ZSB9KTsKCgkgICAgICAgIC8vIEF0IHRoaXMgcG9pbnQsIHRoZSBiaW5kaW5nIGNvbnRleHQgaGFzIGJlZW4gaW5pdGlhbGl6ZWQsIGFuZCB0aGUgInN1YnNjcmliYWJsZSIgY29tcHV0ZWQgb2JzZXJ2YWJsZSBpcwoJICAgICAgICAvLyBzdWJzY3JpYmVkIHRvIGFueSBvYnNlcnZhYmxlcyB0aGF0IHdlcmUgYWNjZXNzZWQgaW4gdGhlIHByb2Nlc3MuIElmIHRoZXJlIGlzIG5vdGhpbmcgdG8gdHJhY2ssIHRoZQoJICAgICAgICAvLyBjb21wdXRlZCB3aWxsIGJlIGluYWN0aXZlLCBhbmQgd2UgY2FuIHNhZmVseSB0aHJvdyBpdCBhd2F5LiBJZiBpdCdzIGFjdGl2ZSwgdGhlIGNvbXB1dGVkIGlzIHN0b3JlZCBpbgoJICAgICAgICAvLyB0aGUgY29udGV4dCBvYmplY3QuCgkgICAgICAgIGlmIChzdWJzY3JpYmFibGUuaXNBY3RpdmUoKSkgewoJICAgICAgICAgICAgc2VsZi5fc3Vic2NyaWJhYmxlID0gc3Vic2NyaWJhYmxlOwoKCSAgICAgICAgICAgIC8vIEFsd2F5cyBub3RpZnkgYmVjYXVzZSBldmVuIGlmIHRoZSBtb2RlbCAoJGRhdGEpIGhhc24ndCBjaGFuZ2VkLCBvdGhlciBjb250ZXh0IHByb3BlcnRpZXMgbWlnaHQgaGF2ZSBjaGFuZ2VkCgkgICAgICAgICAgICBzdWJzY3JpYmFibGVbJ2VxdWFsaXR5Q29tcGFyZXInXSA9IG51bGw7CgoJICAgICAgICAgICAgLy8gV2UgbmVlZCB0byBiZSBhYmxlIHRvIGRpc3Bvc2Ugb2YgdGhpcyBjb21wdXRlZCBvYnNlcnZhYmxlIHdoZW4gaXQncyBubyBsb25nZXIgbmVlZGVkLiBUaGlzIHdvdWxkIGJlCgkgICAgICAgICAgICAvLyBlYXN5IGlmIHdlIGhhZCBhIHNpbmdsZSBub2RlIHRvIHdhdGNoLCBidXQgYmluZGluZyBjb250ZXh0cyBjYW4gYmUgdXNlZCBieSBtYW55IGRpZmZlcmVudCBub2RlcywgYW5kCgkgICAgICAgICAgICAvLyB3ZSBjYW5ub3QgYXNzdW1lIHRoYXQgdGhvc2Ugbm9kZXMgaGF2ZSBhbnkgcmVsYXRpb24gdG8gZWFjaCBvdGhlci4gU28gaW5zdGVhZCB3ZSB0cmFjayBhbnkgbm9kZSB0aGF0CgkgICAgICAgICAgICAvLyB0aGUgY29udGV4dCBpcyBhdHRhY2hlZCB0bywgYW5kIGRpc3Bvc2UgdGhlIGNvbXB1dGVkIHdoZW4gYWxsIG9mIHRob3NlIG5vZGVzIGhhdmUgYmVlbiBjbGVhbmVkLgoKCSAgICAgICAgICAgIC8vIEFkZCBwcm9wZXJ0aWVzIHRvICpzdWJzY3JpYmFibGUqIGluc3RlYWQgb2YgKnNlbGYqIGJlY2F1c2UgYW55IHByb3BlcnRpZXMgYWRkZWQgdG8gKnNlbGYqIG1heSBiZSBvdmVyd3JpdHRlbiBvbiB1cGRhdGVzCgkgICAgICAgICAgICBub2RlcyA9IFtdOwoJICAgICAgICAgICAgc3Vic2NyaWJhYmxlLl9hZGROb2RlID0gZnVuY3Rpb24obm9kZSkgewoJICAgICAgICAgICAgICAgIG5vZGVzLnB1c2gobm9kZSk7CgkgICAgICAgICAgICAgICAga28udXRpbHMuZG9tTm9kZURpc3Bvc2FsLmFkZERpc3Bvc2VDYWxsYmFjayhub2RlLCBmdW5jdGlvbihub2RlKSB7CgkgICAgICAgICAgICAgICAgICAgIGtvLnV0aWxzLmFycmF5UmVtb3ZlSXRlbShub2Rlcywgbm9kZSk7CgkgICAgICAgICAgICAgICAgICAgIGlmICghbm9kZXMubGVuZ3RoKSB7CgkgICAgICAgICAgICAgICAgICAgICAgICBzdWJzY3JpYmFibGUuZGlzcG9zZSgpOwoJICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5fc3Vic2NyaWJhYmxlID0gc3Vic2NyaWJhYmxlID0gdW5kZWZpbmVkOwoJICAgICAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgfSk7CgkgICAgICAgICAgICB9OwoJICAgICAgICB9CgkgICAgfQoKCSAgICAvLyBFeHRlbmQgdGhlIGJpbmRpbmcgY29udGV4dCBoaWVyYXJjaHkgd2l0aCBhIG5ldyB2aWV3IG1vZGVsIG9iamVjdC4gSWYgdGhlIHBhcmVudCBjb250ZXh0IGlzIHdhdGNoaW5nCgkgICAgLy8gYW55IG9ic2V2YWJsZXMsIHRoZSBuZXcgY2hpbGQgY29udGV4dCB3aWxsIGF1dG9tYXRpY2FsbHkgZ2V0IGEgZGVwZW5kZW5jeSBvbiB0aGUgcGFyZW50IGNvbnRleHQuCgkgICAgLy8gQnV0IHRoaXMgZG9lcyBub3QgbWVhbiB0aGF0IHRoZSAkZGF0YSB2YWx1ZSBvZiB0aGUgY2hpbGQgY29udGV4dCB3aWxsIGFsc28gZ2V0IHVwZGF0ZWQuIElmIHRoZSBjaGlsZAoJICAgIC8vIHZpZXcgbW9kZWwgYWxzbyBkZXBlbmRzIG9uIHRoZSBwYXJlbnQgdmlldyBtb2RlbCwgeW91IG11c3QgcHJvdmlkZSBhIGZ1bmN0aW9uIHRoYXQgcmV0dXJucyB0aGUgY29ycmVjdAoJICAgIC8vIHZpZXcgbW9kZWwgb24gZWFjaCB1cGRhdGUuCgkgICAga28uYmluZGluZ0NvbnRleHQucHJvdG90eXBlWydjcmVhdGVDaGlsZENvbnRleHQnXSA9IGZ1bmN0aW9uIChkYXRhSXRlbU9yQWNjZXNzb3IsIGRhdGFJdGVtQWxpYXMsIGV4dGVuZENhbGxiYWNrKSB7CgkgICAgICAgIHJldHVybiBuZXcga28uYmluZGluZ0NvbnRleHQoZGF0YUl0ZW1PckFjY2Vzc29yLCB0aGlzLCBkYXRhSXRlbUFsaWFzLCBmdW5jdGlvbihzZWxmLCBwYXJlbnRDb250ZXh0KSB7CgkgICAgICAgICAgICAvLyBFeHRlbmQgdGhlIGNvbnRleHQgaGllcmFyY2h5IGJ5IHNldHRpbmcgdGhlIGFwcHJvcHJpYXRlIHBvaW50ZXJzCgkgICAgICAgICAgICBzZWxmWyckcGFyZW50Q29udGV4dCddID0gcGFyZW50Q29udGV4dDsKCSAgICAgICAgICAgIHNlbGZbJyRwYXJlbnQnXSA9IHBhcmVudENvbnRleHRbJyRkYXRhJ107CgkgICAgICAgICAgICBzZWxmWyckcGFyZW50cyddID0gKHBhcmVudENvbnRleHRbJyRwYXJlbnRzJ10gfHwgW10pLnNsaWNlKDApOwoJICAgICAgICAgICAgc2VsZlsnJHBhcmVudHMnXS51bnNoaWZ0KHNlbGZbJyRwYXJlbnQnXSk7CgkgICAgICAgICAgICBpZiAoZXh0ZW5kQ2FsbGJhY2spCgkgICAgICAgICAgICAgICAgZXh0ZW5kQ2FsbGJhY2soc2VsZik7CgkgICAgICAgIH0pOwoJICAgIH07CgoJICAgIC8vIEV4dGVuZCB0aGUgYmluZGluZyBjb250ZXh0IHdpdGggbmV3IGN1c3RvbSBwcm9wZXJ0aWVzLiBUaGlzIGRvZXNuJ3QgY2hhbmdlIHRoZSBjb250ZXh0IGhpZXJhcmNoeS4KCSAgICAvLyBTaW1pbGFybHkgdG8gImNoaWxkIiBjb250ZXh0cywgcHJvdmlkZSBhIGZ1bmN0aW9uIGhlcmUgdG8gbWFrZSBzdXJlIHRoYXQgdGhlIGNvcnJlY3QgdmFsdWVzIGFyZSBzZXQKCSAgICAvLyB3aGVuIGFuIG9ic2VydmFibGUgdmlldyBtb2RlbCBpcyB1cGRhdGVkLgoJICAgIGtvLmJpbmRpbmdDb250ZXh0LnByb3RvdHlwZVsnZXh0ZW5kJ10gPSBmdW5jdGlvbihwcm9wZXJ0aWVzKSB7CgkgICAgICAgIC8vIElmIHRoZSBwYXJlbnQgY29udGV4dCByZWZlcmVuY2VzIGFuIG9ic2VydmFibGUgdmlldyBtb2RlbCwgIl9zdWJzY3JpYmFibGUiIHdpbGwgYWx3YXlzIGJlIHRoZQoJICAgICAgICAvLyBsYXRlc3QgdmlldyBtb2RlbCBvYmplY3QuIElmIG5vdCwgIl9zdWJzY3JpYmFibGUiIGlzbid0IHNldCwgYW5kIHdlIGNhbiB1c2UgdGhlIHN0YXRpYyAiJGRhdGEiIHZhbHVlLgoJICAgICAgICByZXR1cm4gbmV3IGtvLmJpbmRpbmdDb250ZXh0KHRoaXMuX3N1YnNjcmliYWJsZSB8fCB0aGlzWyckZGF0YSddLCB0aGlzLCBudWxsLCBmdW5jdGlvbihzZWxmLCBwYXJlbnRDb250ZXh0KSB7CgkgICAgICAgICAgICAvLyBUaGlzICJjaGlsZCIgY29udGV4dCBkb2Vzbid0IGRpcmVjdGx5IHRyYWNrIGEgcGFyZW50IG9ic2VydmFibGUgdmlldyBtb2RlbCwKCSAgICAgICAgICAgIC8vIHNvIHdlIG5lZWQgdG8gbWFudWFsbHkgc2V0IHRoZSAkcmF3RGF0YSB2YWx1ZSB0byBtYXRjaCB0aGUgcGFyZW50LgoJICAgICAgICAgICAgc2VsZlsnJHJhd0RhdGEnXSA9IHBhcmVudENvbnRleHRbJyRyYXdEYXRhJ107CgkgICAgICAgICAgICBrby51dGlscy5leHRlbmQoc2VsZiwgdHlwZW9mKHByb3BlcnRpZXMpID09ICJmdW5jdGlvbiIgPyBwcm9wZXJ0aWVzKCkgOiBwcm9wZXJ0aWVzKTsKCSAgICAgICAgfSk7CgkgICAgfTsKCgkgICAgLy8gUmV0dXJucyB0aGUgdmFsdWVBY2Nlc29yIGZ1bmN0aW9uIGZvciBhIGJpbmRpbmcgdmFsdWUKCSAgICBmdW5jdGlvbiBtYWtlVmFsdWVBY2Nlc3Nvcih2YWx1ZSkgewoJICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CgkgICAgICAgICAgICByZXR1cm4gdmFsdWU7CgkgICAgICAgIH07CgkgICAgfQoKCSAgICAvLyBSZXR1cm5zIHRoZSB2YWx1ZSBvZiBhIHZhbHVlQWNjZXNzb3IgZnVuY3Rpb24KCSAgICBmdW5jdGlvbiBldmFsdWF0ZVZhbHVlQWNjZXNzb3IodmFsdWVBY2Nlc3NvcikgewoJICAgICAgICByZXR1cm4gdmFsdWVBY2Nlc3NvcigpOwoJICAgIH0KCgkgICAgLy8gR2l2ZW4gYSBmdW5jdGlvbiB0aGF0IHJldHVybnMgYmluZGluZ3MsIGNyZWF0ZSBhbmQgcmV0dXJuIGEgbmV3IG9iamVjdCB0aGF0IGNvbnRhaW5zCgkgICAgLy8gYmluZGluZyB2YWx1ZS1hY2Nlc3NvcnMgZnVuY3Rpb25zLiBFYWNoIGFjY2Vzc29yIGZ1bmN0aW9uIGNhbGxzIHRoZSBvcmlnaW5hbCBmdW5jdGlvbgoJICAgIC8vIHNvIHRoYXQgaXQgYWx3YXlzIGdldHMgdGhlIGxhdGVzdCB2YWx1ZSBhbmQgYWxsIGRlcGVuZGVuY2llcyBhcmUgY2FwdHVyZWQuIFRoaXMgaXMgdXNlZAoJICAgIC8vIGJ5IGtvLmFwcGx5QmluZGluZ3NUb05vZGUgYW5kIGdldEJpbmRpbmdzQW5kTWFrZUFjY2Vzc29ycy4KCSAgICBmdW5jdGlvbiBtYWtlQWNjZXNzb3JzRnJvbUZ1bmN0aW9uKGNhbGxiYWNrKSB7CgkgICAgICAgIHJldHVybiBrby51dGlscy5vYmplY3RNYXAoa28uZGVwZW5kZW5jeURldGVjdGlvbi5pZ25vcmUoY2FsbGJhY2spLCBmdW5jdGlvbih2YWx1ZSwga2V5KSB7CgkgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CgkgICAgICAgICAgICAgICAgcmV0dXJuIGNhbGxiYWNrKClba2V5XTsKCSAgICAgICAgICAgIH07CgkgICAgICAgIH0pOwoJICAgIH0KCgkgICAgLy8gR2l2ZW4gYSBiaW5kaW5ncyBmdW5jdGlvbiBvciBvYmplY3QsIGNyZWF0ZSBhbmQgcmV0dXJuIGEgbmV3IG9iamVjdCB0aGF0IGNvbnRhaW5zCgkgICAgLy8gYmluZGluZyB2YWx1ZS1hY2Nlc3NvcnMgZnVuY3Rpb25zLiBUaGlzIGlzIHVzZWQgYnkga28uYXBwbHlCaW5kaW5nc1RvTm9kZS4KCSAgICBmdW5jdGlvbiBtYWtlQmluZGluZ0FjY2Vzc29ycyhiaW5kaW5ncywgY29udGV4dCwgbm9kZSkgewoJICAgICAgICBpZiAodHlwZW9mIGJpbmRpbmdzID09PSAnZnVuY3Rpb24nKSB7CgkgICAgICAgICAgICByZXR1cm4gbWFrZUFjY2Vzc29yc0Zyb21GdW5jdGlvbihiaW5kaW5ncy5iaW5kKG51bGwsIGNvbnRleHQsIG5vZGUpKTsKCSAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgIHJldHVybiBrby51dGlscy5vYmplY3RNYXAoYmluZGluZ3MsIG1ha2VWYWx1ZUFjY2Vzc29yKTsKCSAgICAgICAgfQoJICAgIH0KCgkgICAgLy8gVGhpcyBmdW5jdGlvbiBpcyB1c2VkIGlmIHRoZSBiaW5kaW5nIHByb3ZpZGVyIGRvZXNuJ3QgaW5jbHVkZSBhIGdldEJpbmRpbmdBY2Nlc3NvcnMgZnVuY3Rpb24uCgkgICAgLy8gSXQgbXVzdCBiZSBjYWxsZWQgd2l0aCAndGhpcycgc2V0IHRvIHRoZSBwcm92aWRlciBpbnN0YW5jZS4KCSAgICBmdW5jdGlvbiBnZXRCaW5kaW5nc0FuZE1ha2VBY2Nlc3NvcnMobm9kZSwgY29udGV4dCkgewoJICAgICAgICByZXR1cm4gbWFrZUFjY2Vzc29yc0Zyb21GdW5jdGlvbih0aGlzWydnZXRCaW5kaW5ncyddLmJpbmQodGhpcywgbm9kZSwgY29udGV4dCkpOwoJICAgIH0KCgkgICAgZnVuY3Rpb24gdmFsaWRhdGVUaGF0QmluZGluZ0lzQWxsb3dlZEZvclZpcnR1YWxFbGVtZW50cyhiaW5kaW5nTmFtZSkgewoJICAgICAgICB2YXIgdmFsaWRhdG9yID0ga28udmlydHVhbEVsZW1lbnRzLmFsbG93ZWRCaW5kaW5nc1tiaW5kaW5nTmFtZV07CgkgICAgICAgIGlmICghdmFsaWRhdG9yKQoJICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUaGUgYmluZGluZyAnIiArIGJpbmRpbmdOYW1lICsgIicgY2Fubm90IGJlIHVzZWQgd2l0aCB2aXJ0dWFsIGVsZW1lbnRzIikKCSAgICB9CgoJICAgIGZ1bmN0aW9uIGFwcGx5QmluZGluZ3NUb0Rlc2NlbmRhbnRzSW50ZXJuYWwgKGJpbmRpbmdDb250ZXh0LCBlbGVtZW50T3JWaXJ0dWFsRWxlbWVudCwgYmluZGluZ0NvbnRleHRzTWF5RGlmZmVyRnJvbURvbVBhcmVudEVsZW1lbnQpIHsKCSAgICAgICAgdmFyIGN1cnJlbnRDaGlsZCwKCSAgICAgICAgICAgIG5leHRJblF1ZXVlID0ga28udmlydHVhbEVsZW1lbnRzLmZpcnN0Q2hpbGQoZWxlbWVudE9yVmlydHVhbEVsZW1lbnQpLAoJICAgICAgICAgICAgcHJvdmlkZXIgPSBrby5iaW5kaW5nUHJvdmlkZXJbJ2luc3RhbmNlJ10sCgkgICAgICAgICAgICBwcmVwcm9jZXNzTm9kZSA9IHByb3ZpZGVyWydwcmVwcm9jZXNzTm9kZSddOwoKCSAgICAgICAgLy8gUHJlcHJvY2Vzc2luZyBhbGxvd3MgYSBiaW5kaW5nIHByb3ZpZGVyIHRvIG11dGF0ZSBhIG5vZGUgYmVmb3JlIGJpbmRpbmdzIGFyZSBhcHBsaWVkIHRvIGl0LiBGb3IgZXhhbXBsZSBpdCdzCgkgICAgICAgIC8vIHBvc3NpYmxlIHRvIGluc2VydCBuZXcgc2libGluZ3MgYWZ0ZXIgaXQsIGFuZC9vciByZXBsYWNlIHRoZSBub2RlIHdpdGggYSBkaWZmZXJlbnQgb25lLiBUaGlzIGNhbiBiZSB1c2VkIHRvCgkgICAgICAgIC8vIGltcGxlbWVudCBjdXN0b20gYmluZGluZyBzeW50YXhlcywgc3VjaCBhcyB7eyB2YWx1ZSB9fSBmb3Igc3RyaW5nIGludGVycG9sYXRpb24sIG9yIGN1c3RvbSBlbGVtZW50IHR5cGVzIHRoYXQKCSAgICAgICAgLy8gdHJpZ2dlciBpbnNlcnRpb24gb2YgPHRlbXBsYXRlPiBjb250ZW50cyBhdCB0aGF0IHBvaW50IGluIHRoZSBkb2N1bWVudC4KCSAgICAgICAgaWYgKHByZXByb2Nlc3NOb2RlKSB7CgkgICAgICAgICAgICB3aGlsZSAoY3VycmVudENoaWxkID0gbmV4dEluUXVldWUpIHsKCSAgICAgICAgICAgICAgICBuZXh0SW5RdWV1ZSA9IGtvLnZpcnR1YWxFbGVtZW50cy5uZXh0U2libGluZyhjdXJyZW50Q2hpbGQpOwoJICAgICAgICAgICAgICAgIHByZXByb2Nlc3NOb2RlLmNhbGwocHJvdmlkZXIsIGN1cnJlbnRDaGlsZCk7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICAvLyBSZXNldCBuZXh0SW5RdWV1ZSBmb3IgdGhlIG5leHQgbG9vcAoJICAgICAgICAgICAgbmV4dEluUXVldWUgPSBrby52aXJ0dWFsRWxlbWVudHMuZmlyc3RDaGlsZChlbGVtZW50T3JWaXJ0dWFsRWxlbWVudCk7CgkgICAgICAgIH0KCgkgICAgICAgIHdoaWxlIChjdXJyZW50Q2hpbGQgPSBuZXh0SW5RdWV1ZSkgewoJICAgICAgICAgICAgLy8gS2VlcCBhIHJlY29yZCBvZiB0aGUgbmV4dCBjaGlsZCAqYmVmb3JlKiBhcHBseWluZyBiaW5kaW5ncywgaW4gY2FzZSB0aGUgYmluZGluZyByZW1vdmVzIHRoZSBjdXJyZW50IGNoaWxkIGZyb20gaXRzIHBvc2l0aW9uCgkgICAgICAgICAgICBuZXh0SW5RdWV1ZSA9IGtvLnZpcnR1YWxFbGVtZW50cy5uZXh0U2libGluZyhjdXJyZW50Q2hpbGQpOwoJICAgICAgICAgICAgYXBwbHlCaW5kaW5nc1RvTm9kZUFuZERlc2NlbmRhbnRzSW50ZXJuYWwoYmluZGluZ0NvbnRleHQsIGN1cnJlbnRDaGlsZCwgYmluZGluZ0NvbnRleHRzTWF5RGlmZmVyRnJvbURvbVBhcmVudEVsZW1lbnQpOwoJICAgICAgICB9CgkgICAgfQoKCSAgICBmdW5jdGlvbiBhcHBseUJpbmRpbmdzVG9Ob2RlQW5kRGVzY2VuZGFudHNJbnRlcm5hbCAoYmluZGluZ0NvbnRleHQsIG5vZGVWZXJpZmllZCwgYmluZGluZ0NvbnRleHRNYXlEaWZmZXJGcm9tRG9tUGFyZW50RWxlbWVudCkgewoJICAgICAgICB2YXIgc2hvdWxkQmluZERlc2NlbmRhbnRzID0gdHJ1ZTsKCgkgICAgICAgIC8vIFBlcmYgb3B0aW1pc2F0aW9uOiBBcHBseSBiaW5kaW5ncyBvbmx5IGlmLi4uCgkgICAgICAgIC8vICgxKSBXZSBuZWVkIHRvIHN0b3JlIHRoZSBiaW5kaW5nIGNvbnRleHQgb24gdGhpcyBub2RlIChiZWNhdXNlIGl0IG1heSBkaWZmZXIgZnJvbSB0aGUgRE9NIHBhcmVudCBub2RlJ3MgYmluZGluZyBjb250ZXh0KQoJICAgICAgICAvLyAgICAgTm90ZSB0aGF0IHdlIGNhbid0IHN0b3JlIGJpbmRpbmcgY29udGV4dHMgb24gbm9uLWVsZW1lbnRzIChlLmcuLCB0ZXh0IG5vZGVzKSwgYXMgSUUgZG9lc24ndCBhbGxvdyBleHBhbmRvIHByb3BlcnRpZXMgZm9yIHRob3NlCgkgICAgICAgIC8vICgyKSBJdCBtaWdodCBoYXZlIGJpbmRpbmdzIChlLmcuLCBpdCBoYXMgYSBkYXRhLWJpbmQgYXR0cmlidXRlLCBvciBpdCdzIGEgbWFya2VyIGZvciBhIGNvbnRhaW5lcmxlc3MgdGVtcGxhdGUpCgkgICAgICAgIHZhciBpc0VsZW1lbnQgPSAobm9kZVZlcmlmaWVkLm5vZGVUeXBlID09PSAxKTsKCSAgICAgICAgaWYgKGlzRWxlbWVudCkgLy8gV29ya2Fyb3VuZCBJRSA8PSA4IEhUTUwgcGFyc2luZyB3ZWlyZG5lc3MKCSAgICAgICAgICAgIGtvLnZpcnR1YWxFbGVtZW50cy5ub3JtYWxpc2VWaXJ0dWFsRWxlbWVudERvbVN0cnVjdHVyZShub2RlVmVyaWZpZWQpOwoKCSAgICAgICAgdmFyIHNob3VsZEFwcGx5QmluZGluZ3MgPSAoaXNFbGVtZW50ICYmIGJpbmRpbmdDb250ZXh0TWF5RGlmZmVyRnJvbURvbVBhcmVudEVsZW1lbnQpICAgICAgICAgICAgIC8vIENhc2UgKDEpCgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfHwga28uYmluZGluZ1Byb3ZpZGVyWydpbnN0YW5jZSddWydub2RlSGFzQmluZGluZ3MnXShub2RlVmVyaWZpZWQpOyAgICAgICAvLyBDYXNlICgyKQoJICAgICAgICBpZiAoc2hvdWxkQXBwbHlCaW5kaW5ncykKCSAgICAgICAgICAgIHNob3VsZEJpbmREZXNjZW5kYW50cyA9IGFwcGx5QmluZGluZ3NUb05vZGVJbnRlcm5hbChub2RlVmVyaWZpZWQsIG51bGwsIGJpbmRpbmdDb250ZXh0LCBiaW5kaW5nQ29udGV4dE1heURpZmZlckZyb21Eb21QYXJlbnRFbGVtZW50KVsnc2hvdWxkQmluZERlc2NlbmRhbnRzJ107CgoJICAgICAgICBpZiAoc2hvdWxkQmluZERlc2NlbmRhbnRzICYmICFiaW5kaW5nRG9lc05vdFJlY3Vyc2VJbnRvRWxlbWVudFR5cGVzW2tvLnV0aWxzLnRhZ05hbWVMb3dlcihub2RlVmVyaWZpZWQpXSkgewoJICAgICAgICAgICAgLy8gV2UncmUgcmVjdXJzaW5nIGF1dG9tYXRpY2FsbHkgaW50byAocmVhbCBvciB2aXJ0dWFsKSBjaGlsZCBub2RlcyB3aXRob3V0IGNoYW5naW5nIGJpbmRpbmcgY29udGV4dHMuIFNvLAoJICAgICAgICAgICAgLy8gICogRm9yIGNoaWxkcmVuIG9mIGEgKnJlYWwqIGVsZW1lbnQsIHRoZSBiaW5kaW5nIGNvbnRleHQgaXMgY2VydGFpbmx5IHRoZSBzYW1lIGFzIG9uIHRoZWlyIERPTSAucGFyZW50Tm9kZSwKCSAgICAgICAgICAgIC8vICAgIGhlbmNlIGJpbmRpbmdDb250ZXh0c01heURpZmZlckZyb21Eb21QYXJlbnRFbGVtZW50IGlzIGZhbHNlCgkgICAgICAgICAgICAvLyAgKiBGb3IgY2hpbGRyZW4gb2YgYSAqdmlydHVhbCogZWxlbWVudCwgd2UgY2FuJ3QgYmUgc3VyZS4gRXZhbHVhdGluZyAucGFyZW50Tm9kZSBvbiB0aG9zZSBjaGlsZHJlbiBtYXkKCSAgICAgICAgICAgIC8vICAgIHNraXAgb3ZlciBhbnkgbnVtYmVyIG9mIGludGVybWVkaWF0ZSB2aXJ0dWFsIGVsZW1lbnRzLCBhbnkgb2Ygd2hpY2ggbWlnaHQgZGVmaW5lIGEgY3VzdG9tIGJpbmRpbmcgY29udGV4dCwKCSAgICAgICAgICAgIC8vICAgIGhlbmNlIGJpbmRpbmdDb250ZXh0c01heURpZmZlckZyb21Eb21QYXJlbnRFbGVtZW50IGlzIHRydWUKCSAgICAgICAgICAgIGFwcGx5QmluZGluZ3NUb0Rlc2NlbmRhbnRzSW50ZXJuYWwoYmluZGluZ0NvbnRleHQsIG5vZGVWZXJpZmllZCwgLyogYmluZGluZ0NvbnRleHRzTWF5RGlmZmVyRnJvbURvbVBhcmVudEVsZW1lbnQ6ICovICFpc0VsZW1lbnQpOwoJICAgICAgICB9CgkgICAgfQoKCSAgICB2YXIgYm91bmRFbGVtZW50RG9tRGF0YUtleSA9IGtvLnV0aWxzLmRvbURhdGEubmV4dEtleSgpOwoKCgkgICAgZnVuY3Rpb24gdG9wb2xvZ2ljYWxTb3J0QmluZGluZ3MoYmluZGluZ3MpIHsKCSAgICAgICAgLy8gRGVwdGgtZmlyc3Qgc29ydAoJICAgICAgICB2YXIgcmVzdWx0ID0gW10sICAgICAgICAgICAgICAgIC8vIFRoZSBsaXN0IG9mIGtleS9oYW5kbGVyIHBhaXJzIHRoYXQgd2Ugd2lsbCByZXR1cm4KCSAgICAgICAgICAgIGJpbmRpbmdzQ29uc2lkZXJlZCA9IHt9LCAgICAvLyBBIHRlbXBvcmFyeSByZWNvcmQgb2Ygd2hpY2ggYmluZGluZ3MgYXJlIGFscmVhZHkgaW4gJ3Jlc3VsdCcKCSAgICAgICAgICAgIGN5Y2xpY0RlcGVuZGVuY3lTdGFjayA9IFtdOyAvLyBLZWVwcyB0cmFjayBvZiBhIGRlcHRoLXNlYXJjaCBzbyB0aGF0LCBpZiB0aGVyZSdzIGEgY3ljbGUsIHdlIGtub3cgd2hpY2ggYmluZGluZ3MgY2F1c2VkIGl0CgkgICAgICAgIGtvLnV0aWxzLm9iamVjdEZvckVhY2goYmluZGluZ3MsIGZ1bmN0aW9uIHB1c2hCaW5kaW5nKGJpbmRpbmdLZXkpIHsKCSAgICAgICAgICAgIGlmICghYmluZGluZ3NDb25zaWRlcmVkW2JpbmRpbmdLZXldKSB7CgkgICAgICAgICAgICAgICAgdmFyIGJpbmRpbmcgPSBrb1snZ2V0QmluZGluZ0hhbmRsZXInXShiaW5kaW5nS2V5KTsKCSAgICAgICAgICAgICAgICBpZiAoYmluZGluZykgewoJICAgICAgICAgICAgICAgICAgICAvLyBGaXJzdCBhZGQgZGVwZW5kZW5jaWVzIChpZiBhbnkpIG9mIHRoZSBjdXJyZW50IGJpbmRpbmcKCSAgICAgICAgICAgICAgICAgICAgaWYgKGJpbmRpbmdbJ2FmdGVyJ10pIHsKCSAgICAgICAgICAgICAgICAgICAgICAgIGN5Y2xpY0RlcGVuZGVuY3lTdGFjay5wdXNoKGJpbmRpbmdLZXkpOwoJICAgICAgICAgICAgICAgICAgICAgICAga28udXRpbHMuYXJyYXlGb3JFYWNoKGJpbmRpbmdbJ2FmdGVyJ10sIGZ1bmN0aW9uKGJpbmRpbmdEZXBlbmRlbmN5S2V5KSB7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGJpbmRpbmdzW2JpbmRpbmdEZXBlbmRlbmN5S2V5XSkgewoJICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoa28udXRpbHMuYXJyYXlJbmRleE9mKGN5Y2xpY0RlcGVuZGVuY3lTdGFjaywgYmluZGluZ0RlcGVuZGVuY3lLZXkpICE9PSAtMSkgewoJICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoIkNhbm5vdCBjb21iaW5lIHRoZSBmb2xsb3dpbmcgYmluZGluZ3MsIGJlY2F1c2UgdGhleSBoYXZlIGEgY3ljbGljIGRlcGVuZGVuY3k6ICIgKyBjeWNsaWNEZXBlbmRlbmN5U3RhY2suam9pbigiLCAiKSk7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwdXNoQmluZGluZyhiaW5kaW5nRGVwZW5kZW5jeUtleSk7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgICAgICAgICB9KTsKCSAgICAgICAgICAgICAgICAgICAgICAgIGN5Y2xpY0RlcGVuZGVuY3lTdGFjay5sZW5ndGgtLTsKCSAgICAgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgICAgICAvLyBOZXh0IGFkZCB0aGUgY3VycmVudCBiaW5kaW5nCgkgICAgICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKHsga2V5OiBiaW5kaW5nS2V5LCBoYW5kbGVyOiBiaW5kaW5nIH0pOwoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICBiaW5kaW5nc0NvbnNpZGVyZWRbYmluZGluZ0tleV0gPSB0cnVlOwoJICAgICAgICAgICAgfQoJICAgICAgICB9KTsKCgkgICAgICAgIHJldHVybiByZXN1bHQ7CgkgICAgfQoKCSAgICBmdW5jdGlvbiBhcHBseUJpbmRpbmdzVG9Ob2RlSW50ZXJuYWwobm9kZSwgc291cmNlQmluZGluZ3MsIGJpbmRpbmdDb250ZXh0LCBiaW5kaW5nQ29udGV4dE1heURpZmZlckZyb21Eb21QYXJlbnRFbGVtZW50KSB7CgkgICAgICAgIC8vIFByZXZlbnQgbXVsdGlwbGUgYXBwbHlCaW5kaW5ncyBjYWxscyBmb3IgdGhlIHNhbWUgbm9kZSwgZXhjZXB0IHdoZW4gYSBiaW5kaW5nIHZhbHVlIGlzIHNwZWNpZmllZAoJICAgICAgICB2YXIgYWxyZWFkeUJvdW5kID0ga28udXRpbHMuZG9tRGF0YS5nZXQobm9kZSwgYm91bmRFbGVtZW50RG9tRGF0YUtleSk7CgkgICAgICAgIGlmICghc291cmNlQmluZGluZ3MpIHsKCSAgICAgICAgICAgIGlmIChhbHJlYWR5Qm91bmQpIHsKCSAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcigiWW91IGNhbm5vdCBhcHBseSBiaW5kaW5ncyBtdWx0aXBsZSB0aW1lcyB0byB0aGUgc2FtZSBlbGVtZW50LiIpOwoJICAgICAgICAgICAgfQoJICAgICAgICAgICAga28udXRpbHMuZG9tRGF0YS5zZXQobm9kZSwgYm91bmRFbGVtZW50RG9tRGF0YUtleSwgdHJ1ZSk7CgkgICAgICAgIH0KCgkgICAgICAgIC8vIE9wdGltaXphdGlvbjogRG9uJ3Qgc3RvcmUgdGhlIGJpbmRpbmcgY29udGV4dCBvbiB0aGlzIG5vZGUgaWYgaXQncyBkZWZpbml0ZWx5IHRoZSBzYW1lIGFzIG9uIG5vZGUucGFyZW50Tm9kZSwgYmVjYXVzZQoJICAgICAgICAvLyB3ZSBjYW4gZWFzaWx5IHJlY292ZXIgaXQganVzdCBieSBzY2FubmluZyB1cCB0aGUgbm9kZSdzIGFuY2VzdG9ycyBpbiB0aGUgRE9NCgkgICAgICAgIC8vIChub3RlOiBoZXJlLCBwYXJlbnQgbm9kZSBtZWFucyAicmVhbCBET00gcGFyZW50IiBub3QgInZpcnR1YWwgcGFyZW50IiwgYXMgdGhlcmUncyBubyBPKDEpIHdheSB0byBmaW5kIHRoZSB2aXJ0dWFsIHBhcmVudCkKCSAgICAgICAgaWYgKCFhbHJlYWR5Qm91bmQgJiYgYmluZGluZ0NvbnRleHRNYXlEaWZmZXJGcm9tRG9tUGFyZW50RWxlbWVudCkKCSAgICAgICAgICAgIGtvLnN0b3JlZEJpbmRpbmdDb250ZXh0Rm9yTm9kZShub2RlLCBiaW5kaW5nQ29udGV4dCk7CgoJICAgICAgICAvLyBVc2UgYmluZGluZ3MgaWYgZ2l2ZW4sIG90aGVyd2lzZSBmYWxsIGJhY2sgb24gYXNraW5nIHRoZSBiaW5kaW5ncyBwcm92aWRlciB0byBnaXZlIHVzIHNvbWUgYmluZGluZ3MKCSAgICAgICAgdmFyIGJpbmRpbmdzOwoJICAgICAgICBpZiAoc291cmNlQmluZGluZ3MgJiYgdHlwZW9mIHNvdXJjZUJpbmRpbmdzICE9PSAnZnVuY3Rpb24nKSB7CgkgICAgICAgICAgICBiaW5kaW5ncyA9IHNvdXJjZUJpbmRpbmdzOwoJICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgdmFyIHByb3ZpZGVyID0ga28uYmluZGluZ1Byb3ZpZGVyWydpbnN0YW5jZSddLAoJICAgICAgICAgICAgICAgIGdldEJpbmRpbmdzID0gcHJvdmlkZXJbJ2dldEJpbmRpbmdBY2Nlc3NvcnMnXSB8fCBnZXRCaW5kaW5nc0FuZE1ha2VBY2Nlc3NvcnM7CgoJICAgICAgICAgICAgLy8gR2V0IHRoZSBiaW5kaW5nIGZyb20gdGhlIHByb3ZpZGVyIHdpdGhpbiBhIGNvbXB1dGVkIG9ic2VydmFibGUgc28gdGhhdCB3ZSBjYW4gdXBkYXRlIHRoZSBiaW5kaW5ncyB3aGVuZXZlcgoJICAgICAgICAgICAgLy8gdGhlIGJpbmRpbmcgY29udGV4dCBpcyB1cGRhdGVkIG9yIGlmIHRoZSBiaW5kaW5nIHByb3ZpZGVyIGFjY2Vzc2VzIG9ic2VydmFibGVzLgoJICAgICAgICAgICAgdmFyIGJpbmRpbmdzVXBkYXRlciA9IGtvLmRlcGVuZGVudE9ic2VydmFibGUoCgkgICAgICAgICAgICAgICAgZnVuY3Rpb24oKSB7CgkgICAgICAgICAgICAgICAgICAgIGJpbmRpbmdzID0gc291cmNlQmluZGluZ3MgPyBzb3VyY2VCaW5kaW5ncyhiaW5kaW5nQ29udGV4dCwgbm9kZSkgOiBnZXRCaW5kaW5ncy5jYWxsKHByb3ZpZGVyLCBub2RlLCBiaW5kaW5nQ29udGV4dCk7CgkgICAgICAgICAgICAgICAgICAgIC8vIFJlZ2lzdGVyIGEgZGVwZW5kZW5jeSBvbiB0aGUgYmluZGluZyBjb250ZXh0IHRvIHN1cHBvcnQgb2JzZXZhYmxlIHZpZXcgbW9kZWxzLgoJICAgICAgICAgICAgICAgICAgICBpZiAoYmluZGluZ3MgJiYgYmluZGluZ0NvbnRleHQuX3N1YnNjcmliYWJsZSkKCSAgICAgICAgICAgICAgICAgICAgICAgIGJpbmRpbmdDb250ZXh0Ll9zdWJzY3JpYmFibGUoKTsKCSAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGJpbmRpbmdzOwoJICAgICAgICAgICAgICAgIH0sCgkgICAgICAgICAgICAgICAgbnVsbCwgeyBkaXNwb3NlV2hlbk5vZGVJc1JlbW92ZWQ6IG5vZGUgfQoJICAgICAgICAgICAgKTsKCgkgICAgICAgICAgICBpZiAoIWJpbmRpbmdzIHx8ICFiaW5kaW5nc1VwZGF0ZXIuaXNBY3RpdmUoKSkKCSAgICAgICAgICAgICAgICBiaW5kaW5nc1VwZGF0ZXIgPSBudWxsOwoJICAgICAgICB9CgoJICAgICAgICB2YXIgYmluZGluZ0hhbmRsZXJUaGF0Q29udHJvbHNEZXNjZW5kYW50QmluZGluZ3M7CgkgICAgICAgIGlmIChiaW5kaW5ncykgewoJICAgICAgICAgICAgLy8gUmV0dXJuIHRoZSB2YWx1ZSBhY2Nlc3NvciBmb3IgYSBnaXZlbiBiaW5kaW5nLiBXaGVuIGJpbmRpbmdzIGFyZSBzdGF0aWMgKHdvbid0IGJlIHVwZGF0ZWQgYmVjYXVzZSBvZiBhIGJpbmRpbmcKCSAgICAgICAgICAgIC8vIGNvbnRleHQgdXBkYXRlKSwganVzdCByZXR1cm4gdGhlIHZhbHVlIGFjY2Vzc29yIGZyb20gdGhlIGJpbmRpbmcuIE90aGVyd2lzZSwgcmV0dXJuIGEgZnVuY3Rpb24gdGhhdCBhbHdheXMgZ2V0cwoJICAgICAgICAgICAgLy8gdGhlIGxhdGVzdCBiaW5kaW5nIHZhbHVlIGFuZCByZWdpc3RlcnMgYSBkZXBlbmRlbmN5IG9uIHRoZSBiaW5kaW5nIHVwZGF0ZXIuCgkgICAgICAgICAgICB2YXIgZ2V0VmFsdWVBY2Nlc3NvciA9IGJpbmRpbmdzVXBkYXRlcgoJICAgICAgICAgICAgICAgID8gZnVuY3Rpb24oYmluZGluZ0tleSkgewoJICAgICAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CgkgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZXZhbHVhdGVWYWx1ZUFjY2Vzc29yKGJpbmRpbmdzVXBkYXRlcigpW2JpbmRpbmdLZXldKTsKCSAgICAgICAgICAgICAgICAgICAgfTsKCSAgICAgICAgICAgICAgICB9IDogZnVuY3Rpb24oYmluZGluZ0tleSkgewoJICAgICAgICAgICAgICAgICAgICByZXR1cm4gYmluZGluZ3NbYmluZGluZ0tleV07CgkgICAgICAgICAgICAgICAgfTsKCgkgICAgICAgICAgICAvLyBVc2Ugb2YgYWxsQmluZGluZ3MgYXMgYSBmdW5jdGlvbiBpcyBtYWludGFpbmVkIGZvciBiYWNrd2FyZHMgY29tcGF0aWJpbGl0eSwgYnV0IGl0cyB1c2UgaXMgZGVwcmVjYXRlZAoJICAgICAgICAgICAgZnVuY3Rpb24gYWxsQmluZGluZ3MoKSB7CgkgICAgICAgICAgICAgICAgcmV0dXJuIGtvLnV0aWxzLm9iamVjdE1hcChiaW5kaW5nc1VwZGF0ZXIgPyBiaW5kaW5nc1VwZGF0ZXIoKSA6IGJpbmRpbmdzLCBldmFsdWF0ZVZhbHVlQWNjZXNzb3IpOwoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgLy8gVGhlIGZvbGxvd2luZyBpcyB0aGUgMy54IGFsbEJpbmRpbmdzIEFQSQoJICAgICAgICAgICAgYWxsQmluZGluZ3NbJ2dldCddID0gZnVuY3Rpb24oa2V5KSB7CgkgICAgICAgICAgICAgICAgcmV0dXJuIGJpbmRpbmdzW2tleV0gJiYgZXZhbHVhdGVWYWx1ZUFjY2Vzc29yKGdldFZhbHVlQWNjZXNzb3Ioa2V5KSk7CgkgICAgICAgICAgICB9OwoJICAgICAgICAgICAgYWxsQmluZGluZ3NbJ2hhcyddID0gZnVuY3Rpb24oa2V5KSB7CgkgICAgICAgICAgICAgICAgcmV0dXJuIGtleSBpbiBiaW5kaW5nczsKCSAgICAgICAgICAgIH07CgoJICAgICAgICAgICAgLy8gRmlyc3QgcHV0IHRoZSBiaW5kaW5ncyBpbnRvIHRoZSByaWdodCBvcmRlcgoJICAgICAgICAgICAgdmFyIG9yZGVyZWRCaW5kaW5ncyA9IHRvcG9sb2dpY2FsU29ydEJpbmRpbmdzKGJpbmRpbmdzKTsKCgkgICAgICAgICAgICAvLyBHbyB0aHJvdWdoIHRoZSBzb3J0ZWQgYmluZGluZ3MsIGNhbGxpbmcgaW5pdCBhbmQgdXBkYXRlIGZvciBlYWNoCgkgICAgICAgICAgICBrby51dGlscy5hcnJheUZvckVhY2gob3JkZXJlZEJpbmRpbmdzLCBmdW5jdGlvbihiaW5kaW5nS2V5QW5kSGFuZGxlcikgewoJICAgICAgICAgICAgICAgIC8vIE5vdGUgdGhhdCB0b3BvbG9naWNhbFNvcnRCaW5kaW5ncyBoYXMgYWxyZWFkeSBmaWx0ZXJlZCBvdXQgYW55IG5vbmV4aXN0ZW50IGJpbmRpbmcgaGFuZGxlcnMsCgkgICAgICAgICAgICAgICAgLy8gc28gYmluZGluZ0tleUFuZEhhbmRsZXIuaGFuZGxlciB3aWxsIGFsd2F5cyBiZSBub25udWxsLgoJICAgICAgICAgICAgICAgIHZhciBoYW5kbGVySW5pdEZuID0gYmluZGluZ0tleUFuZEhhbmRsZXIuaGFuZGxlclsiaW5pdCJdLAoJICAgICAgICAgICAgICAgICAgICBoYW5kbGVyVXBkYXRlRm4gPSBiaW5kaW5nS2V5QW5kSGFuZGxlci5oYW5kbGVyWyJ1cGRhdGUiXSwKCSAgICAgICAgICAgICAgICAgICAgYmluZGluZ0tleSA9IGJpbmRpbmdLZXlBbmRIYW5kbGVyLmtleTsKCgkgICAgICAgICAgICAgICAgaWYgKG5vZGUubm9kZVR5cGUgPT09IDgpIHsKCSAgICAgICAgICAgICAgICAgICAgdmFsaWRhdGVUaGF0QmluZGluZ0lzQWxsb3dlZEZvclZpcnR1YWxFbGVtZW50cyhiaW5kaW5nS2V5KTsKCSAgICAgICAgICAgICAgICB9CgoJICAgICAgICAgICAgICAgIHRyeSB7CgkgICAgICAgICAgICAgICAgICAgIC8vIFJ1biBpbml0LCBpZ25vcmluZyBhbnkgZGVwZW5kZW5jaWVzCgkgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgaGFuZGxlckluaXRGbiA9PSAiZnVuY3Rpb24iKSB7CgkgICAgICAgICAgICAgICAgICAgICAgICBrby5kZXBlbmRlbmN5RGV0ZWN0aW9uLmlnbm9yZShmdW5jdGlvbigpIHsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgaW5pdFJlc3VsdCA9IGhhbmRsZXJJbml0Rm4obm9kZSwgZ2V0VmFsdWVBY2Nlc3NvcihiaW5kaW5nS2V5KSwgYWxsQmluZGluZ3MsIGJpbmRpbmdDb250ZXh0WyckZGF0YSddLCBiaW5kaW5nQ29udGV4dCk7CgoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIElmIHRoaXMgYmluZGluZyBoYW5kbGVyIGNsYWltcyB0byBjb250cm9sIGRlc2NlbmRhbnQgYmluZGluZ3MsIG1ha2UgYSBub3RlIG9mIHRoaXMKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaW5pdFJlc3VsdCAmJiBpbml0UmVzdWx0Wydjb250cm9sc0Rlc2NlbmRhbnRCaW5kaW5ncyddKSB7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChiaW5kaW5nSGFuZGxlclRoYXRDb250cm9sc0Rlc2NlbmRhbnRCaW5kaW5ncyAhPT0gdW5kZWZpbmVkKQoJICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJNdWx0aXBsZSBiaW5kaW5ncyAoIiArIGJpbmRpbmdIYW5kbGVyVGhhdENvbnRyb2xzRGVzY2VuZGFudEJpbmRpbmdzICsgIiBhbmQgIiArIGJpbmRpbmdLZXkgKyAiKSBhcmUgdHJ5aW5nIHRvIGNvbnRyb2wgZGVzY2VuZGFudCBiaW5kaW5ncyBvZiB0aGUgc2FtZSBlbGVtZW50LiBZb3UgY2Fubm90IHVzZSB0aGVzZSBiaW5kaW5ncyB0b2dldGhlciBvbiB0aGUgc2FtZSBlbGVtZW50LiIpOwoJICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiaW5kaW5nSGFuZGxlclRoYXRDb250cm9sc0Rlc2NlbmRhbnRCaW5kaW5ncyA9IGJpbmRpbmdLZXk7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgICAgICAgICAgfSk7CgkgICAgICAgICAgICAgICAgICAgIH0KCgkgICAgICAgICAgICAgICAgICAgIC8vIFJ1biB1cGRhdGUgaW4gaXRzIG93biBjb21wdXRlZCB3cmFwcGVyCgkgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgaGFuZGxlclVwZGF0ZUZuID09ICJmdW5jdGlvbiIpIHsKCSAgICAgICAgICAgICAgICAgICAgICAgIGtvLmRlcGVuZGVudE9ic2VydmFibGUoCgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24oKSB7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhhbmRsZXJVcGRhdGVGbihub2RlLCBnZXRWYWx1ZUFjY2Vzc29yKGJpbmRpbmdLZXkpLCBhbGxCaW5kaW5ncywgYmluZGluZ0NvbnRleHRbJyRkYXRhJ10sIGJpbmRpbmdDb250ZXh0KTsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIG51bGwsCgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgeyBkaXNwb3NlV2hlbk5vZGVJc1JlbW92ZWQ6IG5vZGUgfQoJICAgICAgICAgICAgICAgICAgICAgICAgKTsKCSAgICAgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGV4KSB7CgkgICAgICAgICAgICAgICAgICAgIGV4Lm1lc3NhZ2UgPSAiVW5hYmxlIHRvIHByb2Nlc3MgYmluZGluZyBcIiIgKyBiaW5kaW5nS2V5ICsgIjogIiArIGJpbmRpbmdzW2JpbmRpbmdLZXldICsgIlwiXG5NZXNzYWdlOiAiICsgZXgubWVzc2FnZTsKCSAgICAgICAgICAgICAgICAgICAgdGhyb3cgZXg7CgkgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgfSk7CgkgICAgICAgIH0KCgkgICAgICAgIHJldHVybiB7CgkgICAgICAgICAgICAnc2hvdWxkQmluZERlc2NlbmRhbnRzJzogYmluZGluZ0hhbmRsZXJUaGF0Q29udHJvbHNEZXNjZW5kYW50QmluZGluZ3MgPT09IHVuZGVmaW5lZAoJICAgICAgICB9OwoJICAgIH07CgoJICAgIHZhciBzdG9yZWRCaW5kaW5nQ29udGV4dERvbURhdGFLZXkgPSBrby51dGlscy5kb21EYXRhLm5leHRLZXkoKTsKCSAgICBrby5zdG9yZWRCaW5kaW5nQ29udGV4dEZvck5vZGUgPSBmdW5jdGlvbiAobm9kZSwgYmluZGluZ0NvbnRleHQpIHsKCSAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT0gMikgewoJICAgICAgICAgICAga28udXRpbHMuZG9tRGF0YS5zZXQobm9kZSwgc3RvcmVkQmluZGluZ0NvbnRleHREb21EYXRhS2V5LCBiaW5kaW5nQ29udGV4dCk7CgkgICAgICAgICAgICBpZiAoYmluZGluZ0NvbnRleHQuX3N1YnNjcmliYWJsZSkKCSAgICAgICAgICAgICAgICBiaW5kaW5nQ29udGV4dC5fc3Vic2NyaWJhYmxlLl9hZGROb2RlKG5vZGUpOwoJICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgcmV0dXJuIGtvLnV0aWxzLmRvbURhdGEuZ2V0KG5vZGUsIHN0b3JlZEJpbmRpbmdDb250ZXh0RG9tRGF0YUtleSk7CgkgICAgICAgIH0KCSAgICB9CgoJICAgIGZ1bmN0aW9uIGdldEJpbmRpbmdDb250ZXh0KHZpZXdNb2RlbE9yQmluZGluZ0NvbnRleHQpIHsKCSAgICAgICAgcmV0dXJuIHZpZXdNb2RlbE9yQmluZGluZ0NvbnRleHQgJiYgKHZpZXdNb2RlbE9yQmluZGluZ0NvbnRleHQgaW5zdGFuY2VvZiBrby5iaW5kaW5nQ29udGV4dCkKCSAgICAgICAgICAgID8gdmlld01vZGVsT3JCaW5kaW5nQ29udGV4dAoJICAgICAgICAgICAgOiBuZXcga28uYmluZGluZ0NvbnRleHQodmlld01vZGVsT3JCaW5kaW5nQ29udGV4dCk7CgkgICAgfQoKCSAgICBrby5hcHBseUJpbmRpbmdBY2Nlc3NvcnNUb05vZGUgPSBmdW5jdGlvbiAobm9kZSwgYmluZGluZ3MsIHZpZXdNb2RlbE9yQmluZGluZ0NvbnRleHQpIHsKCSAgICAgICAgaWYgKG5vZGUubm9kZVR5cGUgPT09IDEpIC8vIElmIGl0J3MgYW4gZWxlbWVudCwgd29ya2Fyb3VuZCBJRSA8PSA4IEhUTUwgcGFyc2luZyB3ZWlyZG5lc3MKCSAgICAgICAgICAgIGtvLnZpcnR1YWxFbGVtZW50cy5ub3JtYWxpc2VWaXJ0dWFsRWxlbWVudERvbVN0cnVjdHVyZShub2RlKTsKCSAgICAgICAgcmV0dXJuIGFwcGx5QmluZGluZ3NUb05vZGVJbnRlcm5hbChub2RlLCBiaW5kaW5ncywgZ2V0QmluZGluZ0NvbnRleHQodmlld01vZGVsT3JCaW5kaW5nQ29udGV4dCksIHRydWUpOwoJICAgIH07CgoJICAgIGtvLmFwcGx5QmluZGluZ3NUb05vZGUgPSBmdW5jdGlvbiAobm9kZSwgYmluZGluZ3MsIHZpZXdNb2RlbE9yQmluZGluZ0NvbnRleHQpIHsKCSAgICAgICAgdmFyIGNvbnRleHQgPSBnZXRCaW5kaW5nQ29udGV4dCh2aWV3TW9kZWxPckJpbmRpbmdDb250ZXh0KTsKCSAgICAgICAgcmV0dXJuIGtvLmFwcGx5QmluZGluZ0FjY2Vzc29yc1RvTm9kZShub2RlLCBtYWtlQmluZGluZ0FjY2Vzc29ycyhiaW5kaW5ncywgY29udGV4dCwgbm9kZSksIGNvbnRleHQpOwoJICAgIH07CgoJICAgIGtvLmFwcGx5QmluZGluZ3NUb0Rlc2NlbmRhbnRzID0gZnVuY3Rpb24odmlld01vZGVsT3JCaW5kaW5nQ29udGV4dCwgcm9vdE5vZGUpIHsKCSAgICAgICAgaWYgKHJvb3ROb2RlLm5vZGVUeXBlID09PSAxIHx8IHJvb3ROb2RlLm5vZGVUeXBlID09PSA4KQoJICAgICAgICAgICAgYXBwbHlCaW5kaW5nc1RvRGVzY2VuZGFudHNJbnRlcm5hbChnZXRCaW5kaW5nQ29udGV4dCh2aWV3TW9kZWxPckJpbmRpbmdDb250ZXh0KSwgcm9vdE5vZGUsIHRydWUpOwoJICAgIH07CgoJICAgIGtvLmFwcGx5QmluZGluZ3MgPSBmdW5jdGlvbiAodmlld01vZGVsT3JCaW5kaW5nQ29udGV4dCwgcm9vdE5vZGUpIHsKCSAgICAgICAgLy8gSWYgalF1ZXJ5IGlzIGxvYWRlZCBhZnRlciBLbm9ja291dCwgd2Ugd29uJ3QgaW5pdGlhbGx5IGhhdmUgYWNjZXNzIHRvIGl0LiBTbyBzYXZlIGl0IGhlcmUuCgkgICAgICAgIGlmICghalF1ZXJ5SW5zdGFuY2UgJiYgd2luZG93WydqUXVlcnknXSkgewoJICAgICAgICAgICAgalF1ZXJ5SW5zdGFuY2UgPSB3aW5kb3dbJ2pRdWVyeSddOwoJICAgICAgICB9CgoJICAgICAgICBpZiAocm9vdE5vZGUgJiYgKHJvb3ROb2RlLm5vZGVUeXBlICE9PSAxKSAmJiAocm9vdE5vZGUubm9kZVR5cGUgIT09IDgpKQoJICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJrby5hcHBseUJpbmRpbmdzOiBmaXJzdCBwYXJhbWV0ZXIgc2hvdWxkIGJlIHlvdXIgdmlldyBtb2RlbDsgc2Vjb25kIHBhcmFtZXRlciBzaG91bGQgYmUgYSBET00gbm9kZSIpOwoJICAgICAgICByb290Tm9kZSA9IHJvb3ROb2RlIHx8IHdpbmRvdy5kb2N1bWVudC5ib2R5OyAvLyBNYWtlICJyb290Tm9kZSIgcGFyYW1ldGVyIG9wdGlvbmFsCgoJICAgICAgICBhcHBseUJpbmRpbmdzVG9Ob2RlQW5kRGVzY2VuZGFudHNJbnRlcm5hbChnZXRCaW5kaW5nQ29udGV4dCh2aWV3TW9kZWxPckJpbmRpbmdDb250ZXh0KSwgcm9vdE5vZGUsIHRydWUpOwoJICAgIH07CgoJICAgIC8vIFJldHJpZXZpbmcgYmluZGluZyBjb250ZXh0IGZyb20gYXJiaXRyYXJ5IG5vZGVzCgkgICAga28uY29udGV4dEZvciA9IGZ1bmN0aW9uKG5vZGUpIHsKCSAgICAgICAgLy8gV2UgY2FuIG9ubHkgZG8gc29tZXRoaW5nIG1lYW5pbmdmdWwgZm9yIGVsZW1lbnRzIGFuZCBjb21tZW50IG5vZGVzIChpbiBwYXJ0aWN1bGFyLCBub3QgdGV4dCBub2RlcywgYXMgSUUgY2FuJ3Qgc3RvcmUgZG9tZGF0YSBmb3IgdGhlbSkKCSAgICAgICAgc3dpdGNoIChub2RlLm5vZGVUeXBlKSB7CgkgICAgICAgICAgICBjYXNlIDE6CgkgICAgICAgICAgICBjYXNlIDg6CgkgICAgICAgICAgICAgICAgdmFyIGNvbnRleHQgPSBrby5zdG9yZWRCaW5kaW5nQ29udGV4dEZvck5vZGUobm9kZSk7CgkgICAgICAgICAgICAgICAgaWYgKGNvbnRleHQpIHJldHVybiBjb250ZXh0OwoJICAgICAgICAgICAgICAgIGlmIChub2RlLnBhcmVudE5vZGUpIHJldHVybiBrby5jb250ZXh0Rm9yKG5vZGUucGFyZW50Tm9kZSk7CgkgICAgICAgICAgICAgICAgYnJlYWs7CgkgICAgICAgIH0KCSAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKCSAgICB9OwoJICAgIGtvLmRhdGFGb3IgPSBmdW5jdGlvbihub2RlKSB7CgkgICAgICAgIHZhciBjb250ZXh0ID0ga28uY29udGV4dEZvcihub2RlKTsKCSAgICAgICAgcmV0dXJuIGNvbnRleHQgPyBjb250ZXh0WyckZGF0YSddIDogdW5kZWZpbmVkOwoJICAgIH07CgoJICAgIGtvLmV4cG9ydFN5bWJvbCgnYmluZGluZ0hhbmRsZXJzJywga28uYmluZGluZ0hhbmRsZXJzKTsKCSAgICBrby5leHBvcnRTeW1ib2woJ2FwcGx5QmluZGluZ3MnLCBrby5hcHBseUJpbmRpbmdzKTsKCSAgICBrby5leHBvcnRTeW1ib2woJ2FwcGx5QmluZGluZ3NUb0Rlc2NlbmRhbnRzJywga28uYXBwbHlCaW5kaW5nc1RvRGVzY2VuZGFudHMpOwoJICAgIGtvLmV4cG9ydFN5bWJvbCgnYXBwbHlCaW5kaW5nQWNjZXNzb3JzVG9Ob2RlJywga28uYXBwbHlCaW5kaW5nQWNjZXNzb3JzVG9Ob2RlKTsKCSAgICBrby5leHBvcnRTeW1ib2woJ2FwcGx5QmluZGluZ3NUb05vZGUnLCBrby5hcHBseUJpbmRpbmdzVG9Ob2RlKTsKCSAgICBrby5leHBvcnRTeW1ib2woJ2NvbnRleHRGb3InLCBrby5jb250ZXh0Rm9yKTsKCSAgICBrby5leHBvcnRTeW1ib2woJ2RhdGFGb3InLCBrby5kYXRhRm9yKTsKCX0pKCk7CgkoZnVuY3Rpb24odW5kZWZpbmVkKSB7CgkgICAgdmFyIGxvYWRpbmdTdWJzY3JpYmFibGVzQ2FjaGUgPSB7fSwgLy8gVHJhY2tzIGNvbXBvbmVudCBsb2FkcyB0aGF0IGFyZSBjdXJyZW50bHkgaW4gZmxpZ2h0CgkgICAgICAgIGxvYWRlZERlZmluaXRpb25zQ2FjaGUgPSB7fTsgICAgLy8gVHJhY2tzIGNvbXBvbmVudCBsb2FkcyB0aGF0IGhhdmUgYWxyZWFkeSBjb21wbGV0ZWQKCgkgICAga28uY29tcG9uZW50cyA9IHsKCSAgICAgICAgZ2V0OiBmdW5jdGlvbihjb21wb25lbnROYW1lLCBjYWxsYmFjaykgewoJICAgICAgICAgICAgdmFyIGNhY2hlZERlZmluaXRpb24gPSBnZXRPYmplY3RPd25Qcm9wZXJ0eShsb2FkZWREZWZpbml0aW9uc0NhY2hlLCBjb21wb25lbnROYW1lKTsKCSAgICAgICAgICAgIGlmIChjYWNoZWREZWZpbml0aW9uKSB7CgkgICAgICAgICAgICAgICAgLy8gSXQncyBhbHJlYWR5IGxvYWRlZCBhbmQgY2FjaGVkLiBSZXVzZSB0aGUgc2FtZSBkZWZpbml0aW9uIG9iamVjdC4KCSAgICAgICAgICAgICAgICAvLyBOb3RlIHRoYXQgZm9yIEFQSSBjb25zaXN0ZW5jeSwgZXZlbiBjYWNoZSBoaXRzIGNvbXBsZXRlIGFzeW5jaHJvbm91c2x5LgoJICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7IGNhbGxiYWNrKGNhY2hlZERlZmluaXRpb24pIH0sIDApOwoJICAgICAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgICAgICAvLyBKb2luIHRoZSBsb2FkaW5nIHByb2Nlc3MgdGhhdCBpcyBhbHJlYWR5IHVuZGVyd2F5LCBvciBzdGFydCBhIG5ldyBvbmUuCgkgICAgICAgICAgICAgICAgbG9hZENvbXBvbmVudEFuZE5vdGlmeShjb21wb25lbnROYW1lLCBjYWxsYmFjayk7CgkgICAgICAgICAgICB9CgkgICAgICAgIH0sCgoJICAgICAgICBjbGVhckNhY2hlZERlZmluaXRpb246IGZ1bmN0aW9uKGNvbXBvbmVudE5hbWUpIHsKCSAgICAgICAgICAgIGRlbGV0ZSBsb2FkZWREZWZpbml0aW9uc0NhY2hlW2NvbXBvbmVudE5hbWVdOwoJICAgICAgICB9LAoKCSAgICAgICAgX2dldEZpcnN0UmVzdWx0RnJvbUxvYWRlcnM6IGdldEZpcnN0UmVzdWx0RnJvbUxvYWRlcnMKCSAgICB9OwoKCSAgICBmdW5jdGlvbiBnZXRPYmplY3RPd25Qcm9wZXJ0eShvYmosIHByb3BOYW1lKSB7CgkgICAgICAgIHJldHVybiBvYmouaGFzT3duUHJvcGVydHkocHJvcE5hbWUpID8gb2JqW3Byb3BOYW1lXSA6IHVuZGVmaW5lZDsKCSAgICB9CgoJICAgIGZ1bmN0aW9uIGxvYWRDb21wb25lbnRBbmROb3RpZnkoY29tcG9uZW50TmFtZSwgY2FsbGJhY2spIHsKCSAgICAgICAgdmFyIHN1YnNjcmliYWJsZSA9IGdldE9iamVjdE93blByb3BlcnR5KGxvYWRpbmdTdWJzY3JpYmFibGVzQ2FjaGUsIGNvbXBvbmVudE5hbWUpLAoJICAgICAgICAgICAgY29tcGxldGVkQXN5bmM7CgkgICAgICAgIGlmICghc3Vic2NyaWJhYmxlKSB7CgkgICAgICAgICAgICAvLyBJdCdzIG5vdCBzdGFydGVkIGxvYWRpbmcgeWV0LiBTdGFydCBsb2FkaW5nLCBhbmQgd2hlbiBpdCdzIGRvbmUsIG1vdmUgaXQgdG8gbG9hZGVkRGVmaW5pdGlvbnNDYWNoZS4KCSAgICAgICAgICAgIHN1YnNjcmliYWJsZSA9IGxvYWRpbmdTdWJzY3JpYmFibGVzQ2FjaGVbY29tcG9uZW50TmFtZV0gPSBuZXcga28uc3Vic2NyaWJhYmxlKCk7CgkgICAgICAgICAgICBiZWdpbkxvYWRpbmdDb21wb25lbnQoY29tcG9uZW50TmFtZSwgZnVuY3Rpb24oZGVmaW5pdGlvbikgewoJICAgICAgICAgICAgICAgIGxvYWRlZERlZmluaXRpb25zQ2FjaGVbY29tcG9uZW50TmFtZV0gPSBkZWZpbml0aW9uOwoJICAgICAgICAgICAgICAgIGRlbGV0ZSBsb2FkaW5nU3Vic2NyaWJhYmxlc0NhY2hlW2NvbXBvbmVudE5hbWVdOwoKCSAgICAgICAgICAgICAgICAvLyBGb3IgQVBJIGNvbnNpc3RlbmN5LCBhbGwgbG9hZHMgY29tcGxldGUgYXN5bmNocm9ub3VzbHkuIEhvd2V2ZXIgd2Ugd2FudCB0byBhdm9pZAoJICAgICAgICAgICAgICAgIC8vIGFkZGluZyBhbiBleHRyYSBzZXRUaW1lb3V0IGlmIGl0J3MgdW5uZWNlc3NhcnkgKGkuZS4sIHRoZSBjb21wbGV0aW9uIGlzIGFscmVhZHkKCSAgICAgICAgICAgICAgICAvLyBhc3luYykgc2luY2Ugc2V0VGltZW91dCguLi4sIDApIHN0aWxsIHRha2VzIGFib3V0IDE2bXMgb3IgbW9yZSBvbiBtb3N0IGJyb3dzZXJzLgoJICAgICAgICAgICAgICAgIGlmIChjb21wbGV0ZWRBc3luYykgewoJICAgICAgICAgICAgICAgICAgICBzdWJzY3JpYmFibGVbJ25vdGlmeVN1YnNjcmliZXJzJ10oZGVmaW5pdGlvbik7CgkgICAgICAgICAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpIHsKCSAgICAgICAgICAgICAgICAgICAgICAgIHN1YnNjcmliYWJsZVsnbm90aWZ5U3Vic2NyaWJlcnMnXShkZWZpbml0aW9uKTsKCSAgICAgICAgICAgICAgICAgICAgfSwgMCk7CgkgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgfSk7CgkgICAgICAgICAgICBjb21wbGV0ZWRBc3luYyA9IHRydWU7CgkgICAgICAgIH0KCSAgICAgICAgc3Vic2NyaWJhYmxlLnN1YnNjcmliZShjYWxsYmFjayk7CgkgICAgfQoKCSAgICBmdW5jdGlvbiBiZWdpbkxvYWRpbmdDb21wb25lbnQoY29tcG9uZW50TmFtZSwgY2FsbGJhY2spIHsKCSAgICAgICAgZ2V0Rmlyc3RSZXN1bHRGcm9tTG9hZGVycygnZ2V0Q29uZmlnJywgW2NvbXBvbmVudE5hbWVdLCBmdW5jdGlvbihjb25maWcpIHsKCSAgICAgICAgICAgIGlmIChjb25maWcpIHsKCSAgICAgICAgICAgICAgICAvLyBXZSBoYXZlIGEgY29uZmlnLCBzbyBub3cgbG9hZCBpdHMgZGVmaW5pdGlvbgoJICAgICAgICAgICAgICAgIGdldEZpcnN0UmVzdWx0RnJvbUxvYWRlcnMoJ2xvYWRDb21wb25lbnQnLCBbY29tcG9uZW50TmFtZSwgY29uZmlnXSwgZnVuY3Rpb24oZGVmaW5pdGlvbikgewoJICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayhkZWZpbml0aW9uKTsKCSAgICAgICAgICAgICAgICB9KTsKCSAgICAgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICAgICAgLy8gVGhlIGNvbXBvbmVudCBoYXMgbm8gY29uZmlnIC0gaXQncyB1bmtub3duIHRvIGFsbCB0aGUgbG9hZGVycy4KCSAgICAgICAgICAgICAgICAvLyBOb3RlIHRoYXQgdGhpcyBpcyBub3QgYW4gZXJyb3IgKGUuZy4sIGEgbW9kdWxlIGxvYWRpbmcgZXJyb3IpIC0gdGhhdCB3b3VsZCBhYm9ydCB0aGUKCSAgICAgICAgICAgICAgICAvLyBwcm9jZXNzIGFuZCB0aGlzIGNhbGxiYWNrIHdvdWxkIG5vdCBydW4uIEZvciB0aGlzIGNhbGxiYWNrIHRvIHJ1biwgYWxsIGxvYWRlcnMgbXVzdAoJICAgICAgICAgICAgICAgIC8vIGhhdmUgY29uZmlybWVkIHRoZXkgZG9uJ3Qga25vdyBhYm91dCB0aGlzIGNvbXBvbmVudC4KCSAgICAgICAgICAgICAgICBjYWxsYmFjayhudWxsKTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgfSk7CgkgICAgfQoKCSAgICBmdW5jdGlvbiBnZXRGaXJzdFJlc3VsdEZyb21Mb2FkZXJzKG1ldGhvZE5hbWUsIGFyZ3NFeGNlcHRDYWxsYmFjaywgY2FsbGJhY2ssIGNhbmRpZGF0ZUxvYWRlcnMpIHsKCSAgICAgICAgLy8gT24gdGhlIGZpcnN0IGNhbGwgaW4gdGhlIHN0YWNrLCBzdGFydCB3aXRoIHRoZSBmdWxsIHNldCBvZiBsb2FkZXJzCgkgICAgICAgIGlmICghY2FuZGlkYXRlTG9hZGVycykgewoJICAgICAgICAgICAgY2FuZGlkYXRlTG9hZGVycyA9IGtvLmNvbXBvbmVudHNbJ2xvYWRlcnMnXS5zbGljZSgwKTsgLy8gVXNlIGEgY29weSwgYmVjYXVzZSB3ZSdsbCBiZSBtdXRhdGluZyB0aGlzIGFycmF5CgkgICAgICAgIH0KCgkgICAgICAgIC8vIFRyeSB0aGUgbmV4dCBjYW5kaWRhdGUKCSAgICAgICAgdmFyIGN1cnJlbnRDYW5kaWRhdGVMb2FkZXIgPSBjYW5kaWRhdGVMb2FkZXJzLnNoaWZ0KCk7CgkgICAgICAgIGlmIChjdXJyZW50Q2FuZGlkYXRlTG9hZGVyKSB7CgkgICAgICAgICAgICB2YXIgbWV0aG9kSW5zdGFuY2UgPSBjdXJyZW50Q2FuZGlkYXRlTG9hZGVyW21ldGhvZE5hbWVdOwoJICAgICAgICAgICAgaWYgKG1ldGhvZEluc3RhbmNlKSB7CgkgICAgICAgICAgICAgICAgdmFyIHdhc0Fib3J0ZWQgPSBmYWxzZSwKCSAgICAgICAgICAgICAgICAgICAgc3luY2hyb25vdXNSZXR1cm5WYWx1ZSA9IG1ldGhvZEluc3RhbmNlLmFwcGx5KGN1cnJlbnRDYW5kaWRhdGVMb2FkZXIsIGFyZ3NFeGNlcHRDYWxsYmFjay5jb25jYXQoZnVuY3Rpb24ocmVzdWx0KSB7CgkgICAgICAgICAgICAgICAgICAgICAgICBpZiAod2FzQWJvcnRlZCkgewoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKG51bGwpOwoJICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChyZXN1bHQgIT09IG51bGwpIHsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBUaGlzIGNhbmRpZGF0ZSByZXR1cm5lZCBhIHZhbHVlLiBVc2UgaXQuCgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2socmVzdWx0KTsKCSAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gVHJ5IHRoZSBuZXh0IGNhbmRpZGF0ZQoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdldEZpcnN0UmVzdWx0RnJvbUxvYWRlcnMobWV0aG9kTmFtZSwgYXJnc0V4Y2VwdENhbGxiYWNrLCBjYWxsYmFjaywgY2FuZGlkYXRlTG9hZGVycyk7CgkgICAgICAgICAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgICAgIH0pKTsKCgkgICAgICAgICAgICAgICAgLy8gQ3VycmVudGx5LCBsb2FkZXJzIG1heSBub3QgcmV0dXJuIGFueXRoaW5nIHN5bmNocm9ub3VzbHkuIFRoaXMgbGVhdmVzIG9wZW4gdGhlIHBvc3NpYmlsaXR5CgkgICAgICAgICAgICAgICAgLy8gdGhhdCB3ZSdsbCBleHRlbmQgdGhlIEFQSSB0byBzdXBwb3J0IHN5bmNocm9ub3VzIHJldHVybiB2YWx1ZXMgaW4gdGhlIGZ1dHVyZS4gSXQgd29uJ3QgYmUKCSAgICAgICAgICAgICAgICAvLyBhIGJyZWFraW5nIGNoYW5nZSwgYmVjYXVzZSBjdXJyZW50bHkgbm8gbG9hZGVyIGlzIGFsbG93ZWQgdG8gcmV0dXJuIGFueXRoaW5nIGV4Y2VwdCB1bmRlZmluZWQuCgkgICAgICAgICAgICAgICAgaWYgKHN5bmNocm9ub3VzUmV0dXJuVmFsdWUgIT09IHVuZGVmaW5lZCkgewoJICAgICAgICAgICAgICAgICAgICB3YXNBYm9ydGVkID0gdHJ1ZTsKCgkgICAgICAgICAgICAgICAgICAgIC8vIE1ldGhvZCB0byBzdXBwcmVzcyBleGNlcHRpb25zIHdpbGwgcmVtYWluIHVuZG9jdW1lbnRlZC4gVGhpcyBpcyBvbmx5IHRvIGtlZXAKCSAgICAgICAgICAgICAgICAgICAgLy8gS08ncyBzcGVjcyBydW5uaW5nIHRpZGlseSwgc2luY2Ugd2UgY2FuIG9ic2VydmUgdGhlIGxvYWRpbmcgZ290IGFib3J0ZWQgd2l0aG91dAoJICAgICAgICAgICAgICAgICAgICAvLyBoYXZpbmcgZXhjZXB0aW9ucyBjbHV0dGVyaW5nIHVwIHRoZSBjb25zb2xlIHRvby4KCSAgICAgICAgICAgICAgICAgICAgaWYgKCFjdXJyZW50Q2FuZGlkYXRlTG9hZGVyWydzdXBwcmVzc0xvYWRlckV4Y2VwdGlvbnMnXSkgewoJICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdDb21wb25lbnQgbG9hZGVycyBtdXN0IHN1cHBseSB2YWx1ZXMgYnkgaW52b2tpbmcgdGhlIGNhbGxiYWNrLCBub3QgYnkgcmV0dXJuaW5nIHZhbHVlcyBzeW5jaHJvbm91c2x5LicpOwoJICAgICAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgICAgICAvLyBUaGlzIGNhbmRpZGF0ZSBkb2Vzbid0IGhhdmUgdGhlIHJlbGV2YW50IGhhbmRsZXIuIFN5bmNocm9ub3VzbHkgbW92ZSBvbiB0byB0aGUgbmV4dCBvbmUuCgkgICAgICAgICAgICAgICAgZ2V0Rmlyc3RSZXN1bHRGcm9tTG9hZGVycyhtZXRob2ROYW1lLCBhcmdzRXhjZXB0Q2FsbGJhY2ssIGNhbGxiYWNrLCBjYW5kaWRhdGVMb2FkZXJzKTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgIC8vIE5vIGNhbmRpZGF0ZXMgcmV0dXJuZWQgYSB2YWx1ZQoJICAgICAgICAgICAgY2FsbGJhY2sobnVsbCk7CgkgICAgICAgIH0KCSAgICB9CgoJICAgIC8vIFJlZmVyZW5jZSB0aGUgbG9hZGVycyB2aWEgc3RyaW5nIG5hbWUgc28gaXQncyBwb3NzaWJsZSBmb3IgZGV2ZWxvcGVycwoJICAgIC8vIHRvIHJlcGxhY2UgdGhlIHdob2xlIGFycmF5IGJ5IGFzc2lnbmluZyB0byBrby5jb21wb25lbnRzLmxvYWRlcnMKCSAgICBrby5jb21wb25lbnRzWydsb2FkZXJzJ10gPSBbXTsKCgkgICAga28uZXhwb3J0U3ltYm9sKCdjb21wb25lbnRzJywga28uY29tcG9uZW50cyk7CgkgICAga28uZXhwb3J0U3ltYm9sKCdjb21wb25lbnRzLmdldCcsIGtvLmNvbXBvbmVudHMuZ2V0KTsKCSAgICBrby5leHBvcnRTeW1ib2woJ2NvbXBvbmVudHMuY2xlYXJDYWNoZWREZWZpbml0aW9uJywga28uY29tcG9uZW50cy5jbGVhckNhY2hlZERlZmluaXRpb24pOwoJfSkoKTsKCShmdW5jdGlvbih1bmRlZmluZWQpIHsKCgkgICAgLy8gVGhlIGRlZmF1bHQgbG9hZGVyIGlzIHJlc3BvbnNpYmxlIGZvciB0d28gdGhpbmdzOgoJICAgIC8vIDEuIE1haW50YWluaW5nIHRoZSBkZWZhdWx0IGluLW1lbW9yeSByZWdpc3RyeSBvZiBjb21wb25lbnQgY29uZmlndXJhdGlvbiBvYmplY3RzCgkgICAgLy8gICAgKGkuZS4sIHRoZSB0aGluZyB5b3UncmUgd3JpdGluZyB0byB3aGVuIHlvdSBjYWxsIGtvLmNvbXBvbmVudHMucmVnaXN0ZXIoc29tZU5hbWUsIC4uLikpCgkgICAgLy8gMi4gQW5zd2VyaW5nIHJlcXVlc3RzIGZvciBjb21wb25lbnRzIGJ5IGZldGNoaW5nIGNvbmZpZ3VyYXRpb24gb2JqZWN0cwoJICAgIC8vICAgIGZyb20gdGhhdCBkZWZhdWx0IGluLW1lbW9yeSByZWdpc3RyeSBhbmQgcmVzb2x2aW5nIHRoZW0gaW50byBzdGFuZGFyZAoJICAgIC8vICAgIGNvbXBvbmVudCBkZWZpbml0aW9uIG9iamVjdHMgKG9mIHRoZSBmb3JtIHsgY3JlYXRlVmlld01vZGVsOiAuLi4sIHRlbXBsYXRlOiAuLi4gfSkKCSAgICAvLyBDdXN0b20gbG9hZGVycyBtYXkgb3ZlcnJpZGUgZWl0aGVyIG9mIHRoZXNlIGZhY2lsaXRpZXMsIGkuZS4sCgkgICAgLy8gMS4gVG8gc3VwcGx5IGNvbmZpZ3VyYXRpb24gb2JqZWN0cyBmcm9tIHNvbWUgb3RoZXIgc291cmNlIChlLmcuLCBjb252ZW50aW9ucykKCSAgICAvLyAyLiBPciwgdG8gcmVzb2x2ZSBjb25maWd1cmF0aW9uIG9iamVjdHMgYnkgbG9hZGluZyB2aWV3bW9kZWxzL3RlbXBsYXRlcyB2aWEgYXJiaXRyYXJ5IGxvZ2ljLgoKCSAgICB2YXIgZGVmYXVsdENvbmZpZ1JlZ2lzdHJ5ID0ge307CgoJICAgIGtvLmNvbXBvbmVudHMucmVnaXN0ZXIgPSBmdW5jdGlvbihjb21wb25lbnROYW1lLCBjb25maWcpIHsKCSAgICAgICAgaWYgKCFjb25maWcpIHsKCSAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZCBjb25maWd1cmF0aW9uIGZvciAnICsgY29tcG9uZW50TmFtZSk7CgkgICAgICAgIH0KCgkgICAgICAgIGlmIChrby5jb21wb25lbnRzLmlzUmVnaXN0ZXJlZChjb21wb25lbnROYW1lKSkgewoJICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdDb21wb25lbnQgJyArIGNvbXBvbmVudE5hbWUgKyAnIGlzIGFscmVhZHkgcmVnaXN0ZXJlZCcpOwoJICAgICAgICB9CgoJICAgICAgICBkZWZhdWx0Q29uZmlnUmVnaXN0cnlbY29tcG9uZW50TmFtZV0gPSBjb25maWc7CgkgICAgfQoKCSAgICBrby5jb21wb25lbnRzLmlzUmVnaXN0ZXJlZCA9IGZ1bmN0aW9uKGNvbXBvbmVudE5hbWUpIHsKCSAgICAgICAgcmV0dXJuIGNvbXBvbmVudE5hbWUgaW4gZGVmYXVsdENvbmZpZ1JlZ2lzdHJ5OwoJICAgIH0KCgkgICAga28uY29tcG9uZW50cy51bnJlZ2lzdGVyID0gZnVuY3Rpb24oY29tcG9uZW50TmFtZSkgewoJICAgICAgICBkZWxldGUgZGVmYXVsdENvbmZpZ1JlZ2lzdHJ5W2NvbXBvbmVudE5hbWVdOwoJICAgICAgICBrby5jb21wb25lbnRzLmNsZWFyQ2FjaGVkRGVmaW5pdGlvbihjb21wb25lbnROYW1lKTsKCSAgICB9CgoJICAgIGtvLmNvbXBvbmVudHMuZGVmYXVsdExvYWRlciA9IHsKCSAgICAgICAgJ2dldENvbmZpZyc6IGZ1bmN0aW9uKGNvbXBvbmVudE5hbWUsIGNhbGxiYWNrKSB7CgkgICAgICAgICAgICB2YXIgcmVzdWx0ID0gZGVmYXVsdENvbmZpZ1JlZ2lzdHJ5Lmhhc093blByb3BlcnR5KGNvbXBvbmVudE5hbWUpCgkgICAgICAgICAgICAgICAgPyBkZWZhdWx0Q29uZmlnUmVnaXN0cnlbY29tcG9uZW50TmFtZV0KCSAgICAgICAgICAgICAgICA6IG51bGw7CgkgICAgICAgICAgICBjYWxsYmFjayhyZXN1bHQpOwoJICAgICAgICB9LAoKCSAgICAgICAgJ2xvYWRDb21wb25lbnQnOiBmdW5jdGlvbihjb21wb25lbnROYW1lLCBjb25maWcsIGNhbGxiYWNrKSB7CgkgICAgICAgICAgICB2YXIgZXJyb3JDYWxsYmFjayA9IG1ha2VFcnJvckNhbGxiYWNrKGNvbXBvbmVudE5hbWUpOwoJICAgICAgICAgICAgcG9zc2libHlHZXRDb25maWdGcm9tQW1kKGVycm9yQ2FsbGJhY2ssIGNvbmZpZywgZnVuY3Rpb24obG9hZGVkQ29uZmlnKSB7CgkgICAgICAgICAgICAgICAgcmVzb2x2ZUNvbmZpZyhjb21wb25lbnROYW1lLCBlcnJvckNhbGxiYWNrLCBsb2FkZWRDb25maWcsIGNhbGxiYWNrKTsKCSAgICAgICAgICAgIH0pOwoJICAgICAgICB9LAoKCSAgICAgICAgJ2xvYWRUZW1wbGF0ZSc6IGZ1bmN0aW9uKGNvbXBvbmVudE5hbWUsIHRlbXBsYXRlQ29uZmlnLCBjYWxsYmFjaykgewoJICAgICAgICAgICAgcmVzb2x2ZVRlbXBsYXRlKG1ha2VFcnJvckNhbGxiYWNrKGNvbXBvbmVudE5hbWUpLCB0ZW1wbGF0ZUNvbmZpZywgY2FsbGJhY2spOwoJICAgICAgICB9LAoKCSAgICAgICAgJ2xvYWRWaWV3TW9kZWwnOiBmdW5jdGlvbihjb21wb25lbnROYW1lLCB2aWV3TW9kZWxDb25maWcsIGNhbGxiYWNrKSB7CgkgICAgICAgICAgICByZXNvbHZlVmlld01vZGVsKG1ha2VFcnJvckNhbGxiYWNrKGNvbXBvbmVudE5hbWUpLCB2aWV3TW9kZWxDb25maWcsIGNhbGxiYWNrKTsKCSAgICAgICAgfQoJICAgIH07CgoJICAgIHZhciBjcmVhdGVWaWV3TW9kZWxLZXkgPSAnY3JlYXRlVmlld01vZGVsJzsKCgkgICAgLy8gVGFrZXMgYSBjb25maWcgb2JqZWN0IG9mIHRoZSBmb3JtIHsgdGVtcGxhdGU6IC4uLiwgdmlld01vZGVsOiAuLi4gfSwgYW5kIGFzeW5jaHJvbm91c2x5IGNvbnZlcnQgaXQKCSAgICAvLyBpbnRvIHRoZSBzdGFuZGFyZCBjb21wb25lbnQgZGVmaW5pdGlvbiBmb3JtYXQ6CgkgICAgLy8gICAgeyB0ZW1wbGF0ZTogPEFycmF5T2ZEb21Ob2Rlcz4sIGNyZWF0ZVZpZXdNb2RlbDogZnVuY3Rpb24ocGFyYW1zLCBjb21wb25lbnRJbmZvKSB7IC4uLiB9IH0uCgkgICAgLy8gU2luY2UgYm90aCB0ZW1wbGF0ZSBhbmQgdmlld01vZGVsIG1heSBuZWVkIHRvIGJlIHJlc29sdmVkIGFzeW5jaHJvbm91c2x5LCBib3RoIHRhc2tzIGFyZSBwZXJmb3JtZWQKCSAgICAvLyBpbiBwYXJhbGxlbCwgYW5kIHRoZSByZXN1bHRzIGpvaW5lZCB3aGVuIGJvdGggYXJlIHJlYWR5LiBXZSBkb24ndCBkZXBlbmQgb24gYW55IHByb21pc2VzIGluZnJhc3RydWN0dXJlLAoJICAgIC8vIHNvIHRoaXMgaXMgaW1wbGVtZW50ZWQgbWFudWFsbHkgYmVsb3cuCgkgICAgZnVuY3Rpb24gcmVzb2x2ZUNvbmZpZyhjb21wb25lbnROYW1lLCBlcnJvckNhbGxiYWNrLCBjb25maWcsIGNhbGxiYWNrKSB7CgkgICAgICAgIHZhciByZXN1bHQgPSB7fSwKCSAgICAgICAgICAgIG1ha2VDYWxsQmFja1doZW5aZXJvID0gMiwKCSAgICAgICAgICAgIHRyeUlzc3VlQ2FsbGJhY2sgPSBmdW5jdGlvbigpIHsKCSAgICAgICAgICAgICAgICBpZiAoLS1tYWtlQ2FsbEJhY2tXaGVuWmVybyA9PT0gMCkgewoJICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayhyZXN1bHQpOwoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgIH0sCgkgICAgICAgICAgICB0ZW1wbGF0ZUNvbmZpZyA9IGNvbmZpZ1sndGVtcGxhdGUnXSwKCSAgICAgICAgICAgIHZpZXdNb2RlbENvbmZpZyA9IGNvbmZpZ1sndmlld01vZGVsJ107CgoJICAgICAgICBpZiAodGVtcGxhdGVDb25maWcpIHsKCSAgICAgICAgICAgIHBvc3NpYmx5R2V0Q29uZmlnRnJvbUFtZChlcnJvckNhbGxiYWNrLCB0ZW1wbGF0ZUNvbmZpZywgZnVuY3Rpb24obG9hZGVkQ29uZmlnKSB7CgkgICAgICAgICAgICAgICAga28uY29tcG9uZW50cy5fZ2V0Rmlyc3RSZXN1bHRGcm9tTG9hZGVycygnbG9hZFRlbXBsYXRlJywgW2NvbXBvbmVudE5hbWUsIGxvYWRlZENvbmZpZ10sIGZ1bmN0aW9uKHJlc29sdmVkVGVtcGxhdGUpIHsKCSAgICAgICAgICAgICAgICAgICAgcmVzdWx0Wyd0ZW1wbGF0ZSddID0gcmVzb2x2ZWRUZW1wbGF0ZTsKCSAgICAgICAgICAgICAgICAgICAgdHJ5SXNzdWVDYWxsYmFjaygpOwoJICAgICAgICAgICAgICAgIH0pOwoJICAgICAgICAgICAgfSk7CgkgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICB0cnlJc3N1ZUNhbGxiYWNrKCk7CgkgICAgICAgIH0KCgkgICAgICAgIGlmICh2aWV3TW9kZWxDb25maWcpIHsKCSAgICAgICAgICAgIHBvc3NpYmx5R2V0Q29uZmlnRnJvbUFtZChlcnJvckNhbGxiYWNrLCB2aWV3TW9kZWxDb25maWcsIGZ1bmN0aW9uKGxvYWRlZENvbmZpZykgewoJICAgICAgICAgICAgICAgIGtvLmNvbXBvbmVudHMuX2dldEZpcnN0UmVzdWx0RnJvbUxvYWRlcnMoJ2xvYWRWaWV3TW9kZWwnLCBbY29tcG9uZW50TmFtZSwgbG9hZGVkQ29uZmlnXSwgZnVuY3Rpb24ocmVzb2x2ZWRWaWV3TW9kZWwpIHsKCSAgICAgICAgICAgICAgICAgICAgcmVzdWx0W2NyZWF0ZVZpZXdNb2RlbEtleV0gPSByZXNvbHZlZFZpZXdNb2RlbDsKCSAgICAgICAgICAgICAgICAgICAgdHJ5SXNzdWVDYWxsYmFjaygpOwoJICAgICAgICAgICAgICAgIH0pOwoJICAgICAgICAgICAgfSk7CgkgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICB0cnlJc3N1ZUNhbGxiYWNrKCk7CgkgICAgICAgIH0KCSAgICB9CgoJICAgIGZ1bmN0aW9uIHJlc29sdmVUZW1wbGF0ZShlcnJvckNhbGxiYWNrLCB0ZW1wbGF0ZUNvbmZpZywgY2FsbGJhY2spIHsKCSAgICAgICAgaWYgKHR5cGVvZiB0ZW1wbGF0ZUNvbmZpZyA9PT0gJ3N0cmluZycpIHsKCSAgICAgICAgICAgIC8vIE1hcmt1cCAtIHBhcnNlIGl0CgkgICAgICAgICAgICBjYWxsYmFjayhrby51dGlscy5wYXJzZUh0bWxGcmFnbWVudCh0ZW1wbGF0ZUNvbmZpZykpOwoJICAgICAgICB9IGVsc2UgaWYgKHRlbXBsYXRlQ29uZmlnIGluc3RhbmNlb2YgQXJyYXkpIHsKCSAgICAgICAgICAgIC8vIEFzc3VtZSBhbHJlYWR5IGFuIGFycmF5IG9mIERPTSBub2RlcyAtIHBhc3MgdGhyb3VnaCB1bmNoYW5nZWQKCSAgICAgICAgICAgIGNhbGxiYWNrKHRlbXBsYXRlQ29uZmlnKTsKCSAgICAgICAgfSBlbHNlIGlmIChpc0RvY3VtZW50RnJhZ21lbnQodGVtcGxhdGVDb25maWcpKSB7CgkgICAgICAgICAgICAvLyBEb2N1bWVudCBmcmFnbWVudCAtIHVzZSBpdHMgY2hpbGQgbm9kZXMKCSAgICAgICAgICAgIGNhbGxiYWNrKGtvLnV0aWxzLm1ha2VBcnJheSh0ZW1wbGF0ZUNvbmZpZy5jaGlsZE5vZGVzKSk7CgkgICAgICAgIH0gZWxzZSBpZiAodGVtcGxhdGVDb25maWdbJ2VsZW1lbnQnXSkgewoJICAgICAgICAgICAgdmFyIGVsZW1lbnQgPSB0ZW1wbGF0ZUNvbmZpZ1snZWxlbWVudCddOwoJICAgICAgICAgICAgaWYgKGlzRG9tRWxlbWVudChlbGVtZW50KSkgewoJICAgICAgICAgICAgICAgIC8vIEVsZW1lbnQgaW5zdGFuY2UgLSBjb3B5IGl0cyBjaGlsZCBub2RlcwoJICAgICAgICAgICAgICAgIGNhbGxiYWNrKGNsb25lTm9kZXNGcm9tVGVtcGxhdGVTb3VyY2VFbGVtZW50KGVsZW1lbnQpKTsKCSAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGVsZW1lbnQgPT09ICdzdHJpbmcnKSB7CgkgICAgICAgICAgICAgICAgLy8gRWxlbWVudCBJRCAtIGZpbmQgaXQsIHRoZW4gY29weSBpdHMgY2hpbGQgbm9kZXMKCSAgICAgICAgICAgICAgICB2YXIgZWxlbUluc3RhbmNlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoZWxlbWVudCk7CgkgICAgICAgICAgICAgICAgaWYgKGVsZW1JbnN0YW5jZSkgewoJICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayhjbG9uZU5vZGVzRnJvbVRlbXBsYXRlU291cmNlRWxlbWVudChlbGVtSW5zdGFuY2UpKTsKCSAgICAgICAgICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgICAgICAgICBlcnJvckNhbGxiYWNrKCdDYW5ub3QgZmluZCBlbGVtZW50IHdpdGggSUQgJyArIGVsZW1lbnQpOwoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICAgICAgZXJyb3JDYWxsYmFjaygnVW5rbm93biBlbGVtZW50IHR5cGU6ICcgKyBlbGVtZW50KTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgIGVycm9yQ2FsbGJhY2soJ1Vua25vd24gdGVtcGxhdGUgdmFsdWU6ICcgKyB0ZW1wbGF0ZUNvbmZpZyk7CgkgICAgICAgIH0KCSAgICB9CgoJICAgIGZ1bmN0aW9uIHJlc29sdmVWaWV3TW9kZWwoZXJyb3JDYWxsYmFjaywgdmlld01vZGVsQ29uZmlnLCBjYWxsYmFjaykgewoJICAgICAgICBpZiAodHlwZW9mIHZpZXdNb2RlbENvbmZpZyA9PT0gJ2Z1bmN0aW9uJykgewoJICAgICAgICAgICAgLy8gQ29uc3RydWN0b3IgLSBjb252ZXJ0IHRvIHN0YW5kYXJkIGZhY3RvcnkgZnVuY3Rpb24gZm9ybWF0CgkgICAgICAgICAgICAvLyBCeSBkZXNpZ24sIHRoaXMgZG9lcyAqbm90KiBzdXBwbHkgY29tcG9uZW50SW5mbyB0byB0aGUgY29uc3RydWN0b3IsIGFzIHRoZSBpbnRlbnQgaXMgdGhhdAoJICAgICAgICAgICAgLy8gY29tcG9uZW50SW5mbyBjb250YWlucyBub24tdmlld21vZGVsIGRhdGEgKGUuZy4sIHRoZSBjb21wb25lbnQncyBlbGVtZW50KSB0aGF0IHNob3VsZCBvbmx5CgkgICAgICAgICAgICAvLyBiZSB1c2VkIGluIGZhY3RvcnkgZnVuY3Rpb25zLCBub3Qgdmlld21vZGVsIGNvbnN0cnVjdG9ycy4KCSAgICAgICAgICAgIGNhbGxiYWNrKGZ1bmN0aW9uIChwYXJhbXMgLyosIGNvbXBvbmVudEluZm8gKi8pIHsKCSAgICAgICAgICAgICAgICByZXR1cm4gbmV3IHZpZXdNb2RlbENvbmZpZyhwYXJhbXMpOwoJICAgICAgICAgICAgfSk7CgkgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHZpZXdNb2RlbENvbmZpZ1tjcmVhdGVWaWV3TW9kZWxLZXldID09PSAnZnVuY3Rpb24nKSB7CgkgICAgICAgICAgICAvLyBBbHJlYWR5IGEgZmFjdG9yeSBmdW5jdGlvbiAtIHVzZSBpdCBhcy1pcwoJICAgICAgICAgICAgY2FsbGJhY2sodmlld01vZGVsQ29uZmlnW2NyZWF0ZVZpZXdNb2RlbEtleV0pOwoJICAgICAgICB9IGVsc2UgaWYgKCdpbnN0YW5jZScgaW4gdmlld01vZGVsQ29uZmlnKSB7CgkgICAgICAgICAgICAvLyBGaXhlZCBvYmplY3QgaW5zdGFuY2UgLSBwcm9tb3RlIHRvIGNyZWF0ZVZpZXdNb2RlbCBmb3JtYXQgZm9yIEFQSSBjb25zaXN0ZW5jeQoJICAgICAgICAgICAgdmFyIGZpeGVkSW5zdGFuY2UgPSB2aWV3TW9kZWxDb25maWdbJ2luc3RhbmNlJ107CgkgICAgICAgICAgICBjYWxsYmFjayhmdW5jdGlvbiAocGFyYW1zLCBjb21wb25lbnRJbmZvKSB7CgkgICAgICAgICAgICAgICAgcmV0dXJuIGZpeGVkSW5zdGFuY2U7CgkgICAgICAgICAgICB9KTsKCSAgICAgICAgfSBlbHNlIGlmICgndmlld01vZGVsJyBpbiB2aWV3TW9kZWxDb25maWcpIHsKCSAgICAgICAgICAgIC8vIFJlc29sdmVkIEFNRCBtb2R1bGUgd2hvc2UgdmFsdWUgaXMgb2YgdGhlIGZvcm0geyB2aWV3TW9kZWw6IC4uLiB9CgkgICAgICAgICAgICByZXNvbHZlVmlld01vZGVsKGVycm9yQ2FsbGJhY2ssIHZpZXdNb2RlbENvbmZpZ1sndmlld01vZGVsJ10sIGNhbGxiYWNrKTsKCSAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgIGVycm9yQ2FsbGJhY2soJ1Vua25vd24gdmlld01vZGVsIHZhbHVlOiAnICsgdmlld01vZGVsQ29uZmlnKTsKCSAgICAgICAgfQoJICAgIH0KCgkgICAgZnVuY3Rpb24gY2xvbmVOb2Rlc0Zyb21UZW1wbGF0ZVNvdXJjZUVsZW1lbnQoZWxlbUluc3RhbmNlKSB7CgkgICAgICAgIHN3aXRjaCAoa28udXRpbHMudGFnTmFtZUxvd2VyKGVsZW1JbnN0YW5jZSkpIHsKCSAgICAgICAgICAgIGNhc2UgJ3NjcmlwdCc6CgkgICAgICAgICAgICAgICAgcmV0dXJuIGtvLnV0aWxzLnBhcnNlSHRtbEZyYWdtZW50KGVsZW1JbnN0YW5jZS50ZXh0KTsKCSAgICAgICAgICAgIGNhc2UgJ3RleHRhcmVhJzoKCSAgICAgICAgICAgICAgICByZXR1cm4ga28udXRpbHMucGFyc2VIdG1sRnJhZ21lbnQoZWxlbUluc3RhbmNlLnZhbHVlKTsKCSAgICAgICAgICAgIGNhc2UgJ3RlbXBsYXRlJzoKCSAgICAgICAgICAgICAgICAvLyBGb3IgYnJvd3NlcnMgd2l0aCBwcm9wZXIgPHRlbXBsYXRlPiBlbGVtZW50IHN1cHBvcnQgKGkuZS4sIHdoZXJlIHRoZSAuY29udGVudCBwcm9wZXJ0eQoJICAgICAgICAgICAgICAgIC8vIGdpdmVzIGEgZG9jdW1lbnQgZnJhZ21lbnQpLCB1c2UgdGhhdCBkb2N1bWVudCBmcmFnbWVudC4KCSAgICAgICAgICAgICAgICBpZiAoaXNEb2N1bWVudEZyYWdtZW50KGVsZW1JbnN0YW5jZS5jb250ZW50KSkgewoJICAgICAgICAgICAgICAgICAgICByZXR1cm4ga28udXRpbHMuY2xvbmVOb2RlcyhlbGVtSW5zdGFuY2UuY29udGVudC5jaGlsZE5vZGVzKTsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgIH0KCgkgICAgICAgIC8vIFJlZ3VsYXIgZWxlbWVudHMgc3VjaCBhcyA8ZGl2PiwgYW5kIDx0ZW1wbGF0ZT4gZWxlbWVudHMgb24gb2xkIGJyb3dzZXJzIHRoYXQgZG9uJ3QgcmVhbGx5CgkgICAgICAgIC8vIHVuZGVyc3RhbmQgPHRlbXBsYXRlPiBhbmQganVzdCB0cmVhdCBpdCBhcyBhIHJlZ3VsYXIgY29udGFpbmVyCgkgICAgICAgIHJldHVybiBrby51dGlscy5jbG9uZU5vZGVzKGVsZW1JbnN0YW5jZS5jaGlsZE5vZGVzKTsKCSAgICB9CgoJICAgIGZ1bmN0aW9uIGlzRG9tRWxlbWVudChvYmopIHsKCSAgICAgICAgaWYgKHdpbmRvd1snSFRNTEVsZW1lbnQnXSkgewoJICAgICAgICAgICAgcmV0dXJuIG9iaiBpbnN0YW5jZW9mIEhUTUxFbGVtZW50OwoJICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgcmV0dXJuIG9iaiAmJiBvYmoudGFnTmFtZSAmJiBvYmoubm9kZVR5cGUgPT09IDE7CgkgICAgICAgIH0KCSAgICB9CgoJICAgIGZ1bmN0aW9uIGlzRG9jdW1lbnRGcmFnbWVudChvYmopIHsKCSAgICAgICAgaWYgKHdpbmRvd1snRG9jdW1lbnRGcmFnbWVudCddKSB7CgkgICAgICAgICAgICByZXR1cm4gb2JqIGluc3RhbmNlb2YgRG9jdW1lbnRGcmFnbWVudDsKCSAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgIHJldHVybiBvYmogJiYgb2JqLm5vZGVUeXBlID09PSAxMTsKCSAgICAgICAgfQoJICAgIH0KCgkgICAgZnVuY3Rpb24gcG9zc2libHlHZXRDb25maWdGcm9tQW1kKGVycm9yQ2FsbGJhY2ssIGNvbmZpZywgY2FsbGJhY2spIHsKCSAgICAgICAgaWYgKHR5cGVvZiBjb25maWdbJ3JlcXVpcmUnXSA9PT0gJ3N0cmluZycpIHsKCSAgICAgICAgICAgIC8vIFRoZSBjb25maWcgaXMgdGhlIHZhbHVlIG9mIGFuIEFNRCBtb2R1bGUKCSAgICAgICAgICAgIGlmIChyZXF1aXJlIHx8IHdpbmRvd1sncmVxdWlyZSddKSB7CgkgICAgICAgICAgICAgICAgKHJlcXVpcmUgfHwgd2luZG93WydyZXF1aXJlJ10pKFtjb25maWdbJ3JlcXVpcmUnXV0sIGNhbGxiYWNrKTsKCSAgICAgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICAgICAgZXJyb3JDYWxsYmFjaygnVXNlcyByZXF1aXJlLCBidXQgbm8gQU1EIGxvYWRlciBpcyBwcmVzZW50Jyk7CgkgICAgICAgICAgICB9CgkgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICBjYWxsYmFjayhjb25maWcpOwoJICAgICAgICB9CgkgICAgfQoKCSAgICBmdW5jdGlvbiBtYWtlRXJyb3JDYWxsYmFjayhjb21wb25lbnROYW1lKSB7CgkgICAgICAgIHJldHVybiBmdW5jdGlvbiAobWVzc2FnZSkgewoJICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdDb21wb25lbnQgXCcnICsgY29tcG9uZW50TmFtZSArICdcJzogJyArIG1lc3NhZ2UpOwoJICAgICAgICB9OwoJICAgIH0KCgkgICAga28uZXhwb3J0U3ltYm9sKCdjb21wb25lbnRzLnJlZ2lzdGVyJywga28uY29tcG9uZW50cy5yZWdpc3Rlcik7CgkgICAga28uZXhwb3J0U3ltYm9sKCdjb21wb25lbnRzLmlzUmVnaXN0ZXJlZCcsIGtvLmNvbXBvbmVudHMuaXNSZWdpc3RlcmVkKTsKCSAgICBrby5leHBvcnRTeW1ib2woJ2NvbXBvbmVudHMudW5yZWdpc3RlcicsIGtvLmNvbXBvbmVudHMudW5yZWdpc3Rlcik7CgoJICAgIC8vIEV4cG9zZSB0aGUgZGVmYXVsdCBsb2FkZXIgc28gdGhhdCBkZXZlbG9wZXJzIGNhbiBkaXJlY3RseSBhc2sgaXQgZm9yIGNvbmZpZ3VyYXRpb24KCSAgICAvLyBvciB0byByZXNvbHZlIGNvbmZpZ3VyYXRpb24KCSAgICBrby5leHBvcnRTeW1ib2woJ2NvbXBvbmVudHMuZGVmYXVsdExvYWRlcicsIGtvLmNvbXBvbmVudHMuZGVmYXVsdExvYWRlcik7CgoJICAgIC8vIEJ5IGRlZmF1bHQsIHRoZSBkZWZhdWx0IGxvYWRlciBpcyB0aGUgb25seSByZWdpc3RlcmVkIGNvbXBvbmVudCBsb2FkZXIKCSAgICBrby5jb21wb25lbnRzWydsb2FkZXJzJ10ucHVzaChrby5jb21wb25lbnRzLmRlZmF1bHRMb2FkZXIpOwoKCSAgICAvLyBQcml2YXRlbHkgZXhwb3NlIHRoZSB1bmRlcmx5aW5nIGNvbmZpZyByZWdpc3RyeSBmb3IgdXNlIGluIG9sZC1JRSBzaGltCgkgICAga28uY29tcG9uZW50cy5fYWxsUmVnaXN0ZXJlZENvbXBvbmVudHMgPSBkZWZhdWx0Q29uZmlnUmVnaXN0cnk7Cgl9KSgpOwoJKGZ1bmN0aW9uICh1bmRlZmluZWQpIHsKCSAgICAvLyBPdmVycmlkYWJsZSBBUEkgZm9yIGRldGVybWluaW5nIHdoaWNoIGNvbXBvbmVudCBuYW1lIGFwcGxpZXMgdG8gYSBnaXZlbiBub2RlLiBCeSBvdmVycmlkaW5nIHRoaXMsCgkgICAgLy8geW91IGNhbiBmb3IgZXhhbXBsZSBtYXAgc3BlY2lmaWMgdGFnTmFtZXMgdG8gY29tcG9uZW50cyB0aGF0IGFyZSBub3QgcHJlcmVnaXN0ZXJlZC4KCSAgICBrby5jb21wb25lbnRzWydnZXRDb21wb25lbnROYW1lRm9yTm9kZSddID0gZnVuY3Rpb24obm9kZSkgewoJICAgICAgICB2YXIgdGFnTmFtZUxvd2VyID0ga28udXRpbHMudGFnTmFtZUxvd2VyKG5vZGUpOwoJICAgICAgICByZXR1cm4ga28uY29tcG9uZW50cy5pc1JlZ2lzdGVyZWQodGFnTmFtZUxvd2VyKSAmJiB0YWdOYW1lTG93ZXI7CgkgICAgfTsKCgkgICAga28uY29tcG9uZW50cy5hZGRCaW5kaW5nc0ZvckN1c3RvbUVsZW1lbnQgPSBmdW5jdGlvbihhbGxCaW5kaW5ncywgbm9kZSwgYmluZGluZ0NvbnRleHQsIHZhbHVlQWNjZXNzb3JzKSB7CgkgICAgICAgIC8vIERldGVybWluZSBpZiBpdCdzIHJlYWxseSBhIGN1c3RvbSBlbGVtZW50IG1hdGNoaW5nIGEgY29tcG9uZW50CgkgICAgICAgIGlmIChub2RlLm5vZGVUeXBlID09PSAxKSB7CgkgICAgICAgICAgICB2YXIgY29tcG9uZW50TmFtZSA9IGtvLmNvbXBvbmVudHNbJ2dldENvbXBvbmVudE5hbWVGb3JOb2RlJ10obm9kZSk7CgkgICAgICAgICAgICBpZiAoY29tcG9uZW50TmFtZSkgewoJICAgICAgICAgICAgICAgIC8vIEl0IGRvZXMgcmVwcmVzZW50IGEgY29tcG9uZW50LCBzbyBhZGQgYSBjb21wb25lbnQgYmluZGluZyBmb3IgaXQKCSAgICAgICAgICAgICAgICBhbGxCaW5kaW5ncyA9IGFsbEJpbmRpbmdzIHx8IHt9OwoKCSAgICAgICAgICAgICAgICBpZiAoYWxsQmluZGluZ3NbJ2NvbXBvbmVudCddKSB7CgkgICAgICAgICAgICAgICAgICAgIC8vIEF2b2lkIHNpbGVudGx5IG92ZXJ3cml0aW5nIHNvbWUgb3RoZXIgJ2NvbXBvbmVudCcgYmluZGluZyB0aGF0IG1heSBhbHJlYWR5IGJlIG9uIHRoZSBlbGVtZW50CgkgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignQ2Fubm90IHVzZSB0aGUgImNvbXBvbmVudCIgYmluZGluZyBvbiBhIGN1c3RvbSBlbGVtZW50IG1hdGNoaW5nIGEgY29tcG9uZW50Jyk7CgkgICAgICAgICAgICAgICAgfQoKCSAgICAgICAgICAgICAgICB2YXIgY29tcG9uZW50QmluZGluZ1ZhbHVlID0geyAnbmFtZSc6IGNvbXBvbmVudE5hbWUsICdwYXJhbXMnOiBnZXRDb21wb25lbnRQYXJhbXNGcm9tQ3VzdG9tRWxlbWVudChub2RlLCBiaW5kaW5nQ29udGV4dCkgfTsKCgkgICAgICAgICAgICAgICAgYWxsQmluZGluZ3NbJ2NvbXBvbmVudCddID0gdmFsdWVBY2Nlc3NvcnMKCSAgICAgICAgICAgICAgICAgICAgPyBmdW5jdGlvbigpIHsgcmV0dXJuIGNvbXBvbmVudEJpbmRpbmdWYWx1ZTsgfQoJICAgICAgICAgICAgICAgICAgICA6IGNvbXBvbmVudEJpbmRpbmdWYWx1ZTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgfQoKCSAgICAgICAgcmV0dXJuIGFsbEJpbmRpbmdzOwoJICAgIH0KCgkgICAgdmFyIG5hdGl2ZUJpbmRpbmdQcm92aWRlckluc3RhbmNlID0gbmV3IGtvLmJpbmRpbmdQcm92aWRlcigpOwoKCSAgICBmdW5jdGlvbiBnZXRDb21wb25lbnRQYXJhbXNGcm9tQ3VzdG9tRWxlbWVudChlbGVtLCBiaW5kaW5nQ29udGV4dCkgewoJICAgICAgICB2YXIgcGFyYW1zQXR0cmlidXRlID0gZWxlbS5nZXRBdHRyaWJ1dGUoJ3BhcmFtcycpOwoKCSAgICAgICAgaWYgKHBhcmFtc0F0dHJpYnV0ZSkgewoJICAgICAgICAgICAgdmFyIHBhcmFtcyA9IG5hdGl2ZUJpbmRpbmdQcm92aWRlckluc3RhbmNlWydwYXJzZUJpbmRpbmdzU3RyaW5nJ10ocGFyYW1zQXR0cmlidXRlLCBiaW5kaW5nQ29udGV4dCwgZWxlbSwgeyAndmFsdWVBY2Nlc3NvcnMnOiB0cnVlLCAnYmluZGluZ1BhcmFtcyc6IHRydWUgfSksCgkgICAgICAgICAgICAgICAgcmF3UGFyYW1Db21wdXRlZFZhbHVlcyA9IGtvLnV0aWxzLm9iamVjdE1hcChwYXJhbXMsIGZ1bmN0aW9uKHBhcmFtVmFsdWUsIHBhcmFtTmFtZSkgewoJICAgICAgICAgICAgICAgICAgICByZXR1cm4ga28uY29tcHV0ZWQocGFyYW1WYWx1ZSwgbnVsbCwgeyBkaXNwb3NlV2hlbk5vZGVJc1JlbW92ZWQ6IGVsZW0gfSk7CgkgICAgICAgICAgICAgICAgfSksCgkgICAgICAgICAgICAgICAgcmVzdWx0ID0ga28udXRpbHMub2JqZWN0TWFwKHJhd1BhcmFtQ29tcHV0ZWRWYWx1ZXMsIGZ1bmN0aW9uKHBhcmFtVmFsdWVDb21wdXRlZCwgcGFyYW1OYW1lKSB7CgkgICAgICAgICAgICAgICAgICAgIC8vIERvZXMgdGhlIGV2YWx1YXRpb24gb2YgdGhlIHBhcmFtZXRlciB2YWx1ZSB1bndyYXAgYW55IG9ic2VydmFibGVzPwoJICAgICAgICAgICAgICAgICAgICBpZiAoIXBhcmFtVmFsdWVDb21wdXRlZC5pc0FjdGl2ZSgpKSB7CgkgICAgICAgICAgICAgICAgICAgICAgICAvLyBObyBpdCBkb2Vzbid0LCBzbyB0aGVyZSdzIG5vIG5lZWQgZm9yIGFueSBjb21wdXRlZCB3cmFwcGVyLiBKdXN0IHBhc3MgdGhyb3VnaCB0aGUgc3VwcGxpZWQgdmFsdWUgZGlyZWN0bHkuCgkgICAgICAgICAgICAgICAgICAgICAgICAvLyBFeGFtcGxlOiAic29tZVZhbDogZmlyc3ROYW1lLCBhZ2U6IDEyMyIgKHdoZXRoZXIgb3Igbm90IGZpcnN0TmFtZSBpcyBhbiBvYnNlcnZhYmxlL2NvbXB1dGVkKQoJICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHBhcmFtVmFsdWVDb21wdXRlZC5wZWVrKCk7CgkgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICAgICAgICAgICAgICAvLyBZZXMgaXQgZG9lcy4gU3VwcGx5IGEgY29tcHV0ZWQgcHJvcGVydHkgdGhhdCB1bndyYXBzIGJvdGggdGhlIG91dGVyIChiaW5kaW5nIGV4cHJlc3Npb24pCgkgICAgICAgICAgICAgICAgICAgICAgICAvLyBsZXZlbCBvZiBvYnNlcnZhYmlsaXR5LCBhbmQgYW55IGlubmVyIChyZXN1bHRpbmcgbW9kZWwgdmFsdWUpIGxldmVsIG9mIG9ic2VydmFiaWxpdHkuCgkgICAgICAgICAgICAgICAgICAgICAgICAvLyBUaGlzIG1lYW5zIHRoZSBjb21wb25lbnQgZG9lc24ndCBoYXZlIHRvIHdvcnJ5IGFib3V0IG11bHRpcGxlIHVud3JhcHBpbmcuCgkgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4ga28uY29tcHV0ZWQoZnVuY3Rpb24oKSB7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUocGFyYW1WYWx1ZUNvbXB1dGVkKCkpOwoJICAgICAgICAgICAgICAgICAgICAgICAgfSwgbnVsbCwgeyBkaXNwb3NlV2hlbk5vZGVJc1JlbW92ZWQ6IGVsZW0gfSk7CgkgICAgICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICB9KTsKCgkgICAgICAgICAgICAvLyBHaXZlIGFjY2VzcyB0byB0aGUgcmF3IGNvbXB1dGVkcywgYXMgbG9uZyBhcyB0aGF0IHdvdWxkbid0IG92ZXJ3cml0ZSBhbnkgY3VzdG9tIHBhcmFtIGFsc28gY2FsbGVkICckcmF3JwoJICAgICAgICAgICAgLy8gVGhpcyBpcyBpbiBjYXNlIHRoZSBkZXZlbG9wZXIgd2FudHMgdG8gcmVhY3QgdG8gb3V0ZXIgKGJpbmRpbmcpIG9ic2VydmFiaWxpdHkgc2VwYXJhdGVseSBmcm9tIGlubmVyCgkgICAgICAgICAgICAvLyAobW9kZWwgdmFsdWUpIG9ic2VydmFiaWxpdHksIG9yIGluIGNhc2UgdGhlIG1vZGVsIHZhbHVlIG9ic2VydmFibGUgaGFzIHN1Ym9ic2VydmFibGVzLgoJICAgICAgICAgICAgaWYgKCFyZXN1bHQuaGFzT3duUHJvcGVydHkoJyRyYXcnKSkgewoJICAgICAgICAgICAgICAgIHJlc3VsdFsnJHJhdyddID0gcmF3UGFyYW1Db21wdXRlZFZhbHVlczsKCSAgICAgICAgICAgIH0KCgkgICAgICAgICAgICByZXR1cm4gcmVzdWx0OwoJICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgLy8gRm9yIGNvbnNpc3RlbmN5LCBhYnNlbmNlIG9mIGEgInBhcmFtcyIgYXR0cmlidXRlIGlzIHRyZWF0ZWQgdGhlIHNhbWUgYXMgdGhlIHByZXNlbmNlIG9mCgkgICAgICAgICAgICAvLyBhbnkgZW1wdHkgb25lLiBPdGhlcndpc2UgY29tcG9uZW50IHZpZXdtb2RlbHMgbmVlZCBzcGVjaWFsIGNvZGUgdG8gY2hlY2sgd2hldGhlciBvciBub3QKCSAgICAgICAgICAgIC8vICdwYXJhbXMnIG9yICdwYXJhbXMuJHJhdycgaXMgbnVsbC91bmRlZmluZWQgYmVmb3JlIHJlYWRpbmcgc3VicHJvcGVydGllcywgd2hpY2ggaXMgYW5ub3lpbmcuCgkgICAgICAgICAgICByZXR1cm4geyAnJHJhdyc6IHt9IH07CgkgICAgICAgIH0KCSAgICB9CgoJICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCgkgICAgLy8gQ29tcGF0aWJpbGl0eSBjb2RlIGZvciBvbGRlciAocHJlLUhUTUw1KSBJRSBicm93c2VycwoKCSAgICBpZiAoa28udXRpbHMuaWVWZXJzaW9uIDwgOSkgewoJICAgICAgICAvLyBXaGVuZXZlciB5b3UgcHJlcmVnaXN0ZXIgYSBjb21wb25lbnQsIGVuYWJsZSBpdCBhcyBhIGN1c3RvbSBlbGVtZW50IGluIHRoZSBjdXJyZW50IGRvY3VtZW50CgkgICAgICAgIGtvLmNvbXBvbmVudHNbJ3JlZ2lzdGVyJ10gPSAoZnVuY3Rpb24ob3JpZ2luYWxGdW5jdGlvbikgewoJICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKGNvbXBvbmVudE5hbWUpIHsKCSAgICAgICAgICAgICAgICBkb2N1bWVudC5jcmVhdGVFbGVtZW50KGNvbXBvbmVudE5hbWUpOyAvLyBBbGxvd3MgSUU8OSB0byBwYXJzZSBtYXJrdXAgY29udGFpbmluZyB0aGUgY3VzdG9tIGVsZW1lbnQKCSAgICAgICAgICAgICAgICByZXR1cm4gb3JpZ2luYWxGdW5jdGlvbi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoJICAgICAgICAgICAgfQoJICAgICAgICB9KShrby5jb21wb25lbnRzWydyZWdpc3RlciddKTsKCgkgICAgICAgIC8vIFdoZW5ldmVyIHlvdSBjcmVhdGUgYSBkb2N1bWVudCBmcmFnbWVudCwgZW5hYmxlIGFsbCBwcmVyZWdpc3RlcmVkIGNvbXBvbmVudCBuYW1lcyBhcyBjdXN0b20gZWxlbWVudHMKCSAgICAgICAgLy8gVGhpcyBpcyBuZWVkZWQgdG8gbWFrZSBpbm5lclNoaXYvalF1ZXJ5IEhUTUwgcGFyc2luZyBjb3JyZWN0bHkgaGFuZGxlIHRoZSBjdXN0b20gZWxlbWVudHMKCSAgICAgICAgZG9jdW1lbnQuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCA9IChmdW5jdGlvbihvcmlnaW5hbEZ1bmN0aW9uKSB7CgkgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CgkgICAgICAgICAgICAgICAgdmFyIG5ld0RvY0ZyYWcgPSBvcmlnaW5hbEZ1bmN0aW9uKCksCgkgICAgICAgICAgICAgICAgICAgIGFsbENvbXBvbmVudHMgPSBrby5jb21wb25lbnRzLl9hbGxSZWdpc3RlcmVkQ29tcG9uZW50czsKCSAgICAgICAgICAgICAgICBmb3IgKHZhciBjb21wb25lbnROYW1lIGluIGFsbENvbXBvbmVudHMpIHsKCSAgICAgICAgICAgICAgICAgICAgaWYgKGFsbENvbXBvbmVudHMuaGFzT3duUHJvcGVydHkoY29tcG9uZW50TmFtZSkpIHsKCSAgICAgICAgICAgICAgICAgICAgICAgIG5ld0RvY0ZyYWcuY3JlYXRlRWxlbWVudChjb21wb25lbnROYW1lKTsKCSAgICAgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICByZXR1cm4gbmV3RG9jRnJhZzsKCSAgICAgICAgICAgIH07CgkgICAgICAgIH0pKGRvY3VtZW50LmNyZWF0ZURvY3VtZW50RnJhZ21lbnQpOwoJICAgIH0KCX0pKCk7KGZ1bmN0aW9uKHVuZGVmaW5lZCkgewoKCSAgICB2YXIgY29tcG9uZW50TG9hZGluZ09wZXJhdGlvblVuaXF1ZUlkID0gMDsKCgkgICAga28uYmluZGluZ0hhbmRsZXJzWydjb21wb25lbnQnXSA9IHsKCSAgICAgICAgJ2luaXQnOiBmdW5jdGlvbihlbGVtZW50LCB2YWx1ZUFjY2Vzc29yLCBpZ25vcmVkMSwgaWdub3JlZDIsIGJpbmRpbmdDb250ZXh0KSB7CgkgICAgICAgICAgICB2YXIgY3VycmVudFZpZXdNb2RlbCwKCSAgICAgICAgICAgICAgICBjdXJyZW50TG9hZGluZ09wZXJhdGlvbklkLAoJICAgICAgICAgICAgICAgIGRpc3Bvc2VBc3NvY2lhdGVkQ29tcG9uZW50Vmlld01vZGVsID0gZnVuY3Rpb24gKCkgewoJICAgICAgICAgICAgICAgICAgICB2YXIgY3VycmVudFZpZXdNb2RlbERpc3Bvc2UgPSBjdXJyZW50Vmlld01vZGVsICYmIGN1cnJlbnRWaWV3TW9kZWxbJ2Rpc3Bvc2UnXTsKCSAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBjdXJyZW50Vmlld01vZGVsRGlzcG9zZSA9PT0gJ2Z1bmN0aW9uJykgewoJICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudFZpZXdNb2RlbERpc3Bvc2UuY2FsbChjdXJyZW50Vmlld01vZGVsKTsKCSAgICAgICAgICAgICAgICAgICAgfQoKCSAgICAgICAgICAgICAgICAgICAgLy8gQW55IGluLWZsaWdodCBsb2FkaW5nIG9wZXJhdGlvbiBpcyBubyBsb25nZXIgcmVsZXZhbnQsIHNvIG1ha2Ugc3VyZSB3ZSBpZ25vcmUgaXRzIGNvbXBsZXRpb24KCSAgICAgICAgICAgICAgICAgICAgY3VycmVudExvYWRpbmdPcGVyYXRpb25JZCA9IG51bGw7CgkgICAgICAgICAgICAgICAgfTsKCgkgICAgICAgICAgICBrby51dGlscy5kb21Ob2RlRGlzcG9zYWwuYWRkRGlzcG9zZUNhbGxiYWNrKGVsZW1lbnQsIGRpc3Bvc2VBc3NvY2lhdGVkQ29tcG9uZW50Vmlld01vZGVsKTsKCgkgICAgICAgICAgICBrby5jb21wdXRlZChmdW5jdGlvbiAoKSB7CgkgICAgICAgICAgICAgICAgdmFyIHZhbHVlID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZSh2YWx1ZUFjY2Vzc29yKCkpLAoJICAgICAgICAgICAgICAgICAgICBjb21wb25lbnROYW1lLCBjb21wb25lbnRQYXJhbXM7CgoJICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICdzdHJpbmcnKSB7CgkgICAgICAgICAgICAgICAgICAgIGNvbXBvbmVudE5hbWUgPSB2YWx1ZTsKCSAgICAgICAgICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgICAgICAgICBjb21wb25lbnROYW1lID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZSh2YWx1ZVsnbmFtZSddKTsKCSAgICAgICAgICAgICAgICAgICAgY29tcG9uZW50UGFyYW1zID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZSh2YWx1ZVsncGFyYW1zJ10pOwoJICAgICAgICAgICAgICAgIH0KCgkgICAgICAgICAgICAgICAgaWYgKCFjb21wb25lbnROYW1lKSB7CgkgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignTm8gY29tcG9uZW50IG5hbWUgc3BlY2lmaWVkJyk7CgkgICAgICAgICAgICAgICAgfQoKCSAgICAgICAgICAgICAgICB2YXIgbG9hZGluZ09wZXJhdGlvbklkID0gY3VycmVudExvYWRpbmdPcGVyYXRpb25JZCA9ICsrY29tcG9uZW50TG9hZGluZ09wZXJhdGlvblVuaXF1ZUlkOwoJICAgICAgICAgICAgICAgIGtvLmNvbXBvbmVudHMuZ2V0KGNvbXBvbmVudE5hbWUsIGZ1bmN0aW9uKGNvbXBvbmVudERlZmluaXRpb24pIHsKCSAgICAgICAgICAgICAgICAgICAgLy8gSWYgdGhpcyBpcyBub3QgdGhlIGN1cnJlbnQgbG9hZCBvcGVyYXRpb24gZm9yIHRoaXMgZWxlbWVudCwgaWdub3JlIGl0LgoJICAgICAgICAgICAgICAgICAgICBpZiAoY3VycmVudExvYWRpbmdPcGVyYXRpb25JZCAhPT0gbG9hZGluZ09wZXJhdGlvbklkKSB7CgkgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CgkgICAgICAgICAgICAgICAgICAgIH0KCgkgICAgICAgICAgICAgICAgICAgIC8vIENsZWFuIHVwIHByZXZpb3VzIHN0YXRlCgkgICAgICAgICAgICAgICAgICAgIGRpc3Bvc2VBc3NvY2lhdGVkQ29tcG9uZW50Vmlld01vZGVsKCk7CgoJICAgICAgICAgICAgICAgICAgICAvLyBJbnN0YW50aWF0ZSBhbmQgYmluZCBuZXcgY29tcG9uZW50LiBJbXBsaWNpdGx5IHRoaXMgY2xlYW5zIGFueSBvbGQgRE9NIG5vZGVzLgoJICAgICAgICAgICAgICAgICAgICBpZiAoIWNvbXBvbmVudERlZmluaXRpb24pIHsKCSAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignVW5rbm93biBjb21wb25lbnQgXCcnICsgY29tcG9uZW50TmFtZSArICdcJycpOwoJICAgICAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgICAgIGNsb25lVGVtcGxhdGVJbnRvRWxlbWVudChjb21wb25lbnROYW1lLCBjb21wb25lbnREZWZpbml0aW9uLCBlbGVtZW50KTsKCSAgICAgICAgICAgICAgICAgICAgdmFyIGNvbXBvbmVudFZpZXdNb2RlbCA9IGNyZWF0ZVZpZXdNb2RlbChjb21wb25lbnREZWZpbml0aW9uLCBlbGVtZW50LCBjb21wb25lbnRQYXJhbXMpLAoJICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRCaW5kaW5nQ29udGV4dCA9IGJpbmRpbmdDb250ZXh0WydjcmVhdGVDaGlsZENvbnRleHQnXShjb21wb25lbnRWaWV3TW9kZWwpOwoJICAgICAgICAgICAgICAgICAgICBjdXJyZW50Vmlld01vZGVsID0gY29tcG9uZW50Vmlld01vZGVsOwoJICAgICAgICAgICAgICAgICAgICBrby5hcHBseUJpbmRpbmdzVG9EZXNjZW5kYW50cyhjaGlsZEJpbmRpbmdDb250ZXh0LCBlbGVtZW50KTsKCSAgICAgICAgICAgICAgICB9KTsKCSAgICAgICAgICAgIH0sIG51bGwsIHsgZGlzcG9zZVdoZW5Ob2RlSXNSZW1vdmVkOiBlbGVtZW50IH0pOwoKCSAgICAgICAgICAgIHJldHVybiB7ICdjb250cm9sc0Rlc2NlbmRhbnRCaW5kaW5ncyc6IHRydWUgfTsKCSAgICAgICAgfQoJICAgIH07CgoJICAgIGtvLnZpcnR1YWxFbGVtZW50cy5hbGxvd2VkQmluZGluZ3NbJ2NvbXBvbmVudCddID0gdHJ1ZTsKCgkgICAgZnVuY3Rpb24gY2xvbmVUZW1wbGF0ZUludG9FbGVtZW50KGNvbXBvbmVudE5hbWUsIGNvbXBvbmVudERlZmluaXRpb24sIGVsZW1lbnQpIHsKCSAgICAgICAgdmFyIHRlbXBsYXRlID0gY29tcG9uZW50RGVmaW5pdGlvblsndGVtcGxhdGUnXTsKCSAgICAgICAgaWYgKCF0ZW1wbGF0ZSkgewoJICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdDb21wb25lbnQgXCcnICsgY29tcG9uZW50TmFtZSArICdcJyBoYXMgbm8gdGVtcGxhdGUnKTsKCSAgICAgICAgfQoKCSAgICAgICAgdmFyIGNsb25lZE5vZGVzQXJyYXkgPSBrby51dGlscy5jbG9uZU5vZGVzKHRlbXBsYXRlKTsKCSAgICAgICAga28udmlydHVhbEVsZW1lbnRzLnNldERvbU5vZGVDaGlsZHJlbihlbGVtZW50LCBjbG9uZWROb2Rlc0FycmF5KTsKCSAgICB9CgoJICAgIGZ1bmN0aW9uIGNyZWF0ZVZpZXdNb2RlbChjb21wb25lbnREZWZpbml0aW9uLCBlbGVtZW50LCBjb21wb25lbnRQYXJhbXMpIHsKCSAgICAgICAgdmFyIGNvbXBvbmVudFZpZXdNb2RlbEZhY3RvcnkgPSBjb21wb25lbnREZWZpbml0aW9uWydjcmVhdGVWaWV3TW9kZWwnXTsKCSAgICAgICAgcmV0dXJuIGNvbXBvbmVudFZpZXdNb2RlbEZhY3RvcnkKCSAgICAgICAgICAgID8gY29tcG9uZW50Vmlld01vZGVsRmFjdG9yeS5jYWxsKGNvbXBvbmVudERlZmluaXRpb24sIGNvbXBvbmVudFBhcmFtcywgeyBlbGVtZW50OiBlbGVtZW50IH0pCgkgICAgICAgICAgICA6IGNvbXBvbmVudFBhcmFtczsgLy8gVGVtcGxhdGUtb25seSBjb21wb25lbnQKCSAgICB9CgoJfSkoKTsKCXZhciBhdHRySHRtbFRvSmF2YXNjcmlwdE1hcCA9IHsgJ2NsYXNzJzogJ2NsYXNzTmFtZScsICdmb3InOiAnaHRtbEZvcicgfTsKCWtvLmJpbmRpbmdIYW5kbGVyc1snYXR0ciddID0gewoJICAgICd1cGRhdGUnOiBmdW5jdGlvbihlbGVtZW50LCB2YWx1ZUFjY2Vzc29yLCBhbGxCaW5kaW5ncykgewoJICAgICAgICB2YXIgdmFsdWUgPSBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKHZhbHVlQWNjZXNzb3IoKSkgfHwge307CgkgICAgICAgIGtvLnV0aWxzLm9iamVjdEZvckVhY2godmFsdWUsIGZ1bmN0aW9uKGF0dHJOYW1lLCBhdHRyVmFsdWUpIHsKCSAgICAgICAgICAgIGF0dHJWYWx1ZSA9IGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUoYXR0clZhbHVlKTsKCgkgICAgICAgICAgICAvLyBUbyBjb3ZlciBjYXNlcyBsaWtlICJhdHRyOiB7IGNoZWNrZWQ6c29tZVByb3AgfSIsIHdlIHdhbnQgdG8gcmVtb3ZlIHRoZSBhdHRyaWJ1dGUgZW50aXJlbHkKCSAgICAgICAgICAgIC8vIHdoZW4gc29tZVByb3AgaXMgYSAibm8gdmFsdWUiLWxpa2UgdmFsdWUgKHN0cmljdGx5IG51bGwsIGZhbHNlLCBvciB1bmRlZmluZWQpCgkgICAgICAgICAgICAvLyAoYmVjYXVzZSB0aGUgYWJzZW5jZSBvZiB0aGUgImNoZWNrZWQiIGF0dHIgaXMgaG93IHRvIG1hcmsgYW4gZWxlbWVudCBhcyBub3QgY2hlY2tlZCwgZXRjLikKCSAgICAgICAgICAgIHZhciB0b1JlbW92ZSA9IChhdHRyVmFsdWUgPT09IGZhbHNlKSB8fCAoYXR0clZhbHVlID09PSBudWxsKSB8fCAoYXR0clZhbHVlID09PSB1bmRlZmluZWQpOwoJICAgICAgICAgICAgaWYgKHRvUmVtb3ZlKQoJICAgICAgICAgICAgICAgIGVsZW1lbnQucmVtb3ZlQXR0cmlidXRlKGF0dHJOYW1lKTsKCgkgICAgICAgICAgICAvLyBJbiBJRSA8PSA3IGFuZCBJRTggUXVpcmtzIE1vZGUsIHlvdSBoYXZlIHRvIHVzZSB0aGUgSmF2YXNjcmlwdCBwcm9wZXJ0eSBuYW1lIGluc3RlYWQgb2YgdGhlCgkgICAgICAgICAgICAvLyBIVE1MIGF0dHJpYnV0ZSBuYW1lIGZvciBjZXJ0YWluIGF0dHJpYnV0ZXMuIElFOCBTdGFuZGFyZHMgTW9kZSBzdXBwb3J0cyB0aGUgY29ycmVjdCBiZWhhdmlvciwKCSAgICAgICAgICAgIC8vIGJ1dCBpbnN0ZWFkIG9mIGZpZ3VyaW5nIG91dCB0aGUgbW9kZSwgd2UnbGwganVzdCBzZXQgdGhlIGF0dHJpYnV0ZSB0aHJvdWdoIHRoZSBKYXZhc2NyaXB0CgkgICAgICAgICAgICAvLyBwcm9wZXJ0eSBmb3IgSUUgPD0gOC4KCSAgICAgICAgICAgIGlmIChrby51dGlscy5pZVZlcnNpb24gPD0gOCAmJiBhdHRyTmFtZSBpbiBhdHRySHRtbFRvSmF2YXNjcmlwdE1hcCkgewoJICAgICAgICAgICAgICAgIGF0dHJOYW1lID0gYXR0ckh0bWxUb0phdmFzY3JpcHRNYXBbYXR0ck5hbWVdOwoJICAgICAgICAgICAgICAgIGlmICh0b1JlbW92ZSkKCSAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5yZW1vdmVBdHRyaWJ1dGUoYXR0ck5hbWUpOwoJICAgICAgICAgICAgICAgIGVsc2UKCSAgICAgICAgICAgICAgICAgICAgZWxlbWVudFthdHRyTmFtZV0gPSBhdHRyVmFsdWU7CgkgICAgICAgICAgICB9IGVsc2UgaWYgKCF0b1JlbW92ZSkgewoJICAgICAgICAgICAgICAgIGVsZW1lbnQuc2V0QXR0cmlidXRlKGF0dHJOYW1lLCBhdHRyVmFsdWUudG9TdHJpbmcoKSk7CgkgICAgICAgICAgICB9CgoJICAgICAgICAgICAgLy8gVHJlYXQgIm5hbWUiIHNwZWNpYWxseSAtIGFsdGhvdWdoIHlvdSBjYW4gdGhpbmsgb2YgaXQgYXMgYW4gYXR0cmlidXRlLCBpdCBhbHNvIG5lZWRzCgkgICAgICAgICAgICAvLyBzcGVjaWFsIGhhbmRsaW5nIG9uIG9sZGVyIHZlcnNpb25zIG9mIElFIChodHRwczovL2dpdGh1Yi5jb20vU3RldmVTYW5kZXJzb24va25vY2tvdXQvcHVsbC8zMzMpCgkgICAgICAgICAgICAvLyBEZWxpYmVyYXRlbHkgYmVpbmcgY2FzZS1zZW5zaXRpdmUgaGVyZSBiZWNhdXNlIFhIVE1MIHdvdWxkIHJlZ2FyZCAiTmFtZSIgYXMgYSBkaWZmZXJlbnQgdGhpbmcKCSAgICAgICAgICAgIC8vIGVudGlyZWx5LCBhbmQgdGhlcmUncyBubyBzdHJvbmcgcmVhc29uIHRvIGFsbG93IGZvciBzdWNoIGNhc2luZyBpbiBIVE1MLgoJICAgICAgICAgICAgaWYgKGF0dHJOYW1lID09PSAibmFtZSIpIHsKCSAgICAgICAgICAgICAgICBrby51dGlscy5zZXRFbGVtZW50TmFtZShlbGVtZW50LCB0b1JlbW92ZSA/ICIiIDogYXR0clZhbHVlLnRvU3RyaW5nKCkpOwoJICAgICAgICAgICAgfQoJICAgICAgICB9KTsKCSAgICB9Cgl9OwoJKGZ1bmN0aW9uKCkgewoKCWtvLmJpbmRpbmdIYW5kbGVyc1snY2hlY2tlZCddID0gewoJICAgICdhZnRlcic6IFsndmFsdWUnLCAnYXR0ciddLAoJICAgICdpbml0JzogZnVuY3Rpb24gKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IsIGFsbEJpbmRpbmdzKSB7CgkgICAgICAgIHZhciBjaGVja2VkVmFsdWUgPSBrby5wdXJlQ29tcHV0ZWQoZnVuY3Rpb24oKSB7CgkgICAgICAgICAgICAvLyBUcmVhdCAidmFsdWUiIGxpa2UgImNoZWNrZWRWYWx1ZSIgd2hlbiBpdCBpcyBpbmNsdWRlZCB3aXRoICJjaGVja2VkIiBiaW5kaW5nCgkgICAgICAgICAgICBpZiAoYWxsQmluZGluZ3NbJ2hhcyddKCdjaGVja2VkVmFsdWUnKSkgewoJICAgICAgICAgICAgICAgIHJldHVybiBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKGFsbEJpbmRpbmdzLmdldCgnY2hlY2tlZFZhbHVlJykpOwoJICAgICAgICAgICAgfSBlbHNlIGlmIChhbGxCaW5kaW5nc1snaGFzJ10oJ3ZhbHVlJykpIHsKCSAgICAgICAgICAgICAgICByZXR1cm4ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZShhbGxCaW5kaW5ncy5nZXQoJ3ZhbHVlJykpOwoJICAgICAgICAgICAgfQoKCSAgICAgICAgICAgIHJldHVybiBlbGVtZW50LnZhbHVlOwoJICAgICAgICB9KTsKCgkgICAgICAgIGZ1bmN0aW9uIHVwZGF0ZU1vZGVsKCkgewoJICAgICAgICAgICAgLy8gVGhpcyB1cGRhdGVzIHRoZSBtb2RlbCB2YWx1ZSBmcm9tIHRoZSB2aWV3IHZhbHVlLgoJICAgICAgICAgICAgLy8gSXQgcnVucyBpbiByZXNwb25zZSB0byBET00gZXZlbnRzIChjbGljaykgYW5kIGNoYW5nZXMgaW4gY2hlY2tlZFZhbHVlLgoJICAgICAgICAgICAgdmFyIGlzQ2hlY2tlZCA9IGVsZW1lbnQuY2hlY2tlZCwKCSAgICAgICAgICAgICAgICBlbGVtVmFsdWUgPSB1c2VDaGVja2VkVmFsdWUgPyBjaGVja2VkVmFsdWUoKSA6IGlzQ2hlY2tlZDsKCgkgICAgICAgICAgICAvLyBXaGVuIHdlJ3JlIGZpcnN0IHNldHRpbmcgdXAgdGhpcyBjb21wdXRlZCwgZG9uJ3QgY2hhbmdlIGFueSBtb2RlbCBzdGF0ZS4KCSAgICAgICAgICAgIGlmIChrby5jb21wdXRlZENvbnRleHQuaXNJbml0aWFsKCkpIHsKCSAgICAgICAgICAgICAgICByZXR1cm47CgkgICAgICAgICAgICB9CgoJICAgICAgICAgICAgLy8gV2UgY2FuIGlnbm9yZSB1bmNoZWNrZWQgcmFkaW8gYnV0dG9ucywgYmVjYXVzZSBzb21lIG90aGVyIHJhZGlvCgkgICAgICAgICAgICAvLyBidXR0b24gd2lsbCBiZSBnZXR0aW5nIGNoZWNrZWQsIGFuZCB0aGF0IG9uZSBjYW4gdGFrZSBjYXJlIG9mIHVwZGF0aW5nIHN0YXRlLgoJICAgICAgICAgICAgaWYgKGlzUmFkaW8gJiYgIWlzQ2hlY2tlZCkgewoJICAgICAgICAgICAgICAgIHJldHVybjsKCSAgICAgICAgICAgIH0KCgkgICAgICAgICAgICB2YXIgbW9kZWxWYWx1ZSA9IGtvLmRlcGVuZGVuY3lEZXRlY3Rpb24uaWdub3JlKHZhbHVlQWNjZXNzb3IpOwoJICAgICAgICAgICAgaWYgKGlzVmFsdWVBcnJheSkgewoJICAgICAgICAgICAgICAgIGlmIChvbGRFbGVtVmFsdWUgIT09IGVsZW1WYWx1ZSkgewoJICAgICAgICAgICAgICAgICAgICAvLyBXaGVuIHdlJ3JlIHJlc3BvbmRpbmcgdG8gdGhlIGNoZWNrZWRWYWx1ZSBjaGFuZ2luZywgYW5kIHRoZSBlbGVtZW50IGlzCgkgICAgICAgICAgICAgICAgICAgIC8vIGN1cnJlbnRseSBjaGVja2VkLCByZXBsYWNlIHRoZSBvbGQgZWxlbSB2YWx1ZSB3aXRoIHRoZSBuZXcgZWxlbSB2YWx1ZQoJICAgICAgICAgICAgICAgICAgICAvLyBpbiB0aGUgbW9kZWwgYXJyYXkuCgkgICAgICAgICAgICAgICAgICAgIGlmIChpc0NoZWNrZWQpIHsKCSAgICAgICAgICAgICAgICAgICAgICAgIGtvLnV0aWxzLmFkZE9yUmVtb3ZlSXRlbShtb2RlbFZhbHVlLCBlbGVtVmFsdWUsIHRydWUpOwoJICAgICAgICAgICAgICAgICAgICAgICAga28udXRpbHMuYWRkT3JSZW1vdmVJdGVtKG1vZGVsVmFsdWUsIG9sZEVsZW1WYWx1ZSwgZmFsc2UpOwoJICAgICAgICAgICAgICAgICAgICB9CgoJICAgICAgICAgICAgICAgICAgICBvbGRFbGVtVmFsdWUgPSBlbGVtVmFsdWU7CgkgICAgICAgICAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgICAgICAgICAgLy8gV2hlbiB3ZSdyZSByZXNwb25kaW5nIHRvIHRoZSB1c2VyIGhhdmluZyBjaGVja2VkL3VuY2hlY2tlZCBhIGNoZWNrYm94LAoJICAgICAgICAgICAgICAgICAgICAvLyBhZGQvcmVtb3ZlIHRoZSBlbGVtZW50IHZhbHVlIHRvIHRoZSBtb2RlbCBhcnJheS4KCSAgICAgICAgICAgICAgICAgICAga28udXRpbHMuYWRkT3JSZW1vdmVJdGVtKG1vZGVsVmFsdWUsIGVsZW1WYWx1ZSwgaXNDaGVja2VkKTsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgICAgIGtvLmV4cHJlc3Npb25SZXdyaXRpbmcud3JpdGVWYWx1ZVRvUHJvcGVydHkobW9kZWxWYWx1ZSwgYWxsQmluZGluZ3MsICdjaGVja2VkJywgZWxlbVZhbHVlLCB0cnVlKTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgfTsKCgkgICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVZpZXcoKSB7CgkgICAgICAgICAgICAvLyBUaGlzIHVwZGF0ZXMgdGhlIHZpZXcgdmFsdWUgZnJvbSB0aGUgbW9kZWwgdmFsdWUuCgkgICAgICAgICAgICAvLyBJdCBydW5zIGluIHJlc3BvbnNlIHRvIGNoYW5nZXMgaW4gdGhlIGJvdW5kIChjaGVja2VkKSB2YWx1ZS4KCSAgICAgICAgICAgIHZhciBtb2RlbFZhbHVlID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZSh2YWx1ZUFjY2Vzc29yKCkpOwoKCSAgICAgICAgICAgIGlmIChpc1ZhbHVlQXJyYXkpIHsKCSAgICAgICAgICAgICAgICAvLyBXaGVuIGEgY2hlY2tib3ggaXMgYm91bmQgdG8gYW4gYXJyYXksIGJlaW5nIGNoZWNrZWQgcmVwcmVzZW50cyBpdHMgdmFsdWUgYmVpbmcgcHJlc2VudCBpbiB0aGF0IGFycmF5CgkgICAgICAgICAgICAgICAgZWxlbWVudC5jaGVja2VkID0ga28udXRpbHMuYXJyYXlJbmRleE9mKG1vZGVsVmFsdWUsIGNoZWNrZWRWYWx1ZSgpKSA+PSAwOwoJICAgICAgICAgICAgfSBlbHNlIGlmIChpc0NoZWNrYm94KSB7CgkgICAgICAgICAgICAgICAgLy8gV2hlbiBhIGNoZWNrYm94IGlzIGJvdW5kIHRvIGFueSBvdGhlciB2YWx1ZSAobm90IGFuIGFycmF5KSwgYmVpbmcgY2hlY2tlZCByZXByZXNlbnRzIHRoZSB2YWx1ZSBiZWluZyB0cnVlaXNoCgkgICAgICAgICAgICAgICAgZWxlbWVudC5jaGVja2VkID0gbW9kZWxWYWx1ZTsKCSAgICAgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICAgICAgLy8gRm9yIHJhZGlvIGJ1dHRvbnMsIGJlaW5nIGNoZWNrZWQgbWVhbnMgdGhhdCB0aGUgcmFkaW8gYnV0dG9uJ3MgdmFsdWUgY29ycmVzcG9uZHMgdG8gdGhlIG1vZGVsIHZhbHVlCgkgICAgICAgICAgICAgICAgZWxlbWVudC5jaGVja2VkID0gKGNoZWNrZWRWYWx1ZSgpID09PSBtb2RlbFZhbHVlKTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgfTsKCgkgICAgICAgIHZhciBpc0NoZWNrYm94ID0gZWxlbWVudC50eXBlID09ICJjaGVja2JveCIsCgkgICAgICAgICAgICBpc1JhZGlvID0gZWxlbWVudC50eXBlID09ICJyYWRpbyI7CgoJICAgICAgICAvLyBPbmx5IGJpbmQgdG8gY2hlY2sgYm94ZXMgYW5kIHJhZGlvIGJ1dHRvbnMKCSAgICAgICAgaWYgKCFpc0NoZWNrYm94ICYmICFpc1JhZGlvKSB7CgkgICAgICAgICAgICByZXR1cm47CgkgICAgICAgIH0KCgkgICAgICAgIHZhciBpc1ZhbHVlQXJyYXkgPSBpc0NoZWNrYm94ICYmIChrby51dGlscy51bndyYXBPYnNlcnZhYmxlKHZhbHVlQWNjZXNzb3IoKSkgaW5zdGFuY2VvZiBBcnJheSksCgkgICAgICAgICAgICBvbGRFbGVtVmFsdWUgPSBpc1ZhbHVlQXJyYXkgPyBjaGVja2VkVmFsdWUoKSA6IHVuZGVmaW5lZCwKCSAgICAgICAgICAgIHVzZUNoZWNrZWRWYWx1ZSA9IGlzUmFkaW8gfHwgaXNWYWx1ZUFycmF5OwoKCSAgICAgICAgLy8gSUUgNiB3b24ndCBhbGxvdyByYWRpbyBidXR0b25zIHRvIGJlIHNlbGVjdGVkIHVubGVzcyB0aGV5IGhhdmUgYSBuYW1lCgkgICAgICAgIGlmIChpc1JhZGlvICYmICFlbGVtZW50Lm5hbWUpCgkgICAgICAgICAgICBrby5iaW5kaW5nSGFuZGxlcnNbJ3VuaXF1ZU5hbWUnXVsnaW5pdCddKGVsZW1lbnQsIGZ1bmN0aW9uKCkgeyByZXR1cm4gdHJ1ZSB9KTsKCgkgICAgICAgIC8vIFNldCB1cCB0d28gY29tcHV0ZWRzIHRvIHVwZGF0ZSB0aGUgYmluZGluZzoKCgkgICAgICAgIC8vIFRoZSBmaXJzdCByZXNwb25kcyB0byBjaGFuZ2VzIGluIHRoZSBjaGVja2VkVmFsdWUgdmFsdWUgYW5kIHRvIGVsZW1lbnQgY2xpY2tzCgkgICAgICAgIGtvLmNvbXB1dGVkKHVwZGF0ZU1vZGVsLCBudWxsLCB7IGRpc3Bvc2VXaGVuTm9kZUlzUmVtb3ZlZDogZWxlbWVudCB9KTsKCSAgICAgICAga28udXRpbHMucmVnaXN0ZXJFdmVudEhhbmRsZXIoZWxlbWVudCwgImNsaWNrIiwgdXBkYXRlTW9kZWwpOwoKCSAgICAgICAgLy8gVGhlIHNlY29uZCByZXNwb25kcyB0byBjaGFuZ2VzIGluIHRoZSBtb2RlbCB2YWx1ZSAodGhlIG9uZSBhc3NvY2lhdGVkIHdpdGggdGhlIGNoZWNrZWQgYmluZGluZykKCSAgICAgICAga28uY29tcHV0ZWQodXBkYXRlVmlldywgbnVsbCwgeyBkaXNwb3NlV2hlbk5vZGVJc1JlbW92ZWQ6IGVsZW1lbnQgfSk7CgkgICAgfQoJfTsKCWtvLmV4cHJlc3Npb25SZXdyaXRpbmcudHdvV2F5QmluZGluZ3NbJ2NoZWNrZWQnXSA9IHRydWU7CgoJa28uYmluZGluZ0hhbmRsZXJzWydjaGVja2VkVmFsdWUnXSA9IHsKCSAgICAndXBkYXRlJzogZnVuY3Rpb24gKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IpIHsKCSAgICAgICAgZWxlbWVudC52YWx1ZSA9IGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUodmFsdWVBY2Nlc3NvcigpKTsKCSAgICB9Cgl9OwoKCX0pKCk7dmFyIGNsYXNzZXNXcml0dGVuQnlCaW5kaW5nS2V5ID0gJ19fa29fX2Nzc1ZhbHVlJzsKCWtvLmJpbmRpbmdIYW5kbGVyc1snY3NzJ10gPSB7CgkgICAgJ3VwZGF0ZSc6IGZ1bmN0aW9uIChlbGVtZW50LCB2YWx1ZUFjY2Vzc29yKSB7CgkgICAgICAgIHZhciB2YWx1ZSA9IGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUodmFsdWVBY2Nlc3NvcigpKTsKCSAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PSAib2JqZWN0IikgewoJICAgICAgICAgICAga28udXRpbHMub2JqZWN0Rm9yRWFjaCh2YWx1ZSwgZnVuY3Rpb24oY2xhc3NOYW1lLCBzaG91bGRIYXZlQ2xhc3MpIHsKCSAgICAgICAgICAgICAgICBzaG91bGRIYXZlQ2xhc3MgPSBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKHNob3VsZEhhdmVDbGFzcyk7CgkgICAgICAgICAgICAgICAga28udXRpbHMudG9nZ2xlRG9tTm9kZUNzc0NsYXNzKGVsZW1lbnQsIGNsYXNzTmFtZSwgc2hvdWxkSGF2ZUNsYXNzKTsKCSAgICAgICAgICAgIH0pOwoJICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgdmFsdWUgPSBTdHJpbmcodmFsdWUgfHwgJycpOyAvLyBNYWtlIHN1cmUgd2UgZG9uJ3QgdHJ5IHRvIHN0b3JlIG9yIHNldCBhIG5vbi1zdHJpbmcgdmFsdWUKCSAgICAgICAgICAgIGtvLnV0aWxzLnRvZ2dsZURvbU5vZGVDc3NDbGFzcyhlbGVtZW50LCBlbGVtZW50W2NsYXNzZXNXcml0dGVuQnlCaW5kaW5nS2V5XSwgZmFsc2UpOwoJICAgICAgICAgICAgZWxlbWVudFtjbGFzc2VzV3JpdHRlbkJ5QmluZGluZ0tleV0gPSB2YWx1ZTsKCSAgICAgICAgICAgIGtvLnV0aWxzLnRvZ2dsZURvbU5vZGVDc3NDbGFzcyhlbGVtZW50LCB2YWx1ZSwgdHJ1ZSk7CgkgICAgICAgIH0KCSAgICB9Cgl9OwoJa28uYmluZGluZ0hhbmRsZXJzWydlbmFibGUnXSA9IHsKCSAgICAndXBkYXRlJzogZnVuY3Rpb24gKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IpIHsKCSAgICAgICAgdmFyIHZhbHVlID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZSh2YWx1ZUFjY2Vzc29yKCkpOwoJICAgICAgICBpZiAodmFsdWUgJiYgZWxlbWVudC5kaXNhYmxlZCkKCSAgICAgICAgICAgIGVsZW1lbnQucmVtb3ZlQXR0cmlidXRlKCJkaXNhYmxlZCIpOwoJICAgICAgICBlbHNlIGlmICgoIXZhbHVlKSAmJiAoIWVsZW1lbnQuZGlzYWJsZWQpKQoJICAgICAgICAgICAgZWxlbWVudC5kaXNhYmxlZCA9IHRydWU7CgkgICAgfQoJfTsKCglrby5iaW5kaW5nSGFuZGxlcnNbJ2Rpc2FibGUnXSA9IHsKCSAgICAndXBkYXRlJzogZnVuY3Rpb24gKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IpIHsKCSAgICAgICAga28uYmluZGluZ0hhbmRsZXJzWydlbmFibGUnXVsndXBkYXRlJ10oZWxlbWVudCwgZnVuY3Rpb24oKSB7IHJldHVybiAha28udXRpbHMudW53cmFwT2JzZXJ2YWJsZSh2YWx1ZUFjY2Vzc29yKCkpIH0pOwoJICAgIH0KCX07CgkvLyBGb3IgY2VydGFpbiBjb21tb24gZXZlbnRzIChjdXJyZW50bHkganVzdCAnY2xpY2snKSwgYWxsb3cgYSBzaW1wbGlmaWVkIGRhdGEtYmluZGluZyBzeW50YXgKCS8vIGUuZy4gY2xpY2s6aGFuZGxlciBpbnN0ZWFkIG9mIHRoZSB1c3VhbCBmdWxsLWxlbmd0aCBldmVudDp7Y2xpY2s6aGFuZGxlcn0KCWZ1bmN0aW9uIG1ha2VFdmVudEhhbmRsZXJTaG9ydGN1dChldmVudE5hbWUpIHsKCSAgICBrby5iaW5kaW5nSGFuZGxlcnNbZXZlbnROYW1lXSA9IHsKCSAgICAgICAgJ2luaXQnOiBmdW5jdGlvbihlbGVtZW50LCB2YWx1ZUFjY2Vzc29yLCBhbGxCaW5kaW5ncywgdmlld01vZGVsLCBiaW5kaW5nQ29udGV4dCkgewoJICAgICAgICAgICAgdmFyIG5ld1ZhbHVlQWNjZXNzb3IgPSBmdW5jdGlvbiAoKSB7CgkgICAgICAgICAgICAgICAgdmFyIHJlc3VsdCA9IHt9OwoJICAgICAgICAgICAgICAgIHJlc3VsdFtldmVudE5hbWVdID0gdmFsdWVBY2Nlc3NvcigpOwoJICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHQ7CgkgICAgICAgICAgICB9OwoJICAgICAgICAgICAgcmV0dXJuIGtvLmJpbmRpbmdIYW5kbGVyc1snZXZlbnQnXVsnaW5pdCddLmNhbGwodGhpcywgZWxlbWVudCwgbmV3VmFsdWVBY2Nlc3NvciwgYWxsQmluZGluZ3MsIHZpZXdNb2RlbCwgYmluZGluZ0NvbnRleHQpOwoJICAgICAgICB9CgkgICAgfQoJfQoKCWtvLmJpbmRpbmdIYW5kbGVyc1snZXZlbnQnXSA9IHsKCSAgICAnaW5pdCcgOiBmdW5jdGlvbiAoZWxlbWVudCwgdmFsdWVBY2Nlc3NvciwgYWxsQmluZGluZ3MsIHZpZXdNb2RlbCwgYmluZGluZ0NvbnRleHQpIHsKCSAgICAgICAgdmFyIGV2ZW50c1RvSGFuZGxlID0gdmFsdWVBY2Nlc3NvcigpIHx8IHt9OwoJICAgICAgICBrby51dGlscy5vYmplY3RGb3JFYWNoKGV2ZW50c1RvSGFuZGxlLCBmdW5jdGlvbihldmVudE5hbWUpIHsKCSAgICAgICAgICAgIGlmICh0eXBlb2YgZXZlbnROYW1lID09ICJzdHJpbmciKSB7CgkgICAgICAgICAgICAgICAga28udXRpbHMucmVnaXN0ZXJFdmVudEhhbmRsZXIoZWxlbWVudCwgZXZlbnROYW1lLCBmdW5jdGlvbiAoZXZlbnQpIHsKCSAgICAgICAgICAgICAgICAgICAgdmFyIGhhbmRsZXJSZXR1cm5WYWx1ZTsKCSAgICAgICAgICAgICAgICAgICAgdmFyIGhhbmRsZXJGdW5jdGlvbiA9IHZhbHVlQWNjZXNzb3IoKVtldmVudE5hbWVdOwoJICAgICAgICAgICAgICAgICAgICBpZiAoIWhhbmRsZXJGdW5jdGlvbikKCSAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKCgkgICAgICAgICAgICAgICAgICAgIHRyeSB7CgkgICAgICAgICAgICAgICAgICAgICAgICAvLyBUYWtlIGFsbCB0aGUgZXZlbnQgYXJncywgYW5kIHByZWZpeCB3aXRoIHRoZSB2aWV3bW9kZWwKCSAgICAgICAgICAgICAgICAgICAgICAgIHZhciBhcmdzRm9ySGFuZGxlciA9IGtvLnV0aWxzLm1ha2VBcnJheShhcmd1bWVudHMpOwoJICAgICAgICAgICAgICAgICAgICAgICAgdmlld01vZGVsID0gYmluZGluZ0NvbnRleHRbJyRkYXRhJ107CgkgICAgICAgICAgICAgICAgICAgICAgICBhcmdzRm9ySGFuZGxlci51bnNoaWZ0KHZpZXdNb2RlbCk7CgkgICAgICAgICAgICAgICAgICAgICAgICBoYW5kbGVyUmV0dXJuVmFsdWUgPSBoYW5kbGVyRnVuY3Rpb24uYXBwbHkodmlld01vZGVsLCBhcmdzRm9ySGFuZGxlcik7CgkgICAgICAgICAgICAgICAgICAgIH0gZmluYWxseSB7CgkgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaGFuZGxlclJldHVyblZhbHVlICE9PSB0cnVlKSB7IC8vIE5vcm1hbGx5IHdlIHdhbnQgdG8gcHJldmVudCBkZWZhdWx0IGFjdGlvbi4gRGV2ZWxvcGVyIGNhbiBvdmVycmlkZSB0aGlzIGJlIGV4cGxpY2l0bHkgcmV0dXJuaW5nIHRydWUuCgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGV2ZW50LnByZXZlbnREZWZhdWx0KQoJICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQucmV0dXJuVmFsdWUgPSBmYWxzZTsKCSAgICAgICAgICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICAgICAgfQoKCSAgICAgICAgICAgICAgICAgICAgdmFyIGJ1YmJsZSA9IGFsbEJpbmRpbmdzLmdldChldmVudE5hbWUgKyAnQnViYmxlJykgIT09IGZhbHNlOwoJICAgICAgICAgICAgICAgICAgICBpZiAoIWJ1YmJsZSkgewoJICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQuY2FuY2VsQnViYmxlID0gdHJ1ZTsKCSAgICAgICAgICAgICAgICAgICAgICAgIGlmIChldmVudC5zdG9wUHJvcGFnYXRpb24pCgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7CgkgICAgICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICB9KTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgfSk7CgkgICAgfQoJfTsKCS8vICJmb3JlYWNoOiBzb21lRXhwcmVzc2lvbiIgaXMgZXF1aXZhbGVudCB0byAidGVtcGxhdGU6IHsgZm9yZWFjaDogc29tZUV4cHJlc3Npb24gfSIKCS8vICJmb3JlYWNoOiB7IGRhdGE6IHNvbWVFeHByZXNzaW9uLCBhZnRlckFkZDogbXlmbiB9IiBpcyBlcXVpdmFsZW50IHRvICJ0ZW1wbGF0ZTogeyBmb3JlYWNoOiBzb21lRXhwcmVzc2lvbiwgYWZ0ZXJBZGQ6IG15Zm4gfSIKCWtvLmJpbmRpbmdIYW5kbGVyc1snZm9yZWFjaCddID0gewoJICAgIG1ha2VUZW1wbGF0ZVZhbHVlQWNjZXNzb3I6IGZ1bmN0aW9uKHZhbHVlQWNjZXNzb3IpIHsKCSAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewoJICAgICAgICAgICAgdmFyIG1vZGVsVmFsdWUgPSB2YWx1ZUFjY2Vzc29yKCksCgkgICAgICAgICAgICAgICAgdW53cmFwcGVkVmFsdWUgPSBrby51dGlscy5wZWVrT2JzZXJ2YWJsZShtb2RlbFZhbHVlKTsgICAgLy8gVW53cmFwIHdpdGhvdXQgc2V0dGluZyBhIGRlcGVuZGVuY3kgaGVyZQoKCSAgICAgICAgICAgIC8vIElmIHVud3JhcHBlZFZhbHVlIGlzIHRoZSBhcnJheSwgcGFzcyBpbiB0aGUgd3JhcHBlZCB2YWx1ZSBvbiBpdHMgb3duCgkgICAgICAgICAgICAvLyBUaGUgdmFsdWUgd2lsbCBiZSB1bndyYXBwZWQgYW5kIHRyYWNrZWQgd2l0aGluIHRoZSB0ZW1wbGF0ZSBiaW5kaW5nCgkgICAgICAgICAgICAvLyAoU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9TdGV2ZVNhbmRlcnNvbi9rbm9ja291dC9pc3N1ZXMvNTIzKQoJICAgICAgICAgICAgaWYgKCghdW53cmFwcGVkVmFsdWUpIHx8IHR5cGVvZiB1bndyYXBwZWRWYWx1ZS5sZW5ndGggPT0gIm51bWJlciIpCgkgICAgICAgICAgICAgICAgcmV0dXJuIHsgJ2ZvcmVhY2gnOiBtb2RlbFZhbHVlLCAndGVtcGxhdGVFbmdpbmUnOiBrby5uYXRpdmVUZW1wbGF0ZUVuZ2luZS5pbnN0YW5jZSB9OwoKCSAgICAgICAgICAgIC8vIElmIHVud3JhcHBlZFZhbHVlLmRhdGEgaXMgdGhlIGFycmF5LCBwcmVzZXJ2ZSBhbGwgcmVsZXZhbnQgb3B0aW9ucyBhbmQgdW53cmFwIGFnYWluIHZhbHVlIHNvIHdlIGdldCB1cGRhdGVzCgkgICAgICAgICAgICBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKG1vZGVsVmFsdWUpOwoJICAgICAgICAgICAgcmV0dXJuIHsKCSAgICAgICAgICAgICAgICAnZm9yZWFjaCc6IHVud3JhcHBlZFZhbHVlWydkYXRhJ10sCgkgICAgICAgICAgICAgICAgJ2FzJzogdW53cmFwcGVkVmFsdWVbJ2FzJ10sCgkgICAgICAgICAgICAgICAgJ2luY2x1ZGVEZXN0cm95ZWQnOiB1bndyYXBwZWRWYWx1ZVsnaW5jbHVkZURlc3Ryb3llZCddLAoJICAgICAgICAgICAgICAgICdhZnRlckFkZCc6IHVud3JhcHBlZFZhbHVlWydhZnRlckFkZCddLAoJICAgICAgICAgICAgICAgICdiZWZvcmVSZW1vdmUnOiB1bndyYXBwZWRWYWx1ZVsnYmVmb3JlUmVtb3ZlJ10sCgkgICAgICAgICAgICAgICAgJ2FmdGVyUmVuZGVyJzogdW53cmFwcGVkVmFsdWVbJ2FmdGVyUmVuZGVyJ10sCgkgICAgICAgICAgICAgICAgJ2JlZm9yZU1vdmUnOiB1bndyYXBwZWRWYWx1ZVsnYmVmb3JlTW92ZSddLAoJICAgICAgICAgICAgICAgICdhZnRlck1vdmUnOiB1bndyYXBwZWRWYWx1ZVsnYWZ0ZXJNb3ZlJ10sCgkgICAgICAgICAgICAgICAgJ3RlbXBsYXRlRW5naW5lJzoga28ubmF0aXZlVGVtcGxhdGVFbmdpbmUuaW5zdGFuY2UKCSAgICAgICAgICAgIH07CgkgICAgICAgIH07CgkgICAgfSwKCSAgICAnaW5pdCc6IGZ1bmN0aW9uKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IsIGFsbEJpbmRpbmdzLCB2aWV3TW9kZWwsIGJpbmRpbmdDb250ZXh0KSB7CgkgICAgICAgIHJldHVybiBrby5iaW5kaW5nSGFuZGxlcnNbJ3RlbXBsYXRlJ11bJ2luaXQnXShlbGVtZW50LCBrby5iaW5kaW5nSGFuZGxlcnNbJ2ZvcmVhY2gnXS5tYWtlVGVtcGxhdGVWYWx1ZUFjY2Vzc29yKHZhbHVlQWNjZXNzb3IpKTsKCSAgICB9LAoJICAgICd1cGRhdGUnOiBmdW5jdGlvbihlbGVtZW50LCB2YWx1ZUFjY2Vzc29yLCBhbGxCaW5kaW5ncywgdmlld01vZGVsLCBiaW5kaW5nQ29udGV4dCkgewoJICAgICAgICByZXR1cm4ga28uYmluZGluZ0hhbmRsZXJzWyd0ZW1wbGF0ZSddWyd1cGRhdGUnXShlbGVtZW50LCBrby5iaW5kaW5nSGFuZGxlcnNbJ2ZvcmVhY2gnXS5tYWtlVGVtcGxhdGVWYWx1ZUFjY2Vzc29yKHZhbHVlQWNjZXNzb3IpLCBhbGxCaW5kaW5ncywgdmlld01vZGVsLCBiaW5kaW5nQ29udGV4dCk7CgkgICAgfQoJfTsKCWtvLmV4cHJlc3Npb25SZXdyaXRpbmcuYmluZGluZ1Jld3JpdGVWYWxpZGF0b3JzWydmb3JlYWNoJ10gPSBmYWxzZTsgLy8gQ2FuJ3QgcmV3cml0ZSBjb250cm9sIGZsb3cgYmluZGluZ3MKCWtvLnZpcnR1YWxFbGVtZW50cy5hbGxvd2VkQmluZGluZ3NbJ2ZvcmVhY2gnXSA9IHRydWU7Cgl2YXIgaGFzZm9jdXNVcGRhdGluZ1Byb3BlcnR5ID0gJ19fa29faGFzZm9jdXNVcGRhdGluZyc7Cgl2YXIgaGFzZm9jdXNMYXN0VmFsdWUgPSAnX19rb19oYXNmb2N1c0xhc3RWYWx1ZSc7Cglrby5iaW5kaW5nSGFuZGxlcnNbJ2hhc2ZvY3VzJ10gPSB7CgkgICAgJ2luaXQnOiBmdW5jdGlvbihlbGVtZW50LCB2YWx1ZUFjY2Vzc29yLCBhbGxCaW5kaW5ncykgewoJICAgICAgICB2YXIgaGFuZGxlRWxlbWVudEZvY3VzQ2hhbmdlID0gZnVuY3Rpb24oaXNGb2N1c2VkKSB7CgkgICAgICAgICAgICAvLyBXaGVyZSBwb3NzaWJsZSwgaWdub3JlIHdoaWNoIGV2ZW50IHdhcyByYWlzZWQgYW5kIGRldGVybWluZSBmb2N1cyBzdGF0ZSB1c2luZyBhY3RpdmVFbGVtZW50LAoJICAgICAgICAgICAgLy8gYXMgdGhpcyBhdm9pZHMgcGhhbnRvbSBmb2N1cy9ibHVyIGV2ZW50cyByYWlzZWQgd2hlbiBjaGFuZ2luZyB0YWJzIGluIG1vZGVybiBicm93c2Vycy4KCSAgICAgICAgICAgIC8vIEhvd2V2ZXIsIG5vdCBhbGwgS08tdGFyZ2V0ZWQgYnJvd3NlcnMgKEZpcmVmb3ggMikgc3VwcG9ydCBhY3RpdmVFbGVtZW50LiBGb3IgdGhvc2UgYnJvd3NlcnMsCgkgICAgICAgICAgICAvLyBwcmV2ZW50IGEgbG9zcyBvZiBmb2N1cyB3aGVuIGNoYW5naW5nIHRhYnMvd2luZG93cyBieSBzZXR0aW5nIGEgZmxhZyB0aGF0IHByZXZlbnRzIGhhc2ZvY3VzCgkgICAgICAgICAgICAvLyBmcm9tIGNhbGxpbmcgJ2JsdXIoKScgb24gdGhlIGVsZW1lbnQgd2hlbiBpdCBsb3NlcyBmb2N1cy4KCSAgICAgICAgICAgIC8vIERpc2N1c3Npb24gYXQgaHR0cHM6Ly9naXRodWIuY29tL1N0ZXZlU2FuZGVyc29uL2tub2Nrb3V0L3B1bGwvMzUyCgkgICAgICAgICAgICBlbGVtZW50W2hhc2ZvY3VzVXBkYXRpbmdQcm9wZXJ0eV0gPSB0cnVlOwoJICAgICAgICAgICAgdmFyIG93bmVyRG9jID0gZWxlbWVudC5vd25lckRvY3VtZW50OwoJICAgICAgICAgICAgaWYgKCJhY3RpdmVFbGVtZW50IiBpbiBvd25lckRvYykgewoJICAgICAgICAgICAgICAgIHZhciBhY3RpdmU7CgkgICAgICAgICAgICAgICAgdHJ5IHsKCSAgICAgICAgICAgICAgICAgICAgYWN0aXZlID0gb3duZXJEb2MuYWN0aXZlRWxlbWVudDsKCSAgICAgICAgICAgICAgICB9IGNhdGNoKGUpIHsKCSAgICAgICAgICAgICAgICAgICAgLy8gSUU5IHRocm93cyBpZiB5b3UgYWNjZXNzIGFjdGl2ZUVsZW1lbnQgZHVyaW5nIHBhZ2UgbG9hZCAoc2VlIGlzc3VlICM3MDMpCgkgICAgICAgICAgICAgICAgICAgIGFjdGl2ZSA9IG93bmVyRG9jLmJvZHk7CgkgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgIGlzRm9jdXNlZCA9IChhY3RpdmUgPT09IGVsZW1lbnQpOwoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgdmFyIG1vZGVsVmFsdWUgPSB2YWx1ZUFjY2Vzc29yKCk7CgkgICAgICAgICAgICBrby5leHByZXNzaW9uUmV3cml0aW5nLndyaXRlVmFsdWVUb1Byb3BlcnR5KG1vZGVsVmFsdWUsIGFsbEJpbmRpbmdzLCAnaGFzZm9jdXMnLCBpc0ZvY3VzZWQsIHRydWUpOwoKCSAgICAgICAgICAgIC8vY2FjaGUgdGhlIGxhdGVzdCB2YWx1ZSwgc28gd2UgY2FuIGF2b2lkIHVubmVjZXNzYXJpbHkgY2FsbGluZyBmb2N1cy9ibHVyIGluIHRoZSB1cGRhdGUgZnVuY3Rpb24KCSAgICAgICAgICAgIGVsZW1lbnRbaGFzZm9jdXNMYXN0VmFsdWVdID0gaXNGb2N1c2VkOwoJICAgICAgICAgICAgZWxlbWVudFtoYXNmb2N1c1VwZGF0aW5nUHJvcGVydHldID0gZmFsc2U7CgkgICAgICAgIH07CgkgICAgICAgIHZhciBoYW5kbGVFbGVtZW50Rm9jdXNJbiA9IGhhbmRsZUVsZW1lbnRGb2N1c0NoYW5nZS5iaW5kKG51bGwsIHRydWUpOwoJICAgICAgICB2YXIgaGFuZGxlRWxlbWVudEZvY3VzT3V0ID0gaGFuZGxlRWxlbWVudEZvY3VzQ2hhbmdlLmJpbmQobnVsbCwgZmFsc2UpOwoKCSAgICAgICAga28udXRpbHMucmVnaXN0ZXJFdmVudEhhbmRsZXIoZWxlbWVudCwgImZvY3VzIiwgaGFuZGxlRWxlbWVudEZvY3VzSW4pOwoJICAgICAgICBrby51dGlscy5yZWdpc3RlckV2ZW50SGFuZGxlcihlbGVtZW50LCAiZm9jdXNpbiIsIGhhbmRsZUVsZW1lbnRGb2N1c0luKTsgLy8gRm9yIElFCgkgICAgICAgIGtvLnV0aWxzLnJlZ2lzdGVyRXZlbnRIYW5kbGVyKGVsZW1lbnQsICJibHVyIiwgIGhhbmRsZUVsZW1lbnRGb2N1c091dCk7CgkgICAgICAgIGtvLnV0aWxzLnJlZ2lzdGVyRXZlbnRIYW5kbGVyKGVsZW1lbnQsICJmb2N1c291dCIsICBoYW5kbGVFbGVtZW50Rm9jdXNPdXQpOyAvLyBGb3IgSUUKCSAgICB9LAoJICAgICd1cGRhdGUnOiBmdW5jdGlvbihlbGVtZW50LCB2YWx1ZUFjY2Vzc29yKSB7CgkgICAgICAgIHZhciB2YWx1ZSA9ICEha28udXRpbHMudW53cmFwT2JzZXJ2YWJsZSh2YWx1ZUFjY2Vzc29yKCkpOyAvL2ZvcmNlIGJvb2xlYW4gdG8gY29tcGFyZSB3aXRoIGxhc3QgdmFsdWUKCSAgICAgICAgaWYgKCFlbGVtZW50W2hhc2ZvY3VzVXBkYXRpbmdQcm9wZXJ0eV0gJiYgZWxlbWVudFtoYXNmb2N1c0xhc3RWYWx1ZV0gIT09IHZhbHVlKSB7CgkgICAgICAgICAgICB2YWx1ZSA/IGVsZW1lbnQuZm9jdXMoKSA6IGVsZW1lbnQuYmx1cigpOwoJICAgICAgICAgICAga28uZGVwZW5kZW5jeURldGVjdGlvbi5pZ25vcmUoa28udXRpbHMudHJpZ2dlckV2ZW50LCBudWxsLCBbZWxlbWVudCwgdmFsdWUgPyAiZm9jdXNpbiIgOiAiZm9jdXNvdXQiXSk7IC8vIEZvciBJRSwgd2hpY2ggZG9lc24ndCByZWxpYWJseSBmaXJlICJmb2N1cyIgb3IgImJsdXIiIGV2ZW50cyBzeW5jaHJvbm91c2x5CgkgICAgICAgIH0KCSAgICB9Cgl9OwoJa28uZXhwcmVzc2lvblJld3JpdGluZy50d29XYXlCaW5kaW5nc1snaGFzZm9jdXMnXSA9IHRydWU7CgoJa28uYmluZGluZ0hhbmRsZXJzWydoYXNGb2N1cyddID0ga28uYmluZGluZ0hhbmRsZXJzWydoYXNmb2N1cyddOyAvLyBNYWtlICJoYXNGb2N1cyIgYW4gYWxpYXMKCWtvLmV4cHJlc3Npb25SZXdyaXRpbmcudHdvV2F5QmluZGluZ3NbJ2hhc0ZvY3VzJ10gPSB0cnVlOwoJa28uYmluZGluZ0hhbmRsZXJzWydodG1sJ10gPSB7CgkgICAgJ2luaXQnOiBmdW5jdGlvbigpIHsKCSAgICAgICAgLy8gUHJldmVudCBiaW5kaW5nIG9uIHRoZSBkeW5hbWljYWxseS1pbmplY3RlZCBIVE1MIChhcyBkZXZlbG9wZXJzIGFyZSB1bmxpa2VseSB0byBleHBlY3QgdGhhdCwgYW5kIGl0IGhhcyBzZWN1cml0eSBpbXBsaWNhdGlvbnMpCgkgICAgICAgIHJldHVybiB7ICdjb250cm9sc0Rlc2NlbmRhbnRCaW5kaW5ncyc6IHRydWUgfTsKCSAgICB9LAoJICAgICd1cGRhdGUnOiBmdW5jdGlvbiAoZWxlbWVudCwgdmFsdWVBY2Nlc3NvcikgewoJICAgICAgICAvLyBzZXRIdG1sIHdpbGwgdW53cmFwIHRoZSB2YWx1ZSBpZiBuZWVkZWQKCSAgICAgICAga28udXRpbHMuc2V0SHRtbChlbGVtZW50LCB2YWx1ZUFjY2Vzc29yKCkpOwoJICAgIH0KCX07CgkvLyBNYWtlcyBhIGJpbmRpbmcgbGlrZSB3aXRoIG9yIGlmCglmdW5jdGlvbiBtYWtlV2l0aElmQmluZGluZyhiaW5kaW5nS2V5LCBpc1dpdGgsIGlzTm90LCBtYWtlQ29udGV4dENhbGxiYWNrKSB7CgkgICAga28uYmluZGluZ0hhbmRsZXJzW2JpbmRpbmdLZXldID0gewoJICAgICAgICAnaW5pdCc6IGZ1bmN0aW9uKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IsIGFsbEJpbmRpbmdzLCB2aWV3TW9kZWwsIGJpbmRpbmdDb250ZXh0KSB7CgkgICAgICAgICAgICB2YXIgZGlkRGlzcGxheU9uTGFzdFVwZGF0ZSwKCSAgICAgICAgICAgICAgICBzYXZlZE5vZGVzOwoJICAgICAgICAgICAga28uY29tcHV0ZWQoZnVuY3Rpb24oKSB7CgkgICAgICAgICAgICAgICAgdmFyIGRhdGFWYWx1ZSA9IGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUodmFsdWVBY2Nlc3NvcigpKSwKCSAgICAgICAgICAgICAgICAgICAgc2hvdWxkRGlzcGxheSA9ICFpc05vdCAhPT0gIWRhdGFWYWx1ZSwgLy8gZXF1aXZhbGVudCB0byBpc05vdCA/ICFkYXRhVmFsdWUgOiAhIWRhdGFWYWx1ZQoJICAgICAgICAgICAgICAgICAgICBpc0ZpcnN0UmVuZGVyID0gIXNhdmVkTm9kZXMsCgkgICAgICAgICAgICAgICAgICAgIG5lZWRzUmVmcmVzaCA9IGlzRmlyc3RSZW5kZXIgfHwgaXNXaXRoIHx8IChzaG91bGREaXNwbGF5ICE9PSBkaWREaXNwbGF5T25MYXN0VXBkYXRlKTsKCgkgICAgICAgICAgICAgICAgaWYgKG5lZWRzUmVmcmVzaCkgewoJICAgICAgICAgICAgICAgICAgICAvLyBTYXZlIGEgY29weSBvZiB0aGUgaW5uZXIgbm9kZXMgb24gdGhlIGluaXRpYWwgdXBkYXRlLCBidXQgb25seSBpZiB3ZSBoYXZlIGRlcGVuZGVuY2llcy4KCSAgICAgICAgICAgICAgICAgICAgaWYgKGlzRmlyc3RSZW5kZXIgJiYga28uY29tcHV0ZWRDb250ZXh0LmdldERlcGVuZGVuY2llc0NvdW50KCkpIHsKCSAgICAgICAgICAgICAgICAgICAgICAgIHNhdmVkTm9kZXMgPSBrby51dGlscy5jbG9uZU5vZGVzKGtvLnZpcnR1YWxFbGVtZW50cy5jaGlsZE5vZGVzKGVsZW1lbnQpLCB0cnVlIC8qIHNob3VsZENsZWFuTm9kZXMgKi8pOwoJICAgICAgICAgICAgICAgICAgICB9CgoJICAgICAgICAgICAgICAgICAgICBpZiAoc2hvdWxkRGlzcGxheSkgewoJICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFpc0ZpcnN0UmVuZGVyKSB7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAga28udmlydHVhbEVsZW1lbnRzLnNldERvbU5vZGVDaGlsZHJlbihlbGVtZW50LCBrby51dGlscy5jbG9uZU5vZGVzKHNhdmVkTm9kZXMpKTsKCSAgICAgICAgICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICAgICAgICAgIGtvLmFwcGx5QmluZGluZ3NUb0Rlc2NlbmRhbnRzKG1ha2VDb250ZXh0Q2FsbGJhY2sgPyBtYWtlQ29udGV4dENhbGxiYWNrKGJpbmRpbmdDb250ZXh0LCBkYXRhVmFsdWUpIDogYmluZGluZ0NvbnRleHQsIGVsZW1lbnQpOwoJICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgICAgICAgICAgICAga28udmlydHVhbEVsZW1lbnRzLmVtcHR5Tm9kZShlbGVtZW50KTsKCSAgICAgICAgICAgICAgICAgICAgfQoKCSAgICAgICAgICAgICAgICAgICAgZGlkRGlzcGxheU9uTGFzdFVwZGF0ZSA9IHNob3VsZERpc3BsYXk7CgkgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgfSwgbnVsbCwgeyBkaXNwb3NlV2hlbk5vZGVJc1JlbW92ZWQ6IGVsZW1lbnQgfSk7CgkgICAgICAgICAgICByZXR1cm4geyAnY29udHJvbHNEZXNjZW5kYW50QmluZGluZ3MnOiB0cnVlIH07CgkgICAgICAgIH0KCSAgICB9OwoJICAgIGtvLmV4cHJlc3Npb25SZXdyaXRpbmcuYmluZGluZ1Jld3JpdGVWYWxpZGF0b3JzW2JpbmRpbmdLZXldID0gZmFsc2U7IC8vIENhbid0IHJld3JpdGUgY29udHJvbCBmbG93IGJpbmRpbmdzCgkgICAga28udmlydHVhbEVsZW1lbnRzLmFsbG93ZWRCaW5kaW5nc1tiaW5kaW5nS2V5XSA9IHRydWU7Cgl9CgoJLy8gQ29uc3RydWN0IHRoZSBhY3R1YWwgYmluZGluZyBoYW5kbGVycwoJbWFrZVdpdGhJZkJpbmRpbmcoJ2lmJyk7CgltYWtlV2l0aElmQmluZGluZygnaWZub3QnLCBmYWxzZSAvKiBpc1dpdGggKi8sIHRydWUgLyogaXNOb3QgKi8pOwoJbWFrZVdpdGhJZkJpbmRpbmcoJ3dpdGgnLCB0cnVlIC8qIGlzV2l0aCAqLywgZmFsc2UgLyogaXNOb3QgKi8sCgkgICAgZnVuY3Rpb24oYmluZGluZ0NvbnRleHQsIGRhdGFWYWx1ZSkgewoJICAgICAgICByZXR1cm4gYmluZGluZ0NvbnRleHRbJ2NyZWF0ZUNoaWxkQ29udGV4dCddKGRhdGFWYWx1ZSk7CgkgICAgfQoJKTsKCXZhciBjYXB0aW9uUGxhY2Vob2xkZXIgPSB7fTsKCWtvLmJpbmRpbmdIYW5kbGVyc1snb3B0aW9ucyddID0gewoJICAgICdpbml0JzogZnVuY3Rpb24oZWxlbWVudCkgewoJICAgICAgICBpZiAoa28udXRpbHMudGFnTmFtZUxvd2VyKGVsZW1lbnQpICE9PSAic2VsZWN0IikKCSAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigib3B0aW9ucyBiaW5kaW5nIGFwcGxpZXMgb25seSB0byBTRUxFQ1QgZWxlbWVudHMiKTsKCgkgICAgICAgIC8vIFJlbW92ZSBhbGwgZXhpc3RpbmcgPG9wdGlvbj5zLgoJICAgICAgICB3aGlsZSAoZWxlbWVudC5sZW5ndGggPiAwKSB7CgkgICAgICAgICAgICBlbGVtZW50LnJlbW92ZSgwKTsKCSAgICAgICAgfQoKCSAgICAgICAgLy8gRW5zdXJlcyB0aGF0IHRoZSBiaW5kaW5nIHByb2Nlc3NvciBkb2Vzbid0IHRyeSB0byBiaW5kIHRoZSBvcHRpb25zCgkgICAgICAgIHJldHVybiB7ICdjb250cm9sc0Rlc2NlbmRhbnRCaW5kaW5ncyc6IHRydWUgfTsKCSAgICB9LAoJICAgICd1cGRhdGUnOiBmdW5jdGlvbiAoZWxlbWVudCwgdmFsdWVBY2Nlc3NvciwgYWxsQmluZGluZ3MpIHsKCSAgICAgICAgZnVuY3Rpb24gc2VsZWN0ZWRPcHRpb25zKCkgewoJICAgICAgICAgICAgcmV0dXJuIGtvLnV0aWxzLmFycmF5RmlsdGVyKGVsZW1lbnQub3B0aW9ucywgZnVuY3Rpb24gKG5vZGUpIHsgcmV0dXJuIG5vZGUuc2VsZWN0ZWQ7IH0pOwoJICAgICAgICB9CgoJICAgICAgICB2YXIgc2VsZWN0V2FzUHJldmlvdXNseUVtcHR5ID0gZWxlbWVudC5sZW5ndGggPT0gMDsKCSAgICAgICAgdmFyIHByZXZpb3VzU2Nyb2xsVG9wID0gKCFzZWxlY3RXYXNQcmV2aW91c2x5RW1wdHkgJiYgZWxlbWVudC5tdWx0aXBsZSkgPyBlbGVtZW50LnNjcm9sbFRvcCA6IG51bGw7CgkgICAgICAgIHZhciB1bndyYXBwZWRBcnJheSA9IGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUodmFsdWVBY2Nlc3NvcigpKTsKCSAgICAgICAgdmFyIGluY2x1ZGVEZXN0cm95ZWQgPSBhbGxCaW5kaW5ncy5nZXQoJ29wdGlvbnNJbmNsdWRlRGVzdHJveWVkJyk7CgkgICAgICAgIHZhciBhcnJheVRvRG9tTm9kZUNoaWxkcmVuT3B0aW9ucyA9IHt9OwoJICAgICAgICB2YXIgY2FwdGlvblZhbHVlOwoJICAgICAgICB2YXIgZmlsdGVyZWRBcnJheTsKCSAgICAgICAgdmFyIHByZXZpb3VzU2VsZWN0ZWRWYWx1ZXM7CgoJICAgICAgICBpZiAoZWxlbWVudC5tdWx0aXBsZSkgewoJICAgICAgICAgICAgcHJldmlvdXNTZWxlY3RlZFZhbHVlcyA9IGtvLnV0aWxzLmFycmF5TWFwKHNlbGVjdGVkT3B0aW9ucygpLCBrby5zZWxlY3RFeHRlbnNpb25zLnJlYWRWYWx1ZSk7CgkgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICBwcmV2aW91c1NlbGVjdGVkVmFsdWVzID0gZWxlbWVudC5zZWxlY3RlZEluZGV4ID49IDAgPyBbIGtvLnNlbGVjdEV4dGVuc2lvbnMucmVhZFZhbHVlKGVsZW1lbnQub3B0aW9uc1tlbGVtZW50LnNlbGVjdGVkSW5kZXhdKSBdIDogW107CgkgICAgICAgIH0KCgkgICAgICAgIGlmICh1bndyYXBwZWRBcnJheSkgewoJICAgICAgICAgICAgaWYgKHR5cGVvZiB1bndyYXBwZWRBcnJheS5sZW5ndGggPT0gInVuZGVmaW5lZCIpIC8vIENvZXJjZSBzaW5nbGUgdmFsdWUgaW50byBhcnJheQoJICAgICAgICAgICAgICAgIHVud3JhcHBlZEFycmF5ID0gW3Vud3JhcHBlZEFycmF5XTsKCgkgICAgICAgICAgICAvLyBGaWx0ZXIgb3V0IGFueSBlbnRyaWVzIG1hcmtlZCBhcyBkZXN0cm95ZWQKCSAgICAgICAgICAgIGZpbHRlcmVkQXJyYXkgPSBrby51dGlscy5hcnJheUZpbHRlcih1bndyYXBwZWRBcnJheSwgZnVuY3Rpb24oaXRlbSkgewoJICAgICAgICAgICAgICAgIHJldHVybiBpbmNsdWRlRGVzdHJveWVkIHx8IGl0ZW0gPT09IHVuZGVmaW5lZCB8fCBpdGVtID09PSBudWxsIHx8ICFrby51dGlscy51bndyYXBPYnNlcnZhYmxlKGl0ZW1bJ19kZXN0cm95J10pOwoJICAgICAgICAgICAgfSk7CgoJICAgICAgICAgICAgLy8gSWYgY2FwdGlvbiBpcyBpbmNsdWRlZCwgYWRkIGl0IHRvIHRoZSBhcnJheQoJICAgICAgICAgICAgaWYgKGFsbEJpbmRpbmdzWydoYXMnXSgnb3B0aW9uc0NhcHRpb24nKSkgewoJICAgICAgICAgICAgICAgIGNhcHRpb25WYWx1ZSA9IGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUoYWxsQmluZGluZ3MuZ2V0KCdvcHRpb25zQ2FwdGlvbicpKTsKCSAgICAgICAgICAgICAgICAvLyBJZiBjYXB0aW9uIHZhbHVlIGlzIG51bGwgb3IgdW5kZWZpbmVkLCBkb24ndCBzaG93IGEgY2FwdGlvbgoJICAgICAgICAgICAgICAgIGlmIChjYXB0aW9uVmFsdWUgIT09IG51bGwgJiYgY2FwdGlvblZhbHVlICE9PSB1bmRlZmluZWQpIHsKCSAgICAgICAgICAgICAgICAgICAgZmlsdGVyZWRBcnJheS51bnNoaWZ0KGNhcHRpb25QbGFjZWhvbGRlcik7CgkgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgfQoJICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgLy8gSWYgYSBmYWxzeSB2YWx1ZSBpcyBwcm92aWRlZCAoZS5nLiBudWxsKSwgd2UnbGwgc2ltcGx5IGVtcHR5IHRoZSBzZWxlY3QgZWxlbWVudAoJICAgICAgICB9CgoJICAgICAgICBmdW5jdGlvbiBhcHBseVRvT2JqZWN0KG9iamVjdCwgcHJlZGljYXRlLCBkZWZhdWx0VmFsdWUpIHsKCSAgICAgICAgICAgIHZhciBwcmVkaWNhdGVUeXBlID0gdHlwZW9mIHByZWRpY2F0ZTsKCSAgICAgICAgICAgIGlmIChwcmVkaWNhdGVUeXBlID09ICJmdW5jdGlvbiIpICAgIC8vIEdpdmVuIGEgZnVuY3Rpb247IHJ1biBpdCBhZ2FpbnN0IHRoZSBkYXRhIHZhbHVlCgkgICAgICAgICAgICAgICAgcmV0dXJuIHByZWRpY2F0ZShvYmplY3QpOwoJICAgICAgICAgICAgZWxzZSBpZiAocHJlZGljYXRlVHlwZSA9PSAic3RyaW5nIikgLy8gR2l2ZW4gYSBzdHJpbmc7IHRyZWF0IGl0IGFzIGEgcHJvcGVydHkgbmFtZSBvbiB0aGUgZGF0YSB2YWx1ZQoJICAgICAgICAgICAgICAgIHJldHVybiBvYmplY3RbcHJlZGljYXRlXTsKCSAgICAgICAgICAgIGVsc2UgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIEdpdmVuIG5vIG9wdGlvbnNUZXh0IGFyZzsgdXNlIHRoZSBkYXRhIHZhbHVlIGl0c2VsZgoJICAgICAgICAgICAgICAgIHJldHVybiBkZWZhdWx0VmFsdWU7CgkgICAgICAgIH0KCgkgICAgICAgIC8vIFRoZSBmb2xsb3dpbmcgZnVuY3Rpb25zIGNhbiBydW4gYXQgdHdvIGRpZmZlcmVudCB0aW1lczoKCSAgICAgICAgLy8gVGhlIGZpcnN0IGlzIHdoZW4gdGhlIHdob2xlIGFycmF5IGlzIGJlaW5nIHVwZGF0ZWQgZGlyZWN0bHkgZnJvbSB0aGlzIGJpbmRpbmcgaGFuZGxlci4KCSAgICAgICAgLy8gVGhlIHNlY29uZCBpcyB3aGVuIGFuIG9ic2VydmFibGUgdmFsdWUgZm9yIGEgc3BlY2lmaWMgYXJyYXkgZW50cnkgaXMgdXBkYXRlZC4KCSAgICAgICAgLy8gb2xkT3B0aW9ucyB3aWxsIGJlIGVtcHR5IGluIHRoZSBmaXJzdCBjYXNlLCBidXQgd2lsbCBiZSBmaWxsZWQgd2l0aCB0aGUgcHJldmlvdXNseSBnZW5lcmF0ZWQgb3B0aW9uIGluIHRoZSBzZWNvbmQuCgkgICAgICAgIHZhciBpdGVtVXBkYXRlID0gZmFsc2U7CgkgICAgICAgIGZ1bmN0aW9uIG9wdGlvbkZvckFycmF5SXRlbShhcnJheUVudHJ5LCBpbmRleCwgb2xkT3B0aW9ucykgewoJICAgICAgICAgICAgaWYgKG9sZE9wdGlvbnMubGVuZ3RoKSB7CgkgICAgICAgICAgICAgICAgcHJldmlvdXNTZWxlY3RlZFZhbHVlcyA9IG9sZE9wdGlvbnNbMF0uc2VsZWN0ZWQgPyBbIGtvLnNlbGVjdEV4dGVuc2lvbnMucmVhZFZhbHVlKG9sZE9wdGlvbnNbMF0pIF0gOiBbXTsKCSAgICAgICAgICAgICAgICBpdGVtVXBkYXRlID0gdHJ1ZTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIHZhciBvcHRpb24gPSBlbGVtZW50Lm93bmVyRG9jdW1lbnQuY3JlYXRlRWxlbWVudCgib3B0aW9uIik7CgkgICAgICAgICAgICBpZiAoYXJyYXlFbnRyeSA9PT0gY2FwdGlvblBsYWNlaG9sZGVyKSB7CgkgICAgICAgICAgICAgICAga28udXRpbHMuc2V0VGV4dENvbnRlbnQob3B0aW9uLCBhbGxCaW5kaW5ncy5nZXQoJ29wdGlvbnNDYXB0aW9uJykpOwoJICAgICAgICAgICAgICAgIGtvLnNlbGVjdEV4dGVuc2lvbnMud3JpdGVWYWx1ZShvcHRpb24sIHVuZGVmaW5lZCk7CgkgICAgICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgICAgIC8vIEFwcGx5IGEgdmFsdWUgdG8gdGhlIG9wdGlvbiBlbGVtZW50CgkgICAgICAgICAgICAgICAgdmFyIG9wdGlvblZhbHVlID0gYXBwbHlUb09iamVjdChhcnJheUVudHJ5LCBhbGxCaW5kaW5ncy5nZXQoJ29wdGlvbnNWYWx1ZScpLCBhcnJheUVudHJ5KTsKCSAgICAgICAgICAgICAgICBrby5zZWxlY3RFeHRlbnNpb25zLndyaXRlVmFsdWUob3B0aW9uLCBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKG9wdGlvblZhbHVlKSk7CgoJICAgICAgICAgICAgICAgIC8vIEFwcGx5IHNvbWUgdGV4dCB0byB0aGUgb3B0aW9uIGVsZW1lbnQKCSAgICAgICAgICAgICAgICB2YXIgb3B0aW9uVGV4dCA9IGFwcGx5VG9PYmplY3QoYXJyYXlFbnRyeSwgYWxsQmluZGluZ3MuZ2V0KCdvcHRpb25zVGV4dCcpLCBvcHRpb25WYWx1ZSk7CgkgICAgICAgICAgICAgICAga28udXRpbHMuc2V0VGV4dENvbnRlbnQob3B0aW9uLCBvcHRpb25UZXh0KTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIHJldHVybiBbb3B0aW9uXTsKCSAgICAgICAgfQoKCSAgICAgICAgLy8gQnkgdXNpbmcgYSBiZWZvcmVSZW1vdmUgY2FsbGJhY2ssIHdlIGRlbGF5IHRoZSByZW1vdmFsIHVudGlsIGFmdGVyIG5ldyBpdGVtcyBhcmUgYWRkZWQuIFRoaXMgZml4ZXMgYSBzZWxlY3Rpb24KCSAgICAgICAgLy8gcHJvYmxlbSBpbiBJRTw9OCBhbmQgRmlyZWZveC4gU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9rbm9ja291dC9rbm9ja291dC9pc3N1ZXMvMTIwOAoJICAgICAgICBhcnJheVRvRG9tTm9kZUNoaWxkcmVuT3B0aW9uc1snYmVmb3JlUmVtb3ZlJ10gPQoJICAgICAgICAgICAgZnVuY3Rpb24gKG9wdGlvbikgewoJICAgICAgICAgICAgICAgIGVsZW1lbnQucmVtb3ZlQ2hpbGQob3B0aW9uKTsKCSAgICAgICAgICAgIH07CgoJICAgICAgICBmdW5jdGlvbiBzZXRTZWxlY3Rpb25DYWxsYmFjayhhcnJheUVudHJ5LCBuZXdPcHRpb25zKSB7CgkgICAgICAgICAgICAvLyBJRTYgZG9lc24ndCBsaWtlIHVzIHRvIGFzc2lnbiBzZWxlY3Rpb24gdG8gT1BUSU9OIG5vZGVzIGJlZm9yZSB0aGV5J3JlIGFkZGVkIHRvIHRoZSBkb2N1bWVudC4KCSAgICAgICAgICAgIC8vIFRoYXQncyB3aHkgd2UgZmlyc3QgYWRkZWQgdGhlbSB3aXRob3V0IHNlbGVjdGlvbi4gTm93IGl0J3MgdGltZSB0byBzZXQgdGhlIHNlbGVjdGlvbi4KCSAgICAgICAgICAgIGlmIChwcmV2aW91c1NlbGVjdGVkVmFsdWVzLmxlbmd0aCkgewoJICAgICAgICAgICAgICAgIHZhciBpc1NlbGVjdGVkID0ga28udXRpbHMuYXJyYXlJbmRleE9mKHByZXZpb3VzU2VsZWN0ZWRWYWx1ZXMsIGtvLnNlbGVjdEV4dGVuc2lvbnMucmVhZFZhbHVlKG5ld09wdGlvbnNbMF0pKSA+PSAwOwoJICAgICAgICAgICAgICAgIGtvLnV0aWxzLnNldE9wdGlvbk5vZGVTZWxlY3Rpb25TdGF0ZShuZXdPcHRpb25zWzBdLCBpc1NlbGVjdGVkKTsKCgkgICAgICAgICAgICAgICAgLy8gSWYgdGhpcyBvcHRpb24gd2FzIGNoYW5nZWQgZnJvbSBiZWluZyBzZWxlY3RlZCBkdXJpbmcgYSBzaW5nbGUtaXRlbSB1cGRhdGUsIG5vdGlmeSB0aGUgY2hhbmdlCgkgICAgICAgICAgICAgICAgaWYgKGl0ZW1VcGRhdGUgJiYgIWlzU2VsZWN0ZWQpCgkgICAgICAgICAgICAgICAgICAgIGtvLmRlcGVuZGVuY3lEZXRlY3Rpb24uaWdub3JlKGtvLnV0aWxzLnRyaWdnZXJFdmVudCwgbnVsbCwgW2VsZW1lbnQsICJjaGFuZ2UiXSk7CgkgICAgICAgICAgICB9CgkgICAgICAgIH0KCgkgICAgICAgIHZhciBjYWxsYmFjayA9IHNldFNlbGVjdGlvbkNhbGxiYWNrOwoJICAgICAgICBpZiAoYWxsQmluZGluZ3NbJ2hhcyddKCdvcHRpb25zQWZ0ZXJSZW5kZXInKSkgewoJICAgICAgICAgICAgY2FsbGJhY2sgPSBmdW5jdGlvbihhcnJheUVudHJ5LCBuZXdPcHRpb25zKSB7CgkgICAgICAgICAgICAgICAgc2V0U2VsZWN0aW9uQ2FsbGJhY2soYXJyYXlFbnRyeSwgbmV3T3B0aW9ucyk7CgkgICAgICAgICAgICAgICAga28uZGVwZW5kZW5jeURldGVjdGlvbi5pZ25vcmUoYWxsQmluZGluZ3MuZ2V0KCdvcHRpb25zQWZ0ZXJSZW5kZXInKSwgbnVsbCwgW25ld09wdGlvbnNbMF0sIGFycmF5RW50cnkgIT09IGNhcHRpb25QbGFjZWhvbGRlciA/IGFycmF5RW50cnkgOiB1bmRlZmluZWRdKTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgfQoKCSAgICAgICAga28udXRpbHMuc2V0RG9tTm9kZUNoaWxkcmVuRnJvbUFycmF5TWFwcGluZyhlbGVtZW50LCBmaWx0ZXJlZEFycmF5LCBvcHRpb25Gb3JBcnJheUl0ZW0sIGFycmF5VG9Eb21Ob2RlQ2hpbGRyZW5PcHRpb25zLCBjYWxsYmFjayk7CgoJICAgICAgICBrby5kZXBlbmRlbmN5RGV0ZWN0aW9uLmlnbm9yZShmdW5jdGlvbiAoKSB7CgkgICAgICAgICAgICBpZiAoYWxsQmluZGluZ3MuZ2V0KCd2YWx1ZUFsbG93VW5zZXQnKSAmJiBhbGxCaW5kaW5nc1snaGFzJ10oJ3ZhbHVlJykpIHsKCSAgICAgICAgICAgICAgICAvLyBUaGUgbW9kZWwgdmFsdWUgaXMgYXV0aG9yaXRhdGl2ZSwgc28gbWFrZSBzdXJlIGl0cyB2YWx1ZSBpcyB0aGUgb25lIHNlbGVjdGVkCgkgICAgICAgICAgICAgICAga28uc2VsZWN0RXh0ZW5zaW9ucy53cml0ZVZhbHVlKGVsZW1lbnQsIGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUoYWxsQmluZGluZ3MuZ2V0KCd2YWx1ZScpKSwgdHJ1ZSAvKiBhbGxvd1Vuc2V0ICovKTsKCSAgICAgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICAgICAgLy8gRGV0ZXJtaW5lIGlmIHRoZSBzZWxlY3Rpb24gaGFzIGNoYW5nZWQgYXMgYSByZXN1bHQgb2YgdXBkYXRpbmcgdGhlIG9wdGlvbnMgbGlzdAoJICAgICAgICAgICAgICAgIHZhciBzZWxlY3Rpb25DaGFuZ2VkOwoJICAgICAgICAgICAgICAgIGlmIChlbGVtZW50Lm11bHRpcGxlKSB7CgkgICAgICAgICAgICAgICAgICAgIC8vIEZvciBhIG11bHRpcGxlLXNlbGVjdCBib3gsIGNvbXBhcmUgdGhlIG5ldyBzZWxlY3Rpb24gY291bnQgdG8gdGhlIHByZXZpb3VzIG9uZQoJICAgICAgICAgICAgICAgICAgICAvLyBCdXQgaWYgbm90aGluZyB3YXMgc2VsZWN0ZWQgYmVmb3JlLCB0aGUgc2VsZWN0aW9uIGNhbid0IGhhdmUgY2hhbmdlZAoJICAgICAgICAgICAgICAgICAgICBzZWxlY3Rpb25DaGFuZ2VkID0gcHJldmlvdXNTZWxlY3RlZFZhbHVlcy5sZW5ndGggJiYgc2VsZWN0ZWRPcHRpb25zKCkubGVuZ3RoIDwgcHJldmlvdXNTZWxlY3RlZFZhbHVlcy5sZW5ndGg7CgkgICAgICAgICAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgICAgICAgICAgLy8gRm9yIGEgc2luZ2xlLXNlbGVjdCBib3gsIGNvbXBhcmUgdGhlIGN1cnJlbnQgdmFsdWUgdG8gdGhlIHByZXZpb3VzIHZhbHVlCgkgICAgICAgICAgICAgICAgICAgIC8vIEJ1dCBpZiBub3RoaW5nIHdhcyBzZWxlY3RlZCBiZWZvcmUgb3Igbm90aGluZyBpcyBzZWxlY3RlZCBub3csIGp1c3QgbG9vayBmb3IgYSBjaGFuZ2UgaW4gc2VsZWN0aW9uCgkgICAgICAgICAgICAgICAgICAgIHNlbGVjdGlvbkNoYW5nZWQgPSAocHJldmlvdXNTZWxlY3RlZFZhbHVlcy5sZW5ndGggJiYgZWxlbWVudC5zZWxlY3RlZEluZGV4ID49IDApCgkgICAgICAgICAgICAgICAgICAgICAgICA/IChrby5zZWxlY3RFeHRlbnNpb25zLnJlYWRWYWx1ZShlbGVtZW50Lm9wdGlvbnNbZWxlbWVudC5zZWxlY3RlZEluZGV4XSkgIT09IHByZXZpb3VzU2VsZWN0ZWRWYWx1ZXNbMF0pCgkgICAgICAgICAgICAgICAgICAgICAgICA6IChwcmV2aW91c1NlbGVjdGVkVmFsdWVzLmxlbmd0aCB8fCBlbGVtZW50LnNlbGVjdGVkSW5kZXggPj0gMCk7CgkgICAgICAgICAgICAgICAgfQoKCSAgICAgICAgICAgICAgICAvLyBFbnN1cmUgY29uc2lzdGVuY3kgYmV0d2VlbiBtb2RlbCB2YWx1ZSBhbmQgc2VsZWN0ZWQgb3B0aW9uLgoJICAgICAgICAgICAgICAgIC8vIElmIHRoZSBkcm9wZG93biB3YXMgY2hhbmdlZCBzbyB0aGF0IHNlbGVjdGlvbiBpcyBubyBsb25nZXIgdGhlIHNhbWUsCgkgICAgICAgICAgICAgICAgLy8gbm90aWZ5IHRoZSB2YWx1ZSBvciBzZWxlY3RlZE9wdGlvbnMgYmluZGluZy4KCSAgICAgICAgICAgICAgICBpZiAoc2VsZWN0aW9uQ2hhbmdlZCkgewoJICAgICAgICAgICAgICAgICAgICBrby51dGlscy50cmlnZ2VyRXZlbnQoZWxlbWVudCwgImNoYW5nZSIpOwoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgIH0KCSAgICAgICAgfSk7CgoJICAgICAgICAvLyBXb3JrYXJvdW5kIGZvciBJRSBidWcKCSAgICAgICAga28udXRpbHMuZW5zdXJlU2VsZWN0RWxlbWVudElzUmVuZGVyZWRDb3JyZWN0bHkoZWxlbWVudCk7CgoJICAgICAgICBpZiAocHJldmlvdXNTY3JvbGxUb3AgJiYgTWF0aC5hYnMocHJldmlvdXNTY3JvbGxUb3AgLSBlbGVtZW50LnNjcm9sbFRvcCkgPiAyMCkKCSAgICAgICAgICAgIGVsZW1lbnQuc2Nyb2xsVG9wID0gcHJldmlvdXNTY3JvbGxUb3A7CgkgICAgfQoJfTsKCWtvLmJpbmRpbmdIYW5kbGVyc1snb3B0aW9ucyddLm9wdGlvblZhbHVlRG9tRGF0YUtleSA9IGtvLnV0aWxzLmRvbURhdGEubmV4dEtleSgpOwoJa28uYmluZGluZ0hhbmRsZXJzWydzZWxlY3RlZE9wdGlvbnMnXSA9IHsKCSAgICAnYWZ0ZXInOiBbJ29wdGlvbnMnLCAnZm9yZWFjaCddLAoJICAgICdpbml0JzogZnVuY3Rpb24gKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IsIGFsbEJpbmRpbmdzKSB7CgkgICAgICAgIGtvLnV0aWxzLnJlZ2lzdGVyRXZlbnRIYW5kbGVyKGVsZW1lbnQsICJjaGFuZ2UiLCBmdW5jdGlvbiAoKSB7CgkgICAgICAgICAgICB2YXIgdmFsdWUgPSB2YWx1ZUFjY2Vzc29yKCksIHZhbHVlVG9Xcml0ZSA9IFtdOwoJICAgICAgICAgICAga28udXRpbHMuYXJyYXlGb3JFYWNoKGVsZW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoIm9wdGlvbiIpLCBmdW5jdGlvbihub2RlKSB7CgkgICAgICAgICAgICAgICAgaWYgKG5vZGUuc2VsZWN0ZWQpCgkgICAgICAgICAgICAgICAgICAgIHZhbHVlVG9Xcml0ZS5wdXNoKGtvLnNlbGVjdEV4dGVuc2lvbnMucmVhZFZhbHVlKG5vZGUpKTsKCSAgICAgICAgICAgIH0pOwoJICAgICAgICAgICAga28uZXhwcmVzc2lvblJld3JpdGluZy53cml0ZVZhbHVlVG9Qcm9wZXJ0eSh2YWx1ZSwgYWxsQmluZGluZ3MsICdzZWxlY3RlZE9wdGlvbnMnLCB2YWx1ZVRvV3JpdGUpOwoJICAgICAgICB9KTsKCSAgICB9LAoJICAgICd1cGRhdGUnOiBmdW5jdGlvbiAoZWxlbWVudCwgdmFsdWVBY2Nlc3NvcikgewoJICAgICAgICBpZiAoa28udXRpbHMudGFnTmFtZUxvd2VyKGVsZW1lbnQpICE9ICJzZWxlY3QiKQoJICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJ2YWx1ZXMgYmluZGluZyBhcHBsaWVzIG9ubHkgdG8gU0VMRUNUIGVsZW1lbnRzIik7CgoJICAgICAgICB2YXIgbmV3VmFsdWUgPSBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKHZhbHVlQWNjZXNzb3IoKSk7CgkgICAgICAgIGlmIChuZXdWYWx1ZSAmJiB0eXBlb2YgbmV3VmFsdWUubGVuZ3RoID09ICJudW1iZXIiKSB7CgkgICAgICAgICAgICBrby51dGlscy5hcnJheUZvckVhY2goZWxlbWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgib3B0aW9uIiksIGZ1bmN0aW9uKG5vZGUpIHsKCSAgICAgICAgICAgICAgICB2YXIgaXNTZWxlY3RlZCA9IGtvLnV0aWxzLmFycmF5SW5kZXhPZihuZXdWYWx1ZSwga28uc2VsZWN0RXh0ZW5zaW9ucy5yZWFkVmFsdWUobm9kZSkpID49IDA7CgkgICAgICAgICAgICAgICAga28udXRpbHMuc2V0T3B0aW9uTm9kZVNlbGVjdGlvblN0YXRlKG5vZGUsIGlzU2VsZWN0ZWQpOwoJICAgICAgICAgICAgfSk7CgkgICAgICAgIH0KCSAgICB9Cgl9OwoJa28uZXhwcmVzc2lvblJld3JpdGluZy50d29XYXlCaW5kaW5nc1snc2VsZWN0ZWRPcHRpb25zJ10gPSB0cnVlOwoJa28uYmluZGluZ0hhbmRsZXJzWydzdHlsZSddID0gewoJICAgICd1cGRhdGUnOiBmdW5jdGlvbiAoZWxlbWVudCwgdmFsdWVBY2Nlc3NvcikgewoJICAgICAgICB2YXIgdmFsdWUgPSBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKHZhbHVlQWNjZXNzb3IoKSB8fCB7fSk7CgkgICAgICAgIGtvLnV0aWxzLm9iamVjdEZvckVhY2godmFsdWUsIGZ1bmN0aW9uKHN0eWxlTmFtZSwgc3R5bGVWYWx1ZSkgewoJICAgICAgICAgICAgc3R5bGVWYWx1ZSA9IGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUoc3R5bGVWYWx1ZSk7CgoJICAgICAgICAgICAgaWYgKHN0eWxlVmFsdWUgPT09IG51bGwgfHwgc3R5bGVWYWx1ZSA9PT0gdW5kZWZpbmVkIHx8IHN0eWxlVmFsdWUgPT09IGZhbHNlKSB7CgkgICAgICAgICAgICAgICAgLy8gRW1wdHkgc3RyaW5nIHJlbW92ZXMgdGhlIHZhbHVlLCB3aGVyZWFzIG51bGwvdW5kZWZpbmVkIGhhdmUgbm8gZWZmZWN0CgkgICAgICAgICAgICAgICAgc3R5bGVWYWx1ZSA9ICIiOwoJICAgICAgICAgICAgfQoKCSAgICAgICAgICAgIGVsZW1lbnQuc3R5bGVbc3R5bGVOYW1lXSA9IHN0eWxlVmFsdWU7CgkgICAgICAgIH0pOwoJICAgIH0KCX07Cglrby5iaW5kaW5nSGFuZGxlcnNbJ3N1Ym1pdCddID0gewoJICAgICdpbml0JzogZnVuY3Rpb24gKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IsIGFsbEJpbmRpbmdzLCB2aWV3TW9kZWwsIGJpbmRpbmdDb250ZXh0KSB7CgkgICAgICAgIGlmICh0eXBlb2YgdmFsdWVBY2Nlc3NvcigpICE9ICJmdW5jdGlvbiIpCgkgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlRoZSB2YWx1ZSBmb3IgYSBzdWJtaXQgYmluZGluZyBtdXN0IGJlIGEgZnVuY3Rpb24iKTsKCSAgICAgICAga28udXRpbHMucmVnaXN0ZXJFdmVudEhhbmRsZXIoZWxlbWVudCwgInN1Ym1pdCIsIGZ1bmN0aW9uIChldmVudCkgewoJICAgICAgICAgICAgdmFyIGhhbmRsZXJSZXR1cm5WYWx1ZTsKCSAgICAgICAgICAgIHZhciB2YWx1ZSA9IHZhbHVlQWNjZXNzb3IoKTsKCSAgICAgICAgICAgIHRyeSB7IGhhbmRsZXJSZXR1cm5WYWx1ZSA9IHZhbHVlLmNhbGwoYmluZGluZ0NvbnRleHRbJyRkYXRhJ10sIGVsZW1lbnQpOyB9CgkgICAgICAgICAgICBmaW5hbGx5IHsKCSAgICAgICAgICAgICAgICBpZiAoaGFuZGxlclJldHVyblZhbHVlICE9PSB0cnVlKSB7IC8vIE5vcm1hbGx5IHdlIHdhbnQgdG8gcHJldmVudCBkZWZhdWx0IGFjdGlvbi4gRGV2ZWxvcGVyIGNhbiBvdmVycmlkZSB0aGlzIGJlIGV4cGxpY2l0bHkgcmV0dXJuaW5nIHRydWUuCgkgICAgICAgICAgICAgICAgICAgIGlmIChldmVudC5wcmV2ZW50RGVmYXVsdCkKCSAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkgICAgICAgICAgICAgICAgICAgIGVsc2UKCSAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50LnJldHVyblZhbHVlID0gZmFsc2U7CgkgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgfQoJICAgICAgICB9KTsKCSAgICB9Cgl9OwoJa28uYmluZGluZ0hhbmRsZXJzWyd0ZXh0J10gPSB7CgkgICAgJ2luaXQnOiBmdW5jdGlvbigpIHsKCSAgICAgICAgLy8gUHJldmVudCBiaW5kaW5nIG9uIHRoZSBkeW5hbWljYWxseS1pbmplY3RlZCB0ZXh0IG5vZGUgKGFzIGRldmVsb3BlcnMgYXJlIHVubGlrZWx5IHRvIGV4cGVjdCB0aGF0LCBhbmQgaXQgaGFzIHNlY3VyaXR5IGltcGxpY2F0aW9ucykuCgkgICAgICAgIC8vIEl0IHNob3VsZCBhbHNvIG1ha2UgdGhpbmdzIGZhc3RlciwgYXMgd2Ugbm8gbG9uZ2VyIGhhdmUgdG8gY29uc2lkZXIgd2hldGhlciB0aGUgdGV4dCBub2RlIG1pZ2h0IGJlIGJpbmRhYmxlLgoJICAgICAgICByZXR1cm4geyAnY29udHJvbHNEZXNjZW5kYW50QmluZGluZ3MnOiB0cnVlIH07CgkgICAgfSwKCSAgICAndXBkYXRlJzogZnVuY3Rpb24gKGVsZW1lbnQsIHZhbHVlQWNjZXNzb3IpIHsKCSAgICAgICAga28udXRpbHMuc2V0VGV4dENvbnRlbnQoZWxlbWVudCwgdmFsdWVBY2Nlc3NvcigpKTsKCSAgICB9Cgl9OwoJa28udmlydHVhbEVsZW1lbnRzLmFsbG93ZWRCaW5kaW5nc1sndGV4dCddID0gdHJ1ZTsKCShmdW5jdGlvbiAoKSB7CgoJaWYgKHdpbmRvdyAmJiB3aW5kb3cubmF2aWdhdG9yKSB7CgkgICAgdmFyIHBhcnNlVmVyc2lvbiA9IGZ1bmN0aW9uIChtYXRjaGVzKSB7CgkgICAgICAgIGlmIChtYXRjaGVzKSB7CgkgICAgICAgICAgICByZXR1cm4gcGFyc2VGbG9hdChtYXRjaGVzWzFdKTsKCSAgICAgICAgfQoJICAgIH07CgoJICAgIC8vIERldGVjdCB2YXJpb3VzIGJyb3dzZXIgdmVyc2lvbnMgYmVjYXVzZSBzb21lIG9sZCB2ZXJzaW9ucyBkb24ndCBmdWxseSBzdXBwb3J0IHRoZSAnaW5wdXQnIGV2ZW50CgkgICAgdmFyIG9wZXJhVmVyc2lvbiA9IHdpbmRvdy5vcGVyYSAmJiB3aW5kb3cub3BlcmEudmVyc2lvbiAmJiBwYXJzZUludCh3aW5kb3cub3BlcmEudmVyc2lvbigpKSwKCSAgICAgICAgdXNlckFnZW50ID0gd2luZG93Lm5hdmlnYXRvci51c2VyQWdlbnQsCgkgICAgICAgIHNhZmFyaVZlcnNpb24gPSBwYXJzZVZlcnNpb24odXNlckFnZW50Lm1hdGNoKC9eKD86KD8hY2hyb21lKS4pKnZlcnNpb25cLyhbXiBdKikgc2FmYXJpL2kpKSwKCSAgICAgICAgZmlyZWZveFZlcnNpb24gPSBwYXJzZVZlcnNpb24odXNlckFnZW50Lm1hdGNoKC9GaXJlZm94XC8oW14gXSopLykpOwoJfQoKCS8vIElFIDggYW5kIDkgaGF2ZSBidWdzIHRoYXQgcHJldmVudCB0aGUgbm9ybWFsIGV2ZW50cyBmcm9tIGZpcmluZyB3aGVuIHRoZSB2YWx1ZSBjaGFuZ2VzLgoJLy8gQnV0IGl0IGRvZXMgZmlyZSB0aGUgJ3NlbGVjdGlvbmNoYW5nZScgZXZlbnQgb24gbWFueSBvZiB0aG9zZSwgcHJlc3VtYWJseSBiZWNhdXNlIHRoZQoJLy8gY3Vyc29yIGlzIG1vdmluZyBhbmQgdGhhdCBjb3VudHMgYXMgdGhlIHNlbGVjdGlvbiBjaGFuZ2luZy4gVGhlICdzZWxlY3Rpb25jaGFuZ2UnIGV2ZW50IGlzCgkvLyBmaXJlZCBhdCB0aGUgZG9jdW1lbnQgbGV2ZWwgb25seSBhbmQgZG9lc24ndCBkaXJlY3RseSBpbmRpY2F0ZSB3aGljaCBlbGVtZW50IGNoYW5nZWQuIFdlCgkvLyBzZXQgdXAganVzdCBvbmUgZXZlbnQgaGFuZGxlciBmb3IgdGhlIGRvY3VtZW50IGFuZCB1c2UgJ2FjdGl2ZUVsZW1lbnQnIHRvIGRldGVybWluZSB3aGljaAoJLy8gZWxlbWVudCB3YXMgY2hhbmdlZC4KCWlmIChrby51dGlscy5pZVZlcnNpb24gPCAxMCkgewoJICAgIHZhciBzZWxlY3Rpb25DaGFuZ2VSZWdpc3RlcmVkTmFtZSA9IGtvLnV0aWxzLmRvbURhdGEubmV4dEtleSgpLAoJICAgICAgICBzZWxlY3Rpb25DaGFuZ2VIYW5kbGVyTmFtZSA9IGtvLnV0aWxzLmRvbURhdGEubmV4dEtleSgpOwoJICAgIHZhciBzZWxlY3Rpb25DaGFuZ2VIYW5kbGVyID0gZnVuY3Rpb24oZXZlbnQpIHsKCSAgICAgICAgdmFyIHRhcmdldCA9IHRoaXMuYWN0aXZlRWxlbWVudCwKCSAgICAgICAgICAgIGhhbmRsZXIgPSB0YXJnZXQgJiYga28udXRpbHMuZG9tRGF0YS5nZXQodGFyZ2V0LCBzZWxlY3Rpb25DaGFuZ2VIYW5kbGVyTmFtZSk7CgkgICAgICAgIGlmIChoYW5kbGVyKSB7CgkgICAgICAgICAgICBoYW5kbGVyKGV2ZW50KTsKCSAgICAgICAgfQoJICAgIH07CgkgICAgdmFyIHJlZ2lzdGVyRm9yU2VsZWN0aW9uQ2hhbmdlRXZlbnQgPSBmdW5jdGlvbiAoZWxlbWVudCwgaGFuZGxlcikgewoJICAgICAgICB2YXIgb3duZXJEb2MgPSBlbGVtZW50Lm93bmVyRG9jdW1lbnQ7CgkgICAgICAgIGlmICgha28udXRpbHMuZG9tRGF0YS5nZXQob3duZXJEb2MsIHNlbGVjdGlvbkNoYW5nZVJlZ2lzdGVyZWROYW1lKSkgewoJICAgICAgICAgICAga28udXRpbHMuZG9tRGF0YS5zZXQob3duZXJEb2MsIHNlbGVjdGlvbkNoYW5nZVJlZ2lzdGVyZWROYW1lLCB0cnVlKTsKCSAgICAgICAgICAgIGtvLnV0aWxzLnJlZ2lzdGVyRXZlbnRIYW5kbGVyKG93bmVyRG9jLCAnc2VsZWN0aW9uY2hhbmdlJywgc2VsZWN0aW9uQ2hhbmdlSGFuZGxlcik7CgkgICAgICAgIH0KCSAgICAgICAga28udXRpbHMuZG9tRGF0YS5zZXQoZWxlbWVudCwgc2VsZWN0aW9uQ2hhbmdlSGFuZGxlck5hbWUsIGhhbmRsZXIpOwoJICAgIH07Cgl9CgoJa28uYmluZGluZ0hhbmRsZXJzWyd0ZXh0SW5wdXQnXSA9IHsKCSAgICAnaW5pdCc6IGZ1bmN0aW9uIChlbGVtZW50LCB2YWx1ZUFjY2Vzc29yLCBhbGxCaW5kaW5ncykgewoKCSAgICAgICAgdmFyIHByZXZpb3VzRWxlbWVudFZhbHVlID0gZWxlbWVudC52YWx1ZSwKCSAgICAgICAgICAgIHRpbWVvdXRIYW5kbGUsCgkgICAgICAgICAgICBlbGVtZW50VmFsdWVCZWZvcmVFdmVudDsKCgkgICAgICAgIHZhciB1cGRhdGVNb2RlbCA9IGZ1bmN0aW9uIChldmVudCkgewoJICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHRpbWVvdXRIYW5kbGUpOwoJICAgICAgICAgICAgZWxlbWVudFZhbHVlQmVmb3JlRXZlbnQgPSB0aW1lb3V0SGFuZGxlID0gdW5kZWZpbmVkOwoKCSAgICAgICAgICAgIHZhciBlbGVtZW50VmFsdWUgPSBlbGVtZW50LnZhbHVlOwoJICAgICAgICAgICAgaWYgKHByZXZpb3VzRWxlbWVudFZhbHVlICE9PSBlbGVtZW50VmFsdWUpIHsKCSAgICAgICAgICAgICAgICAvLyBQcm92aWRlIGEgd2F5IGZvciB0ZXN0cyB0byBrbm93IGV4YWN0bHkgd2hpY2ggZXZlbnQgd2FzIHByb2Nlc3NlZAoJICAgICAgICAgICAgICAgIGlmIChERUJVRyAmJiBldmVudCkgZWxlbWVudFsnX2tvX3RleHRJbnB1dFByb2Nlc3NlZEV2ZW50J10gPSBldmVudC50eXBlOwoJICAgICAgICAgICAgICAgIHByZXZpb3VzRWxlbWVudFZhbHVlID0gZWxlbWVudFZhbHVlOwoJICAgICAgICAgICAgICAgIGtvLmV4cHJlc3Npb25SZXdyaXRpbmcud3JpdGVWYWx1ZVRvUHJvcGVydHkodmFsdWVBY2Nlc3NvcigpLCBhbGxCaW5kaW5ncywgJ3RleHRJbnB1dCcsIGVsZW1lbnRWYWx1ZSk7CgkgICAgICAgICAgICB9CgkgICAgICAgIH07CgoJICAgICAgICB2YXIgZGVmZXJVcGRhdGVNb2RlbCA9IGZ1bmN0aW9uIChldmVudCkgewoJICAgICAgICAgICAgaWYgKCF0aW1lb3V0SGFuZGxlKSB7CgkgICAgICAgICAgICAgICAgLy8gVGhlIGVsZW1lbnRWYWx1ZUJlZm9yZUV2ZW50IHZhcmlhYmxlIGlzIHNldCAqb25seSogZHVyaW5nIHRoZSBicmllZiBnYXAgYmV0d2VlbiBhbgoJICAgICAgICAgICAgICAgIC8vIGV2ZW50IGZpcmluZyBhbmQgdGhlIHVwZGF0ZU1vZGVsIGZ1bmN0aW9uIHJ1bm5pbmcuIFRoaXMgYWxsb3dzIHVzIHRvIGlnbm9yZSBtb2RlbAoJICAgICAgICAgICAgICAgIC8vIHVwZGF0ZXMgdGhhdCBhcmUgZnJvbSB0aGUgcHJldmlvdXMgc3RhdGUgb2YgdGhlIGVsZW1lbnQsIHVzdWFsbHkgZHVlIHRvIHRlY2huaXF1ZXMKCSAgICAgICAgICAgICAgICAvLyBzdWNoIGFzIHJhdGVMaW1pdC4gU3VjaCB1cGRhdGVzLCBpZiBub3QgaWdub3JlZCwgY2FuIGNhdXNlIGtleXN0cm9rZXMgdG8gYmUgbG9zdC4KCSAgICAgICAgICAgICAgICBlbGVtZW50VmFsdWVCZWZvcmVFdmVudCA9IGVsZW1lbnQudmFsdWU7CgkgICAgICAgICAgICAgICAgdmFyIGhhbmRsZXIgPSBERUJVRyA/IHVwZGF0ZU1vZGVsLmJpbmQoZWxlbWVudCwge3R5cGU6IGV2ZW50LnR5cGV9KSA6IHVwZGF0ZU1vZGVsOwoJICAgICAgICAgICAgICAgIHRpbWVvdXRIYW5kbGUgPSBzZXRUaW1lb3V0KGhhbmRsZXIsIDQpOwoJICAgICAgICAgICAgfQoJICAgICAgICB9OwoKCSAgICAgICAgdmFyIHVwZGF0ZVZpZXcgPSBmdW5jdGlvbiAoKSB7CgkgICAgICAgICAgICB2YXIgbW9kZWxWYWx1ZSA9IGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUodmFsdWVBY2Nlc3NvcigpKTsKCgkgICAgICAgICAgICBpZiAobW9kZWxWYWx1ZSA9PT0gbnVsbCB8fCBtb2RlbFZhbHVlID09PSB1bmRlZmluZWQpIHsKCSAgICAgICAgICAgICAgICBtb2RlbFZhbHVlID0gJyc7CgkgICAgICAgICAgICB9CgoJICAgICAgICAgICAgaWYgKGVsZW1lbnRWYWx1ZUJlZm9yZUV2ZW50ICE9PSB1bmRlZmluZWQgJiYgbW9kZWxWYWx1ZSA9PT0gZWxlbWVudFZhbHVlQmVmb3JlRXZlbnQpIHsKCSAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KHVwZGF0ZVZpZXcsIDQpOwoJICAgICAgICAgICAgICAgIHJldHVybjsKCSAgICAgICAgICAgIH0KCgkgICAgICAgICAgICAvLyBVcGRhdGUgdGhlIGVsZW1lbnQgb25seSBpZiB0aGUgZWxlbWVudCBhbmQgbW9kZWwgYXJlIGRpZmZlcmVudC4gT24gc29tZSBicm93c2VycywgdXBkYXRpbmcgdGhlIHZhbHVlCgkgICAgICAgICAgICAvLyB3aWxsIG1vdmUgdGhlIGN1cnNvciB0byB0aGUgZW5kIG9mIHRoZSBpbnB1dCwgd2hpY2ggd291bGQgYmUgYmFkIHdoaWxlIHRoZSB1c2VyIGlzIHR5cGluZy4KCSAgICAgICAgICAgIGlmIChlbGVtZW50LnZhbHVlICE9PSBtb2RlbFZhbHVlKSB7CgkgICAgICAgICAgICAgICAgcHJldmlvdXNFbGVtZW50VmFsdWUgPSBtb2RlbFZhbHVlOyAgLy8gTWFrZSBzdXJlIHdlIGlnbm9yZSBldmVudHMgKHByb3BlcnR5Y2hhbmdlKSB0aGF0IHJlc3VsdCBmcm9tIHVwZGF0aW5nIHRoZSB2YWx1ZQoJICAgICAgICAgICAgICAgIGVsZW1lbnQudmFsdWUgPSBtb2RlbFZhbHVlOwoJICAgICAgICAgICAgfQoJICAgICAgICB9OwoKCSAgICAgICAgdmFyIG9uRXZlbnQgPSBmdW5jdGlvbiAoZXZlbnQsIGhhbmRsZXIpIHsKCSAgICAgICAgICAgIGtvLnV0aWxzLnJlZ2lzdGVyRXZlbnRIYW5kbGVyKGVsZW1lbnQsIGV2ZW50LCBoYW5kbGVyKTsKCSAgICAgICAgfTsKCgkgICAgICAgIGlmIChERUJVRyAmJiBrby5iaW5kaW5nSGFuZGxlcnNbJ3RleHRJbnB1dCddWydfZm9yY2VVcGRhdGVPbiddKSB7CgkgICAgICAgICAgICAvLyBQcm92aWRlIGEgd2F5IGZvciB0ZXN0cyB0byBzcGVjaWZ5IGV4YWN0bHkgd2hpY2ggZXZlbnRzIGFyZSBib3VuZAoJICAgICAgICAgICAga28udXRpbHMuYXJyYXlGb3JFYWNoKGtvLmJpbmRpbmdIYW5kbGVyc1sndGV4dElucHV0J11bJ19mb3JjZVVwZGF0ZU9uJ10sIGZ1bmN0aW9uKGV2ZW50TmFtZSkgewoJICAgICAgICAgICAgICAgIGlmIChldmVudE5hbWUuc2xpY2UoMCw1KSA9PSAnYWZ0ZXInKSB7CgkgICAgICAgICAgICAgICAgICAgIG9uRXZlbnQoZXZlbnROYW1lLnNsaWNlKDUpLCBkZWZlclVwZGF0ZU1vZGVsKTsKCSAgICAgICAgICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgICAgICAgICBvbkV2ZW50KGV2ZW50TmFtZSwgdXBkYXRlTW9kZWwpOwoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgIH0pOwoJICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgaWYgKGtvLnV0aWxzLmllVmVyc2lvbiA8IDEwKSB7CgkgICAgICAgICAgICAgICAgLy8gSW50ZXJuZXQgRXhwbG9yZXIgPD0gOCBkb2Vzbid0IHN1cHBvcnQgdGhlICdpbnB1dCcgZXZlbnQsIGJ1dCBkb2VzIGluY2x1ZGUgJ3Byb3BlcnR5Y2hhbmdlJyB0aGF0IGZpcmVzIHdoZW5ldmVyCgkgICAgICAgICAgICAgICAgLy8gYW55IHByb3BlcnR5IG9mIGFuIGVsZW1lbnQgY2hhbmdlcy4gVW5saWtlICdpbnB1dCcsIGl0IGFsc28gZmlyZXMgaWYgYSBwcm9wZXJ0eSBpcyBjaGFuZ2VkIGZyb20gSmF2YVNjcmlwdCBjb2RlLAoJICAgICAgICAgICAgICAgIC8vIGJ1dCB0aGF0J3MgYW4gYWNjZXB0YWJsZSBjb21wcm9taXNlIGZvciB0aGlzIGJpbmRpbmcuIElFIDkgZG9lcyBzdXBwb3J0ICdpbnB1dCcsIGJ1dCBzaW5jZSBpdCBkb2Vzbid0IGZpcmUgaXQKCSAgICAgICAgICAgICAgICAvLyB3aGVuIHVzaW5nIGF1dG9jb21wbGV0ZSwgd2UnbGwgdXNlICdwcm9wZXJ0eWNoYW5nZScgZm9yIGl0IGFsc28uCgkgICAgICAgICAgICAgICAgb25FdmVudCgncHJvcGVydHljaGFuZ2UnLCBmdW5jdGlvbihldmVudCkgewoJICAgICAgICAgICAgICAgICAgICBpZiAoZXZlbnQucHJvcGVydHlOYW1lID09PSAndmFsdWUnKSB7CgkgICAgICAgICAgICAgICAgICAgICAgICB1cGRhdGVNb2RlbChldmVudCk7CgkgICAgICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICB9KTsKCgkgICAgICAgICAgICAgICAgaWYgKGtvLnV0aWxzLmllVmVyc2lvbiA9PSA4KSB7CgkgICAgICAgICAgICAgICAgICAgIC8vIElFIDggaGFzIGEgYnVnIHdoZXJlIGl0IGZhaWxzIHRvIGZpcmUgJ3Byb3BlcnR5Y2hhbmdlJyBvbiB0aGUgZmlyc3QgdXBkYXRlIGZvbGxvd2luZyBhIHZhbHVlIGNoYW5nZSBmcm9tCgkgICAgICAgICAgICAgICAgICAgIC8vIEphdmFTY3JpcHQgY29kZS4gSXQgYWxzbyBkb2Vzbid0IGZpcmUgaWYgeW91IGNsZWFyIHRoZSBlbnRpcmUgdmFsdWUuIFRvIGZpeCB0aGlzLCB3ZSBiaW5kIHRvIHRoZSBmb2xsb3dpbmcKCSAgICAgICAgICAgICAgICAgICAgLy8gZXZlbnRzIHRvby4KCSAgICAgICAgICAgICAgICAgICAgb25FdmVudCgna2V5dXAnLCB1cGRhdGVNb2RlbCk7ICAgICAgLy8gQSBzaW5nbGUga2V5c3Rva2UKCSAgICAgICAgICAgICAgICAgICAgb25FdmVudCgna2V5ZG93bicsIHVwZGF0ZU1vZGVsKTsgICAgLy8gVGhlIGZpcnN0IGNoYXJhY3RlciB3aGVuIGEga2V5IGlzIGhlbGQgZG93bgoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICBpZiAoa28udXRpbHMuaWVWZXJzaW9uID49IDgpIHsKCSAgICAgICAgICAgICAgICAgICAgLy8gSW50ZXJuZXQgRXhwbG9yZXIgOSBkb2Vzbid0IGZpcmUgdGhlICdpbnB1dCcgZXZlbnQgd2hlbiBkZWxldGluZyB0ZXh0LCBpbmNsdWRpbmcgdXNpbmcKCSAgICAgICAgICAgICAgICAgICAgLy8gdGhlIGJhY2tzcGFjZSwgZGVsZXRlLCBvciBjdHJsLXgga2V5cywgY2xpY2tpbmcgdGhlICd4JyB0byBjbGVhciB0aGUgaW5wdXQsIGRyYWdnaW5nIHRleHQKCSAgICAgICAgICAgICAgICAgICAgLy8gb3V0IG9mIHRoZSBmaWVsZCwgYW5kIGN1dHRpbmcgb3IgZGVsZXRpbmcgdGV4dCB1c2luZyB0aGUgY29udGV4dCBtZW51LiAnc2VsZWN0aW9uY2hhbmdlJwoJICAgICAgICAgICAgICAgICAgICAvLyBjYW4gZGV0ZWN0IGFsbCBvZiB0aG9zZSBleGNlcHQgZHJhZ2dpbmcgdGV4dCBvdXQgb2YgdGhlIGZpZWxkLCBmb3Igd2hpY2ggd2UgdXNlICdkcmFnZW5kJy4KCSAgICAgICAgICAgICAgICAgICAgLy8gVGhlc2UgYXJlIGFsc28gbmVlZGVkIGluIElFOCBiZWNhdXNlIG9mIHRoZSBidWcgZGVzY3JpYmVkIGFib3ZlLgoJICAgICAgICAgICAgICAgICAgICByZWdpc3RlckZvclNlbGVjdGlvbkNoYW5nZUV2ZW50KGVsZW1lbnQsIHVwZGF0ZU1vZGVsKTsgIC8vICdzZWxlY3Rpb25jaGFuZ2UnIGNvdmVycyBjdXQsIHBhc3RlLCBkcm9wLCBkZWxldGUsIGV0Yy4KCSAgICAgICAgICAgICAgICAgICAgb25FdmVudCgnZHJhZ2VuZCcsIGRlZmVyVXBkYXRlTW9kZWwpOwoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICAgICAgLy8gQWxsIG90aGVyIHN1cHBvcnRlZCBicm93c2VycyBzdXBwb3J0IHRoZSAnaW5wdXQnIGV2ZW50LCB3aGljaCBmaXJlcyB3aGVuZXZlciB0aGUgY29udGVudCBvZiB0aGUgZWxlbWVudCBpcyBjaGFuZ2VkCgkgICAgICAgICAgICAgICAgLy8gdGhyb3VnaCB0aGUgdXNlciBpbnRlcmZhY2UuCgkgICAgICAgICAgICAgICAgb25FdmVudCgnaW5wdXQnLCB1cGRhdGVNb2RlbCk7CgoJICAgICAgICAgICAgICAgIGlmIChzYWZhcmlWZXJzaW9uIDwgNSAmJiBrby51dGlscy50YWdOYW1lTG93ZXIoZWxlbWVudCkgPT09ICJ0ZXh0YXJlYSIpIHsKCSAgICAgICAgICAgICAgICAgICAgLy8gU2FmYXJpIDw1IGRvZXNuJ3QgZmlyZSB0aGUgJ2lucHV0JyBldmVudCBmb3IgPHRleHRhcmVhPiBlbGVtZW50cyAoaXQgZG9lcyBmaXJlICd0ZXh0SW5wdXQnCgkgICAgICAgICAgICAgICAgICAgIC8vIGJ1dCBvbmx5IHdoZW4gdHlwaW5nKS4gU28gd2UnbGwganVzdCBjYXRjaCBhcyBtdWNoIGFzIHdlIGNhbiB3aXRoIGtleWRvd24sIGN1dCwgYW5kIHBhc3RlLgoJICAgICAgICAgICAgICAgICAgICBvbkV2ZW50KCdrZXlkb3duJywgZGVmZXJVcGRhdGVNb2RlbCk7CgkgICAgICAgICAgICAgICAgICAgIG9uRXZlbnQoJ3Bhc3RlJywgZGVmZXJVcGRhdGVNb2RlbCk7CgkgICAgICAgICAgICAgICAgICAgIG9uRXZlbnQoJ2N1dCcsIGRlZmVyVXBkYXRlTW9kZWwpOwoJICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAob3BlcmFWZXJzaW9uIDwgMTEpIHsKCSAgICAgICAgICAgICAgICAgICAgLy8gT3BlcmEgMTAgZG9lc24ndCBhbHdheXMgZmlyZSB0aGUgJ2lucHV0JyBldmVudCBmb3IgY3V0LCBwYXN0ZSwgdW5kbyAmIGRyb3Agb3BlcmF0aW9ucy4KCSAgICAgICAgICAgICAgICAgICAgLy8gV2UgY2FuIHRyeSB0byBjYXRjaCBzb21lIG9mIHRob3NlIHVzaW5nICdrZXlkb3duJy4KCSAgICAgICAgICAgICAgICAgICAgb25FdmVudCgna2V5ZG93bicsIGRlZmVyVXBkYXRlTW9kZWwpOwoJICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoZmlyZWZveFZlcnNpb24gPCA0LjApIHsKCSAgICAgICAgICAgICAgICAgICAgLy8gRmlyZWZveCA8PSAzLjYgZG9lc24ndCBmaXJlIHRoZSAnaW5wdXQnIGV2ZW50IHdoZW4gdGV4dCBpcyBmaWxsZWQgaW4gdGhyb3VnaCBhdXRvY29tcGxldGUKCSAgICAgICAgICAgICAgICAgICAgb25FdmVudCgnRE9NQXV0b0NvbXBsZXRlJywgdXBkYXRlTW9kZWwpOwoKCSAgICAgICAgICAgICAgICAgICAgLy8gRmlyZWZveCA8PTMuNSBkb2Vzbid0IGZpcmUgdGhlICdpbnB1dCcgZXZlbnQgd2hlbiB0ZXh0IGlzIGRyb3BwZWQgaW50byB0aGUgaW5wdXQuCgkgICAgICAgICAgICAgICAgICAgIG9uRXZlbnQoJ2RyYWdkcm9wJywgdXBkYXRlTW9kZWwpOyAgICAgICAvLyA8My41CgkgICAgICAgICAgICAgICAgICAgIG9uRXZlbnQoJ2Ryb3AnLCB1cGRhdGVNb2RlbCk7ICAgICAgICAgICAvLyAzLjUKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICB9CgkgICAgICAgIH0KCgkgICAgICAgIC8vIEJpbmQgdG8gdGhlIGNoYW5nZSBldmVudCBzbyB0aGF0IHdlIGNhbiBjYXRjaCBwcm9ncmFtbWF0aWMgdXBkYXRlcyBvZiB0aGUgdmFsdWUgdGhhdCBmaXJlIHRoaXMgZXZlbnQuCgkgICAgICAgIG9uRXZlbnQoJ2NoYW5nZScsIHVwZGF0ZU1vZGVsKTsKCgkgICAgICAgIGtvLmNvbXB1dGVkKHVwZGF0ZVZpZXcsIG51bGwsIHsgZGlzcG9zZVdoZW5Ob2RlSXNSZW1vdmVkOiBlbGVtZW50IH0pOwoJICAgIH0KCX07Cglrby5leHByZXNzaW9uUmV3cml0aW5nLnR3b1dheUJpbmRpbmdzWyd0ZXh0SW5wdXQnXSA9IHRydWU7CgoJLy8gdGV4dGlucHV0IGlzIGFuIGFsaWFzIGZvciB0ZXh0SW5wdXQKCWtvLmJpbmRpbmdIYW5kbGVyc1sndGV4dGlucHV0J10gPSB7CgkgICAgLy8gcHJlcHJvY2VzcyBpcyB0aGUgb25seSB3YXkgdG8gc2V0IHVwIGEgZnVsbCBhbGlhcwoJICAgICdwcmVwcm9jZXNzJzogZnVuY3Rpb24gKHZhbHVlLCBuYW1lLCBhZGRCaW5kaW5nKSB7CgkgICAgICAgIGFkZEJpbmRpbmcoJ3RleHRJbnB1dCcsIHZhbHVlKTsKCSAgICB9Cgl9OwoKCX0pKCk7a28uYmluZGluZ0hhbmRsZXJzWyd1bmlxdWVOYW1lJ10gPSB7CgkgICAgJ2luaXQnOiBmdW5jdGlvbiAoZWxlbWVudCwgdmFsdWVBY2Nlc3NvcikgewoJICAgICAgICBpZiAodmFsdWVBY2Nlc3NvcigpKSB7CgkgICAgICAgICAgICB2YXIgbmFtZSA9ICJrb191bmlxdWVfIiArICgrK2tvLmJpbmRpbmdIYW5kbGVyc1sndW5pcXVlTmFtZSddLmN1cnJlbnRJbmRleCk7CgkgICAgICAgICAgICBrby51dGlscy5zZXRFbGVtZW50TmFtZShlbGVtZW50LCBuYW1lKTsKCSAgICAgICAgfQoJICAgIH0KCX07Cglrby5iaW5kaW5nSGFuZGxlcnNbJ3VuaXF1ZU5hbWUnXS5jdXJyZW50SW5kZXggPSAwOwoJa28uYmluZGluZ0hhbmRsZXJzWyd2YWx1ZSddID0gewoJICAgICdhZnRlcic6IFsnb3B0aW9ucycsICdmb3JlYWNoJ10sCgkgICAgJ2luaXQnOiBmdW5jdGlvbiAoZWxlbWVudCwgdmFsdWVBY2Nlc3NvciwgYWxsQmluZGluZ3MpIHsKCSAgICAgICAgLy8gSWYgdGhlIHZhbHVlIGJpbmRpbmcgaXMgcGxhY2VkIG9uIGEgcmFkaW8vY2hlY2tib3gsIHRoZW4ganVzdCBwYXNzIHRocm91Z2ggdG8gY2hlY2tlZFZhbHVlIGFuZCBxdWl0CgkgICAgICAgIGlmIChlbGVtZW50LnRhZ05hbWUudG9Mb3dlckNhc2UoKSA9PSAiaW5wdXQiICYmIChlbGVtZW50LnR5cGUgPT0gImNoZWNrYm94IiB8fCBlbGVtZW50LnR5cGUgPT0gInJhZGlvIikpIHsKCSAgICAgICAgICAgIGtvLmFwcGx5QmluZGluZ0FjY2Vzc29yc1RvTm9kZShlbGVtZW50LCB7ICdjaGVja2VkVmFsdWUnOiB2YWx1ZUFjY2Vzc29yIH0pOwoJICAgICAgICAgICAgcmV0dXJuOwoJICAgICAgICB9CgoJICAgICAgICAvLyBBbHdheXMgY2F0Y2ggImNoYW5nZSIgZXZlbnQ7IHBvc3NpYmx5IG90aGVyIGV2ZW50cyB0b28gaWYgYXNrZWQKCSAgICAgICAgdmFyIGV2ZW50c1RvQ2F0Y2ggPSBbImNoYW5nZSJdOwoJICAgICAgICB2YXIgcmVxdWVzdGVkRXZlbnRzVG9DYXRjaCA9IGFsbEJpbmRpbmdzLmdldCgidmFsdWVVcGRhdGUiKTsKCSAgICAgICAgdmFyIHByb3BlcnR5Q2hhbmdlZEZpcmVkID0gZmFsc2U7CgkgICAgICAgIHZhciBlbGVtZW50VmFsdWVCZWZvcmVFdmVudCA9IG51bGw7CgoJICAgICAgICBpZiAocmVxdWVzdGVkRXZlbnRzVG9DYXRjaCkgewoJICAgICAgICAgICAgaWYgKHR5cGVvZiByZXF1ZXN0ZWRFdmVudHNUb0NhdGNoID09ICJzdHJpbmciKSAvLyBBbGxvdyBib3RoIGluZGl2aWR1YWwgZXZlbnQgbmFtZXMsIGFuZCBhcnJheXMgb2YgZXZlbnQgbmFtZXMKCSAgICAgICAgICAgICAgICByZXF1ZXN0ZWRFdmVudHNUb0NhdGNoID0gW3JlcXVlc3RlZEV2ZW50c1RvQ2F0Y2hdOwoJICAgICAgICAgICAga28udXRpbHMuYXJyYXlQdXNoQWxsKGV2ZW50c1RvQ2F0Y2gsIHJlcXVlc3RlZEV2ZW50c1RvQ2F0Y2gpOwoJICAgICAgICAgICAgZXZlbnRzVG9DYXRjaCA9IGtvLnV0aWxzLmFycmF5R2V0RGlzdGluY3RWYWx1ZXMoZXZlbnRzVG9DYXRjaCk7CgkgICAgICAgIH0KCgkgICAgICAgIHZhciB2YWx1ZVVwZGF0ZUhhbmRsZXIgPSBmdW5jdGlvbigpIHsKCSAgICAgICAgICAgIGVsZW1lbnRWYWx1ZUJlZm9yZUV2ZW50ID0gbnVsbDsKCSAgICAgICAgICAgIHByb3BlcnR5Q2hhbmdlZEZpcmVkID0gZmFsc2U7CgkgICAgICAgICAgICB2YXIgbW9kZWxWYWx1ZSA9IHZhbHVlQWNjZXNzb3IoKTsKCSAgICAgICAgICAgIHZhciBlbGVtZW50VmFsdWUgPSBrby5zZWxlY3RFeHRlbnNpb25zLnJlYWRWYWx1ZShlbGVtZW50KTsKCSAgICAgICAgICAgIGtvLmV4cHJlc3Npb25SZXdyaXRpbmcud3JpdGVWYWx1ZVRvUHJvcGVydHkobW9kZWxWYWx1ZSwgYWxsQmluZGluZ3MsICd2YWx1ZScsIGVsZW1lbnRWYWx1ZSk7CgkgICAgICAgIH0KCgkgICAgICAgIC8vIFdvcmthcm91bmQgZm9yIGh0dHBzOi8vZ2l0aHViLmNvbS9TdGV2ZVNhbmRlcnNvbi9rbm9ja291dC9pc3N1ZXMvMTIyCgkgICAgICAgIC8vIElFIGRvZXNuJ3QgZmlyZSAiY2hhbmdlIiBldmVudHMgb24gdGV4dGJveGVzIGlmIHRoZSB1c2VyIHNlbGVjdHMgYSB2YWx1ZSBmcm9tIGl0cyBhdXRvY29tcGxldGUgbGlzdAoJICAgICAgICB2YXIgaWVBdXRvQ29tcGxldGVIYWNrTmVlZGVkID0ga28udXRpbHMuaWVWZXJzaW9uICYmIGVsZW1lbnQudGFnTmFtZS50b0xvd2VyQ2FzZSgpID09ICJpbnB1dCIgJiYgZWxlbWVudC50eXBlID09ICJ0ZXh0IgoJICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJiYgZWxlbWVudC5hdXRvY29tcGxldGUgIT0gIm9mZiIgJiYgKCFlbGVtZW50LmZvcm0gfHwgZWxlbWVudC5mb3JtLmF1dG9jb21wbGV0ZSAhPSAib2ZmIik7CgkgICAgICAgIGlmIChpZUF1dG9Db21wbGV0ZUhhY2tOZWVkZWQgJiYga28udXRpbHMuYXJyYXlJbmRleE9mKGV2ZW50c1RvQ2F0Y2gsICJwcm9wZXJ0eWNoYW5nZSIpID09IC0xKSB7CgkgICAgICAgICAgICBrby51dGlscy5yZWdpc3RlckV2ZW50SGFuZGxlcihlbGVtZW50LCAicHJvcGVydHljaGFuZ2UiLCBmdW5jdGlvbiAoKSB7IHByb3BlcnR5Q2hhbmdlZEZpcmVkID0gdHJ1ZSB9KTsKCSAgICAgICAgICAgIGtvLnV0aWxzLnJlZ2lzdGVyRXZlbnRIYW5kbGVyKGVsZW1lbnQsICJmb2N1cyIsIGZ1bmN0aW9uICgpIHsgcHJvcGVydHlDaGFuZ2VkRmlyZWQgPSBmYWxzZSB9KTsKCSAgICAgICAgICAgIGtvLnV0aWxzLnJlZ2lzdGVyRXZlbnRIYW5kbGVyKGVsZW1lbnQsICJibHVyIiwgZnVuY3Rpb24oKSB7CgkgICAgICAgICAgICAgICAgaWYgKHByb3BlcnR5Q2hhbmdlZEZpcmVkKSB7CgkgICAgICAgICAgICAgICAgICAgIHZhbHVlVXBkYXRlSGFuZGxlcigpOwoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgIH0pOwoJICAgICAgICB9CgoJICAgICAgICBrby51dGlscy5hcnJheUZvckVhY2goZXZlbnRzVG9DYXRjaCwgZnVuY3Rpb24oZXZlbnROYW1lKSB7CgkgICAgICAgICAgICAvLyBUaGUgc3ludGF4ICJhZnRlcjxldmVudG5hbWU+IiBtZWFucyAicnVuIHRoZSBoYW5kbGVyIGFzeW5jaHJvbm91c2x5IGFmdGVyIHRoZSBldmVudCIKCSAgICAgICAgICAgIC8vIFRoaXMgaXMgdXNlZnVsLCBmb3IgZXhhbXBsZSwgdG8gY2F0Y2ggImtleWRvd24iIGV2ZW50cyBhZnRlciB0aGUgYnJvd3NlciBoYXMgdXBkYXRlZCB0aGUgY29udHJvbAoJICAgICAgICAgICAgLy8gKG90aGVyd2lzZSwga28uc2VsZWN0RXh0ZW5zaW9ucy5yZWFkVmFsdWUodGhpcykgd2lsbCByZWNlaXZlIHRoZSBjb250cm9sJ3MgdmFsdWUgKmJlZm9yZSogdGhlIGtleSBldmVudCkKCSAgICAgICAgICAgIHZhciBoYW5kbGVyID0gdmFsdWVVcGRhdGVIYW5kbGVyOwoJICAgICAgICAgICAgaWYgKGtvLnV0aWxzLnN0cmluZ1N0YXJ0c1dpdGgoZXZlbnROYW1lLCAiYWZ0ZXIiKSkgewoJICAgICAgICAgICAgICAgIGhhbmRsZXIgPSBmdW5jdGlvbigpIHsKCSAgICAgICAgICAgICAgICAgICAgLy8gVGhlIGVsZW1lbnRWYWx1ZUJlZm9yZUV2ZW50IHZhcmlhYmxlIGlzIG5vbi1udWxsICpvbmx5KiBkdXJpbmcgdGhlIGJyaWVmIGdhcCBiZXR3ZWVuCgkgICAgICAgICAgICAgICAgICAgIC8vIGEga2V5WCBldmVudCBmaXJpbmcgYW5kIHRoZSB2YWx1ZVVwZGF0ZUhhbmRsZXIgcnVubmluZywgd2hpY2ggaXMgc2NoZWR1bGVkIHRvIGhhcHBlbgoJICAgICAgICAgICAgICAgICAgICAvLyBhdCB0aGUgZWFybGllc3QgYXN5bmNocm9ub3VzIG9wcG9ydHVuaXR5LiBXZSBzdG9yZSB0aGlzIHRlbXBvcmFyeSBpbmZvcm1hdGlvbiBzbyB0aGF0CgkgICAgICAgICAgICAgICAgICAgIC8vIGlmLCBiZXR3ZWVuIGtleVggYW5kIHZhbHVlVXBkYXRlSGFuZGxlciwgdGhlIHVuZGVybHlpbmcgbW9kZWwgdmFsdWUgY2hhbmdlcyBzZXBhcmF0ZWx5LAoJICAgICAgICAgICAgICAgICAgICAvLyB3ZSBjYW4gb3ZlcndyaXRlIHRoYXQgbW9kZWwgdmFsdWUgY2hhbmdlIHdpdGggdGhlIHZhbHVlIHRoZSB1c2VyIGp1c3QgdHlwZWQuIE90aGVyd2lzZSwKCSAgICAgICAgICAgICAgICAgICAgLy8gdGVjaG5pcXVlcyBsaWtlIHJhdGVMaW1pdCBjYW4gdHJpZ2dlciBtb2RlbCBjaGFuZ2VzIGF0IGNyaXRpY2FsIG1vbWVudHMgdGhhdCB3aWxsCgkgICAgICAgICAgICAgICAgICAgIC8vIG92ZXJyaWRlIHRoZSB1c2VyJ3MgaW5wdXRzLCBjYXVzaW5nIGtleXN0cm9rZXMgdG8gYmUgbG9zdC4KCSAgICAgICAgICAgICAgICAgICAgZWxlbWVudFZhbHVlQmVmb3JlRXZlbnQgPSBrby5zZWxlY3RFeHRlbnNpb25zLnJlYWRWYWx1ZShlbGVtZW50KTsKCSAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dCh2YWx1ZVVwZGF0ZUhhbmRsZXIsIDApOwoJICAgICAgICAgICAgICAgIH07CgkgICAgICAgICAgICAgICAgZXZlbnROYW1lID0gZXZlbnROYW1lLnN1YnN0cmluZygiYWZ0ZXIiLmxlbmd0aCk7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICBrby51dGlscy5yZWdpc3RlckV2ZW50SGFuZGxlcihlbGVtZW50LCBldmVudE5hbWUsIGhhbmRsZXIpOwoJICAgICAgICB9KTsKCgkgICAgICAgIHZhciB1cGRhdGVGcm9tTW9kZWwgPSBmdW5jdGlvbiAoKSB7CgkgICAgICAgICAgICB2YXIgbmV3VmFsdWUgPSBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKHZhbHVlQWNjZXNzb3IoKSk7CgkgICAgICAgICAgICB2YXIgZWxlbWVudFZhbHVlID0ga28uc2VsZWN0RXh0ZW5zaW9ucy5yZWFkVmFsdWUoZWxlbWVudCk7CgoJICAgICAgICAgICAgaWYgKGVsZW1lbnRWYWx1ZUJlZm9yZUV2ZW50ICE9PSBudWxsICYmIG5ld1ZhbHVlID09PSBlbGVtZW50VmFsdWVCZWZvcmVFdmVudCkgewoJICAgICAgICAgICAgICAgIHNldFRpbWVvdXQodXBkYXRlRnJvbU1vZGVsLCAwKTsKCSAgICAgICAgICAgICAgICByZXR1cm47CgkgICAgICAgICAgICB9CgoJICAgICAgICAgICAgdmFyIHZhbHVlSGFzQ2hhbmdlZCA9IChuZXdWYWx1ZSAhPT0gZWxlbWVudFZhbHVlKTsKCgkgICAgICAgICAgICBpZiAodmFsdWVIYXNDaGFuZ2VkKSB7CgkgICAgICAgICAgICAgICAgaWYgKGtvLnV0aWxzLnRhZ05hbWVMb3dlcihlbGVtZW50KSA9PT0gInNlbGVjdCIpIHsKCSAgICAgICAgICAgICAgICAgICAgdmFyIGFsbG93VW5zZXQgPSBhbGxCaW5kaW5ncy5nZXQoJ3ZhbHVlQWxsb3dVbnNldCcpOwoJICAgICAgICAgICAgICAgICAgICB2YXIgYXBwbHlWYWx1ZUFjdGlvbiA9IGZ1bmN0aW9uICgpIHsKCSAgICAgICAgICAgICAgICAgICAgICAgIGtvLnNlbGVjdEV4dGVuc2lvbnMud3JpdGVWYWx1ZShlbGVtZW50LCBuZXdWYWx1ZSwgYWxsb3dVbnNldCk7CgkgICAgICAgICAgICAgICAgICAgIH07CgkgICAgICAgICAgICAgICAgICAgIGFwcGx5VmFsdWVBY3Rpb24oKTsKCgkgICAgICAgICAgICAgICAgICAgIGlmICghYWxsb3dVbnNldCAmJiBuZXdWYWx1ZSAhPT0ga28uc2VsZWN0RXh0ZW5zaW9ucy5yZWFkVmFsdWUoZWxlbWVudCkpIHsKCSAgICAgICAgICAgICAgICAgICAgICAgIC8vIElmIHlvdSB0cnkgdG8gc2V0IGEgbW9kZWwgdmFsdWUgdGhhdCBjYW4ndCBiZSByZXByZXNlbnRlZCBpbiBhbiBhbHJlYWR5LXBvcHVsYXRlZCBkcm9wZG93biwgcmVqZWN0IHRoYXQgY2hhbmdlLAoJICAgICAgICAgICAgICAgICAgICAgICAgLy8gYmVjYXVzZSB5b3UncmUgbm90IGFsbG93ZWQgdG8gaGF2ZSBhIG1vZGVsIHZhbHVlIHRoYXQgZGlzYWdyZWVzIHdpdGggYSB2aXNpYmxlIFVJIHNlbGVjdGlvbi4KCSAgICAgICAgICAgICAgICAgICAgICAgIGtvLmRlcGVuZGVuY3lEZXRlY3Rpb24uaWdub3JlKGtvLnV0aWxzLnRyaWdnZXJFdmVudCwgbnVsbCwgW2VsZW1lbnQsICJjaGFuZ2UiXSk7CgkgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICAgICAgICAgICAgICAvLyBXb3JrYXJvdW5kIGZvciBJRTYgYnVnOiBJdCB3b24ndCByZWxpYWJseSBhcHBseSB2YWx1ZXMgdG8gU0VMRUNUIG5vZGVzIGR1cmluZyB0aGUgc2FtZSBleGVjdXRpb24gdGhyZWFkCgkgICAgICAgICAgICAgICAgICAgICAgICAvLyByaWdodCBhZnRlciB5b3UndmUgY2hhbmdlZCB0aGUgc2V0IG9mIE9QVElPTiBub2RlcyBvbiBpdC4gU28gZm9yIHRoYXQgbm9kZSB0eXBlLCB3ZSdsbCBzY2hlZHVsZSBhIHNlY29uZCB0aHJlYWQKCSAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRvIGFwcGx5IHRoZSB2YWx1ZSBhcyB3ZWxsLgoJICAgICAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dChhcHBseVZhbHVlQWN0aW9uLCAwKTsKCSAgICAgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICAgICAgICAgIGtvLnNlbGVjdEV4dGVuc2lvbnMud3JpdGVWYWx1ZShlbGVtZW50LCBuZXdWYWx1ZSk7CgkgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgfQoJICAgICAgICB9OwoKCSAgICAgICAga28uY29tcHV0ZWQodXBkYXRlRnJvbU1vZGVsLCBudWxsLCB7IGRpc3Bvc2VXaGVuTm9kZUlzUmVtb3ZlZDogZWxlbWVudCB9KTsKCSAgICB9LAoJICAgICd1cGRhdGUnOiBmdW5jdGlvbigpIHt9IC8vIEtlZXAgZm9yIGJhY2t3YXJkcyBjb21wYXRpYmlsaXR5IHdpdGggY29kZSB0aGF0IG1heSBoYXZlIHdyYXBwZWQgdmFsdWUgYmluZGluZwoJfTsKCWtvLmV4cHJlc3Npb25SZXdyaXRpbmcudHdvV2F5QmluZGluZ3NbJ3ZhbHVlJ10gPSB0cnVlOwoJa28uYmluZGluZ0hhbmRsZXJzWyd2aXNpYmxlJ10gPSB7CgkgICAgJ3VwZGF0ZSc6IGZ1bmN0aW9uIChlbGVtZW50LCB2YWx1ZUFjY2Vzc29yKSB7CgkgICAgICAgIHZhciB2YWx1ZSA9IGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUodmFsdWVBY2Nlc3NvcigpKTsKCSAgICAgICAgdmFyIGlzQ3VycmVudGx5VmlzaWJsZSA9ICEoZWxlbWVudC5zdHlsZS5kaXNwbGF5ID09ICJub25lIik7CgkgICAgICAgIGlmICh2YWx1ZSAmJiAhaXNDdXJyZW50bHlWaXNpYmxlKQoJICAgICAgICAgICAgZWxlbWVudC5zdHlsZS5kaXNwbGF5ID0gIiI7CgkgICAgICAgIGVsc2UgaWYgKCghdmFsdWUpICYmIGlzQ3VycmVudGx5VmlzaWJsZSkKCSAgICAgICAgICAgIGVsZW1lbnQuc3R5bGUuZGlzcGxheSA9ICJub25lIjsKCSAgICB9Cgl9OwoJLy8gJ2NsaWNrJyBpcyBqdXN0IGEgc2hvcnRoYW5kIGZvciB0aGUgdXN1YWwgZnVsbC1sZW5ndGggZXZlbnQ6e2NsaWNrOmhhbmRsZXJ9CgltYWtlRXZlbnRIYW5kbGVyU2hvcnRjdXQoJ2NsaWNrJyk7CgkvLyBJZiB5b3Ugd2FudCB0byBtYWtlIGEgY3VzdG9tIHRlbXBsYXRlIGVuZ2luZSwKCS8vCgkvLyBbMV0gSW5oZXJpdCBmcm9tIHRoaXMgY2xhc3MgKGxpa2Uga28ubmF0aXZlVGVtcGxhdGVFbmdpbmUgZG9lcykKCS8vIFsyXSBPdmVycmlkZSAncmVuZGVyVGVtcGxhdGVTb3VyY2UnLCBzdXBwbHlpbmcgYSBmdW5jdGlvbiB3aXRoIHRoaXMgc2lnbmF0dXJlOgoJLy8KCS8vICAgICAgICBmdW5jdGlvbiAodGVtcGxhdGVTb3VyY2UsIGJpbmRpbmdDb250ZXh0LCBvcHRpb25zKSB7CgkvLyAgICAgICAgICAgIC8vIC0gdGVtcGxhdGVTb3VyY2UudGV4dCgpIGlzIHRoZSB0ZXh0IG9mIHRoZSB0ZW1wbGF0ZSB5b3Ugc2hvdWxkIHJlbmRlcgoJLy8gICAgICAgICAgICAvLyAtIGJpbmRpbmdDb250ZXh0LiRkYXRhIGlzIHRoZSBkYXRhIHlvdSBzaG91bGQgcGFzcyBpbnRvIHRoZSB0ZW1wbGF0ZQoJLy8gICAgICAgICAgICAvLyAgIC0geW91IG1pZ2h0IGFsc28gd2FudCB0byBtYWtlIGJpbmRpbmdDb250ZXh0LiRwYXJlbnQsIGJpbmRpbmdDb250ZXh0LiRwYXJlbnRzLAoJLy8gICAgICAgICAgICAvLyAgICAgYW5kIGJpbmRpbmdDb250ZXh0LiRyb290IGF2YWlsYWJsZSBpbiB0aGUgdGVtcGxhdGUgdG9vCgkvLyAgICAgICAgICAgIC8vIC0gb3B0aW9ucyBnaXZlcyB5b3UgYWNjZXNzIHRvIGFueSBvdGhlciBwcm9wZXJ0aWVzIHNldCBvbiAiZGF0YS1iaW5kOiB7IHRlbXBsYXRlOiBvcHRpb25zIH0iCgkvLyAgICAgICAgICAgIC8vCgkvLyAgICAgICAgICAgIC8vIFJldHVybiB2YWx1ZTogYW4gYXJyYXkgb2YgRE9NIG5vZGVzCgkvLyAgICAgICAgfQoJLy8KCS8vIFszXSBPdmVycmlkZSAnY3JlYXRlSmF2YVNjcmlwdEV2YWx1YXRvckJsb2NrJywgc3VwcGx5aW5nIGEgZnVuY3Rpb24gd2l0aCB0aGlzIHNpZ25hdHVyZToKCS8vCgkvLyAgICAgICAgZnVuY3Rpb24gKHNjcmlwdCkgewoJLy8gICAgICAgICAgICAvLyBSZXR1cm4gdmFsdWU6IFdoYXRldmVyIHN5bnRheCBtZWFucyAiRXZhbHVhdGUgdGhlIEphdmFTY3JpcHQgc3RhdGVtZW50ICdzY3JpcHQnIGFuZCBvdXRwdXQgdGhlIHJlc3VsdCIKCS8vICAgICAgICAgICAgLy8gICAgICAgICAgICAgICBGb3IgZXhhbXBsZSwgdGhlIGpxdWVyeS50bXBsIHRlbXBsYXRlIGVuZ2luZSBjb252ZXJ0cyAnc29tZVNjcmlwdCcgdG8gJyR7IHNvbWVTY3JpcHQgfScKCS8vICAgICAgICB9CgkvLwoJLy8gICAgIFRoaXMgaXMgb25seSBuZWNlc3NhcnkgaWYgeW91IHdhbnQgdG8gYWxsb3cgZGF0YS1iaW5kIGF0dHJpYnV0ZXMgdG8gcmVmZXJlbmNlIGFyYml0cmFyeSB0ZW1wbGF0ZSB2YXJpYWJsZXMuCgkvLyAgICAgSWYgeW91IGRvbid0IHdhbnQgdG8gYWxsb3cgdGhhdCwgeW91IGNhbiBzZXQgdGhlIHByb3BlcnR5ICdhbGxvd1RlbXBsYXRlUmV3cml0aW5nJyB0byBmYWxzZSAobGlrZSBrby5uYXRpdmVUZW1wbGF0ZUVuZ2luZSBkb2VzKQoJLy8gICAgIGFuZCB0aGVuIHlvdSBkb24ndCBuZWVkIHRvIG92ZXJyaWRlICdjcmVhdGVKYXZhU2NyaXB0RXZhbHVhdG9yQmxvY2snLgoKCWtvLnRlbXBsYXRlRW5naW5lID0gZnVuY3Rpb24gKCkgeyB9OwoKCWtvLnRlbXBsYXRlRW5naW5lLnByb3RvdHlwZVsncmVuZGVyVGVtcGxhdGVTb3VyY2UnXSA9IGZ1bmN0aW9uICh0ZW1wbGF0ZVNvdXJjZSwgYmluZGluZ0NvbnRleHQsIG9wdGlvbnMpIHsKCSAgICB0aHJvdyBuZXcgRXJyb3IoIk92ZXJyaWRlIHJlbmRlclRlbXBsYXRlU291cmNlIik7Cgl9OwoKCWtvLnRlbXBsYXRlRW5naW5lLnByb3RvdHlwZVsnY3JlYXRlSmF2YVNjcmlwdEV2YWx1YXRvckJsb2NrJ10gPSBmdW5jdGlvbiAoc2NyaXB0KSB7CgkgICAgdGhyb3cgbmV3IEVycm9yKCJPdmVycmlkZSBjcmVhdGVKYXZhU2NyaXB0RXZhbHVhdG9yQmxvY2siKTsKCX07CgoJa28udGVtcGxhdGVFbmdpbmUucHJvdG90eXBlWydtYWtlVGVtcGxhdGVTb3VyY2UnXSA9IGZ1bmN0aW9uKHRlbXBsYXRlLCB0ZW1wbGF0ZURvY3VtZW50KSB7CgkgICAgLy8gTmFtZWQgdGVtcGxhdGUKCSAgICBpZiAodHlwZW9mIHRlbXBsYXRlID09ICJzdHJpbmciKSB7CgkgICAgICAgIHRlbXBsYXRlRG9jdW1lbnQgPSB0ZW1wbGF0ZURvY3VtZW50IHx8IGRvY3VtZW50OwoJICAgICAgICB2YXIgZWxlbSA9IHRlbXBsYXRlRG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQodGVtcGxhdGUpOwoJICAgICAgICBpZiAoIWVsZW0pCgkgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkNhbm5vdCBmaW5kIHRlbXBsYXRlIHdpdGggSUQgIiArIHRlbXBsYXRlKTsKCSAgICAgICAgcmV0dXJuIG5ldyBrby50ZW1wbGF0ZVNvdXJjZXMuZG9tRWxlbWVudChlbGVtKTsKCSAgICB9IGVsc2UgaWYgKCh0ZW1wbGF0ZS5ub2RlVHlwZSA9PSAxKSB8fCAodGVtcGxhdGUubm9kZVR5cGUgPT0gOCkpIHsKCSAgICAgICAgLy8gQW5vbnltb3VzIHRlbXBsYXRlCgkgICAgICAgIHJldHVybiBuZXcga28udGVtcGxhdGVTb3VyY2VzLmFub255bW91c1RlbXBsYXRlKHRlbXBsYXRlKTsKCSAgICB9IGVsc2UKCSAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbmtub3duIHRlbXBsYXRlIHR5cGU6ICIgKyB0ZW1wbGF0ZSk7Cgl9OwoKCWtvLnRlbXBsYXRlRW5naW5lLnByb3RvdHlwZVsncmVuZGVyVGVtcGxhdGUnXSA9IGZ1bmN0aW9uICh0ZW1wbGF0ZSwgYmluZGluZ0NvbnRleHQsIG9wdGlvbnMsIHRlbXBsYXRlRG9jdW1lbnQpIHsKCSAgICB2YXIgdGVtcGxhdGVTb3VyY2UgPSB0aGlzWydtYWtlVGVtcGxhdGVTb3VyY2UnXSh0ZW1wbGF0ZSwgdGVtcGxhdGVEb2N1bWVudCk7CgkgICAgcmV0dXJuIHRoaXNbJ3JlbmRlclRlbXBsYXRlU291cmNlJ10odGVtcGxhdGVTb3VyY2UsIGJpbmRpbmdDb250ZXh0LCBvcHRpb25zKTsKCX07CgoJa28udGVtcGxhdGVFbmdpbmUucHJvdG90eXBlWydpc1RlbXBsYXRlUmV3cml0dGVuJ10gPSBmdW5jdGlvbiAodGVtcGxhdGUsIHRlbXBsYXRlRG9jdW1lbnQpIHsKCSAgICAvLyBTa2lwIHJld3JpdGluZyBpZiByZXF1ZXN0ZWQKCSAgICBpZiAodGhpc1snYWxsb3dUZW1wbGF0ZVJld3JpdGluZyddID09PSBmYWxzZSkKCSAgICAgICAgcmV0dXJuIHRydWU7CgkgICAgcmV0dXJuIHRoaXNbJ21ha2VUZW1wbGF0ZVNvdXJjZSddKHRlbXBsYXRlLCB0ZW1wbGF0ZURvY3VtZW50KVsnZGF0YSddKCJpc1Jld3JpdHRlbiIpOwoJfTsKCglrby50ZW1wbGF0ZUVuZ2luZS5wcm90b3R5cGVbJ3Jld3JpdGVUZW1wbGF0ZSddID0gZnVuY3Rpb24gKHRlbXBsYXRlLCByZXdyaXRlckNhbGxiYWNrLCB0ZW1wbGF0ZURvY3VtZW50KSB7CgkgICAgdmFyIHRlbXBsYXRlU291cmNlID0gdGhpc1snbWFrZVRlbXBsYXRlU291cmNlJ10odGVtcGxhdGUsIHRlbXBsYXRlRG9jdW1lbnQpOwoJICAgIHZhciByZXdyaXR0ZW4gPSByZXdyaXRlckNhbGxiYWNrKHRlbXBsYXRlU291cmNlWyd0ZXh0J10oKSk7CgkgICAgdGVtcGxhdGVTb3VyY2VbJ3RleHQnXShyZXdyaXR0ZW4pOwoJICAgIHRlbXBsYXRlU291cmNlWydkYXRhJ10oImlzUmV3cml0dGVuIiwgdHJ1ZSk7Cgl9OwoKCWtvLmV4cG9ydFN5bWJvbCgndGVtcGxhdGVFbmdpbmUnLCBrby50ZW1wbGF0ZUVuZ2luZSk7CgoJa28udGVtcGxhdGVSZXdyaXRpbmcgPSAoZnVuY3Rpb24gKCkgewoJICAgIHZhciBtZW1vaXplRGF0YUJpbmRpbmdBdHRyaWJ1dGVTeW50YXhSZWdleCA9IC8oPChbYS16XStcZCopKD86XHMrKD8hZGF0YS1iaW5kXHMqPVxzKilbYS16MC05XC1dKyg/Oj0oPzpcIlteXCJdKlwifFwnW15cJ10qXCcpKT8pKlxzKylkYXRhLWJpbmRccyo9XHMqKFsiJ10pKFtcc1xTXSo/KVwzL2dpOwoJICAgIHZhciBtZW1vaXplVmlydHVhbENvbnRhaW5lckJpbmRpbmdTeW50YXhSZWdleCA9IC88IS0tXHMqa29cYlxzKihbXHNcU10qPylccyotLT4vZzsKCgkgICAgZnVuY3Rpb24gdmFsaWRhdGVEYXRhQmluZFZhbHVlc0ZvclJld3JpdGluZyhrZXlWYWx1ZUFycmF5KSB7CgkgICAgICAgIHZhciBhbGxWYWxpZGF0b3JzID0ga28uZXhwcmVzc2lvblJld3JpdGluZy5iaW5kaW5nUmV3cml0ZVZhbGlkYXRvcnM7CgkgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwga2V5VmFsdWVBcnJheS5sZW5ndGg7IGkrKykgewoJICAgICAgICAgICAgdmFyIGtleSA9IGtleVZhbHVlQXJyYXlbaV1bJ2tleSddOwoJICAgICAgICAgICAgaWYgKGFsbFZhbGlkYXRvcnMuaGFzT3duUHJvcGVydHkoa2V5KSkgewoJICAgICAgICAgICAgICAgIHZhciB2YWxpZGF0b3IgPSBhbGxWYWxpZGF0b3JzW2tleV07CgoJICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdmFsaWRhdG9yID09PSAiZnVuY3Rpb24iKSB7CgkgICAgICAgICAgICAgICAgICAgIHZhciBwb3NzaWJsZUVycm9yTWVzc2FnZSA9IHZhbGlkYXRvcihrZXlWYWx1ZUFycmF5W2ldWyd2YWx1ZSddKTsKCSAgICAgICAgICAgICAgICAgICAgaWYgKHBvc3NpYmxlRXJyb3JNZXNzYWdlKQoJICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKHBvc3NpYmxlRXJyb3JNZXNzYWdlKTsKCSAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCF2YWxpZGF0b3IpIHsKCSAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUaGlzIHRlbXBsYXRlIGVuZ2luZSBkb2VzIG5vdCBzdXBwb3J0IHRoZSAnIiArIGtleSArICInIGJpbmRpbmcgd2l0aGluIGl0cyB0ZW1wbGF0ZXMiKTsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICB9CgkgICAgICAgIH0KCSAgICB9CgoJICAgIGZ1bmN0aW9uIGNvbnN0cnVjdE1lbW9pemVkVGFnUmVwbGFjZW1lbnQoZGF0YUJpbmRBdHRyaWJ1dGVWYWx1ZSwgdGFnVG9SZXRhaW4sIG5vZGVOYW1lLCB0ZW1wbGF0ZUVuZ2luZSkgewoJICAgICAgICB2YXIgZGF0YUJpbmRLZXlWYWx1ZUFycmF5ID0ga28uZXhwcmVzc2lvblJld3JpdGluZy5wYXJzZU9iamVjdExpdGVyYWwoZGF0YUJpbmRBdHRyaWJ1dGVWYWx1ZSk7CgkgICAgICAgIHZhbGlkYXRlRGF0YUJpbmRWYWx1ZXNGb3JSZXdyaXRpbmcoZGF0YUJpbmRLZXlWYWx1ZUFycmF5KTsKCSAgICAgICAgdmFyIHJld3JpdHRlbkRhdGFCaW5kQXR0cmlidXRlVmFsdWUgPSBrby5leHByZXNzaW9uUmV3cml0aW5nLnByZVByb2Nlc3NCaW5kaW5ncyhkYXRhQmluZEtleVZhbHVlQXJyYXksIHsndmFsdWVBY2Nlc3NvcnMnOnRydWV9KTsKCgkgICAgICAgIC8vIEZvciBubyBvYnZpb3VzIHJlYXNvbiwgT3BlcmEgZmFpbHMgdG8gZXZhbHVhdGUgcmV3cml0dGVuRGF0YUJpbmRBdHRyaWJ1dGVWYWx1ZSB1bmxlc3MgaXQncyB3cmFwcGVkIGluIGFuIGFkZGl0aW9uYWwKCSAgICAgICAgLy8gYW5vbnltb3VzIGZ1bmN0aW9uLCBldmVuIHRob3VnaCBPcGVyYSdzIGJ1aWx0LWluIGRlYnVnZ2VyIGNhbiBldmFsdWF0ZSBpdCBhbnl3YXkuIE5vIG90aGVyIGJyb3dzZXIgcmVxdWlyZXMgdGhpcwoJICAgICAgICAvLyBleHRyYSBpbmRpcmVjdGlvbi4KCSAgICAgICAgdmFyIGFwcGx5QmluZGluZ3NUb05leHRTaWJsaW5nU2NyaXB0ID0KCSAgICAgICAgICAgICJrby5fX3RyX2FtYnRucyhmdW5jdGlvbigkY29udGV4dCwkZWxlbWVudCl7cmV0dXJuKGZ1bmN0aW9uKCl7cmV0dXJueyAiICsgcmV3cml0dGVuRGF0YUJpbmRBdHRyaWJ1dGVWYWx1ZSArICIgfSB9KSgpfSwnIiArIG5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgKyAiJykiOwoJICAgICAgICByZXR1cm4gdGVtcGxhdGVFbmdpbmVbJ2NyZWF0ZUphdmFTY3JpcHRFdmFsdWF0b3JCbG9jayddKGFwcGx5QmluZGluZ3NUb05leHRTaWJsaW5nU2NyaXB0KSArIHRhZ1RvUmV0YWluOwoJICAgIH0KCgkgICAgcmV0dXJuIHsKCSAgICAgICAgZW5zdXJlVGVtcGxhdGVJc1Jld3JpdHRlbjogZnVuY3Rpb24gKHRlbXBsYXRlLCB0ZW1wbGF0ZUVuZ2luZSwgdGVtcGxhdGVEb2N1bWVudCkgewoJICAgICAgICAgICAgaWYgKCF0ZW1wbGF0ZUVuZ2luZVsnaXNUZW1wbGF0ZVJld3JpdHRlbiddKHRlbXBsYXRlLCB0ZW1wbGF0ZURvY3VtZW50KSkKCSAgICAgICAgICAgICAgICB0ZW1wbGF0ZUVuZ2luZVsncmV3cml0ZVRlbXBsYXRlJ10odGVtcGxhdGUsIGZ1bmN0aW9uIChodG1sU3RyaW5nKSB7CgkgICAgICAgICAgICAgICAgICAgIHJldHVybiBrby50ZW1wbGF0ZVJld3JpdGluZy5tZW1vaXplQmluZGluZ0F0dHJpYnV0ZVN5bnRheChodG1sU3RyaW5nLCB0ZW1wbGF0ZUVuZ2luZSk7CgkgICAgICAgICAgICAgICAgfSwgdGVtcGxhdGVEb2N1bWVudCk7CgkgICAgICAgIH0sCgoJICAgICAgICBtZW1vaXplQmluZGluZ0F0dHJpYnV0ZVN5bnRheDogZnVuY3Rpb24gKGh0bWxTdHJpbmcsIHRlbXBsYXRlRW5naW5lKSB7CgkgICAgICAgICAgICByZXR1cm4gaHRtbFN0cmluZy5yZXBsYWNlKG1lbW9pemVEYXRhQmluZGluZ0F0dHJpYnV0ZVN5bnRheFJlZ2V4LCBmdW5jdGlvbiAoKSB7CgkgICAgICAgICAgICAgICAgcmV0dXJuIGNvbnN0cnVjdE1lbW9pemVkVGFnUmVwbGFjZW1lbnQoLyogZGF0YUJpbmRBdHRyaWJ1dGVWYWx1ZTogKi8gYXJndW1lbnRzWzRdLCAvKiB0YWdUb1JldGFpbjogKi8gYXJndW1lbnRzWzFdLCAvKiBub2RlTmFtZTogKi8gYXJndW1lbnRzWzJdLCB0ZW1wbGF0ZUVuZ2luZSk7CgkgICAgICAgICAgICB9KS5yZXBsYWNlKG1lbW9pemVWaXJ0dWFsQ29udGFpbmVyQmluZGluZ1N5bnRheFJlZ2V4LCBmdW5jdGlvbigpIHsKCSAgICAgICAgICAgICAgICByZXR1cm4gY29uc3RydWN0TWVtb2l6ZWRUYWdSZXBsYWNlbWVudCgvKiBkYXRhQmluZEF0dHJpYnV0ZVZhbHVlOiAqLyBhcmd1bWVudHNbMV0sIC8qIHRhZ1RvUmV0YWluOiAqLyAiPCEtLSBrbyAtLT4iLCAvKiBub2RlTmFtZTogKi8gIiNjb21tZW50IiwgdGVtcGxhdGVFbmdpbmUpOwoJICAgICAgICAgICAgfSk7CgkgICAgICAgIH0sCgoJICAgICAgICBhcHBseU1lbW9pemVkQmluZGluZ3NUb05leHRTaWJsaW5nOiBmdW5jdGlvbiAoYmluZGluZ3MsIG5vZGVOYW1lKSB7CgkgICAgICAgICAgICByZXR1cm4ga28ubWVtb2l6YXRpb24ubWVtb2l6ZShmdW5jdGlvbiAoZG9tTm9kZSwgYmluZGluZ0NvbnRleHQpIHsKCSAgICAgICAgICAgICAgICB2YXIgbm9kZVRvQmluZCA9IGRvbU5vZGUubmV4dFNpYmxpbmc7CgkgICAgICAgICAgICAgICAgaWYgKG5vZGVUb0JpbmQgJiYgbm9kZVRvQmluZC5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpID09PSBub2RlTmFtZSkgewoJICAgICAgICAgICAgICAgICAgICBrby5hcHBseUJpbmRpbmdBY2Nlc3NvcnNUb05vZGUobm9kZVRvQmluZCwgYmluZGluZ3MsIGJpbmRpbmdDb250ZXh0KTsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICB9KTsKCSAgICAgICAgfQoJICAgIH0KCX0pKCk7CgoKCS8vIEV4cG9ydGVkIG9ubHkgYmVjYXVzZSBpdCBoYXMgdG8gYmUgcmVmZXJlbmNlZCBieSBzdHJpbmcgbG9va3VwIGZyb20gd2l0aGluIHJld3JpdHRlbiB0ZW1wbGF0ZQoJa28uZXhwb3J0U3ltYm9sKCdfX3RyX2FtYnRucycsIGtvLnRlbXBsYXRlUmV3cml0aW5nLmFwcGx5TWVtb2l6ZWRCaW5kaW5nc1RvTmV4dFNpYmxpbmcpOwoJKGZ1bmN0aW9uKCkgewoJICAgIC8vIEEgdGVtcGxhdGUgc291cmNlIHJlcHJlc2VudHMgYSByZWFkL3dyaXRlIHdheSBvZiBhY2Nlc3NpbmcgYSB0ZW1wbGF0ZS4gVGhpcyBpcyB0byBlbGltaW5hdGUgdGhlIG5lZWQgZm9yIHRlbXBsYXRlIGxvYWRpbmcvc2F2aW5nCgkgICAgLy8gbG9naWMgdG8gYmUgZHVwbGljYXRlZCBpbiBldmVyeSB0ZW1wbGF0ZSBlbmdpbmUgKGFuZCBtZWFucyB0aGV5IGNhbiBhbGwgd29yayB3aXRoIGFub255bW91cyB0ZW1wbGF0ZXMsIGV0Yy4pCgkgICAgLy8KCSAgICAvLyBUd28gYXJlIHByb3ZpZGVkIGJ5IGRlZmF1bHQ6CgkgICAgLy8gIDEuIGtvLnRlbXBsYXRlU291cmNlcy5kb21FbGVtZW50ICAgICAgIC0gcmVhZHMvd3JpdGVzIHRoZSB0ZXh0IGNvbnRlbnQgb2YgYW4gYXJiaXRyYXJ5IERPTSBlbGVtZW50CgkgICAgLy8gIDIuIGtvLnRlbXBsYXRlU291cmNlcy5hbm9ueW1vdXNFbGVtZW50IC0gdXNlcyBrby51dGlscy5kb21EYXRhIHRvIHJlYWQvd3JpdGUgdGV4dCAqYXNzb2NpYXRlZCogd2l0aCB0aGUgRE9NIGVsZW1lbnQsIGJ1dAoJICAgIC8vICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpdGhvdXQgcmVhZGluZy93cml0aW5nIHRoZSBhY3R1YWwgZWxlbWVudCB0ZXh0IGNvbnRlbnQsIHNpbmNlIGl0IHdpbGwgYmUgb3ZlcndyaXR0ZW4KCSAgICAvLyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aXRoIHRoZSByZW5kZXJlZCB0ZW1wbGF0ZSBvdXRwdXQuCgkgICAgLy8gWW91IGNhbiBpbXBsZW1lbnQgeW91ciBvd24gdGVtcGxhdGUgc291cmNlIGlmIHlvdSB3YW50IHRvIGZldGNoL3N0b3JlIHRlbXBsYXRlcyBzb21ld2hlcmUgb3RoZXIgdGhhbiBpbiBET00gZWxlbWVudHMuCgkgICAgLy8gVGVtcGxhdGUgc291cmNlcyBuZWVkIHRvIGhhdmUgdGhlIGZvbGxvd2luZyBmdW5jdGlvbnM6CgkgICAgLy8gICB0ZXh0KCkgCQkJLSByZXR1cm5zIHRoZSB0ZW1wbGF0ZSB0ZXh0IGZyb20geW91ciBzdG9yYWdlIGxvY2F0aW9uCgkgICAgLy8gICB0ZXh0KHZhbHVlKQkJLSB3cml0ZXMgdGhlIHN1cHBsaWVkIHRlbXBsYXRlIHRleHQgdG8geW91ciBzdG9yYWdlIGxvY2F0aW9uCgkgICAgLy8gICBkYXRhKGtleSkJCQktIHJlYWRzIHZhbHVlcyBzdG9yZWQgdXNpbmcgZGF0YShrZXksIHZhbHVlKSAtIHNlZSBiZWxvdwoJICAgIC8vICAgZGF0YShrZXksIHZhbHVlKQktIGFzc29jaWF0ZXMgInZhbHVlIiB3aXRoIHRoaXMgdGVtcGxhdGUgYW5kIHRoZSBrZXkgImtleSIuIElzIHVzZWQgdG8gc3RvcmUgaW5mb3JtYXRpb24gbGlrZSAiaXNSZXdyaXR0ZW4iLgoJICAgIC8vCgkgICAgLy8gT3B0aW9uYWxseSwgdGVtcGxhdGUgc291cmNlcyBjYW4gYWxzbyBoYXZlIHRoZSBmb2xsb3dpbmcgZnVuY3Rpb25zOgoJICAgIC8vICAgbm9kZXMoKSAgICAgICAgICAgIC0gcmV0dXJucyBhIERPTSBlbGVtZW50IGNvbnRhaW5pbmcgdGhlIG5vZGVzIG9mIHRoaXMgdGVtcGxhdGUsIHdoZXJlIGF2YWlsYWJsZQoJICAgIC8vICAgbm9kZXModmFsdWUpICAgICAgIC0gd3JpdGVzIHRoZSBnaXZlbiBET00gZWxlbWVudCB0byB5b3VyIHN0b3JhZ2UgbG9jYXRpb24KCSAgICAvLyBJZiBhIERPTSBlbGVtZW50IGlzIGF2YWlsYWJsZSBmb3IgYSBnaXZlbiB0ZW1wbGF0ZSBzb3VyY2UsIHRlbXBsYXRlIGVuZ2luZXMgYXJlIGVuY291cmFnZWQgdG8gdXNlIGl0IGluIHByZWZlcmVuY2Ugb3ZlciB0ZXh0KCkKCSAgICAvLyBmb3IgaW1wcm92ZWQgc3BlZWQuIEhvd2V2ZXIsIGFsbCB0ZW1wbGF0ZVNvdXJjZXMgbXVzdCBzdXBwbHkgdGV4dCgpIGV2ZW4gaWYgdGhleSBkb24ndCBzdXBwbHkgbm9kZXMoKS4KCSAgICAvLwoJICAgIC8vIE9uY2UgeW91J3ZlIGltcGxlbWVudGVkIGEgdGVtcGxhdGVTb3VyY2UsIG1ha2UgeW91ciB0ZW1wbGF0ZSBlbmdpbmUgdXNlIGl0IGJ5IHN1YmNsYXNzaW5nIHdoYXRldmVyIHRlbXBsYXRlIGVuZ2luZSB5b3Ugd2VyZQoJICAgIC8vIHVzaW5nIGFuZCBvdmVycmlkaW5nICJtYWtlVGVtcGxhdGVTb3VyY2UiIHRvIHJldHVybiBhbiBpbnN0YW5jZSBvZiB5b3VyIGN1c3RvbSB0ZW1wbGF0ZSBzb3VyY2UuCgoJICAgIGtvLnRlbXBsYXRlU291cmNlcyA9IHt9OwoKCSAgICAvLyAtLS0tIGtvLnRlbXBsYXRlU291cmNlcy5kb21FbGVtZW50IC0tLS0tCgoJICAgIGtvLnRlbXBsYXRlU291cmNlcy5kb21FbGVtZW50ID0gZnVuY3Rpb24oZWxlbWVudCkgewoJICAgICAgICB0aGlzLmRvbUVsZW1lbnQgPSBlbGVtZW50OwoJICAgIH0KCgkgICAga28udGVtcGxhdGVTb3VyY2VzLmRvbUVsZW1lbnQucHJvdG90eXBlWyd0ZXh0J10gPSBmdW5jdGlvbigvKiB2YWx1ZVRvV3JpdGUgKi8pIHsKCSAgICAgICAgdmFyIHRhZ05hbWVMb3dlciA9IGtvLnV0aWxzLnRhZ05hbWVMb3dlcih0aGlzLmRvbUVsZW1lbnQpLAoJICAgICAgICAgICAgZWxlbUNvbnRlbnRzUHJvcGVydHkgPSB0YWdOYW1lTG93ZXIgPT09ICJzY3JpcHQiID8gInRleHQiCgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA6IHRhZ05hbWVMb3dlciA9PT0gInRleHRhcmVhIiA/ICJ2YWx1ZSIKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogImlubmVySFRNTCI7CgoJICAgICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PSAwKSB7CgkgICAgICAgICAgICByZXR1cm4gdGhpcy5kb21FbGVtZW50W2VsZW1Db250ZW50c1Byb3BlcnR5XTsKCSAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgIHZhciB2YWx1ZVRvV3JpdGUgPSBhcmd1bWVudHNbMF07CgkgICAgICAgICAgICBpZiAoZWxlbUNvbnRlbnRzUHJvcGVydHkgPT09ICJpbm5lckhUTUwiKQoJICAgICAgICAgICAgICAgIGtvLnV0aWxzLnNldEh0bWwodGhpcy5kb21FbGVtZW50LCB2YWx1ZVRvV3JpdGUpOwoJICAgICAgICAgICAgZWxzZQoJICAgICAgICAgICAgICAgIHRoaXMuZG9tRWxlbWVudFtlbGVtQ29udGVudHNQcm9wZXJ0eV0gPSB2YWx1ZVRvV3JpdGU7CgkgICAgICAgIH0KCSAgICB9OwoKCSAgICB2YXIgZGF0YURvbURhdGFQcmVmaXggPSBrby51dGlscy5kb21EYXRhLm5leHRLZXkoKSArICJfIjsKCSAgICBrby50ZW1wbGF0ZVNvdXJjZXMuZG9tRWxlbWVudC5wcm90b3R5cGVbJ2RhdGEnXSA9IGZ1bmN0aW9uKGtleSAvKiwgdmFsdWVUb1dyaXRlICovKSB7CgkgICAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAxKSB7CgkgICAgICAgICAgICByZXR1cm4ga28udXRpbHMuZG9tRGF0YS5nZXQodGhpcy5kb21FbGVtZW50LCBkYXRhRG9tRGF0YVByZWZpeCArIGtleSk7CgkgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICBrby51dGlscy5kb21EYXRhLnNldCh0aGlzLmRvbUVsZW1lbnQsIGRhdGFEb21EYXRhUHJlZml4ICsga2V5LCBhcmd1bWVudHNbMV0pOwoJICAgICAgICB9CgkgICAgfTsKCgkgICAgLy8gLS0tLSBrby50ZW1wbGF0ZVNvdXJjZXMuYW5vbnltb3VzVGVtcGxhdGUgLS0tLS0KCSAgICAvLyBBbm9ueW1vdXMgdGVtcGxhdGVzIGFyZSBub3JtYWxseSBzYXZlZC9yZXRyaWV2ZWQgYXMgRE9NIG5vZGVzIHRocm91Z2ggIm5vZGVzIi4KCSAgICAvLyBGb3IgY29tcGF0aWJpbGl0eSwgeW91IGNhbiBhbHNvIHJlYWQgInRleHQiOyBpdCB3aWxsIGJlIHNlcmlhbGl6ZWQgZnJvbSB0aGUgbm9kZXMgb24gZGVtYW5kLgoJICAgIC8vIFdyaXRpbmcgdG8gInRleHQiIGlzIHN0aWxsIHN1cHBvcnRlZCwgYnV0IHRoZW4gdGhlIHRlbXBsYXRlIGRhdGEgd2lsbCBub3QgYmUgYXZhaWxhYmxlIGFzIERPTSBub2Rlcy4KCgkgICAgdmFyIGFub255bW91c1RlbXBsYXRlc0RvbURhdGFLZXkgPSBrby51dGlscy5kb21EYXRhLm5leHRLZXkoKTsKCSAgICBrby50ZW1wbGF0ZVNvdXJjZXMuYW5vbnltb3VzVGVtcGxhdGUgPSBmdW5jdGlvbihlbGVtZW50KSB7CgkgICAgICAgIHRoaXMuZG9tRWxlbWVudCA9IGVsZW1lbnQ7CgkgICAgfQoJICAgIGtvLnRlbXBsYXRlU291cmNlcy5hbm9ueW1vdXNUZW1wbGF0ZS5wcm90b3R5cGUgPSBuZXcga28udGVtcGxhdGVTb3VyY2VzLmRvbUVsZW1lbnQoKTsKCSAgICBrby50ZW1wbGF0ZVNvdXJjZXMuYW5vbnltb3VzVGVtcGxhdGUucHJvdG90eXBlLmNvbnN0cnVjdG9yID0ga28udGVtcGxhdGVTb3VyY2VzLmFub255bW91c1RlbXBsYXRlOwoJICAgIGtvLnRlbXBsYXRlU291cmNlcy5hbm9ueW1vdXNUZW1wbGF0ZS5wcm90b3R5cGVbJ3RleHQnXSA9IGZ1bmN0aW9uKC8qIHZhbHVlVG9Xcml0ZSAqLykgewoJICAgICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PSAwKSB7CgkgICAgICAgICAgICB2YXIgdGVtcGxhdGVEYXRhID0ga28udXRpbHMuZG9tRGF0YS5nZXQodGhpcy5kb21FbGVtZW50LCBhbm9ueW1vdXNUZW1wbGF0ZXNEb21EYXRhS2V5KSB8fCB7fTsKCSAgICAgICAgICAgIGlmICh0ZW1wbGF0ZURhdGEudGV4dERhdGEgPT09IHVuZGVmaW5lZCAmJiB0ZW1wbGF0ZURhdGEuY29udGFpbmVyRGF0YSkKCSAgICAgICAgICAgICAgICB0ZW1wbGF0ZURhdGEudGV4dERhdGEgPSB0ZW1wbGF0ZURhdGEuY29udGFpbmVyRGF0YS5pbm5lckhUTUw7CgkgICAgICAgICAgICByZXR1cm4gdGVtcGxhdGVEYXRhLnRleHREYXRhOwoJICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgdmFyIHZhbHVlVG9Xcml0ZSA9IGFyZ3VtZW50c1swXTsKCSAgICAgICAgICAgIGtvLnV0aWxzLmRvbURhdGEuc2V0KHRoaXMuZG9tRWxlbWVudCwgYW5vbnltb3VzVGVtcGxhdGVzRG9tRGF0YUtleSwge3RleHREYXRhOiB2YWx1ZVRvV3JpdGV9KTsKCSAgICAgICAgfQoJICAgIH07CgkgICAga28udGVtcGxhdGVTb3VyY2VzLmRvbUVsZW1lbnQucHJvdG90eXBlWydub2RlcyddID0gZnVuY3Rpb24oLyogdmFsdWVUb1dyaXRlICovKSB7CgkgICAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09IDApIHsKCSAgICAgICAgICAgIHZhciB0ZW1wbGF0ZURhdGEgPSBrby51dGlscy5kb21EYXRhLmdldCh0aGlzLmRvbUVsZW1lbnQsIGFub255bW91c1RlbXBsYXRlc0RvbURhdGFLZXkpIHx8IHt9OwoJICAgICAgICAgICAgcmV0dXJuIHRlbXBsYXRlRGF0YS5jb250YWluZXJEYXRhOwoJICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgdmFyIHZhbHVlVG9Xcml0ZSA9IGFyZ3VtZW50c1swXTsKCSAgICAgICAgICAgIGtvLnV0aWxzLmRvbURhdGEuc2V0KHRoaXMuZG9tRWxlbWVudCwgYW5vbnltb3VzVGVtcGxhdGVzRG9tRGF0YUtleSwge2NvbnRhaW5lckRhdGE6IHZhbHVlVG9Xcml0ZX0pOwoJICAgICAgICB9CgkgICAgfTsKCgkgICAga28uZXhwb3J0U3ltYm9sKCd0ZW1wbGF0ZVNvdXJjZXMnLCBrby50ZW1wbGF0ZVNvdXJjZXMpOwoJICAgIGtvLmV4cG9ydFN5bWJvbCgndGVtcGxhdGVTb3VyY2VzLmRvbUVsZW1lbnQnLCBrby50ZW1wbGF0ZVNvdXJjZXMuZG9tRWxlbWVudCk7CgkgICAga28uZXhwb3J0U3ltYm9sKCd0ZW1wbGF0ZVNvdXJjZXMuYW5vbnltb3VzVGVtcGxhdGUnLCBrby50ZW1wbGF0ZVNvdXJjZXMuYW5vbnltb3VzVGVtcGxhdGUpOwoJfSkoKTsKCShmdW5jdGlvbiAoKSB7CgkgICAgdmFyIF90ZW1wbGF0ZUVuZ2luZTsKCSAgICBrby5zZXRUZW1wbGF0ZUVuZ2luZSA9IGZ1bmN0aW9uICh0ZW1wbGF0ZUVuZ2luZSkgewoJICAgICAgICBpZiAoKHRlbXBsYXRlRW5naW5lICE9IHVuZGVmaW5lZCkgJiYgISh0ZW1wbGF0ZUVuZ2luZSBpbnN0YW5jZW9mIGtvLnRlbXBsYXRlRW5naW5lKSkKCSAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigidGVtcGxhdGVFbmdpbmUgbXVzdCBpbmhlcml0IGZyb20ga28udGVtcGxhdGVFbmdpbmUiKTsKCSAgICAgICAgX3RlbXBsYXRlRW5naW5lID0gdGVtcGxhdGVFbmdpbmU7CgkgICAgfQoKCSAgICBmdW5jdGlvbiBpbnZva2VGb3JFYWNoTm9kZUluQ29udGludW91c1JhbmdlKGZpcnN0Tm9kZSwgbGFzdE5vZGUsIGFjdGlvbikgewoJICAgICAgICB2YXIgbm9kZSwgbmV4dEluUXVldWUgPSBmaXJzdE5vZGUsIGZpcnN0T3V0T2ZSYW5nZU5vZGUgPSBrby52aXJ0dWFsRWxlbWVudHMubmV4dFNpYmxpbmcobGFzdE5vZGUpOwoJICAgICAgICB3aGlsZSAobmV4dEluUXVldWUgJiYgKChub2RlID0gbmV4dEluUXVldWUpICE9PSBmaXJzdE91dE9mUmFuZ2VOb2RlKSkgewoJICAgICAgICAgICAgbmV4dEluUXVldWUgPSBrby52aXJ0dWFsRWxlbWVudHMubmV4dFNpYmxpbmcobm9kZSk7CgkgICAgICAgICAgICBhY3Rpb24obm9kZSwgbmV4dEluUXVldWUpOwoJICAgICAgICB9CgkgICAgfQoKCSAgICBmdW5jdGlvbiBhY3RpdmF0ZUJpbmRpbmdzT25Db250aW51b3VzTm9kZUFycmF5KGNvbnRpbnVvdXNOb2RlQXJyYXksIGJpbmRpbmdDb250ZXh0KSB7CgkgICAgICAgIC8vIFRvIGJlIHVzZWQgb24gYW55IG5vZGVzIHRoYXQgaGF2ZSBiZWVuIHJlbmRlcmVkIGJ5IGEgdGVtcGxhdGUgYW5kIGhhdmUgYmVlbiBpbnNlcnRlZCBpbnRvIHNvbWUgcGFyZW50IGVsZW1lbnQKCSAgICAgICAgLy8gV2Fsa3MgdGhyb3VnaCBjb250aW51b3VzTm9kZUFycmF5ICh3aGljaCAqbXVzdCogYmUgY29udGludW91cywgaS5lLiwgYW4gdW5pbnRlcnJ1cHRlZCBzZXF1ZW5jZSBvZiBzaWJsaW5nIG5vZGVzLCBiZWNhdXNlCgkgICAgICAgIC8vIHRoZSBhbGdvcml0aG0gZm9yIHdhbGtpbmcgdGhlbSByZWxpZXMgb24gdGhpcyksIGFuZCBmb3IgZWFjaCB0b3AtbGV2ZWwgaXRlbSBpbiB0aGUgdmlydHVhbC1lbGVtZW50IHNlbnNlLAoJICAgICAgICAvLyAoMSkgRG9lcyBhIHJlZ3VsYXIgImFwcGx5QmluZGluZ3MiIHRvIGFzc29jaWF0ZSBiaW5kaW5nQ29udGV4dCB3aXRoIHRoaXMgbm9kZSBhbmQgdG8gYWN0aXZhdGUgYW55IG5vbi1tZW1vaXplZCBiaW5kaW5ncwoJICAgICAgICAvLyAoMikgVW5tZW1vaXplcyBhbnkgbWVtb3MgaW4gdGhlIERPTSBzdWJ0cmVlIChlLmcuLCB0byBhY3RpdmF0ZSBiaW5kaW5ncyB0aGF0IGhhZCBiZWVuIG1lbW9pemVkIGR1cmluZyB0ZW1wbGF0ZSByZXdyaXRpbmcpCgoJICAgICAgICBpZiAoY29udGludW91c05vZGVBcnJheS5sZW5ndGgpIHsKCSAgICAgICAgICAgIHZhciBmaXJzdE5vZGUgPSBjb250aW51b3VzTm9kZUFycmF5WzBdLAoJICAgICAgICAgICAgICAgIGxhc3ROb2RlID0gY29udGludW91c05vZGVBcnJheVtjb250aW51b3VzTm9kZUFycmF5Lmxlbmd0aCAtIDFdLAoJICAgICAgICAgICAgICAgIHBhcmVudE5vZGUgPSBmaXJzdE5vZGUucGFyZW50Tm9kZSwKCSAgICAgICAgICAgICAgICBwcm92aWRlciA9IGtvLmJpbmRpbmdQcm92aWRlclsnaW5zdGFuY2UnXSwKCSAgICAgICAgICAgICAgICBwcmVwcm9jZXNzTm9kZSA9IHByb3ZpZGVyWydwcmVwcm9jZXNzTm9kZSddOwoKCSAgICAgICAgICAgIGlmIChwcmVwcm9jZXNzTm9kZSkgewoJICAgICAgICAgICAgICAgIGludm9rZUZvckVhY2hOb2RlSW5Db250aW51b3VzUmFuZ2UoZmlyc3ROb2RlLCBsYXN0Tm9kZSwgZnVuY3Rpb24obm9kZSwgbmV4dE5vZGVJblJhbmdlKSB7CgkgICAgICAgICAgICAgICAgICAgIHZhciBub2RlUHJldmlvdXNTaWJsaW5nID0gbm9kZS5wcmV2aW91c1NpYmxpbmc7CgkgICAgICAgICAgICAgICAgICAgIHZhciBuZXdOb2RlcyA9IHByZXByb2Nlc3NOb2RlLmNhbGwocHJvdmlkZXIsIG5vZGUpOwoJICAgICAgICAgICAgICAgICAgICBpZiAobmV3Tm9kZXMpIHsKCSAgICAgICAgICAgICAgICAgICAgICAgIGlmIChub2RlID09PSBmaXJzdE5vZGUpCgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlyc3ROb2RlID0gbmV3Tm9kZXNbMF0gfHwgbmV4dE5vZGVJblJhbmdlOwoJICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5vZGUgPT09IGxhc3ROb2RlKQoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhc3ROb2RlID0gbmV3Tm9kZXNbbmV3Tm9kZXMubGVuZ3RoIC0gMV0gfHwgbm9kZVByZXZpb3VzU2libGluZzsKCSAgICAgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgIH0pOwoKCSAgICAgICAgICAgICAgICAvLyBCZWNhdXNlIHByZXByb2Nlc3NOb2RlIGNhbiBjaGFuZ2UgdGhlIG5vZGVzLCBpbmNsdWRpbmcgdGhlIGZpcnN0IGFuZCBsYXN0IG5vZGVzLCB1cGRhdGUgY29udGludW91c05vZGVBcnJheSB0byBtYXRjaC4KCSAgICAgICAgICAgICAgICAvLyBXZSBuZWVkIHRoZSBmdWxsIHNldCwgaW5jbHVkaW5nIGlubmVyIG5vZGVzLCBiZWNhdXNlIHRoZSB1bm1lbW9pemUgc3RlcCBtaWdodCByZW1vdmUgdGhlIGZpcnN0IG5vZGUgKGFuZCBzbyB0aGUgcmVhbAoJICAgICAgICAgICAgICAgIC8vIGZpcnN0IG5vZGUgbmVlZHMgdG8gYmUgaW4gdGhlIGFycmF5KS4KCSAgICAgICAgICAgICAgICBjb250aW51b3VzTm9kZUFycmF5Lmxlbmd0aCA9IDA7CgkgICAgICAgICAgICAgICAgaWYgKCFmaXJzdE5vZGUpIHsgLy8gcHJlcHJvY2Vzc05vZGUgbWlnaHQgaGF2ZSByZW1vdmVkIGFsbCB0aGUgbm9kZXMsIGluIHdoaWNoIGNhc2UgdGhlcmUncyBub3RoaW5nIGxlZnQgdG8gZG8KCSAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICBpZiAoZmlyc3ROb2RlID09PSBsYXN0Tm9kZSkgewoJICAgICAgICAgICAgICAgICAgICBjb250aW51b3VzTm9kZUFycmF5LnB1c2goZmlyc3ROb2RlKTsKCSAgICAgICAgICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgICAgICAgICBjb250aW51b3VzTm9kZUFycmF5LnB1c2goZmlyc3ROb2RlLCBsYXN0Tm9kZSk7CgkgICAgICAgICAgICAgICAgICAgIGtvLnV0aWxzLmZpeFVwQ29udGludW91c05vZGVBcnJheShjb250aW51b3VzTm9kZUFycmF5LCBwYXJlbnROb2RlKTsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICB9CgoJICAgICAgICAgICAgLy8gTmVlZCB0byBhcHBseUJpbmRpbmdzICpiZWZvcmUqIHVubWVtb3ppYXRpb24sIGJlY2F1c2UgdW5tZW1vaXphdGlvbiBtaWdodCBpbnRyb2R1Y2UgZXh0cmEgbm9kZXMgKHRoYXQgd2UgZG9uJ3Qgd2FudCB0byByZS1iaW5kKQoJICAgICAgICAgICAgLy8gd2hlcmVhcyBhIHJlZ3VsYXIgYXBwbHlCaW5kaW5ncyB3b24ndCBpbnRyb2R1Y2UgbmV3IG1lbW9pemVkIG5vZGVzCgkgICAgICAgICAgICBpbnZva2VGb3JFYWNoTm9kZUluQ29udGludW91c1JhbmdlKGZpcnN0Tm9kZSwgbGFzdE5vZGUsIGZ1bmN0aW9uKG5vZGUpIHsKCSAgICAgICAgICAgICAgICBpZiAobm9kZS5ub2RlVHlwZSA9PT0gMSB8fCBub2RlLm5vZGVUeXBlID09PSA4KQoJICAgICAgICAgICAgICAgICAgICBrby5hcHBseUJpbmRpbmdzKGJpbmRpbmdDb250ZXh0LCBub2RlKTsKCSAgICAgICAgICAgIH0pOwoJICAgICAgICAgICAgaW52b2tlRm9yRWFjaE5vZGVJbkNvbnRpbnVvdXNSYW5nZShmaXJzdE5vZGUsIGxhc3ROb2RlLCBmdW5jdGlvbihub2RlKSB7CgkgICAgICAgICAgICAgICAgaWYgKG5vZGUubm9kZVR5cGUgPT09IDEgfHwgbm9kZS5ub2RlVHlwZSA9PT0gOCkKCSAgICAgICAgICAgICAgICAgICAga28ubWVtb2l6YXRpb24udW5tZW1vaXplRG9tTm9kZUFuZERlc2NlbmRhbnRzKG5vZGUsIFtiaW5kaW5nQ29udGV4dF0pOwoJICAgICAgICAgICAgfSk7CgoJICAgICAgICAgICAgLy8gTWFrZSBzdXJlIGFueSBjaGFuZ2VzIGRvbmUgYnkgYXBwbHlCaW5kaW5ncyBvciB1bm1lbW9pemUgYXJlIHJlZmxlY3RlZCBpbiB0aGUgYXJyYXkKCSAgICAgICAgICAgIGtvLnV0aWxzLmZpeFVwQ29udGludW91c05vZGVBcnJheShjb250aW51b3VzTm9kZUFycmF5LCBwYXJlbnROb2RlKTsKCSAgICAgICAgfQoJICAgIH0KCgkgICAgZnVuY3Rpb24gZ2V0Rmlyc3ROb2RlRnJvbVBvc3NpYmxlQXJyYXkobm9kZU9yTm9kZUFycmF5KSB7CgkgICAgICAgIHJldHVybiBub2RlT3JOb2RlQXJyYXkubm9kZVR5cGUgPyBub2RlT3JOb2RlQXJyYXkKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA6IG5vZGVPck5vZGVBcnJheS5sZW5ndGggPiAwID8gbm9kZU9yTm9kZUFycmF5WzBdCgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgOiBudWxsOwoJICAgIH0KCgkgICAgZnVuY3Rpb24gZXhlY3V0ZVRlbXBsYXRlKHRhcmdldE5vZGVPck5vZGVBcnJheSwgcmVuZGVyTW9kZSwgdGVtcGxhdGUsIGJpbmRpbmdDb250ZXh0LCBvcHRpb25zKSB7CgkgICAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoJICAgICAgICB2YXIgZmlyc3RUYXJnZXROb2RlID0gdGFyZ2V0Tm9kZU9yTm9kZUFycmF5ICYmIGdldEZpcnN0Tm9kZUZyb21Qb3NzaWJsZUFycmF5KHRhcmdldE5vZGVPck5vZGVBcnJheSk7CgkgICAgICAgIHZhciB0ZW1wbGF0ZURvY3VtZW50ID0gZmlyc3RUYXJnZXROb2RlICYmIGZpcnN0VGFyZ2V0Tm9kZS5vd25lckRvY3VtZW50OwoJICAgICAgICB2YXIgdGVtcGxhdGVFbmdpbmVUb1VzZSA9IChvcHRpb25zWyd0ZW1wbGF0ZUVuZ2luZSddIHx8IF90ZW1wbGF0ZUVuZ2luZSk7CgkgICAgICAgIGtvLnRlbXBsYXRlUmV3cml0aW5nLmVuc3VyZVRlbXBsYXRlSXNSZXdyaXR0ZW4odGVtcGxhdGUsIHRlbXBsYXRlRW5naW5lVG9Vc2UsIHRlbXBsYXRlRG9jdW1lbnQpOwoJICAgICAgICB2YXIgcmVuZGVyZWROb2Rlc0FycmF5ID0gdGVtcGxhdGVFbmdpbmVUb1VzZVsncmVuZGVyVGVtcGxhdGUnXSh0ZW1wbGF0ZSwgYmluZGluZ0NvbnRleHQsIG9wdGlvbnMsIHRlbXBsYXRlRG9jdW1lbnQpOwoKCSAgICAgICAgLy8gTG9vc2VseSBjaGVjayByZXN1bHQgaXMgYW4gYXJyYXkgb2YgRE9NIG5vZGVzCgkgICAgICAgIGlmICgodHlwZW9mIHJlbmRlcmVkTm9kZXNBcnJheS5sZW5ndGggIT0gIm51bWJlciIpIHx8IChyZW5kZXJlZE5vZGVzQXJyYXkubGVuZ3RoID4gMCAmJiB0eXBlb2YgcmVuZGVyZWROb2Rlc0FycmF5WzBdLm5vZGVUeXBlICE9ICJudW1iZXIiKSkKCSAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVGVtcGxhdGUgZW5naW5lIG11c3QgcmV0dXJuIGFuIGFycmF5IG9mIERPTSBub2RlcyIpOwoKCSAgICAgICAgdmFyIGhhdmVBZGRlZE5vZGVzVG9QYXJlbnQgPSBmYWxzZTsKCSAgICAgICAgc3dpdGNoIChyZW5kZXJNb2RlKSB7CgkgICAgICAgICAgICBjYXNlICJyZXBsYWNlQ2hpbGRyZW4iOgoJICAgICAgICAgICAgICAgIGtvLnZpcnR1YWxFbGVtZW50cy5zZXREb21Ob2RlQ2hpbGRyZW4odGFyZ2V0Tm9kZU9yTm9kZUFycmF5LCByZW5kZXJlZE5vZGVzQXJyYXkpOwoJICAgICAgICAgICAgICAgIGhhdmVBZGRlZE5vZGVzVG9QYXJlbnQgPSB0cnVlOwoJICAgICAgICAgICAgICAgIGJyZWFrOwoJICAgICAgICAgICAgY2FzZSAicmVwbGFjZU5vZGUiOgoJICAgICAgICAgICAgICAgIGtvLnV0aWxzLnJlcGxhY2VEb21Ob2Rlcyh0YXJnZXROb2RlT3JOb2RlQXJyYXksIHJlbmRlcmVkTm9kZXNBcnJheSk7CgkgICAgICAgICAgICAgICAgaGF2ZUFkZGVkTm9kZXNUb1BhcmVudCA9IHRydWU7CgkgICAgICAgICAgICAgICAgYnJlYWs7CgkgICAgICAgICAgICBjYXNlICJpZ25vcmVUYXJnZXROb2RlIjogYnJlYWs7CgkgICAgICAgICAgICBkZWZhdWx0OgoJICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVW5rbm93biByZW5kZXJNb2RlOiAiICsgcmVuZGVyTW9kZSk7CgkgICAgICAgIH0KCgkgICAgICAgIGlmIChoYXZlQWRkZWROb2Rlc1RvUGFyZW50KSB7CgkgICAgICAgICAgICBhY3RpdmF0ZUJpbmRpbmdzT25Db250aW51b3VzTm9kZUFycmF5KHJlbmRlcmVkTm9kZXNBcnJheSwgYmluZGluZ0NvbnRleHQpOwoJICAgICAgICAgICAgaWYgKG9wdGlvbnNbJ2FmdGVyUmVuZGVyJ10pCgkgICAgICAgICAgICAgICAga28uZGVwZW5kZW5jeURldGVjdGlvbi5pZ25vcmUob3B0aW9uc1snYWZ0ZXJSZW5kZXInXSwgbnVsbCwgW3JlbmRlcmVkTm9kZXNBcnJheSwgYmluZGluZ0NvbnRleHRbJyRkYXRhJ11dKTsKCSAgICAgICAgfQoKCSAgICAgICAgcmV0dXJuIHJlbmRlcmVkTm9kZXNBcnJheTsKCSAgICB9CgoJICAgIGZ1bmN0aW9uIHJlc29sdmVUZW1wbGF0ZU5hbWUodGVtcGxhdGUsIGRhdGEsIGNvbnRleHQpIHsKCSAgICAgICAgLy8gVGhlIHRlbXBsYXRlIGNhbiBiZSBzcGVjaWZpZWQgYXM6CgkgICAgICAgIGlmIChrby5pc09ic2VydmFibGUodGVtcGxhdGUpKSB7CgkgICAgICAgICAgICAvLyAxLiBBbiBvYnNlcnZhYmxlLCB3aXRoIHN0cmluZyB2YWx1ZQoJICAgICAgICAgICAgcmV0dXJuIHRlbXBsYXRlKCk7CgkgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHRlbXBsYXRlID09PSAnZnVuY3Rpb24nKSB7CgkgICAgICAgICAgICAvLyAyLiBBIGZ1bmN0aW9uIG9mIChkYXRhLCBjb250ZXh0KSByZXR1cm5pbmcgYSBzdHJpbmcKCSAgICAgICAgICAgIHJldHVybiB0ZW1wbGF0ZShkYXRhLCBjb250ZXh0KTsKCSAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgIC8vIDMuIEEgc3RyaW5nCgkgICAgICAgICAgICByZXR1cm4gdGVtcGxhdGU7CgkgICAgICAgIH0KCSAgICB9CgoJICAgIGtvLnJlbmRlclRlbXBsYXRlID0gZnVuY3Rpb24gKHRlbXBsYXRlLCBkYXRhT3JCaW5kaW5nQ29udGV4dCwgb3B0aW9ucywgdGFyZ2V0Tm9kZU9yTm9kZUFycmF5LCByZW5kZXJNb2RlKSB7CgkgICAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoJICAgICAgICBpZiAoKG9wdGlvbnNbJ3RlbXBsYXRlRW5naW5lJ10gfHwgX3RlbXBsYXRlRW5naW5lKSA9PSB1bmRlZmluZWQpCgkgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlNldCBhIHRlbXBsYXRlIGVuZ2luZSBiZWZvcmUgY2FsbGluZyByZW5kZXJUZW1wbGF0ZSIpOwoJICAgICAgICByZW5kZXJNb2RlID0gcmVuZGVyTW9kZSB8fCAicmVwbGFjZUNoaWxkcmVuIjsKCgkgICAgICAgIGlmICh0YXJnZXROb2RlT3JOb2RlQXJyYXkpIHsKCSAgICAgICAgICAgIHZhciBmaXJzdFRhcmdldE5vZGUgPSBnZXRGaXJzdE5vZGVGcm9tUG9zc2libGVBcnJheSh0YXJnZXROb2RlT3JOb2RlQXJyYXkpOwoKCSAgICAgICAgICAgIHZhciB3aGVuVG9EaXNwb3NlID0gZnVuY3Rpb24gKCkgeyByZXR1cm4gKCFmaXJzdFRhcmdldE5vZGUpIHx8ICFrby51dGlscy5kb21Ob2RlSXNBdHRhY2hlZFRvRG9jdW1lbnQoZmlyc3RUYXJnZXROb2RlKTsgfTsgLy8gUGFzc2l2ZSBkaXNwb3NhbCAob24gbmV4dCBldmFsdWF0aW9uKQoJICAgICAgICAgICAgdmFyIGFjdGl2ZWx5RGlzcG9zZVdoZW5Ob2RlSXNSZW1vdmVkID0gKGZpcnN0VGFyZ2V0Tm9kZSAmJiByZW5kZXJNb2RlID09ICJyZXBsYWNlTm9kZSIpID8gZmlyc3RUYXJnZXROb2RlLnBhcmVudE5vZGUgOiBmaXJzdFRhcmdldE5vZGU7CgoJICAgICAgICAgICAgcmV0dXJuIGtvLmRlcGVuZGVudE9ic2VydmFibGUoIC8vIFNvIHRoZSBET00gaXMgYXV0b21hdGljYWxseSB1cGRhdGVkIHdoZW4gYW55IGRlcGVuZGVuY3kgY2hhbmdlcwoJICAgICAgICAgICAgICAgIGZ1bmN0aW9uICgpIHsKCSAgICAgICAgICAgICAgICAgICAgLy8gRW5zdXJlIHdlJ3ZlIGdvdCBhIHByb3BlciBiaW5kaW5nIGNvbnRleHQgdG8gd29yayB3aXRoCgkgICAgICAgICAgICAgICAgICAgIHZhciBiaW5kaW5nQ29udGV4dCA9IChkYXRhT3JCaW5kaW5nQ29udGV4dCAmJiAoZGF0YU9yQmluZGluZ0NvbnRleHQgaW5zdGFuY2VvZiBrby5iaW5kaW5nQ29udGV4dCkpCgkgICAgICAgICAgICAgICAgICAgICAgICA/IGRhdGFPckJpbmRpbmdDb250ZXh0CgkgICAgICAgICAgICAgICAgICAgICAgICA6IG5ldyBrby5iaW5kaW5nQ29udGV4dChrby51dGlscy51bndyYXBPYnNlcnZhYmxlKGRhdGFPckJpbmRpbmdDb250ZXh0KSk7CgoJICAgICAgICAgICAgICAgICAgICB2YXIgdGVtcGxhdGVOYW1lID0gcmVzb2x2ZVRlbXBsYXRlTmFtZSh0ZW1wbGF0ZSwgYmluZGluZ0NvbnRleHRbJyRkYXRhJ10sIGJpbmRpbmdDb250ZXh0KSwKCSAgICAgICAgICAgICAgICAgICAgICAgIHJlbmRlcmVkTm9kZXNBcnJheSA9IGV4ZWN1dGVUZW1wbGF0ZSh0YXJnZXROb2RlT3JOb2RlQXJyYXksIHJlbmRlck1vZGUsIHRlbXBsYXRlTmFtZSwgYmluZGluZ0NvbnRleHQsIG9wdGlvbnMpOwoKCSAgICAgICAgICAgICAgICAgICAgaWYgKHJlbmRlck1vZGUgPT0gInJlcGxhY2VOb2RlIikgewoJICAgICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0Tm9kZU9yTm9kZUFycmF5ID0gcmVuZGVyZWROb2Rlc0FycmF5OwoJICAgICAgICAgICAgICAgICAgICAgICAgZmlyc3RUYXJnZXROb2RlID0gZ2V0Rmlyc3ROb2RlRnJvbVBvc3NpYmxlQXJyYXkodGFyZ2V0Tm9kZU9yTm9kZUFycmF5KTsKCSAgICAgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgIH0sCgkgICAgICAgICAgICAgICAgbnVsbCwKCSAgICAgICAgICAgICAgICB7IGRpc3Bvc2VXaGVuOiB3aGVuVG9EaXNwb3NlLCBkaXNwb3NlV2hlbk5vZGVJc1JlbW92ZWQ6IGFjdGl2ZWx5RGlzcG9zZVdoZW5Ob2RlSXNSZW1vdmVkIH0KCSAgICAgICAgICAgICk7CgkgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICAvLyBXZSBkb24ndCB5ZXQgaGF2ZSBhIERPTSBub2RlIHRvIGV2YWx1YXRlLCBzbyB1c2UgYSBtZW1vIGFuZCByZW5kZXIgdGhlIHRlbXBsYXRlIGxhdGVyIHdoZW4gdGhlcmUgaXMgYSBET00gbm9kZQoJICAgICAgICAgICAgcmV0dXJuIGtvLm1lbW9pemF0aW9uLm1lbW9pemUoZnVuY3Rpb24gKGRvbU5vZGUpIHsKCSAgICAgICAgICAgICAgICBrby5yZW5kZXJUZW1wbGF0ZSh0ZW1wbGF0ZSwgZGF0YU9yQmluZGluZ0NvbnRleHQsIG9wdGlvbnMsIGRvbU5vZGUsICJyZXBsYWNlTm9kZSIpOwoJICAgICAgICAgICAgfSk7CgkgICAgICAgIH0KCSAgICB9OwoKCSAgICBrby5yZW5kZXJUZW1wbGF0ZUZvckVhY2ggPSBmdW5jdGlvbiAodGVtcGxhdGUsIGFycmF5T3JPYnNlcnZhYmxlQXJyYXksIG9wdGlvbnMsIHRhcmdldE5vZGUsIHBhcmVudEJpbmRpbmdDb250ZXh0KSB7CgkgICAgICAgIC8vIFNpbmNlIHNldERvbU5vZGVDaGlsZHJlbkZyb21BcnJheU1hcHBpbmcgYWx3YXlzIGNhbGxzIGV4ZWN1dGVUZW1wbGF0ZUZvckFycmF5SXRlbSBhbmQgdGhlbgoJICAgICAgICAvLyBhY3RpdmF0ZUJpbmRpbmdzQ2FsbGJhY2sgZm9yIGFkZGVkIGl0ZW1zLCB3ZSBjYW4gc3RvcmUgdGhlIGJpbmRpbmcgY29udGV4dCBpbiB0aGUgZm9ybWVyIHRvIHVzZSBpbiB0aGUgbGF0dGVyLgoJICAgICAgICB2YXIgYXJyYXlJdGVtQ29udGV4dDsKCgkgICAgICAgIC8vIFRoaXMgd2lsbCBiZSBjYWxsZWQgYnkgc2V0RG9tTm9kZUNoaWxkcmVuRnJvbUFycmF5TWFwcGluZyB0byBnZXQgdGhlIG5vZGVzIHRvIGFkZCB0byB0YXJnZXROb2RlCgkgICAgICAgIHZhciBleGVjdXRlVGVtcGxhdGVGb3JBcnJheUl0ZW0gPSBmdW5jdGlvbiAoYXJyYXlWYWx1ZSwgaW5kZXgpIHsKCSAgICAgICAgICAgIC8vIFN1cHBvcnQgc2VsZWN0aW5nIHRlbXBsYXRlIGFzIGEgZnVuY3Rpb24gb2YgdGhlIGRhdGEgYmVpbmcgcmVuZGVyZWQKCSAgICAgICAgICAgIGFycmF5SXRlbUNvbnRleHQgPSBwYXJlbnRCaW5kaW5nQ29udGV4dFsnY3JlYXRlQ2hpbGRDb250ZXh0J10oYXJyYXlWYWx1ZSwgb3B0aW9uc1snYXMnXSwgZnVuY3Rpb24oY29udGV4dCkgewoJICAgICAgICAgICAgICAgIGNvbnRleHRbJyRpbmRleCddID0gaW5kZXg7CgkgICAgICAgICAgICB9KTsKCgkgICAgICAgICAgICB2YXIgdGVtcGxhdGVOYW1lID0gcmVzb2x2ZVRlbXBsYXRlTmFtZSh0ZW1wbGF0ZSwgYXJyYXlWYWx1ZSwgYXJyYXlJdGVtQ29udGV4dCk7CgkgICAgICAgICAgICByZXR1cm4gZXhlY3V0ZVRlbXBsYXRlKG51bGwsICJpZ25vcmVUYXJnZXROb2RlIiwgdGVtcGxhdGVOYW1lLCBhcnJheUl0ZW1Db250ZXh0LCBvcHRpb25zKTsKCSAgICAgICAgfQoKCSAgICAgICAgLy8gVGhpcyB3aWxsIGJlIGNhbGxlZCB3aGVuZXZlciBzZXREb21Ob2RlQ2hpbGRyZW5Gcm9tQXJyYXlNYXBwaW5nIGhhcyBhZGRlZCBub2RlcyB0byB0YXJnZXROb2RlCgkgICAgICAgIHZhciBhY3RpdmF0ZUJpbmRpbmdzQ2FsbGJhY2sgPSBmdW5jdGlvbihhcnJheVZhbHVlLCBhZGRlZE5vZGVzQXJyYXksIGluZGV4KSB7CgkgICAgICAgICAgICBhY3RpdmF0ZUJpbmRpbmdzT25Db250aW51b3VzTm9kZUFycmF5KGFkZGVkTm9kZXNBcnJheSwgYXJyYXlJdGVtQ29udGV4dCk7CgkgICAgICAgICAgICBpZiAob3B0aW9uc1snYWZ0ZXJSZW5kZXInXSkKCSAgICAgICAgICAgICAgICBvcHRpb25zWydhZnRlclJlbmRlciddKGFkZGVkTm9kZXNBcnJheSwgYXJyYXlWYWx1ZSk7CgkgICAgICAgIH07CgoJICAgICAgICByZXR1cm4ga28uZGVwZW5kZW50T2JzZXJ2YWJsZShmdW5jdGlvbiAoKSB7CgkgICAgICAgICAgICB2YXIgdW53cmFwcGVkQXJyYXkgPSBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKGFycmF5T3JPYnNlcnZhYmxlQXJyYXkpIHx8IFtdOwoJICAgICAgICAgICAgaWYgKHR5cGVvZiB1bndyYXBwZWRBcnJheS5sZW5ndGggPT0gInVuZGVmaW5lZCIpIC8vIENvZXJjZSBzaW5nbGUgdmFsdWUgaW50byBhcnJheQoJICAgICAgICAgICAgICAgIHVud3JhcHBlZEFycmF5ID0gW3Vud3JhcHBlZEFycmF5XTsKCgkgICAgICAgICAgICAvLyBGaWx0ZXIgb3V0IGFueSBlbnRyaWVzIG1hcmtlZCBhcyBkZXN0cm95ZWQKCSAgICAgICAgICAgIHZhciBmaWx0ZXJlZEFycmF5ID0ga28udXRpbHMuYXJyYXlGaWx0ZXIodW53cmFwcGVkQXJyYXksIGZ1bmN0aW9uKGl0ZW0pIHsKCSAgICAgICAgICAgICAgICByZXR1cm4gb3B0aW9uc1snaW5jbHVkZURlc3Ryb3llZCddIHx8IGl0ZW0gPT09IHVuZGVmaW5lZCB8fCBpdGVtID09PSBudWxsIHx8ICFrby51dGlscy51bndyYXBPYnNlcnZhYmxlKGl0ZW1bJ19kZXN0cm95J10pOwoJICAgICAgICAgICAgfSk7CgoJICAgICAgICAgICAgLy8gQ2FsbCBzZXREb21Ob2RlQ2hpbGRyZW5Gcm9tQXJyYXlNYXBwaW5nLCBpZ25vcmluZyBhbnkgb2JzZXJ2YWJsZXMgdW53cmFwcGVkIHdpdGhpbiAobW9zdCBsaWtlbHkgZnJvbSBhIGNhbGxiYWNrIGZ1bmN0aW9uKS4KCSAgICAgICAgICAgIC8vIElmIHRoZSBhcnJheSBpdGVtcyBhcmUgb2JzZXJ2YWJsZXMsIHRob3VnaCwgdGhleSB3aWxsIGJlIHVud3JhcHBlZCBpbiBleGVjdXRlVGVtcGxhdGVGb3JBcnJheUl0ZW0gYW5kIG1hbmFnZWQgd2l0aGluIHNldERvbU5vZGVDaGlsZHJlbkZyb21BcnJheU1hcHBpbmcuCgkgICAgICAgICAgICBrby5kZXBlbmRlbmN5RGV0ZWN0aW9uLmlnbm9yZShrby51dGlscy5zZXREb21Ob2RlQ2hpbGRyZW5Gcm9tQXJyYXlNYXBwaW5nLCBudWxsLCBbdGFyZ2V0Tm9kZSwgZmlsdGVyZWRBcnJheSwgZXhlY3V0ZVRlbXBsYXRlRm9yQXJyYXlJdGVtLCBvcHRpb25zLCBhY3RpdmF0ZUJpbmRpbmdzQ2FsbGJhY2tdKTsKCgkgICAgICAgIH0sIG51bGwsIHsgZGlzcG9zZVdoZW5Ob2RlSXNSZW1vdmVkOiB0YXJnZXROb2RlIH0pOwoJICAgIH07CgoJICAgIHZhciB0ZW1wbGF0ZUNvbXB1dGVkRG9tRGF0YUtleSA9IGtvLnV0aWxzLmRvbURhdGEubmV4dEtleSgpOwoJICAgIGZ1bmN0aW9uIGRpc3Bvc2VPbGRDb21wdXRlZEFuZFN0b3JlTmV3T25lKGVsZW1lbnQsIG5ld0NvbXB1dGVkKSB7CgkgICAgICAgIHZhciBvbGRDb21wdXRlZCA9IGtvLnV0aWxzLmRvbURhdGEuZ2V0KGVsZW1lbnQsIHRlbXBsYXRlQ29tcHV0ZWREb21EYXRhS2V5KTsKCSAgICAgICAgaWYgKG9sZENvbXB1dGVkICYmICh0eXBlb2Yob2xkQ29tcHV0ZWQuZGlzcG9zZSkgPT0gJ2Z1bmN0aW9uJykpCgkgICAgICAgICAgICBvbGRDb21wdXRlZC5kaXNwb3NlKCk7CgkgICAgICAgIGtvLnV0aWxzLmRvbURhdGEuc2V0KGVsZW1lbnQsIHRlbXBsYXRlQ29tcHV0ZWREb21EYXRhS2V5LCAobmV3Q29tcHV0ZWQgJiYgbmV3Q29tcHV0ZWQuaXNBY3RpdmUoKSkgPyBuZXdDb21wdXRlZCA6IHVuZGVmaW5lZCk7CgkgICAgfQoKCSAgICBrby5iaW5kaW5nSGFuZGxlcnNbJ3RlbXBsYXRlJ10gPSB7CgkgICAgICAgICdpbml0JzogZnVuY3Rpb24oZWxlbWVudCwgdmFsdWVBY2Nlc3NvcikgewoJICAgICAgICAgICAgLy8gU3VwcG9ydCBhbm9ueW1vdXMgdGVtcGxhdGVzCgkgICAgICAgICAgICB2YXIgYmluZGluZ1ZhbHVlID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZSh2YWx1ZUFjY2Vzc29yKCkpOwoJICAgICAgICAgICAgaWYgKHR5cGVvZiBiaW5kaW5nVmFsdWUgPT0gInN0cmluZyIgfHwgYmluZGluZ1ZhbHVlWyduYW1lJ10pIHsKCSAgICAgICAgICAgICAgICAvLyBJdCdzIGEgbmFtZWQgdGVtcGxhdGUgLSBjbGVhciB0aGUgZWxlbWVudAoJICAgICAgICAgICAgICAgIGtvLnZpcnR1YWxFbGVtZW50cy5lbXB0eU5vZGUoZWxlbWVudCk7CgkgICAgICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgICAgIC8vIEl0J3MgYW4gYW5vbnltb3VzIHRlbXBsYXRlIC0gc3RvcmUgdGhlIGVsZW1lbnQgY29udGVudHMsIHRoZW4gY2xlYXIgdGhlIGVsZW1lbnQKCSAgICAgICAgICAgICAgICB2YXIgdGVtcGxhdGVOb2RlcyA9IGtvLnZpcnR1YWxFbGVtZW50cy5jaGlsZE5vZGVzKGVsZW1lbnQpLAoJICAgICAgICAgICAgICAgICAgICBjb250YWluZXIgPSBrby51dGlscy5tb3ZlQ2xlYW5lZE5vZGVzVG9Db250YWluZXJFbGVtZW50KHRlbXBsYXRlTm9kZXMpOyAvLyBUaGlzIGFsc28gcmVtb3ZlcyB0aGUgbm9kZXMgZnJvbSB0aGVpciBjdXJyZW50IHBhcmVudAoJICAgICAgICAgICAgICAgIG5ldyBrby50ZW1wbGF0ZVNvdXJjZXMuYW5vbnltb3VzVGVtcGxhdGUoZWxlbWVudClbJ25vZGVzJ10oY29udGFpbmVyKTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIHJldHVybiB7ICdjb250cm9sc0Rlc2NlbmRhbnRCaW5kaW5ncyc6IHRydWUgfTsKCSAgICAgICAgfSwKCSAgICAgICAgJ3VwZGF0ZSc6IGZ1bmN0aW9uIChlbGVtZW50LCB2YWx1ZUFjY2Vzc29yLCBhbGxCaW5kaW5ncywgdmlld01vZGVsLCBiaW5kaW5nQ29udGV4dCkgewoJICAgICAgICAgICAgdmFyIHZhbHVlID0gdmFsdWVBY2Nlc3NvcigpLAoJICAgICAgICAgICAgICAgIGRhdGFWYWx1ZSwKCSAgICAgICAgICAgICAgICBvcHRpb25zID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZSh2YWx1ZSksCgkgICAgICAgICAgICAgICAgc2hvdWxkRGlzcGxheSA9IHRydWUsCgkgICAgICAgICAgICAgICAgdGVtcGxhdGVDb21wdXRlZCA9IG51bGwsCgkgICAgICAgICAgICAgICAgdGVtcGxhdGVOYW1lOwoKCSAgICAgICAgICAgIGlmICh0eXBlb2Ygb3B0aW9ucyA9PSAic3RyaW5nIikgewoJICAgICAgICAgICAgICAgIHRlbXBsYXRlTmFtZSA9IHZhbHVlOwoJICAgICAgICAgICAgICAgIG9wdGlvbnMgPSB7fTsKCSAgICAgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICAgICAgdGVtcGxhdGVOYW1lID0gb3B0aW9uc1snbmFtZSddOwoKCSAgICAgICAgICAgICAgICAvLyBTdXBwb3J0ICJpZiIvImlmbm90IiBjb25kaXRpb25zCgkgICAgICAgICAgICAgICAgaWYgKCdpZicgaW4gb3B0aW9ucykKCSAgICAgICAgICAgICAgICAgICAgc2hvdWxkRGlzcGxheSA9IGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUob3B0aW9uc1snaWYnXSk7CgkgICAgICAgICAgICAgICAgaWYgKHNob3VsZERpc3BsYXkgJiYgJ2lmbm90JyBpbiBvcHRpb25zKQoJICAgICAgICAgICAgICAgICAgICBzaG91bGREaXNwbGF5ID0gIWtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUob3B0aW9uc1snaWZub3QnXSk7CgoJICAgICAgICAgICAgICAgIGRhdGFWYWx1ZSA9IGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUob3B0aW9uc1snZGF0YSddKTsKCSAgICAgICAgICAgIH0KCgkgICAgICAgICAgICBpZiAoJ2ZvcmVhY2gnIGluIG9wdGlvbnMpIHsKCSAgICAgICAgICAgICAgICAvLyBSZW5kZXIgb25jZSBmb3IgZWFjaCBkYXRhIHBvaW50ICh0cmVhdGluZyBkYXRhIHNldCBhcyBlbXB0eSBpZiBzaG91bGREaXNwbGF5PT1mYWxzZSkKCSAgICAgICAgICAgICAgICB2YXIgZGF0YUFycmF5ID0gKHNob3VsZERpc3BsYXkgJiYgb3B0aW9uc1snZm9yZWFjaCddKSB8fCBbXTsKCSAgICAgICAgICAgICAgICB0ZW1wbGF0ZUNvbXB1dGVkID0ga28ucmVuZGVyVGVtcGxhdGVGb3JFYWNoKHRlbXBsYXRlTmFtZSB8fCBlbGVtZW50LCBkYXRhQXJyYXksIG9wdGlvbnMsIGVsZW1lbnQsIGJpbmRpbmdDb250ZXh0KTsKCSAgICAgICAgICAgIH0gZWxzZSBpZiAoIXNob3VsZERpc3BsYXkpIHsKCSAgICAgICAgICAgICAgICBrby52aXJ0dWFsRWxlbWVudHMuZW1wdHlOb2RlKGVsZW1lbnQpOwoJICAgICAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgICAgICAvLyBSZW5kZXIgb25jZSBmb3IgdGhpcyBzaW5nbGUgZGF0YSBwb2ludCAob3IgdXNlIHRoZSB2aWV3TW9kZWwgaWYgbm8gZGF0YSB3YXMgcHJvdmlkZWQpCgkgICAgICAgICAgICAgICAgdmFyIGlubmVyQmluZGluZ0NvbnRleHQgPSAoJ2RhdGEnIGluIG9wdGlvbnMpID8KCSAgICAgICAgICAgICAgICAgICAgYmluZGluZ0NvbnRleHRbJ2NyZWF0ZUNoaWxkQ29udGV4dCddKGRhdGFWYWx1ZSwgb3B0aW9uc1snYXMnXSkgOiAgLy8gR2l2ZW4gYW4gZXhwbGl0aXQgJ2RhdGEnIHZhbHVlLCB3ZSBjcmVhdGUgYSBjaGlsZCBiaW5kaW5nIGNvbnRleHQgZm9yIGl0CgkgICAgICAgICAgICAgICAgICAgIGJpbmRpbmdDb250ZXh0OyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gR2l2ZW4gbm8gZXhwbGljaXQgJ2RhdGEnIHZhbHVlLCB3ZSByZXRhaW4gdGhlIHNhbWUgYmluZGluZyBjb250ZXh0CgkgICAgICAgICAgICAgICAgdGVtcGxhdGVDb21wdXRlZCA9IGtvLnJlbmRlclRlbXBsYXRlKHRlbXBsYXRlTmFtZSB8fCBlbGVtZW50LCBpbm5lckJpbmRpbmdDb250ZXh0LCBvcHRpb25zLCBlbGVtZW50KTsKCSAgICAgICAgICAgIH0KCgkgICAgICAgICAgICAvLyBJdCBvbmx5IG1ha2VzIHNlbnNlIHRvIGhhdmUgYSBzaW5nbGUgdGVtcGxhdGUgY29tcHV0ZWQgcGVyIGVsZW1lbnQgKG90aGVyd2lzZSB3aGljaCBvbmUgc2hvdWxkIGhhdmUgaXRzIG91dHB1dCBkaXNwbGF5ZWQ/KQoJICAgICAgICAgICAgZGlzcG9zZU9sZENvbXB1dGVkQW5kU3RvcmVOZXdPbmUoZWxlbWVudCwgdGVtcGxhdGVDb21wdXRlZCk7CgkgICAgICAgIH0KCSAgICB9OwoKCSAgICAvLyBBbm9ueW1vdXMgdGVtcGxhdGVzIGNhbid0IGJlIHJld3JpdHRlbi4gR2l2ZSBhIG5pY2UgZXJyb3IgbWVzc2FnZSBpZiB5b3UgdHJ5IHRvIGRvIGl0LgoJICAgIGtvLmV4cHJlc3Npb25SZXdyaXRpbmcuYmluZGluZ1Jld3JpdGVWYWxpZGF0b3JzWyd0ZW1wbGF0ZSddID0gZnVuY3Rpb24oYmluZGluZ1ZhbHVlKSB7CgkgICAgICAgIHZhciBwYXJzZWRCaW5kaW5nVmFsdWUgPSBrby5leHByZXNzaW9uUmV3cml0aW5nLnBhcnNlT2JqZWN0TGl0ZXJhbChiaW5kaW5nVmFsdWUpOwoKCSAgICAgICAgaWYgKChwYXJzZWRCaW5kaW5nVmFsdWUubGVuZ3RoID09IDEpICYmIHBhcnNlZEJpbmRpbmdWYWx1ZVswXVsndW5rbm93biddKQoJICAgICAgICAgICAgcmV0dXJuIG51bGw7IC8vIEl0IGxvb2tzIGxpa2UgYSBzdHJpbmcgbGl0ZXJhbCwgbm90IGFuIG9iamVjdCBsaXRlcmFsLCBzbyB0cmVhdCBpdCBhcyBhIG5hbWVkIHRlbXBsYXRlICh3aGljaCBpcyBhbGxvd2VkIGZvciByZXdyaXRpbmcpCgoJICAgICAgICBpZiAoa28uZXhwcmVzc2lvblJld3JpdGluZy5rZXlWYWx1ZUFycmF5Q29udGFpbnNLZXkocGFyc2VkQmluZGluZ1ZhbHVlLCAibmFtZSIpKQoJICAgICAgICAgICAgcmV0dXJuIG51bGw7IC8vIE5hbWVkIHRlbXBsYXRlcyBjYW4gYmUgcmV3cml0dGVuLCBzbyByZXR1cm4gIm5vIGVycm9yIgoJICAgICAgICByZXR1cm4gIlRoaXMgdGVtcGxhdGUgZW5naW5lIGRvZXMgbm90IHN1cHBvcnQgYW5vbnltb3VzIHRlbXBsYXRlcyBuZXN0ZWQgd2l0aGluIGl0cyB0ZW1wbGF0ZXMiOwoJICAgIH07CgoJICAgIGtvLnZpcnR1YWxFbGVtZW50cy5hbGxvd2VkQmluZGluZ3NbJ3RlbXBsYXRlJ10gPSB0cnVlOwoJfSkoKTsKCglrby5leHBvcnRTeW1ib2woJ3NldFRlbXBsYXRlRW5naW5lJywga28uc2V0VGVtcGxhdGVFbmdpbmUpOwoJa28uZXhwb3J0U3ltYm9sKCdyZW5kZXJUZW1wbGF0ZScsIGtvLnJlbmRlclRlbXBsYXRlKTsKCS8vIEdvIHRocm91Z2ggdGhlIGl0ZW1zIHRoYXQgaGF2ZSBiZWVuIGFkZGVkIGFuZCBkZWxldGVkIGFuZCB0cnkgdG8gZmluZCBtYXRjaGVzIGJldHdlZW4gdGhlbS4KCWtvLnV0aWxzLmZpbmRNb3Zlc0luQXJyYXlDb21wYXJpc29uID0gZnVuY3Rpb24gKGxlZnQsIHJpZ2h0LCBsaW1pdEZhaWxlZENvbXBhcmVzKSB7CgkgICAgaWYgKGxlZnQubGVuZ3RoICYmIHJpZ2h0Lmxlbmd0aCkgewoJICAgICAgICB2YXIgZmFpbGVkQ29tcGFyZXMsIGwsIHIsIGxlZnRJdGVtLCByaWdodEl0ZW07CgkgICAgICAgIGZvciAoZmFpbGVkQ29tcGFyZXMgPSBsID0gMDsgKCFsaW1pdEZhaWxlZENvbXBhcmVzIHx8IGZhaWxlZENvbXBhcmVzIDwgbGltaXRGYWlsZWRDb21wYXJlcykgJiYgKGxlZnRJdGVtID0gbGVmdFtsXSk7ICsrbCkgewoJICAgICAgICAgICAgZm9yIChyID0gMDsgcmlnaHRJdGVtID0gcmlnaHRbcl07ICsrcikgewoJICAgICAgICAgICAgICAgIGlmIChsZWZ0SXRlbVsndmFsdWUnXSA9PT0gcmlnaHRJdGVtWyd2YWx1ZSddKSB7CgkgICAgICAgICAgICAgICAgICAgIGxlZnRJdGVtWydtb3ZlZCddID0gcmlnaHRJdGVtWydpbmRleCddOwoJICAgICAgICAgICAgICAgICAgICByaWdodEl0ZW1bJ21vdmVkJ10gPSBsZWZ0SXRlbVsnaW5kZXgnXTsKCSAgICAgICAgICAgICAgICAgICAgcmlnaHQuc3BsaWNlKHIsIDEpOyAgICAgICAgIC8vIFRoaXMgaXRlbSBpcyBtYXJrZWQgYXMgbW92ZWQ7IHNvIHJlbW92ZSBpdCBmcm9tIHJpZ2h0IGxpc3QKCSAgICAgICAgICAgICAgICAgICAgZmFpbGVkQ29tcGFyZXMgPSByID0gMDsgICAgIC8vIFJlc2V0IGZhaWxlZCBjb21wYXJlcyBjb3VudCBiZWNhdXNlIHdlJ3JlIGNoZWNraW5nIGZvciBjb25zZWN1dGl2ZSBmYWlsdXJlcwoJICAgICAgICAgICAgICAgICAgICBicmVhazsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICBmYWlsZWRDb21wYXJlcyArPSByOwoJICAgICAgICB9CgkgICAgfQoJfTsKCglrby51dGlscy5jb21wYXJlQXJyYXlzID0gKGZ1bmN0aW9uICgpIHsKCSAgICB2YXIgc3RhdHVzTm90SW5PbGQgPSAnYWRkZWQnLCBzdGF0dXNOb3RJbk5ldyA9ICdkZWxldGVkJzsKCgkgICAgLy8gU2ltcGxlIGNhbGN1bGF0aW9uIGJhc2VkIG9uIExldmVuc2h0ZWluIGRpc3RhbmNlLgoJICAgIGZ1bmN0aW9uIGNvbXBhcmVBcnJheXMob2xkQXJyYXksIG5ld0FycmF5LCBvcHRpb25zKSB7CgkgICAgICAgIC8vIEZvciBiYWNrd2FyZCBjb21wYXRpYmlsaXR5LCBpZiB0aGUgdGhpcmQgYXJnIGlzIGFjdHVhbGx5IGEgYm9vbCwgaW50ZXJwcmV0CgkgICAgICAgIC8vIGl0IGFzIHRoZSBvbGQgcGFyYW1ldGVyICdkb250TGltaXRNb3ZlcycuIE5ld2VyIGNvZGUgc2hvdWxkIHVzZSB7IGRvbnRMaW1pdE1vdmVzOiB0cnVlIH0uCgkgICAgICAgIG9wdGlvbnMgPSAodHlwZW9mIG9wdGlvbnMgPT09ICdib29sZWFuJykgPyB7ICdkb250TGltaXRNb3Zlcyc6IG9wdGlvbnMgfSA6IChvcHRpb25zIHx8IHt9KTsKCSAgICAgICAgb2xkQXJyYXkgPSBvbGRBcnJheSB8fCBbXTsKCSAgICAgICAgbmV3QXJyYXkgPSBuZXdBcnJheSB8fCBbXTsKCgkgICAgICAgIGlmIChvbGRBcnJheS5sZW5ndGggPD0gbmV3QXJyYXkubGVuZ3RoKQoJICAgICAgICAgICAgcmV0dXJuIGNvbXBhcmVTbWFsbEFycmF5VG9CaWdBcnJheShvbGRBcnJheSwgbmV3QXJyYXksIHN0YXR1c05vdEluT2xkLCBzdGF0dXNOb3RJbk5ldywgb3B0aW9ucyk7CgkgICAgICAgIGVsc2UKCSAgICAgICAgICAgIHJldHVybiBjb21wYXJlU21hbGxBcnJheVRvQmlnQXJyYXkobmV3QXJyYXksIG9sZEFycmF5LCBzdGF0dXNOb3RJbk5ldywgc3RhdHVzTm90SW5PbGQsIG9wdGlvbnMpOwoJICAgIH0KCgkgICAgZnVuY3Rpb24gY29tcGFyZVNtYWxsQXJyYXlUb0JpZ0FycmF5KHNtbEFycmF5LCBiaWdBcnJheSwgc3RhdHVzTm90SW5TbWwsIHN0YXR1c05vdEluQmlnLCBvcHRpb25zKSB7CgkgICAgICAgIHZhciBteU1pbiA9IE1hdGgubWluLAoJICAgICAgICAgICAgbXlNYXggPSBNYXRoLm1heCwKCSAgICAgICAgICAgIGVkaXREaXN0YW5jZU1hdHJpeCA9IFtdLAoJICAgICAgICAgICAgc21sSW5kZXgsIHNtbEluZGV4TWF4ID0gc21sQXJyYXkubGVuZ3RoLAoJICAgICAgICAgICAgYmlnSW5kZXgsIGJpZ0luZGV4TWF4ID0gYmlnQXJyYXkubGVuZ3RoLAoJICAgICAgICAgICAgY29tcGFyZVJhbmdlID0gKGJpZ0luZGV4TWF4IC0gc21sSW5kZXhNYXgpIHx8IDEsCgkgICAgICAgICAgICBtYXhEaXN0YW5jZSA9IHNtbEluZGV4TWF4ICsgYmlnSW5kZXhNYXggKyAxLAoJICAgICAgICAgICAgdGhpc1JvdywgbGFzdFJvdywKCSAgICAgICAgICAgIGJpZ0luZGV4TWF4Rm9yUm93LCBiaWdJbmRleE1pbkZvclJvdzsKCgkgICAgICAgIGZvciAoc21sSW5kZXggPSAwOyBzbWxJbmRleCA8PSBzbWxJbmRleE1heDsgc21sSW5kZXgrKykgewoJICAgICAgICAgICAgbGFzdFJvdyA9IHRoaXNSb3c7CgkgICAgICAgICAgICBlZGl0RGlzdGFuY2VNYXRyaXgucHVzaCh0aGlzUm93ID0gW10pOwoJICAgICAgICAgICAgYmlnSW5kZXhNYXhGb3JSb3cgPSBteU1pbihiaWdJbmRleE1heCwgc21sSW5kZXggKyBjb21wYXJlUmFuZ2UpOwoJICAgICAgICAgICAgYmlnSW5kZXhNaW5Gb3JSb3cgPSBteU1heCgwLCBzbWxJbmRleCAtIDEpOwoJICAgICAgICAgICAgZm9yIChiaWdJbmRleCA9IGJpZ0luZGV4TWluRm9yUm93OyBiaWdJbmRleCA8PSBiaWdJbmRleE1heEZvclJvdzsgYmlnSW5kZXgrKykgewoJICAgICAgICAgICAgICAgIGlmICghYmlnSW5kZXgpCgkgICAgICAgICAgICAgICAgICAgIHRoaXNSb3dbYmlnSW5kZXhdID0gc21sSW5kZXggKyAxOwoJICAgICAgICAgICAgICAgIGVsc2UgaWYgKCFzbWxJbmRleCkgIC8vIFRvcCByb3cgLSB0cmFuc2Zvcm0gZW1wdHkgYXJyYXkgaW50byBuZXcgYXJyYXkgdmlhIGFkZGl0aW9ucwoJICAgICAgICAgICAgICAgICAgICB0aGlzUm93W2JpZ0luZGV4XSA9IGJpZ0luZGV4ICsgMTsKCSAgICAgICAgICAgICAgICBlbHNlIGlmIChzbWxBcnJheVtzbWxJbmRleCAtIDFdID09PSBiaWdBcnJheVtiaWdJbmRleCAtIDFdKQoJICAgICAgICAgICAgICAgICAgICB0aGlzUm93W2JpZ0luZGV4XSA9IGxhc3RSb3dbYmlnSW5kZXggLSAxXTsgICAgICAgICAgICAgICAgICAvLyBjb3B5IHZhbHVlIChubyBlZGl0KQoJICAgICAgICAgICAgICAgIGVsc2UgewoJICAgICAgICAgICAgICAgICAgICB2YXIgbm9ydGhEaXN0YW5jZSA9IGxhc3RSb3dbYmlnSW5kZXhdIHx8IG1heERpc3RhbmNlOyAgICAgICAvLyBub3QgaW4gYmlnIChkZWxldGlvbikKCSAgICAgICAgICAgICAgICAgICAgdmFyIHdlc3REaXN0YW5jZSA9IHRoaXNSb3dbYmlnSW5kZXggLSAxXSB8fCBtYXhEaXN0YW5jZTsgICAgLy8gbm90IGluIHNtYWxsIChhZGRpdGlvbikKCSAgICAgICAgICAgICAgICAgICAgdGhpc1Jvd1tiaWdJbmRleF0gPSBteU1pbihub3J0aERpc3RhbmNlLCB3ZXN0RGlzdGFuY2UpICsgMTsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICB9CgkgICAgICAgIH0KCgkgICAgICAgIHZhciBlZGl0U2NyaXB0ID0gW10sIG1lTWludXNPbmUsIG5vdEluU21sID0gW10sIG5vdEluQmlnID0gW107CgkgICAgICAgIGZvciAoc21sSW5kZXggPSBzbWxJbmRleE1heCwgYmlnSW5kZXggPSBiaWdJbmRleE1heDsgc21sSW5kZXggfHwgYmlnSW5kZXg7KSB7CgkgICAgICAgICAgICBtZU1pbnVzT25lID0gZWRpdERpc3RhbmNlTWF0cml4W3NtbEluZGV4XVtiaWdJbmRleF0gLSAxOwoJICAgICAgICAgICAgaWYgKGJpZ0luZGV4ICYmIG1lTWludXNPbmUgPT09IGVkaXREaXN0YW5jZU1hdHJpeFtzbWxJbmRleF1bYmlnSW5kZXgtMV0pIHsKCSAgICAgICAgICAgICAgICBub3RJblNtbC5wdXNoKGVkaXRTY3JpcHRbZWRpdFNjcmlwdC5sZW5ndGhdID0geyAgICAgLy8gYWRkZWQKCSAgICAgICAgICAgICAgICAgICAgJ3N0YXR1cyc6IHN0YXR1c05vdEluU21sLAoJICAgICAgICAgICAgICAgICAgICAndmFsdWUnOiBiaWdBcnJheVstLWJpZ0luZGV4XSwKCSAgICAgICAgICAgICAgICAgICAgJ2luZGV4JzogYmlnSW5kZXggfSk7CgkgICAgICAgICAgICB9IGVsc2UgaWYgKHNtbEluZGV4ICYmIG1lTWludXNPbmUgPT09IGVkaXREaXN0YW5jZU1hdHJpeFtzbWxJbmRleCAtIDFdW2JpZ0luZGV4XSkgewoJICAgICAgICAgICAgICAgIG5vdEluQmlnLnB1c2goZWRpdFNjcmlwdFtlZGl0U2NyaXB0Lmxlbmd0aF0gPSB7ICAgICAvLyBkZWxldGVkCgkgICAgICAgICAgICAgICAgICAgICdzdGF0dXMnOiBzdGF0dXNOb3RJbkJpZywKCSAgICAgICAgICAgICAgICAgICAgJ3ZhbHVlJzogc21sQXJyYXlbLS1zbWxJbmRleF0sCgkgICAgICAgICAgICAgICAgICAgICdpbmRleCc6IHNtbEluZGV4IH0pOwoJICAgICAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgICAgICAtLWJpZ0luZGV4OwoJICAgICAgICAgICAgICAgIC0tc21sSW5kZXg7CgkgICAgICAgICAgICAgICAgaWYgKCFvcHRpb25zWydzcGFyc2UnXSkgewoJICAgICAgICAgICAgICAgICAgICBlZGl0U2NyaXB0LnB1c2goewoJICAgICAgICAgICAgICAgICAgICAgICAgJ3N0YXR1cyc6ICJyZXRhaW5lZCIsCgkgICAgICAgICAgICAgICAgICAgICAgICAndmFsdWUnOiBiaWdBcnJheVtiaWdJbmRleF0gfSk7CgkgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgfQoJICAgICAgICB9CgoJICAgICAgICAvLyBTZXQgYSBsaW1pdCBvbiB0aGUgbnVtYmVyIG9mIGNvbnNlY3V0aXZlIG5vbi1tYXRjaGluZyBjb21wYXJpc29uczsgaGF2aW5nIGl0IGEgbXVsdGlwbGUgb2YKCSAgICAgICAgLy8gc21sSW5kZXhNYXgga2VlcHMgdGhlIHRpbWUgY29tcGxleGl0eSBvZiB0aGlzIGFsZ29yaXRobSBsaW5lYXIuCgkgICAgICAgIGtvLnV0aWxzLmZpbmRNb3Zlc0luQXJyYXlDb21wYXJpc29uKG5vdEluU21sLCBub3RJbkJpZywgc21sSW5kZXhNYXggKiAxMCk7CgoJICAgICAgICByZXR1cm4gZWRpdFNjcmlwdC5yZXZlcnNlKCk7CgkgICAgfQoKCSAgICByZXR1cm4gY29tcGFyZUFycmF5czsKCX0pKCk7CgoJa28uZXhwb3J0U3ltYm9sKCd1dGlscy5jb21wYXJlQXJyYXlzJywga28udXRpbHMuY29tcGFyZUFycmF5cyk7CgkoZnVuY3Rpb24gKCkgewoJICAgIC8vIE9iamVjdGl2ZToKCSAgICAvLyAqIEdpdmVuIGFuIGlucHV0IGFycmF5LCBhIGNvbnRhaW5lciBET00gbm9kZSwgYW5kIGEgZnVuY3Rpb24gZnJvbSBhcnJheSBlbGVtZW50cyB0byBhcnJheXMgb2YgRE9NIG5vZGVzLAoJICAgIC8vICAgbWFwIHRoZSBhcnJheSBlbGVtZW50cyB0byBhcnJheXMgb2YgRE9NIG5vZGVzLCBjb25jYXRlbmF0ZSB0b2dldGhlciBhbGwgdGhlc2UgYXJyYXlzLCBhbmQgdXNlIHRoZW0gdG8gcG9wdWxhdGUgdGhlIGNvbnRhaW5lciBET00gbm9kZQoJICAgIC8vICogTmV4dCB0aW1lIHdlJ3JlIGdpdmVuIHRoZSBzYW1lIGNvbWJpbmF0aW9uIG9mIHRoaW5ncyAod2l0aCB0aGUgYXJyYXkgcG9zc2libHkgaGF2aW5nIG11dGF0ZWQpLCB1cGRhdGUgdGhlIGNvbnRhaW5lciBET00gbm9kZQoJICAgIC8vICAgc28gdGhhdCBpdHMgY2hpbGRyZW4gaXMgYWdhaW4gdGhlIGNvbmNhdGVuYXRpb24gb2YgdGhlIG1hcHBpbmdzIG9mIHRoZSBhcnJheSBlbGVtZW50cywgYnV0IGRvbid0IHJlLW1hcCBhbnkgYXJyYXkgZWxlbWVudHMgdGhhdCB3ZQoJICAgIC8vICAgcHJldmlvdXNseSBtYXBwZWQgLSByZXRhaW4gdGhvc2Ugbm9kZXMsIGFuZCBqdXN0IGluc2VydC9kZWxldGUgb3RoZXIgb25lcwoKCSAgICAvLyAiY2FsbGJhY2tBZnRlckFkZGluZ05vZGVzIiB3aWxsIGJlIGludm9rZWQgYWZ0ZXIgYW55ICJtYXBwaW5nIi1nZW5lcmF0ZWQgbm9kZXMgYXJlIGluc2VydGVkIGludG8gdGhlIGNvbnRhaW5lciBub2RlCgkgICAgLy8gWW91IGNhbiB1c2UgdGhpcywgZm9yIGV4YW1wbGUsIHRvIGFjdGl2YXRlIGJpbmRpbmdzIG9uIHRob3NlIG5vZGVzLgoKCSAgICBmdW5jdGlvbiBtYXBOb2RlQW5kUmVmcmVzaFdoZW5DaGFuZ2VkKGNvbnRhaW5lck5vZGUsIG1hcHBpbmcsIHZhbHVlVG9NYXAsIGNhbGxiYWNrQWZ0ZXJBZGRpbmdOb2RlcywgaW5kZXgpIHsKCSAgICAgICAgLy8gTWFwIHRoaXMgYXJyYXkgdmFsdWUgaW5zaWRlIGEgZGVwZW5kZW50T2JzZXJ2YWJsZSBzbyB3ZSByZS1tYXAgd2hlbiBhbnkgZGVwZW5kZW5jeSBjaGFuZ2VzCgkgICAgICAgIHZhciBtYXBwZWROb2RlcyA9IFtdOwoJICAgICAgICB2YXIgZGVwZW5kZW50T2JzZXJ2YWJsZSA9IGtvLmRlcGVuZGVudE9ic2VydmFibGUoZnVuY3Rpb24oKSB7CgkgICAgICAgICAgICB2YXIgbmV3TWFwcGVkTm9kZXMgPSBtYXBwaW5nKHZhbHVlVG9NYXAsIGluZGV4LCBrby51dGlscy5maXhVcENvbnRpbnVvdXNOb2RlQXJyYXkobWFwcGVkTm9kZXMsIGNvbnRhaW5lck5vZGUpKSB8fCBbXTsKCgkgICAgICAgICAgICAvLyBPbiBzdWJzZXF1ZW50IGV2YWx1YXRpb25zLCBqdXN0IHJlcGxhY2UgdGhlIHByZXZpb3VzbHktaW5zZXJ0ZWQgRE9NIG5vZGVzCgkgICAgICAgICAgICBpZiAobWFwcGVkTm9kZXMubGVuZ3RoID4gMCkgewoJICAgICAgICAgICAgICAgIGtvLnV0aWxzLnJlcGxhY2VEb21Ob2RlcyhtYXBwZWROb2RlcywgbmV3TWFwcGVkTm9kZXMpOwoJICAgICAgICAgICAgICAgIGlmIChjYWxsYmFja0FmdGVyQWRkaW5nTm9kZXMpCgkgICAgICAgICAgICAgICAgICAgIGtvLmRlcGVuZGVuY3lEZXRlY3Rpb24uaWdub3JlKGNhbGxiYWNrQWZ0ZXJBZGRpbmdOb2RlcywgbnVsbCwgW3ZhbHVlVG9NYXAsIG5ld01hcHBlZE5vZGVzLCBpbmRleF0pOwoJICAgICAgICAgICAgfQoKCSAgICAgICAgICAgIC8vIFJlcGxhY2UgdGhlIGNvbnRlbnRzIG9mIHRoZSBtYXBwZWROb2RlcyBhcnJheSwgdGhlcmVieSB1cGRhdGluZyB0aGUgcmVjb3JkCgkgICAgICAgICAgICAvLyBvZiB3aGljaCBub2RlcyB3b3VsZCBiZSBkZWxldGVkIGlmIHZhbHVlVG9NYXAgd2FzIGl0c2VsZiBsYXRlciByZW1vdmVkCgkgICAgICAgICAgICBtYXBwZWROb2Rlcy5sZW5ndGggPSAwOwoJICAgICAgICAgICAga28udXRpbHMuYXJyYXlQdXNoQWxsKG1hcHBlZE5vZGVzLCBuZXdNYXBwZWROb2Rlcyk7CgkgICAgICAgIH0sIG51bGwsIHsgZGlzcG9zZVdoZW5Ob2RlSXNSZW1vdmVkOiBjb250YWluZXJOb2RlLCBkaXNwb3NlV2hlbjogZnVuY3Rpb24oKSB7IHJldHVybiAha28udXRpbHMuYW55RG9tTm9kZUlzQXR0YWNoZWRUb0RvY3VtZW50KG1hcHBlZE5vZGVzKTsgfSB9KTsKCSAgICAgICAgcmV0dXJuIHsgbWFwcGVkTm9kZXMgOiBtYXBwZWROb2RlcywgZGVwZW5kZW50T2JzZXJ2YWJsZSA6IChkZXBlbmRlbnRPYnNlcnZhYmxlLmlzQWN0aXZlKCkgPyBkZXBlbmRlbnRPYnNlcnZhYmxlIDogdW5kZWZpbmVkKSB9OwoJICAgIH0KCgkgICAgdmFyIGxhc3RNYXBwaW5nUmVzdWx0RG9tRGF0YUtleSA9IGtvLnV0aWxzLmRvbURhdGEubmV4dEtleSgpOwoKCSAgICBrby51dGlscy5zZXREb21Ob2RlQ2hpbGRyZW5Gcm9tQXJyYXlNYXBwaW5nID0gZnVuY3Rpb24gKGRvbU5vZGUsIGFycmF5LCBtYXBwaW5nLCBvcHRpb25zLCBjYWxsYmFja0FmdGVyQWRkaW5nTm9kZXMpIHsKCSAgICAgICAgLy8gQ29tcGFyZSB0aGUgcHJvdmlkZWQgYXJyYXkgYWdhaW5zdCB0aGUgcHJldmlvdXMgb25lCgkgICAgICAgIGFycmF5ID0gYXJyYXkgfHwgW107CgkgICAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoJICAgICAgICB2YXIgaXNGaXJzdEV4ZWN1dGlvbiA9IGtvLnV0aWxzLmRvbURhdGEuZ2V0KGRvbU5vZGUsIGxhc3RNYXBwaW5nUmVzdWx0RG9tRGF0YUtleSkgPT09IHVuZGVmaW5lZDsKCSAgICAgICAgdmFyIGxhc3RNYXBwaW5nUmVzdWx0ID0ga28udXRpbHMuZG9tRGF0YS5nZXQoZG9tTm9kZSwgbGFzdE1hcHBpbmdSZXN1bHREb21EYXRhS2V5KSB8fCBbXTsKCSAgICAgICAgdmFyIGxhc3RBcnJheSA9IGtvLnV0aWxzLmFycmF5TWFwKGxhc3RNYXBwaW5nUmVzdWx0LCBmdW5jdGlvbiAoeCkgeyByZXR1cm4geC5hcnJheUVudHJ5OyB9KTsKCSAgICAgICAgdmFyIGVkaXRTY3JpcHQgPSBrby51dGlscy5jb21wYXJlQXJyYXlzKGxhc3RBcnJheSwgYXJyYXksIG9wdGlvbnNbJ2RvbnRMaW1pdE1vdmVzJ10pOwoKCSAgICAgICAgLy8gQnVpbGQgdGhlIG5ldyBtYXBwaW5nIHJlc3VsdAoJICAgICAgICB2YXIgbmV3TWFwcGluZ1Jlc3VsdCA9IFtdOwoJICAgICAgICB2YXIgbGFzdE1hcHBpbmdSZXN1bHRJbmRleCA9IDA7CgkgICAgICAgIHZhciBuZXdNYXBwaW5nUmVzdWx0SW5kZXggPSAwOwoKCSAgICAgICAgdmFyIG5vZGVzVG9EZWxldGUgPSBbXTsKCSAgICAgICAgdmFyIGl0ZW1zVG9Qcm9jZXNzID0gW107CgkgICAgICAgIHZhciBpdGVtc0ZvckJlZm9yZVJlbW92ZUNhbGxiYWNrcyA9IFtdOwoJICAgICAgICB2YXIgaXRlbXNGb3JNb3ZlQ2FsbGJhY2tzID0gW107CgkgICAgICAgIHZhciBpdGVtc0ZvckFmdGVyQWRkQ2FsbGJhY2tzID0gW107CgkgICAgICAgIHZhciBtYXBEYXRhOwoKCSAgICAgICAgZnVuY3Rpb24gaXRlbU1vdmVkT3JSZXRhaW5lZChlZGl0U2NyaXB0SW5kZXgsIG9sZFBvc2l0aW9uKSB7CgkgICAgICAgICAgICBtYXBEYXRhID0gbGFzdE1hcHBpbmdSZXN1bHRbb2xkUG9zaXRpb25dOwoJICAgICAgICAgICAgaWYgKG5ld01hcHBpbmdSZXN1bHRJbmRleCAhPT0gb2xkUG9zaXRpb24pCgkgICAgICAgICAgICAgICAgaXRlbXNGb3JNb3ZlQ2FsbGJhY2tzW2VkaXRTY3JpcHRJbmRleF0gPSBtYXBEYXRhOwoJICAgICAgICAgICAgLy8gU2luY2UgdXBkYXRpbmcgdGhlIGluZGV4IG1pZ2h0IGNoYW5nZSB0aGUgbm9kZXMsIGRvIHNvIGJlZm9yZSBjYWxsaW5nIGZpeFVwQ29udGludW91c05vZGVBcnJheQoJICAgICAgICAgICAgbWFwRGF0YS5pbmRleE9ic2VydmFibGUobmV3TWFwcGluZ1Jlc3VsdEluZGV4KyspOwoJICAgICAgICAgICAga28udXRpbHMuZml4VXBDb250aW51b3VzTm9kZUFycmF5KG1hcERhdGEubWFwcGVkTm9kZXMsIGRvbU5vZGUpOwoJICAgICAgICAgICAgbmV3TWFwcGluZ1Jlc3VsdC5wdXNoKG1hcERhdGEpOwoJICAgICAgICAgICAgaXRlbXNUb1Byb2Nlc3MucHVzaChtYXBEYXRhKTsKCSAgICAgICAgfQoKCSAgICAgICAgZnVuY3Rpb24gY2FsbENhbGxiYWNrKGNhbGxiYWNrLCBpdGVtcykgewoJICAgICAgICAgICAgaWYgKGNhbGxiYWNrKSB7CgkgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIG4gPSBpdGVtcy5sZW5ndGg7IGkgPCBuOyBpKyspIHsKCSAgICAgICAgICAgICAgICAgICAgaWYgKGl0ZW1zW2ldKSB7CgkgICAgICAgICAgICAgICAgICAgICAgICBrby51dGlscy5hcnJheUZvckVhY2goaXRlbXNbaV0ubWFwcGVkTm9kZXMsIGZ1bmN0aW9uKG5vZGUpIHsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayhub2RlLCBpLCBpdGVtc1tpXS5hcnJheUVudHJ5KTsKCSAgICAgICAgICAgICAgICAgICAgICAgIH0pOwoJICAgICAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgfQoJICAgICAgICB9CgoJICAgICAgICBmb3IgKHZhciBpID0gMCwgZWRpdFNjcmlwdEl0ZW0sIG1vdmVkSW5kZXg7IGVkaXRTY3JpcHRJdGVtID0gZWRpdFNjcmlwdFtpXTsgaSsrKSB7CgkgICAgICAgICAgICBtb3ZlZEluZGV4ID0gZWRpdFNjcmlwdEl0ZW1bJ21vdmVkJ107CgkgICAgICAgICAgICBzd2l0Y2ggKGVkaXRTY3JpcHRJdGVtWydzdGF0dXMnXSkgewoJICAgICAgICAgICAgICAgIGNhc2UgImRlbGV0ZWQiOgoJICAgICAgICAgICAgICAgICAgICBpZiAobW92ZWRJbmRleCA9PT0gdW5kZWZpbmVkKSB7CgkgICAgICAgICAgICAgICAgICAgICAgICBtYXBEYXRhID0gbGFzdE1hcHBpbmdSZXN1bHRbbGFzdE1hcHBpbmdSZXN1bHRJbmRleF07CgoJICAgICAgICAgICAgICAgICAgICAgICAgLy8gU3RvcCB0cmFja2luZyBjaGFuZ2VzIHRvIHRoZSBtYXBwaW5nIGZvciB0aGVzZSBub2RlcwoJICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1hcERhdGEuZGVwZW5kZW50T2JzZXJ2YWJsZSkKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXBEYXRhLmRlcGVuZGVudE9ic2VydmFibGUuZGlzcG9zZSgpOwoKCSAgICAgICAgICAgICAgICAgICAgICAgIC8vIFF1ZXVlIHRoZXNlIG5vZGVzIGZvciBsYXRlciByZW1vdmFsCgkgICAgICAgICAgICAgICAgICAgICAgICBub2Rlc1RvRGVsZXRlLnB1c2guYXBwbHkobm9kZXNUb0RlbGV0ZSwga28udXRpbHMuZml4VXBDb250aW51b3VzTm9kZUFycmF5KG1hcERhdGEubWFwcGVkTm9kZXMsIGRvbU5vZGUpKTsKCSAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvcHRpb25zWydiZWZvcmVSZW1vdmUnXSkgewoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW1zRm9yQmVmb3JlUmVtb3ZlQ2FsbGJhY2tzW2ldID0gbWFwRGF0YTsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICBpdGVtc1RvUHJvY2Vzcy5wdXNoKG1hcERhdGEpOwoJICAgICAgICAgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgICAgIGxhc3RNYXBwaW5nUmVzdWx0SW5kZXgrKzsKCSAgICAgICAgICAgICAgICAgICAgYnJlYWs7CgoJICAgICAgICAgICAgICAgIGNhc2UgInJldGFpbmVkIjoKCSAgICAgICAgICAgICAgICAgICAgaXRlbU1vdmVkT3JSZXRhaW5lZChpLCBsYXN0TWFwcGluZ1Jlc3VsdEluZGV4KyspOwoJICAgICAgICAgICAgICAgICAgICBicmVhazsKCgkgICAgICAgICAgICAgICAgY2FzZSAiYWRkZWQiOgoJICAgICAgICAgICAgICAgICAgICBpZiAobW92ZWRJbmRleCAhPT0gdW5kZWZpbmVkKSB7CgkgICAgICAgICAgICAgICAgICAgICAgICBpdGVtTW92ZWRPclJldGFpbmVkKGksIG1vdmVkSW5kZXgpOwoJICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgICAgICAgICAgICAgbWFwRGF0YSA9IHsgYXJyYXlFbnRyeTogZWRpdFNjcmlwdEl0ZW1bJ3ZhbHVlJ10sIGluZGV4T2JzZXJ2YWJsZToga28ub2JzZXJ2YWJsZShuZXdNYXBwaW5nUmVzdWx0SW5kZXgrKykgfTsKCSAgICAgICAgICAgICAgICAgICAgICAgIG5ld01hcHBpbmdSZXN1bHQucHVzaChtYXBEYXRhKTsKCSAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW1zVG9Qcm9jZXNzLnB1c2gobWFwRGF0YSk7CgkgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWlzRmlyc3RFeGVjdXRpb24pCgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgaXRlbXNGb3JBZnRlckFkZENhbGxiYWNrc1tpXSA9IG1hcERhdGE7CgkgICAgICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICAgICAgYnJlYWs7CgkgICAgICAgICAgICB9CgkgICAgICAgIH0KCgkgICAgICAgIC8vIENhbGwgYmVmb3JlTW92ZSBmaXJzdCBiZWZvcmUgYW55IGNoYW5nZXMgaGF2ZSBiZWVuIG1hZGUgdG8gdGhlIERPTQoJICAgICAgICBjYWxsQ2FsbGJhY2sob3B0aW9uc1snYmVmb3JlTW92ZSddLCBpdGVtc0Zvck1vdmVDYWxsYmFja3MpOwoKCSAgICAgICAgLy8gTmV4dCByZW1vdmUgbm9kZXMgZm9yIGRlbGV0ZWQgaXRlbXMgKG9yIGp1c3QgY2xlYW4gaWYgdGhlcmUncyBhIGJlZm9yZVJlbW92ZSBjYWxsYmFjaykKCSAgICAgICAga28udXRpbHMuYXJyYXlGb3JFYWNoKG5vZGVzVG9EZWxldGUsIG9wdGlvbnNbJ2JlZm9yZVJlbW92ZSddID8ga28uY2xlYW5Ob2RlIDoga28ucmVtb3ZlTm9kZSk7CgoJICAgICAgICAvLyBOZXh0IGFkZC9yZW9yZGVyIHRoZSByZW1haW5pbmcgaXRlbXMgKHdpbGwgaW5jbHVkZSBkZWxldGVkIGl0ZW1zIGlmIHRoZXJlJ3MgYSBiZWZvcmVSZW1vdmUgY2FsbGJhY2spCgkgICAgICAgIGZvciAodmFyIGkgPSAwLCBuZXh0Tm9kZSA9IGtvLnZpcnR1YWxFbGVtZW50cy5maXJzdENoaWxkKGRvbU5vZGUpLCBsYXN0Tm9kZSwgbm9kZTsgbWFwRGF0YSA9IGl0ZW1zVG9Qcm9jZXNzW2ldOyBpKyspIHsKCSAgICAgICAgICAgIC8vIEdldCBub2RlcyBmb3IgbmV3bHkgYWRkZWQgaXRlbXMKCSAgICAgICAgICAgIGlmICghbWFwRGF0YS5tYXBwZWROb2RlcykKCSAgICAgICAgICAgICAgICBrby51dGlscy5leHRlbmQobWFwRGF0YSwgbWFwTm9kZUFuZFJlZnJlc2hXaGVuQ2hhbmdlZChkb21Ob2RlLCBtYXBwaW5nLCBtYXBEYXRhLmFycmF5RW50cnksIGNhbGxiYWNrQWZ0ZXJBZGRpbmdOb2RlcywgbWFwRGF0YS5pbmRleE9ic2VydmFibGUpKTsKCgkgICAgICAgICAgICAvLyBQdXQgbm9kZXMgaW4gdGhlIHJpZ2h0IHBsYWNlIGlmIHRoZXkgYXJlbid0IHRoZXJlIGFscmVhZHkKCSAgICAgICAgICAgIGZvciAodmFyIGogPSAwOyBub2RlID0gbWFwRGF0YS5tYXBwZWROb2Rlc1tqXTsgbmV4dE5vZGUgPSBub2RlLm5leHRTaWJsaW5nLCBsYXN0Tm9kZSA9IG5vZGUsIGorKykgewoJICAgICAgICAgICAgICAgIGlmIChub2RlICE9PSBuZXh0Tm9kZSkKCSAgICAgICAgICAgICAgICAgICAga28udmlydHVhbEVsZW1lbnRzLmluc2VydEFmdGVyKGRvbU5vZGUsIG5vZGUsIGxhc3ROb2RlKTsKCSAgICAgICAgICAgIH0KCgkgICAgICAgICAgICAvLyBSdW4gdGhlIGNhbGxiYWNrcyBmb3IgbmV3bHkgYWRkZWQgbm9kZXMgKGZvciBleGFtcGxlLCB0byBhcHBseSBiaW5kaW5ncywgZXRjLikKCSAgICAgICAgICAgIGlmICghbWFwRGF0YS5pbml0aWFsaXplZCAmJiBjYWxsYmFja0FmdGVyQWRkaW5nTm9kZXMpIHsKCSAgICAgICAgICAgICAgICBjYWxsYmFja0FmdGVyQWRkaW5nTm9kZXMobWFwRGF0YS5hcnJheUVudHJ5LCBtYXBEYXRhLm1hcHBlZE5vZGVzLCBtYXBEYXRhLmluZGV4T2JzZXJ2YWJsZSk7CgkgICAgICAgICAgICAgICAgbWFwRGF0YS5pbml0aWFsaXplZCA9IHRydWU7CgkgICAgICAgICAgICB9CgkgICAgICAgIH0KCgkgICAgICAgIC8vIElmIHRoZXJlJ3MgYSBiZWZvcmVSZW1vdmUgY2FsbGJhY2ssIGNhbGwgaXQgYWZ0ZXIgcmVvcmRlcmluZy4KCSAgICAgICAgLy8gTm90ZSB0aGF0IHdlIGFzc3VtZSB0aGF0IHRoZSBiZWZvcmVSZW1vdmUgY2FsbGJhY2sgd2lsbCB1c3VhbGx5IGJlIHVzZWQgdG8gcmVtb3ZlIHRoZSBub2RlcyB1c2luZwoJICAgICAgICAvLyBzb21lIHNvcnQgb2YgYW5pbWF0aW9uLCB3aGljaCBpcyB3aHkgd2UgZmlyc3QgcmVvcmRlciB0aGUgbm9kZXMgdGhhdCB3aWxsIGJlIHJlbW92ZWQuIElmIHRoZQoJICAgICAgICAvLyBjYWxsYmFjayBpbnN0ZWFkIHJlbW92ZXMgdGhlIG5vZGVzIHJpZ2h0IGF3YXksIGl0IHdvdWxkIGJlIG1vcmUgZWZmaWNpZW50IHRvIHNraXAgcmVvcmRlcmluZyB0aGVtLgoJICAgICAgICAvLyBQZXJoYXBzIHdlJ2xsIG1ha2UgdGhhdCBjaGFuZ2UgaW4gdGhlIGZ1dHVyZSBpZiB0aGlzIHNjZW5hcmlvIGJlY29tZXMgbW9yZSBjb21tb24uCgkgICAgICAgIGNhbGxDYWxsYmFjayhvcHRpb25zWydiZWZvcmVSZW1vdmUnXSwgaXRlbXNGb3JCZWZvcmVSZW1vdmVDYWxsYmFja3MpOwoKCSAgICAgICAgLy8gRmluYWxseSBjYWxsIGFmdGVyTW92ZSBhbmQgYWZ0ZXJBZGQgY2FsbGJhY2tzCgkgICAgICAgIGNhbGxDYWxsYmFjayhvcHRpb25zWydhZnRlck1vdmUnXSwgaXRlbXNGb3JNb3ZlQ2FsbGJhY2tzKTsKCSAgICAgICAgY2FsbENhbGxiYWNrKG9wdGlvbnNbJ2FmdGVyQWRkJ10sIGl0ZW1zRm9yQWZ0ZXJBZGRDYWxsYmFja3MpOwoKCSAgICAgICAgLy8gU3RvcmUgYSBjb3B5IG9mIHRoZSBhcnJheSBpdGVtcyB3ZSBqdXN0IGNvbnNpZGVyZWQgc28gd2UgY2FuIGRpZmZlcmVuY2UgaXQgbmV4dCB0aW1lCgkgICAgICAgIGtvLnV0aWxzLmRvbURhdGEuc2V0KGRvbU5vZGUsIGxhc3RNYXBwaW5nUmVzdWx0RG9tRGF0YUtleSwgbmV3TWFwcGluZ1Jlc3VsdCk7CgkgICAgfQoJfSkoKTsKCglrby5leHBvcnRTeW1ib2woJ3V0aWxzLnNldERvbU5vZGVDaGlsZHJlbkZyb21BcnJheU1hcHBpbmcnLCBrby51dGlscy5zZXREb21Ob2RlQ2hpbGRyZW5Gcm9tQXJyYXlNYXBwaW5nKTsKCWtvLm5hdGl2ZVRlbXBsYXRlRW5naW5lID0gZnVuY3Rpb24gKCkgewoJICAgIHRoaXNbJ2FsbG93VGVtcGxhdGVSZXdyaXRpbmcnXSA9IGZhbHNlOwoJfQoKCWtvLm5hdGl2ZVRlbXBsYXRlRW5naW5lLnByb3RvdHlwZSA9IG5ldyBrby50ZW1wbGF0ZUVuZ2luZSgpOwoJa28ubmF0aXZlVGVtcGxhdGVFbmdpbmUucHJvdG90eXBlLmNvbnN0cnVjdG9yID0ga28ubmF0aXZlVGVtcGxhdGVFbmdpbmU7Cglrby5uYXRpdmVUZW1wbGF0ZUVuZ2luZS5wcm90b3R5cGVbJ3JlbmRlclRlbXBsYXRlU291cmNlJ10gPSBmdW5jdGlvbiAodGVtcGxhdGVTb3VyY2UsIGJpbmRpbmdDb250ZXh0LCBvcHRpb25zKSB7CgkgICAgdmFyIHVzZU5vZGVzSWZBdmFpbGFibGUgPSAhKGtvLnV0aWxzLmllVmVyc2lvbiA8IDkpLCAvLyBJRTw5IGNsb25lTm9kZSBkb2Vzbid0IHdvcmsgcHJvcGVybHkKCSAgICAgICAgdGVtcGxhdGVOb2Rlc0Z1bmMgPSB1c2VOb2Rlc0lmQXZhaWxhYmxlID8gdGVtcGxhdGVTb3VyY2VbJ25vZGVzJ10gOiBudWxsLAoJICAgICAgICB0ZW1wbGF0ZU5vZGVzID0gdGVtcGxhdGVOb2Rlc0Z1bmMgPyB0ZW1wbGF0ZVNvdXJjZVsnbm9kZXMnXSgpIDogbnVsbDsKCgkgICAgaWYgKHRlbXBsYXRlTm9kZXMpIHsKCSAgICAgICAgcmV0dXJuIGtvLnV0aWxzLm1ha2VBcnJheSh0ZW1wbGF0ZU5vZGVzLmNsb25lTm9kZSh0cnVlKS5jaGlsZE5vZGVzKTsKCSAgICB9IGVsc2UgewoJICAgICAgICB2YXIgdGVtcGxhdGVUZXh0ID0gdGVtcGxhdGVTb3VyY2VbJ3RleHQnXSgpOwoJICAgICAgICByZXR1cm4ga28udXRpbHMucGFyc2VIdG1sRnJhZ21lbnQodGVtcGxhdGVUZXh0KTsKCSAgICB9Cgl9OwoKCWtvLm5hdGl2ZVRlbXBsYXRlRW5naW5lLmluc3RhbmNlID0gbmV3IGtvLm5hdGl2ZVRlbXBsYXRlRW5naW5lKCk7Cglrby5zZXRUZW1wbGF0ZUVuZ2luZShrby5uYXRpdmVUZW1wbGF0ZUVuZ2luZS5pbnN0YW5jZSk7CgoJa28uZXhwb3J0U3ltYm9sKCduYXRpdmVUZW1wbGF0ZUVuZ2luZScsIGtvLm5hdGl2ZVRlbXBsYXRlRW5naW5lKTsKCShmdW5jdGlvbigpIHsKCSAgICBrby5qcXVlcnlUbXBsVGVtcGxhdGVFbmdpbmUgPSBmdW5jdGlvbiAoKSB7CgkgICAgICAgIC8vIERldGVjdCB3aGljaCB2ZXJzaW9uIG9mIGpxdWVyeS10bXBsIHlvdSdyZSB1c2luZy4gVW5mb3J0dW5hdGVseSBqcXVlcnktdG1wbAoJICAgICAgICAvLyBkb2Vzbid0IGV4cG9zZSBhIHZlcnNpb24gbnVtYmVyLCBzbyB3ZSBoYXZlIHRvIGluZmVyIGl0LgoJICAgICAgICAvLyBOb3RlIHRoYXQgYXMgb2YgS25vY2tvdXQgMS4zLCB3ZSBvbmx5IHN1cHBvcnQgalF1ZXJ5LnRtcGwgMS4wLjBwcmUgYW5kIGxhdGVyLAoJICAgICAgICAvLyB3aGljaCBLTyBpbnRlcm5hbGx5IHJlZmVycyB0byBhcyB2ZXJzaW9uICIyIiwgc28gb2xkZXIgdmVyc2lvbnMgYXJlIG5vIGxvbmdlciBkZXRlY3RlZC4KCSAgICAgICAgdmFyIGpRdWVyeVRtcGxWZXJzaW9uID0gdGhpcy5qUXVlcnlUbXBsVmVyc2lvbiA9IChmdW5jdGlvbigpIHsKCSAgICAgICAgICAgIGlmICghalF1ZXJ5SW5zdGFuY2UgfHwgIShqUXVlcnlJbnN0YW5jZVsndG1wbCddKSkKCSAgICAgICAgICAgICAgICByZXR1cm4gMDsKCSAgICAgICAgICAgIC8vIFNpbmNlIGl0IGV4cG9zZXMgbm8gb2ZmaWNpYWwgdmVyc2lvbiBudW1iZXIsIHdlIHVzZSBvdXIgb3duIG51bWJlcmluZyBzeXN0ZW0uIFRvIGJlIHVwZGF0ZWQgYXMganF1ZXJ5LXRtcGwgZXZvbHZlcy4KCSAgICAgICAgICAgIHRyeSB7CgkgICAgICAgICAgICAgICAgaWYgKGpRdWVyeUluc3RhbmNlWyd0bXBsJ11bJ3RhZyddWyd0bXBsJ11bJ29wZW4nXS50b1N0cmluZygpLmluZGV4T2YoJ19fJykgPj0gMCkgewoJICAgICAgICAgICAgICAgICAgICAvLyBTaW5jZSAxLjAuMHByZSwgY3VzdG9tIHRhZ3Mgc2hvdWxkIGFwcGVuZCBtYXJrdXAgdG8gYW4gYXJyYXkgY2FsbGVkICJfXyIKCSAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDI7IC8vIEZpbmFsIHZlcnNpb24gb2YganF1ZXJ5LnRtcGwKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICB9IGNhdGNoKGV4KSB7IC8qIEFwcGFyZW50bHkgbm90IHRoZSB2ZXJzaW9uIHdlIHdlcmUgbG9va2luZyBmb3IgKi8gfQoKCSAgICAgICAgICAgIHJldHVybiAxOyAvLyBBbnkgb2xkZXIgdmVyc2lvbiB0aGF0IHdlIGRvbid0IHN1cHBvcnQKCSAgICAgICAgfSkoKTsKCgkgICAgICAgIGZ1bmN0aW9uIGVuc3VyZUhhc1JlZmVyZW5jZWRKUXVlcnlUZW1wbGF0ZXMoKSB7CgkgICAgICAgICAgICBpZiAoalF1ZXJ5VG1wbFZlcnNpb24gPCAyKQoJICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiWW91ciB2ZXJzaW9uIG9mIGpRdWVyeS50bXBsIGlzIHRvbyBvbGQuIFBsZWFzZSB1cGdyYWRlIHRvIGpRdWVyeS50bXBsIDEuMC4wcHJlIG9yIGxhdGVyLiIpOwoJICAgICAgICB9CgoJICAgICAgICBmdW5jdGlvbiBleGVjdXRlVGVtcGxhdGUoY29tcGlsZWRUZW1wbGF0ZSwgZGF0YSwgalF1ZXJ5VGVtcGxhdGVPcHRpb25zKSB7CgkgICAgICAgICAgICByZXR1cm4galF1ZXJ5SW5zdGFuY2VbJ3RtcGwnXShjb21waWxlZFRlbXBsYXRlLCBkYXRhLCBqUXVlcnlUZW1wbGF0ZU9wdGlvbnMpOwoJICAgICAgICB9CgoJICAgICAgICB0aGlzWydyZW5kZXJUZW1wbGF0ZVNvdXJjZSddID0gZnVuY3Rpb24odGVtcGxhdGVTb3VyY2UsIGJpbmRpbmdDb250ZXh0LCBvcHRpb25zKSB7CgkgICAgICAgICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKCSAgICAgICAgICAgIGVuc3VyZUhhc1JlZmVyZW5jZWRKUXVlcnlUZW1wbGF0ZXMoKTsKCgkgICAgICAgICAgICAvLyBFbnN1cmUgd2UgaGF2ZSBzdG9yZWQgYSBwcmVjb21waWxlZCB2ZXJzaW9uIG9mIHRoaXMgdGVtcGxhdGUgKGRvbid0IHdhbnQgdG8gcmVwYXJzZSBvbiBldmVyeSByZW5kZXIpCgkgICAgICAgICAgICB2YXIgcHJlY29tcGlsZWQgPSB0ZW1wbGF0ZVNvdXJjZVsnZGF0YSddKCdwcmVjb21waWxlZCcpOwoJICAgICAgICAgICAgaWYgKCFwcmVjb21waWxlZCkgewoJICAgICAgICAgICAgICAgIHZhciB0ZW1wbGF0ZVRleHQgPSB0ZW1wbGF0ZVNvdXJjZVsndGV4dCddKCkgfHwgIiI7CgkgICAgICAgICAgICAgICAgLy8gV3JhcCBpbiAid2l0aCgkd2hhdGV2ZXIua29CaW5kaW5nQ29udGV4dCkgeyAuLi4gfSIKCSAgICAgICAgICAgICAgICB0ZW1wbGF0ZVRleHQgPSAie3trb193aXRoICRpdGVtLmtvQmluZGluZ0NvbnRleHR9fSIgKyB0ZW1wbGF0ZVRleHQgKyAie3sva29fd2l0aH19IjsKCgkgICAgICAgICAgICAgICAgcHJlY29tcGlsZWQgPSBqUXVlcnlJbnN0YW5jZVsndGVtcGxhdGUnXShudWxsLCB0ZW1wbGF0ZVRleHQpOwoJICAgICAgICAgICAgICAgIHRlbXBsYXRlU291cmNlWydkYXRhJ10oJ3ByZWNvbXBpbGVkJywgcHJlY29tcGlsZWQpOwoJICAgICAgICAgICAgfQoKCSAgICAgICAgICAgIHZhciBkYXRhID0gW2JpbmRpbmdDb250ZXh0WyckZGF0YSddXTsgLy8gUHJld3JhcCB0aGUgZGF0YSBpbiBhbiBhcnJheSB0byBzdG9wIGpxdWVyeS50bXBsIGZyb20gdHJ5aW5nIHRvIHVud3JhcCBhbnkgYXJyYXlzCgkgICAgICAgICAgICB2YXIgalF1ZXJ5VGVtcGxhdGVPcHRpb25zID0galF1ZXJ5SW5zdGFuY2VbJ2V4dGVuZCddKHsgJ2tvQmluZGluZ0NvbnRleHQnOiBiaW5kaW5nQ29udGV4dCB9LCBvcHRpb25zWyd0ZW1wbGF0ZU9wdGlvbnMnXSk7CgoJICAgICAgICAgICAgdmFyIHJlc3VsdE5vZGVzID0gZXhlY3V0ZVRlbXBsYXRlKHByZWNvbXBpbGVkLCBkYXRhLCBqUXVlcnlUZW1wbGF0ZU9wdGlvbnMpOwoJICAgICAgICAgICAgcmVzdWx0Tm9kZXNbJ2FwcGVuZFRvJ10oZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2IikpOyAvLyBVc2luZyAiYXBwZW5kVG8iIGZvcmNlcyBqUXVlcnkvalF1ZXJ5LnRtcGwgdG8gcGVyZm9ybSBuZWNlc3NhcnkgY2xlYW51cCB3b3JrCgoJICAgICAgICAgICAgalF1ZXJ5SW5zdGFuY2VbJ2ZyYWdtZW50cyddID0ge307IC8vIENsZWFyIGpRdWVyeSdzIGZyYWdtZW50IGNhY2hlIHRvIGF2b2lkIGEgbWVtb3J5IGxlYWsgYWZ0ZXIgYSBsYXJnZSBudW1iZXIgb2YgdGVtcGxhdGUgcmVuZGVycwoJICAgICAgICAgICAgcmV0dXJuIHJlc3VsdE5vZGVzOwoJICAgICAgICB9OwoKCSAgICAgICAgdGhpc1snY3JlYXRlSmF2YVNjcmlwdEV2YWx1YXRvckJsb2NrJ10gPSBmdW5jdGlvbihzY3JpcHQpIHsKCSAgICAgICAgICAgIHJldHVybiAie3trb19jb2RlICgoZnVuY3Rpb24oKSB7IHJldHVybiAiICsgc2NyaXB0ICsgIiB9KSgpKSB9fSI7CgkgICAgICAgIH07CgoJICAgICAgICB0aGlzWydhZGRUZW1wbGF0ZSddID0gZnVuY3Rpb24odGVtcGxhdGVOYW1lLCB0ZW1wbGF0ZU1hcmt1cCkgewoJICAgICAgICAgICAgZG9jdW1lbnQud3JpdGUoIjxzY3JpcHQgdHlwZT0ndGV4dC9odG1sJyBpZD0nIiArIHRlbXBsYXRlTmFtZSArICInPiIgKyB0ZW1wbGF0ZU1hcmt1cCArICI8IiArICIvc2NyaXB0PiIpOwoJICAgICAgICB9OwoKCSAgICAgICAgaWYgKGpRdWVyeVRtcGxWZXJzaW9uID4gMCkgewoJICAgICAgICAgICAgalF1ZXJ5SW5zdGFuY2VbJ3RtcGwnXVsndGFnJ11bJ2tvX2NvZGUnXSA9IHsKCSAgICAgICAgICAgICAgICBvcGVuOiAiX18ucHVzaCgkMSB8fCAnJyk7IgoJICAgICAgICAgICAgfTsKCSAgICAgICAgICAgIGpRdWVyeUluc3RhbmNlWyd0bXBsJ11bJ3RhZyddWydrb193aXRoJ10gPSB7CgkgICAgICAgICAgICAgICAgb3BlbjogIndpdGgoJDEpIHsiLAoJICAgICAgICAgICAgICAgIGNsb3NlOiAifSAiCgkgICAgICAgICAgICB9OwoJICAgICAgICB9CgkgICAgfTsKCgkgICAga28uanF1ZXJ5VG1wbFRlbXBsYXRlRW5naW5lLnByb3RvdHlwZSA9IG5ldyBrby50ZW1wbGF0ZUVuZ2luZSgpOwoJICAgIGtvLmpxdWVyeVRtcGxUZW1wbGF0ZUVuZ2luZS5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBrby5qcXVlcnlUbXBsVGVtcGxhdGVFbmdpbmU7CgoJICAgIC8vIFVzZSB0aGlzIG9uZSBieSBkZWZhdWx0ICpvbmx5IGlmIGpxdWVyeS50bXBsIGlzIHJlZmVyZW5jZWQqCgkgICAgdmFyIGpxdWVyeVRtcGxUZW1wbGF0ZUVuZ2luZUluc3RhbmNlID0gbmV3IGtvLmpxdWVyeVRtcGxUZW1wbGF0ZUVuZ2luZSgpOwoJICAgIGlmIChqcXVlcnlUbXBsVGVtcGxhdGVFbmdpbmVJbnN0YW5jZS5qUXVlcnlUbXBsVmVyc2lvbiA+IDApCgkgICAgICAgIGtvLnNldFRlbXBsYXRlRW5naW5lKGpxdWVyeVRtcGxUZW1wbGF0ZUVuZ2luZUluc3RhbmNlKTsKCgkgICAga28uZXhwb3J0U3ltYm9sKCdqcXVlcnlUbXBsVGVtcGxhdGVFbmdpbmUnLCBrby5qcXVlcnlUbXBsVGVtcGxhdGVFbmdpbmUpOwoJfSkoKTsKCX0pKTsKCX0oKSk7Cgl9KSgpOwoKCi8qKiovIH0KLyoqKioqKi8gXSkKfSk7Cg==",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Fri, 07 Nov 2014 08:09:48 GMT",
                    "Content-Length": "474997",
                    "Date": "Fri, 07 Nov 2014 08:09:49 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}