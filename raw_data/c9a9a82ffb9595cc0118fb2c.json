{
    "url": "http://localhost:9999/sjhewitt/glitch.js/javascripts/html2canvas.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Link manipulation (DOM-based)",
    "issueType": 5246976,
    "severity": "Low",
    "confidence": "Firm",
    "issueBackground": "DOM-based link manipulation vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this to a navigation target within the current page, such as a clickable link or the submission URL of a form. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will modify the target of links within the response. An attacker may be able to leverage this to perform various attacks, including:<ul><li>Causing the user to redirect to an arbitrary external URL, to facilitate a phishing attack.</li><li>Causing the user to submit sensitive form data to a server controlled by the attacker.</li><li>Causing the user to perform an unintended action within the application, by changing the file or query string associated with a link.</li><li>Bypassing browser anti-XSS defenses by injecting on-site links containing XSS exploits, since browser anti-XSS defenses typically do not operate on on-site links.</li></ul>",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based link manipulation vulnerabilities is not to dynamically set the target URLs of links or forms using data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing an arbitrary URL as a link target. In general, this is best achieved by using a whitelist of URLs that are permitted link targets, and strictly validating the target against this list before setting the link target.",
    "issueDetail": "The application may be vulnerable to DOM-based link manipulation. Data is read from <b>window.location.href</b> and written to <b>the 'href' property of a DOM element</b> via the following statement:<ul><li>link.href = window.location.href;</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/sjhewitt/glitch.js/javascripts/html2canvas.js",
                "path": "/sjhewitt/glitch.js/javascripts/html2canvas.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9zamhld2l0dC9nbGl0Y2guanMvamF2YXNjcmlwdHMvaHRtbDJjYW52YXMuanMgSFRUUC8xLjENCkhvc3Q6IGxvY2FsaG9zdDo5OTk5DQoNCg==",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogOTQ5ODUNCkFjY2VwdC1SYW5nZXM6IGJ5dGVzDQpDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2phdmFzY3JpcHQNCkRhdGU6IEZyaSwgMDcgTm92IDIwMTQgMDI6MjU6MTEgR01UDQpMYXN0LU1vZGlmaWVkOiBGcmksIDA3IE5vdiAyMDE0IDAyOjI1OjEwIEdNVA0KDQovKioNCiAgQGxpY2Vuc2UgaHRtbDJjYW52YXMgdjAuMzQgPGh0dHA6Ly9odG1sMmNhbnZhcy5oZXJ0emVuLmNvbT4NCiAgQ29weXJpZ2h0IChjKSAyMDExIE5pa2xhcyB2b24gSGVydHplbi4gQWxsIHJpZ2h0cyByZXNlcnZlZC4NCiAgaHR0cDovL3d3dy50d2l0dGVyLmNvbS9uaWtsYXN2aA0KDQogIFJlbGVhc2VkIHVuZGVyIE1JVCBMaWNlbnNlDQogKi8NCihmdW5jdGlvbih3aW5kb3csIGRvY3VtZW50LCB1bmRlZmluZWQpew0KDQovKg0KICBodG1sMmNhbnZhcyB2MC4zNCA8aHR0cDovL2h0bWwyY2FudmFzLmhlcnR6ZW4uY29tPg0KICBDb3B5cmlnaHQgKGMpIDIwMTEgTmlrbGFzIHZvbiBIZXJ0emVuLiBBbGwgcmlnaHRzIHJlc2VydmVkLg0KICBodHRwOi8vd3d3LnR3aXR0ZXIuY29tL25pa2xhc3ZoDQoNCiAgUmVsZWFzZWQgdW5kZXIgTUlUIExpY2Vuc2UNCiAqLw0KInVzZSBzdHJpY3QiOw0KDQp2YXIgX2h0bWwyY2FudmFzID0ge30sDQpwcmV2aW91c0VsZW1lbnQsDQpjb21wdXRlZENTUywNCmh0bWwyY2FudmFzOw0KDQoNCmZ1bmN0aW9uIGgyY2xvZyhhKSB7DQogICAgaWYgKF9odG1sMmNhbnZhcy5sb2dnaW5nICYmIHdpbmRvdy5jb25zb2xlICYmIHdpbmRvdy5jb25zb2xlLmxvZykgew0KICAgICAgICB3aW5kb3cuY29uc29sZS5sb2coYSk7DQogICAgfQ0KfQ0KDQpfaHRtbDJjYW52YXMuVXRpbCA9IHt9Ow0KDQpfaHRtbDJjYW52YXMuVXRpbC5iYWNrZ3JvdW5kSW1hZ2UgPSBmdW5jdGlvbiAoc3JjKSB7DQoNCiAgICBpZiAoL2RhdGE6aW1hZ2VcLy4qO2Jhc2U2NCwvaS50ZXN0KCBzcmMgKSB8fCAvXigtd2Via2l0fC1tb3p8bGluZWFyLWdyYWRpZW50fC1vLSkvLnRlc3QoIHNyYyApKSB7DQogICAgICAgIHJldHVybiBzcmM7DQogICAgfQ0KDQogICAgaWYgKHNyYy50b0xvd2VyQ2FzZSgpLnN1YnN0ciggMCwgNSApID09PSAndXJsKCInKSB7DQogICAgICAgIHNyYyA9IHNyYy5zdWJzdHIoIDUgKTsNCiAgICAgICAgc3JjID0gc3JjLnN1YnN0ciggMCwgc3JjLmxlbmd0aCAtIDIgKTsNCiAgICB9IGVsc2Ugew0KICAgICAgICBzcmMgPSBzcmMuc3Vic3RyKCA0ICk7DQogICAgICAgIHNyYyA9IHNyYy5zdWJzdHIoIDAsIHNyYy5sZW5ndGggLSAxICk7DQogICAgfQ0KDQogICAgcmV0dXJuIHNyYzsNCn07DQoNCmZ1bmN0aW9uIGFkanVzdEJvdW5kcyhlbCwgYm94KSB7DQogICAgdmFyIHdpbiA9IGRvY3VtZW50LmRlZmF1bHRWaWV3Ow0KICAgIHZhciBkb2MgPSBlbC5vd25lckRvY3VtZW50Ow0KICAgIHZhciBib2R5ID0gZG9jLmJvZHk7DQogICAgdmFyIGRvY0VsZW0gPSBkb2MuZG9jdW1lbnRFbGVtZW50Ow0KICAgIHZhciBjbGllbnRUb3AgID0gZG9jRWxlbS5jbGllbnRUb3AgIHx8IGJvZHkuY2xpZW50VG9wICB8fCAwOw0KICAgIHZhciBjbGllbnRMZWZ0ID0gZG9jRWxlbS5jbGllbnRMZWZ0IHx8IGJvZHkuY2xpZW50TGVmdCB8fCAwOw0KICAgIHZhciBzY3JvbGxUb3AgID0gd2luLnBhZ2VZT2Zmc2V0IHx8IGRvY0VsZW0uc2Nyb2xsVG9wOw0KICAgIHZhciBzY3JvbGxMZWZ0ID0gd2luLnBhZ2VYT2Zmc2V0IHx8IGRvY0VsZW0uc2Nyb2xsTGVmdDsNCiAgICB2YXIgdG9wICA9IGJveC50b3AgICsgc2Nyb2xsVG9wICAtIGNsaWVudFRvcDsNCiAgICB2YXIgbGVmdCA9IGJveC5sZWZ0ICsgc2Nyb2xsTGVmdCAtIGNsaWVudExlZnQ7DQoNCiAgICByZXR1cm4gew0KICAgICAgICB0b3A6IHRvcCwNCiAgICAgICAgbGVmdDogbGVmdCwNCiAgICAgICAgYm90dG9tOiB0b3AgKyBib3guaGVpZ2h0LA0KICAgICAgICBoZWlnaHQ6IGJveC5oZWlnaHQsDQogICAgICAgIHdpZHRoOiBib3gud2lkdGgNCiAgICB9Ow0KfQ0KDQpfaHRtbDJjYW52YXMuVXRpbC5Cb3VuZHMgPSBmdW5jdGlvbiBnZXRCb3VuZHMgKGVsKSB7DQogICAgdmFyIGNsaWVudFJlY3QsDQogICAgYm91bmRzID0ge307DQoNCiAgICBpZiAoZWwuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KXsNCiAgICAgICAgcmV0dXJuIGFkanVzdEJvdW5kcyhlbCwgZWwuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkpOw0KICAgIH0NCn07DQoNCl9odG1sMmNhbnZhcy5VdGlsLmdldENTUyA9IGZ1bmN0aW9uIChlbCwgYXR0cmlidXRlKSB7DQogICAgLy8gcmV0dXJuICQoZWwpLmNzcyhhdHRyaWJ1dGUpOw0KDQogICAgdmFyIHZhbDsNCg0KICAgIGZ1bmN0aW9uIHRvUFgoIGF0dHJpYnV0ZSwgdmFsICkgew0KICAgICAgICB2YXIgcnNMZWZ0ID0gZWwucnVudGltZVN0eWxlICYmIGVsLnJ1bnRpbWVTdHlsZVsgYXR0cmlidXRlIF0sDQogICAgICAgIGxlZnQsDQogICAgICAgIHN0eWxlID0gZWwuc3R5bGU7DQoNCiAgICAgICAgLy8gQ2hlY2sgaWYgd2UgYXJlIG5vdCBkZWFsaW5nIHdpdGggcGl4ZWxzLCAoT3BlcmEgaGFzIGlzc3VlcyB3aXRoIHRoaXMpDQogICAgICAgIC8vIFBvcnRlZCBmcm9tIGpRdWVyeSBjc3MuanMNCiAgICAgICAgLy8gRnJvbSB0aGUgYXdlc29tZSBoYWNrIGJ5IERlYW4gRWR3YXJkcw0KICAgICAgICAvLyBodHRwOi8vZXJpay5lYWUubmV0L2FyY2hpdmVzLzIwMDcvMDcvMjcvMTguNTQuMTUvI2NvbW1lbnQtMTAyMjkxDQoNCiAgICAgICAgLy8gSWYgd2UncmUgbm90IGRlYWxpbmcgd2l0aCBhIHJlZ3VsYXIgcGl4ZWwgbnVtYmVyDQogICAgICAgIC8vIGJ1dCBhIG51bWJlciB0aGF0IGhhcyBhIHdlaXJkIGVuZGluZywgd2UgbmVlZCB0byBjb252ZXJ0IGl0IHRvIHBpeGVscw0KDQogICAgICAgIGlmICggIS9eLT9bMC05XStcLj9bMC05XSooPzpweCk/JC9pLnRlc3QoIHZhbCApICYmIC9eLT9cZC8udGVzdCggdmFsICkgKSB7DQoNCiAgICAgICAgICAgIC8vIFJlbWVtYmVyIHRoZSBvcmlnaW5hbCB2YWx1ZXMNCiAgICAgICAgICAgIGxlZnQgPSBzdHlsZS5sZWZ0Ow0KDQogICAgICAgICAgICAvLyBQdXQgaW4gdGhlIG5ldyB2YWx1ZXMgdG8gZ2V0IGEgY29tcHV0ZWQgdmFsdWUgb3V0DQogICAgICAgICAgICBpZiAoIHJzTGVmdCApIHsNCiAgICAgICAgICAgICAgICBlbC5ydW50aW1lU3R5bGUubGVmdCA9IGVsLmN1cnJlbnRTdHlsZS5sZWZ0Ow0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgc3R5bGUubGVmdCA9IGF0dHJpYnV0ZSA9PT0gImZvbnRTaXplIiA/ICIxZW0iIDogKHZhbCB8fCAwKTsNCiAgICAgICAgICAgIHZhbCA9IHN0eWxlLnBpeGVsTGVmdCArICJweCI7DQoNCiAgICAgICAgICAgIC8vIFJldmVydCB0aGUgY2hhbmdlZCB2YWx1ZXMNCiAgICAgICAgICAgIHN0eWxlLmxlZnQgPSBsZWZ0Ow0KICAgICAgICAgICAgaWYgKCByc0xlZnQgKSB7DQogICAgICAgICAgICAgICAgZWwucnVudGltZVN0eWxlLmxlZnQgPSByc0xlZnQ7DQogICAgICAgICAgICB9DQoNCiAgICAgICAgfQ0KDQogICAgICAgIGlmICghL14odGhpbnxtZWRpdW18dGhpY2spJC9pLnRlc3QoIHZhbCApKSB7DQogICAgICAgICAgICByZXR1cm4gTWF0aC5yb3VuZChwYXJzZUZsb2F0KCB2YWwgKSkgKyAicHgiOw0KICAgICAgICB9DQoNCiAgICAgICAgcmV0dXJuIHZhbDsNCg0KICAgIH0NCg0KDQogICAgaWYgKCB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZSApIHsNCiAgICAgICAgaWYgKCBwcmV2aW91c0VsZW1lbnQgIT09IGVsICkgew0KICAgICAgICAgICAgY29tcHV0ZWRDU1MgPSBkb2N1bWVudC5kZWZhdWx0Vmlldy5nZXRDb21wdXRlZFN0eWxlKGVsLCBudWxsKTsNCiAgICAgICAgfQ0KICAgICAgICB2YWwgPSBjb21wdXRlZENTU1sgYXR0cmlidXRlIF07DQoNCiAgICAgICAgaWYgKCBhdHRyaWJ1dGUgPT09ICJiYWNrZ3JvdW5kUG9zaXRpb24iICkgew0KDQogICAgICAgICAgICB2YWwgPSAodmFsLnNwbGl0KCIsIilbMF0gfHwgIjAgMCIpLnNwbGl0KCIgIik7DQoNCiAgICAgICAgICAgIHZhbFsgMCBdID0gKCB2YWxbMF0uaW5kZXhPZiggIiUiICkgPT09IC0xICkgPyB0b1BYKCAgYXR0cmlidXRlICsgIlgiLCB2YWxbIDAgXSApIDogdmFsWyAwIF07DQogICAgICAgICAgICB2YWxbIDEgXSA9ICggdmFsWzFdID09PSB1bmRlZmluZWQgKSA/IHZhbFswXSA6IHZhbFsxXTsgLy8gSUUgOSBkb2Vzbid0IHJldHVybiBkb3VibGUgZGlnaXQgYWx3YXlzDQogICAgICAgICAgICB2YWxbIDEgXSA9ICggdmFsWzFdLmluZGV4T2YoICIlIiApID09PSAtMSApID8gdG9QWCggIGF0dHJpYnV0ZSArICJZIiwgdmFsWyAxIF0gKSA6IHZhbFsgMSBdOw0KICAgICAgICB9DQoNCiAgICB9IGVsc2UgaWYgKCBlbC5jdXJyZW50U3R5bGUgKSB7DQogICAgICAgIC8vIElFIDk+DQogICAgICAgIGlmIChhdHRyaWJ1dGUgPT09ICJiYWNrZ3JvdW5kUG9zaXRpb24iKSB7DQogICAgICAgICAgICAvLyBPbGRlciBJRSB1c2VzIC14IGFuZCAteQ0KICAgICAgICAgICAgdmFsID0gWyB0b1BYKCAgYXR0cmlidXRlICsgIlgiLCBlbC5jdXJyZW50U3R5bGVbIGF0dHJpYnV0ZSArICJYIiBdICApLCB0b1BYKCAgYXR0cmlidXRlICsgIlkiLCBlbC5jdXJyZW50U3R5bGVbIGF0dHJpYnV0ZSArICJZIiBdICApIF07DQogICAgICAgIH0gZWxzZSB7DQoNCiAgICAgICAgICAgIHZhbCA9IHRvUFgoICBhdHRyaWJ1dGUsIGVsLmN1cnJlbnRTdHlsZVsgYXR0cmlidXRlIF0gICk7DQoNCiAgICAgICAgICAgIGlmICgvXihib3JkZXIpL2kudGVzdCggYXR0cmlidXRlICkgJiYgL14obWVkaXVtfHRoaW58dGhpY2spJC9pLnRlc3QoIHZhbCApKSB7DQogICAgICAgICAgICAgICAgc3dpdGNoICh2YWwpIHsNCiAgICAgICAgICAgICAgICAgICAgY2FzZSAidGhpbiI6DQogICAgICAgICAgICAgICAgICAgICAgICB2YWwgPSAiMXB4IjsNCiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgICAgICAgICBjYXNlICJtZWRpdW0iOg0KICAgICAgICAgICAgICAgICAgICAgICAgdmFsID0gIjBweCI7IC8vIHRoaXMgaXMgd3JvbmcsIGl0IHNob3VsZCBiZSAzcHggYnV0IElFIHVzZXMgbWVkaXVtIGZvciBubyBib3JkZXIgYXMgd2VsbC4uIFRPRE8gZmluZCBhIHdvcmsgYXJvdW5kDQogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgICAgICAgICAgY2FzZSAidGhpY2siOg0KICAgICAgICAgICAgICAgICAgICAgICAgdmFsID0gIjVweCI7DQogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9DQogICAgICAgIH0NCg0KDQoNCiAgICB9DQoNCg0KDQoNCiAgICByZXR1cm4gdmFsOw0KDQoNCg0KLy9yZXR1cm4gJChlbCkuY3NzKGF0dHJpYnV0ZSk7DQoNCg0KfTsNCg0KDQpfaHRtbDJjYW52YXMuVXRpbC5CYWNrZ3JvdW5kUG9zaXRpb24gPSBmdW5jdGlvbiAoIGVsLCBib3VuZHMsIGltYWdlICkgew0KICAgIC8vIFRPRE8gYWRkIHN1cHBvcnQgZm9yIG11bHRpIGltYWdlIGJhY2tncm91bmRzDQoNCiAgICB2YXIgYmdwb3NpdGlvbiA9ICBfaHRtbDJjYW52YXMuVXRpbC5nZXRDU1MoIGVsLCAiYmFja2dyb3VuZFBvc2l0aW9uIiApICwNCiAgICB0b3BQb3MsDQogICAgbGVmdCwNCiAgICBwZXJjZW50YWdlLA0KICAgIHZhbDsNCg0KICAgIGlmIChiZ3Bvc2l0aW9uLmxlbmd0aCA9PT0gMSl7DQogICAgICAgIHZhbCA9IGJncG9zaXRpb247DQoNCiAgICAgICAgYmdwb3NpdGlvbiA9IFtdOw0KDQogICAgICAgIGJncG9zaXRpb25bMF0gPSB2YWw7DQogICAgICAgIGJncG9zaXRpb25bMV0gPSB2YWw7DQogICAgfQ0KDQoNCg0KICAgIGlmIChiZ3Bvc2l0aW9uWzBdLnRvU3RyaW5nKCkuaW5kZXhPZigiJSIpICE9PSAtMSl7DQogICAgICAgIHBlcmNlbnRhZ2UgPSAocGFyc2VGbG9hdChiZ3Bvc2l0aW9uWzBdKS8xMDApOw0KICAgICAgICBsZWZ0ID0gICgoYm91bmRzLndpZHRoICogcGVyY2VudGFnZSktKGltYWdlLndpZHRoKnBlcmNlbnRhZ2UpKTsNCg0KICAgIH1lbHNlew0KICAgICAgICBsZWZ0ID0gcGFyc2VJbnQoYmdwb3NpdGlvblswXSwxMCk7DQogICAgfQ0KDQogICAgaWYgKGJncG9zaXRpb25bMV0udG9TdHJpbmcoKS5pbmRleE9mKCIlIikgIT09IC0xKXsNCg0KICAgICAgICBwZXJjZW50YWdlID0gKHBhcnNlRmxvYXQoYmdwb3NpdGlvblsxXSkvMTAwKTsNCiAgICAgICAgdG9wUG9zID0gICgoYm91bmRzLmhlaWdodCAqIHBlcmNlbnRhZ2UpLShpbWFnZS5oZWlnaHQqcGVyY2VudGFnZSkpOw0KICAgIH1lbHNlew0KICAgICAgICB0b3BQb3MgPSBwYXJzZUludChiZ3Bvc2l0aW9uWzFdLDEwKTsNCiAgICB9DQoNCg0KDQoNCiAgICByZXR1cm4gew0KICAgICAgICB0b3A6IHRvcFBvcywNCiAgICAgICAgbGVmdDogbGVmdA0KICAgIH07DQoNCn07DQoNCl9odG1sMmNhbnZhcy5VdGlsLkV4dGVuZCA9IGZ1bmN0aW9uIChvcHRpb25zLCBkZWZhdWx0cykgew0KICAgIGZvciAodmFyIGtleSBpbiBvcHRpb25zKSB7DQogICAgICAgIGlmIChvcHRpb25zLmhhc093blByb3BlcnR5KGtleSkpIHsNCiAgICAgICAgICAgIGRlZmF1bHRzW2tleV0gPSBvcHRpb25zW2tleV07DQogICAgICAgIH0NCiAgICB9DQogICAgcmV0dXJuIGRlZmF1bHRzOw0KfTsNCg0KDQovKg0KICogRGVyaXZlZCBmcm9tIGpRdWVyeS5jb250ZW50cygpDQogKiBDb3B5cmlnaHQgMjAxMCwgSm9obiBSZXNpZw0KICogRHVhbCBsaWNlbnNlZCB1bmRlciB0aGUgTUlUIG9yIEdQTCBWZXJzaW9uIDIgbGljZW5zZXMuDQogKiBodHRwOi8vanF1ZXJ5Lm9yZy9saWNlbnNlDQogKi8NCl9odG1sMmNhbnZhcy5VdGlsLkNoaWxkcmVuID0gZnVuY3Rpb24oIGVsZW0gKSB7DQoNCg0KICAgIHZhciBjaGlsZHJlbjsNCiAgICB0cnkgew0KDQogICAgICAgIGNoaWxkcmVuID0gKGVsZW0ubm9kZU5hbWUgJiYgZWxlbS5ub2RlTmFtZS50b1VwcGVyQ2FzZSgpID09PSAiSUZSQU1FIikgPw0KICAgICAgICBlbGVtLmNvbnRlbnREb2N1bWVudCB8fCBlbGVtLmNvbnRlbnRXaW5kb3cuZG9jdW1lbnQgOiAoZnVuY3Rpb24oIGFycmF5ICl7DQogICAgICAgICAgICB2YXIgcmV0ID0gW107DQoNCiAgICAgICAgICAgIGlmICggYXJyYXkgIT09IG51bGwgKSB7DQoNCiAgICAgICAgICAgICAgICAoZnVuY3Rpb24oIGZpcnN0LCBzZWNvbmQgKSB7DQogICAgICAgICAgICAgICAgICAgIHZhciBpID0gZmlyc3QubGVuZ3RoLA0KICAgICAgICAgICAgICAgICAgICBqID0gMDsNCg0KICAgICAgICAgICAgICAgICAgICBpZiAoIHR5cGVvZiBzZWNvbmQubGVuZ3RoID09PSAibnVtYmVyIiApIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoIHZhciBsID0gc2Vjb25kLmxlbmd0aDsgaiA8IGw7IGorKyApIHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaXJzdFsgaSsrIF0gPSBzZWNvbmRbIGogXTsNCiAgICAgICAgICAgICAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUgKCBzZWNvbmRbal0gIT09IHVuZGVmaW5lZCApIHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaXJzdFsgaSsrIF0gPSBzZWNvbmRbIGorKyBdOw0KICAgICAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICB9DQoNCiAgICAgICAgICAgICAgICAgICAgZmlyc3QubGVuZ3RoID0gaTsNCg0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmlyc3Q7DQogICAgICAgICAgICAgICAgfSkoIHJldCwgYXJyYXkgKTsNCg0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICByZXR1cm4gcmV0Ow0KICAgICAgICB9KSggZWxlbS5jaGlsZE5vZGVzICk7DQoNCiAgICB9IGNhdGNoIChleCkgew0KICAgICAgICBoMmNsb2coImh0bWwyY2FudmFzLlV0aWwuQ2hpbGRyZW4gZmFpbGVkIHdpdGggZXhjZXB0aW9uOiAiICsgZXgubWVzc2FnZSk7DQogICAgICAgIGNoaWxkcmVuID0gW107DQogICAgfQ0KICAgIHJldHVybiBjaGlsZHJlbjsNCn07DQoNCi8qDQogIGh0bWwyY2FudmFzIHYwLjM0IDxodHRwOi8vaHRtbDJjYW52YXMuaGVydHplbi5jb20+DQogIENvcHlyaWdodCAoYykgMjAxMSBOaWtsYXMgdm9uIEhlcnR6ZW4uIEFsbCByaWdodHMgcmVzZXJ2ZWQuDQogIGh0dHA6Ly93d3cudHdpdHRlci5jb20vbmlrbGFzdmgNCg0KICBDb250cmlidXRvcihzKToNCiAgICAgIE5pa2xhcyB2b24gSGVydHplbiA8aHR0cDovL3d3dy50d2l0dGVyLmNvbS9uaWtsYXN2aD4NCiAgICAgIEFuZHLDqSBGaWVkbGVyICAgICAgPGh0dHA6Ly93d3cudHdpdHRlci5jb20vc29ubmVua2lzdGU+DQoNCiAgUmVsZWFzZWQgdW5kZXIgTUlUIExpY2Vuc2UNCiAqLw0KDQooZnVuY3Rpb24oKXsNCg0KX2h0bWwyY2FudmFzLkdlbmVyYXRlID0ge307DQoNCnZhciByZUdyYWRpZW50cyA9IFsNCiAgICAvXigtd2Via2l0LWxpbmVhci1ncmFkaWVudClcKChbYS16XHNdKykoW1x3XGRcLlxzLCVcKFwpXSspXCkkLywNCiAgICAvXigtby1saW5lYXItZ3JhZGllbnQpXCgoW2EtelxzXSspKFtcd1xkXC5ccywlXChcKV0rKVwpJC8sDQogICAgL14oLXdlYmtpdC1ncmFkaWVudClcKChsaW5lYXJ8cmFkaWFsKSxccygoPzpcZHsxLDN9JT8pXHMoPzpcZHsxLDN9JT8pLFxzKD86XGR7MSwzfSU/KVxzKD86XGR7MSwzfSU/KSkoW1x3XGRcLlxzLCVcKFwpLV0rKVwpJC8sDQogICAgL14oLW1vei1saW5lYXItZ3JhZGllbnQpXCgoKD86XGR7MSwzfSU/KVxzKD86XGR7MSwzfSU/KSkoW1x3XGRcLlxzLCVcKFwpXSspXCkkLywNCiAgICAvXigtd2Via2l0LXJhZGlhbC1ncmFkaWVudClcKCgoPzpcZHsxLDN9JT8pXHMoPzpcZHsxLDN9JT8pKSxccyhcdyspXHMoW2Etei1dKykoW1x3XGRcLlxzLCVcKFwpXSspXCkkLywNCiAgICAvXigtbW96LXJhZGlhbC1ncmFkaWVudClcKCgoPzpcZHsxLDN9JT8pXHMoPzpcZHsxLDN9JT8pKSxccyhcdyspXHM/KFthLXotXSopKFtcd1xkXC5ccywlXChcKV0rKVwpJC8sDQogICAgL14oLW8tcmFkaWFsLWdyYWRpZW50KVwoKCg/OlxkezEsM30lPylccyg/OlxkezEsM30lPykpLFxzKFx3KylccyhbYS16LV0rKShbXHdcZFwuXHMsJVwoXCldKylcKSQvDQpdOw0KDQovKg0KICogVE9ETzogQWRkIElFMTAgdmVuZG9yIHByZWZpeCAoLW1zKSBzdXBwb3J0DQogKiBUT0RPOiBBZGQgVzNDIGdyYWRpZW50IChsaW5lYXItZ3JhZGllbnQpIHN1cHBvcnQNCiAqIFRPRE86IEFkZCBvbGQgV2Via2l0IC13ZWJraXQtZ3JhZGllbnQocmFkaWFsLCAuLi4pIHN1cHBvcnQNCiAqIFRPRE86IE1heWJlIHNvbWUgUmVnRXhwIG9wdGltaXphdGlvbnMgYXJlIHBvc3NpYmxlIDtvKQ0KICovDQpfaHRtbDJjYW52YXMuR2VuZXJhdGUucGFyc2VHcmFkaWVudCA9IGZ1bmN0aW9uKGNzcywgYm91bmRzKSB7DQogICAgdmFyIGdyYWRpZW50LCBpLCBsZW4gPSByZUdyYWRpZW50cy5sZW5ndGgsIG0xLCBzdG9wLCBtMiwgbTJMZW4sIHN0ZXAsIG0zOw0KDQogICAgZm9yKGkgPSAwOyBpIDwgbGVuOyBpKz0xKXsNCiAgICAgICAgbTEgPSBjc3MubWF0Y2gocmVHcmFkaWVudHNbaV0pOw0KICAgICAgICBpZihtMSkgYnJlYWs7DQogICAgfQ0KDQogICAgaWYobTEpIHsNCiAgICAgICAgc3dpdGNoKG0xWzFdKSB7DQogICAgICAgICAgICBjYXNlICctd2Via2l0LWxpbmVhci1ncmFkaWVudCc6DQogICAgICAgICAgICBjYXNlICctby1saW5lYXItZ3JhZGllbnQnOg0KDQogICAgICAgICAgICAgICAgZ3JhZGllbnQgPSB7DQogICAgICAgICAgICAgICAgICAgIHR5cGU6ICdsaW5lYXInLA0KICAgICAgICAgICAgICAgICAgICB4MDogbnVsbCwNCiAgICAgICAgICAgICAgICAgICAgeTA6IG51bGwsDQogICAgICAgICAgICAgICAgICAgIHgxOiBudWxsLA0KICAgICAgICAgICAgICAgICAgICB5MTogbnVsbCwNCiAgICAgICAgICAgICAgICAgICAgY29sb3JTdG9wczogW10NCiAgICAgICAgICAgICAgICB9Ow0KDQogICAgICAgICAgICAgICAgLy8gZ2V0IGNvb3JkaW5hdGVzDQogICAgICAgICAgICAgICAgbTIgPSBtMVsyXS5tYXRjaCgvXHcrL2cpOw0KICAgICAgICAgICAgICAgIGlmKG0yKXsNCiAgICAgICAgICAgICAgICAgICAgbTJMZW4gPSBtMi5sZW5ndGg7DQogICAgICAgICAgICAgICAgICAgIGZvcihpID0gMDsgaSA8IG0yTGVuOyBpKz0xKXsNCiAgICAgICAgICAgICAgICAgICAgICAgIHN3aXRjaChtMltpXSkgew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ3RvcCc6DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LnkwID0gMDsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQueTEgPSBib3VuZHMuaGVpZ2h0Ow0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsNCg0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ3JpZ2h0JzoNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQueDAgPSBib3VuZHMud2lkdGg7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LngxID0gMDsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7DQoNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdib3R0b20nOg0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBncmFkaWVudC55MCA9IGJvdW5kcy5oZWlnaHQ7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LnkxID0gMDsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7DQoNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdsZWZ0JzoNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQueDAgPSAwOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBncmFkaWVudC54MSA9IGJvdW5kcy53aWR0aDsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgaWYoZ3JhZGllbnQueDAgPT09IG51bGwgJiYgZ3JhZGllbnQueDEgPT09IG51bGwpeyAvLyBjZW50ZXINCiAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQueDAgPSBncmFkaWVudC54MSA9IGJvdW5kcy53aWR0aCAvIDI7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIGlmKGdyYWRpZW50LnkwID09PSBudWxsICYmIGdyYWRpZW50LnkxID09PSBudWxsKXsgLy8gY2VudGVyDQogICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LnkwID0gZ3JhZGllbnQueTEgPSBib3VuZHMuaGVpZ2h0IC8gMjsNCiAgICAgICAgICAgICAgICB9DQoNCiAgICAgICAgICAgICAgICAvLyBnZXQgY29sb3JzIGFuZCBzdG9wcw0KICAgICAgICAgICAgICAgIG0yID0gbTFbM10ubWF0Y2goLygoPzpyZ2J8cmdiYSlcKFxkezEsM30sXHNcZHsxLDN9LFxzXGR7MSwzfSg/Oixcc1swLTlcLl0rKT9cKSg/OlxzXGR7MSwzfSg/OiV8cHgpKT8pKy9nKTsNCiAgICAgICAgICAgICAgICBpZihtMil7DQogICAgICAgICAgICAgICAgICAgIG0yTGVuID0gbTIubGVuZ3RoOw0KICAgICAgICAgICAgICAgICAgICBzdGVwID0gMSAvIE1hdGgubWF4KG0yTGVuIC0gMSwgMSk7DQogICAgICAgICAgICAgICAgICAgIGZvcihpID0gMDsgaSA8IG0yTGVuOyBpKz0xKXsNCiAgICAgICAgICAgICAgICAgICAgICAgIG0zID0gbTJbaV0ubWF0Y2goLygoPzpyZ2J8cmdiYSlcKFxkezEsM30sXHNcZHsxLDN9LFxzXGR7MSwzfSg/Oixcc1swLTlcLl0rKT9cKSlccyooXGR7MSwzfSk/KCV8cHgpPy8pOw0KICAgICAgICAgICAgICAgICAgICAgICAgaWYobTNbMl0pew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0b3AgPSBwYXJzZUZsb2F0KG0zWzJdKTsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihtM1szXSA9PT0gJyUnKXsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RvcCAvPSAxMDA7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsgLy8gcHggLSBzdHVwaWQgb3BlcmENCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RvcCAvPSBib3VuZHMud2lkdGg7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdG9wID0gaSAqIHN0ZXA7DQogICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgICAgICBncmFkaWVudC5jb2xvclN0b3BzLnB1c2goew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yOiBtM1sxXSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdG9wOiBzdG9wDQogICAgICAgICAgICAgICAgICAgICAgICB9KTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICBicmVhazsNCg0KICAgICAgICAgICAgY2FzZSAnLXdlYmtpdC1ncmFkaWVudCc6DQoNCiAgICAgICAgICAgICAgICBncmFkaWVudCA9IHsNCiAgICAgICAgICAgICAgICAgICAgdHlwZTogbTFbMl0gPT09ICdyYWRpYWwnID8gJ2NpcmNsZScgOiBtMVsyXSwgLy8gVE9ETzogQWRkIHJhZGlhbCBncmFkaWVudCBzdXBwb3J0IGZvciBvbGRlciBtb3ppbGxhIGRlZmluaXRpb25zDQogICAgICAgICAgICAgICAgICAgIHgwOiAwLA0KICAgICAgICAgICAgICAgICAgICB5MDogMCwNCiAgICAgICAgICAgICAgICAgICAgeDE6IDAsDQogICAgICAgICAgICAgICAgICAgIHkxOiAwLA0KICAgICAgICAgICAgICAgICAgICBjb2xvclN0b3BzOiBbXQ0KICAgICAgICAgICAgICAgIH07DQoNCiAgICAgICAgICAgICAgICAvLyBnZXQgY29vcmRpbmF0ZXMNCiAgICAgICAgICAgICAgICBtMiA9IG0xWzNdLm1hdGNoKC8oXGR7MSwzfSklP1xzKFxkezEsM30pJT8sXHMoXGR7MSwzfSklP1xzKFxkezEsM30pJT8vKTsNCiAgICAgICAgICAgICAgICBpZihtMil7DQogICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LngwID0gKG0yWzFdICogYm91bmRzLndpZHRoKSAvIDEwMDsNCiAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQueTAgPSAobTJbMl0gKiBib3VuZHMuaGVpZ2h0KSAvIDEwMDsNCiAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQueDEgPSAobTJbM10gKiBib3VuZHMud2lkdGgpIC8gMTAwOw0KICAgICAgICAgICAgICAgICAgICBncmFkaWVudC55MSA9IChtMls0XSAqIGJvdW5kcy5oZWlnaHQpIC8gMTAwOw0KICAgICAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgICAgIC8vIGdldCBjb2xvcnMgYW5kIHN0b3BzDQogICAgICAgICAgICAgICAgbTIgPSBtMVs0XS5tYXRjaCgvKCg/OmZyb218dG98Y29sb3Itc3RvcClcKCg/OlswLTlcLl0rLFxzKT8oPzpyZ2J8cmdiYSlcKFxkezEsM30sXHNcZHsxLDN9LFxzXGR7MSwzfSg/Oixcc1swLTlcLl0rKT9cKVwpKSsvZyk7DQogICAgICAgICAgICAgICAgaWYobTIpew0KICAgICAgICAgICAgICAgICAgICBtMkxlbiA9IG0yLmxlbmd0aDsNCiAgICAgICAgICAgICAgICAgICAgZm9yKGkgPSAwOyBpIDwgbTJMZW47IGkrPTEpew0KICAgICAgICAgICAgICAgICAgICAgICAgbTMgPSBtMltpXS5tYXRjaCgvKGZyb218dG98Y29sb3Itc3RvcClcKChbMC05XC5dKyk/KD86LFxzKT8oKD86cmdifHJnYmEpXChcZHsxLDN9LFxzXGR7MSwzfSxcc1xkezEsM30oPzosXHNbMC05XC5dKyk/XCkpXCkvKTsNCiAgICAgICAgICAgICAgICAgICAgICAgIHN0b3AgPSBwYXJzZUZsb2F0KG0zWzJdKTsNCiAgICAgICAgICAgICAgICAgICAgICAgIGlmKG0zWzFdID09PSAnZnJvbScpIHN0b3AgPSAwLjA7DQogICAgICAgICAgICAgICAgICAgICAgICBpZihtM1sxXSA9PT0gJ3RvJykgc3RvcCA9IDEuMDsNCiAgICAgICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LmNvbG9yU3RvcHMucHVzaCh7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sb3I6IG0zWzNdLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0b3A6IHN0b3ANCiAgICAgICAgICAgICAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIGJyZWFrOw0KDQogICAgICAgICAgICBjYXNlICctbW96LWxpbmVhci1ncmFkaWVudCc6DQoNCiAgICAgICAgICAgICAgICBncmFkaWVudCA9IHsNCiAgICAgICAgICAgICAgICAgICAgdHlwZTogJ2xpbmVhcicsDQogICAgICAgICAgICAgICAgICAgIHgwOiAwLA0KICAgICAgICAgICAgICAgICAgICB5MDogMCwNCiAgICAgICAgICAgICAgICAgICAgeDE6IDAsDQogICAgICAgICAgICAgICAgICAgIHkxOiAwLA0KICAgICAgICAgICAgICAgICAgICBjb2xvclN0b3BzOiBbXQ0KICAgICAgICAgICAgICAgIH07DQoNCiAgICAgICAgICAgICAgICAvLyBnZXQgY29vcmRpbmF0ZXMNCiAgICAgICAgICAgICAgICBtMiA9IG0xWzJdLm1hdGNoKC8oXGR7MSwzfSklP1xzKFxkezEsM30pJT8vKTsNCg0KICAgICAgICAgICAgICAgIC8vIG0yWzFdID09IDAlICAgLT4gbGVmdA0KICAgICAgICAgICAgICAgIC8vIG0yWzFdID09IDUwJSAgLT4gY2VudGVyDQogICAgICAgICAgICAgICAgLy8gbTJbMV0gPT0gMTAwJSAtPiByaWdodA0KDQogICAgICAgICAgICAgICAgLy8gbTJbMl0gPT0gMCUgICAtPiB0b3ANCiAgICAgICAgICAgICAgICAvLyBtMlsyXSA9PSA1MCUgIC0+IGNlbnRlcg0KICAgICAgICAgICAgICAgIC8vIG0yWzJdID09IDEwMCUgLT4gYm90dG9tDQoNCiAgICAgICAgICAgICAgICBpZihtMil7DQogICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LngwID0gKG0yWzFdICogYm91bmRzLndpZHRoKSAvIDEwMDsNCiAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQueTAgPSAobTJbMl0gKiBib3VuZHMuaGVpZ2h0KSAvIDEwMDsNCiAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQueDEgPSBib3VuZHMud2lkdGggLSBncmFkaWVudC54MDsNCiAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQueTEgPSBib3VuZHMuaGVpZ2h0IC0gZ3JhZGllbnQueTA7DQogICAgICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAgICAgLy8gZ2V0IGNvbG9ycyBhbmQgc3RvcHMNCiAgICAgICAgICAgICAgICBtMiA9IG0xWzNdLm1hdGNoKC8oKD86cmdifHJnYmEpXChcZHsxLDN9LFxzXGR7MSwzfSxcc1xkezEsM30oPzosXHNbMC05XC5dKyk/XCkoPzpcc1xkezEsM30lKT8pKy9nKTsNCiAgICAgICAgICAgICAgICBpZihtMil7DQogICAgICAgICAgICAgICAgICAgIG0yTGVuID0gbTIubGVuZ3RoOw0KICAgICAgICAgICAgICAgICAgICBzdGVwID0gMSAvIE1hdGgubWF4KG0yTGVuIC0gMSwgMSk7DQogICAgICAgICAgICAgICAgICAgIGZvcihpID0gMDsgaSA8IG0yTGVuOyBpKz0xKXsNCiAgICAgICAgICAgICAgICAgICAgICAgIG0zID0gbTJbaV0ubWF0Y2goLygoPzpyZ2J8cmdiYSlcKFxkezEsM30sXHNcZHsxLDN9LFxzXGR7MSwzfSg/Oixcc1swLTlcLl0rKT9cKSlccyooXGR7MSwzfSk/KCUpPy8pOw0KICAgICAgICAgICAgICAgICAgICAgICAgaWYobTNbMl0pew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0b3AgPSBwYXJzZUZsb2F0KG0zWzJdKTsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihtM1szXSl7IC8vIHBlcmNlbnRhZ2UNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RvcCAvPSAxMDA7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdG9wID0gaSAqIHN0ZXA7DQogICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgICAgICBncmFkaWVudC5jb2xvclN0b3BzLnB1c2goew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yOiBtM1sxXSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdG9wOiBzdG9wDQogICAgICAgICAgICAgICAgICAgICAgICB9KTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICBicmVhazsNCg0KICAgICAgICAgICAgY2FzZSAnLXdlYmtpdC1yYWRpYWwtZ3JhZGllbnQnOg0KICAgICAgICAgICAgY2FzZSAnLW1vei1yYWRpYWwtZ3JhZGllbnQnOg0KICAgICAgICAgICAgY2FzZSAnLW8tcmFkaWFsLWdyYWRpZW50JzoNCg0KICAgICAgICAgICAgICAgIGdyYWRpZW50ID0gew0KICAgICAgICAgICAgICAgICAgICB0eXBlOiAnY2lyY2xlJywNCiAgICAgICAgICAgICAgICAgICAgeDA6IDAsDQogICAgICAgICAgICAgICAgICAgIHkwOiAwLA0KICAgICAgICAgICAgICAgICAgICB4MTogYm91bmRzLndpZHRoLA0KICAgICAgICAgICAgICAgICAgICB5MTogYm91bmRzLmhlaWdodCwNCiAgICAgICAgICAgICAgICAgICAgY3g6IDAsDQogICAgICAgICAgICAgICAgICAgIGN5OiAwLA0KICAgICAgICAgICAgICAgICAgICByeDogMCwNCiAgICAgICAgICAgICAgICAgICAgcnk6IDAsDQogICAgICAgICAgICAgICAgICAgIGNvbG9yU3RvcHM6IFtdDQogICAgICAgICAgICAgICAgfTsNCg0KICAgICAgICAgICAgICAgIC8vIGNlbnRlcg0KICAgICAgICAgICAgICAgIG0yID0gbTFbMl0ubWF0Y2goLyhcZHsxLDN9KSU/XHMoXGR7MSwzfSklPy8pOw0KICAgICAgICAgICAgICAgIGlmKG0yKXsNCiAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQuY3ggPSAobTJbMV0gKiBib3VuZHMud2lkdGgpIC8gMTAwOw0KICAgICAgICAgICAgICAgICAgICBncmFkaWVudC5jeSA9IChtMlsyXSAqIGJvdW5kcy5oZWlnaHQpIC8gMTAwOw0KICAgICAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgICAgIC8vIHNpemUNCiAgICAgICAgICAgICAgICBtMiA9IG0xWzNdLm1hdGNoKC9cdysvKTsNCiAgICAgICAgICAgICAgICBtMyA9IG0xWzRdLm1hdGNoKC9bYS16LV0qLyk7DQogICAgICAgICAgICAgICAgaWYobTIgJiYgbTMpew0KICAgICAgICAgICAgICAgICAgICBzd2l0Y2gobTNbMF0pew0KICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnZmFydGhlc3QtY29ybmVyJzoNCiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ2NvdmVyJzogLy8gaXMgZXF1aXZhbGVudCB0byBmYXJ0aGVzdC1jb3JuZXINCiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJyc6IC8vIG1vemlsbGEgcmVtb3ZlcyAiY292ZXIiIGZyb20gZGVmaW5pdGlvbiA6KA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0bCA9IE1hdGguc3FydChNYXRoLnBvdyhncmFkaWVudC5jeCwgMikgKyBNYXRoLnBvdyhncmFkaWVudC5jeSwgMikpOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0ciA9IE1hdGguc3FydChNYXRoLnBvdyhncmFkaWVudC5jeCwgMikgKyBNYXRoLnBvdyhncmFkaWVudC55MSAtIGdyYWRpZW50LmN5LCAyKSk7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGJyID0gTWF0aC5zcXJ0KE1hdGgucG93KGdyYWRpZW50LngxIC0gZ3JhZGllbnQuY3gsIDIpICsgTWF0aC5wb3coZ3JhZGllbnQueTEgLSBncmFkaWVudC5jeSwgMikpOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBibCA9IE1hdGguc3FydChNYXRoLnBvdyhncmFkaWVudC54MSAtIGdyYWRpZW50LmN4LCAyKSArIE1hdGgucG93KGdyYWRpZW50LmN5LCAyKSk7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQucnggPSBncmFkaWVudC5yeSA9IE1hdGgubWF4KHRsLCB0ciwgYnIsIGJsKTsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ2Nsb3Nlc3QtY29ybmVyJzoNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdGwgPSBNYXRoLnNxcnQoTWF0aC5wb3coZ3JhZGllbnQuY3gsIDIpICsgTWF0aC5wb3coZ3JhZGllbnQuY3ksIDIpKTsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdHIgPSBNYXRoLnNxcnQoTWF0aC5wb3coZ3JhZGllbnQuY3gsIDIpICsgTWF0aC5wb3coZ3JhZGllbnQueTEgLSBncmFkaWVudC5jeSwgMikpOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBiciA9IE1hdGguc3FydChNYXRoLnBvdyhncmFkaWVudC54MSAtIGdyYWRpZW50LmN4LCAyKSArIE1hdGgucG93KGdyYWRpZW50LnkxIC0gZ3JhZGllbnQuY3ksIDIpKTsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgYmwgPSBNYXRoLnNxcnQoTWF0aC5wb3coZ3JhZGllbnQueDEgLSBncmFkaWVudC5jeCwgMikgKyBNYXRoLnBvdyhncmFkaWVudC5jeSwgMikpOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LnJ4ID0gZ3JhZGllbnQucnkgPSBNYXRoLm1pbih0bCwgdHIsIGJyLCBibCk7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdmYXJ0aGVzdC1zaWRlJzoNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihtMlswXSA9PT0gJ2NpcmNsZScpew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBncmFkaWVudC5yeCA9IGdyYWRpZW50LnJ5ID0gTWF0aC5tYXgoDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBncmFkaWVudC5jeCwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LmN5LA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQueDEgLSBncmFkaWVudC5jeCwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LnkxIC0gZ3JhZGllbnQuY3kNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKTsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgeyAvLyBlbGxpcHNlDQoNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQudHlwZSA9IG0yWzBdOw0KDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LnJ4ID0gTWF0aC5tYXgoDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBncmFkaWVudC5jeCwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LngxIC0gZ3JhZGllbnQuY3gNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKTsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQucnkgPSBNYXRoLm1heCgNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LmN5LA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQueTEgLSBncmFkaWVudC5jeQ0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ2Nsb3Nlc3Qtc2lkZSc6DQogICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdjb250YWluJzogLy8gaXMgZXF1aXZhbGVudCB0byBjbG9zZXN0LXNpZGUNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihtMlswXSA9PT0gJ2NpcmNsZScpew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBncmFkaWVudC5yeCA9IGdyYWRpZW50LnJ5ID0gTWF0aC5taW4oDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBncmFkaWVudC5jeCwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LmN5LA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQueDEgLSBncmFkaWVudC5jeCwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LnkxIC0gZ3JhZGllbnQuY3kNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKTsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgeyAvLyBlbGxpcHNlDQoNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQudHlwZSA9IG0yWzBdOw0KDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LnJ4ID0gTWF0aC5taW4oDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBncmFkaWVudC5jeCwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LngxIC0gZ3JhZGllbnQuY3gNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKTsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQucnkgPSBNYXRoLm1pbigNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LmN5LA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQueTEgLSBncmFkaWVudC5jeQ0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsNCg0KICAgICAgICAgICAgICAgICAgICAgICAgLy8gVE9ETzogYWRkIHN1cHBvcnQgZm9yICIzMHB4IDQwcHgiIHNpemVzICh3ZWJraXQgb25seSkNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgICAgIC8vIGNvbG9yIHN0b3BzDQogICAgICAgICAgICAgICAgbTIgPSBtMVs1XS5tYXRjaCgvKCg/OnJnYnxyZ2JhKVwoXGR7MSwzfSxcc1xkezEsM30sXHNcZHsxLDN9KD86LFxzWzAtOVwuXSspP1wpKD86XHNcZHsxLDN9KD86JXxweCkpPykrL2cpOw0KICAgICAgICAgICAgICAgIGlmKG0yKXsNCiAgICAgICAgICAgICAgICAgICAgbTJMZW4gPSBtMi5sZW5ndGg7DQogICAgICAgICAgICAgICAgICAgIHN0ZXAgPSAxIC8gTWF0aC5tYXgobTJMZW4gLSAxLCAxKTsNCiAgICAgICAgICAgICAgICAgICAgZm9yKGkgPSAwOyBpIDwgbTJMZW47IGkrPTEpew0KICAgICAgICAgICAgICAgICAgICAgICAgbTMgPSBtMltpXS5tYXRjaCgvKCg/OnJnYnxyZ2JhKVwoXGR7MSwzfSxcc1xkezEsM30sXHNcZHsxLDN9KD86LFxzWzAtOVwuXSspP1wpKVxzKihcZHsxLDN9KT8oJXxweCk/Lyk7DQogICAgICAgICAgICAgICAgICAgICAgICBpZihtM1syXSl7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RvcCA9IHBhcnNlRmxvYXQobTNbMl0pOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKG0zWzNdID09PSAnJScpew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdG9wIC89IDEwMDsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgeyAvLyBweCAtIHN0dXBpZCBvcGVyYQ0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdG9wIC89IGJvdW5kcy53aWR0aDsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0b3AgPSBpICogc3RlcDsNCiAgICAgICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LmNvbG9yU3RvcHMucHVzaCh7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sb3I6IG0zWzFdLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0b3A6IHN0b3ANCiAgICAgICAgICAgICAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICB9DQogICAgfQ0KDQogICAgcmV0dXJuIGdyYWRpZW50Ow0KfTsNCg0KX2h0bWwyY2FudmFzLkdlbmVyYXRlLkdyYWRpZW50ID0gZnVuY3Rpb24oc3JjLCBib3VuZHMpIHsNCiAgICB2YXIgY2FudmFzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyksDQogICAgY3R4ID0gY2FudmFzLmdldENvbnRleHQoJzJkJyksDQogICAgZ3JhZGllbnQsIGdyYWQsIGksIGxlbiwgaW1nOw0KDQogICAgY2FudmFzLndpZHRoID0gYm91bmRzLndpZHRoOw0KICAgIGNhbnZhcy5oZWlnaHQgPSBib3VuZHMuaGVpZ2h0Ow0KDQogICAgLy8gVE9ETzogYWRkIHN1cHBvcnQgZm9yIG11bHRpIGRlZmluZWQgYmFja2dyb3VuZCBncmFkaWVudHMgKGxpa2UgcmFkaWFsIGdyYWRpZW50IGV4YW1wbGUgaW4gYmFja2dyb3VuZC5odG1sKQ0KICAgIGdyYWRpZW50ID0gX2h0bWwyY2FudmFzLkdlbmVyYXRlLnBhcnNlR3JhZGllbnQoc3JjLCBib3VuZHMpOw0KDQogICAgaW1nID0gbmV3IEltYWdlKCk7DQoNCiAgICBpZihncmFkaWVudCl7DQogICAgICAgIGlmKGdyYWRpZW50LnR5cGUgPT09ICdsaW5lYXInKXsNCiAgICAgICAgICAgIGdyYWQgPSBjdHguY3JlYXRlTGluZWFyR3JhZGllbnQoZ3JhZGllbnQueDAsIGdyYWRpZW50LnkwLCBncmFkaWVudC54MSwgZ3JhZGllbnQueTEpOw0KDQogICAgICAgICAgICBmb3IgKGkgPSAwLCBsZW4gPSBncmFkaWVudC5jb2xvclN0b3BzLmxlbmd0aDsgaSA8IGxlbjsgaSs9MSkgew0KICAgICAgICAgICAgICAgIHRyeSB7DQogICAgICAgICAgICAgICAgICAgIGdyYWQuYWRkQ29sb3JTdG9wKGdyYWRpZW50LmNvbG9yU3RvcHNbaV0uc3RvcCwgZ3JhZGllbnQuY29sb3JTdG9wc1tpXS5jb2xvcik7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIGNhdGNoKGUpIHsNCiAgICAgICAgICAgICAgICAgICAgaDJjbG9nKFsnZmFpbGVkIHRvIGFkZCBjb2xvciBzdG9wOiAnLCBlLCAnOyB0cmllZCB0byBhZGQ6ICcsIGdyYWRpZW50LmNvbG9yU3RvcHNbaV0sICc7IHN0b3A6ICcsIGksICc7IGluOiAnLCBzcmNdKTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIGN0eC5maWxsU3R5bGUgPSBncmFkOw0KICAgICAgICAgICAgY3R4LmZpbGxSZWN0KDAsIDAsIGJvdW5kcy53aWR0aCwgYm91bmRzLmhlaWdodCk7DQoNCiAgICAgICAgICAgIGltZy5zcmMgPSBjYW52YXMudG9EYXRhVVJMKCk7DQogICAgICAgIH0gZWxzZSBpZihncmFkaWVudC50eXBlID09PSAnY2lyY2xlJyl7DQoNCiAgICAgICAgICAgIGdyYWQgPSBjdHguY3JlYXRlUmFkaWFsR3JhZGllbnQoZ3JhZGllbnQuY3gsIGdyYWRpZW50LmN5LCAwLCBncmFkaWVudC5jeCwgZ3JhZGllbnQuY3ksIGdyYWRpZW50LnJ4KTsNCg0KICAgICAgICAgICAgZm9yIChpID0gMCwgbGVuID0gZ3JhZGllbnQuY29sb3JTdG9wcy5sZW5ndGg7IGkgPCBsZW47IGkrPTEpIHsNCiAgICAgICAgICAgICAgICB0cnkgew0KICAgICAgICAgICAgICAgICAgICBncmFkLmFkZENvbG9yU3RvcChncmFkaWVudC5jb2xvclN0b3BzW2ldLnN0b3AsIGdyYWRpZW50LmNvbG9yU3RvcHNbaV0uY29sb3IpOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICBjYXRjaChlKSB7DQogICAgICAgICAgICAgICAgICAgIGgyY2xvZyhbJ2ZhaWxlZCB0byBhZGQgY29sb3Igc3RvcDogJywgZSwgJzsgdHJpZWQgdG8gYWRkOiAnLCBncmFkaWVudC5jb2xvclN0b3BzW2ldLCAnOyBzdG9wOiAnLCBpLCAnOyBpbjogJywgc3JjXSk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gZ3JhZDsNCiAgICAgICAgICAgIGN0eC5maWxsUmVjdCgwLCAwLCBib3VuZHMud2lkdGgsIGJvdW5kcy5oZWlnaHQpOw0KDQogICAgICAgICAgICBpbWcuc3JjID0gY2FudmFzLnRvRGF0YVVSTCgpOw0KICAgICAgICB9IGVsc2UgaWYoZ3JhZGllbnQudHlwZSA9PT0gJ2VsbGlwc2UnKXsNCg0KICAgICAgICAgICAgLy8gZHJhdyBjaXJjbGUNCiAgICAgICAgICAgIHZhciBjYW52YXNSYWRpYWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKSwNCiAgICAgICAgICAgICAgICBjdHhSYWRpYWwgPSBjYW52YXNSYWRpYWwuZ2V0Q29udGV4dCgnMmQnKSwNCiAgICAgICAgICAgICAgICByaSA9IE1hdGgubWF4KGdyYWRpZW50LnJ4LCBncmFkaWVudC5yeSksDQogICAgICAgICAgICAgICAgZGkgPSByaSAqIDIsIGltZ1JhZGlhbDsNCg0KICAgICAgICAgICAgY2FudmFzUmFkaWFsLndpZHRoID0gY2FudmFzUmFkaWFsLmhlaWdodCA9IGRpOw0KDQogICAgICAgICAgICBncmFkID0gY3R4UmFkaWFsLmNyZWF0ZVJhZGlhbEdyYWRpZW50KGdyYWRpZW50LnJ4LCBncmFkaWVudC5yeSwgMCwgZ3JhZGllbnQucngsIGdyYWRpZW50LnJ5LCByaSk7DQoNCiAgICAgICAgICAgIGZvciAoaSA9IDAsIGxlbiA9IGdyYWRpZW50LmNvbG9yU3RvcHMubGVuZ3RoOyBpIDwgbGVuOyBpKz0xKSB7DQogICAgICAgICAgICAgICAgdHJ5IHsNCiAgICAgICAgICAgICAgICAgICAgZ3JhZC5hZGRDb2xvclN0b3AoZ3JhZGllbnQuY29sb3JTdG9wc1tpXS5zdG9wLCBncmFkaWVudC5jb2xvclN0b3BzW2ldLmNvbG9yKTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgY2F0Y2goZSkgew0KICAgICAgICAgICAgICAgICAgICBoMmNsb2coWydmYWlsZWQgdG8gYWRkIGNvbG9yIHN0b3A6ICcsIGUsICc7IHRyaWVkIHRvIGFkZDogJywgZ3JhZGllbnQuY29sb3JTdG9wc1tpXSwgJzsgc3RvcDogJywgaSwgJzsgaW46ICcsIHNyY10pOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgY3R4UmFkaWFsLmZpbGxTdHlsZSA9IGdyYWQ7DQogICAgICAgICAgICBjdHhSYWRpYWwuZmlsbFJlY3QoMCwgMCwgZGksIGRpKTsNCg0KICAgICAgICAgICAgY3R4LmZpbGxTdHlsZSA9IGdyYWRpZW50LmNvbG9yU3RvcHNbaSAtIDFdLmNvbG9yOw0KICAgICAgICAgICAgY3R4LmZpbGxSZWN0KDAsIDAsIGNhbnZhcy53aWR0aCwgY2FudmFzLmhlaWdodCk7DQoNCiAgICAgICAgICAgIGltZ1JhZGlhbCA9IG5ldyBJbWFnZSgpOw0KICAgICAgICAgICAgaW1nUmFkaWFsLm9ubG9hZCA9IGZ1bmN0aW9uKCkgeyAvLyB3YWl0IHVudGlsIHRoZSBpbWFnZSBpcyBmaWxsZWQNCg0KICAgICAgICAgICAgICAgIC8vIHRyYW5zZm9ybSBjaXJjbGUgdG8gZWxsaXBzZQ0KICAgICAgICAgICAgICAgIGN0eC5kcmF3SW1hZ2UoaW1nUmFkaWFsLCBncmFkaWVudC5jeCAtIGdyYWRpZW50LnJ4LCBncmFkaWVudC5jeSAtIGdyYWRpZW50LnJ5LCAyICogZ3JhZGllbnQucngsIDIgKiBncmFkaWVudC5yeSk7DQoNCiAgICAgICAgICAgICAgICBpbWcuc3JjID0gY2FudmFzLnRvRGF0YVVSTCgpOw0KDQogICAgICAgICAgICB9DQogICAgICAgICAgICBpbWdSYWRpYWwuc3JjID0gY2FudmFzUmFkaWFsLnRvRGF0YVVSTCgpOw0KICAgICAgICB9DQogICAgfQ0KDQogICAgcmV0dXJuIGltZzsNCn07DQoNCl9odG1sMmNhbnZhcy5HZW5lcmF0ZS5MaXN0QWxwaGEgPSBmdW5jdGlvbihudW1iZXIpIHsNCiAgICB2YXIgdG1wID0gIiIsDQogICAgbW9kdWx1czsNCg0KICAgIGRvIHsNCiAgICAgICAgbW9kdWx1cyA9IG51bWJlciAlIDI2Ow0KICAgICAgICB0bXAgPSBTdHJpbmcuZnJvbUNoYXJDb2RlKChtb2R1bHVzKSArIDY0KSArIHRtcDsNCiAgICAgICAgbnVtYmVyID0gbnVtYmVyIC8gMjY7DQogICAgfXdoaWxlKChudW1iZXIqMjYpID4gMjYpOw0KDQogICAgcmV0dXJuIHRtcDsNCn07DQoNCl9odG1sMmNhbnZhcy5HZW5lcmF0ZS5MaXN0Um9tYW4gPSBmdW5jdGlvbihudW1iZXIpIHsNCiAgICB2YXIgcm9tYW5BcnJheSA9IFsiTSIsICJDTSIsICJEIiwgIkNEIiwgIkMiLCAiWEMiLCAiTCIsICJYTCIsICJYIiwgIklYIiwgIlYiLCAiSVYiLCAiSSJdLA0KICAgIGRlY2ltYWwgPSBbMTAwMCwgOTAwLCA1MDAsIDQwMCwgMTAwLCA5MCwgNTAsIDQwLCAxMCwgOSwgNSwgNCwgMV0sDQogICAgcm9tYW4gPSAiIiwNCiAgICB2LA0KICAgIGxlbiA9IHJvbWFuQXJyYXkubGVuZ3RoOw0KDQogICAgaWYgKG51bWJlciA8PSAwIHx8IG51bWJlciA+PSA0MDAwKSB7DQogICAgICAgIHJldHVybiBudW1iZXI7DQogICAgfQ0KDQogICAgZm9yICh2PTA7IHYgPCBsZW47IHYrPTEpIHsNCiAgICAgICAgd2hpbGUgKG51bWJlciA+PSBkZWNpbWFsW3ZdKSB7DQogICAgICAgICAgICBudW1iZXIgLT0gZGVjaW1hbFt2XTsNCiAgICAgICAgICAgIHJvbWFuICs9IHJvbWFuQXJyYXlbdl07DQogICAgICAgIH0NCiAgICB9DQoNCiAgICByZXR1cm4gcm9tYW47DQoNCn07DQoNCn0pKCk7DQovKg0KICBodG1sMmNhbnZhcyB2MC4zNCA8aHR0cDovL2h0bWwyY2FudmFzLmhlcnR6ZW4uY29tPg0KICBDb3B5cmlnaHQgKGMpIDIwMTEgTmlrbGFzIHZvbiBIZXJ0emVuLiBBbGwgcmlnaHRzIHJlc2VydmVkLg0KICBodHRwOi8vd3d3LnR3aXR0ZXIuY29tL25pa2xhc3ZoDQoNCiAgUmVsZWFzZWQgdW5kZXIgTUlUIExpY2Vuc2UNCiovDQoNCi8qDQogKiAgTmV3IGZ1bmN0aW9uIGZvciB0cmF2ZXJzaW5nIGVsZW1lbnRzDQogKi8NCg0KX2h0bWwyY2FudmFzLlBhcnNlID0gZnVuY3Rpb24gKCBpbWFnZXMsIG9wdGlvbnMgKSB7DQoNCiAgICB2YXIgc3VwcG9ydCA9IHsNCiAgICAgICAgcmFuZ2VCb3VuZHM6IGZhbHNlLA0KICAgICAgICBzdmdSZW5kZXJpbmc6IG9wdGlvbnMuc3ZnUmVuZGVyaW5nICYmIChmdW5jdGlvbiggKXsNCiAgICAgICAgICAgIHZhciBpbWcgPSBuZXcgSW1hZ2UoKSwNCiAgICAgICAgICAgIGNhbnZhcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImNhbnZhcyIpLA0KICAgICAgICAgICAgY3R4ID0gKGNhbnZhcy5nZXRDb250ZXh0ID09PSB1bmRlZmluZWQpID8gZmFsc2UgOiBjYW52YXMuZ2V0Q29udGV4dCgiMmQiKTsNCiAgICAgICAgICAgIGlmIChjdHggPT09IGZhbHNlKSB7DQogICAgICAgICAgICAgICAgLy8gYnJvd3NlciBkb2Vzbid0IHN1cHBvcnQgY2FudmFzLCBnb29kIGx1Y2sgc3VwcG9ydGluZyBTVkcgb24gY2FudmFzDQogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgY2FudmFzLndpZHRoID0gY2FudmFzLmhlaWdodCA9IDEwOw0KICAgICAgICAgICAgaW1nLnNyYyA9IFsNCiAgICAgICAgICAgICJkYXRhOmltYWdlL3N2Zyt4bWwsIiwNCiAgICAgICAgICAgICI8c3ZnIHhtbG5zPSdodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2Zycgd2lkdGg9JzEwJyBoZWlnaHQ9JzEwJz4iLA0KICAgICAgICAgICAgIjxmb3JlaWduT2JqZWN0IHdpZHRoPScxMCcgaGVpZ2h0PScxMCc+IiwNCiAgICAgICAgICAgICI8ZGl2IHhtbG5zPSdodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hodG1sJyBzdHlsZT0nd2lkdGg6MTA7aGVpZ2h0OjEwOyc+IiwNCiAgICAgICAgICAgICJzdXAiLA0KICAgICAgICAgICAgIjwvZGl2PiIsDQogICAgICAgICAgICAiPC9mb3JlaWduT2JqZWN0PiIsDQogICAgICAgICAgICAiPC9zdmc+Ig0KICAgICAgICAgICAgXS5qb2luKCIiKTsNCiAgICAgICAgICAgIHRyeSB7DQogICAgICAgICAgICAgICAgY3R4LmRyYXdJbWFnZShpbWcsIDAsIDApOw0KICAgICAgICAgICAgICAgIGNhbnZhcy50b0RhdGFVUkwoKTsNCiAgICAgICAgICAgIH0gY2F0Y2goZSkgew0KICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGgyY2xvZygnaHRtbDJjYW52YXM6IFBhcnNlOiBTVkcgcG93ZXJlZCByZW5kZXJpbmcgYXZhaWxhYmxlJyk7DQogICAgICAgICAgICByZXR1cm4gdHJ1ZTsNCg0KICAgICAgICB9KSgpDQogICAgfSwNCiAgICBlbGVtZW50ID0gKCggb3B0aW9ucy5lbGVtZW50cyA9PT0gdW5kZWZpbmVkICkgPyBkb2N1bWVudC5ib2R5IDogb3B0aW9ucy5lbGVtZW50c1swXSksIC8vIHNlbGVjdCBib2R5IGJ5IGRlZmF1bHQNCiAgICBuZWVkUmVvcmRlciA9IGZhbHNlLA0KICAgIG51bURyYXdzID0gMCwNCiAgICBmb250RGF0YSA9IHt9LA0KICAgIGRvYyA9IGVsZW1lbnQub3duZXJEb2N1bWVudCwNCiAgICBpZ25vcmVFbGVtZW50c1JlZ0V4cCA9IG5ldyBSZWdFeHAoIigiICsgb3B0aW9ucy5pZ25vcmVFbGVtZW50cyArICIpIiksDQogICAgYm9keSA9IGRvYy5ib2R5LA0KICAgIHIsDQogICAgdGVzdEVsZW1lbnQsDQogICAgcmFuZ2VCb3VuZHMsDQogICAgcmFuZ2VIZWlnaHQsDQogICAgc3RhY2ssDQogICAgY3R4LA0KICAgIGRvY0RpbSwNCiAgICBpLA0KICAgIGNoaWxkcmVuLA0KICAgIGNoaWxkcmVuTGVuOw0KDQoNCiAgICBmdW5jdGlvbiBkb2NTaXplKCl7DQoNCiAgICAgICAgcmV0dXJuIHsNCiAgICAgICAgICAgIHdpZHRoOiBNYXRoLm1heCgNCiAgICAgICAgICAgICAgICBNYXRoLm1heChkb2MuYm9keS5zY3JvbGxXaWR0aCwgZG9jLmRvY3VtZW50RWxlbWVudC5zY3JvbGxXaWR0aCksDQogICAgICAgICAgICAgICAgTWF0aC5tYXgoZG9jLmJvZHkub2Zmc2V0V2lkdGgsIGRvYy5kb2N1bWVudEVsZW1lbnQub2Zmc2V0V2lkdGgpLA0KICAgICAgICAgICAgICAgIE1hdGgubWF4KGRvYy5ib2R5LmNsaWVudFdpZHRoLCBkb2MuZG9jdW1lbnRFbGVtZW50LmNsaWVudFdpZHRoKQ0KICAgICAgICAgICAgICAgICksDQogICAgICAgICAgICBoZWlnaHQ6IE1hdGgubWF4KA0KICAgICAgICAgICAgICAgIE1hdGgubWF4KGRvYy5ib2R5LnNjcm9sbEhlaWdodCwgZG9jLmRvY3VtZW50RWxlbWVudC5zY3JvbGxIZWlnaHQpLA0KICAgICAgICAgICAgICAgIE1hdGgubWF4KGRvYy5ib2R5Lm9mZnNldEhlaWdodCwgZG9jLmRvY3VtZW50RWxlbWVudC5vZmZzZXRIZWlnaHQpLA0KICAgICAgICAgICAgICAgIE1hdGgubWF4KGRvYy5ib2R5LmNsaWVudEhlaWdodCwgZG9jLmRvY3VtZW50RWxlbWVudC5jbGllbnRIZWlnaHQpDQogICAgICAgICAgICAgICAgKQ0KICAgICAgICB9Ow0KDQogICAgfQ0KDQogICAgaW1hZ2VzID0gaW1hZ2VzIHx8IHt9Ow0KDQogICAgLy8gVGVzdCB3aGV0aGVyIHdlIGNhbiB1c2UgcmFuZ2VzIHRvIG1lYXN1cmUgYm91bmRpbmcgYm94ZXMNCiAgICAvLyBPcGVyYSBkb2Vzbid0IHByb3ZpZGUgdmFsaWQgYm91bmRzLmhlaWdodC9ib3R0b20gZXZlbiB0aG91Z2ggaXQgc3VwcG9ydHMgdGhlIG1ldGhvZC4NCg0KDQogICAgaWYgKGRvYy5jcmVhdGVSYW5nZSkgew0KICAgICAgICByID0gZG9jLmNyZWF0ZVJhbmdlKCk7DQogICAgICAgIC8vdGhpcy5zdXBwb3J0LnJhbmdlQm91bmRzID0gbmV3IEJvb2xlYW4oci5nZXRCb3VuZGluZ0NsaWVudFJlY3QpOw0KICAgICAgICBpZiAoci5nZXRCb3VuZGluZ0NsaWVudFJlY3Qpew0KICAgICAgICAgICAgdGVzdEVsZW1lbnQgPSBkb2MuY3JlYXRlRWxlbWVudCgnYm91bmR0ZXN0Jyk7DQogICAgICAgICAgICB0ZXN0RWxlbWVudC5zdHlsZS5oZWlnaHQgPSAiMTIzcHgiOw0KICAgICAgICAgICAgdGVzdEVsZW1lbnQuc3R5bGUuZGlzcGxheSA9ICJibG9jayI7DQogICAgICAgICAgICBib2R5LmFwcGVuZENoaWxkKHRlc3RFbGVtZW50KTsNCg0KICAgICAgICAgICAgci5zZWxlY3ROb2RlKHRlc3RFbGVtZW50KTsNCiAgICAgICAgICAgIHJhbmdlQm91bmRzID0gci5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsNCiAgICAgICAgICAgIHJhbmdlSGVpZ2h0ID0gcmFuZ2VCb3VuZHMuaGVpZ2h0Ow0KDQogICAgICAgICAgICBpZiAocmFuZ2VIZWlnaHQgPT09IDEyMykgew0KICAgICAgICAgICAgICAgIHN1cHBvcnQucmFuZ2VCb3VuZHMgPSB0cnVlOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgYm9keS5yZW1vdmVDaGlsZCh0ZXN0RWxlbWVudCk7DQoNCg0KICAgICAgICB9DQoNCiAgICB9DQoNCg0KICAgIC8qDQogICAgdmFyIHJvb3RTdGFjayA9IG5ldyB0aGlzLnN0b3JhZ2VDb250ZXh0KCQoZG9jdW1lbnQpLndpZHRoKCksJChkb2N1bWVudCkuaGVpZ2h0KCkpOw0KICAgIHJvb3RTdGFjay5vcGFjaXR5ID0gdGhpcy5nZXRDU1ModGhpcy5lbGVtZW50LCJvcGFjaXR5Iik7DQogICAgdmFyIHN0YWNrID0gdGhpcy5uZXdFbGVtZW50KHRoaXMuZWxlbWVudCxyb290U3RhY2spOw0KDQoNCiAgICB0aGlzLnBhcnNlRWxlbWVudCh0aGlzLmVsZW1lbnQsc3RhY2spOw0KICAgICAqLw0KDQoNCg0KDQogICAgdmFyIGdldENTUyA9IF9odG1sMmNhbnZhcy5VdGlsLmdldENTUzsNCiAgICBmdW5jdGlvbiBnZXRDU1NJbnQoZWxlbWVudCwgYXR0cmlidXRlKSB7DQogICAgICAgIHZhciB2YWwgPSBwYXJzZUludChnZXRDU1MoZWxlbWVudCwgYXR0cmlidXRlKSwgMTApOw0KICAgICAgICByZXR1cm4gKGlzTmFOKHZhbCkpID8gMCA6IHZhbDsgLy8gYm9yZGVycyBpbiBvbGQgSUUgYXJlIHRocm93aW5nICdtZWRpdW0nIGZvciBkZW1vLmh0bWwNCiAgICB9DQoNCiAgICAvLyBEcmF3aW5nIGEgcmVjdGFuZ2xlDQogICAgZnVuY3Rpb24gcmVuZGVyUmVjdCAoY3R4LCB4LCB5LCB3LCBoLCBiZ2NvbG9yKSB7DQogICAgICAgIGlmIChiZ2NvbG9yICE9PSJ0cmFuc3BhcmVudCIpew0KICAgICAgICAgICAgY3R4LnNldFZhcmlhYmxlKCJmaWxsU3R5bGUiLCBiZ2NvbG9yKTsNCiAgICAgICAgICAgIGN0eC5maWxsUmVjdCAoeCwgeSwgdywgaCk7DQogICAgICAgICAgICBudW1EcmF3cys9MTsNCiAgICAgICAgfQ0KICAgIH0NCg0KDQogICAgZnVuY3Rpb24gdGV4dFRyYW5zZm9ybSAodGV4dCwgdHJhbnNmb3JtKSB7DQogICAgICAgIHN3aXRjaCh0cmFuc2Zvcm0pew0KICAgICAgICAgICAgY2FzZSAibG93ZXJjYXNlIjoNCiAgICAgICAgICAgICAgICByZXR1cm4gdGV4dC50b0xvd2VyQ2FzZSgpOw0KDQogICAgICAgICAgICBjYXNlICJjYXBpdGFsaXplIjoNCiAgICAgICAgICAgICAgICByZXR1cm4gdGV4dC5yZXBsYWNlKCAvKF58XHN8OnwtfFwofFwpKShbYS16XSkvZyAsIGZ1bmN0aW9uIChtLCBwMSwgcDIpIHsNCiAgICAgICAgICAgICAgICAgICAgaWYgKG0ubGVuZ3RoID4gMCkgew0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHAxICsgcDIudG9VcHBlckNhc2UoKTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH0gKTsNCg0KICAgICAgICAgICAgY2FzZSAidXBwZXJjYXNlIjoNCiAgICAgICAgICAgICAgICByZXR1cm4gdGV4dC50b1VwcGVyQ2FzZSgpOw0KDQogICAgICAgICAgICBkZWZhdWx0Og0KICAgICAgICAgICAgICAgIHJldHVybiB0ZXh0Ow0KDQogICAgICAgIH0NCg0KICAgIH0NCg0KICAgIGZ1bmN0aW9uIHRyaW1UZXh0ICh0ZXh0KSB7DQogICAgICAgIHJldHVybiB0ZXh0LnJlcGxhY2UoL15ccyovZywgIiIpLnJlcGxhY2UoL1xzKiQvZywgIiIpOw0KICAgIH0NCg0KICAgIGZ1bmN0aW9uIGZvbnRNZXRyaWNzIChmb250LCBmb250U2l6ZSkgew0KDQogICAgICAgIGlmIChmb250RGF0YVtmb250ICsgIi0iICsgZm9udFNpemVdICE9PSB1bmRlZmluZWQpIHsNCiAgICAgICAgICAgIHJldHVybiBmb250RGF0YVtmb250ICsgIi0iICsgZm9udFNpemVdOw0KICAgICAgICB9DQoNCg0KICAgICAgICB2YXIgY29udGFpbmVyID0gZG9jLmNyZWF0ZUVsZW1lbnQoJ2RpdicpLA0KICAgICAgICBpbWcgPSBkb2MuY3JlYXRlRWxlbWVudCgnaW1nJyksDQogICAgICAgIHNwYW4gPSBkb2MuY3JlYXRlRWxlbWVudCgnc3BhbicpLA0KICAgICAgICBiYXNlbGluZSwNCiAgICAgICAgbWlkZGxlLA0KICAgICAgICBtZXRyaWNzT2JqOw0KDQoNCiAgICAgICAgY29udGFpbmVyLnN0eWxlLnZpc2liaWxpdHkgPSAiaGlkZGVuIjsNCiAgICAgICAgY29udGFpbmVyLnN0eWxlLmZvbnRGYW1pbHkgPSBmb250Ow0KICAgICAgICBjb250YWluZXIuc3R5bGUuZm9udFNpemUgPSBmb250U2l6ZTsNCiAgICAgICAgY29udGFpbmVyLnN0eWxlLm1hcmdpbiA9IDA7DQogICAgICAgIGNvbnRhaW5lci5zdHlsZS5wYWRkaW5nID0gMDsNCg0KICAgICAgICBib2R5LmFwcGVuZENoaWxkKGNvbnRhaW5lcik7DQoNCg0KDQogICAgICAgIC8vIGh0dHA6Ly9wcm9iYWJseXByb2dyYW1taW5nLmNvbS8yMDA5LzAzLzE1L3RoZS10aW5pZXN0LWdpZi1ldmVyIChoYW5kdGlueXdoaXRlLmdpZikNCiAgICAgICAgaW1nLnNyYyA9ICJkYXRhOmltYWdlL2dpZjtiYXNlNjQsUjBsR09EbGhBUUFCQUlBQkFQLy8vd0FBQUN3QUFBQUFBUUFCQUFBQ0FrUUJBRHM9IjsNCiAgICAgICAgaW1nLndpZHRoID0gMTsNCiAgICAgICAgaW1nLmhlaWdodCA9IDE7DQoNCiAgICAgICAgaW1nLnN0eWxlLm1hcmdpbiA9IDA7DQogICAgICAgIGltZy5zdHlsZS5wYWRkaW5nID0gMDsNCiAgICAgICAgaW1nLnN0eWxlLnZlcnRpY2FsQWxpZ24gPSAiYmFzZWxpbmUiOw0KDQogICAgICAgIHNwYW4uc3R5bGUuZm9udEZhbWlseSA9IGZvbnQ7DQogICAgICAgIHNwYW4uc3R5bGUuZm9udFNpemUgPSBmb250U2l6ZTsNCiAgICAgICAgc3Bhbi5zdHlsZS5tYXJnaW4gPSAwOw0KICAgICAgICBzcGFuLnN0eWxlLnBhZGRpbmcgPSAwOw0KDQoNCg0KDQogICAgICAgIHNwYW4uYXBwZW5kQ2hpbGQoZG9jLmNyZWF0ZVRleHROb2RlKCdIaWRkZW4gVGV4dCcpKTsNCiAgICAgICAgY29udGFpbmVyLmFwcGVuZENoaWxkKHNwYW4pOw0KICAgICAgICBjb250YWluZXIuYXBwZW5kQ2hpbGQoaW1nKTsNCiAgICAgICAgYmFzZWxpbmUgPSAoaW1nLm9mZnNldFRvcCAtIHNwYW4ub2Zmc2V0VG9wKSArIDE7DQoNCiAgICAgICAgY29udGFpbmVyLnJlbW92ZUNoaWxkKHNwYW4pOw0KICAgICAgICBjb250YWluZXIuYXBwZW5kQ2hpbGQoZG9jLmNyZWF0ZVRleHROb2RlKCdIaWRkZW4gVGV4dCcpKTsNCg0KICAgICAgICBjb250YWluZXIuc3R5bGUubGluZUhlaWdodCA9ICJub3JtYWwiOw0KICAgICAgICBpbWcuc3R5bGUudmVydGljYWxBbGlnbiA9ICJzdXBlciI7DQoNCiAgICAgICAgbWlkZGxlID0gKGltZy5vZmZzZXRUb3AtY29udGFpbmVyLm9mZnNldFRvcCkgKyAxOw0KICAgICAgICBtZXRyaWNzT2JqID0gew0KICAgICAgICAgICAgYmFzZWxpbmU6IGJhc2VsaW5lLA0KICAgICAgICAgICAgbGluZVdpZHRoOiAxLA0KICAgICAgICAgICAgbWlkZGxlOiBtaWRkbGUNCiAgICAgICAgfTsNCg0KDQogICAgICAgIGZvbnREYXRhW2ZvbnQgKyAiLSIgKyBmb250U2l6ZV0gPSBtZXRyaWNzT2JqOw0KDQogICAgICAgIGJvZHkucmVtb3ZlQ2hpbGQoY29udGFpbmVyKTsNCg0KICAgICAgICByZXR1cm4gbWV0cmljc09iajsNCg0KICAgIH0NCg0KDQogICAgZnVuY3Rpb24gZHJhd1RleHQoY3VycmVudFRleHQsIHgsIHksIGN0eCl7DQogICAgICAgIGlmICh0cmltVGV4dChjdXJyZW50VGV4dCkubGVuZ3RoPjApIHsNCiAgICAgICAgICAgIGN0eC5maWxsVGV4dChjdXJyZW50VGV4dCx4LHkpOw0KICAgICAgICAgICAgbnVtRHJhd3MrPTE7DQogICAgICAgIH0NCiAgICB9DQoNCg0KICAgIGZ1bmN0aW9uIHJlbmRlclRleHQoZWwsIHRleHROb2RlLCBzdGFjaykgew0KICAgICAgICB2YXIgY3R4ID0gc3RhY2suY3R4LA0KICAgICAgICBmYW1pbHkgPSBnZXRDU1MoZWwsICJmb250RmFtaWx5IiksDQogICAgICAgIHNpemUgPSBnZXRDU1MoZWwsICJmb250U2l6ZSIpLA0KICAgICAgICBjb2xvciA9IGdldENTUyhlbCwgImNvbG9yIiksDQogICAgICAgIHRleHRfZGVjb3JhdGlvbiA9IGdldENTUyhlbCwgInRleHREZWNvcmF0aW9uIiksDQogICAgICAgIHRleHRfYWxpZ24gPSBnZXRDU1MoZWwsICJ0ZXh0QWxpZ24iKSwNCiAgICAgICAgbGV0dGVyX3NwYWNpbmcgPSBnZXRDU1MoZWwsICJsZXR0ZXJTcGFjaW5nIiksDQogICAgICAgIGJvdW5kcywNCiAgICAgICAgdGV4dCwNCiAgICAgICAgbWV0cmljcywNCiAgICAgICAgcmVuZGVyTGlzdCwNCiAgICAgICAgbGlzdExlbiwNCiAgICAgICAgYm9sZCA9IGdldENTUyhlbCwgImZvbnRXZWlnaHQiKSwNCiAgICAgICAgZm9udF9zdHlsZSA9IGdldENTUyhlbCwgImZvbnRTdHlsZSIpLA0KICAgICAgICBmb250X3ZhcmlhbnQgPSBnZXRDU1MoZWwsICJmb250VmFyaWFudCIpLA0KICAgICAgICBhbGlnbiA9IGZhbHNlLA0KICAgICAgICBuZXdUZXh0Tm9kZSwNCiAgICAgICAgdGV4dFZhbHVlLA0KICAgICAgICB0ZXh0T2Zmc2V0ID0gMCwNCiAgICAgICAgb2xkVGV4dE5vZGUsDQogICAgICAgIGMsDQogICAgICAgIHJhbmdlLA0KICAgICAgICBwYXJlbnQsDQogICAgICAgIHdyYXBFbGVtZW50LA0KICAgICAgICBiYWNrdXBUZXh0Ow0KDQogICAgICAgIC8vIGFwcGx5IHRleHQtdHJhbnNmb3JtOmF0aW9uIHRvIHRoZSB0ZXh0DQoNCg0KDQogICAgICAgIHRleHROb2RlLm5vZGVWYWx1ZSA9IHRleHRUcmFuc2Zvcm0odGV4dE5vZGUubm9kZVZhbHVlLCBnZXRDU1MoZWwsICJ0ZXh0VHJhbnNmb3JtIikpOw0KICAgICAgICB0ZXh0ID0gdHJpbVRleHQodGV4dE5vZGUubm9kZVZhbHVlKTsNCg0KICAgICAgICBpZiAodGV4dC5sZW5ndGg+MCl7DQoNCiAgICAgICAgICAgIGlmICh0ZXh0X2RlY29yYXRpb24gIT09ICJub25lIil7DQogICAgICAgICAgICAgICAgbWV0cmljcyA9IGZvbnRNZXRyaWNzKGZhbWlseSwgc2l6ZSk7DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIHRleHRfYWxpZ24gPSB0ZXh0X2FsaWduLnJlcGxhY2UoWyItd2Via2l0LWF1dG8iXSxbImF1dG8iXSk7DQoNCiAgICAgICAgICAgIGlmIChvcHRpb25zLmxldHRlclJlbmRlcmluZyA9PT0gZmFsc2UgJiYgL14obGVmdHxyaWdodHxqdXN0aWZ5fGF1dG8pJC8udGVzdCh0ZXh0X2FsaWduKSAmJiAvXihub3JtYWx8bm9uZSkkLy50ZXN0KGxldHRlcl9zcGFjaW5nKSl7DQogICAgICAgICAgICAgICAgLy8gdGhpcy5zZXRDb250ZXh0VmFyaWFibGUoY3R4LCJ0ZXh0QWxpZ24iLHRleHRfYWxpZ24pOw0KICAgICAgICAgICAgICAgIHJlbmRlckxpc3QgPSB0ZXh0Tm9kZS5ub2RlVmFsdWUuc3BsaXQoLyhcYnwgKS8pOw0KDQogICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICAvLyAgdGhpcy5zZXRDb250ZXh0VmFyaWFibGUoY3R4LCJ0ZXh0QWxpZ24iLCJsZWZ0Iik7DQogICAgICAgICAgICAgICAgcmVuZGVyTGlzdCA9IHRleHROb2RlLm5vZGVWYWx1ZS5zcGxpdCgiIik7DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIHN3aXRjaChwYXJzZUludChib2xkLCAxMCkpew0KICAgICAgICAgICAgICAgIGNhc2UgNDAxOg0KICAgICAgICAgICAgICAgICAgICBib2xkID0gImJvbGQiOw0KICAgICAgICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgICAgICBjYXNlIDQwMDoNCiAgICAgICAgICAgICAgICAgICAgYm9sZCA9ICJub3JtYWwiOw0KICAgICAgICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgY3R4LnNldFZhcmlhYmxlKCJmaWxsU3R5bGUiLCBjb2xvcik7DQoNCiAgICAgICAgICAgIC8qDQogICAgICAgICAgICAgIG5lZWQgdG8gYmUgZGVmaW5lZCBpbiB0aGUgb3JkZXIgYXMgZGVmaW5lZCBpbiBodHRwOi8vd3d3LnczLm9yZy9UUi9DU1MyMS9mb250cy5odG1sI2ZvbnQtc2hvcnRoYW5kDQogICAgICAgICAgICAgIHRvIHByb3Blcmx5IHdvcmsgaW4gRmlyZWZveA0KICAgICAgICAgICAgKi8NCiAgICAgICAgICAgIGN0eC5zZXRWYXJpYWJsZSgiZm9udCIsIGZvbnRfc3R5bGUrICIgIiArIGZvbnRfdmFyaWFudCAgKyAiICIgKyBib2xkICsgIiAiICsgc2l6ZSArICIgIiArIGZhbWlseSk7DQoNCiAgICAgICAgICAgIGlmIChhbGlnbil7DQogICAgICAgICAgICAgICAgY3R4LnNldFZhcmlhYmxlKCJ0ZXh0QWxpZ24iLCAicmlnaHQiKTsNCiAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgIGN0eC5zZXRWYXJpYWJsZSgidGV4dEFsaWduIiwgImxlZnQiKTsNCiAgICAgICAgICAgIH0NCg0KDQogICAgICAgICAgICAvKg0KICAgICAgICBpZiAoc3RhY2suY2xpcCl7DQogICAgICAgIGN0eC5yZWN0IChzdGFjay5jbGlwLmxlZnQsIHN0YWNrLmNsaXAudG9wLCBzdGFjay5jbGlwLndpZHRoLCBzdGFjay5jbGlwLmhlaWdodCk7DQogICAgICAgIGN0eC5jbGlwKCk7DQogICAgICAgIH0NCiAgICAgICAgICAgICAqLw0KDQoNCiAgICAgICAgICAgIG9sZFRleHROb2RlID0gdGV4dE5vZGU7DQoNCg0KICAgICAgICAgICAgZm9yICggYz0wLCBsaXN0TGVuID0gcmVuZGVyTGlzdC5sZW5ndGg7IGMgPCBsaXN0TGVuOyBjKz0xICkgew0KICAgICAgICAgICAgICAgIHRleHRWYWx1ZSA9IG51bGw7DQoNCg0KDQogICAgICAgICAgICAgICAgaWYgKHN1cHBvcnQucmFuZ2VCb3VuZHMpew0KICAgICAgICAgICAgICAgICAgICAvLyBnZXRCb3VuZGluZ0NsaWVudFJlY3QgaXMgc3VwcG9ydGVkIGZvciByYW5nZXMNCiAgICAgICAgICAgICAgICAgICAgaWYgKHRleHRfZGVjb3JhdGlvbiAhPT0gIm5vbmUiIHx8IHRyaW1UZXh0KHJlbmRlckxpc3RbY10pLmxlbmd0aCAhPT0gMCkgew0KICAgICAgICAgICAgICAgICAgICAgICAgdGV4dFZhbHVlID0gcmVuZGVyTGlzdFtjXTsNCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkb2MuY3JlYXRlUmFuZ2Upew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJhbmdlID0gZG9jLmNyZWF0ZVJhbmdlKCk7DQoNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICByYW5nZS5zZXRTdGFydCh0ZXh0Tm9kZSwgdGV4dE9mZnNldCk7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmFuZ2Uuc2V0RW5kKHRleHROb2RlLCB0ZXh0T2Zmc2V0ICsgdGV4dFZhbHVlLmxlbmd0aCk7DQogICAgICAgICAgICAgICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBUT0RPIGFkZCBJRSBzdXBwb3J0DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmFuZ2UgPSBib2R5LmNyZWF0ZVRleHRSYW5nZSgpOw0KICAgICAgICAgICAgICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAgICAgICAgICAgICBib3VuZHMgPSBhZGp1c3RCb3VuZHModGV4dE5vZGUsIHJhbmdlLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpKTsNCg0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgIC8vIGl0IGlzbid0IHN1cHBvcnRlZCwgc28gbGV0J3Mgd3JhcCBpdCBpbnNpZGUgYW4gZWxlbWVudCBpbnN0ZWFkIGFuZCBnZXQgdGhlIGJvdW5kcyB0aGVyZQ0KDQogICAgICAgICAgICAgICAgICAgIC8vIElFIDkgYnVnDQogICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygb2xkVGV4dE5vZGUubm9kZVZhbHVlICE9PSAic3RyaW5nIiApew0KICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7DQogICAgICAgICAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgICAgICAgICBuZXdUZXh0Tm9kZSA9IG9sZFRleHROb2RlLnNwbGl0VGV4dChyZW5kZXJMaXN0W2NdLmxlbmd0aCk7DQoNCiAgICAgICAgICAgICAgICAgICAgcGFyZW50ID0gb2xkVGV4dE5vZGUucGFyZW50Tm9kZTsNCiAgICAgICAgICAgICAgICAgICAgd3JhcEVsZW1lbnQgPSBkb2MuY3JlYXRlRWxlbWVudCgnd3JhcHBlcicpOw0KICAgICAgICAgICAgICAgICAgICBiYWNrdXBUZXh0ID0gb2xkVGV4dE5vZGUuY2xvbmVOb2RlKHRydWUpOw0KDQogICAgICAgICAgICAgICAgICAgIHdyYXBFbGVtZW50LmFwcGVuZENoaWxkKG9sZFRleHROb2RlLmNsb25lTm9kZSh0cnVlKSk7DQogICAgICAgICAgICAgICAgICAgIHBhcmVudC5yZXBsYWNlQ2hpbGQod3JhcEVsZW1lbnQsIG9sZFRleHROb2RlKTsNCg0KICAgICAgICAgICAgICAgICAgICBib3VuZHMgPSBfaHRtbDJjYW52YXMuVXRpbC5Cb3VuZHMod3JhcEVsZW1lbnQpOw0KDQogICAgICAgICAgICAgICAgICAgIHRleHRWYWx1ZSA9IG9sZFRleHROb2RlLm5vZGVWYWx1ZTsNCg0KICAgICAgICAgICAgICAgICAgICBvbGRUZXh0Tm9kZSA9IG5ld1RleHROb2RlOw0KICAgICAgICAgICAgICAgICAgICBwYXJlbnQucmVwbGFjZUNoaWxkKGJhY2t1cFRleHQsIHdyYXBFbGVtZW50KTsNCg0KDQogICAgICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAgICAgaWYgKHRleHRWYWx1ZSAhPT0gbnVsbCl7DQogICAgICAgICAgICAgICAgICAgIGRyYXdUZXh0KHRleHRWYWx1ZSwgYm91bmRzLmxlZnQsIGJvdW5kcy5ib3R0b20sIGN0eCk7DQogICAgICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAgICAgc3dpdGNoKHRleHRfZGVjb3JhdGlvbikgew0KICAgICAgICAgICAgICAgICAgICBjYXNlICJ1bmRlcmxpbmUiOg0KICAgICAgICAgICAgICAgICAgICAgICAgLy8gRHJhd3MgYSBsaW5lIGF0IHRoZSBiYXNlbGluZSBvZiB0aGUgZm9udA0KICAgICAgICAgICAgICAgICAgICAgICAgLy8gVE9ETyBBcyBzb21lIGJyb3dzZXJzIGRpc3BsYXkgdGhlIGxpbmUgYXMgbW9yZSB0aGFuIDFweCBpZiB0aGUgZm9udC1zaXplIGlzIGJpZywgbmVlZCB0byB0YWtlIHRoYXQgaW50byBhY2NvdW50IGJvdGggaW4gcG9zaXRpb24gYW5kIHNpemUNCiAgICAgICAgICAgICAgICAgICAgICAgIHJlbmRlclJlY3QoY3R4LCBib3VuZHMubGVmdCwgTWF0aC5yb3VuZChib3VuZHMudG9wICsgbWV0cmljcy5iYXNlbGluZSArIG1ldHJpY3MubGluZVdpZHRoKSwgYm91bmRzLndpZHRoLCAxLCBjb2xvcik7DQogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgICAgICAgICAgY2FzZSAib3ZlcmxpbmUiOg0KICAgICAgICAgICAgICAgICAgICAgICAgcmVuZGVyUmVjdChjdHgsIGJvdW5kcy5sZWZ0LCBib3VuZHMudG9wLCBib3VuZHMud2lkdGgsIDEsIGNvbG9yKTsNCiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgICAgICAgICBjYXNlICJsaW5lLXRocm91Z2giOg0KICAgICAgICAgICAgICAgICAgICAgICAgLy8gVE9ETyB0cnkgYW5kIGZpbmQgZXhhY3QgcG9zaXRpb24gZm9yIGxpbmUtdGhyb3VnaA0KICAgICAgICAgICAgICAgICAgICAgICAgcmVuZGVyUmVjdChjdHgsIGJvdW5kcy5sZWZ0LCBNYXRoLmNlaWwoYm91bmRzLnRvcCArIG1ldHJpY3MubWlkZGxlICsgbWV0cmljcy5saW5lV2lkdGgpLCBib3VuZHMud2lkdGgsIDEsIGNvbG9yKTsNCiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOw0KDQogICAgICAgICAgICAgICAgfQ0KDQoNCg0KDQoNCiAgICAgICAgICAgICAgICB0ZXh0T2Zmc2V0ICs9IHJlbmRlckxpc3RbY10ubGVuZ3RoOw0KDQogICAgICAgICAgICB9DQoNCg0KDQogICAgICAgIH0NCg0KICAgIH0NCg0KICAgIGZ1bmN0aW9uIGxpc3RQb3NpdGlvbiAoZWxlbWVudCwgdmFsKSB7DQogICAgICAgIHZhciBib3VuZEVsZW1lbnQgPSBkb2MuY3JlYXRlRWxlbWVudCggImJvdW5kZWxlbWVudCIgKSwNCiAgICAgICAgdHlwZSwNCiAgICAgICAgYm91bmRzOw0KDQogICAgICAgIGJvdW5kRWxlbWVudC5zdHlsZS5kaXNwbGF5ID0gImlubGluZSI7DQogICAgICAgIC8vYm91bmRFbGVtZW50LnN0eWxlLndpZHRoID0gIjFweCI7DQogICAgICAgIC8vYm91bmRFbGVtZW50LnN0eWxlLmhlaWdodCA9ICIxcHgiOw0KDQogICAgICAgIHR5cGUgPSBlbGVtZW50LnN0eWxlLmxpc3RTdHlsZVR5cGU7DQogICAgICAgIGVsZW1lbnQuc3R5bGUubGlzdFN0eWxlVHlwZSA9ICJub25lIjsNCg0KICAgICAgICBib3VuZEVsZW1lbnQuYXBwZW5kQ2hpbGQoIGRvYy5jcmVhdGVUZXh0Tm9kZSggdmFsICkgKTsNCg0KDQogICAgICAgIGVsZW1lbnQuaW5zZXJ0QmVmb3JlKGJvdW5kRWxlbWVudCwgZWxlbWVudC5maXJzdENoaWxkKTsNCg0KDQogICAgICAgIGJvdW5kcyA9IF9odG1sMmNhbnZhcy5VdGlsLkJvdW5kcyggYm91bmRFbGVtZW50ICk7DQogICAgICAgIGVsZW1lbnQucmVtb3ZlQ2hpbGQoIGJvdW5kRWxlbWVudCApOw0KICAgICAgICBlbGVtZW50LnN0eWxlLmxpc3RTdHlsZVR5cGUgPSB0eXBlOw0KICAgICAgICByZXR1cm4gYm91bmRzOw0KDQogICAgfQ0KICAgIA0KDQogICAgDQogICAgZnVuY3Rpb24gZWxlbWVudEluZGV4KCBlbCApIHsNCiAgICAgICAgdmFyIGkgPSAtMSwNCiAgICAgICAgY291bnQgPSAxLA0KICAgICAgICBjaGlsZHMgPSBlbC5wYXJlbnROb2RlLmNoaWxkTm9kZXM7DQoNCiAgICAgICAgaWYgKCBlbC5wYXJlbnROb2RlICkgew0KICAgICAgICAgICAgd2hpbGUoIGNoaWxkc1sgKytpIF0gIT09IGVsICkgew0KICAgICAgICAgICAgICAgaWYgKCBjaGlsZHNbIGkgXS5ub2RlVHlwZSA9PT0gMSApIHsNCiAgICAgICAgICAgICAgICAgICBjb3VudCsrOw0KICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgcmV0dXJuIGNvdW50Ow0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgcmV0dXJuIC0xOw0KICAgICAgICB9DQogICAgICAgDQogICAgfQ0KDQogICAgZnVuY3Rpb24gcmVuZGVyTGlzdEl0ZW0oZWxlbWVudCwgc3RhY2ssIGVsQm91bmRzKSB7DQoNCg0KICAgICAgICB2YXIgcG9zaXRpb24gPSBnZXRDU1MoZWxlbWVudCwgImxpc3RTdHlsZVBvc2l0aW9uIiksDQogICAgICAgIHgsDQogICAgICAgIHksDQogICAgICAgIHR5cGUgPSBnZXRDU1MoZWxlbWVudCwgImxpc3RTdHlsZVR5cGUiKSwNCiAgICAgICAgY3VycmVudEluZGV4LA0KICAgICAgICB0ZXh0LA0KICAgICAgICBsaXN0Qm91bmRzLA0KICAgICAgICBib2xkID0gZ2V0Q1NTKGVsZW1lbnQsICJmb250V2VpZ2h0Iik7DQoNCiAgICAgICAgaWYgKC9eKGRlY2ltYWx8ZGVjaW1hbC1sZWFkaW5nLXplcm98dXBwZXItYWxwaGF8dXBwZXItbGF0aW58dXBwZXItcm9tYW58bG93ZXItYWxwaGF8bG93ZXItZ3JlZWt8bG93ZXItbGF0aW58bG93ZXItcm9tYW4pJC9pLnRlc3QodHlwZSkpIHsNCg0KICAgICAgICAgICAgY3VycmVudEluZGV4ID0gZWxlbWVudEluZGV4KCBlbGVtZW50ICk7DQoNCiAgICAgICAgICAgIHN3aXRjaCh0eXBlKXsNCiAgICAgICAgICAgICAgICBjYXNlICJkZWNpbWFsIjoNCiAgICAgICAgICAgICAgICAgICAgdGV4dCA9IGN1cnJlbnRJbmRleDsNCiAgICAgICAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICAgICAgY2FzZSAiZGVjaW1hbC1sZWFkaW5nLXplcm8iOg0KICAgICAgICAgICAgICAgICAgICBpZiAoY3VycmVudEluZGV4LnRvU3RyaW5nKCkubGVuZ3RoID09PSAxKXsNCiAgICAgICAgICAgICAgICAgICAgICAgIHRleHQgPSBjdXJyZW50SW5kZXggPSAiMCIgKyBjdXJyZW50SW5kZXgudG9TdHJpbmcoKTsNCiAgICAgICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgICAgICB0ZXh0ID0gY3VycmVudEluZGV4LnRvU3RyaW5nKCk7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICAgICAgY2FzZSAidXBwZXItcm9tYW4iOg0KICAgICAgICAgICAgICAgICAgICB0ZXh0ID0gX2h0bWwyY2FudmFzLkdlbmVyYXRlLkxpc3RSb21hbiggY3VycmVudEluZGV4ICk7DQogICAgICAgICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgICAgIGNhc2UgImxvd2VyLXJvbWFuIjoNCiAgICAgICAgICAgICAgICAgICAgdGV4dCA9IF9odG1sMmNhbnZhcy5HZW5lcmF0ZS5MaXN0Um9tYW4oIGN1cnJlbnRJbmRleCApLnRvTG93ZXJDYXNlKCk7DQogICAgICAgICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgICAgIGNhc2UgImxvd2VyLWFscGhhIjoNCiAgICAgICAgICAgICAgICAgICAgdGV4dCA9IF9odG1sMmNhbnZhcy5HZW5lcmF0ZS5MaXN0QWxwaGEoIGN1cnJlbnRJbmRleCApLnRvTG93ZXJDYXNlKCk7DQogICAgICAgICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgICAgIGNhc2UgInVwcGVyLWFscGhhIjoNCiAgICAgICAgICAgICAgICAgICAgdGV4dCA9IF9odG1sMmNhbnZhcy5HZW5lcmF0ZS5MaXN0QWxwaGEoIGN1cnJlbnRJbmRleCApOw0KICAgICAgICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgIH0NCg0KDQogICAgICAgICAgICB0ZXh0ICs9ICIuICI7DQogICAgICAgICAgICBsaXN0Qm91bmRzID0gbGlzdFBvc2l0aW9uKGVsZW1lbnQsIHRleHQpOw0KDQoNCg0KICAgICAgICAgICAgc3dpdGNoKGJvbGQpew0KICAgICAgICAgICAgICAgIGNhc2UgNDAxOg0KICAgICAgICAgICAgICAgICAgICBib2xkID0gImJvbGQiOw0KICAgICAgICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgICAgICBjYXNlIDQwMDoNCiAgICAgICAgICAgICAgICAgICAgYm9sZCA9ICJub3JtYWwiOw0KICAgICAgICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgIH0NCg0KDQoNCg0KICAgICAgICAgICAgY3R4LnNldFZhcmlhYmxlKCAiZmlsbFN0eWxlIiwgZ2V0Q1NTKGVsZW1lbnQsICJjb2xvciIpICk7DQogICAgICAgICAgICBjdHguc2V0VmFyaWFibGUoICJmb250IiwgZ2V0Q1NTKGVsZW1lbnQsICJmb250VmFyaWFudCIpICsgIiAiICsgYm9sZCArICIgIiArIGdldENTUyhlbGVtZW50LCAiZm9udFN0eWxlIikgKyAiICIgKyBnZXRDU1MoZWxlbWVudCwgImZvbnRTaXplIikgKyAiICIgKyBnZXRDU1MoZWxlbWVudCwgImZvbnRGYW1pbHkiKSApOw0KDQoNCiAgICAgICAgICAgIGlmICggcG9zaXRpb24gPT09ICJpbnNpZGUiICkgew0KICAgICAgICAgICAgICAgIGN0eC5zZXRWYXJpYWJsZSgidGV4dEFsaWduIiwgImxlZnQiKTsNCiAgICAgICAgICAgICAgICAvLyAgIHRoaXMuc2V0Rm9udChzdGFjay5jdHgsIGVsZW1lbnQsIGZhbHNlKTsNCiAgICAgICAgICAgICAgICB4ID0gZWxCb3VuZHMubGVmdDsNCg0KICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgcmV0dXJuOw0KICAgICAgICAgICAgLyoNCiAgICAgICAgICAgICAgICAgVE9ETyByZWFsbHkgbmVlZCB0byBmaWd1cmUgb3V0IHNvbWUgbW9yZSBhY2N1cmF0ZSB3YXkgdG8gdHJ5IGFuZCBmaW5kIHRoZSBwb3NpdGlvbi4NCiAgICAgICAgICAgICAgICAgYXMgZGVmaW5lZCBpbiBodHRwOi8vd3d3LnczLm9yZy9UUi9DU1MyMS9nZW5lcmF0ZS5odG1sI3Byb3BkZWYtbGlzdC1zdHlsZS1wb3NpdGlvbiwgaXQgZG9lcyBub3QgZXZlbiBoYXZlIGEgc3BlY2lmaWVkICJjb3JyZWN0IiBwb3NpdGlvbiwgc28gZWFjaCBicm93c2VyDQogICAgICAgICAgICAgICAgIG1heSBkaXNwbGF5IGl0IHdoYXRldmVyIHdheSBpdCBmZWVscyBsaWtlLg0KICAgICAgICAgICAgICAgICAiVGhlIHBvc2l0aW9uIG9mIHRoZSBsaXN0LWl0ZW0gbWFya2VyIGFkamFjZW50IHRvIGZsb2F0cyBpcyB1bmRlZmluZWQgaW4gQ1NTIDIuMS4gQ1NTIDIuMSBkb2VzIG5vdCBzcGVjaWZ5IHRoZSBwcmVjaXNlIGxvY2F0aW9uIG9mIHRoZSBtYXJrZXIgYm94IG9yIGl0cyBwb3NpdGlvbiBpbiB0aGUgcGFpbnRpbmcgb3JkZXIiDQoNCiAgICAgICAgICAgICAgICBjdHguc2V0VmFyaWFibGUoInRleHRBbGlnbiIsICJyaWdodCIpOw0KICAgICAgICAgICAgICAgIC8vICB0aGlzLnNldEZvbnQoc3RhY2suY3R4LCBlbGVtZW50LCB0cnVlKTsNCiAgICAgICAgICAgICAgICB4ID0gZWxCb3VuZHMubGVmdCAtIDEwOw0KICAgICAgICAgICAgICAgICAqLw0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICB5ID0gbGlzdEJvdW5kcy5ib3R0b207DQoNCiAgICAgICAgICAgIGRyYXdUZXh0KHRleHQsIHgsIHksIGN0eCk7DQoNCg0KICAgICAgICB9DQoNCg0KICAgIH0NCg0KICAgIGZ1bmN0aW9uIGxvYWRJbWFnZSAoc3JjKXsNCiAgICAgICAgdmFyIGltZyA9IGltYWdlc1tzcmNdOw0KICAgICAgICBpZiAoaW1nICYmIGltZy5zdWNjZWVkZWQgPT09IHRydWUpIHsNCiAgICAgICAgICAgIHJldHVybiBpbWcuaW1nOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgcmV0dXJuIGZhbHNlOw0KICAgICAgICB9DQogICAgfQ0KDQoNCg0KDQoNCg0KICAgIGZ1bmN0aW9uIGNsaXBCb3VuZHMoc3JjLCBkc3Qpew0KDQogICAgICAgIHZhciB4ID0gTWF0aC5tYXgoc3JjLmxlZnQsIGRzdC5sZWZ0KSwNCiAgICAgICAgeSA9IE1hdGgubWF4KHNyYy50b3AsIGRzdC50b3ApLA0KICAgICAgICB4MiA9IE1hdGgubWluKChzcmMubGVmdCArIHNyYy53aWR0aCksIChkc3QubGVmdCArIGRzdC53aWR0aCkpLA0KICAgICAgICB5MiA9IE1hdGgubWluKChzcmMudG9wICsgc3JjLmhlaWdodCksIChkc3QudG9wICsgZHN0LmhlaWdodCkpOw0KDQogICAgICAgIHJldHVybiB7DQogICAgICAgICAgICBsZWZ0OngsDQogICAgICAgICAgICB0b3A6eSwNCiAgICAgICAgICAgIHdpZHRoOngyLXgsDQogICAgICAgICAgICBoZWlnaHQ6eTIteQ0KICAgICAgICB9Ow0KDQogICAgfQ0KDQogICAgZnVuY3Rpb24gc2V0Wih6SW5kZXgsIHBhcmVudFopew0KICAgICAgICAvLyBUT0RPIGZpeCBzdGF0aWMgZWxlbWVudHMgb3ZlcmxhcHBpbmcgcmVsYXRpdmUvYWJzb2x1dGUgZWxlbWVudHMgdW5kZXIgc2FtZSBzdGFjaywgaWYgdGhleSBhcmUgZGVmaW5lZCBhZnRlciB0aGVtDQogICAgICAgIHZhciBuZXdDb250ZXh0Ow0KICAgICAgICBpZiAoIXBhcmVudFopew0KICAgICAgICAgICAgbmV3Q29udGV4dCA9IGgyY3pDb250ZXh0KDApOw0KICAgICAgICAgICAgcmV0dXJuIG5ld0NvbnRleHQ7DQogICAgICAgIH0NCg0KICAgICAgICBpZiAoekluZGV4ICE9PSAiYXV0byIpew0KICAgICAgICAgICAgbmVlZFJlb3JkZXIgPSB0cnVlOw0KICAgICAgICAgICAgbmV3Q29udGV4dCA9IGgyY3pDb250ZXh0KHpJbmRleCk7DQogICAgICAgICAgICBwYXJlbnRaLmNoaWxkcmVuLnB1c2gobmV3Q29udGV4dCk7DQogICAgICAgICAgICByZXR1cm4gbmV3Q29udGV4dDsNCg0KICAgICAgICB9DQoNCiAgICAgICAgcmV0dXJuIHBhcmVudFo7DQoNCiAgICB9DQoNCiAgICBmdW5jdGlvbiByZW5kZXJCb3JkZXJzKGVsLCBjdHgsIGJvdW5kcywgY2xpcCl7DQoNCiAgICAgICAgLyoNCiAgICAgICAgICogIFRPRE8gYWRkIHN1cHBvcnQgZm9yIGRpZmZlcmVudCBib3JkZXItc3R5bGUncyB0aGFuIHNvbGlkDQogICAgICAgICAqLw0KDQogICAgICAgIHZhciB4ID0gYm91bmRzLmxlZnQsDQogICAgICAgIHkgPSBib3VuZHMudG9wLA0KICAgICAgICB3ID0gYm91bmRzLndpZHRoLA0KICAgICAgICBoID0gYm91bmRzLmhlaWdodCwNCiAgICAgICAgYm9yZGVyU2lkZSwNCiAgICAgICAgYm9yZGVyRGF0YSwNCiAgICAgICAgYngsDQogICAgICAgIGJ5LA0KICAgICAgICBidywNCiAgICAgICAgYmgsDQogICAgICAgIGJvcmRlckJvdW5kcywNCiAgICAgICAgYm9yZGVycyA9IChmdW5jdGlvbihlbCl7DQogICAgICAgICAgICB2YXIgYm9yZGVycyA9IFtdLA0KICAgICAgICAgICAgc2lkZXMgPSBbIlRvcCIsIlJpZ2h0IiwiQm90dG9tIiwiTGVmdCJdLA0KICAgICAgICAgICAgczsNCg0KICAgICAgICAgICAgZm9yIChzID0gMDsgcyA8IDQ7IHMrPTEpew0KICAgICAgICAgICAgICAgIGJvcmRlcnMucHVzaCh7DQogICAgICAgICAgICAgICAgICAgIHdpZHRoOiBnZXRDU1NJbnQoZWwsICdib3JkZXInICsgc2lkZXNbc10gKyAnV2lkdGgnKSwNCiAgICAgICAgICAgICAgICAgICAgY29sb3I6IGdldENTUyhlbCwgJ2JvcmRlcicgKyBzaWRlc1tzXSArICdDb2xvcicpDQogICAgICAgICAgICAgICAgfSk7DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIHJldHVybiBib3JkZXJzOw0KDQogICAgICAgIH0oZWwpKTsNCg0KDQogICAgICAgIGZvciAoYm9yZGVyU2lkZSA9IDA7IGJvcmRlclNpZGUgPCA0OyBib3JkZXJTaWRlKz0xKXsNCiAgICAgICAgICAgIGJvcmRlckRhdGEgPSBib3JkZXJzW2JvcmRlclNpZGVdOw0KDQogICAgICAgICAgICBpZiAoYm9yZGVyRGF0YS53aWR0aD4wKXsNCiAgICAgICAgICAgICAgICBieCA9IHg7DQogICAgICAgICAgICAgICAgYnkgPSB5Ow0KICAgICAgICAgICAgICAgIGJ3ID0gdzsNCiAgICAgICAgICAgICAgICBiaCA9IGggLSAoYm9yZGVyc1syXS53aWR0aCk7DQoNCiAgICAgICAgICAgICAgICBzd2l0Y2goYm9yZGVyU2lkZSl7DQogICAgICAgICAgICAgICAgICAgIGNhc2UgMDoNCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRvcCBib3JkZXINCiAgICAgICAgICAgICAgICAgICAgICAgIGJoID0gYm9yZGVyc1swXS53aWR0aDsNCiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgICAgICAgICBjYXNlIDE6DQogICAgICAgICAgICAgICAgICAgICAgICAvLyByaWdodCBib3JkZXINCiAgICAgICAgICAgICAgICAgICAgICAgIGJ4ID0geCArIHcgLSAoYm9yZGVyc1sxXS53aWR0aCk7DQogICAgICAgICAgICAgICAgICAgICAgICBidyA9IGJvcmRlcnNbMV0ud2lkdGg7DQogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgICAgICAgICAgY2FzZSAyOg0KICAgICAgICAgICAgICAgICAgICAgICAgLy8gYm90dG9tIGJvcmRlcg0KICAgICAgICAgICAgICAgICAgICAgICAgYnkgPSAoYnkgKyBoKSAtIChib3JkZXJzWzJdLndpZHRoKTsNCiAgICAgICAgICAgICAgICAgICAgICAgIGJoID0gYm9yZGVyc1syXS53aWR0aDsNCiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgICAgICAgICBjYXNlIDM6DQogICAgICAgICAgICAgICAgICAgICAgICAvLyBsZWZ0IGJvcmRlcg0KICAgICAgICAgICAgICAgICAgICAgICAgYncgPSBib3JkZXJzWzNdLndpZHRoOw0KICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAgICAgYm9yZGVyQm91bmRzID0gew0KICAgICAgICAgICAgICAgICAgICBsZWZ0OmJ4LA0KICAgICAgICAgICAgICAgICAgICB0b3A6YnksDQogICAgICAgICAgICAgICAgICAgIHdpZHRoOiBidywNCiAgICAgICAgICAgICAgICAgICAgaGVpZ2h0OmJoDQogICAgICAgICAgICAgICAgfTsNCg0KICAgICAgICAgICAgICAgIGlmIChjbGlwKXsNCiAgICAgICAgICAgICAgICAgICAgYm9yZGVyQm91bmRzID0gY2xpcEJvdW5kcyhib3JkZXJCb3VuZHMsIGNsaXApOw0KICAgICAgICAgICAgICAgIH0NCg0KDQogICAgICAgICAgICAgICAgaWYgKGJvcmRlckJvdW5kcy53aWR0aD4wICYmIGJvcmRlckJvdW5kcy5oZWlnaHQ+MCl7DQogICAgICAgICAgICAgICAgICAgIHJlbmRlclJlY3QoY3R4LCBieCwgYnksIGJvcmRlckJvdW5kcy53aWR0aCwgYm9yZGVyQm91bmRzLmhlaWdodCwgYm9yZGVyRGF0YS5jb2xvcik7DQogICAgICAgICAgICAgICAgfQ0KDQoNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KDQogICAgICAgIHJldHVybiBib3JkZXJzOw0KDQogICAgfQ0KDQoNCiAgICBmdW5jdGlvbiByZW5kZXJGb3JtVmFsdWUgKGVsLCBib3VuZHMsIHN0YWNrKXsNCg0KICAgICAgICB2YXIgdmFsdWVXcmFwID0gZG9jLmNyZWF0ZUVsZW1lbnQoJ3ZhbHVld3JhcCcpLA0KICAgICAgICBjc3NBcnIgPSBbJ2xpbmVIZWlnaHQnLCd0ZXh0QWxpZ24nLCdmb250RmFtaWx5JywnY29sb3InLCdmb250U2l6ZScsJ3BhZGRpbmdMZWZ0JywncGFkZGluZ1RvcCcsJ3dpZHRoJywnaGVpZ2h0JywnYm9yZGVyJywnYm9yZGVyTGVmdFdpZHRoJywnYm9yZGVyVG9wV2lkdGgnXSwNCiAgICAgICAgaSwNCiAgICAgICAgdGV4dFZhbHVlLA0KICAgICAgICB0ZXh0Tm9kZSwNCiAgICAgICAgYXJyTGVuLA0KICAgICAgICBzdHlsZTsNCg0KICAgICAgICBmb3IgKGkgPSAwLCBhcnJMZW4gPSBjc3NBcnIubGVuZ3RoOyBpIDwgYXJyTGVuOyBpKz0xKXsNCiAgICAgICAgICAgIHN0eWxlID0gY3NzQXJyW2ldOw0KDQogICAgICAgICAgICB0cnkgew0KICAgICAgICAgICAgICAgIHZhbHVlV3JhcC5zdHlsZVtzdHlsZV0gPSBnZXRDU1MoZWwsIHN0eWxlKTsNCiAgICAgICAgICAgIH0gY2F0Y2goIGUgKSB7DQogICAgICAgICAgICAgICAgLy8gT2xkZXIgSUUgaGFzIGlzc3VlcyB3aXRoICJib3JkZXIiDQogICAgICAgICAgICAgICAgaDJjbG9nKCJodG1sMmNhbnZhczogUGFyc2U6IEV4Y2VwdGlvbiBjYXVnaHQgaW4gcmVuZGVyRm9ybVZhbHVlOiAiICsgZS5tZXNzYWdlKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KDQoNCiAgICAgICAgdmFsdWVXcmFwLnN0eWxlLmJvcmRlckNvbG9yID0gImJsYWNrIjsNCiAgICAgICAgdmFsdWVXcmFwLnN0eWxlLmJvcmRlclN0eWxlID0gInNvbGlkIjsNCiAgICAgICAgdmFsdWVXcmFwLnN0eWxlLmRpc3BsYXkgPSAiYmxvY2siOw0KICAgICAgICB2YWx1ZVdyYXAuc3R5bGUucG9zaXRpb24gPSAiYWJzb2x1dGUiOw0KICAgICAgICBpZiAoL14oc3VibWl0fHJlc2V0fGJ1dHRvbnx0ZXh0fHBhc3N3b3JkKSQvLnRlc3QoZWwudHlwZSkgfHwgZWwubm9kZU5hbWUgPT09ICJTRUxFQ1QiKXsNCiAgICAgICAgICAgIHZhbHVlV3JhcC5zdHlsZS5saW5lSGVpZ2h0ID0gZ2V0Q1NTKGVsLCAiaGVpZ2h0Iik7DQogICAgICAgIH0NCg0KDQogICAgICAgIHZhbHVlV3JhcC5zdHlsZS50b3AgPSBib3VuZHMudG9wICsgInB4IjsNCiAgICAgICAgdmFsdWVXcmFwLnN0eWxlLmxlZnQgPSBib3VuZHMubGVmdCArICJweCI7DQoNCiAgICAgICAgaWYgKGVsLm5vZGVOYW1lID09PSAiU0VMRUNUIil7DQogICAgICAgICAgICAvLyBUT0RPIGluY3JlYXNlIGFjY3VyYWN5IG9mIHRleHQgcG9zaXRpb24NCiAgICAgICAgICAgIHRleHRWYWx1ZSA9IGVsLm9wdGlvbnNbZWwuc2VsZWN0ZWRJbmRleF0udGV4dDsNCiAgICAgICAgfSBlbHNlew0KICAgICAgICAgICAgdGV4dFZhbHVlID0gZWwudmFsdWU7DQogICAgICAgIH0NCiAgICAgICAgdGV4dE5vZGUgPSBkb2MuY3JlYXRlVGV4dE5vZGUodGV4dFZhbHVlKTsNCg0KICAgICAgICB2YWx1ZVdyYXAuYXBwZW5kQ2hpbGQodGV4dE5vZGUpOw0KICAgICAgICBib2R5LmFwcGVuZENoaWxkKHZhbHVlV3JhcCk7DQoNCg0KICAgICAgICByZW5kZXJUZXh0KGVsLCB0ZXh0Tm9kZSwgc3RhY2spOw0KICAgICAgICBib2R5LnJlbW92ZUNoaWxkKHZhbHVlV3JhcCk7DQoNCg0KDQogICAgfQ0KDQoNCg0KDQoNCiAgICBmdW5jdGlvbiByZW5kZXJJbWFnZSAoY3R4LCBpbWFnZSwgc3gsIHN5LCBzdywgc2gsIGR4LCBkeSwgZHcsIGRoKSB7DQogICAgICAgIGN0eC5kcmF3SW1hZ2UoDQogICAgICAgICAgICBpbWFnZSwNCiAgICAgICAgICAgIHN4LCAvL3N4DQogICAgICAgICAgICBzeSwgLy9zeQ0KICAgICAgICAgICAgc3csIC8vc3cNCiAgICAgICAgICAgIHNoLCAvL3NoDQogICAgICAgICAgICBkeCwgLy9keA0KICAgICAgICAgICAgZHksIC8vIGR5DQogICAgICAgICAgICBkdywgLy9kdw0KICAgICAgICAgICAgZGggLy9kaA0KICAgICAgICAgICAgKTsNCiAgICAgICAgbnVtRHJhd3MrPTE7DQoNCiAgICB9DQoNCg0KICAgIGZ1bmN0aW9uIHJlbmRlckJhY2tncm91bmRSZXBlYXQgKGN0eCwgaW1hZ2UsIHgsIHksIHdpZHRoLCBoZWlnaHQsIGVseCwgZWx5KXsNCiAgICAgICAgdmFyIHNvdXJjZVggPSAwLA0KICAgICAgICBzb3VyY2VZPTA7DQogICAgICAgIGlmIChlbHgteD4wKXsNCiAgICAgICAgICAgIHNvdXJjZVggPSBlbHgteDsNCiAgICAgICAgfQ0KDQogICAgICAgIGlmIChlbHkteT4wKXsNCiAgICAgICAgICAgIHNvdXJjZVkgPSBlbHkteTsNCiAgICAgICAgfQ0KDQogICAgICAgIHJlbmRlckltYWdlKA0KICAgICAgICAgICAgY3R4LA0KICAgICAgICAgICAgaW1hZ2UsDQogICAgICAgICAgICBzb3VyY2VYLCAvLyBzb3VyY2UgWA0KICAgICAgICAgICAgc291cmNlWSwgLy8gc291cmNlIFkNCiAgICAgICAgICAgIHdpZHRoLXNvdXJjZVgsIC8vIHNvdXJjZSBXaWR0aA0KICAgICAgICAgICAgaGVpZ2h0LXNvdXJjZVksIC8vIHNvdXJjZSBIZWlnaHQNCiAgICAgICAgICAgIHgrc291cmNlWCwgLy8gZGVzdGluYXRpb24gWA0KICAgICAgICAgICAgeStzb3VyY2VZLCAvLyBkZXN0aW5hdGlvbiBZDQogICAgICAgICAgICB3aWR0aC1zb3VyY2VYLCAvLyBkZXN0aW5hdGlvbiB3aWR0aA0KICAgICAgICAgICAgaGVpZ2h0LXNvdXJjZVkgLy8gZGVzdGluYXRpb24gaGVpZ2h0DQogICAgICAgICAgICApOw0KICAgIH0NCg0KDQogICAgZnVuY3Rpb24gcmVuZGVyQmFja2dyb3VuZFJlcGVhdFkgKGN0eCwgaW1hZ2UsIGJncCwgeCwgeSwgdywgaCl7DQoNCiAgICAgICAgdmFyIGhlaWdodCwNCiAgICAgICAgd2lkdGggPSBNYXRoLm1pbihpbWFnZS53aWR0aCx3KSxiZ3k7DQoNCiAgICAgICAgYmdwLnRvcCA9IGJncC50b3AtTWF0aC5jZWlsKGJncC50b3AvaW1hZ2UuaGVpZ2h0KSppbWFnZS5oZWlnaHQ7DQoNCg0KICAgICAgICBmb3IoYmd5PSh5K2JncC50b3ApO2JneTxoK3k7KXsNCg0KDQogICAgICAgICAgICBpZiAoIE1hdGguZmxvb3IoYmd5K2ltYWdlLmhlaWdodCk+aCt5KXsNCiAgICAgICAgICAgICAgICBoZWlnaHQgPSAoaCt5KS1iZ3k7DQogICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICBoZWlnaHQgPSBpbWFnZS5oZWlnaHQ7DQogICAgICAgICAgICB9DQogICAgICAgICAgICByZW5kZXJCYWNrZ3JvdW5kUmVwZWF0KGN0eCxpbWFnZSx4K2JncC5sZWZ0LGJneSx3aWR0aCxoZWlnaHQseCx5KTsNCg0KICAgICAgICAgICAgYmd5ID0gTWF0aC5mbG9vcihiZ3kraW1hZ2UuaGVpZ2h0KTsNCg0KICAgICAgICB9DQogICAgfQ0KDQogICAgZnVuY3Rpb24gcmVuZGVyQmFja2dyb3VuZFJlcGVhdFgoY3R4LCBpbWFnZSwgYmdwLCB4LCB5LCB3LCBoKXsNCg0KICAgICAgICB2YXIgaGVpZ2h0ID0gTWF0aC5taW4oaW1hZ2UuaGVpZ2h0LGgpLA0KICAgICAgICB3aWR0aCxiZ3g7DQoNCg0KICAgICAgICBiZ3AubGVmdCA9IGJncC5sZWZ0LU1hdGguY2VpbChiZ3AubGVmdC9pbWFnZS53aWR0aCkqaW1hZ2Uud2lkdGg7DQoNCg0KICAgICAgICBmb3IgKGJneD0oeCtiZ3AubGVmdCk7Ymd4PHcreDspIHsNCg0KICAgICAgICAgICAgaWYgKE1hdGguZmxvb3IoYmd4K2ltYWdlLndpZHRoKT53K3gpew0KICAgICAgICAgICAgICAgIHdpZHRoID0gKHcreCktYmd4Ow0KICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgd2lkdGggPSBpbWFnZS53aWR0aDsNCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgcmVuZGVyQmFja2dyb3VuZFJlcGVhdChjdHgsaW1hZ2UsYmd4LCh5K2JncC50b3ApLHdpZHRoLGhlaWdodCx4LHkpOw0KDQogICAgICAgICAgICBiZ3ggPSBNYXRoLmZsb29yKGJneCtpbWFnZS53aWR0aCk7DQoNCg0KICAgICAgICB9DQogICAgfQ0KDQogICAgZnVuY3Rpb24gcmVuZGVyQmFja2dyb3VuZChlbCxib3VuZHMsY3R4KXsNCg0KICAgICAgICAvLyBUT0RPIGFkZCBzdXBwb3J0IGZvciBtdWx0aSBiYWNrZ3JvdW5kLWltYWdlcw0KICAgICAgICB2YXIgYmFja2dyb3VuZF9pbWFnZSA9IGdldENTUyhlbCwgImJhY2tncm91bmRJbWFnZSIpLA0KICAgICAgICBiYWNrZ3JvdW5kX3JlcGVhdCA9IGdldENTUyhlbCwgImJhY2tncm91bmRSZXBlYXQiKS5zcGxpdCgiLCIpWzBdLA0KICAgICAgICBpbWFnZSwNCiAgICAgICAgYmdwLA0KICAgICAgICBiZ3ksDQogICAgICAgIGJndywNCiAgICAgICAgYmdzeCwNCiAgICAgICAgYmdzeSwNCiAgICAgICAgYmdkeCwNCiAgICAgICAgYmdkeSwNCiAgICAgICAgYmdoLA0KICAgICAgICBoLA0KICAgICAgICBoZWlnaHQsDQogICAgICAgIGFkZDsNCg0KICAgICAgICAvLyAgIGlmICh0eXBlb2YgYmFja2dyb3VuZF9pbWFnZSAhPT0gInVuZGVmaW5lZCIgJiYgL14oMXxub25lKSQvLnRlc3QoYmFja2dyb3VuZF9pbWFnZSkgPT09IGZhbHNlICYmIC9eKC13ZWJraXR8LW1venxsaW5lYXItZ3JhZGllbnR8LW8tKS8udGVzdChiYWNrZ3JvdW5kX2ltYWdlKT09PWZhbHNlKXsNCg0KICAgICAgICBpZiAoICEvZGF0YTppbWFnZVwvLio7YmFzZTY0LC9pLnRlc3QoYmFja2dyb3VuZF9pbWFnZSkgJiYgIS9eKC13ZWJraXR8LW1venxsaW5lYXItZ3JhZGllbnR8LW8tKS8udGVzdChiYWNrZ3JvdW5kX2ltYWdlKSApIHsNCiAgICAgICAgICAgIGJhY2tncm91bmRfaW1hZ2UgPSBiYWNrZ3JvdW5kX2ltYWdlLnNwbGl0KCIsIilbMF07DQogICAgICAgIH0NCg0KICAgICAgICBpZiAoIHR5cGVvZiBiYWNrZ3JvdW5kX2ltYWdlICE9PSAidW5kZWZpbmVkIiAmJiAvXigxfG5vbmUpJC8udGVzdCggYmFja2dyb3VuZF9pbWFnZSApID09PSBmYWxzZSApIHsNCiAgICAgICAgICAgIGJhY2tncm91bmRfaW1hZ2UgPSBfaHRtbDJjYW52YXMuVXRpbC5iYWNrZ3JvdW5kSW1hZ2UoIGJhY2tncm91bmRfaW1hZ2UgKTsNCiAgICAgICAgICAgIGltYWdlID0gbG9hZEltYWdlKCBiYWNrZ3JvdW5kX2ltYWdlICk7DQoNCg0KICAgICAgICAgICAgYmdwID0gX2h0bWwyY2FudmFzLlV0aWwuQmFja2dyb3VuZFBvc2l0aW9uKGVsLCBib3VuZHMsIGltYWdlKTsNCg0KICAgICAgICAgICAgLy8gVE9ETyBhZGQgc3VwcG9ydCBmb3IgYmFja2dyb3VuZC1vcmlnaW4NCiAgICAgICAgICAgIGlmICggaW1hZ2UgKXsNCiAgICAgICAgICAgICAgICBzd2l0Y2ggKCBiYWNrZ3JvdW5kX3JlcGVhdCApIHsNCg0KICAgICAgICAgICAgICAgICAgICBjYXNlICJyZXBlYXQteCI6DQogICAgICAgICAgICAgICAgICAgICAgICByZW5kZXJCYWNrZ3JvdW5kUmVwZWF0WCggY3R4LCBpbWFnZSwgYmdwLCBib3VuZHMubGVmdCwgYm91bmRzLnRvcCwgYm91bmRzLndpZHRoLCBib3VuZHMuaGVpZ2h0ICk7DQogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsNCg0KICAgICAgICAgICAgICAgICAgICBjYXNlICJyZXBlYXQteSI6DQogICAgICAgICAgICAgICAgICAgICAgICByZW5kZXJCYWNrZ3JvdW5kUmVwZWF0WSggY3R4LCBpbWFnZSwgYmdwLCBib3VuZHMubGVmdCwgYm91bmRzLnRvcCwgYm91bmRzLndpZHRoLCBib3VuZHMuaGVpZ2h0ICk7DQogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsNCg0KICAgICAgICAgICAgICAgICAgICBjYXNlICJuby1yZXBlYXQiOg0KICAgICAgICAgICAgICAgICAgICAgICAgLyoNCiAgICAgICAgICAgICAgICAgICAgdGhpcy5kcmF3QmFja2dyb3VuZFJlcGVhdCgNCiAgICAgICAgICAgICAgICAgICAgICAgIGN0eCwNCiAgICAgICAgICAgICAgICAgICAgICAgIGltYWdlLA0KICAgICAgICAgICAgICAgICAgICAgICAgYmdwLmxlZnQrYm91bmRzLmxlZnQsIC8vIHN4DQogICAgICAgICAgICAgICAgICAgICAgICBiZ3AudG9wK2JvdW5kcy50b3AsIC8vIHN5DQogICAgICAgICAgICAgICAgICAgICAgICBNYXRoLm1pbihib3VuZHMud2lkdGgsaW1hZ2Uud2lkdGgpLA0KICAgICAgICAgICAgICAgICAgICAgICAgTWF0aC5taW4oYm91bmRzLmhlaWdodCxpbWFnZS5oZWlnaHQpLA0KICAgICAgICAgICAgICAgICAgICAgICAgYm91bmRzLmxlZnQsDQogICAgICAgICAgICAgICAgICAgICAgICBib3VuZHMudG9wDQogICAgICAgICAgICAgICAgICAgICAgICApOyovDQoNCg0KICAgICAgICAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICAgICAgICAgIGJndyA9IGJvdW5kcy53aWR0aCAtIGJncC5sZWZ0Ow0KICAgICAgICAgICAgICAgICAgICAgICAgYmdoID0gYm91bmRzLmhlaWdodCAtIGJncC50b3A7DQogICAgICAgICAgICAgICAgICAgICAgICBiZ3N4ID0gYmdwLmxlZnQ7DQogICAgICAgICAgICAgICAgICAgICAgICBiZ3N5ID0gYmdwLnRvcDsNCiAgICAgICAgICAgICAgICAgICAgICAgIGJnZHggPSBiZ3AubGVmdCtib3VuZHMubGVmdDsNCiAgICAgICAgICAgICAgICAgICAgICAgIGJnZHkgPSBiZ3AudG9wK2JvdW5kcy50b3A7DQoNCiAgICAgICAgICAgICAgICAgICAgICAgIC8vDQogICAgICAgICAgICAgICAgICAgICAgICAvLyAgICAgYmd3ID0gTWF0aC5taW4oYmd3LGltYWdlLndpZHRoKTsNCiAgICAgICAgICAgICAgICAgICAgICAgIC8vICBiZ2ggPSBNYXRoLm1pbihiZ2gsaW1hZ2UuaGVpZ2h0KTsNCg0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGJnc3g8MCl7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgYmdzeCA9IE1hdGguYWJzKGJnc3gpOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJnZHggKz0gYmdzeDsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBiZ3cgPSBNYXRoLm1pbihib3VuZHMud2lkdGgsaW1hZ2Uud2lkdGgtYmdzeCk7DQogICAgICAgICAgICAgICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBiZ3cgPSBNYXRoLm1pbihiZ3csaW1hZ2Uud2lkdGgpOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJnc3ggPSAwOw0KICAgICAgICAgICAgICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoYmdzeTwwKXsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBiZ3N5ID0gTWF0aC5hYnMoYmdzeSk7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgYmdkeSArPSBiZ3N5Ow0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGJnaCA9IGJnaC1iZ3N5Ow0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJnaCA9IE1hdGgubWluKGJvdW5kcy5oZWlnaHQsaW1hZ2UuaGVpZ2h0LWJnc3kpOw0KICAgICAgICAgICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgYmdoID0gTWF0aC5taW4oYmdoLGltYWdlLmhlaWdodCk7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgYmdzeSA9IDA7DQogICAgICAgICAgICAgICAgICAgICAgICB9DQoNCg0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGJnaD4wICYmIGJndyA+IDApew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlbmRlckltYWdlKA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdHgsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGltYWdlLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiZ3N4LCAvLyBzb3VyY2UgWCA6IDANCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYmdzeSwgLy8gc291cmNlIFkgOiAxNjk1DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJndywgLy8gc291cmNlIFdpZHRoIDogMTgNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYmdoLCAvLyBzb3VyY2UgSGVpZ2h0IDogMTY3Nw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiZ2R4LCAvLyBkZXN0aW5hdGlvbiBYIDo5MDYNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYmdkeSwgLy8gZGVzdGluYXRpb24gWSA6IDEwMjANCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYmd3LCAvLyBkZXN0aW5hdGlvbiB3aWR0aCA6IDE4DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJnaCAvLyBkZXN0aW5hdGlvbiBoZWlnaHQgOiAxNjc3DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7DQoNCiAgICAgICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgICAgICAgICBkZWZhdWx0Og0KDQoNCg0KICAgICAgICAgICAgICAgICAgICAgICAgYmdwLnRvcCA9IGJncC50b3AtTWF0aC5jZWlsKGJncC50b3AvaW1hZ2UuaGVpZ2h0KSppbWFnZS5oZWlnaHQ7DQoNCg0KICAgICAgICAgICAgICAgICAgICAgICAgZm9yKGJneT0oYm91bmRzLnRvcCtiZ3AudG9wKTtiZ3k8Ym91bmRzLmhlaWdodCtib3VuZHMudG9wOyl7DQoNCg0KDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaCA9IE1hdGgubWluKGltYWdlLmhlaWdodCwoYm91bmRzLmhlaWdodCtib3VuZHMudG9wKS1iZ3kpOw0KDQoNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIE1hdGguZmxvb3IoYmd5K2ltYWdlLmhlaWdodCk+aCtiZ3kpew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBoZWlnaHQgPSAoaCtiZ3kpLWJneTsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaGVpZ2h0ID0gaW1hZ2UuaGVpZ2h0Ow0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBjb25zb2xlLmxvZyhoZWlnaHQpOw0KDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGJneTxib3VuZHMudG9wKXsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWRkID0gYm91bmRzLnRvcC1iZ3k7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJneSA9IGJvdW5kcy50b3A7DQoNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWRkID0gMDsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9DQoNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZW5kZXJCYWNrZ3JvdW5kUmVwZWF0WChjdHgsaW1hZ2UsYmdwLGJvdW5kcy5sZWZ0LGJneSxib3VuZHMud2lkdGgsaGVpZ2h0KTsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYWRkPjApew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiZ3AudG9wICs9IGFkZDsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgYmd5ID0gTWF0aC5mbG9vcihiZ3kraW1hZ2UuaGVpZ2h0KS1hZGQ7DQogICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsNCg0KDQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgaDJjbG9nKCJodG1sMmNhbnZhczogRXJyb3IgbG9hZGluZyBiYWNrZ3JvdW5kOiIgKyBiYWNrZ3JvdW5kX2ltYWdlKTsNCiAgICAgICAgICAgIC8vY29uc29sZS5sb2coaW1hZ2VzKTsNCiAgICAgICAgICAgIH0NCg0KICAgICAgICB9DQogICAgfQ0KDQoNCg0KICAgIGZ1bmN0aW9uIHJlbmRlckVsZW1lbnQoZWwsIHBhcmVudFN0YWNrKXsNCg0KICAgICAgICB2YXIgYm91bmRzID0gX2h0bWwyY2FudmFzLlV0aWwuQm91bmRzKGVsKSwNCiAgICAgICAgeCA9IGJvdW5kcy5sZWZ0LA0KICAgICAgICB5ID0gYm91bmRzLnRvcCwNCiAgICAgICAgdyA9IGJvdW5kcy53aWR0aCwNCiAgICAgICAgaCA9IGJvdW5kcy5oZWlnaHQsDQogICAgICAgIGltYWdlLA0KICAgICAgICBiZ2NvbG9yID0gZ2V0Q1NTKGVsLCAiYmFja2dyb3VuZENvbG9yIiksDQogICAgICAgIGNzc1Bvc2l0aW9uID0gZ2V0Q1NTKGVsLCAicG9zaXRpb24iKSwNCiAgICAgICAgemluZGV4LA0KICAgICAgICBvcGFjaXR5ID0gZ2V0Q1NTKGVsLCAib3BhY2l0eSIpLA0KICAgICAgICBzdGFjaywNCiAgICAgICAgc3RhY2tMZW5ndGgsDQogICAgICAgIGJvcmRlcnMsDQogICAgICAgIGN0eCwNCiAgICAgICAgYmdib3VuZHMsDQogICAgICAgIGltZ1NyYywNCiAgICAgICAgcGFkZGluZ0xlZnQsDQogICAgICAgIHBhZGRpbmdUb3AsDQogICAgICAgIHBhZGRpbmdSaWdodCwNCiAgICAgICAgcGFkZGluZ0JvdHRvbTsNCg0KICAgICAgICBpZiAoIXBhcmVudFN0YWNrKXsNCiAgICAgICAgICAgIGRvY0RpbSA9IGRvY1NpemUoKTsNCiAgICAgICAgICAgIHBhcmVudFN0YWNrID0gew0KICAgICAgICAgICAgICAgIG9wYWNpdHk6IDENCiAgICAgICAgICAgIH07DQogICAgICAgIH1lbHNlew0KICAgICAgICAgICAgZG9jRGltID0ge307DQogICAgICAgIH0NCg0KDQogICAgICAgIC8vdmFyIHppbmRleCA9IHRoaXMuZm9ybWF0Wih0aGlzLmdldENTUyhlbCwiekluZGV4IiksY3NzUG9zaXRpb24scGFyZW50U3RhY2suekluZGV4LGVsLnBhcmVudE5vZGUpOw0KDQogICAgICAgIHppbmRleCA9IHNldFooIGdldENTUyggZWwsICJ6SW5kZXgiKSwgcGFyZW50U3RhY2suekluZGV4ICk7DQoNCg0KDQogICAgICAgIHN0YWNrID0gew0KICAgICAgICAgICAgY3R4OiBoMmNSZW5kZXJDb250ZXh0KCBkb2NEaW0ud2lkdGggfHwgdyAsIGRvY0RpbS5oZWlnaHQgfHwgaCApLA0KICAgICAgICAgICAgekluZGV4OiB6aW5kZXgsDQogICAgICAgICAgICBvcGFjaXR5OiBvcGFjaXR5ICogcGFyZW50U3RhY2sub3BhY2l0eSwNCiAgICAgICAgICAgIGNzc1Bvc2l0aW9uOiBjc3NQb3NpdGlvbg0KICAgICAgICB9Ow0KDQoNCg0KICAgICAgICAvLyBUT0RPIGNvcnJlY3Qgb3ZlcmZsb3cgZm9yIGFic29sdXRlIGNvbnRlbnQgcmVzaWRpbmcgdW5kZXIgYSBzdGF0aWMgcG9zaXRpb24NCg0KICAgICAgICBpZiAocGFyZW50U3RhY2suY2xpcCl7DQogICAgICAgICAgICBzdGFjay5jbGlwID0gX2h0bWwyY2FudmFzLlV0aWwuRXh0ZW5kKCB7fSwgcGFyZW50U3RhY2suY2xpcCApOw0KICAgICAgICAvL3N0YWNrLmNsaXAgPSBwYXJlbnRTdGFjay5jbGlwOw0KICAgICAgICAvLyAgIHN0YWNrLmNsaXAuaGVpZ2h0ID0gc3RhY2suY2xpcC5oZWlnaHQgLSBwYXJlbnRTdGFjay5ib3JkZXJzWzJdLndpZHRoOw0KICAgICAgICB9DQoNCg0KICAgICAgICBpZiAoIG9wdGlvbnMudXNlT3ZlcmZsb3cgPT09IHRydWUgJiYgLyhoaWRkZW58c2Nyb2xsfGF1dG8pLy50ZXN0KGdldENTUyhlbCwgIm92ZXJmbG93IikpID09PSB0cnVlICYmIC8oQk9EWSkvaS50ZXN0KGVsLm5vZGVOYW1lKSA9PT0gZmFsc2UgKXsNCiAgICAgICAgICAgIGlmIChzdGFjay5jbGlwKXsNCiAgICAgICAgICAgICAgICBzdGFjay5jbGlwID0gY2xpcEJvdW5kcyhzdGFjay5jbGlwLCBib3VuZHMpOw0KICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgc3RhY2suY2xpcCA9IGJvdW5kczsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KDQoNCiAgICAgICAgc3RhY2tMZW5ndGggPSAgemluZGV4LmNoaWxkcmVuLnB1c2goc3RhY2spOw0KDQogICAgICAgIGN0eCA9IHppbmRleC5jaGlsZHJlbltzdGFja0xlbmd0aC0xXS5jdHg7DQoNCiAgICAgICAgY3R4LnNldFZhcmlhYmxlKCJnbG9iYWxBbHBoYSIsIHN0YWNrLm9wYWNpdHkpOw0KDQogICAgICAgIC8vIGRyYXcgZWxlbWVudCBib3JkZXJzDQogICAgICAgIGJvcmRlcnMgPSByZW5kZXJCb3JkZXJzKGVsLCBjdHgsIGJvdW5kcywgZmFsc2UpOw0KICAgICAgICBzdGFjay5ib3JkZXJzID0gYm9yZGVyczsNCg0KDQogICAgICAgIC8vIGxldCdzIG1vZGlmeSBjbGlwIGFyZWEgZm9yIGNoaWxkIGVsZW1lbnRzLCBzbyBib3JkZXJzIGRvbnQgZ2V0IG92ZXJ3cml0dGVuDQoNCiAgICAgICAgLyoNCiAgICBpZiAoc3RhY2suY2xpcCl7DQogICAgICAgIHN0YWNrLmNsaXAud2lkdGggPSBzdGFjay5jbGlwLndpZHRoLShib3JkZXJzWzFdLndpZHRoKTsNCiAgICAgICAgc3RhY2suY2xpcC5oZWlnaHQgPSBzdGFjay5jbGlwLmhlaWdodC0oYm9yZGVyc1syXS53aWR0aCk7DQogICAgfQ0KICAgICAqLw0KICAgICAgICBpZiAoaWdub3JlRWxlbWVudHNSZWdFeHAudGVzdChlbC5ub2RlTmFtZSkgJiYgb3B0aW9ucy5pZnJhbWVEZWZhdWx0ICE9PSAidHJhbnNwYXJlbnQiKXsNCiAgICAgICAgICAgIGlmIChvcHRpb25zLmlmcmFtZURlZmF1bHQgPT09ICJkZWZhdWx0Iil7DQogICAgICAgICAgICAgICAgYmdjb2xvciA9ICIjZWZlZmVmIjsNCiAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgIGJnY29sb3IgPSBvcHRpb25zLmlmcmFtZURlZmF1bHQ7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCg0KICAgICAgICAvLyBkcmF3IGJhc2UgZWxlbWVudCBiZ2NvbG9yDQoNCiAgICAgICAgYmdib3VuZHMgPSB7DQogICAgICAgICAgICBsZWZ0OiB4ICsgYm9yZGVyc1szXS53aWR0aCwNCiAgICAgICAgICAgIHRvcDogeSArIGJvcmRlcnNbMF0ud2lkdGgsDQogICAgICAgICAgICB3aWR0aDogdyAtIChib3JkZXJzWzFdLndpZHRoICsgYm9yZGVyc1szXS53aWR0aCksDQogICAgICAgICAgICBoZWlnaHQ6IGggLSAoYm9yZGVyc1swXS53aWR0aCArIGJvcmRlcnNbMl0ud2lkdGgpDQogICAgICAgIH07DQoNCiAgICAgICAgLy9pZiAodGhpcy53aXRoaW5Cb3VuZHMoc3RhY2suY2xpcCxiZ2JvdW5kcykpew0KDQogICAgICAgIGlmIChzdGFjay5jbGlwKXsNCiAgICAgICAgICAgIGJnYm91bmRzID0gY2xpcEJvdW5kcyhiZ2JvdW5kcywgc3RhY2suY2xpcCk7DQoNCiAgICAgICAgLy99DQoNCiAgICAgICAgfQ0KDQoNCiAgICAgICAgaWYgKGJnYm91bmRzLmhlaWdodCA+IDAgJiYgYmdib3VuZHMud2lkdGggPiAwKXsNCiAgICAgICAgICAgIHJlbmRlclJlY3QoDQogICAgICAgICAgICAgICAgY3R4LA0KICAgICAgICAgICAgICAgIGJnYm91bmRzLmxlZnQsDQogICAgICAgICAgICAgICAgYmdib3VuZHMudG9wLA0KICAgICAgICAgICAgICAgIGJnYm91bmRzLndpZHRoLA0KICAgICAgICAgICAgICAgIGJnYm91bmRzLmhlaWdodCwNCiAgICAgICAgICAgICAgICBiZ2NvbG9yDQogICAgICAgICAgICAgICAgKTsNCg0KICAgICAgICAgICAgcmVuZGVyQmFja2dyb3VuZChlbCwgYmdib3VuZHMsIGN0eCk7DQogICAgICAgIH0NCg0KICAgICAgICBzd2l0Y2goZWwubm9kZU5hbWUpew0KICAgICAgICAgICAgY2FzZSAiSU1HIjoNCiAgICAgICAgICAgICAgICBpbWdTcmMgPSBlbC5nZXRBdHRyaWJ1dGUoJ3NyYycpOw0KICAgICAgICAgICAgICAgIGltYWdlID0gbG9hZEltYWdlKGltZ1NyYyk7DQogICAgICAgICAgICAgICAgaWYgKGltYWdlKXsNCg0KICAgICAgICAgICAgICAgICAgICBwYWRkaW5nTGVmdCA9IGdldENTU0ludChlbCwgJ3BhZGRpbmdMZWZ0Jyk7DQogICAgICAgICAgICAgICAgICAgIHBhZGRpbmdUb3AgPSBnZXRDU1NJbnQoZWwsICdwYWRkaW5nVG9wJyk7DQogICAgICAgICAgICAgICAgICAgIHBhZGRpbmdSaWdodCA9IGdldENTU0ludChlbCwgJ3BhZGRpbmdSaWdodCcpOw0KICAgICAgICAgICAgICAgICAgICBwYWRkaW5nQm90dG9tID0gZ2V0Q1NTSW50KGVsLCAncGFkZGluZ0JvdHRvbScpOw0KDQoNCiAgICAgICAgICAgICAgICAgICAgcmVuZGVySW1hZ2UoDQogICAgICAgICAgICAgICAgICAgICAgICBjdHgsDQogICAgICAgICAgICAgICAgICAgICAgICBpbWFnZSwNCiAgICAgICAgICAgICAgICAgICAgICAgIDAsIC8vc3gNCiAgICAgICAgICAgICAgICAgICAgICAgIDAsIC8vc3kNCiAgICAgICAgICAgICAgICAgICAgICAgIGltYWdlLndpZHRoLCAvL3N3DQogICAgICAgICAgICAgICAgICAgICAgICBpbWFnZS5oZWlnaHQsIC8vc2gNCiAgICAgICAgICAgICAgICAgICAgICAgIHggKyBwYWRkaW5nTGVmdCArIGJvcmRlcnNbM10ud2lkdGgsIC8vZHgNCiAgICAgICAgICAgICAgICAgICAgICAgIHkgKyBwYWRkaW5nVG9wICsgYm9yZGVyc1swXS53aWR0aCwgLy8gZHkNCiAgICAgICAgICAgICAgICAgICAgICAgIGJvdW5kcy53aWR0aCAtIChib3JkZXJzWzFdLndpZHRoICsgYm9yZGVyc1szXS53aWR0aCArIHBhZGRpbmdMZWZ0ICsgcGFkZGluZ1JpZ2h0KSwgLy9kdw0KICAgICAgICAgICAgICAgICAgICAgICAgYm91bmRzLmhlaWdodCAtIChib3JkZXJzWzBdLndpZHRoICsgYm9yZGVyc1syXS53aWR0aCArIHBhZGRpbmdUb3AgKyBwYWRkaW5nQm90dG9tKSAvL2RoDQogICAgICAgICAgICAgICAgICAgICAgICApOw0KDQogICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgIGgyY2xvZygiaHRtbDJjYW52YXM6IEVycm9yIGxvYWRpbmcgPGltZz46IiArIGltZ1NyYyk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgY2FzZSAiSU5QVVQiOg0KICAgICAgICAgICAgICAgIC8vIFRPRE8gYWRkIGFsbCByZWxldmFudCB0eXBlJ3MsIGkuZS4gSFRNTDUgbmV3IHN0dWZmDQogICAgICAgICAgICAgICAgLy8gdG9kbyBhZGQgc3VwcG9ydCBmb3IgcGxhY2Vob2xkZXIgYXR0cmlidXRlIGZvciBicm93c2VycyB3aGljaCBzdXBwb3J0IGl0DQogICAgICAgICAgICAgICAgaWYgKC9eKHRleHR8dXJsfGVtYWlsfHN1Ym1pdHxidXR0b258cmVzZXQpJC8udGVzdChlbC50eXBlKSAmJiBlbC52YWx1ZS5sZW5ndGggPiAwKXsNCg0KICAgICAgICAgICAgICAgICAgICByZW5kZXJGb3JtVmFsdWUoZWwsIGJvdW5kcywgc3RhY2spOw0KDQoNCiAgICAgICAgICAgICAgICAvKg0KICAgICAgICAgICAgICAgICB0aGlzIGp1c3QgZG9lc24ndCB3b3JrIHdlbGwgZW5vdWdoDQoNCiAgICAgICAgICAgICAgICB0aGlzLm5ld1RleHQoZWwsew0KICAgICAgICAgICAgICAgICAgICBub2RlVmFsdWU6ZWwudmFsdWUsDQogICAgICAgICAgICAgICAgICAgIHNwbGl0VGV4dDogZnVuY3Rpb24oKXsNCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgICAgICAgICAgICAgICB9LA0KICAgICAgICAgICAgICAgICAgICBmb3JtVmFsdWU6dHJ1ZQ0KICAgICAgICAgICAgICAgIH0sc3RhY2spOw0KICAgICAgICAgICAgICAgICAqLw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgIGNhc2UgIlRFWFRBUkVBIjoNCiAgICAgICAgICAgICAgICBpZiAoZWwudmFsdWUubGVuZ3RoID4gMCl7DQogICAgICAgICAgICAgICAgICAgIHJlbmRlckZvcm1WYWx1ZShlbCwgYm91bmRzLCBzdGFjayk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgY2FzZSAiU0VMRUNUIjoNCiAgICAgICAgICAgICAgICBpZiAoZWwub3B0aW9ucy5sZW5ndGggPiAwKXsNCiAgICAgICAgICAgICAgICAgICAgcmVuZGVyRm9ybVZhbHVlKGVsLCBib3VuZHMsIHN0YWNrKTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICBjYXNlICJMSSI6DQogICAgICAgICAgICAgICAgcmVuZGVyTGlzdEl0ZW0oZWwsIHN0YWNrLCBiZ2JvdW5kcyk7DQogICAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICBjYXNlICJDQU5WQVMiOg0KICAgICAgICAgICAgICAgIHBhZGRpbmdMZWZ0ID0gZ2V0Q1NTSW50KGVsLCAncGFkZGluZ0xlZnQnKTsNCiAgICAgICAgICAgICAgICBwYWRkaW5nVG9wID0gZ2V0Q1NTSW50KGVsLCAncGFkZGluZ1RvcCcpOw0KICAgICAgICAgICAgICAgIHBhZGRpbmdSaWdodCA9IGdldENTU0ludChlbCwgJ3BhZGRpbmdSaWdodCcpOw0KICAgICAgICAgICAgICAgIHBhZGRpbmdCb3R0b20gPSBnZXRDU1NJbnQoZWwsICdwYWRkaW5nQm90dG9tJyk7DQogICAgICAgICAgICAgICAgcmVuZGVySW1hZ2UoDQogICAgICAgICAgICAgICAgICAgIGN0eCwNCiAgICAgICAgICAgICAgICAgICAgZWwsDQogICAgICAgICAgICAgICAgICAgIDAsIC8vc3gNCiAgICAgICAgICAgICAgICAgICAgMCwgLy9zeQ0KICAgICAgICAgICAgICAgICAgICBlbC53aWR0aCwgLy9zdw0KICAgICAgICAgICAgICAgICAgICBlbC5oZWlnaHQsIC8vc2gNCiAgICAgICAgICAgICAgICAgICAgeCArIHBhZGRpbmdMZWZ0ICsgYm9yZGVyc1szXS53aWR0aCwgLy9keA0KICAgICAgICAgICAgICAgICAgICB5ICsgcGFkZGluZ1RvcCArIGJvcmRlcnNbMF0ud2lkdGgsIC8vIGR5DQogICAgICAgICAgICAgICAgICAgIGJvdW5kcy53aWR0aCAtIChib3JkZXJzWzFdLndpZHRoICsgYm9yZGVyc1szXS53aWR0aCArIHBhZGRpbmdMZWZ0ICsgcGFkZGluZ1JpZ2h0KSwgLy9kdw0KICAgICAgICAgICAgICAgICAgICBib3VuZHMuaGVpZ2h0IC0gKGJvcmRlcnNbMF0ud2lkdGggKyBib3JkZXJzWzJdLndpZHRoICsgcGFkZGluZ1RvcCArIHBhZGRpbmdCb3R0b20pIC8vZGgNCiAgICAgICAgICAgICAgICAgICAgKTsNCiAgICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgfQ0KDQogICAgICAgIHJldHVybiB6aW5kZXguY2hpbGRyZW5bc3RhY2tMZW5ndGggLSAxXTsNCiAgICB9DQoNCg0KDQogICAgZnVuY3Rpb24gcGFyc2VFbGVtZW50IChlbCwgc3RhY2spIHsNCg0KICAgICAgICAvLyBza2lwIGhpZGRlbiBlbGVtZW50cyBhbmQgdGhlaXIgY2hpbGRyZW4NCiAgICAgICAgaWYgKGdldENTUyhlbCwgJ2Rpc3BsYXknKSAhPT0gIm5vbmUiICYmIGdldENTUyhlbCwgJ3Zpc2liaWxpdHknKSAhPT0gImhpZGRlbiIpIHsNCg0KICAgICAgICAgICAgc3RhY2sgPSByZW5kZXJFbGVtZW50KGVsLCBzdGFjaykgfHwgc3RhY2s7DQoNCiAgICAgICAgICAgIGN0eCA9IHN0YWNrLmN0eDsNCg0KICAgICAgICAgICAgaWYgKCAhaWdub3JlRWxlbWVudHNSZWdFeHAudGVzdCggZWwubm9kZU5hbWUgKSApIHsNCiAgICAgICAgICAgICAgICB2YXIgZWxlbWVudENoaWxkcmVuID0gX2h0bWwyY2FudmFzLlV0aWwuQ2hpbGRyZW4oIGVsICksDQogICAgICAgICAgICAgICAgaSwNCiAgICAgICAgICAgICAgICBub2RlLA0KICAgICAgICAgICAgICAgIGNoaWxkcmVuTGVuOw0KICAgICAgICAgICAgICAgIGZvciAoaSA9IDAsIGNoaWxkcmVuTGVuID0gZWxlbWVudENoaWxkcmVuLmxlbmd0aDsgaSA8IGNoaWxkcmVuTGVuOyBpKz0xKSB7DQogICAgICAgICAgICAgICAgICAgIG5vZGUgPSBlbGVtZW50Q2hpbGRyZW5baV07DQoNCiAgICAgICAgICAgICAgICAgICAgaWYgKCBub2RlLm5vZGVUeXBlID09PSAxICkgew0KICAgICAgICAgICAgICAgICAgICAgICAgcGFyc2VFbGVtZW50KG5vZGUsIHN0YWNrKTsNCiAgICAgICAgICAgICAgICAgICAgfWVsc2UgaWYgKCBub2RlLm5vZGVUeXBlID09PSAzICkgew0KICAgICAgICAgICAgICAgICAgICAgICAgcmVuZGVyVGV4dChlbCwgbm9kZSwgc3RhY2spOw0KICAgICAgICAgICAgICAgICAgICB9DQoNCiAgICAgICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIH0NCiAgICAgICAgfSANCiAgICB9DQoNCiAgICBzdGFjayA9IHJlbmRlckVsZW1lbnQoZWxlbWVudCwgbnVsbCk7DQoNCiAgICAvKg0KICAgIFNWRyBwb3dlcmVkIEhUTUwgcmVuZGVyaW5nLCBub24tdGFpbnRlZCBjYW52YXMgYXZhaWxhYmxlIGZyb20gRkYgMTErIG9ud2FyZHMNCiAgICAqLw0KDQogICAgaWYgKCBzdXBwb3J0LnN2Z1JlbmRlcmluZyApIHsNCiAgICAgICAgKGZ1bmN0aW9uKCBib2R5ICl7DQogICAgICAgICAgICB2YXIgaW1nID0gbmV3IEltYWdlKCksDQogICAgICAgICAgICBzaXplID0gIGRvY1NpemUoKSwNCiAgICAgICAgICAgIGh0bWwgPSAiIjsNCg0KICAgICAgICAgICAgZnVuY3Rpb24gcGFyc2VET00oIGVsICkgew0KICAgICAgICAgICAgICAgIHZhciBjaGlsZHJlbiA9IF9odG1sMmNhbnZhcy5VdGlsLkNoaWxkcmVuKCBlbCApLA0KICAgICAgICAgICAgICAgIGxlbiA9IGNoaWxkcmVuLmxlbmd0aCwNCiAgICAgICAgICAgICAgICBhdHRyLA0KICAgICAgICAgICAgICAgIGEsDQogICAgICAgICAgICAgICAgYWxlbiwNCiAgICAgICAgICAgICAgICBlbG0sDQogICAgICAgICAgICAgICAgaTsNCiAgICAgICAgICAgICAgICBmb3IgKCBpID0gMDsgaSA8IGxlbjsgaSs9MSApIHsNCiAgICAgICAgICAgICAgICAgICAgZWxtID0gY2hpbGRyZW5bIGkgXTsNCiAgICAgICAgICAgICAgICAgICAgaWYgKCBlbG0ubm9kZVR5cGUgPT09IDMgKSB7DQogICAgICAgICAgICAgICAgICAgICAgICAvLyBUZXh0IG5vZGUNCg0KICAgICAgICAgICAgICAgICAgICAgICAgaHRtbCArPSBlbG0ubm9kZVZhbHVlLnJlcGxhY2UoL1w8L2csIiZsdDsiKS5yZXBsYWNlKC9cPi9nLCImZ3Q7Iik7DQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoIGVsbS5ub2RlVHlwZSA9PT0gMSApIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEVsZW1lbnQNCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICggIS9eKHNjcmlwdHxtZXRhfHRpdGxlKSQvLnRlc3QoZWxtLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkpICkgew0KDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaHRtbCArPSAiPCIgKyBlbG0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKTsNCg0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGFkZCBhdHRyaWJ1dGVzDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCBlbG0uaGFzQXR0cmlidXRlcygpICkgew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhdHRyID0gZWxtLmF0dHJpYnV0ZXM7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFsZW4gPSBhdHRyLmxlbmd0aDsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yICggYSA9IDA7IGEgPCBhbGVuOyBhKz0xICkgew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaHRtbCArPSAiICIgKyBhdHRyWyBhIF0ubmFtZSArICc9IicgKyBhdHRyWyBhIF0udmFsdWUgKyAnIic7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9DQoNCg0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGh0bWwgKz0gJz4nOw0KDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFyc2VET00oIGVsbSApOw0KDQoNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBodG1sICs9ICI8LyIgKyBlbG0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKSArICI+IjsNCiAgICAgICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIHBhcnNlRE9NKCBib2R5ICk7DQogICAgICAgICAgICBpbWcuc3JjID0gWw0KICAgICAgICAgICAgImRhdGE6aW1hZ2Uvc3ZnK3htbCwiLA0KICAgICAgICAgICAgIjxzdmcgeG1sbnM9J2h0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnJyB2ZXJzaW9uPScxLjEnIHdpZHRoPSciICsgc2l6ZS53aWR0aCArICInIGhlaWdodD0nIiArIHNpemUuaGVpZ2h0ICsgIic+IiwNCiAgICAgICAgICAgICI8Zm9yZWlnbk9iamVjdCB3aWR0aD0nIiArIHNpemUud2lkdGggKyAiJyBoZWlnaHQ9JyIgKyBzaXplLmhlaWdodCArICInPiIsDQogICAgICAgICAgICAiPGh0bWwgeG1sbnM9J2h0dHA6Ly93d3cudzMub3JnLzE5OTkveGh0bWwnIHN0eWxlPSdtYXJnaW46MDsnPiIsDQogICAgICAgICAgICBodG1sLnJlcGxhY2UoL1wjL2csIiUyMyIpLA0KICAgICAgICAgICAgIjwvaHRtbD4iLA0KICAgICAgICAgICAgIjwvZm9yZWlnbk9iamVjdD4iLA0KICAgICAgICAgICAgIjwvc3ZnPiINCiAgICAgICAgICAgIF0uam9pbigiIik7DQoNCg0KDQoNCiAgICAgICAgICAgIGltZy5vbmxvYWQgPSBmdW5jdGlvbigpIHsNCiAgICAgICAgICAgICAgICBzdGFjay5zdmdSZW5kZXIgPSBpbWc7DQogICAgICAgICAgICB9Ow0KDQogICAgICAgIH0pKCBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQgKTsNCg0KICAgIH0NCg0KDQogICAgLy8gcGFyc2UgZXZlcnkgY2hpbGQgZWxlbWVudA0KICAgIGZvciAoaSA9IDAsIGNoaWxkcmVuID0gZWxlbWVudC5jaGlsZHJlbiwgY2hpbGRyZW5MZW4gPSBjaGlsZHJlbi5sZW5ndGg7IGkgPCBjaGlsZHJlbkxlbjsgaSs9MSl7DQogICAgICAgIHBhcnNlRWxlbWVudChjaGlsZHJlbltpXSwgc3RhY2spOw0KICAgIH0NCg0KDQogICAgc3RhY2suYmFja2dyb3VuZENvbG9yID0gZ2V0Q1NTKCBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQsICJiYWNrZ3JvdW5kQ29sb3IiICk7DQoNCiAgICByZXR1cm4gc3RhY2s7DQoNCn07DQoNCmZ1bmN0aW9uIGgyY3pDb250ZXh0KHppbmRleCkgew0KICAgIHJldHVybiB7DQogICAgICAgIHppbmRleDogemluZGV4LA0KICAgICAgICBjaGlsZHJlbjogW10NCiAgICB9Ow0KfQ0KDQovKg0KICBodG1sMmNhbnZhcyB2MC4zNCA8aHR0cDovL2h0bWwyY2FudmFzLmhlcnR6ZW4uY29tPg0KICBDb3B5cmlnaHQgKGMpIDIwMTEgTmlrbGFzIHZvbiBIZXJ0emVuLiBBbGwgcmlnaHRzIHJlc2VydmVkLg0KICBodHRwOi8vd3d3LnR3aXR0ZXIuY29tL25pa2xhc3ZoDQoNCiAgUmVsZWFzZWQgdW5kZXIgTUlUIExpY2Vuc2UNCiAqLw0KDQpfaHRtbDJjYW52YXMuUHJlbG9hZCA9IGZ1bmN0aW9uKCBvcHRpb25zICkgew0KDQogICAgdmFyIGltYWdlcyA9IHsNCiAgICAgICAgbnVtTG9hZGVkOiAwLCAgIC8vIGFsc28gZmFpbGVkIGFyZSBjb3VudGVkIGhlcmUNCiAgICAgICAgbnVtRmFpbGVkOiAwLA0KICAgICAgICBudW1Ub3RhbDogMCwNCiAgICAgICAgY2xlYW51cERvbmU6IGZhbHNlDQogICAgfSwNCiAgICBwYWdlT3JpZ2luLA0KICAgIG1ldGhvZHMsDQogICAgaSwNCiAgICBjb3VudCA9IDAsDQogICAgZWxlbWVudCA9IG9wdGlvbnMuZWxlbWVudHNbMF0gfHwgZG9jdW1lbnQuYm9keSwNCiAgICBkb2MgPSBlbGVtZW50Lm93bmVyRG9jdW1lbnQsDQogICAgZG9tSW1hZ2VzID0gZG9jLmltYWdlcywgLy8gVE9ETyBwcm9iYWJseSBzaG91bGQgbGltaXQgaXQgdG8gaW1hZ2VzIHByZXNlbnQgaW4gdGhlIGVsZW1lbnQgb25seQ0KICAgIGltZ0xlbiA9IGRvbUltYWdlcy5sZW5ndGgsDQogICAgbGluayA9IGRvYy5jcmVhdGVFbGVtZW50KCJhIiksDQogICAgc3VwcG9ydENPUlMgPSAoZnVuY3Rpb24oIGltZyApew0KICAgICAgICByZXR1cm4gKGltZy5jcm9zc09yaWdpbiAhPT0gdW5kZWZpbmVkKTsNCiAgICB9KShuZXcgSW1hZ2UoKSksDQogICAgdGltZW91dFRpbWVyOw0KDQogICAgbGluay5ocmVmID0gd2luZG93LmxvY2F0aW9uLmhyZWY7DQogICAgcGFnZU9yaWdpbiAgPSBsaW5rLnByb3RvY29sICsgbGluay5ob3N0Ow0KDQoNCg0KDQoNCg0KICAgIGZ1bmN0aW9uIGlzU2FtZU9yaWdpbih1cmwpew0KICAgICAgICBsaW5rLmhyZWYgPSB1cmw7DQogICAgICAgIGxpbmsuaHJlZiA9IGxpbmsuaHJlZjsgLy8gWUVTLCBCRUxJRVZFIElUIE9SIE5PVCwgdGhhdCBpcyByZXF1aXJlZCBmb3IgSUU5IC0gaHR0cDovL2pzZmlkZGxlLm5ldC9uaWtsYXN2aC8yZTQ4Yi8NCiAgICAgICAgdmFyIG9yaWdpbiA9IGxpbmsucHJvdG9jb2wgKyBsaW5rLmhvc3Q7DQogICAgICAgIHJldHVybiAob3JpZ2luID09PSBwYWdlT3JpZ2luKTsNCiAgICB9DQoNCiAgICBmdW5jdGlvbiBzdGFydCgpew0KICAgICAgICBoMmNsb2coImh0bWwyY2FudmFzOiBzdGFydDogaW1hZ2VzOiAiICsgaW1hZ2VzLm51bUxvYWRlZCArICIgLyAiICsgaW1hZ2VzLm51bVRvdGFsICsgIiAoZmFpbGVkOiAiICsgaW1hZ2VzLm51bUZhaWxlZCArICIpIik7DQogICAgICAgIGlmICghaW1hZ2VzLmZpcnN0UnVuICYmIGltYWdlcy5udW1Mb2FkZWQgPj0gaW1hZ2VzLm51bVRvdGFsKXsNCiAgICAgICAgICAgIGgyY2xvZygiRmluaXNoZWQgbG9hZGluZyBpbWFnZXM6ICMgIiArIGltYWdlcy5udW1Ub3RhbCArICIgKGZhaWxlZDogIiArIGltYWdlcy5udW1GYWlsZWQgKyAiKSIpOw0KDQogICAgICAgICAgICBpZiAodHlwZW9mIG9wdGlvbnMuY29tcGxldGUgPT09ICJmdW5jdGlvbiIpew0KICAgICAgICAgICAgICAgIG9wdGlvbnMuY29tcGxldGUoaW1hZ2VzKTsNCiAgICAgICAgICAgIH0NCg0KICAgICAgICB9DQogICAgfQ0KDQogICAgLy8gVE9ETyBtb2RpZnkgcHJveHkgdG8gc2VydmUgaW1hZ2VzIHdpdGggQ09SUyBlbmFibGVkLCB3aGVyZSBhdmFpbGFibGUNCiAgICBmdW5jdGlvbiBwcm94eUdldEltYWdlKHVybCwgaW1nLCBpbWFnZU9iail7DQogICAgICAgIHZhciBjYWxsYmFja19uYW1lLA0KICAgICAgICBzY3JpcHRVcmwgPSBvcHRpb25zLnByb3h5LA0KICAgICAgICBzY3JpcHQ7DQoNCiAgICAgICAgbGluay5ocmVmID0gdXJsOw0KICAgICAgICB1cmwgPSBsaW5rLmhyZWY7IC8vIHdvcmsgYXJvdW5kIGZvciBwYWdlcyB3aXRoIGJhc2UgaHJlZj0iIiBzZXQgLSBXQVJOSU5HOiB0aGlzIG1heSBjaGFuZ2UgdGhlIHVybA0KDQogICAgICAgIGNhbGxiYWNrX25hbWUgPSAnaHRtbDJjYW52YXNfJyArIChjb3VudCsrKTsNCiAgICAgICAgaW1hZ2VPYmouY2FsbGJhY2tuYW1lID0gY2FsbGJhY2tfbmFtZTsNCg0KICAgICAgICBpZiAoc2NyaXB0VXJsLmluZGV4T2YoIj8iKSA+IC0xKSB7DQogICAgICAgICAgICBzY3JpcHRVcmwgKz0gIiYiOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgc2NyaXB0VXJsICs9ICI/IjsNCiAgICAgICAgfQ0KICAgICAgICBzY3JpcHRVcmwgKz0gJ3VybD0nICsgZW5jb2RlVVJJQ29tcG9uZW50KHVybCkgKyAnJmNhbGxiYWNrPScgKyBjYWxsYmFja19uYW1lOw0KICAgICAgICBzY3JpcHQgPSBkb2MuY3JlYXRlRWxlbWVudCgic2NyaXB0Iik7DQoNCiAgICAgICAgd2luZG93W2NhbGxiYWNrX25hbWVdID0gZnVuY3Rpb24oYSl7DQogICAgICAgICAgICBpZiAoYS5zdWJzdHJpbmcoMCw2KSA9PT0gImVycm9yOiIpew0KICAgICAgICAgICAgICAgIGltYWdlT2JqLnN1Y2NlZWRlZCA9IGZhbHNlOw0KICAgICAgICAgICAgICAgIGltYWdlcy5udW1Mb2FkZWQrKzsNCiAgICAgICAgICAgICAgICBpbWFnZXMubnVtRmFpbGVkKys7DQogICAgICAgICAgICAgICAgc3RhcnQoKTsNCiAgICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICAgICAgc2V0SW1hZ2VMb2FkSGFuZGxlcnMoaW1nLCBpbWFnZU9iaik7DQogICAgICAgICAgICAgICAgaW1nLnNyYyA9IGE7DQogICAgICAgICAgICB9DQogICAgICAgICAgICB3aW5kb3dbY2FsbGJhY2tfbmFtZV0gPSB1bmRlZmluZWQ7IC8vIHRvIHdvcmsgd2l0aCBJRTw5ICAvLyBOT1RFOiB0aGF0IHRoZSB1bmRlZmluZWQgY2FsbGJhY2sgcHJvcGVydHktbmFtZSBzdGlsbCBleGlzdHMgb24gdGhlIHdpbmRvdyBvYmplY3QgKGZvciBJRTw5KQ0KICAgICAgICAgICAgdHJ5IHsNCiAgICAgICAgICAgICAgICBkZWxldGUgd2luZG93W2NhbGxiYWNrX25hbWVdOyAgLy8gZm9yIGFsbCBicm93c2VyIHRoYXQgc3VwcG9ydCB0aGlzDQogICAgICAgICAgICB9IGNhdGNoKGV4KSB7fQ0KICAgICAgICAgICAgc2NyaXB0LnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoc2NyaXB0KTsNCiAgICAgICAgICAgIHNjcmlwdCA9IG51bGw7DQogICAgICAgICAgICBkZWxldGUgaW1hZ2VPYmouc2NyaXB0Ow0KICAgICAgICAgICAgZGVsZXRlIGltYWdlT2JqLmNhbGxiYWNrbmFtZTsNCiAgICAgICAgfTsNCg0KICAgICAgICBzY3JpcHQuc2V0QXR0cmlidXRlKCJ0eXBlIiwgInRleHQvamF2YXNjcmlwdCIpOw0KICAgICAgICBzY3JpcHQuc2V0QXR0cmlidXRlKCJzcmMiLCBzY3JpcHRVcmwpOw0KICAgICAgICBpbWFnZU9iai5zY3JpcHQgPSBzY3JpcHQ7DQogICAgICAgIHdpbmRvdy5kb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKHNjcmlwdCk7DQoNCiAgICB9DQoNCiAgICBmdW5jdGlvbiBnZXRJbWFnZXMgKGVsKSB7DQoNCg0KDQogICAgICAgIC8vIGlmICghdGhpcy5pZ25vcmVSZS50ZXN0KGVsLm5vZGVOYW1lKSl7DQogICAgICAgIC8vDQogICAgICAgIA0KICAgICAgICB2YXIgY29udGVudHMgPSBfaHRtbDJjYW52YXMuVXRpbC5DaGlsZHJlbihlbCksDQogICAgICAgIGksDQogICAgICAgIGJhY2tncm91bmRfaW1hZ2UsDQogICAgICAgIHNyYywNCiAgICAgICAgaW1nLA0KICAgICAgICBlbE5vZGVUeXBlID0gZmFsc2U7DQoNCiAgICAgICAgLy8gRmlyZWZveCBmYWlscyB3aXRoIHBlcm1pc3Npb24gZGVuaWVkIG9uIHBhZ2VzIHdpdGggaWZyYW1lcw0KICAgICAgICB0cnkgew0KICAgICAgICAgICAgdmFyIGNvbnRlbnRzTGVuID0gY29udGVudHMubGVuZ3RoOw0KICAgICAgICAgICAgZm9yIChpID0gMDsgIGkgPCBjb250ZW50c0xlbjsgaSs9MSApew0KICAgICAgICAgICAgICAgIC8vIHZhciBpZ25SZSA9IG5ldyBSZWdFeHAoIigiK3RoaXMuaWdub3JlRWxlbWVudHMrIikiKTsNCiAgICAgICAgICAgICAgICAvLyBpZiAoIWlnblJlLnRlc3QoZWxlbWVudC5ub2RlTmFtZSkpew0KICAgICAgICAgICAgICAgIGdldEltYWdlcyhjb250ZW50c1tpXSk7DQogICAgICAgICAgICAgICAgLy8gfQ0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICAgIGNhdGNoKCBlICkge30NCg0KDQogICAgICAgIC8vIH0NCiAgICAgICAgdHJ5IHsNCiAgICAgICAgICAgIGVsTm9kZVR5cGUgPSBlbC5ub2RlVHlwZTsNCiAgICAgICAgfSBjYXRjaCAoZXgpIHsNCiAgICAgICAgICAgIGVsTm9kZVR5cGUgPSBmYWxzZTsNCiAgICAgICAgICAgIGgyY2xvZygiaHRtbDJjYW52YXM6IGZhaWxlZCB0byBhY2Nlc3Mgc29tZSBlbGVtZW50J3Mgbm9kZVR5cGUgLSBFeGNlcHRpb246ICIgKyBleC5tZXNzYWdlKTsNCiAgICAgICAgfQ0KDQogICAgICAgIGlmIChlbE5vZGVUeXBlID09PSAxIHx8IGVsTm9kZVR5cGUgPT09IHVuZGVmaW5lZCl7DQoNCiAgICAgICAgICAgIC8vIG9wZXJhIHRocm93cyBleGNlcHRpb24gb24gZXh0ZXJuYWwtY29udGVudC5odG1sDQogICAgICAgICAgICB0cnkgew0KICAgICAgICAgICAgICAgIGJhY2tncm91bmRfaW1hZ2UgPSBfaHRtbDJjYW52YXMuVXRpbC5nZXRDU1MoZWwsICdiYWNrZ3JvdW5kSW1hZ2UnKTsNCiAgICAgICAgICAgIH1jYXRjaChlKSB7DQogICAgICAgICAgICAgICAgaDJjbG9nKCJodG1sMmNhbnZhczogZmFpbGVkIHRvIGdldCBiYWNrZ3JvdW5kLWltYWdlIC0gRXhjZXB0aW9uOiAiICsgZS5tZXNzYWdlKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGlmICggYmFja2dyb3VuZF9pbWFnZSAmJiBiYWNrZ3JvdW5kX2ltYWdlICE9PSAiMSIgJiYgYmFja2dyb3VuZF9pbWFnZSAhPT0gIm5vbmUiICkgew0KDQogICAgICAgICAgICAgICAgLy8gVE9ETyBhZGQgbXVsdGkgaW1hZ2UgYmFja2dyb3VuZCBzdXBwb3J0DQoNCiAgICAgICAgICAgICAgICBpZiAoL14oLXdlYmtpdHwtb3wtbW96fC1tc3xsaW5lYXIpLS8udGVzdCggYmFja2dyb3VuZF9pbWFnZSApKSB7DQoNCiAgICAgICAgICAgICAgICAgICAgaW1nID0gX2h0bWwyY2FudmFzLkdlbmVyYXRlLkdyYWRpZW50KCBiYWNrZ3JvdW5kX2ltYWdlLCBfaHRtbDJjYW52YXMuVXRpbC5Cb3VuZHMoIGVsICkgKTsNCg0KICAgICAgICAgICAgICAgICAgICBpZiAoIGltZyAhPT0gdW5kZWZpbmVkICl7DQogICAgICAgICAgICAgICAgICAgICAgICBpbWFnZXNbYmFja2dyb3VuZF9pbWFnZV0gPSB7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaW1nOiBpbWcsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3VjY2VlZGVkOiB0cnVlDQogICAgICAgICAgICAgICAgICAgICAgICB9Ow0KICAgICAgICAgICAgICAgICAgICAgICAgaW1hZ2VzLm51bVRvdGFsKys7DQogICAgICAgICAgICAgICAgICAgICAgICBpbWFnZXMubnVtTG9hZGVkKys7DQogICAgICAgICAgICAgICAgICAgICAgICBzdGFydCgpOw0KDQogICAgICAgICAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICAgICAgICAgIHNyYyA9IF9odG1sMmNhbnZhcy5VdGlsLmJhY2tncm91bmRJbWFnZShiYWNrZ3JvdW5kX2ltYWdlLm1hdGNoKC9kYXRhOmltYWdlXC8uKjtiYXNlNjQsL2kpID8gYmFja2dyb3VuZF9pbWFnZSA6IGJhY2tncm91bmRfaW1hZ2Uuc3BsaXQoIiwiKVswXSk7DQogICAgICAgICAgICAgICAgICAgIG1ldGhvZHMubG9hZEltYWdlKHNyYyk7DQogICAgICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAgICAgLyoNCiAgICAgICAgICAgIGlmIChiYWNrZ3JvdW5kX2ltYWdlICYmIGJhY2tncm91bmRfaW1hZ2UgIT09ICIxIiAmJiBiYWNrZ3JvdW5kX2ltYWdlICE9PSAibm9uZSIgJiYgYmFja2dyb3VuZF9pbWFnZS5zdWJzdHJpbmcoMCw3KSAhPT0gIi13ZWJraXQiICYmIGJhY2tncm91bmRfaW1hZ2Uuc3Vic3RyaW5nKDAsMykhPT0gIi1vLSIgJiYgYmFja2dyb3VuZF9pbWFnZS5zdWJzdHJpbmcoMCw0KSAhPT0gIi1tb3oiKXsNCiAgICAgICAgICAgICAgICAvLyBUT0RPIGFkZCBtdWx0aSBpbWFnZSBiYWNrZ3JvdW5kIHN1cHBvcnQNCiAgICAgICAgICAgICAgICBzcmMgPSBfaHRtbDJjYW52YXMuVXRpbC5iYWNrZ3JvdW5kSW1hZ2UoYmFja2dyb3VuZF9pbWFnZS5zcGxpdCgiLCIpWzBdKTsNCiAgICAgICAgICAgICAgICBtZXRob2RzLmxvYWRJbWFnZShzcmMpOyAgICAgICAgICAgICovDQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICB9DQoNCiAgICBmdW5jdGlvbiBzZXRJbWFnZUxvYWRIYW5kbGVycyhpbWcsIGltYWdlT2JqKSB7DQogICAgICAgIGltZy5vbmxvYWQgPSBmdW5jdGlvbigpIHsNCiAgICAgICAgICAgIGlmICggaW1hZ2VPYmoudGltZXIgIT09IHVuZGVmaW5lZCApIHsNCiAgICAgICAgICAgICAgICAvLyBDT1JTIHN1Y2NlZWRlZA0KICAgICAgICAgICAgICAgIHdpbmRvdy5jbGVhclRpbWVvdXQoIGltYWdlT2JqLnRpbWVyICk7DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIGltYWdlcy5udW1Mb2FkZWQrKzsNCiAgICAgICAgICAgIGltYWdlT2JqLnN1Y2NlZWRlZCA9IHRydWU7DQogICAgICAgICAgICBpbWcub25lcnJvciA9IGltZy5vbmxvYWQgPSBudWxsOw0KICAgICAgICAgICAgc3RhcnQoKTsNCiAgICAgICAgfTsNCiAgICAgICAgaW1nLm9uZXJyb3IgPSBmdW5jdGlvbigpIHsNCg0KICAgICAgICAgICAgaWYgKGltZy5jcm9zc09yaWdpbiA9PT0gImFub255bW91cyIpIHsNCiAgICAgICAgICAgICAgICAvLyBDT1JTIGZhaWxlZA0KICAgICAgICAgICAgICAgIHdpbmRvdy5jbGVhclRpbWVvdXQoIGltYWdlT2JqLnRpbWVyICk7DQoNCiAgICAgICAgICAgICAgICAvLyBsZXQncyB0cnkgd2l0aCBwcm94eSBpbnN0ZWFkDQogICAgICAgICAgICAgICAgaWYgKCBvcHRpb25zLnByb3h5ICkgew0KICAgICAgICAgICAgICAgICAgICB2YXIgc3JjID0gaW1nLnNyYzsNCiAgICAgICAgICAgICAgICAgICAgaW1nID0gbmV3IEltYWdlKCk7DQogICAgICAgICAgICAgICAgICAgIGltYWdlT2JqLmltZyA9IGltZzsNCiAgICAgICAgICAgICAgICAgICAgaW1nLnNyYyA9IHNyYzsNCg0KICAgICAgICAgICAgICAgICAgICBwcm94eUdldEltYWdlKCBpbWcuc3JjLCBpbWcsIGltYWdlT2JqICk7DQogICAgICAgICAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9DQoNCg0KICAgICAgICAgICAgaW1hZ2VzLm51bUxvYWRlZCsrOw0KICAgICAgICAgICAgaW1hZ2VzLm51bUZhaWxlZCsrOw0KICAgICAgICAgICAgaW1hZ2VPYmouc3VjY2VlZGVkID0gZmFsc2U7DQogICAgICAgICAgICBpbWcub25lcnJvciA9IGltZy5vbmxvYWQgPSBudWxsOw0KICAgICAgICAgICAgc3RhcnQoKTsNCg0KICAgICAgICB9Ow0KDQogICAgICAgIC8vIFRPRE8gT3BlcmEgaGFzIG5vIGxvYWQvZXJyb3IgZXZlbnQgZm9yIFNWRyBpbWFnZXMNCg0KICAgICAgICAvLyBPcGVyYSBuaW5qYSBvbmxvYWQncyBjYWNoZWQgaW1hZ2VzDQogICAgICAgIC8qDQogICAgICAgIHdpbmRvdy5zZXRUaW1lb3V0KGZ1bmN0aW9uKCl7DQogICAgICAgICAgICBpZiAoIGltZy53aWR0aCAhPT0gMCAmJiBpbWFnZU9iai5zdWNjZWVkZWQgPT09IHVuZGVmaW5lZCApIHsNCiAgICAgICAgICAgICAgICBpbWcub25sb2FkKCk7DQogICAgICAgICAgICB9DQogICAgICAgIH0sIDEwMCk7IC8vIG5lZWRzIGEgcmVmbG93IGZvciBiYXNlNjQgZW5jb2RlZCBpbWFnZXM/IGludGVyZXN0aW5nbHkgdGltZW91dCBvZiAwIGRvZXNuJ3Qgd29yayBidXQgMSBkb2VzLg0KICAgICAgICAgKi8NCiAgICB9DQoNCg0KICAgIG1ldGhvZHMgPSB7DQogICAgICAgIGxvYWRJbWFnZTogZnVuY3Rpb24oIHNyYyApIHsNCiAgICAgICAgICAgIHZhciBpbWcsIGltYWdlT2JqOw0KICAgICAgICAgICAgaWYgKCBzcmMgJiYgaW1hZ2VzW3NyY10gPT09IHVuZGVmaW5lZCApIHsNCiAgICAgICAgICAgICAgICBpbWcgPSBuZXcgSW1hZ2UoKTsNCiAgICAgICAgICAgICAgICBpZiAoIHNyYy5tYXRjaCgvZGF0YTppbWFnZVwvLio7YmFzZTY0LC9pKSApIHsNCiAgICAgICAgICAgICAgICAgICAgaW1nLnNyYyA9IHNyYy5yZXBsYWNlKC91cmxcKFsnIl17MCx9fFsnIl17MCx9XCkkL2lnLCAnJyk7DQogICAgICAgICAgICAgICAgICAgIGltYWdlT2JqID0gaW1hZ2VzW3NyY10gPSB7DQogICAgICAgICAgICAgICAgICAgICAgICBpbWc6IGltZw0KICAgICAgICAgICAgICAgICAgICB9Ow0KICAgICAgICAgICAgICAgICAgICBpbWFnZXMubnVtVG90YWwrKzsNCiAgICAgICAgICAgICAgICAgICAgc2V0SW1hZ2VMb2FkSGFuZGxlcnMoaW1nLCBpbWFnZU9iaik7DQogICAgICAgICAgICAgICAgfSBlbHNlIGlmICggaXNTYW1lT3JpZ2luKCBzcmMgKSB8fCBvcHRpb25zLmFsbG93VGFpbnQgPT09ICB0cnVlICkgew0KICAgICAgICAgICAgICAgICAgICBpbWFnZU9iaiA9IGltYWdlc1tzcmNdID0gew0KICAgICAgICAgICAgICAgICAgICAgICAgaW1nOiBpbWcNCiAgICAgICAgICAgICAgICAgICAgfTsNCiAgICAgICAgICAgICAgICAgICAgaW1hZ2VzLm51bVRvdGFsKys7DQogICAgICAgICAgICAgICAgICAgIHNldEltYWdlTG9hZEhhbmRsZXJzKGltZywgaW1hZ2VPYmopOw0KICAgICAgICAgICAgICAgICAgICBpbWcuc3JjID0gc3JjOw0KICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoIHN1cHBvcnRDT1JTICYmICFvcHRpb25zLmFsbG93VGFpbnQgJiYgb3B0aW9ucy51c2VDT1JTICkgew0KICAgICAgICAgICAgICAgICAgICAvLyBhdHRlbXB0IHRvIGxvYWQgd2l0aCBDT1JTDQoNCiAgICAgICAgICAgICAgICAgICAgaW1nLmNyb3NzT3JpZ2luID0gImFub255bW91cyI7DQogICAgICAgICAgICAgICAgICAgIGltYWdlT2JqID0gaW1hZ2VzW3NyY10gPSB7DQogICAgICAgICAgICAgICAgICAgICAgICBpbWc6IGltZw0KICAgICAgICAgICAgICAgICAgICB9Ow0KICAgICAgICAgICAgICAgICAgICBpbWFnZXMubnVtVG90YWwrKzsNCiAgICAgICAgICAgICAgICAgICAgc2V0SW1hZ2VMb2FkSGFuZGxlcnMoaW1nLCBpbWFnZU9iaik7DQogICAgICAgICAgICAgICAgICAgIGltZy5zcmMgPSBzcmM7DQoNCiAgICAgICAgICAgICAgICAgICAgLy8gd29yayBhcm91bmQgZm9yIGh0dHBzOi8vYnVncy53ZWJraXQub3JnL3Nob3dfYnVnLmNnaT9pZD04MDAyOA0KICAgICAgICAgICAgICAgICAgICBpbWcuY3VzdG9tQ29tcGxldGUgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuaW1nLmNvbXBsZXRlKSB7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy50aW1lciA9IHdpbmRvdy5zZXRUaW1lb3V0KHRoaXMuaW1nLmN1c3RvbUNvbXBsZXRlLCAxMDApOw0KICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmltZy5vbmVycm9yKCk7DQogICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIH0uYmluZChpbWFnZU9iaik7DQogICAgICAgICAgICAgICAgICAgIGltZy5jdXN0b21Db21wbGV0ZSgpOw0KDQogICAgICAgICAgICAgICAgfSBlbHNlIGlmICggb3B0aW9ucy5wcm94eSApIHsNCiAgICAgICAgICAgICAgICAgICAgaW1hZ2VPYmogPSBpbWFnZXNbc3JjXSA9IHsNCiAgICAgICAgICAgICAgICAgICAgICAgIGltZzogaW1nDQogICAgICAgICAgICAgICAgICAgIH07DQogICAgICAgICAgICAgICAgICAgIGltYWdlcy5udW1Ub3RhbCsrOw0KICAgICAgICAgICAgICAgICAgICBwcm94eUdldEltYWdlKCBzcmMsIGltZywgaW1hZ2VPYmogKTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9DQoNCiAgICAgICAgfSwNCiAgICAgICAgY2xlYW51cERPTTogZnVuY3Rpb24oY2F1c2UpIHsNCiAgICAgICAgICAgIHZhciBpbWcsIHNyYzsNCiAgICAgICAgICAgIGlmICghaW1hZ2VzLmNsZWFudXBEb25lKSB7DQogICAgICAgICAgICAgICAgaWYgKGNhdXNlICYmIHR5cGVvZiBjYXVzZSA9PT0gInN0cmluZyIpIHsNCiAgICAgICAgICAgICAgICAgICAgaDJjbG9nKCJodG1sMmNhbnZhczogQ2xlYW51cCBiZWNhdXNlOiAiICsgY2F1c2UpOw0KICAgICAgICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICAgICAgICAgIGgyY2xvZygiaHRtbDJjYW52YXM6IENsZWFudXAgYWZ0ZXIgdGltZW91dDogIiArIG9wdGlvbnMudGltZW91dCArICIgbXMuIik7DQogICAgICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAgICAgZm9yIChzcmMgaW4gaW1hZ2VzKSB7DQogICAgICAgICAgICAgICAgICAgIGlmIChpbWFnZXMuaGFzT3duUHJvcGVydHkoc3JjKSkgew0KICAgICAgICAgICAgICAgICAgICAgICAgaW1nID0gaW1hZ2VzW3NyY107DQogICAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGltZyA9PT0gIm9iamVjdCIgJiYgaW1nLmNhbGxiYWNrbmFtZSAmJiBpbWcuc3VjY2VlZGVkID09PSB1bmRlZmluZWQpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBjYW5jZWwgcHJveHkgaW1hZ2UgcmVxdWVzdA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvd1tpbWcuY2FsbGJhY2tuYW1lXSA9IHVuZGVmaW5lZDsgLy8gdG8gd29yayB3aXRoIElFPDkgIC8vIE5PVEU6IHRoYXQgdGhlIHVuZGVmaW5lZCBjYWxsYmFjayBwcm9wZXJ0eS1uYW1lIHN0aWxsIGV4aXN0cyBvbiB0aGUgd2luZG93IG9iamVjdCAoZm9yIElFPDkpDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIHdpbmRvd1tpbWcuY2FsbGJhY2tuYW1lXTsgIC8vIGZvciBhbGwgYnJvd3NlciB0aGF0IHN1cHBvcnQgdGhpcw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2goZXgpIHt9DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGltZy5zY3JpcHQgJiYgaW1nLnNjcmlwdC5wYXJlbnROb2RlKSB7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGltZy5zY3JpcHQuc2V0QXR0cmlidXRlKCJzcmMiLCAiYWJvdXQ6YmxhbmsiKTsgIC8vIHRyeSB0byBjYW5jZWwgcnVubmluZyByZXF1ZXN0DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGltZy5zY3JpcHQucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChpbWcuc2NyaXB0KTsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaW1hZ2VzLm51bUxvYWRlZCsrOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGltYWdlcy5udW1GYWlsZWQrKzsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBoMmNsb2coImh0bWwyY2FudmFzOiBDbGVhbmVkIHVwIGZhaWxlZCBpbWc6ICciICsgc3JjICsgIicgU3RlcHM6ICIgKyBpbWFnZXMubnVtTG9hZGVkICsgIiAvICIgKyBpbWFnZXMubnVtVG90YWwpOw0KICAgICAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAgICAgLy8gY2FuY2VsIGFueSBwZW5kaW5nIHJlcXVlc3RzDQogICAgICAgICAgICAgICAgaWYod2luZG93LnN0b3AgIT09IHVuZGVmaW5lZCkgew0KICAgICAgICAgICAgICAgICAgICB3aW5kb3cuc3RvcCgpOw0KICAgICAgICAgICAgICAgIH0gZWxzZSBpZihkb2N1bWVudC5leGVjQ29tbWFuZCAhPT0gdW5kZWZpbmVkKSB7DQogICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LmV4ZWNDb21tYW5kKCJTdG9wIiwgZmFsc2UpOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICBpZiAoZG9jdW1lbnQuY2xvc2UgIT09IHVuZGVmaW5lZCkgew0KICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC5jbG9zZSgpOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICBpbWFnZXMuY2xlYW51cERvbmUgPSB0cnVlOw0KICAgICAgICAgICAgICAgIGlmICghKGNhdXNlICYmIHR5cGVvZiBjYXVzZSA9PT0gInN0cmluZyIpKSB7DQogICAgICAgICAgICAgICAgICAgIHN0YXJ0KCk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KICAgICAgICB9LA0KICAgICAgICByZW5kZXJpbmdEb25lOiBmdW5jdGlvbigpIHsNCiAgICAgICAgICAgIGlmICh0aW1lb3V0VGltZXIpIHsNCiAgICAgICAgICAgICAgICB3aW5kb3cuY2xlYXJUaW1lb3V0KHRpbWVvdXRUaW1lcik7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCg0KICAgIH07DQoNCiAgICBpZiAob3B0aW9ucy50aW1lb3V0ID4gMCkgew0KICAgICAgICB0aW1lb3V0VGltZXIgPSB3aW5kb3cuc2V0VGltZW91dChtZXRob2RzLmNsZWFudXBET00sIG9wdGlvbnMudGltZW91dCk7DQogICAgfQ0KICAgIGgyY2xvZygnaHRtbDJjYW52YXM6IFByZWxvYWQgc3RhcnRzOiBmaW5kaW5nIGJhY2tncm91bmQtaW1hZ2VzJyk7DQogICAgaW1hZ2VzLmZpcnN0UnVuID0gdHJ1ZTsNCg0KICAgIGdldEltYWdlcyggZWxlbWVudCApOw0KDQogICAgaDJjbG9nKCdodG1sMmNhbnZhczogUHJlbG9hZDogRmluZGluZyBpbWFnZXMnKTsNCiAgICAvLyBsb2FkIDxpbWc+IGltYWdlcw0KICAgIGZvciAoaSA9IDA7IGkgPCBpbWdMZW47IGkrPTEpew0KICAgICAgICBtZXRob2RzLmxvYWRJbWFnZSggZG9tSW1hZ2VzW2ldLmdldEF0dHJpYnV0ZSggInNyYyIgKSApOw0KICAgIH0NCg0KICAgIGltYWdlcy5maXJzdFJ1biA9IGZhbHNlOw0KICAgIGgyY2xvZygnaHRtbDJjYW52YXM6IFByZWxvYWQ6IERvbmUuJyk7DQogICAgaWYgKCBpbWFnZXMubnVtVG90YWwgPT09IGltYWdlcy5udW1Mb2FkZWQgKSB7DQogICAgICAgIHN0YXJ0KCk7DQogICAgfQ0KDQogICAgcmV0dXJuIG1ldGhvZHM7DQoNCn07DQoNCg0KDQoNCi8qDQogIGh0bWwyY2FudmFzIHYwLjM0IDxodHRwOi8vaHRtbDJjYW52YXMuaGVydHplbi5jb20+DQogIENvcHlyaWdodCAoYykgMjAxMSBOaWtsYXMgdm9uIEhlcnR6ZW4uIEFsbCByaWdodHMgcmVzZXJ2ZWQuDQogIGh0dHA6Ly93d3cudHdpdHRlci5jb20vbmlrbGFzdmgNCg0KICBSZWxlYXNlZCB1bmRlciBNSVQgTGljZW5zZQ0KKi8NCmZ1bmN0aW9uIGgyY1JlbmRlckNvbnRleHQod2lkdGgsIGhlaWdodCkgew0KICAgIHZhciBzdG9yYWdlID0gW107DQogICAgcmV0dXJuIHsNCiAgICAgICAgc3RvcmFnZTogc3RvcmFnZSwNCiAgICAgICAgd2lkdGg6IHdpZHRoLA0KICAgICAgICBoZWlnaHQ6IGhlaWdodCwNCiAgICAgICAgZmlsbFJlY3Q6IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgICAgIHN0b3JhZ2UucHVzaCh7DQogICAgICAgICAgICAgICAgdHlwZTogImZ1bmN0aW9uIiwNCiAgICAgICAgICAgICAgICBuYW1lOiAiZmlsbFJlY3QiLA0KICAgICAgICAgICAgICAgICdhcmd1bWVudHMnOiBhcmd1bWVudHMNCiAgICAgICAgICAgIH0pOw0KICAgICAgICB9LA0KICAgICAgICBkcmF3SW1hZ2U6IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgICAgIHN0b3JhZ2UucHVzaCh7DQogICAgICAgICAgICAgICAgdHlwZTogImZ1bmN0aW9uIiwNCiAgICAgICAgICAgICAgICBuYW1lOiAiZHJhd0ltYWdlIiwNCiAgICAgICAgICAgICAgICAnYXJndW1lbnRzJzogYXJndW1lbnRzDQogICAgICAgICAgICB9KTsNCiAgICAgICAgfSwNCiAgICAgICAgZmlsbFRleHQ6IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgICAgIHN0b3JhZ2UucHVzaCh7DQogICAgICAgICAgICAgICAgdHlwZTogImZ1bmN0aW9uIiwNCiAgICAgICAgICAgICAgICBuYW1lOiAiZmlsbFRleHQiLA0KICAgICAgICAgICAgICAgICdhcmd1bWVudHMnOiBhcmd1bWVudHMNCiAgICAgICAgICAgIH0pOw0KICAgICAgICB9LA0KICAgICAgICBzZXRWYXJpYWJsZTogZnVuY3Rpb24gKHZhcmlhYmxlLCB2YWx1ZSkgew0KICAgICAgICAgICAgc3RvcmFnZS5wdXNoKHsNCiAgICAgICAgICAgICAgICB0eXBlOiAidmFyaWFibGUiLA0KICAgICAgICAgICAgICAgIG5hbWU6IHZhcmlhYmxlLA0KICAgICAgICAgICAgICAgICdhcmd1bWVudHMnOiB2YWx1ZQ0KICAgICAgICAgICAgfSk7DQogICAgICAgIH0NCiAgICB9Ow0KfQ0KDQovKg0KICBodG1sMmNhbnZhcyB2MC4zNCA8aHR0cDovL2h0bWwyY2FudmFzLmhlcnR6ZW4uY29tPg0KICBDb3B5cmlnaHQgKGMpIDIwMTEgTmlrbGFzIHZvbiBIZXJ0emVuLiBBbGwgcmlnaHRzIHJlc2VydmVkLg0KICBodHRwOi8vd3d3LnR3aXR0ZXIuY29tL25pa2xhc3ZoDQoNCiAgUmVsZWFzZWQgdW5kZXIgTUlUIExpY2Vuc2UNCiovDQpfaHRtbDJjYW52YXMuUmVuZGVyZXIgPSBmdW5jdGlvbihwYXJzZVF1ZXVlLCBvcHRpb25zKXsNCg0KDQogICAgdmFyIHF1ZXVlID0gW107DQoNCiAgICBmdW5jdGlvbiBzb3J0Wih6U3RhY2spew0KICAgICAgICB2YXIgc3ViU3RhY2tzID0gW10sDQogICAgICAgIHN0YWNrVmFsdWVzID0gW10sDQogICAgICAgIHpTdGFja0NoaWxkcmVuID0gelN0YWNrLmNoaWxkcmVuLA0KICAgICAgICBzLA0KICAgICAgICBpLA0KICAgICAgICBzdGFja0xlbiwNCiAgICAgICAgelZhbHVlLA0KICAgICAgICB6TGVuLA0KICAgICAgICBzdGFja0NoaWxkLA0KICAgICAgICBiLA0KICAgICAgICBzdWJTdGFja0xlbjsNCg0KDQogICAgICAgIGZvciAocyA9IDAsIHpMZW4gPSB6U3RhY2tDaGlsZHJlbi5sZW5ndGg7IHMgPCB6TGVuOyBzKz0xKXsNCg0KICAgICAgICAgICAgc3RhY2tDaGlsZCA9IHpTdGFja0NoaWxkcmVuW3NdOw0KDQogICAgICAgICAgICBpZiAoc3RhY2tDaGlsZC5jaGlsZHJlbiAmJiBzdGFja0NoaWxkLmNoaWxkcmVuLmxlbmd0aCA+IDApew0KICAgICAgICAgICAgICAgIHN1YlN0YWNrcy5wdXNoKHN0YWNrQ2hpbGQpOw0KICAgICAgICAgICAgICAgIHN0YWNrVmFsdWVzLnB1c2goc3RhY2tDaGlsZC56aW5kZXgpOw0KICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgcXVldWUucHVzaChzdGFja0NoaWxkKTsNCiAgICAgICAgICAgIH0NCg0KICAgICAgICB9DQoNCiAgICAgICAgc3RhY2tWYWx1ZXMuc29ydChmdW5jdGlvbihhLCBiKSB7DQogICAgICAgICAgICByZXR1cm4gYSAtIGI7DQogICAgICAgIH0pOw0KDQogICAgICAgIGZvciAoaSA9IDAsIHN0YWNrTGVuID0gc3RhY2tWYWx1ZXMubGVuZ3RoOyBpIDwgc3RhY2tMZW47IGkrPTEpew0KICAgICAgICAgICAgelZhbHVlID0gc3RhY2tWYWx1ZXNbaV07DQogICAgICAgICAgICBmb3IgKGIgPSAwLCBzdWJTdGFja0xlbiA9IHN1YlN0YWNrcy5sZW5ndGg7IGIgPD0gc3ViU3RhY2tMZW47IGIrPTEpew0KDQogICAgICAgICAgICAgICAgaWYgKHN1YlN0YWNrc1tiXS56aW5kZXggPT09IHpWYWx1ZSl7DQogICAgICAgICAgICAgICAgICAgIHN0YWNrQ2hpbGQgPSBzdWJTdGFja3Muc3BsaWNlKGIsIDEpOw0KICAgICAgICAgICAgICAgICAgICBzb3J0WihzdGFja0NoaWxkWzBdKTsNCiAgICAgICAgICAgICAgICAgICAgYnJlYWs7DQoNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9DQogICAgICAgIH0NCg0KICAgIH0NCg0KDQogICAgc29ydFoocGFyc2VRdWV1ZS56SW5kZXgpOw0KICAgIGlmICggdHlwZW9mIG9wdGlvbnMuX3JlbmRlcmVyLl9jcmVhdGUgIT09ICJmdW5jdGlvbiIgKSB7DQogICAgICAgIHRocm93IG5ldyBFcnJvcigiSW52YWxpZCByZW5kZXJlciBkZWZpbmVkIik7DQogICAgfQ0KICAgIHJldHVybiBvcHRpb25zLl9yZW5kZXJlci5fY3JlYXRlKCBwYXJzZVF1ZXVlLCBvcHRpb25zLCBkb2N1bWVudCwgcXVldWUsIF9odG1sMmNhbnZhcyApOw0KDQp9Ow0KDQovKg0KICBodG1sMmNhbnZhcyB2MC4zNCA8aHR0cDovL2h0bWwyY2FudmFzLmhlcnR6ZW4uY29tPg0KICBDb3B5cmlnaHQgKGMpIDIwMTEgTmlrbGFzIHZvbiBIZXJ0emVuLiBBbGwgcmlnaHRzIHJlc2VydmVkLg0KICBodHRwOi8vd3d3LnR3aXR0ZXIuY29tL25pa2xhc3ZoDQoNCiAgUmVsZWFzZWQgdW5kZXIgTUlUIExpY2Vuc2UNCiovDQoNCg0KaHRtbDJjYW52YXMgPSBmdW5jdGlvbiggZWxlbWVudHMsIG9wdHMgKSB7DQoNCiAgICB2YXIgcXVldWUsDQogICAgY2FudmFzLA0KICAgIG9wdGlvbnMgPSB7DQogICAgICAgIC8vIGdlbmVyYWwNCiAgICAgICAgbG9nZ2luZzogZmFsc2UsDQogICAgICAgIGVsZW1lbnRzOiBlbGVtZW50cywNCg0KICAgICAgICAvLyBwcmVsb2FkIG9wdGlvbnMNCiAgICAgICAgcHJveHk6ICJodHRwOi8vaHRtbDJjYW52YXMuYXBwc3BvdC5jb20vIiwNCiAgICAgICAgdGltZW91dDogMCwgICAgLy8gbm8gdGltZW91dA0KICAgICAgICB1c2VDT1JTOiBmYWxzZSwgLy8gdHJ5IHRvIGxvYWQgaW1hZ2VzIGFzIENPUlMgKHdoZXJlIGF2YWlsYWJsZSksIGJlZm9yZSBmYWxsaW5nIGJhY2sgdG8gcHJveHkNCiAgICAgICAgYWxsb3dUYWludDogZmFsc2UsIC8vIHdoZXRoZXIgdG8gYWxsb3cgaW1hZ2VzIHRvIHRhaW50IHRoZSBjYW52YXMsIHdvbid0IG5lZWQgcHJveHkgaWYgc2V0IHRvIHRydWUNCg0KICAgICAgICAvLyBwYXJzZSBvcHRpb25zDQogICAgICAgIHN2Z1JlbmRlcmluZzogZmFsc2UsIC8vIHVzZSBzdmcgcG93ZXJlZCByZW5kZXJpbmcgd2hlcmUgYXZhaWxhYmxlIChGRjExKykNCiAgICAgICAgaWZyYW1lRGVmYXVsdDogImRlZmF1bHQiLA0KICAgICAgICBpZ25vcmVFbGVtZW50czogIklGUkFNRXxPQkpFQ1R8UEFSQU0iLA0KICAgICAgICB1c2VPdmVyZmxvdzogdHJ1ZSwNCiAgICAgICAgbGV0dGVyUmVuZGVyaW5nOiBmYWxzZSwNCg0KICAgICAgICAvLyByZW5kZXIgb3B0aW9ucw0KDQogICAgICAgIGZsYXNoY2FudmFzOiB1bmRlZmluZWQsIC8vIHBhdGggdG8gZmxhc2hjYW52YXMNCiAgICAgICAgd2lkdGg6IG51bGwsDQogICAgICAgIGhlaWdodDogbnVsbCwNCiAgICAgICAgdGFpbnRUZXN0OiB0cnVlLCAvLyBkbyBhIHRhaW50IHRlc3Qgd2l0aCBhbGwgaW1hZ2VzIGJlZm9yZSBhcHBseWluZyB0byBjYW52YXMNCgkJcmVuZGVyZXI6ICJDYW52YXMiDQogICAgfSwgcmVuZGVyZXI7DQoNCiAgICBvcHRpb25zID0gX2h0bWwyY2FudmFzLlV0aWwuRXh0ZW5kKG9wdHMsIG9wdGlvbnMpOw0KDQoJaWYgKHR5cGVvZiBvcHRpb25zLnJlbmRlcmVyID09PSAic3RyaW5nIiAmJiBfaHRtbDJjYW52YXMuUmVuZGVyZXJbb3B0aW9ucy5yZW5kZXJlcl0gIT09IHVuZGVmaW5lZCkgew0KCQlvcHRpb25zLl9yZW5kZXJlciA9IF9odG1sMmNhbnZhcy5SZW5kZXJlcltvcHRpb25zLnJlbmRlcmVyXSggb3B0aW9ucyApOw0KCX0gZWxzZSBpZiAodHlwZW9mIG9wdGlvbnMucmVuZGVyZXIgPT09ICJmdW5jdGlvbiIpIHsNCgkJb3B0aW9ucy5fcmVuZGVyZXIgPSBvcHRpb25zLnJlbmRlcmVyKCBvcHRpb25zICk7DQoJfSBlbHNlIHsNCgkJdGhyb3coIlVua25vd24gcmVuZGVyZXIiKTsNCgl9DQoNCiAgICBfaHRtbDJjYW52YXMubG9nZ2luZyA9IG9wdGlvbnMubG9nZ2luZzsNCiAgICBvcHRpb25zLmNvbXBsZXRlID0gZnVuY3Rpb24oIGltYWdlcyApIHsNCg0KICAgICAgICBpZiAodHlwZW9mIG9wdGlvbnMub25wcmVsb2FkZWQgPT09ICJmdW5jdGlvbiIpIHsNCiAgICAgICAgICAgIGlmICggb3B0aW9ucy5vbnByZWxvYWRlZCggaW1hZ2VzICkgPT09IGZhbHNlICkgew0KICAgICAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgICBxdWV1ZSA9IF9odG1sMmNhbnZhcy5QYXJzZSggaW1hZ2VzLCBvcHRpb25zICk7DQoNCiAgICAgICAgaWYgKHR5cGVvZiBvcHRpb25zLm9ucGFyc2VkID09PSAiZnVuY3Rpb24iKSB7DQogICAgICAgICAgICBpZiAoIG9wdGlvbnMub25wYXJzZWQoIHF1ZXVlICkgPT09IGZhbHNlICkgew0KICAgICAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KDQogICAgICAgIGNhbnZhcyA9IF9odG1sMmNhbnZhcy5SZW5kZXJlciggcXVldWUsIG9wdGlvbnMgKTsNCg0KICAgICAgICBpZiAodHlwZW9mIG9wdGlvbnMub25yZW5kZXJlZCA9PT0gImZ1bmN0aW9uIikgew0KICAgICAgICAgICAgb3B0aW9ucy5vbnJlbmRlcmVkKCBjYW52YXMgKTsNCiAgICAgICAgfQ0KDQoNCiAgICB9Ow0KDQogICAgLy8gZm9yIHBhZ2VzIHdpdGhvdXQgaW1hZ2VzLCB3ZSBzdGlsbCB3YW50IHRoaXMgdG8gYmUgYXN5bmMsIGkuZS4gcmV0dXJuIG1ldGhvZHMgYmVmb3JlIGV4ZWN1dGluZw0KICAgIHdpbmRvdy5zZXRUaW1lb3V0KCBmdW5jdGlvbigpew0KICAgICAgICBfaHRtbDJjYW52YXMuUHJlbG9hZCggb3B0aW9ucyApOw0KICAgIH0sIDAgKTsNCg0KICAgIHJldHVybiB7DQogICAgICAgIHJlbmRlcjogZnVuY3Rpb24oIHF1ZXVlLCBvcHRzICkgew0KICAgICAgICAgICAgcmV0dXJuIF9odG1sMmNhbnZhcy5SZW5kZXJlciggcXVldWUsIF9odG1sMmNhbnZhcy5VdGlsLkV4dGVuZChvcHRzLCBvcHRpb25zKSApOw0KICAgICAgICB9LA0KICAgICAgICBwYXJzZTogZnVuY3Rpb24oIGltYWdlcywgb3B0cyApIHsNCiAgICAgICAgICAgIHJldHVybiBfaHRtbDJjYW52YXMuUGFyc2UoIGltYWdlcywgX2h0bWwyY2FudmFzLlV0aWwuRXh0ZW5kKG9wdHMsIG9wdGlvbnMpICk7DQogICAgICAgIH0sDQogICAgICAgIHByZWxvYWQ6IGZ1bmN0aW9uKCBvcHRzICkgew0KICAgICAgICAgICAgcmV0dXJuIF9odG1sMmNhbnZhcy5QcmVsb2FkKCBfaHRtbDJjYW52YXMuVXRpbC5FeHRlbmQob3B0cywgb3B0aW9ucykgKTsNCiAgICAgICAgfSwNCiAgICAgICAgbG9nOiBoMmNsb2cNCiAgICB9Ow0KfTsNCg0KaHRtbDJjYW52YXMubG9nID0gaDJjbG9nOyAvLyBmb3IgcmVuZGVyZXJzDQpodG1sMmNhbnZhcy5SZW5kZXJlciA9IHsNCiAgICBDYW52YXM6IHVuZGVmaW5lZCAvLyBXZSBhcmUgYXNzdW1pbmcgdGhpcyB3aWxsIGJlIHVzZWQNCn07DQoNCi8qDQogIGh0bWwyY2FudmFzIHYwLjM0IDxodHRwOi8vaHRtbDJjYW52YXMuaGVydHplbi5jb20+DQogIENvcHlyaWdodCAoYykgMjAxMSBOaWtsYXMgdm9uIEhlcnR6ZW4uIEFsbCByaWdodHMgcmVzZXJ2ZWQuDQogIGh0dHA6Ly93d3cudHdpdHRlci5jb20vbmlrbGFzdmgNCg0KICBSZWxlYXNlZCB1bmRlciBNSVQgTGljZW5zZQ0KKi8NCg0KDQpfaHRtbDJjYW52YXMuUmVuZGVyZXIuQ2FudmFzID0gZnVuY3Rpb24oIG9wdGlvbnMgKSB7DQoNCiAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsNCg0KICAgIHZhciBkb2MgPSBkb2N1bWVudCwNCiAgICBjYW52YXMgPSBvcHRpb25zLmNhbnZhcyB8fCBkb2MuY3JlYXRlRWxlbWVudCgnY2FudmFzJyksDQogICAgdXNpbmdGbGFzaGNhbnZhcyA9IGZhbHNlLA0KICAgIF9jcmVhdGVDYWxsZWQgPSBmYWxzZSwNCiAgICBjYW52YXNSZWFkeVRvRHJhdyA9IGZhbHNlLA0KICAgIG1ldGhvZHMsDQogICAgZmxhc2hNYXhTaXplID0gMjg4MDsgLy8gZmxhc2ggYml0bWFwIGxpbWl0ZWQgdG8gMjg4MHgyODgwcHggLy8gaHR0cDovL3N0YWNrb3ZlcmZsb3cuY29tL3F1ZXN0aW9ucy8yMDMzNzkyL2FyZ3VtZW50ZXJyb3ItZXJyb3ItMjAxNS1pbnZhbGlkLWJpdG1hcGRhdGENCg0KDQogICAgaWYgKGNhbnZhcy5nZXRDb250ZXh0KXsNCiAgICAgICAgaDJjbG9nKCJodG1sMmNhbnZhczogUmVuZGVyZXI6IHVzaW5nIGNhbnZhcyByZW5kZXJlciIpOw0KICAgICAgICBjYW52YXNSZWFkeVRvRHJhdyA9IHRydWU7DQogICAgfSBlbHNlIGlmICggb3B0aW9ucy5mbGFzaGNhbnZhcyAhPT0gdW5kZWZpbmVkICl7DQogICAgICAgIHVzaW5nRmxhc2hjYW52YXMgPSB0cnVlOw0KICAgICAgICBoMmNsb2coImh0bWwyY2FudmFzOiBSZW5kZXJlcjogY2FudmFzIG5vdCBhdmFpbGFibGUsIHVzaW5nIGZsYXNoY2FudmFzIik7DQogICAgICAgIHZhciBzY3JpcHQgPSBkb2MuY3JlYXRlRWxlbWVudCgic2NyaXB0Iik7DQogICAgICAgIHNjcmlwdC5zcmMgPSBvcHRpb25zLmZsYXNoY2FudmFzOw0KDQogICAgICAgIHNjcmlwdC5vbmxvYWQgPSAoZnVuY3Rpb24oc2NyaXB0LCBmdW5jKXsNCiAgICAgICAgICAgIHZhciBpbnRlcnZhbEZ1bmM7DQoNCiAgICAgICAgICAgIGlmIChzY3JpcHQub25sb2FkID09PSB1bmRlZmluZWQpIHsNCiAgICAgICAgICAgICAgICAvLyBJRSBsYWNrIG9mIHN1cHBvcnQgZm9yIHNjcmlwdCBvbmxvYWQNCg0KICAgICAgICAgICAgICAgIGlmKCBzY3JpcHQub25yZWFkeXN0YXRlY2hhbmdlICE9PSB1bmRlZmluZWQgKSB7DQoNCiAgICAgICAgICAgICAgICAgICAgaW50ZXJ2YWxGdW5jID0gZnVuY3Rpb24oKSB7DQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2NyaXB0LnJlYWR5U3RhdGUgIT09ICJsb2FkZWQiICYmIHNjcmlwdC5yZWFkeVN0YXRlICE9PSAiY29tcGxldGUiKSB7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LnNldFRpbWVvdXQoIGludGVydmFsRnVuYywgMjUwICk7DQoNCiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gaXQgaXMgbG9hZGVkDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZnVuYygpOw0KDQogICAgICAgICAgICAgICAgICAgICAgICB9DQoNCiAgICAgICAgICAgICAgICAgICAgfTsNCg0KICAgICAgICAgICAgICAgICAgICB3aW5kb3cuc2V0VGltZW91dCggaW50ZXJ2YWxGdW5jLCAyNTAgKTsNCg0KICAgICAgICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICAgICAgICAgIGgyY2xvZygiaHRtbDJjYW52YXM6IFJlbmRlcmVyOiBDYW4ndCB0cmFjayB3aGVuIGZsYXNoY2FudmFzIGlzIGxvYWRlZCIpOw0KICAgICAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgICAgICByZXR1cm4gZnVuYzsNCiAgICAgICAgICAgIH0NCg0KICAgICAgICB9KShzY3JpcHQsIGZ1bmN0aW9uKCl7DQoNCiAgICAgICAgICAgIGlmICh0eXBlb2Ygd2luZG93LkZsYXNoQ2FudmFzICE9PSAidW5kZWZpbmVkIikgew0KICAgICAgICAgICAgICAgIGgyY2xvZygiaHRtbDJjYW52YXM6IFJlbmRlcmVyOiBGbGFzaGNhbnZhcyBpbml0aWFsaXplZCIpOw0KICAgICAgICAgICAgICAgIHdpbmRvdy5GbGFzaENhbnZhcy5pbml0RWxlbWVudCggY2FudmFzICk7DQoNCiAgICAgICAgICAgICAgICBjYW52YXNSZWFkeVRvRHJhdyA9IHRydWU7DQogICAgICAgICAgICAgICAgaWYgKCBfY3JlYXRlQ2FsbGVkICE9PSBmYWxzZSApIHsNCiAgICAgICAgICAgICAgICAgICAgbWV0aG9kcy5fY3JlYXRlLmFwcGx5KCBudWxsLCBfY3JlYXRlQ2FsbGVkICk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KICAgICAgICB9KTsNCg0KICAgICAgICBkb2MuYm9keS5hcHBlbmRDaGlsZCggc2NyaXB0ICk7DQoNCiAgICB9DQoNCiAgICBtZXRob2RzID0gew0KICAgICAgICBfY3JlYXRlOiBmdW5jdGlvbiggelN0YWNrLCBvcHRpb25zLCBkb2MsIHF1ZXVlLCBfaHRtbDJjYW52YXMgKSB7DQoNCiAgICAgICAgICAgIGlmICggIWNhbnZhc1JlYWR5VG9EcmF3ICkgew0KICAgICAgICAgICAgICAgIF9jcmVhdGVDYWxsZWQgPSBhcmd1bWVudHM7DQogICAgICAgICAgICAgICAgcmV0dXJuIGNhbnZhczsNCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgdmFyIGN0eCA9IGNhbnZhcy5nZXRDb250ZXh0KCIyZCIpLA0KICAgICAgICAgICAgc3RvcmFnZUNvbnRleHQsDQogICAgICAgICAgICBpLA0KICAgICAgICAgICAgcXVldWVMZW4sDQogICAgICAgICAgICBhLA0KICAgICAgICAgICAgbmV3Q2FudmFzLA0KICAgICAgICAgICAgYm91bmRzLA0KICAgICAgICAgICAgdGVzdENhbnZhcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImNhbnZhcyIpLA0KICAgICAgICAgICAgaGFzQ1RYID0gKCB0ZXN0Q2FudmFzLmdldENvbnRleHQgIT09IHVuZGVmaW5lZCApLA0KICAgICAgICAgICAgc3RvcmFnZUxlbiwNCiAgICAgICAgICAgIHJlbmRlckl0ZW0sDQogICAgICAgICAgICB0ZXN0Y3R4ID0gKCBoYXNDVFggKSA/IHRlc3RDYW52YXMuZ2V0Q29udGV4dCgiMmQiKSA6IHt9LA0KICAgICAgICAgICAgc2FmZUltYWdlcyA9IFtdLA0KICAgICAgICAgICAgZnN0eWxlOw0KDQogICAgICAgICAgICBjYW52YXMud2lkdGggPSBjYW52YXMuc3R5bGUud2lkdGggPSAoIXVzaW5nRmxhc2hjYW52YXMpID8gb3B0aW9ucy53aWR0aCB8fCB6U3RhY2suY3R4LndpZHRoIDogTWF0aC5taW4oZmxhc2hNYXhTaXplLCAob3B0aW9ucy53aWR0aCB8fCB6U3RhY2suY3R4LndpZHRoKSApOw0KICAgICAgICAgICAgY2FudmFzLmhlaWdodCA9IGNhbnZhcy5zdHlsZS5oZWlnaHQgPSAoIXVzaW5nRmxhc2hjYW52YXMpID8gb3B0aW9ucy5oZWlnaHQgfHwgelN0YWNrLmN0eC5oZWlnaHQgOiBNYXRoLm1pbihmbGFzaE1heFNpemUsIChvcHRpb25zLmhlaWdodCB8fCB6U3RhY2suY3R4LmhlaWdodCkgKTsNCg0KICAgICAgICAgICAgZnN0eWxlID0gY3R4LmZpbGxTdHlsZTsNCiAgICAgICAgICAgIGN0eC5maWxsU3R5bGUgPSB6U3RhY2suYmFja2dyb3VuZENvbG9yOw0KICAgICAgICAgICAgY3R4LmZpbGxSZWN0KDAsIDAsIGNhbnZhcy53aWR0aCwgY2FudmFzLmhlaWdodCk7DQogICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gZnN0eWxlOw0KDQogICAgICAgICAgICBpZiAoIG9wdGlvbnMuc3ZnUmVuZGVyaW5nICYmIHpTdGFjay5zdmdSZW5kZXIgIT09IHVuZGVmaW5lZCApIHsNCiAgICAgICAgICAgICAgICAvLyBUT0RPOiBlbmFibGUgYXN5bmMgcmVuZGVyaW5nIHRvIHN1cHBvcnQgdGhpcw0KICAgICAgICAgICAgICAgIGN0eC5kcmF3SW1hZ2UoIHpTdGFjay5zdmdSZW5kZXIsIDAsIDAgKTsNCiAgICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICAgICAgZm9yICggaSA9IDAsIHF1ZXVlTGVuID0gcXVldWUubGVuZ3RoOyBpIDwgcXVldWVMZW47IGkrPTEgKSB7DQoNCiAgICAgICAgICAgICAgICAgICAgc3RvcmFnZUNvbnRleHQgPSBxdWV1ZS5zcGxpY2UoMCwgMSlbMF07DQogICAgICAgICAgICAgICAgICAgIHN0b3JhZ2VDb250ZXh0LmNhbnZhc1Bvc2l0aW9uID0gc3RvcmFnZUNvbnRleHQuY2FudmFzUG9zaXRpb24gfHwge307DQoNCiAgICAgICAgICAgICAgICAgICAgLy90aGlzLmNhbnZhc1JlbmRlckNvbnRleHQoc3RvcmFnZUNvbnRleHQscGFyZW50Y3R4KTsNCg0KICAgICAgICAgICAgICAgICAgICAvLyBzZXQgY29tbW9uIHNldHRpbmdzIGZvciBjYW52YXMNCiAgICAgICAgICAgICAgICAgICAgY3R4LnRleHRCYXNlbGluZSA9ICJib3R0b20iOw0KDQogICAgICAgICAgICAgICAgICAgIGlmIChzdG9yYWdlQ29udGV4dC5jbGlwKXsNCiAgICAgICAgICAgICAgICAgICAgICAgIGN0eC5zYXZlKCk7DQogICAgICAgICAgICAgICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7DQogICAgICAgICAgICAgICAgICAgICAgICAvLyBjb25zb2xlLmxvZyhzdG9yYWdlQ29udGV4dCk7DQogICAgICAgICAgICAgICAgICAgICAgICBjdHgucmVjdChzdG9yYWdlQ29udGV4dC5jbGlwLmxlZnQsIHN0b3JhZ2VDb250ZXh0LmNsaXAudG9wLCBzdG9yYWdlQ29udGV4dC5jbGlwLndpZHRoLCBzdG9yYWdlQ29udGV4dC5jbGlwLmhlaWdodCk7DQogICAgICAgICAgICAgICAgICAgICAgICBjdHguY2xpcCgpOw0KDQogICAgICAgICAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgICAgICAgICBpZiAoc3RvcmFnZUNvbnRleHQuY3R4LnN0b3JhZ2Upew0KDQogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGEgPSAwLCBzdG9yYWdlTGVuID0gc3RvcmFnZUNvbnRleHQuY3R4LnN0b3JhZ2UubGVuZ3RoOyBhIDwgc3RvcmFnZUxlbjsgYSs9MSl7DQoNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZW5kZXJJdGVtID0gc3RvcmFnZUNvbnRleHQuY3R4LnN0b3JhZ2VbYV07DQoNCg0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN3aXRjaChyZW5kZXJJdGVtLnR5cGUpew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICJ2YXJpYWJsZSI6DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdHhbcmVuZGVySXRlbS5uYW1lXSA9IHJlbmRlckl0ZW1bJ2FyZ3VtZW50cyddOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgImZ1bmN0aW9uIjoNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZW5kZXJJdGVtLm5hbWUgPT09ICJmaWxsUmVjdCIpIHsNCg0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghdXNpbmdGbGFzaGNhbnZhcyB8fCByZW5kZXJJdGVtWydhcmd1bWVudHMnXVswXSArIHJlbmRlckl0ZW1bJ2FyZ3VtZW50cyddWzJdIDwgZmxhc2hNYXhTaXplICAmJiByZW5kZXJJdGVtWydhcmd1bWVudHMnXVsxXSArIHJlbmRlckl0ZW1bJ2FyZ3VtZW50cyddWzNdIDwgZmxhc2hNYXhTaXplKSB7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN0eC5maWxsUmVjdC5hcHBseSggY3R4LCByZW5kZXJJdGVtWydhcmd1bWVudHMnXSApOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1lbHNlIGlmKHJlbmRlckl0ZW0ubmFtZSA9PT0gImZpbGxUZXh0Iikgew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghdXNpbmdGbGFzaGNhbnZhcyB8fCByZW5kZXJJdGVtWydhcmd1bWVudHMnXVsxXSA8IGZsYXNoTWF4U2l6ZSAgJiYgcmVuZGVySXRlbVsnYXJndW1lbnRzJ11bMl0gPCBmbGFzaE1heFNpemUpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3R4LmZpbGxUZXh0LmFwcGx5KCBjdHgsIHJlbmRlckl0ZW1bJ2FyZ3VtZW50cyddICk7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfWVsc2UgaWYocmVuZGVySXRlbS5uYW1lID09PSAiZHJhd0ltYWdlIikgew0KDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlbmRlckl0ZW1bJ2FyZ3VtZW50cyddWzhdID4gMCAmJiByZW5kZXJJdGVtWydhcmd1bWVudHMnXVs3XSl7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICggaGFzQ1RYICYmIG9wdGlvbnMudGFpbnRUZXN0ICkgew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCBzYWZlSW1hZ2VzLmluZGV4T2YoIHJlbmRlckl0ZW1bJ2FyZ3VtZW50cyddWyAwIF0uc3JjICkgPT09IC0xICkgew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlc3RjdHguZHJhd0ltYWdlKCByZW5kZXJJdGVtWydhcmd1bWVudHMnXVsgMCBdLCAwLCAwICk7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVzdGN0eC5nZXRJbWFnZURhdGEoIDAsIDAsIDEsIDEgKTsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoKGUpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVzdENhbnZhcyA9IGRvYy5jcmVhdGVFbGVtZW50KCJjYW52YXMiKTsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVzdGN0eCA9IHRlc3RDYW52YXMuZ2V0Q29udGV4dCgiMmQiKTsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2FmZUltYWdlcy5wdXNoKCByZW5kZXJJdGVtWydhcmd1bWVudHMnXVsgMCBdLnNyYyApOw0KDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3R4LmRyYXdJbWFnZS5hcHBseSggY3R4LCByZW5kZXJJdGVtWydhcmd1bWVudHMnXSApOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0NCg0KDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVmYXVsdDoNCg0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgaWYgKHN0b3JhZ2VDb250ZXh0LmNsaXApew0KICAgICAgICAgICAgICAgICAgICAgICAgY3R4LnJlc3RvcmUoKTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICBoMmNsb2coImh0bWwyY2FudmFzOiBSZW5kZXJlcjogQ2FudmFzIHJlbmRlcmVyIGRvbmUgLSByZXR1cm5pbmcgY2FudmFzIG9iaiIpOw0KDQogICAgICAgICAgICBxdWV1ZUxlbiA9IG9wdGlvbnMuZWxlbWVudHMubGVuZ3RoOw0KDQogICAgICAgICAgICBpZiAocXVldWVMZW4gPT09IDEpIHsNCiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIG9wdGlvbnMuZWxlbWVudHNbIDAgXSA9PT0gIm9iamVjdCIgJiYgb3B0aW9ucy5lbGVtZW50c1sgMCBdLm5vZGVOYW1lICE9PSAiQk9EWSIgJiYgdXNpbmdGbGFzaGNhbnZhcyA9PT0gZmFsc2UpIHsNCiAgICAgICAgICAgICAgICAgICAgLy8gY3JvcCBpbWFnZSB0byB0aGUgYm91bmRzIG9mIHNlbGVjdGVkIChzaW5nbGUpIGVsZW1lbnQNCiAgICAgICAgICAgICAgICAgICAgYm91bmRzID0gX2h0bWwyY2FudmFzLlV0aWwuQm91bmRzKCBvcHRpb25zLmVsZW1lbnRzWyAwIF0gKTsNCiAgICAgICAgICAgICAgICAgICAgbmV3Q2FudmFzID0gZG9jLmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOw0KICAgICAgICAgICAgICAgICAgICBuZXdDYW52YXMud2lkdGggPSBib3VuZHMud2lkdGg7DQogICAgICAgICAgICAgICAgICAgIG5ld0NhbnZhcy5oZWlnaHQgPSBib3VuZHMuaGVpZ2h0Ow0KICAgICAgICAgICAgICAgICAgICBjdHggPSBuZXdDYW52YXMuZ2V0Q29udGV4dCgiMmQiKTsNCg0KICAgICAgICAgICAgICAgICAgICBjdHguZHJhd0ltYWdlKCBjYW52YXMsIGJvdW5kcy5sZWZ0LCBib3VuZHMudG9wLCBib3VuZHMud2lkdGgsIGJvdW5kcy5oZWlnaHQsIDAsIDAsIGJvdW5kcy53aWR0aCwgYm91bmRzLmhlaWdodCApOw0KICAgICAgICAgICAgICAgICAgICBjYW52YXMgPSBudWxsOw0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gbmV3Q2FudmFzOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0gLyplbHNlIHsNCiAgICAgICAgLy8gVE9ETyBjbGlwIGFuZCByZXNpemUgbXVsdGlwbGUgZWxlbWVudHMNCg0KICAgICAgICAgICAgZm9yICggaSA9IDA7IGkgPCBxdWV1ZUxlbjsgaSs9MSApIHsNCiAgICAgICAgICAgICAgICBpZiAob3B0aW9ucy5lbGVtZW50c1sgaSBdIGluc3RhbmNlb2YgRWxlbWVudCkgew0KDQogICAgICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgICAgKi8NCg0KDQoNCiAgICAgICAgICAgIHJldHVybiBjYW52YXM7DQogICAgICAgIH0NCiAgICB9Ow0KDQogICAgcmV0dXJuIG1ldGhvZHM7DQoNCn07DQoNCndpbmRvdy5odG1sMmNhbnZhcyA9IGh0bWwyY2FudmFzOw0KfSh3aW5kb3csIGRvY3VtZW50KSk7DQoNCg==",
                "body": "LyoqDQogIEBsaWNlbnNlIGh0bWwyY2FudmFzIHYwLjM0IDxodHRwOi8vaHRtbDJjYW52YXMuaGVydHplbi5jb20+DQogIENvcHlyaWdodCAoYykgMjAxMSBOaWtsYXMgdm9uIEhlcnR6ZW4uIEFsbCByaWdodHMgcmVzZXJ2ZWQuDQogIGh0dHA6Ly93d3cudHdpdHRlci5jb20vbmlrbGFzdmgNCg0KICBSZWxlYXNlZCB1bmRlciBNSVQgTGljZW5zZQ0KICovDQooZnVuY3Rpb24od2luZG93LCBkb2N1bWVudCwgdW5kZWZpbmVkKXsNCg0KLyoNCiAgaHRtbDJjYW52YXMgdjAuMzQgPGh0dHA6Ly9odG1sMmNhbnZhcy5oZXJ0emVuLmNvbT4NCiAgQ29weXJpZ2h0IChjKSAyMDExIE5pa2xhcyB2b24gSGVydHplbi4gQWxsIHJpZ2h0cyByZXNlcnZlZC4NCiAgaHR0cDovL3d3dy50d2l0dGVyLmNvbS9uaWtsYXN2aA0KDQogIFJlbGVhc2VkIHVuZGVyIE1JVCBMaWNlbnNlDQogKi8NCiJ1c2Ugc3RyaWN0IjsNCg0KdmFyIF9odG1sMmNhbnZhcyA9IHt9LA0KcHJldmlvdXNFbGVtZW50LA0KY29tcHV0ZWRDU1MsDQpodG1sMmNhbnZhczsNCg0KDQpmdW5jdGlvbiBoMmNsb2coYSkgew0KICAgIGlmIChfaHRtbDJjYW52YXMubG9nZ2luZyAmJiB3aW5kb3cuY29uc29sZSAmJiB3aW5kb3cuY29uc29sZS5sb2cpIHsNCiAgICAgICAgd2luZG93LmNvbnNvbGUubG9nKGEpOw0KICAgIH0NCn0NCg0KX2h0bWwyY2FudmFzLlV0aWwgPSB7fTsNCg0KX2h0bWwyY2FudmFzLlV0aWwuYmFja2dyb3VuZEltYWdlID0gZnVuY3Rpb24gKHNyYykgew0KDQogICAgaWYgKC9kYXRhOmltYWdlXC8uKjtiYXNlNjQsL2kudGVzdCggc3JjICkgfHwgL14oLXdlYmtpdHwtbW96fGxpbmVhci1ncmFkaWVudHwtby0pLy50ZXN0KCBzcmMgKSkgew0KICAgICAgICByZXR1cm4gc3JjOw0KICAgIH0NCg0KICAgIGlmIChzcmMudG9Mb3dlckNhc2UoKS5zdWJzdHIoIDAsIDUgKSA9PT0gJ3VybCgiJykgew0KICAgICAgICBzcmMgPSBzcmMuc3Vic3RyKCA1ICk7DQogICAgICAgIHNyYyA9IHNyYy5zdWJzdHIoIDAsIHNyYy5sZW5ndGggLSAyICk7DQogICAgfSBlbHNlIHsNCiAgICAgICAgc3JjID0gc3JjLnN1YnN0ciggNCApOw0KICAgICAgICBzcmMgPSBzcmMuc3Vic3RyKCAwLCBzcmMubGVuZ3RoIC0gMSApOw0KICAgIH0NCg0KICAgIHJldHVybiBzcmM7DQp9Ow0KDQpmdW5jdGlvbiBhZGp1c3RCb3VuZHMoZWwsIGJveCkgew0KICAgIHZhciB3aW4gPSBkb2N1bWVudC5kZWZhdWx0VmlldzsNCiAgICB2YXIgZG9jID0gZWwub3duZXJEb2N1bWVudDsNCiAgICB2YXIgYm9keSA9IGRvYy5ib2R5Ow0KICAgIHZhciBkb2NFbGVtID0gZG9jLmRvY3VtZW50RWxlbWVudDsNCiAgICB2YXIgY2xpZW50VG9wICA9IGRvY0VsZW0uY2xpZW50VG9wICB8fCBib2R5LmNsaWVudFRvcCAgfHwgMDsNCiAgICB2YXIgY2xpZW50TGVmdCA9IGRvY0VsZW0uY2xpZW50TGVmdCB8fCBib2R5LmNsaWVudExlZnQgfHwgMDsNCiAgICB2YXIgc2Nyb2xsVG9wICA9IHdpbi5wYWdlWU9mZnNldCB8fCBkb2NFbGVtLnNjcm9sbFRvcDsNCiAgICB2YXIgc2Nyb2xsTGVmdCA9IHdpbi5wYWdlWE9mZnNldCB8fCBkb2NFbGVtLnNjcm9sbExlZnQ7DQogICAgdmFyIHRvcCAgPSBib3gudG9wICArIHNjcm9sbFRvcCAgLSBjbGllbnRUb3A7DQogICAgdmFyIGxlZnQgPSBib3gubGVmdCArIHNjcm9sbExlZnQgLSBjbGllbnRMZWZ0Ow0KDQogICAgcmV0dXJuIHsNCiAgICAgICAgdG9wOiB0b3AsDQogICAgICAgIGxlZnQ6IGxlZnQsDQogICAgICAgIGJvdHRvbTogdG9wICsgYm94LmhlaWdodCwNCiAgICAgICAgaGVpZ2h0OiBib3guaGVpZ2h0LA0KICAgICAgICB3aWR0aDogYm94LndpZHRoDQogICAgfTsNCn0NCg0KX2h0bWwyY2FudmFzLlV0aWwuQm91bmRzID0gZnVuY3Rpb24gZ2V0Qm91bmRzIChlbCkgew0KICAgIHZhciBjbGllbnRSZWN0LA0KICAgIGJvdW5kcyA9IHt9Ow0KDQogICAgaWYgKGVsLmdldEJvdW5kaW5nQ2xpZW50UmVjdCl7DQogICAgICAgIHJldHVybiBhZGp1c3RCb3VuZHMoZWwsIGVsLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpKTsNCiAgICB9DQp9Ow0KDQpfaHRtbDJjYW52YXMuVXRpbC5nZXRDU1MgPSBmdW5jdGlvbiAoZWwsIGF0dHJpYnV0ZSkgew0KICAgIC8vIHJldHVybiAkKGVsKS5jc3MoYXR0cmlidXRlKTsNCg0KICAgIHZhciB2YWw7DQoNCiAgICBmdW5jdGlvbiB0b1BYKCBhdHRyaWJ1dGUsIHZhbCApIHsNCiAgICAgICAgdmFyIHJzTGVmdCA9IGVsLnJ1bnRpbWVTdHlsZSAmJiBlbC5ydW50aW1lU3R5bGVbIGF0dHJpYnV0ZSBdLA0KICAgICAgICBsZWZ0LA0KICAgICAgICBzdHlsZSA9IGVsLnN0eWxlOw0KDQogICAgICAgIC8vIENoZWNrIGlmIHdlIGFyZSBub3QgZGVhbGluZyB3aXRoIHBpeGVscywgKE9wZXJhIGhhcyBpc3N1ZXMgd2l0aCB0aGlzKQ0KICAgICAgICAvLyBQb3J0ZWQgZnJvbSBqUXVlcnkgY3NzLmpzDQogICAgICAgIC8vIEZyb20gdGhlIGF3ZXNvbWUgaGFjayBieSBEZWFuIEVkd2FyZHMNCiAgICAgICAgLy8gaHR0cDovL2VyaWsuZWFlLm5ldC9hcmNoaXZlcy8yMDA3LzA3LzI3LzE4LjU0LjE1LyNjb21tZW50LTEwMjI5MQ0KDQogICAgICAgIC8vIElmIHdlJ3JlIG5vdCBkZWFsaW5nIHdpdGggYSByZWd1bGFyIHBpeGVsIG51bWJlcg0KICAgICAgICAvLyBidXQgYSBudW1iZXIgdGhhdCBoYXMgYSB3ZWlyZCBlbmRpbmcsIHdlIG5lZWQgdG8gY29udmVydCBpdCB0byBwaXhlbHMNCg0KICAgICAgICBpZiAoICEvXi0/WzAtOV0rXC4/WzAtOV0qKD86cHgpPyQvaS50ZXN0KCB2YWwgKSAmJiAvXi0/XGQvLnRlc3QoIHZhbCApICkgew0KDQogICAgICAgICAgICAvLyBSZW1lbWJlciB0aGUgb3JpZ2luYWwgdmFsdWVzDQogICAgICAgICAgICBsZWZ0ID0gc3R5bGUubGVmdDsNCg0KICAgICAgICAgICAgLy8gUHV0IGluIHRoZSBuZXcgdmFsdWVzIHRvIGdldCBhIGNvbXB1dGVkIHZhbHVlIG91dA0KICAgICAgICAgICAgaWYgKCByc0xlZnQgKSB7DQogICAgICAgICAgICAgICAgZWwucnVudGltZVN0eWxlLmxlZnQgPSBlbC5jdXJyZW50U3R5bGUubGVmdDsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIHN0eWxlLmxlZnQgPSBhdHRyaWJ1dGUgPT09ICJmb250U2l6ZSIgPyAiMWVtIiA6ICh2YWwgfHwgMCk7DQogICAgICAgICAgICB2YWwgPSBzdHlsZS5waXhlbExlZnQgKyAicHgiOw0KDQogICAgICAgICAgICAvLyBSZXZlcnQgdGhlIGNoYW5nZWQgdmFsdWVzDQogICAgICAgICAgICBzdHlsZS5sZWZ0ID0gbGVmdDsNCiAgICAgICAgICAgIGlmICggcnNMZWZ0ICkgew0KICAgICAgICAgICAgICAgIGVsLnJ1bnRpbWVTdHlsZS5sZWZ0ID0gcnNMZWZ0Ow0KICAgICAgICAgICAgfQ0KDQogICAgICAgIH0NCg0KICAgICAgICBpZiAoIS9eKHRoaW58bWVkaXVtfHRoaWNrKSQvaS50ZXN0KCB2YWwgKSkgew0KICAgICAgICAgICAgcmV0dXJuIE1hdGgucm91bmQocGFyc2VGbG9hdCggdmFsICkpICsgInB4IjsNCiAgICAgICAgfQ0KDQogICAgICAgIHJldHVybiB2YWw7DQoNCiAgICB9DQoNCg0KICAgIGlmICggd2luZG93LmdldENvbXB1dGVkU3R5bGUgKSB7DQogICAgICAgIGlmICggcHJldmlvdXNFbGVtZW50ICE9PSBlbCApIHsNCiAgICAgICAgICAgIGNvbXB1dGVkQ1NTID0gZG9jdW1lbnQuZGVmYXVsdFZpZXcuZ2V0Q29tcHV0ZWRTdHlsZShlbCwgbnVsbCk7DQogICAgICAgIH0NCiAgICAgICAgdmFsID0gY29tcHV0ZWRDU1NbIGF0dHJpYnV0ZSBdOw0KDQogICAgICAgIGlmICggYXR0cmlidXRlID09PSAiYmFja2dyb3VuZFBvc2l0aW9uIiApIHsNCg0KICAgICAgICAgICAgdmFsID0gKHZhbC5zcGxpdCgiLCIpWzBdIHx8ICIwIDAiKS5zcGxpdCgiICIpOw0KDQogICAgICAgICAgICB2YWxbIDAgXSA9ICggdmFsWzBdLmluZGV4T2YoICIlIiApID09PSAtMSApID8gdG9QWCggIGF0dHJpYnV0ZSArICJYIiwgdmFsWyAwIF0gKSA6IHZhbFsgMCBdOw0KICAgICAgICAgICAgdmFsWyAxIF0gPSAoIHZhbFsxXSA9PT0gdW5kZWZpbmVkICkgPyB2YWxbMF0gOiB2YWxbMV07IC8vIElFIDkgZG9lc24ndCByZXR1cm4gZG91YmxlIGRpZ2l0IGFsd2F5cw0KICAgICAgICAgICAgdmFsWyAxIF0gPSAoIHZhbFsxXS5pbmRleE9mKCAiJSIgKSA9PT0gLTEgKSA/IHRvUFgoICBhdHRyaWJ1dGUgKyAiWSIsIHZhbFsgMSBdICkgOiB2YWxbIDEgXTsNCiAgICAgICAgfQ0KDQogICAgfSBlbHNlIGlmICggZWwuY3VycmVudFN0eWxlICkgew0KICAgICAgICAvLyBJRSA5Pg0KICAgICAgICBpZiAoYXR0cmlidXRlID09PSAiYmFja2dyb3VuZFBvc2l0aW9uIikgew0KICAgICAgICAgICAgLy8gT2xkZXIgSUUgdXNlcyAteCBhbmQgLXkNCiAgICAgICAgICAgIHZhbCA9IFsgdG9QWCggIGF0dHJpYnV0ZSArICJYIiwgZWwuY3VycmVudFN0eWxlWyBhdHRyaWJ1dGUgKyAiWCIgXSAgKSwgdG9QWCggIGF0dHJpYnV0ZSArICJZIiwgZWwuY3VycmVudFN0eWxlWyBhdHRyaWJ1dGUgKyAiWSIgXSAgKSBdOw0KICAgICAgICB9IGVsc2Ugew0KDQogICAgICAgICAgICB2YWwgPSB0b1BYKCAgYXR0cmlidXRlLCBlbC5jdXJyZW50U3R5bGVbIGF0dHJpYnV0ZSBdICApOw0KDQogICAgICAgICAgICBpZiAoL14oYm9yZGVyKS9pLnRlc3QoIGF0dHJpYnV0ZSApICYmIC9eKG1lZGl1bXx0aGlufHRoaWNrKSQvaS50ZXN0KCB2YWwgKSkgew0KICAgICAgICAgICAgICAgIHN3aXRjaCAodmFsKSB7DQogICAgICAgICAgICAgICAgICAgIGNhc2UgInRoaW4iOg0KICAgICAgICAgICAgICAgICAgICAgICAgdmFsID0gIjFweCI7DQogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgICAgICAgICAgY2FzZSAibWVkaXVtIjoNCiAgICAgICAgICAgICAgICAgICAgICAgIHZhbCA9ICIwcHgiOyAvLyB0aGlzIGlzIHdyb25nLCBpdCBzaG91bGQgYmUgM3B4IGJ1dCBJRSB1c2VzIG1lZGl1bSBmb3Igbm8gYm9yZGVyIGFzIHdlbGwuLiBUT0RPIGZpbmQgYSB3b3JrIGFyb3VuZA0KICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICAgICAgICAgIGNhc2UgInRoaWNrIjoNCiAgICAgICAgICAgICAgICAgICAgICAgIHZhbCA9ICI1cHgiOw0KICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQoNCg0KDQogICAgfQ0KDQoNCg0KDQogICAgcmV0dXJuIHZhbDsNCg0KDQoNCi8vcmV0dXJuICQoZWwpLmNzcyhhdHRyaWJ1dGUpOw0KDQoNCn07DQoNCg0KX2h0bWwyY2FudmFzLlV0aWwuQmFja2dyb3VuZFBvc2l0aW9uID0gZnVuY3Rpb24gKCBlbCwgYm91bmRzLCBpbWFnZSApIHsNCiAgICAvLyBUT0RPIGFkZCBzdXBwb3J0IGZvciBtdWx0aSBpbWFnZSBiYWNrZ3JvdW5kcw0KDQogICAgdmFyIGJncG9zaXRpb24gPSAgX2h0bWwyY2FudmFzLlV0aWwuZ2V0Q1NTKCBlbCwgImJhY2tncm91bmRQb3NpdGlvbiIgKSAsDQogICAgdG9wUG9zLA0KICAgIGxlZnQsDQogICAgcGVyY2VudGFnZSwNCiAgICB2YWw7DQoNCiAgICBpZiAoYmdwb3NpdGlvbi5sZW5ndGggPT09IDEpew0KICAgICAgICB2YWwgPSBiZ3Bvc2l0aW9uOw0KDQogICAgICAgIGJncG9zaXRpb24gPSBbXTsNCg0KICAgICAgICBiZ3Bvc2l0aW9uWzBdID0gdmFsOw0KICAgICAgICBiZ3Bvc2l0aW9uWzFdID0gdmFsOw0KICAgIH0NCg0KDQoNCiAgICBpZiAoYmdwb3NpdGlvblswXS50b1N0cmluZygpLmluZGV4T2YoIiUiKSAhPT0gLTEpew0KICAgICAgICBwZXJjZW50YWdlID0gKHBhcnNlRmxvYXQoYmdwb3NpdGlvblswXSkvMTAwKTsNCiAgICAgICAgbGVmdCA9ICAoKGJvdW5kcy53aWR0aCAqIHBlcmNlbnRhZ2UpLShpbWFnZS53aWR0aCpwZXJjZW50YWdlKSk7DQoNCiAgICB9ZWxzZXsNCiAgICAgICAgbGVmdCA9IHBhcnNlSW50KGJncG9zaXRpb25bMF0sMTApOw0KICAgIH0NCg0KICAgIGlmIChiZ3Bvc2l0aW9uWzFdLnRvU3RyaW5nKCkuaW5kZXhPZigiJSIpICE9PSAtMSl7DQoNCiAgICAgICAgcGVyY2VudGFnZSA9IChwYXJzZUZsb2F0KGJncG9zaXRpb25bMV0pLzEwMCk7DQogICAgICAgIHRvcFBvcyA9ICAoKGJvdW5kcy5oZWlnaHQgKiBwZXJjZW50YWdlKS0oaW1hZ2UuaGVpZ2h0KnBlcmNlbnRhZ2UpKTsNCiAgICB9ZWxzZXsNCiAgICAgICAgdG9wUG9zID0gcGFyc2VJbnQoYmdwb3NpdGlvblsxXSwxMCk7DQogICAgfQ0KDQoNCg0KDQogICAgcmV0dXJuIHsNCiAgICAgICAgdG9wOiB0b3BQb3MsDQogICAgICAgIGxlZnQ6IGxlZnQNCiAgICB9Ow0KDQp9Ow0KDQpfaHRtbDJjYW52YXMuVXRpbC5FeHRlbmQgPSBmdW5jdGlvbiAob3B0aW9ucywgZGVmYXVsdHMpIHsNCiAgICBmb3IgKHZhciBrZXkgaW4gb3B0aW9ucykgew0KICAgICAgICBpZiAob3B0aW9ucy5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7DQogICAgICAgICAgICBkZWZhdWx0c1trZXldID0gb3B0aW9uc1trZXldOw0KICAgICAgICB9DQogICAgfQ0KICAgIHJldHVybiBkZWZhdWx0czsNCn07DQoNCg0KLyoNCiAqIERlcml2ZWQgZnJvbSBqUXVlcnkuY29udGVudHMoKQ0KICogQ29weXJpZ2h0IDIwMTAsIEpvaG4gUmVzaWcNCiAqIER1YWwgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBvciBHUEwgVmVyc2lvbiAyIGxpY2Vuc2VzLg0KICogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQ0KICovDQpfaHRtbDJjYW52YXMuVXRpbC5DaGlsZHJlbiA9IGZ1bmN0aW9uKCBlbGVtICkgew0KDQoNCiAgICB2YXIgY2hpbGRyZW47DQogICAgdHJ5IHsNCg0KICAgICAgICBjaGlsZHJlbiA9IChlbGVtLm5vZGVOYW1lICYmIGVsZW0ubm9kZU5hbWUudG9VcHBlckNhc2UoKSA9PT0gIklGUkFNRSIpID8NCiAgICAgICAgZWxlbS5jb250ZW50RG9jdW1lbnQgfHwgZWxlbS5jb250ZW50V2luZG93LmRvY3VtZW50IDogKGZ1bmN0aW9uKCBhcnJheSApew0KICAgICAgICAgICAgdmFyIHJldCA9IFtdOw0KDQogICAgICAgICAgICBpZiAoIGFycmF5ICE9PSBudWxsICkgew0KDQogICAgICAgICAgICAgICAgKGZ1bmN0aW9uKCBmaXJzdCwgc2Vjb25kICkgew0KICAgICAgICAgICAgICAgICAgICB2YXIgaSA9IGZpcnN0Lmxlbmd0aCwNCiAgICAgICAgICAgICAgICAgICAgaiA9IDA7DQoNCiAgICAgICAgICAgICAgICAgICAgaWYgKCB0eXBlb2Ygc2Vjb25kLmxlbmd0aCA9PT0gIm51bWJlciIgKSB7DQogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKCB2YXIgbCA9IHNlY29uZC5sZW5ndGg7IGogPCBsOyBqKysgKSB7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlyc3RbIGkrKyBdID0gc2Vjb25kWyBqIF07DQogICAgICAgICAgICAgICAgICAgICAgICB9DQoNCiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlICggc2Vjb25kW2pdICE9PSB1bmRlZmluZWQgKSB7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlyc3RbIGkrKyBdID0gc2Vjb25kWyBqKysgXTsNCiAgICAgICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAgICAgICAgIGZpcnN0Lmxlbmd0aCA9IGk7DQoNCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZpcnN0Ow0KICAgICAgICAgICAgICAgIH0pKCByZXQsIGFycmF5ICk7DQoNCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgcmV0dXJuIHJldDsNCiAgICAgICAgfSkoIGVsZW0uY2hpbGROb2RlcyApOw0KDQogICAgfSBjYXRjaCAoZXgpIHsNCiAgICAgICAgaDJjbG9nKCJodG1sMmNhbnZhcy5VdGlsLkNoaWxkcmVuIGZhaWxlZCB3aXRoIGV4Y2VwdGlvbjogIiArIGV4Lm1lc3NhZ2UpOw0KICAgICAgICBjaGlsZHJlbiA9IFtdOw0KICAgIH0NCiAgICByZXR1cm4gY2hpbGRyZW47DQp9Ow0KDQovKg0KICBodG1sMmNhbnZhcyB2MC4zNCA8aHR0cDovL2h0bWwyY2FudmFzLmhlcnR6ZW4uY29tPg0KICBDb3B5cmlnaHQgKGMpIDIwMTEgTmlrbGFzIHZvbiBIZXJ0emVuLiBBbGwgcmlnaHRzIHJlc2VydmVkLg0KICBodHRwOi8vd3d3LnR3aXR0ZXIuY29tL25pa2xhc3ZoDQoNCiAgQ29udHJpYnV0b3Iocyk6DQogICAgICBOaWtsYXMgdm9uIEhlcnR6ZW4gPGh0dHA6Ly93d3cudHdpdHRlci5jb20vbmlrbGFzdmg+DQogICAgICBBbmRyw6kgRmllZGxlciAgICAgIDxodHRwOi8vd3d3LnR3aXR0ZXIuY29tL3Nvbm5lbmtpc3RlPg0KDQogIFJlbGVhc2VkIHVuZGVyIE1JVCBMaWNlbnNlDQogKi8NCg0KKGZ1bmN0aW9uKCl7DQoNCl9odG1sMmNhbnZhcy5HZW5lcmF0ZSA9IHt9Ow0KDQp2YXIgcmVHcmFkaWVudHMgPSBbDQogICAgL14oLXdlYmtpdC1saW5lYXItZ3JhZGllbnQpXCgoW2EtelxzXSspKFtcd1xkXC5ccywlXChcKV0rKVwpJC8sDQogICAgL14oLW8tbGluZWFyLWdyYWRpZW50KVwoKFthLXpcc10rKShbXHdcZFwuXHMsJVwoXCldKylcKSQvLA0KICAgIC9eKC13ZWJraXQtZ3JhZGllbnQpXCgobGluZWFyfHJhZGlhbCksXHMoKD86XGR7MSwzfSU/KVxzKD86XGR7MSwzfSU/KSxccyg/OlxkezEsM30lPylccyg/OlxkezEsM30lPykpKFtcd1xkXC5ccywlXChcKS1dKylcKSQvLA0KICAgIC9eKC1tb3otbGluZWFyLWdyYWRpZW50KVwoKCg/OlxkezEsM30lPylccyg/OlxkezEsM30lPykpKFtcd1xkXC5ccywlXChcKV0rKVwpJC8sDQogICAgL14oLXdlYmtpdC1yYWRpYWwtZ3JhZGllbnQpXCgoKD86XGR7MSwzfSU/KVxzKD86XGR7MSwzfSU/KSksXHMoXHcrKVxzKFthLXotXSspKFtcd1xkXC5ccywlXChcKV0rKVwpJC8sDQogICAgL14oLW1vei1yYWRpYWwtZ3JhZGllbnQpXCgoKD86XGR7MSwzfSU/KVxzKD86XGR7MSwzfSU/KSksXHMoXHcrKVxzPyhbYS16LV0qKShbXHdcZFwuXHMsJVwoXCldKylcKSQvLA0KICAgIC9eKC1vLXJhZGlhbC1ncmFkaWVudClcKCgoPzpcZHsxLDN9JT8pXHMoPzpcZHsxLDN9JT8pKSxccyhcdyspXHMoW2Etei1dKykoW1x3XGRcLlxzLCVcKFwpXSspXCkkLw0KXTsNCg0KLyoNCiAqIFRPRE86IEFkZCBJRTEwIHZlbmRvciBwcmVmaXggKC1tcykgc3VwcG9ydA0KICogVE9ETzogQWRkIFczQyBncmFkaWVudCAobGluZWFyLWdyYWRpZW50KSBzdXBwb3J0DQogKiBUT0RPOiBBZGQgb2xkIFdlYmtpdCAtd2Via2l0LWdyYWRpZW50KHJhZGlhbCwgLi4uKSBzdXBwb3J0DQogKiBUT0RPOiBNYXliZSBzb21lIFJlZ0V4cCBvcHRpbWl6YXRpb25zIGFyZSBwb3NzaWJsZSA7bykNCiAqLw0KX2h0bWwyY2FudmFzLkdlbmVyYXRlLnBhcnNlR3JhZGllbnQgPSBmdW5jdGlvbihjc3MsIGJvdW5kcykgew0KICAgIHZhciBncmFkaWVudCwgaSwgbGVuID0gcmVHcmFkaWVudHMubGVuZ3RoLCBtMSwgc3RvcCwgbTIsIG0yTGVuLCBzdGVwLCBtMzsNCg0KICAgIGZvcihpID0gMDsgaSA8IGxlbjsgaSs9MSl7DQogICAgICAgIG0xID0gY3NzLm1hdGNoKHJlR3JhZGllbnRzW2ldKTsNCiAgICAgICAgaWYobTEpIGJyZWFrOw0KICAgIH0NCg0KICAgIGlmKG0xKSB7DQogICAgICAgIHN3aXRjaChtMVsxXSkgew0KICAgICAgICAgICAgY2FzZSAnLXdlYmtpdC1saW5lYXItZ3JhZGllbnQnOg0KICAgICAgICAgICAgY2FzZSAnLW8tbGluZWFyLWdyYWRpZW50JzoNCg0KICAgICAgICAgICAgICAgIGdyYWRpZW50ID0gew0KICAgICAgICAgICAgICAgICAgICB0eXBlOiAnbGluZWFyJywNCiAgICAgICAgICAgICAgICAgICAgeDA6IG51bGwsDQogICAgICAgICAgICAgICAgICAgIHkwOiBudWxsLA0KICAgICAgICAgICAgICAgICAgICB4MTogbnVsbCwNCiAgICAgICAgICAgICAgICAgICAgeTE6IG51bGwsDQogICAgICAgICAgICAgICAgICAgIGNvbG9yU3RvcHM6IFtdDQogICAgICAgICAgICAgICAgfTsNCg0KICAgICAgICAgICAgICAgIC8vIGdldCBjb29yZGluYXRlcw0KICAgICAgICAgICAgICAgIG0yID0gbTFbMl0ubWF0Y2goL1x3Ky9nKTsNCiAgICAgICAgICAgICAgICBpZihtMil7DQogICAgICAgICAgICAgICAgICAgIG0yTGVuID0gbTIubGVuZ3RoOw0KICAgICAgICAgICAgICAgICAgICBmb3IoaSA9IDA7IGkgPCBtMkxlbjsgaSs9MSl7DQogICAgICAgICAgICAgICAgICAgICAgICBzd2l0Y2gobTJbaV0pIHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICd0b3AnOg0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBncmFkaWVudC55MCA9IDA7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LnkxID0gYm91bmRzLmhlaWdodDsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7DQoNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdyaWdodCc6DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LngwID0gYm91bmRzLndpZHRoOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBncmFkaWVudC54MSA9IDA7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOw0KDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnYm90dG9tJzoNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQueTAgPSBib3VuZHMuaGVpZ2h0Ow0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBncmFkaWVudC55MSA9IDA7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOw0KDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnbGVmdCc6DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LngwID0gMDsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQueDEgPSBib3VuZHMud2lkdGg7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIGlmKGdyYWRpZW50LngwID09PSBudWxsICYmIGdyYWRpZW50LngxID09PSBudWxsKXsgLy8gY2VudGVyDQogICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LngwID0gZ3JhZGllbnQueDEgPSBib3VuZHMud2lkdGggLyAyOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICBpZihncmFkaWVudC55MCA9PT0gbnVsbCAmJiBncmFkaWVudC55MSA9PT0gbnVsbCl7IC8vIGNlbnRlcg0KICAgICAgICAgICAgICAgICAgICBncmFkaWVudC55MCA9IGdyYWRpZW50LnkxID0gYm91bmRzLmhlaWdodCAvIDI7DQogICAgICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAgICAgLy8gZ2V0IGNvbG9ycyBhbmQgc3RvcHMNCiAgICAgICAgICAgICAgICBtMiA9IG0xWzNdLm1hdGNoKC8oKD86cmdifHJnYmEpXChcZHsxLDN9LFxzXGR7MSwzfSxcc1xkezEsM30oPzosXHNbMC05XC5dKyk/XCkoPzpcc1xkezEsM30oPzolfHB4KSk/KSsvZyk7DQogICAgICAgICAgICAgICAgaWYobTIpew0KICAgICAgICAgICAgICAgICAgICBtMkxlbiA9IG0yLmxlbmd0aDsNCiAgICAgICAgICAgICAgICAgICAgc3RlcCA9IDEgLyBNYXRoLm1heChtMkxlbiAtIDEsIDEpOw0KICAgICAgICAgICAgICAgICAgICBmb3IoaSA9IDA7IGkgPCBtMkxlbjsgaSs9MSl7DQogICAgICAgICAgICAgICAgICAgICAgICBtMyA9IG0yW2ldLm1hdGNoKC8oKD86cmdifHJnYmEpXChcZHsxLDN9LFxzXGR7MSwzfSxcc1xkezEsM30oPzosXHNbMC05XC5dKyk/XCkpXHMqKFxkezEsM30pPyglfHB4KT8vKTsNCiAgICAgICAgICAgICAgICAgICAgICAgIGlmKG0zWzJdKXsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdG9wID0gcGFyc2VGbG9hdChtM1syXSk7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYobTNbM10gPT09ICclJyl7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0b3AgLz0gMTAwOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7IC8vIHB4IC0gc3R1cGlkIG9wZXJhDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0b3AgLz0gYm91bmRzLndpZHRoOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RvcCA9IGkgKiBzdGVwOw0KICAgICAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQuY29sb3JTdG9wcy5wdXNoKHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xvcjogbTNbMV0sDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RvcDogc3RvcA0KICAgICAgICAgICAgICAgICAgICAgICAgfSk7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgYnJlYWs7DQoNCiAgICAgICAgICAgIGNhc2UgJy13ZWJraXQtZ3JhZGllbnQnOg0KDQogICAgICAgICAgICAgICAgZ3JhZGllbnQgPSB7DQogICAgICAgICAgICAgICAgICAgIHR5cGU6IG0xWzJdID09PSAncmFkaWFsJyA/ICdjaXJjbGUnIDogbTFbMl0sIC8vIFRPRE86IEFkZCByYWRpYWwgZ3JhZGllbnQgc3VwcG9ydCBmb3Igb2xkZXIgbW96aWxsYSBkZWZpbml0aW9ucw0KICAgICAgICAgICAgICAgICAgICB4MDogMCwNCiAgICAgICAgICAgICAgICAgICAgeTA6IDAsDQogICAgICAgICAgICAgICAgICAgIHgxOiAwLA0KICAgICAgICAgICAgICAgICAgICB5MTogMCwNCiAgICAgICAgICAgICAgICAgICAgY29sb3JTdG9wczogW10NCiAgICAgICAgICAgICAgICB9Ow0KDQogICAgICAgICAgICAgICAgLy8gZ2V0IGNvb3JkaW5hdGVzDQogICAgICAgICAgICAgICAgbTIgPSBtMVszXS5tYXRjaCgvKFxkezEsM30pJT9ccyhcZHsxLDN9KSU/LFxzKFxkezEsM30pJT9ccyhcZHsxLDN9KSU/Lyk7DQogICAgICAgICAgICAgICAgaWYobTIpew0KICAgICAgICAgICAgICAgICAgICBncmFkaWVudC54MCA9IChtMlsxXSAqIGJvdW5kcy53aWR0aCkgLyAxMDA7DQogICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LnkwID0gKG0yWzJdICogYm91bmRzLmhlaWdodCkgLyAxMDA7DQogICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LngxID0gKG0yWzNdICogYm91bmRzLndpZHRoKSAvIDEwMDsNCiAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQueTEgPSAobTJbNF0gKiBib3VuZHMuaGVpZ2h0KSAvIDEwMDsNCiAgICAgICAgICAgICAgICB9DQoNCiAgICAgICAgICAgICAgICAvLyBnZXQgY29sb3JzIGFuZCBzdG9wcw0KICAgICAgICAgICAgICAgIG0yID0gbTFbNF0ubWF0Y2goLygoPzpmcm9tfHRvfGNvbG9yLXN0b3ApXCgoPzpbMC05XC5dKyxccyk/KD86cmdifHJnYmEpXChcZHsxLDN9LFxzXGR7MSwzfSxcc1xkezEsM30oPzosXHNbMC05XC5dKyk/XClcKSkrL2cpOw0KICAgICAgICAgICAgICAgIGlmKG0yKXsNCiAgICAgICAgICAgICAgICAgICAgbTJMZW4gPSBtMi5sZW5ndGg7DQogICAgICAgICAgICAgICAgICAgIGZvcihpID0gMDsgaSA8IG0yTGVuOyBpKz0xKXsNCiAgICAgICAgICAgICAgICAgICAgICAgIG0zID0gbTJbaV0ubWF0Y2goLyhmcm9tfHRvfGNvbG9yLXN0b3ApXCgoWzAtOVwuXSspPyg/Oixccyk/KCg/OnJnYnxyZ2JhKVwoXGR7MSwzfSxcc1xkezEsM30sXHNcZHsxLDN9KD86LFxzWzAtOVwuXSspP1wpKVwpLyk7DQogICAgICAgICAgICAgICAgICAgICAgICBzdG9wID0gcGFyc2VGbG9hdChtM1syXSk7DQogICAgICAgICAgICAgICAgICAgICAgICBpZihtM1sxXSA9PT0gJ2Zyb20nKSBzdG9wID0gMC4wOw0KICAgICAgICAgICAgICAgICAgICAgICAgaWYobTNbMV0gPT09ICd0bycpIHN0b3AgPSAxLjA7DQogICAgICAgICAgICAgICAgICAgICAgICBncmFkaWVudC5jb2xvclN0b3BzLnB1c2goew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yOiBtM1szXSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdG9wOiBzdG9wDQogICAgICAgICAgICAgICAgICAgICAgICB9KTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICBicmVhazsNCg0KICAgICAgICAgICAgY2FzZSAnLW1vei1saW5lYXItZ3JhZGllbnQnOg0KDQogICAgICAgICAgICAgICAgZ3JhZGllbnQgPSB7DQogICAgICAgICAgICAgICAgICAgIHR5cGU6ICdsaW5lYXInLA0KICAgICAgICAgICAgICAgICAgICB4MDogMCwNCiAgICAgICAgICAgICAgICAgICAgeTA6IDAsDQogICAgICAgICAgICAgICAgICAgIHgxOiAwLA0KICAgICAgICAgICAgICAgICAgICB5MTogMCwNCiAgICAgICAgICAgICAgICAgICAgY29sb3JTdG9wczogW10NCiAgICAgICAgICAgICAgICB9Ow0KDQogICAgICAgICAgICAgICAgLy8gZ2V0IGNvb3JkaW5hdGVzDQogICAgICAgICAgICAgICAgbTIgPSBtMVsyXS5tYXRjaCgvKFxkezEsM30pJT9ccyhcZHsxLDN9KSU/Lyk7DQoNCiAgICAgICAgICAgICAgICAvLyBtMlsxXSA9PSAwJSAgIC0+IGxlZnQNCiAgICAgICAgICAgICAgICAvLyBtMlsxXSA9PSA1MCUgIC0+IGNlbnRlcg0KICAgICAgICAgICAgICAgIC8vIG0yWzFdID09IDEwMCUgLT4gcmlnaHQNCg0KICAgICAgICAgICAgICAgIC8vIG0yWzJdID09IDAlICAgLT4gdG9wDQogICAgICAgICAgICAgICAgLy8gbTJbMl0gPT0gNTAlICAtPiBjZW50ZXINCiAgICAgICAgICAgICAgICAvLyBtMlsyXSA9PSAxMDAlIC0+IGJvdHRvbQ0KDQogICAgICAgICAgICAgICAgaWYobTIpew0KICAgICAgICAgICAgICAgICAgICBncmFkaWVudC54MCA9IChtMlsxXSAqIGJvdW5kcy53aWR0aCkgLyAxMDA7DQogICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LnkwID0gKG0yWzJdICogYm91bmRzLmhlaWdodCkgLyAxMDA7DQogICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LngxID0gYm91bmRzLndpZHRoIC0gZ3JhZGllbnQueDA7DQogICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LnkxID0gYm91bmRzLmhlaWdodCAtIGdyYWRpZW50LnkwOw0KICAgICAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgICAgIC8vIGdldCBjb2xvcnMgYW5kIHN0b3BzDQogICAgICAgICAgICAgICAgbTIgPSBtMVszXS5tYXRjaCgvKCg/OnJnYnxyZ2JhKVwoXGR7MSwzfSxcc1xkezEsM30sXHNcZHsxLDN9KD86LFxzWzAtOVwuXSspP1wpKD86XHNcZHsxLDN9JSk/KSsvZyk7DQogICAgICAgICAgICAgICAgaWYobTIpew0KICAgICAgICAgICAgICAgICAgICBtMkxlbiA9IG0yLmxlbmd0aDsNCiAgICAgICAgICAgICAgICAgICAgc3RlcCA9IDEgLyBNYXRoLm1heChtMkxlbiAtIDEsIDEpOw0KICAgICAgICAgICAgICAgICAgICBmb3IoaSA9IDA7IGkgPCBtMkxlbjsgaSs9MSl7DQogICAgICAgICAgICAgICAgICAgICAgICBtMyA9IG0yW2ldLm1hdGNoKC8oKD86cmdifHJnYmEpXChcZHsxLDN9LFxzXGR7MSwzfSxcc1xkezEsM30oPzosXHNbMC05XC5dKyk/XCkpXHMqKFxkezEsM30pPyglKT8vKTsNCiAgICAgICAgICAgICAgICAgICAgICAgIGlmKG0zWzJdKXsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdG9wID0gcGFyc2VGbG9hdChtM1syXSk7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYobTNbM10peyAvLyBwZXJjZW50YWdlDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0b3AgLz0gMTAwOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RvcCA9IGkgKiBzdGVwOw0KICAgICAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQuY29sb3JTdG9wcy5wdXNoKHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xvcjogbTNbMV0sDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RvcDogc3RvcA0KICAgICAgICAgICAgICAgICAgICAgICAgfSk7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgYnJlYWs7DQoNCiAgICAgICAgICAgIGNhc2UgJy13ZWJraXQtcmFkaWFsLWdyYWRpZW50JzoNCiAgICAgICAgICAgIGNhc2UgJy1tb3otcmFkaWFsLWdyYWRpZW50JzoNCiAgICAgICAgICAgIGNhc2UgJy1vLXJhZGlhbC1ncmFkaWVudCc6DQoNCiAgICAgICAgICAgICAgICBncmFkaWVudCA9IHsNCiAgICAgICAgICAgICAgICAgICAgdHlwZTogJ2NpcmNsZScsDQogICAgICAgICAgICAgICAgICAgIHgwOiAwLA0KICAgICAgICAgICAgICAgICAgICB5MDogMCwNCiAgICAgICAgICAgICAgICAgICAgeDE6IGJvdW5kcy53aWR0aCwNCiAgICAgICAgICAgICAgICAgICAgeTE6IGJvdW5kcy5oZWlnaHQsDQogICAgICAgICAgICAgICAgICAgIGN4OiAwLA0KICAgICAgICAgICAgICAgICAgICBjeTogMCwNCiAgICAgICAgICAgICAgICAgICAgcng6IDAsDQogICAgICAgICAgICAgICAgICAgIHJ5OiAwLA0KICAgICAgICAgICAgICAgICAgICBjb2xvclN0b3BzOiBbXQ0KICAgICAgICAgICAgICAgIH07DQoNCiAgICAgICAgICAgICAgICAvLyBjZW50ZXINCiAgICAgICAgICAgICAgICBtMiA9IG0xWzJdLm1hdGNoKC8oXGR7MSwzfSklP1xzKFxkezEsM30pJT8vKTsNCiAgICAgICAgICAgICAgICBpZihtMil7DQogICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LmN4ID0gKG0yWzFdICogYm91bmRzLndpZHRoKSAvIDEwMDsNCiAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQuY3kgPSAobTJbMl0gKiBib3VuZHMuaGVpZ2h0KSAvIDEwMDsNCiAgICAgICAgICAgICAgICB9DQoNCiAgICAgICAgICAgICAgICAvLyBzaXplDQogICAgICAgICAgICAgICAgbTIgPSBtMVszXS5tYXRjaCgvXHcrLyk7DQogICAgICAgICAgICAgICAgbTMgPSBtMVs0XS5tYXRjaCgvW2Etei1dKi8pOw0KICAgICAgICAgICAgICAgIGlmKG0yICYmIG0zKXsNCiAgICAgICAgICAgICAgICAgICAgc3dpdGNoKG0zWzBdKXsNCiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ2ZhcnRoZXN0LWNvcm5lcic6DQogICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdjb3Zlcic6IC8vIGlzIGVxdWl2YWxlbnQgdG8gZmFydGhlc3QtY29ybmVyDQogICAgICAgICAgICAgICAgICAgICAgICBjYXNlICcnOiAvLyBtb3ppbGxhIHJlbW92ZXMgImNvdmVyIiBmcm9tIGRlZmluaXRpb24gOigNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdGwgPSBNYXRoLnNxcnQoTWF0aC5wb3coZ3JhZGllbnQuY3gsIDIpICsgTWF0aC5wb3coZ3JhZGllbnQuY3ksIDIpKTsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdHIgPSBNYXRoLnNxcnQoTWF0aC5wb3coZ3JhZGllbnQuY3gsIDIpICsgTWF0aC5wb3coZ3JhZGllbnQueTEgLSBncmFkaWVudC5jeSwgMikpOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBiciA9IE1hdGguc3FydChNYXRoLnBvdyhncmFkaWVudC54MSAtIGdyYWRpZW50LmN4LCAyKSArIE1hdGgucG93KGdyYWRpZW50LnkxIC0gZ3JhZGllbnQuY3ksIDIpKTsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgYmwgPSBNYXRoLnNxcnQoTWF0aC5wb3coZ3JhZGllbnQueDEgLSBncmFkaWVudC5jeCwgMikgKyBNYXRoLnBvdyhncmFkaWVudC5jeSwgMikpOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LnJ4ID0gZ3JhZGllbnQucnkgPSBNYXRoLm1heCh0bCwgdHIsIGJyLCBibCk7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdjbG9zZXN0LWNvcm5lcic6DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRsID0gTWF0aC5zcXJ0KE1hdGgucG93KGdyYWRpZW50LmN4LCAyKSArIE1hdGgucG93KGdyYWRpZW50LmN5LCAyKSk7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRyID0gTWF0aC5zcXJ0KE1hdGgucG93KGdyYWRpZW50LmN4LCAyKSArIE1hdGgucG93KGdyYWRpZW50LnkxIC0gZ3JhZGllbnQuY3ksIDIpKTsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgYnIgPSBNYXRoLnNxcnQoTWF0aC5wb3coZ3JhZGllbnQueDEgLSBncmFkaWVudC5jeCwgMikgKyBNYXRoLnBvdyhncmFkaWVudC55MSAtIGdyYWRpZW50LmN5LCAyKSk7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGJsID0gTWF0aC5zcXJ0KE1hdGgucG93KGdyYWRpZW50LngxIC0gZ3JhZGllbnQuY3gsIDIpICsgTWF0aC5wb3coZ3JhZGllbnQuY3ksIDIpKTsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBncmFkaWVudC5yeCA9IGdyYWRpZW50LnJ5ID0gTWF0aC5taW4odGwsIHRyLCBiciwgYmwpOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnZmFydGhlc3Qtc2lkZSc6DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYobTJbMF0gPT09ICdjaXJjbGUnKXsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQucnggPSBncmFkaWVudC5yeSA9IE1hdGgubWF4KA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQuY3gsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBncmFkaWVudC5jeSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LngxIC0gZ3JhZGllbnQuY3gsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBncmFkaWVudC55MSAtIGdyYWRpZW50LmN5DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsgLy8gZWxsaXBzZQ0KDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LnR5cGUgPSBtMlswXTsNCg0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBncmFkaWVudC5yeCA9IE1hdGgubWF4KA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQuY3gsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBncmFkaWVudC54MSAtIGdyYWRpZW50LmN4DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LnJ5ID0gTWF0aC5tYXgoDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBncmFkaWVudC5jeSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LnkxIC0gZ3JhZGllbnQuY3kNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKTsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdjbG9zZXN0LXNpZGUnOg0KICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnY29udGFpbic6IC8vIGlzIGVxdWl2YWxlbnQgdG8gY2xvc2VzdC1zaWRlDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYobTJbMF0gPT09ICdjaXJjbGUnKXsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQucnggPSBncmFkaWVudC5yeSA9IE1hdGgubWluKA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQuY3gsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBncmFkaWVudC5jeSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LngxIC0gZ3JhZGllbnQuY3gsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBncmFkaWVudC55MSAtIGdyYWRpZW50LmN5DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsgLy8gZWxsaXBzZQ0KDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LnR5cGUgPSBtMlswXTsNCg0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBncmFkaWVudC5yeCA9IE1hdGgubWluKA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQuY3gsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBncmFkaWVudC54MSAtIGdyYWRpZW50LmN4DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LnJ5ID0gTWF0aC5taW4oDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBncmFkaWVudC5jeSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LnkxIC0gZ3JhZGllbnQuY3kNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKTsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7DQoNCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFRPRE86IGFkZCBzdXBwb3J0IGZvciAiMzBweCA0MHB4IiBzaXplcyAod2Via2l0IG9ubHkpDQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9DQoNCiAgICAgICAgICAgICAgICAvLyBjb2xvciBzdG9wcw0KICAgICAgICAgICAgICAgIG0yID0gbTFbNV0ubWF0Y2goLygoPzpyZ2J8cmdiYSlcKFxkezEsM30sXHNcZHsxLDN9LFxzXGR7MSwzfSg/Oixcc1swLTlcLl0rKT9cKSg/OlxzXGR7MSwzfSg/OiV8cHgpKT8pKy9nKTsNCiAgICAgICAgICAgICAgICBpZihtMil7DQogICAgICAgICAgICAgICAgICAgIG0yTGVuID0gbTIubGVuZ3RoOw0KICAgICAgICAgICAgICAgICAgICBzdGVwID0gMSAvIE1hdGgubWF4KG0yTGVuIC0gMSwgMSk7DQogICAgICAgICAgICAgICAgICAgIGZvcihpID0gMDsgaSA8IG0yTGVuOyBpKz0xKXsNCiAgICAgICAgICAgICAgICAgICAgICAgIG0zID0gbTJbaV0ubWF0Y2goLygoPzpyZ2J8cmdiYSlcKFxkezEsM30sXHNcZHsxLDN9LFxzXGR7MSwzfSg/Oixcc1swLTlcLl0rKT9cKSlccyooXGR7MSwzfSk/KCV8cHgpPy8pOw0KICAgICAgICAgICAgICAgICAgICAgICAgaWYobTNbMl0pew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0b3AgPSBwYXJzZUZsb2F0KG0zWzJdKTsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihtM1szXSA9PT0gJyUnKXsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RvcCAvPSAxMDA7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsgLy8gcHggLSBzdHVwaWQgb3BlcmENCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RvcCAvPSBib3VuZHMud2lkdGg7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdG9wID0gaSAqIHN0ZXA7DQogICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgICAgICBncmFkaWVudC5jb2xvclN0b3BzLnB1c2goew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yOiBtM1sxXSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdG9wOiBzdG9wDQogICAgICAgICAgICAgICAgICAgICAgICB9KTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgfQ0KICAgIH0NCg0KICAgIHJldHVybiBncmFkaWVudDsNCn07DQoNCl9odG1sMmNhbnZhcy5HZW5lcmF0ZS5HcmFkaWVudCA9IGZ1bmN0aW9uKHNyYywgYm91bmRzKSB7DQogICAgdmFyIGNhbnZhcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpLA0KICAgIGN0eCA9IGNhbnZhcy5nZXRDb250ZXh0KCcyZCcpLA0KICAgIGdyYWRpZW50LCBncmFkLCBpLCBsZW4sIGltZzsNCg0KICAgIGNhbnZhcy53aWR0aCA9IGJvdW5kcy53aWR0aDsNCiAgICBjYW52YXMuaGVpZ2h0ID0gYm91bmRzLmhlaWdodDsNCg0KICAgIC8vIFRPRE86IGFkZCBzdXBwb3J0IGZvciBtdWx0aSBkZWZpbmVkIGJhY2tncm91bmQgZ3JhZGllbnRzIChsaWtlIHJhZGlhbCBncmFkaWVudCBleGFtcGxlIGluIGJhY2tncm91bmQuaHRtbCkNCiAgICBncmFkaWVudCA9IF9odG1sMmNhbnZhcy5HZW5lcmF0ZS5wYXJzZUdyYWRpZW50KHNyYywgYm91bmRzKTsNCg0KICAgIGltZyA9IG5ldyBJbWFnZSgpOw0KDQogICAgaWYoZ3JhZGllbnQpew0KICAgICAgICBpZihncmFkaWVudC50eXBlID09PSAnbGluZWFyJyl7DQogICAgICAgICAgICBncmFkID0gY3R4LmNyZWF0ZUxpbmVhckdyYWRpZW50KGdyYWRpZW50LngwLCBncmFkaWVudC55MCwgZ3JhZGllbnQueDEsIGdyYWRpZW50LnkxKTsNCg0KICAgICAgICAgICAgZm9yIChpID0gMCwgbGVuID0gZ3JhZGllbnQuY29sb3JTdG9wcy5sZW5ndGg7IGkgPCBsZW47IGkrPTEpIHsNCiAgICAgICAgICAgICAgICB0cnkgew0KICAgICAgICAgICAgICAgICAgICBncmFkLmFkZENvbG9yU3RvcChncmFkaWVudC5jb2xvclN0b3BzW2ldLnN0b3AsIGdyYWRpZW50LmNvbG9yU3RvcHNbaV0uY29sb3IpOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICBjYXRjaChlKSB7DQogICAgICAgICAgICAgICAgICAgIGgyY2xvZyhbJ2ZhaWxlZCB0byBhZGQgY29sb3Igc3RvcDogJywgZSwgJzsgdHJpZWQgdG8gYWRkOiAnLCBncmFkaWVudC5jb2xvclN0b3BzW2ldLCAnOyBzdG9wOiAnLCBpLCAnOyBpbjogJywgc3JjXSk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gZ3JhZDsNCiAgICAgICAgICAgIGN0eC5maWxsUmVjdCgwLCAwLCBib3VuZHMud2lkdGgsIGJvdW5kcy5oZWlnaHQpOw0KDQogICAgICAgICAgICBpbWcuc3JjID0gY2FudmFzLnRvRGF0YVVSTCgpOw0KICAgICAgICB9IGVsc2UgaWYoZ3JhZGllbnQudHlwZSA9PT0gJ2NpcmNsZScpew0KDQogICAgICAgICAgICBncmFkID0gY3R4LmNyZWF0ZVJhZGlhbEdyYWRpZW50KGdyYWRpZW50LmN4LCBncmFkaWVudC5jeSwgMCwgZ3JhZGllbnQuY3gsIGdyYWRpZW50LmN5LCBncmFkaWVudC5yeCk7DQoNCiAgICAgICAgICAgIGZvciAoaSA9IDAsIGxlbiA9IGdyYWRpZW50LmNvbG9yU3RvcHMubGVuZ3RoOyBpIDwgbGVuOyBpKz0xKSB7DQogICAgICAgICAgICAgICAgdHJ5IHsNCiAgICAgICAgICAgICAgICAgICAgZ3JhZC5hZGRDb2xvclN0b3AoZ3JhZGllbnQuY29sb3JTdG9wc1tpXS5zdG9wLCBncmFkaWVudC5jb2xvclN0b3BzW2ldLmNvbG9yKTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgY2F0Y2goZSkgew0KICAgICAgICAgICAgICAgICAgICBoMmNsb2coWydmYWlsZWQgdG8gYWRkIGNvbG9yIHN0b3A6ICcsIGUsICc7IHRyaWVkIHRvIGFkZDogJywgZ3JhZGllbnQuY29sb3JTdG9wc1tpXSwgJzsgc3RvcDogJywgaSwgJzsgaW46ICcsIHNyY10pOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgY3R4LmZpbGxTdHlsZSA9IGdyYWQ7DQogICAgICAgICAgICBjdHguZmlsbFJlY3QoMCwgMCwgYm91bmRzLndpZHRoLCBib3VuZHMuaGVpZ2h0KTsNCg0KICAgICAgICAgICAgaW1nLnNyYyA9IGNhbnZhcy50b0RhdGFVUkwoKTsNCiAgICAgICAgfSBlbHNlIGlmKGdyYWRpZW50LnR5cGUgPT09ICdlbGxpcHNlJyl7DQoNCiAgICAgICAgICAgIC8vIGRyYXcgY2lyY2xlDQogICAgICAgICAgICB2YXIgY2FudmFzUmFkaWFsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyksDQogICAgICAgICAgICAgICAgY3R4UmFkaWFsID0gY2FudmFzUmFkaWFsLmdldENvbnRleHQoJzJkJyksDQogICAgICAgICAgICAgICAgcmkgPSBNYXRoLm1heChncmFkaWVudC5yeCwgZ3JhZGllbnQucnkpLA0KICAgICAgICAgICAgICAgIGRpID0gcmkgKiAyLCBpbWdSYWRpYWw7DQoNCiAgICAgICAgICAgIGNhbnZhc1JhZGlhbC53aWR0aCA9IGNhbnZhc1JhZGlhbC5oZWlnaHQgPSBkaTsNCg0KICAgICAgICAgICAgZ3JhZCA9IGN0eFJhZGlhbC5jcmVhdGVSYWRpYWxHcmFkaWVudChncmFkaWVudC5yeCwgZ3JhZGllbnQucnksIDAsIGdyYWRpZW50LnJ4LCBncmFkaWVudC5yeSwgcmkpOw0KDQogICAgICAgICAgICBmb3IgKGkgPSAwLCBsZW4gPSBncmFkaWVudC5jb2xvclN0b3BzLmxlbmd0aDsgaSA8IGxlbjsgaSs9MSkgew0KICAgICAgICAgICAgICAgIHRyeSB7DQogICAgICAgICAgICAgICAgICAgIGdyYWQuYWRkQ29sb3JTdG9wKGdyYWRpZW50LmNvbG9yU3RvcHNbaV0uc3RvcCwgZ3JhZGllbnQuY29sb3JTdG9wc1tpXS5jb2xvcik7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIGNhdGNoKGUpIHsNCiAgICAgICAgICAgICAgICAgICAgaDJjbG9nKFsnZmFpbGVkIHRvIGFkZCBjb2xvciBzdG9wOiAnLCBlLCAnOyB0cmllZCB0byBhZGQ6ICcsIGdyYWRpZW50LmNvbG9yU3RvcHNbaV0sICc7IHN0b3A6ICcsIGksICc7IGluOiAnLCBzcmNdKTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIGN0eFJhZGlhbC5maWxsU3R5bGUgPSBncmFkOw0KICAgICAgICAgICAgY3R4UmFkaWFsLmZpbGxSZWN0KDAsIDAsIGRpLCBkaSk7DQoNCiAgICAgICAgICAgIGN0eC5maWxsU3R5bGUgPSBncmFkaWVudC5jb2xvclN0b3BzW2kgLSAxXS5jb2xvcjsNCiAgICAgICAgICAgIGN0eC5maWxsUmVjdCgwLCAwLCBjYW52YXMud2lkdGgsIGNhbnZhcy5oZWlnaHQpOw0KDQogICAgICAgICAgICBpbWdSYWRpYWwgPSBuZXcgSW1hZ2UoKTsNCiAgICAgICAgICAgIGltZ1JhZGlhbC5vbmxvYWQgPSBmdW5jdGlvbigpIHsgLy8gd2FpdCB1bnRpbCB0aGUgaW1hZ2UgaXMgZmlsbGVkDQoNCiAgICAgICAgICAgICAgICAvLyB0cmFuc2Zvcm0gY2lyY2xlIHRvIGVsbGlwc2UNCiAgICAgICAgICAgICAgICBjdHguZHJhd0ltYWdlKGltZ1JhZGlhbCwgZ3JhZGllbnQuY3ggLSBncmFkaWVudC5yeCwgZ3JhZGllbnQuY3kgLSBncmFkaWVudC5yeSwgMiAqIGdyYWRpZW50LnJ4LCAyICogZ3JhZGllbnQucnkpOw0KDQogICAgICAgICAgICAgICAgaW1nLnNyYyA9IGNhbnZhcy50b0RhdGFVUkwoKTsNCg0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgaW1nUmFkaWFsLnNyYyA9IGNhbnZhc1JhZGlhbC50b0RhdGFVUkwoKTsNCiAgICAgICAgfQ0KICAgIH0NCg0KICAgIHJldHVybiBpbWc7DQp9Ow0KDQpfaHRtbDJjYW52YXMuR2VuZXJhdGUuTGlzdEFscGhhID0gZnVuY3Rpb24obnVtYmVyKSB7DQogICAgdmFyIHRtcCA9ICIiLA0KICAgIG1vZHVsdXM7DQoNCiAgICBkbyB7DQogICAgICAgIG1vZHVsdXMgPSBudW1iZXIgJSAyNjsNCiAgICAgICAgdG1wID0gU3RyaW5nLmZyb21DaGFyQ29kZSgobW9kdWx1cykgKyA2NCkgKyB0bXA7DQogICAgICAgIG51bWJlciA9IG51bWJlciAvIDI2Ow0KICAgIH13aGlsZSgobnVtYmVyKjI2KSA+IDI2KTsNCg0KICAgIHJldHVybiB0bXA7DQp9Ow0KDQpfaHRtbDJjYW52YXMuR2VuZXJhdGUuTGlzdFJvbWFuID0gZnVuY3Rpb24obnVtYmVyKSB7DQogICAgdmFyIHJvbWFuQXJyYXkgPSBbIk0iLCAiQ00iLCAiRCIsICJDRCIsICJDIiwgIlhDIiwgIkwiLCAiWEwiLCAiWCIsICJJWCIsICJWIiwgIklWIiwgIkkiXSwNCiAgICBkZWNpbWFsID0gWzEwMDAsIDkwMCwgNTAwLCA0MDAsIDEwMCwgOTAsIDUwLCA0MCwgMTAsIDksIDUsIDQsIDFdLA0KICAgIHJvbWFuID0gIiIsDQogICAgdiwNCiAgICBsZW4gPSByb21hbkFycmF5Lmxlbmd0aDsNCg0KICAgIGlmIChudW1iZXIgPD0gMCB8fCBudW1iZXIgPj0gNDAwMCkgew0KICAgICAgICByZXR1cm4gbnVtYmVyOw0KICAgIH0NCg0KICAgIGZvciAodj0wOyB2IDwgbGVuOyB2Kz0xKSB7DQogICAgICAgIHdoaWxlIChudW1iZXIgPj0gZGVjaW1hbFt2XSkgew0KICAgICAgICAgICAgbnVtYmVyIC09IGRlY2ltYWxbdl07DQogICAgICAgICAgICByb21hbiArPSByb21hbkFycmF5W3ZdOw0KICAgICAgICB9DQogICAgfQ0KDQogICAgcmV0dXJuIHJvbWFuOw0KDQp9Ow0KDQp9KSgpOw0KLyoNCiAgaHRtbDJjYW52YXMgdjAuMzQgPGh0dHA6Ly9odG1sMmNhbnZhcy5oZXJ0emVuLmNvbT4NCiAgQ29weXJpZ2h0IChjKSAyMDExIE5pa2xhcyB2b24gSGVydHplbi4gQWxsIHJpZ2h0cyByZXNlcnZlZC4NCiAgaHR0cDovL3d3dy50d2l0dGVyLmNvbS9uaWtsYXN2aA0KDQogIFJlbGVhc2VkIHVuZGVyIE1JVCBMaWNlbnNlDQoqLw0KDQovKg0KICogIE5ldyBmdW5jdGlvbiBmb3IgdHJhdmVyc2luZyBlbGVtZW50cw0KICovDQoNCl9odG1sMmNhbnZhcy5QYXJzZSA9IGZ1bmN0aW9uICggaW1hZ2VzLCBvcHRpb25zICkgew0KDQogICAgdmFyIHN1cHBvcnQgPSB7DQogICAgICAgIHJhbmdlQm91bmRzOiBmYWxzZSwNCiAgICAgICAgc3ZnUmVuZGVyaW5nOiBvcHRpb25zLnN2Z1JlbmRlcmluZyAmJiAoZnVuY3Rpb24oICl7DQogICAgICAgICAgICB2YXIgaW1nID0gbmV3IEltYWdlKCksDQogICAgICAgICAgICBjYW52YXMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJjYW52YXMiKSwNCiAgICAgICAgICAgIGN0eCA9IChjYW52YXMuZ2V0Q29udGV4dCA9PT0gdW5kZWZpbmVkKSA/IGZhbHNlIDogY2FudmFzLmdldENvbnRleHQoIjJkIik7DQogICAgICAgICAgICBpZiAoY3R4ID09PSBmYWxzZSkgew0KICAgICAgICAgICAgICAgIC8vIGJyb3dzZXIgZG9lc24ndCBzdXBwb3J0IGNhbnZhcywgZ29vZCBsdWNrIHN1cHBvcnRpbmcgU1ZHIG9uIGNhbnZhcw0KICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGNhbnZhcy53aWR0aCA9IGNhbnZhcy5oZWlnaHQgPSAxMDsNCiAgICAgICAgICAgIGltZy5zcmMgPSBbDQogICAgICAgICAgICAiZGF0YTppbWFnZS9zdmcreG1sLCIsDQogICAgICAgICAgICAiPHN2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHdpZHRoPScxMCcgaGVpZ2h0PScxMCc+IiwNCiAgICAgICAgICAgICI8Zm9yZWlnbk9iamVjdCB3aWR0aD0nMTAnIGhlaWdodD0nMTAnPiIsDQogICAgICAgICAgICAiPGRpdiB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMTk5OS94aHRtbCcgc3R5bGU9J3dpZHRoOjEwO2hlaWdodDoxMDsnPiIsDQogICAgICAgICAgICAic3VwIiwNCiAgICAgICAgICAgICI8L2Rpdj4iLA0KICAgICAgICAgICAgIjwvZm9yZWlnbk9iamVjdD4iLA0KICAgICAgICAgICAgIjwvc3ZnPiINCiAgICAgICAgICAgIF0uam9pbigiIik7DQogICAgICAgICAgICB0cnkgew0KICAgICAgICAgICAgICAgIGN0eC5kcmF3SW1hZ2UoaW1nLCAwLCAwKTsNCiAgICAgICAgICAgICAgICBjYW52YXMudG9EYXRhVVJMKCk7DQogICAgICAgICAgICB9IGNhdGNoKGUpIHsNCiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBoMmNsb2coJ2h0bWwyY2FudmFzOiBQYXJzZTogU1ZHIHBvd2VyZWQgcmVuZGVyaW5nIGF2YWlsYWJsZScpOw0KICAgICAgICAgICAgcmV0dXJuIHRydWU7DQoNCiAgICAgICAgfSkoKQ0KICAgIH0sDQogICAgZWxlbWVudCA9ICgoIG9wdGlvbnMuZWxlbWVudHMgPT09IHVuZGVmaW5lZCApID8gZG9jdW1lbnQuYm9keSA6IG9wdGlvbnMuZWxlbWVudHNbMF0pLCAvLyBzZWxlY3QgYm9keSBieSBkZWZhdWx0DQogICAgbmVlZFJlb3JkZXIgPSBmYWxzZSwNCiAgICBudW1EcmF3cyA9IDAsDQogICAgZm9udERhdGEgPSB7fSwNCiAgICBkb2MgPSBlbGVtZW50Lm93bmVyRG9jdW1lbnQsDQogICAgaWdub3JlRWxlbWVudHNSZWdFeHAgPSBuZXcgUmVnRXhwKCIoIiArIG9wdGlvbnMuaWdub3JlRWxlbWVudHMgKyAiKSIpLA0KICAgIGJvZHkgPSBkb2MuYm9keSwNCiAgICByLA0KICAgIHRlc3RFbGVtZW50LA0KICAgIHJhbmdlQm91bmRzLA0KICAgIHJhbmdlSGVpZ2h0LA0KICAgIHN0YWNrLA0KICAgIGN0eCwNCiAgICBkb2NEaW0sDQogICAgaSwNCiAgICBjaGlsZHJlbiwNCiAgICBjaGlsZHJlbkxlbjsNCg0KDQogICAgZnVuY3Rpb24gZG9jU2l6ZSgpew0KDQogICAgICAgIHJldHVybiB7DQogICAgICAgICAgICB3aWR0aDogTWF0aC5tYXgoDQogICAgICAgICAgICAgICAgTWF0aC5tYXgoZG9jLmJvZHkuc2Nyb2xsV2lkdGgsIGRvYy5kb2N1bWVudEVsZW1lbnQuc2Nyb2xsV2lkdGgpLA0KICAgICAgICAgICAgICAgIE1hdGgubWF4KGRvYy5ib2R5Lm9mZnNldFdpZHRoLCBkb2MuZG9jdW1lbnRFbGVtZW50Lm9mZnNldFdpZHRoKSwNCiAgICAgICAgICAgICAgICBNYXRoLm1heChkb2MuYm9keS5jbGllbnRXaWR0aCwgZG9jLmRvY3VtZW50RWxlbWVudC5jbGllbnRXaWR0aCkNCiAgICAgICAgICAgICAgICApLA0KICAgICAgICAgICAgaGVpZ2h0OiBNYXRoLm1heCgNCiAgICAgICAgICAgICAgICBNYXRoLm1heChkb2MuYm9keS5zY3JvbGxIZWlnaHQsIGRvYy5kb2N1bWVudEVsZW1lbnQuc2Nyb2xsSGVpZ2h0KSwNCiAgICAgICAgICAgICAgICBNYXRoLm1heChkb2MuYm9keS5vZmZzZXRIZWlnaHQsIGRvYy5kb2N1bWVudEVsZW1lbnQub2Zmc2V0SGVpZ2h0KSwNCiAgICAgICAgICAgICAgICBNYXRoLm1heChkb2MuYm9keS5jbGllbnRIZWlnaHQsIGRvYy5kb2N1bWVudEVsZW1lbnQuY2xpZW50SGVpZ2h0KQ0KICAgICAgICAgICAgICAgICkNCiAgICAgICAgfTsNCg0KICAgIH0NCg0KICAgIGltYWdlcyA9IGltYWdlcyB8fCB7fTsNCg0KICAgIC8vIFRlc3Qgd2hldGhlciB3ZSBjYW4gdXNlIHJhbmdlcyB0byBtZWFzdXJlIGJvdW5kaW5nIGJveGVzDQogICAgLy8gT3BlcmEgZG9lc24ndCBwcm92aWRlIHZhbGlkIGJvdW5kcy5oZWlnaHQvYm90dG9tIGV2ZW4gdGhvdWdoIGl0IHN1cHBvcnRzIHRoZSBtZXRob2QuDQoNCg0KICAgIGlmIChkb2MuY3JlYXRlUmFuZ2UpIHsNCiAgICAgICAgciA9IGRvYy5jcmVhdGVSYW5nZSgpOw0KICAgICAgICAvL3RoaXMuc3VwcG9ydC5yYW5nZUJvdW5kcyA9IG5ldyBCb29sZWFuKHIuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KTsNCiAgICAgICAgaWYgKHIuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KXsNCiAgICAgICAgICAgIHRlc3RFbGVtZW50ID0gZG9jLmNyZWF0ZUVsZW1lbnQoJ2JvdW5kdGVzdCcpOw0KICAgICAgICAgICAgdGVzdEVsZW1lbnQuc3R5bGUuaGVpZ2h0ID0gIjEyM3B4IjsNCiAgICAgICAgICAgIHRlc3RFbGVtZW50LnN0eWxlLmRpc3BsYXkgPSAiYmxvY2siOw0KICAgICAgICAgICAgYm9keS5hcHBlbmRDaGlsZCh0ZXN0RWxlbWVudCk7DQoNCiAgICAgICAgICAgIHIuc2VsZWN0Tm9kZSh0ZXN0RWxlbWVudCk7DQogICAgICAgICAgICByYW5nZUJvdW5kcyA9IHIuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7DQogICAgICAgICAgICByYW5nZUhlaWdodCA9IHJhbmdlQm91bmRzLmhlaWdodDsNCg0KICAgICAgICAgICAgaWYgKHJhbmdlSGVpZ2h0ID09PSAxMjMpIHsNCiAgICAgICAgICAgICAgICBzdXBwb3J0LnJhbmdlQm91bmRzID0gdHJ1ZTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGJvZHkucmVtb3ZlQ2hpbGQodGVzdEVsZW1lbnQpOw0KDQoNCiAgICAgICAgfQ0KDQogICAgfQ0KDQoNCiAgICAvKg0KICAgIHZhciByb290U3RhY2sgPSBuZXcgdGhpcy5zdG9yYWdlQ29udGV4dCgkKGRvY3VtZW50KS53aWR0aCgpLCQoZG9jdW1lbnQpLmhlaWdodCgpKTsNCiAgICByb290U3RhY2sub3BhY2l0eSA9IHRoaXMuZ2V0Q1NTKHRoaXMuZWxlbWVudCwib3BhY2l0eSIpOw0KICAgIHZhciBzdGFjayA9IHRoaXMubmV3RWxlbWVudCh0aGlzLmVsZW1lbnQscm9vdFN0YWNrKTsNCg0KDQogICAgdGhpcy5wYXJzZUVsZW1lbnQodGhpcy5lbGVtZW50LHN0YWNrKTsNCiAgICAgKi8NCg0KDQoNCg0KICAgIHZhciBnZXRDU1MgPSBfaHRtbDJjYW52YXMuVXRpbC5nZXRDU1M7DQogICAgZnVuY3Rpb24gZ2V0Q1NTSW50KGVsZW1lbnQsIGF0dHJpYnV0ZSkgew0KICAgICAgICB2YXIgdmFsID0gcGFyc2VJbnQoZ2V0Q1NTKGVsZW1lbnQsIGF0dHJpYnV0ZSksIDEwKTsNCiAgICAgICAgcmV0dXJuIChpc05hTih2YWwpKSA/IDAgOiB2YWw7IC8vIGJvcmRlcnMgaW4gb2xkIElFIGFyZSB0aHJvd2luZyAnbWVkaXVtJyBmb3IgZGVtby5odG1sDQogICAgfQ0KDQogICAgLy8gRHJhd2luZyBhIHJlY3RhbmdsZQ0KICAgIGZ1bmN0aW9uIHJlbmRlclJlY3QgKGN0eCwgeCwgeSwgdywgaCwgYmdjb2xvcikgew0KICAgICAgICBpZiAoYmdjb2xvciAhPT0idHJhbnNwYXJlbnQiKXsNCiAgICAgICAgICAgIGN0eC5zZXRWYXJpYWJsZSgiZmlsbFN0eWxlIiwgYmdjb2xvcik7DQogICAgICAgICAgICBjdHguZmlsbFJlY3QgKHgsIHksIHcsIGgpOw0KICAgICAgICAgICAgbnVtRHJhd3MrPTE7DQogICAgICAgIH0NCiAgICB9DQoNCg0KICAgIGZ1bmN0aW9uIHRleHRUcmFuc2Zvcm0gKHRleHQsIHRyYW5zZm9ybSkgew0KICAgICAgICBzd2l0Y2godHJhbnNmb3JtKXsNCiAgICAgICAgICAgIGNhc2UgImxvd2VyY2FzZSI6DQogICAgICAgICAgICAgICAgcmV0dXJuIHRleHQudG9Mb3dlckNhc2UoKTsNCg0KICAgICAgICAgICAgY2FzZSAiY2FwaXRhbGl6ZSI6DQogICAgICAgICAgICAgICAgcmV0dXJuIHRleHQucmVwbGFjZSggLyhefFxzfDp8LXxcKHxcKSkoW2Etel0pL2cgLCBmdW5jdGlvbiAobSwgcDEsIHAyKSB7DQogICAgICAgICAgICAgICAgICAgIGlmIChtLmxlbmd0aCA+IDApIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBwMSArIHAyLnRvVXBwZXJDYXNlKCk7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9ICk7DQoNCiAgICAgICAgICAgIGNhc2UgInVwcGVyY2FzZSI6DQogICAgICAgICAgICAgICAgcmV0dXJuIHRleHQudG9VcHBlckNhc2UoKTsNCg0KICAgICAgICAgICAgZGVmYXVsdDoNCiAgICAgICAgICAgICAgICByZXR1cm4gdGV4dDsNCg0KICAgICAgICB9DQoNCiAgICB9DQoNCiAgICBmdW5jdGlvbiB0cmltVGV4dCAodGV4dCkgew0KICAgICAgICByZXR1cm4gdGV4dC5yZXBsYWNlKC9eXHMqL2csICIiKS5yZXBsYWNlKC9ccyokL2csICIiKTsNCiAgICB9DQoNCiAgICBmdW5jdGlvbiBmb250TWV0cmljcyAoZm9udCwgZm9udFNpemUpIHsNCg0KICAgICAgICBpZiAoZm9udERhdGFbZm9udCArICItIiArIGZvbnRTaXplXSAhPT0gdW5kZWZpbmVkKSB7DQogICAgICAgICAgICByZXR1cm4gZm9udERhdGFbZm9udCArICItIiArIGZvbnRTaXplXTsNCiAgICAgICAgfQ0KDQoNCiAgICAgICAgdmFyIGNvbnRhaW5lciA9IGRvYy5jcmVhdGVFbGVtZW50KCdkaXYnKSwNCiAgICAgICAgaW1nID0gZG9jLmNyZWF0ZUVsZW1lbnQoJ2ltZycpLA0KICAgICAgICBzcGFuID0gZG9jLmNyZWF0ZUVsZW1lbnQoJ3NwYW4nKSwNCiAgICAgICAgYmFzZWxpbmUsDQogICAgICAgIG1pZGRsZSwNCiAgICAgICAgbWV0cmljc09iajsNCg0KDQogICAgICAgIGNvbnRhaW5lci5zdHlsZS52aXNpYmlsaXR5ID0gImhpZGRlbiI7DQogICAgICAgIGNvbnRhaW5lci5zdHlsZS5mb250RmFtaWx5ID0gZm9udDsNCiAgICAgICAgY29udGFpbmVyLnN0eWxlLmZvbnRTaXplID0gZm9udFNpemU7DQogICAgICAgIGNvbnRhaW5lci5zdHlsZS5tYXJnaW4gPSAwOw0KICAgICAgICBjb250YWluZXIuc3R5bGUucGFkZGluZyA9IDA7DQoNCiAgICAgICAgYm9keS5hcHBlbmRDaGlsZChjb250YWluZXIpOw0KDQoNCg0KICAgICAgICAvLyBodHRwOi8vcHJvYmFibHlwcm9ncmFtbWluZy5jb20vMjAwOS8wMy8xNS90aGUtdGluaWVzdC1naWYtZXZlciAoaGFuZHRpbnl3aGl0ZS5naWYpDQogICAgICAgIGltZy5zcmMgPSAiZGF0YTppbWFnZS9naWY7YmFzZTY0LFIwbEdPRGxoQVFBQkFJQUJBUC8vL3dBQUFDd0FBQUFBQVFBQkFBQUNBa1FCQURzPSI7DQogICAgICAgIGltZy53aWR0aCA9IDE7DQogICAgICAgIGltZy5oZWlnaHQgPSAxOw0KDQogICAgICAgIGltZy5zdHlsZS5tYXJnaW4gPSAwOw0KICAgICAgICBpbWcuc3R5bGUucGFkZGluZyA9IDA7DQogICAgICAgIGltZy5zdHlsZS52ZXJ0aWNhbEFsaWduID0gImJhc2VsaW5lIjsNCg0KICAgICAgICBzcGFuLnN0eWxlLmZvbnRGYW1pbHkgPSBmb250Ow0KICAgICAgICBzcGFuLnN0eWxlLmZvbnRTaXplID0gZm9udFNpemU7DQogICAgICAgIHNwYW4uc3R5bGUubWFyZ2luID0gMDsNCiAgICAgICAgc3Bhbi5zdHlsZS5wYWRkaW5nID0gMDsNCg0KDQoNCg0KICAgICAgICBzcGFuLmFwcGVuZENoaWxkKGRvYy5jcmVhdGVUZXh0Tm9kZSgnSGlkZGVuIFRleHQnKSk7DQogICAgICAgIGNvbnRhaW5lci5hcHBlbmRDaGlsZChzcGFuKTsNCiAgICAgICAgY29udGFpbmVyLmFwcGVuZENoaWxkKGltZyk7DQogICAgICAgIGJhc2VsaW5lID0gKGltZy5vZmZzZXRUb3AgLSBzcGFuLm9mZnNldFRvcCkgKyAxOw0KDQogICAgICAgIGNvbnRhaW5lci5yZW1vdmVDaGlsZChzcGFuKTsNCiAgICAgICAgY29udGFpbmVyLmFwcGVuZENoaWxkKGRvYy5jcmVhdGVUZXh0Tm9kZSgnSGlkZGVuIFRleHQnKSk7DQoNCiAgICAgICAgY29udGFpbmVyLnN0eWxlLmxpbmVIZWlnaHQgPSAibm9ybWFsIjsNCiAgICAgICAgaW1nLnN0eWxlLnZlcnRpY2FsQWxpZ24gPSAic3VwZXIiOw0KDQogICAgICAgIG1pZGRsZSA9IChpbWcub2Zmc2V0VG9wLWNvbnRhaW5lci5vZmZzZXRUb3ApICsgMTsNCiAgICAgICAgbWV0cmljc09iaiA9IHsNCiAgICAgICAgICAgIGJhc2VsaW5lOiBiYXNlbGluZSwNCiAgICAgICAgICAgIGxpbmVXaWR0aDogMSwNCiAgICAgICAgICAgIG1pZGRsZTogbWlkZGxlDQogICAgICAgIH07DQoNCg0KICAgICAgICBmb250RGF0YVtmb250ICsgIi0iICsgZm9udFNpemVdID0gbWV0cmljc09iajsNCg0KICAgICAgICBib2R5LnJlbW92ZUNoaWxkKGNvbnRhaW5lcik7DQoNCiAgICAgICAgcmV0dXJuIG1ldHJpY3NPYmo7DQoNCiAgICB9DQoNCg0KICAgIGZ1bmN0aW9uIGRyYXdUZXh0KGN1cnJlbnRUZXh0LCB4LCB5LCBjdHgpew0KICAgICAgICBpZiAodHJpbVRleHQoY3VycmVudFRleHQpLmxlbmd0aD4wKSB7DQogICAgICAgICAgICBjdHguZmlsbFRleHQoY3VycmVudFRleHQseCx5KTsNCiAgICAgICAgICAgIG51bURyYXdzKz0xOw0KICAgICAgICB9DQogICAgfQ0KDQoNCiAgICBmdW5jdGlvbiByZW5kZXJUZXh0KGVsLCB0ZXh0Tm9kZSwgc3RhY2spIHsNCiAgICAgICAgdmFyIGN0eCA9IHN0YWNrLmN0eCwNCiAgICAgICAgZmFtaWx5ID0gZ2V0Q1NTKGVsLCAiZm9udEZhbWlseSIpLA0KICAgICAgICBzaXplID0gZ2V0Q1NTKGVsLCAiZm9udFNpemUiKSwNCiAgICAgICAgY29sb3IgPSBnZXRDU1MoZWwsICJjb2xvciIpLA0KICAgICAgICB0ZXh0X2RlY29yYXRpb24gPSBnZXRDU1MoZWwsICJ0ZXh0RGVjb3JhdGlvbiIpLA0KICAgICAgICB0ZXh0X2FsaWduID0gZ2V0Q1NTKGVsLCAidGV4dEFsaWduIiksDQogICAgICAgIGxldHRlcl9zcGFjaW5nID0gZ2V0Q1NTKGVsLCAibGV0dGVyU3BhY2luZyIpLA0KICAgICAgICBib3VuZHMsDQogICAgICAgIHRleHQsDQogICAgICAgIG1ldHJpY3MsDQogICAgICAgIHJlbmRlckxpc3QsDQogICAgICAgIGxpc3RMZW4sDQogICAgICAgIGJvbGQgPSBnZXRDU1MoZWwsICJmb250V2VpZ2h0IiksDQogICAgICAgIGZvbnRfc3R5bGUgPSBnZXRDU1MoZWwsICJmb250U3R5bGUiKSwNCiAgICAgICAgZm9udF92YXJpYW50ID0gZ2V0Q1NTKGVsLCAiZm9udFZhcmlhbnQiKSwNCiAgICAgICAgYWxpZ24gPSBmYWxzZSwNCiAgICAgICAgbmV3VGV4dE5vZGUsDQogICAgICAgIHRleHRWYWx1ZSwNCiAgICAgICAgdGV4dE9mZnNldCA9IDAsDQogICAgICAgIG9sZFRleHROb2RlLA0KICAgICAgICBjLA0KICAgICAgICByYW5nZSwNCiAgICAgICAgcGFyZW50LA0KICAgICAgICB3cmFwRWxlbWVudCwNCiAgICAgICAgYmFja3VwVGV4dDsNCg0KICAgICAgICAvLyBhcHBseSB0ZXh0LXRyYW5zZm9ybTphdGlvbiB0byB0aGUgdGV4dA0KDQoNCg0KICAgICAgICB0ZXh0Tm9kZS5ub2RlVmFsdWUgPSB0ZXh0VHJhbnNmb3JtKHRleHROb2RlLm5vZGVWYWx1ZSwgZ2V0Q1NTKGVsLCAidGV4dFRyYW5zZm9ybSIpKTsNCiAgICAgICAgdGV4dCA9IHRyaW1UZXh0KHRleHROb2RlLm5vZGVWYWx1ZSk7DQoNCiAgICAgICAgaWYgKHRleHQubGVuZ3RoPjApew0KDQogICAgICAgICAgICBpZiAodGV4dF9kZWNvcmF0aW9uICE9PSAibm9uZSIpew0KICAgICAgICAgICAgICAgIG1ldHJpY3MgPSBmb250TWV0cmljcyhmYW1pbHksIHNpemUpOw0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICB0ZXh0X2FsaWduID0gdGV4dF9hbGlnbi5yZXBsYWNlKFsiLXdlYmtpdC1hdXRvIl0sWyJhdXRvIl0pOw0KDQogICAgICAgICAgICBpZiAob3B0aW9ucy5sZXR0ZXJSZW5kZXJpbmcgPT09IGZhbHNlICYmIC9eKGxlZnR8cmlnaHR8anVzdGlmeXxhdXRvKSQvLnRlc3QodGV4dF9hbGlnbikgJiYgL14obm9ybWFsfG5vbmUpJC8udGVzdChsZXR0ZXJfc3BhY2luZykpew0KICAgICAgICAgICAgICAgIC8vIHRoaXMuc2V0Q29udGV4dFZhcmlhYmxlKGN0eCwidGV4dEFsaWduIix0ZXh0X2FsaWduKTsNCiAgICAgICAgICAgICAgICByZW5kZXJMaXN0ID0gdGV4dE5vZGUubm9kZVZhbHVlLnNwbGl0KC8oXGJ8ICkvKTsNCg0KICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgLy8gIHRoaXMuc2V0Q29udGV4dFZhcmlhYmxlKGN0eCwidGV4dEFsaWduIiwibGVmdCIpOw0KICAgICAgICAgICAgICAgIHJlbmRlckxpc3QgPSB0ZXh0Tm9kZS5ub2RlVmFsdWUuc3BsaXQoIiIpOw0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICBzd2l0Y2gocGFyc2VJbnQoYm9sZCwgMTApKXsNCiAgICAgICAgICAgICAgICBjYXNlIDQwMToNCiAgICAgICAgICAgICAgICAgICAgYm9sZCA9ICJib2xkIjsNCiAgICAgICAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICAgICAgY2FzZSA0MDA6DQogICAgICAgICAgICAgICAgICAgIGJvbGQgPSAibm9ybWFsIjsNCiAgICAgICAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIGN0eC5zZXRWYXJpYWJsZSgiZmlsbFN0eWxlIiwgY29sb3IpOw0KDQogICAgICAgICAgICAvKg0KICAgICAgICAgICAgICBuZWVkIHRvIGJlIGRlZmluZWQgaW4gdGhlIG9yZGVyIGFzIGRlZmluZWQgaW4gaHR0cDovL3d3dy53My5vcmcvVFIvQ1NTMjEvZm9udHMuaHRtbCNmb250LXNob3J0aGFuZA0KICAgICAgICAgICAgICB0byBwcm9wZXJseSB3b3JrIGluIEZpcmVmb3gNCiAgICAgICAgICAgICovDQogICAgICAgICAgICBjdHguc2V0VmFyaWFibGUoImZvbnQiLCBmb250X3N0eWxlKyAiICIgKyBmb250X3ZhcmlhbnQgICsgIiAiICsgYm9sZCArICIgIiArIHNpemUgKyAiICIgKyBmYW1pbHkpOw0KDQogICAgICAgICAgICBpZiAoYWxpZ24pew0KICAgICAgICAgICAgICAgIGN0eC5zZXRWYXJpYWJsZSgidGV4dEFsaWduIiwgInJpZ2h0Iik7DQogICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICBjdHguc2V0VmFyaWFibGUoInRleHRBbGlnbiIsICJsZWZ0Iik7DQogICAgICAgICAgICB9DQoNCg0KICAgICAgICAgICAgLyoNCiAgICAgICAgaWYgKHN0YWNrLmNsaXApew0KICAgICAgICBjdHgucmVjdCAoc3RhY2suY2xpcC5sZWZ0LCBzdGFjay5jbGlwLnRvcCwgc3RhY2suY2xpcC53aWR0aCwgc3RhY2suY2xpcC5oZWlnaHQpOw0KICAgICAgICBjdHguY2xpcCgpOw0KICAgICAgICB9DQogICAgICAgICAgICAgKi8NCg0KDQogICAgICAgICAgICBvbGRUZXh0Tm9kZSA9IHRleHROb2RlOw0KDQoNCiAgICAgICAgICAgIGZvciAoIGM9MCwgbGlzdExlbiA9IHJlbmRlckxpc3QubGVuZ3RoOyBjIDwgbGlzdExlbjsgYys9MSApIHsNCiAgICAgICAgICAgICAgICB0ZXh0VmFsdWUgPSBudWxsOw0KDQoNCg0KICAgICAgICAgICAgICAgIGlmIChzdXBwb3J0LnJhbmdlQm91bmRzKXsNCiAgICAgICAgICAgICAgICAgICAgLy8gZ2V0Qm91bmRpbmdDbGllbnRSZWN0IGlzIHN1cHBvcnRlZCBmb3IgcmFuZ2VzDQogICAgICAgICAgICAgICAgICAgIGlmICh0ZXh0X2RlY29yYXRpb24gIT09ICJub25lIiB8fCB0cmltVGV4dChyZW5kZXJMaXN0W2NdKS5sZW5ndGggIT09IDApIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIHRleHRWYWx1ZSA9IHJlbmRlckxpc3RbY107DQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZG9jLmNyZWF0ZVJhbmdlKXsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICByYW5nZSA9IGRvYy5jcmVhdGVSYW5nZSgpOw0KDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmFuZ2Uuc2V0U3RhcnQodGV4dE5vZGUsIHRleHRPZmZzZXQpOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJhbmdlLnNldEVuZCh0ZXh0Tm9kZSwgdGV4dE9mZnNldCArIHRleHRWYWx1ZS5sZW5ndGgpOw0KICAgICAgICAgICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gVE9ETyBhZGQgSUUgc3VwcG9ydA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJhbmdlID0gYm9keS5jcmVhdGVUZXh0UmFuZ2UoKTsNCiAgICAgICAgICAgICAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgICAgICAgICAgICAgYm91bmRzID0gYWRqdXN0Qm91bmRzKHRleHROb2RlLCByYW5nZS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKSk7DQoNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICAvLyBpdCBpc24ndCBzdXBwb3J0ZWQsIHNvIGxldCdzIHdyYXAgaXQgaW5zaWRlIGFuIGVsZW1lbnQgaW5zdGVhZCBhbmQgZ2V0IHRoZSBib3VuZHMgdGhlcmUNCg0KICAgICAgICAgICAgICAgICAgICAvLyBJRSA5IGJ1Zw0KICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIG9sZFRleHROb2RlLm5vZGVWYWx1ZSAhPT0gInN0cmluZyIgKXsNCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOw0KICAgICAgICAgICAgICAgICAgICB9DQoNCiAgICAgICAgICAgICAgICAgICAgbmV3VGV4dE5vZGUgPSBvbGRUZXh0Tm9kZS5zcGxpdFRleHQocmVuZGVyTGlzdFtjXS5sZW5ndGgpOw0KDQogICAgICAgICAgICAgICAgICAgIHBhcmVudCA9IG9sZFRleHROb2RlLnBhcmVudE5vZGU7DQogICAgICAgICAgICAgICAgICAgIHdyYXBFbGVtZW50ID0gZG9jLmNyZWF0ZUVsZW1lbnQoJ3dyYXBwZXInKTsNCiAgICAgICAgICAgICAgICAgICAgYmFja3VwVGV4dCA9IG9sZFRleHROb2RlLmNsb25lTm9kZSh0cnVlKTsNCg0KICAgICAgICAgICAgICAgICAgICB3cmFwRWxlbWVudC5hcHBlbmRDaGlsZChvbGRUZXh0Tm9kZS5jbG9uZU5vZGUodHJ1ZSkpOw0KICAgICAgICAgICAgICAgICAgICBwYXJlbnQucmVwbGFjZUNoaWxkKHdyYXBFbGVtZW50LCBvbGRUZXh0Tm9kZSk7DQoNCiAgICAgICAgICAgICAgICAgICAgYm91bmRzID0gX2h0bWwyY2FudmFzLlV0aWwuQm91bmRzKHdyYXBFbGVtZW50KTsNCg0KICAgICAgICAgICAgICAgICAgICB0ZXh0VmFsdWUgPSBvbGRUZXh0Tm9kZS5ub2RlVmFsdWU7DQoNCiAgICAgICAgICAgICAgICAgICAgb2xkVGV4dE5vZGUgPSBuZXdUZXh0Tm9kZTsNCiAgICAgICAgICAgICAgICAgICAgcGFyZW50LnJlcGxhY2VDaGlsZChiYWNrdXBUZXh0LCB3cmFwRWxlbWVudCk7DQoNCg0KICAgICAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgICAgIGlmICh0ZXh0VmFsdWUgIT09IG51bGwpew0KICAgICAgICAgICAgICAgICAgICBkcmF3VGV4dCh0ZXh0VmFsdWUsIGJvdW5kcy5sZWZ0LCBib3VuZHMuYm90dG9tLCBjdHgpOw0KICAgICAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgICAgIHN3aXRjaCh0ZXh0X2RlY29yYXRpb24pIHsNCiAgICAgICAgICAgICAgICAgICAgY2FzZSAidW5kZXJsaW5lIjoNCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIERyYXdzIGEgbGluZSBhdCB0aGUgYmFzZWxpbmUgb2YgdGhlIGZvbnQNCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFRPRE8gQXMgc29tZSBicm93c2VycyBkaXNwbGF5IHRoZSBsaW5lIGFzIG1vcmUgdGhhbiAxcHggaWYgdGhlIGZvbnQtc2l6ZSBpcyBiaWcsIG5lZWQgdG8gdGFrZSB0aGF0IGludG8gYWNjb3VudCBib3RoIGluIHBvc2l0aW9uIGFuZCBzaXplDQogICAgICAgICAgICAgICAgICAgICAgICByZW5kZXJSZWN0KGN0eCwgYm91bmRzLmxlZnQsIE1hdGgucm91bmQoYm91bmRzLnRvcCArIG1ldHJpY3MuYmFzZWxpbmUgKyBtZXRyaWNzLmxpbmVXaWR0aCksIGJvdW5kcy53aWR0aCwgMSwgY29sb3IpOw0KICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICAgICAgICAgIGNhc2UgIm92ZXJsaW5lIjoNCiAgICAgICAgICAgICAgICAgICAgICAgIHJlbmRlclJlY3QoY3R4LCBib3VuZHMubGVmdCwgYm91bmRzLnRvcCwgYm91bmRzLndpZHRoLCAxLCBjb2xvcik7DQogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgICAgICAgICAgY2FzZSAibGluZS10aHJvdWdoIjoNCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFRPRE8gdHJ5IGFuZCBmaW5kIGV4YWN0IHBvc2l0aW9uIGZvciBsaW5lLXRocm91Z2gNCiAgICAgICAgICAgICAgICAgICAgICAgIHJlbmRlclJlY3QoY3R4LCBib3VuZHMubGVmdCwgTWF0aC5jZWlsKGJvdW5kcy50b3AgKyBtZXRyaWNzLm1pZGRsZSArIG1ldHJpY3MubGluZVdpZHRoKSwgYm91bmRzLndpZHRoLCAxLCBjb2xvcik7DQogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsNCg0KICAgICAgICAgICAgICAgIH0NCg0KDQoNCg0KDQogICAgICAgICAgICAgICAgdGV4dE9mZnNldCArPSByZW5kZXJMaXN0W2NdLmxlbmd0aDsNCg0KICAgICAgICAgICAgfQ0KDQoNCg0KICAgICAgICB9DQoNCiAgICB9DQoNCiAgICBmdW5jdGlvbiBsaXN0UG9zaXRpb24gKGVsZW1lbnQsIHZhbCkgew0KICAgICAgICB2YXIgYm91bmRFbGVtZW50ID0gZG9jLmNyZWF0ZUVsZW1lbnQoICJib3VuZGVsZW1lbnQiICksDQogICAgICAgIHR5cGUsDQogICAgICAgIGJvdW5kczsNCg0KICAgICAgICBib3VuZEVsZW1lbnQuc3R5bGUuZGlzcGxheSA9ICJpbmxpbmUiOw0KICAgICAgICAvL2JvdW5kRWxlbWVudC5zdHlsZS53aWR0aCA9ICIxcHgiOw0KICAgICAgICAvL2JvdW5kRWxlbWVudC5zdHlsZS5oZWlnaHQgPSAiMXB4IjsNCg0KICAgICAgICB0eXBlID0gZWxlbWVudC5zdHlsZS5saXN0U3R5bGVUeXBlOw0KICAgICAgICBlbGVtZW50LnN0eWxlLmxpc3RTdHlsZVR5cGUgPSAibm9uZSI7DQoNCiAgICAgICAgYm91bmRFbGVtZW50LmFwcGVuZENoaWxkKCBkb2MuY3JlYXRlVGV4dE5vZGUoIHZhbCApICk7DQoNCg0KICAgICAgICBlbGVtZW50Lmluc2VydEJlZm9yZShib3VuZEVsZW1lbnQsIGVsZW1lbnQuZmlyc3RDaGlsZCk7DQoNCg0KICAgICAgICBib3VuZHMgPSBfaHRtbDJjYW52YXMuVXRpbC5Cb3VuZHMoIGJvdW5kRWxlbWVudCApOw0KICAgICAgICBlbGVtZW50LnJlbW92ZUNoaWxkKCBib3VuZEVsZW1lbnQgKTsNCiAgICAgICAgZWxlbWVudC5zdHlsZS5saXN0U3R5bGVUeXBlID0gdHlwZTsNCiAgICAgICAgcmV0dXJuIGJvdW5kczsNCg0KICAgIH0NCiAgICANCg0KICAgIA0KICAgIGZ1bmN0aW9uIGVsZW1lbnRJbmRleCggZWwgKSB7DQogICAgICAgIHZhciBpID0gLTEsDQogICAgICAgIGNvdW50ID0gMSwNCiAgICAgICAgY2hpbGRzID0gZWwucGFyZW50Tm9kZS5jaGlsZE5vZGVzOw0KDQogICAgICAgIGlmICggZWwucGFyZW50Tm9kZSApIHsNCiAgICAgICAgICAgIHdoaWxlKCBjaGlsZHNbICsraSBdICE9PSBlbCApIHsNCiAgICAgICAgICAgICAgIGlmICggY2hpbGRzWyBpIF0ubm9kZVR5cGUgPT09IDEgKSB7DQogICAgICAgICAgICAgICAgICAgY291bnQrKzsNCiAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIHJldHVybiBjb3VudDsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgIHJldHVybiAtMTsNCiAgICAgICAgfQ0KICAgICAgIA0KICAgIH0NCg0KICAgIGZ1bmN0aW9uIHJlbmRlckxpc3RJdGVtKGVsZW1lbnQsIHN0YWNrLCBlbEJvdW5kcykgew0KDQoNCiAgICAgICAgdmFyIHBvc2l0aW9uID0gZ2V0Q1NTKGVsZW1lbnQsICJsaXN0U3R5bGVQb3NpdGlvbiIpLA0KICAgICAgICB4LA0KICAgICAgICB5LA0KICAgICAgICB0eXBlID0gZ2V0Q1NTKGVsZW1lbnQsICJsaXN0U3R5bGVUeXBlIiksDQogICAgICAgIGN1cnJlbnRJbmRleCwNCiAgICAgICAgdGV4dCwNCiAgICAgICAgbGlzdEJvdW5kcywNCiAgICAgICAgYm9sZCA9IGdldENTUyhlbGVtZW50LCAiZm9udFdlaWdodCIpOw0KDQogICAgICAgIGlmICgvXihkZWNpbWFsfGRlY2ltYWwtbGVhZGluZy16ZXJvfHVwcGVyLWFscGhhfHVwcGVyLWxhdGlufHVwcGVyLXJvbWFufGxvd2VyLWFscGhhfGxvd2VyLWdyZWVrfGxvd2VyLWxhdGlufGxvd2VyLXJvbWFuKSQvaS50ZXN0KHR5cGUpKSB7DQoNCiAgICAgICAgICAgIGN1cnJlbnRJbmRleCA9IGVsZW1lbnRJbmRleCggZWxlbWVudCApOw0KDQogICAgICAgICAgICBzd2l0Y2godHlwZSl7DQogICAgICAgICAgICAgICAgY2FzZSAiZGVjaW1hbCI6DQogICAgICAgICAgICAgICAgICAgIHRleHQgPSBjdXJyZW50SW5kZXg7DQogICAgICAgICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgICAgIGNhc2UgImRlY2ltYWwtbGVhZGluZy16ZXJvIjoNCiAgICAgICAgICAgICAgICAgICAgaWYgKGN1cnJlbnRJbmRleC50b1N0cmluZygpLmxlbmd0aCA9PT0gMSl7DQogICAgICAgICAgICAgICAgICAgICAgICB0ZXh0ID0gY3VycmVudEluZGV4ID0gIjAiICsgY3VycmVudEluZGV4LnRvU3RyaW5nKCk7DQogICAgICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICAgICAgdGV4dCA9IGN1cnJlbnRJbmRleC50b1N0cmluZygpOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgICAgIGNhc2UgInVwcGVyLXJvbWFuIjoNCiAgICAgICAgICAgICAgICAgICAgdGV4dCA9IF9odG1sMmNhbnZhcy5HZW5lcmF0ZS5MaXN0Um9tYW4oIGN1cnJlbnRJbmRleCApOw0KICAgICAgICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgICAgICBjYXNlICJsb3dlci1yb21hbiI6DQogICAgICAgICAgICAgICAgICAgIHRleHQgPSBfaHRtbDJjYW52YXMuR2VuZXJhdGUuTGlzdFJvbWFuKCBjdXJyZW50SW5kZXggKS50b0xvd2VyQ2FzZSgpOw0KICAgICAgICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgICAgICBjYXNlICJsb3dlci1hbHBoYSI6DQogICAgICAgICAgICAgICAgICAgIHRleHQgPSBfaHRtbDJjYW52YXMuR2VuZXJhdGUuTGlzdEFscGhhKCBjdXJyZW50SW5kZXggKS50b0xvd2VyQ2FzZSgpOw0KICAgICAgICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgICAgICBjYXNlICJ1cHBlci1hbHBoYSI6DQogICAgICAgICAgICAgICAgICAgIHRleHQgPSBfaHRtbDJjYW52YXMuR2VuZXJhdGUuTGlzdEFscGhhKCBjdXJyZW50SW5kZXggKTsNCiAgICAgICAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICB9DQoNCg0KICAgICAgICAgICAgdGV4dCArPSAiLiAiOw0KICAgICAgICAgICAgbGlzdEJvdW5kcyA9IGxpc3RQb3NpdGlvbihlbGVtZW50LCB0ZXh0KTsNCg0KDQoNCiAgICAgICAgICAgIHN3aXRjaChib2xkKXsNCiAgICAgICAgICAgICAgICBjYXNlIDQwMToNCiAgICAgICAgICAgICAgICAgICAgYm9sZCA9ICJib2xkIjsNCiAgICAgICAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICAgICAgY2FzZSA0MDA6DQogICAgICAgICAgICAgICAgICAgIGJvbGQgPSAibm9ybWFsIjsNCiAgICAgICAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICB9DQoNCg0KDQoNCiAgICAgICAgICAgIGN0eC5zZXRWYXJpYWJsZSggImZpbGxTdHlsZSIsIGdldENTUyhlbGVtZW50LCAiY29sb3IiKSApOw0KICAgICAgICAgICAgY3R4LnNldFZhcmlhYmxlKCAiZm9udCIsIGdldENTUyhlbGVtZW50LCAiZm9udFZhcmlhbnQiKSArICIgIiArIGJvbGQgKyAiICIgKyBnZXRDU1MoZWxlbWVudCwgImZvbnRTdHlsZSIpICsgIiAiICsgZ2V0Q1NTKGVsZW1lbnQsICJmb250U2l6ZSIpICsgIiAiICsgZ2V0Q1NTKGVsZW1lbnQsICJmb250RmFtaWx5IikgKTsNCg0KDQogICAgICAgICAgICBpZiAoIHBvc2l0aW9uID09PSAiaW5zaWRlIiApIHsNCiAgICAgICAgICAgICAgICBjdHguc2V0VmFyaWFibGUoInRleHRBbGlnbiIsICJsZWZ0Iik7DQogICAgICAgICAgICAgICAgLy8gICB0aGlzLnNldEZvbnQoc3RhY2suY3R4LCBlbGVtZW50LCBmYWxzZSk7DQogICAgICAgICAgICAgICAgeCA9IGVsQm91bmRzLmxlZnQ7DQoNCiAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgICAgIC8qDQogICAgICAgICAgICAgICAgIFRPRE8gcmVhbGx5IG5lZWQgdG8gZmlndXJlIG91dCBzb21lIG1vcmUgYWNjdXJhdGUgd2F5IHRvIHRyeSBhbmQgZmluZCB0aGUgcG9zaXRpb24uDQogICAgICAgICAgICAgICAgIGFzIGRlZmluZWQgaW4gaHR0cDovL3d3dy53My5vcmcvVFIvQ1NTMjEvZ2VuZXJhdGUuaHRtbCNwcm9wZGVmLWxpc3Qtc3R5bGUtcG9zaXRpb24sIGl0IGRvZXMgbm90IGV2ZW4gaGF2ZSBhIHNwZWNpZmllZCAiY29ycmVjdCIgcG9zaXRpb24sIHNvIGVhY2ggYnJvd3Nlcg0KICAgICAgICAgICAgICAgICBtYXkgZGlzcGxheSBpdCB3aGF0ZXZlciB3YXkgaXQgZmVlbHMgbGlrZS4NCiAgICAgICAgICAgICAgICAgIlRoZSBwb3NpdGlvbiBvZiB0aGUgbGlzdC1pdGVtIG1hcmtlciBhZGphY2VudCB0byBmbG9hdHMgaXMgdW5kZWZpbmVkIGluIENTUyAyLjEuIENTUyAyLjEgZG9lcyBub3Qgc3BlY2lmeSB0aGUgcHJlY2lzZSBsb2NhdGlvbiBvZiB0aGUgbWFya2VyIGJveCBvciBpdHMgcG9zaXRpb24gaW4gdGhlIHBhaW50aW5nIG9yZGVyIg0KDQogICAgICAgICAgICAgICAgY3R4LnNldFZhcmlhYmxlKCJ0ZXh0QWxpZ24iLCAicmlnaHQiKTsNCiAgICAgICAgICAgICAgICAvLyAgdGhpcy5zZXRGb250KHN0YWNrLmN0eCwgZWxlbWVudCwgdHJ1ZSk7DQogICAgICAgICAgICAgICAgeCA9IGVsQm91bmRzLmxlZnQgLSAxMDsNCiAgICAgICAgICAgICAgICAgKi8NCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgeSA9IGxpc3RCb3VuZHMuYm90dG9tOw0KDQogICAgICAgICAgICBkcmF3VGV4dCh0ZXh0LCB4LCB5LCBjdHgpOw0KDQoNCiAgICAgICAgfQ0KDQoNCiAgICB9DQoNCiAgICBmdW5jdGlvbiBsb2FkSW1hZ2UgKHNyYyl7DQogICAgICAgIHZhciBpbWcgPSBpbWFnZXNbc3JjXTsNCiAgICAgICAgaWYgKGltZyAmJiBpbWcuc3VjY2VlZGVkID09PSB0cnVlKSB7DQogICAgICAgICAgICByZXR1cm4gaW1nLmltZzsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgIHJldHVybiBmYWxzZTsNCiAgICAgICAgfQ0KICAgIH0NCg0KDQoNCg0KDQoNCiAgICBmdW5jdGlvbiBjbGlwQm91bmRzKHNyYywgZHN0KXsNCg0KICAgICAgICB2YXIgeCA9IE1hdGgubWF4KHNyYy5sZWZ0LCBkc3QubGVmdCksDQogICAgICAgIHkgPSBNYXRoLm1heChzcmMudG9wLCBkc3QudG9wKSwNCiAgICAgICAgeDIgPSBNYXRoLm1pbigoc3JjLmxlZnQgKyBzcmMud2lkdGgpLCAoZHN0LmxlZnQgKyBkc3Qud2lkdGgpKSwNCiAgICAgICAgeTIgPSBNYXRoLm1pbigoc3JjLnRvcCArIHNyYy5oZWlnaHQpLCAoZHN0LnRvcCArIGRzdC5oZWlnaHQpKTsNCg0KICAgICAgICByZXR1cm4gew0KICAgICAgICAgICAgbGVmdDp4LA0KICAgICAgICAgICAgdG9wOnksDQogICAgICAgICAgICB3aWR0aDp4Mi14LA0KICAgICAgICAgICAgaGVpZ2h0OnkyLXkNCiAgICAgICAgfTsNCg0KICAgIH0NCg0KICAgIGZ1bmN0aW9uIHNldFooekluZGV4LCBwYXJlbnRaKXsNCiAgICAgICAgLy8gVE9ETyBmaXggc3RhdGljIGVsZW1lbnRzIG92ZXJsYXBwaW5nIHJlbGF0aXZlL2Fic29sdXRlIGVsZW1lbnRzIHVuZGVyIHNhbWUgc3RhY2ssIGlmIHRoZXkgYXJlIGRlZmluZWQgYWZ0ZXIgdGhlbQ0KICAgICAgICB2YXIgbmV3Q29udGV4dDsNCiAgICAgICAgaWYgKCFwYXJlbnRaKXsNCiAgICAgICAgICAgIG5ld0NvbnRleHQgPSBoMmN6Q29udGV4dCgwKTsNCiAgICAgICAgICAgIHJldHVybiBuZXdDb250ZXh0Ow0KICAgICAgICB9DQoNCiAgICAgICAgaWYgKHpJbmRleCAhPT0gImF1dG8iKXsNCiAgICAgICAgICAgIG5lZWRSZW9yZGVyID0gdHJ1ZTsNCiAgICAgICAgICAgIG5ld0NvbnRleHQgPSBoMmN6Q29udGV4dCh6SW5kZXgpOw0KICAgICAgICAgICAgcGFyZW50Wi5jaGlsZHJlbi5wdXNoKG5ld0NvbnRleHQpOw0KICAgICAgICAgICAgcmV0dXJuIG5ld0NvbnRleHQ7DQoNCiAgICAgICAgfQ0KDQogICAgICAgIHJldHVybiBwYXJlbnRaOw0KDQogICAgfQ0KDQogICAgZnVuY3Rpb24gcmVuZGVyQm9yZGVycyhlbCwgY3R4LCBib3VuZHMsIGNsaXApew0KDQogICAgICAgIC8qDQogICAgICAgICAqICBUT0RPIGFkZCBzdXBwb3J0IGZvciBkaWZmZXJlbnQgYm9yZGVyLXN0eWxlJ3MgdGhhbiBzb2xpZA0KICAgICAgICAgKi8NCg0KICAgICAgICB2YXIgeCA9IGJvdW5kcy5sZWZ0LA0KICAgICAgICB5ID0gYm91bmRzLnRvcCwNCiAgICAgICAgdyA9IGJvdW5kcy53aWR0aCwNCiAgICAgICAgaCA9IGJvdW5kcy5oZWlnaHQsDQogICAgICAgIGJvcmRlclNpZGUsDQogICAgICAgIGJvcmRlckRhdGEsDQogICAgICAgIGJ4LA0KICAgICAgICBieSwNCiAgICAgICAgYncsDQogICAgICAgIGJoLA0KICAgICAgICBib3JkZXJCb3VuZHMsDQogICAgICAgIGJvcmRlcnMgPSAoZnVuY3Rpb24oZWwpew0KICAgICAgICAgICAgdmFyIGJvcmRlcnMgPSBbXSwNCiAgICAgICAgICAgIHNpZGVzID0gWyJUb3AiLCJSaWdodCIsIkJvdHRvbSIsIkxlZnQiXSwNCiAgICAgICAgICAgIHM7DQoNCiAgICAgICAgICAgIGZvciAocyA9IDA7IHMgPCA0OyBzKz0xKXsNCiAgICAgICAgICAgICAgICBib3JkZXJzLnB1c2goew0KICAgICAgICAgICAgICAgICAgICB3aWR0aDogZ2V0Q1NTSW50KGVsLCAnYm9yZGVyJyArIHNpZGVzW3NdICsgJ1dpZHRoJyksDQogICAgICAgICAgICAgICAgICAgIGNvbG9yOiBnZXRDU1MoZWwsICdib3JkZXInICsgc2lkZXNbc10gKyAnQ29sb3InKQ0KICAgICAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICByZXR1cm4gYm9yZGVyczsNCg0KICAgICAgICB9KGVsKSk7DQoNCg0KICAgICAgICBmb3IgKGJvcmRlclNpZGUgPSAwOyBib3JkZXJTaWRlIDwgNDsgYm9yZGVyU2lkZSs9MSl7DQogICAgICAgICAgICBib3JkZXJEYXRhID0gYm9yZGVyc1tib3JkZXJTaWRlXTsNCg0KICAgICAgICAgICAgaWYgKGJvcmRlckRhdGEud2lkdGg+MCl7DQogICAgICAgICAgICAgICAgYnggPSB4Ow0KICAgICAgICAgICAgICAgIGJ5ID0geTsNCiAgICAgICAgICAgICAgICBidyA9IHc7DQogICAgICAgICAgICAgICAgYmggPSBoIC0gKGJvcmRlcnNbMl0ud2lkdGgpOw0KDQogICAgICAgICAgICAgICAgc3dpdGNoKGJvcmRlclNpZGUpew0KICAgICAgICAgICAgICAgICAgICBjYXNlIDA6DQogICAgICAgICAgICAgICAgICAgICAgICAvLyB0b3AgYm9yZGVyDQogICAgICAgICAgICAgICAgICAgICAgICBiaCA9IGJvcmRlcnNbMF0ud2lkdGg7DQogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgICAgICAgICAgY2FzZSAxOg0KICAgICAgICAgICAgICAgICAgICAgICAgLy8gcmlnaHQgYm9yZGVyDQogICAgICAgICAgICAgICAgICAgICAgICBieCA9IHggKyB3IC0gKGJvcmRlcnNbMV0ud2lkdGgpOw0KICAgICAgICAgICAgICAgICAgICAgICAgYncgPSBib3JkZXJzWzFdLndpZHRoOw0KICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICAgICAgICAgIGNhc2UgMjoNCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGJvdHRvbSBib3JkZXINCiAgICAgICAgICAgICAgICAgICAgICAgIGJ5ID0gKGJ5ICsgaCkgLSAoYm9yZGVyc1syXS53aWR0aCk7DQogICAgICAgICAgICAgICAgICAgICAgICBiaCA9IGJvcmRlcnNbMl0ud2lkdGg7DQogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgICAgICAgICAgY2FzZSAzOg0KICAgICAgICAgICAgICAgICAgICAgICAgLy8gbGVmdCBib3JkZXINCiAgICAgICAgICAgICAgICAgICAgICAgIGJ3ID0gYm9yZGVyc1szXS53aWR0aDsNCiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgICAgIGJvcmRlckJvdW5kcyA9IHsNCiAgICAgICAgICAgICAgICAgICAgbGVmdDpieCwNCiAgICAgICAgICAgICAgICAgICAgdG9wOmJ5LA0KICAgICAgICAgICAgICAgICAgICB3aWR0aDogYncsDQogICAgICAgICAgICAgICAgICAgIGhlaWdodDpiaA0KICAgICAgICAgICAgICAgIH07DQoNCiAgICAgICAgICAgICAgICBpZiAoY2xpcCl7DQogICAgICAgICAgICAgICAgICAgIGJvcmRlckJvdW5kcyA9IGNsaXBCb3VuZHMoYm9yZGVyQm91bmRzLCBjbGlwKTsNCiAgICAgICAgICAgICAgICB9DQoNCg0KICAgICAgICAgICAgICAgIGlmIChib3JkZXJCb3VuZHMud2lkdGg+MCAmJiBib3JkZXJCb3VuZHMuaGVpZ2h0PjApew0KICAgICAgICAgICAgICAgICAgICByZW5kZXJSZWN0KGN0eCwgYngsIGJ5LCBib3JkZXJCb3VuZHMud2lkdGgsIGJvcmRlckJvdW5kcy5oZWlnaHQsIGJvcmRlckRhdGEuY29sb3IpOw0KICAgICAgICAgICAgICAgIH0NCg0KDQogICAgICAgICAgICB9DQogICAgICAgIH0NCg0KICAgICAgICByZXR1cm4gYm9yZGVyczsNCg0KICAgIH0NCg0KDQogICAgZnVuY3Rpb24gcmVuZGVyRm9ybVZhbHVlIChlbCwgYm91bmRzLCBzdGFjayl7DQoNCiAgICAgICAgdmFyIHZhbHVlV3JhcCA9IGRvYy5jcmVhdGVFbGVtZW50KCd2YWx1ZXdyYXAnKSwNCiAgICAgICAgY3NzQXJyID0gWydsaW5lSGVpZ2h0JywndGV4dEFsaWduJywnZm9udEZhbWlseScsJ2NvbG9yJywnZm9udFNpemUnLCdwYWRkaW5nTGVmdCcsJ3BhZGRpbmdUb3AnLCd3aWR0aCcsJ2hlaWdodCcsJ2JvcmRlcicsJ2JvcmRlckxlZnRXaWR0aCcsJ2JvcmRlclRvcFdpZHRoJ10sDQogICAgICAgIGksDQogICAgICAgIHRleHRWYWx1ZSwNCiAgICAgICAgdGV4dE5vZGUsDQogICAgICAgIGFyckxlbiwNCiAgICAgICAgc3R5bGU7DQoNCiAgICAgICAgZm9yIChpID0gMCwgYXJyTGVuID0gY3NzQXJyLmxlbmd0aDsgaSA8IGFyckxlbjsgaSs9MSl7DQogICAgICAgICAgICBzdHlsZSA9IGNzc0FycltpXTsNCg0KICAgICAgICAgICAgdHJ5IHsNCiAgICAgICAgICAgICAgICB2YWx1ZVdyYXAuc3R5bGVbc3R5bGVdID0gZ2V0Q1NTKGVsLCBzdHlsZSk7DQogICAgICAgICAgICB9IGNhdGNoKCBlICkgew0KICAgICAgICAgICAgICAgIC8vIE9sZGVyIElFIGhhcyBpc3N1ZXMgd2l0aCAiYm9yZGVyIg0KICAgICAgICAgICAgICAgIGgyY2xvZygiaHRtbDJjYW52YXM6IFBhcnNlOiBFeGNlcHRpb24gY2F1Z2h0IGluIHJlbmRlckZvcm1WYWx1ZTogIiArIGUubWVzc2FnZSk7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCg0KDQogICAgICAgIHZhbHVlV3JhcC5zdHlsZS5ib3JkZXJDb2xvciA9ICJibGFjayI7DQogICAgICAgIHZhbHVlV3JhcC5zdHlsZS5ib3JkZXJTdHlsZSA9ICJzb2xpZCI7DQogICAgICAgIHZhbHVlV3JhcC5zdHlsZS5kaXNwbGF5ID0gImJsb2NrIjsNCiAgICAgICAgdmFsdWVXcmFwLnN0eWxlLnBvc2l0aW9uID0gImFic29sdXRlIjsNCiAgICAgICAgaWYgKC9eKHN1Ym1pdHxyZXNldHxidXR0b258dGV4dHxwYXNzd29yZCkkLy50ZXN0KGVsLnR5cGUpIHx8IGVsLm5vZGVOYW1lID09PSAiU0VMRUNUIil7DQogICAgICAgICAgICB2YWx1ZVdyYXAuc3R5bGUubGluZUhlaWdodCA9IGdldENTUyhlbCwgImhlaWdodCIpOw0KICAgICAgICB9DQoNCg0KICAgICAgICB2YWx1ZVdyYXAuc3R5bGUudG9wID0gYm91bmRzLnRvcCArICJweCI7DQogICAgICAgIHZhbHVlV3JhcC5zdHlsZS5sZWZ0ID0gYm91bmRzLmxlZnQgKyAicHgiOw0KDQogICAgICAgIGlmIChlbC5ub2RlTmFtZSA9PT0gIlNFTEVDVCIpew0KICAgICAgICAgICAgLy8gVE9ETyBpbmNyZWFzZSBhY2N1cmFjeSBvZiB0ZXh0IHBvc2l0aW9uDQogICAgICAgICAgICB0ZXh0VmFsdWUgPSBlbC5vcHRpb25zW2VsLnNlbGVjdGVkSW5kZXhdLnRleHQ7DQogICAgICAgIH0gZWxzZXsNCiAgICAgICAgICAgIHRleHRWYWx1ZSA9IGVsLnZhbHVlOw0KICAgICAgICB9DQogICAgICAgIHRleHROb2RlID0gZG9jLmNyZWF0ZVRleHROb2RlKHRleHRWYWx1ZSk7DQoNCiAgICAgICAgdmFsdWVXcmFwLmFwcGVuZENoaWxkKHRleHROb2RlKTsNCiAgICAgICAgYm9keS5hcHBlbmRDaGlsZCh2YWx1ZVdyYXApOw0KDQoNCiAgICAgICAgcmVuZGVyVGV4dChlbCwgdGV4dE5vZGUsIHN0YWNrKTsNCiAgICAgICAgYm9keS5yZW1vdmVDaGlsZCh2YWx1ZVdyYXApOw0KDQoNCg0KICAgIH0NCg0KDQoNCg0KDQogICAgZnVuY3Rpb24gcmVuZGVySW1hZ2UgKGN0eCwgaW1hZ2UsIHN4LCBzeSwgc3csIHNoLCBkeCwgZHksIGR3LCBkaCkgew0KICAgICAgICBjdHguZHJhd0ltYWdlKA0KICAgICAgICAgICAgaW1hZ2UsDQogICAgICAgICAgICBzeCwgLy9zeA0KICAgICAgICAgICAgc3ksIC8vc3kNCiAgICAgICAgICAgIHN3LCAvL3N3DQogICAgICAgICAgICBzaCwgLy9zaA0KICAgICAgICAgICAgZHgsIC8vZHgNCiAgICAgICAgICAgIGR5LCAvLyBkeQ0KICAgICAgICAgICAgZHcsIC8vZHcNCiAgICAgICAgICAgIGRoIC8vZGgNCiAgICAgICAgICAgICk7DQogICAgICAgIG51bURyYXdzKz0xOw0KDQogICAgfQ0KDQoNCiAgICBmdW5jdGlvbiByZW5kZXJCYWNrZ3JvdW5kUmVwZWF0IChjdHgsIGltYWdlLCB4LCB5LCB3aWR0aCwgaGVpZ2h0LCBlbHgsIGVseSl7DQogICAgICAgIHZhciBzb3VyY2VYID0gMCwNCiAgICAgICAgc291cmNlWT0wOw0KICAgICAgICBpZiAoZWx4LXg+MCl7DQogICAgICAgICAgICBzb3VyY2VYID0gZWx4LXg7DQogICAgICAgIH0NCg0KICAgICAgICBpZiAoZWx5LXk+MCl7DQogICAgICAgICAgICBzb3VyY2VZID0gZWx5LXk7DQogICAgICAgIH0NCg0KICAgICAgICByZW5kZXJJbWFnZSgNCiAgICAgICAgICAgIGN0eCwNCiAgICAgICAgICAgIGltYWdlLA0KICAgICAgICAgICAgc291cmNlWCwgLy8gc291cmNlIFgNCiAgICAgICAgICAgIHNvdXJjZVksIC8vIHNvdXJjZSBZDQogICAgICAgICAgICB3aWR0aC1zb3VyY2VYLCAvLyBzb3VyY2UgV2lkdGgNCiAgICAgICAgICAgIGhlaWdodC1zb3VyY2VZLCAvLyBzb3VyY2UgSGVpZ2h0DQogICAgICAgICAgICB4K3NvdXJjZVgsIC8vIGRlc3RpbmF0aW9uIFgNCiAgICAgICAgICAgIHkrc291cmNlWSwgLy8gZGVzdGluYXRpb24gWQ0KICAgICAgICAgICAgd2lkdGgtc291cmNlWCwgLy8gZGVzdGluYXRpb24gd2lkdGgNCiAgICAgICAgICAgIGhlaWdodC1zb3VyY2VZIC8vIGRlc3RpbmF0aW9uIGhlaWdodA0KICAgICAgICAgICAgKTsNCiAgICB9DQoNCg0KICAgIGZ1bmN0aW9uIHJlbmRlckJhY2tncm91bmRSZXBlYXRZIChjdHgsIGltYWdlLCBiZ3AsIHgsIHksIHcsIGgpew0KDQogICAgICAgIHZhciBoZWlnaHQsDQogICAgICAgIHdpZHRoID0gTWF0aC5taW4oaW1hZ2Uud2lkdGgsdyksYmd5Ow0KDQogICAgICAgIGJncC50b3AgPSBiZ3AudG9wLU1hdGguY2VpbChiZ3AudG9wL2ltYWdlLmhlaWdodCkqaW1hZ2UuaGVpZ2h0Ow0KDQoNCiAgICAgICAgZm9yKGJneT0oeStiZ3AudG9wKTtiZ3k8aCt5Oyl7DQoNCg0KICAgICAgICAgICAgaWYgKCBNYXRoLmZsb29yKGJneStpbWFnZS5oZWlnaHQpPmgreSl7DQogICAgICAgICAgICAgICAgaGVpZ2h0ID0gKGgreSktYmd5Ow0KICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgaGVpZ2h0ID0gaW1hZ2UuaGVpZ2h0Ow0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgcmVuZGVyQmFja2dyb3VuZFJlcGVhdChjdHgsaW1hZ2UseCtiZ3AubGVmdCxiZ3ksd2lkdGgsaGVpZ2h0LHgseSk7DQoNCiAgICAgICAgICAgIGJneSA9IE1hdGguZmxvb3IoYmd5K2ltYWdlLmhlaWdodCk7DQoNCiAgICAgICAgfQ0KICAgIH0NCg0KICAgIGZ1bmN0aW9uIHJlbmRlckJhY2tncm91bmRSZXBlYXRYKGN0eCwgaW1hZ2UsIGJncCwgeCwgeSwgdywgaCl7DQoNCiAgICAgICAgdmFyIGhlaWdodCA9IE1hdGgubWluKGltYWdlLmhlaWdodCxoKSwNCiAgICAgICAgd2lkdGgsYmd4Ow0KDQoNCiAgICAgICAgYmdwLmxlZnQgPSBiZ3AubGVmdC1NYXRoLmNlaWwoYmdwLmxlZnQvaW1hZ2Uud2lkdGgpKmltYWdlLndpZHRoOw0KDQoNCiAgICAgICAgZm9yIChiZ3g9KHgrYmdwLmxlZnQpO2JneDx3K3g7KSB7DQoNCiAgICAgICAgICAgIGlmIChNYXRoLmZsb29yKGJneCtpbWFnZS53aWR0aCk+dyt4KXsNCiAgICAgICAgICAgICAgICB3aWR0aCA9ICh3K3gpLWJneDsNCiAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgIHdpZHRoID0gaW1hZ2Uud2lkdGg7DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIHJlbmRlckJhY2tncm91bmRSZXBlYXQoY3R4LGltYWdlLGJneCwoeStiZ3AudG9wKSx3aWR0aCxoZWlnaHQseCx5KTsNCg0KICAgICAgICAgICAgYmd4ID0gTWF0aC5mbG9vcihiZ3graW1hZ2Uud2lkdGgpOw0KDQoNCiAgICAgICAgfQ0KICAgIH0NCg0KICAgIGZ1bmN0aW9uIHJlbmRlckJhY2tncm91bmQoZWwsYm91bmRzLGN0eCl7DQoNCiAgICAgICAgLy8gVE9ETyBhZGQgc3VwcG9ydCBmb3IgbXVsdGkgYmFja2dyb3VuZC1pbWFnZXMNCiAgICAgICAgdmFyIGJhY2tncm91bmRfaW1hZ2UgPSBnZXRDU1MoZWwsICJiYWNrZ3JvdW5kSW1hZ2UiKSwNCiAgICAgICAgYmFja2dyb3VuZF9yZXBlYXQgPSBnZXRDU1MoZWwsICJiYWNrZ3JvdW5kUmVwZWF0Iikuc3BsaXQoIiwiKVswXSwNCiAgICAgICAgaW1hZ2UsDQogICAgICAgIGJncCwNCiAgICAgICAgYmd5LA0KICAgICAgICBiZ3csDQogICAgICAgIGJnc3gsDQogICAgICAgIGJnc3ksDQogICAgICAgIGJnZHgsDQogICAgICAgIGJnZHksDQogICAgICAgIGJnaCwNCiAgICAgICAgaCwNCiAgICAgICAgaGVpZ2h0LA0KICAgICAgICBhZGQ7DQoNCiAgICAgICAgLy8gICBpZiAodHlwZW9mIGJhY2tncm91bmRfaW1hZ2UgIT09ICJ1bmRlZmluZWQiICYmIC9eKDF8bm9uZSkkLy50ZXN0KGJhY2tncm91bmRfaW1hZ2UpID09PSBmYWxzZSAmJiAvXigtd2Via2l0fC1tb3p8bGluZWFyLWdyYWRpZW50fC1vLSkvLnRlc3QoYmFja2dyb3VuZF9pbWFnZSk9PT1mYWxzZSl7DQoNCiAgICAgICAgaWYgKCAhL2RhdGE6aW1hZ2VcLy4qO2Jhc2U2NCwvaS50ZXN0KGJhY2tncm91bmRfaW1hZ2UpICYmICEvXigtd2Via2l0fC1tb3p8bGluZWFyLWdyYWRpZW50fC1vLSkvLnRlc3QoYmFja2dyb3VuZF9pbWFnZSkgKSB7DQogICAgICAgICAgICBiYWNrZ3JvdW5kX2ltYWdlID0gYmFja2dyb3VuZF9pbWFnZS5zcGxpdCgiLCIpWzBdOw0KICAgICAgICB9DQoNCiAgICAgICAgaWYgKCB0eXBlb2YgYmFja2dyb3VuZF9pbWFnZSAhPT0gInVuZGVmaW5lZCIgJiYgL14oMXxub25lKSQvLnRlc3QoIGJhY2tncm91bmRfaW1hZ2UgKSA9PT0gZmFsc2UgKSB7DQogICAgICAgICAgICBiYWNrZ3JvdW5kX2ltYWdlID0gX2h0bWwyY2FudmFzLlV0aWwuYmFja2dyb3VuZEltYWdlKCBiYWNrZ3JvdW5kX2ltYWdlICk7DQogICAgICAgICAgICBpbWFnZSA9IGxvYWRJbWFnZSggYmFja2dyb3VuZF9pbWFnZSApOw0KDQoNCiAgICAgICAgICAgIGJncCA9IF9odG1sMmNhbnZhcy5VdGlsLkJhY2tncm91bmRQb3NpdGlvbihlbCwgYm91bmRzLCBpbWFnZSk7DQoNCiAgICAgICAgICAgIC8vIFRPRE8gYWRkIHN1cHBvcnQgZm9yIGJhY2tncm91bmQtb3JpZ2luDQogICAgICAgICAgICBpZiAoIGltYWdlICl7DQogICAgICAgICAgICAgICAgc3dpdGNoICggYmFja2dyb3VuZF9yZXBlYXQgKSB7DQoNCiAgICAgICAgICAgICAgICAgICAgY2FzZSAicmVwZWF0LXgiOg0KICAgICAgICAgICAgICAgICAgICAgICAgcmVuZGVyQmFja2dyb3VuZFJlcGVhdFgoIGN0eCwgaW1hZ2UsIGJncCwgYm91bmRzLmxlZnQsIGJvdW5kcy50b3AsIGJvdW5kcy53aWR0aCwgYm91bmRzLmhlaWdodCApOw0KICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7DQoNCiAgICAgICAgICAgICAgICAgICAgY2FzZSAicmVwZWF0LXkiOg0KICAgICAgICAgICAgICAgICAgICAgICAgcmVuZGVyQmFja2dyb3VuZFJlcGVhdFkoIGN0eCwgaW1hZ2UsIGJncCwgYm91bmRzLmxlZnQsIGJvdW5kcy50b3AsIGJvdW5kcy53aWR0aCwgYm91bmRzLmhlaWdodCApOw0KICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7DQoNCiAgICAgICAgICAgICAgICAgICAgY2FzZSAibm8tcmVwZWF0IjoNCiAgICAgICAgICAgICAgICAgICAgICAgIC8qDQogICAgICAgICAgICAgICAgICAgIHRoaXMuZHJhd0JhY2tncm91bmRSZXBlYXQoDQogICAgICAgICAgICAgICAgICAgICAgICBjdHgsDQogICAgICAgICAgICAgICAgICAgICAgICBpbWFnZSwNCiAgICAgICAgICAgICAgICAgICAgICAgIGJncC5sZWZ0K2JvdW5kcy5sZWZ0LCAvLyBzeA0KICAgICAgICAgICAgICAgICAgICAgICAgYmdwLnRvcCtib3VuZHMudG9wLCAvLyBzeQ0KICAgICAgICAgICAgICAgICAgICAgICAgTWF0aC5taW4oYm91bmRzLndpZHRoLGltYWdlLndpZHRoKSwNCiAgICAgICAgICAgICAgICAgICAgICAgIE1hdGgubWluKGJvdW5kcy5oZWlnaHQsaW1hZ2UuaGVpZ2h0KSwNCiAgICAgICAgICAgICAgICAgICAgICAgIGJvdW5kcy5sZWZ0LA0KICAgICAgICAgICAgICAgICAgICAgICAgYm91bmRzLnRvcA0KICAgICAgICAgICAgICAgICAgICAgICAgKTsqLw0KDQoNCiAgICAgICAgICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgICAgICAgICBiZ3cgPSBib3VuZHMud2lkdGggLSBiZ3AubGVmdDsNCiAgICAgICAgICAgICAgICAgICAgICAgIGJnaCA9IGJvdW5kcy5oZWlnaHQgLSBiZ3AudG9wOw0KICAgICAgICAgICAgICAgICAgICAgICAgYmdzeCA9IGJncC5sZWZ0Ow0KICAgICAgICAgICAgICAgICAgICAgICAgYmdzeSA9IGJncC50b3A7DQogICAgICAgICAgICAgICAgICAgICAgICBiZ2R4ID0gYmdwLmxlZnQrYm91bmRzLmxlZnQ7DQogICAgICAgICAgICAgICAgICAgICAgICBiZ2R5ID0gYmdwLnRvcCtib3VuZHMudG9wOw0KDQogICAgICAgICAgICAgICAgICAgICAgICAvLw0KICAgICAgICAgICAgICAgICAgICAgICAgLy8gICAgIGJndyA9IE1hdGgubWluKGJndyxpbWFnZS53aWR0aCk7DQogICAgICAgICAgICAgICAgICAgICAgICAvLyAgYmdoID0gTWF0aC5taW4oYmdoLGltYWdlLmhlaWdodCk7DQoNCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChiZ3N4PDApew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJnc3ggPSBNYXRoLmFicyhiZ3N4KTsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBiZ2R4ICs9IGJnc3g7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgYmd3ID0gTWF0aC5taW4oYm91bmRzLndpZHRoLGltYWdlLndpZHRoLWJnc3gpOw0KICAgICAgICAgICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgYmd3ID0gTWF0aC5taW4oYmd3LGltYWdlLndpZHRoKTsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBiZ3N4ID0gMDsNCiAgICAgICAgICAgICAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGJnc3k8MCl7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgYmdzeSA9IE1hdGguYWJzKGJnc3kpOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJnZHkgKz0gYmdzeTsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBiZ2ggPSBiZ2gtYmdzeTsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBiZ2ggPSBNYXRoLm1pbihib3VuZHMuaGVpZ2h0LGltYWdlLmhlaWdodC1iZ3N5KTsNCiAgICAgICAgICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJnaCA9IE1hdGgubWluKGJnaCxpbWFnZS5oZWlnaHQpOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJnc3kgPSAwOw0KICAgICAgICAgICAgICAgICAgICAgICAgfQ0KDQoNCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChiZ2g+MCAmJiBiZ3cgPiAwKXsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZW5kZXJJbWFnZSgNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3R4LA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbWFnZSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYmdzeCwgLy8gc291cmNlIFggOiAwDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJnc3ksIC8vIHNvdXJjZSBZIDogMTY5NQ0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiZ3csIC8vIHNvdXJjZSBXaWR0aCA6IDE4DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJnaCwgLy8gc291cmNlIEhlaWdodCA6IDE2NzcNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYmdkeCwgLy8gZGVzdGluYXRpb24gWCA6OTA2DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJnZHksIC8vIGRlc3RpbmF0aW9uIFkgOiAxMDIwDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJndywgLy8gZGVzdGluYXRpb24gd2lkdGggOiAxOA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiZ2ggLy8gZGVzdGluYXRpb24gaGVpZ2h0IDogMTY3Nw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApOw0KDQogICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgICAgICAgICAgZGVmYXVsdDoNCg0KDQoNCiAgICAgICAgICAgICAgICAgICAgICAgIGJncC50b3AgPSBiZ3AudG9wLU1hdGguY2VpbChiZ3AudG9wL2ltYWdlLmhlaWdodCkqaW1hZ2UuaGVpZ2h0Ow0KDQoNCiAgICAgICAgICAgICAgICAgICAgICAgIGZvcihiZ3k9KGJvdW5kcy50b3ArYmdwLnRvcCk7Ymd5PGJvdW5kcy5oZWlnaHQrYm91bmRzLnRvcDspew0KDQoNCg0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGggPSBNYXRoLm1pbihpbWFnZS5oZWlnaHQsKGJvdW5kcy5oZWlnaHQrYm91bmRzLnRvcCktYmd5KTsNCg0KDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCBNYXRoLmZsb29yKGJneStpbWFnZS5oZWlnaHQpPmgrYmd5KXsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaGVpZ2h0ID0gKGgrYmd5KS1iZ3k7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhlaWdodCA9IGltYWdlLmhlaWdodDsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gY29uc29sZS5sb2coaGVpZ2h0KTsNCg0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChiZ3k8Ym91bmRzLnRvcCl7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFkZCA9IGJvdW5kcy50b3AtYmd5Ow0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiZ3kgPSBib3VuZHMudG9wOw0KDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFkZCA9IDA7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVuZGVyQmFja2dyb3VuZFJlcGVhdFgoY3R4LGltYWdlLGJncCxib3VuZHMubGVmdCxiZ3ksYm91bmRzLndpZHRoLGhlaWdodCk7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGFkZD4wKXsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYmdwLnRvcCArPSBhZGQ7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJneSA9IE1hdGguZmxvb3IoYmd5K2ltYWdlLmhlaWdodCktYWRkOw0KICAgICAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7DQoNCg0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgIGgyY2xvZygiaHRtbDJjYW52YXM6IEVycm9yIGxvYWRpbmcgYmFja2dyb3VuZDoiICsgYmFja2dyb3VuZF9pbWFnZSk7DQogICAgICAgICAgICAvL2NvbnNvbGUubG9nKGltYWdlcyk7DQogICAgICAgICAgICB9DQoNCiAgICAgICAgfQ0KICAgIH0NCg0KDQoNCiAgICBmdW5jdGlvbiByZW5kZXJFbGVtZW50KGVsLCBwYXJlbnRTdGFjayl7DQoNCiAgICAgICAgdmFyIGJvdW5kcyA9IF9odG1sMmNhbnZhcy5VdGlsLkJvdW5kcyhlbCksDQogICAgICAgIHggPSBib3VuZHMubGVmdCwNCiAgICAgICAgeSA9IGJvdW5kcy50b3AsDQogICAgICAgIHcgPSBib3VuZHMud2lkdGgsDQogICAgICAgIGggPSBib3VuZHMuaGVpZ2h0LA0KICAgICAgICBpbWFnZSwNCiAgICAgICAgYmdjb2xvciA9IGdldENTUyhlbCwgImJhY2tncm91bmRDb2xvciIpLA0KICAgICAgICBjc3NQb3NpdGlvbiA9IGdldENTUyhlbCwgInBvc2l0aW9uIiksDQogICAgICAgIHppbmRleCwNCiAgICAgICAgb3BhY2l0eSA9IGdldENTUyhlbCwgIm9wYWNpdHkiKSwNCiAgICAgICAgc3RhY2ssDQogICAgICAgIHN0YWNrTGVuZ3RoLA0KICAgICAgICBib3JkZXJzLA0KICAgICAgICBjdHgsDQogICAgICAgIGJnYm91bmRzLA0KICAgICAgICBpbWdTcmMsDQogICAgICAgIHBhZGRpbmdMZWZ0LA0KICAgICAgICBwYWRkaW5nVG9wLA0KICAgICAgICBwYWRkaW5nUmlnaHQsDQogICAgICAgIHBhZGRpbmdCb3R0b207DQoNCiAgICAgICAgaWYgKCFwYXJlbnRTdGFjayl7DQogICAgICAgICAgICBkb2NEaW0gPSBkb2NTaXplKCk7DQogICAgICAgICAgICBwYXJlbnRTdGFjayA9IHsNCiAgICAgICAgICAgICAgICBvcGFjaXR5OiAxDQogICAgICAgICAgICB9Ow0KICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgIGRvY0RpbSA9IHt9Ow0KICAgICAgICB9DQoNCg0KICAgICAgICAvL3ZhciB6aW5kZXggPSB0aGlzLmZvcm1hdFoodGhpcy5nZXRDU1MoZWwsInpJbmRleCIpLGNzc1Bvc2l0aW9uLHBhcmVudFN0YWNrLnpJbmRleCxlbC5wYXJlbnROb2RlKTsNCg0KICAgICAgICB6aW5kZXggPSBzZXRaKCBnZXRDU1MoIGVsLCAiekluZGV4IiksIHBhcmVudFN0YWNrLnpJbmRleCApOw0KDQoNCg0KICAgICAgICBzdGFjayA9IHsNCiAgICAgICAgICAgIGN0eDogaDJjUmVuZGVyQ29udGV4dCggZG9jRGltLndpZHRoIHx8IHcgLCBkb2NEaW0uaGVpZ2h0IHx8IGggKSwNCiAgICAgICAgICAgIHpJbmRleDogemluZGV4LA0KICAgICAgICAgICAgb3BhY2l0eTogb3BhY2l0eSAqIHBhcmVudFN0YWNrLm9wYWNpdHksDQogICAgICAgICAgICBjc3NQb3NpdGlvbjogY3NzUG9zaXRpb24NCiAgICAgICAgfTsNCg0KDQoNCiAgICAgICAgLy8gVE9ETyBjb3JyZWN0IG92ZXJmbG93IGZvciBhYnNvbHV0ZSBjb250ZW50IHJlc2lkaW5nIHVuZGVyIGEgc3RhdGljIHBvc2l0aW9uDQoNCiAgICAgICAgaWYgKHBhcmVudFN0YWNrLmNsaXApew0KICAgICAgICAgICAgc3RhY2suY2xpcCA9IF9odG1sMmNhbnZhcy5VdGlsLkV4dGVuZCgge30sIHBhcmVudFN0YWNrLmNsaXAgKTsNCiAgICAgICAgLy9zdGFjay5jbGlwID0gcGFyZW50U3RhY2suY2xpcDsNCiAgICAgICAgLy8gICBzdGFjay5jbGlwLmhlaWdodCA9IHN0YWNrLmNsaXAuaGVpZ2h0IC0gcGFyZW50U3RhY2suYm9yZGVyc1syXS53aWR0aDsNCiAgICAgICAgfQ0KDQoNCiAgICAgICAgaWYgKCBvcHRpb25zLnVzZU92ZXJmbG93ID09PSB0cnVlICYmIC8oaGlkZGVufHNjcm9sbHxhdXRvKS8udGVzdChnZXRDU1MoZWwsICJvdmVyZmxvdyIpKSA9PT0gdHJ1ZSAmJiAvKEJPRFkpL2kudGVzdChlbC5ub2RlTmFtZSkgPT09IGZhbHNlICl7DQogICAgICAgICAgICBpZiAoc3RhY2suY2xpcCl7DQogICAgICAgICAgICAgICAgc3RhY2suY2xpcCA9IGNsaXBCb3VuZHMoc3RhY2suY2xpcCwgYm91bmRzKTsNCiAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgIHN0YWNrLmNsaXAgPSBib3VuZHM7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCg0KDQogICAgICAgIHN0YWNrTGVuZ3RoID0gIHppbmRleC5jaGlsZHJlbi5wdXNoKHN0YWNrKTsNCg0KICAgICAgICBjdHggPSB6aW5kZXguY2hpbGRyZW5bc3RhY2tMZW5ndGgtMV0uY3R4Ow0KDQogICAgICAgIGN0eC5zZXRWYXJpYWJsZSgiZ2xvYmFsQWxwaGEiLCBzdGFjay5vcGFjaXR5KTsNCg0KICAgICAgICAvLyBkcmF3IGVsZW1lbnQgYm9yZGVycw0KICAgICAgICBib3JkZXJzID0gcmVuZGVyQm9yZGVycyhlbCwgY3R4LCBib3VuZHMsIGZhbHNlKTsNCiAgICAgICAgc3RhY2suYm9yZGVycyA9IGJvcmRlcnM7DQoNCg0KICAgICAgICAvLyBsZXQncyBtb2RpZnkgY2xpcCBhcmVhIGZvciBjaGlsZCBlbGVtZW50cywgc28gYm9yZGVycyBkb250IGdldCBvdmVyd3JpdHRlbg0KDQogICAgICAgIC8qDQogICAgaWYgKHN0YWNrLmNsaXApew0KICAgICAgICBzdGFjay5jbGlwLndpZHRoID0gc3RhY2suY2xpcC53aWR0aC0oYm9yZGVyc1sxXS53aWR0aCk7DQogICAgICAgIHN0YWNrLmNsaXAuaGVpZ2h0ID0gc3RhY2suY2xpcC5oZWlnaHQtKGJvcmRlcnNbMl0ud2lkdGgpOw0KICAgIH0NCiAgICAgKi8NCiAgICAgICAgaWYgKGlnbm9yZUVsZW1lbnRzUmVnRXhwLnRlc3QoZWwubm9kZU5hbWUpICYmIG9wdGlvbnMuaWZyYW1lRGVmYXVsdCAhPT0gInRyYW5zcGFyZW50Iil7DQogICAgICAgICAgICBpZiAob3B0aW9ucy5pZnJhbWVEZWZhdWx0ID09PSAiZGVmYXVsdCIpew0KICAgICAgICAgICAgICAgIGJnY29sb3IgPSAiI2VmZWZlZiI7DQogICAgICAgICAgICB9ZWxzZXsNCiAgICAgICAgICAgICAgICBiZ2NvbG9yID0gb3B0aW9ucy5pZnJhbWVEZWZhdWx0Ow0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQoNCiAgICAgICAgLy8gZHJhdyBiYXNlIGVsZW1lbnQgYmdjb2xvcg0KDQogICAgICAgIGJnYm91bmRzID0gew0KICAgICAgICAgICAgbGVmdDogeCArIGJvcmRlcnNbM10ud2lkdGgsDQogICAgICAgICAgICB0b3A6IHkgKyBib3JkZXJzWzBdLndpZHRoLA0KICAgICAgICAgICAgd2lkdGg6IHcgLSAoYm9yZGVyc1sxXS53aWR0aCArIGJvcmRlcnNbM10ud2lkdGgpLA0KICAgICAgICAgICAgaGVpZ2h0OiBoIC0gKGJvcmRlcnNbMF0ud2lkdGggKyBib3JkZXJzWzJdLndpZHRoKQ0KICAgICAgICB9Ow0KDQogICAgICAgIC8vaWYgKHRoaXMud2l0aGluQm91bmRzKHN0YWNrLmNsaXAsYmdib3VuZHMpKXsNCg0KICAgICAgICBpZiAoc3RhY2suY2xpcCl7DQogICAgICAgICAgICBiZ2JvdW5kcyA9IGNsaXBCb3VuZHMoYmdib3VuZHMsIHN0YWNrLmNsaXApOw0KDQogICAgICAgIC8vfQ0KDQogICAgICAgIH0NCg0KDQogICAgICAgIGlmIChiZ2JvdW5kcy5oZWlnaHQgPiAwICYmIGJnYm91bmRzLndpZHRoID4gMCl7DQogICAgICAgICAgICByZW5kZXJSZWN0KA0KICAgICAgICAgICAgICAgIGN0eCwNCiAgICAgICAgICAgICAgICBiZ2JvdW5kcy5sZWZ0LA0KICAgICAgICAgICAgICAgIGJnYm91bmRzLnRvcCwNCiAgICAgICAgICAgICAgICBiZ2JvdW5kcy53aWR0aCwNCiAgICAgICAgICAgICAgICBiZ2JvdW5kcy5oZWlnaHQsDQogICAgICAgICAgICAgICAgYmdjb2xvcg0KICAgICAgICAgICAgICAgICk7DQoNCiAgICAgICAgICAgIHJlbmRlckJhY2tncm91bmQoZWwsIGJnYm91bmRzLCBjdHgpOw0KICAgICAgICB9DQoNCiAgICAgICAgc3dpdGNoKGVsLm5vZGVOYW1lKXsNCiAgICAgICAgICAgIGNhc2UgIklNRyI6DQogICAgICAgICAgICAgICAgaW1nU3JjID0gZWwuZ2V0QXR0cmlidXRlKCdzcmMnKTsNCiAgICAgICAgICAgICAgICBpbWFnZSA9IGxvYWRJbWFnZShpbWdTcmMpOw0KICAgICAgICAgICAgICAgIGlmIChpbWFnZSl7DQoNCiAgICAgICAgICAgICAgICAgICAgcGFkZGluZ0xlZnQgPSBnZXRDU1NJbnQoZWwsICdwYWRkaW5nTGVmdCcpOw0KICAgICAgICAgICAgICAgICAgICBwYWRkaW5nVG9wID0gZ2V0Q1NTSW50KGVsLCAncGFkZGluZ1RvcCcpOw0KICAgICAgICAgICAgICAgICAgICBwYWRkaW5nUmlnaHQgPSBnZXRDU1NJbnQoZWwsICdwYWRkaW5nUmlnaHQnKTsNCiAgICAgICAgICAgICAgICAgICAgcGFkZGluZ0JvdHRvbSA9IGdldENTU0ludChlbCwgJ3BhZGRpbmdCb3R0b20nKTsNCg0KDQogICAgICAgICAgICAgICAgICAgIHJlbmRlckltYWdlKA0KICAgICAgICAgICAgICAgICAgICAgICAgY3R4LA0KICAgICAgICAgICAgICAgICAgICAgICAgaW1hZ2UsDQogICAgICAgICAgICAgICAgICAgICAgICAwLCAvL3N4DQogICAgICAgICAgICAgICAgICAgICAgICAwLCAvL3N5DQogICAgICAgICAgICAgICAgICAgICAgICBpbWFnZS53aWR0aCwgLy9zdw0KICAgICAgICAgICAgICAgICAgICAgICAgaW1hZ2UuaGVpZ2h0LCAvL3NoDQogICAgICAgICAgICAgICAgICAgICAgICB4ICsgcGFkZGluZ0xlZnQgKyBib3JkZXJzWzNdLndpZHRoLCAvL2R4DQogICAgICAgICAgICAgICAgICAgICAgICB5ICsgcGFkZGluZ1RvcCArIGJvcmRlcnNbMF0ud2lkdGgsIC8vIGR5DQogICAgICAgICAgICAgICAgICAgICAgICBib3VuZHMud2lkdGggLSAoYm9yZGVyc1sxXS53aWR0aCArIGJvcmRlcnNbM10ud2lkdGggKyBwYWRkaW5nTGVmdCArIHBhZGRpbmdSaWdodCksIC8vZHcNCiAgICAgICAgICAgICAgICAgICAgICAgIGJvdW5kcy5oZWlnaHQgLSAoYm9yZGVyc1swXS53aWR0aCArIGJvcmRlcnNbMl0ud2lkdGggKyBwYWRkaW5nVG9wICsgcGFkZGluZ0JvdHRvbSkgLy9kaA0KICAgICAgICAgICAgICAgICAgICAgICAgKTsNCg0KICAgICAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgICAgICBoMmNsb2coImh0bWwyY2FudmFzOiBFcnJvciBsb2FkaW5nIDxpbWc+OiIgKyBpbWdTcmMpOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgIGNhc2UgIklOUFVUIjoNCiAgICAgICAgICAgICAgICAvLyBUT0RPIGFkZCBhbGwgcmVsZXZhbnQgdHlwZSdzLCBpLmUuIEhUTUw1IG5ldyBzdHVmZg0KICAgICAgICAgICAgICAgIC8vIHRvZG8gYWRkIHN1cHBvcnQgZm9yIHBsYWNlaG9sZGVyIGF0dHJpYnV0ZSBmb3IgYnJvd3NlcnMgd2hpY2ggc3VwcG9ydCBpdA0KICAgICAgICAgICAgICAgIGlmICgvXih0ZXh0fHVybHxlbWFpbHxzdWJtaXR8YnV0dG9ufHJlc2V0KSQvLnRlc3QoZWwudHlwZSkgJiYgZWwudmFsdWUubGVuZ3RoID4gMCl7DQoNCiAgICAgICAgICAgICAgICAgICAgcmVuZGVyRm9ybVZhbHVlKGVsLCBib3VuZHMsIHN0YWNrKTsNCg0KDQogICAgICAgICAgICAgICAgLyoNCiAgICAgICAgICAgICAgICAgdGhpcyBqdXN0IGRvZXNuJ3Qgd29yayB3ZWxsIGVub3VnaA0KDQogICAgICAgICAgICAgICAgdGhpcy5uZXdUZXh0KGVsLHsNCiAgICAgICAgICAgICAgICAgICAgbm9kZVZhbHVlOmVsLnZhbHVlLA0KICAgICAgICAgICAgICAgICAgICBzcGxpdFRleHQ6IGZ1bmN0aW9uKCl7DQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgICAgICAgICAgICAgICAgfSwNCiAgICAgICAgICAgICAgICAgICAgZm9ybVZhbHVlOnRydWUNCiAgICAgICAgICAgICAgICB9LHN0YWNrKTsNCiAgICAgICAgICAgICAgICAgKi8NCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICBjYXNlICJURVhUQVJFQSI6DQogICAgICAgICAgICAgICAgaWYgKGVsLnZhbHVlLmxlbmd0aCA+IDApew0KICAgICAgICAgICAgICAgICAgICByZW5kZXJGb3JtVmFsdWUoZWwsIGJvdW5kcywgc3RhY2spOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgIGNhc2UgIlNFTEVDVCI6DQogICAgICAgICAgICAgICAgaWYgKGVsLm9wdGlvbnMubGVuZ3RoID4gMCl7DQogICAgICAgICAgICAgICAgICAgIHJlbmRlckZvcm1WYWx1ZShlbCwgYm91bmRzLCBzdGFjayk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgY2FzZSAiTEkiOg0KICAgICAgICAgICAgICAgIHJlbmRlckxpc3RJdGVtKGVsLCBzdGFjaywgYmdib3VuZHMpOw0KICAgICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgY2FzZSAiQ0FOVkFTIjoNCiAgICAgICAgICAgICAgICBwYWRkaW5nTGVmdCA9IGdldENTU0ludChlbCwgJ3BhZGRpbmdMZWZ0Jyk7DQogICAgICAgICAgICAgICAgcGFkZGluZ1RvcCA9IGdldENTU0ludChlbCwgJ3BhZGRpbmdUb3AnKTsNCiAgICAgICAgICAgICAgICBwYWRkaW5nUmlnaHQgPSBnZXRDU1NJbnQoZWwsICdwYWRkaW5nUmlnaHQnKTsNCiAgICAgICAgICAgICAgICBwYWRkaW5nQm90dG9tID0gZ2V0Q1NTSW50KGVsLCAncGFkZGluZ0JvdHRvbScpOw0KICAgICAgICAgICAgICAgIHJlbmRlckltYWdlKA0KICAgICAgICAgICAgICAgICAgICBjdHgsDQogICAgICAgICAgICAgICAgICAgIGVsLA0KICAgICAgICAgICAgICAgICAgICAwLCAvL3N4DQogICAgICAgICAgICAgICAgICAgIDAsIC8vc3kNCiAgICAgICAgICAgICAgICAgICAgZWwud2lkdGgsIC8vc3cNCiAgICAgICAgICAgICAgICAgICAgZWwuaGVpZ2h0LCAvL3NoDQogICAgICAgICAgICAgICAgICAgIHggKyBwYWRkaW5nTGVmdCArIGJvcmRlcnNbM10ud2lkdGgsIC8vZHgNCiAgICAgICAgICAgICAgICAgICAgeSArIHBhZGRpbmdUb3AgKyBib3JkZXJzWzBdLndpZHRoLCAvLyBkeQ0KICAgICAgICAgICAgICAgICAgICBib3VuZHMud2lkdGggLSAoYm9yZGVyc1sxXS53aWR0aCArIGJvcmRlcnNbM10ud2lkdGggKyBwYWRkaW5nTGVmdCArIHBhZGRpbmdSaWdodCksIC8vZHcNCiAgICAgICAgICAgICAgICAgICAgYm91bmRzLmhlaWdodCAtIChib3JkZXJzWzBdLndpZHRoICsgYm9yZGVyc1syXS53aWR0aCArIHBhZGRpbmdUb3AgKyBwYWRkaW5nQm90dG9tKSAvL2RoDQogICAgICAgICAgICAgICAgICAgICk7DQogICAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgIH0NCg0KICAgICAgICByZXR1cm4gemluZGV4LmNoaWxkcmVuW3N0YWNrTGVuZ3RoIC0gMV07DQogICAgfQ0KDQoNCg0KICAgIGZ1bmN0aW9uIHBhcnNlRWxlbWVudCAoZWwsIHN0YWNrKSB7DQoNCiAgICAgICAgLy8gc2tpcCBoaWRkZW4gZWxlbWVudHMgYW5kIHRoZWlyIGNoaWxkcmVuDQogICAgICAgIGlmIChnZXRDU1MoZWwsICdkaXNwbGF5JykgIT09ICJub25lIiAmJiBnZXRDU1MoZWwsICd2aXNpYmlsaXR5JykgIT09ICJoaWRkZW4iKSB7DQoNCiAgICAgICAgICAgIHN0YWNrID0gcmVuZGVyRWxlbWVudChlbCwgc3RhY2spIHx8IHN0YWNrOw0KDQogICAgICAgICAgICBjdHggPSBzdGFjay5jdHg7DQoNCiAgICAgICAgICAgIGlmICggIWlnbm9yZUVsZW1lbnRzUmVnRXhwLnRlc3QoIGVsLm5vZGVOYW1lICkgKSB7DQogICAgICAgICAgICAgICAgdmFyIGVsZW1lbnRDaGlsZHJlbiA9IF9odG1sMmNhbnZhcy5VdGlsLkNoaWxkcmVuKCBlbCApLA0KICAgICAgICAgICAgICAgIGksDQogICAgICAgICAgICAgICAgbm9kZSwNCiAgICAgICAgICAgICAgICBjaGlsZHJlbkxlbjsNCiAgICAgICAgICAgICAgICBmb3IgKGkgPSAwLCBjaGlsZHJlbkxlbiA9IGVsZW1lbnRDaGlsZHJlbi5sZW5ndGg7IGkgPCBjaGlsZHJlbkxlbjsgaSs9MSkgew0KICAgICAgICAgICAgICAgICAgICBub2RlID0gZWxlbWVudENoaWxkcmVuW2ldOw0KDQogICAgICAgICAgICAgICAgICAgIGlmICggbm9kZS5ub2RlVHlwZSA9PT0gMSApIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIHBhcnNlRWxlbWVudChub2RlLCBzdGFjayk7DQogICAgICAgICAgICAgICAgICAgIH1lbHNlIGlmICggbm9kZS5ub2RlVHlwZSA9PT0gMyApIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIHJlbmRlclRleHQoZWwsIG5vZGUsIHN0YWNrKTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICB9DQogICAgICAgIH0gDQogICAgfQ0KDQogICAgc3RhY2sgPSByZW5kZXJFbGVtZW50KGVsZW1lbnQsIG51bGwpOw0KDQogICAgLyoNCiAgICBTVkcgcG93ZXJlZCBIVE1MIHJlbmRlcmluZywgbm9uLXRhaW50ZWQgY2FudmFzIGF2YWlsYWJsZSBmcm9tIEZGIDExKyBvbndhcmRzDQogICAgKi8NCg0KICAgIGlmICggc3VwcG9ydC5zdmdSZW5kZXJpbmcgKSB7DQogICAgICAgIChmdW5jdGlvbiggYm9keSApew0KICAgICAgICAgICAgdmFyIGltZyA9IG5ldyBJbWFnZSgpLA0KICAgICAgICAgICAgc2l6ZSA9ICBkb2NTaXplKCksDQogICAgICAgICAgICBodG1sID0gIiI7DQoNCiAgICAgICAgICAgIGZ1bmN0aW9uIHBhcnNlRE9NKCBlbCApIHsNCiAgICAgICAgICAgICAgICB2YXIgY2hpbGRyZW4gPSBfaHRtbDJjYW52YXMuVXRpbC5DaGlsZHJlbiggZWwgKSwNCiAgICAgICAgICAgICAgICBsZW4gPSBjaGlsZHJlbi5sZW5ndGgsDQogICAgICAgICAgICAgICAgYXR0ciwNCiAgICAgICAgICAgICAgICBhLA0KICAgICAgICAgICAgICAgIGFsZW4sDQogICAgICAgICAgICAgICAgZWxtLA0KICAgICAgICAgICAgICAgIGk7DQogICAgICAgICAgICAgICAgZm9yICggaSA9IDA7IGkgPCBsZW47IGkrPTEgKSB7DQogICAgICAgICAgICAgICAgICAgIGVsbSA9IGNoaWxkcmVuWyBpIF07DQogICAgICAgICAgICAgICAgICAgIGlmICggZWxtLm5vZGVUeXBlID09PSAzICkgew0KICAgICAgICAgICAgICAgICAgICAgICAgLy8gVGV4dCBub2RlDQoNCiAgICAgICAgICAgICAgICAgICAgICAgIGh0bWwgKz0gZWxtLm5vZGVWYWx1ZS5yZXBsYWNlKC9cPC9nLCImbHQ7IikucmVwbGFjZSgvXD4vZywiJmd0OyIpOw0KICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCBlbG0ubm9kZVR5cGUgPT09IDEgKSB7DQogICAgICAgICAgICAgICAgICAgICAgICAvLyBFbGVtZW50DQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoICEvXihzY3JpcHR8bWV0YXx0aXRsZSkkLy50ZXN0KGVsbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpKSApIHsNCg0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGh0bWwgKz0gIjwiICsgZWxtLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCk7DQoNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBhZGQgYXR0cmlidXRlcw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICggZWxtLmhhc0F0dHJpYnV0ZXMoKSApIHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXR0ciA9IGVsbS5hdHRyaWJ1dGVzOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbGVuID0gYXR0ci5sZW5ndGg7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoIGEgPSAwOyBhIDwgYWxlbjsgYSs9MSApIHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGh0bWwgKz0gIiAiICsgYXR0clsgYSBdLm5hbWUgKyAnPSInICsgYXR0clsgYSBdLnZhbHVlICsgJyInOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQ0KDQoNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBodG1sICs9ICc+JzsNCg0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcnNlRE9NKCBlbG0gKTsNCg0KDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaHRtbCArPSAiPC8iICsgZWxtLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgKyAiPiI7DQogICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICBwYXJzZURPTSggYm9keSApOw0KICAgICAgICAgICAgaW1nLnNyYyA9IFsNCiAgICAgICAgICAgICJkYXRhOmltYWdlL3N2Zyt4bWwsIiwNCiAgICAgICAgICAgICI8c3ZnIHhtbG5zPSdodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZycgdmVyc2lvbj0nMS4xJyB3aWR0aD0nIiArIHNpemUud2lkdGggKyAiJyBoZWlnaHQ9JyIgKyBzaXplLmhlaWdodCArICInPiIsDQogICAgICAgICAgICAiPGZvcmVpZ25PYmplY3Qgd2lkdGg9JyIgKyBzaXplLndpZHRoICsgIicgaGVpZ2h0PSciICsgc2l6ZS5oZWlnaHQgKyAiJz4iLA0KICAgICAgICAgICAgIjxodG1sIHhtbG5zPSdodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hodG1sJyBzdHlsZT0nbWFyZ2luOjA7Jz4iLA0KICAgICAgICAgICAgaHRtbC5yZXBsYWNlKC9cIy9nLCIlMjMiKSwNCiAgICAgICAgICAgICI8L2h0bWw+IiwNCiAgICAgICAgICAgICI8L2ZvcmVpZ25PYmplY3Q+IiwNCiAgICAgICAgICAgICI8L3N2Zz4iDQogICAgICAgICAgICBdLmpvaW4oIiIpOw0KDQoNCg0KDQogICAgICAgICAgICBpbWcub25sb2FkID0gZnVuY3Rpb24oKSB7DQogICAgICAgICAgICAgICAgc3RhY2suc3ZnUmVuZGVyID0gaW1nOw0KICAgICAgICAgICAgfTsNCg0KICAgICAgICB9KSggZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50ICk7DQoNCiAgICB9DQoNCg0KICAgIC8vIHBhcnNlIGV2ZXJ5IGNoaWxkIGVsZW1lbnQNCiAgICBmb3IgKGkgPSAwLCBjaGlsZHJlbiA9IGVsZW1lbnQuY2hpbGRyZW4sIGNoaWxkcmVuTGVuID0gY2hpbGRyZW4ubGVuZ3RoOyBpIDwgY2hpbGRyZW5MZW47IGkrPTEpew0KICAgICAgICBwYXJzZUVsZW1lbnQoY2hpbGRyZW5baV0sIHN0YWNrKTsNCiAgICB9DQoNCg0KICAgIHN0YWNrLmJhY2tncm91bmRDb2xvciA9IGdldENTUyggZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LCAiYmFja2dyb3VuZENvbG9yIiApOw0KDQogICAgcmV0dXJuIHN0YWNrOw0KDQp9Ow0KDQpmdW5jdGlvbiBoMmN6Q29udGV4dCh6aW5kZXgpIHsNCiAgICByZXR1cm4gew0KICAgICAgICB6aW5kZXg6IHppbmRleCwNCiAgICAgICAgY2hpbGRyZW46IFtdDQogICAgfTsNCn0NCg0KLyoNCiAgaHRtbDJjYW52YXMgdjAuMzQgPGh0dHA6Ly9odG1sMmNhbnZhcy5oZXJ0emVuLmNvbT4NCiAgQ29weXJpZ2h0IChjKSAyMDExIE5pa2xhcyB2b24gSGVydHplbi4gQWxsIHJpZ2h0cyByZXNlcnZlZC4NCiAgaHR0cDovL3d3dy50d2l0dGVyLmNvbS9uaWtsYXN2aA0KDQogIFJlbGVhc2VkIHVuZGVyIE1JVCBMaWNlbnNlDQogKi8NCg0KX2h0bWwyY2FudmFzLlByZWxvYWQgPSBmdW5jdGlvbiggb3B0aW9ucyApIHsNCg0KICAgIHZhciBpbWFnZXMgPSB7DQogICAgICAgIG51bUxvYWRlZDogMCwgICAvLyBhbHNvIGZhaWxlZCBhcmUgY291bnRlZCBoZXJlDQogICAgICAgIG51bUZhaWxlZDogMCwNCiAgICAgICAgbnVtVG90YWw6IDAsDQogICAgICAgIGNsZWFudXBEb25lOiBmYWxzZQ0KICAgIH0sDQogICAgcGFnZU9yaWdpbiwNCiAgICBtZXRob2RzLA0KICAgIGksDQogICAgY291bnQgPSAwLA0KICAgIGVsZW1lbnQgPSBvcHRpb25zLmVsZW1lbnRzWzBdIHx8IGRvY3VtZW50LmJvZHksDQogICAgZG9jID0gZWxlbWVudC5vd25lckRvY3VtZW50LA0KICAgIGRvbUltYWdlcyA9IGRvYy5pbWFnZXMsIC8vIFRPRE8gcHJvYmFibHkgc2hvdWxkIGxpbWl0IGl0IHRvIGltYWdlcyBwcmVzZW50IGluIHRoZSBlbGVtZW50IG9ubHkNCiAgICBpbWdMZW4gPSBkb21JbWFnZXMubGVuZ3RoLA0KICAgIGxpbmsgPSBkb2MuY3JlYXRlRWxlbWVudCgiYSIpLA0KICAgIHN1cHBvcnRDT1JTID0gKGZ1bmN0aW9uKCBpbWcgKXsNCiAgICAgICAgcmV0dXJuIChpbWcuY3Jvc3NPcmlnaW4gIT09IHVuZGVmaW5lZCk7DQogICAgfSkobmV3IEltYWdlKCkpLA0KICAgIHRpbWVvdXRUaW1lcjsNCg0KICAgIGxpbmsuaHJlZiA9IHdpbmRvdy5sb2NhdGlvbi5ocmVmOw0KICAgIHBhZ2VPcmlnaW4gID0gbGluay5wcm90b2NvbCArIGxpbmsuaG9zdDsNCg0KDQoNCg0KDQoNCiAgICBmdW5jdGlvbiBpc1NhbWVPcmlnaW4odXJsKXsNCiAgICAgICAgbGluay5ocmVmID0gdXJsOw0KICAgICAgICBsaW5rLmhyZWYgPSBsaW5rLmhyZWY7IC8vIFlFUywgQkVMSUVWRSBJVCBPUiBOT1QsIHRoYXQgaXMgcmVxdWlyZWQgZm9yIElFOSAtIGh0dHA6Ly9qc2ZpZGRsZS5uZXQvbmlrbGFzdmgvMmU0OGIvDQogICAgICAgIHZhciBvcmlnaW4gPSBsaW5rLnByb3RvY29sICsgbGluay5ob3N0Ow0KICAgICAgICByZXR1cm4gKG9yaWdpbiA9PT0gcGFnZU9yaWdpbik7DQogICAgfQ0KDQogICAgZnVuY3Rpb24gc3RhcnQoKXsNCiAgICAgICAgaDJjbG9nKCJodG1sMmNhbnZhczogc3RhcnQ6IGltYWdlczogIiArIGltYWdlcy5udW1Mb2FkZWQgKyAiIC8gIiArIGltYWdlcy5udW1Ub3RhbCArICIgKGZhaWxlZDogIiArIGltYWdlcy5udW1GYWlsZWQgKyAiKSIpOw0KICAgICAgICBpZiAoIWltYWdlcy5maXJzdFJ1biAmJiBpbWFnZXMubnVtTG9hZGVkID49IGltYWdlcy5udW1Ub3RhbCl7DQogICAgICAgICAgICBoMmNsb2coIkZpbmlzaGVkIGxvYWRpbmcgaW1hZ2VzOiAjICIgKyBpbWFnZXMubnVtVG90YWwgKyAiIChmYWlsZWQ6ICIgKyBpbWFnZXMubnVtRmFpbGVkICsgIikiKTsNCg0KICAgICAgICAgICAgaWYgKHR5cGVvZiBvcHRpb25zLmNvbXBsZXRlID09PSAiZnVuY3Rpb24iKXsNCiAgICAgICAgICAgICAgICBvcHRpb25zLmNvbXBsZXRlKGltYWdlcyk7DQogICAgICAgICAgICB9DQoNCiAgICAgICAgfQ0KICAgIH0NCg0KICAgIC8vIFRPRE8gbW9kaWZ5IHByb3h5IHRvIHNlcnZlIGltYWdlcyB3aXRoIENPUlMgZW5hYmxlZCwgd2hlcmUgYXZhaWxhYmxlDQogICAgZnVuY3Rpb24gcHJveHlHZXRJbWFnZSh1cmwsIGltZywgaW1hZ2VPYmopew0KICAgICAgICB2YXIgY2FsbGJhY2tfbmFtZSwNCiAgICAgICAgc2NyaXB0VXJsID0gb3B0aW9ucy5wcm94eSwNCiAgICAgICAgc2NyaXB0Ow0KDQogICAgICAgIGxpbmsuaHJlZiA9IHVybDsNCiAgICAgICAgdXJsID0gbGluay5ocmVmOyAvLyB3b3JrIGFyb3VuZCBmb3IgcGFnZXMgd2l0aCBiYXNlIGhyZWY9IiIgc2V0IC0gV0FSTklORzogdGhpcyBtYXkgY2hhbmdlIHRoZSB1cmwNCg0KICAgICAgICBjYWxsYmFja19uYW1lID0gJ2h0bWwyY2FudmFzXycgKyAoY291bnQrKyk7DQogICAgICAgIGltYWdlT2JqLmNhbGxiYWNrbmFtZSA9IGNhbGxiYWNrX25hbWU7DQoNCiAgICAgICAgaWYgKHNjcmlwdFVybC5pbmRleE9mKCI/IikgPiAtMSkgew0KICAgICAgICAgICAgc2NyaXB0VXJsICs9ICImIjsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgIHNjcmlwdFVybCArPSAiPyI7DQogICAgICAgIH0NCiAgICAgICAgc2NyaXB0VXJsICs9ICd1cmw9JyArIGVuY29kZVVSSUNvbXBvbmVudCh1cmwpICsgJyZjYWxsYmFjaz0nICsgY2FsbGJhY2tfbmFtZTsNCiAgICAgICAgc2NyaXB0ID0gZG9jLmNyZWF0ZUVsZW1lbnQoInNjcmlwdCIpOw0KDQogICAgICAgIHdpbmRvd1tjYWxsYmFja19uYW1lXSA9IGZ1bmN0aW9uKGEpew0KICAgICAgICAgICAgaWYgKGEuc3Vic3RyaW5nKDAsNikgPT09ICJlcnJvcjoiKXsNCiAgICAgICAgICAgICAgICBpbWFnZU9iai5zdWNjZWVkZWQgPSBmYWxzZTsNCiAgICAgICAgICAgICAgICBpbWFnZXMubnVtTG9hZGVkKys7DQogICAgICAgICAgICAgICAgaW1hZ2VzLm51bUZhaWxlZCsrOw0KICAgICAgICAgICAgICAgIHN0YXJ0KCk7DQogICAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgICAgIHNldEltYWdlTG9hZEhhbmRsZXJzKGltZywgaW1hZ2VPYmopOw0KICAgICAgICAgICAgICAgIGltZy5zcmMgPSBhOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgd2luZG93W2NhbGxiYWNrX25hbWVdID0gdW5kZWZpbmVkOyAvLyB0byB3b3JrIHdpdGggSUU8OSAgLy8gTk9URTogdGhhdCB0aGUgdW5kZWZpbmVkIGNhbGxiYWNrIHByb3BlcnR5LW5hbWUgc3RpbGwgZXhpc3RzIG9uIHRoZSB3aW5kb3cgb2JqZWN0IChmb3IgSUU8OSkNCiAgICAgICAgICAgIHRyeSB7DQogICAgICAgICAgICAgICAgZGVsZXRlIHdpbmRvd1tjYWxsYmFja19uYW1lXTsgIC8vIGZvciBhbGwgYnJvd3NlciB0aGF0IHN1cHBvcnQgdGhpcw0KICAgICAgICAgICAgfSBjYXRjaChleCkge30NCiAgICAgICAgICAgIHNjcmlwdC5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKHNjcmlwdCk7DQogICAgICAgICAgICBzY3JpcHQgPSBudWxsOw0KICAgICAgICAgICAgZGVsZXRlIGltYWdlT2JqLnNjcmlwdDsNCiAgICAgICAgICAgIGRlbGV0ZSBpbWFnZU9iai5jYWxsYmFja25hbWU7DQogICAgICAgIH07DQoNCiAgICAgICAgc2NyaXB0LnNldEF0dHJpYnV0ZSgidHlwZSIsICJ0ZXh0L2phdmFzY3JpcHQiKTsNCiAgICAgICAgc2NyaXB0LnNldEF0dHJpYnV0ZSgic3JjIiwgc2NyaXB0VXJsKTsNCiAgICAgICAgaW1hZ2VPYmouc2NyaXB0ID0gc2NyaXB0Ow0KICAgICAgICB3aW5kb3cuZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChzY3JpcHQpOw0KDQogICAgfQ0KDQogICAgZnVuY3Rpb24gZ2V0SW1hZ2VzIChlbCkgew0KDQoNCg0KICAgICAgICAvLyBpZiAoIXRoaXMuaWdub3JlUmUudGVzdChlbC5ub2RlTmFtZSkpew0KICAgICAgICAvLw0KICAgICAgICANCiAgICAgICAgdmFyIGNvbnRlbnRzID0gX2h0bWwyY2FudmFzLlV0aWwuQ2hpbGRyZW4oZWwpLA0KICAgICAgICBpLA0KICAgICAgICBiYWNrZ3JvdW5kX2ltYWdlLA0KICAgICAgICBzcmMsDQogICAgICAgIGltZywNCiAgICAgICAgZWxOb2RlVHlwZSA9IGZhbHNlOw0KDQogICAgICAgIC8vIEZpcmVmb3ggZmFpbHMgd2l0aCBwZXJtaXNzaW9uIGRlbmllZCBvbiBwYWdlcyB3aXRoIGlmcmFtZXMNCiAgICAgICAgdHJ5IHsNCiAgICAgICAgICAgIHZhciBjb250ZW50c0xlbiA9IGNvbnRlbnRzLmxlbmd0aDsNCiAgICAgICAgICAgIGZvciAoaSA9IDA7ICBpIDwgY29udGVudHNMZW47IGkrPTEgKXsNCiAgICAgICAgICAgICAgICAvLyB2YXIgaWduUmUgPSBuZXcgUmVnRXhwKCIoIit0aGlzLmlnbm9yZUVsZW1lbnRzKyIpIik7DQogICAgICAgICAgICAgICAgLy8gaWYgKCFpZ25SZS50ZXN0KGVsZW1lbnQubm9kZU5hbWUpKXsNCiAgICAgICAgICAgICAgICBnZXRJbWFnZXMoY29udGVudHNbaV0pOw0KICAgICAgICAgICAgICAgIC8vIH0NCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgICBjYXRjaCggZSApIHt9DQoNCg0KICAgICAgICAvLyB9DQogICAgICAgIHRyeSB7DQogICAgICAgICAgICBlbE5vZGVUeXBlID0gZWwubm9kZVR5cGU7DQogICAgICAgIH0gY2F0Y2ggKGV4KSB7DQogICAgICAgICAgICBlbE5vZGVUeXBlID0gZmFsc2U7DQogICAgICAgICAgICBoMmNsb2coImh0bWwyY2FudmFzOiBmYWlsZWQgdG8gYWNjZXNzIHNvbWUgZWxlbWVudCdzIG5vZGVUeXBlIC0gRXhjZXB0aW9uOiAiICsgZXgubWVzc2FnZSk7DQogICAgICAgIH0NCg0KICAgICAgICBpZiAoZWxOb2RlVHlwZSA9PT0gMSB8fCBlbE5vZGVUeXBlID09PSB1bmRlZmluZWQpew0KDQogICAgICAgICAgICAvLyBvcGVyYSB0aHJvd3MgZXhjZXB0aW9uIG9uIGV4dGVybmFsLWNvbnRlbnQuaHRtbA0KICAgICAgICAgICAgdHJ5IHsNCiAgICAgICAgICAgICAgICBiYWNrZ3JvdW5kX2ltYWdlID0gX2h0bWwyY2FudmFzLlV0aWwuZ2V0Q1NTKGVsLCAnYmFja2dyb3VuZEltYWdlJyk7DQogICAgICAgICAgICB9Y2F0Y2goZSkgew0KICAgICAgICAgICAgICAgIGgyY2xvZygiaHRtbDJjYW52YXM6IGZhaWxlZCB0byBnZXQgYmFja2dyb3VuZC1pbWFnZSAtIEV4Y2VwdGlvbjogIiArIGUubWVzc2FnZSk7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBpZiAoIGJhY2tncm91bmRfaW1hZ2UgJiYgYmFja2dyb3VuZF9pbWFnZSAhPT0gIjEiICYmIGJhY2tncm91bmRfaW1hZ2UgIT09ICJub25lIiApIHsNCg0KICAgICAgICAgICAgICAgIC8vIFRPRE8gYWRkIG11bHRpIGltYWdlIGJhY2tncm91bmQgc3VwcG9ydA0KDQogICAgICAgICAgICAgICAgaWYgKC9eKC13ZWJraXR8LW98LW1venwtbXN8bGluZWFyKS0vLnRlc3QoIGJhY2tncm91bmRfaW1hZ2UgKSkgew0KDQogICAgICAgICAgICAgICAgICAgIGltZyA9IF9odG1sMmNhbnZhcy5HZW5lcmF0ZS5HcmFkaWVudCggYmFja2dyb3VuZF9pbWFnZSwgX2h0bWwyY2FudmFzLlV0aWwuQm91bmRzKCBlbCApICk7DQoNCiAgICAgICAgICAgICAgICAgICAgaWYgKCBpbWcgIT09IHVuZGVmaW5lZCApew0KICAgICAgICAgICAgICAgICAgICAgICAgaW1hZ2VzW2JhY2tncm91bmRfaW1hZ2VdID0gew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGltZzogaW1nLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN1Y2NlZWRlZDogdHJ1ZQ0KICAgICAgICAgICAgICAgICAgICAgICAgfTsNCiAgICAgICAgICAgICAgICAgICAgICAgIGltYWdlcy5udW1Ub3RhbCsrOw0KICAgICAgICAgICAgICAgICAgICAgICAgaW1hZ2VzLm51bUxvYWRlZCsrOw0KICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnQoKTsNCg0KICAgICAgICAgICAgICAgICAgICB9DQoNCiAgICAgICAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgICAgICAgICBzcmMgPSBfaHRtbDJjYW52YXMuVXRpbC5iYWNrZ3JvdW5kSW1hZ2UoYmFja2dyb3VuZF9pbWFnZS5tYXRjaCgvZGF0YTppbWFnZVwvLio7YmFzZTY0LC9pKSA/IGJhY2tncm91bmRfaW1hZ2UgOiBiYWNrZ3JvdW5kX2ltYWdlLnNwbGl0KCIsIilbMF0pOw0KICAgICAgICAgICAgICAgICAgICBtZXRob2RzLmxvYWRJbWFnZShzcmMpOw0KICAgICAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgICAgIC8qDQogICAgICAgICAgICBpZiAoYmFja2dyb3VuZF9pbWFnZSAmJiBiYWNrZ3JvdW5kX2ltYWdlICE9PSAiMSIgJiYgYmFja2dyb3VuZF9pbWFnZSAhPT0gIm5vbmUiICYmIGJhY2tncm91bmRfaW1hZ2Uuc3Vic3RyaW5nKDAsNykgIT09ICItd2Via2l0IiAmJiBiYWNrZ3JvdW5kX2ltYWdlLnN1YnN0cmluZygwLDMpIT09ICItby0iICYmIGJhY2tncm91bmRfaW1hZ2Uuc3Vic3RyaW5nKDAsNCkgIT09ICItbW96Iil7DQogICAgICAgICAgICAgICAgLy8gVE9ETyBhZGQgbXVsdGkgaW1hZ2UgYmFja2dyb3VuZCBzdXBwb3J0DQogICAgICAgICAgICAgICAgc3JjID0gX2h0bWwyY2FudmFzLlV0aWwuYmFja2dyb3VuZEltYWdlKGJhY2tncm91bmRfaW1hZ2Uuc3BsaXQoIiwiKVswXSk7DQogICAgICAgICAgICAgICAgbWV0aG9kcy5sb2FkSW1hZ2Uoc3JjKTsgICAgICAgICAgICAqLw0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQogICAgfQ0KDQogICAgZnVuY3Rpb24gc2V0SW1hZ2VMb2FkSGFuZGxlcnMoaW1nLCBpbWFnZU9iaikgew0KICAgICAgICBpbWcub25sb2FkID0gZnVuY3Rpb24oKSB7DQogICAgICAgICAgICBpZiAoIGltYWdlT2JqLnRpbWVyICE9PSB1bmRlZmluZWQgKSB7DQogICAgICAgICAgICAgICAgLy8gQ09SUyBzdWNjZWVkZWQNCiAgICAgICAgICAgICAgICB3aW5kb3cuY2xlYXJUaW1lb3V0KCBpbWFnZU9iai50aW1lciApOw0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICBpbWFnZXMubnVtTG9hZGVkKys7DQogICAgICAgICAgICBpbWFnZU9iai5zdWNjZWVkZWQgPSB0cnVlOw0KICAgICAgICAgICAgaW1nLm9uZXJyb3IgPSBpbWcub25sb2FkID0gbnVsbDsNCiAgICAgICAgICAgIHN0YXJ0KCk7DQogICAgICAgIH07DQogICAgICAgIGltZy5vbmVycm9yID0gZnVuY3Rpb24oKSB7DQoNCiAgICAgICAgICAgIGlmIChpbWcuY3Jvc3NPcmlnaW4gPT09ICJhbm9ueW1vdXMiKSB7DQogICAgICAgICAgICAgICAgLy8gQ09SUyBmYWlsZWQNCiAgICAgICAgICAgICAgICB3aW5kb3cuY2xlYXJUaW1lb3V0KCBpbWFnZU9iai50aW1lciApOw0KDQogICAgICAgICAgICAgICAgLy8gbGV0J3MgdHJ5IHdpdGggcHJveHkgaW5zdGVhZA0KICAgICAgICAgICAgICAgIGlmICggb3B0aW9ucy5wcm94eSApIHsNCiAgICAgICAgICAgICAgICAgICAgdmFyIHNyYyA9IGltZy5zcmM7DQogICAgICAgICAgICAgICAgICAgIGltZyA9IG5ldyBJbWFnZSgpOw0KICAgICAgICAgICAgICAgICAgICBpbWFnZU9iai5pbWcgPSBpbWc7DQogICAgICAgICAgICAgICAgICAgIGltZy5zcmMgPSBzcmM7DQoNCiAgICAgICAgICAgICAgICAgICAgcHJveHlHZXRJbWFnZSggaW1nLnNyYywgaW1nLCBpbWFnZU9iaiApOw0KICAgICAgICAgICAgICAgICAgICByZXR1cm47DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KDQoNCiAgICAgICAgICAgIGltYWdlcy5udW1Mb2FkZWQrKzsNCiAgICAgICAgICAgIGltYWdlcy5udW1GYWlsZWQrKzsNCiAgICAgICAgICAgIGltYWdlT2JqLnN1Y2NlZWRlZCA9IGZhbHNlOw0KICAgICAgICAgICAgaW1nLm9uZXJyb3IgPSBpbWcub25sb2FkID0gbnVsbDsNCiAgICAgICAgICAgIHN0YXJ0KCk7DQoNCiAgICAgICAgfTsNCg0KICAgICAgICAvLyBUT0RPIE9wZXJhIGhhcyBubyBsb2FkL2Vycm9yIGV2ZW50IGZvciBTVkcgaW1hZ2VzDQoNCiAgICAgICAgLy8gT3BlcmEgbmluamEgb25sb2FkJ3MgY2FjaGVkIGltYWdlcw0KICAgICAgICAvKg0KICAgICAgICB3aW5kb3cuc2V0VGltZW91dChmdW5jdGlvbigpew0KICAgICAgICAgICAgaWYgKCBpbWcud2lkdGggIT09IDAgJiYgaW1hZ2VPYmouc3VjY2VlZGVkID09PSB1bmRlZmluZWQgKSB7DQogICAgICAgICAgICAgICAgaW1nLm9ubG9hZCgpOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9LCAxMDApOyAvLyBuZWVkcyBhIHJlZmxvdyBmb3IgYmFzZTY0IGVuY29kZWQgaW1hZ2VzPyBpbnRlcmVzdGluZ2x5IHRpbWVvdXQgb2YgMCBkb2Vzbid0IHdvcmsgYnV0IDEgZG9lcy4NCiAgICAgICAgICovDQogICAgfQ0KDQoNCiAgICBtZXRob2RzID0gew0KICAgICAgICBsb2FkSW1hZ2U6IGZ1bmN0aW9uKCBzcmMgKSB7DQogICAgICAgICAgICB2YXIgaW1nLCBpbWFnZU9iajsNCiAgICAgICAgICAgIGlmICggc3JjICYmIGltYWdlc1tzcmNdID09PSB1bmRlZmluZWQgKSB7DQogICAgICAgICAgICAgICAgaW1nID0gbmV3IEltYWdlKCk7DQogICAgICAgICAgICAgICAgaWYgKCBzcmMubWF0Y2goL2RhdGE6aW1hZ2VcLy4qO2Jhc2U2NCwvaSkgKSB7DQogICAgICAgICAgICAgICAgICAgIGltZy5zcmMgPSBzcmMucmVwbGFjZSgvdXJsXChbJyJdezAsfXxbJyJdezAsfVwpJC9pZywgJycpOw0KICAgICAgICAgICAgICAgICAgICBpbWFnZU9iaiA9IGltYWdlc1tzcmNdID0gew0KICAgICAgICAgICAgICAgICAgICAgICAgaW1nOiBpbWcNCiAgICAgICAgICAgICAgICAgICAgfTsNCiAgICAgICAgICAgICAgICAgICAgaW1hZ2VzLm51bVRvdGFsKys7DQogICAgICAgICAgICAgICAgICAgIHNldEltYWdlTG9hZEhhbmRsZXJzKGltZywgaW1hZ2VPYmopOw0KICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoIGlzU2FtZU9yaWdpbiggc3JjICkgfHwgb3B0aW9ucy5hbGxvd1RhaW50ID09PSAgdHJ1ZSApIHsNCiAgICAgICAgICAgICAgICAgICAgaW1hZ2VPYmogPSBpbWFnZXNbc3JjXSA9IHsNCiAgICAgICAgICAgICAgICAgICAgICAgIGltZzogaW1nDQogICAgICAgICAgICAgICAgICAgIH07DQogICAgICAgICAgICAgICAgICAgIGltYWdlcy5udW1Ub3RhbCsrOw0KICAgICAgICAgICAgICAgICAgICBzZXRJbWFnZUxvYWRIYW5kbGVycyhpbWcsIGltYWdlT2JqKTsNCiAgICAgICAgICAgICAgICAgICAgaW1nLnNyYyA9IHNyYzsNCiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCBzdXBwb3J0Q09SUyAmJiAhb3B0aW9ucy5hbGxvd1RhaW50ICYmIG9wdGlvbnMudXNlQ09SUyApIHsNCiAgICAgICAgICAgICAgICAgICAgLy8gYXR0ZW1wdCB0byBsb2FkIHdpdGggQ09SUw0KDQogICAgICAgICAgICAgICAgICAgIGltZy5jcm9zc09yaWdpbiA9ICJhbm9ueW1vdXMiOw0KICAgICAgICAgICAgICAgICAgICBpbWFnZU9iaiA9IGltYWdlc1tzcmNdID0gew0KICAgICAgICAgICAgICAgICAgICAgICAgaW1nOiBpbWcNCiAgICAgICAgICAgICAgICAgICAgfTsNCiAgICAgICAgICAgICAgICAgICAgaW1hZ2VzLm51bVRvdGFsKys7DQogICAgICAgICAgICAgICAgICAgIHNldEltYWdlTG9hZEhhbmRsZXJzKGltZywgaW1hZ2VPYmopOw0KICAgICAgICAgICAgICAgICAgICBpbWcuc3JjID0gc3JjOw0KDQogICAgICAgICAgICAgICAgICAgIC8vIHdvcmsgYXJvdW5kIGZvciBodHRwczovL2J1Z3Mud2Via2l0Lm9yZy9zaG93X2J1Zy5jZ2k/aWQ9ODAwMjgNCiAgICAgICAgICAgICAgICAgICAgaW1nLmN1c3RvbUNvbXBsZXRlID0gZnVuY3Rpb24gKCkgew0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLmltZy5jb21wbGV0ZSkgew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudGltZXIgPSB3aW5kb3cuc2V0VGltZW91dCh0aGlzLmltZy5jdXN0b21Db21wbGV0ZSwgMTAwKTsNCiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5pbWcub25lcnJvcigpOw0KICAgICAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICB9LmJpbmQoaW1hZ2VPYmopOw0KICAgICAgICAgICAgICAgICAgICBpbWcuY3VzdG9tQ29tcGxldGUoKTsNCg0KICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoIG9wdGlvbnMucHJveHkgKSB7DQogICAgICAgICAgICAgICAgICAgIGltYWdlT2JqID0gaW1hZ2VzW3NyY10gPSB7DQogICAgICAgICAgICAgICAgICAgICAgICBpbWc6IGltZw0KICAgICAgICAgICAgICAgICAgICB9Ow0KICAgICAgICAgICAgICAgICAgICBpbWFnZXMubnVtVG90YWwrKzsNCiAgICAgICAgICAgICAgICAgICAgcHJveHlHZXRJbWFnZSggc3JjLCBpbWcsIGltYWdlT2JqICk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KDQogICAgICAgIH0sDQogICAgICAgIGNsZWFudXBET006IGZ1bmN0aW9uKGNhdXNlKSB7DQogICAgICAgICAgICB2YXIgaW1nLCBzcmM7DQogICAgICAgICAgICBpZiAoIWltYWdlcy5jbGVhbnVwRG9uZSkgew0KICAgICAgICAgICAgICAgIGlmIChjYXVzZSAmJiB0eXBlb2YgY2F1c2UgPT09ICJzdHJpbmciKSB7DQogICAgICAgICAgICAgICAgICAgIGgyY2xvZygiaHRtbDJjYW52YXM6IENsZWFudXAgYmVjYXVzZTogIiArIGNhdXNlKTsNCiAgICAgICAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgICAgICAgICBoMmNsb2coImh0bWwyY2FudmFzOiBDbGVhbnVwIGFmdGVyIHRpbWVvdXQ6ICIgKyBvcHRpb25zLnRpbWVvdXQgKyAiIG1zLiIpOw0KICAgICAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgICAgIGZvciAoc3JjIGluIGltYWdlcykgew0KICAgICAgICAgICAgICAgICAgICBpZiAoaW1hZ2VzLmhhc093blByb3BlcnR5KHNyYykpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIGltZyA9IGltYWdlc1tzcmNdOw0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBpbWcgPT09ICJvYmplY3QiICYmIGltZy5jYWxsYmFja25hbWUgJiYgaW1nLnN1Y2NlZWRlZCA9PT0gdW5kZWZpbmVkKSB7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gY2FuY2VsIHByb3h5IGltYWdlIHJlcXVlc3QNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3dbaW1nLmNhbGxiYWNrbmFtZV0gPSB1bmRlZmluZWQ7IC8vIHRvIHdvcmsgd2l0aCBJRTw5ICAvLyBOT1RFOiB0aGF0IHRoZSB1bmRlZmluZWQgY2FsbGJhY2sgcHJvcGVydHktbmFtZSBzdGlsbCBleGlzdHMgb24gdGhlIHdpbmRvdyBvYmplY3QgKGZvciBJRTw5KQ0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyeSB7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlbGV0ZSB3aW5kb3dbaW1nLmNhbGxiYWNrbmFtZV07ICAvLyBmb3IgYWxsIGJyb3dzZXIgdGhhdCBzdXBwb3J0IHRoaXMNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoKGV4KSB7fQ0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpbWcuc2NyaXB0ICYmIGltZy5zY3JpcHQucGFyZW50Tm9kZSkgew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbWcuc2NyaXB0LnNldEF0dHJpYnV0ZSgic3JjIiwgImFib3V0OmJsYW5rIik7ICAvLyB0cnkgdG8gY2FuY2VsIHJ1bm5pbmcgcmVxdWVzdA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbWcuc2NyaXB0LnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoaW1nLnNjcmlwdCk7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGltYWdlcy5udW1Mb2FkZWQrKzsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbWFnZXMubnVtRmFpbGVkKys7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaDJjbG9nKCJodG1sMmNhbnZhczogQ2xlYW5lZCB1cCBmYWlsZWQgaW1nOiAnIiArIHNyYyArICInIFN0ZXBzOiAiICsgaW1hZ2VzLm51bUxvYWRlZCArICIgLyAiICsgaW1hZ2VzLm51bVRvdGFsKTsNCiAgICAgICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgICAgIC8vIGNhbmNlbCBhbnkgcGVuZGluZyByZXF1ZXN0cw0KICAgICAgICAgICAgICAgIGlmKHdpbmRvdy5zdG9wICE9PSB1bmRlZmluZWQpIHsNCiAgICAgICAgICAgICAgICAgICAgd2luZG93LnN0b3AoKTsNCiAgICAgICAgICAgICAgICB9IGVsc2UgaWYoZG9jdW1lbnQuZXhlY0NvbW1hbmQgIT09IHVuZGVmaW5lZCkgew0KICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC5leGVjQ29tbWFuZCgiU3RvcCIsIGZhbHNlKTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgaWYgKGRvY3VtZW50LmNsb3NlICE9PSB1bmRlZmluZWQpIHsNCiAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQuY2xvc2UoKTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgaW1hZ2VzLmNsZWFudXBEb25lID0gdHJ1ZTsNCiAgICAgICAgICAgICAgICBpZiAoIShjYXVzZSAmJiB0eXBlb2YgY2F1c2UgPT09ICJzdHJpbmciKSkgew0KICAgICAgICAgICAgICAgICAgICBzdGFydCgpOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0NCiAgICAgICAgfSwNCiAgICAgICAgcmVuZGVyaW5nRG9uZTogZnVuY3Rpb24oKSB7DQogICAgICAgICAgICBpZiAodGltZW91dFRpbWVyKSB7DQogICAgICAgICAgICAgICAgd2luZG93LmNsZWFyVGltZW91dCh0aW1lb3V0VGltZXIpOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQoNCiAgICB9Ow0KDQogICAgaWYgKG9wdGlvbnMudGltZW91dCA+IDApIHsNCiAgICAgICAgdGltZW91dFRpbWVyID0gd2luZG93LnNldFRpbWVvdXQobWV0aG9kcy5jbGVhbnVwRE9NLCBvcHRpb25zLnRpbWVvdXQpOw0KICAgIH0NCiAgICBoMmNsb2coJ2h0bWwyY2FudmFzOiBQcmVsb2FkIHN0YXJ0czogZmluZGluZyBiYWNrZ3JvdW5kLWltYWdlcycpOw0KICAgIGltYWdlcy5maXJzdFJ1biA9IHRydWU7DQoNCiAgICBnZXRJbWFnZXMoIGVsZW1lbnQgKTsNCg0KICAgIGgyY2xvZygnaHRtbDJjYW52YXM6IFByZWxvYWQ6IEZpbmRpbmcgaW1hZ2VzJyk7DQogICAgLy8gbG9hZCA8aW1nPiBpbWFnZXMNCiAgICBmb3IgKGkgPSAwOyBpIDwgaW1nTGVuOyBpKz0xKXsNCiAgICAgICAgbWV0aG9kcy5sb2FkSW1hZ2UoIGRvbUltYWdlc1tpXS5nZXRBdHRyaWJ1dGUoICJzcmMiICkgKTsNCiAgICB9DQoNCiAgICBpbWFnZXMuZmlyc3RSdW4gPSBmYWxzZTsNCiAgICBoMmNsb2coJ2h0bWwyY2FudmFzOiBQcmVsb2FkOiBEb25lLicpOw0KICAgIGlmICggaW1hZ2VzLm51bVRvdGFsID09PSBpbWFnZXMubnVtTG9hZGVkICkgew0KICAgICAgICBzdGFydCgpOw0KICAgIH0NCg0KICAgIHJldHVybiBtZXRob2RzOw0KDQp9Ow0KDQoNCg0KDQovKg0KICBodG1sMmNhbnZhcyB2MC4zNCA8aHR0cDovL2h0bWwyY2FudmFzLmhlcnR6ZW4uY29tPg0KICBDb3B5cmlnaHQgKGMpIDIwMTEgTmlrbGFzIHZvbiBIZXJ0emVuLiBBbGwgcmlnaHRzIHJlc2VydmVkLg0KICBodHRwOi8vd3d3LnR3aXR0ZXIuY29tL25pa2xhc3ZoDQoNCiAgUmVsZWFzZWQgdW5kZXIgTUlUIExpY2Vuc2UNCiovDQpmdW5jdGlvbiBoMmNSZW5kZXJDb250ZXh0KHdpZHRoLCBoZWlnaHQpIHsNCiAgICB2YXIgc3RvcmFnZSA9IFtdOw0KICAgIHJldHVybiB7DQogICAgICAgIHN0b3JhZ2U6IHN0b3JhZ2UsDQogICAgICAgIHdpZHRoOiB3aWR0aCwNCiAgICAgICAgaGVpZ2h0OiBoZWlnaHQsDQogICAgICAgIGZpbGxSZWN0OiBmdW5jdGlvbiAoKSB7DQogICAgICAgICAgICBzdG9yYWdlLnB1c2goew0KICAgICAgICAgICAgICAgIHR5cGU6ICJmdW5jdGlvbiIsDQogICAgICAgICAgICAgICAgbmFtZTogImZpbGxSZWN0IiwNCiAgICAgICAgICAgICAgICAnYXJndW1lbnRzJzogYXJndW1lbnRzDQogICAgICAgICAgICB9KTsNCiAgICAgICAgfSwNCiAgICAgICAgZHJhd0ltYWdlOiBmdW5jdGlvbiAoKSB7DQogICAgICAgICAgICBzdG9yYWdlLnB1c2goew0KICAgICAgICAgICAgICAgIHR5cGU6ICJmdW5jdGlvbiIsDQogICAgICAgICAgICAgICAgbmFtZTogImRyYXdJbWFnZSIsDQogICAgICAgICAgICAgICAgJ2FyZ3VtZW50cyc6IGFyZ3VtZW50cw0KICAgICAgICAgICAgfSk7DQogICAgICAgIH0sDQogICAgICAgIGZpbGxUZXh0OiBmdW5jdGlvbiAoKSB7DQogICAgICAgICAgICBzdG9yYWdlLnB1c2goew0KICAgICAgICAgICAgICAgIHR5cGU6ICJmdW5jdGlvbiIsDQogICAgICAgICAgICAgICAgbmFtZTogImZpbGxUZXh0IiwNCiAgICAgICAgICAgICAgICAnYXJndW1lbnRzJzogYXJndW1lbnRzDQogICAgICAgICAgICB9KTsNCiAgICAgICAgfSwNCiAgICAgICAgc2V0VmFyaWFibGU6IGZ1bmN0aW9uICh2YXJpYWJsZSwgdmFsdWUpIHsNCiAgICAgICAgICAgIHN0b3JhZ2UucHVzaCh7DQogICAgICAgICAgICAgICAgdHlwZTogInZhcmlhYmxlIiwNCiAgICAgICAgICAgICAgICBuYW1lOiB2YXJpYWJsZSwNCiAgICAgICAgICAgICAgICAnYXJndW1lbnRzJzogdmFsdWUNCiAgICAgICAgICAgIH0pOw0KICAgICAgICB9DQogICAgfTsNCn0NCg0KLyoNCiAgaHRtbDJjYW52YXMgdjAuMzQgPGh0dHA6Ly9odG1sMmNhbnZhcy5oZXJ0emVuLmNvbT4NCiAgQ29weXJpZ2h0IChjKSAyMDExIE5pa2xhcyB2b24gSGVydHplbi4gQWxsIHJpZ2h0cyByZXNlcnZlZC4NCiAgaHR0cDovL3d3dy50d2l0dGVyLmNvbS9uaWtsYXN2aA0KDQogIFJlbGVhc2VkIHVuZGVyIE1JVCBMaWNlbnNlDQoqLw0KX2h0bWwyY2FudmFzLlJlbmRlcmVyID0gZnVuY3Rpb24ocGFyc2VRdWV1ZSwgb3B0aW9ucyl7DQoNCg0KICAgIHZhciBxdWV1ZSA9IFtdOw0KDQogICAgZnVuY3Rpb24gc29ydFooelN0YWNrKXsNCiAgICAgICAgdmFyIHN1YlN0YWNrcyA9IFtdLA0KICAgICAgICBzdGFja1ZhbHVlcyA9IFtdLA0KICAgICAgICB6U3RhY2tDaGlsZHJlbiA9IHpTdGFjay5jaGlsZHJlbiwNCiAgICAgICAgcywNCiAgICAgICAgaSwNCiAgICAgICAgc3RhY2tMZW4sDQogICAgICAgIHpWYWx1ZSwNCiAgICAgICAgekxlbiwNCiAgICAgICAgc3RhY2tDaGlsZCwNCiAgICAgICAgYiwNCiAgICAgICAgc3ViU3RhY2tMZW47DQoNCg0KICAgICAgICBmb3IgKHMgPSAwLCB6TGVuID0gelN0YWNrQ2hpbGRyZW4ubGVuZ3RoOyBzIDwgekxlbjsgcys9MSl7DQoNCiAgICAgICAgICAgIHN0YWNrQ2hpbGQgPSB6U3RhY2tDaGlsZHJlbltzXTsNCg0KICAgICAgICAgICAgaWYgKHN0YWNrQ2hpbGQuY2hpbGRyZW4gJiYgc3RhY2tDaGlsZC5jaGlsZHJlbi5sZW5ndGggPiAwKXsNCiAgICAgICAgICAgICAgICBzdWJTdGFja3MucHVzaChzdGFja0NoaWxkKTsNCiAgICAgICAgICAgICAgICBzdGFja1ZhbHVlcy5wdXNoKHN0YWNrQ2hpbGQuemluZGV4KTsNCiAgICAgICAgICAgIH1lbHNlew0KICAgICAgICAgICAgICAgIHF1ZXVlLnB1c2goc3RhY2tDaGlsZCk7DQogICAgICAgICAgICB9DQoNCiAgICAgICAgfQ0KDQogICAgICAgIHN0YWNrVmFsdWVzLnNvcnQoZnVuY3Rpb24oYSwgYikgew0KICAgICAgICAgICAgcmV0dXJuIGEgLSBiOw0KICAgICAgICB9KTsNCg0KICAgICAgICBmb3IgKGkgPSAwLCBzdGFja0xlbiA9IHN0YWNrVmFsdWVzLmxlbmd0aDsgaSA8IHN0YWNrTGVuOyBpKz0xKXsNCiAgICAgICAgICAgIHpWYWx1ZSA9IHN0YWNrVmFsdWVzW2ldOw0KICAgICAgICAgICAgZm9yIChiID0gMCwgc3ViU3RhY2tMZW4gPSBzdWJTdGFja3MubGVuZ3RoOyBiIDw9IHN1YlN0YWNrTGVuOyBiKz0xKXsNCg0KICAgICAgICAgICAgICAgIGlmIChzdWJTdGFja3NbYl0uemluZGV4ID09PSB6VmFsdWUpew0KICAgICAgICAgICAgICAgICAgICBzdGFja0NoaWxkID0gc3ViU3RhY2tzLnNwbGljZShiLCAxKTsNCiAgICAgICAgICAgICAgICAgICAgc29ydFooc3RhY2tDaGlsZFswXSk7DQogICAgICAgICAgICAgICAgICAgIGJyZWFrOw0KDQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQoNCiAgICB9DQoNCg0KICAgIHNvcnRaKHBhcnNlUXVldWUuekluZGV4KTsNCiAgICBpZiAoIHR5cGVvZiBvcHRpb25zLl9yZW5kZXJlci5fY3JlYXRlICE9PSAiZnVuY3Rpb24iICkgew0KICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkludmFsaWQgcmVuZGVyZXIgZGVmaW5lZCIpOw0KICAgIH0NCiAgICByZXR1cm4gb3B0aW9ucy5fcmVuZGVyZXIuX2NyZWF0ZSggcGFyc2VRdWV1ZSwgb3B0aW9ucywgZG9jdW1lbnQsIHF1ZXVlLCBfaHRtbDJjYW52YXMgKTsNCg0KfTsNCg0KLyoNCiAgaHRtbDJjYW52YXMgdjAuMzQgPGh0dHA6Ly9odG1sMmNhbnZhcy5oZXJ0emVuLmNvbT4NCiAgQ29weXJpZ2h0IChjKSAyMDExIE5pa2xhcyB2b24gSGVydHplbi4gQWxsIHJpZ2h0cyByZXNlcnZlZC4NCiAgaHR0cDovL3d3dy50d2l0dGVyLmNvbS9uaWtsYXN2aA0KDQogIFJlbGVhc2VkIHVuZGVyIE1JVCBMaWNlbnNlDQoqLw0KDQoNCmh0bWwyY2FudmFzID0gZnVuY3Rpb24oIGVsZW1lbnRzLCBvcHRzICkgew0KDQogICAgdmFyIHF1ZXVlLA0KICAgIGNhbnZhcywNCiAgICBvcHRpb25zID0gew0KICAgICAgICAvLyBnZW5lcmFsDQogICAgICAgIGxvZ2dpbmc6IGZhbHNlLA0KICAgICAgICBlbGVtZW50czogZWxlbWVudHMsDQoNCiAgICAgICAgLy8gcHJlbG9hZCBvcHRpb25zDQogICAgICAgIHByb3h5OiAiaHR0cDovL2h0bWwyY2FudmFzLmFwcHNwb3QuY29tLyIsDQogICAgICAgIHRpbWVvdXQ6IDAsICAgIC8vIG5vIHRpbWVvdXQNCiAgICAgICAgdXNlQ09SUzogZmFsc2UsIC8vIHRyeSB0byBsb2FkIGltYWdlcyBhcyBDT1JTICh3aGVyZSBhdmFpbGFibGUpLCBiZWZvcmUgZmFsbGluZyBiYWNrIHRvIHByb3h5DQogICAgICAgIGFsbG93VGFpbnQ6IGZhbHNlLCAvLyB3aGV0aGVyIHRvIGFsbG93IGltYWdlcyB0byB0YWludCB0aGUgY2FudmFzLCB3b24ndCBuZWVkIHByb3h5IGlmIHNldCB0byB0cnVlDQoNCiAgICAgICAgLy8gcGFyc2Ugb3B0aW9ucw0KICAgICAgICBzdmdSZW5kZXJpbmc6IGZhbHNlLCAvLyB1c2Ugc3ZnIHBvd2VyZWQgcmVuZGVyaW5nIHdoZXJlIGF2YWlsYWJsZSAoRkYxMSspDQogICAgICAgIGlmcmFtZURlZmF1bHQ6ICJkZWZhdWx0IiwNCiAgICAgICAgaWdub3JlRWxlbWVudHM6ICJJRlJBTUV8T0JKRUNUfFBBUkFNIiwNCiAgICAgICAgdXNlT3ZlcmZsb3c6IHRydWUsDQogICAgICAgIGxldHRlclJlbmRlcmluZzogZmFsc2UsDQoNCiAgICAgICAgLy8gcmVuZGVyIG9wdGlvbnMNCg0KICAgICAgICBmbGFzaGNhbnZhczogdW5kZWZpbmVkLCAvLyBwYXRoIHRvIGZsYXNoY2FudmFzDQogICAgICAgIHdpZHRoOiBudWxsLA0KICAgICAgICBoZWlnaHQ6IG51bGwsDQogICAgICAgIHRhaW50VGVzdDogdHJ1ZSwgLy8gZG8gYSB0YWludCB0ZXN0IHdpdGggYWxsIGltYWdlcyBiZWZvcmUgYXBwbHlpbmcgdG8gY2FudmFzDQoJCXJlbmRlcmVyOiAiQ2FudmFzIg0KICAgIH0sIHJlbmRlcmVyOw0KDQogICAgb3B0aW9ucyA9IF9odG1sMmNhbnZhcy5VdGlsLkV4dGVuZChvcHRzLCBvcHRpb25zKTsNCg0KCWlmICh0eXBlb2Ygb3B0aW9ucy5yZW5kZXJlciA9PT0gInN0cmluZyIgJiYgX2h0bWwyY2FudmFzLlJlbmRlcmVyW29wdGlvbnMucmVuZGVyZXJdICE9PSB1bmRlZmluZWQpIHsNCgkJb3B0aW9ucy5fcmVuZGVyZXIgPSBfaHRtbDJjYW52YXMuUmVuZGVyZXJbb3B0aW9ucy5yZW5kZXJlcl0oIG9wdGlvbnMgKTsNCgl9IGVsc2UgaWYgKHR5cGVvZiBvcHRpb25zLnJlbmRlcmVyID09PSAiZnVuY3Rpb24iKSB7DQoJCW9wdGlvbnMuX3JlbmRlcmVyID0gb3B0aW9ucy5yZW5kZXJlciggb3B0aW9ucyApOw0KCX0gZWxzZSB7DQoJCXRocm93KCJVbmtub3duIHJlbmRlcmVyIik7DQoJfQ0KDQogICAgX2h0bWwyY2FudmFzLmxvZ2dpbmcgPSBvcHRpb25zLmxvZ2dpbmc7DQogICAgb3B0aW9ucy5jb21wbGV0ZSA9IGZ1bmN0aW9uKCBpbWFnZXMgKSB7DQoNCiAgICAgICAgaWYgKHR5cGVvZiBvcHRpb25zLm9ucHJlbG9hZGVkID09PSAiZnVuY3Rpb24iKSB7DQogICAgICAgICAgICBpZiAoIG9wdGlvbnMub25wcmVsb2FkZWQoIGltYWdlcyApID09PSBmYWxzZSApIHsNCiAgICAgICAgICAgICAgICByZXR1cm47DQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgICAgcXVldWUgPSBfaHRtbDJjYW52YXMuUGFyc2UoIGltYWdlcywgb3B0aW9ucyApOw0KDQogICAgICAgIGlmICh0eXBlb2Ygb3B0aW9ucy5vbnBhcnNlZCA9PT0gImZ1bmN0aW9uIikgew0KICAgICAgICAgICAgaWYgKCBvcHRpb25zLm9ucGFyc2VkKCBxdWV1ZSApID09PSBmYWxzZSApIHsNCiAgICAgICAgICAgICAgICByZXR1cm47DQogICAgICAgICAgICB9DQogICAgICAgIH0NCg0KICAgICAgICBjYW52YXMgPSBfaHRtbDJjYW52YXMuUmVuZGVyZXIoIHF1ZXVlLCBvcHRpb25zICk7DQoNCiAgICAgICAgaWYgKHR5cGVvZiBvcHRpb25zLm9ucmVuZGVyZWQgPT09ICJmdW5jdGlvbiIpIHsNCiAgICAgICAgICAgIG9wdGlvbnMub25yZW5kZXJlZCggY2FudmFzICk7DQogICAgICAgIH0NCg0KDQogICAgfTsNCg0KICAgIC8vIGZvciBwYWdlcyB3aXRob3V0IGltYWdlcywgd2Ugc3RpbGwgd2FudCB0aGlzIHRvIGJlIGFzeW5jLCBpLmUuIHJldHVybiBtZXRob2RzIGJlZm9yZSBleGVjdXRpbmcNCiAgICB3aW5kb3cuc2V0VGltZW91dCggZnVuY3Rpb24oKXsNCiAgICAgICAgX2h0bWwyY2FudmFzLlByZWxvYWQoIG9wdGlvbnMgKTsNCiAgICB9LCAwICk7DQoNCiAgICByZXR1cm4gew0KICAgICAgICByZW5kZXI6IGZ1bmN0aW9uKCBxdWV1ZSwgb3B0cyApIHsNCiAgICAgICAgICAgIHJldHVybiBfaHRtbDJjYW52YXMuUmVuZGVyZXIoIHF1ZXVlLCBfaHRtbDJjYW52YXMuVXRpbC5FeHRlbmQob3B0cywgb3B0aW9ucykgKTsNCiAgICAgICAgfSwNCiAgICAgICAgcGFyc2U6IGZ1bmN0aW9uKCBpbWFnZXMsIG9wdHMgKSB7DQogICAgICAgICAgICByZXR1cm4gX2h0bWwyY2FudmFzLlBhcnNlKCBpbWFnZXMsIF9odG1sMmNhbnZhcy5VdGlsLkV4dGVuZChvcHRzLCBvcHRpb25zKSApOw0KICAgICAgICB9LA0KICAgICAgICBwcmVsb2FkOiBmdW5jdGlvbiggb3B0cyApIHsNCiAgICAgICAgICAgIHJldHVybiBfaHRtbDJjYW52YXMuUHJlbG9hZCggX2h0bWwyY2FudmFzLlV0aWwuRXh0ZW5kKG9wdHMsIG9wdGlvbnMpICk7DQogICAgICAgIH0sDQogICAgICAgIGxvZzogaDJjbG9nDQogICAgfTsNCn07DQoNCmh0bWwyY2FudmFzLmxvZyA9IGgyY2xvZzsgLy8gZm9yIHJlbmRlcmVycw0KaHRtbDJjYW52YXMuUmVuZGVyZXIgPSB7DQogICAgQ2FudmFzOiB1bmRlZmluZWQgLy8gV2UgYXJlIGFzc3VtaW5nIHRoaXMgd2lsbCBiZSB1c2VkDQp9Ow0KDQovKg0KICBodG1sMmNhbnZhcyB2MC4zNCA8aHR0cDovL2h0bWwyY2FudmFzLmhlcnR6ZW4uY29tPg0KICBDb3B5cmlnaHQgKGMpIDIwMTEgTmlrbGFzIHZvbiBIZXJ0emVuLiBBbGwgcmlnaHRzIHJlc2VydmVkLg0KICBodHRwOi8vd3d3LnR3aXR0ZXIuY29tL25pa2xhc3ZoDQoNCiAgUmVsZWFzZWQgdW5kZXIgTUlUIExpY2Vuc2UNCiovDQoNCg0KX2h0bWwyY2FudmFzLlJlbmRlcmVyLkNhbnZhcyA9IGZ1bmN0aW9uKCBvcHRpb25zICkgew0KDQogICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307DQoNCiAgICB2YXIgZG9jID0gZG9jdW1lbnQsDQogICAgY2FudmFzID0gb3B0aW9ucy5jYW52YXMgfHwgZG9jLmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpLA0KICAgIHVzaW5nRmxhc2hjYW52YXMgPSBmYWxzZSwNCiAgICBfY3JlYXRlQ2FsbGVkID0gZmFsc2UsDQogICAgY2FudmFzUmVhZHlUb0RyYXcgPSBmYWxzZSwNCiAgICBtZXRob2RzLA0KICAgIGZsYXNoTWF4U2l6ZSA9IDI4ODA7IC8vIGZsYXNoIGJpdG1hcCBsaW1pdGVkIHRvIDI4ODB4Mjg4MHB4IC8vIGh0dHA6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvMjAzMzc5Mi9hcmd1bWVudGVycm9yLWVycm9yLTIwMTUtaW52YWxpZC1iaXRtYXBkYXRhDQoNCg0KICAgIGlmIChjYW52YXMuZ2V0Q29udGV4dCl7DQogICAgICAgIGgyY2xvZygiaHRtbDJjYW52YXM6IFJlbmRlcmVyOiB1c2luZyBjYW52YXMgcmVuZGVyZXIiKTsNCiAgICAgICAgY2FudmFzUmVhZHlUb0RyYXcgPSB0cnVlOw0KICAgIH0gZWxzZSBpZiAoIG9wdGlvbnMuZmxhc2hjYW52YXMgIT09IHVuZGVmaW5lZCApew0KICAgICAgICB1c2luZ0ZsYXNoY2FudmFzID0gdHJ1ZTsNCiAgICAgICAgaDJjbG9nKCJodG1sMmNhbnZhczogUmVuZGVyZXI6IGNhbnZhcyBub3QgYXZhaWxhYmxlLCB1c2luZyBmbGFzaGNhbnZhcyIpOw0KICAgICAgICB2YXIgc2NyaXB0ID0gZG9jLmNyZWF0ZUVsZW1lbnQoInNjcmlwdCIpOw0KICAgICAgICBzY3JpcHQuc3JjID0gb3B0aW9ucy5mbGFzaGNhbnZhczsNCg0KICAgICAgICBzY3JpcHQub25sb2FkID0gKGZ1bmN0aW9uKHNjcmlwdCwgZnVuYyl7DQogICAgICAgICAgICB2YXIgaW50ZXJ2YWxGdW5jOw0KDQogICAgICAgICAgICBpZiAoc2NyaXB0Lm9ubG9hZCA9PT0gdW5kZWZpbmVkKSB7DQogICAgICAgICAgICAgICAgLy8gSUUgbGFjayBvZiBzdXBwb3J0IGZvciBzY3JpcHQgb25sb2FkDQoNCiAgICAgICAgICAgICAgICBpZiggc2NyaXB0Lm9ucmVhZHlzdGF0ZWNoYW5nZSAhPT0gdW5kZWZpbmVkICkgew0KDQogICAgICAgICAgICAgICAgICAgIGludGVydmFsRnVuYyA9IGZ1bmN0aW9uKCkgew0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNjcmlwdC5yZWFkeVN0YXRlICE9PSAibG9hZGVkIiAmJiBzY3JpcHQucmVhZHlTdGF0ZSAhPT0gImNvbXBsZXRlIikgew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5zZXRUaW1lb3V0KCBpbnRlcnZhbEZ1bmMsIDI1MCApOw0KDQogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGl0IGlzIGxvYWRlZA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZ1bmMoKTsNCg0KICAgICAgICAgICAgICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAgICAgICAgIH07DQoNCiAgICAgICAgICAgICAgICAgICAgd2luZG93LnNldFRpbWVvdXQoIGludGVydmFsRnVuYywgMjUwICk7DQoNCiAgICAgICAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgICAgICAgICBoMmNsb2coImh0bWwyY2FudmFzOiBSZW5kZXJlcjogQ2FuJ3QgdHJhY2sgd2hlbiBmbGFzaGNhbnZhcyBpcyBsb2FkZWQiKTsNCiAgICAgICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmM7DQogICAgICAgICAgICB9DQoNCiAgICAgICAgfSkoc2NyaXB0LCBmdW5jdGlvbigpew0KDQogICAgICAgICAgICBpZiAodHlwZW9mIHdpbmRvdy5GbGFzaENhbnZhcyAhPT0gInVuZGVmaW5lZCIpIHsNCiAgICAgICAgICAgICAgICBoMmNsb2coImh0bWwyY2FudmFzOiBSZW5kZXJlcjogRmxhc2hjYW52YXMgaW5pdGlhbGl6ZWQiKTsNCiAgICAgICAgICAgICAgICB3aW5kb3cuRmxhc2hDYW52YXMuaW5pdEVsZW1lbnQoIGNhbnZhcyApOw0KDQogICAgICAgICAgICAgICAgY2FudmFzUmVhZHlUb0RyYXcgPSB0cnVlOw0KICAgICAgICAgICAgICAgIGlmICggX2NyZWF0ZUNhbGxlZCAhPT0gZmFsc2UgKSB7DQogICAgICAgICAgICAgICAgICAgIG1ldGhvZHMuX2NyZWF0ZS5hcHBseSggbnVsbCwgX2NyZWF0ZUNhbGxlZCApOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0NCiAgICAgICAgfSk7DQoNCiAgICAgICAgZG9jLmJvZHkuYXBwZW5kQ2hpbGQoIHNjcmlwdCApOw0KDQogICAgfQ0KDQogICAgbWV0aG9kcyA9IHsNCiAgICAgICAgX2NyZWF0ZTogZnVuY3Rpb24oIHpTdGFjaywgb3B0aW9ucywgZG9jLCBxdWV1ZSwgX2h0bWwyY2FudmFzICkgew0KDQogICAgICAgICAgICBpZiAoICFjYW52YXNSZWFkeVRvRHJhdyApIHsNCiAgICAgICAgICAgICAgICBfY3JlYXRlQ2FsbGVkID0gYXJndW1lbnRzOw0KICAgICAgICAgICAgICAgIHJldHVybiBjYW52YXM7DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIHZhciBjdHggPSBjYW52YXMuZ2V0Q29udGV4dCgiMmQiKSwNCiAgICAgICAgICAgIHN0b3JhZ2VDb250ZXh0LA0KICAgICAgICAgICAgaSwNCiAgICAgICAgICAgIHF1ZXVlTGVuLA0KICAgICAgICAgICAgYSwNCiAgICAgICAgICAgIG5ld0NhbnZhcywNCiAgICAgICAgICAgIGJvdW5kcywNCiAgICAgICAgICAgIHRlc3RDYW52YXMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJjYW52YXMiKSwNCiAgICAgICAgICAgIGhhc0NUWCA9ICggdGVzdENhbnZhcy5nZXRDb250ZXh0ICE9PSB1bmRlZmluZWQgKSwNCiAgICAgICAgICAgIHN0b3JhZ2VMZW4sDQogICAgICAgICAgICByZW5kZXJJdGVtLA0KICAgICAgICAgICAgdGVzdGN0eCA9ICggaGFzQ1RYICkgPyB0ZXN0Q2FudmFzLmdldENvbnRleHQoIjJkIikgOiB7fSwNCiAgICAgICAgICAgIHNhZmVJbWFnZXMgPSBbXSwNCiAgICAgICAgICAgIGZzdHlsZTsNCg0KICAgICAgICAgICAgY2FudmFzLndpZHRoID0gY2FudmFzLnN0eWxlLndpZHRoID0gKCF1c2luZ0ZsYXNoY2FudmFzKSA/IG9wdGlvbnMud2lkdGggfHwgelN0YWNrLmN0eC53aWR0aCA6IE1hdGgubWluKGZsYXNoTWF4U2l6ZSwgKG9wdGlvbnMud2lkdGggfHwgelN0YWNrLmN0eC53aWR0aCkgKTsNCiAgICAgICAgICAgIGNhbnZhcy5oZWlnaHQgPSBjYW52YXMuc3R5bGUuaGVpZ2h0ID0gKCF1c2luZ0ZsYXNoY2FudmFzKSA/IG9wdGlvbnMuaGVpZ2h0IHx8IHpTdGFjay5jdHguaGVpZ2h0IDogTWF0aC5taW4oZmxhc2hNYXhTaXplLCAob3B0aW9ucy5oZWlnaHQgfHwgelN0YWNrLmN0eC5oZWlnaHQpICk7DQoNCiAgICAgICAgICAgIGZzdHlsZSA9IGN0eC5maWxsU3R5bGU7DQogICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gelN0YWNrLmJhY2tncm91bmRDb2xvcjsNCiAgICAgICAgICAgIGN0eC5maWxsUmVjdCgwLCAwLCBjYW52YXMud2lkdGgsIGNhbnZhcy5oZWlnaHQpOw0KICAgICAgICAgICAgY3R4LmZpbGxTdHlsZSA9IGZzdHlsZTsNCg0KICAgICAgICAgICAgaWYgKCBvcHRpb25zLnN2Z1JlbmRlcmluZyAmJiB6U3RhY2suc3ZnUmVuZGVyICE9PSB1bmRlZmluZWQgKSB7DQogICAgICAgICAgICAgICAgLy8gVE9ETzogZW5hYmxlIGFzeW5jIHJlbmRlcmluZyB0byBzdXBwb3J0IHRoaXMNCiAgICAgICAgICAgICAgICBjdHguZHJhd0ltYWdlKCB6U3RhY2suc3ZnUmVuZGVyLCAwLCAwICk7DQogICAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgICAgIGZvciAoIGkgPSAwLCBxdWV1ZUxlbiA9IHF1ZXVlLmxlbmd0aDsgaSA8IHF1ZXVlTGVuOyBpKz0xICkgew0KDQogICAgICAgICAgICAgICAgICAgIHN0b3JhZ2VDb250ZXh0ID0gcXVldWUuc3BsaWNlKDAsIDEpWzBdOw0KICAgICAgICAgICAgICAgICAgICBzdG9yYWdlQ29udGV4dC5jYW52YXNQb3NpdGlvbiA9IHN0b3JhZ2VDb250ZXh0LmNhbnZhc1Bvc2l0aW9uIHx8IHt9Ow0KDQogICAgICAgICAgICAgICAgICAgIC8vdGhpcy5jYW52YXNSZW5kZXJDb250ZXh0KHN0b3JhZ2VDb250ZXh0LHBhcmVudGN0eCk7DQoNCiAgICAgICAgICAgICAgICAgICAgLy8gc2V0IGNvbW1vbiBzZXR0aW5ncyBmb3IgY2FudmFzDQogICAgICAgICAgICAgICAgICAgIGN0eC50ZXh0QmFzZWxpbmUgPSAiYm90dG9tIjsNCg0KICAgICAgICAgICAgICAgICAgICBpZiAoc3RvcmFnZUNvbnRleHQuY2xpcCl7DQogICAgICAgICAgICAgICAgICAgICAgICBjdHguc2F2ZSgpOw0KICAgICAgICAgICAgICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOw0KICAgICAgICAgICAgICAgICAgICAgICAgLy8gY29uc29sZS5sb2coc3RvcmFnZUNvbnRleHQpOw0KICAgICAgICAgICAgICAgICAgICAgICAgY3R4LnJlY3Qoc3RvcmFnZUNvbnRleHQuY2xpcC5sZWZ0LCBzdG9yYWdlQ29udGV4dC5jbGlwLnRvcCwgc3RvcmFnZUNvbnRleHQuY2xpcC53aWR0aCwgc3RvcmFnZUNvbnRleHQuY2xpcC5oZWlnaHQpOw0KICAgICAgICAgICAgICAgICAgICAgICAgY3R4LmNsaXAoKTsNCg0KICAgICAgICAgICAgICAgICAgICB9DQoNCiAgICAgICAgICAgICAgICAgICAgaWYgKHN0b3JhZ2VDb250ZXh0LmN0eC5zdG9yYWdlKXsNCg0KICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChhID0gMCwgc3RvcmFnZUxlbiA9IHN0b3JhZ2VDb250ZXh0LmN0eC5zdG9yYWdlLmxlbmd0aDsgYSA8IHN0b3JhZ2VMZW47IGErPTEpew0KDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVuZGVySXRlbSA9IHN0b3JhZ2VDb250ZXh0LmN0eC5zdG9yYWdlW2FdOw0KDQoNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzd2l0Y2gocmVuZGVySXRlbS50eXBlKXsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAidmFyaWFibGUiOg0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3R4W3JlbmRlckl0ZW0ubmFtZV0gPSByZW5kZXJJdGVtWydhcmd1bWVudHMnXTsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICJmdW5jdGlvbiI6DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocmVuZGVySXRlbS5uYW1lID09PSAiZmlsbFJlY3QiKSB7DQoNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXVzaW5nRmxhc2hjYW52YXMgfHwgcmVuZGVySXRlbVsnYXJndW1lbnRzJ11bMF0gKyByZW5kZXJJdGVtWydhcmd1bWVudHMnXVsyXSA8IGZsYXNoTWF4U2l6ZSAgJiYgcmVuZGVySXRlbVsnYXJndW1lbnRzJ11bMV0gKyByZW5kZXJJdGVtWydhcmd1bWVudHMnXVszXSA8IGZsYXNoTWF4U2l6ZSkgew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdHguZmlsbFJlY3QuYXBwbHkoIGN0eCwgcmVuZGVySXRlbVsnYXJndW1lbnRzJ10gKTsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9ZWxzZSBpZihyZW5kZXJJdGVtLm5hbWUgPT09ICJmaWxsVGV4dCIpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXVzaW5nRmxhc2hjYW52YXMgfHwgcmVuZGVySXRlbVsnYXJndW1lbnRzJ11bMV0gPCBmbGFzaE1heFNpemUgICYmIHJlbmRlckl0ZW1bJ2FyZ3VtZW50cyddWzJdIDwgZmxhc2hNYXhTaXplKSB7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN0eC5maWxsVGV4dC5hcHBseSggY3R4LCByZW5kZXJJdGVtWydhcmd1bWVudHMnXSApOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1lbHNlIGlmKHJlbmRlckl0ZW0ubmFtZSA9PT0gImRyYXdJbWFnZSIpIHsNCg0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZW5kZXJJdGVtWydhcmd1bWVudHMnXVs4XSA+IDAgJiYgcmVuZGVySXRlbVsnYXJndW1lbnRzJ11bN10pew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIGhhc0NUWCAmJiBvcHRpb25zLnRhaW50VGVzdCApIHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICggc2FmZUltYWdlcy5pbmRleE9mKCByZW5kZXJJdGVtWydhcmd1bWVudHMnXVsgMCBdLnNyYyApID09PSAtMSApIHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZXN0Y3R4LmRyYXdJbWFnZSggcmVuZGVySXRlbVsnYXJndW1lbnRzJ11bIDAgXSwgMCwgMCApOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyeSB7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlc3RjdHguZ2V0SW1hZ2VEYXRhKCAwLCAwLCAxLCAxICk7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBjYXRjaChlKSB7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlc3RDYW52YXMgPSBkb2MuY3JlYXRlRWxlbWVudCgiY2FudmFzIik7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlc3RjdHggPSB0ZXN0Q2FudmFzLmdldENvbnRleHQoIjJkIik7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNhZmVJbWFnZXMucHVzaCggcmVuZGVySXRlbVsnYXJndW1lbnRzJ11bIDAgXS5zcmMgKTsNCg0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN0eC5kcmF3SW1hZ2UuYXBwbHkoIGN0eCwgcmVuZGVySXRlbVsnYXJndW1lbnRzJ10gKTsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9DQoNCg0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6DQoNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9DQoNCiAgICAgICAgICAgICAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIGlmIChzdG9yYWdlQ29udGV4dC5jbGlwKXsNCiAgICAgICAgICAgICAgICAgICAgICAgIGN0eC5yZXN0b3JlKCk7DQogICAgICAgICAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgaDJjbG9nKCJodG1sMmNhbnZhczogUmVuZGVyZXI6IENhbnZhcyByZW5kZXJlciBkb25lIC0gcmV0dXJuaW5nIGNhbnZhcyBvYmoiKTsNCg0KICAgICAgICAgICAgcXVldWVMZW4gPSBvcHRpb25zLmVsZW1lbnRzLmxlbmd0aDsNCg0KICAgICAgICAgICAgaWYgKHF1ZXVlTGVuID09PSAxKSB7DQogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBvcHRpb25zLmVsZW1lbnRzWyAwIF0gPT09ICJvYmplY3QiICYmIG9wdGlvbnMuZWxlbWVudHNbIDAgXS5ub2RlTmFtZSAhPT0gIkJPRFkiICYmIHVzaW5nRmxhc2hjYW52YXMgPT09IGZhbHNlKSB7DQogICAgICAgICAgICAgICAgICAgIC8vIGNyb3AgaW1hZ2UgdG8gdGhlIGJvdW5kcyBvZiBzZWxlY3RlZCAoc2luZ2xlKSBlbGVtZW50DQogICAgICAgICAgICAgICAgICAgIGJvdW5kcyA9IF9odG1sMmNhbnZhcy5VdGlsLkJvdW5kcyggb3B0aW9ucy5lbGVtZW50c1sgMCBdICk7DQogICAgICAgICAgICAgICAgICAgIG5ld0NhbnZhcyA9IGRvYy5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsNCiAgICAgICAgICAgICAgICAgICAgbmV3Q2FudmFzLndpZHRoID0gYm91bmRzLndpZHRoOw0KICAgICAgICAgICAgICAgICAgICBuZXdDYW52YXMuaGVpZ2h0ID0gYm91bmRzLmhlaWdodDsNCiAgICAgICAgICAgICAgICAgICAgY3R4ID0gbmV3Q2FudmFzLmdldENvbnRleHQoIjJkIik7DQoNCiAgICAgICAgICAgICAgICAgICAgY3R4LmRyYXdJbWFnZSggY2FudmFzLCBib3VuZHMubGVmdCwgYm91bmRzLnRvcCwgYm91bmRzLndpZHRoLCBib3VuZHMuaGVpZ2h0LCAwLCAwLCBib3VuZHMud2lkdGgsIGJvdW5kcy5oZWlnaHQgKTsNCiAgICAgICAgICAgICAgICAgICAgY2FudmFzID0gbnVsbDsNCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG5ld0NhbnZhczsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9IC8qZWxzZSB7DQogICAgICAgIC8vIFRPRE8gY2xpcCBhbmQgcmVzaXplIG11bHRpcGxlIGVsZW1lbnRzDQoNCiAgICAgICAgICAgIGZvciAoIGkgPSAwOyBpIDwgcXVldWVMZW47IGkrPTEgKSB7DQogICAgICAgICAgICAgICAgaWYgKG9wdGlvbnMuZWxlbWVudHNbIGkgXSBpbnN0YW5jZW9mIEVsZW1lbnQpIHsNCg0KICAgICAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICAgICovDQoNCg0KDQogICAgICAgICAgICByZXR1cm4gY2FudmFzOw0KICAgICAgICB9DQogICAgfTsNCg0KICAgIHJldHVybiBtZXRob2RzOw0KDQp9Ow0KDQp3aW5kb3cuaHRtbDJjYW52YXMgPSBodG1sMmNhbnZhczsNCn0od2luZG93LCBkb2N1bWVudCkpOw0KDQo=",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Fri, 07 Nov 2014 02:25:10 GMT",
                    "Content-Length": "94985",
                    "Date": "Fri, 07 Nov 2014 02:25:11 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}