{
    "url": "http://localhost:9999/snrbrnjna/galleryjs/lib/gallery.pkgd.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "DOM data manipulation (DOM-based)",
    "issueType": 5247488,
    "severity": "Information",
    "confidence": "Firm",
    "issueBackground": "DOM-based DOM data manipulation vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this to a data field within the DOM that is used within the visible UI or client-side application logic. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will modify the appearance or behavior of the client-side UI. An attacker may be able to leverage this to perform virtual defacement of the application, or possibly to induce the user to perform unintended actions.",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based DOM data manipulation vulnerabilities is not to dynamically write to DOM data fields any data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from being stored. In general, this is best achieved by using a whitelist of permitted values.",
    "issueDetail": "The application may be vulnerable to DOM-based DOM data manipulation. Data is read from <b>document.location.href</b> and written to <b>history.replaceState()</b> via the following statements:<ul><li>var newLoc = document.location.href;</li><li>newLoc = newLoc.replace(/\\#.*/, '') + (bangboombang ? '#!' + bangboombang : '');</li><li>history.replaceState(null, title, newLoc);</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/snrbrnjna/galleryjs/lib/gallery.pkgd.js",
                "path": "/snrbrnjna/galleryjs/lib/gallery.pkgd.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9zbnJicm5qbmEvZ2FsbGVyeWpzL2xpYi9nYWxsZXJ5LnBrZ2QuanMgSFRUUC8xLjENCkhvc3Q6IGxvY2FsaG9zdDo5OTk5DQoNCg==",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogMzcwMzE3DQpBY2NlcHQtUmFuZ2VzOiBieXRlcw0KQ29udGVudC1UeXBlOiBhcHBsaWNhdGlvbi9qYXZhc2NyaXB0DQpEYXRlOiBGcmksIDA3IE5vdiAyMDE0IDAyOjAzOjQ4IEdNVA0KTGFzdC1Nb2RpZmllZDogRnJpLCAwNyBOb3YgMjAxNCAwMjowMzo0OCBHTVQNCg0KLyoganNoaW50IGlnbm9yZTpzdGFydCAqLwooZnVuY3Rpb24gKHJvb3QsIGZhY3RvcnkpIHsKICAgIGlmICh0eXBlb2YgZGVmaW5lID09PSAnZnVuY3Rpb24nICYmIGRlZmluZS5hbWQpIHsKICAgICAgICAvL0FsbG93IHVzaW5nIHRoaXMgYnVpbHQgbGlicmFyeSBhcyBhbiBBTUQgbW9kdWxlCiAgICAgICAgLy9pbiBhbm90aGVyIHByb2plY3QuIFRoYXQgb3RoZXIgcHJvamVjdCB3aWxsIG9ubHkKICAgICAgICAvL3NlZSB0aGlzIEFNRCBjYWxsLCBub3QgdGhlIGludGVybmFsIG1vZHVsZXMgaW4KICAgICAgICAvL3RoZSBjbG9zdXJlIGJlbG93LgogICAgICAgIGRlZmluZShbXSwgZmFjdG9yeSk7CiAgICB9IGVsc2UgewogICAgICAgIC8vQnJvd3NlciBnbG9iYWxzIGNhc2UuIEp1c3QgYXNzaWduIHRoZQogICAgICAgIC8vcmVzdWx0IHRvIGEgcHJvcGVydHkgb24gdGhlIGdsb2JhbC4KICAgICAgICByb290LkdhbGxlcnlBcHAgPSBmYWN0b3J5KCk7CiAgICB9Cn0odGhpcywgZnVuY3Rpb24gKCkgewogICAgLy9hbG1vbmQsIGFuZCB5b3VyIG1vZHVsZXMgd2lsbCBiZSBpbmxpbmVkIGhlcmUKLyoganNoaW50IGlnbm9yZTplbmQgKi8KLyoqCiAqIEBsaWNlbnNlIGFsbW9uZCAwLjIuOSBDb3B5cmlnaHQgKGMpIDIwMTEtMjAxNCwgVGhlIERvam8gRm91bmRhdGlvbiBBbGwgUmlnaHRzIFJlc2VydmVkLgogKiBBdmFpbGFibGUgdmlhIHRoZSBNSVQgb3IgbmV3IEJTRCBsaWNlbnNlLgogKiBzZWU6IGh0dHA6Ly9naXRodWIuY29tL2pyYnVya2UvYWxtb25kIGZvciBkZXRhaWxzCiAqLwovL0dvaW5nIHNsb3BweSB0byBhdm9pZCAndXNlIHN0cmljdCcgc3RyaW5nIGNvc3QsIGJ1dCBzdHJpY3QgcHJhY3RpY2VzIHNob3VsZAovL2JlIGZvbGxvd2VkLgovKmpzbGludCBzbG9wcHk6IHRydWUgKi8KLypnbG9iYWwgc2V0VGltZW91dDogZmFsc2UgKi8KCnZhciByZXF1aXJlanMsIHJlcXVpcmUsIGRlZmluZTsKKGZ1bmN0aW9uICh1bmRlZikgewogICAgdmFyIG1haW4sIHJlcSwgbWFrZU1hcCwgaGFuZGxlcnMsCiAgICAgICAgZGVmaW5lZCA9IHt9LAogICAgICAgIHdhaXRpbmcgPSB7fSwKICAgICAgICBjb25maWcgPSB7fSwKICAgICAgICBkZWZpbmluZyA9IHt9LAogICAgICAgIGhhc093biA9IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHksCiAgICAgICAgYXBzID0gW10uc2xpY2UsCiAgICAgICAganNTdWZmaXhSZWdFeHAgPSAvXC5qcyQvOwoKICAgIGZ1bmN0aW9uIGhhc1Byb3Aob2JqLCBwcm9wKSB7CiAgICAgICAgcmV0dXJuIGhhc093bi5jYWxsKG9iaiwgcHJvcCk7CiAgICB9CgogICAgLyoqCiAgICAgKiBHaXZlbiBhIHJlbGF0aXZlIG1vZHVsZSBuYW1lLCBsaWtlIC4vc29tZXRoaW5nLCBub3JtYWxpemUgaXQgdG8KICAgICAqIGEgcmVhbCBuYW1lIHRoYXQgY2FuIGJlIG1hcHBlZCB0byBhIHBhdGguCiAgICAgKiBAcGFyYW0ge1N0cmluZ30gbmFtZSB0aGUgcmVsYXRpdmUgbmFtZQogICAgICogQHBhcmFtIHtTdHJpbmd9IGJhc2VOYW1lIGEgcmVhbCBuYW1lIHRoYXQgdGhlIG5hbWUgYXJnIGlzIHJlbGF0aXZlCiAgICAgKiB0by4KICAgICAqIEByZXR1cm5zIHtTdHJpbmd9IG5vcm1hbGl6ZWQgbmFtZQogICAgICovCiAgICBmdW5jdGlvbiBub3JtYWxpemUobmFtZSwgYmFzZU5hbWUpIHsKICAgICAgICB2YXIgbmFtZVBhcnRzLCBuYW1lU2VnbWVudCwgbWFwVmFsdWUsIGZvdW5kTWFwLCBsYXN0SW5kZXgsCiAgICAgICAgICAgIGZvdW5kSSwgZm91bmRTdGFyTWFwLCBzdGFySSwgaSwgaiwgcGFydCwKICAgICAgICAgICAgYmFzZVBhcnRzID0gYmFzZU5hbWUgJiYgYmFzZU5hbWUuc3BsaXQoIi8iKSwKICAgICAgICAgICAgbWFwID0gY29uZmlnLm1hcCwKICAgICAgICAgICAgc3Rhck1hcCA9IChtYXAgJiYgbWFwWycqJ10pIHx8IHt9OwoKICAgICAgICAvL0FkanVzdCBhbnkgcmVsYXRpdmUgcGF0aHMuCiAgICAgICAgaWYgKG5hbWUgJiYgbmFtZS5jaGFyQXQoMCkgPT09ICIuIikgewogICAgICAgICAgICAvL0lmIGhhdmUgYSBiYXNlIG5hbWUsIHRyeSB0byBub3JtYWxpemUgYWdhaW5zdCBpdCwKICAgICAgICAgICAgLy9vdGhlcndpc2UsIGFzc3VtZSBpdCBpcyBhIHRvcC1sZXZlbCByZXF1aXJlIHRoYXQgd2lsbAogICAgICAgICAgICAvL2JlIHJlbGF0aXZlIHRvIGJhc2VVcmwgaW4gdGhlIGVuZC4KICAgICAgICAgICAgaWYgKGJhc2VOYW1lKSB7CiAgICAgICAgICAgICAgICAvL0NvbnZlcnQgYmFzZU5hbWUgdG8gYXJyYXksIGFuZCBsb3Agb2ZmIHRoZSBsYXN0IHBhcnQsCiAgICAgICAgICAgICAgICAvL3NvIHRoYXQgLiBtYXRjaGVzIHRoYXQgImRpcmVjdG9yeSIgYW5kIG5vdCBuYW1lIG9mIHRoZSBiYXNlTmFtZSdzCiAgICAgICAgICAgICAgICAvL21vZHVsZS4gRm9yIGluc3RhbmNlLCBiYXNlTmFtZSBvZiAib25lL3R3by90aHJlZSIsIG1hcHMgdG8KICAgICAgICAgICAgICAgIC8vIm9uZS90d28vdGhyZWUuanMiLCBidXQgd2Ugd2FudCB0aGUgZGlyZWN0b3J5LCAib25lL3R3byIgZm9yCiAgICAgICAgICAgICAgICAvL3RoaXMgbm9ybWFsaXphdGlvbi4KICAgICAgICAgICAgICAgIGJhc2VQYXJ0cyA9IGJhc2VQYXJ0cy5zbGljZSgwLCBiYXNlUGFydHMubGVuZ3RoIC0gMSk7CiAgICAgICAgICAgICAgICBuYW1lID0gbmFtZS5zcGxpdCgnLycpOwogICAgICAgICAgICAgICAgbGFzdEluZGV4ID0gbmFtZS5sZW5ndGggLSAxOwoKICAgICAgICAgICAgICAgIC8vIE5vZGUgLmpzIGFsbG93YW5jZToKICAgICAgICAgICAgICAgIGlmIChjb25maWcubm9kZUlkQ29tcGF0ICYmIGpzU3VmZml4UmVnRXhwLnRlc3QobmFtZVtsYXN0SW5kZXhdKSkgewogICAgICAgICAgICAgICAgICAgIG5hbWVbbGFzdEluZGV4XSA9IG5hbWVbbGFzdEluZGV4XS5yZXBsYWNlKGpzU3VmZml4UmVnRXhwLCAnJyk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgbmFtZSA9IGJhc2VQYXJ0cy5jb25jYXQobmFtZSk7CgogICAgICAgICAgICAgICAgLy9zdGFydCB0cmltRG90cwogICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IG5hbWUubGVuZ3RoOyBpICs9IDEpIHsKICAgICAgICAgICAgICAgICAgICBwYXJ0ID0gbmFtZVtpXTsKICAgICAgICAgICAgICAgICAgICBpZiAocGFydCA9PT0gIi4iKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG5hbWUuc3BsaWNlKGksIDEpOwogICAgICAgICAgICAgICAgICAgICAgICBpIC09IDE7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChwYXJ0ID09PSAiLi4iKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpID09PSAxICYmIChuYW1lWzJdID09PSAnLi4nIHx8IG5hbWVbMF0gPT09ICcuLicpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvL0VuZCBvZiB0aGUgbGluZS4gS2VlcCBhdCBsZWFzdCBvbmUgbm9uLWRvdAogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy9wYXRoIHNlZ21lbnQgYXQgdGhlIGZyb250IHNvIGl0IGNhbiBiZSBtYXBwZWQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vY29ycmVjdGx5IHRvIGRpc2suIE90aGVyd2lzZSwgdGhlcmUgaXMgbGlrZWx5CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvL25vIHBhdGggbWFwcGluZyBmb3IgYSBwYXRoIHN0YXJ0aW5nIHdpdGggJy4uJy4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vVGhpcyBjYW4gc3RpbGwgZmFpbCwgYnV0IGNhdGNoZXMgdGhlIG1vc3QgcmVhc29uYWJsZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy91c2VzIG9mIC4uCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChpID4gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZS5zcGxpY2UoaSAtIDEsIDIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaSAtPSAyOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgLy9lbmQgdHJpbURvdHMKCiAgICAgICAgICAgICAgICBuYW1lID0gbmFtZS5qb2luKCIvIik7CiAgICAgICAgICAgIH0gZWxzZSBpZiAobmFtZS5pbmRleE9mKCcuLycpID09PSAwKSB7CiAgICAgICAgICAgICAgICAvLyBObyBiYXNlTmFtZSwgc28gdGhpcyBpcyBJRCBpcyByZXNvbHZlZCByZWxhdGl2ZQogICAgICAgICAgICAgICAgLy8gdG8gYmFzZVVybCwgcHVsbCBvZmYgdGhlIGxlYWRpbmcgZG90LgogICAgICAgICAgICAgICAgbmFtZSA9IG5hbWUuc3Vic3RyaW5nKDIpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvL0FwcGx5IG1hcCBjb25maWcgaWYgYXZhaWxhYmxlLgogICAgICAgIGlmICgoYmFzZVBhcnRzIHx8IHN0YXJNYXApICYmIG1hcCkgewogICAgICAgICAgICBuYW1lUGFydHMgPSBuYW1lLnNwbGl0KCcvJyk7CgogICAgICAgICAgICBmb3IgKGkgPSBuYW1lUGFydHMubGVuZ3RoOyBpID4gMDsgaSAtPSAxKSB7CiAgICAgICAgICAgICAgICBuYW1lU2VnbWVudCA9IG5hbWVQYXJ0cy5zbGljZSgwLCBpKS5qb2luKCIvIik7CgogICAgICAgICAgICAgICAgaWYgKGJhc2VQYXJ0cykgewogICAgICAgICAgICAgICAgICAgIC8vRmluZCB0aGUgbG9uZ2VzdCBiYXNlTmFtZSBzZWdtZW50IG1hdGNoIGluIHRoZSBjb25maWcuCiAgICAgICAgICAgICAgICAgICAgLy9TbywgZG8gam9pbnMgb24gdGhlIGJpZ2dlc3QgdG8gc21hbGxlc3QgbGVuZ3RocyBvZiBiYXNlUGFydHMuCiAgICAgICAgICAgICAgICAgICAgZm9yIChqID0gYmFzZVBhcnRzLmxlbmd0aDsgaiA+IDA7IGogLT0gMSkgewogICAgICAgICAgICAgICAgICAgICAgICBtYXBWYWx1ZSA9IG1hcFtiYXNlUGFydHMuc2xpY2UoMCwgaikuam9pbignLycpXTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vYmFzZU5hbWUgc2VnbWVudCBoYXMgIGNvbmZpZywgZmluZCBpZiBpdCBoYXMgb25lIGZvcgogICAgICAgICAgICAgICAgICAgICAgICAvL3RoaXMgbmFtZS4KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1hcFZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXBWYWx1ZSA9IG1hcFZhbHVlW25hbWVTZWdtZW50XTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtYXBWYWx1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vTWF0Y2gsIHVwZGF0ZSBuYW1lIHRvIHRoZSBuZXcgdmFsdWUuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm91bmRNYXAgPSBtYXBWYWx1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3VuZEkgPSBpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmIChmb3VuZE1hcCkgewogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vQ2hlY2sgZm9yIGEgc3RhciBtYXAgbWF0Y2gsIGJ1dCBqdXN0IGhvbGQgb24gdG8gaXQsCiAgICAgICAgICAgICAgICAvL2lmIHRoZXJlIGlzIGEgc2hvcnRlciBzZWdtZW50IG1hdGNoIGxhdGVyIGluIGEgbWF0Y2hpbmcKICAgICAgICAgICAgICAgIC8vY29uZmlnLCB0aGVuIGZhdm9yIG92ZXIgdGhpcyBzdGFyIG1hcC4KICAgICAgICAgICAgICAgIGlmICghZm91bmRTdGFyTWFwICYmIHN0YXJNYXAgJiYgc3Rhck1hcFtuYW1lU2VnbWVudF0pIHsKICAgICAgICAgICAgICAgICAgICBmb3VuZFN0YXJNYXAgPSBzdGFyTWFwW25hbWVTZWdtZW50XTsKICAgICAgICAgICAgICAgICAgICBzdGFySSA9IGk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICghZm91bmRNYXAgJiYgZm91bmRTdGFyTWFwKSB7CiAgICAgICAgICAgICAgICBmb3VuZE1hcCA9IGZvdW5kU3Rhck1hcDsKICAgICAgICAgICAgICAgIGZvdW5kSSA9IHN0YXJJOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoZm91bmRNYXApIHsKICAgICAgICAgICAgICAgIG5hbWVQYXJ0cy5zcGxpY2UoMCwgZm91bmRJLCBmb3VuZE1hcCk7CiAgICAgICAgICAgICAgICBuYW1lID0gbmFtZVBhcnRzLmpvaW4oJy8nKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIG5hbWU7CiAgICB9CgogICAgZnVuY3Rpb24gbWFrZVJlcXVpcmUocmVsTmFtZSwgZm9yY2VTeW5jKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgLy9BIHZlcnNpb24gb2YgYSByZXF1aXJlIGZ1bmN0aW9uIHRoYXQgcGFzc2VzIGEgbW9kdWxlTmFtZQogICAgICAgICAgICAvL3ZhbHVlIGZvciBpdGVtcyB0aGF0IG1heSBuZWVkIHRvCiAgICAgICAgICAgIC8vbG9vayB1cCBwYXRocyByZWxhdGl2ZSB0byB0aGUgbW9kdWxlTmFtZQogICAgICAgICAgICByZXR1cm4gcmVxLmFwcGx5KHVuZGVmLCBhcHMuY2FsbChhcmd1bWVudHMsIDApLmNvbmNhdChbcmVsTmFtZSwgZm9yY2VTeW5jXSkpOwogICAgICAgIH07CiAgICB9CgogICAgZnVuY3Rpb24gbWFrZU5vcm1hbGl6ZShyZWxOYW1lKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgICAgIHJldHVybiBub3JtYWxpemUobmFtZSwgcmVsTmFtZSk7CiAgICAgICAgfTsKICAgIH0KCiAgICBmdW5jdGlvbiBtYWtlTG9hZChkZXBOYW1lKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICBkZWZpbmVkW2RlcE5hbWVdID0gdmFsdWU7CiAgICAgICAgfTsKICAgIH0KCiAgICBmdW5jdGlvbiBjYWxsRGVwKG5hbWUpIHsKICAgICAgICBpZiAoaGFzUHJvcCh3YWl0aW5nLCBuYW1lKSkgewogICAgICAgICAgICB2YXIgYXJncyA9IHdhaXRpbmdbbmFtZV07CiAgICAgICAgICAgIGRlbGV0ZSB3YWl0aW5nW25hbWVdOwogICAgICAgICAgICBkZWZpbmluZ1tuYW1lXSA9IHRydWU7CiAgICAgICAgICAgIG1haW4uYXBwbHkodW5kZWYsIGFyZ3MpOwogICAgICAgIH0KCiAgICAgICAgaWYgKCFoYXNQcm9wKGRlZmluZWQsIG5hbWUpICYmICFoYXNQcm9wKGRlZmluaW5nLCBuYW1lKSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ05vICcgKyBuYW1lKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGRlZmluZWRbbmFtZV07CiAgICB9CgogICAgLy9UdXJucyBhIHBsdWdpbiFyZXNvdXJjZSB0byBbcGx1Z2luLCByZXNvdXJjZV0KICAgIC8vd2l0aCB0aGUgcGx1Z2luIGJlaW5nIHVuZGVmaW5lZCBpZiB0aGUgbmFtZQogICAgLy9kaWQgbm90IGhhdmUgYSBwbHVnaW4gcHJlZml4LgogICAgZnVuY3Rpb24gc3BsaXRQcmVmaXgobmFtZSkgewogICAgICAgIHZhciBwcmVmaXgsCiAgICAgICAgICAgIGluZGV4ID0gbmFtZSA/IG5hbWUuaW5kZXhPZignIScpIDogLTE7CiAgICAgICAgaWYgKGluZGV4ID4gLTEpIHsKICAgICAgICAgICAgcHJlZml4ID0gbmFtZS5zdWJzdHJpbmcoMCwgaW5kZXgpOwogICAgICAgICAgICBuYW1lID0gbmFtZS5zdWJzdHJpbmcoaW5kZXggKyAxLCBuYW1lLmxlbmd0aCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBbcHJlZml4LCBuYW1lXTsKICAgIH0KCiAgICAvKioKICAgICAqIE1ha2VzIGEgbmFtZSBtYXAsIG5vcm1hbGl6aW5nIHRoZSBuYW1lLCBhbmQgdXNpbmcgYSBwbHVnaW4KICAgICAqIGZvciBub3JtYWxpemF0aW9uIGlmIG5lY2Vzc2FyeS4gR3JhYnMgYSByZWYgdG8gcGx1Z2luCiAgICAgKiB0b28sIGFzIGFuIG9wdGltaXphdGlvbi4KICAgICAqLwogICAgbWFrZU1hcCA9IGZ1bmN0aW9uIChuYW1lLCByZWxOYW1lKSB7CiAgICAgICAgdmFyIHBsdWdpbiwKICAgICAgICAgICAgcGFydHMgPSBzcGxpdFByZWZpeChuYW1lKSwKICAgICAgICAgICAgcHJlZml4ID0gcGFydHNbMF07CgogICAgICAgIG5hbWUgPSBwYXJ0c1sxXTsKCiAgICAgICAgaWYgKHByZWZpeCkgewogICAgICAgICAgICBwcmVmaXggPSBub3JtYWxpemUocHJlZml4LCByZWxOYW1lKTsKICAgICAgICAgICAgcGx1Z2luID0gY2FsbERlcChwcmVmaXgpOwogICAgICAgIH0KCiAgICAgICAgLy9Ob3JtYWxpemUgYWNjb3JkaW5nCiAgICAgICAgaWYgKHByZWZpeCkgewogICAgICAgICAgICBpZiAocGx1Z2luICYmIHBsdWdpbi5ub3JtYWxpemUpIHsKICAgICAgICAgICAgICAgIG5hbWUgPSBwbHVnaW4ubm9ybWFsaXplKG5hbWUsIG1ha2VOb3JtYWxpemUocmVsTmFtZSkpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgbmFtZSA9IG5vcm1hbGl6ZShuYW1lLCByZWxOYW1lKTsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIG5hbWUgPSBub3JtYWxpemUobmFtZSwgcmVsTmFtZSk7CiAgICAgICAgICAgIHBhcnRzID0gc3BsaXRQcmVmaXgobmFtZSk7CiAgICAgICAgICAgIHByZWZpeCA9IHBhcnRzWzBdOwogICAgICAgICAgICBuYW1lID0gcGFydHNbMV07CiAgICAgICAgICAgIGlmIChwcmVmaXgpIHsKICAgICAgICAgICAgICAgIHBsdWdpbiA9IGNhbGxEZXAocHJlZml4KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy9Vc2luZyByaWRpY3Vsb3VzIHByb3BlcnR5IG5hbWVzIGZvciBzcGFjZSByZWFzb25zCiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgZjogcHJlZml4ID8gcHJlZml4ICsgJyEnICsgbmFtZSA6IG5hbWUsIC8vZnVsbE5hbWUKICAgICAgICAgICAgbjogbmFtZSwKICAgICAgICAgICAgcHI6IHByZWZpeCwKICAgICAgICAgICAgcDogcGx1Z2luCiAgICAgICAgfTsKICAgIH07CgogICAgZnVuY3Rpb24gbWFrZUNvbmZpZyhuYW1lKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIChjb25maWcgJiYgY29uZmlnLmNvbmZpZyAmJiBjb25maWcuY29uZmlnW25hbWVdKSB8fCB7fTsKICAgICAgICB9OwogICAgfQoKICAgIGhhbmRsZXJzID0gewogICAgICAgIHJlcXVpcmU6IGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgICAgIHJldHVybiBtYWtlUmVxdWlyZShuYW1lKTsKICAgICAgICB9LAogICAgICAgIGV4cG9ydHM6IGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgICAgIHZhciBlID0gZGVmaW5lZFtuYW1lXTsKICAgICAgICAgICAgaWYgKHR5cGVvZiBlICE9PSAndW5kZWZpbmVkJykgewogICAgICAgICAgICAgICAgcmV0dXJuIGU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gKGRlZmluZWRbbmFtZV0gPSB7fSk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIG1vZHVsZTogZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgIGlkOiBuYW1lLAogICAgICAgICAgICAgICAgdXJpOiAnJywKICAgICAgICAgICAgICAgIGV4cG9ydHM6IGRlZmluZWRbbmFtZV0sCiAgICAgICAgICAgICAgICBjb25maWc6IG1ha2VDb25maWcobmFtZSkKICAgICAgICAgICAgfTsKICAgICAgICB9CiAgICB9OwoKICAgIG1haW4gPSBmdW5jdGlvbiAobmFtZSwgZGVwcywgY2FsbGJhY2ssIHJlbE5hbWUpIHsKICAgICAgICB2YXIgY2pzTW9kdWxlLCBkZXBOYW1lLCByZXQsIG1hcCwgaSwKICAgICAgICAgICAgYXJncyA9IFtdLAogICAgICAgICAgICBjYWxsYmFja1R5cGUgPSB0eXBlb2YgY2FsbGJhY2ssCiAgICAgICAgICAgIHVzaW5nRXhwb3J0czsKCiAgICAgICAgLy9Vc2UgbmFtZSBpZiBubyByZWxOYW1lCiAgICAgICAgcmVsTmFtZSA9IHJlbE5hbWUgfHwgbmFtZTsKCiAgICAgICAgLy9DYWxsIHRoZSBjYWxsYmFjayB0byBkZWZpbmUgdGhlIG1vZHVsZSwgaWYgbmVjZXNzYXJ5LgogICAgICAgIGlmIChjYWxsYmFja1R5cGUgPT09ICd1bmRlZmluZWQnIHx8IGNhbGxiYWNrVHlwZSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICAvL1B1bGwgb3V0IHRoZSBkZWZpbmVkIGRlcGVuZGVuY2llcyBhbmQgcGFzcyB0aGUgb3JkZXJlZAogICAgICAgICAgICAvL3ZhbHVlcyB0byB0aGUgY2FsbGJhY2suCiAgICAgICAgICAgIC8vRGVmYXVsdCB0byBbcmVxdWlyZSwgZXhwb3J0cywgbW9kdWxlXSBpZiBubyBkZXBzCiAgICAgICAgICAgIGRlcHMgPSAhZGVwcy5sZW5ndGggJiYgY2FsbGJhY2subGVuZ3RoID8gWydyZXF1aXJlJywgJ2V4cG9ydHMnLCAnbW9kdWxlJ10gOiBkZXBzOwogICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgZGVwcy5sZW5ndGg7IGkgKz0gMSkgewogICAgICAgICAgICAgICAgbWFwID0gbWFrZU1hcChkZXBzW2ldLCByZWxOYW1lKTsKICAgICAgICAgICAgICAgIGRlcE5hbWUgPSBtYXAuZjsKCiAgICAgICAgICAgICAgICAvL0Zhc3QgcGF0aCBDb21tb25KUyBzdGFuZGFyZCBkZXBlbmRlbmNpZXMuCiAgICAgICAgICAgICAgICBpZiAoZGVwTmFtZSA9PT0gInJlcXVpcmUiKSB7CiAgICAgICAgICAgICAgICAgICAgYXJnc1tpXSA9IGhhbmRsZXJzLnJlcXVpcmUobmFtZSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGRlcE5hbWUgPT09ICJleHBvcnRzIikgewogICAgICAgICAgICAgICAgICAgIC8vQ29tbW9uSlMgbW9kdWxlIHNwZWMgMS4xCiAgICAgICAgICAgICAgICAgICAgYXJnc1tpXSA9IGhhbmRsZXJzLmV4cG9ydHMobmFtZSk7CiAgICAgICAgICAgICAgICAgICAgdXNpbmdFeHBvcnRzID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoZGVwTmFtZSA9PT0gIm1vZHVsZSIpIHsKICAgICAgICAgICAgICAgICAgICAvL0NvbW1vbkpTIG1vZHVsZSBzcGVjIDEuMQogICAgICAgICAgICAgICAgICAgIGNqc01vZHVsZSA9IGFyZ3NbaV0gPSBoYW5kbGVycy5tb2R1bGUobmFtZSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGhhc1Byb3AoZGVmaW5lZCwgZGVwTmFtZSkgfHwKICAgICAgICAgICAgICAgICAgICAgICAgICAgaGFzUHJvcCh3YWl0aW5nLCBkZXBOYW1lKSB8fAogICAgICAgICAgICAgICAgICAgICAgICAgICBoYXNQcm9wKGRlZmluaW5nLCBkZXBOYW1lKSkgewogICAgICAgICAgICAgICAgICAgIGFyZ3NbaV0gPSBjYWxsRGVwKGRlcE5hbWUpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChtYXAucCkgewogICAgICAgICAgICAgICAgICAgIG1hcC5wLmxvYWQobWFwLm4sIG1ha2VSZXF1aXJlKHJlbE5hbWUsIHRydWUpLCBtYWtlTG9hZChkZXBOYW1lKSwge30pOwogICAgICAgICAgICAgICAgICAgIGFyZ3NbaV0gPSBkZWZpbmVkW2RlcE5hbWVdOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IobmFtZSArICcgbWlzc2luZyAnICsgZGVwTmFtZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldCA9IGNhbGxiYWNrID8gY2FsbGJhY2suYXBwbHkoZGVmaW5lZFtuYW1lXSwgYXJncykgOiB1bmRlZmluZWQ7CgogICAgICAgICAgICBpZiAobmFtZSkgewogICAgICAgICAgICAgICAgLy9JZiBzZXR0aW5nIGV4cG9ydHMgdmlhICJtb2R1bGUiIGlzIGluIHBsYXksCiAgICAgICAgICAgICAgICAvL2Zhdm9yIHRoYXQgb3ZlciByZXR1cm4gdmFsdWUgYW5kIGV4cG9ydHMuIEFmdGVyIHRoYXQsCiAgICAgICAgICAgICAgICAvL2Zhdm9yIGEgbm9uLXVuZGVmaW5lZCByZXR1cm4gdmFsdWUgb3ZlciBleHBvcnRzIHVzZS4KICAgICAgICAgICAgICAgIGlmIChjanNNb2R1bGUgJiYgY2pzTW9kdWxlLmV4cG9ydHMgIT09IHVuZGVmICYmCiAgICAgICAgICAgICAgICAgICAgICAgIGNqc01vZHVsZS5leHBvcnRzICE9PSBkZWZpbmVkW25hbWVdKSB7CiAgICAgICAgICAgICAgICAgICAgZGVmaW5lZFtuYW1lXSA9IGNqc01vZHVsZS5leHBvcnRzOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChyZXQgIT09IHVuZGVmIHx8ICF1c2luZ0V4cG9ydHMpIHsKICAgICAgICAgICAgICAgICAgICAvL1VzZSB0aGUgcmV0dXJuIHZhbHVlIGZyb20gdGhlIGZ1bmN0aW9uLgogICAgICAgICAgICAgICAgICAgIGRlZmluZWRbbmFtZV0gPSByZXQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKG5hbWUpIHsKICAgICAgICAgICAgLy9NYXkganVzdCBiZSBhbiBvYmplY3QgZGVmaW5pdGlvbiBmb3IgdGhlIG1vZHVsZS4gT25seQogICAgICAgICAgICAvL3dvcnJ5IGFib3V0IGRlZmluaW5nIGlmIGhhdmUgYSBtb2R1bGUgbmFtZS4KICAgICAgICAgICAgZGVmaW5lZFtuYW1lXSA9IGNhbGxiYWNrOwogICAgICAgIH0KICAgIH07CgogICAgcmVxdWlyZWpzID0gcmVxdWlyZSA9IHJlcSA9IGZ1bmN0aW9uIChkZXBzLCBjYWxsYmFjaywgcmVsTmFtZSwgZm9yY2VTeW5jLCBhbHQpIHsKICAgICAgICBpZiAodHlwZW9mIGRlcHMgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgIGlmIChoYW5kbGVyc1tkZXBzXSkgewogICAgICAgICAgICAgICAgLy9jYWxsYmFjayBpbiB0aGlzIGNhc2UgaXMgcmVhbGx5IHJlbE5hbWUKICAgICAgICAgICAgICAgIHJldHVybiBoYW5kbGVyc1tkZXBzXShjYWxsYmFjayk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy9KdXN0IHJldHVybiB0aGUgbW9kdWxlIHdhbnRlZC4gSW4gdGhpcyBzY2VuYXJpbywgdGhlCiAgICAgICAgICAgIC8vZGVwcyBhcmcgaXMgdGhlIG1vZHVsZSBuYW1lLCBhbmQgc2Vjb25kIGFyZyAoaWYgcGFzc2VkKQogICAgICAgICAgICAvL2lzIGp1c3QgdGhlIHJlbE5hbWUuCiAgICAgICAgICAgIC8vTm9ybWFsaXplIG1vZHVsZSBuYW1lLCBpZiBpdCBjb250YWlucyAuIG9yIC4uCiAgICAgICAgICAgIHJldHVybiBjYWxsRGVwKG1ha2VNYXAoZGVwcywgY2FsbGJhY2spLmYpOwogICAgICAgIH0gZWxzZSBpZiAoIWRlcHMuc3BsaWNlKSB7CiAgICAgICAgICAgIC8vZGVwcyBpcyBhIGNvbmZpZyBvYmplY3QsIG5vdCBhbiBhcnJheS4KICAgICAgICAgICAgY29uZmlnID0gZGVwczsKICAgICAgICAgICAgaWYgKGNvbmZpZy5kZXBzKSB7CiAgICAgICAgICAgICAgICByZXEoY29uZmlnLmRlcHMsIGNvbmZpZy5jYWxsYmFjayk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCFjYWxsYmFjaykgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoY2FsbGJhY2suc3BsaWNlKSB7CiAgICAgICAgICAgICAgICAvL2NhbGxiYWNrIGlzIGFuIGFycmF5LCB3aGljaCBtZWFucyBpdCBpcyBhIGRlcGVuZGVuY3kgbGlzdC4KICAgICAgICAgICAgICAgIC8vQWRqdXN0IGFyZ3MgaWYgdGhlcmUgYXJlIGRlcGVuZGVuY2llcwogICAgICAgICAgICAgICAgZGVwcyA9IGNhbGxiYWNrOwogICAgICAgICAgICAgICAgY2FsbGJhY2sgPSByZWxOYW1lOwogICAgICAgICAgICAgICAgcmVsTmFtZSA9IG51bGw7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBkZXBzID0gdW5kZWY7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vU3VwcG9ydCByZXF1aXJlKFsnYSddKQogICAgICAgIGNhbGxiYWNrID0gY2FsbGJhY2sgfHwgZnVuY3Rpb24gKCkge307CgogICAgICAgIC8vSWYgcmVsTmFtZSBpcyBhIGZ1bmN0aW9uLCBpdCBpcyBhbiBlcnJiYWNrIGhhbmRsZXIsCiAgICAgICAgLy9zbyByZW1vdmUgaXQuCiAgICAgICAgaWYgKHR5cGVvZiByZWxOYW1lID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgIHJlbE5hbWUgPSBmb3JjZVN5bmM7CiAgICAgICAgICAgIGZvcmNlU3luYyA9IGFsdDsKICAgICAgICB9CgogICAgICAgIC8vU2ltdWxhdGUgYXN5bmMgY2FsbGJhY2s7CiAgICAgICAgaWYgKGZvcmNlU3luYykgewogICAgICAgICAgICBtYWluKHVuZGVmLCBkZXBzLCBjYWxsYmFjaywgcmVsTmFtZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgLy9Vc2luZyBhIG5vbi16ZXJvIHZhbHVlIGJlY2F1c2Ugb2YgY29uY2VybiBmb3Igd2hhdCBvbGQgYnJvd3NlcnMKICAgICAgICAgICAgLy9kbywgYW5kIGxhdGVzdCBicm93c2VycyAidXBncmFkZSIgdG8gNCBpZiBsb3dlciB2YWx1ZSBpcyB1c2VkOgogICAgICAgICAgICAvL2h0dHA6Ly93d3cud2hhdHdnLm9yZy9zcGVjcy93ZWItYXBwcy9jdXJyZW50LXdvcmsvbXVsdGlwYWdlL3RpbWVycy5odG1sI2RvbS13aW5kb3d0aW1lcnMtc2V0dGltZW91dDoKICAgICAgICAgICAgLy9JZiB3YW50IGEgdmFsdWUgaW1tZWRpYXRlbHksIHVzZSByZXF1aXJlKCdpZCcpIGluc3RlYWQgLS0gc29tZXRoaW5nCiAgICAgICAgICAgIC8vdGhhdCB3b3JrcyBpbiBhbG1vbmQgb24gdGhlIGdsb2JhbCBsZXZlbCwgYnV0IG5vdCBndWFyYW50ZWVkIGFuZAogICAgICAgICAgICAvL3VubGlrZWx5IHRvIHdvcmsgaW4gb3RoZXIgQU1EIGltcGxlbWVudGF0aW9ucy4KICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICBtYWluKHVuZGVmLCBkZXBzLCBjYWxsYmFjaywgcmVsTmFtZSk7CiAgICAgICAgICAgIH0sIDQpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHJlcTsKICAgIH07CgogICAgLyoqCiAgICAgKiBKdXN0IGRyb3BzIHRoZSBjb25maWcgb24gdGhlIGZsb29yLCBidXQgcmV0dXJucyByZXEgaW4gY2FzZQogICAgICogdGhlIGNvbmZpZyByZXR1cm4gdmFsdWUgaXMgdXNlZC4KICAgICAqLwogICAgcmVxLmNvbmZpZyA9IGZ1bmN0aW9uIChjZmcpIHsKICAgICAgICByZXR1cm4gcmVxKGNmZyk7CiAgICB9OwoKICAgIC8qKgogICAgICogRXhwb3NlIG1vZHVsZSByZWdpc3RyeSBmb3IgZGVidWdnaW5nIGFuZCB0b29saW5nCiAgICAgKi8KICAgIHJlcXVpcmVqcy5fZGVmaW5lZCA9IGRlZmluZWQ7CgogICAgZGVmaW5lID0gZnVuY3Rpb24gKG5hbWUsIGRlcHMsIGNhbGxiYWNrKSB7CgogICAgICAgIC8vVGhpcyBtb2R1bGUgbWF5IG5vdCBoYXZlIGRlcGVuZGVuY2llcwogICAgICAgIGlmICghZGVwcy5zcGxpY2UpIHsKICAgICAgICAgICAgLy9kZXBzIGlzIG5vdCBhbiBhcnJheSwgc28gcHJvYmFibHkgbWVhbnMKICAgICAgICAgICAgLy9hbiBvYmplY3QgbGl0ZXJhbCBvciBmYWN0b3J5IGZ1bmN0aW9uIGZvcgogICAgICAgICAgICAvL3RoZSB2YWx1ZS4gQWRqdXN0IGFyZ3MuCiAgICAgICAgICAgIGNhbGxiYWNrID0gZGVwczsKICAgICAgICAgICAgZGVwcyA9IFtdOwogICAgICAgIH0KCiAgICAgICAgaWYgKCFoYXNQcm9wKGRlZmluZWQsIG5hbWUpICYmICFoYXNQcm9wKHdhaXRpbmcsIG5hbWUpKSB7CiAgICAgICAgICAgIHdhaXRpbmdbbmFtZV0gPSBbbmFtZSwgZGVwcywgY2FsbGJhY2tdOwogICAgICAgIH0KICAgIH07CgogICAgZGVmaW5lLmFtZCA9IHsKICAgICAgICBqUXVlcnk6IHRydWUKICAgIH07Cn0oKSk7CgpkZWZpbmUoImFsbW9uZCIsIGZ1bmN0aW9uKCl7fSk7CgovLyAgICAgVW5kZXJzY29yZS5qcyAxLjQuNAovLyAgICAgaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcKLy8gICAgIChjKSAyMDA5LTIwMTMgSmVyZW15IEFzaGtlbmFzLCBEb2N1bWVudENsb3VkIEluYy4KLy8gICAgIFVuZGVyc2NvcmUgbWF5IGJlIGZyZWVseSBkaXN0cmlidXRlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuCgooZnVuY3Rpb24oKSB7CgogIC8vIEJhc2VsaW5lIHNldHVwCiAgLy8gLS0tLS0tLS0tLS0tLS0KCiAgLy8gRXN0YWJsaXNoIHRoZSByb290IG9iamVjdCwgYHdpbmRvd2AgaW4gdGhlIGJyb3dzZXIsIG9yIGBnbG9iYWxgIG9uIHRoZSBzZXJ2ZXIuCiAgdmFyIHJvb3QgPSB0aGlzOwoKICAvLyBTYXZlIHRoZSBwcmV2aW91cyB2YWx1ZSBvZiB0aGUgYF9gIHZhcmlhYmxlLgogIHZhciBwcmV2aW91c1VuZGVyc2NvcmUgPSByb290Ll87CgogIC8vIEVzdGFibGlzaCB0aGUgb2JqZWN0IHRoYXQgZ2V0cyByZXR1cm5lZCB0byBicmVhayBvdXQgb2YgYSBsb29wIGl0ZXJhdGlvbi4KICB2YXIgYnJlYWtlciA9IHt9OwoKICAvLyBTYXZlIGJ5dGVzIGluIHRoZSBtaW5pZmllZCAoYnV0IG5vdCBnemlwcGVkKSB2ZXJzaW9uOgogIHZhciBBcnJheVByb3RvID0gQXJyYXkucHJvdG90eXBlLCBPYmpQcm90byA9IE9iamVjdC5wcm90b3R5cGUsIEZ1bmNQcm90byA9IEZ1bmN0aW9uLnByb3RvdHlwZTsKCiAgLy8gQ3JlYXRlIHF1aWNrIHJlZmVyZW5jZSB2YXJpYWJsZXMgZm9yIHNwZWVkIGFjY2VzcyB0byBjb3JlIHByb3RvdHlwZXMuCiAgdmFyIHB1c2ggICAgICAgICAgICAgPSBBcnJheVByb3RvLnB1c2gsCiAgICAgIHNsaWNlICAgICAgICAgICAgPSBBcnJheVByb3RvLnNsaWNlLAogICAgICBjb25jYXQgICAgICAgICAgID0gQXJyYXlQcm90by5jb25jYXQsCiAgICAgIHRvU3RyaW5nICAgICAgICAgPSBPYmpQcm90by50b1N0cmluZywKICAgICAgaGFzT3duUHJvcGVydHkgICA9IE9ialByb3RvLmhhc093blByb3BlcnR5OwoKICAvLyBBbGwgKipFQ01BU2NyaXB0IDUqKiBuYXRpdmUgZnVuY3Rpb24gaW1wbGVtZW50YXRpb25zIHRoYXQgd2UgaG9wZSB0byB1c2UKICAvLyBhcmUgZGVjbGFyZWQgaGVyZS4KICB2YXIKICAgIG5hdGl2ZUZvckVhY2ggICAgICA9IEFycmF5UHJvdG8uZm9yRWFjaCwKICAgIG5hdGl2ZU1hcCAgICAgICAgICA9IEFycmF5UHJvdG8ubWFwLAogICAgbmF0aXZlUmVkdWNlICAgICAgID0gQXJyYXlQcm90by5yZWR1Y2UsCiAgICBuYXRpdmVSZWR1Y2VSaWdodCAgPSBBcnJheVByb3RvLnJlZHVjZVJpZ2h0LAogICAgbmF0aXZlRmlsdGVyICAgICAgID0gQXJyYXlQcm90by5maWx0ZXIsCiAgICBuYXRpdmVFdmVyeSAgICAgICAgPSBBcnJheVByb3RvLmV2ZXJ5LAogICAgbmF0aXZlU29tZSAgICAgICAgID0gQXJyYXlQcm90by5zb21lLAogICAgbmF0aXZlSW5kZXhPZiAgICAgID0gQXJyYXlQcm90by5pbmRleE9mLAogICAgbmF0aXZlTGFzdEluZGV4T2YgID0gQXJyYXlQcm90by5sYXN0SW5kZXhPZiwKICAgIG5hdGl2ZUlzQXJyYXkgICAgICA9IEFycmF5LmlzQXJyYXksCiAgICBuYXRpdmVLZXlzICAgICAgICAgPSBPYmplY3Qua2V5cywKICAgIG5hdGl2ZUJpbmQgICAgICAgICA9IEZ1bmNQcm90by5iaW5kOwoKICAvLyBDcmVhdGUgYSBzYWZlIHJlZmVyZW5jZSB0byB0aGUgVW5kZXJzY29yZSBvYmplY3QgZm9yIHVzZSBiZWxvdy4KICB2YXIgXyA9IGZ1bmN0aW9uKG9iaikgewogICAgaWYgKG9iaiBpbnN0YW5jZW9mIF8pIHJldHVybiBvYmo7CiAgICBpZiAoISh0aGlzIGluc3RhbmNlb2YgXykpIHJldHVybiBuZXcgXyhvYmopOwogICAgdGhpcy5fd3JhcHBlZCA9IG9iajsKICB9OwoKICAvLyBFeHBvcnQgdGhlIFVuZGVyc2NvcmUgb2JqZWN0IGZvciAqKk5vZGUuanMqKiwgd2l0aAogIC8vIGJhY2t3YXJkcy1jb21wYXRpYmlsaXR5IGZvciB0aGUgb2xkIGByZXF1aXJlKClgIEFQSS4gSWYgd2UncmUgaW4KICAvLyB0aGUgYnJvd3NlciwgYWRkIGBfYCBhcyBhIGdsb2JhbCBvYmplY3QgdmlhIGEgc3RyaW5nIGlkZW50aWZpZXIsCiAgLy8gZm9yIENsb3N1cmUgQ29tcGlsZXIgImFkdmFuY2VkIiBtb2RlLgogIGlmICh0eXBlb2YgZXhwb3J0cyAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgIGlmICh0eXBlb2YgbW9kdWxlICE9PSAndW5kZWZpbmVkJyAmJiBtb2R1bGUuZXhwb3J0cykgewogICAgICBleHBvcnRzID0gbW9kdWxlLmV4cG9ydHMgPSBfOwogICAgfQogICAgZXhwb3J0cy5fID0gXzsKICB9IGVsc2UgewogICAgcm9vdC5fID0gXzsKICB9CgogIC8vIEN1cnJlbnQgdmVyc2lvbi4KICBfLlZFUlNJT04gPSAnMS40LjQnOwoKICAvLyBDb2xsZWN0aW9uIEZ1bmN0aW9ucwogIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tCgogIC8vIFRoZSBjb3JuZXJzdG9uZSwgYW4gYGVhY2hgIGltcGxlbWVudGF0aW9uLCBha2EgYGZvckVhY2hgLgogIC8vIEhhbmRsZXMgb2JqZWN0cyB3aXRoIHRoZSBidWlsdC1pbiBgZm9yRWFjaGAsIGFycmF5cywgYW5kIHJhdyBvYmplY3RzLgogIC8vIERlbGVnYXRlcyB0byAqKkVDTUFTY3JpcHQgNSoqJ3MgbmF0aXZlIGBmb3JFYWNoYCBpZiBhdmFpbGFibGUuCiAgdmFyIGVhY2ggPSBfLmVhY2ggPSBfLmZvckVhY2ggPSBmdW5jdGlvbihvYmosIGl0ZXJhdG9yLCBjb250ZXh0KSB7CiAgICBpZiAob2JqID09IG51bGwpIHJldHVybjsKICAgIGlmIChuYXRpdmVGb3JFYWNoICYmIG9iai5mb3JFYWNoID09PSBuYXRpdmVGb3JFYWNoKSB7CiAgICAgIG9iai5mb3JFYWNoKGl0ZXJhdG9yLCBjb250ZXh0KTsKICAgIH0gZWxzZSBpZiAob2JqLmxlbmd0aCA9PT0gK29iai5sZW5ndGgpIHsKICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSBvYmoubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgaWYgKGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgb2JqW2ldLCBpLCBvYmopID09PSBicmVha2VyKSByZXR1cm47CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGZvciAodmFyIGtleSBpbiBvYmopIHsKICAgICAgICBpZiAoXy5oYXMob2JqLCBrZXkpKSB7CiAgICAgICAgICBpZiAoaXRlcmF0b3IuY2FsbChjb250ZXh0LCBvYmpba2V5XSwga2V5LCBvYmopID09PSBicmVha2VyKSByZXR1cm47CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfTsKCiAgLy8gUmV0dXJuIHRoZSByZXN1bHRzIG9mIGFwcGx5aW5nIHRoZSBpdGVyYXRvciB0byBlYWNoIGVsZW1lbnQuCiAgLy8gRGVsZWdhdGVzIHRvICoqRUNNQVNjcmlwdCA1KioncyBuYXRpdmUgYG1hcGAgaWYgYXZhaWxhYmxlLgogIF8ubWFwID0gXy5jb2xsZWN0ID0gZnVuY3Rpb24ob2JqLCBpdGVyYXRvciwgY29udGV4dCkgewogICAgdmFyIHJlc3VsdHMgPSBbXTsKICAgIGlmIChvYmogPT0gbnVsbCkgcmV0dXJuIHJlc3VsdHM7CiAgICBpZiAobmF0aXZlTWFwICYmIG9iai5tYXAgPT09IG5hdGl2ZU1hcCkgcmV0dXJuIG9iai5tYXAoaXRlcmF0b3IsIGNvbnRleHQpOwogICAgZWFjaChvYmosIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgbGlzdCkgewogICAgICByZXN1bHRzW3Jlc3VsdHMubGVuZ3RoXSA9IGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgdmFsdWUsIGluZGV4LCBsaXN0KTsKICAgIH0pOwogICAgcmV0dXJuIHJlc3VsdHM7CiAgfTsKCiAgdmFyIHJlZHVjZUVycm9yID0gJ1JlZHVjZSBvZiBlbXB0eSBhcnJheSB3aXRoIG5vIGluaXRpYWwgdmFsdWUnOwoKICAvLyAqKlJlZHVjZSoqIGJ1aWxkcyB1cCBhIHNpbmdsZSByZXN1bHQgZnJvbSBhIGxpc3Qgb2YgdmFsdWVzLCBha2EgYGluamVjdGAsCiAgLy8gb3IgYGZvbGRsYC4gRGVsZWdhdGVzIHRvICoqRUNNQVNjcmlwdCA1KioncyBuYXRpdmUgYHJlZHVjZWAgaWYgYXZhaWxhYmxlLgogIF8ucmVkdWNlID0gXy5mb2xkbCA9IF8uaW5qZWN0ID0gZnVuY3Rpb24ob2JqLCBpdGVyYXRvciwgbWVtbywgY29udGV4dCkgewogICAgdmFyIGluaXRpYWwgPSBhcmd1bWVudHMubGVuZ3RoID4gMjsKICAgIGlmIChvYmogPT0gbnVsbCkgb2JqID0gW107CiAgICBpZiAobmF0aXZlUmVkdWNlICYmIG9iai5yZWR1Y2UgPT09IG5hdGl2ZVJlZHVjZSkgewogICAgICBpZiAoY29udGV4dCkgaXRlcmF0b3IgPSBfLmJpbmQoaXRlcmF0b3IsIGNvbnRleHQpOwogICAgICByZXR1cm4gaW5pdGlhbCA/IG9iai5yZWR1Y2UoaXRlcmF0b3IsIG1lbW8pIDogb2JqLnJlZHVjZShpdGVyYXRvcik7CiAgICB9CiAgICBlYWNoKG9iaiwgZnVuY3Rpb24odmFsdWUsIGluZGV4LCBsaXN0KSB7CiAgICAgIGlmICghaW5pdGlhbCkgewogICAgICAgIG1lbW8gPSB2YWx1ZTsKICAgICAgICBpbml0aWFsID0gdHJ1ZTsKICAgICAgfSBlbHNlIHsKICAgICAgICBtZW1vID0gaXRlcmF0b3IuY2FsbChjb250ZXh0LCBtZW1vLCB2YWx1ZSwgaW5kZXgsIGxpc3QpOwogICAgICB9CiAgICB9KTsKICAgIGlmICghaW5pdGlhbCkgdGhyb3cgbmV3IFR5cGVFcnJvcihyZWR1Y2VFcnJvcik7CiAgICByZXR1cm4gbWVtbzsKICB9OwoKICAvLyBUaGUgcmlnaHQtYXNzb2NpYXRpdmUgdmVyc2lvbiBvZiByZWR1Y2UsIGFsc28ga25vd24gYXMgYGZvbGRyYC4KICAvLyBEZWxlZ2F0ZXMgdG8gKipFQ01BU2NyaXB0IDUqKidzIG5hdGl2ZSBgcmVkdWNlUmlnaHRgIGlmIGF2YWlsYWJsZS4KICBfLnJlZHVjZVJpZ2h0ID0gXy5mb2xkciA9IGZ1bmN0aW9uKG9iaiwgaXRlcmF0b3IsIG1lbW8sIGNvbnRleHQpIHsKICAgIHZhciBpbml0aWFsID0gYXJndW1lbnRzLmxlbmd0aCA+IDI7CiAgICBpZiAob2JqID09IG51bGwpIG9iaiA9IFtdOwogICAgaWYgKG5hdGl2ZVJlZHVjZVJpZ2h0ICYmIG9iai5yZWR1Y2VSaWdodCA9PT0gbmF0aXZlUmVkdWNlUmlnaHQpIHsKICAgICAgaWYgKGNvbnRleHQpIGl0ZXJhdG9yID0gXy5iaW5kKGl0ZXJhdG9yLCBjb250ZXh0KTsKICAgICAgcmV0dXJuIGluaXRpYWwgPyBvYmoucmVkdWNlUmlnaHQoaXRlcmF0b3IsIG1lbW8pIDogb2JqLnJlZHVjZVJpZ2h0KGl0ZXJhdG9yKTsKICAgIH0KICAgIHZhciBsZW5ndGggPSBvYmoubGVuZ3RoOwogICAgaWYgKGxlbmd0aCAhPT0gK2xlbmd0aCkgewogICAgICB2YXIga2V5cyA9IF8ua2V5cyhvYmopOwogICAgICBsZW5ndGggPSBrZXlzLmxlbmd0aDsKICAgIH0KICAgIGVhY2gob2JqLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGxpc3QpIHsKICAgICAgaW5kZXggPSBrZXlzID8ga2V5c1stLWxlbmd0aF0gOiAtLWxlbmd0aDsKICAgICAgaWYgKCFpbml0aWFsKSB7CiAgICAgICAgbWVtbyA9IG9ialtpbmRleF07CiAgICAgICAgaW5pdGlhbCA9IHRydWU7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgbWVtbyA9IGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgbWVtbywgb2JqW2luZGV4XSwgaW5kZXgsIGxpc3QpOwogICAgICB9CiAgICB9KTsKICAgIGlmICghaW5pdGlhbCkgdGhyb3cgbmV3IFR5cGVFcnJvcihyZWR1Y2VFcnJvcik7CiAgICByZXR1cm4gbWVtbzsKICB9OwoKICAvLyBSZXR1cm4gdGhlIGZpcnN0IHZhbHVlIHdoaWNoIHBhc3NlcyBhIHRydXRoIHRlc3QuIEFsaWFzZWQgYXMgYGRldGVjdGAuCiAgXy5maW5kID0gXy5kZXRlY3QgPSBmdW5jdGlvbihvYmosIGl0ZXJhdG9yLCBjb250ZXh0KSB7CiAgICB2YXIgcmVzdWx0OwogICAgYW55KG9iaiwgZnVuY3Rpb24odmFsdWUsIGluZGV4LCBsaXN0KSB7CiAgICAgIGlmIChpdGVyYXRvci5jYWxsKGNvbnRleHQsIHZhbHVlLCBpbmRleCwgbGlzdCkpIHsKICAgICAgICByZXN1bHQgPSB2YWx1ZTsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgfSk7CiAgICByZXR1cm4gcmVzdWx0OwogIH07CgogIC8vIFJldHVybiBhbGwgdGhlIGVsZW1lbnRzIHRoYXQgcGFzcyBhIHRydXRoIHRlc3QuCiAgLy8gRGVsZWdhdGVzIHRvICoqRUNNQVNjcmlwdCA1KioncyBuYXRpdmUgYGZpbHRlcmAgaWYgYXZhaWxhYmxlLgogIC8vIEFsaWFzZWQgYXMgYHNlbGVjdGAuCiAgXy5maWx0ZXIgPSBfLnNlbGVjdCA9IGZ1bmN0aW9uKG9iaiwgaXRlcmF0b3IsIGNvbnRleHQpIHsKICAgIHZhciByZXN1bHRzID0gW107CiAgICBpZiAob2JqID09IG51bGwpIHJldHVybiByZXN1bHRzOwogICAgaWYgKG5hdGl2ZUZpbHRlciAmJiBvYmouZmlsdGVyID09PSBuYXRpdmVGaWx0ZXIpIHJldHVybiBvYmouZmlsdGVyKGl0ZXJhdG9yLCBjb250ZXh0KTsKICAgIGVhY2gob2JqLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGxpc3QpIHsKICAgICAgaWYgKGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgdmFsdWUsIGluZGV4LCBsaXN0KSkgcmVzdWx0c1tyZXN1bHRzLmxlbmd0aF0gPSB2YWx1ZTsKICAgIH0pOwogICAgcmV0dXJuIHJlc3VsdHM7CiAgfTsKCiAgLy8gUmV0dXJuIGFsbCB0aGUgZWxlbWVudHMgZm9yIHdoaWNoIGEgdHJ1dGggdGVzdCBmYWlscy4KICBfLnJlamVjdCA9IGZ1bmN0aW9uKG9iaiwgaXRlcmF0b3IsIGNvbnRleHQpIHsKICAgIHJldHVybiBfLmZpbHRlcihvYmosIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgbGlzdCkgewogICAgICByZXR1cm4gIWl0ZXJhdG9yLmNhbGwoY29udGV4dCwgdmFsdWUsIGluZGV4LCBsaXN0KTsKICAgIH0sIGNvbnRleHQpOwogIH07CgogIC8vIERldGVybWluZSB3aGV0aGVyIGFsbCBvZiB0aGUgZWxlbWVudHMgbWF0Y2ggYSB0cnV0aCB0ZXN0LgogIC8vIERlbGVnYXRlcyB0byAqKkVDTUFTY3JpcHQgNSoqJ3MgbmF0aXZlIGBldmVyeWAgaWYgYXZhaWxhYmxlLgogIC8vIEFsaWFzZWQgYXMgYGFsbGAuCiAgXy5ldmVyeSA9IF8uYWxsID0gZnVuY3Rpb24ob2JqLCBpdGVyYXRvciwgY29udGV4dCkgewogICAgaXRlcmF0b3IgfHwgKGl0ZXJhdG9yID0gXy5pZGVudGl0eSk7CiAgICB2YXIgcmVzdWx0ID0gdHJ1ZTsKICAgIGlmIChvYmogPT0gbnVsbCkgcmV0dXJuIHJlc3VsdDsKICAgIGlmIChuYXRpdmVFdmVyeSAmJiBvYmouZXZlcnkgPT09IG5hdGl2ZUV2ZXJ5KSByZXR1cm4gb2JqLmV2ZXJ5KGl0ZXJhdG9yLCBjb250ZXh0KTsKICAgIGVhY2gob2JqLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGxpc3QpIHsKICAgICAgaWYgKCEocmVzdWx0ID0gcmVzdWx0ICYmIGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgdmFsdWUsIGluZGV4LCBsaXN0KSkpIHJldHVybiBicmVha2VyOwogICAgfSk7CiAgICByZXR1cm4gISFyZXN1bHQ7CiAgfTsKCiAgLy8gRGV0ZXJtaW5lIGlmIGF0IGxlYXN0IG9uZSBlbGVtZW50IGluIHRoZSBvYmplY3QgbWF0Y2hlcyBhIHRydXRoIHRlc3QuCiAgLy8gRGVsZWdhdGVzIHRvICoqRUNNQVNjcmlwdCA1KioncyBuYXRpdmUgYHNvbWVgIGlmIGF2YWlsYWJsZS4KICAvLyBBbGlhc2VkIGFzIGBhbnlgLgogIHZhciBhbnkgPSBfLnNvbWUgPSBfLmFueSA9IGZ1bmN0aW9uKG9iaiwgaXRlcmF0b3IsIGNvbnRleHQpIHsKICAgIGl0ZXJhdG9yIHx8IChpdGVyYXRvciA9IF8uaWRlbnRpdHkpOwogICAgdmFyIHJlc3VsdCA9IGZhbHNlOwogICAgaWYgKG9iaiA9PSBudWxsKSByZXR1cm4gcmVzdWx0OwogICAgaWYgKG5hdGl2ZVNvbWUgJiYgb2JqLnNvbWUgPT09IG5hdGl2ZVNvbWUpIHJldHVybiBvYmouc29tZShpdGVyYXRvciwgY29udGV4dCk7CiAgICBlYWNoKG9iaiwgZnVuY3Rpb24odmFsdWUsIGluZGV4LCBsaXN0KSB7CiAgICAgIGlmIChyZXN1bHQgfHwgKHJlc3VsdCA9IGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgdmFsdWUsIGluZGV4LCBsaXN0KSkpIHJldHVybiBicmVha2VyOwogICAgfSk7CiAgICByZXR1cm4gISFyZXN1bHQ7CiAgfTsKCiAgLy8gRGV0ZXJtaW5lIGlmIHRoZSBhcnJheSBvciBvYmplY3QgY29udGFpbnMgYSBnaXZlbiB2YWx1ZSAodXNpbmcgYD09PWApLgogIC8vIEFsaWFzZWQgYXMgYGluY2x1ZGVgLgogIF8uY29udGFpbnMgPSBfLmluY2x1ZGUgPSBmdW5jdGlvbihvYmosIHRhcmdldCkgewogICAgaWYgKG9iaiA9PSBudWxsKSByZXR1cm4gZmFsc2U7CiAgICBpZiAobmF0aXZlSW5kZXhPZiAmJiBvYmouaW5kZXhPZiA9PT0gbmF0aXZlSW5kZXhPZikgcmV0dXJuIG9iai5pbmRleE9mKHRhcmdldCkgIT0gLTE7CiAgICByZXR1cm4gYW55KG9iaiwgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgcmV0dXJuIHZhbHVlID09PSB0YXJnZXQ7CiAgICB9KTsKICB9OwoKICAvLyBJbnZva2UgYSBtZXRob2QgKHdpdGggYXJndW1lbnRzKSBvbiBldmVyeSBpdGVtIGluIGEgY29sbGVjdGlvbi4KICBfLmludm9rZSA9IGZ1bmN0aW9uKG9iaiwgbWV0aG9kKSB7CiAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAyKTsKICAgIHZhciBpc0Z1bmMgPSBfLmlzRnVuY3Rpb24obWV0aG9kKTsKICAgIHJldHVybiBfLm1hcChvYmosIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIHJldHVybiAoaXNGdW5jID8gbWV0aG9kIDogdmFsdWVbbWV0aG9kXSkuYXBwbHkodmFsdWUsIGFyZ3MpOwogICAgfSk7CiAgfTsKCiAgLy8gQ29udmVuaWVuY2UgdmVyc2lvbiBvZiBhIGNvbW1vbiB1c2UgY2FzZSBvZiBgbWFwYDogZmV0Y2hpbmcgYSBwcm9wZXJ0eS4KICBfLnBsdWNrID0gZnVuY3Rpb24ob2JqLCBrZXkpIHsKICAgIHJldHVybiBfLm1hcChvYmosIGZ1bmN0aW9uKHZhbHVlKXsgcmV0dXJuIHZhbHVlW2tleV07IH0pOwogIH07CgogIC8vIENvbnZlbmllbmNlIHZlcnNpb24gb2YgYSBjb21tb24gdXNlIGNhc2Ugb2YgYGZpbHRlcmA6IHNlbGVjdGluZyBvbmx5IG9iamVjdHMKICAvLyBjb250YWluaW5nIHNwZWNpZmljIGBrZXk6dmFsdWVgIHBhaXJzLgogIF8ud2hlcmUgPSBmdW5jdGlvbihvYmosIGF0dHJzLCBmaXJzdCkgewogICAgaWYgKF8uaXNFbXB0eShhdHRycykpIHJldHVybiBmaXJzdCA/IG51bGwgOiBbXTsKICAgIHJldHVybiBfW2ZpcnN0ID8gJ2ZpbmQnIDogJ2ZpbHRlciddKG9iaiwgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgZm9yICh2YXIga2V5IGluIGF0dHJzKSB7CiAgICAgICAgaWYgKGF0dHJzW2tleV0gIT09IHZhbHVlW2tleV0pIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0pOwogIH07CgogIC8vIENvbnZlbmllbmNlIHZlcnNpb24gb2YgYSBjb21tb24gdXNlIGNhc2Ugb2YgYGZpbmRgOiBnZXR0aW5nIHRoZSBmaXJzdCBvYmplY3QKICAvLyBjb250YWluaW5nIHNwZWNpZmljIGBrZXk6dmFsdWVgIHBhaXJzLgogIF8uZmluZFdoZXJlID0gZnVuY3Rpb24ob2JqLCBhdHRycykgewogICAgcmV0dXJuIF8ud2hlcmUob2JqLCBhdHRycywgdHJ1ZSk7CiAgfTsKCiAgLy8gUmV0dXJuIHRoZSBtYXhpbXVtIGVsZW1lbnQgb3IgKGVsZW1lbnQtYmFzZWQgY29tcHV0YXRpb24pLgogIC8vIENhbid0IG9wdGltaXplIGFycmF5cyBvZiBpbnRlZ2VycyBsb25nZXIgdGhhbiA2NSw1MzUgZWxlbWVudHMuCiAgLy8gU2VlOiBodHRwczovL2J1Z3Mud2Via2l0Lm9yZy9zaG93X2J1Zy5jZ2k/aWQ9ODA3OTcKICBfLm1heCA9IGZ1bmN0aW9uKG9iaiwgaXRlcmF0b3IsIGNvbnRleHQpIHsKICAgIGlmICghaXRlcmF0b3IgJiYgXy5pc0FycmF5KG9iaikgJiYgb2JqWzBdID09PSArb2JqWzBdICYmIG9iai5sZW5ndGggPCA2NTUzNSkgewogICAgICByZXR1cm4gTWF0aC5tYXguYXBwbHkoTWF0aCwgb2JqKTsKICAgIH0KICAgIGlmICghaXRlcmF0b3IgJiYgXy5pc0VtcHR5KG9iaikpIHJldHVybiAtSW5maW5pdHk7CiAgICB2YXIgcmVzdWx0ID0ge2NvbXB1dGVkIDogLUluZmluaXR5LCB2YWx1ZTogLUluZmluaXR5fTsKICAgIGVhY2gob2JqLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGxpc3QpIHsKICAgICAgdmFyIGNvbXB1dGVkID0gaXRlcmF0b3IgPyBpdGVyYXRvci5jYWxsKGNvbnRleHQsIHZhbHVlLCBpbmRleCwgbGlzdCkgOiB2YWx1ZTsKICAgICAgY29tcHV0ZWQgPj0gcmVzdWx0LmNvbXB1dGVkICYmIChyZXN1bHQgPSB7dmFsdWUgOiB2YWx1ZSwgY29tcHV0ZWQgOiBjb21wdXRlZH0pOwogICAgfSk7CiAgICByZXR1cm4gcmVzdWx0LnZhbHVlOwogIH07CgogIC8vIFJldHVybiB0aGUgbWluaW11bSBlbGVtZW50IChvciBlbGVtZW50LWJhc2VkIGNvbXB1dGF0aW9uKS4KICBfLm1pbiA9IGZ1bmN0aW9uKG9iaiwgaXRlcmF0b3IsIGNvbnRleHQpIHsKICAgIGlmICghaXRlcmF0b3IgJiYgXy5pc0FycmF5KG9iaikgJiYgb2JqWzBdID09PSArb2JqWzBdICYmIG9iai5sZW5ndGggPCA2NTUzNSkgewogICAgICByZXR1cm4gTWF0aC5taW4uYXBwbHkoTWF0aCwgb2JqKTsKICAgIH0KICAgIGlmICghaXRlcmF0b3IgJiYgXy5pc0VtcHR5KG9iaikpIHJldHVybiBJbmZpbml0eTsKICAgIHZhciByZXN1bHQgPSB7Y29tcHV0ZWQgOiBJbmZpbml0eSwgdmFsdWU6IEluZmluaXR5fTsKICAgIGVhY2gob2JqLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGxpc3QpIHsKICAgICAgdmFyIGNvbXB1dGVkID0gaXRlcmF0b3IgPyBpdGVyYXRvci5jYWxsKGNvbnRleHQsIHZhbHVlLCBpbmRleCwgbGlzdCkgOiB2YWx1ZTsKICAgICAgY29tcHV0ZWQgPCByZXN1bHQuY29tcHV0ZWQgJiYgKHJlc3VsdCA9IHt2YWx1ZSA6IHZhbHVlLCBjb21wdXRlZCA6IGNvbXB1dGVkfSk7CiAgICB9KTsKICAgIHJldHVybiByZXN1bHQudmFsdWU7CiAgfTsKCiAgLy8gU2h1ZmZsZSBhbiBhcnJheS4KICBfLnNodWZmbGUgPSBmdW5jdGlvbihvYmopIHsKICAgIHZhciByYW5kOwogICAgdmFyIGluZGV4ID0gMDsKICAgIHZhciBzaHVmZmxlZCA9IFtdOwogICAgZWFjaChvYmosIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIHJhbmQgPSBfLnJhbmRvbShpbmRleCsrKTsKICAgICAgc2h1ZmZsZWRbaW5kZXggLSAxXSA9IHNodWZmbGVkW3JhbmRdOwogICAgICBzaHVmZmxlZFtyYW5kXSA9IHZhbHVlOwogICAgfSk7CiAgICByZXR1cm4gc2h1ZmZsZWQ7CiAgfTsKCiAgLy8gQW4gaW50ZXJuYWwgZnVuY3Rpb24gdG8gZ2VuZXJhdGUgbG9va3VwIGl0ZXJhdG9ycy4KICB2YXIgbG9va3VwSXRlcmF0b3IgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgcmV0dXJuIF8uaXNGdW5jdGlvbih2YWx1ZSkgPyB2YWx1ZSA6IGZ1bmN0aW9uKG9iail7IHJldHVybiBvYmpbdmFsdWVdOyB9OwogIH07CgogIC8vIFNvcnQgdGhlIG9iamVjdCdzIHZhbHVlcyBieSBhIGNyaXRlcmlvbiBwcm9kdWNlZCBieSBhbiBpdGVyYXRvci4KICBfLnNvcnRCeSA9IGZ1bmN0aW9uKG9iaiwgdmFsdWUsIGNvbnRleHQpIHsKICAgIHZhciBpdGVyYXRvciA9IGxvb2t1cEl0ZXJhdG9yKHZhbHVlKTsKICAgIHJldHVybiBfLnBsdWNrKF8ubWFwKG9iaiwgZnVuY3Rpb24odmFsdWUsIGluZGV4LCBsaXN0KSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgdmFsdWUgOiB2YWx1ZSwKICAgICAgICBpbmRleCA6IGluZGV4LAogICAgICAgIGNyaXRlcmlhIDogaXRlcmF0b3IuY2FsbChjb250ZXh0LCB2YWx1ZSwgaW5kZXgsIGxpc3QpCiAgICAgIH07CiAgICB9KS5zb3J0KGZ1bmN0aW9uKGxlZnQsIHJpZ2h0KSB7CiAgICAgIHZhciBhID0gbGVmdC5jcml0ZXJpYTsKICAgICAgdmFyIGIgPSByaWdodC5jcml0ZXJpYTsKICAgICAgaWYgKGEgIT09IGIpIHsKICAgICAgICBpZiAoYSA+IGIgfHwgYSA9PT0gdm9pZCAwKSByZXR1cm4gMTsKICAgICAgICBpZiAoYSA8IGIgfHwgYiA9PT0gdm9pZCAwKSByZXR1cm4gLTE7CiAgICAgIH0KICAgICAgcmV0dXJuIGxlZnQuaW5kZXggPCByaWdodC5pbmRleCA/IC0xIDogMTsKICAgIH0pLCAndmFsdWUnKTsKICB9OwoKICAvLyBBbiBpbnRlcm5hbCBmdW5jdGlvbiB1c2VkIGZvciBhZ2dyZWdhdGUgImdyb3VwIGJ5IiBvcGVyYXRpb25zLgogIHZhciBncm91cCA9IGZ1bmN0aW9uKG9iaiwgdmFsdWUsIGNvbnRleHQsIGJlaGF2aW9yKSB7CiAgICB2YXIgcmVzdWx0ID0ge307CiAgICB2YXIgaXRlcmF0b3IgPSBsb29rdXBJdGVyYXRvcih2YWx1ZSB8fCBfLmlkZW50aXR5KTsKICAgIGVhY2gob2JqLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgpIHsKICAgICAgdmFyIGtleSA9IGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgdmFsdWUsIGluZGV4LCBvYmopOwogICAgICBiZWhhdmlvcihyZXN1bHQsIGtleSwgdmFsdWUpOwogICAgfSk7CiAgICByZXR1cm4gcmVzdWx0OwogIH07CgogIC8vIEdyb3VwcyB0aGUgb2JqZWN0J3MgdmFsdWVzIGJ5IGEgY3JpdGVyaW9uLiBQYXNzIGVpdGhlciBhIHN0cmluZyBhdHRyaWJ1dGUKICAvLyB0byBncm91cCBieSwgb3IgYSBmdW5jdGlvbiB0aGF0IHJldHVybnMgdGhlIGNyaXRlcmlvbi4KICBfLmdyb3VwQnkgPSBmdW5jdGlvbihvYmosIHZhbHVlLCBjb250ZXh0KSB7CiAgICByZXR1cm4gZ3JvdXAob2JqLCB2YWx1ZSwgY29udGV4dCwgZnVuY3Rpb24ocmVzdWx0LCBrZXksIHZhbHVlKSB7CiAgICAgIChfLmhhcyhyZXN1bHQsIGtleSkgPyByZXN1bHRba2V5XSA6IChyZXN1bHRba2V5XSA9IFtdKSkucHVzaCh2YWx1ZSk7CiAgICB9KTsKICB9OwoKICAvLyBDb3VudHMgaW5zdGFuY2VzIG9mIGFuIG9iamVjdCB0aGF0IGdyb3VwIGJ5IGEgY2VydGFpbiBjcml0ZXJpb24uIFBhc3MKICAvLyBlaXRoZXIgYSBzdHJpbmcgYXR0cmlidXRlIHRvIGNvdW50IGJ5LCBvciBhIGZ1bmN0aW9uIHRoYXQgcmV0dXJucyB0aGUKICAvLyBjcml0ZXJpb24uCiAgXy5jb3VudEJ5ID0gZnVuY3Rpb24ob2JqLCB2YWx1ZSwgY29udGV4dCkgewogICAgcmV0dXJuIGdyb3VwKG9iaiwgdmFsdWUsIGNvbnRleHQsIGZ1bmN0aW9uKHJlc3VsdCwga2V5KSB7CiAgICAgIGlmICghXy5oYXMocmVzdWx0LCBrZXkpKSByZXN1bHRba2V5XSA9IDA7CiAgICAgIHJlc3VsdFtrZXldKys7CiAgICB9KTsKICB9OwoKICAvLyBVc2UgYSBjb21wYXJhdG9yIGZ1bmN0aW9uIHRvIGZpZ3VyZSBvdXQgdGhlIHNtYWxsZXN0IGluZGV4IGF0IHdoaWNoCiAgLy8gYW4gb2JqZWN0IHNob3VsZCBiZSBpbnNlcnRlZCBzbyBhcyB0byBtYWludGFpbiBvcmRlci4gVXNlcyBiaW5hcnkgc2VhcmNoLgogIF8uc29ydGVkSW5kZXggPSBmdW5jdGlvbihhcnJheSwgb2JqLCBpdGVyYXRvciwgY29udGV4dCkgewogICAgaXRlcmF0b3IgPSBpdGVyYXRvciA9PSBudWxsID8gXy5pZGVudGl0eSA6IGxvb2t1cEl0ZXJhdG9yKGl0ZXJhdG9yKTsKICAgIHZhciB2YWx1ZSA9IGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgb2JqKTsKICAgIHZhciBsb3cgPSAwLCBoaWdoID0gYXJyYXkubGVuZ3RoOwogICAgd2hpbGUgKGxvdyA8IGhpZ2gpIHsKICAgICAgdmFyIG1pZCA9IChsb3cgKyBoaWdoKSA+Pj4gMTsKICAgICAgaXRlcmF0b3IuY2FsbChjb250ZXh0LCBhcnJheVttaWRdKSA8IHZhbHVlID8gbG93ID0gbWlkICsgMSA6IGhpZ2ggPSBtaWQ7CiAgICB9CiAgICByZXR1cm4gbG93OwogIH07CgogIC8vIFNhZmVseSBjb252ZXJ0IGFueXRoaW5nIGl0ZXJhYmxlIGludG8gYSByZWFsLCBsaXZlIGFycmF5LgogIF8udG9BcnJheSA9IGZ1bmN0aW9uKG9iaikgewogICAgaWYgKCFvYmopIHJldHVybiBbXTsKICAgIGlmIChfLmlzQXJyYXkob2JqKSkgcmV0dXJuIHNsaWNlLmNhbGwob2JqKTsKICAgIGlmIChvYmoubGVuZ3RoID09PSArb2JqLmxlbmd0aCkgcmV0dXJuIF8ubWFwKG9iaiwgXy5pZGVudGl0eSk7CiAgICByZXR1cm4gXy52YWx1ZXMob2JqKTsKICB9OwoKICAvLyBSZXR1cm4gdGhlIG51bWJlciBvZiBlbGVtZW50cyBpbiBhbiBvYmplY3QuCiAgXy5zaXplID0gZnVuY3Rpb24ob2JqKSB7CiAgICBpZiAob2JqID09IG51bGwpIHJldHVybiAwOwogICAgcmV0dXJuIChvYmoubGVuZ3RoID09PSArb2JqLmxlbmd0aCkgPyBvYmoubGVuZ3RoIDogXy5rZXlzKG9iaikubGVuZ3RoOwogIH07CgogIC8vIEFycmF5IEZ1bmN0aW9ucwogIC8vIC0tLS0tLS0tLS0tLS0tLQoKICAvLyBHZXQgdGhlIGZpcnN0IGVsZW1lbnQgb2YgYW4gYXJyYXkuIFBhc3NpbmcgKipuKiogd2lsbCByZXR1cm4gdGhlIGZpcnN0IE4KICAvLyB2YWx1ZXMgaW4gdGhlIGFycmF5LiBBbGlhc2VkIGFzIGBoZWFkYCBhbmQgYHRha2VgLiBUaGUgKipndWFyZCoqIGNoZWNrCiAgLy8gYWxsb3dzIGl0IHRvIHdvcmsgd2l0aCBgXy5tYXBgLgogIF8uZmlyc3QgPSBfLmhlYWQgPSBfLnRha2UgPSBmdW5jdGlvbihhcnJheSwgbiwgZ3VhcmQpIHsKICAgIGlmIChhcnJheSA9PSBudWxsKSByZXR1cm4gdm9pZCAwOwogICAgcmV0dXJuIChuICE9IG51bGwpICYmICFndWFyZCA/IHNsaWNlLmNhbGwoYXJyYXksIDAsIG4pIDogYXJyYXlbMF07CiAgfTsKCiAgLy8gUmV0dXJucyBldmVyeXRoaW5nIGJ1dCB0aGUgbGFzdCBlbnRyeSBvZiB0aGUgYXJyYXkuIEVzcGVjaWFsbHkgdXNlZnVsIG9uCiAgLy8gdGhlIGFyZ3VtZW50cyBvYmplY3QuIFBhc3NpbmcgKipuKiogd2lsbCByZXR1cm4gYWxsIHRoZSB2YWx1ZXMgaW4KICAvLyB0aGUgYXJyYXksIGV4Y2x1ZGluZyB0aGUgbGFzdCBOLiBUaGUgKipndWFyZCoqIGNoZWNrIGFsbG93cyBpdCB0byB3b3JrIHdpdGgKICAvLyBgXy5tYXBgLgogIF8uaW5pdGlhbCA9IGZ1bmN0aW9uKGFycmF5LCBuLCBndWFyZCkgewogICAgcmV0dXJuIHNsaWNlLmNhbGwoYXJyYXksIDAsIGFycmF5Lmxlbmd0aCAtICgobiA9PSBudWxsKSB8fCBndWFyZCA/IDEgOiBuKSk7CiAgfTsKCiAgLy8gR2V0IHRoZSBsYXN0IGVsZW1lbnQgb2YgYW4gYXJyYXkuIFBhc3NpbmcgKipuKiogd2lsbCByZXR1cm4gdGhlIGxhc3QgTgogIC8vIHZhbHVlcyBpbiB0aGUgYXJyYXkuIFRoZSAqKmd1YXJkKiogY2hlY2sgYWxsb3dzIGl0IHRvIHdvcmsgd2l0aCBgXy5tYXBgLgogIF8ubGFzdCA9IGZ1bmN0aW9uKGFycmF5LCBuLCBndWFyZCkgewogICAgaWYgKGFycmF5ID09IG51bGwpIHJldHVybiB2b2lkIDA7CiAgICBpZiAoKG4gIT0gbnVsbCkgJiYgIWd1YXJkKSB7CiAgICAgIHJldHVybiBzbGljZS5jYWxsKGFycmF5LCBNYXRoLm1heChhcnJheS5sZW5ndGggLSBuLCAwKSk7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gYXJyYXlbYXJyYXkubGVuZ3RoIC0gMV07CiAgICB9CiAgfTsKCiAgLy8gUmV0dXJucyBldmVyeXRoaW5nIGJ1dCB0aGUgZmlyc3QgZW50cnkgb2YgdGhlIGFycmF5LiBBbGlhc2VkIGFzIGB0YWlsYCBhbmQgYGRyb3BgLgogIC8vIEVzcGVjaWFsbHkgdXNlZnVsIG9uIHRoZSBhcmd1bWVudHMgb2JqZWN0LiBQYXNzaW5nIGFuICoqbioqIHdpbGwgcmV0dXJuCiAgLy8gdGhlIHJlc3QgTiB2YWx1ZXMgaW4gdGhlIGFycmF5LiBUaGUgKipndWFyZCoqCiAgLy8gY2hlY2sgYWxsb3dzIGl0IHRvIHdvcmsgd2l0aCBgXy5tYXBgLgogIF8ucmVzdCA9IF8udGFpbCA9IF8uZHJvcCA9IGZ1bmN0aW9uKGFycmF5LCBuLCBndWFyZCkgewogICAgcmV0dXJuIHNsaWNlLmNhbGwoYXJyYXksIChuID09IG51bGwpIHx8IGd1YXJkID8gMSA6IG4pOwogIH07CgogIC8vIFRyaW0gb3V0IGFsbCBmYWxzeSB2YWx1ZXMgZnJvbSBhbiBhcnJheS4KICBfLmNvbXBhY3QgPSBmdW5jdGlvbihhcnJheSkgewogICAgcmV0dXJuIF8uZmlsdGVyKGFycmF5LCBfLmlkZW50aXR5KTsKICB9OwoKICAvLyBJbnRlcm5hbCBpbXBsZW1lbnRhdGlvbiBvZiBhIHJlY3Vyc2l2ZSBgZmxhdHRlbmAgZnVuY3Rpb24uCiAgdmFyIGZsYXR0ZW4gPSBmdW5jdGlvbihpbnB1dCwgc2hhbGxvdywgb3V0cHV0KSB7CiAgICBlYWNoKGlucHV0LCBmdW5jdGlvbih2YWx1ZSkgewogICAgICBpZiAoXy5pc0FycmF5KHZhbHVlKSkgewogICAgICAgIHNoYWxsb3cgPyBwdXNoLmFwcGx5KG91dHB1dCwgdmFsdWUpIDogZmxhdHRlbih2YWx1ZSwgc2hhbGxvdywgb3V0cHV0KTsKICAgICAgfSBlbHNlIHsKICAgICAgICBvdXRwdXQucHVzaCh2YWx1ZSk7CiAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuIG91dHB1dDsKICB9OwoKICAvLyBSZXR1cm4gYSBjb21wbGV0ZWx5IGZsYXR0ZW5lZCB2ZXJzaW9uIG9mIGFuIGFycmF5LgogIF8uZmxhdHRlbiA9IGZ1bmN0aW9uKGFycmF5LCBzaGFsbG93KSB7CiAgICByZXR1cm4gZmxhdHRlbihhcnJheSwgc2hhbGxvdywgW10pOwogIH07CgogIC8vIFJldHVybiBhIHZlcnNpb24gb2YgdGhlIGFycmF5IHRoYXQgZG9lcyBub3QgY29udGFpbiB0aGUgc3BlY2lmaWVkIHZhbHVlKHMpLgogIF8ud2l0aG91dCA9IGZ1bmN0aW9uKGFycmF5KSB7CiAgICByZXR1cm4gXy5kaWZmZXJlbmNlKGFycmF5LCBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSkpOwogIH07CgogIC8vIFByb2R1Y2UgYSBkdXBsaWNhdGUtZnJlZSB2ZXJzaW9uIG9mIHRoZSBhcnJheS4gSWYgdGhlIGFycmF5IGhhcyBhbHJlYWR5CiAgLy8gYmVlbiBzb3J0ZWQsIHlvdSBoYXZlIHRoZSBvcHRpb24gb2YgdXNpbmcgYSBmYXN0ZXIgYWxnb3JpdGhtLgogIC8vIEFsaWFzZWQgYXMgYHVuaXF1ZWAuCiAgXy51bmlxID0gXy51bmlxdWUgPSBmdW5jdGlvbihhcnJheSwgaXNTb3J0ZWQsIGl0ZXJhdG9yLCBjb250ZXh0KSB7CiAgICBpZiAoXy5pc0Z1bmN0aW9uKGlzU29ydGVkKSkgewogICAgICBjb250ZXh0ID0gaXRlcmF0b3I7CiAgICAgIGl0ZXJhdG9yID0gaXNTb3J0ZWQ7CiAgICAgIGlzU29ydGVkID0gZmFsc2U7CiAgICB9CiAgICB2YXIgaW5pdGlhbCA9IGl0ZXJhdG9yID8gXy5tYXAoYXJyYXksIGl0ZXJhdG9yLCBjb250ZXh0KSA6IGFycmF5OwogICAgdmFyIHJlc3VsdHMgPSBbXTsKICAgIHZhciBzZWVuID0gW107CiAgICBlYWNoKGluaXRpYWwsIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCkgewogICAgICBpZiAoaXNTb3J0ZWQgPyAoIWluZGV4IHx8IHNlZW5bc2Vlbi5sZW5ndGggLSAxXSAhPT0gdmFsdWUpIDogIV8uY29udGFpbnMoc2VlbiwgdmFsdWUpKSB7CiAgICAgICAgc2Vlbi5wdXNoKHZhbHVlKTsKICAgICAgICByZXN1bHRzLnB1c2goYXJyYXlbaW5kZXhdKTsKICAgICAgfQogICAgfSk7CiAgICByZXR1cm4gcmVzdWx0czsKICB9OwoKICAvLyBQcm9kdWNlIGFuIGFycmF5IHRoYXQgY29udGFpbnMgdGhlIHVuaW9uOiBlYWNoIGRpc3RpbmN0IGVsZW1lbnQgZnJvbSBhbGwgb2YKICAvLyB0aGUgcGFzc2VkLWluIGFycmF5cy4KICBfLnVuaW9uID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gXy51bmlxKGNvbmNhdC5hcHBseShBcnJheVByb3RvLCBhcmd1bWVudHMpKTsKICB9OwoKICAvLyBQcm9kdWNlIGFuIGFycmF5IHRoYXQgY29udGFpbnMgZXZlcnkgaXRlbSBzaGFyZWQgYmV0d2VlbiBhbGwgdGhlCiAgLy8gcGFzc2VkLWluIGFycmF5cy4KICBfLmludGVyc2VjdGlvbiA9IGZ1bmN0aW9uKGFycmF5KSB7CiAgICB2YXIgcmVzdCA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKICAgIHJldHVybiBfLmZpbHRlcihfLnVuaXEoYXJyYXkpLCBmdW5jdGlvbihpdGVtKSB7CiAgICAgIHJldHVybiBfLmV2ZXJ5KHJlc3QsIGZ1bmN0aW9uKG90aGVyKSB7CiAgICAgICAgcmV0dXJuIF8uaW5kZXhPZihvdGhlciwgaXRlbSkgPj0gMDsKICAgICAgfSk7CiAgICB9KTsKICB9OwoKICAvLyBUYWtlIHRoZSBkaWZmZXJlbmNlIGJldHdlZW4gb25lIGFycmF5IGFuZCBhIG51bWJlciBvZiBvdGhlciBhcnJheXMuCiAgLy8gT25seSB0aGUgZWxlbWVudHMgcHJlc2VudCBpbiBqdXN0IHRoZSBmaXJzdCBhcnJheSB3aWxsIHJlbWFpbi4KICBfLmRpZmZlcmVuY2UgPSBmdW5jdGlvbihhcnJheSkgewogICAgdmFyIHJlc3QgPSBjb25jYXQuYXBwbHkoQXJyYXlQcm90bywgc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpKTsKICAgIHJldHVybiBfLmZpbHRlcihhcnJheSwgZnVuY3Rpb24odmFsdWUpeyByZXR1cm4gIV8uY29udGFpbnMocmVzdCwgdmFsdWUpOyB9KTsKICB9OwoKICAvLyBaaXAgdG9nZXRoZXIgbXVsdGlwbGUgbGlzdHMgaW50byBhIHNpbmdsZSBhcnJheSAtLSBlbGVtZW50cyB0aGF0IHNoYXJlCiAgLy8gYW4gaW5kZXggZ28gdG9nZXRoZXIuCiAgXy56aXAgPSBmdW5jdGlvbigpIHsKICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMpOwogICAgdmFyIGxlbmd0aCA9IF8ubWF4KF8ucGx1Y2soYXJncywgJ2xlbmd0aCcpKTsKICAgIHZhciByZXN1bHRzID0gbmV3IEFycmF5KGxlbmd0aCk7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgIHJlc3VsdHNbaV0gPSBfLnBsdWNrKGFyZ3MsICIiICsgaSk7CiAgICB9CiAgICByZXR1cm4gcmVzdWx0czsKICB9OwoKICAvLyBDb252ZXJ0cyBsaXN0cyBpbnRvIG9iamVjdHMuIFBhc3MgZWl0aGVyIGEgc2luZ2xlIGFycmF5IG9mIGBba2V5LCB2YWx1ZV1gCiAgLy8gcGFpcnMsIG9yIHR3byBwYXJhbGxlbCBhcnJheXMgb2YgdGhlIHNhbWUgbGVuZ3RoIC0tIG9uZSBvZiBrZXlzLCBhbmQgb25lIG9mCiAgLy8gdGhlIGNvcnJlc3BvbmRpbmcgdmFsdWVzLgogIF8ub2JqZWN0ID0gZnVuY3Rpb24obGlzdCwgdmFsdWVzKSB7CiAgICBpZiAobGlzdCA9PSBudWxsKSByZXR1cm4ge307CiAgICB2YXIgcmVzdWx0ID0ge307CiAgICBmb3IgKHZhciBpID0gMCwgbCA9IGxpc3QubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgIGlmICh2YWx1ZXMpIHsKICAgICAgICByZXN1bHRbbGlzdFtpXV0gPSB2YWx1ZXNbaV07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmVzdWx0W2xpc3RbaV1bMF1dID0gbGlzdFtpXVsxXTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9OwoKICAvLyBJZiB0aGUgYnJvd3NlciBkb2Vzbid0IHN1cHBseSB1cyB3aXRoIGluZGV4T2YgKEknbSBsb29raW5nIGF0IHlvdSwgKipNU0lFKiopLAogIC8vIHdlIG5lZWQgdGhpcyBmdW5jdGlvbi4gUmV0dXJuIHRoZSBwb3NpdGlvbiBvZiB0aGUgZmlyc3Qgb2NjdXJyZW5jZSBvZiBhbgogIC8vIGl0ZW0gaW4gYW4gYXJyYXksIG9yIC0xIGlmIHRoZSBpdGVtIGlzIG5vdCBpbmNsdWRlZCBpbiB0aGUgYXJyYXkuCiAgLy8gRGVsZWdhdGVzIHRvICoqRUNNQVNjcmlwdCA1KioncyBuYXRpdmUgYGluZGV4T2ZgIGlmIGF2YWlsYWJsZS4KICAvLyBJZiB0aGUgYXJyYXkgaXMgbGFyZ2UgYW5kIGFscmVhZHkgaW4gc29ydCBvcmRlciwgcGFzcyBgdHJ1ZWAKICAvLyBmb3IgKippc1NvcnRlZCoqIHRvIHVzZSBiaW5hcnkgc2VhcmNoLgogIF8uaW5kZXhPZiA9IGZ1bmN0aW9uKGFycmF5LCBpdGVtLCBpc1NvcnRlZCkgewogICAgaWYgKGFycmF5ID09IG51bGwpIHJldHVybiAtMTsKICAgIHZhciBpID0gMCwgbCA9IGFycmF5Lmxlbmd0aDsKICAgIGlmIChpc1NvcnRlZCkgewogICAgICBpZiAodHlwZW9mIGlzU29ydGVkID09ICdudW1iZXInKSB7CiAgICAgICAgaSA9IChpc1NvcnRlZCA8IDAgPyBNYXRoLm1heCgwLCBsICsgaXNTb3J0ZWQpIDogaXNTb3J0ZWQpOwogICAgICB9IGVsc2UgewogICAgICAgIGkgPSBfLnNvcnRlZEluZGV4KGFycmF5LCBpdGVtKTsKICAgICAgICByZXR1cm4gYXJyYXlbaV0gPT09IGl0ZW0gPyBpIDogLTE7CiAgICAgIH0KICAgIH0KICAgIGlmIChuYXRpdmVJbmRleE9mICYmIGFycmF5LmluZGV4T2YgPT09IG5hdGl2ZUluZGV4T2YpIHJldHVybiBhcnJheS5pbmRleE9mKGl0ZW0sIGlzU29ydGVkKTsKICAgIGZvciAoOyBpIDwgbDsgaSsrKSBpZiAoYXJyYXlbaV0gPT09IGl0ZW0pIHJldHVybiBpOwogICAgcmV0dXJuIC0xOwogIH07CgogIC8vIERlbGVnYXRlcyB0byAqKkVDTUFTY3JpcHQgNSoqJ3MgbmF0aXZlIGBsYXN0SW5kZXhPZmAgaWYgYXZhaWxhYmxlLgogIF8ubGFzdEluZGV4T2YgPSBmdW5jdGlvbihhcnJheSwgaXRlbSwgZnJvbSkgewogICAgaWYgKGFycmF5ID09IG51bGwpIHJldHVybiAtMTsKICAgIHZhciBoYXNJbmRleCA9IGZyb20gIT0gbnVsbDsKICAgIGlmIChuYXRpdmVMYXN0SW5kZXhPZiAmJiBhcnJheS5sYXN0SW5kZXhPZiA9PT0gbmF0aXZlTGFzdEluZGV4T2YpIHsKICAgICAgcmV0dXJuIGhhc0luZGV4ID8gYXJyYXkubGFzdEluZGV4T2YoaXRlbSwgZnJvbSkgOiBhcnJheS5sYXN0SW5kZXhPZihpdGVtKTsKICAgIH0KICAgIHZhciBpID0gKGhhc0luZGV4ID8gZnJvbSA6IGFycmF5Lmxlbmd0aCk7CiAgICB3aGlsZSAoaS0tKSBpZiAoYXJyYXlbaV0gPT09IGl0ZW0pIHJldHVybiBpOwogICAgcmV0dXJuIC0xOwogIH07CgogIC8vIEdlbmVyYXRlIGFuIGludGVnZXIgQXJyYXkgY29udGFpbmluZyBhbiBhcml0aG1ldGljIHByb2dyZXNzaW9uLiBBIHBvcnQgb2YKICAvLyB0aGUgbmF0aXZlIFB5dGhvbiBgcmFuZ2UoKWAgZnVuY3Rpb24uIFNlZQogIC8vIFt0aGUgUHl0aG9uIGRvY3VtZW50YXRpb25dKGh0dHA6Ly9kb2NzLnB5dGhvbi5vcmcvbGlicmFyeS9mdW5jdGlvbnMuaHRtbCNyYW5nZSkuCiAgXy5yYW5nZSA9IGZ1bmN0aW9uKHN0YXJ0LCBzdG9wLCBzdGVwKSB7CiAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA8PSAxKSB7CiAgICAgIHN0b3AgPSBzdGFydCB8fCAwOwogICAgICBzdGFydCA9IDA7CiAgICB9CiAgICBzdGVwID0gYXJndW1lbnRzWzJdIHx8IDE7CgogICAgdmFyIGxlbiA9IE1hdGgubWF4KE1hdGguY2VpbCgoc3RvcCAtIHN0YXJ0KSAvIHN0ZXApLCAwKTsKICAgIHZhciBpZHggPSAwOwogICAgdmFyIHJhbmdlID0gbmV3IEFycmF5KGxlbik7CgogICAgd2hpbGUoaWR4IDwgbGVuKSB7CiAgICAgIHJhbmdlW2lkeCsrXSA9IHN0YXJ0OwogICAgICBzdGFydCArPSBzdGVwOwogICAgfQoKICAgIHJldHVybiByYW5nZTsKICB9OwoKICAvLyBGdW5jdGlvbiAoYWhlbSkgRnVuY3Rpb25zCiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tCgogIC8vIENyZWF0ZSBhIGZ1bmN0aW9uIGJvdW5kIHRvIGEgZ2l2ZW4gb2JqZWN0IChhc3NpZ25pbmcgYHRoaXNgLCBhbmQgYXJndW1lbnRzLAogIC8vIG9wdGlvbmFsbHkpLiBEZWxlZ2F0ZXMgdG8gKipFQ01BU2NyaXB0IDUqKidzIG5hdGl2ZSBgRnVuY3Rpb24uYmluZGAgaWYKICAvLyBhdmFpbGFibGUuCiAgXy5iaW5kID0gZnVuY3Rpb24oZnVuYywgY29udGV4dCkgewogICAgaWYgKGZ1bmMuYmluZCA9PT0gbmF0aXZlQmluZCAmJiBuYXRpdmVCaW5kKSByZXR1cm4gbmF0aXZlQmluZC5hcHBseShmdW5jLCBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSkpOwogICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cywgMik7CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBmdW5jLmFwcGx5KGNvbnRleHQsIGFyZ3MuY29uY2F0KHNsaWNlLmNhbGwoYXJndW1lbnRzKSkpOwogICAgfTsKICB9OwoKICAvLyBQYXJ0aWFsbHkgYXBwbHkgYSBmdW5jdGlvbiBieSBjcmVhdGluZyBhIHZlcnNpb24gdGhhdCBoYXMgaGFkIHNvbWUgb2YgaXRzCiAgLy8gYXJndW1lbnRzIHByZS1maWxsZWQsIHdpdGhvdXQgY2hhbmdpbmcgaXRzIGR5bmFtaWMgYHRoaXNgIGNvbnRleHQuCiAgXy5wYXJ0aWFsID0gZnVuY3Rpb24oZnVuYykgewogICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBmdW5jLmFwcGx5KHRoaXMsIGFyZ3MuY29uY2F0KHNsaWNlLmNhbGwoYXJndW1lbnRzKSkpOwogICAgfTsKICB9OwoKICAvLyBCaW5kIGFsbCBvZiBhbiBvYmplY3QncyBtZXRob2RzIHRvIHRoYXQgb2JqZWN0LiBVc2VmdWwgZm9yIGVuc3VyaW5nIHRoYXQKICAvLyBhbGwgY2FsbGJhY2tzIGRlZmluZWQgb24gYW4gb2JqZWN0IGJlbG9uZyB0byBpdC4KICBfLmJpbmRBbGwgPSBmdW5jdGlvbihvYmopIHsKICAgIHZhciBmdW5jcyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKICAgIGlmIChmdW5jcy5sZW5ndGggPT09IDApIGZ1bmNzID0gXy5mdW5jdGlvbnMob2JqKTsKICAgIGVhY2goZnVuY3MsIGZ1bmN0aW9uKGYpIHsgb2JqW2ZdID0gXy5iaW5kKG9ialtmXSwgb2JqKTsgfSk7CiAgICByZXR1cm4gb2JqOwogIH07CgogIC8vIE1lbW9pemUgYW4gZXhwZW5zaXZlIGZ1bmN0aW9uIGJ5IHN0b3JpbmcgaXRzIHJlc3VsdHMuCiAgXy5tZW1vaXplID0gZnVuY3Rpb24oZnVuYywgaGFzaGVyKSB7CiAgICB2YXIgbWVtbyA9IHt9OwogICAgaGFzaGVyIHx8IChoYXNoZXIgPSBfLmlkZW50aXR5KTsKICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgdmFyIGtleSA9IGhhc2hlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICByZXR1cm4gXy5oYXMobWVtbywga2V5KSA/IG1lbW9ba2V5XSA6IChtZW1vW2tleV0gPSBmdW5jLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykpOwogICAgfTsKICB9OwoKICAvLyBEZWxheXMgYSBmdW5jdGlvbiBmb3IgdGhlIGdpdmVuIG51bWJlciBvZiBtaWxsaXNlY29uZHMsIGFuZCB0aGVuIGNhbGxzCiAgLy8gaXQgd2l0aCB0aGUgYXJndW1lbnRzIHN1cHBsaWVkLgogIF8uZGVsYXkgPSBmdW5jdGlvbihmdW5jLCB3YWl0KSB7CiAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAyKTsKICAgIHJldHVybiBzZXRUaW1lb3V0KGZ1bmN0aW9uKCl7IHJldHVybiBmdW5jLmFwcGx5KG51bGwsIGFyZ3MpOyB9LCB3YWl0KTsKICB9OwoKICAvLyBEZWZlcnMgYSBmdW5jdGlvbiwgc2NoZWR1bGluZyBpdCB0byBydW4gYWZ0ZXIgdGhlIGN1cnJlbnQgY2FsbCBzdGFjayBoYXMKICAvLyBjbGVhcmVkLgogIF8uZGVmZXIgPSBmdW5jdGlvbihmdW5jKSB7CiAgICByZXR1cm4gXy5kZWxheS5hcHBseShfLCBbZnVuYywgMV0uY29uY2F0KHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSkpOwogIH07CgogIC8vIFJldHVybnMgYSBmdW5jdGlvbiwgdGhhdCwgd2hlbiBpbnZva2VkLCB3aWxsIG9ubHkgYmUgdHJpZ2dlcmVkIGF0IG1vc3Qgb25jZQogIC8vIGR1cmluZyBhIGdpdmVuIHdpbmRvdyBvZiB0aW1lLgogIF8udGhyb3R0bGUgPSBmdW5jdGlvbihmdW5jLCB3YWl0KSB7CiAgICB2YXIgY29udGV4dCwgYXJncywgdGltZW91dCwgcmVzdWx0OwogICAgdmFyIHByZXZpb3VzID0gMDsKICAgIHZhciBsYXRlciA9IGZ1bmN0aW9uKCkgewogICAgICBwcmV2aW91cyA9IG5ldyBEYXRlOwogICAgICB0aW1lb3V0ID0gbnVsbDsKICAgICAgcmVzdWx0ID0gZnVuYy5hcHBseShjb250ZXh0LCBhcmdzKTsKICAgIH07CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBub3cgPSBuZXcgRGF0ZTsKICAgICAgdmFyIHJlbWFpbmluZyA9IHdhaXQgLSAobm93IC0gcHJldmlvdXMpOwogICAgICBjb250ZXh0ID0gdGhpczsKICAgICAgYXJncyA9IGFyZ3VtZW50czsKICAgICAgaWYgKHJlbWFpbmluZyA8PSAwKSB7CiAgICAgICAgY2xlYXJUaW1lb3V0KHRpbWVvdXQpOwogICAgICAgIHRpbWVvdXQgPSBudWxsOwogICAgICAgIHByZXZpb3VzID0gbm93OwogICAgICAgIHJlc3VsdCA9IGZ1bmMuYXBwbHkoY29udGV4dCwgYXJncyk7CiAgICAgIH0gZWxzZSBpZiAoIXRpbWVvdXQpIHsKICAgICAgICB0aW1lb3V0ID0gc2V0VGltZW91dChsYXRlciwgcmVtYWluaW5nKTsKICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0OwogICAgfTsKICB9OwoKICAvLyBSZXR1cm5zIGEgZnVuY3Rpb24sIHRoYXQsIGFzIGxvbmcgYXMgaXQgY29udGludWVzIHRvIGJlIGludm9rZWQsIHdpbGwgbm90CiAgLy8gYmUgdHJpZ2dlcmVkLiBUaGUgZnVuY3Rpb24gd2lsbCBiZSBjYWxsZWQgYWZ0ZXIgaXQgc3RvcHMgYmVpbmcgY2FsbGVkIGZvcgogIC8vIE4gbWlsbGlzZWNvbmRzLiBJZiBgaW1tZWRpYXRlYCBpcyBwYXNzZWQsIHRyaWdnZXIgdGhlIGZ1bmN0aW9uIG9uIHRoZQogIC8vIGxlYWRpbmcgZWRnZSwgaW5zdGVhZCBvZiB0aGUgdHJhaWxpbmcuCiAgXy5kZWJvdW5jZSA9IGZ1bmN0aW9uKGZ1bmMsIHdhaXQsIGltbWVkaWF0ZSkgewogICAgdmFyIHRpbWVvdXQsIHJlc3VsdDsKICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgdmFyIGNvbnRleHQgPSB0aGlzLCBhcmdzID0gYXJndW1lbnRzOwogICAgICB2YXIgbGF0ZXIgPSBmdW5jdGlvbigpIHsKICAgICAgICB0aW1lb3V0ID0gbnVsbDsKICAgICAgICBpZiAoIWltbWVkaWF0ZSkgcmVzdWx0ID0gZnVuYy5hcHBseShjb250ZXh0LCBhcmdzKTsKICAgICAgfTsKICAgICAgdmFyIGNhbGxOb3cgPSBpbW1lZGlhdGUgJiYgIXRpbWVvdXQ7CiAgICAgIGNsZWFyVGltZW91dCh0aW1lb3V0KTsKICAgICAgdGltZW91dCA9IHNldFRpbWVvdXQobGF0ZXIsIHdhaXQpOwogICAgICBpZiAoY2FsbE5vdykgcmVzdWx0ID0gZnVuYy5hcHBseShjb250ZXh0LCBhcmdzKTsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH07CiAgfTsKCiAgLy8gUmV0dXJucyBhIGZ1bmN0aW9uIHRoYXQgd2lsbCBiZSBleGVjdXRlZCBhdCBtb3N0IG9uZSB0aW1lLCBubyBtYXR0ZXIgaG93CiAgLy8gb2Z0ZW4geW91IGNhbGwgaXQuIFVzZWZ1bCBmb3IgbGF6eSBpbml0aWFsaXphdGlvbi4KICBfLm9uY2UgPSBmdW5jdGlvbihmdW5jKSB7CiAgICB2YXIgcmFuID0gZmFsc2UsIG1lbW87CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIGlmIChyYW4pIHJldHVybiBtZW1vOwogICAgICByYW4gPSB0cnVlOwogICAgICBtZW1vID0gZnVuYy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICBmdW5jID0gbnVsbDsKICAgICAgcmV0dXJuIG1lbW87CiAgICB9OwogIH07CgogIC8vIFJldHVybnMgdGhlIGZpcnN0IGZ1bmN0aW9uIHBhc3NlZCBhcyBhbiBhcmd1bWVudCB0byB0aGUgc2Vjb25kLAogIC8vIGFsbG93aW5nIHlvdSB0byBhZGp1c3QgYXJndW1lbnRzLCBydW4gY29kZSBiZWZvcmUgYW5kIGFmdGVyLCBhbmQKICAvLyBjb25kaXRpb25hbGx5IGV4ZWN1dGUgdGhlIG9yaWdpbmFsIGZ1bmN0aW9uLgogIF8ud3JhcCA9IGZ1bmN0aW9uKGZ1bmMsIHdyYXBwZXIpIHsKICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgdmFyIGFyZ3MgPSBbZnVuY107CiAgICAgIHB1c2guYXBwbHkoYXJncywgYXJndW1lbnRzKTsKICAgICAgcmV0dXJuIHdyYXBwZXIuYXBwbHkodGhpcywgYXJncyk7CiAgICB9OwogIH07CgogIC8vIFJldHVybnMgYSBmdW5jdGlvbiB0aGF0IGlzIHRoZSBjb21wb3NpdGlvbiBvZiBhIGxpc3Qgb2YgZnVuY3Rpb25zLCBlYWNoCiAgLy8gY29uc3VtaW5nIHRoZSByZXR1cm4gdmFsdWUgb2YgdGhlIGZ1bmN0aW9uIHRoYXQgZm9sbG93cy4KICBfLmNvbXBvc2UgPSBmdW5jdGlvbigpIHsKICAgIHZhciBmdW5jcyA9IGFyZ3VtZW50czsKICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgdmFyIGFyZ3MgPSBhcmd1bWVudHM7CiAgICAgIGZvciAodmFyIGkgPSBmdW5jcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICAgIGFyZ3MgPSBbZnVuY3NbaV0uYXBwbHkodGhpcywgYXJncyldOwogICAgICB9CiAgICAgIHJldHVybiBhcmdzWzBdOwogICAgfTsKICB9OwoKICAvLyBSZXR1cm5zIGEgZnVuY3Rpb24gdGhhdCB3aWxsIG9ubHkgYmUgZXhlY3V0ZWQgYWZ0ZXIgYmVpbmcgY2FsbGVkIE4gdGltZXMuCiAgXy5hZnRlciA9IGZ1bmN0aW9uKHRpbWVzLCBmdW5jKSB7CiAgICBpZiAodGltZXMgPD0gMCkgcmV0dXJuIGZ1bmMoKTsKICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgaWYgKC0tdGltZXMgPCAxKSB7CiAgICAgICAgcmV0dXJuIGZ1bmMuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfQogICAgfTsKICB9OwoKICAvLyBPYmplY3QgRnVuY3Rpb25zCiAgLy8gLS0tLS0tLS0tLS0tLS0tLQoKICAvLyBSZXRyaWV2ZSB0aGUgbmFtZXMgb2YgYW4gb2JqZWN0J3MgcHJvcGVydGllcy4KICAvLyBEZWxlZ2F0ZXMgdG8gKipFQ01BU2NyaXB0IDUqKidzIG5hdGl2ZSBgT2JqZWN0LmtleXNgCiAgXy5rZXlzID0gbmF0aXZlS2V5cyB8fCBmdW5jdGlvbihvYmopIHsKICAgIGlmIChvYmogIT09IE9iamVjdChvYmopKSB0aHJvdyBuZXcgVHlwZUVycm9yKCdJbnZhbGlkIG9iamVjdCcpOwogICAgdmFyIGtleXMgPSBbXTsKICAgIGZvciAodmFyIGtleSBpbiBvYmopIGlmIChfLmhhcyhvYmosIGtleSkpIGtleXNba2V5cy5sZW5ndGhdID0ga2V5OwogICAgcmV0dXJuIGtleXM7CiAgfTsKCiAgLy8gUmV0cmlldmUgdGhlIHZhbHVlcyBvZiBhbiBvYmplY3QncyBwcm9wZXJ0aWVzLgogIF8udmFsdWVzID0gZnVuY3Rpb24ob2JqKSB7CiAgICB2YXIgdmFsdWVzID0gW107CiAgICBmb3IgKHZhciBrZXkgaW4gb2JqKSBpZiAoXy5oYXMob2JqLCBrZXkpKSB2YWx1ZXMucHVzaChvYmpba2V5XSk7CiAgICByZXR1cm4gdmFsdWVzOwogIH07CgogIC8vIENvbnZlcnQgYW4gb2JqZWN0IGludG8gYSBsaXN0IG9mIGBba2V5LCB2YWx1ZV1gIHBhaXJzLgogIF8ucGFpcnMgPSBmdW5jdGlvbihvYmopIHsKICAgIHZhciBwYWlycyA9IFtdOwogICAgZm9yICh2YXIga2V5IGluIG9iaikgaWYgKF8uaGFzKG9iaiwga2V5KSkgcGFpcnMucHVzaChba2V5LCBvYmpba2V5XV0pOwogICAgcmV0dXJuIHBhaXJzOwogIH07CgogIC8vIEludmVydCB0aGUga2V5cyBhbmQgdmFsdWVzIG9mIGFuIG9iamVjdC4gVGhlIHZhbHVlcyBtdXN0IGJlIHNlcmlhbGl6YWJsZS4KICBfLmludmVydCA9IGZ1bmN0aW9uKG9iaikgewogICAgdmFyIHJlc3VsdCA9IHt9OwogICAgZm9yICh2YXIga2V5IGluIG9iaikgaWYgKF8uaGFzKG9iaiwga2V5KSkgcmVzdWx0W29ialtrZXldXSA9IGtleTsKICAgIHJldHVybiByZXN1bHQ7CiAgfTsKCiAgLy8gUmV0dXJuIGEgc29ydGVkIGxpc3Qgb2YgdGhlIGZ1bmN0aW9uIG5hbWVzIGF2YWlsYWJsZSBvbiB0aGUgb2JqZWN0LgogIC8vIEFsaWFzZWQgYXMgYG1ldGhvZHNgCiAgXy5mdW5jdGlvbnMgPSBfLm1ldGhvZHMgPSBmdW5jdGlvbihvYmopIHsKICAgIHZhciBuYW1lcyA9IFtdOwogICAgZm9yICh2YXIga2V5IGluIG9iaikgewogICAgICBpZiAoXy5pc0Z1bmN0aW9uKG9ialtrZXldKSkgbmFtZXMucHVzaChrZXkpOwogICAgfQogICAgcmV0dXJuIG5hbWVzLnNvcnQoKTsKICB9OwoKICAvLyBFeHRlbmQgYSBnaXZlbiBvYmplY3Qgd2l0aCBhbGwgdGhlIHByb3BlcnRpZXMgaW4gcGFzc2VkLWluIG9iamVjdChzKS4KICBfLmV4dGVuZCA9IGZ1bmN0aW9uKG9iaikgewogICAgZWFjaChzbGljZS5jYWxsKGFyZ3VtZW50cywgMSksIGZ1bmN0aW9uKHNvdXJjZSkgewogICAgICBpZiAoc291cmNlKSB7CiAgICAgICAgZm9yICh2YXIgcHJvcCBpbiBzb3VyY2UpIHsKICAgICAgICAgIG9ialtwcm9wXSA9IHNvdXJjZVtwcm9wXTsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuIG9iajsKICB9OwoKICAvLyBSZXR1cm4gYSBjb3B5IG9mIHRoZSBvYmplY3Qgb25seSBjb250YWluaW5nIHRoZSB3aGl0ZWxpc3RlZCBwcm9wZXJ0aWVzLgogIF8ucGljayA9IGZ1bmN0aW9uKG9iaikgewogICAgdmFyIGNvcHkgPSB7fTsKICAgIHZhciBrZXlzID0gY29uY2F0LmFwcGx5KEFycmF5UHJvdG8sIHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSk7CiAgICBlYWNoKGtleXMsIGZ1bmN0aW9uKGtleSkgewogICAgICBpZiAoa2V5IGluIG9iaikgY29weVtrZXldID0gb2JqW2tleV07CiAgICB9KTsKICAgIHJldHVybiBjb3B5OwogIH07CgogICAvLyBSZXR1cm4gYSBjb3B5IG9mIHRoZSBvYmplY3Qgd2l0aG91dCB0aGUgYmxhY2tsaXN0ZWQgcHJvcGVydGllcy4KICBfLm9taXQgPSBmdW5jdGlvbihvYmopIHsKICAgIHZhciBjb3B5ID0ge307CiAgICB2YXIga2V5cyA9IGNvbmNhdC5hcHBseShBcnJheVByb3RvLCBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSkpOwogICAgZm9yICh2YXIga2V5IGluIG9iaikgewogICAgICBpZiAoIV8uY29udGFpbnMoa2V5cywga2V5KSkgY29weVtrZXldID0gb2JqW2tleV07CiAgICB9CiAgICByZXR1cm4gY29weTsKICB9OwoKICAvLyBGaWxsIGluIGEgZ2l2ZW4gb2JqZWN0IHdpdGggZGVmYXVsdCBwcm9wZXJ0aWVzLgogIF8uZGVmYXVsdHMgPSBmdW5jdGlvbihvYmopIHsKICAgIGVhY2goc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpLCBmdW5jdGlvbihzb3VyY2UpIHsKICAgICAgaWYgKHNvdXJjZSkgewogICAgICAgIGZvciAodmFyIHByb3AgaW4gc291cmNlKSB7CiAgICAgICAgICBpZiAob2JqW3Byb3BdID09IG51bGwpIG9ialtwcm9wXSA9IHNvdXJjZVtwcm9wXTsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuIG9iajsKICB9OwoKICAvLyBDcmVhdGUgYSAoc2hhbGxvdy1jbG9uZWQpIGR1cGxpY2F0ZSBvZiBhbiBvYmplY3QuCiAgXy5jbG9uZSA9IGZ1bmN0aW9uKG9iaikgewogICAgaWYgKCFfLmlzT2JqZWN0KG9iaikpIHJldHVybiBvYmo7CiAgICByZXR1cm4gXy5pc0FycmF5KG9iaikgPyBvYmouc2xpY2UoKSA6IF8uZXh0ZW5kKHt9LCBvYmopOwogIH07CgogIC8vIEludm9rZXMgaW50ZXJjZXB0b3Igd2l0aCB0aGUgb2JqLCBhbmQgdGhlbiByZXR1cm5zIG9iai4KICAvLyBUaGUgcHJpbWFyeSBwdXJwb3NlIG9mIHRoaXMgbWV0aG9kIGlzIHRvICJ0YXAgaW50byIgYSBtZXRob2QgY2hhaW4sIGluCiAgLy8gb3JkZXIgdG8gcGVyZm9ybSBvcGVyYXRpb25zIG9uIGludGVybWVkaWF0ZSByZXN1bHRzIHdpdGhpbiB0aGUgY2hhaW4uCiAgXy50YXAgPSBmdW5jdGlvbihvYmosIGludGVyY2VwdG9yKSB7CiAgICBpbnRlcmNlcHRvcihvYmopOwogICAgcmV0dXJuIG9iajsKICB9OwoKICAvLyBJbnRlcm5hbCByZWN1cnNpdmUgY29tcGFyaXNvbiBmdW5jdGlvbiBmb3IgYGlzRXF1YWxgLgogIHZhciBlcSA9IGZ1bmN0aW9uKGEsIGIsIGFTdGFjaywgYlN0YWNrKSB7CiAgICAvLyBJZGVudGljYWwgb2JqZWN0cyBhcmUgZXF1YWwuIGAwID09PSAtMGAsIGJ1dCB0aGV5IGFyZW4ndCBpZGVudGljYWwuCiAgICAvLyBTZWUgdGhlIEhhcm1vbnkgYGVnYWxgIHByb3Bvc2FsOiBodHRwOi8vd2lraS5lY21hc2NyaXB0Lm9yZy9kb2t1LnBocD9pZD1oYXJtb255OmVnYWwuCiAgICBpZiAoYSA9PT0gYikgcmV0dXJuIGEgIT09IDAgfHwgMSAvIGEgPT0gMSAvIGI7CiAgICAvLyBBIHN0cmljdCBjb21wYXJpc29uIGlzIG5lY2Vzc2FyeSBiZWNhdXNlIGBudWxsID09IHVuZGVmaW5lZGAuCiAgICBpZiAoYSA9PSBudWxsIHx8IGIgPT0gbnVsbCkgcmV0dXJuIGEgPT09IGI7CiAgICAvLyBVbndyYXAgYW55IHdyYXBwZWQgb2JqZWN0cy4KICAgIGlmIChhIGluc3RhbmNlb2YgXykgYSA9IGEuX3dyYXBwZWQ7CiAgICBpZiAoYiBpbnN0YW5jZW9mIF8pIGIgPSBiLl93cmFwcGVkOwogICAgLy8gQ29tcGFyZSBgW1tDbGFzc11dYCBuYW1lcy4KICAgIHZhciBjbGFzc05hbWUgPSB0b1N0cmluZy5jYWxsKGEpOwogICAgaWYgKGNsYXNzTmFtZSAhPSB0b1N0cmluZy5jYWxsKGIpKSByZXR1cm4gZmFsc2U7CiAgICBzd2l0Y2ggKGNsYXNzTmFtZSkgewogICAgICAvLyBTdHJpbmdzLCBudW1iZXJzLCBkYXRlcywgYW5kIGJvb2xlYW5zIGFyZSBjb21wYXJlZCBieSB2YWx1ZS4KICAgICAgY2FzZSAnW29iamVjdCBTdHJpbmddJzoKICAgICAgICAvLyBQcmltaXRpdmVzIGFuZCB0aGVpciBjb3JyZXNwb25kaW5nIG9iamVjdCB3cmFwcGVycyBhcmUgZXF1aXZhbGVudDsgdGh1cywgYCI1ImAgaXMKICAgICAgICAvLyBlcXVpdmFsZW50IHRvIGBuZXcgU3RyaW5nKCI1IilgLgogICAgICAgIHJldHVybiBhID09IFN0cmluZyhiKTsKICAgICAgY2FzZSAnW29iamVjdCBOdW1iZXJdJzoKICAgICAgICAvLyBgTmFOYHMgYXJlIGVxdWl2YWxlbnQsIGJ1dCBub24tcmVmbGV4aXZlLiBBbiBgZWdhbGAgY29tcGFyaXNvbiBpcyBwZXJmb3JtZWQgZm9yCiAgICAgICAgLy8gb3RoZXIgbnVtZXJpYyB2YWx1ZXMuCiAgICAgICAgcmV0dXJuIGEgIT0gK2EgPyBiICE9ICtiIDogKGEgPT0gMCA/IDEgLyBhID09IDEgLyBiIDogYSA9PSArYik7CiAgICAgIGNhc2UgJ1tvYmplY3QgRGF0ZV0nOgogICAgICBjYXNlICdbb2JqZWN0IEJvb2xlYW5dJzoKICAgICAgICAvLyBDb2VyY2UgZGF0ZXMgYW5kIGJvb2xlYW5zIHRvIG51bWVyaWMgcHJpbWl0aXZlIHZhbHVlcy4gRGF0ZXMgYXJlIGNvbXBhcmVkIGJ5IHRoZWlyCiAgICAgICAgLy8gbWlsbGlzZWNvbmQgcmVwcmVzZW50YXRpb25zLiBOb3RlIHRoYXQgaW52YWxpZCBkYXRlcyB3aXRoIG1pbGxpc2Vjb25kIHJlcHJlc2VudGF0aW9ucwogICAgICAgIC8vIG9mIGBOYU5gIGFyZSBub3QgZXF1aXZhbGVudC4KICAgICAgICByZXR1cm4gK2EgPT0gK2I7CiAgICAgIC8vIFJlZ0V4cHMgYXJlIGNvbXBhcmVkIGJ5IHRoZWlyIHNvdXJjZSBwYXR0ZXJucyBhbmQgZmxhZ3MuCiAgICAgIGNhc2UgJ1tvYmplY3QgUmVnRXhwXSc6CiAgICAgICAgcmV0dXJuIGEuc291cmNlID09IGIuc291cmNlICYmCiAgICAgICAgICAgICAgIGEuZ2xvYmFsID09IGIuZ2xvYmFsICYmCiAgICAgICAgICAgICAgIGEubXVsdGlsaW5lID09IGIubXVsdGlsaW5lICYmCiAgICAgICAgICAgICAgIGEuaWdub3JlQ2FzZSA9PSBiLmlnbm9yZUNhc2U7CiAgICB9CiAgICBpZiAodHlwZW9mIGEgIT0gJ29iamVjdCcgfHwgdHlwZW9mIGIgIT0gJ29iamVjdCcpIHJldHVybiBmYWxzZTsKICAgIC8vIEFzc3VtZSBlcXVhbGl0eSBmb3IgY3ljbGljIHN0cnVjdHVyZXMuIFRoZSBhbGdvcml0aG0gZm9yIGRldGVjdGluZyBjeWNsaWMKICAgIC8vIHN0cnVjdHVyZXMgaXMgYWRhcHRlZCBmcm9tIEVTIDUuMSBzZWN0aW9uIDE1LjEyLjMsIGFic3RyYWN0IG9wZXJhdGlvbiBgSk9gLgogICAgdmFyIGxlbmd0aCA9IGFTdGFjay5sZW5ndGg7CiAgICB3aGlsZSAobGVuZ3RoLS0pIHsKICAgICAgLy8gTGluZWFyIHNlYXJjaC4gUGVyZm9ybWFuY2UgaXMgaW52ZXJzZWx5IHByb3BvcnRpb25hbCB0byB0aGUgbnVtYmVyIG9mCiAgICAgIC8vIHVuaXF1ZSBuZXN0ZWQgc3RydWN0dXJlcy4KICAgICAgaWYgKGFTdGFja1tsZW5ndGhdID09IGEpIHJldHVybiBiU3RhY2tbbGVuZ3RoXSA9PSBiOwogICAgfQogICAgLy8gQWRkIHRoZSBmaXJzdCBvYmplY3QgdG8gdGhlIHN0YWNrIG9mIHRyYXZlcnNlZCBvYmplY3RzLgogICAgYVN0YWNrLnB1c2goYSk7CiAgICBiU3RhY2sucHVzaChiKTsKICAgIHZhciBzaXplID0gMCwgcmVzdWx0ID0gdHJ1ZTsKICAgIC8vIFJlY3Vyc2l2ZWx5IGNvbXBhcmUgb2JqZWN0cyBhbmQgYXJyYXlzLgogICAgaWYgKGNsYXNzTmFtZSA9PSAnW29iamVjdCBBcnJheV0nKSB7CiAgICAgIC8vIENvbXBhcmUgYXJyYXkgbGVuZ3RocyB0byBkZXRlcm1pbmUgaWYgYSBkZWVwIGNvbXBhcmlzb24gaXMgbmVjZXNzYXJ5LgogICAgICBzaXplID0gYS5sZW5ndGg7CiAgICAgIHJlc3VsdCA9IHNpemUgPT0gYi5sZW5ndGg7CiAgICAgIGlmIChyZXN1bHQpIHsKICAgICAgICAvLyBEZWVwIGNvbXBhcmUgdGhlIGNvbnRlbnRzLCBpZ25vcmluZyBub24tbnVtZXJpYyBwcm9wZXJ0aWVzLgogICAgICAgIHdoaWxlIChzaXplLS0pIHsKICAgICAgICAgIGlmICghKHJlc3VsdCA9IGVxKGFbc2l6ZV0sIGJbc2l6ZV0sIGFTdGFjaywgYlN0YWNrKSkpIGJyZWFrOwogICAgICAgIH0KICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgLy8gT2JqZWN0cyB3aXRoIGRpZmZlcmVudCBjb25zdHJ1Y3RvcnMgYXJlIG5vdCBlcXVpdmFsZW50LCBidXQgYE9iamVjdGBzCiAgICAgIC8vIGZyb20gZGlmZmVyZW50IGZyYW1lcyBhcmUuCiAgICAgIHZhciBhQ3RvciA9IGEuY29uc3RydWN0b3IsIGJDdG9yID0gYi5jb25zdHJ1Y3RvcjsKICAgICAgaWYgKGFDdG9yICE9PSBiQ3RvciAmJiAhKF8uaXNGdW5jdGlvbihhQ3RvcikgJiYgKGFDdG9yIGluc3RhbmNlb2YgYUN0b3IpICYmCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfLmlzRnVuY3Rpb24oYkN0b3IpICYmIChiQ3RvciBpbnN0YW5jZW9mIGJDdG9yKSkpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgICAgLy8gRGVlcCBjb21wYXJlIG9iamVjdHMuCiAgICAgIGZvciAodmFyIGtleSBpbiBhKSB7CiAgICAgICAgaWYgKF8uaGFzKGEsIGtleSkpIHsKICAgICAgICAgIC8vIENvdW50IHRoZSBleHBlY3RlZCBudW1iZXIgb2YgcHJvcGVydGllcy4KICAgICAgICAgIHNpemUrKzsKICAgICAgICAgIC8vIERlZXAgY29tcGFyZSBlYWNoIG1lbWJlci4KICAgICAgICAgIGlmICghKHJlc3VsdCA9IF8uaGFzKGIsIGtleSkgJiYgZXEoYVtrZXldLCBiW2tleV0sIGFTdGFjaywgYlN0YWNrKSkpIGJyZWFrOwogICAgICAgIH0KICAgICAgfQogICAgICAvLyBFbnN1cmUgdGhhdCBib3RoIG9iamVjdHMgY29udGFpbiB0aGUgc2FtZSBudW1iZXIgb2YgcHJvcGVydGllcy4KICAgICAgaWYgKHJlc3VsdCkgewogICAgICAgIGZvciAoa2V5IGluIGIpIHsKICAgICAgICAgIGlmIChfLmhhcyhiLCBrZXkpICYmICEoc2l6ZS0tKSkgYnJlYWs7CiAgICAgICAgfQogICAgICAgIHJlc3VsdCA9ICFzaXplOwogICAgICB9CiAgICB9CiAgICAvLyBSZW1vdmUgdGhlIGZpcnN0IG9iamVjdCBmcm9tIHRoZSBzdGFjayBvZiB0cmF2ZXJzZWQgb2JqZWN0cy4KICAgIGFTdGFjay5wb3AoKTsKICAgIGJTdGFjay5wb3AoKTsKICAgIHJldHVybiByZXN1bHQ7CiAgfTsKCiAgLy8gUGVyZm9ybSBhIGRlZXAgY29tcGFyaXNvbiB0byBjaGVjayBpZiB0d28gb2JqZWN0cyBhcmUgZXF1YWwuCiAgXy5pc0VxdWFsID0gZnVuY3Rpb24oYSwgYikgewogICAgcmV0dXJuIGVxKGEsIGIsIFtdLCBbXSk7CiAgfTsKCiAgLy8gSXMgYSBnaXZlbiBhcnJheSwgc3RyaW5nLCBvciBvYmplY3QgZW1wdHk/CiAgLy8gQW4gImVtcHR5IiBvYmplY3QgaGFzIG5vIGVudW1lcmFibGUgb3duLXByb3BlcnRpZXMuCiAgXy5pc0VtcHR5ID0gZnVuY3Rpb24ob2JqKSB7CiAgICBpZiAob2JqID09IG51bGwpIHJldHVybiB0cnVlOwogICAgaWYgKF8uaXNBcnJheShvYmopIHx8IF8uaXNTdHJpbmcob2JqKSkgcmV0dXJuIG9iai5sZW5ndGggPT09IDA7CiAgICBmb3IgKHZhciBrZXkgaW4gb2JqKSBpZiAoXy5oYXMob2JqLCBrZXkpKSByZXR1cm4gZmFsc2U7CiAgICByZXR1cm4gdHJ1ZTsKICB9OwoKICAvLyBJcyBhIGdpdmVuIHZhbHVlIGEgRE9NIGVsZW1lbnQ/CiAgXy5pc0VsZW1lbnQgPSBmdW5jdGlvbihvYmopIHsKICAgIHJldHVybiAhIShvYmogJiYgb2JqLm5vZGVUeXBlID09PSAxKTsKICB9OwoKICAvLyBJcyBhIGdpdmVuIHZhbHVlIGFuIGFycmF5PwogIC8vIERlbGVnYXRlcyB0byBFQ01BNSdzIG5hdGl2ZSBBcnJheS5pc0FycmF5CiAgXy5pc0FycmF5ID0gbmF0aXZlSXNBcnJheSB8fCBmdW5jdGlvbihvYmopIHsKICAgIHJldHVybiB0b1N0cmluZy5jYWxsKG9iaikgPT0gJ1tvYmplY3QgQXJyYXldJzsKICB9OwoKICAvLyBJcyBhIGdpdmVuIHZhcmlhYmxlIGFuIG9iamVjdD8KICBfLmlzT2JqZWN0ID0gZnVuY3Rpb24ob2JqKSB7CiAgICByZXR1cm4gb2JqID09PSBPYmplY3Qob2JqKTsKICB9OwoKICAvLyBBZGQgc29tZSBpc1R5cGUgbWV0aG9kczogaXNBcmd1bWVudHMsIGlzRnVuY3Rpb24sIGlzU3RyaW5nLCBpc051bWJlciwgaXNEYXRlLCBpc1JlZ0V4cC4KICBlYWNoKFsnQXJndW1lbnRzJywgJ0Z1bmN0aW9uJywgJ1N0cmluZycsICdOdW1iZXInLCAnRGF0ZScsICdSZWdFeHAnXSwgZnVuY3Rpb24obmFtZSkgewogICAgX1snaXMnICsgbmFtZV0gPSBmdW5jdGlvbihvYmopIHsKICAgICAgcmV0dXJuIHRvU3RyaW5nLmNhbGwob2JqKSA9PSAnW29iamVjdCAnICsgbmFtZSArICddJzsKICAgIH07CiAgfSk7CgogIC8vIERlZmluZSBhIGZhbGxiYWNrIHZlcnNpb24gb2YgdGhlIG1ldGhvZCBpbiBicm93c2VycyAoYWhlbSwgSUUpLCB3aGVyZQogIC8vIHRoZXJlIGlzbid0IGFueSBpbnNwZWN0YWJsZSAiQXJndW1lbnRzIiB0eXBlLgogIGlmICghXy5pc0FyZ3VtZW50cyhhcmd1bWVudHMpKSB7CiAgICBfLmlzQXJndW1lbnRzID0gZnVuY3Rpb24ob2JqKSB7CiAgICAgIHJldHVybiAhIShvYmogJiYgXy5oYXMob2JqLCAnY2FsbGVlJykpOwogICAgfTsKICB9CgogIC8vIE9wdGltaXplIGBpc0Z1bmN0aW9uYCBpZiBhcHByb3ByaWF0ZS4KICBpZiAodHlwZW9mICgvLi8pICE9PSAnZnVuY3Rpb24nKSB7CiAgICBfLmlzRnVuY3Rpb24gPSBmdW5jdGlvbihvYmopIHsKICAgICAgcmV0dXJuIHR5cGVvZiBvYmogPT09ICdmdW5jdGlvbic7CiAgICB9OwogIH0KCiAgLy8gSXMgYSBnaXZlbiBvYmplY3QgYSBmaW5pdGUgbnVtYmVyPwogIF8uaXNGaW5pdGUgPSBmdW5jdGlvbihvYmopIHsKICAgIHJldHVybiBpc0Zpbml0ZShvYmopICYmICFpc05hTihwYXJzZUZsb2F0KG9iaikpOwogIH07CgogIC8vIElzIHRoZSBnaXZlbiB2YWx1ZSBgTmFOYD8gKE5hTiBpcyB0aGUgb25seSBudW1iZXIgd2hpY2ggZG9lcyBub3QgZXF1YWwgaXRzZWxmKS4KICBfLmlzTmFOID0gZnVuY3Rpb24ob2JqKSB7CiAgICByZXR1cm4gXy5pc051bWJlcihvYmopICYmIG9iaiAhPSArb2JqOwogIH07CgogIC8vIElzIGEgZ2l2ZW4gdmFsdWUgYSBib29sZWFuPwogIF8uaXNCb29sZWFuID0gZnVuY3Rpb24ob2JqKSB7CiAgICByZXR1cm4gb2JqID09PSB0cnVlIHx8IG9iaiA9PT0gZmFsc2UgfHwgdG9TdHJpbmcuY2FsbChvYmopID09ICdbb2JqZWN0IEJvb2xlYW5dJzsKICB9OwoKICAvLyBJcyBhIGdpdmVuIHZhbHVlIGVxdWFsIHRvIG51bGw/CiAgXy5pc051bGwgPSBmdW5jdGlvbihvYmopIHsKICAgIHJldHVybiBvYmogPT09IG51bGw7CiAgfTsKCiAgLy8gSXMgYSBnaXZlbiB2YXJpYWJsZSB1bmRlZmluZWQ/CiAgXy5pc1VuZGVmaW5lZCA9IGZ1bmN0aW9uKG9iaikgewogICAgcmV0dXJuIG9iaiA9PT0gdm9pZCAwOwogIH07CgogIC8vIFNob3J0Y3V0IGZ1bmN0aW9uIGZvciBjaGVja2luZyBpZiBhbiBvYmplY3QgaGFzIGEgZ2l2ZW4gcHJvcGVydHkgZGlyZWN0bHkKICAvLyBvbiBpdHNlbGYgKGluIG90aGVyIHdvcmRzLCBub3Qgb24gYSBwcm90b3R5cGUpLgogIF8uaGFzID0gZnVuY3Rpb24ob2JqLCBrZXkpIHsKICAgIHJldHVybiBoYXNPd25Qcm9wZXJ0eS5jYWxsKG9iaiwga2V5KTsKICB9OwoKICAvLyBVdGlsaXR5IEZ1bmN0aW9ucwogIC8vIC0tLS0tLS0tLS0tLS0tLS0tCgogIC8vIFJ1biBVbmRlcnNjb3JlLmpzIGluICpub0NvbmZsaWN0KiBtb2RlLCByZXR1cm5pbmcgdGhlIGBfYCB2YXJpYWJsZSB0byBpdHMKICAvLyBwcmV2aW91cyBvd25lci4gUmV0dXJucyBhIHJlZmVyZW5jZSB0byB0aGUgVW5kZXJzY29yZSBvYmplY3QuCiAgXy5ub0NvbmZsaWN0ID0gZnVuY3Rpb24oKSB7CiAgICByb290Ll8gPSBwcmV2aW91c1VuZGVyc2NvcmU7CiAgICByZXR1cm4gdGhpczsKICB9OwoKICAvLyBLZWVwIHRoZSBpZGVudGl0eSBmdW5jdGlvbiBhcm91bmQgZm9yIGRlZmF1bHQgaXRlcmF0b3JzLgogIF8uaWRlbnRpdHkgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgcmV0dXJuIHZhbHVlOwogIH07CgogIC8vIFJ1biBhIGZ1bmN0aW9uICoqbioqIHRpbWVzLgogIF8udGltZXMgPSBmdW5jdGlvbihuLCBpdGVyYXRvciwgY29udGV4dCkgewogICAgdmFyIGFjY3VtID0gQXJyYXkobik7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IG47IGkrKykgYWNjdW1baV0gPSBpdGVyYXRvci5jYWxsKGNvbnRleHQsIGkpOwogICAgcmV0dXJuIGFjY3VtOwogIH07CgogIC8vIFJldHVybiBhIHJhbmRvbSBpbnRlZ2VyIGJldHdlZW4gbWluIGFuZCBtYXggKGluY2x1c2l2ZSkuCiAgXy5yYW5kb20gPSBmdW5jdGlvbihtaW4sIG1heCkgewogICAgaWYgKG1heCA9PSBudWxsKSB7CiAgICAgIG1heCA9IG1pbjsKICAgICAgbWluID0gMDsKICAgIH0KICAgIHJldHVybiBtaW4gKyBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiAobWF4IC0gbWluICsgMSkpOwogIH07CgogIC8vIExpc3Qgb2YgSFRNTCBlbnRpdGllcyBmb3IgZXNjYXBpbmcuCiAgdmFyIGVudGl0eU1hcCA9IHsKICAgIGVzY2FwZTogewogICAgICAnJic6ICcmYW1wOycsCiAgICAgICc8JzogJyZsdDsnLAogICAgICAnPic6ICcmZ3Q7JywKICAgICAgJyInOiAnJnF1b3Q7JywKICAgICAgIiciOiAnJiN4Mjc7JywKICAgICAgJy8nOiAnJiN4MkY7JwogICAgfQogIH07CiAgZW50aXR5TWFwLnVuZXNjYXBlID0gXy5pbnZlcnQoZW50aXR5TWFwLmVzY2FwZSk7CgogIC8vIFJlZ2V4ZXMgY29udGFpbmluZyB0aGUga2V5cyBhbmQgdmFsdWVzIGxpc3RlZCBpbW1lZGlhdGVseSBhYm92ZS4KICB2YXIgZW50aXR5UmVnZXhlcyA9IHsKICAgIGVzY2FwZTogICBuZXcgUmVnRXhwKCdbJyArIF8ua2V5cyhlbnRpdHlNYXAuZXNjYXBlKS5qb2luKCcnKSArICddJywgJ2cnKSwKICAgIHVuZXNjYXBlOiBuZXcgUmVnRXhwKCcoJyArIF8ua2V5cyhlbnRpdHlNYXAudW5lc2NhcGUpLmpvaW4oJ3wnKSArICcpJywgJ2cnKQogIH07CgogIC8vIEZ1bmN0aW9ucyBmb3IgZXNjYXBpbmcgYW5kIHVuZXNjYXBpbmcgc3RyaW5ncyB0by9mcm9tIEhUTUwgaW50ZXJwb2xhdGlvbi4KICBfLmVhY2goWydlc2NhcGUnLCAndW5lc2NhcGUnXSwgZnVuY3Rpb24obWV0aG9kKSB7CiAgICBfW21ldGhvZF0gPSBmdW5jdGlvbihzdHJpbmcpIHsKICAgICAgaWYgKHN0cmluZyA9PSBudWxsKSByZXR1cm4gJyc7CiAgICAgIHJldHVybiAoJycgKyBzdHJpbmcpLnJlcGxhY2UoZW50aXR5UmVnZXhlc1ttZXRob2RdLCBmdW5jdGlvbihtYXRjaCkgewogICAgICAgIHJldHVybiBlbnRpdHlNYXBbbWV0aG9kXVttYXRjaF07CiAgICAgIH0pOwogICAgfTsKICB9KTsKCiAgLy8gSWYgdGhlIHZhbHVlIG9mIHRoZSBuYW1lZCBwcm9wZXJ0eSBpcyBhIGZ1bmN0aW9uIHRoZW4gaW52b2tlIGl0OwogIC8vIG90aGVyd2lzZSwgcmV0dXJuIGl0LgogIF8ucmVzdWx0ID0gZnVuY3Rpb24ob2JqZWN0LCBwcm9wZXJ0eSkgewogICAgaWYgKG9iamVjdCA9PSBudWxsKSByZXR1cm4gbnVsbDsKICAgIHZhciB2YWx1ZSA9IG9iamVjdFtwcm9wZXJ0eV07CiAgICByZXR1cm4gXy5pc0Z1bmN0aW9uKHZhbHVlKSA/IHZhbHVlLmNhbGwob2JqZWN0KSA6IHZhbHVlOwogIH07CgogIC8vIEFkZCB5b3VyIG93biBjdXN0b20gZnVuY3Rpb25zIHRvIHRoZSBVbmRlcnNjb3JlIG9iamVjdC4KICBfLm1peGluID0gZnVuY3Rpb24ob2JqKSB7CiAgICBlYWNoKF8uZnVuY3Rpb25zKG9iaiksIGZ1bmN0aW9uKG5hbWUpewogICAgICB2YXIgZnVuYyA9IF9bbmFtZV0gPSBvYmpbbmFtZV07CiAgICAgIF8ucHJvdG90eXBlW25hbWVdID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIGFyZ3MgPSBbdGhpcy5fd3JhcHBlZF07CiAgICAgICAgcHVzaC5hcHBseShhcmdzLCBhcmd1bWVudHMpOwogICAgICAgIHJldHVybiByZXN1bHQuY2FsbCh0aGlzLCBmdW5jLmFwcGx5KF8sIGFyZ3MpKTsKICAgICAgfTsKICAgIH0pOwogIH07CgogIC8vIEdlbmVyYXRlIGEgdW5pcXVlIGludGVnZXIgaWQgKHVuaXF1ZSB3aXRoaW4gdGhlIGVudGlyZSBjbGllbnQgc2Vzc2lvbikuCiAgLy8gVXNlZnVsIGZvciB0ZW1wb3JhcnkgRE9NIGlkcy4KICB2YXIgaWRDb3VudGVyID0gMDsKICBfLnVuaXF1ZUlkID0gZnVuY3Rpb24ocHJlZml4KSB7CiAgICB2YXIgaWQgPSArK2lkQ291bnRlciArICcnOwogICAgcmV0dXJuIHByZWZpeCA/IHByZWZpeCArIGlkIDogaWQ7CiAgfTsKCiAgLy8gQnkgZGVmYXVsdCwgVW5kZXJzY29yZSB1c2VzIEVSQi1zdHlsZSB0ZW1wbGF0ZSBkZWxpbWl0ZXJzLCBjaGFuZ2UgdGhlCiAgLy8gZm9sbG93aW5nIHRlbXBsYXRlIHNldHRpbmdzIHRvIHVzZSBhbHRlcm5hdGl2ZSBkZWxpbWl0ZXJzLgogIF8udGVtcGxhdGVTZXR0aW5ncyA9IHsKICAgIGV2YWx1YXRlICAgIDogLzwlKFtcc1xTXSs/KSU+L2csCiAgICBpbnRlcnBvbGF0ZSA6IC88JT0oW1xzXFNdKz8pJT4vZywKICAgIGVzY2FwZSAgICAgIDogLzwlLShbXHNcU10rPyklPi9nCiAgfTsKCiAgLy8gV2hlbiBjdXN0b21pemluZyBgdGVtcGxhdGVTZXR0aW5nc2AsIGlmIHlvdSBkb24ndCB3YW50IHRvIGRlZmluZSBhbgogIC8vIGludGVycG9sYXRpb24sIGV2YWx1YXRpb24gb3IgZXNjYXBpbmcgcmVnZXgsIHdlIG5lZWQgb25lIHRoYXQgaXMKICAvLyBndWFyYW50ZWVkIG5vdCB0byBtYXRjaC4KICB2YXIgbm9NYXRjaCA9IC8oLileLzsKCiAgLy8gQ2VydGFpbiBjaGFyYWN0ZXJzIG5lZWQgdG8gYmUgZXNjYXBlZCBzbyB0aGF0IHRoZXkgY2FuIGJlIHB1dCBpbnRvIGEKICAvLyBzdHJpbmcgbGl0ZXJhbC4KICB2YXIgZXNjYXBlcyA9IHsKICAgICInIjogICAgICAiJyIsCiAgICAnXFwnOiAgICAgJ1xcJywKICAgICdccic6ICAgICAncicsCiAgICAnXG4nOiAgICAgJ24nLAogICAgJ1x0JzogICAgICd0JywKICAgICdcdTIwMjgnOiAndTIwMjgnLAogICAgJ1x1MjAyOSc6ICd1MjAyOScKICB9OwoKICB2YXIgZXNjYXBlciA9IC9cXHwnfFxyfFxufFx0fFx1MjAyOHxcdTIwMjkvZzsKCiAgLy8gSmF2YVNjcmlwdCBtaWNyby10ZW1wbGF0aW5nLCBzaW1pbGFyIHRvIEpvaG4gUmVzaWcncyBpbXBsZW1lbnRhdGlvbi4KICAvLyBVbmRlcnNjb3JlIHRlbXBsYXRpbmcgaGFuZGxlcyBhcmJpdHJhcnkgZGVsaW1pdGVycywgcHJlc2VydmVzIHdoaXRlc3BhY2UsCiAgLy8gYW5kIGNvcnJlY3RseSBlc2NhcGVzIHF1b3RlcyB3aXRoaW4gaW50ZXJwb2xhdGVkIGNvZGUuCiAgXy50ZW1wbGF0ZSA9IGZ1bmN0aW9uKHRleHQsIGRhdGEsIHNldHRpbmdzKSB7CiAgICB2YXIgcmVuZGVyOwogICAgc2V0dGluZ3MgPSBfLmRlZmF1bHRzKHt9LCBzZXR0aW5ncywgXy50ZW1wbGF0ZVNldHRpbmdzKTsKCiAgICAvLyBDb21iaW5lIGRlbGltaXRlcnMgaW50byBvbmUgcmVndWxhciBleHByZXNzaW9uIHZpYSBhbHRlcm5hdGlvbi4KICAgIHZhciBtYXRjaGVyID0gbmV3IFJlZ0V4cChbCiAgICAgIChzZXR0aW5ncy5lc2NhcGUgfHwgbm9NYXRjaCkuc291cmNlLAogICAgICAoc2V0dGluZ3MuaW50ZXJwb2xhdGUgfHwgbm9NYXRjaCkuc291cmNlLAogICAgICAoc2V0dGluZ3MuZXZhbHVhdGUgfHwgbm9NYXRjaCkuc291cmNlCiAgICBdLmpvaW4oJ3wnKSArICd8JCcsICdnJyk7CgogICAgLy8gQ29tcGlsZSB0aGUgdGVtcGxhdGUgc291cmNlLCBlc2NhcGluZyBzdHJpbmcgbGl0ZXJhbHMgYXBwcm9wcmlhdGVseS4KICAgIHZhciBpbmRleCA9IDA7CiAgICB2YXIgc291cmNlID0gIl9fcCs9JyI7CiAgICB0ZXh0LnJlcGxhY2UobWF0Y2hlciwgZnVuY3Rpb24obWF0Y2gsIGVzY2FwZSwgaW50ZXJwb2xhdGUsIGV2YWx1YXRlLCBvZmZzZXQpIHsKICAgICAgc291cmNlICs9IHRleHQuc2xpY2UoaW5kZXgsIG9mZnNldCkKICAgICAgICAucmVwbGFjZShlc2NhcGVyLCBmdW5jdGlvbihtYXRjaCkgeyByZXR1cm4gJ1xcJyArIGVzY2FwZXNbbWF0Y2hdOyB9KTsKCiAgICAgIGlmIChlc2NhcGUpIHsKICAgICAgICBzb3VyY2UgKz0gIicrXG4oKF9fdD0oIiArIGVzY2FwZSArICIpKT09bnVsbD8nJzpfLmVzY2FwZShfX3QpKStcbiciOwogICAgICB9CiAgICAgIGlmIChpbnRlcnBvbGF0ZSkgewogICAgICAgIHNvdXJjZSArPSAiJytcbigoX190PSgiICsgaW50ZXJwb2xhdGUgKyAiKSk9PW51bGw/Jyc6X190KStcbiciOwogICAgICB9CiAgICAgIGlmIChldmFsdWF0ZSkgewogICAgICAgIHNvdXJjZSArPSAiJztcbiIgKyBldmFsdWF0ZSArICJcbl9fcCs9JyI7CiAgICAgIH0KICAgICAgaW5kZXggPSBvZmZzZXQgKyBtYXRjaC5sZW5ndGg7CiAgICAgIHJldHVybiBtYXRjaDsKICAgIH0pOwogICAgc291cmNlICs9ICInO1xuIjsKCiAgICAvLyBJZiBhIHZhcmlhYmxlIGlzIG5vdCBzcGVjaWZpZWQsIHBsYWNlIGRhdGEgdmFsdWVzIGluIGxvY2FsIHNjb3BlLgogICAgaWYgKCFzZXR0aW5ncy52YXJpYWJsZSkgc291cmNlID0gJ3dpdGgob2JqfHx7fSl7XG4nICsgc291cmNlICsgJ31cbic7CgogICAgc291cmNlID0gInZhciBfX3QsX19wPScnLF9faj1BcnJheS5wcm90b3R5cGUuam9pbiwiICsKICAgICAgInByaW50PWZ1bmN0aW9uKCl7X19wKz1fX2ouY2FsbChhcmd1bWVudHMsJycpO307XG4iICsKICAgICAgc291cmNlICsgInJldHVybiBfX3A7XG4iOwoKICAgIHRyeSB7CiAgICAgIHJlbmRlciA9IG5ldyBGdW5jdGlvbihzZXR0aW5ncy52YXJpYWJsZSB8fCAnb2JqJywgJ18nLCBzb3VyY2UpOwogICAgfSBjYXRjaCAoZSkgewogICAgICBlLnNvdXJjZSA9IHNvdXJjZTsKICAgICAgdGhyb3cgZTsKICAgIH0KCiAgICBpZiAoZGF0YSkgcmV0dXJuIHJlbmRlcihkYXRhLCBfKTsKICAgIHZhciB0ZW1wbGF0ZSA9IGZ1bmN0aW9uKGRhdGEpIHsKICAgICAgcmV0dXJuIHJlbmRlci5jYWxsKHRoaXMsIGRhdGEsIF8pOwogICAgfTsKCiAgICAvLyBQcm92aWRlIHRoZSBjb21waWxlZCBmdW5jdGlvbiBzb3VyY2UgYXMgYSBjb252ZW5pZW5jZSBmb3IgcHJlY29tcGlsYXRpb24uCiAgICB0ZW1wbGF0ZS5zb3VyY2UgPSAnZnVuY3Rpb24oJyArIChzZXR0aW5ncy52YXJpYWJsZSB8fCAnb2JqJykgKyAnKXtcbicgKyBzb3VyY2UgKyAnfSc7CgogICAgcmV0dXJuIHRlbXBsYXRlOwogIH07CgogIC8vIEFkZCBhICJjaGFpbiIgZnVuY3Rpb24sIHdoaWNoIHdpbGwgZGVsZWdhdGUgdG8gdGhlIHdyYXBwZXIuCiAgXy5jaGFpbiA9IGZ1bmN0aW9uKG9iaikgewogICAgcmV0dXJuIF8ob2JqKS5jaGFpbigpOwogIH07CgogIC8vIE9PUAogIC8vIC0tLS0tLS0tLS0tLS0tLQogIC8vIElmIFVuZGVyc2NvcmUgaXMgY2FsbGVkIGFzIGEgZnVuY3Rpb24sIGl0IHJldHVybnMgYSB3cmFwcGVkIG9iamVjdCB0aGF0CiAgLy8gY2FuIGJlIHVzZWQgT08tc3R5bGUuIFRoaXMgd3JhcHBlciBob2xkcyBhbHRlcmVkIHZlcnNpb25zIG9mIGFsbCB0aGUKICAvLyB1bmRlcnNjb3JlIGZ1bmN0aW9ucy4gV3JhcHBlZCBvYmplY3RzIG1heSBiZSBjaGFpbmVkLgoKICAvLyBIZWxwZXIgZnVuY3Rpb24gdG8gY29udGludWUgY2hhaW5pbmcgaW50ZXJtZWRpYXRlIHJlc3VsdHMuCiAgdmFyIHJlc3VsdCA9IGZ1bmN0aW9uKG9iaikgewogICAgcmV0dXJuIHRoaXMuX2NoYWluID8gXyhvYmopLmNoYWluKCkgOiBvYmo7CiAgfTsKCiAgLy8gQWRkIGFsbCBvZiB0aGUgVW5kZXJzY29yZSBmdW5jdGlvbnMgdG8gdGhlIHdyYXBwZXIgb2JqZWN0LgogIF8ubWl4aW4oXyk7CgogIC8vIEFkZCBhbGwgbXV0YXRvciBBcnJheSBmdW5jdGlvbnMgdG8gdGhlIHdyYXBwZXIuCiAgZWFjaChbJ3BvcCcsICdwdXNoJywgJ3JldmVyc2UnLCAnc2hpZnQnLCAnc29ydCcsICdzcGxpY2UnLCAndW5zaGlmdCddLCBmdW5jdGlvbihuYW1lKSB7CiAgICB2YXIgbWV0aG9kID0gQXJyYXlQcm90b1tuYW1lXTsKICAgIF8ucHJvdG90eXBlW25hbWVdID0gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBvYmogPSB0aGlzLl93cmFwcGVkOwogICAgICBtZXRob2QuYXBwbHkob2JqLCBhcmd1bWVudHMpOwogICAgICBpZiAoKG5hbWUgPT0gJ3NoaWZ0JyB8fCBuYW1lID09ICdzcGxpY2UnKSAmJiBvYmoubGVuZ3RoID09PSAwKSBkZWxldGUgb2JqWzBdOwogICAgICByZXR1cm4gcmVzdWx0LmNhbGwodGhpcywgb2JqKTsKICAgIH07CiAgfSk7CgogIC8vIEFkZCBhbGwgYWNjZXNzb3IgQXJyYXkgZnVuY3Rpb25zIHRvIHRoZSB3cmFwcGVyLgogIGVhY2goWydjb25jYXQnLCAnam9pbicsICdzbGljZSddLCBmdW5jdGlvbihuYW1lKSB7CiAgICB2YXIgbWV0aG9kID0gQXJyYXlQcm90b1tuYW1lXTsKICAgIF8ucHJvdG90eXBlW25hbWVdID0gZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiByZXN1bHQuY2FsbCh0aGlzLCBtZXRob2QuYXBwbHkodGhpcy5fd3JhcHBlZCwgYXJndW1lbnRzKSk7CiAgICB9OwogIH0pOwoKICBfLmV4dGVuZChfLnByb3RvdHlwZSwgewoKICAgIC8vIFN0YXJ0IGNoYWluaW5nIGEgd3JhcHBlZCBVbmRlcnNjb3JlIG9iamVjdC4KICAgIGNoYWluOiBmdW5jdGlvbigpIHsKICAgICAgdGhpcy5fY2hhaW4gPSB0cnVlOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gRXh0cmFjdHMgdGhlIHJlc3VsdCBmcm9tIGEgd3JhcHBlZCBhbmQgY2hhaW5lZCBvYmplY3QuCiAgICB2YWx1ZTogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB0aGlzLl93cmFwcGVkOwogICAgfQoKICB9KTsKCn0pLmNhbGwodGhpcyk7CgpkZWZpbmUoInVuZGVyc2NvcmUiLCAoZnVuY3Rpb24gKGdsb2JhbCkgewogICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgcmV0LCBmbjsKICAgICAgICByZXR1cm4gcmV0IHx8IGdsb2JhbC5fOwogICAgfTsKfSh0aGlzKSkpOwoKLy8gICAgIEJhY2tib25lLmpzIDEuMC4wCgovLyAgICAgKGMpIDIwMTAtMjAxMyBKZXJlbXkgQXNoa2VuYXMsIERvY3VtZW50Q2xvdWQgSW5jLgovLyAgICAgQmFja2JvbmUgbWF5IGJlIGZyZWVseSBkaXN0cmlidXRlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuCi8vICAgICBGb3IgYWxsIGRldGFpbHMgYW5kIGRvY3VtZW50YXRpb246Ci8vICAgICBodHRwOi8vYmFja2JvbmVqcy5vcmcKCihmdW5jdGlvbigpewoKICAvLyBJbml0aWFsIFNldHVwCiAgLy8gLS0tLS0tLS0tLS0tLQoKICAvLyBTYXZlIGEgcmVmZXJlbmNlIHRvIHRoZSBnbG9iYWwgb2JqZWN0IChgd2luZG93YCBpbiB0aGUgYnJvd3NlciwgYGV4cG9ydHNgCiAgLy8gb24gdGhlIHNlcnZlcikuCiAgdmFyIHJvb3QgPSB0aGlzOwoKICAvLyBTYXZlIHRoZSBwcmV2aW91cyB2YWx1ZSBvZiB0aGUgYEJhY2tib25lYCB2YXJpYWJsZSwgc28gdGhhdCBpdCBjYW4gYmUKICAvLyByZXN0b3JlZCBsYXRlciBvbiwgaWYgYG5vQ29uZmxpY3RgIGlzIHVzZWQuCiAgdmFyIHByZXZpb3VzQmFja2JvbmUgPSByb290LkJhY2tib25lOwoKICAvLyBDcmVhdGUgbG9jYWwgcmVmZXJlbmNlcyB0byBhcnJheSBtZXRob2RzIHdlJ2xsIHdhbnQgdG8gdXNlIGxhdGVyLgogIHZhciBhcnJheSA9IFtdOwogIHZhciBwdXNoID0gYXJyYXkucHVzaDsKICB2YXIgc2xpY2UgPSBhcnJheS5zbGljZTsKICB2YXIgc3BsaWNlID0gYXJyYXkuc3BsaWNlOwoKICAvLyBUaGUgdG9wLWxldmVsIG5hbWVzcGFjZS4gQWxsIHB1YmxpYyBCYWNrYm9uZSBjbGFzc2VzIGFuZCBtb2R1bGVzIHdpbGwKICAvLyBiZSBhdHRhY2hlZCB0byB0aGlzLiBFeHBvcnRlZCBmb3IgYm90aCB0aGUgYnJvd3NlciBhbmQgdGhlIHNlcnZlci4KICB2YXIgQmFja2JvbmU7CiAgaWYgKHR5cGVvZiBleHBvcnRzICE9PSAndW5kZWZpbmVkJykgewogICAgQmFja2JvbmUgPSBleHBvcnRzOwogIH0gZWxzZSB7CiAgICBCYWNrYm9uZSA9IHJvb3QuQmFja2JvbmUgPSB7fTsKICB9CgogIC8vIEN1cnJlbnQgdmVyc2lvbiBvZiB0aGUgbGlicmFyeS4gS2VlcCBpbiBzeW5jIHdpdGggYHBhY2thZ2UuanNvbmAuCiAgQmFja2JvbmUuVkVSU0lPTiA9ICcxLjAuMCc7CgogIC8vIFJlcXVpcmUgVW5kZXJzY29yZSwgaWYgd2UncmUgb24gdGhlIHNlcnZlciwgYW5kIGl0J3Mgbm90IGFscmVhZHkgcHJlc2VudC4KICB2YXIgXyA9IHJvb3QuXzsKICBpZiAoIV8gJiYgKHR5cGVvZiByZXF1aXJlICE9PSAndW5kZWZpbmVkJykpIF8gPSByZXF1aXJlKCd1bmRlcnNjb3JlJyk7CgogIC8vIEZvciBCYWNrYm9uZSdzIHB1cnBvc2VzLCBqUXVlcnksIFplcHRvLCBFbmRlciwgb3IgTXkgTGlicmFyeSAoa2lkZGluZykgb3ducwogIC8vIHRoZSBgJGAgdmFyaWFibGUuCiAgQmFja2JvbmUuJCA9IHJvb3QualF1ZXJ5IHx8IHJvb3QuWmVwdG8gfHwgcm9vdC5lbmRlciB8fCByb290LiQ7CgogIC8vIFJ1bnMgQmFja2JvbmUuanMgaW4gKm5vQ29uZmxpY3QqIG1vZGUsIHJldHVybmluZyB0aGUgYEJhY2tib25lYCB2YXJpYWJsZQogIC8vIHRvIGl0cyBwcmV2aW91cyBvd25lci4gUmV0dXJucyBhIHJlZmVyZW5jZSB0byB0aGlzIEJhY2tib25lIG9iamVjdC4KICBCYWNrYm9uZS5ub0NvbmZsaWN0ID0gZnVuY3Rpb24oKSB7CiAgICByb290LkJhY2tib25lID0gcHJldmlvdXNCYWNrYm9uZTsKICAgIHJldHVybiB0aGlzOwogIH07CgogIC8vIFR1cm4gb24gYGVtdWxhdGVIVFRQYCB0byBzdXBwb3J0IGxlZ2FjeSBIVFRQIHNlcnZlcnMuIFNldHRpbmcgdGhpcyBvcHRpb24KICAvLyB3aWxsIGZha2UgYCJQVVQiYCBhbmQgYCJERUxFVEUiYCByZXF1ZXN0cyB2aWEgdGhlIGBfbWV0aG9kYCBwYXJhbWV0ZXIgYW5kCiAgLy8gc2V0IGEgYFgtSHR0cC1NZXRob2QtT3ZlcnJpZGVgIGhlYWRlci4KICBCYWNrYm9uZS5lbXVsYXRlSFRUUCA9IGZhbHNlOwoKICAvLyBUdXJuIG9uIGBlbXVsYXRlSlNPTmAgdG8gc3VwcG9ydCBsZWdhY3kgc2VydmVycyB0aGF0IGNhbid0IGRlYWwgd2l0aCBkaXJlY3QKICAvLyBgYXBwbGljYXRpb24vanNvbmAgcmVxdWVzdHMgLi4uIHdpbGwgZW5jb2RlIHRoZSBib2R5IGFzCiAgLy8gYGFwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZGAgaW5zdGVhZCBhbmQgd2lsbCBzZW5kIHRoZSBtb2RlbCBpbiBhCiAgLy8gZm9ybSBwYXJhbSBuYW1lZCBgbW9kZWxgLgogIEJhY2tib25lLmVtdWxhdGVKU09OID0gZmFsc2U7CgogIC8vIEJhY2tib25lLkV2ZW50cwogIC8vIC0tLS0tLS0tLS0tLS0tLQoKICAvLyBBIG1vZHVsZSB0aGF0IGNhbiBiZSBtaXhlZCBpbiB0byAqYW55IG9iamVjdCogaW4gb3JkZXIgdG8gcHJvdmlkZSBpdCB3aXRoCiAgLy8gY3VzdG9tIGV2ZW50cy4gWW91IG1heSBiaW5kIHdpdGggYG9uYCBvciByZW1vdmUgd2l0aCBgb2ZmYCBjYWxsYmFjawogIC8vIGZ1bmN0aW9ucyB0byBhbiBldmVudDsgYHRyaWdnZXJgLWluZyBhbiBldmVudCBmaXJlcyBhbGwgY2FsbGJhY2tzIGluCiAgLy8gc3VjY2Vzc2lvbi4KICAvLwogIC8vICAgICB2YXIgb2JqZWN0ID0ge307CiAgLy8gICAgIF8uZXh0ZW5kKG9iamVjdCwgQmFja2JvbmUuRXZlbnRzKTsKICAvLyAgICAgb2JqZWN0Lm9uKCdleHBhbmQnLCBmdW5jdGlvbigpeyBhbGVydCgnZXhwYW5kZWQnKTsgfSk7CiAgLy8gICAgIG9iamVjdC50cmlnZ2VyKCdleHBhbmQnKTsKICAvLwogIHZhciBFdmVudHMgPSBCYWNrYm9uZS5FdmVudHMgPSB7CgogICAgLy8gQmluZCBhbiBldmVudCB0byBhIGBjYWxsYmFja2AgZnVuY3Rpb24uIFBhc3NpbmcgYCJhbGwiYCB3aWxsIGJpbmQKICAgIC8vIHRoZSBjYWxsYmFjayB0byBhbGwgZXZlbnRzIGZpcmVkLgogICAgb246IGZ1bmN0aW9uKG5hbWUsIGNhbGxiYWNrLCBjb250ZXh0KSB7CiAgICAgIGlmICghZXZlbnRzQXBpKHRoaXMsICdvbicsIG5hbWUsIFtjYWxsYmFjaywgY29udGV4dF0pIHx8ICFjYWxsYmFjaykgcmV0dXJuIHRoaXM7CiAgICAgIHRoaXMuX2V2ZW50cyB8fCAodGhpcy5fZXZlbnRzID0ge30pOwogICAgICB2YXIgZXZlbnRzID0gdGhpcy5fZXZlbnRzW25hbWVdIHx8ICh0aGlzLl9ldmVudHNbbmFtZV0gPSBbXSk7CiAgICAgIGV2ZW50cy5wdXNoKHtjYWxsYmFjazogY2FsbGJhY2ssIGNvbnRleHQ6IGNvbnRleHQsIGN0eDogY29udGV4dCB8fCB0aGlzfSk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBCaW5kIGFuIGV2ZW50IHRvIG9ubHkgYmUgdHJpZ2dlcmVkIGEgc2luZ2xlIHRpbWUuIEFmdGVyIHRoZSBmaXJzdCB0aW1lCiAgICAvLyB0aGUgY2FsbGJhY2sgaXMgaW52b2tlZCwgaXQgd2lsbCBiZSByZW1vdmVkLgogICAgb25jZTogZnVuY3Rpb24obmFtZSwgY2FsbGJhY2ssIGNvbnRleHQpIHsKICAgICAgaWYgKCFldmVudHNBcGkodGhpcywgJ29uY2UnLCBuYW1lLCBbY2FsbGJhY2ssIGNvbnRleHRdKSB8fCAhY2FsbGJhY2spIHJldHVybiB0aGlzOwogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIHZhciBvbmNlID0gXy5vbmNlKGZ1bmN0aW9uKCkgewogICAgICAgIHNlbGYub2ZmKG5hbWUsIG9uY2UpOwogICAgICAgIGNhbGxiYWNrLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIH0pOwogICAgICBvbmNlLl9jYWxsYmFjayA9IGNhbGxiYWNrOwogICAgICByZXR1cm4gdGhpcy5vbihuYW1lLCBvbmNlLCBjb250ZXh0KTsKICAgIH0sCgogICAgLy8gUmVtb3ZlIG9uZSBvciBtYW55IGNhbGxiYWNrcy4gSWYgYGNvbnRleHRgIGlzIG51bGwsIHJlbW92ZXMgYWxsCiAgICAvLyBjYWxsYmFja3Mgd2l0aCB0aGF0IGZ1bmN0aW9uLiBJZiBgY2FsbGJhY2tgIGlzIG51bGwsIHJlbW92ZXMgYWxsCiAgICAvLyBjYWxsYmFja3MgZm9yIHRoZSBldmVudC4gSWYgYG5hbWVgIGlzIG51bGwsIHJlbW92ZXMgYWxsIGJvdW5kCiAgICAvLyBjYWxsYmFja3MgZm9yIGFsbCBldmVudHMuCiAgICBvZmY6IGZ1bmN0aW9uKG5hbWUsIGNhbGxiYWNrLCBjb250ZXh0KSB7CiAgICAgIHZhciByZXRhaW4sIGV2LCBldmVudHMsIG5hbWVzLCBpLCBsLCBqLCBrOwogICAgICBpZiAoIXRoaXMuX2V2ZW50cyB8fCAhZXZlbnRzQXBpKHRoaXMsICdvZmYnLCBuYW1lLCBbY2FsbGJhY2ssIGNvbnRleHRdKSkgcmV0dXJuIHRoaXM7CiAgICAgIGlmICghbmFtZSAmJiAhY2FsbGJhY2sgJiYgIWNvbnRleHQpIHsKICAgICAgICB0aGlzLl9ldmVudHMgPSB7fTsKICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfQoKICAgICAgbmFtZXMgPSBuYW1lID8gW25hbWVdIDogXy5rZXlzKHRoaXMuX2V2ZW50cyk7CiAgICAgIGZvciAoaSA9IDAsIGwgPSBuYW1lcy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICBuYW1lID0gbmFtZXNbaV07CiAgICAgICAgaWYgKGV2ZW50cyA9IHRoaXMuX2V2ZW50c1tuYW1lXSkgewogICAgICAgICAgdGhpcy5fZXZlbnRzW25hbWVdID0gcmV0YWluID0gW107CiAgICAgICAgICBpZiAoY2FsbGJhY2sgfHwgY29udGV4dCkgewogICAgICAgICAgICBmb3IgKGogPSAwLCBrID0gZXZlbnRzLmxlbmd0aDsgaiA8IGs7IGorKykgewogICAgICAgICAgICAgIGV2ID0gZXZlbnRzW2pdOwogICAgICAgICAgICAgIGlmICgoY2FsbGJhY2sgJiYgY2FsbGJhY2sgIT09IGV2LmNhbGxiYWNrICYmIGNhbGxiYWNrICE9PSBldi5jYWxsYmFjay5fY2FsbGJhY2spIHx8CiAgICAgICAgICAgICAgICAgIChjb250ZXh0ICYmIGNvbnRleHQgIT09IGV2LmNvbnRleHQpKSB7CiAgICAgICAgICAgICAgICByZXRhaW4ucHVzaChldik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIXJldGFpbi5sZW5ndGgpIGRlbGV0ZSB0aGlzLl9ldmVudHNbbmFtZV07CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gVHJpZ2dlciBvbmUgb3IgbWFueSBldmVudHMsIGZpcmluZyBhbGwgYm91bmQgY2FsbGJhY2tzLiBDYWxsYmFja3MgYXJlCiAgICAvLyBwYXNzZWQgdGhlIHNhbWUgYXJndW1lbnRzIGFzIGB0cmlnZ2VyYCBpcywgYXBhcnQgZnJvbSB0aGUgZXZlbnQgbmFtZQogICAgLy8gKHVubGVzcyB5b3UncmUgbGlzdGVuaW5nIG9uIGAiYWxsImAsIHdoaWNoIHdpbGwgY2F1c2UgeW91ciBjYWxsYmFjayB0bwogICAgLy8gcmVjZWl2ZSB0aGUgdHJ1ZSBuYW1lIG9mIHRoZSBldmVudCBhcyB0aGUgZmlyc3QgYXJndW1lbnQpLgogICAgdHJpZ2dlcjogZnVuY3Rpb24obmFtZSkgewogICAgICBpZiAoIXRoaXMuX2V2ZW50cykgcmV0dXJuIHRoaXM7CiAgICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwogICAgICBpZiAoIWV2ZW50c0FwaSh0aGlzLCAndHJpZ2dlcicsIG5hbWUsIGFyZ3MpKSByZXR1cm4gdGhpczsKICAgICAgdmFyIGV2ZW50cyA9IHRoaXMuX2V2ZW50c1tuYW1lXTsKICAgICAgdmFyIGFsbEV2ZW50cyA9IHRoaXMuX2V2ZW50cy5hbGw7CiAgICAgIGlmIChldmVudHMpIHRyaWdnZXJFdmVudHMoZXZlbnRzLCBhcmdzKTsKICAgICAgaWYgKGFsbEV2ZW50cykgdHJpZ2dlckV2ZW50cyhhbGxFdmVudHMsIGFyZ3VtZW50cyk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBUZWxsIHRoaXMgb2JqZWN0IHRvIHN0b3AgbGlzdGVuaW5nIHRvIGVpdGhlciBzcGVjaWZpYyBldmVudHMgLi4uIG9yCiAgICAvLyB0byBldmVyeSBvYmplY3QgaXQncyBjdXJyZW50bHkgbGlzdGVuaW5nIHRvLgogICAgc3RvcExpc3RlbmluZzogZnVuY3Rpb24ob2JqLCBuYW1lLCBjYWxsYmFjaykgewogICAgICB2YXIgbGlzdGVuZXJzID0gdGhpcy5fbGlzdGVuZXJzOwogICAgICBpZiAoIWxpc3RlbmVycykgcmV0dXJuIHRoaXM7CiAgICAgIHZhciBkZWxldGVMaXN0ZW5lciA9ICFuYW1lICYmICFjYWxsYmFjazsKICAgICAgaWYgKHR5cGVvZiBuYW1lID09PSAnb2JqZWN0JykgY2FsbGJhY2sgPSB0aGlzOwogICAgICBpZiAob2JqKSAobGlzdGVuZXJzID0ge30pW29iai5fbGlzdGVuZXJJZF0gPSBvYmo7CiAgICAgIGZvciAodmFyIGlkIGluIGxpc3RlbmVycykgewogICAgICAgIGxpc3RlbmVyc1tpZF0ub2ZmKG5hbWUsIGNhbGxiYWNrLCB0aGlzKTsKICAgICAgICBpZiAoZGVsZXRlTGlzdGVuZXIpIGRlbGV0ZSB0aGlzLl9saXN0ZW5lcnNbaWRdOwogICAgICB9CiAgICAgIHJldHVybiB0aGlzOwogICAgfQoKICB9OwoKICAvLyBSZWd1bGFyIGV4cHJlc3Npb24gdXNlZCB0byBzcGxpdCBldmVudCBzdHJpbmdzLgogIHZhciBldmVudFNwbGl0dGVyID0gL1xzKy87CgogIC8vIEltcGxlbWVudCBmYW5jeSBmZWF0dXJlcyBvZiB0aGUgRXZlbnRzIEFQSSBzdWNoIGFzIG11bHRpcGxlIGV2ZW50CiAgLy8gbmFtZXMgYCJjaGFuZ2UgYmx1ciJgIGFuZCBqUXVlcnktc3R5bGUgZXZlbnQgbWFwcyBge2NoYW5nZTogYWN0aW9ufWAKICAvLyBpbiB0ZXJtcyBvZiB0aGUgZXhpc3RpbmcgQVBJLgogIHZhciBldmVudHNBcGkgPSBmdW5jdGlvbihvYmosIGFjdGlvbiwgbmFtZSwgcmVzdCkgewogICAgaWYgKCFuYW1lKSByZXR1cm4gdHJ1ZTsKCiAgICAvLyBIYW5kbGUgZXZlbnQgbWFwcy4KICAgIGlmICh0eXBlb2YgbmFtZSA9PT0gJ29iamVjdCcpIHsKICAgICAgZm9yICh2YXIga2V5IGluIG5hbWUpIHsKICAgICAgICBvYmpbYWN0aW9uXS5hcHBseShvYmosIFtrZXksIG5hbWVba2V5XV0uY29uY2F0KHJlc3QpKTsKICAgICAgfQogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgLy8gSGFuZGxlIHNwYWNlIHNlcGFyYXRlZCBldmVudCBuYW1lcy4KICAgIGlmIChldmVudFNwbGl0dGVyLnRlc3QobmFtZSkpIHsKICAgICAgdmFyIG5hbWVzID0gbmFtZS5zcGxpdChldmVudFNwbGl0dGVyKTsKICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSBuYW1lcy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICBvYmpbYWN0aW9uXS5hcHBseShvYmosIFtuYW1lc1tpXV0uY29uY2F0KHJlc3QpKTsKICAgICAgfQogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgcmV0dXJuIHRydWU7CiAgfTsKCiAgLy8gQSBkaWZmaWN1bHQtdG8tYmVsaWV2ZSwgYnV0IG9wdGltaXplZCBpbnRlcm5hbCBkaXNwYXRjaCBmdW5jdGlvbiBmb3IKICAvLyB0cmlnZ2VyaW5nIGV2ZW50cy4gVHJpZXMgdG8ga2VlcCB0aGUgdXN1YWwgY2FzZXMgc3BlZWR5IChtb3N0IGludGVybmFsCiAgLy8gQmFja2JvbmUgZXZlbnRzIGhhdmUgMyBhcmd1bWVudHMpLgogIHZhciB0cmlnZ2VyRXZlbnRzID0gZnVuY3Rpb24oZXZlbnRzLCBhcmdzKSB7CiAgICB2YXIgZXYsIGkgPSAtMSwgbCA9IGV2ZW50cy5sZW5ndGgsIGExID0gYXJnc1swXSwgYTIgPSBhcmdzWzFdLCBhMyA9IGFyZ3NbMl07CiAgICBzd2l0Y2ggKGFyZ3MubGVuZ3RoKSB7CiAgICAgIGNhc2UgMDogd2hpbGUgKCsraSA8IGwpIChldiA9IGV2ZW50c1tpXSkuY2FsbGJhY2suY2FsbChldi5jdHgpOyByZXR1cm47CiAgICAgIGNhc2UgMTogd2hpbGUgKCsraSA8IGwpIChldiA9IGV2ZW50c1tpXSkuY2FsbGJhY2suY2FsbChldi5jdHgsIGExKTsgcmV0dXJuOwogICAgICBjYXNlIDI6IHdoaWxlICgrK2kgPCBsKSAoZXYgPSBldmVudHNbaV0pLmNhbGxiYWNrLmNhbGwoZXYuY3R4LCBhMSwgYTIpOyByZXR1cm47CiAgICAgIGNhc2UgMzogd2hpbGUgKCsraSA8IGwpIChldiA9IGV2ZW50c1tpXSkuY2FsbGJhY2suY2FsbChldi5jdHgsIGExLCBhMiwgYTMpOyByZXR1cm47CiAgICAgIGRlZmF1bHQ6IHdoaWxlICgrK2kgPCBsKSAoZXYgPSBldmVudHNbaV0pLmNhbGxiYWNrLmFwcGx5KGV2LmN0eCwgYXJncyk7CiAgICB9CiAgfTsKCiAgdmFyIGxpc3Rlbk1ldGhvZHMgPSB7bGlzdGVuVG86ICdvbicsIGxpc3RlblRvT25jZTogJ29uY2UnfTsKCiAgLy8gSW52ZXJzaW9uLW9mLWNvbnRyb2wgdmVyc2lvbnMgb2YgYG9uYCBhbmQgYG9uY2VgLiBUZWxsICp0aGlzKiBvYmplY3QgdG8KICAvLyBsaXN0ZW4gdG8gYW4gZXZlbnQgaW4gYW5vdGhlciBvYmplY3QgLi4uIGtlZXBpbmcgdHJhY2sgb2Ygd2hhdCBpdCdzCiAgLy8gbGlzdGVuaW5nIHRvLgogIF8uZWFjaChsaXN0ZW5NZXRob2RzLCBmdW5jdGlvbihpbXBsZW1lbnRhdGlvbiwgbWV0aG9kKSB7CiAgICBFdmVudHNbbWV0aG9kXSA9IGZ1bmN0aW9uKG9iaiwgbmFtZSwgY2FsbGJhY2spIHsKICAgICAgdmFyIGxpc3RlbmVycyA9IHRoaXMuX2xpc3RlbmVycyB8fCAodGhpcy5fbGlzdGVuZXJzID0ge30pOwogICAgICB2YXIgaWQgPSBvYmouX2xpc3RlbmVySWQgfHwgKG9iai5fbGlzdGVuZXJJZCA9IF8udW5pcXVlSWQoJ2wnKSk7CiAgICAgIGxpc3RlbmVyc1tpZF0gPSBvYmo7CiAgICAgIGlmICh0eXBlb2YgbmFtZSA9PT0gJ29iamVjdCcpIGNhbGxiYWNrID0gdGhpczsKICAgICAgb2JqW2ltcGxlbWVudGF0aW9uXShuYW1lLCBjYWxsYmFjaywgdGhpcyk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfTsKICB9KTsKCiAgLy8gQWxpYXNlcyBmb3IgYmFja3dhcmRzIGNvbXBhdGliaWxpdHkuCiAgRXZlbnRzLmJpbmQgICA9IEV2ZW50cy5vbjsKICBFdmVudHMudW5iaW5kID0gRXZlbnRzLm9mZjsKCiAgLy8gQWxsb3cgdGhlIGBCYWNrYm9uZWAgb2JqZWN0IHRvIHNlcnZlIGFzIGEgZ2xvYmFsIGV2ZW50IGJ1cywgZm9yIGZvbGtzIHdobwogIC8vIHdhbnQgZ2xvYmFsICJwdWJzdWIiIGluIGEgY29udmVuaWVudCBwbGFjZS4KICBfLmV4dGVuZChCYWNrYm9uZSwgRXZlbnRzKTsKCiAgLy8gQmFja2JvbmUuTW9kZWwKICAvLyAtLS0tLS0tLS0tLS0tLQoKICAvLyBCYWNrYm9uZSAqKk1vZGVscyoqIGFyZSB0aGUgYmFzaWMgZGF0YSBvYmplY3QgaW4gdGhlIGZyYW1ld29yayAtLQogIC8vIGZyZXF1ZW50bHkgcmVwcmVzZW50aW5nIGEgcm93IGluIGEgdGFibGUgaW4gYSBkYXRhYmFzZSBvbiB5b3VyIHNlcnZlci4KICAvLyBBIGRpc2NyZXRlIGNodW5rIG9mIGRhdGEgYW5kIGEgYnVuY2ggb2YgdXNlZnVsLCByZWxhdGVkIG1ldGhvZHMgZm9yCiAgLy8gcGVyZm9ybWluZyBjb21wdXRhdGlvbnMgYW5kIHRyYW5zZm9ybWF0aW9ucyBvbiB0aGF0IGRhdGEuCgogIC8vIENyZWF0ZSBhIG5ldyBtb2RlbCB3aXRoIHRoZSBzcGVjaWZpZWQgYXR0cmlidXRlcy4gQSBjbGllbnQgaWQgKGBjaWRgKQogIC8vIGlzIGF1dG9tYXRpY2FsbHkgZ2VuZXJhdGVkIGFuZCBhc3NpZ25lZCBmb3IgeW91LgogIHZhciBNb2RlbCA9IEJhY2tib25lLk1vZGVsID0gZnVuY3Rpb24oYXR0cmlidXRlcywgb3B0aW9ucykgewogICAgdmFyIGRlZmF1bHRzOwogICAgdmFyIGF0dHJzID0gYXR0cmlidXRlcyB8fCB7fTsKICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CiAgICB0aGlzLmNpZCA9IF8udW5pcXVlSWQoJ2MnKTsKICAgIHRoaXMuYXR0cmlidXRlcyA9IHt9OwogICAgXy5leHRlbmQodGhpcywgXy5waWNrKG9wdGlvbnMsIG1vZGVsT3B0aW9ucykpOwogICAgaWYgKG9wdGlvbnMucGFyc2UpIGF0dHJzID0gdGhpcy5wYXJzZShhdHRycywgb3B0aW9ucykgfHwge307CiAgICBpZiAoZGVmYXVsdHMgPSBfLnJlc3VsdCh0aGlzLCAnZGVmYXVsdHMnKSkgewogICAgICBhdHRycyA9IF8uZGVmYXVsdHMoe30sIGF0dHJzLCBkZWZhdWx0cyk7CiAgICB9CiAgICB0aGlzLnNldChhdHRycywgb3B0aW9ucyk7CiAgICB0aGlzLmNoYW5nZWQgPSB7fTsKICAgIHRoaXMuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIH07CgogIC8vIEEgbGlzdCBvZiBvcHRpb25zIHRvIGJlIGF0dGFjaGVkIGRpcmVjdGx5IHRvIHRoZSBtb2RlbCwgaWYgcHJvdmlkZWQuCiAgdmFyIG1vZGVsT3B0aW9ucyA9IFsndXJsJywgJ3VybFJvb3QnLCAnY29sbGVjdGlvbiddOwoKICAvLyBBdHRhY2ggYWxsIGluaGVyaXRhYmxlIG1ldGhvZHMgdG8gdGhlIE1vZGVsIHByb3RvdHlwZS4KICBfLmV4dGVuZChNb2RlbC5wcm90b3R5cGUsIEV2ZW50cywgewoKICAgIC8vIEEgaGFzaCBvZiBhdHRyaWJ1dGVzIHdob3NlIGN1cnJlbnQgYW5kIHByZXZpb3VzIHZhbHVlIGRpZmZlci4KICAgIGNoYW5nZWQ6IG51bGwsCgogICAgLy8gVGhlIHZhbHVlIHJldHVybmVkIGR1cmluZyB0aGUgbGFzdCBmYWlsZWQgdmFsaWRhdGlvbi4KICAgIHZhbGlkYXRpb25FcnJvcjogbnVsbCwKCiAgICAvLyBUaGUgZGVmYXVsdCBuYW1lIGZvciB0aGUgSlNPTiBgaWRgIGF0dHJpYnV0ZSBpcyBgImlkImAuIE1vbmdvREIgYW5kCiAgICAvLyBDb3VjaERCIHVzZXJzIG1heSB3YW50IHRvIHNldCB0aGlzIHRvIGAiX2lkImAuCiAgICBpZEF0dHJpYnV0ZTogJ2lkJywKCiAgICAvLyBJbml0aWFsaXplIGlzIGFuIGVtcHR5IGZ1bmN0aW9uIGJ5IGRlZmF1bHQuIE92ZXJyaWRlIGl0IHdpdGggeW91ciBvd24KICAgIC8vIGluaXRpYWxpemF0aW9uIGxvZ2ljLgogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oKXt9LAoKICAgIC8vIFJldHVybiBhIGNvcHkgb2YgdGhlIG1vZGVsJ3MgYGF0dHJpYnV0ZXNgIG9iamVjdC4KICAgIHRvSlNPTjogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICByZXR1cm4gXy5jbG9uZSh0aGlzLmF0dHJpYnV0ZXMpOwogICAgfSwKCiAgICAvLyBQcm94eSBgQmFja2JvbmUuc3luY2AgYnkgZGVmYXVsdCAtLSBidXQgb3ZlcnJpZGUgdGhpcyBpZiB5b3UgbmVlZAogICAgLy8gY3VzdG9tIHN5bmNpbmcgc2VtYW50aWNzIGZvciAqdGhpcyogcGFydGljdWxhciBtb2RlbC4KICAgIHN5bmM6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gQmFja2JvbmUuc3luYy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfSwKCiAgICAvLyBHZXQgdGhlIHZhbHVlIG9mIGFuIGF0dHJpYnV0ZS4KICAgIGdldDogZnVuY3Rpb24oYXR0cikgewogICAgICByZXR1cm4gdGhpcy5hdHRyaWJ1dGVzW2F0dHJdOwogICAgfSwKCiAgICAvLyBHZXQgdGhlIEhUTUwtZXNjYXBlZCB2YWx1ZSBvZiBhbiBhdHRyaWJ1dGUuCiAgICBlc2NhcGU6IGZ1bmN0aW9uKGF0dHIpIHsKICAgICAgcmV0dXJuIF8uZXNjYXBlKHRoaXMuZ2V0KGF0dHIpKTsKICAgIH0sCgogICAgLy8gUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIGF0dHJpYnV0ZSBjb250YWlucyBhIHZhbHVlIHRoYXQgaXMgbm90IG51bGwKICAgIC8vIG9yIHVuZGVmaW5lZC4KICAgIGhhczogZnVuY3Rpb24oYXR0cikgewogICAgICByZXR1cm4gdGhpcy5nZXQoYXR0cikgIT0gbnVsbDsKICAgIH0sCgogICAgLy8gU2V0IGEgaGFzaCBvZiBtb2RlbCBhdHRyaWJ1dGVzIG9uIHRoZSBvYmplY3QsIGZpcmluZyBgImNoYW5nZSJgLiBUaGlzIGlzCiAgICAvLyB0aGUgY29yZSBwcmltaXRpdmUgb3BlcmF0aW9uIG9mIGEgbW9kZWwsIHVwZGF0aW5nIHRoZSBkYXRhIGFuZCBub3RpZnlpbmcKICAgIC8vIGFueW9uZSB3aG8gbmVlZHMgdG8ga25vdyBhYm91dCB0aGUgY2hhbmdlIGluIHN0YXRlLiBUaGUgaGVhcnQgb2YgdGhlIGJlYXN0LgogICAgc2V0OiBmdW5jdGlvbihrZXksIHZhbCwgb3B0aW9ucykgewogICAgICB2YXIgYXR0ciwgYXR0cnMsIHVuc2V0LCBjaGFuZ2VzLCBzaWxlbnQsIGNoYW5naW5nLCBwcmV2LCBjdXJyZW50OwogICAgICBpZiAoa2V5ID09IG51bGwpIHJldHVybiB0aGlzOwoKICAgICAgLy8gSGFuZGxlIGJvdGggYCJrZXkiLCB2YWx1ZWAgYW5kIGB7a2V5OiB2YWx1ZX1gIC1zdHlsZSBhcmd1bWVudHMuCiAgICAgIGlmICh0eXBlb2Yga2V5ID09PSAnb2JqZWN0JykgewogICAgICAgIGF0dHJzID0ga2V5OwogICAgICAgIG9wdGlvbnMgPSB2YWw7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgKGF0dHJzID0ge30pW2tleV0gPSB2YWw7CiAgICAgIH0KCiAgICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CgogICAgICAvLyBSdW4gdmFsaWRhdGlvbi4KICAgICAgaWYgKCF0aGlzLl92YWxpZGF0ZShhdHRycywgb3B0aW9ucykpIHJldHVybiBmYWxzZTsKCiAgICAgIC8vIEV4dHJhY3QgYXR0cmlidXRlcyBhbmQgb3B0aW9ucy4KICAgICAgdW5zZXQgICAgICAgICAgID0gb3B0aW9ucy51bnNldDsKICAgICAgc2lsZW50ICAgICAgICAgID0gb3B0aW9ucy5zaWxlbnQ7CiAgICAgIGNoYW5nZXMgICAgICAgICA9IFtdOwogICAgICBjaGFuZ2luZyAgICAgICAgPSB0aGlzLl9jaGFuZ2luZzsKICAgICAgdGhpcy5fY2hhbmdpbmcgID0gdHJ1ZTsKCiAgICAgIGlmICghY2hhbmdpbmcpIHsKICAgICAgICB0aGlzLl9wcmV2aW91c0F0dHJpYnV0ZXMgPSBfLmNsb25lKHRoaXMuYXR0cmlidXRlcyk7CiAgICAgICAgdGhpcy5jaGFuZ2VkID0ge307CiAgICAgIH0KICAgICAgY3VycmVudCA9IHRoaXMuYXR0cmlidXRlcywgcHJldiA9IHRoaXMuX3ByZXZpb3VzQXR0cmlidXRlczsKCiAgICAgIC8vIENoZWNrIGZvciBjaGFuZ2VzIG9mIGBpZGAuCiAgICAgIGlmICh0aGlzLmlkQXR0cmlidXRlIGluIGF0dHJzKSB0aGlzLmlkID0gYXR0cnNbdGhpcy5pZEF0dHJpYnV0ZV07CgogICAgICAvLyBGb3IgZWFjaCBgc2V0YCBhdHRyaWJ1dGUsIHVwZGF0ZSBvciBkZWxldGUgdGhlIGN1cnJlbnQgdmFsdWUuCiAgICAgIGZvciAoYXR0ciBpbiBhdHRycykgewogICAgICAgIHZhbCA9IGF0dHJzW2F0dHJdOwogICAgICAgIGlmICghXy5pc0VxdWFsKGN1cnJlbnRbYXR0cl0sIHZhbCkpIGNoYW5nZXMucHVzaChhdHRyKTsKICAgICAgICBpZiAoIV8uaXNFcXVhbChwcmV2W2F0dHJdLCB2YWwpKSB7CiAgICAgICAgICB0aGlzLmNoYW5nZWRbYXR0cl0gPSB2YWw7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGRlbGV0ZSB0aGlzLmNoYW5nZWRbYXR0cl07CiAgICAgICAgfQogICAgICAgIHVuc2V0ID8gZGVsZXRlIGN1cnJlbnRbYXR0cl0gOiBjdXJyZW50W2F0dHJdID0gdmFsOwogICAgICB9CgogICAgICAvLyBUcmlnZ2VyIGFsbCByZWxldmFudCBhdHRyaWJ1dGUgY2hhbmdlcy4KICAgICAgaWYgKCFzaWxlbnQpIHsKICAgICAgICBpZiAoY2hhbmdlcy5sZW5ndGgpIHRoaXMuX3BlbmRpbmcgPSB0cnVlOwogICAgICAgIGZvciAodmFyIGkgPSAwLCBsID0gY2hhbmdlcy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgIHRoaXMudHJpZ2dlcignY2hhbmdlOicgKyBjaGFuZ2VzW2ldLCB0aGlzLCBjdXJyZW50W2NoYW5nZXNbaV1dLCBvcHRpb25zKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIC8vIFlvdSBtaWdodCBiZSB3b25kZXJpbmcgd2h5IHRoZXJlJ3MgYSBgd2hpbGVgIGxvb3AgaGVyZS4gQ2hhbmdlcyBjYW4KICAgICAgLy8gYmUgcmVjdXJzaXZlbHkgbmVzdGVkIHdpdGhpbiBgImNoYW5nZSJgIGV2ZW50cy4KICAgICAgaWYgKGNoYW5naW5nKSByZXR1cm4gdGhpczsKICAgICAgaWYgKCFzaWxlbnQpIHsKICAgICAgICB3aGlsZSAodGhpcy5fcGVuZGluZykgewogICAgICAgICAgdGhpcy5fcGVuZGluZyA9IGZhbHNlOwogICAgICAgICAgdGhpcy50cmlnZ2VyKCdjaGFuZ2UnLCB0aGlzLCBvcHRpb25zKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgdGhpcy5fcGVuZGluZyA9IGZhbHNlOwogICAgICB0aGlzLl9jaGFuZ2luZyA9IGZhbHNlOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gUmVtb3ZlIGFuIGF0dHJpYnV0ZSBmcm9tIHRoZSBtb2RlbCwgZmlyaW5nIGAiY2hhbmdlImAuIGB1bnNldGAgaXMgYSBub29wCiAgICAvLyBpZiB0aGUgYXR0cmlidXRlIGRvZXNuJ3QgZXhpc3QuCiAgICB1bnNldDogZnVuY3Rpb24oYXR0ciwgb3B0aW9ucykgewogICAgICByZXR1cm4gdGhpcy5zZXQoYXR0ciwgdm9pZCAwLCBfLmV4dGVuZCh7fSwgb3B0aW9ucywge3Vuc2V0OiB0cnVlfSkpOwogICAgfSwKCiAgICAvLyBDbGVhciBhbGwgYXR0cmlidXRlcyBvbiB0aGUgbW9kZWwsIGZpcmluZyBgImNoYW5nZSJgLgogICAgY2xlYXI6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgdmFyIGF0dHJzID0ge307CiAgICAgIGZvciAodmFyIGtleSBpbiB0aGlzLmF0dHJpYnV0ZXMpIGF0dHJzW2tleV0gPSB2b2lkIDA7CiAgICAgIHJldHVybiB0aGlzLnNldChhdHRycywgXy5leHRlbmQoe30sIG9wdGlvbnMsIHt1bnNldDogdHJ1ZX0pKTsKICAgIH0sCgogICAgLy8gRGV0ZXJtaW5lIGlmIHRoZSBtb2RlbCBoYXMgY2hhbmdlZCBzaW5jZSB0aGUgbGFzdCBgImNoYW5nZSJgIGV2ZW50LgogICAgLy8gSWYgeW91IHNwZWNpZnkgYW4gYXR0cmlidXRlIG5hbWUsIGRldGVybWluZSBpZiB0aGF0IGF0dHJpYnV0ZSBoYXMgY2hhbmdlZC4KICAgIGhhc0NoYW5nZWQ6IGZ1bmN0aW9uKGF0dHIpIHsKICAgICAgaWYgKGF0dHIgPT0gbnVsbCkgcmV0dXJuICFfLmlzRW1wdHkodGhpcy5jaGFuZ2VkKTsKICAgICAgcmV0dXJuIF8uaGFzKHRoaXMuY2hhbmdlZCwgYXR0cik7CiAgICB9LAoKICAgIC8vIFJldHVybiBhbiBvYmplY3QgY29udGFpbmluZyBhbGwgdGhlIGF0dHJpYnV0ZXMgdGhhdCBoYXZlIGNoYW5nZWQsIG9yCiAgICAvLyBmYWxzZSBpZiB0aGVyZSBhcmUgbm8gY2hhbmdlZCBhdHRyaWJ1dGVzLiBVc2VmdWwgZm9yIGRldGVybWluaW5nIHdoYXQKICAgIC8vIHBhcnRzIG9mIGEgdmlldyBuZWVkIHRvIGJlIHVwZGF0ZWQgYW5kL29yIHdoYXQgYXR0cmlidXRlcyBuZWVkIHRvIGJlCiAgICAvLyBwZXJzaXN0ZWQgdG8gdGhlIHNlcnZlci4gVW5zZXQgYXR0cmlidXRlcyB3aWxsIGJlIHNldCB0byB1bmRlZmluZWQuCiAgICAvLyBZb3UgY2FuIGFsc28gcGFzcyBhbiBhdHRyaWJ1dGVzIG9iamVjdCB0byBkaWZmIGFnYWluc3QgdGhlIG1vZGVsLAogICAgLy8gZGV0ZXJtaW5pbmcgaWYgdGhlcmUgKndvdWxkIGJlKiBhIGNoYW5nZS4KICAgIGNoYW5nZWRBdHRyaWJ1dGVzOiBmdW5jdGlvbihkaWZmKSB7CiAgICAgIGlmICghZGlmZikgcmV0dXJuIHRoaXMuaGFzQ2hhbmdlZCgpID8gXy5jbG9uZSh0aGlzLmNoYW5nZWQpIDogZmFsc2U7CiAgICAgIHZhciB2YWwsIGNoYW5nZWQgPSBmYWxzZTsKICAgICAgdmFyIG9sZCA9IHRoaXMuX2NoYW5naW5nID8gdGhpcy5fcHJldmlvdXNBdHRyaWJ1dGVzIDogdGhpcy5hdHRyaWJ1dGVzOwogICAgICBmb3IgKHZhciBhdHRyIGluIGRpZmYpIHsKICAgICAgICBpZiAoXy5pc0VxdWFsKG9sZFthdHRyXSwgKHZhbCA9IGRpZmZbYXR0cl0pKSkgY29udGludWU7CiAgICAgICAgKGNoYW5nZWQgfHwgKGNoYW5nZWQgPSB7fSkpW2F0dHJdID0gdmFsOwogICAgICB9CiAgICAgIHJldHVybiBjaGFuZ2VkOwogICAgfSwKCiAgICAvLyBHZXQgdGhlIHByZXZpb3VzIHZhbHVlIG9mIGFuIGF0dHJpYnV0ZSwgcmVjb3JkZWQgYXQgdGhlIHRpbWUgdGhlIGxhc3QKICAgIC8vIGAiY2hhbmdlImAgZXZlbnQgd2FzIGZpcmVkLgogICAgcHJldmlvdXM6IGZ1bmN0aW9uKGF0dHIpIHsKICAgICAgaWYgKGF0dHIgPT0gbnVsbCB8fCAhdGhpcy5fcHJldmlvdXNBdHRyaWJ1dGVzKSByZXR1cm4gbnVsbDsKICAgICAgcmV0dXJuIHRoaXMuX3ByZXZpb3VzQXR0cmlidXRlc1thdHRyXTsKICAgIH0sCgogICAgLy8gR2V0IGFsbCBvZiB0aGUgYXR0cmlidXRlcyBvZiB0aGUgbW9kZWwgYXQgdGhlIHRpbWUgb2YgdGhlIHByZXZpb3VzCiAgICAvLyBgImNoYW5nZSJgIGV2ZW50LgogICAgcHJldmlvdXNBdHRyaWJ1dGVzOiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIF8uY2xvbmUodGhpcy5fcHJldmlvdXNBdHRyaWJ1dGVzKTsKICAgIH0sCgogICAgLy8gRmV0Y2ggdGhlIG1vZGVsIGZyb20gdGhlIHNlcnZlci4gSWYgdGhlIHNlcnZlcidzIHJlcHJlc2VudGF0aW9uIG9mIHRoZQogICAgLy8gbW9kZWwgZGlmZmVycyBmcm9tIGl0cyBjdXJyZW50IGF0dHJpYnV0ZXMsIHRoZXkgd2lsbCBiZSBvdmVycmlkZGVuLAogICAgLy8gdHJpZ2dlcmluZyBhIGAiY2hhbmdlImAgZXZlbnQuCiAgICBmZXRjaDogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICBvcHRpb25zID0gb3B0aW9ucyA/IF8uY2xvbmUob3B0aW9ucykgOiB7fTsKICAgICAgaWYgKG9wdGlvbnMucGFyc2UgPT09IHZvaWQgMCkgb3B0aW9ucy5wYXJzZSA9IHRydWU7CiAgICAgIHZhciBtb2RlbCA9IHRoaXM7CiAgICAgIHZhciBzdWNjZXNzID0gb3B0aW9ucy5zdWNjZXNzOwogICAgICBvcHRpb25zLnN1Y2Nlc3MgPSBmdW5jdGlvbihyZXNwKSB7CiAgICAgICAgaWYgKCFtb2RlbC5zZXQobW9kZWwucGFyc2UocmVzcCwgb3B0aW9ucyksIG9wdGlvbnMpKSByZXR1cm4gZmFsc2U7CiAgICAgICAgaWYgKHN1Y2Nlc3MpIHN1Y2Nlc3MobW9kZWwsIHJlc3AsIG9wdGlvbnMpOwogICAgICAgIG1vZGVsLnRyaWdnZXIoJ3N5bmMnLCBtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CiAgICAgIH07CiAgICAgIHdyYXBFcnJvcih0aGlzLCBvcHRpb25zKTsKICAgICAgcmV0dXJuIHRoaXMuc3luYygncmVhZCcsIHRoaXMsIG9wdGlvbnMpOwogICAgfSwKCiAgICAvLyBTZXQgYSBoYXNoIG9mIG1vZGVsIGF0dHJpYnV0ZXMsIGFuZCBzeW5jIHRoZSBtb2RlbCB0byB0aGUgc2VydmVyLgogICAgLy8gSWYgdGhlIHNlcnZlciByZXR1cm5zIGFuIGF0dHJpYnV0ZXMgaGFzaCB0aGF0IGRpZmZlcnMsIHRoZSBtb2RlbCdzCiAgICAvLyBzdGF0ZSB3aWxsIGJlIGBzZXRgIGFnYWluLgogICAgc2F2ZTogZnVuY3Rpb24oa2V5LCB2YWwsIG9wdGlvbnMpIHsKICAgICAgdmFyIGF0dHJzLCBtZXRob2QsIHhociwgYXR0cmlidXRlcyA9IHRoaXMuYXR0cmlidXRlczsKCiAgICAgIC8vIEhhbmRsZSBib3RoIGAia2V5IiwgdmFsdWVgIGFuZCBge2tleTogdmFsdWV9YCAtc3R5bGUgYXJndW1lbnRzLgogICAgICBpZiAoa2V5ID09IG51bGwgfHwgdHlwZW9mIGtleSA9PT0gJ29iamVjdCcpIHsKICAgICAgICBhdHRycyA9IGtleTsKICAgICAgICBvcHRpb25zID0gdmFsOwogICAgICB9IGVsc2UgewogICAgICAgIChhdHRycyA9IHt9KVtrZXldID0gdmFsOwogICAgICB9CgogICAgICAvLyBJZiB3ZSdyZSBub3Qgd2FpdGluZyBhbmQgYXR0cmlidXRlcyBleGlzdCwgc2F2ZSBhY3RzIGFzIGBzZXQoYXR0cikuc2F2ZShudWxsLCBvcHRzKWAuCiAgICAgIGlmIChhdHRycyAmJiAoIW9wdGlvbnMgfHwgIW9wdGlvbnMud2FpdCkgJiYgIXRoaXMuc2V0KGF0dHJzLCBvcHRpb25zKSkgcmV0dXJuIGZhbHNlOwoKICAgICAgb3B0aW9ucyA9IF8uZXh0ZW5kKHt2YWxpZGF0ZTogdHJ1ZX0sIG9wdGlvbnMpOwoKICAgICAgLy8gRG8gbm90IHBlcnNpc3QgaW52YWxpZCBtb2RlbHMuCiAgICAgIGlmICghdGhpcy5fdmFsaWRhdGUoYXR0cnMsIG9wdGlvbnMpKSByZXR1cm4gZmFsc2U7CgogICAgICAvLyBTZXQgdGVtcG9yYXJ5IGF0dHJpYnV0ZXMgaWYgYHt3YWl0OiB0cnVlfWAuCiAgICAgIGlmIChhdHRycyAmJiBvcHRpb25zLndhaXQpIHsKICAgICAgICB0aGlzLmF0dHJpYnV0ZXMgPSBfLmV4dGVuZCh7fSwgYXR0cmlidXRlcywgYXR0cnMpOwogICAgICB9CgogICAgICAvLyBBZnRlciBhIHN1Y2Nlc3NmdWwgc2VydmVyLXNpZGUgc2F2ZSwgdGhlIGNsaWVudCBpcyAob3B0aW9uYWxseSkKICAgICAgLy8gdXBkYXRlZCB3aXRoIHRoZSBzZXJ2ZXItc2lkZSBzdGF0ZS4KICAgICAgaWYgKG9wdGlvbnMucGFyc2UgPT09IHZvaWQgMCkgb3B0aW9ucy5wYXJzZSA9IHRydWU7CiAgICAgIHZhciBtb2RlbCA9IHRoaXM7CiAgICAgIHZhciBzdWNjZXNzID0gb3B0aW9ucy5zdWNjZXNzOwogICAgICBvcHRpb25zLnN1Y2Nlc3MgPSBmdW5jdGlvbihyZXNwKSB7CiAgICAgICAgLy8gRW5zdXJlIGF0dHJpYnV0ZXMgYXJlIHJlc3RvcmVkIGR1cmluZyBzeW5jaHJvbm91cyBzYXZlcy4KICAgICAgICBtb2RlbC5hdHRyaWJ1dGVzID0gYXR0cmlidXRlczsKICAgICAgICB2YXIgc2VydmVyQXR0cnMgPSBtb2RlbC5wYXJzZShyZXNwLCBvcHRpb25zKTsKICAgICAgICBpZiAob3B0aW9ucy53YWl0KSBzZXJ2ZXJBdHRycyA9IF8uZXh0ZW5kKGF0dHJzIHx8IHt9LCBzZXJ2ZXJBdHRycyk7CiAgICAgICAgaWYgKF8uaXNPYmplY3Qoc2VydmVyQXR0cnMpICYmICFtb2RlbC5zZXQoc2VydmVyQXR0cnMsIG9wdGlvbnMpKSB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGlmIChzdWNjZXNzKSBzdWNjZXNzKG1vZGVsLCByZXNwLCBvcHRpb25zKTsKICAgICAgICBtb2RlbC50cmlnZ2VyKCdzeW5jJywgbW9kZWwsIHJlc3AsIG9wdGlvbnMpOwogICAgICB9OwogICAgICB3cmFwRXJyb3IodGhpcywgb3B0aW9ucyk7CgogICAgICBtZXRob2QgPSB0aGlzLmlzTmV3KCkgPyAnY3JlYXRlJyA6IChvcHRpb25zLnBhdGNoID8gJ3BhdGNoJyA6ICd1cGRhdGUnKTsKICAgICAgaWYgKG1ldGhvZCA9PT0gJ3BhdGNoJykgb3B0aW9ucy5hdHRycyA9IGF0dHJzOwogICAgICB4aHIgPSB0aGlzLnN5bmMobWV0aG9kLCB0aGlzLCBvcHRpb25zKTsKCiAgICAgIC8vIFJlc3RvcmUgYXR0cmlidXRlcy4KICAgICAgaWYgKGF0dHJzICYmIG9wdGlvbnMud2FpdCkgdGhpcy5hdHRyaWJ1dGVzID0gYXR0cmlidXRlczsKCiAgICAgIHJldHVybiB4aHI7CiAgICB9LAoKICAgIC8vIERlc3Ryb3kgdGhpcyBtb2RlbCBvbiB0aGUgc2VydmVyIGlmIGl0IHdhcyBhbHJlYWR5IHBlcnNpc3RlZC4KICAgIC8vIE9wdGltaXN0aWNhbGx5IHJlbW92ZXMgdGhlIG1vZGVsIGZyb20gaXRzIGNvbGxlY3Rpb24sIGlmIGl0IGhhcyBvbmUuCiAgICAvLyBJZiBgd2FpdDogdHJ1ZWAgaXMgcGFzc2VkLCB3YWl0cyBmb3IgdGhlIHNlcnZlciB0byByZXNwb25kIGJlZm9yZSByZW1vdmFsLgogICAgZGVzdHJveTogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICBvcHRpb25zID0gb3B0aW9ucyA/IF8uY2xvbmUob3B0aW9ucykgOiB7fTsKICAgICAgdmFyIG1vZGVsID0gdGhpczsKICAgICAgdmFyIHN1Y2Nlc3MgPSBvcHRpb25zLnN1Y2Nlc3M7CgogICAgICB2YXIgZGVzdHJveSA9IGZ1bmN0aW9uKCkgewogICAgICAgIG1vZGVsLnRyaWdnZXIoJ2Rlc3Ryb3knLCBtb2RlbCwgbW9kZWwuY29sbGVjdGlvbiwgb3B0aW9ucyk7CiAgICAgIH07CgogICAgICBvcHRpb25zLnN1Y2Nlc3MgPSBmdW5jdGlvbihyZXNwKSB7CiAgICAgICAgaWYgKG9wdGlvbnMud2FpdCB8fCBtb2RlbC5pc05ldygpKSBkZXN0cm95KCk7CiAgICAgICAgaWYgKHN1Y2Nlc3MpIHN1Y2Nlc3MobW9kZWwsIHJlc3AsIG9wdGlvbnMpOwogICAgICAgIGlmICghbW9kZWwuaXNOZXcoKSkgbW9kZWwudHJpZ2dlcignc3luYycsIG1vZGVsLCByZXNwLCBvcHRpb25zKTsKICAgICAgfTsKCiAgICAgIGlmICh0aGlzLmlzTmV3KCkpIHsKICAgICAgICBvcHRpb25zLnN1Y2Nlc3MoKTsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgICAgd3JhcEVycm9yKHRoaXMsIG9wdGlvbnMpOwoKICAgICAgdmFyIHhociA9IHRoaXMuc3luYygnZGVsZXRlJywgdGhpcywgb3B0aW9ucyk7CiAgICAgIGlmICghb3B0aW9ucy53YWl0KSBkZXN0cm95KCk7CiAgICAgIHJldHVybiB4aHI7CiAgICB9LAoKICAgIC8vIERlZmF1bHQgVVJMIGZvciB0aGUgbW9kZWwncyByZXByZXNlbnRhdGlvbiBvbiB0aGUgc2VydmVyIC0tIGlmIHlvdSdyZQogICAgLy8gdXNpbmcgQmFja2JvbmUncyByZXN0ZnVsIG1ldGhvZHMsIG92ZXJyaWRlIHRoaXMgdG8gY2hhbmdlIHRoZSBlbmRwb2ludAogICAgLy8gdGhhdCB3aWxsIGJlIGNhbGxlZC4KICAgIHVybDogZnVuY3Rpb24oKSB7CiAgICAgIHZhciBiYXNlID0gXy5yZXN1bHQodGhpcywgJ3VybFJvb3QnKSB8fCBfLnJlc3VsdCh0aGlzLmNvbGxlY3Rpb24sICd1cmwnKSB8fCB1cmxFcnJvcigpOwogICAgICBpZiAodGhpcy5pc05ldygpKSByZXR1cm4gYmFzZTsKICAgICAgcmV0dXJuIGJhc2UgKyAoYmFzZS5jaGFyQXQoYmFzZS5sZW5ndGggLSAxKSA9PT0gJy8nID8gJycgOiAnLycpICsgZW5jb2RlVVJJQ29tcG9uZW50KHRoaXMuaWQpOwogICAgfSwKCiAgICAvLyAqKnBhcnNlKiogY29udmVydHMgYSByZXNwb25zZSBpbnRvIHRoZSBoYXNoIG9mIGF0dHJpYnV0ZXMgdG8gYmUgYHNldGAgb24KICAgIC8vIHRoZSBtb2RlbC4gVGhlIGRlZmF1bHQgaW1wbGVtZW50YXRpb24gaXMganVzdCB0byBwYXNzIHRoZSByZXNwb25zZSBhbG9uZy4KICAgIHBhcnNlOiBmdW5jdGlvbihyZXNwLCBvcHRpb25zKSB7CiAgICAgIHJldHVybiByZXNwOwogICAgfSwKCiAgICAvLyBDcmVhdGUgYSBuZXcgbW9kZWwgd2l0aCBpZGVudGljYWwgYXR0cmlidXRlcyB0byB0aGlzIG9uZS4KICAgIGNsb25lOiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIG5ldyB0aGlzLmNvbnN0cnVjdG9yKHRoaXMuYXR0cmlidXRlcyk7CiAgICB9LAoKICAgIC8vIEEgbW9kZWwgaXMgbmV3IGlmIGl0IGhhcyBuZXZlciBiZWVuIHNhdmVkIHRvIHRoZSBzZXJ2ZXIsIGFuZCBsYWNrcyBhbiBpZC4KICAgIGlzTmV3OiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHRoaXMuaWQgPT0gbnVsbDsKICAgIH0sCgogICAgLy8gQ2hlY2sgaWYgdGhlIG1vZGVsIGlzIGN1cnJlbnRseSBpbiBhIHZhbGlkIHN0YXRlLgogICAgaXNWYWxpZDogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICByZXR1cm4gdGhpcy5fdmFsaWRhdGUoe30sIF8uZXh0ZW5kKG9wdGlvbnMgfHwge30sIHsgdmFsaWRhdGU6IHRydWUgfSkpOwogICAgfSwKCiAgICAvLyBSdW4gdmFsaWRhdGlvbiBhZ2FpbnN0IHRoZSBuZXh0IGNvbXBsZXRlIHNldCBvZiBtb2RlbCBhdHRyaWJ1dGVzLAogICAgLy8gcmV0dXJuaW5nIGB0cnVlYCBpZiBhbGwgaXMgd2VsbC4gT3RoZXJ3aXNlLCBmaXJlIGFuIGAiaW52YWxpZCJgIGV2ZW50LgogICAgX3ZhbGlkYXRlOiBmdW5jdGlvbihhdHRycywgb3B0aW9ucykgewogICAgICBpZiAoIW9wdGlvbnMudmFsaWRhdGUgfHwgIXRoaXMudmFsaWRhdGUpIHJldHVybiB0cnVlOwogICAgICBhdHRycyA9IF8uZXh0ZW5kKHt9LCB0aGlzLmF0dHJpYnV0ZXMsIGF0dHJzKTsKICAgICAgdmFyIGVycm9yID0gdGhpcy52YWxpZGF0aW9uRXJyb3IgPSB0aGlzLnZhbGlkYXRlKGF0dHJzLCBvcHRpb25zKSB8fCBudWxsOwogICAgICBpZiAoIWVycm9yKSByZXR1cm4gdHJ1ZTsKICAgICAgdGhpcy50cmlnZ2VyKCdpbnZhbGlkJywgdGhpcywgZXJyb3IsIF8uZXh0ZW5kKG9wdGlvbnMgfHwge30sIHt2YWxpZGF0aW9uRXJyb3I6IGVycm9yfSkpOwogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogIH0pOwoKICAvLyBVbmRlcnNjb3JlIG1ldGhvZHMgdGhhdCB3ZSB3YW50IHRvIGltcGxlbWVudCBvbiB0aGUgTW9kZWwuCiAgdmFyIG1vZGVsTWV0aG9kcyA9IFsna2V5cycsICd2YWx1ZXMnLCAncGFpcnMnLCAnaW52ZXJ0JywgJ3BpY2snLCAnb21pdCddOwoKICAvLyBNaXggaW4gZWFjaCBVbmRlcnNjb3JlIG1ldGhvZCBhcyBhIHByb3h5IHRvIGBNb2RlbCNhdHRyaWJ1dGVzYC4KICBfLmVhY2gobW9kZWxNZXRob2RzLCBmdW5jdGlvbihtZXRob2QpIHsKICAgIE1vZGVsLnByb3RvdHlwZVttZXRob2RdID0gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMpOwogICAgICBhcmdzLnVuc2hpZnQodGhpcy5hdHRyaWJ1dGVzKTsKICAgICAgcmV0dXJuIF9bbWV0aG9kXS5hcHBseShfLCBhcmdzKTsKICAgIH07CiAgfSk7CgogIC8vIEJhY2tib25lLkNvbGxlY3Rpb24KICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tCgogIC8vIElmIG1vZGVscyB0ZW5kIHRvIHJlcHJlc2VudCBhIHNpbmdsZSByb3cgb2YgZGF0YSwgYSBCYWNrYm9uZSBDb2xsZWN0aW9uIGlzCiAgLy8gbW9yZSBhbmFsYWdvdXMgdG8gYSB0YWJsZSBmdWxsIG9mIGRhdGEgLi4uIG9yIGEgc21hbGwgc2xpY2Ugb3IgcGFnZSBvZiB0aGF0CiAgLy8gdGFibGUsIG9yIGEgY29sbGVjdGlvbiBvZiByb3dzIHRoYXQgYmVsb25nIHRvZ2V0aGVyIGZvciBhIHBhcnRpY3VsYXIgcmVhc29uCiAgLy8gLS0gYWxsIG9mIHRoZSBtZXNzYWdlcyBpbiB0aGlzIHBhcnRpY3VsYXIgZm9sZGVyLCBhbGwgb2YgdGhlIGRvY3VtZW50cwogIC8vIGJlbG9uZ2luZyB0byB0aGlzIHBhcnRpY3VsYXIgYXV0aG9yLCBhbmQgc28gb24uIENvbGxlY3Rpb25zIG1haW50YWluCiAgLy8gaW5kZXhlcyBvZiB0aGVpciBtb2RlbHMsIGJvdGggaW4gb3JkZXIsIGFuZCBmb3IgbG9va3VwIGJ5IGBpZGAuCgogIC8vIENyZWF0ZSBhIG5ldyAqKkNvbGxlY3Rpb24qKiwgcGVyaGFwcyB0byBjb250YWluIGEgc3BlY2lmaWMgdHlwZSBvZiBgbW9kZWxgLgogIC8vIElmIGEgYGNvbXBhcmF0b3JgIGlzIHNwZWNpZmllZCwgdGhlIENvbGxlY3Rpb24gd2lsbCBtYWludGFpbgogIC8vIGl0cyBtb2RlbHMgaW4gc29ydCBvcmRlciwgYXMgdGhleSdyZSBhZGRlZCBhbmQgcmVtb3ZlZC4KICB2YXIgQ29sbGVjdGlvbiA9IEJhY2tib25lLkNvbGxlY3Rpb24gPSBmdW5jdGlvbihtb2RlbHMsIG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CiAgICBpZiAob3B0aW9ucy51cmwpIHRoaXMudXJsID0gb3B0aW9ucy51cmw7CiAgICBpZiAob3B0aW9ucy5tb2RlbCkgdGhpcy5tb2RlbCA9IG9wdGlvbnMubW9kZWw7CiAgICBpZiAob3B0aW9ucy5jb21wYXJhdG9yICE9PSB2b2lkIDApIHRoaXMuY29tcGFyYXRvciA9IG9wdGlvbnMuY29tcGFyYXRvcjsKICAgIHRoaXMuX3Jlc2V0KCk7CiAgICB0aGlzLmluaXRpYWxpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIGlmIChtb2RlbHMpIHRoaXMucmVzZXQobW9kZWxzLCBfLmV4dGVuZCh7c2lsZW50OiB0cnVlfSwgb3B0aW9ucykpOwogIH07CgogIC8vIERlZmF1bHQgb3B0aW9ucyBmb3IgYENvbGxlY3Rpb24jc2V0YC4KICB2YXIgc2V0T3B0aW9ucyA9IHthZGQ6IHRydWUsIHJlbW92ZTogdHJ1ZSwgbWVyZ2U6IHRydWV9OwogIHZhciBhZGRPcHRpb25zID0ge2FkZDogdHJ1ZSwgbWVyZ2U6IGZhbHNlLCByZW1vdmU6IGZhbHNlfTsKCiAgLy8gRGVmaW5lIHRoZSBDb2xsZWN0aW9uJ3MgaW5oZXJpdGFibGUgbWV0aG9kcy4KICBfLmV4dGVuZChDb2xsZWN0aW9uLnByb3RvdHlwZSwgRXZlbnRzLCB7CgogICAgLy8gVGhlIGRlZmF1bHQgbW9kZWwgZm9yIGEgY29sbGVjdGlvbiBpcyBqdXN0IGEgKipCYWNrYm9uZS5Nb2RlbCoqLgogICAgLy8gVGhpcyBzaG91bGQgYmUgb3ZlcnJpZGRlbiBpbiBtb3N0IGNhc2VzLgogICAgbW9kZWw6IE1vZGVsLAoKICAgIC8vIEluaXRpYWxpemUgaXMgYW4gZW1wdHkgZnVuY3Rpb24gYnkgZGVmYXVsdC4gT3ZlcnJpZGUgaXQgd2l0aCB5b3VyIG93bgogICAgLy8gaW5pdGlhbGl6YXRpb24gbG9naWMuCiAgICBpbml0aWFsaXplOiBmdW5jdGlvbigpe30sCgogICAgLy8gVGhlIEpTT04gcmVwcmVzZW50YXRpb24gb2YgYSBDb2xsZWN0aW9uIGlzIGFuIGFycmF5IG9mIHRoZQogICAgLy8gbW9kZWxzJyBhdHRyaWJ1dGVzLgogICAgdG9KU09OOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIHJldHVybiB0aGlzLm1hcChmdW5jdGlvbihtb2RlbCl7IHJldHVybiBtb2RlbC50b0pTT04ob3B0aW9ucyk7IH0pOwogICAgfSwKCiAgICAvLyBQcm94eSBgQmFja2JvbmUuc3luY2AgYnkgZGVmYXVsdC4KICAgIHN5bmM6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gQmFja2JvbmUuc3luYy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfSwKCiAgICAvLyBBZGQgYSBtb2RlbCwgb3IgbGlzdCBvZiBtb2RlbHMgdG8gdGhlIHNldC4KICAgIGFkZDogZnVuY3Rpb24obW9kZWxzLCBvcHRpb25zKSB7CiAgICAgIHJldHVybiB0aGlzLnNldChtb2RlbHMsIF8uZGVmYXVsdHMob3B0aW9ucyB8fCB7fSwgYWRkT3B0aW9ucykpOwogICAgfSwKCiAgICAvLyBSZW1vdmUgYSBtb2RlbCwgb3IgYSBsaXN0IG9mIG1vZGVscyBmcm9tIHRoZSBzZXQuCiAgICByZW1vdmU6IGZ1bmN0aW9uKG1vZGVscywgb3B0aW9ucykgewogICAgICBtb2RlbHMgPSBfLmlzQXJyYXkobW9kZWxzKSA/IG1vZGVscy5zbGljZSgpIDogW21vZGVsc107CiAgICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CiAgICAgIHZhciBpLCBsLCBpbmRleCwgbW9kZWw7CiAgICAgIGZvciAoaSA9IDAsIGwgPSBtb2RlbHMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgbW9kZWwgPSB0aGlzLmdldChtb2RlbHNbaV0pOwogICAgICAgIGlmICghbW9kZWwpIGNvbnRpbnVlOwogICAgICAgIGRlbGV0ZSB0aGlzLl9ieUlkW21vZGVsLmlkXTsKICAgICAgICBkZWxldGUgdGhpcy5fYnlJZFttb2RlbC5jaWRdOwogICAgICAgIGluZGV4ID0gdGhpcy5pbmRleE9mKG1vZGVsKTsKICAgICAgICB0aGlzLm1vZGVscy5zcGxpY2UoaW5kZXgsIDEpOwogICAgICAgIHRoaXMubGVuZ3RoLS07CiAgICAgICAgaWYgKCFvcHRpb25zLnNpbGVudCkgewogICAgICAgICAgb3B0aW9ucy5pbmRleCA9IGluZGV4OwogICAgICAgICAgbW9kZWwudHJpZ2dlcigncmVtb3ZlJywgbW9kZWwsIHRoaXMsIG9wdGlvbnMpOwogICAgICAgIH0KICAgICAgICB0aGlzLl9yZW1vdmVSZWZlcmVuY2UobW9kZWwpOwogICAgICB9CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBVcGRhdGUgYSBjb2xsZWN0aW9uIGJ5IGBzZXRgLWluZyBhIG5ldyBsaXN0IG9mIG1vZGVscywgYWRkaW5nIG5ldyBvbmVzLAogICAgLy8gcmVtb3ZpbmcgbW9kZWxzIHRoYXQgYXJlIG5vIGxvbmdlciBwcmVzZW50LCBhbmQgbWVyZ2luZyBtb2RlbHMgdGhhdAogICAgLy8gYWxyZWFkeSBleGlzdCBpbiB0aGUgY29sbGVjdGlvbiwgYXMgbmVjZXNzYXJ5LiBTaW1pbGFyIHRvICoqTW9kZWwjc2V0KiosCiAgICAvLyB0aGUgY29yZSBvcGVyYXRpb24gZm9yIHVwZGF0aW5nIHRoZSBkYXRhIGNvbnRhaW5lZCBieSB0aGUgY29sbGVjdGlvbi4KICAgIHNldDogZnVuY3Rpb24obW9kZWxzLCBvcHRpb25zKSB7CiAgICAgIG9wdGlvbnMgPSBfLmRlZmF1bHRzKG9wdGlvbnMgfHwge30sIHNldE9wdGlvbnMpOwogICAgICBpZiAob3B0aW9ucy5wYXJzZSkgbW9kZWxzID0gdGhpcy5wYXJzZShtb2RlbHMsIG9wdGlvbnMpOwogICAgICBpZiAoIV8uaXNBcnJheShtb2RlbHMpKSBtb2RlbHMgPSBtb2RlbHMgPyBbbW9kZWxzXSA6IFtdOwogICAgICB2YXIgaSwgbCwgbW9kZWwsIGF0dHJzLCBleGlzdGluZywgc29ydDsKICAgICAgdmFyIGF0ID0gb3B0aW9ucy5hdDsKICAgICAgdmFyIHNvcnRhYmxlID0gdGhpcy5jb21wYXJhdG9yICYmIChhdCA9PSBudWxsKSAmJiBvcHRpb25zLnNvcnQgIT09IGZhbHNlOwogICAgICB2YXIgc29ydEF0dHIgPSBfLmlzU3RyaW5nKHRoaXMuY29tcGFyYXRvcikgPyB0aGlzLmNvbXBhcmF0b3IgOiBudWxsOwogICAgICB2YXIgdG9BZGQgPSBbXSwgdG9SZW1vdmUgPSBbXSwgbW9kZWxNYXAgPSB7fTsKCiAgICAgIC8vIFR1cm4gYmFyZSBvYmplY3RzIGludG8gbW9kZWwgcmVmZXJlbmNlcywgYW5kIHByZXZlbnQgaW52YWxpZCBtb2RlbHMKICAgICAgLy8gZnJvbSBiZWluZyBhZGRlZC4KICAgICAgZm9yIChpID0gMCwgbCA9IG1vZGVscy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICBpZiAoIShtb2RlbCA9IHRoaXMuX3ByZXBhcmVNb2RlbChtb2RlbHNbaV0sIG9wdGlvbnMpKSkgY29udGludWU7CgogICAgICAgIC8vIElmIGEgZHVwbGljYXRlIGlzIGZvdW5kLCBwcmV2ZW50IGl0IGZyb20gYmVpbmcgYWRkZWQgYW5kCiAgICAgICAgLy8gb3B0aW9uYWxseSBtZXJnZSBpdCBpbnRvIHRoZSBleGlzdGluZyBtb2RlbC4KICAgICAgICBpZiAoZXhpc3RpbmcgPSB0aGlzLmdldChtb2RlbCkpIHsKICAgICAgICAgIGlmIChvcHRpb25zLnJlbW92ZSkgbW9kZWxNYXBbZXhpc3RpbmcuY2lkXSA9IHRydWU7CiAgICAgICAgICBpZiAob3B0aW9ucy5tZXJnZSkgewogICAgICAgICAgICBleGlzdGluZy5zZXQobW9kZWwuYXR0cmlidXRlcywgb3B0aW9ucyk7CiAgICAgICAgICAgIGlmIChzb3J0YWJsZSAmJiAhc29ydCAmJiBleGlzdGluZy5oYXNDaGFuZ2VkKHNvcnRBdHRyKSkgc29ydCA9IHRydWU7CiAgICAgICAgICB9CgogICAgICAgIC8vIFRoaXMgaXMgYSBuZXcgbW9kZWwsIHB1c2ggaXQgdG8gdGhlIGB0b0FkZGAgbGlzdC4KICAgICAgICB9IGVsc2UgaWYgKG9wdGlvbnMuYWRkKSB7CiAgICAgICAgICB0b0FkZC5wdXNoKG1vZGVsKTsKCiAgICAgICAgICAvLyBMaXN0ZW4gdG8gYWRkZWQgbW9kZWxzJyBldmVudHMsIGFuZCBpbmRleCBtb2RlbHMgZm9yIGxvb2t1cCBieQogICAgICAgICAgLy8gYGlkYCBhbmQgYnkgYGNpZGAuCiAgICAgICAgICBtb2RlbC5vbignYWxsJywgdGhpcy5fb25Nb2RlbEV2ZW50LCB0aGlzKTsKICAgICAgICAgIHRoaXMuX2J5SWRbbW9kZWwuY2lkXSA9IG1vZGVsOwogICAgICAgICAgaWYgKG1vZGVsLmlkICE9IG51bGwpIHRoaXMuX2J5SWRbbW9kZWwuaWRdID0gbW9kZWw7CiAgICAgICAgfQogICAgICB9CgogICAgICAvLyBSZW1vdmUgbm9uZXhpc3RlbnQgbW9kZWxzIGlmIGFwcHJvcHJpYXRlLgogICAgICBpZiAob3B0aW9ucy5yZW1vdmUpIHsKICAgICAgICBmb3IgKGkgPSAwLCBsID0gdGhpcy5sZW5ndGg7IGkgPCBsOyArK2kpIHsKICAgICAgICAgIGlmICghbW9kZWxNYXBbKG1vZGVsID0gdGhpcy5tb2RlbHNbaV0pLmNpZF0pIHRvUmVtb3ZlLnB1c2gobW9kZWwpOwogICAgICAgIH0KICAgICAgICBpZiAodG9SZW1vdmUubGVuZ3RoKSB0aGlzLnJlbW92ZSh0b1JlbW92ZSwgb3B0aW9ucyk7CiAgICAgIH0KCiAgICAgIC8vIFNlZSBpZiBzb3J0aW5nIGlzIG5lZWRlZCwgdXBkYXRlIGBsZW5ndGhgIGFuZCBzcGxpY2UgaW4gbmV3IG1vZGVscy4KICAgICAgaWYgKHRvQWRkLmxlbmd0aCkgewogICAgICAgIGlmIChzb3J0YWJsZSkgc29ydCA9IHRydWU7CiAgICAgICAgdGhpcy5sZW5ndGggKz0gdG9BZGQubGVuZ3RoOwogICAgICAgIGlmIChhdCAhPSBudWxsKSB7CiAgICAgICAgICBzcGxpY2UuYXBwbHkodGhpcy5tb2RlbHMsIFthdCwgMF0uY29uY2F0KHRvQWRkKSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHB1c2guYXBwbHkodGhpcy5tb2RlbHMsIHRvQWRkKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIC8vIFNpbGVudGx5IHNvcnQgdGhlIGNvbGxlY3Rpb24gaWYgYXBwcm9wcmlhdGUuCiAgICAgIGlmIChzb3J0KSB0aGlzLnNvcnQoe3NpbGVudDogdHJ1ZX0pOwoKICAgICAgaWYgKG9wdGlvbnMuc2lsZW50KSByZXR1cm4gdGhpczsKCiAgICAgIC8vIFRyaWdnZXIgYGFkZGAgZXZlbnRzLgogICAgICBmb3IgKGkgPSAwLCBsID0gdG9BZGQubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgKG1vZGVsID0gdG9BZGRbaV0pLnRyaWdnZXIoJ2FkZCcsIG1vZGVsLCB0aGlzLCBvcHRpb25zKTsKICAgICAgfQoKICAgICAgLy8gVHJpZ2dlciBgc29ydGAgaWYgdGhlIGNvbGxlY3Rpb24gd2FzIHNvcnRlZC4KICAgICAgaWYgKHNvcnQpIHRoaXMudHJpZ2dlcignc29ydCcsIHRoaXMsIG9wdGlvbnMpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gV2hlbiB5b3UgaGF2ZSBtb3JlIGl0ZW1zIHRoYW4geW91IHdhbnQgdG8gYWRkIG9yIHJlbW92ZSBpbmRpdmlkdWFsbHksCiAgICAvLyB5b3UgY2FuIHJlc2V0IHRoZSBlbnRpcmUgc2V0IHdpdGggYSBuZXcgbGlzdCBvZiBtb2RlbHMsIHdpdGhvdXQgZmlyaW5nCiAgICAvLyBhbnkgZ3JhbnVsYXIgYGFkZGAgb3IgYHJlbW92ZWAgZXZlbnRzLiBGaXJlcyBgcmVzZXRgIHdoZW4gZmluaXNoZWQuCiAgICAvLyBVc2VmdWwgZm9yIGJ1bGsgb3BlcmF0aW9ucyBhbmQgb3B0aW1pemF0aW9ucy4KICAgIHJlc2V0OiBmdW5jdGlvbihtb2RlbHMsIG9wdGlvbnMpIHsKICAgICAgb3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KTsKICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSB0aGlzLm1vZGVscy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICB0aGlzLl9yZW1vdmVSZWZlcmVuY2UodGhpcy5tb2RlbHNbaV0pOwogICAgICB9CiAgICAgIG9wdGlvbnMucHJldmlvdXNNb2RlbHMgPSB0aGlzLm1vZGVsczsKICAgICAgdGhpcy5fcmVzZXQoKTsKICAgICAgdGhpcy5hZGQobW9kZWxzLCBfLmV4dGVuZCh7c2lsZW50OiB0cnVlfSwgb3B0aW9ucykpOwogICAgICBpZiAoIW9wdGlvbnMuc2lsZW50KSB0aGlzLnRyaWdnZXIoJ3Jlc2V0JywgdGhpcywgb3B0aW9ucyk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBBZGQgYSBtb2RlbCB0byB0aGUgZW5kIG9mIHRoZSBjb2xsZWN0aW9uLgogICAgcHVzaDogZnVuY3Rpb24obW9kZWwsIG9wdGlvbnMpIHsKICAgICAgbW9kZWwgPSB0aGlzLl9wcmVwYXJlTW9kZWwobW9kZWwsIG9wdGlvbnMpOwogICAgICB0aGlzLmFkZChtb2RlbCwgXy5leHRlbmQoe2F0OiB0aGlzLmxlbmd0aH0sIG9wdGlvbnMpKTsKICAgICAgcmV0dXJuIG1vZGVsOwogICAgfSwKCiAgICAvLyBSZW1vdmUgYSBtb2RlbCBmcm9tIHRoZSBlbmQgb2YgdGhlIGNvbGxlY3Rpb24uCiAgICBwb3A6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgdmFyIG1vZGVsID0gdGhpcy5hdCh0aGlzLmxlbmd0aCAtIDEpOwogICAgICB0aGlzLnJlbW92ZShtb2RlbCwgb3B0aW9ucyk7CiAgICAgIHJldHVybiBtb2RlbDsKICAgIH0sCgogICAgLy8gQWRkIGEgbW9kZWwgdG8gdGhlIGJlZ2lubmluZyBvZiB0aGUgY29sbGVjdGlvbi4KICAgIHVuc2hpZnQ6IGZ1bmN0aW9uKG1vZGVsLCBvcHRpb25zKSB7CiAgICAgIG1vZGVsID0gdGhpcy5fcHJlcGFyZU1vZGVsKG1vZGVsLCBvcHRpb25zKTsKICAgICAgdGhpcy5hZGQobW9kZWwsIF8uZXh0ZW5kKHthdDogMH0sIG9wdGlvbnMpKTsKICAgICAgcmV0dXJuIG1vZGVsOwogICAgfSwKCiAgICAvLyBSZW1vdmUgYSBtb2RlbCBmcm9tIHRoZSBiZWdpbm5pbmcgb2YgdGhlIGNvbGxlY3Rpb24uCiAgICBzaGlmdDogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICB2YXIgbW9kZWwgPSB0aGlzLmF0KDApOwogICAgICB0aGlzLnJlbW92ZShtb2RlbCwgb3B0aW9ucyk7CiAgICAgIHJldHVybiBtb2RlbDsKICAgIH0sCgogICAgLy8gU2xpY2Ugb3V0IGEgc3ViLWFycmF5IG9mIG1vZGVscyBmcm9tIHRoZSBjb2xsZWN0aW9uLgogICAgc2xpY2U6IGZ1bmN0aW9uKGJlZ2luLCBlbmQpIHsKICAgICAgcmV0dXJuIHRoaXMubW9kZWxzLnNsaWNlKGJlZ2luLCBlbmQpOwogICAgfSwKCiAgICAvLyBHZXQgYSBtb2RlbCBmcm9tIHRoZSBzZXQgYnkgaWQuCiAgICBnZXQ6IGZ1bmN0aW9uKG9iaikgewogICAgICBpZiAob2JqID09IG51bGwpIHJldHVybiB2b2lkIDA7CiAgICAgIHJldHVybiB0aGlzLl9ieUlkW29iai5pZCAhPSBudWxsID8gb2JqLmlkIDogb2JqLmNpZCB8fCBvYmpdOwogICAgfSwKCiAgICAvLyBHZXQgdGhlIG1vZGVsIGF0IHRoZSBnaXZlbiBpbmRleC4KICAgIGF0OiBmdW5jdGlvbihpbmRleCkgewogICAgICByZXR1cm4gdGhpcy5tb2RlbHNbaW5kZXhdOwogICAgfSwKCiAgICAvLyBSZXR1cm4gbW9kZWxzIHdpdGggbWF0Y2hpbmcgYXR0cmlidXRlcy4gVXNlZnVsIGZvciBzaW1wbGUgY2FzZXMgb2YKICAgIC8vIGBmaWx0ZXJgLgogICAgd2hlcmU6IGZ1bmN0aW9uKGF0dHJzLCBmaXJzdCkgewogICAgICBpZiAoXy5pc0VtcHR5KGF0dHJzKSkgcmV0dXJuIGZpcnN0ID8gdm9pZCAwIDogW107CiAgICAgIHJldHVybiB0aGlzW2ZpcnN0ID8gJ2ZpbmQnIDogJ2ZpbHRlciddKGZ1bmN0aW9uKG1vZGVsKSB7CiAgICAgICAgZm9yICh2YXIga2V5IGluIGF0dHJzKSB7CiAgICAgICAgICBpZiAoYXR0cnNba2V5XSAhPT0gbW9kZWwuZ2V0KGtleSkpIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0pOwogICAgfSwKCiAgICAvLyBSZXR1cm4gdGhlIGZpcnN0IG1vZGVsIHdpdGggbWF0Y2hpbmcgYXR0cmlidXRlcy4gVXNlZnVsIGZvciBzaW1wbGUgY2FzZXMKICAgIC8vIG9mIGBmaW5kYC4KICAgIGZpbmRXaGVyZTogZnVuY3Rpb24oYXR0cnMpIHsKICAgICAgcmV0dXJuIHRoaXMud2hlcmUoYXR0cnMsIHRydWUpOwogICAgfSwKCiAgICAvLyBGb3JjZSB0aGUgY29sbGVjdGlvbiB0byByZS1zb3J0IGl0c2VsZi4gWW91IGRvbid0IG5lZWQgdG8gY2FsbCB0aGlzIHVuZGVyCiAgICAvLyBub3JtYWwgY2lyY3Vtc3RhbmNlcywgYXMgdGhlIHNldCB3aWxsIG1haW50YWluIHNvcnQgb3JkZXIgYXMgZWFjaCBpdGVtCiAgICAvLyBpcyBhZGRlZC4KICAgIHNvcnQ6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgaWYgKCF0aGlzLmNvbXBhcmF0b3IpIHRocm93IG5ldyBFcnJvcignQ2Fubm90IHNvcnQgYSBzZXQgd2l0aG91dCBhIGNvbXBhcmF0b3InKTsKICAgICAgb3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KTsKCiAgICAgIC8vIFJ1biBzb3J0IGJhc2VkIG9uIHR5cGUgb2YgYGNvbXBhcmF0b3JgLgogICAgICBpZiAoXy5pc1N0cmluZyh0aGlzLmNvbXBhcmF0b3IpIHx8IHRoaXMuY29tcGFyYXRvci5sZW5ndGggPT09IDEpIHsKICAgICAgICB0aGlzLm1vZGVscyA9IHRoaXMuc29ydEJ5KHRoaXMuY29tcGFyYXRvciwgdGhpcyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5tb2RlbHMuc29ydChfLmJpbmQodGhpcy5jb21wYXJhdG9yLCB0aGlzKSk7CiAgICAgIH0KCiAgICAgIGlmICghb3B0aW9ucy5zaWxlbnQpIHRoaXMudHJpZ2dlcignc29ydCcsIHRoaXMsIG9wdGlvbnMpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gRmlndXJlIG91dCB0aGUgc21hbGxlc3QgaW5kZXggYXQgd2hpY2ggYSBtb2RlbCBzaG91bGQgYmUgaW5zZXJ0ZWQgc28gYXMKICAgIC8vIHRvIG1haW50YWluIG9yZGVyLgogICAgc29ydGVkSW5kZXg6IGZ1bmN0aW9uKG1vZGVsLCB2YWx1ZSwgY29udGV4dCkgewogICAgICB2YWx1ZSB8fCAodmFsdWUgPSB0aGlzLmNvbXBhcmF0b3IpOwogICAgICB2YXIgaXRlcmF0b3IgPSBfLmlzRnVuY3Rpb24odmFsdWUpID8gdmFsdWUgOiBmdW5jdGlvbihtb2RlbCkgewogICAgICAgIHJldHVybiBtb2RlbC5nZXQodmFsdWUpOwogICAgICB9OwogICAgICByZXR1cm4gXy5zb3J0ZWRJbmRleCh0aGlzLm1vZGVscywgbW9kZWwsIGl0ZXJhdG9yLCBjb250ZXh0KTsKICAgIH0sCgogICAgLy8gUGx1Y2sgYW4gYXR0cmlidXRlIGZyb20gZWFjaCBtb2RlbCBpbiB0aGUgY29sbGVjdGlvbi4KICAgIHBsdWNrOiBmdW5jdGlvbihhdHRyKSB7CiAgICAgIHJldHVybiBfLmludm9rZSh0aGlzLm1vZGVscywgJ2dldCcsIGF0dHIpOwogICAgfSwKCiAgICAvLyBGZXRjaCB0aGUgZGVmYXVsdCBzZXQgb2YgbW9kZWxzIGZvciB0aGlzIGNvbGxlY3Rpb24sIHJlc2V0dGluZyB0aGUKICAgIC8vIGNvbGxlY3Rpb24gd2hlbiB0aGV5IGFycml2ZS4gSWYgYHJlc2V0OiB0cnVlYCBpcyBwYXNzZWQsIHRoZSByZXNwb25zZQogICAgLy8gZGF0YSB3aWxsIGJlIHBhc3NlZCB0aHJvdWdoIHRoZSBgcmVzZXRgIG1ldGhvZCBpbnN0ZWFkIG9mIGBzZXRgLgogICAgZmV0Y2g6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgPyBfLmNsb25lKG9wdGlvbnMpIDoge307CiAgICAgIGlmIChvcHRpb25zLnBhcnNlID09PSB2b2lkIDApIG9wdGlvbnMucGFyc2UgPSB0cnVlOwogICAgICB2YXIgc3VjY2VzcyA9IG9wdGlvbnMuc3VjY2VzczsKICAgICAgdmFyIGNvbGxlY3Rpb24gPSB0aGlzOwogICAgICBvcHRpb25zLnN1Y2Nlc3MgPSBmdW5jdGlvbihyZXNwKSB7CiAgICAgICAgdmFyIG1ldGhvZCA9IG9wdGlvbnMucmVzZXQgPyAncmVzZXQnIDogJ3NldCc7CiAgICAgICAgY29sbGVjdGlvblttZXRob2RdKHJlc3AsIG9wdGlvbnMpOwogICAgICAgIGlmIChzdWNjZXNzKSBzdWNjZXNzKGNvbGxlY3Rpb24sIHJlc3AsIG9wdGlvbnMpOwogICAgICAgIGNvbGxlY3Rpb24udHJpZ2dlcignc3luYycsIGNvbGxlY3Rpb24sIHJlc3AsIG9wdGlvbnMpOwogICAgICB9OwogICAgICB3cmFwRXJyb3IodGhpcywgb3B0aW9ucyk7CiAgICAgIHJldHVybiB0aGlzLnN5bmMoJ3JlYWQnLCB0aGlzLCBvcHRpb25zKTsKICAgIH0sCgogICAgLy8gQ3JlYXRlIGEgbmV3IGluc3RhbmNlIG9mIGEgbW9kZWwgaW4gdGhpcyBjb2xsZWN0aW9uLiBBZGQgdGhlIG1vZGVsIHRvIHRoZQogICAgLy8gY29sbGVjdGlvbiBpbW1lZGlhdGVseSwgdW5sZXNzIGB3YWl0OiB0cnVlYCBpcyBwYXNzZWQsIGluIHdoaWNoIGNhc2Ugd2UKICAgIC8vIHdhaXQgZm9yIHRoZSBzZXJ2ZXIgdG8gYWdyZWUuCiAgICBjcmVhdGU6IGZ1bmN0aW9uKG1vZGVsLCBvcHRpb25zKSB7CiAgICAgIG9wdGlvbnMgPSBvcHRpb25zID8gXy5jbG9uZShvcHRpb25zKSA6IHt9OwogICAgICBpZiAoIShtb2RlbCA9IHRoaXMuX3ByZXBhcmVNb2RlbChtb2RlbCwgb3B0aW9ucykpKSByZXR1cm4gZmFsc2U7CiAgICAgIGlmICghb3B0aW9ucy53YWl0KSB0aGlzLmFkZChtb2RlbCwgb3B0aW9ucyk7CiAgICAgIHZhciBjb2xsZWN0aW9uID0gdGhpczsKICAgICAgdmFyIHN1Y2Nlc3MgPSBvcHRpb25zLnN1Y2Nlc3M7CiAgICAgIG9wdGlvbnMuc3VjY2VzcyA9IGZ1bmN0aW9uKHJlc3ApIHsKICAgICAgICBpZiAob3B0aW9ucy53YWl0KSBjb2xsZWN0aW9uLmFkZChtb2RlbCwgb3B0aW9ucyk7CiAgICAgICAgaWYgKHN1Y2Nlc3MpIHN1Y2Nlc3MobW9kZWwsIHJlc3AsIG9wdGlvbnMpOwogICAgICB9OwogICAgICBtb2RlbC5zYXZlKG51bGwsIG9wdGlvbnMpOwogICAgICByZXR1cm4gbW9kZWw7CiAgICB9LAoKICAgIC8vICoqcGFyc2UqKiBjb252ZXJ0cyBhIHJlc3BvbnNlIGludG8gYSBsaXN0IG9mIG1vZGVscyB0byBiZSBhZGRlZCB0byB0aGUKICAgIC8vIGNvbGxlY3Rpb24uIFRoZSBkZWZhdWx0IGltcGxlbWVudGF0aW9uIGlzIGp1c3QgdG8gcGFzcyBpdCB0aHJvdWdoLgogICAgcGFyc2U6IGZ1bmN0aW9uKHJlc3AsIG9wdGlvbnMpIHsKICAgICAgcmV0dXJuIHJlc3A7CiAgICB9LAoKICAgIC8vIENyZWF0ZSBhIG5ldyBjb2xsZWN0aW9uIHdpdGggYW4gaWRlbnRpY2FsIGxpc3Qgb2YgbW9kZWxzIGFzIHRoaXMgb25lLgogICAgY2xvbmU6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gbmV3IHRoaXMuY29uc3RydWN0b3IodGhpcy5tb2RlbHMpOwogICAgfSwKCiAgICAvLyBQcml2YXRlIG1ldGhvZCB0byByZXNldCBhbGwgaW50ZXJuYWwgc3RhdGUuIENhbGxlZCB3aGVuIHRoZSBjb2xsZWN0aW9uCiAgICAvLyBpcyBmaXJzdCBpbml0aWFsaXplZCBvciByZXNldC4KICAgIF9yZXNldDogZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMubGVuZ3RoID0gMDsKICAgICAgdGhpcy5tb2RlbHMgPSBbXTsKICAgICAgdGhpcy5fYnlJZCAgPSB7fTsKICAgIH0sCgogICAgLy8gUHJlcGFyZSBhIGhhc2ggb2YgYXR0cmlidXRlcyAob3Igb3RoZXIgbW9kZWwpIHRvIGJlIGFkZGVkIHRvIHRoaXMKICAgIC8vIGNvbGxlY3Rpb24uCiAgICBfcHJlcGFyZU1vZGVsOiBmdW5jdGlvbihhdHRycywgb3B0aW9ucykgewogICAgICBpZiAoYXR0cnMgaW5zdGFuY2VvZiBNb2RlbCkgewogICAgICAgIGlmICghYXR0cnMuY29sbGVjdGlvbikgYXR0cnMuY29sbGVjdGlvbiA9IHRoaXM7CiAgICAgICAgcmV0dXJuIGF0dHJzOwogICAgICB9CiAgICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CiAgICAgIG9wdGlvbnMuY29sbGVjdGlvbiA9IHRoaXM7CiAgICAgIHZhciBtb2RlbCA9IG5ldyB0aGlzLm1vZGVsKGF0dHJzLCBvcHRpb25zKTsKICAgICAgaWYgKCFtb2RlbC5fdmFsaWRhdGUoYXR0cnMsIG9wdGlvbnMpKSB7CiAgICAgICAgdGhpcy50cmlnZ2VyKCdpbnZhbGlkJywgdGhpcywgYXR0cnMsIG9wdGlvbnMpOwogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICByZXR1cm4gbW9kZWw7CiAgICB9LAoKICAgIC8vIEludGVybmFsIG1ldGhvZCB0byBzZXZlciBhIG1vZGVsJ3MgdGllcyB0byBhIGNvbGxlY3Rpb24uCiAgICBfcmVtb3ZlUmVmZXJlbmNlOiBmdW5jdGlvbihtb2RlbCkgewogICAgICBpZiAodGhpcyA9PT0gbW9kZWwuY29sbGVjdGlvbikgZGVsZXRlIG1vZGVsLmNvbGxlY3Rpb247CiAgICAgIG1vZGVsLm9mZignYWxsJywgdGhpcy5fb25Nb2RlbEV2ZW50LCB0aGlzKTsKICAgIH0sCgogICAgLy8gSW50ZXJuYWwgbWV0aG9kIGNhbGxlZCBldmVyeSB0aW1lIGEgbW9kZWwgaW4gdGhlIHNldCBmaXJlcyBhbiBldmVudC4KICAgIC8vIFNldHMgbmVlZCB0byB1cGRhdGUgdGhlaXIgaW5kZXhlcyB3aGVuIG1vZGVscyBjaGFuZ2UgaWRzLiBBbGwgb3RoZXIKICAgIC8vIGV2ZW50cyBzaW1wbHkgcHJveHkgdGhyb3VnaC4gImFkZCIgYW5kICJyZW1vdmUiIGV2ZW50cyB0aGF0IG9yaWdpbmF0ZQogICAgLy8gaW4gb3RoZXIgY29sbGVjdGlvbnMgYXJlIGlnbm9yZWQuCiAgICBfb25Nb2RlbEV2ZW50OiBmdW5jdGlvbihldmVudCwgbW9kZWwsIGNvbGxlY3Rpb24sIG9wdGlvbnMpIHsKICAgICAgaWYgKChldmVudCA9PT0gJ2FkZCcgfHwgZXZlbnQgPT09ICdyZW1vdmUnKSAmJiBjb2xsZWN0aW9uICE9PSB0aGlzKSByZXR1cm47CiAgICAgIGlmIChldmVudCA9PT0gJ2Rlc3Ryb3knKSB0aGlzLnJlbW92ZShtb2RlbCwgb3B0aW9ucyk7CiAgICAgIGlmIChtb2RlbCAmJiBldmVudCA9PT0gJ2NoYW5nZTonICsgbW9kZWwuaWRBdHRyaWJ1dGUpIHsKICAgICAgICBkZWxldGUgdGhpcy5fYnlJZFttb2RlbC5wcmV2aW91cyhtb2RlbC5pZEF0dHJpYnV0ZSldOwogICAgICAgIGlmIChtb2RlbC5pZCAhPSBudWxsKSB0aGlzLl9ieUlkW21vZGVsLmlkXSA9IG1vZGVsOwogICAgICB9CiAgICAgIHRoaXMudHJpZ2dlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfQoKICB9KTsKCiAgLy8gVW5kZXJzY29yZSBtZXRob2RzIHRoYXQgd2Ugd2FudCB0byBpbXBsZW1lbnQgb24gdGhlIENvbGxlY3Rpb24uCiAgLy8gOTAlIG9mIHRoZSBjb3JlIHVzZWZ1bG5lc3Mgb2YgQmFja2JvbmUgQ29sbGVjdGlvbnMgaXMgYWN0dWFsbHkgaW1wbGVtZW50ZWQKICAvLyByaWdodCBoZXJlOgogIHZhciBtZXRob2RzID0gWydmb3JFYWNoJywgJ2VhY2gnLCAnbWFwJywgJ2NvbGxlY3QnLCAncmVkdWNlJywgJ2ZvbGRsJywKICAgICdpbmplY3QnLCAncmVkdWNlUmlnaHQnLCAnZm9sZHInLCAnZmluZCcsICdkZXRlY3QnLCAnZmlsdGVyJywgJ3NlbGVjdCcsCiAgICAncmVqZWN0JywgJ2V2ZXJ5JywgJ2FsbCcsICdzb21lJywgJ2FueScsICdpbmNsdWRlJywgJ2NvbnRhaW5zJywgJ2ludm9rZScsCiAgICAnbWF4JywgJ21pbicsICd0b0FycmF5JywgJ3NpemUnLCAnZmlyc3QnLCAnaGVhZCcsICd0YWtlJywgJ2luaXRpYWwnLCAncmVzdCcsCiAgICAndGFpbCcsICdkcm9wJywgJ2xhc3QnLCAnd2l0aG91dCcsICdpbmRleE9mJywgJ3NodWZmbGUnLCAnbGFzdEluZGV4T2YnLAogICAgJ2lzRW1wdHknLCAnY2hhaW4nXTsKCiAgLy8gTWl4IGluIGVhY2ggVW5kZXJzY29yZSBtZXRob2QgYXMgYSBwcm94eSB0byBgQ29sbGVjdGlvbiNtb2RlbHNgLgogIF8uZWFjaChtZXRob2RzLCBmdW5jdGlvbihtZXRob2QpIHsKICAgIENvbGxlY3Rpb24ucHJvdG90eXBlW21ldGhvZF0gPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cyk7CiAgICAgIGFyZ3MudW5zaGlmdCh0aGlzLm1vZGVscyk7CiAgICAgIHJldHVybiBfW21ldGhvZF0uYXBwbHkoXywgYXJncyk7CiAgICB9OwogIH0pOwoKICAvLyBVbmRlcnNjb3JlIG1ldGhvZHMgdGhhdCB0YWtlIGEgcHJvcGVydHkgbmFtZSBhcyBhbiBhcmd1bWVudC4KICB2YXIgYXR0cmlidXRlTWV0aG9kcyA9IFsnZ3JvdXBCeScsICdjb3VudEJ5JywgJ3NvcnRCeSddOwoKICAvLyBVc2UgYXR0cmlidXRlcyBpbnN0ZWFkIG9mIHByb3BlcnRpZXMuCiAgXy5lYWNoKGF0dHJpYnV0ZU1ldGhvZHMsIGZ1bmN0aW9uKG1ldGhvZCkgewogICAgQ29sbGVjdGlvbi5wcm90b3R5cGVbbWV0aG9kXSA9IGZ1bmN0aW9uKHZhbHVlLCBjb250ZXh0KSB7CiAgICAgIHZhciBpdGVyYXRvciA9IF8uaXNGdW5jdGlvbih2YWx1ZSkgPyB2YWx1ZSA6IGZ1bmN0aW9uKG1vZGVsKSB7CiAgICAgICAgcmV0dXJuIG1vZGVsLmdldCh2YWx1ZSk7CiAgICAgIH07CiAgICAgIHJldHVybiBfW21ldGhvZF0odGhpcy5tb2RlbHMsIGl0ZXJhdG9yLCBjb250ZXh0KTsKICAgIH07CiAgfSk7CgogIC8vIEJhY2tib25lLlZpZXcKICAvLyAtLS0tLS0tLS0tLS0tCgogIC8vIEJhY2tib25lIFZpZXdzIGFyZSBhbG1vc3QgbW9yZSBjb252ZW50aW9uIHRoYW4gdGhleSBhcmUgYWN0dWFsIGNvZGUuIEEgVmlldwogIC8vIGlzIHNpbXBseSBhIEphdmFTY3JpcHQgb2JqZWN0IHRoYXQgcmVwcmVzZW50cyBhIGxvZ2ljYWwgY2h1bmsgb2YgVUkgaW4gdGhlCiAgLy8gRE9NLiBUaGlzIG1pZ2h0IGJlIGEgc2luZ2xlIGl0ZW0sIGFuIGVudGlyZSBsaXN0LCBhIHNpZGViYXIgb3IgcGFuZWwsIG9yCiAgLy8gZXZlbiB0aGUgc3Vycm91bmRpbmcgZnJhbWUgd2hpY2ggd3JhcHMgeW91ciB3aG9sZSBhcHAuIERlZmluaW5nIGEgY2h1bmsgb2YKICAvLyBVSSBhcyBhICoqVmlldyoqIGFsbG93cyB5b3UgdG8gZGVmaW5lIHlvdXIgRE9NIGV2ZW50cyBkZWNsYXJhdGl2ZWx5LCB3aXRob3V0CiAgLy8gaGF2aW5nIHRvIHdvcnJ5IGFib3V0IHJlbmRlciBvcmRlciAuLi4gYW5kIG1ha2VzIGl0IGVhc3kgZm9yIHRoZSB2aWV3IHRvCiAgLy8gcmVhY3QgdG8gc3BlY2lmaWMgY2hhbmdlcyBpbiB0aGUgc3RhdGUgb2YgeW91ciBtb2RlbHMuCgogIC8vIENyZWF0aW5nIGEgQmFja2JvbmUuVmlldyBjcmVhdGVzIGl0cyBpbml0aWFsIGVsZW1lbnQgb3V0c2lkZSBvZiB0aGUgRE9NLAogIC8vIGlmIGFuIGV4aXN0aW5nIGVsZW1lbnQgaXMgbm90IHByb3ZpZGVkLi4uCiAgdmFyIFZpZXcgPSBCYWNrYm9uZS5WaWV3ID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgdGhpcy5jaWQgPSBfLnVuaXF1ZUlkKCd2aWV3Jyk7CiAgICB0aGlzLl9jb25maWd1cmUob3B0aW9ucyB8fCB7fSk7CiAgICB0aGlzLl9lbnN1cmVFbGVtZW50KCk7CiAgICB0aGlzLmluaXRpYWxpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIHRoaXMuZGVsZWdhdGVFdmVudHMoKTsKICB9OwoKICAvLyBDYWNoZWQgcmVnZXggdG8gc3BsaXQga2V5cyBmb3IgYGRlbGVnYXRlYC4KICB2YXIgZGVsZWdhdGVFdmVudFNwbGl0dGVyID0gL14oXFMrKVxzKiguKikkLzsKCiAgLy8gTGlzdCBvZiB2aWV3IG9wdGlvbnMgdG8gYmUgbWVyZ2VkIGFzIHByb3BlcnRpZXMuCiAgdmFyIHZpZXdPcHRpb25zID0gWydtb2RlbCcsICdjb2xsZWN0aW9uJywgJ2VsJywgJ2lkJywgJ2F0dHJpYnV0ZXMnLCAnY2xhc3NOYW1lJywgJ3RhZ05hbWUnLCAnZXZlbnRzJ107CgogIC8vIFNldCB1cCBhbGwgaW5oZXJpdGFibGUgKipCYWNrYm9uZS5WaWV3KiogcHJvcGVydGllcyBhbmQgbWV0aG9kcy4KICBfLmV4dGVuZChWaWV3LnByb3RvdHlwZSwgRXZlbnRzLCB7CgogICAgLy8gVGhlIGRlZmF1bHQgYHRhZ05hbWVgIG9mIGEgVmlldydzIGVsZW1lbnQgaXMgYCJkaXYiYC4KICAgIHRhZ05hbWU6ICdkaXYnLAoKICAgIC8vIGpRdWVyeSBkZWxlZ2F0ZSBmb3IgZWxlbWVudCBsb29rdXAsIHNjb3BlZCB0byBET00gZWxlbWVudHMgd2l0aGluIHRoZQogICAgLy8gY3VycmVudCB2aWV3LiBUaGlzIHNob3VsZCBiZSBwcmVmZXJlZCB0byBnbG9iYWwgbG9va3VwcyB3aGVyZSBwb3NzaWJsZS4KICAgICQ6IGZ1bmN0aW9uKHNlbGVjdG9yKSB7CiAgICAgIHJldHVybiB0aGlzLiRlbC5maW5kKHNlbGVjdG9yKTsKICAgIH0sCgogICAgLy8gSW5pdGlhbGl6ZSBpcyBhbiBlbXB0eSBmdW5jdGlvbiBieSBkZWZhdWx0LiBPdmVycmlkZSBpdCB3aXRoIHlvdXIgb3duCiAgICAvLyBpbml0aWFsaXphdGlvbiBsb2dpYy4KICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uKCl7fSwKCiAgICAvLyAqKnJlbmRlcioqIGlzIHRoZSBjb3JlIGZ1bmN0aW9uIHRoYXQgeW91ciB2aWV3IHNob3VsZCBvdmVycmlkZSwgaW4gb3JkZXIKICAgIC8vIHRvIHBvcHVsYXRlIGl0cyBlbGVtZW50IChgdGhpcy5lbGApLCB3aXRoIHRoZSBhcHByb3ByaWF0ZSBIVE1MLiBUaGUKICAgIC8vIGNvbnZlbnRpb24gaXMgZm9yICoqcmVuZGVyKiogdG8gYWx3YXlzIHJldHVybiBgdGhpc2AuCiAgICByZW5kZXI6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gUmVtb3ZlIHRoaXMgdmlldyBieSB0YWtpbmcgdGhlIGVsZW1lbnQgb3V0IG9mIHRoZSBET00sIGFuZCByZW1vdmluZyBhbnkKICAgIC8vIGFwcGxpY2FibGUgQmFja2JvbmUuRXZlbnRzIGxpc3RlbmVycy4KICAgIHJlbW92ZTogZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMuJGVsLnJlbW92ZSgpOwogICAgICB0aGlzLnN0b3BMaXN0ZW5pbmcoKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIENoYW5nZSB0aGUgdmlldydzIGVsZW1lbnQgKGB0aGlzLmVsYCBwcm9wZXJ0eSksIGluY2x1ZGluZyBldmVudAogICAgLy8gcmUtZGVsZWdhdGlvbi4KICAgIHNldEVsZW1lbnQ6IGZ1bmN0aW9uKGVsZW1lbnQsIGRlbGVnYXRlKSB7CiAgICAgIGlmICh0aGlzLiRlbCkgdGhpcy51bmRlbGVnYXRlRXZlbnRzKCk7CiAgICAgIHRoaXMuJGVsID0gZWxlbWVudCBpbnN0YW5jZW9mIEJhY2tib25lLiQgPyBlbGVtZW50IDogQmFja2JvbmUuJChlbGVtZW50KTsKICAgICAgdGhpcy5lbCA9IHRoaXMuJGVsWzBdOwogICAgICBpZiAoZGVsZWdhdGUgIT09IGZhbHNlKSB0aGlzLmRlbGVnYXRlRXZlbnRzKCk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBTZXQgY2FsbGJhY2tzLCB3aGVyZSBgdGhpcy5ldmVudHNgIGlzIGEgaGFzaCBvZgogICAgLy8KICAgIC8vICp7ImV2ZW50IHNlbGVjdG9yIjogImNhbGxiYWNrIn0qCiAgICAvLwogICAgLy8gICAgIHsKICAgIC8vICAgICAgICdtb3VzZWRvd24gLnRpdGxlJzogICdlZGl0JywKICAgIC8vICAgICAgICdjbGljayAuYnV0dG9uJzogICAgICdzYXZlJwogICAgLy8gICAgICAgJ2NsaWNrIC5vcGVuJzogICAgICAgZnVuY3Rpb24oZSkgeyAuLi4gfQogICAgLy8gICAgIH0KICAgIC8vCiAgICAvLyBwYWlycy4gQ2FsbGJhY2tzIHdpbGwgYmUgYm91bmQgdG8gdGhlIHZpZXcsIHdpdGggYHRoaXNgIHNldCBwcm9wZXJseS4KICAgIC8vIFVzZXMgZXZlbnQgZGVsZWdhdGlvbiBmb3IgZWZmaWNpZW5jeS4KICAgIC8vIE9taXR0aW5nIHRoZSBzZWxlY3RvciBiaW5kcyB0aGUgZXZlbnQgdG8gYHRoaXMuZWxgLgogICAgLy8gVGhpcyBvbmx5IHdvcmtzIGZvciBkZWxlZ2F0ZS1hYmxlIGV2ZW50czogbm90IGBmb2N1c2AsIGBibHVyYCwgYW5kCiAgICAvLyBub3QgYGNoYW5nZWAsIGBzdWJtaXRgLCBhbmQgYHJlc2V0YCBpbiBJbnRlcm5ldCBFeHBsb3Jlci4KICAgIGRlbGVnYXRlRXZlbnRzOiBmdW5jdGlvbihldmVudHMpIHsKICAgICAgaWYgKCEoZXZlbnRzIHx8IChldmVudHMgPSBfLnJlc3VsdCh0aGlzLCAnZXZlbnRzJykpKSkgcmV0dXJuIHRoaXM7CiAgICAgIHRoaXMudW5kZWxlZ2F0ZUV2ZW50cygpOwogICAgICBmb3IgKHZhciBrZXkgaW4gZXZlbnRzKSB7CiAgICAgICAgdmFyIG1ldGhvZCA9IGV2ZW50c1trZXldOwogICAgICAgIGlmICghXy5pc0Z1bmN0aW9uKG1ldGhvZCkpIG1ldGhvZCA9IHRoaXNbZXZlbnRzW2tleV1dOwogICAgICAgIGlmICghbWV0aG9kKSBjb250aW51ZTsKCiAgICAgICAgdmFyIG1hdGNoID0ga2V5Lm1hdGNoKGRlbGVnYXRlRXZlbnRTcGxpdHRlcik7CiAgICAgICAgdmFyIGV2ZW50TmFtZSA9IG1hdGNoWzFdLCBzZWxlY3RvciA9IG1hdGNoWzJdOwogICAgICAgIG1ldGhvZCA9IF8uYmluZChtZXRob2QsIHRoaXMpOwogICAgICAgIGV2ZW50TmFtZSArPSAnLmRlbGVnYXRlRXZlbnRzJyArIHRoaXMuY2lkOwogICAgICAgIGlmIChzZWxlY3RvciA9PT0gJycpIHsKICAgICAgICAgIHRoaXMuJGVsLm9uKGV2ZW50TmFtZSwgbWV0aG9kKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhpcy4kZWwub24oZXZlbnROYW1lLCBzZWxlY3RvciwgbWV0aG9kKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIENsZWFycyBhbGwgY2FsbGJhY2tzIHByZXZpb3VzbHkgYm91bmQgdG8gdGhlIHZpZXcgd2l0aCBgZGVsZWdhdGVFdmVudHNgLgogICAgLy8gWW91IHVzdWFsbHkgZG9uJ3QgbmVlZCB0byB1c2UgdGhpcywgYnV0IG1heSB3aXNoIHRvIGlmIHlvdSBoYXZlIG11bHRpcGxlCiAgICAvLyBCYWNrYm9uZSB2aWV3cyBhdHRhY2hlZCB0byB0aGUgc2FtZSBET00gZWxlbWVudC4KICAgIHVuZGVsZWdhdGVFdmVudHM6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLiRlbC5vZmYoJy5kZWxlZ2F0ZUV2ZW50cycgKyB0aGlzLmNpZCk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBQZXJmb3JtcyB0aGUgaW5pdGlhbCBjb25maWd1cmF0aW9uIG9mIGEgVmlldyB3aXRoIGEgc2V0IG9mIG9wdGlvbnMuCiAgICAvLyBLZXlzIHdpdGggc3BlY2lhbCBtZWFuaW5nICooZS5nLiBtb2RlbCwgY29sbGVjdGlvbiwgaWQsIGNsYXNzTmFtZSkqIGFyZQogICAgLy8gYXR0YWNoZWQgZGlyZWN0bHkgdG8gdGhlIHZpZXcuICBTZWUgYHZpZXdPcHRpb25zYCBmb3IgYW4gZXhoYXVzdGl2ZQogICAgLy8gbGlzdC4KICAgIF9jb25maWd1cmU6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgaWYgKHRoaXMub3B0aW9ucykgb3B0aW9ucyA9IF8uZXh0ZW5kKHt9LCBfLnJlc3VsdCh0aGlzLCAnb3B0aW9ucycpLCBvcHRpb25zKTsKICAgICAgXy5leHRlbmQodGhpcywgXy5waWNrKG9wdGlvbnMsIHZpZXdPcHRpb25zKSk7CiAgICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnM7CiAgICB9LAoKICAgIC8vIEVuc3VyZSB0aGF0IHRoZSBWaWV3IGhhcyBhIERPTSBlbGVtZW50IHRvIHJlbmRlciBpbnRvLgogICAgLy8gSWYgYHRoaXMuZWxgIGlzIGEgc3RyaW5nLCBwYXNzIGl0IHRocm91Z2ggYCQoKWAsIHRha2UgdGhlIGZpcnN0CiAgICAvLyBtYXRjaGluZyBlbGVtZW50LCBhbmQgcmUtYXNzaWduIGl0IHRvIGBlbGAuIE90aGVyd2lzZSwgY3JlYXRlCiAgICAvLyBhbiBlbGVtZW50IGZyb20gdGhlIGBpZGAsIGBjbGFzc05hbWVgIGFuZCBgdGFnTmFtZWAgcHJvcGVydGllcy4KICAgIF9lbnN1cmVFbGVtZW50OiBmdW5jdGlvbigpIHsKICAgICAgaWYgKCF0aGlzLmVsKSB7CiAgICAgICAgdmFyIGF0dHJzID0gXy5leHRlbmQoe30sIF8ucmVzdWx0KHRoaXMsICdhdHRyaWJ1dGVzJykpOwogICAgICAgIGlmICh0aGlzLmlkKSBhdHRycy5pZCA9IF8ucmVzdWx0KHRoaXMsICdpZCcpOwogICAgICAgIGlmICh0aGlzLmNsYXNzTmFtZSkgYXR0cnNbJ2NsYXNzJ10gPSBfLnJlc3VsdCh0aGlzLCAnY2xhc3NOYW1lJyk7CiAgICAgICAgdmFyICRlbCA9IEJhY2tib25lLiQoJzwnICsgXy5yZXN1bHQodGhpcywgJ3RhZ05hbWUnKSArICc+JykuYXR0cihhdHRycyk7CiAgICAgICAgdGhpcy5zZXRFbGVtZW50KCRlbCwgZmFsc2UpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuc2V0RWxlbWVudChfLnJlc3VsdCh0aGlzLCAnZWwnKSwgZmFsc2UpOwogICAgICB9CiAgICB9CgogIH0pOwoKICAvLyBCYWNrYm9uZS5zeW5jCiAgLy8gLS0tLS0tLS0tLS0tLQoKICAvLyBPdmVycmlkZSB0aGlzIGZ1bmN0aW9uIHRvIGNoYW5nZSB0aGUgbWFubmVyIGluIHdoaWNoIEJhY2tib25lIHBlcnNpc3RzCiAgLy8gbW9kZWxzIHRvIHRoZSBzZXJ2ZXIuIFlvdSB3aWxsIGJlIHBhc3NlZCB0aGUgdHlwZSBvZiByZXF1ZXN0LCBhbmQgdGhlCiAgLy8gbW9kZWwgaW4gcXVlc3Rpb24uIEJ5IGRlZmF1bHQsIG1ha2VzIGEgUkVTVGZ1bCBBamF4IHJlcXVlc3QKICAvLyB0byB0aGUgbW9kZWwncyBgdXJsKClgLiBTb21lIHBvc3NpYmxlIGN1c3RvbWl6YXRpb25zIGNvdWxkIGJlOgogIC8vCiAgLy8gKiBVc2UgYHNldFRpbWVvdXRgIHRvIGJhdGNoIHJhcGlkLWZpcmUgdXBkYXRlcyBpbnRvIGEgc2luZ2xlIHJlcXVlc3QuCiAgLy8gKiBTZW5kIHVwIHRoZSBtb2RlbHMgYXMgWE1MIGluc3RlYWQgb2YgSlNPTi4KICAvLyAqIFBlcnNpc3QgbW9kZWxzIHZpYSBXZWJTb2NrZXRzIGluc3RlYWQgb2YgQWpheC4KICAvLwogIC8vIFR1cm4gb24gYEJhY2tib25lLmVtdWxhdGVIVFRQYCBpbiBvcmRlciB0byBzZW5kIGBQVVRgIGFuZCBgREVMRVRFYCByZXF1ZXN0cwogIC8vIGFzIGBQT1NUYCwgd2l0aCBhIGBfbWV0aG9kYCBwYXJhbWV0ZXIgY29udGFpbmluZyB0aGUgdHJ1ZSBIVFRQIG1ldGhvZCwKICAvLyBhcyB3ZWxsIGFzIGFsbCByZXF1ZXN0cyB3aXRoIHRoZSBib2R5IGFzIGBhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWRgCiAgLy8gaW5zdGVhZCBvZiBgYXBwbGljYXRpb24vanNvbmAgd2l0aCB0aGUgbW9kZWwgaW4gYSBwYXJhbSBuYW1lZCBgbW9kZWxgLgogIC8vIFVzZWZ1bCB3aGVuIGludGVyZmFjaW5nIHdpdGggc2VydmVyLXNpZGUgbGFuZ3VhZ2VzIGxpa2UgKipQSFAqKiB0aGF0IG1ha2UKICAvLyBpdCBkaWZmaWN1bHQgdG8gcmVhZCB0aGUgYm9keSBvZiBgUFVUYCByZXF1ZXN0cy4KICBCYWNrYm9uZS5zeW5jID0gZnVuY3Rpb24obWV0aG9kLCBtb2RlbCwgb3B0aW9ucykgewogICAgdmFyIHR5cGUgPSBtZXRob2RNYXBbbWV0aG9kXTsKCiAgICAvLyBEZWZhdWx0IG9wdGlvbnMsIHVubGVzcyBzcGVjaWZpZWQuCiAgICBfLmRlZmF1bHRzKG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSksIHsKICAgICAgZW11bGF0ZUhUVFA6IEJhY2tib25lLmVtdWxhdGVIVFRQLAogICAgICBlbXVsYXRlSlNPTjogQmFja2JvbmUuZW11bGF0ZUpTT04KICAgIH0pOwoKICAgIC8vIERlZmF1bHQgSlNPTi1yZXF1ZXN0IG9wdGlvbnMuCiAgICB2YXIgcGFyYW1zID0ge3R5cGU6IHR5cGUsIGRhdGFUeXBlOiAnanNvbid9OwoKICAgIC8vIEVuc3VyZSB0aGF0IHdlIGhhdmUgYSBVUkwuCiAgICBpZiAoIW9wdGlvbnMudXJsKSB7CiAgICAgIHBhcmFtcy51cmwgPSBfLnJlc3VsdChtb2RlbCwgJ3VybCcpIHx8IHVybEVycm9yKCk7CiAgICB9CgogICAgLy8gRW5zdXJlIHRoYXQgd2UgaGF2ZSB0aGUgYXBwcm9wcmlhdGUgcmVxdWVzdCBkYXRhLgogICAgaWYgKG9wdGlvbnMuZGF0YSA9PSBudWxsICYmIG1vZGVsICYmIChtZXRob2QgPT09ICdjcmVhdGUnIHx8IG1ldGhvZCA9PT0gJ3VwZGF0ZScgfHwgbWV0aG9kID09PSAncGF0Y2gnKSkgewogICAgICBwYXJhbXMuY29udGVudFR5cGUgPSAnYXBwbGljYXRpb24vanNvbic7CiAgICAgIHBhcmFtcy5kYXRhID0gSlNPTi5zdHJpbmdpZnkob3B0aW9ucy5hdHRycyB8fCBtb2RlbC50b0pTT04ob3B0aW9ucykpOwogICAgfQoKICAgIC8vIEZvciBvbGRlciBzZXJ2ZXJzLCBlbXVsYXRlIEpTT04gYnkgZW5jb2RpbmcgdGhlIHJlcXVlc3QgaW50byBhbiBIVE1MLWZvcm0uCiAgICBpZiAob3B0aW9ucy5lbXVsYXRlSlNPTikgewogICAgICBwYXJhbXMuY29udGVudFR5cGUgPSAnYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkJzsKICAgICAgcGFyYW1zLmRhdGEgPSBwYXJhbXMuZGF0YSA/IHttb2RlbDogcGFyYW1zLmRhdGF9IDoge307CiAgICB9CgogICAgLy8gRm9yIG9sZGVyIHNlcnZlcnMsIGVtdWxhdGUgSFRUUCBieSBtaW1pY2tpbmcgdGhlIEhUVFAgbWV0aG9kIHdpdGggYF9tZXRob2RgCiAgICAvLyBBbmQgYW4gYFgtSFRUUC1NZXRob2QtT3ZlcnJpZGVgIGhlYWRlci4KICAgIGlmIChvcHRpb25zLmVtdWxhdGVIVFRQICYmICh0eXBlID09PSAnUFVUJyB8fCB0eXBlID09PSAnREVMRVRFJyB8fCB0eXBlID09PSAnUEFUQ0gnKSkgewogICAgICBwYXJhbXMudHlwZSA9ICdQT1NUJzsKICAgICAgaWYgKG9wdGlvbnMuZW11bGF0ZUpTT04pIHBhcmFtcy5kYXRhLl9tZXRob2QgPSB0eXBlOwogICAgICB2YXIgYmVmb3JlU2VuZCA9IG9wdGlvbnMuYmVmb3JlU2VuZDsKICAgICAgb3B0aW9ucy5iZWZvcmVTZW5kID0gZnVuY3Rpb24oeGhyKSB7CiAgICAgICAgeGhyLnNldFJlcXVlc3RIZWFkZXIoJ1gtSFRUUC1NZXRob2QtT3ZlcnJpZGUnLCB0eXBlKTsKICAgICAgICBpZiAoYmVmb3JlU2VuZCkgcmV0dXJuIGJlZm9yZVNlbmQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfTsKICAgIH0KCiAgICAvLyBEb24ndCBwcm9jZXNzIGRhdGEgb24gYSBub24tR0VUIHJlcXVlc3QuCiAgICBpZiAocGFyYW1zLnR5cGUgIT09ICdHRVQnICYmICFvcHRpb25zLmVtdWxhdGVKU09OKSB7CiAgICAgIHBhcmFtcy5wcm9jZXNzRGF0YSA9IGZhbHNlOwogICAgfQoKICAgIC8vIElmIHdlJ3JlIHNlbmRpbmcgYSBgUEFUQ0hgIHJlcXVlc3QsIGFuZCB3ZSdyZSBpbiBhbiBvbGQgSW50ZXJuZXQgRXhwbG9yZXIKICAgIC8vIHRoYXQgc3RpbGwgaGFzIEFjdGl2ZVggZW5hYmxlZCBieSBkZWZhdWx0LCBvdmVycmlkZSBqUXVlcnkgdG8gdXNlIHRoYXQKICAgIC8vIGZvciBYSFIgaW5zdGVhZC4gUmVtb3ZlIHRoaXMgbGluZSB3aGVuIGpRdWVyeSBzdXBwb3J0cyBgUEFUQ0hgIG9uIElFOC4KICAgIGlmIChwYXJhbXMudHlwZSA9PT0gJ1BBVENIJyAmJiB3aW5kb3cuQWN0aXZlWE9iamVjdCAmJgogICAgICAgICAgISh3aW5kb3cuZXh0ZXJuYWwgJiYgd2luZG93LmV4dGVybmFsLm1zQWN0aXZlWEZpbHRlcmluZ0VuYWJsZWQpKSB7CiAgICAgIHBhcmFtcy54aHIgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gbmV3IEFjdGl2ZVhPYmplY3QoIk1pY3Jvc29mdC5YTUxIVFRQIik7CiAgICAgIH07CiAgICB9CgogICAgLy8gTWFrZSB0aGUgcmVxdWVzdCwgYWxsb3dpbmcgdGhlIHVzZXIgdG8gb3ZlcnJpZGUgYW55IEFqYXggb3B0aW9ucy4KICAgIHZhciB4aHIgPSBvcHRpb25zLnhociA9IEJhY2tib25lLmFqYXgoXy5leHRlbmQocGFyYW1zLCBvcHRpb25zKSk7CiAgICBtb2RlbC50cmlnZ2VyKCdyZXF1ZXN0JywgbW9kZWwsIHhociwgb3B0aW9ucyk7CiAgICByZXR1cm4geGhyOwogIH07CgogIC8vIE1hcCBmcm9tIENSVUQgdG8gSFRUUCBmb3Igb3VyIGRlZmF1bHQgYEJhY2tib25lLnN5bmNgIGltcGxlbWVudGF0aW9uLgogIHZhciBtZXRob2RNYXAgPSB7CiAgICAnY3JlYXRlJzogJ1BPU1QnLAogICAgJ3VwZGF0ZSc6ICdQVVQnLAogICAgJ3BhdGNoJzogICdQQVRDSCcsCiAgICAnZGVsZXRlJzogJ0RFTEVURScsCiAgICAncmVhZCc6ICAgJ0dFVCcKICB9OwoKICAvLyBTZXQgdGhlIGRlZmF1bHQgaW1wbGVtZW50YXRpb24gb2YgYEJhY2tib25lLmFqYXhgIHRvIHByb3h5IHRocm91Z2ggdG8gYCRgLgogIC8vIE92ZXJyaWRlIHRoaXMgaWYgeW91J2QgbGlrZSB0byB1c2UgYSBkaWZmZXJlbnQgbGlicmFyeS4KICBCYWNrYm9uZS5hamF4ID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gQmFja2JvbmUuJC5hamF4LmFwcGx5KEJhY2tib25lLiQsIGFyZ3VtZW50cyk7CiAgfTsKCiAgLy8gQmFja2JvbmUuUm91dGVyCiAgLy8gLS0tLS0tLS0tLS0tLS0tCgogIC8vIFJvdXRlcnMgbWFwIGZhdXgtVVJMcyB0byBhY3Rpb25zLCBhbmQgZmlyZSBldmVudHMgd2hlbiByb3V0ZXMgYXJlCiAgLy8gbWF0Y2hlZC4gQ3JlYXRpbmcgYSBuZXcgb25lIHNldHMgaXRzIGByb3V0ZXNgIGhhc2gsIGlmIG5vdCBzZXQgc3RhdGljYWxseS4KICB2YXIgUm91dGVyID0gQmFja2JvbmUuUm91dGVyID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgb3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KTsKICAgIGlmIChvcHRpb25zLnJvdXRlcykgdGhpcy5yb3V0ZXMgPSBvcHRpb25zLnJvdXRlczsKICAgIHRoaXMuX2JpbmRSb3V0ZXMoKTsKICAgIHRoaXMuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIH07CgogIC8vIENhY2hlZCByZWd1bGFyIGV4cHJlc3Npb25zIGZvciBtYXRjaGluZyBuYW1lZCBwYXJhbSBwYXJ0cyBhbmQgc3BsYXR0ZWQKICAvLyBwYXJ0cyBvZiByb3V0ZSBzdHJpbmdzLgogIHZhciBvcHRpb25hbFBhcmFtID0gL1woKC4qPylcKS9nOwogIHZhciBuYW1lZFBhcmFtICAgID0gLyhcKFw/KT86XHcrL2c7CiAgdmFyIHNwbGF0UGFyYW0gICAgPSAvXCpcdysvZzsKICB2YXIgZXNjYXBlUmVnRXhwICA9IC9bXC17fVxbXF0rPy4sXFxcXiR8I1xzXS9nOwoKICAvLyBTZXQgdXAgYWxsIGluaGVyaXRhYmxlICoqQmFja2JvbmUuUm91dGVyKiogcHJvcGVydGllcyBhbmQgbWV0aG9kcy4KICBfLmV4dGVuZChSb3V0ZXIucHJvdG90eXBlLCBFdmVudHMsIHsKCiAgICAvLyBJbml0aWFsaXplIGlzIGFuIGVtcHR5IGZ1bmN0aW9uIGJ5IGRlZmF1bHQuIE92ZXJyaWRlIGl0IHdpdGggeW91ciBvd24KICAgIC8vIGluaXRpYWxpemF0aW9uIGxvZ2ljLgogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oKXt9LAoKICAgIC8vIE1hbnVhbGx5IGJpbmQgYSBzaW5nbGUgbmFtZWQgcm91dGUgdG8gYSBjYWxsYmFjay4gRm9yIGV4YW1wbGU6CiAgICAvLwogICAgLy8gICAgIHRoaXMucm91dGUoJ3NlYXJjaC86cXVlcnkvcDpudW0nLCAnc2VhcmNoJywgZnVuY3Rpb24ocXVlcnksIG51bSkgewogICAgLy8gICAgICAgLi4uCiAgICAvLyAgICAgfSk7CiAgICAvLwogICAgcm91dGU6IGZ1bmN0aW9uKHJvdXRlLCBuYW1lLCBjYWxsYmFjaykgewogICAgICBpZiAoIV8uaXNSZWdFeHAocm91dGUpKSByb3V0ZSA9IHRoaXMuX3JvdXRlVG9SZWdFeHAocm91dGUpOwogICAgICBpZiAoXy5pc0Z1bmN0aW9uKG5hbWUpKSB7CiAgICAgICAgY2FsbGJhY2sgPSBuYW1lOwogICAgICAgIG5hbWUgPSAnJzsKICAgICAgfQogICAgICBpZiAoIWNhbGxiYWNrKSBjYWxsYmFjayA9IHRoaXNbbmFtZV07CiAgICAgIHZhciByb3V0ZXIgPSB0aGlzOwogICAgICBCYWNrYm9uZS5oaXN0b3J5LnJvdXRlKHJvdXRlLCBmdW5jdGlvbihmcmFnbWVudCkgewogICAgICAgIHZhciBhcmdzID0gcm91dGVyLl9leHRyYWN0UGFyYW1ldGVycyhyb3V0ZSwgZnJhZ21lbnQpOwogICAgICAgIGNhbGxiYWNrICYmIGNhbGxiYWNrLmFwcGx5KHJvdXRlciwgYXJncyk7CiAgICAgICAgcm91dGVyLnRyaWdnZXIuYXBwbHkocm91dGVyLCBbJ3JvdXRlOicgKyBuYW1lXS5jb25jYXQoYXJncykpOwogICAgICAgIHJvdXRlci50cmlnZ2VyKCdyb3V0ZScsIG5hbWUsIGFyZ3MpOwogICAgICAgIEJhY2tib25lLmhpc3RvcnkudHJpZ2dlcigncm91dGUnLCByb3V0ZXIsIG5hbWUsIGFyZ3MpOwogICAgICB9KTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIFNpbXBsZSBwcm94eSB0byBgQmFja2JvbmUuaGlzdG9yeWAgdG8gc2F2ZSBhIGZyYWdtZW50IGludG8gdGhlIGhpc3RvcnkuCiAgICBuYXZpZ2F0ZTogZnVuY3Rpb24oZnJhZ21lbnQsIG9wdGlvbnMpIHsKICAgICAgQmFja2JvbmUuaGlzdG9yeS5uYXZpZ2F0ZShmcmFnbWVudCwgb3B0aW9ucyk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBCaW5kIGFsbCBkZWZpbmVkIHJvdXRlcyB0byBgQmFja2JvbmUuaGlzdG9yeWAuIFdlIGhhdmUgdG8gcmV2ZXJzZSB0aGUKICAgIC8vIG9yZGVyIG9mIHRoZSByb3V0ZXMgaGVyZSB0byBzdXBwb3J0IGJlaGF2aW9yIHdoZXJlIHRoZSBtb3N0IGdlbmVyYWwKICAgIC8vIHJvdXRlcyBjYW4gYmUgZGVmaW5lZCBhdCB0aGUgYm90dG9tIG9mIHRoZSByb3V0ZSBtYXAuCiAgICBfYmluZFJvdXRlczogZnVuY3Rpb24oKSB7CiAgICAgIGlmICghdGhpcy5yb3V0ZXMpIHJldHVybjsKICAgICAgdGhpcy5yb3V0ZXMgPSBfLnJlc3VsdCh0aGlzLCAncm91dGVzJyk7CiAgICAgIHZhciByb3V0ZSwgcm91dGVzID0gXy5rZXlzKHRoaXMucm91dGVzKTsKICAgICAgd2hpbGUgKChyb3V0ZSA9IHJvdXRlcy5wb3AoKSkgIT0gbnVsbCkgewogICAgICAgIHRoaXMucm91dGUocm91dGUsIHRoaXMucm91dGVzW3JvdXRlXSk7CiAgICAgIH0KICAgIH0sCgogICAgLy8gQ29udmVydCBhIHJvdXRlIHN0cmluZyBpbnRvIGEgcmVndWxhciBleHByZXNzaW9uLCBzdWl0YWJsZSBmb3IgbWF0Y2hpbmcKICAgIC8vIGFnYWluc3QgdGhlIGN1cnJlbnQgbG9jYXRpb24gaGFzaC4KICAgIF9yb3V0ZVRvUmVnRXhwOiBmdW5jdGlvbihyb3V0ZSkgewogICAgICByb3V0ZSA9IHJvdXRlLnJlcGxhY2UoZXNjYXBlUmVnRXhwLCAnXFwkJicpCiAgICAgICAgICAgICAgICAgICAucmVwbGFjZShvcHRpb25hbFBhcmFtLCAnKD86JDEpPycpCiAgICAgICAgICAgICAgICAgICAucmVwbGFjZShuYW1lZFBhcmFtLCBmdW5jdGlvbihtYXRjaCwgb3B0aW9uYWwpewogICAgICAgICAgICAgICAgICAgICByZXR1cm4gb3B0aW9uYWwgPyBtYXRjaCA6ICcoW15cL10rKSc7CiAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgLnJlcGxhY2Uoc3BsYXRQYXJhbSwgJyguKj8pJyk7CiAgICAgIHJldHVybiBuZXcgUmVnRXhwKCdeJyArIHJvdXRlICsgJyQnKTsKICAgIH0sCgogICAgLy8gR2l2ZW4gYSByb3V0ZSwgYW5kIGEgVVJMIGZyYWdtZW50IHRoYXQgaXQgbWF0Y2hlcywgcmV0dXJuIHRoZSBhcnJheSBvZgogICAgLy8gZXh0cmFjdGVkIGRlY29kZWQgcGFyYW1ldGVycy4gRW1wdHkgb3IgdW5tYXRjaGVkIHBhcmFtZXRlcnMgd2lsbCBiZQogICAgLy8gdHJlYXRlZCBhcyBgbnVsbGAgdG8gbm9ybWFsaXplIGNyb3NzLWJyb3dzZXIgYmVoYXZpb3IuCiAgICBfZXh0cmFjdFBhcmFtZXRlcnM6IGZ1bmN0aW9uKHJvdXRlLCBmcmFnbWVudCkgewogICAgICB2YXIgcGFyYW1zID0gcm91dGUuZXhlYyhmcmFnbWVudCkuc2xpY2UoMSk7CiAgICAgIHJldHVybiBfLm1hcChwYXJhbXMsIGZ1bmN0aW9uKHBhcmFtKSB7CiAgICAgICAgcmV0dXJuIHBhcmFtID8gZGVjb2RlVVJJQ29tcG9uZW50KHBhcmFtKSA6IG51bGw7CiAgICAgIH0pOwogICAgfQoKICB9KTsKCiAgLy8gQmFja2JvbmUuSGlzdG9yeQogIC8vIC0tLS0tLS0tLS0tLS0tLS0KCiAgLy8gSGFuZGxlcyBjcm9zcy1icm93c2VyIGhpc3RvcnkgbWFuYWdlbWVudCwgYmFzZWQgb24gZWl0aGVyCiAgLy8gW3B1c2hTdGF0ZV0oaHR0cDovL2RpdmVpbnRvaHRtbDUuaW5mby9oaXN0b3J5Lmh0bWwpIGFuZCByZWFsIFVSTHMsIG9yCiAgLy8gW29uaGFzaGNoYW5nZV0oaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9ET00vd2luZG93Lm9uaGFzaGNoYW5nZSkKICAvLyBhbmQgVVJMIGZyYWdtZW50cy4gSWYgdGhlIGJyb3dzZXIgc3VwcG9ydHMgbmVpdGhlciAob2xkIElFLCBuYXRjaCksCiAgLy8gZmFsbHMgYmFjayB0byBwb2xsaW5nLgogIHZhciBIaXN0b3J5ID0gQmFja2JvbmUuSGlzdG9yeSA9IGZ1bmN0aW9uKCkgewogICAgdGhpcy5oYW5kbGVycyA9IFtdOwogICAgXy5iaW5kQWxsKHRoaXMsICdjaGVja1VybCcpOwoKICAgIC8vIEVuc3VyZSB0aGF0IGBIaXN0b3J5YCBjYW4gYmUgdXNlZCBvdXRzaWRlIG9mIHRoZSBicm93c2VyLgogICAgaWYgKHR5cGVvZiB3aW5kb3cgIT09ICd1bmRlZmluZWQnKSB7CiAgICAgIHRoaXMubG9jYXRpb24gPSB3aW5kb3cubG9jYXRpb247CiAgICAgIHRoaXMuaGlzdG9yeSA9IHdpbmRvdy5oaXN0b3J5OwogICAgfQogIH07CgogIC8vIENhY2hlZCByZWdleCBmb3Igc3RyaXBwaW5nIGEgbGVhZGluZyBoYXNoL3NsYXNoIGFuZCB0cmFpbGluZyBzcGFjZS4KICB2YXIgcm91dGVTdHJpcHBlciA9IC9eWyNcL118XHMrJC9nOwoKICAvLyBDYWNoZWQgcmVnZXggZm9yIHN0cmlwcGluZyBsZWFkaW5nIGFuZCB0cmFpbGluZyBzbGFzaGVzLgogIHZhciByb290U3RyaXBwZXIgPSAvXlwvK3xcLyskL2c7CgogIC8vIENhY2hlZCByZWdleCBmb3IgZGV0ZWN0aW5nIE1TSUUuCiAgdmFyIGlzRXhwbG9yZXIgPSAvbXNpZSBbXHcuXSsvOwoKICAvLyBDYWNoZWQgcmVnZXggZm9yIHJlbW92aW5nIGEgdHJhaWxpbmcgc2xhc2guCiAgdmFyIHRyYWlsaW5nU2xhc2ggPSAvXC8kLzsKCiAgLy8gSGFzIHRoZSBoaXN0b3J5IGhhbmRsaW5nIGFscmVhZHkgYmVlbiBzdGFydGVkPwogIEhpc3Rvcnkuc3RhcnRlZCA9IGZhbHNlOwoKICAvLyBTZXQgdXAgYWxsIGluaGVyaXRhYmxlICoqQmFja2JvbmUuSGlzdG9yeSoqIHByb3BlcnRpZXMgYW5kIG1ldGhvZHMuCiAgXy5leHRlbmQoSGlzdG9yeS5wcm90b3R5cGUsIEV2ZW50cywgewoKICAgIC8vIFRoZSBkZWZhdWx0IGludGVydmFsIHRvIHBvbGwgZm9yIGhhc2ggY2hhbmdlcywgaWYgbmVjZXNzYXJ5LCBpcwogICAgLy8gdHdlbnR5IHRpbWVzIGEgc2Vjb25kLgogICAgaW50ZXJ2YWw6IDUwLAoKICAgIC8vIEdldHMgdGhlIHRydWUgaGFzaCB2YWx1ZS4gQ2Fubm90IHVzZSBsb2NhdGlvbi5oYXNoIGRpcmVjdGx5IGR1ZSB0byBidWcKICAgIC8vIGluIEZpcmVmb3ggd2hlcmUgbG9jYXRpb24uaGFzaCB3aWxsIGFsd2F5cyBiZSBkZWNvZGVkLgogICAgZ2V0SGFzaDogZnVuY3Rpb24od2luZG93KSB7CiAgICAgIHZhciBtYXRjaCA9ICh3aW5kb3cgfHwgdGhpcykubG9jYXRpb24uaHJlZi5tYXRjaCgvIyguKikkLyk7CiAgICAgIHJldHVybiBtYXRjaCA/IG1hdGNoWzFdIDogJyc7CiAgICB9LAoKICAgIC8vIEdldCB0aGUgY3Jvc3MtYnJvd3NlciBub3JtYWxpemVkIFVSTCBmcmFnbWVudCwgZWl0aGVyIGZyb20gdGhlIFVSTCwKICAgIC8vIHRoZSBoYXNoLCBvciB0aGUgb3ZlcnJpZGUuCiAgICBnZXRGcmFnbWVudDogZnVuY3Rpb24oZnJhZ21lbnQsIGZvcmNlUHVzaFN0YXRlKSB7CiAgICAgIGlmIChmcmFnbWVudCA9PSBudWxsKSB7CiAgICAgICAgaWYgKHRoaXMuX2hhc1B1c2hTdGF0ZSB8fCAhdGhpcy5fd2FudHNIYXNoQ2hhbmdlIHx8IGZvcmNlUHVzaFN0YXRlKSB7CiAgICAgICAgICBmcmFnbWVudCA9IHRoaXMubG9jYXRpb24ucGF0aG5hbWU7CiAgICAgICAgICB2YXIgcm9vdCA9IHRoaXMucm9vdC5yZXBsYWNlKHRyYWlsaW5nU2xhc2gsICcnKTsKICAgICAgICAgIGlmICghZnJhZ21lbnQuaW5kZXhPZihyb290KSkgZnJhZ21lbnQgPSBmcmFnbWVudC5zdWJzdHIocm9vdC5sZW5ndGgpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBmcmFnbWVudCA9IHRoaXMuZ2V0SGFzaCgpOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gZnJhZ21lbnQucmVwbGFjZShyb3V0ZVN0cmlwcGVyLCAnJyk7CiAgICB9LAoKICAgIC8vIFN0YXJ0IHRoZSBoYXNoIGNoYW5nZSBoYW5kbGluZywgcmV0dXJuaW5nIGB0cnVlYCBpZiB0aGUgY3VycmVudCBVUkwgbWF0Y2hlcwogICAgLy8gYW4gZXhpc3Rpbmcgcm91dGUsIGFuZCBgZmFsc2VgIG90aGVyd2lzZS4KICAgIHN0YXJ0OiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIGlmIChIaXN0b3J5LnN0YXJ0ZWQpIHRocm93IG5ldyBFcnJvcigiQmFja2JvbmUuaGlzdG9yeSBoYXMgYWxyZWFkeSBiZWVuIHN0YXJ0ZWQiKTsKICAgICAgSGlzdG9yeS5zdGFydGVkID0gdHJ1ZTsKCiAgICAgIC8vIEZpZ3VyZSBvdXQgdGhlIGluaXRpYWwgY29uZmlndXJhdGlvbi4gRG8gd2UgbmVlZCBhbiBpZnJhbWU/CiAgICAgIC8vIElzIHB1c2hTdGF0ZSBkZXNpcmVkIC4uLiBpcyBpdCBhdmFpbGFibGU/CiAgICAgIHRoaXMub3B0aW9ucyAgICAgICAgICA9IF8uZXh0ZW5kKHt9LCB7cm9vdDogJy8nfSwgdGhpcy5vcHRpb25zLCBvcHRpb25zKTsKICAgICAgdGhpcy5yb290ICAgICAgICAgICAgID0gdGhpcy5vcHRpb25zLnJvb3Q7CiAgICAgIHRoaXMuX3dhbnRzSGFzaENoYW5nZSA9IHRoaXMub3B0aW9ucy5oYXNoQ2hhbmdlICE9PSBmYWxzZTsKICAgICAgdGhpcy5fd2FudHNQdXNoU3RhdGUgID0gISF0aGlzLm9wdGlvbnMucHVzaFN0YXRlOwogICAgICB0aGlzLl9oYXNQdXNoU3RhdGUgICAgPSAhISh0aGlzLm9wdGlvbnMucHVzaFN0YXRlICYmIHRoaXMuaGlzdG9yeSAmJiB0aGlzLmhpc3RvcnkucHVzaFN0YXRlKTsKICAgICAgdmFyIGZyYWdtZW50ICAgICAgICAgID0gdGhpcy5nZXRGcmFnbWVudCgpOwogICAgICB2YXIgZG9jTW9kZSAgICAgICAgICAgPSBkb2N1bWVudC5kb2N1bWVudE1vZGU7CiAgICAgIHZhciBvbGRJRSAgICAgICAgICAgICA9IChpc0V4cGxvcmVyLmV4ZWMobmF2aWdhdG9yLnVzZXJBZ2VudC50b0xvd2VyQ2FzZSgpKSAmJiAoIWRvY01vZGUgfHwgZG9jTW9kZSA8PSA3KSk7CgogICAgICAvLyBOb3JtYWxpemUgcm9vdCB0byBhbHdheXMgaW5jbHVkZSBhIGxlYWRpbmcgYW5kIHRyYWlsaW5nIHNsYXNoLgogICAgICB0aGlzLnJvb3QgPSAoJy8nICsgdGhpcy5yb290ICsgJy8nKS5yZXBsYWNlKHJvb3RTdHJpcHBlciwgJy8nKTsKCiAgICAgIGlmIChvbGRJRSAmJiB0aGlzLl93YW50c0hhc2hDaGFuZ2UpIHsKICAgICAgICB0aGlzLmlmcmFtZSA9IEJhY2tib25lLiQoJzxpZnJhbWUgc3JjPSJqYXZhc2NyaXB0OjAiIHRhYmluZGV4PSItMSIgLz4nKS5oaWRlKCkuYXBwZW5kVG8oJ2JvZHknKVswXS5jb250ZW50V2luZG93OwogICAgICAgIHRoaXMubmF2aWdhdGUoZnJhZ21lbnQpOwogICAgICB9CgogICAgICAvLyBEZXBlbmRpbmcgb24gd2hldGhlciB3ZSdyZSB1c2luZyBwdXNoU3RhdGUgb3IgaGFzaGVzLCBhbmQgd2hldGhlcgogICAgICAvLyAnb25oYXNoY2hhbmdlJyBpcyBzdXBwb3J0ZWQsIGRldGVybWluZSBob3cgd2UgY2hlY2sgdGhlIFVSTCBzdGF0ZS4KICAgICAgaWYgKHRoaXMuX2hhc1B1c2hTdGF0ZSkgewogICAgICAgIEJhY2tib25lLiQod2luZG93KS5vbigncG9wc3RhdGUnLCB0aGlzLmNoZWNrVXJsKTsKICAgICAgfSBlbHNlIGlmICh0aGlzLl93YW50c0hhc2hDaGFuZ2UgJiYgKCdvbmhhc2hjaGFuZ2UnIGluIHdpbmRvdykgJiYgIW9sZElFKSB7CiAgICAgICAgQmFja2JvbmUuJCh3aW5kb3cpLm9uKCdoYXNoY2hhbmdlJywgdGhpcy5jaGVja1VybCk7CiAgICAgIH0gZWxzZSBpZiAodGhpcy5fd2FudHNIYXNoQ2hhbmdlKSB7CiAgICAgICAgdGhpcy5fY2hlY2tVcmxJbnRlcnZhbCA9IHNldEludGVydmFsKHRoaXMuY2hlY2tVcmwsIHRoaXMuaW50ZXJ2YWwpOwogICAgICB9CgogICAgICAvLyBEZXRlcm1pbmUgaWYgd2UgbmVlZCB0byBjaGFuZ2UgdGhlIGJhc2UgdXJsLCBmb3IgYSBwdXNoU3RhdGUgbGluawogICAgICAvLyBvcGVuZWQgYnkgYSBub24tcHVzaFN0YXRlIGJyb3dzZXIuCiAgICAgIHRoaXMuZnJhZ21lbnQgPSBmcmFnbWVudDsKICAgICAgdmFyIGxvYyA9IHRoaXMubG9jYXRpb247CiAgICAgIHZhciBhdFJvb3QgPSBsb2MucGF0aG5hbWUucmVwbGFjZSgvW15cL10kLywgJyQmLycpID09PSB0aGlzLnJvb3Q7CgogICAgICAvLyBJZiB3ZSd2ZSBzdGFydGVkIG9mZiB3aXRoIGEgcm91dGUgZnJvbSBhIGBwdXNoU3RhdGVgLWVuYWJsZWQgYnJvd3NlciwKICAgICAgLy8gYnV0IHdlJ3JlIGN1cnJlbnRseSBpbiBhIGJyb3dzZXIgdGhhdCBkb2Vzbid0IHN1cHBvcnQgaXQuLi4KICAgICAgaWYgKHRoaXMuX3dhbnRzSGFzaENoYW5nZSAmJiB0aGlzLl93YW50c1B1c2hTdGF0ZSAmJiAhdGhpcy5faGFzUHVzaFN0YXRlICYmICFhdFJvb3QpIHsKICAgICAgICB0aGlzLmZyYWdtZW50ID0gdGhpcy5nZXRGcmFnbWVudChudWxsLCB0cnVlKTsKICAgICAgICB0aGlzLmxvY2F0aW9uLnJlcGxhY2UodGhpcy5yb290ICsgdGhpcy5sb2NhdGlvbi5zZWFyY2ggKyAnIycgKyB0aGlzLmZyYWdtZW50KTsKICAgICAgICAvLyBSZXR1cm4gaW1tZWRpYXRlbHkgYXMgYnJvd3NlciB3aWxsIGRvIHJlZGlyZWN0IHRvIG5ldyB1cmwKICAgICAgICByZXR1cm4gdHJ1ZTsKCiAgICAgIC8vIE9yIGlmIHdlJ3ZlIHN0YXJ0ZWQgb3V0IHdpdGggYSBoYXNoLWJhc2VkIHJvdXRlLCBidXQgd2UncmUgY3VycmVudGx5CiAgICAgIC8vIGluIGEgYnJvd3NlciB3aGVyZSBpdCBjb3VsZCBiZSBgcHVzaFN0YXRlYC1iYXNlZCBpbnN0ZWFkLi4uCiAgICAgIH0gZWxzZSBpZiAodGhpcy5fd2FudHNQdXNoU3RhdGUgJiYgdGhpcy5faGFzUHVzaFN0YXRlICYmIGF0Um9vdCAmJiBsb2MuaGFzaCkgewogICAgICAgIHRoaXMuZnJhZ21lbnQgPSB0aGlzLmdldEhhc2goKS5yZXBsYWNlKHJvdXRlU3RyaXBwZXIsICcnKTsKICAgICAgICB0aGlzLmhpc3RvcnkucmVwbGFjZVN0YXRlKHt9LCBkb2N1bWVudC50aXRsZSwgdGhpcy5yb290ICsgdGhpcy5mcmFnbWVudCArIGxvYy5zZWFyY2gpOwogICAgICB9CgogICAgICBpZiAoIXRoaXMub3B0aW9ucy5zaWxlbnQpIHJldHVybiB0aGlzLmxvYWRVcmwoKTsKICAgIH0sCgogICAgLy8gRGlzYWJsZSBCYWNrYm9uZS5oaXN0b3J5LCBwZXJoYXBzIHRlbXBvcmFyaWx5LiBOb3QgdXNlZnVsIGluIGEgcmVhbCBhcHAsCiAgICAvLyBidXQgcG9zc2libHkgdXNlZnVsIGZvciB1bml0IHRlc3RpbmcgUm91dGVycy4KICAgIHN0b3A6IGZ1bmN0aW9uKCkgewogICAgICBCYWNrYm9uZS4kKHdpbmRvdykub2ZmKCdwb3BzdGF0ZScsIHRoaXMuY2hlY2tVcmwpLm9mZignaGFzaGNoYW5nZScsIHRoaXMuY2hlY2tVcmwpOwogICAgICBjbGVhckludGVydmFsKHRoaXMuX2NoZWNrVXJsSW50ZXJ2YWwpOwogICAgICBIaXN0b3J5LnN0YXJ0ZWQgPSBmYWxzZTsKICAgIH0sCgogICAgLy8gQWRkIGEgcm91dGUgdG8gYmUgdGVzdGVkIHdoZW4gdGhlIGZyYWdtZW50IGNoYW5nZXMuIFJvdXRlcyBhZGRlZCBsYXRlcgogICAgLy8gbWF5IG92ZXJyaWRlIHByZXZpb3VzIHJvdXRlcy4KICAgIHJvdXRlOiBmdW5jdGlvbihyb3V0ZSwgY2FsbGJhY2spIHsKICAgICAgdGhpcy5oYW5kbGVycy51bnNoaWZ0KHtyb3V0ZTogcm91dGUsIGNhbGxiYWNrOiBjYWxsYmFja30pOwogICAgfSwKCiAgICAvLyBDaGVja3MgdGhlIGN1cnJlbnQgVVJMIHRvIHNlZSBpZiBpdCBoYXMgY2hhbmdlZCwgYW5kIGlmIGl0IGhhcywKICAgIC8vIGNhbGxzIGBsb2FkVXJsYCwgbm9ybWFsaXppbmcgYWNyb3NzIHRoZSBoaWRkZW4gaWZyYW1lLgogICAgY2hlY2tVcmw6IGZ1bmN0aW9uKGUpIHsKICAgICAgdmFyIGN1cnJlbnQgPSB0aGlzLmdldEZyYWdtZW50KCk7CiAgICAgIGlmIChjdXJyZW50ID09PSB0aGlzLmZyYWdtZW50ICYmIHRoaXMuaWZyYW1lKSB7CiAgICAgICAgY3VycmVudCA9IHRoaXMuZ2V0RnJhZ21lbnQodGhpcy5nZXRIYXNoKHRoaXMuaWZyYW1lKSk7CiAgICAgIH0KICAgICAgaWYgKGN1cnJlbnQgPT09IHRoaXMuZnJhZ21lbnQpIHJldHVybiBmYWxzZTsKICAgICAgaWYgKHRoaXMuaWZyYW1lKSB0aGlzLm5hdmlnYXRlKGN1cnJlbnQpOwogICAgICB0aGlzLmxvYWRVcmwoKSB8fCB0aGlzLmxvYWRVcmwodGhpcy5nZXRIYXNoKCkpOwogICAgfSwKCiAgICAvLyBBdHRlbXB0IHRvIGxvYWQgdGhlIGN1cnJlbnQgVVJMIGZyYWdtZW50LiBJZiBhIHJvdXRlIHN1Y2NlZWRzIHdpdGggYQogICAgLy8gbWF0Y2gsIHJldHVybnMgYHRydWVgLiBJZiBubyBkZWZpbmVkIHJvdXRlcyBtYXRjaGVzIHRoZSBmcmFnbWVudCwKICAgIC8vIHJldHVybnMgYGZhbHNlYC4KICAgIGxvYWRVcmw6IGZ1bmN0aW9uKGZyYWdtZW50T3ZlcnJpZGUpIHsKICAgICAgdmFyIGZyYWdtZW50ID0gdGhpcy5mcmFnbWVudCA9IHRoaXMuZ2V0RnJhZ21lbnQoZnJhZ21lbnRPdmVycmlkZSk7CiAgICAgIHZhciBtYXRjaGVkID0gXy5hbnkodGhpcy5oYW5kbGVycywgZnVuY3Rpb24oaGFuZGxlcikgewogICAgICAgIGlmIChoYW5kbGVyLnJvdXRlLnRlc3QoZnJhZ21lbnQpKSB7CiAgICAgICAgICBoYW5kbGVyLmNhbGxiYWNrKGZyYWdtZW50KTsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIHJldHVybiBtYXRjaGVkOwogICAgfSwKCiAgICAvLyBTYXZlIGEgZnJhZ21lbnQgaW50byB0aGUgaGFzaCBoaXN0b3J5LCBvciByZXBsYWNlIHRoZSBVUkwgc3RhdGUgaWYgdGhlCiAgICAvLyAncmVwbGFjZScgb3B0aW9uIGlzIHBhc3NlZC4gWW91IGFyZSByZXNwb25zaWJsZSBmb3IgcHJvcGVybHkgVVJMLWVuY29kaW5nCiAgICAvLyB0aGUgZnJhZ21lbnQgaW4gYWR2YW5jZS4KICAgIC8vCiAgICAvLyBUaGUgb3B0aW9ucyBvYmplY3QgY2FuIGNvbnRhaW4gYHRyaWdnZXI6IHRydWVgIGlmIHlvdSB3aXNoIHRvIGhhdmUgdGhlCiAgICAvLyByb3V0ZSBjYWxsYmFjayBiZSBmaXJlZCAobm90IHVzdWFsbHkgZGVzaXJhYmxlKSwgb3IgYHJlcGxhY2U6IHRydWVgLCBpZgogICAgLy8geW91IHdpc2ggdG8gbW9kaWZ5IHRoZSBjdXJyZW50IFVSTCB3aXRob3V0IGFkZGluZyBhbiBlbnRyeSB0byB0aGUgaGlzdG9yeS4KICAgIG5hdmlnYXRlOiBmdW5jdGlvbihmcmFnbWVudCwgb3B0aW9ucykgewogICAgICBpZiAoIUhpc3Rvcnkuc3RhcnRlZCkgcmV0dXJuIGZhbHNlOwogICAgICBpZiAoIW9wdGlvbnMgfHwgb3B0aW9ucyA9PT0gdHJ1ZSkgb3B0aW9ucyA9IHt0cmlnZ2VyOiBvcHRpb25zfTsKICAgICAgZnJhZ21lbnQgPSB0aGlzLmdldEZyYWdtZW50KGZyYWdtZW50IHx8ICcnKTsKICAgICAgaWYgKHRoaXMuZnJhZ21lbnQgPT09IGZyYWdtZW50KSByZXR1cm47CiAgICAgIHRoaXMuZnJhZ21lbnQgPSBmcmFnbWVudDsKICAgICAgdmFyIHVybCA9IHRoaXMucm9vdCArIGZyYWdtZW50OwoKICAgICAgLy8gSWYgcHVzaFN0YXRlIGlzIGF2YWlsYWJsZSwgd2UgdXNlIGl0IHRvIHNldCB0aGUgZnJhZ21lbnQgYXMgYSByZWFsIFVSTC4KICAgICAgaWYgKHRoaXMuX2hhc1B1c2hTdGF0ZSkgewogICAgICAgIHRoaXMuaGlzdG9yeVtvcHRpb25zLnJlcGxhY2UgPyAncmVwbGFjZVN0YXRlJyA6ICdwdXNoU3RhdGUnXSh7fSwgZG9jdW1lbnQudGl0bGUsIHVybCk7CgogICAgICAvLyBJZiBoYXNoIGNoYW5nZXMgaGF2ZW4ndCBiZWVuIGV4cGxpY2l0bHkgZGlzYWJsZWQsIHVwZGF0ZSB0aGUgaGFzaAogICAgICAvLyBmcmFnbWVudCB0byBzdG9yZSBoaXN0b3J5LgogICAgICB9IGVsc2UgaWYgKHRoaXMuX3dhbnRzSGFzaENoYW5nZSkgewogICAgICAgIHRoaXMuX3VwZGF0ZUhhc2godGhpcy5sb2NhdGlvbiwgZnJhZ21lbnQsIG9wdGlvbnMucmVwbGFjZSk7CiAgICAgICAgaWYgKHRoaXMuaWZyYW1lICYmIChmcmFnbWVudCAhPT0gdGhpcy5nZXRGcmFnbWVudCh0aGlzLmdldEhhc2godGhpcy5pZnJhbWUpKSkpIHsKICAgICAgICAgIC8vIE9wZW5pbmcgYW5kIGNsb3NpbmcgdGhlIGlmcmFtZSB0cmlja3MgSUU3IGFuZCBlYXJsaWVyIHRvIHB1c2ggYQogICAgICAgICAgLy8gaGlzdG9yeSBlbnRyeSBvbiBoYXNoLXRhZyBjaGFuZ2UuICBXaGVuIHJlcGxhY2UgaXMgdHJ1ZSwgd2UgZG9uJ3QKICAgICAgICAgIC8vIHdhbnQgdGhpcy4KICAgICAgICAgIGlmKCFvcHRpb25zLnJlcGxhY2UpIHRoaXMuaWZyYW1lLmRvY3VtZW50Lm9wZW4oKS5jbG9zZSgpOwogICAgICAgICAgdGhpcy5fdXBkYXRlSGFzaCh0aGlzLmlmcmFtZS5sb2NhdGlvbiwgZnJhZ21lbnQsIG9wdGlvbnMucmVwbGFjZSk7CiAgICAgICAgfQoKICAgICAgLy8gSWYgeW91J3ZlIHRvbGQgdXMgdGhhdCB5b3UgZXhwbGljaXRseSBkb24ndCB3YW50IGZhbGxiYWNrIGhhc2hjaGFuZ2UtCiAgICAgIC8vIGJhc2VkIGhpc3RvcnksIHRoZW4gYG5hdmlnYXRlYCBiZWNvbWVzIGEgcGFnZSByZWZyZXNoLgogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiB0aGlzLmxvY2F0aW9uLmFzc2lnbih1cmwpOwogICAgICB9CiAgICAgIGlmIChvcHRpb25zLnRyaWdnZXIpIHRoaXMubG9hZFVybChmcmFnbWVudCk7CiAgICB9LAoKICAgIC8vIFVwZGF0ZSB0aGUgaGFzaCBsb2NhdGlvbiwgZWl0aGVyIHJlcGxhY2luZyB0aGUgY3VycmVudCBlbnRyeSwgb3IgYWRkaW5nCiAgICAvLyBhIG5ldyBvbmUgdG8gdGhlIGJyb3dzZXIgaGlzdG9yeS4KICAgIF91cGRhdGVIYXNoOiBmdW5jdGlvbihsb2NhdGlvbiwgZnJhZ21lbnQsIHJlcGxhY2UpIHsKICAgICAgaWYgKHJlcGxhY2UpIHsKICAgICAgICB2YXIgaHJlZiA9IGxvY2F0aW9uLmhyZWYucmVwbGFjZSgvKGphdmFzY3JpcHQ6fCMpLiokLywgJycpOwogICAgICAgIGxvY2F0aW9uLnJlcGxhY2UoaHJlZiArICcjJyArIGZyYWdtZW50KTsKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBTb21lIGJyb3dzZXJzIHJlcXVpcmUgdGhhdCBgaGFzaGAgY29udGFpbnMgYSBsZWFkaW5nICMuCiAgICAgICAgbG9jYXRpb24uaGFzaCA9ICcjJyArIGZyYWdtZW50OwogICAgICB9CiAgICB9CgogIH0pOwoKICAvLyBDcmVhdGUgdGhlIGRlZmF1bHQgQmFja2JvbmUuaGlzdG9yeS4KICBCYWNrYm9uZS5oaXN0b3J5ID0gbmV3IEhpc3Rvcnk7CgogIC8vIEhlbHBlcnMKICAvLyAtLS0tLS0tCgogIC8vIEhlbHBlciBmdW5jdGlvbiB0byBjb3JyZWN0bHkgc2V0IHVwIHRoZSBwcm90b3R5cGUgY2hhaW4sIGZvciBzdWJjbGFzc2VzLgogIC8vIFNpbWlsYXIgdG8gYGdvb2cuaW5oZXJpdHNgLCBidXQgdXNlcyBhIGhhc2ggb2YgcHJvdG90eXBlIHByb3BlcnRpZXMgYW5kCiAgLy8gY2xhc3MgcHJvcGVydGllcyB0byBiZSBleHRlbmRlZC4KICB2YXIgZXh0ZW5kID0gZnVuY3Rpb24ocHJvdG9Qcm9wcywgc3RhdGljUHJvcHMpIHsKICAgIHZhciBwYXJlbnQgPSB0aGlzOwogICAgdmFyIGNoaWxkOwoKICAgIC8vIFRoZSBjb25zdHJ1Y3RvciBmdW5jdGlvbiBmb3IgdGhlIG5ldyBzdWJjbGFzcyBpcyBlaXRoZXIgZGVmaW5lZCBieSB5b3UKICAgIC8vICh0aGUgImNvbnN0cnVjdG9yIiBwcm9wZXJ0eSBpbiB5b3VyIGBleHRlbmRgIGRlZmluaXRpb24pLCBvciBkZWZhdWx0ZWQKICAgIC8vIGJ5IHVzIHRvIHNpbXBseSBjYWxsIHRoZSBwYXJlbnQncyBjb25zdHJ1Y3Rvci4KICAgIGlmIChwcm90b1Byb3BzICYmIF8uaGFzKHByb3RvUHJvcHMsICdjb25zdHJ1Y3RvcicpKSB7CiAgICAgIGNoaWxkID0gcHJvdG9Qcm9wcy5jb25zdHJ1Y3RvcjsKICAgIH0gZWxzZSB7CiAgICAgIGNoaWxkID0gZnVuY3Rpb24oKXsgcmV0dXJuIHBhcmVudC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOyB9OwogICAgfQoKICAgIC8vIEFkZCBzdGF0aWMgcHJvcGVydGllcyB0byB0aGUgY29uc3RydWN0b3IgZnVuY3Rpb24sIGlmIHN1cHBsaWVkLgogICAgXy5leHRlbmQoY2hpbGQsIHBhcmVudCwgc3RhdGljUHJvcHMpOwoKICAgIC8vIFNldCB0aGUgcHJvdG90eXBlIGNoYWluIHRvIGluaGVyaXQgZnJvbSBgcGFyZW50YCwgd2l0aG91dCBjYWxsaW5nCiAgICAvLyBgcGFyZW50YCdzIGNvbnN0cnVjdG9yIGZ1bmN0aW9uLgogICAgdmFyIFN1cnJvZ2F0ZSA9IGZ1bmN0aW9uKCl7IHRoaXMuY29uc3RydWN0b3IgPSBjaGlsZDsgfTsKICAgIFN1cnJvZ2F0ZS5wcm90b3R5cGUgPSBwYXJlbnQucHJvdG90eXBlOwogICAgY2hpbGQucHJvdG90eXBlID0gbmV3IFN1cnJvZ2F0ZTsKCiAgICAvLyBBZGQgcHJvdG90eXBlIHByb3BlcnRpZXMgKGluc3RhbmNlIHByb3BlcnRpZXMpIHRvIHRoZSBzdWJjbGFzcywKICAgIC8vIGlmIHN1cHBsaWVkLgogICAgaWYgKHByb3RvUHJvcHMpIF8uZXh0ZW5kKGNoaWxkLnByb3RvdHlwZSwgcHJvdG9Qcm9wcyk7CgogICAgLy8gU2V0IGEgY29udmVuaWVuY2UgcHJvcGVydHkgaW4gY2FzZSB0aGUgcGFyZW50J3MgcHJvdG90eXBlIGlzIG5lZWRlZAogICAgLy8gbGF0ZXIuCiAgICBjaGlsZC5fX3N1cGVyX18gPSBwYXJlbnQucHJvdG90eXBlOwoKICAgIHJldHVybiBjaGlsZDsKICB9OwoKICAvLyBTZXQgdXAgaW5oZXJpdGFuY2UgZm9yIHRoZSBtb2RlbCwgY29sbGVjdGlvbiwgcm91dGVyLCB2aWV3IGFuZCBoaXN0b3J5LgogIE1vZGVsLmV4dGVuZCA9IENvbGxlY3Rpb24uZXh0ZW5kID0gUm91dGVyLmV4dGVuZCA9IFZpZXcuZXh0ZW5kID0gSGlzdG9yeS5leHRlbmQgPSBleHRlbmQ7CgogIC8vIFRocm93IGFuIGVycm9yIHdoZW4gYSBVUkwgaXMgbmVlZGVkLCBhbmQgbm9uZSBpcyBzdXBwbGllZC4KICB2YXIgdXJsRXJyb3IgPSBmdW5jdGlvbigpIHsKICAgIHRocm93IG5ldyBFcnJvcignQSAidXJsIiBwcm9wZXJ0eSBvciBmdW5jdGlvbiBtdXN0IGJlIHNwZWNpZmllZCcpOwogIH07CgogIC8vIFdyYXAgYW4gb3B0aW9uYWwgZXJyb3IgY2FsbGJhY2sgd2l0aCBhIGZhbGxiYWNrIGVycm9yIGV2ZW50LgogIHZhciB3cmFwRXJyb3IgPSBmdW5jdGlvbiAobW9kZWwsIG9wdGlvbnMpIHsKICAgIHZhciBlcnJvciA9IG9wdGlvbnMuZXJyb3I7CiAgICBvcHRpb25zLmVycm9yID0gZnVuY3Rpb24ocmVzcCkgewogICAgICBpZiAoZXJyb3IpIGVycm9yKG1vZGVsLCByZXNwLCBvcHRpb25zKTsKICAgICAgbW9kZWwudHJpZ2dlcignZXJyb3InLCBtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CiAgICB9OwogIH07Cgp9KS5jYWxsKHRoaXMpOwoKZGVmaW5lKCJiYWNrYm9uZSIsIFsidW5kZXJzY29yZSIsImpxdWVyeSJdLCAoZnVuY3Rpb24gKGdsb2JhbCkgewogICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgcmV0LCBmbjsKICAgICAgICByZXR1cm4gcmV0IHx8IGdsb2JhbC5CYWNrYm9uZTsKICAgIH07Cn0odGhpcykpKTsKCi8qKgogKiBCYWNrYm9uZSBsb2NhbFN0b3JhZ2UgQWRhcHRlcgogKiBWZXJzaW9uIDEuMS4xMwogKgogKiBodHRwczovL2dpdGh1Yi5jb20vamVyb21lZ24vQmFja2JvbmUubG9jYWxTdG9yYWdlCiAqLwooZnVuY3Rpb24gKHJvb3QsIGZhY3RvcnkpIHsKICBpZiAodHlwZW9mIGV4cG9ydHMgPT09ICdvYmplY3QnICYmIHR5cGVvZiByZXF1aXJlID09PSAnZnVuY3Rpb24nKSB7CiAgICBtb2R1bGUuZXhwb3J0cyA9IGZhY3RvcnkocmVxdWlyZSgiYmFja2JvbmUiKSk7CiAgfSBlbHNlIGlmICh0eXBlb2YgZGVmaW5lID09PSAiZnVuY3Rpb24iICYmIGRlZmluZS5hbWQpIHsKICAgIC8vIEFNRC4gUmVnaXN0ZXIgYXMgYW4gYW5vbnltb3VzIG1vZHVsZS4KICAgIGRlZmluZSgnbG9jYWxzdG9yYWdlJyxbImJhY2tib25lIl0sIGZ1bmN0aW9uKEJhY2tib25lKSB7CiAgICAgIC8vIFVzZSBnbG9iYWwgdmFyaWFibGVzIGlmIHRoZSBsb2NhbHMgYXJlIHVuZGVmaW5lZC4KICAgICAgcmV0dXJuIGZhY3RvcnkoQmFja2JvbmUgfHwgcm9vdC5CYWNrYm9uZSk7CiAgICB9KTsKICB9IGVsc2UgewogICAgZmFjdG9yeShCYWNrYm9uZSk7CiAgfQp9KHRoaXMsIGZ1bmN0aW9uKEJhY2tib25lKSB7Ci8vIEEgc2ltcGxlIG1vZHVsZSB0byByZXBsYWNlIGBCYWNrYm9uZS5zeW5jYCB3aXRoICpsb2NhbFN0b3JhZ2UqLWJhc2VkCi8vIHBlcnNpc3RlbmNlLiBNb2RlbHMgYXJlIGdpdmVuIEdVSURTLCBhbmQgc2F2ZWQgaW50byBhIEpTT04gb2JqZWN0LiBTaW1wbGUKLy8gYXMgdGhhdC4KCi8vIEhvbGQgcmVmZXJlbmNlIHRvIFVuZGVyc2NvcmUuanMgYW5kIEJhY2tib25lLmpzIGluIHRoZSBjbG9zdXJlIGluIG9yZGVyCi8vIHRvIG1ha2UgdGhpbmdzIHdvcmsgZXZlbiBpZiB0aGV5IGFyZSByZW1vdmVkIGZyb20gdGhlIGdsb2JhbCBuYW1lc3BhY2UKCi8vIEdlbmVyYXRlIGZvdXIgcmFuZG9tIGhleCBkaWdpdHMuCmZ1bmN0aW9uIFM0KCkgewogICByZXR1cm4gKCgoMStNYXRoLnJhbmRvbSgpKSoweDEwMDAwKXwwKS50b1N0cmluZygxNikuc3Vic3RyaW5nKDEpOwp9OwoKLy8gR2VuZXJhdGUgYSBwc2V1ZG8tR1VJRCBieSBjb25jYXRlbmF0aW5nIHJhbmRvbSBoZXhhZGVjaW1hbC4KZnVuY3Rpb24gZ3VpZCgpIHsKICAgcmV0dXJuIChTNCgpK1M0KCkrIi0iK1M0KCkrIi0iK1M0KCkrIi0iK1M0KCkrIi0iK1M0KCkrUzQoKStTNCgpKTsKfTsKCmZ1bmN0aW9uIGlzT2JqZWN0KGl0ZW0pIHsKICByZXR1cm4gaXRlbSA9PT0gT2JqZWN0KGl0ZW0pOwp9CgpmdW5jdGlvbiBjb250YWlucyhhcnJheSwgaXRlbSkgewogIHZhciBpID0gYXJyYXkubGVuZ3RoOwogIHdoaWxlIChpLS0pIGlmIChhcnJheVtpXSA9PT0gaXRlbSkgcmV0dXJuIHRydWU7CiAgcmV0dXJuIGZhbHNlOwp9CgpmdW5jdGlvbiBleHRlbmQob2JqLCBwcm9wcykgewogIGZvciAodmFyIGtleSBpbiBwcm9wcykgb2JqW2tleV0gPSBwcm9wc1trZXldCiAgcmV0dXJuIG9iajsKfQoKLy8gT3VyIFN0b3JlIGlzIHJlcHJlc2VudGVkIGJ5IGEgc2luZ2xlIEpTIG9iamVjdCBpbiAqbG9jYWxTdG9yYWdlKi4gQ3JlYXRlIGl0Ci8vIHdpdGggYSBtZWFuaW5nZnVsIG5hbWUsIGxpa2UgdGhlIG5hbWUgeW91J2QgZ2l2ZSBhIHRhYmxlLgovLyB3aW5kb3cuU3RvcmUgaXMgZGVwcmVjdGF0ZWQsIHVzZSBCYWNrYm9uZS5Mb2NhbFN0b3JhZ2UgaW5zdGVhZApCYWNrYm9uZS5Mb2NhbFN0b3JhZ2UgPSB3aW5kb3cuU3RvcmUgPSBmdW5jdGlvbihuYW1lLCBzZXJpYWxpemVyKSB7CiAgaWYoICF0aGlzLmxvY2FsU3RvcmFnZSApIHsKICAgIHRocm93ICJCYWNrYm9uZS5sb2NhbFN0b3JhZ2U6IEVudmlyb25tZW50IGRvZXMgbm90IHN1cHBvcnQgbG9jYWxTdG9yYWdlLiIKICB9CiAgdGhpcy5uYW1lID0gbmFtZTsKICB0aGlzLnNlcmlhbGl6ZXIgPSBzZXJpYWxpemVyIHx8IHsKICAgIHNlcmlhbGl6ZTogZnVuY3Rpb24oaXRlbSkgewogICAgICByZXR1cm4gaXNPYmplY3QoaXRlbSkgPyBKU09OLnN0cmluZ2lmeShpdGVtKSA6IGl0ZW07CiAgICB9LAogICAgLy8gZml4IGZvciAiaWxsZWdhbCBhY2Nlc3MiIGVycm9yIG9uIEFuZHJvaWQgd2hlbiBKU09OLnBhcnNlIGlzIHBhc3NlZCBudWxsCiAgICBkZXNlcmlhbGl6ZTogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgcmV0dXJuIGRhdGEgJiYgSlNPTi5wYXJzZShkYXRhKTsKICAgIH0KICB9OwogIHZhciBzdG9yZSA9IHRoaXMubG9jYWxTdG9yYWdlKCkuZ2V0SXRlbSh0aGlzLm5hbWUpOwogIHRoaXMucmVjb3JkcyA9IChzdG9yZSAmJiBzdG9yZS5zcGxpdCgiLCIpKSB8fCBbXTsKfTsKCmV4dGVuZChCYWNrYm9uZS5Mb2NhbFN0b3JhZ2UucHJvdG90eXBlLCB7CgogIC8vIFNhdmUgdGhlIGN1cnJlbnQgc3RhdGUgb2YgdGhlICoqU3RvcmUqKiB0byAqbG9jYWxTdG9yYWdlKi4KICBzYXZlOiBmdW5jdGlvbigpIHsKICAgIHRoaXMubG9jYWxTdG9yYWdlKCkuc2V0SXRlbSh0aGlzLm5hbWUsIHRoaXMucmVjb3Jkcy5qb2luKCIsIikpOwogIH0sCgogIC8vIEFkZCBhIG1vZGVsLCBnaXZpbmcgaXQgYSAoaG9wZWZ1bGx5KS11bmlxdWUgR1VJRCwgaWYgaXQgZG9lc24ndCBhbHJlYWR5CiAgLy8gaGF2ZSBhbiBpZCBvZiBpdCdzIG93bi4KICBjcmVhdGU6IGZ1bmN0aW9uKG1vZGVsKSB7CiAgICBpZiAoIW1vZGVsLmlkKSB7CiAgICAgIG1vZGVsLmlkID0gZ3VpZCgpOwogICAgICBtb2RlbC5zZXQobW9kZWwuaWRBdHRyaWJ1dGUsIG1vZGVsLmlkKTsKICAgIH0KICAgIHRoaXMubG9jYWxTdG9yYWdlKCkuc2V0SXRlbSh0aGlzLl9pdGVtTmFtZShtb2RlbC5pZCksIHRoaXMuc2VyaWFsaXplci5zZXJpYWxpemUobW9kZWwpKTsKICAgIHRoaXMucmVjb3Jkcy5wdXNoKG1vZGVsLmlkLnRvU3RyaW5nKCkpOwogICAgdGhpcy5zYXZlKCk7CiAgICByZXR1cm4gdGhpcy5maW5kKG1vZGVsKSAhPT0gZmFsc2U7CiAgfSwKCiAgLy8gVXBkYXRlIGEgbW9kZWwgYnkgcmVwbGFjaW5nIGl0cyBjb3B5IGluIGB0aGlzLmRhdGFgLgogIHVwZGF0ZTogZnVuY3Rpb24obW9kZWwpIHsKICAgIHRoaXMubG9jYWxTdG9yYWdlKCkuc2V0SXRlbSh0aGlzLl9pdGVtTmFtZShtb2RlbC5pZCksIHRoaXMuc2VyaWFsaXplci5zZXJpYWxpemUobW9kZWwpKTsKICAgIHZhciBtb2RlbElkID0gbW9kZWwuaWQudG9TdHJpbmcoKTsKICAgIGlmICghY29udGFpbnModGhpcy5yZWNvcmRzLCBtb2RlbElkKSkgewogICAgICB0aGlzLnJlY29yZHMucHVzaChtb2RlbElkKTsKICAgICAgdGhpcy5zYXZlKCk7CiAgICB9CiAgICByZXR1cm4gdGhpcy5maW5kKG1vZGVsKSAhPT0gZmFsc2U7CiAgfSwKCiAgLy8gUmV0cmlldmUgYSBtb2RlbCBmcm9tIGB0aGlzLmRhdGFgIGJ5IGlkLgogIGZpbmQ6IGZ1bmN0aW9uKG1vZGVsKSB7CiAgICByZXR1cm4gdGhpcy5zZXJpYWxpemVyLmRlc2VyaWFsaXplKHRoaXMubG9jYWxTdG9yYWdlKCkuZ2V0SXRlbSh0aGlzLl9pdGVtTmFtZShtb2RlbC5pZCkpKTsKICB9LAoKICAvLyBSZXR1cm4gdGhlIGFycmF5IG9mIGFsbCBtb2RlbHMgY3VycmVudGx5IGluIHN0b3JhZ2UuCiAgZmluZEFsbDogZnVuY3Rpb24oKSB7CiAgICB2YXIgcmVzdWx0ID0gW107CiAgICBmb3IgKHZhciBpID0gMCwgaWQsIGRhdGE7IGkgPCB0aGlzLnJlY29yZHMubGVuZ3RoOyBpKyspIHsKICAgICAgaWQgPSB0aGlzLnJlY29yZHNbaV07CiAgICAgIGRhdGEgPSB0aGlzLnNlcmlhbGl6ZXIuZGVzZXJpYWxpemUodGhpcy5sb2NhbFN0b3JhZ2UoKS5nZXRJdGVtKHRoaXMuX2l0ZW1OYW1lKGlkKSkpOwogICAgICBpZiAoZGF0YSAhPSBudWxsKSByZXN1bHQucHVzaChkYXRhKTsKICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfSwKCiAgLy8gRGVsZXRlIGEgbW9kZWwgZnJvbSBgdGhpcy5kYXRhYCwgcmV0dXJuaW5nIGl0LgogIGRlc3Ryb3k6IGZ1bmN0aW9uKG1vZGVsKSB7CiAgICB0aGlzLmxvY2FsU3RvcmFnZSgpLnJlbW92ZUl0ZW0odGhpcy5faXRlbU5hbWUobW9kZWwuaWQpKTsKICAgIHZhciBtb2RlbElkID0gbW9kZWwuaWQudG9TdHJpbmcoKTsKICAgIGZvciAodmFyIGkgPSAwLCBpZDsgaSA8IHRoaXMucmVjb3Jkcy5sZW5ndGg7IGkrKykgewogICAgICBpZiAodGhpcy5yZWNvcmRzW2ldID09PSBtb2RlbElkKSB7CiAgICAgICAgdGhpcy5yZWNvcmRzLnNwbGljZShpLCAxKTsKICAgICAgfQogICAgfQogICAgdGhpcy5zYXZlKCk7CiAgICByZXR1cm4gbW9kZWw7CiAgfSwKCiAgbG9jYWxTdG9yYWdlOiBmdW5jdGlvbigpIHsKICAgIHJldHVybiBsb2NhbFN0b3JhZ2U7CiAgfSwKCiAgLy8gQ2xlYXIgbG9jYWxTdG9yYWdlIGZvciBzcGVjaWZpYyBjb2xsZWN0aW9uLgogIF9jbGVhcjogZnVuY3Rpb24oKSB7CiAgICB2YXIgbG9jYWwgPSB0aGlzLmxvY2FsU3RvcmFnZSgpLAogICAgICBpdGVtUmUgPSBuZXcgUmVnRXhwKCJeIiArIHRoaXMubmFtZSArICItIik7CgogICAgLy8gUmVtb3ZlIGlkLXRyYWNraW5nIGl0ZW0gKGUuZy4sICJmb28iKS4KICAgIGxvY2FsLnJlbW92ZUl0ZW0odGhpcy5uYW1lKTsKCiAgICAvLyBNYXRjaCBhbGwgZGF0YSBpdGVtcyAoZS5nLiwgImZvby1JRCIpIGFuZCByZW1vdmUuCiAgICBmb3IgKHZhciBrIGluIGxvY2FsKSB7CiAgICAgIGlmIChpdGVtUmUudGVzdChrKSkgewogICAgICAgIGxvY2FsLnJlbW92ZUl0ZW0oayk7CiAgICAgIH0KICAgIH0KCiAgICB0aGlzLnJlY29yZHMubGVuZ3RoID0gMDsKICB9LAoKICAvLyBTaXplIG9mIGxvY2FsU3RvcmFnZS4KICBfc3RvcmFnZVNpemU6IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHRoaXMubG9jYWxTdG9yYWdlKCkubGVuZ3RoOwogIH0sCgogIF9pdGVtTmFtZTogZnVuY3Rpb24oaWQpIHsKICAgIHJldHVybiB0aGlzLm5hbWUrIi0iK2lkOwogIH0KCn0pOwoKLy8gbG9jYWxTeW5jIGRlbGVnYXRlIHRvIHRoZSBtb2RlbCBvciBjb2xsZWN0aW9uJ3MKLy8gKmxvY2FsU3RvcmFnZSogcHJvcGVydHksIHdoaWNoIHNob3VsZCBiZSBhbiBpbnN0YW5jZSBvZiBgU3RvcmVgLgovLyB3aW5kb3cuU3RvcmUuc3luYyBhbmQgQmFja2JvbmUubG9jYWxTeW5jIGlzIGRlcHJlY2F0ZWQsIHVzZSBCYWNrYm9uZS5Mb2NhbFN0b3JhZ2Uuc3luYyBpbnN0ZWFkCkJhY2tib25lLkxvY2FsU3RvcmFnZS5zeW5jID0gd2luZG93LlN0b3JlLnN5bmMgPSBCYWNrYm9uZS5sb2NhbFN5bmMgPSBmdW5jdGlvbihtZXRob2QsIG1vZGVsLCBvcHRpb25zKSB7CiAgdmFyIHN0b3JlID0gbW9kZWwubG9jYWxTdG9yYWdlIHx8IG1vZGVsLmNvbGxlY3Rpb24ubG9jYWxTdG9yYWdlOwoKICB2YXIgcmVzcCwgZXJyb3JNZXNzYWdlOwogIC8vSWYgJCBpcyBoYXZpbmcgRGVmZXJyZWQgLSB1c2UgaXQuCiAgdmFyIHN5bmNEZmQgPSBCYWNrYm9uZS4kID8KICAgIChCYWNrYm9uZS4kLkRlZmVycmVkICYmIEJhY2tib25lLiQuRGVmZXJyZWQoKSkgOgogICAgKEJhY2tib25lLkRlZmVycmVkICYmIEJhY2tib25lLkRlZmVycmVkKCkpOwoKICB0cnkgewoKICAgIHN3aXRjaCAobWV0aG9kKSB7CiAgICAgIGNhc2UgInJlYWQiOgogICAgICAgIHJlc3AgPSBtb2RlbC5pZCAhPSB1bmRlZmluZWQgPyBzdG9yZS5maW5kKG1vZGVsKSA6IHN0b3JlLmZpbmRBbGwoKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAiY3JlYXRlIjoKICAgICAgICByZXNwID0gc3RvcmUuY3JlYXRlKG1vZGVsKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAidXBkYXRlIjoKICAgICAgICByZXNwID0gc3RvcmUudXBkYXRlKG1vZGVsKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAiZGVsZXRlIjoKICAgICAgICByZXNwID0gc3RvcmUuZGVzdHJveShtb2RlbCk7CiAgICAgICAgYnJlYWs7CiAgICB9CgogIH0gY2F0Y2goZXJyb3IpIHsKICAgIGlmIChlcnJvci5jb2RlID09PSAyMiAmJiBzdG9yZS5fc3RvcmFnZVNpemUoKSA9PT0gMCkKICAgICAgZXJyb3JNZXNzYWdlID0gIlByaXZhdGUgYnJvd3NpbmcgaXMgdW5zdXBwb3J0ZWQiOwogICAgZWxzZQogICAgICBlcnJvck1lc3NhZ2UgPSBlcnJvci5tZXNzYWdlOwogIH0KCiAgaWYgKHJlc3ApIHsKICAgIGlmIChvcHRpb25zICYmIG9wdGlvbnMuc3VjY2VzcykgewogICAgICBpZiAoQmFja2JvbmUuVkVSU0lPTiA9PT0gIjAuOS4xMCIpIHsKICAgICAgICBvcHRpb25zLnN1Y2Nlc3MobW9kZWwsIHJlc3AsIG9wdGlvbnMpOwogICAgICB9IGVsc2UgewogICAgICAgIG9wdGlvbnMuc3VjY2VzcyhyZXNwKTsKICAgICAgfQogICAgfQogICAgaWYgKHN5bmNEZmQpIHsKICAgICAgc3luY0RmZC5yZXNvbHZlKHJlc3ApOwogICAgfQoKICB9IGVsc2UgewogICAgZXJyb3JNZXNzYWdlID0gZXJyb3JNZXNzYWdlID8gZXJyb3JNZXNzYWdlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgOiAiUmVjb3JkIE5vdCBGb3VuZCI7CgogICAgaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy5lcnJvcikKICAgICAgaWYgKEJhY2tib25lLlZFUlNJT04gPT09ICIwLjkuMTAiKSB7CiAgICAgICAgb3B0aW9ucy5lcnJvcihtb2RlbCwgZXJyb3JNZXNzYWdlLCBvcHRpb25zKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBvcHRpb25zLmVycm9yKGVycm9yTWVzc2FnZSk7CiAgICAgIH0KCiAgICBpZiAoc3luY0RmZCkKICAgICAgc3luY0RmZC5yZWplY3QoZXJyb3JNZXNzYWdlKTsKICB9CgogIC8vIGFkZCBjb21wYXRpYmlsaXR5IHdpdGggJC5hamF4CiAgLy8gYWx3YXlzIGV4ZWN1dGUgY2FsbGJhY2sgZm9yIHN1Y2Nlc3MgYW5kIGVycm9yCiAgaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy5jb21wbGV0ZSkgb3B0aW9ucy5jb21wbGV0ZShyZXNwKTsKCiAgcmV0dXJuIHN5bmNEZmQgJiYgc3luY0RmZC5wcm9taXNlKCk7Cn07CgpCYWNrYm9uZS5hamF4U3luYyA9IEJhY2tib25lLnN5bmM7CgpCYWNrYm9uZS5nZXRTeW5jTWV0aG9kID0gZnVuY3Rpb24obW9kZWwpIHsKICBpZihtb2RlbC5sb2NhbFN0b3JhZ2UgfHwgKG1vZGVsLmNvbGxlY3Rpb24gJiYgbW9kZWwuY29sbGVjdGlvbi5sb2NhbFN0b3JhZ2UpKSB7CiAgICByZXR1cm4gQmFja2JvbmUubG9jYWxTeW5jOwogIH0KCiAgcmV0dXJuIEJhY2tib25lLmFqYXhTeW5jOwp9OwoKLy8gT3ZlcnJpZGUgJ0JhY2tib25lLnN5bmMnIHRvIGRlZmF1bHQgdG8gbG9jYWxTeW5jLAovLyB0aGUgb3JpZ2luYWwgJ0JhY2tib25lLnN5bmMnIGlzIHN0aWxsIGF2YWlsYWJsZSBpbiAnQmFja2JvbmUuYWpheFN5bmMnCkJhY2tib25lLnN5bmMgPSBmdW5jdGlvbihtZXRob2QsIG1vZGVsLCBvcHRpb25zKSB7CiAgcmV0dXJuIEJhY2tib25lLmdldFN5bmNNZXRob2QobW9kZWwpLmFwcGx5KHRoaXMsIFttZXRob2QsIG1vZGVsLCBvcHRpb25zXSk7Cn07CgpyZXR1cm4gQmFja2JvbmUuTG9jYWxTdG9yYWdlOwp9KSk7CgpkZWZpbmUoJ2dhbGxlcnkvdXRpbHMvcmVzcG9uc2l2ZS5hZGFwdGVyJyxbCiAgJ2pxdWVyeScsCiAgJ3VuZGVyc2NvcmUnCl0sIGZ1bmN0aW9uKCQsIF8pIHsKICAKICAvKgogICAqIFJlc3BvbnNpdmVBZGFwdGVyCiAgICoKICAgKiBLbm93cyBob3cgZGl2ZXJzZSBNb2R1bGVzIHJlYWN0IGRpZmZlcmVudCBpbiBzb21lIGFzcGVjdHMgdG8gZGlmZmVyZW50IAogICAqIGRldmljZXMuCiAgICogS25vd3Mgd2hpY2ggcHJlc2V0IHRvIGNob29zZSBmb3IgdGhlIGRldmljZSBvbiB3aGljaCB3ZSBhcmUuIAogICAqIGkuZS4gcmVwbGFjZXMgbGFyZ2Ugd2l0aCBsYXJnZV9waG9uZQogICAqCiAgICovCiAgdmFyIFJlc3BvbnNpdmVBZGFwdGVyID0gewoKICAgIC8qCiAgICAgKiBNZWRpYXR5cGUgaXMgZGVmaW5lZCBpbiBkZXZpY2VzLmNzcyB3aXRoIG1lZGlhIHF1ZXJpZXMuIAogICAgICogRGVmYXVsdCB2YWx1ZXMgZm9yIG1lZGlhIHR5cGVzIGFyZSAnZGVza3RvcCcsICdwYWRzJywgJ3Bob25lcycKICAgICAqLwogICAgZ2V0TWVkaWFUeXBlOiBmdW5jdGlvbigpIHsKICAgICAgaWYgKHRoaXMubWVkaWFUeXBlKSB7CiAgICAgICAgcmV0dXJuIHRoaXMubWVkaWFUeXBlOwogICAgICB9IGVsc2UgewogICAgICAgIGlmICghd2luZG93LmdldENvbXB1dGVkU3R5bGUpIHsKICAgICAgICAgIHJldHVybiB0aGlzLm1lZGlhVHlwZSA9ICdkZXNrdG9wJzsgLy8ganNoaW50IGlnbm9yZTpsaW5lCiAgICAgICAgfQogICAgICAgIHZhciBtdCA9IHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKGRvY3VtZW50LmJvZHksJzphZnRlcicpCiAgICAgICAgICAuZ2V0UHJvcGVydHlWYWx1ZSgnY29udGVudCcpLm1hdGNoKC9bYS16QS1aX1wtMC05XSsvZyk7CgogICAgICAgIHJldHVybiB0aGlzLm1lZGlhVHlwZSA9IG10ICYmIG10Lmxlbmd0aD4wID8gbXRbMF0gOiAnZGVza3RvcCc7IC8vIGpzaGludCBpZ25vcmU6bGluZQogICAgICB9CiAgICB9LAogICAgCiAgICAvKgogICAgICogRXhwZWN0cyBhbiBvcHRpb25zLUhhc2ggb3B0cyBhbmQgYSBrZXkgb2YgdGhpcyBIYXNoLiBUaGUgZGVzY3JpYmVkIHZhbHVlIAogICAgICogY2FuIGJlIGEgZGlyZWN0bHkgcmV0dXJuZWQgc2luZ2xlIHZhbHVlIG9yIGFuIG9iamVjdCBIYXNoIHdpdGggdGhlCiAgICAgKiBtZWRpYVR5cGVzIG1hbmFnZWQgYnkgdGhpcyBhZGFwdGVyIGFzIGtleXMuCiAgICAgKi8KICAgIGdldE9wdGlvbkJ5TWVkaWFUeXBlOiBmdW5jdGlvbihvcHRzLCBrZXkpIHsKICAgICAgaWYgKCQuaXNQbGFpbk9iamVjdChvcHRzW2tleV0pKSB7CiAgICAgICAgcmV0dXJuIG9wdHNba2V5XVt0aGlzLmdldE1lZGlhVHlwZSgpXTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gb3B0c1trZXldOwogICAgICB9CiAgICB9LAogICAgCiAgICBwcmVzZXRNYXBwZXJUaHVtYjogZnVuY3Rpb24oaW1hZ2VNb2RlbCkgewogICAgICB2YXIgcHJlc2V0OwogICAgICBzd2l0Y2godGhpcy5nZXRNZWRpYVR5cGUoKSkgewogICAgICAgIGNhc2UgJ2Rlc2t0b3AnOgogICAgICAgIGNhc2UgJ3BhZCc6CiAgICAgICAgY2FzZSAncGhvbmUnOgogICAgICAgICAgcHJlc2V0ID0gaW1hZ2VNb2RlbC5nZXQoJ3RodW1iJyk7CiAgICAgICAgICBicmVhazsKICAgICAgfQogICAgICByZXR1cm4gcHJlc2V0OwogICAgfSwKCiAgICBwcmVzZXRNYXBwZXJMYXJnZTogZnVuY3Rpb24oaW1hZ2VNb2RlbCkgewogICAgICB2YXIgcHJlc2V0OwogICAgICBzd2l0Y2godGhpcy5nZXRNZWRpYVR5cGUoKSkgewogICAgICAgIGNhc2UgJ2Rlc2t0b3AnOgogICAgICAgICAgcHJlc2V0ID0gaW1hZ2VNb2RlbC5nZXQoJ2xhcmdlJyk7CiAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlICdwYWQnOgogICAgICAgICAgcHJlc2V0ID0gaW1hZ2VNb2RlbC5nZXQoJ2xhcmdlX3BhZHMnKTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgJ3Bob25lJzoKICAgICAgICAgIHByZXNldCA9IGltYWdlTW9kZWwuZ2V0KCdsYXJnZV9waG9uZXMnKTsKICAgICAgICAgIGJyZWFrOwogICAgICB9CiAgICAgIHJldHVybiBwcmVzZXQ7CiAgICB9CiAgICAKICB9OwogIAogIHJldHVybiBSZXNwb25zaXZlQWRhcHRlcjsKfSk7CgovKgogKiBHYWxsZXJ5SW1hZ2UgTW9kZWwKICogLS0tLS0tLS0tLQogKgogKiBPdXIgYmFzaWMgKipJbWFnZU1vZGVsKiogaGFzIGF0dHJpYnV0ZXMgZm9yIHRoZSAndGh1bWInLAogKiAnbGFyZ2UnIGFuZCBtZXRhZGF0YSBsaWtlICdvcmllbnRhdGlvbicsICdyYXRpbycsICdleGlmJy4uLgogKgogKi8KZGVmaW5lKCdnYWxsZXJ5L21vZGVscy9pbWFnZS5tb2RlbCcsWwogICd1bmRlcnNjb3JlJywKICAnYmFja2JvbmUnLAogICdnYWxsZXJ5L3V0aWxzL3Jlc3BvbnNpdmUuYWRhcHRlcicKXSwgZnVuY3Rpb24oXywgQmFja2JvbmUsIFJlc3BvbnNpdmVBZGFwdGVyKSB7CiAgdmFyIEltYWdlTW9kZWwgPSBCYWNrYm9uZS5Nb2RlbC5leHRlbmQoewoKICAgIGlkQXR0cmlidXRlOiAnZGlnZXN0JywKCiAgICAvLyBEZWZhdWx0IGF0dHJpYnV0ZXMgZm9yIHRoZSBHYWxsZXJ5SW1hZ2UuCiAgICBkZWZhdWx0czogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgdGh1bWI6IHsKICAgICAgICAgIHNyYzogdW5kZWZpbmVkLAogICAgICAgICAgd2lkdGg6IHVuZGVmaW5lZCwKICAgICAgICAgIGhlaWdodDogdW5kZWZpbmVkLAogICAgICAgICAgX3ZpZXc6IHVuZGVmaW5lZAogICAgICAgIH0sCiAgICAgICAgbGFyZ2U6IHsKICAgICAgICAgIHNyYzogdW5kZWZpbmVkLAogICAgICAgICAgd2lkdGg6IHVuZGVmaW5lZCwKICAgICAgICAgIGhlaWdodDogdW5kZWZpbmVkLAogICAgICAgICAgX3ZpZXc6IHVuZGVmaW5lZAogICAgICAgIH0sCiAgICAgICAgZmlsZW5hbWU6IHVuZGVmaW5lZCwKICAgICAgICBmaWxlbmFtZU9yaWc6IHVuZGVmaW5lZCwKICAgICAgICBkaWdlc3Q6IHVuZGVmaW5lZCwKICAgICAgICBpbmRleDogdW5kZWZpbmVkLAogICAgICAgIG9yaWVudGF0aW9uOiB1bmRlZmluZWQsIC8vIGxhbmRzY2FwZSB8IHBvcnRyYWl0CiAgICAgICAgcmF0aW86IDAsIC8vIDwgMSA9PiBwb3J0cmFpdCB8ID4gMSBsYW5kc2NhcGUgVE9ETzogRG9wcGVsdW5nCiAgICAgICAgZXhpZjoge30sCiAgICAgICAgbWV0YToge30sCiAgICAgICAgaW1hZ2VQYWdlUGF0aDogdW5kZWZpbmVkCiAgICAgIH07CiAgICB9LAogICAgCiAgICAvLyBDb25zdHJ1Y3Rvci9Jbml0aWFsaXplciBoYXMgdG8gYmUgY2FsbGVkIHdpdGggYSBvcHRpb25zLnByZXNldHMgaGFzaCB3aXRoIAogICAgLy8gYSBiYXNldXJsIGZvciBldmVyeSBwcmVzZXQgKG1pbmltdW06IHRodW1iICYgbGFyZ2UpLgogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oYXR0cnMsIG9wdGlvbnMpIHsKICAgICAgaWYgKG9wdGlvbnMgIT09IHVuZGVmaW5lZCkgewogICAgICAgIC8vIHNldCB0aGUgc3JjIGF0dHJpYnV0ZSBmb3IgZXZlcnkgcHJlc2V0CiAgICAgICAgXy5mb3JFYWNoKG9wdGlvbnMucHJlc2V0cywgXy5iaW5kKGZ1bmN0aW9uKHByZXNldCwgcHJlc2V0S2V5KSB7CiAgICAgICAgICB0aGlzLmF0dHJpYnV0ZXNbcHJlc2V0S2V5XVsnc3JjJ10gPSBwcmVzZXRbJ2Jhc2V1cmwnXSArICcvJyArIGF0dHJzWydmaWxlbmFtZSddOwogICAgICAgIH0sIHRoaXMpKTsKICAgICAgICAvLyBzZXQgb3JpZy1maWxlbmFtZQogICAgICAgIHRoaXMuYXR0cmlidXRlc1snZmlsZW5hbWVPcmlnJ10gPSBhdHRyc1snZmlsZW5hbWUnXS5yZXBsYWNlKCctJyArIGF0dHJzWydkaWdlc3QnXSwgJycpOwogICAgICAgIC8vIHNldCBpbWFnZV9wYWdlIHVybAogICAgICAgIGlmIChvcHRpb25zLmdhbGxlcnkgJiYgb3B0aW9ucy5nYWxsZXJ5LmltYWdlUGFnZXMgJiYgb3B0aW9ucy5nYWxsZXJ5LmJhc2VwYXRoKSB7CiAgICAgICAgICB0aGlzLmF0dHJpYnV0ZXNbJ2ltYWdlUGFnZVBhdGgnXSA9IG9wdGlvbnMuZ2FsbGVyeS5wYXRoLnJlcGxhY2UoL1wuaHRtbCQvLCAnJykgKyAnLycgKyBhdHRyc1snZGlnZXN0J107CiAgICAgICAgfQogICAgICB9CiAgICB9LAoKICAgIC8vIFJldHVybnMgdGhlIHByZXNldCBIYXNoIGZvciB0aGUgVGh1bWIgb24gdGhlIGN1cnJlbnQgZGV2aWNlCiAgICBnZXRUaHVtYjogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBSZXNwb25zaXZlQWRhcHRlci5wcmVzZXRNYXBwZXJUaHVtYih0aGlzKTsKICAgIH0sCgogICAgLy8gUmV0dXJucyB0aGUgcHJlc2V0IEhhc2ggZm9yIHRoZSBMYXJnZSBvbiB0aGUgY3VycmVudCBkZXZpY2UKICAgIGdldExhcmdlOiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIFJlc3BvbnNpdmVBZGFwdGVyLnByZXNldE1hcHBlckxhcmdlKHRoaXMpOwogICAgfSwKICAgIAogICAgZ2V0VGh1bWJWaWV3OiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHRoaXMuX3RodW1iVmlldzsKICAgIH0sCiAgICAKICAgIHNldFRodW1iVmlldzogZnVuY3Rpb24odGh1bWJWaWV3KSB7CiAgICAgIHRoaXMuX3RodW1iVmlldyA9IHRodW1iVmlldzsKICAgIH0sCiAgICAKICAgIGdldExhcmdlVmlldzogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB0aGlzLl9sYXJnZVZpZXc7CiAgICB9LAogICAgCiAgICBzZXRMYXJnZVZpZXc6IGZ1bmN0aW9uKGxhcmdlVmlldykgewogICAgICB0aGlzLl9sYXJnZVZpZXcgPSBsYXJnZVZpZXc7CiAgICB9LAogICAgICAgIAogICAgaW5kZXg6IGZ1bmN0aW9uKCkgewogICAgICBpZiAodGhpcy5hdHRyaWJ1dGVzLmluZGV4ID09PSB1bmRlZmluZWQpIHsKICAgICAgICByZXR1cm4gdGhpcy5jb2xsZWN0aW9uID8gdGhpcy5jb2xsZWN0aW9uLmluZGV4T2YodGhpcykgOiB1bmRlZmluZWQ7CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXMuYXR0cmlidXRlcy5pbmRleDsKICAgIH0KICB9KTsKICAKICByZXR1cm4gSW1hZ2VNb2RlbDsKfSk7CgovKiBJbWFnZUNvbGxlY3Rpb24KICogLS0tLS0tLS0tLS0tLS0tCiAqCiAqIFRoZSBjb2xsZWN0aW9uIG9mIEltYWdlTW9kZWwgb2JqZWN0cy4KICoKICovCmRlZmluZSgnZ2FsbGVyeS9jb2xsZWN0aW9ucy9pbWFnZS5jb2xsZWN0aW9uJyxbCiAgJ2JhY2tib25lJywgCiAgJ2xvY2Fsc3RvcmFnZScsCiAgJ2dhbGxlcnkvbW9kZWxzL2ltYWdlLm1vZGVsJwpdLCBmdW5jdGlvbihCYWNrYm9uZSwgbm9wZSwgSW1hZ2VNb2RlbCkgewogIAogIHZhciBJbWFnZUNvbGxlY3Rpb24gPSBCYWNrYm9uZS5Db2xsZWN0aW9uLmV4dGVuZCh7CgogICAgLy8gUmVmZXJlbmNlIHRvIHRoaXMgY29sbGVjdGlvbidzIG1vZGVsLgogICAgbW9kZWw6IEltYWdlTW9kZWwsCgogICAgLy8gTWFrZSBDb2xsZWN0aW9uIGEgTG9jYWxTdG9yYWdlIENvbGxlY3Rpb24sIHdoZW4gb3B0cy5sb2NhbFN0b3JhZ2VLZXkgaXMKICAgIC8vIGdpdmVuLgogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24obW9kZWxzLCBvcHRzKSB7CiAgICAgIGlmIChvcHRzLmxvY2FsU3RvcmFnZUtleSkgewogICAgICAgIHRoaXMua2V5ID0gb3B0cy5sb2NhbFN0b3JhZ2VLZXk7CiAgICAgICAgdGhpcy5sb2NhbFN0b3JhZ2UgPSBuZXcgQmFja2JvbmUuTG9jYWxTdG9yYWdlKHRoaXMua2V5KTsKICAgICAgfQogICAgfSwKCiAgICBwYXJzZTogZnVuY3Rpb24ocmVzcG9uc2UpIHsKICAgICAgcmV0dXJuIHJlc3BvbnNlOwogICAgfQoKICB9KTsKICAKICByZXR1cm4gSW1hZ2VDb2xsZWN0aW9uOwp9KTsKCmRlZmluZSgncGx1Z2lucy9wbHVnaW5zJyxbXSwgZnVuY3Rpb24oKSB7CiAgCiAgLyoKICAgKiBwb2x5ZmlsbCBmb3IgY29uc29sZQogICAqIEF2b2lkIGBjb25zb2xlYCBlcnJvcnMgaW4gYnJvd3NlcnMgdGhhdCBsYWNrIGEgY29uc29sZS4KICAgKi8KICB2YXIgbWV0aG9kOwogIHZhciBub29wID0gZnVuY3Rpb24gKCkge307CiAgdmFyIG1ldGhvZHMgPSBbCiAgICAnYXNzZXJ0JywgJ2NsZWFyJywgJ2NvdW50JywgJ2RlYnVnJywgJ2RpcicsICdkaXJ4bWwnLCAnZXJyb3InLAogICAgJ2V4Y2VwdGlvbicsICdncm91cCcsICdncm91cENvbGxhcHNlZCcsICdncm91cEVuZCcsICdpbmZvJywgJ2xvZycsCiAgICAnbWFya1RpbWVsaW5lJywgJ3Byb2ZpbGUnLCAncHJvZmlsZUVuZCcsICd0YWJsZScsICd0aW1lJywgJ3RpbWVFbmQnLAogICAgJ3RpbWVTdGFtcCcsICd0cmFjZScsICd3YXJuJwogIF07CiAgdmFyIGxlbmd0aCA9IG1ldGhvZHMubGVuZ3RoOwogIHZhciBjb25zb2xlID0gKHdpbmRvdy5jb25zb2xlID0gd2luZG93LmNvbnNvbGUgfHwge30pOwoKICB3aGlsZSAobGVuZ3RoLS0pIHsKICAgIG1ldGhvZCA9IG1ldGhvZHNbbGVuZ3RoXTsKCiAgICAvLyBPbmx5IHN0dWIgdW5kZWZpbmVkIG1ldGhvZHMuCiAgICBpZiAoIWNvbnNvbGVbbWV0aG9kXSkgewogICAgICBjb25zb2xlW21ldGhvZF0gPSBub29wOwogICAgfQogIH0KICAKICAvKgogICAqIFV0aWxpdHkgZm9yIHBhZGRpbmcgTnVtYmVycywgbGlrZSAxID0+IDAxLgogICAqIHN0b2xlbiBmcm9tOiBodHRwOi8vc3RhY2tvdmVyZmxvdy5jb20vcXVlc3Rpb25zLzEwNjMyMzQ2L2hvdy10by1mb3JtYXQtYS1kYXRlLWluLW1tLWRkLXl5eXktaGhtbXNzLWZvcm1hdC1pbi1qYXZhc2NyaXB0IAogICAqLwogIE51bWJlci5wcm90b3R5cGUucGFkTGVmdCA9IGZ1bmN0aW9uKGJhc2UsY2hyKXsKICAgIHZhciAgbGVuID0gKFN0cmluZyhiYXNlIHx8IDEwKS5sZW5ndGggLSBTdHJpbmcodGhpcykubGVuZ3RoKSsxOwogICAgcmV0dXJuIGxlbiA+IDA/IG5ldyBBcnJheShsZW4pLmpvaW4oY2hyIHx8ICcwJykrdGhpcyA6IHRoaXM7CiAgfTsKICAgCiAgLyoKICAqIHBhcnNlIERhdGUgU3RyaW5nIG1hbnVhbGx5LiBGb3JtYXQ6ICcyMDEzLTA5LTEzIDE1OjAxOjM0IFVUQycgCiAgKiAhISBvbmx5IFVUQyB3b3JrcyBhcyBleHBlY3RlZCAhIQogICovCiAgRGF0ZS5wYXJzZU1hbnVhbGx5ID0gZnVuY3Rpb24oZHMpIHsKICAgIGRzID0gZHMuc3BsaXQoJyAnKTsKICAgIHZhciBkYXRlID0gZHNbMF0uc3BsaXQoJy0nKTsKICAgIHZhciB0aW1lID0gZHNbMV0uc3BsaXQoJzonKTsKICAgIGRhdGUgPSBuZXcgRGF0ZShEYXRlLlVUQygKICAgICAgcGFyc2VJbnQoZGF0ZVswXSwxMCksIHBhcnNlSW50KGRhdGVbMV0sMTApIC0gMSwgcGFyc2VJbnQoZGF0ZVsyXSwxMCksCiAgICAgIHBhcnNlSW50KHRpbWVbMF0sMTApLCBwYXJzZUludCh0aW1lWzFdLDEwKSwgcGFyc2VJbnQodGltZVsyXSwxMCkKICAgICkpOwogICAgcmV0dXJuIGRhdGU7CiAgfTsKIAogIC8vIHBhcnNlVXJpIDEuMi4yCiAgLy8gKGMpIFN0ZXZlbiBMZXZpdGhhbiA8c3RldmVubGV2aXRoYW4uY29tPgogIC8vIE1JVCBMaWNlbnNlCiAgd2luZG93LnBhcnNlVXJpID0gZnVuY3Rpb24oc3RyKSB7CiAgICB2YXIgbyAgID0gd2luZG93LnBhcnNlVXJpLm9wdGlvbnMsCiAgICAgIG0gICA9IG8ucGFyc2VyW28uc3RyaWN0TW9kZSA/ICdzdHJpY3QnIDogJ2xvb3NlJ10uZXhlYyhzdHIpLAogICAgICB1cmkgPSB7fSwKICAgICAgaSAgID0gMTQ7CgogICAgd2hpbGUgKGktLSkge3VyaVtvLmtleVtpXV0gPSBtW2ldIHx8ICcnO30KCiAgICB1cmlbby5xLm5hbWVdID0ge307CiAgICB1cmlbby5rZXlbMTJdXS5yZXBsYWNlKG8ucS5wYXJzZXIsIGZ1bmN0aW9uICgkMCwgJDEsICQyKSB7CiAgICAgIGlmICgkMSkge3VyaVtvLnEubmFtZV1bJDFdID0gJDI7fQogICAgfSk7CgogICAgcmV0dXJuIHVyaTsKICB9OwoKICB3aW5kb3cucGFyc2VVcmkub3B0aW9ucyA9IHsKICAgIHN0cmljdE1vZGU6IGZhbHNlLAogICAga2V5OiBbJ3NvdXJjZScsJ3Byb3RvY29sJywnYXV0aG9yaXR5JywndXNlckluZm8nLCd1c2VyJywncGFzc3dvcmQnLCdob3N0JywncG9ydCcsJ3JlbGF0aXZlJywncGF0aCcsJ2RpcmVjdG9yeScsJ2ZpbGUnLCdxdWVyeScsJ2FuY2hvciddLAogICAgcTogICB7CiAgICAgIG5hbWU6ICAgJ3F1ZXJ5S2V5JywKICAgICAgcGFyc2VyOiAvKD86XnwmKShbXiY9XSopPT8oW14mXSopL2cKICAgIH0sCiAgICBwYXJzZXI6IHsKICAgICAgc3RyaWN0OiAvXig/OihbXjpcLz8jXSspOik/KD86XC9cLygoPzooKFteOkBdKikoPzo6KFteOkBdKikpPyk/QCk/KFteOlwvPyNdKikoPzo6KFxkKikpPykpPygoKCg/OltePyNcL10qXC8pKikoW14/I10qKSkoPzpcPyhbXiNdKikpPyg/OiMoLiopKT8pLywKICAgICAgbG9vc2U6ICAvXig/Oig/IVteOkBdKzpbXjpAXC9dKkApKFteOlwvPyMuXSspOik/KD86XC9cLyk/KCg/OigoW146QF0qKSg/OjooW146QF0qKSk/KT9AKT8oW146XC8/I10qKSg/OjooXGQqKSk/KSgoKFwvKD86W14/I10oPyFbXj8jXC9dKlwuW14/I1wvLl0rKD86Wz8jXXwkKSkpKlwvPyk/KFtePyNcL10qKSkoPzpcPyhbXiNdKikpPyg/OiMoLiopKT8pLwogICAgfQogIH07CiAgIAp9KTsKCi8qCiAqIEphdmFTY3JpcHQgTUQ1IDEuMC4xCiAqIGh0dHBzOi8vZ2l0aHViLmNvbS9ibHVlaW1wL0phdmFTY3JpcHQtTUQ1CiAqCiAqIENvcHlyaWdodCAyMDExLCBTZWJhc3RpYW4gVHNjaGFuCiAqIGh0dHBzOi8vYmx1ZWltcC5uZXQKICoKICogTGljZW5zZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlOgogKiBodHRwOi8vd3d3Lm9wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL01JVAogKiAKICogQmFzZWQgb24KICogQSBKYXZhU2NyaXB0IGltcGxlbWVudGF0aW9uIG9mIHRoZSBSU0EgRGF0YSBTZWN1cml0eSwgSW5jLiBNRDUgTWVzc2FnZQogKiBEaWdlc3QgQWxnb3JpdGhtLCBhcyBkZWZpbmVkIGluIFJGQyAxMzIxLgogKiBWZXJzaW9uIDIuMiBDb3B5cmlnaHQgKEMpIFBhdWwgSm9obnN0b24gMTk5OSAtIDIwMDkKICogT3RoZXIgY29udHJpYnV0b3JzOiBHcmVnIEhvbHQsIEFuZHJldyBLZXBlcnQsIFlkbmFyLCBMb3N0aW5ldAogKiBEaXN0cmlidXRlZCB1bmRlciB0aGUgQlNEIExpY2Vuc2UKICogU2VlIGh0dHA6Ly9wYWpob21lLm9yZy51ay9jcnlwdC9tZDUgZm9yIG1vcmUgaW5mby4KICovCgovKmpzbGludCBiaXR3aXNlOiB0cnVlICovCi8qZ2xvYmFsIHVuZXNjYXBlLCBkZWZpbmUgKi8KCihmdW5jdGlvbiAoJCkgewogICAgCgogICAgLyoKICAgICogQWRkIGludGVnZXJzLCB3cmFwcGluZyBhdCAyXjMyLiBUaGlzIHVzZXMgMTYtYml0IG9wZXJhdGlvbnMgaW50ZXJuYWxseQogICAgKiB0byB3b3JrIGFyb3VuZCBidWdzIGluIHNvbWUgSlMgaW50ZXJwcmV0ZXJzLgogICAgKi8KICAgIGZ1bmN0aW9uIHNhZmVfYWRkKHgsIHkpIHsKICAgICAgICB2YXIgbHN3ID0gKHggJiAweEZGRkYpICsgKHkgJiAweEZGRkYpLAogICAgICAgICAgICBtc3cgPSAoeCA+PiAxNikgKyAoeSA+PiAxNikgKyAobHN3ID4+IDE2KTsKICAgICAgICByZXR1cm4gKG1zdyA8PCAxNikgfCAobHN3ICYgMHhGRkZGKTsKICAgIH0KCiAgICAvKgogICAgKiBCaXR3aXNlIHJvdGF0ZSBhIDMyLWJpdCBudW1iZXIgdG8gdGhlIGxlZnQuCiAgICAqLwogICAgZnVuY3Rpb24gYml0X3JvbChudW0sIGNudCkgewogICAgICAgIHJldHVybiAobnVtIDw8IGNudCkgfCAobnVtID4+PiAoMzIgLSBjbnQpKTsKICAgIH0KCiAgICAvKgogICAgKiBUaGVzZSBmdW5jdGlvbnMgaW1wbGVtZW50IHRoZSBmb3VyIGJhc2ljIG9wZXJhdGlvbnMgdGhlIGFsZ29yaXRobSB1c2VzLgogICAgKi8KICAgIGZ1bmN0aW9uIG1kNV9jbW4ocSwgYSwgYiwgeCwgcywgdCkgewogICAgICAgIHJldHVybiBzYWZlX2FkZChiaXRfcm9sKHNhZmVfYWRkKHNhZmVfYWRkKGEsIHEpLCBzYWZlX2FkZCh4LCB0KSksIHMpLCBiKTsKICAgIH0KICAgIGZ1bmN0aW9uIG1kNV9mZihhLCBiLCBjLCBkLCB4LCBzLCB0KSB7CiAgICAgICAgcmV0dXJuIG1kNV9jbW4oKGIgJiBjKSB8ICgofmIpICYgZCksIGEsIGIsIHgsIHMsIHQpOwogICAgfQogICAgZnVuY3Rpb24gbWQ1X2dnKGEsIGIsIGMsIGQsIHgsIHMsIHQpIHsKICAgICAgICByZXR1cm4gbWQ1X2NtbigoYiAmIGQpIHwgKGMgJiAofmQpKSwgYSwgYiwgeCwgcywgdCk7CiAgICB9CiAgICBmdW5jdGlvbiBtZDVfaGgoYSwgYiwgYywgZCwgeCwgcywgdCkgewogICAgICAgIHJldHVybiBtZDVfY21uKGIgXiBjIF4gZCwgYSwgYiwgeCwgcywgdCk7CiAgICB9CiAgICBmdW5jdGlvbiBtZDVfaWkoYSwgYiwgYywgZCwgeCwgcywgdCkgewogICAgICAgIHJldHVybiBtZDVfY21uKGMgXiAoYiB8ICh+ZCkpLCBhLCBiLCB4LCBzLCB0KTsKICAgIH0KCiAgICAvKgogICAgKiBDYWxjdWxhdGUgdGhlIE1ENSBvZiBhbiBhcnJheSBvZiBsaXR0bGUtZW5kaWFuIHdvcmRzLCBhbmQgYSBiaXQgbGVuZ3RoLgogICAgKi8KICAgIGZ1bmN0aW9uIGJpbmxfbWQ1KHgsIGxlbikgewogICAgICAgIC8qIGFwcGVuZCBwYWRkaW5nICovCiAgICAgICAgeFtsZW4gPj4gNV0gfD0gMHg4MCA8PCAobGVuICUgMzIpOwogICAgICAgIHhbKCgobGVuICsgNjQpID4+PiA5KSA8PCA0KSArIDE0XSA9IGxlbjsKCiAgICAgICAgdmFyIGksIG9sZGEsIG9sZGIsIG9sZGMsIG9sZGQsCiAgICAgICAgICAgIGEgPSAgMTczMjU4NDE5MywKICAgICAgICAgICAgYiA9IC0yNzE3MzM4NzksCiAgICAgICAgICAgIGMgPSAtMTczMjU4NDE5NCwKICAgICAgICAgICAgZCA9ICAyNzE3MzM4Nzg7CgogICAgICAgIGZvciAoaSA9IDA7IGkgPCB4Lmxlbmd0aDsgaSArPSAxNikgewogICAgICAgICAgICBvbGRhID0gYTsKICAgICAgICAgICAgb2xkYiA9IGI7CiAgICAgICAgICAgIG9sZGMgPSBjOwogICAgICAgICAgICBvbGRkID0gZDsKCiAgICAgICAgICAgIGEgPSBtZDVfZmYoYSwgYiwgYywgZCwgeFtpXSwgICAgICAgNywgLTY4MDg3NjkzNik7CiAgICAgICAgICAgIGQgPSBtZDVfZmYoZCwgYSwgYiwgYywgeFtpICsgIDFdLCAxMiwgLTM4OTU2NDU4Nik7CiAgICAgICAgICAgIGMgPSBtZDVfZmYoYywgZCwgYSwgYiwgeFtpICsgIDJdLCAxNywgIDYwNjEwNTgxOSk7CiAgICAgICAgICAgIGIgPSBtZDVfZmYoYiwgYywgZCwgYSwgeFtpICsgIDNdLCAyMiwgLTEwNDQ1MjUzMzApOwogICAgICAgICAgICBhID0gbWQ1X2ZmKGEsIGIsIGMsIGQsIHhbaSArICA0XSwgIDcsIC0xNzY0MTg4OTcpOwogICAgICAgICAgICBkID0gbWQ1X2ZmKGQsIGEsIGIsIGMsIHhbaSArICA1XSwgMTIsICAxMjAwMDgwNDI2KTsKICAgICAgICAgICAgYyA9IG1kNV9mZihjLCBkLCBhLCBiLCB4W2kgKyAgNl0sIDE3LCAtMTQ3MzIzMTM0MSk7CiAgICAgICAgICAgIGIgPSBtZDVfZmYoYiwgYywgZCwgYSwgeFtpICsgIDddLCAyMiwgLTQ1NzA1OTgzKTsKICAgICAgICAgICAgYSA9IG1kNV9mZihhLCBiLCBjLCBkLCB4W2kgKyAgOF0sICA3LCAgMTc3MDAzNTQxNik7CiAgICAgICAgICAgIGQgPSBtZDVfZmYoZCwgYSwgYiwgYywgeFtpICsgIDldLCAxMiwgLTE5NTg0MTQ0MTcpOwogICAgICAgICAgICBjID0gbWQ1X2ZmKGMsIGQsIGEsIGIsIHhbaSArIDEwXSwgMTcsIC00MjA2Myk7CiAgICAgICAgICAgIGIgPSBtZDVfZmYoYiwgYywgZCwgYSwgeFtpICsgMTFdLCAyMiwgLTE5OTA0MDQxNjIpOwogICAgICAgICAgICBhID0gbWQ1X2ZmKGEsIGIsIGMsIGQsIHhbaSArIDEyXSwgIDcsICAxODA0NjAzNjgyKTsKICAgICAgICAgICAgZCA9IG1kNV9mZihkLCBhLCBiLCBjLCB4W2kgKyAxM10sIDEyLCAtNDAzNDExMDEpOwogICAgICAgICAgICBjID0gbWQ1X2ZmKGMsIGQsIGEsIGIsIHhbaSArIDE0XSwgMTcsIC0xNTAyMDAyMjkwKTsKICAgICAgICAgICAgYiA9IG1kNV9mZihiLCBjLCBkLCBhLCB4W2kgKyAxNV0sIDIyLCAgMTIzNjUzNTMyOSk7CgogICAgICAgICAgICBhID0gbWQ1X2dnKGEsIGIsIGMsIGQsIHhbaSArICAxXSwgIDUsIC0xNjU3OTY1MTApOwogICAgICAgICAgICBkID0gbWQ1X2dnKGQsIGEsIGIsIGMsIHhbaSArICA2XSwgIDksIC0xMDY5NTAxNjMyKTsKICAgICAgICAgICAgYyA9IG1kNV9nZyhjLCBkLCBhLCBiLCB4W2kgKyAxMV0sIDE0LCAgNjQzNzE3NzEzKTsKICAgICAgICAgICAgYiA9IG1kNV9nZyhiLCBjLCBkLCBhLCB4W2ldLCAgICAgIDIwLCAtMzczODk3MzAyKTsKICAgICAgICAgICAgYSA9IG1kNV9nZyhhLCBiLCBjLCBkLCB4W2kgKyAgNV0sICA1LCAtNzAxNTU4NjkxKTsKICAgICAgICAgICAgZCA9IG1kNV9nZyhkLCBhLCBiLCBjLCB4W2kgKyAxMF0sICA5LCAgMzgwMTYwODMpOwogICAgICAgICAgICBjID0gbWQ1X2dnKGMsIGQsIGEsIGIsIHhbaSArIDE1XSwgMTQsIC02NjA0NzgzMzUpOwogICAgICAgICAgICBiID0gbWQ1X2dnKGIsIGMsIGQsIGEsIHhbaSArICA0XSwgMjAsIC00MDU1Mzc4NDgpOwogICAgICAgICAgICBhID0gbWQ1X2dnKGEsIGIsIGMsIGQsIHhbaSArICA5XSwgIDUsICA1Njg0NDY0MzgpOwogICAgICAgICAgICBkID0gbWQ1X2dnKGQsIGEsIGIsIGMsIHhbaSArIDE0XSwgIDksIC0xMDE5ODAzNjkwKTsKICAgICAgICAgICAgYyA9IG1kNV9nZyhjLCBkLCBhLCBiLCB4W2kgKyAgM10sIDE0LCAtMTg3MzYzOTYxKTsKICAgICAgICAgICAgYiA9IG1kNV9nZyhiLCBjLCBkLCBhLCB4W2kgKyAgOF0sIDIwLCAgMTE2MzUzMTUwMSk7CiAgICAgICAgICAgIGEgPSBtZDVfZ2coYSwgYiwgYywgZCwgeFtpICsgMTNdLCAgNSwgLTE0NDQ2ODE0NjcpOwogICAgICAgICAgICBkID0gbWQ1X2dnKGQsIGEsIGIsIGMsIHhbaSArICAyXSwgIDksIC01MTQwMzc4NCk7CiAgICAgICAgICAgIGMgPSBtZDVfZ2coYywgZCwgYSwgYiwgeFtpICsgIDddLCAxNCwgIDE3MzUzMjg0NzMpOwogICAgICAgICAgICBiID0gbWQ1X2dnKGIsIGMsIGQsIGEsIHhbaSArIDEyXSwgMjAsIC0xOTI2NjA3NzM0KTsKCiAgICAgICAgICAgIGEgPSBtZDVfaGgoYSwgYiwgYywgZCwgeFtpICsgIDVdLCAgNCwgLTM3ODU1OCk7CiAgICAgICAgICAgIGQgPSBtZDVfaGgoZCwgYSwgYiwgYywgeFtpICsgIDhdLCAxMSwgLTIwMjI1NzQ0NjMpOwogICAgICAgICAgICBjID0gbWQ1X2hoKGMsIGQsIGEsIGIsIHhbaSArIDExXSwgMTYsICAxODM5MDMwNTYyKTsKICAgICAgICAgICAgYiA9IG1kNV9oaChiLCBjLCBkLCBhLCB4W2kgKyAxNF0sIDIzLCAtMzUzMDk1NTYpOwogICAgICAgICAgICBhID0gbWQ1X2hoKGEsIGIsIGMsIGQsIHhbaSArICAxXSwgIDQsIC0xNTMwOTkyMDYwKTsKICAgICAgICAgICAgZCA9IG1kNV9oaChkLCBhLCBiLCBjLCB4W2kgKyAgNF0sIDExLCAgMTI3Mjg5MzM1Myk7CiAgICAgICAgICAgIGMgPSBtZDVfaGgoYywgZCwgYSwgYiwgeFtpICsgIDddLCAxNiwgLTE1NTQ5NzYzMik7CiAgICAgICAgICAgIGIgPSBtZDVfaGgoYiwgYywgZCwgYSwgeFtpICsgMTBdLCAyMywgLTEwOTQ3MzA2NDApOwogICAgICAgICAgICBhID0gbWQ1X2hoKGEsIGIsIGMsIGQsIHhbaSArIDEzXSwgIDQsICA2ODEyNzkxNzQpOwogICAgICAgICAgICBkID0gbWQ1X2hoKGQsIGEsIGIsIGMsIHhbaV0sICAgICAgMTEsIC0zNTg1MzcyMjIpOwogICAgICAgICAgICBjID0gbWQ1X2hoKGMsIGQsIGEsIGIsIHhbaSArICAzXSwgMTYsIC03MjI1MjE5NzkpOwogICAgICAgICAgICBiID0gbWQ1X2hoKGIsIGMsIGQsIGEsIHhbaSArICA2XSwgMjMsICA3NjAyOTE4OSk7CiAgICAgICAgICAgIGEgPSBtZDVfaGgoYSwgYiwgYywgZCwgeFtpICsgIDldLCAgNCwgLTY0MDM2NDQ4Nyk7CiAgICAgICAgICAgIGQgPSBtZDVfaGgoZCwgYSwgYiwgYywgeFtpICsgMTJdLCAxMSwgLTQyMTgxNTgzNSk7CiAgICAgICAgICAgIGMgPSBtZDVfaGgoYywgZCwgYSwgYiwgeFtpICsgMTVdLCAxNiwgIDUzMDc0MjUyMCk7CiAgICAgICAgICAgIGIgPSBtZDVfaGgoYiwgYywgZCwgYSwgeFtpICsgIDJdLCAyMywgLTk5NTMzODY1MSk7CgogICAgICAgICAgICBhID0gbWQ1X2lpKGEsIGIsIGMsIGQsIHhbaV0sICAgICAgIDYsIC0xOTg2MzA4NDQpOwogICAgICAgICAgICBkID0gbWQ1X2lpKGQsIGEsIGIsIGMsIHhbaSArICA3XSwgMTAsICAxMTI2ODkxNDE1KTsKICAgICAgICAgICAgYyA9IG1kNV9paShjLCBkLCBhLCBiLCB4W2kgKyAxNF0sIDE1LCAtMTQxNjM1NDkwNSk7CiAgICAgICAgICAgIGIgPSBtZDVfaWkoYiwgYywgZCwgYSwgeFtpICsgIDVdLCAyMSwgLTU3NDM0MDU1KTsKICAgICAgICAgICAgYSA9IG1kNV9paShhLCBiLCBjLCBkLCB4W2kgKyAxMl0sICA2LCAgMTcwMDQ4NTU3MSk7CiAgICAgICAgICAgIGQgPSBtZDVfaWkoZCwgYSwgYiwgYywgeFtpICsgIDNdLCAxMCwgLTE4OTQ5ODY2MDYpOwogICAgICAgICAgICBjID0gbWQ1X2lpKGMsIGQsIGEsIGIsIHhbaSArIDEwXSwgMTUsIC0xMDUxNTIzKTsKICAgICAgICAgICAgYiA9IG1kNV9paShiLCBjLCBkLCBhLCB4W2kgKyAgMV0sIDIxLCAtMjA1NDkyMjc5OSk7CiAgICAgICAgICAgIGEgPSBtZDVfaWkoYSwgYiwgYywgZCwgeFtpICsgIDhdLCAgNiwgIDE4NzMzMTMzNTkpOwogICAgICAgICAgICBkID0gbWQ1X2lpKGQsIGEsIGIsIGMsIHhbaSArIDE1XSwgMTAsIC0zMDYxMTc0NCk7CiAgICAgICAgICAgIGMgPSBtZDVfaWkoYywgZCwgYSwgYiwgeFtpICsgIDZdLCAxNSwgLTE1NjAxOTgzODApOwogICAgICAgICAgICBiID0gbWQ1X2lpKGIsIGMsIGQsIGEsIHhbaSArIDEzXSwgMjEsICAxMzA5MTUxNjQ5KTsKICAgICAgICAgICAgYSA9IG1kNV9paShhLCBiLCBjLCBkLCB4W2kgKyAgNF0sICA2LCAtMTQ1NTIzMDcwKTsKICAgICAgICAgICAgZCA9IG1kNV9paShkLCBhLCBiLCBjLCB4W2kgKyAxMV0sIDEwLCAtMTEyMDIxMDM3OSk7CiAgICAgICAgICAgIGMgPSBtZDVfaWkoYywgZCwgYSwgYiwgeFtpICsgIDJdLCAxNSwgIDcxODc4NzI1OSk7CiAgICAgICAgICAgIGIgPSBtZDVfaWkoYiwgYywgZCwgYSwgeFtpICsgIDldLCAyMSwgLTM0MzQ4NTU1MSk7CgogICAgICAgICAgICBhID0gc2FmZV9hZGQoYSwgb2xkYSk7CiAgICAgICAgICAgIGIgPSBzYWZlX2FkZChiLCBvbGRiKTsKICAgICAgICAgICAgYyA9IHNhZmVfYWRkKGMsIG9sZGMpOwogICAgICAgICAgICBkID0gc2FmZV9hZGQoZCwgb2xkZCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBbYSwgYiwgYywgZF07CiAgICB9CgogICAgLyoKICAgICogQ29udmVydCBhbiBhcnJheSBvZiBsaXR0bGUtZW5kaWFuIHdvcmRzIHRvIGEgc3RyaW5nCiAgICAqLwogICAgZnVuY3Rpb24gYmlubDJyc3RyKGlucHV0KSB7CiAgICAgICAgdmFyIGksCiAgICAgICAgICAgIG91dHB1dCA9ICcnOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBpbnB1dC5sZW5ndGggKiAzMjsgaSArPSA4KSB7CiAgICAgICAgICAgIG91dHB1dCArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKChpbnB1dFtpID4+IDVdID4+PiAoaSAlIDMyKSkgJiAweEZGKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG91dHB1dDsKICAgIH0KCiAgICAvKgogICAgKiBDb252ZXJ0IGEgcmF3IHN0cmluZyB0byBhbiBhcnJheSBvZiBsaXR0bGUtZW5kaWFuIHdvcmRzCiAgICAqIENoYXJhY3RlcnMgPjI1NSBoYXZlIHRoZWlyIGhpZ2gtYnl0ZSBzaWxlbnRseSBpZ25vcmVkLgogICAgKi8KICAgIGZ1bmN0aW9uIHJzdHIyYmlubChpbnB1dCkgewogICAgICAgIHZhciBpLAogICAgICAgICAgICBvdXRwdXQgPSBbXTsKICAgICAgICBvdXRwdXRbKGlucHV0Lmxlbmd0aCA+PiAyKSAtIDFdID0gdW5kZWZpbmVkOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBvdXRwdXQubGVuZ3RoOyBpICs9IDEpIHsKICAgICAgICAgICAgb3V0cHV0W2ldID0gMDsKICAgICAgICB9CiAgICAgICAgZm9yIChpID0gMDsgaSA8IGlucHV0Lmxlbmd0aCAqIDg7IGkgKz0gOCkgewogICAgICAgICAgICBvdXRwdXRbaSA+PiA1XSB8PSAoaW5wdXQuY2hhckNvZGVBdChpIC8gOCkgJiAweEZGKSA8PCAoaSAlIDMyKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG91dHB1dDsKICAgIH0KCiAgICAvKgogICAgKiBDYWxjdWxhdGUgdGhlIE1ENSBvZiBhIHJhdyBzdHJpbmcKICAgICovCiAgICBmdW5jdGlvbiByc3RyX21kNShzKSB7CiAgICAgICAgcmV0dXJuIGJpbmwycnN0cihiaW5sX21kNShyc3RyMmJpbmwocyksIHMubGVuZ3RoICogOCkpOwogICAgfQoKICAgIC8qCiAgICAqIENhbGN1bGF0ZSB0aGUgSE1BQy1NRDUsIG9mIGEga2V5IGFuZCBzb21lIGRhdGEgKHJhdyBzdHJpbmdzKQogICAgKi8KICAgIGZ1bmN0aW9uIHJzdHJfaG1hY19tZDUoa2V5LCBkYXRhKSB7CiAgICAgICAgdmFyIGksCiAgICAgICAgICAgIGJrZXkgPSByc3RyMmJpbmwoa2V5KSwKICAgICAgICAgICAgaXBhZCA9IFtdLAogICAgICAgICAgICBvcGFkID0gW10sCiAgICAgICAgICAgIGhhc2g7CiAgICAgICAgaXBhZFsxNV0gPSBvcGFkWzE1XSA9IHVuZGVmaW5lZDsKICAgICAgICBpZiAoYmtleS5sZW5ndGggPiAxNikgewogICAgICAgICAgICBia2V5ID0gYmlubF9tZDUoYmtleSwga2V5Lmxlbmd0aCAqIDgpOwogICAgICAgIH0KICAgICAgICBmb3IgKGkgPSAwOyBpIDwgMTY7IGkgKz0gMSkgewogICAgICAgICAgICBpcGFkW2ldID0gYmtleVtpXSBeIDB4MzYzNjM2MzY7CiAgICAgICAgICAgIG9wYWRbaV0gPSBia2V5W2ldIF4gMHg1QzVDNUM1QzsKICAgICAgICB9CiAgICAgICAgaGFzaCA9IGJpbmxfbWQ1KGlwYWQuY29uY2F0KHJzdHIyYmlubChkYXRhKSksIDUxMiArIGRhdGEubGVuZ3RoICogOCk7CiAgICAgICAgcmV0dXJuIGJpbmwycnN0cihiaW5sX21kNShvcGFkLmNvbmNhdChoYXNoKSwgNTEyICsgMTI4KSk7CiAgICB9CgogICAgLyoKICAgICogQ29udmVydCBhIHJhdyBzdHJpbmcgdG8gYSBoZXggc3RyaW5nCiAgICAqLwogICAgZnVuY3Rpb24gcnN0cjJoZXgoaW5wdXQpIHsKICAgICAgICB2YXIgaGV4X3RhYiA9ICcwMTIzNDU2Nzg5YWJjZGVmJywKICAgICAgICAgICAgb3V0cHV0ID0gJycsCiAgICAgICAgICAgIHgsCiAgICAgICAgICAgIGk7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IGlucHV0Lmxlbmd0aDsgaSArPSAxKSB7CiAgICAgICAgICAgIHggPSBpbnB1dC5jaGFyQ29kZUF0KGkpOwogICAgICAgICAgICBvdXRwdXQgKz0gaGV4X3RhYi5jaGFyQXQoKHggPj4+IDQpICYgMHgwRikgKwogICAgICAgICAgICAgICAgaGV4X3RhYi5jaGFyQXQoeCAmIDB4MEYpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gb3V0cHV0OwogICAgfQoKICAgIC8qCiAgICAqIEVuY29kZSBhIHN0cmluZyBhcyB1dGYtOAogICAgKi8KICAgIGZ1bmN0aW9uIHN0cjJyc3RyX3V0ZjgoaW5wdXQpIHsKICAgICAgICByZXR1cm4gdW5lc2NhcGUoZW5jb2RlVVJJQ29tcG9uZW50KGlucHV0KSk7CiAgICB9CgogICAgLyoKICAgICogVGFrZSBzdHJpbmcgYXJndW1lbnRzIGFuZCByZXR1cm4gZWl0aGVyIHJhdyBvciBoZXggZW5jb2RlZCBzdHJpbmdzCiAgICAqLwogICAgZnVuY3Rpb24gcmF3X21kNShzKSB7CiAgICAgICAgcmV0dXJuIHJzdHJfbWQ1KHN0cjJyc3RyX3V0ZjgocykpOwogICAgfQogICAgZnVuY3Rpb24gaGV4X21kNShzKSB7CiAgICAgICAgcmV0dXJuIHJzdHIyaGV4KHJhd19tZDUocykpOwogICAgfQogICAgZnVuY3Rpb24gcmF3X2htYWNfbWQ1KGssIGQpIHsKICAgICAgICByZXR1cm4gcnN0cl9obWFjX21kNShzdHIycnN0cl91dGY4KGspLCBzdHIycnN0cl91dGY4KGQpKTsKICAgIH0KICAgIGZ1bmN0aW9uIGhleF9obWFjX21kNShrLCBkKSB7CiAgICAgICAgcmV0dXJuIHJzdHIyaGV4KHJhd19obWFjX21kNShrLCBkKSk7CiAgICB9CgogICAgZnVuY3Rpb24gbWQ1KHN0cmluZywga2V5LCByYXcpIHsKICAgICAgICBpZiAoIWtleSkgewogICAgICAgICAgICBpZiAoIXJhdykgewogICAgICAgICAgICAgICAgcmV0dXJuIGhleF9tZDUoc3RyaW5nKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcmF3X21kNShzdHJpbmcpOwogICAgICAgIH0KICAgICAgICBpZiAoIXJhdykgewogICAgICAgICAgICByZXR1cm4gaGV4X2htYWNfbWQ1KGtleSwgc3RyaW5nKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJhd19obWFjX21kNShrZXksIHN0cmluZyk7CiAgICB9CgogICAgaWYgKHR5cGVvZiBkZWZpbmUgPT09ICdmdW5jdGlvbicgJiYgZGVmaW5lLmFtZCkgewogICAgICAgIGRlZmluZSgnbWQ1JyxbXSxmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiBtZDU7CiAgICAgICAgfSk7CiAgICB9IGVsc2UgewogICAgICAgICQubWQ1ID0gbWQ1OwogICAgfQp9KHRoaXMpKTsKCi8qIGdsb2JhbCBwYXJzZVVyaSAqLwovKgogKiBHYWxsZXJ5TW9kZWwKICogLS0tLS0tLS0tLQogKi8KZGVmaW5lKCdnYWxsZXJ5L21vZGVscy9nYWxsZXJ5Lm1vZGVsJyxbCiAgJ3VuZGVyc2NvcmUnLAogICdiYWNrYm9uZScsCiAgJ2dhbGxlcnkvY29sbGVjdGlvbnMvaW1hZ2UuY29sbGVjdGlvbicsCiAgJ3BsdWdpbnMvcGx1Z2lucycsCiAgJ21kNScKXSwKICBmdW5jdGlvbihfLCBCYWNrYm9uZSwgSW1hZ2VDb2xsZWN0aW9uLCBub3BlLCBtZDUpIHsKCiAgdmFyIEdhbGxlcnlNb2RlbCA9IEJhY2tib25lLk1vZGVsLmV4dGVuZCh7CgogICAgLy8gbG9jYWwgb3IgcmVtb3RlCiAgICB1cmw6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gdGhpcy5nZXQoJ3NyYycpOwogICAgfSwKCiAgICAvLyBEZWZhdWx0IGF0dHJpYnV0ZXMgZm9yIHRoZSBnYWxsZXJ5LiB0aGV5IGdldCBhdXRvbWF0aWNhbGx5IHdpcmVkIGJlZm9yZSAKICAgIC8vIGluaXRpYWxpemUgY2FsbC4KICAgIGRlZmF1bHRzOiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICBzcmM6ICcnLAogICAgICAgIHRpdGxlOiAnJywKICAgICAgICBpbWFnZV9wYWdlczogZmFsc2UsCiAgICAgICAgcHJlc2V0czogewogICAgICAgICAgdGh1bWI6IHsKICAgICAgICAgICAgd2lkdGg6IDMwMAogICAgICAgICAgfSwKICAgICAgICAgIGxhcmdlOiB7CiAgICAgICAgICAgIHdpZHRoOiA4MDAKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGltYWdlczogdW5kZWZpbmVkCiAgICAgIH07CiAgICB9LAoKICAgIC8vIFRoZXNlIGFyZSB0aGUgZmFsbGJhY2sgT3B0aW9ucywgaWYgbmVpdGhlciB0aGUganNvbiwgbm9yIHRoZSBtYXJrdXAgZ2l2ZXMgCiAgICAvLyB1cyBhbnkuCiAgICBkZWZhdWx0T3B0czogewogICAgICBtaW5fY29sX3dpZHRoOiB7IC8vIGpzaGludCBpZ25vcmU6bGluZQogICAgICAgIGRlc2t0b3A6IDMyMCwKICAgICAgICBwYWQ6IDMyMCwKICAgICAgICBwaG9uZTogMzAwCiAgICAgIH0sCiAgICAgIGd1dHRlcl93aWR0aDogMywgLy8ganNoaW50IGlnbm9yZTpsaW5lCiAgICAgIGNodW5rX3NpemU6IDgsIC8vIGpzaGludCBpZ25vcmU6bGluZQogICAgICBmaXJzdF9jaHVuazogMTUsIC8vIGpzaGludCBpZ25vcmU6bGluZQogICAgICBkb3VibGVfdGFwX3RodW1iOiBmYWxzZSAvLyBqc2hpbnQgaWdub3JlOmxpbmUKICAgIH0sCiAgICAKICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLmlkID0gbWQ1KHRoaXMuZ2V0KCdzcmMnKSk7CiAgICAgIHRoaXMuc2xpZGVyU3RhdGUgPSAnY2xvc2VkJzsKICAgICAgdGhpcy5fY3VycmVudCA9IHVuZGVmaW5lZDsKICAgIH0sCiAgICAKICAgIHBhcnNlOiBmdW5jdGlvbihyZXNwb25zZSkgewogICAgICB2YXIgZ2FsbGVyeUhhc2ggPSByZXNwb25zZS5nYWxsZXJ5OwogICAgICAvLyBJbml0IENvbGxlY3Rpb24gd2l0aCByZXNwb25zZSBIYXNoCiAgICAgIGdhbGxlcnlIYXNoLmltYWdlcyA9IG5ldyBJbWFnZUNvbGxlY3Rpb24oZ2FsbGVyeUhhc2guaW1hZ2VzLCB7CiAgICAgICAgcHJlc2V0czogdGhpcy5fcGFyc2VQcmVzZXRzKGdhbGxlcnlIYXNoLnByZXNldHMpLAogICAgICAgIGdhbGxlcnk6IHsKICAgICAgICAgIGJhc2VwYXRoOiBnYWxsZXJ5SGFzaC5wb3N0QmFzZXBhdGgsCiAgICAgICAgICBiYXNldXJsOiBnYWxsZXJ5SGFzaC5wb3N0QmFzZXVybCwKICAgICAgICAgIHBhdGg6IGdhbGxlcnlIYXNoLnBvc3RQYXRoLAogICAgICAgICAgaW1hZ2VQYWdlczogZ2FsbGVyeUhhc2guaW1hZ2VQYWdlcwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIC8vIFByZWNlZGVuY2UgaW4gdGhlc2Ugb3B0aW9uczoKICAgICAgLy8gMSkgb3B0aW9ucyBnaXZlbiBhcyBhdHRyaWJ1dGVzIGludG8gdGhlIGNvbnN0cnVjdG9yICh0aGUgb25lcyB3cml0dGVuIGluIGRhdGEtYXR0cmlidXRlcykKICAgICAgLy8gMikgb3B0aW9ucyBjb21pbmcgd2l0aCB0aGUgZmV0Y2hlZCBqc29uIGRhdGEKICAgICAgLy8gMykgZGVmYXVsdCBvcHRpb25zCiAgICAgIGdhbGxlcnlIYXNoLm9wdHMgPSBfLmV4dGVuZCh7fSwgCiAgICAgICAgdGhpcy5kZWZhdWx0T3B0cywgZ2FsbGVyeUhhc2gub3B0cywgdGhpcy5hdHRyaWJ1dGVzLm9wdHMpOwoKICAgICAgcmV0dXJuIGdhbGxlcnlIYXNoOwogICAgfSwKCiAgICBfcGFyc2VQcmVzZXRzOiBmdW5jdGlvbihwcmVzZXRIYXNoKSB7CiAgICAgIF8uZm9yRWFjaChwcmVzZXRIYXNoLCBmdW5jdGlvbihwcmVzZXQsIHByZXNldEtleSkgewogICAgICAgIC8vIG5vcm1hbGl6ZSBiYXNlVXJsIChjYW4gYWxzbyBiZSBhIHBhdGggaW4gdGhlIHBhcnNlZCBqc29uKQogICAgICAgIHZhciBiYXNlVXJsID0gcHJlc2V0WydiYXNldXJsJ107CiAgICAgICAgaWYgKCFiYXNlVXJsLm1hdGNoKC9odHRwOlwvXC98aHR0cHM6XC9cLy8pKSB7CiAgICAgICAgICB2YXIgdXJpID0gcGFyc2VVcmkod2luZG93LmxvY2F0aW9uLmhyZWYpOwogICAgICAgICAgdmFyIHJvb3QgPSB1cmkucHJvdG9jb2wrICc6Ly8nICsgdXJpLmhvc3QgKyAodXJpLnBvcnQgPyAnOicgKyB1cmkucG9ydCA6ICcnKTsKICAgICAgICAgIGlmIChiYXNlVXJsLmluZGV4T2YoJy8nKSA9PT0gMCkgeyAvLyBhYnNvbHV0ZSBwYXRoCiAgICAgICAgICAgIHByZXNldFsnYmFzZXVybCddID0gcm9vdCArIGJhc2VVcmw7CiAgICAgICAgICB9IGVsc2UgeyAvLyByZWxhdGl2ZSBwYXRoCiAgICAgICAgICAgIHByZXNldFsnYmFzZXVybCddID0gcm9vdCArIHVyaS5kaXJlY3RvcnkgKyBiYXNlVXJsOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICAgIHJldHVybiBwcmVzZXRIYXNoOwogICAgfSwKICAgIAogICAgdG9nZ2xlU2xpZGVyU3RhdGU6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLnNsaWRlclN0YXRlID0gKHRoaXMuc2xpZGVyU3RhdGUgPT09ICdjbG9zZWQnID8gJ29wZW5lZCcgOiAnY2xvc2VkJyk7CiAgICB9LAoKICAgIHNldEN1cnJlbnQ6IGZ1bmN0aW9uKGltYWdlTW9kZWwpIHsKICAgICAgdGhpcy5fY3VycmVudCA9IGltYWdlTW9kZWw7CiAgICB9LAogICAgCiAgICAvLyBJbWFnZU1vZGVsIGluc3RhbmNlCiAgICBnZXRDdXJyZW50OiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHRoaXMuX2N1cnJlbnQ7CiAgICB9LAogICAgCiAgICAvLyBJbWFnZU1vZGVsIGluc3RhbmNlCiAgICBnZXROZXh0OiBmdW5jdGlvbigpIHsKICAgICAgaWYgKHRoaXMuX2N1cnJlbnQpIHsKICAgICAgICB2YXIgaW1hZ2VzID0gdGhpcy5hdHRyaWJ1dGVzLmltYWdlczsKICAgICAgICB2YXIgY3VycmVudEluZGV4ID0gdGhpcy5fY3VycmVudC5pbmRleCgpOwogICAgICAgIGlmIChjdXJyZW50SW5kZXggPCBpbWFnZXMubGVuZ3RoLTEpIHsKICAgICAgICAgIHJldHVybiBpbWFnZXMuYXQoY3VycmVudEluZGV4ICsgMSk7CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgCiAgICAvLyBJbWFnZU1vZGVsIGluc3RhbmNlCiAgICBnZXRQcmV2OiBmdW5jdGlvbigpIHsKICAgICAgaWYgKHRoaXMuX2N1cnJlbnQpIHsKICAgICAgICB2YXIgY3VycmVudEluZGV4ID0gdGhpcy5fY3VycmVudC5pbmRleCgpOwogICAgICAgIGlmIChjdXJyZW50SW5kZXggPiAwKSB7CiAgICAgICAgICByZXR1cm4gdGhpcy5hdHRyaWJ1dGVzLmltYWdlcy5hdChjdXJyZW50SW5kZXggLSAxKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9KTsKICAKICByZXR1cm4gR2FsbGVyeU1vZGVsOwogIAp9KTsKCi8qIFNlbGVjdGlvbkNvbGxlY3Rpb24KICogLS0tLS0tLS0tLS0tLS0tCiAqCiAqIEEgY29sbGVjdGlvbiBvZiBzZWxlY3RlZCBJbWFnZU1vZGVsIG9iamVjdHMuIEl0IGdldHMgc2F2ZWQgaW4gbG9jYWxTdG9yYWdlIG9mCiAqIHRoZSBjbGllbnQgYnJvd3Nlci4KICoKICovCmRlZmluZSgnZ2FsbGVyeS9jb2xsZWN0aW9ucy9zZWxlY3Rpb24uY29sbGVjdGlvbicsWwogICd1bmRlcnNjb3JlJywKICAnYmFja2JvbmUnLAogICdsb2NhbHN0b3JhZ2UnLAogICdnYWxsZXJ5L21vZGVscy9pbWFnZS5tb2RlbCcKXSwKZnVuY3Rpb24gKF8sIEJhY2tib25lLCBub3BlLCBJbWFnZU1vZGVsKSB7CiAgICAKICAgIHZhciBTZWxlY3Rpb25Db2xsZWN0aW9uID0gQmFja2JvbmUuQ29sbGVjdGlvbi5leHRlbmQoewoKICAgICAgLy8gUmVmZXJlbmNlIHRvIHRoaXMgY29sbGVjdGlvbidzIG1vZGVsLgogICAgICBtb2RlbDogSW1hZ2VNb2RlbCwKCiAgICAgIC8qKgogICAgICAgKiBMb2NhbFN0b3JhZ2UgSW1hZ2VNb2RlbCBDb2xsZWN0aW9uIGdpdmVuIGJ5IGFuIGV4cGxpY2l0IGtleSAoYGBvcHRpb25zLmtleWBgKSAKICAgICAgICogb3IsIHdoZW4gdGhlIGtleSBpcyBhIGJvb2xlYW4sIGJ5IHRoZSBpZCBvZiB0aGUgZ2l2ZW4gR2FsbGVyeU1vZGVsIAogICAgICAgKiAoYGBvcHRpb25zLmdhbGxlcnlgYCkuIAogICAgICAgKiBUaGUgQ29sbGVjdGlvbiBnZXRzIGNvbm5lY3RlZCB3aXRoIHRoZSBnaXZlbiBHYWxsZXJ5TW9kZWw6IAogICAgICAgKiBPbmNlIGl0J3MgSW1hZ2VzIGFyZSBsb2FkZWQsIHRoZSBzZWxlY3Rpb24gaXMgZmV0Y2hlZCBmcm9tIHRoZSAKICAgICAgICogbG9jYWxTdG9yYWdlIGFuZCB0aGUgR2FsbGVyeU1vZGVsIGltYWdlcyBhcmUgbWFya2VkIGBgc2VsZWN0ZWRgYCwgaWYgdGhleQogICAgICAgKiBhcmUgaW4gdGhlIFNlbGVjdGlvbi4gVGhlbiB0aGUgYGBzZWxlY3RlZGBgIGF0dHJpYnV0ZSBvZiB0aGUgR2FsbGVyeU1vZGVsCiAgICAgICAqIGltYWdlcyBhcmUgd2F0Y2hlZCwgc28gdGhhdCB0aGUgc2VsZWN0aW9uIGNvbnRhaW5zIG9ubHkgc2VsZWN0ZWQgaW1hZ2VzLgogICAgICAgKgogICAgICAgKiBJZiBgYG9wdGlvbnMuZ2FsbGVyeWBgIGlzIHVuZGVmaW5lZCwgdGhlIGNvbGxlY3Rpb24gaGFzIHRvIGJlIGZldGNoZWQKICAgICAgICogbWFudWFsbHkuCiAgICAgICAqKi8KICAgICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24gKG1vZGVscywgb3B0aW9ucykgewogICAgICAgIC8vIGNvbm5lY3QgZ2FsbGVyeSBhbmQgc2VsZWN0aW9uCiAgICAgICAgaWYgKG9wdGlvbnMuZ2FsbGVyeSkgewogICAgICAgICAgdGhpcy5nYWxsZXJ5ID0gb3B0aW9ucy5nYWxsZXJ5OwogICAgICAgICAgdGhpcy5nYWxsZXJ5LnNldCgnc2VsZWN0aW9uJywgdGhpcyk7CiAgICAgICAgfQoKICAgICAgICAvLyBBIGlkIGFuZCBrZXkgZm9yIGlkZW50aWZ5aW5nIHRoZSBTZWxlY3Rpb24KICAgICAgICB0aGlzLmtleSA9IHR5cGVvZihvcHRpb25zLmtleSkgPT09ICdib29sZWFuJyA/CiAgICAgICAgICB0aGlzLmdhbGxlcnkuaWQgOiAgLy8gaWRlbnRpZmllZCBieSB0aGUgZ2l2ZW4gR2FsbGVyeQogICAgICAgICAgb3B0aW9ucy5rZXk7IC8vIGlkZW50aWZpZWQgYnkgYSBnaXZlbiBrZXkKCiAgICAgICAgLy8gU2VsZWN0aW9uIGlzIHNhdmVkIGluIGxvY2FsU3RvcmFnZQogICAgICAgIHRoaXMubG9jYWxTdG9yYWdlID0gbmV3IEJhY2tib25lLkxvY2FsU3RvcmFnZSgnR2FsbGVyeVNlbGVjdGlvbi0nICsgdGhpcy5rZXkpOwoKICAgICAgICAvLyB3YWl0IGZvciB0aGUgSW1hZ2VDb2xsZWN0aW9uIHRvIGJlIGZldGNoZWQgCiAgICAgICAgLy8gPT4gbGlzdGVuVG8gaXQgJiBmZXRjaCBzZWxlY3Rpb24gZnJvbSBsb2NhbFN0b3JhZ2UKICAgICAgICBpZiAodGhpcy5nYWxsZXJ5KSB7CiAgICAgICAgICB0aGlzLmxpc3RlblRvT25jZSh0aGlzLmdhbGxlcnksICdjaGFuZ2UnLCB0aGlzLmluaXRHYWxsZXJ5KTsKICAgICAgICB9IAogICAgICB9LAoKICAgICAgLy8gQ2FsbGVkLCB3aGVuIHRoZSBHYWxsZXJ5TW9kZWwgaXMgaW5pdGlhbGl6ZWQvbG9hZGVkCiAgICAgIC8vIE5vdyB3ZSBjYW4gCiAgICAgIC8vIC0gZmV0Y2ggdGhpcyBzZWxlY3Rpb24gZnJvbSB0aGUgbG9jYWxTdG9yYWdlIGFuZCBtYXJrIGFsbCBpdCdzIGltYWdlcwogICAgICAvLyAgIGFzIHNlbGVjdGVkIGluIHRoZSBJbWFnZUNvbGxlY3Rpb24gb2YgdGhlIEdhbGxlcnlNb2RlbC4KICAgICAgLy8gLSBsaXN0ZW4gdG8gYW55IGNoYW5nZXMgdG8gdGhlICdzZWxlY3RlZCcgYXR0cmlidXRlIG9mIHRoZSBJbWFnZU1vZGVscwogICAgICAvLyAgIGluIHRoZSBHYWxsZXJ5LgogICAgICBpbml0R2FsbGVyeTogZnVuY3Rpb24oKSB7CiAgICAgICAgLy8gYmVmb3JlIHdlIHNldHVwIHRoZSBjaGFuZ2UtbGlzdGVuZXIsIGVsc2Ugd2UgaGF2ZSAxIHN1cGVyZmx1b3MgCiAgICAgICAgLy8gY2FsbGJhY2stcm91bmR0cmlwCiAgICAgICAgdGhpcy5mZXRjaCgpOwoKICAgICAgICB0aGlzLmxpc3RlblRvKAogICAgICAgICAgdGhpcy5nYWxsZXJ5LmdldCgnaW1hZ2VzJyksICdjaGFuZ2U6c2VsZWN0ZWQnLCB0aGlzLnNlbGVjdGlvbkNoYW5nZWQpOwogICAgICB9LAoKICAgICAgLy8gQ2FsbGVkIGJ5IFNlbGVjdGlvbkNvbGxlY3Rpb24jZmV0Y2gKICAgICAgLy8gTWFya3MgYWxsIHRoZSBmZXRjaGVkIGltYWdlcyBhcyBzZWxlY3RlZCBpbiB0aGUgSW1hZ2VDb2xsZWN0aW9uIG9mIHRoZSAKICAgICAgLy8gR2FsbGVyeU1vZGVsLgogICAgICBwYXJzZTogZnVuY3Rpb24ocmVzcG9uc2UpIHsKICAgICAgICBpZiAodGhpcy5nYWxsZXJ5KSB7CiAgICAgICAgICB2YXIgZ2FsbGVyeUltYWdlcyA9IHRoaXMuZ2FsbGVyeS5nZXQoJ2ltYWdlcycpOwogICAgICAgICAgXy5lYWNoKHJlc3BvbnNlLCBmdW5jdGlvbihzZWxlY3Rpb25Nb2RlbCkgewogICAgICAgICAgICB2YXIgaW1hZ2VNb2RlbCA9IGdhbGxlcnlJbWFnZXMuZ2V0KHNlbGVjdGlvbk1vZGVsLmRpZ2VzdCk7CiAgICAgICAgICAgIGlmIChpbWFnZU1vZGVsKSB7CiAgICAgICAgICAgICAgaW1hZ2VNb2RlbC5zZXQoJ3NlbGVjdGVkJywgdHJ1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0sIHRoaXMpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzcG9uc2U7CiAgICAgIH0sCgogICAgICBzZWxlY3Rpb25DaGFuZ2VkOiBmdW5jdGlvbihpbWFnZU1vZGVsLCBzZWxlY3RlZCkgewogICAgICAgIHZhciBzZWxlY3Rpb25Nb2RlbCA9IHRoaXMuZ2V0KGltYWdlTW9kZWwuaWQpOwogICAgICAgIGlmIChzZWxlY3RlZCAmJiAhc2VsZWN0aW9uTW9kZWwpIHsKICAgICAgICAgIHZhciBzZWxlY3RlZEltYWdlID0gaW1hZ2VNb2RlbC5jbG9uZSgpOwogICAgICAgICAgLy8gc2VsZWN0ZWQgaW1hZ2VzIGhhdmUgbm8gZml4ZWQgaW5kZXgsIHRoZXkgYXJlIHNvcnRlZCBieSB0aGVpciBpbnNlcnQtCiAgICAgICAgICAvLyBvcmRlciwgYnV0IGNhbiBiZSByZW1vdmVkIGFnYWluIGxhdGVyLCBzbyBubyBpbmRleCBpcyBzdG9yZWQKICAgICAgICAgIC8vIHNlZSBJbWFnZU1vZGVsI2luZGV4CiAgICAgICAgICBzZWxlY3RlZEltYWdlLnNldCgnaW5kZXgnLCB1bmRlZmluZWQpOwogICAgICAgICAgdGhpcy5hZGQoc2VsZWN0ZWRJbWFnZSk7CiAgICAgICAgICBzZWxlY3RlZEltYWdlLnNhdmUoKTsKICAgICAgICB9IGVsc2UgaWYgKHNlbGVjdGlvbk1vZGVsKSB7CiAgICAgICAgICBzZWxlY3Rpb25Nb2RlbC5kZXN0cm95KCk7CiAgICAgICAgfQogICAgICB9CiAgICB9LCB7CiAgICAgIC8vIHN0YXRpYyBtZW1iZXJzCgogICAgICBfcG9vbDoge30sCgogICAgICAvLyBPbmx5IG9uIGluc3RhbmNlIHBlciBrZXkgYW5kIGdhbGxlcnkKICAgICAgZ2V0OiBmdW5jdGlvbihrZXksIGdhbGxlcnkpIHsKICAgICAgICB2YXIgX2tleSA9IGtleSArICcjJyArIChnYWxsZXJ5ICE9PSB1bmRlZmluZWQgPyBnYWxsZXJ5LmlkIDogJ25peEdhbGxlcnknKTsKICAgICAgICBpZiAoIV8uaGFzKHRoaXMuX3Bvb2wsIF9rZXkpKSB7CiAgICAgICAgICB0aGlzLl9wb29sW19rZXldID0gbmV3IFNlbGVjdGlvbkNvbGxlY3Rpb24oW10sIHtrZXk6IGtleSwgZ2FsbGVyeTogZ2FsbGVyeX0pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdGhpcy5fcG9vbFtfa2V5XTsKICAgICAgfQogICAgfSk7CiAgICAKICAgIHJldHVybiBTZWxlY3Rpb25Db2xsZWN0aW9uOwogIH0KKTsKCi8qCiAqIFNlbGVjdGlvbkdhbGxlcnlNb2RlbAogKiAtLS0tLS0tLS0tCiAqLwpkZWZpbmUoJ2dhbGxlcnkvbW9kZWxzL3NlbGVjdGlvbi5nYWxsZXJ5Lm1vZGVsJyxbCiAgJ3VuZGVyc2NvcmUnLAogICdnYWxsZXJ5L21vZGVscy9nYWxsZXJ5Lm1vZGVsJywKICAnZ2FsbGVyeS9jb2xsZWN0aW9ucy9pbWFnZS5jb2xsZWN0aW9uJywKICAnZ2FsbGVyeS9jb2xsZWN0aW9ucy9zZWxlY3Rpb24uY29sbGVjdGlvbicKXSwKICBmdW5jdGlvbihfLCBHYWxsZXJ5TW9kZWwsIEltYWdlQ29sbGVjdGlvbiwgU2VsZWN0aW9uQ29sbGVjdGlvbikgewoKICB2YXIgU2VsZWN0aW9uR2FsbGVyeU1vZGVsID0gR2FsbGVyeU1vZGVsLmV4dGVuZCh7CiAgICAKICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uKCkgewogICAgICBHYWxsZXJ5TW9kZWwucHJvdG90eXBlLmluaXRpYWxpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgCiAgICAgIHRoaXMuaWQgPSB0aGlzLmdldCgna2V5Jyk7CiAgICB9LAoKICAgIC8vIE92ZXJyaWRlIGZldGNoIHRvIG9ubHkgZmV0Y2ggc2VsZWN0aW9uCiAgICBmZXRjaDogZnVuY3Rpb24ob3B0cykgewogICAgICAvLyBJcyB0aGUgc2VsZWN0aW9uIGFscmVhZHkgcmVnaXN0ZXJlZCBvbiB0aGlzIEdhbGxlcnlNb2RlbD8KICAgICAgdmFyIGdhbGxlcnlTZWxlY3Rpb24gPSB0aGlzLmdldCgnc2VsZWN0aW9uJyk7CiAgICAgIGlmIChnYWxsZXJ5U2VsZWN0aW9uICYmIGdhbGxlcnlTZWxlY3Rpb24ua2V5ID09PSB0aGlzLmlkKSB7CiAgICAgICAgdGhpcy5hdHRyaWJ1dGVzWydpbWFnZXMnXSA9IGdhbGxlcnlTZWxlY3Rpb247ICAKICAgICAgfSBlbHNlIHsgLy8gbm8sIHdlIGhhdmUgdG8gaW5pdGlhbGl6ZSBhIG5ldyBTZWxlY3Rpb25Db2xsZWN0aW9uCiAgICAgICAgbmV3IFNlbGVjdGlvbkNvbGxlY3Rpb24oW10sIHsKICAgICAgICAgIGdhbGxlcnk6IHRoaXMsCiAgICAgICAgICBrZXk6IHRoaXMuaWQKICAgICAgICB9KTsKICAgICAgfQogICAgICAKICAgICAgLy8gR2FsbGVyeSBkZWZhdWx0IG9wdGlvbnMgbWVyZ2VkIHdpdGggYXR0cmlidXRlLW9wdHMKICAgICAgdGhpcy5hdHRyaWJ1dGVzWydvcHRzJ10gPSBfLmV4dGVuZCh7fSwgdGhpcy5kZWZhdWx0T3B0cywgdGhpcy5hdHRyaWJ1dGVzLm9wdHMpOwoKICAgICAgLy8gZmV0Y2ggbG9jYWwgSW1hZ2VDb2xsZWN0aW9uIGFuZCBwcm9wYWdhdGUgZ2l2ZW4gY2FsbGJhY2tzCiAgICAgIHRoaXMuYXR0cmlidXRlc1snaW1hZ2VzJ10uZmV0Y2goewogICAgICAgIHN1Y2Nlc3M6IF8uYmluZChmdW5jdGlvbiAoY29sbGVjdGlvbiwgcmVzcCwgX29wdHMpIHsKICAgICAgICAgIGlmIChvcHRzLnN1Y2Nlc3MpIHsgb3B0cy5zdWNjZXNzKHRoaXMsIHJlc3AsIG9wdHMpOyB9CiAgICAgICAgICB0aGlzLnRyaWdnZXIoJ2NoYW5nZScpOwogICAgICAgIH0sIHRoaXMpLAogICAgICAgIGVycm9yOiBvcHRzLmVycm9yCiAgICAgIH0pOwogICAgfQoKICB9KTsKICAKICByZXR1cm4gU2VsZWN0aW9uR2FsbGVyeU1vZGVsOwogIAp9KTsKCmRlZmluZSgnZ2FsbGVyeS9tb2RlbHMvZ2FsbGVyeS5mYWN0b3J5JyxbCiAgJ3VuZGVyc2NvcmUnLAogICdnYWxsZXJ5L21vZGVscy9nYWxsZXJ5Lm1vZGVsJywKICAnZ2FsbGVyeS9tb2RlbHMvc2VsZWN0aW9uLmdhbGxlcnkubW9kZWwnCl0sIGZ1bmN0aW9uIChfLCBHYWxsZXJ5TW9kZWwsIFNlbGVjdGlvbkdhbGxlcnlNb2RlbCkgewoKICB2YXIgR2FsbGVyeUZhY3RvcnkgPSBmdW5jdGlvbigpIHsKICAgIAogICAgLyoqCiAgICAgKiBGYWN0b3J5IG1ldGhvZDogcmV0dXJucyBhbiBpbml0aWFsaXplZCBHYWxsZXJ5TW9kZWwgb2JqZWN0IG9mIHRoZSAKICAgICAqIGFwcHJvcHJpYXRlIEdhbGxlcnlNb2RlbCBjbGFzcy4KICAgICAqLwogICAgZnVuY3Rpb24gY3JlYXRlKCRlbCwgb3B0cykgewoKICAgICAgLy8gZ2V0IEdhbGxlcnkgc291cmNlCiAgICAgIHZhciBzcmMgPSBfZ2V0U291cmNlKCRlbCk7CgogICAgICAvLyBpbml0aWFsaXplIEdhbGxlcnlNb2RlbAogICAgICBpZiAoc3JjICE9PSB1bmRlZmluZWQpIHsKICAgICAgICB2YXIgbW9kZWw7CiAgICAgICAgdmFyIGdhbGxlcnlPcHRzID0gXy5leHRlbmQoe30sICRlbC5kYXRhKCdnYWwtb3B0cycpIHx8ICRlbC5kYXRhKCdvcHRzJyksIG9wdHMpOwogICAgICAgIGlmIChzcmMuaW5kZXhPZignc2VsZWN0aW9uOicpIDwgMCkgewogICAgICAgICAgbW9kZWwgPSBuZXcgR2FsbGVyeU1vZGVsKHsKICAgICAgICAgICAgc3JjOiBzcmMsCiAgICAgICAgICAgIG9wdHM6IGdhbGxlcnlPcHRzCiAgICAgICAgICB9KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgbW9kZWwgPSBuZXcgU2VsZWN0aW9uR2FsbGVyeU1vZGVsKHsKICAgICAgICAgICAga2V5OiBzcmMucmVwbGFjZSgnc2VsZWN0aW9uOicsICcnKSwKICAgICAgICAgICAgb3B0czogZ2FsbGVyeU9wdHMKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbW9kZWw7CiAgICAgIH0KCiAgICB9CgogICAgLy8gZXh0cmFjdHMgdGhlIGNvcnJlY3RzIGRhdGEgYXR0cmlidXRlIGZvciB0aGUgR2FsbGVyeSBtb2RlbCB0byBiZSAKICAgIC8vIGluc3RhbmNpYXRlZC4KICAgIGZ1bmN0aW9uIF9nZXRTb3VyY2UoJGVsKSB7CiAgICAgIHZhciBzcmMgPSAkZWwuZGF0YSgnZ2FsLXNyYycpIHx8ICRlbC5kYXRhKCdzcmMnKTsKICAgICAgaWYgKHNyYyA9PT0gdW5kZWZpbmVkKSB7IC8vIGhhbmRsZSBkZXByZWNhdGVkICdwcm9qZWN0JyBvcHRpb24KICAgICAgICBpZiAoJGVsLmRhdGEoJ3Byb2plY3QnKSkgewogICAgICAgICAgc3JjID0gJGVsLmRhdGEoJ3Byb2plY3QnKSArICcuanNvbic7CiAgICAgICAgICBjb25zb2xlLndhcm4oJyJkYXRhLXByb2plY3QiIGFzIGEgZGF0YSBzb3VyY2UgZm9yIGdhbGxlcnlqcyBpcyBkZXByZWNhdGVkISBVc2UgImRhdGEtc3JjIiBpbnN0ZWFkIScpOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gc3JjOwogICAgfQoKCiAgICAvLyBwdWJsaWMgbWV0aG9kcwogICAgcmV0dXJuIHsKICAgICAgY3JlYXRlOiBjcmVhdGUKICAgIH07CgogIH0oKTsKCiAgcmV0dXJuIEdhbGxlcnlGYWN0b3J5OwoKfSk7CgovKioKICogQnJpZGdldCBtYWtlcyBqUXVlcnkgd2lkZ2V0cwogKiB2MS4wLjEKICovCgooIGZ1bmN0aW9uKCB3aW5kb3cgKSB7CgoKCi8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tIHV0aWxzIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tIC8vCgp2YXIgc2xpY2UgPSBBcnJheS5wcm90b3R5cGUuc2xpY2U7CgpmdW5jdGlvbiBub29wKCkge30KCi8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tIGRlZmluaXRpb24gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gLy8KCmZ1bmN0aW9uIGRlZmluZUJyaWRnZXQoICQgKSB7CgovLyBiYWlsIGlmIG5vIGpRdWVyeQppZiAoICEkICkgewogIHJldHVybjsKfQoKLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gYWRkT3B0aW9uTWV0aG9kIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tIC8vCgovKioKICogYWRkcyBvcHRpb24gbWV0aG9kIC0+ICQoKS5wbHVnaW4oJ29wdGlvbicsIHsuLi59KQogKiBAcGFyYW0ge0Z1bmN0aW9ufSBQbHVnaW5DbGFzcyAtIGNvbnN0cnVjdG9yIGNsYXNzCiAqLwpmdW5jdGlvbiBhZGRPcHRpb25NZXRob2QoIFBsdWdpbkNsYXNzICkgewogIC8vIGRvbid0IG92ZXJ3cml0ZSBvcmlnaW5hbCBvcHRpb24gbWV0aG9kCiAgaWYgKCBQbHVnaW5DbGFzcy5wcm90b3R5cGUub3B0aW9uICkgewogICAgcmV0dXJuOwogIH0KCiAgLy8gb3B0aW9uIHNldHRlcgogIFBsdWdpbkNsYXNzLnByb3RvdHlwZS5vcHRpb24gPSBmdW5jdGlvbiggb3B0cyApIHsKICAgIC8vIGJhaWwgb3V0IGlmIG5vdCBhbiBvYmplY3QKICAgIGlmICggISQuaXNQbGFpbk9iamVjdCggb3B0cyApICl7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHRoaXMub3B0aW9ucyA9ICQuZXh0ZW5kKCB0cnVlLCB0aGlzLm9wdGlvbnMsIG9wdHMgKTsKICB9Owp9CgoKLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gcGx1Z2luIGJyaWRnZSAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSAvLwoKLy8gaGVscGVyIGZ1bmN0aW9uIGZvciBsb2dnaW5nIGVycm9ycwovLyAkLmVycm9yIGJyZWFrcyBqUXVlcnkgY2hhaW5pbmcKdmFyIGxvZ0Vycm9yID0gdHlwZW9mIGNvbnNvbGUgPT09ICd1bmRlZmluZWQnID8gbm9vcCA6CiAgZnVuY3Rpb24oIG1lc3NhZ2UgKSB7CiAgICBjb25zb2xlLmVycm9yKCBtZXNzYWdlICk7CiAgfTsKCi8qKgogKiBqUXVlcnkgcGx1Z2luIGJyaWRnZSwgYWNjZXNzIG1ldGhvZHMgbGlrZSAkZWxlbS5wbHVnaW4oJ21ldGhvZCcpCiAqIEBwYXJhbSB7U3RyaW5nfSBuYW1lc3BhY2UgLSBwbHVnaW4gbmFtZQogKiBAcGFyYW0ge0Z1bmN0aW9ufSBQbHVnaW5DbGFzcyAtIGNvbnN0cnVjdG9yIGNsYXNzCiAqLwpmdW5jdGlvbiBicmlkZ2UoIG5hbWVzcGFjZSwgUGx1Z2luQ2xhc3MgKSB7CiAgLy8gYWRkIHRvIGpRdWVyeSBmbiBuYW1lc3BhY2UKICAkLmZuWyBuYW1lc3BhY2UgXSA9IGZ1bmN0aW9uKCBvcHRpb25zICkgewogICAgaWYgKCB0eXBlb2Ygb3B0aW9ucyA9PT0gJ3N0cmluZycgKSB7CiAgICAgIC8vIGNhbGwgcGx1Z2luIG1ldGhvZCB3aGVuIGZpcnN0IGFyZ3VtZW50IGlzIGEgc3RyaW5nCiAgICAgIC8vIGdldCBhcmd1bWVudHMgZm9yIG1ldGhvZAogICAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoIGFyZ3VtZW50cywgMSApOwoKICAgICAgZm9yICggdmFyIGk9MCwgbGVuID0gdGhpcy5sZW5ndGg7IGkgPCBsZW47IGkrKyApIHsKICAgICAgICB2YXIgZWxlbSA9IHRoaXNbaV07CiAgICAgICAgdmFyIGluc3RhbmNlID0gJC5kYXRhKCBlbGVtLCBuYW1lc3BhY2UgKTsKICAgICAgICBpZiAoICFpbnN0YW5jZSApIHsKICAgICAgICAgIGxvZ0Vycm9yKCAiY2Fubm90IGNhbGwgbWV0aG9kcyBvbiAiICsgbmFtZXNwYWNlICsgIiBwcmlvciB0byBpbml0aWFsaXphdGlvbjsgIiArCiAgICAgICAgICAgICJhdHRlbXB0ZWQgdG8gY2FsbCAnIiArIG9wdGlvbnMgKyAiJyIgKTsKICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIH0KICAgICAgICBpZiAoICEkLmlzRnVuY3Rpb24oIGluc3RhbmNlW29wdGlvbnNdICkgfHwgb3B0aW9ucy5jaGFyQXQoMCkgPT09ICdfJyApIHsKICAgICAgICAgIGxvZ0Vycm9yKCAibm8gc3VjaCBtZXRob2QgJyIgKyBvcHRpb25zICsgIicgZm9yICIgKyBuYW1lc3BhY2UgKyAiIGluc3RhbmNlIiApOwogICAgICAgICAgY29udGludWU7CiAgICAgICAgfQoKICAgICAgICAvLyB0cmlnZ2VyIG1ldGhvZCB3aXRoIGFyZ3VtZW50cwogICAgICAgIHZhciByZXR1cm5WYWx1ZSA9IGluc3RhbmNlWyBvcHRpb25zIF0uYXBwbHkoIGluc3RhbmNlLCBhcmdzICk7CgogICAgICAgIC8vIGJyZWFrIGxvb2sgYW5kIHJldHVybiBmaXJzdCB2YWx1ZSBpZiBwcm92aWRlZAogICAgICAgIGlmICggcmV0dXJuVmFsdWUgIT09IHVuZGVmaW5lZCApIHsKICAgICAgICAgIHJldHVybiByZXR1cm5WYWx1ZTsKICAgICAgICB9CiAgICAgIH0KICAgICAgLy8gcmV0dXJuIHRoaXMgaWYgbm8gcmV0dXJuIHZhbHVlCiAgICAgIHJldHVybiB0aGlzOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIHRoaXMuZWFjaCggZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIGluc3RhbmNlID0gJC5kYXRhKCB0aGlzLCBuYW1lc3BhY2UgKTsKICAgICAgICBpZiAoIGluc3RhbmNlICkgewogICAgICAgICAgLy8gYXBwbHkgb3B0aW9ucyAmIGluaXQKICAgICAgICAgIGluc3RhbmNlLm9wdGlvbiggb3B0aW9ucyApOwogICAgICAgICAgaW5zdGFuY2UuX2luaXQoKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgLy8gaW5pdGlhbGl6ZSBuZXcgaW5zdGFuY2UKICAgICAgICAgIGluc3RhbmNlID0gbmV3IFBsdWdpbkNsYXNzKCB0aGlzLCBvcHRpb25zICk7CiAgICAgICAgICAkLmRhdGEoIHRoaXMsIG5hbWVzcGFjZSwgaW5zdGFuY2UgKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQogIH07Cgp9CgovLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSBicmlkZ2V0IC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tIC8vCgovKioKICogY29udmVydHMgYSBQcm90b3R5cGljYWwgY2xhc3MgaW50byBhIHByb3BlciBqUXVlcnkgcGx1Z2luCiAqICAgdGhlIGNsYXNzIG11c3QgaGF2ZSBhIC5faW5pdCBtZXRob2QKICogQHBhcmFtIHtTdHJpbmd9IG5hbWVzcGFjZSAtIHBsdWdpbiBuYW1lLCB1c2VkIGluICQoKS5wbHVnaW5OYW1lCiAqIEBwYXJhbSB7RnVuY3Rpb259IFBsdWdpbkNsYXNzIC0gY29uc3RydWN0b3IgY2xhc3MKICovCiQuYnJpZGdldCA9IGZ1bmN0aW9uKCBuYW1lc3BhY2UsIFBsdWdpbkNsYXNzICkgewogIGFkZE9wdGlvbk1ldGhvZCggUGx1Z2luQ2xhc3MgKTsKICBicmlkZ2UoIG5hbWVzcGFjZSwgUGx1Z2luQ2xhc3MgKTsKfTsKCnJldHVybiAkLmJyaWRnZXQ7Cgp9CgovLyB0cmFuc3BvcnQKaWYgKCB0eXBlb2YgZGVmaW5lID09PSAnZnVuY3Rpb24nICYmIGRlZmluZS5hbWQgKSB7CiAgLy8gQU1ECiAgZGVmaW5lKCAnanF1ZXJ5LWJyaWRnZXQvanF1ZXJ5LmJyaWRnZXQnLFsgJ2pxdWVyeScgXSwgZGVmaW5lQnJpZGdldCApOwp9IGVsc2UgewogIC8vIGdldCBqcXVlcnkgZnJvbSBicm93c2VyIGdsb2JhbAogIGRlZmluZUJyaWRnZXQoIHdpbmRvdy5qUXVlcnkgKTsKfQoKfSkoIHdpbmRvdyApOwoKLyohCiAqIGV2ZW50aWUgdjEuMC41CiAqIGV2ZW50IGJpbmRpbmcgaGVscGVyCiAqICAgZXZlbnRpZS5iaW5kKCBlbGVtLCAnY2xpY2snLCBteUZuICkKICogICBldmVudGllLnVuYmluZCggZWxlbSwgJ2NsaWNrJywgbXlGbiApCiAqIE1JVCBsaWNlbnNlCiAqLwoKLypqc2hpbnQgYnJvd3NlcjogdHJ1ZSwgdW5kZWY6IHRydWUsIHVudXNlZDogdHJ1ZSAqLwovKmdsb2JhbCBkZWZpbmU6IGZhbHNlLCBtb2R1bGU6IGZhbHNlICovCgooIGZ1bmN0aW9uKCB3aW5kb3cgKSB7CgoKCnZhciBkb2NFbGVtID0gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50OwoKdmFyIGJpbmQgPSBmdW5jdGlvbigpIHt9OwoKZnVuY3Rpb24gZ2V0SUVFdmVudCggb2JqICkgewogIHZhciBldmVudCA9IHdpbmRvdy5ldmVudDsKICAvLyBhZGQgZXZlbnQudGFyZ2V0CiAgZXZlbnQudGFyZ2V0ID0gZXZlbnQudGFyZ2V0IHx8IGV2ZW50LnNyY0VsZW1lbnQgfHwgb2JqOwogIHJldHVybiBldmVudDsKfQoKaWYgKCBkb2NFbGVtLmFkZEV2ZW50TGlzdGVuZXIgKSB7CiAgYmluZCA9IGZ1bmN0aW9uKCBvYmosIHR5cGUsIGZuICkgewogICAgb2JqLmFkZEV2ZW50TGlzdGVuZXIoIHR5cGUsIGZuLCBmYWxzZSApOwogIH07Cn0gZWxzZSBpZiAoIGRvY0VsZW0uYXR0YWNoRXZlbnQgKSB7CiAgYmluZCA9IGZ1bmN0aW9uKCBvYmosIHR5cGUsIGZuICkgewogICAgb2JqWyB0eXBlICsgZm4gXSA9IGZuLmhhbmRsZUV2ZW50ID8KICAgICAgZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIGV2ZW50ID0gZ2V0SUVFdmVudCggb2JqICk7CiAgICAgICAgZm4uaGFuZGxlRXZlbnQuY2FsbCggZm4sIGV2ZW50ICk7CiAgICAgIH0gOgogICAgICBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgZXZlbnQgPSBnZXRJRUV2ZW50KCBvYmogKTsKICAgICAgICBmbi5jYWxsKCBvYmosIGV2ZW50ICk7CiAgICAgIH07CiAgICBvYmouYXR0YWNoRXZlbnQoICJvbiIgKyB0eXBlLCBvYmpbIHR5cGUgKyBmbiBdICk7CiAgfTsKfQoKdmFyIHVuYmluZCA9IGZ1bmN0aW9uKCkge307CgppZiAoIGRvY0VsZW0ucmVtb3ZlRXZlbnRMaXN0ZW5lciApIHsKICB1bmJpbmQgPSBmdW5jdGlvbiggb2JqLCB0eXBlLCBmbiApIHsKICAgIG9iai5yZW1vdmVFdmVudExpc3RlbmVyKCB0eXBlLCBmbiwgZmFsc2UgKTsKICB9Owp9IGVsc2UgaWYgKCBkb2NFbGVtLmRldGFjaEV2ZW50ICkgewogIHVuYmluZCA9IGZ1bmN0aW9uKCBvYmosIHR5cGUsIGZuICkgewogICAgb2JqLmRldGFjaEV2ZW50KCAib24iICsgdHlwZSwgb2JqWyB0eXBlICsgZm4gXSApOwogICAgdHJ5IHsKICAgICAgZGVsZXRlIG9ialsgdHlwZSArIGZuIF07CiAgICB9IGNhdGNoICggZXJyICkgewogICAgICAvLyBjYW4ndCBkZWxldGUgd2luZG93IG9iamVjdCBwcm9wZXJ0aWVzCiAgICAgIG9ialsgdHlwZSArIGZuIF0gPSB1bmRlZmluZWQ7CiAgICB9CiAgfTsKfQoKdmFyIGV2ZW50aWUgPSB7CiAgYmluZDogYmluZCwKICB1bmJpbmQ6IHVuYmluZAp9OwoKLy8gLS0tLS0gbW9kdWxlIGRlZmluaXRpb24gLS0tLS0gLy8KCmlmICggdHlwZW9mIGRlZmluZSA9PT0gJ2Z1bmN0aW9uJyAmJiBkZWZpbmUuYW1kICkgewogIC8vIEFNRAogIGRlZmluZSggJ2V2ZW50aWUvZXZlbnRpZScsZXZlbnRpZSApOwp9IGVsc2UgaWYgKCB0eXBlb2YgZXhwb3J0cyA9PT0gJ29iamVjdCcgKSB7CiAgLy8gQ29tbW9uSlMKICBtb2R1bGUuZXhwb3J0cyA9IGV2ZW50aWU7Cn0gZWxzZSB7CiAgLy8gYnJvd3NlciBnbG9iYWwKICB3aW5kb3cuZXZlbnRpZSA9IGV2ZW50aWU7Cn0KCn0pKCB0aGlzICk7CgovKiEKICogZG9jUmVhZHkgdjEuMC4zCiAqIENyb3NzIGJyb3dzZXIgRE9NQ29udGVudExvYWRlZCBldmVudCBlbWl0dGVyCiAqIE1JVCBsaWNlbnNlCiAqLwoKLypqc2hpbnQgYnJvd3NlcjogdHJ1ZSwgc3RyaWN0OiB0cnVlLCB1bmRlZjogdHJ1ZSwgdW51c2VkOiB0cnVlKi8KLypnbG9iYWwgZGVmaW5lOiBmYWxzZSAqLwoKKCBmdW5jdGlvbiggd2luZG93ICkgewoKCgp2YXIgZG9jdW1lbnQgPSB3aW5kb3cuZG9jdW1lbnQ7Ci8vIGNvbGxlY3Rpb24gb2YgZnVuY3Rpb25zIHRvIGJlIHRyaWdnZXJlZCBvbiByZWFkeQp2YXIgcXVldWUgPSBbXTsKCmZ1bmN0aW9uIGRvY1JlYWR5KCBmbiApIHsKICAvLyB0aHJvdyBvdXQgbm9uLWZ1bmN0aW9ucwogIGlmICggdHlwZW9mIGZuICE9PSAnZnVuY3Rpb24nICkgewogICAgcmV0dXJuOwogIH0KCiAgaWYgKCBkb2NSZWFkeS5pc1JlYWR5ICkgewogICAgLy8gcmVhZHkgbm93LCBoaXQgaXQKICAgIGZuKCk7CiAgfSBlbHNlIHsKICAgIC8vIHF1ZXVlIGZ1bmN0aW9uIHdoZW4gcmVhZHkKICAgIHF1ZXVlLnB1c2goIGZuICk7CiAgfQp9Cgpkb2NSZWFkeS5pc1JlYWR5ID0gZmFsc2U7CgovLyB0cmlnZ2VyZWQgb24gdmFyaW91cyBkb2MgcmVhZHkgZXZlbnRzCmZ1bmN0aW9uIGluaXQoIGV2ZW50ICkgewogIC8vIGJhaWwgaWYgSUU4IGRvY3VtZW50IGlzIG5vdCByZWFkeSBqdXN0IHlldAogIHZhciBpc0lFOE5vdFJlYWR5ID0gZXZlbnQudHlwZSA9PT0gJ3JlYWR5c3RhdGVjaGFuZ2UnICYmIGRvY3VtZW50LnJlYWR5U3RhdGUgIT09ICdjb21wbGV0ZSc7CiAgaWYgKCBkb2NSZWFkeS5pc1JlYWR5IHx8IGlzSUU4Tm90UmVhZHkgKSB7CiAgICByZXR1cm47CiAgfQogIGRvY1JlYWR5LmlzUmVhZHkgPSB0cnVlOwoKICAvLyBwcm9jZXNzIHF1ZXVlCiAgZm9yICggdmFyIGk9MCwgbGVuID0gcXVldWUubGVuZ3RoOyBpIDwgbGVuOyBpKysgKSB7CiAgICB2YXIgZm4gPSBxdWV1ZVtpXTsKICAgIGZuKCk7CiAgfQp9CgpmdW5jdGlvbiBkZWZpbmVEb2NSZWFkeSggZXZlbnRpZSApIHsKICBldmVudGllLmJpbmQoIGRvY3VtZW50LCAnRE9NQ29udGVudExvYWRlZCcsIGluaXQgKTsKICBldmVudGllLmJpbmQoIGRvY3VtZW50LCAncmVhZHlzdGF0ZWNoYW5nZScsIGluaXQgKTsKICBldmVudGllLmJpbmQoIHdpbmRvdywgJ2xvYWQnLCBpbml0ICk7CgogIHJldHVybiBkb2NSZWFkeTsKfQoKLy8gdHJhbnNwb3J0CmlmICggdHlwZW9mIGRlZmluZSA9PT0gJ2Z1bmN0aW9uJyAmJiBkZWZpbmUuYW1kICkgewogIC8vIEFNRAogIC8vIGlmIFJlcXVpcmVKUywgdGhlbiBkb2MgaXMgYWxyZWFkeSByZWFkeQogIGRvY1JlYWR5LmlzUmVhZHkgPSB0eXBlb2YgcmVxdWlyZWpzID09PSAnZnVuY3Rpb24nOwogIGRlZmluZSggJ2RvYy1yZWFkeS9kb2MtcmVhZHknLFsgJ2V2ZW50aWUvZXZlbnRpZScgXSwgZGVmaW5lRG9jUmVhZHkgKTsKfSBlbHNlIGlmICggdHlwZW9mIGV4cG9ydHMgPT09ICdvYmplY3QnICkgewogIG1vZHVsZS5leHBvcnRzID0gZGVmaW5lRG9jUmVhZHkoIHJlcXVpcmUoJ2V2ZW50aWUnKSApOwp9IGVsc2UgewogIC8vIGJyb3dzZXIgZ2xvYmFsCiAgd2luZG93LmRvY1JlYWR5ID0gZGVmaW5lRG9jUmVhZHkoIHdpbmRvdy5ldmVudGllICk7Cn0KCn0pKCB3aW5kb3cgKTsKCi8qIQogKiBFdmVudEVtaXR0ZXIgdjQuMi44IC0gZ2l0LmlvL2VlCiAqIE9saXZlciBDYWxkd2VsbAogKiBNSVQgbGljZW5zZQogKiBAcHJlc2VydmUKICovCgooZnVuY3Rpb24gKCkgewoJCgoJLyoqCgkgKiBDbGFzcyBmb3IgbWFuYWdpbmcgZXZlbnRzLgoJICogQ2FuIGJlIGV4dGVuZGVkIHRvIHByb3ZpZGUgZXZlbnQgZnVuY3Rpb25hbGl0eSBpbiBvdGhlciBjbGFzc2VzLgoJICoKCSAqIEBjbGFzcyBFdmVudEVtaXR0ZXIgTWFuYWdlcyBldmVudCByZWdpc3RlcmluZyBhbmQgZW1pdHRpbmcuCgkgKi8KCWZ1bmN0aW9uIEV2ZW50RW1pdHRlcigpIHt9CgoJLy8gU2hvcnRjdXRzIHRvIGltcHJvdmUgc3BlZWQgYW5kIHNpemUKCXZhciBwcm90byA9IEV2ZW50RW1pdHRlci5wcm90b3R5cGU7Cgl2YXIgZXhwb3J0cyA9IHRoaXM7Cgl2YXIgb3JpZ2luYWxHbG9iYWxWYWx1ZSA9IGV4cG9ydHMuRXZlbnRFbWl0dGVyOwoKCS8qKgoJICogRmluZHMgdGhlIGluZGV4IG9mIHRoZSBsaXN0ZW5lciBmb3IgdGhlIGV2ZW50IGluIGl0cyBzdG9yYWdlIGFycmF5LgoJICoKCSAqIEBwYXJhbSB7RnVuY3Rpb25bXX0gbGlzdGVuZXJzIEFycmF5IG9mIGxpc3RlbmVycyB0byBzZWFyY2ggdGhyb3VnaC4KCSAqIEBwYXJhbSB7RnVuY3Rpb259IGxpc3RlbmVyIE1ldGhvZCB0byBsb29rIGZvci4KCSAqIEByZXR1cm4ge051bWJlcn0gSW5kZXggb2YgdGhlIHNwZWNpZmllZCBsaXN0ZW5lciwgLTEgaWYgbm90IGZvdW5kCgkgKiBAYXBpIHByaXZhdGUKCSAqLwoJZnVuY3Rpb24gaW5kZXhPZkxpc3RlbmVyKGxpc3RlbmVycywgbGlzdGVuZXIpIHsKCQl2YXIgaSA9IGxpc3RlbmVycy5sZW5ndGg7CgkJd2hpbGUgKGktLSkgewoJCQlpZiAobGlzdGVuZXJzW2ldLmxpc3RlbmVyID09PSBsaXN0ZW5lcikgewoJCQkJcmV0dXJuIGk7CgkJCX0KCQl9CgoJCXJldHVybiAtMTsKCX0KCgkvKioKCSAqIEFsaWFzIGEgbWV0aG9kIHdoaWxlIGtlZXBpbmcgdGhlIGNvbnRleHQgY29ycmVjdCwgdG8gYWxsb3cgZm9yIG92ZXJ3cml0aW5nIG9mIHRhcmdldCBtZXRob2QuCgkgKgoJICogQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIG5hbWUgb2YgdGhlIHRhcmdldCBtZXRob2QuCgkgKiBAcmV0dXJuIHtGdW5jdGlvbn0gVGhlIGFsaWFzZWQgbWV0aG9kCgkgKiBAYXBpIHByaXZhdGUKCSAqLwoJZnVuY3Rpb24gYWxpYXMobmFtZSkgewoJCXJldHVybiBmdW5jdGlvbiBhbGlhc0Nsb3N1cmUoKSB7CgkJCXJldHVybiB0aGlzW25hbWVdLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CgkJfTsKCX0KCgkvKioKCSAqIFJldHVybnMgdGhlIGxpc3RlbmVyIGFycmF5IGZvciB0aGUgc3BlY2lmaWVkIGV2ZW50LgoJICogV2lsbCBpbml0aWFsaXNlIHRoZSBldmVudCBvYmplY3QgYW5kIGxpc3RlbmVyIGFycmF5cyBpZiByZXF1aXJlZC4KCSAqIFdpbGwgcmV0dXJuIGFuIG9iamVjdCBpZiB5b3UgdXNlIGEgcmVnZXggc2VhcmNoLiBUaGUgb2JqZWN0IGNvbnRhaW5zIGtleXMgZm9yIGVhY2ggbWF0Y2hlZCBldmVudC4gU28gL2JhW3J6XS8gbWlnaHQgcmV0dXJuIGFuIG9iamVjdCBjb250YWluaW5nIGJhciBhbmQgYmF6LiBCdXQgb25seSBpZiB5b3UgaGF2ZSBlaXRoZXIgZGVmaW5lZCB0aGVtIHdpdGggZGVmaW5lRXZlbnQgb3IgYWRkZWQgc29tZSBsaXN0ZW5lcnMgdG8gdGhlbS4KCSAqIEVhY2ggcHJvcGVydHkgaW4gdGhlIG9iamVjdCByZXNwb25zZSBpcyBhbiBhcnJheSBvZiBsaXN0ZW5lciBmdW5jdGlvbnMuCgkgKgoJICogQHBhcmFtIHtTdHJpbmd8UmVnRXhwfSBldnQgTmFtZSBvZiB0aGUgZXZlbnQgdG8gcmV0dXJuIHRoZSBsaXN0ZW5lcnMgZnJvbS4KCSAqIEByZXR1cm4ge0Z1bmN0aW9uW118T2JqZWN0fSBBbGwgbGlzdGVuZXIgZnVuY3Rpb25zIGZvciB0aGUgZXZlbnQuCgkgKi8KCXByb3RvLmdldExpc3RlbmVycyA9IGZ1bmN0aW9uIGdldExpc3RlbmVycyhldnQpIHsKCQl2YXIgZXZlbnRzID0gdGhpcy5fZ2V0RXZlbnRzKCk7CgkJdmFyIHJlc3BvbnNlOwoJCXZhciBrZXk7CgoJCS8vIFJldHVybiBhIGNvbmNhdGVuYXRlZCBhcnJheSBvZiBhbGwgbWF0Y2hpbmcgZXZlbnRzIGlmCgkJLy8gdGhlIHNlbGVjdG9yIGlzIGEgcmVndWxhciBleHByZXNzaW9uLgoJCWlmIChldnQgaW5zdGFuY2VvZiBSZWdFeHApIHsKCQkJcmVzcG9uc2UgPSB7fTsKCQkJZm9yIChrZXkgaW4gZXZlbnRzKSB7CgkJCQlpZiAoZXZlbnRzLmhhc093blByb3BlcnR5KGtleSkgJiYgZXZ0LnRlc3Qoa2V5KSkgewoJCQkJCXJlc3BvbnNlW2tleV0gPSBldmVudHNba2V5XTsKCQkJCX0KCQkJfQoJCX0KCQllbHNlIHsKCQkJcmVzcG9uc2UgPSBldmVudHNbZXZ0XSB8fCAoZXZlbnRzW2V2dF0gPSBbXSk7CgkJfQoKCQlyZXR1cm4gcmVzcG9uc2U7Cgl9OwoKCS8qKgoJICogVGFrZXMgYSBsaXN0IG9mIGxpc3RlbmVyIG9iamVjdHMgYW5kIGZsYXR0ZW5zIGl0IGludG8gYSBsaXN0IG9mIGxpc3RlbmVyIGZ1bmN0aW9ucy4KCSAqCgkgKiBAcGFyYW0ge09iamVjdFtdfSBsaXN0ZW5lcnMgUmF3IGxpc3RlbmVyIG9iamVjdHMuCgkgKiBAcmV0dXJuIHtGdW5jdGlvbltdfSBKdXN0IHRoZSBsaXN0ZW5lciBmdW5jdGlvbnMuCgkgKi8KCXByb3RvLmZsYXR0ZW5MaXN0ZW5lcnMgPSBmdW5jdGlvbiBmbGF0dGVuTGlzdGVuZXJzKGxpc3RlbmVycykgewoJCXZhciBmbGF0TGlzdGVuZXJzID0gW107CgkJdmFyIGk7CgoJCWZvciAoaSA9IDA7IGkgPCBsaXN0ZW5lcnMubGVuZ3RoOyBpICs9IDEpIHsKCQkJZmxhdExpc3RlbmVycy5wdXNoKGxpc3RlbmVyc1tpXS5saXN0ZW5lcik7CgkJfQoKCQlyZXR1cm4gZmxhdExpc3RlbmVyczsKCX07CgoJLyoqCgkgKiBGZXRjaGVzIHRoZSByZXF1ZXN0ZWQgbGlzdGVuZXJzIHZpYSBnZXRMaXN0ZW5lcnMgYnV0IHdpbGwgYWx3YXlzIHJldHVybiB0aGUgcmVzdWx0cyBpbnNpZGUgYW4gb2JqZWN0LiBUaGlzIGlzIG1haW5seSBmb3IgaW50ZXJuYWwgdXNlIGJ1dCBvdGhlcnMgbWF5IGZpbmQgaXQgdXNlZnVsLgoJICoKCSAqIEBwYXJhbSB7U3RyaW5nfFJlZ0V4cH0gZXZ0IE5hbWUgb2YgdGhlIGV2ZW50IHRvIHJldHVybiB0aGUgbGlzdGVuZXJzIGZyb20uCgkgKiBAcmV0dXJuIHtPYmplY3R9IEFsbCBsaXN0ZW5lciBmdW5jdGlvbnMgZm9yIGFuIGV2ZW50IGluIGFuIG9iamVjdC4KCSAqLwoJcHJvdG8uZ2V0TGlzdGVuZXJzQXNPYmplY3QgPSBmdW5jdGlvbiBnZXRMaXN0ZW5lcnNBc09iamVjdChldnQpIHsKCQl2YXIgbGlzdGVuZXJzID0gdGhpcy5nZXRMaXN0ZW5lcnMoZXZ0KTsKCQl2YXIgcmVzcG9uc2U7CgoJCWlmIChsaXN0ZW5lcnMgaW5zdGFuY2VvZiBBcnJheSkgewoJCQlyZXNwb25zZSA9IHt9OwoJCQlyZXNwb25zZVtldnRdID0gbGlzdGVuZXJzOwoJCX0KCgkJcmV0dXJuIHJlc3BvbnNlIHx8IGxpc3RlbmVyczsKCX07CgoJLyoqCgkgKiBBZGRzIGEgbGlzdGVuZXIgZnVuY3Rpb24gdG8gdGhlIHNwZWNpZmllZCBldmVudC4KCSAqIFRoZSBsaXN0ZW5lciB3aWxsIG5vdCBiZSBhZGRlZCBpZiBpdCBpcyBhIGR1cGxpY2F0ZS4KCSAqIElmIHRoZSBsaXN0ZW5lciByZXR1cm5zIHRydWUgdGhlbiBpdCB3aWxsIGJlIHJlbW92ZWQgYWZ0ZXIgaXQgaXMgY2FsbGVkLgoJICogSWYgeW91IHBhc3MgYSByZWd1bGFyIGV4cHJlc3Npb24gYXMgdGhlIGV2ZW50IG5hbWUgdGhlbiB0aGUgbGlzdGVuZXIgd2lsbCBiZSBhZGRlZCB0byBhbGwgZXZlbnRzIHRoYXQgbWF0Y2ggaXQuCgkgKgoJICogQHBhcmFtIHtTdHJpbmd8UmVnRXhwfSBldnQgTmFtZSBvZiB0aGUgZXZlbnQgdG8gYXR0YWNoIHRoZSBsaXN0ZW5lciB0by4KCSAqIEBwYXJhbSB7RnVuY3Rpb259IGxpc3RlbmVyIE1ldGhvZCB0byBiZSBjYWxsZWQgd2hlbiB0aGUgZXZlbnQgaXMgZW1pdHRlZC4gSWYgdGhlIGZ1bmN0aW9uIHJldHVybnMgdHJ1ZSB0aGVuIGl0IHdpbGwgYmUgcmVtb3ZlZCBhZnRlciBjYWxsaW5nLgoJICogQHJldHVybiB7T2JqZWN0fSBDdXJyZW50IGluc3RhbmNlIG9mIEV2ZW50RW1pdHRlciBmb3IgY2hhaW5pbmcuCgkgKi8KCXByb3RvLmFkZExpc3RlbmVyID0gZnVuY3Rpb24gYWRkTGlzdGVuZXIoZXZ0LCBsaXN0ZW5lcikgewoJCXZhciBsaXN0ZW5lcnMgPSB0aGlzLmdldExpc3RlbmVyc0FzT2JqZWN0KGV2dCk7CgkJdmFyIGxpc3RlbmVySXNXcmFwcGVkID0gdHlwZW9mIGxpc3RlbmVyID09PSAnb2JqZWN0JzsKCQl2YXIga2V5OwoKCQlmb3IgKGtleSBpbiBsaXN0ZW5lcnMpIHsKCQkJaWYgKGxpc3RlbmVycy5oYXNPd25Qcm9wZXJ0eShrZXkpICYmIGluZGV4T2ZMaXN0ZW5lcihsaXN0ZW5lcnNba2V5XSwgbGlzdGVuZXIpID09PSAtMSkgewoJCQkJbGlzdGVuZXJzW2tleV0ucHVzaChsaXN0ZW5lcklzV3JhcHBlZCA/IGxpc3RlbmVyIDogewoJCQkJCWxpc3RlbmVyOiBsaXN0ZW5lciwKCQkJCQlvbmNlOiBmYWxzZQoJCQkJfSk7CgkJCX0KCQl9CgoJCXJldHVybiB0aGlzOwoJfTsKCgkvKioKCSAqIEFsaWFzIG9mIGFkZExpc3RlbmVyCgkgKi8KCXByb3RvLm9uID0gYWxpYXMoJ2FkZExpc3RlbmVyJyk7CgoJLyoqCgkgKiBTZW1pLWFsaWFzIG9mIGFkZExpc3RlbmVyLiBJdCB3aWxsIGFkZCBhIGxpc3RlbmVyIHRoYXQgd2lsbCBiZQoJICogYXV0b21hdGljYWxseSByZW1vdmVkIGFmdGVyIGl0cyBmaXJzdCBleGVjdXRpb24uCgkgKgoJICogQHBhcmFtIHtTdHJpbmd8UmVnRXhwfSBldnQgTmFtZSBvZiB0aGUgZXZlbnQgdG8gYXR0YWNoIHRoZSBsaXN0ZW5lciB0by4KCSAqIEBwYXJhbSB7RnVuY3Rpb259IGxpc3RlbmVyIE1ldGhvZCB0byBiZSBjYWxsZWQgd2hlbiB0aGUgZXZlbnQgaXMgZW1pdHRlZC4gSWYgdGhlIGZ1bmN0aW9uIHJldHVybnMgdHJ1ZSB0aGVuIGl0IHdpbGwgYmUgcmVtb3ZlZCBhZnRlciBjYWxsaW5nLgoJICogQHJldHVybiB7T2JqZWN0fSBDdXJyZW50IGluc3RhbmNlIG9mIEV2ZW50RW1pdHRlciBmb3IgY2hhaW5pbmcuCgkgKi8KCXByb3RvLmFkZE9uY2VMaXN0ZW5lciA9IGZ1bmN0aW9uIGFkZE9uY2VMaXN0ZW5lcihldnQsIGxpc3RlbmVyKSB7CgkJcmV0dXJuIHRoaXMuYWRkTGlzdGVuZXIoZXZ0LCB7CgkJCWxpc3RlbmVyOiBsaXN0ZW5lciwKCQkJb25jZTogdHJ1ZQoJCX0pOwoJfTsKCgkvKioKCSAqIEFsaWFzIG9mIGFkZE9uY2VMaXN0ZW5lci4KCSAqLwoJcHJvdG8ub25jZSA9IGFsaWFzKCdhZGRPbmNlTGlzdGVuZXInKTsKCgkvKioKCSAqIERlZmluZXMgYW4gZXZlbnQgbmFtZS4gVGhpcyBpcyByZXF1aXJlZCBpZiB5b3Ugd2FudCB0byB1c2UgYSByZWdleCB0byBhZGQgYSBsaXN0ZW5lciB0byBtdWx0aXBsZSBldmVudHMgYXQgb25jZS4gSWYgeW91IGRvbid0IGRvIHRoaXMgdGhlbiBob3cgZG8geW91IGV4cGVjdCBpdCB0byBrbm93IHdoYXQgZXZlbnQgdG8gYWRkIHRvPyBTaG91bGQgaXQganVzdCBhZGQgdG8gZXZlcnkgcG9zc2libGUgbWF0Y2ggZm9yIGEgcmVnZXg/IE5vLiBUaGF0IGlzIHNjYXJ5IGFuZCBiYWQuCgkgKiBZb3UgbmVlZCB0byB0ZWxsIGl0IHdoYXQgZXZlbnQgbmFtZXMgc2hvdWxkIGJlIG1hdGNoZWQgYnkgYSByZWdleC4KCSAqCgkgKiBAcGFyYW0ge1N0cmluZ30gZXZ0IE5hbWUgb2YgdGhlIGV2ZW50IHRvIGNyZWF0ZS4KCSAqIEByZXR1cm4ge09iamVjdH0gQ3VycmVudCBpbnN0YW5jZSBvZiBFdmVudEVtaXR0ZXIgZm9yIGNoYWluaW5nLgoJICovCglwcm90by5kZWZpbmVFdmVudCA9IGZ1bmN0aW9uIGRlZmluZUV2ZW50KGV2dCkgewoJCXRoaXMuZ2V0TGlzdGVuZXJzKGV2dCk7CgkJcmV0dXJuIHRoaXM7Cgl9OwoKCS8qKgoJICogVXNlcyBkZWZpbmVFdmVudCB0byBkZWZpbmUgbXVsdGlwbGUgZXZlbnRzLgoJICoKCSAqIEBwYXJhbSB7U3RyaW5nW119IGV2dHMgQW4gYXJyYXkgb2YgZXZlbnQgbmFtZXMgdG8gZGVmaW5lLgoJICogQHJldHVybiB7T2JqZWN0fSBDdXJyZW50IGluc3RhbmNlIG9mIEV2ZW50RW1pdHRlciBmb3IgY2hhaW5pbmcuCgkgKi8KCXByb3RvLmRlZmluZUV2ZW50cyA9IGZ1bmN0aW9uIGRlZmluZUV2ZW50cyhldnRzKSB7CgkJZm9yICh2YXIgaSA9IDA7IGkgPCBldnRzLmxlbmd0aDsgaSArPSAxKSB7CgkJCXRoaXMuZGVmaW5lRXZlbnQoZXZ0c1tpXSk7CgkJfQoJCXJldHVybiB0aGlzOwoJfTsKCgkvKioKCSAqIFJlbW92ZXMgYSBsaXN0ZW5lciBmdW5jdGlvbiBmcm9tIHRoZSBzcGVjaWZpZWQgZXZlbnQuCgkgKiBXaGVuIHBhc3NlZCBhIHJlZ3VsYXIgZXhwcmVzc2lvbiBhcyB0aGUgZXZlbnQgbmFtZSwgaXQgd2lsbCByZW1vdmUgdGhlIGxpc3RlbmVyIGZyb20gYWxsIGV2ZW50cyB0aGF0IG1hdGNoIGl0LgoJICoKCSAqIEBwYXJhbSB7U3RyaW5nfFJlZ0V4cH0gZXZ0IE5hbWUgb2YgdGhlIGV2ZW50IHRvIHJlbW92ZSB0aGUgbGlzdGVuZXIgZnJvbS4KCSAqIEBwYXJhbSB7RnVuY3Rpb259IGxpc3RlbmVyIE1ldGhvZCB0byByZW1vdmUgZnJvbSB0aGUgZXZlbnQuCgkgKiBAcmV0dXJuIHtPYmplY3R9IEN1cnJlbnQgaW5zdGFuY2Ugb2YgRXZlbnRFbWl0dGVyIGZvciBjaGFpbmluZy4KCSAqLwoJcHJvdG8ucmVtb3ZlTGlzdGVuZXIgPSBmdW5jdGlvbiByZW1vdmVMaXN0ZW5lcihldnQsIGxpc3RlbmVyKSB7CgkJdmFyIGxpc3RlbmVycyA9IHRoaXMuZ2V0TGlzdGVuZXJzQXNPYmplY3QoZXZ0KTsKCQl2YXIgaW5kZXg7CgkJdmFyIGtleTsKCgkJZm9yIChrZXkgaW4gbGlzdGVuZXJzKSB7CgkJCWlmIChsaXN0ZW5lcnMuaGFzT3duUHJvcGVydHkoa2V5KSkgewoJCQkJaW5kZXggPSBpbmRleE9mTGlzdGVuZXIobGlzdGVuZXJzW2tleV0sIGxpc3RlbmVyKTsKCgkJCQlpZiAoaW5kZXggIT09IC0xKSB7CgkJCQkJbGlzdGVuZXJzW2tleV0uc3BsaWNlKGluZGV4LCAxKTsKCQkJCX0KCQkJfQoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9OwoKCS8qKgoJICogQWxpYXMgb2YgcmVtb3ZlTGlzdGVuZXIKCSAqLwoJcHJvdG8ub2ZmID0gYWxpYXMoJ3JlbW92ZUxpc3RlbmVyJyk7CgoJLyoqCgkgKiBBZGRzIGxpc3RlbmVycyBpbiBidWxrIHVzaW5nIHRoZSBtYW5pcHVsYXRlTGlzdGVuZXJzIG1ldGhvZC4KCSAqIElmIHlvdSBwYXNzIGFuIG9iamVjdCBhcyB0aGUgc2Vjb25kIGFyZ3VtZW50IHlvdSBjYW4gYWRkIHRvIG11bHRpcGxlIGV2ZW50cyBhdCBvbmNlLiBUaGUgb2JqZWN0IHNob3VsZCBjb250YWluIGtleSB2YWx1ZSBwYWlycyBvZiBldmVudHMgYW5kIGxpc3RlbmVycyBvciBsaXN0ZW5lciBhcnJheXMuIFlvdSBjYW4gYWxzbyBwYXNzIGl0IGFuIGV2ZW50IG5hbWUgYW5kIGFuIGFycmF5IG9mIGxpc3RlbmVycyB0byBiZSBhZGRlZC4KCSAqIFlvdSBjYW4gYWxzbyBwYXNzIGl0IGEgcmVndWxhciBleHByZXNzaW9uIHRvIGFkZCB0aGUgYXJyYXkgb2YgbGlzdGVuZXJzIHRvIGFsbCBldmVudHMgdGhhdCBtYXRjaCBpdC4KCSAqIFllYWgsIHRoaXMgZnVuY3Rpb24gZG9lcyBxdWl0ZSBhIGJpdC4gVGhhdCdzIHByb2JhYmx5IGEgYmFkIHRoaW5nLgoJICoKCSAqIEBwYXJhbSB7U3RyaW5nfE9iamVjdHxSZWdFeHB9IGV2dCBBbiBldmVudCBuYW1lIGlmIHlvdSB3aWxsIHBhc3MgYW4gYXJyYXkgb2YgbGlzdGVuZXJzIG5leHQuIEFuIG9iamVjdCBpZiB5b3Ugd2lzaCB0byBhZGQgdG8gbXVsdGlwbGUgZXZlbnRzIGF0IG9uY2UuCgkgKiBAcGFyYW0ge0Z1bmN0aW9uW119IFtsaXN0ZW5lcnNdIEFuIG9wdGlvbmFsIGFycmF5IG9mIGxpc3RlbmVyIGZ1bmN0aW9ucyB0byBhZGQuCgkgKiBAcmV0dXJuIHtPYmplY3R9IEN1cnJlbnQgaW5zdGFuY2Ugb2YgRXZlbnRFbWl0dGVyIGZvciBjaGFpbmluZy4KCSAqLwoJcHJvdG8uYWRkTGlzdGVuZXJzID0gZnVuY3Rpb24gYWRkTGlzdGVuZXJzKGV2dCwgbGlzdGVuZXJzKSB7CgkJLy8gUGFzcyB0aHJvdWdoIHRvIG1hbmlwdWxhdGVMaXN0ZW5lcnMKCQlyZXR1cm4gdGhpcy5tYW5pcHVsYXRlTGlzdGVuZXJzKGZhbHNlLCBldnQsIGxpc3RlbmVycyk7Cgl9OwoKCS8qKgoJICogUmVtb3ZlcyBsaXN0ZW5lcnMgaW4gYnVsayB1c2luZyB0aGUgbWFuaXB1bGF0ZUxpc3RlbmVycyBtZXRob2QuCgkgKiBJZiB5b3UgcGFzcyBhbiBvYmplY3QgYXMgdGhlIHNlY29uZCBhcmd1bWVudCB5b3UgY2FuIHJlbW92ZSBmcm9tIG11bHRpcGxlIGV2ZW50cyBhdCBvbmNlLiBUaGUgb2JqZWN0IHNob3VsZCBjb250YWluIGtleSB2YWx1ZSBwYWlycyBvZiBldmVudHMgYW5kIGxpc3RlbmVycyBvciBsaXN0ZW5lciBhcnJheXMuCgkgKiBZb3UgY2FuIGFsc28gcGFzcyBpdCBhbiBldmVudCBuYW1lIGFuZCBhbiBhcnJheSBvZiBsaXN0ZW5lcnMgdG8gYmUgcmVtb3ZlZC4KCSAqIFlvdSBjYW4gYWxzbyBwYXNzIGl0IGEgcmVndWxhciBleHByZXNzaW9uIHRvIHJlbW92ZSB0aGUgbGlzdGVuZXJzIGZyb20gYWxsIGV2ZW50cyB0aGF0IG1hdGNoIGl0LgoJICoKCSAqIEBwYXJhbSB7U3RyaW5nfE9iamVjdHxSZWdFeHB9IGV2dCBBbiBldmVudCBuYW1lIGlmIHlvdSB3aWxsIHBhc3MgYW4gYXJyYXkgb2YgbGlzdGVuZXJzIG5leHQuIEFuIG9iamVjdCBpZiB5b3Ugd2lzaCB0byByZW1vdmUgZnJvbSBtdWx0aXBsZSBldmVudHMgYXQgb25jZS4KCSAqIEBwYXJhbSB7RnVuY3Rpb25bXX0gW2xpc3RlbmVyc10gQW4gb3B0aW9uYWwgYXJyYXkgb2YgbGlzdGVuZXIgZnVuY3Rpb25zIHRvIHJlbW92ZS4KCSAqIEByZXR1cm4ge09iamVjdH0gQ3VycmVudCBpbnN0YW5jZSBvZiBFdmVudEVtaXR0ZXIgZm9yIGNoYWluaW5nLgoJICovCglwcm90by5yZW1vdmVMaXN0ZW5lcnMgPSBmdW5jdGlvbiByZW1vdmVMaXN0ZW5lcnMoZXZ0LCBsaXN0ZW5lcnMpIHsKCQkvLyBQYXNzIHRocm91Z2ggdG8gbWFuaXB1bGF0ZUxpc3RlbmVycwoJCXJldHVybiB0aGlzLm1hbmlwdWxhdGVMaXN0ZW5lcnModHJ1ZSwgZXZ0LCBsaXN0ZW5lcnMpOwoJfTsKCgkvKioKCSAqIEVkaXRzIGxpc3RlbmVycyBpbiBidWxrLiBUaGUgYWRkTGlzdGVuZXJzIGFuZCByZW1vdmVMaXN0ZW5lcnMgbWV0aG9kcyBib3RoIHVzZSB0aGlzIHRvIGRvIHRoZWlyIGpvYi4gWW91IHNob3VsZCByZWFsbHkgdXNlIHRob3NlIGluc3RlYWQsIHRoaXMgaXMgYSBsaXR0bGUgbG93ZXIgbGV2ZWwuCgkgKiBUaGUgZmlyc3QgYXJndW1lbnQgd2lsbCBkZXRlcm1pbmUgaWYgdGhlIGxpc3RlbmVycyBhcmUgcmVtb3ZlZCAodHJ1ZSkgb3IgYWRkZWQgKGZhbHNlKS4KCSAqIElmIHlvdSBwYXNzIGFuIG9iamVjdCBhcyB0aGUgc2Vjb25kIGFyZ3VtZW50IHlvdSBjYW4gYWRkL3JlbW92ZSBmcm9tIG11bHRpcGxlIGV2ZW50cyBhdCBvbmNlLiBUaGUgb2JqZWN0IHNob3VsZCBjb250YWluIGtleSB2YWx1ZSBwYWlycyBvZiBldmVudHMgYW5kIGxpc3RlbmVycyBvciBsaXN0ZW5lciBhcnJheXMuCgkgKiBZb3UgY2FuIGFsc28gcGFzcyBpdCBhbiBldmVudCBuYW1lIGFuZCBhbiBhcnJheSBvZiBsaXN0ZW5lcnMgdG8gYmUgYWRkZWQvcmVtb3ZlZC4KCSAqIFlvdSBjYW4gYWxzbyBwYXNzIGl0IGEgcmVndWxhciBleHByZXNzaW9uIHRvIG1hbmlwdWxhdGUgdGhlIGxpc3RlbmVycyBvZiBhbGwgZXZlbnRzIHRoYXQgbWF0Y2ggaXQuCgkgKgoJICogQHBhcmFtIHtCb29sZWFufSByZW1vdmUgVHJ1ZSBpZiB5b3Ugd2FudCB0byByZW1vdmUgbGlzdGVuZXJzLCBmYWxzZSBpZiB5b3Ugd2FudCB0byBhZGQuCgkgKiBAcGFyYW0ge1N0cmluZ3xPYmplY3R8UmVnRXhwfSBldnQgQW4gZXZlbnQgbmFtZSBpZiB5b3Ugd2lsbCBwYXNzIGFuIGFycmF5IG9mIGxpc3RlbmVycyBuZXh0LiBBbiBvYmplY3QgaWYgeW91IHdpc2ggdG8gYWRkL3JlbW92ZSBmcm9tIG11bHRpcGxlIGV2ZW50cyBhdCBvbmNlLgoJICogQHBhcmFtIHtGdW5jdGlvbltdfSBbbGlzdGVuZXJzXSBBbiBvcHRpb25hbCBhcnJheSBvZiBsaXN0ZW5lciBmdW5jdGlvbnMgdG8gYWRkL3JlbW92ZS4KCSAqIEByZXR1cm4ge09iamVjdH0gQ3VycmVudCBpbnN0YW5jZSBvZiBFdmVudEVtaXR0ZXIgZm9yIGNoYWluaW5nLgoJICovCglwcm90by5tYW5pcHVsYXRlTGlzdGVuZXJzID0gZnVuY3Rpb24gbWFuaXB1bGF0ZUxpc3RlbmVycyhyZW1vdmUsIGV2dCwgbGlzdGVuZXJzKSB7CgkJdmFyIGk7CgkJdmFyIHZhbHVlOwoJCXZhciBzaW5nbGUgPSByZW1vdmUgPyB0aGlzLnJlbW92ZUxpc3RlbmVyIDogdGhpcy5hZGRMaXN0ZW5lcjsKCQl2YXIgbXVsdGlwbGUgPSByZW1vdmUgPyB0aGlzLnJlbW92ZUxpc3RlbmVycyA6IHRoaXMuYWRkTGlzdGVuZXJzOwoKCQkvLyBJZiBldnQgaXMgYW4gb2JqZWN0IHRoZW4gcGFzcyBlYWNoIG9mIGl0cyBwcm9wZXJ0aWVzIHRvIHRoaXMgbWV0aG9kCgkJaWYgKHR5cGVvZiBldnQgPT09ICdvYmplY3QnICYmICEoZXZ0IGluc3RhbmNlb2YgUmVnRXhwKSkgewoJCQlmb3IgKGkgaW4gZXZ0KSB7CgkJCQlpZiAoZXZ0Lmhhc093blByb3BlcnR5KGkpICYmICh2YWx1ZSA9IGV2dFtpXSkpIHsKCQkJCQkvLyBQYXNzIHRoZSBzaW5nbGUgbGlzdGVuZXIgc3RyYWlnaHQgdGhyb3VnaCB0byB0aGUgc2luZ3VsYXIgbWV0aG9kCgkJCQkJaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ2Z1bmN0aW9uJykgewoJCQkJCQlzaW5nbGUuY2FsbCh0aGlzLCBpLCB2YWx1ZSk7CgkJCQkJfQoJCQkJCWVsc2UgewoJCQkJCQkvLyBPdGhlcndpc2UgcGFzcyBiYWNrIHRvIHRoZSBtdWx0aXBsZSBmdW5jdGlvbgoJCQkJCQltdWx0aXBsZS5jYWxsKHRoaXMsIGksIHZhbHVlKTsKCQkJCQl9CgkJCQl9CgkJCX0KCQl9CgkJZWxzZSB7CgkJCS8vIFNvIGV2dCBtdXN0IGJlIGEgc3RyaW5nCgkJCS8vIEFuZCBsaXN0ZW5lcnMgbXVzdCBiZSBhbiBhcnJheSBvZiBsaXN0ZW5lcnMKCQkJLy8gTG9vcCBvdmVyIGl0IGFuZCBwYXNzIGVhY2ggb25lIHRvIHRoZSBtdWx0aXBsZSBtZXRob2QKCQkJaSA9IGxpc3RlbmVycy5sZW5ndGg7CgkJCXdoaWxlIChpLS0pIHsKCQkJCXNpbmdsZS5jYWxsKHRoaXMsIGV2dCwgbGlzdGVuZXJzW2ldKTsKCQkJfQoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9OwoKCS8qKgoJICogUmVtb3ZlcyBhbGwgbGlzdGVuZXJzIGZyb20gYSBzcGVjaWZpZWQgZXZlbnQuCgkgKiBJZiB5b3UgZG8gbm90IHNwZWNpZnkgYW4gZXZlbnQgdGhlbiBhbGwgbGlzdGVuZXJzIHdpbGwgYmUgcmVtb3ZlZC4KCSAqIFRoYXQgbWVhbnMgZXZlcnkgZXZlbnQgd2lsbCBiZSBlbXB0aWVkLgoJICogWW91IGNhbiBhbHNvIHBhc3MgYSByZWdleCB0byByZW1vdmUgYWxsIGV2ZW50cyB0aGF0IG1hdGNoIGl0LgoJICoKCSAqIEBwYXJhbSB7U3RyaW5nfFJlZ0V4cH0gW2V2dF0gT3B0aW9uYWwgbmFtZSBvZiB0aGUgZXZlbnQgdG8gcmVtb3ZlIGFsbCBsaXN0ZW5lcnMgZm9yLiBXaWxsIHJlbW92ZSBmcm9tIGV2ZXJ5IGV2ZW50IGlmIG5vdCBwYXNzZWQuCgkgKiBAcmV0dXJuIHtPYmplY3R9IEN1cnJlbnQgaW5zdGFuY2Ugb2YgRXZlbnRFbWl0dGVyIGZvciBjaGFpbmluZy4KCSAqLwoJcHJvdG8ucmVtb3ZlRXZlbnQgPSBmdW5jdGlvbiByZW1vdmVFdmVudChldnQpIHsKCQl2YXIgdHlwZSA9IHR5cGVvZiBldnQ7CgkJdmFyIGV2ZW50cyA9IHRoaXMuX2dldEV2ZW50cygpOwoJCXZhciBrZXk7CgoJCS8vIFJlbW92ZSBkaWZmZXJlbnQgdGhpbmdzIGRlcGVuZGluZyBvbiB0aGUgc3RhdGUgb2YgZXZ0CgkJaWYgKHR5cGUgPT09ICdzdHJpbmcnKSB7CgkJCS8vIFJlbW92ZSBhbGwgbGlzdGVuZXJzIGZvciB0aGUgc3BlY2lmaWVkIGV2ZW50CgkJCWRlbGV0ZSBldmVudHNbZXZ0XTsKCQl9CgkJZWxzZSBpZiAoZXZ0IGluc3RhbmNlb2YgUmVnRXhwKSB7CgkJCS8vIFJlbW92ZSBhbGwgZXZlbnRzIG1hdGNoaW5nIHRoZSByZWdleC4KCQkJZm9yIChrZXkgaW4gZXZlbnRzKSB7CgkJCQlpZiAoZXZlbnRzLmhhc093blByb3BlcnR5KGtleSkgJiYgZXZ0LnRlc3Qoa2V5KSkgewoJCQkJCWRlbGV0ZSBldmVudHNba2V5XTsKCQkJCX0KCQkJfQoJCX0KCQllbHNlIHsKCQkJLy8gUmVtb3ZlIGFsbCBsaXN0ZW5lcnMgaW4gYWxsIGV2ZW50cwoJCQlkZWxldGUgdGhpcy5fZXZlbnRzOwoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9OwoKCS8qKgoJICogQWxpYXMgb2YgcmVtb3ZlRXZlbnQuCgkgKgoJICogQWRkZWQgdG8gbWlycm9yIHRoZSBub2RlIEFQSS4KCSAqLwoJcHJvdG8ucmVtb3ZlQWxsTGlzdGVuZXJzID0gYWxpYXMoJ3JlbW92ZUV2ZW50Jyk7CgoJLyoqCgkgKiBFbWl0cyBhbiBldmVudCBvZiB5b3VyIGNob2ljZS4KCSAqIFdoZW4gZW1pdHRlZCwgZXZlcnkgbGlzdGVuZXIgYXR0YWNoZWQgdG8gdGhhdCBldmVudCB3aWxsIGJlIGV4ZWN1dGVkLgoJICogSWYgeW91IHBhc3MgdGhlIG9wdGlvbmFsIGFyZ3VtZW50IGFycmF5IHRoZW4gdGhvc2UgYXJndW1lbnRzIHdpbGwgYmUgcGFzc2VkIHRvIGV2ZXJ5IGxpc3RlbmVyIHVwb24gZXhlY3V0aW9uLgoJICogQmVjYXVzZSBpdCB1c2VzIGBhcHBseWAsIHlvdXIgYXJyYXkgb2YgYXJndW1lbnRzIHdpbGwgYmUgcGFzc2VkIGFzIGlmIHlvdSB3cm90ZSB0aGVtIG91dCBzZXBhcmF0ZWx5LgoJICogU28gdGhleSB3aWxsIG5vdCBhcnJpdmUgd2l0aGluIHRoZSBhcnJheSBvbiB0aGUgb3RoZXIgc2lkZSwgdGhleSB3aWxsIGJlIHNlcGFyYXRlLgoJICogWW91IGNhbiBhbHNvIHBhc3MgYSByZWd1bGFyIGV4cHJlc3Npb24gdG8gZW1pdCB0byBhbGwgZXZlbnRzIHRoYXQgbWF0Y2ggaXQuCgkgKgoJICogQHBhcmFtIHtTdHJpbmd8UmVnRXhwfSBldnQgTmFtZSBvZiB0aGUgZXZlbnQgdG8gZW1pdCBhbmQgZXhlY3V0ZSBsaXN0ZW5lcnMgZm9yLgoJICogQHBhcmFtIHtBcnJheX0gW2FyZ3NdIE9wdGlvbmFsIGFycmF5IG9mIGFyZ3VtZW50cyB0byBiZSBwYXNzZWQgdG8gZWFjaCBsaXN0ZW5lci4KCSAqIEByZXR1cm4ge09iamVjdH0gQ3VycmVudCBpbnN0YW5jZSBvZiBFdmVudEVtaXR0ZXIgZm9yIGNoYWluaW5nLgoJICovCglwcm90by5lbWl0RXZlbnQgPSBmdW5jdGlvbiBlbWl0RXZlbnQoZXZ0LCBhcmdzKSB7CgkJdmFyIGxpc3RlbmVycyA9IHRoaXMuZ2V0TGlzdGVuZXJzQXNPYmplY3QoZXZ0KTsKCQl2YXIgbGlzdGVuZXI7CgkJdmFyIGk7CgkJdmFyIGtleTsKCQl2YXIgcmVzcG9uc2U7CgoJCWZvciAoa2V5IGluIGxpc3RlbmVycykgewoJCQlpZiAobGlzdGVuZXJzLmhhc093blByb3BlcnR5KGtleSkpIHsKCQkJCWkgPSBsaXN0ZW5lcnNba2V5XS5sZW5ndGg7CgoJCQkJd2hpbGUgKGktLSkgewoJCQkJCS8vIElmIHRoZSBsaXN0ZW5lciByZXR1cm5zIHRydWUgdGhlbiBpdCBzaGFsbCBiZSByZW1vdmVkIGZyb20gdGhlIGV2ZW50CgkJCQkJLy8gVGhlIGZ1bmN0aW9uIGlzIGV4ZWN1dGVkIGVpdGhlciB3aXRoIGEgYmFzaWMgY2FsbCBvciBhbiBhcHBseSBpZiB0aGVyZSBpcyBhbiBhcmdzIGFycmF5CgkJCQkJbGlzdGVuZXIgPSBsaXN0ZW5lcnNba2V5XVtpXTsKCgkJCQkJaWYgKGxpc3RlbmVyLm9uY2UgPT09IHRydWUpIHsKCQkJCQkJdGhpcy5yZW1vdmVMaXN0ZW5lcihldnQsIGxpc3RlbmVyLmxpc3RlbmVyKTsKCQkJCQl9CgoJCQkJCXJlc3BvbnNlID0gbGlzdGVuZXIubGlzdGVuZXIuYXBwbHkodGhpcywgYXJncyB8fCBbXSk7CgoJCQkJCWlmIChyZXNwb25zZSA9PT0gdGhpcy5fZ2V0T25jZVJldHVyblZhbHVlKCkpIHsKCQkJCQkJdGhpcy5yZW1vdmVMaXN0ZW5lcihldnQsIGxpc3RlbmVyLmxpc3RlbmVyKTsKCQkJCQl9CgkJCQl9CgkJCX0KCQl9CgoJCXJldHVybiB0aGlzOwoJfTsKCgkvKioKCSAqIEFsaWFzIG9mIGVtaXRFdmVudAoJICovCglwcm90by50cmlnZ2VyID0gYWxpYXMoJ2VtaXRFdmVudCcpOwoKCS8qKgoJICogU3VidGx5IGRpZmZlcmVudCBmcm9tIGVtaXRFdmVudCBpbiB0aGF0IGl0IHdpbGwgcGFzcyBpdHMgYXJndW1lbnRzIG9uIHRvIHRoZSBsaXN0ZW5lcnMsIGFzIG9wcG9zZWQgdG8gdGFraW5nIGEgc2luZ2xlIGFycmF5IG9mIGFyZ3VtZW50cyB0byBwYXNzIG9uLgoJICogQXMgd2l0aCBlbWl0RXZlbnQsIHlvdSBjYW4gcGFzcyBhIHJlZ2V4IGluIHBsYWNlIG9mIHRoZSBldmVudCBuYW1lIHRvIGVtaXQgdG8gYWxsIGV2ZW50cyB0aGF0IG1hdGNoIGl0LgoJICoKCSAqIEBwYXJhbSB7U3RyaW5nfFJlZ0V4cH0gZXZ0IE5hbWUgb2YgdGhlIGV2ZW50IHRvIGVtaXQgYW5kIGV4ZWN1dGUgbGlzdGVuZXJzIGZvci4KCSAqIEBwYXJhbSB7Li4uKn0gT3B0aW9uYWwgYWRkaXRpb25hbCBhcmd1bWVudHMgdG8gYmUgcGFzc2VkIHRvIGVhY2ggbGlzdGVuZXIuCgkgKiBAcmV0dXJuIHtPYmplY3R9IEN1cnJlbnQgaW5zdGFuY2Ugb2YgRXZlbnRFbWl0dGVyIGZvciBjaGFpbmluZy4KCSAqLwoJcHJvdG8uZW1pdCA9IGZ1bmN0aW9uIGVtaXQoZXZ0KSB7CgkJdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwoJCXJldHVybiB0aGlzLmVtaXRFdmVudChldnQsIGFyZ3MpOwoJfTsKCgkvKioKCSAqIFNldHMgdGhlIGN1cnJlbnQgdmFsdWUgdG8gY2hlY2sgYWdhaW5zdCB3aGVuIGV4ZWN1dGluZyBsaXN0ZW5lcnMuIElmIGEKCSAqIGxpc3RlbmVycyByZXR1cm4gdmFsdWUgbWF0Y2hlcyB0aGUgb25lIHNldCBoZXJlIHRoZW4gaXQgd2lsbCBiZSByZW1vdmVkCgkgKiBhZnRlciBleGVjdXRpb24uIFRoaXMgdmFsdWUgZGVmYXVsdHMgdG8gdHJ1ZS4KCSAqCgkgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSBuZXcgdmFsdWUgdG8gY2hlY2sgZm9yIHdoZW4gZXhlY3V0aW5nIGxpc3RlbmVycy4KCSAqIEByZXR1cm4ge09iamVjdH0gQ3VycmVudCBpbnN0YW5jZSBvZiBFdmVudEVtaXR0ZXIgZm9yIGNoYWluaW5nLgoJICovCglwcm90by5zZXRPbmNlUmV0dXJuVmFsdWUgPSBmdW5jdGlvbiBzZXRPbmNlUmV0dXJuVmFsdWUodmFsdWUpIHsKCQl0aGlzLl9vbmNlUmV0dXJuVmFsdWUgPSB2YWx1ZTsKCQlyZXR1cm4gdGhpczsKCX07CgoJLyoqCgkgKiBGZXRjaGVzIHRoZSBjdXJyZW50IHZhbHVlIHRvIGNoZWNrIGFnYWluc3Qgd2hlbiBleGVjdXRpbmcgbGlzdGVuZXJzLiBJZgoJICogdGhlIGxpc3RlbmVycyByZXR1cm4gdmFsdWUgbWF0Y2hlcyB0aGlzIG9uZSB0aGVuIGl0IHNob3VsZCBiZSByZW1vdmVkCgkgKiBhdXRvbWF0aWNhbGx5LiBJdCB3aWxsIHJldHVybiB0cnVlIGJ5IGRlZmF1bHQuCgkgKgoJICogQHJldHVybiB7KnxCb29sZWFufSBUaGUgY3VycmVudCB2YWx1ZSB0byBjaGVjayBmb3Igb3IgdGhlIGRlZmF1bHQsIHRydWUuCgkgKiBAYXBpIHByaXZhdGUKCSAqLwoJcHJvdG8uX2dldE9uY2VSZXR1cm5WYWx1ZSA9IGZ1bmN0aW9uIF9nZXRPbmNlUmV0dXJuVmFsdWUoKSB7CgkJaWYgKHRoaXMuaGFzT3duUHJvcGVydHkoJ19vbmNlUmV0dXJuVmFsdWUnKSkgewoJCQlyZXR1cm4gdGhpcy5fb25jZVJldHVyblZhbHVlOwoJCX0KCQllbHNlIHsKCQkJcmV0dXJuIHRydWU7CgkJfQoJfTsKCgkvKioKCSAqIEZldGNoZXMgdGhlIGV2ZW50cyBvYmplY3QgYW5kIGNyZWF0ZXMgb25lIGlmIHJlcXVpcmVkLgoJICoKCSAqIEByZXR1cm4ge09iamVjdH0gVGhlIGV2ZW50cyBzdG9yYWdlIG9iamVjdC4KCSAqIEBhcGkgcHJpdmF0ZQoJICovCglwcm90by5fZ2V0RXZlbnRzID0gZnVuY3Rpb24gX2dldEV2ZW50cygpIHsKCQlyZXR1cm4gdGhpcy5fZXZlbnRzIHx8ICh0aGlzLl9ldmVudHMgPSB7fSk7Cgl9OwoKCS8qKgoJICogUmV2ZXJ0cyB0aGUgZ2xvYmFsIHtAbGluayBFdmVudEVtaXR0ZXJ9IHRvIGl0cyBwcmV2aW91cyB2YWx1ZSBhbmQgcmV0dXJucyBhIHJlZmVyZW5jZSB0byB0aGlzIHZlcnNpb24uCgkgKgoJICogQHJldHVybiB7RnVuY3Rpb259IE5vbiBjb25mbGljdGluZyBFdmVudEVtaXR0ZXIgY2xhc3MuCgkgKi8KCUV2ZW50RW1pdHRlci5ub0NvbmZsaWN0ID0gZnVuY3Rpb24gbm9Db25mbGljdCgpIHsKCQlleHBvcnRzLkV2ZW50RW1pdHRlciA9IG9yaWdpbmFsR2xvYmFsVmFsdWU7CgkJcmV0dXJuIEV2ZW50RW1pdHRlcjsKCX07CgoJLy8gRXhwb3NlIHRoZSBjbGFzcyBlaXRoZXIgdmlhIEFNRCwgQ29tbW9uSlMgb3IgdGhlIGdsb2JhbCBvYmplY3QKCWlmICh0eXBlb2YgZGVmaW5lID09PSAnZnVuY3Rpb24nICYmIGRlZmluZS5hbWQpIHsKCQlkZWZpbmUoJ2V2ZW50RW1pdHRlci9FdmVudEVtaXR0ZXInLFtdLGZ1bmN0aW9uICgpIHsKCQkJcmV0dXJuIEV2ZW50RW1pdHRlcjsKCQl9KTsKCX0KCWVsc2UgaWYgKHR5cGVvZiBtb2R1bGUgPT09ICdvYmplY3QnICYmIG1vZHVsZS5leHBvcnRzKXsKCQltb2R1bGUuZXhwb3J0cyA9IEV2ZW50RW1pdHRlcjsKCX0KCWVsc2UgewoJCXRoaXMuRXZlbnRFbWl0dGVyID0gRXZlbnRFbWl0dGVyOwoJfQp9LmNhbGwodGhpcykpOwoKLyohCiAqIGdldFN0eWxlUHJvcGVydHkgdjEuMC4zCiAqIG9yaWdpbmFsIGJ5IGthbmdheAogKiBodHRwOi8vcGVyZmVjdGlvbmtpbGxzLmNvbS9mZWF0dXJlLXRlc3RpbmctY3NzLXByb3BlcnRpZXMvCiAqLwoKLypqc2hpbnQgYnJvd3NlcjogdHJ1ZSwgc3RyaWN0OiB0cnVlLCB1bmRlZjogdHJ1ZSAqLwovKmdsb2JhbCBkZWZpbmU6IGZhbHNlLCBleHBvcnRzOiBmYWxzZSwgbW9kdWxlOiBmYWxzZSAqLwoKKCBmdW5jdGlvbiggd2luZG93ICkgewoKCgp2YXIgcHJlZml4ZXMgPSAnV2Via2l0IE1veiBtcyBNcyBPJy5zcGxpdCgnICcpOwp2YXIgZG9jRWxlbVN0eWxlID0gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LnN0eWxlOwoKZnVuY3Rpb24gZ2V0U3R5bGVQcm9wZXJ0eSggcHJvcE5hbWUgKSB7CiAgaWYgKCAhcHJvcE5hbWUgKSB7CiAgICByZXR1cm47CiAgfQoKICAvLyB0ZXN0IHN0YW5kYXJkIHByb3BlcnR5IGZpcnN0CiAgaWYgKCB0eXBlb2YgZG9jRWxlbVN0eWxlWyBwcm9wTmFtZSBdID09PSAnc3RyaW5nJyApIHsKICAgIHJldHVybiBwcm9wTmFtZTsKICB9CgogIC8vIGNhcGl0YWxpemUKICBwcm9wTmFtZSA9IHByb3BOYW1lLmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpICsgcHJvcE5hbWUuc2xpY2UoMSk7CgogIC8vIHRlc3QgdmVuZG9yIHNwZWNpZmljIHByb3BlcnRpZXMKICB2YXIgcHJlZml4ZWQ7CiAgZm9yICggdmFyIGk9MCwgbGVuID0gcHJlZml4ZXMubGVuZ3RoOyBpIDwgbGVuOyBpKysgKSB7CiAgICBwcmVmaXhlZCA9IHByZWZpeGVzW2ldICsgcHJvcE5hbWU7CiAgICBpZiAoIHR5cGVvZiBkb2NFbGVtU3R5bGVbIHByZWZpeGVkIF0gPT09ICdzdHJpbmcnICkgewogICAgICByZXR1cm4gcHJlZml4ZWQ7CiAgICB9CiAgfQp9CgovLyB0cmFuc3BvcnQKaWYgKCB0eXBlb2YgZGVmaW5lID09PSAnZnVuY3Rpb24nICYmIGRlZmluZS5hbWQgKSB7CiAgLy8gQU1ECiAgZGVmaW5lKCAnZ2V0LXN0eWxlLXByb3BlcnR5L2dldC1zdHlsZS1wcm9wZXJ0eScsW10sZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gZ2V0U3R5bGVQcm9wZXJ0eTsKICB9KTsKfSBlbHNlIGlmICggdHlwZW9mIGV4cG9ydHMgPT09ICdvYmplY3QnICkgewogIC8vIENvbW1vbkpTIGZvciBDb21wb25lbnQKICBtb2R1bGUuZXhwb3J0cyA9IGdldFN0eWxlUHJvcGVydHk7Cn0gZWxzZSB7CiAgLy8gYnJvd3NlciBnbG9iYWwKICB3aW5kb3cuZ2V0U3R5bGVQcm9wZXJ0eSA9IGdldFN0eWxlUHJvcGVydHk7Cn0KCn0pKCB3aW5kb3cgKTsKCi8qKgogKiBnZXRTaXplIHYxLjEuNwogKiBtZWFzdXJlIHNpemUgb2YgZWxlbWVudHMKICovCgovKmpzaGludCBicm93c2VyOiB0cnVlLCBzdHJpY3Q6IHRydWUsIHVuZGVmOiB0cnVlLCB1bnVzZWQ6IHRydWUgKi8KLypnbG9iYWwgZGVmaW5lOiBmYWxzZSwgZXhwb3J0czogZmFsc2UsIHJlcXVpcmU6IGZhbHNlLCBtb2R1bGU6IGZhbHNlICovCgooIGZ1bmN0aW9uKCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCgoKLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gaGVscGVycyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSAvLwoKdmFyIGdldENvbXB1dGVkU3R5bGUgPSB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZTsKdmFyIGdldFN0eWxlID0gZ2V0Q29tcHV0ZWRTdHlsZSA/CiAgZnVuY3Rpb24oIGVsZW0gKSB7CiAgICByZXR1cm4gZ2V0Q29tcHV0ZWRTdHlsZSggZWxlbSwgbnVsbCApOwogIH0gOgogIGZ1bmN0aW9uKCBlbGVtICkgewogICAgcmV0dXJuIGVsZW0uY3VycmVudFN0eWxlOwogIH07CgovLyBnZXQgYSBudW1iZXIgZnJvbSBhIHN0cmluZywgbm90IGEgcGVyY2VudGFnZQpmdW5jdGlvbiBnZXRTdHlsZVNpemUoIHZhbHVlICkgewogIHZhciBudW0gPSBwYXJzZUZsb2F0KCB2YWx1ZSApOwogIC8vIG5vdCBhIHBlcmNlbnQgbGlrZSAnMTAwJScsIGFuZCBhIG51bWJlcgogIHZhciBpc1ZhbGlkID0gdmFsdWUuaW5kZXhPZignJScpID09PSAtMSAmJiAhaXNOYU4oIG51bSApOwogIHJldHVybiBpc1ZhbGlkICYmIG51bTsKfQoKLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gbWVhc3VyZW1lbnRzIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tIC8vCgp2YXIgbWVhc3VyZW1lbnRzID0gWwogICdwYWRkaW5nTGVmdCcsCiAgJ3BhZGRpbmdSaWdodCcsCiAgJ3BhZGRpbmdUb3AnLAogICdwYWRkaW5nQm90dG9tJywKICAnbWFyZ2luTGVmdCcsCiAgJ21hcmdpblJpZ2h0JywKICAnbWFyZ2luVG9wJywKICAnbWFyZ2luQm90dG9tJywKICAnYm9yZGVyTGVmdFdpZHRoJywKICAnYm9yZGVyUmlnaHRXaWR0aCcsCiAgJ2JvcmRlclRvcFdpZHRoJywKICAnYm9yZGVyQm90dG9tV2lkdGgnCl07CgpmdW5jdGlvbiBnZXRaZXJvU2l6ZSgpIHsKICB2YXIgc2l6ZSA9IHsKICAgIHdpZHRoOiAwLAogICAgaGVpZ2h0OiAwLAogICAgaW5uZXJXaWR0aDogMCwKICAgIGlubmVySGVpZ2h0OiAwLAogICAgb3V0ZXJXaWR0aDogMCwKICAgIG91dGVySGVpZ2h0OiAwCiAgfTsKICBmb3IgKCB2YXIgaT0wLCBsZW4gPSBtZWFzdXJlbWVudHMubGVuZ3RoOyBpIDwgbGVuOyBpKysgKSB7CiAgICB2YXIgbWVhc3VyZW1lbnQgPSBtZWFzdXJlbWVudHNbaV07CiAgICBzaXplWyBtZWFzdXJlbWVudCBdID0gMDsKICB9CiAgcmV0dXJuIHNpemU7Cn0KCgoKZnVuY3Rpb24gZGVmaW5lR2V0U2l6ZSggZ2V0U3R5bGVQcm9wZXJ0eSApIHsKCi8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tIGJveCBzaXppbmcgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gLy8KCnZhciBib3hTaXppbmdQcm9wID0gZ2V0U3R5bGVQcm9wZXJ0eSgnYm94U2l6aW5nJyk7CnZhciBpc0JveFNpemVPdXRlcjsKCi8qKgogKiBXZWJLaXQgbWVhc3VyZXMgdGhlIG91dGVyLXdpZHRoIG9uIHN0eWxlLndpZHRoIG9uIGJvcmRlci1ib3ggZWxlbXMKICogSUUgJiBGaXJlZm94IG1lYXN1cmVzIHRoZSBpbm5lci13aWR0aAogKi8KKCBmdW5jdGlvbigpIHsKICBpZiAoICFib3hTaXppbmdQcm9wICkgewogICAgcmV0dXJuOwogIH0KCiAgdmFyIGRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogIGRpdi5zdHlsZS53aWR0aCA9ICcyMDBweCc7CiAgZGl2LnN0eWxlLnBhZGRpbmcgPSAnMXB4IDJweCAzcHggNHB4JzsKICBkaXYuc3R5bGUuYm9yZGVyU3R5bGUgPSAnc29saWQnOwogIGRpdi5zdHlsZS5ib3JkZXJXaWR0aCA9ICcxcHggMnB4IDNweCA0cHgnOwogIGRpdi5zdHlsZVsgYm94U2l6aW5nUHJvcCBdID0gJ2JvcmRlci1ib3gnOwoKICB2YXIgYm9keSA9IGRvY3VtZW50LmJvZHkgfHwgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50OwogIGJvZHkuYXBwZW5kQ2hpbGQoIGRpdiApOwogIHZhciBzdHlsZSA9IGdldFN0eWxlKCBkaXYgKTsKCiAgaXNCb3hTaXplT3V0ZXIgPSBnZXRTdHlsZVNpemUoIHN0eWxlLndpZHRoICkgPT09IDIwMDsKICBib2R5LnJlbW92ZUNoaWxkKCBkaXYgKTsKfSkoKTsKCgovLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSBnZXRTaXplIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tIC8vCgpmdW5jdGlvbiBnZXRTaXplKCBlbGVtICkgewogIC8vIHVzZSBxdWVyeVNlbGV0b3IgaWYgZWxlbSBpcyBzdHJpbmcKICBpZiAoIHR5cGVvZiBlbGVtID09PSAnc3RyaW5nJyApIHsKICAgIGVsZW0gPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCBlbGVtICk7CiAgfQoKICAvLyBkbyBub3QgcHJvY2VlZCBvbiBub24tb2JqZWN0cwogIGlmICggIWVsZW0gfHwgdHlwZW9mIGVsZW0gIT09ICdvYmplY3QnIHx8ICFlbGVtLm5vZGVUeXBlICkgewogICAgcmV0dXJuOwogIH0KCiAgdmFyIHN0eWxlID0gZ2V0U3R5bGUoIGVsZW0gKTsKCiAgLy8gaWYgaGlkZGVuLCBldmVyeXRoaW5nIGlzIDAKICBpZiAoIHN0eWxlLmRpc3BsYXkgPT09ICdub25lJyApIHsKICAgIHJldHVybiBnZXRaZXJvU2l6ZSgpOwogIH0KCiAgdmFyIHNpemUgPSB7fTsKICBzaXplLndpZHRoID0gZWxlbS5vZmZzZXRXaWR0aDsKICBzaXplLmhlaWdodCA9IGVsZW0ub2Zmc2V0SGVpZ2h0OwoKICB2YXIgaXNCb3JkZXJCb3ggPSBzaXplLmlzQm9yZGVyQm94ID0gISEoIGJveFNpemluZ1Byb3AgJiYKICAgIHN0eWxlWyBib3hTaXppbmdQcm9wIF0gJiYgc3R5bGVbIGJveFNpemluZ1Byb3AgXSA9PT0gJ2JvcmRlci1ib3gnICk7CgogIC8vIGdldCBhbGwgbWVhc3VyZW1lbnRzCiAgZm9yICggdmFyIGk9MCwgbGVuID0gbWVhc3VyZW1lbnRzLmxlbmd0aDsgaSA8IGxlbjsgaSsrICkgewogICAgdmFyIG1lYXN1cmVtZW50ID0gbWVhc3VyZW1lbnRzW2ldOwogICAgdmFyIHZhbHVlID0gc3R5bGVbIG1lYXN1cmVtZW50IF07CiAgICB2YWx1ZSA9IG11bmdlTm9uUGl4ZWwoIGVsZW0sIHZhbHVlICk7CiAgICB2YXIgbnVtID0gcGFyc2VGbG9hdCggdmFsdWUgKTsKICAgIC8vIGFueSAnYXV0bycsICdtZWRpdW0nIHZhbHVlIHdpbGwgYmUgMAogICAgc2l6ZVsgbWVhc3VyZW1lbnQgXSA9ICFpc05hTiggbnVtICkgPyBudW0gOiAwOwogIH0KCiAgdmFyIHBhZGRpbmdXaWR0aCA9IHNpemUucGFkZGluZ0xlZnQgKyBzaXplLnBhZGRpbmdSaWdodDsKICB2YXIgcGFkZGluZ0hlaWdodCA9IHNpemUucGFkZGluZ1RvcCArIHNpemUucGFkZGluZ0JvdHRvbTsKICB2YXIgbWFyZ2luV2lkdGggPSBzaXplLm1hcmdpbkxlZnQgKyBzaXplLm1hcmdpblJpZ2h0OwogIHZhciBtYXJnaW5IZWlnaHQgPSBzaXplLm1hcmdpblRvcCArIHNpemUubWFyZ2luQm90dG9tOwogIHZhciBib3JkZXJXaWR0aCA9IHNpemUuYm9yZGVyTGVmdFdpZHRoICsgc2l6ZS5ib3JkZXJSaWdodFdpZHRoOwogIHZhciBib3JkZXJIZWlnaHQgPSBzaXplLmJvcmRlclRvcFdpZHRoICsgc2l6ZS5ib3JkZXJCb3R0b21XaWR0aDsKCiAgdmFyIGlzQm9yZGVyQm94U2l6ZU91dGVyID0gaXNCb3JkZXJCb3ggJiYgaXNCb3hTaXplT3V0ZXI7CgogIC8vIG92ZXJ3cml0ZSB3aWR0aCBhbmQgaGVpZ2h0IGlmIHdlIGNhbiBnZXQgaXQgZnJvbSBzdHlsZQogIHZhciBzdHlsZVdpZHRoID0gZ2V0U3R5bGVTaXplKCBzdHlsZS53aWR0aCApOwogIGlmICggc3R5bGVXaWR0aCAhPT0gZmFsc2UgKSB7CiAgICBzaXplLndpZHRoID0gc3R5bGVXaWR0aCArCiAgICAgIC8vIGFkZCBwYWRkaW5nIGFuZCBib3JkZXIgdW5sZXNzIGl0J3MgYWxyZWFkeSBpbmNsdWRpbmcgaXQKICAgICAgKCBpc0JvcmRlckJveFNpemVPdXRlciA/IDAgOiBwYWRkaW5nV2lkdGggKyBib3JkZXJXaWR0aCApOwogIH0KCiAgdmFyIHN0eWxlSGVpZ2h0ID0gZ2V0U3R5bGVTaXplKCBzdHlsZS5oZWlnaHQgKTsKICBpZiAoIHN0eWxlSGVpZ2h0ICE9PSBmYWxzZSApIHsKICAgIHNpemUuaGVpZ2h0ID0gc3R5bGVIZWlnaHQgKwogICAgICAvLyBhZGQgcGFkZGluZyBhbmQgYm9yZGVyIHVubGVzcyBpdCdzIGFscmVhZHkgaW5jbHVkaW5nIGl0CiAgICAgICggaXNCb3JkZXJCb3hTaXplT3V0ZXIgPyAwIDogcGFkZGluZ0hlaWdodCArIGJvcmRlckhlaWdodCApOwogIH0KCiAgc2l6ZS5pbm5lcldpZHRoID0gc2l6ZS53aWR0aCAtICggcGFkZGluZ1dpZHRoICsgYm9yZGVyV2lkdGggKTsKICBzaXplLmlubmVySGVpZ2h0ID0gc2l6ZS5oZWlnaHQgLSAoIHBhZGRpbmdIZWlnaHQgKyBib3JkZXJIZWlnaHQgKTsKCiAgc2l6ZS5vdXRlcldpZHRoID0gc2l6ZS53aWR0aCArIG1hcmdpbldpZHRoOwogIHNpemUub3V0ZXJIZWlnaHQgPSBzaXplLmhlaWdodCArIG1hcmdpbkhlaWdodDsKCiAgcmV0dXJuIHNpemU7Cn0KCi8vIElFOCByZXR1cm5zIHBlcmNlbnQgdmFsdWVzLCBub3QgcGl4ZWxzCi8vIHRha2VuIGZyb20galF1ZXJ5J3MgY3VyQ1NTCmZ1bmN0aW9uIG11bmdlTm9uUGl4ZWwoIGVsZW0sIHZhbHVlICkgewogIC8vIElFOCBhbmQgaGFzIHBlcmNlbnQgdmFsdWUKICBpZiAoIGdldENvbXB1dGVkU3R5bGUgfHwgdmFsdWUuaW5kZXhPZignJScpID09PSAtMSApIHsKICAgIHJldHVybiB2YWx1ZTsKICB9CiAgdmFyIHN0eWxlID0gZWxlbS5zdHlsZTsKICAvLyBSZW1lbWJlciB0aGUgb3JpZ2luYWwgdmFsdWVzCiAgdmFyIGxlZnQgPSBzdHlsZS5sZWZ0OwogIHZhciBycyA9IGVsZW0ucnVudGltZVN0eWxlOwogIHZhciByc0xlZnQgPSBycyAmJiBycy5sZWZ0OwoKICAvLyBQdXQgaW4gdGhlIG5ldyB2YWx1ZXMgdG8gZ2V0IGEgY29tcHV0ZWQgdmFsdWUgb3V0CiAgaWYgKCByc0xlZnQgKSB7CiAgICBycy5sZWZ0ID0gZWxlbS5jdXJyZW50U3R5bGUubGVmdDsKICB9CiAgc3R5bGUubGVmdCA9IHZhbHVlOwogIHZhbHVlID0gc3R5bGUucGl4ZWxMZWZ0OwoKICAvLyBSZXZlcnQgdGhlIGNoYW5nZWQgdmFsdWVzCiAgc3R5bGUubGVmdCA9IGxlZnQ7CiAgaWYgKCByc0xlZnQgKSB7CiAgICBycy5sZWZ0ID0gcnNMZWZ0OwogIH0KCiAgcmV0dXJuIHZhbHVlOwp9CgpyZXR1cm4gZ2V0U2l6ZTsKCn0KCi8vIHRyYW5zcG9ydAppZiAoIHR5cGVvZiBkZWZpbmUgPT09ICdmdW5jdGlvbicgJiYgZGVmaW5lLmFtZCApIHsKICAvLyBBTUQgZm9yIFJlcXVpcmVKUwogIGRlZmluZSggJ2dldC1zaXplL2dldC1zaXplJyxbICdnZXQtc3R5bGUtcHJvcGVydHkvZ2V0LXN0eWxlLXByb3BlcnR5JyBdLCBkZWZpbmVHZXRTaXplICk7Cn0gZWxzZSBpZiAoIHR5cGVvZiBleHBvcnRzID09PSAnb2JqZWN0JyApIHsKICAvLyBDb21tb25KUyBmb3IgQ29tcG9uZW50CiAgbW9kdWxlLmV4cG9ydHMgPSBkZWZpbmVHZXRTaXplKCByZXF1aXJlKCdnZXQtc3R5bGUtcHJvcGVydHknKSApOwp9IGVsc2UgewogIC8vIGJyb3dzZXIgZ2xvYmFsCiAgd2luZG93LmdldFNpemUgPSBkZWZpbmVHZXRTaXplKCB3aW5kb3cuZ2V0U3R5bGVQcm9wZXJ0eSApOwp9Cgp9KSggd2luZG93ICk7CgovKioKICogbWF0Y2hlc1NlbGVjdG9yIHYxLjAuMgogKiBtYXRjaGVzU2VsZWN0b3IoIGVsZW1lbnQsICcuc2VsZWN0b3InICkKICogTUlUIGxpY2Vuc2UKICovCgovKmpzaGludCBicm93c2VyOiB0cnVlLCBzdHJpY3Q6IHRydWUsIHVuZGVmOiB0cnVlLCB1bnVzZWQ6IHRydWUgKi8KLypnbG9iYWwgZGVmaW5lOiBmYWxzZSwgbW9kdWxlOiBmYWxzZSAqLwoKKCBmdW5jdGlvbiggRWxlbVByb3RvICkgewoKICAKCiAgdmFyIG1hdGNoZXNNZXRob2QgPSAoIGZ1bmN0aW9uKCkgewogICAgLy8gY2hlY2sgdW4tcHJlZml4ZWQKICAgIGlmICggRWxlbVByb3RvLm1hdGNoZXNTZWxlY3RvciApIHsKICAgICAgcmV0dXJuICdtYXRjaGVzU2VsZWN0b3InOwogICAgfQogICAgLy8gY2hlY2sgdmVuZG9yIHByZWZpeGVzCiAgICB2YXIgcHJlZml4ZXMgPSBbICd3ZWJraXQnLCAnbW96JywgJ21zJywgJ28nIF07CgogICAgZm9yICggdmFyIGk9MCwgbGVuID0gcHJlZml4ZXMubGVuZ3RoOyBpIDwgbGVuOyBpKysgKSB7CiAgICAgIHZhciBwcmVmaXggPSBwcmVmaXhlc1tpXTsKICAgICAgdmFyIG1ldGhvZCA9IHByZWZpeCArICdNYXRjaGVzU2VsZWN0b3InOwogICAgICBpZiAoIEVsZW1Qcm90b1sgbWV0aG9kIF0gKSB7CiAgICAgICAgcmV0dXJuIG1ldGhvZDsKICAgICAgfQogICAgfQogIH0pKCk7CgogIC8vIC0tLS0tIG1hdGNoIC0tLS0tIC8vCgogIGZ1bmN0aW9uIG1hdGNoKCBlbGVtLCBzZWxlY3RvciApIHsKICAgIHJldHVybiBlbGVtWyBtYXRjaGVzTWV0aG9kIF0oIHNlbGVjdG9yICk7CiAgfQoKICAvLyAtLS0tLSBhcHBlbmRUb0ZyYWdtZW50IC0tLS0tIC8vCgogIGZ1bmN0aW9uIGNoZWNrUGFyZW50KCBlbGVtICkgewogICAgLy8gbm90IG5lZWRlZCBpZiBhbHJlYWR5IGhhcyBwYXJlbnQKICAgIGlmICggZWxlbS5wYXJlbnROb2RlICkgewogICAgICByZXR1cm47CiAgICB9CiAgICB2YXIgZnJhZ21lbnQgPSBkb2N1bWVudC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCk7CiAgICBmcmFnbWVudC5hcHBlbmRDaGlsZCggZWxlbSApOwogIH0KCiAgLy8gLS0tLS0gcXVlcnkgLS0tLS0gLy8KCiAgLy8gZmFsbCBiYWNrIHRvIHVzaW5nIFFTQQogIC8vIHRoeCBAam9uYXRoYW50bmVhbCBodHRwczovL2dpc3QuZ2l0aHViLmNvbS8zMDYyOTU1CiAgZnVuY3Rpb24gcXVlcnkoIGVsZW0sIHNlbGVjdG9yICkgewogICAgLy8gYXBwZW5kIHRvIGZyYWdtZW50IGlmIG5vIHBhcmVudAogICAgY2hlY2tQYXJlbnQoIGVsZW0gKTsKCiAgICAvLyBtYXRjaCBlbGVtIHdpdGggYWxsIHNlbGVjdGVkIGVsZW1zIG9mIHBhcmVudAogICAgdmFyIGVsZW1zID0gZWxlbS5wYXJlbnROb2RlLnF1ZXJ5U2VsZWN0b3JBbGwoIHNlbGVjdG9yICk7CiAgICBmb3IgKCB2YXIgaT0wLCBsZW4gPSBlbGVtcy5sZW5ndGg7IGkgPCBsZW47IGkrKyApIHsKICAgICAgLy8gcmV0dXJuIHRydWUgaWYgbWF0Y2gKICAgICAgaWYgKCBlbGVtc1tpXSA9PT0gZWxlbSApIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgfQogICAgLy8gb3RoZXJ3aXNlIHJldHVybiBmYWxzZQogICAgcmV0dXJuIGZhbHNlOwogIH0KCiAgLy8gLS0tLS0gbWF0Y2hDaGlsZCAtLS0tLSAvLwoKICBmdW5jdGlvbiBtYXRjaENoaWxkKCBlbGVtLCBzZWxlY3RvciApIHsKICAgIGNoZWNrUGFyZW50KCBlbGVtICk7CiAgICByZXR1cm4gbWF0Y2goIGVsZW0sIHNlbGVjdG9yICk7CiAgfQoKICAvLyAtLS0tLSBtYXRjaGVzU2VsZWN0b3IgLS0tLS0gLy8KCiAgdmFyIG1hdGNoZXNTZWxlY3RvcjsKCiAgaWYgKCBtYXRjaGVzTWV0aG9kICkgewogICAgLy8gSUU5IHN1cHBvcnRzIG1hdGNoZXNTZWxlY3RvciwgYnV0IGRvZXNuJ3Qgd29yayBvbiBvcnBoYW5lZCBlbGVtcwogICAgLy8gY2hlY2sgZm9yIHRoYXQKICAgIHZhciBkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgIHZhciBzdXBwb3J0c09ycGhhbnMgPSBtYXRjaCggZGl2LCAnZGl2JyApOwogICAgbWF0Y2hlc1NlbGVjdG9yID0gc3VwcG9ydHNPcnBoYW5zID8gbWF0Y2ggOiBtYXRjaENoaWxkOwogIH0gZWxzZSB7CiAgICBtYXRjaGVzU2VsZWN0b3IgPSBxdWVyeTsKICB9CgogIC8vIHRyYW5zcG9ydAogIGlmICggdHlwZW9mIGRlZmluZSA9PT0gJ2Z1bmN0aW9uJyAmJiBkZWZpbmUuYW1kICkgewogICAgLy8gQU1ECiAgICBkZWZpbmUoICdtYXRjaGVzLXNlbGVjdG9yL21hdGNoZXMtc2VsZWN0b3InLFtdLGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gbWF0Y2hlc1NlbGVjdG9yOwogICAgfSk7CiAgfSBlbHNlIGlmICggdHlwZW9mIGV4cG9ydHMgPT09ICdvYmplY3QnICkgewogICAgbW9kdWxlLmV4cG9ydHMgPSBtYXRjaGVzU2VsZWN0b3I7CiAgfQogIGVsc2UgewogICAgLy8gYnJvd3NlciBnbG9iYWwKICAgIHdpbmRvdy5tYXRjaGVzU2VsZWN0b3IgPSBtYXRjaGVzU2VsZWN0b3I7CiAgfQoKfSkoIEVsZW1lbnQucHJvdG90eXBlICk7CgovKioKICogT3V0bGF5ZXIgSXRlbQogKi8KCiggZnVuY3Rpb24oIHdpbmRvdyApIHsKCgoKLy8gLS0tLS0gZ2V0IHN0eWxlIC0tLS0tIC8vCgp2YXIgZ2V0Q29tcHV0ZWRTdHlsZSA9IHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlOwp2YXIgZ2V0U3R5bGUgPSBnZXRDb21wdXRlZFN0eWxlID8KICBmdW5jdGlvbiggZWxlbSApIHsKICAgIHJldHVybiBnZXRDb21wdXRlZFN0eWxlKCBlbGVtLCBudWxsICk7CiAgfSA6CiAgZnVuY3Rpb24oIGVsZW0gKSB7CiAgICByZXR1cm4gZWxlbS5jdXJyZW50U3R5bGU7CiAgfTsKCgovLyBleHRlbmQgb2JqZWN0cwpmdW5jdGlvbiBleHRlbmQoIGEsIGIgKSB7CiAgZm9yICggdmFyIHByb3AgaW4gYiApIHsKICAgIGFbIHByb3AgXSA9IGJbIHByb3AgXTsKICB9CiAgcmV0dXJuIGE7Cn0KCmZ1bmN0aW9uIGlzRW1wdHlPYmooIG9iaiApIHsKICBmb3IgKCB2YXIgcHJvcCBpbiBvYmogKSB7CiAgICByZXR1cm4gZmFsc2U7CiAgfQogIHByb3AgPSBudWxsOwogIHJldHVybiB0cnVlOwp9CgovLyBodHRwOi8vamFtZXNyb2JlcnRzLm5hbWUvYmxvZy8yMDEwLzAyLzIyL3N0cmluZy1mdW5jdGlvbnMtZm9yLWphdmFzY3JpcHQtdHJpbS10by1jYW1lbC1jYXNlLXRvLWRhc2hlZC1hbmQtdG8tdW5kZXJzY29yZS8KZnVuY3Rpb24gdG9EYXNoKCBzdHIgKSB7CiAgcmV0dXJuIHN0ci5yZXBsYWNlKCAvKFtBLVpdKS9nLCBmdW5jdGlvbiggJDEgKXsKICAgIHJldHVybiAnLScgKyAkMS50b0xvd2VyQ2FzZSgpOwogIH0pOwp9CgovLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSBPdXRsYXllciBkZWZpbml0aW9uIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tIC8vCgpmdW5jdGlvbiBvdXRsYXllckl0ZW1EZWZpbml0aW9uKCBFdmVudEVtaXR0ZXIsIGdldFNpemUsIGdldFN0eWxlUHJvcGVydHkgKSB7CgovLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSBDU1MzIHN1cHBvcnQgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gLy8KCnZhciB0cmFuc2l0aW9uUHJvcGVydHkgPSBnZXRTdHlsZVByb3BlcnR5KCd0cmFuc2l0aW9uJyk7CnZhciB0cmFuc2Zvcm1Qcm9wZXJ0eSA9IGdldFN0eWxlUHJvcGVydHkoJ3RyYW5zZm9ybScpOwp2YXIgc3VwcG9ydHNDU1MzID0gdHJhbnNpdGlvblByb3BlcnR5ICYmIHRyYW5zZm9ybVByb3BlcnR5Owp2YXIgaXMzZCA9ICEhZ2V0U3R5bGVQcm9wZXJ0eSgncGVyc3BlY3RpdmUnKTsKCnZhciB0cmFuc2l0aW9uRW5kRXZlbnQgPSB7CiAgV2Via2l0VHJhbnNpdGlvbjogJ3dlYmtpdFRyYW5zaXRpb25FbmQnLAogIE1velRyYW5zaXRpb246ICd0cmFuc2l0aW9uZW5kJywKICBPVHJhbnNpdGlvbjogJ290cmFuc2l0aW9uZW5kJywKICB0cmFuc2l0aW9uOiAndHJhbnNpdGlvbmVuZCcKfVsgdHJhbnNpdGlvblByb3BlcnR5IF07CgovLyBwcm9wZXJ0aWVzIHRoYXQgY291bGQgaGF2ZSB2ZW5kb3IgcHJlZml4CnZhciBwcmVmaXhhYmxlUHJvcGVydGllcyA9IFsKICAndHJhbnNmb3JtJywKICAndHJhbnNpdGlvbicsCiAgJ3RyYW5zaXRpb25EdXJhdGlvbicsCiAgJ3RyYW5zaXRpb25Qcm9wZXJ0eScKXTsKCi8vIGNhY2hlIGFsbCB2ZW5kb3IgcHJvcGVydGllcwp2YXIgdmVuZG9yUHJvcGVydGllcyA9ICggZnVuY3Rpb24oKSB7CiAgdmFyIGNhY2hlID0ge307CiAgZm9yICggdmFyIGk9MCwgbGVuID0gcHJlZml4YWJsZVByb3BlcnRpZXMubGVuZ3RoOyBpIDwgbGVuOyBpKysgKSB7CiAgICB2YXIgcHJvcCA9IHByZWZpeGFibGVQcm9wZXJ0aWVzW2ldOwogICAgdmFyIHN1cHBvcnRlZFByb3AgPSBnZXRTdHlsZVByb3BlcnR5KCBwcm9wICk7CiAgICBpZiAoIHN1cHBvcnRlZFByb3AgJiYgc3VwcG9ydGVkUHJvcCAhPT0gcHJvcCApIHsKICAgICAgY2FjaGVbIHByb3AgXSA9IHN1cHBvcnRlZFByb3A7CiAgICB9CiAgfQogIHJldHVybiBjYWNoZTsKfSkoKTsKCi8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tIEl0ZW0gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gLy8KCmZ1bmN0aW9uIEl0ZW0oIGVsZW1lbnQsIGxheW91dCApIHsKICBpZiAoICFlbGVtZW50ICkgewogICAgcmV0dXJuOwogIH0KCiAgdGhpcy5lbGVtZW50ID0gZWxlbWVudDsKICAvLyBwYXJlbnQgbGF5b3V0IGNsYXNzLCBpLmUuIE1hc29ucnksIElzb3RvcGUsIG9yIFBhY2tlcnkKICB0aGlzLmxheW91dCA9IGxheW91dDsKICB0aGlzLnBvc2l0aW9uID0gewogICAgeDogMCwKICAgIHk6IDAKICB9OwoKICB0aGlzLl9jcmVhdGUoKTsKfQoKLy8gaW5oZXJpdCBFdmVudEVtaXR0ZXIKZXh0ZW5kKCBJdGVtLnByb3RvdHlwZSwgRXZlbnRFbWl0dGVyLnByb3RvdHlwZSApOwoKSXRlbS5wcm90b3R5cGUuX2NyZWF0ZSA9IGZ1bmN0aW9uKCkgewogIC8vIHRyYW5zaXRpb24gb2JqZWN0cwogIHRoaXMuX3RyYW5zbiA9IHsKICAgIGluZ1Byb3BlcnRpZXM6IHt9LAogICAgY2xlYW46IHt9LAogICAgb25FbmQ6IHt9CiAgfTsKCiAgdGhpcy5jc3MoewogICAgcG9zaXRpb246ICdhYnNvbHV0ZScKICB9KTsKfTsKCi8vIHRyaWdnZXIgc3BlY2lmaWVkIGhhbmRsZXIgZm9yIGV2ZW50IHR5cGUKSXRlbS5wcm90b3R5cGUuaGFuZGxlRXZlbnQgPSBmdW5jdGlvbiggZXZlbnQgKSB7CiAgdmFyIG1ldGhvZCA9ICdvbicgKyBldmVudC50eXBlOwogIGlmICggdGhpc1sgbWV0aG9kIF0gKSB7CiAgICB0aGlzWyBtZXRob2QgXSggZXZlbnQgKTsKICB9Cn07CgpJdGVtLnByb3RvdHlwZS5nZXRTaXplID0gZnVuY3Rpb24oKSB7CiAgdGhpcy5zaXplID0gZ2V0U2l6ZSggdGhpcy5lbGVtZW50ICk7Cn07CgovKioKICogYXBwbHkgQ1NTIHN0eWxlcyB0byBlbGVtZW50CiAqIEBwYXJhbSB7T2JqZWN0fSBzdHlsZQogKi8KSXRlbS5wcm90b3R5cGUuY3NzID0gZnVuY3Rpb24oIHN0eWxlICkgewogIHZhciBlbGVtU3R5bGUgPSB0aGlzLmVsZW1lbnQuc3R5bGU7CgogIGZvciAoIHZhciBwcm9wIGluIHN0eWxlICkgewogICAgLy8gdXNlIHZlbmRvciBwcm9wZXJ0eSBpZiBhdmFpbGFibGUKICAgIHZhciBzdXBwb3J0ZWRQcm9wID0gdmVuZG9yUHJvcGVydGllc1sgcHJvcCBdIHx8IHByb3A7CiAgICBlbGVtU3R5bGVbIHN1cHBvcnRlZFByb3AgXSA9IHN0eWxlWyBwcm9wIF07CiAgfQp9OwoKIC8vIG1lYXN1cmUgcG9zaXRpb24sIGFuZCBzZXRzIGl0Ckl0ZW0ucHJvdG90eXBlLmdldFBvc2l0aW9uID0gZnVuY3Rpb24oKSB7CiAgdmFyIHN0eWxlID0gZ2V0U3R5bGUoIHRoaXMuZWxlbWVudCApOwogIHZhciBsYXlvdXRPcHRpb25zID0gdGhpcy5sYXlvdXQub3B0aW9uczsKICB2YXIgaXNPcmlnaW5MZWZ0ID0gbGF5b3V0T3B0aW9ucy5pc09yaWdpbkxlZnQ7CiAgdmFyIGlzT3JpZ2luVG9wID0gbGF5b3V0T3B0aW9ucy5pc09yaWdpblRvcDsKICB2YXIgeCA9IHBhcnNlSW50KCBzdHlsZVsgaXNPcmlnaW5MZWZ0ID8gJ2xlZnQnIDogJ3JpZ2h0JyBdLCAxMCApOwogIHZhciB5ID0gcGFyc2VJbnQoIHN0eWxlWyBpc09yaWdpblRvcCA/ICd0b3AnIDogJ2JvdHRvbScgXSwgMTAgKTsKCiAgLy8gY2xlYW4gdXAgJ2F1dG8nIG9yIG90aGVyIG5vbi1pbnRlZ2VyIHZhbHVlcwogIHggPSBpc05hTiggeCApID8gMCA6IHg7CiAgeSA9IGlzTmFOKCB5ICkgPyAwIDogeTsKICAvLyByZW1vdmUgcGFkZGluZyBmcm9tIG1lYXN1cmVtZW50CiAgdmFyIGxheW91dFNpemUgPSB0aGlzLmxheW91dC5zaXplOwogIHggLT0gaXNPcmlnaW5MZWZ0ID8gbGF5b3V0U2l6ZS5wYWRkaW5nTGVmdCA6IGxheW91dFNpemUucGFkZGluZ1JpZ2h0OwogIHkgLT0gaXNPcmlnaW5Ub3AgPyBsYXlvdXRTaXplLnBhZGRpbmdUb3AgOiBsYXlvdXRTaXplLnBhZGRpbmdCb3R0b207CgogIHRoaXMucG9zaXRpb24ueCA9IHg7CiAgdGhpcy5wb3NpdGlvbi55ID0geTsKfTsKCi8vIHNldCBzZXR0bGVkIHBvc2l0aW9uLCBhcHBseSBwYWRkaW5nCkl0ZW0ucHJvdG90eXBlLmxheW91dFBvc2l0aW9uID0gZnVuY3Rpb24oKSB7CiAgdmFyIGxheW91dFNpemUgPSB0aGlzLmxheW91dC5zaXplOwogIHZhciBsYXlvdXRPcHRpb25zID0gdGhpcy5sYXlvdXQub3B0aW9uczsKICB2YXIgc3R5bGUgPSB7fTsKCiAgaWYgKCBsYXlvdXRPcHRpb25zLmlzT3JpZ2luTGVmdCApIHsKICAgIHN0eWxlLmxlZnQgPSAoIHRoaXMucG9zaXRpb24ueCArIGxheW91dFNpemUucGFkZGluZ0xlZnQgKSArICdweCc7CiAgICAvLyByZXNldCBvdGhlciBwcm9wZXJ0eQogICAgc3R5bGUucmlnaHQgPSAnJzsKICB9IGVsc2UgewogICAgc3R5bGUucmlnaHQgPSAoIHRoaXMucG9zaXRpb24ueCArIGxheW91dFNpemUucGFkZGluZ1JpZ2h0ICkgKyAncHgnOwogICAgc3R5bGUubGVmdCA9ICcnOwogIH0KCiAgaWYgKCBsYXlvdXRPcHRpb25zLmlzT3JpZ2luVG9wICkgewogICAgc3R5bGUudG9wID0gKCB0aGlzLnBvc2l0aW9uLnkgKyBsYXlvdXRTaXplLnBhZGRpbmdUb3AgKSArICdweCc7CiAgICBzdHlsZS5ib3R0b20gPSAnJzsKICB9IGVsc2UgewogICAgc3R5bGUuYm90dG9tID0gKCB0aGlzLnBvc2l0aW9uLnkgKyBsYXlvdXRTaXplLnBhZGRpbmdCb3R0b20gKSArICdweCc7CiAgICBzdHlsZS50b3AgPSAnJzsKICB9CgogIHRoaXMuY3NzKCBzdHlsZSApOwogIHRoaXMuZW1pdEV2ZW50KCAnbGF5b3V0JywgWyB0aGlzIF0gKTsKfTsKCgovLyB0cmFuc2Zvcm0gdHJhbnNsYXRlIGZ1bmN0aW9uCnZhciB0cmFuc2xhdGUgPSBpczNkID8KICBmdW5jdGlvbiggeCwgeSApIHsKICAgIHJldHVybiAndHJhbnNsYXRlM2QoJyArIHggKyAncHgsICcgKyB5ICsgJ3B4LCAwKSc7CiAgfSA6CiAgZnVuY3Rpb24oIHgsIHkgKSB7CiAgICByZXR1cm4gJ3RyYW5zbGF0ZSgnICsgeCArICdweCwgJyArIHkgKyAncHgpJzsKICB9OwoKCkl0ZW0ucHJvdG90eXBlLl90cmFuc2l0aW9uVG8gPSBmdW5jdGlvbiggeCwgeSApIHsKICB0aGlzLmdldFBvc2l0aW9uKCk7CiAgLy8gZ2V0IGN1cnJlbnQgeCAmIHkgZnJvbSB0b3AvbGVmdAogIHZhciBjdXJYID0gdGhpcy5wb3NpdGlvbi54OwogIHZhciBjdXJZID0gdGhpcy5wb3NpdGlvbi55OwoKICB2YXIgY29tcGFyZVggPSBwYXJzZUludCggeCwgMTAgKTsKICB2YXIgY29tcGFyZVkgPSBwYXJzZUludCggeSwgMTAgKTsKICB2YXIgZGlkTm90TW92ZSA9IGNvbXBhcmVYID09PSB0aGlzLnBvc2l0aW9uLnggJiYgY29tcGFyZVkgPT09IHRoaXMucG9zaXRpb24ueTsKCiAgLy8gc2F2ZSBlbmQgcG9zaXRpb24KICB0aGlzLnNldFBvc2l0aW9uKCB4LCB5ICk7CgogIC8vIGlmIGRpZCBub3QgbW92ZSBhbmQgbm90IHRyYW5zaXRpb25pbmcsIGp1c3QgZ28gdG8gbGF5b3V0CiAgaWYgKCBkaWROb3RNb3ZlICYmICF0aGlzLmlzVHJhbnNpdGlvbmluZyApIHsKICAgIHRoaXMubGF5b3V0UG9zaXRpb24oKTsKICAgIHJldHVybjsKICB9CgogIHZhciB0cmFuc1ggPSB4IC0gY3VyWDsKICB2YXIgdHJhbnNZID0geSAtIGN1clk7CiAgdmFyIHRyYW5zaXRpb25TdHlsZSA9IHt9OwogIC8vIGZsaXAgY29vcmlkaW5hdGVzIGlmIG9yaWdpbiBvbiByaWdodCBvciBib3R0b20KICB2YXIgbGF5b3V0T3B0aW9ucyA9IHRoaXMubGF5b3V0Lm9wdGlvbnM7CiAgdHJhbnNYID0gbGF5b3V0T3B0aW9ucy5pc09yaWdpbkxlZnQgPyB0cmFuc1ggOiAtdHJhbnNYOwogIHRyYW5zWSA9IGxheW91dE9wdGlvbnMuaXNPcmlnaW5Ub3AgPyB0cmFuc1kgOiAtdHJhbnNZOwogIHRyYW5zaXRpb25TdHlsZS50cmFuc2Zvcm0gPSB0cmFuc2xhdGUoIHRyYW5zWCwgdHJhbnNZICk7CgogIHRoaXMudHJhbnNpdGlvbih7CiAgICB0bzogdHJhbnNpdGlvblN0eWxlLAogICAgb25UcmFuc2l0aW9uRW5kOiB7CiAgICAgIHRyYW5zZm9ybTogdGhpcy5sYXlvdXRQb3NpdGlvbgogICAgfSwKICAgIGlzQ2xlYW5pbmc6IHRydWUKICB9KTsKfTsKCi8vIG5vbiB0cmFuc2l0aW9uICsgdHJhbnNmb3JtIHN1cHBvcnQKSXRlbS5wcm90b3R5cGUuZ29UbyA9IGZ1bmN0aW9uKCB4LCB5ICkgewogIHRoaXMuc2V0UG9zaXRpb24oIHgsIHkgKTsKICB0aGlzLmxheW91dFBvc2l0aW9uKCk7Cn07CgovLyB1c2UgdHJhbnNpdGlvbiBhbmQgdHJhbnNmb3JtcyBpZiBzdXBwb3J0ZWQKSXRlbS5wcm90b3R5cGUubW92ZVRvID0gc3VwcG9ydHNDU1MzID8KICBJdGVtLnByb3RvdHlwZS5fdHJhbnNpdGlvblRvIDogSXRlbS5wcm90b3R5cGUuZ29UbzsKCkl0ZW0ucHJvdG90eXBlLnNldFBvc2l0aW9uID0gZnVuY3Rpb24oIHgsIHkgKSB7CiAgdGhpcy5wb3NpdGlvbi54ID0gcGFyc2VJbnQoIHgsIDEwICk7CiAgdGhpcy5wb3NpdGlvbi55ID0gcGFyc2VJbnQoIHksIDEwICk7Cn07CgovLyAtLS0tLSB0cmFuc2l0aW9uIC0tLS0tIC8vCgovKioKICogQHBhcmFtIHtPYmplY3R9IHN0eWxlIC0gQ1NTCiAqIEBwYXJhbSB7RnVuY3Rpb259IG9uVHJhbnNpdGlvbkVuZAogKi8KCi8vIG5vbiB0cmFuc2l0aW9uLCBqdXN0IHRyaWdnZXIgY2FsbGJhY2sKSXRlbS5wcm90b3R5cGUuX25vblRyYW5zaXRpb24gPSBmdW5jdGlvbiggYXJncyApIHsKICB0aGlzLmNzcyggYXJncy50byApOwogIGlmICggYXJncy5pc0NsZWFuaW5nICkgewogICAgdGhpcy5fcmVtb3ZlU3R5bGVzKCBhcmdzLnRvICk7CiAgfQogIGZvciAoIHZhciBwcm9wIGluIGFyZ3Mub25UcmFuc2l0aW9uRW5kICkgewogICAgYXJncy5vblRyYW5zaXRpb25FbmRbIHByb3AgXS5jYWxsKCB0aGlzICk7CiAgfQp9OwoKLyoqCiAqIHByb3BlciB0cmFuc2l0aW9uCiAqIEBwYXJhbSB7T2JqZWN0fSBhcmdzIC0gYXJndW1lbnRzCiAqICAgQHBhcmFtIHtPYmplY3R9IHRvIC0gc3R5bGUgdG8gdHJhbnNpdGlvbiB0bwogKiAgIEBwYXJhbSB7T2JqZWN0fSBmcm9tIC0gc3R5bGUgdG8gc3RhcnQgdHJhbnNpdGlvbiBmcm9tCiAqICAgQHBhcmFtIHtCb29sZWFufSBpc0NsZWFuaW5nIC0gcmVtb3ZlcyB0cmFuc2l0aW9uIHN0eWxlcyBhZnRlciB0cmFuc2l0aW9uCiAqICAgQHBhcmFtIHtGdW5jdGlvbn0gb25UcmFuc2l0aW9uRW5kIC0gY2FsbGJhY2sKICovCkl0ZW0ucHJvdG90eXBlLl90cmFuc2l0aW9uID0gZnVuY3Rpb24oIGFyZ3MgKSB7CiAgLy8gcmVkaXJlY3QgdG8gbm9uVHJhbnNpdGlvbiBpZiBubyB0cmFuc2l0aW9uIGR1cmF0aW9uCiAgaWYgKCAhcGFyc2VGbG9hdCggdGhpcy5sYXlvdXQub3B0aW9ucy50cmFuc2l0aW9uRHVyYXRpb24gKSApIHsKICAgIHRoaXMuX25vblRyYW5zaXRpb24oIGFyZ3MgKTsKICAgIHJldHVybjsKICB9CgogIHZhciBfdHJhbnNpdGlvbiA9IHRoaXMuX3RyYW5zbjsKICAvLyBrZWVwIHRyYWNrIG9mIG9uVHJhbnNpdGlvbkVuZCBjYWxsYmFjayBieSBjc3MgcHJvcGVydHkKICBmb3IgKCB2YXIgcHJvcCBpbiBhcmdzLm9uVHJhbnNpdGlvbkVuZCApIHsKICAgIF90cmFuc2l0aW9uLm9uRW5kWyBwcm9wIF0gPSBhcmdzLm9uVHJhbnNpdGlvbkVuZFsgcHJvcCBdOwogIH0KICAvLyBrZWVwIHRyYWNrIG9mIHByb3BlcnRpZXMgdGhhdCBhcmUgdHJhbnNpdGlvbmluZwogIGZvciAoIHByb3AgaW4gYXJncy50byApIHsKICAgIF90cmFuc2l0aW9uLmluZ1Byb3BlcnRpZXNbIHByb3AgXSA9IHRydWU7CiAgICAvLyBrZWVwIHRyYWNrIG9mIHByb3BlcnRpZXMgdG8gY2xlYW4gdXAgd2hlbiB0cmFuc2l0aW9uIGlzIGRvbmUKICAgIGlmICggYXJncy5pc0NsZWFuaW5nICkgewogICAgICBfdHJhbnNpdGlvbi5jbGVhblsgcHJvcCBdID0gdHJ1ZTsKICAgIH0KICB9CgogIC8vIHNldCBmcm9tIHN0eWxlcwogIGlmICggYXJncy5mcm9tICkgewogICAgdGhpcy5jc3MoIGFyZ3MuZnJvbSApOwogICAgLy8gZm9yY2UgcmVkcmF3LiBodHRwOi8vYmxvZy5hbGV4bWFjY2F3LmNvbS9jc3MtdHJhbnNpdGlvbnMKICAgIHZhciBoID0gdGhpcy5lbGVtZW50Lm9mZnNldEhlaWdodDsKICAgIC8vIGhhY2sgZm9yIEpTSGludCB0byBodXNoIGFib3V0IHVudXNlZCB2YXIKICAgIGggPSBudWxsOwogIH0KICAvLyBlbmFibGUgdHJhbnNpdGlvbgogIHRoaXMuZW5hYmxlVHJhbnNpdGlvbiggYXJncy50byApOwogIC8vIHNldCBzdHlsZXMgdGhhdCBhcmUgdHJhbnNpdGlvbmluZwogIHRoaXMuY3NzKCBhcmdzLnRvICk7CgogIHRoaXMuaXNUcmFuc2l0aW9uaW5nID0gdHJ1ZTsKCn07Cgp2YXIgaXRlbVRyYW5zaXRpb25Qcm9wZXJ0aWVzID0gdHJhbnNmb3JtUHJvcGVydHkgJiYgKCB0b0Rhc2goIHRyYW5zZm9ybVByb3BlcnR5ICkgKwogICcsb3BhY2l0eScgKTsKCkl0ZW0ucHJvdG90eXBlLmVuYWJsZVRyYW5zaXRpb24gPSBmdW5jdGlvbigvKiBzdHlsZSAqLykgewogIC8vIG9ubHkgZW5hYmxlIGlmIG5vdCBhbHJlYWR5IHRyYW5zaXRpb25pbmcKICAvLyBidWcgaW4gSUUxMCB3ZXJlIHJlLXNldHRpbmcgdHJhbnNpdGlvbiBzdHlsZSB3aWxsIHByZXZlbnQKICAvLyB0cmFuc2l0aW9uZW5kIGV2ZW50IGZyb20gdHJpZ2dlcmluZwogIGlmICggdGhpcy5pc1RyYW5zaXRpb25pbmcgKSB7CiAgICByZXR1cm47CiAgfQoKICAvLyBtYWtlIHRyYW5zaXRpb246IGZvbywgYmFyLCBiYXogZnJvbSBzdHlsZSBvYmplY3QKICAvLyBUT0RPIHVuY29tbWVudCB0aGlzIGJpdCB3aGVuIElFMTAgYnVnIGlzIHJlc29sdmVkCiAgLy8gdmFyIHRyYW5zaXRpb25WYWx1ZSA9IFtdOwogIC8vIGZvciAoIHZhciBwcm9wIGluIHN0eWxlICkgewogIC8vICAgLy8gZGFzaC1pZnkgY2FtZWxDYXNlZCBwcm9wZXJ0aWVzIGxpa2UgV2Via2l0VHJhbnNpdGlvbgogIC8vICAgdHJhbnNpdGlvblZhbHVlLnB1c2goIHRvRGFzaCggcHJvcCApICk7CiAgLy8gfQogIC8vIGVuYWJsZSB0cmFuc2l0aW9uIHN0eWxlcwogIC8vIEhBQ0sgYWx3YXlzIGVuYWJsZSB0cmFuc2Zvcm0sb3BhY2l0eSBmb3IgSUUxMAogIHRoaXMuY3NzKHsKICAgIHRyYW5zaXRpb25Qcm9wZXJ0eTogaXRlbVRyYW5zaXRpb25Qcm9wZXJ0aWVzLAogICAgdHJhbnNpdGlvbkR1cmF0aW9uOiB0aGlzLmxheW91dC5vcHRpb25zLnRyYW5zaXRpb25EdXJhdGlvbgogIH0pOwogIC8vIGxpc3RlbiBmb3IgdHJhbnNpdGlvbiBlbmQgZXZlbnQKICB0aGlzLmVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lciggdHJhbnNpdGlvbkVuZEV2ZW50LCB0aGlzLCBmYWxzZSApOwp9OwoKSXRlbS5wcm90b3R5cGUudHJhbnNpdGlvbiA9IEl0ZW0ucHJvdG90eXBlWyB0cmFuc2l0aW9uUHJvcGVydHkgPyAnX3RyYW5zaXRpb24nIDogJ19ub25UcmFuc2l0aW9uJyBdOwoKLy8gLS0tLS0gZXZlbnRzIC0tLS0tIC8vCgpJdGVtLnByb3RvdHlwZS5vbndlYmtpdFRyYW5zaXRpb25FbmQgPSBmdW5jdGlvbiggZXZlbnQgKSB7CiAgdGhpcy5vbnRyYW5zaXRpb25lbmQoIGV2ZW50ICk7Cn07CgpJdGVtLnByb3RvdHlwZS5vbm90cmFuc2l0aW9uZW5kID0gZnVuY3Rpb24oIGV2ZW50ICkgewogIHRoaXMub250cmFuc2l0aW9uZW5kKCBldmVudCApOwp9OwoKLy8gcHJvcGVydGllcyB0aGF0IEkgbXVuZ2UgdG8gbWFrZSBteSBsaWZlIGVhc2llcgp2YXIgZGFzaGVkVmVuZG9yUHJvcGVydGllcyA9IHsKICAnLXdlYmtpdC10cmFuc2Zvcm0nOiAndHJhbnNmb3JtJywKICAnLW1vei10cmFuc2Zvcm0nOiAndHJhbnNmb3JtJywKICAnLW8tdHJhbnNmb3JtJzogJ3RyYW5zZm9ybScKfTsKCkl0ZW0ucHJvdG90eXBlLm9udHJhbnNpdGlvbmVuZCA9IGZ1bmN0aW9uKCBldmVudCApIHsKICAvLyBkaXNyZWdhcmQgYnViYmxlZCBldmVudHMgZnJvbSBjaGlsZHJlbgogIGlmICggZXZlbnQudGFyZ2V0ICE9PSB0aGlzLmVsZW1lbnQgKSB7CiAgICByZXR1cm47CiAgfQogIHZhciBfdHJhbnNpdGlvbiA9IHRoaXMuX3RyYW5zbjsKICAvLyBnZXQgcHJvcGVydHkgbmFtZSBvZiB0cmFuc2l0aW9uZWQgcHJvcGVydHksIGNvbnZlcnQgdG8gcHJlZml4LWZyZWUKICB2YXIgcHJvcGVydHlOYW1lID0gZGFzaGVkVmVuZG9yUHJvcGVydGllc1sgZXZlbnQucHJvcGVydHlOYW1lIF0gfHwgZXZlbnQucHJvcGVydHlOYW1lOwoKICAvLyByZW1vdmUgcHJvcGVydHkgdGhhdCBoYXMgY29tcGxldGVkIHRyYW5zaXRpb25pbmcKICBkZWxldGUgX3RyYW5zaXRpb24uaW5nUHJvcGVydGllc1sgcHJvcGVydHlOYW1lIF07CiAgLy8gY2hlY2sgaWYgYW55IHByb3BlcnRpZXMgYXJlIHN0aWxsIHRyYW5zaXRpb25pbmcKICBpZiAoIGlzRW1wdHlPYmooIF90cmFuc2l0aW9uLmluZ1Byb3BlcnRpZXMgKSApIHsKICAgIC8vIGFsbCBwcm9wZXJ0aWVzIGhhdmUgY29tcGxldGVkIHRyYW5zaXRpb25pbmcKICAgIHRoaXMuZGlzYWJsZVRyYW5zaXRpb24oKTsKICB9CiAgLy8gY2xlYW4gc3R5bGUKICBpZiAoIHByb3BlcnR5TmFtZSBpbiBfdHJhbnNpdGlvbi5jbGVhbiApIHsKICAgIC8vIGNsZWFuIHVwIHN0eWxlCiAgICB0aGlzLmVsZW1lbnQuc3R5bGVbIGV2ZW50LnByb3BlcnR5TmFtZSBdID0gJyc7CiAgICBkZWxldGUgX3RyYW5zaXRpb24uY2xlYW5bIHByb3BlcnR5TmFtZSBdOwogIH0KICAvLyB0cmlnZ2VyIG9uVHJhbnNpdGlvbkVuZCBjYWxsYmFjawogIGlmICggcHJvcGVydHlOYW1lIGluIF90cmFuc2l0aW9uLm9uRW5kICkgewogICAgdmFyIG9uVHJhbnNpdGlvbkVuZCA9IF90cmFuc2l0aW9uLm9uRW5kWyBwcm9wZXJ0eU5hbWUgXTsKICAgIG9uVHJhbnNpdGlvbkVuZC5jYWxsKCB0aGlzICk7CiAgICBkZWxldGUgX3RyYW5zaXRpb24ub25FbmRbIHByb3BlcnR5TmFtZSBdOwogIH0KCiAgdGhpcy5lbWl0RXZlbnQoICd0cmFuc2l0aW9uRW5kJywgWyB0aGlzIF0gKTsKfTsKCkl0ZW0ucHJvdG90eXBlLmRpc2FibGVUcmFuc2l0aW9uID0gZnVuY3Rpb24oKSB7CiAgdGhpcy5yZW1vdmVUcmFuc2l0aW9uU3R5bGVzKCk7CiAgdGhpcy5lbGVtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoIHRyYW5zaXRpb25FbmRFdmVudCwgdGhpcywgZmFsc2UgKTsKICB0aGlzLmlzVHJhbnNpdGlvbmluZyA9IGZhbHNlOwp9OwoKLyoqCiAqIHJlbW92ZXMgc3R5bGUgcHJvcGVydHkgZnJvbSBlbGVtZW50CiAqIEBwYXJhbSB7T2JqZWN0fSBzdHlsZQoqKi8KSXRlbS5wcm90b3R5cGUuX3JlbW92ZVN0eWxlcyA9IGZ1bmN0aW9uKCBzdHlsZSApIHsKICAvLyBjbGVhbiB1cCB0cmFuc2l0aW9uIHN0eWxlcwogIHZhciBjbGVhblN0eWxlID0ge307CiAgZm9yICggdmFyIHByb3AgaW4gc3R5bGUgKSB7CiAgICBjbGVhblN0eWxlWyBwcm9wIF0gPSAnJzsKICB9CiAgdGhpcy5jc3MoIGNsZWFuU3R5bGUgKTsKfTsKCnZhciBjbGVhblRyYW5zaXRpb25TdHlsZSA9IHsKICB0cmFuc2l0aW9uUHJvcGVydHk6ICcnLAogIHRyYW5zaXRpb25EdXJhdGlvbjogJycKfTsKCkl0ZW0ucHJvdG90eXBlLnJlbW92ZVRyYW5zaXRpb25TdHlsZXMgPSBmdW5jdGlvbigpIHsKICAvLyByZW1vdmUgdHJhbnNpdGlvbgogIHRoaXMuY3NzKCBjbGVhblRyYW5zaXRpb25TdHlsZSApOwp9OwoKLy8gLS0tLS0gc2hvdy9oaWRlL3JlbW92ZSAtLS0tLSAvLwoKLy8gcmVtb3ZlIGVsZW1lbnQgZnJvbSBET00KSXRlbS5wcm90b3R5cGUucmVtb3ZlRWxlbSA9IGZ1bmN0aW9uKCkgewogIHRoaXMuZWxlbWVudC5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKCB0aGlzLmVsZW1lbnQgKTsKICB0aGlzLmVtaXRFdmVudCggJ3JlbW92ZScsIFsgdGhpcyBdICk7Cn07CgpJdGVtLnByb3RvdHlwZS5yZW1vdmUgPSBmdW5jdGlvbigpIHsKICAvLyBqdXN0IHJlbW92ZSBlbGVtZW50IGlmIG5vIHRyYW5zaXRpb24gc3VwcG9ydCBvciBubyB0cmFuc2l0aW9uCiAgaWYgKCAhdHJhbnNpdGlvblByb3BlcnR5IHx8ICFwYXJzZUZsb2F0KCB0aGlzLmxheW91dC5vcHRpb25zLnRyYW5zaXRpb25EdXJhdGlvbiApICkgewogICAgdGhpcy5yZW1vdmVFbGVtKCk7CiAgICByZXR1cm47CiAgfQoKICAvLyBzdGFydCB0cmFuc2l0aW9uCiAgdmFyIF90aGlzID0gdGhpczsKICB0aGlzLm9uKCAndHJhbnNpdGlvbkVuZCcsIGZ1bmN0aW9uKCkgewogICAgX3RoaXMucmVtb3ZlRWxlbSgpOwogICAgcmV0dXJuIHRydWU7IC8vIGJpbmQgb25jZQogIH0pOwogIHRoaXMuaGlkZSgpOwp9OwoKSXRlbS5wcm90b3R5cGUucmV2ZWFsID0gZnVuY3Rpb24oKSB7CiAgZGVsZXRlIHRoaXMuaXNIaWRkZW47CiAgLy8gcmVtb3ZlIGRpc3BsYXk6IG5vbmUKICB0aGlzLmNzcyh7IGRpc3BsYXk6ICcnIH0pOwoKICB2YXIgb3B0aW9ucyA9IHRoaXMubGF5b3V0Lm9wdGlvbnM7CiAgdGhpcy50cmFuc2l0aW9uKHsKICAgIGZyb206IG9wdGlvbnMuaGlkZGVuU3R5bGUsCiAgICB0bzogb3B0aW9ucy52aXNpYmxlU3R5bGUsCiAgICBpc0NsZWFuaW5nOiB0cnVlCiAgfSk7Cn07CgpJdGVtLnByb3RvdHlwZS5oaWRlID0gZnVuY3Rpb24oKSB7CiAgLy8gc2V0IGZsYWcKICB0aGlzLmlzSGlkZGVuID0gdHJ1ZTsKICAvLyByZW1vdmUgZGlzcGxheTogbm9uZQogIHRoaXMuY3NzKHsgZGlzcGxheTogJycgfSk7CgogIHZhciBvcHRpb25zID0gdGhpcy5sYXlvdXQub3B0aW9uczsKICB0aGlzLnRyYW5zaXRpb24oewogICAgZnJvbTogb3B0aW9ucy52aXNpYmxlU3R5bGUsCiAgICB0bzogb3B0aW9ucy5oaWRkZW5TdHlsZSwKICAgIC8vIGtlZXAgaGlkZGVuIHN0dWZmIGhpZGRlbgogICAgaXNDbGVhbmluZzogdHJ1ZSwKICAgIG9uVHJhbnNpdGlvbkVuZDogewogICAgICBvcGFjaXR5OiBmdW5jdGlvbigpIHsKICAgICAgICAvLyBjaGVjayBpZiBzdGlsbCBoaWRkZW4KICAgICAgICAvLyBkdXJpbmcgdHJhbnNpdGlvbiwgaXRlbSBtYXkgaGF2ZSBiZWVuIHVuLWhpZGRlbgogICAgICAgIGlmICggdGhpcy5pc0hpZGRlbiApIHsKICAgICAgICAgIHRoaXMuY3NzKHsgZGlzcGxheTogJ25vbmUnIH0pOwogICAgICAgIH0KICAgICAgfQogICAgfQogIH0pOwp9OwoKSXRlbS5wcm90b3R5cGUuZGVzdHJveSA9IGZ1bmN0aW9uKCkgewogIHRoaXMuY3NzKHsKICAgIHBvc2l0aW9uOiAnJywKICAgIGxlZnQ6ICcnLAogICAgcmlnaHQ6ICcnLAogICAgdG9wOiAnJywKICAgIGJvdHRvbTogJycsCiAgICB0cmFuc2l0aW9uOiAnJywKICAgIHRyYW5zZm9ybTogJycKICB9KTsKfTsKCnJldHVybiBJdGVtOwoKfQoKLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gdHJhbnNwb3J0IC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tIC8vCgppZiAoIHR5cGVvZiBkZWZpbmUgPT09ICdmdW5jdGlvbicgJiYgZGVmaW5lLmFtZCApIHsKICAvLyBBTUQKICBkZWZpbmUoICdvdXRsYXllci9pdGVtJyxbCiAgICAgICdldmVudEVtaXR0ZXIvRXZlbnRFbWl0dGVyJywKICAgICAgJ2dldC1zaXplL2dldC1zaXplJywKICAgICAgJ2dldC1zdHlsZS1wcm9wZXJ0eS9nZXQtc3R5bGUtcHJvcGVydHknCiAgICBdLAogICAgb3V0bGF5ZXJJdGVtRGVmaW5pdGlvbiApOwp9IGVsc2UgewogIC8vIGJyb3dzZXIgZ2xvYmFsCiAgd2luZG93Lk91dGxheWVyID0ge307CiAgd2luZG93Lk91dGxheWVyLkl0ZW0gPSBvdXRsYXllckl0ZW1EZWZpbml0aW9uKAogICAgd2luZG93LkV2ZW50RW1pdHRlciwKICAgIHdpbmRvdy5nZXRTaXplLAogICAgd2luZG93LmdldFN0eWxlUHJvcGVydHkKICApOwp9Cgp9KSggd2luZG93ICk7CgovKiEKICogT3V0bGF5ZXIgdjEuMi4wCiAqIHRoZSBicmFpbnMgYW5kIGd1dHMgb2YgYSBsYXlvdXQgbGlicmFyeQogKiBNSVQgbGljZW5zZQogKi8KCiggZnVuY3Rpb24oIHdpbmRvdyApIHsKCgoKLy8gLS0tLS0gdmFycyAtLS0tLSAvLwoKdmFyIGRvY3VtZW50ID0gd2luZG93LmRvY3VtZW50Owp2YXIgY29uc29sZSA9IHdpbmRvdy5jb25zb2xlOwp2YXIgalF1ZXJ5ID0gd2luZG93LmpRdWVyeTsKCnZhciBub29wID0gZnVuY3Rpb24oKSB7fTsKCi8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tIGhlbHBlcnMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gLy8KCi8vIGV4dGVuZCBvYmplY3RzCmZ1bmN0aW9uIGV4dGVuZCggYSwgYiApIHsKICBmb3IgKCB2YXIgcHJvcCBpbiBiICkgewogICAgYVsgcHJvcCBdID0gYlsgcHJvcCBdOwogIH0KICByZXR1cm4gYTsKfQoKCnZhciBvYmpUb1N0cmluZyA9IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmc7CmZ1bmN0aW9uIGlzQXJyYXkoIG9iaiApIHsKICByZXR1cm4gb2JqVG9TdHJpbmcuY2FsbCggb2JqICkgPT09ICdbb2JqZWN0IEFycmF5XSc7Cn0KCi8vIHR1cm4gZWxlbWVudCBvciBub2RlTGlzdCBpbnRvIGFuIGFycmF5CmZ1bmN0aW9uIG1ha2VBcnJheSggb2JqICkgewogIHZhciBhcnkgPSBbXTsKICBpZiAoIGlzQXJyYXkoIG9iaiApICkgewogICAgLy8gdXNlIG9iamVjdCBpZiBhbHJlYWR5IGFuIGFycmF5CiAgICBhcnkgPSBvYmo7CiAgfSBlbHNlIGlmICggb2JqICYmIHR5cGVvZiBvYmoubGVuZ3RoID09PSAnbnVtYmVyJyApIHsKICAgIC8vIGNvbnZlcnQgbm9kZUxpc3QgdG8gYXJyYXkKICAgIGZvciAoIHZhciBpPTAsIGxlbiA9IG9iai5sZW5ndGg7IGkgPCBsZW47IGkrKyApIHsKICAgICAgYXJ5LnB1c2goIG9ialtpXSApOwogICAgfQogIH0gZWxzZSB7CiAgICAvLyBhcnJheSBvZiBzaW5nbGUgaW5kZXgKICAgIGFyeS5wdXNoKCBvYmogKTsKICB9CiAgcmV0dXJuIGFyeTsKfQoKLy8gaHR0cDovL3N0YWNrb3ZlcmZsb3cuY29tL2EvMzg0MzgwLzE4MjE4Mwp2YXIgaXNFbGVtZW50ID0gKCB0eXBlb2YgSFRNTEVsZW1lbnQgPT09ICdvYmplY3QnICkgPwogIGZ1bmN0aW9uIGlzRWxlbWVudERPTTIoIG9iaiApIHsKICAgIHJldHVybiBvYmogaW5zdGFuY2VvZiBIVE1MRWxlbWVudDsKICB9IDoKICBmdW5jdGlvbiBpc0VsZW1lbnRRdWlya3koIG9iaiApIHsKICAgIHJldHVybiBvYmogJiYgdHlwZW9mIG9iaiA9PT0gJ29iamVjdCcgJiYKICAgICAgb2JqLm5vZGVUeXBlID09PSAxICYmIHR5cGVvZiBvYmoubm9kZU5hbWUgPT09ICdzdHJpbmcnOwogIH07CgovLyBpbmRleCBvZiBoZWxwZXIgY2F1c2UgSUU4CnZhciBpbmRleE9mID0gQXJyYXkucHJvdG90eXBlLmluZGV4T2YgPyBmdW5jdGlvbiggYXJ5LCBvYmogKSB7CiAgICByZXR1cm4gYXJ5LmluZGV4T2YoIG9iaiApOwogIH0gOiBmdW5jdGlvbiggYXJ5LCBvYmogKSB7CiAgICBmb3IgKCB2YXIgaT0wLCBsZW4gPSBhcnkubGVuZ3RoOyBpIDwgbGVuOyBpKysgKSB7CiAgICAgIGlmICggYXJ5W2ldID09PSBvYmogKSB7CiAgICAgICAgcmV0dXJuIGk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiAtMTsKICB9OwoKZnVuY3Rpb24gcmVtb3ZlRnJvbSggb2JqLCBhcnkgKSB7CiAgdmFyIGluZGV4ID0gaW5kZXhPZiggYXJ5LCBvYmogKTsKICBpZiAoIGluZGV4ICE9PSAtMSApIHsKICAgIGFyeS5zcGxpY2UoIGluZGV4LCAxICk7CiAgfQp9CgovLyBodHRwOi8vamFtZXNyb2JlcnRzLm5hbWUvYmxvZy8yMDEwLzAyLzIyL3N0cmluZy1mdW5jdGlvbnMtZm9yLWphdmFzY3JpcHQtdHJpbS10by1jYW1lbC1jYXNlLXRvLWRhc2hlZC1hbmQtdG8tdW5kZXJzY29yZS8KZnVuY3Rpb24gdG9EYXNoZWQoIHN0ciApIHsKICByZXR1cm4gc3RyLnJlcGxhY2UoIC8oLikoW0EtWl0pL2csIGZ1bmN0aW9uKCBtYXRjaCwgJDEsICQyICkgewogICAgcmV0dXJuICQxICsgJy0nICsgJDI7CiAgfSkudG9Mb3dlckNhc2UoKTsKfQoKCmZ1bmN0aW9uIG91dGxheWVyRGVmaW5pdGlvbiggZXZlbnRpZSwgZG9jUmVhZHksIEV2ZW50RW1pdHRlciwgZ2V0U2l6ZSwgbWF0Y2hlc1NlbGVjdG9yLCBJdGVtICkgewoKLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gT3V0bGF5ZXIgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gLy8KCi8vIGdsb2JhbGx5IHVuaXF1ZSBpZGVudGlmaWVycwp2YXIgR1VJRCA9IDA7Ci8vIGludGVybmFsIHN0b3JlIG9mIGFsbCBPdXRsYXllciBpbnRhbmNlcwp2YXIgaW5zdGFuY2VzID0ge307CgoKLyoqCiAqIEBwYXJhbSB7RWxlbWVudCwgU3RyaW5nfSBlbGVtZW50CiAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zCiAqIEBjb25zdHJ1Y3RvcgogKi8KZnVuY3Rpb24gT3V0bGF5ZXIoIGVsZW1lbnQsIG9wdGlvbnMgKSB7CiAgLy8gdXNlIGVsZW1lbnQgYXMgc2VsZWN0b3Igc3RyaW5nCiAgaWYgKCB0eXBlb2YgZWxlbWVudCA9PT0gJ3N0cmluZycgKSB7CiAgICBlbGVtZW50ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvciggZWxlbWVudCApOwogIH0KCiAgLy8gYmFpbCBvdXQgaWYgbm90IHByb3BlciBlbGVtZW50CiAgaWYgKCAhZWxlbWVudCB8fCAhaXNFbGVtZW50KCBlbGVtZW50ICkgKSB7CiAgICBpZiAoIGNvbnNvbGUgKSB7CiAgICAgIGNvbnNvbGUuZXJyb3IoICdCYWQgJyArIHRoaXMuY29uc3RydWN0b3IubmFtZXNwYWNlICsgJyBlbGVtZW50OiAnICsgZWxlbWVudCApOwogICAgfQogICAgcmV0dXJuOwogIH0KCiAgdGhpcy5lbGVtZW50ID0gZWxlbWVudDsKCiAgLy8gb3B0aW9ucwogIHRoaXMub3B0aW9ucyA9IGV4dGVuZCgge30sIHRoaXMuY29uc3RydWN0b3IuZGVmYXVsdHMgKTsKICB0aGlzLm9wdGlvbiggb3B0aW9ucyApOwoKICAvLyBhZGQgaWQgZm9yIE91dGxheWVyLmdldEZyb21FbGVtZW50CiAgdmFyIGlkID0gKytHVUlEOwogIHRoaXMuZWxlbWVudC5vdXRsYXllckdVSUQgPSBpZDsgLy8gZXhwYW5kbwogIGluc3RhbmNlc1sgaWQgXSA9IHRoaXM7IC8vIGFzc29jaWF0ZSB2aWEgaWQKCiAgLy8ga2ljayBpdCBvZmYKICB0aGlzLl9jcmVhdGUoKTsKCiAgaWYgKCB0aGlzLm9wdGlvbnMuaXNJbml0TGF5b3V0ICkgewogICAgdGhpcy5sYXlvdXQoKTsKICB9Cn0KCi8vIHNldHRpbmdzIGFyZSBmb3IgaW50ZXJuYWwgdXNlIG9ubHkKT3V0bGF5ZXIubmFtZXNwYWNlID0gJ291dGxheWVyJzsKT3V0bGF5ZXIuSXRlbSA9IEl0ZW07CgovLyBkZWZhdWx0IG9wdGlvbnMKT3V0bGF5ZXIuZGVmYXVsdHMgPSB7CiAgY29udGFpbmVyU3R5bGU6IHsKICAgIHBvc2l0aW9uOiAncmVsYXRpdmUnCiAgfSwKICBpc0luaXRMYXlvdXQ6IHRydWUsCiAgaXNPcmlnaW5MZWZ0OiB0cnVlLAogIGlzT3JpZ2luVG9wOiB0cnVlLAogIGlzUmVzaXplQm91bmQ6IHRydWUsCiAgaXNSZXNpemluZ0NvbnRhaW5lcjogdHJ1ZSwKICAvLyBpdGVtIG9wdGlvbnMKICB0cmFuc2l0aW9uRHVyYXRpb246ICcwLjRzJywKICBoaWRkZW5TdHlsZTogewogICAgb3BhY2l0eTogMCwKICAgIHRyYW5zZm9ybTogJ3NjYWxlKDAuMDAxKScKICB9LAogIHZpc2libGVTdHlsZTogewogICAgb3BhY2l0eTogMSwKICAgIHRyYW5zZm9ybTogJ3NjYWxlKDEpJwogIH0KfTsKCi8vIGluaGVyaXQgRXZlbnRFbWl0dGVyCmV4dGVuZCggT3V0bGF5ZXIucHJvdG90eXBlLCBFdmVudEVtaXR0ZXIucHJvdG90eXBlICk7CgovKioKICogc2V0IG9wdGlvbnMKICogQHBhcmFtIHtPYmplY3R9IG9wdHMKICovCk91dGxheWVyLnByb3RvdHlwZS5vcHRpb24gPSBmdW5jdGlvbiggb3B0cyApIHsKICBleHRlbmQoIHRoaXMub3B0aW9ucywgb3B0cyApOwp9OwoKT3V0bGF5ZXIucHJvdG90eXBlLl9jcmVhdGUgPSBmdW5jdGlvbigpIHsKICAvLyBnZXQgaXRlbXMgZnJvbSBjaGlsZHJlbgogIHRoaXMucmVsb2FkSXRlbXMoKTsKICAvLyBlbGVtZW50cyB0aGF0IGFmZmVjdCBsYXlvdXQsIGJ1dCBhcmUgbm90IGxhaWQgb3V0CiAgdGhpcy5zdGFtcHMgPSBbXTsKICB0aGlzLnN0YW1wKCB0aGlzLm9wdGlvbnMuc3RhbXAgKTsKICAvLyBzZXQgY29udGFpbmVyIHN0eWxlCiAgZXh0ZW5kKCB0aGlzLmVsZW1lbnQuc3R5bGUsIHRoaXMub3B0aW9ucy5jb250YWluZXJTdHlsZSApOwoKICAvLyBiaW5kIHJlc2l6ZSBtZXRob2QKICBpZiAoIHRoaXMub3B0aW9ucy5pc1Jlc2l6ZUJvdW5kICkgewogICAgdGhpcy5iaW5kUmVzaXplKCk7CiAgfQp9OwoKLy8gZ29lcyB0aHJvdWdoIGFsbCBjaGlsZHJlbiBhZ2FpbiBhbmQgZ2V0cyBicmlja3MgaW4gcHJvcGVyIG9yZGVyCk91dGxheWVyLnByb3RvdHlwZS5yZWxvYWRJdGVtcyA9IGZ1bmN0aW9uKCkgewogIC8vIGNvbGxlY3Rpb24gb2YgaXRlbSBlbGVtZW50cwogIHRoaXMuaXRlbXMgPSB0aGlzLl9pdGVtaXplKCB0aGlzLmVsZW1lbnQuY2hpbGRyZW4gKTsKfTsKCgovKioKICogdHVybiBlbGVtZW50cyBpbnRvIE91dGxheWVyLkl0ZW1zIHRvIGJlIHVzZWQgaW4gbGF5b3V0CiAqIEBwYXJhbSB7QXJyYXkgb3IgTm9kZUxpc3Qgb3IgSFRNTEVsZW1lbnR9IGVsZW1zCiAqIEByZXR1cm5zIHtBcnJheX0gaXRlbXMgLSBjb2xsZWN0aW9uIG9mIG5ldyBPdXRsYXllciBJdGVtcwogKi8KT3V0bGF5ZXIucHJvdG90eXBlLl9pdGVtaXplID0gZnVuY3Rpb24oIGVsZW1zICkgewoKICB2YXIgaXRlbUVsZW1zID0gdGhpcy5fZmlsdGVyRmluZEl0ZW1FbGVtZW50cyggZWxlbXMgKTsKICB2YXIgSXRlbSA9IHRoaXMuY29uc3RydWN0b3IuSXRlbTsKCiAgLy8gY3JlYXRlIG5ldyBPdXRsYXllciBJdGVtcyBmb3IgY29sbGVjdGlvbgogIHZhciBpdGVtcyA9IFtdOwogIGZvciAoIHZhciBpPTAsIGxlbiA9IGl0ZW1FbGVtcy5sZW5ndGg7IGkgPCBsZW47IGkrKyApIHsKICAgIHZhciBlbGVtID0gaXRlbUVsZW1zW2ldOwogICAgdmFyIGl0ZW0gPSBuZXcgSXRlbSggZWxlbSwgdGhpcyApOwogICAgaXRlbXMucHVzaCggaXRlbSApOwogIH0KCiAgcmV0dXJuIGl0ZW1zOwp9OwoKLyoqCiAqIGdldCBpdGVtIGVsZW1lbnRzIHRvIGJlIHVzZWQgaW4gbGF5b3V0CiAqIEBwYXJhbSB7QXJyYXkgb3IgTm9kZUxpc3Qgb3IgSFRNTEVsZW1lbnR9IGVsZW1zCiAqIEByZXR1cm5zIHtBcnJheX0gaXRlbXMgLSBpdGVtIGVsZW1lbnRzCiAqLwpPdXRsYXllci5wcm90b3R5cGUuX2ZpbHRlckZpbmRJdGVtRWxlbWVudHMgPSBmdW5jdGlvbiggZWxlbXMgKSB7CiAgLy8gbWFrZSBhcnJheSBvZiBlbGVtcwogIGVsZW1zID0gbWFrZUFycmF5KCBlbGVtcyApOwogIHZhciBpdGVtU2VsZWN0b3IgPSB0aGlzLm9wdGlvbnMuaXRlbVNlbGVjdG9yOwogIHZhciBpdGVtRWxlbXMgPSBbXTsKCiAgZm9yICggdmFyIGk9MCwgbGVuID0gZWxlbXMubGVuZ3RoOyBpIDwgbGVuOyBpKysgKSB7CiAgICB2YXIgZWxlbSA9IGVsZW1zW2ldOwogICAgLy8gY2hlY2sgdGhhdCBlbGVtIGlzIGFuIGFjdHVhbCBlbGVtZW50CiAgICBpZiAoICFpc0VsZW1lbnQoIGVsZW0gKSApIHsKICAgICAgY29udGludWU7CiAgICB9CiAgICAvLyBmaWx0ZXIgJiBmaW5kIGl0ZW1zIGlmIHdlIGhhdmUgYW4gaXRlbSBzZWxlY3RvcgogICAgaWYgKCBpdGVtU2VsZWN0b3IgKSB7CiAgICAgIC8vIGZpbHRlciBzaWJsaW5ncwogICAgICBpZiAoIG1hdGNoZXNTZWxlY3RvciggZWxlbSwgaXRlbVNlbGVjdG9yICkgKSB7CiAgICAgICAgaXRlbUVsZW1zLnB1c2goIGVsZW0gKTsKICAgICAgfQogICAgICAvLyBmaW5kIGNoaWxkcmVuCiAgICAgIHZhciBjaGlsZEVsZW1zID0gZWxlbS5xdWVyeVNlbGVjdG9yQWxsKCBpdGVtU2VsZWN0b3IgKTsKICAgICAgLy8gY29uY2F0IGNoaWxkRWxlbXMgdG8gZmlsdGVyRm91bmQgYXJyYXkKICAgICAgZm9yICggdmFyIGo9MCwgakxlbiA9IGNoaWxkRWxlbXMubGVuZ3RoOyBqIDwgakxlbjsgaisrICkgewogICAgICAgIGl0ZW1FbGVtcy5wdXNoKCBjaGlsZEVsZW1zW2pdICk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGl0ZW1FbGVtcy5wdXNoKCBlbGVtICk7CiAgICB9CiAgfQoKICByZXR1cm4gaXRlbUVsZW1zOwp9OwoKLyoqCiAqIGdldHRlciBtZXRob2QgZm9yIGdldHRpbmcgaXRlbSBlbGVtZW50cwogKiBAcmV0dXJucyB7QXJyYXl9IGVsZW1zIC0gY29sbGVjdGlvbiBvZiBpdGVtIGVsZW1lbnRzCiAqLwpPdXRsYXllci5wcm90b3R5cGUuZ2V0SXRlbUVsZW1lbnRzID0gZnVuY3Rpb24oKSB7CiAgdmFyIGVsZW1zID0gW107CiAgZm9yICggdmFyIGk9MCwgbGVuID0gdGhpcy5pdGVtcy5sZW5ndGg7IGkgPCBsZW47IGkrKyApIHsKICAgIGVsZW1zLnB1c2goIHRoaXMuaXRlbXNbaV0uZWxlbWVudCApOwogIH0KICByZXR1cm4gZWxlbXM7Cn07CgovLyAtLS0tLSBpbml0ICYgbGF5b3V0IC0tLS0tIC8vCgovKioKICogbGF5cyBvdXQgYWxsIGl0ZW1zCiAqLwpPdXRsYXllci5wcm90b3R5cGUubGF5b3V0ID0gZnVuY3Rpb24oKSB7CiAgdGhpcy5fcmVzZXRMYXlvdXQoKTsKICB0aGlzLl9tYW5hZ2VTdGFtcHMoKTsKCiAgLy8gZG9uJ3QgYW5pbWF0ZSBmaXJzdCBsYXlvdXQKICB2YXIgaXNJbnN0YW50ID0gdGhpcy5vcHRpb25zLmlzTGF5b3V0SW5zdGFudCAhPT0gdW5kZWZpbmVkID8KICAgIHRoaXMub3B0aW9ucy5pc0xheW91dEluc3RhbnQgOiAhdGhpcy5faXNMYXlvdXRJbml0ZWQ7CiAgdGhpcy5sYXlvdXRJdGVtcyggdGhpcy5pdGVtcywgaXNJbnN0YW50ICk7CgogIC8vIGZsYWcgZm9yIGluaXRhbGl6ZWQKICB0aGlzLl9pc0xheW91dEluaXRlZCA9IHRydWU7Cn07CgovLyBfaW5pdCBpcyBhbGlhcyBmb3IgbGF5b3V0Ck91dGxheWVyLnByb3RvdHlwZS5faW5pdCA9IE91dGxheWVyLnByb3RvdHlwZS5sYXlvdXQ7CgovKioKICogbG9naWMgYmVmb3JlIGFueSBuZXcgbGF5b3V0CiAqLwpPdXRsYXllci5wcm90b3R5cGUuX3Jlc2V0TGF5b3V0ID0gZnVuY3Rpb24oKSB7CiAgdGhpcy5nZXRTaXplKCk7Cn07CgoKT3V0bGF5ZXIucHJvdG90eXBlLmdldFNpemUgPSBmdW5jdGlvbigpIHsKICB0aGlzLnNpemUgPSBnZXRTaXplKCB0aGlzLmVsZW1lbnQgKTsKfTsKCi8qKgogKiBnZXQgbWVhc3VyZW1lbnQgZnJvbSBvcHRpb24sIGZvciBjb2x1bW5XaWR0aCwgcm93SGVpZ2h0LCBndXR0ZXIKICogaWYgb3B0aW9uIGlzIFN0cmluZyAtPiBnZXQgZWxlbWVudCBmcm9tIHNlbGVjdG9yIHN0cmluZywgJiBnZXQgc2l6ZSBvZiBlbGVtZW50CiAqIGlmIG9wdGlvbiBpcyBFbGVtZW50IC0+IGdldCBzaXplIG9mIGVsZW1lbnQKICogZWxzZSB1c2Ugb3B0aW9uIGFzIGEgbnVtYmVyCiAqCiAqIEBwYXJhbSB7U3RyaW5nfSBtZWFzdXJlbWVudAogKiBAcGFyYW0ge1N0cmluZ30gc2l6ZSAtIHdpZHRoIG9yIGhlaWdodAogKiBAcHJpdmF0ZQogKi8KT3V0bGF5ZXIucHJvdG90eXBlLl9nZXRNZWFzdXJlbWVudCA9IGZ1bmN0aW9uKCBtZWFzdXJlbWVudCwgc2l6ZSApIHsKICB2YXIgb3B0aW9uID0gdGhpcy5vcHRpb25zWyBtZWFzdXJlbWVudCBdOwogIHZhciBlbGVtOwogIGlmICggIW9wdGlvbiApIHsKICAgIC8vIGRlZmF1bHQgdG8gMAogICAgdGhpc1sgbWVhc3VyZW1lbnQgXSA9IDA7CiAgfSBlbHNlIHsKICAgIC8vIHVzZSBvcHRpb24gYXMgYW4gZWxlbWVudAogICAgaWYgKCB0eXBlb2Ygb3B0aW9uID09PSAnc3RyaW5nJyApIHsKICAgICAgZWxlbSA9IHRoaXMuZWxlbWVudC5xdWVyeVNlbGVjdG9yKCBvcHRpb24gKTsKICAgIH0gZWxzZSBpZiAoIGlzRWxlbWVudCggb3B0aW9uICkgKSB7CiAgICAgIGVsZW0gPSBvcHRpb247CiAgICB9CiAgICAvLyB1c2Ugc2l6ZSBvZiBlbGVtZW50LCBpZiBlbGVtZW50CiAgICB0aGlzWyBtZWFzdXJlbWVudCBdID0gZWxlbSA/IGdldFNpemUoIGVsZW0gKVsgc2l6ZSBdIDogb3B0aW9uOwogIH0KfTsKCi8qKgogKiBsYXlvdXQgYSBjb2xsZWN0aW9uIG9mIGl0ZW0gZWxlbWVudHMKICogQGFwaSBwdWJsaWMKICovCk91dGxheWVyLnByb3RvdHlwZS5sYXlvdXRJdGVtcyA9IGZ1bmN0aW9uKCBpdGVtcywgaXNJbnN0YW50ICkgewogIGl0ZW1zID0gdGhpcy5fZ2V0SXRlbXNGb3JMYXlvdXQoIGl0ZW1zICk7CgogIHRoaXMuX2xheW91dEl0ZW1zKCBpdGVtcywgaXNJbnN0YW50ICk7CgogIHRoaXMuX3Bvc3RMYXlvdXQoKTsKfTsKCi8qKgogKiBnZXQgdGhlIGl0ZW1zIHRvIGJlIGxhaWQgb3V0CiAqIHlvdSBtYXkgd2FudCB0byBza2lwIG92ZXIgc29tZSBpdGVtcwogKiBAcGFyYW0ge0FycmF5fSBpdGVtcwogKiBAcmV0dXJucyB7QXJyYXl9IGl0ZW1zCiAqLwpPdXRsYXllci5wcm90b3R5cGUuX2dldEl0ZW1zRm9yTGF5b3V0ID0gZnVuY3Rpb24oIGl0ZW1zICkgewogIHZhciBsYXlvdXRJdGVtcyA9IFtdOwogIGZvciAoIHZhciBpPTAsIGxlbiA9IGl0ZW1zLmxlbmd0aDsgaSA8IGxlbjsgaSsrICkgewogICAgdmFyIGl0ZW0gPSBpdGVtc1tpXTsKICAgIGlmICggIWl0ZW0uaXNJZ25vcmVkICkgewogICAgICBsYXlvdXRJdGVtcy5wdXNoKCBpdGVtICk7CiAgICB9CiAgfQogIHJldHVybiBsYXlvdXRJdGVtczsKfTsKCi8qKgogKiBsYXlvdXQgaXRlbXMKICogQHBhcmFtIHtBcnJheX0gaXRlbXMKICogQHBhcmFtIHtCb29sZWFufSBpc0luc3RhbnQKICovCk91dGxheWVyLnByb3RvdHlwZS5fbGF5b3V0SXRlbXMgPSBmdW5jdGlvbiggaXRlbXMsIGlzSW5zdGFudCApIHsKICB2YXIgX3RoaXMgPSB0aGlzOwogIGZ1bmN0aW9uIG9uSXRlbXNMYXlvdXQoKSB7CiAgICBfdGhpcy5lbWl0RXZlbnQoICdsYXlvdXRDb21wbGV0ZScsIFsgX3RoaXMsIGl0ZW1zIF0gKTsKICB9CgogIGlmICggIWl0ZW1zIHx8ICFpdGVtcy5sZW5ndGggKSB7CiAgICAvLyBubyBpdGVtcywgZW1pdCBldmVudCB3aXRoIGVtcHR5IGFycmF5CiAgICBvbkl0ZW1zTGF5b3V0KCk7CiAgICByZXR1cm47CiAgfQoKICAvLyBlbWl0IGxheW91dENvbXBsZXRlIHdoZW4gZG9uZQogIHRoaXMuX2l0ZW1zT24oIGl0ZW1zLCAnbGF5b3V0Jywgb25JdGVtc0xheW91dCApOwoKICB2YXIgcXVldWUgPSBbXTsKCiAgZm9yICggdmFyIGk9MCwgbGVuID0gaXRlbXMubGVuZ3RoOyBpIDwgbGVuOyBpKysgKSB7CiAgICB2YXIgaXRlbSA9IGl0ZW1zW2ldOwogICAgLy8gZ2V0IHgveSBvYmplY3QgZnJvbSBtZXRob2QKICAgIHZhciBwb3NpdGlvbiA9IHRoaXMuX2dldEl0ZW1MYXlvdXRQb3NpdGlvbiggaXRlbSApOwogICAgLy8gZW5xdWV1ZQogICAgcG9zaXRpb24uaXRlbSA9IGl0ZW07CiAgICBwb3NpdGlvbi5pc0luc3RhbnQgPSBpc0luc3RhbnQgfHwgaXRlbS5pc0xheW91dEluc3RhbnQ7CiAgICBxdWV1ZS5wdXNoKCBwb3NpdGlvbiApOwogIH0KCiAgdGhpcy5fcHJvY2Vzc0xheW91dFF1ZXVlKCBxdWV1ZSApOwp9OwoKLyoqCiAqIGdldCBpdGVtIGxheW91dCBwb3NpdGlvbgogKiBAcGFyYW0ge091dGxheWVyLkl0ZW19IGl0ZW0KICogQHJldHVybnMge09iamVjdH0geCBhbmQgeSBwb3NpdGlvbgogKi8KT3V0bGF5ZXIucHJvdG90eXBlLl9nZXRJdGVtTGF5b3V0UG9zaXRpb24gPSBmdW5jdGlvbiggLyogaXRlbSAqLyApIHsKICByZXR1cm4gewogICAgeDogMCwKICAgIHk6IDAKICB9Owp9OwoKLyoqCiAqIGl0ZXJhdGUgb3ZlciBhcnJheSBhbmQgcG9zaXRpb24gZWFjaCBpdGVtCiAqIFJlYXNvbiBiZWluZyAtIHNlcGFyYXRpbmcgdGhpcyBsb2dpYyBwcmV2ZW50cyAnbGF5b3V0IGludmFsaWRhdGlvbicKICogdGh4IEBwYXVsX2lyaXNoCiAqIEBwYXJhbSB7QXJyYXl9IHF1ZXVlCiAqLwpPdXRsYXllci5wcm90b3R5cGUuX3Byb2Nlc3NMYXlvdXRRdWV1ZSA9IGZ1bmN0aW9uKCBxdWV1ZSApIHsKICBmb3IgKCB2YXIgaT0wLCBsZW4gPSBxdWV1ZS5sZW5ndGg7IGkgPCBsZW47IGkrKyApIHsKICAgIHZhciBvYmogPSBxdWV1ZVtpXTsKICAgIHRoaXMuX3Bvc2l0aW9uSXRlbSggb2JqLml0ZW0sIG9iai54LCBvYmoueSwgb2JqLmlzSW5zdGFudCApOwogIH0KfTsKCi8qKgogKiBTZXRzIHBvc2l0aW9uIG9mIGl0ZW0gaW4gRE9NCiAqIEBwYXJhbSB7T3V0bGF5ZXIuSXRlbX0gaXRlbQogKiBAcGFyYW0ge051bWJlcn0geCAtIGhvcml6b250YWwgcG9zaXRpb24KICogQHBhcmFtIHtOdW1iZXJ9IHkgLSB2ZXJ0aWNhbCBwb3NpdGlvbgogKiBAcGFyYW0ge0Jvb2xlYW59IGlzSW5zdGFudCAtIGRpc2FibGVzIHRyYW5zaXRpb25zCiAqLwpPdXRsYXllci5wcm90b3R5cGUuX3Bvc2l0aW9uSXRlbSA9IGZ1bmN0aW9uKCBpdGVtLCB4LCB5LCBpc0luc3RhbnQgKSB7CiAgaWYgKCBpc0luc3RhbnQgKSB7CiAgICAvLyBpZiBub3QgdHJhbnNpdGlvbiwganVzdCBzZXQgQ1NTCiAgICBpdGVtLmdvVG8oIHgsIHkgKTsKICB9IGVsc2UgewogICAgaXRlbS5tb3ZlVG8oIHgsIHkgKTsKICB9Cn07CgovKioKICogQW55IGxvZ2ljIHlvdSB3YW50IHRvIGRvIGFmdGVyIGVhY2ggbGF5b3V0LAogKiBpLmUuIHNpemUgdGhlIGNvbnRhaW5lcgogKi8KT3V0bGF5ZXIucHJvdG90eXBlLl9wb3N0TGF5b3V0ID0gZnVuY3Rpb24oKSB7CiAgdGhpcy5yZXNpemVDb250YWluZXIoKTsKfTsKCk91dGxheWVyLnByb3RvdHlwZS5yZXNpemVDb250YWluZXIgPSBmdW5jdGlvbigpIHsKICBpZiAoICF0aGlzLm9wdGlvbnMuaXNSZXNpemluZ0NvbnRhaW5lciApIHsKICAgIHJldHVybjsKICB9CiAgdmFyIHNpemUgPSB0aGlzLl9nZXRDb250YWluZXJTaXplKCk7CiAgaWYgKCBzaXplICkgewogICAgdGhpcy5fc2V0Q29udGFpbmVyTWVhc3VyZSggc2l6ZS53aWR0aCwgdHJ1ZSApOwogICAgdGhpcy5fc2V0Q29udGFpbmVyTWVhc3VyZSggc2l6ZS5oZWlnaHQsIGZhbHNlICk7CiAgfQp9OwoKLyoqCiAqIFNldHMgd2lkdGggb3IgaGVpZ2h0IG9mIGNvbnRhaW5lciBpZiByZXR1cm5lZAogKiBAcmV0dXJucyB7T2JqZWN0fSBzaXplCiAqICAgQHBhcmFtIHtOdW1iZXJ9IHdpZHRoCiAqICAgQHBhcmFtIHtOdW1iZXJ9IGhlaWdodAogKi8KT3V0bGF5ZXIucHJvdG90eXBlLl9nZXRDb250YWluZXJTaXplID0gbm9vcDsKCi8qKgogKiBAcGFyYW0ge051bWJlcn0gbWVhc3VyZSAtIHNpemUgb2Ygd2lkdGggb3IgaGVpZ2h0CiAqIEBwYXJhbSB7Qm9vbGVhbn0gaXNXaWR0aAogKi8KT3V0bGF5ZXIucHJvdG90eXBlLl9zZXRDb250YWluZXJNZWFzdXJlID0gZnVuY3Rpb24oIG1lYXN1cmUsIGlzV2lkdGggKSB7CiAgaWYgKCBtZWFzdXJlID09PSB1bmRlZmluZWQgKSB7CiAgICByZXR1cm47CiAgfQoKICB2YXIgZWxlbVNpemUgPSB0aGlzLnNpemU7CiAgLy8gYWRkIHBhZGRpbmcgYW5kIGJvcmRlciB3aWR0aCBpZiBib3JkZXIgYm94CiAgaWYgKCBlbGVtU2l6ZS5pc0JvcmRlckJveCApIHsKICAgIG1lYXN1cmUgKz0gaXNXaWR0aCA/IGVsZW1TaXplLnBhZGRpbmdMZWZ0ICsgZWxlbVNpemUucGFkZGluZ1JpZ2h0ICsKICAgICAgZWxlbVNpemUuYm9yZGVyTGVmdFdpZHRoICsgZWxlbVNpemUuYm9yZGVyUmlnaHRXaWR0aCA6CiAgICAgIGVsZW1TaXplLnBhZGRpbmdCb3R0b20gKyBlbGVtU2l6ZS5wYWRkaW5nVG9wICsKICAgICAgZWxlbVNpemUuYm9yZGVyVG9wV2lkdGggKyBlbGVtU2l6ZS5ib3JkZXJCb3R0b21XaWR0aDsKICB9CgogIG1lYXN1cmUgPSBNYXRoLm1heCggbWVhc3VyZSwgMCApOwogIHRoaXMuZWxlbWVudC5zdHlsZVsgaXNXaWR0aCA/ICd3aWR0aCcgOiAnaGVpZ2h0JyBdID0gbWVhc3VyZSArICdweCc7Cn07CgovKioKICogdHJpZ2dlciBhIGNhbGxiYWNrIGZvciBhIGNvbGxlY3Rpb24gb2YgaXRlbXMgZXZlbnRzCiAqIEBwYXJhbSB7QXJyYXl9IGl0ZW1zIC0gT3V0bGF5ZXIuSXRlbXMKICogQHBhcmFtIHtTdHJpbmd9IGV2ZW50TmFtZQogKiBAcGFyYW0ge0Z1bmN0aW9ufSBjYWxsYmFjawogKi8KT3V0bGF5ZXIucHJvdG90eXBlLl9pdGVtc09uID0gZnVuY3Rpb24oIGl0ZW1zLCBldmVudE5hbWUsIGNhbGxiYWNrICkgewogIHZhciBkb25lQ291bnQgPSAwOwogIHZhciBjb3VudCA9IGl0ZW1zLmxlbmd0aDsKICAvLyBldmVudCBjYWxsYmFjawogIHZhciBfdGhpcyA9IHRoaXM7CiAgZnVuY3Rpb24gdGljaygpIHsKICAgIGRvbmVDb3VudCsrOwogICAgaWYgKCBkb25lQ291bnQgPT09IGNvdW50ICkgewogICAgICBjYWxsYmFjay5jYWxsKCBfdGhpcyApOwogICAgfQogICAgcmV0dXJuIHRydWU7IC8vIGJpbmQgb25jZQogIH0KICAvLyBiaW5kIGNhbGxiYWNrCiAgZm9yICggdmFyIGk9MCwgbGVuID0gaXRlbXMubGVuZ3RoOyBpIDwgbGVuOyBpKysgKSB7CiAgICB2YXIgaXRlbSA9IGl0ZW1zW2ldOwogICAgaXRlbS5vbiggZXZlbnROYW1lLCB0aWNrICk7CiAgfQp9OwoKLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gaWdub3JlICYgc3RhbXBzIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tIC8vCgoKLyoqCiAqIGtlZXAgaXRlbSBpbiBjb2xsZWN0aW9uLCBidXQgZG8gbm90IGxheSBpdCBvdXQKICogaWdub3JlZCBpdGVtcyBkbyBub3QgZ2V0IHNraXBwZWQgaW4gbGF5b3V0CiAqIEBwYXJhbSB7RWxlbWVudH0gZWxlbQogKi8KT3V0bGF5ZXIucHJvdG90eXBlLmlnbm9yZSA9IGZ1bmN0aW9uKCBlbGVtICkgewogIHZhciBpdGVtID0gdGhpcy5nZXRJdGVtKCBlbGVtICk7CiAgaWYgKCBpdGVtICkgewogICAgaXRlbS5pc0lnbm9yZWQgPSB0cnVlOwogIH0KfTsKCi8qKgogKiByZXR1cm4gaXRlbSB0byBsYXlvdXQgY29sbGVjdGlvbgogKiBAcGFyYW0ge0VsZW1lbnR9IGVsZW0KICovCk91dGxheWVyLnByb3RvdHlwZS51bmlnbm9yZSA9IGZ1bmN0aW9uKCBlbGVtICkgewogIHZhciBpdGVtID0gdGhpcy5nZXRJdGVtKCBlbGVtICk7CiAgaWYgKCBpdGVtICkgewogICAgZGVsZXRlIGl0ZW0uaXNJZ25vcmVkOwogIH0KfTsKCi8qKgogKiBhZGRzIGVsZW1lbnRzIHRvIHN0YW1wcwogKiBAcGFyYW0ge05vZGVMaXN0LCBBcnJheSwgRWxlbWVudCwgb3IgU3RyaW5nfSBlbGVtcwogKi8KT3V0bGF5ZXIucHJvdG90eXBlLnN0YW1wID0gZnVuY3Rpb24oIGVsZW1zICkgewogIGVsZW1zID0gdGhpcy5fZmluZCggZWxlbXMgKTsKICBpZiAoICFlbGVtcyApIHsKICAgIHJldHVybjsKICB9CgogIHRoaXMuc3RhbXBzID0gdGhpcy5zdGFtcHMuY29uY2F0KCBlbGVtcyApOwogIC8vIGlnbm9yZQogIGZvciAoIHZhciBpPTAsIGxlbiA9IGVsZW1zLmxlbmd0aDsgaSA8IGxlbjsgaSsrICkgewogICAgdmFyIGVsZW0gPSBlbGVtc1tpXTsKICAgIHRoaXMuaWdub3JlKCBlbGVtICk7CiAgfQp9OwoKLyoqCiAqIHJlbW92ZXMgZWxlbWVudHMgdG8gc3RhbXBzCiAqIEBwYXJhbSB7Tm9kZUxpc3QsIEFycmF5LCBvciBFbGVtZW50fSBlbGVtcwogKi8KT3V0bGF5ZXIucHJvdG90eXBlLnVuc3RhbXAgPSBmdW5jdGlvbiggZWxlbXMgKSB7CiAgZWxlbXMgPSB0aGlzLl9maW5kKCBlbGVtcyApOwogIGlmICggIWVsZW1zICl7CiAgICByZXR1cm47CiAgfQoKICBmb3IgKCB2YXIgaT0wLCBsZW4gPSBlbGVtcy5sZW5ndGg7IGkgPCBsZW47IGkrKyApIHsKICAgIHZhciBlbGVtID0gZWxlbXNbaV07CiAgICAvLyBmaWx0ZXIgb3V0IHJlbW92ZWQgc3RhbXAgZWxlbWVudHMKICAgIHJlbW92ZUZyb20oIGVsZW0sIHRoaXMuc3RhbXBzICk7CiAgICB0aGlzLnVuaWdub3JlKCBlbGVtICk7CiAgfQoKfTsKCi8qKgogKiBmaW5kcyBjaGlsZCBlbGVtZW50cwogKiBAcGFyYW0ge05vZGVMaXN0LCBBcnJheSwgRWxlbWVudCwgb3IgU3RyaW5nfSBlbGVtcwogKiBAcmV0dXJucyB7QXJyYXl9IGVsZW1zCiAqLwpPdXRsYXllci5wcm90b3R5cGUuX2ZpbmQgPSBmdW5jdGlvbiggZWxlbXMgKSB7CiAgaWYgKCAhZWxlbXMgKSB7CiAgICByZXR1cm47CiAgfQogIC8vIGlmIHN0cmluZywgdXNlIGFyZ3VtZW50IGFzIHNlbGVjdG9yIHN0cmluZwogIGlmICggdHlwZW9mIGVsZW1zID09PSAnc3RyaW5nJyApIHsKICAgIGVsZW1zID0gdGhpcy5lbGVtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoIGVsZW1zICk7CiAgfQogIGVsZW1zID0gbWFrZUFycmF5KCBlbGVtcyApOwogIHJldHVybiBlbGVtczsKfTsKCk91dGxheWVyLnByb3RvdHlwZS5fbWFuYWdlU3RhbXBzID0gZnVuY3Rpb24oKSB7CiAgaWYgKCAhdGhpcy5zdGFtcHMgfHwgIXRoaXMuc3RhbXBzLmxlbmd0aCApIHsKICAgIHJldHVybjsKICB9CgogIHRoaXMuX2dldEJvdW5kaW5nUmVjdCgpOwoKICBmb3IgKCB2YXIgaT0wLCBsZW4gPSB0aGlzLnN0YW1wcy5sZW5ndGg7IGkgPCBsZW47IGkrKyApIHsKICAgIHZhciBzdGFtcCA9IHRoaXMuc3RhbXBzW2ldOwogICAgdGhpcy5fbWFuYWdlU3RhbXAoIHN0YW1wICk7CiAgfQp9OwoKLy8gdXBkYXRlIGJvdW5kaW5nTGVmdCAvIFRvcApPdXRsYXllci5wcm90b3R5cGUuX2dldEJvdW5kaW5nUmVjdCA9IGZ1bmN0aW9uKCkgewogIC8vIGdldCBib3VuZGluZyByZWN0IGZvciBjb250YWluZXIgZWxlbWVudAogIHZhciBib3VuZGluZ1JlY3QgPSB0aGlzLmVsZW1lbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CiAgdmFyIHNpemUgPSB0aGlzLnNpemU7CiAgdGhpcy5fYm91bmRpbmdSZWN0ID0gewogICAgbGVmdDogYm91bmRpbmdSZWN0LmxlZnQgKyBzaXplLnBhZGRpbmdMZWZ0ICsgc2l6ZS5ib3JkZXJMZWZ0V2lkdGgsCiAgICB0b3A6IGJvdW5kaW5nUmVjdC50b3AgKyBzaXplLnBhZGRpbmdUb3AgKyBzaXplLmJvcmRlclRvcFdpZHRoLAogICAgcmlnaHQ6IGJvdW5kaW5nUmVjdC5yaWdodCAtICggc2l6ZS5wYWRkaW5nUmlnaHQgKyBzaXplLmJvcmRlclJpZ2h0V2lkdGggKSwKICAgIGJvdHRvbTogYm91bmRpbmdSZWN0LmJvdHRvbSAtICggc2l6ZS5wYWRkaW5nQm90dG9tICsgc2l6ZS5ib3JkZXJCb3R0b21XaWR0aCApCiAgfTsKfTsKCi8qKgogKiBAcGFyYW0ge0VsZW1lbnR9IHN0YW1wCioqLwpPdXRsYXllci5wcm90b3R5cGUuX21hbmFnZVN0YW1wID0gbm9vcDsKCi8qKgogKiBnZXQgeC95IHBvc2l0aW9uIG9mIGVsZW1lbnQgcmVsYXRpdmUgdG8gY29udGFpbmVyIGVsZW1lbnQKICogQHBhcmFtIHtFbGVtZW50fSBlbGVtCiAqIEByZXR1cm5zIHtPYmplY3R9IG9mZnNldCAtIGhhcyBsZWZ0LCB0b3AsIHJpZ2h0LCBib3R0b20KICovCk91dGxheWVyLnByb3RvdHlwZS5fZ2V0RWxlbWVudE9mZnNldCA9IGZ1bmN0aW9uKCBlbGVtICkgewogIHZhciBib3VuZGluZ1JlY3QgPSBlbGVtLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwogIHZhciB0aGlzUmVjdCA9IHRoaXMuX2JvdW5kaW5nUmVjdDsKICB2YXIgc2l6ZSA9IGdldFNpemUoIGVsZW0gKTsKICB2YXIgb2Zmc2V0ID0gewogICAgbGVmdDogYm91bmRpbmdSZWN0LmxlZnQgLSB0aGlzUmVjdC5sZWZ0IC0gc2l6ZS5tYXJnaW5MZWZ0LAogICAgdG9wOiBib3VuZGluZ1JlY3QudG9wIC0gdGhpc1JlY3QudG9wIC0gc2l6ZS5tYXJnaW5Ub3AsCiAgICByaWdodDogdGhpc1JlY3QucmlnaHQgLSBib3VuZGluZ1JlY3QucmlnaHQgLSBzaXplLm1hcmdpblJpZ2h0LAogICAgYm90dG9tOiB0aGlzUmVjdC5ib3R0b20gLSBib3VuZGluZ1JlY3QuYm90dG9tIC0gc2l6ZS5tYXJnaW5Cb3R0b20KICB9OwogIHJldHVybiBvZmZzZXQ7Cn07CgovLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSByZXNpemUgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gLy8KCi8vIGVuYWJsZSBldmVudCBoYW5kbGVycyBmb3IgbGlzdGVuZXJzCi8vIGkuZS4gcmVzaXplIC0+IG9ucmVzaXplCk91dGxheWVyLnByb3RvdHlwZS5oYW5kbGVFdmVudCA9IGZ1bmN0aW9uKCBldmVudCApIHsKICB2YXIgbWV0aG9kID0gJ29uJyArIGV2ZW50LnR5cGU7CiAgaWYgKCB0aGlzWyBtZXRob2QgXSApIHsKICAgIHRoaXNbIG1ldGhvZCBdKCBldmVudCApOwogIH0KfTsKCi8qKgogKiBCaW5kIGxheW91dCB0byB3aW5kb3cgcmVzaXppbmcKICovCk91dGxheWVyLnByb3RvdHlwZS5iaW5kUmVzaXplID0gZnVuY3Rpb24oKSB7CiAgLy8gYmluZCBqdXN0IG9uZSBsaXN0ZW5lcgogIGlmICggdGhpcy5pc1Jlc2l6ZUJvdW5kICkgewogICAgcmV0dXJuOwogIH0KICBldmVudGllLmJpbmQoIHdpbmRvdywgJ3Jlc2l6ZScsIHRoaXMgKTsKICB0aGlzLmlzUmVzaXplQm91bmQgPSB0cnVlOwp9OwoKLyoqCiAqIFVuYmluZCBsYXlvdXQgdG8gd2luZG93IHJlc2l6aW5nCiAqLwpPdXRsYXllci5wcm90b3R5cGUudW5iaW5kUmVzaXplID0gZnVuY3Rpb24oKSB7CiAgaWYgKCB0aGlzLmlzUmVzaXplQm91bmQgKSB7CiAgICBldmVudGllLnVuYmluZCggd2luZG93LCAncmVzaXplJywgdGhpcyApOwogIH0KICB0aGlzLmlzUmVzaXplQm91bmQgPSBmYWxzZTsKfTsKCi8vIG9yaWdpbmFsIGRlYm91bmNlIGJ5IEpvaG4gSGFubgovLyBodHRwOi8vdW5zY3JpcHRhYmxlLmNvbS9pbmRleC5waHAvMjAwOS8wMy8yMC9kZWJvdW5jaW5nLWphdmFzY3JpcHQtbWV0aG9kcy8KCi8vIHRoaXMgZmlyZXMgZXZlcnkgcmVzaXplCk91dGxheWVyLnByb3RvdHlwZS5vbnJlc2l6ZSA9IGZ1bmN0aW9uKCkgewogIGlmICggdGhpcy5yZXNpemVUaW1lb3V0ICkgewogICAgY2xlYXJUaW1lb3V0KCB0aGlzLnJlc2l6ZVRpbWVvdXQgKTsKICB9CgogIHZhciBfdGhpcyA9IHRoaXM7CiAgZnVuY3Rpb24gZGVsYXllZCgpIHsKICAgIF90aGlzLnJlc2l6ZSgpOwogICAgZGVsZXRlIF90aGlzLnJlc2l6ZVRpbWVvdXQ7CiAgfQoKICB0aGlzLnJlc2l6ZVRpbWVvdXQgPSBzZXRUaW1lb3V0KCBkZWxheWVkLCAxMDAgKTsKfTsKCi8vIGRlYm91bmNlZCwgbGF5b3V0IG9uIHJlc2l6ZQpPdXRsYXllci5wcm90b3R5cGUucmVzaXplID0gZnVuY3Rpb24oKSB7CiAgLy8gZG9uJ3QgdHJpZ2dlciBpZiBzaXplIGRpZCBub3QgY2hhbmdlCiAgLy8gb3IgaWYgcmVzaXplIHdhcyB1bmJvdW5kLiBTZWUgIzkKICBpZiAoICF0aGlzLmlzUmVzaXplQm91bmQgfHwgIXRoaXMubmVlZHNSZXNpemVMYXlvdXQoKSApIHsKICAgIHJldHVybjsKICB9CgogIHRoaXMubGF5b3V0KCk7Cn07CgovKioKICogY2hlY2sgaWYgbGF5b3V0IGlzIG5lZWRlZCBwb3N0IGxheW91dAogKiBAcmV0dXJucyBCb29sZWFuCiAqLwpPdXRsYXllci5wcm90b3R5cGUubmVlZHNSZXNpemVMYXlvdXQgPSBmdW5jdGlvbigpIHsKICB2YXIgc2l6ZSA9IGdldFNpemUoIHRoaXMuZWxlbWVudCApOwogIC8vIGNoZWNrIHRoYXQgdGhpcy5zaXplIGFuZCBzaXplIGFyZSB0aGVyZQogIC8vIElFOCB0cmlnZ2VycyByZXNpemUgb24gYm9keSBzaXplIGNoYW5nZSwgc28gdGhleSBtaWdodCBub3QgYmUKICB2YXIgaGFzU2l6ZXMgPSB0aGlzLnNpemUgJiYgc2l6ZTsKICByZXR1cm4gaGFzU2l6ZXMgJiYgc2l6ZS5pbm5lcldpZHRoICE9PSB0aGlzLnNpemUuaW5uZXJXaWR0aDsKfTsKCi8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tIG1ldGhvZHMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gLy8KCi8qKgogKiBhZGQgaXRlbXMgdG8gT3V0bGF5ZXIgaW5zdGFuY2UKICogQHBhcmFtIHtBcnJheSBvciBOb2RlTGlzdCBvciBFbGVtZW50fSBlbGVtcwogKiBAcmV0dXJucyB7QXJyYXl9IGl0ZW1zIC0gT3V0bGF5ZXIuSXRlbXMKKiovCk91dGxheWVyLnByb3RvdHlwZS5hZGRJdGVtcyA9IGZ1bmN0aW9uKCBlbGVtcyApIHsKICB2YXIgaXRlbXMgPSB0aGlzLl9pdGVtaXplKCBlbGVtcyApOwogIC8vIGFkZCBpdGVtcyB0byBjb2xsZWN0aW9uCiAgaWYgKCBpdGVtcy5sZW5ndGggKSB7CiAgICB0aGlzLml0ZW1zID0gdGhpcy5pdGVtcy5jb25jYXQoIGl0ZW1zICk7CiAgfQogIHJldHVybiBpdGVtczsKfTsKCi8qKgogKiBMYXlvdXQgbmV3bHktYXBwZW5kZWQgaXRlbSBlbGVtZW50cwogKiBAcGFyYW0ge0FycmF5IG9yIE5vZGVMaXN0IG9yIEVsZW1lbnR9IGVsZW1zCiAqLwpPdXRsYXllci5wcm90b3R5cGUuYXBwZW5kZWQgPSBmdW5jdGlvbiggZWxlbXMgKSB7CiAgdmFyIGl0ZW1zID0gdGhpcy5hZGRJdGVtcyggZWxlbXMgKTsKICBpZiAoICFpdGVtcy5sZW5ndGggKSB7CiAgICByZXR1cm47CiAgfQogIC8vIGxheW91dCBhbmQgcmV2ZWFsIGp1c3QgdGhlIG5ldyBpdGVtcwogIHRoaXMubGF5b3V0SXRlbXMoIGl0ZW1zLCB0cnVlICk7CiAgdGhpcy5yZXZlYWwoIGl0ZW1zICk7Cn07CgovKioKICogTGF5b3V0IHByZXBlbmRlZCBlbGVtZW50cwogKiBAcGFyYW0ge0FycmF5IG9yIE5vZGVMaXN0IG9yIEVsZW1lbnR9IGVsZW1zCiAqLwpPdXRsYXllci5wcm90b3R5cGUucHJlcGVuZGVkID0gZnVuY3Rpb24oIGVsZW1zICkgewogIHZhciBpdGVtcyA9IHRoaXMuX2l0ZW1pemUoIGVsZW1zICk7CiAgaWYgKCAhaXRlbXMubGVuZ3RoICkgewogICAgcmV0dXJuOwogIH0KICAvLyBhZGQgaXRlbXMgdG8gYmVnaW5uaW5nIG9mIGNvbGxlY3Rpb24KICB2YXIgcHJldmlvdXNJdGVtcyA9IHRoaXMuaXRlbXMuc2xpY2UoMCk7CiAgdGhpcy5pdGVtcyA9IGl0ZW1zLmNvbmNhdCggcHJldmlvdXNJdGVtcyApOwogIC8vIHN0YXJ0IG5ldyBsYXlvdXQKICB0aGlzLl9yZXNldExheW91dCgpOwogIHRoaXMuX21hbmFnZVN0YW1wcygpOwogIC8vIGxheW91dCBuZXcgc3R1ZmYgd2l0aG91dCB0cmFuc2l0aW9uCiAgdGhpcy5sYXlvdXRJdGVtcyggaXRlbXMsIHRydWUgKTsKICB0aGlzLnJldmVhbCggaXRlbXMgKTsKICAvLyBsYXlvdXQgcHJldmlvdXMgaXRlbXMKICB0aGlzLmxheW91dEl0ZW1zKCBwcmV2aW91c0l0ZW1zICk7Cn07CgovKioKICogcmV2ZWFsIGEgY29sbGVjdGlvbiBvZiBpdGVtcwogKiBAcGFyYW0ge0FycmF5IG9mIE91dGxheWVyLkl0ZW1zfSBpdGVtcwogKi8KT3V0bGF5ZXIucHJvdG90eXBlLnJldmVhbCA9IGZ1bmN0aW9uKCBpdGVtcyApIHsKICB2YXIgbGVuID0gaXRlbXMgJiYgaXRlbXMubGVuZ3RoOwogIGlmICggIWxlbiApIHsKICAgIHJldHVybjsKICB9CiAgZm9yICggdmFyIGk9MDsgaSA8IGxlbjsgaSsrICkgewogICAgdmFyIGl0ZW0gPSBpdGVtc1tpXTsKICAgIGl0ZW0ucmV2ZWFsKCk7CiAgfQp9OwoKLyoqCiAqIGhpZGUgYSBjb2xsZWN0aW9uIG9mIGl0ZW1zCiAqIEBwYXJhbSB7QXJyYXkgb2YgT3V0bGF5ZXIuSXRlbXN9IGl0ZW1zCiAqLwpPdXRsYXllci5wcm90b3R5cGUuaGlkZSA9IGZ1bmN0aW9uKCBpdGVtcyApIHsKICB2YXIgbGVuID0gaXRlbXMgJiYgaXRlbXMubGVuZ3RoOwogIGlmICggIWxlbiApIHsKICAgIHJldHVybjsKICB9CiAgZm9yICggdmFyIGk9MDsgaSA8IGxlbjsgaSsrICkgewogICAgdmFyIGl0ZW0gPSBpdGVtc1tpXTsKICAgIGl0ZW0uaGlkZSgpOwogIH0KfTsKCi8qKgogKiBnZXQgT3V0bGF5ZXIuSXRlbSwgZ2l2ZW4gYW4gRWxlbWVudAogKiBAcGFyYW0ge0VsZW1lbnR9IGVsZW0KICogQHBhcmFtIHtGdW5jdGlvbn0gY2FsbGJhY2sKICogQHJldHVybnMge091dGxheWVyLkl0ZW19IGl0ZW0KICovCk91dGxheWVyLnByb3RvdHlwZS5nZXRJdGVtID0gZnVuY3Rpb24oIGVsZW0gKSB7CiAgLy8gbG9vcCB0aHJvdWdoIGl0ZW1zIHRvIGdldCB0aGUgb25lIHRoYXQgbWF0Y2hlcwogIGZvciAoIHZhciBpPTAsIGxlbiA9IHRoaXMuaXRlbXMubGVuZ3RoOyBpIDwgbGVuOyBpKysgKSB7CiAgICB2YXIgaXRlbSA9IHRoaXMuaXRlbXNbaV07CiAgICBpZiAoIGl0ZW0uZWxlbWVudCA9PT0gZWxlbSApIHsKICAgICAgLy8gcmV0dXJuIGl0ZW0KICAgICAgcmV0dXJuIGl0ZW07CiAgICB9CiAgfQp9OwoKLyoqCiAqIGdldCBjb2xsZWN0aW9uIG9mIE91dGxheWVyLkl0ZW1zLCBnaXZlbiBFbGVtZW50cwogKiBAcGFyYW0ge0FycmF5fSBlbGVtcwogKiBAcmV0dXJucyB7QXJyYXl9IGl0ZW1zIC0gT3V0bGF5ZXIuSXRlbXMKICovCk91dGxheWVyLnByb3RvdHlwZS5nZXRJdGVtcyA9IGZ1bmN0aW9uKCBlbGVtcyApIHsKICBpZiAoICFlbGVtcyB8fCAhZWxlbXMubGVuZ3RoICkgewogICAgcmV0dXJuOwogIH0KICB2YXIgaXRlbXMgPSBbXTsKICBmb3IgKCB2YXIgaT0wLCBsZW4gPSBlbGVtcy5sZW5ndGg7IGkgPCBsZW47IGkrKyApIHsKICAgIHZhciBlbGVtID0gZWxlbXNbaV07CiAgICB2YXIgaXRlbSA9IHRoaXMuZ2V0SXRlbSggZWxlbSApOwogICAgaWYgKCBpdGVtICkgewogICAgICBpdGVtcy5wdXNoKCBpdGVtICk7CiAgICB9CiAgfQoKICByZXR1cm4gaXRlbXM7Cn07CgovKioKICogcmVtb3ZlIGVsZW1lbnQocykgZnJvbSBpbnN0YW5jZSBhbmQgRE9NCiAqIEBwYXJhbSB7QXJyYXkgb3IgTm9kZUxpc3Qgb3IgRWxlbWVudH0gZWxlbXMKICovCk91dGxheWVyLnByb3RvdHlwZS5yZW1vdmUgPSBmdW5jdGlvbiggZWxlbXMgKSB7CiAgZWxlbXMgPSBtYWtlQXJyYXkoIGVsZW1zICk7CgogIHZhciByZW1vdmVJdGVtcyA9IHRoaXMuZ2V0SXRlbXMoIGVsZW1zICk7CiAgLy8gYmFpbCBpZiBubyBpdGVtcyB0byByZW1vdmUKICBpZiAoICFyZW1vdmVJdGVtcyB8fCAhcmVtb3ZlSXRlbXMubGVuZ3RoICkgewogICAgcmV0dXJuOwogIH0KCiAgdGhpcy5faXRlbXNPbiggcmVtb3ZlSXRlbXMsICdyZW1vdmUnLCBmdW5jdGlvbigpIHsKICAgIHRoaXMuZW1pdEV2ZW50KCAncmVtb3ZlQ29tcGxldGUnLCBbIHRoaXMsIHJlbW92ZUl0ZW1zIF0gKTsKICB9KTsKCiAgZm9yICggdmFyIGk9MCwgbGVuID0gcmVtb3ZlSXRlbXMubGVuZ3RoOyBpIDwgbGVuOyBpKysgKSB7CiAgICB2YXIgaXRlbSA9IHJlbW92ZUl0ZW1zW2ldOwogICAgaXRlbS5yZW1vdmUoKTsKICAgIC8vIHJlbW92ZSBpdGVtIGZyb20gY29sbGVjdGlvbgogICAgcmVtb3ZlRnJvbSggaXRlbSwgdGhpcy5pdGVtcyApOwogIH0KfTsKCi8vIC0tLS0tIGRlc3Ryb3kgLS0tLS0gLy8KCi8vIHJlbW92ZSBhbmQgZGlzYWJsZSBPdXRsYXllciBpbnN0YW5jZQpPdXRsYXllci5wcm90b3R5cGUuZGVzdHJveSA9IGZ1bmN0aW9uKCkgewogIC8vIGNsZWFuIHVwIGR5bmFtaWMgc3R5bGVzCiAgdmFyIHN0eWxlID0gdGhpcy5lbGVtZW50LnN0eWxlOwogIHN0eWxlLmhlaWdodCA9ICcnOwogIHN0eWxlLnBvc2l0aW9uID0gJyc7CiAgc3R5bGUud2lkdGggPSAnJzsKICAvLyBkZXN0cm95IGl0ZW1zCiAgZm9yICggdmFyIGk9MCwgbGVuID0gdGhpcy5pdGVtcy5sZW5ndGg7IGkgPCBsZW47IGkrKyApIHsKICAgIHZhciBpdGVtID0gdGhpcy5pdGVtc1tpXTsKICAgIGl0ZW0uZGVzdHJveSgpOwogIH0KCiAgdGhpcy51bmJpbmRSZXNpemUoKTsKCiAgZGVsZXRlIHRoaXMuZWxlbWVudC5vdXRsYXllckdVSUQ7CiAgLy8gcmVtb3ZlIGRhdGEgZm9yIGpRdWVyeQogIGlmICggalF1ZXJ5ICkgewogICAgalF1ZXJ5LnJlbW92ZURhdGEoIHRoaXMuZWxlbWVudCwgdGhpcy5jb25zdHJ1Y3Rvci5uYW1lc3BhY2UgKTsKICB9Cgp9OwoKLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gZGF0YSAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSAvLwoKLyoqCiAqIGdldCBPdXRsYXllciBpbnN0YW5jZSBmcm9tIGVsZW1lbnQKICogQHBhcmFtIHtFbGVtZW50fSBlbGVtCiAqIEByZXR1cm5zIHtPdXRsYXllcn0KICovCk91dGxheWVyLmRhdGEgPSBmdW5jdGlvbiggZWxlbSApIHsKICB2YXIgaWQgPSBlbGVtICYmIGVsZW0ub3V0bGF5ZXJHVUlEOwogIHJldHVybiBpZCAmJiBpbnN0YW5jZXNbIGlkIF07Cn07CgoKLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gY3JlYXRlIE91dGxheWVyIGNsYXNzIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tIC8vCgovKioKICogY3JlYXRlIGEgbGF5b3V0IGNsYXNzCiAqIEBwYXJhbSB7U3RyaW5nfSBuYW1lc3BhY2UKICovCk91dGxheWVyLmNyZWF0ZSA9IGZ1bmN0aW9uKCBuYW1lc3BhY2UsIG9wdGlvbnMgKSB7CiAgLy8gc3ViLWNsYXNzIE91dGxheWVyCiAgZnVuY3Rpb24gTGF5b3V0KCkgewogICAgT3V0bGF5ZXIuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwogIH0KICAvLyBpbmhlcml0IE91dGxheWVyIHByb3RvdHlwZSwgdXNlIE9iamVjdC5jcmVhdGUgaWYgdGhlcmUKICBpZiAoIE9iamVjdC5jcmVhdGUgKSB7CiAgICBMYXlvdXQucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZSggT3V0bGF5ZXIucHJvdG90eXBlICk7CiAgfSBlbHNlIHsKICAgIGV4dGVuZCggTGF5b3V0LnByb3RvdHlwZSwgT3V0bGF5ZXIucHJvdG90eXBlICk7CiAgfQogIC8vIHNldCBjb250cnVjdG9yLCB1c2VkIGZvciBuYW1lc3BhY2UgYW5kIEl0ZW0KICBMYXlvdXQucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gTGF5b3V0OwoKICBMYXlvdXQuZGVmYXVsdHMgPSBleHRlbmQoIHt9LCBPdXRsYXllci5kZWZhdWx0cyApOwogIC8vIGFwcGx5IG5ldyBvcHRpb25zCiAgZXh0ZW5kKCBMYXlvdXQuZGVmYXVsdHMsIG9wdGlvbnMgKTsKICAvLyBrZWVwIHByb3RvdHlwZS5zZXR0aW5ncyBmb3IgYmFja3dhcmRzIGNvbXBhdGliaWxpdHkgKFBhY2tlcnkgdjEuMi4wKQogIExheW91dC5wcm90b3R5cGUuc2V0dGluZ3MgPSB7fTsKCiAgTGF5b3V0Lm5hbWVzcGFjZSA9IG5hbWVzcGFjZTsKCiAgTGF5b3V0LmRhdGEgPSBPdXRsYXllci5kYXRhOwoKICAvLyBzdWItY2xhc3MgSXRlbQogIExheW91dC5JdGVtID0gZnVuY3Rpb24gTGF5b3V0SXRlbSgpIHsKICAgIEl0ZW0uYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwogIH07CgogIExheW91dC5JdGVtLnByb3RvdHlwZSA9IG5ldyBJdGVtKCk7CgogIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tIGRlY2xhcmF0aXZlIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tIC8vCgogIC8qKgogICAqIGFsbG93IHVzZXIgdG8gaW5pdGlhbGl6ZSBPdXRsYXllciB2aWEgLmpzLW5hbWVzcGFjZSBjbGFzcwogICAqIG9wdGlvbnMgYXJlIHBhcnNlZCBmcm9tIGRhdGEtbmFtZXNwYWNlLW9wdGlvbiBhdHRyaWJ1dGUKICAgKi8KICBkb2NSZWFkeSggZnVuY3Rpb24oKSB7CiAgICB2YXIgZGFzaGVkTmFtZXNwYWNlID0gdG9EYXNoZWQoIG5hbWVzcGFjZSApOwogICAgdmFyIGVsZW1zID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCggJy5qcy0nICsgZGFzaGVkTmFtZXNwYWNlICk7CiAgICB2YXIgZGF0YUF0dHIgPSAnZGF0YS0nICsgZGFzaGVkTmFtZXNwYWNlICsgJy1vcHRpb25zJzsKCiAgICBmb3IgKCB2YXIgaT0wLCBsZW4gPSBlbGVtcy5sZW5ndGg7IGkgPCBsZW47IGkrKyApIHsKICAgICAgdmFyIGVsZW0gPSBlbGVtc1tpXTsKICAgICAgdmFyIGF0dHIgPSBlbGVtLmdldEF0dHJpYnV0ZSggZGF0YUF0dHIgKTsKICAgICAgdmFyIG9wdGlvbnM7CiAgICAgIHRyeSB7CiAgICAgICAgb3B0aW9ucyA9IGF0dHIgJiYgSlNPTi5wYXJzZSggYXR0ciApOwogICAgICB9IGNhdGNoICggZXJyb3IgKSB7CiAgICAgICAgLy8gbG9nIGVycm9yLCBkbyBub3QgaW5pdGlhbGl6ZQogICAgICAgIGlmICggY29uc29sZSApIHsKICAgICAgICAgIGNvbnNvbGUuZXJyb3IoICdFcnJvciBwYXJzaW5nICcgKyBkYXRhQXR0ciArICcgb24gJyArCiAgICAgICAgICAgIGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKSArICggZWxlbS5pZCA/ICcjJyArIGVsZW0uaWQgOiAnJyApICsgJzogJyArCiAgICAgICAgICAgIGVycm9yICk7CiAgICAgICAgfQogICAgICAgIGNvbnRpbnVlOwogICAgICB9CiAgICAgIC8vIGluaXRpYWxpemUKICAgICAgdmFyIGluc3RhbmNlID0gbmV3IExheW91dCggZWxlbSwgb3B0aW9ucyApOwogICAgICAvLyBtYWtlIGF2YWlsYWJsZSB2aWEgJCgpLmRhdGEoJ2xheW91dG5hbWUnKQogICAgICBpZiAoIGpRdWVyeSApIHsKICAgICAgICBqUXVlcnkuZGF0YSggZWxlbSwgbmFtZXNwYWNlLCBpbnN0YW5jZSApOwogICAgICB9CiAgICB9CiAgfSk7CgogIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tIGpRdWVyeSBicmlkZ2UgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gLy8KCiAgLy8gbWFrZSBpbnRvIGpRdWVyeSBwbHVnaW4KICBpZiAoIGpRdWVyeSAmJiBqUXVlcnkuYnJpZGdldCApIHsKICAgIGpRdWVyeS5icmlkZ2V0KCBuYW1lc3BhY2UsIExheW91dCApOwogIH0KCiAgcmV0dXJuIExheW91dDsKfTsKCi8vIC0tLS0tIGZpbiAtLS0tLSAvLwoKLy8gYmFjayBpbiBnbG9iYWwKT3V0bGF5ZXIuSXRlbSA9IEl0ZW07CgpyZXR1cm4gT3V0bGF5ZXI7Cgp9CgovLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSB0cmFuc3BvcnQgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gLy8KCmlmICggdHlwZW9mIGRlZmluZSA9PT0gJ2Z1bmN0aW9uJyAmJiBkZWZpbmUuYW1kICkgewogIC8vIEFNRAogIGRlZmluZSggJ291dGxheWVyL291dGxheWVyJyxbCiAgICAgICdldmVudGllL2V2ZW50aWUnLAogICAgICAnZG9jLXJlYWR5L2RvYy1yZWFkeScsCiAgICAgICdldmVudEVtaXR0ZXIvRXZlbnRFbWl0dGVyJywKICAgICAgJ2dldC1zaXplL2dldC1zaXplJywKICAgICAgJ21hdGNoZXMtc2VsZWN0b3IvbWF0Y2hlcy1zZWxlY3RvcicsCiAgICAgICcuL2l0ZW0nCiAgICBdLAogICAgb3V0bGF5ZXJEZWZpbml0aW9uICk7Cn0gZWxzZSB7CiAgLy8gYnJvd3NlciBnbG9iYWwKICB3aW5kb3cuT3V0bGF5ZXIgPSBvdXRsYXllckRlZmluaXRpb24oCiAgICB3aW5kb3cuZXZlbnRpZSwKICAgIHdpbmRvdy5kb2NSZWFkeSwKICAgIHdpbmRvdy5FdmVudEVtaXR0ZXIsCiAgICB3aW5kb3cuZ2V0U2l6ZSwKICAgIHdpbmRvdy5tYXRjaGVzU2VsZWN0b3IsCiAgICB3aW5kb3cuT3V0bGF5ZXIuSXRlbQogICk7Cn0KCn0pKCB3aW5kb3cgKTsKCi8qIQogKiBNYXNvbnJ5IHYzLjEuNQogKiBDYXNjYWRpbmcgZ3JpZCBsYXlvdXQgbGlicmFyeQogKiBodHRwOi8vbWFzb25yeS5kZXNhbmRyby5jb20KICogTUlUIExpY2Vuc2UKICogYnkgRGF2aWQgRGVTYW5kcm8KICovCgooIGZ1bmN0aW9uKCB3aW5kb3cgKSB7CgoKCi8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tIGhlbHBlcnMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gLy8KCnZhciBpbmRleE9mID0gQXJyYXkucHJvdG90eXBlLmluZGV4T2YgPwogIGZ1bmN0aW9uKCBpdGVtcywgdmFsdWUgKSB7CiAgICByZXR1cm4gaXRlbXMuaW5kZXhPZiggdmFsdWUgKTsKICB9IDoKICBmdW5jdGlvbiAoIGl0ZW1zLCB2YWx1ZSApIHsKICAgIGZvciAoIHZhciBpPTAsIGxlbiA9IGl0ZW1zLmxlbmd0aDsgaSA8IGxlbjsgaSsrICkgewogICAgICB2YXIgaXRlbSA9IGl0ZW1zW2ldOwogICAgICBpZiAoIGl0ZW0gPT09IHZhbHVlICkgewogICAgICAgIHJldHVybiBpOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gLTE7CiAgfTsKCi8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tIG1hc29ucnlEZWZpbml0aW9uIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tIC8vCgovLyB1c2VkIGZvciBBTUQgZGVmaW5pdGlvbiBhbmQgcmVxdWlyZXMKZnVuY3Rpb24gbWFzb25yeURlZmluaXRpb24oIE91dGxheWVyLCBnZXRTaXplICkgewogIC8vIGNyZWF0ZSBhbiBPdXRsYXllciBsYXlvdXQgY2xhc3MKICB2YXIgTWFzb25yeSA9IE91dGxheWVyLmNyZWF0ZSgnbWFzb25yeScpOwoKICBNYXNvbnJ5LnByb3RvdHlwZS5fcmVzZXRMYXlvdXQgPSBmdW5jdGlvbigpIHsKICAgIHRoaXMuZ2V0U2l6ZSgpOwogICAgdGhpcy5fZ2V0TWVhc3VyZW1lbnQoICdjb2x1bW5XaWR0aCcsICdvdXRlcldpZHRoJyApOwogICAgdGhpcy5fZ2V0TWVhc3VyZW1lbnQoICdndXR0ZXInLCAnb3V0ZXJXaWR0aCcgKTsKICAgIHRoaXMubWVhc3VyZUNvbHVtbnMoKTsKCiAgICAvLyByZXNldCBjb2x1bW4gWQogICAgdmFyIGkgPSB0aGlzLmNvbHM7CiAgICB0aGlzLmNvbFlzID0gW107CiAgICB3aGlsZSAoaS0tKSB7CiAgICAgIHRoaXMuY29sWXMucHVzaCggMCApOwogICAgfQoKICAgIHRoaXMubWF4WSA9IDA7CiAgfTsKCiAgTWFzb25yeS5wcm90b3R5cGUubWVhc3VyZUNvbHVtbnMgPSBmdW5jdGlvbigpIHsKICAgIHRoaXMuZ2V0Q29udGFpbmVyV2lkdGgoKTsKICAgIC8vIGlmIGNvbHVtbldpZHRoIGlzIDAsIGRlZmF1bHQgdG8gb3V0ZXJXaWR0aCBvZiBmaXJzdCBpdGVtCiAgICBpZiAoICF0aGlzLmNvbHVtbldpZHRoICkgewogICAgICB2YXIgZmlyc3RJdGVtID0gdGhpcy5pdGVtc1swXTsKICAgICAgdmFyIGZpcnN0SXRlbUVsZW0gPSBmaXJzdEl0ZW0gJiYgZmlyc3RJdGVtLmVsZW1lbnQ7CiAgICAgIC8vIGNvbHVtbldpZHRoIGZhbGwgYmFjayB0byBpdGVtIG9mIGZpcnN0IGVsZW1lbnQKICAgICAgdGhpcy5jb2x1bW5XaWR0aCA9IGZpcnN0SXRlbUVsZW0gJiYgZ2V0U2l6ZSggZmlyc3RJdGVtRWxlbSApLm91dGVyV2lkdGggfHwKICAgICAgICAvLyBpZiBmaXJzdCBlbGVtIGhhcyBubyB3aWR0aCwgZGVmYXVsdCB0byBzaXplIG9mIGNvbnRhaW5lcgogICAgICAgIHRoaXMuY29udGFpbmVyV2lkdGg7CiAgICB9CgogICAgdGhpcy5jb2x1bW5XaWR0aCArPSB0aGlzLmd1dHRlcjsKCiAgICB0aGlzLmNvbHMgPSBNYXRoLmZsb29yKCAoIHRoaXMuY29udGFpbmVyV2lkdGggKyB0aGlzLmd1dHRlciApIC8gdGhpcy5jb2x1bW5XaWR0aCApOwogICAgdGhpcy5jb2xzID0gTWF0aC5tYXgoIHRoaXMuY29scywgMSApOwogIH07CgogIE1hc29ucnkucHJvdG90eXBlLmdldENvbnRhaW5lcldpZHRoID0gZnVuY3Rpb24oKSB7CiAgICAvLyBjb250YWluZXIgaXMgcGFyZW50IGlmIGZpdCB3aWR0aAogICAgdmFyIGNvbnRhaW5lciA9IHRoaXMub3B0aW9ucy5pc0ZpdFdpZHRoID8gdGhpcy5lbGVtZW50LnBhcmVudE5vZGUgOiB0aGlzLmVsZW1lbnQ7CiAgICAvLyBjaGVjayB0aGF0IHRoaXMuc2l6ZSBhbmQgc2l6ZSBhcmUgdGhlcmUKICAgIC8vIElFOCB0cmlnZ2VycyByZXNpemUgb24gYm9keSBzaXplIGNoYW5nZSwgc28gdGhleSBtaWdodCBub3QgYmUKICAgIHZhciBzaXplID0gZ2V0U2l6ZSggY29udGFpbmVyICk7CiAgICB0aGlzLmNvbnRhaW5lcldpZHRoID0gc2l6ZSAmJiBzaXplLmlubmVyV2lkdGg7CiAgfTsKCiAgTWFzb25yeS5wcm90b3R5cGUuX2dldEl0ZW1MYXlvdXRQb3NpdGlvbiA9IGZ1bmN0aW9uKCBpdGVtICkgewogICAgaXRlbS5nZXRTaXplKCk7CiAgICAvLyBob3cgbWFueSBjb2x1bW5zIGRvZXMgdGhpcyBicmljayBzcGFuCiAgICB2YXIgcmVtYWluZGVyID0gaXRlbS5zaXplLm91dGVyV2lkdGggJSB0aGlzLmNvbHVtbldpZHRoOwogICAgdmFyIG1hdGhNZXRob2QgPSByZW1haW5kZXIgJiYgcmVtYWluZGVyIDwgMSA/ICdyb3VuZCcgOiAnY2VpbCc7CiAgICAvLyByb3VuZCBpZiBvZmYgYnkgMSBwaXhlbCwgb3RoZXJ3aXNlIHVzZSBjZWlsCiAgICB2YXIgY29sU3BhbiA9IE1hdGhbIG1hdGhNZXRob2QgXSggaXRlbS5zaXplLm91dGVyV2lkdGggLyB0aGlzLmNvbHVtbldpZHRoICk7CiAgICBjb2xTcGFuID0gTWF0aC5taW4oIGNvbFNwYW4sIHRoaXMuY29scyApOwoKICAgIHZhciBjb2xHcm91cCA9IHRoaXMuX2dldENvbEdyb3VwKCBjb2xTcGFuICk7CiAgICAvLyBnZXQgdGhlIG1pbmltdW0gWSB2YWx1ZSBmcm9tIHRoZSBjb2x1bW5zCiAgICB2YXIgbWluaW11bVkgPSBNYXRoLm1pbi5hcHBseSggTWF0aCwgY29sR3JvdXAgKTsKICAgIHZhciBzaG9ydENvbEluZGV4ID0gaW5kZXhPZiggY29sR3JvdXAsIG1pbmltdW1ZICk7CgogICAgLy8gcG9zaXRpb24gdGhlIGJyaWNrCiAgICB2YXIgcG9zaXRpb24gPSB7CiAgICAgIHg6IHRoaXMuY29sdW1uV2lkdGggKiBzaG9ydENvbEluZGV4LAogICAgICB5OiBtaW5pbXVtWQogICAgfTsKCiAgICAvLyBhcHBseSBzZXRIZWlnaHQgdG8gbmVjZXNzYXJ5IGNvbHVtbnMKICAgIHZhciBzZXRIZWlnaHQgPSBtaW5pbXVtWSArIGl0ZW0uc2l6ZS5vdXRlckhlaWdodDsKICAgIHZhciBzZXRTcGFuID0gdGhpcy5jb2xzICsgMSAtIGNvbEdyb3VwLmxlbmd0aDsKICAgIGZvciAoIHZhciBpID0gMDsgaSA8IHNldFNwYW47IGkrKyApIHsKICAgICAgdGhpcy5jb2xZc1sgc2hvcnRDb2xJbmRleCArIGkgXSA9IHNldEhlaWdodDsKICAgIH0KCiAgICByZXR1cm4gcG9zaXRpb247CiAgfTsKCiAgLyoqCiAgICogQHBhcmFtIHtOdW1iZXJ9IGNvbFNwYW4gLSBudW1iZXIgb2YgY29sdW1ucyB0aGUgZWxlbWVudCBzcGFucwogICAqIEByZXR1cm5zIHtBcnJheX0gY29sR3JvdXAKICAgKi8KICBNYXNvbnJ5LnByb3RvdHlwZS5fZ2V0Q29sR3JvdXAgPSBmdW5jdGlvbiggY29sU3BhbiApIHsKICAgIGlmICggY29sU3BhbiA8IDIgKSB7CiAgICAgIC8vIGlmIGJyaWNrIHNwYW5zIG9ubHkgb25lIGNvbHVtbiwgdXNlIGFsbCB0aGUgY29sdW1uIFlzCiAgICAgIHJldHVybiB0aGlzLmNvbFlzOwogICAgfQoKICAgIHZhciBjb2xHcm91cCA9IFtdOwogICAgLy8gaG93IG1hbnkgZGlmZmVyZW50IHBsYWNlcyBjb3VsZCB0aGlzIGJyaWNrIGZpdCBob3Jpem9udGFsbHkKICAgIHZhciBncm91cENvdW50ID0gdGhpcy5jb2xzICsgMSAtIGNvbFNwYW47CiAgICAvLyBmb3IgZWFjaCBncm91cCBwb3RlbnRpYWwgaG9yaXpvbnRhbCBwb3NpdGlvbgogICAgZm9yICggdmFyIGkgPSAwOyBpIDwgZ3JvdXBDb3VudDsgaSsrICkgewogICAgICAvLyBtYWtlIGFuIGFycmF5IG9mIGNvbFkgdmFsdWVzIGZvciB0aGF0IG9uZSBncm91cAogICAgICB2YXIgZ3JvdXBDb2xZcyA9IHRoaXMuY29sWXMuc2xpY2UoIGksIGkgKyBjb2xTcGFuICk7CiAgICAgIC8vIGFuZCBnZXQgdGhlIG1heCB2YWx1ZSBvZiB0aGUgYXJyYXkKICAgICAgY29sR3JvdXBbaV0gPSBNYXRoLm1heC5hcHBseSggTWF0aCwgZ3JvdXBDb2xZcyApOwogICAgfQogICAgcmV0dXJuIGNvbEdyb3VwOwogIH07CgogIE1hc29ucnkucHJvdG90eXBlLl9tYW5hZ2VTdGFtcCA9IGZ1bmN0aW9uKCBzdGFtcCApIHsKICAgIHZhciBzdGFtcFNpemUgPSBnZXRTaXplKCBzdGFtcCApOwogICAgdmFyIG9mZnNldCA9IHRoaXMuX2dldEVsZW1lbnRPZmZzZXQoIHN0YW1wICk7CiAgICAvLyBnZXQgdGhlIGNvbHVtbnMgdGhhdCB0aGlzIHN0YW1wIGFmZmVjdHMKICAgIHZhciBmaXJzdFggPSB0aGlzLm9wdGlvbnMuaXNPcmlnaW5MZWZ0ID8gb2Zmc2V0LmxlZnQgOiBvZmZzZXQucmlnaHQ7CiAgICB2YXIgbGFzdFggPSBmaXJzdFggKyBzdGFtcFNpemUub3V0ZXJXaWR0aDsKICAgIHZhciBmaXJzdENvbCA9IE1hdGguZmxvb3IoIGZpcnN0WCAvIHRoaXMuY29sdW1uV2lkdGggKTsKICAgIGZpcnN0Q29sID0gTWF0aC5tYXgoIDAsIGZpcnN0Q29sICk7CiAgICB2YXIgbGFzdENvbCA9IE1hdGguZmxvb3IoIGxhc3RYIC8gdGhpcy5jb2x1bW5XaWR0aCApOwogICAgLy8gbGFzdENvbCBzaG91bGQgbm90IGdvIG92ZXIgaWYgbXVsdGlwbGUgb2YgY29sdW1uV2lkdGggIzQyNQogICAgbGFzdENvbCAtPSBsYXN0WCAlIHRoaXMuY29sdW1uV2lkdGggPyAwIDogMTsKICAgIGxhc3RDb2wgPSBNYXRoLm1pbiggdGhpcy5jb2xzIC0gMSwgbGFzdENvbCApOwogICAgLy8gc2V0IGNvbFlzIHRvIGJvdHRvbSBvZiB0aGUgc3RhbXAKICAgIHZhciBzdGFtcE1heFkgPSAoIHRoaXMub3B0aW9ucy5pc09yaWdpblRvcCA/IG9mZnNldC50b3AgOiBvZmZzZXQuYm90dG9tICkgKwogICAgICBzdGFtcFNpemUub3V0ZXJIZWlnaHQ7CiAgICBmb3IgKCB2YXIgaSA9IGZpcnN0Q29sOyBpIDw9IGxhc3RDb2w7IGkrKyApIHsKICAgICAgdGhpcy5jb2xZc1tpXSA9IE1hdGgubWF4KCBzdGFtcE1heFksIHRoaXMuY29sWXNbaV0gKTsKICAgIH0KICB9OwoKICBNYXNvbnJ5LnByb3RvdHlwZS5fZ2V0Q29udGFpbmVyU2l6ZSA9IGZ1bmN0aW9uKCkgewogICAgdGhpcy5tYXhZID0gTWF0aC5tYXguYXBwbHkoIE1hdGgsIHRoaXMuY29sWXMgKTsKICAgIHZhciBzaXplID0gewogICAgICBoZWlnaHQ6IHRoaXMubWF4WQogICAgfTsKCiAgICBpZiAoIHRoaXMub3B0aW9ucy5pc0ZpdFdpZHRoICkgewogICAgICBzaXplLndpZHRoID0gdGhpcy5fZ2V0Q29udGFpbmVyRml0V2lkdGgoKTsKICAgIH0KCiAgICByZXR1cm4gc2l6ZTsKICB9OwoKICBNYXNvbnJ5LnByb3RvdHlwZS5fZ2V0Q29udGFpbmVyRml0V2lkdGggPSBmdW5jdGlvbigpIHsKICAgIHZhciB1bnVzZWRDb2xzID0gMDsKICAgIC8vIGNvdW50IHVudXNlZCBjb2x1bW5zCiAgICB2YXIgaSA9IHRoaXMuY29sczsKICAgIHdoaWxlICggLS1pICkgewogICAgICBpZiAoIHRoaXMuY29sWXNbaV0gIT09IDAgKSB7CiAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgICAgdW51c2VkQ29scysrOwogICAgfQogICAgLy8gZml0IGNvbnRhaW5lciB0byBjb2x1bW5zIHRoYXQgaGF2ZSBiZWVuIHVzZWQKICAgIHJldHVybiAoIHRoaXMuY29scyAtIHVudXNlZENvbHMgKSAqIHRoaXMuY29sdW1uV2lkdGggLSB0aGlzLmd1dHRlcjsKICB9OwoKICBNYXNvbnJ5LnByb3RvdHlwZS5uZWVkc1Jlc2l6ZUxheW91dCA9IGZ1bmN0aW9uKCkgewogICAgdmFyIHByZXZpb3VzV2lkdGggPSB0aGlzLmNvbnRhaW5lcldpZHRoOwogICAgdGhpcy5nZXRDb250YWluZXJXaWR0aCgpOwogICAgcmV0dXJuIHByZXZpb3VzV2lkdGggIT09IHRoaXMuY29udGFpbmVyV2lkdGg7CiAgfTsKCiAgcmV0dXJuIE1hc29ucnk7Cn0KCi8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tIHRyYW5zcG9ydCAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSAvLwoKaWYgKCB0eXBlb2YgZGVmaW5lID09PSAnZnVuY3Rpb24nICYmIGRlZmluZS5hbWQgKSB7CiAgLy8gQU1ECiAgZGVmaW5lKCAnbWFzb25yeS9tYXNvbnJ5JyxbCiAgICAgICdvdXRsYXllci9vdXRsYXllcicsCiAgICAgICdnZXQtc2l6ZS9nZXQtc2l6ZScKICAgIF0sCiAgICBtYXNvbnJ5RGVmaW5pdGlvbiApOwp9IGVsc2UgewogIC8vIGJyb3dzZXIgZ2xvYmFsCiAgd2luZG93Lk1hc29ucnkgPSBtYXNvbnJ5RGVmaW5pdGlvbigKICAgIHdpbmRvdy5PdXRsYXllciwKICAgIHdpbmRvdy5nZXRTaXplCiAgKTsKfQoKfSkoIHdpbmRvdyApOwoKLyohCiAqIEZsdWlkIE1hc29ucnkgdjEuMC4xCiAqIGV4dGVuZHMgdGhlIGNhc2NhZGluZyBncmlkIGxheW91dCBsaWJyYXJ5IG9mCiAqIGh0dHA6Ly9tYXNvbnJ5LmRlc2FuZHJvLmNvbSBieSBmaWxsaW5nIHVwIHRoZSBjb250YWluZXIgaW4gaXRzIGZ1bGwgd2lkdGguCiAqIE1JVCBMaWNlbnNlCiAqLwoKKCBmdW5jdGlvbiggd2luZG93ICkgewoKCgovLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSBoZWxwZXJzIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tIC8vCgp2YXIgaW5kZXhPZiA9IEFycmF5LnByb3RvdHlwZS5pbmRleE9mID8KICBmdW5jdGlvbiggaXRlbXMsIHZhbHVlICkgewogICAgcmV0dXJuIGl0ZW1zLmluZGV4T2YoIHZhbHVlICk7CiAgfSA6CiAgZnVuY3Rpb24gKCBpdGVtcywgdmFsdWUgKSB7CiAgICBmb3IgKCB2YXIgaT0wLCBsZW4gPSBpdGVtcy5sZW5ndGg7IGkgPCBsZW47IGkrKyApIHsKICAgICAgdmFyIGl0ZW0gPSBpdGVtc1tpXTsKICAgICAgaWYgKCBpdGVtID09PSB2YWx1ZSApIHsKICAgICAgICByZXR1cm4gaTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIC0xOwogIH07CgovLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSBtYXNvbnJ5RGVmaW5pdGlvbiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSAvLwoKLy8gdXNlZCBmb3IgQU1EIGRlZmluaXRpb24gYW5kIHJlcXVpcmVzCmZ1bmN0aW9uIGZsdWlkTWFzb25yeURlZmluaXRpb24oIE91dGxheWVyLCBNYXNvbnJ5ICkgewoKICB2YXIgRmx1aWRNYXNvbnJ5ID0gT3V0bGF5ZXIuY3JlYXRlKCdmbHVpZE1hc29ucnknKTsKCiAgLy8gT3ZlcnJpZGUgb3JpZ2luYWwgbWVhc3VyZUNvbHVtbnMgbWV0aG9kIG9mIG1hc29ucnkKICBGbHVpZE1hc29ucnkucHJvdG90eXBlLm1lYXN1cmVDb2x1bW5zID0gZnVuY3Rpb24oKSB7CiAgICAvLyBteSBmbHVpZCBzdHVmZiBoZXJlCiAgICAvLyBnZXQgdGhlIG1pbkNvbHVtbldpZHRoCiAgICB0aGlzLl9nZXRNZWFzdXJlbWVudCggJ21pbkNvbHVtbldpZHRoJywgJ291dGVyV2lkdGgnICk7CiAgICB0aGlzLm1pbkNvbHVtbldpZHRoICs9IHRoaXMuZ3V0dGVyOwoKICAgIC8vIGdldCBjb250YWluZXIgd2lkdGgKICAgIHRoaXMuZ2V0Q29udGFpbmVyV2lkdGgoKTsKCiAgICAvLyBXb3JrYXJvdW5kOiBpc0ZpdFdpZHRoIG1vZGUgZG9lc24ndCByZXNwZWN0IHBhZGRpbmcgYW5kIGJvcmRlciBvZiB0aGUgaXRlbSBjb250YWluZXIKICAgIC8vIHdoZW4gbWVhc3N1cmluZyB0aGUgY29udGFpbmVyIHdpZHRoIC0gaXQgbWVhc3N1cmVzIG9ubHkgdGhlIHBhcmVudCBvZiB0aGUgY29udGFpbmVyLiAKICAgIC8vIFdoZW4gbGF5aW5nIG91dCB0aGUgaXRlbXMsIHRoZXNlIHZhbHVlcyBhcmUgdXNlZCwgc28gd2UgaGF2ZSB0byBzdWJzdHJhY3QgCiAgICAvLyB0aGVpciB3aWR0aCwgd2hlbiBjYWxjdWxhdGluZyB0aGUgY29sdW1uIHdpZHRoLgogICAgaWYgKHRoaXMub3B0aW9ucy5pc0ZpdFdpZHRoKSB7CiAgICAgIHRoaXMuY29udGFpbmVyV2lkdGggPSB0aGlzLmNvbnRhaW5lcldpZHRoIC0gKAogICAgICAgIHRoaXMuc2l6ZS5wYWRkaW5nTGVmdCArIHRoaXMuc2l6ZS5wYWRkaW5nUmlnaHQgKyAKICAgICAgICB0aGlzLnNpemUuYm9yZGVyTGVmdFdpZHRoICsgdGhpcy5zaXplLmJvcmRlclJpZ2h0V2lkdGgKICAgICAgKTsKICAgIH0KCiAgICAvLyBob3cgbWFueSBjb2x1bW5zPwogICAgdGhpcy5jb2xzID0gTWF0aC5mbG9vciggKCB0aGlzLmNvbnRhaW5lcldpZHRoICsgdGhpcy5ndXR0ZXIgKSAvIHRoaXMubWluQ29sdW1uV2lkdGggKTsKICAgIHRoaXMuY29scyA9IE1hdGgubWF4KCB0aGlzLmNvbHMsIDEgKTsKCiAgICAvLyBkbyB3ZSBoYXZlIG1vcmUgKG9yIGV2ZW4gbGVzcyBbPT4gcmVzdFdpZHRoIG5lZ2F0aXZdKSBzcGFjZT8KICAgIHZhciByZXN0V2lkdGggPSB0aGlzLmNvbnRhaW5lcldpZHRoICsgdGhpcy5ndXR0ZXIgLSB0aGlzLmNvbHMqdGhpcy5taW5Db2x1bW5XaWR0aDsKICAgIHZhciByZXN0V2lkdGhQZXJDb2x1bW4gPSByZXN0V2lkdGgvdGhpcy5jb2xzOwoKICAgIC8vIHdoYXQgdG8gZG8gd2l0aCB0aGUgcm91bmRpbmcgZXJyb3I/CiAgICAvLyB3ZSBhZGQgaXQgb24gdGhlIGxlZnQgYW5kIHJpZ2h0IHNpZGUgb2YgdGhlIGNvbnRhaW5lciAtIHVubGVzcyB3ZSBzZXJ2ZSBpc0ZpdFdpZHRoCiAgICB2YXIgcm91bmRpbmdFcnJvciA9IChyZXN0V2lkdGhQZXJDb2x1bW4gLSBNYXRoLmZsb29yKHJlc3RXaWR0aFBlckNvbHVtbikpKnRoaXMuY29sczsKICAgIHRoaXMuY2VudGVyaW5nT2Zmc2V0ID0gdGhpcy5vcHRpb25zLmlzRml0V2lkdGggPyAwIDogTWF0aC5yb3VuZChyb3VuZGluZ0Vycm9yLzIpOwoKICAgIHRoaXMuY29sdW1uV2lkdGggPSB0aGlzLm1pbkNvbHVtbldpZHRoICsgTWF0aC5mbG9vcihyZXN0V2lkdGhQZXJDb2x1bW4pOwogICAgdGhpcy5jb2x1bW5XaWR0aElubmVyID0gdGhpcy5jb2x1bW5XaWR0aCAtIHRoaXMuZ3V0dGVyOwogIH07CgogIC8vIENhbGN1bGF0ZSBhbmQgc2V0IHdpZHRoIG9mIGV2ZXJ5IGl0ZW0sIHRoZW4gZG8gdGhlIG1hc29ucnkgbGF5b3V0IHBvcyBtYXRoLgogIC8vIFlvdSBjYW4gc3BhbiBhIGl0ZW0gb3ZlciBtb3JlIGNvbHVtbnMgd2l0aCB0aGUgZGF0YS1jb2x1bW5zIGF0dHJpYnV0ZS4KICBGbHVpZE1hc29ucnkucHJvdG90eXBlLl9nZXRJdGVtTGF5b3V0UG9zaXRpb24gPSBmdW5jdGlvbiggaXRlbSApIHsKICAgIC8vIGNhbGN1bGF0ZSB3aWR0aCBvZiBlYWNoIGl0ZW0gZWxlbWVudAogICAgdmFyIHdpZHRoID0gdGhpcy5jb2x1bW5XaWR0aElubmVyOwogICAgLy8gY2hlY2sgaWYgZWxlbWVudCBzaG91bGQgc3BhbiBtb3JlIHRoYW4gb25lIGNvbHVtbgogICAgdmFyIGNvbFNwYW4gPSBpdGVtLmVsZW1lbnQuZ2V0QXR0cmlidXRlKCdkYXRhLWNvbHVtbnMnKTsKICAgIGlmIChjb2xTcGFuID4gMSkgewogICAgICBjb2xTcGFuID0gTWF0aC5taW4oY29sU3BhbiwgdGhpcy5jb2xzKTsKICAgICAgd2lkdGggPSB3aWR0aCpjb2xTcGFuICsgKGNvbFNwYW4tMSkqdGhpcy5ndXR0ZXI7CiAgICB9IGVsc2UgewogICAgICBjb2xTcGFuID0gMTsKICAgIH0KICAgIC8vIHNldCB3aWR0aCBvZiBlbGVtZW50CiAgICBpdGVtLmVsZW1lbnQuc3R5bGUud2lkdGggPSB3aWR0aCArICdweCc7CgogICAgLyogdGhlIHJlc3Qgb2YgdGhlIG1ldGhvZCBpcyByb2JiZWQgYW5kIG5vdCBvdmVycmlkZGVuIGZyb20gdGhlIG9yaWdpbmFsIAogICAgICAgbWFzb25yeSBtZXRob2QgX2dldEl0ZW1MYXlvdXRQb3NpdGlvbiBmb3IgcGVyZm9ybWFuY2UgcmVhc29ucy4gY2F1c2UgZWxzZSAKICAgICAgIHRoZSBjb2xzcGFuIGlzIGNhbGN1bGF0ZWQgdHdpY2UgZm9yIGV2ZXJ5IGl0ZW0gKi8KCiAgICAvLyBjYWxjdWxhdGUgaXRlbSBzaXplCiAgICBpdGVtLmdldFNpemUoKTsKCiAgICB2YXIgY29sR3JvdXAgPSB0aGlzLl9nZXRDb2xHcm91cCggY29sU3BhbiApOwogICAgLy8gZ2V0IHRoZSBtaW5pbXVtIFkgdmFsdWUgZnJvbSB0aGUgY29sdW1ucwogICAgdmFyIG1pbmltdW1ZID0gTWF0aC5taW4uYXBwbHkoIE1hdGgsIGNvbEdyb3VwICk7CiAgICB2YXIgc2hvcnRDb2xJbmRleCA9IGluZGV4T2YoIGNvbEdyb3VwLCBtaW5pbXVtWSApOwoKICAgIC8vIHBvc2l0aW9uIHRoZSBicmljawogICAgdmFyIHBvc2l0aW9uID0gewogICAgICB4OiB0aGlzLmNvbHVtbldpZHRoICogc2hvcnRDb2xJbmRleCArIHRoaXMuY2VudGVyaW5nT2Zmc2V0LAogICAgICB5OiBtaW5pbXVtWQogICAgfTsKCiAgICAvLyBhcHBseSBzZXRIZWlnaHQgdG8gbmVjZXNzYXJ5IGNvbHVtbnMKICAgIHZhciBzZXRIZWlnaHQgPSBtaW5pbXVtWSArIGl0ZW0uc2l6ZS5vdXRlckhlaWdodDsKICAgIHZhciBzZXRTcGFuID0gdGhpcy5jb2xzICsgMSAtIGNvbEdyb3VwLmxlbmd0aDsKICAgIGZvciAoIHZhciBpID0gMDsgaSA8IHNldFNwYW47IGkrKyApIHsKICAgICAgdGhpcy5jb2xZc1sgc2hvcnRDb2xJbmRleCArIGkgXSA9IHNldEhlaWdodDsKICAgIH0KCiAgICByZXR1cm4gcG9zaXRpb247CiAgfTsKCiAgRmx1aWRNYXNvbnJ5LnByb3RvdHlwZS5fcmVzZXRMYXlvdXQgPSBNYXNvbnJ5LnByb3RvdHlwZS5fcmVzZXRMYXlvdXQ7CiAgRmx1aWRNYXNvbnJ5LnByb3RvdHlwZS5nZXRDb250YWluZXJXaWR0aCA9IE1hc29ucnkucHJvdG90eXBlLmdldENvbnRhaW5lcldpZHRoOwogIEZsdWlkTWFzb25yeS5wcm90b3R5cGUuX2dldENvbEdyb3VwID0gTWFzb25yeS5wcm90b3R5cGUuX2dldENvbEdyb3VwOwogIEZsdWlkTWFzb25yeS5wcm90b3R5cGUuX21hbmFnZVN0YW1wID0gTWFzb25yeS5wcm90b3R5cGUuX21hbmFnZVN0YW1wOwogIEZsdWlkTWFzb25yeS5wcm90b3R5cGUuX2dldENvbnRhaW5lclNpemUgPSBNYXNvbnJ5LnByb3RvdHlwZS5fZ2V0Q29udGFpbmVyU2l6ZTsKICBGbHVpZE1hc29ucnkucHJvdG90eXBlLl9nZXRDb250YWluZXJGaXRXaWR0aCA9IE1hc29ucnkucHJvdG90eXBlLl9nZXRDb250YWluZXJGaXRXaWR0aDsKICBGbHVpZE1hc29ucnkucHJvdG90eXBlLm5lZWRzUmVzaXplTGF5b3V0ID0gTWFzb25yeS5wcm90b3R5cGUubmVlZHNSZXNpemVMYXlvdXQ7CgogIHJldHVybiBGbHVpZE1hc29ucnk7Cn0KCi8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tIHRyYW5zcG9ydCAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSAvLwoKaWYgKCB0eXBlb2YgZGVmaW5lID09PSAnZnVuY3Rpb24nICYmIGRlZmluZS5hbWQgKSB7CiAgLy8gQU1ECiAgZGVmaW5lKCAnZmx1aWQtbWFzb25yeScsWwogICAgICAnb3V0bGF5ZXIvb3V0bGF5ZXInLAogICAgICAnbWFzb25yeS9tYXNvbnJ5JwogICAgXSwKICAgIGZsdWlkTWFzb25yeURlZmluaXRpb24gKTsKfSBlbHNlIHsKICAvLyBicm93c2VyIGdsb2JhbAogIHdpbmRvdy5GbHVpZE1hc29ucnkgPSBmbHVpZE1hc29ucnlEZWZpbml0aW9uKAogICAgd2luZG93Lk91dGxheWVyLAogICAgd2luZG93Lk1hc29ucnkKICApOwp9Cgp9KSggd2luZG93ICk7CgovKgogKiBqUXVlcnkgdGhyb3R0bGUgLyBkZWJvdW5jZSAtIHYxLjEgLSAzLzcvMjAxMAogKiBodHRwOi8vYmVuYWxtYW4uY29tL3Byb2plY3RzL2pxdWVyeS10aHJvdHRsZS1kZWJvdW5jZS1wbHVnaW4vCiAqIAogKiBDb3B5cmlnaHQgKGMpIDIwMTAgIkNvd2JveSIgQmVuIEFsbWFuCiAqIER1YWwgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBhbmQgR1BMIGxpY2Vuc2VzLgogKiBodHRwOi8vYmVuYWxtYW4uY29tL2Fib3V0L2xpY2Vuc2UvCiAqLwooZnVuY3Rpb24oYixjKXt2YXIgJD1iLmpRdWVyeXx8Yi5Db3dib3l8fChiLkNvd2JveT17fSksYTskLnRocm90dGxlPWE9ZnVuY3Rpb24oZSxmLGosaSl7dmFyIGgsZD0wO2lmKHR5cGVvZiBmIT09ImJvb2xlYW4iKXtpPWo7aj1mO2Y9Y31mdW5jdGlvbiBnKCl7dmFyIG89dGhpcyxtPStuZXcgRGF0ZSgpLWQsbj1hcmd1bWVudHM7ZnVuY3Rpb24gbCgpe2Q9K25ldyBEYXRlKCk7ai5hcHBseShvLG4pfWZ1bmN0aW9uIGsoKXtoPWN9aWYoaSYmIWgpe2woKX1oJiZjbGVhclRpbWVvdXQoaCk7aWYoaT09PWMmJm0+ZSl7bCgpfWVsc2V7aWYoZiE9PXRydWUpe2g9c2V0VGltZW91dChpP2s6bCxpPT09Yz9lLW06ZSl9fX1pZigkLmd1aWQpe2cuZ3VpZD1qLmd1aWQ9ai5ndWlkfHwkLmd1aWQrK31yZXR1cm4gZ307JC5kZWJvdW5jZT1mdW5jdGlvbihkLGUsZil7cmV0dXJuIGY9PT1jP2EoZCxlLGZhbHNlKTphKGQsZixlIT09ZmFsc2UpfX0pKHRoaXMpOwpkZWZpbmUoInZlbmRvci9qcXVlcnkudGhyb3R0bGUtZGVib3VuY2UiLCBmdW5jdGlvbigpe30pOwoKLyoKKiBAZmlsZU92ZXJ2aWV3IFRvdWNoU3dpcGUgLSBqUXVlcnkgUGx1Z2luCiogQHZlcnNpb24gMS42LjYKKgoqIEBhdXRob3IgTWF0dCBCcnlzb24gaHR0cDovL3d3dy5naXRodWIuY29tL21hdHRicnlzb24KKiBAc2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9tYXR0YnJ5c29uL1RvdWNoU3dpcGUtSnF1ZXJ5LVBsdWdpbgoqIEBzZWUgaHR0cDovL2xhYnMuc2tpbmtlcnMuY29tL3RvdWNoU3dpcGUvCiogQHNlZSBodHRwOi8vcGx1Z2lucy5qcXVlcnkuY29tL3Byb2plY3QvdG91Y2hTd2lwZQoqCiogQ29weXJpZ2h0IChjKSAyMDEwIE1hdHQgQnJ5c29uCiogRHVhbCBsaWNlbnNlZCB1bmRlciB0aGUgTUlUIG9yIEdQTCBWZXJzaW9uIDIgbGljZW5zZXMuCioKKi8KCi8qCioKKiBDaGFuZ2Vsb2cKKiAkRGF0ZTogMjAxMC0xMi0xMiAoV2VkLCAxMiBEZWMgMjAxMCkgJAoqICR2ZXJzaW9uOiAxLjAuMAoqICR2ZXJzaW9uOiAxLjAuMSAtIHJlbW92ZWQgbXVsdGlieXRlIGNvbW1lbnRzCioKKiAkRGF0ZTogMjAxMS0yMS0wMiAoTW9uLCAyMSBGZWIgMjAxMSkgJAoqICR2ZXJzaW9uOiAxLjEuMCAJLSBhZGRlZCBhbGxvd1BhZ2VTY3JvbGwgcHJvcGVydHkgdG8gYWxsb3cgc3dpcGluZyBhbmQgc2Nyb2xsaW5nIG9mIHBhZ2UKKgkJCQkJLSBjaGFuZ2VkIGhhbmRsZXIgc2lnbmF0dXJlcyBzbyBvbmUgaGFuZGxlciBjYW4gYmUgdXNlZCBmb3IgbXVsdGlwbGUgZXZlbnRzCiogJERhdGU6IDIwMTEtMjMtMDIgKFdlZCwgMjMgRmViIDIwMTEpICQKKiAkdmVyc2lvbjogMS4yLjAgCS0gYWRkZWQgY2xpY2sgaGFuZGxlci4gVGhpcyBpcyBmaXJlZCBpZiB0aGUgdXNlciBzaW1wbHkgY2xpY2tzIGFuZCBkb2VzIG5vdCBzd2lwZS4gVGhlIGV2ZW50IG9iamVjdCBhbmQgY2xpY2sgdGFyZ2V0IGFyZSBwYXNzZWQgdG8gaGFuZGxlci4KKgkJCQkJLSBJZiB5b3UgdXNlIHRoZSBodHRwOi8vY29kZS5nb29nbGUuY29tL3AvanF1ZXJ5LXVpLWZvci1pcGFkLWFuZC1pcGhvbmUvIHBsdWdpbiwgeW91IGNhbiBhbHNvIGFzc2lnbiBqUXVlcnkgbW91c2UgZXZlbnRzIHRvIGNoaWxkcmVuIG9mIGEgdG91Y2hTd2lwZSBvYmplY3QuCiogJHZlcnNpb246IDEuMi4xIAktIHJlbW92ZWQgY29uc29sZSBsb2chCioKKiAkdmVyc2lvbjogMS4yLjIgCS0gRml4ZWQgYnVnIHdoZXJlIHNjb3BlIHdhcyBub3QgcHJlc2VydmVkIGluIGNhbGxiYWNrIG1ldGhvZHMuCioKKiAkRGF0ZTogMjAxMS0yOC0wNCAoVGh1cnMsIDI4IEFwcmlsIDIwMTEpICQKKiAkdmVyc2lvbjogMS4yLjQgCS0gQ2hhbmdlZCBsaWNlbmNlIHRlcm1zIHRvIGJlIE1JVCBvciBHUEwgaW5saW5lIHdpdGggalF1ZXJ5LiBBZGRlZCBjaGVjayBmb3Igc3VwcG9ydCBvZiB0b3VjaCBldmVudHMgdG8gc3RvcCBub24gY29tcGF0aWJsZSBicm93c2VycyBlcnJvcmluZy4KKgoqICREYXRlOiAyMDExLTI3LTA5IChUdWVzLCAyNyBTZXB0ZW1iZXIgMjAxMSkgJAoqICR2ZXJzaW9uOiAxLjIuNSAJLSBBZGRlZCBzdXBwb3J0IGZvciB0ZXN0aW5nIHN3aXBlcyB3aXRoIG1vdXNlIG9uIGRlc2t0b3AgYnJvd3NlciAodGhhbmtzIHRvIGh0dHBzOi8vZ2l0aHViLmNvbS9qb2VsaHkpCioKKiAkRGF0ZTogMjAxMi0xNC0wNSAoTW9uLCAxNCBNYXkgMjAxMikgJAoqICR2ZXJzaW9uOiAxLjIuNiAJLSBBZGRlZCB0aW1lVGhyZXNob2xkIGJldHdlZW4gc3RhcnQgYW5kIGVuZCB0b3VjaCwgc28gdXNlciBjYW4gaWdub3JlIHNsb3cgc3dpcGVzICh0aGFua3MgdG8gTWFyayBDaGFzZSkuIERlZmF1bHQgaXMgbnVsbCwgYWxsIHN3aXBlcyBhcmUgZGV0ZWN0ZWQKKgoqICREYXRlOiAyMDEyLTA1LTA2IChUdWVzLCAwNSBKdW5lIDIwMTIpICQKKiAkdmVyc2lvbjogMS4yLjcgCS0gQ2hhbmdlZCB0aW1lIHRocmVzaG9sZCB0byBoYXZlIG51bGwgZGVmYXVsdCBmb3IgYmFja3dhcmRzIGNvbXBhdGliaWxpdHkuIEFkZGVkIGR1cmF0aW9uIHBhcmFtIHBhc3NlZCBiYWNrIGluIGV2ZW50cywgYW5kIHJlZmFjdG9yZWQgaG93IHRpbWUgaXMgaGFuZGxlZC4KKgoqICREYXRlOiAyMDEyLTA1LTA2IChUdWVzLCAwNSBKdW5lIDIwMTIpICQKKiAkdmVyc2lvbjogMS4yLjggCS0gQWRkZWQgdGhlIHBvc3NpYmlsaXR5IHRvIHJldHVybiBhIHZhbHVlIGxpa2UgbnVsbCBvciBmYWxzZSBpbiB0aGUgdHJpZ2dlciBjYWxsYmFjay4gSW4gdGhhdCB3YXkgd2UgY2FuIGNvbnRyb2wgd2hlbiB0aGUgdG91Y2ggc3RhcnQvbW92ZSBzaG91bGQgdGFrZSBlZmZlY3Qgb3Igbm90IChzaW1wbHkgYnkgcmV0dXJuaW5nIGluIHNvbWUgY2FzZXMgcmV0dXJuIG51bGw7IG9yIHJldHVybiBmYWxzZTspIFRoaXMgZWZmZWN0cyB0aGUgb250b3VjaHN0YXJ0L29udG91Y2htb3ZlIGV2ZW50LgoqCiogJERhdGU6IDIwMTItMDYtMDYgKFdlZCwgMDYgSnVuZSAyMDEyKSAkCiogJHZlcnNpb246IDEuMy4wIAktIFJlZmFjdG9yZWQgd2hvbGUgcGx1Z2luIHRvIGFsbG93IGZvciBtZXRob2RzIHRvIGJlIGV4ZWN1dGVkLCBhcyB3ZWxsIGFzIGV4cG9zZWQgZGVmYXVsdHMgZm9yIHVzZXIgb3ZlcnJpZGUuIEFkZGVkICdlbmFibGUnLCAnZGlzYWJsZScsIGFuZCAnZGVzdHJveScgbWV0aG9kcwoqCiogJERhdGU6IDIwMTItMDUtMDYgKEZyaSwgMDUgSnVuZSAyMDEyKSAkCiogJHZlcnNpb246IDEuMy4xIAktIEJ1ZyBmaXhlcyAgLSBiaW5kKCkgd2l0aCBmYWxzZSBhcyBsYXN0IGFyZ3VtZW50IGlzIG5vIGxvbmdlciBzdXBwb3J0ZWQgaW4galF1ZXJ5IDEuNiwgYWxzbywgaWYgeW91IGp1c3QgY2xpY2ssIHRoZSBkdXJhdGlvbiBpcyBub3cgcmV0dXJuZWQgY29ycmVjdGx5LgoqCiogJERhdGU6IDIwMTItMjktMDcgKFN1biwgMjkgSnVseSAyMDEyKSAkCiogJHZlcnNpb246IDEuMy4yCS0gQWRkZWQgZmFsbGJhY2tUb01vdXNlRXZlbnRzIG9wdGlvbiB0byBOT1QgY2FwdHVyZSBtb3VzZSBldmVudHMgb24gbm9uIHRvdWNoIGRldmljZXMuCiogCQkJLSBBZGRlZCAiYWxsIiBmaW5nZXJzIHZhbHVlIHRvIHRoZSBmaW5nZXJzIHByb3BlcnR5LCBzbyBhbnkgY29tYmluYXRpb24gb2YgZmluZ2VycyB0cmlnZ2VycyB0aGUgc3dpcGUsIGFsbG93aW5nIGV2ZW50IGhhbmRsZXJzIHRvIGNoZWNrIHRoZSBmaW5nZXIgY291bnQKKgoqICREYXRlOiAyMDEyLTA5LTA4IChUaHVycywgOSBBdWcgMjAxMikgJAoqICR2ZXJzaW9uOiAxLjMuMwktIENvZGUgdGlkeSBwcmVwIGZvciBtaW5lZmllZCB2ZXJzaW9uCioKKiAkRGF0ZTogMjAxMi0wNC0xMCAod2VkLCA0IE9jdCAyMDEyKSAkCiogJHZlcnNpb246IDEuNC4wCS0gQWRkZWQgcGluY2ggc3VwcG9ydCwgcGluY2hJbiBhbmQgcGluY2hPdXQKKgoqICREYXRlOiAyMDEyLTExLTEwIChUaHVycywgMTEgT2N0IDIwMTIpICQKKiAkdmVyc2lvbjogMS41LjAJLSBBZGRlZCBleGNsdWRlZEVsZW1lbnRzLCBhIGpxdWVyeSBzZWxlY3RvciB0aGF0IHNwZWNpZmllcyBjaGlsZCBlbGVtZW50cyB0aGF0IGRvIE5PVCB0cmlnZ2VyIHN3aXBlcy4gQnkgZGVmYXVsdCwgdGhpcyBpcyBvbmUgc2VsZWN0IHRoYXQgcmVtb3ZlcyBhbGwgZm9ybSwgaW5wdXQgc2VsZWN0LCBidXR0b24gYW5kIGFuY2hvciBlbGVtZW50cy4KKgoqICREYXRlOiAyMDEyLTIyLTEwIChNb24sIDIyIE9jdCAyMDEyKSAkCiogJHZlcnNpb246IDEuNS4xCS0gRml4ZWQgYnVnIHdpdGggalF1ZXJ5IDEuOCBhbmQgdHJhaWxpbmcgY29tbWEgaW4gZXhjbHVkZWRFbGVtZW50cwoqCQkJCQktIEZpeGVkIGJ1ZyB3aXRoIElFIGFuZCBldmVudFByZXZlbnREZWZhdWx0KCkKKiAkRGF0ZTogMjAxMy0wMS0xMiAoRnJpLCAxMiBKYW4gMjAxMykgJAoqICR2ZXJzaW9uOiAxLjYuMAktIEZpeGVkIGJ1Z3Mgd2l0aCBwaW5jaGluZywgbWFpbmx5IHdoZW4gYm90aCBwaW5jaCBhbmQgc3dpcGUgZW5hYmxlZCwgYXMgd2VsbCBhcyBhZGRpbmcgdGltZSB0aHJlc2hvbGQgZm9yIG11bHRpZmluZ2VyIGdlc3R1cmVzLCBzbyByZWxlYXNpbmcgb25lIGZpbmdlciBiZW9mcmUgdGhlIG90aGVyIGRvZXNudCB0cmlnZ2VyIGFzIHNpbmdsZSBmaW5nZXIgZ2VzdHVyZS4KKgkJCQkJLSBtYWRlIHRoZSBkZW1vIHNpdGUgYWxsIHN0YXRpYyBsb2NhbCBIVE1MIHBhZ2VzIHNvIHRoZXkgY2FuIGJlIHJ1biBsb2NhbGx5IGJ5IGEgZGV2ZWxvcGVyCioJCQkJCS0gYWRkZWQganNEb2MgY29tbWVudHMgYW5kIGFkZGVkIGRvY3VtZW50YXRpb24gZm9yIHRoZSBwbHVnaW4JCioJCQkJCS0gY29kZSB0aWR5CioJCQkJCS0gYWRkZWQgdHJpZ2dlck9uVG91Y2hMZWF2ZSBwcm9wZXJ0eSB0aGF0IHdpbGwgZW5kIHRoZSBldmVudCB3aGVuIHRoZSB1c2VyIHN3aXBlcyBvZmYgdGhlIGVsZW1lbnQuCiogJERhdGU6IDIwMTMtMDMtMjMgKFNhdCwgMjMgTWFyIDIwMTMpICQKKiAkdmVyc2lvbjogMS42LjEJLSBBZGRlZCBzdXBwb3J0IGZvciBpZTggdG91Y2ggZXZlbnRzCiogJHZlcnNpb246IDEuNi4yCS0gQWRkZWQgc3VwcG9ydCBmb3IgZXZlbnRzIGJpbmRpbmcgd2l0aCBvbiAvIG9mZiAvIGJpbmQgaW4galEgZm9yIGFsbCBjYWxsYmFjayBuYW1lcy4KKiAgICAgICAgICAgICAgICAgICAtIERlcHJlY2F0ZWQgdGhlICdjbGljaycgaGFuZGxlciBpbiBmYXZvdXIgb2YgdGFwLgoqICAgICAgICAgICAgICAgICAgIC0gYWRkZWQgY2FuY2VsVGhyZXNob2xkIHByb3BlcnR5CiogICAgICAgICAgICAgICAgICAgLSBhZGRlZCBvcHRpb24gbWV0aG9kIHRvIHVwZGF0ZSBpbml0IG9wdGlvbnMgYXQgcnVudGltZQoqICR2ZXJzaW9uIDEuNi4zICAgIC0gYWRkZWQgZG91YmxldGFwLCBsb25ndGFwIGV2ZW50cyBhbmQgbG9uZ1RhcFRocmVzaG9sZCwgZG91YmxlVGFwVGhyZXNob2xkIHByb3BlcnR5CioKKiAkRGF0ZTogMjAxMy0wNC0wNCAoVGh1cnMsIDA0IEFwcmlsIDIwMTMpICQKKiAkdmVyc2lvbiAxLjYuNCAgICAtIEZpeGVkIGJ1ZyB3aXRoIGNhbmNlbFRocmVzaG9sZCBpbnRyb2R1Y2VkIGluIDEuNi4zLCB3aGVyZSBzd2lwZSBzdGF0dXMgbm8gbG9uZ2VyIGZpcmVkIHN0YXJ0IGV2ZW50LCBhbmQgc3RvcHBlZCBvbmNlIHN3aXBpbmcgYmFjay4KKgoqICREYXRlOiAyMDEzLTA4LTI0IChTYXQsIDI0IEF1ZyAyMDEzKSAkCiogJHZlcnNpb24gMS42LjUgICAgLSBNZXJnZWQgYSBmZXcgcHVsbCByZXF1ZXN0cyBmaXhpbmcgdmFyaW91cyBidWdzLCBhZGRlZCBBTUQgc3VwcG9ydC4KKgoqICREYXRlOiAyMDE0LTA2LTA0IChXZWQsIDA0IEp1bmUgMjAxNCkgJAoqICR2ZXJzaW9uIDEuNi42IAktIE1lcmdlIG9mIHB1bGwgcmVxdWVzdHMuCiogICAgCQkJCS0gSUUxMCB0b3VjaCBzdXBwb3J0IAoqICAgIAkJCQktIE9ubHkgcHJldmVudCBkZWZhdWx0IGV2ZW50IGhhbmRsaW5nIG9uIHZhbGlkIHN3aXBlCiogICAgCQkJCS0gU2VwYXJhdGUgbGljZW5zZS9jaGFuZ2Vsb2cgY29tbWVudAoqICAgIAkJCQktIERldGVjdCBpZiB0aGUgc3dpcGUgaXMgdmFsaWQgYXQgdGhlIGVuZCBvZiB0aGUgdG91Y2ggZXZlbnQuCiogICAgCQkJCS0gUGFzcyBmaW5nZXJkYXRhIHRvIGV2ZW50IGhhbmRsZXJzLiAKKiAgICAJCQkJLSBBZGQgJ2hvbGQnIGdlc3R1cmUgCiogICAgCQkJCS0gQmUgbW9yZSB0b2xlcmFudCBhYm91dCB0aGUgdGFwIGRpc3RhbmNlCiogICAgCQkJCS0gVHlwb3MgYW5kIG1pbm9yIGZpeGVzCiovCgovKioKICogU2VlIChodHRwOi8vanF1ZXJ5LmNvbS8pLgogKiBAbmFtZSAkCiAqIEBjbGFzcyAKICogU2VlIHRoZSBqUXVlcnkgTGlicmFyeSAgKGh0dHA6Ly9qcXVlcnkuY29tLykgZm9yIGZ1bGwgZGV0YWlscy4gIFRoaXMganVzdAogKiBkb2N1bWVudHMgdGhlIGZ1bmN0aW9uIGFuZCBjbGFzc2VzIHRoYXQgYXJlIGFkZGVkIHRvIGpRdWVyeSBieSB0aGlzIHBsdWctaW4uCiAqLwogCi8qKgogKiBTZWUgKGh0dHA6Ly9qcXVlcnkuY29tLykKICogQG5hbWUgZm4KICogQGNsYXNzIAogKiBTZWUgdGhlIGpRdWVyeSBMaWJyYXJ5ICAoaHR0cDovL2pxdWVyeS5jb20vKSBmb3IgZnVsbCBkZXRhaWxzLiAgVGhpcyBqdXN0CiAqIGRvY3VtZW50cyB0aGUgZnVuY3Rpb24gYW5kIGNsYXNzZXMgdGhhdCBhcmUgYWRkZWQgdG8galF1ZXJ5IGJ5IHRoaXMgcGx1Zy1pbi4KICogQG1lbWJlck9mICQKICovCgoKCihmdW5jdGlvbiAoZmFjdG9yeSkgewogICAgaWYgKHR5cGVvZiBkZWZpbmUgPT09ICdmdW5jdGlvbicgJiYgZGVmaW5lLmFtZCAmJiBkZWZpbmUuYW1kLmpRdWVyeSkgewogICAgICAgIC8vIEFNRC4gUmVnaXN0ZXIgYXMgYW5vbnltb3VzIG1vZHVsZS4KICAgICAgICBkZWZpbmUoJ2pxdWVyeS10b3VjaHN3aXBlJyxbJ2pxdWVyeSddLCBmYWN0b3J5KTsKICAgIH0gZWxzZSB7CiAgICAgICAgLy8gQnJvd3NlciBnbG9iYWxzLgogICAgICAgIGZhY3RvcnkoalF1ZXJ5KTsKICAgIH0KfShmdW5jdGlvbiAoJCkgewoJCgoJLy9Db25zdGFudHMKCXZhciBMRUZUID0gImxlZnQiLAoJCVJJR0hUID0gInJpZ2h0IiwKCQlVUCA9ICJ1cCIsCgkJRE9XTiA9ICJkb3duIiwKCQlJTiA9ICJpbiIsCgkJT1VUID0gIm91dCIsCgoJCU5PTkUgPSAibm9uZSIsCgkJQVVUTyA9ICJhdXRvIiwKCQkKCQlTV0lQRSA9ICJzd2lwZSIsCgkJUElOQ0ggPSAicGluY2giLAoJCVRBUCA9ICJ0YXAiLAoJCURPVUJMRV9UQVAgPSAiZG91YmxldGFwIiwKCQlMT05HX1RBUCA9ICJsb25ndGFwIiwKCQlIT0xEID0gImhvbGQiLAoJCQoJCUhPUklaT05UQUwgPSAiaG9yaXpvbnRhbCIsCgkJVkVSVElDQUwgPSAidmVydGljYWwiLAoKCQlBTExfRklOR0VSUyA9ICJhbGwiLAoJCQoJCURPVUJMRV9UQVBfVEhSRVNIT0xEID0gMTAsCgoJCVBIQVNFX1NUQVJUID0gInN0YXJ0IiwKCQlQSEFTRV9NT1ZFID0gIm1vdmUiLAoJCVBIQVNFX0VORCA9ICJlbmQiLAoJCVBIQVNFX0NBTkNFTCA9ICJjYW5jZWwiLAoKCQlTVVBQT1JUU19UT1VDSCA9ICdvbnRvdWNoc3RhcnQnIGluIHdpbmRvdywKCQkKCQlTVVBQT1JUU19QT0lOVEVSX0lFMTAgPSB3aW5kb3cubmF2aWdhdG9yLm1zUG9pbnRlckVuYWJsZWQgJiYgIXdpbmRvdy5uYXZpZ2F0b3IucG9pbnRlckVuYWJsZWQsCgkJCgkJU1VQUE9SVFNfUE9JTlRFUiA9IHdpbmRvdy5uYXZpZ2F0b3IucG9pbnRlckVuYWJsZWQgfHwgd2luZG93Lm5hdmlnYXRvci5tc1BvaW50ZXJFbmFibGVkLAoKCQlQTFVHSU5fTlMgPSAnVG91Y2hTd2lwZSc7CgoKCgkvKioKCSogVGhlIGRlZmF1bHQgY29uZmlndXJhdGlvbiwgYW5kIGF2YWlsYWJsZSBvcHRpb25zIHRvIGNvbmZpZ3VyZSB0b3VjaCBzd2lwZSB3aXRoLgoJKiBZb3UgY2FuIHNldCB0aGUgZGVmYXVsdCB2YWx1ZXMgYnkgdXBkYXRpbmcgYW55IG9mIHRoZSBwcm9wZXJ0aWVzIHByaW9yIHRvIGluc3RhbnRpYXRpb24uCgkqIEBuYW1lICQuZm4uc3dpcGUuZGVmYXVsdHMKCSogQG5hbWVzcGFjZQoJKiBAcHJvcGVydHkge2ludH0gW2ZpbmdlcnM9MV0gVGhlIG51bWJlciBvZiBmaW5nZXJzIHRvIGRldGVjdCBpbiBhIHN3aXBlLiBBbnkgc3dpcGVzIHRoYXQgZG8gbm90IG1lZXQgdGhpcyByZXF1aXJlbWVudCB3aWxsIE5PVCB0cmlnZ2VyIHN3aXBlIGhhbmRsZXJzLgoJKiBAcHJvcGVydHkge2ludH0gW3RocmVzaG9sZD03NV0gVGhlIG51bWJlciBvZiBwaXhlbHMgdGhhdCB0aGUgdXNlciBtdXN0IG1vdmUgdGhlaXIgZmluZ2VyIGJ5IGJlZm9yZSBpdCBpcyBjb25zaWRlcmVkIGEgc3dpcGUuIAoJKiBAcHJvcGVydHkge2ludH0gW2NhbmNlbFRocmVzaG9sZD1udWxsXSBUaGUgbnVtYmVyIG9mIHBpeGVscyB0aGF0IHRoZSB1c2VyIG11c3QgbW92ZSB0aGVpciBmaW5nZXIgYmFjayBmcm9tIHRoZSBvcmlnaW5hbCBzd2lwZSBkaXJlY3Rpb24gdG8gY2FuY2VsIHRoZSBnZXN0dXJlLgoJKiBAcHJvcGVydHkge2ludH0gW3BpbmNoVGhyZXNob2xkPTIwXSBUaGUgbnVtYmVyIG9mIHBpeGVscyB0aGF0IHRoZSB1c2VyIG11c3QgcGluY2ggdGhlaXIgZmluZ2VyIGJ5IGJlZm9yZSBpdCBpcyBjb25zaWRlcmVkIGEgcGluY2guIAoJKiBAcHJvcGVydHkge2ludH0gW21heFRpbWVUaHJlc2hvbGQ9bnVsbF0gVGltZSwgaW4gbWlsbGlzZWNvbmRzLCBiZXR3ZWVuIHRvdWNoU3RhcnQgYW5kIHRvdWNoRW5kIG11c3QgTk9UIGV4Y2VlZCBpbiBvcmRlciB0byBiZSBjb25zaWRlcmVkIGEgc3dpcGUuIAoJKiBAcHJvcGVydHkge2ludH0gW2ZpbmdlclJlbGVhc2VUaHJlc2hvbGQ9MjUwXSBUaW1lIGluIG1pbGxpc2Vjb25kcyBiZXR3ZWVuIHJlbGVhc2luZyBtdWx0aXBsZSBmaW5nZXJzLiAgSWYgMiBmaW5nZXJzIGFyZSBkb3duLCBhbmQgYXJlIHJlbGVhc2VkIG9uZSBhZnRlciB0aGUgb3RoZXIsIGlmIHRoZXkgYXJlIHdpdGhpbiB0aGlzIHRocmVzaG9sZCwgaXQgY291bnRzIGFzIGEgc2ltdWx0YW5lb3VzIHJlbGVhc2UuIAoJKiBAcHJvcGVydHkge2ludH0gW2xvbmdUYXBUaHJlc2hvbGQ9NTAwXSBUaW1lIGluIG1pbGxpc2Vjb25kcyBiZXR3ZWVuIHRhcCBhbmQgcmVsZWFzZSBmb3IgYSBsb25nIHRhcAoJKiBAcHJvcGVydHkge2ludH0gW2RvdWJsZVRhcFRocmVzaG9sZD0yMDBdIFRpbWUgaW4gbWlsbGlzZWNvbmRzIGJldHdlZW4gMiB0YXBzIHRvIGNvdW50IGFzIGEgZG91YmxlIHRhcAoJKiBAcHJvcGVydHkge2Z1bmN0aW9ufSBbc3dpcGU9bnVsbF0gQSBoYW5kbGVyIHRvIGNhdGNoIGFsbCBzd2lwZXMuIFNlZSB7QGxpbmsgJC5mbi5zd2lwZSNldmVudDpzd2lwZX0KCSogQHByb3BlcnR5IHtmdW5jdGlvbn0gW3N3aXBlTGVmdD1udWxsXSBBIGhhbmRsZXIgdGhhdCBpcyB0cmlnZ2VyZWQgZm9yICJsZWZ0IiBzd2lwZXMuIFNlZSB7QGxpbmsgJC5mbi5zd2lwZSNldmVudDpzd2lwZUxlZnR9CgkqIEBwcm9wZXJ0eSB7ZnVuY3Rpb259IFtzd2lwZVJpZ2h0PW51bGxdIEEgaGFuZGxlciB0aGF0IGlzIHRyaWdnZXJlZCBmb3IgInJpZ2h0IiBzd2lwZXMuIFNlZSB7QGxpbmsgJC5mbi5zd2lwZSNldmVudDpzd2lwZVJpZ2h0fQoJKiBAcHJvcGVydHkge2Z1bmN0aW9ufSBbc3dpcGVVcD1udWxsXSBBIGhhbmRsZXIgdGhhdCBpcyB0cmlnZ2VyZWQgZm9yICJ1cCIgc3dpcGVzLiBTZWUge0BsaW5rICQuZm4uc3dpcGUjZXZlbnQ6c3dpcGVVcH0KCSogQHByb3BlcnR5IHtmdW5jdGlvbn0gW3N3aXBlRG93bj1udWxsXSBBIGhhbmRsZXIgdGhhdCBpcyB0cmlnZ2VyZWQgZm9yICJkb3duIiBzd2lwZXMuIFNlZSB7QGxpbmsgJC5mbi5zd2lwZSNldmVudDpzd2lwZURvd259CgkqIEBwcm9wZXJ0eSB7ZnVuY3Rpb259IFtzd2lwZVN0YXR1cz1udWxsXSBBIGhhbmRsZXIgdHJpZ2dlcmVkIGZvciBldmVyeSBwaGFzZSBvZiB0aGUgc3dpcGUuIFNlZSB7QGxpbmsgJC5mbi5zd2lwZSNldmVudDpzd2lwZVN0YXR1c30KCSogQHByb3BlcnR5IHtmdW5jdGlvbn0gW3BpbmNoSW49bnVsbF0gQSBoYW5kbGVyIHRyaWdnZXJlZCBmb3IgcGluY2ggaW4gZXZlbnRzLiBTZWUge0BsaW5rICQuZm4uc3dpcGUjZXZlbnQ6cGluY2hJbn0KCSogQHByb3BlcnR5IHtmdW5jdGlvbn0gW3BpbmNoT3V0PW51bGxdIEEgaGFuZGxlciB0cmlnZ2VyZWQgZm9yIHBpbmNoIG91dCBldmVudHMuIFNlZSB7QGxpbmsgJC5mbi5zd2lwZSNldmVudDpwaW5jaE91dH0KCSogQHByb3BlcnR5IHtmdW5jdGlvbn0gW3BpbmNoU3RhdHVzPW51bGxdIEEgaGFuZGxlciB0cmlnZ2VyZWQgZm9yIGV2ZXJ5IHBoYXNlIG9mIGEgcGluY2guIFNlZSB7QGxpbmsgJC5mbi5zd2lwZSNldmVudDpwaW5jaFN0YXR1c30KCSogQHByb3BlcnR5IHtmdW5jdGlvbn0gW3RhcD1udWxsXSBBIGhhbmRsZXIgdHJpZ2dlcmVkIHdoZW4gYSB1c2VyIGp1c3QgdGFwcyBvbiB0aGUgaXRlbSwgcmF0aGVyIHRoYW4gc3dpcGVzIGl0LiBJZiB0aGV5IGRvIG5vdCBtb3ZlLCB0YXAgaXMgdHJpZ2dlcmVkLCBpZiB0aGV5IGRvIG1vdmUsIGl0IGlzIG5vdC4gCgkqIEBwcm9wZXJ0eSB7ZnVuY3Rpb259IFtkb3VibGVUYXA9bnVsbF0gQSBoYW5kbGVyIHRyaWdnZXJlZCB3aGVuIGEgdXNlciBkb3VibGUgdGFwcyBvbiB0aGUgaXRlbS4gVGhlIGRlbGF5IGJldHdlZW4gdGFwcyBjYW4gYmUgc2V0IHdpdGggdGhlIGRvdWJsZVRhcFRocmVzaG9sZCBwcm9wZXJ0eS4gU2VlIHtAbGluayAkLmZuLnN3aXBlLmRlZmF1bHRzI2RvdWJsZVRhcFRocmVzaG9sZH0KCSogQHByb3BlcnR5IHtmdW5jdGlvbn0gW2xvbmdUYXA9bnVsbF0gQSBoYW5kbGVyIHRyaWdnZXJlZCB3aGVuIGEgdXNlciBsb25nIHRhcHMgb24gdGhlIGl0ZW0uIFRoZSBkZWxheSBiZXR3ZWVuIHN0YXJ0IGFuZCBlbmQgY2FuIGJlIHNldCB3aXRoIHRoZSBsb25nVGFwVGhyZXNob2xkIHByb3BlcnR5LiBTZWUge0BsaW5rICQuZm4uc3dpcGUuZGVmYXVsdHMjbG9uZ1RhcFRocmVzaG9sZH0KCSogQHByb3BlcnR5IChmdW5jdGlvbikgW2hvbGQ9bnVsbF0gQSBoYW5kbGVyIHRyaWdnZXJlZCB3aGVuIGEgdXNlciByZWFjaGVzIGxvbmdUYXBUaHJlc2hvbGQgb24gdGhlIGl0ZW0uIFNlZSB7QGxpbmsgJC5mbi5zd2lwZS5kZWZhdWx0cyNsb25nVGFwVGhyZXNob2xkfQoJKiBAcHJvcGVydHkge2Jvb2xlYW59IFt0cmlnZ2VyT25Ub3VjaEVuZD10cnVlXSBJZiB0cnVlLCB0aGUgc3dpcGUgZXZlbnRzIGFyZSB0cmlnZ2VyZWQgd2hlbiB0aGUgdG91Y2ggZW5kIGV2ZW50IGlzIHJlY2VpdmVkICh1c2VyIHJlbGVhc2VzIGZpbmdlcikuICBJZiBmYWxzZSwgaXQgd2lsbCBiZSB0cmlnZ2VyZWQgb24gcmVhY2hpbmcgdGhlIHRocmVzaG9sZCwgYW5kIHRoZW4gY2FuY2VsIHRoZSB0b3VjaCBldmVudCBhdXRvbWF0aWNhbGx5LiAKCSogQHByb3BlcnR5IHtib29sZWFufSBbdHJpZ2dlck9uVG91Y2hMZWF2ZT1mYWxzZV0gSWYgdHJ1ZSwgdGhlbiB3aGVuIHRoZSB1c2VyIGxlYXZlcyB0aGUgc3dpcGUgb2JqZWN0LCB0aGUgc3dpcGUgd2lsbCBlbmQgYW5kIHRyaWdnZXIgYXBwcm9wcmlhdGUgaGFuZGxlcnMuIAoJKiBAcHJvcGVydHkge3N0cmluZ3x1bmRlZmluZWR9IFthbGxvd1BhZ2VTY3JvbGw9J2F1dG8nXSBIb3cgdGhlIGJyb3dzZXIgaGFuZGxlcyBwYWdlIHNjcm9sbHMgd2hlbiB0aGUgdXNlciBpcyBzd2lwaW5nIG9uIGEgdG91Y2hTd2lwZSBvYmplY3QuIFNlZSB7QGxpbmsgJC5mbi5zd2lwZS5wYWdlU2Nyb2xsfS4gIDxici8+PGJyLz4KCQkJCQkJCQkJCTxjb2RlPiJhdXRvIjwvY29kZT4gOiBhbGwgdW5kZWZpbmVkIHN3aXBlcyB3aWxsIGNhdXNlIHRoZSBwYWdlIHRvIHNjcm9sbCBpbiB0aGF0IGRpcmVjdGlvbi4gPGJyLz4KCQkJCQkJCQkJCTxjb2RlPiJub25lIjwvY29kZT4gOiB0aGUgcGFnZSB3aWxsIG5vdCBzY3JvbGwgd2hlbiB1c2VyIHN3aXBlcy4gPGJyLz4KCQkJCQkJCQkJCTxjb2RlPiJob3Jpem9udGFsIjwvY29kZT4gOiB3aWxsIGZvcmNlIHBhZ2UgdG8gc2Nyb2xsIG9uIGhvcml6b250YWwgc3dpcGVzLiA8YnIvPgoJCQkJCQkJCQkJPGNvZGU+InZlcnRpY2FsIjwvY29kZT4gOiB3aWxsIGZvcmNlIHBhZ2UgdG8gc2Nyb2xsIG9uIHZlcnRpY2FsIHN3aXBlcy4gPGJyLz4KCSogQHByb3BlcnR5IHtib29sZWFufSBbZmFsbGJhY2tUb01vdXNlRXZlbnRzPXRydWVdIElmIHRydWUgbW91c2UgZXZlbnRzIGFyZSB1c2VkIHdoZW4gcnVuIG9uIGEgbm9uIHRvdWNoIGRldmljZSwgZmFsc2Ugd2lsbCBzdG9wIHN3aXBlcyBiZWluZyB0cmlnZ2VyZWQgYnkgbW91c2UgZXZlbnRzIG9uIG5vbiB0b2N1aCBkZXZpY2VzLiAKCSogQHByb3BlcnR5IHtzdHJpbmd9IFtleGNsdWRlZEVsZW1lbnRzPSJidXR0b24sIGlucHV0LCBzZWxlY3QsIHRleHRhcmVhLCBhLCAubm9Td2lwZSJdIEEganF1ZXJ5IHNlbGVjdG9yIHRoYXQgc3BlY2lmaWVzIGNoaWxkIGVsZW1lbnRzIHRoYXQgZG8gTk9UIHRyaWdnZXIgc3dpcGVzLiBCeSBkZWZhdWx0IHRoaXMgZXhjbHVkZXMgYWxsIGZvcm0sIGlucHV0LCBzZWxlY3QsIGJ1dHRvbiwgYW5jaG9yIGFuZCAubm9Td2lwZSBlbGVtZW50cy4gCgkKCSovCgl2YXIgZGVmYXVsdHMgPSB7CgkJZmluZ2VyczogMSwgCQkKCQl0aHJlc2hvbGQ6IDc1LCAJCgkJY2FuY2VsVGhyZXNob2xkOm51bGwsCQoJCXBpbmNoVGhyZXNob2xkOjIwLAoJCW1heFRpbWVUaHJlc2hvbGQ6IG51bGwsIAoJCWZpbmdlclJlbGVhc2VUaHJlc2hvbGQ6MjUwLCAKCQlsb25nVGFwVGhyZXNob2xkOjUwMCwKCQlkb3VibGVUYXBUaHJlc2hvbGQ6MjAwLAoJCXN3aXBlOiBudWxsLCAJCQoJCXN3aXBlTGVmdDogbnVsbCwgCQoJCXN3aXBlUmlnaHQ6IG51bGwsIAkKCQlzd2lwZVVwOiBudWxsLCAJCQoJCXN3aXBlRG93bjogbnVsbCwgCQoJCXN3aXBlU3RhdHVzOiBudWxsLCAJCgkJcGluY2hJbjpudWxsLAkJCgkJcGluY2hPdXQ6bnVsbCwJCQoJCXBpbmNoU3RhdHVzOm51bGwsCQoJCWNsaWNrOm51bGwsIC8vRGVwcmVjYXRlZCBzaW5jZSAxLjYuMgoJCXRhcDpudWxsLAoJCWRvdWJsZVRhcDpudWxsLAoJCWxvbmdUYXA6bnVsbCwgCQkKCQlob2xkOm51bGwsIAoJCXRyaWdnZXJPblRvdWNoRW5kOiB0cnVlLCAKCQl0cmlnZ2VyT25Ub3VjaExlYXZlOmZhbHNlLCAKCQlhbGxvd1BhZ2VTY3JvbGw6ICJhdXRvIiwgCgkJZmFsbGJhY2tUb01vdXNlRXZlbnRzOiB0cnVlLAkKCQlleGNsdWRlZEVsZW1lbnRzOiJsYWJlbCwgYnV0dG9uLCBpbnB1dCwgc2VsZWN0LCB0ZXh0YXJlYSwgYSwgLm5vU3dpcGUiCgl9OwoKCgoJLyoqCgkqIEFwcGxpZXMgVG91Y2hTd2lwZSBiZWhhdmlvdXIgdG8gb25lIG9yIG1vcmUgalF1ZXJ5IG9iamVjdHMuCgkqIFRoZSBUb3VjaFN3aXBlIHBsdWdpbiBjYW4gYmUgaW5zdGFudGlhdGVkIHZpYSB0aGlzIG1ldGhvZCwgb3IgbWV0aG9kcyB3aXRoaW4gCgkqIFRvdWNoU3dpcGUgY2FuIGJlIGV4ZWN1dGVkIHZpYSB0aGlzIG1ldGhvZCBhcyBwZXIgalF1ZXJ5IHBsdWdpbiBhcmNoaXRlY3R1cmUuCgkqIEBzZWUgVG91Y2hTd2lwZQoJKiBAY2xhc3MKCSogQHBhcmFtIHtNaXhlZH0gbWV0aG9kIElmIHRoZSBjdXJyZW50IERPTU5vZGUgaXMgYSBUb3VjaFN3aXBlIG9iamVjdCwgYW5kIDxjb2RlPm1ldGhvZDwvY29kZT4gaXMgYSBUb3VjaFN3aXBlIG1ldGhvZCwgdGhlbgoJKiB0aGUgPGNvZGU+bWV0aG9kPC9jb2RlPiBpcyBleGVjdXRlZCwgYW5kIGFueSBmb2xsb3dpbmcgYXJndW1lbnRzIGFyZSBwYXNzZWQgdG8gdGhlIFRvdWNoU3dpcGUgbWV0aG9kLgoJKiBJZiA8Y29kZT5tZXRob2Q8L2NvZGU+IGlzIGFuIG9iamVjdCwgdGhlbiB0aGUgVG91Y2hTd2lwZSBjbGFzcyBpcyBpbnN0YW50aWF0ZWQgb24gdGhlIGN1cnJlbnQgRE9NTm9kZSwgcGFzc2luZyB0aGUgCgkqIGNvbmZpZ3VyYXRpb24gcHJvcGVydGllcyBkZWZpbmVkIGluIHRoZSBvYmplY3QuIFNlZSBUb3VjaFN3aXBlCgkqCgkqLwoJJC5mbi5zd2lwZSA9IGZ1bmN0aW9uIChtZXRob2QpIHsKCQl2YXIgJHRoaXMgPSAkKHRoaXMpLAoJCQlwbHVnaW4gPSAkdGhpcy5kYXRhKFBMVUdJTl9OUyk7CgoJCS8vQ2hlY2sgaWYgd2UgYXJlIGFscmVhZHkgaW5zdGFudGlhdGVkIGFuZCB0cnlpbmcgdG8gZXhlY3V0ZSBhIG1ldGhvZAkKCQlpZiAocGx1Z2luICYmIHR5cGVvZiBtZXRob2QgPT09ICdzdHJpbmcnKSB7CgkJCWlmIChwbHVnaW5bbWV0aG9kXSkgewoJCQkJcmV0dXJuIHBsdWdpblttZXRob2RdLmFwcGx5KHRoaXMsIEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMSkpOwoJCQl9IGVsc2UgewoJCQkJJC5lcnJvcignTWV0aG9kICcgKyBtZXRob2QgKyAnIGRvZXMgbm90IGV4aXN0IG9uIGpRdWVyeS5zd2lwZScpOwoJCQl9CgkJfQoJCS8vRWxzZSBub3QgaW5zdGFudGlhdGVkIGFuZCB0cnlpbmcgdG8gcGFzcyBpbml0IG9iamVjdCAob3Igbm90aGluZykKCQllbHNlIGlmICghcGx1Z2luICYmICh0eXBlb2YgbWV0aG9kID09PSAnb2JqZWN0JyB8fCAhbWV0aG9kKSkgewoJCQlyZXR1cm4gaW5pdC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoJCX0KCgkJcmV0dXJuICR0aGlzOwoJfTsKCgkvL0V4cG9zZSBvdXIgZGVmYXVsdHMgc28gYSB1c2VyIGNvdWxkIG92ZXJyaWRlIHRoZSBwbHVnaW4gZGVmYXVsdHMKCSQuZm4uc3dpcGUuZGVmYXVsdHMgPSBkZWZhdWx0czsKCgkvKioKCSogVGhlIHBoYXNlcyB0aGF0IGEgdG91Y2ggZXZlbnQgZ29lcyB0aHJvdWdoLiAgVGhlIDxjb2RlPnBoYXNlPC9jb2RlPiBpcyBwYXNzZWQgdG8gdGhlIGV2ZW50IGhhbmRsZXJzLiAKCSogVGhlc2UgcHJvcGVydGllcyBhcmUgcmVhZCBvbmx5LCBhdHRlbXB0aW5nIHRvIGNoYW5nZSB0aGVtIHdpbGwgbm90IGFsdGVyIHRoZSB2YWx1ZXMgcGFzc2VkIHRvIHRoZSBldmVudCBoYW5kbGVycy4KCSogQG5hbWVzcGFjZQoJKiBAcmVhZG9ubHkKCSogQHByb3BlcnR5IHtzdHJpbmd9IFBIQVNFX1NUQVJUIENvbnN0YW50IGluZGljYXRpbmcgdGhlIHN0YXJ0IHBoYXNlIG9mIHRoZSB0b3VjaCBldmVudC4gVmFsdWUgaXMgPGNvZGU+InN0YXJ0IjwvY29kZT4uCgkqIEBwcm9wZXJ0eSB7c3RyaW5nfSBQSEFTRV9NT1ZFIENvbnN0YW50IGluZGljYXRpbmcgdGhlIG1vdmUgcGhhc2Ugb2YgdGhlIHRvdWNoIGV2ZW50LiBWYWx1ZSBpcyA8Y29kZT4ibW92ZSI8L2NvZGU+LgoJKiBAcHJvcGVydHkge3N0cmluZ30gUEhBU0VfRU5EIENvbnN0YW50IGluZGljYXRpbmcgdGhlIGVuZCBwaGFzZSBvZiB0aGUgdG91Y2ggZXZlbnQuIFZhbHVlIGlzIDxjb2RlPiJlbmQiPC9jb2RlPi4KCSogQHByb3BlcnR5IHtzdHJpbmd9IFBIQVNFX0NBTkNFTCBDb25zdGFudCBpbmRpY2F0aW5nIHRoZSBjYW5jZWwgcGhhc2Ugb2YgdGhlIHRvdWNoIGV2ZW50LiBWYWx1ZSBpcyA8Y29kZT4iY2FuY2VsIjwvY29kZT4uCgkqLwoJJC5mbi5zd2lwZS5waGFzZXMgPSB7CgkJUEhBU0VfU1RBUlQ6IFBIQVNFX1NUQVJULAoJCVBIQVNFX01PVkU6IFBIQVNFX01PVkUsCgkJUEhBU0VfRU5EOiBQSEFTRV9FTkQsCgkJUEhBU0VfQ0FOQ0VMOiBQSEFTRV9DQU5DRUwKCX07CgoJLyoqCgkqIFRoZSBkaXJlY3Rpb24gY29uc3RhbnRzIHRoYXQgYXJlIHBhc3NlZCB0byB0aGUgZXZlbnQgaGFuZGxlcnMuIAoJKiBUaGVzZSBwcm9wZXJ0aWVzIGFyZSByZWFkIG9ubHksIGF0dGVtcHRpbmcgdG8gY2hhbmdlIHRoZW0gd2lsbCBub3QgYWx0ZXIgdGhlIHZhbHVlcyBwYXNzZWQgdG8gdGhlIGV2ZW50IGhhbmRsZXJzLgoJKiBAbmFtZXNwYWNlCgkqIEByZWFkb25seQoJKiBAcHJvcGVydHkge3N0cmluZ30gTEVGVCBDb25zdGFudCBpbmRpY2F0aW5nIHRoZSBsZWZ0IGRpcmVjdGlvbi4gVmFsdWUgaXMgPGNvZGU+ImxlZnQiPC9jb2RlPi4KCSogQHByb3BlcnR5IHtzdHJpbmd9IFJJR0hUIENvbnN0YW50IGluZGljYXRpbmcgdGhlIHJpZ2h0IGRpcmVjdGlvbi4gVmFsdWUgaXMgPGNvZGU+InJpZ2h0IjwvY29kZT4uCgkqIEBwcm9wZXJ0eSB7c3RyaW5nfSBVUCBDb25zdGFudCBpbmRpY2F0aW5nIHRoZSB1cCBkaXJlY3Rpb24uIFZhbHVlIGlzIDxjb2RlPiJ1cCI8L2NvZGU+LgoJKiBAcHJvcGVydHkge3N0cmluZ30gRE9XTiBDb25zdGFudCBpbmRpY2F0aW5nIHRoZSBkb3duIGRpcmVjdGlvbi4gVmFsdWUgaXMgPGNvZGU+ImNhbmNlbCI8L2NvZGU+LgoJKiBAcHJvcGVydHkge3N0cmluZ30gSU4gQ29uc3RhbnQgaW5kaWNhdGluZyB0aGUgaW4gZGlyZWN0aW9uLiBWYWx1ZSBpcyA8Y29kZT4iaW4iPC9jb2RlPi4KCSogQHByb3BlcnR5IHtzdHJpbmd9IE9VVCBDb25zdGFudCBpbmRpY2F0aW5nIHRoZSBvdXQgZGlyZWN0aW9uLiBWYWx1ZSBpcyA8Y29kZT4ib3V0IjwvY29kZT4uCgkqLwoJJC5mbi5zd2lwZS5kaXJlY3Rpb25zID0gewoJCUxFRlQ6IExFRlQsCgkJUklHSFQ6IFJJR0hULAoJCVVQOiBVUCwKCQlET1dOOiBET1dOLAoJCUlOIDogSU4sCgkJT1VUOiBPVVQKCX07CgkKCS8qKgoJKiBUaGUgcGFnZSBzY3JvbGwgY29uc3RhbnRzIHRoYXQgY2FuIGJlIHVzZWQgdG8gc2V0IHRoZSB2YWx1ZSBvZiA8Y29kZT5hbGxvd1BhZ2VTY3JvbGw8L2NvZGU+IG9wdGlvbgoJKiBUaGVzZSBwcm9wZXJ0aWVzIGFyZSByZWFkIG9ubHkKCSogQG5hbWVzcGFjZQoJKiBAcmVhZG9ubHkKCSogQHNlZSAkLmZuLnN3aXBlLmRlZmF1bHRzI2FsbG93UGFnZVNjcm9sbAoJKiBAcHJvcGVydHkge3N0cmluZ30gTk9ORSBDb25zdGFudCBpbmRpY2F0aW5nIG5vIHBhZ2Ugc2Nyb2xsaW5nIGlzIGFsbG93ZWQuIFZhbHVlIGlzIDxjb2RlPiJub25lIjwvY29kZT4uCgkqIEBwcm9wZXJ0eSB7c3RyaW5nfSBIT1JJWk9OVEFMIENvbnN0YW50IGluZGljYXRpbmcgaG9yaXpvbnRhbCBwYWdlIHNjcm9sbGluZyBpcyBhbGxvd2VkLiBWYWx1ZSBpcyA8Y29kZT4iaG9yaXpvbnRhbCI8L2NvZGU+LgoJKiBAcHJvcGVydHkge3N0cmluZ30gVkVSVElDQUwgQ29uc3RhbnQgaW5kaWNhdGluZyB2ZXJ0aWNhbCBwYWdlIHNjcm9sbGluZyBpcyBhbGxvd2VkLiBWYWx1ZSBpcyA8Y29kZT4idmVydGljYWwiPC9jb2RlPi4KCSogQHByb3BlcnR5IHtzdHJpbmd9IEFVVE8gQ29uc3RhbnQgaW5kaWNhdGluZyBlaXRoZXIgaG9yaXpvbnRhbCBvciB2ZXJ0aWNhbCB3aWxsIGJlIGFsbG93ZWQsIGRlcGVuZGluZyBvbiB0aGUgc3dpcGUgaGFuZGxlcnMgcmVnaXN0ZXJlZC4gVmFsdWUgaXMgPGNvZGU+ImF1dG8iPC9jb2RlPi4KCSovCgkkLmZuLnN3aXBlLnBhZ2VTY3JvbGwgPSB7CgkJTk9ORTogTk9ORSwKCQlIT1JJWk9OVEFMOiBIT1JJWk9OVEFMLAoJCVZFUlRJQ0FMOiBWRVJUSUNBTCwKCQlBVVRPOiBBVVRPCgl9OwoKCS8qKgoJKiBDb25zdGFudHMgcmVwcmVzZW50aW5nIHRoZSBudW1iZXIgb2YgZmluZ2VycyB1c2VkIGluIGEgc3dpcGUuICBUaGVzZSBhcmUgdXNlZCB0byBzZXQgYm90aCB0aGUgdmFsdWUgb2YgPGNvZGU+ZmluZ2VyczwvY29kZT4gaW4gdGhlIAoJKiBvcHRpb25zIG9iamVjdCwgYXMgd2VsbCBhcyB0aGUgdmFsdWUgb2YgdGhlIDxjb2RlPmZpbmdlcnM8L2NvZGU+IGV2ZW50IHByb3BlcnR5LgoJKiBUaGVzZSBwcm9wZXJ0aWVzIGFyZSByZWFkIG9ubHksIGF0dGVtcHRpbmcgdG8gY2hhbmdlIHRoZW0gd2lsbCBub3QgYWx0ZXIgdGhlIHZhbHVlcyBwYXNzZWQgdG8gdGhlIGV2ZW50IGhhbmRsZXJzLgoJKiBAbmFtZXNwYWNlCgkqIEByZWFkb25seQoJKiBAc2VlICQuZm4uc3dpcGUuZGVmYXVsdHMjZmluZ2VycwoJKiBAcHJvcGVydHkge3N0cmluZ30gT05FIENvbnN0YW50IGluZGljYXRpbmcgMSBmaW5nZXIgaXMgdG8gYmUgZGV0ZWN0ZWQgLyB3YXMgZGV0ZWN0ZWQuIFZhbHVlIGlzIDxjb2RlPjE8L2NvZGU+LgoJKiBAcHJvcGVydHkge3N0cmluZ30gVFdPIENvbnN0YW50IGluZGljYXRpbmcgMiBmaW5nZXJzIGFyZSB0byBiZSBkZXRlY3RlZCAvIHdlcmUgZGV0ZWN0ZWQuIFZhbHVlIGlzIDxjb2RlPjE8L2NvZGU+LgoJKiBAcHJvcGVydHkge3N0cmluZ30gVEhSRUUgQ29uc3RhbnQgaW5kaWNhdGluZyAzIGZpbmdlciBhcmUgdG8gYmUgZGV0ZWN0ZWQgLyB3ZXJlIGRldGVjdGVkLiBWYWx1ZSBpcyA8Y29kZT4xPC9jb2RlPi4KCSogQHByb3BlcnR5IHtzdHJpbmd9IEFMTCBDb25zdGFudCBpbmRpY2F0aW5nIGFueSBjb21iaW5hdGlvbiBvZiBmaW5nZXIgYXJlIHRvIGJlIGRldGVjdGVkLiAgVmFsdWUgaXMgPGNvZGU+ImFsbCI8L2NvZGU+LgoJKi8KCSQuZm4uc3dpcGUuZmluZ2VycyA9IHsKCQlPTkU6IDEsCgkJVFdPOiAyLAoJCVRIUkVFOiAzLAoJCUFMTDogQUxMX0ZJTkdFUlMKCX07CgoJLyoqCgkqIEluaXRpYWxpc2UgdGhlIHBsdWdpbiBmb3IgZWFjaCBET00gZWxlbWVudCBtYXRjaGVkCgkqIFRoaXMgY3JlYXRlcyBhIG5ldyBpbnN0YW5jZSBvZiB0aGUgbWFpbiBUb3VjaFN3aXBlIGNsYXNzIGZvciBlYWNoIERPTSBlbGVtZW50LCBhbmQgdGhlbgoJKiBzYXZlcyBhIHJlZmVyZW5jZSB0byB0aGF0IGluc3RhbmNlIGluIHRoZSBlbGVtZW50cyBkYXRhIHByb3BlcnR5LgoJKiBAaW50ZXJuYWwKCSovCglmdW5jdGlvbiBpbml0KG9wdGlvbnMpIHsKCQkvL1ByZXAgYW5kIGV4dGVuZCB0aGUgb3B0aW9ucwoJCWlmIChvcHRpb25zICYmIChvcHRpb25zLmFsbG93UGFnZVNjcm9sbCA9PT0gdW5kZWZpbmVkICYmIChvcHRpb25zLnN3aXBlICE9PSB1bmRlZmluZWQgfHwgb3B0aW9ucy5zd2lwZVN0YXR1cyAhPT0gdW5kZWZpbmVkKSkpIHsKCQkJb3B0aW9ucy5hbGxvd1BhZ2VTY3JvbGwgPSBOT05FOwoJCX0KCQkKICAgICAgICAvL0NoZWNrIGZvciBkZXByZWNhdGVkIG9wdGlvbnMKCQkvL0Vuc3VyZSB0aGF0IGFueSBvbGQgY2xpY2sgaGFuZGxlcnMgYXJlIGFzc2lnbmVkIHRvIHRoZSBuZXcgdGFwLCB1bmxlc3Mgd2UgaGF2ZSBhIHRhcAoJCWlmKG9wdGlvbnMuY2xpY2shPT11bmRlZmluZWQgJiYgb3B0aW9ucy50YXA9PT11bmRlZmluZWQpIHsKCQkgICAgb3B0aW9ucy50YXAgPSBvcHRpb25zLmNsaWNrOwoJCX0KCgkJaWYgKCFvcHRpb25zKSB7CgkJCW9wdGlvbnMgPSB7fTsKCQl9CgkJCiAgICAgICAgLy9wYXNzIGVtcHR5IG9iamVjdCBzbyB3ZSBkb250IG1vZGlmeSB0aGUgZGVmYXVsdHMKCQlvcHRpb25zID0gJC5leHRlbmQoe30sICQuZm4uc3dpcGUuZGVmYXVsdHMsIG9wdGlvbnMpOwoKCQkvL0ZvciBlYWNoIGVsZW1lbnQgaW5zdGFudGlhdGUgdGhlIHBsdWdpbgoJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24gKCkgewoJCQl2YXIgJHRoaXMgPSAkKHRoaXMpOwoKCQkJLy9DaGVjayB3ZSBoYXZlbnQgYWxyZWFkeSBpbml0aWFsaXNlZCB0aGUgcGx1Z2luCgkJCXZhciBwbHVnaW4gPSAkdGhpcy5kYXRhKFBMVUdJTl9OUyk7CgoJCQlpZiAoIXBsdWdpbikgewoJCQkJcGx1Z2luID0gbmV3IFRvdWNoU3dpcGUodGhpcywgb3B0aW9ucyk7CgkJCQkkdGhpcy5kYXRhKFBMVUdJTl9OUywgcGx1Z2luKTsKCQkJfQoJCX0pOwoJfQoKCS8qKgoJKiBNYWluIFRvdWNoU3dpcGUgUGx1Z2luIENsYXNzLgoJKiBEbyBub3QgdXNlIHRoaXMgdG8gY29uc3RydWN0IHlvdXIgVG91Y2hTd2lwZSBvYmplY3QsIHVzZSB0aGUgalF1ZXJ5IHBsdWdpbiBtZXRob2QgJC5mbi5zd2lwZSgpOyB7QGxpbmsgJC5mbi5zd2lwZX0KCSogQHByaXZhdGUKCSogQG5hbWUgVG91Y2hTd2lwZQoJKiBAcGFyYW0ge0RPTU5vZGV9IGVsZW1lbnQgVGhlIEhUTUwgRE9NIG9iamVjdCB0byBhcHBseSB0byBwbHVnaW4gdG8KCSogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMgVGhlIG9wdGlvbnMgdG8gY29uZmlndXJlIHRoZSBwbHVnaW4gd2l0aC4gIEBsaW5rIHskLmZuLnN3aXBlLmRlZmF1bHRzfQoJKiBAc2VlICQuZmguc3dpcGUuZGVmYXVsdHMKCSogQHNlZSAkLmZoLnN3aXBlCiAgICAqIEBjbGFzcwoJKi8KCWZ1bmN0aW9uIFRvdWNoU3dpcGUoZWxlbWVudCwgb3B0aW9ucykgewogICAgICAgIHZhciB1c2VUb3VjaEV2ZW50cyA9IChTVVBQT1JUU19UT1VDSCB8fCBTVVBQT1JUU19QT0lOVEVSIHx8ICFvcHRpb25zLmZhbGxiYWNrVG9Nb3VzZUV2ZW50cyksCiAgICAgICAgICAgIFNUQVJUX0VWID0gdXNlVG91Y2hFdmVudHMgPyAoU1VQUE9SVFNfUE9JTlRFUiA/IChTVVBQT1JUU19QT0lOVEVSX0lFMTAgPyAnTVNQb2ludGVyRG93bicgOiAncG9pbnRlcmRvd24nKSA6ICd0b3VjaHN0YXJ0JykgOiAnbW91c2Vkb3duJywKICAgICAgICAgICAgTU9WRV9FViA9IHVzZVRvdWNoRXZlbnRzID8gKFNVUFBPUlRTX1BPSU5URVIgPyAoU1VQUE9SVFNfUE9JTlRFUl9JRTEwID8gJ01TUG9pbnRlck1vdmUnIDogJ3BvaW50ZXJtb3ZlJykgOiAndG91Y2htb3ZlJykgOiAnbW91c2Vtb3ZlJywKICAgICAgICAgICAgRU5EX0VWID0gdXNlVG91Y2hFdmVudHMgPyAoU1VQUE9SVFNfUE9JTlRFUiA/IChTVVBQT1JUU19QT0lOVEVSX0lFMTAgPyAnTVNQb2ludGVyVXAnIDogJ3BvaW50ZXJ1cCcpIDogJ3RvdWNoZW5kJykgOiAnbW91c2V1cCcsCiAgICAgICAgICAgIExFQVZFX0VWID0gdXNlVG91Y2hFdmVudHMgPyBudWxsIDogJ21vdXNlbGVhdmUnLCAvL3dlIG1hbnVhbGx5IGRldGVjdCBsZWF2ZSBvbiB0b3VjaCBkZXZpY2VzLCBzbyBudWxsIGV2ZW50IGhlcmUKICAgICAgICAgICAgQ0FOQ0VMX0VWID0gKFNVUFBPUlRTX1BPSU5URVIgPyAoU1VQUE9SVFNfUE9JTlRFUl9JRTEwID8gJ01TUG9pbnRlckNhbmNlbCcgOiAncG9pbnRlcmNhbmNlbCcpIDogJ3RvdWNoY2FuY2VsJyk7CgoKCgkJLy90b3VjaCBwcm9wZXJ0aWVzCgkJdmFyIGRpc3RhbmNlID0gMCwKCQkJZGlyZWN0aW9uID0gbnVsbCwKCQkJZHVyYXRpb24gPSAwLAoJCQlzdGFydFRvdWNoZXNEaXN0YW5jZSA9IDAsCgkJCWVuZFRvdWNoZXNEaXN0YW5jZSA9IDAsCgkJCXBpbmNoWm9vbSA9IDEsCgkJCXBpbmNoRGlzdGFuY2UgPSAwLAoJCQlwaW5jaERpcmVjdGlvbiA9IDAsCgkJCW1heGltdW1zTWFwPW51bGw7CgoJCQoJCQoJCS8valF1ZXJ5IHdyYXBwZWQgZWxlbWVudCBmb3IgdGhpcyBpbnN0YW5jZQoJCXZhciAkZWxlbWVudCA9ICQoZWxlbWVudCk7CgkJCgkJLy9DdXJyZW50IHBoYXNlIG9mIHRoIHRvdWNoIGN5Y2xlCgkJdmFyIHBoYXNlID0gInN0YXJ0IjsKCgkJLy8gdGhlIGN1cnJlbnQgbnVtYmVyIG9mIGZpbmdlcnMgYmVpbmcgdXNlZC4KCQl2YXIgZmluZ2VyQ291bnQgPSAwOyAJCQkKCgkJLy90cmFjayBtb3VzZSBwb2ludHMgLyBkZWx0YQoJCXZhciBmaW5nZXJEYXRhPW51bGw7CgoJCS8vdHJhY2sgdGltZXMKCQl2YXIgc3RhcnRUaW1lID0gMCwKCQkJZW5kVGltZSA9IDAsCgkJCXByZXZpb3VzVG91Y2hFbmRUaW1lPTAsCgkJCXByZXZpb3VzVG91Y2hGaW5nZXJDb3VudD0wLAoJCQlkb3VibGVUYXBTdGFydFRpbWU9MDsKCgkJLy9UaW1lb3V0cwoJCXZhciBzaW5nbGVUYXBUaW1lb3V0PW51bGwsCgkJCWhvbGRUaW1lb3V0PW51bGw7CiAgICAgICAgCgkJLy8gQWRkIGdlc3R1cmVzIHRvIGFsbCBzd2lwYWJsZSBhcmVhcyBpZiBzdXBwb3J0ZWQKCQl0cnkgewoJCQkkZWxlbWVudC5iaW5kKFNUQVJUX0VWLCB0b3VjaFN0YXJ0KTsKCQkJJGVsZW1lbnQuYmluZChDQU5DRUxfRVYsIHRvdWNoQ2FuY2VsKTsKCQl9CgkJY2F0Y2ggKGUpIHsKCQkJJC5lcnJvcignZXZlbnRzIG5vdCBzdXBwb3J0ZWQgJyArIFNUQVJUX0VWICsgJywnICsgQ0FOQ0VMX0VWICsgJyBvbiBqUXVlcnkuc3dpcGUnKTsKCQl9CgoJCS8vCgkJLy9QdWJsaWMgbWV0aG9kcwoJCS8vCgkJCgkJLyoqCgkJKiByZS1lbmFibGVzIHRoZSBzd2lwZSBwbHVnaW4gd2l0aCB0aGUgcHJldmlvdXMgY29uZmlndXJhdGlvbgoJCSogQGZ1bmN0aW9uCgkJKiBAbmFtZSAkLmZuLnN3aXBlI2VuYWJsZQoJCSogQHJldHVybiB7RE9NTm9kZX0gVGhlIERvbSBlbGVtZW50IHRoYXQgd2FzIHJlZ2lzdGVyZWQgd2l0aCBUb3VjaFN3aXBlIAoJCSogQGV4YW1wbGUgJCgiI2VsZW1lbnQiKS5zd2lwZSgiZW5hYmxlIik7CgkJKi8KCQl0aGlzLmVuYWJsZSA9IGZ1bmN0aW9uICgpIHsKCQkJJGVsZW1lbnQuYmluZChTVEFSVF9FViwgdG91Y2hTdGFydCk7CgkJCSRlbGVtZW50LmJpbmQoQ0FOQ0VMX0VWLCB0b3VjaENhbmNlbCk7CgkJCXJldHVybiAkZWxlbWVudDsKCQl9OwoKCQkvKioKCQkqIGRpc2FibGVzIHRoZSBzd2lwZSBwbHVnaW4KCQkqIEBmdW5jdGlvbgoJCSogQG5hbWUgJC5mbi5zd2lwZSNkaXNhYmxlCgkJKiBAcmV0dXJuIHtET01Ob2RlfSBUaGUgRG9tIGVsZW1lbnQgdGhhdCBpcyBub3cgcmVnaXN0ZXJlZCB3aXRoIFRvdWNoU3dpcGUKCSAgICAqIEBleGFtcGxlICQoIiNlbGVtZW50Iikuc3dpcGUoImRpc2FibGUiKTsKCQkqLwoJCXRoaXMuZGlzYWJsZSA9IGZ1bmN0aW9uICgpIHsKCQkJcmVtb3ZlTGlzdGVuZXJzKCk7CgkJCXJldHVybiAkZWxlbWVudDsKCQl9OwoKCQkvKioKCQkqIERlc3Ryb3kgdGhlIHN3aXBlIHBsdWdpbiBjb21wbGV0ZWx5LiBUbyB1c2UgYW55IHN3aXBlIG1ldGhvZHMsIHlvdSBtdXN0IHJlIGluaXRpYWxpc2UgdGhlIHBsdWdpbi4KCQkqIEBmdW5jdGlvbgoJCSogQG5hbWUgJC5mbi5zd2lwZSNkZXN0cm95CgkJKiBAcmV0dXJuIHtET01Ob2RlfSBUaGUgRG9tIGVsZW1lbnQgdGhhdCB3YXMgcmVnaXN0ZXJlZCB3aXRoIFRvdWNoU3dpcGUgCgkJKiBAZXhhbXBsZSAkKCIjZWxlbWVudCIpLnN3aXBlKCJkZXN0cm95Iik7CgkJKi8KCQl0aGlzLmRlc3Ryb3kgPSBmdW5jdGlvbiAoKSB7CgkJCXJlbW92ZUxpc3RlbmVycygpOwoJCQkkZWxlbWVudC5kYXRhKFBMVUdJTl9OUywgbnVsbCk7CgkJCXJldHVybiAkZWxlbWVudDsKCQl9OwoKCiAgICAgICAgLyoqCiAgICAgICAgICogQWxsb3dzIHJ1biB0aW1lIHVwZGF0aW5nIG9mIHRoZSBzd2lwZSBjb25maWd1cmF0aW9uIG9wdGlvbnMuCiAgICAgICAgICogQGZ1bmN0aW9uCiAgICAJICogQG5hbWUgJC5mbi5zd2lwZSNvcHRpb24KICAgIAkgKiBAcGFyYW0ge1N0cmluZ30gcHJvcGVydHkgVGhlIG9wdGlvbiBwcm9wZXJ0eSB0byBnZXQgb3Igc2V0CiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IFt2YWx1ZV0gVGhlIHZhbHVlIHRvIHNldCB0aGUgcHJvcGVydHkgdG8KCQkgKiBAcmV0dXJuIHtPYmplY3R9IElmIG9ubHkgYSBwcm9wZXJ0eSBuYW1lIGlzIHBhc3NlZCwgdGhlbiB0aGF0IHByb3BlcnR5IHZhbHVlIGlzIHJldHVybmVkLgoJCSAqIEBleGFtcGxlICQoIiNlbGVtZW50Iikuc3dpcGUoIm9wdGlvbiIsICJ0aHJlc2hvbGQiKTsgLy8gcmV0dXJuIHRoZSB0aHJlc2hvbGQKICAgICAgICAgKiBAZXhhbXBsZSAkKCIjZWxlbWVudCIpLnN3aXBlKCJvcHRpb24iLCAidGhyZXNob2xkIiwgMTAwKTsgLy8gc2V0IHRoZSB0aHJlc2hvbGQgYWZ0ZXIgaW5pdAogICAgICAgICAqIEBzZWUgJC5mbi5zd2lwZS5kZWZhdWx0cwogICAgICAgICAqCiAgICAgICAgICovCiAgICAgICAgdGhpcy5vcHRpb24gPSBmdW5jdGlvbiAocHJvcGVydHksIHZhbHVlKSB7CiAgICAgICAgICAgIGlmKG9wdGlvbnNbcHJvcGVydHldIT09dW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICBpZih2YWx1ZT09PXVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBvcHRpb25zW3Byb3BlcnR5XTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgb3B0aW9uc1twcm9wZXJ0eV0gPSB2YWx1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICQuZXJyb3IoJ09wdGlvbiAnICsgcHJvcGVydHkgKyAnIGRvZXMgbm90IGV4aXN0IG9uIGpRdWVyeS5zd2lwZS5vcHRpb25zJyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KCgkJLy8KCQkvLyBQcml2YXRlIG1ldGhvZHMKCQkvLwoJCQoJCS8vCgkJLy8gRVZFTlRTCgkJLy8KCQkvKioKCQkqIEV2ZW50IGhhbmRsZXIgZm9yIGEgdG91Y2ggc3RhcnQgZXZlbnQuCgkJKiBTdG9wcyB0aGUgZGVmYXVsdCBjbGljayBldmVudCBmcm9tIHRyaWdnZXJpbmcgYW5kIHN0b3JlcyB3aGVyZSB3ZSB0b3VjaGVkCgkJKiBAaW5uZXIKCQkqIEBwYXJhbSB7b2JqZWN0fSBqcUV2ZW50IFRoZSBub3JtYWxpc2VkIGpRdWVyeSBldmVudCBvYmplY3QuCgkJKi8KCQlmdW5jdGlvbiB0b3VjaFN0YXJ0KGpxRXZlbnQpIHsKCQkJLy9JZiB3ZSBhbHJlYWR5IGluIGEgdG91Y2ggZXZlbnQgKGEgZmluZ2VyIGFscmVhZHkgaW4gdXNlKSB0aGVuIGlnbm9yZSBzdWJzZXF1ZW50IG9uZXMuLgoJCQlpZiggZ2V0VG91Y2hJblByb2dyZXNzKCkgKQoJCQkJcmV0dXJuOwoJCQkKCQkJLy9DaGVjayBpZiB0aGlzIGVsZW1lbnQgbWF0Y2hlcyBhbnkgaW4gdGhlIGV4Y2x1ZGVkIGVsZW1lbnRzIHNlbGVjdG9ycywgIG9yIGl0cyBwYXJlbnQgaXMgZXhjbHVkZWQsIGlmIHNvLCBET04nVCBzd2lwZQoJCQlpZiggJChqcUV2ZW50LnRhcmdldCkuY2xvc2VzdCggb3B0aW9ucy5leGNsdWRlZEVsZW1lbnRzLCAkZWxlbWVudCApLmxlbmd0aD4wICkgCgkJCQlyZXR1cm47CgkJCQkKCQkJLy9BcyB3ZSB1c2UgSnF1ZXJ5IGJpbmQgZm9yIGV2ZW50cywgd2UgbmVlZCB0byB0YXJnZXQgdGhlIG9yaWdpbmFsIGV2ZW50IG9iamVjdAoJCQkvL0lmIHRoZXNlIGV2ZW50cyBhcmUgYmVpbmcgcHJvZ3JhbW1hdGljYWxseSB0cmlnZ2VyZWQsIHdlIGRvbid0IGhhdmUgYW4gb3JpZ2luYWwgZXZlbnQgb2JqZWN0LCBzbyB1c2UgdGhlIEpxIG9uZS4KCQkJdmFyIGV2ZW50ID0ganFFdmVudC5vcmlnaW5hbEV2ZW50ID8ganFFdmVudC5vcmlnaW5hbEV2ZW50IDoganFFdmVudDsKCQkJCgkJCXZhciByZXQsCgkJCQlldnQgPSBTVVBQT1JUU19UT1VDSCA/IGV2ZW50LnRvdWNoZXNbMF0gOiBldmVudDsKCgkJCXBoYXNlID0gUEhBU0VfU1RBUlQ7CgoJCQkvL0lmIHdlIHN1cHBvcnQgdG91Y2hlcywgZ2V0IHRoZSBmaW5nZXIgY291bnQKCQkJaWYgKFNVUFBPUlRTX1RPVUNIKSB7CgkJCQkvLyBnZXQgdGhlIHRvdGFsIG51bWJlciBvZiBmaW5nZXJzIHRvdWNoaW5nIHRoZSBzY3JlZW4KCQkJCWZpbmdlckNvdW50ID0gZXZlbnQudG91Y2hlcy5sZW5ndGg7CgkJCX0KCQkJLy9FbHNlIHRoaXMgaXMgdGhlIGRlc2t0b3AsIHNvIHN0b3AgdGhlIGJyb3dzZXIgZnJvbSBkcmFnZ2luZyB0aGUgaW1hZ2UKCQkJZWxzZSB7CgkJCQlqcUV2ZW50LnByZXZlbnREZWZhdWx0KCk7IC8vY2FsbCB0aGlzIG9uIGpxIGV2ZW50IHNvIHdlIGFyZSBjcm9zcyBicm93c2VyCgkJCX0KCgkJCS8vY2xlYXIgdmFycy4uCgkJCWRpc3RhbmNlID0gMDsKCQkJZGlyZWN0aW9uID0gbnVsbDsKCQkJcGluY2hEaXJlY3Rpb249bnVsbDsKCQkJZHVyYXRpb24gPSAwOwoJCQlzdGFydFRvdWNoZXNEaXN0YW5jZT0wOwoJCQllbmRUb3VjaGVzRGlzdGFuY2U9MDsKCQkJcGluY2hab29tID0gMTsKCQkJcGluY2hEaXN0YW5jZSA9IDA7CgkJCWZpbmdlckRhdGE9Y3JlYXRlQWxsRmluZ2VyRGF0YSgpOwoJCQltYXhpbXVtc01hcD1jcmVhdGVNYXhpbXVtc0RhdGEoKTsKCQkJY2FuY2VsTXVsdGlGaW5nZXJSZWxlYXNlKCk7CgoJCQkKCQkJLy8gY2hlY2sgdGhlIG51bWJlciBvZiBmaW5nZXJzIGlzIHdoYXQgd2UgYXJlIGxvb2tpbmcgZm9yLCBvciB3ZSBhcmUgY2FwdHVyaW5nIHBpbmNoZXMKCQkJaWYgKCFTVVBQT1JUU19UT1VDSCB8fCAoZmluZ2VyQ291bnQgPT09IG9wdGlvbnMuZmluZ2VycyB8fCBvcHRpb25zLmZpbmdlcnMgPT09IEFMTF9GSU5HRVJTKSB8fCBoYXNQaW5jaGVzKCkpIHsKCQkJCS8vIGdldCB0aGUgY29vcmRpbmF0ZXMgb2YgdGhlIHRvdWNoCgkJCQljcmVhdGVGaW5nZXJEYXRhKCAwLCBldnQgKTsKCQkJCXN0YXJ0VGltZSA9IGdldFRpbWVTdGFtcCgpOwoJCQkJCgkJCQlpZihmaW5nZXJDb3VudD09MikgewoJCQkJCS8vS2VlcCB0cmFjayBvZiB0aGUgaW5pdGlhbCBwaW5jaCBkaXN0YW5jZSwgc28gd2UgY2FuIGNhbGN1bGF0ZSB0aGUgZGlmZiBsYXRlcgoJCQkJCS8vU3RvcmUgc2Vjb25kIGZpbmdlciBkYXRhIGFzIHN0YXJ0CgkJCQkJY3JlYXRlRmluZ2VyRGF0YSggMSwgZXZlbnQudG91Y2hlc1sxXSApOwoJCQkJCXN0YXJ0VG91Y2hlc0Rpc3RhbmNlID0gZW5kVG91Y2hlc0Rpc3RhbmNlID0gY2FsY3VsYXRlVG91Y2hlc0Rpc3RhbmNlKGZpbmdlckRhdGFbMF0uc3RhcnQsIGZpbmdlckRhdGFbMV0uc3RhcnQpOwoJCQkJfQoJCQkJCgkJCQlpZiAob3B0aW9ucy5zd2lwZVN0YXR1cyB8fCBvcHRpb25zLnBpbmNoU3RhdHVzKSB7CgkJCQkJcmV0ID0gdHJpZ2dlckhhbmRsZXIoZXZlbnQsIHBoYXNlKTsKCQkJCX0KCQkJfQoJCQllbHNlIHsKCQkJCS8vQSB0b3VjaCB3aXRoIG1vcmUgb3IgbGVzcyB0aGFuIHRoZSBmaW5nZXJzIHdlIGFyZSBsb29raW5nIGZvciwgc28gY2FuY2VsCgkJCQlyZXQgPSBmYWxzZTsgCgkJCX0KCgkJCS8vSWYgd2UgaGF2ZSBhIHJldHVybiB2YWx1ZSBmcm9tIHRoZSB1c2VycyBoYW5kbGVyLCB0aGVuIHJldHVybiBhbmQgY2FuY2VsCgkJCWlmIChyZXQgPT09IGZhbHNlKSB7CgkJCQlwaGFzZSA9IFBIQVNFX0NBTkNFTDsKCQkJCXRyaWdnZXJIYW5kbGVyKGV2ZW50LCBwaGFzZSk7CgkJCQlyZXR1cm4gcmV0OwoJCQl9CgkJCWVsc2UgewoJCQkJaWYgKG9wdGlvbnMuaG9sZCkgewoJCQkJCWhvbGRUaW1lb3V0ID0gc2V0VGltZW91dCgkLnByb3h5KGZ1bmN0aW9uKCkgewoJCQkJCQkvL1RyaWdnZXIgdGhlIGV2ZW50CgkJCQkJCSRlbGVtZW50LnRyaWdnZXIoJ2hvbGQnLCBbZXZlbnQudGFyZ2V0XSk7CgkJCQkJCS8vRmlyZSB0aGUgY2FsbGJhY2sKCQkJCQkJaWYob3B0aW9ucy5ob2xkKSB7CgkJCQkJCQlyZXQgPSBvcHRpb25zLmhvbGQuY2FsbCgkZWxlbWVudCwgZXZlbnQsIGV2ZW50LnRhcmdldCk7CgkJCQkJCX0KCQkJCQl9LCB0aGlzKSwgb3B0aW9ucy5sb25nVGFwVGhyZXNob2xkICk7CgkJCQl9CgoJCQkJc2V0VG91Y2hJblByb2dyZXNzKHRydWUpOwoJCQl9CgogICAgICAgICAgICByZXR1cm4gbnVsbDsKCQl9OwoJCQoJCQoJCQoJCS8qKgoJCSogRXZlbnQgaGFuZGxlciBmb3IgYSB0b3VjaCBtb3ZlIGV2ZW50LiAKCQkqIElmIHdlIGNoYW5nZSBmaW5nZXJzIGR1cmluZyBtb3ZlLCB0aGVuIGNhbmNlbCB0aGUgZXZlbnQKCQkqIEBpbm5lcgoJCSogQHBhcmFtIHtvYmplY3R9IGpxRXZlbnQgVGhlIG5vcm1hbGlzZWQgalF1ZXJ5IGV2ZW50IG9iamVjdC4KCQkqLwoJCWZ1bmN0aW9uIHRvdWNoTW92ZShqcUV2ZW50KSB7CgkJCQoJCQkvL0FzIHdlIHVzZSBKcXVlcnkgYmluZCBmb3IgZXZlbnRzLCB3ZSBuZWVkIHRvIHRhcmdldCB0aGUgb3JpZ2luYWwgZXZlbnQgb2JqZWN0CgkJCS8vSWYgdGhlc2UgZXZlbnRzIGFyZSBiZWluZyBwcm9ncmFtbWF0aWNhbGx5IHRyaWdnZXJlZCwgd2UgZG9uJ3QgaGF2ZSBhbiBvcmlnaW5hbCBldmVudCBvYmplY3QsIHNvIHVzZSB0aGUgSnEgb25lLgoJCQl2YXIgZXZlbnQgPSBqcUV2ZW50Lm9yaWdpbmFsRXZlbnQgPyBqcUV2ZW50Lm9yaWdpbmFsRXZlbnQgOiBqcUV2ZW50OwoJCQkKCQkJLy9JZiB3ZSBhcmUgZW5kaW5nLCBjYW5jZWxsaW5nLCBvciB3aXRoaW4gdGhlIHRocmVzaG9sZCBvZiAyIGZpbmdlcnMgYmVpbmcgcmVsZWFzZWQsIGRvbid0IHRyYWNrIGFueXRoaW5nLi4KCQkJaWYgKHBoYXNlID09PSBQSEFTRV9FTkQgfHwgcGhhc2UgPT09IFBIQVNFX0NBTkNFTCB8fCBpbk11bHRpRmluZ2VyUmVsZWFzZSgpKQoJCQkJcmV0dXJuOwoKCQkJdmFyIHJldCwKCQkJCWV2dCA9IFNVUFBPUlRTX1RPVUNIID8gZXZlbnQudG91Y2hlc1swXSA6IGV2ZW50OwoJCQkKCgkJCS8vVXBkYXRlIHRoZSAgZmluZ2VyIGRhdGEgCgkJCXZhciBjdXJyZW50RmluZ2VyID0gdXBkYXRlRmluZ2VyRGF0YShldnQpOwoJCQllbmRUaW1lID0gZ2V0VGltZVN0YW1wKCk7CgkJCQoJCQlpZiAoU1VQUE9SVFNfVE9VQ0gpIHsKCQkJCWZpbmdlckNvdW50ID0gZXZlbnQudG91Y2hlcy5sZW5ndGg7CgkJCX0KCgkJCWlmIChvcHRpb25zLmhvbGQpCgkJCQljbGVhclRpbWVvdXQoaG9sZFRpbWVvdXQpOwoKCQkJcGhhc2UgPSBQSEFTRV9NT1ZFOwoKCQkJLy9JZiB3ZSBoYXZlIDIgZmluZ2VycyBnZXQgVG91Y2hlcyBkaXN0YW5jZSBhcyB3ZWxsCgkJCWlmKGZpbmdlckNvdW50PT0yKSB7CgkJCQkKCQkJCS8vS2VlcCB0cmFjayBvZiB0aGUgaW5pdGlhbCBwaW5jaCBkaXN0YW5jZSwgc28gd2UgY2FuIGNhbGN1bGF0ZSB0aGUgZGlmZiBsYXRlcgoJCQkJLy9XZSBkbyB0aGlzIGhlcmUgYXMgd2VsbCBhcyB0aGUgc3RhcnQgZXZlbnQsIGluIGNhc2UgdGhleSBzdGFydCB3aXRoIDEgZmluZ2VyLCBhbmQgdGhlIHByZXNzIDIgZmluZ2VycwoJCQkJaWYoc3RhcnRUb3VjaGVzRGlzdGFuY2U9PTApIHsKCQkJCQkvL0NyZWF0ZSBzZWNvbmQgZmluZ2VyIGlmIHRoaXMgaXMgdGhlIGZpcnN0IHRpbWUuLi4KCQkJCQljcmVhdGVGaW5nZXJEYXRhKCAxLCBldmVudC50b3VjaGVzWzFdICk7CgkJCQkJCgkJCQkJc3RhcnRUb3VjaGVzRGlzdGFuY2UgPSBlbmRUb3VjaGVzRGlzdGFuY2UgPSBjYWxjdWxhdGVUb3VjaGVzRGlzdGFuY2UoZmluZ2VyRGF0YVswXS5zdGFydCwgZmluZ2VyRGF0YVsxXS5zdGFydCk7CgkJCQl9IGVsc2UgewoJCQkJCS8vRWxzZSBqdXN0IHVwZGF0ZSB0aGUgc2Vjb25kIGZpbmdlcgoJCQkJCXVwZGF0ZUZpbmdlckRhdGEoZXZlbnQudG91Y2hlc1sxXSk7CgkJCQkKCQkJCQllbmRUb3VjaGVzRGlzdGFuY2UgPSBjYWxjdWxhdGVUb3VjaGVzRGlzdGFuY2UoZmluZ2VyRGF0YVswXS5lbmQsIGZpbmdlckRhdGFbMV0uZW5kKTsKCQkJCQlwaW5jaERpcmVjdGlvbiA9IGNhbGN1bGF0ZVBpbmNoRGlyZWN0aW9uKGZpbmdlckRhdGFbMF0uZW5kLCBmaW5nZXJEYXRhWzFdLmVuZCk7CgkJCQl9CgkJCQkKCQkJCQoJCQkJcGluY2hab29tID0gY2FsY3VsYXRlUGluY2hab29tKHN0YXJ0VG91Y2hlc0Rpc3RhbmNlLCBlbmRUb3VjaGVzRGlzdGFuY2UpOwoJCQkJcGluY2hEaXN0YW5jZSA9IE1hdGguYWJzKHN0YXJ0VG91Y2hlc0Rpc3RhbmNlIC0gZW5kVG91Y2hlc0Rpc3RhbmNlKTsKCQkJfQoJCQkKCQkJCgkJCWlmICggKGZpbmdlckNvdW50ID09PSBvcHRpb25zLmZpbmdlcnMgfHwgb3B0aW9ucy5maW5nZXJzID09PSBBTExfRklOR0VSUykgfHwgIVNVUFBPUlRTX1RPVUNIIHx8IGhhc1BpbmNoZXMoKSApIHsKCQkJCQoJCQkJZGlyZWN0aW9uID0gY2FsY3VsYXRlRGlyZWN0aW9uKGN1cnJlbnRGaW5nZXIuc3RhcnQsIGN1cnJlbnRGaW5nZXIuZW5kKTsKCQkJCQoJCQkJLy9DaGVjayBpZiB3ZSBuZWVkIHRvIHByZXZlbnQgZGVmYXVsdCBldmVudCAocGFnZSBzY3JvbGwgLyBwaW5jaCB6b29tKSBvciBub3QKCQkJCXZhbGlkYXRlRGVmYXVsdEV2ZW50KGpxRXZlbnQsIGRpcmVjdGlvbik7CgoJCQkJLy9EaXN0YW5jZSBhbmQgZHVyYXRpb24gYXJlIGFsbCBvZmYgdGhlIG1haW4gZmluZ2VyCgkJCQlkaXN0YW5jZSA9IGNhbGN1bGF0ZURpc3RhbmNlKGN1cnJlbnRGaW5nZXIuc3RhcnQsIGN1cnJlbnRGaW5nZXIuZW5kKTsKCQkJCWR1cmF0aW9uID0gY2FsY3VsYXRlRHVyYXRpb24oKTsKCiAgICAgICAgICAgICAgICAvL0NhY2hlIHRoZSBtYXhpbXVtIGRpc3RhbmNlIHdlIG1hZGUgaW4gdGhpcyBkaXJlY3Rpb24KICAgICAgICAgICAgICAgIHNldE1heERpc3RhbmNlKGRpcmVjdGlvbiwgZGlzdGFuY2UpOwoKCgkJCQlpZiAob3B0aW9ucy5zd2lwZVN0YXR1cyB8fCBvcHRpb25zLnBpbmNoU3RhdHVzKSB7CgkJCQkJcmV0ID0gdHJpZ2dlckhhbmRsZXIoZXZlbnQsIHBoYXNlKTsKCQkJCX0KCQkJCQoJCQkJCgkJCQkvL0lmIHdlIHRyaWdnZXIgZW5kIGV2ZW50cyB3aGVuIHRocmVzaG9sZCBhcmUgbWV0LCBvciB0cmlnZ2VyIGV2ZW50cyB3aGVuIHRvdWNoIGxlYXZlcyBlbGVtZW50CgkJCQlpZighb3B0aW9ucy50cmlnZ2VyT25Ub3VjaEVuZCB8fCBvcHRpb25zLnRyaWdnZXJPblRvdWNoTGVhdmUpIHsKCQkJCQkKCQkJCQl2YXIgaW5Cb3VuZHMgPSB0cnVlOwoJCQkJCQoJCQkJCS8vSWYgY2hlY2tpbmcgaWYgd2UgbGVhdmUgdGhlIGVsZW1lbnQsIHJ1biB0aGUgYm91bmRzIGNoZWNrICh3ZSBjYW4gdXNlIHRvdWNobGVhdmUgYXMgaXRzIG5vdCBzdXBwb3J0ZWQgb24gd2Via2l0KQoJCQkJCWlmKG9wdGlvbnMudHJpZ2dlck9uVG91Y2hMZWF2ZSkgewoJCQkJCQl2YXIgYm91bmRzID0gZ2V0Ym91bmRzKCB0aGlzICk7CgkJCQkJCWluQm91bmRzID0gaXNJbkJvdW5kcyggY3VycmVudEZpbmdlci5lbmQsIGJvdW5kcyApOwoJCQkJCX0KCQkJCQkKCQkJCQkvL1RyaWdnZXIgZW5kIGhhbmRsZXMgYXMgd2Ugc3dpcGUgaWYgdGhyZXNob2xkcyBtZXQgb3IgaWYgd2UgaGF2ZSBsZWZ0IHRoZSBlbGVtZW50IGlmIHRoZSB1c2VyIGhhcyBhc2tlZCB0byBjaGVjayB0aGVzZS4uCgkJCQkJaWYoIW9wdGlvbnMudHJpZ2dlck9uVG91Y2hFbmQgJiYgaW5Cb3VuZHMpIHsKCQkJCQkJcGhhc2UgPSBnZXROZXh0UGhhc2UoIFBIQVNFX01PVkUgKTsKCQkJCQl9IAoJCQkJCS8vV2UgZW5kIGlmIG91dCBvZiBib3VuZHMgaGVyZSwgc28gc2V0IGN1cnJlbnQgcGhhc2UgdG8gRU5ELCBhbmQgY2hlY2sgaWYgaXRzIG1vZGlmaWVkIAoJCQkJCWVsc2UgaWYob3B0aW9ucy50cmlnZ2VyT25Ub3VjaExlYXZlICYmICFpbkJvdW5kcyApIHsKCQkJCQkJcGhhc2UgPSBnZXROZXh0UGhhc2UoIFBIQVNFX0VORCApOwoJCQkJCX0KCQkJCQkJCgkJCQkJaWYocGhhc2U9PVBIQVNFX0NBTkNFTCB8fCBwaGFzZT09UEhBU0VfRU5EKQl7CgkJCQkJCXRyaWdnZXJIYW5kbGVyKGV2ZW50LCBwaGFzZSk7CgkJCQkJfQkJCQkKCQkJCX0KCQkJfQoJCQllbHNlIHsKCQkJCXBoYXNlID0gUEhBU0VfQ0FOQ0VMOwoJCQkJdHJpZ2dlckhhbmRsZXIoZXZlbnQsIHBoYXNlKTsKCQkJfQoKCQkJaWYgKHJldCA9PT0gZmFsc2UpIHsKCQkJCXBoYXNlID0gUEhBU0VfQ0FOQ0VMOwoJCQkJdHJpZ2dlckhhbmRsZXIoZXZlbnQsIHBoYXNlKTsKCQkJfQoJCX0KCgoKCQkvKioKCQkqIEV2ZW50IGhhbmRsZXIgZm9yIGEgdG91Y2ggZW5kIGV2ZW50LiAKCQkqIENhbGN1bGF0ZSB0aGUgZGlyZWN0aW9uIGFuZCB0cmlnZ2VyIGV2ZW50cwoJCSogQGlubmVyCgkJKiBAcGFyYW0ge29iamVjdH0ganFFdmVudCBUaGUgbm9ybWFsaXNlZCBqUXVlcnkgZXZlbnQgb2JqZWN0LgoJCSovCgkJZnVuY3Rpb24gdG91Y2hFbmQoanFFdmVudCkgewoJCQkvL0FzIHdlIHVzZSBKcXVlcnkgYmluZCBmb3IgZXZlbnRzLCB3ZSBuZWVkIHRvIHRhcmdldCB0aGUgb3JpZ2luYWwgZXZlbnQgb2JqZWN0CgkJCXZhciBldmVudCA9IGpxRXZlbnQub3JpZ2luYWxFdmVudDsKCQkJCQoKCQkJLy9JZiB3ZSBhcmUgc3RpbGwgaW4gYSB0b3VjaCB3aXRoIGFub3RoZXIgZmluZ2VyIHJldHVybgoJCQkvL1RoaXMgYWxsb3dzIHVzIHRvIHdhaXQgYSBmcmFjdGlvbiBhbmQgc2VlIGlmIHRoZSBvdGhlciBmaW5nZXIgY29tZXMgdXAsIGlmIGl0IGRvZXMgd2l0aGluIHRoZSB0aHJlc2hvbGQsIHRoZW4gd2UgdHJlYXQgaXQgYXMgYSBtdWx0aSByZWxlYXNlLCBub3QgYSBzaW5nbGUgcmVsZWFzZS4KCQkJaWYgKFNVUFBPUlRTX1RPVUNIKSB7CgkJCQlpZihldmVudC50b3VjaGVzLmxlbmd0aD4wKSB7CgkJCQkJc3RhcnRNdWx0aUZpbmdlclJlbGVhc2UoKTsKCQkJCQlyZXR1cm4gdHJ1ZTsKCQkJCX0KCQkJfQoJCQkKCQkJLy9JZiBhIHByZXZpb3VzIGZpbmdlciBoYXMgYmVlbiByZWxlYXNlZCwgY2hlY2sgaG93IGxvbmcgYWdvLCBpZiB3aXRoaW4gdGhlIHRocmVzaG9sZCwgdGhlbiBhc3N1bWUgaXQgd2FzIGEgbXVsdGlmaW5nZXIgcmVsZWFzZS4KCQkJLy9UaGlzIGlzIHVzZWQgdG8gYWxsb3cgMiBmaW5nZXJzIHRvIHJlbGVhc2UgZnJhY3Rpb25hbGx5IGFmdGVyIGVhY2ggb3RoZXIsIHdoaWxzdCBtYWludGFpbmlnIHRoZSBldmVudCBhcyBjb250YWluZyAyIGZpbmdlcnMsIG5vdCAxCgkJCWlmKGluTXVsdGlGaW5nZXJSZWxlYXNlKCkpIHsJCgkJCQlmaW5nZXJDb3VudD1wcmV2aW91c1RvdWNoRmluZ2VyQ291bnQ7CgkJCX0JCgkJCgkJCS8vU2V0IGVuZCBvZiBzd2lwZQoJCQllbmRUaW1lID0gZ2V0VGltZVN0YW1wKCk7CgkJCQoJCQkvL0dldCBkdXJhdGlvbiBpbmNhc2UgbW92ZSB3YXMgbmV2ZXIgZmlyZWQKCQkJZHVyYXRpb24gPSBjYWxjdWxhdGVEdXJhdGlvbigpOwoJCQkKCQkJLy9JZiB3ZSB0cmlnZ2VyIGhhbmRsZXJzIGF0IGVuZCBvZiBzd2lwZSBPUiwgd2UgdHJpZ2dlciBkdXJpbmcsIGJ1dCB0aGV5IGRpZG50IHRyaWdnZXIgYW5kIHdlIGFyZSBzdGlsbCBpbiB0aGUgbW92ZSBwaGFzZQoJCQlpZihkaWRTd2lwZUJhY2tUb0NhbmNlbCgpIHx8ICF2YWxpZGF0ZVN3aXBlRGlzdGFuY2UoKSkgewoJCQkgICAgcGhhc2UgPSBQSEFTRV9DQU5DRUw7CiAgICAgICAgICAgICAgICB0cmlnZ2VySGFuZGxlcihldmVudCwgcGhhc2UpOwoJCQl9IGVsc2UgaWYgKG9wdGlvbnMudHJpZ2dlck9uVG91Y2hFbmQgfHwgKG9wdGlvbnMudHJpZ2dlck9uVG91Y2hFbmQgPT0gZmFsc2UgJiYgcGhhc2UgPT09IFBIQVNFX01PVkUpKSB7CgkJCQkvL2NhbGwgdGhpcyBvbiBqcSBldmVudCBzbyB3ZSBhcmUgY3Jvc3MgYnJvd3NlciAKCQkJCWpxRXZlbnQucHJldmVudERlZmF1bHQoKTsgCgkJCQlwaGFzZSA9IFBIQVNFX0VORDsKICAgICAgICAgICAgICAgIHRyaWdnZXJIYW5kbGVyKGV2ZW50LCBwaGFzZSk7CgkJCX0KCQkJLy9TcGVjaWFsIGNhc2VzIC0gQSB0YXAgc2hvdWxkIGFsd2F5cyBmaXJlIG9uIHRvdWNoIGVuZCByZWdhcmRsZXNzLAoJCQkvL1NvIGhlcmUgd2UgbWFudWFsbHkgdHJpZ2dlciB0aGUgdGFwIGVuZCBoYW5kbGVyIGJ5IGl0c2VsZgoJCQkvL1dlIGRvbnQgcnVuIHRyaWdnZXIgaGFuZGxlciBhcyBpdCB3aWxsIHJlLXRyaWdnZXIgZXZlbnRzIHRoYXQgbWF5IGhhdmUgZmlyZWQgYWxyZWFkeQoJCQllbHNlIGlmICghb3B0aW9ucy50cmlnZ2VyT25Ub3VjaEVuZCAmJiBoYXNUYXAoKSkgewogICAgICAgICAgICAgICAgLy9UcmlnZ2VyIHRoZSBwaW5jaCBldmVudHMuLi4KCQkJICAgIHBoYXNlID0gUEhBU0VfRU5EOwoJCQkgICAgdHJpZ2dlckhhbmRsZXJGb3JHZXN0dXJlKGV2ZW50LCBwaGFzZSwgVEFQKTsKCQkJfQoJCQllbHNlIGlmIChwaGFzZSA9PT0gUEhBU0VfTU9WRSkgewoJCQkJcGhhc2UgPSBQSEFTRV9DQU5DRUw7CgkJCQl0cmlnZ2VySGFuZGxlcihldmVudCwgcGhhc2UpOwoJCQl9CgoJCQlzZXRUb3VjaEluUHJvZ3Jlc3MoZmFsc2UpOwoKICAgICAgICAgICAgcmV0dXJuIG51bGw7CgkJfQoKCgoJCS8qKgoJCSogRXZlbnQgaGFuZGxlciBmb3IgYSB0b3VjaCBjYW5jZWwgZXZlbnQuIAoJCSogQ2xlYXJzIGN1cnJlbnQgdmFycwoJCSogQGlubmVyCgkJKi8KCQlmdW5jdGlvbiB0b3VjaENhbmNlbCgpIHsKCQkJLy8gcmVzZXQgdGhlIHZhcmlhYmxlcyBiYWNrIHRvIGRlZmF1bHQgdmFsdWVzCgkJCWZpbmdlckNvdW50ID0gMDsKCQkJZW5kVGltZSA9IDA7CgkJCXN0YXJ0VGltZSA9IDA7CgkJCXN0YXJ0VG91Y2hlc0Rpc3RhbmNlPTA7CgkJCWVuZFRvdWNoZXNEaXN0YW5jZT0wOwoJCQlwaW5jaFpvb209MTsKCQkJCgkJCS8vSWYgd2Ugd2VyZSBpbiBwcm9ncmVzcyBvZiB0cmFja2luZyBhIHBvc3NpYmxlIG11bHRpIHRvdWNoIGVuZCwgdGhlbiByZSBzZXQgaXQuCgkJCWNhbmNlbE11bHRpRmluZ2VyUmVsZWFzZSgpOwoJCQkKCQkJc2V0VG91Y2hJblByb2dyZXNzKGZhbHNlKTsKCQl9CgkJCgkJCgkJLyoqCgkJKiBFdmVudCBoYW5kbGVyIGZvciBhIHRvdWNoIGxlYXZlIGV2ZW50LiAKCQkqIFRoaXMgaXMgb25seSB0cmlnZ2VyZWQgb24gZGVza3RvcHMsIGluIHRvdWNoIHdlIHdvcmsgdGhpcyBvdXQgbWFudWFsbHkKCQkqIGFzIHRoZSB0b3VjaGxlYXZlIGV2ZW50IGlzIG5vdCBzdXBwb3J0ZWQgaW4gd2Via2l0CgkJKiBAaW5uZXIKCQkqLwoJCWZ1bmN0aW9uIHRvdWNoTGVhdmUoanFFdmVudCkgewoJCQl2YXIgZXZlbnQgPSBqcUV2ZW50Lm9yaWdpbmFsRXZlbnQ7CgkJCQoJCQkvL0lmIHdlIGhhdmUgdGhlIHRyaWdnZXIgb24gbGVhdmUgcHJvcGVydHkgc2V0Li4uLgoJCQlpZihvcHRpb25zLnRyaWdnZXJPblRvdWNoTGVhdmUpIHsKCQkJCXBoYXNlID0gZ2V0TmV4dFBoYXNlKCBQSEFTRV9FTkQgKTsKCQkJCXRyaWdnZXJIYW5kbGVyKGV2ZW50LCBwaGFzZSk7CgkJCX0KCQl9CgkJCgkJLyoqCgkJKiBSZW1vdmVzIGFsbCBsaXN0ZW5lcnMgdGhhdCB3ZXJlIGFzc29jaWF0ZWQgd2l0aCB0aGUgcGx1Z2luCgkJKiBAaW5uZXIKCQkqLwoJCWZ1bmN0aW9uIHJlbW92ZUxpc3RlbmVycygpIHsKCQkJJGVsZW1lbnQudW5iaW5kKFNUQVJUX0VWLCB0b3VjaFN0YXJ0KTsKCQkJJGVsZW1lbnQudW5iaW5kKENBTkNFTF9FViwgdG91Y2hDYW5jZWwpOwoJCQkkZWxlbWVudC51bmJpbmQoTU9WRV9FViwgdG91Y2hNb3ZlKTsKCQkJJGVsZW1lbnQudW5iaW5kKEVORF9FViwgdG91Y2hFbmQpOwoJCQkKCQkJLy93ZSBvbmx5IGhhdmUgbGVhdmUgZXZlbnRzIG9uIGRlc2t0b3AsIHdlIG1hbnVhbGx5IGNhbGN1bGF0ZSBsZWF2ZSBvbiB0b3VjaCBhcyBpdHMgbm90IHN1cHBvcnRlZCBpbiB3ZWJraXQKCQkJaWYoTEVBVkVfRVYpIHsgCgkJCQkkZWxlbWVudC51bmJpbmQoTEVBVkVfRVYsIHRvdWNoTGVhdmUpOwoJCQl9CgkJCQoJCQlzZXRUb3VjaEluUHJvZ3Jlc3MoZmFsc2UpOwoJCX0KCgkJCgkJLyoqCgkJICogQ2hlY2tzIGlmIHRoZSB0aW1lIGFuZCBkaXN0YW5jZSB0aHJlc2hvbGRzIGhhdmUgYmVlbiBtZXQsIGFuZCBpZiBzbyB0aGVuIHRoZSBhcHByb3ByaWF0ZSBoYW5kbGVycyBhcmUgZmlyZWQuCgkJICovCgkJZnVuY3Rpb24gZ2V0TmV4dFBoYXNlKGN1cnJlbnRQaGFzZSkgewoJCQkKCQkJdmFyIG5leHRQaGFzZSA9IGN1cnJlbnRQaGFzZTsKCQkJCgkJCS8vIEVuc3VyZSB3ZSBoYXZlIHZhbGlkIHN3aXBlICh1bmRlciB0aW1lIGFuZCBvdmVyIGRpc3RhbmNlICBhbmQgY2hlY2sgaWYgd2UgYXJlIG91dCBvZiBib3VuZC4uLikKCQkJdmFyIHZhbGlkVGltZSA9IHZhbGlkYXRlU3dpcGVUaW1lKCk7CgkJCXZhciB2YWxpZERpc3RhbmNlID0gdmFsaWRhdGVTd2lwZURpc3RhbmNlKCk7CgkJCXZhciBkaWRDYW5jZWwgPSBkaWRTd2lwZUJhY2tUb0NhbmNlbCgpOwoJCQkJCQkKCQkJLy9JZiB3ZSBoYXZlIGV4Y2VlZGVkIG91ciB0aW1lLCB0aGVuIGNhbmNlbAkKCQkJaWYoIXZhbGlkVGltZSB8fCBkaWRDYW5jZWwpIHsKCQkJCW5leHRQaGFzZSA9IFBIQVNFX0NBTkNFTDsKCQkJfQoJCQkvL0Vsc2UgaWYgd2UgYXJlIG1vdmluZywgYW5kIGhhdmUgcmVhY2hlZCBkaXN0YW5jZSB0aGVuIGVuZAoJCQllbHNlIGlmICh2YWxpZERpc3RhbmNlICYmIGN1cnJlbnRQaGFzZSA9PSBQSEFTRV9NT1ZFICYmICghb3B0aW9ucy50cmlnZ2VyT25Ub3VjaEVuZCB8fCBvcHRpb25zLnRyaWdnZXJPblRvdWNoTGVhdmUpICkgewoJCQkJbmV4dFBoYXNlID0gUEhBU0VfRU5EOwoJCQl9IAoJCQkvL0Vsc2UgaWYgd2UgaGF2ZSBlbmRlZCBieSBsZWF2aW5nIGFuZCBkaWRuJ3QgcmVhY2ggZGlzdGFuY2UsIHRoZW4gY2FuY2VsCgkJCWVsc2UgaWYgKCF2YWxpZERpc3RhbmNlICYmIGN1cnJlbnRQaGFzZT09UEhBU0VfRU5EICYmIG9wdGlvbnMudHJpZ2dlck9uVG91Y2hMZWF2ZSkgewoJCQkJbmV4dFBoYXNlID0gUEhBU0VfQ0FOQ0VMOwoJCQl9CgkJCQoJCQlyZXR1cm4gbmV4dFBoYXNlOwoJCX0KCQkKCQkKCQkvKioKCQkqIFRyaWdnZXIgdGhlIHJlbGV2YW50IGV2ZW50IGhhbmRsZXIKCQkqIFRoZSBoYW5kbGVycyBhcmUgcGFzc2VkIHRoZSBvcmlnaW5hbCBldmVudCwgdGhlIGVsZW1lbnQgdGhhdCB3YXMgc3dpcGVkLCBhbmQgaW4gdGhlIGNhc2Ugb2YgdGhlIGNhdGNoIGFsbCBoYW5kbGVyLCB0aGUgZGlyZWN0aW9uIHRoYXQgd2FzIHN3aXBlZCwgImxlZnQiLCAicmlnaHQiLCAidXAiLCBvciAiZG93biIKCQkqIEBwYXJhbSB7b2JqZWN0fSBldmVudCB0aGUgb3JpZ2luYWwgZXZlbnQgb2JqZWN0CgkJKiBAcGFyYW0ge3N0cmluZ30gcGhhc2UgdGhlIHBoYXNlIG9mIHRoZSBzd2lwZSAoc3RhcnQsIGVuZCBjYW5jZWwgZXRjKSB7QGxpbmsgJC5mbi5zd2lwZS5waGFzZXN9CgkJKiBAaW5uZXIKCQkqLwoJCWZ1bmN0aW9uIHRyaWdnZXJIYW5kbGVyKGV2ZW50LCBwaGFzZSkgewoJCQkKCQkJdmFyIHJldCA9IHVuZGVmaW5lZDsKCQkJCgkJCS8vIFNXSVBFIEdFU1RVUkVTCgkJCWlmKGRpZFN3aXBlKCkgfHwgaGFzU3dpcGVzKCkpIHsgLy9oYXNTd2lwZXMgYXMgc3RhdHVzIG5lZWRzIHRvIGZpcmUgZXZlbiBpZiBzd2lwZSBpcyBpbnZhbGlkCgkJCQkvL1RyaWdnZXIgdGhlIHN3aXBlIGV2ZW50cy4uLgoJCQkJcmV0ID0gdHJpZ2dlckhhbmRsZXJGb3JHZXN0dXJlKGV2ZW50LCBwaGFzZSwgU1dJUEUpOwoJCQl9IAoJCQkKCQkJLy8gUElOQ0ggR0VTVFVSRVMgKGlmIHRoZSBhYm92ZSBkaWRuJ3QgY2FuY2VsKQoJCQllbHNlIGlmKChkaWRQaW5jaCgpIHx8IGhhc1BpbmNoZXMoKSkgJiYgcmV0IT09ZmFsc2UpIHsKCQkJCS8vVHJpZ2dlciB0aGUgcGluY2ggZXZlbnRzLi4uCgkJCQlyZXQgPSB0cmlnZ2VySGFuZGxlckZvckdlc3R1cmUoZXZlbnQsIHBoYXNlLCBQSU5DSCk7CgkJCX0KCQkJCgkJCS8vIENMSUNLIC8gVEFQIChpZiB0aGUgYWJvdmUgZGlkbid0IGNhbmNlbCkKCQkJaWYoZGlkRG91YmxlVGFwKCkgJiYgcmV0IT09ZmFsc2UpIHsKCQkJCS8vVHJpZ2dlciB0aGUgdGFwIGV2ZW50cy4uLgoJCQkJcmV0ID0gdHJpZ2dlckhhbmRsZXJGb3JHZXN0dXJlKGV2ZW50LCBwaGFzZSwgRE9VQkxFX1RBUCk7CgkJCX0KCQkJCgkJCS8vIENMSUNLIC8gVEFQIChpZiB0aGUgYWJvdmUgZGlkbid0IGNhbmNlbCkKCQkJZWxzZSBpZihkaWRMb25nVGFwKCkgJiYgcmV0IT09ZmFsc2UpIHsKCQkJCS8vVHJpZ2dlciB0aGUgdGFwIGV2ZW50cy4uLgoJCQkJcmV0ID0gdHJpZ2dlckhhbmRsZXJGb3JHZXN0dXJlKGV2ZW50LCBwaGFzZSwgTE9OR19UQVApOwoJCQl9CgoJCQkvLyBDTElDSyAvIFRBUCAoaWYgdGhlIGFib3ZlIGRpZG4ndCBjYW5jZWwpCgkJCWVsc2UgaWYoZGlkVGFwKCkgJiYgcmV0IT09ZmFsc2UpIHsKCQkJCS8vVHJpZ2dlciB0aGUgdGFwIGV2ZW50Li4KCQkJCXJldCA9IHRyaWdnZXJIYW5kbGVyRm9yR2VzdHVyZShldmVudCwgcGhhc2UsIFRBUCk7CgkJCX0KCQkJCgkJCQoJCQkKCQkJLy8gSWYgd2UgYXJlIGNhbmNlbGxpbmcgdGhlIGdlc3R1cmUsIHRoZW4gbWFudWFsbHkgdHJpZ2dlciB0aGUgcmVzZXQgaGFuZGxlcgoJCQlpZiAocGhhc2UgPT09IFBIQVNFX0NBTkNFTCkgewoJCQkJdG91Y2hDYW5jZWwoZXZlbnQpOwoJCQl9CgkJCQoJCQkvLyBJZiB3ZSBhcmUgZW5kaW5nIHRoZSBnZXN0dXJlLCB0aGVuIG1hbnVhbGx5IHRyaWdnZXIgdGhlIHJlc2V0IGhhbmRsZXIgSUYgYWxsIGZpbmdlcnMgYXJlIG9mZgoJCQlpZihwaGFzZSA9PT0gUEhBU0VfRU5EKSB7CgkJCQkvL0lmIHdlIHN1cHBvcnQgdG91Y2gsIHRoZW4gY2hlY2sgdGhhdCBhbGwgZmluZ2VycyBhcmUgb2ZmIGJlZm9yZSB3ZSBjYW5jZWwKCQkJCWlmIChTVVBQT1JUU19UT1VDSCkgewoJCQkJCWlmKGV2ZW50LnRvdWNoZXMubGVuZ3RoPT0wKSB7CgkJCQkJCXRvdWNoQ2FuY2VsKGV2ZW50KTsJCgkJCQkJfQoJCQkJfSAKCQkJCWVsc2UgewoJCQkJCXRvdWNoQ2FuY2VsKGV2ZW50KTsKCQkJCX0KCQkJfQoJCQkJCQoJCQlyZXR1cm4gcmV0OwoJCX0KCQkKCQkKCQkKCQkvKioKCQkqIFRyaWdnZXIgdGhlIHJlbGV2YW50IGV2ZW50IGhhbmRsZXIKCQkqIFRoZSBoYW5kbGVycyBhcmUgcGFzc2VkIHRoZSBvcmlnaW5hbCBldmVudCwgdGhlIGVsZW1lbnQgdGhhdCB3YXMgc3dpcGVkLCBhbmQgaW4gdGhlIGNhc2Ugb2YgdGhlIGNhdGNoIGFsbCBoYW5kbGVyLCB0aGUgZGlyZWN0aW9uIHRoYXQgd2FzIHN3aXBlZCwgImxlZnQiLCAicmlnaHQiLCAidXAiLCBvciAiZG93biIKCQkqIEBwYXJhbSB7b2JqZWN0fSBldmVudCB0aGUgb3JpZ2luYWwgZXZlbnQgb2JqZWN0CgkJKiBAcGFyYW0ge3N0cmluZ30gcGhhc2UgdGhlIHBoYXNlIG9mIHRoZSBzd2lwZSAoc3RhcnQsIGVuZCBjYW5jZWwgZXRjKSB7QGxpbmsgJC5mbi5zd2lwZS5waGFzZXN9CgkJKiBAcGFyYW0ge3N0cmluZ30gZ2VzdHVyZSB0aGUgZ2VzdHVyZSB0byB0cmlnZ2VyIGEgaGFuZGxlciBmb3IgOiBQSU5DSCBvciBTV0lQRSB7QGxpbmsgJC5mbi5zd2lwZS5nZXN0dXJlc30KCQkqIEByZXR1cm4gQm9vbGVhbiBGYWxzZSwgdG8gaW5kaWNhdGUgdGhhdCB0aGUgZXZlbnQgc2hvdWxkIHN0b3AgcHJvcGFnYXRpb24sIG9yIHZvaWQuCgkJKiBAaW5uZXIKCQkqLwoJCWZ1bmN0aW9uIHRyaWdnZXJIYW5kbGVyRm9yR2VzdHVyZShldmVudCwgcGhhc2UsIGdlc3R1cmUpIHsJCgkJCQoJCQl2YXIgcmV0PXVuZGVmaW5lZDsKCQkJCgkJCS8vU1dJUEVTLi4uLgoJCQlpZihnZXN0dXJlPT1TV0lQRSkgewoJCQkJLy9UcmlnZ2VyIHN0YXR1cyBldmVyeSB0aW1lLi4KCQkJCQoJCQkJLy9UcmlnZ2VyIHRoZSBldmVudC4uLgoJCQkJJGVsZW1lbnQudHJpZ2dlcignc3dpcGVTdGF0dXMnLCBbcGhhc2UsIGRpcmVjdGlvbiB8fCBudWxsLCBkaXN0YW5jZSB8fCAwLCBkdXJhdGlvbiB8fCAwLCBmaW5nZXJDb3VudCwgZmluZ2VyRGF0YV0pOwoJCQkJCgkJCQkvL0ZpcmUgdGhlIGNhbGxiYWNrCgkJCQlpZiAob3B0aW9ucy5zd2lwZVN0YXR1cykgewoJCQkJCXJldCA9IG9wdGlvbnMuc3dpcGVTdGF0dXMuY2FsbCgkZWxlbWVudCwgZXZlbnQsIHBoYXNlLCBkaXJlY3Rpb24gfHwgbnVsbCwgZGlzdGFuY2UgfHwgMCwgZHVyYXRpb24gfHwgMCwgZmluZ2VyQ291bnQsIGZpbmdlckRhdGEpOwoJCQkJCS8vSWYgdGhlIHN0YXR1cyBjYW5jZWxzLCB0aGVuIGRvbnQgcnVuIHRoZSBzdWJzZXF1ZW50IGV2ZW50IGhhbmRsZXJzLi4KCQkJCQlpZihyZXQ9PT1mYWxzZSkgcmV0dXJuIGZhbHNlOwoJCQkJfQoJCQkJCgkJCQkKCQkJCQoJCQkJCgkJCQlpZiAocGhhc2UgPT0gUEhBU0VfRU5EICYmIHZhbGlkYXRlU3dpcGUoKSkgewoJCQkJCS8vRmlyZSB0aGUgY2F0Y2ggYWxsIGV2ZW50CgkJCQkJJGVsZW1lbnQudHJpZ2dlcignc3dpcGUnLCBbZGlyZWN0aW9uLCBkaXN0YW5jZSwgZHVyYXRpb24sIGZpbmdlckNvdW50LCBmaW5nZXJEYXRhXSk7CgkJCQkJCgkJCQkJLy9GaXJlIGNhdGNoIGFsbCBjYWxsYmFjawoJCQkJCWlmIChvcHRpb25zLnN3aXBlKSB7CgkJCQkJCXJldCA9IG9wdGlvbnMuc3dpcGUuY2FsbCgkZWxlbWVudCwgZXZlbnQsIGRpcmVjdGlvbiwgZGlzdGFuY2UsIGR1cmF0aW9uLCBmaW5nZXJDb3VudCwgZmluZ2VyRGF0YSk7CgkJCQkJCS8vSWYgdGhlIHN0YXR1cyBjYW5jZWxzLCB0aGVuIGRvbnQgcnVuIHRoZSBzdWJzZXF1ZW50IGV2ZW50IGhhbmRsZXJzLi4KCQkJCQkJaWYocmV0PT09ZmFsc2UpIHJldHVybiBmYWxzZTsKCQkJCQl9CgkJCQkJCgkJCQkJLy90cmlnZ2VyIGRpcmVjdGlvbiBzcGVjaWZpYyBldmVudCBoYW5kbGVycwkKCQkJCQlzd2l0Y2ggKGRpcmVjdGlvbikgewoJCQkJCQljYXNlIExFRlQ6CgkJCQkJCQkvL1RyaWdnZXIgdGhlIGV2ZW50CgkJCQkJCQkkZWxlbWVudC50cmlnZ2VyKCdzd2lwZUxlZnQnLCBbZGlyZWN0aW9uLCBkaXN0YW5jZSwgZHVyYXRpb24sIGZpbmdlckNvdW50LCBmaW5nZXJEYXRhXSk7CgkJCQkJCgkJCQkJICAgICAgICAvL0ZpcmUgdGhlIGNhbGxiYWNrCgkJCQkJCQlpZiAob3B0aW9ucy5zd2lwZUxlZnQpIHsKCQkJCQkJCQlyZXQgPSBvcHRpb25zLnN3aXBlTGVmdC5jYWxsKCRlbGVtZW50LCBldmVudCwgZGlyZWN0aW9uLCBkaXN0YW5jZSwgZHVyYXRpb24sIGZpbmdlckNvdW50LCBmaW5nZXJEYXRhKTsKCQkJCQkJCX0KCQkJCQkJCWJyZWFrOwoJCgkJCQkJCWNhc2UgUklHSFQ6CgkJCQkJCQkvL1RyaWdnZXIgdGhlIGV2ZW50CgkJCQkJICAgICAgICAkZWxlbWVudC50cmlnZ2VyKCdzd2lwZVJpZ2h0JywgW2RpcmVjdGlvbiwgZGlzdGFuY2UsIGR1cmF0aW9uLCBmaW5nZXJDb3VudCwgZmluZ2VyRGF0YV0pOwoJCQkJCQoJCQkJCSAgICAgICAgLy9GaXJlIHRoZSBjYWxsYmFjawoJCQkJCQkJaWYgKG9wdGlvbnMuc3dpcGVSaWdodCkgewoJCQkJCQkJCXJldCA9IG9wdGlvbnMuc3dpcGVSaWdodC5jYWxsKCRlbGVtZW50LCBldmVudCwgZGlyZWN0aW9uLCBkaXN0YW5jZSwgZHVyYXRpb24sIGZpbmdlckNvdW50LCBmaW5nZXJEYXRhKTsKCQkJCQkJCX0KCQkJCQkJCWJyZWFrOwoJCgkJCQkJCWNhc2UgVVA6CgkJCQkJCQkvL1RyaWdnZXIgdGhlIGV2ZW50CgkJCQkJICAgICAgICAkZWxlbWVudC50cmlnZ2VyKCdzd2lwZVVwJywgW2RpcmVjdGlvbiwgZGlzdGFuY2UsIGR1cmF0aW9uLCBmaW5nZXJDb3VudCwgZmluZ2VyRGF0YV0pOwoJCQkJCQoJCQkJCSAgICAgICAgLy9GaXJlIHRoZSBjYWxsYmFjawoJCQkJCQkJaWYgKG9wdGlvbnMuc3dpcGVVcCkgewoJCQkJCQkJCXJldCA9IG9wdGlvbnMuc3dpcGVVcC5jYWxsKCRlbGVtZW50LCBldmVudCwgZGlyZWN0aW9uLCBkaXN0YW5jZSwgZHVyYXRpb24sIGZpbmdlckNvdW50LCBmaW5nZXJEYXRhKTsKCQkJCQkJCX0KCQkJCQkJCWJyZWFrOwoJCgkJCQkJCWNhc2UgRE9XTjoKCQkJCQkJCS8vVHJpZ2dlciB0aGUgZXZlbnQKCQkJCQkgICAgICAgICRlbGVtZW50LnRyaWdnZXIoJ3N3aXBlRG93bicsIFtkaXJlY3Rpb24sIGRpc3RhbmNlLCBkdXJhdGlvbiwgZmluZ2VyQ291bnQsIGZpbmdlckRhdGFdKTsKCQkJCQkKCQkJCQkgICAgICAgIC8vRmlyZSB0aGUgY2FsbGJhY2sKCQkJCQkJCWlmIChvcHRpb25zLnN3aXBlRG93bikgewoJCQkJCQkJCXJldCA9IG9wdGlvbnMuc3dpcGVEb3duLmNhbGwoJGVsZW1lbnQsIGV2ZW50LCBkaXJlY3Rpb24sIGRpc3RhbmNlLCBkdXJhdGlvbiwgZmluZ2VyQ291bnQsIGZpbmdlckRhdGEpOwoJCQkJCQkJfQoJCQkJCQkJYnJlYWs7CgkJCQkJfQoJCQkJfQoJCQl9CgkJCQoJCQkKCQkJLy9QSU5DSEVTLi4uLgoJCQlpZihnZXN0dXJlPT1QSU5DSCkgewoJCQkJLy9UcmlnZ2VyIHRoZSBldmVudAoJCQkgICAgICRlbGVtZW50LnRyaWdnZXIoJ3BpbmNoU3RhdHVzJywgW3BoYXNlLCBwaW5jaERpcmVjdGlvbiB8fCBudWxsLCBwaW5jaERpc3RhbmNlIHx8IDAsIGR1cmF0aW9uIHx8IDAsIGZpbmdlckNvdW50LCBwaW5jaFpvb20sIGZpbmdlckRhdGFdKTsKCQkJCQkKICAgICAgICAgICAgICAgIC8vRmlyZSB0aGUgY2FsbGJhY2sKCQkJCWlmIChvcHRpb25zLnBpbmNoU3RhdHVzKSB7CgkJCQkJcmV0ID0gb3B0aW9ucy5waW5jaFN0YXR1cy5jYWxsKCRlbGVtZW50LCBldmVudCwgcGhhc2UsIHBpbmNoRGlyZWN0aW9uIHx8IG51bGwsIHBpbmNoRGlzdGFuY2UgfHwgMCwgZHVyYXRpb24gfHwgMCwgZmluZ2VyQ291bnQsIHBpbmNoWm9vbSwgZmluZ2VyRGF0YSk7CgkJCQkJLy9JZiB0aGUgc3RhdHVzIGNhbmNlbHMsIHRoZW4gZG9udCBydW4gdGhlIHN1YnNlcXVlbnQgZXZlbnQgaGFuZGxlcnMuLgoJCQkJCWlmKHJldD09PWZhbHNlKSByZXR1cm4gZmFsc2U7CgkJCQl9CgkJCQkKCQkJCWlmKHBoYXNlPT1QSEFTRV9FTkQgJiYgdmFsaWRhdGVQaW5jaCgpKSB7CgkJCQkJCgkJCQkJc3dpdGNoIChwaW5jaERpcmVjdGlvbikgewoJCQkJCQljYXNlIElOOgoJCQkJCQkJLy9UcmlnZ2VyIHRoZSBldmVudAogICAgICAgICAgICAgICAgICAgICAgICAgICAgJGVsZW1lbnQudHJpZ2dlcigncGluY2hJbicsIFtwaW5jaERpcmVjdGlvbiB8fCBudWxsLCBwaW5jaERpc3RhbmNlIHx8IDAsIGR1cmF0aW9uIHx8IDAsIGZpbmdlckNvdW50LCBwaW5jaFpvb20sIGZpbmdlckRhdGFdKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vRmlyZSB0aGUgY2FsbGJhY2sKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvcHRpb25zLnBpbmNoSW4pIHsKCQkJCQkJCQlyZXQgPSBvcHRpb25zLnBpbmNoSW4uY2FsbCgkZWxlbWVudCwgZXZlbnQsIHBpbmNoRGlyZWN0aW9uIHx8IG51bGwsIHBpbmNoRGlzdGFuY2UgfHwgMCwgZHVyYXRpb24gfHwgMCwgZmluZ2VyQ291bnQsIHBpbmNoWm9vbSwgZmluZ2VyRGF0YSk7CgkJCQkJCQl9CgkJCQkJCQlicmVhazsKCQkJCQkJCgkJCQkJCWNhc2UgT1VUOgoJCQkJCQkJLy9UcmlnZ2VyIHRoZSBldmVudAogICAgICAgICAgICAgICAgICAgICAgICAgICAgJGVsZW1lbnQudHJpZ2dlcigncGluY2hPdXQnLCBbcGluY2hEaXJlY3Rpb24gfHwgbnVsbCwgcGluY2hEaXN0YW5jZSB8fCAwLCBkdXJhdGlvbiB8fCAwLCBmaW5nZXJDb3VudCwgcGluY2hab29tLCBmaW5nZXJEYXRhXSk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvL0ZpcmUgdGhlIGNhbGxiYWNrCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAob3B0aW9ucy5waW5jaE91dCkgewoJCQkJCQkJCXJldCA9IG9wdGlvbnMucGluY2hPdXQuY2FsbCgkZWxlbWVudCwgZXZlbnQsIHBpbmNoRGlyZWN0aW9uIHx8IG51bGwsIHBpbmNoRGlzdGFuY2UgfHwgMCwgZHVyYXRpb24gfHwgMCwgZmluZ2VyQ291bnQsIHBpbmNoWm9vbSwgZmluZ2VyRGF0YSk7CgkJCQkJCQl9CgkJCQkJCQlicmVhazsJCgkJCQkJfQoJCQkJfQoJCQl9CgkJCQoKCiAgICAgICAgICAgICAgICAKCSAgICAJCQoJCQlpZihnZXN0dXJlPT1UQVApIHsKCQkJCWlmKHBoYXNlID09PSBQSEFTRV9DQU5DRUwgfHwgcGhhc2UgPT09IFBIQVNFX0VORCkgewoJCQkJCQogICAgCQkJICAgIAogICAgCQkJICAgIC8vQ2FuY2VsIGFueSBleGlzdGluZyBkb3VibGUgdGFwCgkJCQkgICAgY2xlYXJUaW1lb3V0KHNpbmdsZVRhcFRpbWVvdXQpOwogICAgCQkJICAgIC8vQ2FuY2VsIGhvbGQgdGltZW91dAoJCQkJICAgIGNsZWFyVGltZW91dChob2xkVGltZW91dCk7CgkJCQkgICAgICAgICAgIAoJCQkJCS8vSWYgd2UgYXJlIGFsc28gbG9va2luZyBmb3IgZG91YmVsVGFwcywgd2FpdCBpbmNhc2UgdGhpcyBpcyBvbmUuLi4KCQkJCSAgICBpZihoYXNEb3VibGVUYXAoKSAmJiAhaW5Eb3VibGVUYXAoKSkgewoJCQkJICAgICAgICAvL0NhY2hlIHRoZSB0aW1lIG9mIHRoaXMgdGFwCiAgICAgICAgICAgICAgICAgICAgICAgIGRvdWJsZVRhcFN0YXJ0VGltZSA9IGdldFRpbWVTdGFtcCgpOwogICAgICAgICAgICAgICAgICAgICAgIAoJCQkJICAgICAgICAvL05vdyB3YWl0IGZvciB0aGUgZG91YmxlIHRhcCB0aW1lb3V0LCBhbmQgdHJpZ2dlciB0aGlzIHNpbmdsZSB0YXAKCQkJCSAgICAgICAgLy9pZiBpdHMgbm90IGNhbmNlbGxlZCBieSBhIGRvdWJsZSB0YXAKCQkJCSAgICAgICAgc2luZ2xlVGFwVGltZW91dCA9IHNldFRpbWVvdXQoJC5wcm94eShmdW5jdGlvbigpIHsKICAgICAgICAJCQkgICAgICAgIGRvdWJsZVRhcFN0YXJ0VGltZT1udWxsOwogICAgICAgIAkJCSAgICAgICAgLy9UcmlnZ2VyIHRoZSBldmVudAogICAgICAgICAgICAgICAgCQkJJGVsZW1lbnQudHJpZ2dlcigndGFwJywgW2V2ZW50LnRhcmdldF0pOwoKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvL0ZpcmUgdGhlIGNhbGxiYWNrCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihvcHRpb25zLnRhcCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldCA9IG9wdGlvbnMudGFwLmNhbGwoJGVsZW1lbnQsIGV2ZW50LCBldmVudC50YXJnZXQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgCQkJICAgICAgICB9LCB0aGlzKSwgb3B0aW9ucy5kb3VibGVUYXBUaHJlc2hvbGQgKTsKICAgIAkJCSAgICAJCiAgICAJCQkgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgZG91YmxlVGFwU3RhcnRUaW1lPW51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAvL1RyaWdnZXIgdGhlIGV2ZW50CiAgICAgICAgICAgICAgICAgICAgICAgICRlbGVtZW50LnRyaWdnZXIoJ3RhcCcsIFtldmVudC50YXJnZXRdKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAvL0ZpcmUgdGhlIGNhbGxiYWNrCiAgICAgICAgICAgICAgICAgICAgICAgIGlmKG9wdGlvbnMudGFwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXQgPSBvcHRpb25zLnRhcC5jYWxsKCRlbGVtZW50LCBldmVudCwgZXZlbnQudGFyZ2V0KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQoJICAgIAkJICAgIH0KCSAgICAJCX0KCQkJfQoJCQkKCQkJZWxzZSBpZiAoZ2VzdHVyZT09RE9VQkxFX1RBUCkgewoJCQkJaWYocGhhc2UgPT09IFBIQVNFX0NBTkNFTCB8fCBwaGFzZSA9PT0gUEhBU0VfRU5EKSB7CgkJCQkJLy9DYW5jZWwgYW55IHBlbmRpbmcgc2luZ2xldGFwIAoJCQkJICAgIGNsZWFyVGltZW91dChzaW5nbGVUYXBUaW1lb3V0KTsKCQkJCSAgICBkb3VibGVUYXBTdGFydFRpbWU9bnVsbDsKCQkJCSAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy9UcmlnZ2VyIHRoZSBldmVudAogICAgICAgICAgICAgICAgICAgICRlbGVtZW50LnRyaWdnZXIoJ2RvdWJsZXRhcCcsIFtldmVudC50YXJnZXRdKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vRmlyZSB0aGUgY2FsbGJhY2sKICAgICAgICAgICAgICAgICAgICBpZihvcHRpb25zLmRvdWJsZVRhcCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXQgPSBvcHRpb25zLmRvdWJsZVRhcC5jYWxsKCRlbGVtZW50LCBldmVudCwgZXZlbnQudGFyZ2V0KTsKICAgICAgICAgICAgICAgICAgICB9CgkgICAgCQl9CgkJCX0KCQkJCgkJCWVsc2UgaWYgKGdlc3R1cmU9PUxPTkdfVEFQKSB7CgkJCQlpZihwaGFzZSA9PT0gUEhBU0VfQ0FOQ0VMIHx8IHBoYXNlID09PSBQSEFTRV9FTkQpIHsKCQkJCQkvL0NhbmNlbCBhbnkgcGVuZGluZyBzaW5nbGV0YXAgKHNob3VsZG50IGJlIG9uZSkKCQkJCSAgICBjbGVhclRpbWVvdXQoc2luZ2xlVGFwVGltZW91dCk7CgkJCQkgICAgZG91YmxlVGFwU3RhcnRUaW1lPW51bGw7CgkJCQkgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vVHJpZ2dlciB0aGUgZXZlbnQKICAgICAgICAgICAgICAgICAgICAkZWxlbWVudC50cmlnZ2VyKCdsb25ndGFwJywgW2V2ZW50LnRhcmdldF0pOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy9GaXJlIHRoZSBjYWxsYmFjawogICAgICAgICAgICAgICAgICAgIGlmKG9wdGlvbnMubG9uZ1RhcCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXQgPSBvcHRpb25zLmxvbmdUYXAuY2FsbCgkZWxlbWVudCwgZXZlbnQsIGV2ZW50LnRhcmdldCk7CiAgICAgICAgICAgICAgICAgICAgfQoJICAgIAkJfQoJCQl9CQkJCQoJCQkJCgkJCXJldHVybiByZXQ7CgkJfQoKCgoJCQoJCS8vCgkJLy8gR0VTVFVSRSBWQUxJREFUSU9OCgkJLy8KCQkKCQkvKioKCQkqIENoZWNrcyB0aGUgdXNlciBoYXMgc3dpcGUgZmFyIGVub3VnaAoJCSogQHJldHVybiBCb29sZWFuIGlmIDxjb2RlPnRocmVzaG9sZDwvY29kZT4gaGFzIGJlZW4gc2V0LCByZXR1cm4gdHJ1ZSBpZiB0aGUgdGhyZXNob2xkIHdhcyBtZXQsIGVsc2UgZmFsc2UuCgkJKiBJZiBubyB0aHJlc2hvbGQgd2FzIHNldCwgdGhlbiB3ZSByZXR1cm4gdHJ1ZS4KCQkqIEBpbm5lcgoJCSovCgkJZnVuY3Rpb24gdmFsaWRhdGVTd2lwZURpc3RhbmNlKCkgewoJCQl2YXIgdmFsaWQgPSB0cnVlOwoJCQkvL0lmIHdlIG1hZGUgaXQgcGFzdCB0aGUgbWluIHN3aXBlIGRpc3RhbmNlLi4KCQkJaWYgKG9wdGlvbnMudGhyZXNob2xkICE9PSBudWxsKSB7CgkJCQl2YWxpZCA9IGRpc3RhbmNlID49IG9wdGlvbnMudGhyZXNob2xkOwoJCQl9CgkJCQogICAgICAgICAgICByZXR1cm4gdmFsaWQ7CgkJfQoJCQoJCS8qKgoJCSogQ2hlY2tzIHRoZSB1c2VyIGhhcyBzd2lwZWQgYmFjayB0byBjYW5jZWwuCgkJKiBAcmV0dXJuIEJvb2xlYW4gaWYgPGNvZGU+Y2FuY2VsVGhyZXNob2xkPC9jb2RlPiBoYXMgYmVlbiBzZXQsIHJldHVybiB0cnVlIGlmIHRoZSBjYW5jZWxUaHJlc2hvbGQgd2FzIG1ldCwgZWxzZSBmYWxzZS4KCQkqIElmIG5vIGNhbmNlbFRocmVzaG9sZCB3YXMgc2V0LCB0aGVuIHdlIHJldHVybiB0cnVlLgoJCSogQGlubmVyCgkJKi8KCQlmdW5jdGlvbiBkaWRTd2lwZUJhY2tUb0NhbmNlbCgpIHsKICAgICAgICAgICAgdmFyIGNhbmNlbGxlZCA9IGZhbHNlOwogICAgCQlpZihvcHRpb25zLmNhbmNlbFRocmVzaG9sZCAhPT0gbnVsbCAmJiBkaXJlY3Rpb24gIT09bnVsbCkgIHsKICAgIAkJICAgIGNhbmNlbGxlZCA9ICAoZ2V0TWF4RGlzdGFuY2UoIGRpcmVjdGlvbiApIC0gZGlzdGFuY2UpID49IG9wdGlvbnMuY2FuY2VsVGhyZXNob2xkOwoJCQl9CgkJCQoJCQlyZXR1cm4gY2FuY2VsbGVkOwoJCX0KCgkJLyoqCgkJKiBDaGVja3MgdGhlIHVzZXIgaGFzIHBpbmNoZWQgZmFyIGVub3VnaAoJCSogQHJldHVybiBCb29sZWFuIGlmIDxjb2RlPnBpbmNoVGhyZXNob2xkPC9jb2RlPiBoYXMgYmVlbiBzZXQsIHJldHVybiB0cnVlIGlmIHRoZSB0aHJlc2hvbGQgd2FzIG1ldCwgZWxzZSBmYWxzZS4KCQkqIElmIG5vIHRocmVzaG9sZCB3YXMgc2V0LCB0aGVuIHdlIHJldHVybiB0cnVlLgoJCSogQGlubmVyCgkJKi8KCQlmdW5jdGlvbiB2YWxpZGF0ZVBpbmNoRGlzdGFuY2UoKSB7CgkJCWlmIChvcHRpb25zLnBpbmNoVGhyZXNob2xkICE9PSBudWxsKSB7CgkJCQlyZXR1cm4gcGluY2hEaXN0YW5jZSA+PSBvcHRpb25zLnBpbmNoVGhyZXNob2xkOwoJCQl9CgkJCXJldHVybiB0cnVlOwoJCX0KCgkJLyoqCgkJKiBDaGVja3MgdGhhdCB0aGUgdGltZSB0YWtlbiB0byBzd2lwZSBtZWV0cyB0aGUgbWluaW11bSAvIG1heGltdW0gcmVxdWlyZW1lbnRzCgkJKiBAcmV0dXJuIEJvb2xlYW4KCQkqIEBpbm5lcgoJCSovCgkJZnVuY3Rpb24gdmFsaWRhdGVTd2lwZVRpbWUoKSB7CgkJCXZhciByZXN1bHQ7CgkJCS8vSWYgbm8gdGltZSBzZXQsIHRoZW4gcmV0dXJuIHRydWUKCgkJCWlmIChvcHRpb25zLm1heFRpbWVUaHJlc2hvbGQpIHsKCQkJCWlmIChkdXJhdGlvbiA+PSBvcHRpb25zLm1heFRpbWVUaHJlc2hvbGQpIHsKCQkJCQlyZXN1bHQgPSBmYWxzZTsKCQkJCX0gZWxzZSB7CgkJCQkJcmVzdWx0ID0gdHJ1ZTsKCQkJCX0KCQkJfQoJCQllbHNlIHsKCQkJCXJlc3VsdCA9IHRydWU7CgkJCX0KCgkJCXJldHVybiByZXN1bHQ7CgkJfQoKCgkJLyoqCgkJKiBDaGVja3MgZGlyZWN0aW9uIG9mIHRoZSBzd2lwZSBhbmQgdGhlIHZhbHVlIGFsbG93UGFnZVNjcm9sbCB0byBzZWUgaWYgd2Ugc2hvdWxkIGFsbG93IG9yIHByZXZlbnQgdGhlIGRlZmF1bHQgYmVoYXZpb3VyIGZyb20gb2NjdXJyaW5nLgoJCSogVGhpcyB3aWxsIGVzc2VudGlhbGx5IGFsbG93IHBhZ2Ugc2Nyb2xsaW5nIG9yIG5vdCB3aGVuIHRoZSB1c2VyIGlzIHN3aXBpbmcgb24gYSB0b3VjaFN3aXBlIG9iamVjdC4KCQkqIEBwYXJhbSB7b2JqZWN0fSBqcUV2ZW50IFRoZSBub3JtYWxpc2VkIGpRdWVyeSByZXByZXNlbnRhdGlvbiBvZiB0aGUgZXZlbnQgb2JqZWN0LgoJCSogQHBhcmFtIHtzdHJpbmd9IGRpcmVjdGlvbiBUaGUgZGlyZWN0aW9uIG9mIHRoZSBldmVudC4gU2VlIHtAbGluayAkLmZuLnN3aXBlLmRpcmVjdGlvbnN9CgkJKiBAc2VlICQuZm4uc3dpcGUuZGlyZWN0aW9ucwoJCSogQGlubmVyCgkJKi8KCQlmdW5jdGlvbiB2YWxpZGF0ZURlZmF1bHRFdmVudChqcUV2ZW50LCBkaXJlY3Rpb24pIHsKCQkJaWYgKG9wdGlvbnMuYWxsb3dQYWdlU2Nyb2xsID09PSBOT05FIHx8IGhhc1BpbmNoZXMoKSkgewoJCQkJanFFdmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQl9IGVsc2UgewoJCQkJdmFyIGF1dG8gPSBvcHRpb25zLmFsbG93UGFnZVNjcm9sbCA9PT0gQVVUTzsKCgkJCQlzd2l0Y2ggKGRpcmVjdGlvbikgewoJCQkJCWNhc2UgTEVGVDoKCQkJCQkJaWYgKChvcHRpb25zLnN3aXBlTGVmdCAmJiBhdXRvKSB8fCAoIWF1dG8gJiYgb3B0aW9ucy5hbGxvd1BhZ2VTY3JvbGwgIT0gSE9SSVpPTlRBTCkpIHsKCQkJCQkJCWpxRXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCQkJfQoJCQkJCQlicmVhazsKCgkJCQkJY2FzZSBSSUdIVDoKCQkJCQkJaWYgKChvcHRpb25zLnN3aXBlUmlnaHQgJiYgYXV0bykgfHwgKCFhdXRvICYmIG9wdGlvbnMuYWxsb3dQYWdlU2Nyb2xsICE9IEhPUklaT05UQUwpKSB7CgkJCQkJCQlqcUV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQkJCX0KCQkJCQkJYnJlYWs7CgoJCQkJCWNhc2UgVVA6CgkJCQkJCWlmICgob3B0aW9ucy5zd2lwZVVwICYmIGF1dG8pIHx8ICghYXV0byAmJiBvcHRpb25zLmFsbG93UGFnZVNjcm9sbCAhPSBWRVJUSUNBTCkpIHsKCQkJCQkJCWpxRXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCQkJfQoJCQkJCQlicmVhazsKCgkJCQkJY2FzZSBET1dOOgoJCQkJCQlpZiAoKG9wdGlvbnMuc3dpcGVEb3duICYmIGF1dG8pIHx8ICghYXV0byAmJiBvcHRpb25zLmFsbG93UGFnZVNjcm9sbCAhPSBWRVJUSUNBTCkpIHsKCQkJCQkJCWpxRXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCQkJfQoJCQkJCQlicmVhazsKCQkJCX0KCQkJfQoKCQl9CgoKCQkvLyBQSU5DSEVTCgkJLyoqCgkJICogUmV0dXJucyB0cnVlIG9mIHRoZSBjdXJyZW50IHBpbmNoIG1lZXRzIHRoZSB0aHJlc2hvbGRzCgkJICogQHJldHVybiBCb29sZWFuCgkJICogQGlubmVyCgkJKi8KCQlmdW5jdGlvbiB2YWxpZGF0ZVBpbmNoKCkgewoJCSAgICB2YXIgaGFzQ29ycmVjdEZpbmdlckNvdW50ID0gdmFsaWRhdGVGaW5nZXJzKCk7CgkJICAgIHZhciBoYXNFbmRQb2ludCA9IHZhbGlkYXRlRW5kUG9pbnQoKTsKCQkJdmFyIGhhc0NvcnJlY3REaXN0YW5jZSA9IHZhbGlkYXRlUGluY2hEaXN0YW5jZSgpOwoJCQlyZXR1cm4gaGFzQ29ycmVjdEZpbmdlckNvdW50ICYmIGhhc0VuZFBvaW50ICYmIGhhc0NvcnJlY3REaXN0YW5jZTsKCQkJCgkJfQoJCQoJCS8qKgoJCSAqIFJldHVybnMgdHJ1ZSBpZiBhbnkgUGluY2ggZXZlbnRzIGhhdmUgYmVlbiByZWdpc3RlcmVkCgkJICogQHJldHVybiBCb29sZWFuCgkJICogQGlubmVyCgkJKi8KCQlmdW5jdGlvbiBoYXNQaW5jaGVzKCkgewoJCQkvL0VudXJlIHdlIGRvbnQgcmV0dXJuIDAgb3IgbnVsbCBmb3IgZmFsc2UgdmFsdWVzCgkJCXJldHVybiAhIShvcHRpb25zLnBpbmNoU3RhdHVzIHx8IG9wdGlvbnMucGluY2hJbiB8fCBvcHRpb25zLnBpbmNoT3V0KTsKCQl9CgkJCgkJLyoqCgkJICogUmV0dXJucyB0cnVlIGlmIHdlIGFyZSBkZXRlY3RpbmcgcGluY2hlcywgYW5kIGhhdmUgb25lCgkJICogQHJldHVybiBCb29sZWFuCgkJICogQGlubmVyCgkJICovCgkJZnVuY3Rpb24gZGlkUGluY2goKSB7CgkJCS8vRW51cmUgd2UgZG9udCByZXR1cm4gMCBvciBudWxsIGZvciBmYWxzZSB2YWx1ZXMKCQkJcmV0dXJuICEhKHZhbGlkYXRlUGluY2goKSAmJiBoYXNQaW5jaGVzKCkpOwoJCX0KCgoKCgkJLy8gU1dJUEVTCgkJLyoqCgkJICogUmV0dXJucyB0cnVlIGlmIHRoZSBjdXJyZW50IHN3aXBlIG1lZXRzIHRoZSB0aHJlc2hvbGRzCgkJICogQHJldHVybiBCb29sZWFuCgkJICogQGlubmVyCgkJKi8KCQlmdW5jdGlvbiB2YWxpZGF0ZVN3aXBlKCkgewoJCQkvL0NoZWNrIHZhbGlkaXR5IG9mIHN3aXBlCgkJCXZhciBoYXNWYWxpZFRpbWUgPSB2YWxpZGF0ZVN3aXBlVGltZSgpOwoJCQl2YXIgaGFzVmFsaWREaXN0YW5jZSA9IHZhbGlkYXRlU3dpcGVEaXN0YW5jZSgpOwkKCQkJdmFyIGhhc0NvcnJlY3RGaW5nZXJDb3VudCA9IHZhbGlkYXRlRmluZ2VycygpOwoJCSAgICB2YXIgaGFzRW5kUG9pbnQgPSB2YWxpZGF0ZUVuZFBvaW50KCk7CgkJICAgIHZhciBkaWRDYW5jZWwgPSBkaWRTd2lwZUJhY2tUb0NhbmNlbCgpOwkKCQkgICAgCgkJCS8vIGlmIHRoZSB1c2VyIHN3aXBlZCBtb3JlIHRoYW4gdGhlIG1pbmltdW0gbGVuZ3RoLCBwZXJmb3JtIHRoZSBhcHByb3ByaWF0ZSBhY3Rpb24KCQkJLy8gaGFzVmFsaWREaXN0YW5jZSBpcyBudWxsIHdoZW4gbm8gZGlzdGFuY2UgaXMgc2V0IAoJCQl2YXIgdmFsaWQgPSAgIWRpZENhbmNlbCAmJiBoYXNFbmRQb2ludCAmJiBoYXNDb3JyZWN0RmluZ2VyQ291bnQgJiYgaGFzVmFsaWREaXN0YW5jZSAmJiBoYXNWYWxpZFRpbWU7CgkJCQoJCQlyZXR1cm4gdmFsaWQ7CgkJfQoJCQoJCS8qKgoJCSAqIFJldHVybnMgdHJ1ZSBpZiBhbnkgU3dpcGUgZXZlbnRzIGhhdmUgYmVlbiByZWdpc3RlcmVkCgkJICogQHJldHVybiBCb29sZWFuCgkJICogQGlubmVyCgkJKi8KCQlmdW5jdGlvbiBoYXNTd2lwZXMoKSB7CgkJCS8vRW51cmUgd2UgZG9udCByZXR1cm4gMCBvciBudWxsIGZvciBmYWxzZSB2YWx1ZXMKCQkJcmV0dXJuICEhKG9wdGlvbnMuc3dpcGUgfHwgb3B0aW9ucy5zd2lwZVN0YXR1cyB8fCBvcHRpb25zLnN3aXBlTGVmdCB8fCBvcHRpb25zLnN3aXBlUmlnaHQgfHwgb3B0aW9ucy5zd2lwZVVwIHx8IG9wdGlvbnMuc3dpcGVEb3duKTsKCQl9CgkJCgkJCgkJLyoqCgkJICogUmV0dXJucyB0cnVlIGlmIHdlIGFyZSBkZXRlY3Rpbmcgc3dpcGVzIGFuZCBoYXZlIG9uZQoJCSAqIEByZXR1cm4gQm9vbGVhbgoJCSAqIEBpbm5lcgoJCSovCgkJZnVuY3Rpb24gZGlkU3dpcGUoKSB7CgkJCS8vRW51cmUgd2UgZG9udCByZXR1cm4gMCBvciBudWxsIGZvciBmYWxzZSB2YWx1ZXMKCQkJcmV0dXJuICEhKHZhbGlkYXRlU3dpcGUoKSAmJiBoYXNTd2lwZXMoKSk7CgkJfQoKICAgICAgICAvKioKCQkgKiBSZXR1cm5zIHRydWUgaWYgd2UgaGF2ZSBtYXRjaGVkIHRoZSBudW1iZXIgb2YgZmluZ2VycyB3ZSBhcmUgbG9va2luZyBmb3IKCQkgKiBAcmV0dXJuIEJvb2xlYW4KCQkgKiBAaW5uZXIKCQkqLwogICAgICAgIGZ1bmN0aW9uIHZhbGlkYXRlRmluZ2VycygpIHsKICAgICAgICAgICAgLy9UaGUgbnVtYmVyIG9mIGZpbmdlcnMgd2Ugd2FudCB3ZXJlIG1hdGNoZWQsIG9yIG9uIGRlc2t0b3Agd2UgaWdub3JlCiAgICAJCXJldHVybiAoKGZpbmdlckNvdW50ID09PSBvcHRpb25zLmZpbmdlcnMgfHwgb3B0aW9ucy5maW5nZXJzID09PSBBTExfRklOR0VSUykgfHwgIVNVUFBPUlRTX1RPVUNIKTsKICAgIAl9CiAgICAgICAgCiAgICAgICAgLyoqCgkJICogUmV0dXJucyB0cnVlIGlmIHdlIGhhdmUgYW4gZW5kIHBvaW50IGZvciB0aGUgc3dpcGUKCQkgKiBAcmV0dXJuIEJvb2xlYW4KCQkgKiBAaW5uZXIKCQkqLwogICAgICAgIGZ1bmN0aW9uIHZhbGlkYXRlRW5kUG9pbnQoKSB7CiAgICAgICAgICAgIC8vV2UgaGF2ZSBhbiBlbmQgdmFsdWUgZm9yIHRoZSBmaW5nZXIKCQkgICAgcmV0dXJuIGZpbmdlckRhdGFbMF0uZW5kLnggIT09IDA7CiAgICAgICAgfQoKCQkvLyBUQVAgLyBDTElDSwoJCS8qKgoJCSAqIFJldHVybnMgdHJ1ZSBpZiBhIGNsaWNrIC8gdGFwIGV2ZW50cyBoYXZlIGJlZW4gcmVnaXN0ZXJlZAoJCSAqIEByZXR1cm4gQm9vbGVhbgoJCSAqIEBpbm5lcgoJCSovCgkJZnVuY3Rpb24gaGFzVGFwKCkgewoJCQkvL0VudXJlIHdlIGRvbnQgcmV0dXJuIDAgb3IgbnVsbCBmb3IgZmFsc2UgdmFsdWVzCgkJCXJldHVybiAhIShvcHRpb25zLnRhcCkgOwoJCX0KCQkKCQkvKioKCQkgKiBSZXR1cm5zIHRydWUgaWYgYSBkb3VibGUgdGFwIGV2ZW50cyBoYXZlIGJlZW4gcmVnaXN0ZXJlZAoJCSAqIEByZXR1cm4gQm9vbGVhbgoJCSAqIEBpbm5lcgoJCSovCgkJZnVuY3Rpb24gaGFzRG91YmxlVGFwKCkgewoJCQkvL0VudXJlIHdlIGRvbnQgcmV0dXJuIDAgb3IgbnVsbCBmb3IgZmFsc2UgdmFsdWVzCgkJCXJldHVybiAhIShvcHRpb25zLmRvdWJsZVRhcCkgOwoJCX0KCQkKCQkvKioKCQkgKiBSZXR1cm5zIHRydWUgaWYgYW55IGxvbmcgdGFwIGV2ZW50cyBoYXZlIGJlZW4gcmVnaXN0ZXJlZAoJCSAqIEByZXR1cm4gQm9vbGVhbgoJCSAqIEBpbm5lcgoJCSovCgkJZnVuY3Rpb24gaGFzTG9uZ1RhcCgpIHsKCQkJLy9FbnVyZSB3ZSBkb250IHJldHVybiAwIG9yIG51bGwgZm9yIGZhbHNlIHZhbHVlcwoJCQlyZXR1cm4gISEob3B0aW9ucy5sb25nVGFwKSA7CgkJfQoJCQoJCS8qKgoJCSAqIFJldHVybnMgdHJ1ZSBpZiB3ZSBjb3VsZCBiZSBpbiB0aGUgcHJvY2VzcyBvZiBhIGRvdWJsZSB0YXAgKG9uZSB0YXAgaGFzIG9jY3VycmVkLCB3ZSBhcmUgbGlzdGVuaW5nIGZvciBkb3VibGUgdGFwcywgYW5kIHRoZSB0aHJlc2hvbGQgaGFzbid0IHBhc3QuCgkJICogQHJldHVybiBCb29sZWFuCgkJICogQGlubmVyCgkJKi8KCQlmdW5jdGlvbiB2YWxpZGF0ZURvdWJsZVRhcCgpIHsKCQkgICAgaWYoZG91YmxlVGFwU3RhcnRUaW1lPT1udWxsKXsKCQkgICAgICAgIHJldHVybiBmYWxzZTsKCQkgICAgfQoJCSAgICB2YXIgbm93ID0gZ2V0VGltZVN0YW1wKCk7CgkJICAgIHJldHVybiAoaGFzRG91YmxlVGFwKCkgJiYgKChub3ctZG91YmxlVGFwU3RhcnRUaW1lKSA8PSBvcHRpb25zLmRvdWJsZVRhcFRocmVzaG9sZCkpOwoJCX0KCQkKCQkvKioKCQkgKiBSZXR1cm5zIHRydWUgaWYgd2UgY291bGQgYmUgaW4gdGhlIHByb2Nlc3Mgb2YgYSBkb3VibGUgdGFwIChvbmUgdGFwIGhhcyBvY2N1cnJlZCwgd2UgYXJlIGxpc3RlbmluZyBmb3IgZG91YmxlIHRhcHMsIGFuZCB0aGUgdGhyZXNob2xkIGhhc24ndCBwYXN0LgoJCSAqIEByZXR1cm4gQm9vbGVhbgoJCSAqIEBpbm5lcgoJCSovCgkJZnVuY3Rpb24gaW5Eb3VibGVUYXAoKSB7CgkJICAgIHJldHVybiB2YWxpZGF0ZURvdWJsZVRhcCgpOwoJCX0KCQkKCQkKCQkvKioKCQkgKiBSZXR1cm5zIHRydWUgaWYgd2UgaGF2ZSBhIHZhbGlkIHRhcAoJCSAqIEByZXR1cm4gQm9vbGVhbgoJCSAqIEBpbm5lcgoJCSovCgkJZnVuY3Rpb24gdmFsaWRhdGVUYXAoKSB7CgkJICAgIHJldHVybiAoKGZpbmdlckNvdW50ID09PSAxIHx8ICFTVVBQT1JUU19UT1VDSCkgJiYgKGlzTmFOKGRpc3RhbmNlKSB8fCBkaXN0YW5jZSA8IG9wdGlvbnMudGhyZXNob2xkKSk7CgkJfQoJCQoJCS8qKgoJCSAqIFJldHVybnMgdHJ1ZSBpZiB3ZSBoYXZlIGEgdmFsaWQgbG9uZyB0YXAKCQkgKiBAcmV0dXJuIEJvb2xlYW4KCQkgKiBAaW5uZXIKCQkqLwoJCWZ1bmN0aW9uIHZhbGlkYXRlTG9uZ1RhcCgpIHsKCQkgICAgLy9zbGlnaHQgdGhyZXNob2xkIG9uIG1vdmluZyBmaW5nZXIKICAgICAgICAgICAgcmV0dXJuICgoZHVyYXRpb24gPiBvcHRpb25zLmxvbmdUYXBUaHJlc2hvbGQpICYmIChkaXN0YW5jZSA8IERPVUJMRV9UQVBfVEhSRVNIT0xEKSk7IAoJCX0KCQkKCQkvKioKCQkgKiBSZXR1cm5zIHRydWUgaWYgd2UgYXJlIGRldGVjdGluZyB0YXBzIGFuZCBoYXZlIG9uZQoJCSAqIEByZXR1cm4gQm9vbGVhbgoJCSAqIEBpbm5lcgoJCSovCgkJZnVuY3Rpb24gZGlkVGFwKCkgewoJCSAgICAvL0VudXJlIHdlIGRvbnQgcmV0dXJuIDAgb3IgbnVsbCBmb3IgZmFsc2UgdmFsdWVzCgkJCXJldHVybiAhISh2YWxpZGF0ZVRhcCgpICYmIGhhc1RhcCgpKTsKCQl9CgkJCgkJCgkJLyoqCgkJICogUmV0dXJucyB0cnVlIGlmIHdlIGFyZSBkZXRlY3RpbmcgZG91YmxlIHRhcHMgYW5kIGhhdmUgb25lCgkJICogQHJldHVybiBCb29sZWFuCgkJICogQGlubmVyCgkJKi8KCQlmdW5jdGlvbiBkaWREb3VibGVUYXAoKSB7CgkJICAgIC8vRW51cmUgd2UgZG9udCByZXR1cm4gMCBvciBudWxsIGZvciBmYWxzZSB2YWx1ZXMKCQkJcmV0dXJuICEhKHZhbGlkYXRlRG91YmxlVGFwKCkgJiYgaGFzRG91YmxlVGFwKCkpOwoJCX0KCQkKCQkvKioKCQkgKiBSZXR1cm5zIHRydWUgaWYgd2UgYXJlIGRldGVjdGluZyBsb25nIHRhcHMgYW5kIGhhdmUgb25lCgkJICogQHJldHVybiBCb29sZWFuCgkJICogQGlubmVyCgkJKi8KCQlmdW5jdGlvbiBkaWRMb25nVGFwKCkgewoJCSAgICAvL0VudXJlIHdlIGRvbnQgcmV0dXJuIDAgb3IgbnVsbCBmb3IgZmFsc2UgdmFsdWVzCgkJCXJldHVybiAhISh2YWxpZGF0ZUxvbmdUYXAoKSAmJiBoYXNMb25nVGFwKCkpOwoJCX0KCQkKCQkKCQkKCQkKCQkvLyBNVUxUSSBGSU5HRVIgVE9VQ0gKCQkvKioKCQkgKiBTdGFydHMgdHJhY2tpbmcgdGhlIHRpbWUgYmV0d2VlbiAyIGZpbmdlciByZWxlYXNlcywgYW5kIGtlZXBzIHRyYWNrIG9mIGhvdyBtYW55IGZpbmdlcnMgd2UgaW5pdGlhbGx5IGhhZCB1cAoJCSAqIEBpbm5lcgoJCSovCgkJZnVuY3Rpb24gc3RhcnRNdWx0aUZpbmdlclJlbGVhc2UoKSB7CgkJCXByZXZpb3VzVG91Y2hFbmRUaW1lID0gZ2V0VGltZVN0YW1wKCk7CgkJCXByZXZpb3VzVG91Y2hGaW5nZXJDb3VudCA9IGV2ZW50LnRvdWNoZXMubGVuZ3RoKzE7CgkJfQoJCQoJCS8qKgoJCSAqIENhbmNlbHMgdGhlIHRyYWNraW5nIG9mIHRpbWUgYmV0d2VlbiAyIGZpbmdlciByZWxlYXNlcywgYW5kIHJlc2V0cyBjb3VudGVycwoJCSAqIEBpbm5lcgoJCSovCgkJZnVuY3Rpb24gY2FuY2VsTXVsdGlGaW5nZXJSZWxlYXNlKCkgewoJCQlwcmV2aW91c1RvdWNoRW5kVGltZSA9IDA7CgkJCXByZXZpb3VzVG91Y2hGaW5nZXJDb3VudCA9IDA7CgkJfQoJCQoJCS8qKgoJCSAqIENoZWNrcyBpZiB3ZSBhcmUgaW4gdGhlIHRocmVzaG9sZCBiZXR3ZWVuIDIgZmluZ2VycyBiZWluZyByZWxlYXNlZCAKCQkgKiBAcmV0dXJuIEJvb2xlYW4KCQkgKiBAaW5uZXIKCQkqLwoJCWZ1bmN0aW9uIGluTXVsdGlGaW5nZXJSZWxlYXNlKCkgewoJCQkKCQkJdmFyIHdpdGhpblRocmVzaG9sZCA9IGZhbHNlOwoJCQkKCQkJaWYocHJldmlvdXNUb3VjaEVuZFRpbWUpIHsJCgkJCQl2YXIgZGlmZiA9IGdldFRpbWVTdGFtcCgpIC0gcHJldmlvdXNUb3VjaEVuZFRpbWUJCgkJCQlpZiggZGlmZjw9b3B0aW9ucy5maW5nZXJSZWxlYXNlVGhyZXNob2xkICkgewoJCQkJCXdpdGhpblRocmVzaG9sZCA9IHRydWU7CgkJCQl9CgkJCX0KCQkJCgkJCXJldHVybiB3aXRoaW5UaHJlc2hvbGQ7CQoJCX0KCQkKCgkJLyoqCgkJKiBnZXRzIGEgZGF0YSBmbGFnIHRvIGluZGljYXRlIHRoYXQgYSB0b3VjaCBpcyBpbiBwcm9ncmVzcwoJCSogQHJldHVybiBCb29sZWFuCgkJKiBAaW5uZXIKCQkqLwoJCWZ1bmN0aW9uIGdldFRvdWNoSW5Qcm9ncmVzcygpIHsKCQkJLy9zdHJpY3QgZXF1YWxpdHkgdG8gZW5zdXJlIG9ubHkgdHJ1ZSBhbmQgZmFsc2UgYXJlIHJldHVybmVkCgkJCXJldHVybiAhISgkZWxlbWVudC5kYXRhKFBMVUdJTl9OUysnX2ludG91Y2gnKSA9PT0gdHJ1ZSk7CgkJfQoJCQoJCS8qKgoJCSogU2V0cyBhIGRhdGEgZmxhZyB0byBpbmRpY2F0ZSB0aGF0IGEgdG91Y2ggaXMgaW4gcHJvZ3Jlc3MKCQkqIEBwYXJhbSB7Ym9vbGVhbn0gdmFsIFRoZSB2YWx1ZSB0byBzZXQgdGhlIHByb3BlcnR5IHRvCgkJKiBAaW5uZXIKCQkqLwoJCWZ1bmN0aW9uIHNldFRvdWNoSW5Qcm9ncmVzcyh2YWwpIHsKCQkJCgkJCS8vQWRkIG9yIHJlbW92ZSBldmVudCBsaXN0ZW5lcnMgZGVwZW5kaW5nIG9uIHRvdWNoIHN0YXR1cwoJCQlpZih2YWw9PT10cnVlKSB7CgkJCQkkZWxlbWVudC5iaW5kKE1PVkVfRVYsIHRvdWNoTW92ZSk7CgkJCQkkZWxlbWVudC5iaW5kKEVORF9FViwgdG91Y2hFbmQpOwoJCQkJCgkJCQkvL3dlIG9ubHkgaGF2ZSBsZWF2ZSBldmVudHMgb24gZGVza3RvcCwgd2UgbWFudWFsbHkgY2FsY3VhdGUgbGVhdmUgb24gdG91Y2ggYXMgaXRzIG5vdCBzdXBwb3J0ZWQgaW4gd2Via2l0CgkJCQlpZihMRUFWRV9FVikgeyAKCQkJCQkkZWxlbWVudC5iaW5kKExFQVZFX0VWLCB0b3VjaExlYXZlKTsKCQkJCX0KCQkJfSBlbHNlIHsKCQkJCSRlbGVtZW50LnVuYmluZChNT1ZFX0VWLCB0b3VjaE1vdmUsIGZhbHNlKTsKCQkJCSRlbGVtZW50LnVuYmluZChFTkRfRVYsIHRvdWNoRW5kLCBmYWxzZSk7CgkJCQoJCQkJLy93ZSBvbmx5IGhhdmUgbGVhdmUgZXZlbnRzIG9uIGRlc2t0b3AsIHdlIG1hbnVhbGx5IGNhbGN1YXRlIGxlYXZlIG9uIHRvdWNoIGFzIGl0cyBub3Qgc3VwcG9ydGVkIGluIHdlYmtpdAoJCQkJaWYoTEVBVkVfRVYpIHsgCgkJCQkJJGVsZW1lbnQudW5iaW5kKExFQVZFX0VWLCB0b3VjaExlYXZlLCBmYWxzZSk7CgkJCQl9CgkJCX0KCQkJCgkJCgkJCS8vc3RyaWN0IGVxdWFsaXR5IHRvIGVuc3VyZSBvbmx5IHRydWUgYW5kIGZhbHNlIGNhbiB1cGRhdGUgdGhlIHZhbHVlCgkJCSRlbGVtZW50LmRhdGEoUExVR0lOX05TKydfaW50b3VjaCcsIHZhbCA9PT0gdHJ1ZSk7CgkJfQoJCQoJCQoJCS8qKgoJCSAqIENyZWF0ZXMgdGhlIGZpbmdlciBkYXRhIGZvciB0aGUgdG91Y2gvZmluZ2VyIGluIHRoZSBldmVudCBvYmplY3QuCgkJICogQHBhcmFtIHtpbnR9IGluZGV4IFRoZSBpbmRleCBpbiB0aGUgYXJyYXkgdG8gc3RvcmUgdGhlIGZpbmdlciBkYXRhICh1c3VhbGx5IHRoZSBvcmRlciB0aGUgZmluZ2VycyB3ZXJlIHByZXNzZWQpCgkJICogQHBhcmFtIHtvYmplY3R9IGV2dCBUaGUgZXZlbnQgb2JqZWN0IGNvbnRhaW5pbmcgZmluZ2VyIGRhdGEKCQkgKiBAcmV0dXJuIGZpbmdlciBkYXRhIG9iamVjdAoJCSAqIEBpbm5lcgoJCSovCgkJZnVuY3Rpb24gY3JlYXRlRmluZ2VyRGF0YSggaW5kZXgsIGV2dCApIHsKCQkJdmFyIGlkID0gZXZ0LmlkZW50aWZpZXIhPT11bmRlZmluZWQgPyBldnQuaWRlbnRpZmllciA6IDA7IAoJCQkKCQkJZmluZ2VyRGF0YVtpbmRleF0uaWRlbnRpZmllciA9IGlkOwoJCQlmaW5nZXJEYXRhW2luZGV4XS5zdGFydC54ID0gZmluZ2VyRGF0YVtpbmRleF0uZW5kLnggPSBldnQucGFnZVh8fGV2dC5jbGllbnRYOwoJCQlmaW5nZXJEYXRhW2luZGV4XS5zdGFydC55ID0gZmluZ2VyRGF0YVtpbmRleF0uZW5kLnkgPSBldnQucGFnZVl8fGV2dC5jbGllbnRZOwoJCQkKCQkJcmV0dXJuIGZpbmdlckRhdGFbaW5kZXhdOwoJCX0KCQkKCQkvKioKCQkgKiBVcGRhdGVzIHRoZSBmaW5nZXIgZGF0YSBmb3IgYSBwYXJ0aWN1bGFyIGV2ZW50IG9iamVjdAoJCSAqIEBwYXJhbSB7b2JqZWN0fSBldnQgVGhlIGV2ZW50IG9iamVjdCBjb250YWluaW5nIHRoZSB0b3VjaC9maW5nZXIgZGF0YSB0byB1cGFkdGUKCQkgKiBAcmV0dXJuIGEgZmluZ2VyIGRhdGEgb2JqZWN0LgoJCSAqIEBpbm5lcgoJCSovCgkJZnVuY3Rpb24gdXBkYXRlRmluZ2VyRGF0YShldnQpIHsKCQkJCgkJCXZhciBpZCA9IGV2dC5pZGVudGlmaWVyIT09dW5kZWZpbmVkID8gZXZ0LmlkZW50aWZpZXIgOiAwOyAKCQkJdmFyIGYgPSBnZXRGaW5nZXJEYXRhKCBpZCApOwoJCQkKCQkJZi5lbmQueCA9IGV2dC5wYWdlWHx8ZXZ0LmNsaWVudFg7CgkJCWYuZW5kLnkgPSBldnQucGFnZVl8fGV2dC5jbGllbnRZOwoJCQkKCQkJcmV0dXJuIGY7CgkJfQoJCQoJCS8qKgoJCSAqIFJldHVybnMgYSBmaW5nZXIgZGF0YSBvYmplY3QgYnkgaXRzIGV2ZW50IElELgoJCSAqIEVhY2ggdG91Y2ggZXZlbnQgaGFzIGFuIGlkZW50aWZpZXIgcHJvcGVydHksIHdoaWNoIGlzIHVzZWQgCgkJICogdG8gdHJhY2sgcmVwZWF0IHRvdWNoZXMKCQkgKiBAcGFyYW0ge2ludH0gaWQgVGhlIHVuaXF1ZSBpZCBvZiB0aGUgZmluZ2VyIGluIHRoZSBzZXF1ZW5jZSBvZiB0b3VjaCBldmVudHMuCgkJICogQHJldHVybiBhIGZpbmdlciBkYXRhIG9iamVjdC4KCQkgKiBAaW5uZXIKCQkqLwoJCWZ1bmN0aW9uIGdldEZpbmdlckRhdGEoIGlkICkgewoJCQlmb3IodmFyIGk9MDsgaTxmaW5nZXJEYXRhLmxlbmd0aDsgaSsrKSB7CgkJCQlpZihmaW5nZXJEYXRhW2ldLmlkZW50aWZpZXIgPT0gaWQpIHsKCQkJCQlyZXR1cm4gZmluZ2VyRGF0YVtpXTsJCgkJCQl9CgkJCX0KCQl9CgkJCgkJLyoqCgkJICogQ3JlYXRzIGFsbCB0aGUgZmluZ2VyIG9uamVjdHMgYW5kIHJldHVybnMgYW4gYXJyYXkgb2YgZmluZ2VyIGRhdGEKCQkgKiBAcmV0dXJuIEFycmF5IG9mIGZpbmdlciBvYmplY3RzCgkJICogQGlubmVyCgkJKi8KCQlmdW5jdGlvbiBjcmVhdGVBbGxGaW5nZXJEYXRhKCkgewoJCQl2YXIgZmluZ2VyRGF0YT1bXTsKCQkJZm9yICh2YXIgaT0wOyBpPD01OyBpKyspIHsKCQkJCWZpbmdlckRhdGEucHVzaCh7CgkJCQkJc3RhcnQ6eyB4OiAwLCB5OiAwIH0sCgkJCQkJZW5kOnsgeDogMCwgeTogMCB9LAoJCQkJCWlkZW50aWZpZXI6MAoJCQkJfSk7CgkJCX0KCQkJCgkJCXJldHVybiBmaW5nZXJEYXRhOwoJCX0KCQkKCQkvKioKCQkgKiBTZXRzIHRoZSBtYXhpbXVtIGRpc3RhbmNlIHN3aXBlZCBpbiB0aGUgZ2l2ZW4gZGlyZWN0aW9uLiAKCQkgKiBJZiB0aGUgbmV3IHZhbHVlIGlzIGxvd2VyIHRoYW4gdGhlIGN1cnJlbnQgdmFsdWUsIHRoZSBtYXggdmFsdWUgaXMgbm90IGNoYW5nZWQuCgkJICogQHBhcmFtIHtzdHJpbmd9ICBkaXJlY3Rpb24gVGhlIGRpcmVjdGlvbiBvZiB0aGUgc3dpcGUKCQkgKiBAcGFyYW0ge2ludH0gIGRpc3RhbmNlIFRoZSBkaXN0YW5jZSBvZiB0aGUgc3dpcGUKCQkgKiBAaW5uZXIKCQkqLwoJCWZ1bmN0aW9uIHNldE1heERpc3RhbmNlKGRpcmVjdGlvbiwgZGlzdGFuY2UpIHsKICAgIAkJZGlzdGFuY2UgPSBNYXRoLm1heChkaXN0YW5jZSwgZ2V0TWF4RGlzdGFuY2UoZGlyZWN0aW9uKSApOwogICAgCQltYXhpbXVtc01hcFtkaXJlY3Rpb25dLmRpc3RhbmNlID0gZGlzdGFuY2U7CgkJfQogICAgICAgIAogICAgICAgIC8qKgoJCSAqIGdldHMgdGhlIG1heGltdW0gZGlzdGFuY2Ugc3dpcGVkIGluIHRoZSBnaXZlbiBkaXJlY3Rpb24uIAoJCSAqIEBwYXJhbSB7c3RyaW5nfSAgZGlyZWN0aW9uIFRoZSBkaXJlY3Rpb24gb2YgdGhlIHN3aXBlCgkJICogQHJldHVybiBpbnQgIFRoZSBkaXN0YW5jZSBvZiB0aGUgc3dpcGUKCQkgKiBAaW5uZXIKCQkqLyAgICAgICAgCgkJZnVuY3Rpb24gZ2V0TWF4RGlzdGFuY2UoZGlyZWN0aW9uKSB7CgkJCWlmIChtYXhpbXVtc01hcFtkaXJlY3Rpb25dKSByZXR1cm4gbWF4aW11bXNNYXBbZGlyZWN0aW9uXS5kaXN0YW5jZTsKCQkJcmV0dXJuIHVuZGVmaW5lZDsKCQl9CgkJCgkJLyoqCgkJICogQ3JlYXRzIGEgbWFwIG9mIGRpcmVjdGlvbnMgdG8gbWF4aW11bSBzd2lwZWQgdmFsdWVzLgoJCSAqIEByZXR1cm4gT2JqZWN0IEEgZGljdGlvbmFyeSBvZiBtYXhpbXVtIHZhbHVlcywgaW5kZXhlZCBieSBkaXJlY3Rpb24uCgkJICogQGlubmVyCgkJKi8KCQlmdW5jdGlvbiBjcmVhdGVNYXhpbXVtc0RhdGEoKSB7CgkJCXZhciBtYXhEYXRhPXt9OwoJCQltYXhEYXRhW0xFRlRdPWNyZWF0ZU1heGltdW1WTyhMRUZUKTsKCQkJbWF4RGF0YVtSSUdIVF09Y3JlYXRlTWF4aW11bVZPKFJJR0hUKTsKCQkJbWF4RGF0YVtVUF09Y3JlYXRlTWF4aW11bVZPKFVQKTsKCQkJbWF4RGF0YVtET1dOXT1jcmVhdGVNYXhpbXVtVk8oRE9XTik7CgkJCQoJCQlyZXR1cm4gbWF4RGF0YTsKCQl9CgkJCgkJLyoqCgkJICogQ3JlYXRlcyBhIG1hcCBtYXhpbXVtIHN3aXBlZCB2YWx1ZXMgZm9yIGEgZ2l2ZW4gc3dpcGUgZGlyZWN0aW9uCgkJICogQHBhcmFtIHtzdHJpbmd9IFRoZSBkaXJlY3Rpb24gdGhhdCB0aGVzZSB2YWx1ZXMgd2lsbCBiZSBhc3NvY2lhdGVkIHdpdGgKCQkgKiBAcmV0dXJuIE9iamVjdCBNYXhpbXVtIHZhbHVlcwoJCSAqIEBpbm5lcgoJCSovCgkJZnVuY3Rpb24gY3JlYXRlTWF4aW11bVZPKGRpcikgewoJCSAgICByZXR1cm4geyAKCQkgICAgICAgIGRpcmVjdGlvbjpkaXIsIAoJCSAgICAgICAgZGlzdGFuY2U6MAoJCSAgICB9CgkJfQoJCQoJCQoJCS8vCgkJLy8gTUFUSFMgLyBVVElMUwoJCS8vCgoJCS8qKgoJCSogQ2FsY3VsYXRlIHRoZSBkdXJhdGlvbiBvZiB0aGUgc3dpcGUKCQkqIEByZXR1cm4gaW50CgkJKiBAaW5uZXIKCQkqLwoJCWZ1bmN0aW9uIGNhbGN1bGF0ZUR1cmF0aW9uKCkgewoJCQlyZXR1cm4gZW5kVGltZSAtIHN0YXJ0VGltZTsKCQl9CgkJCgkJLyoqCgkJKiBDYWxjdWxhdGUgdGhlIGRpc3RhbmNlIGJldHdlZW4gMiB0b3VjaGVzIChwaW5jaCkKCQkqIEBwYXJhbSB7cG9pbnR9IHN0YXJ0UG9pbnQgQSBwb2ludCBvYmplY3QgY29udGFpbmluZyB4IGFuZCB5IGNvLW9yZGluYXRlcwoJICAgICogQHBhcmFtIHtwb2ludH0gZW5kUG9pbnQgQSBwb2ludCBvYmplY3QgY29udGFpbmluZyB4IGFuZCB5IGNvLW9yZGluYXRlcwoJICAgICogQHJldHVybiBpbnQ7CgkJKiBAaW5uZXIKCQkqLwoJCWZ1bmN0aW9uIGNhbGN1bGF0ZVRvdWNoZXNEaXN0YW5jZShzdGFydFBvaW50LCBlbmRQb2ludCkgewoJCQl2YXIgZGlmZlggPSBNYXRoLmFicyhzdGFydFBvaW50LnggLSBlbmRQb2ludC54KTsKCQkJdmFyIGRpZmZZID0gTWF0aC5hYnMoc3RhcnRQb2ludC55IC0gZW5kUG9pbnQueSk7CgkJCQkKCQkJcmV0dXJuIE1hdGgucm91bmQoTWF0aC5zcXJ0KGRpZmZYKmRpZmZYK2RpZmZZKmRpZmZZKSk7CgkJfQoJCQoJCS8qKgoJCSogQ2FsY3VsYXRlIHRoZSB6b29tIGZhY3RvciBiZXR3ZWVuIHRoZSBzdGFydCBhbmQgZW5kIGRpc3RhbmNlcwoJCSogQHBhcmFtIHtpbnR9IHN0YXJ0RGlzdGFuY2UgRGlzdGFuY2UgKGJldHdlZW4gMiBmaW5nZXJzKSB0aGUgdXNlciBzdGFydGVkIHBpbmNoaW5nIGF0CgkgICAgKiBAcGFyYW0ge2ludH0gZW5kRGlzdGFuY2UgRGlzdGFuY2UgKGJldHdlZW4gMiBmaW5nZXJzKSB0aGUgdXNlciBlbmRlZCBwaW5jaGluZyBhdAoJICAgICogQHJldHVybiBmbG9hdCBUaGUgem9vbSB2YWx1ZSBmcm9tIDAgdG8gMS4KCQkqIEBpbm5lcgoJCSovCgkJZnVuY3Rpb24gY2FsY3VsYXRlUGluY2hab29tKHN0YXJ0RGlzdGFuY2UsIGVuZERpc3RhbmNlKSB7CgkJCXZhciBwZXJjZW50ID0gKGVuZERpc3RhbmNlL3N0YXJ0RGlzdGFuY2UpICogMTsKCQkJcmV0dXJuIHBlcmNlbnQudG9GaXhlZCgyKTsKCQl9CgkJCgkJCgkJLyoqCgkJKiBSZXR1cm5zIHRoZSBwaW5jaCBkaXJlY3Rpb24sIGVpdGhlciBJTiBvciBPVVQgZm9yIHRoZSBnaXZlbiBwb2ludHMKCQkqIEByZXR1cm4gc3RyaW5nIEVpdGhlciB7QGxpbmsgJC5mbi5zd2lwZS5kaXJlY3Rpb25zLklOfSBvciB7QGxpbmsgJC5mbi5zd2lwZS5kaXJlY3Rpb25zLk9VVH0KCQkqIEBzZWUgJC5mbi5zd2lwZS5kaXJlY3Rpb25zCgkJKiBAaW5uZXIKCQkqLwoJCWZ1bmN0aW9uIGNhbGN1bGF0ZVBpbmNoRGlyZWN0aW9uKCkgewoJCQlpZihwaW5jaFpvb208MSkgewoJCQkJcmV0dXJuIE9VVDsKCQkJfQoJCQllbHNlIHsKCQkJCXJldHVybiBJTjsKCQkJfQoJCX0KCQkKCQkKCQkvKioKCQkqIENhbGN1bGF0ZSB0aGUgbGVuZ3RoIC8gZGlzdGFuY2Ugb2YgdGhlIHN3aXBlCgkJKiBAcGFyYW0ge3BvaW50fSBzdGFydFBvaW50IEEgcG9pbnQgb2JqZWN0IGNvbnRhaW5pbmcgeCBhbmQgeSBjby1vcmRpbmF0ZXMKCSAgICAqIEBwYXJhbSB7cG9pbnR9IGVuZFBvaW50IEEgcG9pbnQgb2JqZWN0IGNvbnRhaW5pbmcgeCBhbmQgeSBjby1vcmRpbmF0ZXMKCSAgICAqIEByZXR1cm4gaW50CgkJKiBAaW5uZXIKCQkqLwoJCWZ1bmN0aW9uIGNhbGN1bGF0ZURpc3RhbmNlKHN0YXJ0UG9pbnQsIGVuZFBvaW50KSB7CgkJCXJldHVybiBNYXRoLnJvdW5kKE1hdGguc3FydChNYXRoLnBvdyhlbmRQb2ludC54IC0gc3RhcnRQb2ludC54LCAyKSArIE1hdGgucG93KGVuZFBvaW50LnkgLSBzdGFydFBvaW50LnksIDIpKSk7CgkJfQoKCQkvKioKCQkqIENhbGN1bGF0ZSB0aGUgYW5nbGUgb2YgdGhlIHN3aXBlCgkJKiBAcGFyYW0ge3BvaW50fSBzdGFydFBvaW50IEEgcG9pbnQgb2JqZWN0IGNvbnRhaW5pbmcgeCBhbmQgeSBjby1vcmRpbmF0ZXMKCSAgICAqIEBwYXJhbSB7cG9pbnR9IGVuZFBvaW50IEEgcG9pbnQgb2JqZWN0IGNvbnRhaW5pbmcgeCBhbmQgeSBjby1vcmRpbmF0ZXMKCSAgICAqIEByZXR1cm4gaW50CgkJKiBAaW5uZXIKCQkqLwoJCWZ1bmN0aW9uIGNhbGN1bGF0ZUFuZ2xlKHN0YXJ0UG9pbnQsIGVuZFBvaW50KSB7CgkJCXZhciB4ID0gc3RhcnRQb2ludC54IC0gZW5kUG9pbnQueDsKCQkJdmFyIHkgPSBlbmRQb2ludC55IC0gc3RhcnRQb2ludC55OwoJCQl2YXIgciA9IE1hdGguYXRhbjIoeSwgeCk7IC8vcmFkaWFucwoJCQl2YXIgYW5nbGUgPSBNYXRoLnJvdW5kKHIgKiAxODAgLyBNYXRoLlBJKTsgLy9kZWdyZWVzCgoJCQkvL2Vuc3VyZSB2YWx1ZSBpcyBwb3NpdGl2ZQoJCQlpZiAoYW5nbGUgPCAwKSB7CgkJCQlhbmdsZSA9IDM2MCAtIE1hdGguYWJzKGFuZ2xlKTsKCQkJfQoKCQkJcmV0dXJuIGFuZ2xlOwoJCX0KCgkJLyoqCgkJKiBDYWxjdWxhdGUgdGhlIGRpcmVjdGlvbiBvZiB0aGUgc3dpcGUKCQkqIFRoaXMgd2lsbCBhbHNvIGNhbGwgY2FsY3VsYXRlQW5nbGUgdG8gZ2V0IHRoZSBsYXRlc3QgYW5nbGUgb2Ygc3dpcGUKCQkqIEBwYXJhbSB7cG9pbnR9IHN0YXJ0UG9pbnQgQSBwb2ludCBvYmplY3QgY29udGFpbmluZyB4IGFuZCB5IGNvLW9yZGluYXRlcwoJICAgICogQHBhcmFtIHtwb2ludH0gZW5kUG9pbnQgQSBwb2ludCBvYmplY3QgY29udGFpbmluZyB4IGFuZCB5IGNvLW9yZGluYXRlcwoJICAgICogQHJldHVybiBzdHJpbmcgRWl0aGVyIHtAbGluayAkLmZuLnN3aXBlLmRpcmVjdGlvbnMuTEVGVH0gLyB7QGxpbmsgJC5mbi5zd2lwZS5kaXJlY3Rpb25zLlJJR0hUfSAvIHtAbGluayAkLmZuLnN3aXBlLmRpcmVjdGlvbnMuRE9XTn0gLyB7QGxpbmsgJC5mbi5zd2lwZS5kaXJlY3Rpb25zLlVQfQoJCSogQHNlZSAkLmZuLnN3aXBlLmRpcmVjdGlvbnMKCQkqIEBpbm5lcgoJCSovCgkJZnVuY3Rpb24gY2FsY3VsYXRlRGlyZWN0aW9uKHN0YXJ0UG9pbnQsIGVuZFBvaW50ICkgewoJCQl2YXIgYW5nbGUgPSBjYWxjdWxhdGVBbmdsZShzdGFydFBvaW50LCBlbmRQb2ludCk7CgoJCQlpZiAoKGFuZ2xlIDw9IDQ1KSAmJiAoYW5nbGUgPj0gMCkpIHsKCQkJCXJldHVybiBMRUZUOwoJCQl9IGVsc2UgaWYgKChhbmdsZSA8PSAzNjApICYmIChhbmdsZSA+PSAzMTUpKSB7CgkJCQlyZXR1cm4gTEVGVDsKCQkJfSBlbHNlIGlmICgoYW5nbGUgPj0gMTM1KSAmJiAoYW5nbGUgPD0gMjI1KSkgewoJCQkJcmV0dXJuIFJJR0hUOwoJCQl9IGVsc2UgaWYgKChhbmdsZSA+IDQ1KSAmJiAoYW5nbGUgPCAxMzUpKSB7CgkJCQlyZXR1cm4gRE9XTjsKCQkJfSBlbHNlIHsKCQkJCXJldHVybiBVUDsKCQkJfQoJCX0KCQkKCgkJLyoqCgkJKiBSZXR1cm5zIGEgTVMgdGltZSBzdGFtcCBvZiB0aGUgY3VycmVudCB0aW1lCgkJKiBAcmV0dXJuIGludAoJCSogQGlubmVyCgkJKi8KCQlmdW5jdGlvbiBnZXRUaW1lU3RhbXAoKSB7CgkJCXZhciBub3cgPSBuZXcgRGF0ZSgpOwoJCQlyZXR1cm4gbm93LmdldFRpbWUoKTsKCQl9CgkJCgkJCgkJCgkJLyoqCgkJICogUmV0dXJucyBhIGJvdW5kcyBvYmplY3Qgd2l0aCBsZWZ0LCByaWdodCwgdG9wIGFuZCBib3R0b20gcHJvcGVydGllcyBmb3IgdGhlIGVsZW1lbnQgc3BlY2lmaWVkLgoJCSAqIEBwYXJhbSB7RG9tTm9kZX0gVGhlIERPTSBub2RlIHRvIGdldCB0aGUgYm91bmRzIGZvci4KCQkgKi8KCQlmdW5jdGlvbiBnZXRib3VuZHMoIGVsICkgewoJCQllbCA9ICQoZWwpOwoJCQl2YXIgb2Zmc2V0ID0gZWwub2Zmc2V0KCk7CgkJCQoJCQl2YXIgYm91bmRzID0gewkKCQkJCQlsZWZ0Om9mZnNldC5sZWZ0LAoJCQkJCXJpZ2h0Om9mZnNldC5sZWZ0K2VsLm91dGVyV2lkdGgoKSwKCQkJCQl0b3A6b2Zmc2V0LnRvcCwKCQkJCQlib3R0b206b2Zmc2V0LnRvcCtlbC5vdXRlckhlaWdodCgpCgkJCQkJfQoJCQkKCQkJcmV0dXJuIGJvdW5kczsJCgkJfQoJCQoJCQoJCS8qKgoJCSAqIENoZWNrcyBpZiB0aGUgcG9pbnQgb2JqZWN0IGlzIGluIHRoZSBib3VuZHMgb2JqZWN0LgoJCSAqIEBwYXJhbSB7b2JqZWN0fSBwb2ludCBBIHBvaW50IG9iamVjdC4KCQkgKiBAcGFyYW0ge2ludH0gcG9pbnQueCBUaGUgeCB2YWx1ZSBvZiB0aGUgcG9pbnQuCgkJICogQHBhcmFtIHtpbnR9IHBvaW50LnkgVGhlIHggdmFsdWUgb2YgdGhlIHBvaW50LgoJCSAqIEBwYXJhbSB7b2JqZWN0fSBib3VuZHMgVGhlIGJvdW5kcyBvYmplY3QgdG8gdGVzdAoJCSAqIEBwYXJhbSB7aW50fSBib3VuZHMubGVmdCBUaGUgbGVmdG1vc3QgdmFsdWUKCQkgKiBAcGFyYW0ge2ludH0gYm91bmRzLnJpZ2h0IFRoZSByaWdodHRtb3N0IHZhbHVlCgkJICogQHBhcmFtIHtpbnR9IGJvdW5kcy50b3AgVGhlIHRvcG1vc3QgdmFsdWUKCQkqIEBwYXJhbSB7aW50fSBib3VuZHMuYm90dG9tIFRoZSBib3R0b21tb3N0IHZhbHVlCgkJICovCgkJZnVuY3Rpb24gaXNJbkJvdW5kcyhwb2ludCwgYm91bmRzKSB7CgkJCXJldHVybiAocG9pbnQueCA+IGJvdW5kcy5sZWZ0ICYmIHBvaW50LnggPCBib3VuZHMucmlnaHQgJiYgcG9pbnQueSA+IGJvdW5kcy50b3AgJiYgcG9pbnQueSA8IGJvdW5kcy5ib3R0b20pOwoJCX07CgkKCQoJfQoJCgkKCgovKioKICogQSBjYXRjaCBhbGwgaGFuZGxlciB0aGF0IGlzIHRyaWdnZXJlZCBmb3IgYWxsIHN3aXBlIGRpcmVjdGlvbnMuIAogKiBAbmFtZSAkLmZuLnN3aXBlI3N3aXBlCiAqIEBldmVudAogKiBAZGVmYXVsdCBudWxsCiAqIEBwYXJhbSB7RXZlbnRPYmplY3R9IGV2ZW50IFRoZSBvcmlnaW5hbCBldmVudCBvYmplY3QKICogQHBhcmFtIHtpbnR9IGRpcmVjdGlvbiBUaGUgZGlyZWN0aW9uIHRoZSB1c2VyIHN3aXBlZCBpbi4gU2VlIHtAbGluayAkLmZuLnN3aXBlLmRpcmVjdGlvbnN9CiAqIEBwYXJhbSB7aW50fSBkaXN0YW5jZSBUaGUgZGlzdGFuY2UgdGhlIHVzZXIgc3dpcGVkCiAqIEBwYXJhbSB7aW50fSBkdXJhdGlvbiBUaGUgZHVyYXRpb24gb2YgdGhlIHN3aXBlIGluIG1pbGxpc2Vjb25kcwogKiBAcGFyYW0ge2ludH0gZmluZ2VyQ291bnQgVGhlIG51bWJlciBvZiBmaW5nZXJzIHVzZWQuIFNlZSB7QGxpbmsgJC5mbi5zd2lwZS5maW5nZXJzfQogKiBAcGFyYW0ge29iamVjdH0gZmluZ2VyRGF0YSBUaGUgY29vcmRpbmF0ZXMgb2YgZmluZ2VycyBpbiBldmVudAogKi8KIAoKCgovKioKICogQSBoYW5kbGVyIHRoYXQgaXMgdHJpZ2dlcmVkIGZvciAibGVmdCIgc3dpcGVzLgogKiBAbmFtZSAkLmZuLnN3aXBlI3N3aXBlTGVmdAogKiBAZXZlbnQKICogQGRlZmF1bHQgbnVsbAogKiBAcGFyYW0ge0V2ZW50T2JqZWN0fSBldmVudCBUaGUgb3JpZ2luYWwgZXZlbnQgb2JqZWN0CiAqIEBwYXJhbSB7aW50fSBkaXJlY3Rpb24gVGhlIGRpcmVjdGlvbiB0aGUgdXNlciBzd2lwZWQgaW4uIFNlZSB7QGxpbmsgJC5mbi5zd2lwZS5kaXJlY3Rpb25zfQogKiBAcGFyYW0ge2ludH0gZGlzdGFuY2UgVGhlIGRpc3RhbmNlIHRoZSB1c2VyIHN3aXBlZAogKiBAcGFyYW0ge2ludH0gZHVyYXRpb24gVGhlIGR1cmF0aW9uIG9mIHRoZSBzd2lwZSBpbiBtaWxsaXNlY29uZHMKICogQHBhcmFtIHtpbnR9IGZpbmdlckNvdW50IFRoZSBudW1iZXIgb2YgZmluZ2VycyB1c2VkLiBTZWUge0BsaW5rICQuZm4uc3dpcGUuZmluZ2Vyc30KICogQHBhcmFtIHtvYmplY3R9IGZpbmdlckRhdGEgVGhlIGNvb3JkaW5hdGVzIG9mIGZpbmdlcnMgaW4gZXZlbnQKICovCiAKLyoqCiAqIEEgaGFuZGxlciB0aGF0IGlzIHRyaWdnZXJlZCBmb3IgInJpZ2h0IiBzd2lwZXMuCiAqIEBuYW1lICQuZm4uc3dpcGUjc3dpcGVSaWdodAogKiBAZXZlbnQKICogQGRlZmF1bHQgbnVsbAogKiBAcGFyYW0ge0V2ZW50T2JqZWN0fSBldmVudCBUaGUgb3JpZ2luYWwgZXZlbnQgb2JqZWN0CiAqIEBwYXJhbSB7aW50fSBkaXJlY3Rpb24gVGhlIGRpcmVjdGlvbiB0aGUgdXNlciBzd2lwZWQgaW4uIFNlZSB7QGxpbmsgJC5mbi5zd2lwZS5kaXJlY3Rpb25zfQogKiBAcGFyYW0ge2ludH0gZGlzdGFuY2UgVGhlIGRpc3RhbmNlIHRoZSB1c2VyIHN3aXBlZAogKiBAcGFyYW0ge2ludH0gZHVyYXRpb24gVGhlIGR1cmF0aW9uIG9mIHRoZSBzd2lwZSBpbiBtaWxsaXNlY29uZHMKICogQHBhcmFtIHtpbnR9IGZpbmdlckNvdW50IFRoZSBudW1iZXIgb2YgZmluZ2VycyB1c2VkLiBTZWUge0BsaW5rICQuZm4uc3dpcGUuZmluZ2Vyc30KICogQHBhcmFtIHtvYmplY3R9IGZpbmdlckRhdGEgVGhlIGNvb3JkaW5hdGVzIG9mIGZpbmdlcnMgaW4gZXZlbnQKICovCgovKioKICogQSBoYW5kbGVyIHRoYXQgaXMgdHJpZ2dlcmVkIGZvciAidXAiIHN3aXBlcy4KICogQG5hbWUgJC5mbi5zd2lwZSNzd2lwZVVwCiAqIEBldmVudAogKiBAZGVmYXVsdCBudWxsCiAqIEBwYXJhbSB7RXZlbnRPYmplY3R9IGV2ZW50IFRoZSBvcmlnaW5hbCBldmVudCBvYmplY3QKICogQHBhcmFtIHtpbnR9IGRpcmVjdGlvbiBUaGUgZGlyZWN0aW9uIHRoZSB1c2VyIHN3aXBlZCBpbi4gU2VlIHtAbGluayAkLmZuLnN3aXBlLmRpcmVjdGlvbnN9CiAqIEBwYXJhbSB7aW50fSBkaXN0YW5jZSBUaGUgZGlzdGFuY2UgdGhlIHVzZXIgc3dpcGVkCiAqIEBwYXJhbSB7aW50fSBkdXJhdGlvbiBUaGUgZHVyYXRpb24gb2YgdGhlIHN3aXBlIGluIG1pbGxpc2Vjb25kcwogKiBAcGFyYW0ge2ludH0gZmluZ2VyQ291bnQgVGhlIG51bWJlciBvZiBmaW5nZXJzIHVzZWQuIFNlZSB7QGxpbmsgJC5mbi5zd2lwZS5maW5nZXJzfQogKiBAcGFyYW0ge29iamVjdH0gZmluZ2VyRGF0YSBUaGUgY29vcmRpbmF0ZXMgb2YgZmluZ2VycyBpbiBldmVudAogKi8KIAovKioKICogQSBoYW5kbGVyIHRoYXQgaXMgdHJpZ2dlcmVkIGZvciAiZG93biIgc3dpcGVzLgogKiBAbmFtZSAkLmZuLnN3aXBlI3N3aXBlRG93bgogKiBAZXZlbnQKICogQGRlZmF1bHQgbnVsbAogKiBAcGFyYW0ge0V2ZW50T2JqZWN0fSBldmVudCBUaGUgb3JpZ2luYWwgZXZlbnQgb2JqZWN0CiAqIEBwYXJhbSB7aW50fSBkaXJlY3Rpb24gVGhlIGRpcmVjdGlvbiB0aGUgdXNlciBzd2lwZWQgaW4uIFNlZSB7QGxpbmsgJC5mbi5zd2lwZS5kaXJlY3Rpb25zfQogKiBAcGFyYW0ge2ludH0gZGlzdGFuY2UgVGhlIGRpc3RhbmNlIHRoZSB1c2VyIHN3aXBlZAogKiBAcGFyYW0ge2ludH0gZHVyYXRpb24gVGhlIGR1cmF0aW9uIG9mIHRoZSBzd2lwZSBpbiBtaWxsaXNlY29uZHMKICogQHBhcmFtIHtpbnR9IGZpbmdlckNvdW50IFRoZSBudW1iZXIgb2YgZmluZ2VycyB1c2VkLiBTZWUge0BsaW5rICQuZm4uc3dpcGUuZmluZ2Vyc30KICogQHBhcmFtIHtvYmplY3R9IGZpbmdlckRhdGEgVGhlIGNvb3JkaW5hdGVzIG9mIGZpbmdlcnMgaW4gZXZlbnQKICovCiAKLyoqCiAqIEEgaGFuZGxlciB0cmlnZ2VyZWQgZm9yIGV2ZXJ5IHBoYXNlIG9mIHRoZSBzd2lwZS4gVGhpcyBoYW5kbGVyIGlzIGNvbnN0YW50bHkgZmlyZWQgZm9yIHRoZSBkdXJhdGlvbiBvZiB0aGUgcGluY2guCiAqIFRoaXMgaXMgdHJpZ2dlcmVkIHJlZ2FyZGxlc3Mgb2Ygc3dpcGUgdGhyZXNob2xkcy4KICogQG5hbWUgJC5mbi5zd2lwZSNzd2lwZVN0YXR1cwogKiBAZXZlbnQKICogQGRlZmF1bHQgbnVsbAogKiBAcGFyYW0ge0V2ZW50T2JqZWN0fSBldmVudCBUaGUgb3JpZ2luYWwgZXZlbnQgb2JqZWN0CiAqIEBwYXJhbSB7c3RyaW5nfSBwaGFzZSBUaGUgcGhhc2Ugb2YgdGhlIHN3aXBlIGV2ZW50LiBTZWUge0BsaW5rICQuZm4uc3dpcGUucGhhc2VzfQogKiBAcGFyYW0ge3N0cmluZ30gZGlyZWN0aW9uIFRoZSBkaXJlY3Rpb24gdGhlIHVzZXIgc3dpcGVkIGluLiBUaGlzIGlzIG51bGwgaWYgdGhlIHVzZXIgaGFzIHlldCB0byBtb3ZlLiBTZWUge0BsaW5rICQuZm4uc3dpcGUuZGlyZWN0aW9uc30KICogQHBhcmFtIHtpbnR9IGRpc3RhbmNlIFRoZSBkaXN0YW5jZSB0aGUgdXNlciBzd2lwZWQuIFRoaXMgaXMgMCBpZiB0aGUgdXNlciBoYXMgeWV0IHRvIG1vdmUuCiAqIEBwYXJhbSB7aW50fSBkdXJhdGlvbiBUaGUgZHVyYXRpb24gb2YgdGhlIHN3aXBlIGluIG1pbGxpc2Vjb25kcwogKiBAcGFyYW0ge2ludH0gZmluZ2VyQ291bnQgVGhlIG51bWJlciBvZiBmaW5nZXJzIHVzZWQuIFNlZSB7QGxpbmsgJC5mbi5zd2lwZS5maW5nZXJzfQogKiBAcGFyYW0ge29iamVjdH0gZmluZ2VyRGF0YSBUaGUgY29vcmRpbmF0ZXMgb2YgZmluZ2VycyBpbiBldmVudAogKi8KIAovKioKICogQSBoYW5kbGVyIHRyaWdnZXJlZCBmb3IgcGluY2ggaW4gZXZlbnRzLgogKiBAbmFtZSAkLmZuLnN3aXBlI3BpbmNoSW4KICogQGV2ZW50CiAqIEBkZWZhdWx0IG51bGwKICogQHBhcmFtIHtFdmVudE9iamVjdH0gZXZlbnQgVGhlIG9yaWdpbmFsIGV2ZW50IG9iamVjdAogKiBAcGFyYW0ge2ludH0gZGlyZWN0aW9uIFRoZSBkaXJlY3Rpb24gdGhlIHVzZXIgcGluY2hlZCBpbi4gU2VlIHtAbGluayAkLmZuLnN3aXBlLmRpcmVjdGlvbnN9CiAqIEBwYXJhbSB7aW50fSBkaXN0YW5jZSBUaGUgZGlzdGFuY2UgdGhlIHVzZXIgcGluY2hlZAogKiBAcGFyYW0ge2ludH0gZHVyYXRpb24gVGhlIGR1cmF0aW9uIG9mIHRoZSBzd2lwZSBpbiBtaWxsaXNlY29uZHMKICogQHBhcmFtIHtpbnR9IGZpbmdlckNvdW50IFRoZSBudW1iZXIgb2YgZmluZ2VycyB1c2VkLiBTZWUge0BsaW5rICQuZm4uc3dpcGUuZmluZ2Vyc30KICogQHBhcmFtIHtpbnR9IHpvb20gVGhlIHpvb20vc2NhbGUgbGV2ZWwgdGhlIHVzZXIgcGluY2hlZCB0b28sIDAtMS4KICogQHBhcmFtIHtvYmplY3R9IGZpbmdlckRhdGEgVGhlIGNvb3JkaW5hdGVzIG9mIGZpbmdlcnMgaW4gZXZlbnQKICovCgovKioKICogQSBoYW5kbGVyIHRyaWdnZXJlZCBmb3IgcGluY2ggb3V0IGV2ZW50cy4KICogQG5hbWUgJC5mbi5zd2lwZSNwaW5jaE91dAogKiBAZXZlbnQKICogQGRlZmF1bHQgbnVsbAogKiBAcGFyYW0ge0V2ZW50T2JqZWN0fSBldmVudCBUaGUgb3JpZ2luYWwgZXZlbnQgb2JqZWN0CiAqIEBwYXJhbSB7aW50fSBkaXJlY3Rpb24gVGhlIGRpcmVjdGlvbiB0aGUgdXNlciBwaW5jaGVkIGluLiBTZWUge0BsaW5rICQuZm4uc3dpcGUuZGlyZWN0aW9uc30KICogQHBhcmFtIHtpbnR9IGRpc3RhbmNlIFRoZSBkaXN0YW5jZSB0aGUgdXNlciBwaW5jaGVkCiAqIEBwYXJhbSB7aW50fSBkdXJhdGlvbiBUaGUgZHVyYXRpb24gb2YgdGhlIHN3aXBlIGluIG1pbGxpc2Vjb25kcwogKiBAcGFyYW0ge2ludH0gZmluZ2VyQ291bnQgVGhlIG51bWJlciBvZiBmaW5nZXJzIHVzZWQuIFNlZSB7QGxpbmsgJC5mbi5zd2lwZS5maW5nZXJzfQogKiBAcGFyYW0ge2ludH0gem9vbSBUaGUgem9vbS9zY2FsZSBsZXZlbCB0aGUgdXNlciBwaW5jaGVkIHRvbywgMC0xLgogKiBAcGFyYW0ge29iamVjdH0gZmluZ2VyRGF0YSBUaGUgY29vcmRpbmF0ZXMgb2YgZmluZ2VycyBpbiBldmVudAogKi8gCgovKioKICogQSBoYW5kbGVyIHRyaWdnZXJlZCBmb3IgYWxsIHBpbmNoIGV2ZW50cy4gVGhpcyBoYW5kbGVyIGlzIGNvbnN0YW50bHkgZmlyZWQgZm9yIHRoZSBkdXJhdGlvbiBvZiB0aGUgcGluY2guIFRoaXMgaXMgdHJpZ2dlcmVkIHJlZ2FyZGxlc3Mgb2YgdGhyZXNob2xkcy4KICogQG5hbWUgJC5mbi5zd2lwZSNwaW5jaFN0YXR1cwogKiBAZXZlbnQKICogQGRlZmF1bHQgbnVsbAogKiBAcGFyYW0ge0V2ZW50T2JqZWN0fSBldmVudCBUaGUgb3JpZ2luYWwgZXZlbnQgb2JqZWN0CiAqIEBwYXJhbSB7aW50fSBkaXJlY3Rpb24gVGhlIGRpcmVjdGlvbiB0aGUgdXNlciBwaW5jaGVkIGluLiBTZWUge0BsaW5rICQuZm4uc3dpcGUuZGlyZWN0aW9uc30KICogQHBhcmFtIHtpbnR9IGRpc3RhbmNlIFRoZSBkaXN0YW5jZSB0aGUgdXNlciBwaW5jaGVkCiAqIEBwYXJhbSB7aW50fSBkdXJhdGlvbiBUaGUgZHVyYXRpb24gb2YgdGhlIHN3aXBlIGluIG1pbGxpc2Vjb25kcwogKiBAcGFyYW0ge2ludH0gZmluZ2VyQ291bnQgVGhlIG51bWJlciBvZiBmaW5nZXJzIHVzZWQuIFNlZSB7QGxpbmsgJC5mbi5zd2lwZS5maW5nZXJzfQogKiBAcGFyYW0ge2ludH0gem9vbSBUaGUgem9vbS9zY2FsZSBsZXZlbCB0aGUgdXNlciBwaW5jaGVkIHRvbywgMC0xLgogKiBAcGFyYW0ge29iamVjdH0gZmluZ2VyRGF0YSBUaGUgY29vcmRpbmF0ZXMgb2YgZmluZ2VycyBpbiBldmVudAogKi8KCi8qKgogKiBBIGNsaWNrIGhhbmRsZXIgdHJpZ2dlcmVkIHdoZW4gYSB1c2VyIHNpbXBseSBjbGlja3MsIHJhdGhlciB0aGFuIHN3aXBlcyBvbiBhbiBlbGVtZW50LgogKiBUaGlzIGlzIGRlcHJlY2F0ZWQgc2luY2UgdmVyc2lvbiAxLjYuMiwgYW55IGFzc2lnbm1lbnQgdG8gY2xpY2sgd2lsbCBiZSBhc3NpZ25lZCB0byB0aGUgdGFwIGhhbmRsZXIuCiAqIFlvdSBjYW5ub3QgdXNlIDxjb2RlPm9uPC9jb2RlPiB0byBiaW5kIHRvIHRoaXMgZXZlbnQgYXMgdGhlIGRlZmF1bHQgalEgPGNvZGU+Y2xpY2s8L2NvZGU+IGV2ZW50IHdpbGwgYmUgdHJpZ2dlcmVkLgogKiBVc2UgdGhlIDxjb2RlPnRhcDwvY29kZT4gZXZlbnQgaW5zdGVhZC4KICogQG5hbWUgJC5mbi5zd2lwZSNjbGljawogKiBAZXZlbnQKICogQGRlcHJlY2F0ZWQgc2luY2UgdmVyc2lvbiAxLjYuMiwgcGxlYXNlIHVzZSB7QGxpbmsgJC5mbi5zd2lwZSN0YXB9IGluc3RlYWQgCiAqIEBkZWZhdWx0IG51bGwKICogQHBhcmFtIHtFdmVudE9iamVjdH0gZXZlbnQgVGhlIG9yaWdpbmFsIGV2ZW50IG9iamVjdAogKiBAcGFyYW0ge0RvbU9iamVjdH0gdGFyZ2V0IFRoZSBlbGVtZW50IGNsaWNrZWQgb24uCiAqLwogCiAvKioKICogQSBjbGljayAvIHRhcCBoYW5kbGVyIHRyaWdnZXJlZCB3aGVuIGEgdXNlciBzaW1wbHkgY2xpY2tzIG9yIHRhcHMsIHJhdGhlciB0aGFuIHN3aXBlcyBvbiBhbiBlbGVtZW50LgogKiBAbmFtZSAkLmZuLnN3aXBlI3RhcAogKiBAZXZlbnQKICogQGRlZmF1bHQgbnVsbAogKiBAcGFyYW0ge0V2ZW50T2JqZWN0fSBldmVudCBUaGUgb3JpZ2luYWwgZXZlbnQgb2JqZWN0CiAqIEBwYXJhbSB7RG9tT2JqZWN0fSB0YXJnZXQgVGhlIGVsZW1lbnQgY2xpY2tlZCBvbi4KICovCiAKLyoqCiAqIEEgZG91YmxlIHRhcCBoYW5kbGVyIHRyaWdnZXJlZCB3aGVuIGEgdXNlciBkb3VibGUgY2xpY2tzIG9yIHRhcHMgb24gYW4gZWxlbWVudC4KICogWW91IGNhbiBzZXQgdGhlIHRpbWUgZGVsYXkgZm9yIGEgZG91YmxlIHRhcCB3aXRoIHRoZSB7QGxpbmsgJC5mbi5zd2lwZS5kZWZhdWx0cyNkb3VibGVUYXBUaHJlc2hvbGR9IHByb3BlcnR5LiAKICogTm90ZTogSWYgeW91IHNldCBib3RoIDxjb2RlPmRvdWJsZVRhcDwvY29kZT4gYW5kIDxjb2RlPnRhcDwvY29kZT4gaGFuZGxlcnMsIHRoZSA8Y29kZT50YXA8L2NvZGU+IGV2ZW50IHdpbGwgYmUgZGVsYXllZCBieSB0aGUgPGNvZGU+ZG91YmxlVGFwVGhyZXNob2xkPC9jb2RlPgogKiBhcyB0aGUgc2NyaXB0IG5lZWRzIHRvIGNoZWNrIGlmIGl0cyBhIGRvdWJsZSB0YXAuCiAqIEBuYW1lICQuZm4uc3dpcGUjZG91YmxlVGFwCiAqIEBzZWUgICQuZm4uc3dpcGUuZGVmYXVsdHMjZG91YmxlVGFwVGhyZXNob2xkCiAqIEBldmVudAogKiBAZGVmYXVsdCBudWxsCiAqIEBwYXJhbSB7RXZlbnRPYmplY3R9IGV2ZW50IFRoZSBvcmlnaW5hbCBldmVudCBvYmplY3QKICogQHBhcmFtIHtEb21PYmplY3R9IHRhcmdldCBUaGUgZWxlbWVudCBjbGlja2VkIG9uLgogKi8KIAogLyoqCiAqIEEgbG9uZyB0YXAgaGFuZGxlciB0cmlnZ2VyZWQgb25jZSBhIHRhcCBoYXMgYmVlbiByZWxlYXNlIGlmIHRoZSB0YXAgd2FzIGxvbmdlciB0aGFuIHRoZSBsb25nVGFwVGhyZXNob2xkLgogKiBZb3UgY2FuIHNldCB0aGUgdGltZSBkZWxheSBmb3IgYSBsb25nIHRhcCB3aXRoIHRoZSB7QGxpbmsgJC5mbi5zd2lwZS5kZWZhdWx0cyNsb25nVGFwVGhyZXNob2xkfSBwcm9wZXJ0eS4gCiAqIEBuYW1lICQuZm4uc3dpcGUjbG9uZ1RhcAogKiBAc2VlICAkLmZuLnN3aXBlLmRlZmF1bHRzI2xvbmdUYXBUaHJlc2hvbGQKICogQGV2ZW50CiAqIEBkZWZhdWx0IG51bGwKICogQHBhcmFtIHtFdmVudE9iamVjdH0gZXZlbnQgVGhlIG9yaWdpbmFsIGV2ZW50IG9iamVjdAogKiBAcGFyYW0ge0RvbU9iamVjdH0gdGFyZ2V0IFRoZSBlbGVtZW50IGNsaWNrZWQgb24uCiAqLwoKICAvKioKICogQSBob2xkIHRhcCBoYW5kbGVyIHRyaWdnZXJlZCBhcyBzb29uIGFzIHRoZSBsb25nVGFwVGhyZXNob2xkIGlzIHJlYWNoZWQKICogWW91IGNhbiBzZXQgdGhlIHRpbWUgZGVsYXkgZm9yIGEgbG9uZyB0YXAgd2l0aCB0aGUge0BsaW5rICQuZm4uc3dpcGUuZGVmYXVsdHMjbG9uZ1RhcFRocmVzaG9sZH0gcHJvcGVydHkuIAogKiBAbmFtZSAkLmZuLnN3aXBlI2hvbGQKICogQHNlZSAgJC5mbi5zd2lwZS5kZWZhdWx0cyNsb25nVGFwVGhyZXNob2xkCiAqIEBldmVudAogKiBAZGVmYXVsdCBudWxsCiAqIEBwYXJhbSB7RXZlbnRPYmplY3R9IGV2ZW50IFRoZSBvcmlnaW5hbCBldmVudCBvYmplY3QKICogQHBhcmFtIHtEb21PYmplY3R9IHRhcmdldCBUaGUgZWxlbWVudCBjbGlja2VkIG9uLgogKi8KCn0pKTsKCmRlZmluZSgnZ2FsbGVyeS92aWV3cy9zZWxlY3Rpb24vc2VsZWN0LmJ1dHRvbicsWwogICdiYWNrYm9uZScsCiAgJ2pxdWVyeScsCiAgJ2pxdWVyeS10b3VjaHN3aXBlJwpdLApmdW5jdGlvbiAoQmFja2JvbmUsICQsIG5vcGUpIHsKCiAgLyoKICAgKiBNb2RlbDogSW1hZ2VNb2RlbAogICAqIEVsZW1lbnQ6IHNldCB3aXRoIGNvbnN0cnVjdG9yCiAgICovCiAgdmFyIFNlbGVjdEJ1dHRvbiA9IEJhY2tib25lLlZpZXcuZXh0ZW5kKHsKCiAgICBpbml0aWFsaXplOiBmdW5jdGlvbigpIHsKICAgICAgaWYgKHRoaXMubW9kZWwgJiYgdGhpcy5lbCkgewogICAgICAgIHRoaXMubGlzdGVuVG8odGhpcy5tb2RlbCwgJ2NoYW5nZTpzZWxlY3RlZCcsIHRoaXMudXBkYXRlU2VsZWN0ZWQpOwogICAgICAgIHRoaXMudXBkYXRlU2VsZWN0ZWQodGhpcy5tb2RlbCwgdGhpcy5tb2RlbC5nZXQoJ3NlbGVjdGVkJykpOwoKICAgICAgICAvLyBub3Qgd2l0aCBidWlsdCBpbiBldmVudHMgPT4gZG9lc24ndCB3b3JrIHdlbGwgb24gdG91Y2ggZGV2aWNlcwogICAgICAgIC8vIHRoaXMgZmFsbHMgYmFjayB0byBtb3VzZSBldmVudHMsIHdoZW4gbm8gdG91Y2ggZXZlbnRzIHN1cHBvcnRlZAogICAgICAgIHRoaXMuJGVsLnN3aXBlKHsKICAgICAgICAgIHRhcDogXy5iaW5kKHRoaXMudG9nZ2xlU2VsZWN0ZWQsIHRoaXMpCiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0sCgogICAgLy8gb3ZlcnJpZGUgQmFja2JvbmUuVmlldyNyZW1vdmUgdG8gcmVtb3ZlIHRoZSB0b3VjaCBldmVudCBsaXN0ZW5lcgogICAgcmVtb3ZlOiBmdW5jdGlvbigpIHsKICAgICAgdGhpcy4kZWwuc3dpcGUoJ2Rlc3Ryb3knKTsKICAgICAgQmFja2JvbmUuVmlldy5wcm90b3R5cGUucmVtb3ZlLmNhbGwodGhpcyk7IC8vIGNhbGwgc3VwZXIoKQogICAgICAvLyBjb3VsZCBhbHNvIGJlIHdyaXR0ZW4gYXM6CiAgICAgIC8vIHRoaXMuY29uc3RydWN0b3IuX19zdXBlcl9fLnJlbW92ZS5jYWxsKHRoaXMpOwogICAgfSwKCiAgICB0b2dnbGVTZWxlY3RlZDogZnVuY3Rpb24oZXZ0KSB7CiAgICAgIGV2dC5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24oKTsKICAgICAgZXZ0LnByZXZlbnREZWZhdWx0KCk7CiAgICAgIHRoaXMubW9kZWwuc2V0KCdzZWxlY3RlZCcsICF0aGlzLm1vZGVsLmdldCgnc2VsZWN0ZWQnKSk7CiAgICB9LAoKICAgIHVwZGF0ZVNlbGVjdGVkOiBmdW5jdGlvbihJbWFnZU1vZGVsLCBzZWxlY3RlZCkgewogICAgICBpZiAoc2VsZWN0ZWQpIHsKICAgICAgICB0aGlzLiRlbC5hZGRDbGFzcygnc2VsZWN0ZWQnKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLiRlbC5yZW1vdmVDbGFzcygnc2VsZWN0ZWQnKTsKICAgICAgfQogICAgfQoKICB9KTsKCiAgcmV0dXJuIFNlbGVjdEJ1dHRvbjsKfSk7CgpkZWZpbmUoJ2dhbGxlcnkvdmlld3MvdGh1bWIudmlldycsWwogICdqcXVlcnknLAogICdqcXVlcnktdG91Y2hzd2lwZScsCiAgJ2JhY2tib25lJywKICAnZ2FsbGVyeS92aWV3cy9zZWxlY3Rpb24vc2VsZWN0LmJ1dHRvbicKXSwKZnVuY3Rpb24oJCwgbm9wZSwgQmFja2JvbmUsIFNlbGVjdEJ1dHRvbikgewogIC8qCiAgICogTW9kZWw6IEltYWdlTW9kZWwKICAgKiBFbGVtZW50OiBUaHVtYiBDb250YWluZXIKICAgKiAjZ2FsbGVyeTogR2FsbGVyeU1vZGVsCiAgICovCiAgdmFyIFRodW1iVmlldyA9IEJhY2tib25lLlZpZXcuZXh0ZW5kKHsKICAgIAogICAgLyoKICAgICAqIG9wdGlvbnMuZ2FsbGVyeSBleHBlY3RlZCEKICAgICAqLwogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMubW9kZWwuc2V0VGh1bWJWaWV3KHRoaXMpOwogICAgICB0aGlzLmdhbGxlcnkgPSB0aGlzLm9wdGlvbnMuZ2FsbGVyeTsKICAgICAgdGhpcy50ZW1wbGF0ZSA9IHRoaXMub3B0aW9ucy50ZW1wbGF0ZTsKCiAgICAgIHRoaXMuZG91YmxlVGFwID0gdGhpcy5nYWxsZXJ5LmdldCgnb3B0cycpWydkb3VibGVfdGFwX3RodW1iJ107CiAgICB9LAoKICAgIC8vIG5lZWQgc3dpcGVUb3VjaCBoZXJlIGZvciB0YXAgc2hpdCB3b3JraW5nIGNvcnJlY3RseQogICAgLy8gZXZlbnRzOiB7CiAgICAvLyAgICdjbGljayc6ICdvcGVuSW5TbGlkZXInCiAgICAvLyB9LAoKICAgIC8vIG92ZXJyaWRlIEJhY2tib25lLlZpZXcjcmVtb3ZlIHRvIHJlbW92ZSB0aGUgdG91Y2ggZXZlbnQgbGlzdGVuZXIKICAgIHJlbW92ZTogZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMuJGVsLnN3aXBlKCdkZXN0cm95Jyk7CiAgICAgIEJhY2tib25lLlZpZXcucHJvdG90eXBlLnJlbW92ZS5jYWxsKHRoaXMpOyAvLyBjYWxsIHN1cGVyKCkKICAgICAgLy8gY291bGQgYWxzbyBiZSB3cml0dGVuIGFzOgogICAgICAvLyB0aGlzLmNvbnN0cnVjdG9yLl9fc3VwZXJfXy5yZW1vdmUuY2FsbCh0aGlzKTsKICAgIH0sCgogICAgLy8gZG91YmxlIHRhcCBmZWF0dXJlLCB3aGVuIHRvdWNoZWQKICAgIGNsaWNrT3JUYXBwZWQ6IGZ1bmN0aW9uKGV2dCkgewogICAgICBpZiAoZXZ0LnR5cGUgPT0gJ3RvdWNoZW5kJyAmJiB0aGlzLmRvdWJsZVRhcCkgewogICAgICAgIHRoaXMuJGVsLmFkZENsYXNzKCdkb3VibGUtdGFwJyk7IC8vIG1hcmsgYXMgZG91YmxlIHRhcCB0b3VjaCBpbnRlcmFjdGlvbiBmb3IgY3NzIHN0eWxpbmcKICAgICAgICBpZiAodGhpcy4kZWxbMF0ucXVlcnlTZWxlY3RvcignOmhvdmVyJykgIT09IG51bGwpIHsKICAgICAgICAgIHRoaXMub3BlbkluU2xpZGVyKCk7IAogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLm9wZW5JblNsaWRlcigpOwogICAgICB9CiAgICB9LAogICAgCiAgICBvcGVuSW5TbGlkZXI6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLmdhbGxlcnkudHJpZ2dlcigndGh1bWI6Y2xpY2tlZCcsIHRoaXMubW9kZWwpOwogICAgfSwKICAgIAogICAgcmVuZGVyOiBmdW5jdGlvbigpIHsKICAgICAgdmFyIGh0bWwgPSB0aGlzLnRlbXBsYXRlKHtpbWc6IHRoaXMubW9kZWx9KS50cmltKCk7CiAgICAgIHRoaXMuc2V0RWxlbWVudCgkLnBhcnNlSFRNTChodG1sKSk7CgogICAgICAvLyBub3Qgd2l0aCBidWlsdCBpbiBldmVudHMgPT4gZG9lc24ndCB3b3JrIHdlbGwgb24gdG91Y2ggZGV2aWNlcwogICAgICAvLyB0aGlzIGZhbGxzIGJhY2sgdG8gbW91c2UgZXZlbnRzLCB3aGVuIG5vIHRvdWNoIGV2ZW50cyBzdXBwb3J0ZWQKICAgICAgdGhpcy4kZWwuc3dpcGUoewogICAgICAgIHRhcDogXy5iaW5kKHRoaXMuY2xpY2tPclRhcHBlZCwgdGhpcykKICAgICAgfSk7CgogICAgICBpZiAoIXRoaXMuc2VsZWN0QnV0dG9uKSB7CiAgICAgICAgdGhpcy5zZWxlY3RCdXR0b24gPSBuZXcgU2VsZWN0QnV0dG9uKHsKICAgICAgICAgIG1vZGVsOiB0aGlzLm1vZGVsLAogICAgICAgICAgZWw6IHRoaXMuJCgnLnNlbGVjdG9yJykKICAgICAgICB9KTsKICAgICAgfQogICAgICByZXR1cm4gdGhpczsKICAgIH0KICAgIAogIH0pOwogIAogIHJldHVybiBUaHVtYlZpZXc7Cn0pOwoKZGVmaW5lKCdnYWxsZXJ5L3ZpZXdzL3RodW1iLmNvbnRhaW5lcicsWwogICdqcXVlcnknLAogICd2ZW5kb3IvanF1ZXJ5LnRocm90dGxlLWRlYm91bmNlJywKICAndW5kZXJzY29yZScsCiAgJ2JhY2tib25lJywKICAnZ2FsbGVyeS92aWV3cy90aHVtYi52aWV3JywKICAnZ2FsbGVyeS91dGlscy9yZXNwb25zaXZlLmFkYXB0ZXInCl0sCmZ1bmN0aW9uKCQsIG5vcGUsIF8sIEJhY2tib25lLCBUaHVtYlZpZXcsIFJlc3BvbnNpdmVBZGFwdGVyKSB7CiAgCiAgLyoKICAgKiBNb2RlbDogR2FsbGVyeU1vZGVsCiAgICoKICAgKiBsaXN0ZW5zIG9uY2UgdG8gJ2NoYW5nZScgb24gR2FsbGVyeU1vZGVsID0+IGluaXQgVGh1bWJzCiAgICoKICAgKiBUaGUgY29uc3RydWN0b3IgbmVlZHMgdGhlIGZvbGxvd2luZyBvcHRpb25zCiAgICogLSBtb2RlbAogICAqIC0gZWwgCiAgICovCiAgdmFyIFRodW1iQ29udGFpbmVyID0gQmFja2JvbmUuVmlldy5leHRlbmQoewogIAogICAgZWw6ICcuY29udGFpbmVyLnBob3RvcycsIC8vIGRlZmF1bHQsIGNhbiBiZSBvdmVycmlkZGVuIHdpdGggY29uc3RydWN0b3IKCiAgICBkZWZhdWx0czogewogICAgICBpdGVtU2VsZWN0b3I6ICcucGhvdG8nCiAgICB9LAogIAogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICAvLyBtZXJnZSBkZWZhdWx0cyBhbmQgb3B0aW9ucwogICAgICB0aGlzLm9wdGlvbnMgPSBfLmV4dGVuZCh7fSwgdGhpcy5kZWZhdWx0cywgdGhpcy5vcHRpb25zKTsKCiAgICAgIC8vIG1hcmsgY29udGFpbmVyIGFzIGxvYWRpbmcKICAgICAgdGhpcy4kZWwuYWRkQ2xhc3MoJ2xvYWRpbmcnKTsKCiAgICAgIC8vIHdhaXQgZm9yIHRoZSBJbWFnZUNvbGxlY3Rpb24gdG8gYmUgZmV0Y2hlZAogICAgICB0aGlzLmxpc3RlblRvKHRoaXMubW9kZWwsICdjaGFuZ2UnLCB0aGlzLmdhbGxlcnlGZXRjaGVkKTsKICAgIH0sCgogICAgZ2FsbGVyeUZldGNoZWQ6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLiRlbC5hZGRDbGFzcygnZmV0Y2hlZCcpOwogICAgICB0aGlzLmluaXRHYWxsZXJ5KCk7CiAgICAgIHRoaXMuaW5pdFRodW1icygpOwogICAgfSwKICAgIAogICAgLy8gbm9vcCAvIGFic3RyYWN0IG1ldGhvZAogICAgaW5pdEdhbGxlcnk6IGZ1bmN0aW9uKCkge30sCgogICAgaW5pdFRodW1iczogZnVuY3Rpb24oKSB7CiAgICAgIC8vIGluaXRpYWxpemUgVGh1bWJWaWV3cyBieSBpdGVyYXRpbmcgb3ZlciBleGlzdGluZyB0aHVtYnMgaW4gdGhpcyBjb250YWluZXIKICAgICAgLy8gYW5kIGNvbm5lY3QgdGhlIFRodW1iVmlld3Mgd2l0aCB0aGVpciByZXNwZWN0aXZlIHRodW1iIERPTSBlbGVtZW50CiAgICAgIHZhciBpbWFnZUNvbGxlY3Rpb24gPSB0aGlzLm1vZGVsLmdldCgnaW1hZ2VzJyk7CiAgICAgIHRoaXMuJCh0aGlzLm9wdGlvbnMuaXRlbVNlbGVjdG9yKS5lYWNoKGZ1bmN0aW9uKCkgewogICAgICAgIHZhciB0aHVtYkNvbnRhaW5lciA9ICQodGhpcyk7CiAgICAgICAgLy8gdGhlIGRpZ2VzdCBoYXMgdG8gYmUgdGhlIGlkIG9mIHRoZSBUaHVtYiBjb250YWluZXIKICAgICAgICB2YXIgaW1hZ2VNb2RlbCA9IGltYWdlQ29sbGVjdGlvbi5nZXQodGh1bWJDb250YWluZXIuYXR0cignaWQnKSk7CiAgICAgICAgbmV3IFRodW1iVmlldyh7CiAgICAgICAgICBtb2RlbDogaW1hZ2VNb2RlbCwKICAgICAgICAgIGVsOiB0aHVtYkNvbnRhaW5lciwKICAgICAgICAgIGdhbGxlcnk6IHRoaXMubW9kZWwKICAgICAgICB9KTsKICAgICAgfSk7CiAgICAgICAgICAgIAogICAgICAvLyBGYWRlIGluIGluaXRpYWxpemVkIHRodW1icy4uLiAoc2VlIGdhbGxlcnkuY3NzIGZvciBkZXRhaWxzKQogICAgICB0aGlzLiRlbC5yZW1vdmVDbGFzcygnbG9hZGluZycpOyAvLyBoaWRlIGxvYWRpbmcgaW5kaWNhdG9yCiAgICAgIHRoaXMuJGVsLmZpbmQodGhpcy5vcHRpb25zLml0ZW1TZWxlY3RvcikuYWRkQ2xhc3MoJ2xvYWRlZCcpOyAvLyBmYWRlIGluIHRodW1icwogICAgfSwKICAgICAgICAgICAgCiAgICAvLyBzY3JvbGwgdG8gdGh1bWJWaWV3CiAgICBzY3JvbGxUb1RodW1iOiBmdW5jdGlvbihpbWFnZU1vZGVsKSB7CiAgICAgIHdpbmRvdy5zZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgIGlmIChpbWFnZU1vZGVsKSB7CiAgICAgICAgICB2YXIgdGh1bWJWaWV3ID0gaW1hZ2VNb2RlbC5nZXRUaHVtYlZpZXcoKTsKICAgICAgICAgIGlmICh0aHVtYlZpZXcpIHsKICAgICAgICAgICAgJCgnaHRtbCwgYm9keScpLmFuaW1hdGUoewogICAgICAgICAgICAgIHNjcm9sbFRvcDogdGh1bWJWaWV3LiRlbC5vZmZzZXQoKS50b3AKICAgICAgICAgICAgfSwgMTAwKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sIDIwMCk7CiAgICB9CiAgICAKICB9KTsKCiAgcmV0dXJuIFRodW1iQ29udGFpbmVyOwp9KTsKCmRlZmluZSgnZ2FsbGVyeS92aWV3cy90aHVtYi5jb250YWluZXIubWFzb25yeScsWwogICdqcXVlcnknLAogICd1bmRlcnNjb3JlJywKICAnYmFja2JvbmUnLAogICdqcXVlcnktYnJpZGdldC9qcXVlcnkuYnJpZGdldCcsCiAgJ2ZsdWlkLW1hc29ucnknLAogICdnYWxsZXJ5L3ZpZXdzL3RodW1iLmNvbnRhaW5lcicsCiAgJ2dhbGxlcnkvdXRpbHMvcmVzcG9uc2l2ZS5hZGFwdGVyJwpdLApmdW5jdGlvbigkLCBfLCBCYWNrYm9uZSwgbm9wZSwgRmx1aWRNYXNvbnJ5LCBUaHVtYkNvbnRhaW5lciwgUmVzcG9uc2l2ZUFkYXB0ZXIpIHsKICAKICAkLmJyaWRnZXQoJ2ZsdWlkTWFzb25yeScsIEZsdWlkTWFzb25yeSk7CgogIC8qCiAgICogTW9kZWw6IEdhbGxlcnlNb2RlbAogICAqCiAgICogbGlzdGVucyBvbmNlIHRvICdjaGFuZ2UnIG9uIEdhbGxlcnlNb2RlbCA9PiBpbml0IFRodW1icwogICAqCiAgICogVGhlIGNvbnN0cnVjdG9yIG5lZWRzIHRoZSBmb2xsb3dpbmcgb3B0aW9ucwogICAqIC0gbW9kZWwKICAgKiAtIGVsIAogICAqLwogIHZhciBUaHVtYkNvbnRhaW5lck1hc29ucnkgPSBUaHVtYkNvbnRhaW5lci5leHRlbmQoewogIAogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICBUaHVtYkNvbnRhaW5lci5wcm90b3R5cGUuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfSwKCiAgICBpbml0R2FsbGVyeTogZnVuY3Rpb24oKSB7CiAgICAgIC8vIGluaXRpYWxpemUgbWFzb25yeSBvbiB0aGUgdGh1bWIgQ29udGFpbmVyCiAgICAgIHRoaXMuaW5pdE1hc29ucnkodGhpcy5tb2RlbC5nZXQoJ29wdHMnKSk7CiAgICB9LAogIAogICAgLyoKICAgICAqIG1pbl9jb2xfd2lkdGg6IHdpZHRoIG9mIGNlbGwgKHRodW1iKSBpbiBtYXNvbnJ5IGxheW91dCAodGh1bWIgY2FuIGdldCB0aWxsIAogICAgICogZG91YmxlIGluIHNpemUsIGRlcGVuZGluZyBvbiBjb250YWluZXItd2lkdGgpCiAgICAgKi8KICAgIGluaXRNYXNvbnJ5OiBmdW5jdGlvbihnYWxsZXJ5T3B0cykgewogICAgICB0aGlzLiRlbC5mbHVpZE1hc29ucnkoewogICAgICAgIGl0ZW1TZWxlY3RvciA6IHRoaXMub3B0aW9ucy5pdGVtU2VsZWN0b3IsCiAgICAgICAgbWluQ29sdW1uV2lkdGg6IFJlc3BvbnNpdmVBZGFwdGVyLmdldE9wdGlvbkJ5TWVkaWFUeXBlKGdhbGxlcnlPcHRzLCAnbWluX2NvbF93aWR0aCcpLAogICAgICAgIGd1dHRlcjogUmVzcG9uc2l2ZUFkYXB0ZXIuZ2V0T3B0aW9uQnlNZWRpYVR5cGUoZ2FsbGVyeU9wdHMsICdndXR0ZXJfd2lkdGgnKSwKICAgICAgICBpc0ZpdFdpZHRoOiBmYWxzZQogICAgICB9KTsKICAgIH0KICAgIAogIH0pOwoKICByZXR1cm4gVGh1bWJDb250YWluZXJNYXNvbnJ5Owp9KTsKCi8qIQogKiBpbWFnZXNMb2FkZWQgdjMuMS44CiAqIEphdmFTY3JpcHQgaXMgYWxsIGxpa2UgIllvdSBpbWFnZXMgYXJlIGRvbmUgeWV0IG9yIHdoYXQ/IgogKiBNSVQgTGljZW5zZQogKi8KCiggZnVuY3Rpb24oIHdpbmRvdywgZmFjdG9yeSApIHsgCiAgLy8gdW5pdmVyc2FsIG1vZHVsZSBkZWZpbml0aW9uCgogIC8qZ2xvYmFsIGRlZmluZTogZmFsc2UsIG1vZHVsZTogZmFsc2UsIHJlcXVpcmU6IGZhbHNlICovCgogIGlmICggdHlwZW9mIGRlZmluZSA9PT0gJ2Z1bmN0aW9uJyAmJiBkZWZpbmUuYW1kICkgewogICAgLy8gQU1ECiAgICBkZWZpbmUoICdpbWFnZXNsb2FkZWQvaW1hZ2VzbG9hZGVkJyxbCiAgICAgICdldmVudEVtaXR0ZXIvRXZlbnRFbWl0dGVyJywKICAgICAgJ2V2ZW50aWUvZXZlbnRpZScKICAgIF0sIGZ1bmN0aW9uKCBFdmVudEVtaXR0ZXIsIGV2ZW50aWUgKSB7CiAgICAgIHJldHVybiBmYWN0b3J5KCB3aW5kb3csIEV2ZW50RW1pdHRlciwgZXZlbnRpZSApOwogICAgfSk7CiAgfSBlbHNlIGlmICggdHlwZW9mIGV4cG9ydHMgPT09ICdvYmplY3QnICkgewogICAgLy8gQ29tbW9uSlMKICAgIG1vZHVsZS5leHBvcnRzID0gZmFjdG9yeSgKICAgICAgd2luZG93LAogICAgICByZXF1aXJlKCd3b2xmeTg3LWV2ZW50ZW1pdHRlcicpLAogICAgICByZXF1aXJlKCdldmVudGllJykKICAgICk7CiAgfSBlbHNlIHsKICAgIC8vIGJyb3dzZXIgZ2xvYmFsCiAgICB3aW5kb3cuaW1hZ2VzTG9hZGVkID0gZmFjdG9yeSgKICAgICAgd2luZG93LAogICAgICB3aW5kb3cuRXZlbnRFbWl0dGVyLAogICAgICB3aW5kb3cuZXZlbnRpZQogICAgKTsKICB9Cgp9KSggd2luZG93LAoKLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gIGZhY3RvcnkgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gLy8KCmZ1bmN0aW9uIGZhY3RvcnkoIHdpbmRvdywgRXZlbnRFbWl0dGVyLCBldmVudGllICkgewoKCgp2YXIgJCA9IHdpbmRvdy5qUXVlcnk7CnZhciBjb25zb2xlID0gd2luZG93LmNvbnNvbGU7CnZhciBoYXNDb25zb2xlID0gdHlwZW9mIGNvbnNvbGUgIT09ICd1bmRlZmluZWQnOwoKLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gaGVscGVycyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSAvLwoKLy8gZXh0ZW5kIG9iamVjdHMKZnVuY3Rpb24gZXh0ZW5kKCBhLCBiICkgewogIGZvciAoIHZhciBwcm9wIGluIGIgKSB7CiAgICBhWyBwcm9wIF0gPSBiWyBwcm9wIF07CiAgfQogIHJldHVybiBhOwp9Cgp2YXIgb2JqVG9TdHJpbmcgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nOwpmdW5jdGlvbiBpc0FycmF5KCBvYmogKSB7CiAgcmV0dXJuIG9ialRvU3RyaW5nLmNhbGwoIG9iaiApID09PSAnW29iamVjdCBBcnJheV0nOwp9CgovLyB0dXJuIGVsZW1lbnQgb3Igbm9kZUxpc3QgaW50byBhbiBhcnJheQpmdW5jdGlvbiBtYWtlQXJyYXkoIG9iaiApIHsKICB2YXIgYXJ5ID0gW107CiAgaWYgKCBpc0FycmF5KCBvYmogKSApIHsKICAgIC8vIHVzZSBvYmplY3QgaWYgYWxyZWFkeSBhbiBhcnJheQogICAgYXJ5ID0gb2JqOwogIH0gZWxzZSBpZiAoIHR5cGVvZiBvYmoubGVuZ3RoID09PSAnbnVtYmVyJyApIHsKICAgIC8vIGNvbnZlcnQgbm9kZUxpc3QgdG8gYXJyYXkKICAgIGZvciAoIHZhciBpPTAsIGxlbiA9IG9iai5sZW5ndGg7IGkgPCBsZW47IGkrKyApIHsKICAgICAgYXJ5LnB1c2goIG9ialtpXSApOwogICAgfQogIH0gZWxzZSB7CiAgICAvLyBhcnJheSBvZiBzaW5nbGUgaW5kZXgKICAgIGFyeS5wdXNoKCBvYmogKTsKICB9CiAgcmV0dXJuIGFyeTsKfQoKICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSBpbWFnZXNMb2FkZWQgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gLy8KCiAgLyoqCiAgICogQHBhcmFtIHtBcnJheSwgRWxlbWVudCwgTm9kZUxpc3QsIFN0cmluZ30gZWxlbQogICAqIEBwYXJhbSB7T2JqZWN0IG9yIEZ1bmN0aW9ufSBvcHRpb25zIC0gaWYgZnVuY3Rpb24sIHVzZSBhcyBjYWxsYmFjawogICAqIEBwYXJhbSB7RnVuY3Rpb259IG9uQWx3YXlzIC0gY2FsbGJhY2sgZnVuY3Rpb24KICAgKi8KICBmdW5jdGlvbiBJbWFnZXNMb2FkZWQoIGVsZW0sIG9wdGlvbnMsIG9uQWx3YXlzICkgewogICAgLy8gY29lcmNlIEltYWdlc0xvYWRlZCgpIHdpdGhvdXQgbmV3LCB0byBiZSBuZXcgSW1hZ2VzTG9hZGVkKCkKICAgIGlmICggISggdGhpcyBpbnN0YW5jZW9mIEltYWdlc0xvYWRlZCApICkgewogICAgICByZXR1cm4gbmV3IEltYWdlc0xvYWRlZCggZWxlbSwgb3B0aW9ucyApOwogICAgfQogICAgLy8gdXNlIGVsZW0gYXMgc2VsZWN0b3Igc3RyaW5nCiAgICBpZiAoIHR5cGVvZiBlbGVtID09PSAnc3RyaW5nJyApIHsKICAgICAgZWxlbSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoIGVsZW0gKTsKICAgIH0KCiAgICB0aGlzLmVsZW1lbnRzID0gbWFrZUFycmF5KCBlbGVtICk7CiAgICB0aGlzLm9wdGlvbnMgPSBleHRlbmQoIHt9LCB0aGlzLm9wdGlvbnMgKTsKCiAgICBpZiAoIHR5cGVvZiBvcHRpb25zID09PSAnZnVuY3Rpb24nICkgewogICAgICBvbkFsd2F5cyA9IG9wdGlvbnM7CiAgICB9IGVsc2UgewogICAgICBleHRlbmQoIHRoaXMub3B0aW9ucywgb3B0aW9ucyApOwogICAgfQoKICAgIGlmICggb25BbHdheXMgKSB7CiAgICAgIHRoaXMub24oICdhbHdheXMnLCBvbkFsd2F5cyApOwogICAgfQoKICAgIHRoaXMuZ2V0SW1hZ2VzKCk7CgogICAgaWYgKCAkICkgewogICAgICAvLyBhZGQgalF1ZXJ5IERlZmVycmVkIG9iamVjdAogICAgICB0aGlzLmpxRGVmZXJyZWQgPSBuZXcgJC5EZWZlcnJlZCgpOwogICAgfQoKICAgIC8vIEhBQ0sgY2hlY2sgYXN5bmMgdG8gYWxsb3cgdGltZSB0byBiaW5kIGxpc3RlbmVycwogICAgdmFyIF90aGlzID0gdGhpczsKICAgIHNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewogICAgICBfdGhpcy5jaGVjaygpOwogICAgfSk7CiAgfQoKICBJbWFnZXNMb2FkZWQucHJvdG90eXBlID0gbmV3IEV2ZW50RW1pdHRlcigpOwoKICBJbWFnZXNMb2FkZWQucHJvdG90eXBlLm9wdGlvbnMgPSB7fTsKCiAgSW1hZ2VzTG9hZGVkLnByb3RvdHlwZS5nZXRJbWFnZXMgPSBmdW5jdGlvbigpIHsKICAgIHRoaXMuaW1hZ2VzID0gW107CgogICAgLy8gZmlsdGVyICYgZmluZCBpdGVtcyBpZiB3ZSBoYXZlIGFuIGl0ZW0gc2VsZWN0b3IKICAgIGZvciAoIHZhciBpPTAsIGxlbiA9IHRoaXMuZWxlbWVudHMubGVuZ3RoOyBpIDwgbGVuOyBpKysgKSB7CiAgICAgIHZhciBlbGVtID0gdGhpcy5lbGVtZW50c1tpXTsKICAgICAgLy8gZmlsdGVyIHNpYmxpbmdzCiAgICAgIGlmICggZWxlbS5ub2RlTmFtZSA9PT0gJ0lNRycgKSB7CiAgICAgICAgdGhpcy5hZGRJbWFnZSggZWxlbSApOwogICAgICB9CiAgICAgIC8vIGZpbmQgY2hpbGRyZW4KICAgICAgLy8gbm8gbm9uLWVsZW1lbnQgbm9kZXMsICMxNDMKICAgICAgdmFyIG5vZGVUeXBlID0gZWxlbS5ub2RlVHlwZTsKICAgICAgaWYgKCAhbm9kZVR5cGUgfHwgISggbm9kZVR5cGUgPT09IDEgfHwgbm9kZVR5cGUgPT09IDkgfHwgbm9kZVR5cGUgPT09IDExICkgKSB7CiAgICAgICAgY29udGludWU7CiAgICAgIH0KICAgICAgdmFyIGNoaWxkRWxlbXMgPSBlbGVtLnF1ZXJ5U2VsZWN0b3JBbGwoJ2ltZycpOwogICAgICAvLyBjb25jYXQgY2hpbGRFbGVtcyB0byBmaWx0ZXJGb3VuZCBhcnJheQogICAgICBmb3IgKCB2YXIgaj0wLCBqTGVuID0gY2hpbGRFbGVtcy5sZW5ndGg7IGogPCBqTGVuOyBqKysgKSB7CiAgICAgICAgdmFyIGltZyA9IGNoaWxkRWxlbXNbal07CiAgICAgICAgdGhpcy5hZGRJbWFnZSggaW1nICk7CiAgICAgIH0KICAgIH0KICB9OwoKICAvKioKICAgKiBAcGFyYW0ge0ltYWdlfSBpbWcKICAgKi8KICBJbWFnZXNMb2FkZWQucHJvdG90eXBlLmFkZEltYWdlID0gZnVuY3Rpb24oIGltZyApIHsKICAgIHZhciBsb2FkaW5nSW1hZ2UgPSBuZXcgTG9hZGluZ0ltYWdlKCBpbWcgKTsKICAgIHRoaXMuaW1hZ2VzLnB1c2goIGxvYWRpbmdJbWFnZSApOwogIH07CgogIEltYWdlc0xvYWRlZC5wcm90b3R5cGUuY2hlY2sgPSBmdW5jdGlvbigpIHsKICAgIHZhciBfdGhpcyA9IHRoaXM7CiAgICB2YXIgY2hlY2tlZENvdW50ID0gMDsKICAgIHZhciBsZW5ndGggPSB0aGlzLmltYWdlcy5sZW5ndGg7CiAgICB0aGlzLmhhc0FueUJyb2tlbiA9IGZhbHNlOwogICAgLy8gY29tcGxldGUgaWYgbm8gaW1hZ2VzCiAgICBpZiAoICFsZW5ndGggKSB7CiAgICAgIHRoaXMuY29tcGxldGUoKTsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIGZ1bmN0aW9uIG9uQ29uZmlybSggaW1hZ2UsIG1lc3NhZ2UgKSB7CiAgICAgIGlmICggX3RoaXMub3B0aW9ucy5kZWJ1ZyAmJiBoYXNDb25zb2xlICkgewogICAgICAgIGNvbnNvbGUubG9nKCAnY29uZmlybScsIGltYWdlLCBtZXNzYWdlICk7CiAgICAgIH0KCiAgICAgIF90aGlzLnByb2dyZXNzKCBpbWFnZSApOwogICAgICBjaGVja2VkQ291bnQrKzsKICAgICAgaWYgKCBjaGVja2VkQ291bnQgPT09IGxlbmd0aCApIHsKICAgICAgICBfdGhpcy5jb21wbGV0ZSgpOwogICAgICB9CiAgICAgIHJldHVybiB0cnVlOyAvLyBiaW5kIG9uY2UKICAgIH0KCiAgICBmb3IgKCB2YXIgaT0wOyBpIDwgbGVuZ3RoOyBpKysgKSB7CiAgICAgIHZhciBsb2FkaW5nSW1hZ2UgPSB0aGlzLmltYWdlc1tpXTsKICAgICAgbG9hZGluZ0ltYWdlLm9uKCAnY29uZmlybScsIG9uQ29uZmlybSApOwogICAgICBsb2FkaW5nSW1hZ2UuY2hlY2soKTsKICAgIH0KICB9OwoKICBJbWFnZXNMb2FkZWQucHJvdG90eXBlLnByb2dyZXNzID0gZnVuY3Rpb24oIGltYWdlICkgewogICAgdGhpcy5oYXNBbnlCcm9rZW4gPSB0aGlzLmhhc0FueUJyb2tlbiB8fCAhaW1hZ2UuaXNMb2FkZWQ7CiAgICAvLyBIQUNLIC0gQ2hyb21lIHRyaWdnZXJzIGV2ZW50IGJlZm9yZSBvYmplY3QgcHJvcGVydGllcyBoYXZlIGNoYW5nZWQuICM4MwogICAgdmFyIF90aGlzID0gdGhpczsKICAgIHNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewogICAgICBfdGhpcy5lbWl0KCAncHJvZ3Jlc3MnLCBfdGhpcywgaW1hZ2UgKTsKICAgICAgaWYgKCBfdGhpcy5qcURlZmVycmVkICYmIF90aGlzLmpxRGVmZXJyZWQubm90aWZ5ICkgewogICAgICAgIF90aGlzLmpxRGVmZXJyZWQubm90aWZ5KCBfdGhpcywgaW1hZ2UgKTsKICAgICAgfQogICAgfSk7CiAgfTsKCiAgSW1hZ2VzTG9hZGVkLnByb3RvdHlwZS5jb21wbGV0ZSA9IGZ1bmN0aW9uKCkgewogICAgdmFyIGV2ZW50TmFtZSA9IHRoaXMuaGFzQW55QnJva2VuID8gJ2ZhaWwnIDogJ2RvbmUnOwogICAgdGhpcy5pc0NvbXBsZXRlID0gdHJ1ZTsKICAgIHZhciBfdGhpcyA9IHRoaXM7CiAgICAvLyBIQUNLIC0gYW5vdGhlciBzZXRUaW1lb3V0IHNvIHRoYXQgY29uZmlybSBoYXBwZW5zIGFmdGVyIHByb2dyZXNzCiAgICBzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKICAgICAgX3RoaXMuZW1pdCggZXZlbnROYW1lLCBfdGhpcyApOwogICAgICBfdGhpcy5lbWl0KCAnYWx3YXlzJywgX3RoaXMgKTsKICAgICAgaWYgKCBfdGhpcy5qcURlZmVycmVkICkgewogICAgICAgIHZhciBqcU1ldGhvZCA9IF90aGlzLmhhc0FueUJyb2tlbiA/ICdyZWplY3QnIDogJ3Jlc29sdmUnOwogICAgICAgIF90aGlzLmpxRGVmZXJyZWRbIGpxTWV0aG9kIF0oIF90aGlzICk7CiAgICAgIH0KICAgIH0pOwogIH07CgogIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tIGpxdWVyeSAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSAvLwoKICBpZiAoICQgKSB7CiAgICAkLmZuLmltYWdlc0xvYWRlZCA9IGZ1bmN0aW9uKCBvcHRpb25zLCBjYWxsYmFjayApIHsKICAgICAgdmFyIGluc3RhbmNlID0gbmV3IEltYWdlc0xvYWRlZCggdGhpcywgb3B0aW9ucywgY2FsbGJhY2sgKTsKICAgICAgcmV0dXJuIGluc3RhbmNlLmpxRGVmZXJyZWQucHJvbWlzZSggJCh0aGlzKSApOwogICAgfTsKICB9CgoKICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSAgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gLy8KCiAgZnVuY3Rpb24gTG9hZGluZ0ltYWdlKCBpbWcgKSB7CiAgICB0aGlzLmltZyA9IGltZzsKICB9CgogIExvYWRpbmdJbWFnZS5wcm90b3R5cGUgPSBuZXcgRXZlbnRFbWl0dGVyKCk7CgogIExvYWRpbmdJbWFnZS5wcm90b3R5cGUuY2hlY2sgPSBmdW5jdGlvbigpIHsKICAgIC8vIGZpcnN0IGNoZWNrIGNhY2hlZCBhbnkgcHJldmlvdXMgaW1hZ2VzIHRoYXQgaGF2ZSBzYW1lIHNyYwogICAgdmFyIHJlc291cmNlID0gY2FjaGVbIHRoaXMuaW1nLnNyYyBdIHx8IG5ldyBSZXNvdXJjZSggdGhpcy5pbWcuc3JjICk7CiAgICBpZiAoIHJlc291cmNlLmlzQ29uZmlybWVkICkgewogICAgICB0aGlzLmNvbmZpcm0oIHJlc291cmNlLmlzTG9hZGVkLCAnY2FjaGVkIHdhcyBjb25maXJtZWQnICk7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICAvLyBJZiBjb21wbGV0ZSBpcyB0cnVlIGFuZCBicm93c2VyIHN1cHBvcnRzIG5hdHVyYWwgc2l6ZXMsCiAgICAvLyB0cnkgdG8gY2hlY2sgZm9yIGltYWdlIHN0YXR1cyBtYW51YWxseS4KICAgIGlmICggdGhpcy5pbWcuY29tcGxldGUgJiYgdGhpcy5pbWcubmF0dXJhbFdpZHRoICE9PSB1bmRlZmluZWQgKSB7CiAgICAgIC8vIHJlcG9ydCBiYXNlZCBvbiBuYXR1cmFsV2lkdGgKICAgICAgdGhpcy5jb25maXJtKCB0aGlzLmltZy5uYXR1cmFsV2lkdGggIT09IDAsICduYXR1cmFsV2lkdGgnICk7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICAvLyBJZiBub25lIG9mIHRoZSBjaGVja3MgYWJvdmUgbWF0Y2hlZCwgc2ltdWxhdGUgbG9hZGluZyBvbiBkZXRhY2hlZCBlbGVtZW50LgogICAgdmFyIF90aGlzID0gdGhpczsKICAgIHJlc291cmNlLm9uKCAnY29uZmlybScsIGZ1bmN0aW9uKCByZXNyYywgbWVzc2FnZSApIHsKICAgICAgX3RoaXMuY29uZmlybSggcmVzcmMuaXNMb2FkZWQsIG1lc3NhZ2UgKTsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9KTsKCiAgICByZXNvdXJjZS5jaGVjaygpOwogIH07CgogIExvYWRpbmdJbWFnZS5wcm90b3R5cGUuY29uZmlybSA9IGZ1bmN0aW9uKCBpc0xvYWRlZCwgbWVzc2FnZSApIHsKICAgIHRoaXMuaXNMb2FkZWQgPSBpc0xvYWRlZDsKICAgIHRoaXMuZW1pdCggJ2NvbmZpcm0nLCB0aGlzLCBtZXNzYWdlICk7CiAgfTsKCiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gUmVzb3VyY2UgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gLy8KCiAgLy8gUmVzb3VyY2UgY2hlY2tzIGVhY2ggc3JjLCBvbmx5IG9uY2UKICAvLyBzZXBhcmF0ZSBjbGFzcyBmcm9tIExvYWRpbmdJbWFnZSB0byBwcmV2ZW50IG1lbW9yeSBsZWFrcy4gU2VlICMxMTUKCiAgdmFyIGNhY2hlID0ge307CgogIGZ1bmN0aW9uIFJlc291cmNlKCBzcmMgKSB7CiAgICB0aGlzLnNyYyA9IHNyYzsKICAgIC8vIGFkZCB0byBjYWNoZQogICAgY2FjaGVbIHNyYyBdID0gdGhpczsKICB9CgogIFJlc291cmNlLnByb3RvdHlwZSA9IG5ldyBFdmVudEVtaXR0ZXIoKTsKCiAgUmVzb3VyY2UucHJvdG90eXBlLmNoZWNrID0gZnVuY3Rpb24oKSB7CiAgICAvLyBvbmx5IHRyaWdnZXIgY2hlY2tpbmcgb25jZQogICAgaWYgKCB0aGlzLmlzQ2hlY2tlZCApIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgLy8gc2ltdWxhdGUgbG9hZGluZyBvbiBkZXRhY2hlZCBlbGVtZW50CiAgICB2YXIgcHJveHlJbWFnZSA9IG5ldyBJbWFnZSgpOwogICAgZXZlbnRpZS5iaW5kKCBwcm94eUltYWdlLCAnbG9hZCcsIHRoaXMgKTsKICAgIGV2ZW50aWUuYmluZCggcHJveHlJbWFnZSwgJ2Vycm9yJywgdGhpcyApOwogICAgcHJveHlJbWFnZS5zcmMgPSB0aGlzLnNyYzsKICAgIC8vIHNldCBmbGFnCiAgICB0aGlzLmlzQ2hlY2tlZCA9IHRydWU7CiAgfTsKCiAgLy8gLS0tLS0gZXZlbnRzIC0tLS0tIC8vCgogIC8vIHRyaWdnZXIgc3BlY2lmaWVkIGhhbmRsZXIgZm9yIGV2ZW50IHR5cGUKICBSZXNvdXJjZS5wcm90b3R5cGUuaGFuZGxlRXZlbnQgPSBmdW5jdGlvbiggZXZlbnQgKSB7CiAgICB2YXIgbWV0aG9kID0gJ29uJyArIGV2ZW50LnR5cGU7CiAgICBpZiAoIHRoaXNbIG1ldGhvZCBdICkgewogICAgICB0aGlzWyBtZXRob2QgXSggZXZlbnQgKTsKICAgIH0KICB9OwoKICBSZXNvdXJjZS5wcm90b3R5cGUub25sb2FkID0gZnVuY3Rpb24oIGV2ZW50ICkgewogICAgdGhpcy5jb25maXJtKCB0cnVlLCAnb25sb2FkJyApOwogICAgdGhpcy51bmJpbmRQcm94eUV2ZW50cyggZXZlbnQgKTsKICB9OwoKICBSZXNvdXJjZS5wcm90b3R5cGUub25lcnJvciA9IGZ1bmN0aW9uKCBldmVudCApIHsKICAgIHRoaXMuY29uZmlybSggZmFsc2UsICdvbmVycm9yJyApOwogICAgdGhpcy51bmJpbmRQcm94eUV2ZW50cyggZXZlbnQgKTsKICB9OwoKICAvLyAtLS0tLSBjb25maXJtIC0tLS0tIC8vCgogIFJlc291cmNlLnByb3RvdHlwZS5jb25maXJtID0gZnVuY3Rpb24oIGlzTG9hZGVkLCBtZXNzYWdlICkgewogICAgdGhpcy5pc0NvbmZpcm1lZCA9IHRydWU7CiAgICB0aGlzLmlzTG9hZGVkID0gaXNMb2FkZWQ7CiAgICB0aGlzLmVtaXQoICdjb25maXJtJywgdGhpcywgbWVzc2FnZSApOwogIH07CgogIFJlc291cmNlLnByb3RvdHlwZS51bmJpbmRQcm94eUV2ZW50cyA9IGZ1bmN0aW9uKCBldmVudCApIHsKICAgIGV2ZW50aWUudW5iaW5kKCBldmVudC50YXJnZXQsICdsb2FkJywgdGhpcyApOwogICAgZXZlbnRpZS51bmJpbmQoIGV2ZW50LnRhcmdldCwgJ2Vycm9yJywgdGhpcyApOwogIH07CgogIC8vIC0tLS0tICAtLS0tLSAvLwoKICByZXR1cm4gSW1hZ2VzTG9hZGVkOwoKfSk7CgovKiBqc2hpbnQgY2FtZWxjYXNlOiBmYWxzZSAqLwovKioKICogYXV0aG9yIENocmlzdG9waGVyIEJsdW0KICogICAgLSBvcmlnaW5hbGx5IGZyb20gaHR0cHM6Ly9naXRodWIuY29tL3Byb3RvbmV0L2pxdWVyeS5pbnZpZXcKICogICAgLSBiYXNlZCBvbiB0aGUgaWRlYSBvZiBSZW15IFNoYXJwLCBodHRwOi8vcmVteXNoYXJwLmNvbS8yMDA5LzAxLzI2L2VsZW1lbnQtaW4tdmlldy1ldmVudC1wbHVnaW4vCiAqICAgIC0gZm9ya2VkIGZyb20gaHR0cDovL2dpdGh1Yi5jb20venVrL2pxdWVyeS5pbnZpZXcvCiAqIAogKiBtb2RpZmllZCBieSBwYXRjaGVrb2hvc3MKICogLSB0byB0cmlnZ2VyIG9ubHkgb24gZXZlbnRzIChzY3JvbGwgJiByZXNpemUpCiAqIC0gdG8gdXNlIHJlcXVpcmVqcyBhbmQgdGhyb3R0bGUtZGVib3VuY2UKICovCmRlZmluZSgnbGliL2pxdWVyeS5pbnZpZXcnLFsKICAnanF1ZXJ5JywKICAndmVuZG9yL2pxdWVyeS50aHJvdHRsZS1kZWJvdW5jZScKXSwgZnVuY3Rpb24oJCwgbm9wZSkgewogIAogIHZhciBkZWJ1ZyA9IGZhbHNlOwogIAogIHZhciBpbnZpZXdPYmplY3RzID0ge30sIHZpZXdwb3J0U2l6ZSwgdmlld3BvcnRPZmZzZXQsCiAgICAgIGQgPSBkb2N1bWVudCwgdyA9IHdpbmRvdywgZG9jdW1lbnRFbGVtZW50ID0gZC5kb2N1bWVudEVsZW1lbnQsIGV4cGFuZG8gPSAkLmV4cGFuZG87CgogICQuZXZlbnQuc3BlY2lhbC5pbnZpZXcgPSB7CiAgICBhZGQ6IGZ1bmN0aW9uKGRhdGEpIHsKICAgICAgaW52aWV3T2JqZWN0c1tkYXRhLmd1aWQgKyAnLScgKyB0aGlzW2V4cGFuZG9dXSA9IHsgZGF0YTogZGF0YSwgJGVsZW1lbnQ6ICQodGhpcykgfTsKICAgICAgYmluZFRvVmlld1BvcnRDaGFuZ2VFdmVudHMoKTsKICAgIH0sCgogICAgcmVtb3ZlOiBmdW5jdGlvbihkYXRhKSB7CiAgICAgIHVuYmluZFRvVmlld1BvcnRDaGFuZ2VFdmVudHMoKTsKICAgICAgdHJ5IHsgZGVsZXRlIGludmlld09iamVjdHNbZGF0YS5ndWlkICsgJy0nICsgdGhpc1tleHBhbmRvXV07IH0gY2F0Y2goZSkge30KICAgIH0KICB9OwoKICBmdW5jdGlvbiBnZXRWaWV3cG9ydFNpemUoKSB7CiAgICB2YXIgbW9kZSwgZG9tT2JqZWN0LCBzaXplID0geyBoZWlnaHQ6IHcuaW5uZXJIZWlnaHQsIHdpZHRoOiB3LmlubmVyV2lkdGggfTsKCiAgICAvLyBpZiB0aGlzIGlzIGNvcnJlY3QgdGhlbiByZXR1cm4gaXQuIGlQYWQgaGFzIGNvbXBhdCBNb2RlLCBzbyB3aWxsCiAgICAvLyBnbyBpbnRvIGNoZWNrIGNsaWVudEhlaWdodC9jbGllbnRXaWR0aCAod2hpY2ggaGFzIHRoZSB3cm9uZyB2YWx1ZSkuCiAgICBpZiAoIXNpemUuaGVpZ2h0KSB7CiAgICAgIG1vZGUgPSBkLmNvbXBhdE1vZGU7CiAgICAgIGlmIChtb2RlIHx8ICEkLnN1cHBvcnQuYm94TW9kZWwpIHsgLy8gSUUsIEdlY2tvCiAgICAgICAgZG9tT2JqZWN0ID0gbW9kZSA9PT0gJ0NTUzFDb21wYXQnID8KICAgICAgICAgIGRvY3VtZW50RWxlbWVudCA6IC8vIFN0YW5kYXJkcwogICAgICAgICAgZC5ib2R5OyAvLyBRdWlya3MKICAgICAgICBzaXplID0gewogICAgICAgICAgaGVpZ2h0OiBkb21PYmplY3QuY2xpZW50SGVpZ2h0LAogICAgICAgICAgd2lkdGg6ICBkb21PYmplY3QuY2xpZW50V2lkdGgKICAgICAgICB9OwogICAgICB9CiAgICB9CiAgICByZXR1cm4gc2l6ZTsKICB9CgogIGZ1bmN0aW9uIGdldFZpZXdwb3J0T2Zmc2V0KCkgewogICAgcmV0dXJuIHsKICAgICAgdG9wOiAgdy5wYWdlWU9mZnNldCB8fCBkb2N1bWVudEVsZW1lbnQuc2Nyb2xsVG9wICAgfHwgZC5ib2R5LnNjcm9sbFRvcCwKICAgICAgbGVmdDogdy5wYWdlWE9mZnNldCB8fCBkb2N1bWVudEVsZW1lbnQuc2Nyb2xsTGVmdCAgfHwgZC5ib2R5LnNjcm9sbExlZnQKICAgIH07CiAgfQoKICBmdW5jdGlvbiBjaGVja0luVmlldygpIHsKICAgIHZhciAkZWxlbWVudHMgPSAkKCksIGVsZW1lbnRzTGVuZ3RoLCBpID0gMDsKCiAgICAkLmVhY2goaW52aWV3T2JqZWN0cywgZnVuY3Rpb24oaSwgaW52aWV3T2JqZWN0KSB7CiAgICAgIHZhciBzZWxlY3RvciAgPSBpbnZpZXdPYmplY3QuZGF0YS5zZWxlY3RvciwKICAgICAgICAgICRlbGVtZW50ICA9IGludmlld09iamVjdC4kZWxlbWVudDsKICAgICAgJGVsZW1lbnQgPSBzZWxlY3RvciA/ICRlbGVtZW50LmZpbmQoc2VsZWN0b3IpIDogJGVsZW1lbnQ7CiAgICAgICRlbGVtZW50LmRhdGEoJ2ludmlld19vcHRzJywgaW52aWV3T2JqZWN0LmRhdGEuZGF0YSk7CiAgICAgICRlbGVtZW50cyA9ICRlbGVtZW50cy5hZGQoJGVsZW1lbnQpOwogICAgfSk7CgogICAgZWxlbWVudHNMZW5ndGggPSAkZWxlbWVudHMubGVuZ3RoOwogICAgCiAgICBpZiAoZGVidWcpIHsKICAgICAgY29uc29sZS5sb2coJ2ludmlld09iamVjdHM6ICcpOwogICAgICBjb25zb2xlLmxvZyhpbnZpZXdPYmplY3RzKTsKICAgICAgY29uc29sZS5sb2coJ2VsZW1lbnRzTGVuZ3RoOiAnICsgZWxlbWVudHNMZW5ndGgpOwogICAgfQogICAgCiAgICBpZiAoZWxlbWVudHNMZW5ndGgpIHsKICAgICAgdmlld3BvcnRTaXplICAgPSB2aWV3cG9ydFNpemUgICB8fCBnZXRWaWV3cG9ydFNpemUoKTsKICAgICAgdmlld3BvcnRPZmZzZXQgPSB2aWV3cG9ydE9mZnNldCB8fCBnZXRWaWV3cG9ydE9mZnNldCgpOwogICAgICAKICAgICAgaWYgKGRlYnVnKSB7CiAgICAgICAgY29uc29sZS5sb2coJ3ZpZXdwb3J0U2l6ZTogJyk7CiAgICAgICAgY29uc29sZS5sb2codmlld3BvcnRTaXplKTsKICAgICAgICBjb25zb2xlLmxvZygndmlld3BvcnRPZmZzZXQ6ICcpOwogICAgICAgIGNvbnNvbGUubG9nKHZpZXdwb3J0T2Zmc2V0KTsKICAgICAgfQoKICAgICAgZm9yICg7IGk8ZWxlbWVudHNMZW5ndGg7IGkrKykgewogICAgICAgIC8vIElnbm9yZSBlbGVtZW50cyB0aGF0IGFyZSBub3QgaW4gdGhlIERPTSB0cmVlCiAgICAgICAgaWYgKCEkLmNvbnRhaW5zKGRvY3VtZW50RWxlbWVudCwgJGVsZW1lbnRzW2ldKSkgewogICAgICAgICAgY29udGludWU7CiAgICAgICAgfQoKICAgICAgICB2YXIgJGVsZW1lbnQgICAgICA9ICQoJGVsZW1lbnRzW2ldKSwKICAgICAgICAgICAgZWxlbWVudFNpemUgICA9IHsgaGVpZ2h0OiAkZWxlbWVudC5oZWlnaHQoKSwgd2lkdGg6ICRlbGVtZW50LndpZHRoKCkgfSwKICAgICAgICAgICAgZWxlbWVudE9mZnNldCA9ICRlbGVtZW50Lm9mZnNldCgpLAogICAgICAgICAgICBpblZpZXcgICAgICAgID0gJGVsZW1lbnQuZGF0YSgnaW52aWV3JyksCiAgICAgICAgICAgIHRocmVzaG9sZCAgICAgPSAkZWxlbWVudC5kYXRhKCdpbnZpZXdfb3B0cycpLnRocmVzaG9sZCwKICAgICAgICAgICAgdmlzaWJsZVBhcnRYLAogICAgICAgICAgICB2aXNpYmxlUGFydFksCiAgICAgICAgICAgIHZpc2libGVQYXJ0c01lcmdlZDsKCiAgICAgICAgaWYgKHRocmVzaG9sZCkgewogICAgICAgICAgaWYgKHRoaXMuZGVidWcpIHtjb25zb2xlLmxvZygnVGhyZXNob2xkOiAnICsgdGhyZXNob2xkKTt9CiAgICAgICAgICB2YXIgb3JpZ190b3AgPSBlbGVtZW50T2Zmc2V0LnRvcCwKICAgICAgICAgICAgICBvcmlnX2xlZnQgPSBlbGVtZW50T2Zmc2V0LmxlZnQ7CiAgICAgICAgICBlbGVtZW50T2Zmc2V0ID0gewogICAgICAgICAgICB0b3A6IG9yaWdfdG9wIC0gdGhyZXNob2xkLAogICAgICAgICAgICBsZWZ0OiBvcmlnX2xlZnQgLSB0aHJlc2hvbGQKICAgICAgICAgIH07CiAgICAgICAgfQoKICAgICAgICBpZiAoZGVidWcpIHsKICAgICAgICAgIGNvbnNvbGUubG9nKCdlbGVtZW50U2l6ZTogJyk7CiAgICAgICAgICBjb25zb2xlLmxvZyhlbGVtZW50U2l6ZSk7CiAgICAgICAgICBjb25zb2xlLmxvZygnZWxlbWVudE9mZnNldDogJyk7CiAgICAgICAgICBjb25zb2xlLmxvZyhlbGVtZW50T2Zmc2V0KTsKICAgICAgICB9CgogICAgICAgIC8vIERvbid0IGFzayBtZSB3aHkgYmVjYXVzZSBJIGhhdmVuJ3QgZmlndXJlZCBvdXQgeWV0OgogICAgICAgIC8vIHZpZXdwb3J0T2Zmc2V0IGFuZCB2aWV3cG9ydFNpemUgYXJlIHNvbWV0aW1lcyBzdWRkZW5seSBudWxsIGluIEZpcmVmb3ggNS4KICAgICAgICAvLyBFdmVuIHRob3VnaCBpdCBzb3VuZHMgd2VpcmQ6CiAgICAgICAgLy8gSXQgc2VlbXMgdGhhdCB0aGUgZXhlY3V0aW9uIG9mIHRoaXMgZnVuY3Rpb24gaXMgaW50ZXJmZXJyZWQgYnkgdGhlIG9ucmVzaXplL29uc2Nyb2xsIGV2ZW50CiAgICAgICAgLy8gd2hlcmUgdmlld3BvcnRPZmZzZXQgYW5kIHZpZXdwb3J0U2l6ZSBhcmUgdW5zZXQKICAgICAgICBpZiAoIXZpZXdwb3J0T2Zmc2V0IHx8ICF2aWV3cG9ydFNpemUpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIC8vIEhtbW0sIHRoYXQgd29ya3MgYmV0dGVyLCBFbGVtZW50IGRvZXNuJ3QgaGF2ZSB0byBiZSBjb21wbGV0ZWx5IGluIHZpZXdwb3J0LgogICAgICAgIC8vIGlmIChlbGVtZW50T2Zmc2V0LnRvcCArIGVsZW1lbnRTaXplLmhlaWdodCA+IHZpZXdwb3J0T2Zmc2V0LnRvcCAmJgogICAgICAgIC8vICAgICBlbGVtZW50T2Zmc2V0LnRvcCA8IHZpZXdwb3J0T2Zmc2V0LnRvcCArIHZpZXdwb3J0U2l6ZS5oZWlnaHQgJiYKICAgICAgICAvLyAgICAgZWxlbWVudE9mZnNldC5sZWZ0ICsgZWxlbWVudFNpemUud2lkdGggPiB2aWV3cG9ydE9mZnNldC5sZWZ0ICYmCiAgICAgICAgLy8gICAgIGVsZW1lbnRPZmZzZXQubGVmdCA8IHZpZXdwb3J0T2Zmc2V0LmxlZnQgKyB2aWV3cG9ydFNpemUud2lkdGgpIHsKICAgICAgICBpZiAoZWxlbWVudE9mZnNldC50b3AgPCB2aWV3cG9ydE9mZnNldC50b3AgKyB2aWV3cG9ydFNpemUuaGVpZ2h0ICYmCiAgICAgICAgICAgIGVsZW1lbnRPZmZzZXQubGVmdCA8IHZpZXdwb3J0T2Zmc2V0LmxlZnQgKyB2aWV3cG9ydFNpemUud2lkdGgpIHsKICAgICAgICAgIHZpc2libGVQYXJ0WCA9ICh2aWV3cG9ydE9mZnNldC5sZWZ0ID4gZWxlbWVudE9mZnNldC5sZWZ0ID8KICAgICAgICAgICAgJ3JpZ2h0JyA6ICh2aWV3cG9ydE9mZnNldC5sZWZ0ICsgdmlld3BvcnRTaXplLndpZHRoKSA8IChlbGVtZW50T2Zmc2V0LmxlZnQgKyBlbGVtZW50U2l6ZS53aWR0aCkgPwogICAgICAgICAgICAnbGVmdCcgOiAnYm90aCcpOwogICAgICAgICAgdmlzaWJsZVBhcnRZID0gKHZpZXdwb3J0T2Zmc2V0LnRvcCA+IGVsZW1lbnRPZmZzZXQudG9wID8KICAgICAgICAgICAgJ2JvdHRvbScgOiAodmlld3BvcnRPZmZzZXQudG9wICsgdmlld3BvcnRTaXplLmhlaWdodCkgPCAoZWxlbWVudE9mZnNldC50b3AgKyBlbGVtZW50U2l6ZS5oZWlnaHQpID8KICAgICAgICAgICAgJ3RvcCcgOiAnYm90aCcpOwogICAgICAgICAgdmlzaWJsZVBhcnRzTWVyZ2VkID0gdmlzaWJsZVBhcnRYICsgJy0nICsgdmlzaWJsZVBhcnRZOwogICAgICAgICAgLy8gdW5jb21tZW50IGlmIHlvdSB3YW50IHRvIHRyaWdnZXIgb25seSBpZiB0aGUgY3VycmVudCBjaGVjayByZXN1bHQgZGlmZmVycyBmcm9tIHRlaCBsYXN0IG9uZQogICAgICAgICAgLy8gaWYgKCFpblZpZXcgfHwgaW5WaWV3ICE9PSB2aXNpYmxlUGFydHNNZXJnZWQpIHsKICAgICAgICAgICRlbGVtZW50LmRhdGEoJ2ludmlldycsIHZpc2libGVQYXJ0c01lcmdlZCkudHJpZ2dlcignaW52aWV3JywgW3RydWUsIHZpc2libGVQYXJ0WCwgdmlzaWJsZVBhcnRZXSk7CiAgICAgICAgICAvLyB9CiAgICAgICAgfSBlbHNlIGlmIChpblZpZXcpIHsKICAgICAgICAgICRlbGVtZW50LmRhdGEoJ2ludmlldycsIGZhbHNlKS50cmlnZ2VyKCdpbnZpZXcnLCBbZmFsc2VdKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9CgogIGZ1bmN0aW9uIGJpbmRUb1ZpZXdQb3J0Q2hhbmdlRXZlbnRzKCkgewogICAgJCh3KS5iaW5kKCdzY3JvbGwuaW52aWV3IHJlc2l6ZS5pbnZpZXcnLCAkLnRocm90dGxlKDI1MCwgZnVuY3Rpb24oKSB7CiAgICAgIGlmIChkZWJ1ZykgewogICAgICAgIGNvbnNvbGUubG9nKCdIZWxsbyBpbnZpZXcuanMgY2hlY2tzIGl0IG91dCEnKTsKICAgICAgfQogICAgICB2aWV3cG9ydFNpemUgPSB2aWV3cG9ydE9mZnNldCA9IG51bGw7CiAgICAgIGNoZWNrSW5WaWV3KCk7CiAgICB9KSk7CgogICAgLy8gSUUgPCA5IHNjcm9sbHMgdG8gZm9jdXNlZCBlbGVtZW50cyB3aXRob3V0IGZpcmluZyB0aGUgJ3Njcm9sbCcgZXZlbnQKICAgIC8vIHVuY29tbWVudCwgaWYgeW91IHdhbnQgc3BlY2lhbCB0cmVhdG1lbnQgb2YgSUUgPCA5CiAgICAvLyBpZiAoIWRvY3VtZW50RWxlbWVudC5hZGRFdmVudExpc3RlbmVyICYmIGRvY3VtZW50RWxlbWVudC5hdHRhY2hFdmVudCkgewogICAgLy8gICBkb2N1bWVudEVsZW1lbnQuYXR0YWNoRXZlbnQoJ29uZm9jdXNpbicsIGZ1bmN0aW9uKCkgewogICAgLy8gICAgIHZpZXdwb3J0T2Zmc2V0ID0gbnVsbDsKICAgIC8vICAgfSk7CiAgICAvLyB9CiAgfQogIAogIGZ1bmN0aW9uIHVuYmluZFRvVmlld1BvcnRDaGFuZ2VFdmVudHMoKSB7CiAgICAkKHcpLnVuYmluZCgnc2Nyb2xsLmludmlldyByZXNpemUuaW52aWV3Jyk7CiAgfQoKICAvLyBVc2Ugc2V0SW50ZXJ2YWwgaW4gb3JkZXIgdG8gYWxzbyBtYWtlIHN1cmUgdGhpcyBjYXB0dXJlcyBlbGVtZW50cyB3aXRoaW4KICAvLyAnb3ZlcmZsb3c6c2Nyb2xsJyBlbGVtZW50cyBvciBlbGVtZW50cyB0aGF0IGFwcGVhcmVkIGluIHRoZSBkb20gdHJlZSBkdWUgdG8KICAvLyBkb20gbWFuaXB1bGF0aW9uIGFuZCByZWZsb3cKICAvLyBvbGQ6ICQod2luZG93KS5zY3JvbGwoY2hlY2tJblZpZXcpOwogIC8vCiAgLy8gQnkgdGhlIHdheSwgaU9TIChpUGFkLCBpUGhvbmUsIC4uLikgc2VlbXMgdG8gbm90IGV4ZWN1dGUsIG9yIGF0IGxlYXN0IGRlbGF5cwogIC8vIGludGVydmFscyB3aGlsZSB0aGUgdXNlciBzY3JvbGxzLiBUaGVyZWZvcmUgdGhlIGludmlldyBldmVudCBtaWdodCBmaXJlIGEgYml0IGxhdGUgdGhlcmUKICAvLyBzZXRJbnRlcnZhbChjaGVja0luVmlldywgMjUwKTsKICAKfSk7CgpkZWZpbmUoJ2dhbGxlcnkvdmlld3MvdGh1bWIuY29udGFpbmVyLmR5bmFtaWMnLFsKICAnanF1ZXJ5JywKICAnaW1hZ2VzbG9hZGVkL2ltYWdlc2xvYWRlZCcsCiAgJ2xpYi9qcXVlcnkuaW52aWV3JywKICAndW5kZXJzY29yZScsCiAgJ2JhY2tib25lJywKICAnZ2FsbGVyeS92aWV3cy90aHVtYi5jb250YWluZXInLAogICdnYWxsZXJ5L3ZpZXdzL3RodW1iLnZpZXcnLAogICdnYWxsZXJ5L3V0aWxzL3Jlc3BvbnNpdmUuYWRhcHRlcicKXSwgZnVuY3Rpb24oJCwgSW1hZ2VzTG9hZGVkLCBub3BlLCBfLCBCYWNrYm9uZSwgVGh1bWJDb250YWluZXIsIFRodW1iVmlldywgUmVzcG9uc2l2ZUFkYXB0ZXIpIHsKCiAgLyoKICAgKiBBZGRzIHRoZSBUaHVtYnMgaW4gdGhlIEdhbGxlcnkganNvbiBkeW5hbWljYWxseSwgd2hlbiB0aGUganNvbiBpcyBsb2FkZWQsIHRvIAogICAqIHRoZSBUaHVtYiBDb250YWluZXIuIEFuZCBub3QgYWxsIHRodW1icyBhdCBvbmNlLCBidXQgaW4gY2h1bmtzIGFzIGEgJ3N0b3BwZXInCiAgICogZWxlbWVudCBjb21lcyBpbnRvIHRoZSB2aWV3cG9ydCAoanF1ZXJ5LmludmlldykuCiAgICovCiAgdmFyIFRodW1iQ29udGFpbmVyRHluYW1pYyA9IFRodW1iQ29udGFpbmVyLmV4dGVuZCh7CiAgICAKICAgIGRlYnVnOiBmYWxzZSwKICAgIAogICAgLy8gb3ZlcnJpZGUKICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uKCkgewogICAgICAvLyBSZWFkIGluIGlubGluZSBUZW1wbGF0ZSAKICAgICAgdGhpcy50aHVtYlRlbXBsYXRlID0gdGhpcy5nZXRUaHVtYlRlbXBsYXRlKCk7CiAgICAgIAogICAgICB0aGlzLmxvYWRlZEltYWdlcyA9IDA7CiAgICAgIHRoaXMudGhyZXNob2xkID0gMzAwOwogICAgICAKICAgICAgVGh1bWJDb250YWluZXIucHJvdG90eXBlLmluaXRpYWxpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgCiAgICAgIHRoaXMuc3RvcHBlciA9IHRoaXMuJGVsLm5leHQoJy5zdG9wcGVyJyk7CiAgICAgIC8vIGNoZWNrIGZvciBuZXcgU2xpZGVyIGltYWdlID0+IGxvYWQgdGh1bWJzLi4uCiAgICAgIHRoaXMubGlzdGVuVG8odGhpcy5tb2RlbCwgJ3NsaWRlcjpuZXdJbWFnZScsIHRoaXMub25OZXdTbGlkZXJJbWFnZSk7CiAgICAgIC8vIGNoZWNrIGZvciBzbGlkZXIgZ2V0cyBjbG9zZWQgPT4gc2Nyb2xsIHRvIGN1cnJlbnQgaW1hZ2UKICAgICAgdGhpcy5saXN0ZW5Ubyh0aGlzLm1vZGVsLCAnc2xpZGVyOmNsb3NpbmcnLCB0aGlzLm9uU2xpZGVyQ2xvc2luZyk7CiAgICB9LAogICAgCiAgICBpbml0R2FsbGVyeTogZnVuY3Rpb24oKSB7CiAgICAgIC8vIGdldCBvcHRpb25zIGZyb20gZmV0Y2hlZCBHYWxsZXJ5TW9kZWwKICAgICAgdmFyIGdhbGxlcnlPcHRzID0gdGhpcy5tb2RlbC5nZXQoJ29wdHMnKTsKICAgICAgdGhpcy5maXJzdENodW5rID0gUmVzcG9uc2l2ZUFkYXB0ZXIuZ2V0T3B0aW9uQnlNZWRpYVR5cGUoZ2FsbGVyeU9wdHMsICdmaXJzdF9jaHVuaycpOwogICAgICB0aGlzLmNodW5rU2l6ZSA9IFJlc3BvbnNpdmVBZGFwdGVyLmdldE9wdGlvbkJ5TWVkaWFUeXBlKGdhbGxlcnlPcHRzLCAnY2h1bmtfc2l6ZScpOwoKICAgICAgLy8gbm93IGFsbCBpbWFnZSBtb2RlbHMgYXJlIGZldGNoZWQgKHRoZSBjb2xsZWN0aW9uIGlzIGluaXRpYWxpemVkKSwgbm93IHdlIGNhbiAKICAgICAgLy8gbGlzdGVuIGZvciBldmVudHMgKHJlc2V0LCByZW1vdmUpIG9uIHRoZSBpbWFnZXMgY29sbGVjdGlvbgogICAgICB0aGlzLmxpc3RlblRvKHRoaXMubW9kZWwuZ2V0KCdpbWFnZXMnKSwgJ3Jlc2V0JywgdGhpcy5pbml0VGh1bWJzKTsKICAgICAgdGhpcy5saXN0ZW5Ubyh0aGlzLm1vZGVsLmdldCgnaW1hZ2VzJyksICdyZW1vdmUnLCB0aGlzLnJlbW92ZVRodW1iKTsKICAgIH0sCgogICAgLy8gb3ZlcnJpZGUKICAgIGluaXRUaHVtYnM6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLnJlbW92ZSgpOyAvLyByZW1vdmUgb2xkIFRodW1icwoKICAgICAgdGhpcy5fbGlzdGVuaW5nRm9ySW52aWV3ID0gZmFsc2U7CgogICAgICB0aGlzLmltYWdlc1RvTG9hZCA9IHRoaXMubW9kZWwuZ2V0KCdpbWFnZXMnKS5tb2RlbHMuc2xpY2UoKTsgLy8gc2xpY2UoKSBtZWFucyBjbG9uZSgpCiAgICAgIAogICAgICAvLyBSZW5kZXIgaW5pdGlhbCBjaHVuayBvZiB0aHVtYnMgCiAgICAgIHZhciByZW5kZXJlZFRodW1iRWxlbWVudHMgPSB0aGlzLl9yZW5kZXJDaHVuayh0aGlzLmZpcnN0Q2h1bmspOwogICAgICAKICAgICAgLy8gUmVzZXQgTG9hZGluZyBpbmRpY2F0b3Igb24gQ29udGFpbmVyCiAgICAgIHRoaXMuJGVsLnJlbW92ZUNsYXNzKCdsb2FkaW5nJyk7CiAgICAgIAogICAgICAvLyBDaGVjayB3aGVuIFRodW1icyBhcmUgbG9hZGVkID0+IEhpZGUgaW5kaWNhdG9yICYgcmUtYXJyYW5nZSBtYXNvbnJ5CiAgICAgIHRoaXMuX2NoZWNrSW1hZ2VzTG9hZGVkKHJlbmRlcmVkVGh1bWJFbGVtZW50cyk7CiAgICB9LAoKICAgIHJlbW92ZTogZnVuY3Rpb24oKSB7CiAgICAgIC8vIFRPRE86IHdlIG9ubHkgcmVtb3ZlIHRoZSBET00gZWxlbWVudHMsIGluc3RlYWQgdGhlIHRodW1iVmlld3Mgc2hvdWxkIGdldCByZW1vdmVkCiAgICAgIHRoaXMuJGVsLmNoaWxkcmVuKCkucmVtb3ZlKCk7CiAgICB9LAoKICAgIHJlbW92ZVRodW1iOiBmdW5jdGlvbihtb2RlbCwgY29sbGVjdGlvbiwgb3B0aW9ucykgewogICAgICBtb2RlbC5nZXRUaHVtYlZpZXcoKS5yZW1vdmUoKTsKICAgIH0sCiAgICAgICAgCiAgICByZW5kZXJOZXh0Q2h1bms6IGZ1bmN0aW9uKCkgewogICAgICAvLyBIQUNLLCB3aGVuIGltYWdlc0xvYWRlZCBkb2Vzbid0IHJlYWNoICdhbHdheXMnIGNhbGxiYWNrIChUT0RPOiBtdXNzIGRhcyBub2NoIHNlaW4/KQogICAgICB0aGlzLnRpbWVvdXRCaW5kID0gd2luZG93LnNldFRpbWVvdXQoXy5iaW5kKHRoaXMuX2JpbmRJbnZpZXcsIHRoaXMpLCAyMDAwKTsKICAgICAgLy8gdW5iaW5kIHN0b3BwZXIKICAgICAgdGhpcy5fdW5iaW5kSW52aWV3KCk7CiAgICAgIC8vIHJlbmRlciBuZXh0IGNodW5rIG9mIHRodW1icwogICAgICB2YXIgcmVuZGVyZWRUaHVtYkVsZW1lbnRzID0gdGhpcy5fcmVuZGVyQ2h1bmsodGhpcy5jaHVua1NpemUpOwogICAgICAvLyByZWdpc3RlciBsb2FkZWQgaW1hZ2VzCiAgICAgIHRoaXMuX2NoZWNrSW1hZ2VzTG9hZGVkKHJlbmRlcmVkVGh1bWJFbGVtZW50cyk7CiAgICB9LAogICAgCiAgICAvLyAocmUpbGF5b3V0IG1hc29ucnkKICAgIC8vIFRPRE8vUkVGQUNUT1I6IHdpcmQgdm9uIGltYWdlc2xvYWRlZCBhdWZnZXJ1ZmVuID0+IGVpbiB3ZWl0ZXJlcy9hbGxlIEJpbGQoZXIpIHd1cmRlIGZlcnRpZyBnZWxhZGVuLgogICAgYXJyYW5nZVRodW1iczogZnVuY3Rpb24oKSB7fSwKCiAgICAvLyBjYWxsYmFjayBmb3IgYSBuZXcgdGh1bWJWaWV3IGlzIGluc3RhbmNpYXRlZCBhbmQgYWRkZWQgdG8gdGhlIGRvbQogICAgdGh1bWJBZGRlZDogZnVuY3Rpb24odGh1bWJWaWV3KSB7fSwKCiAgICAvLyBCaW5kcyB0aGlzLl9vblN0b3BwZXJBcHBlYXJlZCBmdW5jdGlvbiB0byBpbnZpZXcgZXZlbnQKICAgIF9iaW5kSW52aWV3OiBmdW5jdGlvbigpIHsKICAgICAgd2luZG93LmNsZWFyVGltZW91dCh0aGlzLnRpbWVvdXRCaW5kKTsKICAgICAgaWYgKHRoaXMuaW1hZ2VzVG9Mb2FkLmxlbmd0aCAmJiAhdGhpcy5fbGlzdGVuaW5nRm9ySW52aWV3KSB7CiAgICAgICAgdGhpcy5zdG9wcGVyLnNob3coKTsKICAgICAgICB0aGlzLnN0b3BwZXIub24oJ2ludmlldycsIHsgdGhyZXNob2xkOiB0aGlzLnRocmVzaG9sZCB9LCBfLmJpbmQodGhpcy5fb25TdG9wcGVyQXBwZWFyZWQsIHRoaXMpKTsKICAgICAgICB0aGlzLl9saXN0ZW5pbmdGb3JJbnZpZXcgPSB0cnVlOwogICAgICAgICQod2luZG93KS50cmlnZ2VyKCdzY3JvbGwnKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLnN0b3BwZXIuaGlkZSgpOwogICAgICB9CiAgICB9LAogICAgLy8gVW5iaW5kcyB0aGlzLl9vblN0b3BwZXJBcHBlYXJlZAogICAgX3VuYmluZEludmlldzogZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMuc3RvcHBlci5vZmYoJ2ludmlldycpOwogICAgICB0aGlzLl9saXN0ZW5pbmdGb3JJbnZpZXcgPSBmYWxzZTsKICAgIH0sCiAgICAvLyBIYW5kbGVyIGZvciAnZW5kbGVzcy1zY3JvbGwnIGxpa2UgaW52aWV3LmpzIGV2ZW50cwogICAgX29uU3RvcHBlckFwcGVhcmVkOiBmdW5jdGlvbihldmVudCwgaXNJblZpZXcsIHZpc2libGVQYXJ0WCwgdmlzaWJsZVBhcnRZKSB7CiAgICAgIGlmIChpc0luVmlldykgewogICAgICAgIGlmICh0aGlzLmRlYnVnKSB7Y29uc29sZS5sb2coJ1NUb1BQZXIgZ2VzaWNodGV0IScpO30KICAgICAgICB0aGlzLnJlbmRlck5leHRDaHVuaygpOwogICAgICB9IGVsc2UgewogICAgICAgIGlmICh0aGlzLmRlYnVnKSB7Y29uc29sZS5sb2coJ1NUb3BwZXIgb3V0IG9mIHNpZ2h0IScpO30KICAgICAgfQogICAgfSwKICAgIAogICAgLy8gcmV0dXJucyBudW1iZXIgb2YgcmVtYWluaW5nIGltYWdlc1RvTG9hZAogICAgX3JlbmRlckNodW5rOiBmdW5jdGlvbihjaHVua1NpemUpIHsKICAgICAgLy8gSXRlYXJ0aW5nIG92ZXIgdGhlIGxvYWRlZCBJbWFnZU1vZGVsIG9iamVjdHMgYW5kIHJlbmRlciB0aGVtCiAgICAgIHZhciByZW5kZXJlZFRodW1iRWxlbWVudHMgPSBbXTsKICAgICAgdmFyIGltYWdlTW9kZWw7CiAgICAgIGZvcih2YXIgaT0wO2k8Y2h1bmtTaXplO2krKykgewogICAgICAgIGltYWdlTW9kZWwgPSB0aGlzLmltYWdlc1RvTG9hZC5zaGlmdCgpOwogICAgICAgIGlmIChpbWFnZU1vZGVsKSB7CiAgICAgICAgICB2YXIgdGh1bWJWaWV3ID0gbmV3IFRodW1iVmlldyh7CiAgICAgICAgICAgIG1vZGVsOiBpbWFnZU1vZGVsLAogICAgICAgICAgICBnYWxsZXJ5OiB0aGlzLm1vZGVsLAogICAgICAgICAgICB0ZW1wbGF0ZTogdGhpcy50aHVtYlRlbXBsYXRlCiAgICAgICAgICB9KTsKICAgICAgICAgIHRodW1iVmlldyA9IHRodW1iVmlldy5yZW5kZXIoKTsKICAgICAgICAgIHRoaXMuJGVsLmFwcGVuZCh0aHVtYlZpZXcuJGVsKTsKICAgICAgICAgIHRoaXMudGh1bWJBZGRlZCh0aHVtYlZpZXcpOwogICAgICAgICAgcmVuZGVyZWRUaHVtYkVsZW1lbnRzLnB1c2godGh1bWJWaWV3LmVsKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiByZW5kZXJlZFRodW1iRWxlbWVudHM7CiAgICB9LAogICAgCiAgICBfY2hlY2tJbWFnZXNMb2FkZWQ6IGZ1bmN0aW9uKHJlbmRlcmVkVGh1bWJFbGVtZW50cykgewogICAgICB2YXIgaW5zdGFuY2UgPSB0aGlzOwoKICAgICAgLy8gUmVnaXN0ZXIgaW1hZ2VzTG9hZGVkIG9uIG5ld2x5IHJlbmRlcmVkIHRodW1icyBmb3Igc3dpdGNoaW5nIAogICAgICAvLyBsb2FkaW5nL2xvYWRlZCBjbGFzc2VzCiAgICAgIG5ldyBJbWFnZXNMb2FkZWQocmVuZGVyZWRUaHVtYkVsZW1lbnRzKQogICAgICAgIC5vbigncHJvZ3Jlc3MnLCBmdW5jdGlvbihpbWFnZXNMb2FkZWQsIGxvYWRpbmdJbWFnZSkgewogICAgICAgICAgaWYgKGxvYWRpbmdJbWFnZS5pc0xvYWRlZCkgewogICAgICAgICAgICBpbnN0YW5jZS5zd2l0Y2hUaHVtYkNsYXNzKGxvYWRpbmdJbWFnZS5pbWcpOwogICAgICAgICAgICBpbnN0YW5jZS5hcnJhbmdlVGh1bWJzKCk7CiAgICAgICAgICB9CiAgICAgICAgfSkKICAgICAgICAub24oJ2Fsd2F5cycsIGZ1bmN0aW9uKCkgewogICAgICAgICAgaWYgKGluc3RhbmNlLmRlYnVnKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdsYXN0IHN0b3BwZXJBcHBlYXJlZCB0cmlnZ2VyIGNvbXBsZXRlZC4nKTsKICAgICAgICAgICAgY29uc29sZS5sb2coJ2xlZnQgb3ZlciBpbWFnZXNUb0xvYWQ6ICcgKyBpbnN0YW5jZS5pbWFnZXNUb0xvYWQubGVuZ3RoKTsKICAgICAgICAgIH0KICAgICAgICAgIHdpbmRvdy5zZXRUaW1lb3V0KF8uYmluZChpbnN0YW5jZS5hcnJhbmdlVGh1bWJzLCBpbnN0YW5jZSksIDIwMCk7CiAgICAgICAgICBpbnN0YW5jZS5fYmluZEludmlldygpOwogICAgICAgIH0pCiAgICAgICAgLm9uKCdmYWlsJywgZnVuY3Rpb24oaW5zdGFuY2UpIHsKICAgICAgICAgIGlmIChpbnN0YW5jZS5kZWJ1ZykgewogICAgICAgICAgICBjb25zb2xlLmxvZygnRkFJTCAtIGFsbCBpbWFnZXMgbG9hZGVkLCBhdCBsZWFzdCBvbmUgaXMgYnJva2VuJyk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIAogICAgICAvLyBDaGVjayBpZiBzb21lIGltYWdlcyBhcmUgbG9hZGVkIHlldCAnYmVmb3JlJyBJbWFnZXNMb2FkZWQgY2FsbAogICAgICAkKHJlbmRlcmVkVGh1bWJFbGVtZW50cykuZWFjaChmdW5jdGlvbihpZHgsIHRodW1iSW1nKSB7CiAgICAgICAgaWYgKCQodGh1bWJJbWcpLnByb3AoJ2NvbXBsZXRlJykpIHsKICAgICAgICAgIGluc3RhbmNlLnN3aXRjaFRodW1iQ2xhc3ModGh1bWJJbWcuaW1nKTsKICAgICAgICAgIGluc3RhbmNlLmFycmFuZ2VUaHVtYnMoKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSwKICAgIAogICAgLy8gVE9ETzogUmVmYWN0b3IgaW50byBUaHVtYlZpZXcKICAgIHN3aXRjaFRodW1iQ2xhc3M6IGZ1bmN0aW9uKGltZykgewogICAgICB2YXIgdGh1bWJJdGVtID0gJChpbWcpLnBhcmVudCgpOwogICAgICByZXR1cm4gdGh1bWJJdGVtLnRvZ2dsZUNsYXNzKCdsb2FkaW5nIGxvYWRlZCcpOwogICAgfSwKICAgIAogICAgb25OZXdTbGlkZXJJbWFnZTogZnVuY3Rpb24obGFyZ2VWaWV3KSB7CiAgICAgIGlmIChfLmNvbnRhaW5zKHRoaXMuaW1hZ2VzVG9Mb2FkLCBsYXJnZVZpZXcubW9kZWwpKSB7CiAgICAgICAgd2luZG93LnNldFRpbWVvdXQoXy5iaW5kKGZ1bmN0aW9uKCkge3RoaXMucmVuZGVyTmV4dENodW5rKCk7fSwgdGhpcyksIDIwMCk7CiAgICAgIH0KICAgIH0sCiAgICAKICAgIG9uU2xpZGVyQ2xvc2luZzogZnVuY3Rpb24obGFzdEN1cnJlbnRsYXJnZVZpZXcpIHsKICAgICAgaWYgKGxhc3RDdXJyZW50bGFyZ2VWaWV3KSB7CiAgICAgICAgdGhpcy5zY3JvbGxUb1RodW1iKGxhc3RDdXJyZW50bGFyZ2VWaWV3Lm1vZGVsKTsKICAgICAgfQogICAgfSwKICAgIAogICAgZ2V0VGh1bWJUZW1wbGF0ZTogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBfLnRlbXBsYXRlKCQoJyN0ZW1wbGF0ZS10aHVtYicpLmh0bWwoKSk7CiAgICB9CiAgICAKICB9KTsKICAKICByZXR1cm4gVGh1bWJDb250YWluZXJEeW5hbWljOwp9KTsKCmRlZmluZSgnZ2FsbGVyeS92aWV3cy90aHVtYi5jb250YWluZXIuZHluYW1pYy5tYXNvbnJ5JyxbCiAgJ2pxdWVyeScsCiAgJ2pxdWVyeS1icmlkZ2V0L2pxdWVyeS5icmlkZ2V0JywKICAnZmx1aWQtbWFzb25yeScsCiAgJ3VuZGVyc2NvcmUnLAogICdiYWNrYm9uZScsCiAgJ2dhbGxlcnkvdmlld3MvdGh1bWIuY29udGFpbmVyLmR5bmFtaWMnLAogICdnYWxsZXJ5L3V0aWxzL3Jlc3BvbnNpdmUuYWRhcHRlcicKXSwgZnVuY3Rpb24oJCwgbm9wZSwgRmx1aWRNYXNvbnJ5LCBfLCBCYWNrYm9uZSwgVGh1bWJDb250YWluZXJEeW5hbWljLCBSZXNwb25zaXZlQWRhcHRlcikgewoKICAkLmJyaWRnZXQoJ2ZsdWlkTWFzb25yeScsIEZsdWlkTWFzb25yeSk7CgogIC8qCiAgICogQWRkcyB0aGUgVGh1bWJzIGluIHRoZSBHYWxsZXJ5IGpzb24gZHluYW1pY2FsbHksIHdoZW4gdGhlIGpzb24gaXMgbG9hZGVkLCB0byAKICAgKiB0aGUgVGh1bWIgQ29udGFpbmVyLiBBbmQgbm90IGFsbCB0aHVtYnMgYXQgb25jZSwgYnV0IGluIGNodW5rcyBhcyBhICdzdG9wcGVyJwogICAqIGVsZW1lbnQgY29tZXMgaW50byB0aGUgdmlld3BvcnQgKGpxdWVyeS5pbnZpZXcpLgogICAqLwogIHZhciBUaHVtYkNvbnRhaW5lckR5bmFtaWNNYXNvbnJ5ID0gVGh1bWJDb250YWluZXJEeW5hbWljLmV4dGVuZCh7CiAgICAKICAgIGRlYnVnOiBmYWxzZSwKICAgIAogICAgLy8gb3ZlcnJpZGUKICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uKCkgewogICAgICBUaHVtYkNvbnRhaW5lckR5bmFtaWMucHJvdG90eXBlLmluaXRpYWxpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH0sCiAgICAKICAgIGluaXRHYWxsZXJ5OiBmdW5jdGlvbigpIHsKICAgICAgVGh1bWJDb250YWluZXJEeW5hbWljLnByb3RvdHlwZS5pbml0R2FsbGVyeS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB0aGlzLmluaXRNYXNvbnJ5KHRoaXMubW9kZWwuZ2V0KCdvcHRzJykpOwogICAgfSwKCiAgICAvKgogICAgICogbWluX2NvbF93aWR0aDogd2lkdGggb2YgY2VsbCAodGh1bWIpIGluIG1hc29ucnkgbGF5b3V0ICh0aHVtYiBjYW4gZ2V0IHRpbGwgCiAgICAgKiBkb3VibGUgaW4gc2l6ZSwgZGVwZW5kaW5nIG9uIGNvbnRhaW5lci13aWR0aCkKICAgICAqLwogICAgaW5pdE1hc29ucnk6IGZ1bmN0aW9uKGdhbGxlcnlPcHRzKSB7CiAgICAgIHRoaXMuJGVsLmZsdWlkTWFzb25yeSh7CiAgICAgICAgaXRlbVNlbGVjdG9yIDogdGhpcy5vcHRpb25zLml0ZW1TZWxlY3RvciwKICAgICAgICBtaW5Db2x1bW5XaWR0aDogUmVzcG9uc2l2ZUFkYXB0ZXIuZ2V0T3B0aW9uQnlNZWRpYVR5cGUoZ2FsbGVyeU9wdHMsICdtaW5fY29sX3dpZHRoJyksCiAgICAgICAgZ3V0dGVyOiBSZXNwb25zaXZlQWRhcHRlci5nZXRPcHRpb25CeU1lZGlhVHlwZShnYWxsZXJ5T3B0cywgJ2d1dHRlcl93aWR0aCcpLAogICAgICAgIGlzRml0V2lkdGg6IGZhbHNlCiAgICAgIH0pOwogICAgfSwKCiAgICByZW1vdmU6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLiRlbC5mbHVpZE1hc29ucnkoJ3JlbW92ZScsIHRoaXMuJGVsLmNoaWxkcmVuKCkpOwogICAgfSwKCiAgICByZW1vdmVUaHVtYjogZnVuY3Rpb24obW9kZWwsIGNvbGxlY3Rpb24sIG9wdGlvbnMpIHsKICAgICAgdmFyICRlbCA9IHRoaXMuJGVsOwogICAgICAkZWwuZmx1aWRNYXNvbnJ5KCdyZW1vdmUnLCBtb2RlbC5nZXRUaHVtYlZpZXcoKS4kZWwpOwogICAgICAkZWwuZmx1aWRNYXNvbnJ5KCk7CiAgICB9LAogICAgICAgICAgICAKICAgIC8vIChyZSlsYXlvdXQgbWFzb25yeQogICAgLy8gVE9ETy9SRUZBQ1RPUjogd2lyZCB2b24gaW1hZ2VzbG9hZGVkIGF1ZmdlcnVmZW4gPT4gZWluIHdlaXRlcmVzL2FsbGUgQmlsZChlcikgd3VyZGUgZmVydGlnIGdlbGFkZW4uCiAgICBhcnJhbmdlVGh1bWJzOiBmdW5jdGlvbigpIHsKICAgICAgdGhpcy4kZWwuZmx1aWRNYXNvbnJ5KCk7CiAgICB9LAoKICAgIC8vIGNhbGxiYWNrIGZvciBhIG5ldyB0aHVtYlZpZXcgaXMgaW5zdGFuY2lhdGVkIGFuZCBhZGRlZCB0byB0aGUgZG9tCiAgICB0aHVtYkFkZGVkOiBmdW5jdGlvbih0aHVtYlZpZXcpIHsKICAgICAgdGhpcy4kZWwuZmx1aWRNYXNvbnJ5KCdhcHBlbmRlZCcsIHRodW1iVmlldy4kZWwpOwogICAgfQoKICB9KTsKICAKICByZXR1cm4gVGh1bWJDb250YWluZXJEeW5hbWljTWFzb25yeTsKfSk7CgpkZWZpbmUoJ2dhbGxlcnkvdmlld3MvbGFyZ2UudmlldycsWwogICdqcXVlcnknLAogICd1bmRlcnNjb3JlJywKICAnYmFja2JvbmUnCl0sCmZ1bmN0aW9uKCQsIF8sIEJhY2tib25lKSB7CiAgLyoKICAgKiBNb2RlbDogSW1hZ2VNb2RlbAogICAqIEVsZW1lbnQ6IExhcmdlIDxpbWc+CiAgICogCiAgICogI3NsaWRlcjogU2xpZGVyVmlldwogICAqLwogIHZhciBMYXJnZVZpZXcgPSBCYWNrYm9uZS5WaWV3LmV4dGVuZCh7CiAgICAKICAgIGRlYnVnOiBmYWxzZSwKICAgIAogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMuc2xpZGVyID0gdGhpcy5vcHRpb25zLnNsaWRlcjsKICAgICAgCiAgICAgIHRoaXMuY3VycmVudFNsaWRlclJhdGlvID0gdW5kZWZpbmVkOwogICAgICB0aGlzLmN1ckRpbXMgPSAge307CiAgICAgIAogICAgICB0aGlzLmxhcmdlQXR0cnMgPSB0aGlzLm1vZGVsLmdldExhcmdlKCk7CiAgICAgIAogICAgICAvLyBTZXQgdGhpcy4kZWwgdG8gbmV3IGltZwogICAgICB0aGlzLnNldEVsZW1lbnQoJCgnPGltZy8+JykpOwogICAgICB0aGlzLiRlbAogICAgICAgIC5hdHRyKCdzcmMnLCB0aGlzLmxhcmdlQXR0cnMuc3JjKQogICAgICAgIC8vIFNldCBNYXgtV2lkdGggYW5kIE1heC1IZWlnaHQgZm9yIG5vdCB1cHNjYWxpbmcgdGhlIGltYWdlIGdyZWF0ZXIgdGhlbgogICAgICAgIC8vIGl0cyBvcmlnaW5hbCBkaW1lbnNpb25zLgogICAgICAgIC5jc3MoewogICAgICAgICAgJ21heC13aWR0aCc6IHRoaXMubGFyZ2VBdHRycy53aWR0aCwKICAgICAgICAgICdtYXgtaGVpZ2h0JzogdGhpcy5sYXJnZUF0dHJzLmhlaWdodAogICAgICAgIH0pOwogICAgICAKICAgICAgdGhpcy5tb2RlbC5zZXRMYXJnZVZpZXcodGhpcyk7CiAgICB9LAogICAgCiAgICBldmVudHM6IHsKICAgICAgJ2xvYWQnOiAnbG9hZGVkJwogICAgfSwKCiAgICByZXNpemU6IGZ1bmN0aW9uKCkgewogICAgICAvLyBEb24ndCBkbyBub3RoaW5nLCBpZiB0aGUgdHJheSBzaXplIGhhc24ndCBjaGFuZ2VkCiAgICAgIGlmICh0aGlzLmN1cnJlbnRTbGlkZXJSYXRpbyAhPT0gdGhpcy5zbGlkZXIucmF0aW8pIHsKICAgICAgICAKICAgICAgICAvLyBTYXZlIGN1cnJlbnQgVHJheSBSYXRpbyBmb3IgbmV4dCBjYWxjLi4KICAgICAgICB0aGlzLmN1cnJlbnRTbGlkZXJSYXRpbyA9IHRoaXMuc2xpZGVyLnJhdGlvOwogICAgCiAgICAgICAgLy8gQ2FsY3VsYXRpbmcgbmV3IERpbWVuc2lvbnMKICAgICAgICB0aGlzLmN1ckRpbXMgPSB0aGlzLl9jYWxjdWxhdGVEaW1zKCk7CiAgICAgIAogICAgICAgIC8vIFNldCB0aGUgSW1hZ2UgRGltZW5zaW9ucyBmb3IgZml0dGluZyBpbiBhbmQgZmlsbGluZyBpdCdzIGNvbnRhaW5lcgogICAgICAgIC8vIGluIHNldFRpbWVvdXQsIHNvIHRoYXQgdGhlIHJlc2V0IGZyb20gYWJvdmUgZ2V0cyB0aW1lIHRvIGJlIGFwcGxpZWQKICAgICAgICB2YXIgbGFyZ2UgPSB0aGlzOwogICAgICAgIHdpbmRvdy5zZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgbGFyZ2UuJGVsLmFuaW1hdGUoewogICAgICAgICAgICB3aWR0aDogbGFyZ2UuY3VyRGltc1sncHgnXVswXSwvLyArICdweCcsIC8vbmV3RGltc1swXSwKICAgICAgICAgICAgaGVpZ2h0OiBsYXJnZS5jdXJEaW1zWydweCddWzFdLy8gKyAncHgnLCAvL25ld0RpbXNbMV0KICAgICAgICAgIH0sIDApOwogICAgICAgIH0sIDApOwogICAgICB9CiAgICB9LAogICAgCiAgICBnZXRXaWR0aDogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB0aGlzLmN1ckRpbXNbJ3B4J11bMF07CiAgICB9LAogICAgCiAgICBnZXRIZWlnaHQ6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gdGhpcy5jdXJEaW1zWydweCddWzFdOwogICAgfSwKICAgIAogICAgLyoKICAgICAqIEJlcmVjaG5ldCBkaWUgdGF0c8OkY2hsaWNoZW4gRGltZW5zaW9uLVdlcnRlICAgICAgCiAgICAgKi8KICAgIF9jYWxjdWxhdGVEaW1zOiBmdW5jdGlvbigpIHsKICAgICAgdmFyIGltZ09yaWVudCA9IHRoaXMubW9kZWwuZ2V0KCdvcmllbnRhdGlvbicpOwogICAgICBpZiAoaW1nT3JpZW50ID09PSAnbGFuZHNjYXBlJykgewogICAgICAgIHRoaXMuX3NldExhcmdlVG9GdWxsV2l0aCgpOwogICAgICAgIC8vIHRvIGhpZ2ggZm9yIHRoZSBzbGlkZXIsIHdoZW4gc2V0IHRvIGZ1bGwgc2xpZGVyIHdpZHRoPwogICAgICAgIGlmICh0aGlzLmN1ckRpbXNbJ3B4J11bMV0gPiB0aGlzLnNsaWRlci5oZWlnaHQpIHsKICAgICAgICAgIGlmICh0aGlzLmRlYnVnKSB7Y29uc29sZS5sb2coJ3VwcywgaW1hZ2UgdG8gaGlnaCBmb3Igc2xpZGVyLCB3aGVuIHNldCB0byBmdWxsIHNsaWRlciB3aWR0aCEnKTt9CiAgICAgICAgICB0aGlzLl9zZXRMYXJnZVRvRnVsbEhlaWdodCgpOwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmIChpbWdPcmllbnQgPT09ICdwb3J0cmFpdCcpIHsKICAgICAgICB0aGlzLl9zZXRMYXJnZVRvRnVsbEhlaWdodCgpOwogICAgICAgIC8vIHRvIHdpZGUgZm9yIHRoZSBzbGlkZXIsIHdoZW4gc2V0IHRvIGZ1bGwgc2xpZGVyIGhlaWdodD8KICAgICAgICBpZiAodGhpcy5jdXJEaW1zWydweCddWzBdID4gdGhpcy5zbGlkZXIud2lkdGgpIHsKICAgICAgICAgIGlmICh0aGlzLmRlYnVnKSB7Y29uc29sZS5sb2coJ3VwcywgaW1hZ2UgdG8gd2lkZSBmb3Igc2xpZGVyLCB3aGVuIHNldCB0byBmdWxsIHNsaWRlciBoZWlnaHQhJyk7fQogICAgICAgICAgdGhpcy5fc2V0TGFyZ2VUb0Z1bGxXaXRoKCk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiB0aGlzLmN1ckRpbXM7CiAgICB9LAogICAgCiAgICBfc2V0TGFyZ2VUb0Z1bGxXaXRoOiBmdW5jdGlvbigpIHsKICAgICAgdGhpcy5jdXJEaW1zWydwZXJjZW50J10gPSBbJzEwMCUnLCAnJ107CiAgICAgIHRoaXMuY3VyRGltc1sncHgnXSA9IFsKICAgICAgICBNYXRoLm1pbih0aGlzLnNsaWRlci53aWR0aCwgdGhpcy5sYXJnZUF0dHJzLndpZHRoKSwKICAgICAgICBNYXRoLm1pbihNYXRoLmZsb29yKHRoaXMuc2xpZGVyLndpZHRoL3RoaXMubW9kZWwuZ2V0KCdyYXRpbycpKSwgdGhpcy5sYXJnZUF0dHJzLmhlaWdodCkKICAgICAgXTsKICAgICAgaWYgKHRoaXMuZGVidWcpIHsKICAgICAgICBjb25zb2xlLmxvZygnMTAwJSB3aWR0aCA9PicrIHRoaXMuc2xpZGVyLndpZHRoICsneCcrCiAgICAgICAgICB0aGlzLmN1ckRpbXNbJ3B4J11bMV0gKydweDsgQ29udGFpbmVyOiAnKwogICAgICAgICAgdGhpcy5zbGlkZXIud2lkdGggKyd4JysgdGhpcy5zbGlkZXIuaGVpZ2h0ICsncHguJyk7CiAgICAgIH0KICAgIH0sCiAgICAKICAgIF9zZXRMYXJnZVRvRnVsbEhlaWdodDogZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMuY3VyRGltc1sncGVyY2VudCddID0gWycnLCAnMTAwJSddOwogICAgICB0aGlzLmN1ckRpbXNbJ3B4J10gPSBbCiAgICAgICAgTWF0aC5taW4oTWF0aC5mbG9vcih0aGlzLnNsaWRlci5oZWlnaHQqdGhpcy5tb2RlbC5nZXQoJ3JhdGlvJykpLCB0aGlzLmxhcmdlQXR0cnMud2lkdGgpLAogICAgICAgIE1hdGgubWluKHRoaXMuc2xpZGVyLmhlaWdodCwgdGhpcy5sYXJnZUF0dHJzLmhlaWdodCkKICAgICAgXTsKICAgICAgaWYgKHRoaXMuZGVidWcpIHsKICAgICAgICBjb25zb2xlLmxvZygnMTAwJSBoZWlnaHQgPT4nKyB0aGlzLmN1ckRpbXNbJ3B4J11bMF0gKyd4JysKICAgICAgICAgIHRoaXMuY3VyRGltc1sncHgnXVsxXSArJ3B4OyBjb250YWluZXI6ICcgKwogICAgICAgICAgdGhpcy5zbGlkZXIud2lkdGggKyd4JysgdGhpcy5zbGlkZXIuaGVpZ2h0ICsncHguJyk7CiAgICAgIH0KICAgIH0sCiAgICAKICAgIGxvYWRlZDogZnVuY3Rpb24oKSB7CiAgICAgIGlmICh0aGlzLmRlYnVnKSB7Y29uc29sZS5sb2coJ0xhcmdlVmlldyBmb3IgSW1hZ2UgJysgdGhpcy5tb2RlbC5pZCArJyBpcyBsb2FkZWQnKTt9CiAgICB9CiAgfSk7CiAgCiAgcmV0dXJuIExhcmdlVmlldzsKfSk7CgpkZWZpbmUoJ2dhbGxlcnkvdmlld3MvY29ja3BpdC52aWV3JyxbCiAgJ2pxdWVyeScsCiAgJ2pxdWVyeS10b3VjaHN3aXBlJywKICAndW5kZXJzY29yZScsCiAgJ2JhY2tib25lJywKICAnZ2FsbGVyeS92aWV3cy9zZWxlY3Rpb24vc2VsZWN0LmJ1dHRvbicKXSwKZnVuY3Rpb24oJCwgbm9wZSwgXywgQmFja2JvbmUsIFNlbGVjdEJ1dHRvbikgewogIAogIC8qCiAgICogTW9kZWw6IEdhbGxlcnlNb2RlbAogICAqLwogIHZhciBDb2NrcGl0VmlldyA9IEJhY2tib25lLlZpZXcuZXh0ZW5kKHsKICAgIAogICAgZWw6ICcuY29ja3BpdCcsCiAgICAKICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uKCkgewogICAgICBpZiAodGhpcy4kZWwubGVuZ3RoKSB7IC8vIG9ubHkgd2hlbiB0aGVyZSdzIGEgY29ja3BpdCBvbiBkZWNrCgogICAgICAgIHRoaXMuYnV0dG9uID0gdGhpcy4kKCcuY29ja3BpdF9idXR0b24nKTsKICAgICAgICB0aGlzLmJvZHkgPSB0aGlzLiQoJy5jb2NrcGl0X2JvZHknKS5hZGRDbGFzcygnaGlkZGVuJyk7CiAgICAgICAgdGhpcy5fYm9keVRlbXBsYXRlID0gdGhpcy5nZXRUZW1wbGF0ZSgpOwogICAgICAgIHRoaXMuc2xpZGVyID0gdGhpcy5vcHRpb25zLnNsaWRlcjsKICAgICAgICAKICAgICAgICB0aGlzLmxpc3RlblRvKHRoaXMubW9kZWwsICdzbGlkZXI6bmV3SW1hZ2UnLCB0aGlzLm9uTmV3SW1hZ2UpOwoKICAgICAgICAvLyBub3Qgd2l0aCBidWlsdCBpbiBldmVudHMgPT4gZG9lc24ndCB3b3JrIHdlbGwgb24gdG91Y2ggZGV2aWNlcwogICAgICAgIC8vIHRoaXMgZmFsbHMgYmFjayB0byBtb3VzZSBldmVudHMsIHdoZW4gbm8gdG91Y2ggZXZlbnRzIHN1cHBvcnRlZAogICAgICAgIHRoaXMuYnV0dG9uLnN3aXBlKHsKICAgICAgICAgIHRhcDogXy5iaW5kKHRoaXMudG9nZ2xlQm9keSwgdGhpcykKICAgICAgICB9KTsKICAgICAgfQogICAgfSwKICAgIAogICAgLy8gb3ZlcnJpZGUgQmFja2JvbmUuVmlldyNyZW1vdmUgdG8gcmVtb3ZlIHRoZSB0b3VjaCBldmVudCBsaXN0ZW5lcgogICAgcmVtb3ZlOiBmdW5jdGlvbigpIHsKICAgICAgdGhpcy5idXR0b24uc3dpcGUoJ2Rlc3Ryb3knKTsKICAgICAgQmFja2JvbmUuVmlldy5wcm90b3R5cGUucmVtb3ZlLmNhbGwodGhpcyk7IC8vIGNhbGwgc3VwZXIoKQogICAgICAvLyBjb3VsZCBhbHNvIGJlIHdyaXR0ZW4gYXM6CiAgICAgIC8vIHRoaXMuY29uc3RydWN0b3IuX19zdXBlcl9fLnJlbW92ZS5jYWxsKHRoaXMpOwogICAgfSwKCiAgICBpc09wZW46IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gIXRoaXMuYm9keS5oYXNDbGFzcygnaGlkZGVuJyk7CiAgICB9LAogICAgCiAgICB0b2dnbGVCb2R5OiBmdW5jdGlvbihldnQpIHsKICAgICAgdGhpcy5ib2R5LnRvZ2dsZUNsYXNzKCdoaWRkZW4nKTsKICAgICAgdGhpcy5yZW5kZXJCb2R5KHRoaXMubW9kZWwuZ2V0Q3VycmVudCgpKTsKICAgIH0sCgogICAgb25OZXdJbWFnZTogZnVuY3Rpb24obGFyZ2VWaWV3KSB7CiAgICAgIHRoaXMucmVuZGVyQm9keShsYXJnZVZpZXcubW9kZWwpOwogICAgfSwKICAgIAogICAgcmVuZGVyQm9keTogZnVuY3Rpb24oaW1hZ2VNb2RlbCkgewogICAgICBpZiAodGhpcy5pc09wZW4oKSkgewogICAgICAgIC8vIHJlbmRlciBpbWFnZSBtZXRhCiAgICAgICAgdGhpcy5ib2R5Lmh0bWwodGhpcy5fYm9keVRlbXBsYXRlKHtpbWc6IGltYWdlTW9kZWx9KSk7CiAgICAgICAgCiAgICAgICAgLy8gdXBkYXRlIFNlbGVjdEJ1dHRvbiBpZiBwcmVzZW50IGluIHRlbXBsYXRlCiAgICAgICAgdmFyIHNlbGVjdG9yID0gdGhpcy4kKCcuc2VsZWN0b3InKTsKICAgICAgICBpZiAoc2VsZWN0b3IubGVuZ3RoKSB7CiAgICAgICAgICB0aGlzLnVwZGF0ZVNlbGVjdEJ1dHRvbihzZWxlY3RvciwgaW1hZ2VNb2RlbCk7CiAgICAgICAgfQogICAgICB9CiAgICB9LAoKICAgIHVwZGF0ZVNlbGVjdEJ1dHRvbjogZnVuY3Rpb24oc2VsZWN0b3IsIGltYWdlTW9kZWwpIHsKICAgICAgaWYgKHRoaXMuc2VsZWN0QnV0dG9uKSB7IC8vIHJlbW92ZSBvbGQgU2VsZWN0QnV0dG9uIGlmIHByZXNlbnQKICAgICAgICB0aGlzLnNlbGVjdEJ1dHRvbi5yZW1vdmUoKTsKICAgICAgfQogICAgICB0aGlzLnNlbGVjdEJ1dHRvbiA9IG5ldyBTZWxlY3RCdXR0b24oewogICAgICAgIG1vZGVsOiBpbWFnZU1vZGVsLAogICAgICAgIGVsOiBzZWxlY3RvcgogICAgICB9KTsKICAgIH0sCgogICAgZ2V0VGVtcGxhdGU6IGZ1bmN0aW9uKCkgewogICAgICB2YXIgdG1wbCA9ICQoJyN0ZW1wbGF0ZS1jb2NrcGl0Qm9keScpOwogICAgICBpZiAodG1wbC5sZW5ndGgpIHsKICAgICAgICByZXR1cm4gXy50ZW1wbGF0ZSh0bXBsLmh0bWwoKSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY29uc29sZS5lcnJvcignTWlzc2luZyBUZW1wbGF0ZSBmb3IgQ29ja3BpdCAoJCgiI3RlbXBsYXRlLWNvY2twaXRCb2R5IikhID0+IENvY2twaXQgbm90IGluaXRpYWxpemVkLicpOwogICAgICAgIHRoaXMuJGVsLmhpZGUoKTsKICAgICAgfQogICAgICAKICAgIH0KICB9KTsKICAKICByZXR1cm4gQ29ja3BpdFZpZXc7Cn0pOwoKZGVmaW5lKCdnYWxsZXJ5L3ZpZXdzL3NsaWRlci52aWV3JyxbCiAgJ2pxdWVyeScsCiAgJ2pxdWVyeS10b3VjaHN3aXBlJywKICAndmVuZG9yL2pxdWVyeS50aHJvdHRsZS1kZWJvdW5jZScsCiAgJ3VuZGVyc2NvcmUnLAogICdiYWNrYm9uZScsCiAgJ2dhbGxlcnkvdmlld3MvbGFyZ2UudmlldycsCiAgJ2dhbGxlcnkvdmlld3MvY29ja3BpdC52aWV3JwpdLCBmdW5jdGlvbigkLCBub3BlLCBub3BlMiwgXywgQmFja2JvbmUsIExhcmdlVmlldywgQ29ja3BpdFZpZXcpIHsKICAKICAvKgogICAqIE1vZGVsOiBHYWxsZXJ5TW9kZWwKICAgKiBFbGVtZW50OiBpcyBzZXQgYnkgdGhlIGNvbnN0cnVjdG9yIChzZWUgYXBwLmpzKQogICAqCiAgICogbGlzdGVucyB0byAndGh1bWI6Y2xpY2tlZCcgb24gR2FsbGVyeU1vZGVsCiAgICogbGlzdGVucyB0byAncmVzaXplLnNsaWRlcicgb24gd2luZG93CiAgICogbGlzdGVucyB0byAnY2xpY2suc2xpZGVyJyBvbiB0aGlzLiRlbAogICAqIGxpc3RlbnMgdG8gJ21vdXNlbW92ZS5zbGlkZXInIG9uIHRoaXMuJGVsCiAgICogbGlzdGVucyB0byAna2V5dXAuc2xpZGVyJyAoRVNDWzI3XSwgY3Vyc29yLWxlZnRbMzddLCBjdXJzb3ItcmlnaHRbMzldKQogICAqIGxpc3RlbnMgb25jZSB0byAnc3luYycgb24gR2FsbGVyeU1vZGVsCiAgICogdHJpZ2dlcnMgJ3NsaWRlcjpuZXdJbWFnZScgd2l0aCBjdXJyZW50IExhcmdlVmlldyBvYmplY3Qgb24gR2FsbGVyeU1vZGVsCiAgICovCiAgdmFyIFNsaWRlclZpZXcgPSBCYWNrYm9uZS5WaWV3LmV4dGVuZCh7CiAgICAgICAgCiAgICBldmVudHM6IHsKICAgICAgJ2NsaWNrIC5uYXYucHJldic6ICdzaG93UHJldicsCiAgICAgICdjbGljayAubmF2Lm5leHQnOiAnc2hvd05leHQnCiAgICB9LAogICAgCiAgICBpbml0aWFsaXplOiBmdW5jdGlvbigpIHsKICAgICAgLy8gTWFyayB3aXRoIHNsaWRlcl9jbG9zZWQgY2xhc3MKICAgICAgJCgnYm9keScpLmFkZENsYXNzKCdzbGlkZXJfY2xvc2VkJyk7CiAgICAgIAogICAgICAvLyBJbml0IEVsZW1lbnRzCiAgICAgIHRoaXMudHJheSA9IHRoaXMuJCgnLnRyYXknKTsKICAgICAgdGhpcy5jdXJyZW50Qm94ID0gdGhpcy4kKCcucGhvdG8uY3VycmVudCcpOyAvL1RPRE86IE9wdGlvbnMKICAgICAgdGhpcy5wcmV2Qm94ID0gdGhpcy4kKCcucGhvdG8ucHJldicpOwogICAgICB0aGlzLm5leHRCb3ggPSB0aGlzLiQoJy5waG90by5uZXh0Jyk7CiAgICAgIHRoaXMubmF2UHJldiA9IHRoaXMuJCgnLm5hdi5wcmV2Jyk7IC8vIFRPRE86IE9wdGlvbnMKICAgICAgdGhpcy5uYXZOZXh0ID0gdGhpcy4kKCcubmF2Lm5leHQnKTsgLy8gVE9ETzogT3B0aW9ucwogICAgICB0aGlzLmN1cnJlbnQgPSB1bmRlZmluZWQ7CiAgICAgIAogICAgICAvLyBSZWdpc3RlciBIYW5kbGVycwogICAgICAvLyBDaGVjaywgd2hlbiBUaHVtYiB3YXMgY2xpY2tlZAogICAgICB0aGlzLmxpc3RlblRvKHRoaXMubW9kZWwsICd0aHVtYjpjbGlja2VkJywgdGhpcy5vcGVuU2xpZGVyKTsKICAgICAgLy8gTGlzdGVuIG9uIHdpbmRvdyByZXNpemUgdG8gcmVzaXplIHRoZSBjdXJyZW50LCB0aGUgcHJldiBhbmQgdGhlIG5leHQgbGFyZ2UKICAgICAgJCh3aW5kb3cpLm9uKCdyZXNpemUuc2xpZGVyJywgXy5iaW5kKCQuZGVib3VuY2UoMjAwLCB0aGlzLnJlc2l6ZSksIHRoaXMpKTsKICAgICAgLy8gTGlzdGVuIHRvIGtleWJvYXJkCiAgICAgICQod2luZG93KS5vbigna2V5dXAuc2xpZGVyJywgXy5iaW5kKHRoaXMua2V5cywgdGhpcykpOwogICAgICAvLyBMaXN0ZW4gdG8gbW91c2Vtb3ZlIGZvciBob3ZlcmluZyB0aGUgcHJldi9uZXh0IGJ1dHRvbnMgLSBvbmx5IG9uIAogICAgICAvLyBub24tdG91Y2ggZGV2aWNlcyAobWl4ZWQgZGV2aWNlcyAoc3VyZmFjZSBldCBhbCkgZG9uJ3QgZ2V0IGhvdmVyIGhlbHApCiAgICAgIHRoaXMudG91Y2hhYmxlID0gKCdvbnRvdWNoc3RhcnQnIGluIHdpbmRvdyk7CiAgICAgIGlmICghdGhpcy50b3VjaGFibGUpIHsKICAgICAgICB0aGlzLnRyYXkub24oJ21vdXNlbW92ZS5zbGlkZXInLCBfLmJpbmQoJC50aHJvdHRsZSgxNTAsIHRoaXMubW91c2Vtb3ZlKSwgdGhpcykpOwogICAgICB9CiAgICAgICAgICAgIAogICAgICAvLyBJbml0IENvY2twaXQKICAgICAgdGhpcy5jb2NrcGl0ID0gbmV3IENvY2twaXRWaWV3KHsKICAgICAgICBtb2RlbDogdGhpcy5tb2RlbCwKICAgICAgICBzbGlkZXI6IHRoaXMKICAgICAgfSk7CiAgICAgIAogICAgICAvLyBJbml0IFN3aXBlLUhhbmRsZXIgYW5kIGRlYWN0aXZhdGUgaXQgCiAgICAgIC8vID0+IG9wZW5TbGlkZXIvY2xvc2VTbGlkZXIgZW5hYmxlcy9kaXNhYmxlcyBpdCBhZ2FpbgogICAgICB0aGlzLmluaXRTd2lwZUhhbmRsZXIoKTsKICAgICAgdGhpcy4kZWwuc3dpcGUoJ2Rpc2FibGUnKTsKICAgICAgCiAgICAgIC8vIENoZWNrIGlmIGEgSW1hZ2VNb2RlbCBpZCBpcyBpbiB0aGUgd2luZG93LmxvY2F0aW9uLmhhc2ggCiAgICAgIC8vID0+IG9wZW4gc2xpZGVyIHdpdGggdGhpcyBpbWFnZQogICAgICB0aGlzLmxpc3RlblRvT25jZSh0aGlzLm1vZGVsLCAnc3luYycsIGZ1bmN0aW9uKCkgewogICAgICAgIGlmICh3aW5kb3cubG9jYXRpb24uaGFzaC5sZW5ndGggPiAyKSB7CiAgICAgICAgICB2YXIgaW1hZ2VNb2RlbCA9IHRoaXMubW9kZWwuZ2V0KCdpbWFnZXMnKS5nZXQod2luZG93LmxvY2F0aW9uLmhhc2guc3Vic3RyKDIpKTsKICAgICAgICAgIGlmIChpbWFnZU1vZGVsKSB7CiAgICAgICAgICAgIHRoaXMub3BlblNsaWRlcihpbWFnZU1vZGVsKTsKICAgICAgICAgICAgLy8gd2FpdCBhIG1pbGxpc2Vjb25kIHRpbGwgdGhlIHRodW1icyBhcmUgbG9hZGVkIGFuZCBwZXJoYXBzIGEgc2Nyb2xsYmFyIGlzCiAgICAgICAgICAgIC8vIHJlbmRlcmVkID0+IGNoYW5nZXMgdGhlIGRpbWVuc2lvbnMgb2YgdGhlIHNsaWRlcgogICAgICAgICAgICB3aW5kb3cuc2V0VGltZW91dChfLmJpbmQodGhpcy5yZXNpemUsIHRoaXMpLCAyNTApOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICB9LAogICAgCiAgICBpbml0U3dpcGVIYW5kbGVyOiBmdW5jdGlvbigpIHsKICAgICAgdmFyIGluc3RhbmNlID0gdGhpczsKICAgICAgdGhpcy4kZWwuc3dpcGUoewogICAgICAgIHN3aXBlTGVmdDogZnVuY3Rpb24oZXZ0LCBkaXJlY3Rpb24sIGRpc3RhbmNlLCBkdXJhdGlvbiwgZmluZ2VyQ291bnQpIHsKICAgICAgICAgIGluc3RhbmNlLnNob3dOZXh0KCk7CiAgICAgICAgICBldnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICB9LAogICAgICAgIHN3aXBlUmlnaHQ6IGZ1bmN0aW9uKGV2dCwgZGlyZWN0aW9uLCBkaXN0YW5jZSwgZHVyYXRpb24sIGZpbmdlckNvdW50KSB7CiAgICAgICAgICBpbnN0YW5jZS5zaG93UHJldigpOwogICAgICAgICAgZXZ0LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgfSwKICAgICAgICB0YXA6IGZ1bmN0aW9uKGV2dCwgdGFyZ2V0KSB7CiAgICAgICAgICBldnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgIGluc3RhbmNlLmNsaWNrKGV2dCk7CiAgICAgICAgfSwKICAgICAgICBhbGxvd1BhZ2VTY3JvbGw6ICdub25lJwogICAgICB9KTsKICAgIH0sCiAgICAgICAgCiAgICAvLyBvdmVycmlkZSBCYWNrYm9uZS5WaWV3I3JlbW92ZSB0byByZW1vdmUgdGhlIGV2ZW50IGxpc3RlbmVyIGZvciAncmVzaXplLnNsaWRlcicKICAgIHJlbW92ZTogZnVuY3Rpb24oKSB7CiAgICAgICQod2luZG93KS5vZmYoJ3Jlc2l6ZS5zbGlkZXInKTsKICAgICAgJCh3aW5kb3cpLm9mZigna2V5dXAuc2xpZGVyJyk7CiAgICAgIGlmICh0aGlzLnRvdWNoYWJsZSkgeyB0aGlzLnRyYXkub2ZmKCdtb3VzZW1vdmUuc2xpZGVyJyk7IH0KICAgICAgdGhpcy4kZWwuc3dpcGUoJ2Rlc3Ryb3knKTsKICAgICAgQmFja2JvbmUuVmlldy5wcm90b3R5cGUucmVtb3ZlLmNhbGwodGhpcyk7IC8vIGNhbGwgc3VwZXIoKQogICAgICAvLyBjb3VsZCBhbHNvIGJlIHdyaXR0ZW4gYXM6CiAgICAgIC8vIHRoaXMuY29uc3RydWN0b3IuX19zdXBlcl9fLnJlbW92ZS5jYWxsKHRoaXMpOwogICAgfSwKICAgIAogICAga2V5czogZnVuY3Rpb24oZXZ0KSB7CiAgICAgIGlmICh0aGlzLmlzT3BlbigpKSB7CiAgICAgICAgc3dpdGNoKGV2dC5rZXlDb2RlKSB7CiAgICAgICAgICBjYXNlIDI3OiAvLyBFU0MKICAgICAgICAgICAgdGhpcy5jbG9zZVNsaWRlcigpOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgMzk6IC8vIFJpZ2h0IEN1cnNvcgogICAgICAgICAgICB0aGlzLnNob3dOZXh0KCk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSAzNzogLy8gTGVmdCBDdXJzb3IKICAgICAgICAgICAgdGhpcy5zaG93UHJldigpOwogICAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICAKICAgIC8vIGV4ZWN1dGUgcHJldi9uZXh0IG9yIGNsb3NlLCBkZXBlbmRpbmcgb24gdGhlIGFyZWEgY2xpY2tlZC4KICAgIGNsaWNrOiBmdW5jdGlvbihldnQpIHsKICAgICAgdmFyIG1vdXNlQ21kID0gdGhpcy5fbWFwTW91c2VFdmVudChldnQpOwogICAgICBzd2l0Y2gobW91c2VDbWQpIHsKICAgICAgICBjYXNlICduYXYucHJldic6CiAgICAgICAgICB0aGlzLnNob3dQcmV2KCk7CiAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlICduYXYubmV4dCc6CiAgICAgICAgICB0aGlzLnNob3dOZXh0KCk7CiAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlICdFU0MnOgogICAgICAgICAgdGhpcy5jbG9zZVNsaWRlcigpOwogICAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgIH0sCiAgICAKICAgIC8vICJob3ZlciIgZWZmZWN0IGZvciBwcmV2L25leHQgYnV0dG9ucyB3aGlsZSBtb3VzZSBpcyBvdmVyIGltYWdlCiAgICBtb3VzZW1vdmU6IGZ1bmN0aW9uKGV2dCkgewogICAgICB2YXIgbW91c2VDbWQgPSB0aGlzLl9tYXBNb3VzZUV2ZW50KGV2dCk7CiAgICAgIGlmIChtb3VzZUNtZCA9PT0gJ25hdi5wcmV2JykgewogICAgICAgIHRoaXMubmF2TmV4dC5yZW1vdmVDbGFzcygnYWN0aXZlJyk7CiAgICAgICAgdGhpcy5uYXZQcmV2LmFkZENsYXNzKCdhY3RpdmUnKTsKICAgICAgfSBlbHNlIGlmIChtb3VzZUNtZCA9PT0gJ25hdi5uZXh0JykgewogICAgICAgIHRoaXMubmF2UHJldi5yZW1vdmVDbGFzcygnYWN0aXZlJyk7CiAgICAgICAgdGhpcy5uYXZOZXh0LmFkZENsYXNzKCdhY3RpdmUnKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLm5hdlByZXYucmVtb3ZlQ2xhc3MoJ2FjdGl2ZScpOwogICAgICAgIHRoaXMubmF2TmV4dC5yZW1vdmVDbGFzcygnYWN0aXZlJyk7CiAgICAgIH0KICAgIH0sCiAgICAKICAgIC8vIENoZWNrIHdoaWNoIGNvbWFuZCB3b3VsZCBiZSBleGVjdXRlZCBmcm9tIHRoZSBjdXJyZW50IG1vdXNlIHBvc2l0aW9uCiAgICBfbWFwTW91c2VFdmVudDogZnVuY3Rpb24oZXZ0KSB7CiAgICAgIHZhciAkdGFyZ2V0ID0gJChldnQudGFyZ2V0KTsKICAgICAgaWYgKCR0YXJnZXQuaXMoJy5waG90byBpbWcnKSkgewogICAgICAgIC8vIHRvdWNoIGV2ZW50cyBnZXQgdGhlIGN1cnJlbnQgcGFnZSBjb29yZGluYXRlcyBpbiBhbm90aGVyIGZhc2hpb24gdGhhbgogICAgICAgIC8vIHB1cmUgb2xkIGNsaWNrIGV2ZW50cwogICAgICAgIHZhciBwYWdlWCA9ICgKICAgICAgICAgIGV2dC5jaGFuZ2VkVG91Y2hlcyAmJiBldnQuY2hhbmdlZFRvdWNoZXMubGVuZ3RoID8KICAgICAgICAgICAgZXZ0LmNoYW5nZWRUb3VjaGVzWzBdLnBhZ2VYIDoKICAgICAgICAgICAgZXZ0LnBhZ2VYCiAgICAgICAgKTsKICAgICAgICB2YXIgb2Zmc2V0WCA9IHBhZ2VYIC0gJChldnQudGFyZ2V0KS5vZmZzZXQoKS5sZWZ0OwogICAgICAgIHZhciBvZmZzZXRSZWxYID0gb2Zmc2V0WCAvIHRoaXMuY3VycmVudC5nZXRXaWR0aCgpOwogICAgICAgIHJldHVybiAob2Zmc2V0UmVsWCA8IDAuNDUgPyAnbmF2LnByZXYnIDogJ25hdi5uZXh0Jyk7CiAgICAgIH0gZWxzZSBpZiAoJHRhcmdldC5jbG9zZXN0KCcuY29ja3BpdCcpLmxlbmd0aCA9PT0gMCkgewogICAgICAgIC8vICQuY2xvc2VzdCA9PiBhbGwgdGFyZ2V0cyB3aXRoaW4gdGhlIHNwZWNpZmllZCAuY29ja3BpdCBjb250YWluZXIKICAgICAgICByZXR1cm4gJ0VTQyc7CiAgICAgIH0KICAgIH0sCiAgICAKICAgIGlzT3BlbjogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB0aGlzLiRlbC5oYXNDbGFzcygnb3BlbicpOwogICAgfSwKICAgIAogICAgb3BlblNsaWRlcjogZnVuY3Rpb24oaW1hZ2VNb2RlbCkgewogICAgICB0aGlzLl9zZXREaW1lbnNpb25zKCk7CiAgICAgIHRoaXMuX3NldEN1cnJlbnQoaW1hZ2VNb2RlbCk7CiAgICAgIHRoaXMuJGVsLmFkZENsYXNzKCdvcGVuJyk7CiAgICAgICQoJ2JvZHknKS5yZW1vdmVDbGFzcygnc2xpZGVyX2Nsb3NlZCcpOwogICAgICB0aGlzLiRlbC5hZGRDbGFzcygndmlzaWJsZScpOwogICAgICB0aGlzLiRlbC5zd2lwZSgnZW5hYmxlJyk7CiAgICAgIHRoaXMubW9kZWwudG9nZ2xlU2xpZGVyU3RhdGUoKTsKICAgIH0sCiAgICAKICAgIHNob3dOZXh0OiBmdW5jdGlvbigpIHsKICAgICAgaWYgKHRoaXMubmV4dCkgewogICAgICAgIHZhciBuZXdOZXh0Qm94ID0gdGhpcy4kZWwuZmluZCgnI3ByZXYnKTsKICAgICAgICAKICAgICAgICB0aGlzLnByZXYgPSB0aGlzLmN1cnJlbnQ7CiAgICAgICAgdGhpcy5wcmV2Qm94ID0gdGhpcy5jdXJyZW50Qm94LmF0dHIoJ2lkJywncHJldicpOwogICAgICAgIHRoaXMuY3VycmVudCA9IHRoaXMubmV4dDsKICAgICAgICB0aGlzLm1vZGVsLnNldEN1cnJlbnQodGhpcy5uZXh0Lm1vZGVsKTsKICAgICAgICB0aGlzLmN1cnJlbnRCb3ggPSB0aGlzLm5leHRCb3guYXR0cignaWQnLCdjdXJyZW50Jyk7CiAgICAgICAgdGhpcy5uZXh0Qm94ID0gbmV3TmV4dEJveC5hdHRyKCdpZCcsJ25leHQnKTsKICAgICAgICAKICAgICAgICB0aGlzLnByZXZCb3gudG9nZ2xlQ2xhc3MoJ2N1cnJlbnQgcHJldicpOwogICAgICAgIHRoaXMuY3VycmVudEJveC50b2dnbGVDbGFzcygnbmV4dCBjdXJyZW50Jyk7CiAgICAgICAgdGhpcy5uZXh0Qm94LnRvZ2dsZUNsYXNzKCdwcmV2IG5leHQnKTsKICAgICAgICAKICAgICAgICB0aGlzLl9zZXROZXh0KCk7CiAgICAgICAgdGhpcy5fY3VycmVudENoYW5nZWQoKTsKICAgICAgfQogICAgfSwKICAgIAogICAgc2hvd1ByZXY6IGZ1bmN0aW9uKCkgewogICAgICBpZiAodGhpcy5wcmV2KSB7CiAgICAgICAgdmFyIG5ld1ByZXZCb3ggPSB0aGlzLiRlbC5maW5kKCcjbmV4dCcpOwogICAgICAgIAogICAgICAgIHRoaXMubmV4dCA9IHRoaXMuY3VycmVudDsKICAgICAgICB0aGlzLm5leHRCb3ggPSB0aGlzLmN1cnJlbnRCb3guYXR0cignaWQnLCduZXh0Jyk7CiAgICAgICAgdGhpcy5jdXJyZW50ID0gdGhpcy5wcmV2OwogICAgICAgIHRoaXMubW9kZWwuc2V0Q3VycmVudCh0aGlzLnByZXYubW9kZWwpOwogICAgICAgIHRoaXMuY3VycmVudEJveCA9IHRoaXMucHJldkJveC5hdHRyKCdpZCcsJ2N1cnJlbnQnKTsKICAgICAgICB0aGlzLnByZXZCb3ggPSBuZXdQcmV2Qm94LmF0dHIoJ2lkJywgJ3ByZXYnKTsKICAgICAgICAKICAgICAgICB0aGlzLm5leHRCb3gudG9nZ2xlQ2xhc3MoJ2N1cnJlbnQgbmV4dCcpOwogICAgICAgIHRoaXMuY3VycmVudEJveC50b2dnbGVDbGFzcygncHJldiBjdXJyZW50Jyk7CiAgICAgICAgdGhpcy5wcmV2Qm94LnRvZ2dsZUNsYXNzKCduZXh0IHByZXYnKTsKICAgICAgICAKICAgICAgICB0aGlzLl9zZXRQcmV2KCk7CiAgICAgICAgdGhpcy5fY3VycmVudENoYW5nZWQoKTsKICAgICAgfQogICAgfSwKICAgIAogICAgY2xvc2VTbGlkZXI6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLm1vZGVsLnRyaWdnZXIoJ3NsaWRlcjpjbG9zaW5nJywgdGhpcy5jdXJyZW50KTsKICAgIAogICAgICB0aGlzLiRlbC5yZW1vdmVDbGFzcygnb3BlbiB2aXNpYmxlJyk7CiAgICAgICQoJ2JvZHknKS5hZGRDbGFzcygnc2xpZGVyX2Nsb3NlZCcpOwoKICAgICAgdGhpcy5fc2V0Q3VycmVudCh1bmRlZmluZWQpOwogICAgICB0aGlzLmN1cnJlbnQgPSB0aGlzLm5leHQgPSB0aGlzLnBlcnYgPSB1bmRlZmluZWQ7CiAgICAgIAogICAgICB0aGlzLiQoJy5waG90bycpLmVtcHR5KCk7CiAgICAKICAgICAgLy8gdXBkYXRlIGJyb3dzZXIgdXJsCiAgICAgIGlmICh0aGlzLm1vZGVsLmdldCgnaW1hZ2VQYWdlcycpICYmIHRoaXMubW9kZWwuZ2V0KCdwb3N0UGF0aCcpKSB7CiAgICAgICAgaGlzdG9yeS5yZXBsYWNlU3RhdGUobnVsbCwgJycsIHRoaXMubW9kZWwuZ2V0KCdwb3N0UGF0aCcpKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLl9zZXRIYXNoYmFuZyhudWxsLCAnw4RNUFRJJyk7CiAgICAgIH0KICAgIAogICAgICB0aGlzLiRlbC5zd2lwZSgnZGlzYWJsZScpOwogICAgICB0aGlzLm1vZGVsLnRvZ2dsZVNsaWRlclN0YXRlKCk7CiAgICB9LAogICAgCiAgICBfc2V0SGFzaGJhbmc6IGZ1bmN0aW9uKGJhbmdib29tYmFuZywgdGl0bGUpIHsKICAgICAgaWYgKE1vZGVybml6ci5oaXN0b3J5KSB7CiAgICAgICAgdmFyIG5ld0xvYyA9IGRvY3VtZW50LmxvY2F0aW9uLmhyZWY7CiAgICAgICAgbmV3TG9jID0gbmV3TG9jLnJlcGxhY2UoL1wjLiovLCAnJykgKyAoYmFuZ2Jvb21iYW5nID8gJyMhJyArIGJhbmdib29tYmFuZyA6ICcnKTsKICAgICAgICBoaXN0b3J5LnJlcGxhY2VTdGF0ZShudWxsLCB0aXRsZSwgbmV3TG9jKTsKICAgICAgfQogICAgfSwKICAgIAogICAgX2N1cnJlbnRDaGFuZ2VkOiBmdW5jdGlvbigpIHsKICAgICAgLy8gdXBkYXRlIGJyb3dzZXIgdXJsCiAgICAgIGlmICh0aGlzLm1vZGVsLmdldCgnaW1hZ2VQYWdlcycpKSB7CiAgICAgICAgaGlzdG9yeS5yZXBsYWNlU3RhdGUobnVsbCwgJycsIHRoaXMuY3VycmVudC5tb2RlbC5nZXQoJ2ltYWdlUGFnZVBhdGgnKSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5fc2V0SGFzaGJhbmcodGhpcy5jdXJyZW50Lm1vZGVsLmlkLCAnSW1hZ2UgJyArIHRoaXMuY3VycmVudC5tb2RlbC5pZCk7CiAgICAgIH0KICAgICAgCiAgICAgIHRoaXMubW9kZWwudHJpZ2dlcignc2xpZGVyOm5ld0ltYWdlJywgdGhpcy5jdXJyZW50KTsKICAgICAgCiAgICAgIGlmICh0aGlzLm5leHQpIHsgdGhpcy5uYXZOZXh0LnJlbW92ZUNsYXNzKCd2aXN1YWxseWhpZGRlbicpOyB9CiAgICAgIGVsc2UgeyB0aGlzLm5hdk5leHQuYWRkQ2xhc3MoJ3Zpc3VhbGx5aGlkZGVuJyk7IH0KICAgICAgaWYgKHRoaXMucHJldikgeyB0aGlzLm5hdlByZXYucmVtb3ZlQ2xhc3MoJ3Zpc3VhbGx5aGlkZGVuJyk7IH0KICAgICAgZWxzZSB7IHRoaXMubmF2UHJldi5hZGRDbGFzcygndmlzdWFsbHloaWRkZW4nKTsgfQogICAgICAKICAgIH0sCiAgICAKICAgIF9zZXRDdXJyZW50OiBmdW5jdGlvbihpbWFnZU1vZGVsKSB7CiAgICAgIHRoaXMubW9kZWwuc2V0Q3VycmVudChpbWFnZU1vZGVsKTsKICAgICAgdmFyIGxhcmdlVmlldyA9IHRoaXMuX2xvYWRPckdldExhcmdlKGltYWdlTW9kZWwpOwogICAgICBpZiAobGFyZ2VWaWV3KSB7CiAgICAgICAgdGhpcy5jdXJyZW50ID0gbGFyZ2VWaWV3OwogICAgICAgIHRoaXMuY3VycmVudEJveC5odG1sKHRoaXMuY3VycmVudC4kZWwpOwogICAgICAgIHRoaXMuX2N1cnJlbnRDaGFuZ2VkKCk7CiAgICAgICAgdGhpcy5fc2V0TmV4dCgpOwogICAgICAgIHRoaXMuX3NldFByZXYoKTsKICAgICAgfQogICAgfSAsCiAgICAKICAgIF9zZXROZXh0OiBmdW5jdGlvbigpIHsKICAgICAgdGhpcy5uZXh0ID0gdGhpcy5fbG9hZE9yR2V0TGFyZ2UodGhpcy5tb2RlbC5nZXROZXh0KCkpOwogICAgICBpZiAodGhpcy5uZXh0KSB7CiAgICAgICAgdGhpcy5uZXh0Qm94Lmh0bWwodGhpcy5uZXh0LiRlbCk7CiAgICAgICAgdGhpcy5uYXZOZXh0LnJlbW92ZUNsYXNzKCd2aXN1YWxseWhpZGRlbicpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMubmF2TmV4dC5hZGRDbGFzcygndmlzdWFsbHloaWRkZW4nKTsKICAgICAgfQogICAgICByZXR1cm4gdGhpcy5uZXh0OwogICAgfSwKICAgIAogICAgX3NldFByZXY6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLnByZXYgPSB0aGlzLl9sb2FkT3JHZXRMYXJnZSh0aGlzLm1vZGVsLmdldFByZXYoKSk7CiAgICAgIGlmICh0aGlzLnByZXYpIHsKICAgICAgICB0aGlzLnByZXZCb3guaHRtbCh0aGlzLnByZXYuJGVsKTsKICAgICAgICB0aGlzLm5hdlByZXYucmVtb3ZlQ2xhc3MoJ3Zpc3VhbGx5aGlkZGVuJyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5uYXZQcmV2LmFkZENsYXNzKCd2aXN1YWxseWhpZGRlbicpOwogICAgICB9CiAgICAgIHJldHVybiB0aGlzLnByZXY7CiAgICB9LAogICAgCiAgICAvLyBzYXZlIGN1cnJlbnQgdHJheSByZXNvbHV0aW9uIG9uIHRoZSBJbWFnZU1vZGVsIG9yIExhcmdlVmlldwogICAgX2xvYWRPckdldExhcmdlOiBmdW5jdGlvbihpbWFnZU1vZGVsKSB7CiAgICAgIGlmIChpbWFnZU1vZGVsKSB7CiAgICAgICAgdmFyIGxhcmdlVmlldyA9ICgKICAgICAgICAgIGltYWdlTW9kZWwuZ2V0TGFyZ2VWaWV3KCkgfHwKICAgICAgICAgIG5ldyBMYXJnZVZpZXcoewogICAgICAgICAgICBtb2RlbDogaW1hZ2VNb2RlbCwKICAgICAgICAgICAgc2xpZGVyOiB0aGlzCiAgICAgICAgICB9KQogICAgICAgICk7CiAgICAgICAgbGFyZ2VWaWV3LnJlc2l6ZSgpOwogICAgICAgIHJldHVybiBsYXJnZVZpZXc7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgfQogICAgfSwKCiAgICByZXNpemU6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLl9zZXREaW1lbnNpb25zKCk7CiAgICAgIAogICAgICBpZiAodGhpcy5jdXJyZW50KSB7IHRoaXMuY3VycmVudC5yZXNpemUoKTsgfQogICAgICBpZiAodGhpcy5uZXh0KSB7IHRoaXMubmV4dC5yZXNpemUoKTsgfQogICAgICBpZiAodGhpcy5wcmV2KSB7IHRoaXMucHJldi5yZXNpemUoKTsgfQogICAgfSwKICAgIAogICAgX3NldERpbWVuc2lvbnM6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLndpZHRoID0gdGhpcy50cmF5LndpZHRoKCk7CiAgICAgIHRoaXMuaGVpZ2h0ID0gdGhpcy50cmF5LmhlaWdodCgpOwogICAgICB0aGlzLnJhdGlvID0gdGhpcy53aWR0aCAvIHRoaXMuaGVpZ2h0OwogICAgICB0aGlzLm9yaWVudGF0aW9uID0gdGhpcy5yYXRpbyA+IDEgPyAnbGFuZHNjYXBlJyA6ICdwb3J0cmFpdCc7CiAgICB9CiAgICAKICB9KTsKICAKICByZXR1cm4gU2xpZGVyVmlldzsKfSk7CgovKiBTZWxlY3Rpb25Db21wb25lbnQKICogLS0tLS0tLS0tLS0tLS0tCiAqCiAqIEEgdmlldyBDb21wb25lbnQuIEJhc2VjbGFzcyBmb3IgU2VsZWN0aW9uIFZpZXcgQ29tcG9uZW50cy4KICogCiAqIFdhaXRzIGZvciBJbml0aWFsaXphdGlvbiAoc3luYykgb2YgdGhlIENvbGxlY3Rpb24sIGxpc3RlbnMgdG8gY2hhbmdlcyBvZgogKiBDb2xsZWN0aW9uIGFuZCBzZXRzIGFjdGl2ZSBjbGFzcyBvbiBFbGVtZW50LCB3aGVuIENvbGxlY3Rpb24gaXMgbm90IGVtcHR5LgogKgogKiBDb2xsZWN0aW9uOiBTZWxlY3Rpb25Db2xsZWN0aW9uCiAqCiAqLwpkZWZpbmUoJ2dhbGxlcnkvdmlld3Mvc2VsZWN0aW9uL2NvbXBvbmVudCcsWwogICdiYWNrYm9uZScKXSwKZnVuY3Rpb24oQmFja2JvbmUpIHsKCiAgdmFyIFNlbGVjdGlvbkNvbXBvbmVudCA9IEJhY2tib25lLlZpZXcuZXh0ZW5kKHsKCiAgICBpbml0aWFsaXplOiBmdW5jdGlvbigpIHsKICAgICAgaWYgKHRoaXMuJGVsLmxlbmd0aCAmJiB0aGlzLmNvbGxlY3Rpb24pIHsKICAgICAgICB0aGlzLmxpc3RlblRvT25jZSh0aGlzLmNvbGxlY3Rpb24sICdzeW5jJywgdGhpcy5zZWxlY3Rpb25TeW5jZWQpOwogICAgICB9CiAgICB9LAoKICAgIHNlbGVjdGlvblN5bmNlZDogZnVuY3Rpb24oY29sbGVjdGlvbiwgcmVzcCwgb3B0cykgewogICAgICB0aGlzLnJlbmRlcigpOyAvLyB6ZXJvIG9wLCBvdmVycmlkZSwgd2hlbiBuZWVkZWQuCiAgICAgIHRoaXMucmVuZGVyQWN0aXZlKGNvbGxlY3Rpb24ubGVuZ3RoID4gMCk7CiAgICAgIHRoaXMuJGVsLmFkZENsYXNzKCdpbml0aWFsaXplZCcpOwogICAgICB0aGlzLmxpc3RlblRvKHRoaXMuY29sbGVjdGlvbiwgJ2FkZCcsIHRoaXMuaXRlbUFkZGVkKTsKICAgICAgdGhpcy5saXN0ZW5Ubyh0aGlzLmNvbGxlY3Rpb24sICdyZW1vdmUnLCB0aGlzLml0ZW1SZW1vdmVkKTsKICAgIH0sCgogICAgaXRlbUFkZGVkOiBmdW5jdGlvbihtb2RlbCwgY29sLCBvcHRzKSB7CiAgICAgIGlmIChjb2wubGVuZ3RoID09PSAxKSB7CiAgICAgICAgdGhpcy5yZW5kZXJBY3RpdmUodHJ1ZSk7CiAgICAgIH0KICAgICAgdGhpcy5zZWxlY3Rpb25DaGFuZ2VkKG9wdHMpOwogICAgfSwKCiAgICBpdGVtUmVtb3ZlZDogZnVuY3Rpb24obW9kZWwsIGNvbCwgb3B0cykgewogICAgICBpZiAoY29sLmxlbmd0aCA9PT0gMCkgewogICAgICAgIHRoaXMucmVuZGVyQWN0aXZlKGZhbHNlKTsKICAgICAgfQogICAgICB0aGlzLnNlbGVjdGlvbkNoYW5nZWQob3B0cyk7CiAgICB9LAoKICAgIC8vIHplcm8gb3AgaGVyZSwgb3ZlcnJpZGUgdGhpcyBpbiB5b3VyIENsYXNzCiAgICBzZWxlY3Rpb25DaGFuZ2VkOiBmdW5jdGlvbihvcHRzKSB7CiAgICAgIHJldHVybjsKICAgIH0sCgogICAgcmVuZGVyQWN0aXZlOiBmdW5jdGlvbihhY3RpdmUpIHsKICAgICAgaWYgKGFjdGl2ZSkgewogICAgICAgIHRoaXMuJGVsLmFkZENsYXNzKCdhY3RpdmUnKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLiRlbC5yZW1vdmVDbGFzcygnYWN0aXZlJyk7CiAgICAgIH0KICAgIH0KCiAgfSk7CgogIHJldHVybiBTZWxlY3Rpb25Db21wb25lbnQ7Cgp9KTsKCi8qIFNlbGVjdGlvbkluZGljYXRvcgogKiAtLS0tLS0tLS0tLS0tLS0KICoKICogQSB2aWV3IENvbXBvbmVudCBpbmRpY2F0aW5nIHRoZSBudW1iZXIgb2Ygc2VsZWN0ZWQgaW1hZ2VzLiAKICoKICogQ29sbGVjdGlvbjogU2VsZWN0aW9uQ29sbGVjdGlvbgogKgogKi8KZGVmaW5lKCdnYWxsZXJ5L3ZpZXdzL3NlbGVjdGlvbi9pbmRpY2F0b3InLFsKICAnYmFja2JvbmUnLAogICdnYWxsZXJ5L3ZpZXdzL3NlbGVjdGlvbi9jb21wb25lbnQnCl0sCmZ1bmN0aW9uKEJhY2tib25lLCBTZWxlY3Rpb25Db21wb25lbnQpIHsKCiAgdmFyIFNlbGVjdGlvbkluZGljYXRvciA9IFNlbGVjdGlvbkNvbXBvbmVudC5leHRlbmQoewoKICAgIC8vIHRoZSBvbmVzIHdpdGggZGF0YS1zZWxlY3Rpb24gZ2V0IHRoZWlyIGVsZW1lbnRzIHBhc3NlZCBpbiBleHBsaWNpdGx5IChzZWUgYXBwLmpzKQogICAgZWw6ICcuc2VsZWN0aW9uIC5pbmRpY2F0b3I6bm90KFtkYXRhLXNlbGVjdGlvbl0pJywKCiAgICBzZWxlY3Rpb25DaGFuZ2VkOiBmdW5jdGlvbihvcHRzKSB7CiAgICAgIHRoaXMucmVuZGVyKCk7CiAgICB9LAoKICAgIHJlbmRlcjogZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMuJGVsLmh0bWwodGhpcy5jb2xsZWN0aW9uLmxlbmd0aCk7CiAgICB9CgogIH0pOwoKICByZXR1cm4gU2VsZWN0aW9uSW5kaWNhdG9yOwoKfSk7CgovKiBTZWxlY3Rpb25Ub2dnbGVCdXR0b24KICogLS0tLS0tLS0tLS0tLS0tCiAqCiAqIEEgdmlldyBDb21wb25lbnQgZm9yIHRvZ2dsaW5nIGJldHdlZW4gdGhlIEltYWdlcyBpbiB0aGUgc2VsZWN0aW9uIGFuZCBhbGwgdGhlIAogKiBpbWFnZXMgb2YgdGhlIGN1cnJlbnQgZ2FsbGVyeS4KICoKICogQ29sbGVjdGlvbjogU2VsZWN0aW9uQ29sbGVjdGlvbgogKgogKi8KZGVmaW5lKCdnYWxsZXJ5L3ZpZXdzL3NlbGVjdGlvbi90b2dnbGUuYnV0dG9uJyxbCiAgJ3VuZGVyc2NvcmUnLAogICdiYWNrYm9uZScsCiAgJ2dhbGxlcnkvdmlld3Mvc2VsZWN0aW9uL2NvbXBvbmVudCcKXSwKZnVuY3Rpb24oXywgQmFja2JvbmUsIFNlbGVjdGlvbkNvbXBvbmVudCkgewoKICB2YXIgU2VsZWN0aW9uVG9nZ2xlQnV0dG9uID0gU2VsZWN0aW9uQ29tcG9uZW50LmV4dGVuZCh7CgogICAgZWw6ICcuc2VsZWN0aW9uIC5idXR0b24udG9nZ2xlJywKCiAgICBldmVudHM6IHsKICAgICAgJ2NsaWNrJzogJ3RvZ2dsZScKICAgIH0sCgogICAgdG9nZ2xlOiBmdW5jdGlvbigpIHsKICAgICAgaWYgKHRoaXMuJGVsLmhhc0NsYXNzKCdhY3RpdmUnKSkgewogICAgICAgIHRoaXMuZmlsdGVyKCk7CiAgICAgIH0KICAgIH0sCgogICAgZmlsdGVyOiBmdW5jdGlvbigpIHsKICAgICAgdmFyIGdhbGxlcnlJbWFnZXMgPSB0aGlzLmNvbGxlY3Rpb24uZ2FsbGVyeS5nZXQoJ2ltYWdlcycpOwogICAgICAKICAgICAgaWYgKCF0aGlzLiRlbC5oYXNDbGFzcygnZmlsdGVyZWQnKSkgeyAgICAgLy8gZmlsdGVyIHNlbGVjdGVkCiAgICAgICAgdGhpcy51bmZpbHRlcmVkSW1hZ2VzID0gbmV3IEJhY2tib25lLkNvbGxlY3Rpb24oZ2FsbGVyeUltYWdlcy5tb2RlbHMpOwogICAgICAgIGdhbGxlcnlJbWFnZXMucmVzZXQodGhpcy5jb2xsZWN0aW9uLm1vZGVscyk7CiAgICAgIH0gZWxzZSB7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHVuZmlsdGVyIHNlbGVjdGVkCiAgICAgICAgZ2FsbGVyeUltYWdlcy5yZXNldCh0aGlzLnVuZmlsdGVyZWRJbWFnZXMubW9kZWxzKTsKICAgICAgICB0aGlzLnVuZmlsdGVyZWRJbWFnZXMgPSB1bmRlZmluZWQ7CiAgICAgIH0KICAgICAgdGhpcy4kZWwudG9nZ2xlQ2xhc3MoJ2ZpbHRlcmVkJyk7CiAgICB9LAoKICAgIC8vIFdoZW4gYW4gaXRlbSBnZXRzIHJlbW92ZWQgYW5kIHRoZSBzZWxlY3Rpb24gaXMgY3VycmVudGx5IHRvZ2dsZWQgKGZpbHRlcmVkKSwgCiAgICAvLyB0aGVuIHdlIG5lZWQgdG8gInN5bmNocm9uaXplIiB0aGUgY29ycmVzcG9uZGluZyBJbWFnZU1vZGVsIG9iamVjdCBpbiB0aGUgCiAgICAvLyB1bmZpbHRlcmVkIGNvbGxlY3Rpb24uCiAgICBpdGVtUmVtb3ZlZDogZnVuY3Rpb24obW9kZWwsIGNvbCwgb3B0cykgewogICAgICBpZiAodGhpcy51bmZpbHRlcmVkSW1hZ2VzKSB7CiAgICAgICAgdmFyIGltYWdlTW9kZWwgPSB0aGlzLnVuZmlsdGVyZWRJbWFnZXMuZ2V0KG1vZGVsLmlkKTsKICAgICAgICBpZiAoaW1hZ2VNb2RlbCkgewogICAgICAgICAgaW1hZ2VNb2RlbC5zZXQoJ3NlbGVjdGVkJywgZmFsc2UpOwogICAgICAgIH0KICAgICAgfQogICAgICBTZWxlY3Rpb25Db21wb25lbnQucHJvdG90eXBlLml0ZW1SZW1vdmVkLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9LAoKICAgIHNlbGVjdGlvbkNoYW5nZWQ6IGZ1bmN0aW9uKG9wdHMpIHsKICAgICAgLy8gdG9nZ2xlIGZpbHRlciBpZiBzZWxlY3Rpb24gZW1wdHkgYW5kIGN1cnJlbnRseSBmaWx0ZXJlZC4KICAgICAgaWYgKHRoaXMuY29sbGVjdGlvbi5sZW5ndGggPT09IDAgJiYgdGhpcy4kZWwuaGFzQ2xhc3MoJ2ZpbHRlcmVkJykpIHsKICAgICAgICB0aGlzLmZpbHRlcigpOwogICAgICB9CiAgICB9CgogIH0pOwoKICByZXR1cm4gU2VsZWN0aW9uVG9nZ2xlQnV0dG9uOwoKfSk7CgovKiBTZWxlY3Rpb25QZGZCdXR0b24KICogLS0tLS0tLS0tLS0tLS0tLS0tLQogKgogKiBBIFZpZXcgQ29tcG9uZW50LiBTZW5kcyB0aGUgc2VsZWN0ZWQgSW1hZ2VzIHRvIGEgcmVtb3RlIFNlcnZpY2Ugc3BlY2lmaWVkIHZpYQogKiB0aGUgZGF0YS11cmwgYXR0cmlidXRlLCB3aGljaCBnZW5lcmF0ZXMgYSBQREYgRm9saW8gZm9yIHRoZSBTZWxlY3Rpb24uCiAqCiAqIFRoZSBDb21wb25lbnQgbmVlZHMgdG8gc3BlY2lmeSBkYXRhLWtleSBhbmQgZGF0YS10aXRsZSBmb3IgdGhlIFBERiBzZXJ2aWNlIHRvCiAqIHdvcmsuIFRoZSBtYXJrdXAgZm9yIHRoaXMgY29tcG9uZW50IHRvIGdldCBhY3RpdmF0ZWQ6CiAqCiAqIGBgPHNwYW4gY2xhc3M9InBkZiBidXR0b24iIHRpdGxlPSJkb3dubG9hZCBzZWxlY3RlZCBwaG90b3MgYXMgUERGIGRvY3VtZW50IiAKICogICAgICAgICBkYXRhLXVybD0iaHR0cDovL3BkZi1nZW4taG9zdC5vcmcvYXBpIiAKICogICAgICAgICBkYXRhLXRpdGxlPSJUaXRsZSBmb3IgRm9saW8iIAogKiAgICAgICAgIGRhdGEta2V5PSJzaXRlLWtleSI+PC9zcGFuPmBgCiAqCiAqIENvbGxlY3Rpb246IFNlbGVjdGlvbkNvbGxlY3Rpb24KICovCmRlZmluZSgnZ2FsbGVyeS92aWV3cy9zZWxlY3Rpb24vcGRmLmJ1dHRvbicsWwogICdiYWNrYm9uZScsCiAgJ2dhbGxlcnkvdmlld3Mvc2VsZWN0aW9uL2NvbXBvbmVudCcKXSwgZnVuY3Rpb24oQmFja2JvbmUsIFNlbGVjdGlvbkNvbXBvbmVudCkgewoKICB2YXIgU2VsZWN0aW9uUGRmQnV0dG9uID0gU2VsZWN0aW9uQ29tcG9uZW50LmV4dGVuZCh7CgogICAgZWw6ICcuc2VsZWN0aW9uIC5idXR0b24ucGRmJywKCiAgICBldmVudHM6IHsKICAgICAgJ2NsaWNrJzogJ2Rvd25sb2FkQ2xpY2snCiAgICB9LAoKICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uKCkgewogICAgICBpZiAodGhpcy4kZWwubGVuZ3RoICYmIHRoaXMuY29sbGVjdGlvbikgewogICAgICAgIC8vIFByZXBhcmUgRGF0YSBmb3IgUERGIFJlcXVlc3QKICAgICAgICB0aGlzLmZvbGlvRGF0YSA9IHt9OwogICAgICAgIHRoaXMuZm9saW9EYXRhLnVybCA9IHRoaXMuJGVsLmRhdGEoJ3VybCcpOwogICAgICAgIHRoaXMuZm9saW9EYXRhLnRpdGxlID0gdGhpcy4kZWwuZGF0YSgndGl0bGUnKTsKICAgICAgICB0aGlzLmZvbGlvRGF0YS5rZXkgPSB0aGlzLiRlbC5kYXRhKCdrZXknKTsKICAgICAgICB0aGlzLmZvbGlvRGF0YS50ZW1wbGF0ZSA9IHRoaXMuJGVsLmRhdGEoJ3RlbXBsYXRlJyk7CiAgICAgICAgCiAgICAgICAgU2VsZWN0aW9uQ29tcG9uZW50LnByb3RvdHlwZS5pbml0aWFsaXplLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIH0KICAgIH0sCgogICAgZG93bmxvYWRDbGljazogZnVuY3Rpb24oKSB7CiAgICAgIGlmICh0aGlzLiRlbC5oYXNDbGFzcygnYWN0aXZlJykpIHsKICAgICAgICB0aGlzLnJlbmRlckxvYWRpbmcoKTsKICAgICAgICAkLmFqYXgoewogICAgICAgICAgICB0eXBlOiAnUE9TVCcsCiAgICAgICAgICAgIHVybDogdGhpcy5mb2xpb0RhdGEudXJsLAogICAgICAgICAgICBkYXRhOiBKU09OLnN0cmluZ2lmeSgKICAgICAgICAgICAgICB0aGlzLmdldFBkZkdlblBheWxvYWQoKQogICAgICAgICAgICApLAogICAgICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbihkYXRhKSB7CiAgICAgICAgICAgICAgaWYgKGRhdGEuZm9saW8uZXhpc3RzKSB7CiAgICAgICAgICAgICAgICB0aGlzLmRvd25sb2FkUGRmKGRhdGEuZm9saW8udXJsKTsKICAgICAgICAgICAgICAgIHRoaXMucmVuZGVyQWN0aXZlKHRoaXMuY29sbGVjdGlvbi5sZW5ndGggPiAwKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy50cnlBZ2FpbihkYXRhLmZvbGlvLnVybCwgMTUwMCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LmJpbmQodGhpcyksCiAgICAgICAgICAgIGVycm9yOiBmdW5jdGlvbihyZXNwKSB7CiAgICAgICAgICAgICAgdGhpcy5yZW5kZXJFcnJvcigpOwogICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdTb21ldGhpbmcgd2VudCB3cm9uZyB3aGlsZSBnZW5lcmF0aW5nIHRoZSBQREYhJywgcmVzcCk7CiAgICAgICAgICAgIH0uYmluZCh0aGlzKSwKICAgICAgICAgICAgY29udGVudFR5cGU6ICdhcHBsaWNhdGlvbi9qc29uJywKICAgICAgICAgICAgZGF0YVR5cGU6ICdqc29uJwogICAgICAgICAgfSk7CiAgICAgIH0KICAgIH0sCgogICAgdHJ5QWdhaW46IGZ1bmN0aW9uKHVybCwgZGVsYXkpIHsKICAgICAgJC5hamF4KHsKICAgICAgICB0eXBlOiAnSEVBRCcsCiAgICAgICAgdXJsOiB1cmwsCiAgICAgICAgc3VjY2VzczogZnVuY3Rpb24ocmVzcCkgewogICAgICAgICAgd2luZG93LmNsZWFyVGltZW91dCh0aGlzLnRpbWVvdXRJZCk7CiAgICAgICAgICB0aGlzLmRvd25sb2FkUGRmKHVybCk7CiAgICAgICAgICB0aGlzLnJlbmRlckFjdGl2ZSh0aGlzLmNvbGxlY3Rpb24ubGVuZ3RoID4gMCk7CiAgICAgICAgfS5iaW5kKHRoaXMpLAogICAgICAgIGVycm9yOiBmdW5jdGlvbihyZXNwKSB7CiAgICAgICAgICB3aW5kb3cuY2xlYXJUaW1lb3V0KHRoaXMudGltZW91dElkKTsKICAgICAgICAgIHRoaXMudGltZW91dElkID0gc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgdGhpcy50cnlBZ2Fpbih1cmwsIGRlbGF5KTsKICAgICAgICAgIH0uYmluZCh0aGlzKSwgZGVsYXkpOwogICAgICAgIH0uYmluZCh0aGlzKQogICAgICB9KTsKICAgIH0sCgogICAgZG93bmxvYWRQZGY6IGZ1bmN0aW9uKHVybCkgewogICAgICB3aW5kb3cubG9jYXRpb24uaHJlZiA9IHVybDsKICAgIH0sCgogICAgLy8gVE9ETzogcmF1cyBoaWVyLCBlbnR3ZWRlciBpbiBkaWUgU2VsZWN0aW9uIG9kZXIgaW4gZGVuIFNlcnZlciwgZGFzIGlzdCAKICAgIC8vIE1vZGVsIGJ1c2luZXNzIQogICAgZ2V0UGRmR2VuUGF5bG9hZDogZnVuY3Rpb24oKSB7CiAgICAgIHZhciBmb2xpb1BheWxvYWQgPSB7CiAgICAgICAgdGl0bGU6IHRoaXMuZm9saW9EYXRhLnRpdGxlLAogICAgICAgIGtleTogdGhpcy5mb2xpb0RhdGEua2V5LAogICAgICAgIHRlbXBsYXRlOiB0aGlzLmZvbGlvRGF0YS50ZW1wbGF0ZSwKICAgICAgICBpbWFnZXM6IFtdCiAgICAgIH07CiAgICAgIHRoaXMuY29sbGVjdGlvbi5lYWNoKGZ1bmN0aW9uKGltYWdlTW9kZWwpIHsKICAgICAgICBmb2xpb1BheWxvYWQuaW1hZ2VzLnB1c2goewogICAgICAgICAgJ3VybCc6IGltYWdlTW9kZWwuZ2V0KCdsYXJnZScpLnNyYwogICAgICAgIH0pOwogICAgICB9KTsKICAgICAgcmV0dXJuIHtmb2xpbzogZm9saW9QYXlsb2FkfTsKICAgIH0sCgogICAgcmVuZGVyRXJyb3I6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLiRlbC5yZW1vdmVDbGFzcygnbG9hZGluZyBhY3RpdmUnKTsKICAgICAgdGhpcy4kZWwuYWRkQ2xhc3MoJ2Vycm9yJyk7CiAgICAgIHRoaXMuJGVsLmh0bWwoJ0Rvd25sb2FkIFBERicpOwogICAgICB0aGlzLiRlbC5hdHRyKCd0aXRsZScsICdTb21ldGhpbmcgd2VudCB3cm9uZzogU2VydmVyIEVycm9yISBUcnkgYWdhaW4gaW4gYSBtb21lbnQnKTsKICAgIH0sCgogICAgcmVuZGVyTG9hZGluZzogZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMuJGVsLmh0bWwoJ0xvYWRpbmcgUERGJyk7CiAgICAgIHRoaXMuJGVsLnJlbW92ZUNsYXNzKCdhY3RpdmUnKTsKICAgICAgdGhpcy4kZWwuYWRkQ2xhc3MoJ2xvYWRpbmcnKTsKICAgIH0sCgogICAgcmVuZGVyQWN0aXZlOiBmdW5jdGlvbihhY3RpdmUpIHsKICAgICAgdGhpcy4kZWwuaHRtbCgnRG93bmxvYWQgUERGJyk7CiAgICAgIHRoaXMuJGVsLnJlbW92ZUNsYXNzKCdsb2FkaW5nJyk7CiAgICAgIFNlbGVjdGlvbkNvbXBvbmVudC5wcm90b3R5cGUucmVuZGVyQWN0aXZlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9CgogIH0pOwoKICByZXR1cm4gU2VsZWN0aW9uUGRmQnV0dG9uOwp9KTsKCi8qIGpzaGludCBjYW1lbGNhc2U6IGZhbHNlICovCi8qCiAqIEdhbGxlcnkgQXBwCiAqCiAqIE9wdGlvbnM6CiAqIC0gZWw6IEVsZW1lbnQgdG8gaW5pdGlhbGl6ZSB0aGUgR2FsbGVyeSBvbi4KICogLSBvbkluaXQ6IENhbGxiYWNrIGZvciB3aGVuIHRoZSBHYWxsZXJ5QXBwIGlzIGluaXRpYWxpemVkICh0aGUgSW1hZ2VzIGFyZSAKICogICAgICAgICAgIGxvYWRlZCkuIFRoZSBjYWxsYmFjayByZWNlaXZlcyB0byBhcmdzOiBHYWxsZXJ5QXBwIGFuZCBHYWxsZXJ5TW9kZWwKICogLSBnYWxsZXJ5T3B0czogb3B0cyBmb3IgdGhlIGdhbGxlcnkgKG92ZXJyaWRlIHRoZSBvbmVzIGluIHRoZSBnYWxsZXJ5IERPTSAKICAgICAgICAgICAgICAgICAgZWxlbWVudCAoZGF0YS1nYWwtb3B0cykgYW5kIHRoZSBnYWxsZXJ5IGpzb24pLgogKi8KZGVmaW5lKCdnYWxsZXJ5L2FwcCcsWwogICdiYWNrYm9uZScsCiAgJ3VuZGVyc2NvcmUnLAogICdnYWxsZXJ5L21vZGVscy9nYWxsZXJ5LmZhY3RvcnknLAogICdnYWxsZXJ5L3ZpZXdzL3RodW1iLmNvbnRhaW5lci5tYXNvbnJ5JywKICAnZ2FsbGVyeS92aWV3cy90aHVtYi5jb250YWluZXIuZHluYW1pYycsCiAgJ2dhbGxlcnkvdmlld3MvdGh1bWIuY29udGFpbmVyLmR5bmFtaWMubWFzb25yeScsCiAgJ2dhbGxlcnkvdmlld3Mvc2xpZGVyLnZpZXcnLAogICdnYWxsZXJ5L3V0aWxzL3Jlc3BvbnNpdmUuYWRhcHRlcicsCiAgJ2dhbGxlcnkvY29sbGVjdGlvbnMvc2VsZWN0aW9uLmNvbGxlY3Rpb24nLAogICdnYWxsZXJ5L3ZpZXdzL3NlbGVjdGlvbi9jb21wb25lbnQnLAogICdnYWxsZXJ5L3ZpZXdzL3NlbGVjdGlvbi9pbmRpY2F0b3InLAogICdnYWxsZXJ5L3ZpZXdzL3NlbGVjdGlvbi90b2dnbGUuYnV0dG9uJywKICAnZ2FsbGVyeS92aWV3cy9zZWxlY3Rpb24vcGRmLmJ1dHRvbicKXSwKZnVuY3Rpb24oCiAgQmFja2JvbmUsIF8sIEdhbGxlcnlGYWN0b3J5LAogIFRodW1iQ29udGFpbmVyTWFzb25yeSwgVGh1bWJDb250YWluZXJEeW5hbWljLCBUaHVtYkNvbnRhaW5lckR5bmFtaWNNYXNvbnJ5LAogIFNsaWRlclZpZXcsIFJlc3BvbnNpdmVBZGFwdGVyLAogIFNlbGVjdGlvbkNvbGxlY3Rpb24sIFNlbGVjdGlvbkNvbXBvbmVudCwgU2VsZWN0aW9uSW5kaWNhdG9yLAogIFNlbGVjdGlvblRvZ2dsZUJ1dHRvbiwgU2VsZWN0aW9uUGRmQnV0dG9uCikgewogIAogIHZhciBHYWxsZXJ5QXBwID0gQmFja2JvbmUuVmlldy5leHRlbmQoewogICAgCiAgICBlbDogJ2FydGljbGUuZ2FsbGVyeScsCgogICAgLy8gZGVmYXVsdCBvcHRpb25zIGZvciBnYWxsZXJ5IGFwcAogICAgZGVmYXVsdE9wdHM6IHsKICAgICAgbGF5b3V0OiAnbWFzb25yeScKICAgIH0sCgogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24ob3B0cykgewoKICAgICAgLy8gZ2V0IG9wdGlvbnMKICAgICAgaWYgKHRoaXMuJGVsLmRhdGEoJ2dhbC1sYXlvdXQnKSkgewogICAgICAgIHRoaXMuZGVmYXVsdE9wdHMubGF5b3V0ID0gdGhpcy4kZWwuZGF0YSgnZ2FsLWxheW91dCcpOwogICAgICB9CiAgICAgIHRoaXMub3B0aW9ucyA9IF8uZXh0ZW5kKHt9LCB0aGlzLmRlZmF1bHRPcHRzLCB0aGlzLm9wdGlvbnMpOwoKICAgICAgLy8gSW5pdCBHYWxsZXJ5TW9kZWwKICAgICAgdGhpcy5tb2RlbCA9IEdhbGxlcnlGYWN0b3J5LmNyZWF0ZSh0aGlzLiRlbCwgb3B0c1snZ2FsbGVyeU9wdHMnXSk7CgogICAgICAvLyBJbml0IFNlbGVjdGlvbgogICAgICB0aGlzLmluaXRTZWxlY3Rpb24oKTsKCiAgICAgIGlmICh0aGlzLm1vZGVsKSB7CiAgICAgICAgLy8gSW5pdCBUaHVtYkNvbnRhaW5lclZpZXcKICAgICAgICB0aGlzLmluaXRUaHVtYkNvbnRhaW5lcigpOwogICAgICAgIAogICAgICAgIC8vIEZldGNoIEdhbGxlcnkgRGF0YSBmcm9tIFNlcnZlcgogICAgICAgIHRoaXMubW9kZWwuZmV0Y2goewogICAgICAgICAgc3VjY2VzczogXy5iaW5kKGZ1bmN0aW9uKG1vZGVsLCByZXNwLCBfb3B0cykgewogICAgICAgICAgICB2YXIgJGVsID0gdGhpcy4kZWw7CiAgICAgICAgICAgIC8vIG1hcmsgRE9NIEVsZW1lbnQgYXMgaW5pdGlhbGl6ZWQKICAgICAgICAgICAgJGVsLmFkZENsYXNzKCdpbml0aWFsaXplZCcpOwogICAgICAgICAgICAvLyBtYXJrIERPTSBFbGVtZW50IGFzIGVtcHR5CiAgICAgICAgICAgIGlmIChtb2RlbC5nZXQoJ2ltYWdlcycpLmlzRW1wdHkoKSkgewogICAgICAgICAgICAgICRlbC5hZGRDbGFzcygnZW1wdHknKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBsaXN0ZW5UbyByZW1vdmUgRXZlbnRzID0+IG1hcmsgZW1wdHkKICAgICAgICAgICAgdGhpcy5saXN0ZW5Ubyhtb2RlbC5nZXQoJ2ltYWdlcycpLCAncmVtb3ZlJywgZnVuY3Rpb24obSxjLG8pIHsKICAgICAgICAgICAgICBpZiAoYy5pc0VtcHR5KCkpIHsgJGVsLmFkZENsYXNzKCdlbXB0eScpOyB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBpZiAob3B0cy5vbkluaXQpIHsgb3B0cy5vbkluaXQodGhpcywgdGhpcy5tb2RlbCk7IH0KICAgICAgICAgIH0sIHRoaXMpCiAgICAgICAgfSk7CgogICAgICAgIC8vIEluc3RhbmNpYXRlIHRoZSBTbGlkZXJWaWV3CiAgICAgICAgdGhpcy5pbml0U2xpZGVyKCk7CgogICAgICAgIC8vIG1ha2UgZ2FsbGVyeSBvYmplY3QgYXZhaWxhYmxlIGluIERPTQogICAgICAgIHRoaXMuJGVsLmRhdGEoJ2dhbGxlcnknLCB0aGlzKTsKICAgICAgfQogICAgfSwKCiAgICAvLyBJbml0IFNlbGVjdGlvbnMKICAgIGluaXRTZWxlY3Rpb246IGZ1bmN0aW9uKCkgewogICAgICAvLyBHbG9iYWwgU2VsZWN0aW9uQ29sbGVjdGlvbiBmb3IgZ2FsbGVyeSBvbmx5IHdoZW4gdGhlcmUgaXMgdGhlIAogICAgICAvLyBkYXRhIGF0dHJpYiBkYXRhLWdhbC1zZWxlY3RvcgogICAgICB2YXIgZ2FsU2VsZWN0aW9uQXR0cmliID0gdGhpcy4kZWwuZGF0YSgnZ2FsLXNlbGVjdGlvbicpOwogICAgICBpZiAoISFnYWxTZWxlY3Rpb25BdHRyaWIpIHsKICAgICAgICAvLyBpbml0IHNlbGVjdGlvbiBjb2xsZWN0aW9uCiAgICAgICAgdGhpcy5zZWxlY3Rpb24gPSBTZWxlY3Rpb25Db2xsZWN0aW9uLmdldCh0aGlzLiRlbC5kYXRhKCdnYWwtc2VsZWN0aW9uJyksIHRoaXMubW9kZWwpOwoKICAgICAgICAvLyBpbml0IHNlbGVjdGlvbiBpbmRpY2F0b3IKICAgICAgICB0aGlzLnNlbGVjdGlvbkluZGljYXRvciA9IG5ldyBTZWxlY3Rpb25JbmRpY2F0b3IoewogICAgICAgICAgY29sbGVjdGlvbjogdGhpcy5zZWxlY3Rpb24KICAgICAgICB9KTsKCiAgICAgICAgLy8gaW5pdCB0b2dnbGUgYnV0dG9uCiAgICAgICAgdGhpcy5zZWxlY3Rpb25Ub2dnbGVCdXR0b24gPSBuZXcgU2VsZWN0aW9uVG9nZ2xlQnV0dG9uKHsKICAgICAgICAgIGNvbGxlY3Rpb246IHRoaXMuc2VsZWN0aW9uCiAgICAgICAgfSk7CgogICAgICAgIC8vIGluaXQgcGRmIGJ1dHRvbgogICAgICAgIHRoaXMuc2VsZWN0aW9uUGRmQnV0dG9uID0gbmV3IFNlbGVjdGlvblBkZkJ1dHRvbih7CiAgICAgICAgICBjb2xsZWN0aW9uOiB0aGlzLnNlbGVjdGlvbgogICAgICAgIH0pOwoKICAgICAgICAvLyBpbml0IHNlbGVjdGlvbiBjb21wb25lbnRzLCB3aGljaCBvbmx5IG5lZWQgdG8gYmUgaW5pdGlhbGl6ZWQgYW5kIHNldCBhY3RpdmUvaW5hY3RpdmUKICAgICAgICBuZXcgU2VsZWN0aW9uQ29tcG9uZW50KHsKICAgICAgICAgIGVsOiAkKCcuc2VsZWN0aW9uIC5jb21wb25lbnQnKSwKICAgICAgICAgIGNvbGxlY3Rpb246IHRoaXMuc2VsZWN0aW9uCiAgICAgICAgfSk7CiAgICAgIH0KCiAgICAgIC8vIEV4cGxpY2l0bHkgYWRkcmVzc2VkIHNlbGVjdGlvbiBpbmRpY2F0b3JzCiAgICAgIC8vIEdyb3VwIHRoZW0gYnkgc2VsZWN0aW9uIGtleXMKICAgICAgdmFyIG1hcHBpbmcgPSB7fTsKICAgICAgJCgnW2RhdGEtc2VsZWN0aW9uXS5pbmRpY2F0b3InKS5lYWNoKGZ1bmN0aW9uKCkgewogICAgICAgIHZhciAkZWwgPSAkKHRoaXMpOwogICAgICAgIG1hcHBpbmdbJGVsLmRhdGEoJ3NlbGVjdGlvbicpXSA9CiAgICAgICAgICBtYXBwaW5nWyRlbC5kYXRhKCdzZWxlY3Rpb24nKV0gPT09IHVuZGVmaW5lZCA/ICRlbCA6IG1hcHBpbmdbJGVsLmRhdGEoJ3NlbGVjdGlvbicpXS5hZGQoJGVsKTsKICAgICAgfSk7CiAgICAgIC8vIGluaXRpYWxpemUgYSBpbmRpY2F0b3IgdmlldyBmb3IgZXZlcnkgc2VsZWN0aW9uIGtleS4KICAgICAgXy5lYWNoKG1hcHBpbmcsIGZ1bmN0aW9uKCRlbGVtZW50cywga2V5KSB7CiAgICAgICAgdmFyIHNlbCA9IFNlbGVjdGlvbkNvbGxlY3Rpb24uZ2V0KGtleSwgdGhpcy5tb2RlbCk7CiAgICAgICAgbmV3IFNlbGVjdGlvbkluZGljYXRvcih7IGNvbGxlY3Rpb246IHNlbCwgZWw6ICRlbGVtZW50cyB9KTsKICAgICAgICBpZiAoc2VsLmdhbGxlcnkgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgc2VsLmZldGNoKCk7CiAgICAgICAgfQogICAgICB9LCB0aGlzKTsKICAgIH0sCgogICAgLy8gSW5zdGFuY2lhdGUgdGhlIFRodW1iQ29udGFpbmVyVmlldyAoZHluYW1pYyBvciBzdGFuZGFyZD8pCiAgICBpbml0VGh1bWJDb250YWluZXI6IGZ1bmN0aW9uKCkgewogICAgICB2YXIgdGh1bWJDb250YWluZXJPcHRpb25zID0gewogICAgICAgIG1vZGVsOiB0aGlzLm1vZGVsLAogICAgICAgIGl0ZW1TZWxlY3RvcjogJy5waG90bycKICAgICAgfTsKICAgICAgCiAgICAgIC8vIG5vdGhpbmcgZHluYW1pYywgYWxsIHBob3RvcyBhcmUgcmVuZGVyZWQgYXQgbG9hZGluZyB0aW1lCiAgICAgIGlmICh0aGlzLiQoJy5jb250YWluZXIucGhvdG9zIC5waG90bycpLmxlbmd0aCkgewogICAgICAgIHRoaXMuY29udGFpbmVyVmlldyA9IG5ldyBUaHVtYkNvbnRhaW5lck1hc29ucnkodGh1bWJDb250YWluZXJPcHRpb25zKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAodGhpcy5vcHRpb25zLmxheW91dCA9PT0gJ25vbmUnKSB7CiAgICAgICAgICB0aGlzLmNvbnRhaW5lclZpZXcgPSBuZXcgVGh1bWJDb250YWluZXJEeW5hbWljKHRodW1iQ29udGFpbmVyT3B0aW9ucyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXMuY29udGFpbmVyVmlldyA9IG5ldyBUaHVtYkNvbnRhaW5lckR5bmFtaWNNYXNvbnJ5KHRodW1iQ29udGFpbmVyT3B0aW9ucyk7CiAgICAgICAgfQogICAgICB9CiAgICB9LAoKICAgIC8vIEluc3RhbmNpYXRlIHRoZSBTbGlkZXIgdmlldwogICAgaW5pdFNsaWRlcjogZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMuc2xpZGVyVmlldyA9IG5ldyBTbGlkZXJWaWV3KHsKICAgICAgICBlbDogdGhpcy4kKCcuc2xpZGVyJyksCiAgICAgICAgbW9kZWw6IHRoaXMubW9kZWwKICAgICAgfSk7CiAgICB9LAoKICAgIC8vIEdpdmUgYXBwIHVzZXIgYWNjZXNzIHRvIHRoZSBSZXNwb25zaXZlQWRhcHRlcgogICAgZ2V0UmVzcG9uc2l2ZUFkYXB0ZXI6IGZ1bmN0aW9uKCkgewogICAgICBpZiAodGhpcy5yZXNwb25zaXZlQWRhcHRlciA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgdGhpcy5yZXNwb25zaXZlQWRhcHRlciA9IFJlc3BvbnNpdmVBZGFwdGVyOwogICAgICB9CiAgICAgIHJldHVybiB0aGlzLnJlc3BvbnNpdmVBZGFwdGVyOwogICAgfQoKICB9KTsKICAKICByZXR1cm4gR2FsbGVyeUFwcDsKCn0pOwoKLyoganNoaW50IGlnbm9yZTpzdGFydCAqLwogICAgLy9UaGUgbW9kdWxlcyBmb3IgeW91ciBwcm9qZWN0IHdpbGwgYmUgaW5saW5lZCBhYm92ZQogICAgLy90aGlzIHNuaXBwZXQuIEFzayBhbG1vbmQgdG8gc3luY2hyb25vdXNseSByZXF1aXJlIHRoZQogICAgLy9tb2R1bGUgdmFsdWUgZm9yICdtYWluJyBoZXJlIGFuZCByZXR1cm4gaXQgYXMgdGhlCiAgICAvL3ZhbHVlIHRvIHVzZSBmb3IgdGhlIHB1YmxpYyBBUEkgZm9yIHRoZSBidWlsdCBmaWxlLgoKICAgIC8vIHdyYXAgZ2xvYmFsIGpRdWVyeSBvYmplY3QgaW50byB0aGUgJ2pxdWVyeScgbW9kdWxlIGZvciBhbGwgaXRzIAogICAgLy8gZGVwZW5kZW5jaWVzIGluIHRoZSBHYWxsZXJ5IEFwcC4KICAgIC8vIHNlZTogaHR0cHM6Ly9naXRodWIuY29tL2pyYnVya2UvYWxtb25kL2lzc3Vlcy8xMgogICAgZGVmaW5lKCdqcXVlcnknLCBbXSwgZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4galF1ZXJ5OwogICAgfSk7CgogICAgcmV0dXJuIHJlcXVpcmUoJ2dhbGxlcnkvYXBwJyk7Cn0pKTsKLyoganNoaW50IGlnbm9yZTplbmQgKi8K",
                "body": "LyoganNoaW50IGlnbm9yZTpzdGFydCAqLwooZnVuY3Rpb24gKHJvb3QsIGZhY3RvcnkpIHsKICAgIGlmICh0eXBlb2YgZGVmaW5lID09PSAnZnVuY3Rpb24nICYmIGRlZmluZS5hbWQpIHsKICAgICAgICAvL0FsbG93IHVzaW5nIHRoaXMgYnVpbHQgbGlicmFyeSBhcyBhbiBBTUQgbW9kdWxlCiAgICAgICAgLy9pbiBhbm90aGVyIHByb2plY3QuIFRoYXQgb3RoZXIgcHJvamVjdCB3aWxsIG9ubHkKICAgICAgICAvL3NlZSB0aGlzIEFNRCBjYWxsLCBub3QgdGhlIGludGVybmFsIG1vZHVsZXMgaW4KICAgICAgICAvL3RoZSBjbG9zdXJlIGJlbG93LgogICAgICAgIGRlZmluZShbXSwgZmFjdG9yeSk7CiAgICB9IGVsc2UgewogICAgICAgIC8vQnJvd3NlciBnbG9iYWxzIGNhc2UuIEp1c3QgYXNzaWduIHRoZQogICAgICAgIC8vcmVzdWx0IHRvIGEgcHJvcGVydHkgb24gdGhlIGdsb2JhbC4KICAgICAgICByb290LkdhbGxlcnlBcHAgPSBmYWN0b3J5KCk7CiAgICB9Cn0odGhpcywgZnVuY3Rpb24gKCkgewogICAgLy9hbG1vbmQsIGFuZCB5b3VyIG1vZHVsZXMgd2lsbCBiZSBpbmxpbmVkIGhlcmUKLyoganNoaW50IGlnbm9yZTplbmQgKi8KLyoqCiAqIEBsaWNlbnNlIGFsbW9uZCAwLjIuOSBDb3B5cmlnaHQgKGMpIDIwMTEtMjAxNCwgVGhlIERvam8gRm91bmRhdGlvbiBBbGwgUmlnaHRzIFJlc2VydmVkLgogKiBBdmFpbGFibGUgdmlhIHRoZSBNSVQgb3IgbmV3IEJTRCBsaWNlbnNlLgogKiBzZWU6IGh0dHA6Ly9naXRodWIuY29tL2pyYnVya2UvYWxtb25kIGZvciBkZXRhaWxzCiAqLwovL0dvaW5nIHNsb3BweSB0byBhdm9pZCAndXNlIHN0cmljdCcgc3RyaW5nIGNvc3QsIGJ1dCBzdHJpY3QgcHJhY3RpY2VzIHNob3VsZAovL2JlIGZvbGxvd2VkLgovKmpzbGludCBzbG9wcHk6IHRydWUgKi8KLypnbG9iYWwgc2V0VGltZW91dDogZmFsc2UgKi8KCnZhciByZXF1aXJlanMsIHJlcXVpcmUsIGRlZmluZTsKKGZ1bmN0aW9uICh1bmRlZikgewogICAgdmFyIG1haW4sIHJlcSwgbWFrZU1hcCwgaGFuZGxlcnMsCiAgICAgICAgZGVmaW5lZCA9IHt9LAogICAgICAgIHdhaXRpbmcgPSB7fSwKICAgICAgICBjb25maWcgPSB7fSwKICAgICAgICBkZWZpbmluZyA9IHt9LAogICAgICAgIGhhc093biA9IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHksCiAgICAgICAgYXBzID0gW10uc2xpY2UsCiAgICAgICAganNTdWZmaXhSZWdFeHAgPSAvXC5qcyQvOwoKICAgIGZ1bmN0aW9uIGhhc1Byb3Aob2JqLCBwcm9wKSB7CiAgICAgICAgcmV0dXJuIGhhc093bi5jYWxsKG9iaiwgcHJvcCk7CiAgICB9CgogICAgLyoqCiAgICAgKiBHaXZlbiBhIHJlbGF0aXZlIG1vZHVsZSBuYW1lLCBsaWtlIC4vc29tZXRoaW5nLCBub3JtYWxpemUgaXQgdG8KICAgICAqIGEgcmVhbCBuYW1lIHRoYXQgY2FuIGJlIG1hcHBlZCB0byBhIHBhdGguCiAgICAgKiBAcGFyYW0ge1N0cmluZ30gbmFtZSB0aGUgcmVsYXRpdmUgbmFtZQogICAgICogQHBhcmFtIHtTdHJpbmd9IGJhc2VOYW1lIGEgcmVhbCBuYW1lIHRoYXQgdGhlIG5hbWUgYXJnIGlzIHJlbGF0aXZlCiAgICAgKiB0by4KICAgICAqIEByZXR1cm5zIHtTdHJpbmd9IG5vcm1hbGl6ZWQgbmFtZQogICAgICovCiAgICBmdW5jdGlvbiBub3JtYWxpemUobmFtZSwgYmFzZU5hbWUpIHsKICAgICAgICB2YXIgbmFtZVBhcnRzLCBuYW1lU2VnbWVudCwgbWFwVmFsdWUsIGZvdW5kTWFwLCBsYXN0SW5kZXgsCiAgICAgICAgICAgIGZvdW5kSSwgZm91bmRTdGFyTWFwLCBzdGFySSwgaSwgaiwgcGFydCwKICAgICAgICAgICAgYmFzZVBhcnRzID0gYmFzZU5hbWUgJiYgYmFzZU5hbWUuc3BsaXQoIi8iKSwKICAgICAgICAgICAgbWFwID0gY29uZmlnLm1hcCwKICAgICAgICAgICAgc3Rhck1hcCA9IChtYXAgJiYgbWFwWycqJ10pIHx8IHt9OwoKICAgICAgICAvL0FkanVzdCBhbnkgcmVsYXRpdmUgcGF0aHMuCiAgICAgICAgaWYgKG5hbWUgJiYgbmFtZS5jaGFyQXQoMCkgPT09ICIuIikgewogICAgICAgICAgICAvL0lmIGhhdmUgYSBiYXNlIG5hbWUsIHRyeSB0byBub3JtYWxpemUgYWdhaW5zdCBpdCwKICAgICAgICAgICAgLy9vdGhlcndpc2UsIGFzc3VtZSBpdCBpcyBhIHRvcC1sZXZlbCByZXF1aXJlIHRoYXQgd2lsbAogICAgICAgICAgICAvL2JlIHJlbGF0aXZlIHRvIGJhc2VVcmwgaW4gdGhlIGVuZC4KICAgICAgICAgICAgaWYgKGJhc2VOYW1lKSB7CiAgICAgICAgICAgICAgICAvL0NvbnZlcnQgYmFzZU5hbWUgdG8gYXJyYXksIGFuZCBsb3Agb2ZmIHRoZSBsYXN0IHBhcnQsCiAgICAgICAgICAgICAgICAvL3NvIHRoYXQgLiBtYXRjaGVzIHRoYXQgImRpcmVjdG9yeSIgYW5kIG5vdCBuYW1lIG9mIHRoZSBiYXNlTmFtZSdzCiAgICAgICAgICAgICAgICAvL21vZHVsZS4gRm9yIGluc3RhbmNlLCBiYXNlTmFtZSBvZiAib25lL3R3by90aHJlZSIsIG1hcHMgdG8KICAgICAgICAgICAgICAgIC8vIm9uZS90d28vdGhyZWUuanMiLCBidXQgd2Ugd2FudCB0aGUgZGlyZWN0b3J5LCAib25lL3R3byIgZm9yCiAgICAgICAgICAgICAgICAvL3RoaXMgbm9ybWFsaXphdGlvbi4KICAgICAgICAgICAgICAgIGJhc2VQYXJ0cyA9IGJhc2VQYXJ0cy5zbGljZSgwLCBiYXNlUGFydHMubGVuZ3RoIC0gMSk7CiAgICAgICAgICAgICAgICBuYW1lID0gbmFtZS5zcGxpdCgnLycpOwogICAgICAgICAgICAgICAgbGFzdEluZGV4ID0gbmFtZS5sZW5ndGggLSAxOwoKICAgICAgICAgICAgICAgIC8vIE5vZGUgLmpzIGFsbG93YW5jZToKICAgICAgICAgICAgICAgIGlmIChjb25maWcubm9kZUlkQ29tcGF0ICYmIGpzU3VmZml4UmVnRXhwLnRlc3QobmFtZVtsYXN0SW5kZXhdKSkgewogICAgICAgICAgICAgICAgICAgIG5hbWVbbGFzdEluZGV4XSA9IG5hbWVbbGFzdEluZGV4XS5yZXBsYWNlKGpzU3VmZml4UmVnRXhwLCAnJyk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgbmFtZSA9IGJhc2VQYXJ0cy5jb25jYXQobmFtZSk7CgogICAgICAgICAgICAgICAgLy9zdGFydCB0cmltRG90cwogICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IG5hbWUubGVuZ3RoOyBpICs9IDEpIHsKICAgICAgICAgICAgICAgICAgICBwYXJ0ID0gbmFtZVtpXTsKICAgICAgICAgICAgICAgICAgICBpZiAocGFydCA9PT0gIi4iKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG5hbWUuc3BsaWNlKGksIDEpOwogICAgICAgICAgICAgICAgICAgICAgICBpIC09IDE7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChwYXJ0ID09PSAiLi4iKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpID09PSAxICYmIChuYW1lWzJdID09PSAnLi4nIHx8IG5hbWVbMF0gPT09ICcuLicpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvL0VuZCBvZiB0aGUgbGluZS4gS2VlcCBhdCBsZWFzdCBvbmUgbm9uLWRvdAogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy9wYXRoIHNlZ21lbnQgYXQgdGhlIGZyb250IHNvIGl0IGNhbiBiZSBtYXBwZWQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vY29ycmVjdGx5IHRvIGRpc2suIE90aGVyd2lzZSwgdGhlcmUgaXMgbGlrZWx5CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvL25vIHBhdGggbWFwcGluZyBmb3IgYSBwYXRoIHN0YXJ0aW5nIHdpdGggJy4uJy4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vVGhpcyBjYW4gc3RpbGwgZmFpbCwgYnV0IGNhdGNoZXMgdGhlIG1vc3QgcmVhc29uYWJsZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy91c2VzIG9mIC4uCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChpID4gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZS5zcGxpY2UoaSAtIDEsIDIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaSAtPSAyOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgLy9lbmQgdHJpbURvdHMKCiAgICAgICAgICAgICAgICBuYW1lID0gbmFtZS5qb2luKCIvIik7CiAgICAgICAgICAgIH0gZWxzZSBpZiAobmFtZS5pbmRleE9mKCcuLycpID09PSAwKSB7CiAgICAgICAgICAgICAgICAvLyBObyBiYXNlTmFtZSwgc28gdGhpcyBpcyBJRCBpcyByZXNvbHZlZCByZWxhdGl2ZQogICAgICAgICAgICAgICAgLy8gdG8gYmFzZVVybCwgcHVsbCBvZmYgdGhlIGxlYWRpbmcgZG90LgogICAgICAgICAgICAgICAgbmFtZSA9IG5hbWUuc3Vic3RyaW5nKDIpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvL0FwcGx5IG1hcCBjb25maWcgaWYgYXZhaWxhYmxlLgogICAgICAgIGlmICgoYmFzZVBhcnRzIHx8IHN0YXJNYXApICYmIG1hcCkgewogICAgICAgICAgICBuYW1lUGFydHMgPSBuYW1lLnNwbGl0KCcvJyk7CgogICAgICAgICAgICBmb3IgKGkgPSBuYW1lUGFydHMubGVuZ3RoOyBpID4gMDsgaSAtPSAxKSB7CiAgICAgICAgICAgICAgICBuYW1lU2VnbWVudCA9IG5hbWVQYXJ0cy5zbGljZSgwLCBpKS5qb2luKCIvIik7CgogICAgICAgICAgICAgICAgaWYgKGJhc2VQYXJ0cykgewogICAgICAgICAgICAgICAgICAgIC8vRmluZCB0aGUgbG9uZ2VzdCBiYXNlTmFtZSBzZWdtZW50IG1hdGNoIGluIHRoZSBjb25maWcuCiAgICAgICAgICAgICAgICAgICAgLy9TbywgZG8gam9pbnMgb24gdGhlIGJpZ2dlc3QgdG8gc21hbGxlc3QgbGVuZ3RocyBvZiBiYXNlUGFydHMuCiAgICAgICAgICAgICAgICAgICAgZm9yIChqID0gYmFzZVBhcnRzLmxlbmd0aDsgaiA+IDA7IGogLT0gMSkgewogICAgICAgICAgICAgICAgICAgICAgICBtYXBWYWx1ZSA9IG1hcFtiYXNlUGFydHMuc2xpY2UoMCwgaikuam9pbignLycpXTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vYmFzZU5hbWUgc2VnbWVudCBoYXMgIGNvbmZpZywgZmluZCBpZiBpdCBoYXMgb25lIGZvcgogICAgICAgICAgICAgICAgICAgICAgICAvL3RoaXMgbmFtZS4KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1hcFZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXBWYWx1ZSA9IG1hcFZhbHVlW25hbWVTZWdtZW50XTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtYXBWYWx1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vTWF0Y2gsIHVwZGF0ZSBuYW1lIHRvIHRoZSBuZXcgdmFsdWUuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm91bmRNYXAgPSBtYXBWYWx1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3VuZEkgPSBpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmIChmb3VuZE1hcCkgewogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vQ2hlY2sgZm9yIGEgc3RhciBtYXAgbWF0Y2gsIGJ1dCBqdXN0IGhvbGQgb24gdG8gaXQsCiAgICAgICAgICAgICAgICAvL2lmIHRoZXJlIGlzIGEgc2hvcnRlciBzZWdtZW50IG1hdGNoIGxhdGVyIGluIGEgbWF0Y2hpbmcKICAgICAgICAgICAgICAgIC8vY29uZmlnLCB0aGVuIGZhdm9yIG92ZXIgdGhpcyBzdGFyIG1hcC4KICAgICAgICAgICAgICAgIGlmICghZm91bmRTdGFyTWFwICYmIHN0YXJNYXAgJiYgc3Rhck1hcFtuYW1lU2VnbWVudF0pIHsKICAgICAgICAgICAgICAgICAgICBmb3VuZFN0YXJNYXAgPSBzdGFyTWFwW25hbWVTZWdtZW50XTsKICAgICAgICAgICAgICAgICAgICBzdGFySSA9IGk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICghZm91bmRNYXAgJiYgZm91bmRTdGFyTWFwKSB7CiAgICAgICAgICAgICAgICBmb3VuZE1hcCA9IGZvdW5kU3Rhck1hcDsKICAgICAgICAgICAgICAgIGZvdW5kSSA9IHN0YXJJOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoZm91bmRNYXApIHsKICAgICAgICAgICAgICAgIG5hbWVQYXJ0cy5zcGxpY2UoMCwgZm91bmRJLCBmb3VuZE1hcCk7CiAgICAgICAgICAgICAgICBuYW1lID0gbmFtZVBhcnRzLmpvaW4oJy8nKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIG5hbWU7CiAgICB9CgogICAgZnVuY3Rpb24gbWFrZVJlcXVpcmUocmVsTmFtZSwgZm9yY2VTeW5jKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgLy9BIHZlcnNpb24gb2YgYSByZXF1aXJlIGZ1bmN0aW9uIHRoYXQgcGFzc2VzIGEgbW9kdWxlTmFtZQogICAgICAgICAgICAvL3ZhbHVlIGZvciBpdGVtcyB0aGF0IG1heSBuZWVkIHRvCiAgICAgICAgICAgIC8vbG9vayB1cCBwYXRocyByZWxhdGl2ZSB0byB0aGUgbW9kdWxlTmFtZQogICAgICAgICAgICByZXR1cm4gcmVxLmFwcGx5KHVuZGVmLCBhcHMuY2FsbChhcmd1bWVudHMsIDApLmNvbmNhdChbcmVsTmFtZSwgZm9yY2VTeW5jXSkpOwogICAgICAgIH07CiAgICB9CgogICAgZnVuY3Rpb24gbWFrZU5vcm1hbGl6ZShyZWxOYW1lKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgICAgIHJldHVybiBub3JtYWxpemUobmFtZSwgcmVsTmFtZSk7CiAgICAgICAgfTsKICAgIH0KCiAgICBmdW5jdGlvbiBtYWtlTG9hZChkZXBOYW1lKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICBkZWZpbmVkW2RlcE5hbWVdID0gdmFsdWU7CiAgICAgICAgfTsKICAgIH0KCiAgICBmdW5jdGlvbiBjYWxsRGVwKG5hbWUpIHsKICAgICAgICBpZiAoaGFzUHJvcCh3YWl0aW5nLCBuYW1lKSkgewogICAgICAgICAgICB2YXIgYXJncyA9IHdhaXRpbmdbbmFtZV07CiAgICAgICAgICAgIGRlbGV0ZSB3YWl0aW5nW25hbWVdOwogICAgICAgICAgICBkZWZpbmluZ1tuYW1lXSA9IHRydWU7CiAgICAgICAgICAgIG1haW4uYXBwbHkodW5kZWYsIGFyZ3MpOwogICAgICAgIH0KCiAgICAgICAgaWYgKCFoYXNQcm9wKGRlZmluZWQsIG5hbWUpICYmICFoYXNQcm9wKGRlZmluaW5nLCBuYW1lKSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ05vICcgKyBuYW1lKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGRlZmluZWRbbmFtZV07CiAgICB9CgogICAgLy9UdXJucyBhIHBsdWdpbiFyZXNvdXJjZSB0byBbcGx1Z2luLCByZXNvdXJjZV0KICAgIC8vd2l0aCB0aGUgcGx1Z2luIGJlaW5nIHVuZGVmaW5lZCBpZiB0aGUgbmFtZQogICAgLy9kaWQgbm90IGhhdmUgYSBwbHVnaW4gcHJlZml4LgogICAgZnVuY3Rpb24gc3BsaXRQcmVmaXgobmFtZSkgewogICAgICAgIHZhciBwcmVmaXgsCiAgICAgICAgICAgIGluZGV4ID0gbmFtZSA/IG5hbWUuaW5kZXhPZignIScpIDogLTE7CiAgICAgICAgaWYgKGluZGV4ID4gLTEpIHsKICAgICAgICAgICAgcHJlZml4ID0gbmFtZS5zdWJzdHJpbmcoMCwgaW5kZXgpOwogICAgICAgICAgICBuYW1lID0gbmFtZS5zdWJzdHJpbmcoaW5kZXggKyAxLCBuYW1lLmxlbmd0aCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBbcHJlZml4LCBuYW1lXTsKICAgIH0KCiAgICAvKioKICAgICAqIE1ha2VzIGEgbmFtZSBtYXAsIG5vcm1hbGl6aW5nIHRoZSBuYW1lLCBhbmQgdXNpbmcgYSBwbHVnaW4KICAgICAqIGZvciBub3JtYWxpemF0aW9uIGlmIG5lY2Vzc2FyeS4gR3JhYnMgYSByZWYgdG8gcGx1Z2luCiAgICAgKiB0b28sIGFzIGFuIG9wdGltaXphdGlvbi4KICAgICAqLwogICAgbWFrZU1hcCA9IGZ1bmN0aW9uIChuYW1lLCByZWxOYW1lKSB7CiAgICAgICAgdmFyIHBsdWdpbiwKICAgICAgICAgICAgcGFydHMgPSBzcGxpdFByZWZpeChuYW1lKSwKICAgICAgICAgICAgcHJlZml4ID0gcGFydHNbMF07CgogICAgICAgIG5hbWUgPSBwYXJ0c1sxXTsKCiAgICAgICAgaWYgKHByZWZpeCkgewogICAgICAgICAgICBwcmVmaXggPSBub3JtYWxpemUocHJlZml4LCByZWxOYW1lKTsKICAgICAgICAgICAgcGx1Z2luID0gY2FsbERlcChwcmVmaXgpOwogICAgICAgIH0KCiAgICAgICAgLy9Ob3JtYWxpemUgYWNjb3JkaW5nCiAgICAgICAgaWYgKHByZWZpeCkgewogICAgICAgICAgICBpZiAocGx1Z2luICYmIHBsdWdpbi5ub3JtYWxpemUpIHsKICAgICAgICAgICAgICAgIG5hbWUgPSBwbHVnaW4ubm9ybWFsaXplKG5hbWUsIG1ha2VOb3JtYWxpemUocmVsTmFtZSkpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgbmFtZSA9IG5vcm1hbGl6ZShuYW1lLCByZWxOYW1lKTsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIG5hbWUgPSBub3JtYWxpemUobmFtZSwgcmVsTmFtZSk7CiAgICAgICAgICAgIHBhcnRzID0gc3BsaXRQcmVmaXgobmFtZSk7CiAgICAgICAgICAgIHByZWZpeCA9IHBhcnRzWzBdOwogICAgICAgICAgICBuYW1lID0gcGFydHNbMV07CiAgICAgICAgICAgIGlmIChwcmVmaXgpIHsKICAgICAgICAgICAgICAgIHBsdWdpbiA9IGNhbGxEZXAocHJlZml4KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy9Vc2luZyByaWRpY3Vsb3VzIHByb3BlcnR5IG5hbWVzIGZvciBzcGFjZSByZWFzb25zCiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgZjogcHJlZml4ID8gcHJlZml4ICsgJyEnICsgbmFtZSA6IG5hbWUsIC8vZnVsbE5hbWUKICAgICAgICAgICAgbjogbmFtZSwKICAgICAgICAgICAgcHI6IHByZWZpeCwKICAgICAgICAgICAgcDogcGx1Z2luCiAgICAgICAgfTsKICAgIH07CgogICAgZnVuY3Rpb24gbWFrZUNvbmZpZyhuYW1lKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIChjb25maWcgJiYgY29uZmlnLmNvbmZpZyAmJiBjb25maWcuY29uZmlnW25hbWVdKSB8fCB7fTsKICAgICAgICB9OwogICAgfQoKICAgIGhhbmRsZXJzID0gewogICAgICAgIHJlcXVpcmU6IGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgICAgIHJldHVybiBtYWtlUmVxdWlyZShuYW1lKTsKICAgICAgICB9LAogICAgICAgIGV4cG9ydHM6IGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgICAgIHZhciBlID0gZGVmaW5lZFtuYW1lXTsKICAgICAgICAgICAgaWYgKHR5cGVvZiBlICE9PSAndW5kZWZpbmVkJykgewogICAgICAgICAgICAgICAgcmV0dXJuIGU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gKGRlZmluZWRbbmFtZV0gPSB7fSk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIG1vZHVsZTogZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgIGlkOiBuYW1lLAogICAgICAgICAgICAgICAgdXJpOiAnJywKICAgICAgICAgICAgICAgIGV4cG9ydHM6IGRlZmluZWRbbmFtZV0sCiAgICAgICAgICAgICAgICBjb25maWc6IG1ha2VDb25maWcobmFtZSkKICAgICAgICAgICAgfTsKICAgICAgICB9CiAgICB9OwoKICAgIG1haW4gPSBmdW5jdGlvbiAobmFtZSwgZGVwcywgY2FsbGJhY2ssIHJlbE5hbWUpIHsKICAgICAgICB2YXIgY2pzTW9kdWxlLCBkZXBOYW1lLCByZXQsIG1hcCwgaSwKICAgICAgICAgICAgYXJncyA9IFtdLAogICAgICAgICAgICBjYWxsYmFja1R5cGUgPSB0eXBlb2YgY2FsbGJhY2ssCiAgICAgICAgICAgIHVzaW5nRXhwb3J0czsKCiAgICAgICAgLy9Vc2UgbmFtZSBpZiBubyByZWxOYW1lCiAgICAgICAgcmVsTmFtZSA9IHJlbE5hbWUgfHwgbmFtZTsKCiAgICAgICAgLy9DYWxsIHRoZSBjYWxsYmFjayB0byBkZWZpbmUgdGhlIG1vZHVsZSwgaWYgbmVjZXNzYXJ5LgogICAgICAgIGlmIChjYWxsYmFja1R5cGUgPT09ICd1bmRlZmluZWQnIHx8IGNhbGxiYWNrVHlwZSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICAvL1B1bGwgb3V0IHRoZSBkZWZpbmVkIGRlcGVuZGVuY2llcyBhbmQgcGFzcyB0aGUgb3JkZXJlZAogICAgICAgICAgICAvL3ZhbHVlcyB0byB0aGUgY2FsbGJhY2suCiAgICAgICAgICAgIC8vRGVmYXVsdCB0byBbcmVxdWlyZSwgZXhwb3J0cywgbW9kdWxlXSBpZiBubyBkZXBzCiAgICAgICAgICAgIGRlcHMgPSAhZGVwcy5sZW5ndGggJiYgY2FsbGJhY2subGVuZ3RoID8gWydyZXF1aXJlJywgJ2V4cG9ydHMnLCAnbW9kdWxlJ10gOiBkZXBzOwogICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgZGVwcy5sZW5ndGg7IGkgKz0gMSkgewogICAgICAgICAgICAgICAgbWFwID0gbWFrZU1hcChkZXBzW2ldLCByZWxOYW1lKTsKICAgICAgICAgICAgICAgIGRlcE5hbWUgPSBtYXAuZjsKCiAgICAgICAgICAgICAgICAvL0Zhc3QgcGF0aCBDb21tb25KUyBzdGFuZGFyZCBkZXBlbmRlbmNpZXMuCiAgICAgICAgICAgICAgICBpZiAoZGVwTmFtZSA9PT0gInJlcXVpcmUiKSB7CiAgICAgICAgICAgICAgICAgICAgYXJnc1tpXSA9IGhhbmRsZXJzLnJlcXVpcmUobmFtZSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGRlcE5hbWUgPT09ICJleHBvcnRzIikgewogICAgICAgICAgICAgICAgICAgIC8vQ29tbW9uSlMgbW9kdWxlIHNwZWMgMS4xCiAgICAgICAgICAgICAgICAgICAgYXJnc1tpXSA9IGhhbmRsZXJzLmV4cG9ydHMobmFtZSk7CiAgICAgICAgICAgICAgICAgICAgdXNpbmdFeHBvcnRzID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoZGVwTmFtZSA9PT0gIm1vZHVsZSIpIHsKICAgICAgICAgICAgICAgICAgICAvL0NvbW1vbkpTIG1vZHVsZSBzcGVjIDEuMQogICAgICAgICAgICAgICAgICAgIGNqc01vZHVsZSA9IGFyZ3NbaV0gPSBoYW5kbGVycy5tb2R1bGUobmFtZSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGhhc1Byb3AoZGVmaW5lZCwgZGVwTmFtZSkgfHwKICAgICAgICAgICAgICAgICAgICAgICAgICAgaGFzUHJvcCh3YWl0aW5nLCBkZXBOYW1lKSB8fAogICAgICAgICAgICAgICAgICAgICAgICAgICBoYXNQcm9wKGRlZmluaW5nLCBkZXBOYW1lKSkgewogICAgICAgICAgICAgICAgICAgIGFyZ3NbaV0gPSBjYWxsRGVwKGRlcE5hbWUpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChtYXAucCkgewogICAgICAgICAgICAgICAgICAgIG1hcC5wLmxvYWQobWFwLm4sIG1ha2VSZXF1aXJlKHJlbE5hbWUsIHRydWUpLCBtYWtlTG9hZChkZXBOYW1lKSwge30pOwogICAgICAgICAgICAgICAgICAgIGFyZ3NbaV0gPSBkZWZpbmVkW2RlcE5hbWVdOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IobmFtZSArICcgbWlzc2luZyAnICsgZGVwTmFtZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldCA9IGNhbGxiYWNrID8gY2FsbGJhY2suYXBwbHkoZGVmaW5lZFtuYW1lXSwgYXJncykgOiB1bmRlZmluZWQ7CgogICAgICAgICAgICBpZiAobmFtZSkgewogICAgICAgICAgICAgICAgLy9JZiBzZXR0aW5nIGV4cG9ydHMgdmlhICJtb2R1bGUiIGlzIGluIHBsYXksCiAgICAgICAgICAgICAgICAvL2Zhdm9yIHRoYXQgb3ZlciByZXR1cm4gdmFsdWUgYW5kIGV4cG9ydHMuIEFmdGVyIHRoYXQsCiAgICAgICAgICAgICAgICAvL2Zhdm9yIGEgbm9uLXVuZGVmaW5lZCByZXR1cm4gdmFsdWUgb3ZlciBleHBvcnRzIHVzZS4KICAgICAgICAgICAgICAgIGlmIChjanNNb2R1bGUgJiYgY2pzTW9kdWxlLmV4cG9ydHMgIT09IHVuZGVmICYmCiAgICAgICAgICAgICAgICAgICAgICAgIGNqc01vZHVsZS5leHBvcnRzICE9PSBkZWZpbmVkW25hbWVdKSB7CiAgICAgICAgICAgICAgICAgICAgZGVmaW5lZFtuYW1lXSA9IGNqc01vZHVsZS5leHBvcnRzOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChyZXQgIT09IHVuZGVmIHx8ICF1c2luZ0V4cG9ydHMpIHsKICAgICAgICAgICAgICAgICAgICAvL1VzZSB0aGUgcmV0dXJuIHZhbHVlIGZyb20gdGhlIGZ1bmN0aW9uLgogICAgICAgICAgICAgICAgICAgIGRlZmluZWRbbmFtZV0gPSByZXQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKG5hbWUpIHsKICAgICAgICAgICAgLy9NYXkganVzdCBiZSBhbiBvYmplY3QgZGVmaW5pdGlvbiBmb3IgdGhlIG1vZHVsZS4gT25seQogICAgICAgICAgICAvL3dvcnJ5IGFib3V0IGRlZmluaW5nIGlmIGhhdmUgYSBtb2R1bGUgbmFtZS4KICAgICAgICAgICAgZGVmaW5lZFtuYW1lXSA9IGNhbGxiYWNrOwogICAgICAgIH0KICAgIH07CgogICAgcmVxdWlyZWpzID0gcmVxdWlyZSA9IHJlcSA9IGZ1bmN0aW9uIChkZXBzLCBjYWxsYmFjaywgcmVsTmFtZSwgZm9yY2VTeW5jLCBhbHQpIHsKICAgICAgICBpZiAodHlwZW9mIGRlcHMgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgIGlmIChoYW5kbGVyc1tkZXBzXSkgewogICAgICAgICAgICAgICAgLy9jYWxsYmFjayBpbiB0aGlzIGNhc2UgaXMgcmVhbGx5IHJlbE5hbWUKICAgICAgICAgICAgICAgIHJldHVybiBoYW5kbGVyc1tkZXBzXShjYWxsYmFjayk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy9KdXN0IHJldHVybiB0aGUgbW9kdWxlIHdhbnRlZC4gSW4gdGhpcyBzY2VuYXJpbywgdGhlCiAgICAgICAgICAgIC8vZGVwcyBhcmcgaXMgdGhlIG1vZHVsZSBuYW1lLCBhbmQgc2Vjb25kIGFyZyAoaWYgcGFzc2VkKQogICAgICAgICAgICAvL2lzIGp1c3QgdGhlIHJlbE5hbWUuCiAgICAgICAgICAgIC8vTm9ybWFsaXplIG1vZHVsZSBuYW1lLCBpZiBpdCBjb250YWlucyAuIG9yIC4uCiAgICAgICAgICAgIHJldHVybiBjYWxsRGVwKG1ha2VNYXAoZGVwcywgY2FsbGJhY2spLmYpOwogICAgICAgIH0gZWxzZSBpZiAoIWRlcHMuc3BsaWNlKSB7CiAgICAgICAgICAgIC8vZGVwcyBpcyBhIGNvbmZpZyBvYmplY3QsIG5vdCBhbiBhcnJheS4KICAgICAgICAgICAgY29uZmlnID0gZGVwczsKICAgICAgICAgICAgaWYgKGNvbmZpZy5kZXBzKSB7CiAgICAgICAgICAgICAgICByZXEoY29uZmlnLmRlcHMsIGNvbmZpZy5jYWxsYmFjayk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCFjYWxsYmFjaykgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoY2FsbGJhY2suc3BsaWNlKSB7CiAgICAgICAgICAgICAgICAvL2NhbGxiYWNrIGlzIGFuIGFycmF5LCB3aGljaCBtZWFucyBpdCBpcyBhIGRlcGVuZGVuY3kgbGlzdC4KICAgICAgICAgICAgICAgIC8vQWRqdXN0IGFyZ3MgaWYgdGhlcmUgYXJlIGRlcGVuZGVuY2llcwogICAgICAgICAgICAgICAgZGVwcyA9IGNhbGxiYWNrOwogICAgICAgICAgICAgICAgY2FsbGJhY2sgPSByZWxOYW1lOwogICAgICAgICAgICAgICAgcmVsTmFtZSA9IG51bGw7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBkZXBzID0gdW5kZWY7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vU3VwcG9ydCByZXF1aXJlKFsnYSddKQogICAgICAgIGNhbGxiYWNrID0gY2FsbGJhY2sgfHwgZnVuY3Rpb24gKCkge307CgogICAgICAgIC8vSWYgcmVsTmFtZSBpcyBhIGZ1bmN0aW9uLCBpdCBpcyBhbiBlcnJiYWNrIGhhbmRsZXIsCiAgICAgICAgLy9zbyByZW1vdmUgaXQuCiAgICAgICAgaWYgKHR5cGVvZiByZWxOYW1lID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgIHJlbE5hbWUgPSBmb3JjZVN5bmM7CiAgICAgICAgICAgIGZvcmNlU3luYyA9IGFsdDsKICAgICAgICB9CgogICAgICAgIC8vU2ltdWxhdGUgYXN5bmMgY2FsbGJhY2s7CiAgICAgICAgaWYgKGZvcmNlU3luYykgewogICAgICAgICAgICBtYWluKHVuZGVmLCBkZXBzLCBjYWxsYmFjaywgcmVsTmFtZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgLy9Vc2luZyBhIG5vbi16ZXJvIHZhbHVlIGJlY2F1c2Ugb2YgY29uY2VybiBmb3Igd2hhdCBvbGQgYnJvd3NlcnMKICAgICAgICAgICAgLy9kbywgYW5kIGxhdGVzdCBicm93c2VycyAidXBncmFkZSIgdG8gNCBpZiBsb3dlciB2YWx1ZSBpcyB1c2VkOgogICAgICAgICAgICAvL2h0dHA6Ly93d3cud2hhdHdnLm9yZy9zcGVjcy93ZWItYXBwcy9jdXJyZW50LXdvcmsvbXVsdGlwYWdlL3RpbWVycy5odG1sI2RvbS13aW5kb3d0aW1lcnMtc2V0dGltZW91dDoKICAgICAgICAgICAgLy9JZiB3YW50IGEgdmFsdWUgaW1tZWRpYXRlbHksIHVzZSByZXF1aXJlKCdpZCcpIGluc3RlYWQgLS0gc29tZXRoaW5nCiAgICAgICAgICAgIC8vdGhhdCB3b3JrcyBpbiBhbG1vbmQgb24gdGhlIGdsb2JhbCBsZXZlbCwgYnV0IG5vdCBndWFyYW50ZWVkIGFuZAogICAgICAgICAgICAvL3VubGlrZWx5IHRvIHdvcmsgaW4gb3RoZXIgQU1EIGltcGxlbWVudGF0aW9ucy4KICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICBtYWluKHVuZGVmLCBkZXBzLCBjYWxsYmFjaywgcmVsTmFtZSk7CiAgICAgICAgICAgIH0sIDQpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHJlcTsKICAgIH07CgogICAgLyoqCiAgICAgKiBKdXN0IGRyb3BzIHRoZSBjb25maWcgb24gdGhlIGZsb29yLCBidXQgcmV0dXJucyByZXEgaW4gY2FzZQogICAgICogdGhlIGNvbmZpZyByZXR1cm4gdmFsdWUgaXMgdXNlZC4KICAgICAqLwogICAgcmVxLmNvbmZpZyA9IGZ1bmN0aW9uIChjZmcpIHsKICAgICAgICByZXR1cm4gcmVxKGNmZyk7CiAgICB9OwoKICAgIC8qKgogICAgICogRXhwb3NlIG1vZHVsZSByZWdpc3RyeSBmb3IgZGVidWdnaW5nIGFuZCB0b29saW5nCiAgICAgKi8KICAgIHJlcXVpcmVqcy5fZGVmaW5lZCA9IGRlZmluZWQ7CgogICAgZGVmaW5lID0gZnVuY3Rpb24gKG5hbWUsIGRlcHMsIGNhbGxiYWNrKSB7CgogICAgICAgIC8vVGhpcyBtb2R1bGUgbWF5IG5vdCBoYXZlIGRlcGVuZGVuY2llcwogICAgICAgIGlmICghZGVwcy5zcGxpY2UpIHsKICAgICAgICAgICAgLy9kZXBzIGlzIG5vdCBhbiBhcnJheSwgc28gcHJvYmFibHkgbWVhbnMKICAgICAgICAgICAgLy9hbiBvYmplY3QgbGl0ZXJhbCBvciBmYWN0b3J5IGZ1bmN0aW9uIGZvcgogICAgICAgICAgICAvL3RoZSB2YWx1ZS4gQWRqdXN0IGFyZ3MuCiAgICAgICAgICAgIGNhbGxiYWNrID0gZGVwczsKICAgICAgICAgICAgZGVwcyA9IFtdOwogICAgICAgIH0KCiAgICAgICAgaWYgKCFoYXNQcm9wKGRlZmluZWQsIG5hbWUpICYmICFoYXNQcm9wKHdhaXRpbmcsIG5hbWUpKSB7CiAgICAgICAgICAgIHdhaXRpbmdbbmFtZV0gPSBbbmFtZSwgZGVwcywgY2FsbGJhY2tdOwogICAgICAgIH0KICAgIH07CgogICAgZGVmaW5lLmFtZCA9IHsKICAgICAgICBqUXVlcnk6IHRydWUKICAgIH07Cn0oKSk7CgpkZWZpbmUoImFsbW9uZCIsIGZ1bmN0aW9uKCl7fSk7CgovLyAgICAgVW5kZXJzY29yZS5qcyAxLjQuNAovLyAgICAgaHR0cDovL3VuZGVyc2NvcmVqcy5vcmcKLy8gICAgIChjKSAyMDA5LTIwMTMgSmVyZW15IEFzaGtlbmFzLCBEb2N1bWVudENsb3VkIEluYy4KLy8gICAgIFVuZGVyc2NvcmUgbWF5IGJlIGZyZWVseSBkaXN0cmlidXRlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuCgooZnVuY3Rpb24oKSB7CgogIC8vIEJhc2VsaW5lIHNldHVwCiAgLy8gLS0tLS0tLS0tLS0tLS0KCiAgLy8gRXN0YWJsaXNoIHRoZSByb290IG9iamVjdCwgYHdpbmRvd2AgaW4gdGhlIGJyb3dzZXIsIG9yIGBnbG9iYWxgIG9uIHRoZSBzZXJ2ZXIuCiAgdmFyIHJvb3QgPSB0aGlzOwoKICAvLyBTYXZlIHRoZSBwcmV2aW91cyB2YWx1ZSBvZiB0aGUgYF9gIHZhcmlhYmxlLgogIHZhciBwcmV2aW91c1VuZGVyc2NvcmUgPSByb290Ll87CgogIC8vIEVzdGFibGlzaCB0aGUgb2JqZWN0IHRoYXQgZ2V0cyByZXR1cm5lZCB0byBicmVhayBvdXQgb2YgYSBsb29wIGl0ZXJhdGlvbi4KICB2YXIgYnJlYWtlciA9IHt9OwoKICAvLyBTYXZlIGJ5dGVzIGluIHRoZSBtaW5pZmllZCAoYnV0IG5vdCBnemlwcGVkKSB2ZXJzaW9uOgogIHZhciBBcnJheVByb3RvID0gQXJyYXkucHJvdG90eXBlLCBPYmpQcm90byA9IE9iamVjdC5wcm90b3R5cGUsIEZ1bmNQcm90byA9IEZ1bmN0aW9uLnByb3RvdHlwZTsKCiAgLy8gQ3JlYXRlIHF1aWNrIHJlZmVyZW5jZSB2YXJpYWJsZXMgZm9yIHNwZWVkIGFjY2VzcyB0byBjb3JlIHByb3RvdHlwZXMuCiAgdmFyIHB1c2ggICAgICAgICAgICAgPSBBcnJheVByb3RvLnB1c2gsCiAgICAgIHNsaWNlICAgICAgICAgICAgPSBBcnJheVByb3RvLnNsaWNlLAogICAgICBjb25jYXQgICAgICAgICAgID0gQXJyYXlQcm90by5jb25jYXQsCiAgICAgIHRvU3RyaW5nICAgICAgICAgPSBPYmpQcm90by50b1N0cmluZywKICAgICAgaGFzT3duUHJvcGVydHkgICA9IE9ialByb3RvLmhhc093blByb3BlcnR5OwoKICAvLyBBbGwgKipFQ01BU2NyaXB0IDUqKiBuYXRpdmUgZnVuY3Rpb24gaW1wbGVtZW50YXRpb25zIHRoYXQgd2UgaG9wZSB0byB1c2UKICAvLyBhcmUgZGVjbGFyZWQgaGVyZS4KICB2YXIKICAgIG5hdGl2ZUZvckVhY2ggICAgICA9IEFycmF5UHJvdG8uZm9yRWFjaCwKICAgIG5hdGl2ZU1hcCAgICAgICAgICA9IEFycmF5UHJvdG8ubWFwLAogICAgbmF0aXZlUmVkdWNlICAgICAgID0gQXJyYXlQcm90by5yZWR1Y2UsCiAgICBuYXRpdmVSZWR1Y2VSaWdodCAgPSBBcnJheVByb3RvLnJlZHVjZVJpZ2h0LAogICAgbmF0aXZlRmlsdGVyICAgICAgID0gQXJyYXlQcm90by5maWx0ZXIsCiAgICBuYXRpdmVFdmVyeSAgICAgICAgPSBBcnJheVByb3RvLmV2ZXJ5LAogICAgbmF0aXZlU29tZSAgICAgICAgID0gQXJyYXlQcm90by5zb21lLAogICAgbmF0aXZlSW5kZXhPZiAgICAgID0gQXJyYXlQcm90by5pbmRleE9mLAogICAgbmF0aXZlTGFzdEluZGV4T2YgID0gQXJyYXlQcm90by5sYXN0SW5kZXhPZiwKICAgIG5hdGl2ZUlzQXJyYXkgICAgICA9IEFycmF5LmlzQXJyYXksCiAgICBuYXRpdmVLZXlzICAgICAgICAgPSBPYmplY3Qua2V5cywKICAgIG5hdGl2ZUJpbmQgICAgICAgICA9IEZ1bmNQcm90by5iaW5kOwoKICAvLyBDcmVhdGUgYSBzYWZlIHJlZmVyZW5jZSB0byB0aGUgVW5kZXJzY29yZSBvYmplY3QgZm9yIHVzZSBiZWxvdy4KICB2YXIgXyA9IGZ1bmN0aW9uKG9iaikgewogICAgaWYgKG9iaiBpbnN0YW5jZW9mIF8pIHJldHVybiBvYmo7CiAgICBpZiAoISh0aGlzIGluc3RhbmNlb2YgXykpIHJldHVybiBuZXcgXyhvYmopOwogICAgdGhpcy5fd3JhcHBlZCA9IG9iajsKICB9OwoKICAvLyBFeHBvcnQgdGhlIFVuZGVyc2NvcmUgb2JqZWN0IGZvciAqKk5vZGUuanMqKiwgd2l0aAogIC8vIGJhY2t3YXJkcy1jb21wYXRpYmlsaXR5IGZvciB0aGUgb2xkIGByZXF1aXJlKClgIEFQSS4gSWYgd2UncmUgaW4KICAvLyB0aGUgYnJvd3NlciwgYWRkIGBfYCBhcyBhIGdsb2JhbCBvYmplY3QgdmlhIGEgc3RyaW5nIGlkZW50aWZpZXIsCiAgLy8gZm9yIENsb3N1cmUgQ29tcGlsZXIgImFkdmFuY2VkIiBtb2RlLgogIGlmICh0eXBlb2YgZXhwb3J0cyAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgIGlmICh0eXBlb2YgbW9kdWxlICE9PSAndW5kZWZpbmVkJyAmJiBtb2R1bGUuZXhwb3J0cykgewogICAgICBleHBvcnRzID0gbW9kdWxlLmV4cG9ydHMgPSBfOwogICAgfQogICAgZXhwb3J0cy5fID0gXzsKICB9IGVsc2UgewogICAgcm9vdC5fID0gXzsKICB9CgogIC8vIEN1cnJlbnQgdmVyc2lvbi4KICBfLlZFUlNJT04gPSAnMS40LjQnOwoKICAvLyBDb2xsZWN0aW9uIEZ1bmN0aW9ucwogIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tCgogIC8vIFRoZSBjb3JuZXJzdG9uZSwgYW4gYGVhY2hgIGltcGxlbWVudGF0aW9uLCBha2EgYGZvckVhY2hgLgogIC8vIEhhbmRsZXMgb2JqZWN0cyB3aXRoIHRoZSBidWlsdC1pbiBgZm9yRWFjaGAsIGFycmF5cywgYW5kIHJhdyBvYmplY3RzLgogIC8vIERlbGVnYXRlcyB0byAqKkVDTUFTY3JpcHQgNSoqJ3MgbmF0aXZlIGBmb3JFYWNoYCBpZiBhdmFpbGFibGUuCiAgdmFyIGVhY2ggPSBfLmVhY2ggPSBfLmZvckVhY2ggPSBmdW5jdGlvbihvYmosIGl0ZXJhdG9yLCBjb250ZXh0KSB7CiAgICBpZiAob2JqID09IG51bGwpIHJldHVybjsKICAgIGlmIChuYXRpdmVGb3JFYWNoICYmIG9iai5mb3JFYWNoID09PSBuYXRpdmVGb3JFYWNoKSB7CiAgICAgIG9iai5mb3JFYWNoKGl0ZXJhdG9yLCBjb250ZXh0KTsKICAgIH0gZWxzZSBpZiAob2JqLmxlbmd0aCA9PT0gK29iai5sZW5ndGgpIHsKICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSBvYmoubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgaWYgKGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgb2JqW2ldLCBpLCBvYmopID09PSBicmVha2VyKSByZXR1cm47CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGZvciAodmFyIGtleSBpbiBvYmopIHsKICAgICAgICBpZiAoXy5oYXMob2JqLCBrZXkpKSB7CiAgICAgICAgICBpZiAoaXRlcmF0b3IuY2FsbChjb250ZXh0LCBvYmpba2V5XSwga2V5LCBvYmopID09PSBicmVha2VyKSByZXR1cm47CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfTsKCiAgLy8gUmV0dXJuIHRoZSByZXN1bHRzIG9mIGFwcGx5aW5nIHRoZSBpdGVyYXRvciB0byBlYWNoIGVsZW1lbnQuCiAgLy8gRGVsZWdhdGVzIHRvICoqRUNNQVNjcmlwdCA1KioncyBuYXRpdmUgYG1hcGAgaWYgYXZhaWxhYmxlLgogIF8ubWFwID0gXy5jb2xsZWN0ID0gZnVuY3Rpb24ob2JqLCBpdGVyYXRvciwgY29udGV4dCkgewogICAgdmFyIHJlc3VsdHMgPSBbXTsKICAgIGlmIChvYmogPT0gbnVsbCkgcmV0dXJuIHJlc3VsdHM7CiAgICBpZiAobmF0aXZlTWFwICYmIG9iai5tYXAgPT09IG5hdGl2ZU1hcCkgcmV0dXJuIG9iai5tYXAoaXRlcmF0b3IsIGNvbnRleHQpOwogICAgZWFjaChvYmosIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgbGlzdCkgewogICAgICByZXN1bHRzW3Jlc3VsdHMubGVuZ3RoXSA9IGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgdmFsdWUsIGluZGV4LCBsaXN0KTsKICAgIH0pOwogICAgcmV0dXJuIHJlc3VsdHM7CiAgfTsKCiAgdmFyIHJlZHVjZUVycm9yID0gJ1JlZHVjZSBvZiBlbXB0eSBhcnJheSB3aXRoIG5vIGluaXRpYWwgdmFsdWUnOwoKICAvLyAqKlJlZHVjZSoqIGJ1aWxkcyB1cCBhIHNpbmdsZSByZXN1bHQgZnJvbSBhIGxpc3Qgb2YgdmFsdWVzLCBha2EgYGluamVjdGAsCiAgLy8gb3IgYGZvbGRsYC4gRGVsZWdhdGVzIHRvICoqRUNNQVNjcmlwdCA1KioncyBuYXRpdmUgYHJlZHVjZWAgaWYgYXZhaWxhYmxlLgogIF8ucmVkdWNlID0gXy5mb2xkbCA9IF8uaW5qZWN0ID0gZnVuY3Rpb24ob2JqLCBpdGVyYXRvciwgbWVtbywgY29udGV4dCkgewogICAgdmFyIGluaXRpYWwgPSBhcmd1bWVudHMubGVuZ3RoID4gMjsKICAgIGlmIChvYmogPT0gbnVsbCkgb2JqID0gW107CiAgICBpZiAobmF0aXZlUmVkdWNlICYmIG9iai5yZWR1Y2UgPT09IG5hdGl2ZVJlZHVjZSkgewogICAgICBpZiAoY29udGV4dCkgaXRlcmF0b3IgPSBfLmJpbmQoaXRlcmF0b3IsIGNvbnRleHQpOwogICAgICByZXR1cm4gaW5pdGlhbCA/IG9iai5yZWR1Y2UoaXRlcmF0b3IsIG1lbW8pIDogb2JqLnJlZHVjZShpdGVyYXRvcik7CiAgICB9CiAgICBlYWNoKG9iaiwgZnVuY3Rpb24odmFsdWUsIGluZGV4LCBsaXN0KSB7CiAgICAgIGlmICghaW5pdGlhbCkgewogICAgICAgIG1lbW8gPSB2YWx1ZTsKICAgICAgICBpbml0aWFsID0gdHJ1ZTsKICAgICAgfSBlbHNlIHsKICAgICAgICBtZW1vID0gaXRlcmF0b3IuY2FsbChjb250ZXh0LCBtZW1vLCB2YWx1ZSwgaW5kZXgsIGxpc3QpOwogICAgICB9CiAgICB9KTsKICAgIGlmICghaW5pdGlhbCkgdGhyb3cgbmV3IFR5cGVFcnJvcihyZWR1Y2VFcnJvcik7CiAgICByZXR1cm4gbWVtbzsKICB9OwoKICAvLyBUaGUgcmlnaHQtYXNzb2NpYXRpdmUgdmVyc2lvbiBvZiByZWR1Y2UsIGFsc28ga25vd24gYXMgYGZvbGRyYC4KICAvLyBEZWxlZ2F0ZXMgdG8gKipFQ01BU2NyaXB0IDUqKidzIG5hdGl2ZSBgcmVkdWNlUmlnaHRgIGlmIGF2YWlsYWJsZS4KICBfLnJlZHVjZVJpZ2h0ID0gXy5mb2xkciA9IGZ1bmN0aW9uKG9iaiwgaXRlcmF0b3IsIG1lbW8sIGNvbnRleHQpIHsKICAgIHZhciBpbml0aWFsID0gYXJndW1lbnRzLmxlbmd0aCA+IDI7CiAgICBpZiAob2JqID09IG51bGwpIG9iaiA9IFtdOwogICAgaWYgKG5hdGl2ZVJlZHVjZVJpZ2h0ICYmIG9iai5yZWR1Y2VSaWdodCA9PT0gbmF0aXZlUmVkdWNlUmlnaHQpIHsKICAgICAgaWYgKGNvbnRleHQpIGl0ZXJhdG9yID0gXy5iaW5kKGl0ZXJhdG9yLCBjb250ZXh0KTsKICAgICAgcmV0dXJuIGluaXRpYWwgPyBvYmoucmVkdWNlUmlnaHQoaXRlcmF0b3IsIG1lbW8pIDogb2JqLnJlZHVjZVJpZ2h0KGl0ZXJhdG9yKTsKICAgIH0KICAgIHZhciBsZW5ndGggPSBvYmoubGVuZ3RoOwogICAgaWYgKGxlbmd0aCAhPT0gK2xlbmd0aCkgewogICAgICB2YXIga2V5cyA9IF8ua2V5cyhvYmopOwogICAgICBsZW5ndGggPSBrZXlzLmxlbmd0aDsKICAgIH0KICAgIGVhY2gob2JqLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGxpc3QpIHsKICAgICAgaW5kZXggPSBrZXlzID8ga2V5c1stLWxlbmd0aF0gOiAtLWxlbmd0aDsKICAgICAgaWYgKCFpbml0aWFsKSB7CiAgICAgICAgbWVtbyA9IG9ialtpbmRleF07CiAgICAgICAgaW5pdGlhbCA9IHRydWU7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgbWVtbyA9IGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgbWVtbywgb2JqW2luZGV4XSwgaW5kZXgsIGxpc3QpOwogICAgICB9CiAgICB9KTsKICAgIGlmICghaW5pdGlhbCkgdGhyb3cgbmV3IFR5cGVFcnJvcihyZWR1Y2VFcnJvcik7CiAgICByZXR1cm4gbWVtbzsKICB9OwoKICAvLyBSZXR1cm4gdGhlIGZpcnN0IHZhbHVlIHdoaWNoIHBhc3NlcyBhIHRydXRoIHRlc3QuIEFsaWFzZWQgYXMgYGRldGVjdGAuCiAgXy5maW5kID0gXy5kZXRlY3QgPSBmdW5jdGlvbihvYmosIGl0ZXJhdG9yLCBjb250ZXh0KSB7CiAgICB2YXIgcmVzdWx0OwogICAgYW55KG9iaiwgZnVuY3Rpb24odmFsdWUsIGluZGV4LCBsaXN0KSB7CiAgICAgIGlmIChpdGVyYXRvci5jYWxsKGNvbnRleHQsIHZhbHVlLCBpbmRleCwgbGlzdCkpIHsKICAgICAgICByZXN1bHQgPSB2YWx1ZTsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgfSk7CiAgICByZXR1cm4gcmVzdWx0OwogIH07CgogIC8vIFJldHVybiBhbGwgdGhlIGVsZW1lbnRzIHRoYXQgcGFzcyBhIHRydXRoIHRlc3QuCiAgLy8gRGVsZWdhdGVzIHRvICoqRUNNQVNjcmlwdCA1KioncyBuYXRpdmUgYGZpbHRlcmAgaWYgYXZhaWxhYmxlLgogIC8vIEFsaWFzZWQgYXMgYHNlbGVjdGAuCiAgXy5maWx0ZXIgPSBfLnNlbGVjdCA9IGZ1bmN0aW9uKG9iaiwgaXRlcmF0b3IsIGNvbnRleHQpIHsKICAgIHZhciByZXN1bHRzID0gW107CiAgICBpZiAob2JqID09IG51bGwpIHJldHVybiByZXN1bHRzOwogICAgaWYgKG5hdGl2ZUZpbHRlciAmJiBvYmouZmlsdGVyID09PSBuYXRpdmVGaWx0ZXIpIHJldHVybiBvYmouZmlsdGVyKGl0ZXJhdG9yLCBjb250ZXh0KTsKICAgIGVhY2gob2JqLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGxpc3QpIHsKICAgICAgaWYgKGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgdmFsdWUsIGluZGV4LCBsaXN0KSkgcmVzdWx0c1tyZXN1bHRzLmxlbmd0aF0gPSB2YWx1ZTsKICAgIH0pOwogICAgcmV0dXJuIHJlc3VsdHM7CiAgfTsKCiAgLy8gUmV0dXJuIGFsbCB0aGUgZWxlbWVudHMgZm9yIHdoaWNoIGEgdHJ1dGggdGVzdCBmYWlscy4KICBfLnJlamVjdCA9IGZ1bmN0aW9uKG9iaiwgaXRlcmF0b3IsIGNvbnRleHQpIHsKICAgIHJldHVybiBfLmZpbHRlcihvYmosIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgbGlzdCkgewogICAgICByZXR1cm4gIWl0ZXJhdG9yLmNhbGwoY29udGV4dCwgdmFsdWUsIGluZGV4LCBsaXN0KTsKICAgIH0sIGNvbnRleHQpOwogIH07CgogIC8vIERldGVybWluZSB3aGV0aGVyIGFsbCBvZiB0aGUgZWxlbWVudHMgbWF0Y2ggYSB0cnV0aCB0ZXN0LgogIC8vIERlbGVnYXRlcyB0byAqKkVDTUFTY3JpcHQgNSoqJ3MgbmF0aXZlIGBldmVyeWAgaWYgYXZhaWxhYmxlLgogIC8vIEFsaWFzZWQgYXMgYGFsbGAuCiAgXy5ldmVyeSA9IF8uYWxsID0gZnVuY3Rpb24ob2JqLCBpdGVyYXRvciwgY29udGV4dCkgewogICAgaXRlcmF0b3IgfHwgKGl0ZXJhdG9yID0gXy5pZGVudGl0eSk7CiAgICB2YXIgcmVzdWx0ID0gdHJ1ZTsKICAgIGlmIChvYmogPT0gbnVsbCkgcmV0dXJuIHJlc3VsdDsKICAgIGlmIChuYXRpdmVFdmVyeSAmJiBvYmouZXZlcnkgPT09IG5hdGl2ZUV2ZXJ5KSByZXR1cm4gb2JqLmV2ZXJ5KGl0ZXJhdG9yLCBjb250ZXh0KTsKICAgIGVhY2gob2JqLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGxpc3QpIHsKICAgICAgaWYgKCEocmVzdWx0ID0gcmVzdWx0ICYmIGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgdmFsdWUsIGluZGV4LCBsaXN0KSkpIHJldHVybiBicmVha2VyOwogICAgfSk7CiAgICByZXR1cm4gISFyZXN1bHQ7CiAgfTsKCiAgLy8gRGV0ZXJtaW5lIGlmIGF0IGxlYXN0IG9uZSBlbGVtZW50IGluIHRoZSBvYmplY3QgbWF0Y2hlcyBhIHRydXRoIHRlc3QuCiAgLy8gRGVsZWdhdGVzIHRvICoqRUNNQVNjcmlwdCA1KioncyBuYXRpdmUgYHNvbWVgIGlmIGF2YWlsYWJsZS4KICAvLyBBbGlhc2VkIGFzIGBhbnlgLgogIHZhciBhbnkgPSBfLnNvbWUgPSBfLmFueSA9IGZ1bmN0aW9uKG9iaiwgaXRlcmF0b3IsIGNvbnRleHQpIHsKICAgIGl0ZXJhdG9yIHx8IChpdGVyYXRvciA9IF8uaWRlbnRpdHkpOwogICAgdmFyIHJlc3VsdCA9IGZhbHNlOwogICAgaWYgKG9iaiA9PSBudWxsKSByZXR1cm4gcmVzdWx0OwogICAgaWYgKG5hdGl2ZVNvbWUgJiYgb2JqLnNvbWUgPT09IG5hdGl2ZVNvbWUpIHJldHVybiBvYmouc29tZShpdGVyYXRvciwgY29udGV4dCk7CiAgICBlYWNoKG9iaiwgZnVuY3Rpb24odmFsdWUsIGluZGV4LCBsaXN0KSB7CiAgICAgIGlmIChyZXN1bHQgfHwgKHJlc3VsdCA9IGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgdmFsdWUsIGluZGV4LCBsaXN0KSkpIHJldHVybiBicmVha2VyOwogICAgfSk7CiAgICByZXR1cm4gISFyZXN1bHQ7CiAgfTsKCiAgLy8gRGV0ZXJtaW5lIGlmIHRoZSBhcnJheSBvciBvYmplY3QgY29udGFpbnMgYSBnaXZlbiB2YWx1ZSAodXNpbmcgYD09PWApLgogIC8vIEFsaWFzZWQgYXMgYGluY2x1ZGVgLgogIF8uY29udGFpbnMgPSBfLmluY2x1ZGUgPSBmdW5jdGlvbihvYmosIHRhcmdldCkgewogICAgaWYgKG9iaiA9PSBudWxsKSByZXR1cm4gZmFsc2U7CiAgICBpZiAobmF0aXZlSW5kZXhPZiAmJiBvYmouaW5kZXhPZiA9PT0gbmF0aXZlSW5kZXhPZikgcmV0dXJuIG9iai5pbmRleE9mKHRhcmdldCkgIT0gLTE7CiAgICByZXR1cm4gYW55KG9iaiwgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgcmV0dXJuIHZhbHVlID09PSB0YXJnZXQ7CiAgICB9KTsKICB9OwoKICAvLyBJbnZva2UgYSBtZXRob2QgKHdpdGggYXJndW1lbnRzKSBvbiBldmVyeSBpdGVtIGluIGEgY29sbGVjdGlvbi4KICBfLmludm9rZSA9IGZ1bmN0aW9uKG9iaiwgbWV0aG9kKSB7CiAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAyKTsKICAgIHZhciBpc0Z1bmMgPSBfLmlzRnVuY3Rpb24obWV0aG9kKTsKICAgIHJldHVybiBfLm1hcChvYmosIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIHJldHVybiAoaXNGdW5jID8gbWV0aG9kIDogdmFsdWVbbWV0aG9kXSkuYXBwbHkodmFsdWUsIGFyZ3MpOwogICAgfSk7CiAgfTsKCiAgLy8gQ29udmVuaWVuY2UgdmVyc2lvbiBvZiBhIGNvbW1vbiB1c2UgY2FzZSBvZiBgbWFwYDogZmV0Y2hpbmcgYSBwcm9wZXJ0eS4KICBfLnBsdWNrID0gZnVuY3Rpb24ob2JqLCBrZXkpIHsKICAgIHJldHVybiBfLm1hcChvYmosIGZ1bmN0aW9uKHZhbHVlKXsgcmV0dXJuIHZhbHVlW2tleV07IH0pOwogIH07CgogIC8vIENvbnZlbmllbmNlIHZlcnNpb24gb2YgYSBjb21tb24gdXNlIGNhc2Ugb2YgYGZpbHRlcmA6IHNlbGVjdGluZyBvbmx5IG9iamVjdHMKICAvLyBjb250YWluaW5nIHNwZWNpZmljIGBrZXk6dmFsdWVgIHBhaXJzLgogIF8ud2hlcmUgPSBmdW5jdGlvbihvYmosIGF0dHJzLCBmaXJzdCkgewogICAgaWYgKF8uaXNFbXB0eShhdHRycykpIHJldHVybiBmaXJzdCA/IG51bGwgOiBbXTsKICAgIHJldHVybiBfW2ZpcnN0ID8gJ2ZpbmQnIDogJ2ZpbHRlciddKG9iaiwgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgZm9yICh2YXIga2V5IGluIGF0dHJzKSB7CiAgICAgICAgaWYgKGF0dHJzW2tleV0gIT09IHZhbHVlW2tleV0pIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0pOwogIH07CgogIC8vIENvbnZlbmllbmNlIHZlcnNpb24gb2YgYSBjb21tb24gdXNlIGNhc2Ugb2YgYGZpbmRgOiBnZXR0aW5nIHRoZSBmaXJzdCBvYmplY3QKICAvLyBjb250YWluaW5nIHNwZWNpZmljIGBrZXk6dmFsdWVgIHBhaXJzLgogIF8uZmluZFdoZXJlID0gZnVuY3Rpb24ob2JqLCBhdHRycykgewogICAgcmV0dXJuIF8ud2hlcmUob2JqLCBhdHRycywgdHJ1ZSk7CiAgfTsKCiAgLy8gUmV0dXJuIHRoZSBtYXhpbXVtIGVsZW1lbnQgb3IgKGVsZW1lbnQtYmFzZWQgY29tcHV0YXRpb24pLgogIC8vIENhbid0IG9wdGltaXplIGFycmF5cyBvZiBpbnRlZ2VycyBsb25nZXIgdGhhbiA2NSw1MzUgZWxlbWVudHMuCiAgLy8gU2VlOiBodHRwczovL2J1Z3Mud2Via2l0Lm9yZy9zaG93X2J1Zy5jZ2k/aWQ9ODA3OTcKICBfLm1heCA9IGZ1bmN0aW9uKG9iaiwgaXRlcmF0b3IsIGNvbnRleHQpIHsKICAgIGlmICghaXRlcmF0b3IgJiYgXy5pc0FycmF5KG9iaikgJiYgb2JqWzBdID09PSArb2JqWzBdICYmIG9iai5sZW5ndGggPCA2NTUzNSkgewogICAgICByZXR1cm4gTWF0aC5tYXguYXBwbHkoTWF0aCwgb2JqKTsKICAgIH0KICAgIGlmICghaXRlcmF0b3IgJiYgXy5pc0VtcHR5KG9iaikpIHJldHVybiAtSW5maW5pdHk7CiAgICB2YXIgcmVzdWx0ID0ge2NvbXB1dGVkIDogLUluZmluaXR5LCB2YWx1ZTogLUluZmluaXR5fTsKICAgIGVhY2gob2JqLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGxpc3QpIHsKICAgICAgdmFyIGNvbXB1dGVkID0gaXRlcmF0b3IgPyBpdGVyYXRvci5jYWxsKGNvbnRleHQsIHZhbHVlLCBpbmRleCwgbGlzdCkgOiB2YWx1ZTsKICAgICAgY29tcHV0ZWQgPj0gcmVzdWx0LmNvbXB1dGVkICYmIChyZXN1bHQgPSB7dmFsdWUgOiB2YWx1ZSwgY29tcHV0ZWQgOiBjb21wdXRlZH0pOwogICAgfSk7CiAgICByZXR1cm4gcmVzdWx0LnZhbHVlOwogIH07CgogIC8vIFJldHVybiB0aGUgbWluaW11bSBlbGVtZW50IChvciBlbGVtZW50LWJhc2VkIGNvbXB1dGF0aW9uKS4KICBfLm1pbiA9IGZ1bmN0aW9uKG9iaiwgaXRlcmF0b3IsIGNvbnRleHQpIHsKICAgIGlmICghaXRlcmF0b3IgJiYgXy5pc0FycmF5KG9iaikgJiYgb2JqWzBdID09PSArb2JqWzBdICYmIG9iai5sZW5ndGggPCA2NTUzNSkgewogICAgICByZXR1cm4gTWF0aC5taW4uYXBwbHkoTWF0aCwgb2JqKTsKICAgIH0KICAgIGlmICghaXRlcmF0b3IgJiYgXy5pc0VtcHR5KG9iaikpIHJldHVybiBJbmZpbml0eTsKICAgIHZhciByZXN1bHQgPSB7Y29tcHV0ZWQgOiBJbmZpbml0eSwgdmFsdWU6IEluZmluaXR5fTsKICAgIGVhY2gob2JqLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGxpc3QpIHsKICAgICAgdmFyIGNvbXB1dGVkID0gaXRlcmF0b3IgPyBpdGVyYXRvci5jYWxsKGNvbnRleHQsIHZhbHVlLCBpbmRleCwgbGlzdCkgOiB2YWx1ZTsKICAgICAgY29tcHV0ZWQgPCByZXN1bHQuY29tcHV0ZWQgJiYgKHJlc3VsdCA9IHt2YWx1ZSA6IHZhbHVlLCBjb21wdXRlZCA6IGNvbXB1dGVkfSk7CiAgICB9KTsKICAgIHJldHVybiByZXN1bHQudmFsdWU7CiAgfTsKCiAgLy8gU2h1ZmZsZSBhbiBhcnJheS4KICBfLnNodWZmbGUgPSBmdW5jdGlvbihvYmopIHsKICAgIHZhciByYW5kOwogICAgdmFyIGluZGV4ID0gMDsKICAgIHZhciBzaHVmZmxlZCA9IFtdOwogICAgZWFjaChvYmosIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIHJhbmQgPSBfLnJhbmRvbShpbmRleCsrKTsKICAgICAgc2h1ZmZsZWRbaW5kZXggLSAxXSA9IHNodWZmbGVkW3JhbmRdOwogICAgICBzaHVmZmxlZFtyYW5kXSA9IHZhbHVlOwogICAgfSk7CiAgICByZXR1cm4gc2h1ZmZsZWQ7CiAgfTsKCiAgLy8gQW4gaW50ZXJuYWwgZnVuY3Rpb24gdG8gZ2VuZXJhdGUgbG9va3VwIGl0ZXJhdG9ycy4KICB2YXIgbG9va3VwSXRlcmF0b3IgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgcmV0dXJuIF8uaXNGdW5jdGlvbih2YWx1ZSkgPyB2YWx1ZSA6IGZ1bmN0aW9uKG9iail7IHJldHVybiBvYmpbdmFsdWVdOyB9OwogIH07CgogIC8vIFNvcnQgdGhlIG9iamVjdCdzIHZhbHVlcyBieSBhIGNyaXRlcmlvbiBwcm9kdWNlZCBieSBhbiBpdGVyYXRvci4KICBfLnNvcnRCeSA9IGZ1bmN0aW9uKG9iaiwgdmFsdWUsIGNvbnRleHQpIHsKICAgIHZhciBpdGVyYXRvciA9IGxvb2t1cEl0ZXJhdG9yKHZhbHVlKTsKICAgIHJldHVybiBfLnBsdWNrKF8ubWFwKG9iaiwgZnVuY3Rpb24odmFsdWUsIGluZGV4LCBsaXN0KSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgdmFsdWUgOiB2YWx1ZSwKICAgICAgICBpbmRleCA6IGluZGV4LAogICAgICAgIGNyaXRlcmlhIDogaXRlcmF0b3IuY2FsbChjb250ZXh0LCB2YWx1ZSwgaW5kZXgsIGxpc3QpCiAgICAgIH07CiAgICB9KS5zb3J0KGZ1bmN0aW9uKGxlZnQsIHJpZ2h0KSB7CiAgICAgIHZhciBhID0gbGVmdC5jcml0ZXJpYTsKICAgICAgdmFyIGIgPSByaWdodC5jcml0ZXJpYTsKICAgICAgaWYgKGEgIT09IGIpIHsKICAgICAgICBpZiAoYSA+IGIgfHwgYSA9PT0gdm9pZCAwKSByZXR1cm4gMTsKICAgICAgICBpZiAoYSA8IGIgfHwgYiA9PT0gdm9pZCAwKSByZXR1cm4gLTE7CiAgICAgIH0KICAgICAgcmV0dXJuIGxlZnQuaW5kZXggPCByaWdodC5pbmRleCA/IC0xIDogMTsKICAgIH0pLCAndmFsdWUnKTsKICB9OwoKICAvLyBBbiBpbnRlcm5hbCBmdW5jdGlvbiB1c2VkIGZvciBhZ2dyZWdhdGUgImdyb3VwIGJ5IiBvcGVyYXRpb25zLgogIHZhciBncm91cCA9IGZ1bmN0aW9uKG9iaiwgdmFsdWUsIGNvbnRleHQsIGJlaGF2aW9yKSB7CiAgICB2YXIgcmVzdWx0ID0ge307CiAgICB2YXIgaXRlcmF0b3IgPSBsb29rdXBJdGVyYXRvcih2YWx1ZSB8fCBfLmlkZW50aXR5KTsKICAgIGVhY2gob2JqLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgpIHsKICAgICAgdmFyIGtleSA9IGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgdmFsdWUsIGluZGV4LCBvYmopOwogICAgICBiZWhhdmlvcihyZXN1bHQsIGtleSwgdmFsdWUpOwogICAgfSk7CiAgICByZXR1cm4gcmVzdWx0OwogIH07CgogIC8vIEdyb3VwcyB0aGUgb2JqZWN0J3MgdmFsdWVzIGJ5IGEgY3JpdGVyaW9uLiBQYXNzIGVpdGhlciBhIHN0cmluZyBhdHRyaWJ1dGUKICAvLyB0byBncm91cCBieSwgb3IgYSBmdW5jdGlvbiB0aGF0IHJldHVybnMgdGhlIGNyaXRlcmlvbi4KICBfLmdyb3VwQnkgPSBmdW5jdGlvbihvYmosIHZhbHVlLCBjb250ZXh0KSB7CiAgICByZXR1cm4gZ3JvdXAob2JqLCB2YWx1ZSwgY29udGV4dCwgZnVuY3Rpb24ocmVzdWx0LCBrZXksIHZhbHVlKSB7CiAgICAgIChfLmhhcyhyZXN1bHQsIGtleSkgPyByZXN1bHRba2V5XSA6IChyZXN1bHRba2V5XSA9IFtdKSkucHVzaCh2YWx1ZSk7CiAgICB9KTsKICB9OwoKICAvLyBDb3VudHMgaW5zdGFuY2VzIG9mIGFuIG9iamVjdCB0aGF0IGdyb3VwIGJ5IGEgY2VydGFpbiBjcml0ZXJpb24uIFBhc3MKICAvLyBlaXRoZXIgYSBzdHJpbmcgYXR0cmlidXRlIHRvIGNvdW50IGJ5LCBvciBhIGZ1bmN0aW9uIHRoYXQgcmV0dXJucyB0aGUKICAvLyBjcml0ZXJpb24uCiAgXy5jb3VudEJ5ID0gZnVuY3Rpb24ob2JqLCB2YWx1ZSwgY29udGV4dCkgewogICAgcmV0dXJuIGdyb3VwKG9iaiwgdmFsdWUsIGNvbnRleHQsIGZ1bmN0aW9uKHJlc3VsdCwga2V5KSB7CiAgICAgIGlmICghXy5oYXMocmVzdWx0LCBrZXkpKSByZXN1bHRba2V5XSA9IDA7CiAgICAgIHJlc3VsdFtrZXldKys7CiAgICB9KTsKICB9OwoKICAvLyBVc2UgYSBjb21wYXJhdG9yIGZ1bmN0aW9uIHRvIGZpZ3VyZSBvdXQgdGhlIHNtYWxsZXN0IGluZGV4IGF0IHdoaWNoCiAgLy8gYW4gb2JqZWN0IHNob3VsZCBiZSBpbnNlcnRlZCBzbyBhcyB0byBtYWludGFpbiBvcmRlci4gVXNlcyBiaW5hcnkgc2VhcmNoLgogIF8uc29ydGVkSW5kZXggPSBmdW5jdGlvbihhcnJheSwgb2JqLCBpdGVyYXRvciwgY29udGV4dCkgewogICAgaXRlcmF0b3IgPSBpdGVyYXRvciA9PSBudWxsID8gXy5pZGVudGl0eSA6IGxvb2t1cEl0ZXJhdG9yKGl0ZXJhdG9yKTsKICAgIHZhciB2YWx1ZSA9IGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgb2JqKTsKICAgIHZhciBsb3cgPSAwLCBoaWdoID0gYXJyYXkubGVuZ3RoOwogICAgd2hpbGUgKGxvdyA8IGhpZ2gpIHsKICAgICAgdmFyIG1pZCA9IChsb3cgKyBoaWdoKSA+Pj4gMTsKICAgICAgaXRlcmF0b3IuY2FsbChjb250ZXh0LCBhcnJheVttaWRdKSA8IHZhbHVlID8gbG93ID0gbWlkICsgMSA6IGhpZ2ggPSBtaWQ7CiAgICB9CiAgICByZXR1cm4gbG93OwogIH07CgogIC8vIFNhZmVseSBjb252ZXJ0IGFueXRoaW5nIGl0ZXJhYmxlIGludG8gYSByZWFsLCBsaXZlIGFycmF5LgogIF8udG9BcnJheSA9IGZ1bmN0aW9uKG9iaikgewogICAgaWYgKCFvYmopIHJldHVybiBbXTsKICAgIGlmIChfLmlzQXJyYXkob2JqKSkgcmV0dXJuIHNsaWNlLmNhbGwob2JqKTsKICAgIGlmIChvYmoubGVuZ3RoID09PSArb2JqLmxlbmd0aCkgcmV0dXJuIF8ubWFwKG9iaiwgXy5pZGVudGl0eSk7CiAgICByZXR1cm4gXy52YWx1ZXMob2JqKTsKICB9OwoKICAvLyBSZXR1cm4gdGhlIG51bWJlciBvZiBlbGVtZW50cyBpbiBhbiBvYmplY3QuCiAgXy5zaXplID0gZnVuY3Rpb24ob2JqKSB7CiAgICBpZiAob2JqID09IG51bGwpIHJldHVybiAwOwogICAgcmV0dXJuIChvYmoubGVuZ3RoID09PSArb2JqLmxlbmd0aCkgPyBvYmoubGVuZ3RoIDogXy5rZXlzKG9iaikubGVuZ3RoOwogIH07CgogIC8vIEFycmF5IEZ1bmN0aW9ucwogIC8vIC0tLS0tLS0tLS0tLS0tLQoKICAvLyBHZXQgdGhlIGZpcnN0IGVsZW1lbnQgb2YgYW4gYXJyYXkuIFBhc3NpbmcgKipuKiogd2lsbCByZXR1cm4gdGhlIGZpcnN0IE4KICAvLyB2YWx1ZXMgaW4gdGhlIGFycmF5LiBBbGlhc2VkIGFzIGBoZWFkYCBhbmQgYHRha2VgLiBUaGUgKipndWFyZCoqIGNoZWNrCiAgLy8gYWxsb3dzIGl0IHRvIHdvcmsgd2l0aCBgXy5tYXBgLgogIF8uZmlyc3QgPSBfLmhlYWQgPSBfLnRha2UgPSBmdW5jdGlvbihhcnJheSwgbiwgZ3VhcmQpIHsKICAgIGlmIChhcnJheSA9PSBudWxsKSByZXR1cm4gdm9pZCAwOwogICAgcmV0dXJuIChuICE9IG51bGwpICYmICFndWFyZCA/IHNsaWNlLmNhbGwoYXJyYXksIDAsIG4pIDogYXJyYXlbMF07CiAgfTsKCiAgLy8gUmV0dXJucyBldmVyeXRoaW5nIGJ1dCB0aGUgbGFzdCBlbnRyeSBvZiB0aGUgYXJyYXkuIEVzcGVjaWFsbHkgdXNlZnVsIG9uCiAgLy8gdGhlIGFyZ3VtZW50cyBvYmplY3QuIFBhc3NpbmcgKipuKiogd2lsbCByZXR1cm4gYWxsIHRoZSB2YWx1ZXMgaW4KICAvLyB0aGUgYXJyYXksIGV4Y2x1ZGluZyB0aGUgbGFzdCBOLiBUaGUgKipndWFyZCoqIGNoZWNrIGFsbG93cyBpdCB0byB3b3JrIHdpdGgKICAvLyBgXy5tYXBgLgogIF8uaW5pdGlhbCA9IGZ1bmN0aW9uKGFycmF5LCBuLCBndWFyZCkgewogICAgcmV0dXJuIHNsaWNlLmNhbGwoYXJyYXksIDAsIGFycmF5Lmxlbmd0aCAtICgobiA9PSBudWxsKSB8fCBndWFyZCA/IDEgOiBuKSk7CiAgfTsKCiAgLy8gR2V0IHRoZSBsYXN0IGVsZW1lbnQgb2YgYW4gYXJyYXkuIFBhc3NpbmcgKipuKiogd2lsbCByZXR1cm4gdGhlIGxhc3QgTgogIC8vIHZhbHVlcyBpbiB0aGUgYXJyYXkuIFRoZSAqKmd1YXJkKiogY2hlY2sgYWxsb3dzIGl0IHRvIHdvcmsgd2l0aCBgXy5tYXBgLgogIF8ubGFzdCA9IGZ1bmN0aW9uKGFycmF5LCBuLCBndWFyZCkgewogICAgaWYgKGFycmF5ID09IG51bGwpIHJldHVybiB2b2lkIDA7CiAgICBpZiAoKG4gIT0gbnVsbCkgJiYgIWd1YXJkKSB7CiAgICAgIHJldHVybiBzbGljZS5jYWxsKGFycmF5LCBNYXRoLm1heChhcnJheS5sZW5ndGggLSBuLCAwKSk7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gYXJyYXlbYXJyYXkubGVuZ3RoIC0gMV07CiAgICB9CiAgfTsKCiAgLy8gUmV0dXJucyBldmVyeXRoaW5nIGJ1dCB0aGUgZmlyc3QgZW50cnkgb2YgdGhlIGFycmF5LiBBbGlhc2VkIGFzIGB0YWlsYCBhbmQgYGRyb3BgLgogIC8vIEVzcGVjaWFsbHkgdXNlZnVsIG9uIHRoZSBhcmd1bWVudHMgb2JqZWN0LiBQYXNzaW5nIGFuICoqbioqIHdpbGwgcmV0dXJuCiAgLy8gdGhlIHJlc3QgTiB2YWx1ZXMgaW4gdGhlIGFycmF5LiBUaGUgKipndWFyZCoqCiAgLy8gY2hlY2sgYWxsb3dzIGl0IHRvIHdvcmsgd2l0aCBgXy5tYXBgLgogIF8ucmVzdCA9IF8udGFpbCA9IF8uZHJvcCA9IGZ1bmN0aW9uKGFycmF5LCBuLCBndWFyZCkgewogICAgcmV0dXJuIHNsaWNlLmNhbGwoYXJyYXksIChuID09IG51bGwpIHx8IGd1YXJkID8gMSA6IG4pOwogIH07CgogIC8vIFRyaW0gb3V0IGFsbCBmYWxzeSB2YWx1ZXMgZnJvbSBhbiBhcnJheS4KICBfLmNvbXBhY3QgPSBmdW5jdGlvbihhcnJheSkgewogICAgcmV0dXJuIF8uZmlsdGVyKGFycmF5LCBfLmlkZW50aXR5KTsKICB9OwoKICAvLyBJbnRlcm5hbCBpbXBsZW1lbnRhdGlvbiBvZiBhIHJlY3Vyc2l2ZSBgZmxhdHRlbmAgZnVuY3Rpb24uCiAgdmFyIGZsYXR0ZW4gPSBmdW5jdGlvbihpbnB1dCwgc2hhbGxvdywgb3V0cHV0KSB7CiAgICBlYWNoKGlucHV0LCBmdW5jdGlvbih2YWx1ZSkgewogICAgICBpZiAoXy5pc0FycmF5KHZhbHVlKSkgewogICAgICAgIHNoYWxsb3cgPyBwdXNoLmFwcGx5KG91dHB1dCwgdmFsdWUpIDogZmxhdHRlbih2YWx1ZSwgc2hhbGxvdywgb3V0cHV0KTsKICAgICAgfSBlbHNlIHsKICAgICAgICBvdXRwdXQucHVzaCh2YWx1ZSk7CiAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuIG91dHB1dDsKICB9OwoKICAvLyBSZXR1cm4gYSBjb21wbGV0ZWx5IGZsYXR0ZW5lZCB2ZXJzaW9uIG9mIGFuIGFycmF5LgogIF8uZmxhdHRlbiA9IGZ1bmN0aW9uKGFycmF5LCBzaGFsbG93KSB7CiAgICByZXR1cm4gZmxhdHRlbihhcnJheSwgc2hhbGxvdywgW10pOwogIH07CgogIC8vIFJldHVybiBhIHZlcnNpb24gb2YgdGhlIGFycmF5IHRoYXQgZG9lcyBub3QgY29udGFpbiB0aGUgc3BlY2lmaWVkIHZhbHVlKHMpLgogIF8ud2l0aG91dCA9IGZ1bmN0aW9uKGFycmF5KSB7CiAgICByZXR1cm4gXy5kaWZmZXJlbmNlKGFycmF5LCBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSkpOwogIH07CgogIC8vIFByb2R1Y2UgYSBkdXBsaWNhdGUtZnJlZSB2ZXJzaW9uIG9mIHRoZSBhcnJheS4gSWYgdGhlIGFycmF5IGhhcyBhbHJlYWR5CiAgLy8gYmVlbiBzb3J0ZWQsIHlvdSBoYXZlIHRoZSBvcHRpb24gb2YgdXNpbmcgYSBmYXN0ZXIgYWxnb3JpdGhtLgogIC8vIEFsaWFzZWQgYXMgYHVuaXF1ZWAuCiAgXy51bmlxID0gXy51bmlxdWUgPSBmdW5jdGlvbihhcnJheSwgaXNTb3J0ZWQsIGl0ZXJhdG9yLCBjb250ZXh0KSB7CiAgICBpZiAoXy5pc0Z1bmN0aW9uKGlzU29ydGVkKSkgewogICAgICBjb250ZXh0ID0gaXRlcmF0b3I7CiAgICAgIGl0ZXJhdG9yID0gaXNTb3J0ZWQ7CiAgICAgIGlzU29ydGVkID0gZmFsc2U7CiAgICB9CiAgICB2YXIgaW5pdGlhbCA9IGl0ZXJhdG9yID8gXy5tYXAoYXJyYXksIGl0ZXJhdG9yLCBjb250ZXh0KSA6IGFycmF5OwogICAgdmFyIHJlc3VsdHMgPSBbXTsKICAgIHZhciBzZWVuID0gW107CiAgICBlYWNoKGluaXRpYWwsIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCkgewogICAgICBpZiAoaXNTb3J0ZWQgPyAoIWluZGV4IHx8IHNlZW5bc2Vlbi5sZW5ndGggLSAxXSAhPT0gdmFsdWUpIDogIV8uY29udGFpbnMoc2VlbiwgdmFsdWUpKSB7CiAgICAgICAgc2Vlbi5wdXNoKHZhbHVlKTsKICAgICAgICByZXN1bHRzLnB1c2goYXJyYXlbaW5kZXhdKTsKICAgICAgfQogICAgfSk7CiAgICByZXR1cm4gcmVzdWx0czsKICB9OwoKICAvLyBQcm9kdWNlIGFuIGFycmF5IHRoYXQgY29udGFpbnMgdGhlIHVuaW9uOiBlYWNoIGRpc3RpbmN0IGVsZW1lbnQgZnJvbSBhbGwgb2YKICAvLyB0aGUgcGFzc2VkLWluIGFycmF5cy4KICBfLnVuaW9uID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gXy51bmlxKGNvbmNhdC5hcHBseShBcnJheVByb3RvLCBhcmd1bWVudHMpKTsKICB9OwoKICAvLyBQcm9kdWNlIGFuIGFycmF5IHRoYXQgY29udGFpbnMgZXZlcnkgaXRlbSBzaGFyZWQgYmV0d2VlbiBhbGwgdGhlCiAgLy8gcGFzc2VkLWluIGFycmF5cy4KICBfLmludGVyc2VjdGlvbiA9IGZ1bmN0aW9uKGFycmF5KSB7CiAgICB2YXIgcmVzdCA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKICAgIHJldHVybiBfLmZpbHRlcihfLnVuaXEoYXJyYXkpLCBmdW5jdGlvbihpdGVtKSB7CiAgICAgIHJldHVybiBfLmV2ZXJ5KHJlc3QsIGZ1bmN0aW9uKG90aGVyKSB7CiAgICAgICAgcmV0dXJuIF8uaW5kZXhPZihvdGhlciwgaXRlbSkgPj0gMDsKICAgICAgfSk7CiAgICB9KTsKICB9OwoKICAvLyBUYWtlIHRoZSBkaWZmZXJlbmNlIGJldHdlZW4gb25lIGFycmF5IGFuZCBhIG51bWJlciBvZiBvdGhlciBhcnJheXMuCiAgLy8gT25seSB0aGUgZWxlbWVudHMgcHJlc2VudCBpbiBqdXN0IHRoZSBmaXJzdCBhcnJheSB3aWxsIHJlbWFpbi4KICBfLmRpZmZlcmVuY2UgPSBmdW5jdGlvbihhcnJheSkgewogICAgdmFyIHJlc3QgPSBjb25jYXQuYXBwbHkoQXJyYXlQcm90bywgc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpKTsKICAgIHJldHVybiBfLmZpbHRlcihhcnJheSwgZnVuY3Rpb24odmFsdWUpeyByZXR1cm4gIV8uY29udGFpbnMocmVzdCwgdmFsdWUpOyB9KTsKICB9OwoKICAvLyBaaXAgdG9nZXRoZXIgbXVsdGlwbGUgbGlzdHMgaW50byBhIHNpbmdsZSBhcnJheSAtLSBlbGVtZW50cyB0aGF0IHNoYXJlCiAgLy8gYW4gaW5kZXggZ28gdG9nZXRoZXIuCiAgXy56aXAgPSBmdW5jdGlvbigpIHsKICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMpOwogICAgdmFyIGxlbmd0aCA9IF8ubWF4KF8ucGx1Y2soYXJncywgJ2xlbmd0aCcpKTsKICAgIHZhciByZXN1bHRzID0gbmV3IEFycmF5KGxlbmd0aCk7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgIHJlc3VsdHNbaV0gPSBfLnBsdWNrKGFyZ3MsICIiICsgaSk7CiAgICB9CiAgICByZXR1cm4gcmVzdWx0czsKICB9OwoKICAvLyBDb252ZXJ0cyBsaXN0cyBpbnRvIG9iamVjdHMuIFBhc3MgZWl0aGVyIGEgc2luZ2xlIGFycmF5IG9mIGBba2V5LCB2YWx1ZV1gCiAgLy8gcGFpcnMsIG9yIHR3byBwYXJhbGxlbCBhcnJheXMgb2YgdGhlIHNhbWUgbGVuZ3RoIC0tIG9uZSBvZiBrZXlzLCBhbmQgb25lIG9mCiAgLy8gdGhlIGNvcnJlc3BvbmRpbmcgdmFsdWVzLgogIF8ub2JqZWN0ID0gZnVuY3Rpb24obGlzdCwgdmFsdWVzKSB7CiAgICBpZiAobGlzdCA9PSBudWxsKSByZXR1cm4ge307CiAgICB2YXIgcmVzdWx0ID0ge307CiAgICBmb3IgKHZhciBpID0gMCwgbCA9IGxpc3QubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgIGlmICh2YWx1ZXMpIHsKICAgICAgICByZXN1bHRbbGlzdFtpXV0gPSB2YWx1ZXNbaV07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmVzdWx0W2xpc3RbaV1bMF1dID0gbGlzdFtpXVsxXTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9OwoKICAvLyBJZiB0aGUgYnJvd3NlciBkb2Vzbid0IHN1cHBseSB1cyB3aXRoIGluZGV4T2YgKEknbSBsb29raW5nIGF0IHlvdSwgKipNU0lFKiopLAogIC8vIHdlIG5lZWQgdGhpcyBmdW5jdGlvbi4gUmV0dXJuIHRoZSBwb3NpdGlvbiBvZiB0aGUgZmlyc3Qgb2NjdXJyZW5jZSBvZiBhbgogIC8vIGl0ZW0gaW4gYW4gYXJyYXksIG9yIC0xIGlmIHRoZSBpdGVtIGlzIG5vdCBpbmNsdWRlZCBpbiB0aGUgYXJyYXkuCiAgLy8gRGVsZWdhdGVzIHRvICoqRUNNQVNjcmlwdCA1KioncyBuYXRpdmUgYGluZGV4T2ZgIGlmIGF2YWlsYWJsZS4KICAvLyBJZiB0aGUgYXJyYXkgaXMgbGFyZ2UgYW5kIGFscmVhZHkgaW4gc29ydCBvcmRlciwgcGFzcyBgdHJ1ZWAKICAvLyBmb3IgKippc1NvcnRlZCoqIHRvIHVzZSBiaW5hcnkgc2VhcmNoLgogIF8uaW5kZXhPZiA9IGZ1bmN0aW9uKGFycmF5LCBpdGVtLCBpc1NvcnRlZCkgewogICAgaWYgKGFycmF5ID09IG51bGwpIHJldHVybiAtMTsKICAgIHZhciBpID0gMCwgbCA9IGFycmF5Lmxlbmd0aDsKICAgIGlmIChpc1NvcnRlZCkgewogICAgICBpZiAodHlwZW9mIGlzU29ydGVkID09ICdudW1iZXInKSB7CiAgICAgICAgaSA9IChpc1NvcnRlZCA8IDAgPyBNYXRoLm1heCgwLCBsICsgaXNTb3J0ZWQpIDogaXNTb3J0ZWQpOwogICAgICB9IGVsc2UgewogICAgICAgIGkgPSBfLnNvcnRlZEluZGV4KGFycmF5LCBpdGVtKTsKICAgICAgICByZXR1cm4gYXJyYXlbaV0gPT09IGl0ZW0gPyBpIDogLTE7CiAgICAgIH0KICAgIH0KICAgIGlmIChuYXRpdmVJbmRleE9mICYmIGFycmF5LmluZGV4T2YgPT09IG5hdGl2ZUluZGV4T2YpIHJldHVybiBhcnJheS5pbmRleE9mKGl0ZW0sIGlzU29ydGVkKTsKICAgIGZvciAoOyBpIDwgbDsgaSsrKSBpZiAoYXJyYXlbaV0gPT09IGl0ZW0pIHJldHVybiBpOwogICAgcmV0dXJuIC0xOwogIH07CgogIC8vIERlbGVnYXRlcyB0byAqKkVDTUFTY3JpcHQgNSoqJ3MgbmF0aXZlIGBsYXN0SW5kZXhPZmAgaWYgYXZhaWxhYmxlLgogIF8ubGFzdEluZGV4T2YgPSBmdW5jdGlvbihhcnJheSwgaXRlbSwgZnJvbSkgewogICAgaWYgKGFycmF5ID09IG51bGwpIHJldHVybiAtMTsKICAgIHZhciBoYXNJbmRleCA9IGZyb20gIT0gbnVsbDsKICAgIGlmIChuYXRpdmVMYXN0SW5kZXhPZiAmJiBhcnJheS5sYXN0SW5kZXhPZiA9PT0gbmF0aXZlTGFzdEluZGV4T2YpIHsKICAgICAgcmV0dXJuIGhhc0luZGV4ID8gYXJyYXkubGFzdEluZGV4T2YoaXRlbSwgZnJvbSkgOiBhcnJheS5sYXN0SW5kZXhPZihpdGVtKTsKICAgIH0KICAgIHZhciBpID0gKGhhc0luZGV4ID8gZnJvbSA6IGFycmF5Lmxlbmd0aCk7CiAgICB3aGlsZSAoaS0tKSBpZiAoYXJyYXlbaV0gPT09IGl0ZW0pIHJldHVybiBpOwogICAgcmV0dXJuIC0xOwogIH07CgogIC8vIEdlbmVyYXRlIGFuIGludGVnZXIgQXJyYXkgY29udGFpbmluZyBhbiBhcml0aG1ldGljIHByb2dyZXNzaW9uLiBBIHBvcnQgb2YKICAvLyB0aGUgbmF0aXZlIFB5dGhvbiBgcmFuZ2UoKWAgZnVuY3Rpb24uIFNlZQogIC8vIFt0aGUgUHl0aG9uIGRvY3VtZW50YXRpb25dKGh0dHA6Ly9kb2NzLnB5dGhvbi5vcmcvbGlicmFyeS9mdW5jdGlvbnMuaHRtbCNyYW5nZSkuCiAgXy5yYW5nZSA9IGZ1bmN0aW9uKHN0YXJ0LCBzdG9wLCBzdGVwKSB7CiAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA8PSAxKSB7CiAgICAgIHN0b3AgPSBzdGFydCB8fCAwOwogICAgICBzdGFydCA9IDA7CiAgICB9CiAgICBzdGVwID0gYXJndW1lbnRzWzJdIHx8IDE7CgogICAgdmFyIGxlbiA9IE1hdGgubWF4KE1hdGguY2VpbCgoc3RvcCAtIHN0YXJ0KSAvIHN0ZXApLCAwKTsKICAgIHZhciBpZHggPSAwOwogICAgdmFyIHJhbmdlID0gbmV3IEFycmF5KGxlbik7CgogICAgd2hpbGUoaWR4IDwgbGVuKSB7CiAgICAgIHJhbmdlW2lkeCsrXSA9IHN0YXJ0OwogICAgICBzdGFydCArPSBzdGVwOwogICAgfQoKICAgIHJldHVybiByYW5nZTsKICB9OwoKICAvLyBGdW5jdGlvbiAoYWhlbSkgRnVuY3Rpb25zCiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tCgogIC8vIENyZWF0ZSBhIGZ1bmN0aW9uIGJvdW5kIHRvIGEgZ2l2ZW4gb2JqZWN0IChhc3NpZ25pbmcgYHRoaXNgLCBhbmQgYXJndW1lbnRzLAogIC8vIG9wdGlvbmFsbHkpLiBEZWxlZ2F0ZXMgdG8gKipFQ01BU2NyaXB0IDUqKidzIG5hdGl2ZSBgRnVuY3Rpb24uYmluZGAgaWYKICAvLyBhdmFpbGFibGUuCiAgXy5iaW5kID0gZnVuY3Rpb24oZnVuYywgY29udGV4dCkgewogICAgaWYgKGZ1bmMuYmluZCA9PT0gbmF0aXZlQmluZCAmJiBuYXRpdmVCaW5kKSByZXR1cm4gbmF0aXZlQmluZC5hcHBseShmdW5jLCBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSkpOwogICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cywgMik7CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBmdW5jLmFwcGx5KGNvbnRleHQsIGFyZ3MuY29uY2F0KHNsaWNlLmNhbGwoYXJndW1lbnRzKSkpOwogICAgfTsKICB9OwoKICAvLyBQYXJ0aWFsbHkgYXBwbHkgYSBmdW5jdGlvbiBieSBjcmVhdGluZyBhIHZlcnNpb24gdGhhdCBoYXMgaGFkIHNvbWUgb2YgaXRzCiAgLy8gYXJndW1lbnRzIHByZS1maWxsZWQsIHdpdGhvdXQgY2hhbmdpbmcgaXRzIGR5bmFtaWMgYHRoaXNgIGNvbnRleHQuCiAgXy5wYXJ0aWFsID0gZnVuY3Rpb24oZnVuYykgewogICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBmdW5jLmFwcGx5KHRoaXMsIGFyZ3MuY29uY2F0KHNsaWNlLmNhbGwoYXJndW1lbnRzKSkpOwogICAgfTsKICB9OwoKICAvLyBCaW5kIGFsbCBvZiBhbiBvYmplY3QncyBtZXRob2RzIHRvIHRoYXQgb2JqZWN0LiBVc2VmdWwgZm9yIGVuc3VyaW5nIHRoYXQKICAvLyBhbGwgY2FsbGJhY2tzIGRlZmluZWQgb24gYW4gb2JqZWN0IGJlbG9uZyB0byBpdC4KICBfLmJpbmRBbGwgPSBmdW5jdGlvbihvYmopIHsKICAgIHZhciBmdW5jcyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKICAgIGlmIChmdW5jcy5sZW5ndGggPT09IDApIGZ1bmNzID0gXy5mdW5jdGlvbnMob2JqKTsKICAgIGVhY2goZnVuY3MsIGZ1bmN0aW9uKGYpIHsgb2JqW2ZdID0gXy5iaW5kKG9ialtmXSwgb2JqKTsgfSk7CiAgICByZXR1cm4gb2JqOwogIH07CgogIC8vIE1lbW9pemUgYW4gZXhwZW5zaXZlIGZ1bmN0aW9uIGJ5IHN0b3JpbmcgaXRzIHJlc3VsdHMuCiAgXy5tZW1vaXplID0gZnVuY3Rpb24oZnVuYywgaGFzaGVyKSB7CiAgICB2YXIgbWVtbyA9IHt9OwogICAgaGFzaGVyIHx8IChoYXNoZXIgPSBfLmlkZW50aXR5KTsKICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgdmFyIGtleSA9IGhhc2hlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICByZXR1cm4gXy5oYXMobWVtbywga2V5KSA/IG1lbW9ba2V5XSA6IChtZW1vW2tleV0gPSBmdW5jLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykpOwogICAgfTsKICB9OwoKICAvLyBEZWxheXMgYSBmdW5jdGlvbiBmb3IgdGhlIGdpdmVuIG51bWJlciBvZiBtaWxsaXNlY29uZHMsIGFuZCB0aGVuIGNhbGxzCiAgLy8gaXQgd2l0aCB0aGUgYXJndW1lbnRzIHN1cHBsaWVkLgogIF8uZGVsYXkgPSBmdW5jdGlvbihmdW5jLCB3YWl0KSB7CiAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAyKTsKICAgIHJldHVybiBzZXRUaW1lb3V0KGZ1bmN0aW9uKCl7IHJldHVybiBmdW5jLmFwcGx5KG51bGwsIGFyZ3MpOyB9LCB3YWl0KTsKICB9OwoKICAvLyBEZWZlcnMgYSBmdW5jdGlvbiwgc2NoZWR1bGluZyBpdCB0byBydW4gYWZ0ZXIgdGhlIGN1cnJlbnQgY2FsbCBzdGFjayBoYXMKICAvLyBjbGVhcmVkLgogIF8uZGVmZXIgPSBmdW5jdGlvbihmdW5jKSB7CiAgICByZXR1cm4gXy5kZWxheS5hcHBseShfLCBbZnVuYywgMV0uY29uY2F0KHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSkpOwogIH07CgogIC8vIFJldHVybnMgYSBmdW5jdGlvbiwgdGhhdCwgd2hlbiBpbnZva2VkLCB3aWxsIG9ubHkgYmUgdHJpZ2dlcmVkIGF0IG1vc3Qgb25jZQogIC8vIGR1cmluZyBhIGdpdmVuIHdpbmRvdyBvZiB0aW1lLgogIF8udGhyb3R0bGUgPSBmdW5jdGlvbihmdW5jLCB3YWl0KSB7CiAgICB2YXIgY29udGV4dCwgYXJncywgdGltZW91dCwgcmVzdWx0OwogICAgdmFyIHByZXZpb3VzID0gMDsKICAgIHZhciBsYXRlciA9IGZ1bmN0aW9uKCkgewogICAgICBwcmV2aW91cyA9IG5ldyBEYXRlOwogICAgICB0aW1lb3V0ID0gbnVsbDsKICAgICAgcmVzdWx0ID0gZnVuYy5hcHBseShjb250ZXh0LCBhcmdzKTsKICAgIH07CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBub3cgPSBuZXcgRGF0ZTsKICAgICAgdmFyIHJlbWFpbmluZyA9IHdhaXQgLSAobm93IC0gcHJldmlvdXMpOwogICAgICBjb250ZXh0ID0gdGhpczsKICAgICAgYXJncyA9IGFyZ3VtZW50czsKICAgICAgaWYgKHJlbWFpbmluZyA8PSAwKSB7CiAgICAgICAgY2xlYXJUaW1lb3V0KHRpbWVvdXQpOwogICAgICAgIHRpbWVvdXQgPSBudWxsOwogICAgICAgIHByZXZpb3VzID0gbm93OwogICAgICAgIHJlc3VsdCA9IGZ1bmMuYXBwbHkoY29udGV4dCwgYXJncyk7CiAgICAgIH0gZWxzZSBpZiAoIXRpbWVvdXQpIHsKICAgICAgICB0aW1lb3V0ID0gc2V0VGltZW91dChsYXRlciwgcmVtYWluaW5nKTsKICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0OwogICAgfTsKICB9OwoKICAvLyBSZXR1cm5zIGEgZnVuY3Rpb24sIHRoYXQsIGFzIGxvbmcgYXMgaXQgY29udGludWVzIHRvIGJlIGludm9rZWQsIHdpbGwgbm90CiAgLy8gYmUgdHJpZ2dlcmVkLiBUaGUgZnVuY3Rpb24gd2lsbCBiZSBjYWxsZWQgYWZ0ZXIgaXQgc3RvcHMgYmVpbmcgY2FsbGVkIGZvcgogIC8vIE4gbWlsbGlzZWNvbmRzLiBJZiBgaW1tZWRpYXRlYCBpcyBwYXNzZWQsIHRyaWdnZXIgdGhlIGZ1bmN0aW9uIG9uIHRoZQogIC8vIGxlYWRpbmcgZWRnZSwgaW5zdGVhZCBvZiB0aGUgdHJhaWxpbmcuCiAgXy5kZWJvdW5jZSA9IGZ1bmN0aW9uKGZ1bmMsIHdhaXQsIGltbWVkaWF0ZSkgewogICAgdmFyIHRpbWVvdXQsIHJlc3VsdDsKICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgdmFyIGNvbnRleHQgPSB0aGlzLCBhcmdzID0gYXJndW1lbnRzOwogICAgICB2YXIgbGF0ZXIgPSBmdW5jdGlvbigpIHsKICAgICAgICB0aW1lb3V0ID0gbnVsbDsKICAgICAgICBpZiAoIWltbWVkaWF0ZSkgcmVzdWx0ID0gZnVuYy5hcHBseShjb250ZXh0LCBhcmdzKTsKICAgICAgfTsKICAgICAgdmFyIGNhbGxOb3cgPSBpbW1lZGlhdGUgJiYgIXRpbWVvdXQ7CiAgICAgIGNsZWFyVGltZW91dCh0aW1lb3V0KTsKICAgICAgdGltZW91dCA9IHNldFRpbWVvdXQobGF0ZXIsIHdhaXQpOwogICAgICBpZiAoY2FsbE5vdykgcmVzdWx0ID0gZnVuYy5hcHBseShjb250ZXh0LCBhcmdzKTsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH07CiAgfTsKCiAgLy8gUmV0dXJucyBhIGZ1bmN0aW9uIHRoYXQgd2lsbCBiZSBleGVjdXRlZCBhdCBtb3N0IG9uZSB0aW1lLCBubyBtYXR0ZXIgaG93CiAgLy8gb2Z0ZW4geW91IGNhbGwgaXQuIFVzZWZ1bCBmb3IgbGF6eSBpbml0aWFsaXphdGlvbi4KICBfLm9uY2UgPSBmdW5jdGlvbihmdW5jKSB7CiAgICB2YXIgcmFuID0gZmFsc2UsIG1lbW87CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIGlmIChyYW4pIHJldHVybiBtZW1vOwogICAgICByYW4gPSB0cnVlOwogICAgICBtZW1vID0gZnVuYy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICBmdW5jID0gbnVsbDsKICAgICAgcmV0dXJuIG1lbW87CiAgICB9OwogIH07CgogIC8vIFJldHVybnMgdGhlIGZpcnN0IGZ1bmN0aW9uIHBhc3NlZCBhcyBhbiBhcmd1bWVudCB0byB0aGUgc2Vjb25kLAogIC8vIGFsbG93aW5nIHlvdSB0byBhZGp1c3QgYXJndW1lbnRzLCBydW4gY29kZSBiZWZvcmUgYW5kIGFmdGVyLCBhbmQKICAvLyBjb25kaXRpb25hbGx5IGV4ZWN1dGUgdGhlIG9yaWdpbmFsIGZ1bmN0aW9uLgogIF8ud3JhcCA9IGZ1bmN0aW9uKGZ1bmMsIHdyYXBwZXIpIHsKICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgdmFyIGFyZ3MgPSBbZnVuY107CiAgICAgIHB1c2guYXBwbHkoYXJncywgYXJndW1lbnRzKTsKICAgICAgcmV0dXJuIHdyYXBwZXIuYXBwbHkodGhpcywgYXJncyk7CiAgICB9OwogIH07CgogIC8vIFJldHVybnMgYSBmdW5jdGlvbiB0aGF0IGlzIHRoZSBjb21wb3NpdGlvbiBvZiBhIGxpc3Qgb2YgZnVuY3Rpb25zLCBlYWNoCiAgLy8gY29uc3VtaW5nIHRoZSByZXR1cm4gdmFsdWUgb2YgdGhlIGZ1bmN0aW9uIHRoYXQgZm9sbG93cy4KICBfLmNvbXBvc2UgPSBmdW5jdGlvbigpIHsKICAgIHZhciBmdW5jcyA9IGFyZ3VtZW50czsKICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgdmFyIGFyZ3MgPSBhcmd1bWVudHM7CiAgICAgIGZvciAodmFyIGkgPSBmdW5jcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICAgIGFyZ3MgPSBbZnVuY3NbaV0uYXBwbHkodGhpcywgYXJncyldOwogICAgICB9CiAgICAgIHJldHVybiBhcmdzWzBdOwogICAgfTsKICB9OwoKICAvLyBSZXR1cm5zIGEgZnVuY3Rpb24gdGhhdCB3aWxsIG9ubHkgYmUgZXhlY3V0ZWQgYWZ0ZXIgYmVpbmcgY2FsbGVkIE4gdGltZXMuCiAgXy5hZnRlciA9IGZ1bmN0aW9uKHRpbWVzLCBmdW5jKSB7CiAgICBpZiAodGltZXMgPD0gMCkgcmV0dXJuIGZ1bmMoKTsKICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgaWYgKC0tdGltZXMgPCAxKSB7CiAgICAgICAgcmV0dXJuIGZ1bmMuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfQogICAgfTsKICB9OwoKICAvLyBPYmplY3QgRnVuY3Rpb25zCiAgLy8gLS0tLS0tLS0tLS0tLS0tLQoKICAvLyBSZXRyaWV2ZSB0aGUgbmFtZXMgb2YgYW4gb2JqZWN0J3MgcHJvcGVydGllcy4KICAvLyBEZWxlZ2F0ZXMgdG8gKipFQ01BU2NyaXB0IDUqKidzIG5hdGl2ZSBgT2JqZWN0LmtleXNgCiAgXy5rZXlzID0gbmF0aXZlS2V5cyB8fCBmdW5jdGlvbihvYmopIHsKICAgIGlmIChvYmogIT09IE9iamVjdChvYmopKSB0aHJvdyBuZXcgVHlwZUVycm9yKCdJbnZhbGlkIG9iamVjdCcpOwogICAgdmFyIGtleXMgPSBbXTsKICAgIGZvciAodmFyIGtleSBpbiBvYmopIGlmIChfLmhhcyhvYmosIGtleSkpIGtleXNba2V5cy5sZW5ndGhdID0ga2V5OwogICAgcmV0dXJuIGtleXM7CiAgfTsKCiAgLy8gUmV0cmlldmUgdGhlIHZhbHVlcyBvZiBhbiBvYmplY3QncyBwcm9wZXJ0aWVzLgogIF8udmFsdWVzID0gZnVuY3Rpb24ob2JqKSB7CiAgICB2YXIgdmFsdWVzID0gW107CiAgICBmb3IgKHZhciBrZXkgaW4gb2JqKSBpZiAoXy5oYXMob2JqLCBrZXkpKSB2YWx1ZXMucHVzaChvYmpba2V5XSk7CiAgICByZXR1cm4gdmFsdWVzOwogIH07CgogIC8vIENvbnZlcnQgYW4gb2JqZWN0IGludG8gYSBsaXN0IG9mIGBba2V5LCB2YWx1ZV1gIHBhaXJzLgogIF8ucGFpcnMgPSBmdW5jdGlvbihvYmopIHsKICAgIHZhciBwYWlycyA9IFtdOwogICAgZm9yICh2YXIga2V5IGluIG9iaikgaWYgKF8uaGFzKG9iaiwga2V5KSkgcGFpcnMucHVzaChba2V5LCBvYmpba2V5XV0pOwogICAgcmV0dXJuIHBhaXJzOwogIH07CgogIC8vIEludmVydCB0aGUga2V5cyBhbmQgdmFsdWVzIG9mIGFuIG9iamVjdC4gVGhlIHZhbHVlcyBtdXN0IGJlIHNlcmlhbGl6YWJsZS4KICBfLmludmVydCA9IGZ1bmN0aW9uKG9iaikgewogICAgdmFyIHJlc3VsdCA9IHt9OwogICAgZm9yICh2YXIga2V5IGluIG9iaikgaWYgKF8uaGFzKG9iaiwga2V5KSkgcmVzdWx0W29ialtrZXldXSA9IGtleTsKICAgIHJldHVybiByZXN1bHQ7CiAgfTsKCiAgLy8gUmV0dXJuIGEgc29ydGVkIGxpc3Qgb2YgdGhlIGZ1bmN0aW9uIG5hbWVzIGF2YWlsYWJsZSBvbiB0aGUgb2JqZWN0LgogIC8vIEFsaWFzZWQgYXMgYG1ldGhvZHNgCiAgXy5mdW5jdGlvbnMgPSBfLm1ldGhvZHMgPSBmdW5jdGlvbihvYmopIHsKICAgIHZhciBuYW1lcyA9IFtdOwogICAgZm9yICh2YXIga2V5IGluIG9iaikgewogICAgICBpZiAoXy5pc0Z1bmN0aW9uKG9ialtrZXldKSkgbmFtZXMucHVzaChrZXkpOwogICAgfQogICAgcmV0dXJuIG5hbWVzLnNvcnQoKTsKICB9OwoKICAvLyBFeHRlbmQgYSBnaXZlbiBvYmplY3Qgd2l0aCBhbGwgdGhlIHByb3BlcnRpZXMgaW4gcGFzc2VkLWluIG9iamVjdChzKS4KICBfLmV4dGVuZCA9IGZ1bmN0aW9uKG9iaikgewogICAgZWFjaChzbGljZS5jYWxsKGFyZ3VtZW50cywgMSksIGZ1bmN0aW9uKHNvdXJjZSkgewogICAgICBpZiAoc291cmNlKSB7CiAgICAgICAgZm9yICh2YXIgcHJvcCBpbiBzb3VyY2UpIHsKICAgICAgICAgIG9ialtwcm9wXSA9IHNvdXJjZVtwcm9wXTsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuIG9iajsKICB9OwoKICAvLyBSZXR1cm4gYSBjb3B5IG9mIHRoZSBvYmplY3Qgb25seSBjb250YWluaW5nIHRoZSB3aGl0ZWxpc3RlZCBwcm9wZXJ0aWVzLgogIF8ucGljayA9IGZ1bmN0aW9uKG9iaikgewogICAgdmFyIGNvcHkgPSB7fTsKICAgIHZhciBrZXlzID0gY29uY2F0LmFwcGx5KEFycmF5UHJvdG8sIHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSk7CiAgICBlYWNoKGtleXMsIGZ1bmN0aW9uKGtleSkgewogICAgICBpZiAoa2V5IGluIG9iaikgY29weVtrZXldID0gb2JqW2tleV07CiAgICB9KTsKICAgIHJldHVybiBjb3B5OwogIH07CgogICAvLyBSZXR1cm4gYSBjb3B5IG9mIHRoZSBvYmplY3Qgd2l0aG91dCB0aGUgYmxhY2tsaXN0ZWQgcHJvcGVydGllcy4KICBfLm9taXQgPSBmdW5jdGlvbihvYmopIHsKICAgIHZhciBjb3B5ID0ge307CiAgICB2YXIga2V5cyA9IGNvbmNhdC5hcHBseShBcnJheVByb3RvLCBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSkpOwogICAgZm9yICh2YXIga2V5IGluIG9iaikgewogICAgICBpZiAoIV8uY29udGFpbnMoa2V5cywga2V5KSkgY29weVtrZXldID0gb2JqW2tleV07CiAgICB9CiAgICByZXR1cm4gY29weTsKICB9OwoKICAvLyBGaWxsIGluIGEgZ2l2ZW4gb2JqZWN0IHdpdGggZGVmYXVsdCBwcm9wZXJ0aWVzLgogIF8uZGVmYXVsdHMgPSBmdW5jdGlvbihvYmopIHsKICAgIGVhY2goc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpLCBmdW5jdGlvbihzb3VyY2UpIHsKICAgICAgaWYgKHNvdXJjZSkgewogICAgICAgIGZvciAodmFyIHByb3AgaW4gc291cmNlKSB7CiAgICAgICAgICBpZiAob2JqW3Byb3BdID09IG51bGwpIG9ialtwcm9wXSA9IHNvdXJjZVtwcm9wXTsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuIG9iajsKICB9OwoKICAvLyBDcmVhdGUgYSAoc2hhbGxvdy1jbG9uZWQpIGR1cGxpY2F0ZSBvZiBhbiBvYmplY3QuCiAgXy5jbG9uZSA9IGZ1bmN0aW9uKG9iaikgewogICAgaWYgKCFfLmlzT2JqZWN0KG9iaikpIHJldHVybiBvYmo7CiAgICByZXR1cm4gXy5pc0FycmF5KG9iaikgPyBvYmouc2xpY2UoKSA6IF8uZXh0ZW5kKHt9LCBvYmopOwogIH07CgogIC8vIEludm9rZXMgaW50ZXJjZXB0b3Igd2l0aCB0aGUgb2JqLCBhbmQgdGhlbiByZXR1cm5zIG9iai4KICAvLyBUaGUgcHJpbWFyeSBwdXJwb3NlIG9mIHRoaXMgbWV0aG9kIGlzIHRvICJ0YXAgaW50byIgYSBtZXRob2QgY2hhaW4sIGluCiAgLy8gb3JkZXIgdG8gcGVyZm9ybSBvcGVyYXRpb25zIG9uIGludGVybWVkaWF0ZSByZXN1bHRzIHdpdGhpbiB0aGUgY2hhaW4uCiAgXy50YXAgPSBmdW5jdGlvbihvYmosIGludGVyY2VwdG9yKSB7CiAgICBpbnRlcmNlcHRvcihvYmopOwogICAgcmV0dXJuIG9iajsKICB9OwoKICAvLyBJbnRlcm5hbCByZWN1cnNpdmUgY29tcGFyaXNvbiBmdW5jdGlvbiBmb3IgYGlzRXF1YWxgLgogIHZhciBlcSA9IGZ1bmN0aW9uKGEsIGIsIGFTdGFjaywgYlN0YWNrKSB7CiAgICAvLyBJZGVudGljYWwgb2JqZWN0cyBhcmUgZXF1YWwuIGAwID09PSAtMGAsIGJ1dCB0aGV5IGFyZW4ndCBpZGVudGljYWwuCiAgICAvLyBTZWUgdGhlIEhhcm1vbnkgYGVnYWxgIHByb3Bvc2FsOiBodHRwOi8vd2lraS5lY21hc2NyaXB0Lm9yZy9kb2t1LnBocD9pZD1oYXJtb255OmVnYWwuCiAgICBpZiAoYSA9PT0gYikgcmV0dXJuIGEgIT09IDAgfHwgMSAvIGEgPT0gMSAvIGI7CiAgICAvLyBBIHN0cmljdCBjb21wYXJpc29uIGlzIG5lY2Vzc2FyeSBiZWNhdXNlIGBudWxsID09IHVuZGVmaW5lZGAuCiAgICBpZiAoYSA9PSBudWxsIHx8IGIgPT0gbnVsbCkgcmV0dXJuIGEgPT09IGI7CiAgICAvLyBVbndyYXAgYW55IHdyYXBwZWQgb2JqZWN0cy4KICAgIGlmIChhIGluc3RhbmNlb2YgXykgYSA9IGEuX3dyYXBwZWQ7CiAgICBpZiAoYiBpbnN0YW5jZW9mIF8pIGIgPSBiLl93cmFwcGVkOwogICAgLy8gQ29tcGFyZSBgW1tDbGFzc11dYCBuYW1lcy4KICAgIHZhciBjbGFzc05hbWUgPSB0b1N0cmluZy5jYWxsKGEpOwogICAgaWYgKGNsYXNzTmFtZSAhPSB0b1N0cmluZy5jYWxsKGIpKSByZXR1cm4gZmFsc2U7CiAgICBzd2l0Y2ggKGNsYXNzTmFtZSkgewogICAgICAvLyBTdHJpbmdzLCBudW1iZXJzLCBkYXRlcywgYW5kIGJvb2xlYW5zIGFyZSBjb21wYXJlZCBieSB2YWx1ZS4KICAgICAgY2FzZSAnW29iamVjdCBTdHJpbmddJzoKICAgICAgICAvLyBQcmltaXRpdmVzIGFuZCB0aGVpciBjb3JyZXNwb25kaW5nIG9iamVjdCB3cmFwcGVycyBhcmUgZXF1aXZhbGVudDsgdGh1cywgYCI1ImAgaXMKICAgICAgICAvLyBlcXVpdmFsZW50IHRvIGBuZXcgU3RyaW5nKCI1IilgLgogICAgICAgIHJldHVybiBhID09IFN0cmluZyhiKTsKICAgICAgY2FzZSAnW29iamVjdCBOdW1iZXJdJzoKICAgICAgICAvLyBgTmFOYHMgYXJlIGVxdWl2YWxlbnQsIGJ1dCBub24tcmVmbGV4aXZlLiBBbiBgZWdhbGAgY29tcGFyaXNvbiBpcyBwZXJmb3JtZWQgZm9yCiAgICAgICAgLy8gb3RoZXIgbnVtZXJpYyB2YWx1ZXMuCiAgICAgICAgcmV0dXJuIGEgIT0gK2EgPyBiICE9ICtiIDogKGEgPT0gMCA/IDEgLyBhID09IDEgLyBiIDogYSA9PSArYik7CiAgICAgIGNhc2UgJ1tvYmplY3QgRGF0ZV0nOgogICAgICBjYXNlICdbb2JqZWN0IEJvb2xlYW5dJzoKICAgICAgICAvLyBDb2VyY2UgZGF0ZXMgYW5kIGJvb2xlYW5zIHRvIG51bWVyaWMgcHJpbWl0aXZlIHZhbHVlcy4gRGF0ZXMgYXJlIGNvbXBhcmVkIGJ5IHRoZWlyCiAgICAgICAgLy8gbWlsbGlzZWNvbmQgcmVwcmVzZW50YXRpb25zLiBOb3RlIHRoYXQgaW52YWxpZCBkYXRlcyB3aXRoIG1pbGxpc2Vjb25kIHJlcHJlc2VudGF0aW9ucwogICAgICAgIC8vIG9mIGBOYU5gIGFyZSBub3QgZXF1aXZhbGVudC4KICAgICAgICByZXR1cm4gK2EgPT0gK2I7CiAgICAgIC8vIFJlZ0V4cHMgYXJlIGNvbXBhcmVkIGJ5IHRoZWlyIHNvdXJjZSBwYXR0ZXJucyBhbmQgZmxhZ3MuCiAgICAgIGNhc2UgJ1tvYmplY3QgUmVnRXhwXSc6CiAgICAgICAgcmV0dXJuIGEuc291cmNlID09IGIuc291cmNlICYmCiAgICAgICAgICAgICAgIGEuZ2xvYmFsID09IGIuZ2xvYmFsICYmCiAgICAgICAgICAgICAgIGEubXVsdGlsaW5lID09IGIubXVsdGlsaW5lICYmCiAgICAgICAgICAgICAgIGEuaWdub3JlQ2FzZSA9PSBiLmlnbm9yZUNhc2U7CiAgICB9CiAgICBpZiAodHlwZW9mIGEgIT0gJ29iamVjdCcgfHwgdHlwZW9mIGIgIT0gJ29iamVjdCcpIHJldHVybiBmYWxzZTsKICAgIC8vIEFzc3VtZSBlcXVhbGl0eSBmb3IgY3ljbGljIHN0cnVjdHVyZXMuIFRoZSBhbGdvcml0aG0gZm9yIGRldGVjdGluZyBjeWNsaWMKICAgIC8vIHN0cnVjdHVyZXMgaXMgYWRhcHRlZCBmcm9tIEVTIDUuMSBzZWN0aW9uIDE1LjEyLjMsIGFic3RyYWN0IG9wZXJhdGlvbiBgSk9gLgogICAgdmFyIGxlbmd0aCA9IGFTdGFjay5sZW5ndGg7CiAgICB3aGlsZSAobGVuZ3RoLS0pIHsKICAgICAgLy8gTGluZWFyIHNlYXJjaC4gUGVyZm9ybWFuY2UgaXMgaW52ZXJzZWx5IHByb3BvcnRpb25hbCB0byB0aGUgbnVtYmVyIG9mCiAgICAgIC8vIHVuaXF1ZSBuZXN0ZWQgc3RydWN0dXJlcy4KICAgICAgaWYgKGFTdGFja1tsZW5ndGhdID09IGEpIHJldHVybiBiU3RhY2tbbGVuZ3RoXSA9PSBiOwogICAgfQogICAgLy8gQWRkIHRoZSBmaXJzdCBvYmplY3QgdG8gdGhlIHN0YWNrIG9mIHRyYXZlcnNlZCBvYmplY3RzLgogICAgYVN0YWNrLnB1c2goYSk7CiAgICBiU3RhY2sucHVzaChiKTsKICAgIHZhciBzaXplID0gMCwgcmVzdWx0ID0gdHJ1ZTsKICAgIC8vIFJlY3Vyc2l2ZWx5IGNvbXBhcmUgb2JqZWN0cyBhbmQgYXJyYXlzLgogICAgaWYgKGNsYXNzTmFtZSA9PSAnW29iamVjdCBBcnJheV0nKSB7CiAgICAgIC8vIENvbXBhcmUgYXJyYXkgbGVuZ3RocyB0byBkZXRlcm1pbmUgaWYgYSBkZWVwIGNvbXBhcmlzb24gaXMgbmVjZXNzYXJ5LgogICAgICBzaXplID0gYS5sZW5ndGg7CiAgICAgIHJlc3VsdCA9IHNpemUgPT0gYi5sZW5ndGg7CiAgICAgIGlmIChyZXN1bHQpIHsKICAgICAgICAvLyBEZWVwIGNvbXBhcmUgdGhlIGNvbnRlbnRzLCBpZ25vcmluZyBub24tbnVtZXJpYyBwcm9wZXJ0aWVzLgogICAgICAgIHdoaWxlIChzaXplLS0pIHsKICAgICAgICAgIGlmICghKHJlc3VsdCA9IGVxKGFbc2l6ZV0sIGJbc2l6ZV0sIGFTdGFjaywgYlN0YWNrKSkpIGJyZWFrOwogICAgICAgIH0KICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgLy8gT2JqZWN0cyB3aXRoIGRpZmZlcmVudCBjb25zdHJ1Y3RvcnMgYXJlIG5vdCBlcXVpdmFsZW50LCBidXQgYE9iamVjdGBzCiAgICAgIC8vIGZyb20gZGlmZmVyZW50IGZyYW1lcyBhcmUuCiAgICAgIHZhciBhQ3RvciA9IGEuY29uc3RydWN0b3IsIGJDdG9yID0gYi5jb25zdHJ1Y3RvcjsKICAgICAgaWYgKGFDdG9yICE9PSBiQ3RvciAmJiAhKF8uaXNGdW5jdGlvbihhQ3RvcikgJiYgKGFDdG9yIGluc3RhbmNlb2YgYUN0b3IpICYmCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfLmlzRnVuY3Rpb24oYkN0b3IpICYmIChiQ3RvciBpbnN0YW5jZW9mIGJDdG9yKSkpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgICAgLy8gRGVlcCBjb21wYXJlIG9iamVjdHMuCiAgICAgIGZvciAodmFyIGtleSBpbiBhKSB7CiAgICAgICAgaWYgKF8uaGFzKGEsIGtleSkpIHsKICAgICAgICAgIC8vIENvdW50IHRoZSBleHBlY3RlZCBudW1iZXIgb2YgcHJvcGVydGllcy4KICAgICAgICAgIHNpemUrKzsKICAgICAgICAgIC8vIERlZXAgY29tcGFyZSBlYWNoIG1lbWJlci4KICAgICAgICAgIGlmICghKHJlc3VsdCA9IF8uaGFzKGIsIGtleSkgJiYgZXEoYVtrZXldLCBiW2tleV0sIGFTdGFjaywgYlN0YWNrKSkpIGJyZWFrOwogICAgICAgIH0KICAgICAgfQogICAgICAvLyBFbnN1cmUgdGhhdCBib3RoIG9iamVjdHMgY29udGFpbiB0aGUgc2FtZSBudW1iZXIgb2YgcHJvcGVydGllcy4KICAgICAgaWYgKHJlc3VsdCkgewogICAgICAgIGZvciAoa2V5IGluIGIpIHsKICAgICAgICAgIGlmIChfLmhhcyhiLCBrZXkpICYmICEoc2l6ZS0tKSkgYnJlYWs7CiAgICAgICAgfQogICAgICAgIHJlc3VsdCA9ICFzaXplOwogICAgICB9CiAgICB9CiAgICAvLyBSZW1vdmUgdGhlIGZpcnN0IG9iamVjdCBmcm9tIHRoZSBzdGFjayBvZiB0cmF2ZXJzZWQgb2JqZWN0cy4KICAgIGFTdGFjay5wb3AoKTsKICAgIGJTdGFjay5wb3AoKTsKICAgIHJldHVybiByZXN1bHQ7CiAgfTsKCiAgLy8gUGVyZm9ybSBhIGRlZXAgY29tcGFyaXNvbiB0byBjaGVjayBpZiB0d28gb2JqZWN0cyBhcmUgZXF1YWwuCiAgXy5pc0VxdWFsID0gZnVuY3Rpb24oYSwgYikgewogICAgcmV0dXJuIGVxKGEsIGIsIFtdLCBbXSk7CiAgfTsKCiAgLy8gSXMgYSBnaXZlbiBhcnJheSwgc3RyaW5nLCBvciBvYmplY3QgZW1wdHk/CiAgLy8gQW4gImVtcHR5IiBvYmplY3QgaGFzIG5vIGVudW1lcmFibGUgb3duLXByb3BlcnRpZXMuCiAgXy5pc0VtcHR5ID0gZnVuY3Rpb24ob2JqKSB7CiAgICBpZiAob2JqID09IG51bGwpIHJldHVybiB0cnVlOwogICAgaWYgKF8uaXNBcnJheShvYmopIHx8IF8uaXNTdHJpbmcob2JqKSkgcmV0dXJuIG9iai5sZW5ndGggPT09IDA7CiAgICBmb3IgKHZhciBrZXkgaW4gb2JqKSBpZiAoXy5oYXMob2JqLCBrZXkpKSByZXR1cm4gZmFsc2U7CiAgICByZXR1cm4gdHJ1ZTsKICB9OwoKICAvLyBJcyBhIGdpdmVuIHZhbHVlIGEgRE9NIGVsZW1lbnQ/CiAgXy5pc0VsZW1lbnQgPSBmdW5jdGlvbihvYmopIHsKICAgIHJldHVybiAhIShvYmogJiYgb2JqLm5vZGVUeXBlID09PSAxKTsKICB9OwoKICAvLyBJcyBhIGdpdmVuIHZhbHVlIGFuIGFycmF5PwogIC8vIERlbGVnYXRlcyB0byBFQ01BNSdzIG5hdGl2ZSBBcnJheS5pc0FycmF5CiAgXy5pc0FycmF5ID0gbmF0aXZlSXNBcnJheSB8fCBmdW5jdGlvbihvYmopIHsKICAgIHJldHVybiB0b1N0cmluZy5jYWxsKG9iaikgPT0gJ1tvYmplY3QgQXJyYXldJzsKICB9OwoKICAvLyBJcyBhIGdpdmVuIHZhcmlhYmxlIGFuIG9iamVjdD8KICBfLmlzT2JqZWN0ID0gZnVuY3Rpb24ob2JqKSB7CiAgICByZXR1cm4gb2JqID09PSBPYmplY3Qob2JqKTsKICB9OwoKICAvLyBBZGQgc29tZSBpc1R5cGUgbWV0aG9kczogaXNBcmd1bWVudHMsIGlzRnVuY3Rpb24sIGlzU3RyaW5nLCBpc051bWJlciwgaXNEYXRlLCBpc1JlZ0V4cC4KICBlYWNoKFsnQXJndW1lbnRzJywgJ0Z1bmN0aW9uJywgJ1N0cmluZycsICdOdW1iZXInLCAnRGF0ZScsICdSZWdFeHAnXSwgZnVuY3Rpb24obmFtZSkgewogICAgX1snaXMnICsgbmFtZV0gPSBmdW5jdGlvbihvYmopIHsKICAgICAgcmV0dXJuIHRvU3RyaW5nLmNhbGwob2JqKSA9PSAnW29iamVjdCAnICsgbmFtZSArICddJzsKICAgIH07CiAgfSk7CgogIC8vIERlZmluZSBhIGZhbGxiYWNrIHZlcnNpb24gb2YgdGhlIG1ldGhvZCBpbiBicm93c2VycyAoYWhlbSwgSUUpLCB3aGVyZQogIC8vIHRoZXJlIGlzbid0IGFueSBpbnNwZWN0YWJsZSAiQXJndW1lbnRzIiB0eXBlLgogIGlmICghXy5pc0FyZ3VtZW50cyhhcmd1bWVudHMpKSB7CiAgICBfLmlzQXJndW1lbnRzID0gZnVuY3Rpb24ob2JqKSB7CiAgICAgIHJldHVybiAhIShvYmogJiYgXy5oYXMob2JqLCAnY2FsbGVlJykpOwogICAgfTsKICB9CgogIC8vIE9wdGltaXplIGBpc0Z1bmN0aW9uYCBpZiBhcHByb3ByaWF0ZS4KICBpZiAodHlwZW9mICgvLi8pICE9PSAnZnVuY3Rpb24nKSB7CiAgICBfLmlzRnVuY3Rpb24gPSBmdW5jdGlvbihvYmopIHsKICAgICAgcmV0dXJuIHR5cGVvZiBvYmogPT09ICdmdW5jdGlvbic7CiAgICB9OwogIH0KCiAgLy8gSXMgYSBnaXZlbiBvYmplY3QgYSBmaW5pdGUgbnVtYmVyPwogIF8uaXNGaW5pdGUgPSBmdW5jdGlvbihvYmopIHsKICAgIHJldHVybiBpc0Zpbml0ZShvYmopICYmICFpc05hTihwYXJzZUZsb2F0KG9iaikpOwogIH07CgogIC8vIElzIHRoZSBnaXZlbiB2YWx1ZSBgTmFOYD8gKE5hTiBpcyB0aGUgb25seSBudW1iZXIgd2hpY2ggZG9lcyBub3QgZXF1YWwgaXRzZWxmKS4KICBfLmlzTmFOID0gZnVuY3Rpb24ob2JqKSB7CiAgICByZXR1cm4gXy5pc051bWJlcihvYmopICYmIG9iaiAhPSArb2JqOwogIH07CgogIC8vIElzIGEgZ2l2ZW4gdmFsdWUgYSBib29sZWFuPwogIF8uaXNCb29sZWFuID0gZnVuY3Rpb24ob2JqKSB7CiAgICByZXR1cm4gb2JqID09PSB0cnVlIHx8IG9iaiA9PT0gZmFsc2UgfHwgdG9TdHJpbmcuY2FsbChvYmopID09ICdbb2JqZWN0IEJvb2xlYW5dJzsKICB9OwoKICAvLyBJcyBhIGdpdmVuIHZhbHVlIGVxdWFsIHRvIG51bGw/CiAgXy5pc051bGwgPSBmdW5jdGlvbihvYmopIHsKICAgIHJldHVybiBvYmogPT09IG51bGw7CiAgfTsKCiAgLy8gSXMgYSBnaXZlbiB2YXJpYWJsZSB1bmRlZmluZWQ/CiAgXy5pc1VuZGVmaW5lZCA9IGZ1bmN0aW9uKG9iaikgewogICAgcmV0dXJuIG9iaiA9PT0gdm9pZCAwOwogIH07CgogIC8vIFNob3J0Y3V0IGZ1bmN0aW9uIGZvciBjaGVja2luZyBpZiBhbiBvYmplY3QgaGFzIGEgZ2l2ZW4gcHJvcGVydHkgZGlyZWN0bHkKICAvLyBvbiBpdHNlbGYgKGluIG90aGVyIHdvcmRzLCBub3Qgb24gYSBwcm90b3R5cGUpLgogIF8uaGFzID0gZnVuY3Rpb24ob2JqLCBrZXkpIHsKICAgIHJldHVybiBoYXNPd25Qcm9wZXJ0eS5jYWxsKG9iaiwga2V5KTsKICB9OwoKICAvLyBVdGlsaXR5IEZ1bmN0aW9ucwogIC8vIC0tLS0tLS0tLS0tLS0tLS0tCgogIC8vIFJ1biBVbmRlcnNjb3JlLmpzIGluICpub0NvbmZsaWN0KiBtb2RlLCByZXR1cm5pbmcgdGhlIGBfYCB2YXJpYWJsZSB0byBpdHMKICAvLyBwcmV2aW91cyBvd25lci4gUmV0dXJucyBhIHJlZmVyZW5jZSB0byB0aGUgVW5kZXJzY29yZSBvYmplY3QuCiAgXy5ub0NvbmZsaWN0ID0gZnVuY3Rpb24oKSB7CiAgICByb290Ll8gPSBwcmV2aW91c1VuZGVyc2NvcmU7CiAgICByZXR1cm4gdGhpczsKICB9OwoKICAvLyBLZWVwIHRoZSBpZGVudGl0eSBmdW5jdGlvbiBhcm91bmQgZm9yIGRlZmF1bHQgaXRlcmF0b3JzLgogIF8uaWRlbnRpdHkgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgcmV0dXJuIHZhbHVlOwogIH07CgogIC8vIFJ1biBhIGZ1bmN0aW9uICoqbioqIHRpbWVzLgogIF8udGltZXMgPSBmdW5jdGlvbihuLCBpdGVyYXRvciwgY29udGV4dCkgewogICAgdmFyIGFjY3VtID0gQXJyYXkobik7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IG47IGkrKykgYWNjdW1baV0gPSBpdGVyYXRvci5jYWxsKGNvbnRleHQsIGkpOwogICAgcmV0dXJuIGFjY3VtOwogIH07CgogIC8vIFJldHVybiBhIHJhbmRvbSBpbnRlZ2VyIGJldHdlZW4gbWluIGFuZCBtYXggKGluY2x1c2l2ZSkuCiAgXy5yYW5kb20gPSBmdW5jdGlvbihtaW4sIG1heCkgewogICAgaWYgKG1heCA9PSBudWxsKSB7CiAgICAgIG1heCA9IG1pbjsKICAgICAgbWluID0gMDsKICAgIH0KICAgIHJldHVybiBtaW4gKyBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiAobWF4IC0gbWluICsgMSkpOwogIH07CgogIC8vIExpc3Qgb2YgSFRNTCBlbnRpdGllcyBmb3IgZXNjYXBpbmcuCiAgdmFyIGVudGl0eU1hcCA9IHsKICAgIGVzY2FwZTogewogICAgICAnJic6ICcmYW1wOycsCiAgICAgICc8JzogJyZsdDsnLAogICAgICAnPic6ICcmZ3Q7JywKICAgICAgJyInOiAnJnF1b3Q7JywKICAgICAgIiciOiAnJiN4Mjc7JywKICAgICAgJy8nOiAnJiN4MkY7JwogICAgfQogIH07CiAgZW50aXR5TWFwLnVuZXNjYXBlID0gXy5pbnZlcnQoZW50aXR5TWFwLmVzY2FwZSk7CgogIC8vIFJlZ2V4ZXMgY29udGFpbmluZyB0aGUga2V5cyBhbmQgdmFsdWVzIGxpc3RlZCBpbW1lZGlhdGVseSBhYm92ZS4KICB2YXIgZW50aXR5UmVnZXhlcyA9IHsKICAgIGVzY2FwZTogICBuZXcgUmVnRXhwKCdbJyArIF8ua2V5cyhlbnRpdHlNYXAuZXNjYXBlKS5qb2luKCcnKSArICddJywgJ2cnKSwKICAgIHVuZXNjYXBlOiBuZXcgUmVnRXhwKCcoJyArIF8ua2V5cyhlbnRpdHlNYXAudW5lc2NhcGUpLmpvaW4oJ3wnKSArICcpJywgJ2cnKQogIH07CgogIC8vIEZ1bmN0aW9ucyBmb3IgZXNjYXBpbmcgYW5kIHVuZXNjYXBpbmcgc3RyaW5ncyB0by9mcm9tIEhUTUwgaW50ZXJwb2xhdGlvbi4KICBfLmVhY2goWydlc2NhcGUnLCAndW5lc2NhcGUnXSwgZnVuY3Rpb24obWV0aG9kKSB7CiAgICBfW21ldGhvZF0gPSBmdW5jdGlvbihzdHJpbmcpIHsKICAgICAgaWYgKHN0cmluZyA9PSBudWxsKSByZXR1cm4gJyc7CiAgICAgIHJldHVybiAoJycgKyBzdHJpbmcpLnJlcGxhY2UoZW50aXR5UmVnZXhlc1ttZXRob2RdLCBmdW5jdGlvbihtYXRjaCkgewogICAgICAgIHJldHVybiBlbnRpdHlNYXBbbWV0aG9kXVttYXRjaF07CiAgICAgIH0pOwogICAgfTsKICB9KTsKCiAgLy8gSWYgdGhlIHZhbHVlIG9mIHRoZSBuYW1lZCBwcm9wZXJ0eSBpcyBhIGZ1bmN0aW9uIHRoZW4gaW52b2tlIGl0OwogIC8vIG90aGVyd2lzZSwgcmV0dXJuIGl0LgogIF8ucmVzdWx0ID0gZnVuY3Rpb24ob2JqZWN0LCBwcm9wZXJ0eSkgewogICAgaWYgKG9iamVjdCA9PSBudWxsKSByZXR1cm4gbnVsbDsKICAgIHZhciB2YWx1ZSA9IG9iamVjdFtwcm9wZXJ0eV07CiAgICByZXR1cm4gXy5pc0Z1bmN0aW9uKHZhbHVlKSA/IHZhbHVlLmNhbGwob2JqZWN0KSA6IHZhbHVlOwogIH07CgogIC8vIEFkZCB5b3VyIG93biBjdXN0b20gZnVuY3Rpb25zIHRvIHRoZSBVbmRlcnNjb3JlIG9iamVjdC4KICBfLm1peGluID0gZnVuY3Rpb24ob2JqKSB7CiAgICBlYWNoKF8uZnVuY3Rpb25zKG9iaiksIGZ1bmN0aW9uKG5hbWUpewogICAgICB2YXIgZnVuYyA9IF9bbmFtZV0gPSBvYmpbbmFtZV07CiAgICAgIF8ucHJvdG90eXBlW25hbWVdID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIGFyZ3MgPSBbdGhpcy5fd3JhcHBlZF07CiAgICAgICAgcHVzaC5hcHBseShhcmdzLCBhcmd1bWVudHMpOwogICAgICAgIHJldHVybiByZXN1bHQuY2FsbCh0aGlzLCBmdW5jLmFwcGx5KF8sIGFyZ3MpKTsKICAgICAgfTsKICAgIH0pOwogIH07CgogIC8vIEdlbmVyYXRlIGEgdW5pcXVlIGludGVnZXIgaWQgKHVuaXF1ZSB3aXRoaW4gdGhlIGVudGlyZSBjbGllbnQgc2Vzc2lvbikuCiAgLy8gVXNlZnVsIGZvciB0ZW1wb3JhcnkgRE9NIGlkcy4KICB2YXIgaWRDb3VudGVyID0gMDsKICBfLnVuaXF1ZUlkID0gZnVuY3Rpb24ocHJlZml4KSB7CiAgICB2YXIgaWQgPSArK2lkQ291bnRlciArICcnOwogICAgcmV0dXJuIHByZWZpeCA/IHByZWZpeCArIGlkIDogaWQ7CiAgfTsKCiAgLy8gQnkgZGVmYXVsdCwgVW5kZXJzY29yZSB1c2VzIEVSQi1zdHlsZSB0ZW1wbGF0ZSBkZWxpbWl0ZXJzLCBjaGFuZ2UgdGhlCiAgLy8gZm9sbG93aW5nIHRlbXBsYXRlIHNldHRpbmdzIHRvIHVzZSBhbHRlcm5hdGl2ZSBkZWxpbWl0ZXJzLgogIF8udGVtcGxhdGVTZXR0aW5ncyA9IHsKICAgIGV2YWx1YXRlICAgIDogLzwlKFtcc1xTXSs/KSU+L2csCiAgICBpbnRlcnBvbGF0ZSA6IC88JT0oW1xzXFNdKz8pJT4vZywKICAgIGVzY2FwZSAgICAgIDogLzwlLShbXHNcU10rPyklPi9nCiAgfTsKCiAgLy8gV2hlbiBjdXN0b21pemluZyBgdGVtcGxhdGVTZXR0aW5nc2AsIGlmIHlvdSBkb24ndCB3YW50IHRvIGRlZmluZSBhbgogIC8vIGludGVycG9sYXRpb24sIGV2YWx1YXRpb24gb3IgZXNjYXBpbmcgcmVnZXgsIHdlIG5lZWQgb25lIHRoYXQgaXMKICAvLyBndWFyYW50ZWVkIG5vdCB0byBtYXRjaC4KICB2YXIgbm9NYXRjaCA9IC8oLileLzsKCiAgLy8gQ2VydGFpbiBjaGFyYWN0ZXJzIG5lZWQgdG8gYmUgZXNjYXBlZCBzbyB0aGF0IHRoZXkgY2FuIGJlIHB1dCBpbnRvIGEKICAvLyBzdHJpbmcgbGl0ZXJhbC4KICB2YXIgZXNjYXBlcyA9IHsKICAgICInIjogICAgICAiJyIsCiAgICAnXFwnOiAgICAgJ1xcJywKICAgICdccic6ICAgICAncicsCiAgICAnXG4nOiAgICAgJ24nLAogICAgJ1x0JzogICAgICd0JywKICAgICdcdTIwMjgnOiAndTIwMjgnLAogICAgJ1x1MjAyOSc6ICd1MjAyOScKICB9OwoKICB2YXIgZXNjYXBlciA9IC9cXHwnfFxyfFxufFx0fFx1MjAyOHxcdTIwMjkvZzsKCiAgLy8gSmF2YVNjcmlwdCBtaWNyby10ZW1wbGF0aW5nLCBzaW1pbGFyIHRvIEpvaG4gUmVzaWcncyBpbXBsZW1lbnRhdGlvbi4KICAvLyBVbmRlcnNjb3JlIHRlbXBsYXRpbmcgaGFuZGxlcyBhcmJpdHJhcnkgZGVsaW1pdGVycywgcHJlc2VydmVzIHdoaXRlc3BhY2UsCiAgLy8gYW5kIGNvcnJlY3RseSBlc2NhcGVzIHF1b3RlcyB3aXRoaW4gaW50ZXJwb2xhdGVkIGNvZGUuCiAgXy50ZW1wbGF0ZSA9IGZ1bmN0aW9uKHRleHQsIGRhdGEsIHNldHRpbmdzKSB7CiAgICB2YXIgcmVuZGVyOwogICAgc2V0dGluZ3MgPSBfLmRlZmF1bHRzKHt9LCBzZXR0aW5ncywgXy50ZW1wbGF0ZVNldHRpbmdzKTsKCiAgICAvLyBDb21iaW5lIGRlbGltaXRlcnMgaW50byBvbmUgcmVndWxhciBleHByZXNzaW9uIHZpYSBhbHRlcm5hdGlvbi4KICAgIHZhciBtYXRjaGVyID0gbmV3IFJlZ0V4cChbCiAgICAgIChzZXR0aW5ncy5lc2NhcGUgfHwgbm9NYXRjaCkuc291cmNlLAogICAgICAoc2V0dGluZ3MuaW50ZXJwb2xhdGUgfHwgbm9NYXRjaCkuc291cmNlLAogICAgICAoc2V0dGluZ3MuZXZhbHVhdGUgfHwgbm9NYXRjaCkuc291cmNlCiAgICBdLmpvaW4oJ3wnKSArICd8JCcsICdnJyk7CgogICAgLy8gQ29tcGlsZSB0aGUgdGVtcGxhdGUgc291cmNlLCBlc2NhcGluZyBzdHJpbmcgbGl0ZXJhbHMgYXBwcm9wcmlhdGVseS4KICAgIHZhciBpbmRleCA9IDA7CiAgICB2YXIgc291cmNlID0gIl9fcCs9JyI7CiAgICB0ZXh0LnJlcGxhY2UobWF0Y2hlciwgZnVuY3Rpb24obWF0Y2gsIGVzY2FwZSwgaW50ZXJwb2xhdGUsIGV2YWx1YXRlLCBvZmZzZXQpIHsKICAgICAgc291cmNlICs9IHRleHQuc2xpY2UoaW5kZXgsIG9mZnNldCkKICAgICAgICAucmVwbGFjZShlc2NhcGVyLCBmdW5jdGlvbihtYXRjaCkgeyByZXR1cm4gJ1xcJyArIGVzY2FwZXNbbWF0Y2hdOyB9KTsKCiAgICAgIGlmIChlc2NhcGUpIHsKICAgICAgICBzb3VyY2UgKz0gIicrXG4oKF9fdD0oIiArIGVzY2FwZSArICIpKT09bnVsbD8nJzpfLmVzY2FwZShfX3QpKStcbiciOwogICAgICB9CiAgICAgIGlmIChpbnRlcnBvbGF0ZSkgewogICAgICAgIHNvdXJjZSArPSAiJytcbigoX190PSgiICsgaW50ZXJwb2xhdGUgKyAiKSk9PW51bGw/Jyc6X190KStcbiciOwogICAgICB9CiAgICAgIGlmIChldmFsdWF0ZSkgewogICAgICAgIHNvdXJjZSArPSAiJztcbiIgKyBldmFsdWF0ZSArICJcbl9fcCs9JyI7CiAgICAgIH0KICAgICAgaW5kZXggPSBvZmZzZXQgKyBtYXRjaC5sZW5ndGg7CiAgICAgIHJldHVybiBtYXRjaDsKICAgIH0pOwogICAgc291cmNlICs9ICInO1xuIjsKCiAgICAvLyBJZiBhIHZhcmlhYmxlIGlzIG5vdCBzcGVjaWZpZWQsIHBsYWNlIGRhdGEgdmFsdWVzIGluIGxvY2FsIHNjb3BlLgogICAgaWYgKCFzZXR0aW5ncy52YXJpYWJsZSkgc291cmNlID0gJ3dpdGgob2JqfHx7fSl7XG4nICsgc291cmNlICsgJ31cbic7CgogICAgc291cmNlID0gInZhciBfX3QsX19wPScnLF9faj1BcnJheS5wcm90b3R5cGUuam9pbiwiICsKICAgICAgInByaW50PWZ1bmN0aW9uKCl7X19wKz1fX2ouY2FsbChhcmd1bWVudHMsJycpO307XG4iICsKICAgICAgc291cmNlICsgInJldHVybiBfX3A7XG4iOwoKICAgIHRyeSB7CiAgICAgIHJlbmRlciA9IG5ldyBGdW5jdGlvbihzZXR0aW5ncy52YXJpYWJsZSB8fCAnb2JqJywgJ18nLCBzb3VyY2UpOwogICAgfSBjYXRjaCAoZSkgewogICAgICBlLnNvdXJjZSA9IHNvdXJjZTsKICAgICAgdGhyb3cgZTsKICAgIH0KCiAgICBpZiAoZGF0YSkgcmV0dXJuIHJlbmRlcihkYXRhLCBfKTsKICAgIHZhciB0ZW1wbGF0ZSA9IGZ1bmN0aW9uKGRhdGEpIHsKICAgICAgcmV0dXJuIHJlbmRlci5jYWxsKHRoaXMsIGRhdGEsIF8pOwogICAgfTsKCiAgICAvLyBQcm92aWRlIHRoZSBjb21waWxlZCBmdW5jdGlvbiBzb3VyY2UgYXMgYSBjb252ZW5pZW5jZSBmb3IgcHJlY29tcGlsYXRpb24uCiAgICB0ZW1wbGF0ZS5zb3VyY2UgPSAnZnVuY3Rpb24oJyArIChzZXR0aW5ncy52YXJpYWJsZSB8fCAnb2JqJykgKyAnKXtcbicgKyBzb3VyY2UgKyAnfSc7CgogICAgcmV0dXJuIHRlbXBsYXRlOwogIH07CgogIC8vIEFkZCBhICJjaGFpbiIgZnVuY3Rpb24sIHdoaWNoIHdpbGwgZGVsZWdhdGUgdG8gdGhlIHdyYXBwZXIuCiAgXy5jaGFpbiA9IGZ1bmN0aW9uKG9iaikgewogICAgcmV0dXJuIF8ob2JqKS5jaGFpbigpOwogIH07CgogIC8vIE9PUAogIC8vIC0tLS0tLS0tLS0tLS0tLQogIC8vIElmIFVuZGVyc2NvcmUgaXMgY2FsbGVkIGFzIGEgZnVuY3Rpb24sIGl0IHJldHVybnMgYSB3cmFwcGVkIG9iamVjdCB0aGF0CiAgLy8gY2FuIGJlIHVzZWQgT08tc3R5bGUuIFRoaXMgd3JhcHBlciBob2xkcyBhbHRlcmVkIHZlcnNpb25zIG9mIGFsbCB0aGUKICAvLyB1bmRlcnNjb3JlIGZ1bmN0aW9ucy4gV3JhcHBlZCBvYmplY3RzIG1heSBiZSBjaGFpbmVkLgoKICAvLyBIZWxwZXIgZnVuY3Rpb24gdG8gY29udGludWUgY2hhaW5pbmcgaW50ZXJtZWRpYXRlIHJlc3VsdHMuCiAgdmFyIHJlc3VsdCA9IGZ1bmN0aW9uKG9iaikgewogICAgcmV0dXJuIHRoaXMuX2NoYWluID8gXyhvYmopLmNoYWluKCkgOiBvYmo7CiAgfTsKCiAgLy8gQWRkIGFsbCBvZiB0aGUgVW5kZXJzY29yZSBmdW5jdGlvbnMgdG8gdGhlIHdyYXBwZXIgb2JqZWN0LgogIF8ubWl4aW4oXyk7CgogIC8vIEFkZCBhbGwgbXV0YXRvciBBcnJheSBmdW5jdGlvbnMgdG8gdGhlIHdyYXBwZXIuCiAgZWFjaChbJ3BvcCcsICdwdXNoJywgJ3JldmVyc2UnLCAnc2hpZnQnLCAnc29ydCcsICdzcGxpY2UnLCAndW5zaGlmdCddLCBmdW5jdGlvbihuYW1lKSB7CiAgICB2YXIgbWV0aG9kID0gQXJyYXlQcm90b1tuYW1lXTsKICAgIF8ucHJvdG90eXBlW25hbWVdID0gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBvYmogPSB0aGlzLl93cmFwcGVkOwogICAgICBtZXRob2QuYXBwbHkob2JqLCBhcmd1bWVudHMpOwogICAgICBpZiAoKG5hbWUgPT0gJ3NoaWZ0JyB8fCBuYW1lID09ICdzcGxpY2UnKSAmJiBvYmoubGVuZ3RoID09PSAwKSBkZWxldGUgb2JqWzBdOwogICAgICByZXR1cm4gcmVzdWx0LmNhbGwodGhpcywgb2JqKTsKICAgIH07CiAgfSk7CgogIC8vIEFkZCBhbGwgYWNjZXNzb3IgQXJyYXkgZnVuY3Rpb25zIHRvIHRoZSB3cmFwcGVyLgogIGVhY2goWydjb25jYXQnLCAnam9pbicsICdzbGljZSddLCBmdW5jdGlvbihuYW1lKSB7CiAgICB2YXIgbWV0aG9kID0gQXJyYXlQcm90b1tuYW1lXTsKICAgIF8ucHJvdG90eXBlW25hbWVdID0gZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiByZXN1bHQuY2FsbCh0aGlzLCBtZXRob2QuYXBwbHkodGhpcy5fd3JhcHBlZCwgYXJndW1lbnRzKSk7CiAgICB9OwogIH0pOwoKICBfLmV4dGVuZChfLnByb3RvdHlwZSwgewoKICAgIC8vIFN0YXJ0IGNoYWluaW5nIGEgd3JhcHBlZCBVbmRlcnNjb3JlIG9iamVjdC4KICAgIGNoYWluOiBmdW5jdGlvbigpIHsKICAgICAgdGhpcy5fY2hhaW4gPSB0cnVlOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gRXh0cmFjdHMgdGhlIHJlc3VsdCBmcm9tIGEgd3JhcHBlZCBhbmQgY2hhaW5lZCBvYmplY3QuCiAgICB2YWx1ZTogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB0aGlzLl93cmFwcGVkOwogICAgfQoKICB9KTsKCn0pLmNhbGwodGhpcyk7CgpkZWZpbmUoInVuZGVyc2NvcmUiLCAoZnVuY3Rpb24gKGdsb2JhbCkgewogICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgcmV0LCBmbjsKICAgICAgICByZXR1cm4gcmV0IHx8IGdsb2JhbC5fOwogICAgfTsKfSh0aGlzKSkpOwoKLy8gICAgIEJhY2tib25lLmpzIDEuMC4wCgovLyAgICAgKGMpIDIwMTAtMjAxMyBKZXJlbXkgQXNoa2VuYXMsIERvY3VtZW50Q2xvdWQgSW5jLgovLyAgICAgQmFja2JvbmUgbWF5IGJlIGZyZWVseSBkaXN0cmlidXRlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuCi8vICAgICBGb3IgYWxsIGRldGFpbHMgYW5kIGRvY3VtZW50YXRpb246Ci8vICAgICBodHRwOi8vYmFja2JvbmVqcy5vcmcKCihmdW5jdGlvbigpewoKICAvLyBJbml0aWFsIFNldHVwCiAgLy8gLS0tLS0tLS0tLS0tLQoKICAvLyBTYXZlIGEgcmVmZXJlbmNlIHRvIHRoZSBnbG9iYWwgb2JqZWN0IChgd2luZG93YCBpbiB0aGUgYnJvd3NlciwgYGV4cG9ydHNgCiAgLy8gb24gdGhlIHNlcnZlcikuCiAgdmFyIHJvb3QgPSB0aGlzOwoKICAvLyBTYXZlIHRoZSBwcmV2aW91cyB2YWx1ZSBvZiB0aGUgYEJhY2tib25lYCB2YXJpYWJsZSwgc28gdGhhdCBpdCBjYW4gYmUKICAvLyByZXN0b3JlZCBsYXRlciBvbiwgaWYgYG5vQ29uZmxpY3RgIGlzIHVzZWQuCiAgdmFyIHByZXZpb3VzQmFja2JvbmUgPSByb290LkJhY2tib25lOwoKICAvLyBDcmVhdGUgbG9jYWwgcmVmZXJlbmNlcyB0byBhcnJheSBtZXRob2RzIHdlJ2xsIHdhbnQgdG8gdXNlIGxhdGVyLgogIHZhciBhcnJheSA9IFtdOwogIHZhciBwdXNoID0gYXJyYXkucHVzaDsKICB2YXIgc2xpY2UgPSBhcnJheS5zbGljZTsKICB2YXIgc3BsaWNlID0gYXJyYXkuc3BsaWNlOwoKICAvLyBUaGUgdG9wLWxldmVsIG5hbWVzcGFjZS4gQWxsIHB1YmxpYyBCYWNrYm9uZSBjbGFzc2VzIGFuZCBtb2R1bGVzIHdpbGwKICAvLyBiZSBhdHRhY2hlZCB0byB0aGlzLiBFeHBvcnRlZCBmb3IgYm90aCB0aGUgYnJvd3NlciBhbmQgdGhlIHNlcnZlci4KICB2YXIgQmFja2JvbmU7CiAgaWYgKHR5cGVvZiBleHBvcnRzICE9PSAndW5kZWZpbmVkJykgewogICAgQmFja2JvbmUgPSBleHBvcnRzOwogIH0gZWxzZSB7CiAgICBCYWNrYm9uZSA9IHJvb3QuQmFja2JvbmUgPSB7fTsKICB9CgogIC8vIEN1cnJlbnQgdmVyc2lvbiBvZiB0aGUgbGlicmFyeS4gS2VlcCBpbiBzeW5jIHdpdGggYHBhY2thZ2UuanNvbmAuCiAgQmFja2JvbmUuVkVSU0lPTiA9ICcxLjAuMCc7CgogIC8vIFJlcXVpcmUgVW5kZXJzY29yZSwgaWYgd2UncmUgb24gdGhlIHNlcnZlciwgYW5kIGl0J3Mgbm90IGFscmVhZHkgcHJlc2VudC4KICB2YXIgXyA9IHJvb3QuXzsKICBpZiAoIV8gJiYgKHR5cGVvZiByZXF1aXJlICE9PSAndW5kZWZpbmVkJykpIF8gPSByZXF1aXJlKCd1bmRlcnNjb3JlJyk7CgogIC8vIEZvciBCYWNrYm9uZSdzIHB1cnBvc2VzLCBqUXVlcnksIFplcHRvLCBFbmRlciwgb3IgTXkgTGlicmFyeSAoa2lkZGluZykgb3ducwogIC8vIHRoZSBgJGAgdmFyaWFibGUuCiAgQmFja2JvbmUuJCA9IHJvb3QualF1ZXJ5IHx8IHJvb3QuWmVwdG8gfHwgcm9vdC5lbmRlciB8fCByb290LiQ7CgogIC8vIFJ1bnMgQmFja2JvbmUuanMgaW4gKm5vQ29uZmxpY3QqIG1vZGUsIHJldHVybmluZyB0aGUgYEJhY2tib25lYCB2YXJpYWJsZQogIC8vIHRvIGl0cyBwcmV2aW91cyBvd25lci4gUmV0dXJucyBhIHJlZmVyZW5jZSB0byB0aGlzIEJhY2tib25lIG9iamVjdC4KICBCYWNrYm9uZS5ub0NvbmZsaWN0ID0gZnVuY3Rpb24oKSB7CiAgICByb290LkJhY2tib25lID0gcHJldmlvdXNCYWNrYm9uZTsKICAgIHJldHVybiB0aGlzOwogIH07CgogIC8vIFR1cm4gb24gYGVtdWxhdGVIVFRQYCB0byBzdXBwb3J0IGxlZ2FjeSBIVFRQIHNlcnZlcnMuIFNldHRpbmcgdGhpcyBvcHRpb24KICAvLyB3aWxsIGZha2UgYCJQVVQiYCBhbmQgYCJERUxFVEUiYCByZXF1ZXN0cyB2aWEgdGhlIGBfbWV0aG9kYCBwYXJhbWV0ZXIgYW5kCiAgLy8gc2V0IGEgYFgtSHR0cC1NZXRob2QtT3ZlcnJpZGVgIGhlYWRlci4KICBCYWNrYm9uZS5lbXVsYXRlSFRUUCA9IGZhbHNlOwoKICAvLyBUdXJuIG9uIGBlbXVsYXRlSlNPTmAgdG8gc3VwcG9ydCBsZWdhY3kgc2VydmVycyB0aGF0IGNhbid0IGRlYWwgd2l0aCBkaXJlY3QKICAvLyBgYXBwbGljYXRpb24vanNvbmAgcmVxdWVzdHMgLi4uIHdpbGwgZW5jb2RlIHRoZSBib2R5IGFzCiAgLy8gYGFwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZGAgaW5zdGVhZCBhbmQgd2lsbCBzZW5kIHRoZSBtb2RlbCBpbiBhCiAgLy8gZm9ybSBwYXJhbSBuYW1lZCBgbW9kZWxgLgogIEJhY2tib25lLmVtdWxhdGVKU09OID0gZmFsc2U7CgogIC8vIEJhY2tib25lLkV2ZW50cwogIC8vIC0tLS0tLS0tLS0tLS0tLQoKICAvLyBBIG1vZHVsZSB0aGF0IGNhbiBiZSBtaXhlZCBpbiB0byAqYW55IG9iamVjdCogaW4gb3JkZXIgdG8gcHJvdmlkZSBpdCB3aXRoCiAgLy8gY3VzdG9tIGV2ZW50cy4gWW91IG1heSBiaW5kIHdpdGggYG9uYCBvciByZW1vdmUgd2l0aCBgb2ZmYCBjYWxsYmFjawogIC8vIGZ1bmN0aW9ucyB0byBhbiBldmVudDsgYHRyaWdnZXJgLWluZyBhbiBldmVudCBmaXJlcyBhbGwgY2FsbGJhY2tzIGluCiAgLy8gc3VjY2Vzc2lvbi4KICAvLwogIC8vICAgICB2YXIgb2JqZWN0ID0ge307CiAgLy8gICAgIF8uZXh0ZW5kKG9iamVjdCwgQmFja2JvbmUuRXZlbnRzKTsKICAvLyAgICAgb2JqZWN0Lm9uKCdleHBhbmQnLCBmdW5jdGlvbigpeyBhbGVydCgnZXhwYW5kZWQnKTsgfSk7CiAgLy8gICAgIG9iamVjdC50cmlnZ2VyKCdleHBhbmQnKTsKICAvLwogIHZhciBFdmVudHMgPSBCYWNrYm9uZS5FdmVudHMgPSB7CgogICAgLy8gQmluZCBhbiBldmVudCB0byBhIGBjYWxsYmFja2AgZnVuY3Rpb24uIFBhc3NpbmcgYCJhbGwiYCB3aWxsIGJpbmQKICAgIC8vIHRoZSBjYWxsYmFjayB0byBhbGwgZXZlbnRzIGZpcmVkLgogICAgb246IGZ1bmN0aW9uKG5hbWUsIGNhbGxiYWNrLCBjb250ZXh0KSB7CiAgICAgIGlmICghZXZlbnRzQXBpKHRoaXMsICdvbicsIG5hbWUsIFtjYWxsYmFjaywgY29udGV4dF0pIHx8ICFjYWxsYmFjaykgcmV0dXJuIHRoaXM7CiAgICAgIHRoaXMuX2V2ZW50cyB8fCAodGhpcy5fZXZlbnRzID0ge30pOwogICAgICB2YXIgZXZlbnRzID0gdGhpcy5fZXZlbnRzW25hbWVdIHx8ICh0aGlzLl9ldmVudHNbbmFtZV0gPSBbXSk7CiAgICAgIGV2ZW50cy5wdXNoKHtjYWxsYmFjazogY2FsbGJhY2ssIGNvbnRleHQ6IGNvbnRleHQsIGN0eDogY29udGV4dCB8fCB0aGlzfSk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBCaW5kIGFuIGV2ZW50IHRvIG9ubHkgYmUgdHJpZ2dlcmVkIGEgc2luZ2xlIHRpbWUuIEFmdGVyIHRoZSBmaXJzdCB0aW1lCiAgICAvLyB0aGUgY2FsbGJhY2sgaXMgaW52b2tlZCwgaXQgd2lsbCBiZSByZW1vdmVkLgogICAgb25jZTogZnVuY3Rpb24obmFtZSwgY2FsbGJhY2ssIGNvbnRleHQpIHsKICAgICAgaWYgKCFldmVudHNBcGkodGhpcywgJ29uY2UnLCBuYW1lLCBbY2FsbGJhY2ssIGNvbnRleHRdKSB8fCAhY2FsbGJhY2spIHJldHVybiB0aGlzOwogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIHZhciBvbmNlID0gXy5vbmNlKGZ1bmN0aW9uKCkgewogICAgICAgIHNlbGYub2ZmKG5hbWUsIG9uY2UpOwogICAgICAgIGNhbGxiYWNrLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIH0pOwogICAgICBvbmNlLl9jYWxsYmFjayA9IGNhbGxiYWNrOwogICAgICByZXR1cm4gdGhpcy5vbihuYW1lLCBvbmNlLCBjb250ZXh0KTsKICAgIH0sCgogICAgLy8gUmVtb3ZlIG9uZSBvciBtYW55IGNhbGxiYWNrcy4gSWYgYGNvbnRleHRgIGlzIG51bGwsIHJlbW92ZXMgYWxsCiAgICAvLyBjYWxsYmFja3Mgd2l0aCB0aGF0IGZ1bmN0aW9uLiBJZiBgY2FsbGJhY2tgIGlzIG51bGwsIHJlbW92ZXMgYWxsCiAgICAvLyBjYWxsYmFja3MgZm9yIHRoZSBldmVudC4gSWYgYG5hbWVgIGlzIG51bGwsIHJlbW92ZXMgYWxsIGJvdW5kCiAgICAvLyBjYWxsYmFja3MgZm9yIGFsbCBldmVudHMuCiAgICBvZmY6IGZ1bmN0aW9uKG5hbWUsIGNhbGxiYWNrLCBjb250ZXh0KSB7CiAgICAgIHZhciByZXRhaW4sIGV2LCBldmVudHMsIG5hbWVzLCBpLCBsLCBqLCBrOwogICAgICBpZiAoIXRoaXMuX2V2ZW50cyB8fCAhZXZlbnRzQXBpKHRoaXMsICdvZmYnLCBuYW1lLCBbY2FsbGJhY2ssIGNvbnRleHRdKSkgcmV0dXJuIHRoaXM7CiAgICAgIGlmICghbmFtZSAmJiAhY2FsbGJhY2sgJiYgIWNvbnRleHQpIHsKICAgICAgICB0aGlzLl9ldmVudHMgPSB7fTsKICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfQoKICAgICAgbmFtZXMgPSBuYW1lID8gW25hbWVdIDogXy5rZXlzKHRoaXMuX2V2ZW50cyk7CiAgICAgIGZvciAoaSA9IDAsIGwgPSBuYW1lcy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICBuYW1lID0gbmFtZXNbaV07CiAgICAgICAgaWYgKGV2ZW50cyA9IHRoaXMuX2V2ZW50c1tuYW1lXSkgewogICAgICAgICAgdGhpcy5fZXZlbnRzW25hbWVdID0gcmV0YWluID0gW107CiAgICAgICAgICBpZiAoY2FsbGJhY2sgfHwgY29udGV4dCkgewogICAgICAgICAgICBmb3IgKGogPSAwLCBrID0gZXZlbnRzLmxlbmd0aDsgaiA8IGs7IGorKykgewogICAgICAgICAgICAgIGV2ID0gZXZlbnRzW2pdOwogICAgICAgICAgICAgIGlmICgoY2FsbGJhY2sgJiYgY2FsbGJhY2sgIT09IGV2LmNhbGxiYWNrICYmIGNhbGxiYWNrICE9PSBldi5jYWxsYmFjay5fY2FsbGJhY2spIHx8CiAgICAgICAgICAgICAgICAgIChjb250ZXh0ICYmIGNvbnRleHQgIT09IGV2LmNvbnRleHQpKSB7CiAgICAgICAgICAgICAgICByZXRhaW4ucHVzaChldik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIXJldGFpbi5sZW5ndGgpIGRlbGV0ZSB0aGlzLl9ldmVudHNbbmFtZV07CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gVHJpZ2dlciBvbmUgb3IgbWFueSBldmVudHMsIGZpcmluZyBhbGwgYm91bmQgY2FsbGJhY2tzLiBDYWxsYmFja3MgYXJlCiAgICAvLyBwYXNzZWQgdGhlIHNhbWUgYXJndW1lbnRzIGFzIGB0cmlnZ2VyYCBpcywgYXBhcnQgZnJvbSB0aGUgZXZlbnQgbmFtZQogICAgLy8gKHVubGVzcyB5b3UncmUgbGlzdGVuaW5nIG9uIGAiYWxsImAsIHdoaWNoIHdpbGwgY2F1c2UgeW91ciBjYWxsYmFjayB0bwogICAgLy8gcmVjZWl2ZSB0aGUgdHJ1ZSBuYW1lIG9mIHRoZSBldmVudCBhcyB0aGUgZmlyc3QgYXJndW1lbnQpLgogICAgdHJpZ2dlcjogZnVuY3Rpb24obmFtZSkgewogICAgICBpZiAoIXRoaXMuX2V2ZW50cykgcmV0dXJuIHRoaXM7CiAgICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwogICAgICBpZiAoIWV2ZW50c0FwaSh0aGlzLCAndHJpZ2dlcicsIG5hbWUsIGFyZ3MpKSByZXR1cm4gdGhpczsKICAgICAgdmFyIGV2ZW50cyA9IHRoaXMuX2V2ZW50c1tuYW1lXTsKICAgICAgdmFyIGFsbEV2ZW50cyA9IHRoaXMuX2V2ZW50cy5hbGw7CiAgICAgIGlmIChldmVudHMpIHRyaWdnZXJFdmVudHMoZXZlbnRzLCBhcmdzKTsKICAgICAgaWYgKGFsbEV2ZW50cykgdHJpZ2dlckV2ZW50cyhhbGxFdmVudHMsIGFyZ3VtZW50cyk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBUZWxsIHRoaXMgb2JqZWN0IHRvIHN0b3AgbGlzdGVuaW5nIHRvIGVpdGhlciBzcGVjaWZpYyBldmVudHMgLi4uIG9yCiAgICAvLyB0byBldmVyeSBvYmplY3QgaXQncyBjdXJyZW50bHkgbGlzdGVuaW5nIHRvLgogICAgc3RvcExpc3RlbmluZzogZnVuY3Rpb24ob2JqLCBuYW1lLCBjYWxsYmFjaykgewogICAgICB2YXIgbGlzdGVuZXJzID0gdGhpcy5fbGlzdGVuZXJzOwogICAgICBpZiAoIWxpc3RlbmVycykgcmV0dXJuIHRoaXM7CiAgICAgIHZhciBkZWxldGVMaXN0ZW5lciA9ICFuYW1lICYmICFjYWxsYmFjazsKICAgICAgaWYgKHR5cGVvZiBuYW1lID09PSAnb2JqZWN0JykgY2FsbGJhY2sgPSB0aGlzOwogICAgICBpZiAob2JqKSAobGlzdGVuZXJzID0ge30pW29iai5fbGlzdGVuZXJJZF0gPSBvYmo7CiAgICAgIGZvciAodmFyIGlkIGluIGxpc3RlbmVycykgewogICAgICAgIGxpc3RlbmVyc1tpZF0ub2ZmKG5hbWUsIGNhbGxiYWNrLCB0aGlzKTsKICAgICAgICBpZiAoZGVsZXRlTGlzdGVuZXIpIGRlbGV0ZSB0aGlzLl9saXN0ZW5lcnNbaWRdOwogICAgICB9CiAgICAgIHJldHVybiB0aGlzOwogICAgfQoKICB9OwoKICAvLyBSZWd1bGFyIGV4cHJlc3Npb24gdXNlZCB0byBzcGxpdCBldmVudCBzdHJpbmdzLgogIHZhciBldmVudFNwbGl0dGVyID0gL1xzKy87CgogIC8vIEltcGxlbWVudCBmYW5jeSBmZWF0dXJlcyBvZiB0aGUgRXZlbnRzIEFQSSBzdWNoIGFzIG11bHRpcGxlIGV2ZW50CiAgLy8gbmFtZXMgYCJjaGFuZ2UgYmx1ciJgIGFuZCBqUXVlcnktc3R5bGUgZXZlbnQgbWFwcyBge2NoYW5nZTogYWN0aW9ufWAKICAvLyBpbiB0ZXJtcyBvZiB0aGUgZXhpc3RpbmcgQVBJLgogIHZhciBldmVudHNBcGkgPSBmdW5jdGlvbihvYmosIGFjdGlvbiwgbmFtZSwgcmVzdCkgewogICAgaWYgKCFuYW1lKSByZXR1cm4gdHJ1ZTsKCiAgICAvLyBIYW5kbGUgZXZlbnQgbWFwcy4KICAgIGlmICh0eXBlb2YgbmFtZSA9PT0gJ29iamVjdCcpIHsKICAgICAgZm9yICh2YXIga2V5IGluIG5hbWUpIHsKICAgICAgICBvYmpbYWN0aW9uXS5hcHBseShvYmosIFtrZXksIG5hbWVba2V5XV0uY29uY2F0KHJlc3QpKTsKICAgICAgfQogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgLy8gSGFuZGxlIHNwYWNlIHNlcGFyYXRlZCBldmVudCBuYW1lcy4KICAgIGlmIChldmVudFNwbGl0dGVyLnRlc3QobmFtZSkpIHsKICAgICAgdmFyIG5hbWVzID0gbmFtZS5zcGxpdChldmVudFNwbGl0dGVyKTsKICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSBuYW1lcy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICBvYmpbYWN0aW9uXS5hcHBseShvYmosIFtuYW1lc1tpXV0uY29uY2F0KHJlc3QpKTsKICAgICAgfQogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgcmV0dXJuIHRydWU7CiAgfTsKCiAgLy8gQSBkaWZmaWN1bHQtdG8tYmVsaWV2ZSwgYnV0IG9wdGltaXplZCBpbnRlcm5hbCBkaXNwYXRjaCBmdW5jdGlvbiBmb3IKICAvLyB0cmlnZ2VyaW5nIGV2ZW50cy4gVHJpZXMgdG8ga2VlcCB0aGUgdXN1YWwgY2FzZXMgc3BlZWR5IChtb3N0IGludGVybmFsCiAgLy8gQmFja2JvbmUgZXZlbnRzIGhhdmUgMyBhcmd1bWVudHMpLgogIHZhciB0cmlnZ2VyRXZlbnRzID0gZnVuY3Rpb24oZXZlbnRzLCBhcmdzKSB7CiAgICB2YXIgZXYsIGkgPSAtMSwgbCA9IGV2ZW50cy5sZW5ndGgsIGExID0gYXJnc1swXSwgYTIgPSBhcmdzWzFdLCBhMyA9IGFyZ3NbMl07CiAgICBzd2l0Y2ggKGFyZ3MubGVuZ3RoKSB7CiAgICAgIGNhc2UgMDogd2hpbGUgKCsraSA8IGwpIChldiA9IGV2ZW50c1tpXSkuY2FsbGJhY2suY2FsbChldi5jdHgpOyByZXR1cm47CiAgICAgIGNhc2UgMTogd2hpbGUgKCsraSA8IGwpIChldiA9IGV2ZW50c1tpXSkuY2FsbGJhY2suY2FsbChldi5jdHgsIGExKTsgcmV0dXJuOwogICAgICBjYXNlIDI6IHdoaWxlICgrK2kgPCBsKSAoZXYgPSBldmVudHNbaV0pLmNhbGxiYWNrLmNhbGwoZXYuY3R4LCBhMSwgYTIpOyByZXR1cm47CiAgICAgIGNhc2UgMzogd2hpbGUgKCsraSA8IGwpIChldiA9IGV2ZW50c1tpXSkuY2FsbGJhY2suY2FsbChldi5jdHgsIGExLCBhMiwgYTMpOyByZXR1cm47CiAgICAgIGRlZmF1bHQ6IHdoaWxlICgrK2kgPCBsKSAoZXYgPSBldmVudHNbaV0pLmNhbGxiYWNrLmFwcGx5KGV2LmN0eCwgYXJncyk7CiAgICB9CiAgfTsKCiAgdmFyIGxpc3Rlbk1ldGhvZHMgPSB7bGlzdGVuVG86ICdvbicsIGxpc3RlblRvT25jZTogJ29uY2UnfTsKCiAgLy8gSW52ZXJzaW9uLW9mLWNvbnRyb2wgdmVyc2lvbnMgb2YgYG9uYCBhbmQgYG9uY2VgLiBUZWxsICp0aGlzKiBvYmplY3QgdG8KICAvLyBsaXN0ZW4gdG8gYW4gZXZlbnQgaW4gYW5vdGhlciBvYmplY3QgLi4uIGtlZXBpbmcgdHJhY2sgb2Ygd2hhdCBpdCdzCiAgLy8gbGlzdGVuaW5nIHRvLgogIF8uZWFjaChsaXN0ZW5NZXRob2RzLCBmdW5jdGlvbihpbXBsZW1lbnRhdGlvbiwgbWV0aG9kKSB7CiAgICBFdmVudHNbbWV0aG9kXSA9IGZ1bmN0aW9uKG9iaiwgbmFtZSwgY2FsbGJhY2spIHsKICAgICAgdmFyIGxpc3RlbmVycyA9IHRoaXMuX2xpc3RlbmVycyB8fCAodGhpcy5fbGlzdGVuZXJzID0ge30pOwogICAgICB2YXIgaWQgPSBvYmouX2xpc3RlbmVySWQgfHwgKG9iai5fbGlzdGVuZXJJZCA9IF8udW5pcXVlSWQoJ2wnKSk7CiAgICAgIGxpc3RlbmVyc1tpZF0gPSBvYmo7CiAgICAgIGlmICh0eXBlb2YgbmFtZSA9PT0gJ29iamVjdCcpIGNhbGxiYWNrID0gdGhpczsKICAgICAgb2JqW2ltcGxlbWVudGF0aW9uXShuYW1lLCBjYWxsYmFjaywgdGhpcyk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfTsKICB9KTsKCiAgLy8gQWxpYXNlcyBmb3IgYmFja3dhcmRzIGNvbXBhdGliaWxpdHkuCiAgRXZlbnRzLmJpbmQgICA9IEV2ZW50cy5vbjsKICBFdmVudHMudW5iaW5kID0gRXZlbnRzLm9mZjsKCiAgLy8gQWxsb3cgdGhlIGBCYWNrYm9uZWAgb2JqZWN0IHRvIHNlcnZlIGFzIGEgZ2xvYmFsIGV2ZW50IGJ1cywgZm9yIGZvbGtzIHdobwogIC8vIHdhbnQgZ2xvYmFsICJwdWJzdWIiIGluIGEgY29udmVuaWVudCBwbGFjZS4KICBfLmV4dGVuZChCYWNrYm9uZSwgRXZlbnRzKTsKCiAgLy8gQmFja2JvbmUuTW9kZWwKICAvLyAtLS0tLS0tLS0tLS0tLQoKICAvLyBCYWNrYm9uZSAqKk1vZGVscyoqIGFyZSB0aGUgYmFzaWMgZGF0YSBvYmplY3QgaW4gdGhlIGZyYW1ld29yayAtLQogIC8vIGZyZXF1ZW50bHkgcmVwcmVzZW50aW5nIGEgcm93IGluIGEgdGFibGUgaW4gYSBkYXRhYmFzZSBvbiB5b3VyIHNlcnZlci4KICAvLyBBIGRpc2NyZXRlIGNodW5rIG9mIGRhdGEgYW5kIGEgYnVuY2ggb2YgdXNlZnVsLCByZWxhdGVkIG1ldGhvZHMgZm9yCiAgLy8gcGVyZm9ybWluZyBjb21wdXRhdGlvbnMgYW5kIHRyYW5zZm9ybWF0aW9ucyBvbiB0aGF0IGRhdGEuCgogIC8vIENyZWF0ZSBhIG5ldyBtb2RlbCB3aXRoIHRoZSBzcGVjaWZpZWQgYXR0cmlidXRlcy4gQSBjbGllbnQgaWQgKGBjaWRgKQogIC8vIGlzIGF1dG9tYXRpY2FsbHkgZ2VuZXJhdGVkIGFuZCBhc3NpZ25lZCBmb3IgeW91LgogIHZhciBNb2RlbCA9IEJhY2tib25lLk1vZGVsID0gZnVuY3Rpb24oYXR0cmlidXRlcywgb3B0aW9ucykgewogICAgdmFyIGRlZmF1bHRzOwogICAgdmFyIGF0dHJzID0gYXR0cmlidXRlcyB8fCB7fTsKICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CiAgICB0aGlzLmNpZCA9IF8udW5pcXVlSWQoJ2MnKTsKICAgIHRoaXMuYXR0cmlidXRlcyA9IHt9OwogICAgXy5leHRlbmQodGhpcywgXy5waWNrKG9wdGlvbnMsIG1vZGVsT3B0aW9ucykpOwogICAgaWYgKG9wdGlvbnMucGFyc2UpIGF0dHJzID0gdGhpcy5wYXJzZShhdHRycywgb3B0aW9ucykgfHwge307CiAgICBpZiAoZGVmYXVsdHMgPSBfLnJlc3VsdCh0aGlzLCAnZGVmYXVsdHMnKSkgewogICAgICBhdHRycyA9IF8uZGVmYXVsdHMoe30sIGF0dHJzLCBkZWZhdWx0cyk7CiAgICB9CiAgICB0aGlzLnNldChhdHRycywgb3B0aW9ucyk7CiAgICB0aGlzLmNoYW5nZWQgPSB7fTsKICAgIHRoaXMuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIH07CgogIC8vIEEgbGlzdCBvZiBvcHRpb25zIHRvIGJlIGF0dGFjaGVkIGRpcmVjdGx5IHRvIHRoZSBtb2RlbCwgaWYgcHJvdmlkZWQuCiAgdmFyIG1vZGVsT3B0aW9ucyA9IFsndXJsJywgJ3VybFJvb3QnLCAnY29sbGVjdGlvbiddOwoKICAvLyBBdHRhY2ggYWxsIGluaGVyaXRhYmxlIG1ldGhvZHMgdG8gdGhlIE1vZGVsIHByb3RvdHlwZS4KICBfLmV4dGVuZChNb2RlbC5wcm90b3R5cGUsIEV2ZW50cywgewoKICAgIC8vIEEgaGFzaCBvZiBhdHRyaWJ1dGVzIHdob3NlIGN1cnJlbnQgYW5kIHByZXZpb3VzIHZhbHVlIGRpZmZlci4KICAgIGNoYW5nZWQ6IG51bGwsCgogICAgLy8gVGhlIHZhbHVlIHJldHVybmVkIGR1cmluZyB0aGUgbGFzdCBmYWlsZWQgdmFsaWRhdGlvbi4KICAgIHZhbGlkYXRpb25FcnJvcjogbnVsbCwKCiAgICAvLyBUaGUgZGVmYXVsdCBuYW1lIGZvciB0aGUgSlNPTiBgaWRgIGF0dHJpYnV0ZSBpcyBgImlkImAuIE1vbmdvREIgYW5kCiAgICAvLyBDb3VjaERCIHVzZXJzIG1heSB3YW50IHRvIHNldCB0aGlzIHRvIGAiX2lkImAuCiAgICBpZEF0dHJpYnV0ZTogJ2lkJywKCiAgICAvLyBJbml0aWFsaXplIGlzIGFuIGVtcHR5IGZ1bmN0aW9uIGJ5IGRlZmF1bHQuIE92ZXJyaWRlIGl0IHdpdGggeW91ciBvd24KICAgIC8vIGluaXRpYWxpemF0aW9uIGxvZ2ljLgogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oKXt9LAoKICAgIC8vIFJldHVybiBhIGNvcHkgb2YgdGhlIG1vZGVsJ3MgYGF0dHJpYnV0ZXNgIG9iamVjdC4KICAgIHRvSlNPTjogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICByZXR1cm4gXy5jbG9uZSh0aGlzLmF0dHJpYnV0ZXMpOwogICAgfSwKCiAgICAvLyBQcm94eSBgQmFja2JvbmUuc3luY2AgYnkgZGVmYXVsdCAtLSBidXQgb3ZlcnJpZGUgdGhpcyBpZiB5b3UgbmVlZAogICAgLy8gY3VzdG9tIHN5bmNpbmcgc2VtYW50aWNzIGZvciAqdGhpcyogcGFydGljdWxhciBtb2RlbC4KICAgIHN5bmM6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gQmFja2JvbmUuc3luYy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfSwKCiAgICAvLyBHZXQgdGhlIHZhbHVlIG9mIGFuIGF0dHJpYnV0ZS4KICAgIGdldDogZnVuY3Rpb24oYXR0cikgewogICAgICByZXR1cm4gdGhpcy5hdHRyaWJ1dGVzW2F0dHJdOwogICAgfSwKCiAgICAvLyBHZXQgdGhlIEhUTUwtZXNjYXBlZCB2YWx1ZSBvZiBhbiBhdHRyaWJ1dGUuCiAgICBlc2NhcGU6IGZ1bmN0aW9uKGF0dHIpIHsKICAgICAgcmV0dXJuIF8uZXNjYXBlKHRoaXMuZ2V0KGF0dHIpKTsKICAgIH0sCgogICAgLy8gUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIGF0dHJpYnV0ZSBjb250YWlucyBhIHZhbHVlIHRoYXQgaXMgbm90IG51bGwKICAgIC8vIG9yIHVuZGVmaW5lZC4KICAgIGhhczogZnVuY3Rpb24oYXR0cikgewogICAgICByZXR1cm4gdGhpcy5nZXQoYXR0cikgIT0gbnVsbDsKICAgIH0sCgogICAgLy8gU2V0IGEgaGFzaCBvZiBtb2RlbCBhdHRyaWJ1dGVzIG9uIHRoZSBvYmplY3QsIGZpcmluZyBgImNoYW5nZSJgLiBUaGlzIGlzCiAgICAvLyB0aGUgY29yZSBwcmltaXRpdmUgb3BlcmF0aW9uIG9mIGEgbW9kZWwsIHVwZGF0aW5nIHRoZSBkYXRhIGFuZCBub3RpZnlpbmcKICAgIC8vIGFueW9uZSB3aG8gbmVlZHMgdG8ga25vdyBhYm91dCB0aGUgY2hhbmdlIGluIHN0YXRlLiBUaGUgaGVhcnQgb2YgdGhlIGJlYXN0LgogICAgc2V0OiBmdW5jdGlvbihrZXksIHZhbCwgb3B0aW9ucykgewogICAgICB2YXIgYXR0ciwgYXR0cnMsIHVuc2V0LCBjaGFuZ2VzLCBzaWxlbnQsIGNoYW5naW5nLCBwcmV2LCBjdXJyZW50OwogICAgICBpZiAoa2V5ID09IG51bGwpIHJldHVybiB0aGlzOwoKICAgICAgLy8gSGFuZGxlIGJvdGggYCJrZXkiLCB2YWx1ZWAgYW5kIGB7a2V5OiB2YWx1ZX1gIC1zdHlsZSBhcmd1bWVudHMuCiAgICAgIGlmICh0eXBlb2Yga2V5ID09PSAnb2JqZWN0JykgewogICAgICAgIGF0dHJzID0ga2V5OwogICAgICAgIG9wdGlvbnMgPSB2YWw7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgKGF0dHJzID0ge30pW2tleV0gPSB2YWw7CiAgICAgIH0KCiAgICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CgogICAgICAvLyBSdW4gdmFsaWRhdGlvbi4KICAgICAgaWYgKCF0aGlzLl92YWxpZGF0ZShhdHRycywgb3B0aW9ucykpIHJldHVybiBmYWxzZTsKCiAgICAgIC8vIEV4dHJhY3QgYXR0cmlidXRlcyBhbmQgb3B0aW9ucy4KICAgICAgdW5zZXQgICAgICAgICAgID0gb3B0aW9ucy51bnNldDsKICAgICAgc2lsZW50ICAgICAgICAgID0gb3B0aW9ucy5zaWxlbnQ7CiAgICAgIGNoYW5nZXMgICAgICAgICA9IFtdOwogICAgICBjaGFuZ2luZyAgICAgICAgPSB0aGlzLl9jaGFuZ2luZzsKICAgICAgdGhpcy5fY2hhbmdpbmcgID0gdHJ1ZTsKCiAgICAgIGlmICghY2hhbmdpbmcpIHsKICAgICAgICB0aGlzLl9wcmV2aW91c0F0dHJpYnV0ZXMgPSBfLmNsb25lKHRoaXMuYXR0cmlidXRlcyk7CiAgICAgICAgdGhpcy5jaGFuZ2VkID0ge307CiAgICAgIH0KICAgICAgY3VycmVudCA9IHRoaXMuYXR0cmlidXRlcywgcHJldiA9IHRoaXMuX3ByZXZpb3VzQXR0cmlidXRlczsKCiAgICAgIC8vIENoZWNrIGZvciBjaGFuZ2VzIG9mIGBpZGAuCiAgICAgIGlmICh0aGlzLmlkQXR0cmlidXRlIGluIGF0dHJzKSB0aGlzLmlkID0gYXR0cnNbdGhpcy5pZEF0dHJpYnV0ZV07CgogICAgICAvLyBGb3IgZWFjaCBgc2V0YCBhdHRyaWJ1dGUsIHVwZGF0ZSBvciBkZWxldGUgdGhlIGN1cnJlbnQgdmFsdWUuCiAgICAgIGZvciAoYXR0ciBpbiBhdHRycykgewogICAgICAgIHZhbCA9IGF0dHJzW2F0dHJdOwogICAgICAgIGlmICghXy5pc0VxdWFsKGN1cnJlbnRbYXR0cl0sIHZhbCkpIGNoYW5nZXMucHVzaChhdHRyKTsKICAgICAgICBpZiAoIV8uaXNFcXVhbChwcmV2W2F0dHJdLCB2YWwpKSB7CiAgICAgICAgICB0aGlzLmNoYW5nZWRbYXR0cl0gPSB2YWw7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGRlbGV0ZSB0aGlzLmNoYW5nZWRbYXR0cl07CiAgICAgICAgfQogICAgICAgIHVuc2V0ID8gZGVsZXRlIGN1cnJlbnRbYXR0cl0gOiBjdXJyZW50W2F0dHJdID0gdmFsOwogICAgICB9CgogICAgICAvLyBUcmlnZ2VyIGFsbCByZWxldmFudCBhdHRyaWJ1dGUgY2hhbmdlcy4KICAgICAgaWYgKCFzaWxlbnQpIHsKICAgICAgICBpZiAoY2hhbmdlcy5sZW5ndGgpIHRoaXMuX3BlbmRpbmcgPSB0cnVlOwogICAgICAgIGZvciAodmFyIGkgPSAwLCBsID0gY2hhbmdlcy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgIHRoaXMudHJpZ2dlcignY2hhbmdlOicgKyBjaGFuZ2VzW2ldLCB0aGlzLCBjdXJyZW50W2NoYW5nZXNbaV1dLCBvcHRpb25zKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIC8vIFlvdSBtaWdodCBiZSB3b25kZXJpbmcgd2h5IHRoZXJlJ3MgYSBgd2hpbGVgIGxvb3AgaGVyZS4gQ2hhbmdlcyBjYW4KICAgICAgLy8gYmUgcmVjdXJzaXZlbHkgbmVzdGVkIHdpdGhpbiBgImNoYW5nZSJgIGV2ZW50cy4KICAgICAgaWYgKGNoYW5naW5nKSByZXR1cm4gdGhpczsKICAgICAgaWYgKCFzaWxlbnQpIHsKICAgICAgICB3aGlsZSAodGhpcy5fcGVuZGluZykgewogICAgICAgICAgdGhpcy5fcGVuZGluZyA9IGZhbHNlOwogICAgICAgICAgdGhpcy50cmlnZ2VyKCdjaGFuZ2UnLCB0aGlzLCBvcHRpb25zKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgdGhpcy5fcGVuZGluZyA9IGZhbHNlOwogICAgICB0aGlzLl9jaGFuZ2luZyA9IGZhbHNlOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gUmVtb3ZlIGFuIGF0dHJpYnV0ZSBmcm9tIHRoZSBtb2RlbCwgZmlyaW5nIGAiY2hhbmdlImAuIGB1bnNldGAgaXMgYSBub29wCiAgICAvLyBpZiB0aGUgYXR0cmlidXRlIGRvZXNuJ3QgZXhpc3QuCiAgICB1bnNldDogZnVuY3Rpb24oYXR0ciwgb3B0aW9ucykgewogICAgICByZXR1cm4gdGhpcy5zZXQoYXR0ciwgdm9pZCAwLCBfLmV4dGVuZCh7fSwgb3B0aW9ucywge3Vuc2V0OiB0cnVlfSkpOwogICAgfSwKCiAgICAvLyBDbGVhciBhbGwgYXR0cmlidXRlcyBvbiB0aGUgbW9kZWwsIGZpcmluZyBgImNoYW5nZSJgLgogICAgY2xlYXI6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgdmFyIGF0dHJzID0ge307CiAgICAgIGZvciAodmFyIGtleSBpbiB0aGlzLmF0dHJpYnV0ZXMpIGF0dHJzW2tleV0gPSB2b2lkIDA7CiAgICAgIHJldHVybiB0aGlzLnNldChhdHRycywgXy5leHRlbmQoe30sIG9wdGlvbnMsIHt1bnNldDogdHJ1ZX0pKTsKICAgIH0sCgogICAgLy8gRGV0ZXJtaW5lIGlmIHRoZSBtb2RlbCBoYXMgY2hhbmdlZCBzaW5jZSB0aGUgbGFzdCBgImNoYW5nZSJgIGV2ZW50LgogICAgLy8gSWYgeW91IHNwZWNpZnkgYW4gYXR0cmlidXRlIG5hbWUsIGRldGVybWluZSBpZiB0aGF0IGF0dHJpYnV0ZSBoYXMgY2hhbmdlZC4KICAgIGhhc0NoYW5nZWQ6IGZ1bmN0aW9uKGF0dHIpIHsKICAgICAgaWYgKGF0dHIgPT0gbnVsbCkgcmV0dXJuICFfLmlzRW1wdHkodGhpcy5jaGFuZ2VkKTsKICAgICAgcmV0dXJuIF8uaGFzKHRoaXMuY2hhbmdlZCwgYXR0cik7CiAgICB9LAoKICAgIC8vIFJldHVybiBhbiBvYmplY3QgY29udGFpbmluZyBhbGwgdGhlIGF0dHJpYnV0ZXMgdGhhdCBoYXZlIGNoYW5nZWQsIG9yCiAgICAvLyBmYWxzZSBpZiB0aGVyZSBhcmUgbm8gY2hhbmdlZCBhdHRyaWJ1dGVzLiBVc2VmdWwgZm9yIGRldGVybWluaW5nIHdoYXQKICAgIC8vIHBhcnRzIG9mIGEgdmlldyBuZWVkIHRvIGJlIHVwZGF0ZWQgYW5kL29yIHdoYXQgYXR0cmlidXRlcyBuZWVkIHRvIGJlCiAgICAvLyBwZXJzaXN0ZWQgdG8gdGhlIHNlcnZlci4gVW5zZXQgYXR0cmlidXRlcyB3aWxsIGJlIHNldCB0byB1bmRlZmluZWQuCiAgICAvLyBZb3UgY2FuIGFsc28gcGFzcyBhbiBhdHRyaWJ1dGVzIG9iamVjdCB0byBkaWZmIGFnYWluc3QgdGhlIG1vZGVsLAogICAgLy8gZGV0ZXJtaW5pbmcgaWYgdGhlcmUgKndvdWxkIGJlKiBhIGNoYW5nZS4KICAgIGNoYW5nZWRBdHRyaWJ1dGVzOiBmdW5jdGlvbihkaWZmKSB7CiAgICAgIGlmICghZGlmZikgcmV0dXJuIHRoaXMuaGFzQ2hhbmdlZCgpID8gXy5jbG9uZSh0aGlzLmNoYW5nZWQpIDogZmFsc2U7CiAgICAgIHZhciB2YWwsIGNoYW5nZWQgPSBmYWxzZTsKICAgICAgdmFyIG9sZCA9IHRoaXMuX2NoYW5naW5nID8gdGhpcy5fcHJldmlvdXNBdHRyaWJ1dGVzIDogdGhpcy5hdHRyaWJ1dGVzOwogICAgICBmb3IgKHZhciBhdHRyIGluIGRpZmYpIHsKICAgICAgICBpZiAoXy5pc0VxdWFsKG9sZFthdHRyXSwgKHZhbCA9IGRpZmZbYXR0cl0pKSkgY29udGludWU7CiAgICAgICAgKGNoYW5nZWQgfHwgKGNoYW5nZWQgPSB7fSkpW2F0dHJdID0gdmFsOwogICAgICB9CiAgICAgIHJldHVybiBjaGFuZ2VkOwogICAgfSwKCiAgICAvLyBHZXQgdGhlIHByZXZpb3VzIHZhbHVlIG9mIGFuIGF0dHJpYnV0ZSwgcmVjb3JkZWQgYXQgdGhlIHRpbWUgdGhlIGxhc3QKICAgIC8vIGAiY2hhbmdlImAgZXZlbnQgd2FzIGZpcmVkLgogICAgcHJldmlvdXM6IGZ1bmN0aW9uKGF0dHIpIHsKICAgICAgaWYgKGF0dHIgPT0gbnVsbCB8fCAhdGhpcy5fcHJldmlvdXNBdHRyaWJ1dGVzKSByZXR1cm4gbnVsbDsKICAgICAgcmV0dXJuIHRoaXMuX3ByZXZpb3VzQXR0cmlidXRlc1thdHRyXTsKICAgIH0sCgogICAgLy8gR2V0IGFsbCBvZiB0aGUgYXR0cmlidXRlcyBvZiB0aGUgbW9kZWwgYXQgdGhlIHRpbWUgb2YgdGhlIHByZXZpb3VzCiAgICAvLyBgImNoYW5nZSJgIGV2ZW50LgogICAgcHJldmlvdXNBdHRyaWJ1dGVzOiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIF8uY2xvbmUodGhpcy5fcHJldmlvdXNBdHRyaWJ1dGVzKTsKICAgIH0sCgogICAgLy8gRmV0Y2ggdGhlIG1vZGVsIGZyb20gdGhlIHNlcnZlci4gSWYgdGhlIHNlcnZlcidzIHJlcHJlc2VudGF0aW9uIG9mIHRoZQogICAgLy8gbW9kZWwgZGlmZmVycyBmcm9tIGl0cyBjdXJyZW50IGF0dHJpYnV0ZXMsIHRoZXkgd2lsbCBiZSBvdmVycmlkZGVuLAogICAgLy8gdHJpZ2dlcmluZyBhIGAiY2hhbmdlImAgZXZlbnQuCiAgICBmZXRjaDogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICBvcHRpb25zID0gb3B0aW9ucyA/IF8uY2xvbmUob3B0aW9ucykgOiB7fTsKICAgICAgaWYgKG9wdGlvbnMucGFyc2UgPT09IHZvaWQgMCkgb3B0aW9ucy5wYXJzZSA9IHRydWU7CiAgICAgIHZhciBtb2RlbCA9IHRoaXM7CiAgICAgIHZhciBzdWNjZXNzID0gb3B0aW9ucy5zdWNjZXNzOwogICAgICBvcHRpb25zLnN1Y2Nlc3MgPSBmdW5jdGlvbihyZXNwKSB7CiAgICAgICAgaWYgKCFtb2RlbC5zZXQobW9kZWwucGFyc2UocmVzcCwgb3B0aW9ucyksIG9wdGlvbnMpKSByZXR1cm4gZmFsc2U7CiAgICAgICAgaWYgKHN1Y2Nlc3MpIHN1Y2Nlc3MobW9kZWwsIHJlc3AsIG9wdGlvbnMpOwogICAgICAgIG1vZGVsLnRyaWdnZXIoJ3N5bmMnLCBtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CiAgICAgIH07CiAgICAgIHdyYXBFcnJvcih0aGlzLCBvcHRpb25zKTsKICAgICAgcmV0dXJuIHRoaXMuc3luYygncmVhZCcsIHRoaXMsIG9wdGlvbnMpOwogICAgfSwKCiAgICAvLyBTZXQgYSBoYXNoIG9mIG1vZGVsIGF0dHJpYnV0ZXMsIGFuZCBzeW5jIHRoZSBtb2RlbCB0byB0aGUgc2VydmVyLgogICAgLy8gSWYgdGhlIHNlcnZlciByZXR1cm5zIGFuIGF0dHJpYnV0ZXMgaGFzaCB0aGF0IGRpZmZlcnMsIHRoZSBtb2RlbCdzCiAgICAvLyBzdGF0ZSB3aWxsIGJlIGBzZXRgIGFnYWluLgogICAgc2F2ZTogZnVuY3Rpb24oa2V5LCB2YWwsIG9wdGlvbnMpIHsKICAgICAgdmFyIGF0dHJzLCBtZXRob2QsIHhociwgYXR0cmlidXRlcyA9IHRoaXMuYXR0cmlidXRlczsKCiAgICAgIC8vIEhhbmRsZSBib3RoIGAia2V5IiwgdmFsdWVgIGFuZCBge2tleTogdmFsdWV9YCAtc3R5bGUgYXJndW1lbnRzLgogICAgICBpZiAoa2V5ID09IG51bGwgfHwgdHlwZW9mIGtleSA9PT0gJ29iamVjdCcpIHsKICAgICAgICBhdHRycyA9IGtleTsKICAgICAgICBvcHRpb25zID0gdmFsOwogICAgICB9IGVsc2UgewogICAgICAgIChhdHRycyA9IHt9KVtrZXldID0gdmFsOwogICAgICB9CgogICAgICAvLyBJZiB3ZSdyZSBub3Qgd2FpdGluZyBhbmQgYXR0cmlidXRlcyBleGlzdCwgc2F2ZSBhY3RzIGFzIGBzZXQoYXR0cikuc2F2ZShudWxsLCBvcHRzKWAuCiAgICAgIGlmIChhdHRycyAmJiAoIW9wdGlvbnMgfHwgIW9wdGlvbnMud2FpdCkgJiYgIXRoaXMuc2V0KGF0dHJzLCBvcHRpb25zKSkgcmV0dXJuIGZhbHNlOwoKICAgICAgb3B0aW9ucyA9IF8uZXh0ZW5kKHt2YWxpZGF0ZTogdHJ1ZX0sIG9wdGlvbnMpOwoKICAgICAgLy8gRG8gbm90IHBlcnNpc3QgaW52YWxpZCBtb2RlbHMuCiAgICAgIGlmICghdGhpcy5fdmFsaWRhdGUoYXR0cnMsIG9wdGlvbnMpKSByZXR1cm4gZmFsc2U7CgogICAgICAvLyBTZXQgdGVtcG9yYXJ5IGF0dHJpYnV0ZXMgaWYgYHt3YWl0OiB0cnVlfWAuCiAgICAgIGlmIChhdHRycyAmJiBvcHRpb25zLndhaXQpIHsKICAgICAgICB0aGlzLmF0dHJpYnV0ZXMgPSBfLmV4dGVuZCh7fSwgYXR0cmlidXRlcywgYXR0cnMpOwogICAgICB9CgogICAgICAvLyBBZnRlciBhIHN1Y2Nlc3NmdWwgc2VydmVyLXNpZGUgc2F2ZSwgdGhlIGNsaWVudCBpcyAob3B0aW9uYWxseSkKICAgICAgLy8gdXBkYXRlZCB3aXRoIHRoZSBzZXJ2ZXItc2lkZSBzdGF0ZS4KICAgICAgaWYgKG9wdGlvbnMucGFyc2UgPT09IHZvaWQgMCkgb3B0aW9ucy5wYXJzZSA9IHRydWU7CiAgICAgIHZhciBtb2RlbCA9IHRoaXM7CiAgICAgIHZhciBzdWNjZXNzID0gb3B0aW9ucy5zdWNjZXNzOwogICAgICBvcHRpb25zLnN1Y2Nlc3MgPSBmdW5jdGlvbihyZXNwKSB7CiAgICAgICAgLy8gRW5zdXJlIGF0dHJpYnV0ZXMgYXJlIHJlc3RvcmVkIGR1cmluZyBzeW5jaHJvbm91cyBzYXZlcy4KICAgICAgICBtb2RlbC5hdHRyaWJ1dGVzID0gYXR0cmlidXRlczsKICAgICAgICB2YXIgc2VydmVyQXR0cnMgPSBtb2RlbC5wYXJzZShyZXNwLCBvcHRpb25zKTsKICAgICAgICBpZiAob3B0aW9ucy53YWl0KSBzZXJ2ZXJBdHRycyA9IF8uZXh0ZW5kKGF0dHJzIHx8IHt9LCBzZXJ2ZXJBdHRycyk7CiAgICAgICAgaWYgKF8uaXNPYmplY3Qoc2VydmVyQXR0cnMpICYmICFtb2RlbC5zZXQoc2VydmVyQXR0cnMsIG9wdGlvbnMpKSB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGlmIChzdWNjZXNzKSBzdWNjZXNzKG1vZGVsLCByZXNwLCBvcHRpb25zKTsKICAgICAgICBtb2RlbC50cmlnZ2VyKCdzeW5jJywgbW9kZWwsIHJlc3AsIG9wdGlvbnMpOwogICAgICB9OwogICAgICB3cmFwRXJyb3IodGhpcywgb3B0aW9ucyk7CgogICAgICBtZXRob2QgPSB0aGlzLmlzTmV3KCkgPyAnY3JlYXRlJyA6IChvcHRpb25zLnBhdGNoID8gJ3BhdGNoJyA6ICd1cGRhdGUnKTsKICAgICAgaWYgKG1ldGhvZCA9PT0gJ3BhdGNoJykgb3B0aW9ucy5hdHRycyA9IGF0dHJzOwogICAgICB4aHIgPSB0aGlzLnN5bmMobWV0aG9kLCB0aGlzLCBvcHRpb25zKTsKCiAgICAgIC8vIFJlc3RvcmUgYXR0cmlidXRlcy4KICAgICAgaWYgKGF0dHJzICYmIG9wdGlvbnMud2FpdCkgdGhpcy5hdHRyaWJ1dGVzID0gYXR0cmlidXRlczsKCiAgICAgIHJldHVybiB4aHI7CiAgICB9LAoKICAgIC8vIERlc3Ryb3kgdGhpcyBtb2RlbCBvbiB0aGUgc2VydmVyIGlmIGl0IHdhcyBhbHJlYWR5IHBlcnNpc3RlZC4KICAgIC8vIE9wdGltaXN0aWNhbGx5IHJlbW92ZXMgdGhlIG1vZGVsIGZyb20gaXRzIGNvbGxlY3Rpb24sIGlmIGl0IGhhcyBvbmUuCiAgICAvLyBJZiBgd2FpdDogdHJ1ZWAgaXMgcGFzc2VkLCB3YWl0cyBmb3IgdGhlIHNlcnZlciB0byByZXNwb25kIGJlZm9yZSByZW1vdmFsLgogICAgZGVzdHJveTogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICBvcHRpb25zID0gb3B0aW9ucyA/IF8uY2xvbmUob3B0aW9ucykgOiB7fTsKICAgICAgdmFyIG1vZGVsID0gdGhpczsKICAgICAgdmFyIHN1Y2Nlc3MgPSBvcHRpb25zLnN1Y2Nlc3M7CgogICAgICB2YXIgZGVzdHJveSA9IGZ1bmN0aW9uKCkgewogICAgICAgIG1vZGVsLnRyaWdnZXIoJ2Rlc3Ryb3knLCBtb2RlbCwgbW9kZWwuY29sbGVjdGlvbiwgb3B0aW9ucyk7CiAgICAgIH07CgogICAgICBvcHRpb25zLnN1Y2Nlc3MgPSBmdW5jdGlvbihyZXNwKSB7CiAgICAgICAgaWYgKG9wdGlvbnMud2FpdCB8fCBtb2RlbC5pc05ldygpKSBkZXN0cm95KCk7CiAgICAgICAgaWYgKHN1Y2Nlc3MpIHN1Y2Nlc3MobW9kZWwsIHJlc3AsIG9wdGlvbnMpOwogICAgICAgIGlmICghbW9kZWwuaXNOZXcoKSkgbW9kZWwudHJpZ2dlcignc3luYycsIG1vZGVsLCByZXNwLCBvcHRpb25zKTsKICAgICAgfTsKCiAgICAgIGlmICh0aGlzLmlzTmV3KCkpIHsKICAgICAgICBvcHRpb25zLnN1Y2Nlc3MoKTsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgICAgd3JhcEVycm9yKHRoaXMsIG9wdGlvbnMpOwoKICAgICAgdmFyIHhociA9IHRoaXMuc3luYygnZGVsZXRlJywgdGhpcywgb3B0aW9ucyk7CiAgICAgIGlmICghb3B0aW9ucy53YWl0KSBkZXN0cm95KCk7CiAgICAgIHJldHVybiB4aHI7CiAgICB9LAoKICAgIC8vIERlZmF1bHQgVVJMIGZvciB0aGUgbW9kZWwncyByZXByZXNlbnRhdGlvbiBvbiB0aGUgc2VydmVyIC0tIGlmIHlvdSdyZQogICAgLy8gdXNpbmcgQmFja2JvbmUncyByZXN0ZnVsIG1ldGhvZHMsIG92ZXJyaWRlIHRoaXMgdG8gY2hhbmdlIHRoZSBlbmRwb2ludAogICAgLy8gdGhhdCB3aWxsIGJlIGNhbGxlZC4KICAgIHVybDogZnVuY3Rpb24oKSB7CiAgICAgIHZhciBiYXNlID0gXy5yZXN1bHQodGhpcywgJ3VybFJvb3QnKSB8fCBfLnJlc3VsdCh0aGlzLmNvbGxlY3Rpb24sICd1cmwnKSB8fCB1cmxFcnJvcigpOwogICAgICBpZiAodGhpcy5pc05ldygpKSByZXR1cm4gYmFzZTsKICAgICAgcmV0dXJuIGJhc2UgKyAoYmFzZS5jaGFyQXQoYmFzZS5sZW5ndGggLSAxKSA9PT0gJy8nID8gJycgOiAnLycpICsgZW5jb2RlVVJJQ29tcG9uZW50KHRoaXMuaWQpOwogICAgfSwKCiAgICAvLyAqKnBhcnNlKiogY29udmVydHMgYSByZXNwb25zZSBpbnRvIHRoZSBoYXNoIG9mIGF0dHJpYnV0ZXMgdG8gYmUgYHNldGAgb24KICAgIC8vIHRoZSBtb2RlbC4gVGhlIGRlZmF1bHQgaW1wbGVtZW50YXRpb24gaXMganVzdCB0byBwYXNzIHRoZSByZXNwb25zZSBhbG9uZy4KICAgIHBhcnNlOiBmdW5jdGlvbihyZXNwLCBvcHRpb25zKSB7CiAgICAgIHJldHVybiByZXNwOwogICAgfSwKCiAgICAvLyBDcmVhdGUgYSBuZXcgbW9kZWwgd2l0aCBpZGVudGljYWwgYXR0cmlidXRlcyB0byB0aGlzIG9uZS4KICAgIGNsb25lOiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIG5ldyB0aGlzLmNvbnN0cnVjdG9yKHRoaXMuYXR0cmlidXRlcyk7CiAgICB9LAoKICAgIC8vIEEgbW9kZWwgaXMgbmV3IGlmIGl0IGhhcyBuZXZlciBiZWVuIHNhdmVkIHRvIHRoZSBzZXJ2ZXIsIGFuZCBsYWNrcyBhbiBpZC4KICAgIGlzTmV3OiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHRoaXMuaWQgPT0gbnVsbDsKICAgIH0sCgogICAgLy8gQ2hlY2sgaWYgdGhlIG1vZGVsIGlzIGN1cnJlbnRseSBpbiBhIHZhbGlkIHN0YXRlLgogICAgaXNWYWxpZDogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICByZXR1cm4gdGhpcy5fdmFsaWRhdGUoe30sIF8uZXh0ZW5kKG9wdGlvbnMgfHwge30sIHsgdmFsaWRhdGU6IHRydWUgfSkpOwogICAgfSwKCiAgICAvLyBSdW4gdmFsaWRhdGlvbiBhZ2FpbnN0IHRoZSBuZXh0IGNvbXBsZXRlIHNldCBvZiBtb2RlbCBhdHRyaWJ1dGVzLAogICAgLy8gcmV0dXJuaW5nIGB0cnVlYCBpZiBhbGwgaXMgd2VsbC4gT3RoZXJ3aXNlLCBmaXJlIGFuIGAiaW52YWxpZCJgIGV2ZW50LgogICAgX3ZhbGlkYXRlOiBmdW5jdGlvbihhdHRycywgb3B0aW9ucykgewogICAgICBpZiAoIW9wdGlvbnMudmFsaWRhdGUgfHwgIXRoaXMudmFsaWRhdGUpIHJldHVybiB0cnVlOwogICAgICBhdHRycyA9IF8uZXh0ZW5kKHt9LCB0aGlzLmF0dHJpYnV0ZXMsIGF0dHJzKTsKICAgICAgdmFyIGVycm9yID0gdGhpcy52YWxpZGF0aW9uRXJyb3IgPSB0aGlzLnZhbGlkYXRlKGF0dHJzLCBvcHRpb25zKSB8fCBudWxsOwogICAgICBpZiAoIWVycm9yKSByZXR1cm4gdHJ1ZTsKICAgICAgdGhpcy50cmlnZ2VyKCdpbnZhbGlkJywgdGhpcywgZXJyb3IsIF8uZXh0ZW5kKG9wdGlvbnMgfHwge30sIHt2YWxpZGF0aW9uRXJyb3I6IGVycm9yfSkpOwogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogIH0pOwoKICAvLyBVbmRlcnNjb3JlIG1ldGhvZHMgdGhhdCB3ZSB3YW50IHRvIGltcGxlbWVudCBvbiB0aGUgTW9kZWwuCiAgdmFyIG1vZGVsTWV0aG9kcyA9IFsna2V5cycsICd2YWx1ZXMnLCAncGFpcnMnLCAnaW52ZXJ0JywgJ3BpY2snLCAnb21pdCddOwoKICAvLyBNaXggaW4gZWFjaCBVbmRlcnNjb3JlIG1ldGhvZCBhcyBhIHByb3h5IHRvIGBNb2RlbCNhdHRyaWJ1dGVzYC4KICBfLmVhY2gobW9kZWxNZXRob2RzLCBmdW5jdGlvbihtZXRob2QpIHsKICAgIE1vZGVsLnByb3RvdHlwZVttZXRob2RdID0gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMpOwogICAgICBhcmdzLnVuc2hpZnQodGhpcy5hdHRyaWJ1dGVzKTsKICAgICAgcmV0dXJuIF9bbWV0aG9kXS5hcHBseShfLCBhcmdzKTsKICAgIH07CiAgfSk7CgogIC8vIEJhY2tib25lLkNvbGxlY3Rpb24KICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tCgogIC8vIElmIG1vZGVscyB0ZW5kIHRvIHJlcHJlc2VudCBhIHNpbmdsZSByb3cgb2YgZGF0YSwgYSBCYWNrYm9uZSBDb2xsZWN0aW9uIGlzCiAgLy8gbW9yZSBhbmFsYWdvdXMgdG8gYSB0YWJsZSBmdWxsIG9mIGRhdGEgLi4uIG9yIGEgc21hbGwgc2xpY2Ugb3IgcGFnZSBvZiB0aGF0CiAgLy8gdGFibGUsIG9yIGEgY29sbGVjdGlvbiBvZiByb3dzIHRoYXQgYmVsb25nIHRvZ2V0aGVyIGZvciBhIHBhcnRpY3VsYXIgcmVhc29uCiAgLy8gLS0gYWxsIG9mIHRoZSBtZXNzYWdlcyBpbiB0aGlzIHBhcnRpY3VsYXIgZm9sZGVyLCBhbGwgb2YgdGhlIGRvY3VtZW50cwogIC8vIGJlbG9uZ2luZyB0byB0aGlzIHBhcnRpY3VsYXIgYXV0aG9yLCBhbmQgc28gb24uIENvbGxlY3Rpb25zIG1haW50YWluCiAgLy8gaW5kZXhlcyBvZiB0aGVpciBtb2RlbHMsIGJvdGggaW4gb3JkZXIsIGFuZCBmb3IgbG9va3VwIGJ5IGBpZGAuCgogIC8vIENyZWF0ZSBhIG5ldyAqKkNvbGxlY3Rpb24qKiwgcGVyaGFwcyB0byBjb250YWluIGEgc3BlY2lmaWMgdHlwZSBvZiBgbW9kZWxgLgogIC8vIElmIGEgYGNvbXBhcmF0b3JgIGlzIHNwZWNpZmllZCwgdGhlIENvbGxlY3Rpb24gd2lsbCBtYWludGFpbgogIC8vIGl0cyBtb2RlbHMgaW4gc29ydCBvcmRlciwgYXMgdGhleSdyZSBhZGRlZCBhbmQgcmVtb3ZlZC4KICB2YXIgQ29sbGVjdGlvbiA9IEJhY2tib25lLkNvbGxlY3Rpb24gPSBmdW5jdGlvbihtb2RlbHMsIG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CiAgICBpZiAob3B0aW9ucy51cmwpIHRoaXMudXJsID0gb3B0aW9ucy51cmw7CiAgICBpZiAob3B0aW9ucy5tb2RlbCkgdGhpcy5tb2RlbCA9IG9wdGlvbnMubW9kZWw7CiAgICBpZiAob3B0aW9ucy5jb21wYXJhdG9yICE9PSB2b2lkIDApIHRoaXMuY29tcGFyYXRvciA9IG9wdGlvbnMuY29tcGFyYXRvcjsKICAgIHRoaXMuX3Jlc2V0KCk7CiAgICB0aGlzLmluaXRpYWxpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIGlmIChtb2RlbHMpIHRoaXMucmVzZXQobW9kZWxzLCBfLmV4dGVuZCh7c2lsZW50OiB0cnVlfSwgb3B0aW9ucykpOwogIH07CgogIC8vIERlZmF1bHQgb3B0aW9ucyBmb3IgYENvbGxlY3Rpb24jc2V0YC4KICB2YXIgc2V0T3B0aW9ucyA9IHthZGQ6IHRydWUsIHJlbW92ZTogdHJ1ZSwgbWVyZ2U6IHRydWV9OwogIHZhciBhZGRPcHRpb25zID0ge2FkZDogdHJ1ZSwgbWVyZ2U6IGZhbHNlLCByZW1vdmU6IGZhbHNlfTsKCiAgLy8gRGVmaW5lIHRoZSBDb2xsZWN0aW9uJ3MgaW5oZXJpdGFibGUgbWV0aG9kcy4KICBfLmV4dGVuZChDb2xsZWN0aW9uLnByb3RvdHlwZSwgRXZlbnRzLCB7CgogICAgLy8gVGhlIGRlZmF1bHQgbW9kZWwgZm9yIGEgY29sbGVjdGlvbiBpcyBqdXN0IGEgKipCYWNrYm9uZS5Nb2RlbCoqLgogICAgLy8gVGhpcyBzaG91bGQgYmUgb3ZlcnJpZGRlbiBpbiBtb3N0IGNhc2VzLgogICAgbW9kZWw6IE1vZGVsLAoKICAgIC8vIEluaXRpYWxpemUgaXMgYW4gZW1wdHkgZnVuY3Rpb24gYnkgZGVmYXVsdC4gT3ZlcnJpZGUgaXQgd2l0aCB5b3VyIG93bgogICAgLy8gaW5pdGlhbGl6YXRpb24gbG9naWMuCiAgICBpbml0aWFsaXplOiBmdW5jdGlvbigpe30sCgogICAgLy8gVGhlIEpTT04gcmVwcmVzZW50YXRpb24gb2YgYSBDb2xsZWN0aW9uIGlzIGFuIGFycmF5IG9mIHRoZQogICAgLy8gbW9kZWxzJyBhdHRyaWJ1dGVzLgogICAgdG9KU09OOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIHJldHVybiB0aGlzLm1hcChmdW5jdGlvbihtb2RlbCl7IHJldHVybiBtb2RlbC50b0pTT04ob3B0aW9ucyk7IH0pOwogICAgfSwKCiAgICAvLyBQcm94eSBgQmFja2JvbmUuc3luY2AgYnkgZGVmYXVsdC4KICAgIHN5bmM6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gQmFja2JvbmUuc3luYy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfSwKCiAgICAvLyBBZGQgYSBtb2RlbCwgb3IgbGlzdCBvZiBtb2RlbHMgdG8gdGhlIHNldC4KICAgIGFkZDogZnVuY3Rpb24obW9kZWxzLCBvcHRpb25zKSB7CiAgICAgIHJldHVybiB0aGlzLnNldChtb2RlbHMsIF8uZGVmYXVsdHMob3B0aW9ucyB8fCB7fSwgYWRkT3B0aW9ucykpOwogICAgfSwKCiAgICAvLyBSZW1vdmUgYSBtb2RlbCwgb3IgYSBsaXN0IG9mIG1vZGVscyBmcm9tIHRoZSBzZXQuCiAgICByZW1vdmU6IGZ1bmN0aW9uKG1vZGVscywgb3B0aW9ucykgewogICAgICBtb2RlbHMgPSBfLmlzQXJyYXkobW9kZWxzKSA/IG1vZGVscy5zbGljZSgpIDogW21vZGVsc107CiAgICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CiAgICAgIHZhciBpLCBsLCBpbmRleCwgbW9kZWw7CiAgICAgIGZvciAoaSA9IDAsIGwgPSBtb2RlbHMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgbW9kZWwgPSB0aGlzLmdldChtb2RlbHNbaV0pOwogICAgICAgIGlmICghbW9kZWwpIGNvbnRpbnVlOwogICAgICAgIGRlbGV0ZSB0aGlzLl9ieUlkW21vZGVsLmlkXTsKICAgICAgICBkZWxldGUgdGhpcy5fYnlJZFttb2RlbC5jaWRdOwogICAgICAgIGluZGV4ID0gdGhpcy5pbmRleE9mKG1vZGVsKTsKICAgICAgICB0aGlzLm1vZGVscy5zcGxpY2UoaW5kZXgsIDEpOwogICAgICAgIHRoaXMubGVuZ3RoLS07CiAgICAgICAgaWYgKCFvcHRpb25zLnNpbGVudCkgewogICAgICAgICAgb3B0aW9ucy5pbmRleCA9IGluZGV4OwogICAgICAgICAgbW9kZWwudHJpZ2dlcigncmVtb3ZlJywgbW9kZWwsIHRoaXMsIG9wdGlvbnMpOwogICAgICAgIH0KICAgICAgICB0aGlzLl9yZW1vdmVSZWZlcmVuY2UobW9kZWwpOwogICAgICB9CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBVcGRhdGUgYSBjb2xsZWN0aW9uIGJ5IGBzZXRgLWluZyBhIG5ldyBsaXN0IG9mIG1vZGVscywgYWRkaW5nIG5ldyBvbmVzLAogICAgLy8gcmVtb3ZpbmcgbW9kZWxzIHRoYXQgYXJlIG5vIGxvbmdlciBwcmVzZW50LCBhbmQgbWVyZ2luZyBtb2RlbHMgdGhhdAogICAgLy8gYWxyZWFkeSBleGlzdCBpbiB0aGUgY29sbGVjdGlvbiwgYXMgbmVjZXNzYXJ5LiBTaW1pbGFyIHRvICoqTW9kZWwjc2V0KiosCiAgICAvLyB0aGUgY29yZSBvcGVyYXRpb24gZm9yIHVwZGF0aW5nIHRoZSBkYXRhIGNvbnRhaW5lZCBieSB0aGUgY29sbGVjdGlvbi4KICAgIHNldDogZnVuY3Rpb24obW9kZWxzLCBvcHRpb25zKSB7CiAgICAgIG9wdGlvbnMgPSBfLmRlZmF1bHRzKG9wdGlvbnMgfHwge30sIHNldE9wdGlvbnMpOwogICAgICBpZiAob3B0aW9ucy5wYXJzZSkgbW9kZWxzID0gdGhpcy5wYXJzZShtb2RlbHMsIG9wdGlvbnMpOwogICAgICBpZiAoIV8uaXNBcnJheShtb2RlbHMpKSBtb2RlbHMgPSBtb2RlbHMgPyBbbW9kZWxzXSA6IFtdOwogICAgICB2YXIgaSwgbCwgbW9kZWwsIGF0dHJzLCBleGlzdGluZywgc29ydDsKICAgICAgdmFyIGF0ID0gb3B0aW9ucy5hdDsKICAgICAgdmFyIHNvcnRhYmxlID0gdGhpcy5jb21wYXJhdG9yICYmIChhdCA9PSBudWxsKSAmJiBvcHRpb25zLnNvcnQgIT09IGZhbHNlOwogICAgICB2YXIgc29ydEF0dHIgPSBfLmlzU3RyaW5nKHRoaXMuY29tcGFyYXRvcikgPyB0aGlzLmNvbXBhcmF0b3IgOiBudWxsOwogICAgICB2YXIgdG9BZGQgPSBbXSwgdG9SZW1vdmUgPSBbXSwgbW9kZWxNYXAgPSB7fTsKCiAgICAgIC8vIFR1cm4gYmFyZSBvYmplY3RzIGludG8gbW9kZWwgcmVmZXJlbmNlcywgYW5kIHByZXZlbnQgaW52YWxpZCBtb2RlbHMKICAgICAgLy8gZnJvbSBiZWluZyBhZGRlZC4KICAgICAgZm9yIChpID0gMCwgbCA9IG1vZGVscy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICBpZiAoIShtb2RlbCA9IHRoaXMuX3ByZXBhcmVNb2RlbChtb2RlbHNbaV0sIG9wdGlvbnMpKSkgY29udGludWU7CgogICAgICAgIC8vIElmIGEgZHVwbGljYXRlIGlzIGZvdW5kLCBwcmV2ZW50IGl0IGZyb20gYmVpbmcgYWRkZWQgYW5kCiAgICAgICAgLy8gb3B0aW9uYWxseSBtZXJnZSBpdCBpbnRvIHRoZSBleGlzdGluZyBtb2RlbC4KICAgICAgICBpZiAoZXhpc3RpbmcgPSB0aGlzLmdldChtb2RlbCkpIHsKICAgICAgICAgIGlmIChvcHRpb25zLnJlbW92ZSkgbW9kZWxNYXBbZXhpc3RpbmcuY2lkXSA9IHRydWU7CiAgICAgICAgICBpZiAob3B0aW9ucy5tZXJnZSkgewogICAgICAgICAgICBleGlzdGluZy5zZXQobW9kZWwuYXR0cmlidXRlcywgb3B0aW9ucyk7CiAgICAgICAgICAgIGlmIChzb3J0YWJsZSAmJiAhc29ydCAmJiBleGlzdGluZy5oYXNDaGFuZ2VkKHNvcnRBdHRyKSkgc29ydCA9IHRydWU7CiAgICAgICAgICB9CgogICAgICAgIC8vIFRoaXMgaXMgYSBuZXcgbW9kZWwsIHB1c2ggaXQgdG8gdGhlIGB0b0FkZGAgbGlzdC4KICAgICAgICB9IGVsc2UgaWYgKG9wdGlvbnMuYWRkKSB7CiAgICAgICAgICB0b0FkZC5wdXNoKG1vZGVsKTsKCiAgICAgICAgICAvLyBMaXN0ZW4gdG8gYWRkZWQgbW9kZWxzJyBldmVudHMsIGFuZCBpbmRleCBtb2RlbHMgZm9yIGxvb2t1cCBieQogICAgICAgICAgLy8gYGlkYCBhbmQgYnkgYGNpZGAuCiAgICAgICAgICBtb2RlbC5vbignYWxsJywgdGhpcy5fb25Nb2RlbEV2ZW50LCB0aGlzKTsKICAgICAgICAgIHRoaXMuX2J5SWRbbW9kZWwuY2lkXSA9IG1vZGVsOwogICAgICAgICAgaWYgKG1vZGVsLmlkICE9IG51bGwpIHRoaXMuX2J5SWRbbW9kZWwuaWRdID0gbW9kZWw7CiAgICAgICAgfQogICAgICB9CgogICAgICAvLyBSZW1vdmUgbm9uZXhpc3RlbnQgbW9kZWxzIGlmIGFwcHJvcHJpYXRlLgogICAgICBpZiAob3B0aW9ucy5yZW1vdmUpIHsKICAgICAgICBmb3IgKGkgPSAwLCBsID0gdGhpcy5sZW5ndGg7IGkgPCBsOyArK2kpIHsKICAgICAgICAgIGlmICghbW9kZWxNYXBbKG1vZGVsID0gdGhpcy5tb2RlbHNbaV0pLmNpZF0pIHRvUmVtb3ZlLnB1c2gobW9kZWwpOwogICAgICAgIH0KICAgICAgICBpZiAodG9SZW1vdmUubGVuZ3RoKSB0aGlzLnJlbW92ZSh0b1JlbW92ZSwgb3B0aW9ucyk7CiAgICAgIH0KCiAgICAgIC8vIFNlZSBpZiBzb3J0aW5nIGlzIG5lZWRlZCwgdXBkYXRlIGBsZW5ndGhgIGFuZCBzcGxpY2UgaW4gbmV3IG1vZGVscy4KICAgICAgaWYgKHRvQWRkLmxlbmd0aCkgewogICAgICAgIGlmIChzb3J0YWJsZSkgc29ydCA9IHRydWU7CiAgICAgICAgdGhpcy5sZW5ndGggKz0gdG9BZGQubGVuZ3RoOwogICAgICAgIGlmIChhdCAhPSBudWxsKSB7CiAgICAgICAgICBzcGxpY2UuYXBwbHkodGhpcy5tb2RlbHMsIFthdCwgMF0uY29uY2F0KHRvQWRkKSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHB1c2guYXBwbHkodGhpcy5tb2RlbHMsIHRvQWRkKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIC8vIFNpbGVudGx5IHNvcnQgdGhlIGNvbGxlY3Rpb24gaWYgYXBwcm9wcmlhdGUuCiAgICAgIGlmIChzb3J0KSB0aGlzLnNvcnQoe3NpbGVudDogdHJ1ZX0pOwoKICAgICAgaWYgKG9wdGlvbnMuc2lsZW50KSByZXR1cm4gdGhpczsKCiAgICAgIC8vIFRyaWdnZXIgYGFkZGAgZXZlbnRzLgogICAgICBmb3IgKGkgPSAwLCBsID0gdG9BZGQubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgKG1vZGVsID0gdG9BZGRbaV0pLnRyaWdnZXIoJ2FkZCcsIG1vZGVsLCB0aGlzLCBvcHRpb25zKTsKICAgICAgfQoKICAgICAgLy8gVHJpZ2dlciBgc29ydGAgaWYgdGhlIGNvbGxlY3Rpb24gd2FzIHNvcnRlZC4KICAgICAgaWYgKHNvcnQpIHRoaXMudHJpZ2dlcignc29ydCcsIHRoaXMsIG9wdGlvbnMpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gV2hlbiB5b3UgaGF2ZSBtb3JlIGl0ZW1zIHRoYW4geW91IHdhbnQgdG8gYWRkIG9yIHJlbW92ZSBpbmRpdmlkdWFsbHksCiAgICAvLyB5b3UgY2FuIHJlc2V0IHRoZSBlbnRpcmUgc2V0IHdpdGggYSBuZXcgbGlzdCBvZiBtb2RlbHMsIHdpdGhvdXQgZmlyaW5nCiAgICAvLyBhbnkgZ3JhbnVsYXIgYGFkZGAgb3IgYHJlbW92ZWAgZXZlbnRzLiBGaXJlcyBgcmVzZXRgIHdoZW4gZmluaXNoZWQuCiAgICAvLyBVc2VmdWwgZm9yIGJ1bGsgb3BlcmF0aW9ucyBhbmQgb3B0aW1pemF0aW9ucy4KICAgIHJlc2V0OiBmdW5jdGlvbihtb2RlbHMsIG9wdGlvbnMpIHsKICAgICAgb3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KTsKICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSB0aGlzLm1vZGVscy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICB0aGlzLl9yZW1vdmVSZWZlcmVuY2UodGhpcy5tb2RlbHNbaV0pOwogICAgICB9CiAgICAgIG9wdGlvbnMucHJldmlvdXNNb2RlbHMgPSB0aGlzLm1vZGVsczsKICAgICAgdGhpcy5fcmVzZXQoKTsKICAgICAgdGhpcy5hZGQobW9kZWxzLCBfLmV4dGVuZCh7c2lsZW50OiB0cnVlfSwgb3B0aW9ucykpOwogICAgICBpZiAoIW9wdGlvbnMuc2lsZW50KSB0aGlzLnRyaWdnZXIoJ3Jlc2V0JywgdGhpcywgb3B0aW9ucyk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBBZGQgYSBtb2RlbCB0byB0aGUgZW5kIG9mIHRoZSBjb2xsZWN0aW9uLgogICAgcHVzaDogZnVuY3Rpb24obW9kZWwsIG9wdGlvbnMpIHsKICAgICAgbW9kZWwgPSB0aGlzLl9wcmVwYXJlTW9kZWwobW9kZWwsIG9wdGlvbnMpOwogICAgICB0aGlzLmFkZChtb2RlbCwgXy5leHRlbmQoe2F0OiB0aGlzLmxlbmd0aH0sIG9wdGlvbnMpKTsKICAgICAgcmV0dXJuIG1vZGVsOwogICAgfSwKCiAgICAvLyBSZW1vdmUgYSBtb2RlbCBmcm9tIHRoZSBlbmQgb2YgdGhlIGNvbGxlY3Rpb24uCiAgICBwb3A6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgdmFyIG1vZGVsID0gdGhpcy5hdCh0aGlzLmxlbmd0aCAtIDEpOwogICAgICB0aGlzLnJlbW92ZShtb2RlbCwgb3B0aW9ucyk7CiAgICAgIHJldHVybiBtb2RlbDsKICAgIH0sCgogICAgLy8gQWRkIGEgbW9kZWwgdG8gdGhlIGJlZ2lubmluZyBvZiB0aGUgY29sbGVjdGlvbi4KICAgIHVuc2hpZnQ6IGZ1bmN0aW9uKG1vZGVsLCBvcHRpb25zKSB7CiAgICAgIG1vZGVsID0gdGhpcy5fcHJlcGFyZU1vZGVsKG1vZGVsLCBvcHRpb25zKTsKICAgICAgdGhpcy5hZGQobW9kZWwsIF8uZXh0ZW5kKHthdDogMH0sIG9wdGlvbnMpKTsKICAgICAgcmV0dXJuIG1vZGVsOwogICAgfSwKCiAgICAvLyBSZW1vdmUgYSBtb2RlbCBmcm9tIHRoZSBiZWdpbm5pbmcgb2YgdGhlIGNvbGxlY3Rpb24uCiAgICBzaGlmdDogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICB2YXIgbW9kZWwgPSB0aGlzLmF0KDApOwogICAgICB0aGlzLnJlbW92ZShtb2RlbCwgb3B0aW9ucyk7CiAgICAgIHJldHVybiBtb2RlbDsKICAgIH0sCgogICAgLy8gU2xpY2Ugb3V0IGEgc3ViLWFycmF5IG9mIG1vZGVscyBmcm9tIHRoZSBjb2xsZWN0aW9uLgogICAgc2xpY2U6IGZ1bmN0aW9uKGJlZ2luLCBlbmQpIHsKICAgICAgcmV0dXJuIHRoaXMubW9kZWxzLnNsaWNlKGJlZ2luLCBlbmQpOwogICAgfSwKCiAgICAvLyBHZXQgYSBtb2RlbCBmcm9tIHRoZSBzZXQgYnkgaWQuCiAgICBnZXQ6IGZ1bmN0aW9uKG9iaikgewogICAgICBpZiAob2JqID09IG51bGwpIHJldHVybiB2b2lkIDA7CiAgICAgIHJldHVybiB0aGlzLl9ieUlkW29iai5pZCAhPSBudWxsID8gb2JqLmlkIDogb2JqLmNpZCB8fCBvYmpdOwogICAgfSwKCiAgICAvLyBHZXQgdGhlIG1vZGVsIGF0IHRoZSBnaXZlbiBpbmRleC4KICAgIGF0OiBmdW5jdGlvbihpbmRleCkgewogICAgICByZXR1cm4gdGhpcy5tb2RlbHNbaW5kZXhdOwogICAgfSwKCiAgICAvLyBSZXR1cm4gbW9kZWxzIHdpdGggbWF0Y2hpbmcgYXR0cmlidXRlcy4gVXNlZnVsIGZvciBzaW1wbGUgY2FzZXMgb2YKICAgIC8vIGBmaWx0ZXJgLgogICAgd2hlcmU6IGZ1bmN0aW9uKGF0dHJzLCBmaXJzdCkgewogICAgICBpZiAoXy5pc0VtcHR5KGF0dHJzKSkgcmV0dXJuIGZpcnN0ID8gdm9pZCAwIDogW107CiAgICAgIHJldHVybiB0aGlzW2ZpcnN0ID8gJ2ZpbmQnIDogJ2ZpbHRlciddKGZ1bmN0aW9uKG1vZGVsKSB7CiAgICAgICAgZm9yICh2YXIga2V5IGluIGF0dHJzKSB7CiAgICAgICAgICBpZiAoYXR0cnNba2V5XSAhPT0gbW9kZWwuZ2V0KGtleSkpIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0pOwogICAgfSwKCiAgICAvLyBSZXR1cm4gdGhlIGZpcnN0IG1vZGVsIHdpdGggbWF0Y2hpbmcgYXR0cmlidXRlcy4gVXNlZnVsIGZvciBzaW1wbGUgY2FzZXMKICAgIC8vIG9mIGBmaW5kYC4KICAgIGZpbmRXaGVyZTogZnVuY3Rpb24oYXR0cnMpIHsKICAgICAgcmV0dXJuIHRoaXMud2hlcmUoYXR0cnMsIHRydWUpOwogICAgfSwKCiAgICAvLyBGb3JjZSB0aGUgY29sbGVjdGlvbiB0byByZS1zb3J0IGl0c2VsZi4gWW91IGRvbid0IG5lZWQgdG8gY2FsbCB0aGlzIHVuZGVyCiAgICAvLyBub3JtYWwgY2lyY3Vtc3RhbmNlcywgYXMgdGhlIHNldCB3aWxsIG1haW50YWluIHNvcnQgb3JkZXIgYXMgZWFjaCBpdGVtCiAgICAvLyBpcyBhZGRlZC4KICAgIHNvcnQ6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgaWYgKCF0aGlzLmNvbXBhcmF0b3IpIHRocm93IG5ldyBFcnJvcignQ2Fubm90IHNvcnQgYSBzZXQgd2l0aG91dCBhIGNvbXBhcmF0b3InKTsKICAgICAgb3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KTsKCiAgICAgIC8vIFJ1biBzb3J0IGJhc2VkIG9uIHR5cGUgb2YgYGNvbXBhcmF0b3JgLgogICAgICBpZiAoXy5pc1N0cmluZyh0aGlzLmNvbXBhcmF0b3IpIHx8IHRoaXMuY29tcGFyYXRvci5sZW5ndGggPT09IDEpIHsKICAgICAgICB0aGlzLm1vZGVscyA9IHRoaXMuc29ydEJ5KHRoaXMuY29tcGFyYXRvciwgdGhpcyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5tb2RlbHMuc29ydChfLmJpbmQodGhpcy5jb21wYXJhdG9yLCB0aGlzKSk7CiAgICAgIH0KCiAgICAgIGlmICghb3B0aW9ucy5zaWxlbnQpIHRoaXMudHJpZ2dlcignc29ydCcsIHRoaXMsIG9wdGlvbnMpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gRmlndXJlIG91dCB0aGUgc21hbGxlc3QgaW5kZXggYXQgd2hpY2ggYSBtb2RlbCBzaG91bGQgYmUgaW5zZXJ0ZWQgc28gYXMKICAgIC8vIHRvIG1haW50YWluIG9yZGVyLgogICAgc29ydGVkSW5kZXg6IGZ1bmN0aW9uKG1vZGVsLCB2YWx1ZSwgY29udGV4dCkgewogICAgICB2YWx1ZSB8fCAodmFsdWUgPSB0aGlzLmNvbXBhcmF0b3IpOwogICAgICB2YXIgaXRlcmF0b3IgPSBfLmlzRnVuY3Rpb24odmFsdWUpID8gdmFsdWUgOiBmdW5jdGlvbihtb2RlbCkgewogICAgICAgIHJldHVybiBtb2RlbC5nZXQodmFsdWUpOwogICAgICB9OwogICAgICByZXR1cm4gXy5zb3J0ZWRJbmRleCh0aGlzLm1vZGVscywgbW9kZWwsIGl0ZXJhdG9yLCBjb250ZXh0KTsKICAgIH0sCgogICAgLy8gUGx1Y2sgYW4gYXR0cmlidXRlIGZyb20gZWFjaCBtb2RlbCBpbiB0aGUgY29sbGVjdGlvbi4KICAgIHBsdWNrOiBmdW5jdGlvbihhdHRyKSB7CiAgICAgIHJldHVybiBfLmludm9rZSh0aGlzLm1vZGVscywgJ2dldCcsIGF0dHIpOwogICAgfSwKCiAgICAvLyBGZXRjaCB0aGUgZGVmYXVsdCBzZXQgb2YgbW9kZWxzIGZvciB0aGlzIGNvbGxlY3Rpb24sIHJlc2V0dGluZyB0aGUKICAgIC8vIGNvbGxlY3Rpb24gd2hlbiB0aGV5IGFycml2ZS4gSWYgYHJlc2V0OiB0cnVlYCBpcyBwYXNzZWQsIHRoZSByZXNwb25zZQogICAgLy8gZGF0YSB3aWxsIGJlIHBhc3NlZCB0aHJvdWdoIHRoZSBgcmVzZXRgIG1ldGhvZCBpbnN0ZWFkIG9mIGBzZXRgLgogICAgZmV0Y2g6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgPyBfLmNsb25lKG9wdGlvbnMpIDoge307CiAgICAgIGlmIChvcHRpb25zLnBhcnNlID09PSB2b2lkIDApIG9wdGlvbnMucGFyc2UgPSB0cnVlOwogICAgICB2YXIgc3VjY2VzcyA9IG9wdGlvbnMuc3VjY2VzczsKICAgICAgdmFyIGNvbGxlY3Rpb24gPSB0aGlzOwogICAgICBvcHRpb25zLnN1Y2Nlc3MgPSBmdW5jdGlvbihyZXNwKSB7CiAgICAgICAgdmFyIG1ldGhvZCA9IG9wdGlvbnMucmVzZXQgPyAncmVzZXQnIDogJ3NldCc7CiAgICAgICAgY29sbGVjdGlvblttZXRob2RdKHJlc3AsIG9wdGlvbnMpOwogICAgICAgIGlmIChzdWNjZXNzKSBzdWNjZXNzKGNvbGxlY3Rpb24sIHJlc3AsIG9wdGlvbnMpOwogICAgICAgIGNvbGxlY3Rpb24udHJpZ2dlcignc3luYycsIGNvbGxlY3Rpb24sIHJlc3AsIG9wdGlvbnMpOwogICAgICB9OwogICAgICB3cmFwRXJyb3IodGhpcywgb3B0aW9ucyk7CiAgICAgIHJldHVybiB0aGlzLnN5bmMoJ3JlYWQnLCB0aGlzLCBvcHRpb25zKTsKICAgIH0sCgogICAgLy8gQ3JlYXRlIGEgbmV3IGluc3RhbmNlIG9mIGEgbW9kZWwgaW4gdGhpcyBjb2xsZWN0aW9uLiBBZGQgdGhlIG1vZGVsIHRvIHRoZQogICAgLy8gY29sbGVjdGlvbiBpbW1lZGlhdGVseSwgdW5sZXNzIGB3YWl0OiB0cnVlYCBpcyBwYXNzZWQsIGluIHdoaWNoIGNhc2Ugd2UKICAgIC8vIHdhaXQgZm9yIHRoZSBzZXJ2ZXIgdG8gYWdyZWUuCiAgICBjcmVhdGU6IGZ1bmN0aW9uKG1vZGVsLCBvcHRpb25zKSB7CiAgICAgIG9wdGlvbnMgPSBvcHRpb25zID8gXy5jbG9uZShvcHRpb25zKSA6IHt9OwogICAgICBpZiAoIShtb2RlbCA9IHRoaXMuX3ByZXBhcmVNb2RlbChtb2RlbCwgb3B0aW9ucykpKSByZXR1cm4gZmFsc2U7CiAgICAgIGlmICghb3B0aW9ucy53YWl0KSB0aGlzLmFkZChtb2RlbCwgb3B0aW9ucyk7CiAgICAgIHZhciBjb2xsZWN0aW9uID0gdGhpczsKICAgICAgdmFyIHN1Y2Nlc3MgPSBvcHRpb25zLnN1Y2Nlc3M7CiAgICAgIG9wdGlvbnMuc3VjY2VzcyA9IGZ1bmN0aW9uKHJlc3ApIHsKICAgICAgICBpZiAob3B0aW9ucy53YWl0KSBjb2xsZWN0aW9uLmFkZChtb2RlbCwgb3B0aW9ucyk7CiAgICAgICAgaWYgKHN1Y2Nlc3MpIHN1Y2Nlc3MobW9kZWwsIHJlc3AsIG9wdGlvbnMpOwogICAgICB9OwogICAgICBtb2RlbC5zYXZlKG51bGwsIG9wdGlvbnMpOwogICAgICByZXR1cm4gbW9kZWw7CiAgICB9LAoKICAgIC8vICoqcGFyc2UqKiBjb252ZXJ0cyBhIHJlc3BvbnNlIGludG8gYSBsaXN0IG9mIG1vZGVscyB0byBiZSBhZGRlZCB0byB0aGUKICAgIC8vIGNvbGxlY3Rpb24uIFRoZSBkZWZhdWx0IGltcGxlbWVudGF0aW9uIGlzIGp1c3QgdG8gcGFzcyBpdCB0aHJvdWdoLgogICAgcGFyc2U6IGZ1bmN0aW9uKHJlc3AsIG9wdGlvbnMpIHsKICAgICAgcmV0dXJuIHJlc3A7CiAgICB9LAoKICAgIC8vIENyZWF0ZSBhIG5ldyBjb2xsZWN0aW9uIHdpdGggYW4gaWRlbnRpY2FsIGxpc3Qgb2YgbW9kZWxzIGFzIHRoaXMgb25lLgogICAgY2xvbmU6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gbmV3IHRoaXMuY29uc3RydWN0b3IodGhpcy5tb2RlbHMpOwogICAgfSwKCiAgICAvLyBQcml2YXRlIG1ldGhvZCB0byByZXNldCBhbGwgaW50ZXJuYWwgc3RhdGUuIENhbGxlZCB3aGVuIHRoZSBjb2xsZWN0aW9uCiAgICAvLyBpcyBmaXJzdCBpbml0aWFsaXplZCBvciByZXNldC4KICAgIF9yZXNldDogZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMubGVuZ3RoID0gMDsKICAgICAgdGhpcy5tb2RlbHMgPSBbXTsKICAgICAgdGhpcy5fYnlJZCAgPSB7fTsKICAgIH0sCgogICAgLy8gUHJlcGFyZSBhIGhhc2ggb2YgYXR0cmlidXRlcyAob3Igb3RoZXIgbW9kZWwpIHRvIGJlIGFkZGVkIHRvIHRoaXMKICAgIC8vIGNvbGxlY3Rpb24uCiAgICBfcHJlcGFyZU1vZGVsOiBmdW5jdGlvbihhdHRycywgb3B0aW9ucykgewogICAgICBpZiAoYXR0cnMgaW5zdGFuY2VvZiBNb2RlbCkgewogICAgICAgIGlmICghYXR0cnMuY29sbGVjdGlvbikgYXR0cnMuY29sbGVjdGlvbiA9IHRoaXM7CiAgICAgICAgcmV0dXJuIGF0dHJzOwogICAgICB9CiAgICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CiAgICAgIG9wdGlvbnMuY29sbGVjdGlvbiA9IHRoaXM7CiAgICAgIHZhciBtb2RlbCA9IG5ldyB0aGlzLm1vZGVsKGF0dHJzLCBvcHRpb25zKTsKICAgICAgaWYgKCFtb2RlbC5fdmFsaWRhdGUoYXR0cnMsIG9wdGlvbnMpKSB7CiAgICAgICAgdGhpcy50cmlnZ2VyKCdpbnZhbGlkJywgdGhpcywgYXR0cnMsIG9wdGlvbnMpOwogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICByZXR1cm4gbW9kZWw7CiAgICB9LAoKICAgIC8vIEludGVybmFsIG1ldGhvZCB0byBzZXZlciBhIG1vZGVsJ3MgdGllcyB0byBhIGNvbGxlY3Rpb24uCiAgICBfcmVtb3ZlUmVmZXJlbmNlOiBmdW5jdGlvbihtb2RlbCkgewogICAgICBpZiAodGhpcyA9PT0gbW9kZWwuY29sbGVjdGlvbikgZGVsZXRlIG1vZGVsLmNvbGxlY3Rpb247CiAgICAgIG1vZGVsLm9mZignYWxsJywgdGhpcy5fb25Nb2RlbEV2ZW50LCB0aGlzKTsKICAgIH0sCgogICAgLy8gSW50ZXJuYWwgbWV0aG9kIGNhbGxlZCBldmVyeSB0aW1lIGEgbW9kZWwgaW4gdGhlIHNldCBmaXJlcyBhbiBldmVudC4KICAgIC8vIFNldHMgbmVlZCB0byB1cGRhdGUgdGhlaXIgaW5kZXhlcyB3aGVuIG1vZGVscyBjaGFuZ2UgaWRzLiBBbGwgb3RoZXIKICAgIC8vIGV2ZW50cyBzaW1wbHkgcHJveHkgdGhyb3VnaC4gImFkZCIgYW5kICJyZW1vdmUiIGV2ZW50cyB0aGF0IG9yaWdpbmF0ZQogICAgLy8gaW4gb3RoZXIgY29sbGVjdGlvbnMgYXJlIGlnbm9yZWQuCiAgICBfb25Nb2RlbEV2ZW50OiBmdW5jdGlvbihldmVudCwgbW9kZWwsIGNvbGxlY3Rpb24sIG9wdGlvbnMpIHsKICAgICAgaWYgKChldmVudCA9PT0gJ2FkZCcgfHwgZXZlbnQgPT09ICdyZW1vdmUnKSAmJiBjb2xsZWN0aW9uICE9PSB0aGlzKSByZXR1cm47CiAgICAgIGlmIChldmVudCA9PT0gJ2Rlc3Ryb3knKSB0aGlzLnJlbW92ZShtb2RlbCwgb3B0aW9ucyk7CiAgICAgIGlmIChtb2RlbCAmJiBldmVudCA9PT0gJ2NoYW5nZTonICsgbW9kZWwuaWRBdHRyaWJ1dGUpIHsKICAgICAgICBkZWxldGUgdGhpcy5fYnlJZFttb2RlbC5wcmV2aW91cyhtb2RlbC5pZEF0dHJpYnV0ZSldOwogICAgICAgIGlmIChtb2RlbC5pZCAhPSBudWxsKSB0aGlzLl9ieUlkW21vZGVsLmlkXSA9IG1vZGVsOwogICAgICB9CiAgICAgIHRoaXMudHJpZ2dlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfQoKICB9KTsKCiAgLy8gVW5kZXJzY29yZSBtZXRob2RzIHRoYXQgd2Ugd2FudCB0byBpbXBsZW1lbnQgb24gdGhlIENvbGxlY3Rpb24uCiAgLy8gOTAlIG9mIHRoZSBjb3JlIHVzZWZ1bG5lc3Mgb2YgQmFja2JvbmUgQ29sbGVjdGlvbnMgaXMgYWN0dWFsbHkgaW1wbGVtZW50ZWQKICAvLyByaWdodCBoZXJlOgogIHZhciBtZXRob2RzID0gWydmb3JFYWNoJywgJ2VhY2gnLCAnbWFwJywgJ2NvbGxlY3QnLCAncmVkdWNlJywgJ2ZvbGRsJywKICAgICdpbmplY3QnLCAncmVkdWNlUmlnaHQnLCAnZm9sZHInLCAnZmluZCcsICdkZXRlY3QnLCAnZmlsdGVyJywgJ3NlbGVjdCcsCiAgICAncmVqZWN0JywgJ2V2ZXJ5JywgJ2FsbCcsICdzb21lJywgJ2FueScsICdpbmNsdWRlJywgJ2NvbnRhaW5zJywgJ2ludm9rZScsCiAgICAnbWF4JywgJ21pbicsICd0b0FycmF5JywgJ3NpemUnLCAnZmlyc3QnLCAnaGVhZCcsICd0YWtlJywgJ2luaXRpYWwnLCAncmVzdCcsCiAgICAndGFpbCcsICdkcm9wJywgJ2xhc3QnLCAnd2l0aG91dCcsICdpbmRleE9mJywgJ3NodWZmbGUnLCAnbGFzdEluZGV4T2YnLAogICAgJ2lzRW1wdHknLCAnY2hhaW4nXTsKCiAgLy8gTWl4IGluIGVhY2ggVW5kZXJzY29yZSBtZXRob2QgYXMgYSBwcm94eSB0byBgQ29sbGVjdGlvbiNtb2RlbHNgLgogIF8uZWFjaChtZXRob2RzLCBmdW5jdGlvbihtZXRob2QpIHsKICAgIENvbGxlY3Rpb24ucHJvdG90eXBlW21ldGhvZF0gPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cyk7CiAgICAgIGFyZ3MudW5zaGlmdCh0aGlzLm1vZGVscyk7CiAgICAgIHJldHVybiBfW21ldGhvZF0uYXBwbHkoXywgYXJncyk7CiAgICB9OwogIH0pOwoKICAvLyBVbmRlcnNjb3JlIG1ldGhvZHMgdGhhdCB0YWtlIGEgcHJvcGVydHkgbmFtZSBhcyBhbiBhcmd1bWVudC4KICB2YXIgYXR0cmlidXRlTWV0aG9kcyA9IFsnZ3JvdXBCeScsICdjb3VudEJ5JywgJ3NvcnRCeSddOwoKICAvLyBVc2UgYXR0cmlidXRlcyBpbnN0ZWFkIG9mIHByb3BlcnRpZXMuCiAgXy5lYWNoKGF0dHJpYnV0ZU1ldGhvZHMsIGZ1bmN0aW9uKG1ldGhvZCkgewogICAgQ29sbGVjdGlvbi5wcm90b3R5cGVbbWV0aG9kXSA9IGZ1bmN0aW9uKHZhbHVlLCBjb250ZXh0KSB7CiAgICAgIHZhciBpdGVyYXRvciA9IF8uaXNGdW5jdGlvbih2YWx1ZSkgPyB2YWx1ZSA6IGZ1bmN0aW9uKG1vZGVsKSB7CiAgICAgICAgcmV0dXJuIG1vZGVsLmdldCh2YWx1ZSk7CiAgICAgIH07CiAgICAgIHJldHVybiBfW21ldGhvZF0odGhpcy5tb2RlbHMsIGl0ZXJhdG9yLCBjb250ZXh0KTsKICAgIH07CiAgfSk7CgogIC8vIEJhY2tib25lLlZpZXcKICAvLyAtLS0tLS0tLS0tLS0tCgogIC8vIEJhY2tib25lIFZpZXdzIGFyZSBhbG1vc3QgbW9yZSBjb252ZW50aW9uIHRoYW4gdGhleSBhcmUgYWN0dWFsIGNvZGUuIEEgVmlldwogIC8vIGlzIHNpbXBseSBhIEphdmFTY3JpcHQgb2JqZWN0IHRoYXQgcmVwcmVzZW50cyBhIGxvZ2ljYWwgY2h1bmsgb2YgVUkgaW4gdGhlCiAgLy8gRE9NLiBUaGlzIG1pZ2h0IGJlIGEgc2luZ2xlIGl0ZW0sIGFuIGVudGlyZSBsaXN0LCBhIHNpZGViYXIgb3IgcGFuZWwsIG9yCiAgLy8gZXZlbiB0aGUgc3Vycm91bmRpbmcgZnJhbWUgd2hpY2ggd3JhcHMgeW91ciB3aG9sZSBhcHAuIERlZmluaW5nIGEgY2h1bmsgb2YKICAvLyBVSSBhcyBhICoqVmlldyoqIGFsbG93cyB5b3UgdG8gZGVmaW5lIHlvdXIgRE9NIGV2ZW50cyBkZWNsYXJhdGl2ZWx5LCB3aXRob3V0CiAgLy8gaGF2aW5nIHRvIHdvcnJ5IGFib3V0IHJlbmRlciBvcmRlciAuLi4gYW5kIG1ha2VzIGl0IGVhc3kgZm9yIHRoZSB2aWV3IHRvCiAgLy8gcmVhY3QgdG8gc3BlY2lmaWMgY2hhbmdlcyBpbiB0aGUgc3RhdGUgb2YgeW91ciBtb2RlbHMuCgogIC8vIENyZWF0aW5nIGEgQmFja2JvbmUuVmlldyBjcmVhdGVzIGl0cyBpbml0aWFsIGVsZW1lbnQgb3V0c2lkZSBvZiB0aGUgRE9NLAogIC8vIGlmIGFuIGV4aXN0aW5nIGVsZW1lbnQgaXMgbm90IHByb3ZpZGVkLi4uCiAgdmFyIFZpZXcgPSBCYWNrYm9uZS5WaWV3ID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgdGhpcy5jaWQgPSBfLnVuaXF1ZUlkKCd2aWV3Jyk7CiAgICB0aGlzLl9jb25maWd1cmUob3B0aW9ucyB8fCB7fSk7CiAgICB0aGlzLl9lbnN1cmVFbGVtZW50KCk7CiAgICB0aGlzLmluaXRpYWxpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIHRoaXMuZGVsZWdhdGVFdmVudHMoKTsKICB9OwoKICAvLyBDYWNoZWQgcmVnZXggdG8gc3BsaXQga2V5cyBmb3IgYGRlbGVnYXRlYC4KICB2YXIgZGVsZWdhdGVFdmVudFNwbGl0dGVyID0gL14oXFMrKVxzKiguKikkLzsKCiAgLy8gTGlzdCBvZiB2aWV3IG9wdGlvbnMgdG8gYmUgbWVyZ2VkIGFzIHByb3BlcnRpZXMuCiAgdmFyIHZpZXdPcHRpb25zID0gWydtb2RlbCcsICdjb2xsZWN0aW9uJywgJ2VsJywgJ2lkJywgJ2F0dHJpYnV0ZXMnLCAnY2xhc3NOYW1lJywgJ3RhZ05hbWUnLCAnZXZlbnRzJ107CgogIC8vIFNldCB1cCBhbGwgaW5oZXJpdGFibGUgKipCYWNrYm9uZS5WaWV3KiogcHJvcGVydGllcyBhbmQgbWV0aG9kcy4KICBfLmV4dGVuZChWaWV3LnByb3RvdHlwZSwgRXZlbnRzLCB7CgogICAgLy8gVGhlIGRlZmF1bHQgYHRhZ05hbWVgIG9mIGEgVmlldydzIGVsZW1lbnQgaXMgYCJkaXYiYC4KICAgIHRhZ05hbWU6ICdkaXYnLAoKICAgIC8vIGpRdWVyeSBkZWxlZ2F0ZSBmb3IgZWxlbWVudCBsb29rdXAsIHNjb3BlZCB0byBET00gZWxlbWVudHMgd2l0aGluIHRoZQogICAgLy8gY3VycmVudCB2aWV3LiBUaGlzIHNob3VsZCBiZSBwcmVmZXJlZCB0byBnbG9iYWwgbG9va3VwcyB3aGVyZSBwb3NzaWJsZS4KICAgICQ6IGZ1bmN0aW9uKHNlbGVjdG9yKSB7CiAgICAgIHJldHVybiB0aGlzLiRlbC5maW5kKHNlbGVjdG9yKTsKICAgIH0sCgogICAgLy8gSW5pdGlhbGl6ZSBpcyBhbiBlbXB0eSBmdW5jdGlvbiBieSBkZWZhdWx0LiBPdmVycmlkZSBpdCB3aXRoIHlvdXIgb3duCiAgICAvLyBpbml0aWFsaXphdGlvbiBsb2dpYy4KICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uKCl7fSwKCiAgICAvLyAqKnJlbmRlcioqIGlzIHRoZSBjb3JlIGZ1bmN0aW9uIHRoYXQgeW91ciB2aWV3IHNob3VsZCBvdmVycmlkZSwgaW4gb3JkZXIKICAgIC8vIHRvIHBvcHVsYXRlIGl0cyBlbGVtZW50IChgdGhpcy5lbGApLCB3aXRoIHRoZSBhcHByb3ByaWF0ZSBIVE1MLiBUaGUKICAgIC8vIGNvbnZlbnRpb24gaXMgZm9yICoqcmVuZGVyKiogdG8gYWx3YXlzIHJldHVybiBgdGhpc2AuCiAgICByZW5kZXI6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gUmVtb3ZlIHRoaXMgdmlldyBieSB0YWtpbmcgdGhlIGVsZW1lbnQgb3V0IG9mIHRoZSBET00sIGFuZCByZW1vdmluZyBhbnkKICAgIC8vIGFwcGxpY2FibGUgQmFja2JvbmUuRXZlbnRzIGxpc3RlbmVycy4KICAgIHJlbW92ZTogZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMuJGVsLnJlbW92ZSgpOwogICAgICB0aGlzLnN0b3BMaXN0ZW5pbmcoKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIENoYW5nZSB0aGUgdmlldydzIGVsZW1lbnQgKGB0aGlzLmVsYCBwcm9wZXJ0eSksIGluY2x1ZGluZyBldmVudAogICAgLy8gcmUtZGVsZWdhdGlvbi4KICAgIHNldEVsZW1lbnQ6IGZ1bmN0aW9uKGVsZW1lbnQsIGRlbGVnYXRlKSB7CiAgICAgIGlmICh0aGlzLiRlbCkgdGhpcy51bmRlbGVnYXRlRXZlbnRzKCk7CiAgICAgIHRoaXMuJGVsID0gZWxlbWVudCBpbnN0YW5jZW9mIEJhY2tib25lLiQgPyBlbGVtZW50IDogQmFja2JvbmUuJChlbGVtZW50KTsKICAgICAgdGhpcy5lbCA9IHRoaXMuJGVsWzBdOwogICAgICBpZiAoZGVsZWdhdGUgIT09IGZhbHNlKSB0aGlzLmRlbGVnYXRlRXZlbnRzKCk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBTZXQgY2FsbGJhY2tzLCB3aGVyZSBgdGhpcy5ldmVudHNgIGlzIGEgaGFzaCBvZgogICAgLy8KICAgIC8vICp7ImV2ZW50IHNlbGVjdG9yIjogImNhbGxiYWNrIn0qCiAgICAvLwogICAgLy8gICAgIHsKICAgIC8vICAgICAgICdtb3VzZWRvd24gLnRpdGxlJzogICdlZGl0JywKICAgIC8vICAgICAgICdjbGljayAuYnV0dG9uJzogICAgICdzYXZlJwogICAgLy8gICAgICAgJ2NsaWNrIC5vcGVuJzogICAgICAgZnVuY3Rpb24oZSkgeyAuLi4gfQogICAgLy8gICAgIH0KICAgIC8vCiAgICAvLyBwYWlycy4gQ2FsbGJhY2tzIHdpbGwgYmUgYm91bmQgdG8gdGhlIHZpZXcsIHdpdGggYHRoaXNgIHNldCBwcm9wZXJseS4KICAgIC8vIFVzZXMgZXZlbnQgZGVsZWdhdGlvbiBmb3IgZWZmaWNpZW5jeS4KICAgIC8vIE9taXR0aW5nIHRoZSBzZWxlY3RvciBiaW5kcyB0aGUgZXZlbnQgdG8gYHRoaXMuZWxgLgogICAgLy8gVGhpcyBvbmx5IHdvcmtzIGZvciBkZWxlZ2F0ZS1hYmxlIGV2ZW50czogbm90IGBmb2N1c2AsIGBibHVyYCwgYW5kCiAgICAvLyBub3QgYGNoYW5nZWAsIGBzdWJtaXRgLCBhbmQgYHJlc2V0YCBpbiBJbnRlcm5ldCBFeHBsb3Jlci4KICAgIGRlbGVnYXRlRXZlbnRzOiBmdW5jdGlvbihldmVudHMpIHsKICAgICAgaWYgKCEoZXZlbnRzIHx8IChldmVudHMgPSBfLnJlc3VsdCh0aGlzLCAnZXZlbnRzJykpKSkgcmV0dXJuIHRoaXM7CiAgICAgIHRoaXMudW5kZWxlZ2F0ZUV2ZW50cygpOwogICAgICBmb3IgKHZhciBrZXkgaW4gZXZlbnRzKSB7CiAgICAgICAgdmFyIG1ldGhvZCA9IGV2ZW50c1trZXldOwogICAgICAgIGlmICghXy5pc0Z1bmN0aW9uKG1ldGhvZCkpIG1ldGhvZCA9IHRoaXNbZXZlbnRzW2tleV1dOwogICAgICAgIGlmICghbWV0aG9kKSBjb250aW51ZTsKCiAgICAgICAgdmFyIG1hdGNoID0ga2V5Lm1hdGNoKGRlbGVnYXRlRXZlbnRTcGxpdHRlcik7CiAgICAgICAgdmFyIGV2ZW50TmFtZSA9IG1hdGNoWzFdLCBzZWxlY3RvciA9IG1hdGNoWzJdOwogICAgICAgIG1ldGhvZCA9IF8uYmluZChtZXRob2QsIHRoaXMpOwogICAgICAgIGV2ZW50TmFtZSArPSAnLmRlbGVnYXRlRXZlbnRzJyArIHRoaXMuY2lkOwogICAgICAgIGlmIChzZWxlY3RvciA9PT0gJycpIHsKICAgICAgICAgIHRoaXMuJGVsLm9uKGV2ZW50TmFtZSwgbWV0aG9kKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhpcy4kZWwub24oZXZlbnROYW1lLCBzZWxlY3RvciwgbWV0aG9kKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIENsZWFycyBhbGwgY2FsbGJhY2tzIHByZXZpb3VzbHkgYm91bmQgdG8gdGhlIHZpZXcgd2l0aCBgZGVsZWdhdGVFdmVudHNgLgogICAgLy8gWW91IHVzdWFsbHkgZG9uJ3QgbmVlZCB0byB1c2UgdGhpcywgYnV0IG1heSB3aXNoIHRvIGlmIHlvdSBoYXZlIG11bHRpcGxlCiAgICAvLyBCYWNrYm9uZSB2aWV3cyBhdHRhY2hlZCB0byB0aGUgc2FtZSBET00gZWxlbWVudC4KICAgIHVuZGVsZWdhdGVFdmVudHM6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLiRlbC5vZmYoJy5kZWxlZ2F0ZUV2ZW50cycgKyB0aGlzLmNpZCk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBQZXJmb3JtcyB0aGUgaW5pdGlhbCBjb25maWd1cmF0aW9uIG9mIGEgVmlldyB3aXRoIGEgc2V0IG9mIG9wdGlvbnMuCiAgICAvLyBLZXlzIHdpdGggc3BlY2lhbCBtZWFuaW5nICooZS5nLiBtb2RlbCwgY29sbGVjdGlvbiwgaWQsIGNsYXNzTmFtZSkqIGFyZQogICAgLy8gYXR0YWNoZWQgZGlyZWN0bHkgdG8gdGhlIHZpZXcuICBTZWUgYHZpZXdPcHRpb25zYCBmb3IgYW4gZXhoYXVzdGl2ZQogICAgLy8gbGlzdC4KICAgIF9jb25maWd1cmU6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgaWYgKHRoaXMub3B0aW9ucykgb3B0aW9ucyA9IF8uZXh0ZW5kKHt9LCBfLnJlc3VsdCh0aGlzLCAnb3B0aW9ucycpLCBvcHRpb25zKTsKICAgICAgXy5leHRlbmQodGhpcywgXy5waWNrKG9wdGlvbnMsIHZpZXdPcHRpb25zKSk7CiAgICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnM7CiAgICB9LAoKICAgIC8vIEVuc3VyZSB0aGF0IHRoZSBWaWV3IGhhcyBhIERPTSBlbGVtZW50IHRvIHJlbmRlciBpbnRvLgogICAgLy8gSWYgYHRoaXMuZWxgIGlzIGEgc3RyaW5nLCBwYXNzIGl0IHRocm91Z2ggYCQoKWAsIHRha2UgdGhlIGZpcnN0CiAgICAvLyBtYXRjaGluZyBlbGVtZW50LCBhbmQgcmUtYXNzaWduIGl0IHRvIGBlbGAuIE90aGVyd2lzZSwgY3JlYXRlCiAgICAvLyBhbiBlbGVtZW50IGZyb20gdGhlIGBpZGAsIGBjbGFzc05hbWVgIGFuZCBgdGFnTmFtZWAgcHJvcGVydGllcy4KICAgIF9lbnN1cmVFbGVtZW50OiBmdW5jdGlvbigpIHsKICAgICAgaWYgKCF0aGlzLmVsKSB7CiAgICAgICAgdmFyIGF0dHJzID0gXy5leHRlbmQoe30sIF8ucmVzdWx0KHRoaXMsICdhdHRyaWJ1dGVzJykpOwogICAgICAgIGlmICh0aGlzLmlkKSBhdHRycy5pZCA9IF8ucmVzdWx0KHRoaXMsICdpZCcpOwogICAgICAgIGlmICh0aGlzLmNsYXNzTmFtZSkgYXR0cnNbJ2NsYXNzJ10gPSBfLnJlc3VsdCh0aGlzLCAnY2xhc3NOYW1lJyk7CiAgICAgICAgdmFyICRlbCA9IEJhY2tib25lLiQoJzwnICsgXy5yZXN1bHQodGhpcywgJ3RhZ05hbWUnKSArICc+JykuYXR0cihhdHRycyk7CiAgICAgICAgdGhpcy5zZXRFbGVtZW50KCRlbCwgZmFsc2UpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuc2V0RWxlbWVudChfLnJlc3VsdCh0aGlzLCAnZWwnKSwgZmFsc2UpOwogICAgICB9CiAgICB9CgogIH0pOwoKICAvLyBCYWNrYm9uZS5zeW5jCiAgLy8gLS0tLS0tLS0tLS0tLQoKICAvLyBPdmVycmlkZSB0aGlzIGZ1bmN0aW9uIHRvIGNoYW5nZSB0aGUgbWFubmVyIGluIHdoaWNoIEJhY2tib25lIHBlcnNpc3RzCiAgLy8gbW9kZWxzIHRvIHRoZSBzZXJ2ZXIuIFlvdSB3aWxsIGJlIHBhc3NlZCB0aGUgdHlwZSBvZiByZXF1ZXN0LCBhbmQgdGhlCiAgLy8gbW9kZWwgaW4gcXVlc3Rpb24uIEJ5IGRlZmF1bHQsIG1ha2VzIGEgUkVTVGZ1bCBBamF4IHJlcXVlc3QKICAvLyB0byB0aGUgbW9kZWwncyBgdXJsKClgLiBTb21lIHBvc3NpYmxlIGN1c3RvbWl6YXRpb25zIGNvdWxkIGJlOgogIC8vCiAgLy8gKiBVc2UgYHNldFRpbWVvdXRgIHRvIGJhdGNoIHJhcGlkLWZpcmUgdXBkYXRlcyBpbnRvIGEgc2luZ2xlIHJlcXVlc3QuCiAgLy8gKiBTZW5kIHVwIHRoZSBtb2RlbHMgYXMgWE1MIGluc3RlYWQgb2YgSlNPTi4KICAvLyAqIFBlcnNpc3QgbW9kZWxzIHZpYSBXZWJTb2NrZXRzIGluc3RlYWQgb2YgQWpheC4KICAvLwogIC8vIFR1cm4gb24gYEJhY2tib25lLmVtdWxhdGVIVFRQYCBpbiBvcmRlciB0byBzZW5kIGBQVVRgIGFuZCBgREVMRVRFYCByZXF1ZXN0cwogIC8vIGFzIGBQT1NUYCwgd2l0aCBhIGBfbWV0aG9kYCBwYXJhbWV0ZXIgY29udGFpbmluZyB0aGUgdHJ1ZSBIVFRQIG1ldGhvZCwKICAvLyBhcyB3ZWxsIGFzIGFsbCByZXF1ZXN0cyB3aXRoIHRoZSBib2R5IGFzIGBhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWRgCiAgLy8gaW5zdGVhZCBvZiBgYXBwbGljYXRpb24vanNvbmAgd2l0aCB0aGUgbW9kZWwgaW4gYSBwYXJhbSBuYW1lZCBgbW9kZWxgLgogIC8vIFVzZWZ1bCB3aGVuIGludGVyZmFjaW5nIHdpdGggc2VydmVyLXNpZGUgbGFuZ3VhZ2VzIGxpa2UgKipQSFAqKiB0aGF0IG1ha2UKICAvLyBpdCBkaWZmaWN1bHQgdG8gcmVhZCB0aGUgYm9keSBvZiBgUFVUYCByZXF1ZXN0cy4KICBCYWNrYm9uZS5zeW5jID0gZnVuY3Rpb24obWV0aG9kLCBtb2RlbCwgb3B0aW9ucykgewogICAgdmFyIHR5cGUgPSBtZXRob2RNYXBbbWV0aG9kXTsKCiAgICAvLyBEZWZhdWx0IG9wdGlvbnMsIHVubGVzcyBzcGVjaWZpZWQuCiAgICBfLmRlZmF1bHRzKG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSksIHsKICAgICAgZW11bGF0ZUhUVFA6IEJhY2tib25lLmVtdWxhdGVIVFRQLAogICAgICBlbXVsYXRlSlNPTjogQmFja2JvbmUuZW11bGF0ZUpTT04KICAgIH0pOwoKICAgIC8vIERlZmF1bHQgSlNPTi1yZXF1ZXN0IG9wdGlvbnMuCiAgICB2YXIgcGFyYW1zID0ge3R5cGU6IHR5cGUsIGRhdGFUeXBlOiAnanNvbid9OwoKICAgIC8vIEVuc3VyZSB0aGF0IHdlIGhhdmUgYSBVUkwuCiAgICBpZiAoIW9wdGlvbnMudXJsKSB7CiAgICAgIHBhcmFtcy51cmwgPSBfLnJlc3VsdChtb2RlbCwgJ3VybCcpIHx8IHVybEVycm9yKCk7CiAgICB9CgogICAgLy8gRW5zdXJlIHRoYXQgd2UgaGF2ZSB0aGUgYXBwcm9wcmlhdGUgcmVxdWVzdCBkYXRhLgogICAgaWYgKG9wdGlvbnMuZGF0YSA9PSBudWxsICYmIG1vZGVsICYmIChtZXRob2QgPT09ICdjcmVhdGUnIHx8IG1ldGhvZCA9PT0gJ3VwZGF0ZScgfHwgbWV0aG9kID09PSAncGF0Y2gnKSkgewogICAgICBwYXJhbXMuY29udGVudFR5cGUgPSAnYXBwbGljYXRpb24vanNvbic7CiAgICAgIHBhcmFtcy5kYXRhID0gSlNPTi5zdHJpbmdpZnkob3B0aW9ucy5hdHRycyB8fCBtb2RlbC50b0pTT04ob3B0aW9ucykpOwogICAgfQoKICAgIC8vIEZvciBvbGRlciBzZXJ2ZXJzLCBlbXVsYXRlIEpTT04gYnkgZW5jb2RpbmcgdGhlIHJlcXVlc3QgaW50byBhbiBIVE1MLWZvcm0uCiAgICBpZiAob3B0aW9ucy5lbXVsYXRlSlNPTikgewogICAgICBwYXJhbXMuY29udGVudFR5cGUgPSAnYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkJzsKICAgICAgcGFyYW1zLmRhdGEgPSBwYXJhbXMuZGF0YSA/IHttb2RlbDogcGFyYW1zLmRhdGF9IDoge307CiAgICB9CgogICAgLy8gRm9yIG9sZGVyIHNlcnZlcnMsIGVtdWxhdGUgSFRUUCBieSBtaW1pY2tpbmcgdGhlIEhUVFAgbWV0aG9kIHdpdGggYF9tZXRob2RgCiAgICAvLyBBbmQgYW4gYFgtSFRUUC1NZXRob2QtT3ZlcnJpZGVgIGhlYWRlci4KICAgIGlmIChvcHRpb25zLmVtdWxhdGVIVFRQICYmICh0eXBlID09PSAnUFVUJyB8fCB0eXBlID09PSAnREVMRVRFJyB8fCB0eXBlID09PSAnUEFUQ0gnKSkgewogICAgICBwYXJhbXMudHlwZSA9ICdQT1NUJzsKICAgICAgaWYgKG9wdGlvbnMuZW11bGF0ZUpTT04pIHBhcmFtcy5kYXRhLl9tZXRob2QgPSB0eXBlOwogICAgICB2YXIgYmVmb3JlU2VuZCA9IG9wdGlvbnMuYmVmb3JlU2VuZDsKICAgICAgb3B0aW9ucy5iZWZvcmVTZW5kID0gZnVuY3Rpb24oeGhyKSB7CiAgICAgICAgeGhyLnNldFJlcXVlc3RIZWFkZXIoJ1gtSFRUUC1NZXRob2QtT3ZlcnJpZGUnLCB0eXBlKTsKICAgICAgICBpZiAoYmVmb3JlU2VuZCkgcmV0dXJuIGJlZm9yZVNlbmQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfTsKICAgIH0KCiAgICAvLyBEb24ndCBwcm9jZXNzIGRhdGEgb24gYSBub24tR0VUIHJlcXVlc3QuCiAgICBpZiAocGFyYW1zLnR5cGUgIT09ICdHRVQnICYmICFvcHRpb25zLmVtdWxhdGVKU09OKSB7CiAgICAgIHBhcmFtcy5wcm9jZXNzRGF0YSA9IGZhbHNlOwogICAgfQoKICAgIC8vIElmIHdlJ3JlIHNlbmRpbmcgYSBgUEFUQ0hgIHJlcXVlc3QsIGFuZCB3ZSdyZSBpbiBhbiBvbGQgSW50ZXJuZXQgRXhwbG9yZXIKICAgIC8vIHRoYXQgc3RpbGwgaGFzIEFjdGl2ZVggZW5hYmxlZCBieSBkZWZhdWx0LCBvdmVycmlkZSBqUXVlcnkgdG8gdXNlIHRoYXQKICAgIC8vIGZvciBYSFIgaW5zdGVhZC4gUmVtb3ZlIHRoaXMgbGluZSB3aGVuIGpRdWVyeSBzdXBwb3J0cyBgUEFUQ0hgIG9uIElFOC4KICAgIGlmIChwYXJhbXMudHlwZSA9PT0gJ1BBVENIJyAmJiB3aW5kb3cuQWN0aXZlWE9iamVjdCAmJgogICAgICAgICAgISh3aW5kb3cuZXh0ZXJuYWwgJiYgd2luZG93LmV4dGVybmFsLm1zQWN0aXZlWEZpbHRlcmluZ0VuYWJsZWQpKSB7CiAgICAgIHBhcmFtcy54aHIgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gbmV3IEFjdGl2ZVhPYmplY3QoIk1pY3Jvc29mdC5YTUxIVFRQIik7CiAgICAgIH07CiAgICB9CgogICAgLy8gTWFrZSB0aGUgcmVxdWVzdCwgYWxsb3dpbmcgdGhlIHVzZXIgdG8gb3ZlcnJpZGUgYW55IEFqYXggb3B0aW9ucy4KICAgIHZhciB4aHIgPSBvcHRpb25zLnhociA9IEJhY2tib25lLmFqYXgoXy5leHRlbmQocGFyYW1zLCBvcHRpb25zKSk7CiAgICBtb2RlbC50cmlnZ2VyKCdyZXF1ZXN0JywgbW9kZWwsIHhociwgb3B0aW9ucyk7CiAgICByZXR1cm4geGhyOwogIH07CgogIC8vIE1hcCBmcm9tIENSVUQgdG8gSFRUUCBmb3Igb3VyIGRlZmF1bHQgYEJhY2tib25lLnN5bmNgIGltcGxlbWVudGF0aW9uLgogIHZhciBtZXRob2RNYXAgPSB7CiAgICAnY3JlYXRlJzogJ1BPU1QnLAogICAgJ3VwZGF0ZSc6ICdQVVQnLAogICAgJ3BhdGNoJzogICdQQVRDSCcsCiAgICAnZGVsZXRlJzogJ0RFTEVURScsCiAgICAncmVhZCc6ICAgJ0dFVCcKICB9OwoKICAvLyBTZXQgdGhlIGRlZmF1bHQgaW1wbGVtZW50YXRpb24gb2YgYEJhY2tib25lLmFqYXhgIHRvIHByb3h5IHRocm91Z2ggdG8gYCRgLgogIC8vIE92ZXJyaWRlIHRoaXMgaWYgeW91J2QgbGlrZSB0byB1c2UgYSBkaWZmZXJlbnQgbGlicmFyeS4KICBCYWNrYm9uZS5hamF4ID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gQmFja2JvbmUuJC5hamF4LmFwcGx5KEJhY2tib25lLiQsIGFyZ3VtZW50cyk7CiAgfTsKCiAgLy8gQmFja2JvbmUuUm91dGVyCiAgLy8gLS0tLS0tLS0tLS0tLS0tCgogIC8vIFJvdXRlcnMgbWFwIGZhdXgtVVJMcyB0byBhY3Rpb25zLCBhbmQgZmlyZSBldmVudHMgd2hlbiByb3V0ZXMgYXJlCiAgLy8gbWF0Y2hlZC4gQ3JlYXRpbmcgYSBuZXcgb25lIHNldHMgaXRzIGByb3V0ZXNgIGhhc2gsIGlmIG5vdCBzZXQgc3RhdGljYWxseS4KICB2YXIgUm91dGVyID0gQmFja2JvbmUuUm91dGVyID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgb3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KTsKICAgIGlmIChvcHRpb25zLnJvdXRlcykgdGhpcy5yb3V0ZXMgPSBvcHRpb25zLnJvdXRlczsKICAgIHRoaXMuX2JpbmRSb3V0ZXMoKTsKICAgIHRoaXMuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIH07CgogIC8vIENhY2hlZCByZWd1bGFyIGV4cHJlc3Npb25zIGZvciBtYXRjaGluZyBuYW1lZCBwYXJhbSBwYXJ0cyBhbmQgc3BsYXR0ZWQKICAvLyBwYXJ0cyBvZiByb3V0ZSBzdHJpbmdzLgogIHZhciBvcHRpb25hbFBhcmFtID0gL1woKC4qPylcKS9nOwogIHZhciBuYW1lZFBhcmFtICAgID0gLyhcKFw/KT86XHcrL2c7CiAgdmFyIHNwbGF0UGFyYW0gICAgPSAvXCpcdysvZzsKICB2YXIgZXNjYXBlUmVnRXhwICA9IC9bXC17fVxbXF0rPy4sXFxcXiR8I1xzXS9nOwoKICAvLyBTZXQgdXAgYWxsIGluaGVyaXRhYmxlICoqQmFja2JvbmUuUm91dGVyKiogcHJvcGVydGllcyBhbmQgbWV0aG9kcy4KICBfLmV4dGVuZChSb3V0ZXIucHJvdG90eXBlLCBFdmVudHMsIHsKCiAgICAvLyBJbml0aWFsaXplIGlzIGFuIGVtcHR5IGZ1bmN0aW9uIGJ5IGRlZmF1bHQuIE92ZXJyaWRlIGl0IHdpdGggeW91ciBvd24KICAgIC8vIGluaXRpYWxpemF0aW9uIGxvZ2ljLgogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oKXt9LAoKICAgIC8vIE1hbnVhbGx5IGJpbmQgYSBzaW5nbGUgbmFtZWQgcm91dGUgdG8gYSBjYWxsYmFjay4gRm9yIGV4YW1wbGU6CiAgICAvLwogICAgLy8gICAgIHRoaXMucm91dGUoJ3NlYXJjaC86cXVlcnkvcDpudW0nLCAnc2VhcmNoJywgZnVuY3Rpb24ocXVlcnksIG51bSkgewogICAgLy8gICAgICAgLi4uCiAgICAvLyAgICAgfSk7CiAgICAvLwogICAgcm91dGU6IGZ1bmN0aW9uKHJvdXRlLCBuYW1lLCBjYWxsYmFjaykgewogICAgICBpZiAoIV8uaXNSZWdFeHAocm91dGUpKSByb3V0ZSA9IHRoaXMuX3JvdXRlVG9SZWdFeHAocm91dGUpOwogICAgICBpZiAoXy5pc0Z1bmN0aW9uKG5hbWUpKSB7CiAgICAgICAgY2FsbGJhY2sgPSBuYW1lOwogICAgICAgIG5hbWUgPSAnJzsKICAgICAgfQogICAgICBpZiAoIWNhbGxiYWNrKSBjYWxsYmFjayA9IHRoaXNbbmFtZV07CiAgICAgIHZhciByb3V0ZXIgPSB0aGlzOwogICAgICBCYWNrYm9uZS5oaXN0b3J5LnJvdXRlKHJvdXRlLCBmdW5jdGlvbihmcmFnbWVudCkgewogICAgICAgIHZhciBhcmdzID0gcm91dGVyLl9leHRyYWN0UGFyYW1ldGVycyhyb3V0ZSwgZnJhZ21lbnQpOwogICAgICAgIGNhbGxiYWNrICYmIGNhbGxiYWNrLmFwcGx5KHJvdXRlciwgYXJncyk7CiAgICAgICAgcm91dGVyLnRyaWdnZXIuYXBwbHkocm91dGVyLCBbJ3JvdXRlOicgKyBuYW1lXS5jb25jYXQoYXJncykpOwogICAgICAgIHJvdXRlci50cmlnZ2VyKCdyb3V0ZScsIG5hbWUsIGFyZ3MpOwogICAgICAgIEJhY2tib25lLmhpc3RvcnkudHJpZ2dlcigncm91dGUnLCByb3V0ZXIsIG5hbWUsIGFyZ3MpOwogICAgICB9KTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIFNpbXBsZSBwcm94eSB0byBgQmFja2JvbmUuaGlzdG9yeWAgdG8gc2F2ZSBhIGZyYWdtZW50IGludG8gdGhlIGhpc3RvcnkuCiAgICBuYXZpZ2F0ZTogZnVuY3Rpb24oZnJhZ21lbnQsIG9wdGlvbnMpIHsKICAgICAgQmFja2JvbmUuaGlzdG9yeS5uYXZpZ2F0ZShmcmFnbWVudCwgb3B0aW9ucyk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBCaW5kIGFsbCBkZWZpbmVkIHJvdXRlcyB0byBgQmFja2JvbmUuaGlzdG9yeWAuIFdlIGhhdmUgdG8gcmV2ZXJzZSB0aGUKICAgIC8vIG9yZGVyIG9mIHRoZSByb3V0ZXMgaGVyZSB0byBzdXBwb3J0IGJlaGF2aW9yIHdoZXJlIHRoZSBtb3N0IGdlbmVyYWwKICAgIC8vIHJvdXRlcyBjYW4gYmUgZGVmaW5lZCBhdCB0aGUgYm90dG9tIG9mIHRoZSByb3V0ZSBtYXAuCiAgICBfYmluZFJvdXRlczogZnVuY3Rpb24oKSB7CiAgICAgIGlmICghdGhpcy5yb3V0ZXMpIHJldHVybjsKICAgICAgdGhpcy5yb3V0ZXMgPSBfLnJlc3VsdCh0aGlzLCAncm91dGVzJyk7CiAgICAgIHZhciByb3V0ZSwgcm91dGVzID0gXy5rZXlzKHRoaXMucm91dGVzKTsKICAgICAgd2hpbGUgKChyb3V0ZSA9IHJvdXRlcy5wb3AoKSkgIT0gbnVsbCkgewogICAgICAgIHRoaXMucm91dGUocm91dGUsIHRoaXMucm91dGVzW3JvdXRlXSk7CiAgICAgIH0KICAgIH0sCgogICAgLy8gQ29udmVydCBhIHJvdXRlIHN0cmluZyBpbnRvIGEgcmVndWxhciBleHByZXNzaW9uLCBzdWl0YWJsZSBmb3IgbWF0Y2hpbmcKICAgIC8vIGFnYWluc3QgdGhlIGN1cnJlbnQgbG9jYXRpb24gaGFzaC4KICAgIF9yb3V0ZVRvUmVnRXhwOiBmdW5jdGlvbihyb3V0ZSkgewogICAgICByb3V0ZSA9IHJvdXRlLnJlcGxhY2UoZXNjYXBlUmVnRXhwLCAnXFwkJicpCiAgICAgICAgICAgICAgICAgICAucmVwbGFjZShvcHRpb25hbFBhcmFtLCAnKD86JDEpPycpCiAgICAgICAgICAgICAgICAgICAucmVwbGFjZShuYW1lZFBhcmFtLCBmdW5jdGlvbihtYXRjaCwgb3B0aW9uYWwpewogICAgICAgICAgICAgICAgICAgICByZXR1cm4gb3B0aW9uYWwgPyBtYXRjaCA6ICcoW15cL10rKSc7CiAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgLnJlcGxhY2Uoc3BsYXRQYXJhbSwgJyguKj8pJyk7CiAgICAgIHJldHVybiBuZXcgUmVnRXhwKCdeJyArIHJvdXRlICsgJyQnKTsKICAgIH0sCgogICAgLy8gR2l2ZW4gYSByb3V0ZSwgYW5kIGEgVVJMIGZyYWdtZW50IHRoYXQgaXQgbWF0Y2hlcywgcmV0dXJuIHRoZSBhcnJheSBvZgogICAgLy8gZXh0cmFjdGVkIGRlY29kZWQgcGFyYW1ldGVycy4gRW1wdHkgb3IgdW5tYXRjaGVkIHBhcmFtZXRlcnMgd2lsbCBiZQogICAgLy8gdHJlYXRlZCBhcyBgbnVsbGAgdG8gbm9ybWFsaXplIGNyb3NzLWJyb3dzZXIgYmVoYXZpb3IuCiAgICBfZXh0cmFjdFBhcmFtZXRlcnM6IGZ1bmN0aW9uKHJvdXRlLCBmcmFnbWVudCkgewogICAgICB2YXIgcGFyYW1zID0gcm91dGUuZXhlYyhmcmFnbWVudCkuc2xpY2UoMSk7CiAgICAgIHJldHVybiBfLm1hcChwYXJhbXMsIGZ1bmN0aW9uKHBhcmFtKSB7CiAgICAgICAgcmV0dXJuIHBhcmFtID8gZGVjb2RlVVJJQ29tcG9uZW50KHBhcmFtKSA6IG51bGw7CiAgICAgIH0pOwogICAgfQoKICB9KTsKCiAgLy8gQmFja2JvbmUuSGlzdG9yeQogIC8vIC0tLS0tLS0tLS0tLS0tLS0KCiAgLy8gSGFuZGxlcyBjcm9zcy1icm93c2VyIGhpc3RvcnkgbWFuYWdlbWVudCwgYmFzZWQgb24gZWl0aGVyCiAgLy8gW3B1c2hTdGF0ZV0oaHR0cDovL2RpdmVpbnRvaHRtbDUuaW5mby9oaXN0b3J5Lmh0bWwpIGFuZCByZWFsIFVSTHMsIG9yCiAgLy8gW29uaGFzaGNoYW5nZV0oaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9ET00vd2luZG93Lm9uaGFzaGNoYW5nZSkKICAvLyBhbmQgVVJMIGZyYWdtZW50cy4gSWYgdGhlIGJyb3dzZXIgc3VwcG9ydHMgbmVpdGhlciAob2xkIElFLCBuYXRjaCksCiAgLy8gZmFsbHMgYmFjayB0byBwb2xsaW5nLgogIHZhciBIaXN0b3J5ID0gQmFja2JvbmUuSGlzdG9yeSA9IGZ1bmN0aW9uKCkgewogICAgdGhpcy5oYW5kbGVycyA9IFtdOwogICAgXy5iaW5kQWxsKHRoaXMsICdjaGVja1VybCcpOwoKICAgIC8vIEVuc3VyZSB0aGF0IGBIaXN0b3J5YCBjYW4gYmUgdXNlZCBvdXRzaWRlIG9mIHRoZSBicm93c2VyLgogICAgaWYgKHR5cGVvZiB3aW5kb3cgIT09ICd1bmRlZmluZWQnKSB7CiAgICAgIHRoaXMubG9jYXRpb24gPSB3aW5kb3cubG9jYXRpb247CiAgICAgIHRoaXMuaGlzdG9yeSA9IHdpbmRvdy5oaXN0b3J5OwogICAgfQogIH07CgogIC8vIENhY2hlZCByZWdleCBmb3Igc3RyaXBwaW5nIGEgbGVhZGluZyBoYXNoL3NsYXNoIGFuZCB0cmFpbGluZyBzcGFjZS4KICB2YXIgcm91dGVTdHJpcHBlciA9IC9eWyNcL118XHMrJC9nOwoKICAvLyBDYWNoZWQgcmVnZXggZm9yIHN0cmlwcGluZyBsZWFkaW5nIGFuZCB0cmFpbGluZyBzbGFzaGVzLgogIHZhciByb290U3RyaXBwZXIgPSAvXlwvK3xcLyskL2c7CgogIC8vIENhY2hlZCByZWdleCBmb3IgZGV0ZWN0aW5nIE1TSUUuCiAgdmFyIGlzRXhwbG9yZXIgPSAvbXNpZSBbXHcuXSsvOwoKICAvLyBDYWNoZWQgcmVnZXggZm9yIHJlbW92aW5nIGEgdHJhaWxpbmcgc2xhc2guCiAgdmFyIHRyYWlsaW5nU2xhc2ggPSAvXC8kLzsKCiAgLy8gSGFzIHRoZSBoaXN0b3J5IGhhbmRsaW5nIGFscmVhZHkgYmVlbiBzdGFydGVkPwogIEhpc3Rvcnkuc3RhcnRlZCA9IGZhbHNlOwoKICAvLyBTZXQgdXAgYWxsIGluaGVyaXRhYmxlICoqQmFja2JvbmUuSGlzdG9yeSoqIHByb3BlcnRpZXMgYW5kIG1ldGhvZHMuCiAgXy5leHRlbmQoSGlzdG9yeS5wcm90b3R5cGUsIEV2ZW50cywgewoKICAgIC8vIFRoZSBkZWZhdWx0IGludGVydmFsIHRvIHBvbGwgZm9yIGhhc2ggY2hhbmdlcywgaWYgbmVjZXNzYXJ5LCBpcwogICAgLy8gdHdlbnR5IHRpbWVzIGEgc2Vjb25kLgogICAgaW50ZXJ2YWw6IDUwLAoKICAgIC8vIEdldHMgdGhlIHRydWUgaGFzaCB2YWx1ZS4gQ2Fubm90IHVzZSBsb2NhdGlvbi5oYXNoIGRpcmVjdGx5IGR1ZSB0byBidWcKICAgIC8vIGluIEZpcmVmb3ggd2hlcmUgbG9jYXRpb24uaGFzaCB3aWxsIGFsd2F5cyBiZSBkZWNvZGVkLgogICAgZ2V0SGFzaDogZnVuY3Rpb24od2luZG93KSB7CiAgICAgIHZhciBtYXRjaCA9ICh3aW5kb3cgfHwgdGhpcykubG9jYXRpb24uaHJlZi5tYXRjaCgvIyguKikkLyk7CiAgICAgIHJldHVybiBtYXRjaCA/IG1hdGNoWzFdIDogJyc7CiAgICB9LAoKICAgIC8vIEdldCB0aGUgY3Jvc3MtYnJvd3NlciBub3JtYWxpemVkIFVSTCBmcmFnbWVudCwgZWl0aGVyIGZyb20gdGhlIFVSTCwKICAgIC8vIHRoZSBoYXNoLCBvciB0aGUgb3ZlcnJpZGUuCiAgICBnZXRGcmFnbWVudDogZnVuY3Rpb24oZnJhZ21lbnQsIGZvcmNlUHVzaFN0YXRlKSB7CiAgICAgIGlmIChmcmFnbWVudCA9PSBudWxsKSB7CiAgICAgICAgaWYgKHRoaXMuX2hhc1B1c2hTdGF0ZSB8fCAhdGhpcy5fd2FudHNIYXNoQ2hhbmdlIHx8IGZvcmNlUHVzaFN0YXRlKSB7CiAgICAgICAgICBmcmFnbWVudCA9IHRoaXMubG9jYXRpb24ucGF0aG5hbWU7CiAgICAgICAgICB2YXIgcm9vdCA9IHRoaXMucm9vdC5yZXBsYWNlKHRyYWlsaW5nU2xhc2gsICcnKTsKICAgICAgICAgIGlmICghZnJhZ21lbnQuaW5kZXhPZihyb290KSkgZnJhZ21lbnQgPSBmcmFnbWVudC5zdWJzdHIocm9vdC5sZW5ndGgpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBmcmFnbWVudCA9IHRoaXMuZ2V0SGFzaCgpOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gZnJhZ21lbnQucmVwbGFjZShyb3V0ZVN0cmlwcGVyLCAnJyk7CiAgICB9LAoKICAgIC8vIFN0YXJ0IHRoZSBoYXNoIGNoYW5nZSBoYW5kbGluZywgcmV0dXJuaW5nIGB0cnVlYCBpZiB0aGUgY3VycmVudCBVUkwgbWF0Y2hlcwogICAgLy8gYW4gZXhpc3Rpbmcgcm91dGUsIGFuZCBgZmFsc2VgIG90aGVyd2lzZS4KICAgIHN0YXJ0OiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIGlmIChIaXN0b3J5LnN0YXJ0ZWQpIHRocm93IG5ldyBFcnJvcigiQmFja2JvbmUuaGlzdG9yeSBoYXMgYWxyZWFkeSBiZWVuIHN0YXJ0ZWQiKTsKICAgICAgSGlzdG9yeS5zdGFydGVkID0gdHJ1ZTsKCiAgICAgIC8vIEZpZ3VyZSBvdXQgdGhlIGluaXRpYWwgY29uZmlndXJhdGlvbi4gRG8gd2UgbmVlZCBhbiBpZnJhbWU/CiAgICAgIC8vIElzIHB1c2hTdGF0ZSBkZXNpcmVkIC4uLiBpcyBpdCBhdmFpbGFibGU/CiAgICAgIHRoaXMub3B0aW9ucyAgICAgICAgICA9IF8uZXh0ZW5kKHt9LCB7cm9vdDogJy8nfSwgdGhpcy5vcHRpb25zLCBvcHRpb25zKTsKICAgICAgdGhpcy5yb290ICAgICAgICAgICAgID0gdGhpcy5vcHRpb25zLnJvb3Q7CiAgICAgIHRoaXMuX3dhbnRzSGFzaENoYW5nZSA9IHRoaXMub3B0aW9ucy5oYXNoQ2hhbmdlICE9PSBmYWxzZTsKICAgICAgdGhpcy5fd2FudHNQdXNoU3RhdGUgID0gISF0aGlzLm9wdGlvbnMucHVzaFN0YXRlOwogICAgICB0aGlzLl9oYXNQdXNoU3RhdGUgICAgPSAhISh0aGlzLm9wdGlvbnMucHVzaFN0YXRlICYmIHRoaXMuaGlzdG9yeSAmJiB0aGlzLmhpc3RvcnkucHVzaFN0YXRlKTsKICAgICAgdmFyIGZyYWdtZW50ICAgICAgICAgID0gdGhpcy5nZXRGcmFnbWVudCgpOwogICAgICB2YXIgZG9jTW9kZSAgICAgICAgICAgPSBkb2N1bWVudC5kb2N1bWVudE1vZGU7CiAgICAgIHZhciBvbGRJRSAgICAgICAgICAgICA9IChpc0V4cGxvcmVyLmV4ZWMobmF2aWdhdG9yLnVzZXJBZ2VudC50b0xvd2VyQ2FzZSgpKSAmJiAoIWRvY01vZGUgfHwgZG9jTW9kZSA8PSA3KSk7CgogICAgICAvLyBOb3JtYWxpemUgcm9vdCB0byBhbHdheXMgaW5jbHVkZSBhIGxlYWRpbmcgYW5kIHRyYWlsaW5nIHNsYXNoLgogICAgICB0aGlzLnJvb3QgPSAoJy8nICsgdGhpcy5yb290ICsgJy8nKS5yZXBsYWNlKHJvb3RTdHJpcHBlciwgJy8nKTsKCiAgICAgIGlmIChvbGRJRSAmJiB0aGlzLl93YW50c0hhc2hDaGFuZ2UpIHsKICAgICAgICB0aGlzLmlmcmFtZSA9IEJhY2tib25lLiQoJzxpZnJhbWUgc3JjPSJqYXZhc2NyaXB0OjAiIHRhYmluZGV4PSItMSIgLz4nKS5oaWRlKCkuYXBwZW5kVG8oJ2JvZHknKVswXS5jb250ZW50V2luZG93OwogICAgICAgIHRoaXMubmF2aWdhdGUoZnJhZ21lbnQpOwogICAgICB9CgogICAgICAvLyBEZXBlbmRpbmcgb24gd2hldGhlciB3ZSdyZSB1c2luZyBwdXNoU3RhdGUgb3IgaGFzaGVzLCBhbmQgd2hldGhlcgogICAgICAvLyAnb25oYXNoY2hhbmdlJyBpcyBzdXBwb3J0ZWQsIGRldGVybWluZSBob3cgd2UgY2hlY2sgdGhlIFVSTCBzdGF0ZS4KICAgICAgaWYgKHRoaXMuX2hhc1B1c2hTdGF0ZSkgewogICAgICAgIEJhY2tib25lLiQod2luZG93KS5vbigncG9wc3RhdGUnLCB0aGlzLmNoZWNrVXJsKTsKICAgICAgfSBlbHNlIGlmICh0aGlzLl93YW50c0hhc2hDaGFuZ2UgJiYgKCdvbmhhc2hjaGFuZ2UnIGluIHdpbmRvdykgJiYgIW9sZElFKSB7CiAgICAgICAgQmFja2JvbmUuJCh3aW5kb3cpLm9uKCdoYXNoY2hhbmdlJywgdGhpcy5jaGVja1VybCk7CiAgICAgIH0gZWxzZSBpZiAodGhpcy5fd2FudHNIYXNoQ2hhbmdlKSB7CiAgICAgICAgdGhpcy5fY2hlY2tVcmxJbnRlcnZhbCA9IHNldEludGVydmFsKHRoaXMuY2hlY2tVcmwsIHRoaXMuaW50ZXJ2YWwpOwogICAgICB9CgogICAgICAvLyBEZXRlcm1pbmUgaWYgd2UgbmVlZCB0byBjaGFuZ2UgdGhlIGJhc2UgdXJsLCBmb3IgYSBwdXNoU3RhdGUgbGluawogICAgICAvLyBvcGVuZWQgYnkgYSBub24tcHVzaFN0YXRlIGJyb3dzZXIuCiAgICAgIHRoaXMuZnJhZ21lbnQgPSBmcmFnbWVudDsKICAgICAgdmFyIGxvYyA9IHRoaXMubG9jYXRpb247CiAgICAgIHZhciBhdFJvb3QgPSBsb2MucGF0aG5hbWUucmVwbGFjZSgvW15cL10kLywgJyQmLycpID09PSB0aGlzLnJvb3Q7CgogICAgICAvLyBJZiB3ZSd2ZSBzdGFydGVkIG9mZiB3aXRoIGEgcm91dGUgZnJvbSBhIGBwdXNoU3RhdGVgLWVuYWJsZWQgYnJvd3NlciwKICAgICAgLy8gYnV0IHdlJ3JlIGN1cnJlbnRseSBpbiBhIGJyb3dzZXIgdGhhdCBkb2Vzbid0IHN1cHBvcnQgaXQuLi4KICAgICAgaWYgKHRoaXMuX3dhbnRzSGFzaENoYW5nZSAmJiB0aGlzLl93YW50c1B1c2hTdGF0ZSAmJiAhdGhpcy5faGFzUHVzaFN0YXRlICYmICFhdFJvb3QpIHsKICAgICAgICB0aGlzLmZyYWdtZW50ID0gdGhpcy5nZXRGcmFnbWVudChudWxsLCB0cnVlKTsKICAgICAgICB0aGlzLmxvY2F0aW9uLnJlcGxhY2UodGhpcy5yb290ICsgdGhpcy5sb2NhdGlvbi5zZWFyY2ggKyAnIycgKyB0aGlzLmZyYWdtZW50KTsKICAgICAgICAvLyBSZXR1cm4gaW1tZWRpYXRlbHkgYXMgYnJvd3NlciB3aWxsIGRvIHJlZGlyZWN0IHRvIG5ldyB1cmwKICAgICAgICByZXR1cm4gdHJ1ZTsKCiAgICAgIC8vIE9yIGlmIHdlJ3ZlIHN0YXJ0ZWQgb3V0IHdpdGggYSBoYXNoLWJhc2VkIHJvdXRlLCBidXQgd2UncmUgY3VycmVudGx5CiAgICAgIC8vIGluIGEgYnJvd3NlciB3aGVyZSBpdCBjb3VsZCBiZSBgcHVzaFN0YXRlYC1iYXNlZCBpbnN0ZWFkLi4uCiAgICAgIH0gZWxzZSBpZiAodGhpcy5fd2FudHNQdXNoU3RhdGUgJiYgdGhpcy5faGFzUHVzaFN0YXRlICYmIGF0Um9vdCAmJiBsb2MuaGFzaCkgewogICAgICAgIHRoaXMuZnJhZ21lbnQgPSB0aGlzLmdldEhhc2goKS5yZXBsYWNlKHJvdXRlU3RyaXBwZXIsICcnKTsKICAgICAgICB0aGlzLmhpc3RvcnkucmVwbGFjZVN0YXRlKHt9LCBkb2N1bWVudC50aXRsZSwgdGhpcy5yb290ICsgdGhpcy5mcmFnbWVudCArIGxvYy5zZWFyY2gpOwogICAgICB9CgogICAgICBpZiAoIXRoaXMub3B0aW9ucy5zaWxlbnQpIHJldHVybiB0aGlzLmxvYWRVcmwoKTsKICAgIH0sCgogICAgLy8gRGlzYWJsZSBCYWNrYm9uZS5oaXN0b3J5LCBwZXJoYXBzIHRlbXBvcmFyaWx5LiBOb3QgdXNlZnVsIGluIGEgcmVhbCBhcHAsCiAgICAvLyBidXQgcG9zc2libHkgdXNlZnVsIGZvciB1bml0IHRlc3RpbmcgUm91dGVycy4KICAgIHN0b3A6IGZ1bmN0aW9uKCkgewogICAgICBCYWNrYm9uZS4kKHdpbmRvdykub2ZmKCdwb3BzdGF0ZScsIHRoaXMuY2hlY2tVcmwpLm9mZignaGFzaGNoYW5nZScsIHRoaXMuY2hlY2tVcmwpOwogICAgICBjbGVhckludGVydmFsKHRoaXMuX2NoZWNrVXJsSW50ZXJ2YWwpOwogICAgICBIaXN0b3J5LnN0YXJ0ZWQgPSBmYWxzZTsKICAgIH0sCgogICAgLy8gQWRkIGEgcm91dGUgdG8gYmUgdGVzdGVkIHdoZW4gdGhlIGZyYWdtZW50IGNoYW5nZXMuIFJvdXRlcyBhZGRlZCBsYXRlcgogICAgLy8gbWF5IG92ZXJyaWRlIHByZXZpb3VzIHJvdXRlcy4KICAgIHJvdXRlOiBmdW5jdGlvbihyb3V0ZSwgY2FsbGJhY2spIHsKICAgICAgdGhpcy5oYW5kbGVycy51bnNoaWZ0KHtyb3V0ZTogcm91dGUsIGNhbGxiYWNrOiBjYWxsYmFja30pOwogICAgfSwKCiAgICAvLyBDaGVja3MgdGhlIGN1cnJlbnQgVVJMIHRvIHNlZSBpZiBpdCBoYXMgY2hhbmdlZCwgYW5kIGlmIGl0IGhhcywKICAgIC8vIGNhbGxzIGBsb2FkVXJsYCwgbm9ybWFsaXppbmcgYWNyb3NzIHRoZSBoaWRkZW4gaWZyYW1lLgogICAgY2hlY2tVcmw6IGZ1bmN0aW9uKGUpIHsKICAgICAgdmFyIGN1cnJlbnQgPSB0aGlzLmdldEZyYWdtZW50KCk7CiAgICAgIGlmIChjdXJyZW50ID09PSB0aGlzLmZyYWdtZW50ICYmIHRoaXMuaWZyYW1lKSB7CiAgICAgICAgY3VycmVudCA9IHRoaXMuZ2V0RnJhZ21lbnQodGhpcy5nZXRIYXNoKHRoaXMuaWZyYW1lKSk7CiAgICAgIH0KICAgICAgaWYgKGN1cnJlbnQgPT09IHRoaXMuZnJhZ21lbnQpIHJldHVybiBmYWxzZTsKICAgICAgaWYgKHRoaXMuaWZyYW1lKSB0aGlzLm5hdmlnYXRlKGN1cnJlbnQpOwogICAgICB0aGlzLmxvYWRVcmwoKSB8fCB0aGlzLmxvYWRVcmwodGhpcy5nZXRIYXNoKCkpOwogICAgfSwKCiAgICAvLyBBdHRlbXB0IHRvIGxvYWQgdGhlIGN1cnJlbnQgVVJMIGZyYWdtZW50LiBJZiBhIHJvdXRlIHN1Y2NlZWRzIHdpdGggYQogICAgLy8gbWF0Y2gsIHJldHVybnMgYHRydWVgLiBJZiBubyBkZWZpbmVkIHJvdXRlcyBtYXRjaGVzIHRoZSBmcmFnbWVudCwKICAgIC8vIHJldHVybnMgYGZhbHNlYC4KICAgIGxvYWRVcmw6IGZ1bmN0aW9uKGZyYWdtZW50T3ZlcnJpZGUpIHsKICAgICAgdmFyIGZyYWdtZW50ID0gdGhpcy5mcmFnbWVudCA9IHRoaXMuZ2V0RnJhZ21lbnQoZnJhZ21lbnRPdmVycmlkZSk7CiAgICAgIHZhciBtYXRjaGVkID0gXy5hbnkodGhpcy5oYW5kbGVycywgZnVuY3Rpb24oaGFuZGxlcikgewogICAgICAgIGlmIChoYW5kbGVyLnJvdXRlLnRlc3QoZnJhZ21lbnQpKSB7CiAgICAgICAgICBoYW5kbGVyLmNhbGxiYWNrKGZyYWdtZW50KTsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIHJldHVybiBtYXRjaGVkOwogICAgfSwKCiAgICAvLyBTYXZlIGEgZnJhZ21lbnQgaW50byB0aGUgaGFzaCBoaXN0b3J5LCBvciByZXBsYWNlIHRoZSBVUkwgc3RhdGUgaWYgdGhlCiAgICAvLyAncmVwbGFjZScgb3B0aW9uIGlzIHBhc3NlZC4gWW91IGFyZSByZXNwb25zaWJsZSBmb3IgcHJvcGVybHkgVVJMLWVuY29kaW5nCiAgICAvLyB0aGUgZnJhZ21lbnQgaW4gYWR2YW5jZS4KICAgIC8vCiAgICAvLyBUaGUgb3B0aW9ucyBvYmplY3QgY2FuIGNvbnRhaW4gYHRyaWdnZXI6IHRydWVgIGlmIHlvdSB3aXNoIHRvIGhhdmUgdGhlCiAgICAvLyByb3V0ZSBjYWxsYmFjayBiZSBmaXJlZCAobm90IHVzdWFsbHkgZGVzaXJhYmxlKSwgb3IgYHJlcGxhY2U6IHRydWVgLCBpZgogICAgLy8geW91IHdpc2ggdG8gbW9kaWZ5IHRoZSBjdXJyZW50IFVSTCB3aXRob3V0IGFkZGluZyBhbiBlbnRyeSB0byB0aGUgaGlzdG9yeS4KICAgIG5hdmlnYXRlOiBmdW5jdGlvbihmcmFnbWVudCwgb3B0aW9ucykgewogICAgICBpZiAoIUhpc3Rvcnkuc3RhcnRlZCkgcmV0dXJuIGZhbHNlOwogICAgICBpZiAoIW9wdGlvbnMgfHwgb3B0aW9ucyA9PT0gdHJ1ZSkgb3B0aW9ucyA9IHt0cmlnZ2VyOiBvcHRpb25zfTsKICAgICAgZnJhZ21lbnQgPSB0aGlzLmdldEZyYWdtZW50KGZyYWdtZW50IHx8ICcnKTsKICAgICAgaWYgKHRoaXMuZnJhZ21lbnQgPT09IGZyYWdtZW50KSByZXR1cm47CiAgICAgIHRoaXMuZnJhZ21lbnQgPSBmcmFnbWVudDsKICAgICAgdmFyIHVybCA9IHRoaXMucm9vdCArIGZyYWdtZW50OwoKICAgICAgLy8gSWYgcHVzaFN0YXRlIGlzIGF2YWlsYWJsZSwgd2UgdXNlIGl0IHRvIHNldCB0aGUgZnJhZ21lbnQgYXMgYSByZWFsIFVSTC4KICAgICAgaWYgKHRoaXMuX2hhc1B1c2hTdGF0ZSkgewogICAgICAgIHRoaXMuaGlzdG9yeVtvcHRpb25zLnJlcGxhY2UgPyAncmVwbGFjZVN0YXRlJyA6ICdwdXNoU3RhdGUnXSh7fSwgZG9jdW1lbnQudGl0bGUsIHVybCk7CgogICAgICAvLyBJZiBoYXNoIGNoYW5nZXMgaGF2ZW4ndCBiZWVuIGV4cGxpY2l0bHkgZGlzYWJsZWQsIHVwZGF0ZSB0aGUgaGFzaAogICAgICAvLyBmcmFnbWVudCB0byBzdG9yZSBoaXN0b3J5LgogICAgICB9IGVsc2UgaWYgKHRoaXMuX3dhbnRzSGFzaENoYW5nZSkgewogICAgICAgIHRoaXMuX3VwZGF0ZUhhc2godGhpcy5sb2NhdGlvbiwgZnJhZ21lbnQsIG9wdGlvbnMucmVwbGFjZSk7CiAgICAgICAgaWYgKHRoaXMuaWZyYW1lICYmIChmcmFnbWVudCAhPT0gdGhpcy5nZXRGcmFnbWVudCh0aGlzLmdldEhhc2godGhpcy5pZnJhbWUpKSkpIHsKICAgICAgICAgIC8vIE9wZW5pbmcgYW5kIGNsb3NpbmcgdGhlIGlmcmFtZSB0cmlja3MgSUU3IGFuZCBlYXJsaWVyIHRvIHB1c2ggYQogICAgICAgICAgLy8gaGlzdG9yeSBlbnRyeSBvbiBoYXNoLXRhZyBjaGFuZ2UuICBXaGVuIHJlcGxhY2UgaXMgdHJ1ZSwgd2UgZG9uJ3QKICAgICAgICAgIC8vIHdhbnQgdGhpcy4KICAgICAgICAgIGlmKCFvcHRpb25zLnJlcGxhY2UpIHRoaXMuaWZyYW1lLmRvY3VtZW50Lm9wZW4oKS5jbG9zZSgpOwogICAgICAgICAgdGhpcy5fdXBkYXRlSGFzaCh0aGlzLmlmcmFtZS5sb2NhdGlvbiwgZnJhZ21lbnQsIG9wdGlvbnMucmVwbGFjZSk7CiAgICAgICAgfQoKICAgICAgLy8gSWYgeW91J3ZlIHRvbGQgdXMgdGhhdCB5b3UgZXhwbGljaXRseSBkb24ndCB3YW50IGZhbGxiYWNrIGhhc2hjaGFuZ2UtCiAgICAgIC8vIGJhc2VkIGhpc3RvcnksIHRoZW4gYG5hdmlnYXRlYCBiZWNvbWVzIGEgcGFnZSByZWZyZXNoLgogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiB0aGlzLmxvY2F0aW9uLmFzc2lnbih1cmwpOwogICAgICB9CiAgICAgIGlmIChvcHRpb25zLnRyaWdnZXIpIHRoaXMubG9hZFVybChmcmFnbWVudCk7CiAgICB9LAoKICAgIC8vIFVwZGF0ZSB0aGUgaGFzaCBsb2NhdGlvbiwgZWl0aGVyIHJlcGxhY2luZyB0aGUgY3VycmVudCBlbnRyeSwgb3IgYWRkaW5nCiAgICAvLyBhIG5ldyBvbmUgdG8gdGhlIGJyb3dzZXIgaGlzdG9yeS4KICAgIF91cGRhdGVIYXNoOiBmdW5jdGlvbihsb2NhdGlvbiwgZnJhZ21lbnQsIHJlcGxhY2UpIHsKICAgICAgaWYgKHJlcGxhY2UpIHsKICAgICAgICB2YXIgaHJlZiA9IGxvY2F0aW9uLmhyZWYucmVwbGFjZSgvKGphdmFzY3JpcHQ6fCMpLiokLywgJycpOwogICAgICAgIGxvY2F0aW9uLnJlcGxhY2UoaHJlZiArICcjJyArIGZyYWdtZW50KTsKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBTb21lIGJyb3dzZXJzIHJlcXVpcmUgdGhhdCBgaGFzaGAgY29udGFpbnMgYSBsZWFkaW5nICMuCiAgICAgICAgbG9jYXRpb24uaGFzaCA9ICcjJyArIGZyYWdtZW50OwogICAgICB9CiAgICB9CgogIH0pOwoKICAvLyBDcmVhdGUgdGhlIGRlZmF1bHQgQmFja2JvbmUuaGlzdG9yeS4KICBCYWNrYm9uZS5oaXN0b3J5ID0gbmV3IEhpc3Rvcnk7CgogIC8vIEhlbHBlcnMKICAvLyAtLS0tLS0tCgogIC8vIEhlbHBlciBmdW5jdGlvbiB0byBjb3JyZWN0bHkgc2V0IHVwIHRoZSBwcm90b3R5cGUgY2hhaW4sIGZvciBzdWJjbGFzc2VzLgogIC8vIFNpbWlsYXIgdG8gYGdvb2cuaW5oZXJpdHNgLCBidXQgdXNlcyBhIGhhc2ggb2YgcHJvdG90eXBlIHByb3BlcnRpZXMgYW5kCiAgLy8gY2xhc3MgcHJvcGVydGllcyB0byBiZSBleHRlbmRlZC4KICB2YXIgZXh0ZW5kID0gZnVuY3Rpb24ocHJvdG9Qcm9wcywgc3RhdGljUHJvcHMpIHsKICAgIHZhciBwYXJlbnQgPSB0aGlzOwogICAgdmFyIGNoaWxkOwoKICAgIC8vIFRoZSBjb25zdHJ1Y3RvciBmdW5jdGlvbiBmb3IgdGhlIG5ldyBzdWJjbGFzcyBpcyBlaXRoZXIgZGVmaW5lZCBieSB5b3UKICAgIC8vICh0aGUgImNvbnN0cnVjdG9yIiBwcm9wZXJ0eSBpbiB5b3VyIGBleHRlbmRgIGRlZmluaXRpb24pLCBvciBkZWZhdWx0ZWQKICAgIC8vIGJ5IHVzIHRvIHNpbXBseSBjYWxsIHRoZSBwYXJlbnQncyBjb25zdHJ1Y3Rvci4KICAgIGlmIChwcm90b1Byb3BzICYmIF8uaGFzKHByb3RvUHJvcHMsICdjb25zdHJ1Y3RvcicpKSB7CiAgICAgIGNoaWxkID0gcHJvdG9Qcm9wcy5jb25zdHJ1Y3RvcjsKICAgIH0gZWxzZSB7CiAgICAgIGNoaWxkID0gZnVuY3Rpb24oKXsgcmV0dXJuIHBhcmVudC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOyB9OwogICAgfQoKICAgIC8vIEFkZCBzdGF0aWMgcHJvcGVydGllcyB0byB0aGUgY29uc3RydWN0b3IgZnVuY3Rpb24sIGlmIHN1cHBsaWVkLgogICAgXy5leHRlbmQoY2hpbGQsIHBhcmVudCwgc3RhdGljUHJvcHMpOwoKICAgIC8vIFNldCB0aGUgcHJvdG90eXBlIGNoYWluIHRvIGluaGVyaXQgZnJvbSBgcGFyZW50YCwgd2l0aG91dCBjYWxsaW5nCiAgICAvLyBgcGFyZW50YCdzIGNvbnN0cnVjdG9yIGZ1bmN0aW9uLgogICAgdmFyIFN1cnJvZ2F0ZSA9IGZ1bmN0aW9uKCl7IHRoaXMuY29uc3RydWN0b3IgPSBjaGlsZDsgfTsKICAgIFN1cnJvZ2F0ZS5wcm90b3R5cGUgPSBwYXJlbnQucHJvdG90eXBlOwogICAgY2hpbGQucHJvdG90eXBlID0gbmV3IFN1cnJvZ2F0ZTsKCiAgICAvLyBBZGQgcHJvdG90eXBlIHByb3BlcnRpZXMgKGluc3RhbmNlIHByb3BlcnRpZXMpIHRvIHRoZSBzdWJjbGFzcywKICAgIC8vIGlmIHN1cHBsaWVkLgogICAgaWYgKHByb3RvUHJvcHMpIF8uZXh0ZW5kKGNoaWxkLnByb3RvdHlwZSwgcHJvdG9Qcm9wcyk7CgogICAgLy8gU2V0IGEgY29udmVuaWVuY2UgcHJvcGVydHkgaW4gY2FzZSB0aGUgcGFyZW50J3MgcHJvdG90eXBlIGlzIG5lZWRlZAogICAgLy8gbGF0ZXIuCiAgICBjaGlsZC5fX3N1cGVyX18gPSBwYXJlbnQucHJvdG90eXBlOwoKICAgIHJldHVybiBjaGlsZDsKICB9OwoKICAvLyBTZXQgdXAgaW5oZXJpdGFuY2UgZm9yIHRoZSBtb2RlbCwgY29sbGVjdGlvbiwgcm91dGVyLCB2aWV3IGFuZCBoaXN0b3J5LgogIE1vZGVsLmV4dGVuZCA9IENvbGxlY3Rpb24uZXh0ZW5kID0gUm91dGVyLmV4dGVuZCA9IFZpZXcuZXh0ZW5kID0gSGlzdG9yeS5leHRlbmQgPSBleHRlbmQ7CgogIC8vIFRocm93IGFuIGVycm9yIHdoZW4gYSBVUkwgaXMgbmVlZGVkLCBhbmQgbm9uZSBpcyBzdXBwbGllZC4KICB2YXIgdXJsRXJyb3IgPSBmdW5jdGlvbigpIHsKICAgIHRocm93IG5ldyBFcnJvcignQSAidXJsIiBwcm9wZXJ0eSBvciBmdW5jdGlvbiBtdXN0IGJlIHNwZWNpZmllZCcpOwogIH07CgogIC8vIFdyYXAgYW4gb3B0aW9uYWwgZXJyb3IgY2FsbGJhY2sgd2l0aCBhIGZhbGxiYWNrIGVycm9yIGV2ZW50LgogIHZhciB3cmFwRXJyb3IgPSBmdW5jdGlvbiAobW9kZWwsIG9wdGlvbnMpIHsKICAgIHZhciBlcnJvciA9IG9wdGlvbnMuZXJyb3I7CiAgICBvcHRpb25zLmVycm9yID0gZnVuY3Rpb24ocmVzcCkgewogICAgICBpZiAoZXJyb3IpIGVycm9yKG1vZGVsLCByZXNwLCBvcHRpb25zKTsKICAgICAgbW9kZWwudHJpZ2dlcignZXJyb3InLCBtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CiAgICB9OwogIH07Cgp9KS5jYWxsKHRoaXMpOwoKZGVmaW5lKCJiYWNrYm9uZSIsIFsidW5kZXJzY29yZSIsImpxdWVyeSJdLCAoZnVuY3Rpb24gKGdsb2JhbCkgewogICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgcmV0LCBmbjsKICAgICAgICByZXR1cm4gcmV0IHx8IGdsb2JhbC5CYWNrYm9uZTsKICAgIH07Cn0odGhpcykpKTsKCi8qKgogKiBCYWNrYm9uZSBsb2NhbFN0b3JhZ2UgQWRhcHRlcgogKiBWZXJzaW9uIDEuMS4xMwogKgogKiBodHRwczovL2dpdGh1Yi5jb20vamVyb21lZ24vQmFja2JvbmUubG9jYWxTdG9yYWdlCiAqLwooZnVuY3Rpb24gKHJvb3QsIGZhY3RvcnkpIHsKICBpZiAodHlwZW9mIGV4cG9ydHMgPT09ICdvYmplY3QnICYmIHR5cGVvZiByZXF1aXJlID09PSAnZnVuY3Rpb24nKSB7CiAgICBtb2R1bGUuZXhwb3J0cyA9IGZhY3RvcnkocmVxdWlyZSgiYmFja2JvbmUiKSk7CiAgfSBlbHNlIGlmICh0eXBlb2YgZGVmaW5lID09PSAiZnVuY3Rpb24iICYmIGRlZmluZS5hbWQpIHsKICAgIC8vIEFNRC4gUmVnaXN0ZXIgYXMgYW4gYW5vbnltb3VzIG1vZHVsZS4KICAgIGRlZmluZSgnbG9jYWxzdG9yYWdlJyxbImJhY2tib25lIl0sIGZ1bmN0aW9uKEJhY2tib25lKSB7CiAgICAgIC8vIFVzZSBnbG9iYWwgdmFyaWFibGVzIGlmIHRoZSBsb2NhbHMgYXJlIHVuZGVmaW5lZC4KICAgICAgcmV0dXJuIGZhY3RvcnkoQmFja2JvbmUgfHwgcm9vdC5CYWNrYm9uZSk7CiAgICB9KTsKICB9IGVsc2UgewogICAgZmFjdG9yeShCYWNrYm9uZSk7CiAgfQp9KHRoaXMsIGZ1bmN0aW9uKEJhY2tib25lKSB7Ci8vIEEgc2ltcGxlIG1vZHVsZSB0byByZXBsYWNlIGBCYWNrYm9uZS5zeW5jYCB3aXRoICpsb2NhbFN0b3JhZ2UqLWJhc2VkCi8vIHBlcnNpc3RlbmNlLiBNb2RlbHMgYXJlIGdpdmVuIEdVSURTLCBhbmQgc2F2ZWQgaW50byBhIEpTT04gb2JqZWN0LiBTaW1wbGUKLy8gYXMgdGhhdC4KCi8vIEhvbGQgcmVmZXJlbmNlIHRvIFVuZGVyc2NvcmUuanMgYW5kIEJhY2tib25lLmpzIGluIHRoZSBjbG9zdXJlIGluIG9yZGVyCi8vIHRvIG1ha2UgdGhpbmdzIHdvcmsgZXZlbiBpZiB0aGV5IGFyZSByZW1vdmVkIGZyb20gdGhlIGdsb2JhbCBuYW1lc3BhY2UKCi8vIEdlbmVyYXRlIGZvdXIgcmFuZG9tIGhleCBkaWdpdHMuCmZ1bmN0aW9uIFM0KCkgewogICByZXR1cm4gKCgoMStNYXRoLnJhbmRvbSgpKSoweDEwMDAwKXwwKS50b1N0cmluZygxNikuc3Vic3RyaW5nKDEpOwp9OwoKLy8gR2VuZXJhdGUgYSBwc2V1ZG8tR1VJRCBieSBjb25jYXRlbmF0aW5nIHJhbmRvbSBoZXhhZGVjaW1hbC4KZnVuY3Rpb24gZ3VpZCgpIHsKICAgcmV0dXJuIChTNCgpK1M0KCkrIi0iK1M0KCkrIi0iK1M0KCkrIi0iK1M0KCkrIi0iK1M0KCkrUzQoKStTNCgpKTsKfTsKCmZ1bmN0aW9uIGlzT2JqZWN0KGl0ZW0pIHsKICByZXR1cm4gaXRlbSA9PT0gT2JqZWN0KGl0ZW0pOwp9CgpmdW5jdGlvbiBjb250YWlucyhhcnJheSwgaXRlbSkgewogIHZhciBpID0gYXJyYXkubGVuZ3RoOwogIHdoaWxlIChpLS0pIGlmIChhcnJheVtpXSA9PT0gaXRlbSkgcmV0dXJuIHRydWU7CiAgcmV0dXJuIGZhbHNlOwp9CgpmdW5jdGlvbiBleHRlbmQob2JqLCBwcm9wcykgewogIGZvciAodmFyIGtleSBpbiBwcm9wcykgb2JqW2tleV0gPSBwcm9wc1trZXldCiAgcmV0dXJuIG9iajsKfQoKLy8gT3VyIFN0b3JlIGlzIHJlcHJlc2VudGVkIGJ5IGEgc2luZ2xlIEpTIG9iamVjdCBpbiAqbG9jYWxTdG9yYWdlKi4gQ3JlYXRlIGl0Ci8vIHdpdGggYSBtZWFuaW5nZnVsIG5hbWUsIGxpa2UgdGhlIG5hbWUgeW91J2QgZ2l2ZSBhIHRhYmxlLgovLyB3aW5kb3cuU3RvcmUgaXMgZGVwcmVjdGF0ZWQsIHVzZSBCYWNrYm9uZS5Mb2NhbFN0b3JhZ2UgaW5zdGVhZApCYWNrYm9uZS5Mb2NhbFN0b3JhZ2UgPSB3aW5kb3cuU3RvcmUgPSBmdW5jdGlvbihuYW1lLCBzZXJpYWxpemVyKSB7CiAgaWYoICF0aGlzLmxvY2FsU3RvcmFnZSApIHsKICAgIHRocm93ICJCYWNrYm9uZS5sb2NhbFN0b3JhZ2U6IEVudmlyb25tZW50IGRvZXMgbm90IHN1cHBvcnQgbG9jYWxTdG9yYWdlLiIKICB9CiAgdGhpcy5uYW1lID0gbmFtZTsKICB0aGlzLnNlcmlhbGl6ZXIgPSBzZXJpYWxpemVyIHx8IHsKICAgIHNlcmlhbGl6ZTogZnVuY3Rpb24oaXRlbSkgewogICAgICByZXR1cm4gaXNPYmplY3QoaXRlbSkgPyBKU09OLnN0cmluZ2lmeShpdGVtKSA6IGl0ZW07CiAgICB9LAogICAgLy8gZml4IGZvciAiaWxsZWdhbCBhY2Nlc3MiIGVycm9yIG9uIEFuZHJvaWQgd2hlbiBKU09OLnBhcnNlIGlzIHBhc3NlZCBudWxsCiAgICBkZXNlcmlhbGl6ZTogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgcmV0dXJuIGRhdGEgJiYgSlNPTi5wYXJzZShkYXRhKTsKICAgIH0KICB9OwogIHZhciBzdG9yZSA9IHRoaXMubG9jYWxTdG9yYWdlKCkuZ2V0SXRlbSh0aGlzLm5hbWUpOwogIHRoaXMucmVjb3JkcyA9IChzdG9yZSAmJiBzdG9yZS5zcGxpdCgiLCIpKSB8fCBbXTsKfTsKCmV4dGVuZChCYWNrYm9uZS5Mb2NhbFN0b3JhZ2UucHJvdG90eXBlLCB7CgogIC8vIFNhdmUgdGhlIGN1cnJlbnQgc3RhdGUgb2YgdGhlICoqU3RvcmUqKiB0byAqbG9jYWxTdG9yYWdlKi4KICBzYXZlOiBmdW5jdGlvbigpIHsKICAgIHRoaXMubG9jYWxTdG9yYWdlKCkuc2V0SXRlbSh0aGlzLm5hbWUsIHRoaXMucmVjb3Jkcy5qb2luKCIsIikpOwogIH0sCgogIC8vIEFkZCBhIG1vZGVsLCBnaXZpbmcgaXQgYSAoaG9wZWZ1bGx5KS11bmlxdWUgR1VJRCwgaWYgaXQgZG9lc24ndCBhbHJlYWR5CiAgLy8gaGF2ZSBhbiBpZCBvZiBpdCdzIG93bi4KICBjcmVhdGU6IGZ1bmN0aW9uKG1vZGVsKSB7CiAgICBpZiAoIW1vZGVsLmlkKSB7CiAgICAgIG1vZGVsLmlkID0gZ3VpZCgpOwogICAgICBtb2RlbC5zZXQobW9kZWwuaWRBdHRyaWJ1dGUsIG1vZGVsLmlkKTsKICAgIH0KICAgIHRoaXMubG9jYWxTdG9yYWdlKCkuc2V0SXRlbSh0aGlzLl9pdGVtTmFtZShtb2RlbC5pZCksIHRoaXMuc2VyaWFsaXplci5zZXJpYWxpemUobW9kZWwpKTsKICAgIHRoaXMucmVjb3Jkcy5wdXNoKG1vZGVsLmlkLnRvU3RyaW5nKCkpOwogICAgdGhpcy5zYXZlKCk7CiAgICByZXR1cm4gdGhpcy5maW5kKG1vZGVsKSAhPT0gZmFsc2U7CiAgfSwKCiAgLy8gVXBkYXRlIGEgbW9kZWwgYnkgcmVwbGFjaW5nIGl0cyBjb3B5IGluIGB0aGlzLmRhdGFgLgogIHVwZGF0ZTogZnVuY3Rpb24obW9kZWwpIHsKICAgIHRoaXMubG9jYWxTdG9yYWdlKCkuc2V0SXRlbSh0aGlzLl9pdGVtTmFtZShtb2RlbC5pZCksIHRoaXMuc2VyaWFsaXplci5zZXJpYWxpemUobW9kZWwpKTsKICAgIHZhciBtb2RlbElkID0gbW9kZWwuaWQudG9TdHJpbmcoKTsKICAgIGlmICghY29udGFpbnModGhpcy5yZWNvcmRzLCBtb2RlbElkKSkgewogICAgICB0aGlzLnJlY29yZHMucHVzaChtb2RlbElkKTsKICAgICAgdGhpcy5zYXZlKCk7CiAgICB9CiAgICByZXR1cm4gdGhpcy5maW5kKG1vZGVsKSAhPT0gZmFsc2U7CiAgfSwKCiAgLy8gUmV0cmlldmUgYSBtb2RlbCBmcm9tIGB0aGlzLmRhdGFgIGJ5IGlkLgogIGZpbmQ6IGZ1bmN0aW9uKG1vZGVsKSB7CiAgICByZXR1cm4gdGhpcy5zZXJpYWxpemVyLmRlc2VyaWFsaXplKHRoaXMubG9jYWxTdG9yYWdlKCkuZ2V0SXRlbSh0aGlzLl9pdGVtTmFtZShtb2RlbC5pZCkpKTsKICB9LAoKICAvLyBSZXR1cm4gdGhlIGFycmF5IG9mIGFsbCBtb2RlbHMgY3VycmVudGx5IGluIHN0b3JhZ2UuCiAgZmluZEFsbDogZnVuY3Rpb24oKSB7CiAgICB2YXIgcmVzdWx0ID0gW107CiAgICBmb3IgKHZhciBpID0gMCwgaWQsIGRhdGE7IGkgPCB0aGlzLnJlY29yZHMubGVuZ3RoOyBpKyspIHsKICAgICAgaWQgPSB0aGlzLnJlY29yZHNbaV07CiAgICAgIGRhdGEgPSB0aGlzLnNlcmlhbGl6ZXIuZGVzZXJpYWxpemUodGhpcy5sb2NhbFN0b3JhZ2UoKS5nZXRJdGVtKHRoaXMuX2l0ZW1OYW1lKGlkKSkpOwogICAgICBpZiAoZGF0YSAhPSBudWxsKSByZXN1bHQucHVzaChkYXRhKTsKICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfSwKCiAgLy8gRGVsZXRlIGEgbW9kZWwgZnJvbSBgdGhpcy5kYXRhYCwgcmV0dXJuaW5nIGl0LgogIGRlc3Ryb3k6IGZ1bmN0aW9uKG1vZGVsKSB7CiAgICB0aGlzLmxvY2FsU3RvcmFnZSgpLnJlbW92ZUl0ZW0odGhpcy5faXRlbU5hbWUobW9kZWwuaWQpKTsKICAgIHZhciBtb2RlbElkID0gbW9kZWwuaWQudG9TdHJpbmcoKTsKICAgIGZvciAodmFyIGkgPSAwLCBpZDsgaSA8IHRoaXMucmVjb3Jkcy5sZW5ndGg7IGkrKykgewogICAgICBpZiAodGhpcy5yZWNvcmRzW2ldID09PSBtb2RlbElkKSB7CiAgICAgICAgdGhpcy5yZWNvcmRzLnNwbGljZShpLCAxKTsKICAgICAgfQogICAgfQogICAgdGhpcy5zYXZlKCk7CiAgICByZXR1cm4gbW9kZWw7CiAgfSwKCiAgbG9jYWxTdG9yYWdlOiBmdW5jdGlvbigpIHsKICAgIHJldHVybiBsb2NhbFN0b3JhZ2U7CiAgfSwKCiAgLy8gQ2xlYXIgbG9jYWxTdG9yYWdlIGZvciBzcGVjaWZpYyBjb2xsZWN0aW9uLgogIF9jbGVhcjogZnVuY3Rpb24oKSB7CiAgICB2YXIgbG9jYWwgPSB0aGlzLmxvY2FsU3RvcmFnZSgpLAogICAgICBpdGVtUmUgPSBuZXcgUmVnRXhwKCJeIiArIHRoaXMubmFtZSArICItIik7CgogICAgLy8gUmVtb3ZlIGlkLXRyYWNraW5nIGl0ZW0gKGUuZy4sICJmb28iKS4KICAgIGxvY2FsLnJlbW92ZUl0ZW0odGhpcy5uYW1lKTsKCiAgICAvLyBNYXRjaCBhbGwgZGF0YSBpdGVtcyAoZS5nLiwgImZvby1JRCIpIGFuZCByZW1vdmUuCiAgICBmb3IgKHZhciBrIGluIGxvY2FsKSB7CiAgICAgIGlmIChpdGVtUmUudGVzdChrKSkgewogICAgICAgIGxvY2FsLnJlbW92ZUl0ZW0oayk7CiAgICAgIH0KICAgIH0KCiAgICB0aGlzLnJlY29yZHMubGVuZ3RoID0gMDsKICB9LAoKICAvLyBTaXplIG9mIGxvY2FsU3RvcmFnZS4KICBfc3RvcmFnZVNpemU6IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHRoaXMubG9jYWxTdG9yYWdlKCkubGVuZ3RoOwogIH0sCgogIF9pdGVtTmFtZTogZnVuY3Rpb24oaWQpIHsKICAgIHJldHVybiB0aGlzLm5hbWUrIi0iK2lkOwogIH0KCn0pOwoKLy8gbG9jYWxTeW5jIGRlbGVnYXRlIHRvIHRoZSBtb2RlbCBvciBjb2xsZWN0aW9uJ3MKLy8gKmxvY2FsU3RvcmFnZSogcHJvcGVydHksIHdoaWNoIHNob3VsZCBiZSBhbiBpbnN0YW5jZSBvZiBgU3RvcmVgLgovLyB3aW5kb3cuU3RvcmUuc3luYyBhbmQgQmFja2JvbmUubG9jYWxTeW5jIGlzIGRlcHJlY2F0ZWQsIHVzZSBCYWNrYm9uZS5Mb2NhbFN0b3JhZ2Uuc3luYyBpbnN0ZWFkCkJhY2tib25lLkxvY2FsU3RvcmFnZS5zeW5jID0gd2luZG93LlN0b3JlLnN5bmMgPSBCYWNrYm9uZS5sb2NhbFN5bmMgPSBmdW5jdGlvbihtZXRob2QsIG1vZGVsLCBvcHRpb25zKSB7CiAgdmFyIHN0b3JlID0gbW9kZWwubG9jYWxTdG9yYWdlIHx8IG1vZGVsLmNvbGxlY3Rpb24ubG9jYWxTdG9yYWdlOwoKICB2YXIgcmVzcCwgZXJyb3JNZXNzYWdlOwogIC8vSWYgJCBpcyBoYXZpbmcgRGVmZXJyZWQgLSB1c2UgaXQuCiAgdmFyIHN5bmNEZmQgPSBCYWNrYm9uZS4kID8KICAgIChCYWNrYm9uZS4kLkRlZmVycmVkICYmIEJhY2tib25lLiQuRGVmZXJyZWQoKSkgOgogICAgKEJhY2tib25lLkRlZmVycmVkICYmIEJhY2tib25lLkRlZmVycmVkKCkpOwoKICB0cnkgewoKICAgIHN3aXRjaCAobWV0aG9kKSB7CiAgICAgIGNhc2UgInJlYWQiOgogICAgICAgIHJlc3AgPSBtb2RlbC5pZCAhPSB1bmRlZmluZWQgPyBzdG9yZS5maW5kKG1vZGVsKSA6IHN0b3JlLmZpbmRBbGwoKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAiY3JlYXRlIjoKICAgICAgICByZXNwID0gc3RvcmUuY3JlYXRlKG1vZGVsKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAidXBkYXRlIjoKICAgICAgICByZXNwID0gc3RvcmUudXBkYXRlKG1vZGVsKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAiZGVsZXRlIjoKICAgICAgICByZXNwID0gc3RvcmUuZGVzdHJveShtb2RlbCk7CiAgICAgICAgYnJlYWs7CiAgICB9CgogIH0gY2F0Y2goZXJyb3IpIHsKICAgIGlmIChlcnJvci5jb2RlID09PSAyMiAmJiBzdG9yZS5fc3RvcmFnZVNpemUoKSA9PT0gMCkKICAgICAgZXJyb3JNZXNzYWdlID0gIlByaXZhdGUgYnJvd3NpbmcgaXMgdW5zdXBwb3J0ZWQiOwogICAgZWxzZQogICAgICBlcnJvck1lc3NhZ2UgPSBlcnJvci5tZXNzYWdlOwogIH0KCiAgaWYgKHJlc3ApIHsKICAgIGlmIChvcHRpb25zICYmIG9wdGlvbnMuc3VjY2VzcykgewogICAgICBpZiAoQmFja2JvbmUuVkVSU0lPTiA9PT0gIjAuOS4xMCIpIHsKICAgICAgICBvcHRpb25zLnN1Y2Nlc3MobW9kZWwsIHJlc3AsIG9wdGlvbnMpOwogICAgICB9IGVsc2UgewogICAgICAgIG9wdGlvbnMuc3VjY2VzcyhyZXNwKTsKICAgICAgfQogICAgfQogICAgaWYgKHN5bmNEZmQpIHsKICAgICAgc3luY0RmZC5yZXNvbHZlKHJlc3ApOwogICAgfQoKICB9IGVsc2UgewogICAgZXJyb3JNZXNzYWdlID0gZXJyb3JNZXNzYWdlID8gZXJyb3JNZXNzYWdlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgOiAiUmVjb3JkIE5vdCBGb3VuZCI7CgogICAgaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy5lcnJvcikKICAgICAgaWYgKEJhY2tib25lLlZFUlNJT04gPT09ICIwLjkuMTAiKSB7CiAgICAgICAgb3B0aW9ucy5lcnJvcihtb2RlbCwgZXJyb3JNZXNzYWdlLCBvcHRpb25zKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBvcHRpb25zLmVycm9yKGVycm9yTWVzc2FnZSk7CiAgICAgIH0KCiAgICBpZiAoc3luY0RmZCkKICAgICAgc3luY0RmZC5yZWplY3QoZXJyb3JNZXNzYWdlKTsKICB9CgogIC8vIGFkZCBjb21wYXRpYmlsaXR5IHdpdGggJC5hamF4CiAgLy8gYWx3YXlzIGV4ZWN1dGUgY2FsbGJhY2sgZm9yIHN1Y2Nlc3MgYW5kIGVycm9yCiAgaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy5jb21wbGV0ZSkgb3B0aW9ucy5jb21wbGV0ZShyZXNwKTsKCiAgcmV0dXJuIHN5bmNEZmQgJiYgc3luY0RmZC5wcm9taXNlKCk7Cn07CgpCYWNrYm9uZS5hamF4U3luYyA9IEJhY2tib25lLnN5bmM7CgpCYWNrYm9uZS5nZXRTeW5jTWV0aG9kID0gZnVuY3Rpb24obW9kZWwpIHsKICBpZihtb2RlbC5sb2NhbFN0b3JhZ2UgfHwgKG1vZGVsLmNvbGxlY3Rpb24gJiYgbW9kZWwuY29sbGVjdGlvbi5sb2NhbFN0b3JhZ2UpKSB7CiAgICByZXR1cm4gQmFja2JvbmUubG9jYWxTeW5jOwogIH0KCiAgcmV0dXJuIEJhY2tib25lLmFqYXhTeW5jOwp9OwoKLy8gT3ZlcnJpZGUgJ0JhY2tib25lLnN5bmMnIHRvIGRlZmF1bHQgdG8gbG9jYWxTeW5jLAovLyB0aGUgb3JpZ2luYWwgJ0JhY2tib25lLnN5bmMnIGlzIHN0aWxsIGF2YWlsYWJsZSBpbiAnQmFja2JvbmUuYWpheFN5bmMnCkJhY2tib25lLnN5bmMgPSBmdW5jdGlvbihtZXRob2QsIG1vZGVsLCBvcHRpb25zKSB7CiAgcmV0dXJuIEJhY2tib25lLmdldFN5bmNNZXRob2QobW9kZWwpLmFwcGx5KHRoaXMsIFttZXRob2QsIG1vZGVsLCBvcHRpb25zXSk7Cn07CgpyZXR1cm4gQmFja2JvbmUuTG9jYWxTdG9yYWdlOwp9KSk7CgpkZWZpbmUoJ2dhbGxlcnkvdXRpbHMvcmVzcG9uc2l2ZS5hZGFwdGVyJyxbCiAgJ2pxdWVyeScsCiAgJ3VuZGVyc2NvcmUnCl0sIGZ1bmN0aW9uKCQsIF8pIHsKICAKICAvKgogICAqIFJlc3BvbnNpdmVBZGFwdGVyCiAgICoKICAgKiBLbm93cyBob3cgZGl2ZXJzZSBNb2R1bGVzIHJlYWN0IGRpZmZlcmVudCBpbiBzb21lIGFzcGVjdHMgdG8gZGlmZmVyZW50IAogICAqIGRldmljZXMuCiAgICogS25vd3Mgd2hpY2ggcHJlc2V0IHRvIGNob29zZSBmb3IgdGhlIGRldmljZSBvbiB3aGljaCB3ZSBhcmUuIAogICAqIGkuZS4gcmVwbGFjZXMgbGFyZ2Ugd2l0aCBsYXJnZV9waG9uZQogICAqCiAgICovCiAgdmFyIFJlc3BvbnNpdmVBZGFwdGVyID0gewoKICAgIC8qCiAgICAgKiBNZWRpYXR5cGUgaXMgZGVmaW5lZCBpbiBkZXZpY2VzLmNzcyB3aXRoIG1lZGlhIHF1ZXJpZXMuIAogICAgICogRGVmYXVsdCB2YWx1ZXMgZm9yIG1lZGlhIHR5cGVzIGFyZSAnZGVza3RvcCcsICdwYWRzJywgJ3Bob25lcycKICAgICAqLwogICAgZ2V0TWVkaWFUeXBlOiBmdW5jdGlvbigpIHsKICAgICAgaWYgKHRoaXMubWVkaWFUeXBlKSB7CiAgICAgICAgcmV0dXJuIHRoaXMubWVkaWFUeXBlOwogICAgICB9IGVsc2UgewogICAgICAgIGlmICghd2luZG93LmdldENvbXB1dGVkU3R5bGUpIHsKICAgICAgICAgIHJldHVybiB0aGlzLm1lZGlhVHlwZSA9ICdkZXNrdG9wJzsgLy8ganNoaW50IGlnbm9yZTpsaW5lCiAgICAgICAgfQogICAgICAgIHZhciBtdCA9IHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKGRvY3VtZW50LmJvZHksJzphZnRlcicpCiAgICAgICAgICAuZ2V0UHJvcGVydHlWYWx1ZSgnY29udGVudCcpLm1hdGNoKC9bYS16QS1aX1wtMC05XSsvZyk7CgogICAgICAgIHJldHVybiB0aGlzLm1lZGlhVHlwZSA9IG10ICYmIG10Lmxlbmd0aD4wID8gbXRbMF0gOiAnZGVza3RvcCc7IC8vIGpzaGludCBpZ25vcmU6bGluZQogICAgICB9CiAgICB9LAogICAgCiAgICAvKgogICAgICogRXhwZWN0cyBhbiBvcHRpb25zLUhhc2ggb3B0cyBhbmQgYSBrZXkgb2YgdGhpcyBIYXNoLiBUaGUgZGVzY3JpYmVkIHZhbHVlIAogICAgICogY2FuIGJlIGEgZGlyZWN0bHkgcmV0dXJuZWQgc2luZ2xlIHZhbHVlIG9yIGFuIG9iamVjdCBIYXNoIHdpdGggdGhlCiAgICAgKiBtZWRpYVR5cGVzIG1hbmFnZWQgYnkgdGhpcyBhZGFwdGVyIGFzIGtleXMuCiAgICAgKi8KICAgIGdldE9wdGlvbkJ5TWVkaWFUeXBlOiBmdW5jdGlvbihvcHRzLCBrZXkpIHsKICAgICAgaWYgKCQuaXNQbGFpbk9iamVjdChvcHRzW2tleV0pKSB7CiAgICAgICAgcmV0dXJuIG9wdHNba2V5XVt0aGlzLmdldE1lZGlhVHlwZSgpXTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gb3B0c1trZXldOwogICAgICB9CiAgICB9LAogICAgCiAgICBwcmVzZXRNYXBwZXJUaHVtYjogZnVuY3Rpb24oaW1hZ2VNb2RlbCkgewogICAgICB2YXIgcHJlc2V0OwogICAgICBzd2l0Y2godGhpcy5nZXRNZWRpYVR5cGUoKSkgewogICAgICAgIGNhc2UgJ2Rlc2t0b3AnOgogICAgICAgIGNhc2UgJ3BhZCc6CiAgICAgICAgY2FzZSAncGhvbmUnOgogICAgICAgICAgcHJlc2V0ID0gaW1hZ2VNb2RlbC5nZXQoJ3RodW1iJyk7CiAgICAgICAgICBicmVhazsKICAgICAgfQogICAgICByZXR1cm4gcHJlc2V0OwogICAgfSwKCiAgICBwcmVzZXRNYXBwZXJMYXJnZTogZnVuY3Rpb24oaW1hZ2VNb2RlbCkgewogICAgICB2YXIgcHJlc2V0OwogICAgICBzd2l0Y2godGhpcy5nZXRNZWRpYVR5cGUoKSkgewogICAgICAgIGNhc2UgJ2Rlc2t0b3AnOgogICAgICAgICAgcHJlc2V0ID0gaW1hZ2VNb2RlbC5nZXQoJ2xhcmdlJyk7CiAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlICdwYWQnOgogICAgICAgICAgcHJlc2V0ID0gaW1hZ2VNb2RlbC5nZXQoJ2xhcmdlX3BhZHMnKTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgJ3Bob25lJzoKICAgICAgICAgIHByZXNldCA9IGltYWdlTW9kZWwuZ2V0KCdsYXJnZV9waG9uZXMnKTsKICAgICAgICAgIGJyZWFrOwogICAgICB9CiAgICAgIHJldHVybiBwcmVzZXQ7CiAgICB9CiAgICAKICB9OwogIAogIHJldHVybiBSZXNwb25zaXZlQWRhcHRlcjsKfSk7CgovKgogKiBHYWxsZXJ5SW1hZ2UgTW9kZWwKICogLS0tLS0tLS0tLQogKgogKiBPdXIgYmFzaWMgKipJbWFnZU1vZGVsKiogaGFzIGF0dHJpYnV0ZXMgZm9yIHRoZSAndGh1bWInLAogKiAnbGFyZ2UnIGFuZCBtZXRhZGF0YSBsaWtlICdvcmllbnRhdGlvbicsICdyYXRpbycsICdleGlmJy4uLgogKgogKi8KZGVmaW5lKCdnYWxsZXJ5L21vZGVscy9pbWFnZS5tb2RlbCcsWwogICd1bmRlcnNjb3JlJywKICAnYmFja2JvbmUnLAogICdnYWxsZXJ5L3V0aWxzL3Jlc3BvbnNpdmUuYWRhcHRlcicKXSwgZnVuY3Rpb24oXywgQmFja2JvbmUsIFJlc3BvbnNpdmVBZGFwdGVyKSB7CiAgdmFyIEltYWdlTW9kZWwgPSBCYWNrYm9uZS5Nb2RlbC5leHRlbmQoewoKICAgIGlkQXR0cmlidXRlOiAnZGlnZXN0JywKCiAgICAvLyBEZWZhdWx0IGF0dHJpYnV0ZXMgZm9yIHRoZSBHYWxsZXJ5SW1hZ2UuCiAgICBkZWZhdWx0czogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgdGh1bWI6IHsKICAgICAgICAgIHNyYzogdW5kZWZpbmVkLAogICAgICAgICAgd2lkdGg6IHVuZGVmaW5lZCwKICAgICAgICAgIGhlaWdodDogdW5kZWZpbmVkLAogICAgICAgICAgX3ZpZXc6IHVuZGVmaW5lZAogICAgICAgIH0sCiAgICAgICAgbGFyZ2U6IHsKICAgICAgICAgIHNyYzogdW5kZWZpbmVkLAogICAgICAgICAgd2lkdGg6IHVuZGVmaW5lZCwKICAgICAgICAgIGhlaWdodDogdW5kZWZpbmVkLAogICAgICAgICAgX3ZpZXc6IHVuZGVmaW5lZAogICAgICAgIH0sCiAgICAgICAgZmlsZW5hbWU6IHVuZGVmaW5lZCwKICAgICAgICBmaWxlbmFtZU9yaWc6IHVuZGVmaW5lZCwKICAgICAgICBkaWdlc3Q6IHVuZGVmaW5lZCwKICAgICAgICBpbmRleDogdW5kZWZpbmVkLAogICAgICAgIG9yaWVudGF0aW9uOiB1bmRlZmluZWQsIC8vIGxhbmRzY2FwZSB8IHBvcnRyYWl0CiAgICAgICAgcmF0aW86IDAsIC8vIDwgMSA9PiBwb3J0cmFpdCB8ID4gMSBsYW5kc2NhcGUgVE9ETzogRG9wcGVsdW5nCiAgICAgICAgZXhpZjoge30sCiAgICAgICAgbWV0YToge30sCiAgICAgICAgaW1hZ2VQYWdlUGF0aDogdW5kZWZpbmVkCiAgICAgIH07CiAgICB9LAogICAgCiAgICAvLyBDb25zdHJ1Y3Rvci9Jbml0aWFsaXplciBoYXMgdG8gYmUgY2FsbGVkIHdpdGggYSBvcHRpb25zLnByZXNldHMgaGFzaCB3aXRoIAogICAgLy8gYSBiYXNldXJsIGZvciBldmVyeSBwcmVzZXQgKG1pbmltdW06IHRodW1iICYgbGFyZ2UpLgogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oYXR0cnMsIG9wdGlvbnMpIHsKICAgICAgaWYgKG9wdGlvbnMgIT09IHVuZGVmaW5lZCkgewogICAgICAgIC8vIHNldCB0aGUgc3JjIGF0dHJpYnV0ZSBmb3IgZXZlcnkgcHJlc2V0CiAgICAgICAgXy5mb3JFYWNoKG9wdGlvbnMucHJlc2V0cywgXy5iaW5kKGZ1bmN0aW9uKHByZXNldCwgcHJlc2V0S2V5KSB7CiAgICAgICAgICB0aGlzLmF0dHJpYnV0ZXNbcHJlc2V0S2V5XVsnc3JjJ10gPSBwcmVzZXRbJ2Jhc2V1cmwnXSArICcvJyArIGF0dHJzWydmaWxlbmFtZSddOwogICAgICAgIH0sIHRoaXMpKTsKICAgICAgICAvLyBzZXQgb3JpZy1maWxlbmFtZQogICAgICAgIHRoaXMuYXR0cmlidXRlc1snZmlsZW5hbWVPcmlnJ10gPSBhdHRyc1snZmlsZW5hbWUnXS5yZXBsYWNlKCctJyArIGF0dHJzWydkaWdlc3QnXSwgJycpOwogICAgICAgIC8vIHNldCBpbWFnZV9wYWdlIHVybAogICAgICAgIGlmIChvcHRpb25zLmdhbGxlcnkgJiYgb3B0aW9ucy5nYWxsZXJ5LmltYWdlUGFnZXMgJiYgb3B0aW9ucy5nYWxsZXJ5LmJhc2VwYXRoKSB7CiAgICAgICAgICB0aGlzLmF0dHJpYnV0ZXNbJ2ltYWdlUGFnZVBhdGgnXSA9IG9wdGlvbnMuZ2FsbGVyeS5wYXRoLnJlcGxhY2UoL1wuaHRtbCQvLCAnJykgKyAnLycgKyBhdHRyc1snZGlnZXN0J107CiAgICAgICAgfQogICAgICB9CiAgICB9LAoKICAgIC8vIFJldHVybnMgdGhlIHByZXNldCBIYXNoIGZvciB0aGUgVGh1bWIgb24gdGhlIGN1cnJlbnQgZGV2aWNlCiAgICBnZXRUaHVtYjogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBSZXNwb25zaXZlQWRhcHRlci5wcmVzZXRNYXBwZXJUaHVtYih0aGlzKTsKICAgIH0sCgogICAgLy8gUmV0dXJucyB0aGUgcHJlc2V0IEhhc2ggZm9yIHRoZSBMYXJnZSBvbiB0aGUgY3VycmVudCBkZXZpY2UKICAgIGdldExhcmdlOiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIFJlc3BvbnNpdmVBZGFwdGVyLnByZXNldE1hcHBlckxhcmdlKHRoaXMpOwogICAgfSwKICAgIAogICAgZ2V0VGh1bWJWaWV3OiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHRoaXMuX3RodW1iVmlldzsKICAgIH0sCiAgICAKICAgIHNldFRodW1iVmlldzogZnVuY3Rpb24odGh1bWJWaWV3KSB7CiAgICAgIHRoaXMuX3RodW1iVmlldyA9IHRodW1iVmlldzsKICAgIH0sCiAgICAKICAgIGdldExhcmdlVmlldzogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB0aGlzLl9sYXJnZVZpZXc7CiAgICB9LAogICAgCiAgICBzZXRMYXJnZVZpZXc6IGZ1bmN0aW9uKGxhcmdlVmlldykgewogICAgICB0aGlzLl9sYXJnZVZpZXcgPSBsYXJnZVZpZXc7CiAgICB9LAogICAgICAgIAogICAgaW5kZXg6IGZ1bmN0aW9uKCkgewogICAgICBpZiAodGhpcy5hdHRyaWJ1dGVzLmluZGV4ID09PSB1bmRlZmluZWQpIHsKICAgICAgICByZXR1cm4gdGhpcy5jb2xsZWN0aW9uID8gdGhpcy5jb2xsZWN0aW9uLmluZGV4T2YodGhpcykgOiB1bmRlZmluZWQ7CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXMuYXR0cmlidXRlcy5pbmRleDsKICAgIH0KICB9KTsKICAKICByZXR1cm4gSW1hZ2VNb2RlbDsKfSk7CgovKiBJbWFnZUNvbGxlY3Rpb24KICogLS0tLS0tLS0tLS0tLS0tCiAqCiAqIFRoZSBjb2xsZWN0aW9uIG9mIEltYWdlTW9kZWwgb2JqZWN0cy4KICoKICovCmRlZmluZSgnZ2FsbGVyeS9jb2xsZWN0aW9ucy9pbWFnZS5jb2xsZWN0aW9uJyxbCiAgJ2JhY2tib25lJywgCiAgJ2xvY2Fsc3RvcmFnZScsCiAgJ2dhbGxlcnkvbW9kZWxzL2ltYWdlLm1vZGVsJwpdLCBmdW5jdGlvbihCYWNrYm9uZSwgbm9wZSwgSW1hZ2VNb2RlbCkgewogIAogIHZhciBJbWFnZUNvbGxlY3Rpb24gPSBCYWNrYm9uZS5Db2xsZWN0aW9uLmV4dGVuZCh7CgogICAgLy8gUmVmZXJlbmNlIHRvIHRoaXMgY29sbGVjdGlvbidzIG1vZGVsLgogICAgbW9kZWw6IEltYWdlTW9kZWwsCgogICAgLy8gTWFrZSBDb2xsZWN0aW9uIGEgTG9jYWxTdG9yYWdlIENvbGxlY3Rpb24sIHdoZW4gb3B0cy5sb2NhbFN0b3JhZ2VLZXkgaXMKICAgIC8vIGdpdmVuLgogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24obW9kZWxzLCBvcHRzKSB7CiAgICAgIGlmIChvcHRzLmxvY2FsU3RvcmFnZUtleSkgewogICAgICAgIHRoaXMua2V5ID0gb3B0cy5sb2NhbFN0b3JhZ2VLZXk7CiAgICAgICAgdGhpcy5sb2NhbFN0b3JhZ2UgPSBuZXcgQmFja2JvbmUuTG9jYWxTdG9yYWdlKHRoaXMua2V5KTsKICAgICAgfQogICAgfSwKCiAgICBwYXJzZTogZnVuY3Rpb24ocmVzcG9uc2UpIHsKICAgICAgcmV0dXJuIHJlc3BvbnNlOwogICAgfQoKICB9KTsKICAKICByZXR1cm4gSW1hZ2VDb2xsZWN0aW9uOwp9KTsKCmRlZmluZSgncGx1Z2lucy9wbHVnaW5zJyxbXSwgZnVuY3Rpb24oKSB7CiAgCiAgLyoKICAgKiBwb2x5ZmlsbCBmb3IgY29uc29sZQogICAqIEF2b2lkIGBjb25zb2xlYCBlcnJvcnMgaW4gYnJvd3NlcnMgdGhhdCBsYWNrIGEgY29uc29sZS4KICAgKi8KICB2YXIgbWV0aG9kOwogIHZhciBub29wID0gZnVuY3Rpb24gKCkge307CiAgdmFyIG1ldGhvZHMgPSBbCiAgICAnYXNzZXJ0JywgJ2NsZWFyJywgJ2NvdW50JywgJ2RlYnVnJywgJ2RpcicsICdkaXJ4bWwnLCAnZXJyb3InLAogICAgJ2V4Y2VwdGlvbicsICdncm91cCcsICdncm91cENvbGxhcHNlZCcsICdncm91cEVuZCcsICdpbmZvJywgJ2xvZycsCiAgICAnbWFya1RpbWVsaW5lJywgJ3Byb2ZpbGUnLCAncHJvZmlsZUVuZCcsICd0YWJsZScsICd0aW1lJywgJ3RpbWVFbmQnLAogICAgJ3RpbWVTdGFtcCcsICd0cmFjZScsICd3YXJuJwogIF07CiAgdmFyIGxlbmd0aCA9IG1ldGhvZHMubGVuZ3RoOwogIHZhciBjb25zb2xlID0gKHdpbmRvdy5jb25zb2xlID0gd2luZG93LmNvbnNvbGUgfHwge30pOwoKICB3aGlsZSAobGVuZ3RoLS0pIHsKICAgIG1ldGhvZCA9IG1ldGhvZHNbbGVuZ3RoXTsKCiAgICAvLyBPbmx5IHN0dWIgdW5kZWZpbmVkIG1ldGhvZHMuCiAgICBpZiAoIWNvbnNvbGVbbWV0aG9kXSkgewogICAgICBjb25zb2xlW21ldGhvZF0gPSBub29wOwogICAgfQogIH0KICAKICAvKgogICAqIFV0aWxpdHkgZm9yIHBhZGRpbmcgTnVtYmVycywgbGlrZSAxID0+IDAxLgogICAqIHN0b2xlbiBmcm9tOiBodHRwOi8vc3RhY2tvdmVyZmxvdy5jb20vcXVlc3Rpb25zLzEwNjMyMzQ2L2hvdy10by1mb3JtYXQtYS1kYXRlLWluLW1tLWRkLXl5eXktaGhtbXNzLWZvcm1hdC1pbi1qYXZhc2NyaXB0IAogICAqLwogIE51bWJlci5wcm90b3R5cGUucGFkTGVmdCA9IGZ1bmN0aW9uKGJhc2UsY2hyKXsKICAgIHZhciAgbGVuID0gKFN0cmluZyhiYXNlIHx8IDEwKS5sZW5ndGggLSBTdHJpbmcodGhpcykubGVuZ3RoKSsxOwogICAgcmV0dXJuIGxlbiA+IDA/IG5ldyBBcnJheShsZW4pLmpvaW4oY2hyIHx8ICcwJykrdGhpcyA6IHRoaXM7CiAgfTsKICAgCiAgLyoKICAqIHBhcnNlIERhdGUgU3RyaW5nIG1hbnVhbGx5LiBGb3JtYXQ6ICcyMDEzLTA5LTEzIDE1OjAxOjM0IFVUQycgCiAgKiAhISBvbmx5IFVUQyB3b3JrcyBhcyBleHBlY3RlZCAhIQogICovCiAgRGF0ZS5wYXJzZU1hbnVhbGx5ID0gZnVuY3Rpb24oZHMpIHsKICAgIGRzID0gZHMuc3BsaXQoJyAnKTsKICAgIHZhciBkYXRlID0gZHNbMF0uc3BsaXQoJy0nKTsKICAgIHZhciB0aW1lID0gZHNbMV0uc3BsaXQoJzonKTsKICAgIGRhdGUgPSBuZXcgRGF0ZShEYXRlLlVUQygKICAgICAgcGFyc2VJbnQoZGF0ZVswXSwxMCksIHBhcnNlSW50KGRhdGVbMV0sMTApIC0gMSwgcGFyc2VJbnQoZGF0ZVsyXSwxMCksCiAgICAgIHBhcnNlSW50KHRpbWVbMF0sMTApLCBwYXJzZUludCh0aW1lWzFdLDEwKSwgcGFyc2VJbnQodGltZVsyXSwxMCkKICAgICkpOwogICAgcmV0dXJuIGRhdGU7CiAgfTsKIAogIC8vIHBhcnNlVXJpIDEuMi4yCiAgLy8gKGMpIFN0ZXZlbiBMZXZpdGhhbiA8c3RldmVubGV2aXRoYW4uY29tPgogIC8vIE1JVCBMaWNlbnNlCiAgd2luZG93LnBhcnNlVXJpID0gZnVuY3Rpb24oc3RyKSB7CiAgICB2YXIgbyAgID0gd2luZG93LnBhcnNlVXJpLm9wdGlvbnMsCiAgICAgIG0gICA9IG8ucGFyc2VyW28uc3RyaWN0TW9kZSA/ICdzdHJpY3QnIDogJ2xvb3NlJ10uZXhlYyhzdHIpLAogICAgICB1cmkgPSB7fSwKICAgICAgaSAgID0gMTQ7CgogICAgd2hpbGUgKGktLSkge3VyaVtvLmtleVtpXV0gPSBtW2ldIHx8ICcnO30KCiAgICB1cmlbby5xLm5hbWVdID0ge307CiAgICB1cmlbby5rZXlbMTJdXS5yZXBsYWNlKG8ucS5wYXJzZXIsIGZ1bmN0aW9uICgkMCwgJDEsICQyKSB7CiAgICAgIGlmICgkMSkge3VyaVtvLnEubmFtZV1bJDFdID0gJDI7fQogICAgfSk7CgogICAgcmV0dXJuIHVyaTsKICB9OwoKICB3aW5kb3cucGFyc2VVcmkub3B0aW9ucyA9IHsKICAgIHN0cmljdE1vZGU6IGZhbHNlLAogICAga2V5OiBbJ3NvdXJjZScsJ3Byb3RvY29sJywnYXV0aG9yaXR5JywndXNlckluZm8nLCd1c2VyJywncGFzc3dvcmQnLCdob3N0JywncG9ydCcsJ3JlbGF0aXZlJywncGF0aCcsJ2RpcmVjdG9yeScsJ2ZpbGUnLCdxdWVyeScsJ2FuY2hvciddLAogICAgcTogICB7CiAgICAgIG5hbWU6ICAgJ3F1ZXJ5S2V5JywKICAgICAgcGFyc2VyOiAvKD86XnwmKShbXiY9XSopPT8oW14mXSopL2cKICAgIH0sCiAgICBwYXJzZXI6IHsKICAgICAgc3RyaWN0OiAvXig/OihbXjpcLz8jXSspOik/KD86XC9cLygoPzooKFteOkBdKikoPzo6KFteOkBdKikpPyk/QCk/KFteOlwvPyNdKikoPzo6KFxkKikpPykpPygoKCg/OltePyNcL10qXC8pKikoW14/I10qKSkoPzpcPyhbXiNdKikpPyg/OiMoLiopKT8pLywKICAgICAgbG9vc2U6ICAvXig/Oig/IVteOkBdKzpbXjpAXC9dKkApKFteOlwvPyMuXSspOik/KD86XC9cLyk/KCg/OigoW146QF0qKSg/OjooW146QF0qKSk/KT9AKT8oW146XC8/I10qKSg/OjooXGQqKSk/KSgoKFwvKD86W14/I10oPyFbXj8jXC9dKlwuW14/I1wvLl0rKD86Wz8jXXwkKSkpKlwvPyk/KFtePyNcL10qKSkoPzpcPyhbXiNdKikpPyg/OiMoLiopKT8pLwogICAgfQogIH07CiAgIAp9KTsKCi8qCiAqIEphdmFTY3JpcHQgTUQ1IDEuMC4xCiAqIGh0dHBzOi8vZ2l0aHViLmNvbS9ibHVlaW1wL0phdmFTY3JpcHQtTUQ1CiAqCiAqIENvcHlyaWdodCAyMDExLCBTZWJhc3RpYW4gVHNjaGFuCiAqIGh0dHBzOi8vYmx1ZWltcC5uZXQKICoKICogTGljZW5zZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlOgogKiBodHRwOi8vd3d3Lm9wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL01JVAogKiAKICogQmFzZWQgb24KICogQSBKYXZhU2NyaXB0IGltcGxlbWVudGF0aW9uIG9mIHRoZSBSU0EgRGF0YSBTZWN1cml0eSwgSW5jLiBNRDUgTWVzc2FnZQogKiBEaWdlc3QgQWxnb3JpdGhtLCBhcyBkZWZpbmVkIGluIFJGQyAxMzIxLgogKiBWZXJzaW9uIDIuMiBDb3B5cmlnaHQgKEMpIFBhdWwgSm9obnN0b24gMTk5OSAtIDIwMDkKICogT3RoZXIgY29udHJpYnV0b3JzOiBHcmVnIEhvbHQsIEFuZHJldyBLZXBlcnQsIFlkbmFyLCBMb3N0aW5ldAogKiBEaXN0cmlidXRlZCB1bmRlciB0aGUgQlNEIExpY2Vuc2UKICogU2VlIGh0dHA6Ly9wYWpob21lLm9yZy51ay9jcnlwdC9tZDUgZm9yIG1vcmUgaW5mby4KICovCgovKmpzbGludCBiaXR3aXNlOiB0cnVlICovCi8qZ2xvYmFsIHVuZXNjYXBlLCBkZWZpbmUgKi8KCihmdW5jdGlvbiAoJCkgewogICAgCgogICAgLyoKICAgICogQWRkIGludGVnZXJzLCB3cmFwcGluZyBhdCAyXjMyLiBUaGlzIHVzZXMgMTYtYml0IG9wZXJhdGlvbnMgaW50ZXJuYWxseQogICAgKiB0byB3b3JrIGFyb3VuZCBidWdzIGluIHNvbWUgSlMgaW50ZXJwcmV0ZXJzLgogICAgKi8KICAgIGZ1bmN0aW9uIHNhZmVfYWRkKHgsIHkpIHsKICAgICAgICB2YXIgbHN3ID0gKHggJiAweEZGRkYpICsgKHkgJiAweEZGRkYpLAogICAgICAgICAgICBtc3cgPSAoeCA+PiAxNikgKyAoeSA+PiAxNikgKyAobHN3ID4+IDE2KTsKICAgICAgICByZXR1cm4gKG1zdyA8PCAxNikgfCAobHN3ICYgMHhGRkZGKTsKICAgIH0KCiAgICAvKgogICAgKiBCaXR3aXNlIHJvdGF0ZSBhIDMyLWJpdCBudW1iZXIgdG8gdGhlIGxlZnQuCiAgICAqLwogICAgZnVuY3Rpb24gYml0X3JvbChudW0sIGNudCkgewogICAgICAgIHJldHVybiAobnVtIDw8IGNudCkgfCAobnVtID4+PiAoMzIgLSBjbnQpKTsKICAgIH0KCiAgICAvKgogICAgKiBUaGVzZSBmdW5jdGlvbnMgaW1wbGVtZW50IHRoZSBmb3VyIGJhc2ljIG9wZXJhdGlvbnMgdGhlIGFsZ29yaXRobSB1c2VzLgogICAgKi8KICAgIGZ1bmN0aW9uIG1kNV9jbW4ocSwgYSwgYiwgeCwgcywgdCkgewogICAgICAgIHJldHVybiBzYWZlX2FkZChiaXRfcm9sKHNhZmVfYWRkKHNhZmVfYWRkKGEsIHEpLCBzYWZlX2FkZCh4LCB0KSksIHMpLCBiKTsKICAgIH0KICAgIGZ1bmN0aW9uIG1kNV9mZihhLCBiLCBjLCBkLCB4LCBzLCB0KSB7CiAgICAgICAgcmV0dXJuIG1kNV9jbW4oKGIgJiBjKSB8ICgofmIpICYgZCksIGEsIGIsIHgsIHMsIHQpOwogICAgfQogICAgZnVuY3Rpb24gbWQ1X2dnKGEsIGIsIGMsIGQsIHgsIHMsIHQpIHsKICAgICAgICByZXR1cm4gbWQ1X2NtbigoYiAmIGQpIHwgKGMgJiAofmQpKSwgYSwgYiwgeCwgcywgdCk7CiAgICB9CiAgICBmdW5jdGlvbiBtZDVfaGgoYSwgYiwgYywgZCwgeCwgcywgdCkgewogICAgICAgIHJldHVybiBtZDVfY21uKGIgXiBjIF4gZCwgYSwgYiwgeCwgcywgdCk7CiAgICB9CiAgICBmdW5jdGlvbiBtZDVfaWkoYSwgYiwgYywgZCwgeCwgcywgdCkgewogICAgICAgIHJldHVybiBtZDVfY21uKGMgXiAoYiB8ICh+ZCkpLCBhLCBiLCB4LCBzLCB0KTsKICAgIH0KCiAgICAvKgogICAgKiBDYWxjdWxhdGUgdGhlIE1ENSBvZiBhbiBhcnJheSBvZiBsaXR0bGUtZW5kaWFuIHdvcmRzLCBhbmQgYSBiaXQgbGVuZ3RoLgogICAgKi8KICAgIGZ1bmN0aW9uIGJpbmxfbWQ1KHgsIGxlbikgewogICAgICAgIC8qIGFwcGVuZCBwYWRkaW5nICovCiAgICAgICAgeFtsZW4gPj4gNV0gfD0gMHg4MCA8PCAobGVuICUgMzIpOwogICAgICAgIHhbKCgobGVuICsgNjQpID4+PiA5KSA8PCA0KSArIDE0XSA9IGxlbjsKCiAgICAgICAgdmFyIGksIG9sZGEsIG9sZGIsIG9sZGMsIG9sZGQsCiAgICAgICAgICAgIGEgPSAgMTczMjU4NDE5MywKICAgICAgICAgICAgYiA9IC0yNzE3MzM4NzksCiAgICAgICAgICAgIGMgPSAtMTczMjU4NDE5NCwKICAgICAgICAgICAgZCA9ICAyNzE3MzM4Nzg7CgogICAgICAgIGZvciAoaSA9IDA7IGkgPCB4Lmxlbmd0aDsgaSArPSAxNikgewogICAgICAgICAgICBvbGRhID0gYTsKICAgICAgICAgICAgb2xkYiA9IGI7CiAgICAgICAgICAgIG9sZGMgPSBjOwogICAgICAgICAgICBvbGRkID0gZDsKCiAgICAgICAgICAgIGEgPSBtZDVfZmYoYSwgYiwgYywgZCwgeFtpXSwgICAgICAgNywgLTY4MDg3NjkzNik7CiAgICAgICAgICAgIGQgPSBtZDVfZmYoZCwgYSwgYiwgYywgeFtpICsgIDFdLCAxMiwgLTM4OTU2NDU4Nik7CiAgICAgICAgICAgIGMgPSBtZDVfZmYoYywgZCwgYSwgYiwgeFtpICsgIDJdLCAxNywgIDYwNjEwNTgxOSk7CiAgICAgICAgICAgIGIgPSBtZDVfZmYoYiwgYywgZCwgYSwgeFtpICsgIDNdLCAyMiwgLTEwNDQ1MjUzMzApOwogICAgICAgICAgICBhID0gbWQ1X2ZmKGEsIGIsIGMsIGQsIHhbaSArICA0XSwgIDcsIC0xNzY0MTg4OTcpOwogICAgICAgICAgICBkID0gbWQ1X2ZmKGQsIGEsIGIsIGMsIHhbaSArICA1XSwgMTIsICAxMjAwMDgwNDI2KTsKICAgICAgICAgICAgYyA9IG1kNV9mZihjLCBkLCBhLCBiLCB4W2kgKyAgNl0sIDE3LCAtMTQ3MzIzMTM0MSk7CiAgICAgICAgICAgIGIgPSBtZDVfZmYoYiwgYywgZCwgYSwgeFtpICsgIDddLCAyMiwgLTQ1NzA1OTgzKTsKICAgICAgICAgICAgYSA9IG1kNV9mZihhLCBiLCBjLCBkLCB4W2kgKyAgOF0sICA3LCAgMTc3MDAzNTQxNik7CiAgICAgICAgICAgIGQgPSBtZDVfZmYoZCwgYSwgYiwgYywgeFtpICsgIDldLCAxMiwgLTE5NTg0MTQ0MTcpOwogICAgICAgICAgICBjID0gbWQ1X2ZmKGMsIGQsIGEsIGIsIHhbaSArIDEwXSwgMTcsIC00MjA2Myk7CiAgICAgICAgICAgIGIgPSBtZDVfZmYoYiwgYywgZCwgYSwgeFtpICsgMTFdLCAyMiwgLTE5OTA0MDQxNjIpOwogICAgICAgICAgICBhID0gbWQ1X2ZmKGEsIGIsIGMsIGQsIHhbaSArIDEyXSwgIDcsICAxODA0NjAzNjgyKTsKICAgICAgICAgICAgZCA9IG1kNV9mZihkLCBhLCBiLCBjLCB4W2kgKyAxM10sIDEyLCAtNDAzNDExMDEpOwogICAgICAgICAgICBjID0gbWQ1X2ZmKGMsIGQsIGEsIGIsIHhbaSArIDE0XSwgMTcsIC0xNTAyMDAyMjkwKTsKICAgICAgICAgICAgYiA9IG1kNV9mZihiLCBjLCBkLCBhLCB4W2kgKyAxNV0sIDIyLCAgMTIzNjUzNTMyOSk7CgogICAgICAgICAgICBhID0gbWQ1X2dnKGEsIGIsIGMsIGQsIHhbaSArICAxXSwgIDUsIC0xNjU3OTY1MTApOwogICAgICAgICAgICBkID0gbWQ1X2dnKGQsIGEsIGIsIGMsIHhbaSArICA2XSwgIDksIC0xMDY5NTAxNjMyKTsKICAgICAgICAgICAgYyA9IG1kNV9nZyhjLCBkLCBhLCBiLCB4W2kgKyAxMV0sIDE0LCAgNjQzNzE3NzEzKTsKICAgICAgICAgICAgYiA9IG1kNV9nZyhiLCBjLCBkLCBhLCB4W2ldLCAgICAgIDIwLCAtMzczODk3MzAyKTsKICAgICAgICAgICAgYSA9IG1kNV9nZyhhLCBiLCBjLCBkLCB4W2kgKyAgNV0sICA1LCAtNzAxNTU4NjkxKTsKICAgICAgICAgICAgZCA9IG1kNV9nZyhkLCBhLCBiLCBjLCB4W2kgKyAxMF0sICA5LCAgMzgwMTYwODMpOwogICAgICAgICAgICBjID0gbWQ1X2dnKGMsIGQsIGEsIGIsIHhbaSArIDE1XSwgMTQsIC02NjA0NzgzMzUpOwogICAgICAgICAgICBiID0gbWQ1X2dnKGIsIGMsIGQsIGEsIHhbaSArICA0XSwgMjAsIC00MDU1Mzc4NDgpOwogICAgICAgICAgICBhID0gbWQ1X2dnKGEsIGIsIGMsIGQsIHhbaSArICA5XSwgIDUsICA1Njg0NDY0MzgpOwogICAgICAgICAgICBkID0gbWQ1X2dnKGQsIGEsIGIsIGMsIHhbaSArIDE0XSwgIDksIC0xMDE5ODAzNjkwKTsKICAgICAgICAgICAgYyA9IG1kNV9nZyhjLCBkLCBhLCBiLCB4W2kgKyAgM10sIDE0LCAtMTg3MzYzOTYxKTsKICAgICAgICAgICAgYiA9IG1kNV9nZyhiLCBjLCBkLCBhLCB4W2kgKyAgOF0sIDIwLCAgMTE2MzUzMTUwMSk7CiAgICAgICAgICAgIGEgPSBtZDVfZ2coYSwgYiwgYywgZCwgeFtpICsgMTNdLCAgNSwgLTE0NDQ2ODE0NjcpOwogICAgICAgICAgICBkID0gbWQ1X2dnKGQsIGEsIGIsIGMsIHhbaSArICAyXSwgIDksIC01MTQwMzc4NCk7CiAgICAgICAgICAgIGMgPSBtZDVfZ2coYywgZCwgYSwgYiwgeFtpICsgIDddLCAxNCwgIDE3MzUzMjg0NzMpOwogICAgICAgICAgICBiID0gbWQ1X2dnKGIsIGMsIGQsIGEsIHhbaSArIDEyXSwgMjAsIC0xOTI2NjA3NzM0KTsKCiAgICAgICAgICAgIGEgPSBtZDVfaGgoYSwgYiwgYywgZCwgeFtpICsgIDVdLCAgNCwgLTM3ODU1OCk7CiAgICAgICAgICAgIGQgPSBtZDVfaGgoZCwgYSwgYiwgYywgeFtpICsgIDhdLCAxMSwgLTIwMjI1NzQ0NjMpOwogICAgICAgICAgICBjID0gbWQ1X2hoKGMsIGQsIGEsIGIsIHhbaSArIDExXSwgMTYsICAxODM5MDMwNTYyKTsKICAgICAgICAgICAgYiA9IG1kNV9oaChiLCBjLCBkLCBhLCB4W2kgKyAxNF0sIDIzLCAtMzUzMDk1NTYpOwogICAgICAgICAgICBhID0gbWQ1X2hoKGEsIGIsIGMsIGQsIHhbaSArICAxXSwgIDQsIC0xNTMwOTkyMDYwKTsKICAgICAgICAgICAgZCA9IG1kNV9oaChkLCBhLCBiLCBjLCB4W2kgKyAgNF0sIDExLCAgMTI3Mjg5MzM1Myk7CiAgICAgICAgICAgIGMgPSBtZDVfaGgoYywgZCwgYSwgYiwgeFtpICsgIDddLCAxNiwgLTE1NTQ5NzYzMik7CiAgICAgICAgICAgIGIgPSBtZDVfaGgoYiwgYywgZCwgYSwgeFtpICsgMTBdLCAyMywgLTEwOTQ3MzA2NDApOwogICAgICAgICAgICBhID0gbWQ1X2hoKGEsIGIsIGMsIGQsIHhbaSArIDEzXSwgIDQsICA2ODEyNzkxNzQpOwogICAgICAgICAgICBkID0gbWQ1X2hoKGQsIGEsIGIsIGMsIHhbaV0sICAgICAgMTEsIC0zNTg1MzcyMjIpOwogICAgICAgICAgICBjID0gbWQ1X2hoKGMsIGQsIGEsIGIsIHhbaSArICAzXSwgMTYsIC03MjI1MjE5NzkpOwogICAgICAgICAgICBiID0gbWQ1X2hoKGIsIGMsIGQsIGEsIHhbaSArICA2XSwgMjMsICA3NjAyOTE4OSk7CiAgICAgICAgICAgIGEgPSBtZDVfaGgoYSwgYiwgYywgZCwgeFtpICsgIDldLCAgNCwgLTY0MDM2NDQ4Nyk7CiAgICAgICAgICAgIGQgPSBtZDVfaGgoZCwgYSwgYiwgYywgeFtpICsgMTJdLCAxMSwgLTQyMTgxNTgzNSk7CiAgICAgICAgICAgIGMgPSBtZDVfaGgoYywgZCwgYSwgYiwgeFtpICsgMTVdLCAxNiwgIDUzMDc0MjUyMCk7CiAgICAgICAgICAgIGIgPSBtZDVfaGgoYiwgYywgZCwgYSwgeFtpICsgIDJdLCAyMywgLTk5NTMzODY1MSk7CgogICAgICAgICAgICBhID0gbWQ1X2lpKGEsIGIsIGMsIGQsIHhbaV0sICAgICAgIDYsIC0xOTg2MzA4NDQpOwogICAgICAgICAgICBkID0gbWQ1X2lpKGQsIGEsIGIsIGMsIHhbaSArICA3XSwgMTAsICAxMTI2ODkxNDE1KTsKICAgICAgICAgICAgYyA9IG1kNV9paShjLCBkLCBhLCBiLCB4W2kgKyAxNF0sIDE1LCAtMTQxNjM1NDkwNSk7CiAgICAgICAgICAgIGIgPSBtZDVfaWkoYiwgYywgZCwgYSwgeFtpICsgIDVdLCAyMSwgLTU3NDM0MDU1KTsKICAgICAgICAgICAgYSA9IG1kNV9paShhLCBiLCBjLCBkLCB4W2kgKyAxMl0sICA2LCAgMTcwMDQ4NTU3MSk7CiAgICAgICAgICAgIGQgPSBtZDVfaWkoZCwgYSwgYiwgYywgeFtpICsgIDNdLCAxMCwgLTE4OTQ5ODY2MDYpOwogICAgICAgICAgICBjID0gbWQ1X2lpKGMsIGQsIGEsIGIsIHhbaSArIDEwXSwgMTUsIC0xMDUxNTIzKTsKICAgICAgICAgICAgYiA9IG1kNV9paShiLCBjLCBkLCBhLCB4W2kgKyAgMV0sIDIxLCAtMjA1NDkyMjc5OSk7CiAgICAgICAgICAgIGEgPSBtZDVfaWkoYSwgYiwgYywgZCwgeFtpICsgIDhdLCAgNiwgIDE4NzMzMTMzNTkpOwogICAgICAgICAgICBkID0gbWQ1X2lpKGQsIGEsIGIsIGMsIHhbaSArIDE1XSwgMTAsIC0zMDYxMTc0NCk7CiAgICAgICAgICAgIGMgPSBtZDVfaWkoYywgZCwgYSwgYiwgeFtpICsgIDZdLCAxNSwgLTE1NjAxOTgzODApOwogICAgICAgICAgICBiID0gbWQ1X2lpKGIsIGMsIGQsIGEsIHhbaSArIDEzXSwgMjEsICAxMzA5MTUxNjQ5KTsKICAgICAgICAgICAgYSA9IG1kNV9paShhLCBiLCBjLCBkLCB4W2kgKyAgNF0sICA2LCAtMTQ1NTIzMDcwKTsKICAgICAgICAgICAgZCA9IG1kNV9paShkLCBhLCBiLCBjLCB4W2kgKyAxMV0sIDEwLCAtMTEyMDIxMDM3OSk7CiAgICAgICAgICAgIGMgPSBtZDVfaWkoYywgZCwgYSwgYiwgeFtpICsgIDJdLCAxNSwgIDcxODc4NzI1OSk7CiAgICAgICAgICAgIGIgPSBtZDVfaWkoYiwgYywgZCwgYSwgeFtpICsgIDldLCAyMSwgLTM0MzQ4NTU1MSk7CgogICAgICAgICAgICBhID0gc2FmZV9hZGQoYSwgb2xkYSk7CiAgICAgICAgICAgIGIgPSBzYWZlX2FkZChiLCBvbGRiKTsKICAgICAgICAgICAgYyA9IHNhZmVfYWRkKGMsIG9sZGMpOwogICAgICAgICAgICBkID0gc2FmZV9hZGQoZCwgb2xkZCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBbYSwgYiwgYywgZF07CiAgICB9CgogICAgLyoKICAgICogQ29udmVydCBhbiBhcnJheSBvZiBsaXR0bGUtZW5kaWFuIHdvcmRzIHRvIGEgc3RyaW5nCiAgICAqLwogICAgZnVuY3Rpb24gYmlubDJyc3RyKGlucHV0KSB7CiAgICAgICAgdmFyIGksCiAgICAgICAgICAgIG91dHB1dCA9ICcnOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBpbnB1dC5sZW5ndGggKiAzMjsgaSArPSA4KSB7CiAgICAgICAgICAgIG91dHB1dCArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKChpbnB1dFtpID4+IDVdID4+PiAoaSAlIDMyKSkgJiAweEZGKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG91dHB1dDsKICAgIH0KCiAgICAvKgogICAgKiBDb252ZXJ0IGEgcmF3IHN0cmluZyB0byBhbiBhcnJheSBvZiBsaXR0bGUtZW5kaWFuIHdvcmRzCiAgICAqIENoYXJhY3RlcnMgPjI1NSBoYXZlIHRoZWlyIGhpZ2gtYnl0ZSBzaWxlbnRseSBpZ25vcmVkLgogICAgKi8KICAgIGZ1bmN0aW9uIHJzdHIyYmlubChpbnB1dCkgewogICAgICAgIHZhciBpLAogICAgICAgICAgICBvdXRwdXQgPSBbXTsKICAgICAgICBvdXRwdXRbKGlucHV0Lmxlbmd0aCA+PiAyKSAtIDFdID0gdW5kZWZpbmVkOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBvdXRwdXQubGVuZ3RoOyBpICs9IDEpIHsKICAgICAgICAgICAgb3V0cHV0W2ldID0gMDsKICAgICAgICB9CiAgICAgICAgZm9yIChpID0gMDsgaSA8IGlucHV0Lmxlbmd0aCAqIDg7IGkgKz0gOCkgewogICAgICAgICAgICBvdXRwdXRbaSA+PiA1XSB8PSAoaW5wdXQuY2hhckNvZGVBdChpIC8gOCkgJiAweEZGKSA8PCAoaSAlIDMyKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG91dHB1dDsKICAgIH0KCiAgICAvKgogICAgKiBDYWxjdWxhdGUgdGhlIE1ENSBvZiBhIHJhdyBzdHJpbmcKICAgICovCiAgICBmdW5jdGlvbiByc3RyX21kNShzKSB7CiAgICAgICAgcmV0dXJuIGJpbmwycnN0cihiaW5sX21kNShyc3RyMmJpbmwocyksIHMubGVuZ3RoICogOCkpOwogICAgfQoKICAgIC8qCiAgICAqIENhbGN1bGF0ZSB0aGUgSE1BQy1NRDUsIG9mIGEga2V5IGFuZCBzb21lIGRhdGEgKHJhdyBzdHJpbmdzKQogICAgKi8KICAgIGZ1bmN0aW9uIHJzdHJfaG1hY19tZDUoa2V5LCBkYXRhKSB7CiAgICAgICAgdmFyIGksCiAgICAgICAgICAgIGJrZXkgPSByc3RyMmJpbmwoa2V5KSwKICAgICAgICAgICAgaXBhZCA9IFtdLAogICAgICAgICAgICBvcGFkID0gW10sCiAgICAgICAgICAgIGhhc2g7CiAgICAgICAgaXBhZFsxNV0gPSBvcGFkWzE1XSA9IHVuZGVmaW5lZDsKICAgICAgICBpZiAoYmtleS5sZW5ndGggPiAxNikgewogICAgICAgICAgICBia2V5ID0gYmlubF9tZDUoYmtleSwga2V5Lmxlbmd0aCAqIDgpOwogICAgICAgIH0KICAgICAgICBmb3IgKGkgPSAwOyBpIDwgMTY7IGkgKz0gMSkgewogICAgICAgICAgICBpcGFkW2ldID0gYmtleVtpXSBeIDB4MzYzNjM2MzY7CiAgICAgICAgICAgIG9wYWRbaV0gPSBia2V5W2ldIF4gMHg1QzVDNUM1QzsKICAgICAgICB9CiAgICAgICAgaGFzaCA9IGJpbmxfbWQ1KGlwYWQuY29uY2F0KHJzdHIyYmlubChkYXRhKSksIDUxMiArIGRhdGEubGVuZ3RoICogOCk7CiAgICAgICAgcmV0dXJuIGJpbmwycnN0cihiaW5sX21kNShvcGFkLmNvbmNhdChoYXNoKSwgNTEyICsgMTI4KSk7CiAgICB9CgogICAgLyoKICAgICogQ29udmVydCBhIHJhdyBzdHJpbmcgdG8gYSBoZXggc3RyaW5nCiAgICAqLwogICAgZnVuY3Rpb24gcnN0cjJoZXgoaW5wdXQpIHsKICAgICAgICB2YXIgaGV4X3RhYiA9ICcwMTIzNDU2Nzg5YWJjZGVmJywKICAgICAgICAgICAgb3V0cHV0ID0gJycsCiAgICAgICAgICAgIHgsCiAgICAgICAgICAgIGk7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IGlucHV0Lmxlbmd0aDsgaSArPSAxKSB7CiAgICAgICAgICAgIHggPSBpbnB1dC5jaGFyQ29kZUF0KGkpOwogICAgICAgICAgICBvdXRwdXQgKz0gaGV4X3RhYi5jaGFyQXQoKHggPj4+IDQpICYgMHgwRikgKwogICAgICAgICAgICAgICAgaGV4X3RhYi5jaGFyQXQoeCAmIDB4MEYpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gb3V0cHV0OwogICAgfQoKICAgIC8qCiAgICAqIEVuY29kZSBhIHN0cmluZyBhcyB1dGYtOAogICAgKi8KICAgIGZ1bmN0aW9uIHN0cjJyc3RyX3V0ZjgoaW5wdXQpIHsKICAgICAgICByZXR1cm4gdW5lc2NhcGUoZW5jb2RlVVJJQ29tcG9uZW50KGlucHV0KSk7CiAgICB9CgogICAgLyoKICAgICogVGFrZSBzdHJpbmcgYXJndW1lbnRzIGFuZCByZXR1cm4gZWl0aGVyIHJhdyBvciBoZXggZW5jb2RlZCBzdHJpbmdzCiAgICAqLwogICAgZnVuY3Rpb24gcmF3X21kNShzKSB7CiAgICAgICAgcmV0dXJuIHJzdHJfbWQ1KHN0cjJyc3RyX3V0ZjgocykpOwogICAgfQogICAgZnVuY3Rpb24gaGV4X21kNShzKSB7CiAgICAgICAgcmV0dXJuIHJzdHIyaGV4KHJhd19tZDUocykpOwogICAgfQogICAgZnVuY3Rpb24gcmF3X2htYWNfbWQ1KGssIGQpIHsKICAgICAgICByZXR1cm4gcnN0cl9obWFjX21kNShzdHIycnN0cl91dGY4KGspLCBzdHIycnN0cl91dGY4KGQpKTsKICAgIH0KICAgIGZ1bmN0aW9uIGhleF9obWFjX21kNShrLCBkKSB7CiAgICAgICAgcmV0dXJuIHJzdHIyaGV4KHJhd19obWFjX21kNShrLCBkKSk7CiAgICB9CgogICAgZnVuY3Rpb24gbWQ1KHN0cmluZywga2V5LCByYXcpIHsKICAgICAgICBpZiAoIWtleSkgewogICAgICAgICAgICBpZiAoIXJhdykgewogICAgICAgICAgICAgICAgcmV0dXJuIGhleF9tZDUoc3RyaW5nKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcmF3X21kNShzdHJpbmcpOwogICAgICAgIH0KICAgICAgICBpZiAoIXJhdykgewogICAgICAgICAgICByZXR1cm4gaGV4X2htYWNfbWQ1KGtleSwgc3RyaW5nKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJhd19obWFjX21kNShrZXksIHN0cmluZyk7CiAgICB9CgogICAgaWYgKHR5cGVvZiBkZWZpbmUgPT09ICdmdW5jdGlvbicgJiYgZGVmaW5lLmFtZCkgewogICAgICAgIGRlZmluZSgnbWQ1JyxbXSxmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiBtZDU7CiAgICAgICAgfSk7CiAgICB9IGVsc2UgewogICAgICAgICQubWQ1ID0gbWQ1OwogICAgfQp9KHRoaXMpKTsKCi8qIGdsb2JhbCBwYXJzZVVyaSAqLwovKgogKiBHYWxsZXJ5TW9kZWwKICogLS0tLS0tLS0tLQogKi8KZGVmaW5lKCdnYWxsZXJ5L21vZGVscy9nYWxsZXJ5Lm1vZGVsJyxbCiAgJ3VuZGVyc2NvcmUnLAogICdiYWNrYm9uZScsCiAgJ2dhbGxlcnkvY29sbGVjdGlvbnMvaW1hZ2UuY29sbGVjdGlvbicsCiAgJ3BsdWdpbnMvcGx1Z2lucycsCiAgJ21kNScKXSwKICBmdW5jdGlvbihfLCBCYWNrYm9uZSwgSW1hZ2VDb2xsZWN0aW9uLCBub3BlLCBtZDUpIHsKCiAgdmFyIEdhbGxlcnlNb2RlbCA9IEJhY2tib25lLk1vZGVsLmV4dGVuZCh7CgogICAgLy8gbG9jYWwgb3IgcmVtb3RlCiAgICB1cmw6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gdGhpcy5nZXQoJ3NyYycpOwogICAgfSwKCiAgICAvLyBEZWZhdWx0IGF0dHJpYnV0ZXMgZm9yIHRoZSBnYWxsZXJ5LiB0aGV5IGdldCBhdXRvbWF0aWNhbGx5IHdpcmVkIGJlZm9yZSAKICAgIC8vIGluaXRpYWxpemUgY2FsbC4KICAgIGRlZmF1bHRzOiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICBzcmM6ICcnLAogICAgICAgIHRpdGxlOiAnJywKICAgICAgICBpbWFnZV9wYWdlczogZmFsc2UsCiAgICAgICAgcHJlc2V0czogewogICAgICAgICAgdGh1bWI6IHsKICAgICAgICAgICAgd2lkdGg6IDMwMAogICAgICAgICAgfSwKICAgICAgICAgIGxhcmdlOiB7CiAgICAgICAgICAgIHdpZHRoOiA4MDAKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGltYWdlczogdW5kZWZpbmVkCiAgICAgIH07CiAgICB9LAoKICAgIC8vIFRoZXNlIGFyZSB0aGUgZmFsbGJhY2sgT3B0aW9ucywgaWYgbmVpdGhlciB0aGUganNvbiwgbm9yIHRoZSBtYXJrdXAgZ2l2ZXMgCiAgICAvLyB1cyBhbnkuCiAgICBkZWZhdWx0T3B0czogewogICAgICBtaW5fY29sX3dpZHRoOiB7IC8vIGpzaGludCBpZ25vcmU6bGluZQogICAgICAgIGRlc2t0b3A6IDMyMCwKICAgICAgICBwYWQ6IDMyMCwKICAgICAgICBwaG9uZTogMzAwCiAgICAgIH0sCiAgICAgIGd1dHRlcl93aWR0aDogMywgLy8ganNoaW50IGlnbm9yZTpsaW5lCiAgICAgIGNodW5rX3NpemU6IDgsIC8vIGpzaGludCBpZ25vcmU6bGluZQogICAgICBmaXJzdF9jaHVuazogMTUsIC8vIGpzaGludCBpZ25vcmU6bGluZQogICAgICBkb3VibGVfdGFwX3RodW1iOiBmYWxzZSAvLyBqc2hpbnQgaWdub3JlOmxpbmUKICAgIH0sCiAgICAKICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLmlkID0gbWQ1KHRoaXMuZ2V0KCdzcmMnKSk7CiAgICAgIHRoaXMuc2xpZGVyU3RhdGUgPSAnY2xvc2VkJzsKICAgICAgdGhpcy5fY3VycmVudCA9IHVuZGVmaW5lZDsKICAgIH0sCiAgICAKICAgIHBhcnNlOiBmdW5jdGlvbihyZXNwb25zZSkgewogICAgICB2YXIgZ2FsbGVyeUhhc2ggPSByZXNwb25zZS5nYWxsZXJ5OwogICAgICAvLyBJbml0IENvbGxlY3Rpb24gd2l0aCByZXNwb25zZSBIYXNoCiAgICAgIGdhbGxlcnlIYXNoLmltYWdlcyA9IG5ldyBJbWFnZUNvbGxlY3Rpb24oZ2FsbGVyeUhhc2guaW1hZ2VzLCB7CiAgICAgICAgcHJlc2V0czogdGhpcy5fcGFyc2VQcmVzZXRzKGdhbGxlcnlIYXNoLnByZXNldHMpLAogICAgICAgIGdhbGxlcnk6IHsKICAgICAgICAgIGJhc2VwYXRoOiBnYWxsZXJ5SGFzaC5wb3N0QmFzZXBhdGgsCiAgICAgICAgICBiYXNldXJsOiBnYWxsZXJ5SGFzaC5wb3N0QmFzZXVybCwKICAgICAgICAgIHBhdGg6IGdhbGxlcnlIYXNoLnBvc3RQYXRoLAogICAgICAgICAgaW1hZ2VQYWdlczogZ2FsbGVyeUhhc2guaW1hZ2VQYWdlcwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIC8vIFByZWNlZGVuY2UgaW4gdGhlc2Ugb3B0aW9uczoKICAgICAgLy8gMSkgb3B0aW9ucyBnaXZlbiBhcyBhdHRyaWJ1dGVzIGludG8gdGhlIGNvbnN0cnVjdG9yICh0aGUgb25lcyB3cml0dGVuIGluIGRhdGEtYXR0cmlidXRlcykKICAgICAgLy8gMikgb3B0aW9ucyBjb21pbmcgd2l0aCB0aGUgZmV0Y2hlZCBqc29uIGRhdGEKICAgICAgLy8gMykgZGVmYXVsdCBvcHRpb25zCiAgICAgIGdhbGxlcnlIYXNoLm9wdHMgPSBfLmV4dGVuZCh7fSwgCiAgICAgICAgdGhpcy5kZWZhdWx0T3B0cywgZ2FsbGVyeUhhc2gub3B0cywgdGhpcy5hdHRyaWJ1dGVzLm9wdHMpOwoKICAgICAgcmV0dXJuIGdhbGxlcnlIYXNoOwogICAgfSwKCiAgICBfcGFyc2VQcmVzZXRzOiBmdW5jdGlvbihwcmVzZXRIYXNoKSB7CiAgICAgIF8uZm9yRWFjaChwcmVzZXRIYXNoLCBmdW5jdGlvbihwcmVzZXQsIHByZXNldEtleSkgewogICAgICAgIC8vIG5vcm1hbGl6ZSBiYXNlVXJsIChjYW4gYWxzbyBiZSBhIHBhdGggaW4gdGhlIHBhcnNlZCBqc29uKQogICAgICAgIHZhciBiYXNlVXJsID0gcHJlc2V0WydiYXNldXJsJ107CiAgICAgICAgaWYgKCFiYXNlVXJsLm1hdGNoKC9odHRwOlwvXC98aHR0cHM6XC9cLy8pKSB7CiAgICAgICAgICB2YXIgdXJpID0gcGFyc2VVcmkod2luZG93LmxvY2F0aW9uLmhyZWYpOwogICAgICAgICAgdmFyIHJvb3QgPSB1cmkucHJvdG9jb2wrICc6Ly8nICsgdXJpLmhvc3QgKyAodXJpLnBvcnQgPyAnOicgKyB1cmkucG9ydCA6ICcnKTsKICAgICAgICAgIGlmIChiYXNlVXJsLmluZGV4T2YoJy8nKSA9PT0gMCkgeyAvLyBhYnNvbHV0ZSBwYXRoCiAgICAgICAgICAgIHByZXNldFsnYmFzZXVybCddID0gcm9vdCArIGJhc2VVcmw7CiAgICAgICAgICB9IGVsc2UgeyAvLyByZWxhdGl2ZSBwYXRoCiAgICAgICAgICAgIHByZXNldFsnYmFzZXVybCddID0gcm9vdCArIHVyaS5kaXJlY3RvcnkgKyBiYXNlVXJsOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICAgIHJldHVybiBwcmVzZXRIYXNoOwogICAgfSwKICAgIAogICAgdG9nZ2xlU2xpZGVyU3RhdGU6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLnNsaWRlclN0YXRlID0gKHRoaXMuc2xpZGVyU3RhdGUgPT09ICdjbG9zZWQnID8gJ29wZW5lZCcgOiAnY2xvc2VkJyk7CiAgICB9LAoKICAgIHNldEN1cnJlbnQ6IGZ1bmN0aW9uKGltYWdlTW9kZWwpIHsKICAgICAgdGhpcy5fY3VycmVudCA9IGltYWdlTW9kZWw7CiAgICB9LAogICAgCiAgICAvLyBJbWFnZU1vZGVsIGluc3RhbmNlCiAgICBnZXRDdXJyZW50OiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHRoaXMuX2N1cnJlbnQ7CiAgICB9LAogICAgCiAgICAvLyBJbWFnZU1vZGVsIGluc3RhbmNlCiAgICBnZXROZXh0OiBmdW5jdGlvbigpIHsKICAgICAgaWYgKHRoaXMuX2N1cnJlbnQpIHsKICAgICAgICB2YXIgaW1hZ2VzID0gdGhpcy5hdHRyaWJ1dGVzLmltYWdlczsKICAgICAgICB2YXIgY3VycmVudEluZGV4ID0gdGhpcy5fY3VycmVudC5pbmRleCgpOwogICAgICAgIGlmIChjdXJyZW50SW5kZXggPCBpbWFnZXMubGVuZ3RoLTEpIHsKICAgICAgICAgIHJldHVybiBpbWFnZXMuYXQoY3VycmVudEluZGV4ICsgMSk7CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgCiAgICAvLyBJbWFnZU1vZGVsIGluc3RhbmNlCiAgICBnZXRQcmV2OiBmdW5jdGlvbigpIHsKICAgICAgaWYgKHRoaXMuX2N1cnJlbnQpIHsKICAgICAgICB2YXIgY3VycmVudEluZGV4ID0gdGhpcy5fY3VycmVudC5pbmRleCgpOwogICAgICAgIGlmIChjdXJyZW50SW5kZXggPiAwKSB7CiAgICAgICAgICByZXR1cm4gdGhpcy5hdHRyaWJ1dGVzLmltYWdlcy5hdChjdXJyZW50SW5kZXggLSAxKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9KTsKICAKICByZXR1cm4gR2FsbGVyeU1vZGVsOwogIAp9KTsKCi8qIFNlbGVjdGlvbkNvbGxlY3Rpb24KICogLS0tLS0tLS0tLS0tLS0tCiAqCiAqIEEgY29sbGVjdGlvbiBvZiBzZWxlY3RlZCBJbWFnZU1vZGVsIG9iamVjdHMuIEl0IGdldHMgc2F2ZWQgaW4gbG9jYWxTdG9yYWdlIG9mCiAqIHRoZSBjbGllbnQgYnJvd3Nlci4KICoKICovCmRlZmluZSgnZ2FsbGVyeS9jb2xsZWN0aW9ucy9zZWxlY3Rpb24uY29sbGVjdGlvbicsWwogICd1bmRlcnNjb3JlJywKICAnYmFja2JvbmUnLAogICdsb2NhbHN0b3JhZ2UnLAogICdnYWxsZXJ5L21vZGVscy9pbWFnZS5tb2RlbCcKXSwKZnVuY3Rpb24gKF8sIEJhY2tib25lLCBub3BlLCBJbWFnZU1vZGVsKSB7CiAgICAKICAgIHZhciBTZWxlY3Rpb25Db2xsZWN0aW9uID0gQmFja2JvbmUuQ29sbGVjdGlvbi5leHRlbmQoewoKICAgICAgLy8gUmVmZXJlbmNlIHRvIHRoaXMgY29sbGVjdGlvbidzIG1vZGVsLgogICAgICBtb2RlbDogSW1hZ2VNb2RlbCwKCiAgICAgIC8qKgogICAgICAgKiBMb2NhbFN0b3JhZ2UgSW1hZ2VNb2RlbCBDb2xsZWN0aW9uIGdpdmVuIGJ5IGFuIGV4cGxpY2l0IGtleSAoYGBvcHRpb25zLmtleWBgKSAKICAgICAgICogb3IsIHdoZW4gdGhlIGtleSBpcyBhIGJvb2xlYW4sIGJ5IHRoZSBpZCBvZiB0aGUgZ2l2ZW4gR2FsbGVyeU1vZGVsIAogICAgICAgKiAoYGBvcHRpb25zLmdhbGxlcnlgYCkuIAogICAgICAgKiBUaGUgQ29sbGVjdGlvbiBnZXRzIGNvbm5lY3RlZCB3aXRoIHRoZSBnaXZlbiBHYWxsZXJ5TW9kZWw6IAogICAgICAgKiBPbmNlIGl0J3MgSW1hZ2VzIGFyZSBsb2FkZWQsIHRoZSBzZWxlY3Rpb24gaXMgZmV0Y2hlZCBmcm9tIHRoZSAKICAgICAgICogbG9jYWxTdG9yYWdlIGFuZCB0aGUgR2FsbGVyeU1vZGVsIGltYWdlcyBhcmUgbWFya2VkIGBgc2VsZWN0ZWRgYCwgaWYgdGhleQogICAgICAgKiBhcmUgaW4gdGhlIFNlbGVjdGlvbi4gVGhlbiB0aGUgYGBzZWxlY3RlZGBgIGF0dHJpYnV0ZSBvZiB0aGUgR2FsbGVyeU1vZGVsCiAgICAgICAqIGltYWdlcyBhcmUgd2F0Y2hlZCwgc28gdGhhdCB0aGUgc2VsZWN0aW9uIGNvbnRhaW5zIG9ubHkgc2VsZWN0ZWQgaW1hZ2VzLgogICAgICAgKgogICAgICAgKiBJZiBgYG9wdGlvbnMuZ2FsbGVyeWBgIGlzIHVuZGVmaW5lZCwgdGhlIGNvbGxlY3Rpb24gaGFzIHRvIGJlIGZldGNoZWQKICAgICAgICogbWFudWFsbHkuCiAgICAgICAqKi8KICAgICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24gKG1vZGVscywgb3B0aW9ucykgewogICAgICAgIC8vIGNvbm5lY3QgZ2FsbGVyeSBhbmQgc2VsZWN0aW9uCiAgICAgICAgaWYgKG9wdGlvbnMuZ2FsbGVyeSkgewogICAgICAgICAgdGhpcy5nYWxsZXJ5ID0gb3B0aW9ucy5nYWxsZXJ5OwogICAgICAgICAgdGhpcy5nYWxsZXJ5LnNldCgnc2VsZWN0aW9uJywgdGhpcyk7CiAgICAgICAgfQoKICAgICAgICAvLyBBIGlkIGFuZCBrZXkgZm9yIGlkZW50aWZ5aW5nIHRoZSBTZWxlY3Rpb24KICAgICAgICB0aGlzLmtleSA9IHR5cGVvZihvcHRpb25zLmtleSkgPT09ICdib29sZWFuJyA/CiAgICAgICAgICB0aGlzLmdhbGxlcnkuaWQgOiAgLy8gaWRlbnRpZmllZCBieSB0aGUgZ2l2ZW4gR2FsbGVyeQogICAgICAgICAgb3B0aW9ucy5rZXk7IC8vIGlkZW50aWZpZWQgYnkgYSBnaXZlbiBrZXkKCiAgICAgICAgLy8gU2VsZWN0aW9uIGlzIHNhdmVkIGluIGxvY2FsU3RvcmFnZQogICAgICAgIHRoaXMubG9jYWxTdG9yYWdlID0gbmV3IEJhY2tib25lLkxvY2FsU3RvcmFnZSgnR2FsbGVyeVNlbGVjdGlvbi0nICsgdGhpcy5rZXkpOwoKICAgICAgICAvLyB3YWl0IGZvciB0aGUgSW1hZ2VDb2xsZWN0aW9uIHRvIGJlIGZldGNoZWQgCiAgICAgICAgLy8gPT4gbGlzdGVuVG8gaXQgJiBmZXRjaCBzZWxlY3Rpb24gZnJvbSBsb2NhbFN0b3JhZ2UKICAgICAgICBpZiAodGhpcy5nYWxsZXJ5KSB7CiAgICAgICAgICB0aGlzLmxpc3RlblRvT25jZSh0aGlzLmdhbGxlcnksICdjaGFuZ2UnLCB0aGlzLmluaXRHYWxsZXJ5KTsKICAgICAgICB9IAogICAgICB9LAoKICAgICAgLy8gQ2FsbGVkLCB3aGVuIHRoZSBHYWxsZXJ5TW9kZWwgaXMgaW5pdGlhbGl6ZWQvbG9hZGVkCiAgICAgIC8vIE5vdyB3ZSBjYW4gCiAgICAgIC8vIC0gZmV0Y2ggdGhpcyBzZWxlY3Rpb24gZnJvbSB0aGUgbG9jYWxTdG9yYWdlIGFuZCBtYXJrIGFsbCBpdCdzIGltYWdlcwogICAgICAvLyAgIGFzIHNlbGVjdGVkIGluIHRoZSBJbWFnZUNvbGxlY3Rpb24gb2YgdGhlIEdhbGxlcnlNb2RlbC4KICAgICAgLy8gLSBsaXN0ZW4gdG8gYW55IGNoYW5nZXMgdG8gdGhlICdzZWxlY3RlZCcgYXR0cmlidXRlIG9mIHRoZSBJbWFnZU1vZGVscwogICAgICAvLyAgIGluIHRoZSBHYWxsZXJ5LgogICAgICBpbml0R2FsbGVyeTogZnVuY3Rpb24oKSB7CiAgICAgICAgLy8gYmVmb3JlIHdlIHNldHVwIHRoZSBjaGFuZ2UtbGlzdGVuZXIsIGVsc2Ugd2UgaGF2ZSAxIHN1cGVyZmx1b3MgCiAgICAgICAgLy8gY2FsbGJhY2stcm91bmR0cmlwCiAgICAgICAgdGhpcy5mZXRjaCgpOwoKICAgICAgICB0aGlzLmxpc3RlblRvKAogICAgICAgICAgdGhpcy5nYWxsZXJ5LmdldCgnaW1hZ2VzJyksICdjaGFuZ2U6c2VsZWN0ZWQnLCB0aGlzLnNlbGVjdGlvbkNoYW5nZWQpOwogICAgICB9LAoKICAgICAgLy8gQ2FsbGVkIGJ5IFNlbGVjdGlvbkNvbGxlY3Rpb24jZmV0Y2gKICAgICAgLy8gTWFya3MgYWxsIHRoZSBmZXRjaGVkIGltYWdlcyBhcyBzZWxlY3RlZCBpbiB0aGUgSW1hZ2VDb2xsZWN0aW9uIG9mIHRoZSAKICAgICAgLy8gR2FsbGVyeU1vZGVsLgogICAgICBwYXJzZTogZnVuY3Rpb24ocmVzcG9uc2UpIHsKICAgICAgICBpZiAodGhpcy5nYWxsZXJ5KSB7CiAgICAgICAgICB2YXIgZ2FsbGVyeUltYWdlcyA9IHRoaXMuZ2FsbGVyeS5nZXQoJ2ltYWdlcycpOwogICAgICAgICAgXy5lYWNoKHJlc3BvbnNlLCBmdW5jdGlvbihzZWxlY3Rpb25Nb2RlbCkgewogICAgICAgICAgICB2YXIgaW1hZ2VNb2RlbCA9IGdhbGxlcnlJbWFnZXMuZ2V0KHNlbGVjdGlvbk1vZGVsLmRpZ2VzdCk7CiAgICAgICAgICAgIGlmIChpbWFnZU1vZGVsKSB7CiAgICAgICAgICAgICAgaW1hZ2VNb2RlbC5zZXQoJ3NlbGVjdGVkJywgdHJ1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0sIHRoaXMpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzcG9uc2U7CiAgICAgIH0sCgogICAgICBzZWxlY3Rpb25DaGFuZ2VkOiBmdW5jdGlvbihpbWFnZU1vZGVsLCBzZWxlY3RlZCkgewogICAgICAgIHZhciBzZWxlY3Rpb25Nb2RlbCA9IHRoaXMuZ2V0KGltYWdlTW9kZWwuaWQpOwogICAgICAgIGlmIChzZWxlY3RlZCAmJiAhc2VsZWN0aW9uTW9kZWwpIHsKICAgICAgICAgIHZhciBzZWxlY3RlZEltYWdlID0gaW1hZ2VNb2RlbC5jbG9uZSgpOwogICAgICAgICAgLy8gc2VsZWN0ZWQgaW1hZ2VzIGhhdmUgbm8gZml4ZWQgaW5kZXgsIHRoZXkgYXJlIHNvcnRlZCBieSB0aGVpciBpbnNlcnQtCiAgICAgICAgICAvLyBvcmRlciwgYnV0IGNhbiBiZSByZW1vdmVkIGFnYWluIGxhdGVyLCBzbyBubyBpbmRleCBpcyBzdG9yZWQKICAgICAgICAgIC8vIHNlZSBJbWFnZU1vZGVsI2luZGV4CiAgICAgICAgICBzZWxlY3RlZEltYWdlLnNldCgnaW5kZXgnLCB1bmRlZmluZWQpOwogICAgICAgICAgdGhpcy5hZGQoc2VsZWN0ZWRJbWFnZSk7CiAgICAgICAgICBzZWxlY3RlZEltYWdlLnNhdmUoKTsKICAgICAgICB9IGVsc2UgaWYgKHNlbGVjdGlvbk1vZGVsKSB7CiAgICAgICAgICBzZWxlY3Rpb25Nb2RlbC5kZXN0cm95KCk7CiAgICAgICAgfQogICAgICB9CiAgICB9LCB7CiAgICAgIC8vIHN0YXRpYyBtZW1iZXJzCgogICAgICBfcG9vbDoge30sCgogICAgICAvLyBPbmx5IG9uIGluc3RhbmNlIHBlciBrZXkgYW5kIGdhbGxlcnkKICAgICAgZ2V0OiBmdW5jdGlvbihrZXksIGdhbGxlcnkpIHsKICAgICAgICB2YXIgX2tleSA9IGtleSArICcjJyArIChnYWxsZXJ5ICE9PSB1bmRlZmluZWQgPyBnYWxsZXJ5LmlkIDogJ25peEdhbGxlcnknKTsKICAgICAgICBpZiAoIV8uaGFzKHRoaXMuX3Bvb2wsIF9rZXkpKSB7CiAgICAgICAgICB0aGlzLl9wb29sW19rZXldID0gbmV3IFNlbGVjdGlvbkNvbGxlY3Rpb24oW10sIHtrZXk6IGtleSwgZ2FsbGVyeTogZ2FsbGVyeX0pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdGhpcy5fcG9vbFtfa2V5XTsKICAgICAgfQogICAgfSk7CiAgICAKICAgIHJldHVybiBTZWxlY3Rpb25Db2xsZWN0aW9uOwogIH0KKTsKCi8qCiAqIFNlbGVjdGlvbkdhbGxlcnlNb2RlbAogKiAtLS0tLS0tLS0tCiAqLwpkZWZpbmUoJ2dhbGxlcnkvbW9kZWxzL3NlbGVjdGlvbi5nYWxsZXJ5Lm1vZGVsJyxbCiAgJ3VuZGVyc2NvcmUnLAogICdnYWxsZXJ5L21vZGVscy9nYWxsZXJ5Lm1vZGVsJywKICAnZ2FsbGVyeS9jb2xsZWN0aW9ucy9pbWFnZS5jb2xsZWN0aW9uJywKICAnZ2FsbGVyeS9jb2xsZWN0aW9ucy9zZWxlY3Rpb24uY29sbGVjdGlvbicKXSwKICBmdW5jdGlvbihfLCBHYWxsZXJ5TW9kZWwsIEltYWdlQ29sbGVjdGlvbiwgU2VsZWN0aW9uQ29sbGVjdGlvbikgewoKICB2YXIgU2VsZWN0aW9uR2FsbGVyeU1vZGVsID0gR2FsbGVyeU1vZGVsLmV4dGVuZCh7CiAgICAKICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uKCkgewogICAgICBHYWxsZXJ5TW9kZWwucHJvdG90eXBlLmluaXRpYWxpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgCiAgICAgIHRoaXMuaWQgPSB0aGlzLmdldCgna2V5Jyk7CiAgICB9LAoKICAgIC8vIE92ZXJyaWRlIGZldGNoIHRvIG9ubHkgZmV0Y2ggc2VsZWN0aW9uCiAgICBmZXRjaDogZnVuY3Rpb24ob3B0cykgewogICAgICAvLyBJcyB0aGUgc2VsZWN0aW9uIGFscmVhZHkgcmVnaXN0ZXJlZCBvbiB0aGlzIEdhbGxlcnlNb2RlbD8KICAgICAgdmFyIGdhbGxlcnlTZWxlY3Rpb24gPSB0aGlzLmdldCgnc2VsZWN0aW9uJyk7CiAgICAgIGlmIChnYWxsZXJ5U2VsZWN0aW9uICYmIGdhbGxlcnlTZWxlY3Rpb24ua2V5ID09PSB0aGlzLmlkKSB7CiAgICAgICAgdGhpcy5hdHRyaWJ1dGVzWydpbWFnZXMnXSA9IGdhbGxlcnlTZWxlY3Rpb247ICAKICAgICAgfSBlbHNlIHsgLy8gbm8sIHdlIGhhdmUgdG8gaW5pdGlhbGl6ZSBhIG5ldyBTZWxlY3Rpb25Db2xsZWN0aW9uCiAgICAgICAgbmV3IFNlbGVjdGlvbkNvbGxlY3Rpb24oW10sIHsKICAgICAgICAgIGdhbGxlcnk6IHRoaXMsCiAgICAgICAgICBrZXk6IHRoaXMuaWQKICAgICAgICB9KTsKICAgICAgfQogICAgICAKICAgICAgLy8gR2FsbGVyeSBkZWZhdWx0IG9wdGlvbnMgbWVyZ2VkIHdpdGggYXR0cmlidXRlLW9wdHMKICAgICAgdGhpcy5hdHRyaWJ1dGVzWydvcHRzJ10gPSBfLmV4dGVuZCh7fSwgdGhpcy5kZWZhdWx0T3B0cywgdGhpcy5hdHRyaWJ1dGVzLm9wdHMpOwoKICAgICAgLy8gZmV0Y2ggbG9jYWwgSW1hZ2VDb2xsZWN0aW9uIGFuZCBwcm9wYWdhdGUgZ2l2ZW4gY2FsbGJhY2tzCiAgICAgIHRoaXMuYXR0cmlidXRlc1snaW1hZ2VzJ10uZmV0Y2goewogICAgICAgIHN1Y2Nlc3M6IF8uYmluZChmdW5jdGlvbiAoY29sbGVjdGlvbiwgcmVzcCwgX29wdHMpIHsKICAgICAgICAgIGlmIChvcHRzLnN1Y2Nlc3MpIHsgb3B0cy5zdWNjZXNzKHRoaXMsIHJlc3AsIG9wdHMpOyB9CiAgICAgICAgICB0aGlzLnRyaWdnZXIoJ2NoYW5nZScpOwogICAgICAgIH0sIHRoaXMpLAogICAgICAgIGVycm9yOiBvcHRzLmVycm9yCiAgICAgIH0pOwogICAgfQoKICB9KTsKICAKICByZXR1cm4gU2VsZWN0aW9uR2FsbGVyeU1vZGVsOwogIAp9KTsKCmRlZmluZSgnZ2FsbGVyeS9tb2RlbHMvZ2FsbGVyeS5mYWN0b3J5JyxbCiAgJ3VuZGVyc2NvcmUnLAogICdnYWxsZXJ5L21vZGVscy9nYWxsZXJ5Lm1vZGVsJywKICAnZ2FsbGVyeS9tb2RlbHMvc2VsZWN0aW9uLmdhbGxlcnkubW9kZWwnCl0sIGZ1bmN0aW9uIChfLCBHYWxsZXJ5TW9kZWwsIFNlbGVjdGlvbkdhbGxlcnlNb2RlbCkgewoKICB2YXIgR2FsbGVyeUZhY3RvcnkgPSBmdW5jdGlvbigpIHsKICAgIAogICAgLyoqCiAgICAgKiBGYWN0b3J5IG1ldGhvZDogcmV0dXJucyBhbiBpbml0aWFsaXplZCBHYWxsZXJ5TW9kZWwgb2JqZWN0IG9mIHRoZSAKICAgICAqIGFwcHJvcHJpYXRlIEdhbGxlcnlNb2RlbCBjbGFzcy4KICAgICAqLwogICAgZnVuY3Rpb24gY3JlYXRlKCRlbCwgb3B0cykgewoKICAgICAgLy8gZ2V0IEdhbGxlcnkgc291cmNlCiAgICAgIHZhciBzcmMgPSBfZ2V0U291cmNlKCRlbCk7CgogICAgICAvLyBpbml0aWFsaXplIEdhbGxlcnlNb2RlbAogICAgICBpZiAoc3JjICE9PSB1bmRlZmluZWQpIHsKICAgICAgICB2YXIgbW9kZWw7CiAgICAgICAgdmFyIGdhbGxlcnlPcHRzID0gXy5leHRlbmQoe30sICRlbC5kYXRhKCdnYWwtb3B0cycpIHx8ICRlbC5kYXRhKCdvcHRzJyksIG9wdHMpOwogICAgICAgIGlmIChzcmMuaW5kZXhPZignc2VsZWN0aW9uOicpIDwgMCkgewogICAgICAgICAgbW9kZWwgPSBuZXcgR2FsbGVyeU1vZGVsKHsKICAgICAgICAgICAgc3JjOiBzcmMsCiAgICAgICAgICAgIG9wdHM6IGdhbGxlcnlPcHRzCiAgICAgICAgICB9KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgbW9kZWwgPSBuZXcgU2VsZWN0aW9uR2FsbGVyeU1vZGVsKHsKICAgICAgICAgICAga2V5OiBzcmMucmVwbGFjZSgnc2VsZWN0aW9uOicsICcnKSwKICAgICAgICAgICAgb3B0czogZ2FsbGVyeU9wdHMKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbW9kZWw7CiAgICAgIH0KCiAgICB9CgogICAgLy8gZXh0cmFjdHMgdGhlIGNvcnJlY3RzIGRhdGEgYXR0cmlidXRlIGZvciB0aGUgR2FsbGVyeSBtb2RlbCB0byBiZSAKICAgIC8vIGluc3RhbmNpYXRlZC4KICAgIGZ1bmN0aW9uIF9nZXRTb3VyY2UoJGVsKSB7CiAgICAgIHZhciBzcmMgPSAkZWwuZGF0YSgnZ2FsLXNyYycpIHx8ICRlbC5kYXRhKCdzcmMnKTsKICAgICAgaWYgKHNyYyA9PT0gdW5kZWZpbmVkKSB7IC8vIGhhbmRsZSBkZXByZWNhdGVkICdwcm9qZWN0JyBvcHRpb24KICAgICAgICBpZiAoJGVsLmRhdGEoJ3Byb2plY3QnKSkgewogICAgICAgICAgc3JjID0gJGVsLmRhdGEoJ3Byb2plY3QnKSArICcuanNvbic7CiAgICAgICAgICBjb25zb2xlLndhcm4oJyJkYXRhLXByb2plY3QiIGFzIGEgZGF0YSBzb3VyY2UgZm9yIGdhbGxlcnlqcyBpcyBkZXByZWNhdGVkISBVc2UgImRhdGEtc3JjIiBpbnN0ZWFkIScpOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gc3JjOwogICAgfQoKCiAgICAvLyBwdWJsaWMgbWV0aG9kcwogICAgcmV0dXJuIHsKICAgICAgY3JlYXRlOiBjcmVhdGUKICAgIH07CgogIH0oKTsKCiAgcmV0dXJuIEdhbGxlcnlGYWN0b3J5OwoKfSk7CgovKioKICogQnJpZGdldCBtYWtlcyBqUXVlcnkgd2lkZ2V0cwogKiB2MS4wLjEKICovCgooIGZ1bmN0aW9uKCB3aW5kb3cgKSB7CgoKCi8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tIHV0aWxzIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tIC8vCgp2YXIgc2xpY2UgPSBBcnJheS5wcm90b3R5cGUuc2xpY2U7CgpmdW5jdGlvbiBub29wKCkge30KCi8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tIGRlZmluaXRpb24gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gLy8KCmZ1bmN0aW9uIGRlZmluZUJyaWRnZXQoICQgKSB7CgovLyBiYWlsIGlmIG5vIGpRdWVyeQppZiAoICEkICkgewogIHJldHVybjsKfQoKLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gYWRkT3B0aW9uTWV0aG9kIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tIC8vCgovKioKICogYWRkcyBvcHRpb24gbWV0aG9kIC0+ICQoKS5wbHVnaW4oJ29wdGlvbicsIHsuLi59KQogKiBAcGFyYW0ge0Z1bmN0aW9ufSBQbHVnaW5DbGFzcyAtIGNvbnN0cnVjdG9yIGNsYXNzCiAqLwpmdW5jdGlvbiBhZGRPcHRpb25NZXRob2QoIFBsdWdpbkNsYXNzICkgewogIC8vIGRvbid0IG92ZXJ3cml0ZSBvcmlnaW5hbCBvcHRpb24gbWV0aG9kCiAgaWYgKCBQbHVnaW5DbGFzcy5wcm90b3R5cGUub3B0aW9uICkgewogICAgcmV0dXJuOwogIH0KCiAgLy8gb3B0aW9uIHNldHRlcgogIFBsdWdpbkNsYXNzLnByb3RvdHlwZS5vcHRpb24gPSBmdW5jdGlvbiggb3B0cyApIHsKICAgIC8vIGJhaWwgb3V0IGlmIG5vdCBhbiBvYmplY3QKICAgIGlmICggISQuaXNQbGFpbk9iamVjdCggb3B0cyApICl7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHRoaXMub3B0aW9ucyA9ICQuZXh0ZW5kKCB0cnVlLCB0aGlzLm9wdGlvbnMsIG9wdHMgKTsKICB9Owp9CgoKLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gcGx1Z2luIGJyaWRnZSAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSAvLwoKLy8gaGVscGVyIGZ1bmN0aW9uIGZvciBsb2dnaW5nIGVycm9ycwovLyAkLmVycm9yIGJyZWFrcyBqUXVlcnkgY2hhaW5pbmcKdmFyIGxvZ0Vycm9yID0gdHlwZW9mIGNvbnNvbGUgPT09ICd1bmRlZmluZWQnID8gbm9vcCA6CiAgZnVuY3Rpb24oIG1lc3NhZ2UgKSB7CiAgICBjb25zb2xlLmVycm9yKCBtZXNzYWdlICk7CiAgfTsKCi8qKgogKiBqUXVlcnkgcGx1Z2luIGJyaWRnZSwgYWNjZXNzIG1ldGhvZHMgbGlrZSAkZWxlbS5wbHVnaW4oJ21ldGhvZCcpCiAqIEBwYXJhbSB7U3RyaW5nfSBuYW1lc3BhY2UgLSBwbHVnaW4gbmFtZQogKiBAcGFyYW0ge0Z1bmN0aW9ufSBQbHVnaW5DbGFzcyAtIGNvbnN0cnVjdG9yIGNsYXNzCiAqLwpmdW5jdGlvbiBicmlkZ2UoIG5hbWVzcGFjZSwgUGx1Z2luQ2xhc3MgKSB7CiAgLy8gYWRkIHRvIGpRdWVyeSBmbiBuYW1lc3BhY2UKICAkLmZuWyBuYW1lc3BhY2UgXSA9IGZ1bmN0aW9uKCBvcHRpb25zICkgewogICAgaWYgKCB0eXBlb2Ygb3B0aW9ucyA9PT0gJ3N0cmluZycgKSB7CiAgICAgIC8vIGNhbGwgcGx1Z2luIG1ldGhvZCB3aGVuIGZpcnN0IGFyZ3VtZW50IGlzIGEgc3RyaW5nCiAgICAgIC8vIGdldCBhcmd1bWVudHMgZm9yIG1ldGhvZAogICAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoIGFyZ3VtZW50cywgMSApOwoKICAgICAgZm9yICggdmFyIGk9MCwgbGVuID0gdGhpcy5sZW5ndGg7IGkgPCBsZW47IGkrKyApIHsKICAgICAgICB2YXIgZWxlbSA9IHRoaXNbaV07CiAgICAgICAgdmFyIGluc3RhbmNlID0gJC5kYXRhKCBlbGVtLCBuYW1lc3BhY2UgKTsKICAgICAgICBpZiAoICFpbnN0YW5jZSApIHsKICAgICAgICAgIGxvZ0Vycm9yKCAiY2Fubm90IGNhbGwgbWV0aG9kcyBvbiAiICsgbmFtZXNwYWNlICsgIiBwcmlvciB0byBpbml0aWFsaXphdGlvbjsgIiArCiAgICAgICAgICAgICJhdHRlbXB0ZWQgdG8gY2FsbCAnIiArIG9wdGlvbnMgKyAiJyIgKTsKICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIH0KICAgICAgICBpZiAoICEkLmlzRnVuY3Rpb24oIGluc3RhbmNlW29wdGlvbnNdICkgfHwgb3B0aW9ucy5jaGFyQXQoMCkgPT09ICdfJyApIHsKICAgICAgICAgIGxvZ0Vycm9yKCAibm8gc3VjaCBtZXRob2QgJyIgKyBvcHRpb25zICsgIicgZm9yICIgKyBuYW1lc3BhY2UgKyAiIGluc3RhbmNlIiApOwogICAgICAgICAgY29udGludWU7CiAgICAgICAgfQoKICAgICAgICAvLyB0cmlnZ2VyIG1ldGhvZCB3aXRoIGFyZ3VtZW50cwogICAgICAgIHZhciByZXR1cm5WYWx1ZSA9IGluc3RhbmNlWyBvcHRpb25zIF0uYXBwbHkoIGluc3RhbmNlLCBhcmdzICk7CgogICAgICAgIC8vIGJyZWFrIGxvb2sgYW5kIHJldHVybiBmaXJzdCB2YWx1ZSBpZiBwcm92aWRlZAogICAgICAgIGlmICggcmV0dXJuVmFsdWUgIT09IHVuZGVmaW5lZCApIHsKICAgICAgICAgIHJldHVybiByZXR1cm5WYWx1ZTsKICAgICAgICB9CiAgICAgIH0KICAgICAgLy8gcmV0dXJuIHRoaXMgaWYgbm8gcmV0dXJuIHZhbHVlCiAgICAgIHJldHVybiB0aGlzOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIHRoaXMuZWFjaCggZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIGluc3RhbmNlID0gJC5kYXRhKCB0aGlzLCBuYW1lc3BhY2UgKTsKICAgICAgICBpZiAoIGluc3RhbmNlICkgewogICAgICAgICAgLy8gYXBwbHkgb3B0aW9ucyAmIGluaXQKICAgICAgICAgIGluc3RhbmNlLm9wdGlvbiggb3B0aW9ucyApOwogICAgICAgICAgaW5zdGFuY2UuX2luaXQoKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgLy8gaW5pdGlhbGl6ZSBuZXcgaW5zdGFuY2UKICAgICAgICAgIGluc3RhbmNlID0gbmV3IFBsdWdpbkNsYXNzKCB0aGlzLCBvcHRpb25zICk7CiAgICAgICAgICAkLmRhdGEoIHRoaXMsIG5hbWVzcGFjZSwgaW5zdGFuY2UgKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQogIH07Cgp9CgovLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSBicmlkZ2V0IC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tIC8vCgovKioKICogY29udmVydHMgYSBQcm90b3R5cGljYWwgY2xhc3MgaW50byBhIHByb3BlciBqUXVlcnkgcGx1Z2luCiAqICAgdGhlIGNsYXNzIG11c3QgaGF2ZSBhIC5faW5pdCBtZXRob2QKICogQHBhcmFtIHtTdHJpbmd9IG5hbWVzcGFjZSAtIHBsdWdpbiBuYW1lLCB1c2VkIGluICQoKS5wbHVnaW5OYW1lCiAqIEBwYXJhbSB7RnVuY3Rpb259IFBsdWdpbkNsYXNzIC0gY29uc3RydWN0b3IgY2xhc3MKICovCiQuYnJpZGdldCA9IGZ1bmN0aW9uKCBuYW1lc3BhY2UsIFBsdWdpbkNsYXNzICkgewogIGFkZE9wdGlvbk1ldGhvZCggUGx1Z2luQ2xhc3MgKTsKICBicmlkZ2UoIG5hbWVzcGFjZSwgUGx1Z2luQ2xhc3MgKTsKfTsKCnJldHVybiAkLmJyaWRnZXQ7Cgp9CgovLyB0cmFuc3BvcnQKaWYgKCB0eXBlb2YgZGVmaW5lID09PSAnZnVuY3Rpb24nICYmIGRlZmluZS5hbWQgKSB7CiAgLy8gQU1ECiAgZGVmaW5lKCAnanF1ZXJ5LWJyaWRnZXQvanF1ZXJ5LmJyaWRnZXQnLFsgJ2pxdWVyeScgXSwgZGVmaW5lQnJpZGdldCApOwp9IGVsc2UgewogIC8vIGdldCBqcXVlcnkgZnJvbSBicm93c2VyIGdsb2JhbAogIGRlZmluZUJyaWRnZXQoIHdpbmRvdy5qUXVlcnkgKTsKfQoKfSkoIHdpbmRvdyApOwoKLyohCiAqIGV2ZW50aWUgdjEuMC41CiAqIGV2ZW50IGJpbmRpbmcgaGVscGVyCiAqICAgZXZlbnRpZS5iaW5kKCBlbGVtLCAnY2xpY2snLCBteUZuICkKICogICBldmVudGllLnVuYmluZCggZWxlbSwgJ2NsaWNrJywgbXlGbiApCiAqIE1JVCBsaWNlbnNlCiAqLwoKLypqc2hpbnQgYnJvd3NlcjogdHJ1ZSwgdW5kZWY6IHRydWUsIHVudXNlZDogdHJ1ZSAqLwovKmdsb2JhbCBkZWZpbmU6IGZhbHNlLCBtb2R1bGU6IGZhbHNlICovCgooIGZ1bmN0aW9uKCB3aW5kb3cgKSB7CgoKCnZhciBkb2NFbGVtID0gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50OwoKdmFyIGJpbmQgPSBmdW5jdGlvbigpIHt9OwoKZnVuY3Rpb24gZ2V0SUVFdmVudCggb2JqICkgewogIHZhciBldmVudCA9IHdpbmRvdy5ldmVudDsKICAvLyBhZGQgZXZlbnQudGFyZ2V0CiAgZXZlbnQudGFyZ2V0ID0gZXZlbnQudGFyZ2V0IHx8IGV2ZW50LnNyY0VsZW1lbnQgfHwgb2JqOwogIHJldHVybiBldmVudDsKfQoKaWYgKCBkb2NFbGVtLmFkZEV2ZW50TGlzdGVuZXIgKSB7CiAgYmluZCA9IGZ1bmN0aW9uKCBvYmosIHR5cGUsIGZuICkgewogICAgb2JqLmFkZEV2ZW50TGlzdGVuZXIoIHR5cGUsIGZuLCBmYWxzZSApOwogIH07Cn0gZWxzZSBpZiAoIGRvY0VsZW0uYXR0YWNoRXZlbnQgKSB7CiAgYmluZCA9IGZ1bmN0aW9uKCBvYmosIHR5cGUsIGZuICkgewogICAgb2JqWyB0eXBlICsgZm4gXSA9IGZuLmhhbmRsZUV2ZW50ID8KICAgICAgZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIGV2ZW50ID0gZ2V0SUVFdmVudCggb2JqICk7CiAgICAgICAgZm4uaGFuZGxlRXZlbnQuY2FsbCggZm4sIGV2ZW50ICk7CiAgICAgIH0gOgogICAgICBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgZXZlbnQgPSBnZXRJRUV2ZW50KCBvYmogKTsKICAgICAgICBmbi5jYWxsKCBvYmosIGV2ZW50ICk7CiAgICAgIH07CiAgICBvYmouYXR0YWNoRXZlbnQoICJvbiIgKyB0eXBlLCBvYmpbIHR5cGUgKyBmbiBdICk7CiAgfTsKfQoKdmFyIHVuYmluZCA9IGZ1bmN0aW9uKCkge307CgppZiAoIGRvY0VsZW0ucmVtb3ZlRXZlbnRMaXN0ZW5lciApIHsKICB1bmJpbmQgPSBmdW5jdGlvbiggb2JqLCB0eXBlLCBmbiApIHsKICAgIG9iai5yZW1vdmVFdmVudExpc3RlbmVyKCB0eXBlLCBmbiwgZmFsc2UgKTsKICB9Owp9IGVsc2UgaWYgKCBkb2NFbGVtLmRldGFjaEV2ZW50ICkgewogIHVuYmluZCA9IGZ1bmN0aW9uKCBvYmosIHR5cGUsIGZuICkgewogICAgb2JqLmRldGFjaEV2ZW50KCAib24iICsgdHlwZSwgb2JqWyB0eXBlICsgZm4gXSApOwogICAgdHJ5IHsKICAgICAgZGVsZXRlIG9ialsgdHlwZSArIGZuIF07CiAgICB9IGNhdGNoICggZXJyICkgewogICAgICAvLyBjYW4ndCBkZWxldGUgd2luZG93IG9iamVjdCBwcm9wZXJ0aWVzCiAgICAgIG9ialsgdHlwZSArIGZuIF0gPSB1bmRlZmluZWQ7CiAgICB9CiAgfTsKfQoKdmFyIGV2ZW50aWUgPSB7CiAgYmluZDogYmluZCwKICB1bmJpbmQ6IHVuYmluZAp9OwoKLy8gLS0tLS0gbW9kdWxlIGRlZmluaXRpb24gLS0tLS0gLy8KCmlmICggdHlwZW9mIGRlZmluZSA9PT0gJ2Z1bmN0aW9uJyAmJiBkZWZpbmUuYW1kICkgewogIC8vIEFNRAogIGRlZmluZSggJ2V2ZW50aWUvZXZlbnRpZScsZXZlbnRpZSApOwp9IGVsc2UgaWYgKCB0eXBlb2YgZXhwb3J0cyA9PT0gJ29iamVjdCcgKSB7CiAgLy8gQ29tbW9uSlMKICBtb2R1bGUuZXhwb3J0cyA9IGV2ZW50aWU7Cn0gZWxzZSB7CiAgLy8gYnJvd3NlciBnbG9iYWwKICB3aW5kb3cuZXZlbnRpZSA9IGV2ZW50aWU7Cn0KCn0pKCB0aGlzICk7CgovKiEKICogZG9jUmVhZHkgdjEuMC4zCiAqIENyb3NzIGJyb3dzZXIgRE9NQ29udGVudExvYWRlZCBldmVudCBlbWl0dGVyCiAqIE1JVCBsaWNlbnNlCiAqLwoKLypqc2hpbnQgYnJvd3NlcjogdHJ1ZSwgc3RyaWN0OiB0cnVlLCB1bmRlZjogdHJ1ZSwgdW51c2VkOiB0cnVlKi8KLypnbG9iYWwgZGVmaW5lOiBmYWxzZSAqLwoKKCBmdW5jdGlvbiggd2luZG93ICkgewoKCgp2YXIgZG9jdW1lbnQgPSB3aW5kb3cuZG9jdW1lbnQ7Ci8vIGNvbGxlY3Rpb24gb2YgZnVuY3Rpb25zIHRvIGJlIHRyaWdnZXJlZCBvbiByZWFkeQp2YXIgcXVldWUgPSBbXTsKCmZ1bmN0aW9uIGRvY1JlYWR5KCBmbiApIHsKICAvLyB0aHJvdyBvdXQgbm9uLWZ1bmN0aW9ucwogIGlmICggdHlwZW9mIGZuICE9PSAnZnVuY3Rpb24nICkgewogICAgcmV0dXJuOwogIH0KCiAgaWYgKCBkb2NSZWFkeS5pc1JlYWR5ICkgewogICAgLy8gcmVhZHkgbm93LCBoaXQgaXQKICAgIGZuKCk7CiAgfSBlbHNlIHsKICAgIC8vIHF1ZXVlIGZ1bmN0aW9uIHdoZW4gcmVhZHkKICAgIHF1ZXVlLnB1c2goIGZuICk7CiAgfQp9Cgpkb2NSZWFkeS5pc1JlYWR5ID0gZmFsc2U7CgovLyB0cmlnZ2VyZWQgb24gdmFyaW91cyBkb2MgcmVhZHkgZXZlbnRzCmZ1bmN0aW9uIGluaXQoIGV2ZW50ICkgewogIC8vIGJhaWwgaWYgSUU4IGRvY3VtZW50IGlzIG5vdCByZWFkeSBqdXN0IHlldAogIHZhciBpc0lFOE5vdFJlYWR5ID0gZXZlbnQudHlwZSA9PT0gJ3JlYWR5c3RhdGVjaGFuZ2UnICYmIGRvY3VtZW50LnJlYWR5U3RhdGUgIT09ICdjb21wbGV0ZSc7CiAgaWYgKCBkb2NSZWFkeS5pc1JlYWR5IHx8IGlzSUU4Tm90UmVhZHkgKSB7CiAgICByZXR1cm47CiAgfQogIGRvY1JlYWR5LmlzUmVhZHkgPSB0cnVlOwoKICAvLyBwcm9jZXNzIHF1ZXVlCiAgZm9yICggdmFyIGk9MCwgbGVuID0gcXVldWUubGVuZ3RoOyBpIDwgbGVuOyBpKysgKSB7CiAgICB2YXIgZm4gPSBxdWV1ZVtpXTsKICAgIGZuKCk7CiAgfQp9CgpmdW5jdGlvbiBkZWZpbmVEb2NSZWFkeSggZXZlbnRpZSApIHsKICBldmVudGllLmJpbmQoIGRvY3VtZW50LCAnRE9NQ29udGVudExvYWRlZCcsIGluaXQgKTsKICBldmVudGllLmJpbmQoIGRvY3VtZW50LCAncmVhZHlzdGF0ZWNoYW5nZScsIGluaXQgKTsKICBldmVudGllLmJpbmQoIHdpbmRvdywgJ2xvYWQnLCBpbml0ICk7CgogIHJldHVybiBkb2NSZWFkeTsKfQoKLy8gdHJhbnNwb3J0CmlmICggdHlwZW9mIGRlZmluZSA9PT0gJ2Z1bmN0aW9uJyAmJiBkZWZpbmUuYW1kICkgewogIC8vIEFNRAogIC8vIGlmIFJlcXVpcmVKUywgdGhlbiBkb2MgaXMgYWxyZWFkeSByZWFkeQogIGRvY1JlYWR5LmlzUmVhZHkgPSB0eXBlb2YgcmVxdWlyZWpzID09PSAnZnVuY3Rpb24nOwogIGRlZmluZSggJ2RvYy1yZWFkeS9kb2MtcmVhZHknLFsgJ2V2ZW50aWUvZXZlbnRpZScgXSwgZGVmaW5lRG9jUmVhZHkgKTsKfSBlbHNlIGlmICggdHlwZW9mIGV4cG9ydHMgPT09ICdvYmplY3QnICkgewogIG1vZHVsZS5leHBvcnRzID0gZGVmaW5lRG9jUmVhZHkoIHJlcXVpcmUoJ2V2ZW50aWUnKSApOwp9IGVsc2UgewogIC8vIGJyb3dzZXIgZ2xvYmFsCiAgd2luZG93LmRvY1JlYWR5ID0gZGVmaW5lRG9jUmVhZHkoIHdpbmRvdy5ldmVudGllICk7Cn0KCn0pKCB3aW5kb3cgKTsKCi8qIQogKiBFdmVudEVtaXR0ZXIgdjQuMi44IC0gZ2l0LmlvL2VlCiAqIE9saXZlciBDYWxkd2VsbAogKiBNSVQgbGljZW5zZQogKiBAcHJlc2VydmUKICovCgooZnVuY3Rpb24gKCkgewoJCgoJLyoqCgkgKiBDbGFzcyBmb3IgbWFuYWdpbmcgZXZlbnRzLgoJICogQ2FuIGJlIGV4dGVuZGVkIHRvIHByb3ZpZGUgZXZlbnQgZnVuY3Rpb25hbGl0eSBpbiBvdGhlciBjbGFzc2VzLgoJICoKCSAqIEBjbGFzcyBFdmVudEVtaXR0ZXIgTWFuYWdlcyBldmVudCByZWdpc3RlcmluZyBhbmQgZW1pdHRpbmcuCgkgKi8KCWZ1bmN0aW9uIEV2ZW50RW1pdHRlcigpIHt9CgoJLy8gU2hvcnRjdXRzIHRvIGltcHJvdmUgc3BlZWQgYW5kIHNpemUKCXZhciBwcm90byA9IEV2ZW50RW1pdHRlci5wcm90b3R5cGU7Cgl2YXIgZXhwb3J0cyA9IHRoaXM7Cgl2YXIgb3JpZ2luYWxHbG9iYWxWYWx1ZSA9IGV4cG9ydHMuRXZlbnRFbWl0dGVyOwoKCS8qKgoJICogRmluZHMgdGhlIGluZGV4IG9mIHRoZSBsaXN0ZW5lciBmb3IgdGhlIGV2ZW50IGluIGl0cyBzdG9yYWdlIGFycmF5LgoJICoKCSAqIEBwYXJhbSB7RnVuY3Rpb25bXX0gbGlzdGVuZXJzIEFycmF5IG9mIGxpc3RlbmVycyB0byBzZWFyY2ggdGhyb3VnaC4KCSAqIEBwYXJhbSB7RnVuY3Rpb259IGxpc3RlbmVyIE1ldGhvZCB0byBsb29rIGZvci4KCSAqIEByZXR1cm4ge051bWJlcn0gSW5kZXggb2YgdGhlIHNwZWNpZmllZCBsaXN0ZW5lciwgLTEgaWYgbm90IGZvdW5kCgkgKiBAYXBpIHByaXZhdGUKCSAqLwoJZnVuY3Rpb24gaW5kZXhPZkxpc3RlbmVyKGxpc3RlbmVycywgbGlzdGVuZXIpIHsKCQl2YXIgaSA9IGxpc3RlbmVycy5sZW5ndGg7CgkJd2hpbGUgKGktLSkgewoJCQlpZiAobGlzdGVuZXJzW2ldLmxpc3RlbmVyID09PSBsaXN0ZW5lcikgewoJCQkJcmV0dXJuIGk7CgkJCX0KCQl9CgoJCXJldHVybiAtMTsKCX0KCgkvKioKCSAqIEFsaWFzIGEgbWV0aG9kIHdoaWxlIGtlZXBpbmcgdGhlIGNvbnRleHQgY29ycmVjdCwgdG8gYWxsb3cgZm9yIG92ZXJ3cml0aW5nIG9mIHRhcmdldCBtZXRob2QuCgkgKgoJICogQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIG5hbWUgb2YgdGhlIHRhcmdldCBtZXRob2QuCgkgKiBAcmV0dXJuIHtGdW5jdGlvbn0gVGhlIGFsaWFzZWQgbWV0aG9kCgkgKiBAYXBpIHByaXZhdGUKCSAqLwoJZnVuY3Rpb24gYWxpYXMobmFtZSkgewoJCXJldHVybiBmdW5jdGlvbiBhbGlhc0Nsb3N1cmUoKSB7CgkJCXJldHVybiB0aGlzW25hbWVdLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CgkJfTsKCX0KCgkvKioKCSAqIFJldHVybnMgdGhlIGxpc3RlbmVyIGFycmF5IGZvciB0aGUgc3BlY2lmaWVkIGV2ZW50LgoJICogV2lsbCBpbml0aWFsaXNlIHRoZSBldmVudCBvYmplY3QgYW5kIGxpc3RlbmVyIGFycmF5cyBpZiByZXF1aXJlZC4KCSAqIFdpbGwgcmV0dXJuIGFuIG9iamVjdCBpZiB5b3UgdXNlIGEgcmVnZXggc2VhcmNoLiBUaGUgb2JqZWN0IGNvbnRhaW5zIGtleXMgZm9yIGVhY2ggbWF0Y2hlZCBldmVudC4gU28gL2JhW3J6XS8gbWlnaHQgcmV0dXJuIGFuIG9iamVjdCBjb250YWluaW5nIGJhciBhbmQgYmF6LiBCdXQgb25seSBpZiB5b3UgaGF2ZSBlaXRoZXIgZGVmaW5lZCB0aGVtIHdpdGggZGVmaW5lRXZlbnQgb3IgYWRkZWQgc29tZSBsaXN0ZW5lcnMgdG8gdGhlbS4KCSAqIEVhY2ggcHJvcGVydHkgaW4gdGhlIG9iamVjdCByZXNwb25zZSBpcyBhbiBhcnJheSBvZiBsaXN0ZW5lciBmdW5jdGlvbnMuCgkgKgoJICogQHBhcmFtIHtTdHJpbmd8UmVnRXhwfSBldnQgTmFtZSBvZiB0aGUgZXZlbnQgdG8gcmV0dXJuIHRoZSBsaXN0ZW5lcnMgZnJvbS4KCSAqIEByZXR1cm4ge0Z1bmN0aW9uW118T2JqZWN0fSBBbGwgbGlzdGVuZXIgZnVuY3Rpb25zIGZvciB0aGUgZXZlbnQuCgkgKi8KCXByb3RvLmdldExpc3RlbmVycyA9IGZ1bmN0aW9uIGdldExpc3RlbmVycyhldnQpIHsKCQl2YXIgZXZlbnRzID0gdGhpcy5fZ2V0RXZlbnRzKCk7CgkJdmFyIHJlc3BvbnNlOwoJCXZhciBrZXk7CgoJCS8vIFJldHVybiBhIGNvbmNhdGVuYXRlZCBhcnJheSBvZiBhbGwgbWF0Y2hpbmcgZXZlbnRzIGlmCgkJLy8gdGhlIHNlbGVjdG9yIGlzIGEgcmVndWxhciBleHByZXNzaW9uLgoJCWlmIChldnQgaW5zdGFuY2VvZiBSZWdFeHApIHsKCQkJcmVzcG9uc2UgPSB7fTsKCQkJZm9yIChrZXkgaW4gZXZlbnRzKSB7CgkJCQlpZiAoZXZlbnRzLmhhc093blByb3BlcnR5KGtleSkgJiYgZXZ0LnRlc3Qoa2V5KSkgewoJCQkJCXJlc3BvbnNlW2tleV0gPSBldmVudHNba2V5XTsKCQkJCX0KCQkJfQoJCX0KCQllbHNlIHsKCQkJcmVzcG9uc2UgPSBldmVudHNbZXZ0XSB8fCAoZXZlbnRzW2V2dF0gPSBbXSk7CgkJfQoKCQlyZXR1cm4gcmVzcG9uc2U7Cgl9OwoKCS8qKgoJICogVGFrZXMgYSBsaXN0IG9mIGxpc3RlbmVyIG9iamVjdHMgYW5kIGZsYXR0ZW5zIGl0IGludG8gYSBsaXN0IG9mIGxpc3RlbmVyIGZ1bmN0aW9ucy4KCSAqCgkgKiBAcGFyYW0ge09iamVjdFtdfSBsaXN0ZW5lcnMgUmF3IGxpc3RlbmVyIG9iamVjdHMuCgkgKiBAcmV0dXJuIHtGdW5jdGlvbltdfSBKdXN0IHRoZSBsaXN0ZW5lciBmdW5jdGlvbnMuCgkgKi8KCXByb3RvLmZsYXR0ZW5MaXN0ZW5lcnMgPSBmdW5jdGlvbiBmbGF0dGVuTGlzdGVuZXJzKGxpc3RlbmVycykgewoJCXZhciBmbGF0TGlzdGVuZXJzID0gW107CgkJdmFyIGk7CgoJCWZvciAoaSA9IDA7IGkgPCBsaXN0ZW5lcnMubGVuZ3RoOyBpICs9IDEpIHsKCQkJZmxhdExpc3RlbmVycy5wdXNoKGxpc3RlbmVyc1tpXS5saXN0ZW5lcik7CgkJfQoKCQlyZXR1cm4gZmxhdExpc3RlbmVyczsKCX07CgoJLyoqCgkgKiBGZXRjaGVzIHRoZSByZXF1ZXN0ZWQgbGlzdGVuZXJzIHZpYSBnZXRMaXN0ZW5lcnMgYnV0IHdpbGwgYWx3YXlzIHJldHVybiB0aGUgcmVzdWx0cyBpbnNpZGUgYW4gb2JqZWN0LiBUaGlzIGlzIG1haW5seSBmb3IgaW50ZXJuYWwgdXNlIGJ1dCBvdGhlcnMgbWF5IGZpbmQgaXQgdXNlZnVsLgoJICoKCSAqIEBwYXJhbSB7U3RyaW5nfFJlZ0V4cH0gZXZ0IE5hbWUgb2YgdGhlIGV2ZW50IHRvIHJldHVybiB0aGUgbGlzdGVuZXJzIGZyb20uCgkgKiBAcmV0dXJuIHtPYmplY3R9IEFsbCBsaXN0ZW5lciBmdW5jdGlvbnMgZm9yIGFuIGV2ZW50IGluIGFuIG9iamVjdC4KCSAqLwoJcHJvdG8uZ2V0TGlzdGVuZXJzQXNPYmplY3QgPSBmdW5jdGlvbiBnZXRMaXN0ZW5lcnNBc09iamVjdChldnQpIHsKCQl2YXIgbGlzdGVuZXJzID0gdGhpcy5nZXRMaXN0ZW5lcnMoZXZ0KTsKCQl2YXIgcmVzcG9uc2U7CgoJCWlmIChsaXN0ZW5lcnMgaW5zdGFuY2VvZiBBcnJheSkgewoJCQlyZXNwb25zZSA9IHt9OwoJCQlyZXNwb25zZVtldnRdID0gbGlzdGVuZXJzOwoJCX0KCgkJcmV0dXJuIHJlc3BvbnNlIHx8IGxpc3RlbmVyczsKCX07CgoJLyoqCgkgKiBBZGRzIGEgbGlzdGVuZXIgZnVuY3Rpb24gdG8gdGhlIHNwZWNpZmllZCBldmVudC4KCSAqIFRoZSBsaXN0ZW5lciB3aWxsIG5vdCBiZSBhZGRlZCBpZiBpdCBpcyBhIGR1cGxpY2F0ZS4KCSAqIElmIHRoZSBsaXN0ZW5lciByZXR1cm5zIHRydWUgdGhlbiBpdCB3aWxsIGJlIHJlbW92ZWQgYWZ0ZXIgaXQgaXMgY2FsbGVkLgoJICogSWYgeW91IHBhc3MgYSByZWd1bGFyIGV4cHJlc3Npb24gYXMgdGhlIGV2ZW50IG5hbWUgdGhlbiB0aGUgbGlzdGVuZXIgd2lsbCBiZSBhZGRlZCB0byBhbGwgZXZlbnRzIHRoYXQgbWF0Y2ggaXQuCgkgKgoJICogQHBhcmFtIHtTdHJpbmd8UmVnRXhwfSBldnQgTmFtZSBvZiB0aGUgZXZlbnQgdG8gYXR0YWNoIHRoZSBsaXN0ZW5lciB0by4KCSAqIEBwYXJhbSB7RnVuY3Rpb259IGxpc3RlbmVyIE1ldGhvZCB0byBiZSBjYWxsZWQgd2hlbiB0aGUgZXZlbnQgaXMgZW1pdHRlZC4gSWYgdGhlIGZ1bmN0aW9uIHJldHVybnMgdHJ1ZSB0aGVuIGl0IHdpbGwgYmUgcmVtb3ZlZCBhZnRlciBjYWxsaW5nLgoJICogQHJldHVybiB7T2JqZWN0fSBDdXJyZW50IGluc3RhbmNlIG9mIEV2ZW50RW1pdHRlciBmb3IgY2hhaW5pbmcuCgkgKi8KCXByb3RvLmFkZExpc3RlbmVyID0gZnVuY3Rpb24gYWRkTGlzdGVuZXIoZXZ0LCBsaXN0ZW5lcikgewoJCXZhciBsaXN0ZW5lcnMgPSB0aGlzLmdldExpc3RlbmVyc0FzT2JqZWN0KGV2dCk7CgkJdmFyIGxpc3RlbmVySXNXcmFwcGVkID0gdHlwZW9mIGxpc3RlbmVyID09PSAnb2JqZWN0JzsKCQl2YXIga2V5OwoKCQlmb3IgKGtleSBpbiBsaXN0ZW5lcnMpIHsKCQkJaWYgKGxpc3RlbmVycy5oYXNPd25Qcm9wZXJ0eShrZXkpICYmIGluZGV4T2ZMaXN0ZW5lcihsaXN0ZW5lcnNba2V5XSwgbGlzdGVuZXIpID09PSAtMSkgewoJCQkJbGlzdGVuZXJzW2tleV0ucHVzaChsaXN0ZW5lcklzV3JhcHBlZCA/IGxpc3RlbmVyIDogewoJCQkJCWxpc3RlbmVyOiBsaXN0ZW5lciwKCQkJCQlvbmNlOiBmYWxzZQoJCQkJfSk7CgkJCX0KCQl9CgoJCXJldHVybiB0aGlzOwoJfTsKCgkvKioKCSAqIEFsaWFzIG9mIGFkZExpc3RlbmVyCgkgKi8KCXByb3RvLm9uID0gYWxpYXMoJ2FkZExpc3RlbmVyJyk7CgoJLyoqCgkgKiBTZW1pLWFsaWFzIG9mIGFkZExpc3RlbmVyLiBJdCB3aWxsIGFkZCBhIGxpc3RlbmVyIHRoYXQgd2lsbCBiZQoJICogYXV0b21hdGljYWxseSByZW1vdmVkIGFmdGVyIGl0cyBmaXJzdCBleGVjdXRpb24uCgkgKgoJICogQHBhcmFtIHtTdHJpbmd8UmVnRXhwfSBldnQgTmFtZSBvZiB0aGUgZXZlbnQgdG8gYXR0YWNoIHRoZSBsaXN0ZW5lciB0by4KCSAqIEBwYXJhbSB7RnVuY3Rpb259IGxpc3RlbmVyIE1ldGhvZCB0byBiZSBjYWxsZWQgd2hlbiB0aGUgZXZlbnQgaXMgZW1pdHRlZC4gSWYgdGhlIGZ1bmN0aW9uIHJldHVybnMgdHJ1ZSB0aGVuIGl0IHdpbGwgYmUgcmVtb3ZlZCBhZnRlciBjYWxsaW5nLgoJICogQHJldHVybiB7T2JqZWN0fSBDdXJyZW50IGluc3RhbmNlIG9mIEV2ZW50RW1pdHRlciBmb3IgY2hhaW5pbmcuCgkgKi8KCXByb3RvLmFkZE9uY2VMaXN0ZW5lciA9IGZ1bmN0aW9uIGFkZE9uY2VMaXN0ZW5lcihldnQsIGxpc3RlbmVyKSB7CgkJcmV0dXJuIHRoaXMuYWRkTGlzdGVuZXIoZXZ0LCB7CgkJCWxpc3RlbmVyOiBsaXN0ZW5lciwKCQkJb25jZTogdHJ1ZQoJCX0pOwoJfTsKCgkvKioKCSAqIEFsaWFzIG9mIGFkZE9uY2VMaXN0ZW5lci4KCSAqLwoJcHJvdG8ub25jZSA9IGFsaWFzKCdhZGRPbmNlTGlzdGVuZXInKTsKCgkvKioKCSAqIERlZmluZXMgYW4gZXZlbnQgbmFtZS4gVGhpcyBpcyByZXF1aXJlZCBpZiB5b3Ugd2FudCB0byB1c2UgYSByZWdleCB0byBhZGQgYSBsaXN0ZW5lciB0byBtdWx0aXBsZSBldmVudHMgYXQgb25jZS4gSWYgeW91IGRvbid0IGRvIHRoaXMgdGhlbiBob3cgZG8geW91IGV4cGVjdCBpdCB0byBrbm93IHdoYXQgZXZlbnQgdG8gYWRkIHRvPyBTaG91bGQgaXQganVzdCBhZGQgdG8gZXZlcnkgcG9zc2libGUgbWF0Y2ggZm9yIGEgcmVnZXg/IE5vLiBUaGF0IGlzIHNjYXJ5IGFuZCBiYWQuCgkgKiBZb3UgbmVlZCB0byB0ZWxsIGl0IHdoYXQgZXZlbnQgbmFtZXMgc2hvdWxkIGJlIG1hdGNoZWQgYnkgYSByZWdleC4KCSAqCgkgKiBAcGFyYW0ge1N0cmluZ30gZXZ0IE5hbWUgb2YgdGhlIGV2ZW50IHRvIGNyZWF0ZS4KCSAqIEByZXR1cm4ge09iamVjdH0gQ3VycmVudCBpbnN0YW5jZSBvZiBFdmVudEVtaXR0ZXIgZm9yIGNoYWluaW5nLgoJICovCglwcm90by5kZWZpbmVFdmVudCA9IGZ1bmN0aW9uIGRlZmluZUV2ZW50KGV2dCkgewoJCXRoaXMuZ2V0TGlzdGVuZXJzKGV2dCk7CgkJcmV0dXJuIHRoaXM7Cgl9OwoKCS8qKgoJICogVXNlcyBkZWZpbmVFdmVudCB0byBkZWZpbmUgbXVsdGlwbGUgZXZlbnRzLgoJICoKCSAqIEBwYXJhbSB7U3RyaW5nW119IGV2dHMgQW4gYXJyYXkgb2YgZXZlbnQgbmFtZXMgdG8gZGVmaW5lLgoJICogQHJldHVybiB7T2JqZWN0fSBDdXJyZW50IGluc3RhbmNlIG9mIEV2ZW50RW1pdHRlciBmb3IgY2hhaW5pbmcuCgkgKi8KCXByb3RvLmRlZmluZUV2ZW50cyA9IGZ1bmN0aW9uIGRlZmluZUV2ZW50cyhldnRzKSB7CgkJZm9yICh2YXIgaSA9IDA7IGkgPCBldnRzLmxlbmd0aDsgaSArPSAxKSB7CgkJCXRoaXMuZGVmaW5lRXZlbnQoZXZ0c1tpXSk7CgkJfQoJCXJldHVybiB0aGlzOwoJfTsKCgkvKioKCSAqIFJlbW92ZXMgYSBsaXN0ZW5lciBmdW5jdGlvbiBmcm9tIHRoZSBzcGVjaWZpZWQgZXZlbnQuCgkgKiBXaGVuIHBhc3NlZCBhIHJlZ3VsYXIgZXhwcmVzc2lvbiBhcyB0aGUgZXZlbnQgbmFtZSwgaXQgd2lsbCByZW1vdmUgdGhlIGxpc3RlbmVyIGZyb20gYWxsIGV2ZW50cyB0aGF0IG1hdGNoIGl0LgoJICoKCSAqIEBwYXJhbSB7U3RyaW5nfFJlZ0V4cH0gZXZ0IE5hbWUgb2YgdGhlIGV2ZW50IHRvIHJlbW92ZSB0aGUgbGlzdGVuZXIgZnJvbS4KCSAqIEBwYXJhbSB7RnVuY3Rpb259IGxpc3RlbmVyIE1ldGhvZCB0byByZW1vdmUgZnJvbSB0aGUgZXZlbnQuCgkgKiBAcmV0dXJuIHtPYmplY3R9IEN1cnJlbnQgaW5zdGFuY2Ugb2YgRXZlbnRFbWl0dGVyIGZvciBjaGFpbmluZy4KCSAqLwoJcHJvdG8ucmVtb3ZlTGlzdGVuZXIgPSBmdW5jdGlvbiByZW1vdmVMaXN0ZW5lcihldnQsIGxpc3RlbmVyKSB7CgkJdmFyIGxpc3RlbmVycyA9IHRoaXMuZ2V0TGlzdGVuZXJzQXNPYmplY3QoZXZ0KTsKCQl2YXIgaW5kZXg7CgkJdmFyIGtleTsKCgkJZm9yIChrZXkgaW4gbGlzdGVuZXJzKSB7CgkJCWlmIChsaXN0ZW5lcnMuaGFzT3duUHJvcGVydHkoa2V5KSkgewoJCQkJaW5kZXggPSBpbmRleE9mTGlzdGVuZXIobGlzdGVuZXJzW2tleV0sIGxpc3RlbmVyKTsKCgkJCQlpZiAoaW5kZXggIT09IC0xKSB7CgkJCQkJbGlzdGVuZXJzW2tleV0uc3BsaWNlKGluZGV4LCAxKTsKCQkJCX0KCQkJfQoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9OwoKCS8qKgoJICogQWxpYXMgb2YgcmVtb3ZlTGlzdGVuZXIKCSAqLwoJcHJvdG8ub2ZmID0gYWxpYXMoJ3JlbW92ZUxpc3RlbmVyJyk7CgoJLyoqCgkgKiBBZGRzIGxpc3RlbmVycyBpbiBidWxrIHVzaW5nIHRoZSBtYW5pcHVsYXRlTGlzdGVuZXJzIG1ldGhvZC4KCSAqIElmIHlvdSBwYXNzIGFuIG9iamVjdCBhcyB0aGUgc2Vjb25kIGFyZ3VtZW50IHlvdSBjYW4gYWRkIHRvIG11bHRpcGxlIGV2ZW50cyBhdCBvbmNlLiBUaGUgb2JqZWN0IHNob3VsZCBjb250YWluIGtleSB2YWx1ZSBwYWlycyBvZiBldmVudHMgYW5kIGxpc3RlbmVycyBvciBsaXN0ZW5lciBhcnJheXMuIFlvdSBjYW4gYWxzbyBwYXNzIGl0IGFuIGV2ZW50IG5hbWUgYW5kIGFuIGFycmF5IG9mIGxpc3RlbmVycyB0byBiZSBhZGRlZC4KCSAqIFlvdSBjYW4gYWxzbyBwYXNzIGl0IGEgcmVndWxhciBleHByZXNzaW9uIHRvIGFkZCB0aGUgYXJyYXkgb2YgbGlzdGVuZXJzIHRvIGFsbCBldmVudHMgdGhhdCBtYXRjaCBpdC4KCSAqIFllYWgsIHRoaXMgZnVuY3Rpb24gZG9lcyBxdWl0ZSBhIGJpdC4gVGhhdCdzIHByb2JhYmx5IGEgYmFkIHRoaW5nLgoJICoKCSAqIEBwYXJhbSB7U3RyaW5nfE9iamVjdHxSZWdFeHB9IGV2dCBBbiBldmVudCBuYW1lIGlmIHlvdSB3aWxsIHBhc3MgYW4gYXJyYXkgb2YgbGlzdGVuZXJzIG5leHQuIEFuIG9iamVjdCBpZiB5b3Ugd2lzaCB0byBhZGQgdG8gbXVsdGlwbGUgZXZlbnRzIGF0IG9uY2UuCgkgKiBAcGFyYW0ge0Z1bmN0aW9uW119IFtsaXN0ZW5lcnNdIEFuIG9wdGlvbmFsIGFycmF5IG9mIGxpc3RlbmVyIGZ1bmN0aW9ucyB0byBhZGQuCgkgKiBAcmV0dXJuIHtPYmplY3R9IEN1cnJlbnQgaW5zdGFuY2Ugb2YgRXZlbnRFbWl0dGVyIGZvciBjaGFpbmluZy4KCSAqLwoJcHJvdG8uYWRkTGlzdGVuZXJzID0gZnVuY3Rpb24gYWRkTGlzdGVuZXJzKGV2dCwgbGlzdGVuZXJzKSB7CgkJLy8gUGFzcyB0aHJvdWdoIHRvIG1hbmlwdWxhdGVMaXN0ZW5lcnMKCQlyZXR1cm4gdGhpcy5tYW5pcHVsYXRlTGlzdGVuZXJzKGZhbHNlLCBldnQsIGxpc3RlbmVycyk7Cgl9OwoKCS8qKgoJICogUmVtb3ZlcyBsaXN0ZW5lcnMgaW4gYnVsayB1c2luZyB0aGUgbWFuaXB1bGF0ZUxpc3RlbmVycyBtZXRob2QuCgkgKiBJZiB5b3UgcGFzcyBhbiBvYmplY3QgYXMgdGhlIHNlY29uZCBhcmd1bWVudCB5b3UgY2FuIHJlbW92ZSBmcm9tIG11bHRpcGxlIGV2ZW50cyBhdCBvbmNlLiBUaGUgb2JqZWN0IHNob3VsZCBjb250YWluIGtleSB2YWx1ZSBwYWlycyBvZiBldmVudHMgYW5kIGxpc3RlbmVycyBvciBsaXN0ZW5lciBhcnJheXMuCgkgKiBZb3UgY2FuIGFsc28gcGFzcyBpdCBhbiBldmVudCBuYW1lIGFuZCBhbiBhcnJheSBvZiBsaXN0ZW5lcnMgdG8gYmUgcmVtb3ZlZC4KCSAqIFlvdSBjYW4gYWxzbyBwYXNzIGl0IGEgcmVndWxhciBleHByZXNzaW9uIHRvIHJlbW92ZSB0aGUgbGlzdGVuZXJzIGZyb20gYWxsIGV2ZW50cyB0aGF0IG1hdGNoIGl0LgoJICoKCSAqIEBwYXJhbSB7U3RyaW5nfE9iamVjdHxSZWdFeHB9IGV2dCBBbiBldmVudCBuYW1lIGlmIHlvdSB3aWxsIHBhc3MgYW4gYXJyYXkgb2YgbGlzdGVuZXJzIG5leHQuIEFuIG9iamVjdCBpZiB5b3Ugd2lzaCB0byByZW1vdmUgZnJvbSBtdWx0aXBsZSBldmVudHMgYXQgb25jZS4KCSAqIEBwYXJhbSB7RnVuY3Rpb25bXX0gW2xpc3RlbmVyc10gQW4gb3B0aW9uYWwgYXJyYXkgb2YgbGlzdGVuZXIgZnVuY3Rpb25zIHRvIHJlbW92ZS4KCSAqIEByZXR1cm4ge09iamVjdH0gQ3VycmVudCBpbnN0YW5jZSBvZiBFdmVudEVtaXR0ZXIgZm9yIGNoYWluaW5nLgoJICovCglwcm90by5yZW1vdmVMaXN0ZW5lcnMgPSBmdW5jdGlvbiByZW1vdmVMaXN0ZW5lcnMoZXZ0LCBsaXN0ZW5lcnMpIHsKCQkvLyBQYXNzIHRocm91Z2ggdG8gbWFuaXB1bGF0ZUxpc3RlbmVycwoJCXJldHVybiB0aGlzLm1hbmlwdWxhdGVMaXN0ZW5lcnModHJ1ZSwgZXZ0LCBsaXN0ZW5lcnMpOwoJfTsKCgkvKioKCSAqIEVkaXRzIGxpc3RlbmVycyBpbiBidWxrLiBUaGUgYWRkTGlzdGVuZXJzIGFuZCByZW1vdmVMaXN0ZW5lcnMgbWV0aG9kcyBib3RoIHVzZSB0aGlzIHRvIGRvIHRoZWlyIGpvYi4gWW91IHNob3VsZCByZWFsbHkgdXNlIHRob3NlIGluc3RlYWQsIHRoaXMgaXMgYSBsaXR0bGUgbG93ZXIgbGV2ZWwuCgkgKiBUaGUgZmlyc3QgYXJndW1lbnQgd2lsbCBkZXRlcm1pbmUgaWYgdGhlIGxpc3RlbmVycyBhcmUgcmVtb3ZlZCAodHJ1ZSkgb3IgYWRkZWQgKGZhbHNlKS4KCSAqIElmIHlvdSBwYXNzIGFuIG9iamVjdCBhcyB0aGUgc2Vjb25kIGFyZ3VtZW50IHlvdSBjYW4gYWRkL3JlbW92ZSBmcm9tIG11bHRpcGxlIGV2ZW50cyBhdCBvbmNlLiBUaGUgb2JqZWN0IHNob3VsZCBjb250YWluIGtleSB2YWx1ZSBwYWlycyBvZiBldmVudHMgYW5kIGxpc3RlbmVycyBvciBsaXN0ZW5lciBhcnJheXMuCgkgKiBZb3UgY2FuIGFsc28gcGFzcyBpdCBhbiBldmVudCBuYW1lIGFuZCBhbiBhcnJheSBvZiBsaXN0ZW5lcnMgdG8gYmUgYWRkZWQvcmVtb3ZlZC4KCSAqIFlvdSBjYW4gYWxzbyBwYXNzIGl0IGEgcmVndWxhciBleHByZXNzaW9uIHRvIG1hbmlwdWxhdGUgdGhlIGxpc3RlbmVycyBvZiBhbGwgZXZlbnRzIHRoYXQgbWF0Y2ggaXQuCgkgKgoJICogQHBhcmFtIHtCb29sZWFufSByZW1vdmUgVHJ1ZSBpZiB5b3Ugd2FudCB0byByZW1vdmUgbGlzdGVuZXJzLCBmYWxzZSBpZiB5b3Ugd2FudCB0byBhZGQuCgkgKiBAcGFyYW0ge1N0cmluZ3xPYmplY3R8UmVnRXhwfSBldnQgQW4gZXZlbnQgbmFtZSBpZiB5b3Ugd2lsbCBwYXNzIGFuIGFycmF5IG9mIGxpc3RlbmVycyBuZXh0LiBBbiBvYmplY3QgaWYgeW91IHdpc2ggdG8gYWRkL3JlbW92ZSBmcm9tIG11bHRpcGxlIGV2ZW50cyBhdCBvbmNlLgoJICogQHBhcmFtIHtGdW5jdGlvbltdfSBbbGlzdGVuZXJzXSBBbiBvcHRpb25hbCBhcnJheSBvZiBsaXN0ZW5lciBmdW5jdGlvbnMgdG8gYWRkL3JlbW92ZS4KCSAqIEByZXR1cm4ge09iamVjdH0gQ3VycmVudCBpbnN0YW5jZSBvZiBFdmVudEVtaXR0ZXIgZm9yIGNoYWluaW5nLgoJICovCglwcm90by5tYW5pcHVsYXRlTGlzdGVuZXJzID0gZnVuY3Rpb24gbWFuaXB1bGF0ZUxpc3RlbmVycyhyZW1vdmUsIGV2dCwgbGlzdGVuZXJzKSB7CgkJdmFyIGk7CgkJdmFyIHZhbHVlOwoJCXZhciBzaW5nbGUgPSByZW1vdmUgPyB0aGlzLnJlbW92ZUxpc3RlbmVyIDogdGhpcy5hZGRMaXN0ZW5lcjsKCQl2YXIgbXVsdGlwbGUgPSByZW1vdmUgPyB0aGlzLnJlbW92ZUxpc3RlbmVycyA6IHRoaXMuYWRkTGlzdGVuZXJzOwoKCQkvLyBJZiBldnQgaXMgYW4gb2JqZWN0IHRoZW4gcGFzcyBlYWNoIG9mIGl0cyBwcm9wZXJ0aWVzIHRvIHRoaXMgbWV0aG9kCgkJaWYgKHR5cGVvZiBldnQgPT09ICdvYmplY3QnICYmICEoZXZ0IGluc3RhbmNlb2YgUmVnRXhwKSkgewoJCQlmb3IgKGkgaW4gZXZ0KSB7CgkJCQlpZiAoZXZ0Lmhhc093blByb3BlcnR5KGkpICYmICh2YWx1ZSA9IGV2dFtpXSkpIHsKCQkJCQkvLyBQYXNzIHRoZSBzaW5nbGUgbGlzdGVuZXIgc3RyYWlnaHQgdGhyb3VnaCB0byB0aGUgc2luZ3VsYXIgbWV0aG9kCgkJCQkJaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ2Z1bmN0aW9uJykgewoJCQkJCQlzaW5nbGUuY2FsbCh0aGlzLCBpLCB2YWx1ZSk7CgkJCQkJfQoJCQkJCWVsc2UgewoJCQkJCQkvLyBPdGhlcndpc2UgcGFzcyBiYWNrIHRvIHRoZSBtdWx0aXBsZSBmdW5jdGlvbgoJCQkJCQltdWx0aXBsZS5jYWxsKHRoaXMsIGksIHZhbHVlKTsKCQkJCQl9CgkJCQl9CgkJCX0KCQl9CgkJZWxzZSB7CgkJCS8vIFNvIGV2dCBtdXN0IGJlIGEgc3RyaW5nCgkJCS8vIEFuZCBsaXN0ZW5lcnMgbXVzdCBiZSBhbiBhcnJheSBvZiBsaXN0ZW5lcnMKCQkJLy8gTG9vcCBvdmVyIGl0IGFuZCBwYXNzIGVhY2ggb25lIHRvIHRoZSBtdWx0aXBsZSBtZXRob2QKCQkJaSA9IGxpc3RlbmVycy5sZW5ndGg7CgkJCXdoaWxlIChpLS0pIHsKCQkJCXNpbmdsZS5jYWxsKHRoaXMsIGV2dCwgbGlzdGVuZXJzW2ldKTsKCQkJfQoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9OwoKCS8qKgoJICogUmVtb3ZlcyBhbGwgbGlzdGVuZXJzIGZyb20gYSBzcGVjaWZpZWQgZXZlbnQuCgkgKiBJZiB5b3UgZG8gbm90IHNwZWNpZnkgYW4gZXZlbnQgdGhlbiBhbGwgbGlzdGVuZXJzIHdpbGwgYmUgcmVtb3ZlZC4KCSAqIFRoYXQgbWVhbnMgZXZlcnkgZXZlbnQgd2lsbCBiZSBlbXB0aWVkLgoJICogWW91IGNhbiBhbHNvIHBhc3MgYSByZWdleCB0byByZW1vdmUgYWxsIGV2ZW50cyB0aGF0IG1hdGNoIGl0LgoJICoKCSAqIEBwYXJhbSB7U3RyaW5nfFJlZ0V4cH0gW2V2dF0gT3B0aW9uYWwgbmFtZSBvZiB0aGUgZXZlbnQgdG8gcmVtb3ZlIGFsbCBsaXN0ZW5lcnMgZm9yLiBXaWxsIHJlbW92ZSBmcm9tIGV2ZXJ5IGV2ZW50IGlmIG5vdCBwYXNzZWQuCgkgKiBAcmV0dXJuIHtPYmplY3R9IEN1cnJlbnQgaW5zdGFuY2Ugb2YgRXZlbnRFbWl0dGVyIGZvciBjaGFpbmluZy4KCSAqLwoJcHJvdG8ucmVtb3ZlRXZlbnQgPSBmdW5jdGlvbiByZW1vdmVFdmVudChldnQpIHsKCQl2YXIgdHlwZSA9IHR5cGVvZiBldnQ7CgkJdmFyIGV2ZW50cyA9IHRoaXMuX2dldEV2ZW50cygpOwoJCXZhciBrZXk7CgoJCS8vIFJlbW92ZSBkaWZmZXJlbnQgdGhpbmdzIGRlcGVuZGluZyBvbiB0aGUgc3RhdGUgb2YgZXZ0CgkJaWYgKHR5cGUgPT09ICdzdHJpbmcnKSB7CgkJCS8vIFJlbW92ZSBhbGwgbGlzdGVuZXJzIGZvciB0aGUgc3BlY2lmaWVkIGV2ZW50CgkJCWRlbGV0ZSBldmVudHNbZXZ0XTsKCQl9CgkJZWxzZSBpZiAoZXZ0IGluc3RhbmNlb2YgUmVnRXhwKSB7CgkJCS8vIFJlbW92ZSBhbGwgZXZlbnRzIG1hdGNoaW5nIHRoZSByZWdleC4KCQkJZm9yIChrZXkgaW4gZXZlbnRzKSB7CgkJCQlpZiAoZXZlbnRzLmhhc093blByb3BlcnR5KGtleSkgJiYgZXZ0LnRlc3Qoa2V5KSkgewoJCQkJCWRlbGV0ZSBldmVudHNba2V5XTsKCQkJCX0KCQkJfQoJCX0KCQllbHNlIHsKCQkJLy8gUmVtb3ZlIGFsbCBsaXN0ZW5lcnMgaW4gYWxsIGV2ZW50cwoJCQlkZWxldGUgdGhpcy5fZXZlbnRzOwoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9OwoKCS8qKgoJICogQWxpYXMgb2YgcmVtb3ZlRXZlbnQuCgkgKgoJICogQWRkZWQgdG8gbWlycm9yIHRoZSBub2RlIEFQSS4KCSAqLwoJcHJvdG8ucmVtb3ZlQWxsTGlzdGVuZXJzID0gYWxpYXMoJ3JlbW92ZUV2ZW50Jyk7CgoJLyoqCgkgKiBFbWl0cyBhbiBldmVudCBvZiB5b3VyIGNob2ljZS4KCSAqIFdoZW4gZW1pdHRlZCwgZXZlcnkgbGlzdGVuZXIgYXR0YWNoZWQgdG8gdGhhdCBldmVudCB3aWxsIGJlIGV4ZWN1dGVkLgoJICogSWYgeW91IHBhc3MgdGhlIG9wdGlvbmFsIGFyZ3VtZW50IGFycmF5IHRoZW4gdGhvc2UgYXJndW1lbnRzIHdpbGwgYmUgcGFzc2VkIHRvIGV2ZXJ5IGxpc3RlbmVyIHVwb24gZXhlY3V0aW9uLgoJICogQmVjYXVzZSBpdCB1c2VzIGBhcHBseWAsIHlvdXIgYXJyYXkgb2YgYXJndW1lbnRzIHdpbGwgYmUgcGFzc2VkIGFzIGlmIHlvdSB3cm90ZSB0aGVtIG91dCBzZXBhcmF0ZWx5LgoJICogU28gdGhleSB3aWxsIG5vdCBhcnJpdmUgd2l0aGluIHRoZSBhcnJheSBvbiB0aGUgb3RoZXIgc2lkZSwgdGhleSB3aWxsIGJlIHNlcGFyYXRlLgoJICogWW91IGNhbiBhbHNvIHBhc3MgYSByZWd1bGFyIGV4cHJlc3Npb24gdG8gZW1pdCB0byBhbGwgZXZlbnRzIHRoYXQgbWF0Y2ggaXQuCgkgKgoJICogQHBhcmFtIHtTdHJpbmd8UmVnRXhwfSBldnQgTmFtZSBvZiB0aGUgZXZlbnQgdG8gZW1pdCBhbmQgZXhlY3V0ZSBsaXN0ZW5lcnMgZm9yLgoJICogQHBhcmFtIHtBcnJheX0gW2FyZ3NdIE9wdGlvbmFsIGFycmF5IG9mIGFyZ3VtZW50cyB0byBiZSBwYXNzZWQgdG8gZWFjaCBsaXN0ZW5lci4KCSAqIEByZXR1cm4ge09iamVjdH0gQ3VycmVudCBpbnN0YW5jZSBvZiBFdmVudEVtaXR0ZXIgZm9yIGNoYWluaW5nLgoJICovCglwcm90by5lbWl0RXZlbnQgPSBmdW5jdGlvbiBlbWl0RXZlbnQoZXZ0LCBhcmdzKSB7CgkJdmFyIGxpc3RlbmVycyA9IHRoaXMuZ2V0TGlzdGVuZXJzQXNPYmplY3QoZXZ0KTsKCQl2YXIgbGlzdGVuZXI7CgkJdmFyIGk7CgkJdmFyIGtleTsKCQl2YXIgcmVzcG9uc2U7CgoJCWZvciAoa2V5IGluIGxpc3RlbmVycykgewoJCQlpZiAobGlzdGVuZXJzLmhhc093blByb3BlcnR5KGtleSkpIHsKCQkJCWkgPSBsaXN0ZW5lcnNba2V5XS5sZW5ndGg7CgoJCQkJd2hpbGUgKGktLSkgewoJCQkJCS8vIElmIHRoZSBsaXN0ZW5lciByZXR1cm5zIHRydWUgdGhlbiBpdCBzaGFsbCBiZSByZW1vdmVkIGZyb20gdGhlIGV2ZW50CgkJCQkJLy8gVGhlIGZ1bmN0aW9uIGlzIGV4ZWN1dGVkIGVpdGhlciB3aXRoIGEgYmFzaWMgY2FsbCBvciBhbiBhcHBseSBpZiB0aGVyZSBpcyBhbiBhcmdzIGFycmF5CgkJCQkJbGlzdGVuZXIgPSBsaXN0ZW5lcnNba2V5XVtpXTsKCgkJCQkJaWYgKGxpc3RlbmVyLm9uY2UgPT09IHRydWUpIHsKCQkJCQkJdGhpcy5yZW1vdmVMaXN0ZW5lcihldnQsIGxpc3RlbmVyLmxpc3RlbmVyKTsKCQkJCQl9CgoJCQkJCXJlc3BvbnNlID0gbGlzdGVuZXIubGlzdGVuZXIuYXBwbHkodGhpcywgYXJncyB8fCBbXSk7CgoJCQkJCWlmIChyZXNwb25zZSA9PT0gdGhpcy5fZ2V0T25jZVJldHVyblZhbHVlKCkpIHsKCQkJCQkJdGhpcy5yZW1vdmVMaXN0ZW5lcihldnQsIGxpc3RlbmVyLmxpc3RlbmVyKTsKCQkJCQl9CgkJCQl9CgkJCX0KCQl9CgoJCXJldHVybiB0aGlzOwoJfTsKCgkvKioKCSAqIEFsaWFzIG9mIGVtaXRFdmVudAoJICovCglwcm90by50cmlnZ2VyID0gYWxpYXMoJ2VtaXRFdmVudCcpOwoKCS8qKgoJICogU3VidGx5IGRpZmZlcmVudCBmcm9tIGVtaXRFdmVudCBpbiB0aGF0IGl0IHdpbGwgcGFzcyBpdHMgYXJndW1lbnRzIG9uIHRvIHRoZSBsaXN0ZW5lcnMsIGFzIG9wcG9zZWQgdG8gdGFraW5nIGEgc2luZ2xlIGFycmF5IG9mIGFyZ3VtZW50cyB0byBwYXNzIG9uLgoJICogQXMgd2l0aCBlbWl0RXZlbnQsIHlvdSBjYW4gcGFzcyBhIHJlZ2V4IGluIHBsYWNlIG9mIHRoZSBldmVudCBuYW1lIHRvIGVtaXQgdG8gYWxsIGV2ZW50cyB0aGF0IG1hdGNoIGl0LgoJICoKCSAqIEBwYXJhbSB7U3RyaW5nfFJlZ0V4cH0gZXZ0IE5hbWUgb2YgdGhlIGV2ZW50IHRvIGVtaXQgYW5kIGV4ZWN1dGUgbGlzdGVuZXJzIGZvci4KCSAqIEBwYXJhbSB7Li4uKn0gT3B0aW9uYWwgYWRkaXRpb25hbCBhcmd1bWVudHMgdG8gYmUgcGFzc2VkIHRvIGVhY2ggbGlzdGVuZXIuCgkgKiBAcmV0dXJuIHtPYmplY3R9IEN1cnJlbnQgaW5zdGFuY2Ugb2YgRXZlbnRFbWl0dGVyIGZvciBjaGFpbmluZy4KCSAqLwoJcHJvdG8uZW1pdCA9IGZ1bmN0aW9uIGVtaXQoZXZ0KSB7CgkJdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwoJCXJldHVybiB0aGlzLmVtaXRFdmVudChldnQsIGFyZ3MpOwoJfTsKCgkvKioKCSAqIFNldHMgdGhlIGN1cnJlbnQgdmFsdWUgdG8gY2hlY2sgYWdhaW5zdCB3aGVuIGV4ZWN1dGluZyBsaXN0ZW5lcnMuIElmIGEKCSAqIGxpc3RlbmVycyByZXR1cm4gdmFsdWUgbWF0Y2hlcyB0aGUgb25lIHNldCBoZXJlIHRoZW4gaXQgd2lsbCBiZSByZW1vdmVkCgkgKiBhZnRlciBleGVjdXRpb24uIFRoaXMgdmFsdWUgZGVmYXVsdHMgdG8gdHJ1ZS4KCSAqCgkgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSBuZXcgdmFsdWUgdG8gY2hlY2sgZm9yIHdoZW4gZXhlY3V0aW5nIGxpc3RlbmVycy4KCSAqIEByZXR1cm4ge09iamVjdH0gQ3VycmVudCBpbnN0YW5jZSBvZiBFdmVudEVtaXR0ZXIgZm9yIGNoYWluaW5nLgoJICovCglwcm90by5zZXRPbmNlUmV0dXJuVmFsdWUgPSBmdW5jdGlvbiBzZXRPbmNlUmV0dXJuVmFsdWUodmFsdWUpIHsKCQl0aGlzLl9vbmNlUmV0dXJuVmFsdWUgPSB2YWx1ZTsKCQlyZXR1cm4gdGhpczsKCX07CgoJLyoqCgkgKiBGZXRjaGVzIHRoZSBjdXJyZW50IHZhbHVlIHRvIGNoZWNrIGFnYWluc3Qgd2hlbiBleGVjdXRpbmcgbGlzdGVuZXJzLiBJZgoJICogdGhlIGxpc3RlbmVycyByZXR1cm4gdmFsdWUgbWF0Y2hlcyB0aGlzIG9uZSB0aGVuIGl0IHNob3VsZCBiZSByZW1vdmVkCgkgKiBhdXRvbWF0aWNhbGx5LiBJdCB3aWxsIHJldHVybiB0cnVlIGJ5IGRlZmF1bHQuCgkgKgoJICogQHJldHVybiB7KnxCb29sZWFufSBUaGUgY3VycmVudCB2YWx1ZSB0byBjaGVjayBmb3Igb3IgdGhlIGRlZmF1bHQsIHRydWUuCgkgKiBAYXBpIHByaXZhdGUKCSAqLwoJcHJvdG8uX2dldE9uY2VSZXR1cm5WYWx1ZSA9IGZ1bmN0aW9uIF9nZXRPbmNlUmV0dXJuVmFsdWUoKSB7CgkJaWYgKHRoaXMuaGFzT3duUHJvcGVydHkoJ19vbmNlUmV0dXJuVmFsdWUnKSkgewoJCQlyZXR1cm4gdGhpcy5fb25jZVJldHVyblZhbHVlOwoJCX0KCQllbHNlIHsKCQkJcmV0dXJuIHRydWU7CgkJfQoJfTsKCgkvKioKCSAqIEZldGNoZXMgdGhlIGV2ZW50cyBvYmplY3QgYW5kIGNyZWF0ZXMgb25lIGlmIHJlcXVpcmVkLgoJICoKCSAqIEByZXR1cm4ge09iamVjdH0gVGhlIGV2ZW50cyBzdG9yYWdlIG9iamVjdC4KCSAqIEBhcGkgcHJpdmF0ZQoJICovCglwcm90by5fZ2V0RXZlbnRzID0gZnVuY3Rpb24gX2dldEV2ZW50cygpIHsKCQlyZXR1cm4gdGhpcy5fZXZlbnRzIHx8ICh0aGlzLl9ldmVudHMgPSB7fSk7Cgl9OwoKCS8qKgoJICogUmV2ZXJ0cyB0aGUgZ2xvYmFsIHtAbGluayBFdmVudEVtaXR0ZXJ9IHRvIGl0cyBwcmV2aW91cyB2YWx1ZSBhbmQgcmV0dXJucyBhIHJlZmVyZW5jZSB0byB0aGlzIHZlcnNpb24uCgkgKgoJICogQHJldHVybiB7RnVuY3Rpb259IE5vbiBjb25mbGljdGluZyBFdmVudEVtaXR0ZXIgY2xhc3MuCgkgKi8KCUV2ZW50RW1pdHRlci5ub0NvbmZsaWN0ID0gZnVuY3Rpb24gbm9Db25mbGljdCgpIHsKCQlleHBvcnRzLkV2ZW50RW1pdHRlciA9IG9yaWdpbmFsR2xvYmFsVmFsdWU7CgkJcmV0dXJuIEV2ZW50RW1pdHRlcjsKCX07CgoJLy8gRXhwb3NlIHRoZSBjbGFzcyBlaXRoZXIgdmlhIEFNRCwgQ29tbW9uSlMgb3IgdGhlIGdsb2JhbCBvYmplY3QKCWlmICh0eXBlb2YgZGVmaW5lID09PSAnZnVuY3Rpb24nICYmIGRlZmluZS5hbWQpIHsKCQlkZWZpbmUoJ2V2ZW50RW1pdHRlci9FdmVudEVtaXR0ZXInLFtdLGZ1bmN0aW9uICgpIHsKCQkJcmV0dXJuIEV2ZW50RW1pdHRlcjsKCQl9KTsKCX0KCWVsc2UgaWYgKHR5cGVvZiBtb2R1bGUgPT09ICdvYmplY3QnICYmIG1vZHVsZS5leHBvcnRzKXsKCQltb2R1bGUuZXhwb3J0cyA9IEV2ZW50RW1pdHRlcjsKCX0KCWVsc2UgewoJCXRoaXMuRXZlbnRFbWl0dGVyID0gRXZlbnRFbWl0dGVyOwoJfQp9LmNhbGwodGhpcykpOwoKLyohCiAqIGdldFN0eWxlUHJvcGVydHkgdjEuMC4zCiAqIG9yaWdpbmFsIGJ5IGthbmdheAogKiBodHRwOi8vcGVyZmVjdGlvbmtpbGxzLmNvbS9mZWF0dXJlLXRlc3RpbmctY3NzLXByb3BlcnRpZXMvCiAqLwoKLypqc2hpbnQgYnJvd3NlcjogdHJ1ZSwgc3RyaWN0OiB0cnVlLCB1bmRlZjogdHJ1ZSAqLwovKmdsb2JhbCBkZWZpbmU6IGZhbHNlLCBleHBvcnRzOiBmYWxzZSwgbW9kdWxlOiBmYWxzZSAqLwoKKCBmdW5jdGlvbiggd2luZG93ICkgewoKCgp2YXIgcHJlZml4ZXMgPSAnV2Via2l0IE1veiBtcyBNcyBPJy5zcGxpdCgnICcpOwp2YXIgZG9jRWxlbVN0eWxlID0gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LnN0eWxlOwoKZnVuY3Rpb24gZ2V0U3R5bGVQcm9wZXJ0eSggcHJvcE5hbWUgKSB7CiAgaWYgKCAhcHJvcE5hbWUgKSB7CiAgICByZXR1cm47CiAgfQoKICAvLyB0ZXN0IHN0YW5kYXJkIHByb3BlcnR5IGZpcnN0CiAgaWYgKCB0eXBlb2YgZG9jRWxlbVN0eWxlWyBwcm9wTmFtZSBdID09PSAnc3RyaW5nJyApIHsKICAgIHJldHVybiBwcm9wTmFtZTsKICB9CgogIC8vIGNhcGl0YWxpemUKICBwcm9wTmFtZSA9IHByb3BOYW1lLmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpICsgcHJvcE5hbWUuc2xpY2UoMSk7CgogIC8vIHRlc3QgdmVuZG9yIHNwZWNpZmljIHByb3BlcnRpZXMKICB2YXIgcHJlZml4ZWQ7CiAgZm9yICggdmFyIGk9MCwgbGVuID0gcHJlZml4ZXMubGVuZ3RoOyBpIDwgbGVuOyBpKysgKSB7CiAgICBwcmVmaXhlZCA9IHByZWZpeGVzW2ldICsgcHJvcE5hbWU7CiAgICBpZiAoIHR5cGVvZiBkb2NFbGVtU3R5bGVbIHByZWZpeGVkIF0gPT09ICdzdHJpbmcnICkgewogICAgICByZXR1cm4gcHJlZml4ZWQ7CiAgICB9CiAgfQp9CgovLyB0cmFuc3BvcnQKaWYgKCB0eXBlb2YgZGVmaW5lID09PSAnZnVuY3Rpb24nICYmIGRlZmluZS5hbWQgKSB7CiAgLy8gQU1ECiAgZGVmaW5lKCAnZ2V0LXN0eWxlLXByb3BlcnR5L2dldC1zdHlsZS1wcm9wZXJ0eScsW10sZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gZ2V0U3R5bGVQcm9wZXJ0eTsKICB9KTsKfSBlbHNlIGlmICggdHlwZW9mIGV4cG9ydHMgPT09ICdvYmplY3QnICkgewogIC8vIENvbW1vbkpTIGZvciBDb21wb25lbnQKICBtb2R1bGUuZXhwb3J0cyA9IGdldFN0eWxlUHJvcGVydHk7Cn0gZWxzZSB7CiAgLy8gYnJvd3NlciBnbG9iYWwKICB3aW5kb3cuZ2V0U3R5bGVQcm9wZXJ0eSA9IGdldFN0eWxlUHJvcGVydHk7Cn0KCn0pKCB3aW5kb3cgKTsKCi8qKgogKiBnZXRTaXplIHYxLjEuNwogKiBtZWFzdXJlIHNpemUgb2YgZWxlbWVudHMKICovCgovKmpzaGludCBicm93c2VyOiB0cnVlLCBzdHJpY3Q6IHRydWUsIHVuZGVmOiB0cnVlLCB1bnVzZWQ6IHRydWUgKi8KLypnbG9iYWwgZGVmaW5lOiBmYWxzZSwgZXhwb3J0czogZmFsc2UsIHJlcXVpcmU6IGZhbHNlLCBtb2R1bGU6IGZhbHNlICovCgooIGZ1bmN0aW9uKCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCgoKLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gaGVscGVycyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSAvLwoKdmFyIGdldENvbXB1dGVkU3R5bGUgPSB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZTsKdmFyIGdldFN0eWxlID0gZ2V0Q29tcHV0ZWRTdHlsZSA/CiAgZnVuY3Rpb24oIGVsZW0gKSB7CiAgICByZXR1cm4gZ2V0Q29tcHV0ZWRTdHlsZSggZWxlbSwgbnVsbCApOwogIH0gOgogIGZ1bmN0aW9uKCBlbGVtICkgewogICAgcmV0dXJuIGVsZW0uY3VycmVudFN0eWxlOwogIH07CgovLyBnZXQgYSBudW1iZXIgZnJvbSBhIHN0cmluZywgbm90IGEgcGVyY2VudGFnZQpmdW5jdGlvbiBnZXRTdHlsZVNpemUoIHZhbHVlICkgewogIHZhciBudW0gPSBwYXJzZUZsb2F0KCB2YWx1ZSApOwogIC8vIG5vdCBhIHBlcmNlbnQgbGlrZSAnMTAwJScsIGFuZCBhIG51bWJlcgogIHZhciBpc1ZhbGlkID0gdmFsdWUuaW5kZXhPZignJScpID09PSAtMSAmJiAhaXNOYU4oIG51bSApOwogIHJldHVybiBpc1ZhbGlkICYmIG51bTsKfQoKLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gbWVhc3VyZW1lbnRzIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tIC8vCgp2YXIgbWVhc3VyZW1lbnRzID0gWwogICdwYWRkaW5nTGVmdCcsCiAgJ3BhZGRpbmdSaWdodCcsCiAgJ3BhZGRpbmdUb3AnLAogICdwYWRkaW5nQm90dG9tJywKICAnbWFyZ2luTGVmdCcsCiAgJ21hcmdpblJpZ2h0JywKICAnbWFyZ2luVG9wJywKICAnbWFyZ2luQm90dG9tJywKICAnYm9yZGVyTGVmdFdpZHRoJywKICAnYm9yZGVyUmlnaHRXaWR0aCcsCiAgJ2JvcmRlclRvcFdpZHRoJywKICAnYm9yZGVyQm90dG9tV2lkdGgnCl07CgpmdW5jdGlvbiBnZXRaZXJvU2l6ZSgpIHsKICB2YXIgc2l6ZSA9IHsKICAgIHdpZHRoOiAwLAogICAgaGVpZ2h0OiAwLAogICAgaW5uZXJXaWR0aDogMCwKICAgIGlubmVySGVpZ2h0OiAwLAogICAgb3V0ZXJXaWR0aDogMCwKICAgIG91dGVySGVpZ2h0OiAwCiAgfTsKICBmb3IgKCB2YXIgaT0wLCBsZW4gPSBtZWFzdXJlbWVudHMubGVuZ3RoOyBpIDwgbGVuOyBpKysgKSB7CiAgICB2YXIgbWVhc3VyZW1lbnQgPSBtZWFzdXJlbWVudHNbaV07CiAgICBzaXplWyBtZWFzdXJlbWVudCBdID0gMDsKICB9CiAgcmV0dXJuIHNpemU7Cn0KCgoKZnVuY3Rpb24gZGVmaW5lR2V0U2l6ZSggZ2V0U3R5bGVQcm9wZXJ0eSApIHsKCi8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tIGJveCBzaXppbmcgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gLy8KCnZhciBib3hTaXppbmdQcm9wID0gZ2V0U3R5bGVQcm9wZXJ0eSgnYm94U2l6aW5nJyk7CnZhciBpc0JveFNpemVPdXRlcjsKCi8qKgogKiBXZWJLaXQgbWVhc3VyZXMgdGhlIG91dGVyLXdpZHRoIG9uIHN0eWxlLndpZHRoIG9uIGJvcmRlci1ib3ggZWxlbXMKICogSUUgJiBGaXJlZm94IG1lYXN1cmVzIHRoZSBpbm5lci13aWR0aAogKi8KKCBmdW5jdGlvbigpIHsKICBpZiAoICFib3hTaXppbmdQcm9wICkgewogICAgcmV0dXJuOwogIH0KCiAgdmFyIGRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogIGRpdi5zdHlsZS53aWR0aCA9ICcyMDBweCc7CiAgZGl2LnN0eWxlLnBhZGRpbmcgPSAnMXB4IDJweCAzcHggNHB4JzsKICBkaXYuc3R5bGUuYm9yZGVyU3R5bGUgPSAnc29saWQnOwogIGRpdi5zdHlsZS5ib3JkZXJXaWR0aCA9ICcxcHggMnB4IDNweCA0cHgnOwogIGRpdi5zdHlsZVsgYm94U2l6aW5nUHJvcCBdID0gJ2JvcmRlci1ib3gnOwoKICB2YXIgYm9keSA9IGRvY3VtZW50LmJvZHkgfHwgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50OwogIGJvZHkuYXBwZW5kQ2hpbGQoIGRpdiApOwogIHZhciBzdHlsZSA9IGdldFN0eWxlKCBkaXYgKTsKCiAgaXNCb3hTaXplT3V0ZXIgPSBnZXRTdHlsZVNpemUoIHN0eWxlLndpZHRoICkgPT09IDIwMDsKICBib2R5LnJlbW92ZUNoaWxkKCBkaXYgKTsKfSkoKTsKCgovLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSBnZXRTaXplIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tIC8vCgpmdW5jdGlvbiBnZXRTaXplKCBlbGVtICkgewogIC8vIHVzZSBxdWVyeVNlbGV0b3IgaWYgZWxlbSBpcyBzdHJpbmcKICBpZiAoIHR5cGVvZiBlbGVtID09PSAnc3RyaW5nJyApIHsKICAgIGVsZW0gPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCBlbGVtICk7CiAgfQoKICAvLyBkbyBub3QgcHJvY2VlZCBvbiBub24tb2JqZWN0cwogIGlmICggIWVsZW0gfHwgdHlwZW9mIGVsZW0gIT09ICdvYmplY3QnIHx8ICFlbGVtLm5vZGVUeXBlICkgewogICAgcmV0dXJuOwogIH0KCiAgdmFyIHN0eWxlID0gZ2V0U3R5bGUoIGVsZW0gKTsKCiAgLy8gaWYgaGlkZGVuLCBldmVyeXRoaW5nIGlzIDAKICBpZiAoIHN0eWxlLmRpc3BsYXkgPT09ICdub25lJyApIHsKICAgIHJldHVybiBnZXRaZXJvU2l6ZSgpOwogIH0KCiAgdmFyIHNpemUgPSB7fTsKICBzaXplLndpZHRoID0gZWxlbS5vZmZzZXRXaWR0aDsKICBzaXplLmhlaWdodCA9IGVsZW0ub2Zmc2V0SGVpZ2h0OwoKICB2YXIgaXNCb3JkZXJCb3ggPSBzaXplLmlzQm9yZGVyQm94ID0gISEoIGJveFNpemluZ1Byb3AgJiYKICAgIHN0eWxlWyBib3hTaXppbmdQcm9wIF0gJiYgc3R5bGVbIGJveFNpemluZ1Byb3AgXSA9PT0gJ2JvcmRlci1ib3gnICk7CgogIC8vIGdldCBhbGwgbWVhc3VyZW1lbnRzCiAgZm9yICggdmFyIGk9MCwgbGVuID0gbWVhc3VyZW1lbnRzLmxlbmd0aDsgaSA8IGxlbjsgaSsrICkgewogICAgdmFyIG1lYXN1cmVtZW50ID0gbWVhc3VyZW1lbnRzW2ldOwogICAgdmFyIHZhbHVlID0gc3R5bGVbIG1lYXN1cmVtZW50IF07CiAgICB2YWx1ZSA9IG11bmdlTm9uUGl4ZWwoIGVsZW0sIHZhbHVlICk7CiAgICB2YXIgbnVtID0gcGFyc2VGbG9hdCggdmFsdWUgKTsKICAgIC8vIGFueSAnYXV0bycsICdtZWRpdW0nIHZhbHVlIHdpbGwgYmUgMAogICAgc2l6ZVsgbWVhc3VyZW1lbnQgXSA9ICFpc05hTiggbnVtICkgPyBudW0gOiAwOwogIH0KCiAgdmFyIHBhZGRpbmdXaWR0aCA9IHNpemUucGFkZGluZ0xlZnQgKyBzaXplLnBhZGRpbmdSaWdodDsKICB2YXIgcGFkZGluZ0hlaWdodCA9IHNpemUucGFkZGluZ1RvcCArIHNpemUucGFkZGluZ0JvdHRvbTsKICB2YXIgbWFyZ2luV2lkdGggPSBzaXplLm1hcmdpbkxlZnQgKyBzaXplLm1hcmdpblJpZ2h0OwogIHZhciBtYXJnaW5IZWlnaHQgPSBzaXplLm1hcmdpblRvcCArIHNpemUubWFyZ2luQm90dG9tOwogIHZhciBib3JkZXJXaWR0aCA9IHNpemUuYm9yZGVyTGVmdFdpZHRoICsgc2l6ZS5ib3JkZXJSaWdodFdpZHRoOwogIHZhciBib3JkZXJIZWlnaHQgPSBzaXplLmJvcmRlclRvcFdpZHRoICsgc2l6ZS5ib3JkZXJCb3R0b21XaWR0aDsKCiAgdmFyIGlzQm9yZGVyQm94U2l6ZU91dGVyID0gaXNCb3JkZXJCb3ggJiYgaXNCb3hTaXplT3V0ZXI7CgogIC8vIG92ZXJ3cml0ZSB3aWR0aCBhbmQgaGVpZ2h0IGlmIHdlIGNhbiBnZXQgaXQgZnJvbSBzdHlsZQogIHZhciBzdHlsZVdpZHRoID0gZ2V0U3R5bGVTaXplKCBzdHlsZS53aWR0aCApOwogIGlmICggc3R5bGVXaWR0aCAhPT0gZmFsc2UgKSB7CiAgICBzaXplLndpZHRoID0gc3R5bGVXaWR0aCArCiAgICAgIC8vIGFkZCBwYWRkaW5nIGFuZCBib3JkZXIgdW5sZXNzIGl0J3MgYWxyZWFkeSBpbmNsdWRpbmcgaXQKICAgICAgKCBpc0JvcmRlckJveFNpemVPdXRlciA/IDAgOiBwYWRkaW5nV2lkdGggKyBib3JkZXJXaWR0aCApOwogIH0KCiAgdmFyIHN0eWxlSGVpZ2h0ID0gZ2V0U3R5bGVTaXplKCBzdHlsZS5oZWlnaHQgKTsKICBpZiAoIHN0eWxlSGVpZ2h0ICE9PSBmYWxzZSApIHsKICAgIHNpemUuaGVpZ2h0ID0gc3R5bGVIZWlnaHQgKwogICAgICAvLyBhZGQgcGFkZGluZyBhbmQgYm9yZGVyIHVubGVzcyBpdCdzIGFscmVhZHkgaW5jbHVkaW5nIGl0CiAgICAgICggaXNCb3JkZXJCb3hTaXplT3V0ZXIgPyAwIDogcGFkZGluZ0hlaWdodCArIGJvcmRlckhlaWdodCApOwogIH0KCiAgc2l6ZS5pbm5lcldpZHRoID0gc2l6ZS53aWR0aCAtICggcGFkZGluZ1dpZHRoICsgYm9yZGVyV2lkdGggKTsKICBzaXplLmlubmVySGVpZ2h0ID0gc2l6ZS5oZWlnaHQgLSAoIHBhZGRpbmdIZWlnaHQgKyBib3JkZXJIZWlnaHQgKTsKCiAgc2l6ZS5vdXRlcldpZHRoID0gc2l6ZS53aWR0aCArIG1hcmdpbldpZHRoOwogIHNpemUub3V0ZXJIZWlnaHQgPSBzaXplLmhlaWdodCArIG1hcmdpbkhlaWdodDsKCiAgcmV0dXJuIHNpemU7Cn0KCi8vIElFOCByZXR1cm5zIHBlcmNlbnQgdmFsdWVzLCBub3QgcGl4ZWxzCi8vIHRha2VuIGZyb20galF1ZXJ5J3MgY3VyQ1NTCmZ1bmN0aW9uIG11bmdlTm9uUGl4ZWwoIGVsZW0sIHZhbHVlICkgewogIC8vIElFOCBhbmQgaGFzIHBlcmNlbnQgdmFsdWUKICBpZiAoIGdldENvbXB1dGVkU3R5bGUgfHwgdmFsdWUuaW5kZXhPZignJScpID09PSAtMSApIHsKICAgIHJldHVybiB2YWx1ZTsKICB9CiAgdmFyIHN0eWxlID0gZWxlbS5zdHlsZTsKICAvLyBSZW1lbWJlciB0aGUgb3JpZ2luYWwgdmFsdWVzCiAgdmFyIGxlZnQgPSBzdHlsZS5sZWZ0OwogIHZhciBycyA9IGVsZW0ucnVudGltZVN0eWxlOwogIHZhciByc0xlZnQgPSBycyAmJiBycy5sZWZ0OwoKICAvLyBQdXQgaW4gdGhlIG5ldyB2YWx1ZXMgdG8gZ2V0IGEgY29tcHV0ZWQgdmFsdWUgb3V0CiAgaWYgKCByc0xlZnQgKSB7CiAgICBycy5sZWZ0ID0gZWxlbS5jdXJyZW50U3R5bGUubGVmdDsKICB9CiAgc3R5bGUubGVmdCA9IHZhbHVlOwogIHZhbHVlID0gc3R5bGUucGl4ZWxMZWZ0OwoKICAvLyBSZXZlcnQgdGhlIGNoYW5nZWQgdmFsdWVzCiAgc3R5bGUubGVmdCA9IGxlZnQ7CiAgaWYgKCByc0xlZnQgKSB7CiAgICBycy5sZWZ0ID0gcnNMZWZ0OwogIH0KCiAgcmV0dXJuIHZhbHVlOwp9CgpyZXR1cm4gZ2V0U2l6ZTsKCn0KCi8vIHRyYW5zcG9ydAppZiAoIHR5cGVvZiBkZWZpbmUgPT09ICdmdW5jdGlvbicgJiYgZGVmaW5lLmFtZCApIHsKICAvLyBBTUQgZm9yIFJlcXVpcmVKUwogIGRlZmluZSggJ2dldC1zaXplL2dldC1zaXplJyxbICdnZXQtc3R5bGUtcHJvcGVydHkvZ2V0LXN0eWxlLXByb3BlcnR5JyBdLCBkZWZpbmVHZXRTaXplICk7Cn0gZWxzZSBpZiAoIHR5cGVvZiBleHBvcnRzID09PSAnb2JqZWN0JyApIHsKICAvLyBDb21tb25KUyBmb3IgQ29tcG9uZW50CiAgbW9kdWxlLmV4cG9ydHMgPSBkZWZpbmVHZXRTaXplKCByZXF1aXJlKCdnZXQtc3R5bGUtcHJvcGVydHknKSApOwp9IGVsc2UgewogIC8vIGJyb3dzZXIgZ2xvYmFsCiAgd2luZG93LmdldFNpemUgPSBkZWZpbmVHZXRTaXplKCB3aW5kb3cuZ2V0U3R5bGVQcm9wZXJ0eSApOwp9Cgp9KSggd2luZG93ICk7CgovKioKICogbWF0Y2hlc1NlbGVjdG9yIHYxLjAuMgogKiBtYXRjaGVzU2VsZWN0b3IoIGVsZW1lbnQsICcuc2VsZWN0b3InICkKICogTUlUIGxpY2Vuc2UKICovCgovKmpzaGludCBicm93c2VyOiB0cnVlLCBzdHJpY3Q6IHRydWUsIHVuZGVmOiB0cnVlLCB1bnVzZWQ6IHRydWUgKi8KLypnbG9iYWwgZGVmaW5lOiBmYWxzZSwgbW9kdWxlOiBmYWxzZSAqLwoKKCBmdW5jdGlvbiggRWxlbVByb3RvICkgewoKICAKCiAgdmFyIG1hdGNoZXNNZXRob2QgPSAoIGZ1bmN0aW9uKCkgewogICAgLy8gY2hlY2sgdW4tcHJlZml4ZWQKICAgIGlmICggRWxlbVByb3RvLm1hdGNoZXNTZWxlY3RvciApIHsKICAgICAgcmV0dXJuICdtYXRjaGVzU2VsZWN0b3InOwogICAgfQogICAgLy8gY2hlY2sgdmVuZG9yIHByZWZpeGVzCiAgICB2YXIgcHJlZml4ZXMgPSBbICd3ZWJraXQnLCAnbW96JywgJ21zJywgJ28nIF07CgogICAgZm9yICggdmFyIGk9MCwgbGVuID0gcHJlZml4ZXMubGVuZ3RoOyBpIDwgbGVuOyBpKysgKSB7CiAgICAgIHZhciBwcmVmaXggPSBwcmVmaXhlc1tpXTsKICAgICAgdmFyIG1ldGhvZCA9IHByZWZpeCArICdNYXRjaGVzU2VsZWN0b3InOwogICAgICBpZiAoIEVsZW1Qcm90b1sgbWV0aG9kIF0gKSB7CiAgICAgICAgcmV0dXJuIG1ldGhvZDsKICAgICAgfQogICAgfQogIH0pKCk7CgogIC8vIC0tLS0tIG1hdGNoIC0tLS0tIC8vCgogIGZ1bmN0aW9uIG1hdGNoKCBlbGVtLCBzZWxlY3RvciApIHsKICAgIHJldHVybiBlbGVtWyBtYXRjaGVzTWV0aG9kIF0oIHNlbGVjdG9yICk7CiAgfQoKICAvLyAtLS0tLSBhcHBlbmRUb0ZyYWdtZW50IC0tLS0tIC8vCgogIGZ1bmN0aW9uIGNoZWNrUGFyZW50KCBlbGVtICkgewogICAgLy8gbm90IG5lZWRlZCBpZiBhbHJlYWR5IGhhcyBwYXJlbnQKICAgIGlmICggZWxlbS5wYXJlbnROb2RlICkgewogICAgICByZXR1cm47CiAgICB9CiAgICB2YXIgZnJhZ21lbnQgPSBkb2N1bWVudC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCk7CiAgICBmcmFnbWVudC5hcHBlbmRDaGlsZCggZWxlbSApOwogIH0KCiAgLy8gLS0tLS0gcXVlcnkgLS0tLS0gLy8KCiAgLy8gZmFsbCBiYWNrIHRvIHVzaW5nIFFTQQogIC8vIHRoeCBAam9uYXRoYW50bmVhbCBodHRwczovL2dpc3QuZ2l0aHViLmNvbS8zMDYyOTU1CiAgZnVuY3Rpb24gcXVlcnkoIGVsZW0sIHNlbGVjdG9yICkgewogICAgLy8gYXBwZW5kIHRvIGZyYWdtZW50IGlmIG5vIHBhcmVudAogICAgY2hlY2tQYXJlbnQoIGVsZW0gKTsKCiAgICAvLyBtYXRjaCBlbGVtIHdpdGggYWxsIHNlbGVjdGVkIGVsZW1zIG9mIHBhcmVudAogICAgdmFyIGVsZW1zID0gZWxlbS5wYXJlbnROb2RlLnF1ZXJ5U2VsZWN0b3JBbGwoIHNlbGVjdG9yICk7CiAgICBmb3IgKCB2YXIgaT0wLCBsZW4gPSBlbGVtcy5sZW5ndGg7IGkgPCBsZW47IGkrKyApIHsKICAgICAgLy8gcmV0dXJuIHRydWUgaWYgbWF0Y2gKICAgICAgaWYgKCBlbGVtc1tpXSA9PT0gZWxlbSApIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgfQogICAgLy8gb3RoZXJ3aXNlIHJldHVybiBmYWxzZQogICAgcmV0dXJuIGZhbHNlOwogIH0KCiAgLy8gLS0tLS0gbWF0Y2hDaGlsZCAtLS0tLSAvLwoKICBmdW5jdGlvbiBtYXRjaENoaWxkKCBlbGVtLCBzZWxlY3RvciApIHsKICAgIGNoZWNrUGFyZW50KCBlbGVtICk7CiAgICByZXR1cm4gbWF0Y2goIGVsZW0sIHNlbGVjdG9yICk7CiAgfQoKICAvLyAtLS0tLSBtYXRjaGVzU2VsZWN0b3IgLS0tLS0gLy8KCiAgdmFyIG1hdGNoZXNTZWxlY3RvcjsKCiAgaWYgKCBtYXRjaGVzTWV0aG9kICkgewogICAgLy8gSUU5IHN1cHBvcnRzIG1hdGNoZXNTZWxlY3RvciwgYnV0IGRvZXNuJ3Qgd29yayBvbiBvcnBoYW5lZCBlbGVtcwogICAgLy8gY2hlY2sgZm9yIHRoYXQKICAgIHZhciBkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgIHZhciBzdXBwb3J0c09ycGhhbnMgPSBtYXRjaCggZGl2LCAnZGl2JyApOwogICAgbWF0Y2hlc1NlbGVjdG9yID0gc3VwcG9ydHNPcnBoYW5zID8gbWF0Y2ggOiBtYXRjaENoaWxkOwogIH0gZWxzZSB7CiAgICBtYXRjaGVzU2VsZWN0b3IgPSBxdWVyeTsKICB9CgogIC8vIHRyYW5zcG9ydAogIGlmICggdHlwZW9mIGRlZmluZSA9PT0gJ2Z1bmN0aW9uJyAmJiBkZWZpbmUuYW1kICkgewogICAgLy8gQU1ECiAgICBkZWZpbmUoICdtYXRjaGVzLXNlbGVjdG9yL21hdGNoZXMtc2VsZWN0b3InLFtdLGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gbWF0Y2hlc1NlbGVjdG9yOwogICAgfSk7CiAgfSBlbHNlIGlmICggdHlwZW9mIGV4cG9ydHMgPT09ICdvYmplY3QnICkgewogICAgbW9kdWxlLmV4cG9ydHMgPSBtYXRjaGVzU2VsZWN0b3I7CiAgfQogIGVsc2UgewogICAgLy8gYnJvd3NlciBnbG9iYWwKICAgIHdpbmRvdy5tYXRjaGVzU2VsZWN0b3IgPSBtYXRjaGVzU2VsZWN0b3I7CiAgfQoKfSkoIEVsZW1lbnQucHJvdG90eXBlICk7CgovKioKICogT3V0bGF5ZXIgSXRlbQogKi8KCiggZnVuY3Rpb24oIHdpbmRvdyApIHsKCgoKLy8gLS0tLS0gZ2V0IHN0eWxlIC0tLS0tIC8vCgp2YXIgZ2V0Q29tcHV0ZWRTdHlsZSA9IHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlOwp2YXIgZ2V0U3R5bGUgPSBnZXRDb21wdXRlZFN0eWxlID8KICBmdW5jdGlvbiggZWxlbSApIHsKICAgIHJldHVybiBnZXRDb21wdXRlZFN0eWxlKCBlbGVtLCBudWxsICk7CiAgfSA6CiAgZnVuY3Rpb24oIGVsZW0gKSB7CiAgICByZXR1cm4gZWxlbS5jdXJyZW50U3R5bGU7CiAgfTsKCgovLyBleHRlbmQgb2JqZWN0cwpmdW5jdGlvbiBleHRlbmQoIGEsIGIgKSB7CiAgZm9yICggdmFyIHByb3AgaW4gYiApIHsKICAgIGFbIHByb3AgXSA9IGJbIHByb3AgXTsKICB9CiAgcmV0dXJuIGE7Cn0KCmZ1bmN0aW9uIGlzRW1wdHlPYmooIG9iaiApIHsKICBmb3IgKCB2YXIgcHJvcCBpbiBvYmogKSB7CiAgICByZXR1cm4gZmFsc2U7CiAgfQogIHByb3AgPSBudWxsOwogIHJldHVybiB0cnVlOwp9CgovLyBodHRwOi8vamFtZXNyb2JlcnRzLm5hbWUvYmxvZy8yMDEwLzAyLzIyL3N0cmluZy1mdW5jdGlvbnMtZm9yLWphdmFzY3JpcHQtdHJpbS10by1jYW1lbC1jYXNlLXRvLWRhc2hlZC1hbmQtdG8tdW5kZXJzY29yZS8KZnVuY3Rpb24gdG9EYXNoKCBzdHIgKSB7CiAgcmV0dXJuIHN0ci5yZXBsYWNlKCAvKFtBLVpdKS9nLCBmdW5jdGlvbiggJDEgKXsKICAgIHJldHVybiAnLScgKyAkMS50b0xvd2VyQ2FzZSgpOwogIH0pOwp9CgovLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSBPdXRsYXllciBkZWZpbml0aW9uIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tIC8vCgpmdW5jdGlvbiBvdXRsYXllckl0ZW1EZWZpbml0aW9uKCBFdmVudEVtaXR0ZXIsIGdldFNpemUsIGdldFN0eWxlUHJvcGVydHkgKSB7CgovLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSBDU1MzIHN1cHBvcnQgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gLy8KCnZhciB0cmFuc2l0aW9uUHJvcGVydHkgPSBnZXRTdHlsZVByb3BlcnR5KCd0cmFuc2l0aW9uJyk7CnZhciB0cmFuc2Zvcm1Qcm9wZXJ0eSA9IGdldFN0eWxlUHJvcGVydHkoJ3RyYW5zZm9ybScpOwp2YXIgc3VwcG9ydHNDU1MzID0gdHJhbnNpdGlvblByb3BlcnR5ICYmIHRyYW5zZm9ybVByb3BlcnR5Owp2YXIgaXMzZCA9ICEhZ2V0U3R5bGVQcm9wZXJ0eSgncGVyc3BlY3RpdmUnKTsKCnZhciB0cmFuc2l0aW9uRW5kRXZlbnQgPSB7CiAgV2Via2l0VHJhbnNpdGlvbjogJ3dlYmtpdFRyYW5zaXRpb25FbmQnLAogIE1velRyYW5zaXRpb246ICd0cmFuc2l0aW9uZW5kJywKICBPVHJhbnNpdGlvbjogJ290cmFuc2l0aW9uZW5kJywKICB0cmFuc2l0aW9uOiAndHJhbnNpdGlvbmVuZCcKfVsgdHJhbnNpdGlvblByb3BlcnR5IF07CgovLyBwcm9wZXJ0aWVzIHRoYXQgY291bGQgaGF2ZSB2ZW5kb3IgcHJlZml4CnZhciBwcmVmaXhhYmxlUHJvcGVydGllcyA9IFsKICAndHJhbnNmb3JtJywKICAndHJhbnNpdGlvbicsCiAgJ3RyYW5zaXRpb25EdXJhdGlvbicsCiAgJ3RyYW5zaXRpb25Qcm9wZXJ0eScKXTsKCi8vIGNhY2hlIGFsbCB2ZW5kb3IgcHJvcGVydGllcwp2YXIgdmVuZG9yUHJvcGVydGllcyA9ICggZnVuY3Rpb24oKSB7CiAgdmFyIGNhY2hlID0ge307CiAgZm9yICggdmFyIGk9MCwgbGVuID0gcHJlZml4YWJsZVByb3BlcnRpZXMubGVuZ3RoOyBpIDwgbGVuOyBpKysgKSB7CiAgICB2YXIgcHJvcCA9IHByZWZpeGFibGVQcm9wZXJ0aWVzW2ldOwogICAgdmFyIHN1cHBvcnRlZFByb3AgPSBnZXRTdHlsZVByb3BlcnR5KCBwcm9wICk7CiAgICBpZiAoIHN1cHBvcnRlZFByb3AgJiYgc3VwcG9ydGVkUHJvcCAhPT0gcHJvcCApIHsKICAgICAgY2FjaGVbIHByb3AgXSA9IHN1cHBvcnRlZFByb3A7CiAgICB9CiAgfQogIHJldHVybiBjYWNoZTsKfSkoKTsKCi8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tIEl0ZW0gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gLy8KCmZ1bmN0aW9uIEl0ZW0oIGVsZW1lbnQsIGxheW91dCApIHsKICBpZiAoICFlbGVtZW50ICkgewogICAgcmV0dXJuOwogIH0KCiAgdGhpcy5lbGVtZW50ID0gZWxlbWVudDsKICAvLyBwYXJlbnQgbGF5b3V0IGNsYXNzLCBpLmUuIE1hc29ucnksIElzb3RvcGUsIG9yIFBhY2tlcnkKICB0aGlzLmxheW91dCA9IGxheW91dDsKICB0aGlzLnBvc2l0aW9uID0gewogICAgeDogMCwKICAgIHk6IDAKICB9OwoKICB0aGlzLl9jcmVhdGUoKTsKfQoKLy8gaW5oZXJpdCBFdmVudEVtaXR0ZXIKZXh0ZW5kKCBJdGVtLnByb3RvdHlwZSwgRXZlbnRFbWl0dGVyLnByb3RvdHlwZSApOwoKSXRlbS5wcm90b3R5cGUuX2NyZWF0ZSA9IGZ1bmN0aW9uKCkgewogIC8vIHRyYW5zaXRpb24gb2JqZWN0cwogIHRoaXMuX3RyYW5zbiA9IHsKICAgIGluZ1Byb3BlcnRpZXM6IHt9LAogICAgY2xlYW46IHt9LAogICAgb25FbmQ6IHt9CiAgfTsKCiAgdGhpcy5jc3MoewogICAgcG9zaXRpb246ICdhYnNvbHV0ZScKICB9KTsKfTsKCi8vIHRyaWdnZXIgc3BlY2lmaWVkIGhhbmRsZXIgZm9yIGV2ZW50IHR5cGUKSXRlbS5wcm90b3R5cGUuaGFuZGxlRXZlbnQgPSBmdW5jdGlvbiggZXZlbnQgKSB7CiAgdmFyIG1ldGhvZCA9ICdvbicgKyBldmVudC50eXBlOwogIGlmICggdGhpc1sgbWV0aG9kIF0gKSB7CiAgICB0aGlzWyBtZXRob2QgXSggZXZlbnQgKTsKICB9Cn07CgpJdGVtLnByb3RvdHlwZS5nZXRTaXplID0gZnVuY3Rpb24oKSB7CiAgdGhpcy5zaXplID0gZ2V0U2l6ZSggdGhpcy5lbGVtZW50ICk7Cn07CgovKioKICogYXBwbHkgQ1NTIHN0eWxlcyB0byBlbGVtZW50CiAqIEBwYXJhbSB7T2JqZWN0fSBzdHlsZQogKi8KSXRlbS5wcm90b3R5cGUuY3NzID0gZnVuY3Rpb24oIHN0eWxlICkgewogIHZhciBlbGVtU3R5bGUgPSB0aGlzLmVsZW1lbnQuc3R5bGU7CgogIGZvciAoIHZhciBwcm9wIGluIHN0eWxlICkgewogICAgLy8gdXNlIHZlbmRvciBwcm9wZXJ0eSBpZiBhdmFpbGFibGUKICAgIHZhciBzdXBwb3J0ZWRQcm9wID0gdmVuZG9yUHJvcGVydGllc1sgcHJvcCBdIHx8IHByb3A7CiAgICBlbGVtU3R5bGVbIHN1cHBvcnRlZFByb3AgXSA9IHN0eWxlWyBwcm9wIF07CiAgfQp9OwoKIC8vIG1lYXN1cmUgcG9zaXRpb24sIGFuZCBzZXRzIGl0Ckl0ZW0ucHJvdG90eXBlLmdldFBvc2l0aW9uID0gZnVuY3Rpb24oKSB7CiAgdmFyIHN0eWxlID0gZ2V0U3R5bGUoIHRoaXMuZWxlbWVudCApOwogIHZhciBsYXlvdXRPcHRpb25zID0gdGhpcy5sYXlvdXQub3B0aW9uczsKICB2YXIgaXNPcmlnaW5MZWZ0ID0gbGF5b3V0T3B0aW9ucy5pc09yaWdpbkxlZnQ7CiAgdmFyIGlzT3JpZ2luVG9wID0gbGF5b3V0T3B0aW9ucy5pc09yaWdpblRvcDsKICB2YXIgeCA9IHBhcnNlSW50KCBzdHlsZVsgaXNPcmlnaW5MZWZ0ID8gJ2xlZnQnIDogJ3JpZ2h0JyBdLCAxMCApOwogIHZhciB5ID0gcGFyc2VJbnQoIHN0eWxlWyBpc09yaWdpblRvcCA/ICd0b3AnIDogJ2JvdHRvbScgXSwgMTAgKTsKCiAgLy8gY2xlYW4gdXAgJ2F1dG8nIG9yIG90aGVyIG5vbi1pbnRlZ2VyIHZhbHVlcwogIHggPSBpc05hTiggeCApID8gMCA6IHg7CiAgeSA9IGlzTmFOKCB5ICkgPyAwIDogeTsKICAvLyByZW1vdmUgcGFkZGluZyBmcm9tIG1lYXN1cmVtZW50CiAgdmFyIGxheW91dFNpemUgPSB0aGlzLmxheW91dC5zaXplOwogIHggLT0gaXNPcmlnaW5MZWZ0ID8gbGF5b3V0U2l6ZS5wYWRkaW5nTGVmdCA6IGxheW91dFNpemUucGFkZGluZ1JpZ2h0OwogIHkgLT0gaXNPcmlnaW5Ub3AgPyBsYXlvdXRTaXplLnBhZGRpbmdUb3AgOiBsYXlvdXRTaXplLnBhZGRpbmdCb3R0b207CgogIHRoaXMucG9zaXRpb24ueCA9IHg7CiAgdGhpcy5wb3NpdGlvbi55ID0geTsKfTsKCi8vIHNldCBzZXR0bGVkIHBvc2l0aW9uLCBhcHBseSBwYWRkaW5nCkl0ZW0ucHJvdG90eXBlLmxheW91dFBvc2l0aW9uID0gZnVuY3Rpb24oKSB7CiAgdmFyIGxheW91dFNpemUgPSB0aGlzLmxheW91dC5zaXplOwogIHZhciBsYXlvdXRPcHRpb25zID0gdGhpcy5sYXlvdXQub3B0aW9uczsKICB2YXIgc3R5bGUgPSB7fTsKCiAgaWYgKCBsYXlvdXRPcHRpb25zLmlzT3JpZ2luTGVmdCApIHsKICAgIHN0eWxlLmxlZnQgPSAoIHRoaXMucG9zaXRpb24ueCArIGxheW91dFNpemUucGFkZGluZ0xlZnQgKSArICdweCc7CiAgICAvLyByZXNldCBvdGhlciBwcm9wZXJ0eQogICAgc3R5bGUucmlnaHQgPSAnJzsKICB9IGVsc2UgewogICAgc3R5bGUucmlnaHQgPSAoIHRoaXMucG9zaXRpb24ueCArIGxheW91dFNpemUucGFkZGluZ1JpZ2h0ICkgKyAncHgnOwogICAgc3R5bGUubGVmdCA9ICcnOwogIH0KCiAgaWYgKCBsYXlvdXRPcHRpb25zLmlzT3JpZ2luVG9wICkgewogICAgc3R5bGUudG9wID0gKCB0aGlzLnBvc2l0aW9uLnkgKyBsYXlvdXRTaXplLnBhZGRpbmdUb3AgKSArICdweCc7CiAgICBzdHlsZS5ib3R0b20gPSAnJzsKICB9IGVsc2UgewogICAgc3R5bGUuYm90dG9tID0gKCB0aGlzLnBvc2l0aW9uLnkgKyBsYXlvdXRTaXplLnBhZGRpbmdCb3R0b20gKSArICdweCc7CiAgICBzdHlsZS50b3AgPSAnJzsKICB9CgogIHRoaXMuY3NzKCBzdHlsZSApOwogIHRoaXMuZW1pdEV2ZW50KCAnbGF5b3V0JywgWyB0aGlzIF0gKTsKfTsKCgovLyB0cmFuc2Zvcm0gdHJhbnNsYXRlIGZ1bmN0aW9uCnZhciB0cmFuc2xhdGUgPSBpczNkID8KICBmdW5jdGlvbiggeCwgeSApIHsKICAgIHJldHVybiAndHJhbnNsYXRlM2QoJyArIHggKyAncHgsICcgKyB5ICsgJ3B4LCAwKSc7CiAgfSA6CiAgZnVuY3Rpb24oIHgsIHkgKSB7CiAgICByZXR1cm4gJ3RyYW5zbGF0ZSgnICsgeCArICdweCwgJyArIHkgKyAncHgpJzsKICB9OwoKCkl0ZW0ucHJvdG90eXBlLl90cmFuc2l0aW9uVG8gPSBmdW5jdGlvbiggeCwgeSApIHsKICB0aGlzLmdldFBvc2l0aW9uKCk7CiAgLy8gZ2V0IGN1cnJlbnQgeCAmIHkgZnJvbSB0b3AvbGVmdAogIHZhciBjdXJYID0gdGhpcy5wb3NpdGlvbi54OwogIHZhciBjdXJZID0gdGhpcy5wb3NpdGlvbi55OwoKICB2YXIgY29tcGFyZVggPSBwYXJzZUludCggeCwgMTAgKTsKICB2YXIgY29tcGFyZVkgPSBwYXJzZUludCggeSwgMTAgKTsKICB2YXIgZGlkTm90TW92ZSA9IGNvbXBhcmVYID09PSB0aGlzLnBvc2l0aW9uLnggJiYgY29tcGFyZVkgPT09IHRoaXMucG9zaXRpb24ueTsKCiAgLy8gc2F2ZSBlbmQgcG9zaXRpb24KICB0aGlzLnNldFBvc2l0aW9uKCB4LCB5ICk7CgogIC8vIGlmIGRpZCBub3QgbW92ZSBhbmQgbm90IHRyYW5zaXRpb25pbmcsIGp1c3QgZ28gdG8gbGF5b3V0CiAgaWYgKCBkaWROb3RNb3ZlICYmICF0aGlzLmlzVHJhbnNpdGlvbmluZyApIHsKICAgIHRoaXMubGF5b3V0UG9zaXRpb24oKTsKICAgIHJldHVybjsKICB9CgogIHZhciB0cmFuc1ggPSB4IC0gY3VyWDsKICB2YXIgdHJhbnNZID0geSAtIGN1clk7CiAgdmFyIHRyYW5zaXRpb25TdHlsZSA9IHt9OwogIC8vIGZsaXAgY29vcmlkaW5hdGVzIGlmIG9yaWdpbiBvbiByaWdodCBvciBib3R0b20KICB2YXIgbGF5b3V0T3B0aW9ucyA9IHRoaXMubGF5b3V0Lm9wdGlvbnM7CiAgdHJhbnNYID0gbGF5b3V0T3B0aW9ucy5pc09yaWdpbkxlZnQgPyB0cmFuc1ggOiAtdHJhbnNYOwogIHRyYW5zWSA9IGxheW91dE9wdGlvbnMuaXNPcmlnaW5Ub3AgPyB0cmFuc1kgOiAtdHJhbnNZOwogIHRyYW5zaXRpb25TdHlsZS50cmFuc2Zvcm0gPSB0cmFuc2xhdGUoIHRyYW5zWCwgdHJhbnNZICk7CgogIHRoaXMudHJhbnNpdGlvbih7CiAgICB0bzogdHJhbnNpdGlvblN0eWxlLAogICAgb25UcmFuc2l0aW9uRW5kOiB7CiAgICAgIHRyYW5zZm9ybTogdGhpcy5sYXlvdXRQb3NpdGlvbgogICAgfSwKICAgIGlzQ2xlYW5pbmc6IHRydWUKICB9KTsKfTsKCi8vIG5vbiB0cmFuc2l0aW9uICsgdHJhbnNmb3JtIHN1cHBvcnQKSXRlbS5wcm90b3R5cGUuZ29UbyA9IGZ1bmN0aW9uKCB4LCB5ICkgewogIHRoaXMuc2V0UG9zaXRpb24oIHgsIHkgKTsKICB0aGlzLmxheW91dFBvc2l0aW9uKCk7Cn07CgovLyB1c2UgdHJhbnNpdGlvbiBhbmQgdHJhbnNmb3JtcyBpZiBzdXBwb3J0ZWQKSXRlbS5wcm90b3R5cGUubW92ZVRvID0gc3VwcG9ydHNDU1MzID8KICBJdGVtLnByb3RvdHlwZS5fdHJhbnNpdGlvblRvIDogSXRlbS5wcm90b3R5cGUuZ29UbzsKCkl0ZW0ucHJvdG90eXBlLnNldFBvc2l0aW9uID0gZnVuY3Rpb24oIHgsIHkgKSB7CiAgdGhpcy5wb3NpdGlvbi54ID0gcGFyc2VJbnQoIHgsIDEwICk7CiAgdGhpcy5wb3NpdGlvbi55ID0gcGFyc2VJbnQoIHksIDEwICk7Cn07CgovLyAtLS0tLSB0cmFuc2l0aW9uIC0tLS0tIC8vCgovKioKICogQHBhcmFtIHtPYmplY3R9IHN0eWxlIC0gQ1NTCiAqIEBwYXJhbSB7RnVuY3Rpb259IG9uVHJhbnNpdGlvbkVuZAogKi8KCi8vIG5vbiB0cmFuc2l0aW9uLCBqdXN0IHRyaWdnZXIgY2FsbGJhY2sKSXRlbS5wcm90b3R5cGUuX25vblRyYW5zaXRpb24gPSBmdW5jdGlvbiggYXJncyApIHsKICB0aGlzLmNzcyggYXJncy50byApOwogIGlmICggYXJncy5pc0NsZWFuaW5nICkgewogICAgdGhpcy5fcmVtb3ZlU3R5bGVzKCBhcmdzLnRvICk7CiAgfQogIGZvciAoIHZhciBwcm9wIGluIGFyZ3Mub25UcmFuc2l0aW9uRW5kICkgewogICAgYXJncy5vblRyYW5zaXRpb25FbmRbIHByb3AgXS5jYWxsKCB0aGlzICk7CiAgfQp9OwoKLyoqCiAqIHByb3BlciB0cmFuc2l0aW9uCiAqIEBwYXJhbSB7T2JqZWN0fSBhcmdzIC0gYXJndW1lbnRzCiAqICAgQHBhcmFtIHtPYmplY3R9IHRvIC0gc3R5bGUgdG8gdHJhbnNpdGlvbiB0bwogKiAgIEBwYXJhbSB7T2JqZWN0fSBmcm9tIC0gc3R5bGUgdG8gc3RhcnQgdHJhbnNpdGlvbiBmcm9tCiAqICAgQHBhcmFtIHtCb29sZWFufSBpc0NsZWFuaW5nIC0gcmVtb3ZlcyB0cmFuc2l0aW9uIHN0eWxlcyBhZnRlciB0cmFuc2l0aW9uCiAqICAgQHBhcmFtIHtGdW5jdGlvbn0gb25UcmFuc2l0aW9uRW5kIC0gY2FsbGJhY2sKICovCkl0ZW0ucHJvdG90eXBlLl90cmFuc2l0aW9uID0gZnVuY3Rpb24oIGFyZ3MgKSB7CiAgLy8gcmVkaXJlY3QgdG8gbm9uVHJhbnNpdGlvbiBpZiBubyB0cmFuc2l0aW9uIGR1cmF0aW9uCiAgaWYgKCAhcGFyc2VGbG9hdCggdGhpcy5sYXlvdXQub3B0aW9ucy50cmFuc2l0aW9uRHVyYXRpb24gKSApIHsKICAgIHRoaXMuX25vblRyYW5zaXRpb24oIGFyZ3MgKTsKICAgIHJldHVybjsKICB9CgogIHZhciBfdHJhbnNpdGlvbiA9IHRoaXMuX3RyYW5zbjsKICAvLyBrZWVwIHRyYWNrIG9mIG9uVHJhbnNpdGlvbkVuZCBjYWxsYmFjayBieSBjc3MgcHJvcGVydHkKICBmb3IgKCB2YXIgcHJvcCBpbiBhcmdzLm9uVHJhbnNpdGlvbkVuZCApIHsKICAgIF90cmFuc2l0aW9uLm9uRW5kWyBwcm9wIF0gPSBhcmdzLm9uVHJhbnNpdGlvbkVuZFsgcHJvcCBdOwogIH0KICAvLyBrZWVwIHRyYWNrIG9mIHByb3BlcnRpZXMgdGhhdCBhcmUgdHJhbnNpdGlvbmluZwogIGZvciAoIHByb3AgaW4gYXJncy50byApIHsKICAgIF90cmFuc2l0aW9uLmluZ1Byb3BlcnRpZXNbIHByb3AgXSA9IHRydWU7CiAgICAvLyBrZWVwIHRyYWNrIG9mIHByb3BlcnRpZXMgdG8gY2xlYW4gdXAgd2hlbiB0cmFuc2l0aW9uIGlzIGRvbmUKICAgIGlmICggYXJncy5pc0NsZWFuaW5nICkgewogICAgICBfdHJhbnNpdGlvbi5jbGVhblsgcHJvcCBdID0gdHJ1ZTsKICAgIH0KICB9CgogIC8vIHNldCBmcm9tIHN0eWxlcwogIGlmICggYXJncy5mcm9tICkgewogICAgdGhpcy5jc3MoIGFyZ3MuZnJvbSApOwogICAgLy8gZm9yY2UgcmVkcmF3LiBodHRwOi8vYmxvZy5hbGV4bWFjY2F3LmNvbS9jc3MtdHJhbnNpdGlvbnMKICAgIHZhciBoID0gdGhpcy5lbGVtZW50Lm9mZnNldEhlaWdodDsKICAgIC8vIGhhY2sgZm9yIEpTSGludCB0byBodXNoIGFib3V0IHVudXNlZCB2YXIKICAgIGggPSBudWxsOwogIH0KICAvLyBlbmFibGUgdHJhbnNpdGlvbgogIHRoaXMuZW5hYmxlVHJhbnNpdGlvbiggYXJncy50byApOwogIC8vIHNldCBzdHlsZXMgdGhhdCBhcmUgdHJhbnNpdGlvbmluZwogIHRoaXMuY3NzKCBhcmdzLnRvICk7CgogIHRoaXMuaXNUcmFuc2l0aW9uaW5nID0gdHJ1ZTsKCn07Cgp2YXIgaXRlbVRyYW5zaXRpb25Qcm9wZXJ0aWVzID0gdHJhbnNmb3JtUHJvcGVydHkgJiYgKCB0b0Rhc2goIHRyYW5zZm9ybVByb3BlcnR5ICkgKwogICcsb3BhY2l0eScgKTsKCkl0ZW0ucHJvdG90eXBlLmVuYWJsZVRyYW5zaXRpb24gPSBmdW5jdGlvbigvKiBzdHlsZSAqLykgewogIC8vIG9ubHkgZW5hYmxlIGlmIG5vdCBhbHJlYWR5IHRyYW5zaXRpb25pbmcKICAvLyBidWcgaW4gSUUxMCB3ZXJlIHJlLXNldHRpbmcgdHJhbnNpdGlvbiBzdHlsZSB3aWxsIHByZXZlbnQKICAvLyB0cmFuc2l0aW9uZW5kIGV2ZW50IGZyb20gdHJpZ2dlcmluZwogIGlmICggdGhpcy5pc1RyYW5zaXRpb25pbmcgKSB7CiAgICByZXR1cm47CiAgfQoKICAvLyBtYWtlIHRyYW5zaXRpb246IGZvbywgYmFyLCBiYXogZnJvbSBzdHlsZSBvYmplY3QKICAvLyBUT0RPIHVuY29tbWVudCB0aGlzIGJpdCB3aGVuIElFMTAgYnVnIGlzIHJlc29sdmVkCiAgLy8gdmFyIHRyYW5zaXRpb25WYWx1ZSA9IFtdOwogIC8vIGZvciAoIHZhciBwcm9wIGluIHN0eWxlICkgewogIC8vICAgLy8gZGFzaC1pZnkgY2FtZWxDYXNlZCBwcm9wZXJ0aWVzIGxpa2UgV2Via2l0VHJhbnNpdGlvbgogIC8vICAgdHJhbnNpdGlvblZhbHVlLnB1c2goIHRvRGFzaCggcHJvcCApICk7CiAgLy8gfQogIC8vIGVuYWJsZSB0cmFuc2l0aW9uIHN0eWxlcwogIC8vIEhBQ0sgYWx3YXlzIGVuYWJsZSB0cmFuc2Zvcm0sb3BhY2l0eSBmb3IgSUUxMAogIHRoaXMuY3NzKHsKICAgIHRyYW5zaXRpb25Qcm9wZXJ0eTogaXRlbVRyYW5zaXRpb25Qcm9wZXJ0aWVzLAogICAgdHJhbnNpdGlvbkR1cmF0aW9uOiB0aGlzLmxheW91dC5vcHRpb25zLnRyYW5zaXRpb25EdXJhdGlvbgogIH0pOwogIC8vIGxpc3RlbiBmb3IgdHJhbnNpdGlvbiBlbmQgZXZlbnQKICB0aGlzLmVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lciggdHJhbnNpdGlvbkVuZEV2ZW50LCB0aGlzLCBmYWxzZSApOwp9OwoKSXRlbS5wcm90b3R5cGUudHJhbnNpdGlvbiA9IEl0ZW0ucHJvdG90eXBlWyB0cmFuc2l0aW9uUHJvcGVydHkgPyAnX3RyYW5zaXRpb24nIDogJ19ub25UcmFuc2l0aW9uJyBdOwoKLy8gLS0tLS0gZXZlbnRzIC0tLS0tIC8vCgpJdGVtLnByb3RvdHlwZS5vbndlYmtpdFRyYW5zaXRpb25FbmQgPSBmdW5jdGlvbiggZXZlbnQgKSB7CiAgdGhpcy5vbnRyYW5zaXRpb25lbmQoIGV2ZW50ICk7Cn07CgpJdGVtLnByb3RvdHlwZS5vbm90cmFuc2l0aW9uZW5kID0gZnVuY3Rpb24oIGV2ZW50ICkgewogIHRoaXMub250cmFuc2l0aW9uZW5kKCBldmVudCApOwp9OwoKLy8gcHJvcGVydGllcyB0aGF0IEkgbXVuZ2UgdG8gbWFrZSBteSBsaWZlIGVhc2llcgp2YXIgZGFzaGVkVmVuZG9yUHJvcGVydGllcyA9IHsKICAnLXdlYmtpdC10cmFuc2Zvcm0nOiAndHJhbnNmb3JtJywKICAnLW1vei10cmFuc2Zvcm0nOiAndHJhbnNmb3JtJywKICAnLW8tdHJhbnNmb3JtJzogJ3RyYW5zZm9ybScKfTsKCkl0ZW0ucHJvdG90eXBlLm9udHJhbnNpdGlvbmVuZCA9IGZ1bmN0aW9uKCBldmVudCApIHsKICAvLyBkaXNyZWdhcmQgYnViYmxlZCBldmVudHMgZnJvbSBjaGlsZHJlbgogIGlmICggZXZlbnQudGFyZ2V0ICE9PSB0aGlzLmVsZW1lbnQgKSB7CiAgICByZXR1cm47CiAgfQogIHZhciBfdHJhbnNpdGlvbiA9IHRoaXMuX3RyYW5zbjsKICAvLyBnZXQgcHJvcGVydHkgbmFtZSBvZiB0cmFuc2l0aW9uZWQgcHJvcGVydHksIGNvbnZlcnQgdG8gcHJlZml4LWZyZWUKICB2YXIgcHJvcGVydHlOYW1lID0gZGFzaGVkVmVuZG9yUHJvcGVydGllc1sgZXZlbnQucHJvcGVydHlOYW1lIF0gfHwgZXZlbnQucHJvcGVydHlOYW1lOwoKICAvLyByZW1vdmUgcHJvcGVydHkgdGhhdCBoYXMgY29tcGxldGVkIHRyYW5zaXRpb25pbmcKICBkZWxldGUgX3RyYW5zaXRpb24uaW5nUHJvcGVydGllc1sgcHJvcGVydHlOYW1lIF07CiAgLy8gY2hlY2sgaWYgYW55IHByb3BlcnRpZXMgYXJlIHN0aWxsIHRyYW5zaXRpb25pbmcKICBpZiAoIGlzRW1wdHlPYmooIF90cmFuc2l0aW9uLmluZ1Byb3BlcnRpZXMgKSApIHsKICAgIC8vIGFsbCBwcm9wZXJ0aWVzIGhhdmUgY29tcGxldGVkIHRyYW5zaXRpb25pbmcKICAgIHRoaXMuZGlzYWJsZVRyYW5zaXRpb24oKTsKICB9CiAgLy8gY2xlYW4gc3R5bGUKICBpZiAoIHByb3BlcnR5TmFtZSBpbiBfdHJhbnNpdGlvbi5jbGVhbiApIHsKICAgIC8vIGNsZWFuIHVwIHN0eWxlCiAgICB0aGlzLmVsZW1lbnQuc3R5bGVbIGV2ZW50LnByb3BlcnR5TmFtZSBdID0gJyc7CiAgICBkZWxldGUgX3RyYW5zaXRpb24uY2xlYW5bIHByb3BlcnR5TmFtZSBdOwogIH0KICAvLyB0cmlnZ2VyIG9uVHJhbnNpdGlvbkVuZCBjYWxsYmFjawogIGlmICggcHJvcGVydHlOYW1lIGluIF90cmFuc2l0aW9uLm9uRW5kICkgewogICAgdmFyIG9uVHJhbnNpdGlvbkVuZCA9IF90cmFuc2l0aW9uLm9uRW5kWyBwcm9wZXJ0eU5hbWUgXTsKICAgIG9uVHJhbnNpdGlvbkVuZC5jYWxsKCB0aGlzICk7CiAgICBkZWxldGUgX3RyYW5zaXRpb24ub25FbmRbIHByb3BlcnR5TmFtZSBdOwogIH0KCiAgdGhpcy5lbWl0RXZlbnQoICd0cmFuc2l0aW9uRW5kJywgWyB0aGlzIF0gKTsKfTsKCkl0ZW0ucHJvdG90eXBlLmRpc2FibGVUcmFuc2l0aW9uID0gZnVuY3Rpb24oKSB7CiAgdGhpcy5yZW1vdmVUcmFuc2l0aW9uU3R5bGVzKCk7CiAgdGhpcy5lbGVtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoIHRyYW5zaXRpb25FbmRFdmVudCwgdGhpcywgZmFsc2UgKTsKICB0aGlzLmlzVHJhbnNpdGlvbmluZyA9IGZhbHNlOwp9OwoKLyoqCiAqIHJlbW92ZXMgc3R5bGUgcHJvcGVydHkgZnJvbSBlbGVtZW50CiAqIEBwYXJhbSB7T2JqZWN0fSBzdHlsZQoqKi8KSXRlbS5wcm90b3R5cGUuX3JlbW92ZVN0eWxlcyA9IGZ1bmN0aW9uKCBzdHlsZSApIHsKICAvLyBjbGVhbiB1cCB0cmFuc2l0aW9uIHN0eWxlcwogIHZhciBjbGVhblN0eWxlID0ge307CiAgZm9yICggdmFyIHByb3AgaW4gc3R5bGUgKSB7CiAgICBjbGVhblN0eWxlWyBwcm9wIF0gPSAnJzsKICB9CiAgdGhpcy5jc3MoIGNsZWFuU3R5bGUgKTsKfTsKCnZhciBjbGVhblRyYW5zaXRpb25TdHlsZSA9IHsKICB0cmFuc2l0aW9uUHJvcGVydHk6ICcnLAogIHRyYW5zaXRpb25EdXJhdGlvbjogJycKfTsKCkl0ZW0ucHJvdG90eXBlLnJlbW92ZVRyYW5zaXRpb25TdHlsZXMgPSBmdW5jdGlvbigpIHsKICAvLyByZW1vdmUgdHJhbnNpdGlvbgogIHRoaXMuY3NzKCBjbGVhblRyYW5zaXRpb25TdHlsZSApOwp9OwoKLy8gLS0tLS0gc2hvdy9oaWRlL3JlbW92ZSAtLS0tLSAvLwoKLy8gcmVtb3ZlIGVsZW1lbnQgZnJvbSBET00KSXRlbS5wcm90b3R5cGUucmVtb3ZlRWxlbSA9IGZ1bmN0aW9uKCkgewogIHRoaXMuZWxlbWVudC5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKCB0aGlzLmVsZW1lbnQgKTsKICB0aGlzLmVtaXRFdmVudCggJ3JlbW92ZScsIFsgdGhpcyBdICk7Cn07CgpJdGVtLnByb3RvdHlwZS5yZW1vdmUgPSBmdW5jdGlvbigpIHsKICAvLyBqdXN0IHJlbW92ZSBlbGVtZW50IGlmIG5vIHRyYW5zaXRpb24gc3VwcG9ydCBvciBubyB0cmFuc2l0aW9uCiAgaWYgKCAhdHJhbnNpdGlvblByb3BlcnR5IHx8ICFwYXJzZUZsb2F0KCB0aGlzLmxheW91dC5vcHRpb25zLnRyYW5zaXRpb25EdXJhdGlvbiApICkgewogICAgdGhpcy5yZW1vdmVFbGVtKCk7CiAgICByZXR1cm47CiAgfQoKICAvLyBzdGFydCB0cmFuc2l0aW9uCiAgdmFyIF90aGlzID0gdGhpczsKICB0aGlzLm9uKCAndHJhbnNpdGlvbkVuZCcsIGZ1bmN0aW9uKCkgewogICAgX3RoaXMucmVtb3ZlRWxlbSgpOwogICAgcmV0dXJuIHRydWU7IC8vIGJpbmQgb25jZQogIH0pOwogIHRoaXMuaGlkZSgpOwp9OwoKSXRlbS5wcm90b3R5cGUucmV2ZWFsID0gZnVuY3Rpb24oKSB7CiAgZGVsZXRlIHRoaXMuaXNIaWRkZW47CiAgLy8gcmVtb3ZlIGRpc3BsYXk6IG5vbmUKICB0aGlzLmNzcyh7IGRpc3BsYXk6ICcnIH0pOwoKICB2YXIgb3B0aW9ucyA9IHRoaXMubGF5b3V0Lm9wdGlvbnM7CiAgdGhpcy50cmFuc2l0aW9uKHsKICAgIGZyb206IG9wdGlvbnMuaGlkZGVuU3R5bGUsCiAgICB0bzogb3B0aW9ucy52aXNpYmxlU3R5bGUsCiAgICBpc0NsZWFuaW5nOiB0cnVlCiAgfSk7Cn07CgpJdGVtLnByb3RvdHlwZS5oaWRlID0gZnVuY3Rpb24oKSB7CiAgLy8gc2V0IGZsYWcKICB0aGlzLmlzSGlkZGVuID0gdHJ1ZTsKICAvLyByZW1vdmUgZGlzcGxheTogbm9uZQogIHRoaXMuY3NzKHsgZGlzcGxheTogJycgfSk7CgogIHZhciBvcHRpb25zID0gdGhpcy5sYXlvdXQub3B0aW9uczsKICB0aGlzLnRyYW5zaXRpb24oewogICAgZnJvbTogb3B0aW9ucy52aXNpYmxlU3R5bGUsCiAgICB0bzogb3B0aW9ucy5oaWRkZW5TdHlsZSwKICAgIC8vIGtlZXAgaGlkZGVuIHN0dWZmIGhpZGRlbgogICAgaXNDbGVhbmluZzogdHJ1ZSwKICAgIG9uVHJhbnNpdGlvbkVuZDogewogICAgICBvcGFjaXR5OiBmdW5jdGlvbigpIHsKICAgICAgICAvLyBjaGVjayBpZiBzdGlsbCBoaWRkZW4KICAgICAgICAvLyBkdXJpbmcgdHJhbnNpdGlvbiwgaXRlbSBtYXkgaGF2ZSBiZWVuIHVuLWhpZGRlbgogICAgICAgIGlmICggdGhpcy5pc0hpZGRlbiApIHsKICAgICAgICAgIHRoaXMuY3NzKHsgZGlzcGxheTogJ25vbmUnIH0pOwogICAgICAgIH0KICAgICAgfQogICAgfQogIH0pOwp9OwoKSXRlbS5wcm90b3R5cGUuZGVzdHJveSA9IGZ1bmN0aW9uKCkgewogIHRoaXMuY3NzKHsKICAgIHBvc2l0aW9uOiAnJywKICAgIGxlZnQ6ICcnLAogICAgcmlnaHQ6ICcnLAogICAgdG9wOiAnJywKICAgIGJvdHRvbTogJycsCiAgICB0cmFuc2l0aW9uOiAnJywKICAgIHRyYW5zZm9ybTogJycKICB9KTsKfTsKCnJldHVybiBJdGVtOwoKfQoKLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gdHJhbnNwb3J0IC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tIC8vCgppZiAoIHR5cGVvZiBkZWZpbmUgPT09ICdmdW5jdGlvbicgJiYgZGVmaW5lLmFtZCApIHsKICAvLyBBTUQKICBkZWZpbmUoICdvdXRsYXllci9pdGVtJyxbCiAgICAgICdldmVudEVtaXR0ZXIvRXZlbnRFbWl0dGVyJywKICAgICAgJ2dldC1zaXplL2dldC1zaXplJywKICAgICAgJ2dldC1zdHlsZS1wcm9wZXJ0eS9nZXQtc3R5bGUtcHJvcGVydHknCiAgICBdLAogICAgb3V0bGF5ZXJJdGVtRGVmaW5pdGlvbiApOwp9IGVsc2UgewogIC8vIGJyb3dzZXIgZ2xvYmFsCiAgd2luZG93Lk91dGxheWVyID0ge307CiAgd2luZG93Lk91dGxheWVyLkl0ZW0gPSBvdXRsYXllckl0ZW1EZWZpbml0aW9uKAogICAgd2luZG93LkV2ZW50RW1pdHRlciwKICAgIHdpbmRvdy5nZXRTaXplLAogICAgd2luZG93LmdldFN0eWxlUHJvcGVydHkKICApOwp9Cgp9KSggd2luZG93ICk7CgovKiEKICogT3V0bGF5ZXIgdjEuMi4wCiAqIHRoZSBicmFpbnMgYW5kIGd1dHMgb2YgYSBsYXlvdXQgbGlicmFyeQogKiBNSVQgbGljZW5zZQogKi8KCiggZnVuY3Rpb24oIHdpbmRvdyApIHsKCgoKLy8gLS0tLS0gdmFycyAtLS0tLSAvLwoKdmFyIGRvY3VtZW50ID0gd2luZG93LmRvY3VtZW50Owp2YXIgY29uc29sZSA9IHdpbmRvdy5jb25zb2xlOwp2YXIgalF1ZXJ5ID0gd2luZG93LmpRdWVyeTsKCnZhciBub29wID0gZnVuY3Rpb24oKSB7fTsKCi8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tIGhlbHBlcnMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gLy8KCi8vIGV4dGVuZCBvYmplY3RzCmZ1bmN0aW9uIGV4dGVuZCggYSwgYiApIHsKICBmb3IgKCB2YXIgcHJvcCBpbiBiICkgewogICAgYVsgcHJvcCBdID0gYlsgcHJvcCBdOwogIH0KICByZXR1cm4gYTsKfQoKCnZhciBvYmpUb1N0cmluZyA9IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmc7CmZ1bmN0aW9uIGlzQXJyYXkoIG9iaiApIHsKICByZXR1cm4gb2JqVG9TdHJpbmcuY2FsbCggb2JqICkgPT09ICdbb2JqZWN0IEFycmF5XSc7Cn0KCi8vIHR1cm4gZWxlbWVudCBvciBub2RlTGlzdCBpbnRvIGFuIGFycmF5CmZ1bmN0aW9uIG1ha2VBcnJheSggb2JqICkgewogIHZhciBhcnkgPSBbXTsKICBpZiAoIGlzQXJyYXkoIG9iaiApICkgewogICAgLy8gdXNlIG9iamVjdCBpZiBhbHJlYWR5IGFuIGFycmF5CiAgICBhcnkgPSBvYmo7CiAgfSBlbHNlIGlmICggb2JqICYmIHR5cGVvZiBvYmoubGVuZ3RoID09PSAnbnVtYmVyJyApIHsKICAgIC8vIGNvbnZlcnQgbm9kZUxpc3QgdG8gYXJyYXkKICAgIGZvciAoIHZhciBpPTAsIGxlbiA9IG9iai5sZW5ndGg7IGkgPCBsZW47IGkrKyApIHsKICAgICAgYXJ5LnB1c2goIG9ialtpXSApOwogICAgfQogIH0gZWxzZSB7CiAgICAvLyBhcnJheSBvZiBzaW5nbGUgaW5kZXgKICAgIGFyeS5wdXNoKCBvYmogKTsKICB9CiAgcmV0dXJuIGFyeTsKfQoKLy8gaHR0cDovL3N0YWNrb3ZlcmZsb3cuY29tL2EvMzg0MzgwLzE4MjE4Mwp2YXIgaXNFbGVtZW50ID0gKCB0eXBlb2YgSFRNTEVsZW1lbnQgPT09ICdvYmplY3QnICkgPwogIGZ1bmN0aW9uIGlzRWxlbWVudERPTTIoIG9iaiApIHsKICAgIHJldHVybiBvYmogaW5zdGFuY2VvZiBIVE1MRWxlbWVudDsKICB9IDoKICBmdW5jdGlvbiBpc0VsZW1lbnRRdWlya3koIG9iaiApIHsKICAgIHJldHVybiBvYmogJiYgdHlwZW9mIG9iaiA9PT0gJ29iamVjdCcgJiYKICAgICAgb2JqLm5vZGVUeXBlID09PSAxICYmIHR5cGVvZiBvYmoubm9kZU5hbWUgPT09ICdzdHJpbmcnOwogIH07CgovLyBpbmRleCBvZiBoZWxwZXIgY2F1c2UgSUU4CnZhciBpbmRleE9mID0gQXJyYXkucHJvdG90eXBlLmluZGV4T2YgPyBmdW5jdGlvbiggYXJ5LCBvYmogKSB7CiAgICByZXR1cm4gYXJ5LmluZGV4T2YoIG9iaiApOwogIH0gOiBmdW5jdGlvbiggYXJ5LCBvYmogKSB7CiAgICBmb3IgKCB2YXIgaT0wLCBsZW4gPSBhcnkubGVuZ3RoOyBpIDwgbGVuOyBpKysgKSB7CiAgICAgIGlmICggYXJ5W2ldID09PSBvYmogKSB7CiAgICAgICAgcmV0dXJuIGk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiAtMTsKICB9OwoKZnVuY3Rpb24gcmVtb3ZlRnJvbSggb2JqLCBhcnkgKSB7CiAgdmFyIGluZGV4ID0gaW5kZXhPZiggYXJ5LCBvYmogKTsKICBpZiAoIGluZGV4ICE9PSAtMSApIHsKICAgIGFyeS5zcGxpY2UoIGluZGV4LCAxICk7CiAgfQp9CgovLyBodHRwOi8vamFtZXNyb2JlcnRzLm5hbWUvYmxvZy8yMDEwLzAyLzIyL3N0cmluZy1mdW5jdGlvbnMtZm9yLWphdmFzY3JpcHQtdHJpbS10by1jYW1lbC1jYXNlLXRvLWRhc2hlZC1hbmQtdG8tdW5kZXJzY29yZS8KZnVuY3Rpb24gdG9EYXNoZWQoIHN0ciApIHsKICByZXR1cm4gc3RyLnJlcGxhY2UoIC8oLikoW0EtWl0pL2csIGZ1bmN0aW9uKCBtYXRjaCwgJDEsICQyICkgewogICAgcmV0dXJuICQxICsgJy0nICsgJDI7CiAgfSkudG9Mb3dlckNhc2UoKTsKfQoKCmZ1bmN0aW9uIG91dGxheWVyRGVmaW5pdGlvbiggZXZlbnRpZSwgZG9jUmVhZHksIEV2ZW50RW1pdHRlciwgZ2V0U2l6ZSwgbWF0Y2hlc1NlbGVjdG9yLCBJdGVtICkgewoKLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gT3V0bGF5ZXIgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gLy8KCi8vIGdsb2JhbGx5IHVuaXF1ZSBpZGVudGlmaWVycwp2YXIgR1VJRCA9IDA7Ci8vIGludGVybmFsIHN0b3JlIG9mIGFsbCBPdXRsYXllciBpbnRhbmNlcwp2YXIgaW5zdGFuY2VzID0ge307CgoKLyoqCiAqIEBwYXJhbSB7RWxlbWVudCwgU3RyaW5nfSBlbGVtZW50CiAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zCiAqIEBjb25zdHJ1Y3RvcgogKi8KZnVuY3Rpb24gT3V0bGF5ZXIoIGVsZW1lbnQsIG9wdGlvbnMgKSB7CiAgLy8gdXNlIGVsZW1lbnQgYXMgc2VsZWN0b3Igc3RyaW5nCiAgaWYgKCB0eXBlb2YgZWxlbWVudCA9PT0gJ3N0cmluZycgKSB7CiAgICBlbGVtZW50ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvciggZWxlbWVudCApOwogIH0KCiAgLy8gYmFpbCBvdXQgaWYgbm90IHByb3BlciBlbGVtZW50CiAgaWYgKCAhZWxlbWVudCB8fCAhaXNFbGVtZW50KCBlbGVtZW50ICkgKSB7CiAgICBpZiAoIGNvbnNvbGUgKSB7CiAgICAgIGNvbnNvbGUuZXJyb3IoICdCYWQgJyArIHRoaXMuY29uc3RydWN0b3IubmFtZXNwYWNlICsgJyBlbGVtZW50OiAnICsgZWxlbWVudCApOwogICAgfQogICAgcmV0dXJuOwogIH0KCiAgdGhpcy5lbGVtZW50ID0gZWxlbWVudDsKCiAgLy8gb3B0aW9ucwogIHRoaXMub3B0aW9ucyA9IGV4dGVuZCgge30sIHRoaXMuY29uc3RydWN0b3IuZGVmYXVsdHMgKTsKICB0aGlzLm9wdGlvbiggb3B0aW9ucyApOwoKICAvLyBhZGQgaWQgZm9yIE91dGxheWVyLmdldEZyb21FbGVtZW50CiAgdmFyIGlkID0gKytHVUlEOwogIHRoaXMuZWxlbWVudC5vdXRsYXllckdVSUQgPSBpZDsgLy8gZXhwYW5kbwogIGluc3RhbmNlc1sgaWQgXSA9IHRoaXM7IC8vIGFzc29jaWF0ZSB2aWEgaWQKCiAgLy8ga2ljayBpdCBvZmYKICB0aGlzLl9jcmVhdGUoKTsKCiAgaWYgKCB0aGlzLm9wdGlvbnMuaXNJbml0TGF5b3V0ICkgewogICAgdGhpcy5sYXlvdXQoKTsKICB9Cn0KCi8vIHNldHRpbmdzIGFyZSBmb3IgaW50ZXJuYWwgdXNlIG9ubHkKT3V0bGF5ZXIubmFtZXNwYWNlID0gJ291dGxheWVyJzsKT3V0bGF5ZXIuSXRlbSA9IEl0ZW07CgovLyBkZWZhdWx0IG9wdGlvbnMKT3V0bGF5ZXIuZGVmYXVsdHMgPSB7CiAgY29udGFpbmVyU3R5bGU6IHsKICAgIHBvc2l0aW9uOiAncmVsYXRpdmUnCiAgfSwKICBpc0luaXRMYXlvdXQ6IHRydWUsCiAgaXNPcmlnaW5MZWZ0OiB0cnVlLAogIGlzT3JpZ2luVG9wOiB0cnVlLAogIGlzUmVzaXplQm91bmQ6IHRydWUsCiAgaXNSZXNpemluZ0NvbnRhaW5lcjogdHJ1ZSwKICAvLyBpdGVtIG9wdGlvbnMKICB0cmFuc2l0aW9uRHVyYXRpb246ICcwLjRzJywKICBoaWRkZW5TdHlsZTogewogICAgb3BhY2l0eTogMCwKICAgIHRyYW5zZm9ybTogJ3NjYWxlKDAuMDAxKScKICB9LAogIHZpc2libGVTdHlsZTogewogICAgb3BhY2l0eTogMSwKICAgIHRyYW5zZm9ybTogJ3NjYWxlKDEpJwogIH0KfTsKCi8vIGluaGVyaXQgRXZlbnRFbWl0dGVyCmV4dGVuZCggT3V0bGF5ZXIucHJvdG90eXBlLCBFdmVudEVtaXR0ZXIucHJvdG90eXBlICk7CgovKioKICogc2V0IG9wdGlvbnMKICogQHBhcmFtIHtPYmplY3R9IG9wdHMKICovCk91dGxheWVyLnByb3RvdHlwZS5vcHRpb24gPSBmdW5jdGlvbiggb3B0cyApIHsKICBleHRlbmQoIHRoaXMub3B0aW9ucywgb3B0cyApOwp9OwoKT3V0bGF5ZXIucHJvdG90eXBlLl9jcmVhdGUgPSBmdW5jdGlvbigpIHsKICAvLyBnZXQgaXRlbXMgZnJvbSBjaGlsZHJlbgogIHRoaXMucmVsb2FkSXRlbXMoKTsKICAvLyBlbGVtZW50cyB0aGF0IGFmZmVjdCBsYXlvdXQsIGJ1dCBhcmUgbm90IGxhaWQgb3V0CiAgdGhpcy5zdGFtcHMgPSBbXTsKICB0aGlzLnN0YW1wKCB0aGlzLm9wdGlvbnMuc3RhbXAgKTsKICAvLyBzZXQgY29udGFpbmVyIHN0eWxlCiAgZXh0ZW5kKCB0aGlzLmVsZW1lbnQuc3R5bGUsIHRoaXMub3B0aW9ucy5jb250YWluZXJTdHlsZSApOwoKICAvLyBiaW5kIHJlc2l6ZSBtZXRob2QKICBpZiAoIHRoaXMub3B0aW9ucy5pc1Jlc2l6ZUJvdW5kICkgewogICAgdGhpcy5iaW5kUmVzaXplKCk7CiAgfQp9OwoKLy8gZ29lcyB0aHJvdWdoIGFsbCBjaGlsZHJlbiBhZ2FpbiBhbmQgZ2V0cyBicmlja3MgaW4gcHJvcGVyIG9yZGVyCk91dGxheWVyLnByb3RvdHlwZS5yZWxvYWRJdGVtcyA9IGZ1bmN0aW9uKCkgewogIC8vIGNvbGxlY3Rpb24gb2YgaXRlbSBlbGVtZW50cwogIHRoaXMuaXRlbXMgPSB0aGlzLl9pdGVtaXplKCB0aGlzLmVsZW1lbnQuY2hpbGRyZW4gKTsKfTsKCgovKioKICogdHVybiBlbGVtZW50cyBpbnRvIE91dGxheWVyLkl0ZW1zIHRvIGJlIHVzZWQgaW4gbGF5b3V0CiAqIEBwYXJhbSB7QXJyYXkgb3IgTm9kZUxpc3Qgb3IgSFRNTEVsZW1lbnR9IGVsZW1zCiAqIEByZXR1cm5zIHtBcnJheX0gaXRlbXMgLSBjb2xsZWN0aW9uIG9mIG5ldyBPdXRsYXllciBJdGVtcwogKi8KT3V0bGF5ZXIucHJvdG90eXBlLl9pdGVtaXplID0gZnVuY3Rpb24oIGVsZW1zICkgewoKICB2YXIgaXRlbUVsZW1zID0gdGhpcy5fZmlsdGVyRmluZEl0ZW1FbGVtZW50cyggZWxlbXMgKTsKICB2YXIgSXRlbSA9IHRoaXMuY29uc3RydWN0b3IuSXRlbTsKCiAgLy8gY3JlYXRlIG5ldyBPdXRsYXllciBJdGVtcyBmb3IgY29sbGVjdGlvbgogIHZhciBpdGVtcyA9IFtdOwogIGZvciAoIHZhciBpPTAsIGxlbiA9IGl0ZW1FbGVtcy5sZW5ndGg7IGkgPCBsZW47IGkrKyApIHsKICAgIHZhciBlbGVtID0gaXRlbUVsZW1zW2ldOwogICAgdmFyIGl0ZW0gPSBuZXcgSXRlbSggZWxlbSwgdGhpcyApOwogICAgaXRlbXMucHVzaCggaXRlbSApOwogIH0KCiAgcmV0dXJuIGl0ZW1zOwp9OwoKLyoqCiAqIGdldCBpdGVtIGVsZW1lbnRzIHRvIGJlIHVzZWQgaW4gbGF5b3V0CiAqIEBwYXJhbSB7QXJyYXkgb3IgTm9kZUxpc3Qgb3IgSFRNTEVsZW1lbnR9IGVsZW1zCiAqIEByZXR1cm5zIHtBcnJheX0gaXRlbXMgLSBpdGVtIGVsZW1lbnRzCiAqLwpPdXRsYXllci5wcm90b3R5cGUuX2ZpbHRlckZpbmRJdGVtRWxlbWVudHMgPSBmdW5jdGlvbiggZWxlbXMgKSB7CiAgLy8gbWFrZSBhcnJheSBvZiBlbGVtcwogIGVsZW1zID0gbWFrZUFycmF5KCBlbGVtcyApOwogIHZhciBpdGVtU2VsZWN0b3IgPSB0aGlzLm9wdGlvbnMuaXRlbVNlbGVjdG9yOwogIHZhciBpdGVtRWxlbXMgPSBbXTsKCiAgZm9yICggdmFyIGk9MCwgbGVuID0gZWxlbXMubGVuZ3RoOyBpIDwgbGVuOyBpKysgKSB7CiAgICB2YXIgZWxlbSA9IGVsZW1zW2ldOwogICAgLy8gY2hlY2sgdGhhdCBlbGVtIGlzIGFuIGFjdHVhbCBlbGVtZW50CiAgICBpZiAoICFpc0VsZW1lbnQoIGVsZW0gKSApIHsKICAgICAgY29udGludWU7CiAgICB9CiAgICAvLyBmaWx0ZXIgJiBmaW5kIGl0ZW1zIGlmIHdlIGhhdmUgYW4gaXRlbSBzZWxlY3RvcgogICAgaWYgKCBpdGVtU2VsZWN0b3IgKSB7CiAgICAgIC8vIGZpbHRlciBzaWJsaW5ncwogICAgICBpZiAoIG1hdGNoZXNTZWxlY3RvciggZWxlbSwgaXRlbVNlbGVjdG9yICkgKSB7CiAgICAgICAgaXRlbUVsZW1zLnB1c2goIGVsZW0gKTsKICAgICAgfQogICAgICAvLyBmaW5kIGNoaWxkcmVuCiAgICAgIHZhciBjaGlsZEVsZW1zID0gZWxlbS5xdWVyeVNlbGVjdG9yQWxsKCBpdGVtU2VsZWN0b3IgKTsKICAgICAgLy8gY29uY2F0IGNoaWxkRWxlbXMgdG8gZmlsdGVyRm91bmQgYXJyYXkKICAgICAgZm9yICggdmFyIGo9MCwgakxlbiA9IGNoaWxkRWxlbXMubGVuZ3RoOyBqIDwgakxlbjsgaisrICkgewogICAgICAgIGl0ZW1FbGVtcy5wdXNoKCBjaGlsZEVsZW1zW2pdICk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGl0ZW1FbGVtcy5wdXNoKCBlbGVtICk7CiAgICB9CiAgfQoKICByZXR1cm4gaXRlbUVsZW1zOwp9OwoKLyoqCiAqIGdldHRlciBtZXRob2QgZm9yIGdldHRpbmcgaXRlbSBlbGVtZW50cwogKiBAcmV0dXJucyB7QXJyYXl9IGVsZW1zIC0gY29sbGVjdGlvbiBvZiBpdGVtIGVsZW1lbnRzCiAqLwpPdXRsYXllci5wcm90b3R5cGUuZ2V0SXRlbUVsZW1lbnRzID0gZnVuY3Rpb24oKSB7CiAgdmFyIGVsZW1zID0gW107CiAgZm9yICggdmFyIGk9MCwgbGVuID0gdGhpcy5pdGVtcy5sZW5ndGg7IGkgPCBsZW47IGkrKyApIHsKICAgIGVsZW1zLnB1c2goIHRoaXMuaXRlbXNbaV0uZWxlbWVudCApOwogIH0KICByZXR1cm4gZWxlbXM7Cn07CgovLyAtLS0tLSBpbml0ICYgbGF5b3V0IC0tLS0tIC8vCgovKioKICogbGF5cyBvdXQgYWxsIGl0ZW1zCiAqLwpPdXRsYXllci5wcm90b3R5cGUubGF5b3V0ID0gZnVuY3Rpb24oKSB7CiAgdGhpcy5fcmVzZXRMYXlvdXQoKTsKICB0aGlzLl9tYW5hZ2VTdGFtcHMoKTsKCiAgLy8gZG9uJ3QgYW5pbWF0ZSBmaXJzdCBsYXlvdXQKICB2YXIgaXNJbnN0YW50ID0gdGhpcy5vcHRpb25zLmlzTGF5b3V0SW5zdGFudCAhPT0gdW5kZWZpbmVkID8KICAgIHRoaXMub3B0aW9ucy5pc0xheW91dEluc3RhbnQgOiAhdGhpcy5faXNMYXlvdXRJbml0ZWQ7CiAgdGhpcy5sYXlvdXRJdGVtcyggdGhpcy5pdGVtcywgaXNJbnN0YW50ICk7CgogIC8vIGZsYWcgZm9yIGluaXRhbGl6ZWQKICB0aGlzLl9pc0xheW91dEluaXRlZCA9IHRydWU7Cn07CgovLyBfaW5pdCBpcyBhbGlhcyBmb3IgbGF5b3V0Ck91dGxheWVyLnByb3RvdHlwZS5faW5pdCA9IE91dGxheWVyLnByb3RvdHlwZS5sYXlvdXQ7CgovKioKICogbG9naWMgYmVmb3JlIGFueSBuZXcgbGF5b3V0CiAqLwpPdXRsYXllci5wcm90b3R5cGUuX3Jlc2V0TGF5b3V0ID0gZnVuY3Rpb24oKSB7CiAgdGhpcy5nZXRTaXplKCk7Cn07CgoKT3V0bGF5ZXIucHJvdG90eXBlLmdldFNpemUgPSBmdW5jdGlvbigpIHsKICB0aGlzLnNpemUgPSBnZXRTaXplKCB0aGlzLmVsZW1lbnQgKTsKfTsKCi8qKgogKiBnZXQgbWVhc3VyZW1lbnQgZnJvbSBvcHRpb24sIGZvciBjb2x1bW5XaWR0aCwgcm93SGVpZ2h0LCBndXR0ZXIKICogaWYgb3B0aW9uIGlzIFN0cmluZyAtPiBnZXQgZWxlbWVudCBmcm9tIHNlbGVjdG9yIHN0cmluZywgJiBnZXQgc2l6ZSBvZiBlbGVtZW50CiAqIGlmIG9wdGlvbiBpcyBFbGVtZW50IC0+IGdldCBzaXplIG9mIGVsZW1lbnQKICogZWxzZSB1c2Ugb3B0aW9uIGFzIGEgbnVtYmVyCiAqCiAqIEBwYXJhbSB7U3RyaW5nfSBtZWFzdXJlbWVudAogKiBAcGFyYW0ge1N0cmluZ30gc2l6ZSAtIHdpZHRoIG9yIGhlaWdodAogKiBAcHJpdmF0ZQogKi8KT3V0bGF5ZXIucHJvdG90eXBlLl9nZXRNZWFzdXJlbWVudCA9IGZ1bmN0aW9uKCBtZWFzdXJlbWVudCwgc2l6ZSApIHsKICB2YXIgb3B0aW9uID0gdGhpcy5vcHRpb25zWyBtZWFzdXJlbWVudCBdOwogIHZhciBlbGVtOwogIGlmICggIW9wdGlvbiApIHsKICAgIC8vIGRlZmF1bHQgdG8gMAogICAgdGhpc1sgbWVhc3VyZW1lbnQgXSA9IDA7CiAgfSBlbHNlIHsKICAgIC8vIHVzZSBvcHRpb24gYXMgYW4gZWxlbWVudAogICAgaWYgKCB0eXBlb2Ygb3B0aW9uID09PSAnc3RyaW5nJyApIHsKICAgICAgZWxlbSA9IHRoaXMuZWxlbWVudC5xdWVyeVNlbGVjdG9yKCBvcHRpb24gKTsKICAgIH0gZWxzZSBpZiAoIGlzRWxlbWVudCggb3B0aW9uICkgKSB7CiAgICAgIGVsZW0gPSBvcHRpb247CiAgICB9CiAgICAvLyB1c2Ugc2l6ZSBvZiBlbGVtZW50LCBpZiBlbGVtZW50CiAgICB0aGlzWyBtZWFzdXJlbWVudCBdID0gZWxlbSA/IGdldFNpemUoIGVsZW0gKVsgc2l6ZSBdIDogb3B0aW9uOwogIH0KfTsKCi8qKgogKiBsYXlvdXQgYSBjb2xsZWN0aW9uIG9mIGl0ZW0gZWxlbWVudHMKICogQGFwaSBwdWJsaWMKICovCk91dGxheWVyLnByb3RvdHlwZS5sYXlvdXRJdGVtcyA9IGZ1bmN0aW9uKCBpdGVtcywgaXNJbnN0YW50ICkgewogIGl0ZW1zID0gdGhpcy5fZ2V0SXRlbXNGb3JMYXlvdXQoIGl0ZW1zICk7CgogIHRoaXMuX2xheW91dEl0ZW1zKCBpdGVtcywgaXNJbnN0YW50ICk7CgogIHRoaXMuX3Bvc3RMYXlvdXQoKTsKfTsKCi8qKgogKiBnZXQgdGhlIGl0ZW1zIHRvIGJlIGxhaWQgb3V0CiAqIHlvdSBtYXkgd2FudCB0byBza2lwIG92ZXIgc29tZSBpdGVtcwogKiBAcGFyYW0ge0FycmF5fSBpdGVtcwogKiBAcmV0dXJucyB7QXJyYXl9IGl0ZW1zCiAqLwpPdXRsYXllci5wcm90b3R5cGUuX2dldEl0ZW1zRm9yTGF5b3V0ID0gZnVuY3Rpb24oIGl0ZW1zICkgewogIHZhciBsYXlvdXRJdGVtcyA9IFtdOwogIGZvciAoIHZhciBpPTAsIGxlbiA9IGl0ZW1zLmxlbmd0aDsgaSA8IGxlbjsgaSsrICkgewogICAgdmFyIGl0ZW0gPSBpdGVtc1tpXTsKICAgIGlmICggIWl0ZW0uaXNJZ25vcmVkICkgewogICAgICBsYXlvdXRJdGVtcy5wdXNoKCBpdGVtICk7CiAgICB9CiAgfQogIHJldHVybiBsYXlvdXRJdGVtczsKfTsKCi8qKgogKiBsYXlvdXQgaXRlbXMKICogQHBhcmFtIHtBcnJheX0gaXRlbXMKICogQHBhcmFtIHtCb29sZWFufSBpc0luc3RhbnQKICovCk91dGxheWVyLnByb3RvdHlwZS5fbGF5b3V0SXRlbXMgPSBmdW5jdGlvbiggaXRlbXMsIGlzSW5zdGFudCApIHsKICB2YXIgX3RoaXMgPSB0aGlzOwogIGZ1bmN0aW9uIG9uSXRlbXNMYXlvdXQoKSB7CiAgICBfdGhpcy5lbWl0RXZlbnQoICdsYXlvdXRDb21wbGV0ZScsIFsgX3RoaXMsIGl0ZW1zIF0gKTsKICB9CgogIGlmICggIWl0ZW1zIHx8ICFpdGVtcy5sZW5ndGggKSB7CiAgICAvLyBubyBpdGVtcywgZW1pdCBldmVudCB3aXRoIGVtcHR5IGFycmF5CiAgICBvbkl0ZW1zTGF5b3V0KCk7CiAgICByZXR1cm47CiAgfQoKICAvLyBlbWl0IGxheW91dENvbXBsZXRlIHdoZW4gZG9uZQogIHRoaXMuX2l0ZW1zT24oIGl0ZW1zLCAnbGF5b3V0Jywgb25JdGVtc0xheW91dCApOwoKICB2YXIgcXVldWUgPSBbXTsKCiAgZm9yICggdmFyIGk9MCwgbGVuID0gaXRlbXMubGVuZ3RoOyBpIDwgbGVuOyBpKysgKSB7CiAgICB2YXIgaXRlbSA9IGl0ZW1zW2ldOwogICAgLy8gZ2V0IHgveSBvYmplY3QgZnJvbSBtZXRob2QKICAgIHZhciBwb3NpdGlvbiA9IHRoaXMuX2dldEl0ZW1MYXlvdXRQb3NpdGlvbiggaXRlbSApOwogICAgLy8gZW5xdWV1ZQogICAgcG9zaXRpb24uaXRlbSA9IGl0ZW07CiAgICBwb3NpdGlvbi5pc0luc3RhbnQgPSBpc0luc3RhbnQgfHwgaXRlbS5pc0xheW91dEluc3RhbnQ7CiAgICBxdWV1ZS5wdXNoKCBwb3NpdGlvbiApOwogIH0KCiAgdGhpcy5fcHJvY2Vzc0xheW91dFF1ZXVlKCBxdWV1ZSApOwp9OwoKLyoqCiAqIGdldCBpdGVtIGxheW91dCBwb3NpdGlvbgogKiBAcGFyYW0ge091dGxheWVyLkl0ZW19IGl0ZW0KICogQHJldHVybnMge09iamVjdH0geCBhbmQgeSBwb3NpdGlvbgogKi8KT3V0bGF5ZXIucHJvdG90eXBlLl9nZXRJdGVtTGF5b3V0UG9zaXRpb24gPSBmdW5jdGlvbiggLyogaXRlbSAqLyApIHsKICByZXR1cm4gewogICAgeDogMCwKICAgIHk6IDAKICB9Owp9OwoKLyoqCiAqIGl0ZXJhdGUgb3ZlciBhcnJheSBhbmQgcG9zaXRpb24gZWFjaCBpdGVtCiAqIFJlYXNvbiBiZWluZyAtIHNlcGFyYXRpbmcgdGhpcyBsb2dpYyBwcmV2ZW50cyAnbGF5b3V0IGludmFsaWRhdGlvbicKICogdGh4IEBwYXVsX2lyaXNoCiAqIEBwYXJhbSB7QXJyYXl9IHF1ZXVlCiAqLwpPdXRsYXllci5wcm90b3R5cGUuX3Byb2Nlc3NMYXlvdXRRdWV1ZSA9IGZ1bmN0aW9uKCBxdWV1ZSApIHsKICBmb3IgKCB2YXIgaT0wLCBsZW4gPSBxdWV1ZS5sZW5ndGg7IGkgPCBsZW47IGkrKyApIHsKICAgIHZhciBvYmogPSBxdWV1ZVtpXTsKICAgIHRoaXMuX3Bvc2l0aW9uSXRlbSggb2JqLml0ZW0sIG9iai54LCBvYmoueSwgb2JqLmlzSW5zdGFudCApOwogIH0KfTsKCi8qKgogKiBTZXRzIHBvc2l0aW9uIG9mIGl0ZW0gaW4gRE9NCiAqIEBwYXJhbSB7T3V0bGF5ZXIuSXRlbX0gaXRlbQogKiBAcGFyYW0ge051bWJlcn0geCAtIGhvcml6b250YWwgcG9zaXRpb24KICogQHBhcmFtIHtOdW1iZXJ9IHkgLSB2ZXJ0aWNhbCBwb3NpdGlvbgogKiBAcGFyYW0ge0Jvb2xlYW59IGlzSW5zdGFudCAtIGRpc2FibGVzIHRyYW5zaXRpb25zCiAqLwpPdXRsYXllci5wcm90b3R5cGUuX3Bvc2l0aW9uSXRlbSA9IGZ1bmN0aW9uKCBpdGVtLCB4LCB5LCBpc0luc3RhbnQgKSB7CiAgaWYgKCBpc0luc3RhbnQgKSB7CiAgICAvLyBpZiBub3QgdHJhbnNpdGlvbiwganVzdCBzZXQgQ1NTCiAgICBpdGVtLmdvVG8oIHgsIHkgKTsKICB9IGVsc2UgewogICAgaXRlbS5tb3ZlVG8oIHgsIHkgKTsKICB9Cn07CgovKioKICogQW55IGxvZ2ljIHlvdSB3YW50IHRvIGRvIGFmdGVyIGVhY2ggbGF5b3V0LAogKiBpLmUuIHNpemUgdGhlIGNvbnRhaW5lcgogKi8KT3V0bGF5ZXIucHJvdG90eXBlLl9wb3N0TGF5b3V0ID0gZnVuY3Rpb24oKSB7CiAgdGhpcy5yZXNpemVDb250YWluZXIoKTsKfTsKCk91dGxheWVyLnByb3RvdHlwZS5yZXNpemVDb250YWluZXIgPSBmdW5jdGlvbigpIHsKICBpZiAoICF0aGlzLm9wdGlvbnMuaXNSZXNpemluZ0NvbnRhaW5lciApIHsKICAgIHJldHVybjsKICB9CiAgdmFyIHNpemUgPSB0aGlzLl9nZXRDb250YWluZXJTaXplKCk7CiAgaWYgKCBzaXplICkgewogICAgdGhpcy5fc2V0Q29udGFpbmVyTWVhc3VyZSggc2l6ZS53aWR0aCwgdHJ1ZSApOwogICAgdGhpcy5fc2V0Q29udGFpbmVyTWVhc3VyZSggc2l6ZS5oZWlnaHQsIGZhbHNlICk7CiAgfQp9OwoKLyoqCiAqIFNldHMgd2lkdGggb3IgaGVpZ2h0IG9mIGNvbnRhaW5lciBpZiByZXR1cm5lZAogKiBAcmV0dXJucyB7T2JqZWN0fSBzaXplCiAqICAgQHBhcmFtIHtOdW1iZXJ9IHdpZHRoCiAqICAgQHBhcmFtIHtOdW1iZXJ9IGhlaWdodAogKi8KT3V0bGF5ZXIucHJvdG90eXBlLl9nZXRDb250YWluZXJTaXplID0gbm9vcDsKCi8qKgogKiBAcGFyYW0ge051bWJlcn0gbWVhc3VyZSAtIHNpemUgb2Ygd2lkdGggb3IgaGVpZ2h0CiAqIEBwYXJhbSB7Qm9vbGVhbn0gaXNXaWR0aAogKi8KT3V0bGF5ZXIucHJvdG90eXBlLl9zZXRDb250YWluZXJNZWFzdXJlID0gZnVuY3Rpb24oIG1lYXN1cmUsIGlzV2lkdGggKSB7CiAgaWYgKCBtZWFzdXJlID09PSB1bmRlZmluZWQgKSB7CiAgICByZXR1cm47CiAgfQoKICB2YXIgZWxlbVNpemUgPSB0aGlzLnNpemU7CiAgLy8gYWRkIHBhZGRpbmcgYW5kIGJvcmRlciB3aWR0aCBpZiBib3JkZXIgYm94CiAgaWYgKCBlbGVtU2l6ZS5pc0JvcmRlckJveCApIHsKICAgIG1lYXN1cmUgKz0gaXNXaWR0aCA/IGVsZW1TaXplLnBhZGRpbmdMZWZ0ICsgZWxlbVNpemUucGFkZGluZ1JpZ2h0ICsKICAgICAgZWxlbVNpemUuYm9yZGVyTGVmdFdpZHRoICsgZWxlbVNpemUuYm9yZGVyUmlnaHRXaWR0aCA6CiAgICAgIGVsZW1TaXplLnBhZGRpbmdCb3R0b20gKyBlbGVtU2l6ZS5wYWRkaW5nVG9wICsKICAgICAgZWxlbVNpemUuYm9yZGVyVG9wV2lkdGggKyBlbGVtU2l6ZS5ib3JkZXJCb3R0b21XaWR0aDsKICB9CgogIG1lYXN1cmUgPSBNYXRoLm1heCggbWVhc3VyZSwgMCApOwogIHRoaXMuZWxlbWVudC5zdHlsZVsgaXNXaWR0aCA/ICd3aWR0aCcgOiAnaGVpZ2h0JyBdID0gbWVhc3VyZSArICdweCc7Cn07CgovKioKICogdHJpZ2dlciBhIGNhbGxiYWNrIGZvciBhIGNvbGxlY3Rpb24gb2YgaXRlbXMgZXZlbnRzCiAqIEBwYXJhbSB7QXJyYXl9IGl0ZW1zIC0gT3V0bGF5ZXIuSXRlbXMKICogQHBhcmFtIHtTdHJpbmd9IGV2ZW50TmFtZQogKiBAcGFyYW0ge0Z1bmN0aW9ufSBjYWxsYmFjawogKi8KT3V0bGF5ZXIucHJvdG90eXBlLl9pdGVtc09uID0gZnVuY3Rpb24oIGl0ZW1zLCBldmVudE5hbWUsIGNhbGxiYWNrICkgewogIHZhciBkb25lQ291bnQgPSAwOwogIHZhciBjb3VudCA9IGl0ZW1zLmxlbmd0aDsKICAvLyBldmVudCBjYWxsYmFjawogIHZhciBfdGhpcyA9IHRoaXM7CiAgZnVuY3Rpb24gdGljaygpIHsKICAgIGRvbmVDb3VudCsrOwogICAgaWYgKCBkb25lQ291bnQgPT09IGNvdW50ICkgewogICAgICBjYWxsYmFjay5jYWxsKCBfdGhpcyApOwogICAgfQogICAgcmV0dXJuIHRydWU7IC8vIGJpbmQgb25jZQogIH0KICAvLyBiaW5kIGNhbGxiYWNrCiAgZm9yICggdmFyIGk9MCwgbGVuID0gaXRlbXMubGVuZ3RoOyBpIDwgbGVuOyBpKysgKSB7CiAgICB2YXIgaXRlbSA9IGl0ZW1zW2ldOwogICAgaXRlbS5vbiggZXZlbnROYW1lLCB0aWNrICk7CiAgfQp9OwoKLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gaWdub3JlICYgc3RhbXBzIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tIC8vCgoKLyoqCiAqIGtlZXAgaXRlbSBpbiBjb2xsZWN0aW9uLCBidXQgZG8gbm90IGxheSBpdCBvdXQKICogaWdub3JlZCBpdGVtcyBkbyBub3QgZ2V0IHNraXBwZWQgaW4gbGF5b3V0CiAqIEBwYXJhbSB7RWxlbWVudH0gZWxlbQogKi8KT3V0bGF5ZXIucHJvdG90eXBlLmlnbm9yZSA9IGZ1bmN0aW9uKCBlbGVtICkgewogIHZhciBpdGVtID0gdGhpcy5nZXRJdGVtKCBlbGVtICk7CiAgaWYgKCBpdGVtICkgewogICAgaXRlbS5pc0lnbm9yZWQgPSB0cnVlOwogIH0KfTsKCi8qKgogKiByZXR1cm4gaXRlbSB0byBsYXlvdXQgY29sbGVjdGlvbgogKiBAcGFyYW0ge0VsZW1lbnR9IGVsZW0KICovCk91dGxheWVyLnByb3RvdHlwZS51bmlnbm9yZSA9IGZ1bmN0aW9uKCBlbGVtICkgewogIHZhciBpdGVtID0gdGhpcy5nZXRJdGVtKCBlbGVtICk7CiAgaWYgKCBpdGVtICkgewogICAgZGVsZXRlIGl0ZW0uaXNJZ25vcmVkOwogIH0KfTsKCi8qKgogKiBhZGRzIGVsZW1lbnRzIHRvIHN0YW1wcwogKiBAcGFyYW0ge05vZGVMaXN0LCBBcnJheSwgRWxlbWVudCwgb3IgU3RyaW5nfSBlbGVtcwogKi8KT3V0bGF5ZXIucHJvdG90eXBlLnN0YW1wID0gZnVuY3Rpb24oIGVsZW1zICkgewogIGVsZW1zID0gdGhpcy5fZmluZCggZWxlbXMgKTsKICBpZiAoICFlbGVtcyApIHsKICAgIHJldHVybjsKICB9CgogIHRoaXMuc3RhbXBzID0gdGhpcy5zdGFtcHMuY29uY2F0KCBlbGVtcyApOwogIC8vIGlnbm9yZQogIGZvciAoIHZhciBpPTAsIGxlbiA9IGVsZW1zLmxlbmd0aDsgaSA8IGxlbjsgaSsrICkgewogICAgdmFyIGVsZW0gPSBlbGVtc1tpXTsKICAgIHRoaXMuaWdub3JlKCBlbGVtICk7CiAgfQp9OwoKLyoqCiAqIHJlbW92ZXMgZWxlbWVudHMgdG8gc3RhbXBzCiAqIEBwYXJhbSB7Tm9kZUxpc3QsIEFycmF5LCBvciBFbGVtZW50fSBlbGVtcwogKi8KT3V0bGF5ZXIucHJvdG90eXBlLnVuc3RhbXAgPSBmdW5jdGlvbiggZWxlbXMgKSB7CiAgZWxlbXMgPSB0aGlzLl9maW5kKCBlbGVtcyApOwogIGlmICggIWVsZW1zICl7CiAgICByZXR1cm47CiAgfQoKICBmb3IgKCB2YXIgaT0wLCBsZW4gPSBlbGVtcy5sZW5ndGg7IGkgPCBsZW47IGkrKyApIHsKICAgIHZhciBlbGVtID0gZWxlbXNbaV07CiAgICAvLyBmaWx0ZXIgb3V0IHJlbW92ZWQgc3RhbXAgZWxlbWVudHMKICAgIHJlbW92ZUZyb20oIGVsZW0sIHRoaXMuc3RhbXBzICk7CiAgICB0aGlzLnVuaWdub3JlKCBlbGVtICk7CiAgfQoKfTsKCi8qKgogKiBmaW5kcyBjaGlsZCBlbGVtZW50cwogKiBAcGFyYW0ge05vZGVMaXN0LCBBcnJheSwgRWxlbWVudCwgb3IgU3RyaW5nfSBlbGVtcwogKiBAcmV0dXJucyB7QXJyYXl9IGVsZW1zCiAqLwpPdXRsYXllci5wcm90b3R5cGUuX2ZpbmQgPSBmdW5jdGlvbiggZWxlbXMgKSB7CiAgaWYgKCAhZWxlbXMgKSB7CiAgICByZXR1cm47CiAgfQogIC8vIGlmIHN0cmluZywgdXNlIGFyZ3VtZW50IGFzIHNlbGVjdG9yIHN0cmluZwogIGlmICggdHlwZW9mIGVsZW1zID09PSAnc3RyaW5nJyApIHsKICAgIGVsZW1zID0gdGhpcy5lbGVtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoIGVsZW1zICk7CiAgfQogIGVsZW1zID0gbWFrZUFycmF5KCBlbGVtcyApOwogIHJldHVybiBlbGVtczsKfTsKCk91dGxheWVyLnByb3RvdHlwZS5fbWFuYWdlU3RhbXBzID0gZnVuY3Rpb24oKSB7CiAgaWYgKCAhdGhpcy5zdGFtcHMgfHwgIXRoaXMuc3RhbXBzLmxlbmd0aCApIHsKICAgIHJldHVybjsKICB9CgogIHRoaXMuX2dldEJvdW5kaW5nUmVjdCgpOwoKICBmb3IgKCB2YXIgaT0wLCBsZW4gPSB0aGlzLnN0YW1wcy5sZW5ndGg7IGkgPCBsZW47IGkrKyApIHsKICAgIHZhciBzdGFtcCA9IHRoaXMuc3RhbXBzW2ldOwogICAgdGhpcy5fbWFuYWdlU3RhbXAoIHN0YW1wICk7CiAgfQp9OwoKLy8gdXBkYXRlIGJvdW5kaW5nTGVmdCAvIFRvcApPdXRsYXllci5wcm90b3R5cGUuX2dldEJvdW5kaW5nUmVjdCA9IGZ1bmN0aW9uKCkgewogIC8vIGdldCBib3VuZGluZyByZWN0IGZvciBjb250YWluZXIgZWxlbWVudAogIHZhciBib3VuZGluZ1JlY3QgPSB0aGlzLmVsZW1lbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CiAgdmFyIHNpemUgPSB0aGlzLnNpemU7CiAgdGhpcy5fYm91bmRpbmdSZWN0ID0gewogICAgbGVmdDogYm91bmRpbmdSZWN0LmxlZnQgKyBzaXplLnBhZGRpbmdMZWZ0ICsgc2l6ZS5ib3JkZXJMZWZ0V2lkdGgsCiAgICB0b3A6IGJvdW5kaW5nUmVjdC50b3AgKyBzaXplLnBhZGRpbmdUb3AgKyBzaXplLmJvcmRlclRvcFdpZHRoLAogICAgcmlnaHQ6IGJvdW5kaW5nUmVjdC5yaWdodCAtICggc2l6ZS5wYWRkaW5nUmlnaHQgKyBzaXplLmJvcmRlclJpZ2h0V2lkdGggKSwKICAgIGJvdHRvbTogYm91bmRpbmdSZWN0LmJvdHRvbSAtICggc2l6ZS5wYWRkaW5nQm90dG9tICsgc2l6ZS5ib3JkZXJCb3R0b21XaWR0aCApCiAgfTsKfTsKCi8qKgogKiBAcGFyYW0ge0VsZW1lbnR9IHN0YW1wCioqLwpPdXRsYXllci5wcm90b3R5cGUuX21hbmFnZVN0YW1wID0gbm9vcDsKCi8qKgogKiBnZXQgeC95IHBvc2l0aW9uIG9mIGVsZW1lbnQgcmVsYXRpdmUgdG8gY29udGFpbmVyIGVsZW1lbnQKICogQHBhcmFtIHtFbGVtZW50fSBlbGVtCiAqIEByZXR1cm5zIHtPYmplY3R9IG9mZnNldCAtIGhhcyBsZWZ0LCB0b3AsIHJpZ2h0LCBib3R0b20KICovCk91dGxheWVyLnByb3RvdHlwZS5fZ2V0RWxlbWVudE9mZnNldCA9IGZ1bmN0aW9uKCBlbGVtICkgewogIHZhciBib3VuZGluZ1JlY3QgPSBlbGVtLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwogIHZhciB0aGlzUmVjdCA9IHRoaXMuX2JvdW5kaW5nUmVjdDsKICB2YXIgc2l6ZSA9IGdldFNpemUoIGVsZW0gKTsKICB2YXIgb2Zmc2V0ID0gewogICAgbGVmdDogYm91bmRpbmdSZWN0LmxlZnQgLSB0aGlzUmVjdC5sZWZ0IC0gc2l6ZS5tYXJnaW5MZWZ0LAogICAgdG9wOiBib3VuZGluZ1JlY3QudG9wIC0gdGhpc1JlY3QudG9wIC0gc2l6ZS5tYXJnaW5Ub3AsCiAgICByaWdodDogdGhpc1JlY3QucmlnaHQgLSBib3VuZGluZ1JlY3QucmlnaHQgLSBzaXplLm1hcmdpblJpZ2h0LAogICAgYm90dG9tOiB0aGlzUmVjdC5ib3R0b20gLSBib3VuZGluZ1JlY3QuYm90dG9tIC0gc2l6ZS5tYXJnaW5Cb3R0b20KICB9OwogIHJldHVybiBvZmZzZXQ7Cn07CgovLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSByZXNpemUgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gLy8KCi8vIGVuYWJsZSBldmVudCBoYW5kbGVycyBmb3IgbGlzdGVuZXJzCi8vIGkuZS4gcmVzaXplIC0+IG9ucmVzaXplCk91dGxheWVyLnByb3RvdHlwZS5oYW5kbGVFdmVudCA9IGZ1bmN0aW9uKCBldmVudCApIHsKICB2YXIgbWV0aG9kID0gJ29uJyArIGV2ZW50LnR5cGU7CiAgaWYgKCB0aGlzWyBtZXRob2QgXSApIHsKICAgIHRoaXNbIG1ldGhvZCBdKCBldmVudCApOwogIH0KfTsKCi8qKgogKiBCaW5kIGxheW91dCB0byB3aW5kb3cgcmVzaXppbmcKICovCk91dGxheWVyLnByb3RvdHlwZS5iaW5kUmVzaXplID0gZnVuY3Rpb24oKSB7CiAgLy8gYmluZCBqdXN0IG9uZSBsaXN0ZW5lcgogIGlmICggdGhpcy5pc1Jlc2l6ZUJvdW5kICkgewogICAgcmV0dXJuOwogIH0KICBldmVudGllLmJpbmQoIHdpbmRvdywgJ3Jlc2l6ZScsIHRoaXMgKTsKICB0aGlzLmlzUmVzaXplQm91bmQgPSB0cnVlOwp9OwoKLyoqCiAqIFVuYmluZCBsYXlvdXQgdG8gd2luZG93IHJlc2l6aW5nCiAqLwpPdXRsYXllci5wcm90b3R5cGUudW5iaW5kUmVzaXplID0gZnVuY3Rpb24oKSB7CiAgaWYgKCB0aGlzLmlzUmVzaXplQm91bmQgKSB7CiAgICBldmVudGllLnVuYmluZCggd2luZG93LCAncmVzaXplJywgdGhpcyApOwogIH0KICB0aGlzLmlzUmVzaXplQm91bmQgPSBmYWxzZTsKfTsKCi8vIG9yaWdpbmFsIGRlYm91bmNlIGJ5IEpvaG4gSGFubgovLyBodHRwOi8vdW5zY3JpcHRhYmxlLmNvbS9pbmRleC5waHAvMjAwOS8wMy8yMC9kZWJvdW5jaW5nLWphdmFzY3JpcHQtbWV0aG9kcy8KCi8vIHRoaXMgZmlyZXMgZXZlcnkgcmVzaXplCk91dGxheWVyLnByb3RvdHlwZS5vbnJlc2l6ZSA9IGZ1bmN0aW9uKCkgewogIGlmICggdGhpcy5yZXNpemVUaW1lb3V0ICkgewogICAgY2xlYXJUaW1lb3V0KCB0aGlzLnJlc2l6ZVRpbWVvdXQgKTsKICB9CgogIHZhciBfdGhpcyA9IHRoaXM7CiAgZnVuY3Rpb24gZGVsYXllZCgpIHsKICAgIF90aGlzLnJlc2l6ZSgpOwogICAgZGVsZXRlIF90aGlzLnJlc2l6ZVRpbWVvdXQ7CiAgfQoKICB0aGlzLnJlc2l6ZVRpbWVvdXQgPSBzZXRUaW1lb3V0KCBkZWxheWVkLCAxMDAgKTsKfTsKCi8vIGRlYm91bmNlZCwgbGF5b3V0IG9uIHJlc2l6ZQpPdXRsYXllci5wcm90b3R5cGUucmVzaXplID0gZnVuY3Rpb24oKSB7CiAgLy8gZG9uJ3QgdHJpZ2dlciBpZiBzaXplIGRpZCBub3QgY2hhbmdlCiAgLy8gb3IgaWYgcmVzaXplIHdhcyB1bmJvdW5kLiBTZWUgIzkKICBpZiAoICF0aGlzLmlzUmVzaXplQm91bmQgfHwgIXRoaXMubmVlZHNSZXNpemVMYXlvdXQoKSApIHsKICAgIHJldHVybjsKICB9CgogIHRoaXMubGF5b3V0KCk7Cn07CgovKioKICogY2hlY2sgaWYgbGF5b3V0IGlzIG5lZWRlZCBwb3N0IGxheW91dAogKiBAcmV0dXJucyBCb29sZWFuCiAqLwpPdXRsYXllci5wcm90b3R5cGUubmVlZHNSZXNpemVMYXlvdXQgPSBmdW5jdGlvbigpIHsKICB2YXIgc2l6ZSA9IGdldFNpemUoIHRoaXMuZWxlbWVudCApOwogIC8vIGNoZWNrIHRoYXQgdGhpcy5zaXplIGFuZCBzaXplIGFyZSB0aGVyZQogIC8vIElFOCB0cmlnZ2VycyByZXNpemUgb24gYm9keSBzaXplIGNoYW5nZSwgc28gdGhleSBtaWdodCBub3QgYmUKICB2YXIgaGFzU2l6ZXMgPSB0aGlzLnNpemUgJiYgc2l6ZTsKICByZXR1cm4gaGFzU2l6ZXMgJiYgc2l6ZS5pbm5lcldpZHRoICE9PSB0aGlzLnNpemUuaW5uZXJXaWR0aDsKfTsKCi8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tIG1ldGhvZHMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gLy8KCi8qKgogKiBhZGQgaXRlbXMgdG8gT3V0bGF5ZXIgaW5zdGFuY2UKICogQHBhcmFtIHtBcnJheSBvciBOb2RlTGlzdCBvciBFbGVtZW50fSBlbGVtcwogKiBAcmV0dXJucyB7QXJyYXl9IGl0ZW1zIC0gT3V0bGF5ZXIuSXRlbXMKKiovCk91dGxheWVyLnByb3RvdHlwZS5hZGRJdGVtcyA9IGZ1bmN0aW9uKCBlbGVtcyApIHsKICB2YXIgaXRlbXMgPSB0aGlzLl9pdGVtaXplKCBlbGVtcyApOwogIC8vIGFkZCBpdGVtcyB0byBjb2xsZWN0aW9uCiAgaWYgKCBpdGVtcy5sZW5ndGggKSB7CiAgICB0aGlzLml0ZW1zID0gdGhpcy5pdGVtcy5jb25jYXQoIGl0ZW1zICk7CiAgfQogIHJldHVybiBpdGVtczsKfTsKCi8qKgogKiBMYXlvdXQgbmV3bHktYXBwZW5kZWQgaXRlbSBlbGVtZW50cwogKiBAcGFyYW0ge0FycmF5IG9yIE5vZGVMaXN0IG9yIEVsZW1lbnR9IGVsZW1zCiAqLwpPdXRsYXllci5wcm90b3R5cGUuYXBwZW5kZWQgPSBmdW5jdGlvbiggZWxlbXMgKSB7CiAgdmFyIGl0ZW1zID0gdGhpcy5hZGRJdGVtcyggZWxlbXMgKTsKICBpZiAoICFpdGVtcy5sZW5ndGggKSB7CiAgICByZXR1cm47CiAgfQogIC8vIGxheW91dCBhbmQgcmV2ZWFsIGp1c3QgdGhlIG5ldyBpdGVtcwogIHRoaXMubGF5b3V0SXRlbXMoIGl0ZW1zLCB0cnVlICk7CiAgdGhpcy5yZXZlYWwoIGl0ZW1zICk7Cn07CgovKioKICogTGF5b3V0IHByZXBlbmRlZCBlbGVtZW50cwogKiBAcGFyYW0ge0FycmF5IG9yIE5vZGVMaXN0IG9yIEVsZW1lbnR9IGVsZW1zCiAqLwpPdXRsYXllci5wcm90b3R5cGUucHJlcGVuZGVkID0gZnVuY3Rpb24oIGVsZW1zICkgewogIHZhciBpdGVtcyA9IHRoaXMuX2l0ZW1pemUoIGVsZW1zICk7CiAgaWYgKCAhaXRlbXMubGVuZ3RoICkgewogICAgcmV0dXJuOwogIH0KICAvLyBhZGQgaXRlbXMgdG8gYmVnaW5uaW5nIG9mIGNvbGxlY3Rpb24KICB2YXIgcHJldmlvdXNJdGVtcyA9IHRoaXMuaXRlbXMuc2xpY2UoMCk7CiAgdGhpcy5pdGVtcyA9IGl0ZW1zLmNvbmNhdCggcHJldmlvdXNJdGVtcyApOwogIC8vIHN0YXJ0IG5ldyBsYXlvdXQKICB0aGlzLl9yZXNldExheW91dCgpOwogIHRoaXMuX21hbmFnZVN0YW1wcygpOwogIC8vIGxheW91dCBuZXcgc3R1ZmYgd2l0aG91dCB0cmFuc2l0aW9uCiAgdGhpcy5sYXlvdXRJdGVtcyggaXRlbXMsIHRydWUgKTsKICB0aGlzLnJldmVhbCggaXRlbXMgKTsKICAvLyBsYXlvdXQgcHJldmlvdXMgaXRlbXMKICB0aGlzLmxheW91dEl0ZW1zKCBwcmV2aW91c0l0ZW1zICk7Cn07CgovKioKICogcmV2ZWFsIGEgY29sbGVjdGlvbiBvZiBpdGVtcwogKiBAcGFyYW0ge0FycmF5IG9mIE91dGxheWVyLkl0ZW1zfSBpdGVtcwogKi8KT3V0bGF5ZXIucHJvdG90eXBlLnJldmVhbCA9IGZ1bmN0aW9uKCBpdGVtcyApIHsKICB2YXIgbGVuID0gaXRlbXMgJiYgaXRlbXMubGVuZ3RoOwogIGlmICggIWxlbiApIHsKICAgIHJldHVybjsKICB9CiAgZm9yICggdmFyIGk9MDsgaSA8IGxlbjsgaSsrICkgewogICAgdmFyIGl0ZW0gPSBpdGVtc1tpXTsKICAgIGl0ZW0ucmV2ZWFsKCk7CiAgfQp9OwoKLyoqCiAqIGhpZGUgYSBjb2xsZWN0aW9uIG9mIGl0ZW1zCiAqIEBwYXJhbSB7QXJyYXkgb2YgT3V0bGF5ZXIuSXRlbXN9IGl0ZW1zCiAqLwpPdXRsYXllci5wcm90b3R5cGUuaGlkZSA9IGZ1bmN0aW9uKCBpdGVtcyApIHsKICB2YXIgbGVuID0gaXRlbXMgJiYgaXRlbXMubGVuZ3RoOwogIGlmICggIWxlbiApIHsKICAgIHJldHVybjsKICB9CiAgZm9yICggdmFyIGk9MDsgaSA8IGxlbjsgaSsrICkgewogICAgdmFyIGl0ZW0gPSBpdGVtc1tpXTsKICAgIGl0ZW0uaGlkZSgpOwogIH0KfTsKCi8qKgogKiBnZXQgT3V0bGF5ZXIuSXRlbSwgZ2l2ZW4gYW4gRWxlbWVudAogKiBAcGFyYW0ge0VsZW1lbnR9IGVsZW0KICogQHBhcmFtIHtGdW5jdGlvbn0gY2FsbGJhY2sKICogQHJldHVybnMge091dGxheWVyLkl0ZW19IGl0ZW0KICovCk91dGxheWVyLnByb3RvdHlwZS5nZXRJdGVtID0gZnVuY3Rpb24oIGVsZW0gKSB7CiAgLy8gbG9vcCB0aHJvdWdoIGl0ZW1zIHRvIGdldCB0aGUgb25lIHRoYXQgbWF0Y2hlcwogIGZvciAoIHZhciBpPTAsIGxlbiA9IHRoaXMuaXRlbXMubGVuZ3RoOyBpIDwgbGVuOyBpKysgKSB7CiAgICB2YXIgaXRlbSA9IHRoaXMuaXRlbXNbaV07CiAgICBpZiAoIGl0ZW0uZWxlbWVudCA9PT0gZWxlbSApIHsKICAgICAgLy8gcmV0dXJuIGl0ZW0KICAgICAgcmV0dXJuIGl0ZW07CiAgICB9CiAgfQp9OwoKLyoqCiAqIGdldCBjb2xsZWN0aW9uIG9mIE91dGxheWVyLkl0ZW1zLCBnaXZlbiBFbGVtZW50cwogKiBAcGFyYW0ge0FycmF5fSBlbGVtcwogKiBAcmV0dXJucyB7QXJyYXl9IGl0ZW1zIC0gT3V0bGF5ZXIuSXRlbXMKICovCk91dGxheWVyLnByb3RvdHlwZS5nZXRJdGVtcyA9IGZ1bmN0aW9uKCBlbGVtcyApIHsKICBpZiAoICFlbGVtcyB8fCAhZWxlbXMubGVuZ3RoICkgewogICAgcmV0dXJuOwogIH0KICB2YXIgaXRlbXMgPSBbXTsKICBmb3IgKCB2YXIgaT0wLCBsZW4gPSBlbGVtcy5sZW5ndGg7IGkgPCBsZW47IGkrKyApIHsKICAgIHZhciBlbGVtID0gZWxlbXNbaV07CiAgICB2YXIgaXRlbSA9IHRoaXMuZ2V0SXRlbSggZWxlbSApOwogICAgaWYgKCBpdGVtICkgewogICAgICBpdGVtcy5wdXNoKCBpdGVtICk7CiAgICB9CiAgfQoKICByZXR1cm4gaXRlbXM7Cn07CgovKioKICogcmVtb3ZlIGVsZW1lbnQocykgZnJvbSBpbnN0YW5jZSBhbmQgRE9NCiAqIEBwYXJhbSB7QXJyYXkgb3IgTm9kZUxpc3Qgb3IgRWxlbWVudH0gZWxlbXMKICovCk91dGxheWVyLnByb3RvdHlwZS5yZW1vdmUgPSBmdW5jdGlvbiggZWxlbXMgKSB7CiAgZWxlbXMgPSBtYWtlQXJyYXkoIGVsZW1zICk7CgogIHZhciByZW1vdmVJdGVtcyA9IHRoaXMuZ2V0SXRlbXMoIGVsZW1zICk7CiAgLy8gYmFpbCBpZiBubyBpdGVtcyB0byByZW1vdmUKICBpZiAoICFyZW1vdmVJdGVtcyB8fCAhcmVtb3ZlSXRlbXMubGVuZ3RoICkgewogICAgcmV0dXJuOwogIH0KCiAgdGhpcy5faXRlbXNPbiggcmVtb3ZlSXRlbXMsICdyZW1vdmUnLCBmdW5jdGlvbigpIHsKICAgIHRoaXMuZW1pdEV2ZW50KCAncmVtb3ZlQ29tcGxldGUnLCBbIHRoaXMsIHJlbW92ZUl0ZW1zIF0gKTsKICB9KTsKCiAgZm9yICggdmFyIGk9MCwgbGVuID0gcmVtb3ZlSXRlbXMubGVuZ3RoOyBpIDwgbGVuOyBpKysgKSB7CiAgICB2YXIgaXRlbSA9IHJlbW92ZUl0ZW1zW2ldOwogICAgaXRlbS5yZW1vdmUoKTsKICAgIC8vIHJlbW92ZSBpdGVtIGZyb20gY29sbGVjdGlvbgogICAgcmVtb3ZlRnJvbSggaXRlbSwgdGhpcy5pdGVtcyApOwogIH0KfTsKCi8vIC0tLS0tIGRlc3Ryb3kgLS0tLS0gLy8KCi8vIHJlbW92ZSBhbmQgZGlzYWJsZSBPdXRsYXllciBpbnN0YW5jZQpPdXRsYXllci5wcm90b3R5cGUuZGVzdHJveSA9IGZ1bmN0aW9uKCkgewogIC8vIGNsZWFuIHVwIGR5bmFtaWMgc3R5bGVzCiAgdmFyIHN0eWxlID0gdGhpcy5lbGVtZW50LnN0eWxlOwogIHN0eWxlLmhlaWdodCA9ICcnOwogIHN0eWxlLnBvc2l0aW9uID0gJyc7CiAgc3R5bGUud2lkdGggPSAnJzsKICAvLyBkZXN0cm95IGl0ZW1zCiAgZm9yICggdmFyIGk9MCwgbGVuID0gdGhpcy5pdGVtcy5sZW5ndGg7IGkgPCBsZW47IGkrKyApIHsKICAgIHZhciBpdGVtID0gdGhpcy5pdGVtc1tpXTsKICAgIGl0ZW0uZGVzdHJveSgpOwogIH0KCiAgdGhpcy51bmJpbmRSZXNpemUoKTsKCiAgZGVsZXRlIHRoaXMuZWxlbWVudC5vdXRsYXllckdVSUQ7CiAgLy8gcmVtb3ZlIGRhdGEgZm9yIGpRdWVyeQogIGlmICggalF1ZXJ5ICkgewogICAgalF1ZXJ5LnJlbW92ZURhdGEoIHRoaXMuZWxlbWVudCwgdGhpcy5jb25zdHJ1Y3Rvci5uYW1lc3BhY2UgKTsKICB9Cgp9OwoKLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gZGF0YSAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSAvLwoKLyoqCiAqIGdldCBPdXRsYXllciBpbnN0YW5jZSBmcm9tIGVsZW1lbnQKICogQHBhcmFtIHtFbGVtZW50fSBlbGVtCiAqIEByZXR1cm5zIHtPdXRsYXllcn0KICovCk91dGxheWVyLmRhdGEgPSBmdW5jdGlvbiggZWxlbSApIHsKICB2YXIgaWQgPSBlbGVtICYmIGVsZW0ub3V0bGF5ZXJHVUlEOwogIHJldHVybiBpZCAmJiBpbnN0YW5jZXNbIGlkIF07Cn07CgoKLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gY3JlYXRlIE91dGxheWVyIGNsYXNzIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tIC8vCgovKioKICogY3JlYXRlIGEgbGF5b3V0IGNsYXNzCiAqIEBwYXJhbSB7U3RyaW5nfSBuYW1lc3BhY2UKICovCk91dGxheWVyLmNyZWF0ZSA9IGZ1bmN0aW9uKCBuYW1lc3BhY2UsIG9wdGlvbnMgKSB7CiAgLy8gc3ViLWNsYXNzIE91dGxheWVyCiAgZnVuY3Rpb24gTGF5b3V0KCkgewogICAgT3V0bGF5ZXIuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwogIH0KICAvLyBpbmhlcml0IE91dGxheWVyIHByb3RvdHlwZSwgdXNlIE9iamVjdC5jcmVhdGUgaWYgdGhlcmUKICBpZiAoIE9iamVjdC5jcmVhdGUgKSB7CiAgICBMYXlvdXQucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZSggT3V0bGF5ZXIucHJvdG90eXBlICk7CiAgfSBlbHNlIHsKICAgIGV4dGVuZCggTGF5b3V0LnByb3RvdHlwZSwgT3V0bGF5ZXIucHJvdG90eXBlICk7CiAgfQogIC8vIHNldCBjb250cnVjdG9yLCB1c2VkIGZvciBuYW1lc3BhY2UgYW5kIEl0ZW0KICBMYXlvdXQucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gTGF5b3V0OwoKICBMYXlvdXQuZGVmYXVsdHMgPSBleHRlbmQoIHt9LCBPdXRsYXllci5kZWZhdWx0cyApOwogIC8vIGFwcGx5IG5ldyBvcHRpb25zCiAgZXh0ZW5kKCBMYXlvdXQuZGVmYXVsdHMsIG9wdGlvbnMgKTsKICAvLyBrZWVwIHByb3RvdHlwZS5zZXR0aW5ncyBmb3IgYmFja3dhcmRzIGNvbXBhdGliaWxpdHkgKFBhY2tlcnkgdjEuMi4wKQogIExheW91dC5wcm90b3R5cGUuc2V0dGluZ3MgPSB7fTsKCiAgTGF5b3V0Lm5hbWVzcGFjZSA9IG5hbWVzcGFjZTsKCiAgTGF5b3V0LmRhdGEgPSBPdXRsYXllci5kYXRhOwoKICAvLyBzdWItY2xhc3MgSXRlbQogIExheW91dC5JdGVtID0gZnVuY3Rpb24gTGF5b3V0SXRlbSgpIHsKICAgIEl0ZW0uYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwogIH07CgogIExheW91dC5JdGVtLnByb3RvdHlwZSA9IG5ldyBJdGVtKCk7CgogIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tIGRlY2xhcmF0aXZlIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tIC8vCgogIC8qKgogICAqIGFsbG93IHVzZXIgdG8gaW5pdGlhbGl6ZSBPdXRsYXllciB2aWEgLmpzLW5hbWVzcGFjZSBjbGFzcwogICAqIG9wdGlvbnMgYXJlIHBhcnNlZCBmcm9tIGRhdGEtbmFtZXNwYWNlLW9wdGlvbiBhdHRyaWJ1dGUKICAgKi8KICBkb2NSZWFkeSggZnVuY3Rpb24oKSB7CiAgICB2YXIgZGFzaGVkTmFtZXNwYWNlID0gdG9EYXNoZWQoIG5hbWVzcGFjZSApOwogICAgdmFyIGVsZW1zID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCggJy5qcy0nICsgZGFzaGVkTmFtZXNwYWNlICk7CiAgICB2YXIgZGF0YUF0dHIgPSAnZGF0YS0nICsgZGFzaGVkTmFtZXNwYWNlICsgJy1vcHRpb25zJzsKCiAgICBmb3IgKCB2YXIgaT0wLCBsZW4gPSBlbGVtcy5sZW5ndGg7IGkgPCBsZW47IGkrKyApIHsKICAgICAgdmFyIGVsZW0gPSBlbGVtc1tpXTsKICAgICAgdmFyIGF0dHIgPSBlbGVtLmdldEF0dHJpYnV0ZSggZGF0YUF0dHIgKTsKICAgICAgdmFyIG9wdGlvbnM7CiAgICAgIHRyeSB7CiAgICAgICAgb3B0aW9ucyA9IGF0dHIgJiYgSlNPTi5wYXJzZSggYXR0ciApOwogICAgICB9IGNhdGNoICggZXJyb3IgKSB7CiAgICAgICAgLy8gbG9nIGVycm9yLCBkbyBub3QgaW5pdGlhbGl6ZQogICAgICAgIGlmICggY29uc29sZSApIHsKICAgICAgICAgIGNvbnNvbGUuZXJyb3IoICdFcnJvciBwYXJzaW5nICcgKyBkYXRhQXR0ciArICcgb24gJyArCiAgICAgICAgICAgIGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKSArICggZWxlbS5pZCA/ICcjJyArIGVsZW0uaWQgOiAnJyApICsgJzogJyArCiAgICAgICAgICAgIGVycm9yICk7CiAgICAgICAgfQogICAgICAgIGNvbnRpbnVlOwogICAgICB9CiAgICAgIC8vIGluaXRpYWxpemUKICAgICAgdmFyIGluc3RhbmNlID0gbmV3IExheW91dCggZWxlbSwgb3B0aW9ucyApOwogICAgICAvLyBtYWtlIGF2YWlsYWJsZSB2aWEgJCgpLmRhdGEoJ2xheW91dG5hbWUnKQogICAgICBpZiAoIGpRdWVyeSApIHsKICAgICAgICBqUXVlcnkuZGF0YSggZWxlbSwgbmFtZXNwYWNlLCBpbnN0YW5jZSApOwogICAgICB9CiAgICB9CiAgfSk7CgogIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tIGpRdWVyeSBicmlkZ2UgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gLy8KCiAgLy8gbWFrZSBpbnRvIGpRdWVyeSBwbHVnaW4KICBpZiAoIGpRdWVyeSAmJiBqUXVlcnkuYnJpZGdldCApIHsKICAgIGpRdWVyeS5icmlkZ2V0KCBuYW1lc3BhY2UsIExheW91dCApOwogIH0KCiAgcmV0dXJuIExheW91dDsKfTsKCi8vIC0tLS0tIGZpbiAtLS0tLSAvLwoKLy8gYmFjayBpbiBnbG9iYWwKT3V0bGF5ZXIuSXRlbSA9IEl0ZW07CgpyZXR1cm4gT3V0bGF5ZXI7Cgp9CgovLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSB0cmFuc3BvcnQgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gLy8KCmlmICggdHlwZW9mIGRlZmluZSA9PT0gJ2Z1bmN0aW9uJyAmJiBkZWZpbmUuYW1kICkgewogIC8vIEFNRAogIGRlZmluZSggJ291dGxheWVyL291dGxheWVyJyxbCiAgICAgICdldmVudGllL2V2ZW50aWUnLAogICAgICAnZG9jLXJlYWR5L2RvYy1yZWFkeScsCiAgICAgICdldmVudEVtaXR0ZXIvRXZlbnRFbWl0dGVyJywKICAgICAgJ2dldC1zaXplL2dldC1zaXplJywKICAgICAgJ21hdGNoZXMtc2VsZWN0b3IvbWF0Y2hlcy1zZWxlY3RvcicsCiAgICAgICcuL2l0ZW0nCiAgICBdLAogICAgb3V0bGF5ZXJEZWZpbml0aW9uICk7Cn0gZWxzZSB7CiAgLy8gYnJvd3NlciBnbG9iYWwKICB3aW5kb3cuT3V0bGF5ZXIgPSBvdXRsYXllckRlZmluaXRpb24oCiAgICB3aW5kb3cuZXZlbnRpZSwKICAgIHdpbmRvdy5kb2NSZWFkeSwKICAgIHdpbmRvdy5FdmVudEVtaXR0ZXIsCiAgICB3aW5kb3cuZ2V0U2l6ZSwKICAgIHdpbmRvdy5tYXRjaGVzU2VsZWN0b3IsCiAgICB3aW5kb3cuT3V0bGF5ZXIuSXRlbQogICk7Cn0KCn0pKCB3aW5kb3cgKTsKCi8qIQogKiBNYXNvbnJ5IHYzLjEuNQogKiBDYXNjYWRpbmcgZ3JpZCBsYXlvdXQgbGlicmFyeQogKiBodHRwOi8vbWFzb25yeS5kZXNhbmRyby5jb20KICogTUlUIExpY2Vuc2UKICogYnkgRGF2aWQgRGVTYW5kcm8KICovCgooIGZ1bmN0aW9uKCB3aW5kb3cgKSB7CgoKCi8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tIGhlbHBlcnMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gLy8KCnZhciBpbmRleE9mID0gQXJyYXkucHJvdG90eXBlLmluZGV4T2YgPwogIGZ1bmN0aW9uKCBpdGVtcywgdmFsdWUgKSB7CiAgICByZXR1cm4gaXRlbXMuaW5kZXhPZiggdmFsdWUgKTsKICB9IDoKICBmdW5jdGlvbiAoIGl0ZW1zLCB2YWx1ZSApIHsKICAgIGZvciAoIHZhciBpPTAsIGxlbiA9IGl0ZW1zLmxlbmd0aDsgaSA8IGxlbjsgaSsrICkgewogICAgICB2YXIgaXRlbSA9IGl0ZW1zW2ldOwogICAgICBpZiAoIGl0ZW0gPT09IHZhbHVlICkgewogICAgICAgIHJldHVybiBpOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gLTE7CiAgfTsKCi8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tIG1hc29ucnlEZWZpbml0aW9uIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tIC8vCgovLyB1c2VkIGZvciBBTUQgZGVmaW5pdGlvbiBhbmQgcmVxdWlyZXMKZnVuY3Rpb24gbWFzb25yeURlZmluaXRpb24oIE91dGxheWVyLCBnZXRTaXplICkgewogIC8vIGNyZWF0ZSBhbiBPdXRsYXllciBsYXlvdXQgY2xhc3MKICB2YXIgTWFzb25yeSA9IE91dGxheWVyLmNyZWF0ZSgnbWFzb25yeScpOwoKICBNYXNvbnJ5LnByb3RvdHlwZS5fcmVzZXRMYXlvdXQgPSBmdW5jdGlvbigpIHsKICAgIHRoaXMuZ2V0U2l6ZSgpOwogICAgdGhpcy5fZ2V0TWVhc3VyZW1lbnQoICdjb2x1bW5XaWR0aCcsICdvdXRlcldpZHRoJyApOwogICAgdGhpcy5fZ2V0TWVhc3VyZW1lbnQoICdndXR0ZXInLCAnb3V0ZXJXaWR0aCcgKTsKICAgIHRoaXMubWVhc3VyZUNvbHVtbnMoKTsKCiAgICAvLyByZXNldCBjb2x1bW4gWQogICAgdmFyIGkgPSB0aGlzLmNvbHM7CiAgICB0aGlzLmNvbFlzID0gW107CiAgICB3aGlsZSAoaS0tKSB7CiAgICAgIHRoaXMuY29sWXMucHVzaCggMCApOwogICAgfQoKICAgIHRoaXMubWF4WSA9IDA7CiAgfTsKCiAgTWFzb25yeS5wcm90b3R5cGUubWVhc3VyZUNvbHVtbnMgPSBmdW5jdGlvbigpIHsKICAgIHRoaXMuZ2V0Q29udGFpbmVyV2lkdGgoKTsKICAgIC8vIGlmIGNvbHVtbldpZHRoIGlzIDAsIGRlZmF1bHQgdG8gb3V0ZXJXaWR0aCBvZiBmaXJzdCBpdGVtCiAgICBpZiAoICF0aGlzLmNvbHVtbldpZHRoICkgewogICAgICB2YXIgZmlyc3RJdGVtID0gdGhpcy5pdGVtc1swXTsKICAgICAgdmFyIGZpcnN0SXRlbUVsZW0gPSBmaXJzdEl0ZW0gJiYgZmlyc3RJdGVtLmVsZW1lbnQ7CiAgICAgIC8vIGNvbHVtbldpZHRoIGZhbGwgYmFjayB0byBpdGVtIG9mIGZpcnN0IGVsZW1lbnQKICAgICAgdGhpcy5jb2x1bW5XaWR0aCA9IGZpcnN0SXRlbUVsZW0gJiYgZ2V0U2l6ZSggZmlyc3RJdGVtRWxlbSApLm91dGVyV2lkdGggfHwKICAgICAgICAvLyBpZiBmaXJzdCBlbGVtIGhhcyBubyB3aWR0aCwgZGVmYXVsdCB0byBzaXplIG9mIGNvbnRhaW5lcgogICAgICAgIHRoaXMuY29udGFpbmVyV2lkdGg7CiAgICB9CgogICAgdGhpcy5jb2x1bW5XaWR0aCArPSB0aGlzLmd1dHRlcjsKCiAgICB0aGlzLmNvbHMgPSBNYXRoLmZsb29yKCAoIHRoaXMuY29udGFpbmVyV2lkdGggKyB0aGlzLmd1dHRlciApIC8gdGhpcy5jb2x1bW5XaWR0aCApOwogICAgdGhpcy5jb2xzID0gTWF0aC5tYXgoIHRoaXMuY29scywgMSApOwogIH07CgogIE1hc29ucnkucHJvdG90eXBlLmdldENvbnRhaW5lcldpZHRoID0gZnVuY3Rpb24oKSB7CiAgICAvLyBjb250YWluZXIgaXMgcGFyZW50IGlmIGZpdCB3aWR0aAogICAgdmFyIGNvbnRhaW5lciA9IHRoaXMub3B0aW9ucy5pc0ZpdFdpZHRoID8gdGhpcy5lbGVtZW50LnBhcmVudE5vZGUgOiB0aGlzLmVsZW1lbnQ7CiAgICAvLyBjaGVjayB0aGF0IHRoaXMuc2l6ZSBhbmQgc2l6ZSBhcmUgdGhlcmUKICAgIC8vIElFOCB0cmlnZ2VycyByZXNpemUgb24gYm9keSBzaXplIGNoYW5nZSwgc28gdGhleSBtaWdodCBub3QgYmUKICAgIHZhciBzaXplID0gZ2V0U2l6ZSggY29udGFpbmVyICk7CiAgICB0aGlzLmNvbnRhaW5lcldpZHRoID0gc2l6ZSAmJiBzaXplLmlubmVyV2lkdGg7CiAgfTsKCiAgTWFzb25yeS5wcm90b3R5cGUuX2dldEl0ZW1MYXlvdXRQb3NpdGlvbiA9IGZ1bmN0aW9uKCBpdGVtICkgewogICAgaXRlbS5nZXRTaXplKCk7CiAgICAvLyBob3cgbWFueSBjb2x1bW5zIGRvZXMgdGhpcyBicmljayBzcGFuCiAgICB2YXIgcmVtYWluZGVyID0gaXRlbS5zaXplLm91dGVyV2lkdGggJSB0aGlzLmNvbHVtbldpZHRoOwogICAgdmFyIG1hdGhNZXRob2QgPSByZW1haW5kZXIgJiYgcmVtYWluZGVyIDwgMSA/ICdyb3VuZCcgOiAnY2VpbCc7CiAgICAvLyByb3VuZCBpZiBvZmYgYnkgMSBwaXhlbCwgb3RoZXJ3aXNlIHVzZSBjZWlsCiAgICB2YXIgY29sU3BhbiA9IE1hdGhbIG1hdGhNZXRob2QgXSggaXRlbS5zaXplLm91dGVyV2lkdGggLyB0aGlzLmNvbHVtbldpZHRoICk7CiAgICBjb2xTcGFuID0gTWF0aC5taW4oIGNvbFNwYW4sIHRoaXMuY29scyApOwoKICAgIHZhciBjb2xHcm91cCA9IHRoaXMuX2dldENvbEdyb3VwKCBjb2xTcGFuICk7CiAgICAvLyBnZXQgdGhlIG1pbmltdW0gWSB2YWx1ZSBmcm9tIHRoZSBjb2x1bW5zCiAgICB2YXIgbWluaW11bVkgPSBNYXRoLm1pbi5hcHBseSggTWF0aCwgY29sR3JvdXAgKTsKICAgIHZhciBzaG9ydENvbEluZGV4ID0gaW5kZXhPZiggY29sR3JvdXAsIG1pbmltdW1ZICk7CgogICAgLy8gcG9zaXRpb24gdGhlIGJyaWNrCiAgICB2YXIgcG9zaXRpb24gPSB7CiAgICAgIHg6IHRoaXMuY29sdW1uV2lkdGggKiBzaG9ydENvbEluZGV4LAogICAgICB5OiBtaW5pbXVtWQogICAgfTsKCiAgICAvLyBhcHBseSBzZXRIZWlnaHQgdG8gbmVjZXNzYXJ5IGNvbHVtbnMKICAgIHZhciBzZXRIZWlnaHQgPSBtaW5pbXVtWSArIGl0ZW0uc2l6ZS5vdXRlckhlaWdodDsKICAgIHZhciBzZXRTcGFuID0gdGhpcy5jb2xzICsgMSAtIGNvbEdyb3VwLmxlbmd0aDsKICAgIGZvciAoIHZhciBpID0gMDsgaSA8IHNldFNwYW47IGkrKyApIHsKICAgICAgdGhpcy5jb2xZc1sgc2hvcnRDb2xJbmRleCArIGkgXSA9IHNldEhlaWdodDsKICAgIH0KCiAgICByZXR1cm4gcG9zaXRpb247CiAgfTsKCiAgLyoqCiAgICogQHBhcmFtIHtOdW1iZXJ9IGNvbFNwYW4gLSBudW1iZXIgb2YgY29sdW1ucyB0aGUgZWxlbWVudCBzcGFucwogICAqIEByZXR1cm5zIHtBcnJheX0gY29sR3JvdXAKICAgKi8KICBNYXNvbnJ5LnByb3RvdHlwZS5fZ2V0Q29sR3JvdXAgPSBmdW5jdGlvbiggY29sU3BhbiApIHsKICAgIGlmICggY29sU3BhbiA8IDIgKSB7CiAgICAgIC8vIGlmIGJyaWNrIHNwYW5zIG9ubHkgb25lIGNvbHVtbiwgdXNlIGFsbCB0aGUgY29sdW1uIFlzCiAgICAgIHJldHVybiB0aGlzLmNvbFlzOwogICAgfQoKICAgIHZhciBjb2xHcm91cCA9IFtdOwogICAgLy8gaG93IG1hbnkgZGlmZmVyZW50IHBsYWNlcyBjb3VsZCB0aGlzIGJyaWNrIGZpdCBob3Jpem9udGFsbHkKICAgIHZhciBncm91cENvdW50ID0gdGhpcy5jb2xzICsgMSAtIGNvbFNwYW47CiAgICAvLyBmb3IgZWFjaCBncm91cCBwb3RlbnRpYWwgaG9yaXpvbnRhbCBwb3NpdGlvbgogICAgZm9yICggdmFyIGkgPSAwOyBpIDwgZ3JvdXBDb3VudDsgaSsrICkgewogICAgICAvLyBtYWtlIGFuIGFycmF5IG9mIGNvbFkgdmFsdWVzIGZvciB0aGF0IG9uZSBncm91cAogICAgICB2YXIgZ3JvdXBDb2xZcyA9IHRoaXMuY29sWXMuc2xpY2UoIGksIGkgKyBjb2xTcGFuICk7CiAgICAgIC8vIGFuZCBnZXQgdGhlIG1heCB2YWx1ZSBvZiB0aGUgYXJyYXkKICAgICAgY29sR3JvdXBbaV0gPSBNYXRoLm1heC5hcHBseSggTWF0aCwgZ3JvdXBDb2xZcyApOwogICAgfQogICAgcmV0dXJuIGNvbEdyb3VwOwogIH07CgogIE1hc29ucnkucHJvdG90eXBlLl9tYW5hZ2VTdGFtcCA9IGZ1bmN0aW9uKCBzdGFtcCApIHsKICAgIHZhciBzdGFtcFNpemUgPSBnZXRTaXplKCBzdGFtcCApOwogICAgdmFyIG9mZnNldCA9IHRoaXMuX2dldEVsZW1lbnRPZmZzZXQoIHN0YW1wICk7CiAgICAvLyBnZXQgdGhlIGNvbHVtbnMgdGhhdCB0aGlzIHN0YW1wIGFmZmVjdHMKICAgIHZhciBmaXJzdFggPSB0aGlzLm9wdGlvbnMuaXNPcmlnaW5MZWZ0ID8gb2Zmc2V0LmxlZnQgOiBvZmZzZXQucmlnaHQ7CiAgICB2YXIgbGFzdFggPSBmaXJzdFggKyBzdGFtcFNpemUub3V0ZXJXaWR0aDsKICAgIHZhciBmaXJzdENvbCA9IE1hdGguZmxvb3IoIGZpcnN0WCAvIHRoaXMuY29sdW1uV2lkdGggKTsKICAgIGZpcnN0Q29sID0gTWF0aC5tYXgoIDAsIGZpcnN0Q29sICk7CiAgICB2YXIgbGFzdENvbCA9IE1hdGguZmxvb3IoIGxhc3RYIC8gdGhpcy5jb2x1bW5XaWR0aCApOwogICAgLy8gbGFzdENvbCBzaG91bGQgbm90IGdvIG92ZXIgaWYgbXVsdGlwbGUgb2YgY29sdW1uV2lkdGggIzQyNQogICAgbGFzdENvbCAtPSBsYXN0WCAlIHRoaXMuY29sdW1uV2lkdGggPyAwIDogMTsKICAgIGxhc3RDb2wgPSBNYXRoLm1pbiggdGhpcy5jb2xzIC0gMSwgbGFzdENvbCApOwogICAgLy8gc2V0IGNvbFlzIHRvIGJvdHRvbSBvZiB0aGUgc3RhbXAKICAgIHZhciBzdGFtcE1heFkgPSAoIHRoaXMub3B0aW9ucy5pc09yaWdpblRvcCA/IG9mZnNldC50b3AgOiBvZmZzZXQuYm90dG9tICkgKwogICAgICBzdGFtcFNpemUub3V0ZXJIZWlnaHQ7CiAgICBmb3IgKCB2YXIgaSA9IGZpcnN0Q29sOyBpIDw9IGxhc3RDb2w7IGkrKyApIHsKICAgICAgdGhpcy5jb2xZc1tpXSA9IE1hdGgubWF4KCBzdGFtcE1heFksIHRoaXMuY29sWXNbaV0gKTsKICAgIH0KICB9OwoKICBNYXNvbnJ5LnByb3RvdHlwZS5fZ2V0Q29udGFpbmVyU2l6ZSA9IGZ1bmN0aW9uKCkgewogICAgdGhpcy5tYXhZID0gTWF0aC5tYXguYXBwbHkoIE1hdGgsIHRoaXMuY29sWXMgKTsKICAgIHZhciBzaXplID0gewogICAgICBoZWlnaHQ6IHRoaXMubWF4WQogICAgfTsKCiAgICBpZiAoIHRoaXMub3B0aW9ucy5pc0ZpdFdpZHRoICkgewogICAgICBzaXplLndpZHRoID0gdGhpcy5fZ2V0Q29udGFpbmVyRml0V2lkdGgoKTsKICAgIH0KCiAgICByZXR1cm4gc2l6ZTsKICB9OwoKICBNYXNvbnJ5LnByb3RvdHlwZS5fZ2V0Q29udGFpbmVyRml0V2lkdGggPSBmdW5jdGlvbigpIHsKICAgIHZhciB1bnVzZWRDb2xzID0gMDsKICAgIC8vIGNvdW50IHVudXNlZCBjb2x1bW5zCiAgICB2YXIgaSA9IHRoaXMuY29sczsKICAgIHdoaWxlICggLS1pICkgewogICAgICBpZiAoIHRoaXMuY29sWXNbaV0gIT09IDAgKSB7CiAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgICAgdW51c2VkQ29scysrOwogICAgfQogICAgLy8gZml0IGNvbnRhaW5lciB0byBjb2x1bW5zIHRoYXQgaGF2ZSBiZWVuIHVzZWQKICAgIHJldHVybiAoIHRoaXMuY29scyAtIHVudXNlZENvbHMgKSAqIHRoaXMuY29sdW1uV2lkdGggLSB0aGlzLmd1dHRlcjsKICB9OwoKICBNYXNvbnJ5LnByb3RvdHlwZS5uZWVkc1Jlc2l6ZUxheW91dCA9IGZ1bmN0aW9uKCkgewogICAgdmFyIHByZXZpb3VzV2lkdGggPSB0aGlzLmNvbnRhaW5lcldpZHRoOwogICAgdGhpcy5nZXRDb250YWluZXJXaWR0aCgpOwogICAgcmV0dXJuIHByZXZpb3VzV2lkdGggIT09IHRoaXMuY29udGFpbmVyV2lkdGg7CiAgfTsKCiAgcmV0dXJuIE1hc29ucnk7Cn0KCi8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tIHRyYW5zcG9ydCAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSAvLwoKaWYgKCB0eXBlb2YgZGVmaW5lID09PSAnZnVuY3Rpb24nICYmIGRlZmluZS5hbWQgKSB7CiAgLy8gQU1ECiAgZGVmaW5lKCAnbWFzb25yeS9tYXNvbnJ5JyxbCiAgICAgICdvdXRsYXllci9vdXRsYXllcicsCiAgICAgICdnZXQtc2l6ZS9nZXQtc2l6ZScKICAgIF0sCiAgICBtYXNvbnJ5RGVmaW5pdGlvbiApOwp9IGVsc2UgewogIC8vIGJyb3dzZXIgZ2xvYmFsCiAgd2luZG93Lk1hc29ucnkgPSBtYXNvbnJ5RGVmaW5pdGlvbigKICAgIHdpbmRvdy5PdXRsYXllciwKICAgIHdpbmRvdy5nZXRTaXplCiAgKTsKfQoKfSkoIHdpbmRvdyApOwoKLyohCiAqIEZsdWlkIE1hc29ucnkgdjEuMC4xCiAqIGV4dGVuZHMgdGhlIGNhc2NhZGluZyBncmlkIGxheW91dCBsaWJyYXJ5IG9mCiAqIGh0dHA6Ly9tYXNvbnJ5LmRlc2FuZHJvLmNvbSBieSBmaWxsaW5nIHVwIHRoZSBjb250YWluZXIgaW4gaXRzIGZ1bGwgd2lkdGguCiAqIE1JVCBMaWNlbnNlCiAqLwoKKCBmdW5jdGlvbiggd2luZG93ICkgewoKCgovLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSBoZWxwZXJzIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tIC8vCgp2YXIgaW5kZXhPZiA9IEFycmF5LnByb3RvdHlwZS5pbmRleE9mID8KICBmdW5jdGlvbiggaXRlbXMsIHZhbHVlICkgewogICAgcmV0dXJuIGl0ZW1zLmluZGV4T2YoIHZhbHVlICk7CiAgfSA6CiAgZnVuY3Rpb24gKCBpdGVtcywgdmFsdWUgKSB7CiAgICBmb3IgKCB2YXIgaT0wLCBsZW4gPSBpdGVtcy5sZW5ndGg7IGkgPCBsZW47IGkrKyApIHsKICAgICAgdmFyIGl0ZW0gPSBpdGVtc1tpXTsKICAgICAgaWYgKCBpdGVtID09PSB2YWx1ZSApIHsKICAgICAgICByZXR1cm4gaTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIC0xOwogIH07CgovLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSBtYXNvbnJ5RGVmaW5pdGlvbiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSAvLwoKLy8gdXNlZCBmb3IgQU1EIGRlZmluaXRpb24gYW5kIHJlcXVpcmVzCmZ1bmN0aW9uIGZsdWlkTWFzb25yeURlZmluaXRpb24oIE91dGxheWVyLCBNYXNvbnJ5ICkgewoKICB2YXIgRmx1aWRNYXNvbnJ5ID0gT3V0bGF5ZXIuY3JlYXRlKCdmbHVpZE1hc29ucnknKTsKCiAgLy8gT3ZlcnJpZGUgb3JpZ2luYWwgbWVhc3VyZUNvbHVtbnMgbWV0aG9kIG9mIG1hc29ucnkKICBGbHVpZE1hc29ucnkucHJvdG90eXBlLm1lYXN1cmVDb2x1bW5zID0gZnVuY3Rpb24oKSB7CiAgICAvLyBteSBmbHVpZCBzdHVmZiBoZXJlCiAgICAvLyBnZXQgdGhlIG1pbkNvbHVtbldpZHRoCiAgICB0aGlzLl9nZXRNZWFzdXJlbWVudCggJ21pbkNvbHVtbldpZHRoJywgJ291dGVyV2lkdGgnICk7CiAgICB0aGlzLm1pbkNvbHVtbldpZHRoICs9IHRoaXMuZ3V0dGVyOwoKICAgIC8vIGdldCBjb250YWluZXIgd2lkdGgKICAgIHRoaXMuZ2V0Q29udGFpbmVyV2lkdGgoKTsKCiAgICAvLyBXb3JrYXJvdW5kOiBpc0ZpdFdpZHRoIG1vZGUgZG9lc24ndCByZXNwZWN0IHBhZGRpbmcgYW5kIGJvcmRlciBvZiB0aGUgaXRlbSBjb250YWluZXIKICAgIC8vIHdoZW4gbWVhc3N1cmluZyB0aGUgY29udGFpbmVyIHdpZHRoIC0gaXQgbWVhc3N1cmVzIG9ubHkgdGhlIHBhcmVudCBvZiB0aGUgY29udGFpbmVyLiAKICAgIC8vIFdoZW4gbGF5aW5nIG91dCB0aGUgaXRlbXMsIHRoZXNlIHZhbHVlcyBhcmUgdXNlZCwgc28gd2UgaGF2ZSB0byBzdWJzdHJhY3QgCiAgICAvLyB0aGVpciB3aWR0aCwgd2hlbiBjYWxjdWxhdGluZyB0aGUgY29sdW1uIHdpZHRoLgogICAgaWYgKHRoaXMub3B0aW9ucy5pc0ZpdFdpZHRoKSB7CiAgICAgIHRoaXMuY29udGFpbmVyV2lkdGggPSB0aGlzLmNvbnRhaW5lcldpZHRoIC0gKAogICAgICAgIHRoaXMuc2l6ZS5wYWRkaW5nTGVmdCArIHRoaXMuc2l6ZS5wYWRkaW5nUmlnaHQgKyAKICAgICAgICB0aGlzLnNpemUuYm9yZGVyTGVmdFdpZHRoICsgdGhpcy5zaXplLmJvcmRlclJpZ2h0V2lkdGgKICAgICAgKTsKICAgIH0KCiAgICAvLyBob3cgbWFueSBjb2x1bW5zPwogICAgdGhpcy5jb2xzID0gTWF0aC5mbG9vciggKCB0aGlzLmNvbnRhaW5lcldpZHRoICsgdGhpcy5ndXR0ZXIgKSAvIHRoaXMubWluQ29sdW1uV2lkdGggKTsKICAgIHRoaXMuY29scyA9IE1hdGgubWF4KCB0aGlzLmNvbHMsIDEgKTsKCiAgICAvLyBkbyB3ZSBoYXZlIG1vcmUgKG9yIGV2ZW4gbGVzcyBbPT4gcmVzdFdpZHRoIG5lZ2F0aXZdKSBzcGFjZT8KICAgIHZhciByZXN0V2lkdGggPSB0aGlzLmNvbnRhaW5lcldpZHRoICsgdGhpcy5ndXR0ZXIgLSB0aGlzLmNvbHMqdGhpcy5taW5Db2x1bW5XaWR0aDsKICAgIHZhciByZXN0V2lkdGhQZXJDb2x1bW4gPSByZXN0V2lkdGgvdGhpcy5jb2xzOwoKICAgIC8vIHdoYXQgdG8gZG8gd2l0aCB0aGUgcm91bmRpbmcgZXJyb3I/CiAgICAvLyB3ZSBhZGQgaXQgb24gdGhlIGxlZnQgYW5kIHJpZ2h0IHNpZGUgb2YgdGhlIGNvbnRhaW5lciAtIHVubGVzcyB3ZSBzZXJ2ZSBpc0ZpdFdpZHRoCiAgICB2YXIgcm91bmRpbmdFcnJvciA9IChyZXN0V2lkdGhQZXJDb2x1bW4gLSBNYXRoLmZsb29yKHJlc3RXaWR0aFBlckNvbHVtbikpKnRoaXMuY29sczsKICAgIHRoaXMuY2VudGVyaW5nT2Zmc2V0ID0gdGhpcy5vcHRpb25zLmlzRml0V2lkdGggPyAwIDogTWF0aC5yb3VuZChyb3VuZGluZ0Vycm9yLzIpOwoKICAgIHRoaXMuY29sdW1uV2lkdGggPSB0aGlzLm1pbkNvbHVtbldpZHRoICsgTWF0aC5mbG9vcihyZXN0V2lkdGhQZXJDb2x1bW4pOwogICAgdGhpcy5jb2x1bW5XaWR0aElubmVyID0gdGhpcy5jb2x1bW5XaWR0aCAtIHRoaXMuZ3V0dGVyOwogIH07CgogIC8vIENhbGN1bGF0ZSBhbmQgc2V0IHdpZHRoIG9mIGV2ZXJ5IGl0ZW0sIHRoZW4gZG8gdGhlIG1hc29ucnkgbGF5b3V0IHBvcyBtYXRoLgogIC8vIFlvdSBjYW4gc3BhbiBhIGl0ZW0gb3ZlciBtb3JlIGNvbHVtbnMgd2l0aCB0aGUgZGF0YS1jb2x1bW5zIGF0dHJpYnV0ZS4KICBGbHVpZE1hc29ucnkucHJvdG90eXBlLl9nZXRJdGVtTGF5b3V0UG9zaXRpb24gPSBmdW5jdGlvbiggaXRlbSApIHsKICAgIC8vIGNhbGN1bGF0ZSB3aWR0aCBvZiBlYWNoIGl0ZW0gZWxlbWVudAogICAgdmFyIHdpZHRoID0gdGhpcy5jb2x1bW5XaWR0aElubmVyOwogICAgLy8gY2hlY2sgaWYgZWxlbWVudCBzaG91bGQgc3BhbiBtb3JlIHRoYW4gb25lIGNvbHVtbgogICAgdmFyIGNvbFNwYW4gPSBpdGVtLmVsZW1lbnQuZ2V0QXR0cmlidXRlKCdkYXRhLWNvbHVtbnMnKTsKICAgIGlmIChjb2xTcGFuID4gMSkgewogICAgICBjb2xTcGFuID0gTWF0aC5taW4oY29sU3BhbiwgdGhpcy5jb2xzKTsKICAgICAgd2lkdGggPSB3aWR0aCpjb2xTcGFuICsgKGNvbFNwYW4tMSkqdGhpcy5ndXR0ZXI7CiAgICB9IGVsc2UgewogICAgICBjb2xTcGFuID0gMTsKICAgIH0KICAgIC8vIHNldCB3aWR0aCBvZiBlbGVtZW50CiAgICBpdGVtLmVsZW1lbnQuc3R5bGUud2lkdGggPSB3aWR0aCArICdweCc7CgogICAgLyogdGhlIHJlc3Qgb2YgdGhlIG1ldGhvZCBpcyByb2JiZWQgYW5kIG5vdCBvdmVycmlkZGVuIGZyb20gdGhlIG9yaWdpbmFsIAogICAgICAgbWFzb25yeSBtZXRob2QgX2dldEl0ZW1MYXlvdXRQb3NpdGlvbiBmb3IgcGVyZm9ybWFuY2UgcmVhc29ucy4gY2F1c2UgZWxzZSAKICAgICAgIHRoZSBjb2xzcGFuIGlzIGNhbGN1bGF0ZWQgdHdpY2UgZm9yIGV2ZXJ5IGl0ZW0gKi8KCiAgICAvLyBjYWxjdWxhdGUgaXRlbSBzaXplCiAgICBpdGVtLmdldFNpemUoKTsKCiAgICB2YXIgY29sR3JvdXAgPSB0aGlzLl9nZXRDb2xHcm91cCggY29sU3BhbiApOwogICAgLy8gZ2V0IHRoZSBtaW5pbXVtIFkgdmFsdWUgZnJvbSB0aGUgY29sdW1ucwogICAgdmFyIG1pbmltdW1ZID0gTWF0aC5taW4uYXBwbHkoIE1hdGgsIGNvbEdyb3VwICk7CiAgICB2YXIgc2hvcnRDb2xJbmRleCA9IGluZGV4T2YoIGNvbEdyb3VwLCBtaW5pbXVtWSApOwoKICAgIC8vIHBvc2l0aW9uIHRoZSBicmljawogICAgdmFyIHBvc2l0aW9uID0gewogICAgICB4OiB0aGlzLmNvbHVtbldpZHRoICogc2hvcnRDb2xJbmRleCArIHRoaXMuY2VudGVyaW5nT2Zmc2V0LAogICAgICB5OiBtaW5pbXVtWQogICAgfTsKCiAgICAvLyBhcHBseSBzZXRIZWlnaHQgdG8gbmVjZXNzYXJ5IGNvbHVtbnMKICAgIHZhciBzZXRIZWlnaHQgPSBtaW5pbXVtWSArIGl0ZW0uc2l6ZS5vdXRlckhlaWdodDsKICAgIHZhciBzZXRTcGFuID0gdGhpcy5jb2xzICsgMSAtIGNvbEdyb3VwLmxlbmd0aDsKICAgIGZvciAoIHZhciBpID0gMDsgaSA8IHNldFNwYW47IGkrKyApIHsKICAgICAgdGhpcy5jb2xZc1sgc2hvcnRDb2xJbmRleCArIGkgXSA9IHNldEhlaWdodDsKICAgIH0KCiAgICByZXR1cm4gcG9zaXRpb247CiAgfTsKCiAgRmx1aWRNYXNvbnJ5LnByb3RvdHlwZS5fcmVzZXRMYXlvdXQgPSBNYXNvbnJ5LnByb3RvdHlwZS5fcmVzZXRMYXlvdXQ7CiAgRmx1aWRNYXNvbnJ5LnByb3RvdHlwZS5nZXRDb250YWluZXJXaWR0aCA9IE1hc29ucnkucHJvdG90eXBlLmdldENvbnRhaW5lcldpZHRoOwogIEZsdWlkTWFzb25yeS5wcm90b3R5cGUuX2dldENvbEdyb3VwID0gTWFzb25yeS5wcm90b3R5cGUuX2dldENvbEdyb3VwOwogIEZsdWlkTWFzb25yeS5wcm90b3R5cGUuX21hbmFnZVN0YW1wID0gTWFzb25yeS5wcm90b3R5cGUuX21hbmFnZVN0YW1wOwogIEZsdWlkTWFzb25yeS5wcm90b3R5cGUuX2dldENvbnRhaW5lclNpemUgPSBNYXNvbnJ5LnByb3RvdHlwZS5fZ2V0Q29udGFpbmVyU2l6ZTsKICBGbHVpZE1hc29ucnkucHJvdG90eXBlLl9nZXRDb250YWluZXJGaXRXaWR0aCA9IE1hc29ucnkucHJvdG90eXBlLl9nZXRDb250YWluZXJGaXRXaWR0aDsKICBGbHVpZE1hc29ucnkucHJvdG90eXBlLm5lZWRzUmVzaXplTGF5b3V0ID0gTWFzb25yeS5wcm90b3R5cGUubmVlZHNSZXNpemVMYXlvdXQ7CgogIHJldHVybiBGbHVpZE1hc29ucnk7Cn0KCi8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tIHRyYW5zcG9ydCAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSAvLwoKaWYgKCB0eXBlb2YgZGVmaW5lID09PSAnZnVuY3Rpb24nICYmIGRlZmluZS5hbWQgKSB7CiAgLy8gQU1ECiAgZGVmaW5lKCAnZmx1aWQtbWFzb25yeScsWwogICAgICAnb3V0bGF5ZXIvb3V0bGF5ZXInLAogICAgICAnbWFzb25yeS9tYXNvbnJ5JwogICAgXSwKICAgIGZsdWlkTWFzb25yeURlZmluaXRpb24gKTsKfSBlbHNlIHsKICAvLyBicm93c2VyIGdsb2JhbAogIHdpbmRvdy5GbHVpZE1hc29ucnkgPSBmbHVpZE1hc29ucnlEZWZpbml0aW9uKAogICAgd2luZG93Lk91dGxheWVyLAogICAgd2luZG93Lk1hc29ucnkKICApOwp9Cgp9KSggd2luZG93ICk7CgovKgogKiBqUXVlcnkgdGhyb3R0bGUgLyBkZWJvdW5jZSAtIHYxLjEgLSAzLzcvMjAxMAogKiBodHRwOi8vYmVuYWxtYW4uY29tL3Byb2plY3RzL2pxdWVyeS10aHJvdHRsZS1kZWJvdW5jZS1wbHVnaW4vCiAqIAogKiBDb3B5cmlnaHQgKGMpIDIwMTAgIkNvd2JveSIgQmVuIEFsbWFuCiAqIER1YWwgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBhbmQgR1BMIGxpY2Vuc2VzLgogKiBodHRwOi8vYmVuYWxtYW4uY29tL2Fib3V0L2xpY2Vuc2UvCiAqLwooZnVuY3Rpb24oYixjKXt2YXIgJD1iLmpRdWVyeXx8Yi5Db3dib3l8fChiLkNvd2JveT17fSksYTskLnRocm90dGxlPWE9ZnVuY3Rpb24oZSxmLGosaSl7dmFyIGgsZD0wO2lmKHR5cGVvZiBmIT09ImJvb2xlYW4iKXtpPWo7aj1mO2Y9Y31mdW5jdGlvbiBnKCl7dmFyIG89dGhpcyxtPStuZXcgRGF0ZSgpLWQsbj1hcmd1bWVudHM7ZnVuY3Rpb24gbCgpe2Q9K25ldyBEYXRlKCk7ai5hcHBseShvLG4pfWZ1bmN0aW9uIGsoKXtoPWN9aWYoaSYmIWgpe2woKX1oJiZjbGVhclRpbWVvdXQoaCk7aWYoaT09PWMmJm0+ZSl7bCgpfWVsc2V7aWYoZiE9PXRydWUpe2g9c2V0VGltZW91dChpP2s6bCxpPT09Yz9lLW06ZSl9fX1pZigkLmd1aWQpe2cuZ3VpZD1qLmd1aWQ9ai5ndWlkfHwkLmd1aWQrK31yZXR1cm4gZ307JC5kZWJvdW5jZT1mdW5jdGlvbihkLGUsZil7cmV0dXJuIGY9PT1jP2EoZCxlLGZhbHNlKTphKGQsZixlIT09ZmFsc2UpfX0pKHRoaXMpOwpkZWZpbmUoInZlbmRvci9qcXVlcnkudGhyb3R0bGUtZGVib3VuY2UiLCBmdW5jdGlvbigpe30pOwoKLyoKKiBAZmlsZU92ZXJ2aWV3IFRvdWNoU3dpcGUgLSBqUXVlcnkgUGx1Z2luCiogQHZlcnNpb24gMS42LjYKKgoqIEBhdXRob3IgTWF0dCBCcnlzb24gaHR0cDovL3d3dy5naXRodWIuY29tL21hdHRicnlzb24KKiBAc2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9tYXR0YnJ5c29uL1RvdWNoU3dpcGUtSnF1ZXJ5LVBsdWdpbgoqIEBzZWUgaHR0cDovL2xhYnMuc2tpbmtlcnMuY29tL3RvdWNoU3dpcGUvCiogQHNlZSBodHRwOi8vcGx1Z2lucy5qcXVlcnkuY29tL3Byb2plY3QvdG91Y2hTd2lwZQoqCiogQ29weXJpZ2h0IChjKSAyMDEwIE1hdHQgQnJ5c29uCiogRHVhbCBsaWNlbnNlZCB1bmRlciB0aGUgTUlUIG9yIEdQTCBWZXJzaW9uIDIgbGljZW5zZXMuCioKKi8KCi8qCioKKiBDaGFuZ2Vsb2cKKiAkRGF0ZTogMjAxMC0xMi0xMiAoV2VkLCAxMiBEZWMgMjAxMCkgJAoqICR2ZXJzaW9uOiAxLjAuMAoqICR2ZXJzaW9uOiAxLjAuMSAtIHJlbW92ZWQgbXVsdGlieXRlIGNvbW1lbnRzCioKKiAkRGF0ZTogMjAxMS0yMS0wMiAoTW9uLCAyMSBGZWIgMjAxMSkgJAoqICR2ZXJzaW9uOiAxLjEuMCAJLSBhZGRlZCBhbGxvd1BhZ2VTY3JvbGwgcHJvcGVydHkgdG8gYWxsb3cgc3dpcGluZyBhbmQgc2Nyb2xsaW5nIG9mIHBhZ2UKKgkJCQkJLSBjaGFuZ2VkIGhhbmRsZXIgc2lnbmF0dXJlcyBzbyBvbmUgaGFuZGxlciBjYW4gYmUgdXNlZCBmb3IgbXVsdGlwbGUgZXZlbnRzCiogJERhdGU6IDIwMTEtMjMtMDIgKFdlZCwgMjMgRmViIDIwMTEpICQKKiAkdmVyc2lvbjogMS4yLjAgCS0gYWRkZWQgY2xpY2sgaGFuZGxlci4gVGhpcyBpcyBmaXJlZCBpZiB0aGUgdXNlciBzaW1wbHkgY2xpY2tzIGFuZCBkb2VzIG5vdCBzd2lwZS4gVGhlIGV2ZW50IG9iamVjdCBhbmQgY2xpY2sgdGFyZ2V0IGFyZSBwYXNzZWQgdG8gaGFuZGxlci4KKgkJCQkJLSBJZiB5b3UgdXNlIHRoZSBodHRwOi8vY29kZS5nb29nbGUuY29tL3AvanF1ZXJ5LXVpLWZvci1pcGFkLWFuZC1pcGhvbmUvIHBsdWdpbiwgeW91IGNhbiBhbHNvIGFzc2lnbiBqUXVlcnkgbW91c2UgZXZlbnRzIHRvIGNoaWxkcmVuIG9mIGEgdG91Y2hTd2lwZSBvYmplY3QuCiogJHZlcnNpb246IDEuMi4xIAktIHJlbW92ZWQgY29uc29sZSBsb2chCioKKiAkdmVyc2lvbjogMS4yLjIgCS0gRml4ZWQgYnVnIHdoZXJlIHNjb3BlIHdhcyBub3QgcHJlc2VydmVkIGluIGNhbGxiYWNrIG1ldGhvZHMuCioKKiAkRGF0ZTogMjAxMS0yOC0wNCAoVGh1cnMsIDI4IEFwcmlsIDIwMTEpICQKKiAkdmVyc2lvbjogMS4yLjQgCS0gQ2hhbmdlZCBsaWNlbmNlIHRlcm1zIHRvIGJlIE1JVCBvciBHUEwgaW5saW5lIHdpdGggalF1ZXJ5LiBBZGRlZCBjaGVjayBmb3Igc3VwcG9ydCBvZiB0b3VjaCBldmVudHMgdG8gc3RvcCBub24gY29tcGF0aWJsZSBicm93c2VycyBlcnJvcmluZy4KKgoqICREYXRlOiAyMDExLTI3LTA5IChUdWVzLCAyNyBTZXB0ZW1iZXIgMjAxMSkgJAoqICR2ZXJzaW9uOiAxLjIuNSAJLSBBZGRlZCBzdXBwb3J0IGZvciB0ZXN0aW5nIHN3aXBlcyB3aXRoIG1vdXNlIG9uIGRlc2t0b3AgYnJvd3NlciAodGhhbmtzIHRvIGh0dHBzOi8vZ2l0aHViLmNvbS9qb2VsaHkpCioKKiAkRGF0ZTogMjAxMi0xNC0wNSAoTW9uLCAxNCBNYXkgMjAxMikgJAoqICR2ZXJzaW9uOiAxLjIuNiAJLSBBZGRlZCB0aW1lVGhyZXNob2xkIGJldHdlZW4gc3RhcnQgYW5kIGVuZCB0b3VjaCwgc28gdXNlciBjYW4gaWdub3JlIHNsb3cgc3dpcGVzICh0aGFua3MgdG8gTWFyayBDaGFzZSkuIERlZmF1bHQgaXMgbnVsbCwgYWxsIHN3aXBlcyBhcmUgZGV0ZWN0ZWQKKgoqICREYXRlOiAyMDEyLTA1LTA2IChUdWVzLCAwNSBKdW5lIDIwMTIpICQKKiAkdmVyc2lvbjogMS4yLjcgCS0gQ2hhbmdlZCB0aW1lIHRocmVzaG9sZCB0byBoYXZlIG51bGwgZGVmYXVsdCBmb3IgYmFja3dhcmRzIGNvbXBhdGliaWxpdHkuIEFkZGVkIGR1cmF0aW9uIHBhcmFtIHBhc3NlZCBiYWNrIGluIGV2ZW50cywgYW5kIHJlZmFjdG9yZWQgaG93IHRpbWUgaXMgaGFuZGxlZC4KKgoqICREYXRlOiAyMDEyLTA1LTA2IChUdWVzLCAwNSBKdW5lIDIwMTIpICQKKiAkdmVyc2lvbjogMS4yLjggCS0gQWRkZWQgdGhlIHBvc3NpYmlsaXR5IHRvIHJldHVybiBhIHZhbHVlIGxpa2UgbnVsbCBvciBmYWxzZSBpbiB0aGUgdHJpZ2dlciBjYWxsYmFjay4gSW4gdGhhdCB3YXkgd2UgY2FuIGNvbnRyb2wgd2hlbiB0aGUgdG91Y2ggc3RhcnQvbW92ZSBzaG91bGQgdGFrZSBlZmZlY3Qgb3Igbm90IChzaW1wbHkgYnkgcmV0dXJuaW5nIGluIHNvbWUgY2FzZXMgcmV0dXJuIG51bGw7IG9yIHJldHVybiBmYWxzZTspIFRoaXMgZWZmZWN0cyB0aGUgb250b3VjaHN0YXJ0L29udG91Y2htb3ZlIGV2ZW50LgoqCiogJERhdGU6IDIwMTItMDYtMDYgKFdlZCwgMDYgSnVuZSAyMDEyKSAkCiogJHZlcnNpb246IDEuMy4wIAktIFJlZmFjdG9yZWQgd2hvbGUgcGx1Z2luIHRvIGFsbG93IGZvciBtZXRob2RzIHRvIGJlIGV4ZWN1dGVkLCBhcyB3ZWxsIGFzIGV4cG9zZWQgZGVmYXVsdHMgZm9yIHVzZXIgb3ZlcnJpZGUuIEFkZGVkICdlbmFibGUnLCAnZGlzYWJsZScsIGFuZCAnZGVzdHJveScgbWV0aG9kcwoqCiogJERhdGU6IDIwMTItMDUtMDYgKEZyaSwgMDUgSnVuZSAyMDEyKSAkCiogJHZlcnNpb246IDEuMy4xIAktIEJ1ZyBmaXhlcyAgLSBiaW5kKCkgd2l0aCBmYWxzZSBhcyBsYXN0IGFyZ3VtZW50IGlzIG5vIGxvbmdlciBzdXBwb3J0ZWQgaW4galF1ZXJ5IDEuNiwgYWxzbywgaWYgeW91IGp1c3QgY2xpY2ssIHRoZSBkdXJhdGlvbiBpcyBub3cgcmV0dXJuZWQgY29ycmVjdGx5LgoqCiogJERhdGU6IDIwMTItMjktMDcgKFN1biwgMjkgSnVseSAyMDEyKSAkCiogJHZlcnNpb246IDEuMy4yCS0gQWRkZWQgZmFsbGJhY2tUb01vdXNlRXZlbnRzIG9wdGlvbiB0byBOT1QgY2FwdHVyZSBtb3VzZSBldmVudHMgb24gbm9uIHRvdWNoIGRldmljZXMuCiogCQkJLSBBZGRlZCAiYWxsIiBmaW5nZXJzIHZhbHVlIHRvIHRoZSBmaW5nZXJzIHByb3BlcnR5LCBzbyBhbnkgY29tYmluYXRpb24gb2YgZmluZ2VycyB0cmlnZ2VycyB0aGUgc3dpcGUsIGFsbG93aW5nIGV2ZW50IGhhbmRsZXJzIHRvIGNoZWNrIHRoZSBmaW5nZXIgY291bnQKKgoqICREYXRlOiAyMDEyLTA5LTA4IChUaHVycywgOSBBdWcgMjAxMikgJAoqICR2ZXJzaW9uOiAxLjMuMwktIENvZGUgdGlkeSBwcmVwIGZvciBtaW5lZmllZCB2ZXJzaW9uCioKKiAkRGF0ZTogMjAxMi0wNC0xMCAod2VkLCA0IE9jdCAyMDEyKSAkCiogJHZlcnNpb246IDEuNC4wCS0gQWRkZWQgcGluY2ggc3VwcG9ydCwgcGluY2hJbiBhbmQgcGluY2hPdXQKKgoqICREYXRlOiAyMDEyLTExLTEwIChUaHVycywgMTEgT2N0IDIwMTIpICQKKiAkdmVyc2lvbjogMS41LjAJLSBBZGRlZCBleGNsdWRlZEVsZW1lbnRzLCBhIGpxdWVyeSBzZWxlY3RvciB0aGF0IHNwZWNpZmllcyBjaGlsZCBlbGVtZW50cyB0aGF0IGRvIE5PVCB0cmlnZ2VyIHN3aXBlcy4gQnkgZGVmYXVsdCwgdGhpcyBpcyBvbmUgc2VsZWN0IHRoYXQgcmVtb3ZlcyBhbGwgZm9ybSwgaW5wdXQgc2VsZWN0LCBidXR0b24gYW5kIGFuY2hvciBlbGVtZW50cy4KKgoqICREYXRlOiAyMDEyLTIyLTEwIChNb24sIDIyIE9jdCAyMDEyKSAkCiogJHZlcnNpb246IDEuNS4xCS0gRml4ZWQgYnVnIHdpdGggalF1ZXJ5IDEuOCBhbmQgdHJhaWxpbmcgY29tbWEgaW4gZXhjbHVkZWRFbGVtZW50cwoqCQkJCQktIEZpeGVkIGJ1ZyB3aXRoIElFIGFuZCBldmVudFByZXZlbnREZWZhdWx0KCkKKiAkRGF0ZTogMjAxMy0wMS0xMiAoRnJpLCAxMiBKYW4gMjAxMykgJAoqICR2ZXJzaW9uOiAxLjYuMAktIEZpeGVkIGJ1Z3Mgd2l0aCBwaW5jaGluZywgbWFpbmx5IHdoZW4gYm90aCBwaW5jaCBhbmQgc3dpcGUgZW5hYmxlZCwgYXMgd2VsbCBhcyBhZGRpbmcgdGltZSB0aHJlc2hvbGQgZm9yIG11bHRpZmluZ2VyIGdlc3R1cmVzLCBzbyByZWxlYXNpbmcgb25lIGZpbmdlciBiZW9mcmUgdGhlIG90aGVyIGRvZXNudCB0cmlnZ2VyIGFzIHNpbmdsZSBmaW5nZXIgZ2VzdHVyZS4KKgkJCQkJLSBtYWRlIHRoZSBkZW1vIHNpdGUgYWxsIHN0YXRpYyBsb2NhbCBIVE1MIHBhZ2VzIHNvIHRoZXkgY2FuIGJlIHJ1biBsb2NhbGx5IGJ5IGEgZGV2ZWxvcGVyCioJCQkJCS0gYWRkZWQganNEb2MgY29tbWVudHMgYW5kIGFkZGVkIGRvY3VtZW50YXRpb24gZm9yIHRoZSBwbHVnaW4JCioJCQkJCS0gY29kZSB0aWR5CioJCQkJCS0gYWRkZWQgdHJpZ2dlck9uVG91Y2hMZWF2ZSBwcm9wZXJ0eSB0aGF0IHdpbGwgZW5kIHRoZSBldmVudCB3aGVuIHRoZSB1c2VyIHN3aXBlcyBvZmYgdGhlIGVsZW1lbnQuCiogJERhdGU6IDIwMTMtMDMtMjMgKFNhdCwgMjMgTWFyIDIwMTMpICQKKiAkdmVyc2lvbjogMS42LjEJLSBBZGRlZCBzdXBwb3J0IGZvciBpZTggdG91Y2ggZXZlbnRzCiogJHZlcnNpb246IDEuNi4yCS0gQWRkZWQgc3VwcG9ydCBmb3IgZXZlbnRzIGJpbmRpbmcgd2l0aCBvbiAvIG9mZiAvIGJpbmQgaW4galEgZm9yIGFsbCBjYWxsYmFjayBuYW1lcy4KKiAgICAgICAgICAgICAgICAgICAtIERlcHJlY2F0ZWQgdGhlICdjbGljaycgaGFuZGxlciBpbiBmYXZvdXIgb2YgdGFwLgoqICAgICAgICAgICAgICAgICAgIC0gYWRkZWQgY2FuY2VsVGhyZXNob2xkIHByb3BlcnR5CiogICAgICAgICAgICAgICAgICAgLSBhZGRlZCBvcHRpb24gbWV0aG9kIHRvIHVwZGF0ZSBpbml0IG9wdGlvbnMgYXQgcnVudGltZQoqICR2ZXJzaW9uIDEuNi4zICAgIC0gYWRkZWQgZG91YmxldGFwLCBsb25ndGFwIGV2ZW50cyBhbmQgbG9uZ1RhcFRocmVzaG9sZCwgZG91YmxlVGFwVGhyZXNob2xkIHByb3BlcnR5CioKKiAkRGF0ZTogMjAxMy0wNC0wNCAoVGh1cnMsIDA0IEFwcmlsIDIwMTMpICQKKiAkdmVyc2lvbiAxLjYuNCAgICAtIEZpeGVkIGJ1ZyB3aXRoIGNhbmNlbFRocmVzaG9sZCBpbnRyb2R1Y2VkIGluIDEuNi4zLCB3aGVyZSBzd2lwZSBzdGF0dXMgbm8gbG9uZ2VyIGZpcmVkIHN0YXJ0IGV2ZW50LCBhbmQgc3RvcHBlZCBvbmNlIHN3aXBpbmcgYmFjay4KKgoqICREYXRlOiAyMDEzLTA4LTI0IChTYXQsIDI0IEF1ZyAyMDEzKSAkCiogJHZlcnNpb24gMS42LjUgICAgLSBNZXJnZWQgYSBmZXcgcHVsbCByZXF1ZXN0cyBmaXhpbmcgdmFyaW91cyBidWdzLCBhZGRlZCBBTUQgc3VwcG9ydC4KKgoqICREYXRlOiAyMDE0LTA2LTA0IChXZWQsIDA0IEp1bmUgMjAxNCkgJAoqICR2ZXJzaW9uIDEuNi42IAktIE1lcmdlIG9mIHB1bGwgcmVxdWVzdHMuCiogICAgCQkJCS0gSUUxMCB0b3VjaCBzdXBwb3J0IAoqICAgIAkJCQktIE9ubHkgcHJldmVudCBkZWZhdWx0IGV2ZW50IGhhbmRsaW5nIG9uIHZhbGlkIHN3aXBlCiogICAgCQkJCS0gU2VwYXJhdGUgbGljZW5zZS9jaGFuZ2Vsb2cgY29tbWVudAoqICAgIAkJCQktIERldGVjdCBpZiB0aGUgc3dpcGUgaXMgdmFsaWQgYXQgdGhlIGVuZCBvZiB0aGUgdG91Y2ggZXZlbnQuCiogICAgCQkJCS0gUGFzcyBmaW5nZXJkYXRhIHRvIGV2ZW50IGhhbmRsZXJzLiAKKiAgICAJCQkJLSBBZGQgJ2hvbGQnIGdlc3R1cmUgCiogICAgCQkJCS0gQmUgbW9yZSB0b2xlcmFudCBhYm91dCB0aGUgdGFwIGRpc3RhbmNlCiogICAgCQkJCS0gVHlwb3MgYW5kIG1pbm9yIGZpeGVzCiovCgovKioKICogU2VlIChodHRwOi8vanF1ZXJ5LmNvbS8pLgogKiBAbmFtZSAkCiAqIEBjbGFzcyAKICogU2VlIHRoZSBqUXVlcnkgTGlicmFyeSAgKGh0dHA6Ly9qcXVlcnkuY29tLykgZm9yIGZ1bGwgZGV0YWlscy4gIFRoaXMganVzdAogKiBkb2N1bWVudHMgdGhlIGZ1bmN0aW9uIGFuZCBjbGFzc2VzIHRoYXQgYXJlIGFkZGVkIHRvIGpRdWVyeSBieSB0aGlzIHBsdWctaW4uCiAqLwogCi8qKgogKiBTZWUgKGh0dHA6Ly9qcXVlcnkuY29tLykKICogQG5hbWUgZm4KICogQGNsYXNzIAogKiBTZWUgdGhlIGpRdWVyeSBMaWJyYXJ5ICAoaHR0cDovL2pxdWVyeS5jb20vKSBmb3IgZnVsbCBkZXRhaWxzLiAgVGhpcyBqdXN0CiAqIGRvY3VtZW50cyB0aGUgZnVuY3Rpb24gYW5kIGNsYXNzZXMgdGhhdCBhcmUgYWRkZWQgdG8galF1ZXJ5IGJ5IHRoaXMgcGx1Zy1pbi4KICogQG1lbWJlck9mICQKICovCgoKCihmdW5jdGlvbiAoZmFjdG9yeSkgewogICAgaWYgKHR5cGVvZiBkZWZpbmUgPT09ICdmdW5jdGlvbicgJiYgZGVmaW5lLmFtZCAmJiBkZWZpbmUuYW1kLmpRdWVyeSkgewogICAgICAgIC8vIEFNRC4gUmVnaXN0ZXIgYXMgYW5vbnltb3VzIG1vZHVsZS4KICAgICAgICBkZWZpbmUoJ2pxdWVyeS10b3VjaHN3aXBlJyxbJ2pxdWVyeSddLCBmYWN0b3J5KTsKICAgIH0gZWxzZSB7CiAgICAgICAgLy8gQnJvd3NlciBnbG9iYWxzLgogICAgICAgIGZhY3RvcnkoalF1ZXJ5KTsKICAgIH0KfShmdW5jdGlvbiAoJCkgewoJCgoJLy9Db25zdGFudHMKCXZhciBMRUZUID0gImxlZnQiLAoJCVJJR0hUID0gInJpZ2h0IiwKCQlVUCA9ICJ1cCIsCgkJRE9XTiA9ICJkb3duIiwKCQlJTiA9ICJpbiIsCgkJT1VUID0gIm91dCIsCgoJCU5PTkUgPSAibm9uZSIsCgkJQVVUTyA9ICJhdXRvIiwKCQkKCQlTV0lQRSA9ICJzd2lwZSIsCgkJUElOQ0ggPSAicGluY2giLAoJCVRBUCA9ICJ0YXAiLAoJCURPVUJMRV9UQVAgPSAiZG91YmxldGFwIiwKCQlMT05HX1RBUCA9ICJsb25ndGFwIiwKCQlIT0xEID0gImhvbGQiLAoJCQoJCUhPUklaT05UQUwgPSAiaG9yaXpvbnRhbCIsCgkJVkVSVElDQUwgPSAidmVydGljYWwiLAoKCQlBTExfRklOR0VSUyA9ICJhbGwiLAoJCQoJCURPVUJMRV9UQVBfVEhSRVNIT0xEID0gMTAsCgoJCVBIQVNFX1NUQVJUID0gInN0YXJ0IiwKCQlQSEFTRV9NT1ZFID0gIm1vdmUiLAoJCVBIQVNFX0VORCA9ICJlbmQiLAoJCVBIQVNFX0NBTkNFTCA9ICJjYW5jZWwiLAoKCQlTVVBQT1JUU19UT1VDSCA9ICdvbnRvdWNoc3RhcnQnIGluIHdpbmRvdywKCQkKCQlTVVBQT1JUU19QT0lOVEVSX0lFMTAgPSB3aW5kb3cubmF2aWdhdG9yLm1zUG9pbnRlckVuYWJsZWQgJiYgIXdpbmRvdy5uYXZpZ2F0b3IucG9pbnRlckVuYWJsZWQsCgkJCgkJU1VQUE9SVFNfUE9JTlRFUiA9IHdpbmRvdy5uYXZpZ2F0b3IucG9pbnRlckVuYWJsZWQgfHwgd2luZG93Lm5hdmlnYXRvci5tc1BvaW50ZXJFbmFibGVkLAoKCQlQTFVHSU5fTlMgPSAnVG91Y2hTd2lwZSc7CgoKCgkvKioKCSogVGhlIGRlZmF1bHQgY29uZmlndXJhdGlvbiwgYW5kIGF2YWlsYWJsZSBvcHRpb25zIHRvIGNvbmZpZ3VyZSB0b3VjaCBzd2lwZSB3aXRoLgoJKiBZb3UgY2FuIHNldCB0aGUgZGVmYXVsdCB2YWx1ZXMgYnkgdXBkYXRpbmcgYW55IG9mIHRoZSBwcm9wZXJ0aWVzIHByaW9yIHRvIGluc3RhbnRpYXRpb24uCgkqIEBuYW1lICQuZm4uc3dpcGUuZGVmYXVsdHMKCSogQG5hbWVzcGFjZQoJKiBAcHJvcGVydHkge2ludH0gW2ZpbmdlcnM9MV0gVGhlIG51bWJlciBvZiBmaW5nZXJzIHRvIGRldGVjdCBpbiBhIHN3aXBlLiBBbnkgc3dpcGVzIHRoYXQgZG8gbm90IG1lZXQgdGhpcyByZXF1aXJlbWVudCB3aWxsIE5PVCB0cmlnZ2VyIHN3aXBlIGhhbmRsZXJzLgoJKiBAcHJvcGVydHkge2ludH0gW3RocmVzaG9sZD03NV0gVGhlIG51bWJlciBvZiBwaXhlbHMgdGhhdCB0aGUgdXNlciBtdXN0IG1vdmUgdGhlaXIgZmluZ2VyIGJ5IGJlZm9yZSBpdCBpcyBjb25zaWRlcmVkIGEgc3dpcGUuIAoJKiBAcHJvcGVydHkge2ludH0gW2NhbmNlbFRocmVzaG9sZD1udWxsXSBUaGUgbnVtYmVyIG9mIHBpeGVscyB0aGF0IHRoZSB1c2VyIG11c3QgbW92ZSB0aGVpciBmaW5nZXIgYmFjayBmcm9tIHRoZSBvcmlnaW5hbCBzd2lwZSBkaXJlY3Rpb24gdG8gY2FuY2VsIHRoZSBnZXN0dXJlLgoJKiBAcHJvcGVydHkge2ludH0gW3BpbmNoVGhyZXNob2xkPTIwXSBUaGUgbnVtYmVyIG9mIHBpeGVscyB0aGF0IHRoZSB1c2VyIG11c3QgcGluY2ggdGhlaXIgZmluZ2VyIGJ5IGJlZm9yZSBpdCBpcyBjb25zaWRlcmVkIGEgcGluY2guIAoJKiBAcHJvcGVydHkge2ludH0gW21heFRpbWVUaHJlc2hvbGQ9bnVsbF0gVGltZSwgaW4gbWlsbGlzZWNvbmRzLCBiZXR3ZWVuIHRvdWNoU3RhcnQgYW5kIHRvdWNoRW5kIG11c3QgTk9UIGV4Y2VlZCBpbiBvcmRlciB0byBiZSBjb25zaWRlcmVkIGEgc3dpcGUuIAoJKiBAcHJvcGVydHkge2ludH0gW2ZpbmdlclJlbGVhc2VUaHJlc2hvbGQ9MjUwXSBUaW1lIGluIG1pbGxpc2Vjb25kcyBiZXR3ZWVuIHJlbGVhc2luZyBtdWx0aXBsZSBmaW5nZXJzLiAgSWYgMiBmaW5nZXJzIGFyZSBkb3duLCBhbmQgYXJlIHJlbGVhc2VkIG9uZSBhZnRlciB0aGUgb3RoZXIsIGlmIHRoZXkgYXJlIHdpdGhpbiB0aGlzIHRocmVzaG9sZCwgaXQgY291bnRzIGFzIGEgc2ltdWx0YW5lb3VzIHJlbGVhc2UuIAoJKiBAcHJvcGVydHkge2ludH0gW2xvbmdUYXBUaHJlc2hvbGQ9NTAwXSBUaW1lIGluIG1pbGxpc2Vjb25kcyBiZXR3ZWVuIHRhcCBhbmQgcmVsZWFzZSBmb3IgYSBsb25nIHRhcAoJKiBAcHJvcGVydHkge2ludH0gW2RvdWJsZVRhcFRocmVzaG9sZD0yMDBdIFRpbWUgaW4gbWlsbGlzZWNvbmRzIGJldHdlZW4gMiB0YXBzIHRvIGNvdW50IGFzIGEgZG91YmxlIHRhcAoJKiBAcHJvcGVydHkge2Z1bmN0aW9ufSBbc3dpcGU9bnVsbF0gQSBoYW5kbGVyIHRvIGNhdGNoIGFsbCBzd2lwZXMuIFNlZSB7QGxpbmsgJC5mbi5zd2lwZSNldmVudDpzd2lwZX0KCSogQHByb3BlcnR5IHtmdW5jdGlvbn0gW3N3aXBlTGVmdD1udWxsXSBBIGhhbmRsZXIgdGhhdCBpcyB0cmlnZ2VyZWQgZm9yICJsZWZ0IiBzd2lwZXMuIFNlZSB7QGxpbmsgJC5mbi5zd2lwZSNldmVudDpzd2lwZUxlZnR9CgkqIEBwcm9wZXJ0eSB7ZnVuY3Rpb259IFtzd2lwZVJpZ2h0PW51bGxdIEEgaGFuZGxlciB0aGF0IGlzIHRyaWdnZXJlZCBmb3IgInJpZ2h0IiBzd2lwZXMuIFNlZSB7QGxpbmsgJC5mbi5zd2lwZSNldmVudDpzd2lwZVJpZ2h0fQoJKiBAcHJvcGVydHkge2Z1bmN0aW9ufSBbc3dpcGVVcD1udWxsXSBBIGhhbmRsZXIgdGhhdCBpcyB0cmlnZ2VyZWQgZm9yICJ1cCIgc3dpcGVzLiBTZWUge0BsaW5rICQuZm4uc3dpcGUjZXZlbnQ6c3dpcGVVcH0KCSogQHByb3BlcnR5IHtmdW5jdGlvbn0gW3N3aXBlRG93bj1udWxsXSBBIGhhbmRsZXIgdGhhdCBpcyB0cmlnZ2VyZWQgZm9yICJkb3duIiBzd2lwZXMuIFNlZSB7QGxpbmsgJC5mbi5zd2lwZSNldmVudDpzd2lwZURvd259CgkqIEBwcm9wZXJ0eSB7ZnVuY3Rpb259IFtzd2lwZVN0YXR1cz1udWxsXSBBIGhhbmRsZXIgdHJpZ2dlcmVkIGZvciBldmVyeSBwaGFzZSBvZiB0aGUgc3dpcGUuIFNlZSB7QGxpbmsgJC5mbi5zd2lwZSNldmVudDpzd2lwZVN0YXR1c30KCSogQHByb3BlcnR5IHtmdW5jdGlvbn0gW3BpbmNoSW49bnVsbF0gQSBoYW5kbGVyIHRyaWdnZXJlZCBmb3IgcGluY2ggaW4gZXZlbnRzLiBTZWUge0BsaW5rICQuZm4uc3dpcGUjZXZlbnQ6cGluY2hJbn0KCSogQHByb3BlcnR5IHtmdW5jdGlvbn0gW3BpbmNoT3V0PW51bGxdIEEgaGFuZGxlciB0cmlnZ2VyZWQgZm9yIHBpbmNoIG91dCBldmVudHMuIFNlZSB7QGxpbmsgJC5mbi5zd2lwZSNldmVudDpwaW5jaE91dH0KCSogQHByb3BlcnR5IHtmdW5jdGlvbn0gW3BpbmNoU3RhdHVzPW51bGxdIEEgaGFuZGxlciB0cmlnZ2VyZWQgZm9yIGV2ZXJ5IHBoYXNlIG9mIGEgcGluY2guIFNlZSB7QGxpbmsgJC5mbi5zd2lwZSNldmVudDpwaW5jaFN0YXR1c30KCSogQHByb3BlcnR5IHtmdW5jdGlvbn0gW3RhcD1udWxsXSBBIGhhbmRsZXIgdHJpZ2dlcmVkIHdoZW4gYSB1c2VyIGp1c3QgdGFwcyBvbiB0aGUgaXRlbSwgcmF0aGVyIHRoYW4gc3dpcGVzIGl0LiBJZiB0aGV5IGRvIG5vdCBtb3ZlLCB0YXAgaXMgdHJpZ2dlcmVkLCBpZiB0aGV5IGRvIG1vdmUsIGl0IGlzIG5vdC4gCgkqIEBwcm9wZXJ0eSB7ZnVuY3Rpb259IFtkb3VibGVUYXA9bnVsbF0gQSBoYW5kbGVyIHRyaWdnZXJlZCB3aGVuIGEgdXNlciBkb3VibGUgdGFwcyBvbiB0aGUgaXRlbS4gVGhlIGRlbGF5IGJldHdlZW4gdGFwcyBjYW4gYmUgc2V0IHdpdGggdGhlIGRvdWJsZVRhcFRocmVzaG9sZCBwcm9wZXJ0eS4gU2VlIHtAbGluayAkLmZuLnN3aXBlLmRlZmF1bHRzI2RvdWJsZVRhcFRocmVzaG9sZH0KCSogQHByb3BlcnR5IHtmdW5jdGlvbn0gW2xvbmdUYXA9bnVsbF0gQSBoYW5kbGVyIHRyaWdnZXJlZCB3aGVuIGEgdXNlciBsb25nIHRhcHMgb24gdGhlIGl0ZW0uIFRoZSBkZWxheSBiZXR3ZWVuIHN0YXJ0IGFuZCBlbmQgY2FuIGJlIHNldCB3aXRoIHRoZSBsb25nVGFwVGhyZXNob2xkIHByb3BlcnR5LiBTZWUge0BsaW5rICQuZm4uc3dpcGUuZGVmYXVsdHMjbG9uZ1RhcFRocmVzaG9sZH0KCSogQHByb3BlcnR5IChmdW5jdGlvbikgW2hvbGQ9bnVsbF0gQSBoYW5kbGVyIHRyaWdnZXJlZCB3aGVuIGEgdXNlciByZWFjaGVzIGxvbmdUYXBUaHJlc2hvbGQgb24gdGhlIGl0ZW0uIFNlZSB7QGxpbmsgJC5mbi5zd2lwZS5kZWZhdWx0cyNsb25nVGFwVGhyZXNob2xkfQoJKiBAcHJvcGVydHkge2Jvb2xlYW59IFt0cmlnZ2VyT25Ub3VjaEVuZD10cnVlXSBJZiB0cnVlLCB0aGUgc3dpcGUgZXZlbnRzIGFyZSB0cmlnZ2VyZWQgd2hlbiB0aGUgdG91Y2ggZW5kIGV2ZW50IGlzIHJlY2VpdmVkICh1c2VyIHJlbGVhc2VzIGZpbmdlcikuICBJZiBmYWxzZSwgaXQgd2lsbCBiZSB0cmlnZ2VyZWQgb24gcmVhY2hpbmcgdGhlIHRocmVzaG9sZCwgYW5kIHRoZW4gY2FuY2VsIHRoZSB0b3VjaCBldmVudCBhdXRvbWF0aWNhbGx5LiAKCSogQHByb3BlcnR5IHtib29sZWFufSBbdHJpZ2dlck9uVG91Y2hMZWF2ZT1mYWxzZV0gSWYgdHJ1ZSwgdGhlbiB3aGVuIHRoZSB1c2VyIGxlYXZlcyB0aGUgc3dpcGUgb2JqZWN0LCB0aGUgc3dpcGUgd2lsbCBlbmQgYW5kIHRyaWdnZXIgYXBwcm9wcmlhdGUgaGFuZGxlcnMuIAoJKiBAcHJvcGVydHkge3N0cmluZ3x1bmRlZmluZWR9IFthbGxvd1BhZ2VTY3JvbGw9J2F1dG8nXSBIb3cgdGhlIGJyb3dzZXIgaGFuZGxlcyBwYWdlIHNjcm9sbHMgd2hlbiB0aGUgdXNlciBpcyBzd2lwaW5nIG9uIGEgdG91Y2hTd2lwZSBvYmplY3QuIFNlZSB7QGxpbmsgJC5mbi5zd2lwZS5wYWdlU2Nyb2xsfS4gIDxici8+PGJyLz4KCQkJCQkJCQkJCTxjb2RlPiJhdXRvIjwvY29kZT4gOiBhbGwgdW5kZWZpbmVkIHN3aXBlcyB3aWxsIGNhdXNlIHRoZSBwYWdlIHRvIHNjcm9sbCBpbiB0aGF0IGRpcmVjdGlvbi4gPGJyLz4KCQkJCQkJCQkJCTxjb2RlPiJub25lIjwvY29kZT4gOiB0aGUgcGFnZSB3aWxsIG5vdCBzY3JvbGwgd2hlbiB1c2VyIHN3aXBlcy4gPGJyLz4KCQkJCQkJCQkJCTxjb2RlPiJob3Jpem9udGFsIjwvY29kZT4gOiB3aWxsIGZvcmNlIHBhZ2UgdG8gc2Nyb2xsIG9uIGhvcml6b250YWwgc3dpcGVzLiA8YnIvPgoJCQkJCQkJCQkJPGNvZGU+InZlcnRpY2FsIjwvY29kZT4gOiB3aWxsIGZvcmNlIHBhZ2UgdG8gc2Nyb2xsIG9uIHZlcnRpY2FsIHN3aXBlcy4gPGJyLz4KCSogQHByb3BlcnR5IHtib29sZWFufSBbZmFsbGJhY2tUb01vdXNlRXZlbnRzPXRydWVdIElmIHRydWUgbW91c2UgZXZlbnRzIGFyZSB1c2VkIHdoZW4gcnVuIG9uIGEgbm9uIHRvdWNoIGRldmljZSwgZmFsc2Ugd2lsbCBzdG9wIHN3aXBlcyBiZWluZyB0cmlnZ2VyZWQgYnkgbW91c2UgZXZlbnRzIG9uIG5vbiB0b2N1aCBkZXZpY2VzLiAKCSogQHByb3BlcnR5IHtzdHJpbmd9IFtleGNsdWRlZEVsZW1lbnRzPSJidXR0b24sIGlucHV0LCBzZWxlY3QsIHRleHRhcmVhLCBhLCAubm9Td2lwZSJdIEEganF1ZXJ5IHNlbGVjdG9yIHRoYXQgc3BlY2lmaWVzIGNoaWxkIGVsZW1lbnRzIHRoYXQgZG8gTk9UIHRyaWdnZXIgc3dpcGVzLiBCeSBkZWZhdWx0IHRoaXMgZXhjbHVkZXMgYWxsIGZvcm0sIGlucHV0LCBzZWxlY3QsIGJ1dHRvbiwgYW5jaG9yIGFuZCAubm9Td2lwZSBlbGVtZW50cy4gCgkKCSovCgl2YXIgZGVmYXVsdHMgPSB7CgkJZmluZ2VyczogMSwgCQkKCQl0aHJlc2hvbGQ6IDc1LCAJCgkJY2FuY2VsVGhyZXNob2xkOm51bGwsCQoJCXBpbmNoVGhyZXNob2xkOjIwLAoJCW1heFRpbWVUaHJlc2hvbGQ6IG51bGwsIAoJCWZpbmdlclJlbGVhc2VUaHJlc2hvbGQ6MjUwLCAKCQlsb25nVGFwVGhyZXNob2xkOjUwMCwKCQlkb3VibGVUYXBUaHJlc2hvbGQ6MjAwLAoJCXN3aXBlOiBudWxsLCAJCQoJCXN3aXBlTGVmdDogbnVsbCwgCQoJCXN3aXBlUmlnaHQ6IG51bGwsIAkKCQlzd2lwZVVwOiBudWxsLCAJCQoJCXN3aXBlRG93bjogbnVsbCwgCQoJCXN3aXBlU3RhdHVzOiBudWxsLCAJCgkJcGluY2hJbjpudWxsLAkJCgkJcGluY2hPdXQ6bnVsbCwJCQoJCXBpbmNoU3RhdHVzOm51bGwsCQoJCWNsaWNrOm51bGwsIC8vRGVwcmVjYXRlZCBzaW5jZSAxLjYuMgoJCXRhcDpudWxsLAoJCWRvdWJsZVRhcDpudWxsLAoJCWxvbmdUYXA6bnVsbCwgCQkKCQlob2xkOm51bGwsIAoJCXRyaWdnZXJPblRvdWNoRW5kOiB0cnVlLCAKCQl0cmlnZ2VyT25Ub3VjaExlYXZlOmZhbHNlLCAKCQlhbGxvd1BhZ2VTY3JvbGw6ICJhdXRvIiwgCgkJZmFsbGJhY2tUb01vdXNlRXZlbnRzOiB0cnVlLAkKCQlleGNsdWRlZEVsZW1lbnRzOiJsYWJlbCwgYnV0dG9uLCBpbnB1dCwgc2VsZWN0LCB0ZXh0YXJlYSwgYSwgLm5vU3dpcGUiCgl9OwoKCgoJLyoqCgkqIEFwcGxpZXMgVG91Y2hTd2lwZSBiZWhhdmlvdXIgdG8gb25lIG9yIG1vcmUgalF1ZXJ5IG9iamVjdHMuCgkqIFRoZSBUb3VjaFN3aXBlIHBsdWdpbiBjYW4gYmUgaW5zdGFudGlhdGVkIHZpYSB0aGlzIG1ldGhvZCwgb3IgbWV0aG9kcyB3aXRoaW4gCgkqIFRvdWNoU3dpcGUgY2FuIGJlIGV4ZWN1dGVkIHZpYSB0aGlzIG1ldGhvZCBhcyBwZXIgalF1ZXJ5IHBsdWdpbiBhcmNoaXRlY3R1cmUuCgkqIEBzZWUgVG91Y2hTd2lwZQoJKiBAY2xhc3MKCSogQHBhcmFtIHtNaXhlZH0gbWV0aG9kIElmIHRoZSBjdXJyZW50IERPTU5vZGUgaXMgYSBUb3VjaFN3aXBlIG9iamVjdCwgYW5kIDxjb2RlPm1ldGhvZDwvY29kZT4gaXMgYSBUb3VjaFN3aXBlIG1ldGhvZCwgdGhlbgoJKiB0aGUgPGNvZGU+bWV0aG9kPC9jb2RlPiBpcyBleGVjdXRlZCwgYW5kIGFueSBmb2xsb3dpbmcgYXJndW1lbnRzIGFyZSBwYXNzZWQgdG8gdGhlIFRvdWNoU3dpcGUgbWV0aG9kLgoJKiBJZiA8Y29kZT5tZXRob2Q8L2NvZGU+IGlzIGFuIG9iamVjdCwgdGhlbiB0aGUgVG91Y2hTd2lwZSBjbGFzcyBpcyBpbnN0YW50aWF0ZWQgb24gdGhlIGN1cnJlbnQgRE9NTm9kZSwgcGFzc2luZyB0aGUgCgkqIGNvbmZpZ3VyYXRpb24gcHJvcGVydGllcyBkZWZpbmVkIGluIHRoZSBvYmplY3QuIFNlZSBUb3VjaFN3aXBlCgkqCgkqLwoJJC5mbi5zd2lwZSA9IGZ1bmN0aW9uIChtZXRob2QpIHsKCQl2YXIgJHRoaXMgPSAkKHRoaXMpLAoJCQlwbHVnaW4gPSAkdGhpcy5kYXRhKFBMVUdJTl9OUyk7CgoJCS8vQ2hlY2sgaWYgd2UgYXJlIGFscmVhZHkgaW5zdGFudGlhdGVkIGFuZCB0cnlpbmcgdG8gZXhlY3V0ZSBhIG1ldGhvZAkKCQlpZiAocGx1Z2luICYmIHR5cGVvZiBtZXRob2QgPT09ICdzdHJpbmcnKSB7CgkJCWlmIChwbHVnaW5bbWV0aG9kXSkgewoJCQkJcmV0dXJuIHBsdWdpblttZXRob2RdLmFwcGx5KHRoaXMsIEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMSkpOwoJCQl9IGVsc2UgewoJCQkJJC5lcnJvcignTWV0aG9kICcgKyBtZXRob2QgKyAnIGRvZXMgbm90IGV4aXN0IG9uIGpRdWVyeS5zd2lwZScpOwoJCQl9CgkJfQoJCS8vRWxzZSBub3QgaW5zdGFudGlhdGVkIGFuZCB0cnlpbmcgdG8gcGFzcyBpbml0IG9iamVjdCAob3Igbm90aGluZykKCQllbHNlIGlmICghcGx1Z2luICYmICh0eXBlb2YgbWV0aG9kID09PSAnb2JqZWN0JyB8fCAhbWV0aG9kKSkgewoJCQlyZXR1cm4gaW5pdC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoJCX0KCgkJcmV0dXJuICR0aGlzOwoJfTsKCgkvL0V4cG9zZSBvdXIgZGVmYXVsdHMgc28gYSB1c2VyIGNvdWxkIG92ZXJyaWRlIHRoZSBwbHVnaW4gZGVmYXVsdHMKCSQuZm4uc3dpcGUuZGVmYXVsdHMgPSBkZWZhdWx0czsKCgkvKioKCSogVGhlIHBoYXNlcyB0aGF0IGEgdG91Y2ggZXZlbnQgZ29lcyB0aHJvdWdoLiAgVGhlIDxjb2RlPnBoYXNlPC9jb2RlPiBpcyBwYXNzZWQgdG8gdGhlIGV2ZW50IGhhbmRsZXJzLiAKCSogVGhlc2UgcHJvcGVydGllcyBhcmUgcmVhZCBvbmx5LCBhdHRlbXB0aW5nIHRvIGNoYW5nZSB0aGVtIHdpbGwgbm90IGFsdGVyIHRoZSB2YWx1ZXMgcGFzc2VkIHRvIHRoZSBldmVudCBoYW5kbGVycy4KCSogQG5hbWVzcGFjZQoJKiBAcmVhZG9ubHkKCSogQHByb3BlcnR5IHtzdHJpbmd9IFBIQVNFX1NUQVJUIENvbnN0YW50IGluZGljYXRpbmcgdGhlIHN0YXJ0IHBoYXNlIG9mIHRoZSB0b3VjaCBldmVudC4gVmFsdWUgaXMgPGNvZGU+InN0YXJ0IjwvY29kZT4uCgkqIEBwcm9wZXJ0eSB7c3RyaW5nfSBQSEFTRV9NT1ZFIENvbnN0YW50IGluZGljYXRpbmcgdGhlIG1vdmUgcGhhc2Ugb2YgdGhlIHRvdWNoIGV2ZW50LiBWYWx1ZSBpcyA8Y29kZT4ibW92ZSI8L2NvZGU+LgoJKiBAcHJvcGVydHkge3N0cmluZ30gUEhBU0VfRU5EIENvbnN0YW50IGluZGljYXRpbmcgdGhlIGVuZCBwaGFzZSBvZiB0aGUgdG91Y2ggZXZlbnQuIFZhbHVlIGlzIDxjb2RlPiJlbmQiPC9jb2RlPi4KCSogQHByb3BlcnR5IHtzdHJpbmd9IFBIQVNFX0NBTkNFTCBDb25zdGFudCBpbmRpY2F0aW5nIHRoZSBjYW5jZWwgcGhhc2Ugb2YgdGhlIHRvdWNoIGV2ZW50LiBWYWx1ZSBpcyA8Y29kZT4iY2FuY2VsIjwvY29kZT4uCgkqLwoJJC5mbi5zd2lwZS5waGFzZXMgPSB7CgkJUEhBU0VfU1RBUlQ6IFBIQVNFX1NUQVJULAoJCVBIQVNFX01PVkU6IFBIQVNFX01PVkUsCgkJUEhBU0VfRU5EOiBQSEFTRV9FTkQsCgkJUEhBU0VfQ0FOQ0VMOiBQSEFTRV9DQU5DRUwKCX07CgoJLyoqCgkqIFRoZSBkaXJlY3Rpb24gY29uc3RhbnRzIHRoYXQgYXJlIHBhc3NlZCB0byB0aGUgZXZlbnQgaGFuZGxlcnMuIAoJKiBUaGVzZSBwcm9wZXJ0aWVzIGFyZSByZWFkIG9ubHksIGF0dGVtcHRpbmcgdG8gY2hhbmdlIHRoZW0gd2lsbCBub3QgYWx0ZXIgdGhlIHZhbHVlcyBwYXNzZWQgdG8gdGhlIGV2ZW50IGhhbmRsZXJzLgoJKiBAbmFtZXNwYWNlCgkqIEByZWFkb25seQoJKiBAcHJvcGVydHkge3N0cmluZ30gTEVGVCBDb25zdGFudCBpbmRpY2F0aW5nIHRoZSBsZWZ0IGRpcmVjdGlvbi4gVmFsdWUgaXMgPGNvZGU+ImxlZnQiPC9jb2RlPi4KCSogQHByb3BlcnR5IHtzdHJpbmd9IFJJR0hUIENvbnN0YW50IGluZGljYXRpbmcgdGhlIHJpZ2h0IGRpcmVjdGlvbi4gVmFsdWUgaXMgPGNvZGU+InJpZ2h0IjwvY29kZT4uCgkqIEBwcm9wZXJ0eSB7c3RyaW5nfSBVUCBDb25zdGFudCBpbmRpY2F0aW5nIHRoZSB1cCBkaXJlY3Rpb24uIFZhbHVlIGlzIDxjb2RlPiJ1cCI8L2NvZGU+LgoJKiBAcHJvcGVydHkge3N0cmluZ30gRE9XTiBDb25zdGFudCBpbmRpY2F0aW5nIHRoZSBkb3duIGRpcmVjdGlvbi4gVmFsdWUgaXMgPGNvZGU+ImNhbmNlbCI8L2NvZGU+LgoJKiBAcHJvcGVydHkge3N0cmluZ30gSU4gQ29uc3RhbnQgaW5kaWNhdGluZyB0aGUgaW4gZGlyZWN0aW9uLiBWYWx1ZSBpcyA8Y29kZT4iaW4iPC9jb2RlPi4KCSogQHByb3BlcnR5IHtzdHJpbmd9IE9VVCBDb25zdGFudCBpbmRpY2F0aW5nIHRoZSBvdXQgZGlyZWN0aW9uLiBWYWx1ZSBpcyA8Y29kZT4ib3V0IjwvY29kZT4uCgkqLwoJJC5mbi5zd2lwZS5kaXJlY3Rpb25zID0gewoJCUxFRlQ6IExFRlQsCgkJUklHSFQ6IFJJR0hULAoJCVVQOiBVUCwKCQlET1dOOiBET1dOLAoJCUlOIDogSU4sCgkJT1VUOiBPVVQKCX07CgkKCS8qKgoJKiBUaGUgcGFnZSBzY3JvbGwgY29uc3RhbnRzIHRoYXQgY2FuIGJlIHVzZWQgdG8gc2V0IHRoZSB2YWx1ZSBvZiA8Y29kZT5hbGxvd1BhZ2VTY3JvbGw8L2NvZGU+IG9wdGlvbgoJKiBUaGVzZSBwcm9wZXJ0aWVzIGFyZSByZWFkIG9ubHkKCSogQG5hbWVzcGFjZQoJKiBAcmVhZG9ubHkKCSogQHNlZSAkLmZuLnN3aXBlLmRlZmF1bHRzI2FsbG93UGFnZVNjcm9sbAoJKiBAcHJvcGVydHkge3N0cmluZ30gTk9ORSBDb25zdGFudCBpbmRpY2F0aW5nIG5vIHBhZ2Ugc2Nyb2xsaW5nIGlzIGFsbG93ZWQuIFZhbHVlIGlzIDxjb2RlPiJub25lIjwvY29kZT4uCgkqIEBwcm9wZXJ0eSB7c3RyaW5nfSBIT1JJWk9OVEFMIENvbnN0YW50IGluZGljYXRpbmcgaG9yaXpvbnRhbCBwYWdlIHNjcm9sbGluZyBpcyBhbGxvd2VkLiBWYWx1ZSBpcyA8Y29kZT4iaG9yaXpvbnRhbCI8L2NvZGU+LgoJKiBAcHJvcGVydHkge3N0cmluZ30gVkVSVElDQUwgQ29uc3RhbnQgaW5kaWNhdGluZyB2ZXJ0aWNhbCBwYWdlIHNjcm9sbGluZyBpcyBhbGxvd2VkLiBWYWx1ZSBpcyA8Y29kZT4idmVydGljYWwiPC9jb2RlPi4KCSogQHByb3BlcnR5IHtzdHJpbmd9IEFVVE8gQ29uc3RhbnQgaW5kaWNhdGluZyBlaXRoZXIgaG9yaXpvbnRhbCBvciB2ZXJ0aWNhbCB3aWxsIGJlIGFsbG93ZWQsIGRlcGVuZGluZyBvbiB0aGUgc3dpcGUgaGFuZGxlcnMgcmVnaXN0ZXJlZC4gVmFsdWUgaXMgPGNvZGU+ImF1dG8iPC9jb2RlPi4KCSovCgkkLmZuLnN3aXBlLnBhZ2VTY3JvbGwgPSB7CgkJTk9ORTogTk9ORSwKCQlIT1JJWk9OVEFMOiBIT1JJWk9OVEFMLAoJCVZFUlRJQ0FMOiBWRVJUSUNBTCwKCQlBVVRPOiBBVVRPCgl9OwoKCS8qKgoJKiBDb25zdGFudHMgcmVwcmVzZW50aW5nIHRoZSBudW1iZXIgb2YgZmluZ2VycyB1c2VkIGluIGEgc3dpcGUuICBUaGVzZSBhcmUgdXNlZCB0byBzZXQgYm90aCB0aGUgdmFsdWUgb2YgPGNvZGU+ZmluZ2VyczwvY29kZT4gaW4gdGhlIAoJKiBvcHRpb25zIG9iamVjdCwgYXMgd2VsbCBhcyB0aGUgdmFsdWUgb2YgdGhlIDxjb2RlPmZpbmdlcnM8L2NvZGU+IGV2ZW50IHByb3BlcnR5LgoJKiBUaGVzZSBwcm9wZXJ0aWVzIGFyZSByZWFkIG9ubHksIGF0dGVtcHRpbmcgdG8gY2hhbmdlIHRoZW0gd2lsbCBub3QgYWx0ZXIgdGhlIHZhbHVlcyBwYXNzZWQgdG8gdGhlIGV2ZW50IGhhbmRsZXJzLgoJKiBAbmFtZXNwYWNlCgkqIEByZWFkb25seQoJKiBAc2VlICQuZm4uc3dpcGUuZGVmYXVsdHMjZmluZ2VycwoJKiBAcHJvcGVydHkge3N0cmluZ30gT05FIENvbnN0YW50IGluZGljYXRpbmcgMSBmaW5nZXIgaXMgdG8gYmUgZGV0ZWN0ZWQgLyB3YXMgZGV0ZWN0ZWQuIFZhbHVlIGlzIDxjb2RlPjE8L2NvZGU+LgoJKiBAcHJvcGVydHkge3N0cmluZ30gVFdPIENvbnN0YW50IGluZGljYXRpbmcgMiBmaW5nZXJzIGFyZSB0byBiZSBkZXRlY3RlZCAvIHdlcmUgZGV0ZWN0ZWQuIFZhbHVlIGlzIDxjb2RlPjE8L2NvZGU+LgoJKiBAcHJvcGVydHkge3N0cmluZ30gVEhSRUUgQ29uc3RhbnQgaW5kaWNhdGluZyAzIGZpbmdlciBhcmUgdG8gYmUgZGV0ZWN0ZWQgLyB3ZXJlIGRldGVjdGVkLiBWYWx1ZSBpcyA8Y29kZT4xPC9jb2RlPi4KCSogQHByb3BlcnR5IHtzdHJpbmd9IEFMTCBDb25zdGFudCBpbmRpY2F0aW5nIGFueSBjb21iaW5hdGlvbiBvZiBmaW5nZXIgYXJlIHRvIGJlIGRldGVjdGVkLiAgVmFsdWUgaXMgPGNvZGU+ImFsbCI8L2NvZGU+LgoJKi8KCSQuZm4uc3dpcGUuZmluZ2VycyA9IHsKCQlPTkU6IDEsCgkJVFdPOiAyLAoJCVRIUkVFOiAzLAoJCUFMTDogQUxMX0ZJTkdFUlMKCX07CgoJLyoqCgkqIEluaXRpYWxpc2UgdGhlIHBsdWdpbiBmb3IgZWFjaCBET00gZWxlbWVudCBtYXRjaGVkCgkqIFRoaXMgY3JlYXRlcyBhIG5ldyBpbnN0YW5jZSBvZiB0aGUgbWFpbiBUb3VjaFN3aXBlIGNsYXNzIGZvciBlYWNoIERPTSBlbGVtZW50LCBhbmQgdGhlbgoJKiBzYXZlcyBhIHJlZmVyZW5jZSB0byB0aGF0IGluc3RhbmNlIGluIHRoZSBlbGVtZW50cyBkYXRhIHByb3BlcnR5LgoJKiBAaW50ZXJuYWwKCSovCglmdW5jdGlvbiBpbml0KG9wdGlvbnMpIHsKCQkvL1ByZXAgYW5kIGV4dGVuZCB0aGUgb3B0aW9ucwoJCWlmIChvcHRpb25zICYmIChvcHRpb25zLmFsbG93UGFnZVNjcm9sbCA9PT0gdW5kZWZpbmVkICYmIChvcHRpb25zLnN3aXBlICE9PSB1bmRlZmluZWQgfHwgb3B0aW9ucy5zd2lwZVN0YXR1cyAhPT0gdW5kZWZpbmVkKSkpIHsKCQkJb3B0aW9ucy5hbGxvd1BhZ2VTY3JvbGwgPSBOT05FOwoJCX0KCQkKICAgICAgICAvL0NoZWNrIGZvciBkZXByZWNhdGVkIG9wdGlvbnMKCQkvL0Vuc3VyZSB0aGF0IGFueSBvbGQgY2xpY2sgaGFuZGxlcnMgYXJlIGFzc2lnbmVkIHRvIHRoZSBuZXcgdGFwLCB1bmxlc3Mgd2UgaGF2ZSBhIHRhcAoJCWlmKG9wdGlvbnMuY2xpY2shPT11bmRlZmluZWQgJiYgb3B0aW9ucy50YXA9PT11bmRlZmluZWQpIHsKCQkgICAgb3B0aW9ucy50YXAgPSBvcHRpb25zLmNsaWNrOwoJCX0KCgkJaWYgKCFvcHRpb25zKSB7CgkJCW9wdGlvbnMgPSB7fTsKCQl9CgkJCiAgICAgICAgLy9wYXNzIGVtcHR5IG9iamVjdCBzbyB3ZSBkb250IG1vZGlmeSB0aGUgZGVmYXVsdHMKCQlvcHRpb25zID0gJC5leHRlbmQoe30sICQuZm4uc3dpcGUuZGVmYXVsdHMsIG9wdGlvbnMpOwoKCQkvL0ZvciBlYWNoIGVsZW1lbnQgaW5zdGFudGlhdGUgdGhlIHBsdWdpbgoJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24gKCkgewoJCQl2YXIgJHRoaXMgPSAkKHRoaXMpOwoKCQkJLy9DaGVjayB3ZSBoYXZlbnQgYWxyZWFkeSBpbml0aWFsaXNlZCB0aGUgcGx1Z2luCgkJCXZhciBwbHVnaW4gPSAkdGhpcy5kYXRhKFBMVUdJTl9OUyk7CgoJCQlpZiAoIXBsdWdpbikgewoJCQkJcGx1Z2luID0gbmV3IFRvdWNoU3dpcGUodGhpcywgb3B0aW9ucyk7CgkJCQkkdGhpcy5kYXRhKFBMVUdJTl9OUywgcGx1Z2luKTsKCQkJfQoJCX0pOwoJfQoKCS8qKgoJKiBNYWluIFRvdWNoU3dpcGUgUGx1Z2luIENsYXNzLgoJKiBEbyBub3QgdXNlIHRoaXMgdG8gY29uc3RydWN0IHlvdXIgVG91Y2hTd2lwZSBvYmplY3QsIHVzZSB0aGUgalF1ZXJ5IHBsdWdpbiBtZXRob2QgJC5mbi5zd2lwZSgpOyB7QGxpbmsgJC5mbi5zd2lwZX0KCSogQHByaXZhdGUKCSogQG5hbWUgVG91Y2hTd2lwZQoJKiBAcGFyYW0ge0RPTU5vZGV9IGVsZW1lbnQgVGhlIEhUTUwgRE9NIG9iamVjdCB0byBhcHBseSB0byBwbHVnaW4gdG8KCSogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMgVGhlIG9wdGlvbnMgdG8gY29uZmlndXJlIHRoZSBwbHVnaW4gd2l0aC4gIEBsaW5rIHskLmZuLnN3aXBlLmRlZmF1bHRzfQoJKiBAc2VlICQuZmguc3dpcGUuZGVmYXVsdHMKCSogQHNlZSAkLmZoLnN3aXBlCiAgICAqIEBjbGFzcwoJKi8KCWZ1bmN0aW9uIFRvdWNoU3dpcGUoZWxlbWVudCwgb3B0aW9ucykgewogICAgICAgIHZhciB1c2VUb3VjaEV2ZW50cyA9IChTVVBQT1JUU19UT1VDSCB8fCBTVVBQT1JUU19QT0lOVEVSIHx8ICFvcHRpb25zLmZhbGxiYWNrVG9Nb3VzZUV2ZW50cyksCiAgICAgICAgICAgIFNUQVJUX0VWID0gdXNlVG91Y2hFdmVudHMgPyAoU1VQUE9SVFNfUE9JTlRFUiA/IChTVVBQT1JUU19QT0lOVEVSX0lFMTAgPyAnTVNQb2ludGVyRG93bicgOiAncG9pbnRlcmRvd24nKSA6ICd0b3VjaHN0YXJ0JykgOiAnbW91c2Vkb3duJywKICAgICAgICAgICAgTU9WRV9FViA9IHVzZVRvdWNoRXZlbnRzID8gKFNVUFBPUlRTX1BPSU5URVIgPyAoU1VQUE9SVFNfUE9JTlRFUl9JRTEwID8gJ01TUG9pbnRlck1vdmUnIDogJ3BvaW50ZXJtb3ZlJykgOiAndG91Y2htb3ZlJykgOiAnbW91c2Vtb3ZlJywKICAgICAgICAgICAgRU5EX0VWID0gdXNlVG91Y2hFdmVudHMgPyAoU1VQUE9SVFNfUE9JTlRFUiA/IChTVVBQT1JUU19QT0lOVEVSX0lFMTAgPyAnTVNQb2ludGVyVXAnIDogJ3BvaW50ZXJ1cCcpIDogJ3RvdWNoZW5kJykgOiAnbW91c2V1cCcsCiAgICAgICAgICAgIExFQVZFX0VWID0gdXNlVG91Y2hFdmVudHMgPyBudWxsIDogJ21vdXNlbGVhdmUnLCAvL3dlIG1hbnVhbGx5IGRldGVjdCBsZWF2ZSBvbiB0b3VjaCBkZXZpY2VzLCBzbyBudWxsIGV2ZW50IGhlcmUKICAgICAgICAgICAgQ0FOQ0VMX0VWID0gKFNVUFBPUlRTX1BPSU5URVIgPyAoU1VQUE9SVFNfUE9JTlRFUl9JRTEwID8gJ01TUG9pbnRlckNhbmNlbCcgOiAncG9pbnRlcmNhbmNlbCcpIDogJ3RvdWNoY2FuY2VsJyk7CgoKCgkJLy90b3VjaCBwcm9wZXJ0aWVzCgkJdmFyIGRpc3RhbmNlID0gMCwKCQkJZGlyZWN0aW9uID0gbnVsbCwKCQkJZHVyYXRpb24gPSAwLAoJCQlzdGFydFRvdWNoZXNEaXN0YW5jZSA9IDAsCgkJCWVuZFRvdWNoZXNEaXN0YW5jZSA9IDAsCgkJCXBpbmNoWm9vbSA9IDEsCgkJCXBpbmNoRGlzdGFuY2UgPSAwLAoJCQlwaW5jaERpcmVjdGlvbiA9IDAsCgkJCW1heGltdW1zTWFwPW51bGw7CgoJCQoJCQoJCS8valF1ZXJ5IHdyYXBwZWQgZWxlbWVudCBmb3IgdGhpcyBpbnN0YW5jZQoJCXZhciAkZWxlbWVudCA9ICQoZWxlbWVudCk7CgkJCgkJLy9DdXJyZW50IHBoYXNlIG9mIHRoIHRvdWNoIGN5Y2xlCgkJdmFyIHBoYXNlID0gInN0YXJ0IjsKCgkJLy8gdGhlIGN1cnJlbnQgbnVtYmVyIG9mIGZpbmdlcnMgYmVpbmcgdXNlZC4KCQl2YXIgZmluZ2VyQ291bnQgPSAwOyAJCQkKCgkJLy90cmFjayBtb3VzZSBwb2ludHMgLyBkZWx0YQoJCXZhciBmaW5nZXJEYXRhPW51bGw7CgoJCS8vdHJhY2sgdGltZXMKCQl2YXIgc3RhcnRUaW1lID0gMCwKCQkJZW5kVGltZSA9IDAsCgkJCXByZXZpb3VzVG91Y2hFbmRUaW1lPTAsCgkJCXByZXZpb3VzVG91Y2hGaW5nZXJDb3VudD0wLAoJCQlkb3VibGVUYXBTdGFydFRpbWU9MDsKCgkJLy9UaW1lb3V0cwoJCXZhciBzaW5nbGVUYXBUaW1lb3V0PW51bGwsCgkJCWhvbGRUaW1lb3V0PW51bGw7CiAgICAgICAgCgkJLy8gQWRkIGdlc3R1cmVzIHRvIGFsbCBzd2lwYWJsZSBhcmVhcyBpZiBzdXBwb3J0ZWQKCQl0cnkgewoJCQkkZWxlbWVudC5iaW5kKFNUQVJUX0VWLCB0b3VjaFN0YXJ0KTsKCQkJJGVsZW1lbnQuYmluZChDQU5DRUxfRVYsIHRvdWNoQ2FuY2VsKTsKCQl9CgkJY2F0Y2ggKGUpIHsKCQkJJC5lcnJvcignZXZlbnRzIG5vdCBzdXBwb3J0ZWQgJyArIFNUQVJUX0VWICsgJywnICsgQ0FOQ0VMX0VWICsgJyBvbiBqUXVlcnkuc3dpcGUnKTsKCQl9CgoJCS8vCgkJLy9QdWJsaWMgbWV0aG9kcwoJCS8vCgkJCgkJLyoqCgkJKiByZS1lbmFibGVzIHRoZSBzd2lwZSBwbHVnaW4gd2l0aCB0aGUgcHJldmlvdXMgY29uZmlndXJhdGlvbgoJCSogQGZ1bmN0aW9uCgkJKiBAbmFtZSAkLmZuLnN3aXBlI2VuYWJsZQoJCSogQHJldHVybiB7RE9NTm9kZX0gVGhlIERvbSBlbGVtZW50IHRoYXQgd2FzIHJlZ2lzdGVyZWQgd2l0aCBUb3VjaFN3aXBlIAoJCSogQGV4YW1wbGUgJCgiI2VsZW1lbnQiKS5zd2lwZSgiZW5hYmxlIik7CgkJKi8KCQl0aGlzLmVuYWJsZSA9IGZ1bmN0aW9uICgpIHsKCQkJJGVsZW1lbnQuYmluZChTVEFSVF9FViwgdG91Y2hTdGFydCk7CgkJCSRlbGVtZW50LmJpbmQoQ0FOQ0VMX0VWLCB0b3VjaENhbmNlbCk7CgkJCXJldHVybiAkZWxlbWVudDsKCQl9OwoKCQkvKioKCQkqIGRpc2FibGVzIHRoZSBzd2lwZSBwbHVnaW4KCQkqIEBmdW5jdGlvbgoJCSogQG5hbWUgJC5mbi5zd2lwZSNkaXNhYmxlCgkJKiBAcmV0dXJuIHtET01Ob2RlfSBUaGUgRG9tIGVsZW1lbnQgdGhhdCBpcyBub3cgcmVnaXN0ZXJlZCB3aXRoIFRvdWNoU3dpcGUKCSAgICAqIEBleGFtcGxlICQoIiNlbGVtZW50Iikuc3dpcGUoImRpc2FibGUiKTsKCQkqLwoJCXRoaXMuZGlzYWJsZSA9IGZ1bmN0aW9uICgpIHsKCQkJcmVtb3ZlTGlzdGVuZXJzKCk7CgkJCXJldHVybiAkZWxlbWVudDsKCQl9OwoKCQkvKioKCQkqIERlc3Ryb3kgdGhlIHN3aXBlIHBsdWdpbiBjb21wbGV0ZWx5LiBUbyB1c2UgYW55IHN3aXBlIG1ldGhvZHMsIHlvdSBtdXN0IHJlIGluaXRpYWxpc2UgdGhlIHBsdWdpbi4KCQkqIEBmdW5jdGlvbgoJCSogQG5hbWUgJC5mbi5zd2lwZSNkZXN0cm95CgkJKiBAcmV0dXJuIHtET01Ob2RlfSBUaGUgRG9tIGVsZW1lbnQgdGhhdCB3YXMgcmVnaXN0ZXJlZCB3aXRoIFRvdWNoU3dpcGUgCgkJKiBAZXhhbXBsZSAkKCIjZWxlbWVudCIpLnN3aXBlKCJkZXN0cm95Iik7CgkJKi8KCQl0aGlzLmRlc3Ryb3kgPSBmdW5jdGlvbiAoKSB7CgkJCXJlbW92ZUxpc3RlbmVycygpOwoJCQkkZWxlbWVudC5kYXRhKFBMVUdJTl9OUywgbnVsbCk7CgkJCXJldHVybiAkZWxlbWVudDsKCQl9OwoKCiAgICAgICAgLyoqCiAgICAgICAgICogQWxsb3dzIHJ1biB0aW1lIHVwZGF0aW5nIG9mIHRoZSBzd2lwZSBjb25maWd1cmF0aW9uIG9wdGlvbnMuCiAgICAgICAgICogQGZ1bmN0aW9uCiAgICAJICogQG5hbWUgJC5mbi5zd2lwZSNvcHRpb24KICAgIAkgKiBAcGFyYW0ge1N0cmluZ30gcHJvcGVydHkgVGhlIG9wdGlvbiBwcm9wZXJ0eSB0byBnZXQgb3Igc2V0CiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IFt2YWx1ZV0gVGhlIHZhbHVlIHRvIHNldCB0aGUgcHJvcGVydHkgdG8KCQkgKiBAcmV0dXJuIHtPYmplY3R9IElmIG9ubHkgYSBwcm9wZXJ0eSBuYW1lIGlzIHBhc3NlZCwgdGhlbiB0aGF0IHByb3BlcnR5IHZhbHVlIGlzIHJldHVybmVkLgoJCSAqIEBleGFtcGxlICQoIiNlbGVtZW50Iikuc3dpcGUoIm9wdGlvbiIsICJ0aHJlc2hvbGQiKTsgLy8gcmV0dXJuIHRoZSB0aHJlc2hvbGQKICAgICAgICAgKiBAZXhhbXBsZSAkKCIjZWxlbWVudCIpLnN3aXBlKCJvcHRpb24iLCAidGhyZXNob2xkIiwgMTAwKTsgLy8gc2V0IHRoZSB0aHJlc2hvbGQgYWZ0ZXIgaW5pdAogICAgICAgICAqIEBzZWUgJC5mbi5zd2lwZS5kZWZhdWx0cwogICAgICAgICAqCiAgICAgICAgICovCiAgICAgICAgdGhpcy5vcHRpb24gPSBmdW5jdGlvbiAocHJvcGVydHksIHZhbHVlKSB7CiAgICAgICAgICAgIGlmKG9wdGlvbnNbcHJvcGVydHldIT09dW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICBpZih2YWx1ZT09PXVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBvcHRpb25zW3Byb3BlcnR5XTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgb3B0aW9uc1twcm9wZXJ0eV0gPSB2YWx1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICQuZXJyb3IoJ09wdGlvbiAnICsgcHJvcGVydHkgKyAnIGRvZXMgbm90IGV4aXN0IG9uIGpRdWVyeS5zd2lwZS5vcHRpb25zJyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KCgkJLy8KCQkvLyBQcml2YXRlIG1ldGhvZHMKCQkvLwoJCQoJCS8vCgkJLy8gRVZFTlRTCgkJLy8KCQkvKioKCQkqIEV2ZW50IGhhbmRsZXIgZm9yIGEgdG91Y2ggc3RhcnQgZXZlbnQuCgkJKiBTdG9wcyB0aGUgZGVmYXVsdCBjbGljayBldmVudCBmcm9tIHRyaWdnZXJpbmcgYW5kIHN0b3JlcyB3aGVyZSB3ZSB0b3VjaGVkCgkJKiBAaW5uZXIKCQkqIEBwYXJhbSB7b2JqZWN0fSBqcUV2ZW50IFRoZSBub3JtYWxpc2VkIGpRdWVyeSBldmVudCBvYmplY3QuCgkJKi8KCQlmdW5jdGlvbiB0b3VjaFN0YXJ0KGpxRXZlbnQpIHsKCQkJLy9JZiB3ZSBhbHJlYWR5IGluIGEgdG91Y2ggZXZlbnQgKGEgZmluZ2VyIGFscmVhZHkgaW4gdXNlKSB0aGVuIGlnbm9yZSBzdWJzZXF1ZW50IG9uZXMuLgoJCQlpZiggZ2V0VG91Y2hJblByb2dyZXNzKCkgKQoJCQkJcmV0dXJuOwoJCQkKCQkJLy9DaGVjayBpZiB0aGlzIGVsZW1lbnQgbWF0Y2hlcyBhbnkgaW4gdGhlIGV4Y2x1ZGVkIGVsZW1lbnRzIHNlbGVjdG9ycywgIG9yIGl0cyBwYXJlbnQgaXMgZXhjbHVkZWQsIGlmIHNvLCBET04nVCBzd2lwZQoJCQlpZiggJChqcUV2ZW50LnRhcmdldCkuY2xvc2VzdCggb3B0aW9ucy5leGNsdWRlZEVsZW1lbnRzLCAkZWxlbWVudCApLmxlbmd0aD4wICkgCgkJCQlyZXR1cm47CgkJCQkKCQkJLy9BcyB3ZSB1c2UgSnF1ZXJ5IGJpbmQgZm9yIGV2ZW50cywgd2UgbmVlZCB0byB0YXJnZXQgdGhlIG9yaWdpbmFsIGV2ZW50IG9iamVjdAoJCQkvL0lmIHRoZXNlIGV2ZW50cyBhcmUgYmVpbmcgcHJvZ3JhbW1hdGljYWxseSB0cmlnZ2VyZWQsIHdlIGRvbid0IGhhdmUgYW4gb3JpZ2luYWwgZXZlbnQgb2JqZWN0LCBzbyB1c2UgdGhlIEpxIG9uZS4KCQkJdmFyIGV2ZW50ID0ganFFdmVudC5vcmlnaW5hbEV2ZW50ID8ganFFdmVudC5vcmlnaW5hbEV2ZW50IDoganFFdmVudDsKCQkJCgkJCXZhciByZXQsCgkJCQlldnQgPSBTVVBQT1JUU19UT1VDSCA/IGV2ZW50LnRvdWNoZXNbMF0gOiBldmVudDsKCgkJCXBoYXNlID0gUEhBU0VfU1RBUlQ7CgoJCQkvL0lmIHdlIHN1cHBvcnQgdG91Y2hlcywgZ2V0IHRoZSBmaW5nZXIgY291bnQKCQkJaWYgKFNVUFBPUlRTX1RPVUNIKSB7CgkJCQkvLyBnZXQgdGhlIHRvdGFsIG51bWJlciBvZiBmaW5nZXJzIHRvdWNoaW5nIHRoZSBzY3JlZW4KCQkJCWZpbmdlckNvdW50ID0gZXZlbnQudG91Y2hlcy5sZW5ndGg7CgkJCX0KCQkJLy9FbHNlIHRoaXMgaXMgdGhlIGRlc2t0b3AsIHNvIHN0b3AgdGhlIGJyb3dzZXIgZnJvbSBkcmFnZ2luZyB0aGUgaW1hZ2UKCQkJZWxzZSB7CgkJCQlqcUV2ZW50LnByZXZlbnREZWZhdWx0KCk7IC8vY2FsbCB0aGlzIG9uIGpxIGV2ZW50IHNvIHdlIGFyZSBjcm9zcyBicm93c2VyCgkJCX0KCgkJCS8vY2xlYXIgdmFycy4uCgkJCWRpc3RhbmNlID0gMDsKCQkJZGlyZWN0aW9uID0gbnVsbDsKCQkJcGluY2hEaXJlY3Rpb249bnVsbDsKCQkJZHVyYXRpb24gPSAwOwoJCQlzdGFydFRvdWNoZXNEaXN0YW5jZT0wOwoJCQllbmRUb3VjaGVzRGlzdGFuY2U9MDsKCQkJcGluY2hab29tID0gMTsKCQkJcGluY2hEaXN0YW5jZSA9IDA7CgkJCWZpbmdlckRhdGE9Y3JlYXRlQWxsRmluZ2VyRGF0YSgpOwoJCQltYXhpbXVtc01hcD1jcmVhdGVNYXhpbXVtc0RhdGEoKTsKCQkJY2FuY2VsTXVsdGlGaW5nZXJSZWxlYXNlKCk7CgoJCQkKCQkJLy8gY2hlY2sgdGhlIG51bWJlciBvZiBmaW5nZXJzIGlzIHdoYXQgd2UgYXJlIGxvb2tpbmcgZm9yLCBvciB3ZSBhcmUgY2FwdHVyaW5nIHBpbmNoZXMKCQkJaWYgKCFTVVBQT1JUU19UT1VDSCB8fCAoZmluZ2VyQ291bnQgPT09IG9wdGlvbnMuZmluZ2VycyB8fCBvcHRpb25zLmZpbmdlcnMgPT09IEFMTF9GSU5HRVJTKSB8fCBoYXNQaW5jaGVzKCkpIHsKCQkJCS8vIGdldCB0aGUgY29vcmRpbmF0ZXMgb2YgdGhlIHRvdWNoCgkJCQljcmVhdGVGaW5nZXJEYXRhKCAwLCBldnQgKTsKCQkJCXN0YXJ0VGltZSA9IGdldFRpbWVTdGFtcCgpOwoJCQkJCgkJCQlpZihmaW5nZXJDb3VudD09MikgewoJCQkJCS8vS2VlcCB0cmFjayBvZiB0aGUgaW5pdGlhbCBwaW5jaCBkaXN0YW5jZSwgc28gd2UgY2FuIGNhbGN1bGF0ZSB0aGUgZGlmZiBsYXRlcgoJCQkJCS8vU3RvcmUgc2Vjb25kIGZpbmdlciBkYXRhIGFzIHN0YXJ0CgkJCQkJY3JlYXRlRmluZ2VyRGF0YSggMSwgZXZlbnQudG91Y2hlc1sxXSApOwoJCQkJCXN0YXJ0VG91Y2hlc0Rpc3RhbmNlID0gZW5kVG91Y2hlc0Rpc3RhbmNlID0gY2FsY3VsYXRlVG91Y2hlc0Rpc3RhbmNlKGZpbmdlckRhdGFbMF0uc3RhcnQsIGZpbmdlckRhdGFbMV0uc3RhcnQpOwoJCQkJfQoJCQkJCgkJCQlpZiAob3B0aW9ucy5zd2lwZVN0YXR1cyB8fCBvcHRpb25zLnBpbmNoU3RhdHVzKSB7CgkJCQkJcmV0ID0gdHJpZ2dlckhhbmRsZXIoZXZlbnQsIHBoYXNlKTsKCQkJCX0KCQkJfQoJCQllbHNlIHsKCQkJCS8vQSB0b3VjaCB3aXRoIG1vcmUgb3IgbGVzcyB0aGFuIHRoZSBmaW5nZXJzIHdlIGFyZSBsb29raW5nIGZvciwgc28gY2FuY2VsCgkJCQlyZXQgPSBmYWxzZTsgCgkJCX0KCgkJCS8vSWYgd2UgaGF2ZSBhIHJldHVybiB2YWx1ZSBmcm9tIHRoZSB1c2VycyBoYW5kbGVyLCB0aGVuIHJldHVybiBhbmQgY2FuY2VsCgkJCWlmIChyZXQgPT09IGZhbHNlKSB7CgkJCQlwaGFzZSA9IFBIQVNFX0NBTkNFTDsKCQkJCXRyaWdnZXJIYW5kbGVyKGV2ZW50LCBwaGFzZSk7CgkJCQlyZXR1cm4gcmV0OwoJCQl9CgkJCWVsc2UgewoJCQkJaWYgKG9wdGlvbnMuaG9sZCkgewoJCQkJCWhvbGRUaW1lb3V0ID0gc2V0VGltZW91dCgkLnByb3h5KGZ1bmN0aW9uKCkgewoJCQkJCQkvL1RyaWdnZXIgdGhlIGV2ZW50CgkJCQkJCSRlbGVtZW50LnRyaWdnZXIoJ2hvbGQnLCBbZXZlbnQudGFyZ2V0XSk7CgkJCQkJCS8vRmlyZSB0aGUgY2FsbGJhY2sKCQkJCQkJaWYob3B0aW9ucy5ob2xkKSB7CgkJCQkJCQlyZXQgPSBvcHRpb25zLmhvbGQuY2FsbCgkZWxlbWVudCwgZXZlbnQsIGV2ZW50LnRhcmdldCk7CgkJCQkJCX0KCQkJCQl9LCB0aGlzKSwgb3B0aW9ucy5sb25nVGFwVGhyZXNob2xkICk7CgkJCQl9CgoJCQkJc2V0VG91Y2hJblByb2dyZXNzKHRydWUpOwoJCQl9CgogICAgICAgICAgICByZXR1cm4gbnVsbDsKCQl9OwoJCQoJCQoJCQoJCS8qKgoJCSogRXZlbnQgaGFuZGxlciBmb3IgYSB0b3VjaCBtb3ZlIGV2ZW50LiAKCQkqIElmIHdlIGNoYW5nZSBmaW5nZXJzIGR1cmluZyBtb3ZlLCB0aGVuIGNhbmNlbCB0aGUgZXZlbnQKCQkqIEBpbm5lcgoJCSogQHBhcmFtIHtvYmplY3R9IGpxRXZlbnQgVGhlIG5vcm1hbGlzZWQgalF1ZXJ5IGV2ZW50IG9iamVjdC4KCQkqLwoJCWZ1bmN0aW9uIHRvdWNoTW92ZShqcUV2ZW50KSB7CgkJCQoJCQkvL0FzIHdlIHVzZSBKcXVlcnkgYmluZCBmb3IgZXZlbnRzLCB3ZSBuZWVkIHRvIHRhcmdldCB0aGUgb3JpZ2luYWwgZXZlbnQgb2JqZWN0CgkJCS8vSWYgdGhlc2UgZXZlbnRzIGFyZSBiZWluZyBwcm9ncmFtbWF0aWNhbGx5IHRyaWdnZXJlZCwgd2UgZG9uJ3QgaGF2ZSBhbiBvcmlnaW5hbCBldmVudCBvYmplY3QsIHNvIHVzZSB0aGUgSnEgb25lLgoJCQl2YXIgZXZlbnQgPSBqcUV2ZW50Lm9yaWdpbmFsRXZlbnQgPyBqcUV2ZW50Lm9yaWdpbmFsRXZlbnQgOiBqcUV2ZW50OwoJCQkKCQkJLy9JZiB3ZSBhcmUgZW5kaW5nLCBjYW5jZWxsaW5nLCBvciB3aXRoaW4gdGhlIHRocmVzaG9sZCBvZiAyIGZpbmdlcnMgYmVpbmcgcmVsZWFzZWQsIGRvbid0IHRyYWNrIGFueXRoaW5nLi4KCQkJaWYgKHBoYXNlID09PSBQSEFTRV9FTkQgfHwgcGhhc2UgPT09IFBIQVNFX0NBTkNFTCB8fCBpbk11bHRpRmluZ2VyUmVsZWFzZSgpKQoJCQkJcmV0dXJuOwoKCQkJdmFyIHJldCwKCQkJCWV2dCA9IFNVUFBPUlRTX1RPVUNIID8gZXZlbnQudG91Y2hlc1swXSA6IGV2ZW50OwoJCQkKCgkJCS8vVXBkYXRlIHRoZSAgZmluZ2VyIGRhdGEgCgkJCXZhciBjdXJyZW50RmluZ2VyID0gdXBkYXRlRmluZ2VyRGF0YShldnQpOwoJCQllbmRUaW1lID0gZ2V0VGltZVN0YW1wKCk7CgkJCQoJCQlpZiAoU1VQUE9SVFNfVE9VQ0gpIHsKCQkJCWZpbmdlckNvdW50ID0gZXZlbnQudG91Y2hlcy5sZW5ndGg7CgkJCX0KCgkJCWlmIChvcHRpb25zLmhvbGQpCgkJCQljbGVhclRpbWVvdXQoaG9sZFRpbWVvdXQpOwoKCQkJcGhhc2UgPSBQSEFTRV9NT1ZFOwoKCQkJLy9JZiB3ZSBoYXZlIDIgZmluZ2VycyBnZXQgVG91Y2hlcyBkaXN0YW5jZSBhcyB3ZWxsCgkJCWlmKGZpbmdlckNvdW50PT0yKSB7CgkJCQkKCQkJCS8vS2VlcCB0cmFjayBvZiB0aGUgaW5pdGlhbCBwaW5jaCBkaXN0YW5jZSwgc28gd2UgY2FuIGNhbGN1bGF0ZSB0aGUgZGlmZiBsYXRlcgoJCQkJLy9XZSBkbyB0aGlzIGhlcmUgYXMgd2VsbCBhcyB0aGUgc3RhcnQgZXZlbnQsIGluIGNhc2UgdGhleSBzdGFydCB3aXRoIDEgZmluZ2VyLCBhbmQgdGhlIHByZXNzIDIgZmluZ2VycwoJCQkJaWYoc3RhcnRUb3VjaGVzRGlzdGFuY2U9PTApIHsKCQkJCQkvL0NyZWF0ZSBzZWNvbmQgZmluZ2VyIGlmIHRoaXMgaXMgdGhlIGZpcnN0IHRpbWUuLi4KCQkJCQljcmVhdGVGaW5nZXJEYXRhKCAxLCBldmVudC50b3VjaGVzWzFdICk7CgkJCQkJCgkJCQkJc3RhcnRUb3VjaGVzRGlzdGFuY2UgPSBlbmRUb3VjaGVzRGlzdGFuY2UgPSBjYWxjdWxhdGVUb3VjaGVzRGlzdGFuY2UoZmluZ2VyRGF0YVswXS5zdGFydCwgZmluZ2VyRGF0YVsxXS5zdGFydCk7CgkJCQl9IGVsc2UgewoJCQkJCS8vRWxzZSBqdXN0IHVwZGF0ZSB0aGUgc2Vjb25kIGZpbmdlcgoJCQkJCXVwZGF0ZUZpbmdlckRhdGEoZXZlbnQudG91Y2hlc1sxXSk7CgkJCQkKCQkJCQllbmRUb3VjaGVzRGlzdGFuY2UgPSBjYWxjdWxhdGVUb3VjaGVzRGlzdGFuY2UoZmluZ2VyRGF0YVswXS5lbmQsIGZpbmdlckRhdGFbMV0uZW5kKTsKCQkJCQlwaW5jaERpcmVjdGlvbiA9IGNhbGN1bGF0ZVBpbmNoRGlyZWN0aW9uKGZpbmdlckRhdGFbMF0uZW5kLCBmaW5nZXJEYXRhWzFdLmVuZCk7CgkJCQl9CgkJCQkKCQkJCQoJCQkJcGluY2hab29tID0gY2FsY3VsYXRlUGluY2hab29tKHN0YXJ0VG91Y2hlc0Rpc3RhbmNlLCBlbmRUb3VjaGVzRGlzdGFuY2UpOwoJCQkJcGluY2hEaXN0YW5jZSA9IE1hdGguYWJzKHN0YXJ0VG91Y2hlc0Rpc3RhbmNlIC0gZW5kVG91Y2hlc0Rpc3RhbmNlKTsKCQkJfQoJCQkKCQkJCgkJCWlmICggKGZpbmdlckNvdW50ID09PSBvcHRpb25zLmZpbmdlcnMgfHwgb3B0aW9ucy5maW5nZXJzID09PSBBTExfRklOR0VSUykgfHwgIVNVUFBPUlRTX1RPVUNIIHx8IGhhc1BpbmNoZXMoKSApIHsKCQkJCQoJCQkJZGlyZWN0aW9uID0gY2FsY3VsYXRlRGlyZWN0aW9uKGN1cnJlbnRGaW5nZXIuc3RhcnQsIGN1cnJlbnRGaW5nZXIuZW5kKTsKCQkJCQoJCQkJLy9DaGVjayBpZiB3ZSBuZWVkIHRvIHByZXZlbnQgZGVmYXVsdCBldmVudCAocGFnZSBzY3JvbGwgLyBwaW5jaCB6b29tKSBvciBub3QKCQkJCXZhbGlkYXRlRGVmYXVsdEV2ZW50KGpxRXZlbnQsIGRpcmVjdGlvbik7CgoJCQkJLy9EaXN0YW5jZSBhbmQgZHVyYXRpb24gYXJlIGFsbCBvZmYgdGhlIG1haW4gZmluZ2VyCgkJCQlkaXN0YW5jZSA9IGNhbGN1bGF0ZURpc3RhbmNlKGN1cnJlbnRGaW5nZXIuc3RhcnQsIGN1cnJlbnRGaW5nZXIuZW5kKTsKCQkJCWR1cmF0aW9uID0gY2FsY3VsYXRlRHVyYXRpb24oKTsKCiAgICAgICAgICAgICAgICAvL0NhY2hlIHRoZSBtYXhpbXVtIGRpc3RhbmNlIHdlIG1hZGUgaW4gdGhpcyBkaXJlY3Rpb24KICAgICAgICAgICAgICAgIHNldE1heERpc3RhbmNlKGRpcmVjdGlvbiwgZGlzdGFuY2UpOwoKCgkJCQlpZiAob3B0aW9ucy5zd2lwZVN0YXR1cyB8fCBvcHRpb25zLnBpbmNoU3RhdHVzKSB7CgkJCQkJcmV0ID0gdHJpZ2dlckhhbmRsZXIoZXZlbnQsIHBoYXNlKTsKCQkJCX0KCQkJCQoJCQkJCgkJCQkvL0lmIHdlIHRyaWdnZXIgZW5kIGV2ZW50cyB3aGVuIHRocmVzaG9sZCBhcmUgbWV0LCBvciB0cmlnZ2VyIGV2ZW50cyB3aGVuIHRvdWNoIGxlYXZlcyBlbGVtZW50CgkJCQlpZighb3B0aW9ucy50cmlnZ2VyT25Ub3VjaEVuZCB8fCBvcHRpb25zLnRyaWdnZXJPblRvdWNoTGVhdmUpIHsKCQkJCQkKCQkJCQl2YXIgaW5Cb3VuZHMgPSB0cnVlOwoJCQkJCQoJCQkJCS8vSWYgY2hlY2tpbmcgaWYgd2UgbGVhdmUgdGhlIGVsZW1lbnQsIHJ1biB0aGUgYm91bmRzIGNoZWNrICh3ZSBjYW4gdXNlIHRvdWNobGVhdmUgYXMgaXRzIG5vdCBzdXBwb3J0ZWQgb24gd2Via2l0KQoJCQkJCWlmKG9wdGlvbnMudHJpZ2dlck9uVG91Y2hMZWF2ZSkgewoJCQkJCQl2YXIgYm91bmRzID0gZ2V0Ym91bmRzKCB0aGlzICk7CgkJCQkJCWluQm91bmRzID0gaXNJbkJvdW5kcyggY3VycmVudEZpbmdlci5lbmQsIGJvdW5kcyApOwoJCQkJCX0KCQkJCQkKCQkJCQkvL1RyaWdnZXIgZW5kIGhhbmRsZXMgYXMgd2Ugc3dpcGUgaWYgdGhyZXNob2xkcyBtZXQgb3IgaWYgd2UgaGF2ZSBsZWZ0IHRoZSBlbGVtZW50IGlmIHRoZSB1c2VyIGhhcyBhc2tlZCB0byBjaGVjayB0aGVzZS4uCgkJCQkJaWYoIW9wdGlvbnMudHJpZ2dlck9uVG91Y2hFbmQgJiYgaW5Cb3VuZHMpIHsKCQkJCQkJcGhhc2UgPSBnZXROZXh0UGhhc2UoIFBIQVNFX01PVkUgKTsKCQkJCQl9IAoJCQkJCS8vV2UgZW5kIGlmIG91dCBvZiBib3VuZHMgaGVyZSwgc28gc2V0IGN1cnJlbnQgcGhhc2UgdG8gRU5ELCBhbmQgY2hlY2sgaWYgaXRzIG1vZGlmaWVkIAoJCQkJCWVsc2UgaWYob3B0aW9ucy50cmlnZ2VyT25Ub3VjaExlYXZlICYmICFpbkJvdW5kcyApIHsKCQkJCQkJcGhhc2UgPSBnZXROZXh0UGhhc2UoIFBIQVNFX0VORCApOwoJCQkJCX0KCQkJCQkJCgkJCQkJaWYocGhhc2U9PVBIQVNFX0NBTkNFTCB8fCBwaGFzZT09UEhBU0VfRU5EKQl7CgkJCQkJCXRyaWdnZXJIYW5kbGVyKGV2ZW50LCBwaGFzZSk7CgkJCQkJfQkJCQkKCQkJCX0KCQkJfQoJCQllbHNlIHsKCQkJCXBoYXNlID0gUEhBU0VfQ0FOQ0VMOwoJCQkJdHJpZ2dlckhhbmRsZXIoZXZlbnQsIHBoYXNlKTsKCQkJfQoKCQkJaWYgKHJldCA9PT0gZmFsc2UpIHsKCQkJCXBoYXNlID0gUEhBU0VfQ0FOQ0VMOwoJCQkJdHJpZ2dlckhhbmRsZXIoZXZlbnQsIHBoYXNlKTsKCQkJfQoJCX0KCgoKCQkvKioKCQkqIEV2ZW50IGhhbmRsZXIgZm9yIGEgdG91Y2ggZW5kIGV2ZW50LiAKCQkqIENhbGN1bGF0ZSB0aGUgZGlyZWN0aW9uIGFuZCB0cmlnZ2VyIGV2ZW50cwoJCSogQGlubmVyCgkJKiBAcGFyYW0ge29iamVjdH0ganFFdmVudCBUaGUgbm9ybWFsaXNlZCBqUXVlcnkgZXZlbnQgb2JqZWN0LgoJCSovCgkJZnVuY3Rpb24gdG91Y2hFbmQoanFFdmVudCkgewoJCQkvL0FzIHdlIHVzZSBKcXVlcnkgYmluZCBmb3IgZXZlbnRzLCB3ZSBuZWVkIHRvIHRhcmdldCB0aGUgb3JpZ2luYWwgZXZlbnQgb2JqZWN0CgkJCXZhciBldmVudCA9IGpxRXZlbnQub3JpZ2luYWxFdmVudDsKCQkJCQoKCQkJLy9JZiB3ZSBhcmUgc3RpbGwgaW4gYSB0b3VjaCB3aXRoIGFub3RoZXIgZmluZ2VyIHJldHVybgoJCQkvL1RoaXMgYWxsb3dzIHVzIHRvIHdhaXQgYSBmcmFjdGlvbiBhbmQgc2VlIGlmIHRoZSBvdGhlciBmaW5nZXIgY29tZXMgdXAsIGlmIGl0IGRvZXMgd2l0aGluIHRoZSB0aHJlc2hvbGQsIHRoZW4gd2UgdHJlYXQgaXQgYXMgYSBtdWx0aSByZWxlYXNlLCBub3QgYSBzaW5nbGUgcmVsZWFzZS4KCQkJaWYgKFNVUFBPUlRTX1RPVUNIKSB7CgkJCQlpZihldmVudC50b3VjaGVzLmxlbmd0aD4wKSB7CgkJCQkJc3RhcnRNdWx0aUZpbmdlclJlbGVhc2UoKTsKCQkJCQlyZXR1cm4gdHJ1ZTsKCQkJCX0KCQkJfQoJCQkKCQkJLy9JZiBhIHByZXZpb3VzIGZpbmdlciBoYXMgYmVlbiByZWxlYXNlZCwgY2hlY2sgaG93IGxvbmcgYWdvLCBpZiB3aXRoaW4gdGhlIHRocmVzaG9sZCwgdGhlbiBhc3N1bWUgaXQgd2FzIGEgbXVsdGlmaW5nZXIgcmVsZWFzZS4KCQkJLy9UaGlzIGlzIHVzZWQgdG8gYWxsb3cgMiBmaW5nZXJzIHRvIHJlbGVhc2UgZnJhY3Rpb25hbGx5IGFmdGVyIGVhY2ggb3RoZXIsIHdoaWxzdCBtYWludGFpbmlnIHRoZSBldmVudCBhcyBjb250YWluZyAyIGZpbmdlcnMsIG5vdCAxCgkJCWlmKGluTXVsdGlGaW5nZXJSZWxlYXNlKCkpIHsJCgkJCQlmaW5nZXJDb3VudD1wcmV2aW91c1RvdWNoRmluZ2VyQ291bnQ7CgkJCX0JCgkJCgkJCS8vU2V0IGVuZCBvZiBzd2lwZQoJCQllbmRUaW1lID0gZ2V0VGltZVN0YW1wKCk7CgkJCQoJCQkvL0dldCBkdXJhdGlvbiBpbmNhc2UgbW92ZSB3YXMgbmV2ZXIgZmlyZWQKCQkJZHVyYXRpb24gPSBjYWxjdWxhdGVEdXJhdGlvbigpOwoJCQkKCQkJLy9JZiB3ZSB0cmlnZ2VyIGhhbmRsZXJzIGF0IGVuZCBvZiBzd2lwZSBPUiwgd2UgdHJpZ2dlciBkdXJpbmcsIGJ1dCB0aGV5IGRpZG50IHRyaWdnZXIgYW5kIHdlIGFyZSBzdGlsbCBpbiB0aGUgbW92ZSBwaGFzZQoJCQlpZihkaWRTd2lwZUJhY2tUb0NhbmNlbCgpIHx8ICF2YWxpZGF0ZVN3aXBlRGlzdGFuY2UoKSkgewoJCQkgICAgcGhhc2UgPSBQSEFTRV9DQU5DRUw7CiAgICAgICAgICAgICAgICB0cmlnZ2VySGFuZGxlcihldmVudCwgcGhhc2UpOwoJCQl9IGVsc2UgaWYgKG9wdGlvbnMudHJpZ2dlck9uVG91Y2hFbmQgfHwgKG9wdGlvbnMudHJpZ2dlck9uVG91Y2hFbmQgPT0gZmFsc2UgJiYgcGhhc2UgPT09IFBIQVNFX01PVkUpKSB7CgkJCQkvL2NhbGwgdGhpcyBvbiBqcSBldmVudCBzbyB3ZSBhcmUgY3Jvc3MgYnJvd3NlciAKCQkJCWpxRXZlbnQucHJldmVudERlZmF1bHQoKTsgCgkJCQlwaGFzZSA9IFBIQVNFX0VORDsKICAgICAgICAgICAgICAgIHRyaWdnZXJIYW5kbGVyKGV2ZW50LCBwaGFzZSk7CgkJCX0KCQkJLy9TcGVjaWFsIGNhc2VzIC0gQSB0YXAgc2hvdWxkIGFsd2F5cyBmaXJlIG9uIHRvdWNoIGVuZCByZWdhcmRsZXNzLAoJCQkvL1NvIGhlcmUgd2UgbWFudWFsbHkgdHJpZ2dlciB0aGUgdGFwIGVuZCBoYW5kbGVyIGJ5IGl0c2VsZgoJCQkvL1dlIGRvbnQgcnVuIHRyaWdnZXIgaGFuZGxlciBhcyBpdCB3aWxsIHJlLXRyaWdnZXIgZXZlbnRzIHRoYXQgbWF5IGhhdmUgZmlyZWQgYWxyZWFkeQoJCQllbHNlIGlmICghb3B0aW9ucy50cmlnZ2VyT25Ub3VjaEVuZCAmJiBoYXNUYXAoKSkgewogICAgICAgICAgICAgICAgLy9UcmlnZ2VyIHRoZSBwaW5jaCBldmVudHMuLi4KCQkJICAgIHBoYXNlID0gUEhBU0VfRU5EOwoJCQkgICAgdHJpZ2dlckhhbmRsZXJGb3JHZXN0dXJlKGV2ZW50LCBwaGFzZSwgVEFQKTsKCQkJfQoJCQllbHNlIGlmIChwaGFzZSA9PT0gUEhBU0VfTU9WRSkgewoJCQkJcGhhc2UgPSBQSEFTRV9DQU5DRUw7CgkJCQl0cmlnZ2VySGFuZGxlcihldmVudCwgcGhhc2UpOwoJCQl9CgoJCQlzZXRUb3VjaEluUHJvZ3Jlc3MoZmFsc2UpOwoKICAgICAgICAgICAgcmV0dXJuIG51bGw7CgkJfQoKCgoJCS8qKgoJCSogRXZlbnQgaGFuZGxlciBmb3IgYSB0b3VjaCBjYW5jZWwgZXZlbnQuIAoJCSogQ2xlYXJzIGN1cnJlbnQgdmFycwoJCSogQGlubmVyCgkJKi8KCQlmdW5jdGlvbiB0b3VjaENhbmNlbCgpIHsKCQkJLy8gcmVzZXQgdGhlIHZhcmlhYmxlcyBiYWNrIHRvIGRlZmF1bHQgdmFsdWVzCgkJCWZpbmdlckNvdW50ID0gMDsKCQkJZW5kVGltZSA9IDA7CgkJCXN0YXJ0VGltZSA9IDA7CgkJCXN0YXJ0VG91Y2hlc0Rpc3RhbmNlPTA7CgkJCWVuZFRvdWNoZXNEaXN0YW5jZT0wOwoJCQlwaW5jaFpvb209MTsKCQkJCgkJCS8vSWYgd2Ugd2VyZSBpbiBwcm9ncmVzcyBvZiB0cmFja2luZyBhIHBvc3NpYmxlIG11bHRpIHRvdWNoIGVuZCwgdGhlbiByZSBzZXQgaXQuCgkJCWNhbmNlbE11bHRpRmluZ2VyUmVsZWFzZSgpOwoJCQkKCQkJc2V0VG91Y2hJblByb2dyZXNzKGZhbHNlKTsKCQl9CgkJCgkJCgkJLyoqCgkJKiBFdmVudCBoYW5kbGVyIGZvciBhIHRvdWNoIGxlYXZlIGV2ZW50LiAKCQkqIFRoaXMgaXMgb25seSB0cmlnZ2VyZWQgb24gZGVza3RvcHMsIGluIHRvdWNoIHdlIHdvcmsgdGhpcyBvdXQgbWFudWFsbHkKCQkqIGFzIHRoZSB0b3VjaGxlYXZlIGV2ZW50IGlzIG5vdCBzdXBwb3J0ZWQgaW4gd2Via2l0CgkJKiBAaW5uZXIKCQkqLwoJCWZ1bmN0aW9uIHRvdWNoTGVhdmUoanFFdmVudCkgewoJCQl2YXIgZXZlbnQgPSBqcUV2ZW50Lm9yaWdpbmFsRXZlbnQ7CgkJCQoJCQkvL0lmIHdlIGhhdmUgdGhlIHRyaWdnZXIgb24gbGVhdmUgcHJvcGVydHkgc2V0Li4uLgoJCQlpZihvcHRpb25zLnRyaWdnZXJPblRvdWNoTGVhdmUpIHsKCQkJCXBoYXNlID0gZ2V0TmV4dFBoYXNlKCBQSEFTRV9FTkQgKTsKCQkJCXRyaWdnZXJIYW5kbGVyKGV2ZW50LCBwaGFzZSk7CgkJCX0KCQl9CgkJCgkJLyoqCgkJKiBSZW1vdmVzIGFsbCBsaXN0ZW5lcnMgdGhhdCB3ZXJlIGFzc29jaWF0ZWQgd2l0aCB0aGUgcGx1Z2luCgkJKiBAaW5uZXIKCQkqLwoJCWZ1bmN0aW9uIHJlbW92ZUxpc3RlbmVycygpIHsKCQkJJGVsZW1lbnQudW5iaW5kKFNUQVJUX0VWLCB0b3VjaFN0YXJ0KTsKCQkJJGVsZW1lbnQudW5iaW5kKENBTkNFTF9FViwgdG91Y2hDYW5jZWwpOwoJCQkkZWxlbWVudC51bmJpbmQoTU9WRV9FViwgdG91Y2hNb3ZlKTsKCQkJJGVsZW1lbnQudW5iaW5kKEVORF9FViwgdG91Y2hFbmQpOwoJCQkKCQkJLy93ZSBvbmx5IGhhdmUgbGVhdmUgZXZlbnRzIG9uIGRlc2t0b3AsIHdlIG1hbnVhbGx5IGNhbGN1bGF0ZSBsZWF2ZSBvbiB0b3VjaCBhcyBpdHMgbm90IHN1cHBvcnRlZCBpbiB3ZWJraXQKCQkJaWYoTEVBVkVfRVYpIHsgCgkJCQkkZWxlbWVudC51bmJpbmQoTEVBVkVfRVYsIHRvdWNoTGVhdmUpOwoJCQl9CgkJCQoJCQlzZXRUb3VjaEluUHJvZ3Jlc3MoZmFsc2UpOwoJCX0KCgkJCgkJLyoqCgkJICogQ2hlY2tzIGlmIHRoZSB0aW1lIGFuZCBkaXN0YW5jZSB0aHJlc2hvbGRzIGhhdmUgYmVlbiBtZXQsIGFuZCBpZiBzbyB0aGVuIHRoZSBhcHByb3ByaWF0ZSBoYW5kbGVycyBhcmUgZmlyZWQuCgkJICovCgkJZnVuY3Rpb24gZ2V0TmV4dFBoYXNlKGN1cnJlbnRQaGFzZSkgewoJCQkKCQkJdmFyIG5leHRQaGFzZSA9IGN1cnJlbnRQaGFzZTsKCQkJCgkJCS8vIEVuc3VyZSB3ZSBoYXZlIHZhbGlkIHN3aXBlICh1bmRlciB0aW1lIGFuZCBvdmVyIGRpc3RhbmNlICBhbmQgY2hlY2sgaWYgd2UgYXJlIG91dCBvZiBib3VuZC4uLikKCQkJdmFyIHZhbGlkVGltZSA9IHZhbGlkYXRlU3dpcGVUaW1lKCk7CgkJCXZhciB2YWxpZERpc3RhbmNlID0gdmFsaWRhdGVTd2lwZURpc3RhbmNlKCk7CgkJCXZhciBkaWRDYW5jZWwgPSBkaWRTd2lwZUJhY2tUb0NhbmNlbCgpOwoJCQkJCQkKCQkJLy9JZiB3ZSBoYXZlIGV4Y2VlZGVkIG91ciB0aW1lLCB0aGVuIGNhbmNlbAkKCQkJaWYoIXZhbGlkVGltZSB8fCBkaWRDYW5jZWwpIHsKCQkJCW5leHRQaGFzZSA9IFBIQVNFX0NBTkNFTDsKCQkJfQoJCQkvL0Vsc2UgaWYgd2UgYXJlIG1vdmluZywgYW5kIGhhdmUgcmVhY2hlZCBkaXN0YW5jZSB0aGVuIGVuZAoJCQllbHNlIGlmICh2YWxpZERpc3RhbmNlICYmIGN1cnJlbnRQaGFzZSA9PSBQSEFTRV9NT1ZFICYmICghb3B0aW9ucy50cmlnZ2VyT25Ub3VjaEVuZCB8fCBvcHRpb25zLnRyaWdnZXJPblRvdWNoTGVhdmUpICkgewoJCQkJbmV4dFBoYXNlID0gUEhBU0VfRU5EOwoJCQl9IAoJCQkvL0Vsc2UgaWYgd2UgaGF2ZSBlbmRlZCBieSBsZWF2aW5nIGFuZCBkaWRuJ3QgcmVhY2ggZGlzdGFuY2UsIHRoZW4gY2FuY2VsCgkJCWVsc2UgaWYgKCF2YWxpZERpc3RhbmNlICYmIGN1cnJlbnRQaGFzZT09UEhBU0VfRU5EICYmIG9wdGlvbnMudHJpZ2dlck9uVG91Y2hMZWF2ZSkgewoJCQkJbmV4dFBoYXNlID0gUEhBU0VfQ0FOQ0VMOwoJCQl9CgkJCQoJCQlyZXR1cm4gbmV4dFBoYXNlOwoJCX0KCQkKCQkKCQkvKioKCQkqIFRyaWdnZXIgdGhlIHJlbGV2YW50IGV2ZW50IGhhbmRsZXIKCQkqIFRoZSBoYW5kbGVycyBhcmUgcGFzc2VkIHRoZSBvcmlnaW5hbCBldmVudCwgdGhlIGVsZW1lbnQgdGhhdCB3YXMgc3dpcGVkLCBhbmQgaW4gdGhlIGNhc2Ugb2YgdGhlIGNhdGNoIGFsbCBoYW5kbGVyLCB0aGUgZGlyZWN0aW9uIHRoYXQgd2FzIHN3aXBlZCwgImxlZnQiLCAicmlnaHQiLCAidXAiLCBvciAiZG93biIKCQkqIEBwYXJhbSB7b2JqZWN0fSBldmVudCB0aGUgb3JpZ2luYWwgZXZlbnQgb2JqZWN0CgkJKiBAcGFyYW0ge3N0cmluZ30gcGhhc2UgdGhlIHBoYXNlIG9mIHRoZSBzd2lwZSAoc3RhcnQsIGVuZCBjYW5jZWwgZXRjKSB7QGxpbmsgJC5mbi5zd2lwZS5waGFzZXN9CgkJKiBAaW5uZXIKCQkqLwoJCWZ1bmN0aW9uIHRyaWdnZXJIYW5kbGVyKGV2ZW50LCBwaGFzZSkgewoJCQkKCQkJdmFyIHJldCA9IHVuZGVmaW5lZDsKCQkJCgkJCS8vIFNXSVBFIEdFU1RVUkVTCgkJCWlmKGRpZFN3aXBlKCkgfHwgaGFzU3dpcGVzKCkpIHsgLy9oYXNTd2lwZXMgYXMgc3RhdHVzIG5lZWRzIHRvIGZpcmUgZXZlbiBpZiBzd2lwZSBpcyBpbnZhbGlkCgkJCQkvL1RyaWdnZXIgdGhlIHN3aXBlIGV2ZW50cy4uLgoJCQkJcmV0ID0gdHJpZ2dlckhhbmRsZXJGb3JHZXN0dXJlKGV2ZW50LCBwaGFzZSwgU1dJUEUpOwoJCQl9IAoJCQkKCQkJLy8gUElOQ0ggR0VTVFVSRVMgKGlmIHRoZSBhYm92ZSBkaWRuJ3QgY2FuY2VsKQoJCQllbHNlIGlmKChkaWRQaW5jaCgpIHx8IGhhc1BpbmNoZXMoKSkgJiYgcmV0IT09ZmFsc2UpIHsKCQkJCS8vVHJpZ2dlciB0aGUgcGluY2ggZXZlbnRzLi4uCgkJCQlyZXQgPSB0cmlnZ2VySGFuZGxlckZvckdlc3R1cmUoZXZlbnQsIHBoYXNlLCBQSU5DSCk7CgkJCX0KCQkJCgkJCS8vIENMSUNLIC8gVEFQIChpZiB0aGUgYWJvdmUgZGlkbid0IGNhbmNlbCkKCQkJaWYoZGlkRG91YmxlVGFwKCkgJiYgcmV0IT09ZmFsc2UpIHsKCQkJCS8vVHJpZ2dlciB0aGUgdGFwIGV2ZW50cy4uLgoJCQkJcmV0ID0gdHJpZ2dlckhhbmRsZXJGb3JHZXN0dXJlKGV2ZW50LCBwaGFzZSwgRE9VQkxFX1RBUCk7CgkJCX0KCQkJCgkJCS8vIENMSUNLIC8gVEFQIChpZiB0aGUgYWJvdmUgZGlkbid0IGNhbmNlbCkKCQkJZWxzZSBpZihkaWRMb25nVGFwKCkgJiYgcmV0IT09ZmFsc2UpIHsKCQkJCS8vVHJpZ2dlciB0aGUgdGFwIGV2ZW50cy4uLgoJCQkJcmV0ID0gdHJpZ2dlckhhbmRsZXJGb3JHZXN0dXJlKGV2ZW50LCBwaGFzZSwgTE9OR19UQVApOwoJCQl9CgoJCQkvLyBDTElDSyAvIFRBUCAoaWYgdGhlIGFib3ZlIGRpZG4ndCBjYW5jZWwpCgkJCWVsc2UgaWYoZGlkVGFwKCkgJiYgcmV0IT09ZmFsc2UpIHsKCQkJCS8vVHJpZ2dlciB0aGUgdGFwIGV2ZW50Li4KCQkJCXJldCA9IHRyaWdnZXJIYW5kbGVyRm9yR2VzdHVyZShldmVudCwgcGhhc2UsIFRBUCk7CgkJCX0KCQkJCgkJCQoJCQkKCQkJLy8gSWYgd2UgYXJlIGNhbmNlbGxpbmcgdGhlIGdlc3R1cmUsIHRoZW4gbWFudWFsbHkgdHJpZ2dlciB0aGUgcmVzZXQgaGFuZGxlcgoJCQlpZiAocGhhc2UgPT09IFBIQVNFX0NBTkNFTCkgewoJCQkJdG91Y2hDYW5jZWwoZXZlbnQpOwoJCQl9CgkJCQoJCQkvLyBJZiB3ZSBhcmUgZW5kaW5nIHRoZSBnZXN0dXJlLCB0aGVuIG1hbnVhbGx5IHRyaWdnZXIgdGhlIHJlc2V0IGhhbmRsZXIgSUYgYWxsIGZpbmdlcnMgYXJlIG9mZgoJCQlpZihwaGFzZSA9PT0gUEhBU0VfRU5EKSB7CgkJCQkvL0lmIHdlIHN1cHBvcnQgdG91Y2gsIHRoZW4gY2hlY2sgdGhhdCBhbGwgZmluZ2VycyBhcmUgb2ZmIGJlZm9yZSB3ZSBjYW5jZWwKCQkJCWlmIChTVVBQT1JUU19UT1VDSCkgewoJCQkJCWlmKGV2ZW50LnRvdWNoZXMubGVuZ3RoPT0wKSB7CgkJCQkJCXRvdWNoQ2FuY2VsKGV2ZW50KTsJCgkJCQkJfQoJCQkJfSAKCQkJCWVsc2UgewoJCQkJCXRvdWNoQ2FuY2VsKGV2ZW50KTsKCQkJCX0KCQkJfQoJCQkJCQoJCQlyZXR1cm4gcmV0OwoJCX0KCQkKCQkKCQkKCQkvKioKCQkqIFRyaWdnZXIgdGhlIHJlbGV2YW50IGV2ZW50IGhhbmRsZXIKCQkqIFRoZSBoYW5kbGVycyBhcmUgcGFzc2VkIHRoZSBvcmlnaW5hbCBldmVudCwgdGhlIGVsZW1lbnQgdGhhdCB3YXMgc3dpcGVkLCBhbmQgaW4gdGhlIGNhc2Ugb2YgdGhlIGNhdGNoIGFsbCBoYW5kbGVyLCB0aGUgZGlyZWN0aW9uIHRoYXQgd2FzIHN3aXBlZCwgImxlZnQiLCAicmlnaHQiLCAidXAiLCBvciAiZG93biIKCQkqIEBwYXJhbSB7b2JqZWN0fSBldmVudCB0aGUgb3JpZ2luYWwgZXZlbnQgb2JqZWN0CgkJKiBAcGFyYW0ge3N0cmluZ30gcGhhc2UgdGhlIHBoYXNlIG9mIHRoZSBzd2lwZSAoc3RhcnQsIGVuZCBjYW5jZWwgZXRjKSB7QGxpbmsgJC5mbi5zd2lwZS5waGFzZXN9CgkJKiBAcGFyYW0ge3N0cmluZ30gZ2VzdHVyZSB0aGUgZ2VzdHVyZSB0byB0cmlnZ2VyIGEgaGFuZGxlciBmb3IgOiBQSU5DSCBvciBTV0lQRSB7QGxpbmsgJC5mbi5zd2lwZS5nZXN0dXJlc30KCQkqIEByZXR1cm4gQm9vbGVhbiBGYWxzZSwgdG8gaW5kaWNhdGUgdGhhdCB0aGUgZXZlbnQgc2hvdWxkIHN0b3AgcHJvcGFnYXRpb24sIG9yIHZvaWQuCgkJKiBAaW5uZXIKCQkqLwoJCWZ1bmN0aW9uIHRyaWdnZXJIYW5kbGVyRm9yR2VzdHVyZShldmVudCwgcGhhc2UsIGdlc3R1cmUpIHsJCgkJCQoJCQl2YXIgcmV0PXVuZGVmaW5lZDsKCQkJCgkJCS8vU1dJUEVTLi4uLgoJCQlpZihnZXN0dXJlPT1TV0lQRSkgewoJCQkJLy9UcmlnZ2VyIHN0YXR1cyBldmVyeSB0aW1lLi4KCQkJCQoJCQkJLy9UcmlnZ2VyIHRoZSBldmVudC4uLgoJCQkJJGVsZW1lbnQudHJpZ2dlcignc3dpcGVTdGF0dXMnLCBbcGhhc2UsIGRpcmVjdGlvbiB8fCBudWxsLCBkaXN0YW5jZSB8fCAwLCBkdXJhdGlvbiB8fCAwLCBmaW5nZXJDb3VudCwgZmluZ2VyRGF0YV0pOwoJCQkJCgkJCQkvL0ZpcmUgdGhlIGNhbGxiYWNrCgkJCQlpZiAob3B0aW9ucy5zd2lwZVN0YXR1cykgewoJCQkJCXJldCA9IG9wdGlvbnMuc3dpcGVTdGF0dXMuY2FsbCgkZWxlbWVudCwgZXZlbnQsIHBoYXNlLCBkaXJlY3Rpb24gfHwgbnVsbCwgZGlzdGFuY2UgfHwgMCwgZHVyYXRpb24gfHwgMCwgZmluZ2VyQ291bnQsIGZpbmdlckRhdGEpOwoJCQkJCS8vSWYgdGhlIHN0YXR1cyBjYW5jZWxzLCB0aGVuIGRvbnQgcnVuIHRoZSBzdWJzZXF1ZW50IGV2ZW50IGhhbmRsZXJzLi4KCQkJCQlpZihyZXQ9PT1mYWxzZSkgcmV0dXJuIGZhbHNlOwoJCQkJfQoJCQkJCgkJCQkKCQkJCQoJCQkJCgkJCQlpZiAocGhhc2UgPT0gUEhBU0VfRU5EICYmIHZhbGlkYXRlU3dpcGUoKSkgewoJCQkJCS8vRmlyZSB0aGUgY2F0Y2ggYWxsIGV2ZW50CgkJCQkJJGVsZW1lbnQudHJpZ2dlcignc3dpcGUnLCBbZGlyZWN0aW9uLCBkaXN0YW5jZSwgZHVyYXRpb24sIGZpbmdlckNvdW50LCBmaW5nZXJEYXRhXSk7CgkJCQkJCgkJCQkJLy9GaXJlIGNhdGNoIGFsbCBjYWxsYmFjawoJCQkJCWlmIChvcHRpb25zLnN3aXBlKSB7CgkJCQkJCXJldCA9IG9wdGlvbnMuc3dpcGUuY2FsbCgkZWxlbWVudCwgZXZlbnQsIGRpcmVjdGlvbiwgZGlzdGFuY2UsIGR1cmF0aW9uLCBmaW5nZXJDb3VudCwgZmluZ2VyRGF0YSk7CgkJCQkJCS8vSWYgdGhlIHN0YXR1cyBjYW5jZWxzLCB0aGVuIGRvbnQgcnVuIHRoZSBzdWJzZXF1ZW50IGV2ZW50IGhhbmRsZXJzLi4KCQkJCQkJaWYocmV0PT09ZmFsc2UpIHJldHVybiBmYWxzZTsKCQkJCQl9CgkJCQkJCgkJCQkJLy90cmlnZ2VyIGRpcmVjdGlvbiBzcGVjaWZpYyBldmVudCBoYW5kbGVycwkKCQkJCQlzd2l0Y2ggKGRpcmVjdGlvbikgewoJCQkJCQljYXNlIExFRlQ6CgkJCQkJCQkvL1RyaWdnZXIgdGhlIGV2ZW50CgkJCQkJCQkkZWxlbWVudC50cmlnZ2VyKCdzd2lwZUxlZnQnLCBbZGlyZWN0aW9uLCBkaXN0YW5jZSwgZHVyYXRpb24sIGZpbmdlckNvdW50LCBmaW5nZXJEYXRhXSk7CgkJCQkJCgkJCQkJICAgICAgICAvL0ZpcmUgdGhlIGNhbGxiYWNrCgkJCQkJCQlpZiAob3B0aW9ucy5zd2lwZUxlZnQpIHsKCQkJCQkJCQlyZXQgPSBvcHRpb25zLnN3aXBlTGVmdC5jYWxsKCRlbGVtZW50LCBldmVudCwgZGlyZWN0aW9uLCBkaXN0YW5jZSwgZHVyYXRpb24sIGZpbmdlckNvdW50LCBmaW5nZXJEYXRhKTsKCQkJCQkJCX0KCQkJCQkJCWJyZWFrOwoJCgkJCQkJCWNhc2UgUklHSFQ6CgkJCQkJCQkvL1RyaWdnZXIgdGhlIGV2ZW50CgkJCQkJICAgICAgICAkZWxlbWVudC50cmlnZ2VyKCdzd2lwZVJpZ2h0JywgW2RpcmVjdGlvbiwgZGlzdGFuY2UsIGR1cmF0aW9uLCBmaW5nZXJDb3VudCwgZmluZ2VyRGF0YV0pOwoJCQkJCQoJCQkJCSAgICAgICAgLy9GaXJlIHRoZSBjYWxsYmFjawoJCQkJCQkJaWYgKG9wdGlvbnMuc3dpcGVSaWdodCkgewoJCQkJCQkJCXJldCA9IG9wdGlvbnMuc3dpcGVSaWdodC5jYWxsKCRlbGVtZW50LCBldmVudCwgZGlyZWN0aW9uLCBkaXN0YW5jZSwgZHVyYXRpb24sIGZpbmdlckNvdW50LCBmaW5nZXJEYXRhKTsKCQkJCQkJCX0KCQkJCQkJCWJyZWFrOwoJCgkJCQkJCWNhc2UgVVA6CgkJCQkJCQkvL1RyaWdnZXIgdGhlIGV2ZW50CgkJCQkJICAgICAgICAkZWxlbWVudC50cmlnZ2VyKCdzd2lwZVVwJywgW2RpcmVjdGlvbiwgZGlzdGFuY2UsIGR1cmF0aW9uLCBmaW5nZXJDb3VudCwgZmluZ2VyRGF0YV0pOwoJCQkJCQoJCQkJCSAgICAgICAgLy9GaXJlIHRoZSBjYWxsYmFjawoJCQkJCQkJaWYgKG9wdGlvbnMuc3dpcGVVcCkgewoJCQkJCQkJCXJldCA9IG9wdGlvbnMuc3dpcGVVcC5jYWxsKCRlbGVtZW50LCBldmVudCwgZGlyZWN0aW9uLCBkaXN0YW5jZSwgZHVyYXRpb24sIGZpbmdlckNvdW50LCBmaW5nZXJEYXRhKTsKCQkJCQkJCX0KCQkJCQkJCWJyZWFrOwoJCgkJCQkJCWNhc2UgRE9XTjoKCQkJCQkJCS8vVHJpZ2dlciB0aGUgZXZlbnQKCQkJCQkgICAgICAgICRlbGVtZW50LnRyaWdnZXIoJ3N3aXBlRG93bicsIFtkaXJlY3Rpb24sIGRpc3RhbmNlLCBkdXJhdGlvbiwgZmluZ2VyQ291bnQsIGZpbmdlckRhdGFdKTsKCQkJCQkKCQkJCQkgICAgICAgIC8vRmlyZSB0aGUgY2FsbGJhY2sKCQkJCQkJCWlmIChvcHRpb25zLnN3aXBlRG93bikgewoJCQkJCQkJCXJldCA9IG9wdGlvbnMuc3dpcGVEb3duLmNhbGwoJGVsZW1lbnQsIGV2ZW50LCBkaXJlY3Rpb24sIGRpc3RhbmNlLCBkdXJhdGlvbiwgZmluZ2VyQ291bnQsIGZpbmdlckRhdGEpOwoJCQkJCQkJfQoJCQkJCQkJYnJlYWs7CgkJCQkJfQoJCQkJfQoJCQl9CgkJCQoJCQkKCQkJLy9QSU5DSEVTLi4uLgoJCQlpZihnZXN0dXJlPT1QSU5DSCkgewoJCQkJLy9UcmlnZ2VyIHRoZSBldmVudAoJCQkgICAgICRlbGVtZW50LnRyaWdnZXIoJ3BpbmNoU3RhdHVzJywgW3BoYXNlLCBwaW5jaERpcmVjdGlvbiB8fCBudWxsLCBwaW5jaERpc3RhbmNlIHx8IDAsIGR1cmF0aW9uIHx8IDAsIGZpbmdlckNvdW50LCBwaW5jaFpvb20sIGZpbmdlckRhdGFdKTsKCQkJCQkKICAgICAgICAgICAgICAgIC8vRmlyZSB0aGUgY2FsbGJhY2sKCQkJCWlmIChvcHRpb25zLnBpbmNoU3RhdHVzKSB7CgkJCQkJcmV0ID0gb3B0aW9ucy5waW5jaFN0YXR1cy5jYWxsKCRlbGVtZW50LCBldmVudCwgcGhhc2UsIHBpbmNoRGlyZWN0aW9uIHx8IG51bGwsIHBpbmNoRGlzdGFuY2UgfHwgMCwgZHVyYXRpb24gfHwgMCwgZmluZ2VyQ291bnQsIHBpbmNoWm9vbSwgZmluZ2VyRGF0YSk7CgkJCQkJLy9JZiB0aGUgc3RhdHVzIGNhbmNlbHMsIHRoZW4gZG9udCBydW4gdGhlIHN1YnNlcXVlbnQgZXZlbnQgaGFuZGxlcnMuLgoJCQkJCWlmKHJldD09PWZhbHNlKSByZXR1cm4gZmFsc2U7CgkJCQl9CgkJCQkKCQkJCWlmKHBoYXNlPT1QSEFTRV9FTkQgJiYgdmFsaWRhdGVQaW5jaCgpKSB7CgkJCQkJCgkJCQkJc3dpdGNoIChwaW5jaERpcmVjdGlvbikgewoJCQkJCQljYXNlIElOOgoJCQkJCQkJLy9UcmlnZ2VyIHRoZSBldmVudAogICAgICAgICAgICAgICAgICAgICAgICAgICAgJGVsZW1lbnQudHJpZ2dlcigncGluY2hJbicsIFtwaW5jaERpcmVjdGlvbiB8fCBudWxsLCBwaW5jaERpc3RhbmNlIHx8IDAsIGR1cmF0aW9uIHx8IDAsIGZpbmdlckNvdW50LCBwaW5jaFpvb20sIGZpbmdlckRhdGFdKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vRmlyZSB0aGUgY2FsbGJhY2sKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvcHRpb25zLnBpbmNoSW4pIHsKCQkJCQkJCQlyZXQgPSBvcHRpb25zLnBpbmNoSW4uY2FsbCgkZWxlbWVudCwgZXZlbnQsIHBpbmNoRGlyZWN0aW9uIHx8IG51bGwsIHBpbmNoRGlzdGFuY2UgfHwgMCwgZHVyYXRpb24gfHwgMCwgZmluZ2VyQ291bnQsIHBpbmNoWm9vbSwgZmluZ2VyRGF0YSk7CgkJCQkJCQl9CgkJCQkJCQlicmVhazsKCQkJCQkJCgkJCQkJCWNhc2UgT1VUOgoJCQkJCQkJLy9UcmlnZ2VyIHRoZSBldmVudAogICAgICAgICAgICAgICAgICAgICAgICAgICAgJGVsZW1lbnQudHJpZ2dlcigncGluY2hPdXQnLCBbcGluY2hEaXJlY3Rpb24gfHwgbnVsbCwgcGluY2hEaXN0YW5jZSB8fCAwLCBkdXJhdGlvbiB8fCAwLCBmaW5nZXJDb3VudCwgcGluY2hab29tLCBmaW5nZXJEYXRhXSk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvL0ZpcmUgdGhlIGNhbGxiYWNrCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAob3B0aW9ucy5waW5jaE91dCkgewoJCQkJCQkJCXJldCA9IG9wdGlvbnMucGluY2hPdXQuY2FsbCgkZWxlbWVudCwgZXZlbnQsIHBpbmNoRGlyZWN0aW9uIHx8IG51bGwsIHBpbmNoRGlzdGFuY2UgfHwgMCwgZHVyYXRpb24gfHwgMCwgZmluZ2VyQ291bnQsIHBpbmNoWm9vbSwgZmluZ2VyRGF0YSk7CgkJCQkJCQl9CgkJCQkJCQlicmVhazsJCgkJCQkJfQoJCQkJfQoJCQl9CgkJCQoKCiAgICAgICAgICAgICAgICAKCSAgICAJCQoJCQlpZihnZXN0dXJlPT1UQVApIHsKCQkJCWlmKHBoYXNlID09PSBQSEFTRV9DQU5DRUwgfHwgcGhhc2UgPT09IFBIQVNFX0VORCkgewoJCQkJCQogICAgCQkJICAgIAogICAgCQkJICAgIC8vQ2FuY2VsIGFueSBleGlzdGluZyBkb3VibGUgdGFwCgkJCQkgICAgY2xlYXJUaW1lb3V0KHNpbmdsZVRhcFRpbWVvdXQpOwogICAgCQkJICAgIC8vQ2FuY2VsIGhvbGQgdGltZW91dAoJCQkJICAgIGNsZWFyVGltZW91dChob2xkVGltZW91dCk7CgkJCQkgICAgICAgICAgIAoJCQkJCS8vSWYgd2UgYXJlIGFsc28gbG9va2luZyBmb3IgZG91YmVsVGFwcywgd2FpdCBpbmNhc2UgdGhpcyBpcyBvbmUuLi4KCQkJCSAgICBpZihoYXNEb3VibGVUYXAoKSAmJiAhaW5Eb3VibGVUYXAoKSkgewoJCQkJICAgICAgICAvL0NhY2hlIHRoZSB0aW1lIG9mIHRoaXMgdGFwCiAgICAgICAgICAgICAgICAgICAgICAgIGRvdWJsZVRhcFN0YXJ0VGltZSA9IGdldFRpbWVTdGFtcCgpOwogICAgICAgICAgICAgICAgICAgICAgIAoJCQkJICAgICAgICAvL05vdyB3YWl0IGZvciB0aGUgZG91YmxlIHRhcCB0aW1lb3V0LCBhbmQgdHJpZ2dlciB0aGlzIHNpbmdsZSB0YXAKCQkJCSAgICAgICAgLy9pZiBpdHMgbm90IGNhbmNlbGxlZCBieSBhIGRvdWJsZSB0YXAKCQkJCSAgICAgICAgc2luZ2xlVGFwVGltZW91dCA9IHNldFRpbWVvdXQoJC5wcm94eShmdW5jdGlvbigpIHsKICAgICAgICAJCQkgICAgICAgIGRvdWJsZVRhcFN0YXJ0VGltZT1udWxsOwogICAgICAgIAkJCSAgICAgICAgLy9UcmlnZ2VyIHRoZSBldmVudAogICAgICAgICAgICAgICAgCQkJJGVsZW1lbnQudHJpZ2dlcigndGFwJywgW2V2ZW50LnRhcmdldF0pOwoKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvL0ZpcmUgdGhlIGNhbGxiYWNrCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihvcHRpb25zLnRhcCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldCA9IG9wdGlvbnMudGFwLmNhbGwoJGVsZW1lbnQsIGV2ZW50LCBldmVudC50YXJnZXQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgCQkJICAgICAgICB9LCB0aGlzKSwgb3B0aW9ucy5kb3VibGVUYXBUaHJlc2hvbGQgKTsKICAgIAkJCSAgICAJCiAgICAJCQkgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgZG91YmxlVGFwU3RhcnRUaW1lPW51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAvL1RyaWdnZXIgdGhlIGV2ZW50CiAgICAgICAgICAgICAgICAgICAgICAgICRlbGVtZW50LnRyaWdnZXIoJ3RhcCcsIFtldmVudC50YXJnZXRdKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAvL0ZpcmUgdGhlIGNhbGxiYWNrCiAgICAgICAgICAgICAgICAgICAgICAgIGlmKG9wdGlvbnMudGFwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXQgPSBvcHRpb25zLnRhcC5jYWxsKCRlbGVtZW50LCBldmVudCwgZXZlbnQudGFyZ2V0KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQoJICAgIAkJICAgIH0KCSAgICAJCX0KCQkJfQoJCQkKCQkJZWxzZSBpZiAoZ2VzdHVyZT09RE9VQkxFX1RBUCkgewoJCQkJaWYocGhhc2UgPT09IFBIQVNFX0NBTkNFTCB8fCBwaGFzZSA9PT0gUEhBU0VfRU5EKSB7CgkJCQkJLy9DYW5jZWwgYW55IHBlbmRpbmcgc2luZ2xldGFwIAoJCQkJICAgIGNsZWFyVGltZW91dChzaW5nbGVUYXBUaW1lb3V0KTsKCQkJCSAgICBkb3VibGVUYXBTdGFydFRpbWU9bnVsbDsKCQkJCSAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy9UcmlnZ2VyIHRoZSBldmVudAogICAgICAgICAgICAgICAgICAgICRlbGVtZW50LnRyaWdnZXIoJ2RvdWJsZXRhcCcsIFtldmVudC50YXJnZXRdKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vRmlyZSB0aGUgY2FsbGJhY2sKICAgICAgICAgICAgICAgICAgICBpZihvcHRpb25zLmRvdWJsZVRhcCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXQgPSBvcHRpb25zLmRvdWJsZVRhcC5jYWxsKCRlbGVtZW50LCBldmVudCwgZXZlbnQudGFyZ2V0KTsKICAgICAgICAgICAgICAgICAgICB9CgkgICAgCQl9CgkJCX0KCQkJCgkJCWVsc2UgaWYgKGdlc3R1cmU9PUxPTkdfVEFQKSB7CgkJCQlpZihwaGFzZSA9PT0gUEhBU0VfQ0FOQ0VMIHx8IHBoYXNlID09PSBQSEFTRV9FTkQpIHsKCQkJCQkvL0NhbmNlbCBhbnkgcGVuZGluZyBzaW5nbGV0YXAgKHNob3VsZG50IGJlIG9uZSkKCQkJCSAgICBjbGVhclRpbWVvdXQoc2luZ2xlVGFwVGltZW91dCk7CgkJCQkgICAgZG91YmxlVGFwU3RhcnRUaW1lPW51bGw7CgkJCQkgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vVHJpZ2dlciB0aGUgZXZlbnQKICAgICAgICAgICAgICAgICAgICAkZWxlbWVudC50cmlnZ2VyKCdsb25ndGFwJywgW2V2ZW50LnRhcmdldF0pOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy9GaXJlIHRoZSBjYWxsYmFjawogICAgICAgICAgICAgICAgICAgIGlmKG9wdGlvbnMubG9uZ1RhcCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXQgPSBvcHRpb25zLmxvbmdUYXAuY2FsbCgkZWxlbWVudCwgZXZlbnQsIGV2ZW50LnRhcmdldCk7CiAgICAgICAgICAgICAgICAgICAgfQoJICAgIAkJfQoJCQl9CQkJCQoJCQkJCgkJCXJldHVybiByZXQ7CgkJfQoKCgoJCQoJCS8vCgkJLy8gR0VTVFVSRSBWQUxJREFUSU9OCgkJLy8KCQkKCQkvKioKCQkqIENoZWNrcyB0aGUgdXNlciBoYXMgc3dpcGUgZmFyIGVub3VnaAoJCSogQHJldHVybiBCb29sZWFuIGlmIDxjb2RlPnRocmVzaG9sZDwvY29kZT4gaGFzIGJlZW4gc2V0LCByZXR1cm4gdHJ1ZSBpZiB0aGUgdGhyZXNob2xkIHdhcyBtZXQsIGVsc2UgZmFsc2UuCgkJKiBJZiBubyB0aHJlc2hvbGQgd2FzIHNldCwgdGhlbiB3ZSByZXR1cm4gdHJ1ZS4KCQkqIEBpbm5lcgoJCSovCgkJZnVuY3Rpb24gdmFsaWRhdGVTd2lwZURpc3RhbmNlKCkgewoJCQl2YXIgdmFsaWQgPSB0cnVlOwoJCQkvL0lmIHdlIG1hZGUgaXQgcGFzdCB0aGUgbWluIHN3aXBlIGRpc3RhbmNlLi4KCQkJaWYgKG9wdGlvbnMudGhyZXNob2xkICE9PSBudWxsKSB7CgkJCQl2YWxpZCA9IGRpc3RhbmNlID49IG9wdGlvbnMudGhyZXNob2xkOwoJCQl9CgkJCQogICAgICAgICAgICByZXR1cm4gdmFsaWQ7CgkJfQoJCQoJCS8qKgoJCSogQ2hlY2tzIHRoZSB1c2VyIGhhcyBzd2lwZWQgYmFjayB0byBjYW5jZWwuCgkJKiBAcmV0dXJuIEJvb2xlYW4gaWYgPGNvZGU+Y2FuY2VsVGhyZXNob2xkPC9jb2RlPiBoYXMgYmVlbiBzZXQsIHJldHVybiB0cnVlIGlmIHRoZSBjYW5jZWxUaHJlc2hvbGQgd2FzIG1ldCwgZWxzZSBmYWxzZS4KCQkqIElmIG5vIGNhbmNlbFRocmVzaG9sZCB3YXMgc2V0LCB0aGVuIHdlIHJldHVybiB0cnVlLgoJCSogQGlubmVyCgkJKi8KCQlmdW5jdGlvbiBkaWRTd2lwZUJhY2tUb0NhbmNlbCgpIHsKICAgICAgICAgICAgdmFyIGNhbmNlbGxlZCA9IGZhbHNlOwogICAgCQlpZihvcHRpb25zLmNhbmNlbFRocmVzaG9sZCAhPT0gbnVsbCAmJiBkaXJlY3Rpb24gIT09bnVsbCkgIHsKICAgIAkJICAgIGNhbmNlbGxlZCA9ICAoZ2V0TWF4RGlzdGFuY2UoIGRpcmVjdGlvbiApIC0gZGlzdGFuY2UpID49IG9wdGlvbnMuY2FuY2VsVGhyZXNob2xkOwoJCQl9CgkJCQoJCQlyZXR1cm4gY2FuY2VsbGVkOwoJCX0KCgkJLyoqCgkJKiBDaGVja3MgdGhlIHVzZXIgaGFzIHBpbmNoZWQgZmFyIGVub3VnaAoJCSogQHJldHVybiBCb29sZWFuIGlmIDxjb2RlPnBpbmNoVGhyZXNob2xkPC9jb2RlPiBoYXMgYmVlbiBzZXQsIHJldHVybiB0cnVlIGlmIHRoZSB0aHJlc2hvbGQgd2FzIG1ldCwgZWxzZSBmYWxzZS4KCQkqIElmIG5vIHRocmVzaG9sZCB3YXMgc2V0LCB0aGVuIHdlIHJldHVybiB0cnVlLgoJCSogQGlubmVyCgkJKi8KCQlmdW5jdGlvbiB2YWxpZGF0ZVBpbmNoRGlzdGFuY2UoKSB7CgkJCWlmIChvcHRpb25zLnBpbmNoVGhyZXNob2xkICE9PSBudWxsKSB7CgkJCQlyZXR1cm4gcGluY2hEaXN0YW5jZSA+PSBvcHRpb25zLnBpbmNoVGhyZXNob2xkOwoJCQl9CgkJCXJldHVybiB0cnVlOwoJCX0KCgkJLyoqCgkJKiBDaGVja3MgdGhhdCB0aGUgdGltZSB0YWtlbiB0byBzd2lwZSBtZWV0cyB0aGUgbWluaW11bSAvIG1heGltdW0gcmVxdWlyZW1lbnRzCgkJKiBAcmV0dXJuIEJvb2xlYW4KCQkqIEBpbm5lcgoJCSovCgkJZnVuY3Rpb24gdmFsaWRhdGVTd2lwZVRpbWUoKSB7CgkJCXZhciByZXN1bHQ7CgkJCS8vSWYgbm8gdGltZSBzZXQsIHRoZW4gcmV0dXJuIHRydWUKCgkJCWlmIChvcHRpb25zLm1heFRpbWVUaHJlc2hvbGQpIHsKCQkJCWlmIChkdXJhdGlvbiA+PSBvcHRpb25zLm1heFRpbWVUaHJlc2hvbGQpIHsKCQkJCQlyZXN1bHQgPSBmYWxzZTsKCQkJCX0gZWxzZSB7CgkJCQkJcmVzdWx0ID0gdHJ1ZTsKCQkJCX0KCQkJfQoJCQllbHNlIHsKCQkJCXJlc3VsdCA9IHRydWU7CgkJCX0KCgkJCXJldHVybiByZXN1bHQ7CgkJfQoKCgkJLyoqCgkJKiBDaGVja3MgZGlyZWN0aW9uIG9mIHRoZSBzd2lwZSBhbmQgdGhlIHZhbHVlIGFsbG93UGFnZVNjcm9sbCB0byBzZWUgaWYgd2Ugc2hvdWxkIGFsbG93IG9yIHByZXZlbnQgdGhlIGRlZmF1bHQgYmVoYXZpb3VyIGZyb20gb2NjdXJyaW5nLgoJCSogVGhpcyB3aWxsIGVzc2VudGlhbGx5IGFsbG93IHBhZ2Ugc2Nyb2xsaW5nIG9yIG5vdCB3aGVuIHRoZSB1c2VyIGlzIHN3aXBpbmcgb24gYSB0b3VjaFN3aXBlIG9iamVjdC4KCQkqIEBwYXJhbSB7b2JqZWN0fSBqcUV2ZW50IFRoZSBub3JtYWxpc2VkIGpRdWVyeSByZXByZXNlbnRhdGlvbiBvZiB0aGUgZXZlbnQgb2JqZWN0LgoJCSogQHBhcmFtIHtzdHJpbmd9IGRpcmVjdGlvbiBUaGUgZGlyZWN0aW9uIG9mIHRoZSBldmVudC4gU2VlIHtAbGluayAkLmZuLnN3aXBlLmRpcmVjdGlvbnN9CgkJKiBAc2VlICQuZm4uc3dpcGUuZGlyZWN0aW9ucwoJCSogQGlubmVyCgkJKi8KCQlmdW5jdGlvbiB2YWxpZGF0ZURlZmF1bHRFdmVudChqcUV2ZW50LCBkaXJlY3Rpb24pIHsKCQkJaWYgKG9wdGlvbnMuYWxsb3dQYWdlU2Nyb2xsID09PSBOT05FIHx8IGhhc1BpbmNoZXMoKSkgewoJCQkJanFFdmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQl9IGVsc2UgewoJCQkJdmFyIGF1dG8gPSBvcHRpb25zLmFsbG93UGFnZVNjcm9sbCA9PT0gQVVUTzsKCgkJCQlzd2l0Y2ggKGRpcmVjdGlvbikgewoJCQkJCWNhc2UgTEVGVDoKCQkJCQkJaWYgKChvcHRpb25zLnN3aXBlTGVmdCAmJiBhdXRvKSB8fCAoIWF1dG8gJiYgb3B0aW9ucy5hbGxvd1BhZ2VTY3JvbGwgIT0gSE9SSVpPTlRBTCkpIHsKCQkJCQkJCWpxRXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCQkJfQoJCQkJCQlicmVhazsKCgkJCQkJY2FzZSBSSUdIVDoKCQkJCQkJaWYgKChvcHRpb25zLnN3aXBlUmlnaHQgJiYgYXV0bykgfHwgKCFhdXRvICYmIG9wdGlvbnMuYWxsb3dQYWdlU2Nyb2xsICE9IEhPUklaT05UQUwpKSB7CgkJCQkJCQlqcUV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQkJCX0KCQkJCQkJYnJlYWs7CgoJCQkJCWNhc2UgVVA6CgkJCQkJCWlmICgob3B0aW9ucy5zd2lwZVVwICYmIGF1dG8pIHx8ICghYXV0byAmJiBvcHRpb25zLmFsbG93UGFnZVNjcm9sbCAhPSBWRVJUSUNBTCkpIHsKCQkJCQkJCWpxRXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCQkJfQoJCQkJCQlicmVhazsKCgkJCQkJY2FzZSBET1dOOgoJCQkJCQlpZiAoKG9wdGlvbnMuc3dpcGVEb3duICYmIGF1dG8pIHx8ICghYXV0byAmJiBvcHRpb25zLmFsbG93UGFnZVNjcm9sbCAhPSBWRVJUSUNBTCkpIHsKCQkJCQkJCWpxRXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCQkJfQoJCQkJCQlicmVhazsKCQkJCX0KCQkJfQoKCQl9CgoKCQkvLyBQSU5DSEVTCgkJLyoqCgkJICogUmV0dXJucyB0cnVlIG9mIHRoZSBjdXJyZW50IHBpbmNoIG1lZXRzIHRoZSB0aHJlc2hvbGRzCgkJICogQHJldHVybiBCb29sZWFuCgkJICogQGlubmVyCgkJKi8KCQlmdW5jdGlvbiB2YWxpZGF0ZVBpbmNoKCkgewoJCSAgICB2YXIgaGFzQ29ycmVjdEZpbmdlckNvdW50ID0gdmFsaWRhdGVGaW5nZXJzKCk7CgkJICAgIHZhciBoYXNFbmRQb2ludCA9IHZhbGlkYXRlRW5kUG9pbnQoKTsKCQkJdmFyIGhhc0NvcnJlY3REaXN0YW5jZSA9IHZhbGlkYXRlUGluY2hEaXN0YW5jZSgpOwoJCQlyZXR1cm4gaGFzQ29ycmVjdEZpbmdlckNvdW50ICYmIGhhc0VuZFBvaW50ICYmIGhhc0NvcnJlY3REaXN0YW5jZTsKCQkJCgkJfQoJCQoJCS8qKgoJCSAqIFJldHVybnMgdHJ1ZSBpZiBhbnkgUGluY2ggZXZlbnRzIGhhdmUgYmVlbiByZWdpc3RlcmVkCgkJICogQHJldHVybiBCb29sZWFuCgkJICogQGlubmVyCgkJKi8KCQlmdW5jdGlvbiBoYXNQaW5jaGVzKCkgewoJCQkvL0VudXJlIHdlIGRvbnQgcmV0dXJuIDAgb3IgbnVsbCBmb3IgZmFsc2UgdmFsdWVzCgkJCXJldHVybiAhIShvcHRpb25zLnBpbmNoU3RhdHVzIHx8IG9wdGlvbnMucGluY2hJbiB8fCBvcHRpb25zLnBpbmNoT3V0KTsKCQl9CgkJCgkJLyoqCgkJICogUmV0dXJucyB0cnVlIGlmIHdlIGFyZSBkZXRlY3RpbmcgcGluY2hlcywgYW5kIGhhdmUgb25lCgkJICogQHJldHVybiBCb29sZWFuCgkJICogQGlubmVyCgkJICovCgkJZnVuY3Rpb24gZGlkUGluY2goKSB7CgkJCS8vRW51cmUgd2UgZG9udCByZXR1cm4gMCBvciBudWxsIGZvciBmYWxzZSB2YWx1ZXMKCQkJcmV0dXJuICEhKHZhbGlkYXRlUGluY2goKSAmJiBoYXNQaW5jaGVzKCkpOwoJCX0KCgoKCgkJLy8gU1dJUEVTCgkJLyoqCgkJICogUmV0dXJucyB0cnVlIGlmIHRoZSBjdXJyZW50IHN3aXBlIG1lZXRzIHRoZSB0aHJlc2hvbGRzCgkJICogQHJldHVybiBCb29sZWFuCgkJICogQGlubmVyCgkJKi8KCQlmdW5jdGlvbiB2YWxpZGF0ZVN3aXBlKCkgewoJCQkvL0NoZWNrIHZhbGlkaXR5IG9mIHN3aXBlCgkJCXZhciBoYXNWYWxpZFRpbWUgPSB2YWxpZGF0ZVN3aXBlVGltZSgpOwoJCQl2YXIgaGFzVmFsaWREaXN0YW5jZSA9IHZhbGlkYXRlU3dpcGVEaXN0YW5jZSgpOwkKCQkJdmFyIGhhc0NvcnJlY3RGaW5nZXJDb3VudCA9IHZhbGlkYXRlRmluZ2VycygpOwoJCSAgICB2YXIgaGFzRW5kUG9pbnQgPSB2YWxpZGF0ZUVuZFBvaW50KCk7CgkJICAgIHZhciBkaWRDYW5jZWwgPSBkaWRTd2lwZUJhY2tUb0NhbmNlbCgpOwkKCQkgICAgCgkJCS8vIGlmIHRoZSB1c2VyIHN3aXBlZCBtb3JlIHRoYW4gdGhlIG1pbmltdW0gbGVuZ3RoLCBwZXJmb3JtIHRoZSBhcHByb3ByaWF0ZSBhY3Rpb24KCQkJLy8gaGFzVmFsaWREaXN0YW5jZSBpcyBudWxsIHdoZW4gbm8gZGlzdGFuY2UgaXMgc2V0IAoJCQl2YXIgdmFsaWQgPSAgIWRpZENhbmNlbCAmJiBoYXNFbmRQb2ludCAmJiBoYXNDb3JyZWN0RmluZ2VyQ291bnQgJiYgaGFzVmFsaWREaXN0YW5jZSAmJiBoYXNWYWxpZFRpbWU7CgkJCQoJCQlyZXR1cm4gdmFsaWQ7CgkJfQoJCQoJCS8qKgoJCSAqIFJldHVybnMgdHJ1ZSBpZiBhbnkgU3dpcGUgZXZlbnRzIGhhdmUgYmVlbiByZWdpc3RlcmVkCgkJICogQHJldHVybiBCb29sZWFuCgkJICogQGlubmVyCgkJKi8KCQlmdW5jdGlvbiBoYXNTd2lwZXMoKSB7CgkJCS8vRW51cmUgd2UgZG9udCByZXR1cm4gMCBvciBudWxsIGZvciBmYWxzZSB2YWx1ZXMKCQkJcmV0dXJuICEhKG9wdGlvbnMuc3dpcGUgfHwgb3B0aW9ucy5zd2lwZVN0YXR1cyB8fCBvcHRpb25zLnN3aXBlTGVmdCB8fCBvcHRpb25zLnN3aXBlUmlnaHQgfHwgb3B0aW9ucy5zd2lwZVVwIHx8IG9wdGlvbnMuc3dpcGVEb3duKTsKCQl9CgkJCgkJCgkJLyoqCgkJICogUmV0dXJucyB0cnVlIGlmIHdlIGFyZSBkZXRlY3Rpbmcgc3dpcGVzIGFuZCBoYXZlIG9uZQoJCSAqIEByZXR1cm4gQm9vbGVhbgoJCSAqIEBpbm5lcgoJCSovCgkJZnVuY3Rpb24gZGlkU3dpcGUoKSB7CgkJCS8vRW51cmUgd2UgZG9udCByZXR1cm4gMCBvciBudWxsIGZvciBmYWxzZSB2YWx1ZXMKCQkJcmV0dXJuICEhKHZhbGlkYXRlU3dpcGUoKSAmJiBoYXNTd2lwZXMoKSk7CgkJfQoKICAgICAgICAvKioKCQkgKiBSZXR1cm5zIHRydWUgaWYgd2UgaGF2ZSBtYXRjaGVkIHRoZSBudW1iZXIgb2YgZmluZ2VycyB3ZSBhcmUgbG9va2luZyBmb3IKCQkgKiBAcmV0dXJuIEJvb2xlYW4KCQkgKiBAaW5uZXIKCQkqLwogICAgICAgIGZ1bmN0aW9uIHZhbGlkYXRlRmluZ2VycygpIHsKICAgICAgICAgICAgLy9UaGUgbnVtYmVyIG9mIGZpbmdlcnMgd2Ugd2FudCB3ZXJlIG1hdGNoZWQsIG9yIG9uIGRlc2t0b3Agd2UgaWdub3JlCiAgICAJCXJldHVybiAoKGZpbmdlckNvdW50ID09PSBvcHRpb25zLmZpbmdlcnMgfHwgb3B0aW9ucy5maW5nZXJzID09PSBBTExfRklOR0VSUykgfHwgIVNVUFBPUlRTX1RPVUNIKTsKICAgIAl9CiAgICAgICAgCiAgICAgICAgLyoqCgkJICogUmV0dXJucyB0cnVlIGlmIHdlIGhhdmUgYW4gZW5kIHBvaW50IGZvciB0aGUgc3dpcGUKCQkgKiBAcmV0dXJuIEJvb2xlYW4KCQkgKiBAaW5uZXIKCQkqLwogICAgICAgIGZ1bmN0aW9uIHZhbGlkYXRlRW5kUG9pbnQoKSB7CiAgICAgICAgICAgIC8vV2UgaGF2ZSBhbiBlbmQgdmFsdWUgZm9yIHRoZSBmaW5nZXIKCQkgICAgcmV0dXJuIGZpbmdlckRhdGFbMF0uZW5kLnggIT09IDA7CiAgICAgICAgfQoKCQkvLyBUQVAgLyBDTElDSwoJCS8qKgoJCSAqIFJldHVybnMgdHJ1ZSBpZiBhIGNsaWNrIC8gdGFwIGV2ZW50cyBoYXZlIGJlZW4gcmVnaXN0ZXJlZAoJCSAqIEByZXR1cm4gQm9vbGVhbgoJCSAqIEBpbm5lcgoJCSovCgkJZnVuY3Rpb24gaGFzVGFwKCkgewoJCQkvL0VudXJlIHdlIGRvbnQgcmV0dXJuIDAgb3IgbnVsbCBmb3IgZmFsc2UgdmFsdWVzCgkJCXJldHVybiAhIShvcHRpb25zLnRhcCkgOwoJCX0KCQkKCQkvKioKCQkgKiBSZXR1cm5zIHRydWUgaWYgYSBkb3VibGUgdGFwIGV2ZW50cyBoYXZlIGJlZW4gcmVnaXN0ZXJlZAoJCSAqIEByZXR1cm4gQm9vbGVhbgoJCSAqIEBpbm5lcgoJCSovCgkJZnVuY3Rpb24gaGFzRG91YmxlVGFwKCkgewoJCQkvL0VudXJlIHdlIGRvbnQgcmV0dXJuIDAgb3IgbnVsbCBmb3IgZmFsc2UgdmFsdWVzCgkJCXJldHVybiAhIShvcHRpb25zLmRvdWJsZVRhcCkgOwoJCX0KCQkKCQkvKioKCQkgKiBSZXR1cm5zIHRydWUgaWYgYW55IGxvbmcgdGFwIGV2ZW50cyBoYXZlIGJlZW4gcmVnaXN0ZXJlZAoJCSAqIEByZXR1cm4gQm9vbGVhbgoJCSAqIEBpbm5lcgoJCSovCgkJZnVuY3Rpb24gaGFzTG9uZ1RhcCgpIHsKCQkJLy9FbnVyZSB3ZSBkb250IHJldHVybiAwIG9yIG51bGwgZm9yIGZhbHNlIHZhbHVlcwoJCQlyZXR1cm4gISEob3B0aW9ucy5sb25nVGFwKSA7CgkJfQoJCQoJCS8qKgoJCSAqIFJldHVybnMgdHJ1ZSBpZiB3ZSBjb3VsZCBiZSBpbiB0aGUgcHJvY2VzcyBvZiBhIGRvdWJsZSB0YXAgKG9uZSB0YXAgaGFzIG9jY3VycmVkLCB3ZSBhcmUgbGlzdGVuaW5nIGZvciBkb3VibGUgdGFwcywgYW5kIHRoZSB0aHJlc2hvbGQgaGFzbid0IHBhc3QuCgkJICogQHJldHVybiBCb29sZWFuCgkJICogQGlubmVyCgkJKi8KCQlmdW5jdGlvbiB2YWxpZGF0ZURvdWJsZVRhcCgpIHsKCQkgICAgaWYoZG91YmxlVGFwU3RhcnRUaW1lPT1udWxsKXsKCQkgICAgICAgIHJldHVybiBmYWxzZTsKCQkgICAgfQoJCSAgICB2YXIgbm93ID0gZ2V0VGltZVN0YW1wKCk7CgkJICAgIHJldHVybiAoaGFzRG91YmxlVGFwKCkgJiYgKChub3ctZG91YmxlVGFwU3RhcnRUaW1lKSA8PSBvcHRpb25zLmRvdWJsZVRhcFRocmVzaG9sZCkpOwoJCX0KCQkKCQkvKioKCQkgKiBSZXR1cm5zIHRydWUgaWYgd2UgY291bGQgYmUgaW4gdGhlIHByb2Nlc3Mgb2YgYSBkb3VibGUgdGFwIChvbmUgdGFwIGhhcyBvY2N1cnJlZCwgd2UgYXJlIGxpc3RlbmluZyBmb3IgZG91YmxlIHRhcHMsIGFuZCB0aGUgdGhyZXNob2xkIGhhc24ndCBwYXN0LgoJCSAqIEByZXR1cm4gQm9vbGVhbgoJCSAqIEBpbm5lcgoJCSovCgkJZnVuY3Rpb24gaW5Eb3VibGVUYXAoKSB7CgkJICAgIHJldHVybiB2YWxpZGF0ZURvdWJsZVRhcCgpOwoJCX0KCQkKCQkKCQkvKioKCQkgKiBSZXR1cm5zIHRydWUgaWYgd2UgaGF2ZSBhIHZhbGlkIHRhcAoJCSAqIEByZXR1cm4gQm9vbGVhbgoJCSAqIEBpbm5lcgoJCSovCgkJZnVuY3Rpb24gdmFsaWRhdGVUYXAoKSB7CgkJICAgIHJldHVybiAoKGZpbmdlckNvdW50ID09PSAxIHx8ICFTVVBQT1JUU19UT1VDSCkgJiYgKGlzTmFOKGRpc3RhbmNlKSB8fCBkaXN0YW5jZSA8IG9wdGlvbnMudGhyZXNob2xkKSk7CgkJfQoJCQoJCS8qKgoJCSAqIFJldHVybnMgdHJ1ZSBpZiB3ZSBoYXZlIGEgdmFsaWQgbG9uZyB0YXAKCQkgKiBAcmV0dXJuIEJvb2xlYW4KCQkgKiBAaW5uZXIKCQkqLwoJCWZ1bmN0aW9uIHZhbGlkYXRlTG9uZ1RhcCgpIHsKCQkgICAgLy9zbGlnaHQgdGhyZXNob2xkIG9uIG1vdmluZyBmaW5nZXIKICAgICAgICAgICAgcmV0dXJuICgoZHVyYXRpb24gPiBvcHRpb25zLmxvbmdUYXBUaHJlc2hvbGQpICYmIChkaXN0YW5jZSA8IERPVUJMRV9UQVBfVEhSRVNIT0xEKSk7IAoJCX0KCQkKCQkvKioKCQkgKiBSZXR1cm5zIHRydWUgaWYgd2UgYXJlIGRldGVjdGluZyB0YXBzIGFuZCBoYXZlIG9uZQoJCSAqIEByZXR1cm4gQm9vbGVhbgoJCSAqIEBpbm5lcgoJCSovCgkJZnVuY3Rpb24gZGlkVGFwKCkgewoJCSAgICAvL0VudXJlIHdlIGRvbnQgcmV0dXJuIDAgb3IgbnVsbCBmb3IgZmFsc2UgdmFsdWVzCgkJCXJldHVybiAhISh2YWxpZGF0ZVRhcCgpICYmIGhhc1RhcCgpKTsKCQl9CgkJCgkJCgkJLyoqCgkJICogUmV0dXJucyB0cnVlIGlmIHdlIGFyZSBkZXRlY3RpbmcgZG91YmxlIHRhcHMgYW5kIGhhdmUgb25lCgkJICogQHJldHVybiBCb29sZWFuCgkJICogQGlubmVyCgkJKi8KCQlmdW5jdGlvbiBkaWREb3VibGVUYXAoKSB7CgkJICAgIC8vRW51cmUgd2UgZG9udCByZXR1cm4gMCBvciBudWxsIGZvciBmYWxzZSB2YWx1ZXMKCQkJcmV0dXJuICEhKHZhbGlkYXRlRG91YmxlVGFwKCkgJiYgaGFzRG91YmxlVGFwKCkpOwoJCX0KCQkKCQkvKioKCQkgKiBSZXR1cm5zIHRydWUgaWYgd2UgYXJlIGRldGVjdGluZyBsb25nIHRhcHMgYW5kIGhhdmUgb25lCgkJICogQHJldHVybiBCb29sZWFuCgkJICogQGlubmVyCgkJKi8KCQlmdW5jdGlvbiBkaWRMb25nVGFwKCkgewoJCSAgICAvL0VudXJlIHdlIGRvbnQgcmV0dXJuIDAgb3IgbnVsbCBmb3IgZmFsc2UgdmFsdWVzCgkJCXJldHVybiAhISh2YWxpZGF0ZUxvbmdUYXAoKSAmJiBoYXNMb25nVGFwKCkpOwoJCX0KCQkKCQkKCQkKCQkKCQkvLyBNVUxUSSBGSU5HRVIgVE9VQ0gKCQkvKioKCQkgKiBTdGFydHMgdHJhY2tpbmcgdGhlIHRpbWUgYmV0d2VlbiAyIGZpbmdlciByZWxlYXNlcywgYW5kIGtlZXBzIHRyYWNrIG9mIGhvdyBtYW55IGZpbmdlcnMgd2UgaW5pdGlhbGx5IGhhZCB1cAoJCSAqIEBpbm5lcgoJCSovCgkJZnVuY3Rpb24gc3RhcnRNdWx0aUZpbmdlclJlbGVhc2UoKSB7CgkJCXByZXZpb3VzVG91Y2hFbmRUaW1lID0gZ2V0VGltZVN0YW1wKCk7CgkJCXByZXZpb3VzVG91Y2hGaW5nZXJDb3VudCA9IGV2ZW50LnRvdWNoZXMubGVuZ3RoKzE7CgkJfQoJCQoJCS8qKgoJCSAqIENhbmNlbHMgdGhlIHRyYWNraW5nIG9mIHRpbWUgYmV0d2VlbiAyIGZpbmdlciByZWxlYXNlcywgYW5kIHJlc2V0cyBjb3VudGVycwoJCSAqIEBpbm5lcgoJCSovCgkJZnVuY3Rpb24gY2FuY2VsTXVsdGlGaW5nZXJSZWxlYXNlKCkgewoJCQlwcmV2aW91c1RvdWNoRW5kVGltZSA9IDA7CgkJCXByZXZpb3VzVG91Y2hGaW5nZXJDb3VudCA9IDA7CgkJfQoJCQoJCS8qKgoJCSAqIENoZWNrcyBpZiB3ZSBhcmUgaW4gdGhlIHRocmVzaG9sZCBiZXR3ZWVuIDIgZmluZ2VycyBiZWluZyByZWxlYXNlZCAKCQkgKiBAcmV0dXJuIEJvb2xlYW4KCQkgKiBAaW5uZXIKCQkqLwoJCWZ1bmN0aW9uIGluTXVsdGlGaW5nZXJSZWxlYXNlKCkgewoJCQkKCQkJdmFyIHdpdGhpblRocmVzaG9sZCA9IGZhbHNlOwoJCQkKCQkJaWYocHJldmlvdXNUb3VjaEVuZFRpbWUpIHsJCgkJCQl2YXIgZGlmZiA9IGdldFRpbWVTdGFtcCgpIC0gcHJldmlvdXNUb3VjaEVuZFRpbWUJCgkJCQlpZiggZGlmZjw9b3B0aW9ucy5maW5nZXJSZWxlYXNlVGhyZXNob2xkICkgewoJCQkJCXdpdGhpblRocmVzaG9sZCA9IHRydWU7CgkJCQl9CgkJCX0KCQkJCgkJCXJldHVybiB3aXRoaW5UaHJlc2hvbGQ7CQoJCX0KCQkKCgkJLyoqCgkJKiBnZXRzIGEgZGF0YSBmbGFnIHRvIGluZGljYXRlIHRoYXQgYSB0b3VjaCBpcyBpbiBwcm9ncmVzcwoJCSogQHJldHVybiBCb29sZWFuCgkJKiBAaW5uZXIKCQkqLwoJCWZ1bmN0aW9uIGdldFRvdWNoSW5Qcm9ncmVzcygpIHsKCQkJLy9zdHJpY3QgZXF1YWxpdHkgdG8gZW5zdXJlIG9ubHkgdHJ1ZSBhbmQgZmFsc2UgYXJlIHJldHVybmVkCgkJCXJldHVybiAhISgkZWxlbWVudC5kYXRhKFBMVUdJTl9OUysnX2ludG91Y2gnKSA9PT0gdHJ1ZSk7CgkJfQoJCQoJCS8qKgoJCSogU2V0cyBhIGRhdGEgZmxhZyB0byBpbmRpY2F0ZSB0aGF0IGEgdG91Y2ggaXMgaW4gcHJvZ3Jlc3MKCQkqIEBwYXJhbSB7Ym9vbGVhbn0gdmFsIFRoZSB2YWx1ZSB0byBzZXQgdGhlIHByb3BlcnR5IHRvCgkJKiBAaW5uZXIKCQkqLwoJCWZ1bmN0aW9uIHNldFRvdWNoSW5Qcm9ncmVzcyh2YWwpIHsKCQkJCgkJCS8vQWRkIG9yIHJlbW92ZSBldmVudCBsaXN0ZW5lcnMgZGVwZW5kaW5nIG9uIHRvdWNoIHN0YXR1cwoJCQlpZih2YWw9PT10cnVlKSB7CgkJCQkkZWxlbWVudC5iaW5kKE1PVkVfRVYsIHRvdWNoTW92ZSk7CgkJCQkkZWxlbWVudC5iaW5kKEVORF9FViwgdG91Y2hFbmQpOwoJCQkJCgkJCQkvL3dlIG9ubHkgaGF2ZSBsZWF2ZSBldmVudHMgb24gZGVza3RvcCwgd2UgbWFudWFsbHkgY2FsY3VhdGUgbGVhdmUgb24gdG91Y2ggYXMgaXRzIG5vdCBzdXBwb3J0ZWQgaW4gd2Via2l0CgkJCQlpZihMRUFWRV9FVikgeyAKCQkJCQkkZWxlbWVudC5iaW5kKExFQVZFX0VWLCB0b3VjaExlYXZlKTsKCQkJCX0KCQkJfSBlbHNlIHsKCQkJCSRlbGVtZW50LnVuYmluZChNT1ZFX0VWLCB0b3VjaE1vdmUsIGZhbHNlKTsKCQkJCSRlbGVtZW50LnVuYmluZChFTkRfRVYsIHRvdWNoRW5kLCBmYWxzZSk7CgkJCQoJCQkJLy93ZSBvbmx5IGhhdmUgbGVhdmUgZXZlbnRzIG9uIGRlc2t0b3AsIHdlIG1hbnVhbGx5IGNhbGN1YXRlIGxlYXZlIG9uIHRvdWNoIGFzIGl0cyBub3Qgc3VwcG9ydGVkIGluIHdlYmtpdAoJCQkJaWYoTEVBVkVfRVYpIHsgCgkJCQkJJGVsZW1lbnQudW5iaW5kKExFQVZFX0VWLCB0b3VjaExlYXZlLCBmYWxzZSk7CgkJCQl9CgkJCX0KCQkJCgkJCgkJCS8vc3RyaWN0IGVxdWFsaXR5IHRvIGVuc3VyZSBvbmx5IHRydWUgYW5kIGZhbHNlIGNhbiB1cGRhdGUgdGhlIHZhbHVlCgkJCSRlbGVtZW50LmRhdGEoUExVR0lOX05TKydfaW50b3VjaCcsIHZhbCA9PT0gdHJ1ZSk7CgkJfQoJCQoJCQoJCS8qKgoJCSAqIENyZWF0ZXMgdGhlIGZpbmdlciBkYXRhIGZvciB0aGUgdG91Y2gvZmluZ2VyIGluIHRoZSBldmVudCBvYmplY3QuCgkJICogQHBhcmFtIHtpbnR9IGluZGV4IFRoZSBpbmRleCBpbiB0aGUgYXJyYXkgdG8gc3RvcmUgdGhlIGZpbmdlciBkYXRhICh1c3VhbGx5IHRoZSBvcmRlciB0aGUgZmluZ2VycyB3ZXJlIHByZXNzZWQpCgkJICogQHBhcmFtIHtvYmplY3R9IGV2dCBUaGUgZXZlbnQgb2JqZWN0IGNvbnRhaW5pbmcgZmluZ2VyIGRhdGEKCQkgKiBAcmV0dXJuIGZpbmdlciBkYXRhIG9iamVjdAoJCSAqIEBpbm5lcgoJCSovCgkJZnVuY3Rpb24gY3JlYXRlRmluZ2VyRGF0YSggaW5kZXgsIGV2dCApIHsKCQkJdmFyIGlkID0gZXZ0LmlkZW50aWZpZXIhPT11bmRlZmluZWQgPyBldnQuaWRlbnRpZmllciA6IDA7IAoJCQkKCQkJZmluZ2VyRGF0YVtpbmRleF0uaWRlbnRpZmllciA9IGlkOwoJCQlmaW5nZXJEYXRhW2luZGV4XS5zdGFydC54ID0gZmluZ2VyRGF0YVtpbmRleF0uZW5kLnggPSBldnQucGFnZVh8fGV2dC5jbGllbnRYOwoJCQlmaW5nZXJEYXRhW2luZGV4XS5zdGFydC55ID0gZmluZ2VyRGF0YVtpbmRleF0uZW5kLnkgPSBldnQucGFnZVl8fGV2dC5jbGllbnRZOwoJCQkKCQkJcmV0dXJuIGZpbmdlckRhdGFbaW5kZXhdOwoJCX0KCQkKCQkvKioKCQkgKiBVcGRhdGVzIHRoZSBmaW5nZXIgZGF0YSBmb3IgYSBwYXJ0aWN1bGFyIGV2ZW50IG9iamVjdAoJCSAqIEBwYXJhbSB7b2JqZWN0fSBldnQgVGhlIGV2ZW50IG9iamVjdCBjb250YWluaW5nIHRoZSB0b3VjaC9maW5nZXIgZGF0YSB0byB1cGFkdGUKCQkgKiBAcmV0dXJuIGEgZmluZ2VyIGRhdGEgb2JqZWN0LgoJCSAqIEBpbm5lcgoJCSovCgkJZnVuY3Rpb24gdXBkYXRlRmluZ2VyRGF0YShldnQpIHsKCQkJCgkJCXZhciBpZCA9IGV2dC5pZGVudGlmaWVyIT09dW5kZWZpbmVkID8gZXZ0LmlkZW50aWZpZXIgOiAwOyAKCQkJdmFyIGYgPSBnZXRGaW5nZXJEYXRhKCBpZCApOwoJCQkKCQkJZi5lbmQueCA9IGV2dC5wYWdlWHx8ZXZ0LmNsaWVudFg7CgkJCWYuZW5kLnkgPSBldnQucGFnZVl8fGV2dC5jbGllbnRZOwoJCQkKCQkJcmV0dXJuIGY7CgkJfQoJCQoJCS8qKgoJCSAqIFJldHVybnMgYSBmaW5nZXIgZGF0YSBvYmplY3QgYnkgaXRzIGV2ZW50IElELgoJCSAqIEVhY2ggdG91Y2ggZXZlbnQgaGFzIGFuIGlkZW50aWZpZXIgcHJvcGVydHksIHdoaWNoIGlzIHVzZWQgCgkJICogdG8gdHJhY2sgcmVwZWF0IHRvdWNoZXMKCQkgKiBAcGFyYW0ge2ludH0gaWQgVGhlIHVuaXF1ZSBpZCBvZiB0aGUgZmluZ2VyIGluIHRoZSBzZXF1ZW5jZSBvZiB0b3VjaCBldmVudHMuCgkJICogQHJldHVybiBhIGZpbmdlciBkYXRhIG9iamVjdC4KCQkgKiBAaW5uZXIKCQkqLwoJCWZ1bmN0aW9uIGdldEZpbmdlckRhdGEoIGlkICkgewoJCQlmb3IodmFyIGk9MDsgaTxmaW5nZXJEYXRhLmxlbmd0aDsgaSsrKSB7CgkJCQlpZihmaW5nZXJEYXRhW2ldLmlkZW50aWZpZXIgPT0gaWQpIHsKCQkJCQlyZXR1cm4gZmluZ2VyRGF0YVtpXTsJCgkJCQl9CgkJCX0KCQl9CgkJCgkJLyoqCgkJICogQ3JlYXRzIGFsbCB0aGUgZmluZ2VyIG9uamVjdHMgYW5kIHJldHVybnMgYW4gYXJyYXkgb2YgZmluZ2VyIGRhdGEKCQkgKiBAcmV0dXJuIEFycmF5IG9mIGZpbmdlciBvYmplY3RzCgkJICogQGlubmVyCgkJKi8KCQlmdW5jdGlvbiBjcmVhdGVBbGxGaW5nZXJEYXRhKCkgewoJCQl2YXIgZmluZ2VyRGF0YT1bXTsKCQkJZm9yICh2YXIgaT0wOyBpPD01OyBpKyspIHsKCQkJCWZpbmdlckRhdGEucHVzaCh7CgkJCQkJc3RhcnQ6eyB4OiAwLCB5OiAwIH0sCgkJCQkJZW5kOnsgeDogMCwgeTogMCB9LAoJCQkJCWlkZW50aWZpZXI6MAoJCQkJfSk7CgkJCX0KCQkJCgkJCXJldHVybiBmaW5nZXJEYXRhOwoJCX0KCQkKCQkvKioKCQkgKiBTZXRzIHRoZSBtYXhpbXVtIGRpc3RhbmNlIHN3aXBlZCBpbiB0aGUgZ2l2ZW4gZGlyZWN0aW9uLiAKCQkgKiBJZiB0aGUgbmV3IHZhbHVlIGlzIGxvd2VyIHRoYW4gdGhlIGN1cnJlbnQgdmFsdWUsIHRoZSBtYXggdmFsdWUgaXMgbm90IGNoYW5nZWQuCgkJICogQHBhcmFtIHtzdHJpbmd9ICBkaXJlY3Rpb24gVGhlIGRpcmVjdGlvbiBvZiB0aGUgc3dpcGUKCQkgKiBAcGFyYW0ge2ludH0gIGRpc3RhbmNlIFRoZSBkaXN0YW5jZSBvZiB0aGUgc3dpcGUKCQkgKiBAaW5uZXIKCQkqLwoJCWZ1bmN0aW9uIHNldE1heERpc3RhbmNlKGRpcmVjdGlvbiwgZGlzdGFuY2UpIHsKICAgIAkJZGlzdGFuY2UgPSBNYXRoLm1heChkaXN0YW5jZSwgZ2V0TWF4RGlzdGFuY2UoZGlyZWN0aW9uKSApOwogICAgCQltYXhpbXVtc01hcFtkaXJlY3Rpb25dLmRpc3RhbmNlID0gZGlzdGFuY2U7CgkJfQogICAgICAgIAogICAgICAgIC8qKgoJCSAqIGdldHMgdGhlIG1heGltdW0gZGlzdGFuY2Ugc3dpcGVkIGluIHRoZSBnaXZlbiBkaXJlY3Rpb24uIAoJCSAqIEBwYXJhbSB7c3RyaW5nfSAgZGlyZWN0aW9uIFRoZSBkaXJlY3Rpb24gb2YgdGhlIHN3aXBlCgkJICogQHJldHVybiBpbnQgIFRoZSBkaXN0YW5jZSBvZiB0aGUgc3dpcGUKCQkgKiBAaW5uZXIKCQkqLyAgICAgICAgCgkJZnVuY3Rpb24gZ2V0TWF4RGlzdGFuY2UoZGlyZWN0aW9uKSB7CgkJCWlmIChtYXhpbXVtc01hcFtkaXJlY3Rpb25dKSByZXR1cm4gbWF4aW11bXNNYXBbZGlyZWN0aW9uXS5kaXN0YW5jZTsKCQkJcmV0dXJuIHVuZGVmaW5lZDsKCQl9CgkJCgkJLyoqCgkJICogQ3JlYXRzIGEgbWFwIG9mIGRpcmVjdGlvbnMgdG8gbWF4aW11bSBzd2lwZWQgdmFsdWVzLgoJCSAqIEByZXR1cm4gT2JqZWN0IEEgZGljdGlvbmFyeSBvZiBtYXhpbXVtIHZhbHVlcywgaW5kZXhlZCBieSBkaXJlY3Rpb24uCgkJICogQGlubmVyCgkJKi8KCQlmdW5jdGlvbiBjcmVhdGVNYXhpbXVtc0RhdGEoKSB7CgkJCXZhciBtYXhEYXRhPXt9OwoJCQltYXhEYXRhW0xFRlRdPWNyZWF0ZU1heGltdW1WTyhMRUZUKTsKCQkJbWF4RGF0YVtSSUdIVF09Y3JlYXRlTWF4aW11bVZPKFJJR0hUKTsKCQkJbWF4RGF0YVtVUF09Y3JlYXRlTWF4aW11bVZPKFVQKTsKCQkJbWF4RGF0YVtET1dOXT1jcmVhdGVNYXhpbXVtVk8oRE9XTik7CgkJCQoJCQlyZXR1cm4gbWF4RGF0YTsKCQl9CgkJCgkJLyoqCgkJICogQ3JlYXRlcyBhIG1hcCBtYXhpbXVtIHN3aXBlZCB2YWx1ZXMgZm9yIGEgZ2l2ZW4gc3dpcGUgZGlyZWN0aW9uCgkJICogQHBhcmFtIHtzdHJpbmd9IFRoZSBkaXJlY3Rpb24gdGhhdCB0aGVzZSB2YWx1ZXMgd2lsbCBiZSBhc3NvY2lhdGVkIHdpdGgKCQkgKiBAcmV0dXJuIE9iamVjdCBNYXhpbXVtIHZhbHVlcwoJCSAqIEBpbm5lcgoJCSovCgkJZnVuY3Rpb24gY3JlYXRlTWF4aW11bVZPKGRpcikgewoJCSAgICByZXR1cm4geyAKCQkgICAgICAgIGRpcmVjdGlvbjpkaXIsIAoJCSAgICAgICAgZGlzdGFuY2U6MAoJCSAgICB9CgkJfQoJCQoJCQoJCS8vCgkJLy8gTUFUSFMgLyBVVElMUwoJCS8vCgoJCS8qKgoJCSogQ2FsY3VsYXRlIHRoZSBkdXJhdGlvbiBvZiB0aGUgc3dpcGUKCQkqIEByZXR1cm4gaW50CgkJKiBAaW5uZXIKCQkqLwoJCWZ1bmN0aW9uIGNhbGN1bGF0ZUR1cmF0aW9uKCkgewoJCQlyZXR1cm4gZW5kVGltZSAtIHN0YXJ0VGltZTsKCQl9CgkJCgkJLyoqCgkJKiBDYWxjdWxhdGUgdGhlIGRpc3RhbmNlIGJldHdlZW4gMiB0b3VjaGVzIChwaW5jaCkKCQkqIEBwYXJhbSB7cG9pbnR9IHN0YXJ0UG9pbnQgQSBwb2ludCBvYmplY3QgY29udGFpbmluZyB4IGFuZCB5IGNvLW9yZGluYXRlcwoJICAgICogQHBhcmFtIHtwb2ludH0gZW5kUG9pbnQgQSBwb2ludCBvYmplY3QgY29udGFpbmluZyB4IGFuZCB5IGNvLW9yZGluYXRlcwoJICAgICogQHJldHVybiBpbnQ7CgkJKiBAaW5uZXIKCQkqLwoJCWZ1bmN0aW9uIGNhbGN1bGF0ZVRvdWNoZXNEaXN0YW5jZShzdGFydFBvaW50LCBlbmRQb2ludCkgewoJCQl2YXIgZGlmZlggPSBNYXRoLmFicyhzdGFydFBvaW50LnggLSBlbmRQb2ludC54KTsKCQkJdmFyIGRpZmZZID0gTWF0aC5hYnMoc3RhcnRQb2ludC55IC0gZW5kUG9pbnQueSk7CgkJCQkKCQkJcmV0dXJuIE1hdGgucm91bmQoTWF0aC5zcXJ0KGRpZmZYKmRpZmZYK2RpZmZZKmRpZmZZKSk7CgkJfQoJCQoJCS8qKgoJCSogQ2FsY3VsYXRlIHRoZSB6b29tIGZhY3RvciBiZXR3ZWVuIHRoZSBzdGFydCBhbmQgZW5kIGRpc3RhbmNlcwoJCSogQHBhcmFtIHtpbnR9IHN0YXJ0RGlzdGFuY2UgRGlzdGFuY2UgKGJldHdlZW4gMiBmaW5nZXJzKSB0aGUgdXNlciBzdGFydGVkIHBpbmNoaW5nIGF0CgkgICAgKiBAcGFyYW0ge2ludH0gZW5kRGlzdGFuY2UgRGlzdGFuY2UgKGJldHdlZW4gMiBmaW5nZXJzKSB0aGUgdXNlciBlbmRlZCBwaW5jaGluZyBhdAoJICAgICogQHJldHVybiBmbG9hdCBUaGUgem9vbSB2YWx1ZSBmcm9tIDAgdG8gMS4KCQkqIEBpbm5lcgoJCSovCgkJZnVuY3Rpb24gY2FsY3VsYXRlUGluY2hab29tKHN0YXJ0RGlzdGFuY2UsIGVuZERpc3RhbmNlKSB7CgkJCXZhciBwZXJjZW50ID0gKGVuZERpc3RhbmNlL3N0YXJ0RGlzdGFuY2UpICogMTsKCQkJcmV0dXJuIHBlcmNlbnQudG9GaXhlZCgyKTsKCQl9CgkJCgkJCgkJLyoqCgkJKiBSZXR1cm5zIHRoZSBwaW5jaCBkaXJlY3Rpb24sIGVpdGhlciBJTiBvciBPVVQgZm9yIHRoZSBnaXZlbiBwb2ludHMKCQkqIEByZXR1cm4gc3RyaW5nIEVpdGhlciB7QGxpbmsgJC5mbi5zd2lwZS5kaXJlY3Rpb25zLklOfSBvciB7QGxpbmsgJC5mbi5zd2lwZS5kaXJlY3Rpb25zLk9VVH0KCQkqIEBzZWUgJC5mbi5zd2lwZS5kaXJlY3Rpb25zCgkJKiBAaW5uZXIKCQkqLwoJCWZ1bmN0aW9uIGNhbGN1bGF0ZVBpbmNoRGlyZWN0aW9uKCkgewoJCQlpZihwaW5jaFpvb208MSkgewoJCQkJcmV0dXJuIE9VVDsKCQkJfQoJCQllbHNlIHsKCQkJCXJldHVybiBJTjsKCQkJfQoJCX0KCQkKCQkKCQkvKioKCQkqIENhbGN1bGF0ZSB0aGUgbGVuZ3RoIC8gZGlzdGFuY2Ugb2YgdGhlIHN3aXBlCgkJKiBAcGFyYW0ge3BvaW50fSBzdGFydFBvaW50IEEgcG9pbnQgb2JqZWN0IGNvbnRhaW5pbmcgeCBhbmQgeSBjby1vcmRpbmF0ZXMKCSAgICAqIEBwYXJhbSB7cG9pbnR9IGVuZFBvaW50IEEgcG9pbnQgb2JqZWN0IGNvbnRhaW5pbmcgeCBhbmQgeSBjby1vcmRpbmF0ZXMKCSAgICAqIEByZXR1cm4gaW50CgkJKiBAaW5uZXIKCQkqLwoJCWZ1bmN0aW9uIGNhbGN1bGF0ZURpc3RhbmNlKHN0YXJ0UG9pbnQsIGVuZFBvaW50KSB7CgkJCXJldHVybiBNYXRoLnJvdW5kKE1hdGguc3FydChNYXRoLnBvdyhlbmRQb2ludC54IC0gc3RhcnRQb2ludC54LCAyKSArIE1hdGgucG93KGVuZFBvaW50LnkgLSBzdGFydFBvaW50LnksIDIpKSk7CgkJfQoKCQkvKioKCQkqIENhbGN1bGF0ZSB0aGUgYW5nbGUgb2YgdGhlIHN3aXBlCgkJKiBAcGFyYW0ge3BvaW50fSBzdGFydFBvaW50IEEgcG9pbnQgb2JqZWN0IGNvbnRhaW5pbmcgeCBhbmQgeSBjby1vcmRpbmF0ZXMKCSAgICAqIEBwYXJhbSB7cG9pbnR9IGVuZFBvaW50IEEgcG9pbnQgb2JqZWN0IGNvbnRhaW5pbmcgeCBhbmQgeSBjby1vcmRpbmF0ZXMKCSAgICAqIEByZXR1cm4gaW50CgkJKiBAaW5uZXIKCQkqLwoJCWZ1bmN0aW9uIGNhbGN1bGF0ZUFuZ2xlKHN0YXJ0UG9pbnQsIGVuZFBvaW50KSB7CgkJCXZhciB4ID0gc3RhcnRQb2ludC54IC0gZW5kUG9pbnQueDsKCQkJdmFyIHkgPSBlbmRQb2ludC55IC0gc3RhcnRQb2ludC55OwoJCQl2YXIgciA9IE1hdGguYXRhbjIoeSwgeCk7IC8vcmFkaWFucwoJCQl2YXIgYW5nbGUgPSBNYXRoLnJvdW5kKHIgKiAxODAgLyBNYXRoLlBJKTsgLy9kZWdyZWVzCgoJCQkvL2Vuc3VyZSB2YWx1ZSBpcyBwb3NpdGl2ZQoJCQlpZiAoYW5nbGUgPCAwKSB7CgkJCQlhbmdsZSA9IDM2MCAtIE1hdGguYWJzKGFuZ2xlKTsKCQkJfQoKCQkJcmV0dXJuIGFuZ2xlOwoJCX0KCgkJLyoqCgkJKiBDYWxjdWxhdGUgdGhlIGRpcmVjdGlvbiBvZiB0aGUgc3dpcGUKCQkqIFRoaXMgd2lsbCBhbHNvIGNhbGwgY2FsY3VsYXRlQW5nbGUgdG8gZ2V0IHRoZSBsYXRlc3QgYW5nbGUgb2Ygc3dpcGUKCQkqIEBwYXJhbSB7cG9pbnR9IHN0YXJ0UG9pbnQgQSBwb2ludCBvYmplY3QgY29udGFpbmluZyB4IGFuZCB5IGNvLW9yZGluYXRlcwoJICAgICogQHBhcmFtIHtwb2ludH0gZW5kUG9pbnQgQSBwb2ludCBvYmplY3QgY29udGFpbmluZyB4IGFuZCB5IGNvLW9yZGluYXRlcwoJICAgICogQHJldHVybiBzdHJpbmcgRWl0aGVyIHtAbGluayAkLmZuLnN3aXBlLmRpcmVjdGlvbnMuTEVGVH0gLyB7QGxpbmsgJC5mbi5zd2lwZS5kaXJlY3Rpb25zLlJJR0hUfSAvIHtAbGluayAkLmZuLnN3aXBlLmRpcmVjdGlvbnMuRE9XTn0gLyB7QGxpbmsgJC5mbi5zd2lwZS5kaXJlY3Rpb25zLlVQfQoJCSogQHNlZSAkLmZuLnN3aXBlLmRpcmVjdGlvbnMKCQkqIEBpbm5lcgoJCSovCgkJZnVuY3Rpb24gY2FsY3VsYXRlRGlyZWN0aW9uKHN0YXJ0UG9pbnQsIGVuZFBvaW50ICkgewoJCQl2YXIgYW5nbGUgPSBjYWxjdWxhdGVBbmdsZShzdGFydFBvaW50LCBlbmRQb2ludCk7CgoJCQlpZiAoKGFuZ2xlIDw9IDQ1KSAmJiAoYW5nbGUgPj0gMCkpIHsKCQkJCXJldHVybiBMRUZUOwoJCQl9IGVsc2UgaWYgKChhbmdsZSA8PSAzNjApICYmIChhbmdsZSA+PSAzMTUpKSB7CgkJCQlyZXR1cm4gTEVGVDsKCQkJfSBlbHNlIGlmICgoYW5nbGUgPj0gMTM1KSAmJiAoYW5nbGUgPD0gMjI1KSkgewoJCQkJcmV0dXJuIFJJR0hUOwoJCQl9IGVsc2UgaWYgKChhbmdsZSA+IDQ1KSAmJiAoYW5nbGUgPCAxMzUpKSB7CgkJCQlyZXR1cm4gRE9XTjsKCQkJfSBlbHNlIHsKCQkJCXJldHVybiBVUDsKCQkJfQoJCX0KCQkKCgkJLyoqCgkJKiBSZXR1cm5zIGEgTVMgdGltZSBzdGFtcCBvZiB0aGUgY3VycmVudCB0aW1lCgkJKiBAcmV0dXJuIGludAoJCSogQGlubmVyCgkJKi8KCQlmdW5jdGlvbiBnZXRUaW1lU3RhbXAoKSB7CgkJCXZhciBub3cgPSBuZXcgRGF0ZSgpOwoJCQlyZXR1cm4gbm93LmdldFRpbWUoKTsKCQl9CgkJCgkJCgkJCgkJLyoqCgkJICogUmV0dXJucyBhIGJvdW5kcyBvYmplY3Qgd2l0aCBsZWZ0LCByaWdodCwgdG9wIGFuZCBib3R0b20gcHJvcGVydGllcyBmb3IgdGhlIGVsZW1lbnQgc3BlY2lmaWVkLgoJCSAqIEBwYXJhbSB7RG9tTm9kZX0gVGhlIERPTSBub2RlIHRvIGdldCB0aGUgYm91bmRzIGZvci4KCQkgKi8KCQlmdW5jdGlvbiBnZXRib3VuZHMoIGVsICkgewoJCQllbCA9ICQoZWwpOwoJCQl2YXIgb2Zmc2V0ID0gZWwub2Zmc2V0KCk7CgkJCQoJCQl2YXIgYm91bmRzID0gewkKCQkJCQlsZWZ0Om9mZnNldC5sZWZ0LAoJCQkJCXJpZ2h0Om9mZnNldC5sZWZ0K2VsLm91dGVyV2lkdGgoKSwKCQkJCQl0b3A6b2Zmc2V0LnRvcCwKCQkJCQlib3R0b206b2Zmc2V0LnRvcCtlbC5vdXRlckhlaWdodCgpCgkJCQkJfQoJCQkKCQkJcmV0dXJuIGJvdW5kczsJCgkJfQoJCQoJCQoJCS8qKgoJCSAqIENoZWNrcyBpZiB0aGUgcG9pbnQgb2JqZWN0IGlzIGluIHRoZSBib3VuZHMgb2JqZWN0LgoJCSAqIEBwYXJhbSB7b2JqZWN0fSBwb2ludCBBIHBvaW50IG9iamVjdC4KCQkgKiBAcGFyYW0ge2ludH0gcG9pbnQueCBUaGUgeCB2YWx1ZSBvZiB0aGUgcG9pbnQuCgkJICogQHBhcmFtIHtpbnR9IHBvaW50LnkgVGhlIHggdmFsdWUgb2YgdGhlIHBvaW50LgoJCSAqIEBwYXJhbSB7b2JqZWN0fSBib3VuZHMgVGhlIGJvdW5kcyBvYmplY3QgdG8gdGVzdAoJCSAqIEBwYXJhbSB7aW50fSBib3VuZHMubGVmdCBUaGUgbGVmdG1vc3QgdmFsdWUKCQkgKiBAcGFyYW0ge2ludH0gYm91bmRzLnJpZ2h0IFRoZSByaWdodHRtb3N0IHZhbHVlCgkJICogQHBhcmFtIHtpbnR9IGJvdW5kcy50b3AgVGhlIHRvcG1vc3QgdmFsdWUKCQkqIEBwYXJhbSB7aW50fSBib3VuZHMuYm90dG9tIFRoZSBib3R0b21tb3N0IHZhbHVlCgkJICovCgkJZnVuY3Rpb24gaXNJbkJvdW5kcyhwb2ludCwgYm91bmRzKSB7CgkJCXJldHVybiAocG9pbnQueCA+IGJvdW5kcy5sZWZ0ICYmIHBvaW50LnggPCBib3VuZHMucmlnaHQgJiYgcG9pbnQueSA+IGJvdW5kcy50b3AgJiYgcG9pbnQueSA8IGJvdW5kcy5ib3R0b20pOwoJCX07CgkKCQoJfQoJCgkKCgovKioKICogQSBjYXRjaCBhbGwgaGFuZGxlciB0aGF0IGlzIHRyaWdnZXJlZCBmb3IgYWxsIHN3aXBlIGRpcmVjdGlvbnMuIAogKiBAbmFtZSAkLmZuLnN3aXBlI3N3aXBlCiAqIEBldmVudAogKiBAZGVmYXVsdCBudWxsCiAqIEBwYXJhbSB7RXZlbnRPYmplY3R9IGV2ZW50IFRoZSBvcmlnaW5hbCBldmVudCBvYmplY3QKICogQHBhcmFtIHtpbnR9IGRpcmVjdGlvbiBUaGUgZGlyZWN0aW9uIHRoZSB1c2VyIHN3aXBlZCBpbi4gU2VlIHtAbGluayAkLmZuLnN3aXBlLmRpcmVjdGlvbnN9CiAqIEBwYXJhbSB7aW50fSBkaXN0YW5jZSBUaGUgZGlzdGFuY2UgdGhlIHVzZXIgc3dpcGVkCiAqIEBwYXJhbSB7aW50fSBkdXJhdGlvbiBUaGUgZHVyYXRpb24gb2YgdGhlIHN3aXBlIGluIG1pbGxpc2Vjb25kcwogKiBAcGFyYW0ge2ludH0gZmluZ2VyQ291bnQgVGhlIG51bWJlciBvZiBmaW5nZXJzIHVzZWQuIFNlZSB7QGxpbmsgJC5mbi5zd2lwZS5maW5nZXJzfQogKiBAcGFyYW0ge29iamVjdH0gZmluZ2VyRGF0YSBUaGUgY29vcmRpbmF0ZXMgb2YgZmluZ2VycyBpbiBldmVudAogKi8KIAoKCgovKioKICogQSBoYW5kbGVyIHRoYXQgaXMgdHJpZ2dlcmVkIGZvciAibGVmdCIgc3dpcGVzLgogKiBAbmFtZSAkLmZuLnN3aXBlI3N3aXBlTGVmdAogKiBAZXZlbnQKICogQGRlZmF1bHQgbnVsbAogKiBAcGFyYW0ge0V2ZW50T2JqZWN0fSBldmVudCBUaGUgb3JpZ2luYWwgZXZlbnQgb2JqZWN0CiAqIEBwYXJhbSB7aW50fSBkaXJlY3Rpb24gVGhlIGRpcmVjdGlvbiB0aGUgdXNlciBzd2lwZWQgaW4uIFNlZSB7QGxpbmsgJC5mbi5zd2lwZS5kaXJlY3Rpb25zfQogKiBAcGFyYW0ge2ludH0gZGlzdGFuY2UgVGhlIGRpc3RhbmNlIHRoZSB1c2VyIHN3aXBlZAogKiBAcGFyYW0ge2ludH0gZHVyYXRpb24gVGhlIGR1cmF0aW9uIG9mIHRoZSBzd2lwZSBpbiBtaWxsaXNlY29uZHMKICogQHBhcmFtIHtpbnR9IGZpbmdlckNvdW50IFRoZSBudW1iZXIgb2YgZmluZ2VycyB1c2VkLiBTZWUge0BsaW5rICQuZm4uc3dpcGUuZmluZ2Vyc30KICogQHBhcmFtIHtvYmplY3R9IGZpbmdlckRhdGEgVGhlIGNvb3JkaW5hdGVzIG9mIGZpbmdlcnMgaW4gZXZlbnQKICovCiAKLyoqCiAqIEEgaGFuZGxlciB0aGF0IGlzIHRyaWdnZXJlZCBmb3IgInJpZ2h0IiBzd2lwZXMuCiAqIEBuYW1lICQuZm4uc3dpcGUjc3dpcGVSaWdodAogKiBAZXZlbnQKICogQGRlZmF1bHQgbnVsbAogKiBAcGFyYW0ge0V2ZW50T2JqZWN0fSBldmVudCBUaGUgb3JpZ2luYWwgZXZlbnQgb2JqZWN0CiAqIEBwYXJhbSB7aW50fSBkaXJlY3Rpb24gVGhlIGRpcmVjdGlvbiB0aGUgdXNlciBzd2lwZWQgaW4uIFNlZSB7QGxpbmsgJC5mbi5zd2lwZS5kaXJlY3Rpb25zfQogKiBAcGFyYW0ge2ludH0gZGlzdGFuY2UgVGhlIGRpc3RhbmNlIHRoZSB1c2VyIHN3aXBlZAogKiBAcGFyYW0ge2ludH0gZHVyYXRpb24gVGhlIGR1cmF0aW9uIG9mIHRoZSBzd2lwZSBpbiBtaWxsaXNlY29uZHMKICogQHBhcmFtIHtpbnR9IGZpbmdlckNvdW50IFRoZSBudW1iZXIgb2YgZmluZ2VycyB1c2VkLiBTZWUge0BsaW5rICQuZm4uc3dpcGUuZmluZ2Vyc30KICogQHBhcmFtIHtvYmplY3R9IGZpbmdlckRhdGEgVGhlIGNvb3JkaW5hdGVzIG9mIGZpbmdlcnMgaW4gZXZlbnQKICovCgovKioKICogQSBoYW5kbGVyIHRoYXQgaXMgdHJpZ2dlcmVkIGZvciAidXAiIHN3aXBlcy4KICogQG5hbWUgJC5mbi5zd2lwZSNzd2lwZVVwCiAqIEBldmVudAogKiBAZGVmYXVsdCBudWxsCiAqIEBwYXJhbSB7RXZlbnRPYmplY3R9IGV2ZW50IFRoZSBvcmlnaW5hbCBldmVudCBvYmplY3QKICogQHBhcmFtIHtpbnR9IGRpcmVjdGlvbiBUaGUgZGlyZWN0aW9uIHRoZSB1c2VyIHN3aXBlZCBpbi4gU2VlIHtAbGluayAkLmZuLnN3aXBlLmRpcmVjdGlvbnN9CiAqIEBwYXJhbSB7aW50fSBkaXN0YW5jZSBUaGUgZGlzdGFuY2UgdGhlIHVzZXIgc3dpcGVkCiAqIEBwYXJhbSB7aW50fSBkdXJhdGlvbiBUaGUgZHVyYXRpb24gb2YgdGhlIHN3aXBlIGluIG1pbGxpc2Vjb25kcwogKiBAcGFyYW0ge2ludH0gZmluZ2VyQ291bnQgVGhlIG51bWJlciBvZiBmaW5nZXJzIHVzZWQuIFNlZSB7QGxpbmsgJC5mbi5zd2lwZS5maW5nZXJzfQogKiBAcGFyYW0ge29iamVjdH0gZmluZ2VyRGF0YSBUaGUgY29vcmRpbmF0ZXMgb2YgZmluZ2VycyBpbiBldmVudAogKi8KIAovKioKICogQSBoYW5kbGVyIHRoYXQgaXMgdHJpZ2dlcmVkIGZvciAiZG93biIgc3dpcGVzLgogKiBAbmFtZSAkLmZuLnN3aXBlI3N3aXBlRG93bgogKiBAZXZlbnQKICogQGRlZmF1bHQgbnVsbAogKiBAcGFyYW0ge0V2ZW50T2JqZWN0fSBldmVudCBUaGUgb3JpZ2luYWwgZXZlbnQgb2JqZWN0CiAqIEBwYXJhbSB7aW50fSBkaXJlY3Rpb24gVGhlIGRpcmVjdGlvbiB0aGUgdXNlciBzd2lwZWQgaW4uIFNlZSB7QGxpbmsgJC5mbi5zd2lwZS5kaXJlY3Rpb25zfQogKiBAcGFyYW0ge2ludH0gZGlzdGFuY2UgVGhlIGRpc3RhbmNlIHRoZSB1c2VyIHN3aXBlZAogKiBAcGFyYW0ge2ludH0gZHVyYXRpb24gVGhlIGR1cmF0aW9uIG9mIHRoZSBzd2lwZSBpbiBtaWxsaXNlY29uZHMKICogQHBhcmFtIHtpbnR9IGZpbmdlckNvdW50IFRoZSBudW1iZXIgb2YgZmluZ2VycyB1c2VkLiBTZWUge0BsaW5rICQuZm4uc3dpcGUuZmluZ2Vyc30KICogQHBhcmFtIHtvYmplY3R9IGZpbmdlckRhdGEgVGhlIGNvb3JkaW5hdGVzIG9mIGZpbmdlcnMgaW4gZXZlbnQKICovCiAKLyoqCiAqIEEgaGFuZGxlciB0cmlnZ2VyZWQgZm9yIGV2ZXJ5IHBoYXNlIG9mIHRoZSBzd2lwZS4gVGhpcyBoYW5kbGVyIGlzIGNvbnN0YW50bHkgZmlyZWQgZm9yIHRoZSBkdXJhdGlvbiBvZiB0aGUgcGluY2guCiAqIFRoaXMgaXMgdHJpZ2dlcmVkIHJlZ2FyZGxlc3Mgb2Ygc3dpcGUgdGhyZXNob2xkcy4KICogQG5hbWUgJC5mbi5zd2lwZSNzd2lwZVN0YXR1cwogKiBAZXZlbnQKICogQGRlZmF1bHQgbnVsbAogKiBAcGFyYW0ge0V2ZW50T2JqZWN0fSBldmVudCBUaGUgb3JpZ2luYWwgZXZlbnQgb2JqZWN0CiAqIEBwYXJhbSB7c3RyaW5nfSBwaGFzZSBUaGUgcGhhc2Ugb2YgdGhlIHN3aXBlIGV2ZW50LiBTZWUge0BsaW5rICQuZm4uc3dpcGUucGhhc2VzfQogKiBAcGFyYW0ge3N0cmluZ30gZGlyZWN0aW9uIFRoZSBkaXJlY3Rpb24gdGhlIHVzZXIgc3dpcGVkIGluLiBUaGlzIGlzIG51bGwgaWYgdGhlIHVzZXIgaGFzIHlldCB0byBtb3ZlLiBTZWUge0BsaW5rICQuZm4uc3dpcGUuZGlyZWN0aW9uc30KICogQHBhcmFtIHtpbnR9IGRpc3RhbmNlIFRoZSBkaXN0YW5jZSB0aGUgdXNlciBzd2lwZWQuIFRoaXMgaXMgMCBpZiB0aGUgdXNlciBoYXMgeWV0IHRvIG1vdmUuCiAqIEBwYXJhbSB7aW50fSBkdXJhdGlvbiBUaGUgZHVyYXRpb24gb2YgdGhlIHN3aXBlIGluIG1pbGxpc2Vjb25kcwogKiBAcGFyYW0ge2ludH0gZmluZ2VyQ291bnQgVGhlIG51bWJlciBvZiBmaW5nZXJzIHVzZWQuIFNlZSB7QGxpbmsgJC5mbi5zd2lwZS5maW5nZXJzfQogKiBAcGFyYW0ge29iamVjdH0gZmluZ2VyRGF0YSBUaGUgY29vcmRpbmF0ZXMgb2YgZmluZ2VycyBpbiBldmVudAogKi8KIAovKioKICogQSBoYW5kbGVyIHRyaWdnZXJlZCBmb3IgcGluY2ggaW4gZXZlbnRzLgogKiBAbmFtZSAkLmZuLnN3aXBlI3BpbmNoSW4KICogQGV2ZW50CiAqIEBkZWZhdWx0IG51bGwKICogQHBhcmFtIHtFdmVudE9iamVjdH0gZXZlbnQgVGhlIG9yaWdpbmFsIGV2ZW50IG9iamVjdAogKiBAcGFyYW0ge2ludH0gZGlyZWN0aW9uIFRoZSBkaXJlY3Rpb24gdGhlIHVzZXIgcGluY2hlZCBpbi4gU2VlIHtAbGluayAkLmZuLnN3aXBlLmRpcmVjdGlvbnN9CiAqIEBwYXJhbSB7aW50fSBkaXN0YW5jZSBUaGUgZGlzdGFuY2UgdGhlIHVzZXIgcGluY2hlZAogKiBAcGFyYW0ge2ludH0gZHVyYXRpb24gVGhlIGR1cmF0aW9uIG9mIHRoZSBzd2lwZSBpbiBtaWxsaXNlY29uZHMKICogQHBhcmFtIHtpbnR9IGZpbmdlckNvdW50IFRoZSBudW1iZXIgb2YgZmluZ2VycyB1c2VkLiBTZWUge0BsaW5rICQuZm4uc3dpcGUuZmluZ2Vyc30KICogQHBhcmFtIHtpbnR9IHpvb20gVGhlIHpvb20vc2NhbGUgbGV2ZWwgdGhlIHVzZXIgcGluY2hlZCB0b28sIDAtMS4KICogQHBhcmFtIHtvYmplY3R9IGZpbmdlckRhdGEgVGhlIGNvb3JkaW5hdGVzIG9mIGZpbmdlcnMgaW4gZXZlbnQKICovCgovKioKICogQSBoYW5kbGVyIHRyaWdnZXJlZCBmb3IgcGluY2ggb3V0IGV2ZW50cy4KICogQG5hbWUgJC5mbi5zd2lwZSNwaW5jaE91dAogKiBAZXZlbnQKICogQGRlZmF1bHQgbnVsbAogKiBAcGFyYW0ge0V2ZW50T2JqZWN0fSBldmVudCBUaGUgb3JpZ2luYWwgZXZlbnQgb2JqZWN0CiAqIEBwYXJhbSB7aW50fSBkaXJlY3Rpb24gVGhlIGRpcmVjdGlvbiB0aGUgdXNlciBwaW5jaGVkIGluLiBTZWUge0BsaW5rICQuZm4uc3dpcGUuZGlyZWN0aW9uc30KICogQHBhcmFtIHtpbnR9IGRpc3RhbmNlIFRoZSBkaXN0YW5jZSB0aGUgdXNlciBwaW5jaGVkCiAqIEBwYXJhbSB7aW50fSBkdXJhdGlvbiBUaGUgZHVyYXRpb24gb2YgdGhlIHN3aXBlIGluIG1pbGxpc2Vjb25kcwogKiBAcGFyYW0ge2ludH0gZmluZ2VyQ291bnQgVGhlIG51bWJlciBvZiBmaW5nZXJzIHVzZWQuIFNlZSB7QGxpbmsgJC5mbi5zd2lwZS5maW5nZXJzfQogKiBAcGFyYW0ge2ludH0gem9vbSBUaGUgem9vbS9zY2FsZSBsZXZlbCB0aGUgdXNlciBwaW5jaGVkIHRvbywgMC0xLgogKiBAcGFyYW0ge29iamVjdH0gZmluZ2VyRGF0YSBUaGUgY29vcmRpbmF0ZXMgb2YgZmluZ2VycyBpbiBldmVudAogKi8gCgovKioKICogQSBoYW5kbGVyIHRyaWdnZXJlZCBmb3IgYWxsIHBpbmNoIGV2ZW50cy4gVGhpcyBoYW5kbGVyIGlzIGNvbnN0YW50bHkgZmlyZWQgZm9yIHRoZSBkdXJhdGlvbiBvZiB0aGUgcGluY2guIFRoaXMgaXMgdHJpZ2dlcmVkIHJlZ2FyZGxlc3Mgb2YgdGhyZXNob2xkcy4KICogQG5hbWUgJC5mbi5zd2lwZSNwaW5jaFN0YXR1cwogKiBAZXZlbnQKICogQGRlZmF1bHQgbnVsbAogKiBAcGFyYW0ge0V2ZW50T2JqZWN0fSBldmVudCBUaGUgb3JpZ2luYWwgZXZlbnQgb2JqZWN0CiAqIEBwYXJhbSB7aW50fSBkaXJlY3Rpb24gVGhlIGRpcmVjdGlvbiB0aGUgdXNlciBwaW5jaGVkIGluLiBTZWUge0BsaW5rICQuZm4uc3dpcGUuZGlyZWN0aW9uc30KICogQHBhcmFtIHtpbnR9IGRpc3RhbmNlIFRoZSBkaXN0YW5jZSB0aGUgdXNlciBwaW5jaGVkCiAqIEBwYXJhbSB7aW50fSBkdXJhdGlvbiBUaGUgZHVyYXRpb24gb2YgdGhlIHN3aXBlIGluIG1pbGxpc2Vjb25kcwogKiBAcGFyYW0ge2ludH0gZmluZ2VyQ291bnQgVGhlIG51bWJlciBvZiBmaW5nZXJzIHVzZWQuIFNlZSB7QGxpbmsgJC5mbi5zd2lwZS5maW5nZXJzfQogKiBAcGFyYW0ge2ludH0gem9vbSBUaGUgem9vbS9zY2FsZSBsZXZlbCB0aGUgdXNlciBwaW5jaGVkIHRvbywgMC0xLgogKiBAcGFyYW0ge29iamVjdH0gZmluZ2VyRGF0YSBUaGUgY29vcmRpbmF0ZXMgb2YgZmluZ2VycyBpbiBldmVudAogKi8KCi8qKgogKiBBIGNsaWNrIGhhbmRsZXIgdHJpZ2dlcmVkIHdoZW4gYSB1c2VyIHNpbXBseSBjbGlja3MsIHJhdGhlciB0aGFuIHN3aXBlcyBvbiBhbiBlbGVtZW50LgogKiBUaGlzIGlzIGRlcHJlY2F0ZWQgc2luY2UgdmVyc2lvbiAxLjYuMiwgYW55IGFzc2lnbm1lbnQgdG8gY2xpY2sgd2lsbCBiZSBhc3NpZ25lZCB0byB0aGUgdGFwIGhhbmRsZXIuCiAqIFlvdSBjYW5ub3QgdXNlIDxjb2RlPm9uPC9jb2RlPiB0byBiaW5kIHRvIHRoaXMgZXZlbnQgYXMgdGhlIGRlZmF1bHQgalEgPGNvZGU+Y2xpY2s8L2NvZGU+IGV2ZW50IHdpbGwgYmUgdHJpZ2dlcmVkLgogKiBVc2UgdGhlIDxjb2RlPnRhcDwvY29kZT4gZXZlbnQgaW5zdGVhZC4KICogQG5hbWUgJC5mbi5zd2lwZSNjbGljawogKiBAZXZlbnQKICogQGRlcHJlY2F0ZWQgc2luY2UgdmVyc2lvbiAxLjYuMiwgcGxlYXNlIHVzZSB7QGxpbmsgJC5mbi5zd2lwZSN0YXB9IGluc3RlYWQgCiAqIEBkZWZhdWx0IG51bGwKICogQHBhcmFtIHtFdmVudE9iamVjdH0gZXZlbnQgVGhlIG9yaWdpbmFsIGV2ZW50IG9iamVjdAogKiBAcGFyYW0ge0RvbU9iamVjdH0gdGFyZ2V0IFRoZSBlbGVtZW50IGNsaWNrZWQgb24uCiAqLwogCiAvKioKICogQSBjbGljayAvIHRhcCBoYW5kbGVyIHRyaWdnZXJlZCB3aGVuIGEgdXNlciBzaW1wbHkgY2xpY2tzIG9yIHRhcHMsIHJhdGhlciB0aGFuIHN3aXBlcyBvbiBhbiBlbGVtZW50LgogKiBAbmFtZSAkLmZuLnN3aXBlI3RhcAogKiBAZXZlbnQKICogQGRlZmF1bHQgbnVsbAogKiBAcGFyYW0ge0V2ZW50T2JqZWN0fSBldmVudCBUaGUgb3JpZ2luYWwgZXZlbnQgb2JqZWN0CiAqIEBwYXJhbSB7RG9tT2JqZWN0fSB0YXJnZXQgVGhlIGVsZW1lbnQgY2xpY2tlZCBvbi4KICovCiAKLyoqCiAqIEEgZG91YmxlIHRhcCBoYW5kbGVyIHRyaWdnZXJlZCB3aGVuIGEgdXNlciBkb3VibGUgY2xpY2tzIG9yIHRhcHMgb24gYW4gZWxlbWVudC4KICogWW91IGNhbiBzZXQgdGhlIHRpbWUgZGVsYXkgZm9yIGEgZG91YmxlIHRhcCB3aXRoIHRoZSB7QGxpbmsgJC5mbi5zd2lwZS5kZWZhdWx0cyNkb3VibGVUYXBUaHJlc2hvbGR9IHByb3BlcnR5LiAKICogTm90ZTogSWYgeW91IHNldCBib3RoIDxjb2RlPmRvdWJsZVRhcDwvY29kZT4gYW5kIDxjb2RlPnRhcDwvY29kZT4gaGFuZGxlcnMsIHRoZSA8Y29kZT50YXA8L2NvZGU+IGV2ZW50IHdpbGwgYmUgZGVsYXllZCBieSB0aGUgPGNvZGU+ZG91YmxlVGFwVGhyZXNob2xkPC9jb2RlPgogKiBhcyB0aGUgc2NyaXB0IG5lZWRzIHRvIGNoZWNrIGlmIGl0cyBhIGRvdWJsZSB0YXAuCiAqIEBuYW1lICQuZm4uc3dpcGUjZG91YmxlVGFwCiAqIEBzZWUgICQuZm4uc3dpcGUuZGVmYXVsdHMjZG91YmxlVGFwVGhyZXNob2xkCiAqIEBldmVudAogKiBAZGVmYXVsdCBudWxsCiAqIEBwYXJhbSB7RXZlbnRPYmplY3R9IGV2ZW50IFRoZSBvcmlnaW5hbCBldmVudCBvYmplY3QKICogQHBhcmFtIHtEb21PYmplY3R9IHRhcmdldCBUaGUgZWxlbWVudCBjbGlja2VkIG9uLgogKi8KIAogLyoqCiAqIEEgbG9uZyB0YXAgaGFuZGxlciB0cmlnZ2VyZWQgb25jZSBhIHRhcCBoYXMgYmVlbiByZWxlYXNlIGlmIHRoZSB0YXAgd2FzIGxvbmdlciB0aGFuIHRoZSBsb25nVGFwVGhyZXNob2xkLgogKiBZb3UgY2FuIHNldCB0aGUgdGltZSBkZWxheSBmb3IgYSBsb25nIHRhcCB3aXRoIHRoZSB7QGxpbmsgJC5mbi5zd2lwZS5kZWZhdWx0cyNsb25nVGFwVGhyZXNob2xkfSBwcm9wZXJ0eS4gCiAqIEBuYW1lICQuZm4uc3dpcGUjbG9uZ1RhcAogKiBAc2VlICAkLmZuLnN3aXBlLmRlZmF1bHRzI2xvbmdUYXBUaHJlc2hvbGQKICogQGV2ZW50CiAqIEBkZWZhdWx0IG51bGwKICogQHBhcmFtIHtFdmVudE9iamVjdH0gZXZlbnQgVGhlIG9yaWdpbmFsIGV2ZW50IG9iamVjdAogKiBAcGFyYW0ge0RvbU9iamVjdH0gdGFyZ2V0IFRoZSBlbGVtZW50IGNsaWNrZWQgb24uCiAqLwoKICAvKioKICogQSBob2xkIHRhcCBoYW5kbGVyIHRyaWdnZXJlZCBhcyBzb29uIGFzIHRoZSBsb25nVGFwVGhyZXNob2xkIGlzIHJlYWNoZWQKICogWW91IGNhbiBzZXQgdGhlIHRpbWUgZGVsYXkgZm9yIGEgbG9uZyB0YXAgd2l0aCB0aGUge0BsaW5rICQuZm4uc3dpcGUuZGVmYXVsdHMjbG9uZ1RhcFRocmVzaG9sZH0gcHJvcGVydHkuIAogKiBAbmFtZSAkLmZuLnN3aXBlI2hvbGQKICogQHNlZSAgJC5mbi5zd2lwZS5kZWZhdWx0cyNsb25nVGFwVGhyZXNob2xkCiAqIEBldmVudAogKiBAZGVmYXVsdCBudWxsCiAqIEBwYXJhbSB7RXZlbnRPYmplY3R9IGV2ZW50IFRoZSBvcmlnaW5hbCBldmVudCBvYmplY3QKICogQHBhcmFtIHtEb21PYmplY3R9IHRhcmdldCBUaGUgZWxlbWVudCBjbGlja2VkIG9uLgogKi8KCn0pKTsKCmRlZmluZSgnZ2FsbGVyeS92aWV3cy9zZWxlY3Rpb24vc2VsZWN0LmJ1dHRvbicsWwogICdiYWNrYm9uZScsCiAgJ2pxdWVyeScsCiAgJ2pxdWVyeS10b3VjaHN3aXBlJwpdLApmdW5jdGlvbiAoQmFja2JvbmUsICQsIG5vcGUpIHsKCiAgLyoKICAgKiBNb2RlbDogSW1hZ2VNb2RlbAogICAqIEVsZW1lbnQ6IHNldCB3aXRoIGNvbnN0cnVjdG9yCiAgICovCiAgdmFyIFNlbGVjdEJ1dHRvbiA9IEJhY2tib25lLlZpZXcuZXh0ZW5kKHsKCiAgICBpbml0aWFsaXplOiBmdW5jdGlvbigpIHsKICAgICAgaWYgKHRoaXMubW9kZWwgJiYgdGhpcy5lbCkgewogICAgICAgIHRoaXMubGlzdGVuVG8odGhpcy5tb2RlbCwgJ2NoYW5nZTpzZWxlY3RlZCcsIHRoaXMudXBkYXRlU2VsZWN0ZWQpOwogICAgICAgIHRoaXMudXBkYXRlU2VsZWN0ZWQodGhpcy5tb2RlbCwgdGhpcy5tb2RlbC5nZXQoJ3NlbGVjdGVkJykpOwoKICAgICAgICAvLyBub3Qgd2l0aCBidWlsdCBpbiBldmVudHMgPT4gZG9lc24ndCB3b3JrIHdlbGwgb24gdG91Y2ggZGV2aWNlcwogICAgICAgIC8vIHRoaXMgZmFsbHMgYmFjayB0byBtb3VzZSBldmVudHMsIHdoZW4gbm8gdG91Y2ggZXZlbnRzIHN1cHBvcnRlZAogICAgICAgIHRoaXMuJGVsLnN3aXBlKHsKICAgICAgICAgIHRhcDogXy5iaW5kKHRoaXMudG9nZ2xlU2VsZWN0ZWQsIHRoaXMpCiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0sCgogICAgLy8gb3ZlcnJpZGUgQmFja2JvbmUuVmlldyNyZW1vdmUgdG8gcmVtb3ZlIHRoZSB0b3VjaCBldmVudCBsaXN0ZW5lcgogICAgcmVtb3ZlOiBmdW5jdGlvbigpIHsKICAgICAgdGhpcy4kZWwuc3dpcGUoJ2Rlc3Ryb3knKTsKICAgICAgQmFja2JvbmUuVmlldy5wcm90b3R5cGUucmVtb3ZlLmNhbGwodGhpcyk7IC8vIGNhbGwgc3VwZXIoKQogICAgICAvLyBjb3VsZCBhbHNvIGJlIHdyaXR0ZW4gYXM6CiAgICAgIC8vIHRoaXMuY29uc3RydWN0b3IuX19zdXBlcl9fLnJlbW92ZS5jYWxsKHRoaXMpOwogICAgfSwKCiAgICB0b2dnbGVTZWxlY3RlZDogZnVuY3Rpb24oZXZ0KSB7CiAgICAgIGV2dC5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24oKTsKICAgICAgZXZ0LnByZXZlbnREZWZhdWx0KCk7CiAgICAgIHRoaXMubW9kZWwuc2V0KCdzZWxlY3RlZCcsICF0aGlzLm1vZGVsLmdldCgnc2VsZWN0ZWQnKSk7CiAgICB9LAoKICAgIHVwZGF0ZVNlbGVjdGVkOiBmdW5jdGlvbihJbWFnZU1vZGVsLCBzZWxlY3RlZCkgewogICAgICBpZiAoc2VsZWN0ZWQpIHsKICAgICAgICB0aGlzLiRlbC5hZGRDbGFzcygnc2VsZWN0ZWQnKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLiRlbC5yZW1vdmVDbGFzcygnc2VsZWN0ZWQnKTsKICAgICAgfQogICAgfQoKICB9KTsKCiAgcmV0dXJuIFNlbGVjdEJ1dHRvbjsKfSk7CgpkZWZpbmUoJ2dhbGxlcnkvdmlld3MvdGh1bWIudmlldycsWwogICdqcXVlcnknLAogICdqcXVlcnktdG91Y2hzd2lwZScsCiAgJ2JhY2tib25lJywKICAnZ2FsbGVyeS92aWV3cy9zZWxlY3Rpb24vc2VsZWN0LmJ1dHRvbicKXSwKZnVuY3Rpb24oJCwgbm9wZSwgQmFja2JvbmUsIFNlbGVjdEJ1dHRvbikgewogIC8qCiAgICogTW9kZWw6IEltYWdlTW9kZWwKICAgKiBFbGVtZW50OiBUaHVtYiBDb250YWluZXIKICAgKiAjZ2FsbGVyeTogR2FsbGVyeU1vZGVsCiAgICovCiAgdmFyIFRodW1iVmlldyA9IEJhY2tib25lLlZpZXcuZXh0ZW5kKHsKICAgIAogICAgLyoKICAgICAqIG9wdGlvbnMuZ2FsbGVyeSBleHBlY3RlZCEKICAgICAqLwogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMubW9kZWwuc2V0VGh1bWJWaWV3KHRoaXMpOwogICAgICB0aGlzLmdhbGxlcnkgPSB0aGlzLm9wdGlvbnMuZ2FsbGVyeTsKICAgICAgdGhpcy50ZW1wbGF0ZSA9IHRoaXMub3B0aW9ucy50ZW1wbGF0ZTsKCiAgICAgIHRoaXMuZG91YmxlVGFwID0gdGhpcy5nYWxsZXJ5LmdldCgnb3B0cycpWydkb3VibGVfdGFwX3RodW1iJ107CiAgICB9LAoKICAgIC8vIG5lZWQgc3dpcGVUb3VjaCBoZXJlIGZvciB0YXAgc2hpdCB3b3JraW5nIGNvcnJlY3RseQogICAgLy8gZXZlbnRzOiB7CiAgICAvLyAgICdjbGljayc6ICdvcGVuSW5TbGlkZXInCiAgICAvLyB9LAoKICAgIC8vIG92ZXJyaWRlIEJhY2tib25lLlZpZXcjcmVtb3ZlIHRvIHJlbW92ZSB0aGUgdG91Y2ggZXZlbnQgbGlzdGVuZXIKICAgIHJlbW92ZTogZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMuJGVsLnN3aXBlKCdkZXN0cm95Jyk7CiAgICAgIEJhY2tib25lLlZpZXcucHJvdG90eXBlLnJlbW92ZS5jYWxsKHRoaXMpOyAvLyBjYWxsIHN1cGVyKCkKICAgICAgLy8gY291bGQgYWxzbyBiZSB3cml0dGVuIGFzOgogICAgICAvLyB0aGlzLmNvbnN0cnVjdG9yLl9fc3VwZXJfXy5yZW1vdmUuY2FsbCh0aGlzKTsKICAgIH0sCgogICAgLy8gZG91YmxlIHRhcCBmZWF0dXJlLCB3aGVuIHRvdWNoZWQKICAgIGNsaWNrT3JUYXBwZWQ6IGZ1bmN0aW9uKGV2dCkgewogICAgICBpZiAoZXZ0LnR5cGUgPT0gJ3RvdWNoZW5kJyAmJiB0aGlzLmRvdWJsZVRhcCkgewogICAgICAgIHRoaXMuJGVsLmFkZENsYXNzKCdkb3VibGUtdGFwJyk7IC8vIG1hcmsgYXMgZG91YmxlIHRhcCB0b3VjaCBpbnRlcmFjdGlvbiBmb3IgY3NzIHN0eWxpbmcKICAgICAgICBpZiAodGhpcy4kZWxbMF0ucXVlcnlTZWxlY3RvcignOmhvdmVyJykgIT09IG51bGwpIHsKICAgICAgICAgIHRoaXMub3BlbkluU2xpZGVyKCk7IAogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLm9wZW5JblNsaWRlcigpOwogICAgICB9CiAgICB9LAogICAgCiAgICBvcGVuSW5TbGlkZXI6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLmdhbGxlcnkudHJpZ2dlcigndGh1bWI6Y2xpY2tlZCcsIHRoaXMubW9kZWwpOwogICAgfSwKICAgIAogICAgcmVuZGVyOiBmdW5jdGlvbigpIHsKICAgICAgdmFyIGh0bWwgPSB0aGlzLnRlbXBsYXRlKHtpbWc6IHRoaXMubW9kZWx9KS50cmltKCk7CiAgICAgIHRoaXMuc2V0RWxlbWVudCgkLnBhcnNlSFRNTChodG1sKSk7CgogICAgICAvLyBub3Qgd2l0aCBidWlsdCBpbiBldmVudHMgPT4gZG9lc24ndCB3b3JrIHdlbGwgb24gdG91Y2ggZGV2aWNlcwogICAgICAvLyB0aGlzIGZhbGxzIGJhY2sgdG8gbW91c2UgZXZlbnRzLCB3aGVuIG5vIHRvdWNoIGV2ZW50cyBzdXBwb3J0ZWQKICAgICAgdGhpcy4kZWwuc3dpcGUoewogICAgICAgIHRhcDogXy5iaW5kKHRoaXMuY2xpY2tPclRhcHBlZCwgdGhpcykKICAgICAgfSk7CgogICAgICBpZiAoIXRoaXMuc2VsZWN0QnV0dG9uKSB7CiAgICAgICAgdGhpcy5zZWxlY3RCdXR0b24gPSBuZXcgU2VsZWN0QnV0dG9uKHsKICAgICAgICAgIG1vZGVsOiB0aGlzLm1vZGVsLAogICAgICAgICAgZWw6IHRoaXMuJCgnLnNlbGVjdG9yJykKICAgICAgICB9KTsKICAgICAgfQogICAgICByZXR1cm4gdGhpczsKICAgIH0KICAgIAogIH0pOwogIAogIHJldHVybiBUaHVtYlZpZXc7Cn0pOwoKZGVmaW5lKCdnYWxsZXJ5L3ZpZXdzL3RodW1iLmNvbnRhaW5lcicsWwogICdqcXVlcnknLAogICd2ZW5kb3IvanF1ZXJ5LnRocm90dGxlLWRlYm91bmNlJywKICAndW5kZXJzY29yZScsCiAgJ2JhY2tib25lJywKICAnZ2FsbGVyeS92aWV3cy90aHVtYi52aWV3JywKICAnZ2FsbGVyeS91dGlscy9yZXNwb25zaXZlLmFkYXB0ZXInCl0sCmZ1bmN0aW9uKCQsIG5vcGUsIF8sIEJhY2tib25lLCBUaHVtYlZpZXcsIFJlc3BvbnNpdmVBZGFwdGVyKSB7CiAgCiAgLyoKICAgKiBNb2RlbDogR2FsbGVyeU1vZGVsCiAgICoKICAgKiBsaXN0ZW5zIG9uY2UgdG8gJ2NoYW5nZScgb24gR2FsbGVyeU1vZGVsID0+IGluaXQgVGh1bWJzCiAgICoKICAgKiBUaGUgY29uc3RydWN0b3IgbmVlZHMgdGhlIGZvbGxvd2luZyBvcHRpb25zCiAgICogLSBtb2RlbAogICAqIC0gZWwgCiAgICovCiAgdmFyIFRodW1iQ29udGFpbmVyID0gQmFja2JvbmUuVmlldy5leHRlbmQoewogIAogICAgZWw6ICcuY29udGFpbmVyLnBob3RvcycsIC8vIGRlZmF1bHQsIGNhbiBiZSBvdmVycmlkZGVuIHdpdGggY29uc3RydWN0b3IKCiAgICBkZWZhdWx0czogewogICAgICBpdGVtU2VsZWN0b3I6ICcucGhvdG8nCiAgICB9LAogIAogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICAvLyBtZXJnZSBkZWZhdWx0cyBhbmQgb3B0aW9ucwogICAgICB0aGlzLm9wdGlvbnMgPSBfLmV4dGVuZCh7fSwgdGhpcy5kZWZhdWx0cywgdGhpcy5vcHRpb25zKTsKCiAgICAgIC8vIG1hcmsgY29udGFpbmVyIGFzIGxvYWRpbmcKICAgICAgdGhpcy4kZWwuYWRkQ2xhc3MoJ2xvYWRpbmcnKTsKCiAgICAgIC8vIHdhaXQgZm9yIHRoZSBJbWFnZUNvbGxlY3Rpb24gdG8gYmUgZmV0Y2hlZAogICAgICB0aGlzLmxpc3RlblRvKHRoaXMubW9kZWwsICdjaGFuZ2UnLCB0aGlzLmdhbGxlcnlGZXRjaGVkKTsKICAgIH0sCgogICAgZ2FsbGVyeUZldGNoZWQ6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLiRlbC5hZGRDbGFzcygnZmV0Y2hlZCcpOwogICAgICB0aGlzLmluaXRHYWxsZXJ5KCk7CiAgICAgIHRoaXMuaW5pdFRodW1icygpOwogICAgfSwKICAgIAogICAgLy8gbm9vcCAvIGFic3RyYWN0IG1ldGhvZAogICAgaW5pdEdhbGxlcnk6IGZ1bmN0aW9uKCkge30sCgogICAgaW5pdFRodW1iczogZnVuY3Rpb24oKSB7CiAgICAgIC8vIGluaXRpYWxpemUgVGh1bWJWaWV3cyBieSBpdGVyYXRpbmcgb3ZlciBleGlzdGluZyB0aHVtYnMgaW4gdGhpcyBjb250YWluZXIKICAgICAgLy8gYW5kIGNvbm5lY3QgdGhlIFRodW1iVmlld3Mgd2l0aCB0aGVpciByZXNwZWN0aXZlIHRodW1iIERPTSBlbGVtZW50CiAgICAgIHZhciBpbWFnZUNvbGxlY3Rpb24gPSB0aGlzLm1vZGVsLmdldCgnaW1hZ2VzJyk7CiAgICAgIHRoaXMuJCh0aGlzLm9wdGlvbnMuaXRlbVNlbGVjdG9yKS5lYWNoKGZ1bmN0aW9uKCkgewogICAgICAgIHZhciB0aHVtYkNvbnRhaW5lciA9ICQodGhpcyk7CiAgICAgICAgLy8gdGhlIGRpZ2VzdCBoYXMgdG8gYmUgdGhlIGlkIG9mIHRoZSBUaHVtYiBjb250YWluZXIKICAgICAgICB2YXIgaW1hZ2VNb2RlbCA9IGltYWdlQ29sbGVjdGlvbi5nZXQodGh1bWJDb250YWluZXIuYXR0cignaWQnKSk7CiAgICAgICAgbmV3IFRodW1iVmlldyh7CiAgICAgICAgICBtb2RlbDogaW1hZ2VNb2RlbCwKICAgICAgICAgIGVsOiB0aHVtYkNvbnRhaW5lciwKICAgICAgICAgIGdhbGxlcnk6IHRoaXMubW9kZWwKICAgICAgICB9KTsKICAgICAgfSk7CiAgICAgICAgICAgIAogICAgICAvLyBGYWRlIGluIGluaXRpYWxpemVkIHRodW1icy4uLiAoc2VlIGdhbGxlcnkuY3NzIGZvciBkZXRhaWxzKQogICAgICB0aGlzLiRlbC5yZW1vdmVDbGFzcygnbG9hZGluZycpOyAvLyBoaWRlIGxvYWRpbmcgaW5kaWNhdG9yCiAgICAgIHRoaXMuJGVsLmZpbmQodGhpcy5vcHRpb25zLml0ZW1TZWxlY3RvcikuYWRkQ2xhc3MoJ2xvYWRlZCcpOyAvLyBmYWRlIGluIHRodW1icwogICAgfSwKICAgICAgICAgICAgCiAgICAvLyBzY3JvbGwgdG8gdGh1bWJWaWV3CiAgICBzY3JvbGxUb1RodW1iOiBmdW5jdGlvbihpbWFnZU1vZGVsKSB7CiAgICAgIHdpbmRvdy5zZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgIGlmIChpbWFnZU1vZGVsKSB7CiAgICAgICAgICB2YXIgdGh1bWJWaWV3ID0gaW1hZ2VNb2RlbC5nZXRUaHVtYlZpZXcoKTsKICAgICAgICAgIGlmICh0aHVtYlZpZXcpIHsKICAgICAgICAgICAgJCgnaHRtbCwgYm9keScpLmFuaW1hdGUoewogICAgICAgICAgICAgIHNjcm9sbFRvcDogdGh1bWJWaWV3LiRlbC5vZmZzZXQoKS50b3AKICAgICAgICAgICAgfSwgMTAwKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sIDIwMCk7CiAgICB9CiAgICAKICB9KTsKCiAgcmV0dXJuIFRodW1iQ29udGFpbmVyOwp9KTsKCmRlZmluZSgnZ2FsbGVyeS92aWV3cy90aHVtYi5jb250YWluZXIubWFzb25yeScsWwogICdqcXVlcnknLAogICd1bmRlcnNjb3JlJywKICAnYmFja2JvbmUnLAogICdqcXVlcnktYnJpZGdldC9qcXVlcnkuYnJpZGdldCcsCiAgJ2ZsdWlkLW1hc29ucnknLAogICdnYWxsZXJ5L3ZpZXdzL3RodW1iLmNvbnRhaW5lcicsCiAgJ2dhbGxlcnkvdXRpbHMvcmVzcG9uc2l2ZS5hZGFwdGVyJwpdLApmdW5jdGlvbigkLCBfLCBCYWNrYm9uZSwgbm9wZSwgRmx1aWRNYXNvbnJ5LCBUaHVtYkNvbnRhaW5lciwgUmVzcG9uc2l2ZUFkYXB0ZXIpIHsKICAKICAkLmJyaWRnZXQoJ2ZsdWlkTWFzb25yeScsIEZsdWlkTWFzb25yeSk7CgogIC8qCiAgICogTW9kZWw6IEdhbGxlcnlNb2RlbAogICAqCiAgICogbGlzdGVucyBvbmNlIHRvICdjaGFuZ2UnIG9uIEdhbGxlcnlNb2RlbCA9PiBpbml0IFRodW1icwogICAqCiAgICogVGhlIGNvbnN0cnVjdG9yIG5lZWRzIHRoZSBmb2xsb3dpbmcgb3B0aW9ucwogICAqIC0gbW9kZWwKICAgKiAtIGVsIAogICAqLwogIHZhciBUaHVtYkNvbnRhaW5lck1hc29ucnkgPSBUaHVtYkNvbnRhaW5lci5leHRlbmQoewogIAogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICBUaHVtYkNvbnRhaW5lci5wcm90b3R5cGUuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfSwKCiAgICBpbml0R2FsbGVyeTogZnVuY3Rpb24oKSB7CiAgICAgIC8vIGluaXRpYWxpemUgbWFzb25yeSBvbiB0aGUgdGh1bWIgQ29udGFpbmVyCiAgICAgIHRoaXMuaW5pdE1hc29ucnkodGhpcy5tb2RlbC5nZXQoJ29wdHMnKSk7CiAgICB9LAogIAogICAgLyoKICAgICAqIG1pbl9jb2xfd2lkdGg6IHdpZHRoIG9mIGNlbGwgKHRodW1iKSBpbiBtYXNvbnJ5IGxheW91dCAodGh1bWIgY2FuIGdldCB0aWxsIAogICAgICogZG91YmxlIGluIHNpemUsIGRlcGVuZGluZyBvbiBjb250YWluZXItd2lkdGgpCiAgICAgKi8KICAgIGluaXRNYXNvbnJ5OiBmdW5jdGlvbihnYWxsZXJ5T3B0cykgewogICAgICB0aGlzLiRlbC5mbHVpZE1hc29ucnkoewogICAgICAgIGl0ZW1TZWxlY3RvciA6IHRoaXMub3B0aW9ucy5pdGVtU2VsZWN0b3IsCiAgICAgICAgbWluQ29sdW1uV2lkdGg6IFJlc3BvbnNpdmVBZGFwdGVyLmdldE9wdGlvbkJ5TWVkaWFUeXBlKGdhbGxlcnlPcHRzLCAnbWluX2NvbF93aWR0aCcpLAogICAgICAgIGd1dHRlcjogUmVzcG9uc2l2ZUFkYXB0ZXIuZ2V0T3B0aW9uQnlNZWRpYVR5cGUoZ2FsbGVyeU9wdHMsICdndXR0ZXJfd2lkdGgnKSwKICAgICAgICBpc0ZpdFdpZHRoOiBmYWxzZQogICAgICB9KTsKICAgIH0KICAgIAogIH0pOwoKICByZXR1cm4gVGh1bWJDb250YWluZXJNYXNvbnJ5Owp9KTsKCi8qIQogKiBpbWFnZXNMb2FkZWQgdjMuMS44CiAqIEphdmFTY3JpcHQgaXMgYWxsIGxpa2UgIllvdSBpbWFnZXMgYXJlIGRvbmUgeWV0IG9yIHdoYXQ/IgogKiBNSVQgTGljZW5zZQogKi8KCiggZnVuY3Rpb24oIHdpbmRvdywgZmFjdG9yeSApIHsgCiAgLy8gdW5pdmVyc2FsIG1vZHVsZSBkZWZpbml0aW9uCgogIC8qZ2xvYmFsIGRlZmluZTogZmFsc2UsIG1vZHVsZTogZmFsc2UsIHJlcXVpcmU6IGZhbHNlICovCgogIGlmICggdHlwZW9mIGRlZmluZSA9PT0gJ2Z1bmN0aW9uJyAmJiBkZWZpbmUuYW1kICkgewogICAgLy8gQU1ECiAgICBkZWZpbmUoICdpbWFnZXNsb2FkZWQvaW1hZ2VzbG9hZGVkJyxbCiAgICAgICdldmVudEVtaXR0ZXIvRXZlbnRFbWl0dGVyJywKICAgICAgJ2V2ZW50aWUvZXZlbnRpZScKICAgIF0sIGZ1bmN0aW9uKCBFdmVudEVtaXR0ZXIsIGV2ZW50aWUgKSB7CiAgICAgIHJldHVybiBmYWN0b3J5KCB3aW5kb3csIEV2ZW50RW1pdHRlciwgZXZlbnRpZSApOwogICAgfSk7CiAgfSBlbHNlIGlmICggdHlwZW9mIGV4cG9ydHMgPT09ICdvYmplY3QnICkgewogICAgLy8gQ29tbW9uSlMKICAgIG1vZHVsZS5leHBvcnRzID0gZmFjdG9yeSgKICAgICAgd2luZG93LAogICAgICByZXF1aXJlKCd3b2xmeTg3LWV2ZW50ZW1pdHRlcicpLAogICAgICByZXF1aXJlKCdldmVudGllJykKICAgICk7CiAgfSBlbHNlIHsKICAgIC8vIGJyb3dzZXIgZ2xvYmFsCiAgICB3aW5kb3cuaW1hZ2VzTG9hZGVkID0gZmFjdG9yeSgKICAgICAgd2luZG93LAogICAgICB3aW5kb3cuRXZlbnRFbWl0dGVyLAogICAgICB3aW5kb3cuZXZlbnRpZQogICAgKTsKICB9Cgp9KSggd2luZG93LAoKLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gIGZhY3RvcnkgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gLy8KCmZ1bmN0aW9uIGZhY3RvcnkoIHdpbmRvdywgRXZlbnRFbWl0dGVyLCBldmVudGllICkgewoKCgp2YXIgJCA9IHdpbmRvdy5qUXVlcnk7CnZhciBjb25zb2xlID0gd2luZG93LmNvbnNvbGU7CnZhciBoYXNDb25zb2xlID0gdHlwZW9mIGNvbnNvbGUgIT09ICd1bmRlZmluZWQnOwoKLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gaGVscGVycyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSAvLwoKLy8gZXh0ZW5kIG9iamVjdHMKZnVuY3Rpb24gZXh0ZW5kKCBhLCBiICkgewogIGZvciAoIHZhciBwcm9wIGluIGIgKSB7CiAgICBhWyBwcm9wIF0gPSBiWyBwcm9wIF07CiAgfQogIHJldHVybiBhOwp9Cgp2YXIgb2JqVG9TdHJpbmcgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nOwpmdW5jdGlvbiBpc0FycmF5KCBvYmogKSB7CiAgcmV0dXJuIG9ialRvU3RyaW5nLmNhbGwoIG9iaiApID09PSAnW29iamVjdCBBcnJheV0nOwp9CgovLyB0dXJuIGVsZW1lbnQgb3Igbm9kZUxpc3QgaW50byBhbiBhcnJheQpmdW5jdGlvbiBtYWtlQXJyYXkoIG9iaiApIHsKICB2YXIgYXJ5ID0gW107CiAgaWYgKCBpc0FycmF5KCBvYmogKSApIHsKICAgIC8vIHVzZSBvYmplY3QgaWYgYWxyZWFkeSBhbiBhcnJheQogICAgYXJ5ID0gb2JqOwogIH0gZWxzZSBpZiAoIHR5cGVvZiBvYmoubGVuZ3RoID09PSAnbnVtYmVyJyApIHsKICAgIC8vIGNvbnZlcnQgbm9kZUxpc3QgdG8gYXJyYXkKICAgIGZvciAoIHZhciBpPTAsIGxlbiA9IG9iai5sZW5ndGg7IGkgPCBsZW47IGkrKyApIHsKICAgICAgYXJ5LnB1c2goIG9ialtpXSApOwogICAgfQogIH0gZWxzZSB7CiAgICAvLyBhcnJheSBvZiBzaW5nbGUgaW5kZXgKICAgIGFyeS5wdXNoKCBvYmogKTsKICB9CiAgcmV0dXJuIGFyeTsKfQoKICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSBpbWFnZXNMb2FkZWQgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gLy8KCiAgLyoqCiAgICogQHBhcmFtIHtBcnJheSwgRWxlbWVudCwgTm9kZUxpc3QsIFN0cmluZ30gZWxlbQogICAqIEBwYXJhbSB7T2JqZWN0IG9yIEZ1bmN0aW9ufSBvcHRpb25zIC0gaWYgZnVuY3Rpb24sIHVzZSBhcyBjYWxsYmFjawogICAqIEBwYXJhbSB7RnVuY3Rpb259IG9uQWx3YXlzIC0gY2FsbGJhY2sgZnVuY3Rpb24KICAgKi8KICBmdW5jdGlvbiBJbWFnZXNMb2FkZWQoIGVsZW0sIG9wdGlvbnMsIG9uQWx3YXlzICkgewogICAgLy8gY29lcmNlIEltYWdlc0xvYWRlZCgpIHdpdGhvdXQgbmV3LCB0byBiZSBuZXcgSW1hZ2VzTG9hZGVkKCkKICAgIGlmICggISggdGhpcyBpbnN0YW5jZW9mIEltYWdlc0xvYWRlZCApICkgewogICAgICByZXR1cm4gbmV3IEltYWdlc0xvYWRlZCggZWxlbSwgb3B0aW9ucyApOwogICAgfQogICAgLy8gdXNlIGVsZW0gYXMgc2VsZWN0b3Igc3RyaW5nCiAgICBpZiAoIHR5cGVvZiBlbGVtID09PSAnc3RyaW5nJyApIHsKICAgICAgZWxlbSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoIGVsZW0gKTsKICAgIH0KCiAgICB0aGlzLmVsZW1lbnRzID0gbWFrZUFycmF5KCBlbGVtICk7CiAgICB0aGlzLm9wdGlvbnMgPSBleHRlbmQoIHt9LCB0aGlzLm9wdGlvbnMgKTsKCiAgICBpZiAoIHR5cGVvZiBvcHRpb25zID09PSAnZnVuY3Rpb24nICkgewogICAgICBvbkFsd2F5cyA9IG9wdGlvbnM7CiAgICB9IGVsc2UgewogICAgICBleHRlbmQoIHRoaXMub3B0aW9ucywgb3B0aW9ucyApOwogICAgfQoKICAgIGlmICggb25BbHdheXMgKSB7CiAgICAgIHRoaXMub24oICdhbHdheXMnLCBvbkFsd2F5cyApOwogICAgfQoKICAgIHRoaXMuZ2V0SW1hZ2VzKCk7CgogICAgaWYgKCAkICkgewogICAgICAvLyBhZGQgalF1ZXJ5IERlZmVycmVkIG9iamVjdAogICAgICB0aGlzLmpxRGVmZXJyZWQgPSBuZXcgJC5EZWZlcnJlZCgpOwogICAgfQoKICAgIC8vIEhBQ0sgY2hlY2sgYXN5bmMgdG8gYWxsb3cgdGltZSB0byBiaW5kIGxpc3RlbmVycwogICAgdmFyIF90aGlzID0gdGhpczsKICAgIHNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewogICAgICBfdGhpcy5jaGVjaygpOwogICAgfSk7CiAgfQoKICBJbWFnZXNMb2FkZWQucHJvdG90eXBlID0gbmV3IEV2ZW50RW1pdHRlcigpOwoKICBJbWFnZXNMb2FkZWQucHJvdG90eXBlLm9wdGlvbnMgPSB7fTsKCiAgSW1hZ2VzTG9hZGVkLnByb3RvdHlwZS5nZXRJbWFnZXMgPSBmdW5jdGlvbigpIHsKICAgIHRoaXMuaW1hZ2VzID0gW107CgogICAgLy8gZmlsdGVyICYgZmluZCBpdGVtcyBpZiB3ZSBoYXZlIGFuIGl0ZW0gc2VsZWN0b3IKICAgIGZvciAoIHZhciBpPTAsIGxlbiA9IHRoaXMuZWxlbWVudHMubGVuZ3RoOyBpIDwgbGVuOyBpKysgKSB7CiAgICAgIHZhciBlbGVtID0gdGhpcy5lbGVtZW50c1tpXTsKICAgICAgLy8gZmlsdGVyIHNpYmxpbmdzCiAgICAgIGlmICggZWxlbS5ub2RlTmFtZSA9PT0gJ0lNRycgKSB7CiAgICAgICAgdGhpcy5hZGRJbWFnZSggZWxlbSApOwogICAgICB9CiAgICAgIC8vIGZpbmQgY2hpbGRyZW4KICAgICAgLy8gbm8gbm9uLWVsZW1lbnQgbm9kZXMsICMxNDMKICAgICAgdmFyIG5vZGVUeXBlID0gZWxlbS5ub2RlVHlwZTsKICAgICAgaWYgKCAhbm9kZVR5cGUgfHwgISggbm9kZVR5cGUgPT09IDEgfHwgbm9kZVR5cGUgPT09IDkgfHwgbm9kZVR5cGUgPT09IDExICkgKSB7CiAgICAgICAgY29udGludWU7CiAgICAgIH0KICAgICAgdmFyIGNoaWxkRWxlbXMgPSBlbGVtLnF1ZXJ5U2VsZWN0b3JBbGwoJ2ltZycpOwogICAgICAvLyBjb25jYXQgY2hpbGRFbGVtcyB0byBmaWx0ZXJGb3VuZCBhcnJheQogICAgICBmb3IgKCB2YXIgaj0wLCBqTGVuID0gY2hpbGRFbGVtcy5sZW5ndGg7IGogPCBqTGVuOyBqKysgKSB7CiAgICAgICAgdmFyIGltZyA9IGNoaWxkRWxlbXNbal07CiAgICAgICAgdGhpcy5hZGRJbWFnZSggaW1nICk7CiAgICAgIH0KICAgIH0KICB9OwoKICAvKioKICAgKiBAcGFyYW0ge0ltYWdlfSBpbWcKICAgKi8KICBJbWFnZXNMb2FkZWQucHJvdG90eXBlLmFkZEltYWdlID0gZnVuY3Rpb24oIGltZyApIHsKICAgIHZhciBsb2FkaW5nSW1hZ2UgPSBuZXcgTG9hZGluZ0ltYWdlKCBpbWcgKTsKICAgIHRoaXMuaW1hZ2VzLnB1c2goIGxvYWRpbmdJbWFnZSApOwogIH07CgogIEltYWdlc0xvYWRlZC5wcm90b3R5cGUuY2hlY2sgPSBmdW5jdGlvbigpIHsKICAgIHZhciBfdGhpcyA9IHRoaXM7CiAgICB2YXIgY2hlY2tlZENvdW50ID0gMDsKICAgIHZhciBsZW5ndGggPSB0aGlzLmltYWdlcy5sZW5ndGg7CiAgICB0aGlzLmhhc0FueUJyb2tlbiA9IGZhbHNlOwogICAgLy8gY29tcGxldGUgaWYgbm8gaW1hZ2VzCiAgICBpZiAoICFsZW5ndGggKSB7CiAgICAgIHRoaXMuY29tcGxldGUoKTsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIGZ1bmN0aW9uIG9uQ29uZmlybSggaW1hZ2UsIG1lc3NhZ2UgKSB7CiAgICAgIGlmICggX3RoaXMub3B0aW9ucy5kZWJ1ZyAmJiBoYXNDb25zb2xlICkgewogICAgICAgIGNvbnNvbGUubG9nKCAnY29uZmlybScsIGltYWdlLCBtZXNzYWdlICk7CiAgICAgIH0KCiAgICAgIF90aGlzLnByb2dyZXNzKCBpbWFnZSApOwogICAgICBjaGVja2VkQ291bnQrKzsKICAgICAgaWYgKCBjaGVja2VkQ291bnQgPT09IGxlbmd0aCApIHsKICAgICAgICBfdGhpcy5jb21wbGV0ZSgpOwogICAgICB9CiAgICAgIHJldHVybiB0cnVlOyAvLyBiaW5kIG9uY2UKICAgIH0KCiAgICBmb3IgKCB2YXIgaT0wOyBpIDwgbGVuZ3RoOyBpKysgKSB7CiAgICAgIHZhciBsb2FkaW5nSW1hZ2UgPSB0aGlzLmltYWdlc1tpXTsKICAgICAgbG9hZGluZ0ltYWdlLm9uKCAnY29uZmlybScsIG9uQ29uZmlybSApOwogICAgICBsb2FkaW5nSW1hZ2UuY2hlY2soKTsKICAgIH0KICB9OwoKICBJbWFnZXNMb2FkZWQucHJvdG90eXBlLnByb2dyZXNzID0gZnVuY3Rpb24oIGltYWdlICkgewogICAgdGhpcy5oYXNBbnlCcm9rZW4gPSB0aGlzLmhhc0FueUJyb2tlbiB8fCAhaW1hZ2UuaXNMb2FkZWQ7CiAgICAvLyBIQUNLIC0gQ2hyb21lIHRyaWdnZXJzIGV2ZW50IGJlZm9yZSBvYmplY3QgcHJvcGVydGllcyBoYXZlIGNoYW5nZWQuICM4MwogICAgdmFyIF90aGlzID0gdGhpczsKICAgIHNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewogICAgICBfdGhpcy5lbWl0KCAncHJvZ3Jlc3MnLCBfdGhpcywgaW1hZ2UgKTsKICAgICAgaWYgKCBfdGhpcy5qcURlZmVycmVkICYmIF90aGlzLmpxRGVmZXJyZWQubm90aWZ5ICkgewogICAgICAgIF90aGlzLmpxRGVmZXJyZWQubm90aWZ5KCBfdGhpcywgaW1hZ2UgKTsKICAgICAgfQogICAgfSk7CiAgfTsKCiAgSW1hZ2VzTG9hZGVkLnByb3RvdHlwZS5jb21wbGV0ZSA9IGZ1bmN0aW9uKCkgewogICAgdmFyIGV2ZW50TmFtZSA9IHRoaXMuaGFzQW55QnJva2VuID8gJ2ZhaWwnIDogJ2RvbmUnOwogICAgdGhpcy5pc0NvbXBsZXRlID0gdHJ1ZTsKICAgIHZhciBfdGhpcyA9IHRoaXM7CiAgICAvLyBIQUNLIC0gYW5vdGhlciBzZXRUaW1lb3V0IHNvIHRoYXQgY29uZmlybSBoYXBwZW5zIGFmdGVyIHByb2dyZXNzCiAgICBzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKICAgICAgX3RoaXMuZW1pdCggZXZlbnROYW1lLCBfdGhpcyApOwogICAgICBfdGhpcy5lbWl0KCAnYWx3YXlzJywgX3RoaXMgKTsKICAgICAgaWYgKCBfdGhpcy5qcURlZmVycmVkICkgewogICAgICAgIHZhciBqcU1ldGhvZCA9IF90aGlzLmhhc0FueUJyb2tlbiA/ICdyZWplY3QnIDogJ3Jlc29sdmUnOwogICAgICAgIF90aGlzLmpxRGVmZXJyZWRbIGpxTWV0aG9kIF0oIF90aGlzICk7CiAgICAgIH0KICAgIH0pOwogIH07CgogIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tIGpxdWVyeSAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSAvLwoKICBpZiAoICQgKSB7CiAgICAkLmZuLmltYWdlc0xvYWRlZCA9IGZ1bmN0aW9uKCBvcHRpb25zLCBjYWxsYmFjayApIHsKICAgICAgdmFyIGluc3RhbmNlID0gbmV3IEltYWdlc0xvYWRlZCggdGhpcywgb3B0aW9ucywgY2FsbGJhY2sgKTsKICAgICAgcmV0dXJuIGluc3RhbmNlLmpxRGVmZXJyZWQucHJvbWlzZSggJCh0aGlzKSApOwogICAgfTsKICB9CgoKICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSAgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gLy8KCiAgZnVuY3Rpb24gTG9hZGluZ0ltYWdlKCBpbWcgKSB7CiAgICB0aGlzLmltZyA9IGltZzsKICB9CgogIExvYWRpbmdJbWFnZS5wcm90b3R5cGUgPSBuZXcgRXZlbnRFbWl0dGVyKCk7CgogIExvYWRpbmdJbWFnZS5wcm90b3R5cGUuY2hlY2sgPSBmdW5jdGlvbigpIHsKICAgIC8vIGZpcnN0IGNoZWNrIGNhY2hlZCBhbnkgcHJldmlvdXMgaW1hZ2VzIHRoYXQgaGF2ZSBzYW1lIHNyYwogICAgdmFyIHJlc291cmNlID0gY2FjaGVbIHRoaXMuaW1nLnNyYyBdIHx8IG5ldyBSZXNvdXJjZSggdGhpcy5pbWcuc3JjICk7CiAgICBpZiAoIHJlc291cmNlLmlzQ29uZmlybWVkICkgewogICAgICB0aGlzLmNvbmZpcm0oIHJlc291cmNlLmlzTG9hZGVkLCAnY2FjaGVkIHdhcyBjb25maXJtZWQnICk7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICAvLyBJZiBjb21wbGV0ZSBpcyB0cnVlIGFuZCBicm93c2VyIHN1cHBvcnRzIG5hdHVyYWwgc2l6ZXMsCiAgICAvLyB0cnkgdG8gY2hlY2sgZm9yIGltYWdlIHN0YXR1cyBtYW51YWxseS4KICAgIGlmICggdGhpcy5pbWcuY29tcGxldGUgJiYgdGhpcy5pbWcubmF0dXJhbFdpZHRoICE9PSB1bmRlZmluZWQgKSB7CiAgICAgIC8vIHJlcG9ydCBiYXNlZCBvbiBuYXR1cmFsV2lkdGgKICAgICAgdGhpcy5jb25maXJtKCB0aGlzLmltZy5uYXR1cmFsV2lkdGggIT09IDAsICduYXR1cmFsV2lkdGgnICk7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICAvLyBJZiBub25lIG9mIHRoZSBjaGVja3MgYWJvdmUgbWF0Y2hlZCwgc2ltdWxhdGUgbG9hZGluZyBvbiBkZXRhY2hlZCBlbGVtZW50LgogICAgdmFyIF90aGlzID0gdGhpczsKICAgIHJlc291cmNlLm9uKCAnY29uZmlybScsIGZ1bmN0aW9uKCByZXNyYywgbWVzc2FnZSApIHsKICAgICAgX3RoaXMuY29uZmlybSggcmVzcmMuaXNMb2FkZWQsIG1lc3NhZ2UgKTsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9KTsKCiAgICByZXNvdXJjZS5jaGVjaygpOwogIH07CgogIExvYWRpbmdJbWFnZS5wcm90b3R5cGUuY29uZmlybSA9IGZ1bmN0aW9uKCBpc0xvYWRlZCwgbWVzc2FnZSApIHsKICAgIHRoaXMuaXNMb2FkZWQgPSBpc0xvYWRlZDsKICAgIHRoaXMuZW1pdCggJ2NvbmZpcm0nLCB0aGlzLCBtZXNzYWdlICk7CiAgfTsKCiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gUmVzb3VyY2UgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gLy8KCiAgLy8gUmVzb3VyY2UgY2hlY2tzIGVhY2ggc3JjLCBvbmx5IG9uY2UKICAvLyBzZXBhcmF0ZSBjbGFzcyBmcm9tIExvYWRpbmdJbWFnZSB0byBwcmV2ZW50IG1lbW9yeSBsZWFrcy4gU2VlICMxMTUKCiAgdmFyIGNhY2hlID0ge307CgogIGZ1bmN0aW9uIFJlc291cmNlKCBzcmMgKSB7CiAgICB0aGlzLnNyYyA9IHNyYzsKICAgIC8vIGFkZCB0byBjYWNoZQogICAgY2FjaGVbIHNyYyBdID0gdGhpczsKICB9CgogIFJlc291cmNlLnByb3RvdHlwZSA9IG5ldyBFdmVudEVtaXR0ZXIoKTsKCiAgUmVzb3VyY2UucHJvdG90eXBlLmNoZWNrID0gZnVuY3Rpb24oKSB7CiAgICAvLyBvbmx5IHRyaWdnZXIgY2hlY2tpbmcgb25jZQogICAgaWYgKCB0aGlzLmlzQ2hlY2tlZCApIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgLy8gc2ltdWxhdGUgbG9hZGluZyBvbiBkZXRhY2hlZCBlbGVtZW50CiAgICB2YXIgcHJveHlJbWFnZSA9IG5ldyBJbWFnZSgpOwogICAgZXZlbnRpZS5iaW5kKCBwcm94eUltYWdlLCAnbG9hZCcsIHRoaXMgKTsKICAgIGV2ZW50aWUuYmluZCggcHJveHlJbWFnZSwgJ2Vycm9yJywgdGhpcyApOwogICAgcHJveHlJbWFnZS5zcmMgPSB0aGlzLnNyYzsKICAgIC8vIHNldCBmbGFnCiAgICB0aGlzLmlzQ2hlY2tlZCA9IHRydWU7CiAgfTsKCiAgLy8gLS0tLS0gZXZlbnRzIC0tLS0tIC8vCgogIC8vIHRyaWdnZXIgc3BlY2lmaWVkIGhhbmRsZXIgZm9yIGV2ZW50IHR5cGUKICBSZXNvdXJjZS5wcm90b3R5cGUuaGFuZGxlRXZlbnQgPSBmdW5jdGlvbiggZXZlbnQgKSB7CiAgICB2YXIgbWV0aG9kID0gJ29uJyArIGV2ZW50LnR5cGU7CiAgICBpZiAoIHRoaXNbIG1ldGhvZCBdICkgewogICAgICB0aGlzWyBtZXRob2QgXSggZXZlbnQgKTsKICAgIH0KICB9OwoKICBSZXNvdXJjZS5wcm90b3R5cGUub25sb2FkID0gZnVuY3Rpb24oIGV2ZW50ICkgewogICAgdGhpcy5jb25maXJtKCB0cnVlLCAnb25sb2FkJyApOwogICAgdGhpcy51bmJpbmRQcm94eUV2ZW50cyggZXZlbnQgKTsKICB9OwoKICBSZXNvdXJjZS5wcm90b3R5cGUub25lcnJvciA9IGZ1bmN0aW9uKCBldmVudCApIHsKICAgIHRoaXMuY29uZmlybSggZmFsc2UsICdvbmVycm9yJyApOwogICAgdGhpcy51bmJpbmRQcm94eUV2ZW50cyggZXZlbnQgKTsKICB9OwoKICAvLyAtLS0tLSBjb25maXJtIC0tLS0tIC8vCgogIFJlc291cmNlLnByb3RvdHlwZS5jb25maXJtID0gZnVuY3Rpb24oIGlzTG9hZGVkLCBtZXNzYWdlICkgewogICAgdGhpcy5pc0NvbmZpcm1lZCA9IHRydWU7CiAgICB0aGlzLmlzTG9hZGVkID0gaXNMb2FkZWQ7CiAgICB0aGlzLmVtaXQoICdjb25maXJtJywgdGhpcywgbWVzc2FnZSApOwogIH07CgogIFJlc291cmNlLnByb3RvdHlwZS51bmJpbmRQcm94eUV2ZW50cyA9IGZ1bmN0aW9uKCBldmVudCApIHsKICAgIGV2ZW50aWUudW5iaW5kKCBldmVudC50YXJnZXQsICdsb2FkJywgdGhpcyApOwogICAgZXZlbnRpZS51bmJpbmQoIGV2ZW50LnRhcmdldCwgJ2Vycm9yJywgdGhpcyApOwogIH07CgogIC8vIC0tLS0tICAtLS0tLSAvLwoKICByZXR1cm4gSW1hZ2VzTG9hZGVkOwoKfSk7CgovKiBqc2hpbnQgY2FtZWxjYXNlOiBmYWxzZSAqLwovKioKICogYXV0aG9yIENocmlzdG9waGVyIEJsdW0KICogICAgLSBvcmlnaW5hbGx5IGZyb20gaHR0cHM6Ly9naXRodWIuY29tL3Byb3RvbmV0L2pxdWVyeS5pbnZpZXcKICogICAgLSBiYXNlZCBvbiB0aGUgaWRlYSBvZiBSZW15IFNoYXJwLCBodHRwOi8vcmVteXNoYXJwLmNvbS8yMDA5LzAxLzI2L2VsZW1lbnQtaW4tdmlldy1ldmVudC1wbHVnaW4vCiAqICAgIC0gZm9ya2VkIGZyb20gaHR0cDovL2dpdGh1Yi5jb20venVrL2pxdWVyeS5pbnZpZXcvCiAqIAogKiBtb2RpZmllZCBieSBwYXRjaGVrb2hvc3MKICogLSB0byB0cmlnZ2VyIG9ubHkgb24gZXZlbnRzIChzY3JvbGwgJiByZXNpemUpCiAqIC0gdG8gdXNlIHJlcXVpcmVqcyBhbmQgdGhyb3R0bGUtZGVib3VuY2UKICovCmRlZmluZSgnbGliL2pxdWVyeS5pbnZpZXcnLFsKICAnanF1ZXJ5JywKICAndmVuZG9yL2pxdWVyeS50aHJvdHRsZS1kZWJvdW5jZScKXSwgZnVuY3Rpb24oJCwgbm9wZSkgewogIAogIHZhciBkZWJ1ZyA9IGZhbHNlOwogIAogIHZhciBpbnZpZXdPYmplY3RzID0ge30sIHZpZXdwb3J0U2l6ZSwgdmlld3BvcnRPZmZzZXQsCiAgICAgIGQgPSBkb2N1bWVudCwgdyA9IHdpbmRvdywgZG9jdW1lbnRFbGVtZW50ID0gZC5kb2N1bWVudEVsZW1lbnQsIGV4cGFuZG8gPSAkLmV4cGFuZG87CgogICQuZXZlbnQuc3BlY2lhbC5pbnZpZXcgPSB7CiAgICBhZGQ6IGZ1bmN0aW9uKGRhdGEpIHsKICAgICAgaW52aWV3T2JqZWN0c1tkYXRhLmd1aWQgKyAnLScgKyB0aGlzW2V4cGFuZG9dXSA9IHsgZGF0YTogZGF0YSwgJGVsZW1lbnQ6ICQodGhpcykgfTsKICAgICAgYmluZFRvVmlld1BvcnRDaGFuZ2VFdmVudHMoKTsKICAgIH0sCgogICAgcmVtb3ZlOiBmdW5jdGlvbihkYXRhKSB7CiAgICAgIHVuYmluZFRvVmlld1BvcnRDaGFuZ2VFdmVudHMoKTsKICAgICAgdHJ5IHsgZGVsZXRlIGludmlld09iamVjdHNbZGF0YS5ndWlkICsgJy0nICsgdGhpc1tleHBhbmRvXV07IH0gY2F0Y2goZSkge30KICAgIH0KICB9OwoKICBmdW5jdGlvbiBnZXRWaWV3cG9ydFNpemUoKSB7CiAgICB2YXIgbW9kZSwgZG9tT2JqZWN0LCBzaXplID0geyBoZWlnaHQ6IHcuaW5uZXJIZWlnaHQsIHdpZHRoOiB3LmlubmVyV2lkdGggfTsKCiAgICAvLyBpZiB0aGlzIGlzIGNvcnJlY3QgdGhlbiByZXR1cm4gaXQuIGlQYWQgaGFzIGNvbXBhdCBNb2RlLCBzbyB3aWxsCiAgICAvLyBnbyBpbnRvIGNoZWNrIGNsaWVudEhlaWdodC9jbGllbnRXaWR0aCAod2hpY2ggaGFzIHRoZSB3cm9uZyB2YWx1ZSkuCiAgICBpZiAoIXNpemUuaGVpZ2h0KSB7CiAgICAgIG1vZGUgPSBkLmNvbXBhdE1vZGU7CiAgICAgIGlmIChtb2RlIHx8ICEkLnN1cHBvcnQuYm94TW9kZWwpIHsgLy8gSUUsIEdlY2tvCiAgICAgICAgZG9tT2JqZWN0ID0gbW9kZSA9PT0gJ0NTUzFDb21wYXQnID8KICAgICAgICAgIGRvY3VtZW50RWxlbWVudCA6IC8vIFN0YW5kYXJkcwogICAgICAgICAgZC5ib2R5OyAvLyBRdWlya3MKICAgICAgICBzaXplID0gewogICAgICAgICAgaGVpZ2h0OiBkb21PYmplY3QuY2xpZW50SGVpZ2h0LAogICAgICAgICAgd2lkdGg6ICBkb21PYmplY3QuY2xpZW50V2lkdGgKICAgICAgICB9OwogICAgICB9CiAgICB9CiAgICByZXR1cm4gc2l6ZTsKICB9CgogIGZ1bmN0aW9uIGdldFZpZXdwb3J0T2Zmc2V0KCkgewogICAgcmV0dXJuIHsKICAgICAgdG9wOiAgdy5wYWdlWU9mZnNldCB8fCBkb2N1bWVudEVsZW1lbnQuc2Nyb2xsVG9wICAgfHwgZC5ib2R5LnNjcm9sbFRvcCwKICAgICAgbGVmdDogdy5wYWdlWE9mZnNldCB8fCBkb2N1bWVudEVsZW1lbnQuc2Nyb2xsTGVmdCAgfHwgZC5ib2R5LnNjcm9sbExlZnQKICAgIH07CiAgfQoKICBmdW5jdGlvbiBjaGVja0luVmlldygpIHsKICAgIHZhciAkZWxlbWVudHMgPSAkKCksIGVsZW1lbnRzTGVuZ3RoLCBpID0gMDsKCiAgICAkLmVhY2goaW52aWV3T2JqZWN0cywgZnVuY3Rpb24oaSwgaW52aWV3T2JqZWN0KSB7CiAgICAgIHZhciBzZWxlY3RvciAgPSBpbnZpZXdPYmplY3QuZGF0YS5zZWxlY3RvciwKICAgICAgICAgICRlbGVtZW50ICA9IGludmlld09iamVjdC4kZWxlbWVudDsKICAgICAgJGVsZW1lbnQgPSBzZWxlY3RvciA/ICRlbGVtZW50LmZpbmQoc2VsZWN0b3IpIDogJGVsZW1lbnQ7CiAgICAgICRlbGVtZW50LmRhdGEoJ2ludmlld19vcHRzJywgaW52aWV3T2JqZWN0LmRhdGEuZGF0YSk7CiAgICAgICRlbGVtZW50cyA9ICRlbGVtZW50cy5hZGQoJGVsZW1lbnQpOwogICAgfSk7CgogICAgZWxlbWVudHNMZW5ndGggPSAkZWxlbWVudHMubGVuZ3RoOwogICAgCiAgICBpZiAoZGVidWcpIHsKICAgICAgY29uc29sZS5sb2coJ2ludmlld09iamVjdHM6ICcpOwogICAgICBjb25zb2xlLmxvZyhpbnZpZXdPYmplY3RzKTsKICAgICAgY29uc29sZS5sb2coJ2VsZW1lbnRzTGVuZ3RoOiAnICsgZWxlbWVudHNMZW5ndGgpOwogICAgfQogICAgCiAgICBpZiAoZWxlbWVudHNMZW5ndGgpIHsKICAgICAgdmlld3BvcnRTaXplICAgPSB2aWV3cG9ydFNpemUgICB8fCBnZXRWaWV3cG9ydFNpemUoKTsKICAgICAgdmlld3BvcnRPZmZzZXQgPSB2aWV3cG9ydE9mZnNldCB8fCBnZXRWaWV3cG9ydE9mZnNldCgpOwogICAgICAKICAgICAgaWYgKGRlYnVnKSB7CiAgICAgICAgY29uc29sZS5sb2coJ3ZpZXdwb3J0U2l6ZTogJyk7CiAgICAgICAgY29uc29sZS5sb2codmlld3BvcnRTaXplKTsKICAgICAgICBjb25zb2xlLmxvZygndmlld3BvcnRPZmZzZXQ6ICcpOwogICAgICAgIGNvbnNvbGUubG9nKHZpZXdwb3J0T2Zmc2V0KTsKICAgICAgfQoKICAgICAgZm9yICg7IGk8ZWxlbWVudHNMZW5ndGg7IGkrKykgewogICAgICAgIC8vIElnbm9yZSBlbGVtZW50cyB0aGF0IGFyZSBub3QgaW4gdGhlIERPTSB0cmVlCiAgICAgICAgaWYgKCEkLmNvbnRhaW5zKGRvY3VtZW50RWxlbWVudCwgJGVsZW1lbnRzW2ldKSkgewogICAgICAgICAgY29udGludWU7CiAgICAgICAgfQoKICAgICAgICB2YXIgJGVsZW1lbnQgICAgICA9ICQoJGVsZW1lbnRzW2ldKSwKICAgICAgICAgICAgZWxlbWVudFNpemUgICA9IHsgaGVpZ2h0OiAkZWxlbWVudC5oZWlnaHQoKSwgd2lkdGg6ICRlbGVtZW50LndpZHRoKCkgfSwKICAgICAgICAgICAgZWxlbWVudE9mZnNldCA9ICRlbGVtZW50Lm9mZnNldCgpLAogICAgICAgICAgICBpblZpZXcgICAgICAgID0gJGVsZW1lbnQuZGF0YSgnaW52aWV3JyksCiAgICAgICAgICAgIHRocmVzaG9sZCAgICAgPSAkZWxlbWVudC5kYXRhKCdpbnZpZXdfb3B0cycpLnRocmVzaG9sZCwKICAgICAgICAgICAgdmlzaWJsZVBhcnRYLAogICAgICAgICAgICB2aXNpYmxlUGFydFksCiAgICAgICAgICAgIHZpc2libGVQYXJ0c01lcmdlZDsKCiAgICAgICAgaWYgKHRocmVzaG9sZCkgewogICAgICAgICAgaWYgKHRoaXMuZGVidWcpIHtjb25zb2xlLmxvZygnVGhyZXNob2xkOiAnICsgdGhyZXNob2xkKTt9CiAgICAgICAgICB2YXIgb3JpZ190b3AgPSBlbGVtZW50T2Zmc2V0LnRvcCwKICAgICAgICAgICAgICBvcmlnX2xlZnQgPSBlbGVtZW50T2Zmc2V0LmxlZnQ7CiAgICAgICAgICBlbGVtZW50T2Zmc2V0ID0gewogICAgICAgICAgICB0b3A6IG9yaWdfdG9wIC0gdGhyZXNob2xkLAogICAgICAgICAgICBsZWZ0OiBvcmlnX2xlZnQgLSB0aHJlc2hvbGQKICAgICAgICAgIH07CiAgICAgICAgfQoKICAgICAgICBpZiAoZGVidWcpIHsKICAgICAgICAgIGNvbnNvbGUubG9nKCdlbGVtZW50U2l6ZTogJyk7CiAgICAgICAgICBjb25zb2xlLmxvZyhlbGVtZW50U2l6ZSk7CiAgICAgICAgICBjb25zb2xlLmxvZygnZWxlbWVudE9mZnNldDogJyk7CiAgICAgICAgICBjb25zb2xlLmxvZyhlbGVtZW50T2Zmc2V0KTsKICAgICAgICB9CgogICAgICAgIC8vIERvbid0IGFzayBtZSB3aHkgYmVjYXVzZSBJIGhhdmVuJ3QgZmlndXJlZCBvdXQgeWV0OgogICAgICAgIC8vIHZpZXdwb3J0T2Zmc2V0IGFuZCB2aWV3cG9ydFNpemUgYXJlIHNvbWV0aW1lcyBzdWRkZW5seSBudWxsIGluIEZpcmVmb3ggNS4KICAgICAgICAvLyBFdmVuIHRob3VnaCBpdCBzb3VuZHMgd2VpcmQ6CiAgICAgICAgLy8gSXQgc2VlbXMgdGhhdCB0aGUgZXhlY3V0aW9uIG9mIHRoaXMgZnVuY3Rpb24gaXMgaW50ZXJmZXJyZWQgYnkgdGhlIG9ucmVzaXplL29uc2Nyb2xsIGV2ZW50CiAgICAgICAgLy8gd2hlcmUgdmlld3BvcnRPZmZzZXQgYW5kIHZpZXdwb3J0U2l6ZSBhcmUgdW5zZXQKICAgICAgICBpZiAoIXZpZXdwb3J0T2Zmc2V0IHx8ICF2aWV3cG9ydFNpemUpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIC8vIEhtbW0sIHRoYXQgd29ya3MgYmV0dGVyLCBFbGVtZW50IGRvZXNuJ3QgaGF2ZSB0byBiZSBjb21wbGV0ZWx5IGluIHZpZXdwb3J0LgogICAgICAgIC8vIGlmIChlbGVtZW50T2Zmc2V0LnRvcCArIGVsZW1lbnRTaXplLmhlaWdodCA+IHZpZXdwb3J0T2Zmc2V0LnRvcCAmJgogICAgICAgIC8vICAgICBlbGVtZW50T2Zmc2V0LnRvcCA8IHZpZXdwb3J0T2Zmc2V0LnRvcCArIHZpZXdwb3J0U2l6ZS5oZWlnaHQgJiYKICAgICAgICAvLyAgICAgZWxlbWVudE9mZnNldC5sZWZ0ICsgZWxlbWVudFNpemUud2lkdGggPiB2aWV3cG9ydE9mZnNldC5sZWZ0ICYmCiAgICAgICAgLy8gICAgIGVsZW1lbnRPZmZzZXQubGVmdCA8IHZpZXdwb3J0T2Zmc2V0LmxlZnQgKyB2aWV3cG9ydFNpemUud2lkdGgpIHsKICAgICAgICBpZiAoZWxlbWVudE9mZnNldC50b3AgPCB2aWV3cG9ydE9mZnNldC50b3AgKyB2aWV3cG9ydFNpemUuaGVpZ2h0ICYmCiAgICAgICAgICAgIGVsZW1lbnRPZmZzZXQubGVmdCA8IHZpZXdwb3J0T2Zmc2V0LmxlZnQgKyB2aWV3cG9ydFNpemUud2lkdGgpIHsKICAgICAgICAgIHZpc2libGVQYXJ0WCA9ICh2aWV3cG9ydE9mZnNldC5sZWZ0ID4gZWxlbWVudE9mZnNldC5sZWZ0ID8KICAgICAgICAgICAgJ3JpZ2h0JyA6ICh2aWV3cG9ydE9mZnNldC5sZWZ0ICsgdmlld3BvcnRTaXplLndpZHRoKSA8IChlbGVtZW50T2Zmc2V0LmxlZnQgKyBlbGVtZW50U2l6ZS53aWR0aCkgPwogICAgICAgICAgICAnbGVmdCcgOiAnYm90aCcpOwogICAgICAgICAgdmlzaWJsZVBhcnRZID0gKHZpZXdwb3J0T2Zmc2V0LnRvcCA+IGVsZW1lbnRPZmZzZXQudG9wID8KICAgICAgICAgICAgJ2JvdHRvbScgOiAodmlld3BvcnRPZmZzZXQudG9wICsgdmlld3BvcnRTaXplLmhlaWdodCkgPCAoZWxlbWVudE9mZnNldC50b3AgKyBlbGVtZW50U2l6ZS5oZWlnaHQpID8KICAgICAgICAgICAgJ3RvcCcgOiAnYm90aCcpOwogICAgICAgICAgdmlzaWJsZVBhcnRzTWVyZ2VkID0gdmlzaWJsZVBhcnRYICsgJy0nICsgdmlzaWJsZVBhcnRZOwogICAgICAgICAgLy8gdW5jb21tZW50IGlmIHlvdSB3YW50IHRvIHRyaWdnZXIgb25seSBpZiB0aGUgY3VycmVudCBjaGVjayByZXN1bHQgZGlmZmVycyBmcm9tIHRlaCBsYXN0IG9uZQogICAgICAgICAgLy8gaWYgKCFpblZpZXcgfHwgaW5WaWV3ICE9PSB2aXNpYmxlUGFydHNNZXJnZWQpIHsKICAgICAgICAgICRlbGVtZW50LmRhdGEoJ2ludmlldycsIHZpc2libGVQYXJ0c01lcmdlZCkudHJpZ2dlcignaW52aWV3JywgW3RydWUsIHZpc2libGVQYXJ0WCwgdmlzaWJsZVBhcnRZXSk7CiAgICAgICAgICAvLyB9CiAgICAgICAgfSBlbHNlIGlmIChpblZpZXcpIHsKICAgICAgICAgICRlbGVtZW50LmRhdGEoJ2ludmlldycsIGZhbHNlKS50cmlnZ2VyKCdpbnZpZXcnLCBbZmFsc2VdKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9CgogIGZ1bmN0aW9uIGJpbmRUb1ZpZXdQb3J0Q2hhbmdlRXZlbnRzKCkgewogICAgJCh3KS5iaW5kKCdzY3JvbGwuaW52aWV3IHJlc2l6ZS5pbnZpZXcnLCAkLnRocm90dGxlKDI1MCwgZnVuY3Rpb24oKSB7CiAgICAgIGlmIChkZWJ1ZykgewogICAgICAgIGNvbnNvbGUubG9nKCdIZWxsbyBpbnZpZXcuanMgY2hlY2tzIGl0IG91dCEnKTsKICAgICAgfQogICAgICB2aWV3cG9ydFNpemUgPSB2aWV3cG9ydE9mZnNldCA9IG51bGw7CiAgICAgIGNoZWNrSW5WaWV3KCk7CiAgICB9KSk7CgogICAgLy8gSUUgPCA5IHNjcm9sbHMgdG8gZm9jdXNlZCBlbGVtZW50cyB3aXRob3V0IGZpcmluZyB0aGUgJ3Njcm9sbCcgZXZlbnQKICAgIC8vIHVuY29tbWVudCwgaWYgeW91IHdhbnQgc3BlY2lhbCB0cmVhdG1lbnQgb2YgSUUgPCA5CiAgICAvLyBpZiAoIWRvY3VtZW50RWxlbWVudC5hZGRFdmVudExpc3RlbmVyICYmIGRvY3VtZW50RWxlbWVudC5hdHRhY2hFdmVudCkgewogICAgLy8gICBkb2N1bWVudEVsZW1lbnQuYXR0YWNoRXZlbnQoJ29uZm9jdXNpbicsIGZ1bmN0aW9uKCkgewogICAgLy8gICAgIHZpZXdwb3J0T2Zmc2V0ID0gbnVsbDsKICAgIC8vICAgfSk7CiAgICAvLyB9CiAgfQogIAogIGZ1bmN0aW9uIHVuYmluZFRvVmlld1BvcnRDaGFuZ2VFdmVudHMoKSB7CiAgICAkKHcpLnVuYmluZCgnc2Nyb2xsLmludmlldyByZXNpemUuaW52aWV3Jyk7CiAgfQoKICAvLyBVc2Ugc2V0SW50ZXJ2YWwgaW4gb3JkZXIgdG8gYWxzbyBtYWtlIHN1cmUgdGhpcyBjYXB0dXJlcyBlbGVtZW50cyB3aXRoaW4KICAvLyAnb3ZlcmZsb3c6c2Nyb2xsJyBlbGVtZW50cyBvciBlbGVtZW50cyB0aGF0IGFwcGVhcmVkIGluIHRoZSBkb20gdHJlZSBkdWUgdG8KICAvLyBkb20gbWFuaXB1bGF0aW9uIGFuZCByZWZsb3cKICAvLyBvbGQ6ICQod2luZG93KS5zY3JvbGwoY2hlY2tJblZpZXcpOwogIC8vCiAgLy8gQnkgdGhlIHdheSwgaU9TIChpUGFkLCBpUGhvbmUsIC4uLikgc2VlbXMgdG8gbm90IGV4ZWN1dGUsIG9yIGF0IGxlYXN0IGRlbGF5cwogIC8vIGludGVydmFscyB3aGlsZSB0aGUgdXNlciBzY3JvbGxzLiBUaGVyZWZvcmUgdGhlIGludmlldyBldmVudCBtaWdodCBmaXJlIGEgYml0IGxhdGUgdGhlcmUKICAvLyBzZXRJbnRlcnZhbChjaGVja0luVmlldywgMjUwKTsKICAKfSk7CgpkZWZpbmUoJ2dhbGxlcnkvdmlld3MvdGh1bWIuY29udGFpbmVyLmR5bmFtaWMnLFsKICAnanF1ZXJ5JywKICAnaW1hZ2VzbG9hZGVkL2ltYWdlc2xvYWRlZCcsCiAgJ2xpYi9qcXVlcnkuaW52aWV3JywKICAndW5kZXJzY29yZScsCiAgJ2JhY2tib25lJywKICAnZ2FsbGVyeS92aWV3cy90aHVtYi5jb250YWluZXInLAogICdnYWxsZXJ5L3ZpZXdzL3RodW1iLnZpZXcnLAogICdnYWxsZXJ5L3V0aWxzL3Jlc3BvbnNpdmUuYWRhcHRlcicKXSwgZnVuY3Rpb24oJCwgSW1hZ2VzTG9hZGVkLCBub3BlLCBfLCBCYWNrYm9uZSwgVGh1bWJDb250YWluZXIsIFRodW1iVmlldywgUmVzcG9uc2l2ZUFkYXB0ZXIpIHsKCiAgLyoKICAgKiBBZGRzIHRoZSBUaHVtYnMgaW4gdGhlIEdhbGxlcnkganNvbiBkeW5hbWljYWxseSwgd2hlbiB0aGUganNvbiBpcyBsb2FkZWQsIHRvIAogICAqIHRoZSBUaHVtYiBDb250YWluZXIuIEFuZCBub3QgYWxsIHRodW1icyBhdCBvbmNlLCBidXQgaW4gY2h1bmtzIGFzIGEgJ3N0b3BwZXInCiAgICogZWxlbWVudCBjb21lcyBpbnRvIHRoZSB2aWV3cG9ydCAoanF1ZXJ5LmludmlldykuCiAgICovCiAgdmFyIFRodW1iQ29udGFpbmVyRHluYW1pYyA9IFRodW1iQ29udGFpbmVyLmV4dGVuZCh7CiAgICAKICAgIGRlYnVnOiBmYWxzZSwKICAgIAogICAgLy8gb3ZlcnJpZGUKICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uKCkgewogICAgICAvLyBSZWFkIGluIGlubGluZSBUZW1wbGF0ZSAKICAgICAgdGhpcy50aHVtYlRlbXBsYXRlID0gdGhpcy5nZXRUaHVtYlRlbXBsYXRlKCk7CiAgICAgIAogICAgICB0aGlzLmxvYWRlZEltYWdlcyA9IDA7CiAgICAgIHRoaXMudGhyZXNob2xkID0gMzAwOwogICAgICAKICAgICAgVGh1bWJDb250YWluZXIucHJvdG90eXBlLmluaXRpYWxpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgCiAgICAgIHRoaXMuc3RvcHBlciA9IHRoaXMuJGVsLm5leHQoJy5zdG9wcGVyJyk7CiAgICAgIC8vIGNoZWNrIGZvciBuZXcgU2xpZGVyIGltYWdlID0+IGxvYWQgdGh1bWJzLi4uCiAgICAgIHRoaXMubGlzdGVuVG8odGhpcy5tb2RlbCwgJ3NsaWRlcjpuZXdJbWFnZScsIHRoaXMub25OZXdTbGlkZXJJbWFnZSk7CiAgICAgIC8vIGNoZWNrIGZvciBzbGlkZXIgZ2V0cyBjbG9zZWQgPT4gc2Nyb2xsIHRvIGN1cnJlbnQgaW1hZ2UKICAgICAgdGhpcy5saXN0ZW5Ubyh0aGlzLm1vZGVsLCAnc2xpZGVyOmNsb3NpbmcnLCB0aGlzLm9uU2xpZGVyQ2xvc2luZyk7CiAgICB9LAogICAgCiAgICBpbml0R2FsbGVyeTogZnVuY3Rpb24oKSB7CiAgICAgIC8vIGdldCBvcHRpb25zIGZyb20gZmV0Y2hlZCBHYWxsZXJ5TW9kZWwKICAgICAgdmFyIGdhbGxlcnlPcHRzID0gdGhpcy5tb2RlbC5nZXQoJ29wdHMnKTsKICAgICAgdGhpcy5maXJzdENodW5rID0gUmVzcG9uc2l2ZUFkYXB0ZXIuZ2V0T3B0aW9uQnlNZWRpYVR5cGUoZ2FsbGVyeU9wdHMsICdmaXJzdF9jaHVuaycpOwogICAgICB0aGlzLmNodW5rU2l6ZSA9IFJlc3BvbnNpdmVBZGFwdGVyLmdldE9wdGlvbkJ5TWVkaWFUeXBlKGdhbGxlcnlPcHRzLCAnY2h1bmtfc2l6ZScpOwoKICAgICAgLy8gbm93IGFsbCBpbWFnZSBtb2RlbHMgYXJlIGZldGNoZWQgKHRoZSBjb2xsZWN0aW9uIGlzIGluaXRpYWxpemVkKSwgbm93IHdlIGNhbiAKICAgICAgLy8gbGlzdGVuIGZvciBldmVudHMgKHJlc2V0LCByZW1vdmUpIG9uIHRoZSBpbWFnZXMgY29sbGVjdGlvbgogICAgICB0aGlzLmxpc3RlblRvKHRoaXMubW9kZWwuZ2V0KCdpbWFnZXMnKSwgJ3Jlc2V0JywgdGhpcy5pbml0VGh1bWJzKTsKICAgICAgdGhpcy5saXN0ZW5Ubyh0aGlzLm1vZGVsLmdldCgnaW1hZ2VzJyksICdyZW1vdmUnLCB0aGlzLnJlbW92ZVRodW1iKTsKICAgIH0sCgogICAgLy8gb3ZlcnJpZGUKICAgIGluaXRUaHVtYnM6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLnJlbW92ZSgpOyAvLyByZW1vdmUgb2xkIFRodW1icwoKICAgICAgdGhpcy5fbGlzdGVuaW5nRm9ySW52aWV3ID0gZmFsc2U7CgogICAgICB0aGlzLmltYWdlc1RvTG9hZCA9IHRoaXMubW9kZWwuZ2V0KCdpbWFnZXMnKS5tb2RlbHMuc2xpY2UoKTsgLy8gc2xpY2UoKSBtZWFucyBjbG9uZSgpCiAgICAgIAogICAgICAvLyBSZW5kZXIgaW5pdGlhbCBjaHVuayBvZiB0aHVtYnMgCiAgICAgIHZhciByZW5kZXJlZFRodW1iRWxlbWVudHMgPSB0aGlzLl9yZW5kZXJDaHVuayh0aGlzLmZpcnN0Q2h1bmspOwogICAgICAKICAgICAgLy8gUmVzZXQgTG9hZGluZyBpbmRpY2F0b3Igb24gQ29udGFpbmVyCiAgICAgIHRoaXMuJGVsLnJlbW92ZUNsYXNzKCdsb2FkaW5nJyk7CiAgICAgIAogICAgICAvLyBDaGVjayB3aGVuIFRodW1icyBhcmUgbG9hZGVkID0+IEhpZGUgaW5kaWNhdG9yICYgcmUtYXJyYW5nZSBtYXNvbnJ5CiAgICAgIHRoaXMuX2NoZWNrSW1hZ2VzTG9hZGVkKHJlbmRlcmVkVGh1bWJFbGVtZW50cyk7CiAgICB9LAoKICAgIHJlbW92ZTogZnVuY3Rpb24oKSB7CiAgICAgIC8vIFRPRE86IHdlIG9ubHkgcmVtb3ZlIHRoZSBET00gZWxlbWVudHMsIGluc3RlYWQgdGhlIHRodW1iVmlld3Mgc2hvdWxkIGdldCByZW1vdmVkCiAgICAgIHRoaXMuJGVsLmNoaWxkcmVuKCkucmVtb3ZlKCk7CiAgICB9LAoKICAgIHJlbW92ZVRodW1iOiBmdW5jdGlvbihtb2RlbCwgY29sbGVjdGlvbiwgb3B0aW9ucykgewogICAgICBtb2RlbC5nZXRUaHVtYlZpZXcoKS5yZW1vdmUoKTsKICAgIH0sCiAgICAgICAgCiAgICByZW5kZXJOZXh0Q2h1bms6IGZ1bmN0aW9uKCkgewogICAgICAvLyBIQUNLLCB3aGVuIGltYWdlc0xvYWRlZCBkb2Vzbid0IHJlYWNoICdhbHdheXMnIGNhbGxiYWNrIChUT0RPOiBtdXNzIGRhcyBub2NoIHNlaW4/KQogICAgICB0aGlzLnRpbWVvdXRCaW5kID0gd2luZG93LnNldFRpbWVvdXQoXy5iaW5kKHRoaXMuX2JpbmRJbnZpZXcsIHRoaXMpLCAyMDAwKTsKICAgICAgLy8gdW5iaW5kIHN0b3BwZXIKICAgICAgdGhpcy5fdW5iaW5kSW52aWV3KCk7CiAgICAgIC8vIHJlbmRlciBuZXh0IGNodW5rIG9mIHRodW1icwogICAgICB2YXIgcmVuZGVyZWRUaHVtYkVsZW1lbnRzID0gdGhpcy5fcmVuZGVyQ2h1bmsodGhpcy5jaHVua1NpemUpOwogICAgICAvLyByZWdpc3RlciBsb2FkZWQgaW1hZ2VzCiAgICAgIHRoaXMuX2NoZWNrSW1hZ2VzTG9hZGVkKHJlbmRlcmVkVGh1bWJFbGVtZW50cyk7CiAgICB9LAogICAgCiAgICAvLyAocmUpbGF5b3V0IG1hc29ucnkKICAgIC8vIFRPRE8vUkVGQUNUT1I6IHdpcmQgdm9uIGltYWdlc2xvYWRlZCBhdWZnZXJ1ZmVuID0+IGVpbiB3ZWl0ZXJlcy9hbGxlIEJpbGQoZXIpIHd1cmRlIGZlcnRpZyBnZWxhZGVuLgogICAgYXJyYW5nZVRodW1iczogZnVuY3Rpb24oKSB7fSwKCiAgICAvLyBjYWxsYmFjayBmb3IgYSBuZXcgdGh1bWJWaWV3IGlzIGluc3RhbmNpYXRlZCBhbmQgYWRkZWQgdG8gdGhlIGRvbQogICAgdGh1bWJBZGRlZDogZnVuY3Rpb24odGh1bWJWaWV3KSB7fSwKCiAgICAvLyBCaW5kcyB0aGlzLl9vblN0b3BwZXJBcHBlYXJlZCBmdW5jdGlvbiB0byBpbnZpZXcgZXZlbnQKICAgIF9iaW5kSW52aWV3OiBmdW5jdGlvbigpIHsKICAgICAgd2luZG93LmNsZWFyVGltZW91dCh0aGlzLnRpbWVvdXRCaW5kKTsKICAgICAgaWYgKHRoaXMuaW1hZ2VzVG9Mb2FkLmxlbmd0aCAmJiAhdGhpcy5fbGlzdGVuaW5nRm9ySW52aWV3KSB7CiAgICAgICAgdGhpcy5zdG9wcGVyLnNob3coKTsKICAgICAgICB0aGlzLnN0b3BwZXIub24oJ2ludmlldycsIHsgdGhyZXNob2xkOiB0aGlzLnRocmVzaG9sZCB9LCBfLmJpbmQodGhpcy5fb25TdG9wcGVyQXBwZWFyZWQsIHRoaXMpKTsKICAgICAgICB0aGlzLl9saXN0ZW5pbmdGb3JJbnZpZXcgPSB0cnVlOwogICAgICAgICQod2luZG93KS50cmlnZ2VyKCdzY3JvbGwnKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLnN0b3BwZXIuaGlkZSgpOwogICAgICB9CiAgICB9LAogICAgLy8gVW5iaW5kcyB0aGlzLl9vblN0b3BwZXJBcHBlYXJlZAogICAgX3VuYmluZEludmlldzogZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMuc3RvcHBlci5vZmYoJ2ludmlldycpOwogICAgICB0aGlzLl9saXN0ZW5pbmdGb3JJbnZpZXcgPSBmYWxzZTsKICAgIH0sCiAgICAvLyBIYW5kbGVyIGZvciAnZW5kbGVzcy1zY3JvbGwnIGxpa2UgaW52aWV3LmpzIGV2ZW50cwogICAgX29uU3RvcHBlckFwcGVhcmVkOiBmdW5jdGlvbihldmVudCwgaXNJblZpZXcsIHZpc2libGVQYXJ0WCwgdmlzaWJsZVBhcnRZKSB7CiAgICAgIGlmIChpc0luVmlldykgewogICAgICAgIGlmICh0aGlzLmRlYnVnKSB7Y29uc29sZS5sb2coJ1NUb1BQZXIgZ2VzaWNodGV0IScpO30KICAgICAgICB0aGlzLnJlbmRlck5leHRDaHVuaygpOwogICAgICB9IGVsc2UgewogICAgICAgIGlmICh0aGlzLmRlYnVnKSB7Y29uc29sZS5sb2coJ1NUb3BwZXIgb3V0IG9mIHNpZ2h0IScpO30KICAgICAgfQogICAgfSwKICAgIAogICAgLy8gcmV0dXJucyBudW1iZXIgb2YgcmVtYWluaW5nIGltYWdlc1RvTG9hZAogICAgX3JlbmRlckNodW5rOiBmdW5jdGlvbihjaHVua1NpemUpIHsKICAgICAgLy8gSXRlYXJ0aW5nIG92ZXIgdGhlIGxvYWRlZCBJbWFnZU1vZGVsIG9iamVjdHMgYW5kIHJlbmRlciB0aGVtCiAgICAgIHZhciByZW5kZXJlZFRodW1iRWxlbWVudHMgPSBbXTsKICAgICAgdmFyIGltYWdlTW9kZWw7CiAgICAgIGZvcih2YXIgaT0wO2k8Y2h1bmtTaXplO2krKykgewogICAgICAgIGltYWdlTW9kZWwgPSB0aGlzLmltYWdlc1RvTG9hZC5zaGlmdCgpOwogICAgICAgIGlmIChpbWFnZU1vZGVsKSB7CiAgICAgICAgICB2YXIgdGh1bWJWaWV3ID0gbmV3IFRodW1iVmlldyh7CiAgICAgICAgICAgIG1vZGVsOiBpbWFnZU1vZGVsLAogICAgICAgICAgICBnYWxsZXJ5OiB0aGlzLm1vZGVsLAogICAgICAgICAgICB0ZW1wbGF0ZTogdGhpcy50aHVtYlRlbXBsYXRlCiAgICAgICAgICB9KTsKICAgICAgICAgIHRodW1iVmlldyA9IHRodW1iVmlldy5yZW5kZXIoKTsKICAgICAgICAgIHRoaXMuJGVsLmFwcGVuZCh0aHVtYlZpZXcuJGVsKTsKICAgICAgICAgIHRoaXMudGh1bWJBZGRlZCh0aHVtYlZpZXcpOwogICAgICAgICAgcmVuZGVyZWRUaHVtYkVsZW1lbnRzLnB1c2godGh1bWJWaWV3LmVsKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiByZW5kZXJlZFRodW1iRWxlbWVudHM7CiAgICB9LAogICAgCiAgICBfY2hlY2tJbWFnZXNMb2FkZWQ6IGZ1bmN0aW9uKHJlbmRlcmVkVGh1bWJFbGVtZW50cykgewogICAgICB2YXIgaW5zdGFuY2UgPSB0aGlzOwoKICAgICAgLy8gUmVnaXN0ZXIgaW1hZ2VzTG9hZGVkIG9uIG5ld2x5IHJlbmRlcmVkIHRodW1icyBmb3Igc3dpdGNoaW5nIAogICAgICAvLyBsb2FkaW5nL2xvYWRlZCBjbGFzc2VzCiAgICAgIG5ldyBJbWFnZXNMb2FkZWQocmVuZGVyZWRUaHVtYkVsZW1lbnRzKQogICAgICAgIC5vbigncHJvZ3Jlc3MnLCBmdW5jdGlvbihpbWFnZXNMb2FkZWQsIGxvYWRpbmdJbWFnZSkgewogICAgICAgICAgaWYgKGxvYWRpbmdJbWFnZS5pc0xvYWRlZCkgewogICAgICAgICAgICBpbnN0YW5jZS5zd2l0Y2hUaHVtYkNsYXNzKGxvYWRpbmdJbWFnZS5pbWcpOwogICAgICAgICAgICBpbnN0YW5jZS5hcnJhbmdlVGh1bWJzKCk7CiAgICAgICAgICB9CiAgICAgICAgfSkKICAgICAgICAub24oJ2Fsd2F5cycsIGZ1bmN0aW9uKCkgewogICAgICAgICAgaWYgKGluc3RhbmNlLmRlYnVnKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdsYXN0IHN0b3BwZXJBcHBlYXJlZCB0cmlnZ2VyIGNvbXBsZXRlZC4nKTsKICAgICAgICAgICAgY29uc29sZS5sb2coJ2xlZnQgb3ZlciBpbWFnZXNUb0xvYWQ6ICcgKyBpbnN0YW5jZS5pbWFnZXNUb0xvYWQubGVuZ3RoKTsKICAgICAgICAgIH0KICAgICAgICAgIHdpbmRvdy5zZXRUaW1lb3V0KF8uYmluZChpbnN0YW5jZS5hcnJhbmdlVGh1bWJzLCBpbnN0YW5jZSksIDIwMCk7CiAgICAgICAgICBpbnN0YW5jZS5fYmluZEludmlldygpOwogICAgICAgIH0pCiAgICAgICAgLm9uKCdmYWlsJywgZnVuY3Rpb24oaW5zdGFuY2UpIHsKICAgICAgICAgIGlmIChpbnN0YW5jZS5kZWJ1ZykgewogICAgICAgICAgICBjb25zb2xlLmxvZygnRkFJTCAtIGFsbCBpbWFnZXMgbG9hZGVkLCBhdCBsZWFzdCBvbmUgaXMgYnJva2VuJyk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIAogICAgICAvLyBDaGVjayBpZiBzb21lIGltYWdlcyBhcmUgbG9hZGVkIHlldCAnYmVmb3JlJyBJbWFnZXNMb2FkZWQgY2FsbAogICAgICAkKHJlbmRlcmVkVGh1bWJFbGVtZW50cykuZWFjaChmdW5jdGlvbihpZHgsIHRodW1iSW1nKSB7CiAgICAgICAgaWYgKCQodGh1bWJJbWcpLnByb3AoJ2NvbXBsZXRlJykpIHsKICAgICAgICAgIGluc3RhbmNlLnN3aXRjaFRodW1iQ2xhc3ModGh1bWJJbWcuaW1nKTsKICAgICAgICAgIGluc3RhbmNlLmFycmFuZ2VUaHVtYnMoKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSwKICAgIAogICAgLy8gVE9ETzogUmVmYWN0b3IgaW50byBUaHVtYlZpZXcKICAgIHN3aXRjaFRodW1iQ2xhc3M6IGZ1bmN0aW9uKGltZykgewogICAgICB2YXIgdGh1bWJJdGVtID0gJChpbWcpLnBhcmVudCgpOwogICAgICByZXR1cm4gdGh1bWJJdGVtLnRvZ2dsZUNsYXNzKCdsb2FkaW5nIGxvYWRlZCcpOwogICAgfSwKICAgIAogICAgb25OZXdTbGlkZXJJbWFnZTogZnVuY3Rpb24obGFyZ2VWaWV3KSB7CiAgICAgIGlmIChfLmNvbnRhaW5zKHRoaXMuaW1hZ2VzVG9Mb2FkLCBsYXJnZVZpZXcubW9kZWwpKSB7CiAgICAgICAgd2luZG93LnNldFRpbWVvdXQoXy5iaW5kKGZ1bmN0aW9uKCkge3RoaXMucmVuZGVyTmV4dENodW5rKCk7fSwgdGhpcyksIDIwMCk7CiAgICAgIH0KICAgIH0sCiAgICAKICAgIG9uU2xpZGVyQ2xvc2luZzogZnVuY3Rpb24obGFzdEN1cnJlbnRsYXJnZVZpZXcpIHsKICAgICAgaWYgKGxhc3RDdXJyZW50bGFyZ2VWaWV3KSB7CiAgICAgICAgdGhpcy5zY3JvbGxUb1RodW1iKGxhc3RDdXJyZW50bGFyZ2VWaWV3Lm1vZGVsKTsKICAgICAgfQogICAgfSwKICAgIAogICAgZ2V0VGh1bWJUZW1wbGF0ZTogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBfLnRlbXBsYXRlKCQoJyN0ZW1wbGF0ZS10aHVtYicpLmh0bWwoKSk7CiAgICB9CiAgICAKICB9KTsKICAKICByZXR1cm4gVGh1bWJDb250YWluZXJEeW5hbWljOwp9KTsKCmRlZmluZSgnZ2FsbGVyeS92aWV3cy90aHVtYi5jb250YWluZXIuZHluYW1pYy5tYXNvbnJ5JyxbCiAgJ2pxdWVyeScsCiAgJ2pxdWVyeS1icmlkZ2V0L2pxdWVyeS5icmlkZ2V0JywKICAnZmx1aWQtbWFzb25yeScsCiAgJ3VuZGVyc2NvcmUnLAogICdiYWNrYm9uZScsCiAgJ2dhbGxlcnkvdmlld3MvdGh1bWIuY29udGFpbmVyLmR5bmFtaWMnLAogICdnYWxsZXJ5L3V0aWxzL3Jlc3BvbnNpdmUuYWRhcHRlcicKXSwgZnVuY3Rpb24oJCwgbm9wZSwgRmx1aWRNYXNvbnJ5LCBfLCBCYWNrYm9uZSwgVGh1bWJDb250YWluZXJEeW5hbWljLCBSZXNwb25zaXZlQWRhcHRlcikgewoKICAkLmJyaWRnZXQoJ2ZsdWlkTWFzb25yeScsIEZsdWlkTWFzb25yeSk7CgogIC8qCiAgICogQWRkcyB0aGUgVGh1bWJzIGluIHRoZSBHYWxsZXJ5IGpzb24gZHluYW1pY2FsbHksIHdoZW4gdGhlIGpzb24gaXMgbG9hZGVkLCB0byAKICAgKiB0aGUgVGh1bWIgQ29udGFpbmVyLiBBbmQgbm90IGFsbCB0aHVtYnMgYXQgb25jZSwgYnV0IGluIGNodW5rcyBhcyBhICdzdG9wcGVyJwogICAqIGVsZW1lbnQgY29tZXMgaW50byB0aGUgdmlld3BvcnQgKGpxdWVyeS5pbnZpZXcpLgogICAqLwogIHZhciBUaHVtYkNvbnRhaW5lckR5bmFtaWNNYXNvbnJ5ID0gVGh1bWJDb250YWluZXJEeW5hbWljLmV4dGVuZCh7CiAgICAKICAgIGRlYnVnOiBmYWxzZSwKICAgIAogICAgLy8gb3ZlcnJpZGUKICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uKCkgewogICAgICBUaHVtYkNvbnRhaW5lckR5bmFtaWMucHJvdG90eXBlLmluaXRpYWxpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH0sCiAgICAKICAgIGluaXRHYWxsZXJ5OiBmdW5jdGlvbigpIHsKICAgICAgVGh1bWJDb250YWluZXJEeW5hbWljLnByb3RvdHlwZS5pbml0R2FsbGVyeS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB0aGlzLmluaXRNYXNvbnJ5KHRoaXMubW9kZWwuZ2V0KCdvcHRzJykpOwogICAgfSwKCiAgICAvKgogICAgICogbWluX2NvbF93aWR0aDogd2lkdGggb2YgY2VsbCAodGh1bWIpIGluIG1hc29ucnkgbGF5b3V0ICh0aHVtYiBjYW4gZ2V0IHRpbGwgCiAgICAgKiBkb3VibGUgaW4gc2l6ZSwgZGVwZW5kaW5nIG9uIGNvbnRhaW5lci13aWR0aCkKICAgICAqLwogICAgaW5pdE1hc29ucnk6IGZ1bmN0aW9uKGdhbGxlcnlPcHRzKSB7CiAgICAgIHRoaXMuJGVsLmZsdWlkTWFzb25yeSh7CiAgICAgICAgaXRlbVNlbGVjdG9yIDogdGhpcy5vcHRpb25zLml0ZW1TZWxlY3RvciwKICAgICAgICBtaW5Db2x1bW5XaWR0aDogUmVzcG9uc2l2ZUFkYXB0ZXIuZ2V0T3B0aW9uQnlNZWRpYVR5cGUoZ2FsbGVyeU9wdHMsICdtaW5fY29sX3dpZHRoJyksCiAgICAgICAgZ3V0dGVyOiBSZXNwb25zaXZlQWRhcHRlci5nZXRPcHRpb25CeU1lZGlhVHlwZShnYWxsZXJ5T3B0cywgJ2d1dHRlcl93aWR0aCcpLAogICAgICAgIGlzRml0V2lkdGg6IGZhbHNlCiAgICAgIH0pOwogICAgfSwKCiAgICByZW1vdmU6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLiRlbC5mbHVpZE1hc29ucnkoJ3JlbW92ZScsIHRoaXMuJGVsLmNoaWxkcmVuKCkpOwogICAgfSwKCiAgICByZW1vdmVUaHVtYjogZnVuY3Rpb24obW9kZWwsIGNvbGxlY3Rpb24sIG9wdGlvbnMpIHsKICAgICAgdmFyICRlbCA9IHRoaXMuJGVsOwogICAgICAkZWwuZmx1aWRNYXNvbnJ5KCdyZW1vdmUnLCBtb2RlbC5nZXRUaHVtYlZpZXcoKS4kZWwpOwogICAgICAkZWwuZmx1aWRNYXNvbnJ5KCk7CiAgICB9LAogICAgICAgICAgICAKICAgIC8vIChyZSlsYXlvdXQgbWFzb25yeQogICAgLy8gVE9ETy9SRUZBQ1RPUjogd2lyZCB2b24gaW1hZ2VzbG9hZGVkIGF1ZmdlcnVmZW4gPT4gZWluIHdlaXRlcmVzL2FsbGUgQmlsZChlcikgd3VyZGUgZmVydGlnIGdlbGFkZW4uCiAgICBhcnJhbmdlVGh1bWJzOiBmdW5jdGlvbigpIHsKICAgICAgdGhpcy4kZWwuZmx1aWRNYXNvbnJ5KCk7CiAgICB9LAoKICAgIC8vIGNhbGxiYWNrIGZvciBhIG5ldyB0aHVtYlZpZXcgaXMgaW5zdGFuY2lhdGVkIGFuZCBhZGRlZCB0byB0aGUgZG9tCiAgICB0aHVtYkFkZGVkOiBmdW5jdGlvbih0aHVtYlZpZXcpIHsKICAgICAgdGhpcy4kZWwuZmx1aWRNYXNvbnJ5KCdhcHBlbmRlZCcsIHRodW1iVmlldy4kZWwpOwogICAgfQoKICB9KTsKICAKICByZXR1cm4gVGh1bWJDb250YWluZXJEeW5hbWljTWFzb25yeTsKfSk7CgpkZWZpbmUoJ2dhbGxlcnkvdmlld3MvbGFyZ2UudmlldycsWwogICdqcXVlcnknLAogICd1bmRlcnNjb3JlJywKICAnYmFja2JvbmUnCl0sCmZ1bmN0aW9uKCQsIF8sIEJhY2tib25lKSB7CiAgLyoKICAgKiBNb2RlbDogSW1hZ2VNb2RlbAogICAqIEVsZW1lbnQ6IExhcmdlIDxpbWc+CiAgICogCiAgICogI3NsaWRlcjogU2xpZGVyVmlldwogICAqLwogIHZhciBMYXJnZVZpZXcgPSBCYWNrYm9uZS5WaWV3LmV4dGVuZCh7CiAgICAKICAgIGRlYnVnOiBmYWxzZSwKICAgIAogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMuc2xpZGVyID0gdGhpcy5vcHRpb25zLnNsaWRlcjsKICAgICAgCiAgICAgIHRoaXMuY3VycmVudFNsaWRlclJhdGlvID0gdW5kZWZpbmVkOwogICAgICB0aGlzLmN1ckRpbXMgPSAge307CiAgICAgIAogICAgICB0aGlzLmxhcmdlQXR0cnMgPSB0aGlzLm1vZGVsLmdldExhcmdlKCk7CiAgICAgIAogICAgICAvLyBTZXQgdGhpcy4kZWwgdG8gbmV3IGltZwogICAgICB0aGlzLnNldEVsZW1lbnQoJCgnPGltZy8+JykpOwogICAgICB0aGlzLiRlbAogICAgICAgIC5hdHRyKCdzcmMnLCB0aGlzLmxhcmdlQXR0cnMuc3JjKQogICAgICAgIC8vIFNldCBNYXgtV2lkdGggYW5kIE1heC1IZWlnaHQgZm9yIG5vdCB1cHNjYWxpbmcgdGhlIGltYWdlIGdyZWF0ZXIgdGhlbgogICAgICAgIC8vIGl0cyBvcmlnaW5hbCBkaW1lbnNpb25zLgogICAgICAgIC5jc3MoewogICAgICAgICAgJ21heC13aWR0aCc6IHRoaXMubGFyZ2VBdHRycy53aWR0aCwKICAgICAgICAgICdtYXgtaGVpZ2h0JzogdGhpcy5sYXJnZUF0dHJzLmhlaWdodAogICAgICAgIH0pOwogICAgICAKICAgICAgdGhpcy5tb2RlbC5zZXRMYXJnZVZpZXcodGhpcyk7CiAgICB9LAogICAgCiAgICBldmVudHM6IHsKICAgICAgJ2xvYWQnOiAnbG9hZGVkJwogICAgfSwKCiAgICByZXNpemU6IGZ1bmN0aW9uKCkgewogICAgICAvLyBEb24ndCBkbyBub3RoaW5nLCBpZiB0aGUgdHJheSBzaXplIGhhc24ndCBjaGFuZ2VkCiAgICAgIGlmICh0aGlzLmN1cnJlbnRTbGlkZXJSYXRpbyAhPT0gdGhpcy5zbGlkZXIucmF0aW8pIHsKICAgICAgICAKICAgICAgICAvLyBTYXZlIGN1cnJlbnQgVHJheSBSYXRpbyBmb3IgbmV4dCBjYWxjLi4KICAgICAgICB0aGlzLmN1cnJlbnRTbGlkZXJSYXRpbyA9IHRoaXMuc2xpZGVyLnJhdGlvOwogICAgCiAgICAgICAgLy8gQ2FsY3VsYXRpbmcgbmV3IERpbWVuc2lvbnMKICAgICAgICB0aGlzLmN1ckRpbXMgPSB0aGlzLl9jYWxjdWxhdGVEaW1zKCk7CiAgICAgIAogICAgICAgIC8vIFNldCB0aGUgSW1hZ2UgRGltZW5zaW9ucyBmb3IgZml0dGluZyBpbiBhbmQgZmlsbGluZyBpdCdzIGNvbnRhaW5lcgogICAgICAgIC8vIGluIHNldFRpbWVvdXQsIHNvIHRoYXQgdGhlIHJlc2V0IGZyb20gYWJvdmUgZ2V0cyB0aW1lIHRvIGJlIGFwcGxpZWQKICAgICAgICB2YXIgbGFyZ2UgPSB0aGlzOwogICAgICAgIHdpbmRvdy5zZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgbGFyZ2UuJGVsLmFuaW1hdGUoewogICAgICAgICAgICB3aWR0aDogbGFyZ2UuY3VyRGltc1sncHgnXVswXSwvLyArICdweCcsIC8vbmV3RGltc1swXSwKICAgICAgICAgICAgaGVpZ2h0OiBsYXJnZS5jdXJEaW1zWydweCddWzFdLy8gKyAncHgnLCAvL25ld0RpbXNbMV0KICAgICAgICAgIH0sIDApOwogICAgICAgIH0sIDApOwogICAgICB9CiAgICB9LAogICAgCiAgICBnZXRXaWR0aDogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB0aGlzLmN1ckRpbXNbJ3B4J11bMF07CiAgICB9LAogICAgCiAgICBnZXRIZWlnaHQ6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gdGhpcy5jdXJEaW1zWydweCddWzFdOwogICAgfSwKICAgIAogICAgLyoKICAgICAqIEJlcmVjaG5ldCBkaWUgdGF0c8OkY2hsaWNoZW4gRGltZW5zaW9uLVdlcnRlICAgICAgCiAgICAgKi8KICAgIF9jYWxjdWxhdGVEaW1zOiBmdW5jdGlvbigpIHsKICAgICAgdmFyIGltZ09yaWVudCA9IHRoaXMubW9kZWwuZ2V0KCdvcmllbnRhdGlvbicpOwogICAgICBpZiAoaW1nT3JpZW50ID09PSAnbGFuZHNjYXBlJykgewogICAgICAgIHRoaXMuX3NldExhcmdlVG9GdWxsV2l0aCgpOwogICAgICAgIC8vIHRvIGhpZ2ggZm9yIHRoZSBzbGlkZXIsIHdoZW4gc2V0IHRvIGZ1bGwgc2xpZGVyIHdpZHRoPwogICAgICAgIGlmICh0aGlzLmN1ckRpbXNbJ3B4J11bMV0gPiB0aGlzLnNsaWRlci5oZWlnaHQpIHsKICAgICAgICAgIGlmICh0aGlzLmRlYnVnKSB7Y29uc29sZS5sb2coJ3VwcywgaW1hZ2UgdG8gaGlnaCBmb3Igc2xpZGVyLCB3aGVuIHNldCB0byBmdWxsIHNsaWRlciB3aWR0aCEnKTt9CiAgICAgICAgICB0aGlzLl9zZXRMYXJnZVRvRnVsbEhlaWdodCgpOwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmIChpbWdPcmllbnQgPT09ICdwb3J0cmFpdCcpIHsKICAgICAgICB0aGlzLl9zZXRMYXJnZVRvRnVsbEhlaWdodCgpOwogICAgICAgIC8vIHRvIHdpZGUgZm9yIHRoZSBzbGlkZXIsIHdoZW4gc2V0IHRvIGZ1bGwgc2xpZGVyIGhlaWdodD8KICAgICAgICBpZiAodGhpcy5jdXJEaW1zWydweCddWzBdID4gdGhpcy5zbGlkZXIud2lkdGgpIHsKICAgICAgICAgIGlmICh0aGlzLmRlYnVnKSB7Y29uc29sZS5sb2coJ3VwcywgaW1hZ2UgdG8gd2lkZSBmb3Igc2xpZGVyLCB3aGVuIHNldCB0byBmdWxsIHNsaWRlciBoZWlnaHQhJyk7fQogICAgICAgICAgdGhpcy5fc2V0TGFyZ2VUb0Z1bGxXaXRoKCk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiB0aGlzLmN1ckRpbXM7CiAgICB9LAogICAgCiAgICBfc2V0TGFyZ2VUb0Z1bGxXaXRoOiBmdW5jdGlvbigpIHsKICAgICAgdGhpcy5jdXJEaW1zWydwZXJjZW50J10gPSBbJzEwMCUnLCAnJ107CiAgICAgIHRoaXMuY3VyRGltc1sncHgnXSA9IFsKICAgICAgICBNYXRoLm1pbih0aGlzLnNsaWRlci53aWR0aCwgdGhpcy5sYXJnZUF0dHJzLndpZHRoKSwKICAgICAgICBNYXRoLm1pbihNYXRoLmZsb29yKHRoaXMuc2xpZGVyLndpZHRoL3RoaXMubW9kZWwuZ2V0KCdyYXRpbycpKSwgdGhpcy5sYXJnZUF0dHJzLmhlaWdodCkKICAgICAgXTsKICAgICAgaWYgKHRoaXMuZGVidWcpIHsKICAgICAgICBjb25zb2xlLmxvZygnMTAwJSB3aWR0aCA9PicrIHRoaXMuc2xpZGVyLndpZHRoICsneCcrCiAgICAgICAgICB0aGlzLmN1ckRpbXNbJ3B4J11bMV0gKydweDsgQ29udGFpbmVyOiAnKwogICAgICAgICAgdGhpcy5zbGlkZXIud2lkdGggKyd4JysgdGhpcy5zbGlkZXIuaGVpZ2h0ICsncHguJyk7CiAgICAgIH0KICAgIH0sCiAgICAKICAgIF9zZXRMYXJnZVRvRnVsbEhlaWdodDogZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMuY3VyRGltc1sncGVyY2VudCddID0gWycnLCAnMTAwJSddOwogICAgICB0aGlzLmN1ckRpbXNbJ3B4J10gPSBbCiAgICAgICAgTWF0aC5taW4oTWF0aC5mbG9vcih0aGlzLnNsaWRlci5oZWlnaHQqdGhpcy5tb2RlbC5nZXQoJ3JhdGlvJykpLCB0aGlzLmxhcmdlQXR0cnMud2lkdGgpLAogICAgICAgIE1hdGgubWluKHRoaXMuc2xpZGVyLmhlaWdodCwgdGhpcy5sYXJnZUF0dHJzLmhlaWdodCkKICAgICAgXTsKICAgICAgaWYgKHRoaXMuZGVidWcpIHsKICAgICAgICBjb25zb2xlLmxvZygnMTAwJSBoZWlnaHQgPT4nKyB0aGlzLmN1ckRpbXNbJ3B4J11bMF0gKyd4JysKICAgICAgICAgIHRoaXMuY3VyRGltc1sncHgnXVsxXSArJ3B4OyBjb250YWluZXI6ICcgKwogICAgICAgICAgdGhpcy5zbGlkZXIud2lkdGggKyd4JysgdGhpcy5zbGlkZXIuaGVpZ2h0ICsncHguJyk7CiAgICAgIH0KICAgIH0sCiAgICAKICAgIGxvYWRlZDogZnVuY3Rpb24oKSB7CiAgICAgIGlmICh0aGlzLmRlYnVnKSB7Y29uc29sZS5sb2coJ0xhcmdlVmlldyBmb3IgSW1hZ2UgJysgdGhpcy5tb2RlbC5pZCArJyBpcyBsb2FkZWQnKTt9CiAgICB9CiAgfSk7CiAgCiAgcmV0dXJuIExhcmdlVmlldzsKfSk7CgpkZWZpbmUoJ2dhbGxlcnkvdmlld3MvY29ja3BpdC52aWV3JyxbCiAgJ2pxdWVyeScsCiAgJ2pxdWVyeS10b3VjaHN3aXBlJywKICAndW5kZXJzY29yZScsCiAgJ2JhY2tib25lJywKICAnZ2FsbGVyeS92aWV3cy9zZWxlY3Rpb24vc2VsZWN0LmJ1dHRvbicKXSwKZnVuY3Rpb24oJCwgbm9wZSwgXywgQmFja2JvbmUsIFNlbGVjdEJ1dHRvbikgewogIAogIC8qCiAgICogTW9kZWw6IEdhbGxlcnlNb2RlbAogICAqLwogIHZhciBDb2NrcGl0VmlldyA9IEJhY2tib25lLlZpZXcuZXh0ZW5kKHsKICAgIAogICAgZWw6ICcuY29ja3BpdCcsCiAgICAKICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uKCkgewogICAgICBpZiAodGhpcy4kZWwubGVuZ3RoKSB7IC8vIG9ubHkgd2hlbiB0aGVyZSdzIGEgY29ja3BpdCBvbiBkZWNrCgogICAgICAgIHRoaXMuYnV0dG9uID0gdGhpcy4kKCcuY29ja3BpdF9idXR0b24nKTsKICAgICAgICB0aGlzLmJvZHkgPSB0aGlzLiQoJy5jb2NrcGl0X2JvZHknKS5hZGRDbGFzcygnaGlkZGVuJyk7CiAgICAgICAgdGhpcy5fYm9keVRlbXBsYXRlID0gdGhpcy5nZXRUZW1wbGF0ZSgpOwogICAgICAgIHRoaXMuc2xpZGVyID0gdGhpcy5vcHRpb25zLnNsaWRlcjsKICAgICAgICAKICAgICAgICB0aGlzLmxpc3RlblRvKHRoaXMubW9kZWwsICdzbGlkZXI6bmV3SW1hZ2UnLCB0aGlzLm9uTmV3SW1hZ2UpOwoKICAgICAgICAvLyBub3Qgd2l0aCBidWlsdCBpbiBldmVudHMgPT4gZG9lc24ndCB3b3JrIHdlbGwgb24gdG91Y2ggZGV2aWNlcwogICAgICAgIC8vIHRoaXMgZmFsbHMgYmFjayB0byBtb3VzZSBldmVudHMsIHdoZW4gbm8gdG91Y2ggZXZlbnRzIHN1cHBvcnRlZAogICAgICAgIHRoaXMuYnV0dG9uLnN3aXBlKHsKICAgICAgICAgIHRhcDogXy5iaW5kKHRoaXMudG9nZ2xlQm9keSwgdGhpcykKICAgICAgICB9KTsKICAgICAgfQogICAgfSwKICAgIAogICAgLy8gb3ZlcnJpZGUgQmFja2JvbmUuVmlldyNyZW1vdmUgdG8gcmVtb3ZlIHRoZSB0b3VjaCBldmVudCBsaXN0ZW5lcgogICAgcmVtb3ZlOiBmdW5jdGlvbigpIHsKICAgICAgdGhpcy5idXR0b24uc3dpcGUoJ2Rlc3Ryb3knKTsKICAgICAgQmFja2JvbmUuVmlldy5wcm90b3R5cGUucmVtb3ZlLmNhbGwodGhpcyk7IC8vIGNhbGwgc3VwZXIoKQogICAgICAvLyBjb3VsZCBhbHNvIGJlIHdyaXR0ZW4gYXM6CiAgICAgIC8vIHRoaXMuY29uc3RydWN0b3IuX19zdXBlcl9fLnJlbW92ZS5jYWxsKHRoaXMpOwogICAgfSwKCiAgICBpc09wZW46IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gIXRoaXMuYm9keS5oYXNDbGFzcygnaGlkZGVuJyk7CiAgICB9LAogICAgCiAgICB0b2dnbGVCb2R5OiBmdW5jdGlvbihldnQpIHsKICAgICAgdGhpcy5ib2R5LnRvZ2dsZUNsYXNzKCdoaWRkZW4nKTsKICAgICAgdGhpcy5yZW5kZXJCb2R5KHRoaXMubW9kZWwuZ2V0Q3VycmVudCgpKTsKICAgIH0sCgogICAgb25OZXdJbWFnZTogZnVuY3Rpb24obGFyZ2VWaWV3KSB7CiAgICAgIHRoaXMucmVuZGVyQm9keShsYXJnZVZpZXcubW9kZWwpOwogICAgfSwKICAgIAogICAgcmVuZGVyQm9keTogZnVuY3Rpb24oaW1hZ2VNb2RlbCkgewogICAgICBpZiAodGhpcy5pc09wZW4oKSkgewogICAgICAgIC8vIHJlbmRlciBpbWFnZSBtZXRhCiAgICAgICAgdGhpcy5ib2R5Lmh0bWwodGhpcy5fYm9keVRlbXBsYXRlKHtpbWc6IGltYWdlTW9kZWx9KSk7CiAgICAgICAgCiAgICAgICAgLy8gdXBkYXRlIFNlbGVjdEJ1dHRvbiBpZiBwcmVzZW50IGluIHRlbXBsYXRlCiAgICAgICAgdmFyIHNlbGVjdG9yID0gdGhpcy4kKCcuc2VsZWN0b3InKTsKICAgICAgICBpZiAoc2VsZWN0b3IubGVuZ3RoKSB7CiAgICAgICAgICB0aGlzLnVwZGF0ZVNlbGVjdEJ1dHRvbihzZWxlY3RvciwgaW1hZ2VNb2RlbCk7CiAgICAgICAgfQogICAgICB9CiAgICB9LAoKICAgIHVwZGF0ZVNlbGVjdEJ1dHRvbjogZnVuY3Rpb24oc2VsZWN0b3IsIGltYWdlTW9kZWwpIHsKICAgICAgaWYgKHRoaXMuc2VsZWN0QnV0dG9uKSB7IC8vIHJlbW92ZSBvbGQgU2VsZWN0QnV0dG9uIGlmIHByZXNlbnQKICAgICAgICB0aGlzLnNlbGVjdEJ1dHRvbi5yZW1vdmUoKTsKICAgICAgfQogICAgICB0aGlzLnNlbGVjdEJ1dHRvbiA9IG5ldyBTZWxlY3RCdXR0b24oewogICAgICAgIG1vZGVsOiBpbWFnZU1vZGVsLAogICAgICAgIGVsOiBzZWxlY3RvcgogICAgICB9KTsKICAgIH0sCgogICAgZ2V0VGVtcGxhdGU6IGZ1bmN0aW9uKCkgewogICAgICB2YXIgdG1wbCA9ICQoJyN0ZW1wbGF0ZS1jb2NrcGl0Qm9keScpOwogICAgICBpZiAodG1wbC5sZW5ndGgpIHsKICAgICAgICByZXR1cm4gXy50ZW1wbGF0ZSh0bXBsLmh0bWwoKSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY29uc29sZS5lcnJvcignTWlzc2luZyBUZW1wbGF0ZSBmb3IgQ29ja3BpdCAoJCgiI3RlbXBsYXRlLWNvY2twaXRCb2R5IikhID0+IENvY2twaXQgbm90IGluaXRpYWxpemVkLicpOwogICAgICAgIHRoaXMuJGVsLmhpZGUoKTsKICAgICAgfQogICAgICAKICAgIH0KICB9KTsKICAKICByZXR1cm4gQ29ja3BpdFZpZXc7Cn0pOwoKZGVmaW5lKCdnYWxsZXJ5L3ZpZXdzL3NsaWRlci52aWV3JyxbCiAgJ2pxdWVyeScsCiAgJ2pxdWVyeS10b3VjaHN3aXBlJywKICAndmVuZG9yL2pxdWVyeS50aHJvdHRsZS1kZWJvdW5jZScsCiAgJ3VuZGVyc2NvcmUnLAogICdiYWNrYm9uZScsCiAgJ2dhbGxlcnkvdmlld3MvbGFyZ2UudmlldycsCiAgJ2dhbGxlcnkvdmlld3MvY29ja3BpdC52aWV3JwpdLCBmdW5jdGlvbigkLCBub3BlLCBub3BlMiwgXywgQmFja2JvbmUsIExhcmdlVmlldywgQ29ja3BpdFZpZXcpIHsKICAKICAvKgogICAqIE1vZGVsOiBHYWxsZXJ5TW9kZWwKICAgKiBFbGVtZW50OiBpcyBzZXQgYnkgdGhlIGNvbnN0cnVjdG9yIChzZWUgYXBwLmpzKQogICAqCiAgICogbGlzdGVucyB0byAndGh1bWI6Y2xpY2tlZCcgb24gR2FsbGVyeU1vZGVsCiAgICogbGlzdGVucyB0byAncmVzaXplLnNsaWRlcicgb24gd2luZG93CiAgICogbGlzdGVucyB0byAnY2xpY2suc2xpZGVyJyBvbiB0aGlzLiRlbAogICAqIGxpc3RlbnMgdG8gJ21vdXNlbW92ZS5zbGlkZXInIG9uIHRoaXMuJGVsCiAgICogbGlzdGVucyB0byAna2V5dXAuc2xpZGVyJyAoRVNDWzI3XSwgY3Vyc29yLWxlZnRbMzddLCBjdXJzb3ItcmlnaHRbMzldKQogICAqIGxpc3RlbnMgb25jZSB0byAnc3luYycgb24gR2FsbGVyeU1vZGVsCiAgICogdHJpZ2dlcnMgJ3NsaWRlcjpuZXdJbWFnZScgd2l0aCBjdXJyZW50IExhcmdlVmlldyBvYmplY3Qgb24gR2FsbGVyeU1vZGVsCiAgICovCiAgdmFyIFNsaWRlclZpZXcgPSBCYWNrYm9uZS5WaWV3LmV4dGVuZCh7CiAgICAgICAgCiAgICBldmVudHM6IHsKICAgICAgJ2NsaWNrIC5uYXYucHJldic6ICdzaG93UHJldicsCiAgICAgICdjbGljayAubmF2Lm5leHQnOiAnc2hvd05leHQnCiAgICB9LAogICAgCiAgICBpbml0aWFsaXplOiBmdW5jdGlvbigpIHsKICAgICAgLy8gTWFyayB3aXRoIHNsaWRlcl9jbG9zZWQgY2xhc3MKICAgICAgJCgnYm9keScpLmFkZENsYXNzKCdzbGlkZXJfY2xvc2VkJyk7CiAgICAgIAogICAgICAvLyBJbml0IEVsZW1lbnRzCiAgICAgIHRoaXMudHJheSA9IHRoaXMuJCgnLnRyYXknKTsKICAgICAgdGhpcy5jdXJyZW50Qm94ID0gdGhpcy4kKCcucGhvdG8uY3VycmVudCcpOyAvL1RPRE86IE9wdGlvbnMKICAgICAgdGhpcy5wcmV2Qm94ID0gdGhpcy4kKCcucGhvdG8ucHJldicpOwogICAgICB0aGlzLm5leHRCb3ggPSB0aGlzLiQoJy5waG90by5uZXh0Jyk7CiAgICAgIHRoaXMubmF2UHJldiA9IHRoaXMuJCgnLm5hdi5wcmV2Jyk7IC8vIFRPRE86IE9wdGlvbnMKICAgICAgdGhpcy5uYXZOZXh0ID0gdGhpcy4kKCcubmF2Lm5leHQnKTsgLy8gVE9ETzogT3B0aW9ucwogICAgICB0aGlzLmN1cnJlbnQgPSB1bmRlZmluZWQ7CiAgICAgIAogICAgICAvLyBSZWdpc3RlciBIYW5kbGVycwogICAgICAvLyBDaGVjaywgd2hlbiBUaHVtYiB3YXMgY2xpY2tlZAogICAgICB0aGlzLmxpc3RlblRvKHRoaXMubW9kZWwsICd0aHVtYjpjbGlja2VkJywgdGhpcy5vcGVuU2xpZGVyKTsKICAgICAgLy8gTGlzdGVuIG9uIHdpbmRvdyByZXNpemUgdG8gcmVzaXplIHRoZSBjdXJyZW50LCB0aGUgcHJldiBhbmQgdGhlIG5leHQgbGFyZ2UKICAgICAgJCh3aW5kb3cpLm9uKCdyZXNpemUuc2xpZGVyJywgXy5iaW5kKCQuZGVib3VuY2UoMjAwLCB0aGlzLnJlc2l6ZSksIHRoaXMpKTsKICAgICAgLy8gTGlzdGVuIHRvIGtleWJvYXJkCiAgICAgICQod2luZG93KS5vbigna2V5dXAuc2xpZGVyJywgXy5iaW5kKHRoaXMua2V5cywgdGhpcykpOwogICAgICAvLyBMaXN0ZW4gdG8gbW91c2Vtb3ZlIGZvciBob3ZlcmluZyB0aGUgcHJldi9uZXh0IGJ1dHRvbnMgLSBvbmx5IG9uIAogICAgICAvLyBub24tdG91Y2ggZGV2aWNlcyAobWl4ZWQgZGV2aWNlcyAoc3VyZmFjZSBldCBhbCkgZG9uJ3QgZ2V0IGhvdmVyIGhlbHApCiAgICAgIHRoaXMudG91Y2hhYmxlID0gKCdvbnRvdWNoc3RhcnQnIGluIHdpbmRvdyk7CiAgICAgIGlmICghdGhpcy50b3VjaGFibGUpIHsKICAgICAgICB0aGlzLnRyYXkub24oJ21vdXNlbW92ZS5zbGlkZXInLCBfLmJpbmQoJC50aHJvdHRsZSgxNTAsIHRoaXMubW91c2Vtb3ZlKSwgdGhpcykpOwogICAgICB9CiAgICAgICAgICAgIAogICAgICAvLyBJbml0IENvY2twaXQKICAgICAgdGhpcy5jb2NrcGl0ID0gbmV3IENvY2twaXRWaWV3KHsKICAgICAgICBtb2RlbDogdGhpcy5tb2RlbCwKICAgICAgICBzbGlkZXI6IHRoaXMKICAgICAgfSk7CiAgICAgIAogICAgICAvLyBJbml0IFN3aXBlLUhhbmRsZXIgYW5kIGRlYWN0aXZhdGUgaXQgCiAgICAgIC8vID0+IG9wZW5TbGlkZXIvY2xvc2VTbGlkZXIgZW5hYmxlcy9kaXNhYmxlcyBpdCBhZ2FpbgogICAgICB0aGlzLmluaXRTd2lwZUhhbmRsZXIoKTsKICAgICAgdGhpcy4kZWwuc3dpcGUoJ2Rpc2FibGUnKTsKICAgICAgCiAgICAgIC8vIENoZWNrIGlmIGEgSW1hZ2VNb2RlbCBpZCBpcyBpbiB0aGUgd2luZG93LmxvY2F0aW9uLmhhc2ggCiAgICAgIC8vID0+IG9wZW4gc2xpZGVyIHdpdGggdGhpcyBpbWFnZQogICAgICB0aGlzLmxpc3RlblRvT25jZSh0aGlzLm1vZGVsLCAnc3luYycsIGZ1bmN0aW9uKCkgewogICAgICAgIGlmICh3aW5kb3cubG9jYXRpb24uaGFzaC5sZW5ndGggPiAyKSB7CiAgICAgICAgICB2YXIgaW1hZ2VNb2RlbCA9IHRoaXMubW9kZWwuZ2V0KCdpbWFnZXMnKS5nZXQod2luZG93LmxvY2F0aW9uLmhhc2guc3Vic3RyKDIpKTsKICAgICAgICAgIGlmIChpbWFnZU1vZGVsKSB7CiAgICAgICAgICAgIHRoaXMub3BlblNsaWRlcihpbWFnZU1vZGVsKTsKICAgICAgICAgICAgLy8gd2FpdCBhIG1pbGxpc2Vjb25kIHRpbGwgdGhlIHRodW1icyBhcmUgbG9hZGVkIGFuZCBwZXJoYXBzIGEgc2Nyb2xsYmFyIGlzCiAgICAgICAgICAgIC8vIHJlbmRlcmVkID0+IGNoYW5nZXMgdGhlIGRpbWVuc2lvbnMgb2YgdGhlIHNsaWRlcgogICAgICAgICAgICB3aW5kb3cuc2V0VGltZW91dChfLmJpbmQodGhpcy5yZXNpemUsIHRoaXMpLCAyNTApOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICB9LAogICAgCiAgICBpbml0U3dpcGVIYW5kbGVyOiBmdW5jdGlvbigpIHsKICAgICAgdmFyIGluc3RhbmNlID0gdGhpczsKICAgICAgdGhpcy4kZWwuc3dpcGUoewogICAgICAgIHN3aXBlTGVmdDogZnVuY3Rpb24oZXZ0LCBkaXJlY3Rpb24sIGRpc3RhbmNlLCBkdXJhdGlvbiwgZmluZ2VyQ291bnQpIHsKICAgICAgICAgIGluc3RhbmNlLnNob3dOZXh0KCk7CiAgICAgICAgICBldnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICB9LAogICAgICAgIHN3aXBlUmlnaHQ6IGZ1bmN0aW9uKGV2dCwgZGlyZWN0aW9uLCBkaXN0YW5jZSwgZHVyYXRpb24sIGZpbmdlckNvdW50KSB7CiAgICAgICAgICBpbnN0YW5jZS5zaG93UHJldigpOwogICAgICAgICAgZXZ0LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgfSwKICAgICAgICB0YXA6IGZ1bmN0aW9uKGV2dCwgdGFyZ2V0KSB7CiAgICAgICAgICBldnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgIGluc3RhbmNlLmNsaWNrKGV2dCk7CiAgICAgICAgfSwKICAgICAgICBhbGxvd1BhZ2VTY3JvbGw6ICdub25lJwogICAgICB9KTsKICAgIH0sCiAgICAgICAgCiAgICAvLyBvdmVycmlkZSBCYWNrYm9uZS5WaWV3I3JlbW92ZSB0byByZW1vdmUgdGhlIGV2ZW50IGxpc3RlbmVyIGZvciAncmVzaXplLnNsaWRlcicKICAgIHJlbW92ZTogZnVuY3Rpb24oKSB7CiAgICAgICQod2luZG93KS5vZmYoJ3Jlc2l6ZS5zbGlkZXInKTsKICAgICAgJCh3aW5kb3cpLm9mZigna2V5dXAuc2xpZGVyJyk7CiAgICAgIGlmICh0aGlzLnRvdWNoYWJsZSkgeyB0aGlzLnRyYXkub2ZmKCdtb3VzZW1vdmUuc2xpZGVyJyk7IH0KICAgICAgdGhpcy4kZWwuc3dpcGUoJ2Rlc3Ryb3knKTsKICAgICAgQmFja2JvbmUuVmlldy5wcm90b3R5cGUucmVtb3ZlLmNhbGwodGhpcyk7IC8vIGNhbGwgc3VwZXIoKQogICAgICAvLyBjb3VsZCBhbHNvIGJlIHdyaXR0ZW4gYXM6CiAgICAgIC8vIHRoaXMuY29uc3RydWN0b3IuX19zdXBlcl9fLnJlbW92ZS5jYWxsKHRoaXMpOwogICAgfSwKICAgIAogICAga2V5czogZnVuY3Rpb24oZXZ0KSB7CiAgICAgIGlmICh0aGlzLmlzT3BlbigpKSB7CiAgICAgICAgc3dpdGNoKGV2dC5rZXlDb2RlKSB7CiAgICAgICAgICBjYXNlIDI3OiAvLyBFU0MKICAgICAgICAgICAgdGhpcy5jbG9zZVNsaWRlcigpOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgMzk6IC8vIFJpZ2h0IEN1cnNvcgogICAgICAgICAgICB0aGlzLnNob3dOZXh0KCk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSAzNzogLy8gTGVmdCBDdXJzb3IKICAgICAgICAgICAgdGhpcy5zaG93UHJldigpOwogICAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICAKICAgIC8vIGV4ZWN1dGUgcHJldi9uZXh0IG9yIGNsb3NlLCBkZXBlbmRpbmcgb24gdGhlIGFyZWEgY2xpY2tlZC4KICAgIGNsaWNrOiBmdW5jdGlvbihldnQpIHsKICAgICAgdmFyIG1vdXNlQ21kID0gdGhpcy5fbWFwTW91c2VFdmVudChldnQpOwogICAgICBzd2l0Y2gobW91c2VDbWQpIHsKICAgICAgICBjYXNlICduYXYucHJldic6CiAgICAgICAgICB0aGlzLnNob3dQcmV2KCk7CiAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlICduYXYubmV4dCc6CiAgICAgICAgICB0aGlzLnNob3dOZXh0KCk7CiAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlICdFU0MnOgogICAgICAgICAgdGhpcy5jbG9zZVNsaWRlcigpOwogICAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgIH0sCiAgICAKICAgIC8vICJob3ZlciIgZWZmZWN0IGZvciBwcmV2L25leHQgYnV0dG9ucyB3aGlsZSBtb3VzZSBpcyBvdmVyIGltYWdlCiAgICBtb3VzZW1vdmU6IGZ1bmN0aW9uKGV2dCkgewogICAgICB2YXIgbW91c2VDbWQgPSB0aGlzLl9tYXBNb3VzZUV2ZW50KGV2dCk7CiAgICAgIGlmIChtb3VzZUNtZCA9PT0gJ25hdi5wcmV2JykgewogICAgICAgIHRoaXMubmF2TmV4dC5yZW1vdmVDbGFzcygnYWN0aXZlJyk7CiAgICAgICAgdGhpcy5uYXZQcmV2LmFkZENsYXNzKCdhY3RpdmUnKTsKICAgICAgfSBlbHNlIGlmIChtb3VzZUNtZCA9PT0gJ25hdi5uZXh0JykgewogICAgICAgIHRoaXMubmF2UHJldi5yZW1vdmVDbGFzcygnYWN0aXZlJyk7CiAgICAgICAgdGhpcy5uYXZOZXh0LmFkZENsYXNzKCdhY3RpdmUnKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLm5hdlByZXYucmVtb3ZlQ2xhc3MoJ2FjdGl2ZScpOwogICAgICAgIHRoaXMubmF2TmV4dC5yZW1vdmVDbGFzcygnYWN0aXZlJyk7CiAgICAgIH0KICAgIH0sCiAgICAKICAgIC8vIENoZWNrIHdoaWNoIGNvbWFuZCB3b3VsZCBiZSBleGVjdXRlZCBmcm9tIHRoZSBjdXJyZW50IG1vdXNlIHBvc2l0aW9uCiAgICBfbWFwTW91c2VFdmVudDogZnVuY3Rpb24oZXZ0KSB7CiAgICAgIHZhciAkdGFyZ2V0ID0gJChldnQudGFyZ2V0KTsKICAgICAgaWYgKCR0YXJnZXQuaXMoJy5waG90byBpbWcnKSkgewogICAgICAgIC8vIHRvdWNoIGV2ZW50cyBnZXQgdGhlIGN1cnJlbnQgcGFnZSBjb29yZGluYXRlcyBpbiBhbm90aGVyIGZhc2hpb24gdGhhbgogICAgICAgIC8vIHB1cmUgb2xkIGNsaWNrIGV2ZW50cwogICAgICAgIHZhciBwYWdlWCA9ICgKICAgICAgICAgIGV2dC5jaGFuZ2VkVG91Y2hlcyAmJiBldnQuY2hhbmdlZFRvdWNoZXMubGVuZ3RoID8KICAgICAgICAgICAgZXZ0LmNoYW5nZWRUb3VjaGVzWzBdLnBhZ2VYIDoKICAgICAgICAgICAgZXZ0LnBhZ2VYCiAgICAgICAgKTsKICAgICAgICB2YXIgb2Zmc2V0WCA9IHBhZ2VYIC0gJChldnQudGFyZ2V0KS5vZmZzZXQoKS5sZWZ0OwogICAgICAgIHZhciBvZmZzZXRSZWxYID0gb2Zmc2V0WCAvIHRoaXMuY3VycmVudC5nZXRXaWR0aCgpOwogICAgICAgIHJldHVybiAob2Zmc2V0UmVsWCA8IDAuNDUgPyAnbmF2LnByZXYnIDogJ25hdi5uZXh0Jyk7CiAgICAgIH0gZWxzZSBpZiAoJHRhcmdldC5jbG9zZXN0KCcuY29ja3BpdCcpLmxlbmd0aCA9PT0gMCkgewogICAgICAgIC8vICQuY2xvc2VzdCA9PiBhbGwgdGFyZ2V0cyB3aXRoaW4gdGhlIHNwZWNpZmllZCAuY29ja3BpdCBjb250YWluZXIKICAgICAgICByZXR1cm4gJ0VTQyc7CiAgICAgIH0KICAgIH0sCiAgICAKICAgIGlzT3BlbjogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB0aGlzLiRlbC5oYXNDbGFzcygnb3BlbicpOwogICAgfSwKICAgIAogICAgb3BlblNsaWRlcjogZnVuY3Rpb24oaW1hZ2VNb2RlbCkgewogICAgICB0aGlzLl9zZXREaW1lbnNpb25zKCk7CiAgICAgIHRoaXMuX3NldEN1cnJlbnQoaW1hZ2VNb2RlbCk7CiAgICAgIHRoaXMuJGVsLmFkZENsYXNzKCdvcGVuJyk7CiAgICAgICQoJ2JvZHknKS5yZW1vdmVDbGFzcygnc2xpZGVyX2Nsb3NlZCcpOwogICAgICB0aGlzLiRlbC5hZGRDbGFzcygndmlzaWJsZScpOwogICAgICB0aGlzLiRlbC5zd2lwZSgnZW5hYmxlJyk7CiAgICAgIHRoaXMubW9kZWwudG9nZ2xlU2xpZGVyU3RhdGUoKTsKICAgIH0sCiAgICAKICAgIHNob3dOZXh0OiBmdW5jdGlvbigpIHsKICAgICAgaWYgKHRoaXMubmV4dCkgewogICAgICAgIHZhciBuZXdOZXh0Qm94ID0gdGhpcy4kZWwuZmluZCgnI3ByZXYnKTsKICAgICAgICAKICAgICAgICB0aGlzLnByZXYgPSB0aGlzLmN1cnJlbnQ7CiAgICAgICAgdGhpcy5wcmV2Qm94ID0gdGhpcy5jdXJyZW50Qm94LmF0dHIoJ2lkJywncHJldicpOwogICAgICAgIHRoaXMuY3VycmVudCA9IHRoaXMubmV4dDsKICAgICAgICB0aGlzLm1vZGVsLnNldEN1cnJlbnQodGhpcy5uZXh0Lm1vZGVsKTsKICAgICAgICB0aGlzLmN1cnJlbnRCb3ggPSB0aGlzLm5leHRCb3guYXR0cignaWQnLCdjdXJyZW50Jyk7CiAgICAgICAgdGhpcy5uZXh0Qm94ID0gbmV3TmV4dEJveC5hdHRyKCdpZCcsJ25leHQnKTsKICAgICAgICAKICAgICAgICB0aGlzLnByZXZCb3gudG9nZ2xlQ2xhc3MoJ2N1cnJlbnQgcHJldicpOwogICAgICAgIHRoaXMuY3VycmVudEJveC50b2dnbGVDbGFzcygnbmV4dCBjdXJyZW50Jyk7CiAgICAgICAgdGhpcy5uZXh0Qm94LnRvZ2dsZUNsYXNzKCdwcmV2IG5leHQnKTsKICAgICAgICAKICAgICAgICB0aGlzLl9zZXROZXh0KCk7CiAgICAgICAgdGhpcy5fY3VycmVudENoYW5nZWQoKTsKICAgICAgfQogICAgfSwKICAgIAogICAgc2hvd1ByZXY6IGZ1bmN0aW9uKCkgewogICAgICBpZiAodGhpcy5wcmV2KSB7CiAgICAgICAgdmFyIG5ld1ByZXZCb3ggPSB0aGlzLiRlbC5maW5kKCcjbmV4dCcpOwogICAgICAgIAogICAgICAgIHRoaXMubmV4dCA9IHRoaXMuY3VycmVudDsKICAgICAgICB0aGlzLm5leHRCb3ggPSB0aGlzLmN1cnJlbnRCb3guYXR0cignaWQnLCduZXh0Jyk7CiAgICAgICAgdGhpcy5jdXJyZW50ID0gdGhpcy5wcmV2OwogICAgICAgIHRoaXMubW9kZWwuc2V0Q3VycmVudCh0aGlzLnByZXYubW9kZWwpOwogICAgICAgIHRoaXMuY3VycmVudEJveCA9IHRoaXMucHJldkJveC5hdHRyKCdpZCcsJ2N1cnJlbnQnKTsKICAgICAgICB0aGlzLnByZXZCb3ggPSBuZXdQcmV2Qm94LmF0dHIoJ2lkJywgJ3ByZXYnKTsKICAgICAgICAKICAgICAgICB0aGlzLm5leHRCb3gudG9nZ2xlQ2xhc3MoJ2N1cnJlbnQgbmV4dCcpOwogICAgICAgIHRoaXMuY3VycmVudEJveC50b2dnbGVDbGFzcygncHJldiBjdXJyZW50Jyk7CiAgICAgICAgdGhpcy5wcmV2Qm94LnRvZ2dsZUNsYXNzKCduZXh0IHByZXYnKTsKICAgICAgICAKICAgICAgICB0aGlzLl9zZXRQcmV2KCk7CiAgICAgICAgdGhpcy5fY3VycmVudENoYW5nZWQoKTsKICAgICAgfQogICAgfSwKICAgIAogICAgY2xvc2VTbGlkZXI6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLm1vZGVsLnRyaWdnZXIoJ3NsaWRlcjpjbG9zaW5nJywgdGhpcy5jdXJyZW50KTsKICAgIAogICAgICB0aGlzLiRlbC5yZW1vdmVDbGFzcygnb3BlbiB2aXNpYmxlJyk7CiAgICAgICQoJ2JvZHknKS5hZGRDbGFzcygnc2xpZGVyX2Nsb3NlZCcpOwoKICAgICAgdGhpcy5fc2V0Q3VycmVudCh1bmRlZmluZWQpOwogICAgICB0aGlzLmN1cnJlbnQgPSB0aGlzLm5leHQgPSB0aGlzLnBlcnYgPSB1bmRlZmluZWQ7CiAgICAgIAogICAgICB0aGlzLiQoJy5waG90bycpLmVtcHR5KCk7CiAgICAKICAgICAgLy8gdXBkYXRlIGJyb3dzZXIgdXJsCiAgICAgIGlmICh0aGlzLm1vZGVsLmdldCgnaW1hZ2VQYWdlcycpICYmIHRoaXMubW9kZWwuZ2V0KCdwb3N0UGF0aCcpKSB7CiAgICAgICAgaGlzdG9yeS5yZXBsYWNlU3RhdGUobnVsbCwgJycsIHRoaXMubW9kZWwuZ2V0KCdwb3N0UGF0aCcpKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLl9zZXRIYXNoYmFuZyhudWxsLCAnw4RNUFRJJyk7CiAgICAgIH0KICAgIAogICAgICB0aGlzLiRlbC5zd2lwZSgnZGlzYWJsZScpOwogICAgICB0aGlzLm1vZGVsLnRvZ2dsZVNsaWRlclN0YXRlKCk7CiAgICB9LAogICAgCiAgICBfc2V0SGFzaGJhbmc6IGZ1bmN0aW9uKGJhbmdib29tYmFuZywgdGl0bGUpIHsKICAgICAgaWYgKE1vZGVybml6ci5oaXN0b3J5KSB7CiAgICAgICAgdmFyIG5ld0xvYyA9IGRvY3VtZW50LmxvY2F0aW9uLmhyZWY7CiAgICAgICAgbmV3TG9jID0gbmV3TG9jLnJlcGxhY2UoL1wjLiovLCAnJykgKyAoYmFuZ2Jvb21iYW5nID8gJyMhJyArIGJhbmdib29tYmFuZyA6ICcnKTsKICAgICAgICBoaXN0b3J5LnJlcGxhY2VTdGF0ZShudWxsLCB0aXRsZSwgbmV3TG9jKTsKICAgICAgfQogICAgfSwKICAgIAogICAgX2N1cnJlbnRDaGFuZ2VkOiBmdW5jdGlvbigpIHsKICAgICAgLy8gdXBkYXRlIGJyb3dzZXIgdXJsCiAgICAgIGlmICh0aGlzLm1vZGVsLmdldCgnaW1hZ2VQYWdlcycpKSB7CiAgICAgICAgaGlzdG9yeS5yZXBsYWNlU3RhdGUobnVsbCwgJycsIHRoaXMuY3VycmVudC5tb2RlbC5nZXQoJ2ltYWdlUGFnZVBhdGgnKSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5fc2V0SGFzaGJhbmcodGhpcy5jdXJyZW50Lm1vZGVsLmlkLCAnSW1hZ2UgJyArIHRoaXMuY3VycmVudC5tb2RlbC5pZCk7CiAgICAgIH0KICAgICAgCiAgICAgIHRoaXMubW9kZWwudHJpZ2dlcignc2xpZGVyOm5ld0ltYWdlJywgdGhpcy5jdXJyZW50KTsKICAgICAgCiAgICAgIGlmICh0aGlzLm5leHQpIHsgdGhpcy5uYXZOZXh0LnJlbW92ZUNsYXNzKCd2aXN1YWxseWhpZGRlbicpOyB9CiAgICAgIGVsc2UgeyB0aGlzLm5hdk5leHQuYWRkQ2xhc3MoJ3Zpc3VhbGx5aGlkZGVuJyk7IH0KICAgICAgaWYgKHRoaXMucHJldikgeyB0aGlzLm5hdlByZXYucmVtb3ZlQ2xhc3MoJ3Zpc3VhbGx5aGlkZGVuJyk7IH0KICAgICAgZWxzZSB7IHRoaXMubmF2UHJldi5hZGRDbGFzcygndmlzdWFsbHloaWRkZW4nKTsgfQogICAgICAKICAgIH0sCiAgICAKICAgIF9zZXRDdXJyZW50OiBmdW5jdGlvbihpbWFnZU1vZGVsKSB7CiAgICAgIHRoaXMubW9kZWwuc2V0Q3VycmVudChpbWFnZU1vZGVsKTsKICAgICAgdmFyIGxhcmdlVmlldyA9IHRoaXMuX2xvYWRPckdldExhcmdlKGltYWdlTW9kZWwpOwogICAgICBpZiAobGFyZ2VWaWV3KSB7CiAgICAgICAgdGhpcy5jdXJyZW50ID0gbGFyZ2VWaWV3OwogICAgICAgIHRoaXMuY3VycmVudEJveC5odG1sKHRoaXMuY3VycmVudC4kZWwpOwogICAgICAgIHRoaXMuX2N1cnJlbnRDaGFuZ2VkKCk7CiAgICAgICAgdGhpcy5fc2V0TmV4dCgpOwogICAgICAgIHRoaXMuX3NldFByZXYoKTsKICAgICAgfQogICAgfSAsCiAgICAKICAgIF9zZXROZXh0OiBmdW5jdGlvbigpIHsKICAgICAgdGhpcy5uZXh0ID0gdGhpcy5fbG9hZE9yR2V0TGFyZ2UodGhpcy5tb2RlbC5nZXROZXh0KCkpOwogICAgICBpZiAodGhpcy5uZXh0KSB7CiAgICAgICAgdGhpcy5uZXh0Qm94Lmh0bWwodGhpcy5uZXh0LiRlbCk7CiAgICAgICAgdGhpcy5uYXZOZXh0LnJlbW92ZUNsYXNzKCd2aXN1YWxseWhpZGRlbicpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMubmF2TmV4dC5hZGRDbGFzcygndmlzdWFsbHloaWRkZW4nKTsKICAgICAgfQogICAgICByZXR1cm4gdGhpcy5uZXh0OwogICAgfSwKICAgIAogICAgX3NldFByZXY6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLnByZXYgPSB0aGlzLl9sb2FkT3JHZXRMYXJnZSh0aGlzLm1vZGVsLmdldFByZXYoKSk7CiAgICAgIGlmICh0aGlzLnByZXYpIHsKICAgICAgICB0aGlzLnByZXZCb3guaHRtbCh0aGlzLnByZXYuJGVsKTsKICAgICAgICB0aGlzLm5hdlByZXYucmVtb3ZlQ2xhc3MoJ3Zpc3VhbGx5aGlkZGVuJyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5uYXZQcmV2LmFkZENsYXNzKCd2aXN1YWxseWhpZGRlbicpOwogICAgICB9CiAgICAgIHJldHVybiB0aGlzLnByZXY7CiAgICB9LAogICAgCiAgICAvLyBzYXZlIGN1cnJlbnQgdHJheSByZXNvbHV0aW9uIG9uIHRoZSBJbWFnZU1vZGVsIG9yIExhcmdlVmlldwogICAgX2xvYWRPckdldExhcmdlOiBmdW5jdGlvbihpbWFnZU1vZGVsKSB7CiAgICAgIGlmIChpbWFnZU1vZGVsKSB7CiAgICAgICAgdmFyIGxhcmdlVmlldyA9ICgKICAgICAgICAgIGltYWdlTW9kZWwuZ2V0TGFyZ2VWaWV3KCkgfHwKICAgICAgICAgIG5ldyBMYXJnZVZpZXcoewogICAgICAgICAgICBtb2RlbDogaW1hZ2VNb2RlbCwKICAgICAgICAgICAgc2xpZGVyOiB0aGlzCiAgICAgICAgICB9KQogICAgICAgICk7CiAgICAgICAgbGFyZ2VWaWV3LnJlc2l6ZSgpOwogICAgICAgIHJldHVybiBsYXJnZVZpZXc7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgfQogICAgfSwKCiAgICByZXNpemU6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLl9zZXREaW1lbnNpb25zKCk7CiAgICAgIAogICAgICBpZiAodGhpcy5jdXJyZW50KSB7IHRoaXMuY3VycmVudC5yZXNpemUoKTsgfQogICAgICBpZiAodGhpcy5uZXh0KSB7IHRoaXMubmV4dC5yZXNpemUoKTsgfQogICAgICBpZiAodGhpcy5wcmV2KSB7IHRoaXMucHJldi5yZXNpemUoKTsgfQogICAgfSwKICAgIAogICAgX3NldERpbWVuc2lvbnM6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLndpZHRoID0gdGhpcy50cmF5LndpZHRoKCk7CiAgICAgIHRoaXMuaGVpZ2h0ID0gdGhpcy50cmF5LmhlaWdodCgpOwogICAgICB0aGlzLnJhdGlvID0gdGhpcy53aWR0aCAvIHRoaXMuaGVpZ2h0OwogICAgICB0aGlzLm9yaWVudGF0aW9uID0gdGhpcy5yYXRpbyA+IDEgPyAnbGFuZHNjYXBlJyA6ICdwb3J0cmFpdCc7CiAgICB9CiAgICAKICB9KTsKICAKICByZXR1cm4gU2xpZGVyVmlldzsKfSk7CgovKiBTZWxlY3Rpb25Db21wb25lbnQKICogLS0tLS0tLS0tLS0tLS0tCiAqCiAqIEEgdmlldyBDb21wb25lbnQuIEJhc2VjbGFzcyBmb3IgU2VsZWN0aW9uIFZpZXcgQ29tcG9uZW50cy4KICogCiAqIFdhaXRzIGZvciBJbml0aWFsaXphdGlvbiAoc3luYykgb2YgdGhlIENvbGxlY3Rpb24sIGxpc3RlbnMgdG8gY2hhbmdlcyBvZgogKiBDb2xsZWN0aW9uIGFuZCBzZXRzIGFjdGl2ZSBjbGFzcyBvbiBFbGVtZW50LCB3aGVuIENvbGxlY3Rpb24gaXMgbm90IGVtcHR5LgogKgogKiBDb2xsZWN0aW9uOiBTZWxlY3Rpb25Db2xsZWN0aW9uCiAqCiAqLwpkZWZpbmUoJ2dhbGxlcnkvdmlld3Mvc2VsZWN0aW9uL2NvbXBvbmVudCcsWwogICdiYWNrYm9uZScKXSwKZnVuY3Rpb24oQmFja2JvbmUpIHsKCiAgdmFyIFNlbGVjdGlvbkNvbXBvbmVudCA9IEJhY2tib25lLlZpZXcuZXh0ZW5kKHsKCiAgICBpbml0aWFsaXplOiBmdW5jdGlvbigpIHsKICAgICAgaWYgKHRoaXMuJGVsLmxlbmd0aCAmJiB0aGlzLmNvbGxlY3Rpb24pIHsKICAgICAgICB0aGlzLmxpc3RlblRvT25jZSh0aGlzLmNvbGxlY3Rpb24sICdzeW5jJywgdGhpcy5zZWxlY3Rpb25TeW5jZWQpOwogICAgICB9CiAgICB9LAoKICAgIHNlbGVjdGlvblN5bmNlZDogZnVuY3Rpb24oY29sbGVjdGlvbiwgcmVzcCwgb3B0cykgewogICAgICB0aGlzLnJlbmRlcigpOyAvLyB6ZXJvIG9wLCBvdmVycmlkZSwgd2hlbiBuZWVkZWQuCiAgICAgIHRoaXMucmVuZGVyQWN0aXZlKGNvbGxlY3Rpb24ubGVuZ3RoID4gMCk7CiAgICAgIHRoaXMuJGVsLmFkZENsYXNzKCdpbml0aWFsaXplZCcpOwogICAgICB0aGlzLmxpc3RlblRvKHRoaXMuY29sbGVjdGlvbiwgJ2FkZCcsIHRoaXMuaXRlbUFkZGVkKTsKICAgICAgdGhpcy5saXN0ZW5Ubyh0aGlzLmNvbGxlY3Rpb24sICdyZW1vdmUnLCB0aGlzLml0ZW1SZW1vdmVkKTsKICAgIH0sCgogICAgaXRlbUFkZGVkOiBmdW5jdGlvbihtb2RlbCwgY29sLCBvcHRzKSB7CiAgICAgIGlmIChjb2wubGVuZ3RoID09PSAxKSB7CiAgICAgICAgdGhpcy5yZW5kZXJBY3RpdmUodHJ1ZSk7CiAgICAgIH0KICAgICAgdGhpcy5zZWxlY3Rpb25DaGFuZ2VkKG9wdHMpOwogICAgfSwKCiAgICBpdGVtUmVtb3ZlZDogZnVuY3Rpb24obW9kZWwsIGNvbCwgb3B0cykgewogICAgICBpZiAoY29sLmxlbmd0aCA9PT0gMCkgewogICAgICAgIHRoaXMucmVuZGVyQWN0aXZlKGZhbHNlKTsKICAgICAgfQogICAgICB0aGlzLnNlbGVjdGlvbkNoYW5nZWQob3B0cyk7CiAgICB9LAoKICAgIC8vIHplcm8gb3AgaGVyZSwgb3ZlcnJpZGUgdGhpcyBpbiB5b3VyIENsYXNzCiAgICBzZWxlY3Rpb25DaGFuZ2VkOiBmdW5jdGlvbihvcHRzKSB7CiAgICAgIHJldHVybjsKICAgIH0sCgogICAgcmVuZGVyQWN0aXZlOiBmdW5jdGlvbihhY3RpdmUpIHsKICAgICAgaWYgKGFjdGl2ZSkgewogICAgICAgIHRoaXMuJGVsLmFkZENsYXNzKCdhY3RpdmUnKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLiRlbC5yZW1vdmVDbGFzcygnYWN0aXZlJyk7CiAgICAgIH0KICAgIH0KCiAgfSk7CgogIHJldHVybiBTZWxlY3Rpb25Db21wb25lbnQ7Cgp9KTsKCi8qIFNlbGVjdGlvbkluZGljYXRvcgogKiAtLS0tLS0tLS0tLS0tLS0KICoKICogQSB2aWV3IENvbXBvbmVudCBpbmRpY2F0aW5nIHRoZSBudW1iZXIgb2Ygc2VsZWN0ZWQgaW1hZ2VzLiAKICoKICogQ29sbGVjdGlvbjogU2VsZWN0aW9uQ29sbGVjdGlvbgogKgogKi8KZGVmaW5lKCdnYWxsZXJ5L3ZpZXdzL3NlbGVjdGlvbi9pbmRpY2F0b3InLFsKICAnYmFja2JvbmUnLAogICdnYWxsZXJ5L3ZpZXdzL3NlbGVjdGlvbi9jb21wb25lbnQnCl0sCmZ1bmN0aW9uKEJhY2tib25lLCBTZWxlY3Rpb25Db21wb25lbnQpIHsKCiAgdmFyIFNlbGVjdGlvbkluZGljYXRvciA9IFNlbGVjdGlvbkNvbXBvbmVudC5leHRlbmQoewoKICAgIC8vIHRoZSBvbmVzIHdpdGggZGF0YS1zZWxlY3Rpb24gZ2V0IHRoZWlyIGVsZW1lbnRzIHBhc3NlZCBpbiBleHBsaWNpdGx5IChzZWUgYXBwLmpzKQogICAgZWw6ICcuc2VsZWN0aW9uIC5pbmRpY2F0b3I6bm90KFtkYXRhLXNlbGVjdGlvbl0pJywKCiAgICBzZWxlY3Rpb25DaGFuZ2VkOiBmdW5jdGlvbihvcHRzKSB7CiAgICAgIHRoaXMucmVuZGVyKCk7CiAgICB9LAoKICAgIHJlbmRlcjogZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMuJGVsLmh0bWwodGhpcy5jb2xsZWN0aW9uLmxlbmd0aCk7CiAgICB9CgogIH0pOwoKICByZXR1cm4gU2VsZWN0aW9uSW5kaWNhdG9yOwoKfSk7CgovKiBTZWxlY3Rpb25Ub2dnbGVCdXR0b24KICogLS0tLS0tLS0tLS0tLS0tCiAqCiAqIEEgdmlldyBDb21wb25lbnQgZm9yIHRvZ2dsaW5nIGJldHdlZW4gdGhlIEltYWdlcyBpbiB0aGUgc2VsZWN0aW9uIGFuZCBhbGwgdGhlIAogKiBpbWFnZXMgb2YgdGhlIGN1cnJlbnQgZ2FsbGVyeS4KICoKICogQ29sbGVjdGlvbjogU2VsZWN0aW9uQ29sbGVjdGlvbgogKgogKi8KZGVmaW5lKCdnYWxsZXJ5L3ZpZXdzL3NlbGVjdGlvbi90b2dnbGUuYnV0dG9uJyxbCiAgJ3VuZGVyc2NvcmUnLAogICdiYWNrYm9uZScsCiAgJ2dhbGxlcnkvdmlld3Mvc2VsZWN0aW9uL2NvbXBvbmVudCcKXSwKZnVuY3Rpb24oXywgQmFja2JvbmUsIFNlbGVjdGlvbkNvbXBvbmVudCkgewoKICB2YXIgU2VsZWN0aW9uVG9nZ2xlQnV0dG9uID0gU2VsZWN0aW9uQ29tcG9uZW50LmV4dGVuZCh7CgogICAgZWw6ICcuc2VsZWN0aW9uIC5idXR0b24udG9nZ2xlJywKCiAgICBldmVudHM6IHsKICAgICAgJ2NsaWNrJzogJ3RvZ2dsZScKICAgIH0sCgogICAgdG9nZ2xlOiBmdW5jdGlvbigpIHsKICAgICAgaWYgKHRoaXMuJGVsLmhhc0NsYXNzKCdhY3RpdmUnKSkgewogICAgICAgIHRoaXMuZmlsdGVyKCk7CiAgICAgIH0KICAgIH0sCgogICAgZmlsdGVyOiBmdW5jdGlvbigpIHsKICAgICAgdmFyIGdhbGxlcnlJbWFnZXMgPSB0aGlzLmNvbGxlY3Rpb24uZ2FsbGVyeS5nZXQoJ2ltYWdlcycpOwogICAgICAKICAgICAgaWYgKCF0aGlzLiRlbC5oYXNDbGFzcygnZmlsdGVyZWQnKSkgeyAgICAgLy8gZmlsdGVyIHNlbGVjdGVkCiAgICAgICAgdGhpcy51bmZpbHRlcmVkSW1hZ2VzID0gbmV3IEJhY2tib25lLkNvbGxlY3Rpb24oZ2FsbGVyeUltYWdlcy5tb2RlbHMpOwogICAgICAgIGdhbGxlcnlJbWFnZXMucmVzZXQodGhpcy5jb2xsZWN0aW9uLm1vZGVscyk7CiAgICAgIH0gZWxzZSB7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHVuZmlsdGVyIHNlbGVjdGVkCiAgICAgICAgZ2FsbGVyeUltYWdlcy5yZXNldCh0aGlzLnVuZmlsdGVyZWRJbWFnZXMubW9kZWxzKTsKICAgICAgICB0aGlzLnVuZmlsdGVyZWRJbWFnZXMgPSB1bmRlZmluZWQ7CiAgICAgIH0KICAgICAgdGhpcy4kZWwudG9nZ2xlQ2xhc3MoJ2ZpbHRlcmVkJyk7CiAgICB9LAoKICAgIC8vIFdoZW4gYW4gaXRlbSBnZXRzIHJlbW92ZWQgYW5kIHRoZSBzZWxlY3Rpb24gaXMgY3VycmVudGx5IHRvZ2dsZWQgKGZpbHRlcmVkKSwgCiAgICAvLyB0aGVuIHdlIG5lZWQgdG8gInN5bmNocm9uaXplIiB0aGUgY29ycmVzcG9uZGluZyBJbWFnZU1vZGVsIG9iamVjdCBpbiB0aGUgCiAgICAvLyB1bmZpbHRlcmVkIGNvbGxlY3Rpb24uCiAgICBpdGVtUmVtb3ZlZDogZnVuY3Rpb24obW9kZWwsIGNvbCwgb3B0cykgewogICAgICBpZiAodGhpcy51bmZpbHRlcmVkSW1hZ2VzKSB7CiAgICAgICAgdmFyIGltYWdlTW9kZWwgPSB0aGlzLnVuZmlsdGVyZWRJbWFnZXMuZ2V0KG1vZGVsLmlkKTsKICAgICAgICBpZiAoaW1hZ2VNb2RlbCkgewogICAgICAgICAgaW1hZ2VNb2RlbC5zZXQoJ3NlbGVjdGVkJywgZmFsc2UpOwogICAgICAgIH0KICAgICAgfQogICAgICBTZWxlY3Rpb25Db21wb25lbnQucHJvdG90eXBlLml0ZW1SZW1vdmVkLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9LAoKICAgIHNlbGVjdGlvbkNoYW5nZWQ6IGZ1bmN0aW9uKG9wdHMpIHsKICAgICAgLy8gdG9nZ2xlIGZpbHRlciBpZiBzZWxlY3Rpb24gZW1wdHkgYW5kIGN1cnJlbnRseSBmaWx0ZXJlZC4KICAgICAgaWYgKHRoaXMuY29sbGVjdGlvbi5sZW5ndGggPT09IDAgJiYgdGhpcy4kZWwuaGFzQ2xhc3MoJ2ZpbHRlcmVkJykpIHsKICAgICAgICB0aGlzLmZpbHRlcigpOwogICAgICB9CiAgICB9CgogIH0pOwoKICByZXR1cm4gU2VsZWN0aW9uVG9nZ2xlQnV0dG9uOwoKfSk7CgovKiBTZWxlY3Rpb25QZGZCdXR0b24KICogLS0tLS0tLS0tLS0tLS0tLS0tLQogKgogKiBBIFZpZXcgQ29tcG9uZW50LiBTZW5kcyB0aGUgc2VsZWN0ZWQgSW1hZ2VzIHRvIGEgcmVtb3RlIFNlcnZpY2Ugc3BlY2lmaWVkIHZpYQogKiB0aGUgZGF0YS11cmwgYXR0cmlidXRlLCB3aGljaCBnZW5lcmF0ZXMgYSBQREYgRm9saW8gZm9yIHRoZSBTZWxlY3Rpb24uCiAqCiAqIFRoZSBDb21wb25lbnQgbmVlZHMgdG8gc3BlY2lmeSBkYXRhLWtleSBhbmQgZGF0YS10aXRsZSBmb3IgdGhlIFBERiBzZXJ2aWNlIHRvCiAqIHdvcmsuIFRoZSBtYXJrdXAgZm9yIHRoaXMgY29tcG9uZW50IHRvIGdldCBhY3RpdmF0ZWQ6CiAqCiAqIGBgPHNwYW4gY2xhc3M9InBkZiBidXR0b24iIHRpdGxlPSJkb3dubG9hZCBzZWxlY3RlZCBwaG90b3MgYXMgUERGIGRvY3VtZW50IiAKICogICAgICAgICBkYXRhLXVybD0iaHR0cDovL3BkZi1nZW4taG9zdC5vcmcvYXBpIiAKICogICAgICAgICBkYXRhLXRpdGxlPSJUaXRsZSBmb3IgRm9saW8iIAogKiAgICAgICAgIGRhdGEta2V5PSJzaXRlLWtleSI+PC9zcGFuPmBgCiAqCiAqIENvbGxlY3Rpb246IFNlbGVjdGlvbkNvbGxlY3Rpb24KICovCmRlZmluZSgnZ2FsbGVyeS92aWV3cy9zZWxlY3Rpb24vcGRmLmJ1dHRvbicsWwogICdiYWNrYm9uZScsCiAgJ2dhbGxlcnkvdmlld3Mvc2VsZWN0aW9uL2NvbXBvbmVudCcKXSwgZnVuY3Rpb24oQmFja2JvbmUsIFNlbGVjdGlvbkNvbXBvbmVudCkgewoKICB2YXIgU2VsZWN0aW9uUGRmQnV0dG9uID0gU2VsZWN0aW9uQ29tcG9uZW50LmV4dGVuZCh7CgogICAgZWw6ICcuc2VsZWN0aW9uIC5idXR0b24ucGRmJywKCiAgICBldmVudHM6IHsKICAgICAgJ2NsaWNrJzogJ2Rvd25sb2FkQ2xpY2snCiAgICB9LAoKICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uKCkgewogICAgICBpZiAodGhpcy4kZWwubGVuZ3RoICYmIHRoaXMuY29sbGVjdGlvbikgewogICAgICAgIC8vIFByZXBhcmUgRGF0YSBmb3IgUERGIFJlcXVlc3QKICAgICAgICB0aGlzLmZvbGlvRGF0YSA9IHt9OwogICAgICAgIHRoaXMuZm9saW9EYXRhLnVybCA9IHRoaXMuJGVsLmRhdGEoJ3VybCcpOwogICAgICAgIHRoaXMuZm9saW9EYXRhLnRpdGxlID0gdGhpcy4kZWwuZGF0YSgndGl0bGUnKTsKICAgICAgICB0aGlzLmZvbGlvRGF0YS5rZXkgPSB0aGlzLiRlbC5kYXRhKCdrZXknKTsKICAgICAgICB0aGlzLmZvbGlvRGF0YS50ZW1wbGF0ZSA9IHRoaXMuJGVsLmRhdGEoJ3RlbXBsYXRlJyk7CiAgICAgICAgCiAgICAgICAgU2VsZWN0aW9uQ29tcG9uZW50LnByb3RvdHlwZS5pbml0aWFsaXplLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIH0KICAgIH0sCgogICAgZG93bmxvYWRDbGljazogZnVuY3Rpb24oKSB7CiAgICAgIGlmICh0aGlzLiRlbC5oYXNDbGFzcygnYWN0aXZlJykpIHsKICAgICAgICB0aGlzLnJlbmRlckxvYWRpbmcoKTsKICAgICAgICAkLmFqYXgoewogICAgICAgICAgICB0eXBlOiAnUE9TVCcsCiAgICAgICAgICAgIHVybDogdGhpcy5mb2xpb0RhdGEudXJsLAogICAgICAgICAgICBkYXRhOiBKU09OLnN0cmluZ2lmeSgKICAgICAgICAgICAgICB0aGlzLmdldFBkZkdlblBheWxvYWQoKQogICAgICAgICAgICApLAogICAgICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbihkYXRhKSB7CiAgICAgICAgICAgICAgaWYgKGRhdGEuZm9saW8uZXhpc3RzKSB7CiAgICAgICAgICAgICAgICB0aGlzLmRvd25sb2FkUGRmKGRhdGEuZm9saW8udXJsKTsKICAgICAgICAgICAgICAgIHRoaXMucmVuZGVyQWN0aXZlKHRoaXMuY29sbGVjdGlvbi5sZW5ndGggPiAwKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy50cnlBZ2FpbihkYXRhLmZvbGlvLnVybCwgMTUwMCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LmJpbmQodGhpcyksCiAgICAgICAgICAgIGVycm9yOiBmdW5jdGlvbihyZXNwKSB7CiAgICAgICAgICAgICAgdGhpcy5yZW5kZXJFcnJvcigpOwogICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdTb21ldGhpbmcgd2VudCB3cm9uZyB3aGlsZSBnZW5lcmF0aW5nIHRoZSBQREYhJywgcmVzcCk7CiAgICAgICAgICAgIH0uYmluZCh0aGlzKSwKICAgICAgICAgICAgY29udGVudFR5cGU6ICdhcHBsaWNhdGlvbi9qc29uJywKICAgICAgICAgICAgZGF0YVR5cGU6ICdqc29uJwogICAgICAgICAgfSk7CiAgICAgIH0KICAgIH0sCgogICAgdHJ5QWdhaW46IGZ1bmN0aW9uKHVybCwgZGVsYXkpIHsKICAgICAgJC5hamF4KHsKICAgICAgICB0eXBlOiAnSEVBRCcsCiAgICAgICAgdXJsOiB1cmwsCiAgICAgICAgc3VjY2VzczogZnVuY3Rpb24ocmVzcCkgewogICAgICAgICAgd2luZG93LmNsZWFyVGltZW91dCh0aGlzLnRpbWVvdXRJZCk7CiAgICAgICAgICB0aGlzLmRvd25sb2FkUGRmKHVybCk7CiAgICAgICAgICB0aGlzLnJlbmRlckFjdGl2ZSh0aGlzLmNvbGxlY3Rpb24ubGVuZ3RoID4gMCk7CiAgICAgICAgfS5iaW5kKHRoaXMpLAogICAgICAgIGVycm9yOiBmdW5jdGlvbihyZXNwKSB7CiAgICAgICAgICB3aW5kb3cuY2xlYXJUaW1lb3V0KHRoaXMudGltZW91dElkKTsKICAgICAgICAgIHRoaXMudGltZW91dElkID0gc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgdGhpcy50cnlBZ2Fpbih1cmwsIGRlbGF5KTsKICAgICAgICAgIH0uYmluZCh0aGlzKSwgZGVsYXkpOwogICAgICAgIH0uYmluZCh0aGlzKQogICAgICB9KTsKICAgIH0sCgogICAgZG93bmxvYWRQZGY6IGZ1bmN0aW9uKHVybCkgewogICAgICB3aW5kb3cubG9jYXRpb24uaHJlZiA9IHVybDsKICAgIH0sCgogICAgLy8gVE9ETzogcmF1cyBoaWVyLCBlbnR3ZWRlciBpbiBkaWUgU2VsZWN0aW9uIG9kZXIgaW4gZGVuIFNlcnZlciwgZGFzIGlzdCAKICAgIC8vIE1vZGVsIGJ1c2luZXNzIQogICAgZ2V0UGRmR2VuUGF5bG9hZDogZnVuY3Rpb24oKSB7CiAgICAgIHZhciBmb2xpb1BheWxvYWQgPSB7CiAgICAgICAgdGl0bGU6IHRoaXMuZm9saW9EYXRhLnRpdGxlLAogICAgICAgIGtleTogdGhpcy5mb2xpb0RhdGEua2V5LAogICAgICAgIHRlbXBsYXRlOiB0aGlzLmZvbGlvRGF0YS50ZW1wbGF0ZSwKICAgICAgICBpbWFnZXM6IFtdCiAgICAgIH07CiAgICAgIHRoaXMuY29sbGVjdGlvbi5lYWNoKGZ1bmN0aW9uKGltYWdlTW9kZWwpIHsKICAgICAgICBmb2xpb1BheWxvYWQuaW1hZ2VzLnB1c2goewogICAgICAgICAgJ3VybCc6IGltYWdlTW9kZWwuZ2V0KCdsYXJnZScpLnNyYwogICAgICAgIH0pOwogICAgICB9KTsKICAgICAgcmV0dXJuIHtmb2xpbzogZm9saW9QYXlsb2FkfTsKICAgIH0sCgogICAgcmVuZGVyRXJyb3I6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLiRlbC5yZW1vdmVDbGFzcygnbG9hZGluZyBhY3RpdmUnKTsKICAgICAgdGhpcy4kZWwuYWRkQ2xhc3MoJ2Vycm9yJyk7CiAgICAgIHRoaXMuJGVsLmh0bWwoJ0Rvd25sb2FkIFBERicpOwogICAgICB0aGlzLiRlbC5hdHRyKCd0aXRsZScsICdTb21ldGhpbmcgd2VudCB3cm9uZzogU2VydmVyIEVycm9yISBUcnkgYWdhaW4gaW4gYSBtb21lbnQnKTsKICAgIH0sCgogICAgcmVuZGVyTG9hZGluZzogZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMuJGVsLmh0bWwoJ0xvYWRpbmcgUERGJyk7CiAgICAgIHRoaXMuJGVsLnJlbW92ZUNsYXNzKCdhY3RpdmUnKTsKICAgICAgdGhpcy4kZWwuYWRkQ2xhc3MoJ2xvYWRpbmcnKTsKICAgIH0sCgogICAgcmVuZGVyQWN0aXZlOiBmdW5jdGlvbihhY3RpdmUpIHsKICAgICAgdGhpcy4kZWwuaHRtbCgnRG93bmxvYWQgUERGJyk7CiAgICAgIHRoaXMuJGVsLnJlbW92ZUNsYXNzKCdsb2FkaW5nJyk7CiAgICAgIFNlbGVjdGlvbkNvbXBvbmVudC5wcm90b3R5cGUucmVuZGVyQWN0aXZlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9CgogIH0pOwoKICByZXR1cm4gU2VsZWN0aW9uUGRmQnV0dG9uOwp9KTsKCi8qIGpzaGludCBjYW1lbGNhc2U6IGZhbHNlICovCi8qCiAqIEdhbGxlcnkgQXBwCiAqCiAqIE9wdGlvbnM6CiAqIC0gZWw6IEVsZW1lbnQgdG8gaW5pdGlhbGl6ZSB0aGUgR2FsbGVyeSBvbi4KICogLSBvbkluaXQ6IENhbGxiYWNrIGZvciB3aGVuIHRoZSBHYWxsZXJ5QXBwIGlzIGluaXRpYWxpemVkICh0aGUgSW1hZ2VzIGFyZSAKICogICAgICAgICAgIGxvYWRlZCkuIFRoZSBjYWxsYmFjayByZWNlaXZlcyB0byBhcmdzOiBHYWxsZXJ5QXBwIGFuZCBHYWxsZXJ5TW9kZWwKICogLSBnYWxsZXJ5T3B0czogb3B0cyBmb3IgdGhlIGdhbGxlcnkgKG92ZXJyaWRlIHRoZSBvbmVzIGluIHRoZSBnYWxsZXJ5IERPTSAKICAgICAgICAgICAgICAgICAgZWxlbWVudCAoZGF0YS1nYWwtb3B0cykgYW5kIHRoZSBnYWxsZXJ5IGpzb24pLgogKi8KZGVmaW5lKCdnYWxsZXJ5L2FwcCcsWwogICdiYWNrYm9uZScsCiAgJ3VuZGVyc2NvcmUnLAogICdnYWxsZXJ5L21vZGVscy9nYWxsZXJ5LmZhY3RvcnknLAogICdnYWxsZXJ5L3ZpZXdzL3RodW1iLmNvbnRhaW5lci5tYXNvbnJ5JywKICAnZ2FsbGVyeS92aWV3cy90aHVtYi5jb250YWluZXIuZHluYW1pYycsCiAgJ2dhbGxlcnkvdmlld3MvdGh1bWIuY29udGFpbmVyLmR5bmFtaWMubWFzb25yeScsCiAgJ2dhbGxlcnkvdmlld3Mvc2xpZGVyLnZpZXcnLAogICdnYWxsZXJ5L3V0aWxzL3Jlc3BvbnNpdmUuYWRhcHRlcicsCiAgJ2dhbGxlcnkvY29sbGVjdGlvbnMvc2VsZWN0aW9uLmNvbGxlY3Rpb24nLAogICdnYWxsZXJ5L3ZpZXdzL3NlbGVjdGlvbi9jb21wb25lbnQnLAogICdnYWxsZXJ5L3ZpZXdzL3NlbGVjdGlvbi9pbmRpY2F0b3InLAogICdnYWxsZXJ5L3ZpZXdzL3NlbGVjdGlvbi90b2dnbGUuYnV0dG9uJywKICAnZ2FsbGVyeS92aWV3cy9zZWxlY3Rpb24vcGRmLmJ1dHRvbicKXSwKZnVuY3Rpb24oCiAgQmFja2JvbmUsIF8sIEdhbGxlcnlGYWN0b3J5LAogIFRodW1iQ29udGFpbmVyTWFzb25yeSwgVGh1bWJDb250YWluZXJEeW5hbWljLCBUaHVtYkNvbnRhaW5lckR5bmFtaWNNYXNvbnJ5LAogIFNsaWRlclZpZXcsIFJlc3BvbnNpdmVBZGFwdGVyLAogIFNlbGVjdGlvbkNvbGxlY3Rpb24sIFNlbGVjdGlvbkNvbXBvbmVudCwgU2VsZWN0aW9uSW5kaWNhdG9yLAogIFNlbGVjdGlvblRvZ2dsZUJ1dHRvbiwgU2VsZWN0aW9uUGRmQnV0dG9uCikgewogIAogIHZhciBHYWxsZXJ5QXBwID0gQmFja2JvbmUuVmlldy5leHRlbmQoewogICAgCiAgICBlbDogJ2FydGljbGUuZ2FsbGVyeScsCgogICAgLy8gZGVmYXVsdCBvcHRpb25zIGZvciBnYWxsZXJ5IGFwcAogICAgZGVmYXVsdE9wdHM6IHsKICAgICAgbGF5b3V0OiAnbWFzb25yeScKICAgIH0sCgogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24ob3B0cykgewoKICAgICAgLy8gZ2V0IG9wdGlvbnMKICAgICAgaWYgKHRoaXMuJGVsLmRhdGEoJ2dhbC1sYXlvdXQnKSkgewogICAgICAgIHRoaXMuZGVmYXVsdE9wdHMubGF5b3V0ID0gdGhpcy4kZWwuZGF0YSgnZ2FsLWxheW91dCcpOwogICAgICB9CiAgICAgIHRoaXMub3B0aW9ucyA9IF8uZXh0ZW5kKHt9LCB0aGlzLmRlZmF1bHRPcHRzLCB0aGlzLm9wdGlvbnMpOwoKICAgICAgLy8gSW5pdCBHYWxsZXJ5TW9kZWwKICAgICAgdGhpcy5tb2RlbCA9IEdhbGxlcnlGYWN0b3J5LmNyZWF0ZSh0aGlzLiRlbCwgb3B0c1snZ2FsbGVyeU9wdHMnXSk7CgogICAgICAvLyBJbml0IFNlbGVjdGlvbgogICAgICB0aGlzLmluaXRTZWxlY3Rpb24oKTsKCiAgICAgIGlmICh0aGlzLm1vZGVsKSB7CiAgICAgICAgLy8gSW5pdCBUaHVtYkNvbnRhaW5lclZpZXcKICAgICAgICB0aGlzLmluaXRUaHVtYkNvbnRhaW5lcigpOwogICAgICAgIAogICAgICAgIC8vIEZldGNoIEdhbGxlcnkgRGF0YSBmcm9tIFNlcnZlcgogICAgICAgIHRoaXMubW9kZWwuZmV0Y2goewogICAgICAgICAgc3VjY2VzczogXy5iaW5kKGZ1bmN0aW9uKG1vZGVsLCByZXNwLCBfb3B0cykgewogICAgICAgICAgICB2YXIgJGVsID0gdGhpcy4kZWw7CiAgICAgICAgICAgIC8vIG1hcmsgRE9NIEVsZW1lbnQgYXMgaW5pdGlhbGl6ZWQKICAgICAgICAgICAgJGVsLmFkZENsYXNzKCdpbml0aWFsaXplZCcpOwogICAgICAgICAgICAvLyBtYXJrIERPTSBFbGVtZW50IGFzIGVtcHR5CiAgICAgICAgICAgIGlmIChtb2RlbC5nZXQoJ2ltYWdlcycpLmlzRW1wdHkoKSkgewogICAgICAgICAgICAgICRlbC5hZGRDbGFzcygnZW1wdHknKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBsaXN0ZW5UbyByZW1vdmUgRXZlbnRzID0+IG1hcmsgZW1wdHkKICAgICAgICAgICAgdGhpcy5saXN0ZW5Ubyhtb2RlbC5nZXQoJ2ltYWdlcycpLCAncmVtb3ZlJywgZnVuY3Rpb24obSxjLG8pIHsKICAgICAgICAgICAgICBpZiAoYy5pc0VtcHR5KCkpIHsgJGVsLmFkZENsYXNzKCdlbXB0eScpOyB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBpZiAob3B0cy5vbkluaXQpIHsgb3B0cy5vbkluaXQodGhpcywgdGhpcy5tb2RlbCk7IH0KICAgICAgICAgIH0sIHRoaXMpCiAgICAgICAgfSk7CgogICAgICAgIC8vIEluc3RhbmNpYXRlIHRoZSBTbGlkZXJWaWV3CiAgICAgICAgdGhpcy5pbml0U2xpZGVyKCk7CgogICAgICAgIC8vIG1ha2UgZ2FsbGVyeSBvYmplY3QgYXZhaWxhYmxlIGluIERPTQogICAgICAgIHRoaXMuJGVsLmRhdGEoJ2dhbGxlcnknLCB0aGlzKTsKICAgICAgfQogICAgfSwKCiAgICAvLyBJbml0IFNlbGVjdGlvbnMKICAgIGluaXRTZWxlY3Rpb246IGZ1bmN0aW9uKCkgewogICAgICAvLyBHbG9iYWwgU2VsZWN0aW9uQ29sbGVjdGlvbiBmb3IgZ2FsbGVyeSBvbmx5IHdoZW4gdGhlcmUgaXMgdGhlIAogICAgICAvLyBkYXRhIGF0dHJpYiBkYXRhLWdhbC1zZWxlY3RvcgogICAgICB2YXIgZ2FsU2VsZWN0aW9uQXR0cmliID0gdGhpcy4kZWwuZGF0YSgnZ2FsLXNlbGVjdGlvbicpOwogICAgICBpZiAoISFnYWxTZWxlY3Rpb25BdHRyaWIpIHsKICAgICAgICAvLyBpbml0IHNlbGVjdGlvbiBjb2xsZWN0aW9uCiAgICAgICAgdGhpcy5zZWxlY3Rpb24gPSBTZWxlY3Rpb25Db2xsZWN0aW9uLmdldCh0aGlzLiRlbC5kYXRhKCdnYWwtc2VsZWN0aW9uJyksIHRoaXMubW9kZWwpOwoKICAgICAgICAvLyBpbml0IHNlbGVjdGlvbiBpbmRpY2F0b3IKICAgICAgICB0aGlzLnNlbGVjdGlvbkluZGljYXRvciA9IG5ldyBTZWxlY3Rpb25JbmRpY2F0b3IoewogICAgICAgICAgY29sbGVjdGlvbjogdGhpcy5zZWxlY3Rpb24KICAgICAgICB9KTsKCiAgICAgICAgLy8gaW5pdCB0b2dnbGUgYnV0dG9uCiAgICAgICAgdGhpcy5zZWxlY3Rpb25Ub2dnbGVCdXR0b24gPSBuZXcgU2VsZWN0aW9uVG9nZ2xlQnV0dG9uKHsKICAgICAgICAgIGNvbGxlY3Rpb246IHRoaXMuc2VsZWN0aW9uCiAgICAgICAgfSk7CgogICAgICAgIC8vIGluaXQgcGRmIGJ1dHRvbgogICAgICAgIHRoaXMuc2VsZWN0aW9uUGRmQnV0dG9uID0gbmV3IFNlbGVjdGlvblBkZkJ1dHRvbih7CiAgICAgICAgICBjb2xsZWN0aW9uOiB0aGlzLnNlbGVjdGlvbgogICAgICAgIH0pOwoKICAgICAgICAvLyBpbml0IHNlbGVjdGlvbiBjb21wb25lbnRzLCB3aGljaCBvbmx5IG5lZWQgdG8gYmUgaW5pdGlhbGl6ZWQgYW5kIHNldCBhY3RpdmUvaW5hY3RpdmUKICAgICAgICBuZXcgU2VsZWN0aW9uQ29tcG9uZW50KHsKICAgICAgICAgIGVsOiAkKCcuc2VsZWN0aW9uIC5jb21wb25lbnQnKSwKICAgICAgICAgIGNvbGxlY3Rpb246IHRoaXMuc2VsZWN0aW9uCiAgICAgICAgfSk7CiAgICAgIH0KCiAgICAgIC8vIEV4cGxpY2l0bHkgYWRkcmVzc2VkIHNlbGVjdGlvbiBpbmRpY2F0b3JzCiAgICAgIC8vIEdyb3VwIHRoZW0gYnkgc2VsZWN0aW9uIGtleXMKICAgICAgdmFyIG1hcHBpbmcgPSB7fTsKICAgICAgJCgnW2RhdGEtc2VsZWN0aW9uXS5pbmRpY2F0b3InKS5lYWNoKGZ1bmN0aW9uKCkgewogICAgICAgIHZhciAkZWwgPSAkKHRoaXMpOwogICAgICAgIG1hcHBpbmdbJGVsLmRhdGEoJ3NlbGVjdGlvbicpXSA9CiAgICAgICAgICBtYXBwaW5nWyRlbC5kYXRhKCdzZWxlY3Rpb24nKV0gPT09IHVuZGVmaW5lZCA/ICRlbCA6IG1hcHBpbmdbJGVsLmRhdGEoJ3NlbGVjdGlvbicpXS5hZGQoJGVsKTsKICAgICAgfSk7CiAgICAgIC8vIGluaXRpYWxpemUgYSBpbmRpY2F0b3IgdmlldyBmb3IgZXZlcnkgc2VsZWN0aW9uIGtleS4KICAgICAgXy5lYWNoKG1hcHBpbmcsIGZ1bmN0aW9uKCRlbGVtZW50cywga2V5KSB7CiAgICAgICAgdmFyIHNlbCA9IFNlbGVjdGlvbkNvbGxlY3Rpb24uZ2V0KGtleSwgdGhpcy5tb2RlbCk7CiAgICAgICAgbmV3IFNlbGVjdGlvbkluZGljYXRvcih7IGNvbGxlY3Rpb246IHNlbCwgZWw6ICRlbGVtZW50cyB9KTsKICAgICAgICBpZiAoc2VsLmdhbGxlcnkgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgc2VsLmZldGNoKCk7CiAgICAgICAgfQogICAgICB9LCB0aGlzKTsKICAgIH0sCgogICAgLy8gSW5zdGFuY2lhdGUgdGhlIFRodW1iQ29udGFpbmVyVmlldyAoZHluYW1pYyBvciBzdGFuZGFyZD8pCiAgICBpbml0VGh1bWJDb250YWluZXI6IGZ1bmN0aW9uKCkgewogICAgICB2YXIgdGh1bWJDb250YWluZXJPcHRpb25zID0gewogICAgICAgIG1vZGVsOiB0aGlzLm1vZGVsLAogICAgICAgIGl0ZW1TZWxlY3RvcjogJy5waG90bycKICAgICAgfTsKICAgICAgCiAgICAgIC8vIG5vdGhpbmcgZHluYW1pYywgYWxsIHBob3RvcyBhcmUgcmVuZGVyZWQgYXQgbG9hZGluZyB0aW1lCiAgICAgIGlmICh0aGlzLiQoJy5jb250YWluZXIucGhvdG9zIC5waG90bycpLmxlbmd0aCkgewogICAgICAgIHRoaXMuY29udGFpbmVyVmlldyA9IG5ldyBUaHVtYkNvbnRhaW5lck1hc29ucnkodGh1bWJDb250YWluZXJPcHRpb25zKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAodGhpcy5vcHRpb25zLmxheW91dCA9PT0gJ25vbmUnKSB7CiAgICAgICAgICB0aGlzLmNvbnRhaW5lclZpZXcgPSBuZXcgVGh1bWJDb250YWluZXJEeW5hbWljKHRodW1iQ29udGFpbmVyT3B0aW9ucyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXMuY29udGFpbmVyVmlldyA9IG5ldyBUaHVtYkNvbnRhaW5lckR5bmFtaWNNYXNvbnJ5KHRodW1iQ29udGFpbmVyT3B0aW9ucyk7CiAgICAgICAgfQogICAgICB9CiAgICB9LAoKICAgIC8vIEluc3RhbmNpYXRlIHRoZSBTbGlkZXIgdmlldwogICAgaW5pdFNsaWRlcjogZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMuc2xpZGVyVmlldyA9IG5ldyBTbGlkZXJWaWV3KHsKICAgICAgICBlbDogdGhpcy4kKCcuc2xpZGVyJyksCiAgICAgICAgbW9kZWw6IHRoaXMubW9kZWwKICAgICAgfSk7CiAgICB9LAoKICAgIC8vIEdpdmUgYXBwIHVzZXIgYWNjZXNzIHRvIHRoZSBSZXNwb25zaXZlQWRhcHRlcgogICAgZ2V0UmVzcG9uc2l2ZUFkYXB0ZXI6IGZ1bmN0aW9uKCkgewogICAgICBpZiAodGhpcy5yZXNwb25zaXZlQWRhcHRlciA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgdGhpcy5yZXNwb25zaXZlQWRhcHRlciA9IFJlc3BvbnNpdmVBZGFwdGVyOwogICAgICB9CiAgICAgIHJldHVybiB0aGlzLnJlc3BvbnNpdmVBZGFwdGVyOwogICAgfQoKICB9KTsKICAKICByZXR1cm4gR2FsbGVyeUFwcDsKCn0pOwoKLyoganNoaW50IGlnbm9yZTpzdGFydCAqLwogICAgLy9UaGUgbW9kdWxlcyBmb3IgeW91ciBwcm9qZWN0IHdpbGwgYmUgaW5saW5lZCBhYm92ZQogICAgLy90aGlzIHNuaXBwZXQuIEFzayBhbG1vbmQgdG8gc3luY2hyb25vdXNseSByZXF1aXJlIHRoZQogICAgLy9tb2R1bGUgdmFsdWUgZm9yICdtYWluJyBoZXJlIGFuZCByZXR1cm4gaXQgYXMgdGhlCiAgICAvL3ZhbHVlIHRvIHVzZSBmb3IgdGhlIHB1YmxpYyBBUEkgZm9yIHRoZSBidWlsdCBmaWxlLgoKICAgIC8vIHdyYXAgZ2xvYmFsIGpRdWVyeSBvYmplY3QgaW50byB0aGUgJ2pxdWVyeScgbW9kdWxlIGZvciBhbGwgaXRzIAogICAgLy8gZGVwZW5kZW5jaWVzIGluIHRoZSBHYWxsZXJ5IEFwcC4KICAgIC8vIHNlZTogaHR0cHM6Ly9naXRodWIuY29tL2pyYnVya2UvYWxtb25kL2lzc3Vlcy8xMgogICAgZGVmaW5lKCdqcXVlcnknLCBbXSwgZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4galF1ZXJ5OwogICAgfSk7CgogICAgcmV0dXJuIHJlcXVpcmUoJ2dhbGxlcnkvYXBwJyk7Cn0pKTsKLyoganNoaW50IGlnbm9yZTplbmQgKi8K",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Fri, 07 Nov 2014 02:03:48 GMT",
                    "Content-Length": "370317",
                    "Date": "Fri, 07 Nov 2014 02:03:48 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}