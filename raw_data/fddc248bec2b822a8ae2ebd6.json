{
    "url": "http://localhost:9999/qrantine/Hackbone/build/hackbone.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Open redirection (DOM-based)",
    "issueType": 5243152,
    "severity": "Low",
    "confidence": "Firm",
    "issueBackground": "DOM-based open redirection vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this data into the target of a redirection in an unsafe way. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will cause a redirection to an arbitrary external domain. This behavior can be leveraged to facilitate phishing attacks against users of the application. The ability to use an authentic application URL, targeting the correct domain with a valid SSL certificate (if SSL is used) lends credibility to the phishing attack because many users, even if they verify these features, will not notice the subsequent redirection to a different domain.<br><br><b>Note:</b> If an attacker is able to control the start of the string that is passed to the redirection API, then it may be possible to escalate this vulnerability into a JavaScript injection attack, by using a URL with the javascript: pseudo-protocol to execute arbitrary script code when the URL is processed by the browser.",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based open redirection vulnerabilities is not to dynamically set redirection targets using data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing an arbitrary URL as a redirection target. In general, this is best achieved by using a whitelist of URLs that are permitted redirection targets, and strictly validating the target against this list before performing the redirection.",
    "issueDetail": "The application may be vulnerable to DOM-based open redirection. Data is read from <b>location.href</b> and written to <b>location.replace()</b> via the following statements:<ul><li>var href = location.href.replace(/(javascript:|#).*$/, '');</li><li>location.replace(href + '#' + fragment);</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/qrantine/Hackbone/build/hackbone.js",
                "path": "/qrantine/Hackbone/build/hackbone.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9xcmFudGluZS9IYWNrYm9uZS9idWlsZC9oYWNrYm9uZS5qcyBIVFRQLzEuMQ0KSG9zdDogbG9jYWxob3N0Ojk5OTkNCg0K",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogODAzNjMNCkFjY2VwdC1SYW5nZXM6IGJ5dGVzDQpDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2phdmFzY3JpcHQNCkRhdGU6IEZyaSwgMDcgTm92IDIwMTQgMDI6NTY6NDYgR01UDQpMYXN0LU1vZGlmaWVkOiBGcmksIDA3IE5vdiAyMDE0IDAyOjU2OjQ2IEdNVA0KDQovKioKICogSGFja2JvbmUgLSAwLjUuMAogKi8KKGZ1bmN0aW9uICgpIHsKCiAgICAvLyBJbml0aWFsIFNldHVwCiAgICAvLyAtLS0tLS0tLS0tLS0tCiAgICAKICAgIC8vIFNhdmUgYSByZWZlcmVuY2UgdG8gdGhlIGdsb2JhbCBvYmplY3QgKGB3aW5kb3dgIGluIHRoZSBicm93c2VyLCBgZXhwb3J0c2AKICAgIC8vIG9uIHRoZSBzZXJ2ZXIpLgogICAgdmFyIHJvb3QgPSB0aGlzOwogICAgCiAgICAvLyBTYXZlIHRoZSBwcmV2aW91cyB2YWx1ZSBvZiB0aGUgYEhhY2tib25lYCB2YXJpYWJsZSwgc28gdGhhdCBpdCBjYW4gYmUKICAgIC8vIHJlc3RvcmVkIGxhdGVyIG9uLCBpZiBgbm9Db25mbGljdGAgaXMgdXNlZC4KICAgIHZhciBwcmV2aW91c0hhY2tib25lID0gcm9vdC5IYWNrYm9uZTsKICAgIAogICAgLy8gQ3JlYXRlIGxvY2FsIHJlZmVyZW5jZXMgdG8gYXJyYXkgbWV0aG9kcyB3ZSdsbCB3YW50IHRvIHVzZSBsYXRlci4KICAgIHZhciBhcnJheSA9IFtdOwogICAgdmFyIHB1c2ggPSBhcnJheS5wdXNoOwogICAgdmFyIHNsaWNlID0gYXJyYXkuc2xpY2U7CiAgICB2YXIgc3BsaWNlID0gYXJyYXkuc3BsaWNlOwogICAgCiAgICAvLyBUaGUgdG9wLWxldmVsIG5hbWVzcGFjZS4gQWxsIHB1YmxpYyBIYWNrYm9uZSBjbGFzc2VzIGFuZCBtb2R1bGVzIHdpbGwKICAgIC8vIGJlIGF0dGFjaGVkIHRvIHRoaXMuIEV4cG9ydGVkIGZvciBib3RoIHRoZSBicm93c2VyIGFuZCB0aGUgc2VydmVyLgogICAgdmFyIEhhY2tib25lOwogICAgaWYgKHR5cGVvZiBleHBvcnRzICE9PSAndW5kZWZpbmVkJykgewogICAgICAgIEhhY2tib25lID0gZXhwb3J0czsKICAgIH0gZWxzZSB7CiAgICAgICAgSGFja2JvbmUgPSByb290LkhhY2tib25lID0ge307CiAgICB9CiAgICAKICAgIC8vIEN1cnJlbnQgdmVyc2lvbiBvZiB0aGUgbGlicmFyeS4gS2VlcCBpbiBzeW5jIHdpdGggYHBhY2thZ2UuanNvbmAuCiAgICBIYWNrYm9uZS5WRVJTSU9OID0gJzAuNS4wJzsKICAgIAogICAgLy8gUmVxdWlyZSBVbmRlcnNjb3JlLCBpZiB3ZSdyZSBvbiB0aGUgc2VydmVyLCBhbmQgaXQncyBub3QgYWxyZWFkeSBwcmVzZW50LgogICAgdmFyIF8gPSByb290Ll87CiAgICBpZiAoIV8gJiYgKHR5cGVvZiByZXF1aXJlICE9PSAndW5kZWZpbmVkJykpIF8gPSByZXF1aXJlKCd1bmRlcnNjb3JlJyk7CiAgICAKICAgIC8vIEZvciBIYWNrYm9uZSdzIHB1cnBvc2VzLCBqUXVlcnksIFplcHRvLCBFbmRlciwgb3IgTXkgTGlicmFyeSAoa2lkZGluZykgb3ducwogICAgLy8gdGhlIGAkYCB2YXJpYWJsZS4KICAgIEhhY2tib25lLiQgPSByb290LmpRdWVyeSB8fCByb290LlplcHRvIHx8IHJvb3QuZW5kZXIgfHwgcm9vdC4kOwogICAgCiAgICAvLyBSdW5zIEhhY2tib25lLmpzIGluICpub0NvbmZsaWN0KiBtb2RlLCByZXR1cm5pbmcgdGhlIGBIYWNrYm9uZWAgdmFyaWFibGUKICAgIC8vIHRvIGl0cyBwcmV2aW91cyBvd25lci4gUmV0dXJucyBhIHJlZmVyZW5jZSB0byB0aGlzIEhhY2tib25lIG9iamVjdC4KICAgIEhhY2tib25lLm5vQ29uZmxpY3QgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgcm9vdC5IYWNrYm9uZSA9IHByZXZpb3VzSGFja2JvbmU7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9OwogICAgCiAgICAvLyBUdXJuIG9uIGBlbXVsYXRlSFRUUGAgdG8gc3VwcG9ydCBsZWdhY3kgSFRUUCBzZXJ2ZXJzLiBTZXR0aW5nIHRoaXMgb3B0aW9uCiAgICAvLyB3aWxsIGZha2UgYCJQQVRDSCJgLCBgIlBVVCJgIGFuZCBgIkRFTEVURSJgIHJlcXVlc3RzIHZpYSB0aGUgYF9tZXRob2RgIHBhcmFtZXRlciBhbmQKICAgIC8vIHNldCBhIGBYLUh0dHAtTWV0aG9kLU92ZXJyaWRlYCBoZWFkZXIuCiAgICBIYWNrYm9uZS5lbXVsYXRlSFRUUCA9IGZhbHNlOwogICAgCiAgICAvLyBUdXJuIG9uIGBlbXVsYXRlSlNPTmAgdG8gc3VwcG9ydCBsZWdhY3kgc2VydmVycyB0aGF0IGNhbid0IGRlYWwgd2l0aCBkaXJlY3QKICAgIC8vIGBhcHBsaWNhdGlvbi9qc29uYCByZXF1ZXN0cyAuLi4gd2lsbCBlbmNvZGUgdGhlIGJvZHkgYXMKICAgIC8vIGBhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWRgIGluc3RlYWQgYW5kIHdpbGwgc2VuZCB0aGUgbW9kZWwgaW4gYQogICAgLy8gZm9ybSBwYXJhbSBuYW1lZCBgbW9kZWxgLgogICAgSGFja2JvbmUuZW11bGF0ZUpTT04gPSBmYWxzZTsKICAgIAogICAgLy8gSGVscGVyIGZ1bmN0aW9uIHRvIGNvcnJlY3RseSBzZXQgdXAgdGhlIHByb3RvdHlwZSBjaGFpbiwgZm9yIHN1YmNsYXNzZXMuCiAgICAvLyBTaW1pbGFyIHRvIGBnb29nLmluaGVyaXRzYCwgYnV0IHVzZXMgYSBoYXNoIG9mIHByb3RvdHlwZSBwcm9wZXJ0aWVzIGFuZAogICAgLy8gY2xhc3MgcHJvcGVydGllcyB0byBiZSBleHRlbmRlZC4KICAgIC8vIFRPRE86IHRoaXMgaXMgYSB2ZXJ5IGZhc3QgaW1wbGVtZW50YXRpb24sIHJlcXVpcmVzIGEgZGVjZW50IG9uZQogICAgdmFyIGV4dGVuZCA9IEhhY2tib25lLmV4dGVuZCA9IGZ1bmN0aW9uIChjb25zdHJ1Y3RvciwgcHJvdG9Qcm9wcywgc3RhdGljUHJvcHMpIHsKICAgICAgICByZXR1cm4gQmFzZS5leHRlbmQuY2FsbChjb25zdHJ1Y3RvciwgcHJvdG9Qcm9wcywgc3RhdGljUHJvcHMpOwogICAgfTsKCgogICAgLy8gSGVscGVycwogICAgLy8gLS0tLS0tLQogICAgCiAgICAvLyBUaHJvdyBhbiBlcnJvciB3aGVuIGEgVVJMIGlzIG5lZWRlZCwgYW5kIG5vbmUgaXMgc3VwcGxpZWQuCiAgICB2YXIgdXJsRXJyb3IgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdBICJ1cmwiIHByb3BlcnR5IG9yIGZ1bmN0aW9uIG11c3QgYmUgc3BlY2lmaWVkJyk7CiAgICB9OwogICAgCiAgICAvLyBXcmFwIGFuIG9wdGlvbmFsIGVycm9yIGNhbGxiYWNrIHdpdGggYSBmYWxsYmFjayBlcnJvciBldmVudC4KICAgIHZhciB3cmFwRXJyb3IgPSBmdW5jdGlvbiAobW9kZWwsIG9wdGlvbnMpIHsKICAgICAgICB2YXIgZXJyb3IgPSBvcHRpb25zLmVycm9yOwogICAgICAgIG9wdGlvbnMuZXJyb3IgPSBmdW5jdGlvbiAocmVzcCkgewogICAgICAgICAgICBpZiAoZXJyb3IpIGVycm9yKG1vZGVsLCByZXNwLCBvcHRpb25zKTsKICAgICAgICAgICAgbW9kZWwudHJpZ2dlcignZXJyb3InLCBtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CiAgICAgICAgfTsKICAgIH07CgogICAgdmFyIEJhc2UgPSBIYWNrYm9uZS5CYXNlID0gZnVuY3Rpb24gKCkge307CiAgICAKICAgIC8vIEhlbHBlciBmdW5jdGlvbiB0byBjb3JyZWN0bHkgc2V0IHVwIHRoZSBwcm90b3R5cGUgY2hhaW4sIGZvciBzdWJjbGFzc2VzLgogICAgLy8gU2ltaWxhciB0byBgZ29vZy5pbmhlcml0c2AsIGJ1dCB1c2VzIGEgaGFzaCBvZiBwcm90b3R5cGUgcHJvcGVydGllcyBhbmQKICAgIC8vIGNsYXNzIHByb3BlcnRpZXMgdG8gYmUgZXh0ZW5kZWQuCiAgICBCYXNlLmV4dGVuZCA9IGZ1bmN0aW9uIChwcm90b1Byb3BzLCBzdGF0aWNQcm9wcykgewogICAgICAgIHZhciBwYXJlbnQgPSB0aGlzOwogICAgICAgIHZhciBjaGlsZDsKICAgIAogICAgICAgIC8vIFRoZSBjb25zdHJ1Y3RvciBmdW5jdGlvbiBmb3IgdGhlIG5ldyBzdWJjbGFzcyBpcyBlaXRoZXIgZGVmaW5lZCBieSB5b3UKICAgICAgICAvLyAodGhlICJjb25zdHJ1Y3RvciIgcHJvcGVydHkgaW4geW91ciBgZXh0ZW5kYCBkZWZpbml0aW9uKSwgb3IgZGVmYXVsdGVkCiAgICAgICAgLy8gYnkgdXMgdG8gc2ltcGx5IGNhbGwgdGhlIHBhcmVudCdzIGNvbnN0cnVjdG9yLgogICAgICAgIGlmIChwcm90b1Byb3BzICYmIF8uaGFzKHByb3RvUHJvcHMsICdjb25zdHJ1Y3RvcicpKSB7CiAgICAgICAgICAgIGNoaWxkID0gcHJvdG9Qcm9wcy5jb25zdHJ1Y3RvcjsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjaGlsZCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiBwYXJlbnQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgICAgfTsKICAgICAgICB9CiAgICAKICAgICAgICAvLyBBZGQgc3RhdGljIHByb3BlcnRpZXMgdG8gdGhlIGNvbnN0cnVjdG9yIGZ1bmN0aW9uLCBpZiBzdXBwbGllZC4KICAgICAgICBfLmV4dGVuZChjaGlsZCwgcGFyZW50LCBzdGF0aWNQcm9wcyk7CiAgICAKICAgICAgICAvLyBTZXQgdGhlIHByb3RvdHlwZSBjaGFpbiB0byBpbmhlcml0IGZyb20gYHBhcmVudGAsIHdpdGhvdXQgY2FsbGluZwogICAgICAgIC8vIGBwYXJlbnRgJ3MgY29uc3RydWN0b3IgZnVuY3Rpb24uCiAgICAgICAgdmFyIFN1cnJvZ2F0ZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdGhpcy5jb25zdHJ1Y3RvciA9IGNoaWxkOwogICAgICAgIH07CiAgICAgICAgU3Vycm9nYXRlLnByb3RvdHlwZSA9IHBhcmVudC5wcm90b3R5cGU7CiAgICAgICAgY2hpbGQucHJvdG90eXBlID0gbmV3IFN1cnJvZ2F0ZSgpOwogICAgCiAgICAgICAgLy8gQWRkIHByb3RvdHlwZSBwcm9wZXJ0aWVzIChpbnN0YW5jZSBwcm9wZXJ0aWVzKSB0byB0aGUgc3ViY2xhc3MsCiAgICAgICAgLy8gaWYgc3VwcGxpZWQuCiAgICAgICAgaWYgKHByb3RvUHJvcHMpIF8uZXh0ZW5kKGNoaWxkLnByb3RvdHlwZSwgcHJvdG9Qcm9wcyk7CiAgICAKICAgICAgICAvLyBTZXQgYSBjb252ZW5pZW5jZSBwcm9wZXJ0eSBpbiBjYXNlIHRoZSBwYXJlbnQncyBwcm90b3R5cGUgaXMgbmVlZGVkCiAgICAgICAgLy8gbGF0ZXIuCiAgICAgICAgY2hpbGQuX19zdXBlcl9fID0gcGFyZW50LnByb3RvdHlwZTsKICAgIAogICAgICAgIHJldHVybiBjaGlsZDsKICAgIH07CiAgICAKICAgIC8vIEhlbHBlciBmdW5jdGlvbiB0byBtaXggbXVsdGlwbGUgaW50ZXJmYWNlcywgYmVoYXZpb3VycyBvciBmZWF0dXJlcyBmcm9tCiAgICBCYXNlLm1peGluID0gZnVuY3Rpb24gKC8qIGNsYXNzZXMgYW5kIHByb3BlcnR5IG1hcHMgKi8pIHsKICAgICAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMCk7CiAgICAgICAgdmFyIG1peGluID0ge307CiAgICAgICAgdmFyIGZlYXR1cmU7CiAgICAKICAgICAgICB3aGlsZSAoYXJncy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgIGZlYXR1cmUgPSBhcmdzLnNoaWZ0KCk7CiAgICAgICAgICAgIGlmICh0eXBlb2YgZmVhdHVyZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgZmVhdHVyZSA9IGZlYXR1cmUucHJvdG90eXBlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIF8uZXh0ZW5kKG1peGluLCBmZWF0dXJlKTsKICAgICAgICB9CiAgICAKICAgICAgICByZXR1cm4gdGhpcy5leHRlbmQobWl4aW4pOwogICAgfTsKICAgIAogICAgQmFzZS5pbXBsZW1lbnQgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDApOwogICAgICAgIHZhciBwcm90byA9IHRoaXMucHJvdG90eXBlOwogICAgICAgIHZhciBmZWF0dXJlOwogICAgCiAgICAgICAgd2hpbGUgKGFyZ3MubGVuZ3RoID4gMCkgewogICAgICAgICAgICBmZWF0dXJlID0gYXJncy5zaGlmdCgpOwogICAgICAgICAgICBpZiAodHlwZW9mIGZlYXR1cmUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIGZlYXR1cmUgPSBmZWF0dXJlLnByb3RvdHlwZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBfLmV4dGVuZChwcm90bywgZmVhdHVyZSk7CiAgICAgICAgfQogICAgCiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9OwoKCiAgICAvLyBDb21wb25lbnQgY2xhc3MgcHJvdmlkZXMgZ2VuZXJhbC9iYXNpYyBsaWZlY3ljbGUgaW50ZXJmYWNlLgogICAgdmFyIENvbXBvbmVudCA9IEhhY2tib25lLkNvbXBvbmVudCA9IEJhc2UuZXh0ZW5kKHsKICAgICAgICAvLyBJbml0aWFsaXplcyB0aGUgQ29tcG9uZW50LiBPdmVycmlkZSBpZiBjdXN0b20gbG9naWMgbmVlZGVkLgogICAgICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSwKICAgIAogICAgICAgIC8vIFBhdXNlcyBvciBtdXRlcyB0aGUgQ29tcG9uZW50LiBPdmVycmlkZSBpZiBjdXN0b20gbG9naWMgbmVlZGVkLgogICAgICAgIHBhdXNlOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCiAgICAKICAgICAgICAvLyBSZXN1bWVzIHRoZSBDb21wb25lbnQgZnJvbSBwYXVzZWQgb3IgbXV0ZWQgc3RhdGUuIE92ZXJyaWRlIGlmIGN1c3RvbSBsb2dpYyBuZWVkZWQuCiAgICAgICAgcmVzdW1lOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCiAgICAKICAgICAgICAvLyBEZXN0cm95cyB0aGUgQ29tcG9uZW50LiBPdmVycmlkZSBpZiBjdXN0b20gbG9naWMgbmVlZGVkLgogICAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfQogICAgfSk7CgogICAgLy8gSGFja2JvbmUuRXZlbnRzCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0KICAgIAogICAgLy8gQSBtb2R1bGUgdGhhdCBjYW4gYmUgbWl4ZWQgaW4gdG8gKmFueSBvYmplY3QqIGluIG9yZGVyIHRvIHByb3ZpZGUgaXQgd2l0aAogICAgLy8gY3VzdG9tIGV2ZW50cy4gWW91IG1heSBiaW5kIHdpdGggYG9uYCBvciByZW1vdmUgd2l0aCBgb2ZmYCBjYWxsYmFjawogICAgLy8gZnVuY3Rpb25zIHRvIGFuIGV2ZW50OyBgdHJpZ2dlcmAtaW5nIGFuIGV2ZW50IGZpcmVzIGFsbCBjYWxsYmFja3MgaW4KICAgIC8vIHN1Y2Nlc3Npb24uCiAgICAvLwogICAgLy8gICAgIHZhciBvYmplY3QgPSB7fTsKICAgIC8vICAgICBfLmV4dGVuZChvYmplY3QsIEhhY2tib25lLkV2ZW50cyk7CiAgICAvLyAgICAgb2JqZWN0Lm9uKCdleHBhbmQnLCBmdW5jdGlvbigpeyBhbGVydCgnZXhwYW5kZWQnKTsgfSk7CiAgICAvLyAgICAgb2JqZWN0LnRyaWdnZXIoJ2V4cGFuZCcpOwogICAgLy8KICAgIHZhciBFdmVudHMgPSBIYWNrYm9uZS5FdmVudHMgPSB7CiAgICAKICAgICAgICAvLyBCaW5kIGFuIGV2ZW50IHRvIGEgYGNhbGxiYWNrYCBmdW5jdGlvbi4gUGFzc2luZyBgImFsbCJgIHdpbGwgYmluZAogICAgICAgIC8vIHRoZSBjYWxsYmFjayB0byBhbGwgZXZlbnRzIGZpcmVkLgogICAgICAgIG9uOiBmdW5jdGlvbiAobmFtZSwgY2FsbGJhY2ssIGNvbnRleHQpIHsKICAgICAgICAgICAgaWYgKCFldmVudHNBcGkodGhpcywgJ29uJywgbmFtZSwgW2NhbGxiYWNrLCBjb250ZXh0XSkgfHwgIWNhbGxiYWNrKSByZXR1cm4gdGhpczsKICAgICAgICAgICAgdGhpcy5fZXZlbnRzIHx8ICh0aGlzLl9ldmVudHMgPSB7fSk7CiAgICAgICAgICAgIHZhciBldmVudHMgPSB0aGlzLl9ldmVudHNbbmFtZV0gfHwgKHRoaXMuX2V2ZW50c1tuYW1lXSA9IFtdKTsKICAgICAgICAgICAgZXZlbnRzLnB1c2goe2NhbGxiYWNrOiBjYWxsYmFjaywgY29udGV4dDogY29udGV4dCwgY3R4OiBjb250ZXh0IHx8IHRoaXN9KTsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSwKICAgIAogICAgICAgIC8vIEJpbmQgYW4gZXZlbnQgdG8gb25seSBiZSB0cmlnZ2VyZWQgYSBzaW5nbGUgdGltZS4gQWZ0ZXIgdGhlIGZpcnN0IHRpbWUKICAgICAgICAvLyB0aGUgY2FsbGJhY2sgaXMgaW52b2tlZCwgaXQgd2lsbCBiZSByZW1vdmVkLgogICAgICAgIG9uY2U6IGZ1bmN0aW9uIChuYW1lLCBjYWxsYmFjaywgY29udGV4dCkgewogICAgICAgICAgICBpZiAoIWV2ZW50c0FwaSh0aGlzLCAnb25jZScsIG5hbWUsIFtjYWxsYmFjaywgY29udGV4dF0pIHx8ICFjYWxsYmFjaykgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgICAgICAgdmFyIG9uY2UgPSBfLm9uY2UoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgc2VsZi5vZmYobmFtZSwgb25jZSk7CiAgICAgICAgICAgICAgICBjYWxsYmFjay5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgb25jZS5fY2FsbGJhY2sgPSBjYWxsYmFjazsKICAgICAgICAgICAgcmV0dXJuIHRoaXMub24obmFtZSwgb25jZSwgY29udGV4dCk7CiAgICAgICAgfSwKICAgIAogICAgICAgIC8vIFJlbW92ZSBvbmUgb3IgbWFueSBjYWxsYmFja3MuIElmIGBjb250ZXh0YCBpcyBudWxsLCByZW1vdmVzIGFsbAogICAgICAgIC8vIGNhbGxiYWNrcyB3aXRoIHRoYXQgZnVuY3Rpb24uIElmIGBjYWxsYmFja2AgaXMgbnVsbCwgcmVtb3ZlcyBhbGwKICAgICAgICAvLyBjYWxsYmFja3MgZm9yIHRoZSBldmVudC4gSWYgYG5hbWVgIGlzIG51bGwsIHJlbW92ZXMgYWxsIGJvdW5kCiAgICAgICAgLy8gY2FsbGJhY2tzIGZvciBhbGwgZXZlbnRzLgogICAgICAgIG9mZjogZnVuY3Rpb24gKG5hbWUsIGNhbGxiYWNrLCBjb250ZXh0KSB7CiAgICAgICAgICAgIHZhciByZXRhaW4sIGV2LCBldmVudHMsIG5hbWVzLCBpLCBsLCBqLCBrOwogICAgICAgICAgICBpZiAoIXRoaXMuX2V2ZW50cyB8fCAhZXZlbnRzQXBpKHRoaXMsICdvZmYnLCBuYW1lLCBbY2FsbGJhY2ssIGNvbnRleHRdKSkgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgIGlmICghbmFtZSAmJiAhY2FsbGJhY2sgJiYgIWNvbnRleHQpIHsKICAgICAgICAgICAgICAgIHRoaXMuX2V2ZW50cyA9IHt9OwogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgIH0KICAgIAogICAgICAgICAgICBuYW1lcyA9IG5hbWUgPyBbbmFtZV0gOiBfLmtleXModGhpcy5fZXZlbnRzKTsKICAgICAgICAgICAgZm9yIChpID0gMCwgbCA9IG5hbWVzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgICAgICAgbmFtZSA9IG5hbWVzW2ldOwogICAgICAgICAgICAgICAgaWYgKGV2ZW50cyA9IHRoaXMuX2V2ZW50c1tuYW1lXSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuX2V2ZW50c1tuYW1lXSA9IHJldGFpbiA9IFtdOwogICAgICAgICAgICAgICAgICAgIGlmIChjYWxsYmFjayB8fCBjb250ZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoaiA9IDAsIGsgPSBldmVudHMubGVuZ3RoOyBqIDwgazsgaisrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBldiA9IGV2ZW50c1tqXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgoY2FsbGJhY2sgJiYgY2FsbGJhY2sgIT09IGV2LmNhbGxiYWNrICYmIGNhbGxiYWNrICE9PSBldi5jYWxsYmFjay5fY2FsbGJhY2spIHx8CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKGNvbnRleHQgJiYgY29udGV4dCAhPT0gZXYuY29udGV4dCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXRhaW4ucHVzaChldik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKCFyZXRhaW4ubGVuZ3RoKSBkZWxldGUgdGhpcy5fZXZlbnRzW25hbWVdOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSwKICAgIAogICAgICAgIC8vIFRyaWdnZXIgb25lIG9yIG1hbnkgZXZlbnRzLCBmaXJpbmcgYWxsIGJvdW5kIGNhbGxiYWNrcy4gQ2FsbGJhY2tzIGFyZQogICAgICAgIC8vIHBhc3NlZCB0aGUgc2FtZSBhcmd1bWVudHMgYXMgYHRyaWdnZXJgIGlzLCBhcGFydCBmcm9tIHRoZSBldmVudCBuYW1lCiAgICAgICAgLy8gKHVubGVzcyB5b3UncmUgbGlzdGVuaW5nIG9uIGAiYWxsImAsIHdoaWNoIHdpbGwgY2F1c2UgeW91ciBjYWxsYmFjayB0bwogICAgICAgIC8vIHJlY2VpdmUgdGhlIHRydWUgbmFtZSBvZiB0aGUgZXZlbnQgYXMgdGhlIGZpcnN0IGFyZ3VtZW50KS4KICAgICAgICB0cmlnZ2VyOiBmdW5jdGlvbiAobmFtZSkgewogICAgICAgICAgICBpZiAoIXRoaXMuX2V2ZW50cykgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwogICAgICAgICAgICBpZiAoIWV2ZW50c0FwaSh0aGlzLCAndHJpZ2dlcicsIG5hbWUsIGFyZ3MpKSByZXR1cm4gdGhpczsKICAgICAgICAgICAgdmFyIGV2ZW50cyA9IHRoaXMuX2V2ZW50c1tuYW1lXTsKICAgICAgICAgICAgdmFyIGFsbEV2ZW50cyA9IHRoaXMuX2V2ZW50cy5hbGw7CiAgICAgICAgICAgIGlmIChldmVudHMpIHRyaWdnZXJFdmVudHMoZXZlbnRzLCBhcmdzKTsKICAgICAgICAgICAgaWYgKGFsbEV2ZW50cykgdHJpZ2dlckV2ZW50cyhhbGxFdmVudHMsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCiAgICAKICAgICAgICAvLyBUZWxsIHRoaXMgb2JqZWN0IHRvIHN0b3AgbGlzdGVuaW5nIHRvIGVpdGhlciBzcGVjaWZpYyBldmVudHMgLi4uIG9yCiAgICAgICAgLy8gdG8gZXZlcnkgb2JqZWN0IGl0J3MgY3VycmVudGx5IGxpc3RlbmluZyB0by4KICAgICAgICBzdG9wTGlzdGVuaW5nOiBmdW5jdGlvbiAob2JqLCBuYW1lLCBjYWxsYmFjaykgewogICAgICAgICAgICB2YXIgbGlzdGVuZXJzID0gdGhpcy5fbGlzdGVuZXJzOwogICAgICAgICAgICBpZiAoIWxpc3RlbmVycykgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgIHZhciBkZWxldGVMaXN0ZW5lciA9ICFuYW1lICYmICFjYWxsYmFjazsKICAgICAgICAgICAgaWYgKHR5cGVvZiBuYW1lID09PSAnb2JqZWN0JykgY2FsbGJhY2sgPSB0aGlzOwogICAgICAgICAgICBpZiAob2JqKSAobGlzdGVuZXJzID0ge30pW29iai5fbGlzdGVuZXJJZF0gPSBvYmo7CiAgICAgICAgICAgIGZvciAodmFyIGlkIGluIGxpc3RlbmVycykgewogICAgICAgICAgICAgICAgaWYgKGxpc3RlbmVycy5oYXNPd25Qcm9wZXJ0eShpZCkpIHsKICAgICAgICAgICAgICAgICAgICBsaXN0ZW5lcnNbaWRdLm9mZihuYW1lLCBjYWxsYmFjaywgdGhpcyk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGRlbGV0ZUxpc3RlbmVyKSBkZWxldGUgdGhpcy5fbGlzdGVuZXJzW2lkXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9CiAgICAKICAgIH07CiAgICAKICAgIC8vIFJlZ3VsYXIgZXhwcmVzc2lvbiB1c2VkIHRvIHNwbGl0IGV2ZW50IHN0cmluZ3MuCiAgICB2YXIgZXZlbnRTcGxpdHRlciA9IC9ccysvOwogICAgCiAgICAvLyBJbXBsZW1lbnQgZmFuY3kgZmVhdHVyZXMgb2YgdGhlIEV2ZW50cyBBUEkgc3VjaCBhcyBtdWx0aXBsZSBldmVudAogICAgLy8gbmFtZXMgYCJjaGFuZ2UgYmx1ciJgIGFuZCBqUXVlcnktc3R5bGUgZXZlbnQgbWFwcyBge2NoYW5nZTogYWN0aW9ufWAKICAgIC8vIGluIHRlcm1zIG9mIHRoZSBleGlzdGluZyBBUEkuCiAgICB2YXIgZXZlbnRzQXBpID0gZnVuY3Rpb24gKG9iaiwgYWN0aW9uLCBuYW1lLCByZXN0KSB7CiAgICAgICAgaWYgKCFuYW1lKSByZXR1cm4gdHJ1ZTsKICAgIAogICAgICAgIC8vIEhhbmRsZSBldmVudCBtYXBzLgogICAgICAgIGlmICh0eXBlb2YgbmFtZSA9PT0gJ29iamVjdCcpIHsKICAgICAgICAgICAgZm9yICh2YXIga2V5IGluIG5hbWUpIHsKICAgICAgICAgICAgICAgIGlmIChuYW1lLmhhc093blByb3BlcnR5KGtleSkpIHsKICAgICAgICAgICAgICAgICAgICBvYmpbYWN0aW9uXS5hcHBseShvYmosIFtrZXksIG5hbWVba2V5XV0uY29uY2F0KHJlc3QpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgCiAgICAgICAgLy8gSGFuZGxlIHNwYWNlIHNlcGFyYXRlZCBldmVudCBuYW1lcy4KICAgICAgICBpZiAoZXZlbnRTcGxpdHRlci50ZXN0KG5hbWUpKSB7CiAgICAgICAgICAgIHZhciBuYW1lcyA9IG5hbWUuc3BsaXQoZXZlbnRTcGxpdHRlcik7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBsID0gbmFtZXMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgICAgICAgICBvYmpbYWN0aW9uXS5hcHBseShvYmosIFtuYW1lc1tpXV0uY29uY2F0KHJlc3QpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgCiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9OwogICAgCiAgICAvLyBBIGRpZmZpY3VsdC10by1iZWxpZXZlLCBidXQgb3B0aW1pemVkIGludGVybmFsIGRpc3BhdGNoIGZ1bmN0aW9uIGZvcgogICAgLy8gdHJpZ2dlcmluZyBldmVudHMuIFRyaWVzIHRvIGtlZXAgdGhlIHVzdWFsIGNhc2VzIHNwZWVkeSAobW9zdCBpbnRlcm5hbAogICAgLy8gSGFja2JvbmUgZXZlbnRzIGhhdmUgMyBhcmd1bWVudHMpLgogICAgdmFyIHRyaWdnZXJFdmVudHMgPSBmdW5jdGlvbiAoZXZlbnRzLCBhcmdzKSB7CiAgICAgICAgdmFyIGV2LCBpID0gLTEsIGwgPSBldmVudHMubGVuZ3RoLCBhMSA9IGFyZ3NbMF0sIGEyID0gYXJnc1sxXSwgYTMgPSBhcmdzWzJdOwogICAgICAgIHN3aXRjaCAoYXJncy5sZW5ndGgpIHsKICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgICAgd2hpbGUgKCsraSA8IGwpIChldiA9IGV2ZW50c1tpXSkuY2FsbGJhY2suY2FsbChldi5jdHgpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICBjYXNlIDE6CiAgICAgICAgICAgICAgICB3aGlsZSAoKytpIDwgbCkgKGV2ID0gZXZlbnRzW2ldKS5jYWxsYmFjay5jYWxsKGV2LmN0eCwgYTEpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICBjYXNlIDI6CiAgICAgICAgICAgICAgICB3aGlsZSAoKytpIDwgbCkgKGV2ID0gZXZlbnRzW2ldKS5jYWxsYmFjay5jYWxsKGV2LmN0eCwgYTEsIGEyKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgY2FzZSAzOgogICAgICAgICAgICAgICAgd2hpbGUgKCsraSA8IGwpIChldiA9IGV2ZW50c1tpXSkuY2FsbGJhY2suY2FsbChldi5jdHgsIGExLCBhMiwgYTMpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgd2hpbGUgKCsraSA8IGwpIChldiA9IGV2ZW50c1tpXSkuY2FsbGJhY2suYXBwbHkoZXYuY3R4LCBhcmdzKTsKICAgICAgICB9CiAgICB9OwogICAgCiAgICB2YXIgbGlzdGVuTWV0aG9kcyA9IHtsaXN0ZW5UbzogJ29uJywgbGlzdGVuVG9PbmNlOiAnb25jZSd9OwogICAgCiAgICAvLyBJbnZlcnNpb24tb2YtY29udHJvbCB2ZXJzaW9ucyBvZiBgb25gIGFuZCBgb25jZWAuIFRlbGwgKnRoaXMqIG9iamVjdCB0bwogICAgLy8gbGlzdGVuIHRvIGFuIGV2ZW50IGluIGFub3RoZXIgb2JqZWN0IC4uLiBrZWVwaW5nIHRyYWNrIG9mIHdoYXQgaXQncwogICAgLy8gbGlzdGVuaW5nIHRvLgogICAgXy5lYWNoKGxpc3Rlbk1ldGhvZHMsIGZ1bmN0aW9uIChpbXBsZW1lbnRhdGlvbiwgbWV0aG9kKSB7CiAgICAgICAgRXZlbnRzW21ldGhvZF0gPSBmdW5jdGlvbiAob2JqLCBuYW1lLCBjYWxsYmFjaykgewogICAgICAgICAgICB2YXIgbGlzdGVuZXJzID0gdGhpcy5fbGlzdGVuZXJzIHx8ICh0aGlzLl9saXN0ZW5lcnMgPSB7fSk7CiAgICAgICAgICAgIHZhciBpZCA9IG9iai5fbGlzdGVuZXJJZCB8fCAob2JqLl9saXN0ZW5lcklkID0gXy51bmlxdWVJZCgnbCcpKTsKICAgICAgICAgICAgbGlzdGVuZXJzW2lkXSA9IG9iajsKICAgICAgICAgICAgaWYgKHR5cGVvZiBuYW1lID09PSAnb2JqZWN0JykgY2FsbGJhY2sgPSB0aGlzOwogICAgICAgICAgICBvYmpbaW1wbGVtZW50YXRpb25dKG5hbWUsIGNhbGxiYWNrLCB0aGlzKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfTsKICAgIH0pOwogICAgCiAgICAvLyBBbGlhc2VzIGZvciBiYWNrd2FyZHMgY29tcGF0aWJpbGl0eS4KICAgIEV2ZW50cy5iaW5kID0gRXZlbnRzLm9uOwogICAgRXZlbnRzLnVuYmluZCA9IEV2ZW50cy5vZmY7CiAgICAKICAgIC8vIEFsbG93IHRoZSBgSGFja2JvbmVgIG9iamVjdCB0byBzZXJ2ZSBhcyBhIGdsb2JhbCBldmVudCBidXMsIGZvciBmb2xrcyB3aG8KICAgIC8vIHdhbnQgZ2xvYmFsICJwdWJzdWIiIGluIGEgY29udmVuaWVudCBwbGFjZS4KICAgIF8uZXh0ZW5kKEhhY2tib25lLCBFdmVudHMpOwoKICAgIC8vQmFja2JvbmUuU3RhdGUKICAgIAogICAgLy9IYWNrYm9uZS5TdGF0ZSBwcm92aWRlcyBhIHNpbXBsZSBldmVudGVkIGRhdGEtc3RvcmUgd2l0aG91dCBhbnkgUkVTVGZ1bCBmZWF0dXJlcy4KICAgIHZhciBTdGF0ZSA9IEhhY2tib25lLlN0YXRlID0gQ29tcG9uZW50LmV4dGVuZCh7CiAgICAKICAgICAgICAvLyBUaGUgZGVmYXVsdCBuYW1lIGZvciB0aGUgSlNPTiBgaWRgIGF0dHJpYnV0ZSBpcyBgImlkImAuIE1vbmdvREIgYW5kCiAgICAgICAgLy8gQ291Y2hEQiB1c2VycyBtYXkgd2FudCB0byBzZXQgdGhpcyB0byBgIl9pZCJgLgogICAgICAgIGlkQXR0cmlidXRlOiAnaWQnLAogICAgCiAgICAgICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uIChhdHRyaWJ1dGVzLCBvcHRpb25zKSB7CiAgICAgICAgICAgIHZhciBkZWZhdWx0czsKICAgICAgICAgICAgdmFyIGF0dHJzID0gYXR0cmlidXRlcyB8fCB7fTsKICAgICAgICAgICAgb3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KTsKICAgICAgICAgICAgdGhpcy5jaWQgPSBfLnVuaXF1ZUlkKCdjJyk7CiAgICAgICAgICAgIHRoaXMuYXR0cmlidXRlcyA9IHt9OwogICAgICAgICAgICBpZiAob3B0aW9ucy5jb2xsZWN0aW9uKSB0aGlzLmNvbGxlY3Rpb24gPSBvcHRpb25zLmNvbGxlY3Rpb247CiAgICAgICAgICAgIGlmIChvcHRpb25zLnBhcnNlKSBhdHRycyA9IHRoaXMucGFyc2UoYXR0cnMsIG9wdGlvbnMpIHx8IHt9OwogICAgICAgICAgICBvcHRpb25zLl9hdHRycyB8fCAob3B0aW9ucy5fYXR0cnMgPSBhdHRycyk7CiAgICAgICAgICAgIGlmIChkZWZhdWx0cyA9IF8ucmVzdWx0KHRoaXMsICdkZWZhdWx0cycpKSB7CiAgICAgICAgICAgICAgICBhdHRycyA9IF8uZGVmYXVsdHMoe30sIGF0dHJzLCBkZWZhdWx0cyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5zZXQoYXR0cnMsIG9wdGlvbnMpOwogICAgICAgICAgICB0aGlzLmNoYW5nZWQgPSB7fTsKICAgICAgICB9LAogICAgCiAgICAgICAgLy8gQSBoYXNoIG9mIGF0dHJpYnV0ZXMgd2hvc2UgY3VycmVudCBhbmQgcHJldmlvdXMgdmFsdWUgZGlmZmVyLgogICAgICAgIGNoYW5nZWQ6IG51bGwsCiAgICAKICAgICAgICAvLyBUaGUgdmFsdWUgcmV0dXJuZWQgZHVyaW5nIHRoZSBsYXN0IGZhaWxlZCB2YWxpZGF0aW9uLgogICAgICAgIHZhbGlkYXRpb25FcnJvcjogbnVsbCwKICAgIAogICAgICAgIC8vIFJldHVybiBhIGNvcHkgb2YgdGhlIFN0YXRlJ3MgYGF0dHJpYnV0ZXNgIG9iamVjdC4KICAgICAgICB0b0pTT046IGZ1bmN0aW9uIChvcHRpb25zKSB7CiAgICAgICAgICAgIHJldHVybiBfLmNsb25lKHRoaXMuYXR0cmlidXRlcyk7CiAgICAgICAgfSwKICAgIAogICAgICAgIC8vIEdldCB0aGUgdmFsdWUgb2YgYW4gYXR0cmlidXRlLgogICAgICAgIGdldDogZnVuY3Rpb24gKGF0dHIpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuYXR0cmlidXRlc1thdHRyXTsKICAgICAgICB9LAogICAgCiAgICAgICAgLy8gR2V0IHRoZSBIVE1MLWVzY2FwZWQgdmFsdWUgb2YgYW4gYXR0cmlidXRlLgogICAgICAgIGVzY2FwZTogZnVuY3Rpb24gKGF0dHIpIHsKICAgICAgICAgICAgcmV0dXJuIF8uZXNjYXBlKHRoaXMuZ2V0KGF0dHIpKTsKICAgICAgICB9LAogICAgCiAgICAgICAgLy8gUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIGF0dHJpYnV0ZSBjb250YWlucyBhIHZhbHVlIHRoYXQgaXMgbm90IG51bGwKICAgICAgICAvLyBvciB1bmRlZmluZWQuCiAgICAgICAgaGFzOiBmdW5jdGlvbiAoYXR0cikgewogICAgICAgICAgICByZXR1cm4gdGhpcy5nZXQoYXR0cikgIT0gbnVsbDsKICAgICAgICB9LAogICAgCiAgICAgICAgLy8gU2V0IGEgaGFzaCBvZiBTdGF0ZSBhdHRyaWJ1dGVzIG9uIHRoZSBvYmplY3QsIGZpcmluZyBgImNoYW5nZSJgLiBUaGlzIGlzCiAgICAgICAgLy8gdGhlIGNvcmUgcHJpbWl0aXZlIG9wZXJhdGlvbiBvZiBhIFN0YXRlLCB1cGRhdGluZyB0aGUgZGF0YSBhbmQgbm90aWZ5aW5nCiAgICAgICAgLy8gYW55b25lIHdobyBuZWVkcyB0byBrbm93IGFib3V0IHRoZSBjaGFuZ2UgaW4gc3RhdGUuIFRoZSBoZWFydCBvZiB0aGUgYmVhc3QuCiAgICAgICAgc2V0OiBmdW5jdGlvbiAoa2V5LCB2YWwsIG9wdGlvbnMpIHsKICAgICAgICAgICAgdmFyIGF0dHIsIGF0dHJzLCB1bnNldCwgY2hhbmdlcywgc2lsZW50LCBjaGFuZ2luZywgcHJldiwgY3VycmVudDsKICAgICAgICAgICAgaWYgKGtleSA9PSBudWxsKSByZXR1cm4gdGhpczsKICAgIAogICAgICAgICAgICAvLyBIYW5kbGUgYm90aCBgImtleSIsIHZhbHVlYCBhbmQgYHtrZXk6IHZhbHVlfWAgLXN0eWxlIGFyZ3VtZW50cy4KICAgICAgICAgICAgaWYgKHR5cGVvZiBrZXkgPT09ICdvYmplY3QnKSB7CiAgICAgICAgICAgICAgICBhdHRycyA9IGtleTsKICAgICAgICAgICAgICAgIG9wdGlvbnMgPSB2YWw7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAoYXR0cnMgPSB7fSlba2V5XSA9IHZhbDsKICAgICAgICAgICAgfQogICAgCiAgICAgICAgICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CiAgICAKICAgICAgICAgICAgLy8gUnVuIHZhbGlkYXRpb24uCiAgICAgICAgICAgIGlmICghdGhpcy5fdmFsaWRhdGUoYXR0cnMsIG9wdGlvbnMpKSByZXR1cm4gZmFsc2U7CiAgICAKICAgICAgICAgICAgLy8gRXh0cmFjdCBhdHRyaWJ1dGVzIGFuZCBvcHRpb25zLgogICAgICAgICAgICB1bnNldCA9IG9wdGlvbnMudW5zZXQ7CiAgICAgICAgICAgIHNpbGVudCA9IG9wdGlvbnMuc2lsZW50OwogICAgICAgICAgICBjaGFuZ2VzID0gW107CiAgICAgICAgICAgIGNoYW5naW5nID0gdGhpcy5fY2hhbmdpbmc7CiAgICAgICAgICAgIHRoaXMuX2NoYW5naW5nID0gdHJ1ZTsKICAgIAogICAgICAgICAgICBpZiAoIWNoYW5naW5nKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9wcmV2aW91c0F0dHJpYnV0ZXMgPSBfLmNsb25lKHRoaXMuYXR0cmlidXRlcyk7CiAgICAgICAgICAgICAgICB0aGlzLmNoYW5nZWQgPSB7fTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjdXJyZW50ID0gdGhpcy5hdHRyaWJ1dGVzLCBwcmV2ID0gdGhpcy5fcHJldmlvdXNBdHRyaWJ1dGVzOwogICAgCiAgICAgICAgICAgIC8vIENoZWNrIGZvciBjaGFuZ2VzIG9mIGBpZGAuCiAgICAgICAgICAgIGlmICh0aGlzLmlkQXR0cmlidXRlIGluIGF0dHJzKSB0aGlzLmlkID0gYXR0cnNbdGhpcy5pZEF0dHJpYnV0ZV07CiAgICAKICAgICAgICAgICAgLy8gRm9yIGVhY2ggYHNldGAgYXR0cmlidXRlLCB1cGRhdGUgb3IgZGVsZXRlIHRoZSBjdXJyZW50IHZhbHVlLgogICAgICAgICAgICBmb3IgKGF0dHIgaW4gYXR0cnMpIHsKICAgICAgICAgICAgICAgIHZhbCA9IGF0dHJzW2F0dHJdOwogICAgICAgICAgICAgICAgaWYgKCFfLmlzRXF1YWwoY3VycmVudFthdHRyXSwgdmFsKSkgY2hhbmdlcy5wdXNoKGF0dHIpOwogICAgICAgICAgICAgICAgaWYgKCFfLmlzRXF1YWwocHJldlthdHRyXSwgdmFsKSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuY2hhbmdlZFthdHRyXSA9IHZhbDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgZGVsZXRlIHRoaXMuY2hhbmdlZFthdHRyXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHVuc2V0ID8gZGVsZXRlIGN1cnJlbnRbYXR0cl0gOiBjdXJyZW50W2F0dHJdID0gdmFsOwogICAgICAgICAgICB9CiAgICAKICAgICAgICAgICAgLy8gVHJpZ2dlciBhbGwgcmVsZXZhbnQgYXR0cmlidXRlIGNoYW5nZXMuCiAgICAgICAgICAgIGlmICghc2lsZW50KSB7CiAgICAgICAgICAgICAgICBpZiAoY2hhbmdlcy5sZW5ndGgpIHRoaXMuX3BlbmRpbmcgPSB0cnVlOwogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSBjaGFuZ2VzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgICAgICAgICAgIHRoaXMudHJpZ2dlcignY2hhbmdlOicgKyBjaGFuZ2VzW2ldLCB0aGlzLCBjdXJyZW50W2NoYW5nZXNbaV1dLCBvcHRpb25zKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgCiAgICAgICAgICAgIC8vIFlvdSBtaWdodCBiZSB3b25kZXJpbmcgd2h5IHRoZXJlJ3MgYSBgd2hpbGVgIGxvb3AgaGVyZS4gQ2hhbmdlcyBjYW4KICAgICAgICAgICAgLy8gYmUgcmVjdXJzaXZlbHkgbmVzdGVkIHdpdGhpbiBgImNoYW5nZSJgIGV2ZW50cy4KICAgICAgICAgICAgaWYgKGNoYW5naW5nKSByZXR1cm4gdGhpczsKICAgICAgICAgICAgaWYgKCFzaWxlbnQpIHsKICAgICAgICAgICAgICAgIHdoaWxlICh0aGlzLl9wZW5kaW5nKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fcGVuZGluZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIHRoaXMudHJpZ2dlcignY2hhbmdlJywgdGhpcywgb3B0aW9ucyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5fcGVuZGluZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLl9jaGFuZ2luZyA9IGZhbHNlOwogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9LAogICAgCiAgICAgICAgLy8gUmVtb3ZlIGFuIGF0dHJpYnV0ZSBmcm9tIHRoZSBTdGF0ZSwgZmlyaW5nIGAiY2hhbmdlImAuIGB1bnNldGAgaXMgYSBub29wCiAgICAgICAgLy8gaWYgdGhlIGF0dHJpYnV0ZSBkb2Vzbid0IGV4aXN0LgogICAgICAgIHVuc2V0OiBmdW5jdGlvbiAoYXR0ciwgb3B0aW9ucykgewogICAgICAgICAgICByZXR1cm4gdGhpcy5zZXQoYXR0ciwgdm9pZCAwLCBfLmV4dGVuZCh7fSwgb3B0aW9ucywge3Vuc2V0OiB0cnVlfSkpOwogICAgICAgIH0sCiAgICAKICAgICAgICAvLyBDbGVhciBhbGwgYXR0cmlidXRlcyBvbiB0aGUgU3RhdGUsIGZpcmluZyBgImNoYW5nZSJgLgogICAgICAgIGNsZWFyOiBmdW5jdGlvbiAob3B0aW9ucykgewogICAgICAgICAgICB2YXIgYXR0cnMgPSB7fTsKICAgICAgICAgICAgZm9yICh2YXIga2V5IGluIHRoaXMuYXR0cmlidXRlcykgYXR0cnNba2V5XSA9IHZvaWQgMDsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuc2V0KGF0dHJzLCBfLmV4dGVuZCh7fSwgb3B0aW9ucywge3Vuc2V0OiB0cnVlfSkpOwogICAgICAgIH0sCiAgICAKICAgICAgICAvLyBEZXN0cm95cyB0aGUgU3RhdGUgYnkgY2xlYXJpbmcgYWxsIGF0dHJpYnV0ZXMuCiAgICAgICAgLy8gQ29udmVuaWVuY2UgbWV0aG9kIGZvciBleHRlbmRpbmcgYmFzZSBDb21wb25lbnQuCiAgICAgICAgZGVzdHJveTogZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5jbGVhci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgIH0sCiAgICAKICAgICAgICAvLyBEZXRlcm1pbmUgaWYgdGhlIFN0YXRlIGhhcyBjaGFuZ2VkIHNpbmNlIHRoZSBsYXN0IGAiY2hhbmdlImAgZXZlbnQuCiAgICAgICAgLy8gSWYgeW91IHNwZWNpZnkgYW4gYXR0cmlidXRlIG5hbWUsIGRldGVybWluZSBpZiB0aGF0IGF0dHJpYnV0ZSBoYXMgY2hhbmdlZC4KICAgICAgICBoYXNDaGFuZ2VkOiBmdW5jdGlvbiAoYXR0cikgewogICAgICAgICAgICBpZiAoYXR0ciA9PSBudWxsKSByZXR1cm4gIV8uaXNFbXB0eSh0aGlzLmNoYW5nZWQpOwogICAgICAgICAgICByZXR1cm4gXy5oYXModGhpcy5jaGFuZ2VkLCBhdHRyKTsKICAgICAgICB9LAogICAgCiAgICAgICAgLy8gUmV0dXJuIGFuIG9iamVjdCBjb250YWluaW5nIGFsbCB0aGUgYXR0cmlidXRlcyB0aGF0IGhhdmUgY2hhbmdlZCwgb3IKICAgICAgICAvLyBmYWxzZSBpZiB0aGVyZSBhcmUgbm8gY2hhbmdlZCBhdHRyaWJ1dGVzLiBVc2VmdWwgZm9yIGRldGVybWluaW5nIHdoYXQKICAgICAgICAvLyBwYXJ0cyBvZiBhIHZpZXcgbmVlZCB0byBiZSB1cGRhdGVkIGFuZC9vciB3aGF0IGF0dHJpYnV0ZXMgbmVlZCB0byBiZQogICAgICAgIC8vIHBlcnNpc3RlZCB0byB0aGUgc2VydmVyLiBVbnNldCBhdHRyaWJ1dGVzIHdpbGwgYmUgc2V0IHRvIHVuZGVmaW5lZC4KICAgICAgICAvLyBZb3UgY2FuIGFsc28gcGFzcyBhbiBhdHRyaWJ1dGVzIG9iamVjdCB0byBkaWZmIGFnYWluc3QgdGhlIFN0YXRlLAogICAgICAgIC8vIGRldGVybWluaW5nIGlmIHRoZXJlICp3b3VsZCBiZSogYSBjaGFuZ2UuCiAgICAgICAgY2hhbmdlZEF0dHJpYnV0ZXM6IGZ1bmN0aW9uIChkaWZmKSB7CiAgICAgICAgICAgIGlmICghZGlmZikgcmV0dXJuIHRoaXMuaGFzQ2hhbmdlZCgpID8gXy5jbG9uZSh0aGlzLmNoYW5nZWQpIDogZmFsc2U7CiAgICAgICAgICAgIHZhciB2YWwsIGNoYW5nZWQgPSBmYWxzZTsKICAgICAgICAgICAgdmFyIG9sZCA9IHRoaXMuX2NoYW5naW5nID8gdGhpcy5fcHJldmlvdXNBdHRyaWJ1dGVzIDogdGhpcy5hdHRyaWJ1dGVzOwogICAgICAgICAgICBmb3IgKHZhciBhdHRyIGluIGRpZmYpIHsKICAgICAgICAgICAgICAgIGlmIChfLmlzRXF1YWwob2xkW2F0dHJdLCAodmFsID0gZGlmZlthdHRyXSkpKSBjb250aW51ZTsKICAgICAgICAgICAgICAgIChjaGFuZ2VkIHx8IChjaGFuZ2VkID0ge30pKVthdHRyXSA9IHZhbDsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gY2hhbmdlZDsKICAgICAgICB9LAogICAgCiAgICAgICAgLy8gR2V0IHRoZSBwcmV2aW91cyB2YWx1ZSBvZiBhbiBhdHRyaWJ1dGUsIHJlY29yZGVkIGF0IHRoZSB0aW1lIHRoZSBsYXN0CiAgICAgICAgLy8gYCJjaGFuZ2UiYCBldmVudCB3YXMgZmlyZWQuCiAgICAgICAgcHJldmlvdXM6IGZ1bmN0aW9uIChhdHRyKSB7CiAgICAgICAgICAgIGlmIChhdHRyID09IG51bGwgfHwgIXRoaXMuX3ByZXZpb3VzQXR0cmlidXRlcykgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9wcmV2aW91c0F0dHJpYnV0ZXNbYXR0cl07CiAgICAgICAgfSwKICAgIAogICAgICAgIC8vIEdldCBhbGwgb2YgdGhlIGF0dHJpYnV0ZXMgb2YgdGhlIFN0YXRlIGF0IHRoZSB0aW1lIG9mIHRoZSBwcmV2aW91cwogICAgICAgIC8vIGAiY2hhbmdlImAgZXZlbnQuCiAgICAgICAgcHJldmlvdXNBdHRyaWJ1dGVzOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiBfLmNsb25lKHRoaXMuX3ByZXZpb3VzQXR0cmlidXRlcyk7CiAgICAgICAgfSwKICAgIAogICAgICAgIC8vIENyZWF0ZSBhIG5ldyBTdGF0ZSB3aXRoIGlkZW50aWNhbCBhdHRyaWJ1dGVzIHRvIHRoaXMgb25lLgogICAgICAgIGNsb25lOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiBuZXcgdGhpcy5jb25zdHJ1Y3Rvcih0aGlzLmF0dHJpYnV0ZXMpOwogICAgICAgIH0sCiAgICAKICAgICAgICAvLyBSdW4gdmFsaWRhdGlvbiBhZ2FpbnN0IHRoZSBuZXh0IGNvbXBsZXRlIHNldCBvZiBTdGF0ZSBhdHRyaWJ1dGVzLAogICAgICAgIC8vIHJldHVybmluZyBgdHJ1ZWAgaWYgYWxsIGlzIHdlbGwuIE90aGVyd2lzZSwgZmlyZSBhbiBgImludmFsaWQiYCBldmVudC4KICAgICAgICBfdmFsaWRhdGU6IGZ1bmN0aW9uIChhdHRycywgb3B0aW9ucykgewogICAgICAgICAgICBpZiAoIW9wdGlvbnMudmFsaWRhdGUgfHwgIXRoaXMudmFsaWRhdGUpIHJldHVybiB0cnVlOwogICAgICAgICAgICBhdHRycyA9IF8uZXh0ZW5kKHt9LCB0aGlzLmF0dHJpYnV0ZXMsIGF0dHJzKTsKICAgICAgICAgICAgdmFyIGVycm9yID0gdGhpcy52YWxpZGF0aW9uRXJyb3IgPSB0aGlzLnZhbGlkYXRlKGF0dHJzLCBvcHRpb25zKSB8fCBudWxsOwogICAgICAgICAgICBpZiAoIWVycm9yKSByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgdGhpcy50cmlnZ2VyKCdpbnZhbGlkJywgdGhpcywgZXJyb3IsIF8uZXh0ZW5kKG9wdGlvbnMgfHwge30sIHt2YWxpZGF0aW9uRXJyb3I6IGVycm9yfSkpOwogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfSwKICAgIAogICAgICAgIC8vICoqcGFyc2UqKiBjb252ZXJ0cyBhIHJlc3BvbnNlIGludG8gdGhlIGhhc2ggb2YgYXR0cmlidXRlcyB0byBiZSBgc2V0YCBvbgogICAgICAgIC8vIHRoZSBtb2RlbC4gVGhlIGRlZmF1bHQgaW1wbGVtZW50YXRpb24gaXMganVzdCB0byBwYXNzIHRoZSByZXNwb25zZSBhbG9uZy4KICAgICAgICBwYXJzZTogZnVuY3Rpb24gKHJlc3AsIG9wdGlvbnMpIHsKICAgICAgICAgICAgcmV0dXJuIHJlc3A7CiAgICAgICAgfSwKICAgIAogICAgICAgIC8vIEEgbW9kZWwgaXMgbmV3IGlmIGl0IGhhcyBuZXZlciBiZWVuIHNhdmVkIHRvIHRoZSBzZXJ2ZXIsIGFuZCBsYWNrcyBhbiBpZC4KICAgICAgICBpc05ldzogZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5pZCA9PSBudWxsOwogICAgICAgIH0sCiAgICAKICAgICAgICAvLyBDaGVjayBpZiB0aGUgbW9kZWwgaXMgY3VycmVudGx5IGluIGEgdmFsaWQgc3RhdGUuCiAgICAgICAgaXNWYWxpZDogZnVuY3Rpb24gKG9wdGlvbnMpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3ZhbGlkYXRlKHt9LCBfLmV4dGVuZChvcHRpb25zIHx8IHt9LCB7IHZhbGlkYXRlOiB0cnVlIH0pKTsKICAgICAgICB9CiAgICB9KTsKICAgIAogICAgXy5leHRlbmQoU3RhdGUucHJvdG90eXBlLCBFdmVudHMpOwogICAgCiAgICAvLyBVbmRlcnNjb3JlIG1ldGhvZHMgdGhhdCB3ZSB3YW50IHRvIGltcGxlbWVudCBvbiB0aGUgU3RhdGUuCiAgICB2YXIgc3RhdGVNZXRob2RzID0gWydrZXlzJywgJ3ZhbHVlcycsICdwYWlycycsICdpbnZlcnQnLCAncGljaycsICdvbWl0J107CiAgICAKICAgIC8vIE1peCBpbiBlYWNoIFVuZGVyc2NvcmUgbWV0aG9kIGFzIGEgcHJveHkgdG8gYFN0YXRlI2F0dHJpYnV0ZXNgLgogICAgXy5lYWNoKHN0YXRlTWV0aG9kcywgZnVuY3Rpb24gKG1ldGhvZCkgewogICAgICAgIFN0YXRlLnByb3RvdHlwZVttZXRob2RdID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzKTsKICAgICAgICAgICAgYXJncy51bnNoaWZ0KHRoaXMuYXR0cmlidXRlcyk7CiAgICAgICAgICAgIHJldHVybiBfW21ldGhvZF0uYXBwbHkoXywgYXJncyk7CiAgICAgICAgfTsKICAgIH0pOwoKICAgIC8vIEhhY2tib25lLkNvbGxlY3Rpb24KICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIAogICAgLy8gSWYgbW9kZWxzIHRlbmQgdG8gcmVwcmVzZW50IGEgc2luZ2xlIHJvdyBvZiBkYXRhLCBhIEhhY2tib25lIENvbGxlY3Rpb24gaXMKICAgIC8vIG1vcmUgYW5hbGFnb3VzIHRvIGEgdGFibGUgZnVsbCBvZiBkYXRhIC4uLiBvciBhIHNtYWxsIHNsaWNlIG9yIHBhZ2Ugb2YgdGhhdAogICAgLy8gdGFibGUsIG9yIGEgY29sbGVjdGlvbiBvZiByb3dzIHRoYXQgYmVsb25nIHRvZ2V0aGVyIGZvciBhIHBhcnRpY3VsYXIgcmVhc29uCiAgICAvLyAtLSBhbGwgb2YgdGhlIG1lc3NhZ2VzIGluIHRoaXMgcGFydGljdWxhciBmb2xkZXIsIGFsbCBvZiB0aGUgZG9jdW1lbnRzCiAgICAvLyBiZWxvbmdpbmcgdG8gdGhpcyBwYXJ0aWN1bGFyIGF1dGhvciwgYW5kIHNvIG9uLiBDb2xsZWN0aW9ucyBtYWludGFpbgogICAgLy8gaW5kZXhlcyBvZiB0aGVpciBtb2RlbHMsIGJvdGggaW4gb3JkZXIsIGFuZCBmb3IgbG9va3VwIGJ5IGBpZGAuCiAgICAKICAgIC8vIENyZWF0ZSBhIG5ldyAqKkNvbGxlY3Rpb24qKiwgcGVyaGFwcyB0byBjb250YWluIGEgc3BlY2lmaWMgdHlwZSBvZiBgbW9kZWxgLgogICAgLy8gSWYgYSBgY29tcGFyYXRvcmAgaXMgc3BlY2lmaWVkLCB0aGUgQ29sbGVjdGlvbiB3aWxsIG1haW50YWluCiAgICAvLyBpdHMgbW9kZWxzIGluIHNvcnQgb3JkZXIsIGFzIHRoZXkncmUgYWRkZWQgYW5kIHJlbW92ZWQuCiAgICAvLyBEZWZhdWx0IG9wdGlvbnMgZm9yIGBDb2xsZWN0aW9uI3NldGAuCiAgICB2YXIgc2V0T3B0aW9ucyA9IHthZGQ6IHRydWUsIHJlbW92ZTogdHJ1ZSwgbWVyZ2U6IHRydWV9OwogICAgdmFyIGFkZE9wdGlvbnMgPSB7YWRkOiB0cnVlLCByZW1vdmU6IGZhbHNlfTsKICAgIAogICAgLy8gRGVmaW5lIHRoZSBDb2xsZWN0aW9uJ3MgaW5oZXJpdGFibGUgbWV0aG9kcy4KICAgIHZhciBDb2xsZWN0aW9uID0gSGFja2JvbmUuQ29sbGVjdGlvbiA9IENvbXBvbmVudC5leHRlbmQoewogICAgICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbiAobW9kZWxzLCBvcHRpb25zKSB7CiAgICAgICAgICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CiAgICAgICAgICAgIGlmIChvcHRpb25zLm1vZGVsKSB0aGlzLm1vZGVsID0gb3B0aW9ucy5tb2RlbDsKICAgICAgICAgICAgaWYgKG9wdGlvbnMuY29tcGFyYXRvciAhPT0gdm9pZCAwKSB0aGlzLmNvbXBhcmF0b3IgPSBvcHRpb25zLmNvbXBhcmF0b3I7CiAgICAgICAgICAgIHRoaXMuX3Jlc2V0KCk7CiAgICAgICAgICAgIHRoaXMuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgICBpZiAobW9kZWxzKSB0aGlzLnJlc2V0KG1vZGVscywgXy5leHRlbmQoe3NpbGVudDogdHJ1ZX0sIG9wdGlvbnMpKTsKICAgICAgICB9LAogICAgCiAgICAgICAgLy8gVGhlIGRlZmF1bHQgbW9kZWwgZm9yIGEgY29sbGVjdGlvbiBpcyBqdXN0IGEgKipIYWNrYm9uZS5TdGF0ZSoqLgogICAgICAgIC8vIFRoaXMgc2hvdWxkIGJlIG92ZXJyaWRkZW4gaW4gbW9zdCBjYXNlcy4KICAgICAgICBtb2RlbDogU3RhdGUsCiAgICAKICAgICAgICAvLyBUaGUgSlNPTiByZXByZXNlbnRhdGlvbiBvZiBhIENvbGxlY3Rpb24gaXMgYW4gYXJyYXkgb2YgdGhlCiAgICAgICAgLy8gbW9kZWxzJyBhdHRyaWJ1dGVzLgogICAgICAgIHRvSlNPTjogZnVuY3Rpb24gKG9wdGlvbnMpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMubWFwKGZ1bmN0aW9uIChtb2RlbCkgewogICAgICAgICAgICAgICAgcmV0dXJuIG1vZGVsLnRvSlNPTihvcHRpb25zKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKICAgIAogICAgICAgIC8vIFByb3h5IGBIYWNrYm9uZS5zeW5jYCBieSBkZWZhdWx0LgogICAgICAgIHN5bmM6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIEhhY2tib25lLnN5bmMuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICB9LAogICAgCiAgICAgICAgLy8gQWRkIGEgbW9kZWwsIG9yIGxpc3Qgb2YgbW9kZWxzIHRvIHRoZSBzZXQuCiAgICAgICAgYWRkOiBmdW5jdGlvbiAobW9kZWxzLCBvcHRpb25zKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnNldChtb2RlbHMsIF8uZXh0ZW5kKHttZXJnZTogZmFsc2V9LCBvcHRpb25zLCBhZGRPcHRpb25zKSk7CiAgICAgICAgfSwKICAgIAogICAgICAgIC8vIFJlbW92ZSBhIG1vZGVsLCBvciBhIGxpc3Qgb2YgbW9kZWxzIGZyb20gdGhlIHNldC4KICAgICAgICByZW1vdmU6IGZ1bmN0aW9uIChtb2RlbHMsIG9wdGlvbnMpIHsKICAgICAgICAgICAgbW9kZWxzID0gXy5pc0FycmF5KG1vZGVscykgPyBtb2RlbHMuc2xpY2UoKSA6IFttb2RlbHNdOwogICAgICAgICAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwogICAgICAgICAgICB2YXIgaSwgbCwgaW5kZXgsIG1vZGVsOwogICAgICAgICAgICBmb3IgKGkgPSAwLCBsID0gbW9kZWxzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgICAgICAgbW9kZWwgPSB0aGlzLmdldChtb2RlbHNbaV0pOwogICAgICAgICAgICAgICAgaWYgKCFtb2RlbCkgY29udGludWU7CiAgICAgICAgICAgICAgICBkZWxldGUgdGhpcy5fYnlJZFttb2RlbC5pZF07CiAgICAgICAgICAgICAgICBkZWxldGUgdGhpcy5fYnlJZFttb2RlbC5jaWRdOwogICAgICAgICAgICAgICAgaW5kZXggPSB0aGlzLmluZGV4T2YobW9kZWwpOwogICAgICAgICAgICAgICAgdGhpcy5tb2RlbHMuc3BsaWNlKGluZGV4LCAxKTsKICAgICAgICAgICAgICAgIHRoaXMubGVuZ3RoLS07CiAgICAgICAgICAgICAgICBpZiAoIW9wdGlvbnMuc2lsZW50KSB7CiAgICAgICAgICAgICAgICAgICAgb3B0aW9ucy5pbmRleCA9IGluZGV4OwogICAgICAgICAgICAgICAgICAgIG1vZGVsLnRyaWdnZXIoJ3JlbW92ZScsIG1vZGVsLCB0aGlzLCBvcHRpb25zKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMuX3JlbW92ZVJlZmVyZW5jZShtb2RlbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSwKICAgIAogICAgICAgIC8vIFJlbW92ZXMgYWxsIG1vZGVscyBmcm9tIHRoZSBjb2xsZWN0aW9uCiAgICAgICAgZGVzdHJveTogZnVuY3Rpb24gKG9wdGlvbnMpIHsKICAgICAgICAgICAgdmFyIG1vZGVscyA9IHRoaXMubW9kZWxzOwogICAgICAgICAgICByZXR1cm4gdGhpcy5yZW1vdmUobW9kZWxzLCBvcHRpb25zKTsKICAgICAgICB9LAogICAgCiAgICAgICAgLy8gVXBkYXRlIGEgY29sbGVjdGlvbiBieSBgc2V0YC1pbmcgYSBuZXcgbGlzdCBvZiBtb2RlbHMsIGFkZGluZyBuZXcgb25lcywKICAgICAgICAvLyByZW1vdmluZyBtb2RlbHMgdGhhdCBhcmUgbm8gbG9uZ2VyIHByZXNlbnQsIGFuZCBtZXJnaW5nIG1vZGVscyB0aGF0CiAgICAgICAgLy8gYWxyZWFkeSBleGlzdCBpbiB0aGUgY29sbGVjdGlvbiwgYXMgbmVjZXNzYXJ5LiBTaW1pbGFyIHRvICoqU3RhdGUjc2V0KiosCiAgICAgICAgLy8gdGhlIGNvcmUgb3BlcmF0aW9uIGZvciB1cGRhdGluZyB0aGUgZGF0YSBjb250YWluZWQgYnkgdGhlIGNvbGxlY3Rpb24uCiAgICAgICAgc2V0OiBmdW5jdGlvbiAobW9kZWxzLCBvcHRpb25zKSB7CiAgICAgICAgICAgIG9wdGlvbnMgPSBfLmRlZmF1bHRzKHt9LCBvcHRpb25zLCBzZXRPcHRpb25zKTsKICAgICAgICAgICAgaWYgKG9wdGlvbnMucGFyc2UpIG1vZGVscyA9IHRoaXMucGFyc2UobW9kZWxzLCBvcHRpb25zKTsKICAgICAgICAgICAgaWYgKCFfLmlzQXJyYXkobW9kZWxzKSkgbW9kZWxzID0gbW9kZWxzID8gW21vZGVsc10gOiBbXTsKICAgICAgICAgICAgdmFyIGksIGwsIG1vZGVsLCBhdHRycywgZXhpc3RpbmcsIHNvcnQ7CiAgICAgICAgICAgIHZhciBhdCA9IG9wdGlvbnMuYXQ7CiAgICAgICAgICAgIHZhciBzb3J0YWJsZSA9IHRoaXMuY29tcGFyYXRvciAmJiAoYXQgPT0gbnVsbCkgJiYgb3B0aW9ucy5zb3J0ICE9PSBmYWxzZTsKICAgICAgICAgICAgdmFyIHNvcnRBdHRyID0gXy5pc1N0cmluZyh0aGlzLmNvbXBhcmF0b3IpID8gdGhpcy5jb21wYXJhdG9yIDogbnVsbDsKICAgICAgICAgICAgdmFyIHRvQWRkID0gW10sIHRvUmVtb3ZlID0gW10sIG1vZGVsTWFwID0ge307CiAgICAgICAgICAgIHZhciBhZGQgPSBvcHRpb25zLmFkZCwgbWVyZ2UgPSBvcHRpb25zLm1lcmdlLCByZW1vdmUgPSBvcHRpb25zLnJlbW92ZTsKICAgICAgICAgICAgdmFyIG9yZGVyID0gIXNvcnRhYmxlICYmIGFkZCAmJiByZW1vdmUgPyBbXSA6IGZhbHNlOwogICAgCiAgICAgICAgICAgIC8vIFR1cm4gYmFyZSBvYmplY3RzIGludG8gbW9kZWwgcmVmZXJlbmNlcywgYW5kIHByZXZlbnQgaW52YWxpZCBtb2RlbHMKICAgICAgICAgICAgLy8gZnJvbSBiZWluZyBhZGRlZC4KICAgICAgICAgICAgZm9yIChpID0gMCwgbCA9IG1vZGVscy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgICAgICAgIGlmICghKG1vZGVsID0gdGhpcy5fcHJlcGFyZU1vZGVsKGF0dHJzID0gbW9kZWxzW2ldLCBvcHRpb25zKSkpIGNvbnRpbnVlOwogICAgCiAgICAgICAgICAgICAgICAvLyBJZiBhIGR1cGxpY2F0ZSBpcyBmb3VuZCwgcHJldmVudCBpdCBmcm9tIGJlaW5nIGFkZGVkIGFuZAogICAgICAgICAgICAgICAgLy8gb3B0aW9uYWxseSBtZXJnZSBpdCBpbnRvIHRoZSBleGlzdGluZyBtb2RlbC4KICAgICAgICAgICAgICAgIGlmIChleGlzdGluZyA9IHRoaXMuZ2V0KG1vZGVsKSkgewogICAgICAgICAgICAgICAgICAgIGlmIChyZW1vdmUpIG1vZGVsTWFwW2V4aXN0aW5nLmNpZF0gPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIGlmIChtZXJnZSkgewogICAgICAgICAgICAgICAgICAgICAgICBhdHRycyA9IGF0dHJzID09PSBtb2RlbCA/IG1vZGVsLmF0dHJpYnV0ZXMgOiBvcHRpb25zLl9hdHRyczsKICAgICAgICAgICAgICAgICAgICAgICAgZXhpc3Rpbmcuc2V0KGF0dHJzLCBvcHRpb25zKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNvcnRhYmxlICYmICFzb3J0ICYmIGV4aXN0aW5nLmhhc0NoYW5nZWQoc29ydEF0dHIpKSBzb3J0ID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAKICAgICAgICAgICAgICAgICAgICAvLyBUaGlzIGlzIGEgbmV3IG1vZGVsLCBwdXNoIGl0IHRvIHRoZSBgdG9BZGRgIGxpc3QuCiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGFkZCkgewogICAgICAgICAgICAgICAgICAgIHRvQWRkLnB1c2gobW9kZWwpOwogICAgCiAgICAgICAgICAgICAgICAgICAgLy8gTGlzdGVuIHRvIGFkZGVkIG1vZGVscycgZXZlbnRzLCBhbmQgaW5kZXggbW9kZWxzIGZvciBsb29rdXAgYnkKICAgICAgICAgICAgICAgICAgICAvLyBgaWRgIGFuZCBieSBgY2lkYC4KICAgICAgICAgICAgICAgICAgICBtb2RlbC5vbignYWxsJywgdGhpcy5fb25Nb2RlbEV2ZW50LCB0aGlzKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9ieUlkW21vZGVsLmNpZF0gPSBtb2RlbDsKICAgICAgICAgICAgICAgICAgICBpZiAobW9kZWwuaWQgIT0gbnVsbCkgdGhpcy5fYnlJZFttb2RlbC5pZF0gPSBtb2RlbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChvcmRlcikgb3JkZXIucHVzaChleGlzdGluZyB8fCBtb2RlbCk7CiAgICAgICAgICAgICAgICBkZWxldGUgb3B0aW9ucy5fYXR0cnM7CiAgICAgICAgICAgIH0KICAgIAogICAgICAgICAgICAvLyBSZW1vdmUgbm9uZXhpc3RlbnQgbW9kZWxzIGlmIGFwcHJvcHJpYXRlLgogICAgICAgICAgICBpZiAocmVtb3ZlKSB7CiAgICAgICAgICAgICAgICBmb3IgKGkgPSAwLCBsID0gdGhpcy5sZW5ndGg7IGkgPCBsOyArK2kpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoIW1vZGVsTWFwWyhtb2RlbCA9IHRoaXMubW9kZWxzW2ldKS5jaWRdKSB0b1JlbW92ZS5wdXNoKG1vZGVsKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICh0b1JlbW92ZS5sZW5ndGgpIHRoaXMucmVtb3ZlKHRvUmVtb3ZlLCBvcHRpb25zKTsKICAgICAgICAgICAgfQogICAgCiAgICAgICAgICAgIC8vIFNlZSBpZiBzb3J0aW5nIGlzIG5lZWRlZCwgdXBkYXRlIGBsZW5ndGhgIGFuZCBzcGxpY2UgaW4gbmV3IG1vZGVscy4KICAgICAgICAgICAgaWYgKHRvQWRkLmxlbmd0aCB8fCAob3JkZXIgJiYgb3JkZXIubGVuZ3RoKSkgewogICAgICAgICAgICAgICAgaWYgKHNvcnRhYmxlKSBzb3J0ID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRoaXMubGVuZ3RoICs9IHRvQWRkLmxlbmd0aDsKICAgICAgICAgICAgICAgIGlmIChhdCAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgc3BsaWNlLmFwcGx5KHRoaXMubW9kZWxzLCBbYXQsIDBdLmNvbmNhdCh0b0FkZCkpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBpZiAob3JkZXIpIHRoaXMubW9kZWxzLmxlbmd0aCA9IDA7CiAgICAgICAgICAgICAgICAgICAgcHVzaC5hcHBseSh0aGlzLm1vZGVscywgb3JkZXIgfHwgdG9BZGQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAKICAgICAgICAgICAgLy8gU2lsZW50bHkgc29ydCB0aGUgY29sbGVjdGlvbiBpZiBhcHByb3ByaWF0ZS4KICAgICAgICAgICAgaWYgKHNvcnQpIHRoaXMuc29ydCh7c2lsZW50OiB0cnVlfSk7CiAgICAKICAgICAgICAgICAgaWYgKG9wdGlvbnMuc2lsZW50KSByZXR1cm4gdGhpczsKICAgIAogICAgICAgICAgICAvLyBUcmlnZ2VyIGBhZGRgIGV2ZW50cy4KICAgICAgICAgICAgZm9yIChpID0gMCwgbCA9IHRvQWRkLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgICAgICAgKG1vZGVsID0gdG9BZGRbaV0pLnRyaWdnZXIoJ2FkZCcsIG1vZGVsLCB0aGlzLCBvcHRpb25zKTsKICAgICAgICAgICAgfQogICAgCiAgICAgICAgICAgIC8vIFRyaWdnZXIgYHNvcnRgIGlmIHRoZSBjb2xsZWN0aW9uIHdhcyBzb3J0ZWQuCiAgICAgICAgICAgIGlmIChzb3J0IHx8IChvcmRlciAmJiBvcmRlci5sZW5ndGgpKSB0aGlzLnRyaWdnZXIoJ3NvcnQnLCB0aGlzLCBvcHRpb25zKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSwKICAgIAogICAgICAgIC8vIFdoZW4geW91IGhhdmUgbW9yZSBpdGVtcyB0aGFuIHlvdSB3YW50IHRvIGFkZCBvciByZW1vdmUgaW5kaXZpZHVhbGx5LAogICAgICAgIC8vIHlvdSBjYW4gcmVzZXQgdGhlIGVudGlyZSBzZXQgd2l0aCBhIG5ldyBsaXN0IG9mIG1vZGVscywgd2l0aG91dCBmaXJpbmcKICAgICAgICAvLyBhbnkgZ3JhbnVsYXIgYGFkZGAgb3IgYHJlbW92ZWAgZXZlbnRzLiBGaXJlcyBgcmVzZXRgIHdoZW4gZmluaXNoZWQuCiAgICAgICAgLy8gVXNlZnVsIGZvciBidWxrIG9wZXJhdGlvbnMgYW5kIG9wdGltaXphdGlvbnMuCiAgICAgICAgcmVzZXQ6IGZ1bmN0aW9uIChtb2RlbHMsIG9wdGlvbnMpIHsKICAgICAgICAgICAgb3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSB0aGlzLm1vZGVscy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgICAgICAgIHRoaXMuX3JlbW92ZVJlZmVyZW5jZSh0aGlzLm1vZGVsc1tpXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgb3B0aW9ucy5wcmV2aW91c01vZGVscyA9IHRoaXMubW9kZWxzOwogICAgICAgICAgICB0aGlzLl9yZXNldCgpOwogICAgICAgICAgICB0aGlzLmFkZChtb2RlbHMsIF8uZXh0ZW5kKHtzaWxlbnQ6IHRydWV9LCBvcHRpb25zKSk7CiAgICAgICAgICAgIGlmICghb3B0aW9ucy5zaWxlbnQpIHRoaXMudHJpZ2dlcigncmVzZXQnLCB0aGlzLCBvcHRpb25zKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSwKICAgIAogICAgICAgIC8vIEFkZCBhIG1vZGVsIHRvIHRoZSBlbmQgb2YgdGhlIGNvbGxlY3Rpb24uCiAgICAgICAgcHVzaDogZnVuY3Rpb24gKG1vZGVsLCBvcHRpb25zKSB7CiAgICAgICAgICAgIG1vZGVsID0gdGhpcy5fcHJlcGFyZU1vZGVsKG1vZGVsLCBvcHRpb25zKTsKICAgICAgICAgICAgdGhpcy5hZGQobW9kZWwsIF8uZXh0ZW5kKHthdDogdGhpcy5sZW5ndGh9LCBvcHRpb25zKSk7CiAgICAgICAgICAgIHJldHVybiBtb2RlbDsKICAgICAgICB9LAogICAgCiAgICAgICAgLy8gUmVtb3ZlIGEgbW9kZWwgZnJvbSB0aGUgZW5kIG9mIHRoZSBjb2xsZWN0aW9uLgogICAgICAgIHBvcDogZnVuY3Rpb24gKG9wdGlvbnMpIHsKICAgICAgICAgICAgdmFyIG1vZGVsID0gdGhpcy5hdCh0aGlzLmxlbmd0aCAtIDEpOwogICAgICAgICAgICB0aGlzLnJlbW92ZShtb2RlbCwgb3B0aW9ucyk7CiAgICAgICAgICAgIHJldHVybiBtb2RlbDsKICAgICAgICB9LAogICAgCiAgICAgICAgLy8gQWRkIGEgbW9kZWwgdG8gdGhlIGJlZ2lubmluZyBvZiB0aGUgY29sbGVjdGlvbi4KICAgICAgICB1bnNoaWZ0OiBmdW5jdGlvbiAobW9kZWwsIG9wdGlvbnMpIHsKICAgICAgICAgICAgbW9kZWwgPSB0aGlzLl9wcmVwYXJlTW9kZWwobW9kZWwsIG9wdGlvbnMpOwogICAgICAgICAgICB0aGlzLmFkZChtb2RlbCwgXy5leHRlbmQoe2F0OiAwfSwgb3B0aW9ucykpOwogICAgICAgICAgICByZXR1cm4gbW9kZWw7CiAgICAgICAgfSwKICAgIAogICAgICAgIC8vIFJlbW92ZSBhIG1vZGVsIGZyb20gdGhlIGJlZ2lubmluZyBvZiB0aGUgY29sbGVjdGlvbi4KICAgICAgICBzaGlmdDogZnVuY3Rpb24gKG9wdGlvbnMpIHsKICAgICAgICAgICAgdmFyIG1vZGVsID0gdGhpcy5hdCgwKTsKICAgICAgICAgICAgdGhpcy5yZW1vdmUobW9kZWwsIG9wdGlvbnMpOwogICAgICAgICAgICByZXR1cm4gbW9kZWw7CiAgICAgICAgfSwKICAgIAogICAgICAgIC8vIFNsaWNlIG91dCBhIHN1Yi1hcnJheSBvZiBtb2RlbHMgZnJvbSB0aGUgY29sbGVjdGlvbi4KICAgICAgICBzbGljZTogZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gc2xpY2UuYXBwbHkodGhpcy5tb2RlbHMsIGFyZ3VtZW50cyk7CiAgICAgICAgfSwKICAgIAogICAgICAgIC8vIEdldCBhIG1vZGVsIGZyb20gdGhlIHNldCBieSBpZC4KICAgICAgICBnZXQ6IGZ1bmN0aW9uIChvYmopIHsKICAgICAgICAgICAgaWYgKG9iaiA9PSBudWxsKSByZXR1cm4gdm9pZCAwOwogICAgICAgICAgICByZXR1cm4gdGhpcy5fYnlJZFtvYmouaWRdIHx8IHRoaXMuX2J5SWRbb2JqLmNpZF0gfHwgdGhpcy5fYnlJZFtvYmpdOwogICAgICAgIH0sCiAgICAKICAgICAgICAvLyBHZXQgdGhlIG1vZGVsIGF0IHRoZSBnaXZlbiBpbmRleC4KICAgICAgICBhdDogZnVuY3Rpb24gKGluZGV4KSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLm1vZGVsc1tpbmRleF07CiAgICAgICAgfSwKICAgIAogICAgICAgIC8vIFJldHVybiBtb2RlbHMgd2l0aCBtYXRjaGluZyBhdHRyaWJ1dGVzLiBVc2VmdWwgZm9yIHNpbXBsZSBjYXNlcyBvZgogICAgICAgIC8vIGBmaWx0ZXJgLgogICAgICAgIHdoZXJlOiBmdW5jdGlvbiAoYXR0cnMsIGZpcnN0KSB7CiAgICAgICAgICAgIGlmIChfLmlzRW1wdHkoYXR0cnMpKSByZXR1cm4gZmlyc3QgPyB2b2lkIDAgOiBbXTsKICAgICAgICAgICAgcmV0dXJuIHRoaXNbZmlyc3QgPyAnZmluZCcgOiAnZmlsdGVyJ10oZnVuY3Rpb24gKG1vZGVsKSB7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gYXR0cnMpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoYXR0cnMuaGFzT3duUHJvcGVydHkoa2V5KSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoYXR0cnNba2V5XSAhPT0gbW9kZWwuZ2V0KGtleSkpIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKICAgIAogICAgICAgIC8vIFJldHVybiB0aGUgZmlyc3QgbW9kZWwgd2l0aCBtYXRjaGluZyBhdHRyaWJ1dGVzLiBVc2VmdWwgZm9yIHNpbXBsZSBjYXNlcwogICAgICAgIC8vIG9mIGBmaW5kYC4KICAgICAgICBmaW5kV2hlcmU6IGZ1bmN0aW9uIChhdHRycykgewogICAgICAgICAgICByZXR1cm4gdGhpcy53aGVyZShhdHRycywgdHJ1ZSk7CiAgICAgICAgfSwKICAgIAogICAgICAgIC8vIEZvcmNlIHRoZSBjb2xsZWN0aW9uIHRvIHJlLXNvcnQgaXRzZWxmLiBZb3UgZG9uJ3QgbmVlZCB0byBjYWxsIHRoaXMgdW5kZXIKICAgICAgICAvLyBub3JtYWwgY2lyY3Vtc3RhbmNlcywgYXMgdGhlIHNldCB3aWxsIG1haW50YWluIHNvcnQgb3JkZXIgYXMgZWFjaCBpdGVtCiAgICAgICAgLy8gaXMgYWRkZWQuCiAgICAgICAgc29ydDogZnVuY3Rpb24gKG9wdGlvbnMpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmNvbXBhcmF0b3IpIHRocm93IG5ldyBFcnJvcignQ2Fubm90IHNvcnQgYSBzZXQgd2l0aG91dCBhIGNvbXBhcmF0b3InKTsKICAgICAgICAgICAgb3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KTsKICAgIAogICAgICAgICAgICAvLyBSdW4gc29ydCBiYXNlZCBvbiB0eXBlIG9mIGBjb21wYXJhdG9yYC4KICAgICAgICAgICAgaWYgKF8uaXNTdHJpbmcodGhpcy5jb21wYXJhdG9yKSB8fCB0aGlzLmNvbXBhcmF0b3IubGVuZ3RoID09PSAxKSB7CiAgICAgICAgICAgICAgICB0aGlzLm1vZGVscyA9IHRoaXMuc29ydEJ5KHRoaXMuY29tcGFyYXRvciwgdGhpcyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLm1vZGVscy5zb3J0KF8uYmluZCh0aGlzLmNvbXBhcmF0b3IsIHRoaXMpKTsKICAgICAgICAgICAgfQogICAgCiAgICAgICAgICAgIGlmICghb3B0aW9ucy5zaWxlbnQpIHRoaXMudHJpZ2dlcignc29ydCcsIHRoaXMsIG9wdGlvbnMpOwogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9LAogICAgCiAgICAgICAgLy8gRmlndXJlIG91dCB0aGUgc21hbGxlc3QgaW5kZXggYXQgd2hpY2ggYSBtb2RlbCBzaG91bGQgYmUgaW5zZXJ0ZWQgc28gYXMKICAgICAgICAvLyB0byBtYWludGFpbiBvcmRlci4KICAgICAgICBzb3J0ZWRJbmRleDogZnVuY3Rpb24gKG1vZGVsLCB2YWx1ZSwgY29udGV4dCkgewogICAgICAgICAgICB2YWx1ZSB8fCAodmFsdWUgPSB0aGlzLmNvbXBhcmF0b3IpOwogICAgICAgICAgICB2YXIgaXRlcmF0b3IgPSBfLmlzRnVuY3Rpb24odmFsdWUpID8gdmFsdWUgOiBmdW5jdGlvbiAobW9kZWwpIHsKICAgICAgICAgICAgICAgIHJldHVybiBtb2RlbC5nZXQodmFsdWUpOwogICAgICAgICAgICB9OwogICAgICAgICAgICByZXR1cm4gXy5zb3J0ZWRJbmRleCh0aGlzLm1vZGVscywgbW9kZWwsIGl0ZXJhdG9yLCBjb250ZXh0KTsKICAgICAgICB9LAogICAgCiAgICAgICAgLy8gUGx1Y2sgYW4gYXR0cmlidXRlIGZyb20gZWFjaCBtb2RlbCBpbiB0aGUgY29sbGVjdGlvbi4KICAgICAgICBwbHVjazogZnVuY3Rpb24gKGF0dHIpIHsKICAgICAgICAgICAgcmV0dXJuIF8uaW52b2tlKHRoaXMubW9kZWxzLCAnZ2V0JywgYXR0cik7CiAgICAgICAgfSwKICAgIAogICAgICAgIC8vIEZldGNoIHRoZSBkZWZhdWx0IHNldCBvZiBtb2RlbHMgZm9yIHRoaXMgY29sbGVjdGlvbiwgcmVzZXR0aW5nIHRoZQogICAgICAgIC8vIGNvbGxlY3Rpb24gd2hlbiB0aGV5IGFycml2ZS4gSWYgYHJlc2V0OiB0cnVlYCBpcyBwYXNzZWQsIHRoZSByZXNwb25zZQogICAgICAgIC8vIGRhdGEgd2lsbCBiZSBwYXNzZWQgdGhyb3VnaCB0aGUgYHJlc2V0YCBtZXRob2QgaW5zdGVhZCBvZiBgc2V0YC4KICAgICAgICBmZXRjaDogZnVuY3Rpb24gKG9wdGlvbnMpIHsKICAgICAgICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgPyBfLmNsb25lKG9wdGlvbnMpIDoge307CiAgICAgICAgICAgIGlmIChvcHRpb25zLnBhcnNlID09PSB2b2lkIDApIG9wdGlvbnMucGFyc2UgPSB0cnVlOwogICAgICAgICAgICB2YXIgc3VjY2VzcyA9IG9wdGlvbnMuc3VjY2VzczsKICAgICAgICAgICAgdmFyIGNvbGxlY3Rpb24gPSB0aGlzOwogICAgICAgICAgICBvcHRpb25zLnN1Y2Nlc3MgPSBmdW5jdGlvbiAocmVzcCkgewogICAgICAgICAgICAgICAgdmFyIG1ldGhvZCA9IG9wdGlvbnMucmVzZXQgPyAncmVzZXQnIDogJ3NldCc7CiAgICAgICAgICAgICAgICBjb2xsZWN0aW9uW21ldGhvZF0ocmVzcCwgb3B0aW9ucyk7CiAgICAgICAgICAgICAgICBpZiAoc3VjY2Vzcykgc3VjY2Vzcyhjb2xsZWN0aW9uLCByZXNwLCBvcHRpb25zKTsKICAgICAgICAgICAgICAgIGNvbGxlY3Rpb24udHJpZ2dlcignc3luYycsIGNvbGxlY3Rpb24sIHJlc3AsIG9wdGlvbnMpOwogICAgICAgICAgICB9OwogICAgICAgICAgICB3cmFwRXJyb3IodGhpcywgb3B0aW9ucyk7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnN5bmMoJ3JlYWQnLCB0aGlzLCBvcHRpb25zKTsKICAgICAgICB9LAogICAgCiAgICAgICAgLy8gQ3JlYXRlIGEgbmV3IGluc3RhbmNlIG9mIGEgbW9kZWwgaW4gdGhpcyBjb2xsZWN0aW9uLiBBZGQgdGhlIG1vZGVsIHRvIHRoZQogICAgICAgIC8vIGNvbGxlY3Rpb24gaW1tZWRpYXRlbHksIHVubGVzcyBgd2FpdDogdHJ1ZWAgaXMgcGFzc2VkLCBpbiB3aGljaCBjYXNlIHdlCiAgICAgICAgLy8gd2FpdCBmb3IgdGhlIHNlcnZlciB0byBhZ3JlZS4KICAgICAgICBjcmVhdGU6IGZ1bmN0aW9uIChtb2RlbCwgb3B0aW9ucykgewogICAgICAgICAgICBvcHRpb25zID0gb3B0aW9ucyA/IF8uY2xvbmUob3B0aW9ucykgOiB7fTsKICAgICAgICAgICAgaWYgKCEobW9kZWwgPSB0aGlzLl9wcmVwYXJlTW9kZWwobW9kZWwsIG9wdGlvbnMpKSkgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICBpZiAoIW9wdGlvbnMud2FpdCkgdGhpcy5hZGQobW9kZWwsIG9wdGlvbnMpOwogICAgICAgICAgICB2YXIgY29sbGVjdGlvbiA9IHRoaXM7CiAgICAgICAgICAgIHZhciBzdWNjZXNzID0gb3B0aW9ucy5zdWNjZXNzOwogICAgICAgICAgICBvcHRpb25zLnN1Y2Nlc3MgPSBmdW5jdGlvbiAobW9kZWwsIHJlc3AsIG9wdGlvbnMpIHsKICAgICAgICAgICAgICAgIGlmIChvcHRpb25zLndhaXQpIGNvbGxlY3Rpb24uYWRkKG1vZGVsLCBvcHRpb25zKTsKICAgICAgICAgICAgICAgIGlmIChzdWNjZXNzKSBzdWNjZXNzKG1vZGVsLCByZXNwLCBvcHRpb25zKTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgbW9kZWwgaW5zdGFuY2VvZiBNb2RlbCAmJiBtb2RlbC5zYXZlKG51bGwsIG9wdGlvbnMpOwogICAgICAgICAgICByZXR1cm4gbW9kZWw7CiAgICAgICAgfSwKICAgIAogICAgICAgIC8vICoqcGFyc2UqKiBjb252ZXJ0cyBhIHJlc3BvbnNlIGludG8gYSBsaXN0IG9mIG1vZGVscyB0byBiZSBhZGRlZCB0byB0aGUKICAgICAgICAvLyBjb2xsZWN0aW9uLiBUaGUgZGVmYXVsdCBpbXBsZW1lbnRhdGlvbiBpcyBqdXN0IHRvIHBhc3MgaXQgdGhyb3VnaC4KICAgICAgICBwYXJzZTogZnVuY3Rpb24gKHJlc3AsIG9wdGlvbnMpIHsKICAgICAgICAgICAgcmV0dXJuIHJlc3A7CiAgICAgICAgfSwKICAgIAogICAgICAgIC8vIENyZWF0ZSBhIG5ldyBjb2xsZWN0aW9uIHdpdGggYW4gaWRlbnRpY2FsIGxpc3Qgb2YgbW9kZWxzIGFzIHRoaXMgb25lLgogICAgICAgIGNsb25lOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiBuZXcgdGhpcy5jb25zdHJ1Y3Rvcih0aGlzLm1vZGVscyk7CiAgICAgICAgfSwKICAgIAogICAgICAgIC8vIFByaXZhdGUgbWV0aG9kIHRvIHJlc2V0IGFsbCBpbnRlcm5hbCBzdGF0ZS4gQ2FsbGVkIHdoZW4gdGhlIGNvbGxlY3Rpb24KICAgICAgICAvLyBpcyBmaXJzdCBpbml0aWFsaXplZCBvciByZXNldC4KICAgICAgICBfcmVzZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdGhpcy5sZW5ndGggPSAwOwogICAgICAgICAgICB0aGlzLm1vZGVscyA9IFtdOwogICAgICAgICAgICB0aGlzLl9ieUlkID0ge307CiAgICAgICAgfSwKICAgIAogICAgICAgIC8vIFByZXBhcmUgYSBoYXNoIG9mIGF0dHJpYnV0ZXMgKG9yIG90aGVyIG1vZGVsKSB0byBiZSBhZGRlZCB0byB0aGlzCiAgICAgICAgLy8gY29sbGVjdGlvbi4KICAgICAgICBfcHJlcGFyZU1vZGVsOiBmdW5jdGlvbiAoYXR0cnMsIG9wdGlvbnMpIHsKICAgICAgICAgICAgaWYgKGF0dHJzIGluc3RhbmNlb2YgU3RhdGUpIHsKICAgICAgICAgICAgICAgIGlmICghYXR0cnMuY29sbGVjdGlvbikgYXR0cnMuY29sbGVjdGlvbiA9IHRoaXM7CiAgICAgICAgICAgICAgICByZXR1cm4gYXR0cnM7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgb3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KTsKICAgICAgICAgICAgb3B0aW9ucy5jb2xsZWN0aW9uID0gdGhpczsKICAgICAgICAgICAgdmFyIG1vZGVsID0gbmV3IHRoaXMubW9kZWwoYXR0cnMsIG9wdGlvbnMpOwogICAgICAgICAgICBpZiAoIW1vZGVsLnZhbGlkYXRpb25FcnJvcikgcmV0dXJuIG1vZGVsOwogICAgICAgICAgICB0aGlzLnRyaWdnZXIoJ2ludmFsaWQnLCB0aGlzLCBhdHRycywgb3B0aW9ucyk7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9LAogICAgCiAgICAgICAgLy8gSW50ZXJuYWwgbWV0aG9kIHRvIHNldmVyIGEgbW9kZWwncyB0aWVzIHRvIGEgY29sbGVjdGlvbi4KICAgICAgICBfcmVtb3ZlUmVmZXJlbmNlOiBmdW5jdGlvbiAobW9kZWwpIHsKICAgICAgICAgICAgaWYgKHRoaXMgPT09IG1vZGVsLmNvbGxlY3Rpb24pIGRlbGV0ZSBtb2RlbC5jb2xsZWN0aW9uOwogICAgICAgICAgICBtb2RlbC5vZmYoJ2FsbCcsIHRoaXMuX29uTW9kZWxFdmVudCwgdGhpcyk7CiAgICAgICAgfSwKICAgIAogICAgICAgIC8vIEludGVybmFsIG1ldGhvZCBjYWxsZWQgZXZlcnkgdGltZSBhIG1vZGVsIGluIHRoZSBzZXQgZmlyZXMgYW4gZXZlbnQuCiAgICAgICAgLy8gU2V0cyBuZWVkIHRvIHVwZGF0ZSB0aGVpciBpbmRleGVzIHdoZW4gbW9kZWxzIGNoYW5nZSBpZHMuIEFsbCBvdGhlcgogICAgICAgIC8vIGV2ZW50cyBzaW1wbHkgcHJveHkgdGhyb3VnaC4gImFkZCIgYW5kICJyZW1vdmUiIGV2ZW50cyB0aGF0IG9yaWdpbmF0ZQogICAgICAgIC8vIGluIG90aGVyIGNvbGxlY3Rpb25zIGFyZSBpZ25vcmVkLgogICAgICAgIF9vbk1vZGVsRXZlbnQ6IGZ1bmN0aW9uIChldmVudCwgbW9kZWwsIGNvbGxlY3Rpb24sIG9wdGlvbnMpIHsKICAgICAgICAgICAgaWYgKChldmVudCA9PT0gJ2FkZCcgfHwgZXZlbnQgPT09ICdyZW1vdmUnKSAmJiBjb2xsZWN0aW9uICE9PSB0aGlzKSByZXR1cm47CiAgICAgICAgICAgIGlmIChldmVudCA9PT0gJ2Rlc3Ryb3knKSB0aGlzLnJlbW92ZShtb2RlbCwgb3B0aW9ucyk7CiAgICAgICAgICAgIGlmIChtb2RlbCAmJiBldmVudCA9PT0gJ2NoYW5nZTonICsgbW9kZWwuaWRBdHRyaWJ1dGUpIHsKICAgICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLl9ieUlkW21vZGVsLnByZXZpb3VzKG1vZGVsLmlkQXR0cmlidXRlKV07CiAgICAgICAgICAgICAgICBpZiAobW9kZWwuaWQgIT0gbnVsbCkgdGhpcy5fYnlJZFttb2RlbC5pZF0gPSBtb2RlbDsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLnRyaWdnZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICB9CiAgICAKICAgIH0sIEV2ZW50cyk7CiAgICAKICAgIF8uZXh0ZW5kKENvbGxlY3Rpb24ucHJvdG90eXBlLCBFdmVudHMpOwogICAgCiAgICAvLyBVbmRlcnNjb3JlIG1ldGhvZHMgdGhhdCB3ZSB3YW50IHRvIGltcGxlbWVudCBvbiB0aGUgQ29sbGVjdGlvbi4KICAgIC8vIDkwJSBvZiB0aGUgY29yZSB1c2VmdWxuZXNzIG9mIEhhY2tib25lIENvbGxlY3Rpb25zIGlzIGFjdHVhbGx5IGltcGxlbWVudGVkCiAgICAvLyByaWdodCBoZXJlOgogICAgdmFyIG1ldGhvZHMgPSBbJ2ZvckVhY2gnLCAnZWFjaCcsICdtYXAnLCAnY29sbGVjdCcsICdyZWR1Y2UnLCAnZm9sZGwnLAogICAgICAgICdpbmplY3QnLCAncmVkdWNlUmlnaHQnLCAnZm9sZHInLCAnZmluZCcsICdkZXRlY3QnLCAnZmlsdGVyJywgJ3NlbGVjdCcsCiAgICAgICAgJ3JlamVjdCcsICdldmVyeScsICdhbGwnLCAnc29tZScsICdhbnknLCAnaW5jbHVkZScsICdjb250YWlucycsICdpbnZva2UnLAogICAgICAgICdtYXgnLCAnbWluJywgJ3RvQXJyYXknLCAnc2l6ZScsICdmaXJzdCcsICdoZWFkJywgJ3Rha2UnLCAnaW5pdGlhbCcsICdyZXN0JywKICAgICAgICAndGFpbCcsICdkcm9wJywgJ2xhc3QnLCAnd2l0aG91dCcsICdkaWZmZXJlbmNlJywgJ2luZGV4T2YnLCAnc2h1ZmZsZScsCiAgICAgICAgJ2xhc3RJbmRleE9mJywgJ2lzRW1wdHknLCAnY2hhaW4nXTsKICAgIAogICAgLy8gTWl4IGluIGVhY2ggVW5kZXJzY29yZSBtZXRob2QgYXMgYSBwcm94eSB0byBgQ29sbGVjdGlvbiNtb2RlbHNgLgogICAgXy5lYWNoKG1ldGhvZHMsIGZ1bmN0aW9uIChtZXRob2QpIHsKICAgICAgICBDb2xsZWN0aW9uLnByb3RvdHlwZVttZXRob2RdID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzKTsKICAgICAgICAgICAgYXJncy51bnNoaWZ0KHRoaXMubW9kZWxzKTsKICAgICAgICAgICAgcmV0dXJuIF9bbWV0aG9kXS5hcHBseShfLCBhcmdzKTsKICAgICAgICB9OwogICAgfSk7CiAgICAKICAgIC8vIFVuZGVyc2NvcmUgbWV0aG9kcyB0aGF0IHRha2UgYSBwcm9wZXJ0eSBuYW1lIGFzIGFuIGFyZ3VtZW50LgogICAgdmFyIGF0dHJpYnV0ZU1ldGhvZHMgPSBbJ2dyb3VwQnknLCAnY291bnRCeScsICdzb3J0QnknXTsKICAgIAogICAgLy8gVXNlIGF0dHJpYnV0ZXMgaW5zdGVhZCBvZiBwcm9wZXJ0aWVzLgogICAgXy5lYWNoKGF0dHJpYnV0ZU1ldGhvZHMsIGZ1bmN0aW9uIChtZXRob2QpIHsKICAgICAgICBDb2xsZWN0aW9uLnByb3RvdHlwZVttZXRob2RdID0gZnVuY3Rpb24gKHZhbHVlLCBjb250ZXh0KSB7CiAgICAgICAgICAgIHZhciBpdGVyYXRvciA9IF8uaXNGdW5jdGlvbih2YWx1ZSkgPyB2YWx1ZSA6IGZ1bmN0aW9uIChtb2RlbCkgewogICAgICAgICAgICAgICAgcmV0dXJuIG1vZGVsLmdldCh2YWx1ZSk7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHJldHVybiBfW21ldGhvZF0odGhpcy5tb2RlbHMsIGl0ZXJhdG9yLCBjb250ZXh0KTsKICAgICAgICB9OwogICAgfSk7CgogICAgLy8gSGFja2JvbmUuSGlzdG9yeQogICAgLy8gLS0tLS0tLS0tLS0tLS0tLQogICAgCiAgICAvLyBIYW5kbGVzIGNyb3NzLWJyb3dzZXIgaGlzdG9yeSBtYW5hZ2VtZW50LCBiYXNlZCBvbiBlaXRoZXIKICAgIC8vIFtwdXNoU3RhdGVdKGh0dHA6Ly9kaXZlaW50b2h0bWw1LmluZm8vaGlzdG9yeS5odG1sKSBhbmQgcmVhbCBVUkxzLCBvcgogICAgLy8gW29uaGFzaGNoYW5nZV0oaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9ET00vd2luZG93Lm9uaGFzaGNoYW5nZSkKICAgIC8vIGFuZCBVUkwgZnJhZ21lbnRzLiBJZiB0aGUgYnJvd3NlciBzdXBwb3J0cyBuZWl0aGVyIChvbGQgSUUsIG5hdGNoKSwKICAgIC8vIGZhbGxzIGJhY2sgdG8gcG9sbGluZy4KICAgIHZhciBIaXN0b3J5ID0gSGFja2JvbmUuSGlzdG9yeSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICB0aGlzLmhhbmRsZXJzID0gW107CiAgICAgICAgXy5iaW5kQWxsKHRoaXMsICdjaGVja1VybCcpOwogICAgCiAgICAgICAgLy8gRW5zdXJlIHRoYXQgYEhpc3RvcnlgIGNhbiBiZSB1c2VkIG91dHNpZGUgb2YgdGhlIGJyb3dzZXIuCiAgICAgICAgaWYgKHR5cGVvZiB3aW5kb3cgIT09ICd1bmRlZmluZWQnKSB7CiAgICAgICAgICAgIHRoaXMubG9jYXRpb24gPSB3aW5kb3cubG9jYXRpb247CiAgICAgICAgICAgIHRoaXMuaGlzdG9yeSA9IHdpbmRvdy5oaXN0b3J5OwogICAgICAgIH0KICAgIH07CiAgICAKICAgIC8vIENhY2hlZCByZWdleCBmb3Igc3RyaXBwaW5nIGEgbGVhZGluZyBoYXNoL3NsYXNoIGFuZCB0cmFpbGluZyBzcGFjZS4KICAgIHZhciByb3V0ZVN0cmlwcGVyID0gL15bI1wvXXxccyskL2c7CiAgICAKICAgIC8vIENhY2hlZCByZWdleCBmb3Igc3RyaXBwaW5nIGxlYWRpbmcgYW5kIHRyYWlsaW5nIHNsYXNoZXMuCiAgICB2YXIgcm9vdFN0cmlwcGVyID0gL15cLyt8XC8rJC9nOwogICAgCiAgICAvLyBDYWNoZWQgcmVnZXggZm9yIGRldGVjdGluZyBNU0lFLgogICAgdmFyIGlzRXhwbG9yZXIgPSAvbXNpZSBbXHcuXSsvOwogICAgCiAgICAvLyBDYWNoZWQgcmVnZXggZm9yIHJlbW92aW5nIGEgdHJhaWxpbmcgc2xhc2guCiAgICB2YXIgdHJhaWxpbmdTbGFzaCA9IC9cLyQvOwogICAgCiAgICAvLyBIYXMgdGhlIGhpc3RvcnkgaGFuZGxpbmcgYWxyZWFkeSBiZWVuIHN0YXJ0ZWQ/CiAgICBIaXN0b3J5LnN0YXJ0ZWQgPSBmYWxzZTsKICAgIAogICAgLy8gU2V0IHVwIGFsbCBpbmhlcml0YWJsZSAqKkhhY2tib25lLkhpc3RvcnkqKiBwcm9wZXJ0aWVzIGFuZCBtZXRob2RzLgogICAgXy5leHRlbmQoSGlzdG9yeS5wcm90b3R5cGUsIEV2ZW50cywgewogICAgCiAgICAgICAgLy8gVGhlIGRlZmF1bHQgaW50ZXJ2YWwgdG8gcG9sbCBmb3IgaGFzaCBjaGFuZ2VzLCBpZiBuZWNlc3NhcnksIGlzCiAgICAgICAgLy8gdHdlbnR5IHRpbWVzIGEgc2Vjb25kLgogICAgICAgIGludGVydmFsOiA1MCwKICAgIAogICAgICAgIC8vIEdldHMgdGhlIHRydWUgaGFzaCB2YWx1ZS4gQ2Fubm90IHVzZSBsb2NhdGlvbi5oYXNoIGRpcmVjdGx5IGR1ZSB0byBidWcKICAgICAgICAvLyBpbiBGaXJlZm94IHdoZXJlIGxvY2F0aW9uLmhhc2ggd2lsbCBhbHdheXMgYmUgZGVjb2RlZC4KICAgICAgICBnZXRIYXNoOiBmdW5jdGlvbiAod2luZG93KSB7CiAgICAgICAgICAgIHZhciBtYXRjaCA9ICh3aW5kb3cgfHwgdGhpcykubG9jYXRpb24uaHJlZi5tYXRjaCgvIyguKikkLyk7CiAgICAgICAgICAgIHJldHVybiBtYXRjaCA/IG1hdGNoWzFdIDogJyc7CiAgICAgICAgfSwKICAgIAogICAgICAgIC8vIEdldCB0aGUgY3Jvc3MtYnJvd3NlciBub3JtYWxpemVkIFVSTCBmcmFnbWVudCwgZWl0aGVyIGZyb20gdGhlIFVSTCwKICAgICAgICAvLyB0aGUgaGFzaCwgb3IgdGhlIG92ZXJyaWRlLgogICAgICAgIGdldEZyYWdtZW50OiBmdW5jdGlvbiAoZnJhZ21lbnQsIGZvcmNlUHVzaFN0YXRlKSB7CiAgICAgICAgICAgIGlmIChmcmFnbWVudCA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5faGFzUHVzaFN0YXRlIHx8ICF0aGlzLl93YW50c0hhc2hDaGFuZ2UgfHwgZm9yY2VQdXNoU3RhdGUpIHsKICAgICAgICAgICAgICAgICAgICBmcmFnbWVudCA9IHRoaXMubG9jYXRpb24ucGF0aG5hbWU7CiAgICAgICAgICAgICAgICAgICAgdmFyIHJvb3QgPSB0aGlzLnJvb3QucmVwbGFjZSh0cmFpbGluZ1NsYXNoLCAnJyk7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFmcmFnbWVudC5pbmRleE9mKHJvb3QpKSBmcmFnbWVudCA9IGZyYWdtZW50LnNsaWNlKHJvb3QubGVuZ3RoKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgZnJhZ21lbnQgPSB0aGlzLmdldEhhc2goKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZnJhZ21lbnQucmVwbGFjZShyb3V0ZVN0cmlwcGVyLCAnJyk7CiAgICAgICAgfSwKICAgIAogICAgICAgIC8vIFN0YXJ0IHRoZSBoYXNoIGNoYW5nZSBoYW5kbGluZywgcmV0dXJuaW5nIGB0cnVlYCBpZiB0aGUgY3VycmVudCBVUkwgbWF0Y2hlcwogICAgICAgIC8vIGFuIGV4aXN0aW5nIHJvdXRlLCBhbmQgYGZhbHNlYCBvdGhlcndpc2UuCiAgICAgICAgc3RhcnQ6IGZ1bmN0aW9uIChvcHRpb25zKSB7CiAgICAgICAgICAgIGlmIChIaXN0b3J5LnN0YXJ0ZWQpIHRocm93IG5ldyBFcnJvcigiSGFja2JvbmUuaGlzdG9yeSBoYXMgYWxyZWFkeSBiZWVuIHN0YXJ0ZWQiKTsKICAgICAgICAgICAgSGlzdG9yeS5zdGFydGVkID0gdHJ1ZTsKICAgIAogICAgICAgICAgICAvLyBGaWd1cmUgb3V0IHRoZSBpbml0aWFsIGNvbmZpZ3VyYXRpb24uIERvIHdlIG5lZWQgYW4gaWZyYW1lPwogICAgICAgICAgICAvLyBJcyBwdXNoU3RhdGUgZGVzaXJlZCAuLi4gaXMgaXQgYXZhaWxhYmxlPwogICAgICAgICAgICB0aGlzLm9wdGlvbnMgPSBfLmV4dGVuZCh7fSwge3Jvb3Q6ICcvJ30sIHRoaXMub3B0aW9ucywgb3B0aW9ucyk7CiAgICAgICAgICAgIHRoaXMucm9vdCA9IHRoaXMub3B0aW9ucy5yb290OwogICAgICAgICAgICB0aGlzLl93YW50c0hhc2hDaGFuZ2UgPSB0aGlzLm9wdGlvbnMuaGFzaENoYW5nZSAhPT0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuX3dhbnRzUHVzaFN0YXRlID0gISF0aGlzLm9wdGlvbnMucHVzaFN0YXRlOwogICAgICAgICAgICB0aGlzLl9oYXNQdXNoU3RhdGUgPSAhISh0aGlzLm9wdGlvbnMucHVzaFN0YXRlICYmIHRoaXMuaGlzdG9yeSAmJiB0aGlzLmhpc3RvcnkucHVzaFN0YXRlKTsKICAgICAgICAgICAgdmFyIGZyYWdtZW50ID0gdGhpcy5nZXRGcmFnbWVudCgpOwogICAgICAgICAgICB2YXIgZG9jTW9kZSA9IGRvY3VtZW50LmRvY3VtZW50TW9kZTsKICAgICAgICAgICAgdmFyIG9sZElFID0gKGlzRXhwbG9yZXIuZXhlYyhuYXZpZ2F0b3IudXNlckFnZW50LnRvTG93ZXJDYXNlKCkpICYmICghZG9jTW9kZSB8fCBkb2NNb2RlIDw9IDcpKTsKICAgIAogICAgICAgICAgICAvLyBOb3JtYWxpemUgcm9vdCB0byBhbHdheXMgaW5jbHVkZSBhIGxlYWRpbmcgYW5kIHRyYWlsaW5nIHNsYXNoLgogICAgICAgICAgICB0aGlzLnJvb3QgPSAoJy8nICsgdGhpcy5yb290ICsgJy8nKS5yZXBsYWNlKHJvb3RTdHJpcHBlciwgJy8nKTsKICAgIAogICAgICAgICAgICBpZiAob2xkSUUgJiYgdGhpcy5fd2FudHNIYXNoQ2hhbmdlKSB7CiAgICAgICAgICAgICAgICB0aGlzLmlmcmFtZSA9IEhhY2tib25lLiQoJzxpZnJhbWUgc3JjPSJqYXZhc2NyaXB0OjAiIHRhYmluZGV4PSItMSIgLz4nKS5oaWRlKCkuYXBwZW5kVG8oJ2JvZHknKVswXS5jb250ZW50V2luZG93OwogICAgICAgICAgICAgICAgdGhpcy5uYXZpZ2F0ZShmcmFnbWVudCk7CiAgICAgICAgICAgIH0KICAgIAogICAgICAgICAgICAvLyBEZXBlbmRpbmcgb24gd2hldGhlciB3ZSdyZSB1c2luZyBwdXNoU3RhdGUgb3IgaGFzaGVzLCBhbmQgd2hldGhlcgogICAgICAgICAgICAvLyAnb25oYXNoY2hhbmdlJyBpcyBzdXBwb3J0ZWQsIGRldGVybWluZSBob3cgd2UgY2hlY2sgdGhlIFVSTCBzdGF0ZS4KICAgICAgICAgICAgaWYgKHRoaXMuX2hhc1B1c2hTdGF0ZSkgewogICAgICAgICAgICAgICAgSGFja2JvbmUuJCh3aW5kb3cpLm9uKCdwb3BzdGF0ZScsIHRoaXMuY2hlY2tVcmwpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuX3dhbnRzSGFzaENoYW5nZSAmJiAoJ29uaGFzaGNoYW5nZScgaW4gd2luZG93KSAmJiAhb2xkSUUpIHsKICAgICAgICAgICAgICAgIEhhY2tib25lLiQod2luZG93KS5vbignaGFzaGNoYW5nZScsIHRoaXMuY2hlY2tVcmwpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuX3dhbnRzSGFzaENoYW5nZSkgewogICAgICAgICAgICAgICAgdGhpcy5fY2hlY2tVcmxJbnRlcnZhbCA9IHNldEludGVydmFsKHRoaXMuY2hlY2tVcmwsIHRoaXMuaW50ZXJ2YWwpOwogICAgICAgICAgICB9CiAgICAKICAgICAgICAgICAgLy8gRGV0ZXJtaW5lIGlmIHdlIG5lZWQgdG8gY2hhbmdlIHRoZSBiYXNlIHVybCwgZm9yIGEgcHVzaFN0YXRlIGxpbmsKICAgICAgICAgICAgLy8gb3BlbmVkIGJ5IGEgbm9uLXB1c2hTdGF0ZSBicm93c2VyLgogICAgICAgICAgICB0aGlzLmZyYWdtZW50ID0gZnJhZ21lbnQ7CiAgICAgICAgICAgIHZhciBsb2MgPSB0aGlzLmxvY2F0aW9uOwogICAgICAgICAgICB2YXIgYXRSb290ID0gbG9jLnBhdGhuYW1lLnJlcGxhY2UoL1teXC9dJC8sICckJi8nKSA9PT0gdGhpcy5yb290OwogICAgCiAgICAgICAgICAgIC8vIFRyYW5zaXRpb24gZnJvbSBoYXNoQ2hhbmdlIHRvIHB1c2hTdGF0ZSBvciB2aWNlIHZlcnNhIGlmIGJvdGggYXJlCiAgICAgICAgICAgIC8vIHJlcXVlc3RlZC4KICAgICAgICAgICAgaWYgKHRoaXMuX3dhbnRzSGFzaENoYW5nZSAmJiB0aGlzLl93YW50c1B1c2hTdGF0ZSkgewogICAgCiAgICAgICAgICAgICAgICAvLyBJZiB3ZSd2ZSBzdGFydGVkIG9mZiB3aXRoIGEgcm91dGUgZnJvbSBhIGBwdXNoU3RhdGVgLWVuYWJsZWQKICAgICAgICAgICAgICAgIC8vIGJyb3dzZXIsIGJ1dCB3ZSdyZSBjdXJyZW50bHkgaW4gYSBicm93c2VyIHRoYXQgZG9lc24ndCBzdXBwb3J0IGl0Li4uCiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuX2hhc1B1c2hTdGF0ZSAmJiAhYXRSb290KSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5mcmFnbWVudCA9IHRoaXMuZ2V0RnJhZ21lbnQobnVsbCwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5sb2NhdGlvbi5yZXBsYWNlKHRoaXMucm9vdCArIHRoaXMubG9jYXRpb24uc2VhcmNoICsgJyMnICsgdGhpcy5mcmFnbWVudCk7CiAgICAgICAgICAgICAgICAgICAgLy8gUmV0dXJuIGltbWVkaWF0ZWx5IGFzIGJyb3dzZXIgd2lsbCBkbyByZWRpcmVjdCB0byBuZXcgdXJsCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAKICAgICAgICAgICAgICAgICAgICAvLyBPciBpZiB3ZSd2ZSBzdGFydGVkIG91dCB3aXRoIGEgaGFzaC1iYXNlZCByb3V0ZSwgYnV0IHdlJ3JlIGN1cnJlbnRseQogICAgICAgICAgICAgICAgICAgIC8vIGluIGEgYnJvd3NlciB3aGVyZSBpdCBjb3VsZCBiZSBgcHVzaFN0YXRlYC1iYXNlZCBpbnN0ZWFkLi4uCiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuX2hhc1B1c2hTdGF0ZSAmJiBhdFJvb3QgJiYgbG9jLmhhc2gpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmZyYWdtZW50ID0gdGhpcy5nZXRIYXNoKCkucmVwbGFjZShyb3V0ZVN0cmlwcGVyLCAnJyk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5oaXN0b3J5LnJlcGxhY2VTdGF0ZSh7fSwgZG9jdW1lbnQudGl0bGUsIHRoaXMucm9vdCArIHRoaXMuZnJhZ21lbnQgKyBsb2Muc2VhcmNoKTsKICAgICAgICAgICAgICAgIH0KICAgIAogICAgICAgICAgICB9CiAgICAKICAgICAgICAgICAgaWYgKCF0aGlzLm9wdGlvbnMuc2lsZW50KSByZXR1cm4gdGhpcy5sb2FkVXJsKCk7CiAgICAgICAgfSwKICAgIAogICAgICAgIC8vIERpc2FibGUgSGFja2JvbmUuaGlzdG9yeSwgcGVyaGFwcyB0ZW1wb3JhcmlseS4gTm90IHVzZWZ1bCBpbiBhIHJlYWwgYXBwLAogICAgICAgIC8vIGJ1dCBwb3NzaWJseSB1c2VmdWwgZm9yIHVuaXQgdGVzdGluZyBSb3V0ZXJzLgogICAgICAgIHN0b3A6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgSGFja2JvbmUuJCh3aW5kb3cpLm9mZigncG9wc3RhdGUnLCB0aGlzLmNoZWNrVXJsKS5vZmYoJ2hhc2hjaGFuZ2UnLCB0aGlzLmNoZWNrVXJsKTsKICAgICAgICAgICAgY2xlYXJJbnRlcnZhbCh0aGlzLl9jaGVja1VybEludGVydmFsKTsKICAgICAgICAgICAgSGlzdG9yeS5zdGFydGVkID0gZmFsc2U7CiAgICAgICAgfSwKICAgIAogICAgICAgIC8vIEFkZCBhIHJvdXRlIHRvIGJlIHRlc3RlZCB3aGVuIHRoZSBmcmFnbWVudCBjaGFuZ2VzLiBSb3V0ZXMgYWRkZWQgbGF0ZXIKICAgICAgICAvLyBtYXkgb3ZlcnJpZGUgcHJldmlvdXMgcm91dGVzLgogICAgICAgIHJvdXRlOiBmdW5jdGlvbiAocm91dGUsIGNhbGxiYWNrKSB7CiAgICAgICAgICAgIHRoaXMuaGFuZGxlcnMudW5zaGlmdCh7cm91dGU6IHJvdXRlLCBjYWxsYmFjazogY2FsbGJhY2t9KTsKICAgICAgICB9LAogICAgCiAgICAgICAgLy8gQ2hlY2tzIHRoZSBjdXJyZW50IFVSTCB0byBzZWUgaWYgaXQgaGFzIGNoYW5nZWQsIGFuZCBpZiBpdCBoYXMsCiAgICAgICAgLy8gY2FsbHMgYGxvYWRVcmxgLCBub3JtYWxpemluZyBhY3Jvc3MgdGhlIGhpZGRlbiBpZnJhbWUuCiAgICAgICAgY2hlY2tVcmw6IGZ1bmN0aW9uIChlKSB7CiAgICAgICAgICAgIHZhciBjdXJyZW50ID0gdGhpcy5nZXRGcmFnbWVudCgpOwogICAgICAgICAgICBpZiAoY3VycmVudCA9PT0gdGhpcy5mcmFnbWVudCAmJiB0aGlzLmlmcmFtZSkgewogICAgICAgICAgICAgICAgY3VycmVudCA9IHRoaXMuZ2V0RnJhZ21lbnQodGhpcy5nZXRIYXNoKHRoaXMuaWZyYW1lKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGN1cnJlbnQgPT09IHRoaXMuZnJhZ21lbnQpIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgaWYgKHRoaXMuaWZyYW1lKSB0aGlzLm5hdmlnYXRlKGN1cnJlbnQpOwogICAgICAgICAgICB0aGlzLmxvYWRVcmwoKTsKICAgICAgICB9LAogICAgCiAgICAgICAgLy8gQXR0ZW1wdCB0byBsb2FkIHRoZSBjdXJyZW50IFVSTCBmcmFnbWVudC4gSWYgYSByb3V0ZSBzdWNjZWVkcyB3aXRoIGEKICAgICAgICAvLyBtYXRjaCwgcmV0dXJucyBgdHJ1ZWAuIElmIG5vIGRlZmluZWQgcm91dGVzIG1hdGNoZXMgdGhlIGZyYWdtZW50LAogICAgICAgIC8vIHJldHVybnMgYGZhbHNlYC4KICAgICAgICBsb2FkVXJsOiBmdW5jdGlvbiAoZnJhZ21lbnRPdmVycmlkZSkgewogICAgICAgICAgICB2YXIgZnJhZ21lbnQgPSB0aGlzLmZyYWdtZW50ID0gdGhpcy5nZXRGcmFnbWVudChmcmFnbWVudE92ZXJyaWRlKTsKICAgICAgICAgICAgcmV0dXJuIF8uYW55KHRoaXMuaGFuZGxlcnMsIGZ1bmN0aW9uIChoYW5kbGVyKSB7CiAgICAgICAgICAgICAgICBpZiAoaGFuZGxlci5yb3V0ZS50ZXN0KGZyYWdtZW50KSkgewogICAgICAgICAgICAgICAgICAgIGhhbmRsZXIuY2FsbGJhY2soZnJhZ21lbnQpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9LAogICAgCiAgICAgICAgLy8gU2F2ZSBhIGZyYWdtZW50IGludG8gdGhlIGhhc2ggaGlzdG9yeSwgb3IgcmVwbGFjZSB0aGUgVVJMIHN0YXRlIGlmIHRoZQogICAgICAgIC8vICdyZXBsYWNlJyBvcHRpb24gaXMgcGFzc2VkLiBZb3UgYXJlIHJlc3BvbnNpYmxlIGZvciBwcm9wZXJseSBVUkwtZW5jb2RpbmcKICAgICAgICAvLyB0aGUgZnJhZ21lbnQgaW4gYWR2YW5jZS4KICAgICAgICAvLwogICAgICAgIC8vIFRoZSBvcHRpb25zIG9iamVjdCBjYW4gY29udGFpbiBgdHJpZ2dlcjogdHJ1ZWAgaWYgeW91IHdpc2ggdG8gaGF2ZSB0aGUKICAgICAgICAvLyByb3V0ZSBjYWxsYmFjayBiZSBmaXJlZCAobm90IHVzdWFsbHkgZGVzaXJhYmxlKSwgb3IgYHJlcGxhY2U6IHRydWVgLCBpZgogICAgICAgIC8vIHlvdSB3aXNoIHRvIG1vZGlmeSB0aGUgY3VycmVudCBVUkwgd2l0aG91dCBhZGRpbmcgYW4gZW50cnkgdG8gdGhlIGhpc3RvcnkuCiAgICAgICAgbmF2aWdhdGU6IGZ1bmN0aW9uIChmcmFnbWVudCwgb3B0aW9ucykgewogICAgICAgICAgICBpZiAoIUhpc3Rvcnkuc3RhcnRlZCkgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICBpZiAoIW9wdGlvbnMgfHwgb3B0aW9ucyA9PT0gdHJ1ZSkgb3B0aW9ucyA9IHt0cmlnZ2VyOiAhIW9wdGlvbnN9OwogICAgCiAgICAgICAgICAgIGZyYWdtZW50ID0gdGhpcy5nZXRGcmFnbWVudChmcmFnbWVudCB8fCAnJyk7CiAgICAgICAgICAgIGlmICh0aGlzLmZyYWdtZW50ID09PSBmcmFnbWVudCkgcmV0dXJuOwogICAgICAgICAgICB0aGlzLmZyYWdtZW50ID0gZnJhZ21lbnQ7CiAgICAKICAgICAgICAgICAgdmFyIHVybCA9IHRoaXMucm9vdCArIGZyYWdtZW50OwogICAgCiAgICAgICAgICAgIC8vIERvbid0IGluY2x1ZGUgYSB0cmFpbGluZyBzbGFzaCBvbiB0aGUgcm9vdC4KICAgICAgICAgICAgaWYgKGZyYWdtZW50ID09PSAnJyAmJiB1cmwgIT09ICcvJykgdXJsID0gdXJsLnNsaWNlKDAsIC0xKTsKICAgIAogICAgICAgICAgICAvLyBJZiBwdXNoU3RhdGUgaXMgYXZhaWxhYmxlLCB3ZSB1c2UgaXQgdG8gc2V0IHRoZSBmcmFnbWVudCBhcyBhIHJlYWwgVVJMLgogICAgICAgICAgICBpZiAodGhpcy5faGFzUHVzaFN0YXRlKSB7CiAgICAgICAgICAgICAgICB0aGlzLmhpc3Rvcnlbb3B0aW9ucy5yZXBsYWNlID8gJ3JlcGxhY2VTdGF0ZScgOiAncHVzaFN0YXRlJ10oe30sIGRvY3VtZW50LnRpdGxlLCB1cmwpOwogICAgCiAgICAgICAgICAgICAgICAvLyBJZiBoYXNoIGNoYW5nZXMgaGF2ZW4ndCBiZWVuIGV4cGxpY2l0bHkgZGlzYWJsZWQsIHVwZGF0ZSB0aGUgaGFzaAogICAgICAgICAgICAgICAgLy8gZnJhZ21lbnQgdG8gc3RvcmUgaGlzdG9yeS4KICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLl93YW50c0hhc2hDaGFuZ2UpIHsKICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZUhhc2godGhpcy5sb2NhdGlvbiwgZnJhZ21lbnQsIG9wdGlvbnMucmVwbGFjZSk7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5pZnJhbWUgJiYgKGZyYWdtZW50ICE9PSB0aGlzLmdldEZyYWdtZW50KHRoaXMuZ2V0SGFzaCh0aGlzLmlmcmFtZSkpKSkgewogICAgICAgICAgICAgICAgICAgIC8vIE9wZW5pbmcgYW5kIGNsb3NpbmcgdGhlIGlmcmFtZSB0cmlja3MgSUU3IGFuZCBlYXJsaWVyIHRvIHB1c2ggYQogICAgICAgICAgICAgICAgICAgIC8vIGhpc3RvcnkgZW50cnkgb24gaGFzaC10YWcgY2hhbmdlLiAgV2hlbiByZXBsYWNlIGlzIHRydWUsIHdlIGRvbid0CiAgICAgICAgICAgICAgICAgICAgLy8gd2FudCB0aGlzLgogICAgICAgICAgICAgICAgICAgIGlmICghb3B0aW9ucy5yZXBsYWNlKSB0aGlzLmlmcmFtZS5kb2N1bWVudC5vcGVuKCkuY2xvc2UoKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVIYXNoKHRoaXMuaWZyYW1lLmxvY2F0aW9uLCBmcmFnbWVudCwgb3B0aW9ucy5yZXBsYWNlKTsKICAgICAgICAgICAgICAgIH0KICAgIAogICAgICAgICAgICAgICAgLy8gSWYgeW91J3ZlIHRvbGQgdXMgdGhhdCB5b3UgZXhwbGljaXRseSBkb24ndCB3YW50IGZhbGxiYWNrIGhhc2hjaGFuZ2UtCiAgICAgICAgICAgICAgICAvLyBiYXNlZCBoaXN0b3J5LCB0aGVuIGBuYXZpZ2F0ZWAgYmVjb21lcyBhIHBhZ2UgcmVmcmVzaC4KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmxvY2F0aW9uLmFzc2lnbih1cmwpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChvcHRpb25zLnRyaWdnZXIpIHJldHVybiB0aGlzLmxvYWRVcmwoZnJhZ21lbnQpOwogICAgICAgIH0sCiAgICAKICAgICAgICAvLyBVcGRhdGUgdGhlIGhhc2ggbG9jYXRpb24sIGVpdGhlciByZXBsYWNpbmcgdGhlIGN1cnJlbnQgZW50cnksIG9yIGFkZGluZwogICAgICAgIC8vIGEgbmV3IG9uZSB0byB0aGUgYnJvd3NlciBoaXN0b3J5LgogICAgICAgIF91cGRhdGVIYXNoOiBmdW5jdGlvbiAobG9jYXRpb24sIGZyYWdtZW50LCByZXBsYWNlKSB7CiAgICAgICAgICAgIGlmIChyZXBsYWNlKSB7CiAgICAgICAgICAgICAgICB2YXIgaHJlZiA9IGxvY2F0aW9uLmhyZWYucmVwbGFjZSgvKGphdmFzY3JpcHQ6fCMpLiokLywgJycpOwogICAgICAgICAgICAgICAgbG9jYXRpb24ucmVwbGFjZShocmVmICsgJyMnICsgZnJhZ21lbnQpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gU29tZSBicm93c2VycyByZXF1aXJlIHRoYXQgYGhhc2hgIGNvbnRhaW5zIGEgbGVhZGluZyAjLgogICAgICAgICAgICAgICAgbG9jYXRpb24uaGFzaCA9ICcjJyArIGZyYWdtZW50OwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgCiAgICB9KTsKICAgIAogICAgLy8gQ3JlYXRlIHRoZSBkZWZhdWx0IEhhY2tib25lLmhpc3RvcnkuCiAgICBIYWNrYm9uZS5oaXN0b3J5ID0gbmV3IEhpc3Rvcnk7CgogICAgLy8gSGFja2JvbmUuUm91dGVyCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0KICAgIAogICAgLy8gQ2FjaGVkIHJlZ3VsYXIgZXhwcmVzc2lvbnMgZm9yIG1hdGNoaW5nIG5hbWVkIHBhcmFtIHBhcnRzIGFuZCBzcGxhdHRlZAogICAgLy8gcGFydHMgb2Ygcm91dGUgc3RyaW5ncy4KICAgIHZhciBvcHRpb25hbFBhcmFtID0gL1woKC4qPylcKS9nOwogICAgdmFyIG5hbWVkUGFyYW0gPSAvKFwoXD8pPzpcdysvZzsKICAgIHZhciBzcGxhdFBhcmFtID0gL1wqXHcrL2c7CiAgICB2YXIgZXNjYXBlUmVnRXhwID0gL1tcLXt9XFtcXSs/LixcXFxeJHwjXHNdL2c7CiAgICAKICAgIC8vIFJvdXRlcnMgbWFwIGZhdXgtVVJMcyB0byBhY3Rpb25zLCBhbmQgZmlyZSBldmVudHMgd2hlbiByb3V0ZXMgYXJlCiAgICAvLyBtYXRjaGVkLiBDcmVhdGluZyBhIG5ldyBvbmUgc2V0cyBpdHMgYHJvdXRlc2AgaGFzaCwgaWYgbm90IHNldCBzdGF0aWNhbGx5LgogICAgdmFyIFJvdXRlciA9IEhhY2tib25lLlJvdXRlciA9IENvbXBvbmVudC5leHRlbmQoewogICAgICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbiAob3B0aW9ucykgewogICAgICAgICAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwogICAgICAgICAgICBpZiAob3B0aW9ucy5yb3V0ZXMpIHRoaXMucm91dGVzID0gb3B0aW9ucy5yb3V0ZXM7CiAgICAgICAgICAgIHRoaXMuX2JpbmRSb3V0ZXMoKTsKICAgICAgICAgICAgdGhpcy5pbml0aWFsaXplLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgfSwKICAgIAogICAgICAgIC8vIE1hbnVhbGx5IGJpbmQgYSBzaW5nbGUgbmFtZWQgcm91dGUgdG8gYSBjYWxsYmFjay4gRm9yIGV4YW1wbGU6CiAgICAgICAgLy8KICAgICAgICAvLyAgICAgdGhpcy5yb3V0ZSgnc2VhcmNoLzpxdWVyeS9wOm51bScsICdzZWFyY2gnLCBmdW5jdGlvbihxdWVyeSwgbnVtKSB7CiAgICAgICAgLy8gICAgICAgLi4uCiAgICAgICAgLy8gICAgIH0pOwogICAgICAgIC8vCiAgICAgICAgcm91dGU6IGZ1bmN0aW9uIChyb3V0ZSwgbmFtZSwgY2FsbGJhY2spIHsKICAgICAgICAgICAgaWYgKCFfLmlzUmVnRXhwKHJvdXRlKSkgcm91dGUgPSB0aGlzLl9yb3V0ZVRvUmVnRXhwKHJvdXRlKTsKICAgICAgICAgICAgaWYgKF8uaXNGdW5jdGlvbihuYW1lKSkgewogICAgICAgICAgICAgICAgY2FsbGJhY2sgPSBuYW1lOwogICAgICAgICAgICAgICAgbmFtZSA9ICcnOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICghY2FsbGJhY2spIGNhbGxiYWNrID0gdGhpc1tuYW1lXTsKICAgICAgICAgICAgdmFyIHJvdXRlciA9IHRoaXM7CiAgICAgICAgICAgIEhhY2tib25lLmhpc3Rvcnkucm91dGUocm91dGUsIGZ1bmN0aW9uIChmcmFnbWVudCkgewogICAgICAgICAgICAgICAgdmFyIGFyZ3MgPSByb3V0ZXIuX2V4dHJhY3RQYXJhbWV0ZXJzKHJvdXRlLCBmcmFnbWVudCk7CiAgICAgICAgICAgICAgICBjYWxsYmFjayAmJiBjYWxsYmFjay5hcHBseShyb3V0ZXIsIGFyZ3MpOwogICAgICAgICAgICAgICAgcm91dGVyLnRyaWdnZXIuYXBwbHkocm91dGVyLCBbJ3JvdXRlOicgKyBuYW1lXS5jb25jYXQoYXJncykpOwogICAgICAgICAgICAgICAgcm91dGVyLnRyaWdnZXIoJ3JvdXRlJywgbmFtZSwgYXJncyk7CiAgICAgICAgICAgICAgICBIYWNrYm9uZS5oaXN0b3J5LnRyaWdnZXIoJ3JvdXRlJywgcm91dGVyLCBuYW1lLCBhcmdzKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCiAgICAKICAgICAgICAvLyBTaW1wbGUgcHJveHkgdG8gYEhhY2tib25lLmhpc3RvcnlgIHRvIHNhdmUgYSBmcmFnbWVudCBpbnRvIHRoZSBoaXN0b3J5LgogICAgICAgIG5hdmlnYXRlOiBmdW5jdGlvbiAoZnJhZ21lbnQsIG9wdGlvbnMpIHsKICAgICAgICAgICAgSGFja2JvbmUuaGlzdG9yeS5uYXZpZ2F0ZShmcmFnbWVudCwgb3B0aW9ucyk7CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCiAgICAKICAgICAgICAvLyBCaW5kIGFsbCBkZWZpbmVkIHJvdXRlcyB0byBgSGFja2JvbmUuaGlzdG9yeWAuIFdlIGhhdmUgdG8gcmV2ZXJzZSB0aGUKICAgICAgICAvLyBvcmRlciBvZiB0aGUgcm91dGVzIGhlcmUgdG8gc3VwcG9ydCBiZWhhdmlvciB3aGVyZSB0aGUgbW9zdCBnZW5lcmFsCiAgICAgICAgLy8gcm91dGVzIGNhbiBiZSBkZWZpbmVkIGF0IHRoZSBib3R0b20gb2YgdGhlIHJvdXRlIG1hcC4KICAgICAgICBfYmluZFJvdXRlczogZnVuY3Rpb24gKCkgewogICAgICAgICAgICBpZiAoIXRoaXMucm91dGVzKSByZXR1cm47CiAgICAgICAgICAgIHRoaXMucm91dGVzID0gXy5yZXN1bHQodGhpcywgJ3JvdXRlcycpOwogICAgICAgICAgICB2YXIgcm91dGUsIHJvdXRlcyA9IF8ua2V5cyh0aGlzLnJvdXRlcyk7CiAgICAgICAgICAgIHdoaWxlICgocm91dGUgPSByb3V0ZXMucG9wKCkpICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHRoaXMucm91dGUocm91dGUsIHRoaXMucm91dGVzW3JvdXRlXSk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgCiAgICAgICAgLy8gQ29udmVydCBhIHJvdXRlIHN0cmluZyBpbnRvIGEgcmVndWxhciBleHByZXNzaW9uLCBzdWl0YWJsZSBmb3IgbWF0Y2hpbmcKICAgICAgICAvLyBhZ2FpbnN0IHRoZSBjdXJyZW50IGxvY2F0aW9uIGhhc2guCiAgICAgICAgX3JvdXRlVG9SZWdFeHA6IGZ1bmN0aW9uIChyb3V0ZSkgewogICAgICAgICAgICByb3V0ZSA9IHJvdXRlLnJlcGxhY2UoZXNjYXBlUmVnRXhwLCAnXFwkJicpCiAgICAgICAgICAgICAgICAucmVwbGFjZShvcHRpb25hbFBhcmFtLCAnKD86JDEpPycpCiAgICAgICAgICAgICAgICAucmVwbGFjZShuYW1lZFBhcmFtLCBmdW5jdGlvbiAobWF0Y2gsIG9wdGlvbmFsKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG9wdGlvbmFsID8gbWF0Y2ggOiAnKFteXC9dKyknOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC5yZXBsYWNlKHNwbGF0UGFyYW0sICcoLio/KScpOwogICAgICAgICAgICByZXR1cm4gbmV3IFJlZ0V4cCgnXicgKyByb3V0ZSArICckJyk7CiAgICAgICAgfSwKICAgIAogICAgICAgIC8vIEdpdmVuIGEgcm91dGUsIGFuZCBhIFVSTCBmcmFnbWVudCB0aGF0IGl0IG1hdGNoZXMsIHJldHVybiB0aGUgYXJyYXkgb2YKICAgICAgICAvLyBleHRyYWN0ZWQgZGVjb2RlZCBwYXJhbWV0ZXJzLiBFbXB0eSBvciB1bm1hdGNoZWQgcGFyYW1ldGVycyB3aWxsIGJlCiAgICAgICAgLy8gdHJlYXRlZCBhcyBgbnVsbGAgdG8gbm9ybWFsaXplIGNyb3NzLWJyb3dzZXIgYmVoYXZpb3IuCiAgICAgICAgX2V4dHJhY3RQYXJhbWV0ZXJzOiBmdW5jdGlvbiAocm91dGUsIGZyYWdtZW50KSB7CiAgICAgICAgICAgIHZhciBwYXJhbXMgPSByb3V0ZS5leGVjKGZyYWdtZW50KS5zbGljZSgxKTsKICAgICAgICAgICAgcmV0dXJuIF8ubWFwKHBhcmFtcywgZnVuY3Rpb24gKHBhcmFtKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gcGFyYW0gPyBkZWNvZGVVUklDb21wb25lbnQocGFyYW0pIDogbnVsbDsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgfSk7CiAgICAKICAgIF8uZXh0ZW5kKFJvdXRlci5wcm90b3R5cGUsIEV2ZW50cyk7CgogICAgLy8gSGFja2JvbmUuc3luYwogICAgLy8gLS0tLS0tLS0tLS0tLQogICAgCiAgICAvLyBPdmVycmlkZSB0aGlzIGZ1bmN0aW9uIHRvIGNoYW5nZSB0aGUgbWFubmVyIGluIHdoaWNoIEhhY2tib25lIHBlcnNpc3RzCiAgICAvLyBtb2RlbHMgdG8gdGhlIHNlcnZlci4gWW91IHdpbGwgYmUgcGFzc2VkIHRoZSB0eXBlIG9mIHJlcXVlc3QsIGFuZCB0aGUKICAgIC8vIG1vZGVsIGluIHF1ZXN0aW9uLiBCeSBkZWZhdWx0LCBtYWtlcyBhIFJFU1RmdWwgQWpheCByZXF1ZXN0CiAgICAvLyB0byB0aGUgbW9kZWwncyBgdXJsKClgLiBTb21lIHBvc3NpYmxlIGN1c3RvbWl6YXRpb25zIGNvdWxkIGJlOgogICAgLy8KICAgIC8vICogVXNlIGBzZXRUaW1lb3V0YCB0byBiYXRjaCByYXBpZC1maXJlIHVwZGF0ZXMgaW50byBhIHNpbmdsZSByZXF1ZXN0LgogICAgLy8gKiBTZW5kIHVwIHRoZSBtb2RlbHMgYXMgWE1MIGluc3RlYWQgb2YgSlNPTi4KICAgIC8vICogUGVyc2lzdCBtb2RlbHMgdmlhIFdlYlNvY2tldHMgaW5zdGVhZCBvZiBBamF4LgogICAgLy8KICAgIC8vIFR1cm4gb24gYEhhY2tib25lLmVtdWxhdGVIVFRQYCBpbiBvcmRlciB0byBzZW5kIGBQVVRgIGFuZCBgREVMRVRFYCByZXF1ZXN0cwogICAgLy8gYXMgYFBPU1RgLCB3aXRoIGEgYF9tZXRob2RgIHBhcmFtZXRlciBjb250YWluaW5nIHRoZSB0cnVlIEhUVFAgbWV0aG9kLAogICAgLy8gYXMgd2VsbCBhcyBhbGwgcmVxdWVzdHMgd2l0aCB0aGUgYm9keSBhcyBgYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkYAogICAgLy8gaW5zdGVhZCBvZiBgYXBwbGljYXRpb24vanNvbmAgd2l0aCB0aGUgbW9kZWwgaW4gYSBwYXJhbSBuYW1lZCBgbW9kZWxgLgogICAgLy8gVXNlZnVsIHdoZW4gaW50ZXJmYWNpbmcgd2l0aCBzZXJ2ZXItc2lkZSBsYW5ndWFnZXMgbGlrZSAqKlBIUCoqIHRoYXQgbWFrZQogICAgLy8gaXQgZGlmZmljdWx0IHRvIHJlYWQgdGhlIGJvZHkgb2YgYFBVVGAgcmVxdWVzdHMuCiAgICBIYWNrYm9uZS5zeW5jID0gZnVuY3Rpb24gKG1ldGhvZCwgbW9kZWwsIG9wdGlvbnMpIHsKICAgICAgICB2YXIgdHlwZSA9IG1ldGhvZE1hcFttZXRob2RdOwogICAgCiAgICAgICAgLy8gRGVmYXVsdCBvcHRpb25zLCB1bmxlc3Mgc3BlY2lmaWVkLgogICAgICAgIF8uZGVmYXVsdHMob3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KSwgewogICAgICAgICAgICBlbXVsYXRlSFRUUDogSGFja2JvbmUuZW11bGF0ZUhUVFAsCiAgICAgICAgICAgIGVtdWxhdGVKU09OOiBIYWNrYm9uZS5lbXVsYXRlSlNPTgogICAgICAgIH0pOwogICAgCiAgICAgICAgLy8gRGVmYXVsdCBKU09OLXJlcXVlc3Qgb3B0aW9ucy4KICAgICAgICB2YXIgcGFyYW1zID0ge3R5cGU6IHR5cGUsIGRhdGFUeXBlOiAnanNvbid9OwogICAgCiAgICAgICAgLy8gRW5zdXJlIHRoYXQgd2UgaGF2ZSBhIFVSTC4KICAgICAgICBpZiAoIW9wdGlvbnMudXJsKSB7CiAgICAgICAgICAgIHBhcmFtcy51cmwgPSBfLnJlc3VsdChtb2RlbCwgJ3VybCcpIHx8IHVybEVycm9yKCk7CiAgICAgICAgfQogICAgCiAgICAgICAgLy8gRW5zdXJlIHRoYXQgd2UgaGF2ZSB0aGUgYXBwcm9wcmlhdGUgcmVxdWVzdCBkYXRhLgogICAgICAgIGlmIChvcHRpb25zLmRhdGEgPT0gbnVsbCAmJiBtb2RlbCAmJiAobWV0aG9kID09PSAnY3JlYXRlJyB8fCBtZXRob2QgPT09ICd1cGRhdGUnIHx8IG1ldGhvZCA9PT0gJ3BhdGNoJykpIHsKICAgICAgICAgICAgcGFyYW1zLmNvbnRlbnRUeXBlID0gJ2FwcGxpY2F0aW9uL2pzb24nOwogICAgICAgICAgICBwYXJhbXMuZGF0YSA9IEpTT04uc3RyaW5naWZ5KG9wdGlvbnMuYXR0cnMgfHwgbW9kZWwudG9KU09OKG9wdGlvbnMpKTsKICAgICAgICB9CiAgICAKICAgICAgICAvLyBGb3Igb2xkZXIgc2VydmVycywgZW11bGF0ZSBKU09OIGJ5IGVuY29kaW5nIHRoZSByZXF1ZXN0IGludG8gYW4gSFRNTC1mb3JtLgogICAgICAgIGlmIChvcHRpb25zLmVtdWxhdGVKU09OKSB7CiAgICAgICAgICAgIHBhcmFtcy5jb250ZW50VHlwZSA9ICdhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWQnOwogICAgICAgICAgICBwYXJhbXMuZGF0YSA9IHBhcmFtcy5kYXRhID8ge21vZGVsOiBwYXJhbXMuZGF0YX0gOiB7fTsKICAgICAgICB9CiAgICAKICAgICAgICAvLyBGb3Igb2xkZXIgc2VydmVycywgZW11bGF0ZSBIVFRQIGJ5IG1pbWlja2luZyB0aGUgSFRUUCBtZXRob2Qgd2l0aCBgX21ldGhvZGAKICAgICAgICAvLyBBbmQgYW4gYFgtSFRUUC1NZXRob2QtT3ZlcnJpZGVgIGhlYWRlci4KICAgICAgICBpZiAob3B0aW9ucy5lbXVsYXRlSFRUUCAmJiAodHlwZSA9PT0gJ1BVVCcgfHwgdHlwZSA9PT0gJ0RFTEVURScgfHwgdHlwZSA9PT0gJ1BBVENIJykpIHsKICAgICAgICAgICAgcGFyYW1zLnR5cGUgPSAnUE9TVCc7CiAgICAgICAgICAgIGlmIChvcHRpb25zLmVtdWxhdGVKU09OKSBwYXJhbXMuZGF0YS5fbWV0aG9kID0gdHlwZTsKICAgICAgICAgICAgdmFyIGJlZm9yZVNlbmQgPSBvcHRpb25zLmJlZm9yZVNlbmQ7CiAgICAgICAgICAgIG9wdGlvbnMuYmVmb3JlU2VuZCA9IGZ1bmN0aW9uICh4aHIpIHsKICAgICAgICAgICAgICAgIHZhciByZXN1bHQ7CiAgICAgICAgICAgICAgICB4aHIuc2V0UmVxdWVzdEhlYWRlcignWC1IVFRQLU1ldGhvZC1PdmVycmlkZScsIHR5cGUpOwogICAgICAgICAgICAgICAgaWYgKGJlZm9yZVNlbmQpIHJlc3VsdCA9IGJlZm9yZVNlbmQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgICAgIH07CiAgICAgICAgfQogICAgCiAgICAgICAgLy8gRG9uJ3QgcHJvY2VzcyBkYXRhIG9uIGEgbm9uLUdFVCByZXF1ZXN0LgogICAgICAgIGlmIChwYXJhbXMudHlwZSAhPT0gJ0dFVCcgJiYgIW9wdGlvbnMuZW11bGF0ZUpTT04pIHsKICAgICAgICAgICAgcGFyYW1zLnByb2Nlc3NEYXRhID0gZmFsc2U7CiAgICAgICAgfQogICAgCiAgICAgICAgLy8gSWYgd2UncmUgc2VuZGluZyBhIGBQQVRDSGAgcmVxdWVzdCwgYW5kIHdlJ3JlIGluIGFuIG9sZCBJbnRlcm5ldCBFeHBsb3JlcgogICAgICAgIC8vIHRoYXQgc3RpbGwgaGFzIEFjdGl2ZVggZW5hYmxlZCBieSBkZWZhdWx0LCBvdmVycmlkZSBqUXVlcnkgdG8gdXNlIHRoYXQKICAgICAgICAvLyBmb3IgWEhSIGluc3RlYWQuIFJlbW92ZSB0aGlzIGxpbmUgd2hlbiBqUXVlcnkgc3VwcG9ydHMgYFBBVENIYCBvbiBJRTguCiAgICAgICAgaWYgKHBhcmFtcy50eXBlID09PSAnUEFUQ0gnICYmIG5vWGhyUGF0Y2gpIHsKICAgICAgICAgICAgcGFyYW1zLnhociA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiBuZXcgQWN0aXZlWE9iamVjdCgiTWljcm9zb2Z0LlhNTEhUVFAiKTsKICAgICAgICAgICAgfTsKICAgICAgICB9CiAgICAKICAgICAgICAvLyBNYWtlIHRoZSByZXF1ZXN0LCBhbGxvd2luZyB0aGUgdXNlciB0byBvdmVycmlkZSBhbnkgQWpheCBvcHRpb25zLgogICAgICAgIHZhciB4aHIgPSBvcHRpb25zLnhociA9IEhhY2tib25lLmFqYXgoXy5leHRlbmQocGFyYW1zLCBvcHRpb25zKSk7CiAgICAgICAgbW9kZWwudHJpZ2dlcigncmVxdWVzdCcsIG1vZGVsLCB4aHIsIG9wdGlvbnMpOwogICAgICAgIHJldHVybiB4aHI7CiAgICB9OwogICAgCiAgICB2YXIgbm9YaHJQYXRjaCA9IHR5cGVvZiB3aW5kb3cgIT09ICd1bmRlZmluZWQnICYmICEhd2luZG93LkFjdGl2ZVhPYmplY3QgJiYgISh3aW5kb3cuWE1MSHR0cFJlcXVlc3QgJiYgKG5ldyBYTUxIdHRwUmVxdWVzdCkuZGlzcGF0Y2hFdmVudCk7CiAgICAKICAgIC8vIE1hcCBmcm9tIENSVUQgdG8gSFRUUCBmb3Igb3VyIGRlZmF1bHQgYEhhY2tib25lLnN5bmNgIGltcGxlbWVudGF0aW9uLgogICAgdmFyIG1ldGhvZE1hcCA9IEhhY2tib25lLnN5bmMuaHR0cE1hcCA9IHsKICAgICAgICAnY3JlYXRlJzogJ1BPU1QnLAogICAgICAgICd1cGRhdGUnOiAnUFVUJywKICAgICAgICAncGF0Y2gnOiAnUEFUQ0gnLAogICAgICAgICdkZWxldGUnOiAnREVMRVRFJywKICAgICAgICAncmVhZCc6ICdHRVQnCiAgICB9OwogICAgCiAgICAvLyBTZXQgdGhlIGRlZmF1bHQgaW1wbGVtZW50YXRpb24gb2YgYEhhY2tib25lLmFqYXhgIHRvIHByb3h5IHRocm91Z2ggdG8gYCRgLgogICAgLy8gT3ZlcnJpZGUgdGhpcyBpZiB5b3UnZCBsaWtlIHRvIHVzZSBhIGRpZmZlcmVudCBsaWJyYXJ5LgogICAgSGFja2JvbmUuYWpheCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gSGFja2JvbmUuJC5hamF4LmFwcGx5KEhhY2tib25lLiQsIGFyZ3VtZW50cyk7CiAgICB9OwoKICAgIC8vIEJhY2tib25lLkJhc2VWaWV3CiAgICAvLyAtLS0tLS0tLS0tLS0tCiAgICAKICAgIC8vIEhhY2tib25lIEJhc2VWaWV3cyBhcmUgYWxtb3N0IG1vcmUgY29udmVudGlvbiB0aGFuIHRoZXkgYXJlIGFjdHVhbCBjb2RlLiBBIEJhc2VWaWV3CiAgICAvLyBpcyBzaW1wbHkgYSBKYXZhU2NyaXB0IG9iamVjdCB0aGF0IHJlcHJlc2VudHMgYSBsb2dpY2FsIGNodW5rIG9mIFVJIGluIHRoZQogICAgLy8gRE9NLiBUaGlzIG1pZ2h0IGJlIGEgc2luZ2xlIGl0ZW0sIGFuIGVudGlyZSBsaXN0LCBhIHNpZGViYXIgb3IgcGFuZWwsIG9yCiAgICAvLyBldmVuIHRoZSBzdXJyb3VuZGluZyBmcmFtZSB3aGljaCB3cmFwcyB5b3VyIHdob2xlIGFwcC4gRGVmaW5pbmcgYSBjaHVuayBvZgogICAgLy8gVUkgYXMgYSAqKlZpZXcqKiBhbGxvd3MgeW91IHRvIGRlZmluZSB5b3VyIERPTSBldmVudHMgZGVjbGFyYXRpdmVseSwgd2l0aG91dAogICAgLy8gaGF2aW5nIHRvIHdvcnJ5IGFib3V0IHJlbmRlciBvcmRlci4KICAgIAogICAgLy8gSGFja2JvbmUgQmFzZVZpZXcgaW5zdGFuY2VzIGFyZSBnZW5lcmljIE1WQy9NVlAgcGF0dGVybiB2aWV3cy4gVGhleSBhcmUgJ2NvbnRyb2xsZWQnCiAgICAvLyBieSB0aGUgb2JqZWN0IGNvbnRhaW5pbmcgdGhlIHZpZXcgaW5zdGFuY2UgYW5kIHRoZXkgaGF2ZSBubyByZWZlcmVuY2UgdG8gYW55CiAgICAvLyBIYWNrYm9uZS5Nb2RlbCBvciBIYWNrYm9uZS5Db2xsZWN0aW9uIGluc3RhbmNlLgogICAgCiAgICAvLyBPcHRpb25zIHdpdGggc3BlY2lhbCBtZWFuaW5nICooZS5nLiBtb2RlbCwgY29sbGVjdGlvbiwgaWQsIGNsYXNzTmFtZSkqIGFyZQogICAgLy8gYXR0YWNoZWQgZGlyZWN0bHkgdG8gdGhlIHZpZXcuICBTZWUgYGJhc2VWaWV3T3B0aW9uc2AgZm9yIGFuIGV4aGF1c3RpdmUKICAgIC8vIGxpc3QuCiAgICAKICAgIC8vIENyZWF0aW5nIGEgSGFja2JvbmUuQmFzZVZpZXcgY3JlYXRlcyBpdHMgaW5pdGlhbCBlbGVtZW50IG91dHNpZGUgb2YgdGhlIERPTSwKICAgIC8vIGlmIGFuIGV4aXN0aW5nIGVsZW1lbnQgaXMgbm90IHByb3ZpZGVkLi4uCiAgICAKICAgIC8vIFNldCB1cCBhbGwgaW5oZXJpdGFibGUgKipIYWNrYm9uZS5CYXNlVmlldyoqIHByb3BlcnRpZXMgYW5kIG1ldGhvZHMuCiAgICB2YXIgQmFzZVZpZXcgPSBIYWNrYm9uZS5CYXNlVmlldyA9IENvbXBvbmVudC5leHRlbmQoewogICAgICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbiAob3B0aW9ucykgewogICAgICAgICAgICB0aGlzLmNpZCA9IF8udW5pcXVlSWQoJ3ZpZXcnKTsKICAgICAgICAgICAgb3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KTsKICAgICAgICAgICAgXy5leHRlbmQodGhpcywgXy5waWNrKG9wdGlvbnMsIEJhc2VWaWV3LnZpZXdPcHRpb25zKSk7CiAgICAgICAgICAgIHRoaXMuX2Vuc3VyZUVsZW1lbnQoKTsKICAgICAgICAgICAgdGhpcy5pbml0aWFsaXplLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgIHRoaXMuZGVsZWdhdGVFdmVudHMoKTsKICAgICAgICB9LAogICAgCiAgICAgICAgLy8gVGhlIGRlZmF1bHQgYHRhZ05hbWVgIG9mIGEgQmFzZVZpZXcncyBlbGVtZW50IGlzIGAiZGl2ImAuCiAgICAgICAgdGFnTmFtZTogJ2RpdicsCiAgICAKICAgICAgICAvLyBqUXVlcnkgZGVsZWdhdGUgZm9yIGVsZW1lbnQgbG9va3VwLCBzY29wZWQgdG8gRE9NIGVsZW1lbnRzIHdpdGhpbiB0aGUKICAgICAgICAvLyBjdXJyZW50IHZpZXcuIFRoaXMgc2hvdWxkIGJlIHByZWZlcmVkIHRvIGdsb2JhbCBsb29rdXBzIHdoZXJlIHBvc3NpYmxlLgogICAgICAgICQ6IGZ1bmN0aW9uIChzZWxlY3RvcikgewogICAgICAgICAgICByZXR1cm4gdGhpcy4kZWwuZmluZChzZWxlY3Rvcik7CiAgICAgICAgfSwKICAgIAogICAgICAgIC8vICoqcmVuZGVyKiogaXMgdGhlIGNvcmUgZnVuY3Rpb24gdGhhdCB5b3VyIHZpZXcgc2hvdWxkIG92ZXJyaWRlLCBpbiBvcmRlcgogICAgICAgIC8vIHRvIHBvcHVsYXRlIGl0cyBlbGVtZW50IChgdGhpcy5lbGApLCB3aXRoIHRoZSBhcHByb3ByaWF0ZSBIVE1MLiBUaGUKICAgICAgICAvLyBjb252ZW50aW9uIGlzIGZvciAqKnJlbmRlcioqIHRvIGFsd2F5cyByZXR1cm4gYHRoaXNgLgogICAgICAgIHJlbmRlcjogZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9LAogICAgCiAgICAgICAgLy8gUmVtb3ZlIHRoaXMgdmlldyBieSB0YWtpbmcgdGhlIGVsZW1lbnQgb3V0IG9mIHRoZSBET00sIGFuZCByZW1vdmluZyBhbnkKICAgICAgICAvLyBhcHBsaWNhYmxlIEhhY2tib25lLkV2ZW50cyBsaXN0ZW5lcnMuCiAgICAgICAgcmVtb3ZlOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHRoaXMuJGVsLnJlbW92ZSgpOwogICAgICAgICAgICB0aGlzLnN0b3BMaXN0ZW5pbmcoKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSwKICAgIAogICAgICAgIC8vIERlc3Ryb3lzIHRoZSBCYXNlVmlldyBieSBpbnZva2luZyB0aGUgQmFzZVZpZXcjcmVtb3ZlIG1ldGhvZC4KICAgICAgICAvLyBDb252ZW5pZW5jZSBtZXRob2QgZm9yIGV4dGVuZGluZyBiYXNlIENvbXBvbmVudC4KICAgICAgICBkZXN0cm95OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnJlbW92ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgIH0sCiAgICAKICAgICAgICAvLyBDaGFuZ2UgdGhlIHZpZXcncyBlbGVtZW50IChgdGhpcy5lbGAgcHJvcGVydHkpLCBpbmNsdWRpbmcgZXZlbnQKICAgICAgICAvLyByZS1kZWxlZ2F0aW9uLgogICAgICAgIHNldEVsZW1lbnQ6IGZ1bmN0aW9uIChlbGVtZW50LCBkZWxlZ2F0ZSkgewogICAgICAgICAgICBpZiAodGhpcy4kZWwpIHRoaXMudW5kZWxlZ2F0ZUV2ZW50cygpOwogICAgICAgICAgICB0aGlzLiRlbCA9IGVsZW1lbnQgaW5zdGFuY2VvZiBIYWNrYm9uZS4kID8gZWxlbWVudCA6IEhhY2tib25lLiQoZWxlbWVudCk7CiAgICAgICAgICAgIHRoaXMuZWwgPSB0aGlzLiRlbFswXTsKICAgICAgICAgICAgaWYgKGRlbGVnYXRlICE9PSBmYWxzZSkgdGhpcy5kZWxlZ2F0ZUV2ZW50cygpOwogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9LAogICAgCiAgICAgICAgLy8gU2V0IGNhbGxiYWNrcywgd2hlcmUgYHRoaXMuZXZlbnRzYCBpcyBhIGhhc2ggb2YKICAgICAgICAvLwogICAgICAgIC8vICp7ImV2ZW50IHNlbGVjdG9yIjogImNhbGxiYWNrIn0qCiAgICAgICAgLy8KICAgICAgICAvLyAgICAgewogICAgICAgIC8vICAgICAgICdtb3VzZWRvd24gLnRpdGxlJzogICdlZGl0JywKICAgICAgICAvLyAgICAgICAnY2xpY2sgLmJ1dHRvbic6ICAgICAnc2F2ZScsCiAgICAgICAgLy8gICAgICAgJ2NsaWNrIC5vcGVuJzogICAgICAgZnVuY3Rpb24oZSkgeyAuLi4gfQogICAgICAgIC8vICAgICB9CiAgICAgICAgLy8KICAgICAgICAvLyBwYWlycy4gQ2FsbGJhY2tzIHdpbGwgYmUgYm91bmQgdG8gdGhlIHZpZXcsIHdpdGggYHRoaXNgIHNldCBwcm9wZXJseS4KICAgICAgICAvLyBVc2VzIGV2ZW50IGRlbGVnYXRpb24gZm9yIGVmZmljaWVuY3kuCiAgICAgICAgLy8gT21pdHRpbmcgdGhlIHNlbGVjdG9yIGJpbmRzIHRoZSBldmVudCB0byBgdGhpcy5lbGAuCiAgICAgICAgLy8gVGhpcyBvbmx5IHdvcmtzIGZvciBkZWxlZ2F0ZS1hYmxlIGV2ZW50czogbm90IGBmb2N1c2AsIGBibHVyYCwgYW5kCiAgICAgICAgLy8gbm90IGBjaGFuZ2VgLCBgc3VibWl0YCwgYW5kIGByZXNldGAgaW4gSW50ZXJuZXQgRXhwbG9yZXIuCiAgICAgICAgZGVsZWdhdGVFdmVudHM6IGZ1bmN0aW9uIChldmVudHMpIHsKICAgICAgICAgICAgaWYgKCEoZXZlbnRzIHx8IChldmVudHMgPSBfLnJlc3VsdCh0aGlzLCAnZXZlbnRzJykpKSkgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgIHRoaXMudW5kZWxlZ2F0ZUV2ZW50cygpOwogICAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gZXZlbnRzKSB7CiAgICAgICAgICAgICAgICBpZiAoZXZlbnRzLmhhc093blByb3BlcnR5KGtleSkpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgbWV0aG9kID0gZXZlbnRzW2tleV07CiAgICAgICAgICAgICAgICAgICAgaWYgKCFfLmlzRnVuY3Rpb24obWV0aG9kKSkgbWV0aG9kID0gdGhpc1tldmVudHNba2V5XV07CiAgICAgICAgICAgICAgICAgICAgaWYgKCFtZXRob2QpIGNvbnRpbnVlOwogICAgCiAgICAgICAgICAgICAgICAgICAgdmFyIG1hdGNoID0ga2V5Lm1hdGNoKGRlbGVnYXRlRXZlbnRTcGxpdHRlcik7CiAgICAgICAgICAgICAgICAgICAgdmFyIGV2ZW50TmFtZSA9IG1hdGNoWzFdLCBzZWxlY3RvciA9IG1hdGNoWzJdOwogICAgICAgICAgICAgICAgICAgIG1ldGhvZCA9IF8uYmluZChtZXRob2QsIHRoaXMpOwogICAgICAgICAgICAgICAgICAgIGV2ZW50TmFtZSArPSAnLmRlbGVnYXRlRXZlbnRzJyArIHRoaXMuY2lkOwogICAgICAgICAgICAgICAgICAgIGlmIChzZWxlY3RvciA9PT0gJycpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy4kZWwub24oZXZlbnROYW1lLCBtZXRob2QpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuJGVsLm9uKGV2ZW50TmFtZSwgc2VsZWN0b3IsIG1ldGhvZCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCiAgICAKICAgICAgICAvLyBDbGVhcnMgYWxsIGNhbGxiYWNrcyBwcmV2aW91c2x5IGJvdW5kIHRvIHRoZSB2aWV3IHdpdGggYGRlbGVnYXRlRXZlbnRzYC4KICAgICAgICAvLyBZb3UgdXN1YWxseSBkb24ndCBuZWVkIHRvIHVzZSB0aGlzLCBidXQgbWF5IHdpc2ggdG8gaWYgeW91IGhhdmUgbXVsdGlwbGUKICAgICAgICAvLyBIYWNrYm9uZSB2aWV3cyBhdHRhY2hlZCB0byB0aGUgc2FtZSBET00gZWxlbWVudC4KICAgICAgICB1bmRlbGVnYXRlRXZlbnRzOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHRoaXMuJGVsLm9mZignLmRlbGVnYXRlRXZlbnRzJyArIHRoaXMuY2lkKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSwKICAgIAogICAgICAgIC8vIEVuc3VyZSB0aGF0IHRoZSBCYXNlVmlldyBoYXMgYSBET00gZWxlbWVudCB0byByZW5kZXIgaW50by4KICAgICAgICAvLyBJZiBgdGhpcy5lbGAgaXMgYSBzdHJpbmcsIHBhc3MgaXQgdGhyb3VnaCBgJCgpYCwgdGFrZSB0aGUgZmlyc3QKICAgICAgICAvLyBtYXRjaGluZyBlbGVtZW50LCBhbmQgcmUtYXNzaWduIGl0IHRvIGBlbGAuIE90aGVyd2lzZSwgY3JlYXRlCiAgICAgICAgLy8gYW4gZWxlbWVudCBmcm9tIHRoZSBgaWRgLCBgY2xhc3NOYW1lYCBhbmQgYHRhZ05hbWVgIHByb3BlcnRpZXMuCiAgICAgICAgX2Vuc3VyZUVsZW1lbnQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmVsKSB7CiAgICAgICAgICAgICAgICB2YXIgYXR0cnMgPSBfLmV4dGVuZCh7fSwgXy5yZXN1bHQodGhpcywgJ2F0dHJpYnV0ZXMnKSk7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5pZCkgYXR0cnMuaWQgPSBfLnJlc3VsdCh0aGlzLCAnaWQnKTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmNsYXNzTmFtZSkgYXR0cnNbJ2NsYXNzJ10gPSBfLnJlc3VsdCh0aGlzLCAnY2xhc3NOYW1lJyk7CiAgICAgICAgICAgICAgICB2YXIgJGVsID0gSGFja2JvbmUuJCgnPCcgKyBfLnJlc3VsdCh0aGlzLCAndGFnTmFtZScpICsgJz4nKS5hdHRyKGF0dHJzKTsKICAgICAgICAgICAgICAgIHRoaXMuc2V0RWxlbWVudCgkZWwsIGZhbHNlKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuc2V0RWxlbWVudChfLnJlc3VsdCh0aGlzLCAnZWwnKSwgZmFsc2UpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSwgRXZlbnRzKTsKICAgIAogICAgLy8gTGlzdCBvZiB2aWV3IG9wdGlvbnMgdG8gYmUgbWVyZ2VkIGFzIHByb3BlcnRpZXMuCiAgICBCYXNlVmlldy52aWV3T3B0aW9ucyA9IFsnZWwnLCAnaWQnLCAnYXR0cmlidXRlcycsICdjbGFzc05hbWUnLCAndGFnTmFtZScsICdldmVudHMnXTsKICAgIAogICAgXy5leHRlbmQoQmFzZVZpZXcucHJvdG90eXBlLCBFdmVudHMpOwogICAgCiAgICAvLyBDYWNoZWQgcmVnZXggdG8gc3BsaXQga2V5cyBmb3IgYGRlbGVnYXRlYC4KICAgIHZhciBkZWxlZ2F0ZUV2ZW50U3BsaXR0ZXIgPSAvXihcUyspXHMqKC4qKSQvOwoKICAgIC8vIEhhY2tib25lLlZpZXcKICAgIC8vIC0tLS0tLS0tLS0tLS0KICAgIAogICAgLy8gT3B0aW9ucyB3aXRoIHNwZWNpYWwgbWVhbmluZyAqKGUuZy4gbW9kZWwsIGNvbGxlY3Rpb24sIGlkLCBjbGFzc05hbWUpKiBhcmUKICAgIC8vIGF0dGFjaGVkIGRpcmVjdGx5IHRvIHRoZSB2aWV3LiAgU2VlIGB2aWV3T3B0aW9uc2AgZm9yIGFuIGV4aGF1c3RpdmUKICAgIC8vIGxpc3QuCiAgICAKICAgIC8vIFNldCB1cCBhbGwgaW5oZXJpdGFibGUgKipIYWNrYm9uZS5WaWV3KiogcHJvcGVydGllcyBhbmQgbWV0aG9kcy4KICAgIHZhciBWaWV3ID0gSGFja2JvbmUuVmlldyA9IEJhc2VWaWV3LmV4dGVuZCh7CiAgICAgICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uIChvcHRpb25zKSB7CiAgICAgICAgICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CiAgICAgICAgICAgIF8uZXh0ZW5kKHRoaXMsIF8ucGljayhvcHRpb25zLCBWaWV3LnZpZXdPcHRpb25zKSk7CiAgICAgICAgICAgIEJhc2VWaWV3LmNhbGwodGhpcywgb3B0aW9ucyk7CiAgICAgICAgfQogICAgfSwgewogICAgICAgIC8vIExpc3Qgb2YgdmlldyBvcHRpb25zIHRvIGJlIG1lcmdlZCBhcyBwcm9wZXJ0aWVzLgogICAgICAgIHZpZXdPcHRpb25zOiBbJ21vZGVsJywgJ2NvbGxlY3Rpb24nXQogICAgfSk7CgogICAgdmFyIENhY2hlID0gSGFja2JvbmUuQ2FjaGUgPSBCYXNlLmV4dGVuZCh7CiAgICAgICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdGhpcy5yb290ID0ge307CiAgICAgICAgfSwKICAgIAogICAgICAgIC8vIE5vbi1BUEkgbWV0aG9kLiBDcmVhdGVzIGEgcGF0aCBvbiBnaXZlbiByb290IG9yIHRoZSBDYWNoZSNyb290LgogICAgICAgIF9jcmVhdGU6IGZ1bmN0aW9uIChwYXRoLCByb290KSB7CiAgICAgICAgICAgIHZhciBicmFuY2g7CiAgICAgICAgICAgIHZhciB0cmVlID0gKHJvb3QgfHwgdGhpcy5yb290KTsKICAgIAogICAgICAgICAgICB3aGlsZSAocGF0aC5sZW5ndGggPiAwICYmIHRyZWUpIHsKICAgICAgICAgICAgICAgIGJyYW5jaCA9IHBhdGguc2hpZnQoKTsKICAgICAgICAgICAgICAgIHRyZWVbYnJhbmNoXSB8fCAodHJlZVticmFuY2hdID0ge30pOwogICAgICAgICAgICAgICAgdHJlZSA9IHRyZWVbYnJhbmNoXTsKICAgICAgICAgICAgfQogICAgCiAgICAgICAgICAgIHJldHVybiB0cmVlOwogICAgICAgIH0sCiAgICAKICAgICAgICAvLyBOb24tQVBJIG1ldGhvZC4gRGlncyBhIHBhdGggb24gdGhlIGdpdmVuIHJvb3Qgb3IgdGhlIENhY2hlI3Jvb3QuCiAgICAgICAgX3Jlc29sdmU6IGZ1bmN0aW9uIChyYXdQYXRoLCByb290KSB7CiAgICAgICAgICAgIHZhciByZXNvbHZlZCwgcGF0aDsKICAgIAogICAgICAgICAgICBpZiAocmF3UGF0aCBpbnN0YW5jZW9mIEFycmF5KSB7CiAgICAgICAgICAgICAgICBwYXRoID0gcmF3UGF0aDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHBhdGggPSAocmF3UGF0aC50b1N0cmluZygpLnNwbGl0KCIuIikgfHwgW10pOwogICAgICAgICAgICB9CiAgICAKICAgICAgICAgICAgaWYgKHBhdGgubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgcmVzb2x2ZWQgPSAocm9vdCB8fCB0aGlzLnJvb3QpOwogICAgCiAgICAgICAgICAgICAgICB3aGlsZSAocGF0aC5sZW5ndGggPiAwICYmIHJlc29sdmVkKSB7CiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZWQgPSByZXNvbHZlZFtwYXRoLnNoaWZ0KCldOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAKICAgICAgICAgICAgcmV0dXJuIHJlc29sdmVkOwogICAgICAgIH0sCiAgICAKICAgICAgICAvLyBRdWVyaWVzIHRoZSBzcGVjaWZpZWQgYnJhbmNoKGVzKSBpbiB0aGUgQ2FjaGUuCiAgICAgICAgLy8gVGFrZXMgYW4gQXJyYXkgb2YgU3RyaW5ncywgTWFwIG9mIHN0cmluZ3Mgb3IgYSBTdHJpbmcuCiAgICAgICAgZ2V0OiBmdW5jdGlvbiAoYXJnKSB7CiAgICAgICAgICAgIHZhciByZXN1bHQsIGk7CiAgICAKICAgICAgICAgICAgaWYgKGFyZyBpbnN0YW5jZW9mIEFycmF5KSB7CiAgICAgICAgICAgICAgICByZXN1bHQgPSBbXTsKICAgIAogICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGFyZy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgIHJlc3VsdFtpXSA9IHRoaXMuX3Jlc29sdmUoYXJnW2ldKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChhcmcgaW5zdGFuY2VvZiBPYmplY3QpIHsKICAgICAgICAgICAgICAgIHJlc3VsdCA9IHt9OwogICAgCiAgICAgICAgICAgICAgICBmb3IgKGkgaW4gYXJnKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGFyZy5oYXNPd25Qcm9wZXJ0eShpKSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRbaV0gPSB0aGlzLl9yZXNvbHZlKGFyZ1tpXSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKGFyZ3VtZW50cy5sZW5ndGggPiAxKSB7CiAgICAgICAgICAgICAgICByZXN1bHQgPSB0aGlzLmdldChBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDApKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgYXJnID09PSAnc3RyaW5nJykgewogICAgICAgICAgICAgICAgcmVzdWx0ID0gdGhpcy5fcmVzb2x2ZShhcmcpOwogICAgICAgICAgICB9CiAgICAKICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9LAogICAgCiAgICAgICAgLy8gQ3JlYXRlcyB0aGUgc3BlY2lmaWVkIGJyYW5jaChlcykgaW4gdGhlIENhY2hlLgogICAgICAgIC8vIFRha2VzIGFuIEFycmF5IG9mIFN0cmluZ3MsIE1hcCBvZiBzdHJpbmdzIG9yIGEgU3RyaW5nLgogICAgICAgIHNldDogZnVuY3Rpb24gKGFyZywgdmFsdWUpIHsKICAgICAgICAgICAgdmFyIHBhdGgsIG5hbWUsIHJvb3Q7CiAgICAKICAgICAgICAgICAgaWYgKGFyZyBpbnN0YW5jZW9mIE9iamVjdCkgewogICAgICAgICAgICAgICAgZm9yIChuYW1lIGluIGFyZykgewogICAgICAgICAgICAgICAgICAgIGlmIChhcmcuaGFzT3duUHJvcGVydHkobmFtZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXQobmFtZSwgYXJnW25hbWVdKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGFyZyA9PSAnc3RyaW5nJyAmJiB0eXBlb2YgdmFsdWUgIT09ICd1bmRlZmluZWQnKSB7CiAgICAgICAgICAgICAgICBwYXRoID0gYXJnLnNwbGl0KCIuIik7CiAgICAgICAgICAgICAgICBuYW1lID0gcGF0aC5wb3AoKTsKICAgICAgICAgICAgICAgIHJvb3QgPSB0aGlzLl9jcmVhdGUocGF0aCk7CiAgICAgICAgICAgICAgICByb290W25hbWVdID0gdmFsdWU7CiAgICAgICAgICAgIH0KICAgIAogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9LAogICAgCiAgICAgICAgLy8gUmVtb3ZlcyB0aGUgc3BlY2lmaWVkIGJyYW5jaCBmcm9tIHRoZSBDYWNoZS4KICAgICAgICAvLyBUYWtlcyBhbiBBcnJheSBvZiBTdHJpbmdzLCBNYXAgb2Ygc3RyaW5ncyBvciBhIFN0cmluZy4KICAgICAgICB1bnNldDogZnVuY3Rpb24gKGFyZykgewogICAgICAgICAgICB2YXIgcGF0aCwgbmFtZSwgcm9vdCwgaTsKICAgIAogICAgICAgICAgICBpZiAoYXJnIGluc3RhbmNlb2YgQXJyYXkpIHsKICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBhcmcubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnVuc2V0KGFyZ1tpXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAoYXJnIGluc3RhbmNlb2YgT2JqZWN0KSB7CiAgICAgICAgICAgICAgICBmb3IgKG5hbWUgaW4gYXJnKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGFyZy5oYXNPd25Qcm9wZXJ0eShuYW1lKSkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnVuc2V0KG5hbWUsIGFyZ1tuYW1lXSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBhcmcgPT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgICAgIHBhdGggPSBhcmcuc3BsaXQoIi4iKTsKICAgICAgICAgICAgICAgIG5hbWUgPSBwYXRoLnBvcCgpOwogICAgICAgICAgICAgICAgcm9vdCA9IHRoaXMuX3Jlc29sdmUocGF0aCk7CiAgICAgICAgICAgICAgICBkZWxldGUgcm9vdFtuYW1lXTsKICAgICAgICAgICAgfQogICAgCiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0KICAgIH0pOwoKICAgIC8vIEdlbmVyaWMgY2xhc3MgZm9yIGhhbmRsaW5nIGNoaWxkcmVuIGluIG9yZGVyIC0gd2VsbCwgb3Igbm90Li4uCiAgICB2YXIgQ29tcG9zaXRlID0gSGFja2JvbmUuQ29tcG9zaXRlID0gQ29tcG9uZW50LmV4dGVuZCh7CiAgICAgICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdGhpcy5jaGlsZHJlbiA9IHt9OwogICAgICAgICAgICB0aGlzLm9yZGVyID0gW107CiAgICAgICAgfSwKICAgIAogICAgICAgIC8vIEFkZHMgYSBuZXcgaXRlbSBpbnRvIHRoZSBvcmRlcgogICAgICAgIGFkZDogZnVuY3Rpb24gKGFyZywgaXRlbSkgewogICAgICAgICAgICB2YXIgY2hpbGRyZW4gPSB0aGlzLmNoaWxkcmVuOwogICAgICAgICAgICB2YXIgb3JkZXIgPSB0aGlzLm9yZGVyOwogICAgICAgICAgICB2YXIgaTsKICAgIAogICAgICAgICAgICBpZiAodHlwZW9mIGFyZyA9PT0gInN0cmluZyIgJiYgaXRlbSAmJiAhY2hpbGRyZW4uaGFzT3duUHJvcGVydHkoYXJnKSkgewogICAgICAgICAgICAgICAgY2hpbGRyZW5bYXJnXSA9IGl0ZW07CiAgICAgICAgICAgICAgICBvcmRlci5wdXNoKGFyZyk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGFyZyA9PT0gIm51bWJlciIgJiYgIWlzTmFOKGFyZykgJiYgYXJnID49IDApIHsKICAgICAgICAgICAgICAgIHRoaXMuYWRkKGFyZy50b1N0cmluZygpLCBpdGVtKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChhcmcgaW5zdGFuY2VvZiBBcnJheSkgewogICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGFyZy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGlmIChvcmRlci5pbmRleE9mKGFyZ1tpXSkgPCAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkcmVuW29yZGVyLmxlbmd0aF0gPSBhcmdbaV07CiAgICAgICAgICAgICAgICAgICAgICAgIG9yZGVyLnB1c2gob3JkZXIubGVuZ3RoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAoYXJnIGluc3RhbmNlb2YgT2JqZWN0KSB7CiAgICAgICAgICAgICAgICBmb3IgKGkgaW4gYXJnKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGFyZy5oYXNPd25Qcm9wZXJ0eShpKSAmJiAhY2hpbGRyZW4uaGFzT3duUHJvcGVydHkoaSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRyZW5baV0gPSBhcmdbaV07CiAgICAgICAgICAgICAgICAgICAgICAgIG9yZGVyLnB1c2goaSkKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgIAogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9LAogICAgCiAgICAgICAgLy9SZXR1cm5zIGEgY2hpbGQgYnkgaXQncyBuYW1lIG9yIGJ5IHRoZSBvcmRlciBzcGVjaWZpZWQuCiAgICAgICAgZ2V0OiBmdW5jdGlvbiAoYXJnKSB7CiAgICAgICAgICAgIHJldHVybiAodGhpcy5nZXRCeU5hbWUoYXJnKSB8fCB0aGlzLmdldEJ5T3JkZXIoYXJnKSk7CiAgICAgICAgfSwKICAgIAogICAgICAgIC8vIERldGVybWluZXMgd2hldGhlciB0aGUgQ29tcG9zaXRlIGNvbnRhaW5zIGFuZCBpdGVtLgogICAgICAgIGNvbnRhaW5zOiBmdW5jdGlvbiAoYXJnKSB7CiAgICAgICAgICAgIHZhciBjaGlsZHJlbiA9IHRoaXMuY2hpbGRyZW47CiAgICAgICAgICAgIHZhciByZXN1bHQgPSAhIXRoaXMuZ2V0KGFyZyk7CiAgICAgICAgICAgIHZhciBrZXk7CiAgICAKICAgICAgICAgICAgaWYgKCFyZXN1bHQpIHsKICAgICAgICAgICAgICAgIGZvciAoa2V5IGluIGNoaWxkcmVuKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGNoaWxkcmVuLmhhc093blByb3BlcnR5KGtleSkgJiYgY2hpbGRyZW5ba2V5XSA9PT0gYXJnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgCiAgICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgfSwKICAgIAogICAgICAgIC8vIFJldHVybnMgYSBjaGlsZCBieSBpdCdzIG5hbWUuCiAgICAgICAgZ2V0QnlOYW1lOiBmdW5jdGlvbiAobmFtZSkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5jaGlsZHJlbltuYW1lXTsKICAgICAgICB9LAogICAgCiAgICAgICAgLy8gUmV0dXJucyBhIGNoaWxkIGJ5IHRoZSBvcmRlciBzcGVjaWZpZWQuCiAgICAgICAgZ2V0QnlPcmRlcjogZnVuY3Rpb24gKGlkKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmNoaWxkcmVuW3RoaXMub3JkZXJbaWRdXTsKICAgICAgICB9LAogICAgCiAgICAgICAgLy8gUmVtb3ZlcyBhIGNoaWxkIGJ5IGl0J3MgbmFtZSBvciBieSB0aGUgb3JkZXIgc3BlY2lmaWVkLgogICAgICAgIHJlbW92ZTogZnVuY3Rpb24gKGFyZykgewogICAgICAgICAgICB2YXIgY2hpbGRyZW4gPSB0aGlzLmNoaWxkcmVuOwogICAgICAgICAgICB2YXIgb3JkZXIgPSB0aGlzLm9yZGVyOwogICAgICAgICAgICB2YXIga2V5LCBpZCwgaTsKICAgIAogICAgICAgICAgICBpZiAodHlwZW9mIGFyZyA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICAgIGlkID0gXy5pbmRleE9mKG9yZGVyLCBhcmcpOwogICAgICAgICAgICAgICAgZGVsZXRlIGNoaWxkcmVuW29yZGVyW2lkXV07CiAgICAgICAgICAgICAgICBvcmRlci5zcGxpY2UoaWQsIDEpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBhcmcgPT09ICJudW1iZXIiICYmICFpc05hTihhcmcpICYmIGFyZyA+IC0xKSB7CiAgICAgICAgICAgICAgICB0aGlzLnJlbW92ZShhcmcudG9TdHJpbmcoKSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoYXJnKSB7CiAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgb3JkZXIubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBrZXkgPSBvcmRlcltpXTsKICAgICAgICAgICAgICAgICAgICBpZiAoY2hpbGRyZW5ba2V5XSA9PT0gYXJnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBjaGlsZHJlbltrZXldOwogICAgICAgICAgICAgICAgICAgICAgICBvcmRlci5zcGxpY2UoaSwgMSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSwKICAgIAogICAgICAgIC8vRGVzdHJveXMgYW5kIHJlbW92ZXMgYWxsIGNoaWxkcmVuCiAgICAgICAgcmVtb3ZlQWxsOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciBjaGlsZHJlbiA9IHRoaXMuY2hpbGRyZW47CiAgICAgICAgICAgIHZhciBvcmRlciA9IHRoaXMub3JkZXI7CiAgICAgICAgICAgIHZhciBjaGlsZDsKICAgIAogICAgICAgICAgICB3aGlsZSAob3JkZXIubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgY2hpbGQgPSBvcmRlclswXTsKICAgICAgICAgICAgICAgIGNoaWxkcmVuW2NoaWxkXS5kZXN0cm95KCk7CiAgICAgICAgICAgICAgICB0aGlzLnJlbW92ZShjaGlsZCk7CiAgICAgICAgICAgIH0KICAgIAogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9LAogICAgCiAgICAgICAgLy8gRXhlY3V0ZXMgdGhlIHNwZWNpZmllZCBmdW5jdGlvbiBvbiBlYWNoIGNoaWxkLgogICAgICAgIGVhY2g6IGZ1bmN0aW9uIChwcm9jKSB7CiAgICAgICAgICAgIHZhciBjaGlsZHJlbiA9IHRoaXMuY2hpbGRyZW47CiAgICAgICAgICAgIHZhciBvcmRlciA9IHRoaXMub3JkZXI7CiAgICAgICAgICAgIHZhciBpID0gMDsKICAgICAgICAgICAgdmFyIGNoaWxkOwogICAgCiAgICAgICAgICAgIGlmICh0eXBlb2YgcHJvYyA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgZm9yICg7IGkgPCBvcmRlci5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGNoaWxkID0gY2hpbGRyZW5bb3JkZXJbaV1dOwogICAgICAgICAgICAgICAgICAgIHByb2MuY2FsbCh0aGlzLCBjaGlsZCwgb3JkZXJbaV0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSwKICAgIAogICAgICAgIC8vIEludm9rZXMgdGhlIHNwZWNpZmllZCBtZXRob2Qgb24gZWFjaCBjaGlsZCB3aXRoIHRoZSByZW1haW5pbmcgYXJndW1lbnRzLgogICAgICAgIGludm9rZTogZnVuY3Rpb24gKG1ldGhvZCkgewogICAgICAgICAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CiAgICAgICAgICAgIHZhciBjaGlsZHJlbiA9IHRoaXMuY2hpbGRyZW47CiAgICAgICAgICAgIHZhciBvcmRlciA9IHRoaXMub3JkZXI7CiAgICAgICAgICAgIHZhciBpID0gMDsKICAgIAogICAgICAgICAgICBmb3IgKDsgaSA8IG9yZGVyLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgY2hpbGRyZW5bb3JkZXJbaV1dW21ldGhvZF0oYXJncyk7CiAgICAgICAgICAgIH0KICAgIAogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9LAogICAgCiAgICAgICAgLy9GaW5kcyB0aGUgZmlyc3QgY2hpbGQgYmFzZWQgb24gdGhlIGdpdmVuIGNvbXBhcmF0b3IgZnVuY3Rpb24uCiAgICAgICAgZmluZDogZnVuY3Rpb24gKGNvbXBhcmF0b3IpIHsKICAgICAgICAgICAgdmFyIGNoaWxkcmVuID0gdGhpcy5jaGlsZHJlbjsKICAgICAgICAgICAgdmFyIG9yZGVyID0gdGhpcy5vcmRlcjsKICAgICAgICAgICAgdmFyIGkgPSAwOwogICAgICAgICAgICB2YXIgY2hpbGQ7CiAgICAKICAgICAgICAgICAgaWYgKHR5cGVvZiBjb21wYXJhdG9yID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICBmb3IgKDsgaSA8IG9yZGVyLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgY2hpbGQgPSBjaGlsZHJlbltvcmRlcltpXV07CiAgICAKICAgICAgICAgICAgICAgICAgICBpZiAoY29tcGFyYXRvci5jYWxsKHRoaXMsIGNoaWxkLCBvcmRlcltpXSkpIHsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBjaGlsZDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgCiAgICAgICAgLy8gT3ZlcnJpZGVzIENvbXBvbmVudCNkZXN0cm95IG1ldGhvZC4KICAgICAgICBkZXN0cm95OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHRoaXMucmVtb3ZlQWxsKCk7CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0KICAgIH0pOwoKICAgIC8vIEJhY2tib25lLk1vZGVsCiAgICAvLyAtLS0tLS0tLS0tLS0tLQogICAgCiAgICAvLyBIYWNrYm9uZSAqKk1vZGVscyoqIGFyZSB0aGUgYmFzaWMgZGF0YSBvYmplY3QgaW4gdGhlIGZyYW1ld29yayAtLQogICAgLy8gZnJlcXVlbnRseSByZXByZXNlbnRpbmcgYSByb3cgaW4gYSB0YWJsZSBpbiBhIGRhdGFiYXNlIG9uIHlvdXIgc2VydmVyLgogICAgLy8gQSBkaXNjcmV0ZSBjaHVuayBvZiBkYXRhIGFuZCBhIGJ1bmNoIG9mIHVzZWZ1bCwgcmVsYXRlZCBtZXRob2RzIGZvcgogICAgLy8gcGVyZm9ybWluZyBjb21wdXRhdGlvbnMgYW5kIHRyYW5zZm9ybWF0aW9ucyBvbiB0aGF0IGRhdGEuCiAgICAKICAgIC8vIENyZWF0ZSBhIG5ldyBtb2RlbCB3aXRoIHRoZSBzcGVjaWZpZWQgYXR0cmlidXRlcy4gQSBjbGllbnQgaWQgKGBjaWRgKQogICAgLy8gaXMgYXV0b21hdGljYWxseSBnZW5lcmF0ZWQgYW5kIGFzc2lnbmVkIGZvciB5b3UuCiAgICB2YXIgTW9kZWwgPSBIYWNrYm9uZS5Nb2RlbCA9IFN0YXRlLmV4dGVuZCh7CiAgICAgICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uIChhdHRyaWJ1dGVzLCBvcHRpb25zKSB7CiAgICAgICAgICAgIFN0YXRlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgIHRoaXMuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgIH0sCiAgICAKICAgICAgICAvLyBQcm94eSBgSGFja2JvbmUuc3luY2AgYnkgZGVmYXVsdCAtLSBidXQgb3ZlcnJpZGUgdGhpcyBpZiB5b3UgbmVlZAogICAgICAgIC8vIGN1c3RvbSBzeW5jaW5nIHNlbWFudGljcyBmb3IgKnRoaXMqIHBhcnRpY3VsYXIgbW9kZWwuCiAgICAgICAgc3luYzogZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gSGFja2JvbmUuc3luYy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgIH0sCiAgICAKICAgICAgICAvLyBGZXRjaCB0aGUgbW9kZWwgZnJvbSB0aGUgc2VydmVyLiBJZiB0aGUgc2VydmVyJ3MgcmVwcmVzZW50YXRpb24gb2YgdGhlCiAgICAgICAgLy8gbW9kZWwgZGlmZmVycyBmcm9tIGl0cyBjdXJyZW50IGF0dHJpYnV0ZXMsIHRoZXkgd2lsbCBiZSBvdmVycmlkZGVuLAogICAgICAgIC8vIHRyaWdnZXJpbmcgYSBgImNoYW5nZSJgIGV2ZW50LgogICAgICAgIGZldGNoOiBmdW5jdGlvbiAob3B0aW9ucykgewogICAgICAgICAgICBvcHRpb25zID0gb3B0aW9ucyA/IF8uY2xvbmUob3B0aW9ucykgOiB7fTsKICAgICAgICAgICAgaWYgKG9wdGlvbnMucGFyc2UgPT09IHZvaWQgMCkgb3B0aW9ucy5wYXJzZSA9IHRydWU7CiAgICAgICAgICAgIHZhciBtb2RlbCA9IHRoaXM7CiAgICAgICAgICAgIHZhciBzdWNjZXNzID0gb3B0aW9ucy5zdWNjZXNzOwogICAgICAgICAgICBvcHRpb25zLnN1Y2Nlc3MgPSBmdW5jdGlvbiAocmVzcCkgewogICAgICAgICAgICAgICAgaWYgKCFtb2RlbC5zZXQobW9kZWwucGFyc2UocmVzcCwgb3B0aW9ucyksIG9wdGlvbnMpKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICBpZiAoc3VjY2Vzcykgc3VjY2Vzcyhtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CiAgICAgICAgICAgICAgICBtb2RlbC50cmlnZ2VyKCdzeW5jJywgbW9kZWwsIHJlc3AsIG9wdGlvbnMpOwogICAgICAgICAgICB9OwogICAgICAgICAgICB3cmFwRXJyb3IodGhpcywgb3B0aW9ucyk7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnN5bmMoJ3JlYWQnLCB0aGlzLCBvcHRpb25zKTsKICAgICAgICB9LAogICAgCiAgICAgICAgLy8gU2V0IGEgaGFzaCBvZiBtb2RlbCBhdHRyaWJ1dGVzLCBhbmQgc3luYyB0aGUgbW9kZWwgdG8gdGhlIHNlcnZlci4KICAgICAgICAvLyBJZiB0aGUgc2VydmVyIHJldHVybnMgYW4gYXR0cmlidXRlcyBoYXNoIHRoYXQgZGlmZmVycywgdGhlIG1vZGVsJ3MKICAgICAgICAvLyBzdGF0ZSB3aWxsIGJlIGBzZXRgIGFnYWluLgogICAgICAgIHNhdmU6IGZ1bmN0aW9uIChrZXksIHZhbCwgb3B0aW9ucykgewogICAgICAgICAgICB2YXIgYXR0cnMsIG1ldGhvZCwgeGhyLCBhdHRyaWJ1dGVzID0gdGhpcy5hdHRyaWJ1dGVzOwogICAgCiAgICAgICAgICAgIC8vIEhhbmRsZSBib3RoIGAia2V5IiwgdmFsdWVgIGFuZCBge2tleTogdmFsdWV9YCAtc3R5bGUgYXJndW1lbnRzLgogICAgICAgICAgICBpZiAoa2V5ID09IG51bGwgfHwgdHlwZW9mIGtleSA9PT0gJ29iamVjdCcpIHsKICAgICAgICAgICAgICAgIGF0dHJzID0ga2V5OwogICAgICAgICAgICAgICAgb3B0aW9ucyA9IHZhbDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIChhdHRycyA9IHt9KVtrZXldID0gdmFsOwogICAgICAgICAgICB9CiAgICAKICAgICAgICAgICAgb3B0aW9ucyA9IF8uZXh0ZW5kKHt2YWxpZGF0ZTogdHJ1ZX0sIG9wdGlvbnMpOwogICAgCiAgICAgICAgICAgIC8vIElmIHdlJ3JlIG5vdCB3YWl0aW5nIGFuZCBhdHRyaWJ1dGVzIGV4aXN0LCBzYXZlIGFjdHMgYXMKICAgICAgICAgICAgLy8gYHNldChhdHRyKS5zYXZlKG51bGwsIG9wdHMpYCB3aXRoIHZhbGlkYXRpb24uIE90aGVyd2lzZSwgY2hlY2sgaWYKICAgICAgICAgICAgLy8gdGhlIG1vZGVsIHdpbGwgYmUgdmFsaWQgd2hlbiB0aGUgYXR0cmlidXRlcywgaWYgYW55LCBhcmUgc2V0LgogICAgICAgICAgICBpZiAoYXR0cnMgJiYgIW9wdGlvbnMud2FpdCkgewogICAgICAgICAgICAgICAgaWYgKCF0aGlzLnNldChhdHRycywgb3B0aW9ucykpIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmICghdGhpcy5fdmFsaWRhdGUoYXR0cnMsIG9wdGlvbnMpKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgIAogICAgICAgICAgICAvLyBTZXQgdGVtcG9yYXJ5IGF0dHJpYnV0ZXMgaWYgYHt3YWl0OiB0cnVlfWAuCiAgICAgICAgICAgIGlmIChhdHRycyAmJiBvcHRpb25zLndhaXQpIHsKICAgICAgICAgICAgICAgIHRoaXMuYXR0cmlidXRlcyA9IF8uZXh0ZW5kKHt9LCBhdHRyaWJ1dGVzLCBhdHRycyk7CiAgICAgICAgICAgIH0KICAgIAogICAgICAgICAgICAvLyBBZnRlciBhIHN1Y2Nlc3NmdWwgc2VydmVyLXNpZGUgc2F2ZSwgdGhlIGNsaWVudCBpcyAob3B0aW9uYWxseSkKICAgICAgICAgICAgLy8gdXBkYXRlZCB3aXRoIHRoZSBzZXJ2ZXItc2lkZSBzdGF0ZS4KICAgICAgICAgICAgaWYgKG9wdGlvbnMucGFyc2UgPT09IHZvaWQgMCkgb3B0aW9ucy5wYXJzZSA9IHRydWU7CiAgICAgICAgICAgIHZhciBtb2RlbCA9IHRoaXM7CiAgICAgICAgICAgIHZhciBzdWNjZXNzID0gb3B0aW9ucy5zdWNjZXNzOwogICAgICAgICAgICBvcHRpb25zLnN1Y2Nlc3MgPSBmdW5jdGlvbiAocmVzcCkgewogICAgICAgICAgICAgICAgLy8gRW5zdXJlIGF0dHJpYnV0ZXMgYXJlIHJlc3RvcmVkIGR1cmluZyBzeW5jaHJvbm91cyBzYXZlcy4KICAgICAgICAgICAgICAgIG1vZGVsLmF0dHJpYnV0ZXMgPSBhdHRyaWJ1dGVzOwogICAgICAgICAgICAgICAgdmFyIHNlcnZlckF0dHJzID0gbW9kZWwucGFyc2UocmVzcCwgb3B0aW9ucyk7CiAgICAgICAgICAgICAgICBpZiAob3B0aW9ucy53YWl0KSBzZXJ2ZXJBdHRycyA9IF8uZXh0ZW5kKGF0dHJzIHx8IHt9LCBzZXJ2ZXJBdHRycyk7CiAgICAgICAgICAgICAgICBpZiAoXy5pc09iamVjdChzZXJ2ZXJBdHRycykgJiYgIW1vZGVsLnNldChzZXJ2ZXJBdHRycywgb3B0aW9ucykpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoc3VjY2Vzcykgc3VjY2Vzcyhtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CiAgICAgICAgICAgICAgICBtb2RlbC50cmlnZ2VyKCdzeW5jJywgbW9kZWwsIHJlc3AsIG9wdGlvbnMpOwogICAgICAgICAgICB9OwogICAgICAgICAgICB3cmFwRXJyb3IodGhpcywgb3B0aW9ucyk7CiAgICAKICAgICAgICAgICAgbWV0aG9kID0gdGhpcy5pc05ldygpID8gJ2NyZWF0ZScgOiAob3B0aW9ucy5wYXRjaCA/ICdwYXRjaCcgOiAndXBkYXRlJyk7CiAgICAgICAgICAgIGlmIChtZXRob2QgPT09ICdwYXRjaCcpIG9wdGlvbnMuYXR0cnMgPSBhdHRyczsKICAgICAgICAgICAgeGhyID0gdGhpcy5zeW5jKG1ldGhvZCwgdGhpcywgb3B0aW9ucyk7CiAgICAKICAgICAgICAgICAgLy8gUmVzdG9yZSBhdHRyaWJ1dGVzLgogICAgICAgICAgICBpZiAoYXR0cnMgJiYgb3B0aW9ucy53YWl0KSB0aGlzLmF0dHJpYnV0ZXMgPSBhdHRyaWJ1dGVzOwogICAgCiAgICAgICAgICAgIHJldHVybiB4aHI7CiAgICAgICAgfSwKICAgIAogICAgICAgIC8vIERlc3Ryb3kgdGhpcyBtb2RlbCBvbiB0aGUgc2VydmVyIGlmIGl0IHdhcyBhbHJlYWR5IHBlcnNpc3RlZC4KICAgICAgICAvLyBPcHRpbWlzdGljYWxseSByZW1vdmVzIHRoZSBtb2RlbCBmcm9tIGl0cyBjb2xsZWN0aW9uLCBpZiBpdCBoYXMgb25lLgogICAgICAgIC8vIElmIGB3YWl0OiB0cnVlYCBpcyBwYXNzZWQsIHdhaXRzIGZvciB0aGUgc2VydmVyIHRvIHJlc3BvbmQgYmVmb3JlIHJlbW92YWwuCiAgICAgICAgZGVzdHJveTogZnVuY3Rpb24gKG9wdGlvbnMpIHsKICAgICAgICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgPyBfLmNsb25lKG9wdGlvbnMpIDoge307CiAgICAgICAgICAgIHZhciBtb2RlbCA9IHRoaXM7CiAgICAgICAgICAgIHZhciBzdWNjZXNzID0gb3B0aW9ucy5zdWNjZXNzOwogICAgCiAgICAgICAgICAgIHZhciBkZXN0cm95ID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgbW9kZWwudHJpZ2dlcignZGVzdHJveScsIG1vZGVsLCBtb2RlbC5jb2xsZWN0aW9uLCBvcHRpb25zKTsKICAgICAgICAgICAgfTsKICAgIAogICAgICAgICAgICBvcHRpb25zLnN1Y2Nlc3MgPSBmdW5jdGlvbiAocmVzcCkgewogICAgICAgICAgICAgICAgaWYgKG9wdGlvbnMud2FpdCB8fCBtb2RlbC5pc05ldygpKSBkZXN0cm95KCk7CiAgICAgICAgICAgICAgICBpZiAoc3VjY2Vzcykgc3VjY2Vzcyhtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CiAgICAgICAgICAgICAgICBpZiAoIW1vZGVsLmlzTmV3KCkpIG1vZGVsLnRyaWdnZXIoJ3N5bmMnLCBtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CiAgICAgICAgICAgIH07CiAgICAKICAgICAgICAgICAgaWYgKHRoaXMuaXNOZXcoKSkgewogICAgICAgICAgICAgICAgb3B0aW9ucy5zdWNjZXNzKCk7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd3JhcEVycm9yKHRoaXMsIG9wdGlvbnMpOwogICAgCiAgICAgICAgICAgIHZhciB4aHIgPSB0aGlzLnN5bmMoJ2RlbGV0ZScsIHRoaXMsIG9wdGlvbnMpOwogICAgICAgICAgICBpZiAoIW9wdGlvbnMud2FpdCkgZGVzdHJveSgpOwogICAgCiAgICAgICAgICAgIFN0YXRlLnByb3RvdHlwZS5kZXN0cm95LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAKICAgICAgICAgICAgcmV0dXJuIHhocjsKICAgICAgICB9LAogICAgCiAgICAgICAgLy8gRGVmYXVsdCBVUkwgZm9yIHRoZSBtb2RlbCdzIHJlcHJlc2VudGF0aW9uIG9uIHRoZSBzZXJ2ZXIgLS0gaWYgeW91J3JlCiAgICAgICAgLy8gdXNpbmcgSGFja2JvbmUncyByZXN0ZnVsIG1ldGhvZHMsIG92ZXJyaWRlIHRoaXMgdG8gY2hhbmdlIHRoZSBlbmRwb2ludAogICAgICAgIC8vIHRoYXQgd2lsbCBiZSBjYWxsZWQuCiAgICAgICAgdXJsOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciBiYXNlID0gXy5yZXN1bHQodGhpcywgJ3VybFJvb3QnKSB8fCBfLnJlc3VsdCh0aGlzLmNvbGxlY3Rpb24sICd1cmwnKSB8fCB1cmxFcnJvcigpOwogICAgICAgICAgICBpZiAodGhpcy5pc05ldygpKSByZXR1cm4gYmFzZTsKICAgICAgICAgICAgcmV0dXJuIGJhc2UgKyAoYmFzZS5jaGFyQXQoYmFzZS5sZW5ndGggLSAxKSA9PT0gJy8nID8gJycgOiAnLycpICsgZW5jb2RlVVJJQ29tcG9uZW50KHRoaXMuaWQpOwogICAgICAgIH0KICAgIH0sIEV2ZW50cyk7CgogICAgLy9BTUQgc3VwcG9ydCB3aXRoIGRlZmluZQogICAgaWYgKHR5cGVvZiBkZWZpbmUgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICBkZWZpbmUoJ0hhY2tib25lJywgW10sIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIHJvb3QuSGFja2JvbmU7CiAgICAgICAgfSk7CiAgICB9Cgp9KS5jYWxsKHRoaXMpOw==",
                "body": "LyoqCiAqIEhhY2tib25lIC0gMC41LjAKICovCihmdW5jdGlvbiAoKSB7CgogICAgLy8gSW5pdGlhbCBTZXR1cAogICAgLy8gLS0tLS0tLS0tLS0tLQogICAgCiAgICAvLyBTYXZlIGEgcmVmZXJlbmNlIHRvIHRoZSBnbG9iYWwgb2JqZWN0IChgd2luZG93YCBpbiB0aGUgYnJvd3NlciwgYGV4cG9ydHNgCiAgICAvLyBvbiB0aGUgc2VydmVyKS4KICAgIHZhciByb290ID0gdGhpczsKICAgIAogICAgLy8gU2F2ZSB0aGUgcHJldmlvdXMgdmFsdWUgb2YgdGhlIGBIYWNrYm9uZWAgdmFyaWFibGUsIHNvIHRoYXQgaXQgY2FuIGJlCiAgICAvLyByZXN0b3JlZCBsYXRlciBvbiwgaWYgYG5vQ29uZmxpY3RgIGlzIHVzZWQuCiAgICB2YXIgcHJldmlvdXNIYWNrYm9uZSA9IHJvb3QuSGFja2JvbmU7CiAgICAKICAgIC8vIENyZWF0ZSBsb2NhbCByZWZlcmVuY2VzIHRvIGFycmF5IG1ldGhvZHMgd2UnbGwgd2FudCB0byB1c2UgbGF0ZXIuCiAgICB2YXIgYXJyYXkgPSBbXTsKICAgIHZhciBwdXNoID0gYXJyYXkucHVzaDsKICAgIHZhciBzbGljZSA9IGFycmF5LnNsaWNlOwogICAgdmFyIHNwbGljZSA9IGFycmF5LnNwbGljZTsKICAgIAogICAgLy8gVGhlIHRvcC1sZXZlbCBuYW1lc3BhY2UuIEFsbCBwdWJsaWMgSGFja2JvbmUgY2xhc3NlcyBhbmQgbW9kdWxlcyB3aWxsCiAgICAvLyBiZSBhdHRhY2hlZCB0byB0aGlzLiBFeHBvcnRlZCBmb3IgYm90aCB0aGUgYnJvd3NlciBhbmQgdGhlIHNlcnZlci4KICAgIHZhciBIYWNrYm9uZTsKICAgIGlmICh0eXBlb2YgZXhwb3J0cyAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICBIYWNrYm9uZSA9IGV4cG9ydHM7CiAgICB9IGVsc2UgewogICAgICAgIEhhY2tib25lID0gcm9vdC5IYWNrYm9uZSA9IHt9OwogICAgfQogICAgCiAgICAvLyBDdXJyZW50IHZlcnNpb24gb2YgdGhlIGxpYnJhcnkuIEtlZXAgaW4gc3luYyB3aXRoIGBwYWNrYWdlLmpzb25gLgogICAgSGFja2JvbmUuVkVSU0lPTiA9ICcwLjUuMCc7CiAgICAKICAgIC8vIFJlcXVpcmUgVW5kZXJzY29yZSwgaWYgd2UncmUgb24gdGhlIHNlcnZlciwgYW5kIGl0J3Mgbm90IGFscmVhZHkgcHJlc2VudC4KICAgIHZhciBfID0gcm9vdC5fOwogICAgaWYgKCFfICYmICh0eXBlb2YgcmVxdWlyZSAhPT0gJ3VuZGVmaW5lZCcpKSBfID0gcmVxdWlyZSgndW5kZXJzY29yZScpOwogICAgCiAgICAvLyBGb3IgSGFja2JvbmUncyBwdXJwb3NlcywgalF1ZXJ5LCBaZXB0bywgRW5kZXIsIG9yIE15IExpYnJhcnkgKGtpZGRpbmcpIG93bnMKICAgIC8vIHRoZSBgJGAgdmFyaWFibGUuCiAgICBIYWNrYm9uZS4kID0gcm9vdC5qUXVlcnkgfHwgcm9vdC5aZXB0byB8fCByb290LmVuZGVyIHx8IHJvb3QuJDsKICAgIAogICAgLy8gUnVucyBIYWNrYm9uZS5qcyBpbiAqbm9Db25mbGljdCogbW9kZSwgcmV0dXJuaW5nIHRoZSBgSGFja2JvbmVgIHZhcmlhYmxlCiAgICAvLyB0byBpdHMgcHJldmlvdXMgb3duZXIuIFJldHVybnMgYSByZWZlcmVuY2UgdG8gdGhpcyBIYWNrYm9uZSBvYmplY3QuCiAgICBIYWNrYm9uZS5ub0NvbmZsaWN0ID0gZnVuY3Rpb24gKCkgewogICAgICAgIHJvb3QuSGFja2JvbmUgPSBwcmV2aW91c0hhY2tib25lOwogICAgICAgIHJldHVybiB0aGlzOwogICAgfTsKICAgIAogICAgLy8gVHVybiBvbiBgZW11bGF0ZUhUVFBgIHRvIHN1cHBvcnQgbGVnYWN5IEhUVFAgc2VydmVycy4gU2V0dGluZyB0aGlzIG9wdGlvbgogICAgLy8gd2lsbCBmYWtlIGAiUEFUQ0giYCwgYCJQVVQiYCBhbmQgYCJERUxFVEUiYCByZXF1ZXN0cyB2aWEgdGhlIGBfbWV0aG9kYCBwYXJhbWV0ZXIgYW5kCiAgICAvLyBzZXQgYSBgWC1IdHRwLU1ldGhvZC1PdmVycmlkZWAgaGVhZGVyLgogICAgSGFja2JvbmUuZW11bGF0ZUhUVFAgPSBmYWxzZTsKICAgIAogICAgLy8gVHVybiBvbiBgZW11bGF0ZUpTT05gIHRvIHN1cHBvcnQgbGVnYWN5IHNlcnZlcnMgdGhhdCBjYW4ndCBkZWFsIHdpdGggZGlyZWN0CiAgICAvLyBgYXBwbGljYXRpb24vanNvbmAgcmVxdWVzdHMgLi4uIHdpbGwgZW5jb2RlIHRoZSBib2R5IGFzCiAgICAvLyBgYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkYCBpbnN0ZWFkIGFuZCB3aWxsIHNlbmQgdGhlIG1vZGVsIGluIGEKICAgIC8vIGZvcm0gcGFyYW0gbmFtZWQgYG1vZGVsYC4KICAgIEhhY2tib25lLmVtdWxhdGVKU09OID0gZmFsc2U7CiAgICAKICAgIC8vIEhlbHBlciBmdW5jdGlvbiB0byBjb3JyZWN0bHkgc2V0IHVwIHRoZSBwcm90b3R5cGUgY2hhaW4sIGZvciBzdWJjbGFzc2VzLgogICAgLy8gU2ltaWxhciB0byBgZ29vZy5pbmhlcml0c2AsIGJ1dCB1c2VzIGEgaGFzaCBvZiBwcm90b3R5cGUgcHJvcGVydGllcyBhbmQKICAgIC8vIGNsYXNzIHByb3BlcnRpZXMgdG8gYmUgZXh0ZW5kZWQuCiAgICAvLyBUT0RPOiB0aGlzIGlzIGEgdmVyeSBmYXN0IGltcGxlbWVudGF0aW9uLCByZXF1aXJlcyBhIGRlY2VudCBvbmUKICAgIHZhciBleHRlbmQgPSBIYWNrYm9uZS5leHRlbmQgPSBmdW5jdGlvbiAoY29uc3RydWN0b3IsIHByb3RvUHJvcHMsIHN0YXRpY1Byb3BzKSB7CiAgICAgICAgcmV0dXJuIEJhc2UuZXh0ZW5kLmNhbGwoY29uc3RydWN0b3IsIHByb3RvUHJvcHMsIHN0YXRpY1Byb3BzKTsKICAgIH07CgoKICAgIC8vIEhlbHBlcnMKICAgIC8vIC0tLS0tLS0KICAgIAogICAgLy8gVGhyb3cgYW4gZXJyb3Igd2hlbiBhIFVSTCBpcyBuZWVkZWQsIGFuZCBub25lIGlzIHN1cHBsaWVkLgogICAgdmFyIHVybEVycm9yID0gZnVuY3Rpb24gKCkgewogICAgICAgIHRocm93IG5ldyBFcnJvcignQSAidXJsIiBwcm9wZXJ0eSBvciBmdW5jdGlvbiBtdXN0IGJlIHNwZWNpZmllZCcpOwogICAgfTsKICAgIAogICAgLy8gV3JhcCBhbiBvcHRpb25hbCBlcnJvciBjYWxsYmFjayB3aXRoIGEgZmFsbGJhY2sgZXJyb3IgZXZlbnQuCiAgICB2YXIgd3JhcEVycm9yID0gZnVuY3Rpb24gKG1vZGVsLCBvcHRpb25zKSB7CiAgICAgICAgdmFyIGVycm9yID0gb3B0aW9ucy5lcnJvcjsKICAgICAgICBvcHRpb25zLmVycm9yID0gZnVuY3Rpb24gKHJlc3ApIHsKICAgICAgICAgICAgaWYgKGVycm9yKSBlcnJvcihtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CiAgICAgICAgICAgIG1vZGVsLnRyaWdnZXIoJ2Vycm9yJywgbW9kZWwsIHJlc3AsIG9wdGlvbnMpOwogICAgICAgIH07CiAgICB9OwoKICAgIHZhciBCYXNlID0gSGFja2JvbmUuQmFzZSA9IGZ1bmN0aW9uICgpIHt9OwogICAgCiAgICAvLyBIZWxwZXIgZnVuY3Rpb24gdG8gY29ycmVjdGx5IHNldCB1cCB0aGUgcHJvdG90eXBlIGNoYWluLCBmb3Igc3ViY2xhc3Nlcy4KICAgIC8vIFNpbWlsYXIgdG8gYGdvb2cuaW5oZXJpdHNgLCBidXQgdXNlcyBhIGhhc2ggb2YgcHJvdG90eXBlIHByb3BlcnRpZXMgYW5kCiAgICAvLyBjbGFzcyBwcm9wZXJ0aWVzIHRvIGJlIGV4dGVuZGVkLgogICAgQmFzZS5leHRlbmQgPSBmdW5jdGlvbiAocHJvdG9Qcm9wcywgc3RhdGljUHJvcHMpIHsKICAgICAgICB2YXIgcGFyZW50ID0gdGhpczsKICAgICAgICB2YXIgY2hpbGQ7CiAgICAKICAgICAgICAvLyBUaGUgY29uc3RydWN0b3IgZnVuY3Rpb24gZm9yIHRoZSBuZXcgc3ViY2xhc3MgaXMgZWl0aGVyIGRlZmluZWQgYnkgeW91CiAgICAgICAgLy8gKHRoZSAiY29uc3RydWN0b3IiIHByb3BlcnR5IGluIHlvdXIgYGV4dGVuZGAgZGVmaW5pdGlvbiksIG9yIGRlZmF1bHRlZAogICAgICAgIC8vIGJ5IHVzIHRvIHNpbXBseSBjYWxsIHRoZSBwYXJlbnQncyBjb25zdHJ1Y3Rvci4KICAgICAgICBpZiAocHJvdG9Qcm9wcyAmJiBfLmhhcyhwcm90b1Byb3BzLCAnY29uc3RydWN0b3InKSkgewogICAgICAgICAgICBjaGlsZCA9IHByb3RvUHJvcHMuY29uc3RydWN0b3I7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY2hpbGQgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gcGFyZW50LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgIH07CiAgICAgICAgfQogICAgCiAgICAgICAgLy8gQWRkIHN0YXRpYyBwcm9wZXJ0aWVzIHRvIHRoZSBjb25zdHJ1Y3RvciBmdW5jdGlvbiwgaWYgc3VwcGxpZWQuCiAgICAgICAgXy5leHRlbmQoY2hpbGQsIHBhcmVudCwgc3RhdGljUHJvcHMpOwogICAgCiAgICAgICAgLy8gU2V0IHRoZSBwcm90b3R5cGUgY2hhaW4gdG8gaW5oZXJpdCBmcm9tIGBwYXJlbnRgLCB3aXRob3V0IGNhbGxpbmcKICAgICAgICAvLyBgcGFyZW50YCdzIGNvbnN0cnVjdG9yIGZ1bmN0aW9uLgogICAgICAgIHZhciBTdXJyb2dhdGUgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHRoaXMuY29uc3RydWN0b3IgPSBjaGlsZDsKICAgICAgICB9OwogICAgICAgIFN1cnJvZ2F0ZS5wcm90b3R5cGUgPSBwYXJlbnQucHJvdG90eXBlOwogICAgICAgIGNoaWxkLnByb3RvdHlwZSA9IG5ldyBTdXJyb2dhdGUoKTsKICAgIAogICAgICAgIC8vIEFkZCBwcm90b3R5cGUgcHJvcGVydGllcyAoaW5zdGFuY2UgcHJvcGVydGllcykgdG8gdGhlIHN1YmNsYXNzLAogICAgICAgIC8vIGlmIHN1cHBsaWVkLgogICAgICAgIGlmIChwcm90b1Byb3BzKSBfLmV4dGVuZChjaGlsZC5wcm90b3R5cGUsIHByb3RvUHJvcHMpOwogICAgCiAgICAgICAgLy8gU2V0IGEgY29udmVuaWVuY2UgcHJvcGVydHkgaW4gY2FzZSB0aGUgcGFyZW50J3MgcHJvdG90eXBlIGlzIG5lZWRlZAogICAgICAgIC8vIGxhdGVyLgogICAgICAgIGNoaWxkLl9fc3VwZXJfXyA9IHBhcmVudC5wcm90b3R5cGU7CiAgICAKICAgICAgICByZXR1cm4gY2hpbGQ7CiAgICB9OwogICAgCiAgICAvLyBIZWxwZXIgZnVuY3Rpb24gdG8gbWl4IG11bHRpcGxlIGludGVyZmFjZXMsIGJlaGF2aW91cnMgb3IgZmVhdHVyZXMgZnJvbQogICAgQmFzZS5taXhpbiA9IGZ1bmN0aW9uICgvKiBjbGFzc2VzIGFuZCBwcm9wZXJ0eSBtYXBzICovKSB7CiAgICAgICAgdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDApOwogICAgICAgIHZhciBtaXhpbiA9IHt9OwogICAgICAgIHZhciBmZWF0dXJlOwogICAgCiAgICAgICAgd2hpbGUgKGFyZ3MubGVuZ3RoID4gMCkgewogICAgICAgICAgICBmZWF0dXJlID0gYXJncy5zaGlmdCgpOwogICAgICAgICAgICBpZiAodHlwZW9mIGZlYXR1cmUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIGZlYXR1cmUgPSBmZWF0dXJlLnByb3RvdHlwZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBfLmV4dGVuZChtaXhpbiwgZmVhdHVyZSk7CiAgICAgICAgfQogICAgCiAgICAgICAgcmV0dXJuIHRoaXMuZXh0ZW5kKG1peGluKTsKICAgIH07CiAgICAKICAgIEJhc2UuaW1wbGVtZW50ID0gZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAwKTsKICAgICAgICB2YXIgcHJvdG8gPSB0aGlzLnByb3RvdHlwZTsKICAgICAgICB2YXIgZmVhdHVyZTsKICAgIAogICAgICAgIHdoaWxlIChhcmdzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgZmVhdHVyZSA9IGFyZ3Muc2hpZnQoKTsKICAgICAgICAgICAgaWYgKHR5cGVvZiBmZWF0dXJlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICBmZWF0dXJlID0gZmVhdHVyZS5wcm90b3R5cGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgXy5leHRlbmQocHJvdG8sIGZlYXR1cmUpOwogICAgICAgIH0KICAgIAogICAgICAgIHJldHVybiB0aGlzOwogICAgfTsKCgogICAgLy8gQ29tcG9uZW50IGNsYXNzIHByb3ZpZGVzIGdlbmVyYWwvYmFzaWMgbGlmZWN5Y2xlIGludGVyZmFjZS4KICAgIHZhciBDb21wb25lbnQgPSBIYWNrYm9uZS5Db21wb25lbnQgPSBCYXNlLmV4dGVuZCh7CiAgICAgICAgLy8gSW5pdGlhbGl6ZXMgdGhlIENvbXBvbmVudC4gT3ZlcnJpZGUgaWYgY3VzdG9tIGxvZ2ljIG5lZWRlZC4KICAgICAgICBpbml0aWFsaXplOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCiAgICAKICAgICAgICAvLyBQYXVzZXMgb3IgbXV0ZXMgdGhlIENvbXBvbmVudC4gT3ZlcnJpZGUgaWYgY3VzdG9tIGxvZ2ljIG5lZWRlZC4KICAgICAgICBwYXVzZTogZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9LAogICAgCiAgICAgICAgLy8gUmVzdW1lcyB0aGUgQ29tcG9uZW50IGZyb20gcGF1c2VkIG9yIG11dGVkIHN0YXRlLiBPdmVycmlkZSBpZiBjdXN0b20gbG9naWMgbmVlZGVkLgogICAgICAgIHJlc3VtZTogZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9LAogICAgCiAgICAgICAgLy8gRGVzdHJveXMgdGhlIENvbXBvbmVudC4gT3ZlcnJpZGUgaWYgY3VzdG9tIGxvZ2ljIG5lZWRlZC4KICAgICAgICBkZXN0cm95OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0KICAgIH0pOwoKICAgIC8vIEhhY2tib25lLkV2ZW50cwogICAgLy8gLS0tLS0tLS0tLS0tLS0tCiAgICAKICAgIC8vIEEgbW9kdWxlIHRoYXQgY2FuIGJlIG1peGVkIGluIHRvICphbnkgb2JqZWN0KiBpbiBvcmRlciB0byBwcm92aWRlIGl0IHdpdGgKICAgIC8vIGN1c3RvbSBldmVudHMuIFlvdSBtYXkgYmluZCB3aXRoIGBvbmAgb3IgcmVtb3ZlIHdpdGggYG9mZmAgY2FsbGJhY2sKICAgIC8vIGZ1bmN0aW9ucyB0byBhbiBldmVudDsgYHRyaWdnZXJgLWluZyBhbiBldmVudCBmaXJlcyBhbGwgY2FsbGJhY2tzIGluCiAgICAvLyBzdWNjZXNzaW9uLgogICAgLy8KICAgIC8vICAgICB2YXIgb2JqZWN0ID0ge307CiAgICAvLyAgICAgXy5leHRlbmQob2JqZWN0LCBIYWNrYm9uZS5FdmVudHMpOwogICAgLy8gICAgIG9iamVjdC5vbignZXhwYW5kJywgZnVuY3Rpb24oKXsgYWxlcnQoJ2V4cGFuZGVkJyk7IH0pOwogICAgLy8gICAgIG9iamVjdC50cmlnZ2VyKCdleHBhbmQnKTsKICAgIC8vCiAgICB2YXIgRXZlbnRzID0gSGFja2JvbmUuRXZlbnRzID0gewogICAgCiAgICAgICAgLy8gQmluZCBhbiBldmVudCB0byBhIGBjYWxsYmFja2AgZnVuY3Rpb24uIFBhc3NpbmcgYCJhbGwiYCB3aWxsIGJpbmQKICAgICAgICAvLyB0aGUgY2FsbGJhY2sgdG8gYWxsIGV2ZW50cyBmaXJlZC4KICAgICAgICBvbjogZnVuY3Rpb24gKG5hbWUsIGNhbGxiYWNrLCBjb250ZXh0KSB7CiAgICAgICAgICAgIGlmICghZXZlbnRzQXBpKHRoaXMsICdvbicsIG5hbWUsIFtjYWxsYmFjaywgY29udGV4dF0pIHx8ICFjYWxsYmFjaykgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgIHRoaXMuX2V2ZW50cyB8fCAodGhpcy5fZXZlbnRzID0ge30pOwogICAgICAgICAgICB2YXIgZXZlbnRzID0gdGhpcy5fZXZlbnRzW25hbWVdIHx8ICh0aGlzLl9ldmVudHNbbmFtZV0gPSBbXSk7CiAgICAgICAgICAgIGV2ZW50cy5wdXNoKHtjYWxsYmFjazogY2FsbGJhY2ssIGNvbnRleHQ6IGNvbnRleHQsIGN0eDogY29udGV4dCB8fCB0aGlzfSk7CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCiAgICAKICAgICAgICAvLyBCaW5kIGFuIGV2ZW50IHRvIG9ubHkgYmUgdHJpZ2dlcmVkIGEgc2luZ2xlIHRpbWUuIEFmdGVyIHRoZSBmaXJzdCB0aW1lCiAgICAgICAgLy8gdGhlIGNhbGxiYWNrIGlzIGludm9rZWQsIGl0IHdpbGwgYmUgcmVtb3ZlZC4KICAgICAgICBvbmNlOiBmdW5jdGlvbiAobmFtZSwgY2FsbGJhY2ssIGNvbnRleHQpIHsKICAgICAgICAgICAgaWYgKCFldmVudHNBcGkodGhpcywgJ29uY2UnLCBuYW1lLCBbY2FsbGJhY2ssIGNvbnRleHRdKSB8fCAhY2FsbGJhY2spIHJldHVybiB0aGlzOwogICAgICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgICAgICAgIHZhciBvbmNlID0gXy5vbmNlKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHNlbGYub2ZmKG5hbWUsIG9uY2UpOwogICAgICAgICAgICAgICAgY2FsbGJhY2suYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIG9uY2UuX2NhbGxiYWNrID0gY2FsbGJhY2s7CiAgICAgICAgICAgIHJldHVybiB0aGlzLm9uKG5hbWUsIG9uY2UsIGNvbnRleHQpOwogICAgICAgIH0sCiAgICAKICAgICAgICAvLyBSZW1vdmUgb25lIG9yIG1hbnkgY2FsbGJhY2tzLiBJZiBgY29udGV4dGAgaXMgbnVsbCwgcmVtb3ZlcyBhbGwKICAgICAgICAvLyBjYWxsYmFja3Mgd2l0aCB0aGF0IGZ1bmN0aW9uLiBJZiBgY2FsbGJhY2tgIGlzIG51bGwsIHJlbW92ZXMgYWxsCiAgICAgICAgLy8gY2FsbGJhY2tzIGZvciB0aGUgZXZlbnQuIElmIGBuYW1lYCBpcyBudWxsLCByZW1vdmVzIGFsbCBib3VuZAogICAgICAgIC8vIGNhbGxiYWNrcyBmb3IgYWxsIGV2ZW50cy4KICAgICAgICBvZmY6IGZ1bmN0aW9uIChuYW1lLCBjYWxsYmFjaywgY29udGV4dCkgewogICAgICAgICAgICB2YXIgcmV0YWluLCBldiwgZXZlbnRzLCBuYW1lcywgaSwgbCwgaiwgazsKICAgICAgICAgICAgaWYgKCF0aGlzLl9ldmVudHMgfHwgIWV2ZW50c0FwaSh0aGlzLCAnb2ZmJywgbmFtZSwgW2NhbGxiYWNrLCBjb250ZXh0XSkpIHJldHVybiB0aGlzOwogICAgICAgICAgICBpZiAoIW5hbWUgJiYgIWNhbGxiYWNrICYmICFjb250ZXh0KSB7CiAgICAgICAgICAgICAgICB0aGlzLl9ldmVudHMgPSB7fTsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgICB9CiAgICAKICAgICAgICAgICAgbmFtZXMgPSBuYW1lID8gW25hbWVdIDogXy5rZXlzKHRoaXMuX2V2ZW50cyk7CiAgICAgICAgICAgIGZvciAoaSA9IDAsIGwgPSBuYW1lcy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgICAgICAgIG5hbWUgPSBuYW1lc1tpXTsKICAgICAgICAgICAgICAgIGlmIChldmVudHMgPSB0aGlzLl9ldmVudHNbbmFtZV0pIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9ldmVudHNbbmFtZV0gPSByZXRhaW4gPSBbXTsKICAgICAgICAgICAgICAgICAgICBpZiAoY2FsbGJhY2sgfHwgY29udGV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGogPSAwLCBrID0gZXZlbnRzLmxlbmd0aDsgaiA8IGs7IGorKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZXYgPSBldmVudHNbal07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoKGNhbGxiYWNrICYmIGNhbGxiYWNrICE9PSBldi5jYWxsYmFjayAmJiBjYWxsYmFjayAhPT0gZXYuY2FsbGJhY2suX2NhbGxiYWNrKSB8fAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIChjb250ZXh0ICYmIGNvbnRleHQgIT09IGV2LmNvbnRleHQpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0YWluLnB1c2goZXYpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmICghcmV0YWluLmxlbmd0aCkgZGVsZXRlIHRoaXMuX2V2ZW50c1tuYW1lXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgCiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCiAgICAKICAgICAgICAvLyBUcmlnZ2VyIG9uZSBvciBtYW55IGV2ZW50cywgZmlyaW5nIGFsbCBib3VuZCBjYWxsYmFja3MuIENhbGxiYWNrcyBhcmUKICAgICAgICAvLyBwYXNzZWQgdGhlIHNhbWUgYXJndW1lbnRzIGFzIGB0cmlnZ2VyYCBpcywgYXBhcnQgZnJvbSB0aGUgZXZlbnQgbmFtZQogICAgICAgIC8vICh1bmxlc3MgeW91J3JlIGxpc3RlbmluZyBvbiBgImFsbCJgLCB3aGljaCB3aWxsIGNhdXNlIHlvdXIgY2FsbGJhY2sgdG8KICAgICAgICAvLyByZWNlaXZlIHRoZSB0cnVlIG5hbWUgb2YgdGhlIGV2ZW50IGFzIHRoZSBmaXJzdCBhcmd1bWVudCkuCiAgICAgICAgdHJpZ2dlcjogZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLl9ldmVudHMpIHJldHVybiB0aGlzOwogICAgICAgICAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKICAgICAgICAgICAgaWYgKCFldmVudHNBcGkodGhpcywgJ3RyaWdnZXInLCBuYW1lLCBhcmdzKSkgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgIHZhciBldmVudHMgPSB0aGlzLl9ldmVudHNbbmFtZV07CiAgICAgICAgICAgIHZhciBhbGxFdmVudHMgPSB0aGlzLl9ldmVudHMuYWxsOwogICAgICAgICAgICBpZiAoZXZlbnRzKSB0cmlnZ2VyRXZlbnRzKGV2ZW50cywgYXJncyk7CiAgICAgICAgICAgIGlmIChhbGxFdmVudHMpIHRyaWdnZXJFdmVudHMoYWxsRXZlbnRzLCBhcmd1bWVudHMpOwogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9LAogICAgCiAgICAgICAgLy8gVGVsbCB0aGlzIG9iamVjdCB0byBzdG9wIGxpc3RlbmluZyB0byBlaXRoZXIgc3BlY2lmaWMgZXZlbnRzIC4uLiBvcgogICAgICAgIC8vIHRvIGV2ZXJ5IG9iamVjdCBpdCdzIGN1cnJlbnRseSBsaXN0ZW5pbmcgdG8uCiAgICAgICAgc3RvcExpc3RlbmluZzogZnVuY3Rpb24gKG9iaiwgbmFtZSwgY2FsbGJhY2spIHsKICAgICAgICAgICAgdmFyIGxpc3RlbmVycyA9IHRoaXMuX2xpc3RlbmVyczsKICAgICAgICAgICAgaWYgKCFsaXN0ZW5lcnMpIHJldHVybiB0aGlzOwogICAgICAgICAgICB2YXIgZGVsZXRlTGlzdGVuZXIgPSAhbmFtZSAmJiAhY2FsbGJhY2s7CiAgICAgICAgICAgIGlmICh0eXBlb2YgbmFtZSA9PT0gJ29iamVjdCcpIGNhbGxiYWNrID0gdGhpczsKICAgICAgICAgICAgaWYgKG9iaikgKGxpc3RlbmVycyA9IHt9KVtvYmouX2xpc3RlbmVySWRdID0gb2JqOwogICAgICAgICAgICBmb3IgKHZhciBpZCBpbiBsaXN0ZW5lcnMpIHsKICAgICAgICAgICAgICAgIGlmIChsaXN0ZW5lcnMuaGFzT3duUHJvcGVydHkoaWQpKSB7CiAgICAgICAgICAgICAgICAgICAgbGlzdGVuZXJzW2lkXS5vZmYobmFtZSwgY2FsbGJhY2ssIHRoaXMpOwogICAgICAgICAgICAgICAgICAgIGlmIChkZWxldGVMaXN0ZW5lcikgZGVsZXRlIHRoaXMuX2xpc3RlbmVyc1tpZF07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfQogICAgCiAgICB9OwogICAgCiAgICAvLyBSZWd1bGFyIGV4cHJlc3Npb24gdXNlZCB0byBzcGxpdCBldmVudCBzdHJpbmdzLgogICAgdmFyIGV2ZW50U3BsaXR0ZXIgPSAvXHMrLzsKICAgIAogICAgLy8gSW1wbGVtZW50IGZhbmN5IGZlYXR1cmVzIG9mIHRoZSBFdmVudHMgQVBJIHN1Y2ggYXMgbXVsdGlwbGUgZXZlbnQKICAgIC8vIG5hbWVzIGAiY2hhbmdlIGJsdXIiYCBhbmQgalF1ZXJ5LXN0eWxlIGV2ZW50IG1hcHMgYHtjaGFuZ2U6IGFjdGlvbn1gCiAgICAvLyBpbiB0ZXJtcyBvZiB0aGUgZXhpc3RpbmcgQVBJLgogICAgdmFyIGV2ZW50c0FwaSA9IGZ1bmN0aW9uIChvYmosIGFjdGlvbiwgbmFtZSwgcmVzdCkgewogICAgICAgIGlmICghbmFtZSkgcmV0dXJuIHRydWU7CiAgICAKICAgICAgICAvLyBIYW5kbGUgZXZlbnQgbWFwcy4KICAgICAgICBpZiAodHlwZW9mIG5hbWUgPT09ICdvYmplY3QnKSB7CiAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiBuYW1lKSB7CiAgICAgICAgICAgICAgICBpZiAobmFtZS5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CiAgICAgICAgICAgICAgICAgICAgb2JqW2FjdGlvbl0uYXBwbHkob2JqLCBba2V5LCBuYW1lW2tleV1dLmNvbmNhdChyZXN0KSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgIAogICAgICAgIC8vIEhhbmRsZSBzcGFjZSBzZXBhcmF0ZWQgZXZlbnQgbmFtZXMuCiAgICAgICAgaWYgKGV2ZW50U3BsaXR0ZXIudGVzdChuYW1lKSkgewogICAgICAgICAgICB2YXIgbmFtZXMgPSBuYW1lLnNwbGl0KGV2ZW50U3BsaXR0ZXIpOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgbCA9IG5hbWVzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgICAgICAgb2JqW2FjdGlvbl0uYXBwbHkob2JqLCBbbmFtZXNbaV1dLmNvbmNhdChyZXN0KSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgIAogICAgICAgIHJldHVybiB0cnVlOwogICAgfTsKICAgIAogICAgLy8gQSBkaWZmaWN1bHQtdG8tYmVsaWV2ZSwgYnV0IG9wdGltaXplZCBpbnRlcm5hbCBkaXNwYXRjaCBmdW5jdGlvbiBmb3IKICAgIC8vIHRyaWdnZXJpbmcgZXZlbnRzLiBUcmllcyB0byBrZWVwIHRoZSB1c3VhbCBjYXNlcyBzcGVlZHkgKG1vc3QgaW50ZXJuYWwKICAgIC8vIEhhY2tib25lIGV2ZW50cyBoYXZlIDMgYXJndW1lbnRzKS4KICAgIHZhciB0cmlnZ2VyRXZlbnRzID0gZnVuY3Rpb24gKGV2ZW50cywgYXJncykgewogICAgICAgIHZhciBldiwgaSA9IC0xLCBsID0gZXZlbnRzLmxlbmd0aCwgYTEgPSBhcmdzWzBdLCBhMiA9IGFyZ3NbMV0sIGEzID0gYXJnc1syXTsKICAgICAgICBzd2l0Y2ggKGFyZ3MubGVuZ3RoKSB7CiAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICAgIHdoaWxlICgrK2kgPCBsKSAoZXYgPSBldmVudHNbaV0pLmNhbGxiYWNrLmNhbGwoZXYuY3R4KTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgY2FzZSAxOgogICAgICAgICAgICAgICAgd2hpbGUgKCsraSA8IGwpIChldiA9IGV2ZW50c1tpXSkuY2FsbGJhY2suY2FsbChldi5jdHgsIGExKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgY2FzZSAyOgogICAgICAgICAgICAgICAgd2hpbGUgKCsraSA8IGwpIChldiA9IGV2ZW50c1tpXSkuY2FsbGJhY2suY2FsbChldi5jdHgsIGExLCBhMik7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIGNhc2UgMzoKICAgICAgICAgICAgICAgIHdoaWxlICgrK2kgPCBsKSAoZXYgPSBldmVudHNbaV0pLmNhbGxiYWNrLmNhbGwoZXYuY3R4LCBhMSwgYTIsIGEzKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgIHdoaWxlICgrK2kgPCBsKSAoZXYgPSBldmVudHNbaV0pLmNhbGxiYWNrLmFwcGx5KGV2LmN0eCwgYXJncyk7CiAgICAgICAgfQogICAgfTsKICAgIAogICAgdmFyIGxpc3Rlbk1ldGhvZHMgPSB7bGlzdGVuVG86ICdvbicsIGxpc3RlblRvT25jZTogJ29uY2UnfTsKICAgIAogICAgLy8gSW52ZXJzaW9uLW9mLWNvbnRyb2wgdmVyc2lvbnMgb2YgYG9uYCBhbmQgYG9uY2VgLiBUZWxsICp0aGlzKiBvYmplY3QgdG8KICAgIC8vIGxpc3RlbiB0byBhbiBldmVudCBpbiBhbm90aGVyIG9iamVjdCAuLi4ga2VlcGluZyB0cmFjayBvZiB3aGF0IGl0J3MKICAgIC8vIGxpc3RlbmluZyB0by4KICAgIF8uZWFjaChsaXN0ZW5NZXRob2RzLCBmdW5jdGlvbiAoaW1wbGVtZW50YXRpb24sIG1ldGhvZCkgewogICAgICAgIEV2ZW50c1ttZXRob2RdID0gZnVuY3Rpb24gKG9iaiwgbmFtZSwgY2FsbGJhY2spIHsKICAgICAgICAgICAgdmFyIGxpc3RlbmVycyA9IHRoaXMuX2xpc3RlbmVycyB8fCAodGhpcy5fbGlzdGVuZXJzID0ge30pOwogICAgICAgICAgICB2YXIgaWQgPSBvYmouX2xpc3RlbmVySWQgfHwgKG9iai5fbGlzdGVuZXJJZCA9IF8udW5pcXVlSWQoJ2wnKSk7CiAgICAgICAgICAgIGxpc3RlbmVyc1tpZF0gPSBvYmo7CiAgICAgICAgICAgIGlmICh0eXBlb2YgbmFtZSA9PT0gJ29iamVjdCcpIGNhbGxiYWNrID0gdGhpczsKICAgICAgICAgICAgb2JqW2ltcGxlbWVudGF0aW9uXShuYW1lLCBjYWxsYmFjaywgdGhpcyk7CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH07CiAgICB9KTsKICAgIAogICAgLy8gQWxpYXNlcyBmb3IgYmFja3dhcmRzIGNvbXBhdGliaWxpdHkuCiAgICBFdmVudHMuYmluZCA9IEV2ZW50cy5vbjsKICAgIEV2ZW50cy51bmJpbmQgPSBFdmVudHMub2ZmOwogICAgCiAgICAvLyBBbGxvdyB0aGUgYEhhY2tib25lYCBvYmplY3QgdG8gc2VydmUgYXMgYSBnbG9iYWwgZXZlbnQgYnVzLCBmb3IgZm9sa3Mgd2hvCiAgICAvLyB3YW50IGdsb2JhbCAicHVic3ViIiBpbiBhIGNvbnZlbmllbnQgcGxhY2UuCiAgICBfLmV4dGVuZChIYWNrYm9uZSwgRXZlbnRzKTsKCiAgICAvL0JhY2tib25lLlN0YXRlCiAgICAKICAgIC8vSGFja2JvbmUuU3RhdGUgcHJvdmlkZXMgYSBzaW1wbGUgZXZlbnRlZCBkYXRhLXN0b3JlIHdpdGhvdXQgYW55IFJFU1RmdWwgZmVhdHVyZXMuCiAgICB2YXIgU3RhdGUgPSBIYWNrYm9uZS5TdGF0ZSA9IENvbXBvbmVudC5leHRlbmQoewogICAgCiAgICAgICAgLy8gVGhlIGRlZmF1bHQgbmFtZSBmb3IgdGhlIEpTT04gYGlkYCBhdHRyaWJ1dGUgaXMgYCJpZCJgLiBNb25nb0RCIGFuZAogICAgICAgIC8vIENvdWNoREIgdXNlcnMgbWF5IHdhbnQgdG8gc2V0IHRoaXMgdG8gYCJfaWQiYC4KICAgICAgICBpZEF0dHJpYnV0ZTogJ2lkJywKICAgIAogICAgICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbiAoYXR0cmlidXRlcywgb3B0aW9ucykgewogICAgICAgICAgICB2YXIgZGVmYXVsdHM7CiAgICAgICAgICAgIHZhciBhdHRycyA9IGF0dHJpYnV0ZXMgfHwge307CiAgICAgICAgICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CiAgICAgICAgICAgIHRoaXMuY2lkID0gXy51bmlxdWVJZCgnYycpOwogICAgICAgICAgICB0aGlzLmF0dHJpYnV0ZXMgPSB7fTsKICAgICAgICAgICAgaWYgKG9wdGlvbnMuY29sbGVjdGlvbikgdGhpcy5jb2xsZWN0aW9uID0gb3B0aW9ucy5jb2xsZWN0aW9uOwogICAgICAgICAgICBpZiAob3B0aW9ucy5wYXJzZSkgYXR0cnMgPSB0aGlzLnBhcnNlKGF0dHJzLCBvcHRpb25zKSB8fCB7fTsKICAgICAgICAgICAgb3B0aW9ucy5fYXR0cnMgfHwgKG9wdGlvbnMuX2F0dHJzID0gYXR0cnMpOwogICAgICAgICAgICBpZiAoZGVmYXVsdHMgPSBfLnJlc3VsdCh0aGlzLCAnZGVmYXVsdHMnKSkgewogICAgICAgICAgICAgICAgYXR0cnMgPSBfLmRlZmF1bHRzKHt9LCBhdHRycywgZGVmYXVsdHMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuc2V0KGF0dHJzLCBvcHRpb25zKTsKICAgICAgICAgICAgdGhpcy5jaGFuZ2VkID0ge307CiAgICAgICAgfSwKICAgIAogICAgICAgIC8vIEEgaGFzaCBvZiBhdHRyaWJ1dGVzIHdob3NlIGN1cnJlbnQgYW5kIHByZXZpb3VzIHZhbHVlIGRpZmZlci4KICAgICAgICBjaGFuZ2VkOiBudWxsLAogICAgCiAgICAgICAgLy8gVGhlIHZhbHVlIHJldHVybmVkIGR1cmluZyB0aGUgbGFzdCBmYWlsZWQgdmFsaWRhdGlvbi4KICAgICAgICB2YWxpZGF0aW9uRXJyb3I6IG51bGwsCiAgICAKICAgICAgICAvLyBSZXR1cm4gYSBjb3B5IG9mIHRoZSBTdGF0ZSdzIGBhdHRyaWJ1dGVzYCBvYmplY3QuCiAgICAgICAgdG9KU09OOiBmdW5jdGlvbiAob3B0aW9ucykgewogICAgICAgICAgICByZXR1cm4gXy5jbG9uZSh0aGlzLmF0dHJpYnV0ZXMpOwogICAgICAgIH0sCiAgICAKICAgICAgICAvLyBHZXQgdGhlIHZhbHVlIG9mIGFuIGF0dHJpYnV0ZS4KICAgICAgICBnZXQ6IGZ1bmN0aW9uIChhdHRyKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmF0dHJpYnV0ZXNbYXR0cl07CiAgICAgICAgfSwKICAgIAogICAgICAgIC8vIEdldCB0aGUgSFRNTC1lc2NhcGVkIHZhbHVlIG9mIGFuIGF0dHJpYnV0ZS4KICAgICAgICBlc2NhcGU6IGZ1bmN0aW9uIChhdHRyKSB7CiAgICAgICAgICAgIHJldHVybiBfLmVzY2FwZSh0aGlzLmdldChhdHRyKSk7CiAgICAgICAgfSwKICAgIAogICAgICAgIC8vIFJldHVybnMgYHRydWVgIGlmIHRoZSBhdHRyaWJ1dGUgY29udGFpbnMgYSB2YWx1ZSB0aGF0IGlzIG5vdCBudWxsCiAgICAgICAgLy8gb3IgdW5kZWZpbmVkLgogICAgICAgIGhhczogZnVuY3Rpb24gKGF0dHIpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0KGF0dHIpICE9IG51bGw7CiAgICAgICAgfSwKICAgIAogICAgICAgIC8vIFNldCBhIGhhc2ggb2YgU3RhdGUgYXR0cmlidXRlcyBvbiB0aGUgb2JqZWN0LCBmaXJpbmcgYCJjaGFuZ2UiYC4gVGhpcyBpcwogICAgICAgIC8vIHRoZSBjb3JlIHByaW1pdGl2ZSBvcGVyYXRpb24gb2YgYSBTdGF0ZSwgdXBkYXRpbmcgdGhlIGRhdGEgYW5kIG5vdGlmeWluZwogICAgICAgIC8vIGFueW9uZSB3aG8gbmVlZHMgdG8ga25vdyBhYm91dCB0aGUgY2hhbmdlIGluIHN0YXRlLiBUaGUgaGVhcnQgb2YgdGhlIGJlYXN0LgogICAgICAgIHNldDogZnVuY3Rpb24gKGtleSwgdmFsLCBvcHRpb25zKSB7CiAgICAgICAgICAgIHZhciBhdHRyLCBhdHRycywgdW5zZXQsIGNoYW5nZXMsIHNpbGVudCwgY2hhbmdpbmcsIHByZXYsIGN1cnJlbnQ7CiAgICAgICAgICAgIGlmIChrZXkgPT0gbnVsbCkgcmV0dXJuIHRoaXM7CiAgICAKICAgICAgICAgICAgLy8gSGFuZGxlIGJvdGggYCJrZXkiLCB2YWx1ZWAgYW5kIGB7a2V5OiB2YWx1ZX1gIC1zdHlsZSBhcmd1bWVudHMuCiAgICAgICAgICAgIGlmICh0eXBlb2Yga2V5ID09PSAnb2JqZWN0JykgewogICAgICAgICAgICAgICAgYXR0cnMgPSBrZXk7CiAgICAgICAgICAgICAgICBvcHRpb25zID0gdmFsOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgKGF0dHJzID0ge30pW2tleV0gPSB2YWw7CiAgICAgICAgICAgIH0KICAgIAogICAgICAgICAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwogICAgCiAgICAgICAgICAgIC8vIFJ1biB2YWxpZGF0aW9uLgogICAgICAgICAgICBpZiAoIXRoaXMuX3ZhbGlkYXRlKGF0dHJzLCBvcHRpb25zKSkgcmV0dXJuIGZhbHNlOwogICAgCiAgICAgICAgICAgIC8vIEV4dHJhY3QgYXR0cmlidXRlcyBhbmQgb3B0aW9ucy4KICAgICAgICAgICAgdW5zZXQgPSBvcHRpb25zLnVuc2V0OwogICAgICAgICAgICBzaWxlbnQgPSBvcHRpb25zLnNpbGVudDsKICAgICAgICAgICAgY2hhbmdlcyA9IFtdOwogICAgICAgICAgICBjaGFuZ2luZyA9IHRoaXMuX2NoYW5naW5nOwogICAgICAgICAgICB0aGlzLl9jaGFuZ2luZyA9IHRydWU7CiAgICAKICAgICAgICAgICAgaWYgKCFjaGFuZ2luZykgewogICAgICAgICAgICAgICAgdGhpcy5fcHJldmlvdXNBdHRyaWJ1dGVzID0gXy5jbG9uZSh0aGlzLmF0dHJpYnV0ZXMpOwogICAgICAgICAgICAgICAgdGhpcy5jaGFuZ2VkID0ge307CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY3VycmVudCA9IHRoaXMuYXR0cmlidXRlcywgcHJldiA9IHRoaXMuX3ByZXZpb3VzQXR0cmlidXRlczsKICAgIAogICAgICAgICAgICAvLyBDaGVjayBmb3IgY2hhbmdlcyBvZiBgaWRgLgogICAgICAgICAgICBpZiAodGhpcy5pZEF0dHJpYnV0ZSBpbiBhdHRycykgdGhpcy5pZCA9IGF0dHJzW3RoaXMuaWRBdHRyaWJ1dGVdOwogICAgCiAgICAgICAgICAgIC8vIEZvciBlYWNoIGBzZXRgIGF0dHJpYnV0ZSwgdXBkYXRlIG9yIGRlbGV0ZSB0aGUgY3VycmVudCB2YWx1ZS4KICAgICAgICAgICAgZm9yIChhdHRyIGluIGF0dHJzKSB7CiAgICAgICAgICAgICAgICB2YWwgPSBhdHRyc1thdHRyXTsKICAgICAgICAgICAgICAgIGlmICghXy5pc0VxdWFsKGN1cnJlbnRbYXR0cl0sIHZhbCkpIGNoYW5nZXMucHVzaChhdHRyKTsKICAgICAgICAgICAgICAgIGlmICghXy5pc0VxdWFsKHByZXZbYXR0cl0sIHZhbCkpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNoYW5nZWRbYXR0cl0gPSB2YWw7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLmNoYW5nZWRbYXR0cl07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB1bnNldCA/IGRlbGV0ZSBjdXJyZW50W2F0dHJdIDogY3VycmVudFthdHRyXSA9IHZhbDsKICAgICAgICAgICAgfQogICAgCiAgICAgICAgICAgIC8vIFRyaWdnZXIgYWxsIHJlbGV2YW50IGF0dHJpYnV0ZSBjaGFuZ2VzLgogICAgICAgICAgICBpZiAoIXNpbGVudCkgewogICAgICAgICAgICAgICAgaWYgKGNoYW5nZXMubGVuZ3RoKSB0aGlzLl9wZW5kaW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBsID0gY2hhbmdlcy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnRyaWdnZXIoJ2NoYW5nZTonICsgY2hhbmdlc1tpXSwgdGhpcywgY3VycmVudFtjaGFuZ2VzW2ldXSwgb3B0aW9ucyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgIAogICAgICAgICAgICAvLyBZb3UgbWlnaHQgYmUgd29uZGVyaW5nIHdoeSB0aGVyZSdzIGEgYHdoaWxlYCBsb29wIGhlcmUuIENoYW5nZXMgY2FuCiAgICAgICAgICAgIC8vIGJlIHJlY3Vyc2l2ZWx5IG5lc3RlZCB3aXRoaW4gYCJjaGFuZ2UiYCBldmVudHMuCiAgICAgICAgICAgIGlmIChjaGFuZ2luZykgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgIGlmICghc2lsZW50KSB7CiAgICAgICAgICAgICAgICB3aGlsZSAodGhpcy5fcGVuZGluZykgewogICAgICAgICAgICAgICAgICAgIHRoaXMuX3BlbmRpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnRyaWdnZXIoJ2NoYW5nZScsIHRoaXMsIG9wdGlvbnMpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuX3BlbmRpbmcgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5fY2hhbmdpbmcgPSBmYWxzZTsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSwKICAgIAogICAgICAgIC8vIFJlbW92ZSBhbiBhdHRyaWJ1dGUgZnJvbSB0aGUgU3RhdGUsIGZpcmluZyBgImNoYW5nZSJgLiBgdW5zZXRgIGlzIGEgbm9vcAogICAgICAgIC8vIGlmIHRoZSBhdHRyaWJ1dGUgZG9lc24ndCBleGlzdC4KICAgICAgICB1bnNldDogZnVuY3Rpb24gKGF0dHIsIG9wdGlvbnMpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuc2V0KGF0dHIsIHZvaWQgMCwgXy5leHRlbmQoe30sIG9wdGlvbnMsIHt1bnNldDogdHJ1ZX0pKTsKICAgICAgICB9LAogICAgCiAgICAgICAgLy8gQ2xlYXIgYWxsIGF0dHJpYnV0ZXMgb24gdGhlIFN0YXRlLCBmaXJpbmcgYCJjaGFuZ2UiYC4KICAgICAgICBjbGVhcjogZnVuY3Rpb24gKG9wdGlvbnMpIHsKICAgICAgICAgICAgdmFyIGF0dHJzID0ge307CiAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiB0aGlzLmF0dHJpYnV0ZXMpIGF0dHJzW2tleV0gPSB2b2lkIDA7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnNldChhdHRycywgXy5leHRlbmQoe30sIG9wdGlvbnMsIHt1bnNldDogdHJ1ZX0pKTsKICAgICAgICB9LAogICAgCiAgICAgICAgLy8gRGVzdHJveXMgdGhlIFN0YXRlIGJ5IGNsZWFyaW5nIGFsbCBhdHRyaWJ1dGVzLgogICAgICAgIC8vIENvbnZlbmllbmNlIG1ldGhvZCBmb3IgZXh0ZW5kaW5nIGJhc2UgQ29tcG9uZW50LgogICAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuY2xlYXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICB9LAogICAgCiAgICAgICAgLy8gRGV0ZXJtaW5lIGlmIHRoZSBTdGF0ZSBoYXMgY2hhbmdlZCBzaW5jZSB0aGUgbGFzdCBgImNoYW5nZSJgIGV2ZW50LgogICAgICAgIC8vIElmIHlvdSBzcGVjaWZ5IGFuIGF0dHJpYnV0ZSBuYW1lLCBkZXRlcm1pbmUgaWYgdGhhdCBhdHRyaWJ1dGUgaGFzIGNoYW5nZWQuCiAgICAgICAgaGFzQ2hhbmdlZDogZnVuY3Rpb24gKGF0dHIpIHsKICAgICAgICAgICAgaWYgKGF0dHIgPT0gbnVsbCkgcmV0dXJuICFfLmlzRW1wdHkodGhpcy5jaGFuZ2VkKTsKICAgICAgICAgICAgcmV0dXJuIF8uaGFzKHRoaXMuY2hhbmdlZCwgYXR0cik7CiAgICAgICAgfSwKICAgIAogICAgICAgIC8vIFJldHVybiBhbiBvYmplY3QgY29udGFpbmluZyBhbGwgdGhlIGF0dHJpYnV0ZXMgdGhhdCBoYXZlIGNoYW5nZWQsIG9yCiAgICAgICAgLy8gZmFsc2UgaWYgdGhlcmUgYXJlIG5vIGNoYW5nZWQgYXR0cmlidXRlcy4gVXNlZnVsIGZvciBkZXRlcm1pbmluZyB3aGF0CiAgICAgICAgLy8gcGFydHMgb2YgYSB2aWV3IG5lZWQgdG8gYmUgdXBkYXRlZCBhbmQvb3Igd2hhdCBhdHRyaWJ1dGVzIG5lZWQgdG8gYmUKICAgICAgICAvLyBwZXJzaXN0ZWQgdG8gdGhlIHNlcnZlci4gVW5zZXQgYXR0cmlidXRlcyB3aWxsIGJlIHNldCB0byB1bmRlZmluZWQuCiAgICAgICAgLy8gWW91IGNhbiBhbHNvIHBhc3MgYW4gYXR0cmlidXRlcyBvYmplY3QgdG8gZGlmZiBhZ2FpbnN0IHRoZSBTdGF0ZSwKICAgICAgICAvLyBkZXRlcm1pbmluZyBpZiB0aGVyZSAqd291bGQgYmUqIGEgY2hhbmdlLgogICAgICAgIGNoYW5nZWRBdHRyaWJ1dGVzOiBmdW5jdGlvbiAoZGlmZikgewogICAgICAgICAgICBpZiAoIWRpZmYpIHJldHVybiB0aGlzLmhhc0NoYW5nZWQoKSA/IF8uY2xvbmUodGhpcy5jaGFuZ2VkKSA6IGZhbHNlOwogICAgICAgICAgICB2YXIgdmFsLCBjaGFuZ2VkID0gZmFsc2U7CiAgICAgICAgICAgIHZhciBvbGQgPSB0aGlzLl9jaGFuZ2luZyA/IHRoaXMuX3ByZXZpb3VzQXR0cmlidXRlcyA6IHRoaXMuYXR0cmlidXRlczsKICAgICAgICAgICAgZm9yICh2YXIgYXR0ciBpbiBkaWZmKSB7CiAgICAgICAgICAgICAgICBpZiAoXy5pc0VxdWFsKG9sZFthdHRyXSwgKHZhbCA9IGRpZmZbYXR0cl0pKSkgY29udGludWU7CiAgICAgICAgICAgICAgICAoY2hhbmdlZCB8fCAoY2hhbmdlZCA9IHt9KSlbYXR0cl0gPSB2YWw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGNoYW5nZWQ7CiAgICAgICAgfSwKICAgIAogICAgICAgIC8vIEdldCB0aGUgcHJldmlvdXMgdmFsdWUgb2YgYW4gYXR0cmlidXRlLCByZWNvcmRlZCBhdCB0aGUgdGltZSB0aGUgbGFzdAogICAgICAgIC8vIGAiY2hhbmdlImAgZXZlbnQgd2FzIGZpcmVkLgogICAgICAgIHByZXZpb3VzOiBmdW5jdGlvbiAoYXR0cikgewogICAgICAgICAgICBpZiAoYXR0ciA9PSBudWxsIHx8ICF0aGlzLl9wcmV2aW91c0F0dHJpYnV0ZXMpIHJldHVybiBudWxsOwogICAgICAgICAgICByZXR1cm4gdGhpcy5fcHJldmlvdXNBdHRyaWJ1dGVzW2F0dHJdOwogICAgICAgIH0sCiAgICAKICAgICAgICAvLyBHZXQgYWxsIG9mIHRoZSBhdHRyaWJ1dGVzIG9mIHRoZSBTdGF0ZSBhdCB0aGUgdGltZSBvZiB0aGUgcHJldmlvdXMKICAgICAgICAvLyBgImNoYW5nZSJgIGV2ZW50LgogICAgICAgIHByZXZpb3VzQXR0cmlidXRlczogZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gXy5jbG9uZSh0aGlzLl9wcmV2aW91c0F0dHJpYnV0ZXMpOwogICAgICAgIH0sCiAgICAKICAgICAgICAvLyBDcmVhdGUgYSBuZXcgU3RhdGUgd2l0aCBpZGVudGljYWwgYXR0cmlidXRlcyB0byB0aGlzIG9uZS4KICAgICAgICBjbG9uZTogZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gbmV3IHRoaXMuY29uc3RydWN0b3IodGhpcy5hdHRyaWJ1dGVzKTsKICAgICAgICB9LAogICAgCiAgICAgICAgLy8gUnVuIHZhbGlkYXRpb24gYWdhaW5zdCB0aGUgbmV4dCBjb21wbGV0ZSBzZXQgb2YgU3RhdGUgYXR0cmlidXRlcywKICAgICAgICAvLyByZXR1cm5pbmcgYHRydWVgIGlmIGFsbCBpcyB3ZWxsLiBPdGhlcndpc2UsIGZpcmUgYW4gYCJpbnZhbGlkImAgZXZlbnQuCiAgICAgICAgX3ZhbGlkYXRlOiBmdW5jdGlvbiAoYXR0cnMsIG9wdGlvbnMpIHsKICAgICAgICAgICAgaWYgKCFvcHRpb25zLnZhbGlkYXRlIHx8ICF0aGlzLnZhbGlkYXRlKSByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgYXR0cnMgPSBfLmV4dGVuZCh7fSwgdGhpcy5hdHRyaWJ1dGVzLCBhdHRycyk7CiAgICAgICAgICAgIHZhciBlcnJvciA9IHRoaXMudmFsaWRhdGlvbkVycm9yID0gdGhpcy52YWxpZGF0ZShhdHRycywgb3B0aW9ucykgfHwgbnVsbDsKICAgICAgICAgICAgaWYgKCFlcnJvcikgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIHRoaXMudHJpZ2dlcignaW52YWxpZCcsIHRoaXMsIGVycm9yLCBfLmV4dGVuZChvcHRpb25zIHx8IHt9LCB7dmFsaWRhdGlvbkVycm9yOiBlcnJvcn0pKTsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0sCiAgICAKICAgICAgICAvLyAqKnBhcnNlKiogY29udmVydHMgYSByZXNwb25zZSBpbnRvIHRoZSBoYXNoIG9mIGF0dHJpYnV0ZXMgdG8gYmUgYHNldGAgb24KICAgICAgICAvLyB0aGUgbW9kZWwuIFRoZSBkZWZhdWx0IGltcGxlbWVudGF0aW9uIGlzIGp1c3QgdG8gcGFzcyB0aGUgcmVzcG9uc2UgYWxvbmcuCiAgICAgICAgcGFyc2U6IGZ1bmN0aW9uIChyZXNwLCBvcHRpb25zKSB7CiAgICAgICAgICAgIHJldHVybiByZXNwOwogICAgICAgIH0sCiAgICAKICAgICAgICAvLyBBIG1vZGVsIGlzIG5ldyBpZiBpdCBoYXMgbmV2ZXIgYmVlbiBzYXZlZCB0byB0aGUgc2VydmVyLCBhbmQgbGFja3MgYW4gaWQuCiAgICAgICAgaXNOZXc6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuaWQgPT0gbnVsbDsKICAgICAgICB9LAogICAgCiAgICAgICAgLy8gQ2hlY2sgaWYgdGhlIG1vZGVsIGlzIGN1cnJlbnRseSBpbiBhIHZhbGlkIHN0YXRlLgogICAgICAgIGlzVmFsaWQ6IGZ1bmN0aW9uIChvcHRpb25zKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl92YWxpZGF0ZSh7fSwgXy5leHRlbmQob3B0aW9ucyB8fCB7fSwgeyB2YWxpZGF0ZTogdHJ1ZSB9KSk7CiAgICAgICAgfQogICAgfSk7CiAgICAKICAgIF8uZXh0ZW5kKFN0YXRlLnByb3RvdHlwZSwgRXZlbnRzKTsKICAgIAogICAgLy8gVW5kZXJzY29yZSBtZXRob2RzIHRoYXQgd2Ugd2FudCB0byBpbXBsZW1lbnQgb24gdGhlIFN0YXRlLgogICAgdmFyIHN0YXRlTWV0aG9kcyA9IFsna2V5cycsICd2YWx1ZXMnLCAncGFpcnMnLCAnaW52ZXJ0JywgJ3BpY2snLCAnb21pdCddOwogICAgCiAgICAvLyBNaXggaW4gZWFjaCBVbmRlcnNjb3JlIG1ldGhvZCBhcyBhIHByb3h5IHRvIGBTdGF0ZSNhdHRyaWJ1dGVzYC4KICAgIF8uZWFjaChzdGF0ZU1ldGhvZHMsIGZ1bmN0aW9uIChtZXRob2QpIHsKICAgICAgICBTdGF0ZS5wcm90b3R5cGVbbWV0aG9kXSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cyk7CiAgICAgICAgICAgIGFyZ3MudW5zaGlmdCh0aGlzLmF0dHJpYnV0ZXMpOwogICAgICAgICAgICByZXR1cm4gX1ttZXRob2RdLmFwcGx5KF8sIGFyZ3MpOwogICAgICAgIH07CiAgICB9KTsKCiAgICAvLyBIYWNrYm9uZS5Db2xsZWN0aW9uCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAKICAgIC8vIElmIG1vZGVscyB0ZW5kIHRvIHJlcHJlc2VudCBhIHNpbmdsZSByb3cgb2YgZGF0YSwgYSBIYWNrYm9uZSBDb2xsZWN0aW9uIGlzCiAgICAvLyBtb3JlIGFuYWxhZ291cyB0byBhIHRhYmxlIGZ1bGwgb2YgZGF0YSAuLi4gb3IgYSBzbWFsbCBzbGljZSBvciBwYWdlIG9mIHRoYXQKICAgIC8vIHRhYmxlLCBvciBhIGNvbGxlY3Rpb24gb2Ygcm93cyB0aGF0IGJlbG9uZyB0b2dldGhlciBmb3IgYSBwYXJ0aWN1bGFyIHJlYXNvbgogICAgLy8gLS0gYWxsIG9mIHRoZSBtZXNzYWdlcyBpbiB0aGlzIHBhcnRpY3VsYXIgZm9sZGVyLCBhbGwgb2YgdGhlIGRvY3VtZW50cwogICAgLy8gYmVsb25naW5nIHRvIHRoaXMgcGFydGljdWxhciBhdXRob3IsIGFuZCBzbyBvbi4gQ29sbGVjdGlvbnMgbWFpbnRhaW4KICAgIC8vIGluZGV4ZXMgb2YgdGhlaXIgbW9kZWxzLCBib3RoIGluIG9yZGVyLCBhbmQgZm9yIGxvb2t1cCBieSBgaWRgLgogICAgCiAgICAvLyBDcmVhdGUgYSBuZXcgKipDb2xsZWN0aW9uKiosIHBlcmhhcHMgdG8gY29udGFpbiBhIHNwZWNpZmljIHR5cGUgb2YgYG1vZGVsYC4KICAgIC8vIElmIGEgYGNvbXBhcmF0b3JgIGlzIHNwZWNpZmllZCwgdGhlIENvbGxlY3Rpb24gd2lsbCBtYWludGFpbgogICAgLy8gaXRzIG1vZGVscyBpbiBzb3J0IG9yZGVyLCBhcyB0aGV5J3JlIGFkZGVkIGFuZCByZW1vdmVkLgogICAgLy8gRGVmYXVsdCBvcHRpb25zIGZvciBgQ29sbGVjdGlvbiNzZXRgLgogICAgdmFyIHNldE9wdGlvbnMgPSB7YWRkOiB0cnVlLCByZW1vdmU6IHRydWUsIG1lcmdlOiB0cnVlfTsKICAgIHZhciBhZGRPcHRpb25zID0ge2FkZDogdHJ1ZSwgcmVtb3ZlOiBmYWxzZX07CiAgICAKICAgIC8vIERlZmluZSB0aGUgQ29sbGVjdGlvbidzIGluaGVyaXRhYmxlIG1ldGhvZHMuCiAgICB2YXIgQ29sbGVjdGlvbiA9IEhhY2tib25lLkNvbGxlY3Rpb24gPSBDb21wb25lbnQuZXh0ZW5kKHsKICAgICAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24gKG1vZGVscywgb3B0aW9ucykgewogICAgICAgICAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwogICAgICAgICAgICBpZiAob3B0aW9ucy5tb2RlbCkgdGhpcy5tb2RlbCA9IG9wdGlvbnMubW9kZWw7CiAgICAgICAgICAgIGlmIChvcHRpb25zLmNvbXBhcmF0b3IgIT09IHZvaWQgMCkgdGhpcy5jb21wYXJhdG9yID0gb3B0aW9ucy5jb21wYXJhdG9yOwogICAgICAgICAgICB0aGlzLl9yZXNldCgpOwogICAgICAgICAgICB0aGlzLmluaXRpYWxpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgICAgaWYgKG1vZGVscykgdGhpcy5yZXNldChtb2RlbHMsIF8uZXh0ZW5kKHtzaWxlbnQ6IHRydWV9LCBvcHRpb25zKSk7CiAgICAgICAgfSwKICAgIAogICAgICAgIC8vIFRoZSBkZWZhdWx0IG1vZGVsIGZvciBhIGNvbGxlY3Rpb24gaXMganVzdCBhICoqSGFja2JvbmUuU3RhdGUqKi4KICAgICAgICAvLyBUaGlzIHNob3VsZCBiZSBvdmVycmlkZGVuIGluIG1vc3QgY2FzZXMuCiAgICAgICAgbW9kZWw6IFN0YXRlLAogICAgCiAgICAgICAgLy8gVGhlIEpTT04gcmVwcmVzZW50YXRpb24gb2YgYSBDb2xsZWN0aW9uIGlzIGFuIGFycmF5IG9mIHRoZQogICAgICAgIC8vIG1vZGVscycgYXR0cmlidXRlcy4KICAgICAgICB0b0pTT046IGZ1bmN0aW9uIChvcHRpb25zKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLm1hcChmdW5jdGlvbiAobW9kZWwpIHsKICAgICAgICAgICAgICAgIHJldHVybiBtb2RlbC50b0pTT04ob3B0aW9ucyk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCiAgICAKICAgICAgICAvLyBQcm94eSBgSGFja2JvbmUuc3luY2AgYnkgZGVmYXVsdC4KICAgICAgICBzeW5jOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiBIYWNrYm9uZS5zeW5jLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgfSwKICAgIAogICAgICAgIC8vIEFkZCBhIG1vZGVsLCBvciBsaXN0IG9mIG1vZGVscyB0byB0aGUgc2V0LgogICAgICAgIGFkZDogZnVuY3Rpb24gKG1vZGVscywgb3B0aW9ucykgewogICAgICAgICAgICByZXR1cm4gdGhpcy5zZXQobW9kZWxzLCBfLmV4dGVuZCh7bWVyZ2U6IGZhbHNlfSwgb3B0aW9ucywgYWRkT3B0aW9ucykpOwogICAgICAgIH0sCiAgICAKICAgICAgICAvLyBSZW1vdmUgYSBtb2RlbCwgb3IgYSBsaXN0IG9mIG1vZGVscyBmcm9tIHRoZSBzZXQuCiAgICAgICAgcmVtb3ZlOiBmdW5jdGlvbiAobW9kZWxzLCBvcHRpb25zKSB7CiAgICAgICAgICAgIG1vZGVscyA9IF8uaXNBcnJheShtb2RlbHMpID8gbW9kZWxzLnNsaWNlKCkgOiBbbW9kZWxzXTsKICAgICAgICAgICAgb3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KTsKICAgICAgICAgICAgdmFyIGksIGwsIGluZGV4LCBtb2RlbDsKICAgICAgICAgICAgZm9yIChpID0gMCwgbCA9IG1vZGVscy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgICAgICAgIG1vZGVsID0gdGhpcy5nZXQobW9kZWxzW2ldKTsKICAgICAgICAgICAgICAgIGlmICghbW9kZWwpIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgZGVsZXRlIHRoaXMuX2J5SWRbbW9kZWwuaWRdOwogICAgICAgICAgICAgICAgZGVsZXRlIHRoaXMuX2J5SWRbbW9kZWwuY2lkXTsKICAgICAgICAgICAgICAgIGluZGV4ID0gdGhpcy5pbmRleE9mKG1vZGVsKTsKICAgICAgICAgICAgICAgIHRoaXMubW9kZWxzLnNwbGljZShpbmRleCwgMSk7CiAgICAgICAgICAgICAgICB0aGlzLmxlbmd0aC0tOwogICAgICAgICAgICAgICAgaWYgKCFvcHRpb25zLnNpbGVudCkgewogICAgICAgICAgICAgICAgICAgIG9wdGlvbnMuaW5kZXggPSBpbmRleDsKICAgICAgICAgICAgICAgICAgICBtb2RlbC50cmlnZ2VyKCdyZW1vdmUnLCBtb2RlbCwgdGhpcywgb3B0aW9ucyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLl9yZW1vdmVSZWZlcmVuY2UobW9kZWwpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCiAgICAKICAgICAgICAvLyBSZW1vdmVzIGFsbCBtb2RlbHMgZnJvbSB0aGUgY29sbGVjdGlvbgogICAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uIChvcHRpb25zKSB7CiAgICAgICAgICAgIHZhciBtb2RlbHMgPSB0aGlzLm1vZGVsczsKICAgICAgICAgICAgcmV0dXJuIHRoaXMucmVtb3ZlKG1vZGVscywgb3B0aW9ucyk7CiAgICAgICAgfSwKICAgIAogICAgICAgIC8vIFVwZGF0ZSBhIGNvbGxlY3Rpb24gYnkgYHNldGAtaW5nIGEgbmV3IGxpc3Qgb2YgbW9kZWxzLCBhZGRpbmcgbmV3IG9uZXMsCiAgICAgICAgLy8gcmVtb3ZpbmcgbW9kZWxzIHRoYXQgYXJlIG5vIGxvbmdlciBwcmVzZW50LCBhbmQgbWVyZ2luZyBtb2RlbHMgdGhhdAogICAgICAgIC8vIGFscmVhZHkgZXhpc3QgaW4gdGhlIGNvbGxlY3Rpb24sIGFzIG5lY2Vzc2FyeS4gU2ltaWxhciB0byAqKlN0YXRlI3NldCoqLAogICAgICAgIC8vIHRoZSBjb3JlIG9wZXJhdGlvbiBmb3IgdXBkYXRpbmcgdGhlIGRhdGEgY29udGFpbmVkIGJ5IHRoZSBjb2xsZWN0aW9uLgogICAgICAgIHNldDogZnVuY3Rpb24gKG1vZGVscywgb3B0aW9ucykgewogICAgICAgICAgICBvcHRpb25zID0gXy5kZWZhdWx0cyh7fSwgb3B0aW9ucywgc2V0T3B0aW9ucyk7CiAgICAgICAgICAgIGlmIChvcHRpb25zLnBhcnNlKSBtb2RlbHMgPSB0aGlzLnBhcnNlKG1vZGVscywgb3B0aW9ucyk7CiAgICAgICAgICAgIGlmICghXy5pc0FycmF5KG1vZGVscykpIG1vZGVscyA9IG1vZGVscyA/IFttb2RlbHNdIDogW107CiAgICAgICAgICAgIHZhciBpLCBsLCBtb2RlbCwgYXR0cnMsIGV4aXN0aW5nLCBzb3J0OwogICAgICAgICAgICB2YXIgYXQgPSBvcHRpb25zLmF0OwogICAgICAgICAgICB2YXIgc29ydGFibGUgPSB0aGlzLmNvbXBhcmF0b3IgJiYgKGF0ID09IG51bGwpICYmIG9wdGlvbnMuc29ydCAhPT0gZmFsc2U7CiAgICAgICAgICAgIHZhciBzb3J0QXR0ciA9IF8uaXNTdHJpbmcodGhpcy5jb21wYXJhdG9yKSA/IHRoaXMuY29tcGFyYXRvciA6IG51bGw7CiAgICAgICAgICAgIHZhciB0b0FkZCA9IFtdLCB0b1JlbW92ZSA9IFtdLCBtb2RlbE1hcCA9IHt9OwogICAgICAgICAgICB2YXIgYWRkID0gb3B0aW9ucy5hZGQsIG1lcmdlID0gb3B0aW9ucy5tZXJnZSwgcmVtb3ZlID0gb3B0aW9ucy5yZW1vdmU7CiAgICAgICAgICAgIHZhciBvcmRlciA9ICFzb3J0YWJsZSAmJiBhZGQgJiYgcmVtb3ZlID8gW10gOiBmYWxzZTsKICAgIAogICAgICAgICAgICAvLyBUdXJuIGJhcmUgb2JqZWN0cyBpbnRvIG1vZGVsIHJlZmVyZW5jZXMsIGFuZCBwcmV2ZW50IGludmFsaWQgbW9kZWxzCiAgICAgICAgICAgIC8vIGZyb20gYmVpbmcgYWRkZWQuCiAgICAgICAgICAgIGZvciAoaSA9IDAsIGwgPSBtb2RlbHMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgICAgICAgICBpZiAoIShtb2RlbCA9IHRoaXMuX3ByZXBhcmVNb2RlbChhdHRycyA9IG1vZGVsc1tpXSwgb3B0aW9ucykpKSBjb250aW51ZTsKICAgIAogICAgICAgICAgICAgICAgLy8gSWYgYSBkdXBsaWNhdGUgaXMgZm91bmQsIHByZXZlbnQgaXQgZnJvbSBiZWluZyBhZGRlZCBhbmQKICAgICAgICAgICAgICAgIC8vIG9wdGlvbmFsbHkgbWVyZ2UgaXQgaW50byB0aGUgZXhpc3RpbmcgbW9kZWwuCiAgICAgICAgICAgICAgICBpZiAoZXhpc3RpbmcgPSB0aGlzLmdldChtb2RlbCkpIHsKICAgICAgICAgICAgICAgICAgICBpZiAocmVtb3ZlKSBtb2RlbE1hcFtleGlzdGluZy5jaWRdID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBpZiAobWVyZ2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYXR0cnMgPSBhdHRycyA9PT0gbW9kZWwgPyBtb2RlbC5hdHRyaWJ1dGVzIDogb3B0aW9ucy5fYXR0cnM7CiAgICAgICAgICAgICAgICAgICAgICAgIGV4aXN0aW5nLnNldChhdHRycywgb3B0aW9ucyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzb3J0YWJsZSAmJiAhc29ydCAmJiBleGlzdGluZy5oYXNDaGFuZ2VkKHNvcnRBdHRyKSkgc29ydCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgCiAgICAgICAgICAgICAgICAgICAgLy8gVGhpcyBpcyBhIG5ldyBtb2RlbCwgcHVzaCBpdCB0byB0aGUgYHRvQWRkYCBsaXN0LgogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChhZGQpIHsKICAgICAgICAgICAgICAgICAgICB0b0FkZC5wdXNoKG1vZGVsKTsKICAgIAogICAgICAgICAgICAgICAgICAgIC8vIExpc3RlbiB0byBhZGRlZCBtb2RlbHMnIGV2ZW50cywgYW5kIGluZGV4IG1vZGVscyBmb3IgbG9va3VwIGJ5CiAgICAgICAgICAgICAgICAgICAgLy8gYGlkYCBhbmQgYnkgYGNpZGAuCiAgICAgICAgICAgICAgICAgICAgbW9kZWwub24oJ2FsbCcsIHRoaXMuX29uTW9kZWxFdmVudCwgdGhpcyk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fYnlJZFttb2RlbC5jaWRdID0gbW9kZWw7CiAgICAgICAgICAgICAgICAgICAgaWYgKG1vZGVsLmlkICE9IG51bGwpIHRoaXMuX2J5SWRbbW9kZWwuaWRdID0gbW9kZWw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAob3JkZXIpIG9yZGVyLnB1c2goZXhpc3RpbmcgfHwgbW9kZWwpOwogICAgICAgICAgICAgICAgZGVsZXRlIG9wdGlvbnMuX2F0dHJzOwogICAgICAgICAgICB9CiAgICAKICAgICAgICAgICAgLy8gUmVtb3ZlIG5vbmV4aXN0ZW50IG1vZGVscyBpZiBhcHByb3ByaWF0ZS4KICAgICAgICAgICAgaWYgKHJlbW92ZSkgewogICAgICAgICAgICAgICAgZm9yIChpID0gMCwgbCA9IHRoaXMubGVuZ3RoOyBpIDwgbDsgKytpKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFtb2RlbE1hcFsobW9kZWwgPSB0aGlzLm1vZGVsc1tpXSkuY2lkXSkgdG9SZW1vdmUucHVzaChtb2RlbCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAodG9SZW1vdmUubGVuZ3RoKSB0aGlzLnJlbW92ZSh0b1JlbW92ZSwgb3B0aW9ucyk7CiAgICAgICAgICAgIH0KICAgIAogICAgICAgICAgICAvLyBTZWUgaWYgc29ydGluZyBpcyBuZWVkZWQsIHVwZGF0ZSBgbGVuZ3RoYCBhbmQgc3BsaWNlIGluIG5ldyBtb2RlbHMuCiAgICAgICAgICAgIGlmICh0b0FkZC5sZW5ndGggfHwgKG9yZGVyICYmIG9yZGVyLmxlbmd0aCkpIHsKICAgICAgICAgICAgICAgIGlmIChzb3J0YWJsZSkgc29ydCA9IHRydWU7CiAgICAgICAgICAgICAgICB0aGlzLmxlbmd0aCArPSB0b0FkZC5sZW5ndGg7CiAgICAgICAgICAgICAgICBpZiAoYXQgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHNwbGljZS5hcHBseSh0aGlzLm1vZGVscywgW2F0LCAwXS5jb25jYXQodG9BZGQpKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKG9yZGVyKSB0aGlzLm1vZGVscy5sZW5ndGggPSAwOwogICAgICAgICAgICAgICAgICAgIHB1c2guYXBwbHkodGhpcy5tb2RlbHMsIG9yZGVyIHx8IHRvQWRkKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgCiAgICAgICAgICAgIC8vIFNpbGVudGx5IHNvcnQgdGhlIGNvbGxlY3Rpb24gaWYgYXBwcm9wcmlhdGUuCiAgICAgICAgICAgIGlmIChzb3J0KSB0aGlzLnNvcnQoe3NpbGVudDogdHJ1ZX0pOwogICAgCiAgICAgICAgICAgIGlmIChvcHRpb25zLnNpbGVudCkgcmV0dXJuIHRoaXM7CiAgICAKICAgICAgICAgICAgLy8gVHJpZ2dlciBgYWRkYCBldmVudHMuCiAgICAgICAgICAgIGZvciAoaSA9IDAsIGwgPSB0b0FkZC5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgICAgICAgIChtb2RlbCA9IHRvQWRkW2ldKS50cmlnZ2VyKCdhZGQnLCBtb2RlbCwgdGhpcywgb3B0aW9ucyk7CiAgICAgICAgICAgIH0KICAgIAogICAgICAgICAgICAvLyBUcmlnZ2VyIGBzb3J0YCBpZiB0aGUgY29sbGVjdGlvbiB3YXMgc29ydGVkLgogICAgICAgICAgICBpZiAoc29ydCB8fCAob3JkZXIgJiYgb3JkZXIubGVuZ3RoKSkgdGhpcy50cmlnZ2VyKCdzb3J0JywgdGhpcywgb3B0aW9ucyk7CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCiAgICAKICAgICAgICAvLyBXaGVuIHlvdSBoYXZlIG1vcmUgaXRlbXMgdGhhbiB5b3Ugd2FudCB0byBhZGQgb3IgcmVtb3ZlIGluZGl2aWR1YWxseSwKICAgICAgICAvLyB5b3UgY2FuIHJlc2V0IHRoZSBlbnRpcmUgc2V0IHdpdGggYSBuZXcgbGlzdCBvZiBtb2RlbHMsIHdpdGhvdXQgZmlyaW5nCiAgICAgICAgLy8gYW55IGdyYW51bGFyIGBhZGRgIG9yIGByZW1vdmVgIGV2ZW50cy4gRmlyZXMgYHJlc2V0YCB3aGVuIGZpbmlzaGVkLgogICAgICAgIC8vIFVzZWZ1bCBmb3IgYnVsayBvcGVyYXRpb25zIGFuZCBvcHRpbWl6YXRpb25zLgogICAgICAgIHJlc2V0OiBmdW5jdGlvbiAobW9kZWxzLCBvcHRpb25zKSB7CiAgICAgICAgICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBsID0gdGhpcy5tb2RlbHMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9yZW1vdmVSZWZlcmVuY2UodGhpcy5tb2RlbHNbaV0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG9wdGlvbnMucHJldmlvdXNNb2RlbHMgPSB0aGlzLm1vZGVsczsKICAgICAgICAgICAgdGhpcy5fcmVzZXQoKTsKICAgICAgICAgICAgdGhpcy5hZGQobW9kZWxzLCBfLmV4dGVuZCh7c2lsZW50OiB0cnVlfSwgb3B0aW9ucykpOwogICAgICAgICAgICBpZiAoIW9wdGlvbnMuc2lsZW50KSB0aGlzLnRyaWdnZXIoJ3Jlc2V0JywgdGhpcywgb3B0aW9ucyk7CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCiAgICAKICAgICAgICAvLyBBZGQgYSBtb2RlbCB0byB0aGUgZW5kIG9mIHRoZSBjb2xsZWN0aW9uLgogICAgICAgIHB1c2g6IGZ1bmN0aW9uIChtb2RlbCwgb3B0aW9ucykgewogICAgICAgICAgICBtb2RlbCA9IHRoaXMuX3ByZXBhcmVNb2RlbChtb2RlbCwgb3B0aW9ucyk7CiAgICAgICAgICAgIHRoaXMuYWRkKG1vZGVsLCBfLmV4dGVuZCh7YXQ6IHRoaXMubGVuZ3RofSwgb3B0aW9ucykpOwogICAgICAgICAgICByZXR1cm4gbW9kZWw7CiAgICAgICAgfSwKICAgIAogICAgICAgIC8vIFJlbW92ZSBhIG1vZGVsIGZyb20gdGhlIGVuZCBvZiB0aGUgY29sbGVjdGlvbi4KICAgICAgICBwb3A6IGZ1bmN0aW9uIChvcHRpb25zKSB7CiAgICAgICAgICAgIHZhciBtb2RlbCA9IHRoaXMuYXQodGhpcy5sZW5ndGggLSAxKTsKICAgICAgICAgICAgdGhpcy5yZW1vdmUobW9kZWwsIG9wdGlvbnMpOwogICAgICAgICAgICByZXR1cm4gbW9kZWw7CiAgICAgICAgfSwKICAgIAogICAgICAgIC8vIEFkZCBhIG1vZGVsIHRvIHRoZSBiZWdpbm5pbmcgb2YgdGhlIGNvbGxlY3Rpb24uCiAgICAgICAgdW5zaGlmdDogZnVuY3Rpb24gKG1vZGVsLCBvcHRpb25zKSB7CiAgICAgICAgICAgIG1vZGVsID0gdGhpcy5fcHJlcGFyZU1vZGVsKG1vZGVsLCBvcHRpb25zKTsKICAgICAgICAgICAgdGhpcy5hZGQobW9kZWwsIF8uZXh0ZW5kKHthdDogMH0sIG9wdGlvbnMpKTsKICAgICAgICAgICAgcmV0dXJuIG1vZGVsOwogICAgICAgIH0sCiAgICAKICAgICAgICAvLyBSZW1vdmUgYSBtb2RlbCBmcm9tIHRoZSBiZWdpbm5pbmcgb2YgdGhlIGNvbGxlY3Rpb24uCiAgICAgICAgc2hpZnQ6IGZ1bmN0aW9uIChvcHRpb25zKSB7CiAgICAgICAgICAgIHZhciBtb2RlbCA9IHRoaXMuYXQoMCk7CiAgICAgICAgICAgIHRoaXMucmVtb3ZlKG1vZGVsLCBvcHRpb25zKTsKICAgICAgICAgICAgcmV0dXJuIG1vZGVsOwogICAgICAgIH0sCiAgICAKICAgICAgICAvLyBTbGljZSBvdXQgYSBzdWItYXJyYXkgb2YgbW9kZWxzIGZyb20gdGhlIGNvbGxlY3Rpb24uCiAgICAgICAgc2xpY2U6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIHNsaWNlLmFwcGx5KHRoaXMubW9kZWxzLCBhcmd1bWVudHMpOwogICAgICAgIH0sCiAgICAKICAgICAgICAvLyBHZXQgYSBtb2RlbCBmcm9tIHRoZSBzZXQgYnkgaWQuCiAgICAgICAgZ2V0OiBmdW5jdGlvbiAob2JqKSB7CiAgICAgICAgICAgIGlmIChvYmogPT0gbnVsbCkgcmV0dXJuIHZvaWQgMDsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2J5SWRbb2JqLmlkXSB8fCB0aGlzLl9ieUlkW29iai5jaWRdIHx8IHRoaXMuX2J5SWRbb2JqXTsKICAgICAgICB9LAogICAgCiAgICAgICAgLy8gR2V0IHRoZSBtb2RlbCBhdCB0aGUgZ2l2ZW4gaW5kZXguCiAgICAgICAgYXQ6IGZ1bmN0aW9uIChpbmRleCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5tb2RlbHNbaW5kZXhdOwogICAgICAgIH0sCiAgICAKICAgICAgICAvLyBSZXR1cm4gbW9kZWxzIHdpdGggbWF0Y2hpbmcgYXR0cmlidXRlcy4gVXNlZnVsIGZvciBzaW1wbGUgY2FzZXMgb2YKICAgICAgICAvLyBgZmlsdGVyYC4KICAgICAgICB3aGVyZTogZnVuY3Rpb24gKGF0dHJzLCBmaXJzdCkgewogICAgICAgICAgICBpZiAoXy5pc0VtcHR5KGF0dHJzKSkgcmV0dXJuIGZpcnN0ID8gdm9pZCAwIDogW107CiAgICAgICAgICAgIHJldHVybiB0aGlzW2ZpcnN0ID8gJ2ZpbmQnIDogJ2ZpbHRlciddKGZ1bmN0aW9uIChtb2RlbCkgewogICAgICAgICAgICAgICAgZm9yICh2YXIga2V5IGluIGF0dHJzKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGF0dHJzLmhhc093blByb3BlcnR5KGtleSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGF0dHJzW2tleV0gIT09IG1vZGVsLmdldChrZXkpKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCiAgICAKICAgICAgICAvLyBSZXR1cm4gdGhlIGZpcnN0IG1vZGVsIHdpdGggbWF0Y2hpbmcgYXR0cmlidXRlcy4gVXNlZnVsIGZvciBzaW1wbGUgY2FzZXMKICAgICAgICAvLyBvZiBgZmluZGAuCiAgICAgICAgZmluZFdoZXJlOiBmdW5jdGlvbiAoYXR0cnMpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMud2hlcmUoYXR0cnMsIHRydWUpOwogICAgICAgIH0sCiAgICAKICAgICAgICAvLyBGb3JjZSB0aGUgY29sbGVjdGlvbiB0byByZS1zb3J0IGl0c2VsZi4gWW91IGRvbid0IG5lZWQgdG8gY2FsbCB0aGlzIHVuZGVyCiAgICAgICAgLy8gbm9ybWFsIGNpcmN1bXN0YW5jZXMsIGFzIHRoZSBzZXQgd2lsbCBtYWludGFpbiBzb3J0IG9yZGVyIGFzIGVhY2ggaXRlbQogICAgICAgIC8vIGlzIGFkZGVkLgogICAgICAgIHNvcnQ6IGZ1bmN0aW9uIChvcHRpb25zKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5jb21wYXJhdG9yKSB0aHJvdyBuZXcgRXJyb3IoJ0Nhbm5vdCBzb3J0IGEgc2V0IHdpdGhvdXQgYSBjb21wYXJhdG9yJyk7CiAgICAgICAgICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CiAgICAKICAgICAgICAgICAgLy8gUnVuIHNvcnQgYmFzZWQgb24gdHlwZSBvZiBgY29tcGFyYXRvcmAuCiAgICAgICAgICAgIGlmIChfLmlzU3RyaW5nKHRoaXMuY29tcGFyYXRvcikgfHwgdGhpcy5jb21wYXJhdG9yLmxlbmd0aCA9PT0gMSkgewogICAgICAgICAgICAgICAgdGhpcy5tb2RlbHMgPSB0aGlzLnNvcnRCeSh0aGlzLmNvbXBhcmF0b3IsIHRoaXMpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5tb2RlbHMuc29ydChfLmJpbmQodGhpcy5jb21wYXJhdG9yLCB0aGlzKSk7CiAgICAgICAgICAgIH0KICAgIAogICAgICAgICAgICBpZiAoIW9wdGlvbnMuc2lsZW50KSB0aGlzLnRyaWdnZXIoJ3NvcnQnLCB0aGlzLCBvcHRpb25zKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSwKICAgIAogICAgICAgIC8vIEZpZ3VyZSBvdXQgdGhlIHNtYWxsZXN0IGluZGV4IGF0IHdoaWNoIGEgbW9kZWwgc2hvdWxkIGJlIGluc2VydGVkIHNvIGFzCiAgICAgICAgLy8gdG8gbWFpbnRhaW4gb3JkZXIuCiAgICAgICAgc29ydGVkSW5kZXg6IGZ1bmN0aW9uIChtb2RlbCwgdmFsdWUsIGNvbnRleHQpIHsKICAgICAgICAgICAgdmFsdWUgfHwgKHZhbHVlID0gdGhpcy5jb21wYXJhdG9yKTsKICAgICAgICAgICAgdmFyIGl0ZXJhdG9yID0gXy5pc0Z1bmN0aW9uKHZhbHVlKSA/IHZhbHVlIDogZnVuY3Rpb24gKG1vZGVsKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbW9kZWwuZ2V0KHZhbHVlKTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgcmV0dXJuIF8uc29ydGVkSW5kZXgodGhpcy5tb2RlbHMsIG1vZGVsLCBpdGVyYXRvciwgY29udGV4dCk7CiAgICAgICAgfSwKICAgIAogICAgICAgIC8vIFBsdWNrIGFuIGF0dHJpYnV0ZSBmcm9tIGVhY2ggbW9kZWwgaW4gdGhlIGNvbGxlY3Rpb24uCiAgICAgICAgcGx1Y2s6IGZ1bmN0aW9uIChhdHRyKSB7CiAgICAgICAgICAgIHJldHVybiBfLmludm9rZSh0aGlzLm1vZGVscywgJ2dldCcsIGF0dHIpOwogICAgICAgIH0sCiAgICAKICAgICAgICAvLyBGZXRjaCB0aGUgZGVmYXVsdCBzZXQgb2YgbW9kZWxzIGZvciB0aGlzIGNvbGxlY3Rpb24sIHJlc2V0dGluZyB0aGUKICAgICAgICAvLyBjb2xsZWN0aW9uIHdoZW4gdGhleSBhcnJpdmUuIElmIGByZXNldDogdHJ1ZWAgaXMgcGFzc2VkLCB0aGUgcmVzcG9uc2UKICAgICAgICAvLyBkYXRhIHdpbGwgYmUgcGFzc2VkIHRocm91Z2ggdGhlIGByZXNldGAgbWV0aG9kIGluc3RlYWQgb2YgYHNldGAuCiAgICAgICAgZmV0Y2g6IGZ1bmN0aW9uIChvcHRpb25zKSB7CiAgICAgICAgICAgIG9wdGlvbnMgPSBvcHRpb25zID8gXy5jbG9uZShvcHRpb25zKSA6IHt9OwogICAgICAgICAgICBpZiAob3B0aW9ucy5wYXJzZSA9PT0gdm9pZCAwKSBvcHRpb25zLnBhcnNlID0gdHJ1ZTsKICAgICAgICAgICAgdmFyIHN1Y2Nlc3MgPSBvcHRpb25zLnN1Y2Nlc3M7CiAgICAgICAgICAgIHZhciBjb2xsZWN0aW9uID0gdGhpczsKICAgICAgICAgICAgb3B0aW9ucy5zdWNjZXNzID0gZnVuY3Rpb24gKHJlc3ApIHsKICAgICAgICAgICAgICAgIHZhciBtZXRob2QgPSBvcHRpb25zLnJlc2V0ID8gJ3Jlc2V0JyA6ICdzZXQnOwogICAgICAgICAgICAgICAgY29sbGVjdGlvblttZXRob2RdKHJlc3AsIG9wdGlvbnMpOwogICAgICAgICAgICAgICAgaWYgKHN1Y2Nlc3MpIHN1Y2Nlc3MoY29sbGVjdGlvbiwgcmVzcCwgb3B0aW9ucyk7CiAgICAgICAgICAgICAgICBjb2xsZWN0aW9uLnRyaWdnZXIoJ3N5bmMnLCBjb2xsZWN0aW9uLCByZXNwLCBvcHRpb25zKTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgd3JhcEVycm9yKHRoaXMsIG9wdGlvbnMpOwogICAgICAgICAgICByZXR1cm4gdGhpcy5zeW5jKCdyZWFkJywgdGhpcywgb3B0aW9ucyk7CiAgICAgICAgfSwKICAgIAogICAgICAgIC8vIENyZWF0ZSBhIG5ldyBpbnN0YW5jZSBvZiBhIG1vZGVsIGluIHRoaXMgY29sbGVjdGlvbi4gQWRkIHRoZSBtb2RlbCB0byB0aGUKICAgICAgICAvLyBjb2xsZWN0aW9uIGltbWVkaWF0ZWx5LCB1bmxlc3MgYHdhaXQ6IHRydWVgIGlzIHBhc3NlZCwgaW4gd2hpY2ggY2FzZSB3ZQogICAgICAgIC8vIHdhaXQgZm9yIHRoZSBzZXJ2ZXIgdG8gYWdyZWUuCiAgICAgICAgY3JlYXRlOiBmdW5jdGlvbiAobW9kZWwsIG9wdGlvbnMpIHsKICAgICAgICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgPyBfLmNsb25lKG9wdGlvbnMpIDoge307CiAgICAgICAgICAgIGlmICghKG1vZGVsID0gdGhpcy5fcHJlcGFyZU1vZGVsKG1vZGVsLCBvcHRpb25zKSkpIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgaWYgKCFvcHRpb25zLndhaXQpIHRoaXMuYWRkKG1vZGVsLCBvcHRpb25zKTsKICAgICAgICAgICAgdmFyIGNvbGxlY3Rpb24gPSB0aGlzOwogICAgICAgICAgICB2YXIgc3VjY2VzcyA9IG9wdGlvbnMuc3VjY2VzczsKICAgICAgICAgICAgb3B0aW9ucy5zdWNjZXNzID0gZnVuY3Rpb24gKG1vZGVsLCByZXNwLCBvcHRpb25zKSB7CiAgICAgICAgICAgICAgICBpZiAob3B0aW9ucy53YWl0KSBjb2xsZWN0aW9uLmFkZChtb2RlbCwgb3B0aW9ucyk7CiAgICAgICAgICAgICAgICBpZiAoc3VjY2Vzcykgc3VjY2Vzcyhtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIG1vZGVsIGluc3RhbmNlb2YgTW9kZWwgJiYgbW9kZWwuc2F2ZShudWxsLCBvcHRpb25zKTsKICAgICAgICAgICAgcmV0dXJuIG1vZGVsOwogICAgICAgIH0sCiAgICAKICAgICAgICAvLyAqKnBhcnNlKiogY29udmVydHMgYSByZXNwb25zZSBpbnRvIGEgbGlzdCBvZiBtb2RlbHMgdG8gYmUgYWRkZWQgdG8gdGhlCiAgICAgICAgLy8gY29sbGVjdGlvbi4gVGhlIGRlZmF1bHQgaW1wbGVtZW50YXRpb24gaXMganVzdCB0byBwYXNzIGl0IHRocm91Z2guCiAgICAgICAgcGFyc2U6IGZ1bmN0aW9uIChyZXNwLCBvcHRpb25zKSB7CiAgICAgICAgICAgIHJldHVybiByZXNwOwogICAgICAgIH0sCiAgICAKICAgICAgICAvLyBDcmVhdGUgYSBuZXcgY29sbGVjdGlvbiB3aXRoIGFuIGlkZW50aWNhbCBsaXN0IG9mIG1vZGVscyBhcyB0aGlzIG9uZS4KICAgICAgICBjbG9uZTogZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gbmV3IHRoaXMuY29uc3RydWN0b3IodGhpcy5tb2RlbHMpOwogICAgICAgIH0sCiAgICAKICAgICAgICAvLyBQcml2YXRlIG1ldGhvZCB0byByZXNldCBhbGwgaW50ZXJuYWwgc3RhdGUuIENhbGxlZCB3aGVuIHRoZSBjb2xsZWN0aW9uCiAgICAgICAgLy8gaXMgZmlyc3QgaW5pdGlhbGl6ZWQgb3IgcmVzZXQuCiAgICAgICAgX3Jlc2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHRoaXMubGVuZ3RoID0gMDsKICAgICAgICAgICAgdGhpcy5tb2RlbHMgPSBbXTsKICAgICAgICAgICAgdGhpcy5fYnlJZCA9IHt9OwogICAgICAgIH0sCiAgICAKICAgICAgICAvLyBQcmVwYXJlIGEgaGFzaCBvZiBhdHRyaWJ1dGVzIChvciBvdGhlciBtb2RlbCkgdG8gYmUgYWRkZWQgdG8gdGhpcwogICAgICAgIC8vIGNvbGxlY3Rpb24uCiAgICAgICAgX3ByZXBhcmVNb2RlbDogZnVuY3Rpb24gKGF0dHJzLCBvcHRpb25zKSB7CiAgICAgICAgICAgIGlmIChhdHRycyBpbnN0YW5jZW9mIFN0YXRlKSB7CiAgICAgICAgICAgICAgICBpZiAoIWF0dHJzLmNvbGxlY3Rpb24pIGF0dHJzLmNvbGxlY3Rpb24gPSB0aGlzOwogICAgICAgICAgICAgICAgcmV0dXJuIGF0dHJzOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CiAgICAgICAgICAgIG9wdGlvbnMuY29sbGVjdGlvbiA9IHRoaXM7CiAgICAgICAgICAgIHZhciBtb2RlbCA9IG5ldyB0aGlzLm1vZGVsKGF0dHJzLCBvcHRpb25zKTsKICAgICAgICAgICAgaWYgKCFtb2RlbC52YWxpZGF0aW9uRXJyb3IpIHJldHVybiBtb2RlbDsKICAgICAgICAgICAgdGhpcy50cmlnZ2VyKCdpbnZhbGlkJywgdGhpcywgYXR0cnMsIG9wdGlvbnMpOwogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfSwKICAgIAogICAgICAgIC8vIEludGVybmFsIG1ldGhvZCB0byBzZXZlciBhIG1vZGVsJ3MgdGllcyB0byBhIGNvbGxlY3Rpb24uCiAgICAgICAgX3JlbW92ZVJlZmVyZW5jZTogZnVuY3Rpb24gKG1vZGVsKSB7CiAgICAgICAgICAgIGlmICh0aGlzID09PSBtb2RlbC5jb2xsZWN0aW9uKSBkZWxldGUgbW9kZWwuY29sbGVjdGlvbjsKICAgICAgICAgICAgbW9kZWwub2ZmKCdhbGwnLCB0aGlzLl9vbk1vZGVsRXZlbnQsIHRoaXMpOwogICAgICAgIH0sCiAgICAKICAgICAgICAvLyBJbnRlcm5hbCBtZXRob2QgY2FsbGVkIGV2ZXJ5IHRpbWUgYSBtb2RlbCBpbiB0aGUgc2V0IGZpcmVzIGFuIGV2ZW50LgogICAgICAgIC8vIFNldHMgbmVlZCB0byB1cGRhdGUgdGhlaXIgaW5kZXhlcyB3aGVuIG1vZGVscyBjaGFuZ2UgaWRzLiBBbGwgb3RoZXIKICAgICAgICAvLyBldmVudHMgc2ltcGx5IHByb3h5IHRocm91Z2guICJhZGQiIGFuZCAicmVtb3ZlIiBldmVudHMgdGhhdCBvcmlnaW5hdGUKICAgICAgICAvLyBpbiBvdGhlciBjb2xsZWN0aW9ucyBhcmUgaWdub3JlZC4KICAgICAgICBfb25Nb2RlbEV2ZW50OiBmdW5jdGlvbiAoZXZlbnQsIG1vZGVsLCBjb2xsZWN0aW9uLCBvcHRpb25zKSB7CiAgICAgICAgICAgIGlmICgoZXZlbnQgPT09ICdhZGQnIHx8IGV2ZW50ID09PSAncmVtb3ZlJykgJiYgY29sbGVjdGlvbiAhPT0gdGhpcykgcmV0dXJuOwogICAgICAgICAgICBpZiAoZXZlbnQgPT09ICdkZXN0cm95JykgdGhpcy5yZW1vdmUobW9kZWwsIG9wdGlvbnMpOwogICAgICAgICAgICBpZiAobW9kZWwgJiYgZXZlbnQgPT09ICdjaGFuZ2U6JyArIG1vZGVsLmlkQXR0cmlidXRlKSB7CiAgICAgICAgICAgICAgICBkZWxldGUgdGhpcy5fYnlJZFttb2RlbC5wcmV2aW91cyhtb2RlbC5pZEF0dHJpYnV0ZSldOwogICAgICAgICAgICAgICAgaWYgKG1vZGVsLmlkICE9IG51bGwpIHRoaXMuX2J5SWRbbW9kZWwuaWRdID0gbW9kZWw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy50cmlnZ2VyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgfQogICAgCiAgICB9LCBFdmVudHMpOwogICAgCiAgICBfLmV4dGVuZChDb2xsZWN0aW9uLnByb3RvdHlwZSwgRXZlbnRzKTsKICAgIAogICAgLy8gVW5kZXJzY29yZSBtZXRob2RzIHRoYXQgd2Ugd2FudCB0byBpbXBsZW1lbnQgb24gdGhlIENvbGxlY3Rpb24uCiAgICAvLyA5MCUgb2YgdGhlIGNvcmUgdXNlZnVsbmVzcyBvZiBIYWNrYm9uZSBDb2xsZWN0aW9ucyBpcyBhY3R1YWxseSBpbXBsZW1lbnRlZAogICAgLy8gcmlnaHQgaGVyZToKICAgIHZhciBtZXRob2RzID0gWydmb3JFYWNoJywgJ2VhY2gnLCAnbWFwJywgJ2NvbGxlY3QnLCAncmVkdWNlJywgJ2ZvbGRsJywKICAgICAgICAnaW5qZWN0JywgJ3JlZHVjZVJpZ2h0JywgJ2ZvbGRyJywgJ2ZpbmQnLCAnZGV0ZWN0JywgJ2ZpbHRlcicsICdzZWxlY3QnLAogICAgICAgICdyZWplY3QnLCAnZXZlcnknLCAnYWxsJywgJ3NvbWUnLCAnYW55JywgJ2luY2x1ZGUnLCAnY29udGFpbnMnLCAnaW52b2tlJywKICAgICAgICAnbWF4JywgJ21pbicsICd0b0FycmF5JywgJ3NpemUnLCAnZmlyc3QnLCAnaGVhZCcsICd0YWtlJywgJ2luaXRpYWwnLCAncmVzdCcsCiAgICAgICAgJ3RhaWwnLCAnZHJvcCcsICdsYXN0JywgJ3dpdGhvdXQnLCAnZGlmZmVyZW5jZScsICdpbmRleE9mJywgJ3NodWZmbGUnLAogICAgICAgICdsYXN0SW5kZXhPZicsICdpc0VtcHR5JywgJ2NoYWluJ107CiAgICAKICAgIC8vIE1peCBpbiBlYWNoIFVuZGVyc2NvcmUgbWV0aG9kIGFzIGEgcHJveHkgdG8gYENvbGxlY3Rpb24jbW9kZWxzYC4KICAgIF8uZWFjaChtZXRob2RzLCBmdW5jdGlvbiAobWV0aG9kKSB7CiAgICAgICAgQ29sbGVjdGlvbi5wcm90b3R5cGVbbWV0aG9kXSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cyk7CiAgICAgICAgICAgIGFyZ3MudW5zaGlmdCh0aGlzLm1vZGVscyk7CiAgICAgICAgICAgIHJldHVybiBfW21ldGhvZF0uYXBwbHkoXywgYXJncyk7CiAgICAgICAgfTsKICAgIH0pOwogICAgCiAgICAvLyBVbmRlcnNjb3JlIG1ldGhvZHMgdGhhdCB0YWtlIGEgcHJvcGVydHkgbmFtZSBhcyBhbiBhcmd1bWVudC4KICAgIHZhciBhdHRyaWJ1dGVNZXRob2RzID0gWydncm91cEJ5JywgJ2NvdW50QnknLCAnc29ydEJ5J107CiAgICAKICAgIC8vIFVzZSBhdHRyaWJ1dGVzIGluc3RlYWQgb2YgcHJvcGVydGllcy4KICAgIF8uZWFjaChhdHRyaWJ1dGVNZXRob2RzLCBmdW5jdGlvbiAobWV0aG9kKSB7CiAgICAgICAgQ29sbGVjdGlvbi5wcm90b3R5cGVbbWV0aG9kXSA9IGZ1bmN0aW9uICh2YWx1ZSwgY29udGV4dCkgewogICAgICAgICAgICB2YXIgaXRlcmF0b3IgPSBfLmlzRnVuY3Rpb24odmFsdWUpID8gdmFsdWUgOiBmdW5jdGlvbiAobW9kZWwpIHsKICAgICAgICAgICAgICAgIHJldHVybiBtb2RlbC5nZXQodmFsdWUpOwogICAgICAgICAgICB9OwogICAgICAgICAgICByZXR1cm4gX1ttZXRob2RdKHRoaXMubW9kZWxzLCBpdGVyYXRvciwgY29udGV4dCk7CiAgICAgICAgfTsKICAgIH0pOwoKICAgIC8vIEhhY2tib25lLkhpc3RvcnkKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0KICAgIAogICAgLy8gSGFuZGxlcyBjcm9zcy1icm93c2VyIGhpc3RvcnkgbWFuYWdlbWVudCwgYmFzZWQgb24gZWl0aGVyCiAgICAvLyBbcHVzaFN0YXRlXShodHRwOi8vZGl2ZWludG9odG1sNS5pbmZvL2hpc3RvcnkuaHRtbCkgYW5kIHJlYWwgVVJMcywgb3IKICAgIC8vIFtvbmhhc2hjaGFuZ2VdKGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvRE9NL3dpbmRvdy5vbmhhc2hjaGFuZ2UpCiAgICAvLyBhbmQgVVJMIGZyYWdtZW50cy4gSWYgdGhlIGJyb3dzZXIgc3VwcG9ydHMgbmVpdGhlciAob2xkIElFLCBuYXRjaCksCiAgICAvLyBmYWxscyBiYWNrIHRvIHBvbGxpbmcuCiAgICB2YXIgSGlzdG9yeSA9IEhhY2tib25lLkhpc3RvcnkgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgdGhpcy5oYW5kbGVycyA9IFtdOwogICAgICAgIF8uYmluZEFsbCh0aGlzLCAnY2hlY2tVcmwnKTsKICAgIAogICAgICAgIC8vIEVuc3VyZSB0aGF0IGBIaXN0b3J5YCBjYW4gYmUgdXNlZCBvdXRzaWRlIG9mIHRoZSBicm93c2VyLgogICAgICAgIGlmICh0eXBlb2Ygd2luZG93ICE9PSAndW5kZWZpbmVkJykgewogICAgICAgICAgICB0aGlzLmxvY2F0aW9uID0gd2luZG93LmxvY2F0aW9uOwogICAgICAgICAgICB0aGlzLmhpc3RvcnkgPSB3aW5kb3cuaGlzdG9yeTsKICAgICAgICB9CiAgICB9OwogICAgCiAgICAvLyBDYWNoZWQgcmVnZXggZm9yIHN0cmlwcGluZyBhIGxlYWRpbmcgaGFzaC9zbGFzaCBhbmQgdHJhaWxpbmcgc3BhY2UuCiAgICB2YXIgcm91dGVTdHJpcHBlciA9IC9eWyNcL118XHMrJC9nOwogICAgCiAgICAvLyBDYWNoZWQgcmVnZXggZm9yIHN0cmlwcGluZyBsZWFkaW5nIGFuZCB0cmFpbGluZyBzbGFzaGVzLgogICAgdmFyIHJvb3RTdHJpcHBlciA9IC9eXC8rfFwvKyQvZzsKICAgIAogICAgLy8gQ2FjaGVkIHJlZ2V4IGZvciBkZXRlY3RpbmcgTVNJRS4KICAgIHZhciBpc0V4cGxvcmVyID0gL21zaWUgW1x3Ll0rLzsKICAgIAogICAgLy8gQ2FjaGVkIHJlZ2V4IGZvciByZW1vdmluZyBhIHRyYWlsaW5nIHNsYXNoLgogICAgdmFyIHRyYWlsaW5nU2xhc2ggPSAvXC8kLzsKICAgIAogICAgLy8gSGFzIHRoZSBoaXN0b3J5IGhhbmRsaW5nIGFscmVhZHkgYmVlbiBzdGFydGVkPwogICAgSGlzdG9yeS5zdGFydGVkID0gZmFsc2U7CiAgICAKICAgIC8vIFNldCB1cCBhbGwgaW5oZXJpdGFibGUgKipIYWNrYm9uZS5IaXN0b3J5KiogcHJvcGVydGllcyBhbmQgbWV0aG9kcy4KICAgIF8uZXh0ZW5kKEhpc3RvcnkucHJvdG90eXBlLCBFdmVudHMsIHsKICAgIAogICAgICAgIC8vIFRoZSBkZWZhdWx0IGludGVydmFsIHRvIHBvbGwgZm9yIGhhc2ggY2hhbmdlcywgaWYgbmVjZXNzYXJ5LCBpcwogICAgICAgIC8vIHR3ZW50eSB0aW1lcyBhIHNlY29uZC4KICAgICAgICBpbnRlcnZhbDogNTAsCiAgICAKICAgICAgICAvLyBHZXRzIHRoZSB0cnVlIGhhc2ggdmFsdWUuIENhbm5vdCB1c2UgbG9jYXRpb24uaGFzaCBkaXJlY3RseSBkdWUgdG8gYnVnCiAgICAgICAgLy8gaW4gRmlyZWZveCB3aGVyZSBsb2NhdGlvbi5oYXNoIHdpbGwgYWx3YXlzIGJlIGRlY29kZWQuCiAgICAgICAgZ2V0SGFzaDogZnVuY3Rpb24gKHdpbmRvdykgewogICAgICAgICAgICB2YXIgbWF0Y2ggPSAod2luZG93IHx8IHRoaXMpLmxvY2F0aW9uLmhyZWYubWF0Y2goLyMoLiopJC8pOwogICAgICAgICAgICByZXR1cm4gbWF0Y2ggPyBtYXRjaFsxXSA6ICcnOwogICAgICAgIH0sCiAgICAKICAgICAgICAvLyBHZXQgdGhlIGNyb3NzLWJyb3dzZXIgbm9ybWFsaXplZCBVUkwgZnJhZ21lbnQsIGVpdGhlciBmcm9tIHRoZSBVUkwsCiAgICAgICAgLy8gdGhlIGhhc2gsIG9yIHRoZSBvdmVycmlkZS4KICAgICAgICBnZXRGcmFnbWVudDogZnVuY3Rpb24gKGZyYWdtZW50LCBmb3JjZVB1c2hTdGF0ZSkgewogICAgICAgICAgICBpZiAoZnJhZ21lbnQgPT0gbnVsbCkgewogICAgICAgICAgICAgICAgaWYgKHRoaXMuX2hhc1B1c2hTdGF0ZSB8fCAhdGhpcy5fd2FudHNIYXNoQ2hhbmdlIHx8IGZvcmNlUHVzaFN0YXRlKSB7CiAgICAgICAgICAgICAgICAgICAgZnJhZ21lbnQgPSB0aGlzLmxvY2F0aW9uLnBhdGhuYW1lOwogICAgICAgICAgICAgICAgICAgIHZhciByb290ID0gdGhpcy5yb290LnJlcGxhY2UodHJhaWxpbmdTbGFzaCwgJycpOwogICAgICAgICAgICAgICAgICAgIGlmICghZnJhZ21lbnQuaW5kZXhPZihyb290KSkgZnJhZ21lbnQgPSBmcmFnbWVudC5zbGljZShyb290Lmxlbmd0aCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGZyYWdtZW50ID0gdGhpcy5nZXRIYXNoKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZyYWdtZW50LnJlcGxhY2Uocm91dGVTdHJpcHBlciwgJycpOwogICAgICAgIH0sCiAgICAKICAgICAgICAvLyBTdGFydCB0aGUgaGFzaCBjaGFuZ2UgaGFuZGxpbmcsIHJldHVybmluZyBgdHJ1ZWAgaWYgdGhlIGN1cnJlbnQgVVJMIG1hdGNoZXMKICAgICAgICAvLyBhbiBleGlzdGluZyByb3V0ZSwgYW5kIGBmYWxzZWAgb3RoZXJ3aXNlLgogICAgICAgIHN0YXJ0OiBmdW5jdGlvbiAob3B0aW9ucykgewogICAgICAgICAgICBpZiAoSGlzdG9yeS5zdGFydGVkKSB0aHJvdyBuZXcgRXJyb3IoIkhhY2tib25lLmhpc3RvcnkgaGFzIGFscmVhZHkgYmVlbiBzdGFydGVkIik7CiAgICAgICAgICAgIEhpc3Rvcnkuc3RhcnRlZCA9IHRydWU7CiAgICAKICAgICAgICAgICAgLy8gRmlndXJlIG91dCB0aGUgaW5pdGlhbCBjb25maWd1cmF0aW9uLiBEbyB3ZSBuZWVkIGFuIGlmcmFtZT8KICAgICAgICAgICAgLy8gSXMgcHVzaFN0YXRlIGRlc2lyZWQgLi4uIGlzIGl0IGF2YWlsYWJsZT8KICAgICAgICAgICAgdGhpcy5vcHRpb25zID0gXy5leHRlbmQoe30sIHtyb290OiAnLyd9LCB0aGlzLm9wdGlvbnMsIG9wdGlvbnMpOwogICAgICAgICAgICB0aGlzLnJvb3QgPSB0aGlzLm9wdGlvbnMucm9vdDsKICAgICAgICAgICAgdGhpcy5fd2FudHNIYXNoQ2hhbmdlID0gdGhpcy5vcHRpb25zLmhhc2hDaGFuZ2UgIT09IGZhbHNlOwogICAgICAgICAgICB0aGlzLl93YW50c1B1c2hTdGF0ZSA9ICEhdGhpcy5vcHRpb25zLnB1c2hTdGF0ZTsKICAgICAgICAgICAgdGhpcy5faGFzUHVzaFN0YXRlID0gISEodGhpcy5vcHRpb25zLnB1c2hTdGF0ZSAmJiB0aGlzLmhpc3RvcnkgJiYgdGhpcy5oaXN0b3J5LnB1c2hTdGF0ZSk7CiAgICAgICAgICAgIHZhciBmcmFnbWVudCA9IHRoaXMuZ2V0RnJhZ21lbnQoKTsKICAgICAgICAgICAgdmFyIGRvY01vZGUgPSBkb2N1bWVudC5kb2N1bWVudE1vZGU7CiAgICAgICAgICAgIHZhciBvbGRJRSA9IChpc0V4cGxvcmVyLmV4ZWMobmF2aWdhdG9yLnVzZXJBZ2VudC50b0xvd2VyQ2FzZSgpKSAmJiAoIWRvY01vZGUgfHwgZG9jTW9kZSA8PSA3KSk7CiAgICAKICAgICAgICAgICAgLy8gTm9ybWFsaXplIHJvb3QgdG8gYWx3YXlzIGluY2x1ZGUgYSBsZWFkaW5nIGFuZCB0cmFpbGluZyBzbGFzaC4KICAgICAgICAgICAgdGhpcy5yb290ID0gKCcvJyArIHRoaXMucm9vdCArICcvJykucmVwbGFjZShyb290U3RyaXBwZXIsICcvJyk7CiAgICAKICAgICAgICAgICAgaWYgKG9sZElFICYmIHRoaXMuX3dhbnRzSGFzaENoYW5nZSkgewogICAgICAgICAgICAgICAgdGhpcy5pZnJhbWUgPSBIYWNrYm9uZS4kKCc8aWZyYW1lIHNyYz0iamF2YXNjcmlwdDowIiB0YWJpbmRleD0iLTEiIC8+JykuaGlkZSgpLmFwcGVuZFRvKCdib2R5JylbMF0uY29udGVudFdpbmRvdzsKICAgICAgICAgICAgICAgIHRoaXMubmF2aWdhdGUoZnJhZ21lbnQpOwogICAgICAgICAgICB9CiAgICAKICAgICAgICAgICAgLy8gRGVwZW5kaW5nIG9uIHdoZXRoZXIgd2UncmUgdXNpbmcgcHVzaFN0YXRlIG9yIGhhc2hlcywgYW5kIHdoZXRoZXIKICAgICAgICAgICAgLy8gJ29uaGFzaGNoYW5nZScgaXMgc3VwcG9ydGVkLCBkZXRlcm1pbmUgaG93IHdlIGNoZWNrIHRoZSBVUkwgc3RhdGUuCiAgICAgICAgICAgIGlmICh0aGlzLl9oYXNQdXNoU3RhdGUpIHsKICAgICAgICAgICAgICAgIEhhY2tib25lLiQod2luZG93KS5vbigncG9wc3RhdGUnLCB0aGlzLmNoZWNrVXJsKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLl93YW50c0hhc2hDaGFuZ2UgJiYgKCdvbmhhc2hjaGFuZ2UnIGluIHdpbmRvdykgJiYgIW9sZElFKSB7CiAgICAgICAgICAgICAgICBIYWNrYm9uZS4kKHdpbmRvdykub24oJ2hhc2hjaGFuZ2UnLCB0aGlzLmNoZWNrVXJsKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLl93YW50c0hhc2hDaGFuZ2UpIHsKICAgICAgICAgICAgICAgIHRoaXMuX2NoZWNrVXJsSW50ZXJ2YWwgPSBzZXRJbnRlcnZhbCh0aGlzLmNoZWNrVXJsLCB0aGlzLmludGVydmFsKTsKICAgICAgICAgICAgfQogICAgCiAgICAgICAgICAgIC8vIERldGVybWluZSBpZiB3ZSBuZWVkIHRvIGNoYW5nZSB0aGUgYmFzZSB1cmwsIGZvciBhIHB1c2hTdGF0ZSBsaW5rCiAgICAgICAgICAgIC8vIG9wZW5lZCBieSBhIG5vbi1wdXNoU3RhdGUgYnJvd3Nlci4KICAgICAgICAgICAgdGhpcy5mcmFnbWVudCA9IGZyYWdtZW50OwogICAgICAgICAgICB2YXIgbG9jID0gdGhpcy5sb2NhdGlvbjsKICAgICAgICAgICAgdmFyIGF0Um9vdCA9IGxvYy5wYXRobmFtZS5yZXBsYWNlKC9bXlwvXSQvLCAnJCYvJykgPT09IHRoaXMucm9vdDsKICAgIAogICAgICAgICAgICAvLyBUcmFuc2l0aW9uIGZyb20gaGFzaENoYW5nZSB0byBwdXNoU3RhdGUgb3IgdmljZSB2ZXJzYSBpZiBib3RoIGFyZQogICAgICAgICAgICAvLyByZXF1ZXN0ZWQuCiAgICAgICAgICAgIGlmICh0aGlzLl93YW50c0hhc2hDaGFuZ2UgJiYgdGhpcy5fd2FudHNQdXNoU3RhdGUpIHsKICAgIAogICAgICAgICAgICAgICAgLy8gSWYgd2UndmUgc3RhcnRlZCBvZmYgd2l0aCBhIHJvdXRlIGZyb20gYSBgcHVzaFN0YXRlYC1lbmFibGVkCiAgICAgICAgICAgICAgICAvLyBicm93c2VyLCBidXQgd2UncmUgY3VycmVudGx5IGluIGEgYnJvd3NlciB0aGF0IGRvZXNuJ3Qgc3VwcG9ydCBpdC4uLgogICAgICAgICAgICAgICAgaWYgKCF0aGlzLl9oYXNQdXNoU3RhdGUgJiYgIWF0Um9vdCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZnJhZ21lbnQgPSB0aGlzLmdldEZyYWdtZW50KG51bGwsIHRydWUpOwogICAgICAgICAgICAgICAgICAgIHRoaXMubG9jYXRpb24ucmVwbGFjZSh0aGlzLnJvb3QgKyB0aGlzLmxvY2F0aW9uLnNlYXJjaCArICcjJyArIHRoaXMuZnJhZ21lbnQpOwogICAgICAgICAgICAgICAgICAgIC8vIFJldHVybiBpbW1lZGlhdGVseSBhcyBicm93c2VyIHdpbGwgZG8gcmVkaXJlY3QgdG8gbmV3IHVybAogICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgCiAgICAgICAgICAgICAgICAgICAgLy8gT3IgaWYgd2UndmUgc3RhcnRlZCBvdXQgd2l0aCBhIGhhc2gtYmFzZWQgcm91dGUsIGJ1dCB3ZSdyZSBjdXJyZW50bHkKICAgICAgICAgICAgICAgICAgICAvLyBpbiBhIGJyb3dzZXIgd2hlcmUgaXQgY291bGQgYmUgYHB1c2hTdGF0ZWAtYmFzZWQgaW5zdGVhZC4uLgogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLl9oYXNQdXNoU3RhdGUgJiYgYXRSb290ICYmIGxvYy5oYXNoKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5mcmFnbWVudCA9IHRoaXMuZ2V0SGFzaCgpLnJlcGxhY2Uocm91dGVTdHJpcHBlciwgJycpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuaGlzdG9yeS5yZXBsYWNlU3RhdGUoe30sIGRvY3VtZW50LnRpdGxlLCB0aGlzLnJvb3QgKyB0aGlzLmZyYWdtZW50ICsgbG9jLnNlYXJjaCk7CiAgICAgICAgICAgICAgICB9CiAgICAKICAgICAgICAgICAgfQogICAgCiAgICAgICAgICAgIGlmICghdGhpcy5vcHRpb25zLnNpbGVudCkgcmV0dXJuIHRoaXMubG9hZFVybCgpOwogICAgICAgIH0sCiAgICAKICAgICAgICAvLyBEaXNhYmxlIEhhY2tib25lLmhpc3RvcnksIHBlcmhhcHMgdGVtcG9yYXJpbHkuIE5vdCB1c2VmdWwgaW4gYSByZWFsIGFwcCwKICAgICAgICAvLyBidXQgcG9zc2libHkgdXNlZnVsIGZvciB1bml0IHRlc3RpbmcgUm91dGVycy4KICAgICAgICBzdG9wOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIEhhY2tib25lLiQod2luZG93KS5vZmYoJ3BvcHN0YXRlJywgdGhpcy5jaGVja1VybCkub2ZmKCdoYXNoY2hhbmdlJywgdGhpcy5jaGVja1VybCk7CiAgICAgICAgICAgIGNsZWFySW50ZXJ2YWwodGhpcy5fY2hlY2tVcmxJbnRlcnZhbCk7CiAgICAgICAgICAgIEhpc3Rvcnkuc3RhcnRlZCA9IGZhbHNlOwogICAgICAgIH0sCiAgICAKICAgICAgICAvLyBBZGQgYSByb3V0ZSB0byBiZSB0ZXN0ZWQgd2hlbiB0aGUgZnJhZ21lbnQgY2hhbmdlcy4gUm91dGVzIGFkZGVkIGxhdGVyCiAgICAgICAgLy8gbWF5IG92ZXJyaWRlIHByZXZpb3VzIHJvdXRlcy4KICAgICAgICByb3V0ZTogZnVuY3Rpb24gKHJvdXRlLCBjYWxsYmFjaykgewogICAgICAgICAgICB0aGlzLmhhbmRsZXJzLnVuc2hpZnQoe3JvdXRlOiByb3V0ZSwgY2FsbGJhY2s6IGNhbGxiYWNrfSk7CiAgICAgICAgfSwKICAgIAogICAgICAgIC8vIENoZWNrcyB0aGUgY3VycmVudCBVUkwgdG8gc2VlIGlmIGl0IGhhcyBjaGFuZ2VkLCBhbmQgaWYgaXQgaGFzLAogICAgICAgIC8vIGNhbGxzIGBsb2FkVXJsYCwgbm9ybWFsaXppbmcgYWNyb3NzIHRoZSBoaWRkZW4gaWZyYW1lLgogICAgICAgIGNoZWNrVXJsOiBmdW5jdGlvbiAoZSkgewogICAgICAgICAgICB2YXIgY3VycmVudCA9IHRoaXMuZ2V0RnJhZ21lbnQoKTsKICAgICAgICAgICAgaWYgKGN1cnJlbnQgPT09IHRoaXMuZnJhZ21lbnQgJiYgdGhpcy5pZnJhbWUpIHsKICAgICAgICAgICAgICAgIGN1cnJlbnQgPSB0aGlzLmdldEZyYWdtZW50KHRoaXMuZ2V0SGFzaCh0aGlzLmlmcmFtZSkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChjdXJyZW50ID09PSB0aGlzLmZyYWdtZW50KSByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIGlmICh0aGlzLmlmcmFtZSkgdGhpcy5uYXZpZ2F0ZShjdXJyZW50KTsKICAgICAgICAgICAgdGhpcy5sb2FkVXJsKCk7CiAgICAgICAgfSwKICAgIAogICAgICAgIC8vIEF0dGVtcHQgdG8gbG9hZCB0aGUgY3VycmVudCBVUkwgZnJhZ21lbnQuIElmIGEgcm91dGUgc3VjY2VlZHMgd2l0aCBhCiAgICAgICAgLy8gbWF0Y2gsIHJldHVybnMgYHRydWVgLiBJZiBubyBkZWZpbmVkIHJvdXRlcyBtYXRjaGVzIHRoZSBmcmFnbWVudCwKICAgICAgICAvLyByZXR1cm5zIGBmYWxzZWAuCiAgICAgICAgbG9hZFVybDogZnVuY3Rpb24gKGZyYWdtZW50T3ZlcnJpZGUpIHsKICAgICAgICAgICAgdmFyIGZyYWdtZW50ID0gdGhpcy5mcmFnbWVudCA9IHRoaXMuZ2V0RnJhZ21lbnQoZnJhZ21lbnRPdmVycmlkZSk7CiAgICAgICAgICAgIHJldHVybiBfLmFueSh0aGlzLmhhbmRsZXJzLCBmdW5jdGlvbiAoaGFuZGxlcikgewogICAgICAgICAgICAgICAgaWYgKGhhbmRsZXIucm91dGUudGVzdChmcmFnbWVudCkpIHsKICAgICAgICAgICAgICAgICAgICBoYW5kbGVyLmNhbGxiYWNrKGZyYWdtZW50KTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKICAgIAogICAgICAgIC8vIFNhdmUgYSBmcmFnbWVudCBpbnRvIHRoZSBoYXNoIGhpc3RvcnksIG9yIHJlcGxhY2UgdGhlIFVSTCBzdGF0ZSBpZiB0aGUKICAgICAgICAvLyAncmVwbGFjZScgb3B0aW9uIGlzIHBhc3NlZC4gWW91IGFyZSByZXNwb25zaWJsZSBmb3IgcHJvcGVybHkgVVJMLWVuY29kaW5nCiAgICAgICAgLy8gdGhlIGZyYWdtZW50IGluIGFkdmFuY2UuCiAgICAgICAgLy8KICAgICAgICAvLyBUaGUgb3B0aW9ucyBvYmplY3QgY2FuIGNvbnRhaW4gYHRyaWdnZXI6IHRydWVgIGlmIHlvdSB3aXNoIHRvIGhhdmUgdGhlCiAgICAgICAgLy8gcm91dGUgY2FsbGJhY2sgYmUgZmlyZWQgKG5vdCB1c3VhbGx5IGRlc2lyYWJsZSksIG9yIGByZXBsYWNlOiB0cnVlYCwgaWYKICAgICAgICAvLyB5b3Ugd2lzaCB0byBtb2RpZnkgdGhlIGN1cnJlbnQgVVJMIHdpdGhvdXQgYWRkaW5nIGFuIGVudHJ5IHRvIHRoZSBoaXN0b3J5LgogICAgICAgIG5hdmlnYXRlOiBmdW5jdGlvbiAoZnJhZ21lbnQsIG9wdGlvbnMpIHsKICAgICAgICAgICAgaWYgKCFIaXN0b3J5LnN0YXJ0ZWQpIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgaWYgKCFvcHRpb25zIHx8IG9wdGlvbnMgPT09IHRydWUpIG9wdGlvbnMgPSB7dHJpZ2dlcjogISFvcHRpb25zfTsKICAgIAogICAgICAgICAgICBmcmFnbWVudCA9IHRoaXMuZ2V0RnJhZ21lbnQoZnJhZ21lbnQgfHwgJycpOwogICAgICAgICAgICBpZiAodGhpcy5mcmFnbWVudCA9PT0gZnJhZ21lbnQpIHJldHVybjsKICAgICAgICAgICAgdGhpcy5mcmFnbWVudCA9IGZyYWdtZW50OwogICAgCiAgICAgICAgICAgIHZhciB1cmwgPSB0aGlzLnJvb3QgKyBmcmFnbWVudDsKICAgIAogICAgICAgICAgICAvLyBEb24ndCBpbmNsdWRlIGEgdHJhaWxpbmcgc2xhc2ggb24gdGhlIHJvb3QuCiAgICAgICAgICAgIGlmIChmcmFnbWVudCA9PT0gJycgJiYgdXJsICE9PSAnLycpIHVybCA9IHVybC5zbGljZSgwLCAtMSk7CiAgICAKICAgICAgICAgICAgLy8gSWYgcHVzaFN0YXRlIGlzIGF2YWlsYWJsZSwgd2UgdXNlIGl0IHRvIHNldCB0aGUgZnJhZ21lbnQgYXMgYSByZWFsIFVSTC4KICAgICAgICAgICAgaWYgKHRoaXMuX2hhc1B1c2hTdGF0ZSkgewogICAgICAgICAgICAgICAgdGhpcy5oaXN0b3J5W29wdGlvbnMucmVwbGFjZSA/ICdyZXBsYWNlU3RhdGUnIDogJ3B1c2hTdGF0ZSddKHt9LCBkb2N1bWVudC50aXRsZSwgdXJsKTsKICAgIAogICAgICAgICAgICAgICAgLy8gSWYgaGFzaCBjaGFuZ2VzIGhhdmVuJ3QgYmVlbiBleHBsaWNpdGx5IGRpc2FibGVkLCB1cGRhdGUgdGhlIGhhc2gKICAgICAgICAgICAgICAgIC8vIGZyYWdtZW50IHRvIHN0b3JlIGhpc3RvcnkuCiAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5fd2FudHNIYXNoQ2hhbmdlKSB7CiAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVIYXNoKHRoaXMubG9jYXRpb24sIGZyYWdtZW50LCBvcHRpb25zLnJlcGxhY2UpOwogICAgICAgICAgICAgICAgaWYgKHRoaXMuaWZyYW1lICYmIChmcmFnbWVudCAhPT0gdGhpcy5nZXRGcmFnbWVudCh0aGlzLmdldEhhc2godGhpcy5pZnJhbWUpKSkpIHsKICAgICAgICAgICAgICAgICAgICAvLyBPcGVuaW5nIGFuZCBjbG9zaW5nIHRoZSBpZnJhbWUgdHJpY2tzIElFNyBhbmQgZWFybGllciB0byBwdXNoIGEKICAgICAgICAgICAgICAgICAgICAvLyBoaXN0b3J5IGVudHJ5IG9uIGhhc2gtdGFnIGNoYW5nZS4gIFdoZW4gcmVwbGFjZSBpcyB0cnVlLCB3ZSBkb24ndAogICAgICAgICAgICAgICAgICAgIC8vIHdhbnQgdGhpcy4KICAgICAgICAgICAgICAgICAgICBpZiAoIW9wdGlvbnMucmVwbGFjZSkgdGhpcy5pZnJhbWUuZG9jdW1lbnQub3BlbigpLmNsb3NlKCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlSGFzaCh0aGlzLmlmcmFtZS5sb2NhdGlvbiwgZnJhZ21lbnQsIG9wdGlvbnMucmVwbGFjZSk7CiAgICAgICAgICAgICAgICB9CiAgICAKICAgICAgICAgICAgICAgIC8vIElmIHlvdSd2ZSB0b2xkIHVzIHRoYXQgeW91IGV4cGxpY2l0bHkgZG9uJ3Qgd2FudCBmYWxsYmFjayBoYXNoY2hhbmdlLQogICAgICAgICAgICAgICAgLy8gYmFzZWQgaGlzdG9yeSwgdGhlbiBgbmF2aWdhdGVgIGJlY29tZXMgYSBwYWdlIHJlZnJlc2guCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5sb2NhdGlvbi5hc3NpZ24odXJsKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAob3B0aW9ucy50cmlnZ2VyKSByZXR1cm4gdGhpcy5sb2FkVXJsKGZyYWdtZW50KTsKICAgICAgICB9LAogICAgCiAgICAgICAgLy8gVXBkYXRlIHRoZSBoYXNoIGxvY2F0aW9uLCBlaXRoZXIgcmVwbGFjaW5nIHRoZSBjdXJyZW50IGVudHJ5LCBvciBhZGRpbmcKICAgICAgICAvLyBhIG5ldyBvbmUgdG8gdGhlIGJyb3dzZXIgaGlzdG9yeS4KICAgICAgICBfdXBkYXRlSGFzaDogZnVuY3Rpb24gKGxvY2F0aW9uLCBmcmFnbWVudCwgcmVwbGFjZSkgewogICAgICAgICAgICBpZiAocmVwbGFjZSkgewogICAgICAgICAgICAgICAgdmFyIGhyZWYgPSBsb2NhdGlvbi5ocmVmLnJlcGxhY2UoLyhqYXZhc2NyaXB0OnwjKS4qJC8sICcnKTsKICAgICAgICAgICAgICAgIGxvY2F0aW9uLnJlcGxhY2UoaHJlZiArICcjJyArIGZyYWdtZW50KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIFNvbWUgYnJvd3NlcnMgcmVxdWlyZSB0aGF0IGBoYXNoYCBjb250YWlucyBhIGxlYWRpbmcgIy4KICAgICAgICAgICAgICAgIGxvY2F0aW9uLmhhc2ggPSAnIycgKyBmcmFnbWVudDsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIAogICAgfSk7CiAgICAKICAgIC8vIENyZWF0ZSB0aGUgZGVmYXVsdCBIYWNrYm9uZS5oaXN0b3J5LgogICAgSGFja2JvbmUuaGlzdG9yeSA9IG5ldyBIaXN0b3J5OwoKICAgIC8vIEhhY2tib25lLlJvdXRlcgogICAgLy8gLS0tLS0tLS0tLS0tLS0tCiAgICAKICAgIC8vIENhY2hlZCByZWd1bGFyIGV4cHJlc3Npb25zIGZvciBtYXRjaGluZyBuYW1lZCBwYXJhbSBwYXJ0cyBhbmQgc3BsYXR0ZWQKICAgIC8vIHBhcnRzIG9mIHJvdXRlIHN0cmluZ3MuCiAgICB2YXIgb3B0aW9uYWxQYXJhbSA9IC9cKCguKj8pXCkvZzsKICAgIHZhciBuYW1lZFBhcmFtID0gLyhcKFw/KT86XHcrL2c7CiAgICB2YXIgc3BsYXRQYXJhbSA9IC9cKlx3Ky9nOwogICAgdmFyIGVzY2FwZVJlZ0V4cCA9IC9bXC17fVxbXF0rPy4sXFxcXiR8I1xzXS9nOwogICAgCiAgICAvLyBSb3V0ZXJzIG1hcCBmYXV4LVVSTHMgdG8gYWN0aW9ucywgYW5kIGZpcmUgZXZlbnRzIHdoZW4gcm91dGVzIGFyZQogICAgLy8gbWF0Y2hlZC4gQ3JlYXRpbmcgYSBuZXcgb25lIHNldHMgaXRzIGByb3V0ZXNgIGhhc2gsIGlmIG5vdCBzZXQgc3RhdGljYWxseS4KICAgIHZhciBSb3V0ZXIgPSBIYWNrYm9uZS5Sb3V0ZXIgPSBDb21wb25lbnQuZXh0ZW5kKHsKICAgICAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24gKG9wdGlvbnMpIHsKICAgICAgICAgICAgb3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KTsKICAgICAgICAgICAgaWYgKG9wdGlvbnMucm91dGVzKSB0aGlzLnJvdXRlcyA9IG9wdGlvbnMucm91dGVzOwogICAgICAgICAgICB0aGlzLl9iaW5kUm91dGVzKCk7CiAgICAgICAgICAgIHRoaXMuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgIH0sCiAgICAKICAgICAgICAvLyBNYW51YWxseSBiaW5kIGEgc2luZ2xlIG5hbWVkIHJvdXRlIHRvIGEgY2FsbGJhY2suIEZvciBleGFtcGxlOgogICAgICAgIC8vCiAgICAgICAgLy8gICAgIHRoaXMucm91dGUoJ3NlYXJjaC86cXVlcnkvcDpudW0nLCAnc2VhcmNoJywgZnVuY3Rpb24ocXVlcnksIG51bSkgewogICAgICAgIC8vICAgICAgIC4uLgogICAgICAgIC8vICAgICB9KTsKICAgICAgICAvLwogICAgICAgIHJvdXRlOiBmdW5jdGlvbiAocm91dGUsIG5hbWUsIGNhbGxiYWNrKSB7CiAgICAgICAgICAgIGlmICghXy5pc1JlZ0V4cChyb3V0ZSkpIHJvdXRlID0gdGhpcy5fcm91dGVUb1JlZ0V4cChyb3V0ZSk7CiAgICAgICAgICAgIGlmIChfLmlzRnVuY3Rpb24obmFtZSkpIHsKICAgICAgICAgICAgICAgIGNhbGxiYWNrID0gbmFtZTsKICAgICAgICAgICAgICAgIG5hbWUgPSAnJzsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIWNhbGxiYWNrKSBjYWxsYmFjayA9IHRoaXNbbmFtZV07CiAgICAgICAgICAgIHZhciByb3V0ZXIgPSB0aGlzOwogICAgICAgICAgICBIYWNrYm9uZS5oaXN0b3J5LnJvdXRlKHJvdXRlLCBmdW5jdGlvbiAoZnJhZ21lbnQpIHsKICAgICAgICAgICAgICAgIHZhciBhcmdzID0gcm91dGVyLl9leHRyYWN0UGFyYW1ldGVycyhyb3V0ZSwgZnJhZ21lbnQpOwogICAgICAgICAgICAgICAgY2FsbGJhY2sgJiYgY2FsbGJhY2suYXBwbHkocm91dGVyLCBhcmdzKTsKICAgICAgICAgICAgICAgIHJvdXRlci50cmlnZ2VyLmFwcGx5KHJvdXRlciwgWydyb3V0ZTonICsgbmFtZV0uY29uY2F0KGFyZ3MpKTsKICAgICAgICAgICAgICAgIHJvdXRlci50cmlnZ2VyKCdyb3V0ZScsIG5hbWUsIGFyZ3MpOwogICAgICAgICAgICAgICAgSGFja2JvbmUuaGlzdG9yeS50cmlnZ2VyKCdyb3V0ZScsIHJvdXRlciwgbmFtZSwgYXJncyk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9LAogICAgCiAgICAgICAgLy8gU2ltcGxlIHByb3h5IHRvIGBIYWNrYm9uZS5oaXN0b3J5YCB0byBzYXZlIGEgZnJhZ21lbnQgaW50byB0aGUgaGlzdG9yeS4KICAgICAgICBuYXZpZ2F0ZTogZnVuY3Rpb24gKGZyYWdtZW50LCBvcHRpb25zKSB7CiAgICAgICAgICAgIEhhY2tib25lLmhpc3RvcnkubmF2aWdhdGUoZnJhZ21lbnQsIG9wdGlvbnMpOwogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9LAogICAgCiAgICAgICAgLy8gQmluZCBhbGwgZGVmaW5lZCByb3V0ZXMgdG8gYEhhY2tib25lLmhpc3RvcnlgLiBXZSBoYXZlIHRvIHJldmVyc2UgdGhlCiAgICAgICAgLy8gb3JkZXIgb2YgdGhlIHJvdXRlcyBoZXJlIHRvIHN1cHBvcnQgYmVoYXZpb3Igd2hlcmUgdGhlIG1vc3QgZ2VuZXJhbAogICAgICAgIC8vIHJvdXRlcyBjYW4gYmUgZGVmaW5lZCBhdCB0aGUgYm90dG9tIG9mIHRoZSByb3V0ZSBtYXAuCiAgICAgICAgX2JpbmRSb3V0ZXM6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLnJvdXRlcykgcmV0dXJuOwogICAgICAgICAgICB0aGlzLnJvdXRlcyA9IF8ucmVzdWx0KHRoaXMsICdyb3V0ZXMnKTsKICAgICAgICAgICAgdmFyIHJvdXRlLCByb3V0ZXMgPSBfLmtleXModGhpcy5yb3V0ZXMpOwogICAgICAgICAgICB3aGlsZSAoKHJvdXRlID0gcm91dGVzLnBvcCgpKSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICB0aGlzLnJvdXRlKHJvdXRlLCB0aGlzLnJvdXRlc1tyb3V0ZV0pOwogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgIAogICAgICAgIC8vIENvbnZlcnQgYSByb3V0ZSBzdHJpbmcgaW50byBhIHJlZ3VsYXIgZXhwcmVzc2lvbiwgc3VpdGFibGUgZm9yIG1hdGNoaW5nCiAgICAgICAgLy8gYWdhaW5zdCB0aGUgY3VycmVudCBsb2NhdGlvbiBoYXNoLgogICAgICAgIF9yb3V0ZVRvUmVnRXhwOiBmdW5jdGlvbiAocm91dGUpIHsKICAgICAgICAgICAgcm91dGUgPSByb3V0ZS5yZXBsYWNlKGVzY2FwZVJlZ0V4cCwgJ1xcJCYnKQogICAgICAgICAgICAgICAgLnJlcGxhY2Uob3B0aW9uYWxQYXJhbSwgJyg/OiQxKT8nKQogICAgICAgICAgICAgICAgLnJlcGxhY2UobmFtZWRQYXJhbSwgZnVuY3Rpb24gKG1hdGNoLCBvcHRpb25hbCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBvcHRpb25hbCA/IG1hdGNoIDogJyhbXlwvXSspJzsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAucmVwbGFjZShzcGxhdFBhcmFtLCAnKC4qPyknKTsKICAgICAgICAgICAgcmV0dXJuIG5ldyBSZWdFeHAoJ14nICsgcm91dGUgKyAnJCcpOwogICAgICAgIH0sCiAgICAKICAgICAgICAvLyBHaXZlbiBhIHJvdXRlLCBhbmQgYSBVUkwgZnJhZ21lbnQgdGhhdCBpdCBtYXRjaGVzLCByZXR1cm4gdGhlIGFycmF5IG9mCiAgICAgICAgLy8gZXh0cmFjdGVkIGRlY29kZWQgcGFyYW1ldGVycy4gRW1wdHkgb3IgdW5tYXRjaGVkIHBhcmFtZXRlcnMgd2lsbCBiZQogICAgICAgIC8vIHRyZWF0ZWQgYXMgYG51bGxgIHRvIG5vcm1hbGl6ZSBjcm9zcy1icm93c2VyIGJlaGF2aW9yLgogICAgICAgIF9leHRyYWN0UGFyYW1ldGVyczogZnVuY3Rpb24gKHJvdXRlLCBmcmFnbWVudCkgewogICAgICAgICAgICB2YXIgcGFyYW1zID0gcm91dGUuZXhlYyhmcmFnbWVudCkuc2xpY2UoMSk7CiAgICAgICAgICAgIHJldHVybiBfLm1hcChwYXJhbXMsIGZ1bmN0aW9uIChwYXJhbSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHBhcmFtID8gZGVjb2RlVVJJQ29tcG9uZW50KHBhcmFtKSA6IG51bGw7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgIH0pOwogICAgCiAgICBfLmV4dGVuZChSb3V0ZXIucHJvdG90eXBlLCBFdmVudHMpOwoKICAgIC8vIEhhY2tib25lLnN5bmMKICAgIC8vIC0tLS0tLS0tLS0tLS0KICAgIAogICAgLy8gT3ZlcnJpZGUgdGhpcyBmdW5jdGlvbiB0byBjaGFuZ2UgdGhlIG1hbm5lciBpbiB3aGljaCBIYWNrYm9uZSBwZXJzaXN0cwogICAgLy8gbW9kZWxzIHRvIHRoZSBzZXJ2ZXIuIFlvdSB3aWxsIGJlIHBhc3NlZCB0aGUgdHlwZSBvZiByZXF1ZXN0LCBhbmQgdGhlCiAgICAvLyBtb2RlbCBpbiBxdWVzdGlvbi4gQnkgZGVmYXVsdCwgbWFrZXMgYSBSRVNUZnVsIEFqYXggcmVxdWVzdAogICAgLy8gdG8gdGhlIG1vZGVsJ3MgYHVybCgpYC4gU29tZSBwb3NzaWJsZSBjdXN0b21pemF0aW9ucyBjb3VsZCBiZToKICAgIC8vCiAgICAvLyAqIFVzZSBgc2V0VGltZW91dGAgdG8gYmF0Y2ggcmFwaWQtZmlyZSB1cGRhdGVzIGludG8gYSBzaW5nbGUgcmVxdWVzdC4KICAgIC8vICogU2VuZCB1cCB0aGUgbW9kZWxzIGFzIFhNTCBpbnN0ZWFkIG9mIEpTT04uCiAgICAvLyAqIFBlcnNpc3QgbW9kZWxzIHZpYSBXZWJTb2NrZXRzIGluc3RlYWQgb2YgQWpheC4KICAgIC8vCiAgICAvLyBUdXJuIG9uIGBIYWNrYm9uZS5lbXVsYXRlSFRUUGAgaW4gb3JkZXIgdG8gc2VuZCBgUFVUYCBhbmQgYERFTEVURWAgcmVxdWVzdHMKICAgIC8vIGFzIGBQT1NUYCwgd2l0aCBhIGBfbWV0aG9kYCBwYXJhbWV0ZXIgY29udGFpbmluZyB0aGUgdHJ1ZSBIVFRQIG1ldGhvZCwKICAgIC8vIGFzIHdlbGwgYXMgYWxsIHJlcXVlc3RzIHdpdGggdGhlIGJvZHkgYXMgYGFwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZGAKICAgIC8vIGluc3RlYWQgb2YgYGFwcGxpY2F0aW9uL2pzb25gIHdpdGggdGhlIG1vZGVsIGluIGEgcGFyYW0gbmFtZWQgYG1vZGVsYC4KICAgIC8vIFVzZWZ1bCB3aGVuIGludGVyZmFjaW5nIHdpdGggc2VydmVyLXNpZGUgbGFuZ3VhZ2VzIGxpa2UgKipQSFAqKiB0aGF0IG1ha2UKICAgIC8vIGl0IGRpZmZpY3VsdCB0byByZWFkIHRoZSBib2R5IG9mIGBQVVRgIHJlcXVlc3RzLgogICAgSGFja2JvbmUuc3luYyA9IGZ1bmN0aW9uIChtZXRob2QsIG1vZGVsLCBvcHRpb25zKSB7CiAgICAgICAgdmFyIHR5cGUgPSBtZXRob2RNYXBbbWV0aG9kXTsKICAgIAogICAgICAgIC8vIERlZmF1bHQgb3B0aW9ucywgdW5sZXNzIHNwZWNpZmllZC4KICAgICAgICBfLmRlZmF1bHRzKG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSksIHsKICAgICAgICAgICAgZW11bGF0ZUhUVFA6IEhhY2tib25lLmVtdWxhdGVIVFRQLAogICAgICAgICAgICBlbXVsYXRlSlNPTjogSGFja2JvbmUuZW11bGF0ZUpTT04KICAgICAgICB9KTsKICAgIAogICAgICAgIC8vIERlZmF1bHQgSlNPTi1yZXF1ZXN0IG9wdGlvbnMuCiAgICAgICAgdmFyIHBhcmFtcyA9IHt0eXBlOiB0eXBlLCBkYXRhVHlwZTogJ2pzb24nfTsKICAgIAogICAgICAgIC8vIEVuc3VyZSB0aGF0IHdlIGhhdmUgYSBVUkwuCiAgICAgICAgaWYgKCFvcHRpb25zLnVybCkgewogICAgICAgICAgICBwYXJhbXMudXJsID0gXy5yZXN1bHQobW9kZWwsICd1cmwnKSB8fCB1cmxFcnJvcigpOwogICAgICAgIH0KICAgIAogICAgICAgIC8vIEVuc3VyZSB0aGF0IHdlIGhhdmUgdGhlIGFwcHJvcHJpYXRlIHJlcXVlc3QgZGF0YS4KICAgICAgICBpZiAob3B0aW9ucy5kYXRhID09IG51bGwgJiYgbW9kZWwgJiYgKG1ldGhvZCA9PT0gJ2NyZWF0ZScgfHwgbWV0aG9kID09PSAndXBkYXRlJyB8fCBtZXRob2QgPT09ICdwYXRjaCcpKSB7CiAgICAgICAgICAgIHBhcmFtcy5jb250ZW50VHlwZSA9ICdhcHBsaWNhdGlvbi9qc29uJzsKICAgICAgICAgICAgcGFyYW1zLmRhdGEgPSBKU09OLnN0cmluZ2lmeShvcHRpb25zLmF0dHJzIHx8IG1vZGVsLnRvSlNPTihvcHRpb25zKSk7CiAgICAgICAgfQogICAgCiAgICAgICAgLy8gRm9yIG9sZGVyIHNlcnZlcnMsIGVtdWxhdGUgSlNPTiBieSBlbmNvZGluZyB0aGUgcmVxdWVzdCBpbnRvIGFuIEhUTUwtZm9ybS4KICAgICAgICBpZiAob3B0aW9ucy5lbXVsYXRlSlNPTikgewogICAgICAgICAgICBwYXJhbXMuY29udGVudFR5cGUgPSAnYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkJzsKICAgICAgICAgICAgcGFyYW1zLmRhdGEgPSBwYXJhbXMuZGF0YSA/IHttb2RlbDogcGFyYW1zLmRhdGF9IDoge307CiAgICAgICAgfQogICAgCiAgICAgICAgLy8gRm9yIG9sZGVyIHNlcnZlcnMsIGVtdWxhdGUgSFRUUCBieSBtaW1pY2tpbmcgdGhlIEhUVFAgbWV0aG9kIHdpdGggYF9tZXRob2RgCiAgICAgICAgLy8gQW5kIGFuIGBYLUhUVFAtTWV0aG9kLU92ZXJyaWRlYCBoZWFkZXIuCiAgICAgICAgaWYgKG9wdGlvbnMuZW11bGF0ZUhUVFAgJiYgKHR5cGUgPT09ICdQVVQnIHx8IHR5cGUgPT09ICdERUxFVEUnIHx8IHR5cGUgPT09ICdQQVRDSCcpKSB7CiAgICAgICAgICAgIHBhcmFtcy50eXBlID0gJ1BPU1QnOwogICAgICAgICAgICBpZiAob3B0aW9ucy5lbXVsYXRlSlNPTikgcGFyYW1zLmRhdGEuX21ldGhvZCA9IHR5cGU7CiAgICAgICAgICAgIHZhciBiZWZvcmVTZW5kID0gb3B0aW9ucy5iZWZvcmVTZW5kOwogICAgICAgICAgICBvcHRpb25zLmJlZm9yZVNlbmQgPSBmdW5jdGlvbiAoeGhyKSB7CiAgICAgICAgICAgICAgICB2YXIgcmVzdWx0OwogICAgICAgICAgICAgICAgeGhyLnNldFJlcXVlc3RIZWFkZXIoJ1gtSFRUUC1NZXRob2QtT3ZlcnJpZGUnLCB0eXBlKTsKICAgICAgICAgICAgICAgIGlmIChiZWZvcmVTZW5kKSByZXN1bHQgPSBiZWZvcmVTZW5kLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgICAgICB9OwogICAgICAgIH0KICAgIAogICAgICAgIC8vIERvbid0IHByb2Nlc3MgZGF0YSBvbiBhIG5vbi1HRVQgcmVxdWVzdC4KICAgICAgICBpZiAocGFyYW1zLnR5cGUgIT09ICdHRVQnICYmICFvcHRpb25zLmVtdWxhdGVKU09OKSB7CiAgICAgICAgICAgIHBhcmFtcy5wcm9jZXNzRGF0YSA9IGZhbHNlOwogICAgICAgIH0KICAgIAogICAgICAgIC8vIElmIHdlJ3JlIHNlbmRpbmcgYSBgUEFUQ0hgIHJlcXVlc3QsIGFuZCB3ZSdyZSBpbiBhbiBvbGQgSW50ZXJuZXQgRXhwbG9yZXIKICAgICAgICAvLyB0aGF0IHN0aWxsIGhhcyBBY3RpdmVYIGVuYWJsZWQgYnkgZGVmYXVsdCwgb3ZlcnJpZGUgalF1ZXJ5IHRvIHVzZSB0aGF0CiAgICAgICAgLy8gZm9yIFhIUiBpbnN0ZWFkLiBSZW1vdmUgdGhpcyBsaW5lIHdoZW4galF1ZXJ5IHN1cHBvcnRzIGBQQVRDSGAgb24gSUU4LgogICAgICAgIGlmIChwYXJhbXMudHlwZSA9PT0gJ1BBVENIJyAmJiBub1hoclBhdGNoKSB7CiAgICAgICAgICAgIHBhcmFtcy54aHIgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbmV3IEFjdGl2ZVhPYmplY3QoIk1pY3Jvc29mdC5YTUxIVFRQIik7CiAgICAgICAgICAgIH07CiAgICAgICAgfQogICAgCiAgICAgICAgLy8gTWFrZSB0aGUgcmVxdWVzdCwgYWxsb3dpbmcgdGhlIHVzZXIgdG8gb3ZlcnJpZGUgYW55IEFqYXggb3B0aW9ucy4KICAgICAgICB2YXIgeGhyID0gb3B0aW9ucy54aHIgPSBIYWNrYm9uZS5hamF4KF8uZXh0ZW5kKHBhcmFtcywgb3B0aW9ucykpOwogICAgICAgIG1vZGVsLnRyaWdnZXIoJ3JlcXVlc3QnLCBtb2RlbCwgeGhyLCBvcHRpb25zKTsKICAgICAgICByZXR1cm4geGhyOwogICAgfTsKICAgIAogICAgdmFyIG5vWGhyUGF0Y2ggPSB0eXBlb2Ygd2luZG93ICE9PSAndW5kZWZpbmVkJyAmJiAhIXdpbmRvdy5BY3RpdmVYT2JqZWN0ICYmICEod2luZG93LlhNTEh0dHBSZXF1ZXN0ICYmIChuZXcgWE1MSHR0cFJlcXVlc3QpLmRpc3BhdGNoRXZlbnQpOwogICAgCiAgICAvLyBNYXAgZnJvbSBDUlVEIHRvIEhUVFAgZm9yIG91ciBkZWZhdWx0IGBIYWNrYm9uZS5zeW5jYCBpbXBsZW1lbnRhdGlvbi4KICAgIHZhciBtZXRob2RNYXAgPSBIYWNrYm9uZS5zeW5jLmh0dHBNYXAgPSB7CiAgICAgICAgJ2NyZWF0ZSc6ICdQT1NUJywKICAgICAgICAndXBkYXRlJzogJ1BVVCcsCiAgICAgICAgJ3BhdGNoJzogJ1BBVENIJywKICAgICAgICAnZGVsZXRlJzogJ0RFTEVURScsCiAgICAgICAgJ3JlYWQnOiAnR0VUJwogICAgfTsKICAgIAogICAgLy8gU2V0IHRoZSBkZWZhdWx0IGltcGxlbWVudGF0aW9uIG9mIGBIYWNrYm9uZS5hamF4YCB0byBwcm94eSB0aHJvdWdoIHRvIGAkYC4KICAgIC8vIE92ZXJyaWRlIHRoaXMgaWYgeW91J2QgbGlrZSB0byB1c2UgYSBkaWZmZXJlbnQgbGlicmFyeS4KICAgIEhhY2tib25lLmFqYXggPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIEhhY2tib25lLiQuYWpheC5hcHBseShIYWNrYm9uZS4kLCBhcmd1bWVudHMpOwogICAgfTsKCiAgICAvLyBCYWNrYm9uZS5CYXNlVmlldwogICAgLy8gLS0tLS0tLS0tLS0tLQogICAgCiAgICAvLyBIYWNrYm9uZSBCYXNlVmlld3MgYXJlIGFsbW9zdCBtb3JlIGNvbnZlbnRpb24gdGhhbiB0aGV5IGFyZSBhY3R1YWwgY29kZS4gQSBCYXNlVmlldwogICAgLy8gaXMgc2ltcGx5IGEgSmF2YVNjcmlwdCBvYmplY3QgdGhhdCByZXByZXNlbnRzIGEgbG9naWNhbCBjaHVuayBvZiBVSSBpbiB0aGUKICAgIC8vIERPTS4gVGhpcyBtaWdodCBiZSBhIHNpbmdsZSBpdGVtLCBhbiBlbnRpcmUgbGlzdCwgYSBzaWRlYmFyIG9yIHBhbmVsLCBvcgogICAgLy8gZXZlbiB0aGUgc3Vycm91bmRpbmcgZnJhbWUgd2hpY2ggd3JhcHMgeW91ciB3aG9sZSBhcHAuIERlZmluaW5nIGEgY2h1bmsgb2YKICAgIC8vIFVJIGFzIGEgKipWaWV3KiogYWxsb3dzIHlvdSB0byBkZWZpbmUgeW91ciBET00gZXZlbnRzIGRlY2xhcmF0aXZlbHksIHdpdGhvdXQKICAgIC8vIGhhdmluZyB0byB3b3JyeSBhYm91dCByZW5kZXIgb3JkZXIuCiAgICAKICAgIC8vIEhhY2tib25lIEJhc2VWaWV3IGluc3RhbmNlcyBhcmUgZ2VuZXJpYyBNVkMvTVZQIHBhdHRlcm4gdmlld3MuIFRoZXkgYXJlICdjb250cm9sbGVkJwogICAgLy8gYnkgdGhlIG9iamVjdCBjb250YWluaW5nIHRoZSB2aWV3IGluc3RhbmNlIGFuZCB0aGV5IGhhdmUgbm8gcmVmZXJlbmNlIHRvIGFueQogICAgLy8gSGFja2JvbmUuTW9kZWwgb3IgSGFja2JvbmUuQ29sbGVjdGlvbiBpbnN0YW5jZS4KICAgIAogICAgLy8gT3B0aW9ucyB3aXRoIHNwZWNpYWwgbWVhbmluZyAqKGUuZy4gbW9kZWwsIGNvbGxlY3Rpb24sIGlkLCBjbGFzc05hbWUpKiBhcmUKICAgIC8vIGF0dGFjaGVkIGRpcmVjdGx5IHRvIHRoZSB2aWV3LiAgU2VlIGBiYXNlVmlld09wdGlvbnNgIGZvciBhbiBleGhhdXN0aXZlCiAgICAvLyBsaXN0LgogICAgCiAgICAvLyBDcmVhdGluZyBhIEhhY2tib25lLkJhc2VWaWV3IGNyZWF0ZXMgaXRzIGluaXRpYWwgZWxlbWVudCBvdXRzaWRlIG9mIHRoZSBET00sCiAgICAvLyBpZiBhbiBleGlzdGluZyBlbGVtZW50IGlzIG5vdCBwcm92aWRlZC4uLgogICAgCiAgICAvLyBTZXQgdXAgYWxsIGluaGVyaXRhYmxlICoqSGFja2JvbmUuQmFzZVZpZXcqKiBwcm9wZXJ0aWVzIGFuZCBtZXRob2RzLgogICAgdmFyIEJhc2VWaWV3ID0gSGFja2JvbmUuQmFzZVZpZXcgPSBDb21wb25lbnQuZXh0ZW5kKHsKICAgICAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24gKG9wdGlvbnMpIHsKICAgICAgICAgICAgdGhpcy5jaWQgPSBfLnVuaXF1ZUlkKCd2aWV3Jyk7CiAgICAgICAgICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CiAgICAgICAgICAgIF8uZXh0ZW5kKHRoaXMsIF8ucGljayhvcHRpb25zLCBCYXNlVmlldy52aWV3T3B0aW9ucykpOwogICAgICAgICAgICB0aGlzLl9lbnN1cmVFbGVtZW50KCk7CiAgICAgICAgICAgIHRoaXMuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgICB0aGlzLmRlbGVnYXRlRXZlbnRzKCk7CiAgICAgICAgfSwKICAgIAogICAgICAgIC8vIFRoZSBkZWZhdWx0IGB0YWdOYW1lYCBvZiBhIEJhc2VWaWV3J3MgZWxlbWVudCBpcyBgImRpdiJgLgogICAgICAgIHRhZ05hbWU6ICdkaXYnLAogICAgCiAgICAgICAgLy8galF1ZXJ5IGRlbGVnYXRlIGZvciBlbGVtZW50IGxvb2t1cCwgc2NvcGVkIHRvIERPTSBlbGVtZW50cyB3aXRoaW4gdGhlCiAgICAgICAgLy8gY3VycmVudCB2aWV3LiBUaGlzIHNob3VsZCBiZSBwcmVmZXJlZCB0byBnbG9iYWwgbG9va3VwcyB3aGVyZSBwb3NzaWJsZS4KICAgICAgICAkOiBmdW5jdGlvbiAoc2VsZWN0b3IpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuJGVsLmZpbmQoc2VsZWN0b3IpOwogICAgICAgIH0sCiAgICAKICAgICAgICAvLyAqKnJlbmRlcioqIGlzIHRoZSBjb3JlIGZ1bmN0aW9uIHRoYXQgeW91ciB2aWV3IHNob3VsZCBvdmVycmlkZSwgaW4gb3JkZXIKICAgICAgICAvLyB0byBwb3B1bGF0ZSBpdHMgZWxlbWVudCAoYHRoaXMuZWxgKSwgd2l0aCB0aGUgYXBwcm9wcmlhdGUgSFRNTC4gVGhlCiAgICAgICAgLy8gY29udmVudGlvbiBpcyBmb3IgKipyZW5kZXIqKiB0byBhbHdheXMgcmV0dXJuIGB0aGlzYC4KICAgICAgICByZW5kZXI6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSwKICAgIAogICAgICAgIC8vIFJlbW92ZSB0aGlzIHZpZXcgYnkgdGFraW5nIHRoZSBlbGVtZW50IG91dCBvZiB0aGUgRE9NLCBhbmQgcmVtb3ZpbmcgYW55CiAgICAgICAgLy8gYXBwbGljYWJsZSBIYWNrYm9uZS5FdmVudHMgbGlzdGVuZXJzLgogICAgICAgIHJlbW92ZTogZnVuY3Rpb24gKCkgewogICAgICAgICAgICB0aGlzLiRlbC5yZW1vdmUoKTsKICAgICAgICAgICAgdGhpcy5zdG9wTGlzdGVuaW5nKCk7CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCiAgICAKICAgICAgICAvLyBEZXN0cm95cyB0aGUgQmFzZVZpZXcgYnkgaW52b2tpbmcgdGhlIEJhc2VWaWV3I3JlbW92ZSBtZXRob2QuCiAgICAgICAgLy8gQ29udmVuaWVuY2UgbWV0aG9kIGZvciBleHRlbmRpbmcgYmFzZSBDb21wb25lbnQuCiAgICAgICAgZGVzdHJveTogZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5yZW1vdmUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICB9LAogICAgCiAgICAgICAgLy8gQ2hhbmdlIHRoZSB2aWV3J3MgZWxlbWVudCAoYHRoaXMuZWxgIHByb3BlcnR5KSwgaW5jbHVkaW5nIGV2ZW50CiAgICAgICAgLy8gcmUtZGVsZWdhdGlvbi4KICAgICAgICBzZXRFbGVtZW50OiBmdW5jdGlvbiAoZWxlbWVudCwgZGVsZWdhdGUpIHsKICAgICAgICAgICAgaWYgKHRoaXMuJGVsKSB0aGlzLnVuZGVsZWdhdGVFdmVudHMoKTsKICAgICAgICAgICAgdGhpcy4kZWwgPSBlbGVtZW50IGluc3RhbmNlb2YgSGFja2JvbmUuJCA/IGVsZW1lbnQgOiBIYWNrYm9uZS4kKGVsZW1lbnQpOwogICAgICAgICAgICB0aGlzLmVsID0gdGhpcy4kZWxbMF07CiAgICAgICAgICAgIGlmIChkZWxlZ2F0ZSAhPT0gZmFsc2UpIHRoaXMuZGVsZWdhdGVFdmVudHMoKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSwKICAgIAogICAgICAgIC8vIFNldCBjYWxsYmFja3MsIHdoZXJlIGB0aGlzLmV2ZW50c2AgaXMgYSBoYXNoIG9mCiAgICAgICAgLy8KICAgICAgICAvLyAqeyJldmVudCBzZWxlY3RvciI6ICJjYWxsYmFjayJ9KgogICAgICAgIC8vCiAgICAgICAgLy8gICAgIHsKICAgICAgICAvLyAgICAgICAnbW91c2Vkb3duIC50aXRsZSc6ICAnZWRpdCcsCiAgICAgICAgLy8gICAgICAgJ2NsaWNrIC5idXR0b24nOiAgICAgJ3NhdmUnLAogICAgICAgIC8vICAgICAgICdjbGljayAub3Blbic6ICAgICAgIGZ1bmN0aW9uKGUpIHsgLi4uIH0KICAgICAgICAvLyAgICAgfQogICAgICAgIC8vCiAgICAgICAgLy8gcGFpcnMuIENhbGxiYWNrcyB3aWxsIGJlIGJvdW5kIHRvIHRoZSB2aWV3LCB3aXRoIGB0aGlzYCBzZXQgcHJvcGVybHkuCiAgICAgICAgLy8gVXNlcyBldmVudCBkZWxlZ2F0aW9uIGZvciBlZmZpY2llbmN5LgogICAgICAgIC8vIE9taXR0aW5nIHRoZSBzZWxlY3RvciBiaW5kcyB0aGUgZXZlbnQgdG8gYHRoaXMuZWxgLgogICAgICAgIC8vIFRoaXMgb25seSB3b3JrcyBmb3IgZGVsZWdhdGUtYWJsZSBldmVudHM6IG5vdCBgZm9jdXNgLCBgYmx1cmAsIGFuZAogICAgICAgIC8vIG5vdCBgY2hhbmdlYCwgYHN1Ym1pdGAsIGFuZCBgcmVzZXRgIGluIEludGVybmV0IEV4cGxvcmVyLgogICAgICAgIGRlbGVnYXRlRXZlbnRzOiBmdW5jdGlvbiAoZXZlbnRzKSB7CiAgICAgICAgICAgIGlmICghKGV2ZW50cyB8fCAoZXZlbnRzID0gXy5yZXN1bHQodGhpcywgJ2V2ZW50cycpKSkpIHJldHVybiB0aGlzOwogICAgICAgICAgICB0aGlzLnVuZGVsZWdhdGVFdmVudHMoKTsKICAgICAgICAgICAgZm9yICh2YXIga2V5IGluIGV2ZW50cykgewogICAgICAgICAgICAgICAgaWYgKGV2ZW50cy5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIG1ldGhvZCA9IGV2ZW50c1trZXldOwogICAgICAgICAgICAgICAgICAgIGlmICghXy5pc0Z1bmN0aW9uKG1ldGhvZCkpIG1ldGhvZCA9IHRoaXNbZXZlbnRzW2tleV1dOwogICAgICAgICAgICAgICAgICAgIGlmICghbWV0aG9kKSBjb250aW51ZTsKICAgIAogICAgICAgICAgICAgICAgICAgIHZhciBtYXRjaCA9IGtleS5tYXRjaChkZWxlZ2F0ZUV2ZW50U3BsaXR0ZXIpOwogICAgICAgICAgICAgICAgICAgIHZhciBldmVudE5hbWUgPSBtYXRjaFsxXSwgc2VsZWN0b3IgPSBtYXRjaFsyXTsKICAgICAgICAgICAgICAgICAgICBtZXRob2QgPSBfLmJpbmQobWV0aG9kLCB0aGlzKTsKICAgICAgICAgICAgICAgICAgICBldmVudE5hbWUgKz0gJy5kZWxlZ2F0ZUV2ZW50cycgKyB0aGlzLmNpZDsKICAgICAgICAgICAgICAgICAgICBpZiAoc2VsZWN0b3IgPT09ICcnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuJGVsLm9uKGV2ZW50TmFtZSwgbWV0aG9kKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLiRlbC5vbihldmVudE5hbWUsIHNlbGVjdG9yLCBtZXRob2QpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9LAogICAgCiAgICAgICAgLy8gQ2xlYXJzIGFsbCBjYWxsYmFja3MgcHJldmlvdXNseSBib3VuZCB0byB0aGUgdmlldyB3aXRoIGBkZWxlZ2F0ZUV2ZW50c2AuCiAgICAgICAgLy8gWW91IHVzdWFsbHkgZG9uJ3QgbmVlZCB0byB1c2UgdGhpcywgYnV0IG1heSB3aXNoIHRvIGlmIHlvdSBoYXZlIG11bHRpcGxlCiAgICAgICAgLy8gSGFja2JvbmUgdmlld3MgYXR0YWNoZWQgdG8gdGhlIHNhbWUgRE9NIGVsZW1lbnQuCiAgICAgICAgdW5kZWxlZ2F0ZUV2ZW50czogZnVuY3Rpb24gKCkgewogICAgICAgICAgICB0aGlzLiRlbC5vZmYoJy5kZWxlZ2F0ZUV2ZW50cycgKyB0aGlzLmNpZCk7CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCiAgICAKICAgICAgICAvLyBFbnN1cmUgdGhhdCB0aGUgQmFzZVZpZXcgaGFzIGEgRE9NIGVsZW1lbnQgdG8gcmVuZGVyIGludG8uCiAgICAgICAgLy8gSWYgYHRoaXMuZWxgIGlzIGEgc3RyaW5nLCBwYXNzIGl0IHRocm91Z2ggYCQoKWAsIHRha2UgdGhlIGZpcnN0CiAgICAgICAgLy8gbWF0Y2hpbmcgZWxlbWVudCwgYW5kIHJlLWFzc2lnbiBpdCB0byBgZWxgLiBPdGhlcndpc2UsIGNyZWF0ZQogICAgICAgIC8vIGFuIGVsZW1lbnQgZnJvbSB0aGUgYGlkYCwgYGNsYXNzTmFtZWAgYW5kIGB0YWdOYW1lYCBwcm9wZXJ0aWVzLgogICAgICAgIF9lbnN1cmVFbGVtZW50OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5lbCkgewogICAgICAgICAgICAgICAgdmFyIGF0dHJzID0gXy5leHRlbmQoe30sIF8ucmVzdWx0KHRoaXMsICdhdHRyaWJ1dGVzJykpOwogICAgICAgICAgICAgICAgaWYgKHRoaXMuaWQpIGF0dHJzLmlkID0gXy5yZXN1bHQodGhpcywgJ2lkJyk7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5jbGFzc05hbWUpIGF0dHJzWydjbGFzcyddID0gXy5yZXN1bHQodGhpcywgJ2NsYXNzTmFtZScpOwogICAgICAgICAgICAgICAgdmFyICRlbCA9IEhhY2tib25lLiQoJzwnICsgXy5yZXN1bHQodGhpcywgJ3RhZ05hbWUnKSArICc+JykuYXR0cihhdHRycyk7CiAgICAgICAgICAgICAgICB0aGlzLnNldEVsZW1lbnQoJGVsLCBmYWxzZSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLnNldEVsZW1lbnQoXy5yZXN1bHQodGhpcywgJ2VsJyksIGZhbHNlKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0sIEV2ZW50cyk7CiAgICAKICAgIC8vIExpc3Qgb2YgdmlldyBvcHRpb25zIHRvIGJlIG1lcmdlZCBhcyBwcm9wZXJ0aWVzLgogICAgQmFzZVZpZXcudmlld09wdGlvbnMgPSBbJ2VsJywgJ2lkJywgJ2F0dHJpYnV0ZXMnLCAnY2xhc3NOYW1lJywgJ3RhZ05hbWUnLCAnZXZlbnRzJ107CiAgICAKICAgIF8uZXh0ZW5kKEJhc2VWaWV3LnByb3RvdHlwZSwgRXZlbnRzKTsKICAgIAogICAgLy8gQ2FjaGVkIHJlZ2V4IHRvIHNwbGl0IGtleXMgZm9yIGBkZWxlZ2F0ZWAuCiAgICB2YXIgZGVsZWdhdGVFdmVudFNwbGl0dGVyID0gL14oXFMrKVxzKiguKikkLzsKCiAgICAvLyBIYWNrYm9uZS5WaWV3CiAgICAvLyAtLS0tLS0tLS0tLS0tCiAgICAKICAgIC8vIE9wdGlvbnMgd2l0aCBzcGVjaWFsIG1lYW5pbmcgKihlLmcuIG1vZGVsLCBjb2xsZWN0aW9uLCBpZCwgY2xhc3NOYW1lKSogYXJlCiAgICAvLyBhdHRhY2hlZCBkaXJlY3RseSB0byB0aGUgdmlldy4gIFNlZSBgdmlld09wdGlvbnNgIGZvciBhbiBleGhhdXN0aXZlCiAgICAvLyBsaXN0LgogICAgCiAgICAvLyBTZXQgdXAgYWxsIGluaGVyaXRhYmxlICoqSGFja2JvbmUuVmlldyoqIHByb3BlcnRpZXMgYW5kIG1ldGhvZHMuCiAgICB2YXIgVmlldyA9IEhhY2tib25lLlZpZXcgPSBCYXNlVmlldy5leHRlbmQoewogICAgICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbiAob3B0aW9ucykgewogICAgICAgICAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwogICAgICAgICAgICBfLmV4dGVuZCh0aGlzLCBfLnBpY2sob3B0aW9ucywgVmlldy52aWV3T3B0aW9ucykpOwogICAgICAgICAgICBCYXNlVmlldy5jYWxsKHRoaXMsIG9wdGlvbnMpOwogICAgICAgIH0KICAgIH0sIHsKICAgICAgICAvLyBMaXN0IG9mIHZpZXcgb3B0aW9ucyB0byBiZSBtZXJnZWQgYXMgcHJvcGVydGllcy4KICAgICAgICB2aWV3T3B0aW9uczogWydtb2RlbCcsICdjb2xsZWN0aW9uJ10KICAgIH0pOwoKICAgIHZhciBDYWNoZSA9IEhhY2tib25lLkNhY2hlID0gQmFzZS5leHRlbmQoewogICAgICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHRoaXMucm9vdCA9IHt9OwogICAgICAgIH0sCiAgICAKICAgICAgICAvLyBOb24tQVBJIG1ldGhvZC4gQ3JlYXRlcyBhIHBhdGggb24gZ2l2ZW4gcm9vdCBvciB0aGUgQ2FjaGUjcm9vdC4KICAgICAgICBfY3JlYXRlOiBmdW5jdGlvbiAocGF0aCwgcm9vdCkgewogICAgICAgICAgICB2YXIgYnJhbmNoOwogICAgICAgICAgICB2YXIgdHJlZSA9IChyb290IHx8IHRoaXMucm9vdCk7CiAgICAKICAgICAgICAgICAgd2hpbGUgKHBhdGgubGVuZ3RoID4gMCAmJiB0cmVlKSB7CiAgICAgICAgICAgICAgICBicmFuY2ggPSBwYXRoLnNoaWZ0KCk7CiAgICAgICAgICAgICAgICB0cmVlW2JyYW5jaF0gfHwgKHRyZWVbYnJhbmNoXSA9IHt9KTsKICAgICAgICAgICAgICAgIHRyZWUgPSB0cmVlW2JyYW5jaF07CiAgICAgICAgICAgIH0KICAgIAogICAgICAgICAgICByZXR1cm4gdHJlZTsKICAgICAgICB9LAogICAgCiAgICAgICAgLy8gTm9uLUFQSSBtZXRob2QuIERpZ3MgYSBwYXRoIG9uIHRoZSBnaXZlbiByb290IG9yIHRoZSBDYWNoZSNyb290LgogICAgICAgIF9yZXNvbHZlOiBmdW5jdGlvbiAocmF3UGF0aCwgcm9vdCkgewogICAgICAgICAgICB2YXIgcmVzb2x2ZWQsIHBhdGg7CiAgICAKICAgICAgICAgICAgaWYgKHJhd1BhdGggaW5zdGFuY2VvZiBBcnJheSkgewogICAgICAgICAgICAgICAgcGF0aCA9IHJhd1BhdGg7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBwYXRoID0gKHJhd1BhdGgudG9TdHJpbmcoKS5zcGxpdCgiLiIpIHx8IFtdKTsKICAgICAgICAgICAgfQogICAgCiAgICAgICAgICAgIGlmIChwYXRoLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgIHJlc29sdmVkID0gKHJvb3QgfHwgdGhpcy5yb290KTsKICAgIAogICAgICAgICAgICAgICAgd2hpbGUgKHBhdGgubGVuZ3RoID4gMCAmJiByZXNvbHZlZCkgewogICAgICAgICAgICAgICAgICAgIHJlc29sdmVkID0gcmVzb2x2ZWRbcGF0aC5zaGlmdCgpXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgCiAgICAgICAgICAgIHJldHVybiByZXNvbHZlZDsKICAgICAgICB9LAogICAgCiAgICAgICAgLy8gUXVlcmllcyB0aGUgc3BlY2lmaWVkIGJyYW5jaChlcykgaW4gdGhlIENhY2hlLgogICAgICAgIC8vIFRha2VzIGFuIEFycmF5IG9mIFN0cmluZ3MsIE1hcCBvZiBzdHJpbmdzIG9yIGEgU3RyaW5nLgogICAgICAgIGdldDogZnVuY3Rpb24gKGFyZykgewogICAgICAgICAgICB2YXIgcmVzdWx0LCBpOwogICAgCiAgICAgICAgICAgIGlmIChhcmcgaW5zdGFuY2VvZiBBcnJheSkgewogICAgICAgICAgICAgICAgcmVzdWx0ID0gW107CiAgICAKICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBhcmcubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICByZXN1bHRbaV0gPSB0aGlzLl9yZXNvbHZlKGFyZ1tpXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAoYXJnIGluc3RhbmNlb2YgT2JqZWN0KSB7CiAgICAgICAgICAgICAgICByZXN1bHQgPSB7fTsKICAgIAogICAgICAgICAgICAgICAgZm9yIChpIGluIGFyZykgewogICAgICAgICAgICAgICAgICAgIGlmIChhcmcuaGFzT3duUHJvcGVydHkoaSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0W2ldID0gdGhpcy5fcmVzb2x2ZShhcmdbaV0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChhcmd1bWVudHMubGVuZ3RoID4gMSkgewogICAgICAgICAgICAgICAgcmVzdWx0ID0gdGhpcy5nZXQoQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAwKSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGFyZyA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgICAgIHJlc3VsdCA9IHRoaXMuX3Jlc29sdmUoYXJnKTsKICAgICAgICAgICAgfQogICAgCiAgICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgfSwKICAgIAogICAgICAgIC8vIENyZWF0ZXMgdGhlIHNwZWNpZmllZCBicmFuY2goZXMpIGluIHRoZSBDYWNoZS4KICAgICAgICAvLyBUYWtlcyBhbiBBcnJheSBvZiBTdHJpbmdzLCBNYXAgb2Ygc3RyaW5ncyBvciBhIFN0cmluZy4KICAgICAgICBzZXQ6IGZ1bmN0aW9uIChhcmcsIHZhbHVlKSB7CiAgICAgICAgICAgIHZhciBwYXRoLCBuYW1lLCByb290OwogICAgCiAgICAgICAgICAgIGlmIChhcmcgaW5zdGFuY2VvZiBPYmplY3QpIHsKICAgICAgICAgICAgICAgIGZvciAobmFtZSBpbiBhcmcpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoYXJnLmhhc093blByb3BlcnR5KG5hbWUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2V0KG5hbWUsIGFyZ1tuYW1lXSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBhcmcgPT0gJ3N0cmluZycgJiYgdHlwZW9mIHZhbHVlICE9PSAndW5kZWZpbmVkJykgewogICAgICAgICAgICAgICAgcGF0aCA9IGFyZy5zcGxpdCgiLiIpOwogICAgICAgICAgICAgICAgbmFtZSA9IHBhdGgucG9wKCk7CiAgICAgICAgICAgICAgICByb290ID0gdGhpcy5fY3JlYXRlKHBhdGgpOwogICAgICAgICAgICAgICAgcm9vdFtuYW1lXSA9IHZhbHVlOwogICAgICAgICAgICB9CiAgICAKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSwKICAgIAogICAgICAgIC8vIFJlbW92ZXMgdGhlIHNwZWNpZmllZCBicmFuY2ggZnJvbSB0aGUgQ2FjaGUuCiAgICAgICAgLy8gVGFrZXMgYW4gQXJyYXkgb2YgU3RyaW5ncywgTWFwIG9mIHN0cmluZ3Mgb3IgYSBTdHJpbmcuCiAgICAgICAgdW5zZXQ6IGZ1bmN0aW9uIChhcmcpIHsKICAgICAgICAgICAgdmFyIHBhdGgsIG5hbWUsIHJvb3QsIGk7CiAgICAKICAgICAgICAgICAgaWYgKGFyZyBpbnN0YW5jZW9mIEFycmF5KSB7CiAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgYXJnLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy51bnNldChhcmdbaV0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKGFyZyBpbnN0YW5jZW9mIE9iamVjdCkgewogICAgICAgICAgICAgICAgZm9yIChuYW1lIGluIGFyZykgewogICAgICAgICAgICAgICAgICAgIGlmIChhcmcuaGFzT3duUHJvcGVydHkobmFtZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy51bnNldChuYW1lLCBhcmdbbmFtZV0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgYXJnID09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgICAgICBwYXRoID0gYXJnLnNwbGl0KCIuIik7CiAgICAgICAgICAgICAgICBuYW1lID0gcGF0aC5wb3AoKTsKICAgICAgICAgICAgICAgIHJvb3QgPSB0aGlzLl9yZXNvbHZlKHBhdGgpOwogICAgICAgICAgICAgICAgZGVsZXRlIHJvb3RbbmFtZV07CiAgICAgICAgICAgIH0KICAgIAogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9CiAgICB9KTsKCiAgICAvLyBHZW5lcmljIGNsYXNzIGZvciBoYW5kbGluZyBjaGlsZHJlbiBpbiBvcmRlciAtIHdlbGwsIG9yIG5vdC4uLgogICAgdmFyIENvbXBvc2l0ZSA9IEhhY2tib25lLkNvbXBvc2l0ZSA9IENvbXBvbmVudC5leHRlbmQoewogICAgICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHRoaXMuY2hpbGRyZW4gPSB7fTsKICAgICAgICAgICAgdGhpcy5vcmRlciA9IFtdOwogICAgICAgIH0sCiAgICAKICAgICAgICAvLyBBZGRzIGEgbmV3IGl0ZW0gaW50byB0aGUgb3JkZXIKICAgICAgICBhZGQ6IGZ1bmN0aW9uIChhcmcsIGl0ZW0pIHsKICAgICAgICAgICAgdmFyIGNoaWxkcmVuID0gdGhpcy5jaGlsZHJlbjsKICAgICAgICAgICAgdmFyIG9yZGVyID0gdGhpcy5vcmRlcjsKICAgICAgICAgICAgdmFyIGk7CiAgICAKICAgICAgICAgICAgaWYgKHR5cGVvZiBhcmcgPT09ICJzdHJpbmciICYmIGl0ZW0gJiYgIWNoaWxkcmVuLmhhc093blByb3BlcnR5KGFyZykpIHsKICAgICAgICAgICAgICAgIGNoaWxkcmVuW2FyZ10gPSBpdGVtOwogICAgICAgICAgICAgICAgb3JkZXIucHVzaChhcmcpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBhcmcgPT09ICJudW1iZXIiICYmICFpc05hTihhcmcpICYmIGFyZyA+PSAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLmFkZChhcmcudG9TdHJpbmcoKSwgaXRlbSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoYXJnIGluc3RhbmNlb2YgQXJyYXkpIHsKICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBhcmcubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBpZiAob3JkZXIuaW5kZXhPZihhcmdbaV0pIDwgMCkgewogICAgICAgICAgICAgICAgICAgICAgICBjaGlsZHJlbltvcmRlci5sZW5ndGhdID0gYXJnW2ldOwogICAgICAgICAgICAgICAgICAgICAgICBvcmRlci5wdXNoKG9yZGVyLmxlbmd0aCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKGFyZyBpbnN0YW5jZW9mIE9iamVjdCkgewogICAgICAgICAgICAgICAgZm9yIChpIGluIGFyZykgewogICAgICAgICAgICAgICAgICAgIGlmIChhcmcuaGFzT3duUHJvcGVydHkoaSkgJiYgIWNoaWxkcmVuLmhhc093blByb3BlcnR5KGkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkcmVuW2ldID0gYXJnW2ldOwogICAgICAgICAgICAgICAgICAgICAgICBvcmRlci5wdXNoKGkpCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSwKICAgIAogICAgICAgIC8vUmV0dXJucyBhIGNoaWxkIGJ5IGl0J3MgbmFtZSBvciBieSB0aGUgb3JkZXIgc3BlY2lmaWVkLgogICAgICAgIGdldDogZnVuY3Rpb24gKGFyZykgewogICAgICAgICAgICByZXR1cm4gKHRoaXMuZ2V0QnlOYW1lKGFyZykgfHwgdGhpcy5nZXRCeU9yZGVyKGFyZykpOwogICAgICAgIH0sCiAgICAKICAgICAgICAvLyBEZXRlcm1pbmVzIHdoZXRoZXIgdGhlIENvbXBvc2l0ZSBjb250YWlucyBhbmQgaXRlbS4KICAgICAgICBjb250YWluczogZnVuY3Rpb24gKGFyZykgewogICAgICAgICAgICB2YXIgY2hpbGRyZW4gPSB0aGlzLmNoaWxkcmVuOwogICAgICAgICAgICB2YXIgcmVzdWx0ID0gISF0aGlzLmdldChhcmcpOwogICAgICAgICAgICB2YXIga2V5OwogICAgCiAgICAgICAgICAgIGlmICghcmVzdWx0KSB7CiAgICAgICAgICAgICAgICBmb3IgKGtleSBpbiBjaGlsZHJlbikgewogICAgICAgICAgICAgICAgICAgIGlmIChjaGlsZHJlbi5oYXNPd25Qcm9wZXJ0eShrZXkpICYmIGNoaWxkcmVuW2tleV0gPT09IGFyZykgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgIAogICAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0sCiAgICAKICAgICAgICAvLyBSZXR1cm5zIGEgY2hpbGQgYnkgaXQncyBuYW1lLgogICAgICAgIGdldEJ5TmFtZTogZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuY2hpbGRyZW5bbmFtZV07CiAgICAgICAgfSwKICAgIAogICAgICAgIC8vIFJldHVybnMgYSBjaGlsZCBieSB0aGUgb3JkZXIgc3BlY2lmaWVkLgogICAgICAgIGdldEJ5T3JkZXI6IGZ1bmN0aW9uIChpZCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5jaGlsZHJlblt0aGlzLm9yZGVyW2lkXV07CiAgICAgICAgfSwKICAgIAogICAgICAgIC8vIFJlbW92ZXMgYSBjaGlsZCBieSBpdCdzIG5hbWUgb3IgYnkgdGhlIG9yZGVyIHNwZWNpZmllZC4KICAgICAgICByZW1vdmU6IGZ1bmN0aW9uIChhcmcpIHsKICAgICAgICAgICAgdmFyIGNoaWxkcmVuID0gdGhpcy5jaGlsZHJlbjsKICAgICAgICAgICAgdmFyIG9yZGVyID0gdGhpcy5vcmRlcjsKICAgICAgICAgICAgdmFyIGtleSwgaWQsIGk7CiAgICAKICAgICAgICAgICAgaWYgKHR5cGVvZiBhcmcgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgICBpZCA9IF8uaW5kZXhPZihvcmRlciwgYXJnKTsKICAgICAgICAgICAgICAgIGRlbGV0ZSBjaGlsZHJlbltvcmRlcltpZF1dOwogICAgICAgICAgICAgICAgb3JkZXIuc3BsaWNlKGlkLCAxKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgYXJnID09PSAibnVtYmVyIiAmJiAhaXNOYU4oYXJnKSAmJiBhcmcgPiAtMSkgewogICAgICAgICAgICAgICAgdGhpcy5yZW1vdmUoYXJnLnRvU3RyaW5nKCkpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGFyZykgewogICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IG9yZGVyLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAga2V5ID0gb3JkZXJbaV07CiAgICAgICAgICAgICAgICAgICAgaWYgKGNoaWxkcmVuW2tleV0gPT09IGFyZykgewogICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgY2hpbGRyZW5ba2V5XTsKICAgICAgICAgICAgICAgICAgICAgICAgb3JkZXIuc3BsaWNlKGksIDEpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgCiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCiAgICAKICAgICAgICAvL0Rlc3Ryb3lzIGFuZCByZW1vdmVzIGFsbCBjaGlsZHJlbgogICAgICAgIHJlbW92ZUFsbDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgY2hpbGRyZW4gPSB0aGlzLmNoaWxkcmVuOwogICAgICAgICAgICB2YXIgb3JkZXIgPSB0aGlzLm9yZGVyOwogICAgICAgICAgICB2YXIgY2hpbGQ7CiAgICAKICAgICAgICAgICAgd2hpbGUgKG9yZGVyLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgIGNoaWxkID0gb3JkZXJbMF07CiAgICAgICAgICAgICAgICBjaGlsZHJlbltjaGlsZF0uZGVzdHJveSgpOwogICAgICAgICAgICAgICAgdGhpcy5yZW1vdmUoY2hpbGQpOwogICAgICAgICAgICB9CiAgICAKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSwKICAgIAogICAgICAgIC8vIEV4ZWN1dGVzIHRoZSBzcGVjaWZpZWQgZnVuY3Rpb24gb24gZWFjaCBjaGlsZC4KICAgICAgICBlYWNoOiBmdW5jdGlvbiAocHJvYykgewogICAgICAgICAgICB2YXIgY2hpbGRyZW4gPSB0aGlzLmNoaWxkcmVuOwogICAgICAgICAgICB2YXIgb3JkZXIgPSB0aGlzLm9yZGVyOwogICAgICAgICAgICB2YXIgaSA9IDA7CiAgICAgICAgICAgIHZhciBjaGlsZDsKICAgIAogICAgICAgICAgICBpZiAodHlwZW9mIHByb2MgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIGZvciAoOyBpIDwgb3JkZXIubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBjaGlsZCA9IGNoaWxkcmVuW29yZGVyW2ldXTsKICAgICAgICAgICAgICAgICAgICBwcm9jLmNhbGwodGhpcywgY2hpbGQsIG9yZGVyW2ldKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgCiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCiAgICAKICAgICAgICAvLyBJbnZva2VzIHRoZSBzcGVjaWZpZWQgbWV0aG9kIG9uIGVhY2ggY2hpbGQgd2l0aCB0aGUgcmVtYWluaW5nIGFyZ3VtZW50cy4KICAgICAgICBpbnZva2U6IGZ1bmN0aW9uIChtZXRob2QpIHsKICAgICAgICAgICAgdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwogICAgICAgICAgICB2YXIgY2hpbGRyZW4gPSB0aGlzLmNoaWxkcmVuOwogICAgICAgICAgICB2YXIgb3JkZXIgPSB0aGlzLm9yZGVyOwogICAgICAgICAgICB2YXIgaSA9IDA7CiAgICAKICAgICAgICAgICAgZm9yICg7IGkgPCBvcmRlci5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIGNoaWxkcmVuW29yZGVyW2ldXVttZXRob2RdKGFyZ3MpOwogICAgICAgICAgICB9CiAgICAKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSwKICAgIAogICAgICAgIC8vRmluZHMgdGhlIGZpcnN0IGNoaWxkIGJhc2VkIG9uIHRoZSBnaXZlbiBjb21wYXJhdG9yIGZ1bmN0aW9uLgogICAgICAgIGZpbmQ6IGZ1bmN0aW9uIChjb21wYXJhdG9yKSB7CiAgICAgICAgICAgIHZhciBjaGlsZHJlbiA9IHRoaXMuY2hpbGRyZW47CiAgICAgICAgICAgIHZhciBvcmRlciA9IHRoaXMub3JkZXI7CiAgICAgICAgICAgIHZhciBpID0gMDsKICAgICAgICAgICAgdmFyIGNoaWxkOwogICAgCiAgICAgICAgICAgIGlmICh0eXBlb2YgY29tcGFyYXRvciA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgZm9yICg7IGkgPCBvcmRlci5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGNoaWxkID0gY2hpbGRyZW5bb3JkZXJbaV1dOwogICAgCiAgICAgICAgICAgICAgICAgICAgaWYgKGNvbXBhcmF0b3IuY2FsbCh0aGlzLCBjaGlsZCwgb3JkZXJbaV0pKSB7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gY2hpbGQ7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgIAogICAgICAgIC8vIE92ZXJyaWRlcyBDb21wb25lbnQjZGVzdHJveSBtZXRob2QuCiAgICAgICAgZGVzdHJveTogZnVuY3Rpb24gKCkgewogICAgICAgICAgICB0aGlzLnJlbW92ZUFsbCgpOwogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9CiAgICB9KTsKCiAgICAvLyBCYWNrYm9uZS5Nb2RlbAogICAgLy8gLS0tLS0tLS0tLS0tLS0KICAgIAogICAgLy8gSGFja2JvbmUgKipNb2RlbHMqKiBhcmUgdGhlIGJhc2ljIGRhdGEgb2JqZWN0IGluIHRoZSBmcmFtZXdvcmsgLS0KICAgIC8vIGZyZXF1ZW50bHkgcmVwcmVzZW50aW5nIGEgcm93IGluIGEgdGFibGUgaW4gYSBkYXRhYmFzZSBvbiB5b3VyIHNlcnZlci4KICAgIC8vIEEgZGlzY3JldGUgY2h1bmsgb2YgZGF0YSBhbmQgYSBidW5jaCBvZiB1c2VmdWwsIHJlbGF0ZWQgbWV0aG9kcyBmb3IKICAgIC8vIHBlcmZvcm1pbmcgY29tcHV0YXRpb25zIGFuZCB0cmFuc2Zvcm1hdGlvbnMgb24gdGhhdCBkYXRhLgogICAgCiAgICAvLyBDcmVhdGUgYSBuZXcgbW9kZWwgd2l0aCB0aGUgc3BlY2lmaWVkIGF0dHJpYnV0ZXMuIEEgY2xpZW50IGlkIChgY2lkYCkKICAgIC8vIGlzIGF1dG9tYXRpY2FsbHkgZ2VuZXJhdGVkIGFuZCBhc3NpZ25lZCBmb3IgeW91LgogICAgdmFyIE1vZGVsID0gSGFja2JvbmUuTW9kZWwgPSBTdGF0ZS5leHRlbmQoewogICAgICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbiAoYXR0cmlidXRlcywgb3B0aW9ucykgewogICAgICAgICAgICBTdGF0ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgICB0aGlzLmluaXRpYWxpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICB9LAogICAgCiAgICAgICAgLy8gUHJveHkgYEhhY2tib25lLnN5bmNgIGJ5IGRlZmF1bHQgLS0gYnV0IG92ZXJyaWRlIHRoaXMgaWYgeW91IG5lZWQKICAgICAgICAvLyBjdXN0b20gc3luY2luZyBzZW1hbnRpY3MgZm9yICp0aGlzKiBwYXJ0aWN1bGFyIG1vZGVsLgogICAgICAgIHN5bmM6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIEhhY2tib25lLnN5bmMuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICB9LAogICAgCiAgICAgICAgLy8gRmV0Y2ggdGhlIG1vZGVsIGZyb20gdGhlIHNlcnZlci4gSWYgdGhlIHNlcnZlcidzIHJlcHJlc2VudGF0aW9uIG9mIHRoZQogICAgICAgIC8vIG1vZGVsIGRpZmZlcnMgZnJvbSBpdHMgY3VycmVudCBhdHRyaWJ1dGVzLCB0aGV5IHdpbGwgYmUgb3ZlcnJpZGRlbiwKICAgICAgICAvLyB0cmlnZ2VyaW5nIGEgYCJjaGFuZ2UiYCBldmVudC4KICAgICAgICBmZXRjaDogZnVuY3Rpb24gKG9wdGlvbnMpIHsKICAgICAgICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgPyBfLmNsb25lKG9wdGlvbnMpIDoge307CiAgICAgICAgICAgIGlmIChvcHRpb25zLnBhcnNlID09PSB2b2lkIDApIG9wdGlvbnMucGFyc2UgPSB0cnVlOwogICAgICAgICAgICB2YXIgbW9kZWwgPSB0aGlzOwogICAgICAgICAgICB2YXIgc3VjY2VzcyA9IG9wdGlvbnMuc3VjY2VzczsKICAgICAgICAgICAgb3B0aW9ucy5zdWNjZXNzID0gZnVuY3Rpb24gKHJlc3ApIHsKICAgICAgICAgICAgICAgIGlmICghbW9kZWwuc2V0KG1vZGVsLnBhcnNlKHJlc3AsIG9wdGlvbnMpLCBvcHRpb25zKSkgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgaWYgKHN1Y2Nlc3MpIHN1Y2Nlc3MobW9kZWwsIHJlc3AsIG9wdGlvbnMpOwogICAgICAgICAgICAgICAgbW9kZWwudHJpZ2dlcignc3luYycsIG1vZGVsLCByZXNwLCBvcHRpb25zKTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgd3JhcEVycm9yKHRoaXMsIG9wdGlvbnMpOwogICAgICAgICAgICByZXR1cm4gdGhpcy5zeW5jKCdyZWFkJywgdGhpcywgb3B0aW9ucyk7CiAgICAgICAgfSwKICAgIAogICAgICAgIC8vIFNldCBhIGhhc2ggb2YgbW9kZWwgYXR0cmlidXRlcywgYW5kIHN5bmMgdGhlIG1vZGVsIHRvIHRoZSBzZXJ2ZXIuCiAgICAgICAgLy8gSWYgdGhlIHNlcnZlciByZXR1cm5zIGFuIGF0dHJpYnV0ZXMgaGFzaCB0aGF0IGRpZmZlcnMsIHRoZSBtb2RlbCdzCiAgICAgICAgLy8gc3RhdGUgd2lsbCBiZSBgc2V0YCBhZ2Fpbi4KICAgICAgICBzYXZlOiBmdW5jdGlvbiAoa2V5LCB2YWwsIG9wdGlvbnMpIHsKICAgICAgICAgICAgdmFyIGF0dHJzLCBtZXRob2QsIHhociwgYXR0cmlidXRlcyA9IHRoaXMuYXR0cmlidXRlczsKICAgIAogICAgICAgICAgICAvLyBIYW5kbGUgYm90aCBgImtleSIsIHZhbHVlYCBhbmQgYHtrZXk6IHZhbHVlfWAgLXN0eWxlIGFyZ3VtZW50cy4KICAgICAgICAgICAgaWYgKGtleSA9PSBudWxsIHx8IHR5cGVvZiBrZXkgPT09ICdvYmplY3QnKSB7CiAgICAgICAgICAgICAgICBhdHRycyA9IGtleTsKICAgICAgICAgICAgICAgIG9wdGlvbnMgPSB2YWw7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAoYXR0cnMgPSB7fSlba2V5XSA9IHZhbDsKICAgICAgICAgICAgfQogICAgCiAgICAgICAgICAgIG9wdGlvbnMgPSBfLmV4dGVuZCh7dmFsaWRhdGU6IHRydWV9LCBvcHRpb25zKTsKICAgIAogICAgICAgICAgICAvLyBJZiB3ZSdyZSBub3Qgd2FpdGluZyBhbmQgYXR0cmlidXRlcyBleGlzdCwgc2F2ZSBhY3RzIGFzCiAgICAgICAgICAgIC8vIGBzZXQoYXR0cikuc2F2ZShudWxsLCBvcHRzKWAgd2l0aCB2YWxpZGF0aW9uLiBPdGhlcndpc2UsIGNoZWNrIGlmCiAgICAgICAgICAgIC8vIHRoZSBtb2RlbCB3aWxsIGJlIHZhbGlkIHdoZW4gdGhlIGF0dHJpYnV0ZXMsIGlmIGFueSwgYXJlIHNldC4KICAgICAgICAgICAgaWYgKGF0dHJzICYmICFvcHRpb25zLndhaXQpIHsKICAgICAgICAgICAgICAgIGlmICghdGhpcy5zZXQoYXR0cnMsIG9wdGlvbnMpKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuX3ZhbGlkYXRlKGF0dHJzLCBvcHRpb25zKSkgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAKICAgICAgICAgICAgLy8gU2V0IHRlbXBvcmFyeSBhdHRyaWJ1dGVzIGlmIGB7d2FpdDogdHJ1ZX1gLgogICAgICAgICAgICBpZiAoYXR0cnMgJiYgb3B0aW9ucy53YWl0KSB7CiAgICAgICAgICAgICAgICB0aGlzLmF0dHJpYnV0ZXMgPSBfLmV4dGVuZCh7fSwgYXR0cmlidXRlcywgYXR0cnMpOwogICAgICAgICAgICB9CiAgICAKICAgICAgICAgICAgLy8gQWZ0ZXIgYSBzdWNjZXNzZnVsIHNlcnZlci1zaWRlIHNhdmUsIHRoZSBjbGllbnQgaXMgKG9wdGlvbmFsbHkpCiAgICAgICAgICAgIC8vIHVwZGF0ZWQgd2l0aCB0aGUgc2VydmVyLXNpZGUgc3RhdGUuCiAgICAgICAgICAgIGlmIChvcHRpb25zLnBhcnNlID09PSB2b2lkIDApIG9wdGlvbnMucGFyc2UgPSB0cnVlOwogICAgICAgICAgICB2YXIgbW9kZWwgPSB0aGlzOwogICAgICAgICAgICB2YXIgc3VjY2VzcyA9IG9wdGlvbnMuc3VjY2VzczsKICAgICAgICAgICAgb3B0aW9ucy5zdWNjZXNzID0gZnVuY3Rpb24gKHJlc3ApIHsKICAgICAgICAgICAgICAgIC8vIEVuc3VyZSBhdHRyaWJ1dGVzIGFyZSByZXN0b3JlZCBkdXJpbmcgc3luY2hyb25vdXMgc2F2ZXMuCiAgICAgICAgICAgICAgICBtb2RlbC5hdHRyaWJ1dGVzID0gYXR0cmlidXRlczsKICAgICAgICAgICAgICAgIHZhciBzZXJ2ZXJBdHRycyA9IG1vZGVsLnBhcnNlKHJlc3AsIG9wdGlvbnMpOwogICAgICAgICAgICAgICAgaWYgKG9wdGlvbnMud2FpdCkgc2VydmVyQXR0cnMgPSBfLmV4dGVuZChhdHRycyB8fCB7fSwgc2VydmVyQXR0cnMpOwogICAgICAgICAgICAgICAgaWYgKF8uaXNPYmplY3Qoc2VydmVyQXR0cnMpICYmICFtb2RlbC5zZXQoc2VydmVyQXR0cnMsIG9wdGlvbnMpKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHN1Y2Nlc3MpIHN1Y2Nlc3MobW9kZWwsIHJlc3AsIG9wdGlvbnMpOwogICAgICAgICAgICAgICAgbW9kZWwudHJpZ2dlcignc3luYycsIG1vZGVsLCByZXNwLCBvcHRpb25zKTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgd3JhcEVycm9yKHRoaXMsIG9wdGlvbnMpOwogICAgCiAgICAgICAgICAgIG1ldGhvZCA9IHRoaXMuaXNOZXcoKSA/ICdjcmVhdGUnIDogKG9wdGlvbnMucGF0Y2ggPyAncGF0Y2gnIDogJ3VwZGF0ZScpOwogICAgICAgICAgICBpZiAobWV0aG9kID09PSAncGF0Y2gnKSBvcHRpb25zLmF0dHJzID0gYXR0cnM7CiAgICAgICAgICAgIHhociA9IHRoaXMuc3luYyhtZXRob2QsIHRoaXMsIG9wdGlvbnMpOwogICAgCiAgICAgICAgICAgIC8vIFJlc3RvcmUgYXR0cmlidXRlcy4KICAgICAgICAgICAgaWYgKGF0dHJzICYmIG9wdGlvbnMud2FpdCkgdGhpcy5hdHRyaWJ1dGVzID0gYXR0cmlidXRlczsKICAgIAogICAgICAgICAgICByZXR1cm4geGhyOwogICAgICAgIH0sCiAgICAKICAgICAgICAvLyBEZXN0cm95IHRoaXMgbW9kZWwgb24gdGhlIHNlcnZlciBpZiBpdCB3YXMgYWxyZWFkeSBwZXJzaXN0ZWQuCiAgICAgICAgLy8gT3B0aW1pc3RpY2FsbHkgcmVtb3ZlcyB0aGUgbW9kZWwgZnJvbSBpdHMgY29sbGVjdGlvbiwgaWYgaXQgaGFzIG9uZS4KICAgICAgICAvLyBJZiBgd2FpdDogdHJ1ZWAgaXMgcGFzc2VkLCB3YWl0cyBmb3IgdGhlIHNlcnZlciB0byByZXNwb25kIGJlZm9yZSByZW1vdmFsLgogICAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uIChvcHRpb25zKSB7CiAgICAgICAgICAgIG9wdGlvbnMgPSBvcHRpb25zID8gXy5jbG9uZShvcHRpb25zKSA6IHt9OwogICAgICAgICAgICB2YXIgbW9kZWwgPSB0aGlzOwogICAgICAgICAgICB2YXIgc3VjY2VzcyA9IG9wdGlvbnMuc3VjY2VzczsKICAgIAogICAgICAgICAgICB2YXIgZGVzdHJveSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIG1vZGVsLnRyaWdnZXIoJ2Rlc3Ryb3knLCBtb2RlbCwgbW9kZWwuY29sbGVjdGlvbiwgb3B0aW9ucyk7CiAgICAgICAgICAgIH07CiAgICAKICAgICAgICAgICAgb3B0aW9ucy5zdWNjZXNzID0gZnVuY3Rpb24gKHJlc3ApIHsKICAgICAgICAgICAgICAgIGlmIChvcHRpb25zLndhaXQgfHwgbW9kZWwuaXNOZXcoKSkgZGVzdHJveSgpOwogICAgICAgICAgICAgICAgaWYgKHN1Y2Nlc3MpIHN1Y2Nlc3MobW9kZWwsIHJlc3AsIG9wdGlvbnMpOwogICAgICAgICAgICAgICAgaWYgKCFtb2RlbC5pc05ldygpKSBtb2RlbC50cmlnZ2VyKCdzeW5jJywgbW9kZWwsIHJlc3AsIG9wdGlvbnMpOwogICAgICAgICAgICB9OwogICAgCiAgICAgICAgICAgIGlmICh0aGlzLmlzTmV3KCkpIHsKICAgICAgICAgICAgICAgIG9wdGlvbnMuc3VjY2VzcygpOwogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdyYXBFcnJvcih0aGlzLCBvcHRpb25zKTsKICAgIAogICAgICAgICAgICB2YXIgeGhyID0gdGhpcy5zeW5jKCdkZWxldGUnLCB0aGlzLCBvcHRpb25zKTsKICAgICAgICAgICAgaWYgKCFvcHRpb25zLndhaXQpIGRlc3Ryb3koKTsKICAgIAogICAgICAgICAgICBTdGF0ZS5wcm90b3R5cGUuZGVzdHJveS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgCiAgICAgICAgICAgIHJldHVybiB4aHI7CiAgICAgICAgfSwKICAgIAogICAgICAgIC8vIERlZmF1bHQgVVJMIGZvciB0aGUgbW9kZWwncyByZXByZXNlbnRhdGlvbiBvbiB0aGUgc2VydmVyIC0tIGlmIHlvdSdyZQogICAgICAgIC8vIHVzaW5nIEhhY2tib25lJ3MgcmVzdGZ1bCBtZXRob2RzLCBvdmVycmlkZSB0aGlzIHRvIGNoYW5nZSB0aGUgZW5kcG9pbnQKICAgICAgICAvLyB0aGF0IHdpbGwgYmUgY2FsbGVkLgogICAgICAgIHVybDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgYmFzZSA9IF8ucmVzdWx0KHRoaXMsICd1cmxSb290JykgfHwgXy5yZXN1bHQodGhpcy5jb2xsZWN0aW9uLCAndXJsJykgfHwgdXJsRXJyb3IoKTsKICAgICAgICAgICAgaWYgKHRoaXMuaXNOZXcoKSkgcmV0dXJuIGJhc2U7CiAgICAgICAgICAgIHJldHVybiBiYXNlICsgKGJhc2UuY2hhckF0KGJhc2UubGVuZ3RoIC0gMSkgPT09ICcvJyA/ICcnIDogJy8nKSArIGVuY29kZVVSSUNvbXBvbmVudCh0aGlzLmlkKTsKICAgICAgICB9CiAgICB9LCBFdmVudHMpOwoKICAgIC8vQU1EIHN1cHBvcnQgd2l0aCBkZWZpbmUKICAgIGlmICh0eXBlb2YgZGVmaW5lID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgZGVmaW5lKCdIYWNrYm9uZScsIFtdLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiByb290LkhhY2tib25lOwogICAgICAgIH0pOwogICAgfQoKfSkuY2FsbCh0aGlzKTs=",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Fri, 07 Nov 2014 02:56:46 GMT",
                    "Content-Length": "80363",
                    "Date": "Fri, 07 Nov 2014 02:56:46 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}