{
    "url": "http://localhost:9999/pkukielka/angular-panels/test/lib/angular/angular-scenario.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "DOM data manipulation (DOM-based)",
    "issueType": 5247488,
    "severity": "Information",
    "confidence": "Firm",
    "issueBackground": "DOM-based DOM data manipulation vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this to a data field within the DOM that is used within the visible UI or client-side application logic. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will modify the appearance or behavior of the client-side UI. An attacker may be able to leverage this to perform virtual defacement of the application, or possibly to induce the user to perform unintended actions.",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based DOM data manipulation vulnerabilities is not to dynamically write to DOM data fields any data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from being stored. In general, this is best achieved by using a whitelist of permitted values.",
    "issueDetail": "The application may be vulnerable to DOM-based DOM data manipulation. Data is read from <b>window.location.href</b> and written to <b>the 'text()' function of JQuery</b> via the following statements:<ul><li>var href = window.location.href;</li><li>body.find('#system-error').tex...' ) .text('Scenario runner mus...' + href.split(':' ) [0 ] + ':// is not supporte...' );</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/pkukielka/angular-panels/test/lib/angular/angular-scenario.js",
                "path": "/pkukielka/angular-panels/test/lib/angular/angular-scenario.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9wa3VraWVsa2EvYW5ndWxhci1wYW5lbHMvdGVzdC9saWIvYW5ndWxhci9hbmd1bGFyLXNjZW5hcmlvLmpzIEhUVFAvMS4xDQpIb3N0OiBsb2NhbGhvc3Q6OTk5OQ0KDQo=",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogNjAxMDU5DQpBY2NlcHQtUmFuZ2VzOiBieXRlcw0KQ29udGVudC1UeXBlOiBhcHBsaWNhdGlvbi9qYXZhc2NyaXB0DQpEYXRlOiBUaHUsIDA2IE5vdiAyMDE0IDA4OjI1OjI2IEdNVA0KTGFzdC1Nb2RpZmllZDogVGh1LCAwNiBOb3YgMjAxNCAwODoyNToyNiBHTVQNCg0KLyohCiAqIGpRdWVyeSBKYXZhU2NyaXB0IExpYnJhcnkgdjEuNC4yCiAqIGh0dHA6Ly9qcXVlcnkuY29tLwogKgogKiBDb3B5cmlnaHQgMjAxMCwgSm9obiBSZXNpZwogKiBEdWFsIGxpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgb3IgR1BMIFZlcnNpb24gMiBsaWNlbnNlcy4KICogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQogKgogKiBJbmNsdWRlcyBTaXp6bGUuanMKICogaHR0cDovL3NpenpsZWpzLmNvbS8KICogQ29weXJpZ2h0IDIwMTAsIFRoZSBEb2pvIEZvdW5kYXRpb24KICogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCwgQlNELCBhbmQgR1BMIExpY2Vuc2VzLgogKgogKiBEYXRlOiBTYXQgRmViIDEzIDIyOjMzOjQ4IDIwMTAgLTA1MDAKICovCihmdW5jdGlvbiggd2luZG93LCB1bmRlZmluZWQgKSB7CgovLyBEZWZpbmUgYSBsb2NhbCBjb3B5IG9mIGpRdWVyeQp2YXIgalF1ZXJ5ID0gZnVuY3Rpb24oIHNlbGVjdG9yLCBjb250ZXh0ICkgewoJCS8vIFRoZSBqUXVlcnkgb2JqZWN0IGlzIGFjdHVhbGx5IGp1c3QgdGhlIGluaXQgY29uc3RydWN0b3IgJ2VuaGFuY2VkJwoJCXJldHVybiBuZXcgalF1ZXJ5LmZuLmluaXQoIHNlbGVjdG9yLCBjb250ZXh0ICk7Cgl9LAoKCS8vIE1hcCBvdmVyIGpRdWVyeSBpbiBjYXNlIG9mIG92ZXJ3cml0ZQoJX2pRdWVyeSA9IHdpbmRvdy5qUXVlcnksCgoJLy8gTWFwIG92ZXIgdGhlICQgaW4gY2FzZSBvZiBvdmVyd3JpdGUKCV8kID0gd2luZG93LiQsCgoJLy8gVXNlIHRoZSBjb3JyZWN0IGRvY3VtZW50IGFjY29yZGluZ2x5IHdpdGggd2luZG93IGFyZ3VtZW50IChzYW5kYm94KQoJZG9jdW1lbnQgPSB3aW5kb3cuZG9jdW1lbnQsCgoJLy8gQSBjZW50cmFsIHJlZmVyZW5jZSB0byB0aGUgcm9vdCBqUXVlcnkoZG9jdW1lbnQpCglyb290alF1ZXJ5LAoKCS8vIEEgc2ltcGxlIHdheSB0byBjaGVjayBmb3IgSFRNTCBzdHJpbmdzIG9yIElEIHN0cmluZ3MKCS8vIChib3RoIG9mIHdoaWNoIHdlIG9wdGltaXplIGZvcikKCXF1aWNrRXhwciA9IC9eW148XSooPFtcd1xXXSs+KVtePl0qJHxeIyhbXHctXSspJC8sCgoJLy8gSXMgaXQgYSBzaW1wbGUgc2VsZWN0b3IKCWlzU2ltcGxlID0gL14uW146I1xbXC4sXSokLywKCgkvLyBDaGVjayBpZiBhIHN0cmluZyBoYXMgYSBub24td2hpdGVzcGFjZSBjaGFyYWN0ZXIgaW4gaXQKCXJub3R3aGl0ZSA9IC9cUy8sCgoJLy8gVXNlZCBmb3IgdHJpbW1pbmcgd2hpdGVzcGFjZQoJcnRyaW0gPSAvXihcc3xcdTAwQTApK3woXHN8XHUwMEEwKSskL2csCgoJLy8gTWF0Y2ggYSBzdGFuZGFsb25lIHRhZwoJcnNpbmdsZVRhZyA9IC9ePChcdyspXHMqXC8/Pig/OjxcL1wxPik/JC8sCgoJLy8gS2VlcCBhIFVzZXJBZ2VudCBzdHJpbmcgZm9yIHVzZSB3aXRoIGpRdWVyeS5icm93c2VyCgl1c2VyQWdlbnQgPSBuYXZpZ2F0b3IudXNlckFnZW50LAoKCS8vIEZvciBtYXRjaGluZyB0aGUgZW5naW5lIGFuZCB2ZXJzaW9uIG9mIHRoZSBicm93c2VyCglicm93c2VyTWF0Y2gsCgkKCS8vIEhhcyB0aGUgcmVhZHkgZXZlbnRzIGFscmVhZHkgYmVlbiBib3VuZD8KCXJlYWR5Qm91bmQgPSBmYWxzZSwKCQoJLy8gVGhlIGZ1bmN0aW9ucyB0byBleGVjdXRlIG9uIERPTSByZWFkeQoJcmVhZHlMaXN0ID0gW10sCgoJLy8gVGhlIHJlYWR5IGV2ZW50IGhhbmRsZXIKCURPTUNvbnRlbnRMb2FkZWQsCgoJLy8gU2F2ZSBhIHJlZmVyZW5jZSB0byBzb21lIGNvcmUgbWV0aG9kcwoJdG9TdHJpbmcgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLAoJaGFzT3duUHJvcGVydHkgPSBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LAoJcHVzaCA9IEFycmF5LnByb3RvdHlwZS5wdXNoLAoJc2xpY2UgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UsCglpbmRleE9mID0gQXJyYXkucHJvdG90eXBlLmluZGV4T2Y7CgpqUXVlcnkuZm4gPSBqUXVlcnkucHJvdG90eXBlID0gewoJaW5pdDogZnVuY3Rpb24oIHNlbGVjdG9yLCBjb250ZXh0ICkgewoJCXZhciBtYXRjaCwgZWxlbSwgcmV0LCBkb2M7CgoJCS8vIEhhbmRsZSAkKCIiKSwgJChudWxsKSwgb3IgJCh1bmRlZmluZWQpCgkJaWYgKCAhc2VsZWN0b3IgKSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJLy8gSGFuZGxlICQoRE9NRWxlbWVudCkKCQlpZiAoIHNlbGVjdG9yLm5vZGVUeXBlICkgewoJCQl0aGlzLmNvbnRleHQgPSB0aGlzWzBdID0gc2VsZWN0b3I7CgkJCXRoaXMubGVuZ3RoID0gMTsKCQkJcmV0dXJuIHRoaXM7CgkJfQoJCQoJCS8vIFRoZSBib2R5IGVsZW1lbnQgb25seSBleGlzdHMgb25jZSwgb3B0aW1pemUgZmluZGluZyBpdAoJCWlmICggc2VsZWN0b3IgPT09ICJib2R5IiAmJiAhY29udGV4dCApIHsKCQkJdGhpcy5jb250ZXh0ID0gZG9jdW1lbnQ7CgkJCXRoaXNbMF0gPSBkb2N1bWVudC5ib2R5OwoJCQl0aGlzLnNlbGVjdG9yID0gImJvZHkiOwoJCQl0aGlzLmxlbmd0aCA9IDE7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJLy8gSGFuZGxlIEhUTUwgc3RyaW5ncwoJCWlmICggdHlwZW9mIHNlbGVjdG9yID09PSAic3RyaW5nIiApIHsKCQkJLy8gQXJlIHdlIGRlYWxpbmcgd2l0aCBIVE1MIHN0cmluZyBvciBhbiBJRD8KCQkJbWF0Y2ggPSBxdWlja0V4cHIuZXhlYyggc2VsZWN0b3IgKTsKCgkJCS8vIFZlcmlmeSBhIG1hdGNoLCBhbmQgdGhhdCBubyBjb250ZXh0IHdhcyBzcGVjaWZpZWQgZm9yICNpZAoJCQlpZiAoIG1hdGNoICYmIChtYXRjaFsxXSB8fCAhY29udGV4dCkgKSB7CgoJCQkJLy8gSEFORExFOiAkKGh0bWwpIC0+ICQoYXJyYXkpCgkJCQlpZiAoIG1hdGNoWzFdICkgewoJCQkJCWRvYyA9IChjb250ZXh0ID8gY29udGV4dC5vd25lckRvY3VtZW50IHx8IGNvbnRleHQgOiBkb2N1bWVudCk7CgoJCQkJCS8vIElmIGEgc2luZ2xlIHN0cmluZyBpcyBwYXNzZWQgaW4gYW5kIGl0J3MgYSBzaW5nbGUgdGFnCgkJCQkJLy8ganVzdCBkbyBhIGNyZWF0ZUVsZW1lbnQgYW5kIHNraXAgdGhlIHJlc3QKCQkJCQlyZXQgPSByc2luZ2xlVGFnLmV4ZWMoIHNlbGVjdG9yICk7CgoJCQkJCWlmICggcmV0ICkgewoJCQkJCQlpZiAoIGpRdWVyeS5pc1BsYWluT2JqZWN0KCBjb250ZXh0ICkgKSB7CgkJCQkJCQlzZWxlY3RvciA9IFsgZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggcmV0WzFdICkgXTsKCQkJCQkJCWpRdWVyeS5mbi5hdHRyLmNhbGwoIHNlbGVjdG9yLCBjb250ZXh0LCB0cnVlICk7CgoJCQkJCQl9IGVsc2UgewoJCQkJCQkJc2VsZWN0b3IgPSBbIGRvYy5jcmVhdGVFbGVtZW50KCByZXRbMV0gKSBdOwoJCQkJCQl9CgoJCQkJCX0gZWxzZSB7CgkJCQkJCXJldCA9IGJ1aWxkRnJhZ21lbnQoIFsgbWF0Y2hbMV0gXSwgWyBkb2MgXSApOwoJCQkJCQlzZWxlY3RvciA9IChyZXQuY2FjaGVhYmxlID8gcmV0LmZyYWdtZW50LmNsb25lTm9kZSh0cnVlKSA6IHJldC5mcmFnbWVudCkuY2hpbGROb2RlczsKCQkJCQl9CgkJCQkJCgkJCQkJcmV0dXJuIGpRdWVyeS5tZXJnZSggdGhpcywgc2VsZWN0b3IgKTsKCQkJCQkKCQkJCS8vIEhBTkRMRTogJCgiI2lkIikKCQkJCX0gZWxzZSB7CgkJCQkJZWxlbSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCBtYXRjaFsyXSApOwoKCQkJCQlpZiAoIGVsZW0gKSB7CgkJCQkJCS8vIEhhbmRsZSB0aGUgY2FzZSB3aGVyZSBJRSBhbmQgT3BlcmEgcmV0dXJuIGl0ZW1zCgkJCQkJCS8vIGJ5IG5hbWUgaW5zdGVhZCBvZiBJRAoJCQkJCQlpZiAoIGVsZW0uaWQgIT09IG1hdGNoWzJdICkgewoJCQkJCQkJcmV0dXJuIHJvb3RqUXVlcnkuZmluZCggc2VsZWN0b3IgKTsKCQkJCQkJfQoKCQkJCQkJLy8gT3RoZXJ3aXNlLCB3ZSBpbmplY3QgdGhlIGVsZW1lbnQgZGlyZWN0bHkgaW50byB0aGUgalF1ZXJ5IG9iamVjdAoJCQkJCQl0aGlzLmxlbmd0aCA9IDE7CgkJCQkJCXRoaXNbMF0gPSBlbGVtOwoJCQkJCX0KCgkJCQkJdGhpcy5jb250ZXh0ID0gZG9jdW1lbnQ7CgkJCQkJdGhpcy5zZWxlY3RvciA9IHNlbGVjdG9yOwoJCQkJCXJldHVybiB0aGlzOwoJCQkJfQoKCQkJLy8gSEFORExFOiAkKCJUQUciKQoJCQl9IGVsc2UgaWYgKCAhY29udGV4dCAmJiAvXlx3KyQvLnRlc3QoIHNlbGVjdG9yICkgKSB7CgkJCQl0aGlzLnNlbGVjdG9yID0gc2VsZWN0b3I7CgkJCQl0aGlzLmNvbnRleHQgPSBkb2N1bWVudDsKCQkJCXNlbGVjdG9yID0gZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoIHNlbGVjdG9yICk7CgkJCQlyZXR1cm4galF1ZXJ5Lm1lcmdlKCB0aGlzLCBzZWxlY3RvciApOwoKCQkJLy8gSEFORExFOiAkKGV4cHIsICQoLi4uKSkKCQkJfSBlbHNlIGlmICggIWNvbnRleHQgfHwgY29udGV4dC5qcXVlcnkgKSB7CgkJCQlyZXR1cm4gKGNvbnRleHQgfHwgcm9vdGpRdWVyeSkuZmluZCggc2VsZWN0b3IgKTsKCgkJCS8vIEhBTkRMRTogJChleHByLCBjb250ZXh0KQoJCQkvLyAod2hpY2ggaXMganVzdCBlcXVpdmFsZW50IHRvOiAkKGNvbnRleHQpLmZpbmQoZXhwcikKCQkJfSBlbHNlIHsKCQkJCXJldHVybiBqUXVlcnkoIGNvbnRleHQgKS5maW5kKCBzZWxlY3RvciApOwoJCQl9CgoJCS8vIEhBTkRMRTogJChmdW5jdGlvbikKCQkvLyBTaG9ydGN1dCBmb3IgZG9jdW1lbnQgcmVhZHkKCQl9IGVsc2UgaWYgKCBqUXVlcnkuaXNGdW5jdGlvbiggc2VsZWN0b3IgKSApIHsKCQkJcmV0dXJuIHJvb3RqUXVlcnkucmVhZHkoIHNlbGVjdG9yICk7CgkJfQoKCQlpZiAoc2VsZWN0b3Iuc2VsZWN0b3IgIT09IHVuZGVmaW5lZCkgewoJCQl0aGlzLnNlbGVjdG9yID0gc2VsZWN0b3Iuc2VsZWN0b3I7CgkJCXRoaXMuY29udGV4dCA9IHNlbGVjdG9yLmNvbnRleHQ7CgkJfQoKCQlyZXR1cm4galF1ZXJ5Lm1ha2VBcnJheSggc2VsZWN0b3IsIHRoaXMgKTsKCX0sCgoJLy8gU3RhcnQgd2l0aCBhbiBlbXB0eSBzZWxlY3RvcgoJc2VsZWN0b3I6ICIiLAoKCS8vIFRoZSBjdXJyZW50IHZlcnNpb24gb2YgalF1ZXJ5IGJlaW5nIHVzZWQKCWpxdWVyeTogIjEuNC4yIiwKCgkvLyBUaGUgZGVmYXVsdCBsZW5ndGggb2YgYSBqUXVlcnkgb2JqZWN0IGlzIDAKCWxlbmd0aDogMCwKCgkvLyBUaGUgbnVtYmVyIG9mIGVsZW1lbnRzIGNvbnRhaW5lZCBpbiB0aGUgbWF0Y2hlZCBlbGVtZW50IHNldAoJc2l6ZTogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMubGVuZ3RoOwoJfSwKCgl0b0FycmF5OiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gc2xpY2UuY2FsbCggdGhpcywgMCApOwoJfSwKCgkvLyBHZXQgdGhlIE50aCBlbGVtZW50IGluIHRoZSBtYXRjaGVkIGVsZW1lbnQgc2V0IE9SCgkvLyBHZXQgdGhlIHdob2xlIG1hdGNoZWQgZWxlbWVudCBzZXQgYXMgYSBjbGVhbiBhcnJheQoJZ2V0OiBmdW5jdGlvbiggbnVtICkgewoJCXJldHVybiBudW0gPT0gbnVsbCA/CgoJCQkvLyBSZXR1cm4gYSAnY2xlYW4nIGFycmF5CgkJCXRoaXMudG9BcnJheSgpIDoKCgkJCS8vIFJldHVybiBqdXN0IHRoZSBvYmplY3QKCQkJKCBudW0gPCAwID8gdGhpcy5zbGljZShudW0pWyAwIF0gOiB0aGlzWyBudW0gXSApOwoJfSwKCgkvLyBUYWtlIGFuIGFycmF5IG9mIGVsZW1lbnRzIGFuZCBwdXNoIGl0IG9udG8gdGhlIHN0YWNrCgkvLyAocmV0dXJuaW5nIHRoZSBuZXcgbWF0Y2hlZCBlbGVtZW50IHNldCkKCXB1c2hTdGFjazogZnVuY3Rpb24oIGVsZW1zLCBuYW1lLCBzZWxlY3RvciApIHsKCQkvLyBCdWlsZCBhIG5ldyBqUXVlcnkgbWF0Y2hlZCBlbGVtZW50IHNldAoJCXZhciByZXQgPSBqUXVlcnkoKTsKCgkJaWYgKCBqUXVlcnkuaXNBcnJheSggZWxlbXMgKSApIHsKCQkJcHVzaC5hcHBseSggcmV0LCBlbGVtcyApOwoJCQoJCX0gZWxzZSB7CgkJCWpRdWVyeS5tZXJnZSggcmV0LCBlbGVtcyApOwoJCX0KCgkJLy8gQWRkIHRoZSBvbGQgb2JqZWN0IG9udG8gdGhlIHN0YWNrIChhcyBhIHJlZmVyZW5jZSkKCQlyZXQucHJldk9iamVjdCA9IHRoaXM7CgoJCXJldC5jb250ZXh0ID0gdGhpcy5jb250ZXh0OwoKCQlpZiAoIG5hbWUgPT09ICJmaW5kIiApIHsKCQkJcmV0LnNlbGVjdG9yID0gdGhpcy5zZWxlY3RvciArICh0aGlzLnNlbGVjdG9yID8gIiAiIDogIiIpICsgc2VsZWN0b3I7CgkJfSBlbHNlIGlmICggbmFtZSApIHsKCQkJcmV0LnNlbGVjdG9yID0gdGhpcy5zZWxlY3RvciArICIuIiArIG5hbWUgKyAiKCIgKyBzZWxlY3RvciArICIpIjsKCQl9CgoJCS8vIFJldHVybiB0aGUgbmV3bHktZm9ybWVkIGVsZW1lbnQgc2V0CgkJcmV0dXJuIHJldDsKCX0sCgoJLy8gRXhlY3V0ZSBhIGNhbGxiYWNrIGZvciBldmVyeSBlbGVtZW50IGluIHRoZSBtYXRjaGVkIHNldC4KCS8vIChZb3UgY2FuIHNlZWQgdGhlIGFyZ3VtZW50cyB3aXRoIGFuIGFycmF5IG9mIGFyZ3MsIGJ1dCB0aGlzIGlzCgkvLyBvbmx5IHVzZWQgaW50ZXJuYWxseS4pCgllYWNoOiBmdW5jdGlvbiggY2FsbGJhY2ssIGFyZ3MgKSB7CgkJcmV0dXJuIGpRdWVyeS5lYWNoKCB0aGlzLCBjYWxsYmFjaywgYXJncyApOwoJfSwKCQoJcmVhZHk6IGZ1bmN0aW9uKCBmbiApIHsKCQkvLyBBdHRhY2ggdGhlIGxpc3RlbmVycwoJCWpRdWVyeS5iaW5kUmVhZHkoKTsKCgkJLy8gSWYgdGhlIERPTSBpcyBhbHJlYWR5IHJlYWR5CgkJaWYgKCBqUXVlcnkuaXNSZWFkeSApIHsKCQkJLy8gRXhlY3V0ZSB0aGUgZnVuY3Rpb24gaW1tZWRpYXRlbHkKCQkJZm4uY2FsbCggZG9jdW1lbnQsIGpRdWVyeSApOwoKCQkvLyBPdGhlcndpc2UsIHJlbWVtYmVyIHRoZSBmdW5jdGlvbiBmb3IgbGF0ZXIKCQl9IGVsc2UgaWYgKCByZWFkeUxpc3QgKSB7CgkJCS8vIEFkZCB0aGUgZnVuY3Rpb24gdG8gdGhlIHdhaXQgbGlzdAoJCQlyZWFkeUxpc3QucHVzaCggZm4gKTsKCQl9CgoJCXJldHVybiB0aGlzOwoJfSwKCQoJZXE6IGZ1bmN0aW9uKCBpICkgewoJCXJldHVybiBpID09PSAtMSA/CgkJCXRoaXMuc2xpY2UoIGkgKSA6CgkJCXRoaXMuc2xpY2UoIGksICtpICsgMSApOwoJfSwKCglmaXJzdDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuZXEoIDAgKTsKCX0sCgoJbGFzdDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuZXEoIC0xICk7Cgl9LAoKCXNsaWNlOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5wdXNoU3RhY2soIHNsaWNlLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKSwKCQkJInNsaWNlIiwgc2xpY2UuY2FsbChhcmd1bWVudHMpLmpvaW4oIiwiKSApOwoJfSwKCgltYXA6IGZ1bmN0aW9uKCBjYWxsYmFjayApIHsKCQlyZXR1cm4gdGhpcy5wdXNoU3RhY2soIGpRdWVyeS5tYXAodGhpcywgZnVuY3Rpb24oIGVsZW0sIGkgKSB7CgkJCXJldHVybiBjYWxsYmFjay5jYWxsKCBlbGVtLCBpLCBlbGVtICk7CgkJfSkpOwoJfSwKCQoJZW5kOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5wcmV2T2JqZWN0IHx8IGpRdWVyeShudWxsKTsKCX0sCgoJLy8gRm9yIGludGVybmFsIHVzZSBvbmx5LgoJLy8gQmVoYXZlcyBsaWtlIGFuIEFycmF5J3MgbWV0aG9kLCBub3QgbGlrZSBhIGpRdWVyeSBtZXRob2QuCglwdXNoOiBwdXNoLAoJc29ydDogW10uc29ydCwKCXNwbGljZTogW10uc3BsaWNlCn07CgovLyBHaXZlIHRoZSBpbml0IGZ1bmN0aW9uIHRoZSBqUXVlcnkgcHJvdG90eXBlIGZvciBsYXRlciBpbnN0YW50aWF0aW9uCmpRdWVyeS5mbi5pbml0LnByb3RvdHlwZSA9IGpRdWVyeS5mbjsKCmpRdWVyeS5leHRlbmQgPSBqUXVlcnkuZm4uZXh0ZW5kID0gZnVuY3Rpb24oKSB7CgkvLyBjb3B5IHJlZmVyZW5jZSB0byB0YXJnZXQgb2JqZWN0Cgl2YXIgdGFyZ2V0ID0gYXJndW1lbnRzWzBdIHx8IHt9LCBpID0gMSwgbGVuZ3RoID0gYXJndW1lbnRzLmxlbmd0aCwgZGVlcCA9IGZhbHNlLCBvcHRpb25zLCBuYW1lLCBzcmMsIGNvcHk7CgoJLy8gSGFuZGxlIGEgZGVlcCBjb3B5IHNpdHVhdGlvbgoJaWYgKCB0eXBlb2YgdGFyZ2V0ID09PSAiYm9vbGVhbiIgKSB7CgkJZGVlcCA9IHRhcmdldDsKCQl0YXJnZXQgPSBhcmd1bWVudHNbMV0gfHwge307CgkJLy8gc2tpcCB0aGUgYm9vbGVhbiBhbmQgdGhlIHRhcmdldAoJCWkgPSAyOwoJfQoKCS8vIEhhbmRsZSBjYXNlIHdoZW4gdGFyZ2V0IGlzIGEgc3RyaW5nIG9yIHNvbWV0aGluZyAocG9zc2libGUgaW4gZGVlcCBjb3B5KQoJaWYgKCB0eXBlb2YgdGFyZ2V0ICE9PSAib2JqZWN0IiAmJiAhalF1ZXJ5LmlzRnVuY3Rpb24odGFyZ2V0KSApIHsKCQl0YXJnZXQgPSB7fTsKCX0KCgkvLyBleHRlbmQgalF1ZXJ5IGl0c2VsZiBpZiBvbmx5IG9uZSBhcmd1bWVudCBpcyBwYXNzZWQKCWlmICggbGVuZ3RoID09PSBpICkgewoJCXRhcmdldCA9IHRoaXM7CgkJLS1pOwoJfQoKCWZvciAoIDsgaSA8IGxlbmd0aDsgaSsrICkgewoJCS8vIE9ubHkgZGVhbCB3aXRoIG5vbi1udWxsL3VuZGVmaW5lZCB2YWx1ZXMKCQlpZiAoIChvcHRpb25zID0gYXJndW1lbnRzWyBpIF0pICE9IG51bGwgKSB7CgkJCS8vIEV4dGVuZCB0aGUgYmFzZSBvYmplY3QKCQkJZm9yICggbmFtZSBpbiBvcHRpb25zICkgewoJCQkJc3JjID0gdGFyZ2V0WyBuYW1lIF07CgkJCQljb3B5ID0gb3B0aW9uc1sgbmFtZSBdOwoKCQkJCS8vIFByZXZlbnQgbmV2ZXItZW5kaW5nIGxvb3AKCQkJCWlmICggdGFyZ2V0ID09PSBjb3B5ICkgewoJCQkJCWNvbnRpbnVlOwoJCQkJfQoKCQkJCS8vIFJlY3Vyc2UgaWYgd2UncmUgbWVyZ2luZyBvYmplY3QgbGl0ZXJhbCB2YWx1ZXMgb3IgYXJyYXlzCgkJCQlpZiAoIGRlZXAgJiYgY29weSAmJiAoIGpRdWVyeS5pc1BsYWluT2JqZWN0KGNvcHkpIHx8IGpRdWVyeS5pc0FycmF5KGNvcHkpICkgKSB7CgkJCQkJdmFyIGNsb25lID0gc3JjICYmICggalF1ZXJ5LmlzUGxhaW5PYmplY3Qoc3JjKSB8fCBqUXVlcnkuaXNBcnJheShzcmMpICkgPyBzcmMKCQkJCQkJOiBqUXVlcnkuaXNBcnJheShjb3B5KSA/IFtdIDoge307CgoJCQkJCS8vIE5ldmVyIG1vdmUgb3JpZ2luYWwgb2JqZWN0cywgY2xvbmUgdGhlbQoJCQkJCXRhcmdldFsgbmFtZSBdID0galF1ZXJ5LmV4dGVuZCggZGVlcCwgY2xvbmUsIGNvcHkgKTsKCgkJCQkvLyBEb24ndCBicmluZyBpbiB1bmRlZmluZWQgdmFsdWVzCgkJCQl9IGVsc2UgaWYgKCBjb3B5ICE9PSB1bmRlZmluZWQgKSB7CgkJCQkJdGFyZ2V0WyBuYW1lIF0gPSBjb3B5OwoJCQkJfQoJCQl9CgkJfQoJfQoKCS8vIFJldHVybiB0aGUgbW9kaWZpZWQgb2JqZWN0CglyZXR1cm4gdGFyZ2V0Owp9OwoKalF1ZXJ5LmV4dGVuZCh7Cglub0NvbmZsaWN0OiBmdW5jdGlvbiggZGVlcCApIHsKCQl3aW5kb3cuJCA9IF8kOwoKCQlpZiAoIGRlZXAgKSB7CgkJCXdpbmRvdy5qUXVlcnkgPSBfalF1ZXJ5OwoJCX0KCgkJcmV0dXJuIGpRdWVyeTsKCX0sCgkKCS8vIElzIHRoZSBET00gcmVhZHkgdG8gYmUgdXNlZD8gU2V0IHRvIHRydWUgb25jZSBpdCBvY2N1cnMuCglpc1JlYWR5OiBmYWxzZSwKCQoJLy8gSGFuZGxlIHdoZW4gdGhlIERPTSBpcyByZWFkeQoJcmVhZHk6IGZ1bmN0aW9uKCkgewoJCS8vIE1ha2Ugc3VyZSB0aGF0IHRoZSBET00gaXMgbm90IGFscmVhZHkgbG9hZGVkCgkJaWYgKCAhalF1ZXJ5LmlzUmVhZHkgKSB7CgkJCS8vIE1ha2Ugc3VyZSBib2R5IGV4aXN0cywgYXQgbGVhc3QsIGluIGNhc2UgSUUgZ2V0cyBhIGxpdHRsZSBvdmVyemVhbG91cyAodGlja2V0ICM1NDQzKS4KCQkJaWYgKCAhZG9jdW1lbnQuYm9keSApIHsKCQkJCXJldHVybiBzZXRUaW1lb3V0KCBqUXVlcnkucmVhZHksIDEzICk7CgkJCX0KCgkJCS8vIFJlbWVtYmVyIHRoYXQgdGhlIERPTSBpcyByZWFkeQoJCQlqUXVlcnkuaXNSZWFkeSA9IHRydWU7CgoJCQkvLyBJZiB0aGVyZSBhcmUgZnVuY3Rpb25zIGJvdW5kLCB0byBleGVjdXRlCgkJCWlmICggcmVhZHlMaXN0ICkgewoJCQkJLy8gRXhlY3V0ZSBhbGwgb2YgdGhlbQoJCQkJdmFyIGZuLCBpID0gMDsKCQkJCXdoaWxlICggKGZuID0gcmVhZHlMaXN0WyBpKysgXSkgKSB7CgkJCQkJZm4uY2FsbCggZG9jdW1lbnQsIGpRdWVyeSApOwoJCQkJfQoKCQkJCS8vIFJlc2V0IHRoZSBsaXN0IG9mIGZ1bmN0aW9ucwoJCQkJcmVhZHlMaXN0ID0gbnVsbDsKCQkJfQoKCQkJLy8gVHJpZ2dlciBhbnkgYm91bmQgcmVhZHkgZXZlbnRzCgkJCWlmICggalF1ZXJ5LmZuLnRyaWdnZXJIYW5kbGVyICkgewoJCQkJalF1ZXJ5KCBkb2N1bWVudCApLnRyaWdnZXJIYW5kbGVyKCAicmVhZHkiICk7CgkJCX0KCQl9Cgl9LAoJCgliaW5kUmVhZHk6IGZ1bmN0aW9uKCkgewoJCWlmICggcmVhZHlCb3VuZCApIHsKCQkJcmV0dXJuOwoJCX0KCgkJcmVhZHlCb3VuZCA9IHRydWU7CgoJCS8vIENhdGNoIGNhc2VzIHdoZXJlICQoZG9jdW1lbnQpLnJlYWR5KCkgaXMgY2FsbGVkIGFmdGVyIHRoZQoJCS8vIGJyb3dzZXIgZXZlbnQgaGFzIGFscmVhZHkgb2NjdXJyZWQuCgkJaWYgKCBkb2N1bWVudC5yZWFkeVN0YXRlID09PSAiY29tcGxldGUiICkgewoJCQlyZXR1cm4galF1ZXJ5LnJlYWR5KCk7CgkJfQoKCQkvLyBNb3ppbGxhLCBPcGVyYSBhbmQgd2Via2l0IG5pZ2h0bGllcyBjdXJyZW50bHkgc3VwcG9ydCB0aGlzIGV2ZW50CgkJaWYgKCBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyICkgewoJCQkvLyBVc2UgdGhlIGhhbmR5IGV2ZW50IGNhbGxiYWNrCgkJCWRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoICJET01Db250ZW50TG9hZGVkIiwgRE9NQ29udGVudExvYWRlZCwgZmFsc2UgKTsKCQkJCgkJCS8vIEEgZmFsbGJhY2sgdG8gd2luZG93Lm9ubG9hZCwgdGhhdCB3aWxsIGFsd2F5cyB3b3JrCgkJCXdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCAibG9hZCIsIGpRdWVyeS5yZWFkeSwgZmFsc2UgKTsKCgkJLy8gSWYgSUUgZXZlbnQgbW9kZWwgaXMgdXNlZAoJCX0gZWxzZSBpZiAoIGRvY3VtZW50LmF0dGFjaEV2ZW50ICkgewoJCQkvLyBlbnN1cmUgZmlyaW5nIGJlZm9yZSBvbmxvYWQsCgkJCS8vIG1heWJlIGxhdGUgYnV0IHNhZmUgYWxzbyBmb3IgaWZyYW1lcwoJCQlkb2N1bWVudC5hdHRhY2hFdmVudCgib25yZWFkeXN0YXRlY2hhbmdlIiwgRE9NQ29udGVudExvYWRlZCk7CgkJCQoJCQkvLyBBIGZhbGxiYWNrIHRvIHdpbmRvdy5vbmxvYWQsIHRoYXQgd2lsbCBhbHdheXMgd29yawoJCQl3aW5kb3cuYXR0YWNoRXZlbnQoICJvbmxvYWQiLCBqUXVlcnkucmVhZHkgKTsKCgkJCS8vIElmIElFIGFuZCBub3QgYSBmcmFtZQoJCQkvLyBjb250aW51YWxseSBjaGVjayB0byBzZWUgaWYgdGhlIGRvY3VtZW50IGlzIHJlYWR5CgkJCXZhciB0b3BsZXZlbCA9IGZhbHNlOwoKCQkJdHJ5IHsKCQkJCXRvcGxldmVsID0gd2luZG93LmZyYW1lRWxlbWVudCA9PSBudWxsOwoJCQl9IGNhdGNoKGUpIHt9CgoJCQlpZiAoIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5kb1Njcm9sbCAmJiB0b3BsZXZlbCApIHsKCQkJCWRvU2Nyb2xsQ2hlY2soKTsKCQkJfQoJCX0KCX0sCgoJLy8gU2VlIHRlc3QvdW5pdC9jb3JlLmpzIGZvciBkZXRhaWxzIGNvbmNlcm5pbmcgaXNGdW5jdGlvbi4KCS8vIFNpbmNlIHZlcnNpb24gMS4zLCBET00gbWV0aG9kcyBhbmQgZnVuY3Rpb25zIGxpa2UgYWxlcnQKCS8vIGFyZW4ndCBzdXBwb3J0ZWQuIFRoZXkgcmV0dXJuIGZhbHNlIG9uIElFICgjMjk2OCkuCglpc0Z1bmN0aW9uOiBmdW5jdGlvbiggb2JqICkgewoJCXJldHVybiB0b1N0cmluZy5jYWxsKG9iaikgPT09ICJbb2JqZWN0IEZ1bmN0aW9uXSI7Cgl9LAoKCWlzQXJyYXk6IGZ1bmN0aW9uKCBvYmogKSB7CgkJcmV0dXJuIHRvU3RyaW5nLmNhbGwob2JqKSA9PT0gIltvYmplY3QgQXJyYXldIjsKCX0sCgoJaXNQbGFpbk9iamVjdDogZnVuY3Rpb24oIG9iaiApIHsKCQkvLyBNdXN0IGJlIGFuIE9iamVjdC4KCQkvLyBCZWNhdXNlIG9mIElFLCB3ZSBhbHNvIGhhdmUgdG8gY2hlY2sgdGhlIHByZXNlbmNlIG9mIHRoZSBjb25zdHJ1Y3RvciBwcm9wZXJ0eS4KCQkvLyBNYWtlIHN1cmUgdGhhdCBET00gbm9kZXMgYW5kIHdpbmRvdyBvYmplY3RzIGRvbid0IHBhc3MgdGhyb3VnaCwgYXMgd2VsbAoJCWlmICggIW9iaiB8fCB0b1N0cmluZy5jYWxsKG9iaikgIT09ICJbb2JqZWN0IE9iamVjdF0iIHx8IG9iai5ub2RlVHlwZSB8fCBvYmouc2V0SW50ZXJ2YWwgKSB7CgkJCXJldHVybiBmYWxzZTsKCQl9CgkJCgkJLy8gTm90IG93biBjb25zdHJ1Y3RvciBwcm9wZXJ0eSBtdXN0IGJlIE9iamVjdAoJCWlmICggb2JqLmNvbnN0cnVjdG9yCgkJCSYmICFoYXNPd25Qcm9wZXJ0eS5jYWxsKG9iaiwgImNvbnN0cnVjdG9yIikKCQkJJiYgIWhhc093blByb3BlcnR5LmNhbGwob2JqLmNvbnN0cnVjdG9yLnByb3RvdHlwZSwgImlzUHJvdG90eXBlT2YiKSApIHsKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCQkKCQkvLyBPd24gcHJvcGVydGllcyBhcmUgZW51bWVyYXRlZCBmaXJzdGx5LCBzbyB0byBzcGVlZCB1cCwKCQkvLyBpZiBsYXN0IG9uZSBpcyBvd24sIHRoZW4gYWxsIHByb3BlcnRpZXMgYXJlIG93bi4KCQoJCXZhciBrZXk7CgkJZm9yICgga2V5IGluIG9iaiApIHt9CgkJCgkJcmV0dXJuIGtleSA9PT0gdW5kZWZpbmVkIHx8IGhhc093blByb3BlcnR5LmNhbGwoIG9iaiwga2V5ICk7Cgl9LAoKCWlzRW1wdHlPYmplY3Q6IGZ1bmN0aW9uKCBvYmogKSB7CgkJZm9yICggdmFyIG5hbWUgaW4gb2JqICkgewoJCQlyZXR1cm4gZmFsc2U7CgkJfQoJCXJldHVybiB0cnVlOwoJfSwKCQoJZXJyb3I6IGZ1bmN0aW9uKCBtc2cgKSB7CgkJdGhyb3cgbXNnOwoJfSwKCQoJcGFyc2VKU09OOiBmdW5jdGlvbiggZGF0YSApIHsKCQlpZiAoIHR5cGVvZiBkYXRhICE9PSAic3RyaW5nIiB8fCAhZGF0YSApIHsKCQkJcmV0dXJuIG51bGw7CgkJfQoKCQkvLyBNYWtlIHN1cmUgbGVhZGluZy90cmFpbGluZyB3aGl0ZXNwYWNlIGlzIHJlbW92ZWQgKElFIGNhbid0IGhhbmRsZSBpdCkKCQlkYXRhID0galF1ZXJ5LnRyaW0oIGRhdGEgKTsKCQkKCQkvLyBNYWtlIHN1cmUgdGhlIGluY29taW5nIGRhdGEgaXMgYWN0dWFsIEpTT04KCQkvLyBMb2dpYyBib3Jyb3dlZCBmcm9tIGh0dHA6Ly9qc29uLm9yZy9qc29uMi5qcwoJCWlmICggL15bXF0sOnt9XHNdKiQvLnRlc3QoZGF0YS5yZXBsYWNlKC9cXCg/OlsiXFxcL2JmbnJ0XXx1WzAtOWEtZkEtRl17NH0pL2csICJAIikKCQkJLnJlcGxhY2UoLyJbXiJcXFxuXHJdKiJ8dHJ1ZXxmYWxzZXxudWxsfC0/XGQrKD86XC5cZCopPyg/OltlRV1bK1wtXT9cZCspPy9nLCAiXSIpCgkJCS5yZXBsYWNlKC8oPzpefDp8LCkoPzpccypcWykrL2csICIiKSkgKSB7CgoJCQkvLyBUcnkgdG8gdXNlIHRoZSBuYXRpdmUgSlNPTiBwYXJzZXIgZmlyc3QKCQkJcmV0dXJuIHdpbmRvdy5KU09OICYmIHdpbmRvdy5KU09OLnBhcnNlID8KCQkJCXdpbmRvdy5KU09OLnBhcnNlKCBkYXRhICkgOgoJCQkJKG5ldyBGdW5jdGlvbigicmV0dXJuICIgKyBkYXRhKSkoKTsKCgkJfSBlbHNlIHsKCQkJalF1ZXJ5LmVycm9yKCAiSW52YWxpZCBKU09OOiAiICsgZGF0YSApOwoJCX0KCX0sCgoJbm9vcDogZnVuY3Rpb24oKSB7fSwKCgkvLyBFdmFsdWxhdGVzIGEgc2NyaXB0IGluIGEgZ2xvYmFsIGNvbnRleHQKCWdsb2JhbEV2YWw6IGZ1bmN0aW9uKCBkYXRhICkgewoJCWlmICggZGF0YSAmJiBybm90d2hpdGUudGVzdChkYXRhKSApIHsKCQkJLy8gSW5zcGlyZWQgYnkgY29kZSBieSBBbmRyZWEgR2lhbW1hcmNoaQoJCQkvLyBodHRwOi8vd2VicmVmbGVjdGlvbi5ibG9nc3BvdC5jb20vMjAwNy8wOC9nbG9iYWwtc2NvcGUtZXZhbHVhdGlvbi1hbmQtZG9tLmh0bWwKCQkJdmFyIGhlYWQgPSBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgiaGVhZCIpWzBdIHx8IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudCwKCQkJCXNjcmlwdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInNjcmlwdCIpOwoKCQkJc2NyaXB0LnR5cGUgPSAidGV4dC9qYXZhc2NyaXB0IjsKCgkJCWlmICggalF1ZXJ5LnN1cHBvcnQuc2NyaXB0RXZhbCApIHsKCQkJCXNjcmlwdC5hcHBlbmRDaGlsZCggZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoIGRhdGEgKSApOwoJCQl9IGVsc2UgewoJCQkJc2NyaXB0LnRleHQgPSBkYXRhOwoJCQl9CgoJCQkvLyBVc2UgaW5zZXJ0QmVmb3JlIGluc3RlYWQgb2YgYXBwZW5kQ2hpbGQgdG8gY2lyY3VtdmVudCBhbiBJRTYgYnVnLgoJCQkvLyBUaGlzIGFyaXNlcyB3aGVuIGEgYmFzZSBub2RlIGlzIHVzZWQgKCMyNzA5KS4KCQkJaGVhZC5pbnNlcnRCZWZvcmUoIHNjcmlwdCwgaGVhZC5maXJzdENoaWxkICk7CgkJCWhlYWQucmVtb3ZlQ2hpbGQoIHNjcmlwdCApOwoJCX0KCX0sCgoJbm9kZU5hbWU6IGZ1bmN0aW9uKCBlbGVtLCBuYW1lICkgewoJCXJldHVybiBlbGVtLm5vZGVOYW1lICYmIGVsZW0ubm9kZU5hbWUudG9VcHBlckNhc2UoKSA9PT0gbmFtZS50b1VwcGVyQ2FzZSgpOwoJfSwKCgkvLyBhcmdzIGlzIGZvciBpbnRlcm5hbCB1c2FnZSBvbmx5CgllYWNoOiBmdW5jdGlvbiggb2JqZWN0LCBjYWxsYmFjaywgYXJncyApIHsKCQl2YXIgbmFtZSwgaSA9IDAsCgkJCWxlbmd0aCA9IG9iamVjdC5sZW5ndGgsCgkJCWlzT2JqID0gbGVuZ3RoID09PSB1bmRlZmluZWQgfHwgalF1ZXJ5LmlzRnVuY3Rpb24ob2JqZWN0KTsKCgkJaWYgKCBhcmdzICkgewoJCQlpZiAoIGlzT2JqICkgewoJCQkJZm9yICggbmFtZSBpbiBvYmplY3QgKSB7CgkJCQkJaWYgKCBjYWxsYmFjay5hcHBseSggb2JqZWN0WyBuYW1lIF0sIGFyZ3MgKSA9PT0gZmFsc2UgKSB7CgkJCQkJCWJyZWFrOwoJCQkJCX0KCQkJCX0KCQkJfSBlbHNlIHsKCQkJCWZvciAoIDsgaSA8IGxlbmd0aDsgKSB7CgkJCQkJaWYgKCBjYWxsYmFjay5hcHBseSggb2JqZWN0WyBpKysgXSwgYXJncyApID09PSBmYWxzZSApIHsKCQkJCQkJYnJlYWs7CgkJCQkJfQoJCQkJfQoJCQl9CgoJCS8vIEEgc3BlY2lhbCwgZmFzdCwgY2FzZSBmb3IgdGhlIG1vc3QgY29tbW9uIHVzZSBvZiBlYWNoCgkJfSBlbHNlIHsKCQkJaWYgKCBpc09iaiApIHsKCQkJCWZvciAoIG5hbWUgaW4gb2JqZWN0ICkgewoJCQkJCWlmICggY2FsbGJhY2suY2FsbCggb2JqZWN0WyBuYW1lIF0sIG5hbWUsIG9iamVjdFsgbmFtZSBdICkgPT09IGZhbHNlICkgewoJCQkJCQlicmVhazsKCQkJCQl9CgkJCQl9CgkJCX0gZWxzZSB7CgkJCQlmb3IgKCB2YXIgdmFsdWUgPSBvYmplY3RbMF07CgkJCQkJaSA8IGxlbmd0aCAmJiBjYWxsYmFjay5jYWxsKCB2YWx1ZSwgaSwgdmFsdWUgKSAhPT0gZmFsc2U7IHZhbHVlID0gb2JqZWN0WysraV0gKSB7fQoJCQl9CgkJfQoKCQlyZXR1cm4gb2JqZWN0OwoJfSwKCgl0cmltOiBmdW5jdGlvbiggdGV4dCApIHsKCQlyZXR1cm4gKHRleHQgfHwgIiIpLnJlcGxhY2UoIHJ0cmltLCAiIiApOwoJfSwKCgkvLyByZXN1bHRzIGlzIGZvciBpbnRlcm5hbCB1c2FnZSBvbmx5CgltYWtlQXJyYXk6IGZ1bmN0aW9uKCBhcnJheSwgcmVzdWx0cyApIHsKCQl2YXIgcmV0ID0gcmVzdWx0cyB8fCBbXTsKCgkJaWYgKCBhcnJheSAhPSBudWxsICkgewoJCQkvLyBUaGUgd2luZG93LCBzdHJpbmdzIChhbmQgZnVuY3Rpb25zKSBhbHNvIGhhdmUgJ2xlbmd0aCcKCQkJLy8gVGhlIGV4dHJhIHR5cGVvZiBmdW5jdGlvbiBjaGVjayBpcyB0byBwcmV2ZW50IGNyYXNoZXMKCQkJLy8gaW4gU2FmYXJpIDIgKFNlZTogIzMwMzkpCgkJCWlmICggYXJyYXkubGVuZ3RoID09IG51bGwgfHwgdHlwZW9mIGFycmF5ID09PSAic3RyaW5nIiB8fCBqUXVlcnkuaXNGdW5jdGlvbihhcnJheSkgfHwgKHR5cGVvZiBhcnJheSAhPT0gImZ1bmN0aW9uIiAmJiBhcnJheS5zZXRJbnRlcnZhbCkgKSB7CgkJCQlwdXNoLmNhbGwoIHJldCwgYXJyYXkgKTsKCQkJfSBlbHNlIHsKCQkJCWpRdWVyeS5tZXJnZSggcmV0LCBhcnJheSApOwoJCQl9CgkJfQoKCQlyZXR1cm4gcmV0OwoJfSwKCglpbkFycmF5OiBmdW5jdGlvbiggZWxlbSwgYXJyYXkgKSB7CgkJaWYgKCBhcnJheS5pbmRleE9mICkgewoJCQlyZXR1cm4gYXJyYXkuaW5kZXhPZiggZWxlbSApOwoJCX0KCgkJZm9yICggdmFyIGkgPSAwLCBsZW5ndGggPSBhcnJheS5sZW5ndGg7IGkgPCBsZW5ndGg7IGkrKyApIHsKCQkJaWYgKCBhcnJheVsgaSBdID09PSBlbGVtICkgewoJCQkJcmV0dXJuIGk7CgkJCX0KCQl9CgoJCXJldHVybiAtMTsKCX0sCgoJbWVyZ2U6IGZ1bmN0aW9uKCBmaXJzdCwgc2Vjb25kICkgewoJCXZhciBpID0gZmlyc3QubGVuZ3RoLCBqID0gMDsKCgkJaWYgKCB0eXBlb2Ygc2Vjb25kLmxlbmd0aCA9PT0gIm51bWJlciIgKSB7CgkJCWZvciAoIHZhciBsID0gc2Vjb25kLmxlbmd0aDsgaiA8IGw7IGorKyApIHsKCQkJCWZpcnN0WyBpKysgXSA9IHNlY29uZFsgaiBdOwoJCQl9CgkJCgkJfSBlbHNlIHsKCQkJd2hpbGUgKCBzZWNvbmRbal0gIT09IHVuZGVmaW5lZCApIHsKCQkJCWZpcnN0WyBpKysgXSA9IHNlY29uZFsgaisrIF07CgkJCX0KCQl9CgoJCWZpcnN0Lmxlbmd0aCA9IGk7CgoJCXJldHVybiBmaXJzdDsKCX0sCgoJZ3JlcDogZnVuY3Rpb24oIGVsZW1zLCBjYWxsYmFjaywgaW52ICkgewoJCXZhciByZXQgPSBbXTsKCgkJLy8gR28gdGhyb3VnaCB0aGUgYXJyYXksIG9ubHkgc2F2aW5nIHRoZSBpdGVtcwoJCS8vIHRoYXQgcGFzcyB0aGUgdmFsaWRhdG9yIGZ1bmN0aW9uCgkJZm9yICggdmFyIGkgPSAwLCBsZW5ndGggPSBlbGVtcy5sZW5ndGg7IGkgPCBsZW5ndGg7IGkrKyApIHsKCQkJaWYgKCAhaW52ICE9PSAhY2FsbGJhY2soIGVsZW1zWyBpIF0sIGkgKSApIHsKCQkJCXJldC5wdXNoKCBlbGVtc1sgaSBdICk7CgkJCX0KCQl9CgoJCXJldHVybiByZXQ7Cgl9LAoKCS8vIGFyZyBpcyBmb3IgaW50ZXJuYWwgdXNhZ2Ugb25seQoJbWFwOiBmdW5jdGlvbiggZWxlbXMsIGNhbGxiYWNrLCBhcmcgKSB7CgkJdmFyIHJldCA9IFtdLCB2YWx1ZTsKCgkJLy8gR28gdGhyb3VnaCB0aGUgYXJyYXksIHRyYW5zbGF0aW5nIGVhY2ggb2YgdGhlIGl0ZW1zIHRvIHRoZWlyCgkJLy8gbmV3IHZhbHVlIChvciB2YWx1ZXMpLgoJCWZvciAoIHZhciBpID0gMCwgbGVuZ3RoID0gZWxlbXMubGVuZ3RoOyBpIDwgbGVuZ3RoOyBpKysgKSB7CgkJCXZhbHVlID0gY2FsbGJhY2soIGVsZW1zWyBpIF0sIGksIGFyZyApOwoKCQkJaWYgKCB2YWx1ZSAhPSBudWxsICkgewoJCQkJcmV0WyByZXQubGVuZ3RoIF0gPSB2YWx1ZTsKCQkJfQoJCX0KCgkJcmV0dXJuIHJldC5jb25jYXQuYXBwbHkoIFtdLCByZXQgKTsKCX0sCgoJLy8gQSBnbG9iYWwgR1VJRCBjb3VudGVyIGZvciBvYmplY3RzCglndWlkOiAxLAoKCXByb3h5OiBmdW5jdGlvbiggZm4sIHByb3h5LCB0aGlzT2JqZWN0ICkgewoJCWlmICggYXJndW1lbnRzLmxlbmd0aCA9PT0gMiApIHsKCQkJaWYgKCB0eXBlb2YgcHJveHkgPT09ICJzdHJpbmciICkgewoJCQkJdGhpc09iamVjdCA9IGZuOwoJCQkJZm4gPSB0aGlzT2JqZWN0WyBwcm94eSBdOwoJCQkJcHJveHkgPSB1bmRlZmluZWQ7CgoJCQl9IGVsc2UgaWYgKCBwcm94eSAmJiAhalF1ZXJ5LmlzRnVuY3Rpb24oIHByb3h5ICkgKSB7CgkJCQl0aGlzT2JqZWN0ID0gcHJveHk7CgkJCQlwcm94eSA9IHVuZGVmaW5lZDsKCQkJfQoJCX0KCgkJaWYgKCAhcHJveHkgJiYgZm4gKSB7CgkJCXByb3h5ID0gZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gZm4uYXBwbHkoIHRoaXNPYmplY3QgfHwgdGhpcywgYXJndW1lbnRzICk7CgkJCX07CgkJfQoKCQkvLyBTZXQgdGhlIGd1aWQgb2YgdW5pcXVlIGhhbmRsZXIgdG8gdGhlIHNhbWUgb2Ygb3JpZ2luYWwgaGFuZGxlciwgc28gaXQgY2FuIGJlIHJlbW92ZWQKCQlpZiAoIGZuICkgewoJCQlwcm94eS5ndWlkID0gZm4uZ3VpZCA9IGZuLmd1aWQgfHwgcHJveHkuZ3VpZCB8fCBqUXVlcnkuZ3VpZCsrOwoJCX0KCgkJLy8gU28gcHJveHkgY2FuIGJlIGRlY2xhcmVkIGFzIGFuIGFyZ3VtZW50CgkJcmV0dXJuIHByb3h5OwoJfSwKCgkvLyBVc2Ugb2YgalF1ZXJ5LmJyb3dzZXIgaXMgZnJvd25lZCB1cG9uLgoJLy8gTW9yZSBkZXRhaWxzOiBodHRwOi8vZG9jcy5qcXVlcnkuY29tL1V0aWxpdGllcy9qUXVlcnkuYnJvd3NlcgoJdWFNYXRjaDogZnVuY3Rpb24oIHVhICkgewoJCXVhID0gdWEudG9Mb3dlckNhc2UoKTsKCgkJdmFyIG1hdGNoID0gLyh3ZWJraXQpWyBcL10oW1x3Ll0rKS8uZXhlYyggdWEgKSB8fAoJCQkvKG9wZXJhKSg/Oi4qdmVyc2lvbik/WyBcL10oW1x3Ll0rKS8uZXhlYyggdWEgKSB8fAoJCQkvKG1zaWUpIChbXHcuXSspLy5leGVjKCB1YSApIHx8CgkJCSEvY29tcGF0aWJsZS8udGVzdCggdWEgKSAmJiAvKG1vemlsbGEpKD86Lio/IHJ2OihbXHcuXSspKT8vLmV4ZWMoIHVhICkgfHwKCQkgIAlbXTsKCgkJcmV0dXJuIHsgYnJvd3NlcjogbWF0Y2hbMV0gfHwgIiIsIHZlcnNpb246IG1hdGNoWzJdIHx8ICIwIiB9OwoJfSwKCglicm93c2VyOiB7fQp9KTsKCmJyb3dzZXJNYXRjaCA9IGpRdWVyeS51YU1hdGNoKCB1c2VyQWdlbnQgKTsKaWYgKCBicm93c2VyTWF0Y2guYnJvd3NlciApIHsKCWpRdWVyeS5icm93c2VyWyBicm93c2VyTWF0Y2guYnJvd3NlciBdID0gdHJ1ZTsKCWpRdWVyeS5icm93c2VyLnZlcnNpb24gPSBicm93c2VyTWF0Y2gudmVyc2lvbjsKfQoKLy8gRGVwcmVjYXRlZCwgdXNlIGpRdWVyeS5icm93c2VyLndlYmtpdCBpbnN0ZWFkCmlmICggalF1ZXJ5LmJyb3dzZXIud2Via2l0ICkgewoJalF1ZXJ5LmJyb3dzZXIuc2FmYXJpID0gdHJ1ZTsKfQoKaWYgKCBpbmRleE9mICkgewoJalF1ZXJ5LmluQXJyYXkgPSBmdW5jdGlvbiggZWxlbSwgYXJyYXkgKSB7CgkJcmV0dXJuIGluZGV4T2YuY2FsbCggYXJyYXksIGVsZW0gKTsKCX07Cn0KCi8vIEFsbCBqUXVlcnkgb2JqZWN0cyBzaG91bGQgcG9pbnQgYmFjayB0byB0aGVzZQpyb290alF1ZXJ5ID0galF1ZXJ5KGRvY3VtZW50KTsKCi8vIENsZWFudXAgZnVuY3Rpb25zIGZvciB0aGUgZG9jdW1lbnQgcmVhZHkgbWV0aG9kCmlmICggZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lciApIHsKCURPTUNvbnRlbnRMb2FkZWQgPSBmdW5jdGlvbigpIHsKCQlkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCAiRE9NQ29udGVudExvYWRlZCIsIERPTUNvbnRlbnRMb2FkZWQsIGZhbHNlICk7CgkJalF1ZXJ5LnJlYWR5KCk7Cgl9OwoKfSBlbHNlIGlmICggZG9jdW1lbnQuYXR0YWNoRXZlbnQgKSB7CglET01Db250ZW50TG9hZGVkID0gZnVuY3Rpb24oKSB7CgkJLy8gTWFrZSBzdXJlIGJvZHkgZXhpc3RzLCBhdCBsZWFzdCwgaW4gY2FzZSBJRSBnZXRzIGEgbGl0dGxlIG92ZXJ6ZWFsb3VzICh0aWNrZXQgIzU0NDMpLgoJCWlmICggZG9jdW1lbnQucmVhZHlTdGF0ZSA9PT0gImNvbXBsZXRlIiApIHsKCQkJZG9jdW1lbnQuZGV0YWNoRXZlbnQoICJvbnJlYWR5c3RhdGVjaGFuZ2UiLCBET01Db250ZW50TG9hZGVkICk7CgkJCWpRdWVyeS5yZWFkeSgpOwoJCX0KCX07Cn0KCi8vIFRoZSBET00gcmVhZHkgY2hlY2sgZm9yIEludGVybmV0IEV4cGxvcmVyCmZ1bmN0aW9uIGRvU2Nyb2xsQ2hlY2soKSB7CglpZiAoIGpRdWVyeS5pc1JlYWR5ICkgewoJCXJldHVybjsKCX0KCgl0cnkgewoJCS8vIElmIElFIGlzIHVzZWQsIHVzZSB0aGUgdHJpY2sgYnkgRGllZ28gUGVyaW5pCgkJLy8gaHR0cDovL2phdmFzY3JpcHQubndib3guY29tL0lFQ29udGVudExvYWRlZC8KCQlkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuZG9TY3JvbGwoImxlZnQiKTsKCX0gY2F0Y2goIGVycm9yICkgewoJCXNldFRpbWVvdXQoIGRvU2Nyb2xsQ2hlY2ssIDEgKTsKCQlyZXR1cm47Cgl9CgoJLy8gYW5kIGV4ZWN1dGUgYW55IHdhaXRpbmcgZnVuY3Rpb25zCglqUXVlcnkucmVhZHkoKTsKfQoKZnVuY3Rpb24gZXZhbFNjcmlwdCggaSwgZWxlbSApIHsKCWlmICggZWxlbS5zcmMgKSB7CgkJalF1ZXJ5LmFqYXgoewoJCQl1cmw6IGVsZW0uc3JjLAoJCQlhc3luYzogZmFsc2UsCgkJCWRhdGFUeXBlOiAic2NyaXB0IgoJCX0pOwoJfSBlbHNlIHsKCQlqUXVlcnkuZ2xvYmFsRXZhbCggZWxlbS50ZXh0IHx8IGVsZW0udGV4dENvbnRlbnQgfHwgZWxlbS5pbm5lckhUTUwgfHwgIiIgKTsKCX0KCglpZiAoIGVsZW0ucGFyZW50Tm9kZSApIHsKCQllbGVtLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoIGVsZW0gKTsKCX0KfQoKLy8gTXV0aWZ1bmN0aW9uYWwgbWV0aG9kIHRvIGdldCBhbmQgc2V0IHZhbHVlcyB0byBhIGNvbGxlY3Rpb24KLy8gVGhlIHZhbHVlL3MgY2FuIGJlIG9wdGlvbmFsbHkgYnkgZXhlY3V0ZWQgaWYgaXRzIGEgZnVuY3Rpb24KZnVuY3Rpb24gYWNjZXNzKCBlbGVtcywga2V5LCB2YWx1ZSwgZXhlYywgZm4sIHBhc3MgKSB7Cgl2YXIgbGVuZ3RoID0gZWxlbXMubGVuZ3RoOwoJCgkvLyBTZXR0aW5nIG1hbnkgYXR0cmlidXRlcwoJaWYgKCB0eXBlb2Yga2V5ID09PSAib2JqZWN0IiApIHsKCQlmb3IgKCB2YXIgayBpbiBrZXkgKSB7CgkJCWFjY2VzcyggZWxlbXMsIGssIGtleVtrXSwgZXhlYywgZm4sIHZhbHVlICk7CgkJfQoJCXJldHVybiBlbGVtczsKCX0KCQoJLy8gU2V0dGluZyBvbmUgYXR0cmlidXRlCglpZiAoIHZhbHVlICE9PSB1bmRlZmluZWQgKSB7CgkJLy8gT3B0aW9uYWxseSwgZnVuY3Rpb24gdmFsdWVzIGdldCBleGVjdXRlZCBpZiBleGVjIGlzIHRydWUKCQlleGVjID0gIXBhc3MgJiYgZXhlYyAmJiBqUXVlcnkuaXNGdW5jdGlvbih2YWx1ZSk7CgkJCgkJZm9yICggdmFyIGkgPSAwOyBpIDwgbGVuZ3RoOyBpKysgKSB7CgkJCWZuKCBlbGVtc1tpXSwga2V5LCBleGVjID8gdmFsdWUuY2FsbCggZWxlbXNbaV0sIGksIGZuKCBlbGVtc1tpXSwga2V5ICkgKSA6IHZhbHVlLCBwYXNzICk7CgkJfQoJCQoJCXJldHVybiBlbGVtczsKCX0KCQoJLy8gR2V0dGluZyBhbiBhdHRyaWJ1dGUKCXJldHVybiBsZW5ndGggPyBmbiggZWxlbXNbMF0sIGtleSApIDogdW5kZWZpbmVkOwp9CgpmdW5jdGlvbiBub3coKSB7CglyZXR1cm4gKG5ldyBEYXRlKS5nZXRUaW1lKCk7Cn0KKGZ1bmN0aW9uKCkgewoKCWpRdWVyeS5zdXBwb3J0ID0ge307CgoJdmFyIHJvb3QgPSBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQsCgkJc2NyaXB0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgic2NyaXB0IiksCgkJZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2IiksCgkJaWQgPSAic2NyaXB0IiArIG5vdygpOwoKCWRpdi5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiOwoJZGl2LmlubmVySFRNTCA9ICIgICA8bGluay8+PHRhYmxlPjwvdGFibGU+PGEgaHJlZj0nL2EnIHN0eWxlPSdjb2xvcjpyZWQ7ZmxvYXQ6bGVmdDtvcGFjaXR5Oi41NTsnPmE8L2E+PGlucHV0IHR5cGU9J2NoZWNrYm94Jy8+IjsKCgl2YXIgYWxsID0gZGl2LmdldEVsZW1lbnRzQnlUYWdOYW1lKCIqIiksCgkJYSA9IGRpdi5nZXRFbGVtZW50c0J5VGFnTmFtZSgiYSIpWzBdOwoKCS8vIENhbid0IGdldCBiYXNpYyB0ZXN0IHN1cHBvcnQKCWlmICggIWFsbCB8fCAhYWxsLmxlbmd0aCB8fCAhYSApIHsKCQlyZXR1cm47Cgl9CgoJalF1ZXJ5LnN1cHBvcnQgPSB7CgkJLy8gSUUgc3RyaXBzIGxlYWRpbmcgd2hpdGVzcGFjZSB3aGVuIC5pbm5lckhUTUwgaXMgdXNlZAoJCWxlYWRpbmdXaGl0ZXNwYWNlOiBkaXYuZmlyc3RDaGlsZC5ub2RlVHlwZSA9PT0gMywKCgkJLy8gTWFrZSBzdXJlIHRoYXQgdGJvZHkgZWxlbWVudHMgYXJlbid0IGF1dG9tYXRpY2FsbHkgaW5zZXJ0ZWQKCQkvLyBJRSB3aWxsIGluc2VydCB0aGVtIGludG8gZW1wdHkgdGFibGVzCgkJdGJvZHk6ICFkaXYuZ2V0RWxlbWVudHNCeVRhZ05hbWUoInRib2R5IikubGVuZ3RoLAoKCQkvLyBNYWtlIHN1cmUgdGhhdCBsaW5rIGVsZW1lbnRzIGdldCBzZXJpYWxpemVkIGNvcnJlY3RseSBieSBpbm5lckhUTUwKCQkvLyBUaGlzIHJlcXVpcmVzIGEgd3JhcHBlciBlbGVtZW50IGluIElFCgkJaHRtbFNlcmlhbGl6ZTogISFkaXYuZ2V0RWxlbWVudHNCeVRhZ05hbWUoImxpbmsiKS5sZW5ndGgsCgoJCS8vIEdldCB0aGUgc3R5bGUgaW5mb3JtYXRpb24gZnJvbSBnZXRBdHRyaWJ1dGUKCQkvLyAoSUUgdXNlcyAuY3NzVGV4dCBpbnN0ZWQpCgkJc3R5bGU6IC9yZWQvLnRlc3QoIGEuZ2V0QXR0cmlidXRlKCJzdHlsZSIpICksCgoJCS8vIE1ha2Ugc3VyZSB0aGF0IFVSTHMgYXJlbid0IG1hbmlwdWxhdGVkCgkJLy8gKElFIG5vcm1hbGl6ZXMgaXQgYnkgZGVmYXVsdCkKCQlocmVmTm9ybWFsaXplZDogYS5nZXRBdHRyaWJ1dGUoImhyZWYiKSA9PT0gIi9hIiwKCgkJLy8gTWFrZSBzdXJlIHRoYXQgZWxlbWVudCBvcGFjaXR5IGV4aXN0cwoJCS8vIChJRSB1c2VzIGZpbHRlciBpbnN0ZWFkKQoJCS8vIFVzZSBhIHJlZ2V4IHRvIHdvcmsgYXJvdW5kIGEgV2ViS2l0IGlzc3VlLiBTZWUgIzUxNDUKCQlvcGFjaXR5OiAvXjAuNTUkLy50ZXN0KCBhLnN0eWxlLm9wYWNpdHkgKSwKCgkJLy8gVmVyaWZ5IHN0eWxlIGZsb2F0IGV4aXN0ZW5jZQoJCS8vIChJRSB1c2VzIHN0eWxlRmxvYXQgaW5zdGVhZCBvZiBjc3NGbG9hdCkKCQljc3NGbG9hdDogISFhLnN0eWxlLmNzc0Zsb2F0LAoKCQkvLyBNYWtlIHN1cmUgdGhhdCBpZiBubyB2YWx1ZSBpcyBzcGVjaWZpZWQgZm9yIGEgY2hlY2tib3gKCQkvLyB0aGF0IGl0IGRlZmF1bHRzIHRvICJvbiIuCgkJLy8gKFdlYktpdCBkZWZhdWx0cyB0byAiIiBpbnN0ZWFkKQoJCWNoZWNrT246IGRpdi5nZXRFbGVtZW50c0J5VGFnTmFtZSgiaW5wdXQiKVswXS52YWx1ZSA9PT0gIm9uIiwKCgkJLy8gTWFrZSBzdXJlIHRoYXQgYSBzZWxlY3RlZC1ieS1kZWZhdWx0IG9wdGlvbiBoYXMgYSB3b3JraW5nIHNlbGVjdGVkIHByb3BlcnR5LgoJCS8vIChXZWJLaXQgZGVmYXVsdHMgdG8gZmFsc2UgaW5zdGVhZCBvZiB0cnVlLCBJRSB0b28sIGlmIGl0J3MgaW4gYW4gb3B0Z3JvdXApCgkJb3B0U2VsZWN0ZWQ6IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInNlbGVjdCIpLmFwcGVuZENoaWxkKCBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJvcHRpb24iKSApLnNlbGVjdGVkLAoKCQlwYXJlbnROb2RlOiBkaXYucmVtb3ZlQ2hpbGQoIGRpdi5hcHBlbmRDaGlsZCggZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2IikgKSApLnBhcmVudE5vZGUgPT09IG51bGwsCgoJCS8vIFdpbGwgYmUgZGVmaW5lZCBsYXRlcgoJCWRlbGV0ZUV4cGFuZG86IHRydWUsCgkJY2hlY2tDbG9uZTogZmFsc2UsCgkJc2NyaXB0RXZhbDogZmFsc2UsCgkJbm9DbG9uZUV2ZW50OiB0cnVlLAoJCWJveE1vZGVsOiBudWxsCgl9OwoKCXNjcmlwdC50eXBlID0gInRleHQvamF2YXNjcmlwdCI7Cgl0cnkgewoJCXNjcmlwdC5hcHBlbmRDaGlsZCggZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoICJ3aW5kb3cuIiArIGlkICsgIj0xOyIgKSApOwoJfSBjYXRjaChlKSB7fQoKCXJvb3QuaW5zZXJ0QmVmb3JlKCBzY3JpcHQsIHJvb3QuZmlyc3RDaGlsZCApOwoKCS8vIE1ha2Ugc3VyZSB0aGF0IHRoZSBleGVjdXRpb24gb2YgY29kZSB3b3JrcyBieSBpbmplY3RpbmcgYSBzY3JpcHQKCS8vIHRhZyB3aXRoIGFwcGVuZENoaWxkL2NyZWF0ZVRleHROb2RlCgkvLyAoSUUgZG9lc24ndCBzdXBwb3J0IHRoaXMsIGZhaWxzLCBhbmQgdXNlcyAudGV4dCBpbnN0ZWFkKQoJaWYgKCB3aW5kb3dbIGlkIF0gKSB7CgkJalF1ZXJ5LnN1cHBvcnQuc2NyaXB0RXZhbCA9IHRydWU7CgkJZGVsZXRlIHdpbmRvd1sgaWQgXTsKCX0KCgkvLyBUZXN0IHRvIHNlZSBpZiBpdCdzIHBvc3NpYmxlIHRvIGRlbGV0ZSBhbiBleHBhbmRvIGZyb20gYW4gZWxlbWVudAoJLy8gRmFpbHMgaW4gSW50ZXJuZXQgRXhwbG9yZXIKCXRyeSB7CgkJZGVsZXRlIHNjcmlwdC50ZXN0OwoJCgl9IGNhdGNoKGUpIHsKCQlqUXVlcnkuc3VwcG9ydC5kZWxldGVFeHBhbmRvID0gZmFsc2U7Cgl9CgoJcm9vdC5yZW1vdmVDaGlsZCggc2NyaXB0ICk7CgoJaWYgKCBkaXYuYXR0YWNoRXZlbnQgJiYgZGl2LmZpcmVFdmVudCApIHsKCQlkaXYuYXR0YWNoRXZlbnQoIm9uY2xpY2siLCBmdW5jdGlvbiBjbGljaygpIHsKCQkJLy8gQ2xvbmluZyBhIG5vZGUgc2hvdWxkbid0IGNvcHkgb3ZlciBhbnkKCQkJLy8gYm91bmQgZXZlbnQgaGFuZGxlcnMgKElFIGRvZXMgdGhpcykKCQkJalF1ZXJ5LnN1cHBvcnQubm9DbG9uZUV2ZW50ID0gZmFsc2U7CgkJCWRpdi5kZXRhY2hFdmVudCgib25jbGljayIsIGNsaWNrKTsKCQl9KTsKCQlkaXYuY2xvbmVOb2RlKHRydWUpLmZpcmVFdmVudCgib25jbGljayIpOwoJfQoKCWRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwoJZGl2LmlubmVySFRNTCA9ICI8aW5wdXQgdHlwZT0ncmFkaW8nIG5hbWU9J3JhZGlvdGVzdCcgY2hlY2tlZD0nY2hlY2tlZCcvPiI7CgoJdmFyIGZyYWdtZW50ID0gZG9jdW1lbnQuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpOwoJZnJhZ21lbnQuYXBwZW5kQ2hpbGQoIGRpdi5maXJzdENoaWxkICk7CgoJLy8gV2ViS2l0IGRvZXNuJ3QgY2xvbmUgY2hlY2tlZCBzdGF0ZSBjb3JyZWN0bHkgaW4gZnJhZ21lbnRzCglqUXVlcnkuc3VwcG9ydC5jaGVja0Nsb25lID0gZnJhZ21lbnQuY2xvbmVOb2RlKHRydWUpLmNsb25lTm9kZSh0cnVlKS5sYXN0Q2hpbGQuY2hlY2tlZDsKCgkvLyBGaWd1cmUgb3V0IGlmIHRoZSBXM0MgYm94IG1vZGVsIHdvcmtzIGFzIGV4cGVjdGVkCgkvLyBkb2N1bWVudC5ib2R5IG11c3QgZXhpc3QgYmVmb3JlIHdlIGNhbiBkbyB0aGlzCglqUXVlcnkoZnVuY3Rpb24oKSB7CgkJdmFyIGRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwoJCWRpdi5zdHlsZS53aWR0aCA9IGRpdi5zdHlsZS5wYWRkaW5nTGVmdCA9ICIxcHgiOwoKCQlkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKCBkaXYgKTsKCQlqUXVlcnkuYm94TW9kZWwgPSBqUXVlcnkuc3VwcG9ydC5ib3hNb2RlbCA9IGRpdi5vZmZzZXRXaWR0aCA9PT0gMjsKCQlkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKCBkaXYgKS5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwoKCQlkaXYgPSBudWxsOwoJfSk7CgoJLy8gVGVjaG5pcXVlIGZyb20gSnVyaXkgWmF5dHNldgoJLy8gaHR0cDovL3RoaW5rd2ViMi5jb20vcHJvamVjdHMvcHJvdG90eXBlL2RldGVjdGluZy1ldmVudC1zdXBwb3J0LXdpdGhvdXQtYnJvd3Nlci1zbmlmZmluZy8KCXZhciBldmVudFN1cHBvcnRlZCA9IGZ1bmN0aW9uKCBldmVudE5hbWUgKSB7IAoJCXZhciBlbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOyAKCQlldmVudE5hbWUgPSAib24iICsgZXZlbnROYW1lOyAKCgkJdmFyIGlzU3VwcG9ydGVkID0gKGV2ZW50TmFtZSBpbiBlbCk7IAoJCWlmICggIWlzU3VwcG9ydGVkICkgeyAKCQkJZWwuc2V0QXR0cmlidXRlKGV2ZW50TmFtZSwgInJldHVybjsiKTsgCgkJCWlzU3VwcG9ydGVkID0gdHlwZW9mIGVsW2V2ZW50TmFtZV0gPT09ICJmdW5jdGlvbiI7IAoJCX0gCgkJZWwgPSBudWxsOyAKCgkJcmV0dXJuIGlzU3VwcG9ydGVkOyAKCX07CgkKCWpRdWVyeS5zdXBwb3J0LnN1Ym1pdEJ1YmJsZXMgPSBldmVudFN1cHBvcnRlZCgic3VibWl0Iik7CglqUXVlcnkuc3VwcG9ydC5jaGFuZ2VCdWJibGVzID0gZXZlbnRTdXBwb3J0ZWQoImNoYW5nZSIpOwoKCS8vIHJlbGVhc2UgbWVtb3J5IGluIElFCglyb290ID0gc2NyaXB0ID0gZGl2ID0gYWxsID0gYSA9IG51bGw7Cn0pKCk7CgpqUXVlcnkucHJvcHMgPSB7CgkiZm9yIjogImh0bWxGb3IiLAoJImNsYXNzIjogImNsYXNzTmFtZSIsCglyZWFkb25seTogInJlYWRPbmx5IiwKCW1heGxlbmd0aDogIm1heExlbmd0aCIsCgljZWxsc3BhY2luZzogImNlbGxTcGFjaW5nIiwKCXJvd3NwYW46ICJyb3dTcGFuIiwKCWNvbHNwYW46ICJjb2xTcGFuIiwKCXRhYmluZGV4OiAidGFiSW5kZXgiLAoJdXNlbWFwOiAidXNlTWFwIiwKCWZyYW1lYm9yZGVyOiAiZnJhbWVCb3JkZXIiCn07CnZhciBleHBhbmRvID0gImpRdWVyeSIgKyBub3coKSwgdXVpZCA9IDAsIHdpbmRvd0RhdGEgPSB7fTsKCmpRdWVyeS5leHRlbmQoewoJY2FjaGU6IHt9LAoJCglleHBhbmRvOmV4cGFuZG8sCgoJLy8gVGhlIGZvbGxvd2luZyBlbGVtZW50cyB0aHJvdyB1bmNhdGNoYWJsZSBleGNlcHRpb25zIGlmIHlvdQoJLy8gYXR0ZW1wdCB0byBhZGQgZXhwYW5kbyBwcm9wZXJ0aWVzIHRvIHRoZW0uCglub0RhdGE6IHsKCQkiZW1iZWQiOiB0cnVlLAoJCSJvYmplY3QiOiB0cnVlLAoJCSJhcHBsZXQiOiB0cnVlCgl9LAoKCWRhdGE6IGZ1bmN0aW9uKCBlbGVtLCBuYW1lLCBkYXRhICkgewoJCWlmICggZWxlbS5ub2RlTmFtZSAmJiBqUXVlcnkubm9EYXRhW2VsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKV0gKSB7CgkJCXJldHVybjsKCQl9CgoJCWVsZW0gPSBlbGVtID09IHdpbmRvdyA/CgkJCXdpbmRvd0RhdGEgOgoJCQllbGVtOwoKCQl2YXIgaWQgPSBlbGVtWyBleHBhbmRvIF0sIGNhY2hlID0galF1ZXJ5LmNhY2hlLCB0aGlzQ2FjaGU7CgoJCWlmICggIWlkICYmIHR5cGVvZiBuYW1lID09PSAic3RyaW5nIiAmJiBkYXRhID09PSB1bmRlZmluZWQgKSB7CgkJCXJldHVybiBudWxsOwoJCX0KCgkJLy8gQ29tcHV0ZSBhIHVuaXF1ZSBJRCBmb3IgdGhlIGVsZW1lbnQKCQlpZiAoICFpZCApIHsgCgkJCWlkID0gKyt1dWlkOwoJCX0KCgkJLy8gQXZvaWQgZ2VuZXJhdGluZyBhIG5ldyBjYWNoZSB1bmxlc3Mgbm9uZSBleGlzdHMgYW5kIHdlCgkJLy8gd2FudCB0byBtYW5pcHVsYXRlIGl0LgoJCWlmICggdHlwZW9mIG5hbWUgPT09ICJvYmplY3QiICkgewoJCQllbGVtWyBleHBhbmRvIF0gPSBpZDsKCQkJdGhpc0NhY2hlID0gY2FjaGVbIGlkIF0gPSBqUXVlcnkuZXh0ZW5kKHRydWUsIHt9LCBuYW1lKTsKCgkJfSBlbHNlIGlmICggIWNhY2hlWyBpZCBdICkgewoJCQllbGVtWyBleHBhbmRvIF0gPSBpZDsKCQkJY2FjaGVbIGlkIF0gPSB7fTsKCQl9CgoJCXRoaXNDYWNoZSA9IGNhY2hlWyBpZCBdOwoKCQkvLyBQcmV2ZW50IG92ZXJyaWRpbmcgdGhlIG5hbWVkIGNhY2hlIHdpdGggdW5kZWZpbmVkIHZhbHVlcwoJCWlmICggZGF0YSAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzQ2FjaGVbIG5hbWUgXSA9IGRhdGE7CgkJfQoKCQlyZXR1cm4gdHlwZW9mIG5hbWUgPT09ICJzdHJpbmciID8gdGhpc0NhY2hlWyBuYW1lIF0gOiB0aGlzQ2FjaGU7Cgl9LAoKCXJlbW92ZURhdGE6IGZ1bmN0aW9uKCBlbGVtLCBuYW1lICkgewoJCWlmICggZWxlbS5ub2RlTmFtZSAmJiBqUXVlcnkubm9EYXRhW2VsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKV0gKSB7CgkJCXJldHVybjsKCQl9CgoJCWVsZW0gPSBlbGVtID09IHdpbmRvdyA/CgkJCXdpbmRvd0RhdGEgOgoJCQllbGVtOwoKCQl2YXIgaWQgPSBlbGVtWyBleHBhbmRvIF0sIGNhY2hlID0galF1ZXJ5LmNhY2hlLCB0aGlzQ2FjaGUgPSBjYWNoZVsgaWQgXTsKCgkJLy8gSWYgd2Ugd2FudCB0byByZW1vdmUgYSBzcGVjaWZpYyBzZWN0aW9uIG9mIHRoZSBlbGVtZW50J3MgZGF0YQoJCWlmICggbmFtZSApIHsKCQkJaWYgKCB0aGlzQ2FjaGUgKSB7CgkJCQkvLyBSZW1vdmUgdGhlIHNlY3Rpb24gb2YgY2FjaGUgZGF0YQoJCQkJZGVsZXRlIHRoaXNDYWNoZVsgbmFtZSBdOwoKCQkJCS8vIElmIHdlJ3ZlIHJlbW92ZWQgYWxsIHRoZSBkYXRhLCByZW1vdmUgdGhlIGVsZW1lbnQncyBjYWNoZQoJCQkJaWYgKCBqUXVlcnkuaXNFbXB0eU9iamVjdCh0aGlzQ2FjaGUpICkgewoJCQkJCWpRdWVyeS5yZW1vdmVEYXRhKCBlbGVtICk7CgkJCQl9CgkJCX0KCgkJLy8gT3RoZXJ3aXNlLCB3ZSB3YW50IHRvIHJlbW92ZSBhbGwgb2YgdGhlIGVsZW1lbnQncyBkYXRhCgkJfSBlbHNlIHsKCQkJaWYgKCBqUXVlcnkuc3VwcG9ydC5kZWxldGVFeHBhbmRvICkgewoJCQkJZGVsZXRlIGVsZW1bIGpRdWVyeS5leHBhbmRvIF07CgoJCQl9IGVsc2UgaWYgKCBlbGVtLnJlbW92ZUF0dHJpYnV0ZSApIHsKCQkJCWVsZW0ucmVtb3ZlQXR0cmlidXRlKCBqUXVlcnkuZXhwYW5kbyApOwoJCQl9CgoJCQkvLyBDb21wbGV0ZWx5IHJlbW92ZSB0aGUgZGF0YSBjYWNoZQoJCQlkZWxldGUgY2FjaGVbIGlkIF07CgkJfQoJfQp9KTsKCmpRdWVyeS5mbi5leHRlbmQoewoJZGF0YTogZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CgkJaWYgKCB0eXBlb2Yga2V5ID09PSAidW5kZWZpbmVkIiAmJiB0aGlzLmxlbmd0aCApIHsKCQkJcmV0dXJuIGpRdWVyeS5kYXRhKCB0aGlzWzBdICk7CgoJCX0gZWxzZSBpZiAoIHR5cGVvZiBrZXkgPT09ICJvYmplY3QiICkgewoJCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJalF1ZXJ5LmRhdGEoIHRoaXMsIGtleSApOwoJCQl9KTsKCQl9CgoJCXZhciBwYXJ0cyA9IGtleS5zcGxpdCgiLiIpOwoJCXBhcnRzWzFdID0gcGFydHNbMV0gPyAiLiIgKyBwYXJ0c1sxXSA6ICIiOwoKCQlpZiAoIHZhbHVlID09PSB1bmRlZmluZWQgKSB7CgkJCXZhciBkYXRhID0gdGhpcy50cmlnZ2VySGFuZGxlcigiZ2V0RGF0YSIgKyBwYXJ0c1sxXSArICIhIiwgW3BhcnRzWzBdXSk7CgoJCQlpZiAoIGRhdGEgPT09IHVuZGVmaW5lZCAmJiB0aGlzLmxlbmd0aCApIHsKCQkJCWRhdGEgPSBqUXVlcnkuZGF0YSggdGhpc1swXSwga2V5ICk7CgkJCX0KCQkJcmV0dXJuIGRhdGEgPT09IHVuZGVmaW5lZCAmJiBwYXJ0c1sxXSA/CgkJCQl0aGlzLmRhdGEoIHBhcnRzWzBdICkgOgoJCQkJZGF0YTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy50cmlnZ2VyKCJzZXREYXRhIiArIHBhcnRzWzFdICsgIiEiLCBbcGFydHNbMF0sIHZhbHVlXSkuZWFjaChmdW5jdGlvbigpIHsKCQkJCWpRdWVyeS5kYXRhKCB0aGlzLCBrZXksIHZhbHVlICk7CgkJCX0pOwoJCX0KCX0sCgoJcmVtb3ZlRGF0YTogZnVuY3Rpb24oIGtleSApIHsKCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQlqUXVlcnkucmVtb3ZlRGF0YSggdGhpcywga2V5ICk7CgkJfSk7Cgl9Cn0pOwpqUXVlcnkuZXh0ZW5kKHsKCXF1ZXVlOiBmdW5jdGlvbiggZWxlbSwgdHlwZSwgZGF0YSApIHsKCQlpZiAoICFlbGVtICkgewoJCQlyZXR1cm47CgkJfQoKCQl0eXBlID0gKHR5cGUgfHwgImZ4IikgKyAicXVldWUiOwoJCXZhciBxID0galF1ZXJ5LmRhdGEoIGVsZW0sIHR5cGUgKTsKCgkJLy8gU3BlZWQgdXAgZGVxdWV1ZSBieSBnZXR0aW5nIG91dCBxdWlja2x5IGlmIHRoaXMgaXMganVzdCBhIGxvb2t1cAoJCWlmICggIWRhdGEgKSB7CgkJCXJldHVybiBxIHx8IFtdOwoJCX0KCgkJaWYgKCAhcSB8fCBqUXVlcnkuaXNBcnJheShkYXRhKSApIHsKCQkJcSA9IGpRdWVyeS5kYXRhKCBlbGVtLCB0eXBlLCBqUXVlcnkubWFrZUFycmF5KGRhdGEpICk7CgoJCX0gZWxzZSB7CgkJCXEucHVzaCggZGF0YSApOwoJCX0KCgkJcmV0dXJuIHE7Cgl9LAoKCWRlcXVldWU6IGZ1bmN0aW9uKCBlbGVtLCB0eXBlICkgewoJCXR5cGUgPSB0eXBlIHx8ICJmeCI7CgoJCXZhciBxdWV1ZSA9IGpRdWVyeS5xdWV1ZSggZWxlbSwgdHlwZSApLCBmbiA9IHF1ZXVlLnNoaWZ0KCk7CgoJCS8vIElmIHRoZSBmeCBxdWV1ZSBpcyBkZXF1ZXVlZCwgYWx3YXlzIHJlbW92ZSB0aGUgcHJvZ3Jlc3Mgc2VudGluZWwKCQlpZiAoIGZuID09PSAiaW5wcm9ncmVzcyIgKSB7CgkJCWZuID0gcXVldWUuc2hpZnQoKTsKCQl9CgoJCWlmICggZm4gKSB7CgkJCS8vIEFkZCBhIHByb2dyZXNzIHNlbnRpbmVsIHRvIHByZXZlbnQgdGhlIGZ4IHF1ZXVlIGZyb20gYmVpbmcKCQkJLy8gYXV0b21hdGljYWxseSBkZXF1ZXVlZAoJCQlpZiAoIHR5cGUgPT09ICJmeCIgKSB7CgkJCQlxdWV1ZS51bnNoaWZ0KCJpbnByb2dyZXNzIik7CgkJCX0KCgkJCWZuLmNhbGwoZWxlbSwgZnVuY3Rpb24oKSB7CgkJCQlqUXVlcnkuZGVxdWV1ZShlbGVtLCB0eXBlKTsKCQkJfSk7CgkJfQoJfQp9KTsKCmpRdWVyeS5mbi5leHRlbmQoewoJcXVldWU6IGZ1bmN0aW9uKCB0eXBlLCBkYXRhICkgewoJCWlmICggdHlwZW9mIHR5cGUgIT09ICJzdHJpbmciICkgewoJCQlkYXRhID0gdHlwZTsKCQkJdHlwZSA9ICJmeCI7CgkJfQoKCQlpZiAoIGRhdGEgPT09IHVuZGVmaW5lZCApIHsKCQkJcmV0dXJuIGpRdWVyeS5xdWV1ZSggdGhpc1swXSwgdHlwZSApOwoJCX0KCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCBpLCBlbGVtICkgewoJCQl2YXIgcXVldWUgPSBqUXVlcnkucXVldWUoIHRoaXMsIHR5cGUsIGRhdGEgKTsKCgkJCWlmICggdHlwZSA9PT0gImZ4IiAmJiBxdWV1ZVswXSAhPT0gImlucHJvZ3Jlc3MiICkgewoJCQkJalF1ZXJ5LmRlcXVldWUoIHRoaXMsIHR5cGUgKTsKCQkJfQoJCX0pOwoJfSwKCWRlcXVldWU6IGZ1bmN0aW9uKCB0eXBlICkgewoJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgkJCWpRdWVyeS5kZXF1ZXVlKCB0aGlzLCB0eXBlICk7CgkJfSk7Cgl9LAoKCS8vIEJhc2VkIG9mZiBvZiB0aGUgcGx1Z2luIGJ5IENsaW50IEhlbGZlcnMsIHdpdGggcGVybWlzc2lvbi4KCS8vIGh0dHA6Ly9ibGluZHNpZ25hbHMuY29tL2luZGV4LnBocC8yMDA5LzA3L2pxdWVyeS1kZWxheS8KCWRlbGF5OiBmdW5jdGlvbiggdGltZSwgdHlwZSApIHsKCQl0aW1lID0galF1ZXJ5LmZ4ID8galF1ZXJ5LmZ4LnNwZWVkc1t0aW1lXSB8fCB0aW1lIDogdGltZTsKCQl0eXBlID0gdHlwZSB8fCAiZngiOwoKCQlyZXR1cm4gdGhpcy5xdWV1ZSggdHlwZSwgZnVuY3Rpb24oKSB7CgkJCXZhciBlbGVtID0gdGhpczsKCQkJc2V0VGltZW91dChmdW5jdGlvbigpIHsKCQkJCWpRdWVyeS5kZXF1ZXVlKCBlbGVtLCB0eXBlICk7CgkJCX0sIHRpbWUgKTsKCQl9KTsKCX0sCgoJY2xlYXJRdWV1ZTogZnVuY3Rpb24oIHR5cGUgKSB7CgkJcmV0dXJuIHRoaXMucXVldWUoIHR5cGUgfHwgImZ4IiwgW10gKTsKCX0KfSk7CnZhciByY2xhc3MgPSAvW1xuXHRdL2csCglyc3BhY2UgPSAvXHMrLywKCXJyZXR1cm4gPSAvXHIvZywKCXJzcGVjaWFsdXJsID0gL2hyZWZ8c3JjfHN0eWxlLywKCXJ0eXBlID0gLyhidXR0b258aW5wdXQpL2ksCglyZm9jdXNhYmxlID0gLyhidXR0b258aW5wdXR8b2JqZWN0fHNlbGVjdHx0ZXh0YXJlYSkvaSwKCXJjbGlja2FibGUgPSAvXihhfGFyZWEpJC9pLAoJcnJhZGlvY2hlY2sgPSAvcmFkaW98Y2hlY2tib3gvOwoKalF1ZXJ5LmZuLmV4dGVuZCh7CglhdHRyOiBmdW5jdGlvbiggbmFtZSwgdmFsdWUgKSB7CgkJcmV0dXJuIGFjY2VzcyggdGhpcywgbmFtZSwgdmFsdWUsIHRydWUsIGpRdWVyeS5hdHRyICk7Cgl9LAoKCXJlbW92ZUF0dHI6IGZ1bmN0aW9uKCBuYW1lLCBmbiApIHsKCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCl7CgkJCWpRdWVyeS5hdHRyKCB0aGlzLCBuYW1lLCAiIiApOwoJCQlpZiAoIHRoaXMubm9kZVR5cGUgPT09IDEgKSB7CgkJCQl0aGlzLnJlbW92ZUF0dHJpYnV0ZSggbmFtZSApOwoJCQl9CgkJfSk7Cgl9LAoKCWFkZENsYXNzOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJaWYgKCBqUXVlcnkuaXNGdW5jdGlvbih2YWx1ZSkgKSB7CgkJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oaSkgewoJCQkJdmFyIHNlbGYgPSBqUXVlcnkodGhpcyk7CgkJCQlzZWxmLmFkZENsYXNzKCB2YWx1ZS5jYWxsKHRoaXMsIGksIHNlbGYuYXR0cigiY2xhc3MiKSkgKTsKCQkJfSk7CgkJfQoKCQlpZiAoIHZhbHVlICYmIHR5cGVvZiB2YWx1ZSA9PT0gInN0cmluZyIgKSB7CgkJCXZhciBjbGFzc05hbWVzID0gKHZhbHVlIHx8ICIiKS5zcGxpdCggcnNwYWNlICk7CgoJCQlmb3IgKCB2YXIgaSA9IDAsIGwgPSB0aGlzLmxlbmd0aDsgaSA8IGw7IGkrKyApIHsKCQkJCXZhciBlbGVtID0gdGhpc1tpXTsKCgkJCQlpZiAoIGVsZW0ubm9kZVR5cGUgPT09IDEgKSB7CgkJCQkJaWYgKCAhZWxlbS5jbGFzc05hbWUgKSB7CgkJCQkJCWVsZW0uY2xhc3NOYW1lID0gdmFsdWU7CgoJCQkJCX0gZWxzZSB7CgkJCQkJCXZhciBjbGFzc05hbWUgPSAiICIgKyBlbGVtLmNsYXNzTmFtZSArICIgIiwgc2V0Q2xhc3MgPSBlbGVtLmNsYXNzTmFtZTsKCQkJCQkJZm9yICggdmFyIGMgPSAwLCBjbCA9IGNsYXNzTmFtZXMubGVuZ3RoOyBjIDwgY2w7IGMrKyApIHsKCQkJCQkJCWlmICggY2xhc3NOYW1lLmluZGV4T2YoICIgIiArIGNsYXNzTmFtZXNbY10gKyAiICIgKSA8IDAgKSB7CgkJCQkJCQkJc2V0Q2xhc3MgKz0gIiAiICsgY2xhc3NOYW1lc1tjXTsKCQkJCQkJCX0KCQkJCQkJfQoJCQkJCQllbGVtLmNsYXNzTmFtZSA9IGpRdWVyeS50cmltKCBzZXRDbGFzcyApOwoJCQkJCX0KCQkJCX0KCQkJfQoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9LAoKCXJlbW92ZUNsYXNzOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJaWYgKCBqUXVlcnkuaXNGdW5jdGlvbih2YWx1ZSkgKSB7CgkJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oaSkgewoJCQkJdmFyIHNlbGYgPSBqUXVlcnkodGhpcyk7CgkJCQlzZWxmLnJlbW92ZUNsYXNzKCB2YWx1ZS5jYWxsKHRoaXMsIGksIHNlbGYuYXR0cigiY2xhc3MiKSkgKTsKCQkJfSk7CgkJfQoKCQlpZiAoICh2YWx1ZSAmJiB0eXBlb2YgdmFsdWUgPT09ICJzdHJpbmciKSB8fCB2YWx1ZSA9PT0gdW5kZWZpbmVkICkgewoJCQl2YXIgY2xhc3NOYW1lcyA9ICh2YWx1ZSB8fCAiIikuc3BsaXQocnNwYWNlKTsKCgkJCWZvciAoIHZhciBpID0gMCwgbCA9IHRoaXMubGVuZ3RoOyBpIDwgbDsgaSsrICkgewoJCQkJdmFyIGVsZW0gPSB0aGlzW2ldOwoKCQkJCWlmICggZWxlbS5ub2RlVHlwZSA9PT0gMSAmJiBlbGVtLmNsYXNzTmFtZSApIHsKCQkJCQlpZiAoIHZhbHVlICkgewoJCQkJCQl2YXIgY2xhc3NOYW1lID0gKCIgIiArIGVsZW0uY2xhc3NOYW1lICsgIiAiKS5yZXBsYWNlKHJjbGFzcywgIiAiKTsKCQkJCQkJZm9yICggdmFyIGMgPSAwLCBjbCA9IGNsYXNzTmFtZXMubGVuZ3RoOyBjIDwgY2w7IGMrKyApIHsKCQkJCQkJCWNsYXNzTmFtZSA9IGNsYXNzTmFtZS5yZXBsYWNlKCIgIiArIGNsYXNzTmFtZXNbY10gKyAiICIsICIgIik7CgkJCQkJCX0KCQkJCQkJZWxlbS5jbGFzc05hbWUgPSBqUXVlcnkudHJpbSggY2xhc3NOYW1lICk7CgoJCQkJCX0gZWxzZSB7CgkJCQkJCWVsZW0uY2xhc3NOYW1lID0gIiI7CgkJCQkJfQoJCQkJfQoJCQl9CgkJfQoKCQlyZXR1cm4gdGhpczsKCX0sCgoJdG9nZ2xlQ2xhc3M6IGZ1bmN0aW9uKCB2YWx1ZSwgc3RhdGVWYWwgKSB7CgkJdmFyIHR5cGUgPSB0eXBlb2YgdmFsdWUsIGlzQm9vbCA9IHR5cGVvZiBzdGF0ZVZhbCA9PT0gImJvb2xlYW4iOwoKCQlpZiAoIGpRdWVyeS5pc0Z1bmN0aW9uKCB2YWx1ZSApICkgewoJCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKGkpIHsKCQkJCXZhciBzZWxmID0galF1ZXJ5KHRoaXMpOwoJCQkJc2VsZi50b2dnbGVDbGFzcyggdmFsdWUuY2FsbCh0aGlzLCBpLCBzZWxmLmF0dHIoImNsYXNzIiksIHN0YXRlVmFsKSwgc3RhdGVWYWwgKTsKCQkJfSk7CgkJfQoKCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQlpZiAoIHR5cGUgPT09ICJzdHJpbmciICkgewoJCQkJLy8gdG9nZ2xlIGluZGl2aWR1YWwgY2xhc3MgbmFtZXMKCQkJCXZhciBjbGFzc05hbWUsIGkgPSAwLCBzZWxmID0galF1ZXJ5KHRoaXMpLAoJCQkJCXN0YXRlID0gc3RhdGVWYWwsCgkJCQkJY2xhc3NOYW1lcyA9IHZhbHVlLnNwbGl0KCByc3BhY2UgKTsKCgkJCQl3aGlsZSAoIChjbGFzc05hbWUgPSBjbGFzc05hbWVzWyBpKysgXSkgKSB7CgkJCQkJLy8gY2hlY2sgZWFjaCBjbGFzc05hbWUgZ2l2ZW4sIHNwYWNlIHNlcGVyYXRlZCBsaXN0CgkJCQkJc3RhdGUgPSBpc0Jvb2wgPyBzdGF0ZSA6ICFzZWxmLmhhc0NsYXNzKCBjbGFzc05hbWUgKTsKCQkJCQlzZWxmWyBzdGF0ZSA/ICJhZGRDbGFzcyIgOiAicmVtb3ZlQ2xhc3MiIF0oIGNsYXNzTmFtZSApOwoJCQkJfQoKCQkJfSBlbHNlIGlmICggdHlwZSA9PT0gInVuZGVmaW5lZCIgfHwgdHlwZSA9PT0gImJvb2xlYW4iICkgewoJCQkJaWYgKCB0aGlzLmNsYXNzTmFtZSApIHsKCQkJCQkvLyBzdG9yZSBjbGFzc05hbWUgaWYgc2V0CgkJCQkJalF1ZXJ5LmRhdGEoIHRoaXMsICJfX2NsYXNzTmFtZV9fIiwgdGhpcy5jbGFzc05hbWUgKTsKCQkJCX0KCgkJCQkvLyB0b2dnbGUgd2hvbGUgY2xhc3NOYW1lCgkJCQl0aGlzLmNsYXNzTmFtZSA9IHRoaXMuY2xhc3NOYW1lIHx8IHZhbHVlID09PSBmYWxzZSA/ICIiIDogalF1ZXJ5LmRhdGEoIHRoaXMsICJfX2NsYXNzTmFtZV9fIiApIHx8ICIiOwoJCQl9CgkJfSk7Cgl9LAoKCWhhc0NsYXNzOiBmdW5jdGlvbiggc2VsZWN0b3IgKSB7CgkJdmFyIGNsYXNzTmFtZSA9ICIgIiArIHNlbGVjdG9yICsgIiAiOwoJCWZvciAoIHZhciBpID0gMCwgbCA9IHRoaXMubGVuZ3RoOyBpIDwgbDsgaSsrICkgewoJCQlpZiAoICgiICIgKyB0aGlzW2ldLmNsYXNzTmFtZSArICIgIikucmVwbGFjZShyY2xhc3MsICIgIikuaW5kZXhPZiggY2xhc3NOYW1lICkgPiAtMSApIHsKCQkJCXJldHVybiB0cnVlOwoJCQl9CgkJfQoKCQlyZXR1cm4gZmFsc2U7Cgl9LAoKCXZhbDogZnVuY3Rpb24oIHZhbHVlICkgewoJCWlmICggdmFsdWUgPT09IHVuZGVmaW5lZCApIHsKCQkJdmFyIGVsZW0gPSB0aGlzWzBdOwoKCQkJaWYgKCBlbGVtICkgewoJCQkJaWYgKCBqUXVlcnkubm9kZU5hbWUoIGVsZW0sICJvcHRpb24iICkgKSB7CgkJCQkJcmV0dXJuIChlbGVtLmF0dHJpYnV0ZXMudmFsdWUgfHwge30pLnNwZWNpZmllZCA/IGVsZW0udmFsdWUgOiBlbGVtLnRleHQ7CgkJCQl9CgoJCQkJLy8gV2UgbmVlZCB0byBoYW5kbGUgc2VsZWN0IGJveGVzIHNwZWNpYWwKCQkJCWlmICggalF1ZXJ5Lm5vZGVOYW1lKCBlbGVtLCAic2VsZWN0IiApICkgewoJCQkJCXZhciBpbmRleCA9IGVsZW0uc2VsZWN0ZWRJbmRleCwKCQkJCQkJdmFsdWVzID0gW10sCgkJCQkJCW9wdGlvbnMgPSBlbGVtLm9wdGlvbnMsCgkJCQkJCW9uZSA9IGVsZW0udHlwZSA9PT0gInNlbGVjdC1vbmUiOwoKCQkJCQkvLyBOb3RoaW5nIHdhcyBzZWxlY3RlZAoJCQkJCWlmICggaW5kZXggPCAwICkgewoJCQkJCQlyZXR1cm4gbnVsbDsKCQkJCQl9CgoJCQkJCS8vIExvb3AgdGhyb3VnaCBhbGwgdGhlIHNlbGVjdGVkIG9wdGlvbnMKCQkJCQlmb3IgKCB2YXIgaSA9IG9uZSA/IGluZGV4IDogMCwgbWF4ID0gb25lID8gaW5kZXggKyAxIDogb3B0aW9ucy5sZW5ndGg7IGkgPCBtYXg7IGkrKyApIHsKCQkJCQkJdmFyIG9wdGlvbiA9IG9wdGlvbnNbIGkgXTsKCgkJCQkJCWlmICggb3B0aW9uLnNlbGVjdGVkICkgewoJCQkJCQkJLy8gR2V0IHRoZSBzcGVjaWZjIHZhbHVlIGZvciB0aGUgb3B0aW9uCgkJCQkJCQl2YWx1ZSA9IGpRdWVyeShvcHRpb24pLnZhbCgpOwoKCQkJCQkJCS8vIFdlIGRvbid0IG5lZWQgYW4gYXJyYXkgZm9yIG9uZSBzZWxlY3RzCgkJCQkJCQlpZiAoIG9uZSApIHsKCQkJCQkJCQlyZXR1cm4gdmFsdWU7CgkJCQkJCQl9CgoJCQkJCQkJLy8gTXVsdGktU2VsZWN0cyByZXR1cm4gYW4gYXJyYXkKCQkJCQkJCXZhbHVlcy5wdXNoKCB2YWx1ZSApOwoJCQkJCQl9CgkJCQkJfQoKCQkJCQlyZXR1cm4gdmFsdWVzOwoJCQkJfQoKCQkJCS8vIEhhbmRsZSB0aGUgY2FzZSB3aGVyZSBpbiBXZWJraXQgIiIgaXMgcmV0dXJuZWQgaW5zdGVhZCBvZiAib24iIGlmIGEgdmFsdWUgaXNuJ3Qgc3BlY2lmaWVkCgkJCQlpZiAoIHJyYWRpb2NoZWNrLnRlc3QoIGVsZW0udHlwZSApICYmICFqUXVlcnkuc3VwcG9ydC5jaGVja09uICkgewoJCQkJCXJldHVybiBlbGVtLmdldEF0dHJpYnV0ZSgidmFsdWUiKSA9PT0gbnVsbCA/ICJvbiIgOiBlbGVtLnZhbHVlOwoJCQkJfQoJCQkJCgoJCQkJLy8gRXZlcnl0aGluZyBlbHNlLCB3ZSBqdXN0IGdyYWIgdGhlIHZhbHVlCgkJCQlyZXR1cm4gKGVsZW0udmFsdWUgfHwgIiIpLnJlcGxhY2UocnJldHVybiwgIiIpOwoKCQkJfQoKCQkJcmV0dXJuIHVuZGVmaW5lZDsKCQl9CgoJCXZhciBpc0Z1bmN0aW9uID0galF1ZXJ5LmlzRnVuY3Rpb24odmFsdWUpOwoKCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKGkpIHsKCQkJdmFyIHNlbGYgPSBqUXVlcnkodGhpcyksIHZhbCA9IHZhbHVlOwoKCQkJaWYgKCB0aGlzLm5vZGVUeXBlICE9PSAxICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQlpZiAoIGlzRnVuY3Rpb24gKSB7CgkJCQl2YWwgPSB2YWx1ZS5jYWxsKHRoaXMsIGksIHNlbGYudmFsKCkpOwoJCQl9CgoJCQkvLyBUeXBlY2FzdCBlYWNoIHRpbWUgaWYgdGhlIHZhbHVlIGlzIGEgRnVuY3Rpb24gYW5kIHRoZSBhcHBlbmRlZAoJCQkvLyB2YWx1ZSBpcyB0aGVyZWZvcmUgZGlmZmVyZW50IGVhY2ggdGltZS4KCQkJaWYgKCB0eXBlb2YgdmFsID09PSAibnVtYmVyIiApIHsKCQkJCXZhbCArPSAiIjsKCQkJfQoKCQkJaWYgKCBqUXVlcnkuaXNBcnJheSh2YWwpICYmIHJyYWRpb2NoZWNrLnRlc3QoIHRoaXMudHlwZSApICkgewoJCQkJdGhpcy5jaGVja2VkID0galF1ZXJ5LmluQXJyYXkoIHNlbGYudmFsKCksIHZhbCApID49IDA7CgoJCQl9IGVsc2UgaWYgKCBqUXVlcnkubm9kZU5hbWUoIHRoaXMsICJzZWxlY3QiICkgKSB7CgkJCQl2YXIgdmFsdWVzID0galF1ZXJ5Lm1ha2VBcnJheSh2YWwpOwoKCQkJCWpRdWVyeSggIm9wdGlvbiIsIHRoaXMgKS5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJCXRoaXMuc2VsZWN0ZWQgPSBqUXVlcnkuaW5BcnJheSggalF1ZXJ5KHRoaXMpLnZhbCgpLCB2YWx1ZXMgKSA+PSAwOwoJCQkJfSk7CgoJCQkJaWYgKCAhdmFsdWVzLmxlbmd0aCApIHsKCQkJCQl0aGlzLnNlbGVjdGVkSW5kZXggPSAtMTsKCQkJCX0KCgkJCX0gZWxzZSB7CgkJCQl0aGlzLnZhbHVlID0gdmFsOwoJCQl9CgkJfSk7Cgl9Cn0pOwoKalF1ZXJ5LmV4dGVuZCh7CglhdHRyRm46IHsKCQl2YWw6IHRydWUsCgkJY3NzOiB0cnVlLAoJCWh0bWw6IHRydWUsCgkJdGV4dDogdHJ1ZSwKCQlkYXRhOiB0cnVlLAoJCXdpZHRoOiB0cnVlLAoJCWhlaWdodDogdHJ1ZSwKCQlvZmZzZXQ6IHRydWUKCX0sCgkJCglhdHRyOiBmdW5jdGlvbiggZWxlbSwgbmFtZSwgdmFsdWUsIHBhc3MgKSB7CgkJLy8gZG9uJ3Qgc2V0IGF0dHJpYnV0ZXMgb24gdGV4dCBhbmQgY29tbWVudCBub2RlcwoJCWlmICggIWVsZW0gfHwgZWxlbS5ub2RlVHlwZSA9PT0gMyB8fCBlbGVtLm5vZGVUeXBlID09PSA4ICkgewoJCQlyZXR1cm4gdW5kZWZpbmVkOwoJCX0KCgkJaWYgKCBwYXNzICYmIG5hbWUgaW4galF1ZXJ5LmF0dHJGbiApIHsKCQkJcmV0dXJuIGpRdWVyeShlbGVtKVtuYW1lXSh2YWx1ZSk7CgkJfQoKCQl2YXIgbm90eG1sID0gZWxlbS5ub2RlVHlwZSAhPT0gMSB8fCAhalF1ZXJ5LmlzWE1MRG9jKCBlbGVtICksCgkJCS8vIFdoZXRoZXIgd2UgYXJlIHNldHRpbmcgKG9yIGdldHRpbmcpCgkJCXNldCA9IHZhbHVlICE9PSB1bmRlZmluZWQ7CgoJCS8vIFRyeSB0byBub3JtYWxpemUvZml4IHRoZSBuYW1lCgkJbmFtZSA9IG5vdHhtbCAmJiBqUXVlcnkucHJvcHNbIG5hbWUgXSB8fCBuYW1lOwoKCQkvLyBPbmx5IGRvIGFsbCB0aGUgZm9sbG93aW5nIGlmIHRoaXMgaXMgYSBub2RlIChmYXN0ZXIgZm9yIHN0eWxlKQoJCWlmICggZWxlbS5ub2RlVHlwZSA9PT0gMSApIHsKCQkJLy8gVGhlc2UgYXR0cmlidXRlcyByZXF1aXJlIHNwZWNpYWwgdHJlYXRtZW50CgkJCXZhciBzcGVjaWFsID0gcnNwZWNpYWx1cmwudGVzdCggbmFtZSApOwoKCQkJLy8gU2FmYXJpIG1pcy1yZXBvcnRzIHRoZSBkZWZhdWx0IHNlbGVjdGVkIHByb3BlcnR5IG9mIGFuIG9wdGlvbgoJCQkvLyBBY2Nlc3NpbmcgdGhlIHBhcmVudCdzIHNlbGVjdGVkSW5kZXggcHJvcGVydHkgZml4ZXMgaXQKCQkJaWYgKCBuYW1lID09PSAic2VsZWN0ZWQiICYmICFqUXVlcnkuc3VwcG9ydC5vcHRTZWxlY3RlZCApIHsKCQkJCXZhciBwYXJlbnQgPSBlbGVtLnBhcmVudE5vZGU7CgkJCQlpZiAoIHBhcmVudCApIHsKCQkJCQlwYXJlbnQuc2VsZWN0ZWRJbmRleDsKCQoJCQkJCS8vIE1ha2Ugc3VyZSB0aGF0IGl0IGFsc28gd29ya3Mgd2l0aCBvcHRncm91cHMsIHNlZSAjNTcwMQoJCQkJCWlmICggcGFyZW50LnBhcmVudE5vZGUgKSB7CgkJCQkJCXBhcmVudC5wYXJlbnROb2RlLnNlbGVjdGVkSW5kZXg7CgkJCQkJfQoJCQkJfQoJCQl9CgoJCQkvLyBJZiBhcHBsaWNhYmxlLCBhY2Nlc3MgdGhlIGF0dHJpYnV0ZSB2aWEgdGhlIERPTSAwIHdheQoJCQlpZiAoIG5hbWUgaW4gZWxlbSAmJiBub3R4bWwgJiYgIXNwZWNpYWwgKSB7CgkJCQlpZiAoIHNldCApIHsKCQkJCQkvLyBXZSBjYW4ndCBhbGxvdyB0aGUgdHlwZSBwcm9wZXJ0eSB0byBiZSBjaGFuZ2VkIChzaW5jZSBpdCBjYXVzZXMgcHJvYmxlbXMgaW4gSUUpCgkJCQkJaWYgKCBuYW1lID09PSAidHlwZSIgJiYgcnR5cGUudGVzdCggZWxlbS5ub2RlTmFtZSApICYmIGVsZW0ucGFyZW50Tm9kZSApIHsKCQkJCQkJalF1ZXJ5LmVycm9yKCAidHlwZSBwcm9wZXJ0eSBjYW4ndCBiZSBjaGFuZ2VkIiApOwoJCQkJCX0KCgkJCQkJZWxlbVsgbmFtZSBdID0gdmFsdWU7CgkJCQl9CgoJCQkJLy8gYnJvd3NlcnMgaW5kZXggZWxlbWVudHMgYnkgaWQvbmFtZSBvbiBmb3JtcywgZ2l2ZSBwcmlvcml0eSB0byBhdHRyaWJ1dGVzLgoJCQkJaWYgKCBqUXVlcnkubm9kZU5hbWUoIGVsZW0sICJmb3JtIiApICYmIGVsZW0uZ2V0QXR0cmlidXRlTm9kZShuYW1lKSApIHsKCQkJCQlyZXR1cm4gZWxlbS5nZXRBdHRyaWJ1dGVOb2RlKCBuYW1lICkubm9kZVZhbHVlOwoJCQkJfQoKCQkJCS8vIGVsZW0udGFiSW5kZXggZG9lc24ndCBhbHdheXMgcmV0dXJuIHRoZSBjb3JyZWN0IHZhbHVlIHdoZW4gaXQgaGFzbid0IGJlZW4gZXhwbGljaXRseSBzZXQKCQkJCS8vIGh0dHA6Ly9mbHVpZHByb2plY3Qub3JnL2Jsb2cvMjAwOC8wMS8wOS9nZXR0aW5nLXNldHRpbmctYW5kLXJlbW92aW5nLXRhYmluZGV4LXZhbHVlcy13aXRoLWphdmFzY3JpcHQvCgkJCQlpZiAoIG5hbWUgPT09ICJ0YWJJbmRleCIgKSB7CgkJCQkJdmFyIGF0dHJpYnV0ZU5vZGUgPSBlbGVtLmdldEF0dHJpYnV0ZU5vZGUoICJ0YWJJbmRleCIgKTsKCgkJCQkJcmV0dXJuIGF0dHJpYnV0ZU5vZGUgJiYgYXR0cmlidXRlTm9kZS5zcGVjaWZpZWQgPwoJCQkJCQlhdHRyaWJ1dGVOb2RlLnZhbHVlIDoKCQkJCQkJcmZvY3VzYWJsZS50ZXN0KCBlbGVtLm5vZGVOYW1lICkgfHwgcmNsaWNrYWJsZS50ZXN0KCBlbGVtLm5vZGVOYW1lICkgJiYgZWxlbS5ocmVmID8KCQkJCQkJCTAgOgoJCQkJCQkJdW5kZWZpbmVkOwoJCQkJfQoKCQkJCXJldHVybiBlbGVtWyBuYW1lIF07CgkJCX0KCgkJCWlmICggIWpRdWVyeS5zdXBwb3J0LnN0eWxlICYmIG5vdHhtbCAmJiBuYW1lID09PSAic3R5bGUiICkgewoJCQkJaWYgKCBzZXQgKSB7CgkJCQkJZWxlbS5zdHlsZS5jc3NUZXh0ID0gIiIgKyB2YWx1ZTsKCQkJCX0KCgkJCQlyZXR1cm4gZWxlbS5zdHlsZS5jc3NUZXh0OwoJCQl9CgoJCQlpZiAoIHNldCApIHsKCQkJCS8vIGNvbnZlcnQgdGhlIHZhbHVlIHRvIGEgc3RyaW5nIChhbGwgYnJvd3NlcnMgZG8gdGhpcyBidXQgSUUpIHNlZSAjMTA3MAoJCQkJZWxlbS5zZXRBdHRyaWJ1dGUoIG5hbWUsICIiICsgdmFsdWUgKTsKCQkJfQoKCQkJdmFyIGF0dHIgPSAhalF1ZXJ5LnN1cHBvcnQuaHJlZk5vcm1hbGl6ZWQgJiYgbm90eG1sICYmIHNwZWNpYWwgPwoJCQkJCS8vIFNvbWUgYXR0cmlidXRlcyByZXF1aXJlIGEgc3BlY2lhbCBjYWxsIG9uIElFCgkJCQkJZWxlbS5nZXRBdHRyaWJ1dGUoIG5hbWUsIDIgKSA6CgkJCQkJZWxlbS5nZXRBdHRyaWJ1dGUoIG5hbWUgKTsKCgkJCS8vIE5vbi1leGlzdGVudCBhdHRyaWJ1dGVzIHJldHVybiBudWxsLCB3ZSBub3JtYWxpemUgdG8gdW5kZWZpbmVkCgkJCXJldHVybiBhdHRyID09PSBudWxsID8gdW5kZWZpbmVkIDogYXR0cjsKCQl9CgoJCS8vIGVsZW0gaXMgYWN0dWFsbHkgZWxlbS5zdHlsZSAuLi4gc2V0IHRoZSBzdHlsZQoJCS8vIFVzaW5nIGF0dHIgZm9yIHNwZWNpZmljIHN0eWxlIGluZm9ybWF0aW9uIGlzIG5vdyBkZXByZWNhdGVkLiBVc2Ugc3R5bGUgaW5zdGVhZC4KCQlyZXR1cm4galF1ZXJ5LnN0eWxlKCBlbGVtLCBuYW1lLCB2YWx1ZSApOwoJfQp9KTsKdmFyIHJuYW1lc3BhY2VzID0gL1wuKC4qKSQvLAoJZmNsZWFudXAgPSBmdW5jdGlvbiggbm0gKSB7CgkJcmV0dXJuIG5tLnJlcGxhY2UoL1teXHdcc1wuXHxgXS9nLCBmdW5jdGlvbiggY2ggKSB7CgkJCXJldHVybiAiXFwiICsgY2g7CgkJfSk7Cgl9OwoKLyoKICogQSBudW1iZXIgb2YgaGVscGVyIGZ1bmN0aW9ucyB1c2VkIGZvciBtYW5hZ2luZyBldmVudHMuCiAqIE1hbnkgb2YgdGhlIGlkZWFzIGJlaGluZCB0aGlzIGNvZGUgb3JpZ2luYXRlZCBmcm9tCiAqIERlYW4gRWR3YXJkcycgYWRkRXZlbnQgbGlicmFyeS4KICovCmpRdWVyeS5ldmVudCA9IHsKCgkvLyBCaW5kIGFuIGV2ZW50IHRvIGFuIGVsZW1lbnQKCS8vIE9yaWdpbmFsIGJ5IERlYW4gRWR3YXJkcwoJYWRkOiBmdW5jdGlvbiggZWxlbSwgdHlwZXMsIGhhbmRsZXIsIGRhdGEgKSB7CgkJaWYgKCBlbGVtLm5vZGVUeXBlID09PSAzIHx8IGVsZW0ubm9kZVR5cGUgPT09IDggKSB7CgkJCXJldHVybjsKCQl9CgoJCS8vIEZvciB3aGF0ZXZlciByZWFzb24sIElFIGhhcyB0cm91YmxlIHBhc3NpbmcgdGhlIHdpbmRvdyBvYmplY3QKCQkvLyBhcm91bmQsIGNhdXNpbmcgaXQgdG8gYmUgY2xvbmVkIGluIHRoZSBwcm9jZXNzCgkJaWYgKCBlbGVtLnNldEludGVydmFsICYmICggZWxlbSAhPT0gd2luZG93ICYmICFlbGVtLmZyYW1lRWxlbWVudCApICkgewoJCQllbGVtID0gd2luZG93OwoJCX0KCgkJdmFyIGhhbmRsZU9iakluLCBoYW5kbGVPYmo7CgoJCWlmICggaGFuZGxlci5oYW5kbGVyICkgewoJCQloYW5kbGVPYmpJbiA9IGhhbmRsZXI7CgkJCWhhbmRsZXIgPSBoYW5kbGVPYmpJbi5oYW5kbGVyOwoJCX0KCgkJLy8gTWFrZSBzdXJlIHRoYXQgdGhlIGZ1bmN0aW9uIGJlaW5nIGV4ZWN1dGVkIGhhcyBhIHVuaXF1ZSBJRAoJCWlmICggIWhhbmRsZXIuZ3VpZCApIHsKCQkJaGFuZGxlci5ndWlkID0galF1ZXJ5Lmd1aWQrKzsKCQl9CgoJCS8vIEluaXQgdGhlIGVsZW1lbnQncyBldmVudCBzdHJ1Y3R1cmUKCQl2YXIgZWxlbURhdGEgPSBqUXVlcnkuZGF0YSggZWxlbSApOwoKCQkvLyBJZiBubyBlbGVtRGF0YSBpcyBmb3VuZCB0aGVuIHdlIG11c3QgYmUgdHJ5aW5nIHRvIGJpbmQgdG8gb25lIG9mIHRoZQoJCS8vIGJhbm5lZCBub0RhdGEgZWxlbWVudHMKCQlpZiAoICFlbGVtRGF0YSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJdmFyIGV2ZW50cyA9IGVsZW1EYXRhLmV2ZW50cyA9IGVsZW1EYXRhLmV2ZW50cyB8fCB7fSwKCQkJZXZlbnRIYW5kbGUgPSBlbGVtRGF0YS5oYW5kbGUsIGV2ZW50SGFuZGxlOwoKCQlpZiAoICFldmVudEhhbmRsZSApIHsKCQkJZWxlbURhdGEuaGFuZGxlID0gZXZlbnRIYW5kbGUgPSBmdW5jdGlvbigpIHsKCQkJCS8vIEhhbmRsZSB0aGUgc2Vjb25kIGV2ZW50IG9mIGEgdHJpZ2dlciBhbmQgd2hlbgoJCQkJLy8gYW4gZXZlbnQgaXMgY2FsbGVkIGFmdGVyIGEgcGFnZSBoYXMgdW5sb2FkZWQKCQkJCXJldHVybiB0eXBlb2YgalF1ZXJ5ICE9PSAidW5kZWZpbmVkIiAmJiAhalF1ZXJ5LmV2ZW50LnRyaWdnZXJlZCA/CgkJCQkJalF1ZXJ5LmV2ZW50LmhhbmRsZS5hcHBseSggZXZlbnRIYW5kbGUuZWxlbSwgYXJndW1lbnRzICkgOgoJCQkJCXVuZGVmaW5lZDsKCQkJfTsKCQl9CgoJCS8vIEFkZCBlbGVtIGFzIGEgcHJvcGVydHkgb2YgdGhlIGhhbmRsZSBmdW5jdGlvbgoJCS8vIFRoaXMgaXMgdG8gcHJldmVudCBhIG1lbW9yeSBsZWFrIHdpdGggbm9uLW5hdGl2ZSBldmVudHMgaW4gSUUuCgkJZXZlbnRIYW5kbGUuZWxlbSA9IGVsZW07CgoJCS8vIEhhbmRsZSBtdWx0aXBsZSBldmVudHMgc2VwYXJhdGVkIGJ5IGEgc3BhY2UKCQkvLyBqUXVlcnkoLi4uKS5iaW5kKCJtb3VzZW92ZXIgbW91c2VvdXQiLCBmbik7CgkJdHlwZXMgPSB0eXBlcy5zcGxpdCgiICIpOwoKCQl2YXIgdHlwZSwgaSA9IDAsIG5hbWVzcGFjZXM7CgoJCXdoaWxlICggKHR5cGUgPSB0eXBlc1sgaSsrIF0pICkgewoJCQloYW5kbGVPYmogPSBoYW5kbGVPYmpJbiA/CgkJCQlqUXVlcnkuZXh0ZW5kKHt9LCBoYW5kbGVPYmpJbikgOgoJCQkJeyBoYW5kbGVyOiBoYW5kbGVyLCBkYXRhOiBkYXRhIH07CgoJCQkvLyBOYW1lc3BhY2VkIGV2ZW50IGhhbmRsZXJzCgkJCWlmICggdHlwZS5pbmRleE9mKCIuIikgPiAtMSApIHsKCQkJCW5hbWVzcGFjZXMgPSB0eXBlLnNwbGl0KCIuIik7CgkJCQl0eXBlID0gbmFtZXNwYWNlcy5zaGlmdCgpOwoJCQkJaGFuZGxlT2JqLm5hbWVzcGFjZSA9IG5hbWVzcGFjZXMuc2xpY2UoMCkuc29ydCgpLmpvaW4oIi4iKTsKCgkJCX0gZWxzZSB7CgkJCQluYW1lc3BhY2VzID0gW107CgkJCQloYW5kbGVPYmoubmFtZXNwYWNlID0gIiI7CgkJCX0KCgkJCWhhbmRsZU9iai50eXBlID0gdHlwZTsKCQkJaGFuZGxlT2JqLmd1aWQgPSBoYW5kbGVyLmd1aWQ7CgoJCQkvLyBHZXQgdGhlIGN1cnJlbnQgbGlzdCBvZiBmdW5jdGlvbnMgYm91bmQgdG8gdGhpcyBldmVudAoJCQl2YXIgaGFuZGxlcnMgPSBldmVudHNbIHR5cGUgXSwKCQkJCXNwZWNpYWwgPSBqUXVlcnkuZXZlbnQuc3BlY2lhbFsgdHlwZSBdIHx8IHt9OwoKCQkJLy8gSW5pdCB0aGUgZXZlbnQgaGFuZGxlciBxdWV1ZQoJCQlpZiAoICFoYW5kbGVycyApIHsKCQkJCWhhbmRsZXJzID0gZXZlbnRzWyB0eXBlIF0gPSBbXTsKCgkJCQkvLyBDaGVjayBmb3IgYSBzcGVjaWFsIGV2ZW50IGhhbmRsZXIKCQkJCS8vIE9ubHkgdXNlIGFkZEV2ZW50TGlzdGVuZXIvYXR0YWNoRXZlbnQgaWYgdGhlIHNwZWNpYWwKCQkJCS8vIGV2ZW50cyBoYW5kbGVyIHJldHVybnMgZmFsc2UKCQkJCWlmICggIXNwZWNpYWwuc2V0dXAgfHwgc3BlY2lhbC5zZXR1cC5jYWxsKCBlbGVtLCBkYXRhLCBuYW1lc3BhY2VzLCBldmVudEhhbmRsZSApID09PSBmYWxzZSApIHsKCQkJCQkvLyBCaW5kIHRoZSBnbG9iYWwgZXZlbnQgaGFuZGxlciB0byB0aGUgZWxlbWVudAoJCQkJCWlmICggZWxlbS5hZGRFdmVudExpc3RlbmVyICkgewoJCQkJCQllbGVtLmFkZEV2ZW50TGlzdGVuZXIoIHR5cGUsIGV2ZW50SGFuZGxlLCBmYWxzZSApOwoKCQkJCQl9IGVsc2UgaWYgKCBlbGVtLmF0dGFjaEV2ZW50ICkgewoJCQkJCQllbGVtLmF0dGFjaEV2ZW50KCAib24iICsgdHlwZSwgZXZlbnRIYW5kbGUgKTsKCQkJCQl9CgkJCQl9CgkJCX0KCQkJCgkJCWlmICggc3BlY2lhbC5hZGQgKSB7IAoJCQkJc3BlY2lhbC5hZGQuY2FsbCggZWxlbSwgaGFuZGxlT2JqICk7IAoKCQkJCWlmICggIWhhbmRsZU9iai5oYW5kbGVyLmd1aWQgKSB7CgkJCQkJaGFuZGxlT2JqLmhhbmRsZXIuZ3VpZCA9IGhhbmRsZXIuZ3VpZDsKCQkJCX0KCQkJfQoKCQkJLy8gQWRkIHRoZSBmdW5jdGlvbiB0byB0aGUgZWxlbWVudCdzIGhhbmRsZXIgbGlzdAoJCQloYW5kbGVycy5wdXNoKCBoYW5kbGVPYmogKTsKCgkJCS8vIEtlZXAgdHJhY2sgb2Ygd2hpY2ggZXZlbnRzIGhhdmUgYmVlbiB1c2VkLCBmb3IgZ2xvYmFsIHRyaWdnZXJpbmcKCQkJalF1ZXJ5LmV2ZW50Lmdsb2JhbFsgdHlwZSBdID0gdHJ1ZTsKCQl9CgoJCS8vIE51bGxpZnkgZWxlbSB0byBwcmV2ZW50IG1lbW9yeSBsZWFrcyBpbiBJRQoJCWVsZW0gPSBudWxsOwoJfSwKCglnbG9iYWw6IHt9LAoKCS8vIERldGFjaCBhbiBldmVudCBvciBzZXQgb2YgZXZlbnRzIGZyb20gYW4gZWxlbWVudAoJcmVtb3ZlOiBmdW5jdGlvbiggZWxlbSwgdHlwZXMsIGhhbmRsZXIsIHBvcyApIHsKCQkvLyBkb24ndCBkbyBldmVudHMgb24gdGV4dCBhbmQgY29tbWVudCBub2RlcwoJCWlmICggZWxlbS5ub2RlVHlwZSA9PT0gMyB8fCBlbGVtLm5vZGVUeXBlID09PSA4ICkgewoJCQlyZXR1cm47CgkJfQoKCQl2YXIgcmV0LCB0eXBlLCBmbiwgaSA9IDAsIGFsbCwgbmFtZXNwYWNlcywgbmFtZXNwYWNlLCBzcGVjaWFsLCBldmVudFR5cGUsIGhhbmRsZU9iaiwgb3JpZ1R5cGUsCgkJCWVsZW1EYXRhID0galF1ZXJ5LmRhdGEoIGVsZW0gKSwKCQkJZXZlbnRzID0gZWxlbURhdGEgJiYgZWxlbURhdGEuZXZlbnRzOwoKCQlpZiAoICFlbGVtRGF0YSB8fCAhZXZlbnRzICkgewoJCQlyZXR1cm47CgkJfQoKCQkvLyB0eXBlcyBpcyBhY3R1YWxseSBhbiBldmVudCBvYmplY3QgaGVyZQoJCWlmICggdHlwZXMgJiYgdHlwZXMudHlwZSApIHsKCQkJaGFuZGxlciA9IHR5cGVzLmhhbmRsZXI7CgkJCXR5cGVzID0gdHlwZXMudHlwZTsKCQl9CgoJCS8vIFVuYmluZCBhbGwgZXZlbnRzIGZvciB0aGUgZWxlbWVudAoJCWlmICggIXR5cGVzIHx8IHR5cGVvZiB0eXBlcyA9PT0gInN0cmluZyIgJiYgdHlwZXMuY2hhckF0KDApID09PSAiLiIgKSB7CgkJCXR5cGVzID0gdHlwZXMgfHwgIiI7CgoJCQlmb3IgKCB0eXBlIGluIGV2ZW50cyApIHsKCQkJCWpRdWVyeS5ldmVudC5yZW1vdmUoIGVsZW0sIHR5cGUgKyB0eXBlcyApOwoJCQl9CgoJCQlyZXR1cm47CgkJfQoKCQkvLyBIYW5kbGUgbXVsdGlwbGUgZXZlbnRzIHNlcGFyYXRlZCBieSBhIHNwYWNlCgkJLy8galF1ZXJ5KC4uLikudW5iaW5kKCJtb3VzZW92ZXIgbW91c2VvdXQiLCBmbik7CgkJdHlwZXMgPSB0eXBlcy5zcGxpdCgiICIpOwoKCQl3aGlsZSAoICh0eXBlID0gdHlwZXNbIGkrKyBdKSApIHsKCQkJb3JpZ1R5cGUgPSB0eXBlOwoJCQloYW5kbGVPYmogPSBudWxsOwoJCQlhbGwgPSB0eXBlLmluZGV4T2YoIi4iKSA8IDA7CgkJCW5hbWVzcGFjZXMgPSBbXTsKCgkJCWlmICggIWFsbCApIHsKCQkJCS8vIE5hbWVzcGFjZWQgZXZlbnQgaGFuZGxlcnMKCQkJCW5hbWVzcGFjZXMgPSB0eXBlLnNwbGl0KCIuIik7CgkJCQl0eXBlID0gbmFtZXNwYWNlcy5zaGlmdCgpOwoKCQkJCW5hbWVzcGFjZSA9IG5ldyBSZWdFeHAoIihefFxcLikiICsgCgkJCQkJalF1ZXJ5Lm1hcCggbmFtZXNwYWNlcy5zbGljZSgwKS5zb3J0KCksIGZjbGVhbnVwICkuam9pbigiXFwuKD86LipcXC4pPyIpICsgIihcXC58JCkiKQoJCQl9CgoJCQlldmVudFR5cGUgPSBldmVudHNbIHR5cGUgXTsKCgkJCWlmICggIWV2ZW50VHlwZSApIHsKCQkJCWNvbnRpbnVlOwoJCQl9CgoJCQlpZiAoICFoYW5kbGVyICkgewoJCQkJZm9yICggdmFyIGogPSAwOyBqIDwgZXZlbnRUeXBlLmxlbmd0aDsgaisrICkgewoJCQkJCWhhbmRsZU9iaiA9IGV2ZW50VHlwZVsgaiBdOwoKCQkJCQlpZiAoIGFsbCB8fCBuYW1lc3BhY2UudGVzdCggaGFuZGxlT2JqLm5hbWVzcGFjZSApICkgewoJCQkJCQlqUXVlcnkuZXZlbnQucmVtb3ZlKCBlbGVtLCBvcmlnVHlwZSwgaGFuZGxlT2JqLmhhbmRsZXIsIGogKTsKCQkJCQkJZXZlbnRUeXBlLnNwbGljZSggai0tLCAxICk7CgkJCQkJfQoJCQkJfQoKCQkJCWNvbnRpbnVlOwoJCQl9CgoJCQlzcGVjaWFsID0galF1ZXJ5LmV2ZW50LnNwZWNpYWxbIHR5cGUgXSB8fCB7fTsKCgkJCWZvciAoIHZhciBqID0gcG9zIHx8IDA7IGogPCBldmVudFR5cGUubGVuZ3RoOyBqKysgKSB7CgkJCQloYW5kbGVPYmogPSBldmVudFR5cGVbIGogXTsKCgkJCQlpZiAoIGhhbmRsZXIuZ3VpZCA9PT0gaGFuZGxlT2JqLmd1aWQgKSB7CgkJCQkJLy8gcmVtb3ZlIHRoZSBnaXZlbiBoYW5kbGVyIGZvciB0aGUgZ2l2ZW4gdHlwZQoJCQkJCWlmICggYWxsIHx8IG5hbWVzcGFjZS50ZXN0KCBoYW5kbGVPYmoubmFtZXNwYWNlICkgKSB7CgkJCQkJCWlmICggcG9zID09IG51bGwgKSB7CgkJCQkJCQlldmVudFR5cGUuc3BsaWNlKCBqLS0sIDEgKTsKCQkJCQkJfQoKCQkJCQkJaWYgKCBzcGVjaWFsLnJlbW92ZSApIHsKCQkJCQkJCXNwZWNpYWwucmVtb3ZlLmNhbGwoIGVsZW0sIGhhbmRsZU9iaiApOwoJCQkJCQl9CgkJCQkJfQoKCQkJCQlpZiAoIHBvcyAhPSBudWxsICkgewoJCQkJCQlicmVhazsKCQkJCQl9CgkJCQl9CgkJCX0KCgkJCS8vIHJlbW92ZSBnZW5lcmljIGV2ZW50IGhhbmRsZXIgaWYgbm8gbW9yZSBoYW5kbGVycyBleGlzdAoJCQlpZiAoIGV2ZW50VHlwZS5sZW5ndGggPT09IDAgfHwgcG9zICE9IG51bGwgJiYgZXZlbnRUeXBlLmxlbmd0aCA9PT0gMSApIHsKCQkJCWlmICggIXNwZWNpYWwudGVhcmRvd24gfHwgc3BlY2lhbC50ZWFyZG93bi5jYWxsKCBlbGVtLCBuYW1lc3BhY2VzICkgPT09IGZhbHNlICkgewoJCQkJCXJlbW92ZUV2ZW50KCBlbGVtLCB0eXBlLCBlbGVtRGF0YS5oYW5kbGUgKTsKCQkJCX0KCgkJCQlyZXQgPSBudWxsOwoJCQkJZGVsZXRlIGV2ZW50c1sgdHlwZSBdOwoJCQl9CgkJfQoKCQkvLyBSZW1vdmUgdGhlIGV4cGFuZG8gaWYgaXQncyBubyBsb25nZXIgdXNlZAoJCWlmICggalF1ZXJ5LmlzRW1wdHlPYmplY3QoIGV2ZW50cyApICkgewoJCQl2YXIgaGFuZGxlID0gZWxlbURhdGEuaGFuZGxlOwoJCQlpZiAoIGhhbmRsZSApIHsKCQkJCWhhbmRsZS5lbGVtID0gbnVsbDsKCQkJfQoKCQkJZGVsZXRlIGVsZW1EYXRhLmV2ZW50czsKCQkJZGVsZXRlIGVsZW1EYXRhLmhhbmRsZTsKCgkJCWlmICggalF1ZXJ5LmlzRW1wdHlPYmplY3QoIGVsZW1EYXRhICkgKSB7CgkJCQlqUXVlcnkucmVtb3ZlRGF0YSggZWxlbSApOwoJCQl9CgkJfQoJfSwKCgkvLyBidWJibGluZyBpcyBpbnRlcm5hbAoJdHJpZ2dlcjogZnVuY3Rpb24oIGV2ZW50LCBkYXRhLCBlbGVtIC8qLCBidWJibGluZyAqLyApIHsKCQkvLyBFdmVudCBvYmplY3Qgb3IgZXZlbnQgdHlwZQoJCXZhciB0eXBlID0gZXZlbnQudHlwZSB8fCBldmVudCwKCQkJYnViYmxpbmcgPSBhcmd1bWVudHNbM107CgoJCWlmICggIWJ1YmJsaW5nICkgewoJCQlldmVudCA9IHR5cGVvZiBldmVudCA9PT0gIm9iamVjdCIgPwoJCQkJLy8galF1ZXJ5LkV2ZW50IG9iamVjdAoJCQkJZXZlbnRbZXhwYW5kb10gPyBldmVudCA6CgkJCQkvLyBPYmplY3QgbGl0ZXJhbAoJCQkJalF1ZXJ5LmV4dGVuZCggalF1ZXJ5LkV2ZW50KHR5cGUpLCBldmVudCApIDoKCQkJCS8vIEp1c3QgdGhlIGV2ZW50IHR5cGUgKHN0cmluZykKCQkJCWpRdWVyeS5FdmVudCh0eXBlKTsKCgkJCWlmICggdHlwZS5pbmRleE9mKCIhIikgPj0gMCApIHsKCQkJCWV2ZW50LnR5cGUgPSB0eXBlID0gdHlwZS5zbGljZSgwLCAtMSk7CgkJCQlldmVudC5leGNsdXNpdmUgPSB0cnVlOwoJCQl9CgoJCQkvLyBIYW5kbGUgYSBnbG9iYWwgdHJpZ2dlcgoJCQlpZiAoICFlbGVtICkgewoJCQkJLy8gRG9uJ3QgYnViYmxlIGN1c3RvbSBldmVudHMgd2hlbiBnbG9iYWwgKHRvIGF2b2lkIHRvbyBtdWNoIG92ZXJoZWFkKQoJCQkJZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7CgoJCQkJLy8gT25seSB0cmlnZ2VyIGlmIHdlJ3ZlIGV2ZXIgYm91bmQgYW4gZXZlbnQgZm9yIGl0CgkJCQlpZiAoIGpRdWVyeS5ldmVudC5nbG9iYWxbIHR5cGUgXSApIHsKCQkJCQlqUXVlcnkuZWFjaCggalF1ZXJ5LmNhY2hlLCBmdW5jdGlvbigpIHsKCQkJCQkJaWYgKCB0aGlzLmV2ZW50cyAmJiB0aGlzLmV2ZW50c1t0eXBlXSApIHsKCQkJCQkJCWpRdWVyeS5ldmVudC50cmlnZ2VyKCBldmVudCwgZGF0YSwgdGhpcy5oYW5kbGUuZWxlbSApOwoJCQkJCQl9CgkJCQkJfSk7CgkJCQl9CgkJCX0KCgkJCS8vIEhhbmRsZSB0cmlnZ2VyaW5nIGEgc2luZ2xlIGVsZW1lbnQKCgkJCS8vIGRvbid0IGRvIGV2ZW50cyBvbiB0ZXh0IGFuZCBjb21tZW50IG5vZGVzCgkJCWlmICggIWVsZW0gfHwgZWxlbS5ub2RlVHlwZSA9PT0gMyB8fCBlbGVtLm5vZGVUeXBlID09PSA4ICkgewoJCQkJcmV0dXJuIHVuZGVmaW5lZDsKCQkJfQoKCQkJLy8gQ2xlYW4gdXAgaW4gY2FzZSBpdCBpcyByZXVzZWQKCQkJZXZlbnQucmVzdWx0ID0gdW5kZWZpbmVkOwoJCQlldmVudC50YXJnZXQgPSBlbGVtOwoKCQkJLy8gQ2xvbmUgdGhlIGluY29taW5nIGRhdGEsIGlmIGFueQoJCQlkYXRhID0galF1ZXJ5Lm1ha2VBcnJheSggZGF0YSApOwoJCQlkYXRhLnVuc2hpZnQoIGV2ZW50ICk7CgkJfQoKCQlldmVudC5jdXJyZW50VGFyZ2V0ID0gZWxlbTsKCgkJLy8gVHJpZ2dlciB0aGUgZXZlbnQsIGl0IGlzIGFzc3VtZWQgdGhhdCAiaGFuZGxlIiBpcyBhIGZ1bmN0aW9uCgkJdmFyIGhhbmRsZSA9IGpRdWVyeS5kYXRhKCBlbGVtLCAiaGFuZGxlIiApOwoJCWlmICggaGFuZGxlICkgewoJCQloYW5kbGUuYXBwbHkoIGVsZW0sIGRhdGEgKTsKCQl9CgoJCXZhciBwYXJlbnQgPSBlbGVtLnBhcmVudE5vZGUgfHwgZWxlbS5vd25lckRvY3VtZW50OwoKCQkvLyBUcmlnZ2VyIGFuIGlubGluZSBib3VuZCBzY3JpcHQKCQl0cnkgewoJCQlpZiAoICEoZWxlbSAmJiBlbGVtLm5vZGVOYW1lICYmIGpRdWVyeS5ub0RhdGFbZWxlbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpXSkgKSB7CgkJCQlpZiAoIGVsZW1bICJvbiIgKyB0eXBlIF0gJiYgZWxlbVsgIm9uIiArIHR5cGUgXS5hcHBseSggZWxlbSwgZGF0YSApID09PSBmYWxzZSApIHsKCQkJCQlldmVudC5yZXN1bHQgPSBmYWxzZTsKCQkJCX0KCQkJfQoKCQkvLyBwcmV2ZW50IElFIGZyb20gdGhyb3dpbmcgYW4gZXJyb3IgZm9yIHNvbWUgZWxlbWVudHMgd2l0aCBzb21lIGV2ZW50IHR5cGVzLCBzZWUgIzM1MzMKCQl9IGNhdGNoIChlKSB7fQoKCQlpZiAoICFldmVudC5pc1Byb3BhZ2F0aW9uU3RvcHBlZCgpICYmIHBhcmVudCApIHsKCQkJalF1ZXJ5LmV2ZW50LnRyaWdnZXIoIGV2ZW50LCBkYXRhLCBwYXJlbnQsIHRydWUgKTsKCgkJfSBlbHNlIGlmICggIWV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoJCQl2YXIgdGFyZ2V0ID0gZXZlbnQudGFyZ2V0LCBvbGQsCgkJCQlpc0NsaWNrID0galF1ZXJ5Lm5vZGVOYW1lKHRhcmdldCwgImEiKSAmJiB0eXBlID09PSAiY2xpY2siLAoJCQkJc3BlY2lhbCA9IGpRdWVyeS5ldmVudC5zcGVjaWFsWyB0eXBlIF0gfHwge307CgoJCQlpZiAoICghc3BlY2lhbC5fZGVmYXVsdCB8fCBzcGVjaWFsLl9kZWZhdWx0LmNhbGwoIGVsZW0sIGV2ZW50ICkgPT09IGZhbHNlKSAmJiAKCQkJCSFpc0NsaWNrICYmICEodGFyZ2V0ICYmIHRhcmdldC5ub2RlTmFtZSAmJiBqUXVlcnkubm9EYXRhW3RhcmdldC5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpXSkgKSB7CgoJCQkJdHJ5IHsKCQkJCQlpZiAoIHRhcmdldFsgdHlwZSBdICkgewoJCQkJCQkvLyBNYWtlIHN1cmUgdGhhdCB3ZSBkb24ndCBhY2NpZGVudGFsbHkgcmUtdHJpZ2dlciB0aGUgb25GT08gZXZlbnRzCgkJCQkJCW9sZCA9IHRhcmdldFsgIm9uIiArIHR5cGUgXTsKCgkJCQkJCWlmICggb2xkICkgewoJCQkJCQkJdGFyZ2V0WyAib24iICsgdHlwZSBdID0gbnVsbDsKCQkJCQkJfQoKCQkJCQkJalF1ZXJ5LmV2ZW50LnRyaWdnZXJlZCA9IHRydWU7CgkJCQkJCXRhcmdldFsgdHlwZSBdKCk7CgkJCQkJfQoKCQkJCS8vIHByZXZlbnQgSUUgZnJvbSB0aHJvd2luZyBhbiBlcnJvciBmb3Igc29tZSBlbGVtZW50cyB3aXRoIHNvbWUgZXZlbnQgdHlwZXMsIHNlZSAjMzUzMwoJCQkJfSBjYXRjaCAoZSkge30KCgkJCQlpZiAoIG9sZCApIHsKCQkJCQl0YXJnZXRbICJvbiIgKyB0eXBlIF0gPSBvbGQ7CgkJCQl9CgoJCQkJalF1ZXJ5LmV2ZW50LnRyaWdnZXJlZCA9IGZhbHNlOwoJCQl9CgkJfQoJfSwKCgloYW5kbGU6IGZ1bmN0aW9uKCBldmVudCApIHsKCQl2YXIgYWxsLCBoYW5kbGVycywgbmFtZXNwYWNlcywgbmFtZXNwYWNlLCBldmVudHM7CgoJCWV2ZW50ID0gYXJndW1lbnRzWzBdID0galF1ZXJ5LmV2ZW50LmZpeCggZXZlbnQgfHwgd2luZG93LmV2ZW50ICk7CgkJZXZlbnQuY3VycmVudFRhcmdldCA9IHRoaXM7CgoJCS8vIE5hbWVzcGFjZWQgZXZlbnQgaGFuZGxlcnMKCQlhbGwgPSBldmVudC50eXBlLmluZGV4T2YoIi4iKSA8IDAgJiYgIWV2ZW50LmV4Y2x1c2l2ZTsKCgkJaWYgKCAhYWxsICkgewoJCQluYW1lc3BhY2VzID0gZXZlbnQudHlwZS5zcGxpdCgiLiIpOwoJCQlldmVudC50eXBlID0gbmFtZXNwYWNlcy5zaGlmdCgpOwoJCQluYW1lc3BhY2UgPSBuZXcgUmVnRXhwKCIoXnxcXC4pIiArIG5hbWVzcGFjZXMuc2xpY2UoMCkuc29ydCgpLmpvaW4oIlxcLig/Oi4qXFwuKT8iKSArICIoXFwufCQpIik7CgkJfQoKCQl2YXIgZXZlbnRzID0galF1ZXJ5LmRhdGEodGhpcywgImV2ZW50cyIpLCBoYW5kbGVycyA9IGV2ZW50c1sgZXZlbnQudHlwZSBdOwoKCQlpZiAoIGV2ZW50cyAmJiBoYW5kbGVycyApIHsKCQkJLy8gQ2xvbmUgdGhlIGhhbmRsZXJzIHRvIHByZXZlbnQgbWFuaXB1bGF0aW9uCgkJCWhhbmRsZXJzID0gaGFuZGxlcnMuc2xpY2UoMCk7CgoJCQlmb3IgKCB2YXIgaiA9IDAsIGwgPSBoYW5kbGVycy5sZW5ndGg7IGogPCBsOyBqKysgKSB7CgkJCQl2YXIgaGFuZGxlT2JqID0gaGFuZGxlcnNbIGogXTsKCgkJCQkvLyBGaWx0ZXIgdGhlIGZ1bmN0aW9ucyBieSBjbGFzcwoJCQkJaWYgKCBhbGwgfHwgbmFtZXNwYWNlLnRlc3QoIGhhbmRsZU9iai5uYW1lc3BhY2UgKSApIHsKCQkJCQkvLyBQYXNzIGluIGEgcmVmZXJlbmNlIHRvIHRoZSBoYW5kbGVyIGZ1bmN0aW9uIGl0c2VsZgoJCQkJCS8vIFNvIHRoYXQgd2UgY2FuIGxhdGVyIHJlbW92ZSBpdAoJCQkJCWV2ZW50LmhhbmRsZXIgPSBoYW5kbGVPYmouaGFuZGxlcjsKCQkJCQlldmVudC5kYXRhID0gaGFuZGxlT2JqLmRhdGE7CgkJCQkJZXZlbnQuaGFuZGxlT2JqID0gaGFuZGxlT2JqOwoJCgkJCQkJdmFyIHJldCA9IGhhbmRsZU9iai5oYW5kbGVyLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsKCgkJCQkJaWYgKCByZXQgIT09IHVuZGVmaW5lZCApIHsKCQkJCQkJZXZlbnQucmVzdWx0ID0gcmV0OwoJCQkJCQlpZiAoIHJldCA9PT0gZmFsc2UgKSB7CgkJCQkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJCQkJZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7CgkJCQkJCX0KCQkJCQl9CgoJCQkJCWlmICggZXZlbnQuaXNJbW1lZGlhdGVQcm9wYWdhdGlvblN0b3BwZWQoKSApIHsKCQkJCQkJYnJlYWs7CgkJCQkJfQoJCQkJfQoJCQl9CgkJfQoKCQlyZXR1cm4gZXZlbnQucmVzdWx0OwoJfSwKCglwcm9wczogImFsdEtleSBhdHRyQ2hhbmdlIGF0dHJOYW1lIGJ1YmJsZXMgYnV0dG9uIGNhbmNlbGFibGUgY2hhckNvZGUgY2xpZW50WCBjbGllbnRZIGN0cmxLZXkgY3VycmVudFRhcmdldCBkYXRhIGRldGFpbCBldmVudFBoYXNlIGZyb21FbGVtZW50IGhhbmRsZXIga2V5Q29kZSBsYXllclggbGF5ZXJZIG1ldGFLZXkgbmV3VmFsdWUgb2Zmc2V0WCBvZmZzZXRZIG9yaWdpbmFsVGFyZ2V0IHBhZ2VYIHBhZ2VZIHByZXZWYWx1ZSByZWxhdGVkTm9kZSByZWxhdGVkVGFyZ2V0IHNjcmVlblggc2NyZWVuWSBzaGlmdEtleSBzcmNFbGVtZW50IHRhcmdldCB0b0VsZW1lbnQgdmlldyB3aGVlbERlbHRhIHdoaWNoIi5zcGxpdCgiICIpLAoKCWZpeDogZnVuY3Rpb24oIGV2ZW50ICkgewoJCWlmICggZXZlbnRbIGV4cGFuZG8gXSApIHsKCQkJcmV0dXJuIGV2ZW50OwoJCX0KCgkJLy8gc3RvcmUgYSBjb3B5IG9mIHRoZSBvcmlnaW5hbCBldmVudCBvYmplY3QKCQkvLyBhbmQgImNsb25lIiB0byBzZXQgcmVhZC1vbmx5IHByb3BlcnRpZXMKCQl2YXIgb3JpZ2luYWxFdmVudCA9IGV2ZW50OwoJCWV2ZW50ID0galF1ZXJ5LkV2ZW50KCBvcmlnaW5hbEV2ZW50ICk7CgoJCWZvciAoIHZhciBpID0gdGhpcy5wcm9wcy5sZW5ndGgsIHByb3A7IGk7ICkgewoJCQlwcm9wID0gdGhpcy5wcm9wc1sgLS1pIF07CgkJCWV2ZW50WyBwcm9wIF0gPSBvcmlnaW5hbEV2ZW50WyBwcm9wIF07CgkJfQoKCQkvLyBGaXggdGFyZ2V0IHByb3BlcnR5LCBpZiBuZWNlc3NhcnkKCQlpZiAoICFldmVudC50YXJnZXQgKSB7CgkJCWV2ZW50LnRhcmdldCA9IGV2ZW50LnNyY0VsZW1lbnQgfHwgZG9jdW1lbnQ7IC8vIEZpeGVzICMxOTI1IHdoZXJlIHNyY0VsZW1lbnQgbWlnaHQgbm90IGJlIGRlZmluZWQgZWl0aGVyCgkJfQoKCQkvLyBjaGVjayBpZiB0YXJnZXQgaXMgYSB0ZXh0bm9kZSAoc2FmYXJpKQoJCWlmICggZXZlbnQudGFyZ2V0Lm5vZGVUeXBlID09PSAzICkgewoJCQlldmVudC50YXJnZXQgPSBldmVudC50YXJnZXQucGFyZW50Tm9kZTsKCQl9CgoJCS8vIEFkZCByZWxhdGVkVGFyZ2V0LCBpZiBuZWNlc3NhcnkKCQlpZiAoICFldmVudC5yZWxhdGVkVGFyZ2V0ICYmIGV2ZW50LmZyb21FbGVtZW50ICkgewoJCQlldmVudC5yZWxhdGVkVGFyZ2V0ID0gZXZlbnQuZnJvbUVsZW1lbnQgPT09IGV2ZW50LnRhcmdldCA/IGV2ZW50LnRvRWxlbWVudCA6IGV2ZW50LmZyb21FbGVtZW50OwoJCX0KCgkJLy8gQ2FsY3VsYXRlIHBhZ2VYL1kgaWYgbWlzc2luZyBhbmQgY2xpZW50WC9ZIGF2YWlsYWJsZQoJCWlmICggZXZlbnQucGFnZVggPT0gbnVsbCAmJiBldmVudC5jbGllbnRYICE9IG51bGwgKSB7CgkJCXZhciBkb2MgPSBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQsIGJvZHkgPSBkb2N1bWVudC5ib2R5OwoJCQlldmVudC5wYWdlWCA9IGV2ZW50LmNsaWVudFggKyAoZG9jICYmIGRvYy5zY3JvbGxMZWZ0IHx8IGJvZHkgJiYgYm9keS5zY3JvbGxMZWZ0IHx8IDApIC0gKGRvYyAmJiBkb2MuY2xpZW50TGVmdCB8fCBib2R5ICYmIGJvZHkuY2xpZW50TGVmdCB8fCAwKTsKCQkJZXZlbnQucGFnZVkgPSBldmVudC5jbGllbnRZICsgKGRvYyAmJiBkb2Muc2Nyb2xsVG9wICB8fCBib2R5ICYmIGJvZHkuc2Nyb2xsVG9wICB8fCAwKSAtIChkb2MgJiYgZG9jLmNsaWVudFRvcCAgfHwgYm9keSAmJiBib2R5LmNsaWVudFRvcCAgfHwgMCk7CgkJfQoKCQkvLyBBZGQgd2hpY2ggZm9yIGtleSBldmVudHMKCQlpZiAoICFldmVudC53aGljaCAmJiAoKGV2ZW50LmNoYXJDb2RlIHx8IGV2ZW50LmNoYXJDb2RlID09PSAwKSA/IGV2ZW50LmNoYXJDb2RlIDogZXZlbnQua2V5Q29kZSkgKSB7CgkJCWV2ZW50LndoaWNoID0gZXZlbnQuY2hhckNvZGUgfHwgZXZlbnQua2V5Q29kZTsKCQl9CgoJCS8vIEFkZCBtZXRhS2V5IHRvIG5vbi1NYWMgYnJvd3NlcnMgKHVzZSBjdHJsIGZvciBQQydzIGFuZCBNZXRhIGZvciBNYWNzKQoJCWlmICggIWV2ZW50Lm1ldGFLZXkgJiYgZXZlbnQuY3RybEtleSApIHsKCQkJZXZlbnQubWV0YUtleSA9IGV2ZW50LmN0cmxLZXk7CgkJfQoKCQkvLyBBZGQgd2hpY2ggZm9yIGNsaWNrOiAxID09PSBsZWZ0OyAyID09PSBtaWRkbGU7IDMgPT09IHJpZ2h0CgkJLy8gTm90ZTogYnV0dG9uIGlzIG5vdCBub3JtYWxpemVkLCBzbyBkb24ndCB1c2UgaXQKCQlpZiAoICFldmVudC53aGljaCAmJiBldmVudC5idXR0b24gIT09IHVuZGVmaW5lZCApIHsKCQkJZXZlbnQud2hpY2ggPSAoZXZlbnQuYnV0dG9uICYgMSA/IDEgOiAoIGV2ZW50LmJ1dHRvbiAmIDIgPyAzIDogKCBldmVudC5idXR0b24gJiA0ID8gMiA6IDAgKSApKTsKCQl9CgoJCXJldHVybiBldmVudDsKCX0sCgoJLy8gRGVwcmVjYXRlZCwgdXNlIGpRdWVyeS5ndWlkIGluc3RlYWQKCWd1aWQ6IDFFOCwKCgkvLyBEZXByZWNhdGVkLCB1c2UgalF1ZXJ5LnByb3h5IGluc3RlYWQKCXByb3h5OiBqUXVlcnkucHJveHksCgoJc3BlY2lhbDogewoJCXJlYWR5OiB7CgkJCS8vIE1ha2Ugc3VyZSB0aGUgcmVhZHkgZXZlbnQgaXMgc2V0dXAKCQkJc2V0dXA6IGpRdWVyeS5iaW5kUmVhZHksCgkJCXRlYXJkb3duOiBqUXVlcnkubm9vcAoJCX0sCgoJCWxpdmU6IHsKCQkJYWRkOiBmdW5jdGlvbiggaGFuZGxlT2JqICkgewoJCQkJalF1ZXJ5LmV2ZW50LmFkZCggdGhpcywgaGFuZGxlT2JqLm9yaWdUeXBlLCBqUXVlcnkuZXh0ZW5kKHt9LCBoYW5kbGVPYmosIHtoYW5kbGVyOiBsaXZlSGFuZGxlcn0pICk7IAoJCQl9LAoKCQkJcmVtb3ZlOiBmdW5jdGlvbiggaGFuZGxlT2JqICkgewoJCQkJdmFyIHJlbW92ZSA9IHRydWUsCgkJCQkJdHlwZSA9IGhhbmRsZU9iai5vcmlnVHlwZS5yZXBsYWNlKHJuYW1lc3BhY2VzLCAiIik7CgkJCQkKCQkJCWpRdWVyeS5lYWNoKCBqUXVlcnkuZGF0YSh0aGlzLCAiZXZlbnRzIikubGl2ZSB8fCBbXSwgZnVuY3Rpb24oKSB7CgkJCQkJaWYgKCB0eXBlID09PSB0aGlzLm9yaWdUeXBlLnJlcGxhY2Uocm5hbWVzcGFjZXMsICIiKSApIHsKCQkJCQkJcmVtb3ZlID0gZmFsc2U7CgkJCQkJCXJldHVybiBmYWxzZTsKCQkJCQl9CgkJCQl9KTsKCgkJCQlpZiAoIHJlbW92ZSApIHsKCQkJCQlqUXVlcnkuZXZlbnQucmVtb3ZlKCB0aGlzLCBoYW5kbGVPYmoub3JpZ1R5cGUsIGxpdmVIYW5kbGVyICk7CgkJCQl9CgkJCX0KCgkJfSwKCgkJYmVmb3JldW5sb2FkOiB7CgkJCXNldHVwOiBmdW5jdGlvbiggZGF0YSwgbmFtZXNwYWNlcywgZXZlbnRIYW5kbGUgKSB7CgkJCQkvLyBXZSBvbmx5IHdhbnQgdG8gZG8gdGhpcyBzcGVjaWFsIGNhc2Ugb24gd2luZG93cwoJCQkJaWYgKCB0aGlzLnNldEludGVydmFsICkgewoJCQkJCXRoaXMub25iZWZvcmV1bmxvYWQgPSBldmVudEhhbmRsZTsKCQkJCX0KCgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0sCgkJCXRlYXJkb3duOiBmdW5jdGlvbiggbmFtZXNwYWNlcywgZXZlbnRIYW5kbGUgKSB7CgkJCQlpZiAoIHRoaXMub25iZWZvcmV1bmxvYWQgPT09IGV2ZW50SGFuZGxlICkgewoJCQkJCXRoaXMub25iZWZvcmV1bmxvYWQgPSBudWxsOwoJCQkJfQoJCQl9CgkJfQoJfQp9OwoKdmFyIHJlbW92ZUV2ZW50ID0gZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lciA/CglmdW5jdGlvbiggZWxlbSwgdHlwZSwgaGFuZGxlICkgewoJCWVsZW0ucmVtb3ZlRXZlbnRMaXN0ZW5lciggdHlwZSwgaGFuZGxlLCBmYWxzZSApOwoJfSA6IAoJZnVuY3Rpb24oIGVsZW0sIHR5cGUsIGhhbmRsZSApIHsKCQllbGVtLmRldGFjaEV2ZW50KCAib24iICsgdHlwZSwgaGFuZGxlICk7Cgl9OwoKalF1ZXJ5LkV2ZW50ID0gZnVuY3Rpb24oIHNyYyApIHsKCS8vIEFsbG93IGluc3RhbnRpYXRpb24gd2l0aG91dCB0aGUgJ25ldycga2V5d29yZAoJaWYgKCAhdGhpcy5wcmV2ZW50RGVmYXVsdCApIHsKCQlyZXR1cm4gbmV3IGpRdWVyeS5FdmVudCggc3JjICk7Cgl9CgoJLy8gRXZlbnQgb2JqZWN0CglpZiAoIHNyYyAmJiBzcmMudHlwZSApIHsKCQl0aGlzLm9yaWdpbmFsRXZlbnQgPSBzcmM7CgkJdGhpcy50eXBlID0gc3JjLnR5cGU7CgkvLyBFdmVudCB0eXBlCgl9IGVsc2UgewoJCXRoaXMudHlwZSA9IHNyYzsKCX0KCgkvLyB0aW1lU3RhbXAgaXMgYnVnZ3kgZm9yIHNvbWUgZXZlbnRzIG9uIEZpcmVmb3goIzM4NDMpCgkvLyBTbyB3ZSB3b24ndCByZWx5IG9uIHRoZSBuYXRpdmUgdmFsdWUKCXRoaXMudGltZVN0YW1wID0gbm93KCk7CgoJLy8gTWFyayBpdCBhcyBmaXhlZAoJdGhpc1sgZXhwYW5kbyBdID0gdHJ1ZTsKfTsKCmZ1bmN0aW9uIHJldHVybkZhbHNlKCkgewoJcmV0dXJuIGZhbHNlOwp9CmZ1bmN0aW9uIHJldHVyblRydWUoKSB7CglyZXR1cm4gdHJ1ZTsKfQoKLy8galF1ZXJ5LkV2ZW50IGlzIGJhc2VkIG9uIERPTTMgRXZlbnRzIGFzIHNwZWNpZmllZCBieSB0aGUgRUNNQVNjcmlwdCBMYW5ndWFnZSBCaW5kaW5nCi8vIGh0dHA6Ly93d3cudzMub3JnL1RSLzIwMDMvV0QtRE9NLUxldmVsLTMtRXZlbnRzLTIwMDMwMzMxL2VjbWEtc2NyaXB0LWJpbmRpbmcuaHRtbApqUXVlcnkuRXZlbnQucHJvdG90eXBlID0gewoJcHJldmVudERlZmF1bHQ6IGZ1bmN0aW9uKCkgewoJCXRoaXMuaXNEZWZhdWx0UHJldmVudGVkID0gcmV0dXJuVHJ1ZTsKCgkJdmFyIGUgPSB0aGlzLm9yaWdpbmFsRXZlbnQ7CgkJaWYgKCAhZSApIHsKCQkJcmV0dXJuOwoJCX0KCQkKCQkvLyBpZiBwcmV2ZW50RGVmYXVsdCBleGlzdHMgcnVuIGl0IG9uIHRoZSBvcmlnaW5hbCBldmVudAoJCWlmICggZS5wcmV2ZW50RGVmYXVsdCApIHsKCQkJZS5wcmV2ZW50RGVmYXVsdCgpOwoJCX0KCQkvLyBvdGhlcndpc2Ugc2V0IHRoZSByZXR1cm5WYWx1ZSBwcm9wZXJ0eSBvZiB0aGUgb3JpZ2luYWwgZXZlbnQgdG8gZmFsc2UgKElFKQoJCWUucmV0dXJuVmFsdWUgPSBmYWxzZTsKCX0sCglzdG9wUHJvcGFnYXRpb246IGZ1bmN0aW9uKCkgewoJCXRoaXMuaXNQcm9wYWdhdGlvblN0b3BwZWQgPSByZXR1cm5UcnVlOwoKCQl2YXIgZSA9IHRoaXMub3JpZ2luYWxFdmVudDsKCQlpZiAoICFlICkgewoJCQlyZXR1cm47CgkJfQoJCS8vIGlmIHN0b3BQcm9wYWdhdGlvbiBleGlzdHMgcnVuIGl0IG9uIHRoZSBvcmlnaW5hbCBldmVudAoJCWlmICggZS5zdG9wUHJvcGFnYXRpb24gKSB7CgkJCWUuc3RvcFByb3BhZ2F0aW9uKCk7CgkJfQoJCS8vIG90aGVyd2lzZSBzZXQgdGhlIGNhbmNlbEJ1YmJsZSBwcm9wZXJ0eSBvZiB0aGUgb3JpZ2luYWwgZXZlbnQgdG8gdHJ1ZSAoSUUpCgkJZS5jYW5jZWxCdWJibGUgPSB0cnVlOwoJfSwKCXN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbjogZnVuY3Rpb24oKSB7CgkJdGhpcy5pc0ltbWVkaWF0ZVByb3BhZ2F0aW9uU3RvcHBlZCA9IHJldHVyblRydWU7CgkJdGhpcy5zdG9wUHJvcGFnYXRpb24oKTsKCX0sCglpc0RlZmF1bHRQcmV2ZW50ZWQ6IHJldHVybkZhbHNlLAoJaXNQcm9wYWdhdGlvblN0b3BwZWQ6IHJldHVybkZhbHNlLAoJaXNJbW1lZGlhdGVQcm9wYWdhdGlvblN0b3BwZWQ6IHJldHVybkZhbHNlCn07CgovLyBDaGVja3MgaWYgYW4gZXZlbnQgaGFwcGVuZWQgb24gYW4gZWxlbWVudCB3aXRoaW4gYW5vdGhlciBlbGVtZW50Ci8vIFVzZWQgaW4galF1ZXJ5LmV2ZW50LnNwZWNpYWwubW91c2VlbnRlciBhbmQgbW91c2VsZWF2ZSBoYW5kbGVycwp2YXIgd2l0aGluRWxlbWVudCA9IGZ1bmN0aW9uKCBldmVudCApIHsKCS8vIENoZWNrIGlmIG1vdXNlKG92ZXJ8b3V0KSBhcmUgc3RpbGwgd2l0aGluIHRoZSBzYW1lIHBhcmVudCBlbGVtZW50Cgl2YXIgcGFyZW50ID0gZXZlbnQucmVsYXRlZFRhcmdldDsKCgkvLyBGaXJlZm94IHNvbWV0aW1lcyBhc3NpZ25zIHJlbGF0ZWRUYXJnZXQgYSBYVUwgZWxlbWVudAoJLy8gd2hpY2ggd2UgY2Fubm90IGFjY2VzcyB0aGUgcGFyZW50Tm9kZSBwcm9wZXJ0eSBvZgoJdHJ5IHsKCQkvLyBUcmF2ZXJzZSB1cCB0aGUgdHJlZQoJCXdoaWxlICggcGFyZW50ICYmIHBhcmVudCAhPT0gdGhpcyApIHsKCQkJcGFyZW50ID0gcGFyZW50LnBhcmVudE5vZGU7CgkJfQoKCQlpZiAoIHBhcmVudCAhPT0gdGhpcyApIHsKCQkJLy8gc2V0IHRoZSBjb3JyZWN0IGV2ZW50IHR5cGUKCQkJZXZlbnQudHlwZSA9IGV2ZW50LmRhdGE7CgoJCQkvLyBoYW5kbGUgZXZlbnQgaWYgd2UgYWN0dWFsbHkganVzdCBtb3VzZWQgb24gdG8gYSBub24gc3ViLWVsZW1lbnQKCQkJalF1ZXJ5LmV2ZW50LmhhbmRsZS5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgkJfQoKCS8vIGFzc3VtaW5nIHdlJ3ZlIGxlZnQgdGhlIGVsZW1lbnQgc2luY2Ugd2UgbW9zdCBsaWtlbHkgbW91c2Vkb3ZlciBhIHh1bCBlbGVtZW50Cgl9IGNhdGNoKGUpIHsgfQp9LAoKLy8gSW4gY2FzZSBvZiBldmVudCBkZWxlZ2F0aW9uLCB3ZSBvbmx5IG5lZWQgdG8gcmVuYW1lIHRoZSBldmVudC50eXBlLAovLyBsaXZlSGFuZGxlciB3aWxsIHRha2UgY2FyZSBvZiB0aGUgcmVzdC4KZGVsZWdhdGUgPSBmdW5jdGlvbiggZXZlbnQgKSB7CglldmVudC50eXBlID0gZXZlbnQuZGF0YTsKCWpRdWVyeS5ldmVudC5oYW5kbGUuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwp9OwoKLy8gQ3JlYXRlIG1vdXNlZW50ZXIgYW5kIG1vdXNlbGVhdmUgZXZlbnRzCmpRdWVyeS5lYWNoKHsKCW1vdXNlZW50ZXI6ICJtb3VzZW92ZXIiLAoJbW91c2VsZWF2ZTogIm1vdXNlb3V0Igp9LCBmdW5jdGlvbiggb3JpZywgZml4ICkgewoJalF1ZXJ5LmV2ZW50LnNwZWNpYWxbIG9yaWcgXSA9IHsKCQlzZXR1cDogZnVuY3Rpb24oIGRhdGEgKSB7CgkJCWpRdWVyeS5ldmVudC5hZGQoIHRoaXMsIGZpeCwgZGF0YSAmJiBkYXRhLnNlbGVjdG9yID8gZGVsZWdhdGUgOiB3aXRoaW5FbGVtZW50LCBvcmlnICk7CgkJfSwKCQl0ZWFyZG93bjogZnVuY3Rpb24oIGRhdGEgKSB7CgkJCWpRdWVyeS5ldmVudC5yZW1vdmUoIHRoaXMsIGZpeCwgZGF0YSAmJiBkYXRhLnNlbGVjdG9yID8gZGVsZWdhdGUgOiB3aXRoaW5FbGVtZW50ICk7CgkJfQoJfTsKfSk7CgovLyBzdWJtaXQgZGVsZWdhdGlvbgppZiAoICFqUXVlcnkuc3VwcG9ydC5zdWJtaXRCdWJibGVzICkgewoKCWpRdWVyeS5ldmVudC5zcGVjaWFsLnN1Ym1pdCA9IHsKCQlzZXR1cDogZnVuY3Rpb24oIGRhdGEsIG5hbWVzcGFjZXMgKSB7CgkJCWlmICggdGhpcy5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpICE9PSAiZm9ybSIgKSB7CgkJCQlqUXVlcnkuZXZlbnQuYWRkKHRoaXMsICJjbGljay5zcGVjaWFsU3VibWl0IiwgZnVuY3Rpb24oIGUgKSB7CgkJCQkJdmFyIGVsZW0gPSBlLnRhcmdldCwgdHlwZSA9IGVsZW0udHlwZTsKCgkJCQkJaWYgKCAodHlwZSA9PT0gInN1Ym1pdCIgfHwgdHlwZSA9PT0gImltYWdlIikgJiYgalF1ZXJ5KCBlbGVtICkuY2xvc2VzdCgiZm9ybSIpLmxlbmd0aCApIHsKCQkJCQkJcmV0dXJuIHRyaWdnZXIoICJzdWJtaXQiLCB0aGlzLCBhcmd1bWVudHMgKTsKCQkJCQl9CgkJCQl9KTsKCSAKCQkJCWpRdWVyeS5ldmVudC5hZGQodGhpcywgImtleXByZXNzLnNwZWNpYWxTdWJtaXQiLCBmdW5jdGlvbiggZSApIHsKCQkJCQl2YXIgZWxlbSA9IGUudGFyZ2V0LCB0eXBlID0gZWxlbS50eXBlOwoKCQkJCQlpZiAoICh0eXBlID09PSAidGV4dCIgfHwgdHlwZSA9PT0gInBhc3N3b3JkIikgJiYgalF1ZXJ5KCBlbGVtICkuY2xvc2VzdCgiZm9ybSIpLmxlbmd0aCAmJiBlLmtleUNvZGUgPT09IDEzICkgewoJCQkJCQlyZXR1cm4gdHJpZ2dlciggInN1Ym1pdCIsIHRoaXMsIGFyZ3VtZW50cyApOwoJCQkJCX0KCQkJCX0pOwoKCQkJfSBlbHNlIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoJCX0sCgoJCXRlYXJkb3duOiBmdW5jdGlvbiggbmFtZXNwYWNlcyApIHsKCQkJalF1ZXJ5LmV2ZW50LnJlbW92ZSggdGhpcywgIi5zcGVjaWFsU3VibWl0IiApOwoJCX0KCX07Cgp9CgovLyBjaGFuZ2UgZGVsZWdhdGlvbiwgaGFwcGVucyBoZXJlIHNvIHdlIGhhdmUgYmluZC4KaWYgKCAhalF1ZXJ5LnN1cHBvcnQuY2hhbmdlQnViYmxlcyApIHsKCgl2YXIgZm9ybUVsZW1zID0gL3RleHRhcmVhfGlucHV0fHNlbGVjdC9pLAoKCWNoYW5nZUZpbHRlcnMsCgoJZ2V0VmFsID0gZnVuY3Rpb24oIGVsZW0gKSB7CgkJdmFyIHR5cGUgPSBlbGVtLnR5cGUsIHZhbCA9IGVsZW0udmFsdWU7CgoJCWlmICggdHlwZSA9PT0gInJhZGlvIiB8fCB0eXBlID09PSAiY2hlY2tib3giICkgewoJCQl2YWwgPSBlbGVtLmNoZWNrZWQ7CgoJCX0gZWxzZSBpZiAoIHR5cGUgPT09ICJzZWxlY3QtbXVsdGlwbGUiICkgewoJCQl2YWwgPSBlbGVtLnNlbGVjdGVkSW5kZXggPiAtMSA/CgkJCQlqUXVlcnkubWFwKCBlbGVtLm9wdGlvbnMsIGZ1bmN0aW9uKCBlbGVtICkgewoJCQkJCXJldHVybiBlbGVtLnNlbGVjdGVkOwoJCQkJfSkuam9pbigiLSIpIDoKCQkJCSIiOwoKCQl9IGVsc2UgaWYgKCBlbGVtLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09ICJzZWxlY3QiICkgewoJCQl2YWwgPSBlbGVtLnNlbGVjdGVkSW5kZXg7CgkJfQoKCQlyZXR1cm4gdmFsOwoJfSwKCgl0ZXN0Q2hhbmdlID0gZnVuY3Rpb24gdGVzdENoYW5nZSggZSApIHsKCQl2YXIgZWxlbSA9IGUudGFyZ2V0LCBkYXRhLCB2YWw7CgoJCWlmICggIWZvcm1FbGVtcy50ZXN0KCBlbGVtLm5vZGVOYW1lICkgfHwgZWxlbS5yZWFkT25seSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJZGF0YSA9IGpRdWVyeS5kYXRhKCBlbGVtLCAiX2NoYW5nZV9kYXRhIiApOwoJCXZhbCA9IGdldFZhbChlbGVtKTsKCgkJLy8gdGhlIGN1cnJlbnQgZGF0YSB3aWxsIGJlIGFsc28gcmV0cmlldmVkIGJ5IGJlZm9yZWFjdGl2YXRlCgkJaWYgKCBlLnR5cGUgIT09ICJmb2N1c291dCIgfHwgZWxlbS50eXBlICE9PSAicmFkaW8iICkgewoJCQlqUXVlcnkuZGF0YSggZWxlbSwgIl9jaGFuZ2VfZGF0YSIsIHZhbCApOwoJCX0KCQkKCQlpZiAoIGRhdGEgPT09IHVuZGVmaW5lZCB8fCB2YWwgPT09IGRhdGEgKSB7CgkJCXJldHVybjsKCQl9CgoJCWlmICggZGF0YSAhPSBudWxsIHx8IHZhbCApIHsKCQkJZS50eXBlID0gImNoYW5nZSI7CgkJCXJldHVybiBqUXVlcnkuZXZlbnQudHJpZ2dlciggZSwgYXJndW1lbnRzWzFdLCBlbGVtICk7CgkJfQoJfTsKCglqUXVlcnkuZXZlbnQuc3BlY2lhbC5jaGFuZ2UgPSB7CgkJZmlsdGVyczogewoJCQlmb2N1c291dDogdGVzdENoYW5nZSwgCgoJCQljbGljazogZnVuY3Rpb24oIGUgKSB7CgkJCQl2YXIgZWxlbSA9IGUudGFyZ2V0LCB0eXBlID0gZWxlbS50eXBlOwoKCQkJCWlmICggdHlwZSA9PT0gInJhZGlvIiB8fCB0eXBlID09PSAiY2hlY2tib3giIHx8IGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gInNlbGVjdCIgKSB7CgkJCQkJcmV0dXJuIHRlc3RDaGFuZ2UuY2FsbCggdGhpcywgZSApOwoJCQkJfQoJCQl9LAoKCQkJLy8gQ2hhbmdlIGhhcyB0byBiZSBjYWxsZWQgYmVmb3JlIHN1Ym1pdAoJCQkvLyBLZXlkb3duIHdpbGwgYmUgY2FsbGVkIGJlZm9yZSBrZXlwcmVzcywgd2hpY2ggaXMgdXNlZCBpbiBzdWJtaXQtZXZlbnQgZGVsZWdhdGlvbgoJCQlrZXlkb3duOiBmdW5jdGlvbiggZSApIHsKCQkJCXZhciBlbGVtID0gZS50YXJnZXQsIHR5cGUgPSBlbGVtLnR5cGU7CgoJCQkJaWYgKCAoZS5rZXlDb2RlID09PSAxMyAmJiBlbGVtLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgIT09ICJ0ZXh0YXJlYSIpIHx8CgkJCQkJKGUua2V5Q29kZSA9PT0gMzIgJiYgKHR5cGUgPT09ICJjaGVja2JveCIgfHwgdHlwZSA9PT0gInJhZGlvIikpIHx8CgkJCQkJdHlwZSA9PT0gInNlbGVjdC1tdWx0aXBsZSIgKSB7CgkJCQkJcmV0dXJuIHRlc3RDaGFuZ2UuY2FsbCggdGhpcywgZSApOwoJCQkJfQoJCQl9LAoKCQkJLy8gQmVmb3JlYWN0aXZhdGUgaGFwcGVucyBhbHNvIGJlZm9yZSB0aGUgcHJldmlvdXMgZWxlbWVudCBpcyBibHVycmVkCgkJCS8vIHdpdGggdGhpcyBldmVudCB5b3UgY2FuJ3QgdHJpZ2dlciBhIGNoYW5nZSBldmVudCwgYnV0IHlvdSBjYW4gc3RvcmUKCQkJLy8gaW5mb3JtYXRpb24vZm9jdXNbaW5dIGlzIG5vdCBuZWVkZWQgYW55bW9yZQoJCQliZWZvcmVhY3RpdmF0ZTogZnVuY3Rpb24oIGUgKSB7CgkJCQl2YXIgZWxlbSA9IGUudGFyZ2V0OwoJCQkJalF1ZXJ5LmRhdGEoIGVsZW0sICJfY2hhbmdlX2RhdGEiLCBnZXRWYWwoZWxlbSkgKTsKCQkJfQoJCX0sCgoJCXNldHVwOiBmdW5jdGlvbiggZGF0YSwgbmFtZXNwYWNlcyApIHsKCQkJaWYgKCB0aGlzLnR5cGUgPT09ICJmaWxlIiApIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoKCQkJZm9yICggdmFyIHR5cGUgaW4gY2hhbmdlRmlsdGVycyApIHsKCQkJCWpRdWVyeS5ldmVudC5hZGQoIHRoaXMsIHR5cGUgKyAiLnNwZWNpYWxDaGFuZ2UiLCBjaGFuZ2VGaWx0ZXJzW3R5cGVdICk7CgkJCX0KCgkJCXJldHVybiBmb3JtRWxlbXMudGVzdCggdGhpcy5ub2RlTmFtZSApOwoJCX0sCgoJCXRlYXJkb3duOiBmdW5jdGlvbiggbmFtZXNwYWNlcyApIHsKCQkJalF1ZXJ5LmV2ZW50LnJlbW92ZSggdGhpcywgIi5zcGVjaWFsQ2hhbmdlIiApOwoKCQkJcmV0dXJuIGZvcm1FbGVtcy50ZXN0KCB0aGlzLm5vZGVOYW1lICk7CgkJfQoJfTsKCgljaGFuZ2VGaWx0ZXJzID0galF1ZXJ5LmV2ZW50LnNwZWNpYWwuY2hhbmdlLmZpbHRlcnM7Cn0KCmZ1bmN0aW9uIHRyaWdnZXIoIHR5cGUsIGVsZW0sIGFyZ3MgKSB7CglhcmdzWzBdLnR5cGUgPSB0eXBlOwoJcmV0dXJuIGpRdWVyeS5ldmVudC5oYW5kbGUuYXBwbHkoIGVsZW0sIGFyZ3MgKTsKfQoKLy8gQ3JlYXRlICJidWJibGluZyIgZm9jdXMgYW5kIGJsdXIgZXZlbnRzCmlmICggZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lciApIHsKCWpRdWVyeS5lYWNoKHsgZm9jdXM6ICJmb2N1c2luIiwgYmx1cjogImZvY3Vzb3V0IiB9LCBmdW5jdGlvbiggb3JpZywgZml4ICkgewoJCWpRdWVyeS5ldmVudC5zcGVjaWFsWyBmaXggXSA9IHsKCQkJc2V0dXA6IGZ1bmN0aW9uKCkgewoJCQkJdGhpcy5hZGRFdmVudExpc3RlbmVyKCBvcmlnLCBoYW5kbGVyLCB0cnVlICk7CgkJCX0sIAoJCQl0ZWFyZG93bjogZnVuY3Rpb24oKSB7IAoJCQkJdGhpcy5yZW1vdmVFdmVudExpc3RlbmVyKCBvcmlnLCBoYW5kbGVyLCB0cnVlICk7CgkJCX0KCQl9OwoKCQlmdW5jdGlvbiBoYW5kbGVyKCBlICkgeyAKCQkJZSA9IGpRdWVyeS5ldmVudC5maXgoIGUgKTsKCQkJZS50eXBlID0gZml4OwoJCQlyZXR1cm4galF1ZXJ5LmV2ZW50LmhhbmRsZS5jYWxsKCB0aGlzLCBlICk7CgkJfQoJfSk7Cn0KCmpRdWVyeS5lYWNoKFsiYmluZCIsICJvbmUiXSwgZnVuY3Rpb24oIGksIG5hbWUgKSB7CglqUXVlcnkuZm5bIG5hbWUgXSA9IGZ1bmN0aW9uKCB0eXBlLCBkYXRhLCBmbiApIHsKCQkvLyBIYW5kbGUgb2JqZWN0IGxpdGVyYWxzCgkJaWYgKCB0eXBlb2YgdHlwZSA9PT0gIm9iamVjdCIgKSB7CgkJCWZvciAoIHZhciBrZXkgaW4gdHlwZSApIHsKCQkJCXRoaXNbIG5hbWUgXShrZXksIGRhdGEsIHR5cGVba2V5XSwgZm4pOwoJCQl9CgkJCXJldHVybiB0aGlzOwoJCX0KCQkKCQlpZiAoIGpRdWVyeS5pc0Z1bmN0aW9uKCBkYXRhICkgKSB7CgkJCWZuID0gZGF0YTsKCQkJZGF0YSA9IHVuZGVmaW5lZDsKCQl9CgoJCXZhciBoYW5kbGVyID0gbmFtZSA9PT0gIm9uZSIgPyBqUXVlcnkucHJveHkoIGZuLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCWpRdWVyeSggdGhpcyApLnVuYmluZCggZXZlbnQsIGhhbmRsZXIgKTsKCQkJcmV0dXJuIGZuLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsKCQl9KSA6IGZuOwoKCQlpZiAoIHR5cGUgPT09ICJ1bmxvYWQiICYmIG5hbWUgIT09ICJvbmUiICkgewoJCQl0aGlzLm9uZSggdHlwZSwgZGF0YSwgZm4gKTsKCgkJfSBlbHNlIHsKCQkJZm9yICggdmFyIGkgPSAwLCBsID0gdGhpcy5sZW5ndGg7IGkgPCBsOyBpKysgKSB7CgkJCQlqUXVlcnkuZXZlbnQuYWRkKCB0aGlzW2ldLCB0eXBlLCBoYW5kbGVyLCBkYXRhICk7CgkJCX0KCQl9CgoJCXJldHVybiB0aGlzOwoJfTsKfSk7CgpqUXVlcnkuZm4uZXh0ZW5kKHsKCXVuYmluZDogZnVuY3Rpb24oIHR5cGUsIGZuICkgewoJCS8vIEhhbmRsZSBvYmplY3QgbGl0ZXJhbHMKCQlpZiAoIHR5cGVvZiB0eXBlID09PSAib2JqZWN0IiAmJiAhdHlwZS5wcmV2ZW50RGVmYXVsdCApIHsKCQkJZm9yICggdmFyIGtleSBpbiB0eXBlICkgewoJCQkJdGhpcy51bmJpbmQoa2V5LCB0eXBlW2tleV0pOwoJCQl9CgoJCX0gZWxzZSB7CgkJCWZvciAoIHZhciBpID0gMCwgbCA9IHRoaXMubGVuZ3RoOyBpIDwgbDsgaSsrICkgewoJCQkJalF1ZXJ5LmV2ZW50LnJlbW92ZSggdGhpc1tpXSwgdHlwZSwgZm4gKTsKCQkJfQoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9LAoJCglkZWxlZ2F0ZTogZnVuY3Rpb24oIHNlbGVjdG9yLCB0eXBlcywgZGF0YSwgZm4gKSB7CgkJcmV0dXJuIHRoaXMubGl2ZSggdHlwZXMsIGRhdGEsIGZuLCBzZWxlY3RvciApOwoJfSwKCQoJdW5kZWxlZ2F0ZTogZnVuY3Rpb24oIHNlbGVjdG9yLCB0eXBlcywgZm4gKSB7CgkJaWYgKCBhcmd1bWVudHMubGVuZ3RoID09PSAwICkgewoJCQkJcmV0dXJuIHRoaXMudW5iaW5kKCAibGl2ZSIgKTsKCQkKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5kaWUoIHR5cGVzLCBudWxsLCBmbiwgc2VsZWN0b3IgKTsKCQl9Cgl9LAoJCgl0cmlnZ2VyOiBmdW5jdGlvbiggdHlwZSwgZGF0YSApIHsKCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQlqUXVlcnkuZXZlbnQudHJpZ2dlciggdHlwZSwgZGF0YSwgdGhpcyApOwoJCX0pOwoJfSwKCgl0cmlnZ2VySGFuZGxlcjogZnVuY3Rpb24oIHR5cGUsIGRhdGEgKSB7CgkJaWYgKCB0aGlzWzBdICkgewoJCQl2YXIgZXZlbnQgPSBqUXVlcnkuRXZlbnQoIHR5cGUgKTsKCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7CgkJCWpRdWVyeS5ldmVudC50cmlnZ2VyKCBldmVudCwgZGF0YSwgdGhpc1swXSApOwoJCQlyZXR1cm4gZXZlbnQucmVzdWx0OwoJCX0KCX0sCgoJdG9nZ2xlOiBmdW5jdGlvbiggZm4gKSB7CgkJLy8gU2F2ZSByZWZlcmVuY2UgdG8gYXJndW1lbnRzIGZvciBhY2Nlc3MgaW4gY2xvc3VyZQoJCXZhciBhcmdzID0gYXJndW1lbnRzLCBpID0gMTsKCgkJLy8gbGluayBhbGwgdGhlIGZ1bmN0aW9ucywgc28gYW55IG9mIHRoZW0gY2FuIHVuYmluZCB0aGlzIGNsaWNrIGhhbmRsZXIKCQl3aGlsZSAoIGkgPCBhcmdzLmxlbmd0aCApIHsKCQkJalF1ZXJ5LnByb3h5KCBmbiwgYXJnc1sgaSsrIF0gKTsKCQl9CgoJCXJldHVybiB0aGlzLmNsaWNrKCBqUXVlcnkucHJveHkoIGZuLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCS8vIEZpZ3VyZSBvdXQgd2hpY2ggZnVuY3Rpb24gdG8gZXhlY3V0ZQoJCQl2YXIgbGFzdFRvZ2dsZSA9ICggalF1ZXJ5LmRhdGEoIHRoaXMsICJsYXN0VG9nZ2xlIiArIGZuLmd1aWQgKSB8fCAwICkgJSBpOwoJCQlqUXVlcnkuZGF0YSggdGhpcywgImxhc3RUb2dnbGUiICsgZm4uZ3VpZCwgbGFzdFRvZ2dsZSArIDEgKTsKCgkJCS8vIE1ha2Ugc3VyZSB0aGF0IGNsaWNrcyBzdG9wCgkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgoJCQkvLyBhbmQgZXhlY3V0ZSB0aGUgZnVuY3Rpb24KCQkJcmV0dXJuIGFyZ3NbIGxhc3RUb2dnbGUgXS5hcHBseSggdGhpcywgYXJndW1lbnRzICkgfHwgZmFsc2U7CgkJfSkpOwoJfSwKCglob3ZlcjogZnVuY3Rpb24oIGZuT3ZlciwgZm5PdXQgKSB7CgkJcmV0dXJuIHRoaXMubW91c2VlbnRlciggZm5PdmVyICkubW91c2VsZWF2ZSggZm5PdXQgfHwgZm5PdmVyICk7Cgl9Cn0pOwoKdmFyIGxpdmVNYXAgPSB7Cglmb2N1czogImZvY3VzaW4iLAoJYmx1cjogImZvY3Vzb3V0IiwKCW1vdXNlZW50ZXI6ICJtb3VzZW92ZXIiLAoJbW91c2VsZWF2ZTogIm1vdXNlb3V0Igp9OwoKalF1ZXJ5LmVhY2goWyJsaXZlIiwgImRpZSJdLCBmdW5jdGlvbiggaSwgbmFtZSApIHsKCWpRdWVyeS5mblsgbmFtZSBdID0gZnVuY3Rpb24oIHR5cGVzLCBkYXRhLCBmbiwgb3JpZ1NlbGVjdG9yIC8qIEludGVybmFsIFVzZSBPbmx5ICovICkgewoJCXZhciB0eXBlLCBpID0gMCwgbWF0Y2gsIG5hbWVzcGFjZXMsIHByZVR5cGUsCgkJCXNlbGVjdG9yID0gb3JpZ1NlbGVjdG9yIHx8IHRoaXMuc2VsZWN0b3IsCgkJCWNvbnRleHQgPSBvcmlnU2VsZWN0b3IgPyB0aGlzIDogalF1ZXJ5KCB0aGlzLmNvbnRleHQgKTsKCgkJaWYgKCBqUXVlcnkuaXNGdW5jdGlvbiggZGF0YSApICkgewoJCQlmbiA9IGRhdGE7CgkJCWRhdGEgPSB1bmRlZmluZWQ7CgkJfQoKCQl0eXBlcyA9ICh0eXBlcyB8fCAiIikuc3BsaXQoIiAiKTsKCgkJd2hpbGUgKCAodHlwZSA9IHR5cGVzWyBpKysgXSkgIT0gbnVsbCApIHsKCQkJbWF0Y2ggPSBybmFtZXNwYWNlcy5leGVjKCB0eXBlICk7CgkJCW5hbWVzcGFjZXMgPSAiIjsKCgkJCWlmICggbWF0Y2ggKSAgewoJCQkJbmFtZXNwYWNlcyA9IG1hdGNoWzBdOwoJCQkJdHlwZSA9IHR5cGUucmVwbGFjZSggcm5hbWVzcGFjZXMsICIiICk7CgkJCX0KCgkJCWlmICggdHlwZSA9PT0gImhvdmVyIiApIHsKCQkJCXR5cGVzLnB1c2goICJtb3VzZWVudGVyIiArIG5hbWVzcGFjZXMsICJtb3VzZWxlYXZlIiArIG5hbWVzcGFjZXMgKTsKCQkJCWNvbnRpbnVlOwoJCQl9CgoJCQlwcmVUeXBlID0gdHlwZTsKCgkJCWlmICggdHlwZSA9PT0gImZvY3VzIiB8fCB0eXBlID09PSAiYmx1ciIgKSB7CgkJCQl0eXBlcy5wdXNoKCBsaXZlTWFwWyB0eXBlIF0gKyBuYW1lc3BhY2VzICk7CgkJCQl0eXBlID0gdHlwZSArIG5hbWVzcGFjZXM7CgoJCQl9IGVsc2UgewoJCQkJdHlwZSA9IChsaXZlTWFwWyB0eXBlIF0gfHwgdHlwZSkgKyBuYW1lc3BhY2VzOwoJCQl9CgoJCQlpZiAoIG5hbWUgPT09ICJsaXZlIiApIHsKCQkJCS8vIGJpbmQgbGl2ZSBoYW5kbGVyCgkJCQljb250ZXh0LmVhY2goZnVuY3Rpb24oKXsKCQkJCQlqUXVlcnkuZXZlbnQuYWRkKCB0aGlzLCBsaXZlQ29udmVydCggdHlwZSwgc2VsZWN0b3IgKSwKCQkJCQkJeyBkYXRhOiBkYXRhLCBzZWxlY3Rvcjogc2VsZWN0b3IsIGhhbmRsZXI6IGZuLCBvcmlnVHlwZTogdHlwZSwgb3JpZ0hhbmRsZXI6IGZuLCBwcmVUeXBlOiBwcmVUeXBlIH0gKTsKCQkJCX0pOwoKCQkJfSBlbHNlIHsKCQkJCS8vIHVuYmluZCBsaXZlIGhhbmRsZXIKCQkJCWNvbnRleHQudW5iaW5kKCBsaXZlQ29udmVydCggdHlwZSwgc2VsZWN0b3IgKSwgZm4gKTsKCQkJfQoJCX0KCQkKCQlyZXR1cm4gdGhpczsKCX0KfSk7CgpmdW5jdGlvbiBsaXZlSGFuZGxlciggZXZlbnQgKSB7Cgl2YXIgc3RvcCwgZWxlbXMgPSBbXSwgc2VsZWN0b3JzID0gW10sIGFyZ3MgPSBhcmd1bWVudHMsCgkJcmVsYXRlZCwgbWF0Y2gsIGhhbmRsZU9iaiwgZWxlbSwgaiwgaSwgbCwgZGF0YSwKCQlldmVudHMgPSBqUXVlcnkuZGF0YSggdGhpcywgImV2ZW50cyIgKTsKCgkvLyBNYWtlIHN1cmUgd2UgYXZvaWQgbm9uLWxlZnQtY2xpY2sgYnViYmxpbmcgaW4gRmlyZWZveCAoIzM4NjEpCglpZiAoIGV2ZW50LmxpdmVGaXJlZCA9PT0gdGhpcyB8fCAhZXZlbnRzIHx8ICFldmVudHMubGl2ZSB8fCBldmVudC5idXR0b24gJiYgZXZlbnQudHlwZSA9PT0gImNsaWNrIiApIHsKCQlyZXR1cm47Cgl9CgoJZXZlbnQubGl2ZUZpcmVkID0gdGhpczsKCgl2YXIgbGl2ZSA9IGV2ZW50cy5saXZlLnNsaWNlKDApOwoKCWZvciAoIGogPSAwOyBqIDwgbGl2ZS5sZW5ndGg7IGorKyApIHsKCQloYW5kbGVPYmogPSBsaXZlW2pdOwoKCQlpZiAoIGhhbmRsZU9iai5vcmlnVHlwZS5yZXBsYWNlKCBybmFtZXNwYWNlcywgIiIgKSA9PT0gZXZlbnQudHlwZSApIHsKCQkJc2VsZWN0b3JzLnB1c2goIGhhbmRsZU9iai5zZWxlY3RvciApOwoKCQl9IGVsc2UgewoJCQlsaXZlLnNwbGljZSggai0tLCAxICk7CgkJfQoJfQoKCW1hdGNoID0galF1ZXJ5KCBldmVudC50YXJnZXQgKS5jbG9zZXN0KCBzZWxlY3RvcnMsIGV2ZW50LmN1cnJlbnRUYXJnZXQgKTsKCglmb3IgKCBpID0gMCwgbCA9IG1hdGNoLmxlbmd0aDsgaSA8IGw7IGkrKyApIHsKCQlmb3IgKCBqID0gMDsgaiA8IGxpdmUubGVuZ3RoOyBqKysgKSB7CgkJCWhhbmRsZU9iaiA9IGxpdmVbal07CgoJCQlpZiAoIG1hdGNoW2ldLnNlbGVjdG9yID09PSBoYW5kbGVPYmouc2VsZWN0b3IgKSB7CgkJCQllbGVtID0gbWF0Y2hbaV0uZWxlbTsKCQkJCXJlbGF0ZWQgPSBudWxsOwoKCQkJCS8vIFRob3NlIHR3byBldmVudHMgcmVxdWlyZSBhZGRpdGlvbmFsIGNoZWNraW5nCgkJCQlpZiAoIGhhbmRsZU9iai5wcmVUeXBlID09PSAibW91c2VlbnRlciIgfHwgaGFuZGxlT2JqLnByZVR5cGUgPT09ICJtb3VzZWxlYXZlIiApIHsKCQkJCQlyZWxhdGVkID0galF1ZXJ5KCBldmVudC5yZWxhdGVkVGFyZ2V0ICkuY2xvc2VzdCggaGFuZGxlT2JqLnNlbGVjdG9yIClbMF07CgkJCQl9CgoJCQkJaWYgKCAhcmVsYXRlZCB8fCByZWxhdGVkICE9PSBlbGVtICkgewoJCQkJCWVsZW1zLnB1c2goeyBlbGVtOiBlbGVtLCBoYW5kbGVPYmo6IGhhbmRsZU9iaiB9KTsKCQkJCX0KCQkJfQoJCX0KCX0KCglmb3IgKCBpID0gMCwgbCA9IGVsZW1zLmxlbmd0aDsgaSA8IGw7IGkrKyApIHsKCQltYXRjaCA9IGVsZW1zW2ldOwoJCWV2ZW50LmN1cnJlbnRUYXJnZXQgPSBtYXRjaC5lbGVtOwoJCWV2ZW50LmRhdGEgPSBtYXRjaC5oYW5kbGVPYmouZGF0YTsKCQlldmVudC5oYW5kbGVPYmogPSBtYXRjaC5oYW5kbGVPYmo7CgoJCWlmICggbWF0Y2guaGFuZGxlT2JqLm9yaWdIYW5kbGVyLmFwcGx5KCBtYXRjaC5lbGVtLCBhcmdzICkgPT09IGZhbHNlICkgewoJCQlzdG9wID0gZmFsc2U7CgkJCWJyZWFrOwoJCX0KCX0KCglyZXR1cm4gc3RvcDsKfQoKZnVuY3Rpb24gbGl2ZUNvbnZlcnQoIHR5cGUsIHNlbGVjdG9yICkgewoJcmV0dXJuICJsaXZlLiIgKyAodHlwZSAmJiB0eXBlICE9PSAiKiIgPyB0eXBlICsgIi4iIDogIiIpICsgc2VsZWN0b3IucmVwbGFjZSgvXC4vZywgImAiKS5yZXBsYWNlKC8gL2csICImIik7Cn0KCmpRdWVyeS5lYWNoKCAoImJsdXIgZm9jdXMgZm9jdXNpbiBmb2N1c291dCBsb2FkIHJlc2l6ZSBzY3JvbGwgdW5sb2FkIGNsaWNrIGRibGNsaWNrICIgKwoJIm1vdXNlZG93biBtb3VzZXVwIG1vdXNlbW92ZSBtb3VzZW92ZXIgbW91c2VvdXQgbW91c2VlbnRlciBtb3VzZWxlYXZlICIgKwoJImNoYW5nZSBzZWxlY3Qgc3VibWl0IGtleWRvd24ga2V5cHJlc3Mga2V5dXAgZXJyb3IiKS5zcGxpdCgiICIpLCBmdW5jdGlvbiggaSwgbmFtZSApIHsKCgkvLyBIYW5kbGUgZXZlbnQgYmluZGluZwoJalF1ZXJ5LmZuWyBuYW1lIF0gPSBmdW5jdGlvbiggZm4gKSB7CgkJcmV0dXJuIGZuID8gdGhpcy5iaW5kKCBuYW1lLCBmbiApIDogdGhpcy50cmlnZ2VyKCBuYW1lICk7Cgl9OwoKCWlmICggalF1ZXJ5LmF0dHJGbiApIHsKCQlqUXVlcnkuYXR0ckZuWyBuYW1lIF0gPSB0cnVlOwoJfQp9KTsKCi8vIFByZXZlbnQgbWVtb3J5IGxlYWtzIGluIElFCi8vIFdpbmRvdyBpc24ndCBpbmNsdWRlZCBzbyBhcyBub3QgdG8gdW5iaW5kIGV4aXN0aW5nIHVubG9hZCBldmVudHMKLy8gTW9yZSBpbmZvOgovLyAgLSBodHRwOi8vaXNhYWNzY2hsdWV0ZXIuY29tLzIwMDYvMTAvbXNpZS1tZW1vcnktbGVha3MvCmlmICggd2luZG93LmF0dGFjaEV2ZW50ICYmICF3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lciApIHsKCXdpbmRvdy5hdHRhY2hFdmVudCgib251bmxvYWQiLCBmdW5jdGlvbigpIHsKCQlmb3IgKCB2YXIgaWQgaW4galF1ZXJ5LmNhY2hlICkgewoJCQlpZiAoIGpRdWVyeS5jYWNoZVsgaWQgXS5oYW5kbGUgKSB7CgkJCQkvLyBUcnkvQ2F0Y2ggaXMgdG8gaGFuZGxlIGlmcmFtZXMgYmVpbmcgdW5sb2FkZWQsIHNlZSAjNDI4MAoJCQkJdHJ5IHsKCQkJCQlqUXVlcnkuZXZlbnQucmVtb3ZlKCBqUXVlcnkuY2FjaGVbIGlkIF0uaGFuZGxlLmVsZW0gKTsKCQkJCX0gY2F0Y2goZSkge30KCQkJfQoJCX0KCX0pOwp9Ci8qIQogKiBTaXp6bGUgQ1NTIFNlbGVjdG9yIEVuZ2luZSAtIHYxLjAKICogIENvcHlyaWdodCAyMDA5LCBUaGUgRG9qbyBGb3VuZGF0aW9uCiAqICBSZWxlYXNlZCB1bmRlciB0aGUgTUlULCBCU0QsIGFuZCBHUEwgTGljZW5zZXMuCiAqICBNb3JlIGluZm9ybWF0aW9uOiBodHRwOi8vc2l6emxlanMuY29tLwogKi8KKGZ1bmN0aW9uKCl7Cgp2YXIgY2h1bmtlciA9IC8oKD86XCgoPzpcKFteKCldK1wpfFteKCldKykrXCl8XFsoPzpcW1teW1xdXSpcXXxbJyJdW14nIl0qWyciXXxbXltcXSciXSspK1xdfFxcLnxbXiA+K34sKFxbXFxdKykrfFs+K35dKShccyosXHMqKT8oKD86LnxccnxcbikqKS9nLAoJZG9uZSA9IDAsCgl0b1N0cmluZyA9IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcsCgloYXNEdXBsaWNhdGUgPSBmYWxzZSwKCWJhc2VIYXNEdXBsaWNhdGUgPSB0cnVlOwoKLy8gSGVyZSB3ZSBjaGVjayBpZiB0aGUgSmF2YVNjcmlwdCBlbmdpbmUgaXMgdXNpbmcgc29tZSBzb3J0IG9mCi8vIG9wdGltaXphdGlvbiB3aGVyZSBpdCBkb2VzIG5vdCBhbHdheXMgY2FsbCBvdXIgY29tcGFyaXNpb24KLy8gZnVuY3Rpb24uIElmIHRoYXQgaXMgdGhlIGNhc2UsIGRpc2NhcmQgdGhlIGhhc0R1cGxpY2F0ZSB2YWx1ZS4KLy8gICBUaHVzIGZhciB0aGF0IGluY2x1ZGVzIEdvb2dsZSBDaHJvbWUuClswLCAwXS5zb3J0KGZ1bmN0aW9uKCl7CgliYXNlSGFzRHVwbGljYXRlID0gZmFsc2U7CglyZXR1cm4gMDsKfSk7Cgp2YXIgU2l6emxlID0gZnVuY3Rpb24oc2VsZWN0b3IsIGNvbnRleHQsIHJlc3VsdHMsIHNlZWQpIHsKCXJlc3VsdHMgPSByZXN1bHRzIHx8IFtdOwoJdmFyIG9yaWdDb250ZXh0ID0gY29udGV4dCA9IGNvbnRleHQgfHwgZG9jdW1lbnQ7CgoJaWYgKCBjb250ZXh0Lm5vZGVUeXBlICE9PSAxICYmIGNvbnRleHQubm9kZVR5cGUgIT09IDkgKSB7CgkJcmV0dXJuIFtdOwoJfQoJCglpZiAoICFzZWxlY3RvciB8fCB0eXBlb2Ygc2VsZWN0b3IgIT09ICJzdHJpbmciICkgewoJCXJldHVybiByZXN1bHRzOwoJfQoKCXZhciBwYXJ0cyA9IFtdLCBtLCBzZXQsIGNoZWNrU2V0LCBleHRyYSwgcHJ1bmUgPSB0cnVlLCBjb250ZXh0WE1MID0gaXNYTUwoY29udGV4dCksCgkJc29GYXIgPSBzZWxlY3RvcjsKCQoJLy8gUmVzZXQgdGhlIHBvc2l0aW9uIG9mIHRoZSBjaHVua2VyIHJlZ2V4cCAoc3RhcnQgZnJvbSBoZWFkKQoJd2hpbGUgKCAoY2h1bmtlci5leGVjKCIiKSwgbSA9IGNodW5rZXIuZXhlYyhzb0ZhcikpICE9PSBudWxsICkgewoJCXNvRmFyID0gbVszXTsKCQkKCQlwYXJ0cy5wdXNoKCBtWzFdICk7CgkJCgkJaWYgKCBtWzJdICkgewoJCQlleHRyYSA9IG1bM107CgkJCWJyZWFrOwoJCX0KCX0KCglpZiAoIHBhcnRzLmxlbmd0aCA+IDEgJiYgb3JpZ1BPUy5leGVjKCBzZWxlY3RvciApICkgewoJCWlmICggcGFydHMubGVuZ3RoID09PSAyICYmIEV4cHIucmVsYXRpdmVbIHBhcnRzWzBdIF0gKSB7CgkJCXNldCA9IHBvc1Byb2Nlc3MoIHBhcnRzWzBdICsgcGFydHNbMV0sIGNvbnRleHQgKTsKCQl9IGVsc2UgewoJCQlzZXQgPSBFeHByLnJlbGF0aXZlWyBwYXJ0c1swXSBdID8KCQkJCVsgY29udGV4dCBdIDoKCQkJCVNpenpsZSggcGFydHMuc2hpZnQoKSwgY29udGV4dCApOwoKCQkJd2hpbGUgKCBwYXJ0cy5sZW5ndGggKSB7CgkJCQlzZWxlY3RvciA9IHBhcnRzLnNoaWZ0KCk7CgoJCQkJaWYgKCBFeHByLnJlbGF0aXZlWyBzZWxlY3RvciBdICkgewoJCQkJCXNlbGVjdG9yICs9IHBhcnRzLnNoaWZ0KCk7CgkJCQl9CgkJCQkKCQkJCXNldCA9IHBvc1Byb2Nlc3MoIHNlbGVjdG9yLCBzZXQgKTsKCQkJfQoJCX0KCX0gZWxzZSB7CgkJLy8gVGFrZSBhIHNob3J0Y3V0IGFuZCBzZXQgdGhlIGNvbnRleHQgaWYgdGhlIHJvb3Qgc2VsZWN0b3IgaXMgYW4gSUQKCQkvLyAoYnV0IG5vdCBpZiBpdCdsbCBiZSBmYXN0ZXIgaWYgdGhlIGlubmVyIHNlbGVjdG9yIGlzIGFuIElEKQoJCWlmICggIXNlZWQgJiYgcGFydHMubGVuZ3RoID4gMSAmJiBjb250ZXh0Lm5vZGVUeXBlID09PSA5ICYmICFjb250ZXh0WE1MICYmCgkJCQlFeHByLm1hdGNoLklELnRlc3QocGFydHNbMF0pICYmICFFeHByLm1hdGNoLklELnRlc3QocGFydHNbcGFydHMubGVuZ3RoIC0gMV0pICkgewoJCQl2YXIgcmV0ID0gU2l6emxlLmZpbmQoIHBhcnRzLnNoaWZ0KCksIGNvbnRleHQsIGNvbnRleHRYTUwgKTsKCQkJY29udGV4dCA9IHJldC5leHByID8gU2l6emxlLmZpbHRlciggcmV0LmV4cHIsIHJldC5zZXQgKVswXSA6IHJldC5zZXRbMF07CgkJfQoKCQlpZiAoIGNvbnRleHQgKSB7CgkJCXZhciByZXQgPSBzZWVkID8KCQkJCXsgZXhwcjogcGFydHMucG9wKCksIHNldDogbWFrZUFycmF5KHNlZWQpIH0gOgoJCQkJU2l6emxlLmZpbmQoIHBhcnRzLnBvcCgpLCBwYXJ0cy5sZW5ndGggPT09IDEgJiYgKHBhcnRzWzBdID09PSAifiIgfHwgcGFydHNbMF0gPT09ICIrIikgJiYgY29udGV4dC5wYXJlbnROb2RlID8gY29udGV4dC5wYXJlbnROb2RlIDogY29udGV4dCwgY29udGV4dFhNTCApOwoJCQlzZXQgPSByZXQuZXhwciA/IFNpenpsZS5maWx0ZXIoIHJldC5leHByLCByZXQuc2V0ICkgOiByZXQuc2V0OwoKCQkJaWYgKCBwYXJ0cy5sZW5ndGggPiAwICkgewoJCQkJY2hlY2tTZXQgPSBtYWtlQXJyYXkoc2V0KTsKCQkJfSBlbHNlIHsKCQkJCXBydW5lID0gZmFsc2U7CgkJCX0KCgkJCXdoaWxlICggcGFydHMubGVuZ3RoICkgewoJCQkJdmFyIGN1ciA9IHBhcnRzLnBvcCgpLCBwb3AgPSBjdXI7CgoJCQkJaWYgKCAhRXhwci5yZWxhdGl2ZVsgY3VyIF0gKSB7CgkJCQkJY3VyID0gIiI7CgkJCQl9IGVsc2UgewoJCQkJCXBvcCA9IHBhcnRzLnBvcCgpOwoJCQkJfQoKCQkJCWlmICggcG9wID09IG51bGwgKSB7CgkJCQkJcG9wID0gY29udGV4dDsKCQkJCX0KCgkJCQlFeHByLnJlbGF0aXZlWyBjdXIgXSggY2hlY2tTZXQsIHBvcCwgY29udGV4dFhNTCApOwoJCQl9CgkJfSBlbHNlIHsKCQkJY2hlY2tTZXQgPSBwYXJ0cyA9IFtdOwoJCX0KCX0KCglpZiAoICFjaGVja1NldCApIHsKCQljaGVja1NldCA9IHNldDsKCX0KCglpZiAoICFjaGVja1NldCApIHsKCQlTaXp6bGUuZXJyb3IoIGN1ciB8fCBzZWxlY3RvciApOwoJfQoKCWlmICggdG9TdHJpbmcuY2FsbChjaGVja1NldCkgPT09ICJbb2JqZWN0IEFycmF5XSIgKSB7CgkJaWYgKCAhcHJ1bmUgKSB7CgkJCXJlc3VsdHMucHVzaC5hcHBseSggcmVzdWx0cywgY2hlY2tTZXQgKTsKCQl9IGVsc2UgaWYgKCBjb250ZXh0ICYmIGNvbnRleHQubm9kZVR5cGUgPT09IDEgKSB7CgkJCWZvciAoIHZhciBpID0gMDsgY2hlY2tTZXRbaV0gIT0gbnVsbDsgaSsrICkgewoJCQkJaWYgKCBjaGVja1NldFtpXSAmJiAoY2hlY2tTZXRbaV0gPT09IHRydWUgfHwgY2hlY2tTZXRbaV0ubm9kZVR5cGUgPT09IDEgJiYgY29udGFpbnMoY29udGV4dCwgY2hlY2tTZXRbaV0pKSApIHsKCQkJCQlyZXN1bHRzLnB1c2goIHNldFtpXSApOwoJCQkJfQoJCQl9CgkJfSBlbHNlIHsKCQkJZm9yICggdmFyIGkgPSAwOyBjaGVja1NldFtpXSAhPSBudWxsOyBpKysgKSB7CgkJCQlpZiAoIGNoZWNrU2V0W2ldICYmIGNoZWNrU2V0W2ldLm5vZGVUeXBlID09PSAxICkgewoJCQkJCXJlc3VsdHMucHVzaCggc2V0W2ldICk7CgkJCQl9CgkJCX0KCQl9Cgl9IGVsc2UgewoJCW1ha2VBcnJheSggY2hlY2tTZXQsIHJlc3VsdHMgKTsKCX0KCglpZiAoIGV4dHJhICkgewoJCVNpenpsZSggZXh0cmEsIG9yaWdDb250ZXh0LCByZXN1bHRzLCBzZWVkICk7CgkJU2l6emxlLnVuaXF1ZVNvcnQoIHJlc3VsdHMgKTsKCX0KCglyZXR1cm4gcmVzdWx0czsKfTsKClNpenpsZS51bmlxdWVTb3J0ID0gZnVuY3Rpb24ocmVzdWx0cyl7CglpZiAoIHNvcnRPcmRlciApIHsKCQloYXNEdXBsaWNhdGUgPSBiYXNlSGFzRHVwbGljYXRlOwoJCXJlc3VsdHMuc29ydChzb3J0T3JkZXIpOwoKCQlpZiAoIGhhc0R1cGxpY2F0ZSApIHsKCQkJZm9yICggdmFyIGkgPSAxOyBpIDwgcmVzdWx0cy5sZW5ndGg7IGkrKyApIHsKCQkJCWlmICggcmVzdWx0c1tpXSA9PT0gcmVzdWx0c1tpLTFdICkgewoJCQkJCXJlc3VsdHMuc3BsaWNlKGktLSwgMSk7CgkJCQl9CgkJCX0KCQl9Cgl9CgoJcmV0dXJuIHJlc3VsdHM7Cn07CgpTaXp6bGUubWF0Y2hlcyA9IGZ1bmN0aW9uKGV4cHIsIHNldCl7CglyZXR1cm4gU2l6emxlKGV4cHIsIG51bGwsIG51bGwsIHNldCk7Cn07CgpTaXp6bGUuZmluZCA9IGZ1bmN0aW9uKGV4cHIsIGNvbnRleHQsIGlzWE1MKXsKCXZhciBzZXQsIG1hdGNoOwoKCWlmICggIWV4cHIgKSB7CgkJcmV0dXJuIFtdOwoJfQoKCWZvciAoIHZhciBpID0gMCwgbCA9IEV4cHIub3JkZXIubGVuZ3RoOyBpIDwgbDsgaSsrICkgewoJCXZhciB0eXBlID0gRXhwci5vcmRlcltpXSwgbWF0Y2g7CgkJCgkJaWYgKCAobWF0Y2ggPSBFeHByLmxlZnRNYXRjaFsgdHlwZSBdLmV4ZWMoIGV4cHIgKSkgKSB7CgkJCXZhciBsZWZ0ID0gbWF0Y2hbMV07CgkJCW1hdGNoLnNwbGljZSgxLDEpOwoKCQkJaWYgKCBsZWZ0LnN1YnN0ciggbGVmdC5sZW5ndGggLSAxICkgIT09ICJcXCIgKSB7CgkJCQltYXRjaFsxXSA9IChtYXRjaFsxXSB8fCAiIikucmVwbGFjZSgvXFwvZywgIiIpOwoJCQkJc2V0ID0gRXhwci5maW5kWyB0eXBlIF0oIG1hdGNoLCBjb250ZXh0LCBpc1hNTCApOwoJCQkJaWYgKCBzZXQgIT0gbnVsbCApIHsKCQkJCQlleHByID0gZXhwci5yZXBsYWNlKCBFeHByLm1hdGNoWyB0eXBlIF0sICIiICk7CgkJCQkJYnJlYWs7CgkJCQl9CgkJCX0KCQl9Cgl9CgoJaWYgKCAhc2V0ICkgewoJCXNldCA9IGNvbnRleHQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoIioiKTsKCX0KCglyZXR1cm4ge3NldDogc2V0LCBleHByOiBleHByfTsKfTsKClNpenpsZS5maWx0ZXIgPSBmdW5jdGlvbihleHByLCBzZXQsIGlucGxhY2UsIG5vdCl7Cgl2YXIgb2xkID0gZXhwciwgcmVzdWx0ID0gW10sIGN1ckxvb3AgPSBzZXQsIG1hdGNoLCBhbnlGb3VuZCwKCQlpc1hNTEZpbHRlciA9IHNldCAmJiBzZXRbMF0gJiYgaXNYTUwoc2V0WzBdKTsKCgl3aGlsZSAoIGV4cHIgJiYgc2V0Lmxlbmd0aCApIHsKCQlmb3IgKCB2YXIgdHlwZSBpbiBFeHByLmZpbHRlciApIHsKCQkJaWYgKCAobWF0Y2ggPSBFeHByLmxlZnRNYXRjaFsgdHlwZSBdLmV4ZWMoIGV4cHIgKSkgIT0gbnVsbCAmJiBtYXRjaFsyXSApIHsKCQkJCXZhciBmaWx0ZXIgPSBFeHByLmZpbHRlclsgdHlwZSBdLCBmb3VuZCwgaXRlbSwgbGVmdCA9IG1hdGNoWzFdOwoJCQkJYW55Rm91bmQgPSBmYWxzZTsKCgkJCQltYXRjaC5zcGxpY2UoMSwxKTsKCgkJCQlpZiAoIGxlZnQuc3Vic3RyKCBsZWZ0Lmxlbmd0aCAtIDEgKSA9PT0gIlxcIiApIHsKCQkJCQljb250aW51ZTsKCQkJCX0KCgkJCQlpZiAoIGN1ckxvb3AgPT09IHJlc3VsdCApIHsKCQkJCQlyZXN1bHQgPSBbXTsKCQkJCX0KCgkJCQlpZiAoIEV4cHIucHJlRmlsdGVyWyB0eXBlIF0gKSB7CgkJCQkJbWF0Y2ggPSBFeHByLnByZUZpbHRlclsgdHlwZSBdKCBtYXRjaCwgY3VyTG9vcCwgaW5wbGFjZSwgcmVzdWx0LCBub3QsIGlzWE1MRmlsdGVyICk7CgoJCQkJCWlmICggIW1hdGNoICkgewoJCQkJCQlhbnlGb3VuZCA9IGZvdW5kID0gdHJ1ZTsKCQkJCQl9IGVsc2UgaWYgKCBtYXRjaCA9PT0gdHJ1ZSApIHsKCQkJCQkJY29udGludWU7CgkJCQkJfQoJCQkJfQoKCQkJCWlmICggbWF0Y2ggKSB7CgkJCQkJZm9yICggdmFyIGkgPSAwOyAoaXRlbSA9IGN1ckxvb3BbaV0pICE9IG51bGw7IGkrKyApIHsKCQkJCQkJaWYgKCBpdGVtICkgewoJCQkJCQkJZm91bmQgPSBmaWx0ZXIoIGl0ZW0sIG1hdGNoLCBpLCBjdXJMb29wICk7CgkJCQkJCQl2YXIgcGFzcyA9IG5vdCBeICEhZm91bmQ7CgoJCQkJCQkJaWYgKCBpbnBsYWNlICYmIGZvdW5kICE9IG51bGwgKSB7CgkJCQkJCQkJaWYgKCBwYXNzICkgewoJCQkJCQkJCQlhbnlGb3VuZCA9IHRydWU7CgkJCQkJCQkJfSBlbHNlIHsKCQkJCQkJCQkJY3VyTG9vcFtpXSA9IGZhbHNlOwoJCQkJCQkJCX0KCQkJCQkJCX0gZWxzZSBpZiAoIHBhc3MgKSB7CgkJCQkJCQkJcmVzdWx0LnB1c2goIGl0ZW0gKTsKCQkJCQkJCQlhbnlGb3VuZCA9IHRydWU7CgkJCQkJCQl9CgkJCQkJCX0KCQkJCQl9CgkJCQl9CgoJCQkJaWYgKCBmb3VuZCAhPT0gdW5kZWZpbmVkICkgewoJCQkJCWlmICggIWlucGxhY2UgKSB7CgkJCQkJCWN1ckxvb3AgPSByZXN1bHQ7CgkJCQkJfQoKCQkJCQlleHByID0gZXhwci5yZXBsYWNlKCBFeHByLm1hdGNoWyB0eXBlIF0sICIiICk7CgoJCQkJCWlmICggIWFueUZvdW5kICkgewoJCQkJCQlyZXR1cm4gW107CgkJCQkJfQoKCQkJCQlicmVhazsKCQkJCX0KCQkJfQoJCX0KCgkJLy8gSW1wcm9wZXIgZXhwcmVzc2lvbgoJCWlmICggZXhwciA9PT0gb2xkICkgewoJCQlpZiAoIGFueUZvdW5kID09IG51bGwgKSB7CgkJCQlTaXp6bGUuZXJyb3IoIGV4cHIgKTsKCQkJfSBlbHNlIHsKCQkJCWJyZWFrOwoJCQl9CgkJfQoKCQlvbGQgPSBleHByOwoJfQoKCXJldHVybiBjdXJMb29wOwp9OwoKU2l6emxlLmVycm9yID0gZnVuY3Rpb24oIG1zZyApIHsKCXRocm93ICJTeW50YXggZXJyb3IsIHVucmVjb2duaXplZCBleHByZXNzaW9uOiAiICsgbXNnOwp9OwoKdmFyIEV4cHIgPSBTaXp6bGUuc2VsZWN0b3JzID0gewoJb3JkZXI6IFsgIklEIiwgIk5BTUUiLCAiVEFHIiBdLAoJbWF0Y2g6IHsKCQlJRDogLyMoKD86W1x3XHUwMGMwLVx1RkZGRi1dfFxcLikrKS8sCgkJQ0xBU1M6IC9cLigoPzpbXHdcdTAwYzAtXHVGRkZGLV18XFwuKSspLywKCQlOQU1FOiAvXFtuYW1lPVsnIl0qKCg/Oltcd1x1MDBjMC1cdUZGRkYtXXxcXC4pKylbJyJdKlxdLywKCQlBVFRSOiAvXFtccyooKD86W1x3XHUwMGMwLVx1RkZGRi1dfFxcLikrKVxzKig/OihcUz89KVxzKihbJyJdKikoLio/KVwzfClccypcXS8sCgkJVEFHOiAvXigoPzpbXHdcdTAwYzAtXHVGRkZGXCotXXxcXC4pKykvLAoJCUNISUxEOiAvOihvbmx5fG50aHxsYXN0fGZpcnN0KS1jaGlsZCg/OlwoKGV2ZW58b2RkfFtcZG4rLV0qKVwpKT8vLAoJCVBPUzogLzoobnRofGVxfGd0fGx0fGZpcnN0fGxhc3R8ZXZlbnxvZGQpKD86XCgoXGQqKVwpKT8oPz1bXi1dfCQpLywKCQlQU0VVRE86IC86KCg/Oltcd1x1MDBjMC1cdUZGRkYtXXxcXC4pKykoPzpcKChbJyJdPykoKD86XChbXlwpXStcKXxbXlwoXCldKikrKVwyXCkpPy8KCX0sCglsZWZ0TWF0Y2g6IHt9LAoJYXR0ck1hcDogewoJCSJjbGFzcyI6ICJjbGFzc05hbWUiLAoJCSJmb3IiOiAiaHRtbEZvciIKCX0sCglhdHRySGFuZGxlOiB7CgkJaHJlZjogZnVuY3Rpb24oZWxlbSl7CgkJCXJldHVybiBlbGVtLmdldEF0dHJpYnV0ZSgiaHJlZiIpOwoJCX0KCX0sCglyZWxhdGl2ZTogewoJCSIrIjogZnVuY3Rpb24oY2hlY2tTZXQsIHBhcnQpewoJCQl2YXIgaXNQYXJ0U3RyID0gdHlwZW9mIHBhcnQgPT09ICJzdHJpbmciLAoJCQkJaXNUYWcgPSBpc1BhcnRTdHIgJiYgIS9cVy8udGVzdChwYXJ0KSwKCQkJCWlzUGFydFN0ck5vdFRhZyA9IGlzUGFydFN0ciAmJiAhaXNUYWc7CgoJCQlpZiAoIGlzVGFnICkgewoJCQkJcGFydCA9IHBhcnQudG9Mb3dlckNhc2UoKTsKCQkJfQoKCQkJZm9yICggdmFyIGkgPSAwLCBsID0gY2hlY2tTZXQubGVuZ3RoLCBlbGVtOyBpIDwgbDsgaSsrICkgewoJCQkJaWYgKCAoZWxlbSA9IGNoZWNrU2V0W2ldKSApIHsKCQkJCQl3aGlsZSAoIChlbGVtID0gZWxlbS5wcmV2aW91c1NpYmxpbmcpICYmIGVsZW0ubm9kZVR5cGUgIT09IDEgKSB7fQoKCQkJCQljaGVja1NldFtpXSA9IGlzUGFydFN0ck5vdFRhZyB8fCBlbGVtICYmIGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gcGFydCA/CgkJCQkJCWVsZW0gfHwgZmFsc2UgOgoJCQkJCQllbGVtID09PSBwYXJ0OwoJCQkJfQoJCQl9CgoJCQlpZiAoIGlzUGFydFN0ck5vdFRhZyApIHsKCQkJCVNpenpsZS5maWx0ZXIoIHBhcnQsIGNoZWNrU2V0LCB0cnVlICk7CgkJCX0KCQl9LAoJCSI+IjogZnVuY3Rpb24oY2hlY2tTZXQsIHBhcnQpewoJCQl2YXIgaXNQYXJ0U3RyID0gdHlwZW9mIHBhcnQgPT09ICJzdHJpbmciOwoKCQkJaWYgKCBpc1BhcnRTdHIgJiYgIS9cVy8udGVzdChwYXJ0KSApIHsKCQkJCXBhcnQgPSBwYXJ0LnRvTG93ZXJDYXNlKCk7CgoJCQkJZm9yICggdmFyIGkgPSAwLCBsID0gY2hlY2tTZXQubGVuZ3RoOyBpIDwgbDsgaSsrICkgewoJCQkJCXZhciBlbGVtID0gY2hlY2tTZXRbaV07CgkJCQkJaWYgKCBlbGVtICkgewoJCQkJCQl2YXIgcGFyZW50ID0gZWxlbS5wYXJlbnROb2RlOwoJCQkJCQljaGVja1NldFtpXSA9IHBhcmVudC5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpID09PSBwYXJ0ID8gcGFyZW50IDogZmFsc2U7CgkJCQkJfQoJCQkJfQoJCQl9IGVsc2UgewoJCQkJZm9yICggdmFyIGkgPSAwLCBsID0gY2hlY2tTZXQubGVuZ3RoOyBpIDwgbDsgaSsrICkgewoJCQkJCXZhciBlbGVtID0gY2hlY2tTZXRbaV07CgkJCQkJaWYgKCBlbGVtICkgewoJCQkJCQljaGVja1NldFtpXSA9IGlzUGFydFN0ciA/CgkJCQkJCQllbGVtLnBhcmVudE5vZGUgOgoJCQkJCQkJZWxlbS5wYXJlbnROb2RlID09PSBwYXJ0OwoJCQkJCX0KCQkJCX0KCgkJCQlpZiAoIGlzUGFydFN0ciApIHsKCQkJCQlTaXp6bGUuZmlsdGVyKCBwYXJ0LCBjaGVja1NldCwgdHJ1ZSApOwoJCQkJfQoJCQl9CgkJfSwKCQkiIjogZnVuY3Rpb24oY2hlY2tTZXQsIHBhcnQsIGlzWE1MKXsKCQkJdmFyIGRvbmVOYW1lID0gZG9uZSsrLCBjaGVja0ZuID0gZGlyQ2hlY2s7CgoJCQlpZiAoIHR5cGVvZiBwYXJ0ID09PSAic3RyaW5nIiAmJiAhL1xXLy50ZXN0KHBhcnQpICkgewoJCQkJdmFyIG5vZGVDaGVjayA9IHBhcnQgPSBwYXJ0LnRvTG93ZXJDYXNlKCk7CgkJCQljaGVja0ZuID0gZGlyTm9kZUNoZWNrOwoJCQl9CgoJCQljaGVja0ZuKCJwYXJlbnROb2RlIiwgcGFydCwgZG9uZU5hbWUsIGNoZWNrU2V0LCBub2RlQ2hlY2ssIGlzWE1MKTsKCQl9LAoJCSJ+IjogZnVuY3Rpb24oY2hlY2tTZXQsIHBhcnQsIGlzWE1MKXsKCQkJdmFyIGRvbmVOYW1lID0gZG9uZSsrLCBjaGVja0ZuID0gZGlyQ2hlY2s7CgoJCQlpZiAoIHR5cGVvZiBwYXJ0ID09PSAic3RyaW5nIiAmJiAhL1xXLy50ZXN0KHBhcnQpICkgewoJCQkJdmFyIG5vZGVDaGVjayA9IHBhcnQgPSBwYXJ0LnRvTG93ZXJDYXNlKCk7CgkJCQljaGVja0ZuID0gZGlyTm9kZUNoZWNrOwoJCQl9CgoJCQljaGVja0ZuKCJwcmV2aW91c1NpYmxpbmciLCBwYXJ0LCBkb25lTmFtZSwgY2hlY2tTZXQsIG5vZGVDaGVjaywgaXNYTUwpOwoJCX0KCX0sCglmaW5kOiB7CgkJSUQ6IGZ1bmN0aW9uKG1hdGNoLCBjb250ZXh0LCBpc1hNTCl7CgkJCWlmICggdHlwZW9mIGNvbnRleHQuZ2V0RWxlbWVudEJ5SWQgIT09ICJ1bmRlZmluZWQiICYmICFpc1hNTCApIHsKCQkJCXZhciBtID0gY29udGV4dC5nZXRFbGVtZW50QnlJZChtYXRjaFsxXSk7CgkJCQlyZXR1cm4gbSA/IFttXSA6IFtdOwoJCQl9CgkJfSwKCQlOQU1FOiBmdW5jdGlvbihtYXRjaCwgY29udGV4dCl7CgkJCWlmICggdHlwZW9mIGNvbnRleHQuZ2V0RWxlbWVudHNCeU5hbWUgIT09ICJ1bmRlZmluZWQiICkgewoJCQkJdmFyIHJldCA9IFtdLCByZXN1bHRzID0gY29udGV4dC5nZXRFbGVtZW50c0J5TmFtZShtYXRjaFsxXSk7CgoJCQkJZm9yICggdmFyIGkgPSAwLCBsID0gcmVzdWx0cy5sZW5ndGg7IGkgPCBsOyBpKysgKSB7CgkJCQkJaWYgKCByZXN1bHRzW2ldLmdldEF0dHJpYnV0ZSgibmFtZSIpID09PSBtYXRjaFsxXSApIHsKCQkJCQkJcmV0LnB1c2goIHJlc3VsdHNbaV0gKTsKCQkJCQl9CgkJCQl9CgoJCQkJcmV0dXJuIHJldC5sZW5ndGggPT09IDAgPyBudWxsIDogcmV0OwoJCQl9CgkJfSwKCQlUQUc6IGZ1bmN0aW9uKG1hdGNoLCBjb250ZXh0KXsKCQkJcmV0dXJuIGNvbnRleHQuZ2V0RWxlbWVudHNCeVRhZ05hbWUobWF0Y2hbMV0pOwoJCX0KCX0sCglwcmVGaWx0ZXI6IHsKCQlDTEFTUzogZnVuY3Rpb24obWF0Y2gsIGN1ckxvb3AsIGlucGxhY2UsIHJlc3VsdCwgbm90LCBpc1hNTCl7CgkJCW1hdGNoID0gIiAiICsgbWF0Y2hbMV0ucmVwbGFjZSgvXFwvZywgIiIpICsgIiAiOwoKCQkJaWYgKCBpc1hNTCApIHsKCQkJCXJldHVybiBtYXRjaDsKCQkJfQoKCQkJZm9yICggdmFyIGkgPSAwLCBlbGVtOyAoZWxlbSA9IGN1ckxvb3BbaV0pICE9IG51bGw7IGkrKyApIHsKCQkJCWlmICggZWxlbSApIHsKCQkJCQlpZiAoIG5vdCBeIChlbGVtLmNsYXNzTmFtZSAmJiAoIiAiICsgZWxlbS5jbGFzc05hbWUgKyAiICIpLnJlcGxhY2UoL1tcdFxuXS9nLCAiICIpLmluZGV4T2YobWF0Y2gpID49IDApICkgewoJCQkJCQlpZiAoICFpbnBsYWNlICkgewoJCQkJCQkJcmVzdWx0LnB1c2goIGVsZW0gKTsKCQkJCQkJfQoJCQkJCX0gZWxzZSBpZiAoIGlucGxhY2UgKSB7CgkJCQkJCWN1ckxvb3BbaV0gPSBmYWxzZTsKCQkJCQl9CgkJCQl9CgkJCX0KCgkJCXJldHVybiBmYWxzZTsKCQl9LAoJCUlEOiBmdW5jdGlvbihtYXRjaCl7CgkJCXJldHVybiBtYXRjaFsxXS5yZXBsYWNlKC9cXC9nLCAiIik7CgkJfSwKCQlUQUc6IGZ1bmN0aW9uKG1hdGNoLCBjdXJMb29wKXsKCQkJcmV0dXJuIG1hdGNoWzFdLnRvTG93ZXJDYXNlKCk7CgkJfSwKCQlDSElMRDogZnVuY3Rpb24obWF0Y2gpewoJCQlpZiAoIG1hdGNoWzFdID09PSAibnRoIiApIHsKCQkJCS8vIHBhcnNlIGVxdWF0aW9ucyBsaWtlICdldmVuJywgJ29kZCcsICc1JywgJzJuJywgJzNuKzInLCAnNG4tMScsICctbis2JwoJCQkJdmFyIHRlc3QgPSAvKC0/KShcZCopbigoPzpcK3wtKT9cZCopLy5leGVjKAoJCQkJCW1hdGNoWzJdID09PSAiZXZlbiIgJiYgIjJuIiB8fCBtYXRjaFsyXSA9PT0gIm9kZCIgJiYgIjJuKzEiIHx8CgkJCQkJIS9cRC8udGVzdCggbWF0Y2hbMl0gKSAmJiAiMG4rIiArIG1hdGNoWzJdIHx8IG1hdGNoWzJdKTsKCgkJCQkvLyBjYWxjdWxhdGUgdGhlIG51bWJlcnMgKGZpcnN0KW4rKGxhc3QpIGluY2x1ZGluZyBpZiB0aGV5IGFyZSBuZWdhdGl2ZQoJCQkJbWF0Y2hbMl0gPSAodGVzdFsxXSArICh0ZXN0WzJdIHx8IDEpKSAtIDA7CgkJCQltYXRjaFszXSA9IHRlc3RbM10gLSAwOwoJCQl9CgoJCQkvLyBUT0RPOiBNb3ZlIHRvIG5vcm1hbCBjYWNoaW5nIHN5c3RlbQoJCQltYXRjaFswXSA9IGRvbmUrKzsKCgkJCXJldHVybiBtYXRjaDsKCQl9LAoJCUFUVFI6IGZ1bmN0aW9uKG1hdGNoLCBjdXJMb29wLCBpbnBsYWNlLCByZXN1bHQsIG5vdCwgaXNYTUwpewoJCQl2YXIgbmFtZSA9IG1hdGNoWzFdLnJlcGxhY2UoL1xcL2csICIiKTsKCQkJCgkJCWlmICggIWlzWE1MICYmIEV4cHIuYXR0ck1hcFtuYW1lXSApIHsKCQkJCW1hdGNoWzFdID0gRXhwci5hdHRyTWFwW25hbWVdOwoJCQl9CgoJCQlpZiAoIG1hdGNoWzJdID09PSAifj0iICkgewoJCQkJbWF0Y2hbNF0gPSAiICIgKyBtYXRjaFs0XSArICIgIjsKCQkJfQoKCQkJcmV0dXJuIG1hdGNoOwoJCX0sCgkJUFNFVURPOiBmdW5jdGlvbihtYXRjaCwgY3VyTG9vcCwgaW5wbGFjZSwgcmVzdWx0LCBub3QpewoJCQlpZiAoIG1hdGNoWzFdID09PSAibm90IiApIHsKCQkJCS8vIElmIHdlJ3JlIGRlYWxpbmcgd2l0aCBhIGNvbXBsZXggZXhwcmVzc2lvbiwgb3IgYSBzaW1wbGUgb25lCgkJCQlpZiAoICggY2h1bmtlci5leGVjKG1hdGNoWzNdKSB8fCAiIiApLmxlbmd0aCA+IDEgfHwgL15cdy8udGVzdChtYXRjaFszXSkgKSB7CgkJCQkJbWF0Y2hbM10gPSBTaXp6bGUobWF0Y2hbM10sIG51bGwsIG51bGwsIGN1ckxvb3ApOwoJCQkJfSBlbHNlIHsKCQkJCQl2YXIgcmV0ID0gU2l6emxlLmZpbHRlcihtYXRjaFszXSwgY3VyTG9vcCwgaW5wbGFjZSwgdHJ1ZSBeIG5vdCk7CgkJCQkJaWYgKCAhaW5wbGFjZSApIHsKCQkJCQkJcmVzdWx0LnB1c2guYXBwbHkoIHJlc3VsdCwgcmV0ICk7CgkJCQkJfQoJCQkJCXJldHVybiBmYWxzZTsKCQkJCX0KCQkJfSBlbHNlIGlmICggRXhwci5tYXRjaC5QT1MudGVzdCggbWF0Y2hbMF0gKSB8fCBFeHByLm1hdGNoLkNISUxELnRlc3QoIG1hdGNoWzBdICkgKSB7CgkJCQlyZXR1cm4gdHJ1ZTsKCQkJfQoJCQkKCQkJcmV0dXJuIG1hdGNoOwoJCX0sCgkJUE9TOiBmdW5jdGlvbihtYXRjaCl7CgkJCW1hdGNoLnVuc2hpZnQoIHRydWUgKTsKCQkJcmV0dXJuIG1hdGNoOwoJCX0KCX0sCglmaWx0ZXJzOiB7CgkJZW5hYmxlZDogZnVuY3Rpb24oZWxlbSl7CgkJCXJldHVybiBlbGVtLmRpc2FibGVkID09PSBmYWxzZSAmJiBlbGVtLnR5cGUgIT09ICJoaWRkZW4iOwoJCX0sCgkJZGlzYWJsZWQ6IGZ1bmN0aW9uKGVsZW0pewoJCQlyZXR1cm4gZWxlbS5kaXNhYmxlZCA9PT0gdHJ1ZTsKCQl9LAoJCWNoZWNrZWQ6IGZ1bmN0aW9uKGVsZW0pewoJCQlyZXR1cm4gZWxlbS5jaGVja2VkID09PSB0cnVlOwoJCX0sCgkJc2VsZWN0ZWQ6IGZ1bmN0aW9uKGVsZW0pewoJCQkvLyBBY2Nlc3NpbmcgdGhpcyBwcm9wZXJ0eSBtYWtlcyBzZWxlY3RlZC1ieS1kZWZhdWx0CgkJCS8vIG9wdGlvbnMgaW4gU2FmYXJpIHdvcmsgcHJvcGVybHkKCQkJZWxlbS5wYXJlbnROb2RlLnNlbGVjdGVkSW5kZXg7CgkJCXJldHVybiBlbGVtLnNlbGVjdGVkID09PSB0cnVlOwoJCX0sCgkJcGFyZW50OiBmdW5jdGlvbihlbGVtKXsKCQkJcmV0dXJuICEhZWxlbS5maXJzdENoaWxkOwoJCX0sCgkJZW1wdHk6IGZ1bmN0aW9uKGVsZW0pewoJCQlyZXR1cm4gIWVsZW0uZmlyc3RDaGlsZDsKCQl9LAoJCWhhczogZnVuY3Rpb24oZWxlbSwgaSwgbWF0Y2gpewoJCQlyZXR1cm4gISFTaXp6bGUoIG1hdGNoWzNdLCBlbGVtICkubGVuZ3RoOwoJCX0sCgkJaGVhZGVyOiBmdW5jdGlvbihlbGVtKXsKCQkJcmV0dXJuIC9oXGQvaS50ZXN0KCBlbGVtLm5vZGVOYW1lICk7CgkJfSwKCQl0ZXh0OiBmdW5jdGlvbihlbGVtKXsKCQkJcmV0dXJuICJ0ZXh0IiA9PT0gZWxlbS50eXBlOwoJCX0sCgkJcmFkaW86IGZ1bmN0aW9uKGVsZW0pewoJCQlyZXR1cm4gInJhZGlvIiA9PT0gZWxlbS50eXBlOwoJCX0sCgkJY2hlY2tib3g6IGZ1bmN0aW9uKGVsZW0pewoJCQlyZXR1cm4gImNoZWNrYm94IiA9PT0gZWxlbS50eXBlOwoJCX0sCgkJZmlsZTogZnVuY3Rpb24oZWxlbSl7CgkJCXJldHVybiAiZmlsZSIgPT09IGVsZW0udHlwZTsKCQl9LAoJCXBhc3N3b3JkOiBmdW5jdGlvbihlbGVtKXsKCQkJcmV0dXJuICJwYXNzd29yZCIgPT09IGVsZW0udHlwZTsKCQl9LAoJCXN1Ym1pdDogZnVuY3Rpb24oZWxlbSl7CgkJCXJldHVybiAic3VibWl0IiA9PT0gZWxlbS50eXBlOwoJCX0sCgkJaW1hZ2U6IGZ1bmN0aW9uKGVsZW0pewoJCQlyZXR1cm4gImltYWdlIiA9PT0gZWxlbS50eXBlOwoJCX0sCgkJcmVzZXQ6IGZ1bmN0aW9uKGVsZW0pewoJCQlyZXR1cm4gInJlc2V0IiA9PT0gZWxlbS50eXBlOwoJCX0sCgkJYnV0dG9uOiBmdW5jdGlvbihlbGVtKXsKCQkJcmV0dXJuICJidXR0b24iID09PSBlbGVtLnR5cGUgfHwgZWxlbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpID09PSAiYnV0dG9uIjsKCQl9LAoJCWlucHV0OiBmdW5jdGlvbihlbGVtKXsKCQkJcmV0dXJuIC9pbnB1dHxzZWxlY3R8dGV4dGFyZWF8YnV0dG9uL2kudGVzdChlbGVtLm5vZGVOYW1lKTsKCQl9Cgl9LAoJc2V0RmlsdGVyczogewoJCWZpcnN0OiBmdW5jdGlvbihlbGVtLCBpKXsKCQkJcmV0dXJuIGkgPT09IDA7CgkJfSwKCQlsYXN0OiBmdW5jdGlvbihlbGVtLCBpLCBtYXRjaCwgYXJyYXkpewoJCQlyZXR1cm4gaSA9PT0gYXJyYXkubGVuZ3RoIC0gMTsKCQl9LAoJCWV2ZW46IGZ1bmN0aW9uKGVsZW0sIGkpewoJCQlyZXR1cm4gaSAlIDIgPT09IDA7CgkJfSwKCQlvZGQ6IGZ1bmN0aW9uKGVsZW0sIGkpewoJCQlyZXR1cm4gaSAlIDIgPT09IDE7CgkJfSwKCQlsdDogZnVuY3Rpb24oZWxlbSwgaSwgbWF0Y2gpewoJCQlyZXR1cm4gaSA8IG1hdGNoWzNdIC0gMDsKCQl9LAoJCWd0OiBmdW5jdGlvbihlbGVtLCBpLCBtYXRjaCl7CgkJCXJldHVybiBpID4gbWF0Y2hbM10gLSAwOwoJCX0sCgkJbnRoOiBmdW5jdGlvbihlbGVtLCBpLCBtYXRjaCl7CgkJCXJldHVybiBtYXRjaFszXSAtIDAgPT09IGk7CgkJfSwKCQllcTogZnVuY3Rpb24oZWxlbSwgaSwgbWF0Y2gpewoJCQlyZXR1cm4gbWF0Y2hbM10gLSAwID09PSBpOwoJCX0KCX0sCglmaWx0ZXI6IHsKCQlQU0VVRE86IGZ1bmN0aW9uKGVsZW0sIG1hdGNoLCBpLCBhcnJheSl7CgkJCXZhciBuYW1lID0gbWF0Y2hbMV0sIGZpbHRlciA9IEV4cHIuZmlsdGVyc1sgbmFtZSBdOwoKCQkJaWYgKCBmaWx0ZXIgKSB7CgkJCQlyZXR1cm4gZmlsdGVyKCBlbGVtLCBpLCBtYXRjaCwgYXJyYXkgKTsKCQkJfSBlbHNlIGlmICggbmFtZSA9PT0gImNvbnRhaW5zIiApIHsKCQkJCXJldHVybiAoZWxlbS50ZXh0Q29udGVudCB8fCBlbGVtLmlubmVyVGV4dCB8fCBnZXRUZXh0KFsgZWxlbSBdKSB8fCAiIikuaW5kZXhPZihtYXRjaFszXSkgPj0gMDsKCQkJfSBlbHNlIGlmICggbmFtZSA9PT0gIm5vdCIgKSB7CgkJCQl2YXIgbm90ID0gbWF0Y2hbM107CgoJCQkJZm9yICggdmFyIGkgPSAwLCBsID0gbm90Lmxlbmd0aDsgaSA8IGw7IGkrKyApIHsKCQkJCQlpZiAoIG5vdFtpXSA9PT0gZWxlbSApIHsKCQkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJCX0KCQkJCX0KCgkJCQlyZXR1cm4gdHJ1ZTsKCQkJfSBlbHNlIHsKCQkJCVNpenpsZS5lcnJvciggIlN5bnRheCBlcnJvciwgdW5yZWNvZ25pemVkIGV4cHJlc3Npb246ICIgKyBuYW1lICk7CgkJCX0KCQl9LAoJCUNISUxEOiBmdW5jdGlvbihlbGVtLCBtYXRjaCl7CgkJCXZhciB0eXBlID0gbWF0Y2hbMV0sIG5vZGUgPSBlbGVtOwoJCQlzd2l0Y2ggKHR5cGUpIHsKCQkJCWNhc2UgJ29ubHknOgoJCQkJY2FzZSAnZmlyc3QnOgoJCQkJCXdoaWxlICggKG5vZGUgPSBub2RlLnByZXZpb3VzU2libGluZykgKQkgewoJCQkJCQlpZiAoIG5vZGUubm9kZVR5cGUgPT09IDEgKSB7IAoJCQkJCQkJcmV0dXJuIGZhbHNlOyAKCQkJCQkJfQoJCQkJCX0KCQkJCQlpZiAoIHR5cGUgPT09ICJmaXJzdCIgKSB7IAoJCQkJCQlyZXR1cm4gdHJ1ZTsgCgkJCQkJfQoJCQkJCW5vZGUgPSBlbGVtOwoJCQkJY2FzZSAnbGFzdCc6CgkJCQkJd2hpbGUgKCAobm9kZSA9IG5vZGUubmV4dFNpYmxpbmcpICkJIHsKCQkJCQkJaWYgKCBub2RlLm5vZGVUeXBlID09PSAxICkgeyAKCQkJCQkJCXJldHVybiBmYWxzZTsgCgkJCQkJCX0KCQkJCQl9CgkJCQkJcmV0dXJuIHRydWU7CgkJCQljYXNlICdudGgnOgoJCQkJCXZhciBmaXJzdCA9IG1hdGNoWzJdLCBsYXN0ID0gbWF0Y2hbM107CgoJCQkJCWlmICggZmlyc3QgPT09IDEgJiYgbGFzdCA9PT0gMCApIHsKCQkJCQkJcmV0dXJuIHRydWU7CgkJCQkJfQoJCQkJCQoJCQkJCXZhciBkb25lTmFtZSA9IG1hdGNoWzBdLAoJCQkJCQlwYXJlbnQgPSBlbGVtLnBhcmVudE5vZGU7CgkKCQkJCQlpZiAoIHBhcmVudCAmJiAocGFyZW50LnNpemNhY2hlICE9PSBkb25lTmFtZSB8fCAhZWxlbS5ub2RlSW5kZXgpICkgewoJCQkJCQl2YXIgY291bnQgPSAwOwoJCQkJCQlmb3IgKCBub2RlID0gcGFyZW50LmZpcnN0Q2hpbGQ7IG5vZGU7IG5vZGUgPSBub2RlLm5leHRTaWJsaW5nICkgewoJCQkJCQkJaWYgKCBub2RlLm5vZGVUeXBlID09PSAxICkgewoJCQkJCQkJCW5vZGUubm9kZUluZGV4ID0gKytjb3VudDsKCQkJCQkJCX0KCQkJCQkJfSAKCQkJCQkJcGFyZW50LnNpemNhY2hlID0gZG9uZU5hbWU7CgkJCQkJfQoJCQkJCQoJCQkJCXZhciBkaWZmID0gZWxlbS5ub2RlSW5kZXggLSBsYXN0OwoJCQkJCWlmICggZmlyc3QgPT09IDAgKSB7CgkJCQkJCXJldHVybiBkaWZmID09PSAwOwoJCQkJCX0gZWxzZSB7CgkJCQkJCXJldHVybiAoIGRpZmYgJSBmaXJzdCA9PT0gMCAmJiBkaWZmIC8gZmlyc3QgPj0gMCApOwoJCQkJCX0KCQkJfQoJCX0sCgkJSUQ6IGZ1bmN0aW9uKGVsZW0sIG1hdGNoKXsKCQkJcmV0dXJuIGVsZW0ubm9kZVR5cGUgPT09IDEgJiYgZWxlbS5nZXRBdHRyaWJ1dGUoImlkIikgPT09IG1hdGNoOwoJCX0sCgkJVEFHOiBmdW5jdGlvbihlbGVtLCBtYXRjaCl7CgkJCXJldHVybiAobWF0Y2ggPT09ICIqIiAmJiBlbGVtLm5vZGVUeXBlID09PSAxKSB8fCBlbGVtLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09IG1hdGNoOwoJCX0sCgkJQ0xBU1M6IGZ1bmN0aW9uKGVsZW0sIG1hdGNoKXsKCQkJcmV0dXJuICgiICIgKyAoZWxlbS5jbGFzc05hbWUgfHwgZWxlbS5nZXRBdHRyaWJ1dGUoImNsYXNzIikpICsgIiAiKQoJCQkJLmluZGV4T2YoIG1hdGNoICkgPiAtMTsKCQl9LAoJCUFUVFI6IGZ1bmN0aW9uKGVsZW0sIG1hdGNoKXsKCQkJdmFyIG5hbWUgPSBtYXRjaFsxXSwKCQkJCXJlc3VsdCA9IEV4cHIuYXR0ckhhbmRsZVsgbmFtZSBdID8KCQkJCQlFeHByLmF0dHJIYW5kbGVbIG5hbWUgXSggZWxlbSApIDoKCQkJCQllbGVtWyBuYW1lIF0gIT0gbnVsbCA/CgkJCQkJCWVsZW1bIG5hbWUgXSA6CgkJCQkJCWVsZW0uZ2V0QXR0cmlidXRlKCBuYW1lICksCgkJCQl2YWx1ZSA9IHJlc3VsdCArICIiLAoJCQkJdHlwZSA9IG1hdGNoWzJdLAoJCQkJY2hlY2sgPSBtYXRjaFs0XTsKCgkJCXJldHVybiByZXN1bHQgPT0gbnVsbCA/CgkJCQl0eXBlID09PSAiIT0iIDoKCQkJCXR5cGUgPT09ICI9IiA/CgkJCQl2YWx1ZSA9PT0gY2hlY2sgOgoJCQkJdHlwZSA9PT0gIio9IiA/CgkJCQl2YWx1ZS5pbmRleE9mKGNoZWNrKSA+PSAwIDoKCQkJCXR5cGUgPT09ICJ+PSIgPwoJCQkJKCIgIiArIHZhbHVlICsgIiAiKS5pbmRleE9mKGNoZWNrKSA+PSAwIDoKCQkJCSFjaGVjayA/CgkJCQl2YWx1ZSAmJiByZXN1bHQgIT09IGZhbHNlIDoKCQkJCXR5cGUgPT09ICIhPSIgPwoJCQkJdmFsdWUgIT09IGNoZWNrIDoKCQkJCXR5cGUgPT09ICJePSIgPwoJCQkJdmFsdWUuaW5kZXhPZihjaGVjaykgPT09IDAgOgoJCQkJdHlwZSA9PT0gIiQ9IiA/CgkJCQl2YWx1ZS5zdWJzdHIodmFsdWUubGVuZ3RoIC0gY2hlY2subGVuZ3RoKSA9PT0gY2hlY2sgOgoJCQkJdHlwZSA9PT0gInw9IiA/CgkJCQl2YWx1ZSA9PT0gY2hlY2sgfHwgdmFsdWUuc3Vic3RyKDAsIGNoZWNrLmxlbmd0aCArIDEpID09PSBjaGVjayArICItIiA6CgkJCQlmYWxzZTsKCQl9LAoJCVBPUzogZnVuY3Rpb24oZWxlbSwgbWF0Y2gsIGksIGFycmF5KXsKCQkJdmFyIG5hbWUgPSBtYXRjaFsyXSwgZmlsdGVyID0gRXhwci5zZXRGaWx0ZXJzWyBuYW1lIF07CgoJCQlpZiAoIGZpbHRlciApIHsKCQkJCXJldHVybiBmaWx0ZXIoIGVsZW0sIGksIG1hdGNoLCBhcnJheSApOwoJCQl9CgkJfQoJfQp9OwoKdmFyIG9yaWdQT1MgPSBFeHByLm1hdGNoLlBPUzsKCmZvciAoIHZhciB0eXBlIGluIEV4cHIubWF0Y2ggKSB7CglFeHByLm1hdGNoWyB0eXBlIF0gPSBuZXcgUmVnRXhwKCBFeHByLm1hdGNoWyB0eXBlIF0uc291cmNlICsgLyg/IVteXFtdKlxdKSg/IVteXChdKlwpKS8uc291cmNlICk7CglFeHByLmxlZnRNYXRjaFsgdHlwZSBdID0gbmV3IFJlZ0V4cCggLyheKD86LnxccnxcbikqPykvLnNvdXJjZSArIEV4cHIubWF0Y2hbIHR5cGUgXS5zb3VyY2UucmVwbGFjZSgvXFwoXGQrKS9nLCBmdW5jdGlvbihhbGwsIG51bSl7CgkJcmV0dXJuICJcXCIgKyAobnVtIC0gMCArIDEpOwoJfSkpOwp9Cgp2YXIgbWFrZUFycmF5ID0gZnVuY3Rpb24oYXJyYXksIHJlc3VsdHMpIHsKCWFycmF5ID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoIGFycmF5LCAwICk7CgoJaWYgKCByZXN1bHRzICkgewoJCXJlc3VsdHMucHVzaC5hcHBseSggcmVzdWx0cywgYXJyYXkgKTsKCQlyZXR1cm4gcmVzdWx0czsKCX0KCQoJcmV0dXJuIGFycmF5Owp9OwoKLy8gUGVyZm9ybSBhIHNpbXBsZSBjaGVjayB0byBkZXRlcm1pbmUgaWYgdGhlIGJyb3dzZXIgaXMgY2FwYWJsZSBvZgovLyBjb252ZXJ0aW5nIGEgTm9kZUxpc3QgdG8gYW4gYXJyYXkgdXNpbmcgYnVpbHRpbiBtZXRob2RzLgovLyBBbHNvIHZlcmlmaWVzIHRoYXQgdGhlIHJldHVybmVkIGFycmF5IGhvbGRzIERPTSBub2RlcwovLyAod2hpY2ggaXMgbm90IHRoZSBjYXNlIGluIHRoZSBCbGFja2JlcnJ5IGJyb3dzZXIpCnRyeSB7CglBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbCggZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmNoaWxkTm9kZXMsIDAgKVswXS5ub2RlVHlwZTsKCi8vIFByb3ZpZGUgYSBmYWxsYmFjayBtZXRob2QgaWYgaXQgZG9lcyBub3Qgd29yawp9IGNhdGNoKGUpewoJbWFrZUFycmF5ID0gZnVuY3Rpb24oYXJyYXksIHJlc3VsdHMpIHsKCQl2YXIgcmV0ID0gcmVzdWx0cyB8fCBbXTsKCgkJaWYgKCB0b1N0cmluZy5jYWxsKGFycmF5KSA9PT0gIltvYmplY3QgQXJyYXldIiApIHsKCQkJQXJyYXkucHJvdG90eXBlLnB1c2guYXBwbHkoIHJldCwgYXJyYXkgKTsKCQl9IGVsc2UgewoJCQlpZiAoIHR5cGVvZiBhcnJheS5sZW5ndGggPT09ICJudW1iZXIiICkgewoJCQkJZm9yICggdmFyIGkgPSAwLCBsID0gYXJyYXkubGVuZ3RoOyBpIDwgbDsgaSsrICkgewoJCQkJCXJldC5wdXNoKCBhcnJheVtpXSApOwoJCQkJfQoJCQl9IGVsc2UgewoJCQkJZm9yICggdmFyIGkgPSAwOyBhcnJheVtpXTsgaSsrICkgewoJCQkJCXJldC5wdXNoKCBhcnJheVtpXSApOwoJCQkJfQoJCQl9CgkJfQoKCQlyZXR1cm4gcmV0OwoJfTsKfQoKdmFyIHNvcnRPcmRlcjsKCmlmICggZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uICkgewoJc29ydE9yZGVyID0gZnVuY3Rpb24oIGEsIGIgKSB7CgkJaWYgKCAhYS5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbiB8fCAhYi5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbiApIHsKCQkJaWYgKCBhID09IGIgKSB7CgkJCQloYXNEdXBsaWNhdGUgPSB0cnVlOwoJCQl9CgkJCXJldHVybiBhLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uID8gLTEgOiAxOwoJCX0KCgkJdmFyIHJldCA9IGEuY29tcGFyZURvY3VtZW50UG9zaXRpb24oYikgJiA0ID8gLTEgOiBhID09PSBiID8gMCA6IDE7CgkJaWYgKCByZXQgPT09IDAgKSB7CgkJCWhhc0R1cGxpY2F0ZSA9IHRydWU7CgkJfQoJCXJldHVybiByZXQ7Cgl9Owp9IGVsc2UgaWYgKCAic291cmNlSW5kZXgiIGluIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudCApIHsKCXNvcnRPcmRlciA9IGZ1bmN0aW9uKCBhLCBiICkgewoJCWlmICggIWEuc291cmNlSW5kZXggfHwgIWIuc291cmNlSW5kZXggKSB7CgkJCWlmICggYSA9PSBiICkgewoJCQkJaGFzRHVwbGljYXRlID0gdHJ1ZTsKCQkJfQoJCQlyZXR1cm4gYS5zb3VyY2VJbmRleCA/IC0xIDogMTsKCQl9CgoJCXZhciByZXQgPSBhLnNvdXJjZUluZGV4IC0gYi5zb3VyY2VJbmRleDsKCQlpZiAoIHJldCA9PT0gMCApIHsKCQkJaGFzRHVwbGljYXRlID0gdHJ1ZTsKCQl9CgkJcmV0dXJuIHJldDsKCX07Cn0gZWxzZSBpZiAoIGRvY3VtZW50LmNyZWF0ZVJhbmdlICkgewoJc29ydE9yZGVyID0gZnVuY3Rpb24oIGEsIGIgKSB7CgkJaWYgKCAhYS5vd25lckRvY3VtZW50IHx8ICFiLm93bmVyRG9jdW1lbnQgKSB7CgkJCWlmICggYSA9PSBiICkgewoJCQkJaGFzRHVwbGljYXRlID0gdHJ1ZTsKCQkJfQoJCQlyZXR1cm4gYS5vd25lckRvY3VtZW50ID8gLTEgOiAxOwoJCX0KCgkJdmFyIGFSYW5nZSA9IGEub3duZXJEb2N1bWVudC5jcmVhdGVSYW5nZSgpLCBiUmFuZ2UgPSBiLm93bmVyRG9jdW1lbnQuY3JlYXRlUmFuZ2UoKTsKCQlhUmFuZ2Uuc2V0U3RhcnQoYSwgMCk7CgkJYVJhbmdlLnNldEVuZChhLCAwKTsKCQliUmFuZ2Uuc2V0U3RhcnQoYiwgMCk7CgkJYlJhbmdlLnNldEVuZChiLCAwKTsKCQl2YXIgcmV0ID0gYVJhbmdlLmNvbXBhcmVCb3VuZGFyeVBvaW50cyhSYW5nZS5TVEFSVF9UT19FTkQsIGJSYW5nZSk7CgkJaWYgKCByZXQgPT09IDAgKSB7CgkJCWhhc0R1cGxpY2F0ZSA9IHRydWU7CgkJfQoJCXJldHVybiByZXQ7Cgl9Owp9CgovLyBVdGlsaXR5IGZ1bmN0aW9uIGZvciByZXRyZWl2aW5nIHRoZSB0ZXh0IHZhbHVlIG9mIGFuIGFycmF5IG9mIERPTSBub2RlcwpmdW5jdGlvbiBnZXRUZXh0KCBlbGVtcyApIHsKCXZhciByZXQgPSAiIiwgZWxlbTsKCglmb3IgKCB2YXIgaSA9IDA7IGVsZW1zW2ldOyBpKysgKSB7CgkJZWxlbSA9IGVsZW1zW2ldOwoKCQkvLyBHZXQgdGhlIHRleHQgZnJvbSB0ZXh0IG5vZGVzIGFuZCBDREFUQSBub2RlcwoJCWlmICggZWxlbS5ub2RlVHlwZSA9PT0gMyB8fCBlbGVtLm5vZGVUeXBlID09PSA0ICkgewoJCQlyZXQgKz0gZWxlbS5ub2RlVmFsdWU7CgoJCS8vIFRyYXZlcnNlIGV2ZXJ5dGhpbmcgZWxzZSwgZXhjZXB0IGNvbW1lbnQgbm9kZXMKCQl9IGVsc2UgaWYgKCBlbGVtLm5vZGVUeXBlICE9PSA4ICkgewoJCQlyZXQgKz0gZ2V0VGV4dCggZWxlbS5jaGlsZE5vZGVzICk7CgkJfQoJfQoKCXJldHVybiByZXQ7Cn0KCi8vIENoZWNrIHRvIHNlZSBpZiB0aGUgYnJvd3NlciByZXR1cm5zIGVsZW1lbnRzIGJ5IG5hbWUgd2hlbgovLyBxdWVyeWluZyBieSBnZXRFbGVtZW50QnlJZCAoYW5kIHByb3ZpZGUgYSB3b3JrYXJvdW5kKQooZnVuY3Rpb24oKXsKCS8vIFdlJ3JlIGdvaW5nIHRvIGluamVjdCBhIGZha2UgaW5wdXQgZWxlbWVudCB3aXRoIGEgc3BlY2lmaWVkIG5hbWUKCXZhciBmb3JtID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2IiksCgkJaWQgPSAic2NyaXB0IiArIChuZXcgRGF0ZSkuZ2V0VGltZSgpOwoJZm9ybS5pbm5lckhUTUwgPSAiPGEgbmFtZT0nIiArIGlkICsgIicvPiI7CgoJLy8gSW5qZWN0IGl0IGludG8gdGhlIHJvb3QgZWxlbWVudCwgY2hlY2sgaXRzIHN0YXR1cywgYW5kIHJlbW92ZSBpdCBxdWlja2x5Cgl2YXIgcm9vdCA9IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudDsKCXJvb3QuaW5zZXJ0QmVmb3JlKCBmb3JtLCByb290LmZpcnN0Q2hpbGQgKTsKCgkvLyBUaGUgd29ya2Fyb3VuZCBoYXMgdG8gZG8gYWRkaXRpb25hbCBjaGVja3MgYWZ0ZXIgYSBnZXRFbGVtZW50QnlJZAoJLy8gV2hpY2ggc2xvd3MgdGhpbmdzIGRvd24gZm9yIG90aGVyIGJyb3dzZXJzIChoZW5jZSB0aGUgYnJhbmNoaW5nKQoJaWYgKCBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCggaWQgKSApIHsKCQlFeHByLmZpbmQuSUQgPSBmdW5jdGlvbihtYXRjaCwgY29udGV4dCwgaXNYTUwpewoJCQlpZiAoIHR5cGVvZiBjb250ZXh0LmdldEVsZW1lbnRCeUlkICE9PSAidW5kZWZpbmVkIiAmJiAhaXNYTUwgKSB7CgkJCQl2YXIgbSA9IGNvbnRleHQuZ2V0RWxlbWVudEJ5SWQobWF0Y2hbMV0pOwoJCQkJcmV0dXJuIG0gPyBtLmlkID09PSBtYXRjaFsxXSB8fCB0eXBlb2YgbS5nZXRBdHRyaWJ1dGVOb2RlICE9PSAidW5kZWZpbmVkIiAmJiBtLmdldEF0dHJpYnV0ZU5vZGUoImlkIikubm9kZVZhbHVlID09PSBtYXRjaFsxXSA/IFttXSA6IHVuZGVmaW5lZCA6IFtdOwoJCQl9CgkJfTsKCgkJRXhwci5maWx0ZXIuSUQgPSBmdW5jdGlvbihlbGVtLCBtYXRjaCl7CgkJCXZhciBub2RlID0gdHlwZW9mIGVsZW0uZ2V0QXR0cmlidXRlTm9kZSAhPT0gInVuZGVmaW5lZCIgJiYgZWxlbS5nZXRBdHRyaWJ1dGVOb2RlKCJpZCIpOwoJCQlyZXR1cm4gZWxlbS5ub2RlVHlwZSA9PT0gMSAmJiBub2RlICYmIG5vZGUubm9kZVZhbHVlID09PSBtYXRjaDsKCQl9OwoJfQoKCXJvb3QucmVtb3ZlQ2hpbGQoIGZvcm0gKTsKCXJvb3QgPSBmb3JtID0gbnVsbDsgLy8gcmVsZWFzZSBtZW1vcnkgaW4gSUUKfSkoKTsKCihmdW5jdGlvbigpewoJLy8gQ2hlY2sgdG8gc2VlIGlmIHRoZSBicm93c2VyIHJldHVybnMgb25seSBlbGVtZW50cwoJLy8gd2hlbiBkb2luZyBnZXRFbGVtZW50c0J5VGFnTmFtZSgiKiIpCgoJLy8gQ3JlYXRlIGEgZmFrZSBlbGVtZW50Cgl2YXIgZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CglkaXYuYXBwZW5kQ2hpbGQoIGRvY3VtZW50LmNyZWF0ZUNvbW1lbnQoIiIpICk7CgoJLy8gTWFrZSBzdXJlIG5vIGNvbW1lbnRzIGFyZSBmb3VuZAoJaWYgKCBkaXYuZ2V0RWxlbWVudHNCeVRhZ05hbWUoIioiKS5sZW5ndGggPiAwICkgewoJCUV4cHIuZmluZC5UQUcgPSBmdW5jdGlvbihtYXRjaCwgY29udGV4dCl7CgkJCXZhciByZXN1bHRzID0gY29udGV4dC5nZXRFbGVtZW50c0J5VGFnTmFtZShtYXRjaFsxXSk7CgoJCQkvLyBGaWx0ZXIgb3V0IHBvc3NpYmxlIGNvbW1lbnRzCgkJCWlmICggbWF0Y2hbMV0gPT09ICIqIiApIHsKCQkJCXZhciB0bXAgPSBbXTsKCgkJCQlmb3IgKCB2YXIgaSA9IDA7IHJlc3VsdHNbaV07IGkrKyApIHsKCQkJCQlpZiAoIHJlc3VsdHNbaV0ubm9kZVR5cGUgPT09IDEgKSB7CgkJCQkJCXRtcC5wdXNoKCByZXN1bHRzW2ldICk7CgkJCQkJfQoJCQkJfQoKCQkJCXJlc3VsdHMgPSB0bXA7CgkJCX0KCgkJCXJldHVybiByZXN1bHRzOwoJCX07Cgl9CgoJLy8gQ2hlY2sgdG8gc2VlIGlmIGFuIGF0dHJpYnV0ZSByZXR1cm5zIG5vcm1hbGl6ZWQgaHJlZiBhdHRyaWJ1dGVzCglkaXYuaW5uZXJIVE1MID0gIjxhIGhyZWY9JyMnPjwvYT4iOwoJaWYgKCBkaXYuZmlyc3RDaGlsZCAmJiB0eXBlb2YgZGl2LmZpcnN0Q2hpbGQuZ2V0QXR0cmlidXRlICE9PSAidW5kZWZpbmVkIiAmJgoJCQlkaXYuZmlyc3RDaGlsZC5nZXRBdHRyaWJ1dGUoImhyZWYiKSAhPT0gIiMiICkgewoJCUV4cHIuYXR0ckhhbmRsZS5ocmVmID0gZnVuY3Rpb24oZWxlbSl7CgkJCXJldHVybiBlbGVtLmdldEF0dHJpYnV0ZSgiaHJlZiIsIDIpOwoJCX07Cgl9CgoJZGl2ID0gbnVsbDsgLy8gcmVsZWFzZSBtZW1vcnkgaW4gSUUKfSkoKTsKCmlmICggZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCApIHsKCShmdW5jdGlvbigpewoJCXZhciBvbGRTaXp6bGUgPSBTaXp6bGUsIGRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwoJCWRpdi5pbm5lckhUTUwgPSAiPHAgY2xhc3M9J1RFU1QnPjwvcD4iOwoKCQkvLyBTYWZhcmkgY2FuJ3QgaGFuZGxlIHVwcGVyY2FzZSBvciB1bmljb2RlIGNoYXJhY3RlcnMgd2hlbgoJCS8vIGluIHF1aXJrcyBtb2RlLgoJCWlmICggZGl2LnF1ZXJ5U2VsZWN0b3JBbGwgJiYgZGl2LnF1ZXJ5U2VsZWN0b3JBbGwoIi5URVNUIikubGVuZ3RoID09PSAwICkgewoJCQlyZXR1cm47CgkJfQoJCgkJU2l6emxlID0gZnVuY3Rpb24ocXVlcnksIGNvbnRleHQsIGV4dHJhLCBzZWVkKXsKCQkJY29udGV4dCA9IGNvbnRleHQgfHwgZG9jdW1lbnQ7CgoJCQkvLyBPbmx5IHVzZSBxdWVyeVNlbGVjdG9yQWxsIG9uIG5vbi1YTUwgZG9jdW1lbnRzCgkJCS8vIChJRCBzZWxlY3RvcnMgZG9uJ3Qgd29yayBpbiBub24tSFRNTCBkb2N1bWVudHMpCgkJCWlmICggIXNlZWQgJiYgY29udGV4dC5ub2RlVHlwZSA9PT0gOSAmJiAhaXNYTUwoY29udGV4dCkgKSB7CgkJCQl0cnkgewoJCQkJCXJldHVybiBtYWtlQXJyYXkoIGNvbnRleHQucXVlcnlTZWxlY3RvckFsbChxdWVyeSksIGV4dHJhICk7CgkJCQl9IGNhdGNoKGUpe30KCQkJfQoJCQoJCQlyZXR1cm4gb2xkU2l6emxlKHF1ZXJ5LCBjb250ZXh0LCBleHRyYSwgc2VlZCk7CgkJfTsKCgkJZm9yICggdmFyIHByb3AgaW4gb2xkU2l6emxlICkgewoJCQlTaXp6bGVbIHByb3AgXSA9IG9sZFNpenpsZVsgcHJvcCBdOwoJCX0KCgkJZGl2ID0gbnVsbDsgLy8gcmVsZWFzZSBtZW1vcnkgaW4gSUUKCX0pKCk7Cn0KCihmdW5jdGlvbigpewoJdmFyIGRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwoKCWRpdi5pbm5lckhUTUwgPSAiPGRpdiBjbGFzcz0ndGVzdCBlJz48L2Rpdj48ZGl2IGNsYXNzPSd0ZXN0Jz48L2Rpdj4iOwoKCS8vIE9wZXJhIGNhbid0IGZpbmQgYSBzZWNvbmQgY2xhc3NuYW1lIChpbiA5LjYpCgkvLyBBbHNvLCBtYWtlIHN1cmUgdGhhdCBnZXRFbGVtZW50c0J5Q2xhc3NOYW1lIGFjdHVhbGx5IGV4aXN0cwoJaWYgKCAhZGl2LmdldEVsZW1lbnRzQnlDbGFzc05hbWUgfHwgZGl2LmdldEVsZW1lbnRzQnlDbGFzc05hbWUoImUiKS5sZW5ndGggPT09IDAgKSB7CgkJcmV0dXJuOwoJfQoKCS8vIFNhZmFyaSBjYWNoZXMgY2xhc3MgYXR0cmlidXRlcywgZG9lc24ndCBjYXRjaCBjaGFuZ2VzIChpbiAzLjIpCglkaXYubGFzdENoaWxkLmNsYXNzTmFtZSA9ICJlIjsKCglpZiAoIGRpdi5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKCJlIikubGVuZ3RoID09PSAxICkgewoJCXJldHVybjsKCX0KCQoJRXhwci5vcmRlci5zcGxpY2UoMSwgMCwgIkNMQVNTIik7CglFeHByLmZpbmQuQ0xBU1MgPSBmdW5jdGlvbihtYXRjaCwgY29udGV4dCwgaXNYTUwpIHsKCQlpZiAoIHR5cGVvZiBjb250ZXh0LmdldEVsZW1lbnRzQnlDbGFzc05hbWUgIT09ICJ1bmRlZmluZWQiICYmICFpc1hNTCApIHsKCQkJcmV0dXJuIGNvbnRleHQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZShtYXRjaFsxXSk7CgkJfQoJfTsKCglkaXYgPSBudWxsOyAvLyByZWxlYXNlIG1lbW9yeSBpbiBJRQp9KSgpOwoKZnVuY3Rpb24gZGlyTm9kZUNoZWNrKCBkaXIsIGN1ciwgZG9uZU5hbWUsIGNoZWNrU2V0LCBub2RlQ2hlY2ssIGlzWE1MICkgewoJZm9yICggdmFyIGkgPSAwLCBsID0gY2hlY2tTZXQubGVuZ3RoOyBpIDwgbDsgaSsrICkgewoJCXZhciBlbGVtID0gY2hlY2tTZXRbaV07CgkJaWYgKCBlbGVtICkgewoJCQllbGVtID0gZWxlbVtkaXJdOwoJCQl2YXIgbWF0Y2ggPSBmYWxzZTsKCgkJCXdoaWxlICggZWxlbSApIHsKCQkJCWlmICggZWxlbS5zaXpjYWNoZSA9PT0gZG9uZU5hbWUgKSB7CgkJCQkJbWF0Y2ggPSBjaGVja1NldFtlbGVtLnNpenNldF07CgkJCQkJYnJlYWs7CgkJCQl9CgoJCQkJaWYgKCBlbGVtLm5vZGVUeXBlID09PSAxICYmICFpc1hNTCApewoJCQkJCWVsZW0uc2l6Y2FjaGUgPSBkb25lTmFtZTsKCQkJCQllbGVtLnNpenNldCA9IGk7CgkJCQl9CgoJCQkJaWYgKCBlbGVtLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09IGN1ciApIHsKCQkJCQltYXRjaCA9IGVsZW07CgkJCQkJYnJlYWs7CgkJCQl9CgoJCQkJZWxlbSA9IGVsZW1bZGlyXTsKCQkJfQoKCQkJY2hlY2tTZXRbaV0gPSBtYXRjaDsKCQl9Cgl9Cn0KCmZ1bmN0aW9uIGRpckNoZWNrKCBkaXIsIGN1ciwgZG9uZU5hbWUsIGNoZWNrU2V0LCBub2RlQ2hlY2ssIGlzWE1MICkgewoJZm9yICggdmFyIGkgPSAwLCBsID0gY2hlY2tTZXQubGVuZ3RoOyBpIDwgbDsgaSsrICkgewoJCXZhciBlbGVtID0gY2hlY2tTZXRbaV07CgkJaWYgKCBlbGVtICkgewoJCQllbGVtID0gZWxlbVtkaXJdOwoJCQl2YXIgbWF0Y2ggPSBmYWxzZTsKCgkJCXdoaWxlICggZWxlbSApIHsKCQkJCWlmICggZWxlbS5zaXpjYWNoZSA9PT0gZG9uZU5hbWUgKSB7CgkJCQkJbWF0Y2ggPSBjaGVja1NldFtlbGVtLnNpenNldF07CgkJCQkJYnJlYWs7CgkJCQl9CgoJCQkJaWYgKCBlbGVtLm5vZGVUeXBlID09PSAxICkgewoJCQkJCWlmICggIWlzWE1MICkgewoJCQkJCQllbGVtLnNpemNhY2hlID0gZG9uZU5hbWU7CgkJCQkJCWVsZW0uc2l6c2V0ID0gaTsKCQkJCQl9CgkJCQkJaWYgKCB0eXBlb2YgY3VyICE9PSAic3RyaW5nIiApIHsKCQkJCQkJaWYgKCBlbGVtID09PSBjdXIgKSB7CgkJCQkJCQltYXRjaCA9IHRydWU7CgkJCQkJCQlicmVhazsKCQkJCQkJfQoKCQkJCQl9IGVsc2UgaWYgKCBTaXp6bGUuZmlsdGVyKCBjdXIsIFtlbGVtXSApLmxlbmd0aCA+IDAgKSB7CgkJCQkJCW1hdGNoID0gZWxlbTsKCQkJCQkJYnJlYWs7CgkJCQkJfQoJCQkJfQoKCQkJCWVsZW0gPSBlbGVtW2Rpcl07CgkJCX0KCgkJCWNoZWNrU2V0W2ldID0gbWF0Y2g7CgkJfQoJfQp9Cgp2YXIgY29udGFpbnMgPSBkb2N1bWVudC5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbiA/IGZ1bmN0aW9uKGEsIGIpewoJcmV0dXJuICEhKGEuY29tcGFyZURvY3VtZW50UG9zaXRpb24oYikgJiAxNik7Cn0gOiBmdW5jdGlvbihhLCBiKXsKCXJldHVybiBhICE9PSBiICYmIChhLmNvbnRhaW5zID8gYS5jb250YWlucyhiKSA6IHRydWUpOwp9OwoKdmFyIGlzWE1MID0gZnVuY3Rpb24oZWxlbSl7CgkvLyBkb2N1bWVudEVsZW1lbnQgaXMgdmVyaWZpZWQgZm9yIGNhc2VzIHdoZXJlIGl0IGRvZXNuJ3QgeWV0IGV4aXN0CgkvLyAoc3VjaCBhcyBsb2FkaW5nIGlmcmFtZXMgaW4gSUUgLSAjNDgzMykgCgl2YXIgZG9jdW1lbnRFbGVtZW50ID0gKGVsZW0gPyBlbGVtLm93bmVyRG9jdW1lbnQgfHwgZWxlbSA6IDApLmRvY3VtZW50RWxlbWVudDsKCXJldHVybiBkb2N1bWVudEVsZW1lbnQgPyBkb2N1bWVudEVsZW1lbnQubm9kZU5hbWUgIT09ICJIVE1MIiA6IGZhbHNlOwp9OwoKdmFyIHBvc1Byb2Nlc3MgPSBmdW5jdGlvbihzZWxlY3RvciwgY29udGV4dCl7Cgl2YXIgdG1wU2V0ID0gW10sIGxhdGVyID0gIiIsIG1hdGNoLAoJCXJvb3QgPSBjb250ZXh0Lm5vZGVUeXBlID8gW2NvbnRleHRdIDogY29udGV4dDsKCgkvLyBQb3NpdGlvbiBzZWxlY3RvcnMgbXVzdCBiZSBkb25lIGFmdGVyIHRoZSBmaWx0ZXIKCS8vIEFuZCBzbyBtdXN0IDpub3QocG9zaXRpb25hbCkgc28gd2UgbW92ZSBhbGwgUFNFVURPcyB0byB0aGUgZW5kCgl3aGlsZSAoIChtYXRjaCA9IEV4cHIubWF0Y2guUFNFVURPLmV4ZWMoIHNlbGVjdG9yICkpICkgewoJCWxhdGVyICs9IG1hdGNoWzBdOwoJCXNlbGVjdG9yID0gc2VsZWN0b3IucmVwbGFjZSggRXhwci5tYXRjaC5QU0VVRE8sICIiICk7Cgl9CgoJc2VsZWN0b3IgPSBFeHByLnJlbGF0aXZlW3NlbGVjdG9yXSA/IHNlbGVjdG9yICsgIioiIDogc2VsZWN0b3I7CgoJZm9yICggdmFyIGkgPSAwLCBsID0gcm9vdC5sZW5ndGg7IGkgPCBsOyBpKysgKSB7CgkJU2l6emxlKCBzZWxlY3Rvciwgcm9vdFtpXSwgdG1wU2V0ICk7Cgl9CgoJcmV0dXJuIFNpenpsZS5maWx0ZXIoIGxhdGVyLCB0bXBTZXQgKTsKfTsKCi8vIEVYUE9TRQpqUXVlcnkuZmluZCA9IFNpenpsZTsKalF1ZXJ5LmV4cHIgPSBTaXp6bGUuc2VsZWN0b3JzOwpqUXVlcnkuZXhwclsiOiJdID0galF1ZXJ5LmV4cHIuZmlsdGVyczsKalF1ZXJ5LnVuaXF1ZSA9IFNpenpsZS51bmlxdWVTb3J0OwpqUXVlcnkudGV4dCA9IGdldFRleHQ7CmpRdWVyeS5pc1hNTERvYyA9IGlzWE1MOwpqUXVlcnkuY29udGFpbnMgPSBjb250YWluczsKCnJldHVybjsKCndpbmRvdy5TaXp6bGUgPSBTaXp6bGU7Cgp9KSgpOwp2YXIgcnVudGlsID0gL1VudGlsJC8sCglycGFyZW50c3ByZXYgPSAvXig/OnBhcmVudHN8cHJldlVudGlsfHByZXZBbGwpLywKCS8vIE5vdGU6IFRoaXMgUmVnRXhwIHNob3VsZCBiZSBpbXByb3ZlZCwgb3IgbGlrZWx5IHB1bGxlZCBmcm9tIFNpenpsZQoJcm11bHRpc2VsZWN0b3IgPSAvLC8sCglzbGljZSA9IEFycmF5LnByb3RvdHlwZS5zbGljZTsKCi8vIEltcGxlbWVudCB0aGUgaWRlbnRpY2FsIGZ1bmN0aW9uYWxpdHkgZm9yIGZpbHRlciBhbmQgbm90CnZhciB3aW5ub3cgPSBmdW5jdGlvbiggZWxlbWVudHMsIHF1YWxpZmllciwga2VlcCApIHsKCWlmICggalF1ZXJ5LmlzRnVuY3Rpb24oIHF1YWxpZmllciApICkgewoJCXJldHVybiBqUXVlcnkuZ3JlcChlbGVtZW50cywgZnVuY3Rpb24oIGVsZW0sIGkgKSB7CgkJCXJldHVybiAhIXF1YWxpZmllci5jYWxsKCBlbGVtLCBpLCBlbGVtICkgPT09IGtlZXA7CgkJfSk7CgoJfSBlbHNlIGlmICggcXVhbGlmaWVyLm5vZGVUeXBlICkgewoJCXJldHVybiBqUXVlcnkuZ3JlcChlbGVtZW50cywgZnVuY3Rpb24oIGVsZW0sIGkgKSB7CgkJCXJldHVybiAoZWxlbSA9PT0gcXVhbGlmaWVyKSA9PT0ga2VlcDsKCQl9KTsKCgl9IGVsc2UgaWYgKCB0eXBlb2YgcXVhbGlmaWVyID09PSAic3RyaW5nIiApIHsKCQl2YXIgZmlsdGVyZWQgPSBqUXVlcnkuZ3JlcChlbGVtZW50cywgZnVuY3Rpb24oIGVsZW0gKSB7CgkJCXJldHVybiBlbGVtLm5vZGVUeXBlID09PSAxOwoJCX0pOwoKCQlpZiAoIGlzU2ltcGxlLnRlc3QoIHF1YWxpZmllciApICkgewoJCQlyZXR1cm4galF1ZXJ5LmZpbHRlcihxdWFsaWZpZXIsIGZpbHRlcmVkLCAha2VlcCk7CgkJfSBlbHNlIHsKCQkJcXVhbGlmaWVyID0galF1ZXJ5LmZpbHRlciggcXVhbGlmaWVyLCBmaWx0ZXJlZCApOwoJCX0KCX0KCglyZXR1cm4galF1ZXJ5LmdyZXAoZWxlbWVudHMsIGZ1bmN0aW9uKCBlbGVtLCBpICkgewoJCXJldHVybiAoalF1ZXJ5LmluQXJyYXkoIGVsZW0sIHF1YWxpZmllciApID49IDApID09PSBrZWVwOwoJfSk7Cn07CgpqUXVlcnkuZm4uZXh0ZW5kKHsKCWZpbmQ6IGZ1bmN0aW9uKCBzZWxlY3RvciApIHsKCQl2YXIgcmV0ID0gdGhpcy5wdXNoU3RhY2soICIiLCAiZmluZCIsIHNlbGVjdG9yICksIGxlbmd0aCA9IDA7CgoJCWZvciAoIHZhciBpID0gMCwgbCA9IHRoaXMubGVuZ3RoOyBpIDwgbDsgaSsrICkgewoJCQlsZW5ndGggPSByZXQubGVuZ3RoOwoJCQlqUXVlcnkuZmluZCggc2VsZWN0b3IsIHRoaXNbaV0sIHJldCApOwoKCQkJaWYgKCBpID4gMCApIHsKCQkJCS8vIE1ha2Ugc3VyZSB0aGF0IHRoZSByZXN1bHRzIGFyZSB1bmlxdWUKCQkJCWZvciAoIHZhciBuID0gbGVuZ3RoOyBuIDwgcmV0Lmxlbmd0aDsgbisrICkgewoJCQkJCWZvciAoIHZhciByID0gMDsgciA8IGxlbmd0aDsgcisrICkgewoJCQkJCQlpZiAoIHJldFtyXSA9PT0gcmV0W25dICkgewoJCQkJCQkJcmV0LnNwbGljZShuLS0sIDEpOwoJCQkJCQkJYnJlYWs7CgkJCQkJCX0KCQkJCQl9CgkJCQl9CgkJCX0KCQl9CgoJCXJldHVybiByZXQ7Cgl9LAoKCWhhczogZnVuY3Rpb24oIHRhcmdldCApIHsKCQl2YXIgdGFyZ2V0cyA9IGpRdWVyeSggdGFyZ2V0ICk7CgkJcmV0dXJuIHRoaXMuZmlsdGVyKGZ1bmN0aW9uKCkgewoJCQlmb3IgKCB2YXIgaSA9IDAsIGwgPSB0YXJnZXRzLmxlbmd0aDsgaSA8IGw7IGkrKyApIHsKCQkJCWlmICggalF1ZXJ5LmNvbnRhaW5zKCB0aGlzLCB0YXJnZXRzW2ldICkgKSB7CgkJCQkJcmV0dXJuIHRydWU7CgkJCQl9CgkJCX0KCQl9KTsKCX0sCgoJbm90OiBmdW5jdGlvbiggc2VsZWN0b3IgKSB7CgkJcmV0dXJuIHRoaXMucHVzaFN0YWNrKCB3aW5ub3codGhpcywgc2VsZWN0b3IsIGZhbHNlKSwgIm5vdCIsIHNlbGVjdG9yKTsKCX0sCgoJZmlsdGVyOiBmdW5jdGlvbiggc2VsZWN0b3IgKSB7CgkJcmV0dXJuIHRoaXMucHVzaFN0YWNrKCB3aW5ub3codGhpcywgc2VsZWN0b3IsIHRydWUpLCAiZmlsdGVyIiwgc2VsZWN0b3IgKTsKCX0sCgkKCWlzOiBmdW5jdGlvbiggc2VsZWN0b3IgKSB7CgkJcmV0dXJuICEhc2VsZWN0b3IgJiYgalF1ZXJ5LmZpbHRlciggc2VsZWN0b3IsIHRoaXMgKS5sZW5ndGggPiAwOwoJfSwKCgljbG9zZXN0OiBmdW5jdGlvbiggc2VsZWN0b3JzLCBjb250ZXh0ICkgewoJCWlmICggalF1ZXJ5LmlzQXJyYXkoIHNlbGVjdG9ycyApICkgewoJCQl2YXIgcmV0ID0gW10sIGN1ciA9IHRoaXNbMF0sIG1hdGNoLCBtYXRjaGVzID0ge30sIHNlbGVjdG9yOwoKCQkJaWYgKCBjdXIgJiYgc2VsZWN0b3JzLmxlbmd0aCApIHsKCQkJCWZvciAoIHZhciBpID0gMCwgbCA9IHNlbGVjdG9ycy5sZW5ndGg7IGkgPCBsOyBpKysgKSB7CgkJCQkJc2VsZWN0b3IgPSBzZWxlY3RvcnNbaV07CgoJCQkJCWlmICggIW1hdGNoZXNbc2VsZWN0b3JdICkgewoJCQkJCQltYXRjaGVzW3NlbGVjdG9yXSA9IGpRdWVyeS5leHByLm1hdGNoLlBPUy50ZXN0KCBzZWxlY3RvciApID8gCgkJCQkJCQlqUXVlcnkoIHNlbGVjdG9yLCBjb250ZXh0IHx8IHRoaXMuY29udGV4dCApIDoKCQkJCQkJCXNlbGVjdG9yOwoJCQkJCX0KCQkJCX0KCgkJCQl3aGlsZSAoIGN1ciAmJiBjdXIub3duZXJEb2N1bWVudCAmJiBjdXIgIT09IGNvbnRleHQgKSB7CgkJCQkJZm9yICggc2VsZWN0b3IgaW4gbWF0Y2hlcyApIHsKCQkJCQkJbWF0Y2ggPSBtYXRjaGVzW3NlbGVjdG9yXTsKCgkJCQkJCWlmICggbWF0Y2guanF1ZXJ5ID8gbWF0Y2guaW5kZXgoY3VyKSA+IC0xIDogalF1ZXJ5KGN1cikuaXMobWF0Y2gpICkgewoJCQkJCQkJcmV0LnB1c2goeyBzZWxlY3Rvcjogc2VsZWN0b3IsIGVsZW06IGN1ciB9KTsKCQkJCQkJCWRlbGV0ZSBtYXRjaGVzW3NlbGVjdG9yXTsKCQkJCQkJfQoJCQkJCX0KCQkJCQljdXIgPSBjdXIucGFyZW50Tm9kZTsKCQkJCX0KCQkJfQoKCQkJcmV0dXJuIHJldDsKCQl9CgoJCXZhciBwb3MgPSBqUXVlcnkuZXhwci5tYXRjaC5QT1MudGVzdCggc2VsZWN0b3JzICkgPyAKCQkJalF1ZXJ5KCBzZWxlY3RvcnMsIGNvbnRleHQgfHwgdGhpcy5jb250ZXh0ICkgOiBudWxsOwoKCQlyZXR1cm4gdGhpcy5tYXAoZnVuY3Rpb24oIGksIGN1ciApIHsKCQkJd2hpbGUgKCBjdXIgJiYgY3VyLm93bmVyRG9jdW1lbnQgJiYgY3VyICE9PSBjb250ZXh0ICkgewoJCQkJaWYgKCBwb3MgPyBwb3MuaW5kZXgoY3VyKSA+IC0xIDogalF1ZXJ5KGN1cikuaXMoc2VsZWN0b3JzKSApIHsKCQkJCQlyZXR1cm4gY3VyOwoJCQkJfQoJCQkJY3VyID0gY3VyLnBhcmVudE5vZGU7CgkJCX0KCQkJcmV0dXJuIG51bGw7CgkJfSk7Cgl9LAoJCgkvLyBEZXRlcm1pbmUgdGhlIHBvc2l0aW9uIG9mIGFuIGVsZW1lbnQgd2l0aGluCgkvLyB0aGUgbWF0Y2hlZCBzZXQgb2YgZWxlbWVudHMKCWluZGV4OiBmdW5jdGlvbiggZWxlbSApIHsKCQlpZiAoICFlbGVtIHx8IHR5cGVvZiBlbGVtID09PSAic3RyaW5nIiApIHsKCQkJcmV0dXJuIGpRdWVyeS5pbkFycmF5KCB0aGlzWzBdLAoJCQkJLy8gSWYgaXQgcmVjZWl2ZXMgYSBzdHJpbmcsIHRoZSBzZWxlY3RvciBpcyB1c2VkCgkJCQkvLyBJZiBpdCByZWNlaXZlcyBub3RoaW5nLCB0aGUgc2libGluZ3MgYXJlIHVzZWQKCQkJCWVsZW0gPyBqUXVlcnkoIGVsZW0gKSA6IHRoaXMucGFyZW50KCkuY2hpbGRyZW4oKSApOwoJCX0KCQkvLyBMb2NhdGUgdGhlIHBvc2l0aW9uIG9mIHRoZSBkZXNpcmVkIGVsZW1lbnQKCQlyZXR1cm4galF1ZXJ5LmluQXJyYXkoCgkJCS8vIElmIGl0IHJlY2VpdmVzIGEgalF1ZXJ5IG9iamVjdCwgdGhlIGZpcnN0IGVsZW1lbnQgaXMgdXNlZAoJCQllbGVtLmpxdWVyeSA/IGVsZW1bMF0gOiBlbGVtLCB0aGlzICk7Cgl9LAoKCWFkZDogZnVuY3Rpb24oIHNlbGVjdG9yLCBjb250ZXh0ICkgewoJCXZhciBzZXQgPSB0eXBlb2Ygc2VsZWN0b3IgPT09ICJzdHJpbmciID8KCQkJCWpRdWVyeSggc2VsZWN0b3IsIGNvbnRleHQgfHwgdGhpcy5jb250ZXh0ICkgOgoJCQkJalF1ZXJ5Lm1ha2VBcnJheSggc2VsZWN0b3IgKSwKCQkJYWxsID0galF1ZXJ5Lm1lcmdlKCB0aGlzLmdldCgpLCBzZXQgKTsKCgkJcmV0dXJuIHRoaXMucHVzaFN0YWNrKCBpc0Rpc2Nvbm5lY3RlZCggc2V0WzBdICkgfHwgaXNEaXNjb25uZWN0ZWQoIGFsbFswXSApID8KCQkJYWxsIDoKCQkJalF1ZXJ5LnVuaXF1ZSggYWxsICkgKTsKCX0sCgoJYW5kU2VsZjogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuYWRkKCB0aGlzLnByZXZPYmplY3QgKTsKCX0KfSk7CgovLyBBIHBhaW5mdWxseSBzaW1wbGUgY2hlY2sgdG8gc2VlIGlmIGFuIGVsZW1lbnQgaXMgZGlzY29ubmVjdGVkCi8vIGZyb20gYSBkb2N1bWVudCAoc2hvdWxkIGJlIGltcHJvdmVkLCB3aGVyZSBmZWFzaWJsZSkuCmZ1bmN0aW9uIGlzRGlzY29ubmVjdGVkKCBub2RlICkgewoJcmV0dXJuICFub2RlIHx8ICFub2RlLnBhcmVudE5vZGUgfHwgbm9kZS5wYXJlbnROb2RlLm5vZGVUeXBlID09PSAxMTsKfQoKalF1ZXJ5LmVhY2goewoJcGFyZW50OiBmdW5jdGlvbiggZWxlbSApIHsKCQl2YXIgcGFyZW50ID0gZWxlbS5wYXJlbnROb2RlOwoJCXJldHVybiBwYXJlbnQgJiYgcGFyZW50Lm5vZGVUeXBlICE9PSAxMSA/IHBhcmVudCA6IG51bGw7Cgl9LAoJcGFyZW50czogZnVuY3Rpb24oIGVsZW0gKSB7CgkJcmV0dXJuIGpRdWVyeS5kaXIoIGVsZW0sICJwYXJlbnROb2RlIiApOwoJfSwKCXBhcmVudHNVbnRpbDogZnVuY3Rpb24oIGVsZW0sIGksIHVudGlsICkgewoJCXJldHVybiBqUXVlcnkuZGlyKCBlbGVtLCAicGFyZW50Tm9kZSIsIHVudGlsICk7Cgl9LAoJbmV4dDogZnVuY3Rpb24oIGVsZW0gKSB7CgkJcmV0dXJuIGpRdWVyeS5udGgoIGVsZW0sIDIsICJuZXh0U2libGluZyIgKTsKCX0sCglwcmV2OiBmdW5jdGlvbiggZWxlbSApIHsKCQlyZXR1cm4galF1ZXJ5Lm50aCggZWxlbSwgMiwgInByZXZpb3VzU2libGluZyIgKTsKCX0sCgluZXh0QWxsOiBmdW5jdGlvbiggZWxlbSApIHsKCQlyZXR1cm4galF1ZXJ5LmRpciggZWxlbSwgIm5leHRTaWJsaW5nIiApOwoJfSwKCXByZXZBbGw6IGZ1bmN0aW9uKCBlbGVtICkgewoJCXJldHVybiBqUXVlcnkuZGlyKCBlbGVtLCAicHJldmlvdXNTaWJsaW5nIiApOwoJfSwKCW5leHRVbnRpbDogZnVuY3Rpb24oIGVsZW0sIGksIHVudGlsICkgewoJCXJldHVybiBqUXVlcnkuZGlyKCBlbGVtLCAibmV4dFNpYmxpbmciLCB1bnRpbCApOwoJfSwKCXByZXZVbnRpbDogZnVuY3Rpb24oIGVsZW0sIGksIHVudGlsICkgewoJCXJldHVybiBqUXVlcnkuZGlyKCBlbGVtLCAicHJldmlvdXNTaWJsaW5nIiwgdW50aWwgKTsKCX0sCglzaWJsaW5nczogZnVuY3Rpb24oIGVsZW0gKSB7CgkJcmV0dXJuIGpRdWVyeS5zaWJsaW5nKCBlbGVtLnBhcmVudE5vZGUuZmlyc3RDaGlsZCwgZWxlbSApOwoJfSwKCWNoaWxkcmVuOiBmdW5jdGlvbiggZWxlbSApIHsKCQlyZXR1cm4galF1ZXJ5LnNpYmxpbmcoIGVsZW0uZmlyc3RDaGlsZCApOwoJfSwKCWNvbnRlbnRzOiBmdW5jdGlvbiggZWxlbSApIHsKCQlyZXR1cm4galF1ZXJ5Lm5vZGVOYW1lKCBlbGVtLCAiaWZyYW1lIiApID8KCQkJZWxlbS5jb250ZW50RG9jdW1lbnQgfHwgZWxlbS5jb250ZW50V2luZG93LmRvY3VtZW50IDoKCQkJalF1ZXJ5Lm1ha2VBcnJheSggZWxlbS5jaGlsZE5vZGVzICk7Cgl9Cn0sIGZ1bmN0aW9uKCBuYW1lLCBmbiApIHsKCWpRdWVyeS5mblsgbmFtZSBdID0gZnVuY3Rpb24oIHVudGlsLCBzZWxlY3RvciApIHsKCQl2YXIgcmV0ID0galF1ZXJ5Lm1hcCggdGhpcywgZm4sIHVudGlsICk7CgkJCgkJaWYgKCAhcnVudGlsLnRlc3QoIG5hbWUgKSApIHsKCQkJc2VsZWN0b3IgPSB1bnRpbDsKCQl9CgoJCWlmICggc2VsZWN0b3IgJiYgdHlwZW9mIHNlbGVjdG9yID09PSAic3RyaW5nIiApIHsKCQkJcmV0ID0galF1ZXJ5LmZpbHRlciggc2VsZWN0b3IsIHJldCApOwoJCX0KCgkJcmV0ID0gdGhpcy5sZW5ndGggPiAxID8galF1ZXJ5LnVuaXF1ZSggcmV0ICkgOiByZXQ7CgoJCWlmICggKHRoaXMubGVuZ3RoID4gMSB8fCBybXVsdGlzZWxlY3Rvci50ZXN0KCBzZWxlY3RvciApKSAmJiBycGFyZW50c3ByZXYudGVzdCggbmFtZSApICkgewoJCQlyZXQgPSByZXQucmV2ZXJzZSgpOwoJCX0KCgkJcmV0dXJuIHRoaXMucHVzaFN0YWNrKCByZXQsIG5hbWUsIHNsaWNlLmNhbGwoYXJndW1lbnRzKS5qb2luKCIsIikgKTsKCX07Cn0pOwoKalF1ZXJ5LmV4dGVuZCh7CglmaWx0ZXI6IGZ1bmN0aW9uKCBleHByLCBlbGVtcywgbm90ICkgewoJCWlmICggbm90ICkgewoJCQlleHByID0gIjpub3QoIiArIGV4cHIgKyAiKSI7CgkJfQoKCQlyZXR1cm4galF1ZXJ5LmZpbmQubWF0Y2hlcyhleHByLCBlbGVtcyk7Cgl9LAoJCglkaXI6IGZ1bmN0aW9uKCBlbGVtLCBkaXIsIHVudGlsICkgewoJCXZhciBtYXRjaGVkID0gW10sIGN1ciA9IGVsZW1bZGlyXTsKCQl3aGlsZSAoIGN1ciAmJiBjdXIubm9kZVR5cGUgIT09IDkgJiYgKHVudGlsID09PSB1bmRlZmluZWQgfHwgY3VyLm5vZGVUeXBlICE9PSAxIHx8ICFqUXVlcnkoIGN1ciApLmlzKCB1bnRpbCApKSApIHsKCQkJaWYgKCBjdXIubm9kZVR5cGUgPT09IDEgKSB7CgkJCQltYXRjaGVkLnB1c2goIGN1ciApOwoJCQl9CgkJCWN1ciA9IGN1cltkaXJdOwoJCX0KCQlyZXR1cm4gbWF0Y2hlZDsKCX0sCgoJbnRoOiBmdW5jdGlvbiggY3VyLCByZXN1bHQsIGRpciwgZWxlbSApIHsKCQlyZXN1bHQgPSByZXN1bHQgfHwgMTsKCQl2YXIgbnVtID0gMDsKCgkJZm9yICggOyBjdXI7IGN1ciA9IGN1cltkaXJdICkgewoJCQlpZiAoIGN1ci5ub2RlVHlwZSA9PT0gMSAmJiArK251bSA9PT0gcmVzdWx0ICkgewoJCQkJYnJlYWs7CgkJCX0KCQl9CgoJCXJldHVybiBjdXI7Cgl9LAoKCXNpYmxpbmc6IGZ1bmN0aW9uKCBuLCBlbGVtICkgewoJCXZhciByID0gW107CgoJCWZvciAoIDsgbjsgbiA9IG4ubmV4dFNpYmxpbmcgKSB7CgkJCWlmICggbi5ub2RlVHlwZSA9PT0gMSAmJiBuICE9PSBlbGVtICkgewoJCQkJci5wdXNoKCBuICk7CgkJCX0KCQl9CgoJCXJldHVybiByOwoJfQp9KTsKdmFyIHJpbmxpbmVqUXVlcnkgPSAvIGpRdWVyeVxkKz0iKD86XGQrfG51bGwpIi9nLAoJcmxlYWRpbmdXaGl0ZXNwYWNlID0gL15ccysvLAoJcnhodG1sVGFnID0gLyg8KFtcdzpdKylbXj5dKj8pXC8+L2csCglyc2VsZkNsb3NpbmcgPSAvXig/OmFyZWF8YnJ8Y29sfGVtYmVkfGhyfGltZ3xpbnB1dHxsaW5rfG1ldGF8cGFyYW0pJC9pLAoJcnRhZ05hbWUgPSAvPChbXHc6XSspLywKCXJ0Ym9keSA9IC88dGJvZHkvaSwKCXJodG1sID0gLzx8JiM/XHcrOy8sCglybm9jYWNoZSA9IC88c2NyaXB0fDxvYmplY3R8PGVtYmVkfDxvcHRpb258PHN0eWxlL2ksCglyY2hlY2tlZCA9IC9jaGVja2VkXHMqKD86W149XXw9XHMqLmNoZWNrZWQuKS9pLCAgLy8gY2hlY2tlZD0iY2hlY2tlZCIgb3IgY2hlY2tlZCAoaHRtbDUpCglmY2xvc2VUYWcgPSBmdW5jdGlvbiggYWxsLCBmcm9udCwgdGFnICkgewoJCXJldHVybiByc2VsZkNsb3NpbmcudGVzdCggdGFnICkgPwoJCQlhbGwgOgoJCQlmcm9udCArICI+PC8iICsgdGFnICsgIj4iOwoJfSwKCXdyYXBNYXAgPSB7CgkJb3B0aW9uOiBbIDEsICI8c2VsZWN0IG11bHRpcGxlPSdtdWx0aXBsZSc+IiwgIjwvc2VsZWN0PiIgXSwKCQlsZWdlbmQ6IFsgMSwgIjxmaWVsZHNldD4iLCAiPC9maWVsZHNldD4iIF0sCgkJdGhlYWQ6IFsgMSwgIjx0YWJsZT4iLCAiPC90YWJsZT4iIF0sCgkJdHI6IFsgMiwgIjx0YWJsZT48dGJvZHk+IiwgIjwvdGJvZHk+PC90YWJsZT4iIF0sCgkJdGQ6IFsgMywgIjx0YWJsZT48dGJvZHk+PHRyPiIsICI8L3RyPjwvdGJvZHk+PC90YWJsZT4iIF0sCgkJY29sOiBbIDIsICI8dGFibGU+PHRib2R5PjwvdGJvZHk+PGNvbGdyb3VwPiIsICI8L2NvbGdyb3VwPjwvdGFibGU+IiBdLAoJCWFyZWE6IFsgMSwgIjxtYXA+IiwgIjwvbWFwPiIgXSwKCQlfZGVmYXVsdDogWyAwLCAiIiwgIiIgXQoJfTsKCndyYXBNYXAub3B0Z3JvdXAgPSB3cmFwTWFwLm9wdGlvbjsKd3JhcE1hcC50Ym9keSA9IHdyYXBNYXAudGZvb3QgPSB3cmFwTWFwLmNvbGdyb3VwID0gd3JhcE1hcC5jYXB0aW9uID0gd3JhcE1hcC50aGVhZDsKd3JhcE1hcC50aCA9IHdyYXBNYXAudGQ7CgovLyBJRSBjYW4ndCBzZXJpYWxpemUgPGxpbms+IGFuZCA8c2NyaXB0PiB0YWdzIG5vcm1hbGx5CmlmICggIWpRdWVyeS5zdXBwb3J0Lmh0bWxTZXJpYWxpemUgKSB7Cgl3cmFwTWFwLl9kZWZhdWx0ID0gWyAxLCAiZGl2PGRpdj4iLCAiPC9kaXY+IiBdOwp9CgpqUXVlcnkuZm4uZXh0ZW5kKHsKCXRleHQ6IGZ1bmN0aW9uKCB0ZXh0ICkgewoJCWlmICggalF1ZXJ5LmlzRnVuY3Rpb24odGV4dCkgKSB7CgkJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oaSkgewoJCQkJdmFyIHNlbGYgPSBqUXVlcnkodGhpcyk7CgkJCQlzZWxmLnRleHQoIHRleHQuY2FsbCh0aGlzLCBpLCBzZWxmLnRleHQoKSkgKTsKCQkJfSk7CgkJfQoKCQlpZiAoIHR5cGVvZiB0ZXh0ICE9PSAib2JqZWN0IiAmJiB0ZXh0ICE9PSB1bmRlZmluZWQgKSB7CgkJCXJldHVybiB0aGlzLmVtcHR5KCkuYXBwZW5kKCAodGhpc1swXSAmJiB0aGlzWzBdLm93bmVyRG9jdW1lbnQgfHwgZG9jdW1lbnQpLmNyZWF0ZVRleHROb2RlKCB0ZXh0ICkgKTsKCQl9CgoJCXJldHVybiBqUXVlcnkudGV4dCggdGhpcyApOwoJfSwKCgl3cmFwQWxsOiBmdW5jdGlvbiggaHRtbCApIHsKCQlpZiAoIGpRdWVyeS5pc0Z1bmN0aW9uKCBodG1sICkgKSB7CgkJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oaSkgewoJCQkJalF1ZXJ5KHRoaXMpLndyYXBBbGwoIGh0bWwuY2FsbCh0aGlzLCBpKSApOwoJCQl9KTsKCQl9CgoJCWlmICggdGhpc1swXSApIHsKCQkJLy8gVGhlIGVsZW1lbnRzIHRvIHdyYXAgdGhlIHRhcmdldCBhcm91bmQKCQkJdmFyIHdyYXAgPSBqUXVlcnkoIGh0bWwsIHRoaXNbMF0ub3duZXJEb2N1bWVudCApLmVxKDApLmNsb25lKHRydWUpOwoKCQkJaWYgKCB0aGlzWzBdLnBhcmVudE5vZGUgKSB7CgkJCQl3cmFwLmluc2VydEJlZm9yZSggdGhpc1swXSApOwoJCQl9CgoJCQl3cmFwLm1hcChmdW5jdGlvbigpIHsKCQkJCXZhciBlbGVtID0gdGhpczsKCgkJCQl3aGlsZSAoIGVsZW0uZmlyc3RDaGlsZCAmJiBlbGVtLmZpcnN0Q2hpbGQubm9kZVR5cGUgPT09IDEgKSB7CgkJCQkJZWxlbSA9IGVsZW0uZmlyc3RDaGlsZDsKCQkJCX0KCgkJCQlyZXR1cm4gZWxlbTsKCQkJfSkuYXBwZW5kKHRoaXMpOwoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9LAoKCXdyYXBJbm5lcjogZnVuY3Rpb24oIGh0bWwgKSB7CgkJaWYgKCBqUXVlcnkuaXNGdW5jdGlvbiggaHRtbCApICkgewoJCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKGkpIHsKCQkJCWpRdWVyeSh0aGlzKS53cmFwSW5uZXIoIGh0bWwuY2FsbCh0aGlzLCBpKSApOwoJCQl9KTsKCQl9CgoJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgkJCXZhciBzZWxmID0galF1ZXJ5KCB0aGlzICksIGNvbnRlbnRzID0gc2VsZi5jb250ZW50cygpOwoKCQkJaWYgKCBjb250ZW50cy5sZW5ndGggKSB7CgkJCQljb250ZW50cy53cmFwQWxsKCBodG1sICk7CgoJCQl9IGVsc2UgewoJCQkJc2VsZi5hcHBlbmQoIGh0bWwgKTsKCQkJfQoJCX0pOwoJfSwKCgl3cmFwOiBmdW5jdGlvbiggaHRtbCApIHsKCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQlqUXVlcnkoIHRoaXMgKS53cmFwQWxsKCBodG1sICk7CgkJfSk7Cgl9LAoKCXVud3JhcDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMucGFyZW50KCkuZWFjaChmdW5jdGlvbigpIHsKCQkJaWYgKCAhalF1ZXJ5Lm5vZGVOYW1lKCB0aGlzLCAiYm9keSIgKSApIHsKCQkJCWpRdWVyeSggdGhpcyApLnJlcGxhY2VXaXRoKCB0aGlzLmNoaWxkTm9kZXMgKTsKCQkJfQoJCX0pLmVuZCgpOwoJfSwKCglhcHBlbmQ6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLmRvbU1hbmlwKGFyZ3VtZW50cywgdHJ1ZSwgZnVuY3Rpb24oIGVsZW0gKSB7CgkJCWlmICggdGhpcy5ub2RlVHlwZSA9PT0gMSApIHsKCQkJCXRoaXMuYXBwZW5kQ2hpbGQoIGVsZW0gKTsKCQkJfQoJCX0pOwoJfSwKCglwcmVwZW5kOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5kb21NYW5pcChhcmd1bWVudHMsIHRydWUsIGZ1bmN0aW9uKCBlbGVtICkgewoJCQlpZiAoIHRoaXMubm9kZVR5cGUgPT09IDEgKSB7CgkJCQl0aGlzLmluc2VydEJlZm9yZSggZWxlbSwgdGhpcy5maXJzdENoaWxkICk7CgkJCX0KCQl9KTsKCX0sCgoJYmVmb3JlOiBmdW5jdGlvbigpIHsKCQlpZiAoIHRoaXNbMF0gJiYgdGhpc1swXS5wYXJlbnROb2RlICkgewoJCQlyZXR1cm4gdGhpcy5kb21NYW5pcChhcmd1bWVudHMsIGZhbHNlLCBmdW5jdGlvbiggZWxlbSApIHsKCQkJCXRoaXMucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUoIGVsZW0sIHRoaXMgKTsKCQkJfSk7CgkJfSBlbHNlIGlmICggYXJndW1lbnRzLmxlbmd0aCApIHsKCQkJdmFyIHNldCA9IGpRdWVyeShhcmd1bWVudHNbMF0pOwoJCQlzZXQucHVzaC5hcHBseSggc2V0LCB0aGlzLnRvQXJyYXkoKSApOwoJCQlyZXR1cm4gdGhpcy5wdXNoU3RhY2soIHNldCwgImJlZm9yZSIsIGFyZ3VtZW50cyApOwoJCX0KCX0sCgoJYWZ0ZXI6IGZ1bmN0aW9uKCkgewoJCWlmICggdGhpc1swXSAmJiB0aGlzWzBdLnBhcmVudE5vZGUgKSB7CgkJCXJldHVybiB0aGlzLmRvbU1hbmlwKGFyZ3VtZW50cywgZmFsc2UsIGZ1bmN0aW9uKCBlbGVtICkgewoJCQkJdGhpcy5wYXJlbnROb2RlLmluc2VydEJlZm9yZSggZWxlbSwgdGhpcy5uZXh0U2libGluZyApOwoJCQl9KTsKCQl9IGVsc2UgaWYgKCBhcmd1bWVudHMubGVuZ3RoICkgewoJCQl2YXIgc2V0ID0gdGhpcy5wdXNoU3RhY2soIHRoaXMsICJhZnRlciIsIGFyZ3VtZW50cyApOwoJCQlzZXQucHVzaC5hcHBseSggc2V0LCBqUXVlcnkoYXJndW1lbnRzWzBdKS50b0FycmF5KCkgKTsKCQkJcmV0dXJuIHNldDsKCQl9Cgl9LAoJCgkvLyBrZWVwRGF0YSBpcyBmb3IgaW50ZXJuYWwgdXNlIG9ubHktLWRvIG5vdCBkb2N1bWVudAoJcmVtb3ZlOiBmdW5jdGlvbiggc2VsZWN0b3IsIGtlZXBEYXRhICkgewoJCWZvciAoIHZhciBpID0gMCwgZWxlbTsgKGVsZW0gPSB0aGlzW2ldKSAhPSBudWxsOyBpKysgKSB7CgkJCWlmICggIXNlbGVjdG9yIHx8IGpRdWVyeS5maWx0ZXIoIHNlbGVjdG9yLCBbIGVsZW0gXSApLmxlbmd0aCApIHsKCQkJCWlmICggIWtlZXBEYXRhICYmIGVsZW0ubm9kZVR5cGUgPT09IDEgKSB7CgkJCQkJalF1ZXJ5LmNsZWFuRGF0YSggZWxlbS5nZXRFbGVtZW50c0J5VGFnTmFtZSgiKiIpICk7CgkJCQkJalF1ZXJ5LmNsZWFuRGF0YSggWyBlbGVtIF0gKTsKCQkJCX0KCgkJCQlpZiAoIGVsZW0ucGFyZW50Tm9kZSApIHsKCQkJCQkgZWxlbS5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKCBlbGVtICk7CgkJCQl9CgkJCX0KCQl9CgkJCgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWVtcHR5OiBmdW5jdGlvbigpIHsKCQlmb3IgKCB2YXIgaSA9IDAsIGVsZW07IChlbGVtID0gdGhpc1tpXSkgIT0gbnVsbDsgaSsrICkgewoJCQkvLyBSZW1vdmUgZWxlbWVudCBub2RlcyBhbmQgcHJldmVudCBtZW1vcnkgbGVha3MKCQkJaWYgKCBlbGVtLm5vZGVUeXBlID09PSAxICkgewoJCQkJalF1ZXJ5LmNsZWFuRGF0YSggZWxlbS5nZXRFbGVtZW50c0J5VGFnTmFtZSgiKiIpICk7CgkJCX0KCgkJCS8vIFJlbW92ZSBhbnkgcmVtYWluaW5nIG5vZGVzCgkJCXdoaWxlICggZWxlbS5maXJzdENoaWxkICkgewoJCQkJZWxlbS5yZW1vdmVDaGlsZCggZWxlbS5maXJzdENoaWxkICk7CgkJCX0KCQl9CgkJCgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWNsb25lOiBmdW5jdGlvbiggZXZlbnRzICkgewoJCS8vIERvIHRoZSBjbG9uZQoJCXZhciByZXQgPSB0aGlzLm1hcChmdW5jdGlvbigpIHsKCQkJaWYgKCAhalF1ZXJ5LnN1cHBvcnQubm9DbG9uZUV2ZW50ICYmICFqUXVlcnkuaXNYTUxEb2ModGhpcykgKSB7CgkJCQkvLyBJRSBjb3BpZXMgZXZlbnRzIGJvdW5kIHZpYSBhdHRhY2hFdmVudCB3aGVuCgkJCQkvLyB1c2luZyBjbG9uZU5vZGUuIENhbGxpbmcgZGV0YWNoRXZlbnQgb24gdGhlCgkJCQkvLyBjbG9uZSB3aWxsIGFsc28gcmVtb3ZlIHRoZSBldmVudHMgZnJvbSB0aGUgb3JpZ25hbAoJCQkJLy8gSW4gb3JkZXIgdG8gZ2V0IGFyb3VuZCB0aGlzLCB3ZSB1c2UgaW5uZXJIVE1MLgoJCQkJLy8gVW5mb3J0dW5hdGVseSwgdGhpcyBtZWFucyBzb21lIG1vZGlmaWNhdGlvbnMgdG8KCQkJCS8vIGF0dHJpYnV0ZXMgaW4gSUUgdGhhdCBhcmUgYWN0dWFsbHkgb25seSBzdG9yZWQKCQkJCS8vIGFzIHByb3BlcnRpZXMgd2lsbCBub3QgYmUgY29waWVkIChzdWNoIGFzIHRoZQoJCQkJLy8gdGhlIG5hbWUgYXR0cmlidXRlIG9uIGFuIGlucHV0KS4KCQkJCXZhciBodG1sID0gdGhpcy5vdXRlckhUTUwsIG93bmVyRG9jdW1lbnQgPSB0aGlzLm93bmVyRG9jdW1lbnQ7CgkJCQlpZiAoICFodG1sICkgewoJCQkJCXZhciBkaXYgPSBvd25lckRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwoJCQkJCWRpdi5hcHBlbmRDaGlsZCggdGhpcy5jbG9uZU5vZGUodHJ1ZSkgKTsKCQkJCQlodG1sID0gZGl2LmlubmVySFRNTDsKCQkJCX0KCgkJCQlyZXR1cm4galF1ZXJ5LmNsZWFuKFtodG1sLnJlcGxhY2UocmlubGluZWpRdWVyeSwgIiIpCgkJCQkJLy8gSGFuZGxlIHRoZSBjYXNlIGluIElFIDggd2hlcmUgYWN0aW9uPS90ZXN0Lz4gc2VsZi1jbG9zZXMgYSB0YWcKCQkJCQkucmVwbGFjZSgvPShbXj0iJz5cc10rXC8pPi9nLCAnPSIkMSI+JykKCQkJCQkucmVwbGFjZShybGVhZGluZ1doaXRlc3BhY2UsICIiKV0sIG93bmVyRG9jdW1lbnQpWzBdOwoJCQl9IGVsc2UgewoJCQkJcmV0dXJuIHRoaXMuY2xvbmVOb2RlKHRydWUpOwoJCQl9CgkJfSk7CgoJCS8vIENvcHkgdGhlIGV2ZW50cyBmcm9tIHRoZSBvcmlnaW5hbCB0byB0aGUgY2xvbmUKCQlpZiAoIGV2ZW50cyA9PT0gdHJ1ZSApIHsKCQkJY2xvbmVDb3B5RXZlbnQoIHRoaXMsIHJldCApOwoJCQljbG9uZUNvcHlFdmVudCggdGhpcy5maW5kKCIqIiksIHJldC5maW5kKCIqIikgKTsKCQl9CgoJCS8vIFJldHVybiB0aGUgY2xvbmVkIHNldAoJCXJldHVybiByZXQ7Cgl9LAoKCWh0bWw6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQlpZiAoIHZhbHVlID09PSB1bmRlZmluZWQgKSB7CgkJCXJldHVybiB0aGlzWzBdICYmIHRoaXNbMF0ubm9kZVR5cGUgPT09IDEgPwoJCQkJdGhpc1swXS5pbm5lckhUTUwucmVwbGFjZShyaW5saW5lalF1ZXJ5LCAiIikgOgoJCQkJbnVsbDsKCgkJLy8gU2VlIGlmIHdlIGNhbiB0YWtlIGEgc2hvcnRjdXQgYW5kIGp1c3QgdXNlIGlubmVySFRNTAoJCX0gZWxzZSBpZiAoIHR5cGVvZiB2YWx1ZSA9PT0gInN0cmluZyIgJiYgIXJub2NhY2hlLnRlc3QoIHZhbHVlICkgJiYKCQkJKGpRdWVyeS5zdXBwb3J0LmxlYWRpbmdXaGl0ZXNwYWNlIHx8ICFybGVhZGluZ1doaXRlc3BhY2UudGVzdCggdmFsdWUgKSkgJiYKCQkJIXdyYXBNYXBbIChydGFnTmFtZS5leGVjKCB2YWx1ZSApIHx8IFsiIiwgIiJdKVsxXS50b0xvd2VyQ2FzZSgpIF0gKSB7CgoJCQl2YWx1ZSA9IHZhbHVlLnJlcGxhY2UocnhodG1sVGFnLCBmY2xvc2VUYWcpOwoKCQkJdHJ5IHsKCQkJCWZvciAoIHZhciBpID0gMCwgbCA9IHRoaXMubGVuZ3RoOyBpIDwgbDsgaSsrICkgewoJCQkJCS8vIFJlbW92ZSBlbGVtZW50IG5vZGVzIGFuZCBwcmV2ZW50IG1lbW9yeSBsZWFrcwoJCQkJCWlmICggdGhpc1tpXS5ub2RlVHlwZSA9PT0gMSApIHsKCQkJCQkJalF1ZXJ5LmNsZWFuRGF0YSggdGhpc1tpXS5nZXRFbGVtZW50c0J5VGFnTmFtZSgiKiIpICk7CgkJCQkJCXRoaXNbaV0uaW5uZXJIVE1MID0gdmFsdWU7CgkJCQkJfQoJCQkJfQoKCQkJLy8gSWYgdXNpbmcgaW5uZXJIVE1MIHRocm93cyBhbiBleGNlcHRpb24sIHVzZSB0aGUgZmFsbGJhY2sgbWV0aG9kCgkJCX0gY2F0Y2goZSkgewoJCQkJdGhpcy5lbXB0eSgpLmFwcGVuZCggdmFsdWUgKTsKCQkJfQoKCQl9IGVsc2UgaWYgKCBqUXVlcnkuaXNGdW5jdGlvbiggdmFsdWUgKSApIHsKCQkJdGhpcy5lYWNoKGZ1bmN0aW9uKGkpewoJCQkJdmFyIHNlbGYgPSBqUXVlcnkodGhpcyksIG9sZCA9IHNlbGYuaHRtbCgpOwoJCQkJc2VsZi5lbXB0eSgpLmFwcGVuZChmdW5jdGlvbigpewoJCQkJCXJldHVybiB2YWx1ZS5jYWxsKCB0aGlzLCBpLCBvbGQgKTsKCQkJCX0pOwoJCQl9KTsKCgkJfSBlbHNlIHsKCQkJdGhpcy5lbXB0eSgpLmFwcGVuZCggdmFsdWUgKTsKCQl9CgoJCXJldHVybiB0aGlzOwoJfSwKCglyZXBsYWNlV2l0aDogZnVuY3Rpb24oIHZhbHVlICkgewoJCWlmICggdGhpc1swXSAmJiB0aGlzWzBdLnBhcmVudE5vZGUgKSB7CgkJCS8vIE1ha2Ugc3VyZSB0aGF0IHRoZSBlbGVtZW50cyBhcmUgcmVtb3ZlZCBmcm9tIHRoZSBET00gYmVmb3JlIHRoZXkgYXJlIGluc2VydGVkCgkJCS8vIHRoaXMgY2FuIGhlbHAgZml4IHJlcGxhY2luZyBhIHBhcmVudCB3aXRoIGNoaWxkIGVsZW1lbnRzCgkJCWlmICggalF1ZXJ5LmlzRnVuY3Rpb24oIHZhbHVlICkgKSB7CgkJCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKGkpIHsKCQkJCQl2YXIgc2VsZiA9IGpRdWVyeSh0aGlzKSwgb2xkID0gc2VsZi5odG1sKCk7CgkJCQkJc2VsZi5yZXBsYWNlV2l0aCggdmFsdWUuY2FsbCggdGhpcywgaSwgb2xkICkgKTsKCQkJCX0pOwoJCQl9CgoJCQlpZiAoIHR5cGVvZiB2YWx1ZSAhPT0gInN0cmluZyIgKSB7CgkJCQl2YWx1ZSA9IGpRdWVyeSh2YWx1ZSkuZGV0YWNoKCk7CgkJCX0KCgkJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgkJCQl2YXIgbmV4dCA9IHRoaXMubmV4dFNpYmxpbmcsIHBhcmVudCA9IHRoaXMucGFyZW50Tm9kZTsKCgkJCQlqUXVlcnkodGhpcykucmVtb3ZlKCk7CgoJCQkJaWYgKCBuZXh0ICkgewoJCQkJCWpRdWVyeShuZXh0KS5iZWZvcmUoIHZhbHVlICk7CgkJCQl9IGVsc2UgewoJCQkJCWpRdWVyeShwYXJlbnQpLmFwcGVuZCggdmFsdWUgKTsKCQkJCX0KCQkJfSk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMucHVzaFN0YWNrKCBqUXVlcnkoalF1ZXJ5LmlzRnVuY3Rpb24odmFsdWUpID8gdmFsdWUoKSA6IHZhbHVlKSwgInJlcGxhY2VXaXRoIiwgdmFsdWUgKTsKCQl9Cgl9LAoKCWRldGFjaDogZnVuY3Rpb24oIHNlbGVjdG9yICkgewoJCXJldHVybiB0aGlzLnJlbW92ZSggc2VsZWN0b3IsIHRydWUgKTsKCX0sCgoJZG9tTWFuaXA6IGZ1bmN0aW9uKCBhcmdzLCB0YWJsZSwgY2FsbGJhY2sgKSB7CgkJdmFyIHJlc3VsdHMsIGZpcnN0LCB2YWx1ZSA9IGFyZ3NbMF0sIHNjcmlwdHMgPSBbXSwgZnJhZ21lbnQsIHBhcmVudDsKCgkJLy8gV2UgY2FuJ3QgY2xvbmVOb2RlIGZyYWdtZW50cyB0aGF0IGNvbnRhaW4gY2hlY2tlZCwgaW4gV2ViS2l0CgkJaWYgKCAhalF1ZXJ5LnN1cHBvcnQuY2hlY2tDbG9uZSAmJiBhcmd1bWVudHMubGVuZ3RoID09PSAzICYmIHR5cGVvZiB2YWx1ZSA9PT0gInN0cmluZyIgJiYgcmNoZWNrZWQudGVzdCggdmFsdWUgKSApIHsKCQkJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJCWpRdWVyeSh0aGlzKS5kb21NYW5pcCggYXJncywgdGFibGUsIGNhbGxiYWNrLCB0cnVlICk7CgkJCX0pOwoJCX0KCgkJaWYgKCBqUXVlcnkuaXNGdW5jdGlvbih2YWx1ZSkgKSB7CgkJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oaSkgewoJCQkJdmFyIHNlbGYgPSBqUXVlcnkodGhpcyk7CgkJCQlhcmdzWzBdID0gdmFsdWUuY2FsbCh0aGlzLCBpLCB0YWJsZSA/IHNlbGYuaHRtbCgpIDogdW5kZWZpbmVkKTsKCQkJCXNlbGYuZG9tTWFuaXAoIGFyZ3MsIHRhYmxlLCBjYWxsYmFjayApOwoJCQl9KTsKCQl9CgoJCWlmICggdGhpc1swXSApIHsKCQkJcGFyZW50ID0gdmFsdWUgJiYgdmFsdWUucGFyZW50Tm9kZTsKCgkJCS8vIElmIHdlJ3JlIGluIGEgZnJhZ21lbnQsIGp1c3QgdXNlIHRoYXQgaW5zdGVhZCBvZiBidWlsZGluZyBhIG5ldyBvbmUKCQkJaWYgKCBqUXVlcnkuc3VwcG9ydC5wYXJlbnROb2RlICYmIHBhcmVudCAmJiBwYXJlbnQubm9kZVR5cGUgPT09IDExICYmIHBhcmVudC5jaGlsZE5vZGVzLmxlbmd0aCA9PT0gdGhpcy5sZW5ndGggKSB7CgkJCQlyZXN1bHRzID0geyBmcmFnbWVudDogcGFyZW50IH07CgoJCQl9IGVsc2UgewoJCQkJcmVzdWx0cyA9IGJ1aWxkRnJhZ21lbnQoIGFyZ3MsIHRoaXMsIHNjcmlwdHMgKTsKCQkJfQoJCQkKCQkJZnJhZ21lbnQgPSByZXN1bHRzLmZyYWdtZW50OwoJCQkKCQkJaWYgKCBmcmFnbWVudC5jaGlsZE5vZGVzLmxlbmd0aCA9PT0gMSApIHsKCQkJCWZpcnN0ID0gZnJhZ21lbnQgPSBmcmFnbWVudC5maXJzdENoaWxkOwoJCQl9IGVsc2UgewoJCQkJZmlyc3QgPSBmcmFnbWVudC5maXJzdENoaWxkOwoJCQl9CgoJCQlpZiAoIGZpcnN0ICkgewoJCQkJdGFibGUgPSB0YWJsZSAmJiBqUXVlcnkubm9kZU5hbWUoIGZpcnN0LCAidHIiICk7CgoJCQkJZm9yICggdmFyIGkgPSAwLCBsID0gdGhpcy5sZW5ndGg7IGkgPCBsOyBpKysgKSB7CgkJCQkJY2FsbGJhY2suY2FsbCgKCQkJCQkJdGFibGUgPwoJCQkJCQkJcm9vdCh0aGlzW2ldLCBmaXJzdCkgOgoJCQkJCQkJdGhpc1tpXSwKCQkJCQkJaSA+IDAgfHwgcmVzdWx0cy5jYWNoZWFibGUgfHwgdGhpcy5sZW5ndGggPiAxICA/CgkJCQkJCQlmcmFnbWVudC5jbG9uZU5vZGUodHJ1ZSkgOgoJCQkJCQkJZnJhZ21lbnQKCQkJCQkpOwoJCQkJfQoJCQl9CgoJCQlpZiAoIHNjcmlwdHMubGVuZ3RoICkgewoJCQkJalF1ZXJ5LmVhY2goIHNjcmlwdHMsIGV2YWxTY3JpcHQgKTsKCQkJfQoJCX0KCgkJcmV0dXJuIHRoaXM7CgoJCWZ1bmN0aW9uIHJvb3QoIGVsZW0sIGN1ciApIHsKCQkJcmV0dXJuIGpRdWVyeS5ub2RlTmFtZShlbGVtLCAidGFibGUiKSA/CgkJCQkoZWxlbS5nZXRFbGVtZW50c0J5VGFnTmFtZSgidGJvZHkiKVswXSB8fAoJCQkJZWxlbS5hcHBlbmRDaGlsZChlbGVtLm93bmVyRG9jdW1lbnQuY3JlYXRlRWxlbWVudCgidGJvZHkiKSkpIDoKCQkJCWVsZW07CgkJfQoJfQp9KTsKCmZ1bmN0aW9uIGNsb25lQ29weUV2ZW50KG9yaWcsIHJldCkgewoJdmFyIGkgPSAwOwoKCXJldC5lYWNoKGZ1bmN0aW9uKCkgewoJCWlmICggdGhpcy5ub2RlTmFtZSAhPT0gKG9yaWdbaV0gJiYgb3JpZ1tpXS5ub2RlTmFtZSkgKSB7CgkJCXJldHVybjsKCQl9CgoJCXZhciBvbGREYXRhID0galF1ZXJ5LmRhdGEoIG9yaWdbaSsrXSApLCBjdXJEYXRhID0galF1ZXJ5LmRhdGEoIHRoaXMsIG9sZERhdGEgKSwgZXZlbnRzID0gb2xkRGF0YSAmJiBvbGREYXRhLmV2ZW50czsKCgkJaWYgKCBldmVudHMgKSB7CgkJCWRlbGV0ZSBjdXJEYXRhLmhhbmRsZTsKCQkJY3VyRGF0YS5ldmVudHMgPSB7fTsKCgkJCWZvciAoIHZhciB0eXBlIGluIGV2ZW50cyApIHsKCQkJCWZvciAoIHZhciBoYW5kbGVyIGluIGV2ZW50c1sgdHlwZSBdICkgewoJCQkJCWpRdWVyeS5ldmVudC5hZGQoIHRoaXMsIHR5cGUsIGV2ZW50c1sgdHlwZSBdWyBoYW5kbGVyIF0sIGV2ZW50c1sgdHlwZSBdWyBoYW5kbGVyIF0uZGF0YSApOwoJCQkJfQoJCQl9CgkJfQoJfSk7Cn0KCmZ1bmN0aW9uIGJ1aWxkRnJhZ21lbnQoIGFyZ3MsIG5vZGVzLCBzY3JpcHRzICkgewoJdmFyIGZyYWdtZW50LCBjYWNoZWFibGUsIGNhY2hlcmVzdWx0cywKCQlkb2MgPSAobm9kZXMgJiYgbm9kZXNbMF0gPyBub2Rlc1swXS5vd25lckRvY3VtZW50IHx8IG5vZGVzWzBdIDogZG9jdW1lbnQpOwoKCS8vIE9ubHkgY2FjaGUgInNtYWxsIiAoMS8yIEtCKSBzdHJpbmdzIHRoYXQgYXJlIGFzc29jaWF0ZWQgd2l0aCB0aGUgbWFpbiBkb2N1bWVudAoJLy8gQ2xvbmluZyBvcHRpb25zIGxvc2VzIHRoZSBzZWxlY3RlZCBzdGF0ZSwgc28gZG9uJ3QgY2FjaGUgdGhlbQoJLy8gSUUgNiBkb2Vzbid0IGxpa2UgaXQgd2hlbiB5b3UgcHV0IDxvYmplY3Q+IG9yIDxlbWJlZD4gZWxlbWVudHMgaW4gYSBmcmFnbWVudAoJLy8gQWxzbywgV2ViS2l0IGRvZXMgbm90IGNsb25lICdjaGVja2VkJyBhdHRyaWJ1dGVzIG9uIGNsb25lTm9kZSwgc28gZG9uJ3QgY2FjaGUKCWlmICggYXJncy5sZW5ndGggPT09IDEgJiYgdHlwZW9mIGFyZ3NbMF0gPT09ICJzdHJpbmciICYmIGFyZ3NbMF0ubGVuZ3RoIDwgNTEyICYmIGRvYyA9PT0gZG9jdW1lbnQgJiYKCQkhcm5vY2FjaGUudGVzdCggYXJnc1swXSApICYmIChqUXVlcnkuc3VwcG9ydC5jaGVja0Nsb25lIHx8ICFyY2hlY2tlZC50ZXN0KCBhcmdzWzBdICkpICkgewoKCQljYWNoZWFibGUgPSB0cnVlOwoJCWNhY2hlcmVzdWx0cyA9IGpRdWVyeS5mcmFnbWVudHNbIGFyZ3NbMF0gXTsKCQlpZiAoIGNhY2hlcmVzdWx0cyApIHsKCQkJaWYgKCBjYWNoZXJlc3VsdHMgIT09IDEgKSB7CgkJCQlmcmFnbWVudCA9IGNhY2hlcmVzdWx0czsKCQkJfQoJCX0KCX0KCglpZiAoICFmcmFnbWVudCApIHsKCQlmcmFnbWVudCA9IGRvYy5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCk7CgkJalF1ZXJ5LmNsZWFuKCBhcmdzLCBkb2MsIGZyYWdtZW50LCBzY3JpcHRzICk7Cgl9CgoJaWYgKCBjYWNoZWFibGUgKSB7CgkJalF1ZXJ5LmZyYWdtZW50c1sgYXJnc1swXSBdID0gY2FjaGVyZXN1bHRzID8gZnJhZ21lbnQgOiAxOwoJfQoKCXJldHVybiB7IGZyYWdtZW50OiBmcmFnbWVudCwgY2FjaGVhYmxlOiBjYWNoZWFibGUgfTsKfQoKalF1ZXJ5LmZyYWdtZW50cyA9IHt9OwoKalF1ZXJ5LmVhY2goewoJYXBwZW5kVG86ICJhcHBlbmQiLAoJcHJlcGVuZFRvOiAicHJlcGVuZCIsCglpbnNlcnRCZWZvcmU6ICJiZWZvcmUiLAoJaW5zZXJ0QWZ0ZXI6ICJhZnRlciIsCglyZXBsYWNlQWxsOiAicmVwbGFjZVdpdGgiCn0sIGZ1bmN0aW9uKCBuYW1lLCBvcmlnaW5hbCApIHsKCWpRdWVyeS5mblsgbmFtZSBdID0gZnVuY3Rpb24oIHNlbGVjdG9yICkgewoJCXZhciByZXQgPSBbXSwgaW5zZXJ0ID0galF1ZXJ5KCBzZWxlY3RvciApLAoJCQlwYXJlbnQgPSB0aGlzLmxlbmd0aCA9PT0gMSAmJiB0aGlzWzBdLnBhcmVudE5vZGU7CgkJCgkJaWYgKCBwYXJlbnQgJiYgcGFyZW50Lm5vZGVUeXBlID09PSAxMSAmJiBwYXJlbnQuY2hpbGROb2Rlcy5sZW5ndGggPT09IDEgJiYgaW5zZXJ0Lmxlbmd0aCA9PT0gMSApIHsKCQkJaW5zZXJ0WyBvcmlnaW5hbCBdKCB0aGlzWzBdICk7CgkJCXJldHVybiB0aGlzOwoJCQkKCQl9IGVsc2UgewoJCQlmb3IgKCB2YXIgaSA9IDAsIGwgPSBpbnNlcnQubGVuZ3RoOyBpIDwgbDsgaSsrICkgewoJCQkJdmFyIGVsZW1zID0gKGkgPiAwID8gdGhpcy5jbG9uZSh0cnVlKSA6IHRoaXMpLmdldCgpOwoJCQkJalF1ZXJ5LmZuWyBvcmlnaW5hbCBdLmFwcGx5KCBqUXVlcnkoaW5zZXJ0W2ldKSwgZWxlbXMgKTsKCQkJCXJldCA9IHJldC5jb25jYXQoIGVsZW1zICk7CgkJCX0KCQkKCQkJcmV0dXJuIHRoaXMucHVzaFN0YWNrKCByZXQsIG5hbWUsIGluc2VydC5zZWxlY3RvciApOwoJCX0KCX07Cn0pOwoKalF1ZXJ5LmV4dGVuZCh7CgljbGVhbjogZnVuY3Rpb24oIGVsZW1zLCBjb250ZXh0LCBmcmFnbWVudCwgc2NyaXB0cyApIHsKCQljb250ZXh0ID0gY29udGV4dCB8fCBkb2N1bWVudDsKCgkJLy8gIWNvbnRleHQuY3JlYXRlRWxlbWVudCBmYWlscyBpbiBJRSB3aXRoIGFuIGVycm9yIGJ1dCByZXR1cm5zIHR5cGVvZiAnb2JqZWN0JwoJCWlmICggdHlwZW9mIGNvbnRleHQuY3JlYXRlRWxlbWVudCA9PT0gInVuZGVmaW5lZCIgKSB7CgkJCWNvbnRleHQgPSBjb250ZXh0Lm93bmVyRG9jdW1lbnQgfHwgY29udGV4dFswXSAmJiBjb250ZXh0WzBdLm93bmVyRG9jdW1lbnQgfHwgZG9jdW1lbnQ7CgkJfQoKCQl2YXIgcmV0ID0gW107CgoJCWZvciAoIHZhciBpID0gMCwgZWxlbTsgKGVsZW0gPSBlbGVtc1tpXSkgIT0gbnVsbDsgaSsrICkgewoJCQlpZiAoIHR5cGVvZiBlbGVtID09PSAibnVtYmVyIiApIHsKCQkJCWVsZW0gKz0gIiI7CgkJCX0KCgkJCWlmICggIWVsZW0gKSB7CgkJCQljb250aW51ZTsKCQkJfQoKCQkJLy8gQ29udmVydCBodG1sIHN0cmluZyBpbnRvIERPTSBub2RlcwoJCQlpZiAoIHR5cGVvZiBlbGVtID09PSAic3RyaW5nIiAmJiAhcmh0bWwudGVzdCggZWxlbSApICkgewoJCQkJZWxlbSA9IGNvbnRleHQuY3JlYXRlVGV4dE5vZGUoIGVsZW0gKTsKCgkJCX0gZWxzZSBpZiAoIHR5cGVvZiBlbGVtID09PSAic3RyaW5nIiApIHsKCQkJCS8vIEZpeCAiWEhUTUwiLXN0eWxlIHRhZ3MgaW4gYWxsIGJyb3dzZXJzCgkJCQllbGVtID0gZWxlbS5yZXBsYWNlKHJ4aHRtbFRhZywgZmNsb3NlVGFnKTsKCgkJCQkvLyBUcmltIHdoaXRlc3BhY2UsIG90aGVyd2lzZSBpbmRleE9mIHdvbid0IHdvcmsgYXMgZXhwZWN0ZWQKCQkJCXZhciB0YWcgPSAocnRhZ05hbWUuZXhlYyggZWxlbSApIHx8IFsiIiwgIiJdKVsxXS50b0xvd2VyQ2FzZSgpLAoJCQkJCXdyYXAgPSB3cmFwTWFwWyB0YWcgXSB8fCB3cmFwTWFwLl9kZWZhdWx0LAoJCQkJCWRlcHRoID0gd3JhcFswXSwKCQkJCQlkaXYgPSBjb250ZXh0LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwoKCQkJCS8vIEdvIHRvIGh0bWwgYW5kIGJhY2ssIHRoZW4gcGVlbCBvZmYgZXh0cmEgd3JhcHBlcnMKCQkJCWRpdi5pbm5lckhUTUwgPSB3cmFwWzFdICsgZWxlbSArIHdyYXBbMl07CgoJCQkJLy8gTW92ZSB0byB0aGUgcmlnaHQgZGVwdGgKCQkJCXdoaWxlICggZGVwdGgtLSApIHsKCQkJCQlkaXYgPSBkaXYubGFzdENoaWxkOwoJCQkJfQoKCQkJCS8vIFJlbW92ZSBJRSdzIGF1dG9pbnNlcnRlZCA8dGJvZHk+IGZyb20gdGFibGUgZnJhZ21lbnRzCgkJCQlpZiAoICFqUXVlcnkuc3VwcG9ydC50Ym9keSApIHsKCgkJCQkJLy8gU3RyaW5nIHdhcyBhIDx0YWJsZT4sICptYXkqIGhhdmUgc3B1cmlvdXMgPHRib2R5PgoJCQkJCXZhciBoYXNCb2R5ID0gcnRib2R5LnRlc3QoZWxlbSksCgkJCQkJCXRib2R5ID0gdGFnID09PSAidGFibGUiICYmICFoYXNCb2R5ID8KCQkJCQkJCWRpdi5maXJzdENoaWxkICYmIGRpdi5maXJzdENoaWxkLmNoaWxkTm9kZXMgOgoKCQkJCQkJCS8vIFN0cmluZyB3YXMgYSBiYXJlIDx0aGVhZD4gb3IgPHRmb290PgoJCQkJCQkJd3JhcFsxXSA9PT0gIjx0YWJsZT4iICYmICFoYXNCb2R5ID8KCQkJCQkJCQlkaXYuY2hpbGROb2RlcyA6CgkJCQkJCQkJW107CgoJCQkJCWZvciAoIHZhciBqID0gdGJvZHkubGVuZ3RoIC0gMTsgaiA+PSAwIDsgLS1qICkgewoJCQkJCQlpZiAoIGpRdWVyeS5ub2RlTmFtZSggdGJvZHlbIGogXSwgInRib2R5IiApICYmICF0Ym9keVsgaiBdLmNoaWxkTm9kZXMubGVuZ3RoICkgewoJCQkJCQkJdGJvZHlbIGogXS5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKCB0Ym9keVsgaiBdICk7CgkJCQkJCX0KCQkJCQl9CgoJCQkJfQoKCQkJCS8vIElFIGNvbXBsZXRlbHkga2lsbHMgbGVhZGluZyB3aGl0ZXNwYWNlIHdoZW4gaW5uZXJIVE1MIGlzIHVzZWQKCQkJCWlmICggIWpRdWVyeS5zdXBwb3J0LmxlYWRpbmdXaGl0ZXNwYWNlICYmIHJsZWFkaW5nV2hpdGVzcGFjZS50ZXN0KCBlbGVtICkgKSB7CgkJCQkJZGl2Lmluc2VydEJlZm9yZSggY29udGV4dC5jcmVhdGVUZXh0Tm9kZSggcmxlYWRpbmdXaGl0ZXNwYWNlLmV4ZWMoZWxlbSlbMF0gKSwgZGl2LmZpcnN0Q2hpbGQgKTsKCQkJCX0KCgkJCQllbGVtID0gZGl2LmNoaWxkTm9kZXM7CgkJCX0KCgkJCWlmICggZWxlbS5ub2RlVHlwZSApIHsKCQkJCXJldC5wdXNoKCBlbGVtICk7CgkJCX0gZWxzZSB7CgkJCQlyZXQgPSBqUXVlcnkubWVyZ2UoIHJldCwgZWxlbSApOwoJCQl9CgkJfQoKCQlpZiAoIGZyYWdtZW50ICkgewoJCQlmb3IgKCB2YXIgaSA9IDA7IHJldFtpXTsgaSsrICkgewoJCQkJaWYgKCBzY3JpcHRzICYmIGpRdWVyeS5ub2RlTmFtZSggcmV0W2ldLCAic2NyaXB0IiApICYmICghcmV0W2ldLnR5cGUgfHwgcmV0W2ldLnR5cGUudG9Mb3dlckNhc2UoKSA9PT0gInRleHQvamF2YXNjcmlwdCIpICkgewoJCQkJCXNjcmlwdHMucHVzaCggcmV0W2ldLnBhcmVudE5vZGUgPyByZXRbaV0ucGFyZW50Tm9kZS5yZW1vdmVDaGlsZCggcmV0W2ldICkgOiByZXRbaV0gKTsKCQkJCQoJCQkJfSBlbHNlIHsKCQkJCQlpZiAoIHJldFtpXS5ub2RlVHlwZSA9PT0gMSApIHsKCQkJCQkJcmV0LnNwbGljZS5hcHBseSggcmV0LCBbaSArIDEsIDBdLmNvbmNhdChqUXVlcnkubWFrZUFycmF5KHJldFtpXS5nZXRFbGVtZW50c0J5VGFnTmFtZSgic2NyaXB0IikpKSApOwoJCQkJCX0KCQkJCQlmcmFnbWVudC5hcHBlbmRDaGlsZCggcmV0W2ldICk7CgkJCQl9CgkJCX0KCQl9CgoJCXJldHVybiByZXQ7Cgl9LAoJCgljbGVhbkRhdGE6IGZ1bmN0aW9uKCBlbGVtcyApIHsKCQl2YXIgZGF0YSwgaWQsIGNhY2hlID0galF1ZXJ5LmNhY2hlLAoJCQlzcGVjaWFsID0galF1ZXJ5LmV2ZW50LnNwZWNpYWwsCgkJCWRlbGV0ZUV4cGFuZG8gPSBqUXVlcnkuc3VwcG9ydC5kZWxldGVFeHBhbmRvOwoJCQoJCWZvciAoIHZhciBpID0gMCwgZWxlbTsgKGVsZW0gPSBlbGVtc1tpXSkgIT0gbnVsbDsgaSsrICkgewoJCQlpZCA9IGVsZW1bIGpRdWVyeS5leHBhbmRvIF07CgkJCQoJCQlpZiAoIGlkICkgewoJCQkJZGF0YSA9IGNhY2hlWyBpZCBdOwoJCQkJCgkJCQlpZiAoIGRhdGEuZXZlbnRzICkgewoJCQkJCWZvciAoIHZhciB0eXBlIGluIGRhdGEuZXZlbnRzICkgewoJCQkJCQlpZiAoIHNwZWNpYWxbIHR5cGUgXSApIHsKCQkJCQkJCWpRdWVyeS5ldmVudC5yZW1vdmUoIGVsZW0sIHR5cGUgKTsKCgkJCQkJCX0gZWxzZSB7CgkJCQkJCQlyZW1vdmVFdmVudCggZWxlbSwgdHlwZSwgZGF0YS5oYW5kbGUgKTsKCQkJCQkJfQoJCQkJCX0KCQkJCX0KCQkJCQoJCQkJaWYgKCBkZWxldGVFeHBhbmRvICkgewoJCQkJCWRlbGV0ZSBlbGVtWyBqUXVlcnkuZXhwYW5kbyBdOwoKCQkJCX0gZWxzZSBpZiAoIGVsZW0ucmVtb3ZlQXR0cmlidXRlICkgewoJCQkJCWVsZW0ucmVtb3ZlQXR0cmlidXRlKCBqUXVlcnkuZXhwYW5kbyApOwoJCQkJfQoJCQkJCgkJCQlkZWxldGUgY2FjaGVbIGlkIF07CgkJCX0KCQl9Cgl9Cn0pOwovLyBleGNsdWRlIHRoZSBmb2xsb3dpbmcgY3NzIHByb3BlcnRpZXMgdG8gYWRkIHB4CnZhciByZXhjbHVkZSA9IC96LT9pbmRleHxmb250LT93ZWlnaHR8b3BhY2l0eXx6b29tfGxpbmUtP2hlaWdodC9pLAoJcmFscGhhID0gL2FscGhhXChbXildKlwpLywKCXJvcGFjaXR5ID0gL29wYWNpdHk9KFteKV0qKS8sCglyZmxvYXQgPSAvZmxvYXQvaSwKCXJkYXNoQWxwaGEgPSAvLShbYS16XSkvaWcsCglydXBwZXIgPSAvKFtBLVpdKS9nLAoJcm51bXB4ID0gL14tP1xkKyg/OnB4KT8kL2ksCglybnVtID0gL14tP1xkLywKCgljc3NTaG93ID0geyBwb3NpdGlvbjogImFic29sdXRlIiwgdmlzaWJpbGl0eTogImhpZGRlbiIsIGRpc3BsYXk6ImJsb2NrIiB9LAoJY3NzV2lkdGggPSBbICJMZWZ0IiwgIlJpZ2h0IiBdLAoJY3NzSGVpZ2h0ID0gWyAiVG9wIiwgIkJvdHRvbSIgXSwKCgkvLyBjYWNoZSBjaGVjayBmb3IgZGVmYXVsdFZpZXcuZ2V0Q29tcHV0ZWRTdHlsZQoJZ2V0Q29tcHV0ZWRTdHlsZSA9IGRvY3VtZW50LmRlZmF1bHRWaWV3ICYmIGRvY3VtZW50LmRlZmF1bHRWaWV3LmdldENvbXB1dGVkU3R5bGUsCgkvLyBub3JtYWxpemUgZmxvYXQgY3NzIHByb3BlcnR5CglzdHlsZUZsb2F0ID0galF1ZXJ5LnN1cHBvcnQuY3NzRmxvYXQgPyAiY3NzRmxvYXQiIDogInN0eWxlRmxvYXQiLAoJZmNhbWVsQ2FzZSA9IGZ1bmN0aW9uKCBhbGwsIGxldHRlciApIHsKCQlyZXR1cm4gbGV0dGVyLnRvVXBwZXJDYXNlKCk7Cgl9OwoKalF1ZXJ5LmZuLmNzcyA9IGZ1bmN0aW9uKCBuYW1lLCB2YWx1ZSApIHsKCXJldHVybiBhY2Nlc3MoIHRoaXMsIG5hbWUsIHZhbHVlLCB0cnVlLCBmdW5jdGlvbiggZWxlbSwgbmFtZSwgdmFsdWUgKSB7CgkJaWYgKCB2YWx1ZSA9PT0gdW5kZWZpbmVkICkgewoJCQlyZXR1cm4galF1ZXJ5LmN1ckNTUyggZWxlbSwgbmFtZSApOwoJCX0KCQkKCQlpZiAoIHR5cGVvZiB2YWx1ZSA9PT0gIm51bWJlciIgJiYgIXJleGNsdWRlLnRlc3QobmFtZSkgKSB7CgkJCXZhbHVlICs9ICJweCI7CgkJfQoKCQlqUXVlcnkuc3R5bGUoIGVsZW0sIG5hbWUsIHZhbHVlICk7Cgl9KTsKfTsKCmpRdWVyeS5leHRlbmQoewoJc3R5bGU6IGZ1bmN0aW9uKCBlbGVtLCBuYW1lLCB2YWx1ZSApIHsKCQkvLyBkb24ndCBzZXQgc3R5bGVzIG9uIHRleHQgYW5kIGNvbW1lbnQgbm9kZXMKCQlpZiAoICFlbGVtIHx8IGVsZW0ubm9kZVR5cGUgPT09IDMgfHwgZWxlbS5ub2RlVHlwZSA9PT0gOCApIHsKCQkJcmV0dXJuIHVuZGVmaW5lZDsKCQl9CgoJCS8vIGlnbm9yZSBuZWdhdGl2ZSB3aWR0aCBhbmQgaGVpZ2h0IHZhbHVlcyAjMTU5OQoJCWlmICggKG5hbWUgPT09ICJ3aWR0aCIgfHwgbmFtZSA9PT0gImhlaWdodCIpICYmIHBhcnNlRmxvYXQodmFsdWUpIDwgMCApIHsKCQkJdmFsdWUgPSB1bmRlZmluZWQ7CgkJfQoKCQl2YXIgc3R5bGUgPSBlbGVtLnN0eWxlIHx8IGVsZW0sIHNldCA9IHZhbHVlICE9PSB1bmRlZmluZWQ7CgoJCS8vIElFIHVzZXMgZmlsdGVycyBmb3Igb3BhY2l0eQoJCWlmICggIWpRdWVyeS5zdXBwb3J0Lm9wYWNpdHkgJiYgbmFtZSA9PT0gIm9wYWNpdHkiICkgewoJCQlpZiAoIHNldCApIHsKCQkJCS8vIElFIGhhcyB0cm91YmxlIHdpdGggb3BhY2l0eSBpZiBpdCBkb2VzIG5vdCBoYXZlIGxheW91dAoJCQkJLy8gRm9yY2UgaXQgYnkgc2V0dGluZyB0aGUgem9vbSBsZXZlbAoJCQkJc3R5bGUuem9vbSA9IDE7CgoJCQkJLy8gU2V0IHRoZSBhbHBoYSBmaWx0ZXIgdG8gc2V0IHRoZSBvcGFjaXR5CgkJCQl2YXIgb3BhY2l0eSA9IHBhcnNlSW50KCB2YWx1ZSwgMTAgKSArICIiID09PSAiTmFOIiA/ICIiIDogImFscGhhKG9wYWNpdHk9IiArIHZhbHVlICogMTAwICsgIikiOwoJCQkJdmFyIGZpbHRlciA9IHN0eWxlLmZpbHRlciB8fCBqUXVlcnkuY3VyQ1NTKCBlbGVtLCAiZmlsdGVyIiApIHx8ICIiOwoJCQkJc3R5bGUuZmlsdGVyID0gcmFscGhhLnRlc3QoZmlsdGVyKSA/IGZpbHRlci5yZXBsYWNlKHJhbHBoYSwgb3BhY2l0eSkgOiBvcGFjaXR5OwoJCQl9CgoJCQlyZXR1cm4gc3R5bGUuZmlsdGVyICYmIHN0eWxlLmZpbHRlci5pbmRleE9mKCJvcGFjaXR5PSIpID49IDAgPwoJCQkJKHBhcnNlRmxvYXQoIHJvcGFjaXR5LmV4ZWMoc3R5bGUuZmlsdGVyKVsxXSApIC8gMTAwKSArICIiOgoJCQkJIiI7CgkJfQoKCQkvLyBNYWtlIHN1cmUgd2UncmUgdXNpbmcgdGhlIHJpZ2h0IG5hbWUgZm9yIGdldHRpbmcgdGhlIGZsb2F0IHZhbHVlCgkJaWYgKCByZmxvYXQudGVzdCggbmFtZSApICkgewoJCQluYW1lID0gc3R5bGVGbG9hdDsKCQl9CgoJCW5hbWUgPSBuYW1lLnJlcGxhY2UocmRhc2hBbHBoYSwgZmNhbWVsQ2FzZSk7CgoJCWlmICggc2V0ICkgewoJCQlzdHlsZVsgbmFtZSBdID0gdmFsdWU7CgkJfQoKCQlyZXR1cm4gc3R5bGVbIG5hbWUgXTsKCX0sCgoJY3NzOiBmdW5jdGlvbiggZWxlbSwgbmFtZSwgZm9yY2UsIGV4dHJhICkgewoJCWlmICggbmFtZSA9PT0gIndpZHRoIiB8fCBuYW1lID09PSAiaGVpZ2h0IiApIHsKCQkJdmFyIHZhbCwgcHJvcHMgPSBjc3NTaG93LCB3aGljaCA9IG5hbWUgPT09ICJ3aWR0aCIgPyBjc3NXaWR0aCA6IGNzc0hlaWdodDsKCgkJCWZ1bmN0aW9uIGdldFdIKCkgewoJCQkJdmFsID0gbmFtZSA9PT0gIndpZHRoIiA/IGVsZW0ub2Zmc2V0V2lkdGggOiBlbGVtLm9mZnNldEhlaWdodDsKCgkJCQlpZiAoIGV4dHJhID09PSAiYm9yZGVyIiApIHsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJalF1ZXJ5LmVhY2goIHdoaWNoLCBmdW5jdGlvbigpIHsKCQkJCQlpZiAoICFleHRyYSApIHsKCQkJCQkJdmFsIC09IHBhcnNlRmxvYXQoalF1ZXJ5LmN1ckNTUyggZWxlbSwgInBhZGRpbmciICsgdGhpcywgdHJ1ZSkpIHx8IDA7CgkJCQkJfQoKCQkJCQlpZiAoIGV4dHJhID09PSAibWFyZ2luIiApIHsKCQkJCQkJdmFsICs9IHBhcnNlRmxvYXQoalF1ZXJ5LmN1ckNTUyggZWxlbSwgIm1hcmdpbiIgKyB0aGlzLCB0cnVlKSkgfHwgMDsKCQkJCQl9IGVsc2UgewoJCQkJCQl2YWwgLT0gcGFyc2VGbG9hdChqUXVlcnkuY3VyQ1NTKCBlbGVtLCAiYm9yZGVyIiArIHRoaXMgKyAiV2lkdGgiLCB0cnVlKSkgfHwgMDsKCQkJCQl9CgkJCQl9KTsKCQkJfQoKCQkJaWYgKCBlbGVtLm9mZnNldFdpZHRoICE9PSAwICkgewoJCQkJZ2V0V0goKTsKCQkJfSBlbHNlIHsKCQkJCWpRdWVyeS5zd2FwKCBlbGVtLCBwcm9wcywgZ2V0V0ggKTsKCQkJfQoKCQkJcmV0dXJuIE1hdGgubWF4KDAsIE1hdGgucm91bmQodmFsKSk7CgkJfQoKCQlyZXR1cm4galF1ZXJ5LmN1ckNTUyggZWxlbSwgbmFtZSwgZm9yY2UgKTsKCX0sCgoJY3VyQ1NTOiBmdW5jdGlvbiggZWxlbSwgbmFtZSwgZm9yY2UgKSB7CgkJdmFyIHJldCwgc3R5bGUgPSBlbGVtLnN0eWxlLCBmaWx0ZXI7CgoJCS8vIElFIHVzZXMgZmlsdGVycyBmb3Igb3BhY2l0eQoJCWlmICggIWpRdWVyeS5zdXBwb3J0Lm9wYWNpdHkgJiYgbmFtZSA9PT0gIm9wYWNpdHkiICYmIGVsZW0uY3VycmVudFN0eWxlICkgewoJCQlyZXQgPSByb3BhY2l0eS50ZXN0KGVsZW0uY3VycmVudFN0eWxlLmZpbHRlciB8fCAiIikgPwoJCQkJKHBhcnNlRmxvYXQoUmVnRXhwLiQxKSAvIDEwMCkgKyAiIiA6CgkJCQkiIjsKCgkJCXJldHVybiByZXQgPT09ICIiID8KCQkJCSIxIiA6CgkJCQlyZXQ7CgkJfQoKCQkvLyBNYWtlIHN1cmUgd2UncmUgdXNpbmcgdGhlIHJpZ2h0IG5hbWUgZm9yIGdldHRpbmcgdGhlIGZsb2F0IHZhbHVlCgkJaWYgKCByZmxvYXQudGVzdCggbmFtZSApICkgewoJCQluYW1lID0gc3R5bGVGbG9hdDsKCQl9CgoJCWlmICggIWZvcmNlICYmIHN0eWxlICYmIHN0eWxlWyBuYW1lIF0gKSB7CgkJCXJldCA9IHN0eWxlWyBuYW1lIF07CgoJCX0gZWxzZSBpZiAoIGdldENvbXB1dGVkU3R5bGUgKSB7CgoJCQkvLyBPbmx5ICJmbG9hdCIgaXMgbmVlZGVkIGhlcmUKCQkJaWYgKCByZmxvYXQudGVzdCggbmFtZSApICkgewoJCQkJbmFtZSA9ICJmbG9hdCI7CgkJCX0KCgkJCW5hbWUgPSBuYW1lLnJlcGxhY2UoIHJ1cHBlciwgIi0kMSIgKS50b0xvd2VyQ2FzZSgpOwoKCQkJdmFyIGRlZmF1bHRWaWV3ID0gZWxlbS5vd25lckRvY3VtZW50LmRlZmF1bHRWaWV3OwoKCQkJaWYgKCAhZGVmYXVsdFZpZXcgKSB7CgkJCQlyZXR1cm4gbnVsbDsKCQkJfQoKCQkJdmFyIGNvbXB1dGVkU3R5bGUgPSBkZWZhdWx0Vmlldy5nZXRDb21wdXRlZFN0eWxlKCBlbGVtLCBudWxsICk7CgoJCQlpZiAoIGNvbXB1dGVkU3R5bGUgKSB7CgkJCQlyZXQgPSBjb21wdXRlZFN0eWxlLmdldFByb3BlcnR5VmFsdWUoIG5hbWUgKTsKCQkJfQoKCQkJLy8gV2Ugc2hvdWxkIGFsd2F5cyBnZXQgYSBudW1iZXIgYmFjayBmcm9tIG9wYWNpdHkKCQkJaWYgKCBuYW1lID09PSAib3BhY2l0eSIgJiYgcmV0ID09PSAiIiApIHsKCQkJCXJldCA9ICIxIjsKCQkJfQoKCQl9IGVsc2UgaWYgKCBlbGVtLmN1cnJlbnRTdHlsZSApIHsKCQkJdmFyIGNhbWVsQ2FzZSA9IG5hbWUucmVwbGFjZShyZGFzaEFscGhhLCBmY2FtZWxDYXNlKTsKCgkJCXJldCA9IGVsZW0uY3VycmVudFN0eWxlWyBuYW1lIF0gfHwgZWxlbS5jdXJyZW50U3R5bGVbIGNhbWVsQ2FzZSBdOwoKCQkJLy8gRnJvbSB0aGUgYXdlc29tZSBoYWNrIGJ5IERlYW4gRWR3YXJkcwoJCQkvLyBodHRwOi8vZXJpay5lYWUubmV0L2FyY2hpdmVzLzIwMDcvMDcvMjcvMTguNTQuMTUvI2NvbW1lbnQtMTAyMjkxCgoJCQkvLyBJZiB3ZSdyZSBub3QgZGVhbGluZyB3aXRoIGEgcmVndWxhciBwaXhlbCBudW1iZXIKCQkJLy8gYnV0IGEgbnVtYmVyIHRoYXQgaGFzIGEgd2VpcmQgZW5kaW5nLCB3ZSBuZWVkIHRvIGNvbnZlcnQgaXQgdG8gcGl4ZWxzCgkJCWlmICggIXJudW1weC50ZXN0KCByZXQgKSAmJiBybnVtLnRlc3QoIHJldCApICkgewoJCQkJLy8gUmVtZW1iZXIgdGhlIG9yaWdpbmFsIHZhbHVlcwoJCQkJdmFyIGxlZnQgPSBzdHlsZS5sZWZ0LCByc0xlZnQgPSBlbGVtLnJ1bnRpbWVTdHlsZS5sZWZ0OwoKCQkJCS8vIFB1dCBpbiB0aGUgbmV3IHZhbHVlcyB0byBnZXQgYSBjb21wdXRlZCB2YWx1ZSBvdXQKCQkJCWVsZW0ucnVudGltZVN0eWxlLmxlZnQgPSBlbGVtLmN1cnJlbnRTdHlsZS5sZWZ0OwoJCQkJc3R5bGUubGVmdCA9IGNhbWVsQ2FzZSA9PT0gImZvbnRTaXplIiA/ICIxZW0iIDogKHJldCB8fCAwKTsKCQkJCXJldCA9IHN0eWxlLnBpeGVsTGVmdCArICJweCI7CgoJCQkJLy8gUmV2ZXJ0IHRoZSBjaGFuZ2VkIHZhbHVlcwoJCQkJc3R5bGUubGVmdCA9IGxlZnQ7CgkJCQllbGVtLnJ1bnRpbWVTdHlsZS5sZWZ0ID0gcnNMZWZ0OwoJCQl9CgkJfQoKCQlyZXR1cm4gcmV0OwoJfSwKCgkvLyBBIG1ldGhvZCBmb3IgcXVpY2tseSBzd2FwcGluZyBpbi9vdXQgQ1NTIHByb3BlcnRpZXMgdG8gZ2V0IGNvcnJlY3QgY2FsY3VsYXRpb25zCglzd2FwOiBmdW5jdGlvbiggZWxlbSwgb3B0aW9ucywgY2FsbGJhY2sgKSB7CgkJdmFyIG9sZCA9IHt9OwoKCQkvLyBSZW1lbWJlciB0aGUgb2xkIHZhbHVlcywgYW5kIGluc2VydCB0aGUgbmV3IG9uZXMKCQlmb3IgKCB2YXIgbmFtZSBpbiBvcHRpb25zICkgewoJCQlvbGRbIG5hbWUgXSA9IGVsZW0uc3R5bGVbIG5hbWUgXTsKCQkJZWxlbS5zdHlsZVsgbmFtZSBdID0gb3B0aW9uc1sgbmFtZSBdOwoJCX0KCgkJY2FsbGJhY2suY2FsbCggZWxlbSApOwoKCQkvLyBSZXZlcnQgdGhlIG9sZCB2YWx1ZXMKCQlmb3IgKCB2YXIgbmFtZSBpbiBvcHRpb25zICkgewoJCQllbGVtLnN0eWxlWyBuYW1lIF0gPSBvbGRbIG5hbWUgXTsKCQl9Cgl9Cn0pOwoKaWYgKCBqUXVlcnkuZXhwciAmJiBqUXVlcnkuZXhwci5maWx0ZXJzICkgewoJalF1ZXJ5LmV4cHIuZmlsdGVycy5oaWRkZW4gPSBmdW5jdGlvbiggZWxlbSApIHsKCQl2YXIgd2lkdGggPSBlbGVtLm9mZnNldFdpZHRoLCBoZWlnaHQgPSBlbGVtLm9mZnNldEhlaWdodCwKCQkJc2tpcCA9IGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gInRyIjsKCgkJcmV0dXJuIHdpZHRoID09PSAwICYmIGhlaWdodCA9PT0gMCAmJiAhc2tpcCA/CgkJCXRydWUgOgoJCQl3aWR0aCA+IDAgJiYgaGVpZ2h0ID4gMCAmJiAhc2tpcCA/CgkJCQlmYWxzZSA6CgkJCQlqUXVlcnkuY3VyQ1NTKGVsZW0sICJkaXNwbGF5IikgPT09ICJub25lIjsKCX07CgoJalF1ZXJ5LmV4cHIuZmlsdGVycy52aXNpYmxlID0gZnVuY3Rpb24oIGVsZW0gKSB7CgkJcmV0dXJuICFqUXVlcnkuZXhwci5maWx0ZXJzLmhpZGRlbiggZWxlbSApOwoJfTsKfQp2YXIganNjID0gbm93KCksCglyc2NyaXB0ID0gLzxzY3JpcHQoLnxccykqP1wvc2NyaXB0Pi9naSwKCXJzZWxlY3RUZXh0YXJlYSA9IC9zZWxlY3R8dGV4dGFyZWEvaSwKCXJpbnB1dCA9IC9jb2xvcnxkYXRlfGRhdGV0aW1lfGVtYWlsfGhpZGRlbnxtb250aHxudW1iZXJ8cGFzc3dvcmR8cmFuZ2V8c2VhcmNofHRlbHx0ZXh0fHRpbWV8dXJsfHdlZWsvaSwKCWpzcmUgPSAvPVw/KCZ8JCkvLAoJcnF1ZXJ5ID0gL1w/LywKCXJ0cyA9IC8oXD98JilfPS4qPygmfCQpLywKCXJ1cmwgPSAvXihcdys6KT9cL1wvKFteXC8/I10rKS8sCglyMjAgPSAvJTIwL2csCgoJLy8gS2VlcCBhIGNvcHkgb2YgdGhlIG9sZCBsb2FkIG1ldGhvZAoJX2xvYWQgPSBqUXVlcnkuZm4ubG9hZDsKCmpRdWVyeS5mbi5leHRlbmQoewoJbG9hZDogZnVuY3Rpb24oIHVybCwgcGFyYW1zLCBjYWxsYmFjayApIHsKCQlpZiAoIHR5cGVvZiB1cmwgIT09ICJzdHJpbmciICkgewoJCQlyZXR1cm4gX2xvYWQuY2FsbCggdGhpcywgdXJsICk7CgoJCS8vIERvbid0IGRvIGEgcmVxdWVzdCBpZiBubyBlbGVtZW50cyBhcmUgYmVpbmcgcmVxdWVzdGVkCgkJfSBlbHNlIGlmICggIXRoaXMubGVuZ3RoICkgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCXZhciBvZmYgPSB1cmwuaW5kZXhPZigiICIpOwoJCWlmICggb2ZmID49IDAgKSB7CgkJCXZhciBzZWxlY3RvciA9IHVybC5zbGljZShvZmYsIHVybC5sZW5ndGgpOwoJCQl1cmwgPSB1cmwuc2xpY2UoMCwgb2ZmKTsKCQl9CgoJCS8vIERlZmF1bHQgdG8gYSBHRVQgcmVxdWVzdAoJCXZhciB0eXBlID0gIkdFVCI7CgoJCS8vIElmIHRoZSBzZWNvbmQgcGFyYW1ldGVyIHdhcyBwcm92aWRlZAoJCWlmICggcGFyYW1zICkgewoJCQkvLyBJZiBpdCdzIGEgZnVuY3Rpb24KCQkJaWYgKCBqUXVlcnkuaXNGdW5jdGlvbiggcGFyYW1zICkgKSB7CgkJCQkvLyBXZSBhc3N1bWUgdGhhdCBpdCdzIHRoZSBjYWxsYmFjawoJCQkJY2FsbGJhY2sgPSBwYXJhbXM7CgkJCQlwYXJhbXMgPSBudWxsOwoKCQkJLy8gT3RoZXJ3aXNlLCBidWlsZCBhIHBhcmFtIHN0cmluZwoJCQl9IGVsc2UgaWYgKCB0eXBlb2YgcGFyYW1zID09PSAib2JqZWN0IiApIHsKCQkJCXBhcmFtcyA9IGpRdWVyeS5wYXJhbSggcGFyYW1zLCBqUXVlcnkuYWpheFNldHRpbmdzLnRyYWRpdGlvbmFsICk7CgkJCQl0eXBlID0gIlBPU1QiOwoJCQl9CgkJfQoKCQl2YXIgc2VsZiA9IHRoaXM7CgoJCS8vIFJlcXVlc3QgdGhlIHJlbW90ZSBkb2N1bWVudAoJCWpRdWVyeS5hamF4KHsKCQkJdXJsOiB1cmwsCgkJCXR5cGU6IHR5cGUsCgkJCWRhdGFUeXBlOiAiaHRtbCIsCgkJCWRhdGE6IHBhcmFtcywKCQkJY29tcGxldGU6IGZ1bmN0aW9uKCByZXMsIHN0YXR1cyApIHsKCQkJCS8vIElmIHN1Y2Nlc3NmdWwsIGluamVjdCB0aGUgSFRNTCBpbnRvIGFsbCB0aGUgbWF0Y2hlZCBlbGVtZW50cwoJCQkJaWYgKCBzdGF0dXMgPT09ICJzdWNjZXNzIiB8fCBzdGF0dXMgPT09ICJub3Rtb2RpZmllZCIgKSB7CgkJCQkJLy8gU2VlIGlmIGEgc2VsZWN0b3Igd2FzIHNwZWNpZmllZAoJCQkJCXNlbGYuaHRtbCggc2VsZWN0b3IgPwoJCQkJCQkvLyBDcmVhdGUgYSBkdW1teSBkaXYgdG8gaG9sZCB0aGUgcmVzdWx0cwoJCQkJCQlqUXVlcnkoIjxkaXYgLz4iKQoJCQkJCQkJLy8gaW5qZWN0IHRoZSBjb250ZW50cyBvZiB0aGUgZG9jdW1lbnQgaW4sIHJlbW92aW5nIHRoZSBzY3JpcHRzCgkJCQkJCQkvLyB0byBhdm9pZCBhbnkgJ1Blcm1pc3Npb24gRGVuaWVkJyBlcnJvcnMgaW4gSUUKCQkJCQkJCS5hcHBlbmQocmVzLnJlc3BvbnNlVGV4dC5yZXBsYWNlKHJzY3JpcHQsICIiKSkKCgkJCQkJCQkvLyBMb2NhdGUgdGhlIHNwZWNpZmllZCBlbGVtZW50cwoJCQkJCQkJLmZpbmQoc2VsZWN0b3IpIDoKCgkJCQkJCS8vIElmIG5vdCwganVzdCBpbmplY3QgdGhlIGZ1bGwgcmVzdWx0CgkJCQkJCXJlcy5yZXNwb25zZVRleHQgKTsKCQkJCX0KCgkJCQlpZiAoIGNhbGxiYWNrICkgewoJCQkJCXNlbGYuZWFjaCggY2FsbGJhY2ssIFtyZXMucmVzcG9uc2VUZXh0LCBzdGF0dXMsIHJlc10gKTsKCQkJCX0KCQkJfQoJCX0pOwoKCQlyZXR1cm4gdGhpczsKCX0sCgoJc2VyaWFsaXplOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4galF1ZXJ5LnBhcmFtKHRoaXMuc2VyaWFsaXplQXJyYXkoKSk7Cgl9LAoJc2VyaWFsaXplQXJyYXk6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLm1hcChmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHRoaXMuZWxlbWVudHMgPyBqUXVlcnkubWFrZUFycmF5KHRoaXMuZWxlbWVudHMpIDogdGhpczsKCQl9KQoJCS5maWx0ZXIoZnVuY3Rpb24oKSB7CgkJCXJldHVybiB0aGlzLm5hbWUgJiYgIXRoaXMuZGlzYWJsZWQgJiYKCQkJCSh0aGlzLmNoZWNrZWQgfHwgcnNlbGVjdFRleHRhcmVhLnRlc3QodGhpcy5ub2RlTmFtZSkgfHwKCQkJCQlyaW5wdXQudGVzdCh0aGlzLnR5cGUpKTsKCQl9KQoJCS5tYXAoZnVuY3Rpb24oIGksIGVsZW0gKSB7CgkJCXZhciB2YWwgPSBqUXVlcnkodGhpcykudmFsKCk7CgoJCQlyZXR1cm4gdmFsID09IG51bGwgPwoJCQkJbnVsbCA6CgkJCQlqUXVlcnkuaXNBcnJheSh2YWwpID8KCQkJCQlqUXVlcnkubWFwKCB2YWwsIGZ1bmN0aW9uKCB2YWwsIGkgKSB7CgkJCQkJCXJldHVybiB7IG5hbWU6IGVsZW0ubmFtZSwgdmFsdWU6IHZhbCB9OwoJCQkJCX0pIDoKCQkJCQl7IG5hbWU6IGVsZW0ubmFtZSwgdmFsdWU6IHZhbCB9OwoJCX0pLmdldCgpOwoJfQp9KTsKCi8vIEF0dGFjaCBhIGJ1bmNoIG9mIGZ1bmN0aW9ucyBmb3IgaGFuZGxpbmcgY29tbW9uIEFKQVggZXZlbnRzCmpRdWVyeS5lYWNoKCAiYWpheFN0YXJ0IGFqYXhTdG9wIGFqYXhDb21wbGV0ZSBhamF4RXJyb3IgYWpheFN1Y2Nlc3MgYWpheFNlbmQiLnNwbGl0KCIgIiksIGZ1bmN0aW9uKCBpLCBvICkgewoJalF1ZXJ5LmZuW29dID0gZnVuY3Rpb24oIGYgKSB7CgkJcmV0dXJuIHRoaXMuYmluZChvLCBmKTsKCX07Cn0pOwoKalF1ZXJ5LmV4dGVuZCh7CgoJZ2V0OiBmdW5jdGlvbiggdXJsLCBkYXRhLCBjYWxsYmFjaywgdHlwZSApIHsKCQkvLyBzaGlmdCBhcmd1bWVudHMgaWYgZGF0YSBhcmd1bWVudCB3YXMgb21pdGVkCgkJaWYgKCBqUXVlcnkuaXNGdW5jdGlvbiggZGF0YSApICkgewoJCQl0eXBlID0gdHlwZSB8fCBjYWxsYmFjazsKCQkJY2FsbGJhY2sgPSBkYXRhOwoJCQlkYXRhID0gbnVsbDsKCQl9CgoJCXJldHVybiBqUXVlcnkuYWpheCh7CgkJCXR5cGU6ICJHRVQiLAoJCQl1cmw6IHVybCwKCQkJZGF0YTogZGF0YSwKCQkJc3VjY2VzczogY2FsbGJhY2ssCgkJCWRhdGFUeXBlOiB0eXBlCgkJfSk7Cgl9LAoKCWdldFNjcmlwdDogZnVuY3Rpb24oIHVybCwgY2FsbGJhY2sgKSB7CgkJcmV0dXJuIGpRdWVyeS5nZXQodXJsLCBudWxsLCBjYWxsYmFjaywgInNjcmlwdCIpOwoJfSwKCglnZXRKU09OOiBmdW5jdGlvbiggdXJsLCBkYXRhLCBjYWxsYmFjayApIHsKCQlyZXR1cm4galF1ZXJ5LmdldCh1cmwsIGRhdGEsIGNhbGxiYWNrLCAianNvbiIpOwoJfSwKCglwb3N0OiBmdW5jdGlvbiggdXJsLCBkYXRhLCBjYWxsYmFjaywgdHlwZSApIHsKCQkvLyBzaGlmdCBhcmd1bWVudHMgaWYgZGF0YSBhcmd1bWVudCB3YXMgb21pdGVkCgkJaWYgKCBqUXVlcnkuaXNGdW5jdGlvbiggZGF0YSApICkgewoJCQl0eXBlID0gdHlwZSB8fCBjYWxsYmFjazsKCQkJY2FsbGJhY2sgPSBkYXRhOwoJCQlkYXRhID0ge307CgkJfQoKCQlyZXR1cm4galF1ZXJ5LmFqYXgoewoJCQl0eXBlOiAiUE9TVCIsCgkJCXVybDogdXJsLAoJCQlkYXRhOiBkYXRhLAoJCQlzdWNjZXNzOiBjYWxsYmFjaywKCQkJZGF0YVR5cGU6IHR5cGUKCQl9KTsKCX0sCgoJYWpheFNldHVwOiBmdW5jdGlvbiggc2V0dGluZ3MgKSB7CgkJalF1ZXJ5LmV4dGVuZCggalF1ZXJ5LmFqYXhTZXR0aW5ncywgc2V0dGluZ3MgKTsKCX0sCgoJYWpheFNldHRpbmdzOiB7CgkJdXJsOiBsb2NhdGlvbi5ocmVmLAoJCWdsb2JhbDogdHJ1ZSwKCQl0eXBlOiAiR0VUIiwKCQljb250ZW50VHlwZTogImFwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZCIsCgkJcHJvY2Vzc0RhdGE6IHRydWUsCgkJYXN5bmM6IHRydWUsCgkJLyoKCQl0aW1lb3V0OiAwLAoJCWRhdGE6IG51bGwsCgkJdXNlcm5hbWU6IG51bGwsCgkJcGFzc3dvcmQ6IG51bGwsCgkJdHJhZGl0aW9uYWw6IGZhbHNlLAoJCSovCgkJLy8gQ3JlYXRlIHRoZSByZXF1ZXN0IG9iamVjdDsgTWljcm9zb2Z0IGZhaWxlZCB0byBwcm9wZXJseQoJCS8vIGltcGxlbWVudCB0aGUgWE1MSHR0cFJlcXVlc3QgaW4gSUU3IChjYW4ndCByZXF1ZXN0IGxvY2FsIGZpbGVzKSwKCQkvLyBzbyB3ZSB1c2UgdGhlIEFjdGl2ZVhPYmplY3Qgd2hlbiBpdCBpcyBhdmFpbGFibGUKCQkvLyBUaGlzIGZ1bmN0aW9uIGNhbiBiZSBvdmVycmlkZW4gYnkgY2FsbGluZyBqUXVlcnkuYWpheFNldHVwCgkJeGhyOiB3aW5kb3cuWE1MSHR0cFJlcXVlc3QgJiYgKHdpbmRvdy5sb2NhdGlvbi5wcm90b2NvbCAhPT0gImZpbGU6IiB8fCAhd2luZG93LkFjdGl2ZVhPYmplY3QpID8KCQkJZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gbmV3IHdpbmRvdy5YTUxIdHRwUmVxdWVzdCgpOwoJCQl9IDoKCQkJZnVuY3Rpb24oKSB7CgkJCQl0cnkgewoJCQkJCXJldHVybiBuZXcgd2luZG93LkFjdGl2ZVhPYmplY3QoIk1pY3Jvc29mdC5YTUxIVFRQIik7CgkJCQl9IGNhdGNoKGUpIHt9CgkJCX0sCgkJYWNjZXB0czogewoJCQl4bWw6ICJhcHBsaWNhdGlvbi94bWwsIHRleHQveG1sIiwKCQkJaHRtbDogInRleHQvaHRtbCIsCgkJCXNjcmlwdDogInRleHQvamF2YXNjcmlwdCwgYXBwbGljYXRpb24vamF2YXNjcmlwdCIsCgkJCWpzb246ICJhcHBsaWNhdGlvbi9qc29uLCB0ZXh0L2phdmFzY3JpcHQiLAoJCQl0ZXh0OiAidGV4dC9wbGFpbiIsCgkJCV9kZWZhdWx0OiAiKi8qIgoJCX0KCX0sCgoJLy8gTGFzdC1Nb2RpZmllZCBoZWFkZXIgY2FjaGUgZm9yIG5leHQgcmVxdWVzdAoJbGFzdE1vZGlmaWVkOiB7fSwKCWV0YWc6IHt9LAoKCWFqYXg6IGZ1bmN0aW9uKCBvcmlnU2V0dGluZ3MgKSB7CgkJdmFyIHMgPSBqUXVlcnkuZXh0ZW5kKHRydWUsIHt9LCBqUXVlcnkuYWpheFNldHRpbmdzLCBvcmlnU2V0dGluZ3MpOwoJCQoJCXZhciBqc29ucCwgc3RhdHVzLCBkYXRhLAoJCQljYWxsYmFja0NvbnRleHQgPSBvcmlnU2V0dGluZ3MgJiYgb3JpZ1NldHRpbmdzLmNvbnRleHQgfHwgcywKCQkJdHlwZSA9IHMudHlwZS50b1VwcGVyQ2FzZSgpOwoKCQkvLyBjb252ZXJ0IGRhdGEgaWYgbm90IGFscmVhZHkgYSBzdHJpbmcKCQlpZiAoIHMuZGF0YSAmJiBzLnByb2Nlc3NEYXRhICYmIHR5cGVvZiBzLmRhdGEgIT09ICJzdHJpbmciICkgewoJCQlzLmRhdGEgPSBqUXVlcnkucGFyYW0oIHMuZGF0YSwgcy50cmFkaXRpb25hbCApOwoJCX0KCgkJLy8gSGFuZGxlIEpTT05QIFBhcmFtZXRlciBDYWxsYmFja3MKCQlpZiAoIHMuZGF0YVR5cGUgPT09ICJqc29ucCIgKSB7CgkJCWlmICggdHlwZSA9PT0gIkdFVCIgKSB7CgkJCQlpZiAoICFqc3JlLnRlc3QoIHMudXJsICkgKSB7CgkJCQkJcy51cmwgKz0gKHJxdWVyeS50ZXN0KCBzLnVybCApID8gIiYiIDogIj8iKSArIChzLmpzb25wIHx8ICJjYWxsYmFjayIpICsgIj0/IjsKCQkJCX0KCQkJfSBlbHNlIGlmICggIXMuZGF0YSB8fCAhanNyZS50ZXN0KHMuZGF0YSkgKSB7CgkJCQlzLmRhdGEgPSAocy5kYXRhID8gcy5kYXRhICsgIiYiIDogIiIpICsgKHMuanNvbnAgfHwgImNhbGxiYWNrIikgKyAiPT8iOwoJCQl9CgkJCXMuZGF0YVR5cGUgPSAianNvbiI7CgkJfQoKCQkvLyBCdWlsZCB0ZW1wb3JhcnkgSlNPTlAgZnVuY3Rpb24KCQlpZiAoIHMuZGF0YVR5cGUgPT09ICJqc29uIiAmJiAocy5kYXRhICYmIGpzcmUudGVzdChzLmRhdGEpIHx8IGpzcmUudGVzdChzLnVybCkpICkgewoJCQlqc29ucCA9IHMuanNvbnBDYWxsYmFjayB8fCAoImpzb25wIiArIGpzYysrKTsKCgkJCS8vIFJlcGxhY2UgdGhlID0/IHNlcXVlbmNlIGJvdGggaW4gdGhlIHF1ZXJ5IHN0cmluZyBhbmQgdGhlIGRhdGEKCQkJaWYgKCBzLmRhdGEgKSB7CgkJCQlzLmRhdGEgPSAocy5kYXRhICsgIiIpLnJlcGxhY2UoanNyZSwgIj0iICsganNvbnAgKyAiJDEiKTsKCQkJfQoKCQkJcy51cmwgPSBzLnVybC5yZXBsYWNlKGpzcmUsICI9IiArIGpzb25wICsgIiQxIik7CgoJCQkvLyBXZSBuZWVkIHRvIG1ha2Ugc3VyZQoJCQkvLyB0aGF0IGEgSlNPTlAgc3R5bGUgcmVzcG9uc2UgaXMgZXhlY3V0ZWQgcHJvcGVybHkKCQkJcy5kYXRhVHlwZSA9ICJzY3JpcHQiOwoKCQkJLy8gSGFuZGxlIEpTT05QLXN0eWxlIGxvYWRpbmcKCQkJd2luZG93WyBqc29ucCBdID0gd2luZG93WyBqc29ucCBdIHx8IGZ1bmN0aW9uKCB0bXAgKSB7CgkJCQlkYXRhID0gdG1wOwoJCQkJc3VjY2VzcygpOwoJCQkJY29tcGxldGUoKTsKCQkJCS8vIEdhcmJhZ2UgY29sbGVjdAoJCQkJd2luZG93WyBqc29ucCBdID0gdW5kZWZpbmVkOwoKCQkJCXRyeSB7CgkJCQkJZGVsZXRlIHdpbmRvd1sganNvbnAgXTsKCQkJCX0gY2F0Y2goZSkge30KCgkJCQlpZiAoIGhlYWQgKSB7CgkJCQkJaGVhZC5yZW1vdmVDaGlsZCggc2NyaXB0ICk7CgkJCQl9CgkJCX07CgkJfQoKCQlpZiAoIHMuZGF0YVR5cGUgPT09ICJzY3JpcHQiICYmIHMuY2FjaGUgPT09IG51bGwgKSB7CgkJCXMuY2FjaGUgPSBmYWxzZTsKCQl9CgoJCWlmICggcy5jYWNoZSA9PT0gZmFsc2UgJiYgdHlwZSA9PT0gIkdFVCIgKSB7CgkJCXZhciB0cyA9IG5vdygpOwoKCQkJLy8gdHJ5IHJlcGxhY2luZyBfPSBpZiBpdCBpcyB0aGVyZQoJCQl2YXIgcmV0ID0gcy51cmwucmVwbGFjZShydHMsICIkMV89IiArIHRzICsgIiQyIik7CgoJCQkvLyBpZiBub3RoaW5nIHdhcyByZXBsYWNlZCwgYWRkIHRpbWVzdGFtcCB0byB0aGUgZW5kCgkJCXMudXJsID0gcmV0ICsgKChyZXQgPT09IHMudXJsKSA/IChycXVlcnkudGVzdChzLnVybCkgPyAiJiIgOiAiPyIpICsgIl89IiArIHRzIDogIiIpOwoJCX0KCgkJLy8gSWYgZGF0YSBpcyBhdmFpbGFibGUsIGFwcGVuZCBkYXRhIHRvIHVybCBmb3IgZ2V0IHJlcXVlc3RzCgkJaWYgKCBzLmRhdGEgJiYgdHlwZSA9PT0gIkdFVCIgKSB7CgkJCXMudXJsICs9IChycXVlcnkudGVzdChzLnVybCkgPyAiJiIgOiAiPyIpICsgcy5kYXRhOwoJCX0KCgkJLy8gV2F0Y2ggZm9yIGEgbmV3IHNldCBvZiByZXF1ZXN0cwoJCWlmICggcy5nbG9iYWwgJiYgISBqUXVlcnkuYWN0aXZlKysgKSB7CgkJCWpRdWVyeS5ldmVudC50cmlnZ2VyKCAiYWpheFN0YXJ0IiApOwoJCX0KCgkJLy8gTWF0Y2hlcyBhbiBhYnNvbHV0ZSBVUkwsIGFuZCBzYXZlcyB0aGUgZG9tYWluCgkJdmFyIHBhcnRzID0gcnVybC5leGVjKCBzLnVybCApLAoJCQlyZW1vdGUgPSBwYXJ0cyAmJiAocGFydHNbMV0gJiYgcGFydHNbMV0gIT09IGxvY2F0aW9uLnByb3RvY29sIHx8IHBhcnRzWzJdICE9PSBsb2NhdGlvbi5ob3N0KTsKCgkJLy8gSWYgd2UncmUgcmVxdWVzdGluZyBhIHJlbW90ZSBkb2N1bWVudAoJCS8vIGFuZCB0cnlpbmcgdG8gbG9hZCBKU09OIG9yIFNjcmlwdCB3aXRoIGEgR0VUCgkJaWYgKCBzLmRhdGFUeXBlID09PSAic2NyaXB0IiAmJiB0eXBlID09PSAiR0VUIiAmJiByZW1vdGUgKSB7CgkJCXZhciBoZWFkID0gZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoImhlYWQiKVswXSB8fCBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQ7CgkJCXZhciBzY3JpcHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzY3JpcHQiKTsKCQkJc2NyaXB0LnNyYyA9IHMudXJsOwoJCQlpZiAoIHMuc2NyaXB0Q2hhcnNldCApIHsKCQkJCXNjcmlwdC5jaGFyc2V0ID0gcy5zY3JpcHRDaGFyc2V0OwoJCQl9CgoJCQkvLyBIYW5kbGUgU2NyaXB0IGxvYWRpbmcKCQkJaWYgKCAhanNvbnAgKSB7CgkJCQl2YXIgZG9uZSA9IGZhbHNlOwoKCQkJCS8vIEF0dGFjaCBoYW5kbGVycyBmb3IgYWxsIGJyb3dzZXJzCgkJCQlzY3JpcHQub25sb2FkID0gc2NyaXB0Lm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGZ1bmN0aW9uKCkgewoJCQkJCWlmICggIWRvbmUgJiYgKCF0aGlzLnJlYWR5U3RhdGUgfHwKCQkJCQkJCXRoaXMucmVhZHlTdGF0ZSA9PT0gImxvYWRlZCIgfHwgdGhpcy5yZWFkeVN0YXRlID09PSAiY29tcGxldGUiKSApIHsKCQkJCQkJZG9uZSA9IHRydWU7CgkJCQkJCXN1Y2Nlc3MoKTsKCQkJCQkJY29tcGxldGUoKTsKCgkJCQkJCS8vIEhhbmRsZSBtZW1vcnkgbGVhayBpbiBJRQoJCQkJCQlzY3JpcHQub25sb2FkID0gc2NyaXB0Lm9ucmVhZHlzdGF0ZWNoYW5nZSA9IG51bGw7CgkJCQkJCWlmICggaGVhZCAmJiBzY3JpcHQucGFyZW50Tm9kZSApIHsKCQkJCQkJCWhlYWQucmVtb3ZlQ2hpbGQoIHNjcmlwdCApOwoJCQkJCQl9CgkJCQkJfQoJCQkJfTsKCQkJfQoKCQkJLy8gVXNlIGluc2VydEJlZm9yZSBpbnN0ZWFkIG9mIGFwcGVuZENoaWxkICB0byBjaXJjdW12ZW50IGFuIElFNiBidWcuCgkJCS8vIFRoaXMgYXJpc2VzIHdoZW4gYSBiYXNlIG5vZGUgaXMgdXNlZCAoIzI3MDkgYW5kICM0Mzc4KS4KCQkJaGVhZC5pbnNlcnRCZWZvcmUoIHNjcmlwdCwgaGVhZC5maXJzdENoaWxkICk7CgoJCQkvLyBXZSBoYW5kbGUgZXZlcnl0aGluZyB1c2luZyB0aGUgc2NyaXB0IGVsZW1lbnQgaW5qZWN0aW9uCgkJCXJldHVybiB1bmRlZmluZWQ7CgkJfQoKCQl2YXIgcmVxdWVzdERvbmUgPSBmYWxzZTsKCgkJLy8gQ3JlYXRlIHRoZSByZXF1ZXN0IG9iamVjdAoJCXZhciB4aHIgPSBzLnhocigpOwoKCQlpZiAoICF4aHIgKSB7CgkJCXJldHVybjsKCQl9CgoJCS8vIE9wZW4gdGhlIHNvY2tldAoJCS8vIFBhc3NpbmcgbnVsbCB1c2VybmFtZSwgZ2VuZXJhdGVzIGEgbG9naW4gcG9wdXAgb24gT3BlcmEgKCMyODY1KQoJCWlmICggcy51c2VybmFtZSApIHsKCQkJeGhyLm9wZW4odHlwZSwgcy51cmwsIHMuYXN5bmMsIHMudXNlcm5hbWUsIHMucGFzc3dvcmQpOwoJCX0gZWxzZSB7CgkJCXhoci5vcGVuKHR5cGUsIHMudXJsLCBzLmFzeW5jKTsKCQl9CgoJCS8vIE5lZWQgYW4gZXh0cmEgdHJ5L2NhdGNoIGZvciBjcm9zcyBkb21haW4gcmVxdWVzdHMgaW4gRmlyZWZveCAzCgkJdHJ5IHsKCQkJLy8gU2V0IHRoZSBjb3JyZWN0IGhlYWRlciwgaWYgZGF0YSBpcyBiZWluZyBzZW50CgkJCWlmICggcy5kYXRhIHx8IG9yaWdTZXR0aW5ncyAmJiBvcmlnU2V0dGluZ3MuY29udGVudFR5cGUgKSB7CgkJCQl4aHIuc2V0UmVxdWVzdEhlYWRlcigiQ29udGVudC1UeXBlIiwgcy5jb250ZW50VHlwZSk7CgkJCX0KCgkJCS8vIFNldCB0aGUgSWYtTW9kaWZpZWQtU2luY2UgYW5kL29yIElmLU5vbmUtTWF0Y2ggaGVhZGVyLCBpZiBpbiBpZk1vZGlmaWVkIG1vZGUuCgkJCWlmICggcy5pZk1vZGlmaWVkICkgewoJCQkJaWYgKCBqUXVlcnkubGFzdE1vZGlmaWVkW3MudXJsXSApIHsKCQkJCQl4aHIuc2V0UmVxdWVzdEhlYWRlcigiSWYtTW9kaWZpZWQtU2luY2UiLCBqUXVlcnkubGFzdE1vZGlmaWVkW3MudXJsXSk7CgkJCQl9CgoJCQkJaWYgKCBqUXVlcnkuZXRhZ1tzLnVybF0gKSB7CgkJCQkJeGhyLnNldFJlcXVlc3RIZWFkZXIoIklmLU5vbmUtTWF0Y2giLCBqUXVlcnkuZXRhZ1tzLnVybF0pOwoJCQkJfQoJCQl9CgoJCQkvLyBTZXQgaGVhZGVyIHNvIHRoZSBjYWxsZWQgc2NyaXB0IGtub3dzIHRoYXQgaXQncyBhbiBYTUxIdHRwUmVxdWVzdAoJCQkvLyBPbmx5IHNlbmQgdGhlIGhlYWRlciBpZiBpdCdzIG5vdCBhIHJlbW90ZSBYSFIKCQkJaWYgKCAhcmVtb3RlICkgewoJCQkJeGhyLnNldFJlcXVlc3RIZWFkZXIoIlgtUmVxdWVzdGVkLVdpdGgiLCAiWE1MSHR0cFJlcXVlc3QiKTsKCQkJfQoKCQkJLy8gU2V0IHRoZSBBY2NlcHRzIGhlYWRlciBmb3IgdGhlIHNlcnZlciwgZGVwZW5kaW5nIG9uIHRoZSBkYXRhVHlwZQoJCQl4aHIuc2V0UmVxdWVzdEhlYWRlcigiQWNjZXB0Iiwgcy5kYXRhVHlwZSAmJiBzLmFjY2VwdHNbIHMuZGF0YVR5cGUgXSA/CgkJCQlzLmFjY2VwdHNbIHMuZGF0YVR5cGUgXSArICIsICovKiIgOgoJCQkJcy5hY2NlcHRzLl9kZWZhdWx0ICk7CgkJfSBjYXRjaChlKSB7fQoKCQkvLyBBbGxvdyBjdXN0b20gaGVhZGVycy9taW1ldHlwZXMgYW5kIGVhcmx5IGFib3J0CgkJaWYgKCBzLmJlZm9yZVNlbmQgJiYgcy5iZWZvcmVTZW5kLmNhbGwoY2FsbGJhY2tDb250ZXh0LCB4aHIsIHMpID09PSBmYWxzZSApIHsKCQkJLy8gSGFuZGxlIHRoZSBnbG9iYWwgQUpBWCBjb3VudGVyCgkJCWlmICggcy5nbG9iYWwgJiYgISAtLWpRdWVyeS5hY3RpdmUgKSB7CgkJCQlqUXVlcnkuZXZlbnQudHJpZ2dlciggImFqYXhTdG9wIiApOwoJCQl9CgoJCQkvLyBjbG9zZSBvcGVuZGVkIHNvY2tldAoJCQl4aHIuYWJvcnQoKTsKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCgkJaWYgKCBzLmdsb2JhbCApIHsKCQkJdHJpZ2dlcigiYWpheFNlbmQiLCBbeGhyLCBzXSk7CgkJfQoKCQkvLyBXYWl0IGZvciBhIHJlc3BvbnNlIHRvIGNvbWUgYmFjawoJCXZhciBvbnJlYWR5c3RhdGVjaGFuZ2UgPSB4aHIub25yZWFkeXN0YXRlY2hhbmdlID0gZnVuY3Rpb24oIGlzVGltZW91dCApIHsKCQkJLy8gVGhlIHJlcXVlc3Qgd2FzIGFib3J0ZWQKCQkJaWYgKCAheGhyIHx8IHhoci5yZWFkeVN0YXRlID09PSAwIHx8IGlzVGltZW91dCA9PT0gImFib3J0IiApIHsKCQkJCS8vIE9wZXJhIGRvZXNuJ3QgY2FsbCBvbnJlYWR5c3RhdGVjaGFuZ2UgYmVmb3JlIHRoaXMgcG9pbnQKCQkJCS8vIHNvIHdlIHNpbXVsYXRlIHRoZSBjYWxsCgkJCQlpZiAoICFyZXF1ZXN0RG9uZSApIHsKCQkJCQljb21wbGV0ZSgpOwoJCQkJfQoKCQkJCXJlcXVlc3REb25lID0gdHJ1ZTsKCQkJCWlmICggeGhyICkgewoJCQkJCXhoci5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBqUXVlcnkubm9vcDsKCQkJCX0KCgkJCS8vIFRoZSB0cmFuc2ZlciBpcyBjb21wbGV0ZSBhbmQgdGhlIGRhdGEgaXMgYXZhaWxhYmxlLCBvciB0aGUgcmVxdWVzdCB0aW1lZCBvdXQKCQkJfSBlbHNlIGlmICggIXJlcXVlc3REb25lICYmIHhociAmJiAoeGhyLnJlYWR5U3RhdGUgPT09IDQgfHwgaXNUaW1lb3V0ID09PSAidGltZW91dCIpICkgewoJCQkJcmVxdWVzdERvbmUgPSB0cnVlOwoJCQkJeGhyLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGpRdWVyeS5ub29wOwoKCQkJCXN0YXR1cyA9IGlzVGltZW91dCA9PT0gInRpbWVvdXQiID8KCQkJCQkidGltZW91dCIgOgoJCQkJCSFqUXVlcnkuaHR0cFN1Y2Nlc3MoIHhociApID8KCQkJCQkJImVycm9yIiA6CgkJCQkJCXMuaWZNb2RpZmllZCAmJiBqUXVlcnkuaHR0cE5vdE1vZGlmaWVkKCB4aHIsIHMudXJsICkgPwoJCQkJCQkJIm5vdG1vZGlmaWVkIiA6CgkJCQkJCQkic3VjY2VzcyI7CgoJCQkJdmFyIGVyck1zZzsKCgkJCQlpZiAoIHN0YXR1cyA9PT0gInN1Y2Nlc3MiICkgewoJCQkJCS8vIFdhdGNoIGZvciwgYW5kIGNhdGNoLCBYTUwgZG9jdW1lbnQgcGFyc2UgZXJyb3JzCgkJCQkJdHJ5IHsKCQkJCQkJLy8gcHJvY2VzcyB0aGUgZGF0YSAocnVucyB0aGUgeG1sIHRocm91Z2ggaHR0cERhdGEgcmVnYXJkbGVzcyBvZiBjYWxsYmFjaykKCQkJCQkJZGF0YSA9IGpRdWVyeS5odHRwRGF0YSggeGhyLCBzLmRhdGFUeXBlLCBzICk7CgkJCQkJfSBjYXRjaChlcnIpIHsKCQkJCQkJc3RhdHVzID0gInBhcnNlcmVycm9yIjsKCQkJCQkJZXJyTXNnID0gZXJyOwoJCQkJCX0KCQkJCX0KCgkJCQkvLyBNYWtlIHN1cmUgdGhhdCB0aGUgcmVxdWVzdCB3YXMgc3VjY2Vzc2Z1bCBvciBub3Rtb2RpZmllZAoJCQkJaWYgKCBzdGF0dXMgPT09ICJzdWNjZXNzIiB8fCBzdGF0dXMgPT09ICJub3Rtb2RpZmllZCIgKSB7CgkJCQkJLy8gSlNPTlAgaGFuZGxlcyBpdHMgb3duIHN1Y2Nlc3MgY2FsbGJhY2sKCQkJCQlpZiAoICFqc29ucCApIHsKCQkJCQkJc3VjY2VzcygpOwoJCQkJCX0KCQkJCX0gZWxzZSB7CgkJCQkJalF1ZXJ5LmhhbmRsZUVycm9yKHMsIHhociwgc3RhdHVzLCBlcnJNc2cpOwoJCQkJfQoKCQkJCS8vIEZpcmUgdGhlIGNvbXBsZXRlIGhhbmRsZXJzCgkJCQljb21wbGV0ZSgpOwoKCQkJCWlmICggaXNUaW1lb3V0ID09PSAidGltZW91dCIgKSB7CgkJCQkJeGhyLmFib3J0KCk7CgkJCQl9CgoJCQkJLy8gU3RvcCBtZW1vcnkgbGVha3MKCQkJCWlmICggcy5hc3luYyApIHsKCQkJCQl4aHIgPSBudWxsOwoJCQkJfQoJCQl9CgkJfTsKCgkJLy8gT3ZlcnJpZGUgdGhlIGFib3J0IGhhbmRsZXIsIGlmIHdlIGNhbiAoSUUgZG9lc24ndCBhbGxvdyBpdCwgYnV0IHRoYXQncyBPSykKCQkvLyBPcGVyYSBkb2Vzbid0IGZpcmUgb25yZWFkeXN0YXRlY2hhbmdlIGF0IGFsbCBvbiBhYm9ydAoJCXRyeSB7CgkJCXZhciBvbGRBYm9ydCA9IHhoci5hYm9ydDsKCQkJeGhyLmFib3J0ID0gZnVuY3Rpb24oKSB7CgkJCQlpZiAoIHhociApIHsKCQkJCQlvbGRBYm9ydC5jYWxsKCB4aHIgKTsKCQkJCX0KCgkJCQlvbnJlYWR5c3RhdGVjaGFuZ2UoICJhYm9ydCIgKTsKCQkJfTsKCQl9IGNhdGNoKGUpIHsgfQoKCQkvLyBUaW1lb3V0IGNoZWNrZXIKCQlpZiAoIHMuYXN5bmMgJiYgcy50aW1lb3V0ID4gMCApIHsKCQkJc2V0VGltZW91dChmdW5jdGlvbigpIHsKCQkJCS8vIENoZWNrIHRvIHNlZSBpZiB0aGUgcmVxdWVzdCBpcyBzdGlsbCBoYXBwZW5pbmcKCQkJCWlmICggeGhyICYmICFyZXF1ZXN0RG9uZSApIHsKCQkJCQlvbnJlYWR5c3RhdGVjaGFuZ2UoICJ0aW1lb3V0IiApOwoJCQkJfQoJCQl9LCBzLnRpbWVvdXQpOwoJCX0KCgkJLy8gU2VuZCB0aGUgZGF0YQoJCXRyeSB7CgkJCXhoci5zZW5kKCB0eXBlID09PSAiUE9TVCIgfHwgdHlwZSA9PT0gIlBVVCIgfHwgdHlwZSA9PT0gIkRFTEVURSIgPyBzLmRhdGEgOiBudWxsICk7CgkJfSBjYXRjaChlKSB7CgkJCWpRdWVyeS5oYW5kbGVFcnJvcihzLCB4aHIsIG51bGwsIGUpOwoJCQkvLyBGaXJlIHRoZSBjb21wbGV0ZSBoYW5kbGVycwoJCQljb21wbGV0ZSgpOwoJCX0KCgkJLy8gZmlyZWZveCAxLjUgZG9lc24ndCBmaXJlIHN0YXRlY2hhbmdlIGZvciBzeW5jIHJlcXVlc3RzCgkJaWYgKCAhcy5hc3luYyApIHsKCQkJb25yZWFkeXN0YXRlY2hhbmdlKCk7CgkJfQoKCQlmdW5jdGlvbiBzdWNjZXNzKCkgewoJCQkvLyBJZiBhIGxvY2FsIGNhbGxiYWNrIHdhcyBzcGVjaWZpZWQsIGZpcmUgaXQgYW5kIHBhc3MgaXQgdGhlIGRhdGEKCQkJaWYgKCBzLnN1Y2Nlc3MgKSB7CgkJCQlzLnN1Y2Nlc3MuY2FsbCggY2FsbGJhY2tDb250ZXh0LCBkYXRhLCBzdGF0dXMsIHhociApOwoJCQl9CgoJCQkvLyBGaXJlIHRoZSBnbG9iYWwgY2FsbGJhY2sKCQkJaWYgKCBzLmdsb2JhbCApIHsKCQkJCXRyaWdnZXIoICJhamF4U3VjY2VzcyIsIFt4aHIsIHNdICk7CgkJCX0KCQl9CgoJCWZ1bmN0aW9uIGNvbXBsZXRlKCkgewoJCQkvLyBQcm9jZXNzIHJlc3VsdAoJCQlpZiAoIHMuY29tcGxldGUgKSB7CgkJCQlzLmNvbXBsZXRlLmNhbGwoIGNhbGxiYWNrQ29udGV4dCwgeGhyLCBzdGF0dXMpOwoJCQl9CgoJCQkvLyBUaGUgcmVxdWVzdCB3YXMgY29tcGxldGVkCgkJCWlmICggcy5nbG9iYWwgKSB7CgkJCQl0cmlnZ2VyKCAiYWpheENvbXBsZXRlIiwgW3hociwgc10gKTsKCQkJfQoKCQkJLy8gSGFuZGxlIHRoZSBnbG9iYWwgQUpBWCBjb3VudGVyCgkJCWlmICggcy5nbG9iYWwgJiYgISAtLWpRdWVyeS5hY3RpdmUgKSB7CgkJCQlqUXVlcnkuZXZlbnQudHJpZ2dlciggImFqYXhTdG9wIiApOwoJCQl9CgkJfQoJCQoJCWZ1bmN0aW9uIHRyaWdnZXIodHlwZSwgYXJncykgewoJCQkocy5jb250ZXh0ID8galF1ZXJ5KHMuY29udGV4dCkgOiBqUXVlcnkuZXZlbnQpLnRyaWdnZXIodHlwZSwgYXJncyk7CgkJfQoKCQkvLyByZXR1cm4gWE1MSHR0cFJlcXVlc3QgdG8gYWxsb3cgYWJvcnRpbmcgdGhlIHJlcXVlc3QgZXRjLgoJCXJldHVybiB4aHI7Cgl9LAoKCWhhbmRsZUVycm9yOiBmdW5jdGlvbiggcywgeGhyLCBzdGF0dXMsIGUgKSB7CgkJLy8gSWYgYSBsb2NhbCBjYWxsYmFjayB3YXMgc3BlY2lmaWVkLCBmaXJlIGl0CgkJaWYgKCBzLmVycm9yICkgewoJCQlzLmVycm9yLmNhbGwoIHMuY29udGV4dCB8fCBzLCB4aHIsIHN0YXR1cywgZSApOwoJCX0KCgkJLy8gRmlyZSB0aGUgZ2xvYmFsIGNhbGxiYWNrCgkJaWYgKCBzLmdsb2JhbCApIHsKCQkJKHMuY29udGV4dCA/IGpRdWVyeShzLmNvbnRleHQpIDogalF1ZXJ5LmV2ZW50KS50cmlnZ2VyKCAiYWpheEVycm9yIiwgW3hociwgcywgZV0gKTsKCQl9Cgl9LAoKCS8vIENvdW50ZXIgZm9yIGhvbGRpbmcgdGhlIG51bWJlciBvZiBhY3RpdmUgcXVlcmllcwoJYWN0aXZlOiAwLAoKCS8vIERldGVybWluZXMgaWYgYW4gWE1MSHR0cFJlcXVlc3Qgd2FzIHN1Y2Nlc3NmdWwgb3Igbm90CglodHRwU3VjY2VzczogZnVuY3Rpb24oIHhociApIHsKCQl0cnkgewoJCQkvLyBJRSBlcnJvciBzb21ldGltZXMgcmV0dXJucyAxMjIzIHdoZW4gaXQgc2hvdWxkIGJlIDIwNCBzbyB0cmVhdCBpdCBhcyBzdWNjZXNzLCBzZWUgIzE0NTAKCQkJcmV0dXJuICF4aHIuc3RhdHVzICYmIGxvY2F0aW9uLnByb3RvY29sID09PSAiZmlsZToiIHx8CgkJCQkvLyBPcGVyYSByZXR1cm5zIDAgd2hlbiBzdGF0dXMgaXMgMzA0CgkJCQkoIHhoci5zdGF0dXMgPj0gMjAwICYmIHhoci5zdGF0dXMgPCAzMDAgKSB8fAoJCQkJeGhyLnN0YXR1cyA9PT0gMzA0IHx8IHhoci5zdGF0dXMgPT09IDEyMjMgfHwgeGhyLnN0YXR1cyA9PT0gMDsKCQl9IGNhdGNoKGUpIHt9CgoJCXJldHVybiBmYWxzZTsKCX0sCgoJLy8gRGV0ZXJtaW5lcyBpZiBhbiBYTUxIdHRwUmVxdWVzdCByZXR1cm5zIE5vdE1vZGlmaWVkCglodHRwTm90TW9kaWZpZWQ6IGZ1bmN0aW9uKCB4aHIsIHVybCApIHsKCQl2YXIgbGFzdE1vZGlmaWVkID0geGhyLmdldFJlc3BvbnNlSGVhZGVyKCJMYXN0LU1vZGlmaWVkIiksCgkJCWV0YWcgPSB4aHIuZ2V0UmVzcG9uc2VIZWFkZXIoIkV0YWciKTsKCgkJaWYgKCBsYXN0TW9kaWZpZWQgKSB7CgkJCWpRdWVyeS5sYXN0TW9kaWZpZWRbdXJsXSA9IGxhc3RNb2RpZmllZDsKCQl9CgoJCWlmICggZXRhZyApIHsKCQkJalF1ZXJ5LmV0YWdbdXJsXSA9IGV0YWc7CgkJfQoKCQkvLyBPcGVyYSByZXR1cm5zIDAgd2hlbiBzdGF0dXMgaXMgMzA0CgkJcmV0dXJuIHhoci5zdGF0dXMgPT09IDMwNCB8fCB4aHIuc3RhdHVzID09PSAwOwoJfSwKCglodHRwRGF0YTogZnVuY3Rpb24oIHhociwgdHlwZSwgcyApIHsKCQl2YXIgY3QgPSB4aHIuZ2V0UmVzcG9uc2VIZWFkZXIoImNvbnRlbnQtdHlwZSIpIHx8ICIiLAoJCQl4bWwgPSB0eXBlID09PSAieG1sIiB8fCAhdHlwZSAmJiBjdC5pbmRleE9mKCJ4bWwiKSA+PSAwLAoJCQlkYXRhID0geG1sID8geGhyLnJlc3BvbnNlWE1MIDogeGhyLnJlc3BvbnNlVGV4dDsKCgkJaWYgKCB4bWwgJiYgZGF0YS5kb2N1bWVudEVsZW1lbnQubm9kZU5hbWUgPT09ICJwYXJzZXJlcnJvciIgKSB7CgkJCWpRdWVyeS5lcnJvciggInBhcnNlcmVycm9yIiApOwoJCX0KCgkJLy8gQWxsb3cgYSBwcmUtZmlsdGVyaW5nIGZ1bmN0aW9uIHRvIHNhbml0aXplIHRoZSByZXNwb25zZQoJCS8vIHMgaXMgY2hlY2tlZCB0byBrZWVwIGJhY2t3YXJkcyBjb21wYXRpYmlsaXR5CgkJaWYgKCBzICYmIHMuZGF0YUZpbHRlciApIHsKCQkJZGF0YSA9IHMuZGF0YUZpbHRlciggZGF0YSwgdHlwZSApOwoJCX0KCgkJLy8gVGhlIGZpbHRlciBjYW4gYWN0dWFsbHkgcGFyc2UgdGhlIHJlc3BvbnNlCgkJaWYgKCB0eXBlb2YgZGF0YSA9PT0gInN0cmluZyIgKSB7CgkJCS8vIEdldCB0aGUgSmF2YVNjcmlwdCBvYmplY3QsIGlmIEpTT04gaXMgdXNlZC4KCQkJaWYgKCB0eXBlID09PSAianNvbiIgfHwgIXR5cGUgJiYgY3QuaW5kZXhPZigianNvbiIpID49IDAgKSB7CgkJCQlkYXRhID0galF1ZXJ5LnBhcnNlSlNPTiggZGF0YSApOwoKCQkJLy8gSWYgdGhlIHR5cGUgaXMgInNjcmlwdCIsIGV2YWwgaXQgaW4gZ2xvYmFsIGNvbnRleHQKCQkJfSBlbHNlIGlmICggdHlwZSA9PT0gInNjcmlwdCIgfHwgIXR5cGUgJiYgY3QuaW5kZXhPZigiamF2YXNjcmlwdCIpID49IDAgKSB7CgkJCQlqUXVlcnkuZ2xvYmFsRXZhbCggZGF0YSApOwoJCQl9CgkJfQoKCQlyZXR1cm4gZGF0YTsKCX0sCgoJLy8gU2VyaWFsaXplIGFuIGFycmF5IG9mIGZvcm0gZWxlbWVudHMgb3IgYSBzZXQgb2YKCS8vIGtleS92YWx1ZXMgaW50byBhIHF1ZXJ5IHN0cmluZwoJcGFyYW06IGZ1bmN0aW9uKCBhLCB0cmFkaXRpb25hbCApIHsKCQl2YXIgcyA9IFtdOwoJCQoJCS8vIFNldCB0cmFkaXRpb25hbCB0byB0cnVlIGZvciBqUXVlcnkgPD0gMS4zLjIgYmVoYXZpb3IuCgkJaWYgKCB0cmFkaXRpb25hbCA9PT0gdW5kZWZpbmVkICkgewoJCQl0cmFkaXRpb25hbCA9IGpRdWVyeS5hamF4U2V0dGluZ3MudHJhZGl0aW9uYWw7CgkJfQoJCQoJCS8vIElmIGFuIGFycmF5IHdhcyBwYXNzZWQgaW4sIGFzc3VtZSB0aGF0IGl0IGlzIGFuIGFycmF5IG9mIGZvcm0gZWxlbWVudHMuCgkJaWYgKCBqUXVlcnkuaXNBcnJheShhKSB8fCBhLmpxdWVyeSApIHsKCQkJLy8gU2VyaWFsaXplIHRoZSBmb3JtIGVsZW1lbnRzCgkJCWpRdWVyeS5lYWNoKCBhLCBmdW5jdGlvbigpIHsKCQkJCWFkZCggdGhpcy5uYW1lLCB0aGlzLnZhbHVlICk7CgkJCX0pOwoJCQkKCQl9IGVsc2UgewoJCQkvLyBJZiB0cmFkaXRpb25hbCwgZW5jb2RlIHRoZSAib2xkIiB3YXkgKHRoZSB3YXkgMS4zLjIgb3Igb2xkZXIKCQkJLy8gZGlkIGl0KSwgb3RoZXJ3aXNlIGVuY29kZSBwYXJhbXMgcmVjdXJzaXZlbHkuCgkJCWZvciAoIHZhciBwcmVmaXggaW4gYSApIHsKCQkJCWJ1aWxkUGFyYW1zKCBwcmVmaXgsIGFbcHJlZml4XSApOwoJCQl9CgkJfQoKCQkvLyBSZXR1cm4gdGhlIHJlc3VsdGluZyBzZXJpYWxpemF0aW9uCgkJcmV0dXJuIHMuam9pbigiJiIpLnJlcGxhY2UocjIwLCAiKyIpOwoKCQlmdW5jdGlvbiBidWlsZFBhcmFtcyggcHJlZml4LCBvYmogKSB7CgkJCWlmICggalF1ZXJ5LmlzQXJyYXkob2JqKSApIHsKCQkJCS8vIFNlcmlhbGl6ZSBhcnJheSBpdGVtLgoJCQkJalF1ZXJ5LmVhY2goIG9iaiwgZnVuY3Rpb24oIGksIHYgKSB7CgkJCQkJaWYgKCB0cmFkaXRpb25hbCB8fCAvXFtcXSQvLnRlc3QoIHByZWZpeCApICkgewoJCQkJCQkvLyBUcmVhdCBlYWNoIGFycmF5IGl0ZW0gYXMgYSBzY2FsYXIuCgkJCQkJCWFkZCggcHJlZml4LCB2ICk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJLy8gSWYgYXJyYXkgaXRlbSBpcyBub24tc2NhbGFyIChhcnJheSBvciBvYmplY3QpLCBlbmNvZGUgaXRzCgkJCQkJCS8vIG51bWVyaWMgaW5kZXggdG8gcmVzb2x2ZSBkZXNlcmlhbGl6YXRpb24gYW1iaWd1aXR5IGlzc3Vlcy4KCQkJCQkJLy8gTm90ZSB0aGF0IHJhY2sgKGFzIG9mIDEuMC4wKSBjYW4ndCBjdXJyZW50bHkgZGVzZXJpYWxpemUKCQkJCQkJLy8gbmVzdGVkIGFycmF5cyBwcm9wZXJseSwgYW5kIGF0dGVtcHRpbmcgdG8gZG8gc28gbWF5IGNhdXNlCgkJCQkJCS8vIGEgc2VydmVyIGVycm9yLiBQb3NzaWJsZSBmaXhlcyBhcmUgdG8gbW9kaWZ5IHJhY2sncwoJCQkJCQkvLyBkZXNlcmlhbGl6YXRpb24gYWxnb3JpdGhtIG9yIHRvIHByb3ZpZGUgYW4gb3B0aW9uIG9yIGZsYWcKCQkJCQkJLy8gdG8gZm9yY2UgYXJyYXkgc2VyaWFsaXphdGlvbiB0byBiZSBzaGFsbG93LgoJCQkJCQlidWlsZFBhcmFtcyggcHJlZml4ICsgIlsiICsgKCB0eXBlb2YgdiA9PT0gIm9iamVjdCIgfHwgalF1ZXJ5LmlzQXJyYXkodikgPyBpIDogIiIgKSArICJdIiwgdiApOwoJCQkJCX0KCQkJCX0pOwoJCQkJCQoJCQl9IGVsc2UgaWYgKCAhdHJhZGl0aW9uYWwgJiYgb2JqICE9IG51bGwgJiYgdHlwZW9mIG9iaiA9PT0gIm9iamVjdCIgKSB7CgkJCQkvLyBTZXJpYWxpemUgb2JqZWN0IGl0ZW0uCgkJCQlqUXVlcnkuZWFjaCggb2JqLCBmdW5jdGlvbiggaywgdiApIHsKCQkJCQlidWlsZFBhcmFtcyggcHJlZml4ICsgIlsiICsgayArICJdIiwgdiApOwoJCQkJfSk7CgkJCQkJCgkJCX0gZWxzZSB7CgkJCQkvLyBTZXJpYWxpemUgc2NhbGFyIGl0ZW0uCgkJCQlhZGQoIHByZWZpeCwgb2JqICk7CgkJCX0KCQl9CgoJCWZ1bmN0aW9uIGFkZCgga2V5LCB2YWx1ZSApIHsKCQkJLy8gSWYgdmFsdWUgaXMgYSBmdW5jdGlvbiwgaW52b2tlIGl0IGFuZCByZXR1cm4gaXRzIHZhbHVlCgkJCXZhbHVlID0galF1ZXJ5LmlzRnVuY3Rpb24odmFsdWUpID8gdmFsdWUoKSA6IHZhbHVlOwoJCQlzWyBzLmxlbmd0aCBdID0gZW5jb2RlVVJJQ29tcG9uZW50KGtleSkgKyAiPSIgKyBlbmNvZGVVUklDb21wb25lbnQodmFsdWUpOwoJCX0KCX0KfSk7CnZhciBlbGVtZGlzcGxheSA9IHt9LAoJcmZ4dHlwZXMgPSAvdG9nZ2xlfHNob3d8aGlkZS8sCglyZnhudW0gPSAvXihbKy1dPSk/KFtcZCstLl0rKSguKikkLywKCXRpbWVySWQsCglmeEF0dHJzID0gWwoJCS8vIGhlaWdodCBhbmltYXRpb25zCgkJWyAiaGVpZ2h0IiwgIm1hcmdpblRvcCIsICJtYXJnaW5Cb3R0b20iLCAicGFkZGluZ1RvcCIsICJwYWRkaW5nQm90dG9tIiBdLAoJCS8vIHdpZHRoIGFuaW1hdGlvbnMKCQlbICJ3aWR0aCIsICJtYXJnaW5MZWZ0IiwgIm1hcmdpblJpZ2h0IiwgInBhZGRpbmdMZWZ0IiwgInBhZGRpbmdSaWdodCIgXSwKCQkvLyBvcGFjaXR5IGFuaW1hdGlvbnMKCQlbICJvcGFjaXR5IiBdCgldOwoKalF1ZXJ5LmZuLmV4dGVuZCh7CglzaG93OiBmdW5jdGlvbiggc3BlZWQsIGNhbGxiYWNrICkgewoJCWlmICggc3BlZWQgfHwgc3BlZWQgPT09IDApIHsKCQkJcmV0dXJuIHRoaXMuYW5pbWF0ZSggZ2VuRngoInNob3ciLCAzKSwgc3BlZWQsIGNhbGxiYWNrKTsKCgkJfSBlbHNlIHsKCQkJZm9yICggdmFyIGkgPSAwLCBsID0gdGhpcy5sZW5ndGg7IGkgPCBsOyBpKysgKSB7CgkJCQl2YXIgb2xkID0galF1ZXJ5LmRhdGEodGhpc1tpXSwgIm9sZGRpc3BsYXkiKTsKCgkJCQl0aGlzW2ldLnN0eWxlLmRpc3BsYXkgPSBvbGQgfHwgIiI7CgoJCQkJaWYgKCBqUXVlcnkuY3NzKHRoaXNbaV0sICJkaXNwbGF5IikgPT09ICJub25lIiApIHsKCQkJCQl2YXIgbm9kZU5hbWUgPSB0aGlzW2ldLm5vZGVOYW1lLCBkaXNwbGF5OwoKCQkJCQlpZiAoIGVsZW1kaXNwbGF5WyBub2RlTmFtZSBdICkgewoJCQkJCQlkaXNwbGF5ID0gZWxlbWRpc3BsYXlbIG5vZGVOYW1lIF07CgoJCQkJCX0gZWxzZSB7CgkJCQkJCXZhciBlbGVtID0galF1ZXJ5KCI8IiArIG5vZGVOYW1lICsgIiAvPiIpLmFwcGVuZFRvKCJib2R5Iik7CgoJCQkJCQlkaXNwbGF5ID0gZWxlbS5jc3MoImRpc3BsYXkiKTsKCgkJCQkJCWlmICggZGlzcGxheSA9PT0gIm5vbmUiICkgewoJCQkJCQkJZGlzcGxheSA9ICJibG9jayI7CgkJCQkJCX0KCgkJCQkJCWVsZW0ucmVtb3ZlKCk7CgoJCQkJCQllbGVtZGlzcGxheVsgbm9kZU5hbWUgXSA9IGRpc3BsYXk7CgkJCQkJfQoKCQkJCQlqUXVlcnkuZGF0YSh0aGlzW2ldLCAib2xkZGlzcGxheSIsIGRpc3BsYXkpOwoJCQkJfQoJCQl9CgoJCQkvLyBTZXQgdGhlIGRpc3BsYXkgb2YgdGhlIGVsZW1lbnRzIGluIGEgc2Vjb25kIGxvb3AKCQkJLy8gdG8gYXZvaWQgdGhlIGNvbnN0YW50IHJlZmxvdwoJCQlmb3IgKCB2YXIgaiA9IDAsIGsgPSB0aGlzLmxlbmd0aDsgaiA8IGs7IGorKyApIHsKCQkJCXRoaXNbal0uc3R5bGUuZGlzcGxheSA9IGpRdWVyeS5kYXRhKHRoaXNbal0sICJvbGRkaXNwbGF5IikgfHwgIiI7CgkJCX0KCgkJCXJldHVybiB0aGlzOwoJCX0KCX0sCgoJaGlkZTogZnVuY3Rpb24oIHNwZWVkLCBjYWxsYmFjayApIHsKCQlpZiAoIHNwZWVkIHx8IHNwZWVkID09PSAwICkgewoJCQlyZXR1cm4gdGhpcy5hbmltYXRlKCBnZW5GeCgiaGlkZSIsIDMpLCBzcGVlZCwgY2FsbGJhY2spOwoKCQl9IGVsc2UgewoJCQlmb3IgKCB2YXIgaSA9IDAsIGwgPSB0aGlzLmxlbmd0aDsgaSA8IGw7IGkrKyApIHsKCQkJCXZhciBvbGQgPSBqUXVlcnkuZGF0YSh0aGlzW2ldLCAib2xkZGlzcGxheSIpOwoJCQkJaWYgKCAhb2xkICYmIG9sZCAhPT0gIm5vbmUiICkgewoJCQkJCWpRdWVyeS5kYXRhKHRoaXNbaV0sICJvbGRkaXNwbGF5IiwgalF1ZXJ5LmNzcyh0aGlzW2ldLCAiZGlzcGxheSIpKTsKCQkJCX0KCQkJfQoKCQkJLy8gU2V0IHRoZSBkaXNwbGF5IG9mIHRoZSBlbGVtZW50cyBpbiBhIHNlY29uZCBsb29wCgkJCS8vIHRvIGF2b2lkIHRoZSBjb25zdGFudCByZWZsb3cKCQkJZm9yICggdmFyIGogPSAwLCBrID0gdGhpcy5sZW5ndGg7IGogPCBrOyBqKysgKSB7CgkJCQl0aGlzW2pdLnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7CgkJCX0KCgkJCXJldHVybiB0aGlzOwoJCX0KCX0sCgoJLy8gU2F2ZSB0aGUgb2xkIHRvZ2dsZSBmdW5jdGlvbgoJX3RvZ2dsZTogalF1ZXJ5LmZuLnRvZ2dsZSwKCgl0b2dnbGU6IGZ1bmN0aW9uKCBmbiwgZm4yICkgewoJCXZhciBib29sID0gdHlwZW9mIGZuID09PSAiYm9vbGVhbiI7CgoJCWlmICggalF1ZXJ5LmlzRnVuY3Rpb24oZm4pICYmIGpRdWVyeS5pc0Z1bmN0aW9uKGZuMikgKSB7CgkJCXRoaXMuX3RvZ2dsZS5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgoJCX0gZWxzZSBpZiAoIGZuID09IG51bGwgfHwgYm9vbCApIHsKCQkJdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJdmFyIHN0YXRlID0gYm9vbCA/IGZuIDogalF1ZXJ5KHRoaXMpLmlzKCI6aGlkZGVuIik7CgkJCQlqUXVlcnkodGhpcylbIHN0YXRlID8gInNob3ciIDogImhpZGUiIF0oKTsKCQkJfSk7CgoJCX0gZWxzZSB7CgkJCXRoaXMuYW5pbWF0ZShnZW5GeCgidG9nZ2xlIiwgMyksIGZuLCBmbjIpOwoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWZhZGVUbzogZnVuY3Rpb24oIHNwZWVkLCB0bywgY2FsbGJhY2sgKSB7CgkJcmV0dXJuIHRoaXMuZmlsdGVyKCI6aGlkZGVuIikuY3NzKCJvcGFjaXR5IiwgMCkuc2hvdygpLmVuZCgpCgkJCQkJLmFuaW1hdGUoe29wYWNpdHk6IHRvfSwgc3BlZWQsIGNhbGxiYWNrKTsKCX0sCgoJYW5pbWF0ZTogZnVuY3Rpb24oIHByb3AsIHNwZWVkLCBlYXNpbmcsIGNhbGxiYWNrICkgewoJCXZhciBvcHRhbGwgPSBqUXVlcnkuc3BlZWQoc3BlZWQsIGVhc2luZywgY2FsbGJhY2spOwoKCQlpZiAoIGpRdWVyeS5pc0VtcHR5T2JqZWN0KCBwcm9wICkgKSB7CgkJCXJldHVybiB0aGlzLmVhY2goIG9wdGFsbC5jb21wbGV0ZSApOwoJCX0KCgkJcmV0dXJuIHRoaXNbIG9wdGFsbC5xdWV1ZSA9PT0gZmFsc2UgPyAiZWFjaCIgOiAicXVldWUiIF0oZnVuY3Rpb24oKSB7CgkJCXZhciBvcHQgPSBqUXVlcnkuZXh0ZW5kKHt9LCBvcHRhbGwpLCBwLAoJCQkJaGlkZGVuID0gdGhpcy5ub2RlVHlwZSA9PT0gMSAmJiBqUXVlcnkodGhpcykuaXMoIjpoaWRkZW4iKSwKCQkJCXNlbGYgPSB0aGlzOwoKCQkJZm9yICggcCBpbiBwcm9wICkgewoJCQkJdmFyIG5hbWUgPSBwLnJlcGxhY2UocmRhc2hBbHBoYSwgZmNhbWVsQ2FzZSk7CgoJCQkJaWYgKCBwICE9PSBuYW1lICkgewoJCQkJCXByb3BbIG5hbWUgXSA9IHByb3BbIHAgXTsKCQkJCQlkZWxldGUgcHJvcFsgcCBdOwoJCQkJCXAgPSBuYW1lOwoJCQkJfQoKCQkJCWlmICggcHJvcFtwXSA9PT0gImhpZGUiICYmIGhpZGRlbiB8fCBwcm9wW3BdID09PSAic2hvdyIgJiYgIWhpZGRlbiApIHsKCQkJCQlyZXR1cm4gb3B0LmNvbXBsZXRlLmNhbGwodGhpcyk7CgkJCQl9CgoJCQkJaWYgKCAoIHAgPT09ICJoZWlnaHQiIHx8IHAgPT09ICJ3aWR0aCIgKSAmJiB0aGlzLnN0eWxlICkgewoJCQkJCS8vIFN0b3JlIGRpc3BsYXkgcHJvcGVydHkKCQkJCQlvcHQuZGlzcGxheSA9IGpRdWVyeS5jc3ModGhpcywgImRpc3BsYXkiKTsKCgkJCQkJLy8gTWFrZSBzdXJlIHRoYXQgbm90aGluZyBzbmVha3Mgb3V0CgkJCQkJb3B0Lm92ZXJmbG93ID0gdGhpcy5zdHlsZS5vdmVyZmxvdzsKCQkJCX0KCgkJCQlpZiAoIGpRdWVyeS5pc0FycmF5KCBwcm9wW3BdICkgKSB7CgkJCQkJLy8gQ3JlYXRlIChpZiBuZWVkZWQpIGFuZCBhZGQgdG8gc3BlY2lhbEVhc2luZwoJCQkJCShvcHQuc3BlY2lhbEVhc2luZyA9IG9wdC5zcGVjaWFsRWFzaW5nIHx8IHt9KVtwXSA9IHByb3BbcF1bMV07CgkJCQkJcHJvcFtwXSA9IHByb3BbcF1bMF07CgkJCQl9CgkJCX0KCgkJCWlmICggb3B0Lm92ZXJmbG93ICE9IG51bGwgKSB7CgkJCQl0aGlzLnN0eWxlLm92ZXJmbG93ID0gImhpZGRlbiI7CgkJCX0KCgkJCW9wdC5jdXJBbmltID0galF1ZXJ5LmV4dGVuZCh7fSwgcHJvcCk7CgoJCQlqUXVlcnkuZWFjaCggcHJvcCwgZnVuY3Rpb24oIG5hbWUsIHZhbCApIHsKCQkJCXZhciBlID0gbmV3IGpRdWVyeS5meCggc2VsZiwgb3B0LCBuYW1lICk7CgoJCQkJaWYgKCByZnh0eXBlcy50ZXN0KHZhbCkgKSB7CgkJCQkJZVsgdmFsID09PSAidG9nZ2xlIiA/IGhpZGRlbiA/ICJzaG93IiA6ICJoaWRlIiA6IHZhbCBdKCBwcm9wICk7CgoJCQkJfSBlbHNlIHsKCQkJCQl2YXIgcGFydHMgPSByZnhudW0uZXhlYyh2YWwpLAoJCQkJCQlzdGFydCA9IGUuY3VyKHRydWUpIHx8IDA7CgoJCQkJCWlmICggcGFydHMgKSB7CgkJCQkJCXZhciBlbmQgPSBwYXJzZUZsb2F0KCBwYXJ0c1syXSApLAoJCQkJCQkJdW5pdCA9IHBhcnRzWzNdIHx8ICJweCI7CgoJCQkJCQkvLyBXZSBuZWVkIHRvIGNvbXB1dGUgc3RhcnRpbmcgdmFsdWUKCQkJCQkJaWYgKCB1bml0ICE9PSAicHgiICkgewoJCQkJCQkJc2VsZi5zdHlsZVsgbmFtZSBdID0gKGVuZCB8fCAxKSArIHVuaXQ7CgkJCQkJCQlzdGFydCA9ICgoZW5kIHx8IDEpIC8gZS5jdXIodHJ1ZSkpICogc3RhcnQ7CgkJCQkJCQlzZWxmLnN0eWxlWyBuYW1lIF0gPSBzdGFydCArIHVuaXQ7CgkJCQkJCX0KCgkJCQkJCS8vIElmIGEgKz0vLT0gdG9rZW4gd2FzIHByb3ZpZGVkLCB3ZSdyZSBkb2luZyBhIHJlbGF0aXZlIGFuaW1hdGlvbgoJCQkJCQlpZiAoIHBhcnRzWzFdICkgewoJCQkJCQkJZW5kID0gKChwYXJ0c1sxXSA9PT0gIi09IiA/IC0xIDogMSkgKiBlbmQpICsgc3RhcnQ7CgkJCQkJCX0KCgkJCQkJCWUuY3VzdG9tKCBzdGFydCwgZW5kLCB1bml0ICk7CgoJCQkJCX0gZWxzZSB7CgkJCQkJCWUuY3VzdG9tKCBzdGFydCwgdmFsLCAiIiApOwoJCQkJCX0KCQkJCX0KCQkJfSk7CgoJCQkvLyBGb3IgSlMgc3RyaWN0IGNvbXBsaWFuY2UKCQkJcmV0dXJuIHRydWU7CgkJfSk7Cgl9LAoKCXN0b3A6IGZ1bmN0aW9uKCBjbGVhclF1ZXVlLCBnb3RvRW5kICkgewoJCXZhciB0aW1lcnMgPSBqUXVlcnkudGltZXJzOwoKCQlpZiAoIGNsZWFyUXVldWUgKSB7CgkJCXRoaXMucXVldWUoW10pOwoJCX0KCgkJdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQkvLyBnbyBpbiByZXZlcnNlIG9yZGVyIHNvIGFueXRoaW5nIGFkZGVkIHRvIHRoZSBxdWV1ZSBkdXJpbmcgdGhlIGxvb3AgaXMgaWdub3JlZAoJCQlmb3IgKCB2YXIgaSA9IHRpbWVycy5sZW5ndGggLSAxOyBpID49IDA7IGktLSApIHsKCQkJCWlmICggdGltZXJzW2ldLmVsZW0gPT09IHRoaXMgKSB7CgkJCQkJaWYgKGdvdG9FbmQpIHsKCQkJCQkJLy8gZm9yY2UgdGhlIG5leHQgc3RlcCB0byBiZSB0aGUgbGFzdAoJCQkJCQl0aW1lcnNbaV0odHJ1ZSk7CgkJCQkJfQoKCQkJCQl0aW1lcnMuc3BsaWNlKGksIDEpOwoJCQkJfQoJCQl9CgkJfSk7CgoJCS8vIHN0YXJ0IHRoZSBuZXh0IGluIHRoZSBxdWV1ZSBpZiB0aGUgbGFzdCBzdGVwIHdhc24ndCBmb3JjZWQKCQlpZiAoICFnb3RvRW5kICkgewoJCQl0aGlzLmRlcXVldWUoKTsKCQl9CgoJCXJldHVybiB0aGlzOwoJfQoKfSk7CgovLyBHZW5lcmF0ZSBzaG9ydGN1dHMgZm9yIGN1c3RvbSBhbmltYXRpb25zCmpRdWVyeS5lYWNoKHsKCXNsaWRlRG93bjogZ2VuRngoInNob3ciLCAxKSwKCXNsaWRlVXA6IGdlbkZ4KCJoaWRlIiwgMSksCglzbGlkZVRvZ2dsZTogZ2VuRngoInRvZ2dsZSIsIDEpLAoJZmFkZUluOiB7IG9wYWNpdHk6ICJzaG93IiB9LAoJZmFkZU91dDogeyBvcGFjaXR5OiAiaGlkZSIgfQp9LCBmdW5jdGlvbiggbmFtZSwgcHJvcHMgKSB7CglqUXVlcnkuZm5bIG5hbWUgXSA9IGZ1bmN0aW9uKCBzcGVlZCwgY2FsbGJhY2sgKSB7CgkJcmV0dXJuIHRoaXMuYW5pbWF0ZSggcHJvcHMsIHNwZWVkLCBjYWxsYmFjayApOwoJfTsKfSk7CgpqUXVlcnkuZXh0ZW5kKHsKCXNwZWVkOiBmdW5jdGlvbiggc3BlZWQsIGVhc2luZywgZm4gKSB7CgkJdmFyIG9wdCA9IHNwZWVkICYmIHR5cGVvZiBzcGVlZCA9PT0gIm9iamVjdCIgPyBzcGVlZCA6IHsKCQkJY29tcGxldGU6IGZuIHx8ICFmbiAmJiBlYXNpbmcgfHwKCQkJCWpRdWVyeS5pc0Z1bmN0aW9uKCBzcGVlZCApICYmIHNwZWVkLAoJCQlkdXJhdGlvbjogc3BlZWQsCgkJCWVhc2luZzogZm4gJiYgZWFzaW5nIHx8IGVhc2luZyAmJiAhalF1ZXJ5LmlzRnVuY3Rpb24oZWFzaW5nKSAmJiBlYXNpbmcKCQl9OwoKCQlvcHQuZHVyYXRpb24gPSBqUXVlcnkuZngub2ZmID8gMCA6IHR5cGVvZiBvcHQuZHVyYXRpb24gPT09ICJudW1iZXIiID8gb3B0LmR1cmF0aW9uIDoKCQkJalF1ZXJ5LmZ4LnNwZWVkc1tvcHQuZHVyYXRpb25dIHx8IGpRdWVyeS5meC5zcGVlZHMuX2RlZmF1bHQ7CgoJCS8vIFF1ZXVlaW5nCgkJb3B0Lm9sZCA9IG9wdC5jb21wbGV0ZTsKCQlvcHQuY29tcGxldGUgPSBmdW5jdGlvbigpIHsKCQkJaWYgKCBvcHQucXVldWUgIT09IGZhbHNlICkgewoJCQkJalF1ZXJ5KHRoaXMpLmRlcXVldWUoKTsKCQkJfQoJCQlpZiAoIGpRdWVyeS5pc0Z1bmN0aW9uKCBvcHQub2xkICkgKSB7CgkJCQlvcHQub2xkLmNhbGwoIHRoaXMgKTsKCQkJfQoJCX07CgoJCXJldHVybiBvcHQ7Cgl9LAoKCWVhc2luZzogewoJCWxpbmVhcjogZnVuY3Rpb24oIHAsIG4sIGZpcnN0TnVtLCBkaWZmICkgewoJCQlyZXR1cm4gZmlyc3ROdW0gKyBkaWZmICogcDsKCQl9LAoJCXN3aW5nOiBmdW5jdGlvbiggcCwgbiwgZmlyc3ROdW0sIGRpZmYgKSB7CgkJCXJldHVybiAoKC1NYXRoLmNvcyhwKk1hdGguUEkpLzIpICsgMC41KSAqIGRpZmYgKyBmaXJzdE51bTsKCQl9Cgl9LAoKCXRpbWVyczogW10sCgoJZng6IGZ1bmN0aW9uKCBlbGVtLCBvcHRpb25zLCBwcm9wICkgewoJCXRoaXMub3B0aW9ucyA9IG9wdGlvbnM7CgkJdGhpcy5lbGVtID0gZWxlbTsKCQl0aGlzLnByb3AgPSBwcm9wOwoKCQlpZiAoICFvcHRpb25zLm9yaWcgKSB7CgkJCW9wdGlvbnMub3JpZyA9IHt9OwoJCX0KCX0KCn0pOwoKalF1ZXJ5LmZ4LnByb3RvdHlwZSA9IHsKCS8vIFNpbXBsZSBmdW5jdGlvbiBmb3Igc2V0dGluZyBhIHN0eWxlIHZhbHVlCgl1cGRhdGU6IGZ1bmN0aW9uKCkgewoJCWlmICggdGhpcy5vcHRpb25zLnN0ZXAgKSB7CgkJCXRoaXMub3B0aW9ucy5zdGVwLmNhbGwoIHRoaXMuZWxlbSwgdGhpcy5ub3csIHRoaXMgKTsKCQl9CgoJCShqUXVlcnkuZnguc3RlcFt0aGlzLnByb3BdIHx8IGpRdWVyeS5meC5zdGVwLl9kZWZhdWx0KSggdGhpcyApOwoKCQkvLyBTZXQgZGlzcGxheSBwcm9wZXJ0eSB0byBibG9jayBmb3IgaGVpZ2h0L3dpZHRoIGFuaW1hdGlvbnMKCQlpZiAoICggdGhpcy5wcm9wID09PSAiaGVpZ2h0IiB8fCB0aGlzLnByb3AgPT09ICJ3aWR0aCIgKSAmJiB0aGlzLmVsZW0uc3R5bGUgKSB7CgkJCXRoaXMuZWxlbS5zdHlsZS5kaXNwbGF5ID0gImJsb2NrIjsKCQl9Cgl9LAoKCS8vIEdldCB0aGUgY3VycmVudCBzaXplCgljdXI6IGZ1bmN0aW9uKCBmb3JjZSApIHsKCQlpZiAoIHRoaXMuZWxlbVt0aGlzLnByb3BdICE9IG51bGwgJiYgKCF0aGlzLmVsZW0uc3R5bGUgfHwgdGhpcy5lbGVtLnN0eWxlW3RoaXMucHJvcF0gPT0gbnVsbCkgKSB7CgkJCXJldHVybiB0aGlzLmVsZW1bIHRoaXMucHJvcCBdOwoJCX0KCgkJdmFyIHIgPSBwYXJzZUZsb2F0KGpRdWVyeS5jc3ModGhpcy5lbGVtLCB0aGlzLnByb3AsIGZvcmNlKSk7CgkJcmV0dXJuIHIgJiYgciA+IC0xMDAwMCA/IHIgOiBwYXJzZUZsb2F0KGpRdWVyeS5jdXJDU1ModGhpcy5lbGVtLCB0aGlzLnByb3ApKSB8fCAwOwoJfSwKCgkvLyBTdGFydCBhbiBhbmltYXRpb24gZnJvbSBvbmUgbnVtYmVyIHRvIGFub3RoZXIKCWN1c3RvbTogZnVuY3Rpb24oIGZyb20sIHRvLCB1bml0ICkgewoJCXRoaXMuc3RhcnRUaW1lID0gbm93KCk7CgkJdGhpcy5zdGFydCA9IGZyb207CgkJdGhpcy5lbmQgPSB0bzsKCQl0aGlzLnVuaXQgPSB1bml0IHx8IHRoaXMudW5pdCB8fCAicHgiOwoJCXRoaXMubm93ID0gdGhpcy5zdGFydDsKCQl0aGlzLnBvcyA9IHRoaXMuc3RhdGUgPSAwOwoKCQl2YXIgc2VsZiA9IHRoaXM7CgkJZnVuY3Rpb24gdCggZ290b0VuZCApIHsKCQkJcmV0dXJuIHNlbGYuc3RlcChnb3RvRW5kKTsKCQl9CgoJCXQuZWxlbSA9IHRoaXMuZWxlbTsKCgkJaWYgKCB0KCkgJiYgalF1ZXJ5LnRpbWVycy5wdXNoKHQpICYmICF0aW1lcklkICkgewoJCQl0aW1lcklkID0gc2V0SW50ZXJ2YWwoalF1ZXJ5LmZ4LnRpY2ssIDEzKTsKCQl9Cgl9LAoKCS8vIFNpbXBsZSAnc2hvdycgZnVuY3Rpb24KCXNob3c6IGZ1bmN0aW9uKCkgewoJCS8vIFJlbWVtYmVyIHdoZXJlIHdlIHN0YXJ0ZWQsIHNvIHRoYXQgd2UgY2FuIGdvIGJhY2sgdG8gaXQgbGF0ZXIKCQl0aGlzLm9wdGlvbnMub3JpZ1t0aGlzLnByb3BdID0galF1ZXJ5LnN0eWxlKCB0aGlzLmVsZW0sIHRoaXMucHJvcCApOwoJCXRoaXMub3B0aW9ucy5zaG93ID0gdHJ1ZTsKCgkJLy8gQmVnaW4gdGhlIGFuaW1hdGlvbgoJCS8vIE1ha2Ugc3VyZSB0aGF0IHdlIHN0YXJ0IGF0IGEgc21hbGwgd2lkdGgvaGVpZ2h0IHRvIGF2b2lkIGFueQoJCS8vIGZsYXNoIG9mIGNvbnRlbnQKCQl0aGlzLmN1c3RvbSh0aGlzLnByb3AgPT09ICJ3aWR0aCIgfHwgdGhpcy5wcm9wID09PSAiaGVpZ2h0IiA/IDEgOiAwLCB0aGlzLmN1cigpKTsKCgkJLy8gU3RhcnQgYnkgc2hvd2luZyB0aGUgZWxlbWVudAoJCWpRdWVyeSggdGhpcy5lbGVtICkuc2hvdygpOwoJfSwKCgkvLyBTaW1wbGUgJ2hpZGUnIGZ1bmN0aW9uCgloaWRlOiBmdW5jdGlvbigpIHsKCQkvLyBSZW1lbWJlciB3aGVyZSB3ZSBzdGFydGVkLCBzbyB0aGF0IHdlIGNhbiBnbyBiYWNrIHRvIGl0IGxhdGVyCgkJdGhpcy5vcHRpb25zLm9yaWdbdGhpcy5wcm9wXSA9IGpRdWVyeS5zdHlsZSggdGhpcy5lbGVtLCB0aGlzLnByb3AgKTsKCQl0aGlzLm9wdGlvbnMuaGlkZSA9IHRydWU7CgoJCS8vIEJlZ2luIHRoZSBhbmltYXRpb24KCQl0aGlzLmN1c3RvbSh0aGlzLmN1cigpLCAwKTsKCX0sCgoJLy8gRWFjaCBzdGVwIG9mIGFuIGFuaW1hdGlvbgoJc3RlcDogZnVuY3Rpb24oIGdvdG9FbmQgKSB7CgkJdmFyIHQgPSBub3coKSwgZG9uZSA9IHRydWU7CgoJCWlmICggZ290b0VuZCB8fCB0ID49IHRoaXMub3B0aW9ucy5kdXJhdGlvbiArIHRoaXMuc3RhcnRUaW1lICkgewoJCQl0aGlzLm5vdyA9IHRoaXMuZW5kOwoJCQl0aGlzLnBvcyA9IHRoaXMuc3RhdGUgPSAxOwoJCQl0aGlzLnVwZGF0ZSgpOwoKCQkJdGhpcy5vcHRpb25zLmN1ckFuaW1bIHRoaXMucHJvcCBdID0gdHJ1ZTsKCgkJCWZvciAoIHZhciBpIGluIHRoaXMub3B0aW9ucy5jdXJBbmltICkgewoJCQkJaWYgKCB0aGlzLm9wdGlvbnMuY3VyQW5pbVtpXSAhPT0gdHJ1ZSApIHsKCQkJCQlkb25lID0gZmFsc2U7CgkJCQl9CgkJCX0KCgkJCWlmICggZG9uZSApIHsKCQkJCWlmICggdGhpcy5vcHRpb25zLmRpc3BsYXkgIT0gbnVsbCApIHsKCQkJCQkvLyBSZXNldCB0aGUgb3ZlcmZsb3cKCQkJCQl0aGlzLmVsZW0uc3R5bGUub3ZlcmZsb3cgPSB0aGlzLm9wdGlvbnMub3ZlcmZsb3c7CgoJCQkJCS8vIFJlc2V0IHRoZSBkaXNwbGF5CgkJCQkJdmFyIG9sZCA9IGpRdWVyeS5kYXRhKHRoaXMuZWxlbSwgIm9sZGRpc3BsYXkiKTsKCQkJCQl0aGlzLmVsZW0uc3R5bGUuZGlzcGxheSA9IG9sZCA/IG9sZCA6IHRoaXMub3B0aW9ucy5kaXNwbGF5OwoKCQkJCQlpZiAoIGpRdWVyeS5jc3ModGhpcy5lbGVtLCAiZGlzcGxheSIpID09PSAibm9uZSIgKSB7CgkJCQkJCXRoaXMuZWxlbS5zdHlsZS5kaXNwbGF5ID0gImJsb2NrIjsKCQkJCQl9CgkJCQl9CgoJCQkJLy8gSGlkZSB0aGUgZWxlbWVudCBpZiB0aGUgImhpZGUiIG9wZXJhdGlvbiB3YXMgZG9uZQoJCQkJaWYgKCB0aGlzLm9wdGlvbnMuaGlkZSApIHsKCQkJCQlqUXVlcnkodGhpcy5lbGVtKS5oaWRlKCk7CgkJCQl9CgoJCQkJLy8gUmVzZXQgdGhlIHByb3BlcnRpZXMsIGlmIHRoZSBpdGVtIGhhcyBiZWVuIGhpZGRlbiBvciBzaG93bgoJCQkJaWYgKCB0aGlzLm9wdGlvbnMuaGlkZSB8fCB0aGlzLm9wdGlvbnMuc2hvdyApIHsKCQkJCQlmb3IgKCB2YXIgcCBpbiB0aGlzLm9wdGlvbnMuY3VyQW5pbSApIHsKCQkJCQkJalF1ZXJ5LnN0eWxlKHRoaXMuZWxlbSwgcCwgdGhpcy5vcHRpb25zLm9yaWdbcF0pOwoJCQkJCX0KCQkJCX0KCgkJCQkvLyBFeGVjdXRlIHRoZSBjb21wbGV0ZSBmdW5jdGlvbgoJCQkJdGhpcy5vcHRpb25zLmNvbXBsZXRlLmNhbGwoIHRoaXMuZWxlbSApOwoJCQl9CgoJCQlyZXR1cm4gZmFsc2U7CgoJCX0gZWxzZSB7CgkJCXZhciBuID0gdCAtIHRoaXMuc3RhcnRUaW1lOwoJCQl0aGlzLnN0YXRlID0gbiAvIHRoaXMub3B0aW9ucy5kdXJhdGlvbjsKCgkJCS8vIFBlcmZvcm0gdGhlIGVhc2luZyBmdW5jdGlvbiwgZGVmYXVsdHMgdG8gc3dpbmcKCQkJdmFyIHNwZWNpYWxFYXNpbmcgPSB0aGlzLm9wdGlvbnMuc3BlY2lhbEVhc2luZyAmJiB0aGlzLm9wdGlvbnMuc3BlY2lhbEVhc2luZ1t0aGlzLnByb3BdOwoJCQl2YXIgZGVmYXVsdEVhc2luZyA9IHRoaXMub3B0aW9ucy5lYXNpbmcgfHwgKGpRdWVyeS5lYXNpbmcuc3dpbmcgPyAic3dpbmciIDogImxpbmVhciIpOwoJCQl0aGlzLnBvcyA9IGpRdWVyeS5lYXNpbmdbc3BlY2lhbEVhc2luZyB8fCBkZWZhdWx0RWFzaW5nXSh0aGlzLnN0YXRlLCBuLCAwLCAxLCB0aGlzLm9wdGlvbnMuZHVyYXRpb24pOwoJCQl0aGlzLm5vdyA9IHRoaXMuc3RhcnQgKyAoKHRoaXMuZW5kIC0gdGhpcy5zdGFydCkgKiB0aGlzLnBvcyk7CgoJCQkvLyBQZXJmb3JtIHRoZSBuZXh0IHN0ZXAgb2YgdGhlIGFuaW1hdGlvbgoJCQl0aGlzLnVwZGF0ZSgpOwoJCX0KCgkJcmV0dXJuIHRydWU7Cgl9Cn07CgpqUXVlcnkuZXh0ZW5kKCBqUXVlcnkuZngsIHsKCXRpY2s6IGZ1bmN0aW9uKCkgewoJCXZhciB0aW1lcnMgPSBqUXVlcnkudGltZXJzOwoKCQlmb3IgKCB2YXIgaSA9IDA7IGkgPCB0aW1lcnMubGVuZ3RoOyBpKysgKSB7CgkJCWlmICggIXRpbWVyc1tpXSgpICkgewoJCQkJdGltZXJzLnNwbGljZShpLS0sIDEpOwoJCQl9CgkJfQoKCQlpZiAoICF0aW1lcnMubGVuZ3RoICkgewoJCQlqUXVlcnkuZnguc3RvcCgpOwoJCX0KCX0sCgkJCglzdG9wOiBmdW5jdGlvbigpIHsKCQljbGVhckludGVydmFsKCB0aW1lcklkICk7CgkJdGltZXJJZCA9IG51bGw7Cgl9LAoJCglzcGVlZHM6IHsKCQlzbG93OiA2MDAsCiAJCWZhc3Q6IDIwMCwKIAkJLy8gRGVmYXVsdCBzcGVlZAogCQlfZGVmYXVsdDogNDAwCgl9LAoKCXN0ZXA6IHsKCQlvcGFjaXR5OiBmdW5jdGlvbiggZnggKSB7CgkJCWpRdWVyeS5zdHlsZShmeC5lbGVtLCAib3BhY2l0eSIsIGZ4Lm5vdyk7CgkJfSwKCgkJX2RlZmF1bHQ6IGZ1bmN0aW9uKCBmeCApIHsKCQkJaWYgKCBmeC5lbGVtLnN0eWxlICYmIGZ4LmVsZW0uc3R5bGVbIGZ4LnByb3AgXSAhPSBudWxsICkgewoJCQkJZnguZWxlbS5zdHlsZVsgZngucHJvcCBdID0gKGZ4LnByb3AgPT09ICJ3aWR0aCIgfHwgZngucHJvcCA9PT0gImhlaWdodCIgPyBNYXRoLm1heCgwLCBmeC5ub3cpIDogZngubm93KSArIGZ4LnVuaXQ7CgkJCX0gZWxzZSB7CgkJCQlmeC5lbGVtWyBmeC5wcm9wIF0gPSBmeC5ub3c7CgkJCX0KCQl9Cgl9Cn0pOwoKaWYgKCBqUXVlcnkuZXhwciAmJiBqUXVlcnkuZXhwci5maWx0ZXJzICkgewoJalF1ZXJ5LmV4cHIuZmlsdGVycy5hbmltYXRlZCA9IGZ1bmN0aW9uKCBlbGVtICkgewoJCXJldHVybiBqUXVlcnkuZ3JlcChqUXVlcnkudGltZXJzLCBmdW5jdGlvbiggZm4gKSB7CgkJCXJldHVybiBlbGVtID09PSBmbi5lbGVtOwoJCX0pLmxlbmd0aDsKCX07Cn0KCmZ1bmN0aW9uIGdlbkZ4KCB0eXBlLCBudW0gKSB7Cgl2YXIgb2JqID0ge307CgoJalF1ZXJ5LmVhY2goIGZ4QXR0cnMuY29uY2F0LmFwcGx5KFtdLCBmeEF0dHJzLnNsaWNlKDAsbnVtKSksIGZ1bmN0aW9uKCkgewoJCW9ialsgdGhpcyBdID0gdHlwZTsKCX0pOwoKCXJldHVybiBvYmo7Cn0KaWYgKCAiZ2V0Qm91bmRpbmdDbGllbnRSZWN0IiBpbiBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQgKSB7CglqUXVlcnkuZm4ub2Zmc2V0ID0gZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJdmFyIGVsZW0gPSB0aGlzWzBdOwoKCQlpZiAoIG9wdGlvbnMgKSB7IAoJCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCBpICkgewoJCQkJalF1ZXJ5Lm9mZnNldC5zZXRPZmZzZXQoIHRoaXMsIG9wdGlvbnMsIGkgKTsKCQkJfSk7CgkJfQoKCQlpZiAoICFlbGVtIHx8ICFlbGVtLm93bmVyRG9jdW1lbnQgKSB7CgkJCXJldHVybiBudWxsOwoJCX0KCgkJaWYgKCBlbGVtID09PSBlbGVtLm93bmVyRG9jdW1lbnQuYm9keSApIHsKCQkJcmV0dXJuIGpRdWVyeS5vZmZzZXQuYm9keU9mZnNldCggZWxlbSApOwoJCX0KCgkJdmFyIGJveCA9IGVsZW0uZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCksIGRvYyA9IGVsZW0ub3duZXJEb2N1bWVudCwgYm9keSA9IGRvYy5ib2R5LCBkb2NFbGVtID0gZG9jLmRvY3VtZW50RWxlbWVudCwKCQkJY2xpZW50VG9wID0gZG9jRWxlbS5jbGllbnRUb3AgfHwgYm9keS5jbGllbnRUb3AgfHwgMCwgY2xpZW50TGVmdCA9IGRvY0VsZW0uY2xpZW50TGVmdCB8fCBib2R5LmNsaWVudExlZnQgfHwgMCwKCQkJdG9wICA9IGJveC50b3AgICsgKHNlbGYucGFnZVlPZmZzZXQgfHwgalF1ZXJ5LnN1cHBvcnQuYm94TW9kZWwgJiYgZG9jRWxlbS5zY3JvbGxUb3AgIHx8IGJvZHkuc2Nyb2xsVG9wICkgLSBjbGllbnRUb3AsCgkJCWxlZnQgPSBib3gubGVmdCArIChzZWxmLnBhZ2VYT2Zmc2V0IHx8IGpRdWVyeS5zdXBwb3J0LmJveE1vZGVsICYmIGRvY0VsZW0uc2Nyb2xsTGVmdCB8fCBib2R5LnNjcm9sbExlZnQpIC0gY2xpZW50TGVmdDsKCgkJcmV0dXJuIHsgdG9wOiB0b3AsIGxlZnQ6IGxlZnQgfTsKCX07Cgp9IGVsc2UgewoJalF1ZXJ5LmZuLm9mZnNldCA9IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCXZhciBlbGVtID0gdGhpc1swXTsKCgkJaWYgKCBvcHRpb25zICkgeyAKCQkJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiggaSApIHsKCQkJCWpRdWVyeS5vZmZzZXQuc2V0T2Zmc2V0KCB0aGlzLCBvcHRpb25zLCBpICk7CgkJCX0pOwoJCX0KCgkJaWYgKCAhZWxlbSB8fCAhZWxlbS5vd25lckRvY3VtZW50ICkgewoJCQlyZXR1cm4gbnVsbDsKCQl9CgoJCWlmICggZWxlbSA9PT0gZWxlbS5vd25lckRvY3VtZW50LmJvZHkgKSB7CgkJCXJldHVybiBqUXVlcnkub2Zmc2V0LmJvZHlPZmZzZXQoIGVsZW0gKTsKCQl9CgoJCWpRdWVyeS5vZmZzZXQuaW5pdGlhbGl6ZSgpOwoKCQl2YXIgb2Zmc2V0UGFyZW50ID0gZWxlbS5vZmZzZXRQYXJlbnQsIHByZXZPZmZzZXRQYXJlbnQgPSBlbGVtLAoJCQlkb2MgPSBlbGVtLm93bmVyRG9jdW1lbnQsIGNvbXB1dGVkU3R5bGUsIGRvY0VsZW0gPSBkb2MuZG9jdW1lbnRFbGVtZW50LAoJCQlib2R5ID0gZG9jLmJvZHksIGRlZmF1bHRWaWV3ID0gZG9jLmRlZmF1bHRWaWV3LAoJCQlwcmV2Q29tcHV0ZWRTdHlsZSA9IGRlZmF1bHRWaWV3ID8gZGVmYXVsdFZpZXcuZ2V0Q29tcHV0ZWRTdHlsZSggZWxlbSwgbnVsbCApIDogZWxlbS5jdXJyZW50U3R5bGUsCgkJCXRvcCA9IGVsZW0ub2Zmc2V0VG9wLCBsZWZ0ID0gZWxlbS5vZmZzZXRMZWZ0OwoKCQl3aGlsZSAoIChlbGVtID0gZWxlbS5wYXJlbnROb2RlKSAmJiBlbGVtICE9PSBib2R5ICYmIGVsZW0gIT09IGRvY0VsZW0gKSB7CgkJCWlmICggalF1ZXJ5Lm9mZnNldC5zdXBwb3J0c0ZpeGVkUG9zaXRpb24gJiYgcHJldkNvbXB1dGVkU3R5bGUucG9zaXRpb24gPT09ICJmaXhlZCIgKSB7CgkJCQlicmVhazsKCQkJfQoKCQkJY29tcHV0ZWRTdHlsZSA9IGRlZmF1bHRWaWV3ID8gZGVmYXVsdFZpZXcuZ2V0Q29tcHV0ZWRTdHlsZShlbGVtLCBudWxsKSA6IGVsZW0uY3VycmVudFN0eWxlOwoJCQl0b3AgIC09IGVsZW0uc2Nyb2xsVG9wOwoJCQlsZWZ0IC09IGVsZW0uc2Nyb2xsTGVmdDsKCgkJCWlmICggZWxlbSA9PT0gb2Zmc2V0UGFyZW50ICkgewoJCQkJdG9wICArPSBlbGVtLm9mZnNldFRvcDsKCQkJCWxlZnQgKz0gZWxlbS5vZmZzZXRMZWZ0OwoKCQkJCWlmICggalF1ZXJ5Lm9mZnNldC5kb2VzTm90QWRkQm9yZGVyICYmICEoalF1ZXJ5Lm9mZnNldC5kb2VzQWRkQm9yZGVyRm9yVGFibGVBbmRDZWxscyAmJiAvXnQoYWJsZXxkfGgpJC9pLnRlc3QoZWxlbS5ub2RlTmFtZSkpICkgewoJCQkJCXRvcCAgKz0gcGFyc2VGbG9hdCggY29tcHV0ZWRTdHlsZS5ib3JkZXJUb3BXaWR0aCAgKSB8fCAwOwoJCQkJCWxlZnQgKz0gcGFyc2VGbG9hdCggY29tcHV0ZWRTdHlsZS5ib3JkZXJMZWZ0V2lkdGggKSB8fCAwOwoJCQkJfQoKCQkJCXByZXZPZmZzZXRQYXJlbnQgPSBvZmZzZXRQYXJlbnQsIG9mZnNldFBhcmVudCA9IGVsZW0ub2Zmc2V0UGFyZW50OwoJCQl9CgoJCQlpZiAoIGpRdWVyeS5vZmZzZXQuc3VidHJhY3RzQm9yZGVyRm9yT3ZlcmZsb3dOb3RWaXNpYmxlICYmIGNvbXB1dGVkU3R5bGUub3ZlcmZsb3cgIT09ICJ2aXNpYmxlIiApIHsKCQkJCXRvcCAgKz0gcGFyc2VGbG9hdCggY29tcHV0ZWRTdHlsZS5ib3JkZXJUb3BXaWR0aCAgKSB8fCAwOwoJCQkJbGVmdCArPSBwYXJzZUZsb2F0KCBjb21wdXRlZFN0eWxlLmJvcmRlckxlZnRXaWR0aCApIHx8IDA7CgkJCX0KCgkJCXByZXZDb21wdXRlZFN0eWxlID0gY29tcHV0ZWRTdHlsZTsKCQl9CgoJCWlmICggcHJldkNvbXB1dGVkU3R5bGUucG9zaXRpb24gPT09ICJyZWxhdGl2ZSIgfHwgcHJldkNvbXB1dGVkU3R5bGUucG9zaXRpb24gPT09ICJzdGF0aWMiICkgewoJCQl0b3AgICs9IGJvZHkub2Zmc2V0VG9wOwoJCQlsZWZ0ICs9IGJvZHkub2Zmc2V0TGVmdDsKCQl9CgoJCWlmICggalF1ZXJ5Lm9mZnNldC5zdXBwb3J0c0ZpeGVkUG9zaXRpb24gJiYgcHJldkNvbXB1dGVkU3R5bGUucG9zaXRpb24gPT09ICJmaXhlZCIgKSB7CgkJCXRvcCAgKz0gTWF0aC5tYXgoIGRvY0VsZW0uc2Nyb2xsVG9wLCBib2R5LnNjcm9sbFRvcCApOwoJCQlsZWZ0ICs9IE1hdGgubWF4KCBkb2NFbGVtLnNjcm9sbExlZnQsIGJvZHkuc2Nyb2xsTGVmdCApOwoJCX0KCgkJcmV0dXJuIHsgdG9wOiB0b3AsIGxlZnQ6IGxlZnQgfTsKCX07Cn0KCmpRdWVyeS5vZmZzZXQgPSB7Cglpbml0aWFsaXplOiBmdW5jdGlvbigpIHsKCQl2YXIgYm9keSA9IGRvY3VtZW50LmJvZHksIGNvbnRhaW5lciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpLCBpbm5lckRpdiwgY2hlY2tEaXYsIHRhYmxlLCB0ZCwgYm9keU1hcmdpblRvcCA9IHBhcnNlRmxvYXQoIGpRdWVyeS5jdXJDU1MoYm9keSwgIm1hcmdpblRvcCIsIHRydWUpICkgfHwgMCwKCQkJaHRtbCA9ICI8ZGl2IHN0eWxlPSdwb3NpdGlvbjphYnNvbHV0ZTt0b3A6MDtsZWZ0OjA7bWFyZ2luOjA7Ym9yZGVyOjVweCBzb2xpZCAjMDAwO3BhZGRpbmc6MDt3aWR0aDoxcHg7aGVpZ2h0OjFweDsnPjxkaXY+PC9kaXY+PC9kaXY+PHRhYmxlIHN0eWxlPSdwb3NpdGlvbjphYnNvbHV0ZTt0b3A6MDtsZWZ0OjA7bWFyZ2luOjA7Ym9yZGVyOjVweCBzb2xpZCAjMDAwO3BhZGRpbmc6MDt3aWR0aDoxcHg7aGVpZ2h0OjFweDsnIGNlbGxwYWRkaW5nPScwJyBjZWxsc3BhY2luZz0nMCc+PHRyPjx0ZD48L3RkPjwvdHI+PC90YWJsZT4iOwoKCQlqUXVlcnkuZXh0ZW5kKCBjb250YWluZXIuc3R5bGUsIHsgcG9zaXRpb246ICJhYnNvbHV0ZSIsIHRvcDogMCwgbGVmdDogMCwgbWFyZ2luOiAwLCBib3JkZXI6IDAsIHdpZHRoOiAiMXB4IiwgaGVpZ2h0OiAiMXB4IiwgdmlzaWJpbGl0eTogImhpZGRlbiIgfSApOwoKCQljb250YWluZXIuaW5uZXJIVE1MID0gaHRtbDsKCQlib2R5Lmluc2VydEJlZm9yZSggY29udGFpbmVyLCBib2R5LmZpcnN0Q2hpbGQgKTsKCQlpbm5lckRpdiA9IGNvbnRhaW5lci5maXJzdENoaWxkOwoJCWNoZWNrRGl2ID0gaW5uZXJEaXYuZmlyc3RDaGlsZDsKCQl0ZCA9IGlubmVyRGl2Lm5leHRTaWJsaW5nLmZpcnN0Q2hpbGQuZmlyc3RDaGlsZDsKCgkJdGhpcy5kb2VzTm90QWRkQm9yZGVyID0gKGNoZWNrRGl2Lm9mZnNldFRvcCAhPT0gNSk7CgkJdGhpcy5kb2VzQWRkQm9yZGVyRm9yVGFibGVBbmRDZWxscyA9ICh0ZC5vZmZzZXRUb3AgPT09IDUpOwoKCQljaGVja0Rpdi5zdHlsZS5wb3NpdGlvbiA9ICJmaXhlZCIsIGNoZWNrRGl2LnN0eWxlLnRvcCA9ICIyMHB4IjsKCQkvLyBzYWZhcmkgc3VidHJhY3RzIHBhcmVudCBib3JkZXIgd2lkdGggaGVyZSB3aGljaCBpcyA1cHgKCQl0aGlzLnN1cHBvcnRzRml4ZWRQb3NpdGlvbiA9IChjaGVja0Rpdi5vZmZzZXRUb3AgPT09IDIwIHx8IGNoZWNrRGl2Lm9mZnNldFRvcCA9PT0gMTUpOwoJCWNoZWNrRGl2LnN0eWxlLnBvc2l0aW9uID0gY2hlY2tEaXYuc3R5bGUudG9wID0gIiI7CgoJCWlubmVyRGl2LnN0eWxlLm92ZXJmbG93ID0gImhpZGRlbiIsIGlubmVyRGl2LnN0eWxlLnBvc2l0aW9uID0gInJlbGF0aXZlIjsKCQl0aGlzLnN1YnRyYWN0c0JvcmRlckZvck92ZXJmbG93Tm90VmlzaWJsZSA9IChjaGVja0Rpdi5vZmZzZXRUb3AgPT09IC01KTsKCgkJdGhpcy5kb2VzTm90SW5jbHVkZU1hcmdpbkluQm9keU9mZnNldCA9IChib2R5Lm9mZnNldFRvcCAhPT0gYm9keU1hcmdpblRvcCk7CgoJCWJvZHkucmVtb3ZlQ2hpbGQoIGNvbnRhaW5lciApOwoJCWJvZHkgPSBjb250YWluZXIgPSBpbm5lckRpdiA9IGNoZWNrRGl2ID0gdGFibGUgPSB0ZCA9IG51bGw7CgkJalF1ZXJ5Lm9mZnNldC5pbml0aWFsaXplID0galF1ZXJ5Lm5vb3A7Cgl9LAoKCWJvZHlPZmZzZXQ6IGZ1bmN0aW9uKCBib2R5ICkgewoJCXZhciB0b3AgPSBib2R5Lm9mZnNldFRvcCwgbGVmdCA9IGJvZHkub2Zmc2V0TGVmdDsKCgkJalF1ZXJ5Lm9mZnNldC5pbml0aWFsaXplKCk7CgoJCWlmICggalF1ZXJ5Lm9mZnNldC5kb2VzTm90SW5jbHVkZU1hcmdpbkluQm9keU9mZnNldCApIHsKCQkJdG9wICArPSBwYXJzZUZsb2F0KCBqUXVlcnkuY3VyQ1NTKGJvZHksICJtYXJnaW5Ub3AiLCAgdHJ1ZSkgKSB8fCAwOwoJCQlsZWZ0ICs9IHBhcnNlRmxvYXQoIGpRdWVyeS5jdXJDU1MoYm9keSwgIm1hcmdpbkxlZnQiLCB0cnVlKSApIHx8IDA7CgkJfQoKCQlyZXR1cm4geyB0b3A6IHRvcCwgbGVmdDogbGVmdCB9OwoJfSwKCQoJc2V0T2Zmc2V0OiBmdW5jdGlvbiggZWxlbSwgb3B0aW9ucywgaSApIHsKCQkvLyBzZXQgcG9zaXRpb24gZmlyc3QsIGluLWNhc2UgdG9wL2xlZnQgYXJlIHNldCBldmVuIG9uIHN0YXRpYyBlbGVtCgkJaWYgKCAvc3RhdGljLy50ZXN0KCBqUXVlcnkuY3VyQ1NTKCBlbGVtLCAicG9zaXRpb24iICkgKSApIHsKCQkJZWxlbS5zdHlsZS5wb3NpdGlvbiA9ICJyZWxhdGl2ZSI7CgkJfQoJCXZhciBjdXJFbGVtICAgPSBqUXVlcnkoIGVsZW0gKSwKCQkJY3VyT2Zmc2V0ID0gY3VyRWxlbS5vZmZzZXQoKSwKCQkJY3VyVG9wICAgID0gcGFyc2VJbnQoIGpRdWVyeS5jdXJDU1MoIGVsZW0sICJ0b3AiLCAgdHJ1ZSApLCAxMCApIHx8IDAsCgkJCWN1ckxlZnQgICA9IHBhcnNlSW50KCBqUXVlcnkuY3VyQ1NTKCBlbGVtLCAibGVmdCIsIHRydWUgKSwgMTAgKSB8fCAwOwoKCQlpZiAoIGpRdWVyeS5pc0Z1bmN0aW9uKCBvcHRpb25zICkgKSB7CgkJCW9wdGlvbnMgPSBvcHRpb25zLmNhbGwoIGVsZW0sIGksIGN1ck9mZnNldCApOwoJCX0KCgkJdmFyIHByb3BzID0gewoJCQl0b3A6ICAob3B0aW9ucy50b3AgIC0gY3VyT2Zmc2V0LnRvcCkgICsgY3VyVG9wLAoJCQlsZWZ0OiAob3B0aW9ucy5sZWZ0IC0gY3VyT2Zmc2V0LmxlZnQpICsgY3VyTGVmdAoJCX07CgkJCgkJaWYgKCAidXNpbmciIGluIG9wdGlvbnMgKSB7CgkJCW9wdGlvbnMudXNpbmcuY2FsbCggZWxlbSwgcHJvcHMgKTsKCQl9IGVsc2UgewoJCQljdXJFbGVtLmNzcyggcHJvcHMgKTsKCQl9Cgl9Cn07CgoKalF1ZXJ5LmZuLmV4dGVuZCh7Cglwb3NpdGlvbjogZnVuY3Rpb24oKSB7CgkJaWYgKCAhdGhpc1swXSApIHsKCQkJcmV0dXJuIG51bGw7CgkJfQoKCQl2YXIgZWxlbSA9IHRoaXNbMF0sCgoJCS8vIEdldCAqcmVhbCogb2Zmc2V0UGFyZW50CgkJb2Zmc2V0UGFyZW50ID0gdGhpcy5vZmZzZXRQYXJlbnQoKSwKCgkJLy8gR2V0IGNvcnJlY3Qgb2Zmc2V0cwoJCW9mZnNldCAgICAgICA9IHRoaXMub2Zmc2V0KCksCgkJcGFyZW50T2Zmc2V0ID0gL15ib2R5fGh0bWwkL2kudGVzdChvZmZzZXRQYXJlbnRbMF0ubm9kZU5hbWUpID8geyB0b3A6IDAsIGxlZnQ6IDAgfSA6IG9mZnNldFBhcmVudC5vZmZzZXQoKTsKCgkJLy8gU3VidHJhY3QgZWxlbWVudCBtYXJnaW5zCgkJLy8gbm90ZTogd2hlbiBhbiBlbGVtZW50IGhhcyBtYXJnaW46IGF1dG8gdGhlIG9mZnNldExlZnQgYW5kIG1hcmdpbkxlZnQKCQkvLyBhcmUgdGhlIHNhbWUgaW4gU2FmYXJpIGNhdXNpbmcgb2Zmc2V0LmxlZnQgdG8gaW5jb3JyZWN0bHkgYmUgMAoJCW9mZnNldC50b3AgIC09IHBhcnNlRmxvYXQoIGpRdWVyeS5jdXJDU1MoZWxlbSwgIm1hcmdpblRvcCIsICB0cnVlKSApIHx8IDA7CgkJb2Zmc2V0LmxlZnQgLT0gcGFyc2VGbG9hdCggalF1ZXJ5LmN1ckNTUyhlbGVtLCAibWFyZ2luTGVmdCIsIHRydWUpICkgfHwgMDsKCgkJLy8gQWRkIG9mZnNldFBhcmVudCBib3JkZXJzCgkJcGFyZW50T2Zmc2V0LnRvcCAgKz0gcGFyc2VGbG9hdCggalF1ZXJ5LmN1ckNTUyhvZmZzZXRQYXJlbnRbMF0sICJib3JkZXJUb3BXaWR0aCIsICB0cnVlKSApIHx8IDA7CgkJcGFyZW50T2Zmc2V0LmxlZnQgKz0gcGFyc2VGbG9hdCggalF1ZXJ5LmN1ckNTUyhvZmZzZXRQYXJlbnRbMF0sICJib3JkZXJMZWZ0V2lkdGgiLCB0cnVlKSApIHx8IDA7CgoJCS8vIFN1YnRyYWN0IHRoZSB0d28gb2Zmc2V0cwoJCXJldHVybiB7CgkJCXRvcDogIG9mZnNldC50b3AgIC0gcGFyZW50T2Zmc2V0LnRvcCwKCQkJbGVmdDogb2Zmc2V0LmxlZnQgLSBwYXJlbnRPZmZzZXQubGVmdAoJCX07Cgl9LAoKCW9mZnNldFBhcmVudDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMubWFwKGZ1bmN0aW9uKCkgewoJCQl2YXIgb2Zmc2V0UGFyZW50ID0gdGhpcy5vZmZzZXRQYXJlbnQgfHwgZG9jdW1lbnQuYm9keTsKCQkJd2hpbGUgKCBvZmZzZXRQYXJlbnQgJiYgKCEvXmJvZHl8aHRtbCQvaS50ZXN0KG9mZnNldFBhcmVudC5ub2RlTmFtZSkgJiYgalF1ZXJ5LmNzcyhvZmZzZXRQYXJlbnQsICJwb3NpdGlvbiIpID09PSAic3RhdGljIikgKSB7CgkJCQlvZmZzZXRQYXJlbnQgPSBvZmZzZXRQYXJlbnQub2Zmc2V0UGFyZW50OwoJCQl9CgkJCXJldHVybiBvZmZzZXRQYXJlbnQ7CgkJfSk7Cgl9Cn0pOwoKCi8vIENyZWF0ZSBzY3JvbGxMZWZ0IGFuZCBzY3JvbGxUb3AgbWV0aG9kcwpqUXVlcnkuZWFjaCggWyJMZWZ0IiwgIlRvcCJdLCBmdW5jdGlvbiggaSwgbmFtZSApIHsKCXZhciBtZXRob2QgPSAic2Nyb2xsIiArIG5hbWU7CgoJalF1ZXJ5LmZuWyBtZXRob2QgXSA9IGZ1bmN0aW9uKHZhbCkgewoJCXZhciBlbGVtID0gdGhpc1swXSwgd2luOwoJCQoJCWlmICggIWVsZW0gKSB7CgkJCXJldHVybiBudWxsOwoJCX0KCgkJaWYgKCB2YWwgIT09IHVuZGVmaW5lZCApIHsKCQkJLy8gU2V0IHRoZSBzY3JvbGwgb2Zmc2V0CgkJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgkJCQl3aW4gPSBnZXRXaW5kb3coIHRoaXMgKTsKCgkJCQlpZiAoIHdpbiApIHsKCQkJCQl3aW4uc2Nyb2xsVG8oCgkJCQkJCSFpID8gdmFsIDogalF1ZXJ5KHdpbikuc2Nyb2xsTGVmdCgpLAoJCQkJCQkgaSA/IHZhbCA6IGpRdWVyeSh3aW4pLnNjcm9sbFRvcCgpCgkJCQkJKTsKCgkJCQl9IGVsc2UgewoJCQkJCXRoaXNbIG1ldGhvZCBdID0gdmFsOwoJCQkJfQoJCQl9KTsKCQl9IGVsc2UgewoJCQl3aW4gPSBnZXRXaW5kb3coIGVsZW0gKTsKCgkJCS8vIFJldHVybiB0aGUgc2Nyb2xsIG9mZnNldAoJCQlyZXR1cm4gd2luID8gKCJwYWdlWE9mZnNldCIgaW4gd2luKSA/IHdpblsgaSA/ICJwYWdlWU9mZnNldCIgOiAicGFnZVhPZmZzZXQiIF0gOgoJCQkJalF1ZXJ5LnN1cHBvcnQuYm94TW9kZWwgJiYgd2luLmRvY3VtZW50LmRvY3VtZW50RWxlbWVudFsgbWV0aG9kIF0gfHwKCQkJCQl3aW4uZG9jdW1lbnQuYm9keVsgbWV0aG9kIF0gOgoJCQkJZWxlbVsgbWV0aG9kIF07CgkJfQoJfTsKfSk7CgpmdW5jdGlvbiBnZXRXaW5kb3coIGVsZW0gKSB7CglyZXR1cm4gKCJzY3JvbGxUbyIgaW4gZWxlbSAmJiBlbGVtLmRvY3VtZW50KSA/CgkJZWxlbSA6CgkJZWxlbS5ub2RlVHlwZSA9PT0gOSA/CgkJCWVsZW0uZGVmYXVsdFZpZXcgfHwgZWxlbS5wYXJlbnRXaW5kb3cgOgoJCQlmYWxzZTsKfQovLyBDcmVhdGUgaW5uZXJIZWlnaHQsIGlubmVyV2lkdGgsIG91dGVySGVpZ2h0IGFuZCBvdXRlcldpZHRoIG1ldGhvZHMKalF1ZXJ5LmVhY2goWyAiSGVpZ2h0IiwgIldpZHRoIiBdLCBmdW5jdGlvbiggaSwgbmFtZSApIHsKCgl2YXIgdHlwZSA9IG5hbWUudG9Mb3dlckNhc2UoKTsKCgkvLyBpbm5lckhlaWdodCBhbmQgaW5uZXJXaWR0aAoJalF1ZXJ5LmZuWyJpbm5lciIgKyBuYW1lXSA9IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzWzBdID8KCQkJalF1ZXJ5LmNzcyggdGhpc1swXSwgdHlwZSwgZmFsc2UsICJwYWRkaW5nIiApIDoKCQkJbnVsbDsKCX07CgoJLy8gb3V0ZXJIZWlnaHQgYW5kIG91dGVyV2lkdGgKCWpRdWVyeS5mblsib3V0ZXIiICsgbmFtZV0gPSBmdW5jdGlvbiggbWFyZ2luICkgewoJCXJldHVybiB0aGlzWzBdID8KCQkJalF1ZXJ5LmNzcyggdGhpc1swXSwgdHlwZSwgZmFsc2UsIG1hcmdpbiA/ICJtYXJnaW4iIDogImJvcmRlciIgKSA6CgkJCW51bGw7Cgl9OwoKCWpRdWVyeS5mblsgdHlwZSBdID0gZnVuY3Rpb24oIHNpemUgKSB7CgkJLy8gR2V0IHdpbmRvdyB3aWR0aCBvciBoZWlnaHQKCQl2YXIgZWxlbSA9IHRoaXNbMF07CgkJaWYgKCAhZWxlbSApIHsKCQkJcmV0dXJuIHNpemUgPT0gbnVsbCA/IG51bGwgOiB0aGlzOwoJCX0KCQkKCQlpZiAoIGpRdWVyeS5pc0Z1bmN0aW9uKCBzaXplICkgKSB7CgkJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oIGkgKSB7CgkJCQl2YXIgc2VsZiA9IGpRdWVyeSggdGhpcyApOwoJCQkJc2VsZlsgdHlwZSBdKCBzaXplLmNhbGwoIHRoaXMsIGksIHNlbGZbIHR5cGUgXSgpICkgKTsKCQkJfSk7CgkJfQoKCQlyZXR1cm4gKCJzY3JvbGxUbyIgaW4gZWxlbSAmJiBlbGVtLmRvY3VtZW50KSA/IC8vIGRvZXMgaXQgd2FsayBhbmQgcXVhY2sgbGlrZSBhIHdpbmRvdz8KCQkJLy8gRXZlcnlvbmUgZWxzZSB1c2UgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50IG9yIGRvY3VtZW50LmJvZHkgZGVwZW5kaW5nIG9uIFF1aXJrcyB2cyBTdGFuZGFyZHMgbW9kZQoJCQllbGVtLmRvY3VtZW50LmNvbXBhdE1vZGUgPT09ICJDU1MxQ29tcGF0IiAmJiBlbGVtLmRvY3VtZW50LmRvY3VtZW50RWxlbWVudFsgImNsaWVudCIgKyBuYW1lIF0gfHwKCQkJZWxlbS5kb2N1bWVudC5ib2R5WyAiY2xpZW50IiArIG5hbWUgXSA6CgoJCQkvLyBHZXQgZG9jdW1lbnQgd2lkdGggb3IgaGVpZ2h0CgkJCShlbGVtLm5vZGVUeXBlID09PSA5KSA/IC8vIGlzIGl0IGEgZG9jdW1lbnQKCQkJCS8vIEVpdGhlciBzY3JvbGxbV2lkdGgvSGVpZ2h0XSBvciBvZmZzZXRbV2lkdGgvSGVpZ2h0XSwgd2hpY2hldmVyIGlzIGdyZWF0ZXIKCQkJCU1hdGgubWF4KAoJCQkJCWVsZW0uZG9jdW1lbnRFbGVtZW50WyJjbGllbnQiICsgbmFtZV0sCgkJCQkJZWxlbS5ib2R5WyJzY3JvbGwiICsgbmFtZV0sIGVsZW0uZG9jdW1lbnRFbGVtZW50WyJzY3JvbGwiICsgbmFtZV0sCgkJCQkJZWxlbS5ib2R5WyJvZmZzZXQiICsgbmFtZV0sIGVsZW0uZG9jdW1lbnRFbGVtZW50WyJvZmZzZXQiICsgbmFtZV0KCQkJCSkgOgoKCQkJCS8vIEdldCBvciBzZXQgd2lkdGggb3IgaGVpZ2h0IG9uIHRoZSBlbGVtZW50CgkJCQlzaXplID09PSB1bmRlZmluZWQgPwoJCQkJCS8vIEdldCB3aWR0aCBvciBoZWlnaHQgb24gdGhlIGVsZW1lbnQKCQkJCQlqUXVlcnkuY3NzKCBlbGVtLCB0eXBlICkgOgoKCQkJCQkvLyBTZXQgdGhlIHdpZHRoIG9yIGhlaWdodCBvbiB0aGUgZWxlbWVudCAoZGVmYXVsdCB0byBwaXhlbHMgaWYgdmFsdWUgaXMgdW5pdGxlc3MpCgkJCQkJdGhpcy5jc3MoIHR5cGUsIHR5cGVvZiBzaXplID09PSAic3RyaW5nIiA/IHNpemUgOiBzaXplICsgInB4IiApOwoJfTsKCn0pOwovLyBFeHBvc2UgalF1ZXJ5IHRvIHRoZSBnbG9iYWwgb2JqZWN0CndpbmRvdy5qUXVlcnkgPSB3aW5kb3cuJCA9IGpRdWVyeTsKCn0pKHdpbmRvdyk7Ci8qKgogKiBAbGljZW5zZSBBbmd1bGFySlMgdjAuOS4xOQogKiAoYykgMjAxMC0yMDExIEFuZ3VsYXJKUyBodHRwOi8vYW5ndWxhcmpzLm9yZwogKiBMaWNlbnNlOiBNSVQKICovCihmdW5jdGlvbih3aW5kb3csIGRvY3VtZW50KXsKICB2YXIgX2pRdWVyeSA9IHdpbmRvdy5qUXVlcnkubm9Db25mbGljdCh0cnVlKTsKJ3VzZSBzdHJpY3QnOwoKLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCgppZiAodHlwZW9mIGRvY3VtZW50LmdldEF0dHJpYnV0ZSA9PSAkdW5kZWZpbmVkKQogIGRvY3VtZW50LmdldEF0dHJpYnV0ZSA9IGZ1bmN0aW9uKCkge307CgovKioKICogQHdvcmtJblByb2dyZXNzCiAqIEBuZ2RvYyBmdW5jdGlvbgogKiBAbmFtZSBhbmd1bGFyLmxvd2VyY2FzZQogKiBAZnVuY3Rpb24KICoKICogQGRlc2NyaXB0aW9uIENvbnZlcnRzIHN0cmluZyB0byBsb3dlcmNhc2UKICogQHBhcmFtIHtzdHJpbmd9IHN0cmluZyBTdHJpbmcgdG8gYmUgbG93ZXJjYXNlZC4KICogQHJldHVybnMge3N0cmluZ30gTG93ZXJjYXNlZCBzdHJpbmcuCiAqLwp2YXIgbG93ZXJjYXNlID0gZnVuY3Rpb24gKHN0cmluZyl7IHJldHVybiBpc1N0cmluZyhzdHJpbmcpID8gc3RyaW5nLnRvTG93ZXJDYXNlKCkgOiBzdHJpbmc7IH07CgoKLyoqCiAqIEB3b3JrSW5Qcm9ncmVzcwogKiBAbmdkb2MgZnVuY3Rpb24KICogQG5hbWUgYW5ndWxhci51cHBlcmNhc2UKICogQGZ1bmN0aW9uCiAqCiAqIEBkZXNjcmlwdGlvbiBDb252ZXJ0cyBzdHJpbmcgdG8gdXBwZXJjYXNlLgogKiBAcGFyYW0ge3N0cmluZ30gc3RyaW5nIFN0cmluZyB0byBiZSB1cHBlcmNhc2VkLgogKiBAcmV0dXJucyB7c3RyaW5nfSBVcHBlcmNhc2VkIHN0cmluZy4KICovCnZhciB1cHBlcmNhc2UgPSBmdW5jdGlvbiAoc3RyaW5nKXsgcmV0dXJuIGlzU3RyaW5nKHN0cmluZykgPyBzdHJpbmcudG9VcHBlckNhc2UoKSA6IHN0cmluZzsgfTsKCgp2YXIgbWFudWFsTG93ZXJjYXNlID0gZnVuY3Rpb24gKHMpIHsKICByZXR1cm4gaXNTdHJpbmcocykKICAgICAgPyBzLnJlcGxhY2UoL1tBLVpdL2csIGZ1bmN0aW9uIChjaCkge3JldHVybiBmcm9tQ2hhckNvZGUoY2guY2hhckNvZGVBdCgwKSB8IDMyKTsgfSkKICAgICAgOiBzOwp9Owp2YXIgbWFudWFsVXBwZXJjYXNlID0gZnVuY3Rpb24gKHMpIHsKICByZXR1cm4gaXNTdHJpbmcocykKICAgICAgPyBzLnJlcGxhY2UoL1thLXpdL2csIGZ1bmN0aW9uIChjaCkge3JldHVybiBmcm9tQ2hhckNvZGUoY2guY2hhckNvZGVBdCgwKSAmIH4zMik7IH0pCiAgICAgIDogczsKfTsKCgovLyBTdHJpbmcjdG9Mb3dlckNhc2UgYW5kIFN0cmluZyN0b1VwcGVyQ2FzZSBkb24ndCBwcm9kdWNlIGNvcnJlY3QgcmVzdWx0cyBpbiBicm93c2VycyB3aXRoIFR1cmtpc2gKLy8gbG9jYWxlLCBmb3IgdGhpcyByZWFzb24gd2UgbmVlZCB0byBkZXRlY3QgdGhpcyBjYXNlIGFuZCByZWRlZmluZSBsb3dlcmNhc2UvdXBwZXJjYXNlIG1ldGhvZHMgd2l0aAovLyBjb3JyZWN0IGJ1dCBzbG93ZXIgYWx0ZXJuYXRpdmVzLgppZiAoJ2knICE9PSAnSScudG9Mb3dlckNhc2UoKSkgewogIGxvd2VyY2FzZSA9IG1hbnVhbExvd2VyY2FzZTsKICB1cHBlcmNhc2UgPSBtYW51YWxVcHBlcmNhc2U7Cn0KCmZ1bmN0aW9uIGZyb21DaGFyQ29kZShjb2RlKSB7IHJldHVybiBTdHJpbmcuZnJvbUNoYXJDb2RlKGNvZGUpOyB9CgoKdmFyIF91bmRlZmluZWQgICAgICAgID0gdW5kZWZpbmVkLAogICAgX251bGwgICAgICAgICAgICAgPSBudWxsLAogICAgJCRlbGVtZW50ICAgICAgICAgPSAnJGVsZW1lbnQnLAogICAgJCRzY29wZSAgICAgICAgICAgPSAnJHNjb3BlJywKICAgICQkdmFsaWRhdGUgICAgICAgID0gJyR2YWxpZGF0ZScsCiAgICAkYW5ndWxhciAgICAgICAgICA9ICdhbmd1bGFyJywKICAgICRhcnJheSAgICAgICAgICAgID0gJ2FycmF5JywKICAgICRib29sZWFuICAgICAgICAgID0gJ2Jvb2xlYW4nLAogICAgJGNvbnNvbGUgICAgICAgICAgPSAnY29uc29sZScsCiAgICAkZGF0ZSAgICAgICAgICAgICA9ICdkYXRlJywKICAgICRlbGVtZW50ICAgICAgICAgID0gJ2VsZW1lbnQnLAogICAgJGZ1bmN0aW9uICAgICAgICAgPSAnZnVuY3Rpb24nLAogICAgJGxlbmd0aCAgICAgICAgICAgPSAnbGVuZ3RoJywKICAgICRuYW1lICAgICAgICAgICAgID0gJ25hbWUnLAogICAgJG5vb3AgICAgICAgICAgICAgPSAnbm9vcCcsCiAgICAkbnVsbCAgICAgICAgICAgICA9ICdudWxsJywKICAgICRudW1iZXIgICAgICAgICAgID0gJ251bWJlcicsCiAgICAkb2JqZWN0ICAgICAgICAgICA9ICdvYmplY3QnLAogICAgJHN0cmluZyAgICAgICAgICAgPSAnc3RyaW5nJywKICAgICR2YWx1ZSAgICAgICAgICAgID0gJ3ZhbHVlJywKICAgICRzZWxlY3RlZCAgICAgICAgID0gJ3NlbGVjdGVkJywKICAgICR1bmRlZmluZWQgICAgICAgID0gJ3VuZGVmaW5lZCcsCiAgICBOR19FWENFUFRJT04gICAgICA9ICduZy1leGNlcHRpb24nLAogICAgTkdfVkFMSURBVElPTl9FUlJPUiA9ICduZy12YWxpZGF0aW9uLWVycm9yJywKICAgIE5PT1AgICAgICAgICAgICAgID0gJ25vb3AnLAogICAgUFJJT1JJVFlfRklSU1QgICAgPSAtOTk5OTksCiAgICBQUklPUklUWV9XQVRDSCAgICA9IC0xMDAwLAogICAgUFJJT1JJVFlfTEFTVCAgICAgPSAgOTk5OTksCiAgICBQUklPUklUWSAgICAgICAgICA9IHsnRklSU1QnOiBQUklPUklUWV9GSVJTVCwgJ0xBU1QnOiBQUklPUklUWV9MQVNULCAnV0FUQ0gnOlBSSU9SSVRZX1dBVENIfSwKICAgIEVycm9yICAgICAgICAgICAgID0gd2luZG93LkVycm9yLAogICAgLyoqIGhvbGRzIG1ham9yIHZlcnNpb24gbnVtYmVyIGZvciBJRSBvciBOYU4gZm9yIHJlYWwgYnJvd3NlcnMgKi8KICAgIG1zaWUgICAgICAgICAgICAgID0gcGFyc2VJbnQoKC9tc2llIChcZCspLy5leGVjKGxvd2VyY2FzZShuYXZpZ2F0b3IudXNlckFnZW50KSkgfHwgW10pWzFdLCAxMCksCiAgICBqcUxpdGUsICAgICAgICAgICAvLyBkZWxheSBiaW5kaW5nIHNpbmNlIGpRdWVyeSBjb3VsZCBiZSBsb2FkZWQgYWZ0ZXIgdXMuCiAgICBqUXVlcnksICAgICAgICAgICAvLyBkZWxheSBiaW5kaW5nCiAgICBzbGljZSAgICAgICAgICAgICA9IFtdLnNsaWNlLAogICAgcHVzaCAgICAgICAgICAgICAgPSBbXS5wdXNoLAogICAgZXJyb3IgICAgICAgICAgICAgPSB3aW5kb3dbJGNvbnNvbGVdCiAgICAgICAgICAgICAgICAgICAgICAgICAgID8gYmluZCh3aW5kb3dbJGNvbnNvbGVdLCB3aW5kb3dbJGNvbnNvbGVdWydlcnJvciddIHx8IG5vb3ApCiAgICAgICAgICAgICAgICAgICAgICAgICAgIDogbm9vcCwKCiAgICAvKiogQG5hbWUgYW5ndWxhciAqLwogICAgYW5ndWxhciAgICAgICAgICAgPSB3aW5kb3dbJGFuZ3VsYXJdIHx8ICh3aW5kb3dbJGFuZ3VsYXJdID0ge30pLAogICAgLyoqIEBuYW1lIGFuZ3VsYXIubWFya3VwICovCiAgICBhbmd1bGFyVGV4dE1hcmt1cCA9IGV4dGVuc2lvbk1hcChhbmd1bGFyLCAnbWFya3VwJyksCiAgICAvKiogQG5hbWUgYW5ndWxhci5hdHRyTWFya3VwICovCiAgICBhbmd1bGFyQXR0ck1hcmt1cCA9IGV4dGVuc2lvbk1hcChhbmd1bGFyLCAnYXR0ck1hcmt1cCcpLAogICAgLyoqIEBuYW1lIGFuZ3VsYXIuZGlyZWN0aXZlICovCiAgICBhbmd1bGFyRGlyZWN0aXZlICA9IGV4dGVuc2lvbk1hcChhbmd1bGFyLCAnZGlyZWN0aXZlJyksCiAgICAvKiogQG5hbWUgYW5ndWxhci53aWRnZXQgKi8KICAgIGFuZ3VsYXJXaWRnZXQgICAgID0gZXh0ZW5zaW9uTWFwKGFuZ3VsYXIsICd3aWRnZXQnLCBsb3dlcmNhc2UpLAogICAgLyoqIEBuYW1lIGFuZ3VsYXIudmFsaWRhdG9yICovCiAgICBhbmd1bGFyVmFsaWRhdG9yICA9IGV4dGVuc2lvbk1hcChhbmd1bGFyLCAndmFsaWRhdG9yJyksCiAgICAvKiogQG5hbWUgYW5ndWxhci5maWxldGVyICovCiAgICBhbmd1bGFyRmlsdGVyICAgICA9IGV4dGVuc2lvbk1hcChhbmd1bGFyLCAnZmlsdGVyJyksCiAgICAvKiogQG5hbWUgYW5ndWxhci5mb3JtYXR0ZXIgKi8KICAgIGFuZ3VsYXJGb3JtYXR0ZXIgID0gZXh0ZW5zaW9uTWFwKGFuZ3VsYXIsICdmb3JtYXR0ZXInKSwKICAgIC8qKiBAbmFtZSBhbmd1bGFyLnNlcnZpY2UgKi8KICAgIGFuZ3VsYXJTZXJ2aWNlICAgID0gZXh0ZW5zaW9uTWFwKGFuZ3VsYXIsICdzZXJ2aWNlJyksCiAgICBhbmd1bGFyQ2FsbGJhY2tzICA9IGV4dGVuc2lvbk1hcChhbmd1bGFyLCAnY2FsbGJhY2tzJyksCiAgICBub2RlTmFtZV8sCiAgICBybmdTY3JpcHQgICAgICAgICA9IC9eKHwuKlwvKWFuZ3VsYXIoLS4qPyk/KFwubWluKT8uanMoXD9bXiNdKik/KCMoLiopKT8kLywKICAgIHVpZCAgICAgICAgICAgICAgID0gWycwJywgJzAnLCAnMCddLAogICAgREFURV9JU09TVFJJTkdfTE4gPSAyNDsKCi8qKgogKiBAd29ya0luUHJvZ3Jlc3MKICogQG5nZG9jIGZ1bmN0aW9uCiAqIEBuYW1lIGFuZ3VsYXIuZm9yRWFjaAogKiBAZnVuY3Rpb24KICoKICogQGRlc2NyaXB0aW9uCiAqIEludm9rZXMgdGhlIGBpdGVyYXRvcmAgZnVuY3Rpb24gb25jZSBmb3IgZWFjaCBpdGVtIGluIGBvYmpgIGNvbGxlY3Rpb24uIFRoZSBjb2xsZWN0aW9uIGNhbiBlaXRoZXIKICogYmUgYW4gb2JqZWN0IG9yIGFuIGFycmF5LiBUaGUgYGl0ZXJhdG9yYCBmdW5jdGlvbiBpcyBpbnZva2VkIHdpdGggYGl0ZXJhdG9yKHZhbHVlLCBrZXkpYCwgd2hlcmUKICogYHZhbHVlYCBpcyB0aGUgdmFsdWUgb2YgYW4gb2JqZWN0IHByb3BlcnR5IG9yIGFuIGFycmF5IGVsZW1lbnQgYW5kIGBrZXlgIGlzIHRoZSBvYmplY3QgcHJvcGVydHkKICoga2V5IG9yIGFycmF5IGVsZW1lbnQgaW5kZXguIE9wdGlvbmFsbHksIGBjb250ZXh0YCBjYW4gYmUgc3BlY2lmaWVkIGZvciB0aGUgaXRlcmF0b3IgZnVuY3Rpb24uCiAqCiAqIE5vdGU6IHRoaXMgZnVuY3Rpb24gd2FzIHByZXZpb3VzbHkga25vd24gYXMgYGFuZ3VsYXIuZm9yZWFjaGAuCiAqCiAgIDxwcmU+CiAgICAgdmFyIHZhbHVlcyA9IHtuYW1lOiAnbWlza28nLCBnZW5kZXI6ICdtYWxlJ307CiAgICAgdmFyIGxvZyA9IFtdOwogICAgIGFuZ3VsYXIuZm9yRWFjaCh2YWx1ZXMsIGZ1bmN0aW9uKHZhbHVlLCBrZXkpewogICAgICAgdGhpcy5wdXNoKGtleSArICc6ICcgKyB2YWx1ZSk7CiAgICAgfSwgbG9nKTsKICAgICBleHBlY3QobG9nKS50b0VxdWFsKFsnbmFtZTogbWlza28nLCAnZ2VuZGVyOm1hbGUnXSk7CiAgIDwvcHJlPgogKgogKiBAcGFyYW0ge09iamVjdHxBcnJheX0gb2JqIE9iamVjdCB0byBpdGVyYXRlIG92ZXIuCiAqIEBwYXJhbSB7ZnVuY3Rpb24oKX0gaXRlcmF0b3IgSXRlcmF0b3IgZnVuY3Rpb24uCiAqIEBwYXJhbSB7T2JqZWN0fSBjb250ZXh0IE9iamVjdCB0byBiZWNvbWUgY29udGV4dCAoYHRoaXNgKSBmb3IgdGhlIGl0ZXJhdG9yIGZ1bmN0aW9uLgogKiBAcmV0dXJucyB7T2JqZWN0fEFycmF5fSBSZWZlcmVuY2UgdG8gYG9iamAuCiAqLwpmdW5jdGlvbiBmb3JFYWNoKG9iaiwgaXRlcmF0b3IsIGNvbnRleHQpIHsKICB2YXIga2V5OwogIGlmIChvYmopIHsKICAgIGlmIChpc0Z1bmN0aW9uKG9iaikpewogICAgICBmb3IgKGtleSBpbiBvYmopIHsKICAgICAgICBpZiAoa2V5ICE9ICdwcm90b3R5cGUnICYmIGtleSAhPSAkbGVuZ3RoICYmIGtleSAhPSAkbmFtZSAmJiBvYmouaGFzT3duUHJvcGVydHkoa2V5KSkgewogICAgICAgICAgaXRlcmF0b3IuY2FsbChjb250ZXh0LCBvYmpba2V5XSwga2V5KTsKICAgICAgICB9CiAgICAgIH0KICAgIH0gZWxzZSBpZiAob2JqLmZvckVhY2ggJiYgb2JqLmZvckVhY2ggIT09IGZvckVhY2gpIHsKICAgICAgb2JqLmZvckVhY2goaXRlcmF0b3IsIGNvbnRleHQpOwogICAgfSBlbHNlIGlmIChpc09iamVjdChvYmopICYmIGlzTnVtYmVyKG9iai5sZW5ndGgpKSB7CiAgICAgIGZvciAoa2V5ID0gMDsga2V5IDwgb2JqLmxlbmd0aDsga2V5KyspCiAgICAgICAgaXRlcmF0b3IuY2FsbChjb250ZXh0LCBvYmpba2V5XSwga2V5KTsKICAgIH0gZWxzZSB7CiAgICAgIGZvciAoa2V5IGluIG9iaikKICAgICAgICBpdGVyYXRvci5jYWxsKGNvbnRleHQsIG9ialtrZXldLCBrZXkpOwogICAgfQogIH0KICByZXR1cm4gb2JqOwp9CgpmdW5jdGlvbiBmb3JFYWNoU29ydGVkKG9iaiwgaXRlcmF0b3IsIGNvbnRleHQpIHsKICB2YXIga2V5cyA9IFtdOwogIGZvciAodmFyIGtleSBpbiBvYmopIGtleXMucHVzaChrZXkpOwogIGtleXMuc29ydCgpOwogIGZvciAoIHZhciBpID0gMDsgaSA8IGtleXMubGVuZ3RoOyBpKyspIHsKICAgIGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgb2JqW2tleXNbaV1dLCBrZXlzW2ldKTsKICB9CiAgcmV0dXJuIGtleXM7Cn0KCgpmdW5jdGlvbiBmb3JtYXRFcnJvcihhcmcpIHsKICBpZiAoYXJnIGluc3RhbmNlb2YgRXJyb3IpIHsKICAgIGlmIChhcmcuc3RhY2spIHsKICAgICAgYXJnID0gKGFyZy5tZXNzYWdlICYmIGFyZy5zdGFjay5pbmRleE9mKGFyZy5tZXNzYWdlKSA9PT0gLTEpID8KICAgICAgICAgICAgJ0Vycm9yOiAnICsgYXJnLm1lc3NhZ2UgKyAnXG4nICsgYXJnLnN0YWNrIDogYXJnLnN0YWNrOwogICAgfSBlbHNlIGlmIChhcmcuc291cmNlVVJMKSB7CiAgICAgIGFyZyA9IGFyZy5tZXNzYWdlICsgJ1xuJyArIGFyZy5zb3VyY2VVUkwgKyAnOicgKyBhcmcubGluZTsKICAgIH0KICB9CiAgcmV0dXJuIGFyZzsKfQoKLyoqCiAqIEBkZXNjcmlwdGlvbgogKiBBIGNvbnNpc3RlbnQgd2F5IG9mIGNyZWF0aW5nIHVuaXF1ZSBJRHMgaW4gYW5ndWxhci4gVGhlIElEIGlzIGEgc2VxdWVuY2Ugb2YgYWxwaGEgbnVtZXJpYwogKiBjaGFyYWN0ZXJzIHN1Y2ggYXMgJzAxMkFCQycuIFRoZSByZWFzb24gd2h5IHdlIGFyZSBub3QgdXNpbmcgc2ltcGx5IGEgbnVtYmVyIGNvdW50ZXIgaXMgdGhhdAogKiB0aGUgbnVtYmVyIHN0cmluZyBnZXRzIGxvbmdlciBvdmVyIHRpbWUsIGFuZCBpdCBjYW4gYWxzbyBvdmVyZmxvdywgd2hlcmUgYXMgdGhlIHRoZSBuZXh0SWQKICogd2lsbCBncm93IG11Y2ggc2xvd2VyLCBpdCBpcyBhIHN0cmluZywgYW5kIGl0IHdpbGwgbmV2ZXIgb3ZlcmZsb3cuCiAqCiAqIEByZXR1cm5zIGFuIHVuaXF1ZSBhbHBoYS1udW1lcmljIHN0cmluZwogKi8KZnVuY3Rpb24gbmV4dFVpZCgpIHsKICB2YXIgaW5kZXggPSB1aWQubGVuZ3RoOwogIHZhciBkaWdpdDsKCiAgd2hpbGUoaW5kZXgpIHsKICAgIGluZGV4LS07CiAgICBkaWdpdCA9IHVpZFtpbmRleF0uY2hhckNvZGVBdCgwKTsKICAgIGlmIChkaWdpdCA9PSA1NyAvKic5JyovKSB7CiAgICAgIHVpZFtpbmRleF0gPSAnQSc7CiAgICAgIHJldHVybiB1aWQuam9pbignJyk7CiAgICB9CiAgICBpZiAoZGlnaXQgPT0gOTAgIC8qJ1onKi8pIHsKICAgICAgdWlkW2luZGV4XSA9ICcwJzsKICAgIH0gZWxzZSB7CiAgICAgIHVpZFtpbmRleF0gPSBTdHJpbmcuZnJvbUNoYXJDb2RlKGRpZ2l0ICsgMSk7CiAgICAgIHJldHVybiB1aWQuam9pbignJyk7CiAgICB9CiAgfQogIHVpZC51bnNoaWZ0KCcwJyk7CiAgcmV0dXJuIHVpZC5qb2luKCcnKTsKfQoKLyoqCiAqIEB3b3JrSW5Qcm9ncmVzcwogKiBAbmdkb2MgZnVuY3Rpb24KICogQG5hbWUgYW5ndWxhci5leHRlbmQKICogQGZ1bmN0aW9uCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBFeHRlbmRzIHRoZSBkZXN0aW5hdGlvbiBvYmplY3QgYGRzdGAgYnkgY29weWluZyBhbGwgb2YgdGhlIHByb3BlcnRpZXMgZnJvbSB0aGUgYHNyY2Agb2JqZWN0KHMpIHRvCiAqIGBkc3RgLiBZb3UgY2FuIHNwZWNpZnkgbXVsdGlwbGUgYHNyY2Agb2JqZWN0cy4KICoKICogQHBhcmFtIHtPYmplY3R9IGRzdCBUaGUgZGVzdGluYXRpb24gb2JqZWN0LgogKiBAcGFyYW0gey4uLk9iamVjdH0gc3JjIFRoZSBzb3VyY2Ugb2JqZWN0KHMpLgogKi8KZnVuY3Rpb24gZXh0ZW5kKGRzdCkgewogIGZvckVhY2goYXJndW1lbnRzLCBmdW5jdGlvbihvYmopewogICAgaWYgKG9iaiAhPT0gZHN0KSB7CiAgICAgIGZvckVhY2gob2JqLCBmdW5jdGlvbih2YWx1ZSwga2V5KXsKICAgICAgICBkc3Rba2V5XSA9IHZhbHVlOwogICAgICB9KTsKICAgIH0KICB9KTsKICByZXR1cm4gZHN0Owp9CgoKZnVuY3Rpb24gaW5oZXJpdChwYXJlbnQsIGV4dHJhKSB7CiAgcmV0dXJuIGV4dGVuZChuZXcgKGV4dGVuZChmdW5jdGlvbigpe30sIHtwcm90b3R5cGU6cGFyZW50fSkpKCksIGV4dHJhKTsKfQoKCi8qKgogKiBAd29ya0luUHJvZ3Jlc3MKICogQG5nZG9jIGZ1bmN0aW9uCiAqIEBuYW1lIGFuZ3VsYXIubm9vcAogKiBAZnVuY3Rpb24KICoKICogQGRlc2NyaXB0aW9uCiAqIEVtcHR5IGZ1bmN0aW9uIHRoYXQgcGVyZm9ybXMgbm8gb3BlcmF0aW9uIHdoYXRzb2V2ZXIuIFRoaXMgZnVuY3Rpb24gaXMgdXNlZnVsIHdoZW4gd3JpdGluZyBjb2RlCiAqIGluIHRoZSBmdW5jdGlvbmFsIHN0eWxlLgogICA8cHJlPgogICAgIGZ1bmN0aW9uIGZvbyhjYWxsYmFjaykgewogICAgICAgdmFyIHJlc3VsdCA9IGNhbGN1bGF0ZVJlc3VsdCgpOwogICAgICAgKGNhbGxiYWNrIHx8IGFuZ3VsYXIubm9vcCkocmVzdWx0KTsKICAgICB9CiAgIDwvcHJlPgogKi8KZnVuY3Rpb24gbm9vcCgpIHt9CgoKLyoqCiAqIEB3b3JrSW5Qcm9ncmVzcwogKiBAbmdkb2MgZnVuY3Rpb24KICogQG5hbWUgYW5ndWxhci5pZGVudGl0eQogKiBAZnVuY3Rpb24KICoKICogQGRlc2NyaXB0aW9uCiAqIEEgZnVuY3Rpb24gdGhhdCBkb2VzIG5vdGhpbmcgZXhjZXB0IGZvciByZXR1cm5pbmcgaXRzIGZpcnN0IGFyZ3VtZW50LiBUaGlzIGZ1bmN0aW9uIGlzIHVzZWZ1bAogKiB3aGVuIHdyaXRpbmcgY29kZSBpbiB0aGUgZnVuY3Rpb25hbCBzdHlsZS4KICoKICAgPHByZT4KICAgICBmdW5jdGlvbiB0cmFuc2Zvcm1lcih0cmFuc2Zvcm1hdGlvbkZuLCB2YWx1ZSkgewogICAgICAgcmV0dXJuICh0cmFuc2Zvcm1hdGlvbkZuIHx8IGlkZW50aXR5KSh2YWx1ZSk7CiAgICAgfTsKICAgPC9wcmU+CiAqLwpmdW5jdGlvbiBpZGVudGl0eSgkKSB7cmV0dXJuICQ7fQoKCmZ1bmN0aW9uIHZhbHVlRm4odmFsdWUpIHtyZXR1cm4gZnVuY3Rpb24oKXsgcmV0dXJuIHZhbHVlOyB9O30KCmZ1bmN0aW9uIGV4dGVuc2lvbk1hcChhbmd1bGFyLCBuYW1lLCB0cmFuc2Zvcm0pIHsKICB2YXIgZXh0UG9pbnQ7CiAgcmV0dXJuIGFuZ3VsYXJbbmFtZV0gfHwgKGV4dFBvaW50ID0gYW5ndWxhcltuYW1lXSA9IGZ1bmN0aW9uIChuYW1lLCBmbiwgcHJvcCl7CiAgICBuYW1lID0gKHRyYW5zZm9ybSB8fCBpZGVudGl0eSkobmFtZSk7CiAgICBpZiAoaXNEZWZpbmVkKGZuKSkgewogICAgICBleHRQb2ludFtuYW1lXSA9IGV4dGVuZChmbiwgcHJvcCB8fCB7fSk7CiAgICB9CiAgICByZXR1cm4gZXh0UG9pbnRbbmFtZV07CiAgfSk7Cn0KCi8qKgogKiBAd29ya0luUHJvZ3Jlc3MKICogQG5nZG9jIGZ1bmN0aW9uCiAqIEBuYW1lIGFuZ3VsYXIuaXNVbmRlZmluZWQKICogQGZ1bmN0aW9uCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBDaGVja3MgaWYgYSByZWZlcmVuY2UgaXMgdW5kZWZpbmVkLgogKgogKiBAcGFyYW0geyp9IHZhbHVlIFJlZmVyZW5jZSB0byBjaGVjay4KICogQHJldHVybnMge2Jvb2xlYW59IFRydWUgaWYgYHZhbHVlYCBpcyB1bmRlZmluZWQuCiAqLwpmdW5jdGlvbiBpc1VuZGVmaW5lZCh2YWx1ZSl7IHJldHVybiB0eXBlb2YgdmFsdWUgPT0gJHVuZGVmaW5lZDsgfQoKCi8qKgogKiBAd29ya0luUHJvZ3Jlc3MKICogQG5nZG9jIGZ1bmN0aW9uCiAqIEBuYW1lIGFuZ3VsYXIuaXNEZWZpbmVkCiAqIEBmdW5jdGlvbgogKgogKiBAZGVzY3JpcHRpb24KICogQ2hlY2tzIGlmIGEgcmVmZXJlbmNlIGlzIGRlZmluZWQuCiAqCiAqIEBwYXJhbSB7Kn0gdmFsdWUgUmVmZXJlbmNlIHRvIGNoZWNrLgogKiBAcmV0dXJucyB7Ym9vbGVhbn0gVHJ1ZSBpZiBgdmFsdWVgIGlzIGRlZmluZWQuCiAqLwpmdW5jdGlvbiBpc0RlZmluZWQodmFsdWUpeyByZXR1cm4gdHlwZW9mIHZhbHVlICE9ICR1bmRlZmluZWQ7IH0KCgovKioKICogQHdvcmtJblByb2dyZXNzCiAqIEBuZ2RvYyBmdW5jdGlvbgogKiBAbmFtZSBhbmd1bGFyLmlzT2JqZWN0CiAqIEBmdW5jdGlvbgogKgogKiBAZGVzY3JpcHRpb24KICogQ2hlY2tzIGlmIGEgcmVmZXJlbmNlIGlzIGFuIGBPYmplY3RgLiBVbmxpa2UgaW4gSmF2YVNjcmlwdCBgbnVsbGBzIGFyZSBub3QgY29uc2lkZXJlZCB0byBiZQogKiBvYmplY3RzLgogKgogKiBAcGFyYW0geyp9IHZhbHVlIFJlZmVyZW5jZSB0byBjaGVjay4KICogQHJldHVybnMge2Jvb2xlYW59IFRydWUgaWYgYHZhbHVlYCBpcyBhbiBgT2JqZWN0YCBidXQgbm90IGBudWxsYC4KICovCmZ1bmN0aW9uIGlzT2JqZWN0KHZhbHVlKXsgcmV0dXJuIHZhbHVlIT1udWxsICYmIHR5cGVvZiB2YWx1ZSA9PSAkb2JqZWN0O30KCgovKioKICogQHdvcmtJblByb2dyZXNzCiAqIEBuZ2RvYyBmdW5jdGlvbgogKiBAbmFtZSBhbmd1bGFyLmlzU3RyaW5nCiAqIEBmdW5jdGlvbgogKgogKiBAZGVzY3JpcHRpb24KICogQ2hlY2tzIGlmIGEgcmVmZXJlbmNlIGlzIGEgYFN0cmluZ2AuCiAqCiAqIEBwYXJhbSB7Kn0gdmFsdWUgUmVmZXJlbmNlIHRvIGNoZWNrLgogKiBAcmV0dXJucyB7Ym9vbGVhbn0gVHJ1ZSBpZiBgdmFsdWVgIGlzIGEgYFN0cmluZ2AuCiAqLwpmdW5jdGlvbiBpc1N0cmluZyh2YWx1ZSl7IHJldHVybiB0eXBlb2YgdmFsdWUgPT0gJHN0cmluZzt9CgoKLyoqCiAqIEB3b3JrSW5Qcm9ncmVzcwogKiBAbmdkb2MgZnVuY3Rpb24KICogQG5hbWUgYW5ndWxhci5pc051bWJlcgogKiBAZnVuY3Rpb24KICoKICogQGRlc2NyaXB0aW9uCiAqIENoZWNrcyBpZiBhIHJlZmVyZW5jZSBpcyBhIGBOdW1iZXJgLgogKgogKiBAcGFyYW0geyp9IHZhbHVlIFJlZmVyZW5jZSB0byBjaGVjay4KICogQHJldHVybnMge2Jvb2xlYW59IFRydWUgaWYgYHZhbHVlYCBpcyBhIGBOdW1iZXJgLgogKi8KZnVuY3Rpb24gaXNOdW1iZXIodmFsdWUpeyByZXR1cm4gdHlwZW9mIHZhbHVlID09ICRudW1iZXI7fQoKCi8qKgogKiBAd29ya0luUHJvZ3Jlc3MKICogQG5nZG9jIGZ1bmN0aW9uCiAqIEBuYW1lIGFuZ3VsYXIuaXNEYXRlCiAqIEBmdW5jdGlvbgogKgogKiBAZGVzY3JpcHRpb24KICogQ2hlY2tzIGlmIHZhbHVlIGlzIGEgZGF0ZS4KICoKICogQHBhcmFtIHsqfSB2YWx1ZSBSZWZlcmVuY2UgdG8gY2hlY2suCiAqIEByZXR1cm5zIHtib29sZWFufSBUcnVlIGlmIGB2YWx1ZWAgaXMgYSBgRGF0ZWAuCiAqLwpmdW5jdGlvbiBpc0RhdGUodmFsdWUpeyByZXR1cm4gdmFsdWUgaW5zdGFuY2VvZiBEYXRlOyB9CgoKLyoqCiAqIEB3b3JrSW5Qcm9ncmVzcwogKiBAbmdkb2MgZnVuY3Rpb24KICogQG5hbWUgYW5ndWxhci5pc0FycmF5CiAqIEBmdW5jdGlvbgogKgogKiBAZGVzY3JpcHRpb24KICogQ2hlY2tzIGlmIGEgcmVmZXJlbmNlIGlzIGFuIGBBcnJheWAuCiAqCiAqIEBwYXJhbSB7Kn0gdmFsdWUgUmVmZXJlbmNlIHRvIGNoZWNrLgogKiBAcmV0dXJucyB7Ym9vbGVhbn0gVHJ1ZSBpZiBgdmFsdWVgIGlzIGFuIGBBcnJheWAuCiAqLwpmdW5jdGlvbiBpc0FycmF5KHZhbHVlKSB7IHJldHVybiB2YWx1ZSBpbnN0YW5jZW9mIEFycmF5OyB9CgoKLyoqCiAqIEB3b3JrSW5Qcm9ncmVzcwogKiBAbmdkb2MgZnVuY3Rpb24KICogQG5hbWUgYW5ndWxhci5pc0Z1bmN0aW9uCiAqIEBmdW5jdGlvbgogKgogKiBAZGVzY3JpcHRpb24KICogQ2hlY2tzIGlmIGEgcmVmZXJlbmNlIGlzIGEgYEZ1bmN0aW9uYC4KICoKICogQHBhcmFtIHsqfSB2YWx1ZSBSZWZlcmVuY2UgdG8gY2hlY2suCiAqIEByZXR1cm5zIHtib29sZWFufSBUcnVlIGlmIGB2YWx1ZWAgaXMgYSBgRnVuY3Rpb25gLgogKi8KZnVuY3Rpb24gaXNGdW5jdGlvbih2YWx1ZSl7IHJldHVybiB0eXBlb2YgdmFsdWUgPT0gJGZ1bmN0aW9uO30KCgovKioKICogQ2hlY2tzIGlmIGBvYmpgIGlzIGEgd2luZG93IG9iamVjdC4KICoKICogQHByaXZhdGUKICogQHBhcmFtIHsqfSBvYmogT2JqZWN0IHRvIGNoZWNrCiAqIEByZXR1cm5zIHtib29sZWFufSBUcnVlIGlmIGBvYmpgIGlzIGEgd2luZG93IG9iai4KICovCmZ1bmN0aW9uIGlzV2luZG93KG9iaikgewogIHJldHVybiBvYmogJiYgb2JqLmRvY3VtZW50ICYmIG9iai5sb2NhdGlvbiAmJiBvYmouYWxlcnQgJiYgb2JqLnNldEludGVydmFsOwp9CgpmdW5jdGlvbiBpc0Jvb2xlYW4odmFsdWUpIHsgcmV0dXJuIHR5cGVvZiB2YWx1ZSA9PSAkYm9vbGVhbjt9CmZ1bmN0aW9uIGlzVGV4dE5vZGUobm9kZSkgeyByZXR1cm4gbm9kZU5hbWVfKG5vZGUpID09ICcjdGV4dCc7IH0KZnVuY3Rpb24gdHJpbSh2YWx1ZSkgeyByZXR1cm4gaXNTdHJpbmcodmFsdWUpID8gdmFsdWUucmVwbGFjZSgvXlxzKi8sICcnKS5yZXBsYWNlKC9ccyokLywgJycpIDogdmFsdWU7IH0KZnVuY3Rpb24gaXNFbGVtZW50KG5vZGUpIHsKICByZXR1cm4gbm9kZSAmJgogICAgKG5vZGUubm9kZU5hbWUgIC8vIHdlIGFyZSBhIGRpcmVjdCBlbGVtZW50CiAgICB8fCAobm9kZS5iaW5kICYmIG5vZGUuZmluZCkpOyAgLy8gd2UgaGF2ZSBhIGJpbmQgYW5kIGZpbmQgbWV0aG9kIHBhcnQgb2YgalF1ZXJ5IEFQSQp9CgovKioKICogQHBhcmFtIHN0ciAna2V5MSxrZXkyLC4uLicKICogQHJldHVybnMge29iamVjdH0gaW4gdGhlIGZvcm0gb2Yge2tleTE6dHJ1ZSwga2V5Mjp0cnVlLCAuLi59CiAqLwpmdW5jdGlvbiBtYWtlTWFwKHN0cil7CiAgdmFyIG9iaiA9IHt9LCBpdGVtcyA9IHN0ci5zcGxpdCgiLCIpLCBpOwogIGZvciAoIGkgPSAwOyBpIDwgaXRlbXMubGVuZ3RoOyBpKysgKQogICAgb2JqWyBpdGVtc1tpXSBdID0gdHJ1ZTsKICByZXR1cm4gb2JqOwp9CgoKCi8qKgogKiBIVE1MIGNsYXNzIHdoaWNoIGlzIHRoZSBvbmx5IGNsYXNzIHdoaWNoIGNhbiBiZSB1c2VkIGluIG5nOmJpbmQgdG8gaW5saW5lIEhUTUwgZm9yIHNlY3VyaXR5IHJlYXNvbnMuCiAqIEBjb25zdHJ1Y3RvcgogKiBAcGFyYW0gaHRtbCByYXcgKHVuc2FmZSkgaHRtbAogKiBAcGFyYW0ge3N0cmluZz19IG9wdGlvbiBpZiBzZXQgdG8gJ3VzYWZlJyB0aGVuIGdldCBtZXRob2Qgd2lsbCByZXR1cm4gcmF3ICh1bnNhZmUvdW5zYW5pdGl6ZWQpIGh0bWwKICovCmZ1bmN0aW9uIEhUTUwoaHRtbCwgb3B0aW9uKSB7CiAgdGhpcy5odG1sID0gaHRtbDsKICB0aGlzLmdldCA9IGxvd2VyY2FzZShvcHRpb24pID09ICd1bnNhZmUnCiAgICA/IHZhbHVlRm4oaHRtbCkKICAgIDogZnVuY3Rpb24gaHRtbFNhbml0aXplKCkgewogICAgICAgIHZhciBidWYgPSBbXTsKICAgICAgICBodG1sUGFyc2VyKGh0bWwsIGh0bWxTYW5pdGl6ZVdyaXRlcihidWYpKTsKICAgICAgICByZXR1cm4gYnVmLmpvaW4oJycpOwogICAgICB9Owp9CgppZiAobXNpZSA8IDkpIHsKICBub2RlTmFtZV8gPSBmdW5jdGlvbihlbGVtZW50KSB7CiAgICBlbGVtZW50ID0gZWxlbWVudC5ub2RlTmFtZSA/IGVsZW1lbnQgOiBlbGVtZW50WzBdOwogICAgcmV0dXJuIChlbGVtZW50LnNjb3BlTmFtZSAmJiBlbGVtZW50LnNjb3BlTmFtZSAhPSAnSFRNTCcgKSA/IHVwcGVyY2FzZShlbGVtZW50LnNjb3BlTmFtZSArICc6JyArIGVsZW1lbnQubm9kZU5hbWUpIDogZWxlbWVudC5ub2RlTmFtZTsKICB9Owp9IGVsc2UgewogIG5vZGVOYW1lXyA9IGZ1bmN0aW9uKGVsZW1lbnQpIHsKICAgIHJldHVybiBlbGVtZW50Lm5vZGVOYW1lID8gZWxlbWVudC5ub2RlTmFtZSA6IGVsZW1lbnRbMF0ubm9kZU5hbWU7CiAgfTsKfQoKZnVuY3Rpb24gaXNWaXNpYmxlKGVsZW1lbnQpIHsKICB2YXIgcmVjdCA9IGVsZW1lbnRbMF0uZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCksCiAgICAgIHdpZHRoID0gKHJlY3Qud2lkdGggfHwgKHJlY3QucmlnaHR8fDAgLSByZWN0LmxlZnR8fDApKSwKICAgICAgaGVpZ2h0ID0gKHJlY3QuaGVpZ2h0IHx8IChyZWN0LmJvdHRvbXx8MCAtIHJlY3QudG9wfHwwKSk7CiAgcmV0dXJuIHdpZHRoPjAgJiYgaGVpZ2h0PjA7Cn0KCmZ1bmN0aW9uIG1hcChvYmosIGl0ZXJhdG9yLCBjb250ZXh0KSB7CiAgdmFyIHJlc3VsdHMgPSBbXTsKICBmb3JFYWNoKG9iaiwgZnVuY3Rpb24odmFsdWUsIGluZGV4LCBsaXN0KSB7CiAgICByZXN1bHRzLnB1c2goaXRlcmF0b3IuY2FsbChjb250ZXh0LCB2YWx1ZSwgaW5kZXgsIGxpc3QpKTsKICB9KTsKICByZXR1cm4gcmVzdWx0czsKfQoKCi8qKgogKiBAbmdkb2MgZnVuY3Rpb24KICogQG5hbWUgYW5ndWxhci5PYmplY3Quc2l6ZQogKiBAZnVuY3Rpb24KICoKICogQGRlc2NyaXB0aW9uCiAqIERldGVybWluZXMgdGhlIG51bWJlciBvZiBlbGVtZW50cyBpbiBhbiBhcnJheSwgbnVtYmVyIG9mIHByb3BlcnRpZXMgb2YgYW4gb2JqZWN0IG9yIHN0cmluZwogKiBsZW5ndGguCiAqCiAqIE5vdGU6IHRoaXMgZnVuY3Rpb24gaXMgdXNlZCB0byBhdWdtZW50IHRoZSBPYmplY3QgdHlwZSBpbiBhbmd1bGFyIGV4cHJlc3Npb25zLiBTZWUKICoge0BsaW5rIGFuZ3VsYXIuT2JqZWN0fSBmb3IgbW9yZSBpbmZvLgogKgogKiBAcGFyYW0ge09iamVjdHxBcnJheXxzdHJpbmd9IG9iaiBPYmplY3QsIGFycmF5IG9yIHN0cmluZyB0byBpbnNwZWN0LgogKiBAcGFyYW0ge2Jvb2xlYW59IFtvd25Qcm9wc09ubHk9ZmFsc2VdIENvdW50IG9ubHkgIm93biIgcHJvcGVydGllcyBpbiBhbiBvYmplY3QKICogQHJldHVybnMge251bWJlcn0gVGhlIHNpemUgb2YgYG9iamAgb3IgYDBgIGlmIGBvYmpgIGlzIG5laXRoZXIgYW4gb2JqZWN0IG9yIGFuIGFycmF5LgogKgogKiBAZXhhbXBsZQogKiA8ZG9jOmV4YW1wbGU+CiAqICA8ZG9jOnNvdXJjZT4KICogICBOdW1iZXIgb2YgaXRlbXMgaW4gYXJyYXk6IHt7IFsxLDJdLiRzaXplKCkgfX08YnIvPgogKiAgIE51bWJlciBvZiBpdGVtcyBpbiBvYmplY3Q6IHt7IHthOjEsIGI6MiwgYzozfS4kc2l6ZSgpIH19PGJyLz4KICogIDwvZG9jOnNvdXJjZT4KICogIDxkb2M6c2NlbmFyaW8+CiAqICAgaXQoJ3Nob3VsZCBwcmludCBjb3JyZWN0IHNpemVzIGZvciBhbiBhcnJheSBhbmQgYW4gb2JqZWN0JywgZnVuY3Rpb24oKSB7CiAqICAgICBleHBlY3QoYmluZGluZygnWzEsMl0uJHNpemUoKScpKS50b0JlKCcyJyk7CiAqICAgICBleHBlY3QoYmluZGluZygne2E6MSwgYjoyLCBjOjN9LiRzaXplKCknKSkudG9CZSgnMycpOwogKiAgIH0pOwogKiAgPC9kb2M6c2NlbmFyaW8+CiAqIDwvZG9jOmV4YW1wbGU+CiAqLwpmdW5jdGlvbiBzaXplKG9iaiwgb3duUHJvcHNPbmx5KSB7CiAgdmFyIHNpemUgPSAwLCBrZXk7CgogIGlmIChpc0FycmF5KG9iaikgfHwgaXNTdHJpbmcob2JqKSkgewogICAgcmV0dXJuIG9iai5sZW5ndGg7CiAgfSBlbHNlIGlmIChpc09iamVjdChvYmopKXsKICAgIGZvciAoa2V5IGluIG9iaikKICAgICAgaWYgKCFvd25Qcm9wc09ubHkgfHwgb2JqLmhhc093blByb3BlcnR5KGtleSkpCiAgICAgICAgc2l6ZSsrOwogIH0KCiAgcmV0dXJuIHNpemU7Cn0KCgpmdW5jdGlvbiBpbmNsdWRlcyhhcnJheSwgb2JqKSB7CiAgZm9yICggdmFyIGkgPSAwOyBpIDwgYXJyYXkubGVuZ3RoOyBpKyspIHsKICAgIGlmIChvYmogPT09IGFycmF5W2ldKSByZXR1cm4gdHJ1ZTsKICB9CiAgcmV0dXJuIGZhbHNlOwp9CgpmdW5jdGlvbiBpbmRleE9mKGFycmF5LCBvYmopIHsKICBmb3IgKCB2YXIgaSA9IDA7IGkgPCBhcnJheS5sZW5ndGg7IGkrKykgewogICAgaWYgKG9iaiA9PT0gYXJyYXlbaV0pIHJldHVybiBpOwogIH0KICByZXR1cm4gLTE7Cn0KCmZ1bmN0aW9uIGlzTGVhZk5vZGUgKG5vZGUpIHsKICBpZiAobm9kZSkgewogICAgc3dpdGNoIChub2RlLm5vZGVOYW1lKSB7CiAgICBjYXNlICJPUFRJT04iOgogICAgY2FzZSAiUFJFIjoKICAgIGNhc2UgIlRJVExFIjoKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgfQogIHJldHVybiBmYWxzZTsKfQoKLyoqCiAqIEBuZ2RvYyBmdW5jdGlvbgogKiBAbmFtZSBhbmd1bGFyLk9iamVjdC5jb3B5CiAqIEBmdW5jdGlvbgogKgogKiBAZGVzY3JpcHRpb24KICogQ3JlYXRlcyBhIGRlZXAgY29weSBvZiBgc291cmNlYC4KICoKICogSWYgYHNvdXJjZWAgaXMgYW4gb2JqZWN0IG9yIGFuIGFycmF5LCBhbGwgb2YgaXRzIG1lbWJlcnMgd2lsbCBiZSBjb3BpZWQgaW50byB0aGUgYGRlc3RpbmF0aW9uYAogKiBvYmplY3QuCiAqCiAqIElmIGBkZXN0aW5hdGlvbmAgaXMgbm90IHByb3ZpZGVkIGFuZCBgc291cmNlYCBpcyBhbiBvYmplY3Qgb3IgYW4gYXJyYXksIGEgY29weSBpcyBjcmVhdGVkICYKICogcmV0dXJuZWQsIG90aGVyd2lzZSB0aGUgYHNvdXJjZWAgaXMgcmV0dXJuZWQuCiAqCiAqIElmIGBkZXN0aW5hdGlvbmAgaXMgcHJvdmlkZWQsIGFsbCBvZiBpdHMgcHJvcGVydGllcyB3aWxsIGJlIGRlbGV0ZWQuCiAqCiAqIE5vdGU6IHRoaXMgZnVuY3Rpb24gaXMgdXNlZCB0byBhdWdtZW50IHRoZSBPYmplY3QgdHlwZSBpbiBhbmd1bGFyIGV4cHJlc3Npb25zLiBTZWUKICoge0BsaW5rIGFuZ3VsYXIuT2JqZWN0fSBmb3IgbW9yZSBpbmZvLgogKgogKiBAcGFyYW0geyp9IHNvdXJjZSBUaGUgc291cmNlIHRvIGJlIHVzZWQgdG8gbWFrZSBhIGNvcHkuCiAqICAgICAgICAgICAgICAgICAgIENhbiBiZSBhbnkgdHlwZSBpbmNsdWRpbmcgcHJpbWl0aXZlcywgYG51bGxgIGFuZCBgdW5kZWZpbmVkYC4KICogQHBhcmFtIHsoT2JqZWN0fEFycmF5KT19IGRlc3RpbmF0aW9uIE9wdGlvbmFsIGRlc3RpbmF0aW9uIGludG8gd2hpY2ggdGhlIHNvdXJjZSBpcyBjb3BpZWQuIElmCiAqICAgICBwcm92aWRlZCwgbXVzdCBiZSBvZiB0aGUgc2FtZSB0eXBlIGFzIGBzb3VyY2VgLgogKiBAcmV0dXJucyB7Kn0gVGhlIGNvcHkgb3IgdXBkYXRlZCBgZGVzdGluYXRpb25gIGlmIGBkZXN0aW5hdGlvbmAgd2FzIHNwZWNpZmllZC4KICoKICogQGV4YW1wbGUKICogPGRvYzpleGFtcGxlPgogKiAgPGRvYzpzb3VyY2U+CiAgICAgU2FsdXRhdGlvbjogPGlucHV0IHR5cGU9InRleHQiIG5hbWU9Im1hc3Rlci5zYWx1dGF0aW9uIiB2YWx1ZT0iSGVsbG8iIC8+PGJyLz4KICAgICBOYW1lOiA8aW5wdXQgdHlwZT0idGV4dCIgbmFtZT0ibWFzdGVyLm5hbWUiIHZhbHVlPSJ3b3JsZCIvPjxici8+CiAgICAgPGJ1dHRvbiBuZzpjbGljaz0iZm9ybSA9IG1hc3Rlci4kY29weSgpIj5jb3B5PC9idXR0b24+CiAgICAgPGhyLz4KCiAgICAgVGhlIG1hc3RlciBvYmplY3QgaXMgPHNwYW4gbmc6aGlkZT0ibWFzdGVyLiRlcXVhbHMoZm9ybSkiPk5PVDwvc3Bhbj4gZXF1YWwgdG8gdGhlIGZvcm0gb2JqZWN0LgoKICAgICA8cHJlPm1hc3Rlcj17e21hc3Rlcn19PC9wcmU+CiAgICAgPHByZT5mb3JtPXt7Zm9ybX19PC9wcmU+CiAqICA8L2RvYzpzb3VyY2U+CiAqICA8ZG9jOnNjZW5hcmlvPgogICBpdCgnc2hvdWxkIHByaW50IHRoYXQgaW5pdGlhbHkgdGhlIGZvcm0gb2JqZWN0IGlzIE5PVCBlcXVhbCB0byBtYXN0ZXInLCBmdW5jdGlvbigpIHsKICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgaW5wdXRbbmFtZT1tYXN0ZXIuc2FsdXRhdGlvbl0nKS52YWwoKSkudG9CZSgnSGVsbG8nKTsKICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgaW5wdXRbbmFtZT1tYXN0ZXIubmFtZV0nKS52YWwoKSkudG9CZSgnd29ybGQnKTsKICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgc3BhbicpLmNzcygnZGlzcGxheScpKS50b0JlKCdpbmxpbmUnKTsKICAgfSk7CgogICBpdCgnc2hvdWxkIG1ha2UgZm9ybSBhbmQgbWFzdGVyIGVxdWFsIHdoZW4gdGhlIGNvcHkgYnV0dG9uIGlzIGNsaWNrZWQnLCBmdW5jdGlvbigpIHsKICAgICBlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBidXR0b24nKS5jbGljaygpOwogICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBzcGFuJykuY3NzKCdkaXNwbGF5JykpLnRvQmUoJ25vbmUnKTsKICAgfSk7CiAqICA8L2RvYzpzY2VuYXJpbz4KICogPC9kb2M6ZXhhbXBsZT4KICovCmZ1bmN0aW9uIGNvcHkoc291cmNlLCBkZXN0aW5hdGlvbil7CiAgaWYgKCFkZXN0aW5hdGlvbikgewogICAgZGVzdGluYXRpb24gPSBzb3VyY2U7CiAgICBpZiAoc291cmNlKSB7CiAgICAgIGlmIChpc0FycmF5KHNvdXJjZSkpIHsKICAgICAgICBkZXN0aW5hdGlvbiA9IGNvcHkoc291cmNlLCBbXSk7CiAgICAgIH0gZWxzZSBpZiAoaXNEYXRlKHNvdXJjZSkpIHsKICAgICAgICBkZXN0aW5hdGlvbiA9IG5ldyBEYXRlKHNvdXJjZS5nZXRUaW1lKCkpOwogICAgICB9IGVsc2UgaWYgKGlzT2JqZWN0KHNvdXJjZSkpIHsKICAgICAgICBkZXN0aW5hdGlvbiA9IGNvcHkoc291cmNlLCB7fSk7CiAgICAgIH0KICAgIH0KICB9IGVsc2UgewogICAgaWYgKGlzQXJyYXkoc291cmNlKSkgewogICAgICB3aGlsZShkZXN0aW5hdGlvbi5sZW5ndGgpIHsKICAgICAgICBkZXN0aW5hdGlvbi5wb3AoKTsKICAgICAgfQogICAgICBmb3IgKCB2YXIgaSA9IDA7IGkgPCBzb3VyY2UubGVuZ3RoOyBpKyspIHsKICAgICAgICBkZXN0aW5hdGlvbi5wdXNoKGNvcHkoc291cmNlW2ldKSk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGZvckVhY2goZGVzdGluYXRpb24sIGZ1bmN0aW9uKHZhbHVlLCBrZXkpewogICAgICAgIGRlbGV0ZSBkZXN0aW5hdGlvbltrZXldOwogICAgICB9KTsKICAgICAgZm9yICggdmFyIGtleSBpbiBzb3VyY2UpIHsKICAgICAgICBkZXN0aW5hdGlvbltrZXldID0gY29weShzb3VyY2Vba2V5XSk7CiAgICAgIH0KICAgIH0KICB9CiAgcmV0dXJuIGRlc3RpbmF0aW9uOwp9CgoKLyoqCiAqIEBuZ2RvYyBmdW5jdGlvbgogKiBAbmFtZSBhbmd1bGFyLk9iamVjdC5lcXVhbHMKICogQGZ1bmN0aW9uCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBEZXRlcm1pbmVzIGlmIHR3byBvYmplY3RzIG9yIHZhbHVlIGFyZSBlcXVpdmFsZW50LgogKgogKiBUbyBiZSBlcXVpdmFsZW50LCB0aGV5IG11c3QgcGFzcyBgPT1gIGNvbXBhcmlzb24gb3IgYmUgb2YgdGhlIHNhbWUgdHlwZSBhbmQgaGF2ZSBhbGwgdGhlaXIKICogcHJvcGVydGllcyBwYXNzIGA9PWAgY29tcGFyaXNvbi4gRHVyaW5nIHByb3BlcnR5IGNvbXBhcmlzaW9uIHByb3BlcnRpZXMgb2YgYGZ1bmN0aW9uYCB0eXBlIGFuZAogKiBwcm9wZXJ0aWVzIHdpdGggbmFtZSBzdGFydGluZyB3aXRoIGAkYCBhcmUgaWdub3JlZC4KICoKICogU3VwcG9ydHMgdmFsdWVzIHR5cGVzLCBhcnJheXMgYW5kIG9iamVjdHMuCiAqCiAqIE5vdGU6IHRoaXMgZnVuY3Rpb24gaXMgdXNlZCB0byBhdWdtZW50IHRoZSBPYmplY3QgdHlwZSBpbiBhbmd1bGFyIGV4cHJlc3Npb25zLiBTZWUKICoge0BsaW5rIGFuZ3VsYXIuT2JqZWN0fSBmb3IgbW9yZSBpbmZvLgogKgogKiBAcGFyYW0geyp9IG8xIE9iamVjdCBvciB2YWx1ZSB0byBjb21wYXJlLgogKiBAcGFyYW0geyp9IG8yIE9iamVjdCBvciB2YWx1ZSB0byBjb21wYXJlLgogKiBAcmV0dXJucyB7Ym9vbGVhbn0gVHJ1ZSBpZiBhcmd1bWVudHMgYXJlIGVxdWFsLgogKgogKiBAZXhhbXBsZQogKiA8ZG9jOmV4YW1wbGU+CiAqICA8ZG9jOnNvdXJjZT4KICAgICBTYWx1dGF0aW9uOiA8aW5wdXQgdHlwZT0idGV4dCIgbmFtZT0iZ3JlZXRpbmcuc2FsdXRhdGlvbiIgdmFsdWU9IkhlbGxvIiAvPjxici8+CiAgICAgTmFtZTogPGlucHV0IHR5cGU9InRleHQiIG5hbWU9ImdyZWV0aW5nLm5hbWUiIHZhbHVlPSJ3b3JsZCIvPjxici8+CiAgICAgPGhyLz4KCiAgICAgVGhlIDxjb2RlPmdyZWV0aW5nPC9jb2RlPiBvYmplY3QgaXMKICAgICA8c3BhbiBuZzpoaWRlPSJncmVldGluZy4kZXF1YWxzKHtzYWx1dGF0aW9uOidIZWxsbycsIG5hbWU6J3dvcmxkJ30pIj5OT1Q8L3NwYW4+IGVxdWFsIHRvCiAgICAgPGNvZGU+e3NhbHV0YXRpb246J0hlbGxvJywgbmFtZTond29ybGQnfTwvY29kZT4uCgogICAgIDxwcmU+Z3JlZXRpbmc9e3tncmVldGluZ319PC9wcmU+CiAqICA8L2RvYzpzb3VyY2U+CiAqICA8ZG9jOnNjZW5hcmlvPgogICAgIGl0KCdzaG91bGQgcHJpbnQgdGhhdCBpbml0aWFseSBncmVldGluZyBpcyBlcXVhbCB0byB0aGUgaGFyZGNvZGVkIHZhbHVlIG9iamVjdCcsIGZ1bmN0aW9uKCkgewogICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIGlucHV0W25hbWU9Z3JlZXRpbmcuc2FsdXRhdGlvbl0nKS52YWwoKSkudG9CZSgnSGVsbG8nKTsKICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBpbnB1dFtuYW1lPWdyZWV0aW5nLm5hbWVdJykudmFsKCkpLnRvQmUoJ3dvcmxkJyk7CiAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgc3BhbicpLmNzcygnZGlzcGxheScpKS50b0JlKCdub25lJyk7CiAgICAgfSk7CgogICAgIGl0KCdzaG91bGQgc2F5IHRoYXQgdGhlIG9iamVjdHMgYXJlIG5vdCBlcXVhbCB3aGVuIHRoZSBmb3JtIGlzIG1vZGlmaWVkJywgZnVuY3Rpb24oKSB7CiAgICAgICBpbnB1dCgnZ3JlZXRpbmcubmFtZScpLmVudGVyKCdraXR0eScpOwogICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIHNwYW4nKS5jc3MoJ2Rpc3BsYXknKSkudG9CZSgnaW5saW5lJyk7CiAgICAgfSk7CiAqICA8L2RvYzpzY2VuYXJpbz4KICogPC9kb2M6ZXhhbXBsZT4KICovCmZ1bmN0aW9uIGVxdWFscyhvMSwgbzIpIHsKICBpZiAobzEgPT0gbzIpIHJldHVybiB0cnVlOwogIGlmIChvMSA9PT0gbnVsbCB8fCBvMiA9PT0gbnVsbCkgcmV0dXJuIGZhbHNlOwogIHZhciB0MSA9IHR5cGVvZiBvMSwgdDIgPSB0eXBlb2YgbzIsIGxlbmd0aCwga2V5LCBrZXlTZXQ7CiAgaWYgKHQxID09IHQyICYmIHQxID09ICdvYmplY3QnKSB7CiAgICBpZiAobzEgaW5zdGFuY2VvZiBBcnJheSkgewogICAgICBpZiAoKGxlbmd0aCA9IG8xLmxlbmd0aCkgPT0gbzIubGVuZ3RoKSB7CiAgICAgICAgZm9yKGtleT0wOyBrZXk8bGVuZ3RoOyBrZXkrKykgewogICAgICAgICAgaWYgKCFlcXVhbHMobzFba2V5XSwgbzJba2V5XSkpIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGtleVNldCA9IHt9OwogICAgICBmb3Ioa2V5IGluIG8xKSB7CiAgICAgICAgaWYgKGtleS5jaGFyQXQoMCkgIT09ICckJyAmJiAhaXNGdW5jdGlvbihvMVtrZXldKSAmJiAhZXF1YWxzKG8xW2tleV0sIG8yW2tleV0pKSByZXR1cm4gZmFsc2U7CiAgICAgICAga2V5U2V0W2tleV0gPSB0cnVlOwogICAgICB9CiAgICAgIGZvcihrZXkgaW4gbzIpIHsKICAgICAgICBpZiAoIWtleVNldFtrZXldICYmIGtleS5jaGFyQXQoMCkgIT09ICckJyAmJiAhaXNGdW5jdGlvbihvMltrZXldKSkgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIHJldHVybiB0cnVlOwogICAgfQogIH0KICByZXR1cm4gZmFsc2U7Cn0KCmZ1bmN0aW9uIHNldEh0bWwobm9kZSwgaHRtbCkgewogIGlmIChpc0xlYWZOb2RlKG5vZGUpKSB7CiAgICBpZiAobXNpZSkgewogICAgICBub2RlLmlubmVyVGV4dCA9IGh0bWw7CiAgICB9IGVsc2UgewogICAgICBub2RlLnRleHRDb250ZW50ID0gaHRtbDsKICAgIH0KICB9IGVsc2UgewogICAgbm9kZS5pbm5lckhUTUwgPSBodG1sOwogIH0KfQoKZnVuY3Rpb24gaXNSZW5kZXJhYmxlRWxlbWVudChlbGVtZW50KSB7CiAgdmFyIG5hbWUgPSBlbGVtZW50ICYmIGVsZW1lbnRbMF0gJiYgZWxlbWVudFswXS5ub2RlTmFtZTsKICByZXR1cm4gbmFtZSAmJiBuYW1lLmNoYXJBdCgwKSAhPSAnIycgJiYKICAgICFpbmNsdWRlcyhbJ1RSJywgJ0NPTCcsICdDT0xHUk9VUCcsICdUQk9EWScsICdUSEVBRCcsICdURk9PVCddLCBuYW1lKTsKfQoKZnVuY3Rpb24gZWxlbWVudEVycm9yKGVsZW1lbnQsIHR5cGUsIGVycm9yKSB7CiAgdmFyIHBhcmVudDsKCiAgd2hpbGUgKCFpc1JlbmRlcmFibGVFbGVtZW50KGVsZW1lbnQpKSB7CiAgICBwYXJlbnQgPSBlbGVtZW50LnBhcmVudCgpOwogICAgaWYgKHBhcmVudC5sZW5ndGgpIHsKICAgICAgZWxlbWVudCA9IGVsZW1lbnQucGFyZW50KCk7CiAgICB9IGVsc2UgewogICAgICByZXR1cm47CiAgICB9CiAgfQoKICBpZiAoZWxlbWVudFswXVsnJE5HX0VSUk9SJ10gIT09IGVycm9yKSB7CiAgICBlbGVtZW50WzBdWyckTkdfRVJST1InXSA9IGVycm9yOwogICAgaWYgKGVycm9yKSB7CiAgICAgIGVsZW1lbnQuYWRkQ2xhc3ModHlwZSk7CiAgICAgIGVsZW1lbnQuYXR0cih0eXBlLCBlcnJvci5tZXNzYWdlIHx8IGVycm9yKTsKICAgIH0gZWxzZSB7CiAgICAgIGVsZW1lbnQucmVtb3ZlQ2xhc3ModHlwZSk7CiAgICAgIGVsZW1lbnQucmVtb3ZlQXR0cih0eXBlKTsKICAgIH0KICB9Cn0KCmZ1bmN0aW9uIGNvbmNhdChhcnJheTEsIGFycmF5MiwgaW5kZXgpIHsKICByZXR1cm4gYXJyYXkxLmNvbmNhdChzbGljZS5jYWxsKGFycmF5MiwgaW5kZXgsIGFycmF5Mi5sZW5ndGgpKTsKfQoKCi8qKgogKiBAd29ya0luUHJvZ3Jlc3MKICogQG5nZG9jIGZ1bmN0aW9uCiAqIEBuYW1lIGFuZ3VsYXIuYmluZAogKiBAZnVuY3Rpb24KICoKICogQGRlc2NyaXB0aW9uCiAqIFJldHVybnMgYSBmdW5jdGlvbiB3aGljaCBjYWxscyBmdW5jdGlvbiBgZm5gIGJvdW5kIHRvIGBzZWxmYCAoYHNlbGZgIGJlY29tZXMgdGhlIGB0aGlzYCBmb3IgYGZuYCkuCiAqIE9wdGlvbmFsIGBhcmdzYCBjYW4gYmUgc3VwcGxpZWQgd2hpY2ggYXJlIHByZWJvdW5kIHRvIHRoZSBmdW5jdGlvbiwgYWxzbyBrbm93biBhcwogKiBbZnVuY3Rpb24gY3VycnlpbmddKGh0dHA6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvQ3VycnlpbmcpLgogKgogKiBAcGFyYW0ge09iamVjdH0gc2VsZiBDb250ZXh0IHdoaWNoIGBmbmAgc2hvdWxkIGJlIGV2YWx1YXRlZCBpbi4KICogQHBhcmFtIHtmdW5jdGlvbigpfSBmbiBGdW5jdGlvbiB0byBiZSBib3VuZC4KICogQHBhcmFtIHsuLi4qfSBhcmdzIE9wdGlvbmFsIGFyZ3VtZW50cyB0byBiZSBwcmVib3VuZCB0byB0aGUgYGZuYCBmdW5jdGlvbiBjYWxsLgogKiBAcmV0dXJucyB7ZnVuY3Rpb24oKX0gRnVuY3Rpb24gdGhhdCB3cmFwcyB0aGUgYGZuYCB3aXRoIGFsbCB0aGUgc3BlY2lmaWVkIGJpbmRpbmdzLgogKi8KZnVuY3Rpb24gYmluZChzZWxmLCBmbikgewogIHZhciBjdXJyeUFyZ3MgPSBhcmd1bWVudHMubGVuZ3RoID4gMgogICAgPyBzbGljZS5jYWxsKGFyZ3VtZW50cywgMiwgYXJndW1lbnRzLmxlbmd0aCkKICAgIDogW107CiAgaWYgKHR5cGVvZiBmbiA9PSAkZnVuY3Rpb24gJiYgIShmbiBpbnN0YW5jZW9mIFJlZ0V4cCkpIHsKICAgIHJldHVybiBjdXJyeUFyZ3MubGVuZ3RoCiAgICAgID8gZnVuY3Rpb24oKSB7CiAgICAgICAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aAogICAgICAgICAgICA/IGZuLmFwcGx5KHNlbGYsIGN1cnJ5QXJncy5jb25jYXQoc2xpY2UuY2FsbChhcmd1bWVudHMsIDAsIGFyZ3VtZW50cy5sZW5ndGgpKSkKICAgICAgICAgICAgOiBmbi5hcHBseShzZWxmLCBjdXJyeUFyZ3MpOwogICAgICAgIH0KICAgICAgOiBmdW5jdGlvbigpIHsKICAgICAgICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoCiAgICAgICAgICAgID8gZm4uYXBwbHkoc2VsZiwgYXJndW1lbnRzKQogICAgICAgICAgICA6IGZuLmNhbGwoc2VsZik7CiAgICAgICAgfTsKICB9IGVsc2UgewogICAgLy8gaW4gSUUsIG5hdGl2ZSBtZXRob2RzIGFyZSBub3QgZnVuY3Rpb25zIGFuZCBzbyB0aGV5IGNhbiBub3QgYmUgYm91bmQgKGJ1dCB0aGV5IGRvbid0IG5lZWQgdG8gYmUpCiAgICByZXR1cm4gZm47CiAgfQp9CgpmdW5jdGlvbiB0b0Jvb2xlYW4odmFsdWUpIHsKICBpZiAodmFsdWUgJiYgdmFsdWUubGVuZ3RoICE9PSAwKSB7CiAgICB2YXIgdiA9IGxvd2VyY2FzZSgiIiArIHZhbHVlKTsKICAgIHZhbHVlID0gISh2ID09ICdmJyB8fCB2ID09ICcwJyB8fCB2ID09ICdmYWxzZScgfHwgdiA9PSAnbm8nIHx8IHYgPT0gJ24nIHx8IHYgPT0gJ1tdJyk7CiAgfSBlbHNlIHsKICAgIHZhbHVlID0gZmFsc2U7CiAgfQogIHJldHVybiB2YWx1ZTsKfQoKZnVuY3Rpb24gbWVyZ2Uoc3JjLCBkc3QpIHsKICBmb3IgKCB2YXIga2V5IGluIHNyYykgewogICAgdmFyIHZhbHVlID0gZHN0W2tleV07CiAgICB2YXIgdHlwZSA9IHR5cGVvZiB2YWx1ZTsKICAgIGlmICh0eXBlID09ICR1bmRlZmluZWQpIHsKICAgICAgZHN0W2tleV0gPSBmcm9tSnNvbih0b0pzb24oc3JjW2tleV0pKTsKICAgIH0gZWxzZSBpZiAodHlwZSA9PSAnb2JqZWN0JyAmJiB2YWx1ZS5jb25zdHJ1Y3RvciAhPSBhcnJheSAmJgogICAgICAgIGtleS5zdWJzdHJpbmcoMCwgMSkgIT0gIiQiKSB7CiAgICAgIG1lcmdlKHNyY1trZXldLCB2YWx1ZSk7CiAgICB9CiAgfQp9CgoKLyoqIEBuYW1lIGFuZ3VsYXIuY29tcGlsZSAqLwpmdW5jdGlvbiBjb21waWxlKGVsZW1lbnQpIHsKICByZXR1cm4gbmV3IENvbXBpbGVyKGFuZ3VsYXJUZXh0TWFya3VwLCBhbmd1bGFyQXR0ck1hcmt1cCwgYW5ndWxhckRpcmVjdGl2ZSwgYW5ndWxhcldpZGdldCkKICAgIC5jb21waWxlKGVsZW1lbnQpOwp9Ci8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KCi8qKgogKiBQYXJzZXMgYW4gZXNjYXBlZCB1cmwgcXVlcnkgc3RyaW5nIGludG8ga2V5LXZhbHVlIHBhaXJzLgogKiBAcmV0dXJucyBPYmplY3QuPChzdHJpbmd8Ym9vbGVhbik+CiAqLwpmdW5jdGlvbiBwYXJzZUtleVZhbHVlKC8qKnN0cmluZyova2V5VmFsdWUpIHsKICB2YXIgb2JqID0ge30sIGtleV92YWx1ZSwga2V5OwogIGZvckVhY2goKGtleVZhbHVlIHx8ICIiKS5zcGxpdCgnJicpLCBmdW5jdGlvbihrZXlWYWx1ZSl7CiAgICBpZiAoa2V5VmFsdWUpIHsKICAgICAga2V5X3ZhbHVlID0ga2V5VmFsdWUuc3BsaXQoJz0nKTsKICAgICAga2V5ID0gdW5lc2NhcGUoa2V5X3ZhbHVlWzBdKTsKICAgICAgb2JqW2tleV0gPSBpc0RlZmluZWQoa2V5X3ZhbHVlWzFdKSA/IHVuZXNjYXBlKGtleV92YWx1ZVsxXSkgOiB0cnVlOwogICAgfQogIH0pOwogIHJldHVybiBvYmo7Cn0KCmZ1bmN0aW9uIHRvS2V5VmFsdWUob2JqKSB7CiAgdmFyIHBhcnRzID0gW107CiAgZm9yRWFjaChvYmosIGZ1bmN0aW9uKHZhbHVlLCBrZXkpIHsKICAgIHBhcnRzLnB1c2goZXNjYXBlKGtleSkgKyAodmFsdWUgPT09IHRydWUgPyAnJyA6ICc9JyArIGVzY2FwZSh2YWx1ZSkpKTsKICB9KTsKICByZXR1cm4gcGFydHMubGVuZ3RoID8gcGFydHMuam9pbignJicpIDogJyc7Cn0KCgovKioKICogV2UgbmVlZCBvdXIgY3VzdG9tIG1laHRvZCBiZWNhdXNlIGVuY29kZVVSSUNvbXBvbmVudCBpcyB0b28gYWdyZXNzaXZlIGFuZCBkb2Vzbid0IGZvbGxvdwogKiBodHRwOi8vd3d3LmlldGYub3JnL3JmYy9yZmMzOTg2LnR4dCB3aXRoIHJlZ2FyZHMgdG8gdGhlIGNoYXJhY3RlciBzZXQgKHBjaGFyKSBhbGxvd2VkIGluIHBhdGgKICogc2VnbWVudHM6CiAqICAgIHNlZ21lbnQgICAgICAgPSAqcGNoYXIKICogICAgcGNoYXIgICAgICAgICA9IHVucmVzZXJ2ZWQgLyBwY3QtZW5jb2RlZCAvIHN1Yi1kZWxpbXMgLyAiOiIgLyAiQCIKICogICAgcGN0LWVuY29kZWQgICA9ICIlIiBIRVhESUcgSEVYRElHCiAqICAgIHVucmVzZXJ2ZWQgICAgPSBBTFBIQSAvIERJR0lUIC8gIi0iIC8gIi4iIC8gIl8iIC8gIn4iCiAqICAgIHN1Yi1kZWxpbXMgICAgPSAiISIgLyAiJCIgLyAiJiIgLyAiJyIgLyAiKCIgLyAiKSIKICogICAgICAgICAgICAgICAgICAgICAvICIqIiAvICIrIiAvICIsIiAvICI7IiAvICI9IgogKi8KZnVuY3Rpb24gZW5jb2RlVXJpU2VnbWVudCh2YWwpIHsKICByZXR1cm4gZW5jb2RlVXJpUXVlcnkodmFsLCB0cnVlKS4KICAgICAgICAgICAgIHJlcGxhY2UoLyUyNi9naSwgJyYnKS4KICAgICAgICAgICAgIHJlcGxhY2UoLyUzRC9naSwgJz0nKS4KICAgICAgICAgICAgIHJlcGxhY2UoLyUyQi9naSwgJysnKTsKfQoKCi8qKgogKiBUaGlzIG1ldGhvZCBpcyBpbnRlbmRlZCBmb3IgZW5jb2RpbmcgKmtleSogb3IgKnZhbHVlKiBwYXJ0cyBvZiBxdWVyeSBjb21wb25lbnQuIFdlIG5lZWQgYSBjdXN0b20KICogbWV0aG9kIGJlY3Vhc2UgZW5jb2RlVVJJQ29tcG9uZW50IGlzIHRvbyBhZ3Jlc3NpdmUgYW5kIGVuY29kZXMgc3R1ZmYgdGhhdCBkb2Vzbid0IGhhdmUgdG8gYmUKICogZW5jb2RlZCBwZXIgaHR0cDovL3Rvb2xzLmlldGYub3JnL2h0bWwvcmZjMzk4NjoKICogICAgcXVlcnkgICAgICAgPSAqKCBwY2hhciAvICIvIiAvICI/IiApCiAqICAgIHBjaGFyICAgICAgICAgPSB1bnJlc2VydmVkIC8gcGN0LWVuY29kZWQgLyBzdWItZGVsaW1zIC8gIjoiIC8gIkAiCiAqICAgIHVucmVzZXJ2ZWQgICAgPSBBTFBIQSAvIERJR0lUIC8gIi0iIC8gIi4iIC8gIl8iIC8gIn4iCiAqICAgIHBjdC1lbmNvZGVkICAgPSAiJSIgSEVYRElHIEhFWERJRwogKiAgICBzdWItZGVsaW1zICAgID0gIiEiIC8gIiQiIC8gIiYiIC8gIiciIC8gIigiIC8gIikiCiAqICAgICAgICAgICAgICAgICAgICAgLyAiKiIgLyAiKyIgLyAiLCIgLyAiOyIgLyAiPSIKICovCmZ1bmN0aW9uIGVuY29kZVVyaVF1ZXJ5KHZhbCwgcGN0RW5jb2RlU3BhY2VzKSB7CiAgcmV0dXJuIGVuY29kZVVSSUNvbXBvbmVudCh2YWwpLgogICAgICAgICAgICAgcmVwbGFjZSgvJTQwL2dpLCAnQCcpLgogICAgICAgICAgICAgcmVwbGFjZSgvJTNBL2dpLCAnOicpLgogICAgICAgICAgICAgcmVwbGFjZSgvJTI0L2csICckJykuCiAgICAgICAgICAgICByZXBsYWNlKC8lMkMvZ2ksICcsJykuCiAgICAgICAgICAgICByZXBsYWNlKChwY3RFbmNvZGVTcGFjZXMgPyBudWxsIDogLyUyMC9nKSwgJysnKTsKfQoKCi8qKgogKiBAd29ya0luUHJvZ3Jlc3MKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBhbmd1bGFyLmRpcmVjdGl2ZS5uZzphdXRvYmluZAogKiBAZWxlbWVudCBzY3JpcHQKICoKICogQFRPRE8gbmc6YXV0b2JpbmQgaXMgbm90IGEgZGlyZWN0aXZlISEgaXQgc2hvdWxkIGJlIGRvY3VtZW50ZWQgYXMgYm9vdHN0cmFwIHBhcmFtZXRlciBpbiBhCiAqICAgICBzZXBhcmF0ZSBib290c3RyYXAgc2VjdGlvbi4KICogQFRPRE8gcmVuYW1lIHRvIG5nOmF1dG9iaW5kIHRvIG5nOmF1dG9ib290CiAqCiAqIEBkZXNjcmlwdGlvbgogKgogKiBgbmc6YXV0b2JpbmRgIHdpdGggbm8gcGFyYW1ldGVycyB0ZWxscyBhbmd1bGFyIHRvIGNvbXBpbGUgYW5kIG1hbmFnZSB0aGUgd2hvbGUgcGFnZS4KICoKICogYG5nOmF1dG9iaW5kPSJbcm9vdCBlbGVtZW50IElEXSJgIHRlbGxzIGFuZ3VsYXIgdG8gY29tcGlsZSBhbmQgbWFuYWdlIHBhcnQgb2YgdGhlIGRvY3VjbWVudCwKICogc3RhcnRpbmcgYXQgInJvb3QgZWxlbWVudCBJRCIuCiAqCiAqIEZvciBkZXRhaWxzIG9uIGJvb3RzdHJhcHBpbmcgYW5ndWxhciwgc2VlIHtAbGluayBndWlkZS9kZXZfZ3VpZGUuYm9vdHN0cmFwIEluaXRpYWxpemluZyBBbmd1bGFyfQogKiBpbiB0aGUgQW5ndWxhciBEZXZlbG9wZXIgR3VpZGUuCiAqLwpmdW5jdGlvbiBhbmd1bGFySW5pdChjb25maWcsIGRvY3VtZW50KXsKICB2YXIgYXV0b2JpbmQgPSBjb25maWcuYXV0b2JpbmQ7CgogIGlmIChhdXRvYmluZCkgewogICAgdmFyIGVsZW1lbnQgPSBpc1N0cmluZyhhdXRvYmluZCkgPyBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChhdXRvYmluZCkgOiBkb2N1bWVudCwKICAgICAgICBzY29wZSA9IGNvbXBpbGUoZWxlbWVudCkoY3JlYXRlU2NvcGUoeyckY29uZmlnJzpjb25maWd9KSksCiAgICAgICAgJGJyb3dzZXIgPSBzY29wZS4kc2VydmljZSgnJGJyb3dzZXInKTsKCiAgICBpZiAoY29uZmlnLmNzcykKICAgICAgJGJyb3dzZXIuYWRkQ3NzKGNvbmZpZy5iYXNlX3VybCArIGNvbmZpZy5jc3MpOwogICAgZWxzZSBpZihtc2llPDgpCiAgICAgICRicm93c2VyLmFkZEpzKGNvbmZpZy5pZV9jb21wYXQsIGNvbmZpZy5pZV9jb21wYXRfaWQpOwogIH0KfQoKZnVuY3Rpb24gYW5ndWxhckpzQ29uZmlnKGRvY3VtZW50LCBjb25maWcpIHsKICBiaW5kSlF1ZXJ5KCk7CiAgdmFyIHNjcmlwdHMgPSBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgic2NyaXB0IiksCiAgICAgIG1hdGNoOwogIGNvbmZpZyA9IGV4dGVuZCh7CiAgICBpZV9jb21wYXRfaWQ6ICduZy1pZS1jb21wYXQnCiAgfSwgY29uZmlnKTsKICBmb3IodmFyIGogPSAwOyBqIDwgc2NyaXB0cy5sZW5ndGg7IGorKykgewogICAgbWF0Y2ggPSAoc2NyaXB0c1tqXS5zcmMgfHwgIiIpLm1hdGNoKHJuZ1NjcmlwdCk7CiAgICBpZiAobWF0Y2gpIHsKICAgICAgY29uZmlnLmJhc2VfdXJsID0gbWF0Y2hbMV07CiAgICAgIGNvbmZpZy5pZV9jb21wYXQgPSBtYXRjaFsxXSArICdhbmd1bGFyLWllLWNvbXBhdCcgKyAobWF0Y2hbMl0gfHwgJycpICsgJy5qcyc7CiAgICAgIGV4dGVuZChjb25maWcsIHBhcnNlS2V5VmFsdWUobWF0Y2hbNl0pKTsKICAgICAgZWFjaEF0dHJpYnV0ZShqcUxpdGUoc2NyaXB0c1tqXSksIGZ1bmN0aW9uKHZhbHVlLCBuYW1lKXsKICAgICAgICBpZiAoL15uZzovLmV4ZWMobmFtZSkpIHsKICAgICAgICAgIG5hbWUgPSBuYW1lLnN1YnN0cmluZygzKS5yZXBsYWNlKC8tL2csICdfJyk7CiAgICAgICAgICB2YWx1ZSA9IHZhbHVlIHx8IHRydWU7CiAgICAgICAgICBjb25maWdbbmFtZV0gPSB2YWx1ZTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQogIH0KICByZXR1cm4gY29uZmlnOwp9CgpmdW5jdGlvbiBiaW5kSlF1ZXJ5KCl7CiAgLy8gYmluZCB0byBqUXVlcnkgaWYgcHJlc2VudDsKICBqUXVlcnkgPSB3aW5kb3cualF1ZXJ5OwogIC8vIHJlc2V0IHRvIGpRdWVyeSBvciBkZWZhdWx0IHRvIHVzLgogIGlmIChqUXVlcnkpIHsKICAgIGpxTGl0ZSA9IGpRdWVyeTsKICAgIGV4dGVuZChqUXVlcnkuZm4sIHsKICAgICAgc2NvcGU6IEpRTGl0ZVByb3RvdHlwZS5zY29wZQogICAgfSk7CiAgfSBlbHNlIHsKICAgIGpxTGl0ZSA9IGpxTGl0ZVdyYXA7CiAgfQogIGFuZ3VsYXIuZWxlbWVudCA9IGpxTGl0ZTsKfQoKLyoqCiAqIHRocm93IGVycm9yIG9mIHRoZSBhcmd1bWVudCBpcyBmYWxzeS4KICovCmZ1bmN0aW9uIGFzc2VydEFyZyhhcmcsIG5hbWUsIHJlYXNvbikgewogIGlmICghYXJnKSB7CiAgICB2YXIgZXJyb3IgPSBuZXcgRXJyb3IoIkFyZ3VtZW50ICciICsgKG5hbWV8fCc/JykgKyAiJyBpcyAiICsKICAgICAgICAocmVhc29uIHx8ICJyZXF1aXJlZCIpKTsKICAgIHRocm93IGVycm9yOwogIH0KfQoKZnVuY3Rpb24gYXNzZXJ0QXJnRm4oYXJnLCBuYW1lKSB7CiAgYXNzZXJ0QXJnKGlzRnVuY3Rpb24oYXJnLCBuYW1lLCAnbm90IGEgZnVuY3Rpb24nKSk7Cn0KCgovKioKICogQG5nZG9jIHByb3BlcnR5CiAqIEBuYW1lIGFuZ3VsYXIudmVyc2lvbgogKiBAZGVzY3JpcHRpb24KICogT2JqZWN0IHdoaWNoIGNvbnRhaW5zIGluZm9ybWF0aW9uIGFib3V0IHRoZSBjdXJyZW50IEFuZ3VsYXJKUyB2ZXJzaW9uLiBUaGUgb2JqZWN0IGhhcyBmb2xsb3dpbmcKICogcHJvcGVydGllczoKICoKICogLSBgZnVsbGAg4oCTIGB7c3RyaW5nfWAg4oCTIGZ1bGwgdmVyc2lvbiBzdHJpbmcsIGUuZy4gIjAuOS4xOCIKICogLSBgbWFqb3JgIOKAkyBge251bWJlcn1gIOKAkyBtYWpvciB2ZXJzaW9uIG51bWJlciwgZS5nLiAwCiAqIC0gYG1pbm9yYCDigJMgYHtudW1iZXJ9YCDigJMgbWlub3IgdmVyc2lvbiBudW1iZXIsIGUuZy4gOQogKiAtIGBkb3RgIOKAkyBge251bWJlcn1gIOKAkyBkb3QgdmVyc2lvbiBudW1iZXIsIGUuZy4gMTgKICogLSBgY29kZU5hbWVgIOKAkyBge3N0cmluZ31gIOKAkyBjb2RlIG5hbWUgb2YgdGhlIHJlbGVhc2UsIGUuZy4gImppZ2dsaW5nLWFybWZhdCIKICovCnZhciB2ZXJzaW9uID0gewogIGZ1bGw6ICcwLjkuMTknLCAgICAvLyBhbGwgb2YgdGhlc2UgcGxhY2Vob2xkZXIgc3RyaW5ncyB3aWxsIGJlIHJlcGxhY2VkIGJ5IHJha2UncwogIG1ham9yOiAiTkdfVkVSU0lPTl9NQUpPUiIsICAgIC8vIGNvbXBpbGUgdGFzawogIG1pbm9yOiAiTkdfVkVSU0lPTl9NSU5PUiIsCiAgZG90OiAiTkdfVkVSU0lPTl9ET1QiLAogIGNvZGVOYW1lOiAnIk5HX1ZFUlNJT05fQ09ERU5BTUUiJwp9OwondXNlIHN0cmljdCc7Cgp2YXIgYXJyYXkgPSBbXS5jb25zdHJ1Y3RvcjsKCi8qKgogKiBAd29ya0luUHJvZ3Jlc3MKICogQG5nZG9jIGZ1bmN0aW9uCiAqIEBuYW1lIGFuZ3VsYXIudG9Kc29uCiAqIEBmdW5jdGlvbgogKgogKiBAZGVzY3JpcHRpb24KICogU2VyaWFsaXplcyB0aGUgaW5wdXQgaW50byBhIEpTT04gZm9ybWF0ZWQgc3RyaW5nLgogKgogKiBAcGFyYW0ge09iamVjdHxBcnJheXxEYXRlfHN0cmluZ3xudW1iZXJ9IG9iaiBJbnB1dCB0byBqc29uaWZ5LgogKiBAcGFyYW0ge2Jvb2xlYW49fSBwcmV0dHkgSWYgc2V0IHRvIHRydWUsIHRoZSBKU09OIG91dHB1dCB3aWxsIGNvbnRhaW4gbmV3bGluZXMgYW5kIHdoaXRlc3BhY2UuCiAqIEByZXR1cm5zIHtzdHJpbmd9IEpzb25pZmllZCBzdHJpbmcgcmVwcmVzZW50aW5nIGBvYmpgLgogKi8KZnVuY3Rpb24gdG9Kc29uKG9iaiwgcHJldHR5KSB7CiAgdmFyIGJ1ZiA9IFtdOwogIHRvSnNvbkFycmF5KGJ1Ziwgb2JqLCBwcmV0dHkgPyAiXG4gICIgOiBudWxsLCBbXSk7CiAgcmV0dXJuIGJ1Zi5qb2luKCcnKTsKfQoKLyoqCiAqIEB3b3JrSW5Qcm9ncmVzcwogKiBAbmdkb2MgZnVuY3Rpb24KICogQG5hbWUgYW5ndWxhci5mcm9tSnNvbgogKiBAZnVuY3Rpb24KICoKICogQGRlc2NyaXB0aW9uCiAqIERlc2VyaWFsaXplcyBhIHN0cmluZyBpbiB0aGUgSlNPTiBmb3JtYXQuCiAqCiAqIEBwYXJhbSB7c3RyaW5nfSBqc29uIEpTT04gc3RyaW5nIHRvIGRlc2VyaWFsaXplLgogKiBAcGFyYW0ge2Jvb2xlYW59IFt1c2VOYXRpdmU9ZmFsc2VdIFVzZSBuYXRpdmUgSlNPTiBwYXJzZXIgaWYgYXZhaWxhYmxlCiAqIEByZXR1cm5zIHtPYmplY3R8QXJyYXl8RGF0ZXxzdHJpbmd8bnVtYmVyfSBEZXNlcmlhbGl6ZWQgdGhpbmd5LgogKi8KZnVuY3Rpb24gZnJvbUpzb24oanNvbiwgdXNlTmF0aXZlKSB7CiAgaWYgKCFpc1N0cmluZyhqc29uKSkgcmV0dXJuIGpzb247CgogIHZhciBvYmo7CgogIHRyeSB7CiAgICBpZiAodXNlTmF0aXZlICYmIHdpbmRvdy5KU09OICYmIHdpbmRvdy5KU09OLnBhcnNlKSB7CiAgICAgIG9iaiA9IEpTT04ucGFyc2UoanNvbik7CiAgICAgIHJldHVybiB0cmFuc2Zvcm1EYXRlcyhvYmopOwogICAgfQogICAgcmV0dXJuIHBhcnNlcihqc29uLCB0cnVlKS5wcmltYXJ5KCkoKTsKICB9IGNhdGNoIChlKSB7CiAgICBlcnJvcigiZnJvbUpzb24gZXJyb3I6ICIsIGpzb24sIGUpOwogICAgdGhyb3cgZTsKICB9CgogIC8vIFRPRE8gbWFrZSBmb3JFYWNoIG9wdGlvbmFsbHkgcmVjdXJzaXZlIGFuZCByZW1vdmUgdGhpcyBmdW5jdGlvbgogIGZ1bmN0aW9uIHRyYW5zZm9ybURhdGVzKG9iaikgewogICAgaWYgKGlzU3RyaW5nKG9iaikgJiYgb2JqLmxlbmd0aCA9PT0gREFURV9JU09TVFJJTkdfTE4pIHsKICAgICAgcmV0dXJuIGFuZ3VsYXJTdHJpbmcudG9EYXRlKG9iaik7CiAgICB9IGVsc2UgaWYgKGlzQXJyYXkob2JqKSB8fCBpc09iamVjdChvYmopKSB7CiAgICAgIGZvckVhY2gob2JqLCBmdW5jdGlvbih2YWwsIG5hbWUpIHsKICAgICAgICBvYmpbbmFtZV0gPSB0cmFuc2Zvcm1EYXRlcyh2YWwpOwogICAgICB9KTsKICAgIH0KICAgIHJldHVybiBvYmo7CiAgfQp9Cgphbmd1bGFyLnRvSnNvbiA9IHRvSnNvbjsKYW5ndWxhci5mcm9tSnNvbiA9IGZyb21Kc29uOwoKZnVuY3Rpb24gdG9Kc29uQXJyYXkoYnVmLCBvYmosIHByZXR0eSwgc3RhY2spIHsKICBpZiAoaXNPYmplY3Qob2JqKSkgewogICAgaWYgKG9iaiA9PT0gd2luZG93KSB7CiAgICAgIGJ1Zi5wdXNoKCdXSU5ET1cnKTsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIGlmIChvYmogPT09IGRvY3VtZW50KSB7CiAgICAgIGJ1Zi5wdXNoKCdET0NVTUVOVCcpOwogICAgICByZXR1cm47CiAgICB9CgogICAgaWYgKGluY2x1ZGVzKHN0YWNrLCBvYmopKSB7CiAgICAgIGJ1Zi5wdXNoKCdSRUNVUlNJT04nKTsKICAgICAgcmV0dXJuOwogICAgfQogICAgc3RhY2sucHVzaChvYmopOwogIH0KICBpZiAob2JqID09PSBudWxsKSB7CiAgICBidWYucHVzaCgkbnVsbCk7CiAgfSBlbHNlIGlmIChvYmogaW5zdGFuY2VvZiBSZWdFeHApIHsKICAgIGJ1Zi5wdXNoKGFuZ3VsYXIuU3RyaW5nLnF1b3RlVW5pY29kZShvYmoudG9TdHJpbmcoKSkpOwogIH0gZWxzZSBpZiAoaXNGdW5jdGlvbihvYmopKSB7CiAgICByZXR1cm47CiAgfSBlbHNlIGlmIChpc0Jvb2xlYW4ob2JqKSkgewogICAgYnVmLnB1c2goJycgKyBvYmopOwogIH0gZWxzZSBpZiAoaXNOdW1iZXIob2JqKSkgewogICAgaWYgKGlzTmFOKG9iaikpIHsKICAgICAgYnVmLnB1c2goJG51bGwpOwogICAgfSBlbHNlIHsKICAgICAgYnVmLnB1c2goJycgKyBvYmopOwogICAgfQogIH0gZWxzZSBpZiAoaXNTdHJpbmcob2JqKSkgewogICAgcmV0dXJuIGJ1Zi5wdXNoKGFuZ3VsYXIuU3RyaW5nLnF1b3RlVW5pY29kZShvYmopKTsKICB9IGVsc2UgaWYgKGlzT2JqZWN0KG9iaikpIHsKICAgIGlmIChpc0FycmF5KG9iaikpIHsKICAgICAgYnVmLnB1c2goIlsiKTsKICAgICAgdmFyIGxlbiA9IG9iai5sZW5ndGg7CiAgICAgIHZhciBzZXAgPSBmYWxzZTsKICAgICAgZm9yKHZhciBpPTA7IGk8bGVuOyBpKyspIHsKICAgICAgICB2YXIgaXRlbSA9IG9ialtpXTsKICAgICAgICBpZiAoc2VwKSBidWYucHVzaCgiLCIpOwogICAgICAgIGlmICghKGl0ZW0gaW5zdGFuY2VvZiBSZWdFeHApICYmIChpc0Z1bmN0aW9uKGl0ZW0pIHx8IGlzVW5kZWZpbmVkKGl0ZW0pKSkgewogICAgICAgICAgYnVmLnB1c2goJG51bGwpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0b0pzb25BcnJheShidWYsIGl0ZW0sIHByZXR0eSwgc3RhY2spOwogICAgICAgIH0KICAgICAgICBzZXAgPSB0cnVlOwogICAgICB9CiAgICAgIGJ1Zi5wdXNoKCJdIik7CiAgICB9IGVsc2UgaWYgKGlzRGF0ZShvYmopKSB7CiAgICAgIGJ1Zi5wdXNoKGFuZ3VsYXIuU3RyaW5nLnF1b3RlVW5pY29kZShhbmd1bGFyLkRhdGUudG9TdHJpbmcob2JqKSkpOwogICAgfSBlbHNlIHsKICAgICAgYnVmLnB1c2goInsiKTsKICAgICAgaWYgKHByZXR0eSkgYnVmLnB1c2gocHJldHR5KTsKICAgICAgdmFyIGNvbW1hID0gZmFsc2U7CiAgICAgIHZhciBjaGlsZFByZXR0eSA9IHByZXR0eSA/IHByZXR0eSArICIgICIgOiBmYWxzZTsKICAgICAgdmFyIGtleXMgPSBbXTsKICAgICAgZm9yKHZhciBrIGluIG9iaikgewogICAgICAgIGlmIChvYmouaGFzT3duUHJvcGVydHkoaykgJiYgb2JqW2tdICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgIGtleXMucHVzaChrKTsKICAgICAgICB9CiAgICAgIH0KICAgICAga2V5cy5zb3J0KCk7CiAgICAgIGZvciAoIHZhciBrZXlJbmRleCA9IDA7IGtleUluZGV4IDwga2V5cy5sZW5ndGg7IGtleUluZGV4KyspIHsKICAgICAgICB2YXIga2V5ID0ga2V5c1trZXlJbmRleF07CiAgICAgICAgdmFyIHZhbHVlID0gb2JqW2tleV07CiAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSAhPSAkZnVuY3Rpb24pIHsKICAgICAgICAgIGlmIChjb21tYSkgewogICAgICAgICAgICBidWYucHVzaCgiLCIpOwogICAgICAgICAgICBpZiAocHJldHR5KSBidWYucHVzaChwcmV0dHkpOwogICAgICAgICAgfQogICAgICAgICAgYnVmLnB1c2goYW5ndWxhci5TdHJpbmcucXVvdGUoa2V5KSk7CiAgICAgICAgICBidWYucHVzaCgiOiIpOwogICAgICAgICAgdG9Kc29uQXJyYXkoYnVmLCB2YWx1ZSwgY2hpbGRQcmV0dHksIHN0YWNrKTsKICAgICAgICAgIGNvbW1hID0gdHJ1ZTsKICAgICAgICB9CiAgICAgIH0KICAgICAgYnVmLnB1c2goIn0iKTsKICAgIH0KICB9CiAgaWYgKGlzT2JqZWN0KG9iaikpIHsKICAgIHN0YWNrLnBvcCgpOwogIH0KfQondXNlIHN0cmljdCc7CgovKioKICogVGVtcGxhdGUgcHJvdmlkZXMgZGlyZWN0aW9ucyBhbiBob3cgdG8gYmluZCB0byBhIGdpdmVuIGVsZW1lbnQuCiAqIEl0IGNvbnRhaW5zIGEgbGlzdCBvZiBpbml0IGZ1bmN0aW9ucyB3aGljaCBuZWVkIHRvIGJlIGNhbGxlZCB0bwogKiBiaW5kIHRvIGEgbmV3IGluc3RhbmNlIG9mIGVsZW1lbnRzLiBJdCBhbHNvIHByb3ZpZGVzIGEgbGlzdAogKiBvZiBjaGlsZCBwYXRocyB3aGljaCBjb250YWluIGNoaWxkIHRlbXBsYXRlcwogKi8KZnVuY3Rpb24gVGVtcGxhdGUocHJpb3JpdHkpIHsKICB0aGlzLnBhdGhzID0gW107CiAgdGhpcy5jaGlsZHJlbiA9IFtdOwogIHRoaXMuaW5pdHMgPSBbXTsKICB0aGlzLnByaW9yaXR5ID0gcHJpb3JpdHk7CiAgdGhpcy5uZXdTY29wZSA9IGZhbHNlOwp9CgpUZW1wbGF0ZS5wcm90b3R5cGUgPSB7CiAgYXR0YWNoOiBmdW5jdGlvbihlbGVtZW50LCBzY29wZSkgewogICAgdmFyIGluaXRzID0ge307CiAgICB0aGlzLmNvbGxlY3RJbml0cyhlbGVtZW50LCBpbml0cywgc2NvcGUpOwogICAgZm9yRWFjaFNvcnRlZChpbml0cywgZnVuY3Rpb24ocXVldWUpewogICAgICBmb3JFYWNoKHF1ZXVlLCBmdW5jdGlvbihmbikge2ZuKCk7fSk7CiAgICB9KTsKICB9LAoKICBjb2xsZWN0SW5pdHM6IGZ1bmN0aW9uKGVsZW1lbnQsIGluaXRzLCBzY29wZSkgewogICAgdmFyIHF1ZXVlID0gaW5pdHNbdGhpcy5wcmlvcml0eV0sIGNoaWxkU2NvcGUgPSBzY29wZTsKICAgIGlmICghcXVldWUpIHsKICAgICAgaW5pdHNbdGhpcy5wcmlvcml0eV0gPSBxdWV1ZSA9IFtdOwogICAgfQogICAgaWYgKHRoaXMubmV3U2NvcGUpIHsKICAgICAgY2hpbGRTY29wZSA9IGNyZWF0ZVNjb3BlKHNjb3BlKTsKICAgICAgc2NvcGUuJG9uRXZhbChjaGlsZFNjb3BlLiRldmFsKTsKICAgICAgZWxlbWVudC5kYXRhKCQkc2NvcGUsIGNoaWxkU2NvcGUpOwogICAgfQogICAgZm9yRWFjaCh0aGlzLmluaXRzLCBmdW5jdGlvbihmbikgewogICAgICBxdWV1ZS5wdXNoKGZ1bmN0aW9uKCkgewogICAgICAgIGNoaWxkU2NvcGUuJHRyeUV2YWwoZnVuY3Rpb24oKXsKICAgICAgICAgIHJldHVybiBjaGlsZFNjb3BlLiRzZXJ2aWNlLmludm9rZShjaGlsZFNjb3BlLCBmbiwgW2VsZW1lbnRdKTsKICAgICAgICB9LCBlbGVtZW50KTsKICAgICAgfSk7CiAgICB9KTsKICAgIHZhciBpLAogICAgICAgIGNoaWxkTm9kZXMgPSBlbGVtZW50WzBdLmNoaWxkTm9kZXMsCiAgICAgICAgY2hpbGRyZW4gPSB0aGlzLmNoaWxkcmVuLAogICAgICAgIHBhdGhzID0gdGhpcy5wYXRocywKICAgICAgICBsZW5ndGggPSBwYXRocy5sZW5ndGg7CiAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgY2hpbGRyZW5baV0uY29sbGVjdEluaXRzKGpxTGl0ZShjaGlsZE5vZGVzW3BhdGhzW2ldXSksIGluaXRzLCBjaGlsZFNjb3BlKTsKICAgIH0KICB9LAoKCiAgYWRkSW5pdDpmdW5jdGlvbihsaW5raW5nRm4pIHsKICAgIGlmIChsaW5raW5nRm4pIHsKICAgICAgaWYgKCFsaW5raW5nRm4uJGluamVjdCkKICAgICAgICBsaW5raW5nRm4uJGluamVjdCA9IFtdOwogICAgICB0aGlzLmluaXRzLnB1c2gobGlua2luZ0ZuKTsKICAgIH0KICB9LAoKCiAgYWRkQ2hpbGQ6IGZ1bmN0aW9uKGluZGV4LCB0ZW1wbGF0ZSkgewogICAgaWYgKHRlbXBsYXRlKSB7CiAgICAgIHRoaXMucGF0aHMucHVzaChpbmRleCk7CiAgICAgIHRoaXMuY2hpbGRyZW4ucHVzaCh0ZW1wbGF0ZSk7CiAgICB9CiAgfSwKCiAgZW1wdHk6IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHRoaXMuaW5pdHMubGVuZ3RoID09PSAwICYmIHRoaXMucGF0aHMubGVuZ3RoID09PSAwOwogIH0KfTsKCi8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCi8vQ29tcGlsZXIKLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwoKLyoqCiAqIEB3b3JrSW5Qcm9ncmVzcwogKiBAbmdkb2MgZnVuY3Rpb24KICogQG5hbWUgYW5ndWxhci5jb21waWxlCiAqIEBmdW5jdGlvbgogKgogKiBAZGVzY3JpcHRpb24KICogQ29tcGlsZXMgYSBwaWVjZSBvZiBIVE1MIHN0cmluZyBvciBET00gaW50byBhIHRlbXBsYXRlIGFuZCBwcm9kdWNlcyBhIHRlbXBsYXRlIGZ1bmN0aW9uLCB3aGljaAogKiBjYW4gdGhlbiBiZSB1c2VkIHRvIGxpbmsge0BsaW5rIGFuZ3VsYXIuc2NvcGUgc2NvcGV9IGFuZCB0aGUgdGVtcGxhdGUgdG9nZXRoZXIuCiAqCiAqIFRoZSBjb21waWxhdGlvbiBpcyBhIHByb2Nlc3Mgb2Ygd2Fsa2luZyB0aGUgRE9NIHRyZWUgYW5kIHRyeWluZyB0byBtYXRjaCBET00gZWxlbWVudHMgdG8KICoge0BsaW5rIGFuZ3VsYXIubWFya3VwIG1hcmt1cH0sIHtAbGluayBhbmd1bGFyLmF0dHJNYXJrdXAgYXR0ck1hcmt1cH0sCiAqIHtAbGluayBhbmd1bGFyLndpZGdldCB3aWRnZXRzfSwgYW5kIHtAbGluayBhbmd1bGFyLmRpcmVjdGl2ZSBkaXJlY3RpdmVzfS4gRm9yIGVhY2ggbWF0Y2ggaXQKICogZXhlY3V0ZXMgY29ycmVzcG9uZGluZyBtYXJrdXAsIGF0dHJNYXJrdXAsIHdpZGdldCBvciBkaXJlY3RpdmUgdGVtcGxhdGUgZnVuY3Rpb24gYW5kIGNvbGxlY3RzIHRoZQogKiBpbnN0YW5jZSBmdW5jdGlvbnMgaW50byBhIHNpbmdsZSB0ZW1wbGF0ZSBmdW5jdGlvbiB3aGljaCBpcyB0aGVuIHJldHVybmVkLgogKgogKiBUaGUgdGVtcGxhdGUgZnVuY3Rpb24gY2FuIHRoZW4gYmUgdXNlZCBvbmNlIHRvIHByb2R1Y2UgdGhlIHZpZXcgb3IgYXMgaXQgaXMgdGhlIGNhc2Ugd2l0aAogKiB7QGxpbmsgYW5ndWxhci53aWRnZXQuQG5nOnJlcGVhdCByZXBlYXRlcn0gbWFueS10aW1lcywgaW4gd2hpY2ggY2FzZSBlYWNoIGNhbGwgcmVzdWx0cyBpbiBhIHZpZXcKICogdGhhdCBpcyBhIERPTSBjbG9uZSBvZiB0aGUgb3JpZ2luYWwgdGVtcGxhdGUuCiAqCiAgIDxwcmU+CiAgICAvLyBjb21waWxlIHRoZSBlbnRpcmUgd2luZG93LmRvY3VtZW50IGFuZCBnaXZlIG1lIHRoZSBzY29wZSBib3VuZCB0byB0aGlzIHRlbXBsYXRlLgogICAgdmFyIHJvb3RTY29wZSA9IGFuZ3VsYXIuY29tcGlsZSh3aW5kb3cuZG9jdW1lbnQpKCk7CgogICAgLy8gY29tcGlsZSBhIHBpZWNlIG9mIGh0bWwKICAgIHZhciByb290U2NvcGUyID0gYW5ndWxhci5jb21waWxlKCc8ZGl2IG5nOmNsaWNrPSJjbGlja2VkID0gdHJ1ZSI+Y2xpY2sgbWU8L2Rpdj4nKSgpOwoKICAgIC8vIGNvbXBpbGUgYSBwaWVjZSBvZiBodG1sIGFuZCByZXRhaW4gcmVmZXJlbmNlIHRvIGJvdGggdGhlIGRvbSBhbmQgc2NvcGUKICAgIHZhciB0ZW1wbGF0ZSA9IGFuZ3VsYXIuZWxlbWVudCgnPGRpdiBuZzpjbGljaz0iY2xpY2tlZCA9IHRydWUiPmNsaWNrIG1lPC9kaXY+JyksCiAgICAgICAgc2NvcGUgPSBhbmd1bGFyLmNvbXBpbGUodGVtcGxhdGUpKCk7CiAgICAvLyBhdCB0aGlzIHBvaW50IHRlbXBsYXRlIHdhcyB0cmFuc2Zvcm1lZCBpbnRvIGEgdmlldwogICA8L3ByZT4KICoKICoKICogQHBhcmFtIHtzdHJpbmd8RE9NRWxlbWVudH0gZWxlbWVudCBFbGVtZW50IG9yIEhUTUwgdG8gY29tcGlsZSBpbnRvIGEgdGVtcGxhdGUgZnVuY3Rpb24uCiAqIEByZXR1cm5zIHtmdW5jdGlvbihbc2NvcGVdWywgY2xvbmVBdHRhY2hGbl0pfSBhIHRlbXBsYXRlIGZ1bmN0aW9uIHdoaWNoIGlzIHVzZWQgdG8gYmluZCB0ZW1wbGF0ZQogKiAoYSBET00gZWxlbWVudC90cmVlKSB0byBhIHNjb3BlLiBXaGVyZToKICoKICogICogYHNjb3BlYCAtIEEge0BsaW5rIGFuZ3VsYXIuc2NvcGUgU2NvcGV9IHRvIGJpbmQgdG8uIElmIG5vbmUgc3BlY2lmaWVkLCB0aGVuIGEgbmV3CiAqICAgICAgICAgICAgICAgcm9vdCBzY29wZSBpcyBjcmVhdGVkLgogKiAgKiBgY2xvbmVBdHRhY2hGbmAgLSBJZiBgY2xvbmVBdHRhY2hGbmAgaXMgcHJvdmlkZWQsIHRoZW4gdGhlIGxpbmsgZnVuY3Rpb24gd2lsbCBjbG9uZSB0aGUKICogICAgICAgICAgICAgICBgdGVtcGxhdGVgIGFuZCBjYWxsIHRoZSBgY2xvbmVBdHRhY2hGbmAgZnVuY3Rpb24gYWxsb3dpbmcgdGhlIGNhbGxlciB0byBhdHRhY2ggdGhlCiAqICAgICAgICAgICAgICAgY2xvbmVkIGVsZW1lbnRzIHRvIHRoZSBET00gZG9jdW1lbnQgYXQgdGhlIGFwcHJvcHJpYXRlIHBsYWNlLiBUaGUgYGNsb25lQXR0YWNoRm5gIGlzCiAqICAgICAgICAgICAgICAgY2FsbGVkIGFzOiA8YnIvPiBgY2xvbmVBdHRhY2hGbihjbG9uZWRFbGVtZW50LCBzY29wZSlgIHdoZXJlOgogKgogKiAgICAgICogYGNsb25lZEVsZW1lbnRgIC0gaXMgYSBjbG9uZSBvZiB0aGUgb3JpZ2luYWwgYGVsZW1lbnRgIHBhc3NlZCBpbnRvIHRoZSBjb21waWxlci4KICogICAgICAqIGBzY29wZWAgLSBpcyB0aGUgY3VycmVudCBzY29wZSB3aXRoIHdoaWNoIHRoZSBsaW5raW5nIGZ1bmN0aW9uIGlzIHdvcmtpbmcgd2l0aC4KICoKICogQ2FsbGluZyB0aGUgdGVtcGxhdGUgZnVuY3Rpb24gcmV0dXJucyB0aGUgc2NvcGUgdG8gd2hpY2ggdGhlIGVsZW1lbnQgaXMgYm91bmQgdG8uIEl0IGlzIGVpdGhlcgogKiB0aGUgc2FtZSBzY29wZSBhcyB0aGUgb25lIHBhc3NlZCBpbnRvIHRoZSB0ZW1wbGF0ZSBmdW5jdGlvbiwgb3IgaWYgbm9uZSB3ZXJlIHByb3ZpZGVkIGl0J3MgdGhlCiAqIG5ld2x5IGNyZWF0ZSBzY29wZS4KICoKICogSWYgeW91IG5lZWQgYWNjZXNzIHRvIHRoZSBib3VuZCB2aWV3LCB0aGVyZSBhcmUgdHdvIHdheXMgdG8gZG8gaXQ6CiAqCiAqIC0gSWYgeW91IGFyZSBub3QgYXNraW5nIHRoZSBsaW5raW5nIGZ1bmN0aW9uIHRvIGNsb25lIHRoZSB0ZW1wbGF0ZSwgY3JlYXRlIHRoZSBET00gZWxlbWVudChzKQogKiAgIGJlZm9yZSB5b3Ugc2VuZCB0aGVtIHRvIHRoZSBjb21waWxlciBhbmQga2VlcCB0aGlzIHJlZmVyZW5jZSBhcm91bmQuCiAqICAgPHByZT4KICogICAgIHZhciB2aWV3ID0gYW5ndWxhci5lbGVtZW50KCc8cD57e3RvdGFsfX08L3A+JyksCiAqICAgICAgICAgc2NvcGUgPSBhbmd1bGFyLmNvbXBpbGUodmlldykoKTsKICogICA8L3ByZT4KICoKICogLSBpZiBvbiB0aGUgb3RoZXIgaGFuZCwgeW91IG5lZWQgdGhlIGVsZW1lbnQgdG8gYmUgY2xvbmVkLCB0aGUgdmlldyByZWZlcmVuY2UgZnJvbSB0aGUgb3JpZ2luYWwKICogICBleGFtcGxlIHdvdWxkIG5vdCBwb2ludCB0byB0aGUgY2xvbmUsIGJ1dCByYXRoZXIgdG8gdGhlIG9yaWdpbmFsIHRlbXBsYXRlIHRoYXQgd2FzIGNsb25lZC4gSW4KICogICB0aGlzIGNhc2UsIHlvdSBjYW4gYWNjZXNzIHRoZSBjbG9uZSB2aWEgdGhlIGNsb25lQXR0YWNoRm46CiAqICAgPHByZT4KICogICAgIHZhciBvcmlnaW5hbCA9IGFuZ3VsYXIuZWxlbWVudCgnPHA+e3t0b3RhbH19PC9wPicpLAogKiAgICAgICAgIHNjb3BlID0gc29tZVBhcmVudFNjb3BlLiRuZXcoKSwKICogICAgICAgICBjbG9uZTsKICoKICogICAgIGFuZ3VsYXIuY29tcGlsZShvcmlnaW5hbCkoc2NvcGUsIGZ1bmN0aW9uKGNsb25lZEVsZW1lbnQsIHNjb3BlKSB7CiAqICAgICAgIGNsb25lID0gY2xvbmVkRWxlbWVudDsKICogICAgICAgLy9hdHRhY2ggdGhlIGNsb25lIHRvIERPTSBkb2N1bWVudCBhdCB0aGUgcmlnaHQgcGxhY2UKICogICAgIH0pOwogKgogKiAgICAgLy9ub3cgd2UgaGF2ZSByZWZlcmVuY2UgdG8gdGhlIGNsb25lZCBET00gdmlhIGBjbG9uZWAKICogICA8L3ByZT4KICoKICoKICogQ29tcGlsZXIgTWV0aG9kcyBGb3IgV2lkZ2V0cyBhbmQgRGlyZWN0aXZlczoKICoKICogVGhlIGZvbGxvd2luZyBtZXRob2RzIGFyZSBhdmFpbGFibGUgZm9yIHVzZSB3aGVuIHlvdSB3cml0ZSB5b3VyIG93biB3aWRnZXRzLCBkaXJlY3RpdmVzLAogKiBhbmQgbWFya3VwLiAgKFJlY2FsbCB0aGF0IHRoZSBjb21waWxlIGZ1bmN0aW9uJ3MgdGhpcyBpcyBhIHJlZmVyZW5jZSB0byB0aGUgY29tcGlsZXIuKQogKgogKiAgYGNvbXBpbGUoZWxlbWVudClgIC0gcmV0dXJucyBsaW5rZXIgLQogKiAgSW52b2tlIGEgbmV3IGluc3RhbmNlIG9mIHRoZSBjb21waWxlciB0byBjb21waWxlIGEgRE9NIGVsZW1lbnQgYW5kIHJldHVybiBhIGxpbmtlciBmdW5jdGlvbi4KICogIFlvdSBjYW4gYXBwbHkgdGhlIGxpbmtlciBmdW5jdGlvbiB0byB0aGUgb3JpZ2luYWwgZWxlbWVudCBvciBhIGNsb25lIG9mIHRoZSBvcmlnaW5hbCBlbGVtZW50LgogKiAgVGhlIGxpbmtlciBmdW5jdGlvbiByZXR1cm5zIGEgc2NvcGUuCiAqCiAqICAqIGBjb21tZW50KGNvbW1lbnRUZXh0KWAgLSByZXR1cm5zIGVsZW1lbnQgLSBDcmVhdGUgYSBjb21tZW50IGVsZW1lbnQuCiAqCiAqICAqIGBlbGVtZW50KGVsZW1lbnROYW1lKWAgLSByZXR1cm5zIGVsZW1lbnQgLSBDcmVhdGUgYW4gZWxlbWVudCBieSBuYW1lLgogKgogKiAgKiBgdGV4dCh0ZXh0KWAgLSByZXR1cm5zIGVsZW1lbnQgLSBDcmVhdGUgYSB0ZXh0IGVsZW1lbnQuCiAqCiAqICAqIGBkZXNjZW5kKFtzZXRdKWAgLSByZXR1cm5zIGRlc2NlbmQgc3RhdGUgKHRydWUgb3IgZmFsc2UpLiBHZXQgb3Igc2V0IHRoZSBjdXJyZW50IGRlc2NlbmQKICogIHN0YXRlLiBJZiB0cnVlIHRoZSBjb21waWxlciB3aWxsIGRlc2NlbmQgdG8gY2hpbGRyZW4gZWxlbWVudHMuCiAqCiAqICAqIGBkaXJlY3RpdmVzKFtzZXRdKWAgLSByZXR1cm5zIGRpcmVjdGl2ZSBzdGF0ZSAodHJ1ZSBvciBmYWxzZSkuIEdldCBvciBzZXQgdGhlIGN1cnJlbnQKICogIGRpcmVjdGl2ZXMgcHJvY2Vzc2luZyBzdGF0ZS4gVGhlIGNvbXBpbGVyIHdpbGwgcHJvY2VzcyBkaXJlY3RpdmVzIG9ubHkgd2hlbiBkaXJlY3RpdmVzIHNldCB0bwogKiAgdHJ1ZS4KICoKICogRm9yIGluZm9ybWF0aW9uIG9uIGhvdyB0aGUgY29tcGlsZXIgd29ya3MsIHNlZSB0aGUKICoge0BsaW5rIGd1aWRlL2Rldl9ndWlkZS5jb21waWxlciBBbmd1bGFyIEhUTUwgQ29tcGlsZXJ9IHNlY3Rpb24gb2YgdGhlIERldmVsb3BlciBHdWlkZS4KICovCmZ1bmN0aW9uIENvbXBpbGVyKG1hcmt1cCwgYXR0ck1hcmt1cCwgZGlyZWN0aXZlcywgd2lkZ2V0cyl7CiAgdGhpcy5tYXJrdXAgPSBtYXJrdXA7CiAgdGhpcy5hdHRyTWFya3VwID0gYXR0ck1hcmt1cDsKICB0aGlzLmRpcmVjdGl2ZXMgPSBkaXJlY3RpdmVzOwogIHRoaXMud2lkZ2V0cyA9IHdpZGdldHM7Cn0KCkNvbXBpbGVyLnByb3RvdHlwZSA9IHsKICBjb21waWxlOiBmdW5jdGlvbih0ZW1wbGF0ZUVsZW1lbnQpIHsKICAgIHRlbXBsYXRlRWxlbWVudCA9IGpxTGl0ZSh0ZW1wbGF0ZUVsZW1lbnQpOwogICAgdmFyIGluZGV4ID0gMCwKICAgICAgICB0ZW1wbGF0ZSwKICAgICAgICBwYXJlbnQgPSB0ZW1wbGF0ZUVsZW1lbnQucGFyZW50KCk7CiAgICBpZiAodGVtcGxhdGVFbGVtZW50Lmxlbmd0aCA+IDEpIHsKICAgICAgLy8gaHR0cHM6Ly9naXRodWIuY29tL2FuZ3VsYXIvYW5ndWxhci5qcy9pc3N1ZXMvMzM4CiAgICAgIHRocm93IEVycm9yKCJDYW5ub3QgY29tcGlsZSBtdWx0aXBsZSBlbGVtZW50IHJvb3RzOiAiICsKICAgICAgICAgIGpxTGl0ZSgnPGRpdj4nKS5hcHBlbmQodGVtcGxhdGVFbGVtZW50LmNsb25lKCkpLmh0bWwoKSk7CiAgICB9CiAgICBpZiAocGFyZW50ICYmIHBhcmVudFswXSkgewogICAgICBwYXJlbnQgPSBwYXJlbnRbMF07CiAgICAgIGZvcih2YXIgaSA9IDA7IGkgPCBwYXJlbnQuY2hpbGROb2Rlcy5sZW5ndGg7IGkrKykgewogICAgICAgIGlmIChwYXJlbnQuY2hpbGROb2Rlc1tpXSA9PSB0ZW1wbGF0ZUVsZW1lbnRbMF0pIHsKICAgICAgICAgIGluZGV4ID0gaTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIHRlbXBsYXRlID0gdGhpcy50ZW1wbGF0aXplKHRlbXBsYXRlRWxlbWVudCwgaW5kZXgsIDApIHx8IG5ldyBUZW1wbGF0ZSgpOwogICAgcmV0dXJuIGZ1bmN0aW9uKHNjb3BlLCBjbG9uZUNvbm5lY3RGbil7CiAgICAgIC8vIGltcG9ydGFudCEhOiB3ZSBtdXN0IGNhbGwgb3VyIGpxTGl0ZS5jbG9uZSgpIHNpbmNlIHRoZSBqUXVlcnkgb25lIGlzIHRyeWluZyB0byBiZSBzbWFydAogICAgICAvLyBhbmQgc29tZXRpbWVzIGNoYW5nZXMgdGhlIHN0cnVjdHVyZSBvZiB0aGUgRE9NLgogICAgICB2YXIgZWxlbWVudCA9IGNsb25lQ29ubmVjdEZuCiAgICAgICAgPyBKUUxpdGVQcm90b3R5cGUuY2xvbmUuY2FsbCh0ZW1wbGF0ZUVsZW1lbnQpIC8vIElNUE9SVEFOVCEhIQogICAgICAgIDogdGVtcGxhdGVFbGVtZW50OwogICAgICAgIHNjb3BlID0gc2NvcGUgfHwgY3JlYXRlU2NvcGUoKTsKICAgICAgZWxlbWVudC5kYXRhKCQkc2NvcGUsIHNjb3BlKTsKICAgICAgc2NvcGUuJGVsZW1lbnQgPSBlbGVtZW50OwogICAgICAoY2xvbmVDb25uZWN0Rm58fG5vb3ApKGVsZW1lbnQsIHNjb3BlKTsKICAgICAgdGVtcGxhdGUuYXR0YWNoKGVsZW1lbnQsIHNjb3BlKTsKICAgICAgc2NvcGUuJGV2YWwoKTsKICAgICAgcmV0dXJuIHNjb3BlOwogICAgfTsKICB9LAoKCiAgLyoqCiAgICogQHdvcmtJblByb2dyZXNzCiAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAqIEBuYW1lIGFuZ3VsYXIuZGlyZWN0aXZlLm5nOmV2YWwtb3JkZXIKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIE5vcm1hbGx5IHRoZSB2aWV3IGlzIHVwZGF0ZWQgZnJvbSB0b3AgdG8gYm90dG9tLiBUaGlzIHVzdWFsbHkgaXMKICAgKiBub3QgYSBwcm9ibGVtLCBidXQgdW5kZXIgc29tZSBjaXJjdW1zdGFuY2VzIHRoZSB2YWx1ZXMgZm9yIGRhdGEKICAgKiBpcyBub3QgYXZhaWxhYmxlIHVudGlsIGFmdGVyIHRoZSBmdWxsIHZpZXcgaXMgY29tcHV0ZWQuIElmIHN1Y2gKICAgKiB2YWx1ZXMgYXJlIG5lZWRlZCBiZWZvcmUgdGhleSBhcmUgY29tcHV0ZWQgdGhlIG9yZGVyIG9mCiAgICogZXZhbHVhdGlvbiBjYW4gYmUgY2hhbmdlZCB1c2luZyBuZzpldmFsLW9yZGVyCiAgICoKICAgKiBAZWxlbWVudCBBTlkKICAgKiBAcGFyYW0ge2ludGVnZXJ8c3RyaW5nPX0gW3ByaW9yaXR5PTBdIHByaW9yaXR5IGludGVnZXIsIG9yIEZJUlNULCBMQVNUIGNvbnN0YW50CiAgICoKICAgKiBAZXhhbXBsZQogICAqIHRyeSBjaGFuZ2luZyB0aGUgaW52b2ljZSBhbmQgc2VlIHRoYXQgdGhlIFRvdGFsIHdpbGwgbGFnIGluIGV2YWx1YXRpb24KICAgKiBAZXhhbXBsZQogICAgIDxkb2M6ZXhhbXBsZT4KICAgICAgIDxkb2M6c291cmNlPgogICAgICAgIDxkaXY+VE9UQUw6IHdpdGhvdXQgbmc6ZXZhbC1vcmRlciB7eyBpdGVtcy4kc3VtKCd0b3RhbCcpIHwgY3VycmVuY3kgfX08L2Rpdj4KICAgICAgICA8ZGl2IG5nOmV2YWwtb3JkZXI9J0xBU1QnPlRPVEFMOiB3aXRoIG5nOmV2YWwtb3JkZXIge3sgaXRlbXMuJHN1bSgndG90YWwnKSB8IGN1cnJlbmN5IH19PC9kaXY+CiAgICAgICAgPHRhYmxlIG5nOmluaXQ9Iml0ZW1zPVt7cXR5OjEsIGNvc3Q6OS45OSwgZGVzYzonZ2FkZ2V0J31dIj4KICAgICAgICAgIDx0cj4KICAgICAgICAgICAgPHRkPlFUWTwvdGQ+CiAgICAgICAgICAgIDx0ZD5EZXNjcmlwdGlvbjwvdGQ+CiAgICAgICAgICAgIDx0ZD5Db3N0PC90ZD4KICAgICAgICAgICAgPHRkPlRvdGFsPC90ZD4KICAgICAgICAgICAgPHRkPjwvdGQ+CiAgICAgICAgICA8L3RyPgogICAgICAgICAgPHRyIG5nOnJlcGVhdD0iaXRlbSBpbiBpdGVtcyI+CiAgICAgICAgICAgIDx0ZD48aW5wdXQgbmFtZT0iaXRlbS5xdHkiLz48L3RkPgogICAgICAgICAgICA8dGQ+PGlucHV0IG5hbWU9Iml0ZW0uZGVzYyIvPjwvdGQ+CiAgICAgICAgICAgIDx0ZD48aW5wdXQgbmFtZT0iaXRlbS5jb3N0Ii8+PC90ZD4KICAgICAgICAgICAgPHRkPnt7aXRlbS50b3RhbCA9IGl0ZW0ucXR5ICogaXRlbS5jb3N0IHwgY3VycmVuY3l9fTwvdGQ+CiAgICAgICAgICAgIDx0ZD48YSBocmVmPSIiIG5nOmNsaWNrPSJpdGVtcy4kcmVtb3ZlKGl0ZW0pIj5YPC9hPjwvdGQ+CiAgICAgICAgICA8L3RyPgogICAgICAgICAgPHRyPgogICAgICAgICAgICA8dGQgY29sc3Bhbj0iMyI+PGEgaHJlZj0iIiBuZzpjbGljaz0iaXRlbXMuJGFkZCgpIj5hZGQ8L2E+PC90ZD4KICAgICAgICAgICAgPHRkPnt7IGl0ZW1zLiRzdW0oJ3RvdGFsJykgfCBjdXJyZW5jeSB9fTwvdGQ+CiAgICAgICAgICA8L3RyPgogICAgICAgIDwvdGFibGU+CiAgICAgICA8L2RvYzpzb3VyY2U+CiAgICAgICA8ZG9jOnNjZW5hcmlvPgogICAgICAgICBpdCgnc2hvdWxkIGNoZWNrIG5nOmZvcm1hdCcsIGZ1bmN0aW9uKCl7CiAgICAgICAgICAgZXhwZWN0KHVzaW5nKCcuZG9jLWV4YW1wbGUtbGl2ZSBkaXY6Zmlyc3QnKS5iaW5kaW5nKCJpdGVtcy4kc3VtKCd0b3RhbCcpIikpLnRvQmUoJyQ5Ljk5Jyk7CiAgICAgICAgICAgZXhwZWN0KHVzaW5nKCcuZG9jLWV4YW1wbGUtbGl2ZSBkaXY6bGFzdCcpLmJpbmRpbmcoIml0ZW1zLiRzdW0oJ3RvdGFsJykiKSkudG9CZSgnJDkuOTknKTsKICAgICAgICAgICBpbnB1dCgnaXRlbS5xdHknKS5lbnRlcignMicpOwogICAgICAgICAgIGV4cGVjdCh1c2luZygnLmRvYy1leGFtcGxlLWxpdmUgZGl2OmZpcnN0JykuYmluZGluZygiaXRlbXMuJHN1bSgndG90YWwnKSIpKS50b0JlKCckOS45OScpOwogICAgICAgICAgIGV4cGVjdCh1c2luZygnLmRvYy1leGFtcGxlLWxpdmUgZGl2Omxhc3QnKS5iaW5kaW5nKCJpdGVtcy4kc3VtKCd0b3RhbCcpIikpLnRvQmUoJyQxOS45OCcpOwogICAgICAgICB9KTsKICAgICAgIDwvZG9jOnNjZW5hcmlvPgogICAgIDwvZG9jOmV4YW1wbGU+CiAgICovCgogIHRlbXBsYXRpemU6IGZ1bmN0aW9uKGVsZW1lbnQsIGVsZW1lbnRJbmRleCwgcHJpb3JpdHkpewogICAgdmFyIHNlbGYgPSB0aGlzLAogICAgICAgIHdpZGdldCwKICAgICAgICBmbiwKICAgICAgICBkaXJlY3RpdmVGbnMgPSBzZWxmLmRpcmVjdGl2ZXMsCiAgICAgICAgZGVzY2VuZCA9IHRydWUsCiAgICAgICAgZGlyZWN0aXZlcyA9IHRydWUsCiAgICAgICAgZWxlbWVudE5hbWUgPSBub2RlTmFtZV8oZWxlbWVudCksCiAgICAgICAgZWxlbWVudE5hbWVzcGFjZSA9IGVsZW1lbnROYW1lLmluZGV4T2YoJzonKSA+IDAgPyBsb3dlcmNhc2UoZWxlbWVudE5hbWUpLnJlcGxhY2UoJzonLCAnLScpIDogJycsCiAgICAgICAgdGVtcGxhdGUsCiAgICAgICAgc2VsZkFwaSA9IHsKICAgICAgICAgIGNvbXBpbGU6IGJpbmQoc2VsZiwgc2VsZi5jb21waWxlKSwKICAgICAgICAgIGRlc2NlbmQ6IGZ1bmN0aW9uKHZhbHVlKXsgaWYoaXNEZWZpbmVkKHZhbHVlKSkgZGVzY2VuZCA9IHZhbHVlOyByZXR1cm4gZGVzY2VuZDt9LAogICAgICAgICAgZGlyZWN0aXZlczogZnVuY3Rpb24odmFsdWUpeyBpZihpc0RlZmluZWQodmFsdWUpKSBkaXJlY3RpdmVzID0gdmFsdWU7IHJldHVybiBkaXJlY3RpdmVzO30sCiAgICAgICAgICBzY29wZTogZnVuY3Rpb24odmFsdWUpeyBpZihpc0RlZmluZWQodmFsdWUpKSB0ZW1wbGF0ZS5uZXdTY29wZSA9IHRlbXBsYXRlLm5ld1Njb3BlIHx8IHZhbHVlOyByZXR1cm4gdGVtcGxhdGUubmV3U2NvcGU7fQogICAgICAgIH07CiAgICB0cnkgewogICAgICBwcmlvcml0eSA9IGVsZW1lbnQuYXR0cignbmc6ZXZhbC1vcmRlcicpIHx8IHByaW9yaXR5IHx8IDA7CiAgICB9IGNhdGNoIChlKSB7CiAgICAgIC8vIGZvciBzb21lIHJlYXNvbiBJRSB0aHJvd3MgZXJyb3IgdW5kZXIgc29tZSB3ZWlyZCBjaXJjdW1zdGFuY2VzLiBzbyBqdXN0IGFzc3VtZSBub3RoaW5nCiAgICAgIHByaW9yaXR5ID0gcHJpb3JpdHkgfHwgMDsKICAgIH0KICAgIGVsZW1lbnQuYWRkQ2xhc3MoZWxlbWVudE5hbWVzcGFjZSk7CiAgICBpZiAoaXNTdHJpbmcocHJpb3JpdHkpKSB7CiAgICAgIHByaW9yaXR5ID0gUFJJT1JJVFlbdXBwZXJjYXNlKHByaW9yaXR5KV0gfHwgcGFyc2VJbnQocHJpb3JpdHksIDEwKTsKICAgIH0KICAgIHRlbXBsYXRlID0gbmV3IFRlbXBsYXRlKHByaW9yaXR5KTsKICAgIGVhY2hBdHRyaWJ1dGUoZWxlbWVudCwgZnVuY3Rpb24odmFsdWUsIG5hbWUpewogICAgICBpZiAoIXdpZGdldCkgewogICAgICAgIGlmICh3aWRnZXQgPSBzZWxmLndpZGdldHMoJ0AnICsgbmFtZSkpIHsKICAgICAgICAgIGVsZW1lbnQuYWRkQ2xhc3MoJ25nLWF0dHItd2lkZ2V0Jyk7CiAgICAgICAgICB3aWRnZXQgPSBiaW5kKHNlbGZBcGksIHdpZGdldCwgdmFsdWUsIGVsZW1lbnQpOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgICBpZiAoIXdpZGdldCkgewogICAgICBpZiAod2lkZ2V0ID0gc2VsZi53aWRnZXRzKGVsZW1lbnROYW1lKSkgewogICAgICAgIGlmIChlbGVtZW50TmFtZXNwYWNlKQogICAgICAgICAgZWxlbWVudC5hZGRDbGFzcygnbmctd2lkZ2V0Jyk7CiAgICAgICAgd2lkZ2V0ID0gYmluZChzZWxmQXBpLCB3aWRnZXQsIGVsZW1lbnQpOwogICAgICB9CiAgICB9CiAgICBpZiAod2lkZ2V0KSB7CiAgICAgIGRlc2NlbmQgPSBmYWxzZTsKICAgICAgZGlyZWN0aXZlcyA9IGZhbHNlOwogICAgICB2YXIgcGFyZW50ID0gZWxlbWVudC5wYXJlbnQoKTsKICAgICAgdGVtcGxhdGUuYWRkSW5pdCh3aWRnZXQuY2FsbChzZWxmQXBpLCBlbGVtZW50KSk7CiAgICAgIGlmIChwYXJlbnQgJiYgcGFyZW50WzBdKSB7CiAgICAgICAgZWxlbWVudCA9IGpxTGl0ZShwYXJlbnRbMF0uY2hpbGROb2Rlc1tlbGVtZW50SW5kZXhdKTsKICAgICAgfQogICAgfQogICAgaWYgKGRlc2NlbmQpewogICAgICAvLyBwcm9jZXNzIG1hcmt1cCBmb3IgdGV4dCBub2RlcyBvbmx5CiAgICAgIGZvcih2YXIgaT0wLCBjaGlsZD1lbGVtZW50WzBdLmNoaWxkTm9kZXM7CiAgICAgICAgICBpPGNoaWxkLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgaWYgKGlzVGV4dE5vZGUoY2hpbGRbaV0pKSB7CiAgICAgICAgICBmb3JFYWNoKHNlbGYubWFya3VwLCBmdW5jdGlvbihtYXJrdXApewogICAgICAgICAgICBpZiAoaTxjaGlsZC5sZW5ndGgpIHsKICAgICAgICAgICAgICB2YXIgdGV4dE5vZGUgPSBqcUxpdGUoY2hpbGRbaV0pOwogICAgICAgICAgICAgIG1hcmt1cC5jYWxsKHNlbGZBcGksIHRleHROb2RlLnRleHQoKSwgdGV4dE5vZGUsIGVsZW1lbnQpOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICBpZiAoZGlyZWN0aXZlcykgewogICAgICAvLyBQcm9jZXNzIGF0dHJpYnV0ZXMvZGlyZWN0aXZlcwogICAgICBlYWNoQXR0cmlidXRlKGVsZW1lbnQsIGZ1bmN0aW9uKHZhbHVlLCBuYW1lKXsKICAgICAgICBmb3JFYWNoKHNlbGYuYXR0ck1hcmt1cCwgZnVuY3Rpb24obWFya3VwKXsKICAgICAgICAgIG1hcmt1cC5jYWxsKHNlbGZBcGksIHZhbHVlLCBuYW1lLCBlbGVtZW50KTsKICAgICAgICB9KTsKICAgICAgfSk7CiAgICAgIGVhY2hBdHRyaWJ1dGUoZWxlbWVudCwgZnVuY3Rpb24odmFsdWUsIG5hbWUpewogICAgICAgIGZuID0gZGlyZWN0aXZlRm5zW25hbWVdOwogICAgICAgIGlmIChmbikgewogICAgICAgICAgZWxlbWVudC5hZGRDbGFzcygnbmctZGlyZWN0aXZlJyk7CiAgICAgICAgICB0ZW1wbGF0ZS5hZGRJbml0KChkaXJlY3RpdmVGbnNbbmFtZV0pLmNhbGwoc2VsZkFwaSwgdmFsdWUsIGVsZW1lbnQpKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQogICAgLy8gUHJvY2VzcyBub24gdGV4dCBjaGlsZCBub2RlcwogICAgaWYgKGRlc2NlbmQpIHsKICAgICAgZWFjaE5vZGUoZWxlbWVudCwgZnVuY3Rpb24oY2hpbGQsIGkpewogICAgICAgIHRlbXBsYXRlLmFkZENoaWxkKGksIHNlbGYudGVtcGxhdGl6ZShjaGlsZCwgaSwgcHJpb3JpdHkpKTsKICAgICAgfSk7CiAgICB9CiAgICByZXR1cm4gdGVtcGxhdGUuZW1wdHkoKSA/IG51bGwgOiB0ZW1wbGF0ZTsKICB9Cn07CgpmdW5jdGlvbiBlYWNoTm9kZShlbGVtZW50LCBmbil7CiAgdmFyIGksIGNobGROb2RlcyA9IGVsZW1lbnRbMF0uY2hpbGROb2RlcyB8fCBbXSwgY2hsZDsKICBmb3IgKGkgPSAwOyBpIDwgY2hsZE5vZGVzLmxlbmd0aDsgaSsrKSB7CiAgICBpZighaXNUZXh0Tm9kZShjaGxkID0gY2hsZE5vZGVzW2ldKSkgewogICAgICBmbihqcUxpdGUoY2hsZCksIGkpOwogICAgfQogIH0KfQoKZnVuY3Rpb24gZWFjaEF0dHJpYnV0ZShlbGVtZW50LCBmbil7CiAgdmFyIGksIGF0dHJzID0gZWxlbWVudFswXS5hdHRyaWJ1dGVzIHx8IFtdLCBjaGxkLCBhdHRyLCBuYW1lLCB2YWx1ZSwgYXR0clZhbHVlID0ge307CiAgZm9yIChpID0gMDsgaSA8IGF0dHJzLmxlbmd0aDsgaSsrKSB7CiAgICBhdHRyID0gYXR0cnNbaV07CiAgICBuYW1lID0gYXR0ci5uYW1lOwogICAgdmFsdWUgPSBhdHRyLnZhbHVlOwogICAgaWYgKG1zaWUgJiYgbmFtZSA9PSAnaHJlZicpIHsKICAgICAgdmFsdWUgPSBkZWNvZGVVUklDb21wb25lbnQoZWxlbWVudFswXS5nZXRBdHRyaWJ1dGUobmFtZSwgMikpOwogICAgfQogICAgYXR0clZhbHVlW25hbWVdID0gdmFsdWU7CiAgfQogIGZvckVhY2hTb3J0ZWQoYXR0clZhbHVlLCBmbik7Cn0KCid1c2Ugc3RyaWN0JzsKCmZ1bmN0aW9uIGdldHRlcihpbnN0YW5jZSwgcGF0aCwgdW5ib3VuZEZuKSB7CiAgaWYgKCFwYXRoKSByZXR1cm4gaW5zdGFuY2U7CiAgdmFyIGVsZW1lbnQgPSBwYXRoLnNwbGl0KCcuJyk7CiAgdmFyIGtleTsKICB2YXIgbGFzdEluc3RhbmNlID0gaW5zdGFuY2U7CiAgdmFyIGxlbiA9IGVsZW1lbnQubGVuZ3RoOwogIGZvciAoIHZhciBpID0gMDsgaSA8IGxlbjsgaSsrKSB7CiAgICBrZXkgPSBlbGVtZW50W2ldOwogICAgaWYgKCFrZXkubWF0Y2goL15bXCRcd11bXCRcd1xkXSokLykpCiAgICAgICAgdGhyb3cgIkV4cHJlc3Npb24gJyIgKyBwYXRoICsgIicgaXMgbm90IGEgdmFsaWQgZXhwcmVzc2lvbiBmb3IgYWNjZXNzaW5nIHZhcmlhYmxlcy4iOwogICAgaWYgKGluc3RhbmNlKSB7CiAgICAgIGxhc3RJbnN0YW5jZSA9IGluc3RhbmNlOwogICAgICBpbnN0YW5jZSA9IGluc3RhbmNlW2tleV07CiAgICB9CiAgICBpZiAoaXNVbmRlZmluZWQoaW5zdGFuY2UpICAmJiBrZXkuY2hhckF0KDApID09ICckJykgewogICAgICB2YXIgdHlwZSA9IGFuZ3VsYXJbJ0dsb2JhbCddWyd0eXBlT2YnXShsYXN0SW5zdGFuY2UpOwogICAgICB0eXBlID0gYW5ndWxhclt0eXBlLmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpK3R5cGUuc3Vic3RyaW5nKDEpXTsKICAgICAgdmFyIGZuID0gdHlwZSA/IHR5cGVbW2tleS5zdWJzdHJpbmcoMSldXSA6IHVuZGVmaW5lZDsKICAgICAgaWYgKGZuKSB7CiAgICAgICAgaW5zdGFuY2UgPSBiaW5kKGxhc3RJbnN0YW5jZSwgZm4sIGxhc3RJbnN0YW5jZSk7CiAgICAgICAgcmV0dXJuIGluc3RhbmNlOwogICAgICB9CiAgICB9CiAgfQogIGlmICghdW5ib3VuZEZuICYmIGlzRnVuY3Rpb24oaW5zdGFuY2UpKSB7CiAgICByZXR1cm4gYmluZChsYXN0SW5zdGFuY2UsIGluc3RhbmNlKTsKICB9CiAgcmV0dXJuIGluc3RhbmNlOwp9CgpmdW5jdGlvbiBzZXR0ZXIoaW5zdGFuY2UsIHBhdGgsIHZhbHVlKXsKICB2YXIgZWxlbWVudCA9IHBhdGguc3BsaXQoJy4nKTsKICBmb3IgKCB2YXIgaSA9IDA7IGVsZW1lbnQubGVuZ3RoID4gMTsgaSsrKSB7CiAgICB2YXIga2V5ID0gZWxlbWVudC5zaGlmdCgpOwogICAgdmFyIG5ld0luc3RhbmNlID0gaW5zdGFuY2Vba2V5XTsKICAgIGlmICghbmV3SW5zdGFuY2UpIHsKICAgICAgbmV3SW5zdGFuY2UgPSB7fTsKICAgICAgaW5zdGFuY2Vba2V5XSA9IG5ld0luc3RhbmNlOwogICAgfQogICAgaW5zdGFuY2UgPSBuZXdJbnN0YW5jZTsKICB9CiAgaW5zdGFuY2VbZWxlbWVudC5zaGlmdCgpXSA9IHZhbHVlOwogIHJldHVybiB2YWx1ZTsKfQoKLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KdmFyIHNjb3BlSWQgPSAwLAogICAgZ2V0dGVyRm5DYWNoZSA9IHt9LAogICAgY29tcGlsZUNhY2hlID0ge30sCiAgICBKU19LRVlXT1JEUyA9IHt9Owpmb3JFYWNoKAogICAgKCJhYnN0cmFjdCxib29sZWFuLGJyZWFrLGJ5dGUsY2FzZSxjYXRjaCxjaGFyLGNsYXNzLGNvbnN0LGNvbnRpbnVlLGRlYnVnZ2VyLGRlZmF1bHQsIiArCiAgICAiZGVsZXRlLGRvLGRvdWJsZSxlbHNlLGVudW0sZXhwb3J0LGV4dGVuZHMsZmFsc2UsZmluYWwsZmluYWxseSxmbG9hdCxmb3IsZnVuY3Rpb24sZ290bywiICsKICAgICJpZixpbXBsZW1lbnRzLGltcG9ydCxpbmluc3RhbmNlb2YsaW50aW50ZXJmYWNlLGxvbmcsbmF0aXZlLG5ldyxudWxsLHBhY2thZ2UscHJpdmF0ZSwiICsKICAgICJwcm90ZWN0ZWQscHVibGljLHJldHVybixzaG9ydCxzdGF0aWMsc3VwZXIsc3dpdGNoLHN5bmNocm9uaXplZCx0aGlzLHRocm93LHRocm93cywiICsKICAgICJ0cmFuc2llbnQsdHJ1ZSx0cnksdHlwZW9mLHZhcix2b2xhdGlsZSx2b2lkLHVuZGVmaW5lZCx3aGlsZSx3aXRoIikuc3BsaXQoLywvKSwKICBmdW5jdGlvbihrZXkpeyBKU19LRVlXT1JEU1trZXldID0gdHJ1ZTt9Cik7CmZ1bmN0aW9uIGdldHRlckZuKHBhdGgpewogIHZhciBmbiA9IGdldHRlckZuQ2FjaGVbcGF0aF07CiAgaWYgKGZuKSByZXR1cm4gZm47CgogIHZhciBjb2RlID0gJ3ZhciBsLCBmbiwgdDtcbic7CiAgZm9yRWFjaChwYXRoLnNwbGl0KCcuJyksIGZ1bmN0aW9uKGtleSkgewogICAga2V5ID0gKEpTX0tFWVdPUkRTW2tleV0pID8gJ1siJyArIGtleSArICciXScgOiAnLicgKyBrZXk7CiAgICBjb2RlICs9ICdpZighcykgcmV0dXJuIHM7XG4nICsKICAgICAgICAgICAgJ2w9cztcbicgKwogICAgICAgICAgICAncz1zJyArIGtleSArICc7XG4nICsKICAgICAgICAgICAgJ2lmKHR5cGVvZiBzPT0iZnVuY3Rpb24iICYmICEocyBpbnN0YW5jZW9mIFJlZ0V4cCkpIHMgPSBmdW5jdGlvbigpeyByZXR1cm4gbCcra2V5KycuYXBwbHkobCwgYXJndW1lbnRzKTsgfTtcbic7CiAgICBpZiAoa2V5LmNoYXJBdCgxKSA9PSAnJCcpIHsKICAgICAgLy8gc3BlY2lhbCBjb2RlIGZvciBzdXBlci1pbXBvc2VkIGZ1bmN0aW9ucwogICAgICB2YXIgbmFtZSA9IGtleS5zdWJzdHIoMik7CiAgICAgIGNvZGUgKz0gJ2lmKCFzKSB7XG4nICsKICAgICAgICAgICAgICAnICB0ID0gYW5ndWxhci5HbG9iYWwudHlwZU9mKGwpO1xuJyArCiAgICAgICAgICAgICAgJyAgZm4gPSAoYW5ndWxhclt0LmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpICsgdC5zdWJzdHJpbmcoMSldfHx7fSlbIicgKyBuYW1lICsgJyJdO1xuJyArCiAgICAgICAgICAgICAgJyAgaWYgKGZuKSBzID0gZnVuY3Rpb24oKXsgcmV0dXJuIGZuLmFwcGx5KGwsIFtsXS5jb25jYXQoQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAwLCBhcmd1bWVudHMubGVuZ3RoKSkpOyB9O1xuJyArCiAgICAgICAgICAgICAgJ31cbic7CiAgICB9CiAgfSk7CiAgY29kZSArPSAncmV0dXJuIHM7JzsKICBmbiA9IEZ1bmN0aW9uKCdzJywgY29kZSk7CiAgZm5bInRvU3RyaW5nIl0gPSBmdW5jdGlvbigpeyByZXR1cm4gY29kZTsgfTsKCiAgcmV0dXJuIGdldHRlckZuQ2FjaGVbcGF0aF0gPSBmbjsKfQoKLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KCmZ1bmN0aW9uIGV4cHJlc3Npb25Db21waWxlKGV4cCl7CiAgaWYgKHR5cGVvZiBleHAgPT09ICRmdW5jdGlvbikgcmV0dXJuIGV4cDsKICB2YXIgZm4gPSBjb21waWxlQ2FjaGVbZXhwXTsKICBpZiAoIWZuKSB7CiAgICB2YXIgcCA9IHBhcnNlcihleHApOwogICAgdmFyIGZuU2VsZiA9IHAuc3RhdGVtZW50cygpOwogICAgZm4gPSBjb21waWxlQ2FjaGVbZXhwXSA9IGV4dGVuZCgKICAgICAgZnVuY3Rpb24oKXsgcmV0dXJuIGZuU2VsZih0aGlzKTt9LAogICAgICB7Zm5TZWxmOiBmblNlbGZ9KTsKICB9CiAgcmV0dXJuIGZuOwp9CgpmdW5jdGlvbiBlcnJvckhhbmRsZXJGb3IoZWxlbWVudCwgZXJyb3IpIHsKICBlbGVtZW50RXJyb3IoZWxlbWVudCwgTkdfRVhDRVBUSU9OLCBpc0RlZmluZWQoZXJyb3IpID8gZm9ybWF0RXJyb3IoZXJyb3IpIDogZXJyb3IpOwp9CgoKLyoqCiAqIEB3b3JrSW5Qcm9ncmVzcwogKiBAbmdkb2Mgb3ZlcnZpZXcKICogQG5hbWUgYW5ndWxhci5zY29wZQogKgogKiBAZGVzY3JpcHRpb24KICogU2NvcGUgaXMgYSBKYXZhU2NyaXB0IG9iamVjdCBhbmQgdGhlIGV4ZWN1dGlvbiBjb250ZXh0IGZvciBleHByZXNzaW9ucy4gWW91IGNhbiB0aGluayBhYm91dAogKiBzY29wZXMgYXMgSmF2YVNjcmlwdCBvYmplY3RzIHRoYXQgaGF2ZSBleHRyYSBBUElzIGZvciByZWdpc3RlcmluZyB3YXRjaGVycy4gQSBzY29wZSBpcyB0aGUKICogY29udGV4dCBpbiB3aGljaCBtb2RlbCAoZnJvbSB0aGUgbW9kZWwtdmlldy1jb250cm9sbGVyIGRlc2lnbiBwYXR0ZXJuKSBleGlzdHMuCiAqCiAqIEFuZ3VsYXIgc2NvcGUgb2JqZWN0cyBwcm92aWRlIHRoZSBmb2xsb3dpbmcgbWV0aG9kczoKICoKICogKiB7QGxpbmsgYW5ndWxhci5zY29wZS4kYmVjb21lICRiZWNvbWUoKX0gLQogKiAqIHtAbGluayBhbmd1bGFyLnNjb3BlLiRiaW5kICRiaW5kKCl9IC0KICogKiB7QGxpbmsgYW5ndWxhci5zY29wZS4kZXZhbCAkZXZhbCgpfSAtCiAqICoge0BsaW5rIGFuZ3VsYXIuc2NvcGUuJGdldCAkZ2V0KCl9IC0KICogKiB7QGxpbmsgYW5ndWxhci5zY29wZS4kbmV3ICRuZXcoKX0gLQogKiAqIHtAbGluayBhbmd1bGFyLnNjb3BlLiRvbkV2YWwgJG9uRXZhbCgpfSAtCiAqICoge0BsaW5rIGFuZ3VsYXIuc2NvcGUuJHNlcnZpY2UgJHNlcnZpY2UoKX0gLQogKiAqIHtAbGluayBhbmd1bGFyLnNjb3BlLiRzZXQgJHNldCgpfSAtCiAqICoge0BsaW5rIGFuZ3VsYXIuc2NvcGUuJHRyeUV2YWwgJHRyeUV2YWwoKX0gLQogKiAqIHtAbGluayBhbmd1bGFyLnNjb3BlLiR3YXRjaCAkd2F0Y2goKX0gLQogKgogKiBGb3IgbW9yZSBpbmZvcm1hdGlvbiBhYm91dCBob3cgYW5ndWxhciBzY29wZSBvYmplY3RzIHdvcmssIHNlZSB7QGxpbmsgZ3VpZGUvZGV2X2d1aWRlLnNjb3BlcwogKiBBbmd1bGFyIFNjb3BlIE9iamVjdHN9IGluIHRoZSBhbmd1bGFyIERldmVsb3BlciBHdWlkZS4KICovCmZ1bmN0aW9uIGNyZWF0ZVNjb3BlKHBhcmVudCwgcHJvdmlkZXJzLCBpbnN0YW5jZUNhY2hlKSB7CiAgZnVuY3Rpb24gUGFyZW50KCl7fQogIHBhcmVudCA9IFBhcmVudC5wcm90b3R5cGUgPSAocGFyZW50IHx8IHt9KTsKICB2YXIgaW5zdGFuY2UgPSBuZXcgUGFyZW50KCk7CiAgdmFyIGV2YWxMaXN0cyA9IHtzb3J0ZWQ6W119OwogIHZhciAkbG9nLCAkZXhjZXB0aW9uSGFuZGxlcjsKCiAgZXh0ZW5kKGluc3RhbmNlLCB7CiAgICAndGhpcyc6IGluc3RhbmNlLAogICAgJGlkOiAoc2NvcGVJZCsrKSwKICAgICRwYXJlbnQ6IHBhcmVudCwKCiAgICAvKioKICAgICAqIEB3b3JrSW5Qcm9ncmVzcwogICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgKiBAbmFtZSBhbmd1bGFyLnNjb3BlLiRiaW5kCiAgICAgKiBAZnVuY3Rpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIEJpbmRzIGEgZnVuY3Rpb24gYGZuYCB0byB0aGUgY3VycmVudCBzY29wZS4gU2VlOiB7QGxpbmsgYW5ndWxhci5iaW5kfS4KCiAgICAgICA8cHJlPgogICAgICAgICB2YXIgc2NvcGUgPSBhbmd1bGFyLnNjb3BlKCk7CiAgICAgICAgIHZhciBmbiA9IHNjb3BlLiRiaW5kKGZ1bmN0aW9uKCl7CiAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgIH0pOwogICAgICAgICBleHBlY3QoZm4oKSkudG9FcXVhbChzY29wZSk7CiAgICAgICA8L3ByZT4KICAgICAqCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKCl9IGZuIEZ1bmN0aW9uIHRvIGJlIGJvdW5kLgogICAgICovCiAgICAkYmluZDogYmluZChpbnN0YW5jZSwgYmluZCwgaW5zdGFuY2UpLAoKCiAgICAvKioKICAgICAqIEB3b3JrSW5Qcm9ncmVzcwogICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgKiBAbmFtZSBhbmd1bGFyLnNjb3BlLiRnZXQKICAgICAqIEBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogUmV0dXJucyB0aGUgdmFsdWUgZm9yIGBwcm9wZXJ0eV9jaGFpbmAgb24gdGhlIGN1cnJlbnQgc2NvcGUuIFVubGlrZSBpbiBKYXZhU2NyaXB0LCBpZiB0aGVyZQogICAgICogYXJlIGFueSBgdW5kZWZpbmVkYCBpbnRlcm1lZGlhcnkgcHJvcGVydGllcywgYHVuZGVmaW5lZGAgaXMgcmV0dXJuZWQgaW5zdGVhZCBvZiB0aHJvd2luZyBhbgogICAgICogZXhjZXB0aW9uLgogICAgICoKICAgICAgIDxwcmU+CiAgICAgICAgIHZhciBzY29wZSA9IGFuZ3VsYXIuc2NvcGUoKTsKICAgICAgICAgZXhwZWN0KHNjb3BlLiRnZXQoJ3BlcnNvbi5uYW1lJykpLnRvRXF1YWwodW5kZWZpbmVkKTsKICAgICAgICAgc2NvcGUucGVyc29uID0ge307CiAgICAgICAgIGV4cGVjdChzY29wZS4kZ2V0KCdwZXJzb24ubmFtZScpKS50b0VxdWFsKHVuZGVmaW5lZCk7CiAgICAgICAgIHNjb3BlLnBlcnNvbi5uYW1lID0gJ21pc2tvJzsKICAgICAgICAgZXhwZWN0KHNjb3BlLiRnZXQoJ3BlcnNvbi5uYW1lJykpLnRvRXF1YWwoJ21pc2tvJyk7CiAgICAgICA8L3ByZT4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gcHJvcGVydHlfY2hhaW4gU3RyaW5nIHJlcHJlc2VudGluZyBuYW1lIG9mIGEgc2NvcGUgcHJvcGVydHkuIE9wdGlvbmFsbHkKICAgICAqICAgICBwcm9wZXJ0aWVzIGNhbiBiZSBjaGFpbmVkIHdpdGggYC5gIChkb3QpLCBlLmcuIGAncGVyc29uLm5hbWUuZmlyc3QnYAogICAgICogQHJldHVybnMgeyp9IFZhbHVlIGZvciB0aGUgKG5lc3RlZCkgcHJvcGVydHkuCiAgICAgKi8KICAgICRnZXQ6IGJpbmQoaW5zdGFuY2UsIGdldHRlciwgaW5zdGFuY2UpLAoKCiAgICAvKioKICAgICAqIEB3b3JrSW5Qcm9ncmVzcwogICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgKiBAbmFtZSBhbmd1bGFyLnNjb3BlLiRzZXQKICAgICAqIEBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogQXNzaWducyBhIHZhbHVlIHRvIGEgcHJvcGVydHkgb2YgdGhlIGN1cnJlbnQgc2NvcGUgc3BlY2lmaWVkIHZpYSBgcHJvcGVydHlfY2hhaW5gLiBVbmxpa2UgaW4KICAgICAqIEphdmFTY3JpcHQsIGlmIHRoZXJlIGFyZSBhbnkgYHVuZGVmaW5lZGAgaW50ZXJtZWRpYXJ5IHByb3BlcnRpZXMsIGVtcHR5IG9iamVjdHMgYXJlIGNyZWF0ZWQKICAgICAqIGFuZCBhc3NpZ25lZCB0byB0aGVtIGluc3RlYWQgb2YgdGhyb3dpbmcgYW4gZXhjZXB0aW9uLgogICAgICoKICAgICAgIDxwcmU+CiAgICAgICAgIHZhciBzY29wZSA9IGFuZ3VsYXIuc2NvcGUoKTsKICAgICAgICAgZXhwZWN0KHNjb3BlLnBlcnNvbikudG9FcXVhbCh1bmRlZmluZWQpOwogICAgICAgICBzY29wZS4kc2V0KCdwZXJzb24ubmFtZScsICdtaXNrbycpOwogICAgICAgICBleHBlY3Qoc2NvcGUucGVyc29uKS50b0VxdWFsKHtuYW1lOidtaXNrbyd9KTsKICAgICAgICAgZXhwZWN0KHNjb3BlLnBlcnNvbi5uYW1lKS50b0VxdWFsKCdtaXNrbycpOwogICAgICAgPC9wcmU+CiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IHByb3BlcnR5X2NoYWluIFN0cmluZyByZXByZXNlbnRpbmcgbmFtZSBvZiBhIHNjb3BlIHByb3BlcnR5LiBPcHRpb25hbGx5CiAgICAgKiAgICAgcHJvcGVydGllcyBjYW4gYmUgY2hhaW5lZCB3aXRoIGAuYCAoZG90KSwgZS5nLiBgJ3BlcnNvbi5uYW1lLmZpcnN0J2AKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVmFsdWUgdG8gYXNzaWduIHRvIHRoZSBzY29wZSBwcm9wZXJ0eS4KICAgICAqLwogICAgJHNldDogYmluZChpbnN0YW5jZSwgc2V0dGVyLCBpbnN0YW5jZSksCgoKICAgIC8qKgogICAgICogQHdvcmtJblByb2dyZXNzCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIGFuZ3VsYXIuc2NvcGUuJGV2YWwKICAgICAqIEBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogV2l0aG91dCB0aGUgYGV4cGAgcGFyYW1ldGVyIHRyaWdnZXJzIGFuIGV2YWwgY3ljbGUgZm9yIHRoaXMgc2NvcGUgYW5kIGl0cyBjaGlsZCBzY29wZXMuCiAgICAgKgogICAgICogV2l0aCB0aGUgYGV4cGAgcGFyYW1ldGVyLCBjb21waWxlcyB0aGUgZXhwcmVzc2lvbiB0byBhIGZ1bmN0aW9uIGFuZCBjYWxscyBpdCB3aXRoIGB0aGlzYCBzZXQKICAgICAqIHRvIHRoZSBjdXJyZW50IHNjb3BlIGFuZCByZXR1cm5zIHRoZSByZXN1bHQuIEluIG90aGVyIHdvcmRzLCBldmFsdWF0ZXMgYGV4cGAgYXMgYW5ndWxhcgogICAgICogZXhwcmVzc2lvbiBpbiB0aGUgY29udGV4dCBvZiB0aGUgY3VycmVudCBzY29wZS4KICAgICAqCiAgICAgKiAjIEV4YW1wbGUKICAgICAgIDxwcmU+CiAgICAgICAgIHZhciBzY29wZSA9IGFuZ3VsYXIuc2NvcGUoKTsKICAgICAgICAgc2NvcGUuYSA9IDE7CiAgICAgICAgIHNjb3BlLmIgPSAyOwoKICAgICAgICAgZXhwZWN0KHNjb3BlLiRldmFsKCdhK2InKSkudG9FcXVhbCgzKTsKICAgICAgICAgZXhwZWN0KHNjb3BlLiRldmFsKGZ1bmN0aW9uKCl7IHJldHVybiB0aGlzLmEgKyB0aGlzLmI7IH0pKS50b0VxdWFsKDMpOwoKICAgICAgICAgc2NvcGUuJG9uRXZhbCgnc3VtID0gYStiJyk7CiAgICAgICAgIGV4cGVjdChzY29wZS5zdW0pLnRvRXF1YWwodW5kZWZpbmVkKTsKICAgICAgICAgc2NvcGUuJGV2YWwoKTsKICAgICAgICAgZXhwZWN0KHNjb3BlLnN1bSkudG9FcXVhbCgzKTsKICAgICAgIDwvcHJlPgogICAgICoKICAgICAqIEBwYXJhbSB7KHN0cmluZ3xmdW5jdGlvbigpKT19IGV4cCBBbiBhbmd1bGFyIGV4cHJlc3Npb24gdG8gYmUgY29tcGlsZWQgdG8gYSBmdW5jdGlvbiBvciBhIGpzCiAgICAgKiAgICAgZnVuY3Rpb24uCiAgICAgKgogICAgICogQHJldHVybnMgeyp9IFRoZSByZXN1bHQgb2YgY2FsbGluZyBjb21waWxlZCBgZXhwYCB3aXRoIGB0aGlzYCBzZXQgdG8gdGhlIGN1cnJlbnQgc2NvcGUuCiAgICAgKi8KICAgICRldmFsOiBmdW5jdGlvbihleHApIHsKICAgICAgdmFyIHR5cGUgPSB0eXBlb2YgZXhwOwogICAgICB2YXIgaSwgaVNpemU7CiAgICAgIHZhciBqLCBqU2l6ZTsKICAgICAgdmFyIHF1ZXVlOwogICAgICB2YXIgZm47CiAgICAgIGlmICh0eXBlID09ICR1bmRlZmluZWQpIHsKICAgICAgICBmb3IgKCBpID0gMCwgaVNpemUgPSBldmFsTGlzdHMuc29ydGVkLmxlbmd0aDsgaSA8IGlTaXplOyBpKyspIHsKICAgICAgICAgIGZvciAoIHF1ZXVlID0gZXZhbExpc3RzLnNvcnRlZFtpXSwKICAgICAgICAgICAgICBqU2l6ZSA9IHF1ZXVlLmxlbmd0aCwKICAgICAgICAgICAgICBqPSAwOyBqIDwgalNpemU7IGorKykgewogICAgICAgICAgICBpbnN0YW5jZS4kdHJ5RXZhbChxdWV1ZVtqXS5mbiwgcXVldWVbal0uaGFuZGxlcik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICRmdW5jdGlvbikgewogICAgICAgIHJldHVybiBleHAuY2FsbChpbnN0YW5jZSk7CiAgICAgIH0gZWxzZSAgaWYgKHR5cGUgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgcmV0dXJuIGV4cHJlc3Npb25Db21waWxlKGV4cCkuY2FsbChpbnN0YW5jZSk7CiAgICAgIH0KICAgIH0sCgoKICAgIC8qKgogICAgICogQHdvcmtJblByb2dyZXNzCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIGFuZ3VsYXIuc2NvcGUuJHRyeUV2YWwKICAgICAqIEBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogRXZhbHVhdGVzIHRoZSBleHByZXNzaW9uIGluIHRoZSBjb250ZXh0IG9mIHRoZSBjdXJyZW50IHNjb3BlIGp1c3QgbGlrZQogICAgICoge0BsaW5rIGFuZ3VsYXIuc2NvcGUuJGV2YWx9IHdpdGggZXhwcmVzc2lvbiBwYXJhbWV0ZXIsIGJ1dCBhbHNvIHdyYXBzIGl0IGluIGEgdHJ5L2NhdGNoCiAgICAgKiBibG9jay4KICAgICAqCiAgICAgKiBJZiBhbiBleGNlcHRpb24gaXMgdGhyb3duIHRoZW4gYGV4Y2VwdGlvbkhhbmRsZXJgIGlzIHVzZWQgdG8gaGFuZGxlIHRoZSBleGNlcHRpb24uCiAgICAgKgogICAgICogIyBFeGFtcGxlCiAgICAgICA8cHJlPgogICAgICAgICB2YXIgc2NvcGUgPSBhbmd1bGFyLnNjb3BlKCk7CiAgICAgICAgIHNjb3BlLmVycm9yID0gZnVuY3Rpb24oKXsgdGhyb3cgJ215ZXJyb3InOyB9OwogICAgICAgICBzY29wZS4kZXhjZXB0aW9uSGFuZGxlciA9IGZ1bmN0aW9uKGUpIHt0aGlzLmxhc3RFeGNlcHRpb24gPSBlOyB9OwoKICAgICAgICAgZXhwZWN0KHNjb3BlLiRldmFsKCdlcnJvcigpJykpOwogICAgICAgICBleHBlY3Qoc2NvcGUubGFzdEV4Y2VwdGlvbikudG9FcXVhbCgnbXllcnJvcicpOwogICAgICAgICB0aGlzLmxhc3RFeGNlcHRpb24gPSBudWxsOwoKICAgICAgICAgZXhwZWN0KHNjb3BlLiRldmFsKCdlcnJvcigpJyksICBmdW5jdGlvbihlKSB7dGhpcy5sYXN0RXhjZXB0aW9uID0gZTsgfSk7CiAgICAgICAgIGV4cGVjdChzY29wZS5sYXN0RXhjZXB0aW9uKS50b0VxdWFsKCdteWVycm9yJyk7CgogICAgICAgICB2YXIgYm9keSA9IGFuZ3VsYXIuZWxlbWVudCh3aW5kb3cuZG9jdW1lbnQuYm9keSk7CiAgICAgICAgIGV4cGVjdChzY29wZS4kZXZhbCgnZXJyb3IoKScpLCBib2R5KTsKICAgICAgICAgZXhwZWN0KGJvZHkuYXR0cignbmctZXhjZXB0aW9uJykpLnRvRXF1YWwoJyJteWVycm9yIicpOwogICAgICAgICBleHBlY3QoYm9keS5oYXNDbGFzcygnbmctZXhjZXB0aW9uJykpLnRvRXF1YWwodHJ1ZSk7CiAgICAgICA8L3ByZT4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ3xmdW5jdGlvbigpfSBleHByZXNzaW9uIEFuZ3VsYXIgZXhwcmVzc2lvbiB0byBldmFsdWF0ZS4KICAgICAqIEBwYXJhbSB7KGZ1bmN0aW9uKCl8RE9NRWxlbWVudCk9fSBleGNlcHRpb25IYW5kbGVyIEZ1bmN0aW9uIHRvIGJlIGNhbGxlZCBvciBET01FbGVtZW50IHRvIGJlCiAgICAgKiAgICAgZGVjb3JhdGVkLgogICAgICogQHJldHVybnMgeyp9IFRoZSByZXN1bHQgb2YgYGV4cHJlc3Npb25gIGV2YWx1YXRpb24uCiAgICAgKi8KICAgICR0cnlFdmFsOiBmdW5jdGlvbiAoZXhwcmVzc2lvbiwgZXhjZXB0aW9uSGFuZGxlcikgewogICAgICB2YXIgdHlwZSA9IHR5cGVvZiBleHByZXNzaW9uOwogICAgICB0cnkgewogICAgICAgIGlmICh0eXBlID09ICRmdW5jdGlvbikgewogICAgICAgICAgcmV0dXJuIGV4cHJlc3Npb24uY2FsbChpbnN0YW5jZSk7CiAgICAgICAgfSBlbHNlIGlmICh0eXBlID09ICdzdHJpbmcnKXsKICAgICAgICAgIHJldHVybiBleHByZXNzaW9uQ29tcGlsZShleHByZXNzaW9uKS5jYWxsKGluc3RhbmNlKTsKICAgICAgICB9CiAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICBpZiAoJGxvZykgJGxvZy5lcnJvcihlKTsKICAgICAgICBpZiAoaXNGdW5jdGlvbihleGNlcHRpb25IYW5kbGVyKSkgewogICAgICAgICAgZXhjZXB0aW9uSGFuZGxlcihlKTsKICAgICAgICB9IGVsc2UgaWYgKGV4Y2VwdGlvbkhhbmRsZXIpIHsKICAgICAgICAgIGVycm9ySGFuZGxlckZvcihleGNlcHRpb25IYW5kbGVyLCBlKTsKICAgICAgICB9IGVsc2UgaWYgKGlzRnVuY3Rpb24oJGV4Y2VwdGlvbkhhbmRsZXIpKSB7CiAgICAgICAgICAkZXhjZXB0aW9uSGFuZGxlcihlKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCgoKICAgIC8qKgogICAgICogQHdvcmtJblByb2dyZXNzCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIGFuZ3VsYXIuc2NvcGUuJHdhdGNoCiAgICAgKiBAZnVuY3Rpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFJlZ2lzdGVycyBgbGlzdGVuZXJgIGFzIGEgY2FsbGJhY2sgdG8gYmUgZXhlY3V0ZWQgZXZlcnkgdGltZSB0aGUgYHdhdGNoRXhwYCBjaGFuZ2VzLiBCZSBhd2FyZQogICAgICogdGhhdCB0aGUgY2FsbGJhY2sgZ2V0cywgYnkgZGVmYXVsdCwgY2FsbGVkIHVwb24gcmVnaXN0cmF0aW9uLCB0aGlzIGNhbiBiZSBwcmV2ZW50ZWQgdmlhIHRoZQogICAgICogYGluaXRSdW5gIHBhcmFtZXRlci4KICAgICAqCiAgICAgKiAjIEV4YW1wbGUKICAgICAgIDxwcmU+CiAgICAgICAgIHZhciBzY29wZSA9IGFuZ3VsYXIuc2NvcGUoKTsKICAgICAgICAgc2NvcGUubmFtZSA9ICdtaXNrbyc7CiAgICAgICAgIHNjb3BlLmNvdW50ZXIgPSAwOwoKICAgICAgICAgZXhwZWN0KHNjb3BlLmNvdW50ZXIpLnRvRXF1YWwoMCk7CiAgICAgICAgIHNjb3BlLiR3YXRjaCgnbmFtZScsICdjb3VudGVyID0gY291bnRlciArIDEnKTsKICAgICAgICAgZXhwZWN0KHNjb3BlLmNvdW50ZXIpLnRvRXF1YWwoMSk7CgogICAgICAgICBzY29wZS4kZXZhbCgpOwogICAgICAgICBleHBlY3Qoc2NvcGUuY291bnRlcikudG9FcXVhbCgxKTsKCiAgICAgICAgIHNjb3BlLm5hbWUgPSAnYWRhbSc7CiAgICAgICAgIHNjb3BlLiRldmFsKCk7CiAgICAgICAgIGV4cGVjdChzY29wZS5jb3VudGVyKS50b0VxdWFsKDIpOwogICAgICAgPC9wcmU+CiAgICAgKgogICAgICogQHBhcmFtIHtmdW5jdGlvbigpfHN0cmluZ30gd2F0Y2hFeHAgRXhwcmVzc2lvbiB0aGF0IHNob3VsZCBiZSBldmFsdWF0ZWQgYW5kIGNoZWNrZWQgZm9yCiAgICAgKiAgICBjaGFuZ2UgZHVyaW5nIGVhY2ggZXZhbCBjeWNsZS4gQ2FuIGJlIGFuIGFuZ3VsYXIgc3RyaW5nIGV4cHJlc3Npb24gb3IgYSBmdW5jdGlvbi4KICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oKXxzdHJpbmd9IGxpc3RlbmVyIEZ1bmN0aW9uIChvciBhbmd1bGFyIHN0cmluZyBleHByZXNzaW9uKSB0aGF0IGdldHMgY2FsbGVkCiAgICAgKiAgICBldmVyeSB0aW1lIHRoZSB2YWx1ZSBvZiB0aGUgYHdhdGNoRXhwYCBjaGFuZ2VzLiBUaGUgZnVuY3Rpb24gd2lsbCBiZSBjYWxsZWQgd2l0aCB0d28KICAgICAqICAgIHBhcmFtZXRlcnMsIGBuZXdWYWx1ZWAgYW5kIGBvbGRWYWx1ZWAuCiAgICAgKiBAcGFyYW0geyhmdW5jdGlvbigpfERPTUVsZW1lbnQpPX0gW2V4Y2VwdGlvbkhhbmxkZXI9YW5ndWxhci5zZXJ2aWNlLiRleGNlcHRpb25IYW5kbGVyXSBIYW5kbGVyCiAgICAgKiAgICB0aGF0IGdldHMgY2FsbGVkIHdoZW4gYHdhdGNoRXhwYCBvciBgbGlzdGVuZXJgIHRocm93cyBhbiBleGNlcHRpb24uIElmIGEgRE9NRWxlbWVudCBpcwogICAgICogICAgc3BlY2lmaWVkIGFzIGEgaGFuZGxlciwgdGhlIGVsZW1lbnQgZ2V0cyBkZWNvcmF0ZWQgYnkgYW5ndWxhciB3aXRoIHRoZSBpbmZvcm1hdGlvbiBhYm91dCB0aGUKICAgICAqICAgIGV4Y2VwdGlvbi4KICAgICAqIEBwYXJhbSB7Ym9vbGVhbj19IFtpbml0UnVuPXRydWVdIEZsYWcgdGhhdCBwcmV2ZW50cyB0aGUgZmlyc3QgZXhlY3V0aW9uIG9mIHRoZSBsaXN0ZW5lciB1cG9uCiAgICAgKiAgICByZWdpc3RyYXRpb24uCiAgICAgKgogICAgICovCiAgICAkd2F0Y2g6IGZ1bmN0aW9uKHdhdGNoRXhwLCBsaXN0ZW5lciwgZXhjZXB0aW9uSGFuZGxlciwgaW5pdFJ1bikgewogICAgICB2YXIgd2F0Y2ggPSBleHByZXNzaW9uQ29tcGlsZSh3YXRjaEV4cCksCiAgICAgICAgICBsYXN0ID0gd2F0Y2guY2FsbChpbnN0YW5jZSk7CiAgICAgIGxpc3RlbmVyID0gZXhwcmVzc2lvbkNvbXBpbGUobGlzdGVuZXIpOwogICAgICBmdW5jdGlvbiB3YXRjaGVyKGZpcnN0UnVuKXsKICAgICAgICB2YXIgdmFsdWUgPSB3YXRjaC5jYWxsKGluc3RhbmNlKSwKICAgICAgICAgICAgLy8gd2UgaGF2ZSB0byBzYXZlIHRoZSB2YWx1ZSBiZWNhdXNlIGxpc3RlbmVyIGNhbiBjYWxsIG91cnNlbHZlcyA9PiBpbmYgbG9vcAogICAgICAgICAgICBsYXN0VmFsdWUgPSBsYXN0OwogICAgICAgIGlmIChmaXJzdFJ1biB8fCBsYXN0VmFsdWUgIT09IHZhbHVlKSB7CiAgICAgICAgICBsYXN0ID0gdmFsdWU7CiAgICAgICAgICBpbnN0YW5jZS4kdHJ5RXZhbChmdW5jdGlvbigpewogICAgICAgICAgICByZXR1cm4gbGlzdGVuZXIuY2FsbChpbnN0YW5jZSwgdmFsdWUsIGxhc3RWYWx1ZSk7CiAgICAgICAgICB9LCBleGNlcHRpb25IYW5kbGVyKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgaW5zdGFuY2UuJG9uRXZhbChQUklPUklUWV9XQVRDSCwgd2F0Y2hlcik7CiAgICAgIGlmIChpc1VuZGVmaW5lZChpbml0UnVuKSkgaW5pdFJ1biA9IHRydWU7CiAgICAgIGlmIChpbml0UnVuKSB3YXRjaGVyKHRydWUpOwogICAgfSwKCiAgICAvKioKICAgICAqIEB3b3JrSW5Qcm9ncmVzcwogICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgKiBAbmFtZSBhbmd1bGFyLnNjb3BlLiRvbkV2YWwKICAgICAqIEBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogRXZhbHVhdGVzIHRoZSBgZXhwcmAgZXhwcmVzc2lvbiBpbiB0aGUgY29udGV4dCBvZiB0aGUgY3VycmVudCBzY29wZSBkdXJpbmcgZWFjaAogICAgICoge0BsaW5rIGFuZ3VsYXIuc2NvcGUuJGV2YWwgZXZhbCBjeWNsZX0uCiAgICAgKgogICAgICogIyBFeGFtcGxlCiAgICAgICA8cHJlPgogICAgICAgICB2YXIgc2NvcGUgPSBhbmd1bGFyLnNjb3BlKCk7CiAgICAgICAgIHNjb3BlLmNvdW50ZXIgPSAwOwogICAgICAgICBzY29wZS4kb25FdmFsKCdjb3VudGVyID0gY291bnRlciArIDEnKTsKICAgICAgICAgZXhwZWN0KHNjb3BlLmNvdW50ZXIpLnRvRXF1YWwoMCk7CiAgICAgICAgIHNjb3BlLiRldmFsKCk7CiAgICAgICAgIGV4cGVjdChzY29wZS5jb3VudGVyKS50b0VxdWFsKDEpOwogICAgICAgPC9wcmU+CiAgICAgKgogICAgICogQHBhcmFtIHtudW1iZXJ9IFtwcmlvcml0eT0wXSBFeGVjdXRpb24gcHJpb3JpdHkuIExvd2VyIHByaW9yaXR5IG51bWJlcnMgZ2V0IGV4ZWN1dGVkIGZpcnN0LgogICAgICogQHBhcmFtIHtzdHJpbmd8ZnVuY3Rpb24oKX0gZXhwciBBbmd1bGFyIGV4cHJlc3Npb24gb3IgZnVuY3Rpb24gdG8gYmUgZXhlY3V0ZWQuCiAgICAgKiBAcGFyYW0geyhmdW5jdGlvbigpfERPTUVsZW1lbnQpPX0gW2V4Y2VwdGlvbkhhbmRsZXI9YW5ndWxhci5zZXJ2aWNlLiRleGNlcHRpb25IYW5kbGVyXSBIYW5kbGVyCiAgICAgKiAgICAgZnVuY3Rpb24gdG8gY2FsbCBvciBET00gZWxlbWVudCB0byBkZWNvcmF0ZSB3aGVuIGFuIGV4Y2VwdGlvbiBvY2N1cnMuCiAgICAgKgogICAgICovCiAgICAkb25FdmFsOiBmdW5jdGlvbihwcmlvcml0eSwgZXhwciwgZXhjZXB0aW9uSGFuZGxlcil7CiAgICAgIGlmICghaXNOdW1iZXIocHJpb3JpdHkpKSB7CiAgICAgICAgZXhjZXB0aW9uSGFuZGxlciA9IGV4cHI7CiAgICAgICAgZXhwciA9IHByaW9yaXR5OwogICAgICAgIHByaW9yaXR5ID0gMDsKICAgICAgfQogICAgICB2YXIgZXZhbExpc3QgPSBldmFsTGlzdHNbcHJpb3JpdHldOwogICAgICBpZiAoIWV2YWxMaXN0KSB7CiAgICAgICAgZXZhbExpc3QgPSBldmFsTGlzdHNbcHJpb3JpdHldID0gW107CiAgICAgICAgZXZhbExpc3QucHJpb3JpdHkgPSBwcmlvcml0eTsKICAgICAgICBldmFsTGlzdHMuc29ydGVkLnB1c2goZXZhbExpc3QpOwogICAgICAgIGV2YWxMaXN0cy5zb3J0ZWQuc29ydChmdW5jdGlvbihhLGIpe3JldHVybiBhLnByaW9yaXR5LWIucHJpb3JpdHk7fSk7CiAgICAgIH0KICAgICAgZXZhbExpc3QucHVzaCh7CiAgICAgICAgZm46IGV4cHJlc3Npb25Db21waWxlKGV4cHIpLAogICAgICAgIGhhbmRsZXI6IGV4Y2VwdGlvbkhhbmRsZXIKICAgICAgfSk7CiAgICB9LAoKICAgIC8qKgogICAgICogQHdvcmtJblByb2dyZXNzCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIGFuZ3VsYXIuc2NvcGUuJGJlY29tZQogICAgICogQGZ1bmN0aW9uCiAgICAgKiBAZGVwcmVjYXRlZCBUaGlzIG1ldGhvZCB3aWxsIGJlIHJlbW92ZWQgYmVmb3JlIDEuMAogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogTW9kaWZpZXMgdGhlIHNjb3BlIHRvIGFjdCBsaWtlIGFuIGluc3RhbmNlIG9mIHRoZSBnaXZlbiBjbGFzcyBieToKICAgICAqCiAgICAgKiAtIGNvcHlpbmcgdGhlIGNsYXNzJ3MgcHJvdG90eXBlIG1ldGhvZHMKICAgICAqIC0gYXBwbHlpbmcgdGhlIGNsYXNzJ3MgaW5pdGlhbGl6YXRpb24gZnVuY3Rpb24gdG8gdGhlIHNjb3BlIGluc3RhbmNlICh3aXRob3V0IHVzaW5nIHRoZSBuZXcKICAgICAqICAgb3BlcmF0b3IpCiAgICAgKgogICAgICogVGhhdCBtYWtlcyB0aGUgc2NvcGUgYmUgYSBgdGhpc2AgZm9yIHRoZSBnaXZlbiBjbGFzcydzIG1ldGhvZHMg4oCUIGVmZmVjdGl2ZWx5IGFuIGluc3RhbmNlIG9mCiAgICAgKiB0aGUgZ2l2ZW4gY2xhc3Mgd2l0aCBhZGRpdGlvbmFsIChzY29wZSkgc3R1ZmYuIEEgc2NvcGUgY2FuIGxhdGVyIGAkYmVjb21lYCBhbm90aGVyIGNsYXNzLgogICAgICoKICAgICAqIGAkYmVjb21lYCBnZXRzIHVzZWQgdG8gbWFrZSB0aGUgY3VycmVudCBzY29wZSBhY3QgbGlrZSBhbiBpbnN0YW5jZSBvZiBhIGNvbnRyb2xsZXIgY2xhc3MuCiAgICAgKiBUaGlzIGFsbG93cyBmb3IgdXNlIG9mIGEgY29udHJvbGxlciBjbGFzcyBpbiB0d28gd2F5cy4KICAgICAqCiAgICAgKiAtIGFzIGFuIG9yZGluYXJ5IEphdmFTY3JpcHQgY2xhc3MgZm9yIHN0YW5kYWxvbmUgdGVzdGluZywgaW5zdGFudGlhdGVkIHVzaW5nIHRoZSBuZXcKICAgICAqICAgb3BlcmF0b3IsIHdpdGggbm8gYXR0YWNoZWQgdmlldy4KICAgICAqIC0gYXMgYSBjb250cm9sbGVyIGZvciBhbiBhbmd1bGFyIG1vZGVsIHN0b3JlZCBpbiBhIHNjb3BlLCAiaW5zdGFudGlhdGVkIiBieQogICAgICogICBgc2NvcGUuJGJlY29tZShDb250cm9sbGVyQ2xhc3MpYC4KICAgICAqCiAgICAgKiBFaXRoZXIgd2F5LCB0aGUgY29udHJvbGxlcidzIG1ldGhvZHMgcmVmZXIgdG8gdGhlIG1vZGVsICB2YXJpYWJsZXMgbGlrZSBgdGhpcy5uYW1lYC4gV2hlbgogICAgICogc3RvcmVkIGluIGEgc2NvcGUsIHRoZSBtb2RlbCBzdXBwb3J0cyBkYXRhIGJpbmRpbmcuIFdoZW4gYm91bmQgdG8gYSB2aWV3LCB7e25hbWV9fSBpbiB0aGUKICAgICAqIEhUTUwgdGVtcGxhdGUgcmVmZXJzIHRvIHRoZSBzYW1lIHZhcmlhYmxlLgogICAgICovCiAgICAkYmVjb21lOiBmdW5jdGlvbihDbGFzcykgewogICAgICBpZiAoaXNGdW5jdGlvbihDbGFzcykpIHsKICAgICAgICBpbnN0YW5jZS5jb25zdHJ1Y3RvciA9IENsYXNzOwogICAgICAgIGZvckVhY2goQ2xhc3MucHJvdG90eXBlLCBmdW5jdGlvbihmbiwgbmFtZSl7CiAgICAgICAgICBpbnN0YW5jZVtuYW1lXSA9IGJpbmQoaW5zdGFuY2UsIGZuKTsKICAgICAgICB9KTsKICAgICAgICBpbnN0YW5jZS4kc2VydmljZS5pbnZva2UoaW5zdGFuY2UsIENsYXNzLCBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSwgYXJndW1lbnRzLmxlbmd0aCkpOwoKICAgICAgICAvL1RPRE86IGJhY2t3YXJkcyBjb21wYXRpYmlsaXR5IGhhY2ssIHJlbW92ZSB3aGVuIHdlIGRvbid0IGRlcGVuZCBvbiBpbml0IG1ldGhvZHMKICAgICAgICBpZiAoaXNGdW5jdGlvbihDbGFzcy5wcm90b3R5cGUuaW5pdCkpIHsKICAgICAgICAgIGluc3RhbmNlLmluaXQoKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCgogICAgLyoqCiAgICAgKiBAd29ya0luUHJvZ3Jlc3MKICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICogQG5hbWUgYW5ndWxhci5zY29wZS4kbmV3CiAgICAgKiBAZnVuY3Rpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIENyZWF0ZXMgYSBuZXcge0BsaW5rIGFuZ3VsYXIuc2NvcGUgc2NvcGV9LCB0aGF0OgogICAgICoKICAgICAqIC0gaXMgYSBjaGlsZCBvZiB0aGUgY3VycmVudCBzY29wZQogICAgICogLSB3aWxsIHtAbGluayBhbmd1bGFyLnNjb3BlLiRiZWNvbWUgJGJlY29tZX0gb2YgdHlwZSBzcGVjaWZpZWQgdmlhIGBjb25zdHJ1Y3RvcmAKICAgICAqCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKCl9IGNvbnN0cnVjdG9yIENvbnN0cnVjdG9yIGZ1bmN0aW9uIG9mIHRoZSB0eXBlIHRoZSBuZXcgc2NvcGUgc2hvdWxkIGFzc3VtZS4KICAgICAqIEByZXR1cm5zIHtPYmplY3R9IFRoZSBuZXdseSBjcmVhdGVkIGNoaWxkIHNjb3BlLgogICAgICoKICAgICAqLwogICAgJG5ldzogZnVuY3Rpb24oY29uc3RydWN0b3IpIHsKICAgICAgdmFyIGNoaWxkID0gY3JlYXRlU2NvcGUoaW5zdGFuY2UpOwogICAgICBjaGlsZC4kYmVjb21lLmFwcGx5KGluc3RhbmNlLCBjb25jYXQoW2NvbnN0cnVjdG9yXSwgYXJndW1lbnRzLCAxKSk7CiAgICAgIGluc3RhbmNlLiRvbkV2YWwoY2hpbGQuJGV2YWwpOwogICAgICByZXR1cm4gY2hpbGQ7CiAgICB9CgogIH0pOwoKICBpZiAoIXBhcmVudC4kcm9vdCkgewogICAgaW5zdGFuY2UuJHJvb3QgPSBpbnN0YW5jZTsKICAgIGluc3RhbmNlLiRwYXJlbnQgPSBpbnN0YW5jZTsKCiAgICAvKioKICAgICAqIEB3b3JrSW5Qcm9ncmVzcwogICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgKiBAbmFtZSBhbmd1bGFyLnNjb3BlLiRzZXJ2aWNlCiAgICAgKiBAZnVuY3Rpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFByb3ZpZGVzIGFjY2VzcyB0byBhbmd1bGFyJ3MgZGVwZW5kZW5jeSBpbmplY3RvciBhbmQKICAgICAqIHtAbGluayBhbmd1bGFyLnNlcnZpY2UgcmVnaXN0ZXJlZCBzZXJ2aWNlc30uIEluIGdlbmVyYWwgdGhlIHVzZSBvZiB0aGlzIGFwaSBpcyBkaXNjb3VyYWdlZCwKICAgICAqIGV4Y2VwdCBmb3IgdGVzdHMgYW5kIGNvbXBvbmVudHMgdGhhdCBjdXJyZW50bHkgZG9uJ3Qgc3VwcG9ydCBkZXBlbmRlbmN5IGluamVjdGlvbiAod2lkZ2V0cywKICAgICAqIGZpbHRlcnMsIGV0YykuCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IHNlcnZpY2VJZCBTdHJpbmcgSUQgb2YgdGhlIHNlcnZpY2UgdG8gcmV0dXJuLgogICAgICogQHJldHVybnMgeyp9IFZhbHVlLCBvYmplY3Qgb3IgZnVuY3Rpb24gcmV0dXJuZWQgYnkgdGhlIHNlcnZpY2UgZmFjdG9yeSBmdW5jdGlvbiBpZiBhbnkuCiAgICAgKi8KICAgIChpbnN0YW5jZS4kc2VydmljZSA9IGNyZWF0ZUluamVjdG9yKGluc3RhbmNlLCBwcm92aWRlcnMsIGluc3RhbmNlQ2FjaGUpKS5lYWdlcigpOwogIH0KCiAgJGxvZyA9IGluc3RhbmNlLiRzZXJ2aWNlKCckbG9nJyk7CiAgJGV4Y2VwdGlvbkhhbmRsZXIgPSBpbnN0YW5jZS4kc2VydmljZSgnJGV4Y2VwdGlvbkhhbmRsZXInKTsKCiAgcmV0dXJuIGluc3RhbmNlOwp9Cid1c2Ugc3RyaWN0JzsKCi8qKgogKiBAbmdkb2MgZnVuY3Rpb24KICogQG5hbWUgYW5ndWxhci5pbmplY3RvcgogKiBAZnVuY3Rpb24KICoKICogQGRlc2NyaXB0aW9uCiAqIENyZWF0ZXMgYW4gaW5qZWN0b3IgZnVuY3Rpb24gdGhhdCBjYW4gYmUgdXNlZCBmb3IgcmV0cmlldmluZyBzZXJ2aWNlcyBhcyB3ZWxsIGFzIGZvcgogKiBkZXBlbmRlbmN5IGluamVjdGlvbiAoc2VlIHtAbGluayBndWlkZS9kZXZfZ3VpZGUuZGkgZGVwZW5kZW5jeSBpbmplY3Rpb259KS4KICoKICogQW5ndWxhciBjcmVhdGVzIGFuIGluamVjdG9yIGF1dG9tYXRpY2FsbHkgZm9yIHRoZSByb290IHNjb3BlIGFuZCBpdCBpcyBhdmFpbGFibGUgYXMgdGhlCiAqIHtAbGluayBhbmd1bGFyLnNjb3BlLiRzZXJ2aWNlICRzZXJ2aWNlfSBwcm9wZXJ0eS4gQ3JlYXRpb24gb2YgdGhlIGluamVjdG9yIGF1dG9tYXRpY2FsbHkgY3JlYXRlcwogKiBhbGwgb2YgdGhlIGAkZWFnZXJgIHtAbGluayBhbmd1bGFyLnNlcnZpY2Ugc2VydmljZXN9LgogKgogKiBAcGFyYW0ge09iamVjdD19IFtmYWN0b3J5U2NvcGU9e31dIGB0aGlzYCBmb3IgdGhlIHNlcnZpY2UgZmFjdG9yeSBmdW5jdGlvbi4KICogQHBhcmFtIHtPYmplY3QuPHN0cmluZywgZnVuY3Rpb24oKT49fSBbZmFjdG9yaWVzPWFuZ3VsYXIuc2VydmljZV0gTWFwIG9mIHNlcnZpY2UgZmFjdG9yeQogKiAgICAgZnVuY3Rpb25zLgogKiBAcGFyYW0ge09iamVjdC48c3RyaW5nLCBmdW5jdGlvbigpPj19IFtpbnN0YW5jZUNhY2hlPXt9XSBQbGFjZSB3aGVyZSBpbnN0YW5jZXMgb2Ygc2VydmljZXMgYXJlCiAqICAgICBzYXZlZCBmb3IgcmV1c2UuIENhbiBhbHNvIGJlIHVzZWQgdG8gb3ZlcnJpZGUgc2VydmljZXMgc3BlY2lmaWVkIGJ5IGBzZXJ2aWNlRmFjdG9yeWAKICogICAgICh1c2VmdWwgaW4gdGVzdHMpLgogKiBAcmV0dXJucyB7ZnVuY3Rpb24oKX0gSW5qZWN0b3IgZnVuY3Rpb246CiAqCiAqICAgKiBgaW5qZWN0b3Ioc2VydmljZU5hbWUpYDoKICogICAgICogYHNlcnZpY2VOYW1lYCAtIGB7c3RyaW5nPX1gIC0gbmFtZSBvZiB0aGUgc2VydmljZSB0byByZXRyaWV2ZS4KICoKICogVGhlIGluamVjdG9yIGZ1bmN0aW9uIGFsc28gaGFzIHRoZXNlIHByb3BlcnRpZXM6CiAqCiAqICAgKiBhbiBgaW52b2tlYCBwcm9wZXJ0eSB3aGljaCBjYW4gYmUgdXNlZCB0byBpbnZva2UgbWV0aG9kcyB3aXRoIGRlcGVuZGVuY3ktaW5qZWN0ZWQgYXJndW1lbnRzLgogKiAgICBgaW5qZWN0b3IuaW52b2tlKHNlbGYsIGZuLCBjdXJyeUFyZ3MpYAogKiAgICAgKiBgc2VsZmAgLSAgImB0aGlzYCIgdG8gYmUgdXNlZCB3aGVuIGludm9raW5nIHRoZSBmdW5jdGlvbi4KICogICAgICogYGZuYCAtIHRoZSBmdW5jdGlvbiB0byBiZSBpbnZva2VkLiBUaGUgZnVuY3Rpb24gbWF5IGhhdmUgdGhlIGAkaW5qZWN0YCBwcm9wZXJ0eSB3aGljaAogKiAgICAgICAgbGlzdHMgdGhlIHNldCBvZiBhcmd1bWVudHMgd2hpY2ggc2hvdWxkIGJlIGF1dG8gaW5qZWN0ZWQKICogICAgICAgIChzZWUge0BsaW5rIGd1aWRlL2Rldl9ndWlkZS5kaSBkZXBlbmRlbmN5IGluamVjdGlvbn0pLgogKiAgICAgKiBgY3VycnlBcmdzKGFycmF5KWAgLSBvcHRpb25hbCBhcnJheSBvZiBhcmd1bWVudHMgdG8gcGFzcyB0byBmdW5jdGlvbiBpbnZvY2F0aW9uIGFmdGVyIHRoZQogKiAgICAgICAgaW5qZWN0aW9uIGFyZ3VtZW50cyAoYWxzbyBrbm93biBhcyBjdXJyeSBhcmd1bWVudHMgb3IgY3VycnlpbmcpLgogKiAgICogYW4gYGVhZ2VyYCBwcm9wZXJ0eSB3aGljaCBpcyB1c2VkIHRvIGluaXRpYWxpemUgdGhlIGVhZ2VyIHNlcnZpY2VzLgogKiAgICAgYGluamVjdG9yLmVhZ2VyKClgCiAqLwpmdW5jdGlvbiBjcmVhdGVJbmplY3RvcihmYWN0b3J5U2NvcGUsIGZhY3RvcmllcywgaW5zdGFuY2VDYWNoZSkgewogIGZhY3RvcmllcyA9IGZhY3RvcmllcyB8fCBhbmd1bGFyU2VydmljZTsKICBpbnN0YW5jZUNhY2hlID0gaW5zdGFuY2VDYWNoZSB8fCB7fTsKICBmYWN0b3J5U2NvcGUgPSBmYWN0b3J5U2NvcGUgfHwge307CiAgaW5qZWN0b3IuaW52b2tlID0gaW52b2tlOwoKICBpbmplY3Rvci5lYWdlciA9IGZ1bmN0aW9uKCl7CiAgICBmb3JFYWNoKGZhY3RvcmllcywgZnVuY3Rpb24oZmFjdG9yeSwgbmFtZSl7CiAgICAgIGlmIChmYWN0b3J5LiRlYWdlcikKICAgICAgICBpbmplY3RvcihuYW1lKTsKCiAgICAgIGlmIChmYWN0b3J5LiRjcmVhdGlvbikKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkZhaWxlZCB0byByZWdpc3RlciBzZXJ2aWNlICciICsgbmFtZSArCiAgICAgICAgIic6ICRjcmVhdGlvbiBwcm9wZXJ0eSBpcyB1bnN1cHBvcnRlZC4gVXNlICRlYWdlcjp0cnVlIG9yIHNlZSByZWxlYXNlIG5vdGVzLiIpOwogICAgfSk7CiAgfTsKICByZXR1cm4gaW5qZWN0b3I7CgogIGZ1bmN0aW9uIGluamVjdG9yKHZhbHVlKXsKICAgIGlmICghKHZhbHVlIGluIGluc3RhbmNlQ2FjaGUpKSB7CiAgICAgIHZhciBmYWN0b3J5ID0gZmFjdG9yaWVzW3ZhbHVlXTsKICAgICAgaWYgKCFmYWN0b3J5KSB0aHJvdyBFcnJvcigiVW5rbm93biBwcm92aWRlciBmb3IgJyIrdmFsdWUrIicuIik7CiAgICAgIGluc3RhbmNlQ2FjaGVbdmFsdWVdID0gaW52b2tlKGZhY3RvcnlTY29wZSwgZmFjdG9yeSk7CiAgICB9CiAgICByZXR1cm4gaW5zdGFuY2VDYWNoZVt2YWx1ZV07CiAgfQoKICBmdW5jdGlvbiBpbnZva2Uoc2VsZiwgZm4sIGFyZ3MpewogICAgYXJncyA9IGFyZ3MgfHwgW107CiAgICB2YXIgaW5qZWN0TmFtZXMgPSBpbmplY3Rpb25BcmdzKGZuKTsKICAgIHZhciBpID0gaW5qZWN0TmFtZXMubGVuZ3RoOwogICAgd2hpbGUoaS0tKSB7CiAgICAgIGFyZ3MudW5zaGlmdChpbmplY3RvcihpbmplY3ROYW1lc1tpXSkpOwogICAgfQogICAgcmV0dXJuIGZuLmFwcGx5KHNlbGYsIGFyZ3MpOwogIH0KfQoKLyoqCiAqIFRISVMgSVMgTk9UIFBVQkxJQyBET0MgWUVUIQogKgogKiBAbmFtZSBhbmd1bGFyLmFubm90YXRlCiAqIEBmdW5jdGlvbgogKgogKiBAZGVzY3JpcHRpb24KICogQW5ub3RhdGUgdGhlIGZ1bmN0aW9uIHdpdGggaW5qZWN0aW9uIGFyZ3VtZW50cy4gVGhpcyBpcyBlcXVpdmFsZW50IHRvIHNldHRpbmcgdGhlIGAkaW5qZWN0YAogKiBwcm9wZXJ0eSBhcyBkZXNjcmliZWQgaW4ge0BsaW5rIGd1aWRlLmRpIGRlcGVuZGVuY3kgaW5qZWN0aW9ufS4KICoKICogPHByZT4KICogdmFyIE15Q29udHJvbGxlciA9IGFuZ3VsYXIuYW5ub3RhdGUoJyRsb2NhdGlvbicsIGZ1bmN0aW9uKCRsb2NhdGlvbil7IC4uLiB9KTsKICogPC9wcmU+CiAqCiAqIGlzIHRoZSBzYW1lIGFzCiAqCiAqIDxwcmU+CiAqIHZhciBNeUNvbnRyb2xsZXIgPSBmdW5jdGlvbigkbG9jYXRpb24peyAuLi4gfTsKICogTXlDb250cm9sbGVyLiRpbmplY3QgPSBbJyRsb2NhdGlvbiddOwogKiA8L3ByZT4KICoKICogQHBhcmFtIHtTdHJpbmd8QXJyYXl9IHNlcnZpY2VOYW1lLi4uIHplcm8gb3IgbW9yZSBzZXJ2aWNlIG5hbWVzIHRvIGluamVjdCBpbnRvIHRoZQogKiAgICAgYGFubm90YXRlZEZ1bmN0aW9uYC4KICogQHBhcmFtIHtmdW5jdGlvbn0gYW5ub3RhdGVkRnVuY3Rpb24gZnVuY3Rpb24gdG8gYW5ub3RhdGUgd2l0aCBgJGluamVjdGAKICogICAgIGZ1bmN0aW9ucy4KICogQHJldHVybnMge2Z1bmN0aW9ufSBgYW5ub3RhdGVkRnVuY3Rpb25gCiAqLwpmdW5jdGlvbiBhbm5vdGF0ZShzZXJ2aWNlcywgZm4pIHsKICBpZiAoc2VydmljZXMgaW5zdGFuY2VvZiBBcnJheSkgewogICAgZm4uJGluamVjdCA9IHNlcnZpY2VzOwogICAgcmV0dXJuIGZuOwogIH0gZWxzZSB7CiAgICB2YXIgaSA9IDAsCiAgICAgICAgbGVuZ3RoID0gYXJndW1lbnRzLmxlbmd0aCAtIDEsIC8vIGxhc3Qgb25lIGlzIHRoZSBkZXN0aW5hdGlvbiBmdW5jdGlvbgogICAgICAgICRpbmplY3QgPSBhcmd1bWVudHNbbGVuZ3RoXS4kaW5qZWN0ID0gW107CiAgICBmb3IgKDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICRpbmplY3QucHVzaChhcmd1bWVudHNbaV0pOwogICAgfQogICAgcmV0dXJuIGFyZ3VtZW50c1tsZW5ndGhdOyAvLyByZXR1cm4gdGhlIGxhc3Qgb25lCiAgfQp9CgpmdW5jdGlvbiBhbmd1bGFyU2VydmljZUluamVjdChuYW1lLCBmbiwgaW5qZWN0LCBlYWdlcikgewogIGFuZ3VsYXJTZXJ2aWNlKG5hbWUsIGZuLCB7JGluamVjdDppbmplY3QsICRlYWdlcjplYWdlcn0pOwp9CgoKLyoqCiAqIEByZXR1cm5zIHRoZSAkaW5qZWN0IHByb3BlcnR5IG9mIGZ1bmN0aW9uLiBJZiBub3QgZm91bmQgdGhlCiAqIHRoZSAkaW5qZWN0IGlzIGNvbXB1dGVkIGJ5IGxvb2tpbmcgYXQgdGhlIHRvU3RyaW5nIG9mIGZ1bmN0aW9uIGFuZAogKiBleHRyYWN0aW5nIGFsbCBhcmd1bWVudHMgd2hpY2ggYW5kIGFzc3VtaW5nIHRoYXQgdGhleSBhcmUgdGhlCiAqIGluamVjdGlvbiBuYW1lcy4KICovCnZhciBGTl9BUkdTID0gL15mdW5jdGlvblxzKlteXChdKlwoKFteXCldKilcKS9tOwp2YXIgRk5fQVJHX1NQTElUID0gLywvOwp2YXIgRk5fQVJHID0gL15ccyooLis/KVxzKiQvOwp2YXIgU1RSSVBfQ09NTUVOVFMgPSAvKChcL1wvLiokKXwoXC9cKltcc1xTXSo/XCpcLykpL21nOwpmdW5jdGlvbiBpbmplY3Rpb25BcmdzKGZuKSB7CiAgYXNzZXJ0QXJnRm4oZm4pOwogIGlmICghZm4uJGluamVjdCkgewogICAgdmFyIGFyZ3MgPSBmbi4kaW5qZWN0ID0gW107CiAgICB2YXIgZm5UZXh0ID0gZm4udG9TdHJpbmcoKS5yZXBsYWNlKFNUUklQX0NPTU1FTlRTLCAnJyk7CiAgICB2YXIgYXJnRGVjbCA9IGZuVGV4dC5tYXRjaChGTl9BUkdTKTsKICAgIGZvckVhY2goYXJnRGVjbFsxXS5zcGxpdChGTl9BUkdfU1BMSVQpLCBmdW5jdGlvbihhcmcpewogICAgICBhcmcucmVwbGFjZShGTl9BUkcsIGZ1bmN0aW9uKGFsbCwgbmFtZSl7CiAgICAgICAgYXJncy5wdXNoKG5hbWUpOwogICAgICB9KTsKICAgIH0pOwogIH0KICByZXR1cm4gZm4uJGluamVjdDsKfQondXNlIHN0cmljdCc7Cgp2YXIgT1BFUkFUT1JTID0gewogICAgJ251bGwnOmZ1bmN0aW9uKHNlbGYpe3JldHVybiBudWxsO30sCiAgICAndHJ1ZSc6ZnVuY3Rpb24oc2VsZil7cmV0dXJuIHRydWU7fSwKICAgICdmYWxzZSc6ZnVuY3Rpb24oc2VsZil7cmV0dXJuIGZhbHNlO30sCiAgICAkdW5kZWZpbmVkOm5vb3AsCiAgICAnKyc6ZnVuY3Rpb24oc2VsZiwgYSxiKXtyZXR1cm4gKGlzRGVmaW5lZChhKT9hOjApKyhpc0RlZmluZWQoYik/YjowKTt9LAogICAgJy0nOmZ1bmN0aW9uKHNlbGYsIGEsYil7cmV0dXJuIChpc0RlZmluZWQoYSk/YTowKS0oaXNEZWZpbmVkKGIpP2I6MCk7fSwKICAgICcqJzpmdW5jdGlvbihzZWxmLCBhLGIpe3JldHVybiBhKmI7fSwKICAgICcvJzpmdW5jdGlvbihzZWxmLCBhLGIpe3JldHVybiBhL2I7fSwKICAgICclJzpmdW5jdGlvbihzZWxmLCBhLGIpe3JldHVybiBhJWI7fSwKICAgICdeJzpmdW5jdGlvbihzZWxmLCBhLGIpe3JldHVybiBhXmI7fSwKICAgICc9Jzpub29wLAogICAgJz09JzpmdW5jdGlvbihzZWxmLCBhLGIpe3JldHVybiBhPT1iO30sCiAgICAnIT0nOmZ1bmN0aW9uKHNlbGYsIGEsYil7cmV0dXJuIGEhPWI7fSwKICAgICc8JzpmdW5jdGlvbihzZWxmLCBhLGIpe3JldHVybiBhPGI7fSwKICAgICc+JzpmdW5jdGlvbihzZWxmLCBhLGIpe3JldHVybiBhPmI7fSwKICAgICc8PSc6ZnVuY3Rpb24oc2VsZiwgYSxiKXtyZXR1cm4gYTw9Yjt9LAogICAgJz49JzpmdW5jdGlvbihzZWxmLCBhLGIpe3JldHVybiBhPj1iO30sCiAgICAnJiYnOmZ1bmN0aW9uKHNlbGYsIGEsYil7cmV0dXJuIGEmJmI7fSwKICAgICd8fCc6ZnVuY3Rpb24oc2VsZiwgYSxiKXtyZXR1cm4gYXx8Yjt9LAogICAgJyYnOmZ1bmN0aW9uKHNlbGYsIGEsYil7cmV0dXJuIGEmYjt9LAovLyAgICAnfCc6ZnVuY3Rpb24oc2VsZiwgYSxiKXtyZXR1cm4gYXxiO30sCiAgICAnfCc6ZnVuY3Rpb24oc2VsZiwgYSxiKXtyZXR1cm4gYihzZWxmLCBhKTt9LAogICAgJyEnOmZ1bmN0aW9uKHNlbGYsIGEpe3JldHVybiAhYTt9Cn07CnZhciBFU0NBUEUgPSB7Im4iOiJcbiIsICJmIjoiXGYiLCAiciI6IlxyIiwgInQiOiJcdCIsICJ2IjoiXHYiLCAiJyI6IiciLCAnIic6JyInfTsKCmZ1bmN0aW9uIGxleCh0ZXh0LCBwYXJzZVN0cmluZ3NGb3JPYmplY3RzKXsKICB2YXIgZGF0ZVBhcnNlTGVuZ3RoID0gcGFyc2VTdHJpbmdzRm9yT2JqZWN0cyA/IERBVEVfSVNPU1RSSU5HX0xOIDogLTEsCiAgICAgIHRva2VucyA9IFtdLAogICAgICB0b2tlbiwKICAgICAgaW5kZXggPSAwLAogICAgICBqc29uID0gW10sCiAgICAgIGNoLAogICAgICBsYXN0Q2ggPSAnOic7IC8vIGNhbiBzdGFydCByZWdleHAKCiAgd2hpbGUgKGluZGV4IDwgdGV4dC5sZW5ndGgpIHsKICAgIGNoID0gdGV4dC5jaGFyQXQoaW5kZXgpOwogICAgaWYgKGlzKCciXCcnKSkgewogICAgICByZWFkU3RyaW5nKGNoKTsKICAgIH0gZWxzZSBpZiAoaXNOdW1iZXIoY2gpIHx8IGlzKCcuJykgJiYgaXNOdW1iZXIocGVlaygpKSkgewogICAgICByZWFkTnVtYmVyKCk7CiAgICB9IGVsc2UgaWYgKGlzSWRlbnQoY2gpKSB7CiAgICAgIHJlYWRJZGVudCgpOwogICAgICAvLyBpZGVudGlmaWVycyBjYW4gb25seSBiZSBpZiB0aGUgcHJlY2VkaW5nIGNoYXIgd2FzIGEgeyBvciAsCiAgICAgIGlmICh3YXMoJ3ssJykgJiYganNvblswXT09J3snICYmCiAgICAgICAgICh0b2tlbj10b2tlbnNbdG9rZW5zLmxlbmd0aC0xXSkpIHsKICAgICAgICB0b2tlbi5qc29uID0gdG9rZW4udGV4dC5pbmRleE9mKCcuJykgPT0gLTE7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAoaXMoJygpe31bXS4sOzonKSkgewogICAgICB0b2tlbnMucHVzaCh7CiAgICAgICAgaW5kZXg6aW5kZXgsCiAgICAgICAgdGV4dDpjaCwKICAgICAgICBqc29uOih3YXMoJzpbLCcpICYmIGlzKCd7WycpKSB8fCBpcygnfV06LCcpCiAgICAgIH0pOwogICAgICBpZiAoaXMoJ3tbJykpIGpzb24udW5zaGlmdChjaCk7CiAgICAgIGlmIChpcygnfV0nKSkganNvbi5zaGlmdCgpOwogICAgICBpbmRleCsrOwogICAgfSBlbHNlIGlmIChpc1doaXRlc3BhY2UoY2gpKSB7CiAgICAgIGluZGV4Kys7CiAgICAgIGNvbnRpbnVlOwogICAgfSBlbHNlIHsKICAgICAgdmFyIGNoMiA9IGNoICsgcGVlaygpLAogICAgICAgICAgZm4gPSBPUEVSQVRPUlNbY2hdLAogICAgICAgICAgZm4yID0gT1BFUkFUT1JTW2NoMl07CiAgICAgIGlmIChmbjIpIHsKICAgICAgICB0b2tlbnMucHVzaCh7aW5kZXg6aW5kZXgsIHRleHQ6Y2gyLCBmbjpmbjJ9KTsKICAgICAgICBpbmRleCArPSAyOwogICAgICB9IGVsc2UgaWYgKGZuKSB7CiAgICAgICAgdG9rZW5zLnB1c2goe2luZGV4OmluZGV4LCB0ZXh0OmNoLCBmbjpmbiwganNvbjogd2FzKCdbLDonKSAmJiBpcygnKy0nKX0pOwogICAgICAgIGluZGV4ICs9IDE7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhyb3dFcnJvcigiVW5leHBlY3RlZCBuZXh0IGNoYXJhY3RlciAiLCBpbmRleCwgaW5kZXgrMSk7CiAgICAgIH0KICAgIH0KICAgIGxhc3RDaCA9IGNoOwogIH0KICByZXR1cm4gdG9rZW5zOwoKICBmdW5jdGlvbiBpcyhjaGFycykgewogICAgcmV0dXJuIGNoYXJzLmluZGV4T2YoY2gpICE9IC0xOwogIH0KCiAgZnVuY3Rpb24gd2FzKGNoYXJzKSB7CiAgICByZXR1cm4gY2hhcnMuaW5kZXhPZihsYXN0Q2gpICE9IC0xOwogIH0KCiAgZnVuY3Rpb24gcGVlaygpIHsKICAgIHJldHVybiBpbmRleCArIDEgPCB0ZXh0Lmxlbmd0aCA/IHRleHQuY2hhckF0KGluZGV4ICsgMSkgOiBmYWxzZTsKICB9CiAgZnVuY3Rpb24gaXNOdW1iZXIoY2gpIHsKICAgIHJldHVybiAnMCcgPD0gY2ggJiYgY2ggPD0gJzknOwogIH0KICBmdW5jdGlvbiBpc1doaXRlc3BhY2UoY2gpIHsKICAgIHJldHVybiBjaCA9PSAnICcgfHwgY2ggPT0gJ1xyJyB8fCBjaCA9PSAnXHQnIHx8CiAgICAgICAgICAgY2ggPT0gJ1xuJyB8fCBjaCA9PSAnXHYnIHx8IGNoID09ICdcdTAwQTAnOyAvLyBJRSB0cmVhdHMgbm9uLWJyZWFraW5nIHNwYWNlIGFzIFx1MDBBMAogIH0KICBmdW5jdGlvbiBpc0lkZW50KGNoKSB7CiAgICByZXR1cm4gJ2EnIDw9IGNoICYmIGNoIDw9ICd6JyB8fAogICAgICAgICAgICdBJyA8PSBjaCAmJiBjaCA8PSAnWicgfHwKICAgICAgICAgICAnXycgPT0gY2ggfHwgY2ggPT0gJyQnOwogIH0KICBmdW5jdGlvbiBpc0V4cE9wZXJhdG9yKGNoKSB7CiAgICByZXR1cm4gY2ggPT0gJy0nIHx8IGNoID09ICcrJyB8fCBpc051bWJlcihjaCk7CiAgfQoKICBmdW5jdGlvbiB0aHJvd0Vycm9yKGVycm9yLCBzdGFydCwgZW5kKSB7CiAgICBlbmQgPSBlbmQgfHwgaW5kZXg7CiAgICB0aHJvdyBFcnJvcigiTGV4ZXIgRXJyb3I6ICIgKyBlcnJvciArICIgYXQgY29sdW1uIiArCiAgICAgICAgKGlzRGVmaW5lZChzdGFydCkKICAgICAgICAgICAgPyAicyAiICsgc3RhcnQgKyAgIi0iICsgaW5kZXggKyAiIFsiICsgdGV4dC5zdWJzdHJpbmcoc3RhcnQsIGVuZCkgKyAiXSIKICAgICAgICAgICAgOiAiICIgKyBlbmQpICsKICAgICAgICAiIGluIGV4cHJlc3Npb24gWyIgKyB0ZXh0ICsgIl0uIik7CiAgfQoKICBmdW5jdGlvbiByZWFkTnVtYmVyKCkgewogICAgdmFyIG51bWJlciA9ICIiOwogICAgdmFyIHN0YXJ0ID0gaW5kZXg7CiAgICB3aGlsZSAoaW5kZXggPCB0ZXh0Lmxlbmd0aCkgewogICAgICB2YXIgY2ggPSBsb3dlcmNhc2UodGV4dC5jaGFyQXQoaW5kZXgpKTsKICAgICAgaWYgKGNoID09ICcuJyB8fCBpc051bWJlcihjaCkpIHsKICAgICAgICBudW1iZXIgKz0gY2g7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIHBlZWtDaCA9IHBlZWsoKTsKICAgICAgICBpZiAoY2ggPT0gJ2UnICYmIGlzRXhwT3BlcmF0b3IocGVla0NoKSkgewogICAgICAgICAgbnVtYmVyICs9IGNoOwogICAgICAgIH0gZWxzZSBpZiAoaXNFeHBPcGVyYXRvcihjaCkgJiYKICAgICAgICAgICAgcGVla0NoICYmIGlzTnVtYmVyKHBlZWtDaCkgJiYKICAgICAgICAgICAgbnVtYmVyLmNoYXJBdChudW1iZXIubGVuZ3RoIC0gMSkgPT0gJ2UnKSB7CiAgICAgICAgICBudW1iZXIgKz0gY2g7CiAgICAgICAgfSBlbHNlIGlmIChpc0V4cE9wZXJhdG9yKGNoKSAmJgogICAgICAgICAgICAoIXBlZWtDaCB8fCAhaXNOdW1iZXIocGVla0NoKSkgJiYKICAgICAgICAgICAgbnVtYmVyLmNoYXJBdChudW1iZXIubGVuZ3RoIC0gMSkgPT0gJ2UnKSB7CiAgICAgICAgICB0aHJvd0Vycm9yKCdJbnZhbGlkIGV4cG9uZW50Jyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgfQogICAgICBpbmRleCsrOwogICAgfQogICAgbnVtYmVyID0gMSAqIG51bWJlcjsKICAgIHRva2Vucy5wdXNoKHtpbmRleDpzdGFydCwgdGV4dDpudW1iZXIsIGpzb246dHJ1ZSwKICAgICAgZm46ZnVuY3Rpb24oKXtyZXR1cm4gbnVtYmVyO319KTsKICB9CiAgZnVuY3Rpb24gcmVhZElkZW50KCkgewogICAgdmFyIGlkZW50ID0gIiI7CiAgICB2YXIgc3RhcnQgPSBpbmRleDsKICAgIHZhciBmbjsKICAgIHdoaWxlIChpbmRleCA8IHRleHQubGVuZ3RoKSB7CiAgICAgIHZhciBjaCA9IHRleHQuY2hhckF0KGluZGV4KTsKICAgICAgaWYgKGNoID09ICcuJyB8fCBpc0lkZW50KGNoKSB8fCBpc051bWJlcihjaCkpIHsKICAgICAgICBpZGVudCArPSBjaDsKICAgICAgfSBlbHNlIHsKICAgICAgICBicmVhazsKICAgICAgfQogICAgICBpbmRleCsrOwogICAgfQogICAgZm4gPSBPUEVSQVRPUlNbaWRlbnRdOwogICAgdG9rZW5zLnB1c2goewogICAgICBpbmRleDpzdGFydCwKICAgICAgdGV4dDppZGVudCwKICAgICAganNvbjogZm4sCiAgICAgIGZuOmZufHxleHRlbmQoZ2V0dGVyRm4oaWRlbnQpLCB7CiAgICAgICAgYXNzaWduOmZ1bmN0aW9uKHNlbGYsIHZhbHVlKXsKICAgICAgICAgIHJldHVybiBzZXR0ZXIoc2VsZiwgaWRlbnQsIHZhbHVlKTsKICAgICAgICB9CiAgICAgIH0pCiAgICB9KTsKICB9CgogIGZ1bmN0aW9uIHJlYWRTdHJpbmcocXVvdGUpIHsKICAgIHZhciBzdGFydCA9IGluZGV4OwogICAgaW5kZXgrKzsKICAgIHZhciBzdHJpbmcgPSAiIjsKICAgIHZhciByYXdTdHJpbmcgPSBxdW90ZTsKICAgIHZhciBlc2NhcGUgPSBmYWxzZTsKICAgIHdoaWxlIChpbmRleCA8IHRleHQubGVuZ3RoKSB7CiAgICAgIHZhciBjaCA9IHRleHQuY2hhckF0KGluZGV4KTsKICAgICAgcmF3U3RyaW5nICs9IGNoOwogICAgICBpZiAoZXNjYXBlKSB7CiAgICAgICAgaWYgKGNoID09ICd1JykgewogICAgICAgICAgdmFyIGhleCA9IHRleHQuc3Vic3RyaW5nKGluZGV4ICsgMSwgaW5kZXggKyA1KTsKICAgICAgICAgIGlmICghaGV4Lm1hdGNoKC9bXGRhLWZdezR9L2kpKQogICAgICAgICAgICB0aHJvd0Vycm9yKCAiSW52YWxpZCB1bmljb2RlIGVzY2FwZSBbXFx1IiArIGhleCArICJdIik7CiAgICAgICAgICBpbmRleCArPSA0OwogICAgICAgICAgc3RyaW5nICs9IFN0cmluZy5mcm9tQ2hhckNvZGUocGFyc2VJbnQoaGV4LCAxNikpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB2YXIgcmVwID0gRVNDQVBFW2NoXTsKICAgICAgICAgIGlmIChyZXApIHsKICAgICAgICAgICAgc3RyaW5nICs9IHJlcDsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHN0cmluZyArPSBjaDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZXNjYXBlID0gZmFsc2U7CiAgICAgIH0gZWxzZSBpZiAoY2ggPT0gJ1xcJykgewogICAgICAgIGVzY2FwZSA9IHRydWU7CiAgICAgIH0gZWxzZSBpZiAoY2ggPT0gcXVvdGUpIHsKICAgICAgICBpbmRleCsrOwogICAgICAgIHRva2Vucy5wdXNoKHtpbmRleDpzdGFydCwgdGV4dDpyYXdTdHJpbmcsIHN0cmluZzpzdHJpbmcsIGpzb246dHJ1ZSwKICAgICAgICAgIGZuOmZ1bmN0aW9uKCl7CiAgICAgICAgICAgIHJldHVybiAoc3RyaW5nLmxlbmd0aCA9PSBkYXRlUGFyc2VMZW5ndGgpCiAgICAgICAgICAgICAgPyBhbmd1bGFyWydTdHJpbmcnXVsndG9EYXRlJ10oc3RyaW5nKQogICAgICAgICAgICAgIDogc3RyaW5nOwogICAgICAgICAgfX0pOwogICAgICAgIHJldHVybjsKICAgICAgfSBlbHNlIHsKICAgICAgICBzdHJpbmcgKz0gY2g7CiAgICAgIH0KICAgICAgaW5kZXgrKzsKICAgIH0KICAgIHRocm93RXJyb3IoIlVudGVybWluYXRlZCBxdW90ZSIsIHN0YXJ0KTsKICB9Cn0KCi8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCgpmdW5jdGlvbiBwYXJzZXIodGV4dCwganNvbil7CiAgdmFyIFpFUk8gPSB2YWx1ZUZuKDApLAogICAgICB0b2tlbnMgPSBsZXgodGV4dCwganNvbiksCiAgICAgIGFzc2lnbm1lbnQgPSBfYXNzaWdubWVudCwKICAgICAgYXNzaWduYWJsZSA9IGxvZ2ljYWxPUiwKICAgICAgZnVuY3Rpb25DYWxsID0gX2Z1bmN0aW9uQ2FsbCwKICAgICAgZmllbGRBY2Nlc3MgPSBfZmllbGRBY2Nlc3MsCiAgICAgIG9iamVjdEluZGV4ID0gX29iamVjdEluZGV4LAogICAgICBmaWx0ZXJDaGFpbiA9IF9maWx0ZXJDaGFpbiwKICAgICAgZnVuY3Rpb25JZGVudCA9IF9mdW5jdGlvbklkZW50LAogICAgICBwaXBlRnVuY3Rpb24gPSBfcGlwZUZ1bmN0aW9uOwogIGlmKGpzb24pewogICAgLy8gVGhlIGV4dHJhIGxldmVsIG9mIGFsaWFzaW5nIGlzIGhlcmUsIGp1c3QgaW4gY2FzZSB0aGUgbGV4ZXIgbWlzc2VzIHNvbWV0aGluZywgc28gdGhhdAogICAgLy8gd2UgcHJldmVudCBhbnkgYWNjaWRlbnRhbCBleGVjdXRpb24gaW4gSlNPTi4KICAgIGFzc2lnbm1lbnQgPSBsb2dpY2FsT1I7CiAgICBmdW5jdGlvbkNhbGwgPQogICAgICBmaWVsZEFjY2VzcyA9CiAgICAgIG9iamVjdEluZGV4ID0KICAgICAgYXNzaWduYWJsZSA9CiAgICAgIGZpbHRlckNoYWluID0KICAgICAgZnVuY3Rpb25JZGVudCA9CiAgICAgIHBpcGVGdW5jdGlvbiA9CiAgICAgICAgZnVuY3Rpb24gKCl7IHRocm93RXJyb3IoImlzIG5vdCB2YWxpZCBqc29uIiwge3RleHQ6dGV4dCwgaW5kZXg6MH0pOyB9OwogIH0KICAvL1RPRE86IFNob3VsZG4ndCBhbGwgb2YgdGhlIHB1YmxpYyBtZXRob2RzIGhhdmUgYXNzZXJ0QWxsQ29uc3VtZWQ/CiAgLy9UT0RPOiBJIHRoaW5rIHRoZXNlIHNob3VsZCBiZSBwdWJsaWMgYXMgcGFydCBvZiB0aGUgcGFyc2VyIGFwaSBpbnN0ZWFkIG9mIHNjb3BlLiRldmFsKCkuCiAgcmV0dXJuIHsKICAgICAgYXNzaWduYWJsZTogYXNzZXJ0Q29uc3VtZWQoYXNzaWduYWJsZSksCiAgICAgIHByaW1hcnk6IGFzc2VydENvbnN1bWVkKHByaW1hcnkpLAogICAgICBzdGF0ZW1lbnRzOiBhc3NlcnRDb25zdW1lZChzdGF0ZW1lbnRzKSwKICAgICAgdmFsaWRhdG9yOiBhc3NlcnRDb25zdW1lZCh2YWxpZGF0b3IpLAogICAgICBmb3JtYXR0ZXI6IGFzc2VydENvbnN1bWVkKGZvcm1hdHRlciksCiAgICAgIGZpbHRlcjogYXNzZXJ0Q29uc3VtZWQoZmlsdGVyKQogIH07CgogIGZ1bmN0aW9uIGFzc2VydENvbnN1bWVkKGZuKSB7CiAgICByZXR1cm4gZnVuY3Rpb24oKXsKICAgICAgdmFyIHZhbHVlID0gZm4oKTsKICAgICAgaWYgKHRva2Vucy5sZW5ndGggIT09IDApIHsKICAgICAgICB0aHJvd0Vycm9yKCJpcyBhbiB1bmV4cGVjdGVkIHRva2VuIiwgdG9rZW5zWzBdKTsKICAgICAgfQogICAgICByZXR1cm4gdmFsdWU7CiAgICB9OwogIH0KCiAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICBmdW5jdGlvbiB0aHJvd0Vycm9yKG1zZywgdG9rZW4pIHsKICAgIHRocm93IEVycm9yKCJTeW50YXggRXJyb3I6IFRva2VuICciICsgdG9rZW4udGV4dCArCiAgICAgICInICIgKyBtc2cgKyAiIGF0IGNvbHVtbiAiICsKICAgICAgKHRva2VuLmluZGV4ICsgMSkgKyAiIG9mIHRoZSBleHByZXNzaW9uIFsiICsKICAgICAgdGV4dCArICJdIHN0YXJ0aW5nIGF0IFsiICsgdGV4dC5zdWJzdHJpbmcodG9rZW4uaW5kZXgpICsgIl0uIik7CiAgfQoKICBmdW5jdGlvbiBwZWVrVG9rZW4oKSB7CiAgICBpZiAodG9rZW5zLmxlbmd0aCA9PT0gMCkKICAgICAgdGhyb3cgRXJyb3IoIlVuZXhwZWN0ZWQgZW5kIG9mIGV4cHJlc3Npb246ICIgKyB0ZXh0KTsKICAgIHJldHVybiB0b2tlbnNbMF07CiAgfQoKICBmdW5jdGlvbiBwZWVrKGUxLCBlMiwgZTMsIGU0KSB7CiAgICBpZiAodG9rZW5zLmxlbmd0aCA+IDApIHsKICAgICAgdmFyIHRva2VuID0gdG9rZW5zWzBdOwogICAgICB2YXIgdCA9IHRva2VuLnRleHQ7CiAgICAgIGlmICh0PT1lMSB8fCB0PT1lMiB8fCB0PT1lMyB8fCB0PT1lNCB8fAogICAgICAgICAgKCFlMSAmJiAhZTIgJiYgIWUzICYmICFlNCkpIHsKICAgICAgICByZXR1cm4gdG9rZW47CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBmYWxzZTsKICB9CgogIGZ1bmN0aW9uIGV4cGVjdChlMSwgZTIsIGUzLCBlNCl7CiAgICB2YXIgdG9rZW4gPSBwZWVrKGUxLCBlMiwgZTMsIGU0KTsKICAgIGlmICh0b2tlbikgewogICAgICBpZiAoanNvbiAmJiAhdG9rZW4uanNvbikgewogICAgICAgIHRocm93RXJyb3IoImlzIG5vdCB2YWxpZCBqc29uIiwgdG9rZW4pOwogICAgICB9CiAgICAgIHRva2Vucy5zaGlmdCgpOwogICAgICByZXR1cm4gdG9rZW47CiAgICB9CiAgICByZXR1cm4gZmFsc2U7CiAgfQoKICBmdW5jdGlvbiBjb25zdW1lKGUxKXsKICAgIGlmICghZXhwZWN0KGUxKSkgewogICAgICB0aHJvd0Vycm9yKCJpcyB1bmV4cGVjdGVkLCBleHBlY3RpbmcgWyIgKyBlMSArICJdIiwgcGVlaygpKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIHVuYXJ5Rm4oZm4sIHJpZ2h0KSB7CiAgICByZXR1cm4gZnVuY3Rpb24oc2VsZikgewogICAgICByZXR1cm4gZm4oc2VsZiwgcmlnaHQoc2VsZikpOwogICAgfTsKICB9CgogIGZ1bmN0aW9uIGJpbmFyeUZuKGxlZnQsIGZuLCByaWdodCkgewogICAgcmV0dXJuIGZ1bmN0aW9uKHNlbGYpIHsKICAgICAgcmV0dXJuIGZuKHNlbGYsIGxlZnQoc2VsZiksIHJpZ2h0KHNlbGYpKTsKICAgIH07CiAgfQoKICBmdW5jdGlvbiBoYXNUb2tlbnMgKCkgewogICAgcmV0dXJuIHRva2Vucy5sZW5ndGggPiAwOwogIH0KCiAgZnVuY3Rpb24gc3RhdGVtZW50cygpewogICAgdmFyIHN0YXRlbWVudHMgPSBbXTsKICAgIHdoaWxlKHRydWUpIHsKICAgICAgaWYgKHRva2Vucy5sZW5ndGggPiAwICYmICFwZWVrKCd9JywgJyknLCAnOycsICddJykpCiAgICAgICAgc3RhdGVtZW50cy5wdXNoKGZpbHRlckNoYWluKCkpOwogICAgICBpZiAoIWV4cGVjdCgnOycpKSB7CiAgICAgICAgLy8gb3B0aW1pemUgZm9yIHRoZSBjb21tb24gY2FzZSB3aGVyZSB0aGVyZSBpcyBvbmx5IG9uZSBzdGF0ZW1lbnQuCiAgICAgICAgLy8gVE9ETyhzaXplKTogbWF5YmUgd2Ugc2hvdWxkIG5vdCBzdXBwb3J0IG11bHRpcGxlIHN0YXRlbWVudHM/CiAgICAgICAgcmV0dXJuIHN0YXRlbWVudHMubGVuZ3RoID09IDEKICAgICAgICAgID8gc3RhdGVtZW50c1swXQogICAgICAgICAgOiBmdW5jdGlvbiAoc2VsZil7CiAgICAgICAgICAgIHZhciB2YWx1ZTsKICAgICAgICAgICAgZm9yICggdmFyIGkgPSAwOyBpIDwgc3RhdGVtZW50cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIHZhciBzdGF0ZW1lbnQgPSBzdGF0ZW1lbnRzW2ldOwogICAgICAgICAgICAgIGlmIChzdGF0ZW1lbnQpCiAgICAgICAgICAgICAgICB2YWx1ZSA9IHN0YXRlbWVudChzZWxmKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICB9OwogICAgICB9CiAgICB9CiAgfQoKICBmdW5jdGlvbiBfZmlsdGVyQ2hhaW4oKXsKICAgIHZhciBsZWZ0ID0gZXhwcmVzc2lvbigpOwogICAgdmFyIHRva2VuOwogICAgd2hpbGUodHJ1ZSkgewogICAgICBpZiAoKHRva2VuID0gZXhwZWN0KCd8JykpKSB7CiAgICAgICAgbGVmdCA9IGJpbmFyeUZuKGxlZnQsIHRva2VuLmZuLCBmaWx0ZXIoKSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIGxlZnQ7CiAgICAgIH0KICAgIH0KICB9CgogIGZ1bmN0aW9uIGZpbHRlcigpewogICAgcmV0dXJuIHBpcGVGdW5jdGlvbihhbmd1bGFyRmlsdGVyKTsKICB9CgogIGZ1bmN0aW9uIHZhbGlkYXRvcigpewogICAgcmV0dXJuIHBpcGVGdW5jdGlvbihhbmd1bGFyVmFsaWRhdG9yKTsKICB9CgogIGZ1bmN0aW9uIGZvcm1hdHRlcigpewogICAgdmFyIHRva2VuID0gZXhwZWN0KCk7CiAgICB2YXIgZm9ybWF0dGVyID0gYW5ndWxhckZvcm1hdHRlclt0b2tlbi50ZXh0XTsKICAgIHZhciBhcmdGbnMgPSBbXTsKICAgIGlmICghZm9ybWF0dGVyKSB0aHJvd0Vycm9yKCdpcyBub3QgYSB2YWxpZCBmb3JtYXR0ZXIuJywgdG9rZW4pOwogICAgd2hpbGUodHJ1ZSkgewogICAgICBpZiAoKHRva2VuID0gZXhwZWN0KCc6JykpKSB7CiAgICAgICAgYXJnRm5zLnB1c2goZXhwcmVzc2lvbigpKTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gdmFsdWVGbih7CiAgICAgICAgICBmb3JtYXQ6aW52b2tlRm4oZm9ybWF0dGVyLmZvcm1hdCksCiAgICAgICAgICBwYXJzZTppbnZva2VGbihmb3JtYXR0ZXIucGFyc2UpCiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0KICAgIGZ1bmN0aW9uIGludm9rZUZuKGZuKXsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKHNlbGYsIGlucHV0KXsKICAgICAgICB2YXIgYXJncyA9IFtpbnB1dF07CiAgICAgICAgZm9yICggdmFyIGkgPSAwOyBpIDwgYXJnRm5zLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBhcmdzLnB1c2goYXJnRm5zW2ldKHNlbGYpKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZuLmFwcGx5KHNlbGYsIGFyZ3MpOwogICAgICB9OwogICAgfQogIH0KCiAgZnVuY3Rpb24gX3BpcGVGdW5jdGlvbihmblNjb3BlKXsKICAgIHZhciBmbiA9IGZ1bmN0aW9uSWRlbnQoZm5TY29wZSk7CiAgICB2YXIgYXJnc0ZuID0gW107CiAgICB2YXIgdG9rZW47CiAgICB3aGlsZSh0cnVlKSB7CiAgICAgIGlmICgodG9rZW4gPSBleHBlY3QoJzonKSkpIHsKICAgICAgICBhcmdzRm4ucHVzaChleHByZXNzaW9uKCkpOwogICAgICB9IGVsc2UgewogICAgICAgIHZhciBmbkludm9rZSA9IGZ1bmN0aW9uKHNlbGYsIGlucHV0KXsKICAgICAgICAgIHZhciBhcmdzID0gW2lucHV0XTsKICAgICAgICAgIGZvciAoIHZhciBpID0gMDsgaSA8IGFyZ3NGbi5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBhcmdzLnB1c2goYXJnc0ZuW2ldKHNlbGYpKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmbi5hcHBseShzZWxmLCBhcmdzKTsKICAgICAgICB9OwogICAgICAgIHJldHVybiBmdW5jdGlvbigpewogICAgICAgICAgcmV0dXJuIGZuSW52b2tlOwogICAgICAgIH07CiAgICAgIH0KICAgIH0KICB9CgogIGZ1bmN0aW9uIGV4cHJlc3Npb24oKXsKICAgIHJldHVybiBhc3NpZ25tZW50KCk7CiAgfQoKICBmdW5jdGlvbiBfYXNzaWdubWVudCgpewogICAgdmFyIGxlZnQgPSBsb2dpY2FsT1IoKTsKICAgIHZhciByaWdodDsKICAgIHZhciB0b2tlbjsKICAgIGlmICh0b2tlbiA9IGV4cGVjdCgnPScpKSB7CiAgICAgIGlmICghbGVmdC5hc3NpZ24pIHsKICAgICAgICB0aHJvd0Vycm9yKCJpbXBsaWVzIGFzc2lnbm1lbnQgYnV0IFsiICsKICAgICAgICAgIHRleHQuc3Vic3RyaW5nKDAsIHRva2VuLmluZGV4KSArICJdIGNhbiBub3QgYmUgYXNzaWduZWQgdG8iLCB0b2tlbik7CiAgICAgIH0KICAgICAgcmlnaHQgPSBsb2dpY2FsT1IoKTsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKHNlbGYpewogICAgICAgIHJldHVybiBsZWZ0LmFzc2lnbihzZWxmLCByaWdodChzZWxmKSk7CiAgICAgIH07CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gbGVmdDsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGxvZ2ljYWxPUigpewogICAgdmFyIGxlZnQgPSBsb2dpY2FsQU5EKCk7CiAgICB2YXIgdG9rZW47CiAgICB3aGlsZSh0cnVlKSB7CiAgICAgIGlmICgodG9rZW4gPSBleHBlY3QoJ3x8JykpKSB7CiAgICAgICAgbGVmdCA9IGJpbmFyeUZuKGxlZnQsIHRva2VuLmZuLCBsb2dpY2FsQU5EKCkpOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBsZWZ0OwogICAgICB9CiAgICB9CiAgfQoKICBmdW5jdGlvbiBsb2dpY2FsQU5EKCl7CiAgICB2YXIgbGVmdCA9IGVxdWFsaXR5KCk7CiAgICB2YXIgdG9rZW47CiAgICBpZiAoKHRva2VuID0gZXhwZWN0KCcmJicpKSkgewogICAgICBsZWZ0ID0gYmluYXJ5Rm4obGVmdCwgdG9rZW4uZm4sIGxvZ2ljYWxBTkQoKSk7CiAgICB9CiAgICByZXR1cm4gbGVmdDsKICB9CgogIGZ1bmN0aW9uIGVxdWFsaXR5KCl7CiAgICB2YXIgbGVmdCA9IHJlbGF0aW9uYWwoKTsKICAgIHZhciB0b2tlbjsKICAgIGlmICgodG9rZW4gPSBleHBlY3QoJz09JywnIT0nKSkpIHsKICAgICAgbGVmdCA9IGJpbmFyeUZuKGxlZnQsIHRva2VuLmZuLCBlcXVhbGl0eSgpKTsKICAgIH0KICAgIHJldHVybiBsZWZ0OwogIH0KCiAgZnVuY3Rpb24gcmVsYXRpb25hbCgpewogICAgdmFyIGxlZnQgPSBhZGRpdGl2ZSgpOwogICAgdmFyIHRva2VuOwogICAgaWYgKHRva2VuID0gZXhwZWN0KCc8JywgJz4nLCAnPD0nLCAnPj0nKSkgewogICAgICBsZWZ0ID0gYmluYXJ5Rm4obGVmdCwgdG9rZW4uZm4sIHJlbGF0aW9uYWwoKSk7CiAgICB9CiAgICByZXR1cm4gbGVmdDsKICB9CgogIGZ1bmN0aW9uIGFkZGl0aXZlKCl7CiAgICB2YXIgbGVmdCA9IG11bHRpcGxpY2F0aXZlKCk7CiAgICB2YXIgdG9rZW47CiAgICB3aGlsZSh0b2tlbiA9IGV4cGVjdCgnKycsJy0nKSkgewogICAgICBsZWZ0ID0gYmluYXJ5Rm4obGVmdCwgdG9rZW4uZm4sIG11bHRpcGxpY2F0aXZlKCkpOwogICAgfQogICAgcmV0dXJuIGxlZnQ7CiAgfQoKICBmdW5jdGlvbiBtdWx0aXBsaWNhdGl2ZSgpewogICAgdmFyIGxlZnQgPSB1bmFyeSgpOwogICAgdmFyIHRva2VuOwogICAgd2hpbGUodG9rZW4gPSBleHBlY3QoJyonLCcvJywnJScpKSB7CiAgICAgIGxlZnQgPSBiaW5hcnlGbihsZWZ0LCB0b2tlbi5mbiwgdW5hcnkoKSk7CiAgICB9CiAgICByZXR1cm4gbGVmdDsKICB9CgogIGZ1bmN0aW9uIHVuYXJ5KCl7CiAgICB2YXIgdG9rZW47CiAgICBpZiAoZXhwZWN0KCcrJykpIHsKICAgICAgcmV0dXJuIHByaW1hcnkoKTsKICAgIH0gZWxzZSBpZiAodG9rZW4gPSBleHBlY3QoJy0nKSkgewogICAgICByZXR1cm4gYmluYXJ5Rm4oWkVSTywgdG9rZW4uZm4sIHVuYXJ5KCkpOwogICAgfSBlbHNlIGlmICh0b2tlbiA9IGV4cGVjdCgnIScpKSB7CiAgICAgIHJldHVybiB1bmFyeUZuKHRva2VuLmZuLCB1bmFyeSgpKTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBwcmltYXJ5KCk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBfZnVuY3Rpb25JZGVudChmblNjb3BlKSB7CiAgICB2YXIgdG9rZW4gPSBleHBlY3QoKTsKICAgIHZhciBlbGVtZW50ID0gdG9rZW4udGV4dC5zcGxpdCgnLicpOwogICAgdmFyIGluc3RhbmNlID0gZm5TY29wZTsKICAgIHZhciBrZXk7CiAgICBmb3IgKCB2YXIgaSA9IDA7IGkgPCBlbGVtZW50Lmxlbmd0aDsgaSsrKSB7CiAgICAgIGtleSA9IGVsZW1lbnRbaV07CiAgICAgIGlmIChpbnN0YW5jZSkKICAgICAgICBpbnN0YW5jZSA9IGluc3RhbmNlW2tleV07CiAgICB9CiAgICBpZiAodHlwZW9mIGluc3RhbmNlICE9ICRmdW5jdGlvbikgewogICAgICB0aHJvd0Vycm9yKCJzaG91bGQgYmUgYSBmdW5jdGlvbiIsIHRva2VuKTsKICAgIH0KICAgIHJldHVybiBpbnN0YW5jZTsKICB9CgogIGZ1bmN0aW9uIHByaW1hcnkoKSB7CiAgICB2YXIgcHJpbWFyeTsKICAgIGlmIChleHBlY3QoJygnKSkgewogICAgICB2YXIgZXhwcmVzc2lvbiA9IGZpbHRlckNoYWluKCk7CiAgICAgIGNvbnN1bWUoJyknKTsKICAgICAgcHJpbWFyeSA9IGV4cHJlc3Npb247CiAgICB9IGVsc2UgaWYgKGV4cGVjdCgnWycpKSB7CiAgICAgIHByaW1hcnkgPSBhcnJheURlY2xhcmF0aW9uKCk7CiAgICB9IGVsc2UgaWYgKGV4cGVjdCgneycpKSB7CiAgICAgIHByaW1hcnkgPSBvYmplY3QoKTsKICAgIH0gZWxzZSB7CiAgICAgIHZhciB0b2tlbiA9IGV4cGVjdCgpOwogICAgICBwcmltYXJ5ID0gdG9rZW4uZm47CiAgICAgIGlmICghcHJpbWFyeSkgewogICAgICAgIHRocm93RXJyb3IoIm5vdCBhIHByaW1hcnkgZXhwcmVzc2lvbiIsIHRva2VuKTsKICAgICAgfQogICAgfQogICAgdmFyIG5leHQ7CiAgICB3aGlsZSAobmV4dCA9IGV4cGVjdCgnKCcsICdbJywgJy4nKSkgewogICAgICBpZiAobmV4dC50ZXh0ID09PSAnKCcpIHsKICAgICAgICBwcmltYXJ5ID0gZnVuY3Rpb25DYWxsKHByaW1hcnkpOwogICAgICB9IGVsc2UgaWYgKG5leHQudGV4dCA9PT0gJ1snKSB7CiAgICAgICAgcHJpbWFyeSA9IG9iamVjdEluZGV4KHByaW1hcnkpOwogICAgICB9IGVsc2UgaWYgKG5leHQudGV4dCA9PT0gJy4nKSB7CiAgICAgICAgcHJpbWFyeSA9IGZpZWxkQWNjZXNzKHByaW1hcnkpOwogICAgICB9IGVsc2UgewogICAgICAgIHRocm93RXJyb3IoIklNUE9TU0lCTEUiKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHByaW1hcnk7CiAgfQoKICBmdW5jdGlvbiBfZmllbGRBY2Nlc3Mob2JqZWN0KSB7CiAgICB2YXIgZmllbGQgPSBleHBlY3QoKS50ZXh0OwogICAgdmFyIGdldHRlciA9IGdldHRlckZuKGZpZWxkKTsKICAgIHJldHVybiBleHRlbmQoZnVuY3Rpb24gKHNlbGYpewogICAgICByZXR1cm4gZ2V0dGVyKG9iamVjdChzZWxmKSk7CiAgICB9LCB7CiAgICAgIGFzc2lnbjpmdW5jdGlvbihzZWxmLCB2YWx1ZSl7CiAgICAgICAgcmV0dXJuIHNldHRlcihvYmplY3Qoc2VsZiksIGZpZWxkLCB2YWx1ZSk7CiAgICAgIH0KICAgIH0pOwogIH0KCiAgZnVuY3Rpb24gX29iamVjdEluZGV4KG9iaikgewogICAgdmFyIGluZGV4Rm4gPSBleHByZXNzaW9uKCk7CiAgICBjb25zdW1lKCddJyk7CiAgICByZXR1cm4gZXh0ZW5kKAogICAgICBmdW5jdGlvbiAoc2VsZil7CiAgICAgICAgdmFyIG8gPSBvYmooc2VsZik7CiAgICAgICAgdmFyIGkgPSBpbmRleEZuKHNlbGYpOwogICAgICAgIHJldHVybiAobykgPyBvW2ldIDogdW5kZWZpbmVkOwogICAgICB9LCB7CiAgICAgICAgYXNzaWduOmZ1bmN0aW9uKHNlbGYsIHZhbHVlKXsKICAgICAgICAgIHJldHVybiBvYmooc2VsZilbaW5kZXhGbihzZWxmKV0gPSB2YWx1ZTsKICAgICAgICB9CiAgICAgIH0pOwogIH0KCiAgZnVuY3Rpb24gX2Z1bmN0aW9uQ2FsbChmbikgewogICAgdmFyIGFyZ3NGbiA9IFtdOwogICAgaWYgKHBlZWtUb2tlbigpLnRleHQgIT0gJyknKSB7CiAgICAgIGRvIHsKICAgICAgICBhcmdzRm4ucHVzaChleHByZXNzaW9uKCkpOwogICAgICB9IHdoaWxlIChleHBlY3QoJywnKSk7CiAgICB9CiAgICBjb25zdW1lKCcpJyk7CiAgICByZXR1cm4gZnVuY3Rpb24gKHNlbGYpewogICAgICB2YXIgYXJncyA9IFtdOwogICAgICBmb3IgKCB2YXIgaSA9IDA7IGkgPCBhcmdzRm4ubGVuZ3RoOyBpKyspIHsKICAgICAgICBhcmdzLnB1c2goYXJnc0ZuW2ldKHNlbGYpKTsKICAgICAgfQogICAgICB2YXIgZm5QdHIgPSBmbihzZWxmKSB8fCBub29wOwogICAgICAvLyBJRSBzdHVwaWRpdHkhCiAgICAgIHJldHVybiBmblB0ci5hcHBseQogICAgICAgICAgPyBmblB0ci5hcHBseShzZWxmLCBhcmdzKQogICAgICAgICAgOiBmblB0cihhcmdzWzBdLCBhcmdzWzFdLCBhcmdzWzJdLCBhcmdzWzNdLCBhcmdzWzRdKTsKICAgIH07CiAgfQoKICAvLyBUaGlzIGlzIHVzZWQgd2l0aCBqc29uIGFycmF5IGRlY2xhcmF0aW9uCiAgZnVuY3Rpb24gYXJyYXlEZWNsYXJhdGlvbiAoKSB7CiAgICB2YXIgZWxlbWVudEZucyA9IFtdOwogICAgaWYgKHBlZWtUb2tlbigpLnRleHQgIT0gJ10nKSB7CiAgICAgIGRvIHsKICAgICAgICBlbGVtZW50Rm5zLnB1c2goZXhwcmVzc2lvbigpKTsKICAgICAgfSB3aGlsZSAoZXhwZWN0KCcsJykpOwogICAgfQogICAgY29uc3VtZSgnXScpOwogICAgcmV0dXJuIGZ1bmN0aW9uIChzZWxmKXsKICAgICAgdmFyIGFycmF5ID0gW107CiAgICAgIGZvciAoIHZhciBpID0gMDsgaSA8IGVsZW1lbnRGbnMubGVuZ3RoOyBpKyspIHsKICAgICAgICBhcnJheS5wdXNoKGVsZW1lbnRGbnNbaV0oc2VsZikpOwogICAgICB9CiAgICAgIHJldHVybiBhcnJheTsKICAgIH07CiAgfQoKICBmdW5jdGlvbiBvYmplY3QgKCkgewogICAgdmFyIGtleVZhbHVlcyA9IFtdOwogICAgaWYgKHBlZWtUb2tlbigpLnRleHQgIT0gJ30nKSB7CiAgICAgIGRvIHsKICAgICAgICB2YXIgdG9rZW4gPSBleHBlY3QoKSwKICAgICAgICBrZXkgPSB0b2tlbi5zdHJpbmcgfHwgdG9rZW4udGV4dDsKICAgICAgICBjb25zdW1lKCI6Iik7CiAgICAgICAgdmFyIHZhbHVlID0gZXhwcmVzc2lvbigpOwogICAgICAgIGtleVZhbHVlcy5wdXNoKHtrZXk6a2V5LCB2YWx1ZTp2YWx1ZX0pOwogICAgICB9IHdoaWxlIChleHBlY3QoJywnKSk7CiAgICB9CiAgICBjb25zdW1lKCd9Jyk7CiAgICByZXR1cm4gZnVuY3Rpb24gKHNlbGYpewogICAgICB2YXIgb2JqZWN0ID0ge307CiAgICAgIGZvciAoIHZhciBpID0gMDsgaSA8IGtleVZhbHVlcy5sZW5ndGg7IGkrKykgewogICAgICAgIHZhciBrZXlWYWx1ZSA9IGtleVZhbHVlc1tpXTsKICAgICAgICB2YXIgdmFsdWUgPSBrZXlWYWx1ZS52YWx1ZShzZWxmKTsKICAgICAgICBvYmplY3Rba2V5VmFsdWUua2V5XSA9IHZhbHVlOwogICAgICB9CiAgICAgIHJldHVybiBvYmplY3Q7CiAgICB9OwogIH0KCiAgZnVuY3Rpb24gd2F0Y2hEZWNsICgpIHsKICAgIHZhciBhbmNob3JOYW1lID0gZXhwZWN0KCkudGV4dDsKICAgIGNvbnN1bWUoIjoiKTsKICAgIHZhciBleHByZXNzaW9uRm47CiAgICBpZiAocGVla1Rva2VuKCkudGV4dCA9PSAneycpIHsKICAgICAgY29uc3VtZSgieyIpOwogICAgICBleHByZXNzaW9uRm4gPSBzdGF0ZW1lbnRzKCk7CiAgICAgIGNvbnN1bWUoIn0iKTsKICAgIH0gZWxzZSB7CiAgICAgIGV4cHJlc3Npb25GbiA9IGV4cHJlc3Npb24oKTsKICAgIH0KICAgIHJldHVybiBmdW5jdGlvbihzZWxmKSB7CiAgICAgIHJldHVybiB7bmFtZTphbmNob3JOYW1lLCBmbjpleHByZXNzaW9uRm59OwogICAgfTsKICB9Cn0KCgoKJ3VzZSBzdHJpY3QnOwoKCgpmdW5jdGlvbiBSb3V0ZSh0ZW1wbGF0ZSwgZGVmYXVsdHMpIHsKICB0aGlzLnRlbXBsYXRlID0gdGVtcGxhdGUgPSB0ZW1wbGF0ZSArICcjJzsKICB0aGlzLmRlZmF1bHRzID0gZGVmYXVsdHMgfHwge307CiAgdmFyIHVybFBhcmFtcyA9IHRoaXMudXJsUGFyYW1zID0ge307CiAgZm9yRWFjaCh0ZW1wbGF0ZS5zcGxpdCgvXFcvKSwgZnVuY3Rpb24ocGFyYW0pewogICAgaWYgKHBhcmFtICYmIHRlbXBsYXRlLm1hdGNoKG5ldyBSZWdFeHAoIjoiICsgcGFyYW0gKyAiXFxXIikpKSB7CiAgICAgIHVybFBhcmFtc1twYXJhbV0gPSB0cnVlOwogICAgfQogIH0pOwp9CgpSb3V0ZS5wcm90b3R5cGUgPSB7CiAgdXJsOiBmdW5jdGlvbihwYXJhbXMpIHsKICAgIHZhciBzZWxmID0gdGhpcywKICAgICAgICB1cmwgPSB0aGlzLnRlbXBsYXRlLAogICAgICAgIGVuY29kZWRWYWw7CgogICAgcGFyYW1zID0gcGFyYW1zIHx8IHt9OwogICAgZm9yRWFjaCh0aGlzLnVybFBhcmFtcywgZnVuY3Rpb24oXywgdXJsUGFyYW0pewogICAgICBlbmNvZGVkVmFsID0gZW5jb2RlVXJpU2VnbWVudChwYXJhbXNbdXJsUGFyYW1dIHx8IHNlbGYuZGVmYXVsdHNbdXJsUGFyYW1dIHx8ICIiKTsKICAgICAgdXJsID0gdXJsLnJlcGxhY2UobmV3IFJlZ0V4cCgiOiIgKyB1cmxQYXJhbSArICIoXFxXKSIpLCBlbmNvZGVkVmFsICsgIiQxIik7CiAgICB9KTsKICAgIHVybCA9IHVybC5yZXBsYWNlKC9cLz8jJC8sICcnKTsKICAgIHZhciBxdWVyeSA9IFtdOwogICAgZm9yRWFjaFNvcnRlZChwYXJhbXMsIGZ1bmN0aW9uKHZhbHVlLCBrZXkpewogICAgICBpZiAoIXNlbGYudXJsUGFyYW1zW2tleV0pIHsKICAgICAgICBxdWVyeS5wdXNoKGVuY29kZVVyaVF1ZXJ5KGtleSkgKyAnPScgKyBlbmNvZGVVcmlRdWVyeSh2YWx1ZSkpOwogICAgICB9CiAgICB9KTsKICAgIHVybCA9IHVybC5yZXBsYWNlKC9cLyokLywgJycpOwogICAgcmV0dXJuIHVybCArIChxdWVyeS5sZW5ndGggPyAnPycgKyBxdWVyeS5qb2luKCcmJykgOiAnJyk7CiAgfQp9OwoKZnVuY3Rpb24gUmVzb3VyY2VGYWN0b3J5KHhocikgewogIHRoaXMueGhyID0geGhyOwp9CgpSZXNvdXJjZUZhY3RvcnkuREVGQVVMVF9BQ1RJT05TID0gewogICdnZXQnOiAgICB7bWV0aG9kOidHRVQnfSwKICAnc2F2ZSc6ICAge21ldGhvZDonUE9TVCd9LAogICdxdWVyeSc6ICB7bWV0aG9kOidHRVQnLCBpc0FycmF5OnRydWV9LAogICdyZW1vdmUnOiB7bWV0aG9kOidERUxFVEUnfSwKICAnZGVsZXRlJzoge21ldGhvZDonREVMRVRFJ30KfTsKClJlc291cmNlRmFjdG9yeS5wcm90b3R5cGUgPSB7CiAgcm91dGU6IGZ1bmN0aW9uKHVybCwgcGFyYW1EZWZhdWx0cywgYWN0aW9ucyl7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB2YXIgcm91dGUgPSBuZXcgUm91dGUodXJsKTsKICAgIGFjdGlvbnMgPSBleHRlbmQoe30sIFJlc291cmNlRmFjdG9yeS5ERUZBVUxUX0FDVElPTlMsIGFjdGlvbnMpOwogICAgZnVuY3Rpb24gZXh0cmFjdFBhcmFtcyhkYXRhKXsKICAgICAgdmFyIGlkcyA9IHt9OwogICAgICBmb3JFYWNoKHBhcmFtRGVmYXVsdHMgfHwge30sIGZ1bmN0aW9uKHZhbHVlLCBrZXkpewogICAgICAgIGlkc1trZXldID0gdmFsdWUuY2hhckF0ICYmIHZhbHVlLmNoYXJBdCgwKSA9PSAnQCcgPyBnZXR0ZXIoZGF0YSwgdmFsdWUuc3Vic3RyKDEpKSA6IHZhbHVlOwogICAgICB9KTsKICAgICAgcmV0dXJuIGlkczsKICAgIH0KCiAgICBmdW5jdGlvbiBSZXNvdXJjZSh2YWx1ZSl7CiAgICAgIGNvcHkodmFsdWUgfHwge30sIHRoaXMpOwogICAgfQoKICAgIGZvckVhY2goYWN0aW9ucywgZnVuY3Rpb24oYWN0aW9uLCBuYW1lKXsKICAgICAgdmFyIGlzUG9zdE9yUHV0ID0gYWN0aW9uLm1ldGhvZCA9PSAnUE9TVCcgfHwgYWN0aW9uLm1ldGhvZCA9PSAnUFVUJzsKICAgICAgUmVzb3VyY2VbbmFtZV0gPSBmdW5jdGlvbiAoYTEsIGEyLCBhMywgYTQpIHsKICAgICAgICB2YXIgcGFyYW1zID0ge307CiAgICAgICAgdmFyIGRhdGE7CiAgICAgICAgdmFyIHN1Y2Nlc3MgPSBub29wOwogICAgICAgIHZhciBlcnJvciA9IG51bGw7CiAgICAgICAgc3dpdGNoKGFyZ3VtZW50cy5sZW5ndGgpIHsKICAgICAgICBjYXNlIDQ6CiAgICAgICAgICBlcnJvciA9IGE0OwogICAgICAgICAgc3VjY2VzcyA9IGEzOwogICAgICAgICAgLy9mYWxsdGhyb3VnaAogICAgICAgIGNhc2UgMzoKICAgICAgICBjYXNlIDI6CiAgICAgICAgICBpZiAoaXNGdW5jdGlvbihhMikpIHsKICAgICAgICAgICAgaWYgKGlzRnVuY3Rpb24oYTEpKSB7CiAgICAgICAgICAgICAgc3VjY2VzcyA9IGExOwogICAgICAgICAgICAgIGVycm9yID0gYTI7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHN1Y2Nlc3MgPSBhMjsKICAgICAgICAgICAgZXJyb3IgPSBhMzsKICAgICAgICAgICAgLy9mYWxsdGhyb3VnaAogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcGFyYW1zID0gYTE7CiAgICAgICAgICAgIGRhdGEgPSBhMjsKICAgICAgICAgICAgc3VjY2VzcyA9IGEzOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICBjYXNlIDE6CiAgICAgICAgICBpZiAoaXNGdW5jdGlvbihhMSkpIHN1Y2Nlc3MgPSBhMTsKICAgICAgICAgIGVsc2UgaWYgKGlzUG9zdE9yUHV0KSBkYXRhID0gYTE7CiAgICAgICAgICBlbHNlIHBhcmFtcyA9IGExOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAwOiBicmVhazsKICAgICAgICBkZWZhdWx0OgogICAgICAgICAgdGhyb3cgIkV4cGVjdGVkIGJldHdlZW4gMC00IGFyZ3VtZW50cyBbcGFyYW1zLCBkYXRhLCBzdWNjZXNzLCBlcnJvcl0sIGdvdCAiICsKICAgICAgICAgICAgYXJndW1lbnRzLmxlbmd0aCArICIgYXJndW1lbnRzLiI7CiAgICAgICAgfQoKICAgICAgICB2YXIgdmFsdWUgPSB0aGlzIGluc3RhbmNlb2YgUmVzb3VyY2UgPyB0aGlzIDogKGFjdGlvbi5pc0FycmF5ID8gW10gOiBuZXcgUmVzb3VyY2UoZGF0YSkpOwogICAgICAgIHNlbGYueGhyKAogICAgICAgICAgYWN0aW9uLm1ldGhvZCwKICAgICAgICAgIHJvdXRlLnVybChleHRlbmQoe30sIGFjdGlvbi5wYXJhbXMgfHwge30sIGV4dHJhY3RQYXJhbXMoZGF0YSksIHBhcmFtcykpLAogICAgICAgICAgZGF0YSwKICAgICAgICAgIGZ1bmN0aW9uKHN0YXR1cywgcmVzcG9uc2UsIHJlc3BvbnNlSGVhZGVycykgewogICAgICAgICAgICBpZiAocmVzcG9uc2UpIHsKICAgICAgICAgICAgICBpZiAoYWN0aW9uLmlzQXJyYXkpIHsKICAgICAgICAgICAgICAgIHZhbHVlLmxlbmd0aCA9IDA7CiAgICAgICAgICAgICAgICBmb3JFYWNoKHJlc3BvbnNlLCBmdW5jdGlvbihpdGVtKSB7CiAgICAgICAgICAgICAgICAgIHZhbHVlLnB1c2gobmV3IFJlc291cmNlKGl0ZW0pKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjb3B5KHJlc3BvbnNlLCB2YWx1ZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIChzdWNjZXNzfHxub29wKSh2YWx1ZSwgcmVzcG9uc2VIZWFkZXJzKTsKICAgICAgICAgIH0sCiAgICAgICAgICBlcnJvciB8fCBhY3Rpb24udmVyaWZ5Q2FjaGUsCiAgICAgICAgICBhY3Rpb24udmVyaWZ5Q2FjaGUpOwogICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgfTsKCiAgICAgIFJlc291cmNlLmJpbmQgPSBmdW5jdGlvbihhZGRpdGlvbmFsUGFyYW1EZWZhdWx0cyl7CiAgICAgICAgcmV0dXJuIHNlbGYucm91dGUodXJsLCBleHRlbmQoe30sIHBhcmFtRGVmYXVsdHMsIGFkZGl0aW9uYWxQYXJhbURlZmF1bHRzKSwgYWN0aW9ucyk7CiAgICAgIH07CgogICAgICBSZXNvdXJjZS5wcm90b3R5cGVbJyQnICsgbmFtZV0gPSBmdW5jdGlvbihhMSwgYTIsIGEzKSB7CiAgICAgICAgdmFyIHBhcmFtcyA9IGV4dHJhY3RQYXJhbXModGhpcyksCiAgICAgICAgICAgIHN1Y2Nlc3MgPSBub29wLAogICAgICAgICAgICBlcnJvcjsKCiAgICAgICAgc3dpdGNoKGFyZ3VtZW50cy5sZW5ndGgpIHsKICAgICAgICBjYXNlIDM6IHBhcmFtcyA9IGExOyBzdWNjZXNzID0gYTI7IGVycm9yID0gYTM7IGJyZWFrOwogICAgICAgIGNhc2UgMjoKICAgICAgICBjYXNlIDE6CiAgICAgICAgICBpZiAoaXNGdW5jdGlvbihhMSkpIHsKICAgICAgICAgICAgc3VjY2VzcyA9IGExOwogICAgICAgICAgICBlcnJvciA9IGEyOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcGFyYW1zID0gYTE7CiAgICAgICAgICAgIHN1Y2Nlc3MgPSBhMiB8fCBub29wOwogICAgICAgICAgfQogICAgICAgIGNhc2UgMDogYnJlYWs7CiAgICAgICAgZGVmYXVsdDoKICAgICAgICAgIHRocm93ICJFeHBlY3RlZCBiZXR3ZWVuIDEtMyBhcmd1bWVudHMgW3BhcmFtcywgc3VjY2VzcywgZXJyb3JdLCBnb3QgIiArCiAgICAgICAgICAgIGFyZ3VtZW50cy5sZW5ndGggKyAiIGFyZ3VtZW50cy4iOwogICAgICAgIH0KICAgICAgICB2YXIgZGF0YSA9IGlzUG9zdE9yUHV0ID8gdGhpcyA6IHVuZGVmaW5lZDsKICAgICAgICBSZXNvdXJjZVtuYW1lXS5jYWxsKHRoaXMsIHBhcmFtcywgZGF0YSwgc3VjY2VzcywgZXJyb3IpOwogICAgICB9OwogICAgfSk7CiAgICByZXR1cm4gUmVzb3VyY2U7CiAgfQp9OwondXNlIHN0cmljdCc7CgovLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KLy8gQnJvd3NlcgovLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KdmFyIFhIUiA9IHdpbmRvdy5YTUxIdHRwUmVxdWVzdCB8fCBmdW5jdGlvbiAoKSB7CiAgdHJ5IHsgcmV0dXJuIG5ldyBBY3RpdmVYT2JqZWN0KCJNc3htbDIuWE1MSFRUUC42LjAiKTsgfSBjYXRjaCAoZTEpIHt9CiAgdHJ5IHsgcmV0dXJuIG5ldyBBY3RpdmVYT2JqZWN0KCJNc3htbDIuWE1MSFRUUC4zLjAiKTsgfSBjYXRjaCAoZTIpIHt9CiAgdHJ5IHsgcmV0dXJuIG5ldyBBY3RpdmVYT2JqZWN0KCJNc3htbDIuWE1MSFRUUCIpOyB9IGNhdGNoIChlMykge30KICB0aHJvdyBuZXcgRXJyb3IoIlRoaXMgYnJvd3NlciBkb2VzIG5vdCBzdXBwb3J0IFhNTEh0dHBSZXF1ZXN0LiIpOwp9OwoKCi8qKgogKiBAbmdkb2Mgc2VydmljZQogKiBAbmFtZSBhbmd1bGFyLnNlcnZpY2UuJGJyb3dzZXIKICogQHJlcXVpcmVzICRsb2cKICoKICogQGRlc2NyaXB0aW9uCiAqIENvbnN0cnVjdG9yIGZvciB0aGUgb2JqZWN0IGV4cG9zZWQgYXMgJGJyb3dzZXIgc2VydmljZS4KICoKICogVGhpcyBvYmplY3QgaGFzIHR3byBnb2FsczoKICoKICogLSBoaWRlIGFsbCB0aGUgZ2xvYmFsIHN0YXRlIGluIHRoZSBicm93c2VyIGNhdXNlZCBieSB0aGUgd2luZG93IG9iamVjdAogKiAtIGFic3RyYWN0IGF3YXkgYWxsIHRoZSBicm93c2VyIHNwZWNpZmljIGZlYXR1cmVzIGFuZCBpbmNvbnNpc3RlbmNpZXMKICoKICogRm9yIHRlc3RzIHdlIHByb3ZpZGUge0BsaW5rIGFuZ3VsYXIubW9jay5zZXJ2aWNlLiRicm93c2VyIG1vY2sgaW1wbGVtZW50YXRpb259IG9mIHRoZSBgJGJyb3dzZXJgCiAqIHNlcnZpY2UsIHdoaWNoIGNhbiBiZSB1c2VkIGZvciBjb252ZW5pZW50IHRlc3Rpbmcgb2YgdGhlIGFwcGxpY2F0aW9uIHdpdGhvdXQgdGhlIGludGVyYWN0aW9uIHdpdGgKICogdGhlIHJlYWwgYnJvd3NlciBhcGlzLgogKi8KLyoqCiAqIEBwYXJhbSB7b2JqZWN0fSB3aW5kb3cgVGhlIGdsb2JhbCB3aW5kb3cgb2JqZWN0LgogKiBAcGFyYW0ge29iamVjdH0gZG9jdW1lbnQgalF1ZXJ5IHdyYXBwZWQgZG9jdW1lbnQuCiAqIEBwYXJhbSB7b2JqZWN0fSBib2R5IGpRdWVyeSB3cmFwcGVkIGRvY3VtZW50LmJvZHkuCiAqIEBwYXJhbSB7ZnVuY3Rpb24oKX0gWEhSIFhNTEh0dHBSZXF1ZXN0IGNvbnN0cnVjdG9yLgogKiBAcGFyYW0ge29iamVjdH0gJGxvZyBjb25zb2xlLmxvZyBvciBhbiBvYmplY3Qgd2l0aCB0aGUgc2FtZSBpbnRlcmZhY2UuCiAqLwpmdW5jdGlvbiBCcm93c2VyKHdpbmRvdywgZG9jdW1lbnQsIGJvZHksIFhIUiwgJGxvZykgewogIHZhciBzZWxmID0gdGhpcywKICAgICAgcmF3RG9jdW1lbnQgPSBkb2N1bWVudFswXSwKICAgICAgbG9jYXRpb24gPSB3aW5kb3cubG9jYXRpb24sCiAgICAgIHNldFRpbWVvdXQgPSB3aW5kb3cuc2V0VGltZW91dCwKICAgICAgY2xlYXJUaW1lb3V0ID0gd2luZG93LmNsZWFyVGltZW91dCwKICAgICAgcGVuZGluZ0RlZmVySWRzID0ge30sCiAgICAgIGxhc3RMb2NhdGlvblVybDsKCiAgc2VsZi5pc01vY2sgPSBmYWxzZTsKCiAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICAvLyBYSFIgQVBJCiAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICB2YXIgaWRDb3VudGVyID0gMDsKICB2YXIgb3V0c3RhbmRpbmdSZXF1ZXN0Q291bnQgPSAwOwogIHZhciBvdXRzdGFuZGluZ1JlcXVlc3RDYWxsYmFja3MgPSBbXTsKCgogIC8qKgogICAqIEV4ZWN1dGVzIHRoZSBgZm5gIGZ1bmN0aW9uIChzdXBwb3J0cyBjdXJyeWluZykgYW5kIGRlY3JlbWVudHMgdGhlIGBvdXRzdGFuZGluZ1JlcXVlc3RDYWxsYmFja3NgCiAgICogY291bnRlci4gSWYgdGhlIGNvdW50ZXIgcmVhY2hlcyAwLCBhbGwgdGhlIGBvdXRzdGFuZGluZ1JlcXVlc3RDYWxsYmFja3NgIGFyZSBleGVjdXRlZC4KICAgKi8KICBmdW5jdGlvbiBjb21wbGV0ZU91dHN0YW5kaW5nUmVxdWVzdChmbikgewogICAgdHJ5IHsKICAgICAgZm4uYXBwbHkobnVsbCwgc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpKTsKICAgIH0gZmluYWxseSB7CiAgICAgIG91dHN0YW5kaW5nUmVxdWVzdENvdW50LS07CiAgICAgIGlmIChvdXRzdGFuZGluZ1JlcXVlc3RDb3VudCA9PT0gMCkgewogICAgICAgIHdoaWxlKG91dHN0YW5kaW5nUmVxdWVzdENhbGxiYWNrcy5sZW5ndGgpIHsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIG91dHN0YW5kaW5nUmVxdWVzdENhbGxiYWNrcy5wb3AoKSgpOwogICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAkbG9nLmVycm9yKGUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQogIH0KCiAgLyoqCiAgICogQHdvcmtJblByb2dyZXNzCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lIGFuZ3VsYXIuc2VydmljZS4kYnJvd3NlciN4aHIKICAgKiBAbWV0aG9kT2YgYW5ndWxhci5zZXJ2aWNlLiRicm93c2VyCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gbWV0aG9kIFJlcXVlc3RlZCBtZXRob2QgKGdldHxwb3N0fHB1dHxkZWxldGV8aGVhZHxqc29uKQogICAqIEBwYXJhbSB7c3RyaW5nfSB1cmwgUmVxdWVzdGVkIHVybAogICAqIEBwYXJhbSB7P3N0cmluZ30gcG9zdCBQb3N0IGRhdGEgdG8gc2VuZCAobnVsbCBpZiBub3RoaW5nIHRvIHBvc3QpCiAgICogQHBhcmFtIHtmdW5jdGlvbihudW1iZXIsIHN0cmluZywgZnVuY3Rpb24oW3N0cmluZ10pKX0gY2FsbGJhY2sgRnVuY3Rpb24gdGhhdCB3aWxsIGJlIGNhbGxlZCBvbgogICAqICAgcmVzcG9uc2UuIFRoZSB0aGlyZCBhcmd1bWVudCBpcyBhIGZ1bmN0aW9uIHRoYXQgY2FuIGJlIGNhbGxlZCB0byByZXR1cm4gYSBzcGVjaWZpZWQgcmVzcG9uc2UKICAgKiAgIGhlYWRlciBvciBhbiBPYmplY3QgY29udGFpbmluZyBhbGwgaGVhZGVycyAod2hlbiBjYWxsZWQgd2l0aCBubyBhcmd1bWVudHMpLgogICAqIEBwYXJhbSB7b2JqZWN0PX0gaGVhZGVyIGFkZGl0aW9uYWwgSFRUUCBoZWFkZXJzIHRvIHNlbmQgd2l0aCBYSFIuCiAgICogICBTdGFuZGFyZCBoZWFkZXJzIGFyZToKICAgKiAgIDx1bD4KICAgKiAgICAgPGxpPjx0dD5Db250ZW50LVR5cGU8L3R0PjogPHR0PmFwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZDwvdHQ+PC9saT4KICAgKiAgICAgPGxpPjx0dD5BY2NlcHQ8L3R0PjogPHR0PmFwcGxpY2F0aW9uL2pzb24sIHRleHQvcGxhaW4sICYjNDI7LyYjNDI7PC90dD48L2xpPgogICAqICAgICA8bGk+PHR0PlgtUmVxdWVzdGVkLVdpdGg8L3R0PjogPHR0PlhNTEh0dHBSZXF1ZXN0PC90dD48L2xpPgogICAqICAgPC91bD4KICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFNlbmQgYWpheCByZXF1ZXN0CiAgICovCiAgc2VsZi54aHIgPSBmdW5jdGlvbihtZXRob2QsIHVybCwgcG9zdCwgY2FsbGJhY2ssIGhlYWRlcnMpIHsKICAgIHZhciBwYXJzZWRIZWFkZXJzOwoKICAgIG91dHN0YW5kaW5nUmVxdWVzdENvdW50ICsrOwogICAgaWYgKGxvd2VyY2FzZShtZXRob2QpID09ICdqc29uJykgewogICAgICB2YXIgY2FsbGJhY2tJZCA9ICgiYW5ndWxhcl8iICsgTWF0aC5yYW5kb20oKSArICdfJyArIChpZENvdW50ZXIrKykpLnJlcGxhY2UoL1xkXC4vLCAnJyk7CiAgICAgIHdpbmRvd1tjYWxsYmFja0lkXSA9IGZ1bmN0aW9uKGRhdGEpIHsKICAgICAgICB3aW5kb3dbY2FsbGJhY2tJZF0uZGF0YSA9IGRhdGE7CiAgICAgIH07CgogICAgICB2YXIgc2NyaXB0ID0gc2VsZi5hZGRKcyh1cmwucmVwbGFjZSgnSlNPTl9DQUxMQkFDSycsIGNhbGxiYWNrSWQpLCBudWxsLCBmdW5jdGlvbigpIHsKICAgICAgICBpZiAod2luZG93W2NhbGxiYWNrSWRdLmRhdGEpIHsKICAgICAgICAgIGNvbXBsZXRlT3V0c3RhbmRpbmdSZXF1ZXN0KGNhbGxiYWNrLCAyMDAsIHdpbmRvd1tjYWxsYmFja0lkXS5kYXRhKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY29tcGxldGVPdXRzdGFuZGluZ1JlcXVlc3QoY2FsbGJhY2spOwogICAgICAgIH0KICAgICAgICBkZWxldGUgd2luZG93W2NhbGxiYWNrSWRdOwogICAgICAgIGJvZHlbMF0ucmVtb3ZlQ2hpbGQoc2NyaXB0KTsKICAgICAgfSk7CiAgICB9IGVsc2UgewogICAgICB2YXIgeGhyID0gbmV3IFhIUigpOwogICAgICB4aHIub3BlbihtZXRob2QsIHVybCwgdHJ1ZSk7CiAgICAgIGZvckVhY2goaGVhZGVycywgZnVuY3Rpb24odmFsdWUsIGtleSkgewogICAgICAgICAgaWYgKHZhbHVlKSB4aHIuc2V0UmVxdWVzdEhlYWRlcihrZXksIHZhbHVlKTsKICAgICAgfSk7CiAgICAgIHhoci5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBmdW5jdGlvbigpIHsKICAgICAgICBpZiAoeGhyLnJlYWR5U3RhdGUgPT0gNCkgewogICAgICAgICAgLy8gbm9ybWFsaXplIElFIGJ1ZyAoaHR0cDovL2J1Z3MuanF1ZXJ5LmNvbS90aWNrZXQvMTQ1MCkKICAgICAgICAgIHZhciBzdGF0dXMgPSB4aHIuc3RhdHVzID09IDEyMjMgPyAyMDQgOiB4aHIuc3RhdHVzIHx8IDIwMDsKICAgICAgICAgIGNvbXBsZXRlT3V0c3RhbmRpbmdSZXF1ZXN0KGNhbGxiYWNrLCBzdGF0dXMsIHhoci5yZXNwb25zZVRleHQsIGZ1bmN0aW9uKGhlYWRlcikgewogICAgICAgICAgICBoZWFkZXIgPSBsb3dlcmNhc2UoaGVhZGVyKTsKCiAgICAgICAgICAgIGlmIChoZWFkZXIpIHsKICAgICAgICAgICAgICByZXR1cm4gcGFyc2VkSGVhZGVycwogICAgICAgICAgICAgICAgPyBwYXJzZWRIZWFkZXJzW2hlYWRlcl0gfHwgbnVsbAogICAgICAgICAgICAgICAgOiB4aHIuZ2V0UmVzcG9uc2VIZWFkZXIoaGVhZGVyKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAvLyBSZXR1cm4gYW4gb2JqZWN0IGNvbnRhaW5pbmcgZWFjaCByZXNwb25zZSBoZWFkZXIKICAgICAgICAgICAgICBwYXJzZWRIZWFkZXJzID0ge307CgogICAgICAgICAgICAgIGZvckVhY2goeGhyLmdldEFsbFJlc3BvbnNlSGVhZGVycygpLnNwbGl0KCdcbicpLCBmdW5jdGlvbihsaW5lKSB7CiAgICAgICAgICAgICAgICB2YXIgaSA9IGxpbmUuaW5kZXhPZignOicpLAogICAgICAgICAgICAgICAgICAgIGtleSA9IGxvd2VyY2FzZSh0cmltKGxpbmUuc3Vic3RyKDAsIGkpKSksCiAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSB0cmltKGxpbmUuc3Vic3RyKGkgKyAxKSk7CgogICAgICAgICAgICAgICAgaWYgKHBhcnNlZEhlYWRlcnNba2V5XSkgewogICAgICAgICAgICAgICAgICAvLyBDb21iaW5lIHJlcGVhdGVkIGhlYWRlcnMKICAgICAgICAgICAgICAgICAgLy8gaHR0cDovL3d3dy53My5vcmcvUHJvdG9jb2xzL3JmYzI2MTYvcmZjMjYxNi1zZWM0Lmh0bWwjc2VjNC4yCiAgICAgICAgICAgICAgICAgIHBhcnNlZEhlYWRlcnNba2V5XSArPSAnLCAnICsgdmFsdWU7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBwYXJzZWRIZWFkZXJzW2tleV0gPSB2YWx1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgcmV0dXJuIHBhcnNlZEhlYWRlcnM7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfTsKICAgICAgeGhyLnNlbmQocG9zdCB8fCAnJyk7CiAgICB9CiAgfTsKCiAgLyoqCiAgICogQHByaXZhdGUKICAgKiBOb3RlOiB0aGlzIG1ldGhvZCBpcyB1c2VkIG9ubHkgYnkgc2NlbmFyaW8gcnVubmVyCiAgICogVE9ETyh2b2p0YSk6IHByZWZpeCB0aGlzIG1ldGhvZCB3aXRoICQkID8KICAgKiBAcGFyYW0ge2Z1bmN0aW9uKCl9IGNhbGxiYWNrIEZ1bmN0aW9uIHRoYXQgd2lsbCBiZSBjYWxsZWQgd2hlbiBubyBvdXRzdGFuZGluZyByZXF1ZXN0CiAgICovCiAgc2VsZi5ub3RpZnlXaGVuTm9PdXRzdGFuZGluZ1JlcXVlc3RzID0gZnVuY3Rpb24oY2FsbGJhY2spIHsKICAgIC8vIGZvcmNlIGJyb3dzZXIgdG8gZXhlY3V0ZSBhbGwgcG9sbEZucyAtIHRoaXMgaXMgbmVlZGVkIHNvIHRoYXQgY29va2llcyBhbmQgb3RoZXIgcG9sbGVycyBmaXJlCiAgICAvLyBhdCBzb21lIGRldGVybWluaXN0aWMgdGltZSBpbiByZXNwZWN0IHRvIHRoZSB0ZXN0IHJ1bm5lcidzIGFjdGlvbnMuIExlYXZpbmcgdGhpbmdzIHVwIHRvIHRoZQogICAgLy8gcmVndWxhciBwb2xsZXIgd291bGQgcmVzdWx0IGluIGZsYWt5IHRlc3RzLgogICAgZm9yRWFjaChwb2xsRm5zLCBmdW5jdGlvbihwb2xsRm4peyBwb2xsRm4oKTsgfSk7CgogICAgaWYgKG91dHN0YW5kaW5nUmVxdWVzdENvdW50ID09PSAwKSB7CiAgICAgIGNhbGxiYWNrKCk7CiAgICB9IGVsc2UgewogICAgICBvdXRzdGFuZGluZ1JlcXVlc3RDYWxsYmFja3MucHVzaChjYWxsYmFjayk7CiAgICB9CiAgfTsKCiAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICAvLyBQb2xsIFdhdGNoZXIgQVBJCiAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICB2YXIgcG9sbEZucyA9IFtdLAogICAgICBwb2xsVGltZW91dDsKCiAgLyoqCiAgICogQHdvcmtJblByb2dyZXNzCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lIGFuZ3VsYXIuc2VydmljZS4kYnJvd3NlciNhZGRQb2xsRm4KICAgKiBAbWV0aG9kT2YgYW5ndWxhci5zZXJ2aWNlLiRicm93c2VyCiAgICoKICAgKiBAcGFyYW0ge2Z1bmN0aW9uKCl9IGZuIFBvbGwgZnVuY3Rpb24gdG8gYWRkCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBBZGRzIGEgZnVuY3Rpb24gdG8gdGhlIGxpc3Qgb2YgZnVuY3Rpb25zIHRoYXQgcG9sbGVyIHBlcmlvZGljYWxseSBleGVjdXRlcywKICAgKiBhbmQgc3RhcnRzIHBvbGxpbmcgaWYgbm90IHN0YXJ0ZWQgeWV0LgogICAqCiAgICogQHJldHVybnMge2Z1bmN0aW9uKCl9IHRoZSBhZGRlZCBmdW5jdGlvbgogICAqLwogIHNlbGYuYWRkUG9sbEZuID0gZnVuY3Rpb24oZm4pIHsKICAgIGlmIChpc1VuZGVmaW5lZChwb2xsVGltZW91dCkpIHN0YXJ0UG9sbGVyKDEwMCwgc2V0VGltZW91dCk7CiAgICBwb2xsRm5zLnB1c2goZm4pOwogICAgcmV0dXJuIGZuOwogIH07CgogIC8qKgogICAqIEBwYXJhbSB7bnVtYmVyfSBpbnRlcnZhbCBIb3cgb2Z0ZW4gc2hvdWxkIGJyb3dzZXIgY2FsbCBwb2xsIGZ1bmN0aW9ucyAobXMpCiAgICogQHBhcmFtIHtmdW5jdGlvbigpfSBzZXRUaW1lb3V0IFJlZmVyZW5jZSB0byBhIHJlYWwgb3IgZmFrZSBgc2V0VGltZW91dGAgZnVuY3Rpb24uCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBDb25maWd1cmVzIHRoZSBwb2xsZXIgdG8gcnVuIGluIHRoZSBzcGVjaWZpZWQgaW50ZXJ2YWxzLCB1c2luZyB0aGUgc3BlY2lmaWVkCiAgICogc2V0VGltZW91dCBmbiBhbmQga2lja3MgaXQgb2ZmLgogICAqLwogIGZ1bmN0aW9uIHN0YXJ0UG9sbGVyKGludGVydmFsLCBzZXRUaW1lb3V0KSB7CiAgICAoZnVuY3Rpb24gY2hlY2soKSB7CiAgICAgIGZvckVhY2gocG9sbEZucywgZnVuY3Rpb24ocG9sbEZuKXsgcG9sbEZuKCk7IH0pOwogICAgICBwb2xsVGltZW91dCA9IHNldFRpbWVvdXQoY2hlY2ssIGludGVydmFsKTsKICAgIH0pKCk7CiAgfTsKCiAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICAvLyBVUkwgQVBJCiAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KCiAgLyoqCiAgICogQHdvcmtJblByb2dyZXNzCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lIGFuZ3VsYXIuc2VydmljZS4kYnJvd3NlciNzZXRVcmwKICAgKiBAbWV0aG9kT2YgYW5ndWxhci5zZXJ2aWNlLiRicm93c2VyCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gdXJsIE5ldyB1cmwKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFNldHMgYnJvd3NlcidzIHVybAogICAqLwogIHNlbGYuc2V0VXJsID0gZnVuY3Rpb24odXJsKSB7CgogICAgdmFyIGV4aXN0aW5nVVJMID0gbGFzdExvY2F0aW9uVXJsOwogICAgaWYgKCFleGlzdGluZ1VSTC5tYXRjaCgvIy8pKSBleGlzdGluZ1VSTCArPSAnIyc7CiAgICBpZiAoIXVybC5tYXRjaCgvIy8pKSB1cmwgKz0gJyMnOwogICAgaWYgKGV4aXN0aW5nVVJMICE9IHVybCkgewogICAgICBsb2NhdGlvbi5ocmVmID0gdXJsOwogICAgfQogICB9OwoKICAvKioKICAgKiBAd29ya0luUHJvZ3Jlc3MKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgYW5ndWxhci5zZXJ2aWNlLiRicm93c2VyI2dldFVybAogICAqIEBtZXRob2RPZiBhbmd1bGFyLnNlcnZpY2UuJGJyb3dzZXIKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIEdldCBjdXJyZW50IGJyb3dzZXIncyB1cmwKICAgKgogICAqIEByZXR1cm5zIHtzdHJpbmd9IEJyb3dzZXIncyB1cmwKICAgKi8KICBzZWxmLmdldFVybCA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIGxhc3RMb2NhdGlvblVybCA9IGxvY2F0aW9uLmhyZWY7CiAgfTsKCgogIC8qKgogICAqIEB3b3JrSW5Qcm9ncmVzcwogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSBhbmd1bGFyLnNlcnZpY2UuJGJyb3dzZXIjb25IYXNoQ2hhbmdlCiAgICogQG1ldGhvZE9mIGFuZ3VsYXIuc2VydmljZS4kYnJvd3NlcgogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogRGV0ZWN0cyBpZiBicm93c2VyIHN1cHBvcnQgb25oYXNoY2hhbmdlIGV2ZW50cyBhbmQgcmVnaXN0ZXIgYSBsaXN0ZW5lciBvdGhlcndpc2UgcmVnaXN0ZXJzCiAgICogJGJyb3dzZXIgcG9sbGVyLiBUaGUgYGxpc3RlbmVyYCB3aWxsIHRoZW4gZ2V0IGNhbGxlZCB3aGVuIHRoZSBoYXNoIGNoYW5nZXMuCiAgICoKICAgKiBUaGUgbGlzdGVuZXIgZ2V0cyBjYWxsZWQgd2l0aCBlaXRoZXIgSGFzaENoYW5nZUV2ZW50IG9iamVjdCBvciBzaW1wbGUgb2JqZWN0IHRoYXQgYWxzbyBjb250YWlucwogICAqIGBvbGRVUkxgIGFuZCBgbmV3VVJMYCBwcm9wZXJ0aWVzLgogICAqCiAgICogTm90ZTogdGhpcyBhcGkgaXMgaW50ZW5kZWQgZm9yIHVzZSBvbmx5IGJ5IHRoZSAkbG9jYXRpb24gc2VydmljZS4gUGxlYXNlIHVzZSB0aGUKICAgKiB7QGxpbmsgYW5ndWxhci5zZXJ2aWNlLiRsb2NhdGlvbiAkbG9jYXRpb24gc2VydmljZX0gdG8gbW9uaXRvciBoYXNoIGNoYW5nZXMgaW4gYW5ndWxhciBhcHBzLgogICAqCiAgICogQHBhcmFtIHtmdW5jdGlvbihldmVudCl9IGxpc3RlbmVyIExpc3RlbmVyIGZ1bmN0aW9uIHRvIGJlIGNhbGxlZCB3aGVuIHVybCBoYXNoIGNoYW5nZXMuCiAgICogQHJldHVybiB7ZnVuY3Rpb24oKX0gUmV0dXJucyB0aGUgcmVnaXN0ZXJlZCBsaXN0ZW5lciBmbiAtIGhhbmR5IGlmIHRoZSBmbiBpcyBhbm9ueW1vdXMuCiAgICovCiAgc2VsZi5vbkhhc2hDaGFuZ2UgPSBmdW5jdGlvbihsaXN0ZW5lcikgewogICAgLy8gSUU4IGNvbXAgbW9kZSByZXR1cm5zIHRydWUsIGJ1dCBkb2Vzbid0IHN1cHBvcnQgaGFzaGNoYW5nZSBldmVudAogICAgdmFyIGRtID0gd2luZG93LmRvY3VtZW50LmRvY3VtZW50TW9kZTsKICAgIGlmICgnb25oYXNoY2hhbmdlJyBpbiB3aW5kb3cgJiYgKGlzVW5kZWZpbmVkKGRtKSB8fCBkbSA+PSA4KSkgewogICAgICBqcUxpdGUod2luZG93KS5iaW5kKCdoYXNoY2hhbmdlJywgbGlzdGVuZXIpOwogICAgfSBlbHNlIHsKICAgICAgdmFyIGxhc3RCcm93c2VyVXJsID0gc2VsZi5nZXRVcmwoKTsKCiAgICAgIHNlbGYuYWRkUG9sbEZuKGZ1bmN0aW9uKCkgewogICAgICAgIGlmIChsYXN0QnJvd3NlclVybCAhPSBzZWxmLmdldFVybCgpKSB7CiAgICAgICAgICBsaXN0ZW5lcigpOwogICAgICAgICAgbGFzdEJyb3dzZXJVcmwgPSBzZWxmLmdldFVybCgpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgICByZXR1cm4gbGlzdGVuZXI7CiAgfTsKCiAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICAvLyBDb29raWVzIEFQSQogIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgdmFyIGxhc3RDb29raWVzID0ge307CiAgdmFyIGxhc3RDb29raWVTdHJpbmcgPSAnJzsKCiAgLyoqCiAgICogQHdvcmtJblByb2dyZXNzCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lIGFuZ3VsYXIuc2VydmljZS4kYnJvd3NlciNjb29raWVzCiAgICogQG1ldGhvZE9mIGFuZ3VsYXIuc2VydmljZS4kYnJvd3NlcgogICAqCiAgICogQHBhcmFtIHtzdHJpbmc9fSBuYW1lIENvb2tpZSBuYW1lCiAgICogQHBhcmFtIHtzdHJpbmc9fSB2YWx1ZSBDb2traWUgdmFsdWUKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFRoZSBjb29raWVzIG1ldGhvZCBwcm92aWRlcyBhICdwcml2YXRlJyBsb3cgbGV2ZWwgYWNjZXNzIHRvIGJyb3dzZXIgY29va2llcy4KICAgKiBJdCBpcyBub3QgbWVhbnQgdG8gYmUgdXNlZCBkaXJlY3RseSwgdXNlIHRoZSAkY29va2llIHNlcnZpY2UgaW5zdGVhZC4KICAgKgogICAqIFRoZSByZXR1cm4gdmFsdWVzIHZhcnkgZGVwZW5kaW5nIG9uIHRoZSBhcmd1bWVudHMgdGhhdCB0aGUgbWV0aG9kIHdhcyBjYWxsZWQgd2l0aCBhcyBmb2xsb3dzOgogICAqIDx1bD4KICAgKiAgIDxsaT5jb29raWVzKCkgLT4gaGFzaCBvZiBhbGwgY29va2llcywgdGhpcyBpcyBOT1QgYSBjb3B5IG9mIHRoZSBpbnRlcm5hbCBzdGF0ZSwgc28gZG8gbm90IG1vZGlmeSBpdDwvbGk+CiAgICogICA8bGk+Y29va2llcyhuYW1lLCB2YWx1ZSkgLT4gc2V0IG5hbWUgdG8gdmFsdWUsIGlmIHZhbHVlIGlzIHVuZGVmaW5lZCBkZWxldGUgdGhlIGNvb2tpZTwvbGk+CiAgICogICA8bGk+Y29va2llcyhuYW1lKSAtPiB0aGUgc2FtZSBhcyAobmFtZSwgdW5kZWZpbmVkKSA9PSBERUxFVEVTIChubyBvbmUgY2FsbHMgaXQgcmlnaHQgbm93IHRoYXQgd2F5KTwvbGk+CiAgICogPC91bD4KICAgKgogICAqIEByZXR1cm5zIHtPYmplY3R9IEhhc2ggb2YgYWxsIGNvb2tpZXMgKGlmIGNhbGxlZCB3aXRob3V0IGFueSBwYXJhbWV0ZXIpCiAgICovCiAgc2VsZi5jb29raWVzID0gZnVuY3Rpb24gKG5hbWUsIHZhbHVlKSB7CiAgICB2YXIgY29va2llTGVuZ3RoLCBjb29raWVBcnJheSwgY29va2llLCBpLCBrZXlWYWx1ZSwgaW5kZXg7CgogICAgaWYgKG5hbWUpIHsKICAgICAgaWYgKHZhbHVlID09PSB1bmRlZmluZWQpIHsKICAgICAgICByYXdEb2N1bWVudC5jb29raWUgPSBlc2NhcGUobmFtZSkgKyAiPTtleHBpcmVzPVRodSwgMDEgSmFuIDE5NzAgMDA6MDA6MDAgR01UIjsKICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAoaXNTdHJpbmcodmFsdWUpKSB7CiAgICAgICAgICByYXdEb2N1bWVudC5jb29raWUgPSBlc2NhcGUobmFtZSkgKyAnPScgKyBlc2NhcGUodmFsdWUpOwoKICAgICAgICAgIGNvb2tpZUxlbmd0aCA9IG5hbWUubGVuZ3RoICsgdmFsdWUubGVuZ3RoICsgMTsKICAgICAgICAgIGlmIChjb29raWVMZW5ndGggPiA0MDk2KSB7CiAgICAgICAgICAgICRsb2cud2FybigiQ29va2llICciKyBuYW1lICsiJyBwb3NzaWJseSBub3Qgc2V0IG9yIG92ZXJmbG93ZWQgYmVjYXVzZSBpdCB3YXMgdG9vIGxhcmdlICgiKwogICAgICAgICAgICAgIGNvb2tpZUxlbmd0aCArICIgPiA0MDk2IGJ5dGVzKSEiKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChsYXN0Q29va2llcy5sZW5ndGggPiAyMCkgewogICAgICAgICAgICAkbG9nLndhcm4oIkNvb2tpZSAnIisgbmFtZSArIicgcG9zc2libHkgbm90IHNldCBvciBvdmVyZmxvd2VkIGJlY2F1c2UgdG9vIG1hbnkgY29va2llcyAiICsKICAgICAgICAgICAgICAid2VyZSBhbHJlYWR5IHNldCAoIiArIGxhc3RDb29raWVzLmxlbmd0aCArICIgPiAyMCApIik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9IGVsc2UgewogICAgICBpZiAocmF3RG9jdW1lbnQuY29va2llICE9PSBsYXN0Q29va2llU3RyaW5nKSB7CiAgICAgICAgbGFzdENvb2tpZVN0cmluZyA9IHJhd0RvY3VtZW50LmNvb2tpZTsKICAgICAgICBjb29raWVBcnJheSA9IGxhc3RDb29raWVTdHJpbmcuc3BsaXQoIjsgIik7CiAgICAgICAgbGFzdENvb2tpZXMgPSB7fTsKCiAgICAgICAgZm9yIChpID0gMDsgaSA8IGNvb2tpZUFycmF5Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBjb29raWUgPSBjb29raWVBcnJheVtpXTsKICAgICAgICAgIGluZGV4ID0gY29va2llLmluZGV4T2YoJz0nKTsKICAgICAgICAgIGlmIChpbmRleCA+IDApIHsgLy9pZ25vcmUgbmFtZWxlc3MgY29va2llcwogICAgICAgICAgICBsYXN0Q29va2llc1t1bmVzY2FwZShjb29raWUuc3Vic3RyaW5nKDAsIGluZGV4KSldID0gdW5lc2NhcGUoY29va2llLnN1YnN0cmluZyhpbmRleCArIDEpKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIGxhc3RDb29raWVzOwogICAgfQogIH07CgoKICAvKioKICAgKiBAd29ya0luUHJvZ3Jlc3MKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgYW5ndWxhci5zZXJ2aWNlLiRicm93c2VyI2RlZmVyCiAgICogQG1ldGhvZE9mIGFuZ3VsYXIuc2VydmljZS4kYnJvd3NlcgogICAqIEBwYXJhbSB7ZnVuY3Rpb24oKX0gZm4gQSBmdW5jdGlvbiwgd2hvJ3MgZXhlY3V0aW9uIHNob3VsZCBiZSBkZWZlcmVkLgogICAqIEBwYXJhbSB7bnVtYmVyPX0gW2RlbGF5PTBdIG9mIG1pbGxpc2Vjb25kcyB0byBkZWZlciB0aGUgZnVuY3Rpb24gZXhlY3V0aW9uLgogICAqIEByZXR1cm5zIHsqfSBEZWZlcklkIHRoYXQgY2FuIGJlIHVzZWQgdG8gY2FuY2VsIHRoZSB0YXNrIHZpYSBgJGJyb3dzZXIuZGVmZXIuY2FuY2VsKClgLgogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogRXhlY3V0ZXMgYSBmbiBhc3luY2hyb25pb3VzbHkgdmlhIGBzZXRUaW1lb3V0KGZuLCBkZWxheSlgLgogICAqCiAgICogVW5saWtlIHdoZW4gY2FsbGluZyBgc2V0VGltZW91dGAgZGlyZWN0bHksIGluIHRlc3QgdGhpcyBmdW5jdGlvbiBpcyBtb2NrZWQgYW5kIGluc3RlYWQgb2YgdXNpbmcKICAgKiBgc2V0VGltZW91dGAgaW4gdGVzdHMsIHRoZSBmbnMgYXJlIHF1ZXVlZCBpbiBhbiBhcnJheSwgd2hpY2ggY2FuIGJlIHByb2dyYW1tYXRpY2FsbHkgZmx1c2hlZAogICAqIHZpYSBgJGJyb3dzZXIuZGVmZXIuZmx1c2goKWAuCiAgICoKICAgKi8KICBzZWxmLmRlZmVyID0gZnVuY3Rpb24oZm4sIGRlbGF5KSB7CiAgICB2YXIgdGltZW91dElkOwogICAgb3V0c3RhbmRpbmdSZXF1ZXN0Q291bnQrKzsKICAgIHRpbWVvdXRJZCA9IHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgIGRlbGV0ZSBwZW5kaW5nRGVmZXJJZHNbdGltZW91dElkXTsKICAgICAgY29tcGxldGVPdXRzdGFuZGluZ1JlcXVlc3QoZm4pOwogICAgfSwgZGVsYXkgfHwgMCk7CiAgICBwZW5kaW5nRGVmZXJJZHNbdGltZW91dElkXSA9IHRydWU7CiAgICByZXR1cm4gdGltZW91dElkOwogIH07CgoKICAvKioKICAgKiBUSElTIERPQyBJUyBOT1QgVklTSUJMRSBiZWNhdXNlIG5nZG9jcyBjYW4ndCBwcm9jZXNzIGRvY3MgZm9yIGZvbyNtZXRob2QubWV0aG9kCiAgICoKICAgKiBAbmFtZSBhbmd1bGFyLnNlcnZpY2UuJGJyb3dzZXIjZGVmZXIuY2FuY2VsCiAgICogQG1ldGhvZE9mIGFuZ3VsYXIuc2VydmljZS4kYnJvd3Nlci5kZWZlcgogICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgdGFzayBoYXNuJ3QgZXhlY3V0ZWQgeWV0IGFuZCB3YXMgc3VjY2Vzc2Z1bHkgY2FuY2VsZWQuCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBDYW5jZWxzIGEgZGVmZXJlZCB0YXNrIGlkZW50aWZpZWQgd2l0aCBgZGVmZXJJZGAuCiAgICovCgogIHNlbGYuZGVmZXIuY2FuY2VsID0gZnVuY3Rpb24oZGVmZXJJZCkgewogICAgaWYgKHBlbmRpbmdEZWZlcklkc1tkZWZlcklkXSkgewogICAgICBkZWxldGUgcGVuZGluZ0RlZmVySWRzW2RlZmVySWRdOwogICAgICBjbGVhclRpbWVvdXQoZGVmZXJJZCk7CiAgICAgIGNvbXBsZXRlT3V0c3RhbmRpbmdSZXF1ZXN0KG5vb3ApOwogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICB9OwoKCiAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICAvLyBNaXNjIEFQSQogIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgdmFyIGhvdmVyTGlzdGVuZXIgPSBub29wOwoKICAvKioKICAgKiBAd29ya0luUHJvZ3Jlc3MKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgYW5ndWxhci5zZXJ2aWNlLiRicm93c2VyI2hvdmVyCiAgICogQG1ldGhvZE9mIGFuZ3VsYXIuc2VydmljZS4kYnJvd3NlcgogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogU2V0IGhvdmVyIGxpc3RlbmVyLgogICAqCiAgICogQHBhcmFtIHtmdW5jdGlvbihPYmplY3QsIGJvb2xlYW4pfSBsaXN0ZW5lciBGdW5jdGlvbiB0aGF0IHdpbGwgYmUgY2FsbGVkIHdoZW4gYSBob3ZlciBldmVudAogICAqICAgIG9jY3Vycy4KICAgKi8KICBzZWxmLmhvdmVyID0gZnVuY3Rpb24obGlzdGVuZXIpIHsgaG92ZXJMaXN0ZW5lciA9IGxpc3RlbmVyOyB9OwoKICAvKioKICAgKiBAd29ya0luUHJvZ3Jlc3MKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgYW5ndWxhci5zZXJ2aWNlLiRicm93c2VyI2JpbmQKICAgKiBAbWV0aG9kT2YgYW5ndWxhci5zZXJ2aWNlLiRicm93c2VyCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBSZWdpc3RlciBob3ZlciBmdW5jdGlvbiB0byByZWFsIGJyb3dzZXIKICAgKi8KICBzZWxmLmJpbmQgPSBmdW5jdGlvbigpIHsKICAgIGRvY3VtZW50LmJpbmQoIm1vdXNlb3ZlciIsIGZ1bmN0aW9uKGV2ZW50KXsKICAgICAgaG92ZXJMaXN0ZW5lcihqcUxpdGUobXNpZSA/IGV2ZW50LnNyY0VsZW1lbnQgOiBldmVudC50YXJnZXQpLCB0cnVlKTsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9KTsKICAgIGRvY3VtZW50LmJpbmQoIm1vdXNlbGVhdmUgbW91c2VvdXQgY2xpY2sgZGJsY2xpY2sga2V5cHJlc3Mga2V5dXAiLCBmdW5jdGlvbihldmVudCl7CiAgICAgIGhvdmVyTGlzdGVuZXIoanFMaXRlKGV2ZW50LnRhcmdldCksIGZhbHNlKTsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9KTsKICB9OwoKCiAgLyoqCiAgICogQHdvcmtJblByb2dyZXNzCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lIGFuZ3VsYXIuc2VydmljZS4kYnJvd3NlciNhZGRDc3MKICAgKiBAbWV0aG9kT2YgYW5ndWxhci5zZXJ2aWNlLiRicm93c2VyCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gdXJsIFVybCB0byBjc3MgZmlsZQogICAqIEBkZXNjcmlwdGlvbgogICAqIEFkZHMgYSBzdHlsZXNoZWV0IHRhZyB0byB0aGUgaGVhZC4KICAgKi8KICBzZWxmLmFkZENzcyA9IGZ1bmN0aW9uKHVybCkgewogICAgdmFyIGxpbmsgPSBqcUxpdGUocmF3RG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnbGluaycpKTsKICAgIGxpbmsuYXR0cigncmVsJywgJ3N0eWxlc2hlZXQnKTsKICAgIGxpbmsuYXR0cigndHlwZScsICd0ZXh0L2NzcycpOwogICAgbGluay5hdHRyKCdocmVmJywgdXJsKTsKICAgIGJvZHkuYXBwZW5kKGxpbmspOwogIH07CgoKICAvKioKICAgKiBAd29ya0luUHJvZ3Jlc3MKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgYW5ndWxhci5zZXJ2aWNlLiRicm93c2VyI2FkZEpzCiAgICogQG1ldGhvZE9mIGFuZ3VsYXIuc2VydmljZS4kYnJvd3NlcgogICAqCiAgICogQHBhcmFtIHtzdHJpbmd9IHVybCBVcmwgdG8ganMgZmlsZQogICAqIEBwYXJhbSB7c3RyaW5nPX0gZG9tSWQgT3B0aW9uYWwgaWQgZm9yIHRoZSBzY3JpcHQgdGFnCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBBZGRzIGEgc2NyaXB0IHRhZyB0byB0aGUgaGVhZC4KICAgKi8KICBzZWxmLmFkZEpzID0gZnVuY3Rpb24odXJsLCBkb21JZCwgZG9uZSkgewogICAgLy8gd2UgY2FuJ3QgdXNlIGpRdWVyeS9qcUxpdGUgaGVyZSBiZWNhdXNlIGpRdWVyeSBkb2VzIGNyYXp5IHNoaXQgd2l0aCBzY3JpcHQgZWxlbWVudHMsIGUuZy46CiAgICAvLyAtIGZldGNoZXMgbG9jYWwgc2NyaXB0cyB2aWEgWEhSIGFuZCBldmFscyB0aGVtCiAgICAvLyAtIGFkZHMgYW5kIGltbWVkaWF0ZWx5IHJlbW92ZXMgc2NyaXB0IGVsZW1lbnRzIGZyb20gdGhlIGRvY3VtZW50CiAgICAvLwogICAgLy8gV2UgbmVlZCBhZGRKcyB0byBiZSBhYmxlIHRvIGFkZCBhbmd1bGFyLWllLWNvbXBhdC5qcyB3aGljaCBpcyB2ZXJ5IHNwZWNpYWwgYW5kIG11c3QgcmVtYWluCiAgICAvLyBwYXJ0IG9mIHRoZSBET00gc28gdGhhdCB0aGUgZW1iZWRkZWQgaW1hZ2VzIGNhbiByZWZlcmVuY2UgaXQuIGpRdWVyeSdzIGFwcGVuZCBpbXBsZW1lbnRhdGlvbgogICAgLy8gKHYxLjQuMikgZnViYXJzIGl0LgogICAgdmFyIHNjcmlwdCA9IHJhd0RvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NjcmlwdCcpOwoKICAgIHNjcmlwdC50eXBlID0gJ3RleHQvamF2YXNjcmlwdCc7CiAgICBzY3JpcHQuc3JjID0gdXJsOwogICAgaWYgKGRvbUlkKSBzY3JpcHQuaWQgPSBkb21JZDsKCiAgICBpZiAobXNpZSkgewogICAgICBzY3JpcHQub25yZWFkeXN0YXRlY2hhbmdlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgL2xvYWRlZHxjb21wbGV0ZS8udGVzdChzY3JpcHQucmVhZHlTdGF0ZSkgJiYgZG9uZSAmJiBkb25lKCk7CiAgICAgIH07CiAgICB9IGVsc2UgewogICAgICBpZiAoZG9uZSkgc2NyaXB0Lm9ubG9hZCA9IHNjcmlwdC5vbmVycm9yID0gZG9uZTsKICAgIH0KCiAgICBib2R5WzBdLmFwcGVuZENoaWxkKHNjcmlwdCk7CgogICAgcmV0dXJuIHNjcmlwdDsKICB9Owp9Cid1c2Ugc3RyaWN0JzsKCi8qCiAqIEhUTUwgUGFyc2VyIEJ5IE1pc2tvIEhldmVyeSAobWlza29AaGV2ZXJ5LmNvbSkKICogYmFzZWQgb246ICBIVE1MIFBhcnNlciBCeSBKb2huIFJlc2lnIChlam9obi5vcmcpCiAqIE9yaWdpbmFsIGNvZGUgYnkgRXJpayBBcnZpZHNzb24sIE1vemlsbGEgUHVibGljIExpY2Vuc2UKICogaHR0cDovL2VyaWsuZWFlLm5ldC9zaW1wbGVodG1scGFyc2VyL3NpbXBsZWh0bWxwYXJzZXIuanMKICoKICogLy8gVXNlIGxpa2Ugc286CiAqIGh0bWxQYXJzZXIoaHRtbFN0cmluZywgewogKiAgICAgc3RhcnQ6IGZ1bmN0aW9uKHRhZywgYXR0cnMsIHVuYXJ5KSB7fSwKICogICAgIGVuZDogZnVuY3Rpb24odGFnKSB7fSwKICogICAgIGNoYXJzOiBmdW5jdGlvbih0ZXh0KSB7fSwKICogICAgIGNvbW1lbnQ6IGZ1bmN0aW9uKHRleHQpIHt9CiAqIH0pOwogKgogKi8KCi8vIFJlZ3VsYXIgRXhwcmVzc2lvbnMgZm9yIHBhcnNpbmcgdGFncyBhbmQgYXR0cmlidXRlcwp2YXIgU1RBUlRfVEFHX1JFR0VYUCA9IC9ePFxzKihbXHc6LV0rKSgoPzpccytbXHc6LV0rKD86XHMqPVxzKig/Oig/OiJbXiJdKiIpfCg/OidbXiddKicpfFtePlxzXSspKT8pKilccyooXC8/KVxzKj4vLAogIEVORF9UQUdfUkVHRVhQID0gL148XHMqXC9ccyooW1x3Oi1dKylbXj5dKj4vLAogIEFUVFJfUkVHRVhQID0gLyhbXHc6LV0rKSg/OlxzKj1ccyooPzooPzoiKCg/OlteIl0pKikiKXwoPzonKCg/OlteJ10pKiknKXwoW14+XHNdKykpKT8vZywKICBCRUdJTl9UQUdfUkVHRVhQID0gL148LywKICBCRUdJTkdfRU5EX1RBR0VfUkVHRVhQID0gL148XHMqXC8vLAogIENPTU1FTlRfUkVHRVhQID0gLzwhLS0oLio/KS0tPi9nLAogIENEQVRBX1JFR0VYUCA9IC88IVxbQ0RBVEFcWyguKj8pXV0+L2csCiAgVVJJX1JFR0VYUCA9IC9eKChmdHB8aHR0cHM/KTpcL1wvfG1haWx0bzp8IykvLAogIE5PTl9BTFBIQU5VTUVSSUNfUkVHRVhQID0gLyhbXlwjLX58IHwhXSkvZzsgLy8gTWF0Y2ggZXZlcnl0aGluZyBvdXRzaWRlIG9mIG5vcm1hbCBjaGFycyBhbmQgIiAocXVvdGUgY2hhcmFjdGVyKQoKLy8gRW1wdHkgRWxlbWVudHMgLSBIVE1MIDQuMDEKdmFyIGVtcHR5RWxlbWVudHMgPSBtYWtlTWFwKCJhcmVhLGJyLGNvbCxocixpbWciKTsKCi8vIEJsb2NrIEVsZW1lbnRzIC0gSFRNTCA0LjAxCnZhciBibG9ja0VsZW1lbnRzID0gbWFrZU1hcCgiYWRkcmVzcyxibG9ja3F1b3RlLGNlbnRlcixkZCxkZWwsZGlyLGRpdixkbCxkdCwiKwogICAgImhyLGlucyxsaSxtYXAsbWVudSxvbCxwLHByZSxzY3JpcHQsdGFibGUsdGJvZHksdGQsdGZvb3QsdGgsdGhlYWQsdHIsdWwiKTsKCi8vIElubGluZSBFbGVtZW50cyAtIEhUTUwgNC4wMQp2YXIgaW5saW5lRWxlbWVudHMgPSBtYWtlTWFwKCJhLGFiYnIsYWNyb255bSxiLGJkbyxiaWcsYnIsY2l0ZSxjb2RlLGRlbCxkZm4sZW0sZm9udCxpLGltZywiKwogICAgImlucyxrYmQsbGFiZWwsbWFwLHEscyxzYW1wLHNtYWxsLHNwYW4sc3RyaWtlLHN0cm9uZyxzdWIsc3VwLHR0LHUsdmFyIik7Ci8vIEVsZW1lbnRzIHRoYXQgeW91IGNhbiwgaW50ZW50aW9uYWxseSwgbGVhdmUgb3BlbgovLyAoYW5kIHdoaWNoIGNsb3NlIHRoZW1zZWx2ZXMpCnZhciBjbG9zZVNlbGZFbGVtZW50cyA9IG1ha2VNYXAoImNvbGdyb3VwLGRkLGR0LGxpLHAsdGQsdGZvb3QsdGgsdGhlYWQsdHIiKTsKLy8gU3BlY2lhbCBFbGVtZW50cyAoY2FuIGNvbnRhaW4gYW55dGhpbmcpCnZhciBzcGVjaWFsRWxlbWVudHMgPSBtYWtlTWFwKCJzY3JpcHQsc3R5bGUiKTsKdmFyIHZhbGlkRWxlbWVudHMgPSBleHRlbmQoe30sIGVtcHR5RWxlbWVudHMsIGJsb2NrRWxlbWVudHMsIGlubGluZUVsZW1lbnRzLCBjbG9zZVNlbGZFbGVtZW50cyk7CgovL0F0dHJpYnV0ZXMgdGhhdCBoYXZlIGhyZWYgYW5kIGhlbmNlIG5lZWQgdG8gYmUgc2FuaXRpemVkCnZhciB1cmlBdHRycyA9IG1ha2VNYXAoImJhY2tncm91bmQsaHJlZixsb25nZGVzYyxzcmMsdXNlbWFwIik7CnZhciB2YWxpZEF0dHJzID0gZXh0ZW5kKHt9LCB1cmlBdHRycywgbWFrZU1hcCgKICAgICdhYmJyLGFsaWduLGFsdCxheGlzLGJnY29sb3IsYm9yZGVyLGNlbGxwYWRkaW5nLGNlbGxzcGFjaW5nLGNsYXNzLGNsZWFyLCcrCiAgICAnY29sb3IsY29scyxjb2xzcGFuLGNvbXBhY3QsY29vcmRzLGRpcixmYWNlLGhlYWRlcnMsaGVpZ2h0LGhyZWZsYW5nLGhzcGFjZSwnKwogICAgJ2lzbWFwLGxhbmcsbGFuZ3VhZ2Usbm9ocmVmLG5vd3JhcCxyZWwscmV2LHJvd3Mscm93c3BhbixydWxlcywnKwogICAgJ3Njb3BlLHNjcm9sbGluZyxzaGFwZSxzcGFuLHN0YXJ0LHN1bW1hcnksdGFyZ2V0LHRpdGxlLHR5cGUsJysKICAgICd2YWxpZ24sdmFsdWUsdnNwYWNlLHdpZHRoJykpOwoKLyoqCiAqIEBleGFtcGxlCiAqIGh0bWxQYXJzZXIoaHRtbFN0cmluZywgewogKiAgICAgc3RhcnQ6IGZ1bmN0aW9uKHRhZywgYXR0cnMsIHVuYXJ5KSB7fSwKICogICAgIGVuZDogZnVuY3Rpb24odGFnKSB7fSwKICogICAgIGNoYXJzOiBmdW5jdGlvbih0ZXh0KSB7fSwKICogICAgIGNvbW1lbnQ6IGZ1bmN0aW9uKHRleHQpIHt9CiAqIH0pOwogKgogKiBAcGFyYW0ge3N0cmluZ30gaHRtbCBzdHJpbmcKICogQHBhcmFtIHtvYmplY3R9IGhhbmRsZXIKICovCmZ1bmN0aW9uIGh0bWxQYXJzZXIoIGh0bWwsIGhhbmRsZXIgKSB7CiAgdmFyIGluZGV4LCBjaGFycywgbWF0Y2gsIHN0YWNrID0gW10sIGxhc3QgPSBodG1sOwogIHN0YWNrLmxhc3QgPSBmdW5jdGlvbigpeyByZXR1cm4gc3RhY2tbIHN0YWNrLmxlbmd0aCAtIDEgXTsgfTsKCiAgd2hpbGUgKCBodG1sICkgewogICAgY2hhcnMgPSB0cnVlOwoKICAgIC8vIE1ha2Ugc3VyZSB3ZSdyZSBub3QgaW4gYSBzY3JpcHQgb3Igc3R5bGUgZWxlbWVudAogICAgaWYgKCAhc3RhY2subGFzdCgpIHx8ICFzcGVjaWFsRWxlbWVudHNbIHN0YWNrLmxhc3QoKSBdICkgewoKICAgICAgLy8gQ29tbWVudAogICAgICBpZiAoIGh0bWwuaW5kZXhPZigiPCEtLSIpID09PSAwICkgewogICAgICAgIGluZGV4ID0gaHRtbC5pbmRleE9mKCItLT4iKTsKCiAgICAgICAgaWYgKCBpbmRleCA+PSAwICkgewogICAgICAgICAgaWYgKGhhbmRsZXIuY29tbWVudCkgaGFuZGxlci5jb21tZW50KCBodG1sLnN1YnN0cmluZyggNCwgaW5kZXggKSApOwogICAgICAgICAgaHRtbCA9IGh0bWwuc3Vic3RyaW5nKCBpbmRleCArIDMgKTsKICAgICAgICAgIGNoYXJzID0gZmFsc2U7CiAgICAgICAgfQoKICAgICAgLy8gZW5kIHRhZwogICAgICB9IGVsc2UgaWYgKCBCRUdJTkdfRU5EX1RBR0VfUkVHRVhQLnRlc3QoaHRtbCkgKSB7CiAgICAgICAgbWF0Y2ggPSBodG1sLm1hdGNoKCBFTkRfVEFHX1JFR0VYUCApOwoKICAgICAgICBpZiAoIG1hdGNoICkgewogICAgICAgICAgaHRtbCA9IGh0bWwuc3Vic3RyaW5nKCBtYXRjaFswXS5sZW5ndGggKTsKICAgICAgICAgIG1hdGNoWzBdLnJlcGxhY2UoIEVORF9UQUdfUkVHRVhQLCBwYXJzZUVuZFRhZyApOwogICAgICAgICAgY2hhcnMgPSBmYWxzZTsKICAgICAgICB9CgogICAgICAvLyBzdGFydCB0YWcKICAgICAgfSBlbHNlIGlmICggQkVHSU5fVEFHX1JFR0VYUC50ZXN0KGh0bWwpICkgewogICAgICAgIG1hdGNoID0gaHRtbC5tYXRjaCggU1RBUlRfVEFHX1JFR0VYUCApOwoKICAgICAgICBpZiAoIG1hdGNoICkgewogICAgICAgICAgaHRtbCA9IGh0bWwuc3Vic3RyaW5nKCBtYXRjaFswXS5sZW5ndGggKTsKICAgICAgICAgIG1hdGNoWzBdLnJlcGxhY2UoIFNUQVJUX1RBR19SRUdFWFAsIHBhcnNlU3RhcnRUYWcgKTsKICAgICAgICAgIGNoYXJzID0gZmFsc2U7CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAoIGNoYXJzICkgewogICAgICAgIGluZGV4ID0gaHRtbC5pbmRleE9mKCI8Iik7CgogICAgICAgIHZhciB0ZXh0ID0gaW5kZXggPCAwID8gaHRtbCA6IGh0bWwuc3Vic3RyaW5nKCAwLCBpbmRleCApOwogICAgICAgIGh0bWwgPSBpbmRleCA8IDAgPyAiIiA6IGh0bWwuc3Vic3RyaW5nKCBpbmRleCApOwoKICAgICAgICBpZiAoaGFuZGxlci5jaGFycykgaGFuZGxlci5jaGFycyggZGVjb2RlRW50aXRpZXModGV4dCkgKTsKICAgICAgfQoKICAgIH0gZWxzZSB7CiAgICAgIGh0bWwgPSBodG1sLnJlcGxhY2UobmV3IFJlZ0V4cCgiKC4qKTxcXHMqXFwvXFxzKiIgKyBzdGFjay5sYXN0KCkgKyAiW14+XSo+IiwgJ2knKSwgZnVuY3Rpb24oYWxsLCB0ZXh0KXsKICAgICAgICB0ZXh0ID0gdGV4dC4KICAgICAgICAgIHJlcGxhY2UoQ09NTUVOVF9SRUdFWFAsICIkMSIpLgogICAgICAgICAgcmVwbGFjZShDREFUQV9SRUdFWFAsICIkMSIpOwoKICAgICAgICBpZiAoaGFuZGxlci5jaGFycykgaGFuZGxlci5jaGFycyggZGVjb2RlRW50aXRpZXModGV4dCkgKTsKCiAgICAgICAgcmV0dXJuICIiOwogICAgICB9KTsKCiAgICAgIHBhcnNlRW5kVGFnKCAiIiwgc3RhY2subGFzdCgpICk7CiAgICB9CgogICAgaWYgKCBodG1sID09IGxhc3QgKSB7CiAgICAgIHRocm93ICJQYXJzZSBFcnJvcjogIiArIGh0bWw7CiAgICB9CiAgICBsYXN0ID0gaHRtbDsKICB9CgogIC8vIENsZWFuIHVwIGFueSByZW1haW5pbmcgdGFncwogIHBhcnNlRW5kVGFnKCk7CgogIGZ1bmN0aW9uIHBhcnNlU3RhcnRUYWcoIHRhZywgdGFnTmFtZSwgcmVzdCwgdW5hcnkgKSB7CiAgICB0YWdOYW1lID0gbG93ZXJjYXNlKHRhZ05hbWUpOwogICAgaWYgKCBibG9ja0VsZW1lbnRzWyB0YWdOYW1lIF0gKSB7CiAgICAgIHdoaWxlICggc3RhY2subGFzdCgpICYmIGlubGluZUVsZW1lbnRzWyBzdGFjay5sYXN0KCkgXSApIHsKICAgICAgICBwYXJzZUVuZFRhZyggIiIsIHN0YWNrLmxhc3QoKSApOwogICAgICB9CiAgICB9CgogICAgaWYgKCBjbG9zZVNlbGZFbGVtZW50c1sgdGFnTmFtZSBdICYmIHN0YWNrLmxhc3QoKSA9PSB0YWdOYW1lICkgewogICAgICBwYXJzZUVuZFRhZyggIiIsIHRhZ05hbWUgKTsKICAgIH0KCiAgICB1bmFyeSA9IGVtcHR5RWxlbWVudHNbIHRhZ05hbWUgXSB8fCAhIXVuYXJ5OwoKICAgIGlmICggIXVuYXJ5ICkKICAgICAgc3RhY2sucHVzaCggdGFnTmFtZSApOwoKICAgIHZhciBhdHRycyA9IHt9OwoKICAgIHJlc3QucmVwbGFjZShBVFRSX1JFR0VYUCwgZnVuY3Rpb24obWF0Y2gsIG5hbWUsIGRvdWJsZVF1b3RlZFZhbHVlLCBzaW5nbGVRb3V0ZWRWYWx1ZSwgdW5xb3V0ZWRWYWx1ZSkgewogICAgICB2YXIgdmFsdWUgPSBkb3VibGVRdW90ZWRWYWx1ZQogICAgICAgIHx8IHNpbmdsZVFvdXRlZFZhbHVlCiAgICAgICAgfHwgdW5xb3V0ZWRWYWx1ZQogICAgICAgIHx8ICcnOwoKICAgICAgYXR0cnNbbmFtZV0gPSBkZWNvZGVFbnRpdGllcyh2YWx1ZSk7CiAgICB9KTsKICAgIGlmIChoYW5kbGVyLnN0YXJ0KSBoYW5kbGVyLnN0YXJ0KCB0YWdOYW1lLCBhdHRycywgdW5hcnkgKTsKICB9CgogIGZ1bmN0aW9uIHBhcnNlRW5kVGFnKCB0YWcsIHRhZ05hbWUgKSB7CiAgICB2YXIgcG9zID0gMCwgaTsKICAgIHRhZ05hbWUgPSBsb3dlcmNhc2UodGFnTmFtZSk7CiAgICBpZiAoIHRhZ05hbWUgKQogICAgICAvLyBGaW5kIHRoZSBjbG9zZXN0IG9wZW5lZCB0YWcgb2YgdGhlIHNhbWUgdHlwZQogICAgICBmb3IgKCBwb3MgPSBzdGFjay5sZW5ndGggLSAxOyBwb3MgPj0gMDsgcG9zLS0gKQogICAgICAgIGlmICggc3RhY2tbIHBvcyBdID09IHRhZ05hbWUgKQogICAgICAgICAgYnJlYWs7CgogICAgaWYgKCBwb3MgPj0gMCApIHsKICAgICAgLy8gQ2xvc2UgYWxsIHRoZSBvcGVuIGVsZW1lbnRzLCB1cCB0aGUgc3RhY2sKICAgICAgZm9yICggaSA9IHN0YWNrLmxlbmd0aCAtIDE7IGkgPj0gcG9zOyBpLS0gKQogICAgICAgIGlmIChoYW5kbGVyLmVuZCkgaGFuZGxlci5lbmQoIHN0YWNrWyBpIF0gKTsKCiAgICAgIC8vIFJlbW92ZSB0aGUgb3BlbiBlbGVtZW50cyBmcm9tIHRoZSBzdGFjawogICAgICBzdGFjay5sZW5ndGggPSBwb3M7CiAgICB9CiAgfQp9CgovKioKICogZGVjb2RlcyBhbGwgZW50aXRpZXMgaW50byByZWd1bGFyIHN0cmluZwogKiBAcGFyYW0gdmFsdWUKICogQHJldHVybnMge3N0cmluZ30gQSBzdHJpbmcgd2l0aCBkZWNvZGVkIGVudGl0aWVzLgogKi8KdmFyIGhpZGRlblByZT1kb2N1bWVudC5jcmVhdGVFbGVtZW50KCJwcmUiKTsKZnVuY3Rpb24gZGVjb2RlRW50aXRpZXModmFsdWUpIHsKICBoaWRkZW5QcmUuaW5uZXJIVE1MPXZhbHVlLnJlcGxhY2UoLzwvZywiJmx0OyIpOwogIHJldHVybiBoaWRkZW5QcmUuaW5uZXJUZXh0IHx8IGhpZGRlblByZS50ZXh0Q29udGVudCB8fCAnJzsKfQoKLyoqCiAqIEVzY2FwZXMgYWxsIHBvdGVudGlhbGx5IGRhbmdlcm91cyBjaGFyYWN0ZXJzLCBzbyB0aGF0IHRoZQogKiByZXN1bHRpbmcgc3RyaW5nIGNhbiBiZSBzYWZlbHkgaW5zZXJ0ZWQgaW50byBhdHRyaWJ1dGUgb3IKICogZWxlbWVudCB0ZXh0LgogKiBAcGFyYW0gdmFsdWUKICogQHJldHVybnMgZXNjYXBlZCB0ZXh0CiAqLwpmdW5jdGlvbiBlbmNvZGVFbnRpdGllcyh2YWx1ZSkgewogIHJldHVybiB2YWx1ZS4KICAgIHJlcGxhY2UoLyYvZywgJyZhbXA7JykuCiAgICByZXBsYWNlKE5PTl9BTFBIQU5VTUVSSUNfUkVHRVhQLCBmdW5jdGlvbih2YWx1ZSl7CiAgICAgIHJldHVybiAnJiMnICsgdmFsdWUuY2hhckNvZGVBdCgwKSArICc7JzsKICAgIH0pLgogICAgcmVwbGFjZSgvPC9nLCAnJmx0OycpLgogICAgcmVwbGFjZSgvPi9nLCAnJmd0OycpOwp9CgovKioKICogY3JlYXRlIGFuIEhUTUwvWE1MIHdyaXRlciB3aGljaCB3cml0ZXMgdG8gYnVmZmVyCiAqIEBwYXJhbSB7QXJyYXl9IGJ1ZiB1c2UgYnVmLmphaW4oJycpIHRvIGdldCBvdXQgc2FuaXRpemVkIGh0bWwgc3RyaW5nCiAqIEByZXR1cm5zIHtvYmplY3R9IGluIHRoZSBmb3JtIG9mIHsKICogICAgIHN0YXJ0OiBmdW5jdGlvbih0YWcsIGF0dHJzLCB1bmFyeSkge30sCiAqICAgICBlbmQ6IGZ1bmN0aW9uKHRhZykge30sCiAqICAgICBjaGFyczogZnVuY3Rpb24odGV4dCkge30sCiAqICAgICBjb21tZW50OiBmdW5jdGlvbih0ZXh0KSB7fQogKiB9CiAqLwpmdW5jdGlvbiBodG1sU2FuaXRpemVXcml0ZXIoYnVmKXsKICB2YXIgaWdub3JlID0gZmFsc2U7CiAgdmFyIG91dCA9IGJpbmQoYnVmLCBidWYucHVzaCk7CiAgcmV0dXJuIHsKICAgIHN0YXJ0OiBmdW5jdGlvbih0YWcsIGF0dHJzLCB1bmFyeSl7CiAgICAgIHRhZyA9IGxvd2VyY2FzZSh0YWcpOwogICAgICBpZiAoIWlnbm9yZSAmJiBzcGVjaWFsRWxlbWVudHNbdGFnXSkgewogICAgICAgIGlnbm9yZSA9IHRhZzsKICAgICAgfQogICAgICBpZiAoIWlnbm9yZSAmJiB2YWxpZEVsZW1lbnRzW3RhZ10gPT0gdHJ1ZSkgewogICAgICAgIG91dCgnPCcpOwogICAgICAgIG91dCh0YWcpOwogICAgICAgIGZvckVhY2goYXR0cnMsIGZ1bmN0aW9uKHZhbHVlLCBrZXkpewogICAgICAgICAgdmFyIGxrZXk9bG93ZXJjYXNlKGtleSk7CiAgICAgICAgICBpZiAodmFsaWRBdHRyc1tsa2V5XT09dHJ1ZSAmJiAodXJpQXR0cnNbbGtleV0hPT10cnVlIHx8IHZhbHVlLm1hdGNoKFVSSV9SRUdFWFApKSkgewogICAgICAgICAgICBvdXQoJyAnKTsKICAgICAgICAgICAgb3V0KGtleSk7CiAgICAgICAgICAgIG91dCgnPSInKTsKICAgICAgICAgICAgb3V0KGVuY29kZUVudGl0aWVzKHZhbHVlKSk7CiAgICAgICAgICAgIG91dCgnIicpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIG91dCh1bmFyeSA/ICcvPicgOiAnPicpOwogICAgICB9CiAgICB9LAogICAgZW5kOiBmdW5jdGlvbih0YWcpewogICAgICAgIHRhZyA9IGxvd2VyY2FzZSh0YWcpOwogICAgICAgIGlmICghaWdub3JlICYmIHZhbGlkRWxlbWVudHNbdGFnXSA9PSB0cnVlKSB7CiAgICAgICAgICBvdXQoJzwvJyk7CiAgICAgICAgICBvdXQodGFnKTsKICAgICAgICAgIG91dCgnPicpOwogICAgICAgIH0KICAgICAgICBpZiAodGFnID09IGlnbm9yZSkgewogICAgICAgICAgaWdub3JlID0gZmFsc2U7CiAgICAgICAgfQogICAgICB9LAogICAgY2hhcnM6IGZ1bmN0aW9uKGNoYXJzKXsKICAgICAgICBpZiAoIWlnbm9yZSkgewogICAgICAgICAgb3V0KGVuY29kZUVudGl0aWVzKGNoYXJzKSk7CiAgICAgICAgfQogICAgICB9CiAgfTsKfQondXNlIHN0cmljdCc7CgovLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCi8vSlFMaXRlCi8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KCi8qKgogKiBAd29ya0luUHJvZ3Jlc3MKICogQG5nZG9jIGZ1bmN0aW9uCiAqIEBuYW1lIGFuZ3VsYXIuZWxlbWVudAogKiBAZnVuY3Rpb24KICoKICogQGRlc2NyaXB0aW9uCiAqIFdyYXBzIGEgcmF3IERPTSBlbGVtZW50IG9yIEhUTUwgc3RyaW5nIGFzIFtqUXVlcnldKGh0dHA6Ly9qcXVlcnkuY29tKSBlbGVtZW50LgogKiBgYW5ndWxhci5lbGVtZW50YCBpcyBlaXRoZXIgYW4gYWxpYXMgZm9yIFtqUXVlcnldKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9qUXVlcnkvKSBmdW5jdGlvbiBpZgogKiBqUXVlcnkgaXMgbG9hZGVkIG9yIGEgZnVuY3Rpb24gdGhhdCB3cmFwcyB0aGUgZWxlbWVudCBvciBzdHJpbmcgaW4gYW5ndWxhcidzIGpRdWVyeSBsaXRlCiAqIGltcGxlbWVudGF0aW9uLgogKgogKiBSZWFsIGpRdWVyeSBhbHdheXMgdGFrZXMgcHJlY2VkZW5jZSAoYXMgbG9uZyBhcyBpdCB3YXMgbG9hZGVkIGJlZm9yZSBgRE9NQ29udGVudEV2ZW50YCkKICoKICogQW5ndWxhcidzIGpRdWVyeSBsaXRlIGltcGxlbWVudGF0aW9uIGlzIGEgdGlueSBBUEktY29tcGF0aWJsZSBzdWJzZXQgb2YgalF1ZXJ5IHdoaWNoIGFsbG93cwogKiBhbmd1bGFyIHRvIG1hbmlwdWxhdGUgRE9NLiBUaGUgalF1ZXJ5IGxpdGUgaW1wbGVtZW50cyBvbmx5IGEgc3Vic2V0IG9mIGpRdWVyeSBhcGksIHdpdGggdGhlCiAqIGZvY3VzIG9uIHRoZSBtb3N0IGNvbW1vbmx5IG5lZWRlZCBmdW5jdGlvbmFsaXR5IGFuZCBtaW5pbWFsIGZvb3RwcmludC4gRm9yIHRoaXMgcmVhc29uIG9ubHkgYQogKiBsaW1pdGVkIG51bWJlciBvZiBqUXVlcnkgbWV0aG9kcywgYXJndW1lbnRzIGFuZCBpbnZvY2F0aW9uIHN0eWxlcyBhcmUgc3VwcG9ydGVkLgogKgogKiBOb3RlOiBBbGwgZWxlbWVudCByZWZlcmVuY2VzIGluIGFuZ3VsYXIgYXJlIGFsd2F5cyB3cmFwcGVkIHdpdGggalF1ZXJ5IChsaXRlKSBhbmQgYXJlIG5ldmVyCiAqIHJhdyBET00gcmVmZXJlbmNlcy4KICoKICogIyMgQW5ndWxhcidzIGpRdWVyeSBsaXRlIGltcGxlbWVudHMgdGhlc2UgZnVuY3Rpb25zOgogKgogKiAtIFthZGRDbGFzcygpXShodHRwOi8vYXBpLmpxdWVyeS5jb20vYWRkQ2xhc3MvKQogKiAtIFthZnRlcigpXShodHRwOi8vYXBpLmpxdWVyeS5jb20vYWZ0ZXIvKQogKiAtIFthcHBlbmQoKV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL2FwcGVuZC8pCiAqIC0gW2F0dHIoKV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL2F0dHIvKQogKiAtIFtiaW5kKCldKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9iaW5kLykKICogLSBbY2hpbGRyZW4oKV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL2NoaWxkcmVuLykKICogLSBbY2xvbmUoKV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL2Nsb25lLykKICogLSBbY3NzKCldKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9jc3MvKQogKiAtIFtkYXRhKCldKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9kYXRhLykKICogLSBbaGFzQ2xhc3MoKV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL2hhc0NsYXNzLykKICogLSBbcGFyZW50KCldKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9wYXJlbnQvKQogKiAtIFtyZW1vdmUoKV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL3JlbW92ZS8pCiAqIC0gW3JlbW92ZUF0dHIoKV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL3JlbW92ZUF0dHIvKQogKiAtIFtyZW1vdmVDbGFzcygpXShodHRwOi8vYXBpLmpxdWVyeS5jb20vcmVtb3ZlQ2xhc3MvKQogKiAtIFtyZW1vdmVEYXRhKCldKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9yZW1vdmVEYXRhLykKICogLSBbcmVwbGFjZVdpdGgoKV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL3JlcGxhY2VXaXRoLykKICogLSBbdGV4dCgpXShodHRwOi8vYXBpLmpxdWVyeS5jb20vdGV4dC8pCiAqIC0gW3RyaWdnZXIoKV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL3RyaWdnZXIvKQogKiAtIFtlcSgpXShodHRwOi8vYXBpLmpxdWVyeS5jb20vZXEvKQogKgogKiAjIyBBZGRpdGlvbmFsbHkgdGhlc2UgbWV0aG9kcyBleHRlbmQgdGhlIGpRdWVyeSBhbmQgIGFyZSBhdmFpbGFibGUgaW4gYm90aCBqUXVlcnkgYW5kIGpRdWVyeSBsaXRlCiAqIHZlcnNpb246CiAqCiAqLSBgc2NvcGUoKWAgLSByZXRyaWV2ZXMgdGhlIGN1cnJlbnQgYW5ndWxhciBzY29wZSBvZiB0aGUgZWxlbWVudC4KICoKICogQHBhcmFtIHtzdHJpbmd8RE9NRWxlbWVudH0gZWxlbWVudCBIVE1MIHN0cmluZyBvciBET01FbGVtZW50IHRvIGJlIHdyYXBwZWQgaW50byBqUXVlcnkuCiAqIEByZXR1cm5zIHtPYmplY3R9IGpRdWVyeSBvYmplY3QuCiAqLwoKdmFyIGpxQ2FjaGUgPSB7fSwKICAgIGpxTmFtZSA9ICduZy0nICsgbmV3IERhdGUoKS5nZXRUaW1lKCksCiAgICBqcUlkID0gMSwKICAgIGFkZEV2ZW50TGlzdGVuZXJGbiA9ICh3aW5kb3cuZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcgogICAgICA/IGZ1bmN0aW9uKGVsZW1lbnQsIHR5cGUsIGZuKSB7ZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKHR5cGUsIGZuLCBmYWxzZSk7fQogICAgICA6IGZ1bmN0aW9uKGVsZW1lbnQsIHR5cGUsIGZuKSB7ZWxlbWVudC5hdHRhY2hFdmVudCgnb24nICsgdHlwZSwgZm4pO30pLAogICAgcmVtb3ZlRXZlbnRMaXN0ZW5lckZuID0gKHdpbmRvdy5kb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyCiAgICAgID8gZnVuY3Rpb24oZWxlbWVudCwgdHlwZSwgZm4pIHtlbGVtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIodHlwZSwgZm4sIGZhbHNlKTsgfQogICAgICA6IGZ1bmN0aW9uKGVsZW1lbnQsIHR5cGUsIGZuKSB7ZWxlbWVudC5kZXRhY2hFdmVudCgnb24nICsgdHlwZSwgZm4pOyB9KTsKCmZ1bmN0aW9uIGpxTmV4dElkKCkgeyByZXR1cm4gKGpxSWQrKyk7IH0KCgpmdW5jdGlvbiBnZXRTdHlsZShlbGVtZW50KSB7CiAgdmFyIGN1cnJlbnQgPSB7fSwgc3R5bGUgPSBlbGVtZW50WzBdLnN0eWxlLCB2YWx1ZSwgbmFtZSwgaTsKICBpZiAodHlwZW9mIHN0eWxlLmxlbmd0aCA9PSAnbnVtYmVyJykgewogICAgZm9yKGkgPSAwOyBpIDwgc3R5bGUubGVuZ3RoOyBpKyspIHsKICAgICAgbmFtZSA9IHN0eWxlW2ldOwogICAgICBjdXJyZW50W25hbWVdID0gc3R5bGVbbmFtZV07CiAgICB9CiAgfSBlbHNlIHsKICAgIGZvciAobmFtZSBpbiBzdHlsZSkgewogICAgICB2YWx1ZSA9IHN0eWxlW25hbWVdOwogICAgICBpZiAoMSpuYW1lICE9IG5hbWUgJiYgbmFtZSAhPSAnY3NzVGV4dCcgJiYgdmFsdWUgJiYgdHlwZW9mIHZhbHVlID09ICdzdHJpbmcnICYmIHZhbHVlICE9J2ZhbHNlJykKICAgICAgICBjdXJyZW50W25hbWVdID0gdmFsdWU7CiAgICB9CiAgfQogIHJldHVybiBjdXJyZW50Owp9CgovLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KZnVuY3Rpb24ganFMaXRlV3JhcChlbGVtZW50KSB7CiAgaWYgKGlzU3RyaW5nKGVsZW1lbnQpICYmIGVsZW1lbnQuY2hhckF0KDApICE9ICc8JykgewogICAgdGhyb3cgbmV3IEVycm9yKCdzZWxlY3RvcnMgbm90IGltcGxlbWVudGVkJyk7CiAgfQogIHJldHVybiBuZXcgSlFMaXRlKGVsZW1lbnQpOwp9CgpmdW5jdGlvbiBKUUxpdGUoZWxlbWVudCkgewogIGlmIChlbGVtZW50IGluc3RhbmNlb2YgSlFMaXRlKSB7CiAgICByZXR1cm4gZWxlbWVudDsKICB9IGVsc2UgaWYgKGlzU3RyaW5nKGVsZW1lbnQpKSB7CiAgICB2YXIgZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAvLyBSZWFkIGFib3V0IHRoZSBOb1Njb3BlIGVsZW1lbnRzIGhlcmU6CiAgICAvLyBodHRwOi8vbXNkbi5taWNyb3NvZnQuY29tL2VuLXVzL2xpYnJhcnkvbXM1MzM4OTcoVlMuODUpLmFzcHgKICAgIGRpdi5pbm5lckhUTUwgPSAnPGRpdj4mbmJzcDs8L2Rpdj4nICsgZWxlbWVudDsgLy8gSUUgaW5zYW5pdHkgdG8gbWFrZSBOb1Njb3BlIGVsZW1lbnRzIHdvcmshCiAgICBkaXYucmVtb3ZlQ2hpbGQoZGl2LmZpcnN0Q2hpbGQpOyAvLyByZW1vdmUgdGhlIHN1cGVyZmx1b3VzIGRpdgogICAgSlFMaXRlQWRkTm9kZXModGhpcywgZGl2LmNoaWxkTm9kZXMpOwogICAgdGhpcy5yZW1vdmUoKTsgLy8gZGV0YWNoIHRoZSBlbGVtZW50cyBmcm9tIHRoZSB0ZW1wb3JhcnkgRE9NIGRpdi4KICB9IGVsc2UgewogICAgSlFMaXRlQWRkTm9kZXModGhpcywgZWxlbWVudCk7CiAgfQp9CgpmdW5jdGlvbiBKUUxpdGVDbG9uZShlbGVtZW50KSB7CiAgcmV0dXJuIGVsZW1lbnQuY2xvbmVOb2RlKHRydWUpOwp9CgpmdW5jdGlvbiBKUUxpdGVEZWFsb2MoZWxlbWVudCl7CiAgSlFMaXRlUmVtb3ZlRGF0YShlbGVtZW50KTsKICBmb3IgKCB2YXIgaSA9IDAsIGNoaWxkcmVuID0gZWxlbWVudC5jaGlsZE5vZGVzIHx8IFtdOyBpIDwgY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHsKICAgIEpRTGl0ZURlYWxvYyhjaGlsZHJlbltpXSk7CiAgfQp9CgpmdW5jdGlvbiBKUUxpdGVSZW1vdmVEYXRhKGVsZW1lbnQpIHsKICB2YXIgY2FjaGVJZCA9IGVsZW1lbnRbanFOYW1lXSwKICBjYWNoZSA9IGpxQ2FjaGVbY2FjaGVJZF07CiAgaWYgKGNhY2hlKSB7CiAgICBmb3JFYWNoKGNhY2hlLmJpbmQgfHwge30sIGZ1bmN0aW9uKGZuLCB0eXBlKXsKICAgICAgcmVtb3ZlRXZlbnRMaXN0ZW5lckZuKGVsZW1lbnQsIHR5cGUsIGZuKTsKICAgIH0pOwogICAgZGVsZXRlIGpxQ2FjaGVbY2FjaGVJZF07CiAgICBlbGVtZW50W2pxTmFtZV0gPSB1bmRlZmluZWQ7IC8vIGllIGRvZXMgbm90IGFsbG93IGRlbGV0aW9uIG9mIGF0dHJpYnV0ZXMgb24gZWxlbWVudHMuCiAgfQp9CgpmdW5jdGlvbiBKUUxpdGVEYXRhKGVsZW1lbnQsIGtleSwgdmFsdWUpIHsKICB2YXIgY2FjaGVJZCA9IGVsZW1lbnRbanFOYW1lXSwKICAgICAgY2FjaGUgPSBqcUNhY2hlW2NhY2hlSWQgfHwgLTFdOwogIGlmIChpc0RlZmluZWQodmFsdWUpKSB7CiAgICBpZiAoIWNhY2hlKSB7CiAgICAgIGVsZW1lbnRbanFOYW1lXSA9IGNhY2hlSWQgPSBqcU5leHRJZCgpOwogICAgICBjYWNoZSA9IGpxQ2FjaGVbY2FjaGVJZF0gPSB7fTsKICAgIH0KICAgIGNhY2hlW2tleV0gPSB2YWx1ZTsKICB9IGVsc2UgewogICAgcmV0dXJuIGNhY2hlID8gY2FjaGVba2V5XSA6IG51bGw7CiAgfQp9CgpmdW5jdGlvbiBKUUxpdGVIYXNDbGFzcyhlbGVtZW50LCBzZWxlY3RvciwgXykgewogIC8vIHRoZSBhcmd1bWVudCAnXycgaXMgaW1wb3J0YW50LCBzaW5jZSBpdCBtYWtlcyB0aGUgZnVuY3Rpb24gaGF2ZSAzIGFyZ3VtZW50cywgd2hpY2gKICAvLyBpcyBuZWVkZWQgZm9yIGRlbGVnYXRlIGZ1bmN0aW9uIHRvIHJlYWxpemUgdGhlIHRoaXMgaXMgYSBnZXR0ZXIuCiAgdmFyIGNsYXNzTmFtZSA9ICIgIiArIHNlbGVjdG9yICsgIiAiOwogIHJldHVybiAoKCIgIiArIGVsZW1lbnQuY2xhc3NOYW1lICsgIiAiKS5yZXBsYWNlKC9bXG5cdF0vZywgIiAiKS5pbmRleE9mKCBjbGFzc05hbWUgKSA+IC0xKTsKfQoKZnVuY3Rpb24gSlFMaXRlUmVtb3ZlQ2xhc3MoZWxlbWVudCwgc2VsZWN0b3IpIHsKICBlbGVtZW50LmNsYXNzTmFtZSA9IHRyaW0oCiAgICAgICgiICIgKyBlbGVtZW50LmNsYXNzTmFtZSArICIgIikKICAgICAgLnJlcGxhY2UoL1tcblx0XS9nLCAiICIpCiAgICAgIC5yZXBsYWNlKCIgIiArIHNlbGVjdG9yICsgIiAiLCAiIikKICApOwp9CgpmdW5jdGlvbiBKUUxpdGVBZGRDbGFzcyhlbGVtZW50LCBzZWxlY3RvciApIHsKICBpZiAoIUpRTGl0ZUhhc0NsYXNzKGVsZW1lbnQsIHNlbGVjdG9yKSkgewogICAgZWxlbWVudC5jbGFzc05hbWUgPSB0cmltKGVsZW1lbnQuY2xhc3NOYW1lICsgJyAnICsgc2VsZWN0b3IpOwogIH0KfQoKZnVuY3Rpb24gSlFMaXRlQWRkTm9kZXMocm9vdCwgZWxlbWVudHMpIHsKICBpZiAoZWxlbWVudHMpIHsKICAgIGVsZW1lbnRzID0gKCFlbGVtZW50cy5ub2RlTmFtZSAmJiBpc0RlZmluZWQoZWxlbWVudHMubGVuZ3RoKSAmJiAhaXNXaW5kb3coZWxlbWVudHMpKQogICAgICA/IGVsZW1lbnRzCiAgICAgIDogWyBlbGVtZW50cyBdOwogICAgZm9yKHZhciBpPTA7IGkgPCBlbGVtZW50cy5sZW5ndGg7IGkrKykgewogICAgICByb290LnB1c2goZWxlbWVudHNbaV0pOwogICAgfQogIH0KfQoKLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCi8vIEZ1bmN0aW9ucyB3aGljaCBhcmUgZGVjbGFyZWQgZGlyZWN0bHkuCi8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwp2YXIgSlFMaXRlUHJvdG90eXBlID0gSlFMaXRlLnByb3RvdHlwZSA9IHsKICByZWFkeTogZnVuY3Rpb24oZm4pIHsKICAgIHZhciBmaXJlZCA9IGZhbHNlOwoKICAgIGZ1bmN0aW9uIHRyaWdnZXIoKSB7CiAgICAgIGlmIChmaXJlZCkgcmV0dXJuOwogICAgICBmaXJlZCA9IHRydWU7CiAgICAgIGZuKCk7CiAgICB9CgogICAgdGhpcy5iaW5kKCdET01Db250ZW50TG9hZGVkJywgdHJpZ2dlcik7IC8vIHdvcmtzIGZvciBtb2Rlcm4gYnJvd3NlcnMgYW5kIElFOQogICAgLy8gd2UgY2FuIG5vdCB1c2UganFMaXRlIHNpbmNlIHdlIGFyZSBub3QgZG9uZSBsb2FkaW5nIGFuZCBqUXVlcnkgY291bGQgYmUgbG9hZGVkIGxhdGVyLgogICAganFMaXRlV3JhcCh3aW5kb3cpLmJpbmQoJ2xvYWQnLCB0cmlnZ2VyKTsgLy8gZmFsbGJhY2sgdG8gd2luZG93Lm9ubG9hZCBmb3Igb3RoZXJzCiAgfSwKICB0b1N0cmluZzogZnVuY3Rpb24oKSB7CiAgICB2YXIgdmFsdWUgPSBbXTsKICAgIGZvckVhY2godGhpcywgZnVuY3Rpb24oZSl7IHZhbHVlLnB1c2goJycgKyBlKTt9KTsKICAgIHJldHVybiAnWycgKyB2YWx1ZS5qb2luKCcsICcpICsgJ10nOwogIH0sCgogIGVxOiBmdW5jdGlvbihpbmRleCkgewogICAgICByZXR1cm4gKGluZGV4ID49IDApID8ganFMaXRlKHRoaXNbaW5kZXhdKSA6IGpxTGl0ZSh0aGlzW3RoaXMubGVuZ3RoICsgaW5kZXhdKTsKICB9LAoKICBsZW5ndGg6IDAsCiAgcHVzaDogcHVzaCwKICBzb3J0OiBbXS5zb3J0LAogIHNwbGljZTogW10uc3BsaWNlCn07CgovLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KLy8gRnVuY3Rpb25zIGl0ZXJhdGluZyBnZXR0ZXIvc2V0dGVycy4KLy8gdGhlc2UgZnVuY3Rpb25zIHJldHVybiBzZWxmIG9uIHNldHRlciBhbmQKLy8gdmFsdWUgb24gZ2V0LgovLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KdmFyIFNQRUNJQUxfQVRUUiA9IG1ha2VNYXAoIm11bHRpcGxlLHNlbGVjdGVkLGNoZWNrZWQsZGlzYWJsZWQscmVhZG9ubHkiKTsKCmZvckVhY2goewogIGRhdGE6IEpRTGl0ZURhdGEsCgogIHNjb3BlOiBmdW5jdGlvbihlbGVtZW50KSB7CiAgICB2YXIgc2NvcGU7CiAgICB3aGlsZSAoZWxlbWVudCAmJiAhKHNjb3BlID0ganFMaXRlKGVsZW1lbnQpLmRhdGEoJCRzY29wZSkpKSB7CiAgICAgIGVsZW1lbnQgPSBlbGVtZW50LnBhcmVudE5vZGU7CiAgICB9CiAgICByZXR1cm4gc2NvcGU7CiAgfSwKCiAgcmVtb3ZlQXR0cjogZnVuY3Rpb24oZWxlbWVudCxuYW1lKSB7CiAgICBlbGVtZW50LnJlbW92ZUF0dHJpYnV0ZShuYW1lKTsKICB9LAoKICBoYXNDbGFzczogSlFMaXRlSGFzQ2xhc3MsCgogIGNzczogZnVuY3Rpb24oZWxlbWVudCwgbmFtZSwgdmFsdWUpIHsKICAgIGlmIChpc0RlZmluZWQodmFsdWUpKSB7CiAgICAgIGVsZW1lbnQuc3R5bGVbbmFtZV0gPSB2YWx1ZTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBlbGVtZW50LnN0eWxlW25hbWVdOwogICAgfQogIH0sCgogIGF0dHI6IGZ1bmN0aW9uKGVsZW1lbnQsIG5hbWUsIHZhbHVlKXsKICAgIGlmIChTUEVDSUFMX0FUVFJbbmFtZV0pIHsKICAgICAgaWYgKGlzRGVmaW5lZCh2YWx1ZSkpIHsKICAgICAgICBlbGVtZW50W25hbWVdID0gISF2YWx1ZTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gZWxlbWVudFtuYW1lXTsKICAgICAgfQogICAgfSBlbHNlIGlmIChpc0RlZmluZWQodmFsdWUpKSB7CiAgICAgIGVsZW1lbnQuc2V0QXR0cmlidXRlKG5hbWUsIHZhbHVlKTsKICAgIH0gZWxzZSBpZiAoZWxlbWVudC5nZXRBdHRyaWJ1dGUpIHsKICAgICAgLy8gdGhlIGV4dHJhIGFyZ3VtZW50ICIyIiBpcyB0byBnZXQgdGhlIHJpZ2h0IHRoaW5nIGZvciBhLmhyZWYgaW4gSUUsIHNlZSBqUXVlcnkgY29kZQogICAgICAvLyBzb21lIGVsZW1lbnRzIChlLmcuIERvY3VtZW50KSBkb24ndCBoYXZlIGdldCBhdHRyaWJ1dGUsIHNvIHJldHVybiB1bmRlZmluZWQKICAgICAgdmFyIHJldCA9IGVsZW1lbnQuZ2V0QXR0cmlidXRlKG5hbWUsIDIpOwogICAgICAvLyBub3JtYWxpemUgbm9uLWV4aXN0aW5nIGF0dHJpYnV0ZXMgdG8gdW5kZWZpbmVkIChhcyBqUXVlcnkpCiAgICAgIHJldHVybiByZXQgPT09IG51bGwgPyB1bmRlZmluZWQgOiByZXQ7CiAgICB9CiAgfSwKCiAgdGV4dDogZXh0ZW5kKChtc2llIDwgOSkKICAgICAgPyBmdW5jdGlvbihlbGVtZW50LCB2YWx1ZSkgewogICAgICAgIC8vIE5vZGVUeXBlID09IDMgaXMgdGV4dCBub2RlCiAgICAgICAgaWYgKGVsZW1lbnQubm9kZVR5cGUgPT0gMykgewogICAgICAgICAgaWYgKGlzVW5kZWZpbmVkKHZhbHVlKSkKICAgICAgICAgICAgcmV0dXJuIGVsZW1lbnQubm9kZVZhbHVlOwogICAgICAgICAgZWxlbWVudC5ub2RlVmFsdWUgPSB2YWx1ZTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgaWYgKGlzVW5kZWZpbmVkKHZhbHVlKSkKICAgICAgICAgICAgcmV0dXJuIGVsZW1lbnQuaW5uZXJUZXh0OwogICAgICAgICAgZWxlbWVudC5pbm5lclRleHQgPSB2YWx1ZTsKICAgICAgICB9CiAgICAgIH0KICAgICAgOiBmdW5jdGlvbihlbGVtZW50LCB2YWx1ZSkgewogICAgICAgIGlmIChpc1VuZGVmaW5lZCh2YWx1ZSkpIHsKICAgICAgICAgIHJldHVybiBlbGVtZW50LnRleHRDb250ZW50OwogICAgICAgIH0KICAgICAgICBlbGVtZW50LnRleHRDb250ZW50ID0gdmFsdWU7CiAgICAgIH0sIHskZHY6Jyd9KSwKCiAgdmFsOiBmdW5jdGlvbihlbGVtZW50LCB2YWx1ZSkgewogICAgaWYgKGlzVW5kZWZpbmVkKHZhbHVlKSkgewogICAgICByZXR1cm4gZWxlbWVudC52YWx1ZTsKICAgIH0KICAgIGVsZW1lbnQudmFsdWUgPSB2YWx1ZTsKICB9LAoKICBodG1sOiBmdW5jdGlvbihlbGVtZW50LCB2YWx1ZSkgewogICAgaWYgKGlzVW5kZWZpbmVkKHZhbHVlKSkgewogICAgICByZXR1cm4gZWxlbWVudC5pbm5lckhUTUw7CiAgICB9CiAgICBmb3IgKHZhciBpID0gMCwgY2hpbGROb2RlcyA9IGVsZW1lbnQuY2hpbGROb2RlczsgaSA8IGNoaWxkTm9kZXMubGVuZ3RoOyBpKyspIHsKICAgICAgSlFMaXRlRGVhbG9jKGNoaWxkTm9kZXNbaV0pOwogICAgfQogICAgZWxlbWVudC5pbm5lckhUTUwgPSB2YWx1ZTsKICB9Cn0sIGZ1bmN0aW9uKGZuLCBuYW1lKXsKICAvKioKICAgKiBQcm9wZXJ0aWVzOiB3cml0ZXMgcmV0dXJuIHNlbGVjdGlvbiwgcmVhZHMgcmV0dXJuIGZpcnN0IHZhbHVlCiAgICovCiAgSlFMaXRlLnByb3RvdHlwZVtuYW1lXSA9IGZ1bmN0aW9uKGFyZzEsIGFyZzIpIHsKICAgIHZhciBpLCBrZXk7CgogICAgaWYgKChmbi5sZW5ndGggPT0gMiA/IGFyZzEgOiBhcmcyKSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgIGlmIChpc09iamVjdChhcmcxKSkgewogICAgICAgIC8vIHdlIGFyZSBhIHdyaXRlLCBidXQgdGhlIG9iamVjdCBwcm9wZXJ0aWVzIGFyZSB0aGUga2V5L3ZhbHVlcwogICAgICAgIGZvcihpPTA7IGkgPCB0aGlzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBmb3IgKGtleSBpbiBhcmcxKSB7CiAgICAgICAgICAgIGZuKHRoaXNbaV0sIGtleSwgYXJnMVtrZXldKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgLy8gcmV0dXJuIHNlbGYgZm9yIGNoYWluaW5nCiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gd2UgYXJlIGEgcmVhZCwgc28gcmVhZCB0aGUgZmlyc3QgY2hpbGQuCiAgICAgICAgaWYgKHRoaXMubGVuZ3RoKQogICAgICAgICAgcmV0dXJuIGZuKHRoaXNbMF0sIGFyZzEsIGFyZzIpOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICAvLyB3ZSBhcmUgYSB3cml0ZSwgc28gYXBwbHkgdG8gYWxsIGNoaWxkcmVuCiAgICAgIGZvcihpPTA7IGkgPCB0aGlzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgZm4odGhpc1tpXSwgYXJnMSwgYXJnMik7CiAgICAgIH0KICAgICAgLy8gcmV0dXJuIHNlbGYgZm9yIGNoYWluaW5nCiAgICAgIHJldHVybiB0aGlzOwogICAgfQogICAgcmV0dXJuIGZuLiRkdjsKICB9Owp9KTsKCi8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwovLyBGdW5jdGlvbnMgaXRlcmF0aW5nIHRyYXZlcnNhbC4KLy8gVGhlc2UgZnVuY3Rpb25zIGNoYWluIHJlc3VsdHMgaW50byBhIHNpbmdsZQovLyBzZWxlY3Rvci4KLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCmZvckVhY2goewogIHJlbW92ZURhdGE6IEpRTGl0ZVJlbW92ZURhdGEsCgogIGRlYWxvYzogSlFMaXRlRGVhbG9jLAoKICBiaW5kOiBmdW5jdGlvbihlbGVtZW50LCB0eXBlLCBmbil7CiAgICB2YXIgYmluZCA9IEpRTGl0ZURhdGEoZWxlbWVudCwgJ2JpbmQnKTsKICAgIGlmICghYmluZCkgSlFMaXRlRGF0YShlbGVtZW50LCAnYmluZCcsIGJpbmQgPSB7fSk7CiAgICBmb3JFYWNoKHR5cGUuc3BsaXQoJyAnKSwgZnVuY3Rpb24odHlwZSl7CiAgICAgIHZhciBldmVudEhhbmRsZXIgPSBiaW5kW3R5cGVdOwogICAgICBpZiAoIWV2ZW50SGFuZGxlcikgewogICAgICAgIGJpbmRbdHlwZV0gPSBldmVudEhhbmRsZXIgPSBmdW5jdGlvbihldmVudCkgewogICAgICAgICAgaWYgKCFldmVudC5wcmV2ZW50RGVmYXVsdCkgewogICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCA9IGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICAgZXZlbnQucmV0dXJuVmFsdWUgPSBmYWxzZTsgLy9pZQogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgICAgaWYgKCFldmVudC5zdG9wUHJvcGFnYXRpb24pIHsKICAgICAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgZXZlbnQuY2FuY2VsQnViYmxlID0gdHJ1ZTsgLy9pZQogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgICAgaWYgKCFldmVudC50YXJnZXQpIHsKICAgICAgICAgICAgZXZlbnQudGFyZ2V0ID0gZXZlbnQuc3JjRWxlbWVudCB8fCBkb2N1bWVudDsKICAgICAgICAgIH0KICAgICAgICAgIGZvckVhY2goZXZlbnRIYW5kbGVyLmZucywgZnVuY3Rpb24oZm4pewogICAgICAgICAgICBmbi5jYWxsKGVsZW1lbnQsIGV2ZW50KTsKICAgICAgICAgIH0pOwogICAgICAgIH07CiAgICAgICAgZXZlbnRIYW5kbGVyLmZucyA9IFtdOwogICAgICAgIGFkZEV2ZW50TGlzdGVuZXJGbihlbGVtZW50LCB0eXBlLCBldmVudEhhbmRsZXIpOwogICAgICB9CiAgICAgIGV2ZW50SGFuZGxlci5mbnMucHVzaChmbik7CiAgICB9KTsKICB9LAoKICByZXBsYWNlV2l0aDogZnVuY3Rpb24oZWxlbWVudCwgcmVwbGFjZU5vZGUpIHsKICAgIHZhciBpbmRleCwgcGFyZW50ID0gZWxlbWVudC5wYXJlbnROb2RlOwogICAgSlFMaXRlRGVhbG9jKGVsZW1lbnQpOwogICAgZm9yRWFjaChuZXcgSlFMaXRlKHJlcGxhY2VOb2RlKSwgZnVuY3Rpb24obm9kZSl7CiAgICAgIGlmIChpbmRleCkgewogICAgICAgIHBhcmVudC5pbnNlcnRCZWZvcmUobm9kZSwgaW5kZXgubmV4dFNpYmxpbmcpOwogICAgICB9IGVsc2UgewogICAgICAgIHBhcmVudC5yZXBsYWNlQ2hpbGQobm9kZSwgZWxlbWVudCk7CiAgICAgIH0KICAgICAgaW5kZXggPSBub2RlOwogICAgfSk7CiAgfSwKCiAgY2hpbGRyZW46IGZ1bmN0aW9uKGVsZW1lbnQpIHsKICAgIHZhciBjaGlsZHJlbiA9IFtdOwogICAgZm9yRWFjaChlbGVtZW50LmNoaWxkTm9kZXMsIGZ1bmN0aW9uKGVsZW1lbnQpewogICAgICBpZiAoZWxlbWVudC5ub2RlTmFtZSAhPSAnI3RleHQnKQogICAgICAgIGNoaWxkcmVuLnB1c2goZWxlbWVudCk7CiAgICB9KTsKICAgIHJldHVybiBjaGlsZHJlbjsKICB9LAoKICBhcHBlbmQ6IGZ1bmN0aW9uKGVsZW1lbnQsIG5vZGUpIHsKICAgIGZvckVhY2gobmV3IEpRTGl0ZShub2RlKSwgZnVuY3Rpb24oY2hpbGQpewogICAgICBpZiAoZWxlbWVudC5ub2RlVHlwZSA9PT0gMSkKICAgICAgICBlbGVtZW50LmFwcGVuZENoaWxkKGNoaWxkKTsKICAgIH0pOwogIH0sCgogIHByZXBlbmQ6IGZ1bmN0aW9uKGVsZW1lbnQsIG5vZGUpIHsKICAgIGlmIChlbGVtZW50Lm5vZGVUeXBlID09PSAxKSB7CiAgICAgIHZhciBpbmRleCA9IGVsZW1lbnQuZmlyc3RDaGlsZDsKICAgICAgZm9yRWFjaChuZXcgSlFMaXRlKG5vZGUpLCBmdW5jdGlvbihjaGlsZCl7CiAgICAgICAgaWYgKGluZGV4KSB7CiAgICAgICAgICBlbGVtZW50Lmluc2VydEJlZm9yZShjaGlsZCwgaW5kZXgpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBlbGVtZW50LmFwcGVuZENoaWxkKGNoaWxkKTsKICAgICAgICAgIGluZGV4ID0gY2hpbGQ7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICB9LAoKICByZW1vdmU6IGZ1bmN0aW9uKGVsZW1lbnQpIHsKICAgIEpRTGl0ZURlYWxvYyhlbGVtZW50KTsKICAgIHZhciBwYXJlbnQgPSBlbGVtZW50LnBhcmVudE5vZGU7CiAgICBpZiAocGFyZW50KSBwYXJlbnQucmVtb3ZlQ2hpbGQoZWxlbWVudCk7CiAgfSwKCiAgYWZ0ZXI6IGZ1bmN0aW9uKGVsZW1lbnQsIG5ld0VsZW1lbnQpIHsKICAgIHZhciBpbmRleCA9IGVsZW1lbnQsIHBhcmVudCA9IGVsZW1lbnQucGFyZW50Tm9kZTsKICAgIGZvckVhY2gobmV3IEpRTGl0ZShuZXdFbGVtZW50KSwgZnVuY3Rpb24obm9kZSl7CiAgICAgIHBhcmVudC5pbnNlcnRCZWZvcmUobm9kZSwgaW5kZXgubmV4dFNpYmxpbmcpOwogICAgICBpbmRleCA9IG5vZGU7CiAgICB9KTsKICB9LAoKICBhZGRDbGFzczogSlFMaXRlQWRkQ2xhc3MsCiAgcmVtb3ZlQ2xhc3M6IEpRTGl0ZVJlbW92ZUNsYXNzLAoKICB0b2dnbGVDbGFzczogZnVuY3Rpb24oZWxlbWVudCwgc2VsZWN0b3IsIGNvbmRpdGlvbikgewogICAgaWYgKGlzVW5kZWZpbmVkKGNvbmRpdGlvbikpIHsKICAgICAgY29uZGl0aW9uID0gIUpRTGl0ZUhhc0NsYXNzKGVsZW1lbnQsIHNlbGVjdG9yKTsKICAgIH0KICAgIChjb25kaXRpb24gPyBKUUxpdGVBZGRDbGFzcyA6IEpRTGl0ZVJlbW92ZUNsYXNzKShlbGVtZW50LCBzZWxlY3Rvcik7CiAgfSwKCiAgcGFyZW50OiBmdW5jdGlvbihlbGVtZW50KSB7CiAgICB2YXIgcGFyZW50ID0gZWxlbWVudC5wYXJlbnROb2RlOwogICAgcmV0dXJuIHBhcmVudCAmJiBwYXJlbnQubm9kZVR5cGUgIT09IDExID8gcGFyZW50IDogbnVsbDsKICB9LAoKICBuZXh0OiBmdW5jdGlvbihlbGVtZW50KSB7CiAgICByZXR1cm4gZWxlbWVudC5uZXh0U2libGluZzsKICB9LAoKICBmaW5kOiBmdW5jdGlvbihlbGVtZW50LCBzZWxlY3RvcikgewogICAgcmV0dXJuIGVsZW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoc2VsZWN0b3IpOwogIH0sCgogIGNsb25lOiBKUUxpdGVDbG9uZQp9LCBmdW5jdGlvbihmbiwgbmFtZSl7CiAgLyoqCiAgICogY2hhaW5pbmcgZnVuY3Rpb25zCiAgICovCiAgSlFMaXRlLnByb3RvdHlwZVtuYW1lXSA9IGZ1bmN0aW9uKGFyZzEsIGFyZzIpIHsKICAgIHZhciB2YWx1ZTsKICAgIGZvcih2YXIgaT0wOyBpIDwgdGhpcy5sZW5ndGg7IGkrKykgewogICAgICBpZiAodmFsdWUgPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgdmFsdWUgPSBmbih0aGlzW2ldLCBhcmcxLCBhcmcyKTsKICAgICAgICBpZiAodmFsdWUgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgLy8gYW55IGZ1bmN0aW9uIHdoaWNoIHJldHVybnMgYSB2YWx1ZSBuZWVkcyB0byBiZSB3cmFwcGVkCiAgICAgICAgICB2YWx1ZSA9IGpxTGl0ZSh2YWx1ZSk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIEpRTGl0ZUFkZE5vZGVzKHZhbHVlLCBmbih0aGlzW2ldLCBhcmcxLCBhcmcyKSk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiB2YWx1ZSA9PSB1bmRlZmluZWQgPyB0aGlzIDogdmFsdWU7CiAgfTsKfSk7Cid1c2Ugc3RyaWN0JzsKCnZhciBhbmd1bGFyR2xvYmFsID0gewogICd0eXBlT2YnOmZ1bmN0aW9uKG9iail7CiAgICBpZiAob2JqID09PSBudWxsKSByZXR1cm4gJG51bGw7CiAgICB2YXIgdHlwZSA9IHR5cGVvZiBvYmo7CiAgICBpZiAodHlwZSA9PSAkb2JqZWN0KSB7CiAgICAgIGlmIChvYmogaW5zdGFuY2VvZiBBcnJheSkgcmV0dXJuICRhcnJheTsKICAgICAgaWYgKGlzRGF0ZShvYmopKSByZXR1cm4gJGRhdGU7CiAgICAgIGlmIChvYmoubm9kZVR5cGUgPT0gMSkgcmV0dXJuICRlbGVtZW50OwogICAgfQogICAgcmV0dXJuIHR5cGU7CiAgfQp9OwoKCi8qKgogKiBAbmdkb2Mgb3ZlcnZpZXcKICogQG5hbWUgYW5ndWxhci5PYmplY3QKICogQGZ1bmN0aW9uCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBBIG5hbWVzcGFjZSBmb3IgdXRpbGl0eSBmdW5jdGlvbnMgdXNlZCB0byB3b3JrIHdpdGggSmF2YVNjcmlwdCBvYmplY3RzLiBUaGVzZSBmdW5jdGlvbnMgYXJlCiAqIGV4cG9zZWQgaW4gdHdvIHdheXM6CiAqCiAqIF9fKiBBbmd1bGFyIGV4cHJlc3Npb25zOl9fIEZ1bmN0aW9ucyBhcmUgYm91bmQgdG8gYWxsIG9iamVjdHMgYW5kIGF1Z21lbnQgdGhlIE9iamVjdCB0eXBlLiBUaGUKICogbmFtZXMgb2YgdGhlc2UgbWV0aG9kcyBhcmUgcHJlZml4ZWQgd2l0aCB0aGUgJyQnIGNoYXJhY3RlciBpbiBvcmRlciB0byBtaW5pbWl6ZSBuYW1pbmcgY29sbGlzaW9ucy4KICogVG8gY2FsbCBhIG1ldGhvZCwgaW52b2tlIHRoZSBmdW5jdGlvbiB3aXRob3V0IHRoZSBmaXJzdCBhcmd1bWVudCwgZS5nLCBgbXlPYmplY3QuJGZvbyhwYXJhbTIpYC4KICoKICogX18qIEphdmFTY3JpcHQgY29kZTpfXyBGdW5jdGlvbnMgZG9uJ3QgYXVnbWVudCB0aGUgT2JqZWN0IHR5cGUgYW5kIG11c3QgYmUgaW52b2tlZCBhcyBmdW5jdGlvbnMgb2YKICogYGFuZ3VsYXIuT2JqZWN0YCBhcyBgYW5ndWxhci5PYmplY3QuZm9vKG15T2JqZWN0LCBwYXJhbTIpYC4KICoKICogKiB7QGxpbmsgYW5ndWxhci5PYmplY3QuY29weSBhbmd1bGFyLk9iamVjdC5jb3B5KCl9IC0gQ3JlYXRlcyBhIGRlZXAgY29weSBvZiB0aGUgc291cmNlIHBhcmFtZXRlcgogKiAqIHtAbGluayBhbmd1bGFyLk9iamVjdC5lcXVhbHMgYW5ndWxhci5PYmplY3QuZXF1YWxzKCl9IC0gRGV0ZXJtaW5lcyBpZiB0d28gb2JqZWN0cyBvciB2YWx1ZXMgYXJlCiAqIGVxdWl2YWxlbnQKICogKiB7QGxpbmsgYW5ndWxhci5PYmplY3Quc2l6ZSBhbmd1bGFyLk9iamVjdC5zaXplKCl9IC0gRGV0ZXJtaW5lcyB0aGUgbnVtYmVyIG9mIGVsZW1lbnRzIGluCiAqIHN0cmluZ3MsIGFycmF5cywgYW5kIG9iamVjdHMuCiAqLwp2YXIgYW5ndWxhckNvbGxlY3Rpb24gPSB7CiAgJ2NvcHknOiBjb3B5LAogICdzaXplJzogc2l6ZSwKICAnZXF1YWxzJzogZXF1YWxzCn07CnZhciBhbmd1bGFyT2JqZWN0ID0gewogICdleHRlbmQnOiBleHRlbmQKfTsKCi8qKgogKiBAbmdkb2Mgb3ZlcnZpZXcKICogQG5hbWUgYW5ndWxhci5BcnJheQogKgogKiBAZGVzY3JpcHRpb24KICogQSBuYW1lc3BhY2UgZm9yIHV0aWxpdHkgZnVuY3Rpb25zIGZvciB0aGUgbWFuaXB1bGF0aW9uIG9mIEphdmFTY3JpcHQgQXJyYXkgb2JqZWN0cy4KICoKICogVGhlc2UgZnVuY3Rpb25zIGFyZSBleHBvc2VkIGluIHR3byB3YXlzOgogKgogKiAqIF9fQW5ndWxhciBleHByZXNzaW9uczpfXyBGdW5jdGlvbnMgYXJlIGJvdW5kIHRvIHRoZSBBcnJheSBvYmplY3RzIGFuZCBhdWdtZW50IHRoZSBBcnJheSB0eXBlIGFzCiAqIGFycmF5IG1ldGhvZHMuIFRoZSBuYW1lcyBvZiB0aGVzZSBtZXRob2RzIGFyZSBwcmVmaXhlZCB3aXRoICQgY2hhcmFjdGVyIHRvIG1pbmltaXplIG5hbWluZwogKiBjb2xsaXNpb25zLiBUbyBjYWxsIGEgbWV0aG9kLCBpbnZva2UgbXlBcnJheU9iamVjdC4kZm9vKHBhcmFtcykuCiAqCiAqICAgICBCZWNhdXNlIEFycmF5IHR5cGUgaXMgYSBzdWJ0eXBlIG9mIHRoZSBPYmplY3QgdHlwZSwgYWxsIGFuZ3VsYXIuT2JqZWN0IGZ1bmN0aW9ucyBhdWdtZW50CiAqICAgICB0aGVBcnJheSB0eXBlIGluIGFuZ3VsYXIgZXhwcmVzc2lvbnMgYXMgd2VsbC4KICoKICogKiBfX0phdmFTY3JpcHQgY29kZTpfXyBGdW5jdGlvbnMgZG9uJ3QgYXVnbWVudCB0aGUgQXJyYXkgdHlwZSBhbmQgbXVzdCBiZSBpbnZva2VkIGFzIGZ1bmN0aW9ucyBvZgogKiBgYW5ndWxhci5BcnJheWAgYXMgYGFuZ3VsYXIuQXJyYXkuZm9vKG15QXJyYXlPYmplY3QsIHBhcmFtcylgLgogKgogKiBUaGUgZm9sbG93aW5nIEFQSXMgYXJlIGJ1aWx0LWluIHRvIHRoZSBhbmd1bGFyIEFycmF5IG9iamVjdDoKICoKICogKiB7QGxpbmsgYW5ndWxhci5BcnJheS5hZGQgYW5ndWxhci5BcnJheS5hZGQoKX0gLSBPcHRpb25hbGx5IGFkZHMgYSBuZXcgZWxlbWVudCB0byBhbiBhcnJheS4KICogKiB7QGxpbmsgYW5ndWxhci5BcnJheS5jb3VudCBhbmd1bGFyLkFycmF5LmNvdW50KCl9IC0gRGV0ZXJtaW5lcyB0aGUgbnVtYmVyIG9mIGVsZW1lbnRzIGluIGFuCiAqIGFycmF5LgogKiAqIHtAbGluayBhbmd1bGFyLkFycmF5LmZpbHRlciBhbmd1bGFyLkFycmF5LmZpbHRlcigpfSAtIFJldHVybnMgYSBzdWJzZXQgb2YgaXRlbXMgYXMgYSBuZXcgYXJyYXkuCiAqICoge0BsaW5rIGFuZ3VsYXIuQXJyYXkuaW5kZXhPZiBhbmd1bGFyLkFycmF5LmluZGV4T2YoKX0gLSBEZXRlcm1pbmVzIHRoZSBpbmRleCBvZiBhbiBhcnJheSB2YWx1ZS4KICogKiB7QGxpbmsgYW5ndWxhci5BcnJheS5saW1pdFRvIGFuZ3VsYXIuQXJyYXkubGltaXRUbygpfSAtIENyZWF0ZXMgYSBuZXcgYXJyYXkgb2ZmIHRoZSBmcm9udCBvcgogKiBiYWNrIG9mIGFuIGV4aXN0aW5nIGFycmF5LgogKiAqIHtAbGluayBhbmd1bGFyLkFycmF5Lm9yZGVyQnkgYW5ndWxhci5BcnJheS5vcmRlckJ5KCl9IC0gT3JkZXJzIGFycmF5IGVsZW1lbnRzCiAqICoge0BsaW5rIGFuZ3VsYXIuQXJyYXkucmVtb3ZlIGFuZ3VsYXIuQXJyYXkucmVtb3ZlKCl9IC0gUmVtb3ZlcyBhcnJheSBlbGVtZW50cwogKiAqIHtAbGluayBhbmd1bGFyLkFycmF5LnN1bSBhbmd1bGFyLkFycmF5LnN1bSgpfSAtIFN1bXMgdGhlIG51bWJlciBlbGVtZW50cyBpbiBhbiBhcnJheQogKi8KdmFyIGFuZ3VsYXJBcnJheSA9IHsKCgogIC8qKgogICAqIEBuZ2RvYyBmdW5jdGlvbgogICAqIEBuYW1lIGFuZ3VsYXIuQXJyYXkuaW5kZXhPZgogICAqIEBmdW5jdGlvbgogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogRGV0ZXJtaW5lcyB0aGUgaW5kZXggb2YgYHZhbHVlYCBpbiBgYXJyYXlgLgogICAqCiAgICogTm90ZTogdGhpcyBmdW5jdGlvbiBpcyB1c2VkIHRvIGF1Z21lbnQgdGhlIGBBcnJheWAgdHlwZSBpbiBhbmd1bGFyIGV4cHJlc3Npb25zLiBTZWUKICAgKiB7QGxpbmsgYW5ndWxhci5BcnJheX0gZm9yIG1vcmUgaW5mby4KICAgKgogICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IEFycmF5IHRvIHNlYXJjaC4KICAgKiBAcGFyYW0geyp9IHZhbHVlIFZhbHVlIHRvIHNlYXJjaCBmb3IuCiAgICogQHJldHVybnMge251bWJlcn0gVGhlIHBvc2l0aW9uIG9mIHRoZSBlbGVtZW50IGluIGBhcnJheWAuIFRoZSBwb3NpdGlvbiBpcyAwLWJhc2VkLiBgLTFgIGlzIHJldHVybmVkIGlmIHRoZSB2YWx1ZSBjYW4ndCBiZSBmb3VuZC4KICAgKgogICAqIEBleGFtcGxlCiAgICAgIDxkb2M6ZXhhbXBsZT4KICAgICAgICA8ZG9jOnNvdXJjZT4KICAgICAgICAgPGRpdiBuZzppbml0PSJib29rcyA9IFsnTW9ieSBEaWNrJywgJ0dyZWF0IEdhdHNieScsICdSb21lbyBhbmQgSnVsaWV0J10iPjwvZGl2PgogICAgICAgICA8aW5wdXQgbmFtZT0nYm9va05hbWUnIHZhbHVlPSdSb21lbyBhbmQgSnVsaWV0Jz4gPGJyPgogICAgICAgICBJbmRleCBvZiAne3tib29rTmFtZX19JyBpbiB0aGUgbGlzdCB7e2Jvb2tzfX0gaXMgPGVtPnt7Ym9va3MuJGluZGV4T2YoYm9va05hbWUpfX08L2VtPi4KICAgICAgICA8L2RvYzpzb3VyY2U+CiAgICAgICAgPGRvYzpzY2VuYXJpbz4KICAgICAgICAgaXQoJ3Nob3VsZCBjb3JyZWN0bHkgY2FsY3VsYXRlIHRoZSBpbml0aWFsIGluZGV4JywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ2Jvb2tzLiRpbmRleE9mKGJvb2tOYW1lKScpKS50b0JlKCcyJyk7CiAgICAgICAgIH0pOwoKICAgICAgICAgaXQoJ3Nob3VsZCByZWNhbGN1bGF0ZScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgIGlucHV0KCdib29rTmFtZScpLmVudGVyKCdmb28nKTsKICAgICAgICAgICBleHBlY3QoYmluZGluZygnYm9va3MuJGluZGV4T2YoYm9va05hbWUpJykpLnRvQmUoJy0xJyk7CgogICAgICAgICAgIGlucHV0KCdib29rTmFtZScpLmVudGVyKCdNb2J5IERpY2snKTsKICAgICAgICAgICBleHBlY3QoYmluZGluZygnYm9va3MuJGluZGV4T2YoYm9va05hbWUpJykpLnRvQmUoJzAnKTsKICAgICAgICAgfSk7CiAgICAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgIDwvZG9jOmV4YW1wbGU+CiAgICovCiAgJ2luZGV4T2YnOiBpbmRleE9mLAoKCiAgLyoqCiAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICogQG5hbWUgYW5ndWxhci5BcnJheS5zdW0KICAgKiBAZnVuY3Rpb24KICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFRoaXMgZnVuY3Rpb24gY2FsY3VsYXRlcyB0aGUgc3VtIG9mIGFsbCBudW1iZXJzIGluIGBhcnJheWAuIElmIHRoZSBgZXhwcmVzc2lvbnNgIGlzIHN1cHBsaWVkLAogICAqIGl0IGlzIGV2YWx1YXRlZCBvbmNlIGZvciBlYWNoIGVsZW1lbnQgaW4gYGFycmF5YCBhbmQgdGhlbiB0aGUgc3VtIG9mIHRoZXNlIHZhbHVlcyBpcyByZXR1cm5lZC4KICAgKgogICAqIE5vdGU6IHRoaXMgZnVuY3Rpb24gaXMgdXNlZCB0byBhdWdtZW50IHRoZSBgQXJyYXlgIHR5cGUgaW4gYW5ndWxhciBleHByZXNzaW9ucy4gU2VlCiAgICoge0BsaW5rIGFuZ3VsYXIuQXJyYXl9IGZvciBtb3JlIGluZm8uCiAgICoKICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBUaGUgc291cmNlIGFycmF5LgogICAqIEBwYXJhbSB7KHN0cmluZ3xmdW5jdGlvbigpKT19IGV4cHJlc3Npb24gQW5ndWxhciBleHByZXNzaW9uIG9yIGEgZnVuY3Rpb24gdG8gYmUgZXZhbHVhdGVkIGZvciBlYWNoCiAgICogICAgIGVsZW1lbnQgaW4gYGFycmF5YC4gVGhlIGFycmF5IGVsZW1lbnQgYmVjb21lcyB0aGUgYHRoaXNgIGR1cmluZyB0aGUgZXZhbHVhdGlvbi4KICAgKiBAcmV0dXJucyB7bnVtYmVyfSBTdW0gb2YgaXRlbXMgaW4gdGhlIGFycmF5LgogICAqCiAgICogQGV4YW1wbGUKICAgICAgPGRvYzpleGFtcGxlPgogICAgICAgIDxkb2M6c291cmNlPgogICAgICAgICA8dGFibGUgbmc6aW5pdD0iaW52b2ljZT0ge2l0ZW1zOlt7cXR5OjEwLCBkZXNjcmlwdGlvbjonZ2FkZ2V0JywgY29zdDo5Ljk1fV19Ij4KICAgICAgICAgICA8dHI+PHRoPlF0eTwvdGg+PHRoPkRlc2NyaXB0aW9uPC90aD48dGg+Q29zdDwvdGg+PHRoPlRvdGFsPC90aD48dGg+PC90aD48L3RyPgogICAgICAgICAgIDx0ciBuZzpyZXBlYXQ9Iml0ZW0gaW4gaW52b2ljZS5pdGVtcyI+CiAgICAgICAgICAgICA8dGQ+PGlucHV0IG5hbWU9Iml0ZW0ucXR5IiB2YWx1ZT0iMSIgc2l6ZT0iNCIgbmc6cmVxdWlyZWQgbmc6dmFsaWRhdGU9ImludGVnZXIiPjwvdGQ+CiAgICAgICAgICAgIDx0ZD48aW5wdXQgbmFtZT0iaXRlbS5kZXNjcmlwdGlvbiI+PC90ZD4KICAgICAgICAgICAgICA8dGQ+PGlucHV0IG5hbWU9Iml0ZW0uY29zdCIgdmFsdWU9IjAuMDAiIG5nOnJlcXVpcmVkIG5nOnZhbGlkYXRlPSJudW1iZXIiIHNpemU9IjYiPjwvdGQ+CiAgICAgICAgICAgICA8dGQ+e3tpdGVtLnF0eSAqIGl0ZW0uY29zdCB8IGN1cnJlbmN5fX08L3RkPgogICAgICAgICAgICAgPHRkPls8YSBocmVmIG5nOmNsaWNrPSJpbnZvaWNlLml0ZW1zLiRyZW1vdmUoaXRlbSkiPlg8L2E+XTwvdGQ+CiAgICAgICAgICAgPC90cj4KICAgICAgICAgICA8dHI+CiAgICAgICAgICAgICA8dGQ+PGEgaHJlZiBuZzpjbGljaz0iaW52b2ljZS5pdGVtcy4kYWRkKCkiPmFkZCBpdGVtPC9hPjwvdGQ+CiAgICAgICAgICAgICA8dGQ+PC90ZD4KICAgICAgICAgICAgIDx0ZD5Ub3RhbDo8L3RkPgogICAgICAgICAgICAgPHRkPnt7aW52b2ljZS5pdGVtcy4kc3VtKCdxdHkqY29zdCcpIHwgY3VycmVuY3l9fTwvdGQ+CiAgICAgICAgICAgPC90cj4KICAgICAgICAgPC90YWJsZT4KICAgICAgICA8L2RvYzpzb3VyY2U+CiAgICAgICAgPGRvYzpzY2VuYXJpbz4KICAgICAgICAgLy9UT0RPOiB0aGVzZSBzcGVjcyBhcmUgbGFtZSBiZWNhdXNlIEkgaGFkIHRvIHdvcmsgYXJvdW5kIGlzc3VlcyAjMTY0IGFuZCAjMTY3CiAgICAgICAgIGl0KCdzaG91bGQgaW5pdGlhbGl6ZSBhbmQgY2FsY3VsYXRlIHRoZSB0b3RhbHMnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICBleHBlY3QocmVwZWF0ZXIoJy5kb2MtZXhhbXBsZS1saXZlIHRhYmxlIHRyJywgJ2l0ZW0gaW4gaW52b2ljZS5pdGVtcycpLmNvdW50KCkpLnRvQmUoMyk7CiAgICAgICAgICAgZXhwZWN0KHJlcGVhdGVyKCcuZG9jLWV4YW1wbGUtbGl2ZSB0YWJsZSB0cicsICdpdGVtIGluIGludm9pY2UuaXRlbXMnKS5yb3coMSkpLgogICAgICAgICAgICAgdG9FcXVhbChbJyQ5OS41MCddKTsKICAgICAgICAgICBleHBlY3QoYmluZGluZygiaW52b2ljZS5pdGVtcy4kc3VtKCdxdHkqY29zdCcpIikpLnRvQmUoJyQ5OS41MCcpOwogICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCJpbnZvaWNlLml0ZW1zLiRzdW0oJ3F0eSpjb3N0JykiKSkudG9CZSgnJDk5LjUwJyk7CiAgICAgICAgIH0pOwoKICAgICAgICAgaXQoJ3Nob3VsZCBhZGQgYW4gZW50cnkgYW5kIHJlY2FsY3VsYXRlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgYTpjb250YWlucygiYWRkIGl0ZW0iKScpLmNsaWNrKCk7CiAgICAgICAgICAgdXNpbmcoJy5kb2MtZXhhbXBsZS1saXZlIHRyOm50aC1jaGlsZCgzKScpLmlucHV0KCdpdGVtLnF0eScpLmVudGVyKCcyMCcpOwogICAgICAgICAgIHVzaW5nKCcuZG9jLWV4YW1wbGUtbGl2ZSB0cjpudGgtY2hpbGQoMyknKS5pbnB1dCgnaXRlbS5jb3N0JykuZW50ZXIoJzEwMCcpOwoKICAgICAgICAgICBleHBlY3QocmVwZWF0ZXIoJy5kb2MtZXhhbXBsZS1saXZlIHRhYmxlIHRyJywgJ2l0ZW0gaW4gaW52b2ljZS5pdGVtcycpLnJvdygyKSkuCiAgICAgICAgICAgICB0b0VxdWFsKFsnJDIsMDAwLjAwJ10pOwogICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCJpbnZvaWNlLml0ZW1zLiRzdW0oJ3F0eSpjb3N0JykiKSkudG9CZSgnJDIsMDk5LjUwJyk7CiAgICAgICAgIH0pOwogICAgICAgIDwvZG9jOnNjZW5hcmlvPgogICAgICA8L2RvYzpleGFtcGxlPgogICAqLwogICdzdW0nOmZ1bmN0aW9uKGFycmF5LCBleHByZXNzaW9uKSB7CiAgICB2YXIgZm4gPSBhbmd1bGFyWydGdW5jdGlvbiddWydjb21waWxlJ10oZXhwcmVzc2lvbik7CiAgICB2YXIgc3VtID0gMDsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYXJyYXkubGVuZ3RoOyBpKyspIHsKICAgICAgdmFyIHZhbHVlID0gMSAqIGZuKGFycmF5W2ldKTsKICAgICAgaWYgKCFpc05hTih2YWx1ZSkpewogICAgICAgIHN1bSArPSB2YWx1ZTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHN1bTsKICB9LAoKCiAgLyoqCiAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICogQG5hbWUgYW5ndWxhci5BcnJheS5yZW1vdmUKICAgKiBAZnVuY3Rpb24KICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIE1vZGlmaWVzIGBhcnJheWAgYnkgcmVtb3ZpbmcgYW4gZWxlbWVudCBmcm9tIGl0LiBUaGUgZWxlbWVudCB3aWxsIGJlIGxvb2tlZCB1cCB1c2luZyB0aGUKICAgKiB7QGxpbmsgYW5ndWxhci5BcnJheS5pbmRleE9mIGluZGV4T2Z9IGZ1bmN0aW9uIG9uIHRoZSBgYXJyYXlgIGFuZCBvbmx5IHRoZSBmaXJzdCBpbnN0YW5jZSBvZgogICAqIHRoZSBlbGVtZW50IHdpbGwgYmUgcmVtb3ZlZC4KICAgKgogICAqIE5vdGU6IHRoaXMgZnVuY3Rpb24gaXMgdXNlZCB0byBhdWdtZW50IHRoZSBgQXJyYXlgIHR5cGUgaW4gYW5ndWxhciBleHByZXNzaW9ucy4gU2VlCiAgICoge0BsaW5rIGFuZ3VsYXIuQXJyYXl9IGZvciBtb3JlIGluZm8uCiAgICoKICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBBcnJheSBmcm9tIHdoaWNoIGFuIGVsZW1lbnQgc2hvdWxkIGJlIHJlbW92ZWQuCiAgICogQHBhcmFtIHsqfSB2YWx1ZSBFbGVtZW50IHRvIGJlIHJlbW92ZWQuCiAgICogQHJldHVybnMgeyp9IFRoZSByZW1vdmVkIGVsZW1lbnQuCiAgICoKICAgKiBAZXhhbXBsZQogICAgIDxkb2M6ZXhhbXBsZT4KICAgICAgIDxkb2M6c291cmNlPgogICAgICAgICA8dWwgbmc6aW5pdD0idGFza3M9WydMZWFybiBBbmd1bGFyJywgJ1JlYWQgRG9jdW1lbnRhdGlvbicsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ0NoZWNrIG91dCBkZW1vcycsICdCdWlsZCBjb29sIGFwcGxpY2F0aW9ucyddIj4KICAgICAgICAgICA8bGkgbmc6cmVwZWF0PSJ0YXNrIGluIHRhc2tzIj4KICAgICAgICAgICAgIHt7dGFza319IFs8YSBocmVmPSIiIG5nOmNsaWNrPSJ0YXNrcy4kcmVtb3ZlKHRhc2spIj5YPC9hPl0KICAgICAgICAgICA8L2xpPgogICAgICAgICA8L3VsPgogICAgICAgICA8aHIvPgogICAgICAgICB0YXNrcyA9IHt7dGFza3N9fQogICAgICAgPC9kb2M6c291cmNlPgogICAgICAgPGRvYzpzY2VuYXJpbz4KICAgICAgICAgaXQoJ3Nob3VsZCBpbml0aWFsaXplIHRoZSB0YXNrIGxpc3Qgd2l0aCBmb3IgdGFza3MnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICBleHBlY3QocmVwZWF0ZXIoJy5kb2MtZXhhbXBsZS1saXZlIHVsIGxpJywgJ3Rhc2sgaW4gdGFza3MnKS5jb3VudCgpKS50b0JlKDQpOwogICAgICAgICAgIGV4cGVjdChyZXBlYXRlcignLmRvYy1leGFtcGxlLWxpdmUgdWwgbGknLCAndGFzayBpbiB0YXNrcycpLmNvbHVtbigndGFzaycpKS4KICAgICAgICAgICAgIHRvRXF1YWwoWydMZWFybiBBbmd1bGFyJywgJ1JlYWQgRG9jdW1lbnRhdGlvbicsICdDaGVjayBvdXQgZGVtb3MnLAogICAgICAgICAgICAgICAgICAgICAgJ0J1aWxkIGNvb2wgYXBwbGljYXRpb25zJ10pOwogICAgICAgICB9KTsKCiAgICAgICAgIGl0KCdzaG91bGQgaW5pdGlhbGl6ZSB0aGUgdGFzayBsaXN0IHdpdGggZm9yIHRhc2tzJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgdWwgbGkgYTpjb250YWlucygiWCIpOmZpcnN0JykuY2xpY2soKTsKICAgICAgICAgICBleHBlY3QocmVwZWF0ZXIoJy5kb2MtZXhhbXBsZS1saXZlIHVsIGxpJywgJ3Rhc2sgaW4gdGFza3MnKS5jb3VudCgpKS50b0JlKDMpOwoKICAgICAgICAgICBlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSB1bCBsaSBhOmNvbnRhaW5zKCJYIik6bGFzdCcpLmNsaWNrKCk7CiAgICAgICAgICAgZXhwZWN0KHJlcGVhdGVyKCcuZG9jLWV4YW1wbGUtbGl2ZSB1bCBsaScsICd0YXNrIGluIHRhc2tzJykuY291bnQoKSkudG9CZSgyKTsKCiAgICAgICAgICAgZXhwZWN0KHJlcGVhdGVyKCcuZG9jLWV4YW1wbGUtbGl2ZSB1bCBsaScsICd0YXNrIGluIHRhc2tzJykuY29sdW1uKCd0YXNrJykpLgogICAgICAgICAgICAgdG9FcXVhbChbJ1JlYWQgRG9jdW1lbnRhdGlvbicsICdDaGVjayBvdXQgZGVtb3MnXSk7CiAgICAgICAgIH0pOwogICAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgPC9kb2M6ZXhhbXBsZT4KICAgKi8KICAncmVtb3ZlJzpmdW5jdGlvbihhcnJheSwgdmFsdWUpIHsKICAgIHZhciBpbmRleCA9IGluZGV4T2YoYXJyYXksIHZhbHVlKTsKICAgIGlmIChpbmRleCA+PTApCiAgICAgIGFycmF5LnNwbGljZShpbmRleCwgMSk7CiAgICByZXR1cm4gdmFsdWU7CiAgfSwKCgogIC8qKgogICAqIEBuZ2RvYyBmdW5jdGlvbgogICAqIEBuYW1lIGFuZ3VsYXIuQXJyYXkuZmlsdGVyCiAgICogQGZ1bmN0aW9uCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBTZWxlY3RzIGEgc3Vic2V0IG9mIGl0ZW1zIGZyb20gYGFycmF5YCBhbmQgcmV0dXJucyBpdCBhcyBhIG5ldyBhcnJheS4KICAgKgogICAqIE5vdGU6IHRoaXMgZnVuY3Rpb24gaXMgdXNlZCB0byBhdWdtZW50IHRoZSBgQXJyYXlgIHR5cGUgaW4gYW5ndWxhciBleHByZXNzaW9ucy4gU2VlCiAgICoge0BsaW5rIGFuZ3VsYXIuQXJyYXl9IGZvciBtb3JlIGluZm8uCiAgICoKICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBUaGUgc291cmNlIGFycmF5LgogICAqIEBwYXJhbSB7c3RyaW5nfE9iamVjdHxmdW5jdGlvbigpfSBleHByZXNzaW9uIFRoZSBwcmVkaWNhdGUgdG8gYmUgdXNlZCBmb3Igc2VsZWN0aW5nIGl0ZW1zIGZyb20KICAgKiAgIGBhcnJheWAuCiAgICoKICAgKiAgIENhbiBiZSBvbmUgb2Y6CiAgICoKICAgKiAgIC0gYHN0cmluZ2A6IFByZWRpY2F0ZSB0aGF0IHJlc3VsdHMgaW4gYSBzdWJzdHJpbmcgbWF0Y2ggdXNpbmcgdGhlIHZhbHVlIG9mIGBleHByZXNzaW9uYAogICAqICAgICBzdHJpbmcuIEFsbCBzdHJpbmdzIG9yIG9iamVjdHMgd2l0aCBzdHJpbmcgcHJvcGVydGllcyBpbiBgYXJyYXlgIHRoYXQgY29udGFpbiB0aGlzIHN0cmluZwogICAqICAgICB3aWxsIGJlIHJldHVybmVkLiBUaGUgcHJlZGljYXRlIGNhbiBiZSBuZWdhdGVkIGJ5IHByZWZpeGluZyB0aGUgc3RyaW5nIHdpdGggYCFgLgogICAqCiAgICogICAtIGBPYmplY3RgOiBBIHBhdHRlcm4gb2JqZWN0IGNhbiBiZSB1c2VkIHRvIGZpbHRlciBzcGVjaWZpYyBwcm9wZXJ0aWVzIG9uIG9iamVjdHMgY29udGFpbmVkCiAgICogICAgIGJ5IGBhcnJheWAuIEZvciBleGFtcGxlIGB7bmFtZToiTSIsIHBob25lOiIxIn1gIHByZWRpY2F0ZSB3aWxsIHJldHVybiBhbiBhcnJheSBvZiBpdGVtcwogICAqICAgICB3aGljaCBoYXZlIHByb3BlcnR5IGBuYW1lYCBjb250YWluaW5nICJNIiBhbmQgcHJvcGVydHkgYHBob25lYCBjb250YWluaW5nICIxIi4gQSBzcGVjaWFsCiAgICogICAgIHByb3BlcnR5IG5hbWUgYCRgIGNhbiBiZSB1c2VkIChhcyBpbiBgeyQ6InRleHQifWApIHRvIGFjY2VwdCBhIG1hdGNoIGFnYWluc3QgYW55CiAgICogICAgIHByb3BlcnR5IG9mIHRoZSBvYmplY3QuIFRoYXQncyBlcXVpdmFsZW50IHRvIHRoZSBzaW1wbGUgc3Vic3RyaW5nIG1hdGNoIHdpdGggYSBgc3RyaW5nYAogICAqICAgICBhcyBkZXNjcmliZWQgYWJvdmUuCiAgICoKICAgKiAgIC0gYGZ1bmN0aW9uYDogQSBwcmVkaWNhdGUgZnVuY3Rpb24gY2FuIGJlIHVzZWQgdG8gd3JpdGUgYXJiaXRyYXJ5IGZpbHRlcnMuIFRoZSBmdW5jdGlvbiBpcwogICAqICAgICBjYWxsZWQgZm9yIGVhY2ggZWxlbWVudCBvZiBgYXJyYXlgLiBUaGUgZmluYWwgcmVzdWx0IGlzIGFuIGFycmF5IG9mIHRob3NlIGVsZW1lbnRzIHRoYXQKICAgKiAgICAgdGhlIHByZWRpY2F0ZSByZXR1cm5lZCB0cnVlIGZvci4KICAgKgogICAqIEBleGFtcGxlCiAgICAgPGRvYzpleGFtcGxlPgogICAgICAgPGRvYzpzb3VyY2U+CiAgICAgICAgIDxkaXYgbmc6aW5pdD0iZnJpZW5kcyA9IFt7bmFtZTonSm9obicsIHBob25lOic1NTUtMTI3Nid9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAge25hbWU6J01hcnknLCBwaG9uZTonODAwLUJJRy1NQVJZJ30sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB7bmFtZTonTWlrZScsIHBob25lOic1NTUtNDMyMSd9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAge25hbWU6J0FkYW0nLCBwaG9uZTonNTU1LTU2NzgnfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHtuYW1lOidKdWxpZScsIHBob25lOic1NTUtODc2NSd9XSI+PC9kaXY+CgogICAgICAgICBTZWFyY2g6IDxpbnB1dCBuYW1lPSJzZWFyY2hUZXh0Ii8+CiAgICAgICAgIDx0YWJsZSBpZD0ic2VhcmNoVGV4dFJlc3VsdHMiPgogICAgICAgICAgIDx0cj48dGg+TmFtZTwvdGg+PHRoPlBob25lPC90aD48dHI+CiAgICAgICAgICAgPHRyIG5nOnJlcGVhdD0iZnJpZW5kIGluIGZyaWVuZHMuJGZpbHRlcihzZWFyY2hUZXh0KSI+CiAgICAgICAgICAgICA8dGQ+e3tmcmllbmQubmFtZX19PC90ZD4KICAgICAgICAgICAgIDx0ZD57e2ZyaWVuZC5waG9uZX19PC90ZD4KICAgICAgICAgICA8dHI+CiAgICAgICAgIDwvdGFibGU+CiAgICAgICAgIDxocj4KICAgICAgICAgQW55OiA8aW5wdXQgbmFtZT0ic2VhcmNoLiQiLz4gPGJyPgogICAgICAgICBOYW1lIG9ubHkgPGlucHV0IG5hbWU9InNlYXJjaC5uYW1lIi8+PGJyPgogICAgICAgICBQaG9uZSBvbmx5IDxpbnB1dCBuYW1lPSJzZWFyY2gucGhvbmUiLz48YnI+CiAgICAgICAgIDx0YWJsZSBpZD0ic2VhcmNoT2JqUmVzdWx0cyI+CiAgICAgICAgICAgPHRyPjx0aD5OYW1lPC90aD48dGg+UGhvbmU8L3RoPjx0cj4KICAgICAgICAgICA8dHIgbmc6cmVwZWF0PSJmcmllbmQgaW4gZnJpZW5kcy4kZmlsdGVyKHNlYXJjaCkiPgogICAgICAgICAgICAgPHRkPnt7ZnJpZW5kLm5hbWV9fTwvdGQ+CiAgICAgICAgICAgICA8dGQ+e3tmcmllbmQucGhvbmV9fTwvdGQ+CiAgICAgICAgICAgPHRyPgogICAgICAgICA8L3RhYmxlPgogICAgICAgPC9kb2M6c291cmNlPgogICAgICAgPGRvYzpzY2VuYXJpbz4KICAgICAgICAgaXQoJ3Nob3VsZCBzZWFyY2ggYWNyb3NzIGFsbCBmaWVsZHMgd2hlbiBmaWx0ZXJpbmcgd2l0aCBhIHN0cmluZycsIGZ1bmN0aW9uKCkgewogICAgICAgICAgIGlucHV0KCdzZWFyY2hUZXh0JykuZW50ZXIoJ20nKTsKICAgICAgICAgICBleHBlY3QocmVwZWF0ZXIoJyNzZWFyY2hUZXh0UmVzdWx0cyB0cicsICdmcmllbmQgaW4gZnJpZW5kcycpLmNvbHVtbignbmFtZScpKS4KICAgICAgICAgICAgIHRvRXF1YWwoWydNYXJ5JywgJ01pa2UnLCAnQWRhbSddKTsKCiAgICAgICAgICAgaW5wdXQoJ3NlYXJjaFRleHQnKS5lbnRlcignNzYnKTsKICAgICAgICAgICBleHBlY3QocmVwZWF0ZXIoJyNzZWFyY2hUZXh0UmVzdWx0cyB0cicsICdmcmllbmQgaW4gZnJpZW5kcycpLmNvbHVtbignbmFtZScpKS4KICAgICAgICAgICAgIHRvRXF1YWwoWydKb2huJywgJ0p1bGllJ10pOwogICAgICAgICB9KTsKCiAgICAgICAgIGl0KCdzaG91bGQgc2VhcmNoIGluIHNwZWNpZmljIGZpZWxkcyB3aGVuIGZpbHRlcmluZyB3aXRoIGEgcHJlZGljYXRlIG9iamVjdCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgIGlucHV0KCdzZWFyY2guJCcpLmVudGVyKCdpJyk7CiAgICAgICAgICAgZXhwZWN0KHJlcGVhdGVyKCcjc2VhcmNoT2JqUmVzdWx0cyB0cicsICdmcmllbmQgaW4gZnJpZW5kcycpLmNvbHVtbignbmFtZScpKS4KICAgICAgICAgICAgIHRvRXF1YWwoWydNYXJ5JywgJ01pa2UnLCAnSnVsaWUnXSk7CiAgICAgICAgIH0pOwogICAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgPC9kb2M6ZXhhbXBsZT4KICAgKi8KICAnZmlsdGVyJzpmdW5jdGlvbihhcnJheSwgZXhwcmVzc2lvbikgewogICAgdmFyIHByZWRpY2F0ZXMgPSBbXTsKICAgIHByZWRpY2F0ZXMuY2hlY2sgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICBmb3IgKHZhciBqID0gMDsgaiA8IHByZWRpY2F0ZXMubGVuZ3RoOyBqKyspIHsKICAgICAgICBpZighcHJlZGljYXRlc1tqXSh2YWx1ZSkpIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHRydWU7CiAgICB9OwogICAgdmFyIHNlYXJjaCA9IGZ1bmN0aW9uKG9iaiwgdGV4dCl7CiAgICAgIGlmICh0ZXh0LmNoYXJBdCgwKSA9PT0gJyEnKSB7CiAgICAgICAgcmV0dXJuICFzZWFyY2gob2JqLCB0ZXh0LnN1YnN0cigxKSk7CiAgICAgIH0KICAgICAgc3dpdGNoICh0eXBlb2Ygb2JqKSB7CiAgICAgIGNhc2UgImJvb2xlYW4iOgogICAgICBjYXNlICJudW1iZXIiOgogICAgICBjYXNlICJzdHJpbmciOgogICAgICAgIHJldHVybiAoJycgKyBvYmopLnRvTG93ZXJDYXNlKCkuaW5kZXhPZih0ZXh0KSA+IC0xOwogICAgICBjYXNlICJvYmplY3QiOgogICAgICAgIGZvciAoIHZhciBvYmpLZXkgaW4gb2JqKSB7CiAgICAgICAgICBpZiAob2JqS2V5LmNoYXJBdCgwKSAhPT0gJyQnICYmIHNlYXJjaChvYmpbb2JqS2V5XSwgdGV4dCkpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgY2FzZSAiYXJyYXkiOgogICAgICAgIGZvciAoIHZhciBpID0gMDsgaSA8IG9iai5sZW5ndGg7IGkrKykgewogICAgICAgICAgaWYgKHNlYXJjaChvYmpbaV0sIHRleHQpKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIGRlZmF1bHQ6CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICB9OwogICAgc3dpdGNoICh0eXBlb2YgZXhwcmVzc2lvbikgewogICAgICBjYXNlICJib29sZWFuIjoKICAgICAgY2FzZSAibnVtYmVyIjoKICAgICAgY2FzZSAic3RyaW5nIjoKICAgICAgICBleHByZXNzaW9uID0geyQ6ZXhwcmVzc2lvbn07CiAgICAgIGNhc2UgIm9iamVjdCI6CiAgICAgICAgZm9yICh2YXIga2V5IGluIGV4cHJlc3Npb24pIHsKICAgICAgICAgIGlmIChrZXkgPT0gJyQnKSB7CiAgICAgICAgICAgIChmdW5jdGlvbigpewogICAgICAgICAgICAgIHZhciB0ZXh0ID0gKCcnK2V4cHJlc3Npb25ba2V5XSkudG9Mb3dlckNhc2UoKTsKICAgICAgICAgICAgICBpZiAoIXRleHQpIHJldHVybjsKICAgICAgICAgICAgICBwcmVkaWNhdGVzLnB1c2goZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICAgIHJldHVybiBzZWFyY2godmFsdWUsIHRleHQpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KSgpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgKGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICAgdmFyIHBhdGggPSBrZXk7CiAgICAgICAgICAgICAgdmFyIHRleHQgPSAoJycrZXhwcmVzc2lvbltrZXldKS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICAgIGlmICghdGV4dCkgcmV0dXJuOwogICAgICAgICAgICAgIHByZWRpY2F0ZXMucHVzaChmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHNlYXJjaChnZXR0ZXIodmFsdWUsIHBhdGgpLCB0ZXh0KTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSkoKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgJGZ1bmN0aW9uOgogICAgICAgIHByZWRpY2F0ZXMucHVzaChleHByZXNzaW9uKTsKICAgICAgICBicmVhazsKICAgICAgZGVmYXVsdDoKICAgICAgICByZXR1cm4gYXJyYXk7CiAgICB9CiAgICB2YXIgZmlsdGVyZWQgPSBbXTsKICAgIGZvciAoIHZhciBqID0gMDsgaiA8IGFycmF5Lmxlbmd0aDsgaisrKSB7CiAgICAgIHZhciB2YWx1ZSA9IGFycmF5W2pdOwogICAgICBpZiAocHJlZGljYXRlcy5jaGVjayh2YWx1ZSkpIHsKICAgICAgICBmaWx0ZXJlZC5wdXNoKHZhbHVlKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIGZpbHRlcmVkOwogIH0sCgoKICAvKioKICAgKiBAd29ya0luUHJvZ3Jlc3MKICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgKiBAbmFtZSBhbmd1bGFyLkFycmF5LmFkZAogICAqIEBmdW5jdGlvbgogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogYGFkZGAgaXMgYSBmdW5jdGlvbiBzaW1pbGFyIHRvIEphdmFTY3JpcHQncyBgQXJyYXkjcHVzaGAgbWV0aG9kLCBpbiB0aGF0IGl0IGFwcGVuZHMgYSBuZXcKICAgKiBlbGVtZW50IHRvIGFuIGFycmF5LiBUaGUgZGlmZmVyZW5jZSBpcyB0aGF0IHRoZSB2YWx1ZSBiZWluZyBhZGRlZCBpcyBvcHRpb25hbCBhbmQgZGVmYXVsdHMgdG8KICAgKiBhbiBlbXB0eSBvYmplY3QuCiAgICoKICAgKiBOb3RlOiB0aGlzIGZ1bmN0aW9uIGlzIHVzZWQgdG8gYXVnbWVudCB0aGUgYEFycmF5YCB0eXBlIGluIGFuZ3VsYXIgZXhwcmVzc2lvbnMuIFNlZQogICAqIHtAbGluayBhbmd1bGFyLkFycmF5fSBmb3IgbW9yZSBpbmZvLgogICAqCiAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IGV4cGFuZC4KICAgKiBAcGFyYW0geyo9fSBbdmFsdWU9e31dIFRoZSB2YWx1ZSB0byBiZSBhZGRlZC4KICAgKiBAcmV0dXJucyB7QXJyYXl9IFRoZSBleHBhbmRlZCBhcnJheS4KICAgKgogICAqIEBUT0RPIHNpbXBsaWZ5IHRoZSBleGFtcGxlLgogICAqCiAgICogQGV4YW1wbGUKICAgKiBUaGlzIGV4YW1wbGUgc2hvd3MgaG93IGFuIGluaXRpYWxseSBlbXB0eSBhcnJheSBjYW4gYmUgZmlsbGVkIHdpdGggb2JqZWN0cyBjcmVhdGVkIGZyb20gdXNlcgogICAqIGlucHV0IHZpYSB0aGUgYCRhZGRgIG1ldGhvZC4KICAgICA8ZG9jOmV4YW1wbGU+CiAgICAgICA8ZG9jOnNvdXJjZT4KICAgICAgICAgWzxhIGhyZWY9IiIgbmc6Y2xpY2s9InBlb3BsZS4kYWRkKCkiPmFkZCBlbXB0eTwvYT5dCiAgICAgICAgIFs8YSBocmVmPSIiIG5nOmNsaWNrPSJwZW9wbGUuJGFkZCh7bmFtZTonSm9obicsIHNleDonbWFsZSd9KSI+YWRkICdKb2huJzwvYT5dCiAgICAgICAgIFs8YSBocmVmPSIiIG5nOmNsaWNrPSJwZW9wbGUuJGFkZCh7bmFtZTonTWFyeScsIHNleDonZmVtYWxlJ30pIj5hZGQgJ01hcnknPC9hPl0KCiAgICAgICAgIDx1bCBuZzppbml0PSJwZW9wbGU9W10iPgogICAgICAgICAgIDxsaSBuZzpyZXBlYXQ9InBlcnNvbiBpbiBwZW9wbGUiPgogICAgICAgICAgICAgPGlucHV0IG5hbWU9InBlcnNvbi5uYW1lIj4KICAgICAgICAgICAgIDxzZWxlY3QgbmFtZT0icGVyc29uLnNleCI+CiAgICAgICAgICAgICAgIDxvcHRpb24gdmFsdWU9IiI+LS1jaG9zZSBvbmUtLTwvb3B0aW9uPgogICAgICAgICAgICAgICA8b3B0aW9uPm1hbGU8L29wdGlvbj4KICAgICAgICAgICAgICAgPG9wdGlvbj5mZW1hbGU8L29wdGlvbj4KICAgICAgICAgICAgIDwvc2VsZWN0PgogICAgICAgICAgICAgWzxhIGhyZWY9IiIgbmc6Y2xpY2s9InBlb3BsZS4kcmVtb3ZlKHBlcnNvbikiPlg8L2E+XQogICAgICAgICAgIDwvbGk+CiAgICAgICAgIDwvdWw+CiAgICAgICAgIDxwcmU+cGVvcGxlID0ge3twZW9wbGV9fTwvcHJlPgogICAgICAgPC9kb2M6c291cmNlPgogICAgICAgPGRvYzpzY2VuYXJpbz4KICAgICAgICAgYmVmb3JlRWFjaChmdW5jdGlvbigpIHsKICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3Blb3BsZScpKS50b0JlKCdwZW9wbGUgPSBbXScpOwogICAgICAgICB9KTsKCiAgICAgICAgIGl0KCdzaG91bGQgY3JlYXRlIGFuIGVtcHR5IHJlY29yZCB3aGVuICJhZGQgZW1wdHkiIGlzIGNsaWNrZWQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICBlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBhOmNvbnRhaW5zKCJhZGQgZW1wdHkiKScpLmNsaWNrKCk7CiAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3Blb3BsZScpKS50b0JlKCdwZW9wbGUgPSBbe1xuICAibmFtZSI6IiIsXG4gICJzZXgiOm51bGx9XScpOwogICAgICAgICB9KTsKCiAgICAgICAgIGl0KCdzaG91bGQgY3JlYXRlIGEgIkpvaG4iIHJlY29yZCB3aGVuICJhZGQgXCdKb2huXCciIGlzIGNsaWNrZWQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICBlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBhOmNvbnRhaW5zKCJhZGQgXCdKb2huXCciKScpLmNsaWNrKCk7CiAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3Blb3BsZScpKS50b0JlKCdwZW9wbGUgPSBbe1xuICAibmFtZSI6IkpvaG4iLFxuICAic2V4IjoibWFsZSJ9XScpOwogICAgICAgICB9KTsKCiAgICAgICAgIGl0KCdzaG91bGQgY3JlYXRlIGEgIk1hcnkiIHJlY29yZCB3aGVuICJhZGQgXCdNYXJ5XCciIGlzIGNsaWNrZWQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICBlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBhOmNvbnRhaW5zKCJhZGQgXCdNYXJ5XCciKScpLmNsaWNrKCk7CiAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3Blb3BsZScpKS50b0JlKCdwZW9wbGUgPSBbe1xuICAibmFtZSI6Ik1hcnkiLFxuICAic2V4IjoiZmVtYWxlIn1dJyk7CiAgICAgICAgIH0pOwoKICAgICAgICAgaXQoJ3Nob3VsZCBkZWxldGUgYSByZWNvcmQgd2hlbiAiWCIgaXMgY2xpY2tlZCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBhOmNvbnRhaW5zKCJhZGQgZW1wdHkiKScpLmNsaWNrKCk7CiAgICAgICAgICAgIGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIGxpIGE6Y29udGFpbnMoIlgiKTpmaXJzdCcpLmNsaWNrKCk7CiAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdwZW9wbGUnKSkudG9CZSgncGVvcGxlID0gW10nKTsKICAgICAgICAgfSk7CiAgICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICA8L2RvYzpleGFtcGxlPgogICAqLwogICdhZGQnOmZ1bmN0aW9uKGFycmF5LCB2YWx1ZSkgewogICAgYXJyYXkucHVzaChpc1VuZGVmaW5lZCh2YWx1ZSk/IHt9IDogdmFsdWUpOwogICAgcmV0dXJuIGFycmF5OwogIH0sCgoKICAvKioKICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgKiBAbmFtZSBhbmd1bGFyLkFycmF5LmNvdW50CiAgICogQGZ1bmN0aW9uCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBEZXRlcm1pbmVzIHRoZSBudW1iZXIgb2YgZWxlbWVudHMgaW4gYW4gYXJyYXkuIE9wdGlvbmFsbHkgaXQgd2lsbCBjb3VudCBvbmx5IHRob3NlIGVsZW1lbnRzCiAgICogZm9yIHdoaWNoIHRoZSBgY29uZGl0aW9uYCBldmFsdWF0ZXMgdG8gYHRydWVgLgogICAqCiAgICogTm90ZTogdGhpcyBmdW5jdGlvbiBpcyB1c2VkIHRvIGF1Z21lbnQgdGhlIGBBcnJheWAgdHlwZSBpbiBhbmd1bGFyIGV4cHJlc3Npb25zLiBTZWUKICAgKiB7QGxpbmsgYW5ndWxhci5BcnJheX0gZm9yIG1vcmUgaW5mby4KICAgKgogICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IFRoZSBhcnJheSB0byBjb3VudCBlbGVtZW50cyBpbi4KICAgKiBAcGFyYW0geyhmdW5jdGlvbigpfHN0cmluZyk9fSBjb25kaXRpb24gQSBmdW5jdGlvbiB0byBiZSBldmFsdWF0ZWQgb3IgYW5ndWxhciBleHByZXNzaW9uIHRvIGJlCiAgICogICAgIGNvbXBpbGVkIGFuZCBldmFsdWF0ZWQuIFRoZSBlbGVtZW50IHRoYXQgaXMgY3VycmVudGx5IGJlaW5nIGl0ZXJhdGVkIG92ZXIsIGlzIGV4cG9zZWQgdG8KICAgKiAgICAgdGhlIGBjb25kaXRpb25gIGFzIGB0aGlzYC4KICAgKiBAcmV0dXJucyB7bnVtYmVyfSBOdW1iZXIgb2YgZWxlbWVudHMgaW4gdGhlIGFycmF5IChmb3Igd2hpY2ggdGhlIGNvbmRpdGlvbiBldmFsdWF0ZXMgdG8gdHJ1ZSkuCiAgICoKICAgKiBAZXhhbXBsZQogICAgIDxkb2M6ZXhhbXBsZT4KICAgICAgIDxkb2M6c291cmNlPgogICAgICAgICA8cHJlIG5nOmluaXQ9Iml0ZW1zID0gW3tuYW1lOidrbmlmZScsIHBvaW50czoxfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB7bmFtZTonZm9yaycsIHBvaW50czozfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB7bmFtZTonc3Bvb24nLCBwb2ludHM6MX1dIj48L3ByZT4KICAgICAgICAgPHVsPgogICAgICAgICAgIDxsaSBuZzpyZXBlYXQ9Iml0ZW0gaW4gaXRlbXMiPgogICAgICAgICAgICAgIHt7aXRlbS5uYW1lfX06IHBvaW50cz0KICAgICAgICAgICAgICA8aW5wdXQgdHlwZT0idGV4dCIgbmFtZT0iaXRlbS5wb2ludHMiLz4gPCEtLSBpZD0iaXRlbXt7JGluZGV4fX0gLS0+CiAgICAgICAgICAgPC9saT4KICAgICAgICAgPC91bD4KICAgICAgICAgPHA+TnVtYmVyIG9mIGl0ZW1zIHdoaWNoIGhhdmUgb25lIHBvaW50OiA8ZW0+e3sgaXRlbXMuJGNvdW50KCdwb2ludHM9PTEnKSB9fTwvZW0+PC9wPgogICAgICAgICA8cD5OdW1iZXIgb2YgaXRlbXMgd2hpY2ggaGF2ZSBtb3JlIHRoYW4gb25lIHBvaW50OiA8ZW0+e3tpdGVtcy4kY291bnQoJ3BvaW50cyZndDsxJyl9fTwvZW0+PC9wPgogICAgICAgPC9kb2M6c291cmNlPgogICAgICAgPGRvYzpzY2VuYXJpbz4KICAgICAgICAgaXQoJ3Nob3VsZCBjYWxjdWxhdGUgY291bnRzJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ2l0ZW1zLiRjb3VudChcJ3BvaW50cz09MVwnKScpKS50b0VxdWFsKDIpOwogICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdpdGVtcy4kY291bnQoXCdwb2ludHM+MVwnKScpKS50b0VxdWFsKDEpOwogICAgICAgICB9KTsKCiAgICAgICAgIGl0KCdzaG91bGQgcmVjYWxjdWxhdGUgd2hlbiB1cGRhdGVkJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgdXNpbmcoJy5kb2MtZXhhbXBsZS1saXZlIGxpOmZpcnN0LWNoaWxkJykuaW5wdXQoJ2l0ZW0ucG9pbnRzJykuZW50ZXIoJzIzJyk7CiAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ2l0ZW1zLiRjb3VudChcJ3BvaW50cz09MVwnKScpKS50b0VxdWFsKDEpOwogICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdpdGVtcy4kY291bnQoXCdwb2ludHM+MVwnKScpKS50b0VxdWFsKDIpOwogICAgICAgICB9KTsKICAgICAgIDwvZG9jOnNjZW5hcmlvPgogICAgIDwvZG9jOmV4YW1wbGU+CiAgICovCiAgJ2NvdW50JzpmdW5jdGlvbihhcnJheSwgY29uZGl0aW9uKSB7CiAgICBpZiAoIWNvbmRpdGlvbikgcmV0dXJuIGFycmF5Lmxlbmd0aDsKICAgIHZhciBmbiA9IGFuZ3VsYXJbJ0Z1bmN0aW9uJ11bJ2NvbXBpbGUnXShjb25kaXRpb24pLCBjb3VudCA9IDA7CiAgICBmb3JFYWNoKGFycmF5LCBmdW5jdGlvbih2YWx1ZSl7CiAgICAgIGlmIChmbih2YWx1ZSkpIHsKICAgICAgICBjb3VudCArKzsKICAgICAgfQogICAgfSk7CiAgICByZXR1cm4gY291bnQ7CiAgfSwKCgogIC8qKgogICAqIEBuZ2RvYyBmdW5jdGlvbgogICAqIEBuYW1lIGFuZ3VsYXIuQXJyYXkub3JkZXJCeQogICAqIEBmdW5jdGlvbgogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogT3JkZXJzIGBhcnJheWAgYnkgdGhlIGBleHByZXNzaW9uYCBwcmVkaWNhdGUuCiAgICoKICAgKiBOb3RlOiB0aGlzIGZ1bmN0aW9uIGlzIHVzZWQgdG8gYXVnbWVudCB0aGUgYEFycmF5YCB0eXBlIGluIGFuZ3VsYXIgZXhwcmVzc2lvbnMuIFNlZQogICAqIHtAbGluayBhbmd1bGFyLkFycmF5fSBmb3IgbW9yZSBpbmZvLgogICAqCiAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IHRvIHNvcnQuCiAgICogQHBhcmFtIHtmdW5jdGlvbigqKXxzdHJpbmd8QXJyYXkuPChmdW5jdGlvbigqKXxzdHJpbmcpPn0gZXhwcmVzc2lvbiBBIHByZWRpY2F0ZSB0byBiZQogICAqICAgIHVzZWQgYnkgdGhlIGNvbXBhcmF0b3IgdG8gZGV0ZXJtaW5lIHRoZSBvcmRlciBvZiBlbGVtZW50cy4KICAgKgogICAqICAgIENhbiBiZSBvbmUgb2Y6CiAgICoKICAgKiAgICAtIGBmdW5jdGlvbmA6IGdldHRlciBmdW5jdGlvbi4gVGhlIHJlc3VsdCBvZiB0aGlzIGZ1bmN0aW9uIHdpbGwgYmUgc29ydGVkIHVzaW5nIHRoZQogICAqICAgICAgYDxgLCBgPWAsIGA+YCBvcGVyYXRvcgogICAqICAgIC0gYHN0cmluZ2A6IGFuZ3VsYXIgZXhwcmVzc2lvbiB3aGljaCBldmFsdWF0ZXMgdG8gYW4gb2JqZWN0IHRvIG9yZGVyIGJ5LCBzdWNoIGFzICduYW1lJyB0bwogICAqICAgICAgc29ydCBieSBhIHByb3BlcnR5IGNhbGxlZCAnbmFtZScuIE9wdGlvbmFsbHkgcHJlZml4ZWQgd2l0aCBgK2Agb3IgYC1gIHRvIGNvbnRyb2wgYXNjZW5kaW5nCiAgICogICAgICBvciBkZXNjZW5kaW5nIHNvcnQgb3JkZXIgKGUuZy4gK25hbWUgb3IgLW5hbWUpLgogICAqICAgIC0gYEFycmF5YDogYXJyYXkgb2YgZnVuY3Rpb24gb3Igc3RyaW5nIHByZWRpY2F0ZXMsIHN1Y2ggdGhhdCBhIGZpcnN0IHByZWRpY2F0ZSBpbiB0aGUgYXJyYXkKICAgKiAgICAgIGlzIHVzZWQgZm9yIHNvcnRpbmcsIGJ1dCB3aGVuIHRoZSBpdGVtcyBhcmUgZXF1aXZhbGVudCBuZXh0IHByZWRpY2F0ZSBpcyB1c2VkLgogICAqCiAgICogQHBhcmFtIHtib29sZWFuPX0gcmV2ZXJzZSBSZXZlcnNlIHRoZSBvcmRlciB0aGUgYXJyYXkuCiAgICogQHJldHVybnMge0FycmF5fSBTb3J0ZWQgY29weSBvZiB0aGUgc291cmNlIGFycmF5LgogICAqCiAgICogQGV4YW1wbGUKICAgICA8ZG9jOmV4YW1wbGU+CiAgICAgICA8ZG9jOnNvdXJjZT4KICAgICAgICAgPGRpdiBuZzppbml0PSJmcmllbmRzID0gW3tuYW1lOidKb2huJywgcGhvbmU6JzU1NS0xMjEyJywgYWdlOjEwfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHtuYW1lOidNYXJ5JywgcGhvbmU6JzU1NS05ODc2JywgYWdlOjE5fSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHtuYW1lOidNaWtlJywgcGhvbmU6JzU1NS00MzIxJywgYWdlOjIxfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHtuYW1lOidBZGFtJywgcGhvbmU6JzU1NS01Njc4JywgYWdlOjM1fSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHtuYW1lOidKdWxpZScsIHBob25lOic1NTUtODc2NScsIGFnZToyOX1dIj48L2Rpdj4KCiAgICAgICAgIDxwcmU+U29ydGluZyBwcmVkaWNhdGUgPSB7e3ByZWRpY2F0ZX19OyByZXZlcnNlID0ge3tyZXZlcnNlfX08L3ByZT4KICAgICAgICAgPGhyLz4KICAgICAgICAgWyA8YSBocmVmPSIiIG5nOmNsaWNrPSJwcmVkaWNhdGU9JyciPnVuc29ydGVkPC9hPiBdCiAgICAgICAgIDx0YWJsZSBuZzppbml0PSJwcmVkaWNhdGU9Jy1hZ2UnIj4KICAgICAgICAgICA8dHI+CiAgICAgICAgICAgICA8dGg+PGEgaHJlZj0iIiBuZzpjbGljaz0icHJlZGljYXRlID0gJ25hbWUnOyByZXZlcnNlPWZhbHNlIj5OYW1lPC9hPgogICAgICAgICAgICAgICAgICg8YSBocmVmIG5nOmNsaWNrPSJwcmVkaWNhdGUgPSAnLW5hbWUnOyByZXZlcnNlPWZhbHNlIj5ePC9hPik8L3RoPgogICAgICAgICAgICAgPHRoPjxhIGhyZWY9IiIgbmc6Y2xpY2s9InByZWRpY2F0ZSA9ICdwaG9uZSc7IHJldmVyc2U9IXJldmVyc2UiPlBob25lIE51bWJlcjwvYT48L3RoPgogICAgICAgICAgICAgPHRoPjxhIGhyZWY9IiIgbmc6Y2xpY2s9InByZWRpY2F0ZSA9ICdhZ2UnOyByZXZlcnNlPSFyZXZlcnNlIj5BZ2U8L2E+PC90aD4KICAgICAgICAgICA8dHI+CiAgICAgICAgICAgPHRyIG5nOnJlcGVhdD0iZnJpZW5kIGluIGZyaWVuZHMuJG9yZGVyQnkocHJlZGljYXRlLCByZXZlcnNlKSI+CiAgICAgICAgICAgICA8dGQ+e3tmcmllbmQubmFtZX19PC90ZD4KICAgICAgICAgICAgIDx0ZD57e2ZyaWVuZC5waG9uZX19PC90ZD4KICAgICAgICAgICAgIDx0ZD57e2ZyaWVuZC5hZ2V9fTwvdGQ+CiAgICAgICAgICAgPHRyPgogICAgICAgICA8L3RhYmxlPgogICAgICAgPC9kb2M6c291cmNlPgogICAgICAgPGRvYzpzY2VuYXJpbz4KICAgICAgICAgaXQoJ3Nob3VsZCBiZSByZXZlcnNlIG9yZGVyZWQgYnkgYWdlZCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdwcmVkaWNhdGUnKSkudG9CZSgnU29ydGluZyBwcmVkaWNhdGUgPSAtYWdlOyByZXZlcnNlID0gJyk7CiAgICAgICAgICAgZXhwZWN0KHJlcGVhdGVyKCcuZG9jLWV4YW1wbGUtbGl2ZSB0YWJsZScsICdmcmllbmQgaW4gZnJpZW5kcycpLmNvbHVtbignZnJpZW5kLmFnZScpKS4KICAgICAgICAgICAgIHRvRXF1YWwoWyczNScsICcyOScsICcyMScsICcxOScsICcxMCddKTsKICAgICAgICAgICBleHBlY3QocmVwZWF0ZXIoJy5kb2MtZXhhbXBsZS1saXZlIHRhYmxlJywgJ2ZyaWVuZCBpbiBmcmllbmRzJykuY29sdW1uKCdmcmllbmQubmFtZScpKS4KICAgICAgICAgICAgIHRvRXF1YWwoWydBZGFtJywgJ0p1bGllJywgJ01pa2UnLCAnTWFyeScsICdKb2huJ10pOwogICAgICAgICB9KTsKCiAgICAgICAgIGl0KCdzaG91bGQgcmVvcmRlciB0aGUgdGFibGUgd2hlbiB1c2VyIHNlbGVjdHMgZGlmZmVyZW50IHByZWRpY2F0ZScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgIGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIGE6Y29udGFpbnMoIk5hbWUiKScpLmNsaWNrKCk7CiAgICAgICAgICAgZXhwZWN0KHJlcGVhdGVyKCcuZG9jLWV4YW1wbGUtbGl2ZSB0YWJsZScsICdmcmllbmQgaW4gZnJpZW5kcycpLmNvbHVtbignZnJpZW5kLm5hbWUnKSkuCiAgICAgICAgICAgICB0b0VxdWFsKFsnQWRhbScsICdKb2huJywgJ0p1bGllJywgJ01hcnknLCAnTWlrZSddKTsKICAgICAgICAgICBleHBlY3QocmVwZWF0ZXIoJy5kb2MtZXhhbXBsZS1saXZlIHRhYmxlJywgJ2ZyaWVuZCBpbiBmcmllbmRzJykuY29sdW1uKCdmcmllbmQuYWdlJykpLgogICAgICAgICAgICAgdG9FcXVhbChbJzM1JywgJzEwJywgJzI5JywgJzE5JywgJzIxJ10pOwoKICAgICAgICAgICBlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBhOmNvbnRhaW5zKCJQaG9uZSIpJykuY2xpY2soKTsKICAgICAgICAgICBleHBlY3QocmVwZWF0ZXIoJy5kb2MtZXhhbXBsZS1saXZlIHRhYmxlJywgJ2ZyaWVuZCBpbiBmcmllbmRzJykuY29sdW1uKCdmcmllbmQucGhvbmUnKSkuCiAgICAgICAgICAgICB0b0VxdWFsKFsnNTU1LTk4NzYnLCAnNTU1LTg3NjUnLCAnNTU1LTU2NzgnLCAnNTU1LTQzMjEnLCAnNTU1LTEyMTInXSk7CiAgICAgICAgICAgZXhwZWN0KHJlcGVhdGVyKCcuZG9jLWV4YW1wbGUtbGl2ZSB0YWJsZScsICdmcmllbmQgaW4gZnJpZW5kcycpLmNvbHVtbignZnJpZW5kLm5hbWUnKSkuCiAgICAgICAgICAgICB0b0VxdWFsKFsnTWFyeScsICdKdWxpZScsICdBZGFtJywgJ01pa2UnLCAnSm9obiddKTsKICAgICAgICAgfSk7CiAgICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICA8L2RvYzpleGFtcGxlPgogICAqLwogICdvcmRlckJ5JzpmdW5jdGlvbihhcnJheSwgc29ydFByZWRpY2F0ZSwgcmV2ZXJzZU9yZGVyKSB7CiAgICBpZiAoIXNvcnRQcmVkaWNhdGUpIHJldHVybiBhcnJheTsKICAgIHNvcnRQcmVkaWNhdGUgPSBpc0FycmF5KHNvcnRQcmVkaWNhdGUpID8gc29ydFByZWRpY2F0ZTogW3NvcnRQcmVkaWNhdGVdOwogICAgc29ydFByZWRpY2F0ZSA9IG1hcChzb3J0UHJlZGljYXRlLCBmdW5jdGlvbihwcmVkaWNhdGUpewogICAgICB2YXIgZGVzY2VuZGluZyA9IGZhbHNlLCBnZXQgPSBwcmVkaWNhdGUgfHwgaWRlbnRpdHk7CiAgICAgIGlmIChpc1N0cmluZyhwcmVkaWNhdGUpKSB7CiAgICAgICAgaWYgKChwcmVkaWNhdGUuY2hhckF0KDApID09ICcrJyB8fCBwcmVkaWNhdGUuY2hhckF0KDApID09ICctJykpIHsKICAgICAgICAgIGRlc2NlbmRpbmcgPSBwcmVkaWNhdGUuY2hhckF0KDApID09ICctJzsKICAgICAgICAgIHByZWRpY2F0ZSA9IHByZWRpY2F0ZS5zdWJzdHJpbmcoMSk7CiAgICAgICAgfQogICAgICAgIGdldCA9IGV4cHJlc3Npb25Db21waWxlKHByZWRpY2F0ZSkuZm5TZWxmOwogICAgICB9CiAgICAgIHJldHVybiByZXZlcnNlQ29tcGFyYXRvcihmdW5jdGlvbihhLGIpewogICAgICAgIHJldHVybiBjb21wYXJlKGdldChhKSxnZXQoYikpOwogICAgICB9LCBkZXNjZW5kaW5nKTsKICAgIH0pOwogICAgdmFyIGFycmF5Q29weSA9IFtdOwogICAgZm9yICggdmFyIGkgPSAwOyBpIDwgYXJyYXkubGVuZ3RoOyBpKyspIHsgYXJyYXlDb3B5LnB1c2goYXJyYXlbaV0pOyB9CiAgICByZXR1cm4gYXJyYXlDb3B5LnNvcnQocmV2ZXJzZUNvbXBhcmF0b3IoY29tcGFyYXRvciwgcmV2ZXJzZU9yZGVyKSk7CgogICAgZnVuY3Rpb24gY29tcGFyYXRvcihvMSwgbzIpewogICAgICBmb3IgKCB2YXIgaSA9IDA7IGkgPCBzb3J0UHJlZGljYXRlLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgdmFyIGNvbXAgPSBzb3J0UHJlZGljYXRlW2ldKG8xLCBvMik7CiAgICAgICAgaWYgKGNvbXAgIT09IDApIHJldHVybiBjb21wOwogICAgICB9CiAgICAgIHJldHVybiAwOwogICAgfQogICAgZnVuY3Rpb24gcmV2ZXJzZUNvbXBhcmF0b3IoY29tcCwgZGVzY2VuZGluZykgewogICAgICByZXR1cm4gdG9Cb29sZWFuKGRlc2NlbmRpbmcpCiAgICAgICAgICA/IGZ1bmN0aW9uKGEsYil7cmV0dXJuIGNvbXAoYixhKTt9CiAgICAgICAgICA6IGNvbXA7CiAgICB9CiAgICBmdW5jdGlvbiBjb21wYXJlKHYxLCB2Mil7CiAgICAgIHZhciB0MSA9IHR5cGVvZiB2MTsKICAgICAgdmFyIHQyID0gdHlwZW9mIHYyOwogICAgICBpZiAodDEgPT0gdDIpIHsKICAgICAgICBpZiAodDEgPT0gInN0cmluZyIpIHYxID0gdjEudG9Mb3dlckNhc2UoKTsKICAgICAgICBpZiAodDEgPT0gInN0cmluZyIpIHYyID0gdjIudG9Mb3dlckNhc2UoKTsKICAgICAgICBpZiAodjEgPT09IHYyKSByZXR1cm4gMDsKICAgICAgICByZXR1cm4gdjEgPCB2MiA/IC0xIDogMTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gdDEgPCB0MiA/IC0xIDogMTsKICAgICAgfQogICAgfQogIH0sCgoKICAvKioKICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgKiBAbmFtZSBhbmd1bGFyLkFycmF5LmxpbWl0VG8KICAgKiBAZnVuY3Rpb24KICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIENyZWF0ZXMgYSBuZXcgYXJyYXkgY29udGFpbmluZyBvbmx5IHRoZSBmaXJzdCwgb3IgbGFzdCBgbGltaXRgIG51bWJlciBvZiBlbGVtZW50cyBvZiB0aGUKICAgKiBzb3VyY2UgYGFycmF5YC4KICAgKgogICAqIE5vdGU6IHRoaXMgZnVuY3Rpb24gaXMgdXNlZCB0byBhdWdtZW50IHRoZSBgQXJyYXlgIHR5cGUgaW4gYW5ndWxhciBleHByZXNzaW9ucy4gU2VlCiAgICoge0BsaW5rIGFuZ3VsYXIuQXJyYXl9IGZvciBtb3JlIGluZm8uCiAgICoKICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBTb3VyY2UgYXJyYXkgdG8gYmUgbGltaXRlZC4KICAgKiBAcGFyYW0ge3N0cmluZ3xOdW1iZXJ9IGxpbWl0IFRoZSBsZW5ndGggb2YgdGhlIHJldHVybmVkIGFycmF5LiBJZiB0aGUgbnVtYmVyIGlzIHBvc2l0aXZlLCB0aGUKICAgKiAgICAgZmlyc3QgYGxpbWl0YCBpdGVtcyBmcm9tIHRoZSBzb3VyY2UgYXJyYXkgd2lsbCBiZSBjb3BpZWQsIGlmIHRoZSBudW1iZXIgaXMgbmVnYXRpdmUsIHRoZQogICAqICAgICBsYXN0IGBsaW1pdGAgaXRlbXMgd2lsbCBiZSBjb3BpZWQuCiAgICogQHJldHVybnMge0FycmF5fSBBIG5ldyBzdWItYXJyYXkgb2YgbGVuZ3RoIGBsaW1pdGAuCiAgICoKICAgKiBAZXhhbXBsZQogICAgIDxkb2M6ZXhhbXBsZT4KICAgICAgIDxkb2M6c291cmNlPgogICAgICAgICA8ZGl2IG5nOmluaXQ9Im51bWJlcnMgPSBbMSwyLDMsNCw1LDYsNyw4LDldIj4KICAgICAgICAgICBMaW1pdCBbMSwyLDMsNCw1LDYsNyw4LDldIHRvOiA8aW5wdXQgbmFtZT0ibGltaXQiIHZhbHVlPSIzIi8+CiAgICAgICAgICAgPHA+T3V0cHV0OiB7eyBudW1iZXJzLiRsaW1pdFRvKGxpbWl0KSB8IGpzb24gfX08L3A+CiAgICAgICAgIDwvZGl2PgogICAgICAgPC9kb2M6c291cmNlPgogICAgICAgPGRvYzpzY2VuYXJpbz4KICAgICAgICAgaXQoJ3Nob3VsZCBsaW1pdCB0aGUgbnVtZXIgYXJyYXkgdG8gZmlyc3QgdGhyZWUgaXRlbXMnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgaW5wdXRbbmFtZT1saW1pdF0nKS52YWwoKSkudG9CZSgnMycpOwogICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdudW1iZXJzLiRsaW1pdFRvKGxpbWl0KSB8IGpzb24nKSkudG9FcXVhbCgnWzEsMiwzXScpOwogICAgICAgICB9KTsKCiAgICAgICAgIGl0KCdzaG91bGQgdXBkYXRlIHRoZSBvdXRwdXQgd2hlbiAtMyBpcyBlbnRlcmVkJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgaW5wdXQoJ2xpbWl0JykuZW50ZXIoLTMpOwogICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdudW1iZXJzLiRsaW1pdFRvKGxpbWl0KSB8IGpzb24nKSkudG9FcXVhbCgnWzcsOCw5XScpOwogICAgICAgICB9KTsKICAgICAgIDwvZG9jOnNjZW5hcmlvPgogICAgIDwvZG9jOmV4YW1wbGU+CiAgICovCiAgbGltaXRUbzogZnVuY3Rpb24oYXJyYXksIGxpbWl0KSB7CiAgICBsaW1pdCA9IHBhcnNlSW50KGxpbWl0LCAxMCk7CiAgICB2YXIgb3V0ID0gW10sCiAgICAgICAgaSwgbjsKCiAgICBpZiAobGltaXQgPiAwKSB7CiAgICAgIGkgPSAwOwogICAgICBuID0gbGltaXQ7CiAgICB9IGVsc2UgewogICAgICBpID0gYXJyYXkubGVuZ3RoICsgbGltaXQ7CiAgICAgIG4gPSBhcnJheS5sZW5ndGg7CiAgICB9CgogICAgZm9yICg7IGk8bjsgaSsrKSB7CiAgICAgIG91dC5wdXNoKGFycmF5W2ldKTsKICAgIH0KCiAgICByZXR1cm4gb3V0OwogIH0KfTsKCnZhciBSX0lTTzgwNjFfU1RSID0gL14oXGR7NH0pLShcZFxkKS0oXGRcZCkoPzpUKFxkXGQpKD86XDooXGRcZCkoPzpcOihcZFxkKSg/OlwuKFxkezN9KSk/KT8pP1opPyQvOwoKdmFyIGFuZ3VsYXJTdHJpbmcgPSB7CiAgJ3F1b3RlJzpmdW5jdGlvbihzdHJpbmcpIHsKICAgIHJldHVybiAnIicgKyBzdHJpbmcucmVwbGFjZSgvXFwvZywgJ1xcXFwnKS4KICAgICAgICAgICAgICAgICAgICAgICAgcmVwbGFjZSgvIi9nLCAnXFwiJykuCiAgICAgICAgICAgICAgICAgICAgICAgIHJlcGxhY2UoL1xuL2csICdcXG4nKS4KICAgICAgICAgICAgICAgICAgICAgICAgcmVwbGFjZSgvXGYvZywgJ1xcZicpLgogICAgICAgICAgICAgICAgICAgICAgICByZXBsYWNlKC9cci9nLCAnXFxyJykuCiAgICAgICAgICAgICAgICAgICAgICAgIHJlcGxhY2UoL1x0L2csICdcXHQnKS4KICAgICAgICAgICAgICAgICAgICAgICAgcmVwbGFjZSgvXHYvZywgJ1xcdicpICsKICAgICAgICAgICAgICciJzsKICB9LAogICdxdW90ZVVuaWNvZGUnOmZ1bmN0aW9uKHN0cmluZykgewogICAgdmFyIHN0ciA9IGFuZ3VsYXJbJ1N0cmluZyddWydxdW90ZSddKHN0cmluZyk7CiAgICB2YXIgY2hhcnMgPSBbXTsKICAgIGZvciAoIHZhciBpID0gMDsgaSA8IHN0ci5sZW5ndGg7IGkrKykgewogICAgICB2YXIgY2ggPSBzdHIuY2hhckNvZGVBdChpKTsKICAgICAgaWYgKGNoIDwgMTI4KSB7CiAgICAgICAgY2hhcnMucHVzaChzdHIuY2hhckF0KGkpKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB2YXIgZW5jb2RlID0gIjAwMCIgKyBjaC50b1N0cmluZygxNik7CiAgICAgICAgY2hhcnMucHVzaCgiXFx1IiArIGVuY29kZS5zdWJzdHJpbmcoZW5jb2RlLmxlbmd0aCAtIDQpKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIGNoYXJzLmpvaW4oJycpOwogIH0sCgogIC8qKgogICAqIFRyaWVzIHRvIGNvbnZlcnQgaW5wdXQgdG8gZGF0ZSBhbmQgaWYgc3VjY2Vzc2Z1bCByZXR1cm5zIHRoZSBkYXRlLCBvdGhlcndpc2UgcmV0dXJucyB0aGUgaW5wdXQuCiAgICogQHBhcmFtIHtzdHJpbmd9IHN0cmluZwogICAqIEByZXR1cm4geyhEYXRlfHN0cmluZyl9CiAgICovCiAgJ3RvRGF0ZSc6ZnVuY3Rpb24oc3RyaW5nKXsKICAgIHZhciBtYXRjaDsKICAgIGlmIChpc1N0cmluZyhzdHJpbmcpICYmIChtYXRjaCA9IHN0cmluZy5tYXRjaChSX0lTTzgwNjFfU1RSKSkpewogICAgICB2YXIgZGF0ZSA9IG5ldyBEYXRlKDApOwogICAgICBkYXRlLnNldFVUQ0Z1bGxZZWFyKG1hdGNoWzFdLCBtYXRjaFsyXSAtIDEsIG1hdGNoWzNdKTsKICAgICAgZGF0ZS5zZXRVVENIb3VycyhtYXRjaFs0XXx8MCwgbWF0Y2hbNV18fDAsIG1hdGNoWzZdfHwwLCBtYXRjaFs3XXx8MCk7CiAgICAgIHJldHVybiBkYXRlOwogICAgfQogICAgcmV0dXJuIHN0cmluZzsKICB9Cn07Cgp2YXIgYW5ndWxhckRhdGUgPSB7CiAgICAndG9TdHJpbmcnOmZ1bmN0aW9uKGRhdGUpewogICAgICAgaWYgKCFkYXRlKSByZXR1cm4gZGF0ZTsKCiAgICAgICB2YXIgaXNvU3RyaW5nID0gZGF0ZS50b0lTT1N0cmluZyA/IGRhdGUudG9JU09TdHJpbmcoKSA6ICcnOwoKICAgICAgIHJldHVybiAoaXNvU3RyaW5nLmxlbmd0aD09MjQpID8KICAgICAgICAgICAgICAgIGlzb1N0cmluZyA6CiAgICAgICAgICAgICAgICBwYWROdW1iZXIoZGF0ZS5nZXRVVENGdWxsWWVhcigpLCA0KSArICctJyArCiAgICAgICAgICAgICAgICAgIHBhZE51bWJlcihkYXRlLmdldFVUQ01vbnRoKCkgKyAxLCAyKSArICctJyArCiAgICAgICAgICAgICAgICAgIHBhZE51bWJlcihkYXRlLmdldFVUQ0RhdGUoKSwgMikgKyAnVCcgKwogICAgICAgICAgICAgICAgICBwYWROdW1iZXIoZGF0ZS5nZXRVVENIb3VycygpLCAyKSArICc6JyArCiAgICAgICAgICAgICAgICAgIHBhZE51bWJlcihkYXRlLmdldFVUQ01pbnV0ZXMoKSwgMikgKyAnOicgKwogICAgICAgICAgICAgICAgICBwYWROdW1iZXIoZGF0ZS5nZXRVVENTZWNvbmRzKCksIDIpICsgJy4nICsKICAgICAgICAgICAgICAgICAgcGFkTnVtYmVyKGRhdGUuZ2V0VVRDTWlsbGlzZWNvbmRzKCksIDMpICsgJ1onOwogICAgfQogIH07Cgp2YXIgYW5ndWxhckZ1bmN0aW9uID0gewogICdjb21waWxlJzpmdW5jdGlvbihleHByZXNzaW9uKSB7CiAgICBpZiAoaXNGdW5jdGlvbihleHByZXNzaW9uKSl7CiAgICAgIHJldHVybiBleHByZXNzaW9uOwogICAgfSBlbHNlIGlmIChleHByZXNzaW9uKXsKICAgICAgcmV0dXJuIGV4cHJlc3Npb25Db21waWxlKGV4cHJlc3Npb24pLmZuU2VsZjsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBpZGVudGl0eTsKICAgIH0KICB9Cn07CgovKioKICogQ29tcHV0ZXMgYSBoYXNoIG9mIGFuICdvYmonLgogKiBIYXNoIG9mIGE6CiAqICBzdHJpbmcgaXMgc3RyaW5nCiAqICBudW1iZXIgaXMgbnVtYmVyIGFzIHN0cmluZwogKiAgb2JqZWN0IGlzIGVpdGhlciBjYWxsICRoYXNoS2V5IGZ1bmN0aW9uIG9uIG9iamVjdCBvciBhc3NpZ24gdW5pcXVlIGhhc2hLZXkgaWQuCiAqCiAqIEBwYXJhbSBvYmoKICogQHJldHVybnMge1N0cmluZ30gaGFzaCBzdHJpbmcgc3VjaCB0aGF0IHRoZSBzYW1lIGlucHV0IHdpbGwgaGF2ZSB0aGUgc2FtZSBoYXNoIHN0cmluZwogKi8KZnVuY3Rpb24gaGFzaEtleShvYmopIHsKICB2YXIgb2JqVHlwZSA9IHR5cGVvZiBvYmo7CiAgdmFyIGtleSA9IG9iajsKICBpZiAob2JqVHlwZSA9PSAnb2JqZWN0JykgewogICAgaWYgKHR5cGVvZiAoa2V5ID0gb2JqLiRoYXNoS2V5KSA9PSAnZnVuY3Rpb24nKSB7CiAgICAgIC8vIG11c3QgaW52b2tlIG9uIG9iamVjdCB0byBrZWVwIHRoZSByaWdodCB0aGlzCiAgICAgIGtleSA9IG9iai4kaGFzaEtleSgpOwogICAgfSBlbHNlIGlmIChrZXkgPT09IHVuZGVmaW5lZCkgewogICAgICBrZXkgPSBvYmouJGhhc2hLZXkgPSBuZXh0VWlkKCk7CiAgICB9CiAgfTsKICByZXR1cm4gb2JqVHlwZSArICc6JyArIGtleTsKfQoKLyoqCiAqIEhhc2hNYXAgd2hpY2ggY2FuIHVzZSBvYmplY3RzIGFzIGtleXMKICovCmZ1bmN0aW9uIEhhc2hNYXAoKXt9Ckhhc2hNYXAucHJvdG90eXBlID0gewogIC8qKgogICAqIFN0b3JlIGtleSB2YWx1ZSBwYWlyCiAgICogQHBhcmFtIGtleSBrZXkgdG8gc3RvcmUgY2FuIGJlIGFueSB0eXBlCiAgICogQHBhcmFtIHZhbHVlIHZhbHVlIHRvIHN0b3JlIGNhbiBiZSBhbnkgdHlwZQogICAqIEByZXR1cm5zIG9sZCB2YWx1ZSBpZiBhbnkKICAgKi8KICBwdXQ6IGZ1bmN0aW9uKGtleSwgdmFsdWUpIHsKICAgIHZhciBfa2V5ID0gaGFzaEtleShrZXkpOwogICAgdmFyIG9sZFZhbHVlID0gdGhpc1tfa2V5XTsKICAgIHRoaXNbX2tleV0gPSB2YWx1ZTsKICAgIHJldHVybiBvbGRWYWx1ZTsKICB9LAoKICAvKioKICAgKiBAcGFyYW0ga2V5CiAgICogQHJldHVybnMgdGhlIHZhbHVlIGZvciB0aGUga2V5CiAgICovCiAgZ2V0OiBmdW5jdGlvbihrZXkpIHsKICAgIHJldHVybiB0aGlzW2hhc2hLZXkoa2V5KV07CiAgfSwKCiAgLyoqCiAgICogUmVtb3ZlIHRoZSBrZXkvdmFsdWUgcGFpcgogICAqIEBwYXJhbSBrZXkKICAgKiBAcmV0dXJucyB2YWx1ZSBhc3NvY2lhdGVkIHdpdGgga2V5IGJlZm9yZSBpdCB3YXMgcmVtb3ZlZAogICAqLwogIHJlbW92ZTogZnVuY3Rpb24oa2V5KSB7CiAgICB2YXIgX2tleSA9IGhhc2hLZXkoa2V5KTsKICAgIHZhciB2YWx1ZSA9IHRoaXNbX2tleV07CiAgICBkZWxldGUgdGhpc1tfa2V5XTsKICAgIHJldHVybiB2YWx1ZTsKICB9Cn07CgpmdW5jdGlvbiBkZWZpbmVBcGkoZHN0LCBjaGFpbil7CiAgYW5ndWxhcltkc3RdID0gYW5ndWxhcltkc3RdIHx8IHt9OwogIGZvckVhY2goY2hhaW4sIGZ1bmN0aW9uKHBhcmVudCl7CiAgICBleHRlbmQoYW5ndWxhcltkc3RdLCBwYXJlbnQpOwogIH0pOwp9CmRlZmluZUFwaSgnR2xvYmFsJywgW2FuZ3VsYXJHbG9iYWxdKTsKZGVmaW5lQXBpKCdDb2xsZWN0aW9uJywgW2FuZ3VsYXJHbG9iYWwsIGFuZ3VsYXJDb2xsZWN0aW9uXSk7CmRlZmluZUFwaSgnQXJyYXknLCBbYW5ndWxhckdsb2JhbCwgYW5ndWxhckNvbGxlY3Rpb24sIGFuZ3VsYXJBcnJheV0pOwpkZWZpbmVBcGkoJ09iamVjdCcsIFthbmd1bGFyR2xvYmFsLCBhbmd1bGFyQ29sbGVjdGlvbiwgYW5ndWxhck9iamVjdF0pOwpkZWZpbmVBcGkoJ1N0cmluZycsIFthbmd1bGFyR2xvYmFsLCBhbmd1bGFyU3RyaW5nXSk7CmRlZmluZUFwaSgnRGF0ZScsIFthbmd1bGFyR2xvYmFsLCBhbmd1bGFyRGF0ZV0pOwovL0lFIGJ1Zwphbmd1bGFyLkRhdGUudG9TdHJpbmcgPSBhbmd1bGFyRGF0ZS50b1N0cmluZzsKZGVmaW5lQXBpKCdGdW5jdGlvbicsIFthbmd1bGFyR2xvYmFsLCBhbmd1bGFyQ29sbGVjdGlvbiwgYW5ndWxhckZ1bmN0aW9uXSk7Cid1c2Ugc3RyaWN0JzsKCi8qKgogKiBAd29ya0luUHJvZ3Jlc3MKICogQG5nZG9jIG92ZXJ2aWV3CiAqIEBuYW1lIGFuZ3VsYXIuZmlsdGVyCiAqIEBkZXNjcmlwdGlvbgogKgogKiBGaWx0ZXJzIGFyZSB1c2VkIGZvciBmb3JtYXR0aW5nIGRhdGEgZGlzcGxheWVkIHRvIHRoZSB1c2VyLgogKgogKiBUaGUgZ2VuZXJhbCBzeW50YXggaW4gdGVtcGxhdGVzIGlzIGFzIGZvbGxvd3M6CiAqCiAqICAgICAgICAge3sgZXhwcmVzc2lvbiB8IFsgZmlsdGVyX25hbWUgXSB9fQogKgogKiBGb2xsb3dpbmcgaXMgdGhlIGxpc3Qgb2YgYnVpbHQtaW4gYW5ndWxhciBmaWx0ZXJzOgogKgogKiAqIHtAbGluayBhbmd1bGFyLmZpbHRlci5jdXJyZW5jeSBjdXJyZW5jeX0KICogKiB7QGxpbmsgYW5ndWxhci5maWx0ZXIuZGF0ZSBkYXRlfQogKiAqIHtAbGluayBhbmd1bGFyLmZpbHRlci5odG1sIGh0bWx9CiAqICoge0BsaW5rIGFuZ3VsYXIuZmlsdGVyLmpzb24ganNvbn0KICogKiB7QGxpbmsgYW5ndWxhci5maWx0ZXIubGlua3kgbGlua3l9CiAqICoge0BsaW5rIGFuZ3VsYXIuZmlsdGVyLmxvd2VyY2FzZSBsb3dlcmNhc2V9CiAqICoge0BsaW5rIGFuZ3VsYXIuZmlsdGVyLm51bWJlciBudW1iZXJ9CiAqICoge0BsaW5rIGFuZ3VsYXIuZmlsdGVyLnVwcGVyY2FzZSB1cHBlcmNhc2V9CiAqCiAqIEZvciBtb3JlIGluZm9ybWF0aW9uIGFib3V0IGhvdyBhbmd1bGFyIGZpbHRlcnMgd29yaywgYW5kIGhvdyB0byBjcmVhdGUgeW91ciBvd24gZmlsdGVycywgc2VlCiAqIHtAbGluayBndWlkZS9kZXZfZ3VpZGUudGVtcGxhdGVzLmZpbHRlcnMgVW5kZXJzdGFuZGluZyBBbmd1bGFyIEZpbHRlcnN9IGluIHRoZSBhbmd1bGFyIERldmVsb3BlcgogKiBHdWlkZS4KICovCgovKioKICogQHdvcmtJblByb2dyZXNzCiAqIEBuZ2RvYyBmaWx0ZXIKICogQG5hbWUgYW5ndWxhci5maWx0ZXIuY3VycmVuY3kKICogQGZ1bmN0aW9uCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBGb3JtYXRzIGEgbnVtYmVyIGFzIGEgY3VycmVuY3kgKGllICQxLDIzNC41NikuIFdoZW4gbm8gY3VycmVuY3kgc3ltYm9sIGlzIHByb3ZpZGVkLCBkZWZhdWx0CiAqIHN5bWJvbCBmb3IgY3VycmVudCBsb2NhbGUgaXMgdXNlZC4KICoKICogQHBhcmFtIHtudW1iZXJ9IGFtb3VudCBJbnB1dCB0byBmaWx0ZXIuCiAqIEBwYXJhbSB7c3RyaW5nPX0gc3ltYm9sIEN1cnJlbmN5IHN5bWJvbCBvciBpZGVudGlmaWVyIHRvIGJlIGRpc3BsYXllZC4KICogQHJldHVybnMge3N0cmluZ30gRm9ybWF0dGVkIG51bWJlci4KICoKICogQGNzcyBuZy1mb3JtYXQtbmVnYXRpdmUKICogICBXaGVuIHRoZSB2YWx1ZSBpcyBuZWdhdGl2ZSwgdGhpcyBjc3MgY2xhc3MgaXMgYXBwbGllZCB0byB0aGUgYmluZGluZyBtYWtpbmcgaXQgKGJ5IGRlZmF1bHQpIHJlZC4KICoKICogQGV4YW1wbGUKICAgPGRvYzpleGFtcGxlPgogICAgIDxkb2M6c291cmNlPgogICAgICAgPGlucHV0IHR5cGU9InRleHQiIG5hbWU9ImFtb3VudCIgdmFsdWU9IjEyMzQuNTYiLz4gPGJyLz4KICAgICAgIGRlZmF1bHQgY3VycmVuY3kgc3ltYm9sICgkKToge3thbW91bnQgfCBjdXJyZW5jeX19PGJyLz4KICAgICAgIGN1c3RvbSBjdXJyZW5jeSBpZGVudGlmaWVyIChVU0QkKToge3thbW91bnQgfCBjdXJyZW5jeToiVVNEJCJ9fQogICAgIDwvZG9jOnNvdXJjZT4KICAgICA8ZG9jOnNjZW5hcmlvPgogICAgICAgaXQoJ3Nob3VsZCBpbml0IHdpdGggMTIzNC41NicsIGZ1bmN0aW9uKCl7CiAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdhbW91bnQgfCBjdXJyZW5jeScpKS50b0JlKCckMSwyMzQuNTYnKTsKICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ2Ftb3VudCB8IGN1cnJlbmN5OiJVU0QkIicpKS50b0JlKCdVU0QkMSwyMzQuNTYnKTsKICAgICAgIH0pOwogICAgICAgaXQoJ3Nob3VsZCB1cGRhdGUnLCBmdW5jdGlvbigpewogICAgICAgICBpbnB1dCgnYW1vdW50JykuZW50ZXIoJy0xMjM0Jyk7CiAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdhbW91bnQgfCBjdXJyZW5jeScpKS50b0JlKCcoJDEsMjM0LjAwKScpOwogICAgICAgICBleHBlY3QoYmluZGluZygnYW1vdW50IHwgY3VycmVuY3k6IlVTRCQiJykpLnRvQmUoJyhVU0QkMSwyMzQuMDApJyk7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSAubmctYmluZGluZycpLmF0dHIoJ2NsYXNzTmFtZScpKS4KICAgICAgICAgICB0b01hdGNoKC9uZy1mb3JtYXQtbmVnYXRpdmUvKTsKICAgICAgIH0pOwogICAgIDwvZG9jOnNjZW5hcmlvPgogICA8L2RvYzpleGFtcGxlPgogKi8KYW5ndWxhckZpbHRlci5jdXJyZW5jeSA9IGZ1bmN0aW9uKGFtb3VudCwgY3VycmVuY3lTeW1ib2wpewogIHRoaXMuJGVsZW1lbnQudG9nZ2xlQ2xhc3MoJ25nLWZvcm1hdC1uZWdhdGl2ZScsIGFtb3VudCA8IDApOwogIGlmIChpc1VuZGVmaW5lZChjdXJyZW5jeVN5bWJvbCkpIGN1cnJlbmN5U3ltYm9sID0gTlVNQkVSX0ZPUk1BVFMuQ1VSUkVOQ1lfU1lNOwogIHJldHVybiBmb3JtYXROdW1iZXIoYW1vdW50LCAyLCAxKS5yZXBsYWNlKC9cdTAwQTQvZywgY3VycmVuY3lTeW1ib2wpOwp9OwoKLyoqCiAqIEB3b3JrSW5Qcm9ncmVzcwogKiBAbmdkb2MgZmlsdGVyCiAqIEBuYW1lIGFuZ3VsYXIuZmlsdGVyLm51bWJlcgogKiBAZnVuY3Rpb24KICoKICogQGRlc2NyaXB0aW9uCiAqIEZvcm1hdHMgYSBudW1iZXIgYXMgdGV4dC4KICoKICogSWYgdGhlIGlucHV0IGlzIG5vdCBhIG51bWJlciBhbiBlbXB0eSBzdHJpbmcgaXMgcmV0dXJuZWQuCiAqCiAqIEBwYXJhbSB7bnVtYmVyfHN0cmluZ30gbnVtYmVyIE51bWJlciB0byBmb3JtYXQuCiAqIEBwYXJhbSB7KG51bWJlcnxzdHJpbmcpPX0gW2ZyYWN0aW9uU2l6ZT0yXSBOdW1iZXIgb2YgZGVjaW1hbCBwbGFjZXMgdG8gcm91bmQgdGhlIG51bWJlciB0by4KICogQHJldHVybnMge3N0cmluZ30gTnVtYmVyIHJvdW5kZWQgdG8gZGVjaW1hbFBsYWNlcyBhbmQgcGxhY2VzIGEg4oCcLOKAnSBhZnRlciBlYWNoIHRoaXJkIGRpZ2l0LgogKgogKiBAZXhhbXBsZQogICA8ZG9jOmV4YW1wbGU+CiAgICAgPGRvYzpzb3VyY2U+CiAgICAgICBFbnRlciBudW1iZXI6IDxpbnB1dCBuYW1lPSd2YWwnIHZhbHVlPScxMjM0LjU2Nzg5JyAvPjxici8+CiAgICAgICBEZWZhdWx0IGZvcm1hdHRpbmc6IHt7dmFsIHwgbnVtYmVyfX08YnIvPgogICAgICAgTm8gZnJhY3Rpb25zOiB7e3ZhbCB8IG51bWJlcjowfX08YnIvPgogICAgICAgTmVnYXRpdmUgbnVtYmVyOiB7ey12YWwgfCBudW1iZXI6NH19CiAgICAgPC9kb2M6c291cmNlPgogICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgICBpdCgnc2hvdWxkIGZvcm1hdCBudW1iZXJzJywgZnVuY3Rpb24oKXsKICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3ZhbCB8IG51bWJlcicpKS50b0JlKCcxLDIzNC41NjgnKTsKICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3ZhbCB8IG51bWJlcjowJykpLnRvQmUoJzEsMjM1Jyk7CiAgICAgICAgIGV4cGVjdChiaW5kaW5nKCctdmFsIHwgbnVtYmVyOjQnKSkudG9CZSgnLTEsMjM0LjU2NzknKTsKICAgICAgIH0pOwoKICAgICAgIGl0KCdzaG91bGQgdXBkYXRlJywgZnVuY3Rpb24oKXsKICAgICAgICAgaW5wdXQoJ3ZhbCcpLmVudGVyKCczMzc0LjMzMycpOwogICAgICAgICBleHBlY3QoYmluZGluZygndmFsIHwgbnVtYmVyJykpLnRvQmUoJzMsMzc0LjMzMycpOwogICAgICAgICBleHBlY3QoYmluZGluZygndmFsIHwgbnVtYmVyOjAnKSkudG9CZSgnMywzNzQnKTsKICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJy12YWwgfCBudW1iZXI6NCcpKS50b0JlKCctMywzNzQuMzMzMCcpOwogICAgICAgfSk7CiAgICAgPC9kb2M6c2NlbmFyaW8+CiAgIDwvZG9jOmV4YW1wbGU+CiAqLwoKLy8gUEFUVEVSTlNbMF0gaXMgYW4gYXJyYXkgZm9yIERlY2ltYWwgUGF0dGVybiwgUEFUVEVSTlNbMV0gaXMgYW4gYXJyYXkgQ3VycmVuY3kgUGF0dGVybgovLyBGb2xsb3dpbmcgaXMgdGhlIG9yZGVyIGluIGVhY2ggcGF0dGVybiBhcnJheToKLy8gMDogbWluSW50ZWdlciwKLy8gMTogbWluRnJhY3Rpb24sCi8vIDI6IG1heEZyYWN0aW9uLAovLyAzOiBwb3NpdGl2ZVByZWZpeCwKLy8gNDogcG9zaXRpdmVTdWZmaXgsCi8vIDU6IG5lZ2F0aXZlUHJlZml4LAovLyA2OiBuZWdhdGl2ZVN1ZmZpeCwKLy8gNzogZ3JvdXBTaXplLAovLyA4OiBsYXN0R3JvdXBTaXplCnZhciBOVU1CRVJfRk9STUFUUyA9IHsKICAgICAgREVDSU1BTF9TRVA6ICcuJywKICAgICAgR1JPVVBfU0VQOiAnLCcsCiAgICAgIFBBVFRFUk5TOiBbWzEsIDAsIDMsICcnLCAnJywgJy0nLCAnJywgMywgM10sWzEsIDIsIDIsICdcdTAwQTQnLCAnJywgJyhcdTAwQTQnLCAnKScsIDMsIDNdXSwKICAgICAgQ1VSUkVOQ1lfU1lNOiAnJCcKfTsKdmFyIERFQ0lNQUxfU0VQID0gJy4nOwoKYW5ndWxhckZpbHRlci5udW1iZXIgPSBmdW5jdGlvbihudW1iZXIsIGZyYWN0aW9uU2l6ZSkgewogIGlmIChpc05hTihudW1iZXIpIHx8ICFpc0Zpbml0ZShudW1iZXIpKSByZXR1cm4gJyc7CiAgcmV0dXJuIGZvcm1hdE51bWJlcihudW1iZXIsIGZyYWN0aW9uU2l6ZSwgMCk7Cn07CgpmdW5jdGlvbiBmb3JtYXROdW1iZXIobnVtYmVyLCBmcmFjdGlvblNpemUsIHR5cGUpIHsKICB2YXIgaXNOZWdhdGl2ZSA9IG51bWJlciA8IDAsCiAgICAgIHR5cGUgPSB0eXBlIHx8IDAsIC8vIDAgaXMgZGVjaW1hbCBwYXR0ZXJuLCAxIGlzIGN1cnJlbmN5IHBhdHRlcm4KICAgICAgcGF0dGVybiA9IE5VTUJFUl9GT1JNQVRTLlBBVFRFUk5TW3R5cGVdOwoKICBudW1iZXIgPSBNYXRoLmFicyhudW1iZXIpOwogIHZhciBudW1TdHIgPSAgbnVtYmVyICsgJycsCiAgICAgIGZvcm1hdGVkVGV4dCA9ICcnLAogICAgICBwYXJ0cyA9IFtdOwoKICBpZiAobnVtU3RyLmluZGV4T2YoJ2UnKSAhPT0gLTEpIHsKICAgIHZhciBmb3JtYXRlZFRleHQgPSBudW1TdHI7CiAgfSBlbHNlIHsKICAgIHZhciBmcmFjdGlvbkxlbiA9IChudW1TdHIuc3BsaXQoREVDSU1BTF9TRVApWzFdIHx8ICcnKS5sZW5ndGg7CgogICAgLy9kZXRlcm1pbmUgZnJhY3Rpb25TaXplIGlmIGl0IGlzIG5vdCBzcGVjaWZpZWQKICAgIGlmIChpc1VuZGVmaW5lZChmcmFjdGlvblNpemUpKSB7CiAgICAgIGZyYWN0aW9uU2l6ZSA9IE1hdGgubWluKE1hdGgubWF4KHBhdHRlcm5bMV0sIGZyYWN0aW9uTGVuKSwgcGF0dGVyblsyXSk7CiAgICB9CgogICAgdmFyIHBvdyA9IE1hdGgucG93KDEwLCBmcmFjdGlvblNpemUpOwogICAgbnVtYmVyID0gTWF0aC5yb3VuZChudW1iZXIgKiBwb3cpIC8gcG93OwogICAgdmFyIGZyYWN0aW9uID0gKCcnICsgbnVtYmVyKS5zcGxpdChERUNJTUFMX1NFUCk7CiAgICB2YXIgd2hvbGUgPSBmcmFjdGlvblswXTsKICAgIGZyYWN0aW9uID0gZnJhY3Rpb25bMV0gfHwgJyc7CgogICAgdmFyIHBvcyA9IDAsCiAgICAgICAgbGdyb3VwID0gcGF0dGVybls4XSwKICAgICAgICBncm91cCA9IHBhdHRlcm5bN107CgogICAgaWYgKHdob2xlLmxlbmd0aCA+PSAobGdyb3VwICsgZ3JvdXApKSB7CiAgICAgIHBvcyA9IHdob2xlLmxlbmd0aCAtIGxncm91cDsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwb3M7IGkrKykgewogICAgICAgIGlmICgocG9zIC0gaSklZ3JvdXAgPT09IDAgJiYgaSAhPT0gMCkgewogICAgICAgICAgZm9ybWF0ZWRUZXh0ICs9IE5VTUJFUl9GT1JNQVRTLkdST1VQX1NFUDsKICAgICAgICB9CiAgICAgICAgZm9ybWF0ZWRUZXh0ICs9IHdob2xlLmNoYXJBdChpKTsKICAgICAgfQogICAgfQoKICAgIGZvciAoaSA9IHBvczsgaSA8IHdob2xlLmxlbmd0aDsgaSsrKSB7CiAgICAgIGlmICgod2hvbGUubGVuZ3RoIC0gaSklbGdyb3VwID09PSAwICYmIGkgIT09IDApIHsKICAgICAgICBmb3JtYXRlZFRleHQgKz0gTlVNQkVSX0ZPUk1BVFMuR1JPVVBfU0VQOwogICAgICB9CiAgICAgIGZvcm1hdGVkVGV4dCArPSB3aG9sZS5jaGFyQXQoaSk7CiAgICB9CgogICAgLy8gZm9ybWF0IGZyYWN0aW9uIHBhcnQuCiAgICB3aGlsZShmcmFjdGlvbi5sZW5ndGggPCBmcmFjdGlvblNpemUpIHsKICAgICAgZnJhY3Rpb24gKz0gJzAnOwogICAgfQogICAgaWYgKGZyYWN0aW9uU2l6ZSkgZm9ybWF0ZWRUZXh0ICs9IE5VTUJFUl9GT1JNQVRTLkRFQ0lNQUxfU0VQICsgZnJhY3Rpb24uc3Vic3RyKDAsIGZyYWN0aW9uU2l6ZSk7CiAgfQoKICBwYXJ0cy5wdXNoKGlzTmVnYXRpdmUgPyBwYXR0ZXJuWzVdIDogcGF0dGVyblszXSk7CiAgcGFydHMucHVzaChmb3JtYXRlZFRleHQpOwogIHBhcnRzLnB1c2goaXNOZWdhdGl2ZSA/IHBhdHRlcm5bNl0gOiBwYXR0ZXJuWzRdKTsKICByZXR1cm4gcGFydHMuam9pbignJyk7Cn0KCmZ1bmN0aW9uIHBhZE51bWJlcihudW0sIGRpZ2l0cywgdHJpbSkgewogIHZhciBuZWcgPSAnJzsKICBpZiAobnVtIDwgMCkgewogICAgbmVnID0gICctJzsKICAgIG51bSA9IC1udW07CiAgfQogIG51bSA9ICcnICsgbnVtOwogIHdoaWxlKG51bS5sZW5ndGggPCBkaWdpdHMpIG51bSA9ICcwJyArIG51bTsKICBpZiAodHJpbSkKICAgIG51bSA9IG51bS5zdWJzdHIobnVtLmxlbmd0aCAtIGRpZ2l0cyk7CiAgcmV0dXJuIG5lZyArIG51bTsKfQoKCmZ1bmN0aW9uIGRhdGVHZXR0ZXIobmFtZSwgc2l6ZSwgb2Zmc2V0LCB0cmltKSB7CiAgcmV0dXJuIGZ1bmN0aW9uKGRhdGUpIHsKICAgIHZhciB2YWx1ZSA9IGRhdGVbJ2dldCcgKyBuYW1lXSgpOwogICAgaWYgKG9mZnNldCA+IDAgfHwgdmFsdWUgPiAtb2Zmc2V0KQogICAgICB2YWx1ZSArPSBvZmZzZXQ7CiAgICBpZiAodmFsdWUgPT09IDAgJiYgb2Zmc2V0ID09IC0xMiApIHZhbHVlID0gMTI7CiAgICByZXR1cm4gcGFkTnVtYmVyKHZhbHVlLCBzaXplLCB0cmltKTsKICB9Owp9CgpmdW5jdGlvbiBkYXRlU3RyR2V0dGVyKG5hbWUsIHNob3J0Rm9ybSkgewogIHJldHVybiBmdW5jdGlvbihkYXRlKSB7CiAgICB2YXIgdmFsdWUgPSBkYXRlWydnZXQnICsgbmFtZV0oKTsKCiAgICBpZihuYW1lID09ICdNb250aCcpIHsKICAgICAgdmFsdWUgPSBNT05USFt2YWx1ZV07CiAgICB9IGVsc2UgewogICAgICB2YWx1ZSA9IERBWVt2YWx1ZV07CiAgICB9CgogICAgcmV0dXJuIHNob3J0Rm9ybSA/IHZhbHVlLnN1YnN0cigwLDMpIDogdmFsdWU7CiAgfTsKfQoKZnVuY3Rpb24gdGltZVpvbmVHZXR0ZXIobnVtRm9ybWF0KSB7CiAgcmV0dXJuIGZ1bmN0aW9uKGRhdGUpIHsKICAgIHZhciB0aW1lWm9uZTsKICAgIGlmIChudW1Gb3JtYXQgfHwgISh0aW1lWm9uZSA9IEdFVF9USU1FX1pPTkUuZXhlYyhkYXRlLnRvU3RyaW5nKCkpKSkgewogICAgICB2YXIgb2Zmc2V0ID0gZGF0ZS5nZXRUaW1lem9uZU9mZnNldCgpOwogICAgICByZXR1cm4gcGFkTnVtYmVyKG9mZnNldCAvIDYwLCAyKSArIHBhZE51bWJlcihNYXRoLmFicyhvZmZzZXQgJSA2MCksIDIpOwogICAgfQogICAgcmV0dXJuIHRpbWVab25lWzBdOwogIH07Cn0KCnZhciBEQVkgPSAnU3VuZGF5LE1vbmRheSxUdWVzZGF5LFdlZG5lc2RheSxUaHVyc2RheSxGcmlkYXksU2F0dXJkYXknLnNwbGl0KCcsJyk7Cgp2YXIgTU9OVEggPSAnSmFudWFyeSxGZWJydWFyeSxNYXJjaCxBcHJpbCxNYXksSnVuZSxKdWx5LEF1Z3VzdCxTZXB0ZW1iZXIsT2N0b2JlcixOb3ZlbWJlcixEZWNlbWJlcicuCiAgICAgICAgICAgICBzcGxpdCgnLCcpOwoKdmFyIERBVEVfRk9STUFUUyA9IHsKICB5eXl5OiBkYXRlR2V0dGVyKCdGdWxsWWVhcicsIDQpLAogICAgeXk6IGRhdGVHZXR0ZXIoJ0Z1bGxZZWFyJywgMiwgMCwgdHJ1ZSksCiAgICAgeTogZGF0ZUdldHRlcignRnVsbFllYXInLCAxKSwKICBNTU1NOiBkYXRlU3RyR2V0dGVyKCdNb250aCcpLAogICBNTU06IGRhdGVTdHJHZXR0ZXIoJ01vbnRoJywgdHJ1ZSksCiAgICBNTTogZGF0ZUdldHRlcignTW9udGgnLCAyLCAxKSwKICAgICBNOiBkYXRlR2V0dGVyKCdNb250aCcsIDEsIDEpLAogICAgZGQ6IGRhdGVHZXR0ZXIoJ0RhdGUnLCAyKSwKICAgICBkOiBkYXRlR2V0dGVyKCdEYXRlJywgMSksCiAgICBISDogZGF0ZUdldHRlcignSG91cnMnLCAyKSwKICAgICBIOiBkYXRlR2V0dGVyKCdIb3VycycsIDEpLAogICAgaGg6IGRhdGVHZXR0ZXIoJ0hvdXJzJywgMiwgLTEyKSwKICAgICBoOiBkYXRlR2V0dGVyKCdIb3VycycsIDEsIC0xMiksCiAgICBtbTogZGF0ZUdldHRlcignTWludXRlcycsIDIpLAogICAgIG06IGRhdGVHZXR0ZXIoJ01pbnV0ZXMnLCAxKSwKICAgIHNzOiBkYXRlR2V0dGVyKCdTZWNvbmRzJywgMiksCiAgICAgczogZGF0ZUdldHRlcignU2Vjb25kcycsIDEpLAogIEVFRUU6IGRhdGVTdHJHZXR0ZXIoJ0RheScpLAogICBFRUU6IGRhdGVTdHJHZXR0ZXIoJ0RheScsIHRydWUpLAogICAgIGE6IGZ1bmN0aW9uKGRhdGUpe3JldHVybiBkYXRlLmdldEhvdXJzKCkgPCAxMiA/ICdhbScgOiAncG0nO30sCiAgICAgejogdGltZVpvbmVHZXR0ZXIoZmFsc2UpLAogICAgIFo6IHRpbWVab25lR2V0dGVyKHRydWUpCn07Cgp2YXIgREVGQVVMVF9EQVRFVElNRV9GT1JNQVRTID0gewogICAgICAgICBsb25nOiAnTU1NTSBkLCB5IGg6bW06c3MgYSB6JywKICAgICAgIG1lZGl1bTogJ01NTSBkLCB5IGg6bW06c3MgYScsCiAgICAgICAgc2hvcnQ6ICdNL2QveXkgaDptbSBhJywKICAgIGZ1bGxEYXRlOiAnRUVFRSwgTU1NTSBkLCB5JywKICAgIGxvbmdEYXRlOiAnTU1NTSBkLCB5JywKICBtZWRpdW1EYXRlOiAnTU1NIGQsIHknLAogICBzaG9ydERhdGU6ICdNL2QveXknLAogICAgbG9uZ1RpbWU6ICdoOm1tOnNzIGEgeicsCiAgbWVkaXVtVGltZTogJ2g6bW06c3MgYScsCiAgIHNob3J0VGltZTogJ2g6bW0gYScKfTsKCnZhciBHRVRfVElNRV9aT05FID0gL1tBLVpdezN9KD8hWytcLV0pLzsKdmFyIERBVEVfRk9STUFUU19TUExJVCA9IC8oW155TWRIaG1zYXpaRV0qKShFK3x5K3xNK3xkK3xIK3xoK3xtK3xzK3xhfFp8eikoLiopLzsKdmFyIE9QRVJBX1RPU1RSSU5HX1BBVFRFUk4gPSAvXltcZF0uKlokLzsKdmFyIE5VTUJFUl9TVFJJTkcgPSAvXlxkKyQvOwoKCi8qKgogKiBAd29ya0luUHJvZ3Jlc3MKICogQG5nZG9jIGZpbHRlcgogKiBAbmFtZSBhbmd1bGFyLmZpbHRlci5kYXRlCiAqIEBmdW5jdGlvbgogKgogKiBAZGVzY3JpcHRpb24KICogICBGb3JtYXRzIGBkYXRlYCB0byBhIHN0cmluZyBiYXNlZCBvbiB0aGUgcmVxdWVzdGVkIGBmb3JtYXRgLgogKgogKiAgIGBmb3JtYXRgIHN0cmluZyBjYW4gYmUgY29tcG9zZWQgb2YgdGhlIGZvbGxvd2luZyBlbGVtZW50czoKICoKICogICAqIGAneXl5eSdgOiA0IGRpZ2l0IHJlcHJlc2VudGF0aW9uIG9mIHllYXIgKGUuZy4gQUQgMSA9PiAwMDAxLCBBRCAyMDEwID0+IDIwMTApCiAqICAgKiBgJ3l5J2A6IDIgZGlnaXQgcmVwcmVzZW50YXRpb24gb2YgeWVhciwgcGFkZGVkICgwMC05OSkuIChlLmcuIEFEIDIwMDEgPT4gMDEsIEFEIDIwMTAgPT4gMTApCiAqICAgKiBgJ3knYDogMSBkaWdpdCByZXByZXNlbnRhdGlvbiBvZiB5ZWFyLCBlLmcuIChBRCAxID0+IDEsIEFEIDE5OSA9PiAxOTkpCiAqICAgKiBgJ01NTU0nYDogTW9udGggaW4geWVhciAoSmFudWFyeS1EZWNlbWJlcikKICogICAqIGAnTU1NJ2A6IE1vbnRoIGluIHllYXIgKEphbi1EZWMpCiAqICAgKiBgJ01NJ2A6IE1vbnRoIGluIHllYXIsIHBhZGRlZCAoMDEtMTIpCiAqICAgKiBgJ00nYDogTW9udGggaW4geWVhciAoMS0xMikKICogICAqIGAnZGQnYDogRGF5IGluIG1vbnRoLCBwYWRkZWQgKDAxLTMxKQogKiAgICogYCdkJ2A6IERheSBpbiBtb250aCAoMS0zMSkKICogICAqIGAnRUVFRSdgOiBEYXkgaW4gV2VlaywoU3VuZGF5LVNhdHVyZGF5KQogKiAgICogYCdFRUUnYDogRGF5IGluIFdlZWssIChTdW4tU2F0KQogKiAgICogYCdISCdgOiBIb3VyIGluIGRheSwgcGFkZGVkICgwMC0yMykKICogICAqIGAnSCdgOiBIb3VyIGluIGRheSAoMC0yMykKICogICAqIGAnaGgnYDogSG91ciBpbiBhbS9wbSwgcGFkZGVkICgwMS0xMikKICogICAqIGAnaCdgOiBIb3VyIGluIGFtL3BtLCAoMS0xMikKICogICAqIGAnbW0nYDogTWludXRlIGluIGhvdXIsIHBhZGRlZCAoMDAtNTkpCiAqICAgKiBgJ20nYDogTWludXRlIGluIGhvdXIgKDAtNTkpCiAqICAgKiBgJ3NzJ2A6IFNlY29uZCBpbiBtaW51dGUsIHBhZGRlZCAoMDAtNTkpCiAqICAgKiBgJ3MnYDogU2Vjb25kIGluIG1pbnV0ZSAoMC01OSkKICogICAqIGAnYSdgOiBhbS9wbSBtYXJrZXIKICogICAqIGAnWidgOiA0IGRpZ2l0ICgrc2lnbikgcmVwcmVzZW50YXRpb24gb2YgdGhlIHRpbWV6b25lIG9mZnNldCAoLTEyMDAtMTIwMCkKICogICAqIGAneidgOiBzaG9ydCBmb3JtIG9mIGN1cnJlbnQgdGltZXpvbmUgbmFtZSAoZS5nLiBQRFQpCiAqCiAqICAgYGZvcm1hdGAgc3RyaW5nIGNhbiBhbHNvIGJlIHRoZSBmb2xsb3dpbmcgZGVmYXVsdCBmb3JtYXRzIGZvciBgZW5fVVNgIGxvY2FsZSAoc3VwcG9ydCBmb3Igb3RoZXIKICogICAgbG9jYWxlcyB3aWxsIGJlIGFkZGVkIGluIHRoZSBmdXR1cmUgdmVyc2lvbnMpOgogKgogKiAgICogYCdsb25nJ2A6IGVxdWl2YWxlbnQgdG8gYCdNTU1NIGQsIHkgaDptbTpzcyBhIHonYCBmb3IgZW5fVVMgIGxvY2FsZQogKiAgICAgKGUuZy4gU2VwdGVtYmVyIDMsIDIwMTAgMTI6MDU6MDggcG0gUERUKQogKiAgICogYCdtZWRpdW0nYDogZXF1aXZhbGVudCB0byBgJ01NTSBkLCB5IGg6bW06c3MgYSdgIGZvciBlbl9VUyBsb2NhbGUKICogICAgIChlLmcuIFNlcCAzLCAyMDEwIDEyOjA1OjA4IHBtKQogKiAgICogYCdzaG9ydCdgOiBlcXVpdmFsZW50IHRvIGAnTS9kL3l5IGg6bW0gYSdgIGZvciBlbl9VUyAgbG9jYWxlIChlLmcuIDkvMy8xMCAxMjowNSBwbSkKICogICAqIGAnZnVsbERhdGUnYDogZXF1aXZhbGVudCB0byBgJ0VFRUUsIE1NTU0gZCx5J2AgZm9yIGVuX1VTICBsb2NhbGUKICogICAgIChlLmcuIEZyaWRheSwgU2VwdGVtYmVyIDMsIDIwMTApCiAqICAgKiBgJ2xvbmdEYXRlJ2A6IGVxdWl2YWxlbnQgdG8gYCdNTU1NIGQsIHknYCBmb3IgZW5fVVMgIGxvY2FsZSAoZS5nLiBTZXB0ZW1iZXIgMywgMjAxMAogKiAgICogYCdtZWRpdW1EYXRlJ2A6IGVxdWl2YWxlbnQgdG8gYCdNTU0gZCwgeSdgIGZvciBlbl9VUyAgbG9jYWxlIChlLmcuIFNlcCAzLCAyMDEwKQogKiAgICogYCdzaG9ydERhdGUnYDogZXF1aXZhbGVudCB0byBgJ00vZC95eSdgIGZvciBlbl9VUyBsb2NhbGUgKGUuZy4gOS8zLzEwKQogKiAgICogYCdsb25nVGltZSdgOiBlcXVpdmFsZW50IHRvIGAnaDptbTpzcyBhIHonYCBmb3IgZW5fVVMgbG9jYWxlIChlLmcuIDEyOjA1OjA4IHBtIFBEVCkKICogICAqIGAnbWVkaXVtVGltZSdgOiBlcXVpdmFsZW50IHRvIGAnaDptbTpzcyBhJ2AgZm9yIGVuX1VTIGxvY2FsZSAoZS5nLiAxMjowNTowOCBwbSkKICogICAqIGAnc2hvcnRUaW1lJ2A6IGVxdWl2YWxlbnQgdG8gYCdoOm1tIGEnYCBmb3IgZW5fVVMgbG9jYWxlIChlLmcuIDEyOjA1IHBtKQogKgogKiBAcGFyYW0geyhEYXRlfG51bWJlcnxzdHJpbmcpfSBkYXRlIERhdGUgdG8gZm9ybWF0IGVpdGhlciBhcyBEYXRlIG9iamVjdCwgbWlsbGlzZWNvbmRzIChzdHJpbmcgb3IKICogICAgbnVtYmVyKSBvciBJU08gODYwMSBleHRlbmRlZCBkYXRldGltZSBzdHJpbmcgKHl5eXktTU0tZGRUSEg6bW06c3MuU1NTWikuCiAqIEBwYXJhbSB7c3RyaW5nPX0gZm9ybWF0IEZvcm1hdHRpbmcgcnVsZXMgKHNlZSBEZXNjcmlwdGlvbikuIElmIG5vdCBzcGVjaWZpZWQsCiAqICAgIERhdGUjdG9Mb2NhbGVEYXRlU3RyaW5nIGlzIHVzZWQuCiAqIEByZXR1cm5zIHtzdHJpbmd9IEZvcm1hdHRlZCBzdHJpbmcgb3IgdGhlIGlucHV0IGlmIGlucHV0IGlzIG5vdCByZWNvZ25pemVkIGFzIGRhdGUvbWlsbGlzLgogKgogKiBAZXhhbXBsZQogICA8ZG9jOmV4YW1wbGU+CiAgICAgPGRvYzpzb3VyY2U+CiAgICAgICA8c3BhbiBuZzpub24tYmluZGFibGU+e3sxMjg4MzIzNjIzMDA2IHwgZGF0ZTonbWVkaXVtJ319PC9zcGFuPjoKICAgICAgICAgICB7ezEyODgzMjM2MjMwMDYgfCBkYXRlOidtZWRpdW0nfX08YnIvPgogICAgICAgPHNwYW4gbmc6bm9uLWJpbmRhYmxlPnt7MTI4ODMyMzYyMzAwNiB8IGRhdGU6J3l5eXktTU0tZGQgSEg6bW06c3MgWid9fTwvc3Bhbj46CiAgICAgICAgICB7ezEyODgzMjM2MjMwMDYgfCBkYXRlOid5eXl5LU1NLWRkIEhIOm1tOnNzIFonfX08YnIvPgogICAgICAgPHNwYW4gbmc6bm9uLWJpbmRhYmxlPnt7MTI4ODMyMzYyMzAwNiB8IGRhdGU6J01NL2RkL3l5eXkgQCBoOm1tYSd9fTwvc3Bhbj46CiAgICAgICAgICB7eycxMjg4MzIzNjIzMDA2JyB8IGRhdGU6J01NL2RkL3l5eXkgQCBoOm1tYSd9fTxici8+CiAgICAgPC9kb2M6c291cmNlPgogICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgICBpdCgnc2hvdWxkIGZvcm1hdCBkYXRlJywgZnVuY3Rpb24oKXsKICAgICAgICAgZXhwZWN0KGJpbmRpbmcoIjEyODgzMjM2MjMwMDYgfCBkYXRlOidtZWRpdW0nIikpLgogICAgICAgICAgICB0b01hdGNoKC9PY3QgMlxkLCAyMDEwIFxkezEsMn06XGR7Mn06XGR7Mn0gKGFtfHBtKS8pOwogICAgICAgICBleHBlY3QoYmluZGluZygiMTI4ODMyMzYyMzAwNiB8IGRhdGU6J3l5eXktTU0tZGQgSEg6bW06c3MgWiciKSkuCiAgICAgICAgICAgIHRvTWF0Y2goLzIwMTBcLTEwXC0yXGQgXGR7Mn06XGR7Mn06XGR7Mn0gXC0/XGR7NH0vKTsKICAgICAgICAgZXhwZWN0KGJpbmRpbmcoIicxMjg4MzIzNjIzMDA2JyB8IGRhdGU6J01NL2RkL3l5eXkgQCBoOm1tYSciKSkuCiAgICAgICAgICAgIHRvTWF0Y2goLzEwXC8yXGRcLzIwMTAgQCBcZHsxLDJ9OlxkezJ9KGFtfHBtKS8pOwogICAgICAgfSk7CiAgICAgPC9kb2M6c2NlbmFyaW8+CiAgIDwvZG9jOmV4YW1wbGU+CiAqLwphbmd1bGFyRmlsdGVyLmRhdGUgPSBmdW5jdGlvbihkYXRlLCBmb3JtYXQpIHsKICBmb3JtYXQgPSBERUZBVUxUX0RBVEVUSU1FX0ZPUk1BVFNbZm9ybWF0XSB8fCBmb3JtYXQ7CiAgaWYgKGlzU3RyaW5nKGRhdGUpKSB7CiAgICBpZiAoTlVNQkVSX1NUUklORy50ZXN0KGRhdGUpKSB7CiAgICAgIGRhdGUgPSBwYXJzZUludChkYXRlLCAxMCk7CiAgICB9IGVsc2UgewogICAgICBkYXRlID0gYW5ndWxhclN0cmluZy50b0RhdGUoZGF0ZSk7CiAgICB9CiAgfQoKICBpZiAoaXNOdW1iZXIoZGF0ZSkpIHsKICAgIGRhdGUgPSBuZXcgRGF0ZShkYXRlKTsKICB9CgogIGlmICghaXNEYXRlKGRhdGUpKSB7CiAgICByZXR1cm4gZGF0ZTsKICB9CgogIHZhciB0ZXh0ID0gZGF0ZS50b0xvY2FsZURhdGVTdHJpbmcoKSwgZm47CiAgaWYgKGZvcm1hdCAmJiBpc1N0cmluZyhmb3JtYXQpKSB7CiAgICB0ZXh0ID0gJyc7CiAgICB2YXIgcGFydHMgPSBbXSwgbWF0Y2g7CiAgICB3aGlsZShmb3JtYXQpIHsKICAgICAgbWF0Y2ggPSBEQVRFX0ZPUk1BVFNfU1BMSVQuZXhlYyhmb3JtYXQpOwogICAgICBpZiAobWF0Y2gpIHsKICAgICAgICBwYXJ0cyA9IGNvbmNhdChwYXJ0cywgbWF0Y2gsIDEpOwogICAgICAgIGZvcm1hdCA9IHBhcnRzLnBvcCgpOwogICAgICB9IGVsc2UgewogICAgICAgIHBhcnRzLnB1c2goZm9ybWF0KTsKICAgICAgICBmb3JtYXQgPSBudWxsOwogICAgICB9CiAgICB9CiAgICBmb3JFYWNoKHBhcnRzLCBmdW5jdGlvbih2YWx1ZSl7CiAgICAgIGZuID0gREFURV9GT1JNQVRTW3ZhbHVlXTsKICAgICAgdGV4dCArPSBmbiA/IGZuKGRhdGUpIDogdmFsdWU7CiAgICB9KTsKICB9CiAgcmV0dXJuIHRleHQ7Cn07CgoKLyoqCiAqIEB3b3JrSW5Qcm9ncmVzcwogKiBAbmdkb2MgZmlsdGVyCiAqIEBuYW1lIGFuZ3VsYXIuZmlsdGVyLmpzb24KICogQGZ1bmN0aW9uCiAqCiAqIEBkZXNjcmlwdGlvbgogKiAgIEFsbG93cyB5b3UgdG8gY29udmVydCBhIEphdmFTY3JpcHQgb2JqZWN0IGludG8gSlNPTiBzdHJpbmcuCiAqCiAqICAgVGhpcyBmaWx0ZXIgaXMgbW9zdGx5IHVzZWZ1bCBmb3IgZGVidWdnaW5nLiBXaGVuIHVzaW5nIHRoZSBkb3VibGUgY3VybHkge3t2YWx1ZX19IG5vdGF0aW9uCiAqICAgdGhlIGJpbmRpbmcgaXMgYXV0b21hdGljYWxseSBjb252ZXJ0ZWQgdG8gSlNPTi4KICoKICogQHBhcmFtIHsqfSBvYmplY3QgQW55IEphdmFTY3JpcHQgb2JqZWN0IChpbmNsdWRpbmcgYXJyYXlzIGFuZCBwcmltaXRpdmUgdHlwZXMpIHRvIGZpbHRlci4KICogQHJldHVybnMge3N0cmluZ30gSlNPTiBzdHJpbmcuCiAqCiAqIEBjc3MgbmctbW9ub3NwYWNlIEFsd2F5cyBhcHBsaWVkIHRvIHRoZSBlbmNhcHN1bGF0aW5nIGVsZW1lbnQuCiAqCiAqIEBleGFtcGxlOgogICA8ZG9jOmV4YW1wbGU+CiAgICAgPGRvYzpzb3VyY2U+CiAgICAgICA8aW5wdXQgdHlwZT0idGV4dCIgbmFtZT0ib2JqVHh0IiB2YWx1ZT0ie2E6MSwgYjpbXX0iCiAgICAgICAgICAgICAgbmc6ZXZhbD0ib2JqID0gJGV2YWwob2JqVHh0KSIvPgogICAgICAgPHByZT57eyBvYmogfCBqc29uIH19PC9wcmU+CiAgICAgPC9kb2M6c291cmNlPgogICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgICBpdCgnc2hvdWxkIGpzb25pZnkgZmlsdGVyZWQgb2JqZWN0cycsIGZ1bmN0aW9uKCkgewogICAgICAgICBleHBlY3QoYmluZGluZygnb2JqIHwganNvbicpKS50b0JlKCd7XG4gICJhIjoxLFxuICAiYiI6W119Jyk7CiAgICAgICB9KTsKCiAgICAgICBpdCgnc2hvdWxkIHVwZGF0ZScsIGZ1bmN0aW9uKCkgewogICAgICAgICBpbnB1dCgnb2JqVHh0JykuZW50ZXIoJ1sxLCAyLCAzXScpOwogICAgICAgICBleHBlY3QoYmluZGluZygnb2JqIHwganNvbicpKS50b0JlKCdbMSwyLDNdJyk7CiAgICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgPC9kb2M6ZXhhbXBsZT4KICoKICovCmFuZ3VsYXJGaWx0ZXIuanNvbiA9IGZ1bmN0aW9uKG9iamVjdCkgewogIHRoaXMuJGVsZW1lbnQuYWRkQ2xhc3MoIm5nLW1vbm9zcGFjZSIpOwogIHJldHVybiB0b0pzb24ob2JqZWN0LCB0cnVlKTsKfTsKCgovKioKICogQHdvcmtJblByb2dyZXNzCiAqIEBuZ2RvYyBmaWx0ZXIKICogQG5hbWUgYW5ndWxhci5maWx0ZXIubG93ZXJjYXNlCiAqIEBmdW5jdGlvbgogKgogKiBAc2VlIGFuZ3VsYXIubG93ZXJjYXNlCiAqLwphbmd1bGFyRmlsdGVyLmxvd2VyY2FzZSA9IGxvd2VyY2FzZTsKCgovKioKICogQHdvcmtJblByb2dyZXNzCiAqIEBuZ2RvYyBmaWx0ZXIKICogQG5hbWUgYW5ndWxhci5maWx0ZXIudXBwZXJjYXNlCiAqIEBmdW5jdGlvbgogKgogKiBAc2VlIGFuZ3VsYXIudXBwZXJjYXNlCiAqLwphbmd1bGFyRmlsdGVyLnVwcGVyY2FzZSA9IHVwcGVyY2FzZTsKCgovKioKICogQHdvcmtJblByb2dyZXNzCiAqIEBuZ2RvYyBmaWx0ZXIKICogQG5hbWUgYW5ndWxhci5maWx0ZXIuaHRtbAogKiBAZnVuY3Rpb24KICoKICogQGRlc2NyaXB0aW9uCiAqICAgUHJldmVudHMgdGhlIGlucHV0IGZyb20gZ2V0dGluZyBlc2NhcGVkIGJ5IGFuZ3VsYXIuIEJ5IGRlZmF1bHQgdGhlIGlucHV0IGlzIHNhbml0aXplZCBhbmQKICogICBpbnNlcnRlZCBpbnRvIHRoZSBET00gYXMgaXMuCiAqCiAqICAgVGhlIGlucHV0IGlzIHNhbml0aXplZCBieSBwYXJzaW5nIHRoZSBodG1sIGludG8gdG9rZW5zLiBBbGwgc2FmZSB0b2tlbnMgKGZyb20gYSB3aGl0ZWxpc3QpIGFyZQogKiAgIHRoZW4gc2VyaWFsaXplZCBiYWNrIHRvIHByb3Blcmx5IGVzY2FwZWQgaHRtbCBzdHJpbmcuIFRoaXMgbWVhbnMgdGhhdCBubyB1bnNhZmUgaW5wdXQgY2FuIG1ha2UKICogICBpdCBpbnRvIHRoZSByZXR1cm5lZCBzdHJpbmcsIGhvd2V2ZXIsIHNpbmNlIG91ciBwYXJzZXIgaXMgbW9yZSBzdHJpY3QgdGhhbiBhIHR5cGljYWwgYnJvd3NlcgogKiAgIHBhcnNlciwgaXQncyBwb3NzaWJsZSB0aGF0IHNvbWUgb2JzY3VyZSBpbnB1dCwgd2hpY2ggd291bGQgYmUgcmVjb2duaXplZCBhcyB2YWxpZCBIVE1MIGJ5IGEKICogICBicm93c2VyLCB3b24ndCBtYWtlIGl0IHRocm91Z2ggdGhlIHNhbml0aXplci4KICoKICogICBJZiB5b3UgaGF0ZSB5b3VyIHVzZXJzLCB5b3UgbWF5IGNhbGwgdGhlIGZpbHRlciB3aXRoIG9wdGlvbmFsICd1bnNhZmUnIGFyZ3VtZW50LCB3aGljaCBieXBhc3NlcwogKiAgIHRoZSBodG1sIHNhbml0aXplciwgYnV0IG1ha2VzIHlvdXIgYXBwbGljYXRpb24gdnVsbmVyYWJsZSB0byBYU1MgYW5kIG90aGVyIGF0dGFja3MuIFVzaW5nIHRoaXMKICogICBvcHRpb24gaXMgc3Ryb25nbHkgZGlzY291cmFnZWQgYW5kIHNob3VsZCBiZSB1c2VkIG9ubHkgaWYgeW91IGFic29sdXRlbHkgdHJ1c3QgdGhlIGlucHV0IGJlaW5nCiAqICAgZmlsdGVyZWQgYW5kIHlvdSBjYW4ndCBnZXQgdGhlIGNvbnRlbnQgdGhyb3VnaCB0aGUgc2FuaXRpemVyLgogKgogKiBAcGFyYW0ge3N0cmluZ30gaHRtbCBIdG1sIGlucHV0LgogKiBAcGFyYW0ge3N0cmluZz19IG9wdGlvbiBJZiAndW5zYWZlJyB0aGVuIGRvIG5vdCBzYW5pdGl6ZSB0aGUgSFRNTCBpbnB1dC4KICogQHJldHVybnMge3N0cmluZ30gU2FuaXRpemVkIG9yIHJhdyBodG1sLgogKgogKiBAZXhhbXBsZQogICA8ZG9jOmV4YW1wbGU+CiAgICAgPGRvYzpzb3VyY2U+CiAgICAgIFNuaXBwZXQ6IDx0ZXh0YXJlYSBuYW1lPSJzbmlwcGV0IiBjb2xzPSI2MCIgcm93cz0iMyI+CiAgICAgJmx0O3Agc3R5bGU9ImNvbG9yOmJsdWUiJmd0O2FuIGh0bWwKICAgICAmbHQ7ZW0gb25tb3VzZW92ZXI9InRoaXMudGV4dENvbnRlbnQ9J1BXTjNEISciJmd0O2NsaWNrIGhlcmUmbHQ7L2VtJmd0OwogICAgIHNuaXBwZXQmbHQ7L3AmZ3Q7PC90ZXh0YXJlYT4KICAgICAgIDx0YWJsZT4KICAgICAgICAgPHRyPgogICAgICAgICAgIDx0ZD5GaWx0ZXI8L3RkPgogICAgICAgICAgIDx0ZD5Tb3VyY2U8L3RkPgogICAgICAgICAgIDx0ZD5SZW5kZXJlZDwvdGQ+CiAgICAgICAgIDwvdHI+CiAgICAgICAgIDx0ciBpZD0iaHRtbC1maWx0ZXIiPgogICAgICAgICAgIDx0ZD5odG1sIGZpbHRlcjwvdGQ+CiAgICAgICAgICAgPHRkPgogICAgICAgICAgICAgPHByZT4mbHQ7ZGl2IG5nOmJpbmQ9InNuaXBwZXQgfCBodG1sIiZndDs8YnIvPiZsdDsvZGl2Jmd0OzwvcHJlPgogICAgICAgICAgIDwvdGQ+CiAgICAgICAgICAgPHRkPgogICAgICAgICAgICAgPGRpdiBuZzpiaW5kPSJzbmlwcGV0IHwgaHRtbCI+PC9kaXY+CiAgICAgICAgICAgPC90ZD4KICAgICAgICAgPC90cj4KICAgICAgICAgPHRyIGlkPSJlc2NhcGVkLWh0bWwiPgogICAgICAgICAgIDx0ZD5ubyBmaWx0ZXI8L3RkPgogICAgICAgICAgIDx0ZD48cHJlPiZsdDtkaXYgbmc6YmluZD0ic25pcHBldCImZ3Q7PGJyLz4mbHQ7L2RpdiZndDs8L3ByZT48L3RkPgogICAgICAgICAgIDx0ZD48ZGl2IG5nOmJpbmQ9InNuaXBwZXQiPjwvZGl2PjwvdGQ+CiAgICAgICAgIDwvdHI+CiAgICAgICAgIDx0ciBpZD0iaHRtbC11bnNhZmUtZmlsdGVyIj4KICAgICAgICAgICA8dGQ+dW5zYWZlIGh0bWwgZmlsdGVyPC90ZD4KICAgICAgICAgICA8dGQ+PHByZT4mbHQ7ZGl2IG5nOmJpbmQ9InNuaXBwZXQgfCBodG1sOid1bnNhZmUnIiZndDs8YnIvPiZsdDsvZGl2Jmd0OzwvcHJlPjwvdGQ+CiAgICAgICAgICAgPHRkPjxkaXYgbmc6YmluZD0ic25pcHBldCB8IGh0bWw6J3Vuc2FmZSciPjwvZGl2PjwvdGQ+CiAgICAgICAgIDwvdHI+CiAgICAgICA8L3RhYmxlPgogICAgIDwvZG9jOnNvdXJjZT4KICAgICA8ZG9jOnNjZW5hcmlvPgogICAgICAgaXQoJ3Nob3VsZCBzYW5pdGl6ZSB0aGUgaHRtbCBzbmlwcGV0ICcsIGZ1bmN0aW9uKCl7CiAgICAgICAgIGV4cGVjdCh1c2luZygnI2h0bWwtZmlsdGVyJykuYmluZGluZygnc25pcHBldCB8IGh0bWwnKSkuCiAgICAgICAgICAgdG9CZSgnPHA+YW4gaHRtbFxuPGVtPmNsaWNrIGhlcmU8L2VtPlxuc25pcHBldDwvcD4nKTsKICAgICAgIH0pOwoKICAgICAgIGl0KCdzaG91bGQgZXNjYXBlIHNuaXBwZXQgd2l0aG91dCBhbnkgZmlsdGVyJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGV4cGVjdCh1c2luZygnI2VzY2FwZWQtaHRtbCcpLmJpbmRpbmcoJ3NuaXBwZXQnKSkuCiAgICAgICAgICAgdG9CZSgiJmx0O3Agc3R5bGU9XCJjb2xvcjpibHVlXCImZ3Q7YW4gaHRtbFxuIiArCiAgICAgICAgICAgICAgICAiJmx0O2VtIG9ubW91c2VvdmVyPVwidGhpcy50ZXh0Q29udGVudD0nUFdOM0QhJ1wiJmd0O2NsaWNrIGhlcmUmbHQ7L2VtJmd0O1xuIiArCiAgICAgICAgICAgICAgICAic25pcHBldCZsdDsvcCZndDsiKTsKICAgICAgIH0pOwoKICAgICAgIGl0KCdzaG91bGQgaW5saW5lIHJhdyBzbmlwcGV0IGlmIGZpbHRlcmVkIGFzIHVuc2FmZScsIGZ1bmN0aW9uKCkgewogICAgICAgICBleHBlY3QodXNpbmcoJyNodG1sLXVuc2FmZS1maWx0ZXInKS5iaW5kaW5nKCJzbmlwcGV0IHwgaHRtbDondW5zYWZlJyIpKS4KICAgICAgICAgICB0b0JlKCI8cCBzdHlsZT1cImNvbG9yOmJsdWVcIj5hbiBodG1sXG4iICsKICAgICAgICAgICAgICAgICI8ZW0gb25tb3VzZW92ZXI9XCJ0aGlzLnRleHRDb250ZW50PSdQV04zRCEnXCI+Y2xpY2sgaGVyZTwvZW0+XG4iICsKICAgICAgICAgICAgICAgICJzbmlwcGV0PC9wPiIpOwogICAgICAgfSk7CgogICAgICAgaXQoJ3Nob3VsZCB1cGRhdGUnLCBmdW5jdGlvbigpewogICAgICAgICBpbnB1dCgnc25pcHBldCcpLmVudGVyKCduZXcgPGI+dGV4dDwvYj4nKTsKICAgICAgICAgZXhwZWN0KHVzaW5nKCcjaHRtbC1maWx0ZXInKS5iaW5kaW5nKCdzbmlwcGV0IHwgaHRtbCcpKS50b0JlKCduZXcgPGI+dGV4dDwvYj4nKTsKICAgICAgICAgZXhwZWN0KHVzaW5nKCcjZXNjYXBlZC1odG1sJykuYmluZGluZygnc25pcHBldCcpKS50b0JlKCJuZXcgJmx0O2ImZ3Q7dGV4dCZsdDsvYiZndDsiKTsKICAgICAgICAgZXhwZWN0KHVzaW5nKCcjaHRtbC11bnNhZmUtZmlsdGVyJykuYmluZGluZygic25pcHBldCB8IGh0bWw6J3Vuc2FmZSciKSkudG9CZSgnbmV3IDxiPnRleHQ8L2I+Jyk7CiAgICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgPC9kb2M6ZXhhbXBsZT4KICovCmFuZ3VsYXJGaWx0ZXIuaHRtbCA9ICBmdW5jdGlvbihodG1sLCBvcHRpb24pewogIHJldHVybiBuZXcgSFRNTChodG1sLCBvcHRpb24pOwp9OwoKCi8qKgogKiBAd29ya0luUHJvZ3Jlc3MKICogQG5nZG9jIGZpbHRlcgogKiBAbmFtZSBhbmd1bGFyLmZpbHRlci5saW5reQogKiBAZnVuY3Rpb24KICoKICogQGRlc2NyaXB0aW9uCiAqICAgRmluZHMgbGlua3MgaW4gdGV4dCBpbnB1dCBhbmQgdHVybnMgdGhlbSBpbnRvIGh0bWwgbGlua3MuIFN1cHBvcnRzIGh0dHAvaHR0cHMvZnRwL21haWx0byBhbmQKICogICBwbGFpbiBlbWFpbCBhZGRyZXNzIGxpbmtzLgogKgogKiBAcGFyYW0ge3N0cmluZ30gdGV4dCBJbnB1dCB0ZXh0LgogKiBAcmV0dXJucyB7c3RyaW5nfSBIdG1sLWxpbmtpZmllZCB0ZXh0LgogKgogKiBAZXhhbXBsZQogICA8ZG9jOmV4YW1wbGU+CiAgICAgPGRvYzpzb3VyY2U+CiAgICAgICBTbmlwcGV0OiA8dGV4dGFyZWEgbmFtZT0ic25pcHBldCIgY29scz0iNjAiIHJvd3M9IjMiPgogIFByZXR0eSB0ZXh0IHdpdGggc29tZSBsaW5rczoKICBodHRwOi8vYW5ndWxhcmpzLm9yZy8sCiAgbWFpbHRvOnVzQHNvbWV3aGVyZS5vcmcsCiAgYW5vdGhlckBzb21ld2hlcmUub3JnLAogIGFuZCBvbmUgbW9yZTogZnRwOi8vMTI3LjAuMC4xLy48L3RleHRhcmVhPgogICAgICAgPHRhYmxlPgogICAgICAgICA8dHI+CiAgICAgICAgICAgPHRkPkZpbHRlcjwvdGQ+CiAgICAgICAgICAgPHRkPlNvdXJjZTwvdGQ+CiAgICAgICAgICAgPHRkPlJlbmRlcmVkPC90ZD4KICAgICAgICAgPC90cj4KICAgICAgICAgPHRyIGlkPSJsaW5reS1maWx0ZXIiPgogICAgICAgICAgIDx0ZD5saW5reSBmaWx0ZXI8L3RkPgogICAgICAgICAgIDx0ZD4KICAgICAgICAgICAgIDxwcmU+Jmx0O2RpdiBuZzpiaW5kPSJzbmlwcGV0IHwgbGlua3kiJmd0Ozxici8+Jmx0Oy9kaXYmZ3Q7PC9wcmU+CiAgICAgICAgICAgPC90ZD4KICAgICAgICAgICA8dGQ+CiAgICAgICAgICAgICA8ZGl2IG5nOmJpbmQ9InNuaXBwZXQgfCBsaW5reSI+PC9kaXY+CiAgICAgICAgICAgPC90ZD4KICAgICAgICAgPC90cj4KICAgICAgICAgPHRyIGlkPSJlc2NhcGVkLWh0bWwiPgogICAgICAgICAgIDx0ZD5ubyBmaWx0ZXI8L3RkPgogICAgICAgICAgIDx0ZD48cHJlPiZsdDtkaXYgbmc6YmluZD0ic25pcHBldCImZ3Q7PGJyLz4mbHQ7L2RpdiZndDs8L3ByZT48L3RkPgogICAgICAgICAgIDx0ZD48ZGl2IG5nOmJpbmQ9InNuaXBwZXQiPjwvZGl2PjwvdGQ+CiAgICAgICAgIDwvdHI+CiAgICAgICA8L3RhYmxlPgogICAgIDwvZG9jOnNvdXJjZT4KICAgICA8ZG9jOnNjZW5hcmlvPgogICAgICAgaXQoJ3Nob3VsZCBsaW5raWZ5IHRoZSBzbmlwcGV0IHdpdGggdXJscycsIGZ1bmN0aW9uKCl7CiAgICAgICAgIGV4cGVjdCh1c2luZygnI2xpbmt5LWZpbHRlcicpLmJpbmRpbmcoJ3NuaXBwZXQgfCBsaW5reScpKS4KICAgICAgICAgICB0b0JlKCdQcmV0dHkgdGV4dCB3aXRoIHNvbWUgbGlua3M6XG4nICsKICAgICAgICAgICAgICAgICc8YSBocmVmPSJodHRwOi8vYW5ndWxhcmpzLm9yZy8iPmh0dHA6Ly9hbmd1bGFyanMub3JnLzwvYT4sXG4nICsKICAgICAgICAgICAgICAgICc8YSBocmVmPSJtYWlsdG86dXNAc29tZXdoZXJlLm9yZyI+dXNAc29tZXdoZXJlLm9yZzwvYT4sXG4nICsKICAgICAgICAgICAgICAgICc8YSBocmVmPSJtYWlsdG86YW5vdGhlckBzb21ld2hlcmUub3JnIj5hbm90aGVyQHNvbWV3aGVyZS5vcmc8L2E+LFxuJyArCiAgICAgICAgICAgICAgICAnYW5kIG9uZSBtb3JlOiA8YSBocmVmPSJmdHA6Ly8xMjcuMC4wLjEvIj5mdHA6Ly8xMjcuMC4wLjEvPC9hPi4nKTsKICAgICAgIH0pOwoKICAgICAgIGl0ICgnc2hvdWxkIG5vdCBsaW5raWZ5IHNuaXBwZXQgd2l0aG91dCB0aGUgbGlua3kgZmlsdGVyJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGV4cGVjdCh1c2luZygnI2VzY2FwZWQtaHRtbCcpLmJpbmRpbmcoJ3NuaXBwZXQnKSkuCiAgICAgICAgICAgdG9CZSgiUHJldHR5IHRleHQgd2l0aCBzb21lIGxpbmtzOlxuIiArCiAgICAgICAgICAgICAgICAiaHR0cDovL2FuZ3VsYXJqcy5vcmcvLFxuIiArCiAgICAgICAgICAgICAgICAibWFpbHRvOnVzQHNvbWV3aGVyZS5vcmcsXG4iICsKICAgICAgICAgICAgICAgICJhbm90aGVyQHNvbWV3aGVyZS5vcmcsXG4iICsKICAgICAgICAgICAgICAgICJhbmQgb25lIG1vcmU6IGZ0cDovLzEyNy4wLjAuMS8uIik7CiAgICAgICB9KTsKCiAgICAgICBpdCgnc2hvdWxkIHVwZGF0ZScsIGZ1bmN0aW9uKCl7CiAgICAgICAgIGlucHV0KCdzbmlwcGV0JykuZW50ZXIoJ25ldyBodHRwOi8vbGluay4nKTsKICAgICAgICAgZXhwZWN0KHVzaW5nKCcjbGlua3ktZmlsdGVyJykuYmluZGluZygnc25pcHBldCB8IGxpbmt5JykpLgogICAgICAgICAgIHRvQmUoJ25ldyA8YSBocmVmPSJodHRwOi8vbGluayI+aHR0cDovL2xpbms8L2E+LicpOwogICAgICAgICBleHBlY3QodXNpbmcoJyNlc2NhcGVkLWh0bWwnKS5iaW5kaW5nKCdzbmlwcGV0JykpLnRvQmUoJ25ldyBodHRwOi8vbGluay4nKTsKICAgICAgIH0pOwogICAgIDwvZG9jOnNjZW5hcmlvPgogICA8L2RvYzpleGFtcGxlPgogKi8KLy9UT0RPOiBleHRlcm5hbGl6ZSBhbGwgcmVnZXhwcwphbmd1bGFyRmlsdGVyLmxpbmt5ID0gZnVuY3Rpb24odGV4dCl7CiAgaWYgKCF0ZXh0KSByZXR1cm4gdGV4dDsKICB2YXIgVVJMID0gLygoZnRwfGh0dHBzPyk6XC9cL3wobWFpbHRvOik/W0EtWmEtejAtOS5fJSstXStAKVxTKlteXHNcLlw7XCxcKFwpXHtcfVw8XD5dLzsKICB2YXIgbWF0Y2g7CiAgdmFyIHJhdyA9IHRleHQ7CiAgdmFyIGh0bWwgPSBbXTsKICB2YXIgd3JpdGVyID0gaHRtbFNhbml0aXplV3JpdGVyKGh0bWwpOwogIHZhciB1cmw7CiAgdmFyIGk7CiAgd2hpbGUgKG1hdGNoPXJhdy5tYXRjaChVUkwpKSB7CiAgICAvLyBXZSBjYW4gbm90IGVuZCBpbiB0aGVzZSBhcyB0aGV5IGFyZSBzb21ldGltZXMgZm91bmQgYXQgdGhlIGVuZCBvZiB0aGUgc2VudGVuY2UKICAgIHVybCA9IG1hdGNoWzBdOwogICAgLy8gaWYgd2UgZGlkIG5vdCBtYXRjaCBmdHAvaHR0cC9tYWlsdG8gdGhlbiBhc3N1bWUgbWFpbHRvCiAgICBpZiAobWF0Y2hbMl09PW1hdGNoWzNdKSB1cmwgPSAnbWFpbHRvOicgKyB1cmw7CiAgICBpID0gbWF0Y2guaW5kZXg7CiAgICB3cml0ZXIuY2hhcnMocmF3LnN1YnN0cigwLCBpKSk7CiAgICB3cml0ZXIuc3RhcnQoJ2EnLCB7aHJlZjp1cmx9KTsKICAgIHdyaXRlci5jaGFycyhtYXRjaFswXS5yZXBsYWNlKC9ebWFpbHRvOi8sICcnKSk7CiAgICB3cml0ZXIuZW5kKCdhJyk7CiAgICByYXcgPSByYXcuc3Vic3RyaW5nKGkgKyBtYXRjaFswXS5sZW5ndGgpOwogIH0KICB3cml0ZXIuY2hhcnMocmF3KTsKICByZXR1cm4gbmV3IEhUTUwoaHRtbC5qb2luKCcnKSk7Cn07Cid1c2Ugc3RyaWN0JzsKCi8qKgogKiBAd29ya0luUHJvZ3Jlc3MKICogQG5nZG9jIG92ZXJ2aWV3CiAqIEBuYW1lIGFuZ3VsYXIuZm9ybWF0dGVyCiAqIEBkZXNjcmlwdGlvbgogKgogKiBGb3JtYXR0ZXJzIGFyZSB1c2VkIGZvciB0cmFuc2xhdGluZyBkYXRhIGZvcm1hdHMgYmV0d2VlbiB0aG9zZSB1c2VkIGZvciBkaXNwbGF5IGFuZCB0aG9zZSB1c2VkCiAqIGZvciBzdG9yYWdlLgogKgogKiBGb2xsb3dpbmcgaXMgdGhlIGxpc3Qgb2YgYnVpbHQtaW4gYW5ndWxhciBmb3JtYXR0ZXJzOgogKgogKiAqIHtAbGluayBhbmd1bGFyLmZvcm1hdHRlci5ib29sZWFuIGJvb2xlYW59IC0gRm9ybWF0cyB1c2VyIGlucHV0IGluIGJvb2xlYW4gZm9ybWF0CiAqICoge0BsaW5rIGFuZ3VsYXIuZm9ybWF0dGVyLmpzb24ganNvbn0gLSBGb3JtYXRzIHVzZXIgaW5wdXQgaW4gSlNPTiBmb3JtYXQKICogKiB7QGxpbmsgYW5ndWxhci5mb3JtYXR0ZXIubGlzdCBsaXN0fSAtIEZvcm1hdHMgdXNlciBpbnB1dCBzdHJpbmcgYXMgYW4gYXJyYXkKICogKiB7QGxpbmsgYW5ndWxhci5mb3JtYXR0ZXIubnVtYmVyIG51bWJlcn0gLSBGb3JtYXRzIHVzZXIgaW5wdXQgc3RyaW5ncyBhcyBhIG51bWJlcgogKiAqIHtAbGluayBhbmd1bGFyLmZvcm1hdHRlci50cmltIHRyaW19IC0gVHJpbXMgZXh0cmFzIHNwYWNlcyBmcm9tIGVuZCBvZiB1c2VyIGlucHV0CiAqCiAqIEZvciBtb3JlIGluZm9ybWF0aW9uIGFib3V0IGhvdyBhbmd1bGFyIGZvcm1hdHRlcnMgd29yaywgYW5kIGhvdyB0byBjcmVhdGUgeW91ciBvd24gZm9ybWF0dGVycywKICogc2VlIHtAbGluayBndWlkZS9kZXZfZ3VpZGUudGVtcGxhdGVzLmZvcm1hdHRlcnMgVW5kZXJzdGFuZGluZyBBbmd1bGFyIEZvcm1hdHRlcnN9IGluIHRoZSBhbmd1bGFyCiAqIERldmVsb3BlciBHdWlkZS4KICovCgpmdW5jdGlvbiBmb3JtYXR0ZXIoZm9ybWF0LCBwYXJzZSkge3JldHVybiB7J2Zvcm1hdCc6Zm9ybWF0LCAncGFyc2UnOnBhcnNlIHx8IGZvcm1hdH07fQpmdW5jdGlvbiB0b1N0cmluZyhvYmopIHsKICByZXR1cm4gKGlzRGVmaW5lZChvYmopICYmIG9iaiAhPT0gbnVsbCkgPyAiIiArIG9iaiA6IG9iajsKfQoKdmFyIE5VTUJFUiA9IC9eXHMqWy0rXT9cZCooXC5cZCopP1xzKiQvOwoKYW5ndWxhckZvcm1hdHRlci5ub29wID0gZm9ybWF0dGVyKGlkZW50aXR5LCBpZGVudGl0eSk7CgovKioKICogQHdvcmtJblByb2dyZXNzCiAqIEBuZ2RvYyBmb3JtYXR0ZXIKICogQG5hbWUgYW5ndWxhci5mb3JtYXR0ZXIuanNvbgogKgogKiBAZGVzY3JpcHRpb24KICogICBGb3JtYXRzIHRoZSB1c2VyIGlucHV0IGFzIEpTT04gdGV4dC4KICoKICogQHJldHVybnMgez9zdHJpbmd9IEEgSlNPTiBzdHJpbmcgcmVwcmVzZW50YXRpb24gb2YgdGhlIG1vZGVsLgogKgogKiBAZXhhbXBsZQogICA8ZG9jOmV4YW1wbGU+CiAgICAgPGRvYzpzb3VyY2U+CiAgICAgIDxkaXYgbmc6aW5pdD0iZGF0YT17bmFtZTonbWlza28nLCBwcm9qZWN0Oidhbmd1bGFyJ30iPgogICAgICAgIDxpbnB1dCB0eXBlPSJ0ZXh0IiBzaXplPSc1MCcgbmFtZT0iZGF0YSIgbmc6Zm9ybWF0PSJqc29uIi8+CiAgICAgICAgPHByZT5kYXRhPXt7ZGF0YX19PC9wcmU+CiAgICAgIDwvZGl2PgogICAgIDwvZG9jOnNvdXJjZT4KICAgICA8ZG9jOnNjZW5hcmlvPgogICAgICBpdCgnc2hvdWxkIGZvcm1hdCBqc29uJywgZnVuY3Rpb24oKXsKICAgICAgICBleHBlY3QoYmluZGluZygnZGF0YScpKS50b0VxdWFsKCdkYXRhPXtcbiAgXCJuYW1lXCI6XCJtaXNrb1wiLFxuICBcInByb2plY3RcIjpcImFuZ3VsYXJcIn0nKTsKICAgICAgICBpbnB1dCgnZGF0YScpLmVudGVyKCd7fScpOwogICAgICAgIGV4cGVjdChiaW5kaW5nKCdkYXRhJykpLnRvRXF1YWwoJ2RhdGE9e1xuICB9Jyk7CiAgICAgIH0pOwogICAgIDwvZG9jOnNjZW5hcmlvPgogICA8L2RvYzpleGFtcGxlPgogKi8KYW5ndWxhckZvcm1hdHRlci5qc29uID0gZm9ybWF0dGVyKHRvSnNvbiwgZnVuY3Rpb24odmFsdWUpewogIHJldHVybiBmcm9tSnNvbih2YWx1ZSB8fCAnbnVsbCcpOwp9KTsKCi8qKgogKiBAd29ya0luUHJvZ3Jlc3MKICogQG5nZG9jIGZvcm1hdHRlcgogKiBAbmFtZSBhbmd1bGFyLmZvcm1hdHRlci5ib29sZWFuCiAqCiAqIEBkZXNjcmlwdGlvbgogKiAgIFVzZSBib29sZWFuIGZvcm1hdHRlciBpZiB5b3Ugd2lzaCB0byBzdG9yZSB0aGUgZGF0YSBhcyBib29sZWFuLgogKgogKiBAcmV0dXJucyB7Ym9vbGVhbn0gQ29udmVydHMgdG8gYHRydWVgIHVubGVzcyB1c2VyIGVudGVycyAoYmxhbmspLCBgZmAsIGBmYWxzZWAsIGAwYCwgYG5vYCwgYFtdYC4KICoKICogQGV4YW1wbGUKICAgPGRvYzpleGFtcGxlPgogICAgIDxkb2M6c291cmNlPgogICAgICAgIEVudGVyIHRydXRoeSB0ZXh0OgogICAgICAgIDxpbnB1dCB0eXBlPSJ0ZXh0IiBuYW1lPSJ2YWx1ZSIgbmc6Zm9ybWF0PSJib29sZWFuIiB2YWx1ZT0ibm8iLz4KICAgICAgICA8aW5wdXQgdHlwZT0iY2hlY2tib3giIG5hbWU9InZhbHVlIi8+CiAgICAgICAgPHByZT52YWx1ZT17e3ZhbHVlfX08L3ByZT4KICAgICA8L2RvYzpzb3VyY2U+CiAgICAgPGRvYzpzY2VuYXJpbz4KICAgICAgICBpdCgnc2hvdWxkIGZvcm1hdCBib29sZWFuJywgZnVuY3Rpb24oKXsKICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCd2YWx1ZScpKS50b0VxdWFsKCd2YWx1ZT1mYWxzZScpOwogICAgICAgICAgaW5wdXQoJ3ZhbHVlJykuZW50ZXIoJ3RydXRoeScpOwogICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3ZhbHVlJykpLnRvRXF1YWwoJ3ZhbHVlPXRydWUnKTsKICAgICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgPC9kb2M6ZXhhbXBsZT4KICovCmFuZ3VsYXJGb3JtYXR0ZXJbJ2Jvb2xlYW4nXSA9IGZvcm1hdHRlcih0b1N0cmluZywgdG9Cb29sZWFuKTsKCi8qKgogKiBAd29ya0luUHJvZ3Jlc3MKICogQG5nZG9jIGZvcm1hdHRlcgogKiBAbmFtZSBhbmd1bGFyLmZvcm1hdHRlci5udW1iZXIKICoKICogQGRlc2NyaXB0aW9uCiAqIFVzZSBudW1iZXIgZm9ybWF0dGVyIGlmIHlvdSB3aXNoIHRvIGNvbnZlcnQgdGhlIHVzZXIgZW50ZXJlZCBzdHJpbmcgdG8gYSBudW1iZXIuCiAqCiAqIEByZXR1cm5zIHtudW1iZXJ9IE51bWJlciBmcm9tIHRoZSBwYXJzZWQgc3RyaW5nLgogKgogKiBAZXhhbXBsZQogICA8ZG9jOmV4YW1wbGU+CiAgICAgPGRvYzpzb3VyY2U+CiAgICAgIEVudGVyIHZhbGlkIG51bWJlcjoKICAgICAgPGlucHV0IHR5cGU9InRleHQiIG5hbWU9InZhbHVlIiBuZzpmb3JtYXQ9Im51bWJlciIgdmFsdWU9IjEyMzQiLz4KICAgICAgPHByZT52YWx1ZT17e3ZhbHVlfX08L3ByZT4KICAgICA8L2RvYzpzb3VyY2U+CiAgICAgPGRvYzpzY2VuYXJpbz4KICAgICAgaXQoJ3Nob3VsZCBmb3JtYXQgbnVtYmVycycsIGZ1bmN0aW9uKCl7CiAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3ZhbHVlJykpLnRvRXF1YWwoJ3ZhbHVlPTEyMzQnKTsKICAgICAgICBpbnB1dCgndmFsdWUnKS5lbnRlcignNTY3OCcpOwogICAgICAgIGV4cGVjdChiaW5kaW5nKCd2YWx1ZScpKS50b0VxdWFsKCd2YWx1ZT01Njc4Jyk7CiAgICAgIH0pOwogICAgIDwvZG9jOnNjZW5hcmlvPgogICA8L2RvYzpleGFtcGxlPgogKi8KYW5ndWxhckZvcm1hdHRlci5udW1iZXIgPSBmb3JtYXR0ZXIodG9TdHJpbmcsIGZ1bmN0aW9uKG9iail7CiAgaWYgKG9iaiA9PSBudWxsIHx8IE5VTUJFUi5leGVjKG9iaikpIHsKICAgIHJldHVybiBvYmo9PT1udWxsIHx8IG9iaiA9PT0gJycgPyBudWxsIDogMSpvYmo7CiAgfSBlbHNlIHsKICAgIHRocm93ICJOb3QgYSBudW1iZXIiOwogIH0KfSk7CgovKioKICogQHdvcmtJblByb2dyZXNzCiAqIEBuZ2RvYyBmb3JtYXR0ZXIKICogQG5hbWUgYW5ndWxhci5mb3JtYXR0ZXIubGlzdAogKgogKiBAZGVzY3JpcHRpb24KICogVXNlIGxpc3QgZm9ybWF0dGVyIGlmIHlvdSB3aXNoIHRvIGNvbnZlcnQgdGhlIHVzZXIgZW50ZXJlZCBzdHJpbmcgdG8gYW4gYXJyYXkuCiAqCiAqIEByZXR1cm5zIHtBcnJheX0gQXJyYXkgcGFyc2VkIGZyb20gdGhlIGVudGVyZWQgc3RyaW5nLgogKgogKiBAZXhhbXBsZQogICA8ZG9jOmV4YW1wbGU+CiAgICAgPGRvYzpzb3VyY2U+CiAgICAgICAgRW50ZXIgYSBsaXN0IG9mIGl0ZW1zOgogICAgICAgIDxpbnB1dCB0eXBlPSJ0ZXh0IiBuYW1lPSJ2YWx1ZSIgbmc6Zm9ybWF0PSJsaXN0IiB2YWx1ZT0iIGNoYWlyICwsIHRhYmxlIi8+CiAgICAgICAgPGlucHV0IHR5cGU9InRleHQiIG5hbWU9InZhbHVlIiBuZzpmb3JtYXQ9Imxpc3QiLz4KICAgICAgICA8cHJlPnZhbHVlPXt7dmFsdWV9fTwvcHJlPgogICAgIDwvZG9jOnNvdXJjZT4KICAgICA8ZG9jOnNjZW5hcmlvPgogICAgICBpdCgnc2hvdWxkIGZvcm1hdCBsaXN0cycsIGZ1bmN0aW9uKCl7CiAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3ZhbHVlJykpLnRvRXF1YWwoJ3ZhbHVlPVsiY2hhaXIiLCJ0YWJsZSJdJyk7CiAgICAgICAgdGhpcy5hZGRGdXR1cmVBY3Rpb24oJ2NoYW5nZSB0byBYWVonLCBmdW5jdGlvbigkd2luZG93LCAkZG9jdW1lbnQsIGRvbmUpewogICAgICAgICAgJGRvY3VtZW50LmVsZW1lbnRzKCcuZG9jLWV4YW1wbGUtbGl2ZSA6aW5wdXQ6bGFzdCcpLnZhbCgnLCxhLGIsJykudHJpZ2dlcignY2hhbmdlJyk7CiAgICAgICAgICBkb25lKCk7CiAgICAgICAgfSk7CiAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3ZhbHVlJykpLnRvRXF1YWwoJ3ZhbHVlPVsiYSIsImIiXScpOwogICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgPC9kb2M6ZXhhbXBsZT4KICovCmFuZ3VsYXJGb3JtYXR0ZXIubGlzdCA9IGZvcm1hdHRlcigKICBmdW5jdGlvbihvYmopIHsgcmV0dXJuIG9iaiA/IG9iai5qb2luKCIsICIpIDogb2JqOyB9LAogIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICB2YXIgbGlzdCA9IFtdOwogICAgZm9yRWFjaCgodmFsdWUgfHwgJycpLnNwbGl0KCcsJyksIGZ1bmN0aW9uKGl0ZW0pewogICAgICBpdGVtID0gdHJpbShpdGVtKTsKICAgICAgaWYgKGl0ZW0pIGxpc3QucHVzaChpdGVtKTsKICAgIH0pOwogICAgcmV0dXJuIGxpc3Q7CiAgfQopOwoKLyoqCiAqIEB3b3JrSW5Qcm9ncmVzcwogKiBAbmdkb2MgZm9ybWF0dGVyCiAqIEBuYW1lIGFuZ3VsYXIuZm9ybWF0dGVyLnRyaW0KICoKICogQGRlc2NyaXB0aW9uCiAqIFVzZSB0cmltIGZvcm1hdHRlciBpZiB5b3Ugd2lzaCB0byB0cmltIGV4dHJhIHNwYWNlcyBpbiB1c2VyIHRleHQuCiAqCiAqIEByZXR1cm5zIHtTdHJpbmd9IFRyaW0gZXhjZXNzIGxlYWRpbmcgYW5kIHRyYWlsaW5nIHNwYWNlLgogKgogKiBAZXhhbXBsZQogICA8ZG9jOmV4YW1wbGU+CiAgICAgPGRvYzpzb3VyY2U+CiAgICAgICAgRW50ZXIgdGV4dCB3aXRoIGxlYWRpbmcvdHJhaWxpbmcgc3BhY2VzOgogICAgICAgIDxpbnB1dCB0eXBlPSJ0ZXh0IiBuYW1lPSJ2YWx1ZSIgbmc6Zm9ybWF0PSJ0cmltIiB2YWx1ZT0iICBib29rICAiLz4KICAgICAgICA8aW5wdXQgdHlwZT0idGV4dCIgbmFtZT0idmFsdWUiIG5nOmZvcm1hdD0idHJpbSIvPgogICAgICAgIDxwcmU+dmFsdWU9e3t2YWx1ZXxqc29ufX08L3ByZT4KICAgICA8L2RvYzpzb3VyY2U+CiAgICAgPGRvYzpzY2VuYXJpbz4KICAgICAgICBpdCgnc2hvdWxkIGZvcm1hdCB0cmltJywgZnVuY3Rpb24oKXsKICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCd2YWx1ZScpKS50b0VxdWFsKCd2YWx1ZT0iYm9vayInKTsKICAgICAgICAgIHRoaXMuYWRkRnV0dXJlQWN0aW9uKCdjaGFuZ2UgdG8gWFlaJywgZnVuY3Rpb24oJHdpbmRvdywgJGRvY3VtZW50LCBkb25lKXsKICAgICAgICAgICAgJGRvY3VtZW50LmVsZW1lbnRzKCcuZG9jLWV4YW1wbGUtbGl2ZSA6aW5wdXQ6bGFzdCcpLnZhbCgnICB0ZXh0ICAnKS50cmlnZ2VyKCdjaGFuZ2UnKTsKICAgICAgICAgICAgZG9uZSgpOwogICAgICAgICAgfSk7CiAgICAgICAgICBleHBlY3QoYmluZGluZygndmFsdWUnKSkudG9FcXVhbCgndmFsdWU9InRleHQiJyk7CiAgICAgICAgfSk7CiAgICAgPC9kb2M6c2NlbmFyaW8+CiAgIDwvZG9jOmV4YW1wbGU+CiAqLwphbmd1bGFyRm9ybWF0dGVyLnRyaW0gPSBmb3JtYXR0ZXIoCiAgZnVuY3Rpb24ob2JqKSB7IHJldHVybiBvYmogPyB0cmltKCIiICsgb2JqKSA6ICIiOyB9Cik7Cid1c2Ugc3RyaWN0JzsKCi8qKgogKiBAd29ya0luUHJvZ3Jlc3MKICogQG5nZG9jIG92ZXJ2aWV3CiAqIEBuYW1lIGFuZ3VsYXIudmFsaWRhdG9yCiAqIEBkZXNjcmlwdGlvbgogKgogKiBNb3N0IG9mIHRoZSBidWlsdC1pbiBhbmd1bGFyIHZhbGlkYXRvcnMgYXJlIHVzZWQgdG8gY2hlY2sgdXNlciBpbnB1dCBhZ2FpbnN0IGRlZmluZWQgdHlwZXMgb3IKICogcGF0dGVybnMuICBZb3UgY2FuIGVhc2lseSBjcmVhdGUgeW91ciBvd24gY3VzdG9tIHZhbGlkYXRvcnMgYXMgd2VsbC4KICoKICogRm9sbG93aW5nIGlzIHRoZSBsaXN0IG9mIGJ1aWx0LWluIGFuZ3VsYXIgdmFsaWRhdG9yczoKICoKICogKiB7QGxpbmsgYW5ndWxhci52YWxpZGF0b3IuYXN5bmNocm9ub3VzIGFzeW5jaHJvbm91cygpfSAtIFByb3ZpZGVzIGFzeW5jaHJvbm91cyB2YWxpZGF0aW9uIHZpYSBhCiAqIGNhbGxiYWNrIGZ1bmN0aW9uLgogKiAqIHtAbGluayBhbmd1bGFyLnZhbGlkYXRvci5kYXRlIGRhdGUoKX0gLSBDaGVja3MgdXNlciBpbnB1dCBhZ2FpbnN0IGRlZmF1bHQgZGF0ZSBmb3JtYXQ6CiAqICJNTS9ERC9ZWVlZIgogKiAqIHtAbGluayBhbmd1bGFyLnZhbGlkYXRvci5lbWFpbCBlbWFpbCgpfSAtIFZhbGlkYXRlcyB0aGF0IHVzZXIgaW5wdXQgaXMgYSB3ZWxsLWZvcm1lZCBlbWFpbAogKiBhZGRyZXNzLgogKiAqIHtAbGluayBhbmd1bGFyLnZhbGlkYXRvci5pbnRlZ2VyIGludGVnZXIoKX0gLSBWYWxpZGF0ZXMgdGhhdCB1c2VyIGlucHV0IGlzIGFuIGludGVnZXIKICogKiB7QGxpbmsgYW5ndWxhci52YWxpZGF0b3IuanNvbiBqc29uKCl9IC0gVmFsaWRhdGVzIHRoYXQgdXNlciBpbnB1dCBpcyB2YWxpZCBKU09OCiAqICoge0BsaW5rIGFuZ3VsYXIudmFsaWRhdG9yLm51bWJlciBudW1iZXIoKX0gLSBWYWxpZGF0ZXMgdGhhdCB1c2VyIGlucHV0IGlzIGEgbnVtYmVyCiAqICoge0BsaW5rIGFuZ3VsYXIudmFsaWRhdG9yLnBob25lIHBob25lKCl9IC0gVmFsaWRhdGVzIHRoYXQgdXNlciBpbnB1dCBtYXRjaGVzIHRoZSBwYXR0ZXJuCiAqICIxKDEyMykxMjMtMTIzNCIKICogKiB7QGxpbmsgYW5ndWxhci52YWxpZGF0b3IucmVnZXhwIHJlZ2V4cCgpfSAtIFJlc3RyaWN0cyB2YWxpZCBpbnB1dCB0byBhIHNwZWNpZmllZCByZWd1bGFyCiAqIGV4cHJlc3Npb24gcGF0dGVybgogKiAqIHtAbGluayBhbmd1bGFyLnZhbGlkYXRvci51cmwgdXJsKCl9IC0gVmFsaWRhdGVzIHRoYXQgdXNlciBpbnB1dCBpcyBhIHdlbGwtZm9ybWVkIFVSTC4KICoKICogRm9yIG1vcmUgaW5mb3JtYXRpb24gYWJvdXQgaG93IGFuZ3VsYXIgdmFsaWRhdG9ycyB3b3JrLCBhbmQgaG93IHRvIGNyZWF0ZSB5b3VyIG93biB2YWxpZGF0b3JzLAogKiBzZWUge0BsaW5rIGd1aWRlL2Rldl9ndWlkZS50ZW1wbGF0ZXMudmFsaWRhdG9ycyBVbmRlcnN0YW5kaW5nIEFuZ3VsYXIgVmFsaWRhdG9yc30gaW4gdGhlIGFuZ3VsYXIKICogRGV2ZWxvcGVyIEd1aWRlLgogKi8KCmV4dGVuZChhbmd1bGFyVmFsaWRhdG9yLCB7CiAgJ25vb3AnOiBmdW5jdGlvbigpIHsgcmV0dXJuIG51bGw7IH0sCgogIC8qKgogICAqIEB3b3JrSW5Qcm9ncmVzcwogICAqIEBuZ2RvYyB2YWxpZGF0b3IKICAgKiBAbmFtZSBhbmd1bGFyLnZhbGlkYXRvci5yZWdleHAKICAgKiBAZGVzY3JpcHRpb24KICAgKiBVc2UgcmVnZXhwIHZhbGlkYXRvciB0byByZXN0cmljdCB0aGUgaW5wdXQgdG8gYW55IFJlZ3VsYXIgRXhwcmVzc2lvbi4KICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfSB2YWx1ZSB2YWx1ZSB0byB2YWxpZGF0ZQogICAqIEBwYXJhbSB7c3RyaW5nfHJlZ2V4cH0gZXhwcmVzc2lvbiByZWd1bGFyIGV4cHJlc3Npb24uCiAgICogQHBhcmFtIHtzdHJpbmc9fSBtc2cgZXJyb3IgbWVzc2FnZSB0byBkaXNwbGF5LgogICAqIEBjc3MgbmctdmFsaWRhdGlvbi1lcnJvcgogICAqCiAgICogQGV4YW1wbGUKICAgIDxkb2M6ZXhhbXBsZT4KICAgICAgPGRvYzpzb3VyY2U+CiAgICAgICAgPHNjcmlwdD4gZnVuY3Rpb24gQ250bCgpewogICAgICAgICB0aGlzLnNzblJlZ0V4cCA9IC9eXGRcZFxkLVxkXGQtXGRcZFxkXGQkLzsKICAgICAgICB9CiAgICAgICAgPC9zY3JpcHQ+CiAgICAgICAgRW50ZXIgdmFsaWQgU1NOOgogICAgICAgIDxkaXYgbmc6Y29udHJvbGxlcj0iQ250bCI+CiAgICAgICAgPGlucHV0IG5hbWU9InNzbiIgdmFsdWU9IjEyMy00NS02Nzg5IiBuZzp2YWxpZGF0ZT0icmVnZXhwOnNzblJlZ0V4cCIgPgogICAgICAgIDwvZGl2PgogICAgICA8L2RvYzpzb3VyY2U+CiAgICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgICAgaXQoJ3Nob3VsZCBpbnZhbGlkYXRlIG5vbiBzc24nLCBmdW5jdGlvbigpewogICAgICAgICB2YXIgdGV4dEJveCA9IGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIDppbnB1dCcpOwogICAgICAgICBleHBlY3QodGV4dEJveC5hdHRyKCdjbGFzc05hbWUnKSkubm90KCkudG9NYXRjaCgvbmctdmFsaWRhdGlvbi1lcnJvci8pOwogICAgICAgICBleHBlY3QodGV4dEJveC52YWwoKSkudG9FcXVhbCgnMTIzLTQ1LTY3ODknKTsKICAgICAgICAgaW5wdXQoJ3NzbicpLmVudGVyKCcxMjMtNDUtNjc4OTAnKTsKICAgICAgICAgZXhwZWN0KHRleHRCb3guYXR0cignY2xhc3NOYW1lJykpLnRvTWF0Y2goL25nLXZhbGlkYXRpb24tZXJyb3IvKTsKICAgICAgICB9KTsKICAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICA8L2RvYzpleGFtcGxlPgogICAqCiAgICovCiAgJ3JlZ2V4cCc6IGZ1bmN0aW9uKHZhbHVlLCByZWdleHAsIG1zZykgewogICAgaWYgKCF2YWx1ZS5tYXRjaChyZWdleHApKSB7CiAgICAgIHJldHVybiBtc2cgfHwKICAgICAgICAiVmFsdWUgZG9lcyBub3QgbWF0Y2ggZXhwZWN0ZWQgZm9ybWF0ICIgKyByZWdleHAgKyAiLiI7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KICB9LAoKICAvKioKICAgKiBAd29ya0luUHJvZ3Jlc3MKICAgKiBAbmdkb2MgdmFsaWRhdG9yCiAgICogQG5hbWUgYW5ndWxhci52YWxpZGF0b3IubnVtYmVyCiAgICogQGRlc2NyaXB0aW9uCiAgICogVXNlIG51bWJlciB2YWxpZGF0b3IgdG8gcmVzdHJpY3QgdGhlIGlucHV0IHRvIG51bWJlcnMgd2l0aCBhbgogICAqIG9wdGlvbmFsIHJhbmdlLiAoU2VlIGludGVnZXIgZm9yIHdob2xlIG51bWJlcnMgdmFsaWRhdG9yKS4KICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfSB2YWx1ZSB2YWx1ZSB0byB2YWxpZGF0ZQogICAqIEBwYXJhbSB7aW50PX0gW21pbj1NSU5fSU5UXSBtaW5pbXVtIHZhbHVlLgogICAqIEBwYXJhbSB7aW50PX0gW21heD1NQVhfSU5UXSBtYXhpbXVtIHZhbHVlLgogICAqIEBjc3MgbmctdmFsaWRhdGlvbi1lcnJvcgogICAqCiAgICogQGV4YW1wbGUKICAgIDxkb2M6ZXhhbXBsZT4KICAgICAgPGRvYzpzb3VyY2U+CiAgICAgICAgRW50ZXIgbnVtYmVyOiA8aW5wdXQgbmFtZT0ibjEiIG5nOnZhbGlkYXRlPSJudW1iZXIiID4gPGJyPgogICAgICAgIEVudGVyIG51bWJlciBncmVhdGVyIHRoYW4gMTA6IDxpbnB1dCBuYW1lPSJuMiIgbmc6dmFsaWRhdGU9Im51bWJlcjoxMCIgPiA8YnI+CiAgICAgICAgRW50ZXIgbnVtYmVyIGJldHdlZW4gMTAwIGFuZCAyMDA6IDxpbnB1dCBuYW1lPSJuMyIgbmc6dmFsaWRhdGU9Im51bWJlcjoxMDA6MjAwIiA+IDxicj4KICAgICAgPC9kb2M6c291cmNlPgogICAgICA8ZG9jOnNjZW5hcmlvPgogICAgICAgIGl0KCdzaG91bGQgaW52YWxpZGF0ZSBudW1iZXInLCBmdW5jdGlvbigpewogICAgICAgICB2YXIgbjEgPSBlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSA6aW5wdXRbbmFtZT1uMV0nKTsKICAgICAgICAgZXhwZWN0KG4xLmF0dHIoJ2NsYXNzTmFtZScpKS5ub3QoKS50b01hdGNoKC9uZy12YWxpZGF0aW9uLWVycm9yLyk7CiAgICAgICAgIGlucHV0KCduMScpLmVudGVyKCcxLngnKTsKICAgICAgICAgZXhwZWN0KG4xLmF0dHIoJ2NsYXNzTmFtZScpKS50b01hdGNoKC9uZy12YWxpZGF0aW9uLWVycm9yLyk7CiAgICAgICAgIHZhciBuMiA9IGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIDppbnB1dFtuYW1lPW4yXScpOwogICAgICAgICBleHBlY3QobjIuYXR0cignY2xhc3NOYW1lJykpLm5vdCgpLnRvTWF0Y2goL25nLXZhbGlkYXRpb24tZXJyb3IvKTsKICAgICAgICAgaW5wdXQoJ24yJykuZW50ZXIoJzknKTsKICAgICAgICAgZXhwZWN0KG4yLmF0dHIoJ2NsYXNzTmFtZScpKS50b01hdGNoKC9uZy12YWxpZGF0aW9uLWVycm9yLyk7CiAgICAgICAgIHZhciBuMyA9IGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIDppbnB1dFtuYW1lPW4zXScpOwogICAgICAgICBleHBlY3QobjMuYXR0cignY2xhc3NOYW1lJykpLm5vdCgpLnRvTWF0Y2goL25nLXZhbGlkYXRpb24tZXJyb3IvKTsKICAgICAgICAgaW5wdXQoJ24zJykuZW50ZXIoJzIwMScpOwogICAgICAgICBleHBlY3QobjMuYXR0cignY2xhc3NOYW1lJykpLnRvTWF0Y2goL25nLXZhbGlkYXRpb24tZXJyb3IvKTsKICAgICAgICB9KTsKICAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICA8L2RvYzpleGFtcGxlPgogICAqCiAgICovCiAgJ251bWJlcic6IGZ1bmN0aW9uKHZhbHVlLCBtaW4sIG1heCkgewogICAgdmFyIG51bSA9IDEgKiB2YWx1ZTsKICAgIGlmIChudW0gPT0gdmFsdWUpIHsKICAgICAgaWYgKHR5cGVvZiBtaW4gIT0gJHVuZGVmaW5lZCAmJiBudW0gPCBtaW4pIHsKICAgICAgICByZXR1cm4gIlZhbHVlIGNhbiBub3QgYmUgbGVzcyB0aGFuICIgKyBtaW4gKyAiLiI7CiAgICAgIH0KICAgICAgaWYgKHR5cGVvZiBtaW4gIT0gJHVuZGVmaW5lZCAmJiBudW0gPiBtYXgpIHsKICAgICAgICByZXR1cm4gIlZhbHVlIGNhbiBub3QgYmUgZ3JlYXRlciB0aGFuICIgKyBtYXggKyAiLiI7CiAgICAgIH0KICAgICAgcmV0dXJuIG51bGw7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gIk5vdCBhIG51bWJlciI7CiAgICB9CiAgfSwKCiAgLyoqCiAgICogQHdvcmtJblByb2dyZXNzCiAgICogQG5nZG9jIHZhbGlkYXRvcgogICAqIEBuYW1lIGFuZ3VsYXIudmFsaWRhdG9yLmludGVnZXIKICAgKiBAZGVzY3JpcHRpb24KICAgKiBVc2UgbnVtYmVyIHZhbGlkYXRvciB0byByZXN0cmljdCB0aGUgaW5wdXQgdG8gaW50ZWdlcnMgd2l0aCBhbgogICAqIG9wdGlvbmFsIHJhbmdlLiAoU2VlIGludGVnZXIgZm9yIHdob2xlIG51bWJlcnMgdmFsaWRhdG9yKS4KICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfSB2YWx1ZSB2YWx1ZSB0byB2YWxpZGF0ZQogICAqIEBwYXJhbSB7aW50PX0gW21pbj1NSU5fSU5UXSBtaW5pbXVtIHZhbHVlLgogICAqIEBwYXJhbSB7aW50PX0gW21heD1NQVhfSU5UXSBtYXhpbXVtIHZhbHVlLgogICAqIEBjc3MgbmctdmFsaWRhdGlvbi1lcnJvcgogICAqCiAgICogQGV4YW1wbGUKICAgIDxkb2M6ZXhhbXBsZT4KICAgICAgPGRvYzpzb3VyY2U+CiAgICAgICAgRW50ZXIgaW50ZWdlcjogPGlucHV0IG5hbWU9Im4xIiBuZzp2YWxpZGF0ZT0iaW50ZWdlciIgPiA8YnI+CiAgICAgICAgRW50ZXIgaW50ZWdlciBlcXVhbCBvciBncmVhdGVyIHRoYW4gMTA6IDxpbnB1dCBuYW1lPSJuMiIgbmc6dmFsaWRhdGU9ImludGVnZXI6MTAiID4gPGJyPgogICAgICAgIEVudGVyIGludGVnZXIgYmV0d2VlbiAxMDAgYW5kIDIwMCAoaW5jbHVzaXZlKTogPGlucHV0IG5hbWU9Im4zIiBuZzp2YWxpZGF0ZT0iaW50ZWdlcjoxMDA6MjAwIiA+IDxicj4KICAgICAgPC9kb2M6c291cmNlPgogICAgICA8ZG9jOnNjZW5hcmlvPgogICAgICAgIGl0KCdzaG91bGQgaW52YWxpZGF0ZSBpbnRlZ2VyJywgZnVuY3Rpb24oKXsKICAgICAgICAgdmFyIG4xID0gZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgOmlucHV0W25hbWU9bjFdJyk7CiAgICAgICAgIGV4cGVjdChuMS5hdHRyKCdjbGFzc05hbWUnKSkubm90KCkudG9NYXRjaCgvbmctdmFsaWRhdGlvbi1lcnJvci8pOwogICAgICAgICBpbnB1dCgnbjEnKS5lbnRlcignMS4xJyk7CiAgICAgICAgIGV4cGVjdChuMS5hdHRyKCdjbGFzc05hbWUnKSkudG9NYXRjaCgvbmctdmFsaWRhdGlvbi1lcnJvci8pOwogICAgICAgICB2YXIgbjIgPSBlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSA6aW5wdXRbbmFtZT1uMl0nKTsKICAgICAgICAgZXhwZWN0KG4yLmF0dHIoJ2NsYXNzTmFtZScpKS5ub3QoKS50b01hdGNoKC9uZy12YWxpZGF0aW9uLWVycm9yLyk7CiAgICAgICAgIGlucHV0KCduMicpLmVudGVyKCcxMC4xJyk7CiAgICAgICAgIGV4cGVjdChuMi5hdHRyKCdjbGFzc05hbWUnKSkudG9NYXRjaCgvbmctdmFsaWRhdGlvbi1lcnJvci8pOwogICAgICAgICB2YXIgbjMgPSBlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSA6aW5wdXRbbmFtZT1uM10nKTsKICAgICAgICAgZXhwZWN0KG4zLmF0dHIoJ2NsYXNzTmFtZScpKS5ub3QoKS50b01hdGNoKC9uZy12YWxpZGF0aW9uLWVycm9yLyk7CiAgICAgICAgIGlucHV0KCduMycpLmVudGVyKCcxMDAuMScpOwogICAgICAgICBleHBlY3QobjMuYXR0cignY2xhc3NOYW1lJykpLnRvTWF0Y2goL25nLXZhbGlkYXRpb24tZXJyb3IvKTsKICAgICAgICB9KTsKICAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICA8L2RvYzpleGFtcGxlPgogICAqLwogICdpbnRlZ2VyJzogZnVuY3Rpb24odmFsdWUsIG1pbiwgbWF4KSB7CiAgICB2YXIgbnVtYmVyRXJyb3IgPSBhbmd1bGFyVmFsaWRhdG9yWydudW1iZXInXSh2YWx1ZSwgbWluLCBtYXgpOwogICAgaWYgKG51bWJlckVycm9yKSByZXR1cm4gbnVtYmVyRXJyb3I7CiAgICBpZiAoISgiIiArIHZhbHVlKS5tYXRjaCgvXlxzKltcZCtdKlxzKiQvKSB8fCB2YWx1ZSAhPSBNYXRoLnJvdW5kKHZhbHVlKSkgewogICAgICByZXR1cm4gIk5vdCBhIHdob2xlIG51bWJlciI7CiAgICB9CiAgICByZXR1cm4gbnVsbDsKICB9LAoKICAvKioKICAgKiBAd29ya0luUHJvZ3Jlc3MKICAgKiBAbmdkb2MgdmFsaWRhdG9yCiAgICogQG5hbWUgYW5ndWxhci52YWxpZGF0b3IuZGF0ZQogICAqIEBkZXNjcmlwdGlvbgogICAqIFVzZSBkYXRlIHZhbGlkYXRvciB0byByZXN0cmljdCB0aGUgdXNlciBpbnB1dCB0byBhIHZhbGlkIGRhdGUKICAgKiBpbiBmb3JtYXQgaW4gZm9ybWF0IE1NL0REL1lZWVkuCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gdmFsdWUgdmFsdWUgdG8gdmFsaWRhdGUKICAgKiBAY3NzIG5nLXZhbGlkYXRpb24tZXJyb3IKICAgKgogICAqIEBleGFtcGxlCiAgICA8ZG9jOmV4YW1wbGU+CiAgICAgIDxkb2M6c291cmNlPgogICAgICAgIEVudGVyIHZhbGlkIGRhdGU6CiAgICAgICAgPGlucHV0IG5hbWU9InRleHQiIHZhbHVlPSIxLzEvMjAwOSIgbmc6dmFsaWRhdGU9ImRhdGUiID4KICAgICAgPC9kb2M6c291cmNlPgogICAgICA8ZG9jOnNjZW5hcmlvPgogICAgICAgIGl0KCdzaG91bGQgaW52YWxpZGF0ZSBkYXRlJywgZnVuY3Rpb24oKXsKICAgICAgICAgdmFyIG4xID0gZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgOmlucHV0Jyk7CiAgICAgICAgIGV4cGVjdChuMS5hdHRyKCdjbGFzc05hbWUnKSkubm90KCkudG9NYXRjaCgvbmctdmFsaWRhdGlvbi1lcnJvci8pOwogICAgICAgICBpbnB1dCgndGV4dCcpLmVudGVyKCcxMjMvMTIzLzEyMycpOwogICAgICAgICBleHBlY3QobjEuYXR0cignY2xhc3NOYW1lJykpLnRvTWF0Y2goL25nLXZhbGlkYXRpb24tZXJyb3IvKTsKICAgICAgICB9KTsKICAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICA8L2RvYzpleGFtcGxlPgogICAqCiAgICovCiAgJ2RhdGUnOiBmdW5jdGlvbih2YWx1ZSkgewogICAgdmFyIGZpZWxkcyA9IC9eKFxkXGQ/KVwvKFxkXGQ/KVwvKFxkXGRcZFxkKSQvLmV4ZWModmFsdWUpOwogICAgdmFyIGRhdGUgPSBmaWVsZHMgPyBuZXcgRGF0ZShmaWVsZHNbM10sIGZpZWxkc1sxXS0xLCBmaWVsZHNbMl0pIDogMDsKICAgIHJldHVybiAoZGF0ZSAmJgogICAgICAgICAgICBkYXRlLmdldEZ1bGxZZWFyKCkgPT0gZmllbGRzWzNdICYmCiAgICAgICAgICAgIGRhdGUuZ2V0TW9udGgoKSA9PSBmaWVsZHNbMV0tMSAmJgogICAgICAgICAgICBkYXRlLmdldERhdGUoKSA9PSBmaWVsZHNbMl0pCiAgICAgICAgICAgICAgPyBudWxsCiAgICAgICAgICAgICAgOiAiVmFsdWUgaXMgbm90IGEgZGF0ZS4gKEV4cGVjdGluZyBmb3JtYXQ6IDEyLzMxLzIwMDkpLiI7CiAgfSwKCiAgLyoqCiAgICogQHdvcmtJblByb2dyZXNzCiAgICogQG5nZG9jIHZhbGlkYXRvcgogICAqIEBuYW1lIGFuZ3VsYXIudmFsaWRhdG9yLmVtYWlsCiAgICogQGRlc2NyaXB0aW9uCiAgICogVXNlIGVtYWlsIHZhbGlkYXRvciBpZiB5b3Ugd2lzdCB0byByZXN0cmljdCB0aGUgdXNlciBpbnB1dCB0byBhIHZhbGlkIGVtYWlsLgogICAqCiAgICogQHBhcmFtIHtzdHJpbmd9IHZhbHVlIHZhbHVlIHRvIHZhbGlkYXRlCiAgICogQGNzcyBuZy12YWxpZGF0aW9uLWVycm9yCiAgICoKICAgKiBAZXhhbXBsZQogICAgPGRvYzpleGFtcGxlPgogICAgICA8ZG9jOnNvdXJjZT4KICAgICAgICBFbnRlciB2YWxpZCBlbWFpbDoKICAgICAgICA8aW5wdXQgbmFtZT0idGV4dCIgbmc6dmFsaWRhdGU9ImVtYWlsIiB2YWx1ZT0ibWVAZXhhbXBsZS5jb20iPgogICAgICA8L2RvYzpzb3VyY2U+CiAgICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgICAgaXQoJ3Nob3VsZCBpbnZhbGlkYXRlIGVtYWlsJywgZnVuY3Rpb24oKXsKICAgICAgICAgdmFyIG4xID0gZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgOmlucHV0Jyk7CiAgICAgICAgIGV4cGVjdChuMS5hdHRyKCdjbGFzc05hbWUnKSkubm90KCkudG9NYXRjaCgvbmctdmFsaWRhdGlvbi1lcnJvci8pOwogICAgICAgICBpbnB1dCgndGV4dCcpLmVudGVyKCdhQGIuYycpOwogICAgICAgICBleHBlY3QobjEuYXR0cignY2xhc3NOYW1lJykpLnRvTWF0Y2goL25nLXZhbGlkYXRpb24tZXJyb3IvKTsKICAgICAgICB9KTsKICAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICA8L2RvYzpleGFtcGxlPgogICAqCiAgICovCiAgJ2VtYWlsJzogZnVuY3Rpb24odmFsdWUpIHsKICAgIGlmICh2YWx1ZS5tYXRjaCgvXltBLVphLXowLTkuXyUrLV0rQFtBLVphLXowLTkuLV0rXC5bQS1aYS16XXsyLDR9JC8pKSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfQogICAgcmV0dXJuICJFbWFpbCBuZWVkcyB0byBiZSBpbiB1c2VybmFtZUBob3N0LmNvbSBmb3JtYXQuIjsKICB9LAoKICAvKioKICAgKiBAd29ya0luUHJvZ3Jlc3MKICAgKiBAbmdkb2MgdmFsaWRhdG9yCiAgICogQG5hbWUgYW5ndWxhci52YWxpZGF0b3IucGhvbmUKICAgKiBAZGVzY3JpcHRpb24KICAgKiBVc2UgcGhvbmUgdmFsaWRhdG9yIHRvIHJlc3RyaWN0IHRoZSBpbnB1dCBwaG9uZSBudW1iZXJzLgogICAqCiAgICogQHBhcmFtIHtzdHJpbmd9IHZhbHVlIHZhbHVlIHRvIHZhbGlkYXRlCiAgICogQGNzcyBuZy12YWxpZGF0aW9uLWVycm9yCiAgICoKICAgKiBAZXhhbXBsZQogICAgPGRvYzpleGFtcGxlPgogICAgICA8ZG9jOnNvdXJjZT4KICAgICAgICBFbnRlciB2YWxpZCBwaG9uZSBudW1iZXI6CiAgICAgICAgPGlucHV0IG5hbWU9InRleHQiIHZhbHVlPSIxKDIzNCk1NjctODkwMSIgbmc6dmFsaWRhdGU9InBob25lIiA+CiAgICAgIDwvZG9jOnNvdXJjZT4KICAgICAgPGRvYzpzY2VuYXJpbz4KICAgICAgICBpdCgnc2hvdWxkIGludmFsaWRhdGUgcGhvbmUnLCBmdW5jdGlvbigpewogICAgICAgICB2YXIgbjEgPSBlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSA6aW5wdXQnKTsKICAgICAgICAgZXhwZWN0KG4xLmF0dHIoJ2NsYXNzTmFtZScpKS5ub3QoKS50b01hdGNoKC9uZy12YWxpZGF0aW9uLWVycm9yLyk7CiAgICAgICAgIGlucHV0KCd0ZXh0JykuZW50ZXIoJysxMjM0NTY3OCcpOwogICAgICAgICBleHBlY3QobjEuYXR0cignY2xhc3NOYW1lJykpLnRvTWF0Y2goL25nLXZhbGlkYXRpb24tZXJyb3IvKTsKICAgICAgICB9KTsKICAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICA8L2RvYzpleGFtcGxlPgogICAqCiAgICovCiAgJ3Bob25lJzogZnVuY3Rpb24odmFsdWUpIHsKICAgIGlmICh2YWx1ZS5tYXRjaCgvXjFcKFxkXGRcZFwpXGRcZFxkLVxkXGRcZFxkJC8pKSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfQogICAgaWYgKHZhbHVlLm1hdGNoKC9eXCtcZHsyLDN9IChcKFxkezEsNX1cKSk/W1xkIF0rXGQkLykpIHsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CiAgICByZXR1cm4gIlBob25lIG51bWJlciBuZWVkcyB0byBiZSBpbiAxKDk4Nyk2NTQtMzIxMCBmb3JtYXQgaW4gTm9ydGggQW1lcmljYSAiICsKICAgICAgICAgICAib3IgKzk5OSAoMTIzKSA0NTY3OCA5MDYgaW50ZXJuYXRpb25hbGx5LiI7CiAgfSwKCiAgLyoqCiAgICogQHdvcmtJblByb2dyZXNzCiAgICogQG5nZG9jIHZhbGlkYXRvcgogICAqIEBuYW1lIGFuZ3VsYXIudmFsaWRhdG9yLnVybAogICAqIEBkZXNjcmlwdGlvbgogICAqIFVzZSBwaG9uZSB2YWxpZGF0b3IgdG8gcmVzdHJpY3QgdGhlIGlucHV0IFVSTHMuCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gdmFsdWUgdmFsdWUgdG8gdmFsaWRhdGUKICAgKiBAY3NzIG5nLXZhbGlkYXRpb24tZXJyb3IKICAgKgogICAqIEBleGFtcGxlCiAgICA8ZG9jOmV4YW1wbGU+CiAgICAgIDxkb2M6c291cmNlPgogICAgICAgIEVudGVyIHZhbGlkIFVSTDoKICAgICAgICA8aW5wdXQgbmFtZT0idGV4dCIgdmFsdWU9Imh0dHA6Ly9leGFtcGxlLmNvbS9hYmMuaHRtbCIgc2l6ZT0iNDAiIG5nOnZhbGlkYXRlPSJ1cmwiID4KICAgICAgPC9kb2M6c291cmNlPgogICAgICA8ZG9jOnNjZW5hcmlvPgogICAgICAgIGl0KCdzaG91bGQgaW52YWxpZGF0ZSB1cmwnLCBmdW5jdGlvbigpewogICAgICAgICB2YXIgbjEgPSBlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSA6aW5wdXQnKTsKICAgICAgICAgZXhwZWN0KG4xLmF0dHIoJ2NsYXNzTmFtZScpKS5ub3QoKS50b01hdGNoKC9uZy12YWxpZGF0aW9uLWVycm9yLyk7CiAgICAgICAgIGlucHV0KCd0ZXh0JykuZW50ZXIoJ2FiYzovL3NlcnZlci9wYXRoJyk7CiAgICAgICAgIGV4cGVjdChuMS5hdHRyKCdjbGFzc05hbWUnKSkudG9NYXRjaCgvbmctdmFsaWRhdGlvbi1lcnJvci8pOwogICAgICAgIH0pOwogICAgICA8L2RvYzpzY2VuYXJpbz4KICAgIDwvZG9jOmV4YW1wbGU+CiAgICoKICAgKi8KICAndXJsJzogZnVuY3Rpb24odmFsdWUpIHsKICAgIGlmICh2YWx1ZS5tYXRjaCgvXihmdHB8aHR0cHxodHRwcyk6XC9cLyhcdys6ezAsMX1cdypAKT8oXFMrKSg6WzAtOV0rKT8oXC98XC8oW1x3IyE6Lj8rPSYlQCFcLVwvXSkpPyQvKSkgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KICAgIHJldHVybiAiVVJMIG5lZWRzIHRvIGJlIGluIGh0dHA6Ly9zZXJ2ZXJbOnBvcnRdL3BhdGggZm9ybWF0LiI7CiAgfSwKCiAgLyoqCiAgICogQHdvcmtJblByb2dyZXNzCiAgICogQG5nZG9jIHZhbGlkYXRvcgogICAqIEBuYW1lIGFuZ3VsYXIudmFsaWRhdG9yLmpzb24KICAgKiBAZGVzY3JpcHRpb24KICAgKiBVc2UganNvbiB2YWxpZGF0b3IgaWYgeW91IHdpc2ggdG8gcmVzdHJpY3QgdGhlIHVzZXIgaW5wdXQgdG8gYSB2YWxpZCBKU09OLgogICAqCiAgICogQHBhcmFtIHtzdHJpbmd9IHZhbHVlIHZhbHVlIHRvIHZhbGlkYXRlCiAgICogQGNzcyBuZy12YWxpZGF0aW9uLWVycm9yCiAgICoKICAgKiBAZXhhbXBsZQogICAgPGRvYzpleGFtcGxlPgogICAgICA8ZG9jOnNvdXJjZT4KICAgICAgICA8dGV4dGFyZWEgbmFtZT0ianNvbiIgY29scz0iNjAiIHJvd3M9IjUiIG5nOnZhbGlkYXRlPSJqc29uIj4KICAgICAgICB7bmFtZTonYWJjJ30KICAgICAgICA8L3RleHRhcmVhPgogICAgICA8L2RvYzpzb3VyY2U+CiAgICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgICAgaXQoJ3Nob3VsZCBpbnZhbGlkYXRlIGpzb24nLCBmdW5jdGlvbigpewogICAgICAgICB2YXIgbjEgPSBlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSA6aW5wdXQnKTsKICAgICAgICAgZXhwZWN0KG4xLmF0dHIoJ2NsYXNzTmFtZScpKS5ub3QoKS50b01hdGNoKC9uZy12YWxpZGF0aW9uLWVycm9yLyk7CiAgICAgICAgIGlucHV0KCdqc29uJykuZW50ZXIoJ3tuYW1lfScpOwogICAgICAgICBleHBlY3QobjEuYXR0cignY2xhc3NOYW1lJykpLnRvTWF0Y2goL25nLXZhbGlkYXRpb24tZXJyb3IvKTsKICAgICAgICB9KTsKICAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICA8L2RvYzpleGFtcGxlPgogICAqCiAgICovCiAgJ2pzb24nOiBmdW5jdGlvbih2YWx1ZSkgewogICAgdHJ5IHsKICAgICAgZnJvbUpzb24odmFsdWUpOwogICAgICByZXR1cm4gbnVsbDsKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgcmV0dXJuIGUudG9TdHJpbmcoKTsKICAgIH0KICB9LAoKICAvKioKICAgKiBAd29ya0luUHJvZ3Jlc3MKICAgKiBAbmdkb2MgdmFsaWRhdG9yCiAgICogQG5hbWUgYW5ndWxhci52YWxpZGF0b3IuYXN5bmNocm9ub3VzCiAgICogQGRlc2NyaXB0aW9uCiAgICogVXNlIGFzeW5jaHJvbm91cyB2YWxpZGF0b3IgaWYgdGhlIHZhbGlkYXRpb24gY2FuIG5vdCBiZSBjb21wdXRlZAogICAqIGltbWVkaWF0ZWx5LCBidXQgaXMgcHJvdmlkZWQgdGhyb3VnaCBhIGNhbGxiYWNrLiBUaGUgd2lkZ2V0CiAgICogYXV0b21hdGljYWxseSBzaG93cyBhIHNwaW5uaW5nIGluZGljYXRvciB3aGlsZSB0aGUgdmFsaWRpdHkgb2YKICAgKiB0aGUgd2lkZ2V0IGlzIGNvbXB1dGVkLiBUaGlzIHZhbGlkYXRvciBjYWNoZXMgdGhlIHJlc3VsdC4KICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfSB2YWx1ZSB2YWx1ZSB0byB2YWxpZGF0ZQogICAqIEBwYXJhbSB7ZnVuY3Rpb24oaW5wdXRUb1ZhbGlkYXRlLHZhbGlkYXRpb25Eb25lKX0gdmFsaWRhdGUgZnVuY3Rpb24gdG8gY2FsbCB0byB2YWxpZGF0ZSB0aGUgc3RhdGUKICAgKiAgICAgICAgIG9mIHRoZSBpbnB1dC4KICAgKiBAcGFyYW0ge2Z1bmN0aW9uKGRhdGEpPX0gW3VwZGF0ZT1ub29wXSBmdW5jdGlvbiB0byBjYWxsIHdoZW4gc3RhdGUgb2YgdGhlCiAgICogICAgdmFsaWRhdG9yIGNoYW5nZXMKICAgKgogICAqIEBwYXJhbURlc2NyaXB0aW9uCiAgICogVGhlIGB2YWxpZGF0ZWAgZnVuY3Rpb24gKHNwZWNpZmllZCBieSB5b3UpIGlzIGNhbGxlZCBhcwogICAqIGB2YWxpZGF0ZShpbnB1dFRvVmFsaWRhdGUsIHZhbGlkYXRpb25Eb25lKWA6CiAgICoKICAgKiAgICAqIGBpbnB1dFRvVmFsaWRhdGVgOiB2YWx1ZSBvZiB0aGUgaW5wdXQgYm94LgogICAqICAgICogYHZhbGlkYXRpb25Eb25lYDogYGZ1bmN0aW9uKGVycm9yLCBkYXRhKXsuLi59YAogICAqICAgICAgICogYGVycm9yYDogZXJyb3IgdGV4dCB0byBkaXNwbGF5IGlmIHZhbGlkYXRpb24gZmFpbHMKICAgKiAgICAgICAqIGBkYXRhYDogZGF0YSBvYmplY3QgdG8gcGFzcyB0byB1cGRhdGUgZnVuY3Rpb24KICAgKgogICAqIFRoZSBgdXBkYXRlYCBmdW5jdGlvbiBpcyBvcHRpb25hbGx5IHNwZWNpZmllZCBieSB5b3UgYW5kIGlzCiAgICogY2FsbGVkIGJ5IDxhbmd1bGFyLz4gb24gaW5wdXQgY2hhbmdlLiBTaW5jZSB0aGUKICAgKiBhc3luY2hyb25vdXMgdmFsaWRhdG9yIGNhY2hlcyB0aGUgcmVzdWx0cywgdGhlIHVwZGF0ZQogICAqIGZ1bmN0aW9uIGNhbiBiZSBjYWxsZWQgd2l0aG91dCBhIGNhbGwgdG8gYHZhbGlkYXRlYAogICAqIGZ1bmN0aW9uLiBUaGUgZnVuY3Rpb24gaXMgY2FsbGVkIGFzIGB1cGRhdGUoZGF0YSlgOgogICAqCiAgICogICAgKiBgZGF0YWA6IGRhdGEgb2JqZWN0IGFzIHBhc3NlZCBmcm9tIHZhbGlkYXRlIGZ1bmN0aW9uCiAgICoKICAgKiBAY3NzIG5nLWlucHV0LWluZGljYXRvci13YWl0LCBuZy12YWxpZGF0aW9uLWVycm9yCiAgICoKICAgKiBAZXhhbXBsZQogICAgPGRvYzpleGFtcGxlPgogICAgICA8ZG9jOnNvdXJjZT4KICAgICAgICA8c2NyaXB0PgogICAgICAgIGZ1bmN0aW9uIE15Q250bCgpewogICAgICAgICB0aGlzLm15VmFsaWRhdG9yID0gZnVuY3Rpb24gKGlucHV0VG9WYWxpZGF0ZSwgdmFsaWRhdGlvbkRvbmUpIHsKICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICB2YWxpZGF0aW9uRG9uZShpbnB1dFRvVmFsaWRhdGUubGVuZ3RoICUgMik7CiAgICAgICAgICAgfSwgNTAwKTsKICAgICAgICAgfQogICAgICAgIH0KICAgICAgICA8L3NjcmlwdD4KICAgICAgICBUaGlzIGlucHV0IGlzIHZhbGlkYXRlZCBhc3luY2hyb25vdXNseToKICAgICAgICA8ZGl2IG5nOmNvbnRyb2xsZXI9Ik15Q250bCI+CiAgICAgICAgICA8aW5wdXQgbmFtZT0idGV4dCIgbmc6dmFsaWRhdGU9ImFzeW5jaHJvbm91czpteVZhbGlkYXRvciI+CiAgICAgICAgPC9kaXY+CiAgICAgIDwvZG9jOnNvdXJjZT4KICAgICAgPGRvYzpzY2VuYXJpbz4KICAgICAgICBpdCgnc2hvdWxkIGNoYW5nZSBjb2xvciBpbiBkZWxheWVkIHdheScsIGZ1bmN0aW9uKCl7CiAgICAgICAgIHZhciB0ZXh0Qm94ID0gZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgOmlucHV0Jyk7CiAgICAgICAgIGV4cGVjdCh0ZXh0Qm94LmF0dHIoJ2NsYXNzTmFtZScpKS5ub3QoKS50b01hdGNoKC9uZy1pbnB1dC1pbmRpY2F0b3Itd2FpdC8pOwogICAgICAgICBleHBlY3QodGV4dEJveC5hdHRyKCdjbGFzc05hbWUnKSkubm90KCkudG9NYXRjaCgvbmctdmFsaWRhdGlvbi1lcnJvci8pOwogICAgICAgICBpbnB1dCgndGV4dCcpLmVudGVyKCdYJyk7CiAgICAgICAgIGV4cGVjdCh0ZXh0Qm94LmF0dHIoJ2NsYXNzTmFtZScpKS50b01hdGNoKC9uZy1pbnB1dC1pbmRpY2F0b3Itd2FpdC8pOwogICAgICAgICBzbGVlcCguNik7CiAgICAgICAgIGV4cGVjdCh0ZXh0Qm94LmF0dHIoJ2NsYXNzTmFtZScpKS5ub3QoKS50b01hdGNoKC9uZy1pbnB1dC1pbmRpY2F0b3Itd2FpdC8pOwogICAgICAgICBleHBlY3QodGV4dEJveC5hdHRyKCdjbGFzc05hbWUnKSkudG9NYXRjaCgvbmctdmFsaWRhdGlvbi1lcnJvci8pOwogICAgICAgIH0pOwogICAgICA8L2RvYzpzY2VuYXJpbz4KICAgIDwvZG9jOmV4YW1wbGU+CiAgICoKICAgKi8KICAvKgogICAqIGNhY2hlIGlzIGF0dGFjaGVkIHRvIHRoZSBlbGVtZW50CiAgICogY2FjaGU6IHsKICAgKiAgIGlucHV0cyA6IHsKICAgKiAgICAgJ3VzZXIgaW5wdXQnOiB7CiAgICogICAgICAgIHJlc3BvbnNlOiBzZXJ2ZXIgcmVzcG9uc2UsCiAgICogICAgICAgIGVycm9yOiB2YWxpZGF0aW9uIGVycm9yCiAgICogICAgIH0sCiAgICogICAgIGN1cnJlbnQ6ICdjdXJyZW50IGlucHV0JwogICAqICAgfQogICAqIH0KICAgKgogICAqLwogICdhc3luY2hyb25vdXMnOiBmdW5jdGlvbihpbnB1dCwgYXN5bmNocm9ub3VzRm4sIHVwZGF0ZUZuKSB7CiAgICBpZiAoIWlucHV0KSByZXR1cm47CiAgICB2YXIgc2NvcGUgPSB0aGlzOwogICAgdmFyIGVsZW1lbnQgPSBzY29wZS4kZWxlbWVudDsKICAgIHZhciBjYWNoZSA9IGVsZW1lbnQuZGF0YSgnJGFzeW5jVmFsaWRhdG9yJyk7CiAgICBpZiAoIWNhY2hlKSB7CiAgICAgIGVsZW1lbnQuZGF0YSgnJGFzeW5jVmFsaWRhdG9yJywgY2FjaGUgPSB7aW5wdXRzOnt9fSk7CiAgICB9CgogICAgY2FjaGUuY3VycmVudCA9IGlucHV0OwoKICAgIHZhciBpbnB1dFN0YXRlID0gY2FjaGUuaW5wdXRzW2lucHV0XSwKICAgICAgICAkaW52YWxpZFdpZGdldHMgPSBzY29wZS4kc2VydmljZSgnJGludmFsaWRXaWRnZXRzJyk7CgogICAgaWYgKCFpbnB1dFN0YXRlKSB7CiAgICAgIGNhY2hlLmlucHV0c1tpbnB1dF0gPSBpbnB1dFN0YXRlID0geyBpbkZsaWdodDogdHJ1ZSB9OwogICAgICAkaW52YWxpZFdpZGdldHMubWFya0ludmFsaWQoc2NvcGUuJGVsZW1lbnQpOwogICAgICBlbGVtZW50LmFkZENsYXNzKCduZy1pbnB1dC1pbmRpY2F0b3Itd2FpdCcpOwogICAgICBhc3luY2hyb25vdXNGbihpbnB1dCwgZnVuY3Rpb24oZXJyb3IsIGRhdGEpIHsKICAgICAgICBpbnB1dFN0YXRlLnJlc3BvbnNlID0gZGF0YTsKICAgICAgICBpbnB1dFN0YXRlLmVycm9yID0gZXJyb3I7CiAgICAgICAgaW5wdXRTdGF0ZS5pbkZsaWdodCA9IGZhbHNlOwogICAgICAgIGlmIChjYWNoZS5jdXJyZW50ID09IGlucHV0KSB7CiAgICAgICAgICBlbGVtZW50LnJlbW92ZUNsYXNzKCduZy1pbnB1dC1pbmRpY2F0b3Itd2FpdCcpOwogICAgICAgICAgJGludmFsaWRXaWRnZXRzLm1hcmtWYWxpZChlbGVtZW50KTsKICAgICAgICB9CiAgICAgICAgZWxlbWVudC5kYXRhKCQkdmFsaWRhdGUpKCk7CiAgICAgICAgc2NvcGUuJHNlcnZpY2UoJyR1cGRhdGVWaWV3JykoKTsKICAgICAgfSk7CiAgICB9IGVsc2UgaWYgKGlucHV0U3RhdGUuaW5GbGlnaHQpIHsKICAgICAgLy8gcmVxdWVzdCBpbiBmbGlnaHQsIG1hcmsgd2lkZ2V0IGludmFsaWQsIGJ1dCBkb24ndCBzaG93IGl0IHRvIHVzZXIKICAgICAgJGludmFsaWRXaWRnZXRzLm1hcmtJbnZhbGlkKHNjb3BlLiRlbGVtZW50KTsKICAgIH0gZWxzZSB7CiAgICAgICh1cGRhdGVGbnx8bm9vcCkoaW5wdXRTdGF0ZS5yZXNwb25zZSk7CiAgICB9CiAgICByZXR1cm4gaW5wdXRTdGF0ZS5lcnJvcjsKICB9Cgp9KTsKJ3VzZSBzdHJpY3QnOwoKLyoqCiAqIEB3b3JrSW5Qcm9ncmVzcwogKiBAbmdkb2Mgc2VydmljZQogKiBAbmFtZSBhbmd1bGFyLnNlcnZpY2UuJGNvb2tpZVN0b3JlCiAqIEByZXF1aXJlcyAkY29va2llcwogKgogKiBAZGVzY3JpcHRpb24KICogUHJvdmlkZXMgYSBrZXktdmFsdWUgKHN0cmluZy1vYmplY3QpIHN0b3JhZ2UsIHRoYXQgaXMgYmFja2VkIGJ5IHNlc3Npb24gY29va2llcy4KICogT2JqZWN0cyBwdXQgb3IgcmV0cmlldmVkIGZyb20gdGhpcyBzdG9yYWdlIGFyZSBhdXRvbWF0aWNhbGx5IHNlcmlhbGl6ZWQgb3IKICogZGVzZXJpYWxpemVkIGJ5IGFuZ3VsYXIncyB0b0pzb24vZnJvbUpzb24uCiAqIEBleGFtcGxlCiAqLwphbmd1bGFyU2VydmljZUluamVjdCgnJGNvb2tpZVN0b3JlJywgZnVuY3Rpb24oJHN0b3JlKSB7CgogIHJldHVybiB7CiAgICAvKioKICAgICAqIEB3b3JrSW5Qcm9ncmVzcwogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgYW5ndWxhci5zZXJ2aWNlLiRjb29raWVTdG9yZSNnZXQKICAgICAqIEBtZXRob2RPZiBhbmd1bGFyLnNlcnZpY2UuJGNvb2tpZVN0b3JlCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBSZXR1cm5zIHRoZSB2YWx1ZSBvZiBnaXZlbiBjb29raWUga2V5CiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSBJZCB0byB1c2UgZm9yIGxvb2t1cC4KICAgICAqIEByZXR1cm5zIHtPYmplY3R9IERlc2VyaWFsaXplZCBjb29raWUgdmFsdWUuCiAgICAgKi8KICAgIGdldDogZnVuY3Rpb24oa2V5KSB7CiAgICAgIHJldHVybiBmcm9tSnNvbigkc3RvcmVba2V5XSk7CiAgICB9LAoKICAgIC8qKgogICAgICogQHdvcmtJblByb2dyZXNzCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSBhbmd1bGFyLnNlcnZpY2UuJGNvb2tpZVN0b3JlI3B1dAogICAgICogQG1ldGhvZE9mIGFuZ3VsYXIuc2VydmljZS4kY29va2llU3RvcmUKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFNldHMgYSB2YWx1ZSBmb3IgZ2l2ZW4gY29va2llIGtleQogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgSWQgZm9yIHRoZSBgdmFsdWVgLgogICAgICogQHBhcmFtIHtPYmplY3R9IHZhbHVlIFZhbHVlIHRvIGJlIHN0b3JlZC4KICAgICAqLwogICAgcHV0OiBmdW5jdGlvbihrZXksIHZhbHVlKSB7CiAgICAgICRzdG9yZVtrZXldID0gdG9Kc29uKHZhbHVlKTsKICAgIH0sCgogICAgLyoqCiAgICAgKiBAd29ya0luUHJvZ3Jlc3MKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lIGFuZ3VsYXIuc2VydmljZS4kY29va2llU3RvcmUjcmVtb3ZlCiAgICAgKiBAbWV0aG9kT2YgYW5ndWxhci5zZXJ2aWNlLiRjb29raWVTdG9yZQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogUmVtb3ZlIGdpdmVuIGNvb2tpZQogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgSWQgb2YgdGhlIGtleS12YWx1ZSBwYWlyIHRvIGRlbGV0ZS4KICAgICAqLwogICAgcmVtb3ZlOiBmdW5jdGlvbihrZXkpIHsKICAgICAgZGVsZXRlICRzdG9yZVtrZXldOwogICAgfQogIH07Cgp9LCBbJyRjb29raWVzJ10pOwondXNlIHN0cmljdCc7CgovKioKICogQHdvcmtJblByb2dyZXNzCiAqIEBuZ2RvYyBzZXJ2aWNlCiAqIEBuYW1lIGFuZ3VsYXIuc2VydmljZS4kY29va2llcwogKiBAcmVxdWlyZXMgJGJyb3dzZXIKICoKICogQGRlc2NyaXB0aW9uCiAqIFByb3ZpZGVzIHJlYWQvd3JpdGUgYWNjZXNzIHRvIGJyb3dzZXIncyBjb29raWVzLgogKgogKiBPbmx5IGEgc2ltcGxlIE9iamVjdCBpcyBleHBvc2VkIGFuZCBieSBhZGRpbmcgb3IgcmVtb3ZpbmcgcHJvcGVydGllcyB0by9mcm9tCiAqIHRoaXMgb2JqZWN0LCBuZXcgY29va2llcyBhcmUgY3JlYXRlZC9kZWxldGVkIGF0IHRoZSBlbmQgb2YgY3VycmVudCAkZXZhbC4KICoKICogQGV4YW1wbGUKICovCmFuZ3VsYXJTZXJ2aWNlSW5qZWN0KCckY29va2llcycsIGZ1bmN0aW9uKCRicm93c2VyKSB7CiAgdmFyIHJvb3RTY29wZSA9IHRoaXMsCiAgICAgIGNvb2tpZXMgPSB7fSwKICAgICAgbGFzdENvb2tpZXMgPSB7fSwKICAgICAgbGFzdEJyb3dzZXJDb29raWVzLAogICAgICBydW5FdmFsID0gZmFsc2U7CgogIC8vY3JlYXRlcyBhIHBvbGxlciBmbiB0aGF0IGNvcGllcyBhbGwgY29va2llcyBmcm9tIHRoZSAkYnJvd3NlciB0byBzZXJ2aWNlICYgaW5pdHMgdGhlIHNlcnZpY2UKICAkYnJvd3Nlci5hZGRQb2xsRm4oZnVuY3Rpb24oKSB7CiAgICB2YXIgY3VycmVudENvb2tpZXMgPSAkYnJvd3Nlci5jb29raWVzKCk7CiAgICBpZiAobGFzdEJyb3dzZXJDb29raWVzICE9IGN1cnJlbnRDb29raWVzKSB7IC8vcmVsaWVzIG9uIGJyb3dzZXIuY29va2llcygpIGltcGwKICAgICAgbGFzdEJyb3dzZXJDb29raWVzID0gY3VycmVudENvb2tpZXM7CiAgICAgIGNvcHkoY3VycmVudENvb2tpZXMsIGxhc3RDb29raWVzKTsKICAgICAgY29weShjdXJyZW50Q29va2llcywgY29va2llcyk7CiAgICAgIGlmIChydW5FdmFsKSByb290U2NvcGUuJGV2YWwoKTsKICAgIH0KICB9KSgpOwoKICBydW5FdmFsID0gdHJ1ZTsKCiAgLy9hdCB0aGUgZW5kIG9mIGVhY2ggZXZhbCwgcHVzaCBjb29raWVzCiAgLy9UT0RPOiB0aGlzIHNob3VsZCBoYXBwZW4gYmVmb3JlIHRoZSAiZGVsYXllZCIgd2F0Y2hlcyBmaXJlLCBiZWNhdXNlIGlmIHNvbWUgY29va2llcyBhcmUgbm90CiAgLy8gICAgICBzdHJpbmdzIG9yIGJyb3dzZXIgcmVmdXNlcyB0byBzdG9yZSBzb21lIGNvb2tpZXMsIHdlIHVwZGF0ZSB0aGUgbW9kZWwgaW4gdGhlIHB1c2ggZm4uCiAgdGhpcy4kb25FdmFsKFBSSU9SSVRZX0xBU1QsIHB1c2gpOwoKICByZXR1cm4gY29va2llczsKCgogIC8qKgogICAqIFB1c2hlcyBhbGwgdGhlIGNvb2tpZXMgZnJvbSB0aGUgc2VydmljZSB0byB0aGUgYnJvd3NlciBhbmQgdmVyaWZpZXMgaWYgYWxsIGNvb2tpZXMgd2VyZSBzdG9yZWQuCiAgICovCiAgZnVuY3Rpb24gcHVzaCgpewogICAgdmFyIG5hbWUsCiAgICAgICAgdmFsdWUsCiAgICAgICAgYnJvd3NlckNvb2tpZXMsCiAgICAgICAgdXBkYXRlZDsKCiAgICAvL2RlbGV0ZSBhbnkgY29va2llcyBkZWxldGVkIGluICRjb29raWVzCiAgICBmb3IgKG5hbWUgaW4gbGFzdENvb2tpZXMpIHsKICAgICAgaWYgKGlzVW5kZWZpbmVkKGNvb2tpZXNbbmFtZV0pKSB7CiAgICAgICAgJGJyb3dzZXIuY29va2llcyhuYW1lLCB1bmRlZmluZWQpOwogICAgICB9CiAgICB9CgogICAgLy91cGRhdGUgYWxsIGNvb2tpZXMgdXBkYXRlZCBpbiAkY29va2llcwogICAgZm9yKG5hbWUgaW4gY29va2llcykgewogICAgICB2YWx1ZSA9IGNvb2tpZXNbbmFtZV07CiAgICAgIGlmICghaXNTdHJpbmcodmFsdWUpKSB7CiAgICAgICAgaWYgKGlzRGVmaW5lZChsYXN0Q29va2llc1tuYW1lXSkpIHsKICAgICAgICAgIGNvb2tpZXNbbmFtZV0gPSBsYXN0Q29va2llc1tuYW1lXTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZGVsZXRlIGNvb2tpZXNbbmFtZV07CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKHZhbHVlICE9PSBsYXN0Q29va2llc1tuYW1lXSkgewogICAgICAgICRicm93c2VyLmNvb2tpZXMobmFtZSwgdmFsdWUpOwogICAgICAgIHVwZGF0ZWQgPSB0cnVlOwogICAgICB9CiAgICB9CgogICAgLy92ZXJpZnkgd2hhdCB3YXMgYWN0dWFsbHkgc3RvcmVkCiAgICBpZiAodXBkYXRlZCl7CiAgICAgIHVwZGF0ZWQgPSBmYWxzZTsKICAgICAgYnJvd3NlckNvb2tpZXMgPSAkYnJvd3Nlci5jb29raWVzKCk7CgogICAgICBmb3IgKG5hbWUgaW4gY29va2llcykgewogICAgICAgIGlmIChjb29raWVzW25hbWVdICE9PSBicm93c2VyQ29va2llc1tuYW1lXSkgewogICAgICAgICAgLy9kZWxldGUgb3IgcmVzZXQgYWxsIGNvb2tpZXMgdGhhdCB0aGUgYnJvd3NlciBkcm9wcGVkIGZyb20gJGNvb2tpZXMKICAgICAgICAgIGlmIChpc1VuZGVmaW5lZChicm93c2VyQ29va2llc1tuYW1lXSkpIHsKICAgICAgICAgICAgZGVsZXRlIGNvb2tpZXNbbmFtZV07CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjb29raWVzW25hbWVdID0gYnJvd3NlckNvb2tpZXNbbmFtZV07CiAgICAgICAgICB9CiAgICAgICAgICB1cGRhdGVkID0gdHJ1ZTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9Cn0sIFsnJGJyb3dzZXInXSk7Cid1c2Ugc3RyaWN0JzsKCi8qKgogKiBAd29ya0luUHJvZ3Jlc3MKICogQG5nZG9jIHNlcnZpY2UKICogQG5hbWUgYW5ndWxhci5zZXJ2aWNlLiRkZWZlcgogKiBAcmVxdWlyZXMgJGJyb3dzZXIKICogQHJlcXVpcmVzICRleGNlcHRpb25IYW5kbGVyCiAqIEByZXF1aXJlcyAkdXBkYXRlVmlldwogKgogKiBAZGVzY3JpcHRpb24KICogRGVsZWdhdGVzIHRvIHtAbGluayBhbmd1bGFyLnNlcnZpY2UuJGJyb3dzZXIgJGJyb3dzZXIuZGVmZXJ9LCBidXQgd3JhcHMgdGhlIGBmbmAgZnVuY3Rpb24KICogaW50byBhIHRyeS9jYXRjaCBibG9jayBhbmQgZGVsZWdhdGVzIGFueSBleGNlcHRpb25zIHRvCiAqIHtAbGluayBhbmd1bGFyLnNlcnZpY2UuJGV4Y2VwdGlvbkhhbmRsZXIgJGV4Y2VwdGlvbkhhbmRsZXJ9IHNlcnZpY2UuCiAqCiAqIEluIHRlc3RzIHlvdSBjYW4gdXNlIGAkYnJvd3Nlci5kZWZlci5mbHVzaCgpYCB0byBmbHVzaCB0aGUgcXVldWUgb2YgZGVmZXJyZWQgZnVuY3Rpb25zLgogKgogKiBAcGFyYW0ge2Z1bmN0aW9uKCl9IGZuIEEgZnVuY3Rpb24sIHdobydzIGV4ZWN1dGlvbiBzaG91bGQgYmUgZGVmZXJyZWQuCiAqIEBwYXJhbSB7bnVtYmVyPX0gW2RlbGF5PTBdIG9mIG1pbGxpc2Vjb25kcyB0byBkZWZlciB0aGUgZnVuY3Rpb24gZXhlY3V0aW9uLgogKi8KYW5ndWxhclNlcnZpY2VJbmplY3QoJyRkZWZlcicsIGZ1bmN0aW9uKCRicm93c2VyLCAkZXhjZXB0aW9uSGFuZGxlciwgJHVwZGF0ZVZpZXcpIHsKICByZXR1cm4gZnVuY3Rpb24oZm4sIGRlbGF5KSB7CiAgICAkYnJvd3Nlci5kZWZlcihmdW5jdGlvbigpIHsKICAgICAgdHJ5IHsKICAgICAgICBmbigpOwogICAgICB9IGNhdGNoKGUpIHsKICAgICAgICAkZXhjZXB0aW9uSGFuZGxlcihlKTsKICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAkdXBkYXRlVmlldygpOwogICAgICB9CiAgICB9LCBkZWxheSk7CiAgfTsKfSwgWyckYnJvd3NlcicsICckZXhjZXB0aW9uSGFuZGxlcicsICckdXBkYXRlVmlldyddKTsKJ3VzZSBzdHJpY3QnOwoKLyoqCiAqIEB3b3JrSW5Qcm9ncmVzcwogKiBAbmdkb2Mgc2VydmljZQogKiBAbmFtZSBhbmd1bGFyLnNlcnZpY2UuJGRvY3VtZW50CiAqIEByZXF1aXJlcyAkd2luZG93CiAqCiAqIEBkZXNjcmlwdGlvbgogKiBBIHtAbGluayBhbmd1bGFyLmVsZW1lbnQgalF1ZXJ5IChsaXRlKX0td3JhcHBlZCByZWZlcmVuY2UgdG8gdGhlIGJyb3dzZXIncyBgd2luZG93LmRvY3VtZW50YAogKiBlbGVtZW50LgogKi8KYW5ndWxhclNlcnZpY2VJbmplY3QoIiRkb2N1bWVudCIsIGZ1bmN0aW9uKHdpbmRvdyl7CiAgcmV0dXJuIGpxTGl0ZSh3aW5kb3cuZG9jdW1lbnQpOwp9LCBbJyR3aW5kb3cnXSk7Cid1c2Ugc3RyaWN0JzsKCi8qKgogKiBAd29ya0luUHJvZ3Jlc3MKICogQG5nZG9jIHNlcnZpY2UKICogQG5hbWUgYW5ndWxhci5zZXJ2aWNlLiRleGNlcHRpb25IYW5kbGVyCiAqIEByZXF1aXJlcyAkbG9nCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBBbnkgdW5jYXVnaHQgZXhjZXB0aW9uIGluIGFuZ3VsYXIgZXhwcmVzc2lvbnMgaXMgZGVsZWdhdGVkIHRvIHRoaXMgc2VydmljZS4KICogVGhlIGRlZmF1bHQgaW1wbGVtZW50YXRpb24gc2ltcGx5IGRlbGVnYXRlcyB0byBgJGxvZy5lcnJvcmAgd2hpY2ggbG9ncyBpdCBpbnRvCiAqIHRoZSBicm93c2VyIGNvbnNvbGUuCiAqCiAqIEluIHVuaXQgdGVzdHMsIGlmIGBhbmd1bGFyLW1vY2tzLmpzYCBpcyBsb2FkZWQsIHRoaXMgc2VydmljZSBpcyBvdmVycmlkZW4gYnkKICoge0BsaW5rIGFuZ3VsYXIubW9jay5zZXJ2aWNlLiRleGNlcHRpb25IYW5kbGVyIG1vY2sgJGV4Y2VwdGlvbkhhbmRsZXJ9CiAqCiAqIEBleGFtcGxlCiAqLwp2YXIgJGV4Y2VwdGlvbkhhbmRsZXJGYWN0b3J5OyAvL3JlZmVyZW5jZSB0byBiZSB1c2VkIG9ubHkgaW4gdGVzdHMKYW5ndWxhclNlcnZpY2VJbmplY3QoJyRleGNlcHRpb25IYW5kbGVyJywgJGV4Y2VwdGlvbkhhbmRsZXJGYWN0b3J5ID0gZnVuY3Rpb24oJGxvZyl7CiAgcmV0dXJuIGZ1bmN0aW9uKGUpIHsKICAgICRsb2cuZXJyb3IoZSk7CiAgfTsKfSwgWyckbG9nJ10pOwondXNlIHN0cmljdCc7CgovKioKICogQHdvcmtJblByb2dyZXNzCiAqIEBuZ2RvYyBzZXJ2aWNlCiAqIEBuYW1lIGFuZ3VsYXIuc2VydmljZS4kaG92ZXIKICogQHJlcXVpcmVzICRicm93c2VyCiAqIEByZXF1aXJlcyAkZG9jdW1lbnQKICoKICogQGRlc2NyaXB0aW9uCiAqCiAqIEBleGFtcGxlCiAqLwphbmd1bGFyU2VydmljZUluamVjdCgiJGhvdmVyIiwgZnVuY3Rpb24oYnJvd3NlciwgZG9jdW1lbnQpIHsKICB2YXIgdG9vbHRpcCwgc2VsZiA9IHRoaXMsIGVycm9yLCB3aWR0aCA9IDMwMCwgYXJyb3dXaWR0aCA9IDEwLCBib2R5ID0ganFMaXRlKGRvY3VtZW50WzBdLmJvZHkpOwogIGJyb3dzZXIuaG92ZXIoZnVuY3Rpb24oZWxlbWVudCwgc2hvdyl7CiAgICBpZiAoc2hvdyAmJiAoZXJyb3IgPSBlbGVtZW50LmF0dHIoTkdfRVhDRVBUSU9OKSB8fCBlbGVtZW50LmF0dHIoTkdfVkFMSURBVElPTl9FUlJPUikpKSB7CiAgICAgIGlmICghdG9vbHRpcCkgewogICAgICAgIHRvb2x0aXAgPSB7CiAgICAgICAgICAgIGNhbGxvdXQ6IGpxTGl0ZSgnPGRpdiBpZD0ibmctY2FsbG91dCI+PC9kaXY+JyksCiAgICAgICAgICAgIGFycm93OiBqcUxpdGUoJzxkaXY+PC9kaXY+JyksCiAgICAgICAgICAgIHRpdGxlOiBqcUxpdGUoJzxkaXYgY2xhc3M9Im5nLXRpdGxlIj48L2Rpdj4nKSwKICAgICAgICAgICAgY29udGVudDoganFMaXRlKCc8ZGl2IGNsYXNzPSJuZy1jb250ZW50Ij48L2Rpdj4nKQogICAgICAgIH07CiAgICAgICAgdG9vbHRpcC5jYWxsb3V0LmFwcGVuZCh0b29sdGlwLmFycm93KTsKICAgICAgICB0b29sdGlwLmNhbGxvdXQuYXBwZW5kKHRvb2x0aXAudGl0bGUpOwogICAgICAgIHRvb2x0aXAuY2FsbG91dC5hcHBlbmQodG9vbHRpcC5jb250ZW50KTsKICAgICAgICBib2R5LmFwcGVuZCh0b29sdGlwLmNhbGxvdXQpOwogICAgICB9CiAgICAgIHZhciBkb2NSZWN0ID0gYm9keVswXS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKSwKICAgICAgICAgIGVsZW1lbnRSZWN0ID0gZWxlbWVudFswXS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKSwKICAgICAgICAgIGxlZnRTcGFjZSA9IGRvY1JlY3QucmlnaHQgLSBlbGVtZW50UmVjdC5yaWdodCAtIGFycm93V2lkdGg7CiAgICAgIHRvb2x0aXAudGl0bGUudGV4dChlbGVtZW50Lmhhc0NsYXNzKCJuZy1leGNlcHRpb24iKSA/ICJFWENFUFRJT046IiA6ICJWYWxpZGF0aW9uIGVycm9yLi4uIik7CiAgICAgIHRvb2x0aXAuY29udGVudC50ZXh0KGVycm9yKTsKICAgICAgaWYgKGxlZnRTcGFjZSA8IHdpZHRoKSB7CiAgICAgICAgdG9vbHRpcC5hcnJvdy5hZGRDbGFzcygnbmctYXJyb3ctcmlnaHQnKTsKICAgICAgICB0b29sdGlwLmFycm93LmNzcyh7bGVmdDogKHdpZHRoICsgMSkrJ3B4J30pOwogICAgICAgIHRvb2x0aXAuY2FsbG91dC5jc3MoewogICAgICAgICAgcG9zaXRpb246ICdmaXhlZCcsCiAgICAgICAgICBsZWZ0OiAoZWxlbWVudFJlY3QubGVmdCAtIGFycm93V2lkdGggLSB3aWR0aCAtIDQpICsgInB4IiwKICAgICAgICAgIHRvcDogKGVsZW1lbnRSZWN0LnRvcCAtIDMpICsgInB4IiwKICAgICAgICAgIHdpZHRoOiB3aWR0aCArICJweCIKICAgICAgICB9KTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0b29sdGlwLmFycm93LmFkZENsYXNzKCduZy1hcnJvdy1sZWZ0Jyk7CiAgICAgICAgdG9vbHRpcC5jYWxsb3V0LmNzcyh7CiAgICAgICAgICBwb3NpdGlvbjogJ2ZpeGVkJywKICAgICAgICAgIGxlZnQ6IChlbGVtZW50UmVjdC5yaWdodCArIGFycm93V2lkdGgpICsgInB4IiwKICAgICAgICAgIHRvcDogKGVsZW1lbnRSZWN0LnRvcCAtIDMpICsgInB4IiwKICAgICAgICAgIHdpZHRoOiB3aWR0aCArICJweCIKICAgICAgICB9KTsKICAgICAgfQogICAgfSBlbHNlIGlmICh0b29sdGlwKSB7CiAgICAgIHRvb2x0aXAuY2FsbG91dC5yZW1vdmUoKTsKICAgICAgdG9vbHRpcCA9IG51bGw7CiAgICB9CiAgfSk7Cn0sIFsnJGJyb3dzZXInLCAnJGRvY3VtZW50J10sIHRydWUpOwondXNlIHN0cmljdCc7CgovKioKICogQHdvcmtJblByb2dyZXNzCiAqIEBuZ2RvYyBzZXJ2aWNlCiAqIEBuYW1lIGFuZ3VsYXIuc2VydmljZS4kaW52YWxpZFdpZGdldHMKICoKICogQGRlc2NyaXB0aW9uCiAqIEtlZXBzIHJlZmVyZW5jZXMgdG8gYWxsIGludmFsaWQgd2lkZ2V0cyBmb3VuZCBkdXJpbmcgdmFsaWRhdGlvbi4KICogQ2FuIGJlIHF1ZXJpZWQgdG8gZmluZCB3aGV0aGVyIHRoZXJlIGFyZSBhbnkgaW52YWxpZCB3aWRnZXRzIGN1cnJlbnRseSBkaXNwbGF5ZWQuCiAqCiAqIEBleGFtcGxlCiAqLwphbmd1bGFyU2VydmljZUluamVjdCgiJGludmFsaWRXaWRnZXRzIiwgZnVuY3Rpb24oKXsKICB2YXIgaW52YWxpZFdpZGdldHMgPSBbXTsKCgogIC8qKiBSZW1vdmUgYW4gZWxlbWVudCBmcm9tIHRoZSBhcnJheSBvZiBpbnZhbGlkIHdpZGdldHMgKi8KICBpbnZhbGlkV2lkZ2V0cy5tYXJrVmFsaWQgPSBmdW5jdGlvbihlbGVtZW50KXsKICAgIHZhciBpbmRleCA9IGluZGV4T2YoaW52YWxpZFdpZGdldHMsIGVsZW1lbnQpOwogICAgaWYgKGluZGV4ICE9IC0xKQogICAgICBpbnZhbGlkV2lkZ2V0cy5zcGxpY2UoaW5kZXgsIDEpOwogIH07CgoKICAvKiogQWRkIGFuIGVsZW1lbnQgdG8gdGhlIGFycmF5IG9mIGludmFsaWQgd2lkZ2V0cyAqLwogIGludmFsaWRXaWRnZXRzLm1hcmtJbnZhbGlkID0gZnVuY3Rpb24oZWxlbWVudCl7CiAgICB2YXIgaW5kZXggPSBpbmRleE9mKGludmFsaWRXaWRnZXRzLCBlbGVtZW50KTsKICAgIGlmIChpbmRleCA9PT0gLTEpCiAgICAgIGludmFsaWRXaWRnZXRzLnB1c2goZWxlbWVudCk7CiAgfTsKCgogIC8qKiBSZXR1cm4gY291bnQgb2YgYWxsIGludmFsaWQgd2lkZ2V0cyB0aGF0IGFyZSBjdXJyZW50bHkgdmlzaWJsZSAqLwogIGludmFsaWRXaWRnZXRzLnZpc2libGUgPSBmdW5jdGlvbigpIHsKICAgIHZhciBjb3VudCA9IDA7CiAgICBmb3JFYWNoKGludmFsaWRXaWRnZXRzLCBmdW5jdGlvbih3aWRnZXQpewogICAgICBjb3VudCA9IGNvdW50ICsgKGlzVmlzaWJsZSh3aWRnZXQpID8gMSA6IDApOwogICAgfSk7CiAgICByZXR1cm4gY291bnQ7CiAgfTsKCgogIC8qIEF0IHRoZSBlbmQgb2YgZWFjaCBldmFsIHJlbW92ZXMgYWxsIGludmFsaWQgd2lkZ2V0cyB0aGF0IGFyZSBub3QgcGFydCBvZiB0aGUgY3VycmVudCBET00uICovCiAgdGhpcy4kb25FdmFsKFBSSU9SSVRZX0xBU1QsIGZ1bmN0aW9uKCkgewogICAgZm9yKHZhciBpID0gMDsgaSA8IGludmFsaWRXaWRnZXRzLmxlbmd0aDspIHsKICAgICAgdmFyIHdpZGdldCA9IGludmFsaWRXaWRnZXRzW2ldOwogICAgICBpZiAoaXNPcnBoYW4od2lkZ2V0WzBdKSkgewogICAgICAgIGludmFsaWRXaWRnZXRzLnNwbGljZShpLCAxKTsKICAgICAgICBpZiAod2lkZ2V0LmRlYWxvYykgd2lkZ2V0LmRlYWxvYygpOwogICAgICB9IGVsc2UgewogICAgICAgIGkrKzsKICAgICAgfQogICAgfQogIH0pOwoKCiAgLyoqCiAgICogVHJhdmVyc2VzIERPTSBlbGVtZW50J3MgKHdpZGdldCdzKSBwYXJlbnRzIGFuZCBjb25zaWRlcnMgdGhlIGVsZW1lbnQgdG8gYmUgYW4gb3JwaGFudCBpZiBvbmUgb2YKICAgKiBpdCdzIHBhcmVudHMgaXNuJ3QgdGhlIGN1cnJlbnQgd2luZG93LmRvY3VtZW50LgogICAqLwogIGZ1bmN0aW9uIGlzT3JwaGFuKHdpZGdldCkgewogICAgaWYgKHdpZGdldCA9PSB3aW5kb3cuZG9jdW1lbnQpIHJldHVybiBmYWxzZTsKICAgIHZhciBwYXJlbnQgPSB3aWRnZXQucGFyZW50Tm9kZTsKICAgIHJldHVybiAhcGFyZW50IHx8IGlzT3JwaGFuKHBhcmVudCk7CiAgfQoKICByZXR1cm4gaW52YWxpZFdpZGdldHM7Cn0pOwondXNlIHN0cmljdCc7Cgp2YXIgVVJMX01BVENIID0gL14oZmlsZXxmdHB8aHR0cHxodHRwcyk6XC9cLyhcdys6ezAsMX1cdypAKT8oW1x3XC4tXSopKDooWzAtOV0rKSk/KFwvW15cPyNdKik/KFw/KFteI10qKSk/KCMoLiopKT8kLywKICAgIEhBU0hfTUFUQ0ggPSAvXihbXlw/XSopPyhcPyhbXlw/XSopKT8kLywKICAgIERFRkFVTFRfUE9SVFMgPSB7J2h0dHAnOiA4MCwgJ2h0dHBzJzogNDQzLCAnZnRwJzoyMX07CgovKioKICogQHdvcmtJblByb2dyZXNzCiAqIEBuZ2RvYyBzZXJ2aWNlCiAqIEBuYW1lIGFuZ3VsYXIuc2VydmljZS4kbG9jYXRpb24KICogQHJlcXVpcmVzICRicm93c2VyCiAqCiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBocmVmIFRoZSBmdWxsIFVSTCBvZiB0aGUgY3VycmVudCBsb2NhdGlvbi4KICogQHByb3BlcnR5IHtzdHJpbmd9IHByb3RvY29sIFRoZSBwcm90b2NvbCBwYXJ0IG9mIHRoZSBVUkwgKGUuZy4gaHR0cCBvciBodHRwcykuCiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBob3N0IFRoZSBob3N0IG5hbWUsIGlwIGFkZHJlc3Mgb3IgRlFETiBvZiB0aGUgY3VycmVudCBsb2NhdGlvbi4KICogQHByb3BlcnR5IHtudW1iZXJ9IHBvcnQgVGhlIHBvcnQgbnVtYmVyIG9mIHRoZSBjdXJyZW50IGxvY2F0aW9uIChlLmcuIDgwLCA0NDMsIDgwODApLgogKiBAcHJvcGVydHkge3N0cmluZ30gcGF0aCBUaGUgcGF0aCBvZiB0aGUgY3VycmVudCBsb2NhdGlvbiAoZS5nLiAvbXlhcHAvaW5ib3gpLgogKiBAcHJvcGVydHkge09iamVjdC48c3RyaW5nfGJvb2xlYW4+fSBzZWFyY2ggTWFwIG9mIHF1ZXJ5IHBhcmFtZXRlcnMgKGUuZy4ge3VzZXI6ImZvbyIsIHBhZ2U6MjN9KS4KICogQHByb3BlcnR5IHtzdHJpbmd9IGhhc2ggVGhlIGZyYWdtZW50IHBhcnQgb2YgdGhlIFVSTCBvZiB0aGUgY3VycmVudCBsb2NhdGlvbiAoZS5nLiAjZm9vKS4KICogQHByb3BlcnR5IHtzdHJpbmd9IGhhc2hQYXRoIFNpbWlsYXIgdG8gYHBhdGhgLCBidXQgbG9jYXRlZCBpbiB0aGUgYGhhc2hgIGZyYWdtZW50CiAqICAgICAoZS5nLiAuLi9mb28jL3NvbWUvcGF0aCAgPT4gL3NvbWUvcGF0aCkuCiAqIEBwcm9wZXJ0eSB7T2JqZWN0LjxzdHJpbmd8Ym9vbGVhbj59IGhhc2hTZWFyY2ggU2ltaWxhciB0byBgc2VhcmNoYCBidXQgbG9jYXRlZCBpbiBgaGFzaGAKICogICAgIGZyYWdtZW50IChlLmcuIC4uLi9mb28jL3NvbWUvcGF0aD9oYXNoUXVlcnk9cGFyYW0gID0+ICB7aGFzaFF1ZXJ5OiAicGFyYW0ifSkuCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBQYXJzZXMgdGhlIGJyb3dzZXIgbG9jYXRpb24gdXJsIGFuZCBtYWtlcyBpdCBhdmFpbGFibGUgdG8geW91ciBhcHBsaWNhdGlvbi4KICogQW55IGNoYW5nZXMgdG8gdGhlIHVybCBhcmUgcmVmbGVjdGVkIGludG8gYCRsb2NhdGlvbmAgc2VydmljZSBhbmQgY2hhbmdlcyB0bwogKiBgJGxvY2F0aW9uYCBhcmUgcmVmbGVjdGVkIGluIHRoZSBicm93c2VyIGxvY2F0aW9uIHVybC4KICoKICogTm90aWNlIHRoYXQgdXNpbmcgYnJvd3NlcidzIGZvcndhcmQvYmFjayBidXR0b25zIGNoYW5nZXMgdGhlICRsb2NhdGlvbi4KICoKICogQGV4YW1wbGUKICAgPGRvYzpleGFtcGxlPgogICAgIDxkb2M6c291cmNlPgogICAgICAgPGRpdiBuZzppbml0PSIkbG9jYXRpb24gPSAkc2VydmljZSgnJGxvY2F0aW9uJykiPgogICAgICAgICA8YSBpZD0iZXgtdGVzdCIgaHJlZj0iI215UGF0aD9uYW1lPW1pc2tvIj50ZXN0IGhhc2g8L2E+fAogICAgICAgICA8YSBpZD0iZXgtcmVzZXQiIGhyZWY9IiMhL2FwaS9hbmd1bGFyLnNlcnZpY2UuJGxvY2F0aW9uIj5yZXNldCBoYXNoPC9hPjxici8+CiAgICAgICAgIDxpbnB1dCB0eXBlPSd0ZXh0JyBuYW1lPSIkbG9jYXRpb24uaGFzaCIgc2l6ZT0iMzAiPgogICAgICAgICA8cHJlPiRsb2NhdGlvbiA9IHt7JGxvY2F0aW9ufX08L3ByZT4KICAgICAgIDwvZGl2PgogICAgIDwvZG9jOnNvdXJjZT4KICAgICA8ZG9jOnNjZW5hcmlvPgogICAgICAgaXQoJ3Nob3VsZCBpbml0aWFsaXplIHRoZSBpbnB1dCBmaWVsZCcsIGZ1bmN0aW9uKCkgewogICAgICAgICBleHBlY3QodXNpbmcoJy5kb2MtZXhhbXBsZS1saXZlJykuaW5wdXQoJyRsb2NhdGlvbi5oYXNoJykudmFsKCkpLgogICAgICAgICAgIHRvQmUoJyEvYXBpL2FuZ3VsYXIuc2VydmljZS4kbG9jYXRpb24nKTsKICAgICAgIH0pOwoKCiAgICAgICBpdCgnc2hvdWxkIGJpbmQgJGxvY2F0aW9uLmhhc2ggdG8gdGhlIGlucHV0IGZpZWxkJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIHVzaW5nKCcuZG9jLWV4YW1wbGUtbGl2ZScpLmlucHV0KCckbG9jYXRpb24uaGFzaCcpLmVudGVyKCdmb28nKTsKICAgICAgICAgZXhwZWN0KGJyb3dzZXIoKS5sb2NhdGlvbigpLmhhc2goKSkudG9CZSgnZm9vJyk7CiAgICAgICB9KTsKCgogICAgICAgaXQoJ3Nob3VsZCBzZXQgdGhlIGhhc2ggdG8gYSB0ZXN0IHN0cmluZyB3aXRoIHRlc3QgbGluayBpcyBwcmVzZWQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgdXNpbmcoJy5kb2MtZXhhbXBsZS1saXZlJykuZWxlbWVudCgnI2V4LXRlc3QnKS5jbGljaygpOwogICAgICAgICBleHBlY3QodXNpbmcoJy5kb2MtZXhhbXBsZS1saXZlJykuaW5wdXQoJyRsb2NhdGlvbi5oYXNoJykudmFsKCkpLgogICAgICAgICAgIHRvQmUoJ215UGF0aD9uYW1lPW1pc2tvJyk7CiAgICAgICB9KTsKCiAgICAgICBpdCgnc2hvdWxkIHJlc2V0ICRsb2NhdGlvbiB3aGVuIHJlc2V0IGxpbmsgaXMgcHJlc3NlZCcsIGZ1bmN0aW9uKCkgewogICAgICAgICB1c2luZygnLmRvYy1leGFtcGxlLWxpdmUnKS5pbnB1dCgnJGxvY2F0aW9uLmhhc2gnKS5lbnRlcignZm9vJyk7CiAgICAgICAgIHVzaW5nKCcuZG9jLWV4YW1wbGUtbGl2ZScpLmVsZW1lbnQoJyNleC1yZXNldCcpLmNsaWNrKCk7CiAgICAgICAgIGV4cGVjdCh1c2luZygnLmRvYy1leGFtcGxlLWxpdmUnKS5pbnB1dCgnJGxvY2F0aW9uLmhhc2gnKS52YWwoKSkuCiAgICAgICAgICAgdG9CZSgnIS9hcGkvYW5ndWxhci5zZXJ2aWNlLiRsb2NhdGlvbicpOwogICAgICAgfSk7CgogICAgIDwvZG9jOnNjZW5hcmlvPgogICAgPC9kb2M6ZXhhbXBsZT4KICovCmFuZ3VsYXJTZXJ2aWNlSW5qZWN0KCIkbG9jYXRpb24iLCBmdW5jdGlvbigkYnJvd3NlcikgewogIHZhciBzY29wZSA9IHRoaXMsCiAgICAgIGxvY2F0aW9uID0ge3VwZGF0ZTp1cGRhdGUsIHVwZGF0ZUhhc2g6IHVwZGF0ZUhhc2h9LAogICAgICBsYXN0TG9jYXRpb24gPSB7fTsKCiAgJGJyb3dzZXIub25IYXNoQ2hhbmdlKGZ1bmN0aW9uKCkgeyAvL3JlZ2lzdGVyCiAgICB1cGRhdGUoJGJyb3dzZXIuZ2V0VXJsKCkpOwogICAgY29weShsb2NhdGlvbiwgbGFzdExvY2F0aW9uKTsKICAgIHNjb3BlLiRldmFsKCk7CiAgfSkoKTsgLy9pbml0aWFsaXplCgogIHRoaXMuJG9uRXZhbChQUklPUklUWV9GSVJTVCwgc3luYyk7CiAgdGhpcy4kb25FdmFsKFBSSU9SSVRZX0xBU1QsIHVwZGF0ZUJyb3dzZXIpOwoKICByZXR1cm4gbG9jYXRpb247CgogIC8vIFBVQkxJQyBNRVRIT0RTCgogIC8qKgogICAqIEB3b3JrSW5Qcm9ncmVzcwogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSBhbmd1bGFyLnNlcnZpY2UuJGxvY2F0aW9uI3VwZGF0ZQogICAqIEBtZXRob2RPZiBhbmd1bGFyLnNlcnZpY2UuJGxvY2F0aW9uCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBVcGRhdGVzIHRoZSBsb2NhdGlvbiBvYmplY3QuCiAgICoKICAgKiBEb2VzIG5vdCBpbW1lZGlhdGVseSB1cGRhdGUgdGhlIGJyb3dzZXIuIEluc3RlYWQgdGhlIGJyb3dzZXIgaXMgdXBkYXRlZCBhdCB0aGUgZW5kIG9mICRldmFsKCkKICAgKiBjeWNsZS4KICAgKgogICAqIDxwcmU+CiAgICAgICAkbG9jYXRpb24udXBkYXRlKCdodHRwOi8vd3d3LmFuZ3VsYXJqcy5vcmcvcGF0aCNoYXNoP3NlYXJjaD14Jyk7CiAgICAgICAkbG9jYXRpb24udXBkYXRlKHtob3N0OiAnd3d3Lmdvb2dsZS5jb20nLCBwcm90b2NvbDogJ2h0dHBzJ30pOwogICAgICAgJGxvY2F0aW9uLnVwZGF0ZSh7aGFzaFBhdGg6ICcvcGF0aCcsIGhhc2hTZWFyY2g6IHthOiAnYicsIHg6IHRydWV9fSk7CiAgICAgPC9wcmU+CiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ3xPYmplY3R9IGhyZWYgRnVsbCBocmVmIGFzIGEgc3RyaW5nIG9yIG9iamVjdCB3aXRoIHByb3BlcnRpZXMKICAgKi8KICBmdW5jdGlvbiB1cGRhdGUoaHJlZikgewogICAgaWYgKGlzU3RyaW5nKGhyZWYpKSB7CiAgICAgIGV4dGVuZChsb2NhdGlvbiwgcGFyc2VIcmVmKGhyZWYpKTsKICAgIH0gZWxzZSB7CiAgICAgIGlmIChpc0RlZmluZWQoaHJlZi5oYXNoKSkgewogICAgICAgIGV4dGVuZChocmVmLCBpc1N0cmluZyhocmVmLmhhc2gpID8gcGFyc2VIYXNoKGhyZWYuaGFzaCkgOiBocmVmLmhhc2gpOwogICAgICB9CgogICAgICBleHRlbmQobG9jYXRpb24sIGhyZWYpOwoKICAgICAgaWYgKGlzRGVmaW5lZChocmVmLmhhc2hQYXRoIHx8IGhyZWYuaGFzaFNlYXJjaCkpIHsKICAgICAgICBsb2NhdGlvbi5oYXNoID0gY29tcG9zZUhhc2gobG9jYXRpb24pOwogICAgICB9CgogICAgICBsb2NhdGlvbi5ocmVmID0gY29tcG9zZUhyZWYobG9jYXRpb24pOwogICAgfQogIH0KCiAgLyoqCiAgICogQHdvcmtJblByb2dyZXNzCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lIGFuZ3VsYXIuc2VydmljZS4kbG9jYXRpb24jdXBkYXRlSGFzaAogICAqIEBtZXRob2RPZiBhbmd1bGFyLnNlcnZpY2UuJGxvY2F0aW9uCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBVcGRhdGVzIHRoZSBoYXNoIGZyYWdtZW50IHBhcnQgb2YgdGhlIHVybC4KICAgKgogICAqIEBzZWUgdXBkYXRlKCkKICAgKgogICAqIDxwcmU+CiAgICAgICBzY29wZS4kbG9jYXRpb24udXBkYXRlSGFzaCgnL2hwJykKICAgICAgICAgPT0+IHVwZGF0ZSh7aGFzaFBhdGg6ICcvaHAnfSkKICAgICAgIHNjb3BlLiRsb2NhdGlvbi51cGRhdGVIYXNoKHthOiB0cnVlLCBiOiAndmFsJ30pCiAgICAgICAgID09PiB1cGRhdGUoe2hhc2hTZWFyY2g6IHthOiB0cnVlLCBiOiAndmFsJ319KQogICAgICAgc2NvcGUuJGxvY2F0aW9uLnVwZGF0ZUhhc2goJy9ocCcsIHthOiB0cnVlfSkKICAgICAgICAgPT0+IHVwZGF0ZSh7aGFzaFBhdGg6ICcvaHAnLCBoYXNoU2VhcmNoOiB7YTogdHJ1ZX19KQogICAgIDwvcHJlPgogICAqCiAgICogQHBhcmFtIHtzdHJpbmd8T2JqZWN0fSBwYXRoIEEgaGFzaFBhdGggb3IgaGFzaFNlYXJjaCBvYmplY3QKICAgKiBAcGFyYW0ge09iamVjdD19IHNlYXJjaCBBIGhhc2hTZWFyY2ggb2JqZWN0CiAgICovCiAgZnVuY3Rpb24gdXBkYXRlSGFzaChwYXRoLCBzZWFyY2gpIHsKICAgIHZhciBoYXNoID0ge307CgogICAgaWYgKGlzU3RyaW5nKHBhdGgpKSB7CiAgICAgIGhhc2guaGFzaFBhdGggPSBwYXRoOwogICAgICBoYXNoLmhhc2hTZWFyY2ggPSBzZWFyY2ggfHwge307CiAgICB9IGVsc2UKICAgICAgaGFzaC5oYXNoU2VhcmNoID0gcGF0aDsKCiAgICBoYXNoLmhhc2ggPSBjb21wb3NlSGFzaChoYXNoKTsKCiAgICB1cGRhdGUoe2hhc2g6IGhhc2h9KTsKICB9CgoKICAvLyBJTk5FUiBNRVRIT0RTCgogIC8qKgogICAqIFN5bmNocm9uaXplcyBhbGwgbG9jYXRpb24gb2JqZWN0IHByb3BlcnRpZXMuCiAgICoKICAgKiBVc2VyIGlzIGFsbG93ZWQgdG8gY2hhbmdlIHByb3BlcnRpZXMsIHNvIGFmdGVyIHByb3BlcnR5IGNoYW5nZSwKICAgKiBsb2NhdGlvbiBvYmplY3QgaXMgbm90IGluIGNvbnNpc3RlbnQgc3RhdGUuCiAgICoKICAgKiBQcm9wZXJ0aWVzIGFyZSBzeW5jZWQgd2l0aCB0aGUgZm9sbG93aW5nIHByZWNlZGVuY2Ugb3JkZXI6CiAgICoKICAgKiAtIGAkbG9jYXRpb24uaHJlZmAKICAgKiAtIGAkbG9jYXRpb24uaGFzaGAKICAgKiAtIGV2ZXJ5dGhpbmcgZWxzZQogICAqCiAgICogS2VlcCBpbiBtaW5kIHRoYXQgaWYgdGhlIGZvbGxvd2luZyBjb2RlIGlzIGV4ZWN1dGVkOgogICAqCiAgICogc2NvcGUuJGxvY2F0aW9uLmhyZWYgPSAnaHR0cDovL3d3dy5hbmd1bGFyanMub3JnL3BhdGgjYS9iJwogICAqCiAgICogaW1tZWRpYXRlbHkgYWZ0ZXJ3YXJkcyBhbGwgb3RoZXIgcHJvcGVydGllcyBhcmUgc3RpbGwgdGhlIG9sZCBvbmVzLi4uCiAgICoKICAgKiBUaGlzIG1ldGhvZCBjaGVja3MgdGhlIGNoYW5nZXMgYW5kIHVwZGF0ZSBsb2NhdGlvbiB0byB0aGUgY29uc2lzdGVudCBzdGF0ZQogICAqLwogIGZ1bmN0aW9uIHN5bmMoKSB7CiAgICBpZiAoIWVxdWFscyhsb2NhdGlvbiwgbGFzdExvY2F0aW9uKSkgewogICAgICBpZiAobG9jYXRpb24uaHJlZiAhPSBsYXN0TG9jYXRpb24uaHJlZikgewogICAgICAgIHVwZGF0ZShsb2NhdGlvbi5ocmVmKTsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgaWYgKGxvY2F0aW9uLmhhc2ggIT0gbGFzdExvY2F0aW9uLmhhc2gpIHsKICAgICAgICB2YXIgaGFzaCA9IHBhcnNlSGFzaChsb2NhdGlvbi5oYXNoKTsKICAgICAgICB1cGRhdGVIYXNoKGhhc2guaGFzaFBhdGgsIGhhc2guaGFzaFNlYXJjaCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgbG9jYXRpb24uaGFzaCA9IGNvbXBvc2VIYXNoKGxvY2F0aW9uKTsKICAgICAgICBsb2NhdGlvbi5ocmVmID0gY29tcG9zZUhyZWYobG9jYXRpb24pOwogICAgICB9CiAgICAgIHVwZGF0ZShsb2NhdGlvbi5ocmVmKTsKICAgIH0KICB9CgoKICAvKioKICAgKiBJZiBsb2NhdGlvbiBoYXMgY2hhbmdlZCwgdXBkYXRlIHRoZSBicm93c2VyCiAgICogVGhpcyBtZXRob2QgaXMgY2FsbGVkIGF0IHRoZSBlbmQgb2YgJGV2YWwoKSBwaGFzZQogICAqLwogIGZ1bmN0aW9uIHVwZGF0ZUJyb3dzZXIoKSB7CiAgICBzeW5jKCk7CgogICAgaWYgKCRicm93c2VyLmdldFVybCgpICE9IGxvY2F0aW9uLmhyZWYpIHsKICAgICAgJGJyb3dzZXIuc2V0VXJsKGxvY2F0aW9uLmhyZWYpOwogICAgICBjb3B5KGxvY2F0aW9uLCBsYXN0TG9jYXRpb24pOwogICAgfQogIH0KCiAgLyoqCiAgICogQ29tcG9zZSBocmVmIHN0cmluZyBmcm9tIGEgbG9jYXRpb24gb2JqZWN0CiAgICoKICAgKiBAcGFyYW0ge09iamVjdH0gbG9jIFRoZSBsb2NhdGlvbiBvYmplY3Qgd2l0aCBhbGwgcHJvcGVydGllcwogICAqIEByZXR1cm4ge3N0cmluZ30gQ29tcG9zZWQgaHJlZgogICAqLwogIGZ1bmN0aW9uIGNvbXBvc2VIcmVmKGxvYykgewogICAgdmFyIHVybCA9IHRvS2V5VmFsdWUobG9jLnNlYXJjaCk7CiAgICB2YXIgcG9ydCA9IChsb2MucG9ydCA9PSBERUZBVUxUX1BPUlRTW2xvYy5wcm90b2NvbF0gPyBudWxsIDogbG9jLnBvcnQpOwoKICAgIHJldHVybiBsb2MucHJvdG9jb2wgICsgJzovLycgKyBsb2MuaG9zdCArCiAgICAgICAgICAocG9ydCA/ICc6JyArIHBvcnQgOiAnJykgKyBsb2MucGF0aCArCiAgICAgICAgICAodXJsID8gJz8nICsgdXJsIDogJycpICsgKGxvYy5oYXNoID8gJyMnICsgbG9jLmhhc2ggOiAnJyk7CiAgfQoKICAvKioKICAgKiBDb21wb3NlIGhhc2ggc3RyaW5nIGZyb20gbG9jYXRpb24gb2JqZWN0CiAgICoKICAgKiBAcGFyYW0ge09iamVjdH0gbG9jIE9iamVjdCB3aXRoIGhhc2hQYXRoIGFuZCBoYXNoU2VhcmNoIHByb3BlcnRpZXMKICAgKiBAcmV0dXJuIHtzdHJpbmd9IEhhc2ggc3RyaW5nCiAgICovCiAgZnVuY3Rpb24gY29tcG9zZUhhc2gobG9jKSB7CiAgICB2YXIgaGFzaFNlYXJjaCA9IHRvS2V5VmFsdWUobG9jLmhhc2hTZWFyY2gpOwogICAgLy9UT0RPOiB0ZW1wb3JhcnkgZml4IGZvciBpc3N1ZSAjMTU4CiAgICByZXR1cm4gZXNjYXBlKGxvYy5oYXNoUGF0aCkucmVwbGFjZSgvJTIxL2dpLCAnIScpLnJlcGxhY2UoLyUzQS9naSwgJzonKS5yZXBsYWNlKC8lMjQvZ2ksICckJykgKwogICAgICAgICAgKGhhc2hTZWFyY2ggPyAnPycgKyBoYXNoU2VhcmNoIDogJycpOwogIH0KCiAgLyoqCiAgICogUGFyc2UgaHJlZiBzdHJpbmcgaW50byBsb2NhdGlvbiBvYmplY3QKICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfSBocmVmCiAgICogQHJldHVybiB7T2JqZWN0fSBUaGUgbG9jYXRpb24gb2JqZWN0CiAgICovCiAgZnVuY3Rpb24gcGFyc2VIcmVmKGhyZWYpIHsKICAgIHZhciBsb2MgPSB7fTsKICAgIHZhciBtYXRjaCA9IFVSTF9NQVRDSC5leGVjKGhyZWYpOwoKICAgIGlmIChtYXRjaCkgewogICAgICBsb2MuaHJlZiA9IGhyZWYucmVwbGFjZSgvIyQvLCAnJyk7CiAgICAgIGxvYy5wcm90b2NvbCA9IG1hdGNoWzFdOwogICAgICBsb2MuaG9zdCA9IG1hdGNoWzNdIHx8ICcnOwogICAgICBsb2MucG9ydCA9IG1hdGNoWzVdIHx8IERFRkFVTFRfUE9SVFNbbG9jLnByb3RvY29sXSB8fCBudWxsOwogICAgICBsb2MucGF0aCA9IG1hdGNoWzZdIHx8ICcnOwogICAgICBsb2Muc2VhcmNoID0gcGFyc2VLZXlWYWx1ZShtYXRjaFs4XSk7CiAgICAgIGxvYy5oYXNoID0gbWF0Y2hbMTBdIHx8ICcnOwoKICAgICAgZXh0ZW5kKGxvYywgcGFyc2VIYXNoKGxvYy5oYXNoKSk7CiAgICB9CgogICAgcmV0dXJuIGxvYzsKICB9CgogIC8qKgogICAqIFBhcnNlIGhhc2ggc3RyaW5nIGludG8gb2JqZWN0CiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gaGFzaAogICAqLwogIGZ1bmN0aW9uIHBhcnNlSGFzaChoYXNoKSB7CiAgICB2YXIgaCA9IHt9OwogICAgdmFyIG1hdGNoID0gSEFTSF9NQVRDSC5leGVjKGhhc2gpOwoKICAgIGlmIChtYXRjaCkgewogICAgICBoLmhhc2ggPSBoYXNoOwogICAgICBoLmhhc2hQYXRoID0gdW5lc2NhcGUobWF0Y2hbMV0gfHwgJycpOwogICAgICBoLmhhc2hTZWFyY2ggPSBwYXJzZUtleVZhbHVlKG1hdGNoWzNdKTsKICAgIH0KCiAgICByZXR1cm4gaDsKICB9Cn0sIFsnJGJyb3dzZXInXSk7Cid1c2Ugc3RyaWN0JzsKCi8qKgogKiBAd29ya0luUHJvZ3Jlc3MKICogQG5nZG9jIHNlcnZpY2UKICogQG5hbWUgYW5ndWxhci5zZXJ2aWNlLiRsb2cKICogQHJlcXVpcmVzICR3aW5kb3cKICoKICogQGRlc2NyaXB0aW9uCiAqIFNpbXBsZSBzZXJ2aWNlIGZvciBsb2dnaW5nLiBEZWZhdWx0IGltcGxlbWVudGF0aW9uIHdyaXRlcyB0aGUgbWVzc2FnZQogKiBpbnRvIHRoZSBicm93c2VyJ3MgY29uc29sZSAoaWYgcHJlc2VudCkuCiAqCiAqIFRoZSBtYWluIHB1cnBvc2Ugb2YgdGhpcyBzZXJ2aWNlIGlzIHRvIHNpbXBsaWZ5IGRlYnVnZ2luZyBhbmQgdHJvdWJsZXNob290aW5nLgogKgogKiBAZXhhbXBsZQogICAgPGRvYzpleGFtcGxlPgogICAgICA8ZG9jOnNvdXJjZT4KICAgICAgICAgPHA+UmVsb2FkIHRoaXMgcGFnZSB3aXRoIG9wZW4gY29uc29sZSwgZW50ZXIgdGV4dCBhbmQgaGl0IHRoZSBsb2cgYnV0dG9uLi4uPC9wPgogICAgICAgICBNZXNzYWdlOgogICAgICAgICA8aW5wdXQgdHlwZT0idGV4dCIgbmFtZT0ibWVzc2FnZSIgdmFsdWU9IkhlbGxvIFdvcmxkISIvPgogICAgICAgICA8YnV0dG9uIG5nOmNsaWNrPSIkbG9nLmxvZyhtZXNzYWdlKSI+bG9nPC9idXR0b24+CiAgICAgICAgIDxidXR0b24gbmc6Y2xpY2s9IiRsb2cud2FybihtZXNzYWdlKSI+d2FybjwvYnV0dG9uPgogICAgICAgICA8YnV0dG9uIG5nOmNsaWNrPSIkbG9nLmluZm8obWVzc2FnZSkiPmluZm88L2J1dHRvbj4KICAgICAgICAgPGJ1dHRvbiBuZzpjbGljaz0iJGxvZy5lcnJvcihtZXNzYWdlKSI+ZXJyb3I8L2J1dHRvbj4KICAgICAgPC9kb2M6c291cmNlPgogICAgICA8ZG9jOnNjZW5hcmlvPgogICAgICA8L2RvYzpzY2VuYXJpbz4KICAgIDwvZG9jOmV4YW1wbGU+CiAqLwp2YXIgJGxvZ0ZhY3Rvcnk7IC8vcmVmZXJlbmNlIHRvIGJlIHVzZWQgb25seSBpbiB0ZXN0cwphbmd1bGFyU2VydmljZUluamVjdCgiJGxvZyIsICRsb2dGYWN0b3J5ID0gZnVuY3Rpb24oJHdpbmRvdyl7CiAgcmV0dXJuIHsKICAgIC8qKgogICAgICogQHdvcmtJblByb2dyZXNzCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSBhbmd1bGFyLnNlcnZpY2UuJGxvZyNsb2cKICAgICAqIEBtZXRob2RPZiBhbmd1bGFyLnNlcnZpY2UuJGxvZwogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogV3JpdGUgYSBsb2cgbWVzc2FnZQogICAgICovCiAgICBsb2c6IGNvbnNvbGVMb2coJ2xvZycpLAoKICAgIC8qKgogICAgICogQHdvcmtJblByb2dyZXNzCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSBhbmd1bGFyLnNlcnZpY2UuJGxvZyN3YXJuCiAgICAgKiBAbWV0aG9kT2YgYW5ndWxhci5zZXJ2aWNlLiRsb2cKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFdyaXRlIGEgd2FybmluZyBtZXNzYWdlCiAgICAgKi8KICAgIHdhcm46IGNvbnNvbGVMb2coJ3dhcm4nKSwKCiAgICAvKioKICAgICAqIEB3b3JrSW5Qcm9ncmVzcwogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgYW5ndWxhci5zZXJ2aWNlLiRsb2cjaW5mbwogICAgICogQG1ldGhvZE9mIGFuZ3VsYXIuc2VydmljZS4kbG9nCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBXcml0ZSBhbiBpbmZvcm1hdGlvbiBtZXNzYWdlCiAgICAgKi8KICAgIGluZm86IGNvbnNvbGVMb2coJ2luZm8nKSwKCiAgICAvKioKICAgICAqIEB3b3JrSW5Qcm9ncmVzcwogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgYW5ndWxhci5zZXJ2aWNlLiRsb2cjZXJyb3IKICAgICAqIEBtZXRob2RPZiBhbmd1bGFyLnNlcnZpY2UuJGxvZwogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogV3JpdGUgYW4gZXJyb3IgbWVzc2FnZQogICAgICovCiAgICBlcnJvcjogY29uc29sZUxvZygnZXJyb3InKQogIH07CgogIGZ1bmN0aW9uIGNvbnNvbGVMb2codHlwZSkgewogICAgdmFyIGNvbnNvbGUgPSAkd2luZG93LmNvbnNvbGUgfHwge307CiAgICB2YXIgbG9nRm4gPSBjb25zb2xlW3R5cGVdIHx8IGNvbnNvbGUubG9nIHx8IG5vb3A7CiAgICBpZiAobG9nRm4uYXBwbHkpIHsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKCl7CiAgICAgICAgdmFyIGFyZ3MgPSBbXTsKICAgICAgICBmb3JFYWNoKGFyZ3VtZW50cywgZnVuY3Rpb24oYXJnKXsKICAgICAgICAgIGFyZ3MucHVzaChmb3JtYXRFcnJvcihhcmcpKTsKICAgICAgICB9KTsKICAgICAgICByZXR1cm4gbG9nRm4uYXBwbHkoY29uc29sZSwgYXJncyk7CiAgICAgIH07CiAgICB9IGVsc2UgewogICAgICAvLyB3ZSBhcmUgSUUsIGluIHdoaWNoIGNhc2UgdGhlcmUgaXMgbm90aGluZyB3ZSBjYW4gZG8KICAgICAgcmV0dXJuIGxvZ0ZuOwogICAgfQogIH0KfSwgWyckd2luZG93J10pOwondXNlIHN0cmljdCc7CgovKioKICogQHdvcmtJblByb2dyZXNzCiAqIEBuZ2RvYyBzZXJ2aWNlCiAqIEBuYW1lIGFuZ3VsYXIuc2VydmljZS4kcmVzb3VyY2UKICogQHJlcXVpcmVzICR4aHIuY2FjaGUKICoKICogQGRlc2NyaXB0aW9uCiAqIEEgZmFjdG9yeSB3aGljaCBjcmVhdGVzIGEgcmVzb3VyY2Ugb2JqZWN0IHRoYXQgbGV0cyB5b3UgaW50ZXJhY3Qgd2l0aAogKiBbUkVTVGZ1bF0oaHR0cDovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9SZXByZXNlbnRhdGlvbmFsX1N0YXRlX1RyYW5zZmVyKSBzZXJ2ZXItc2lkZSBkYXRhIHNvdXJjZXMuCiAqCiAqIFRoZSByZXR1cm5lZCByZXNvdXJjZSBvYmplY3QgaGFzIGFjdGlvbiBtZXRob2RzIHdoaWNoIHByb3ZpZGUgaGlnaC1sZXZlbCBiZWhhdmlvcnMgd2l0aG91dAogKiB0aGUgbmVlZCB0byBpbnRlcmFjdCB3aXRoIHRoZSBsb3cgbGV2ZWwge0BsaW5rIGFuZ3VsYXIuc2VydmljZS4keGhyICR4aHJ9IHNlcnZpY2Ugb3IKICogcmF3IFhNTEh0dHBSZXF1ZXN0LgogKgogKiBAcGFyYW0ge3N0cmluZ30gdXJsIEEgcGFyYW1ldGVyaXplZCBVUkwgdGVtcGxhdGUgd2l0aCBwYXJhbWV0ZXJzIHByZWZpeGVkIGJ5IGA6YCBhcyBpbgogKiAgIGAvdXNlci86dXNlcm5hbWVgLgogKgogKiBAcGFyYW0ge09iamVjdD19IHBhcmFtRGVmYXVsdHMgRGVmYXVsdCB2YWx1ZXMgZm9yIGB1cmxgIHBhcmFtZXRlcnMuIFRoZXNlIGNhbiBiZSBvdmVycmlkZGVuIGluCiAqICAgYGFjdGlvbnNgIG1ldGhvZHMuCiAqCiAqICAgRWFjaCBrZXkgdmFsdWUgaW4gdGhlIHBhcmFtZXRlciBvYmplY3QgaXMgZmlyc3QgYm91bmQgdG8gdXJsIHRlbXBsYXRlIGlmIHByZXNlbnQgYW5kIHRoZW4gYW55CiAqICAgZXhjZXNzIGtleXMgYXJlIGFwcGVuZGVkIHRvIHRoZSB1cmwgc2VhcmNoIHF1ZXJ5IGFmdGVyIHRoZSBgP2AuCiAqCiAqICAgR2l2ZW4gYSB0ZW1wbGF0ZSBgL3BhdGgvOnZlcmJgIGFuZCBwYXJhbWV0ZXIgYHt2ZXJiOidncmVldCcsIHNhbHV0YXRpb246J0hlbGxvJ31gIHJlc3VsdHMgaW4KICogICBVUkwgYC9wYXRoL2dyZWV0P3NhbHV0YXRpb249SGVsbG9gLgogKgogKiAgIElmIHRoZSBwYXJhbWV0ZXIgdmFsdWUgaXMgcHJlZml4ZWQgd2l0aCBgQGAgdGhlbiB0aGUgdmFsdWUgb2YgdGhhdCBwYXJhbWV0ZXIgaXMgZXh0cmFjdGVkIGZyb20KICogICB0aGUgZGF0YSBvYmplY3QgKHVzZWZ1bCBmb3Igbm9uLUdFVCBvcGVyYXRpb25zKS4KICoKICogQHBhcmFtIHtPYmplY3QuPE9iamVjdD49fSBhY3Rpb25zIEhhc2ggd2l0aCBkZWNsYXJhdGlvbiBvZiBjdXN0b20gYWN0aW9uIHRoYXQgc2hvdWxkIGV4dGVuZCB0aGUKICogICBkZWZhdWx0IHNldCBvZiByZXNvdXJjZSBhY3Rpb25zLiBUaGUgZGVjbGFyYXRpb24gc2hvdWxkIGJlIGNyZWF0ZWQgaW4gdGhlIGZvbGxvd2luZyBmb3JtYXQ6CiAqCiAqICAgICAgIHthY3Rpb24xOiB7bWV0aG9kOj8sIHBhcmFtczo/LCBpc0FycmF5Oj8sIHZlcmlmeUNhY2hlOj99LAogKiAgICAgICAgYWN0aW9uMjoge21ldGhvZDo/LCBwYXJhbXM6PywgaXNBcnJheTo/LCB2ZXJpZnlDYWNoZTo/fSwKICogICAgICAgIC4uLn0KICoKICogICBXaGVyZToKICoKICogICAtIGBhY3Rpb25gIOKAkyB7c3RyaW5nfSDigJMgVGhlIG5hbWUgb2YgYWN0aW9uLiBUaGlzIG5hbWUgYmVjb21lcyB0aGUgbmFtZSBvZiB0aGUgbWV0aG9kIG9uIHlvdXIKICogICAgIHJlc291cmNlIG9iamVjdC4KICogICAtIGBtZXRob2RgIOKAkyB7c3RyaW5nfSDigJMgSFRUUCByZXF1ZXN0IG1ldGhvZC4gVmFsaWQgbWV0aG9kcyBhcmU6IGBHRVRgLCBgUE9TVGAsIGBQVVRgLCBgREVMRVRFYCwKICogICAgIGFuZCBgSlNPTmAgKGFsc28ga25vd24gYXMgSlNPTlApLgogKiAgIC0gYHBhcmFtc2Ag4oCTIHtvYmplY3Q9fSDigJMgT3B0aW9uYWwgc2V0IG9mIHByZS1ib3VuZCBwYXJhbWV0ZXJzIGZvciB0aGlzIGFjdGlvbi4KICogICAtIGlzQXJyYXkg4oCTIHtib29sZWFuPX0g4oCTIElmIHRydWUgdGhlbiB0aGUgcmV0dXJuZWQgb2JqZWN0IGZvciB0aGlzIGFjdGlvbiBpcyBhbiBhcnJheSwgc2VlCiAqICAgICBgcmV0dXJuc2Agc2VjdGlvbi4KICogICAtIHZlcmlmeUNhY2hlIOKAkyB7Ym9vbGVhbj19IOKAkyBJZiB0cnVlIHRoZW4gd2hlbmV2ZXIgY2FjaGUgaGl0IG9jY3VycywgdGhlIG9iamVjdCBpcyByZXR1cm5lZCBhbmQKICogICAgIGFuIGFzeW5jIHJlcXVlc3Qgd2lsbCBiZSBtYWRlIHRvIHRoZSBzZXJ2ZXIgYW5kIHRoZSByZXNvdXJjZXMgYXMgd2VsbCBhcyB0aGUgY2FjaGUgd2lsbCBiZQogKiAgICAgdXBkYXRlZCB3aGVuIHRoZSByZXNwb25zZSBpcyByZWNlaXZlZC4KICoKICogQHJldHVybnMge09iamVjdH0gQSByZXNvdXJjZSAiY2xhc3MiIG9iamVjdCB3aXRoIG1ldGhvZHMgZm9yIHRoZSBkZWZhdWx0IHNldCBvZiByZXNvdXJjZSBhY3Rpb25zCiAqICAgb3B0aW9uYWxseSBleHRlbmRlZCB3aXRoIGN1c3RvbSBgYWN0aW9uc2AuIFRoZSBkZWZhdWx0IHNldCBjb250YWlucyB0aGVzZSBhY3Rpb25zOgogKgogKiAgICAgICB7ICdnZXQnOiAgICB7bWV0aG9kOidHRVQnfSwKICogICAgICAgICAnc2F2ZSc6ICAge21ldGhvZDonUE9TVCd9LAogKiAgICAgICAgICdxdWVyeSc6ICB7bWV0aG9kOidHRVQnLCBpc0FycmF5OnRydWV9LAogKiAgICAgICAgICdyZW1vdmUnOiB7bWV0aG9kOidERUxFVEUnfSwKICogICAgICAgICAnZGVsZXRlJzoge21ldGhvZDonREVMRVRFJ30gfTsKICoKICogICBDYWxsaW5nIHRoZXNlIG1ldGhvZHMgaW52b2tlIGFuIHtAbGluayBhbmd1bGFyLnNlcnZpY2UuJHhocn0gd2l0aCB0aGUgc3BlY2lmaWVkIGh0dHAgbWV0aG9kLAogKiAgIGRlc3RpbmF0aW9uIGFuZCBwYXJhbWV0ZXJzLiBXaGVuIHRoZSBkYXRhIGlzIHJldHVybmVkIGZyb20gdGhlIHNlcnZlciB0aGVuIHRoZSBvYmplY3QgaXMgYW4KICogICBpbnN0YW5jZSBvZiB0aGUgcmVzb3VyY2UgY2xhc3MgYHNhdmVgLCBgcmVtb3ZlYCBhbmQgYGRlbGV0ZWAgYWN0aW9ucyBhcmUgYXZhaWxhYmxlIG9uIGl0IGFzCiAqICAgbWV0aG9kcyB3aXRoIHRoZSBgJGAgcHJlZml4LiBUaGlzIGFsbG93cyB5b3UgdG8gZWFzaWx5IHBlcmZvcm0gQ1JVRCBvcGVyYXRpb25zIChjcmVhdGUsIHJlYWQsCiAqICAgdXBkYXRlLCBkZWxldGUpIG9uIHNlcnZlci1zaWRlIGRhdGEgbGlrZSB0aGlzOgogKiAgIDxwcmU+CiAgICAgICAgdmFyIFVzZXIgPSAkcmVzb3VyY2UoJy91c2VyLzp1c2VySWQnLCB7dXNlcklkOidAaWQnfSk7CiAgICAgICAgdmFyIHVzZXIgPSBVc2VyLmdldCh7dXNlcklkOjEyM30sIGZ1bmN0aW9uKCl7CiAgICAgICAgICB1c2VyLmFiYyA9IHRydWU7CiAgICAgICAgICB1c2VyLiRzYXZlKCk7CiAgICAgICAgfSk7CiAgICAgPC9wcmU+CiAqCiAqICAgSXQgaXMgaW1wb3J0YW50IHRvIHJlYWxpemUgdGhhdCBpbnZva2luZyBhICRyZXNvdXJjZSBvYmplY3QgbWV0aG9kIGltbWVkaWF0ZWx5IHJldHVybnMgYW4KICogICBlbXB0eSByZWZlcmVuY2UgKG9iamVjdCBvciBhcnJheSBkZXBlbmRpbmcgb24gYGlzQXJyYXlgKS4gT25jZSB0aGUgZGF0YSBpcyByZXR1cm5lZCBmcm9tIHRoZQogKiAgIHNlcnZlciB0aGUgZXhpc3RpbmcgcmVmZXJlbmNlIGlzIHBvcHVsYXRlZCB3aXRoIHRoZSBhY3R1YWwgZGF0YS4gVGhpcyBpcyBhIHVzZWZ1bCB0cmljayBzaW5jZQogKiAgIHVzdWFsbHkgdGhlIHJlc291cmNlIGlzIGFzc2lnbmVkIHRvIGEgbW9kZWwgd2hpY2ggaXMgdGhlbiByZW5kZXJlZCBieSB0aGUgdmlldy4gSGF2aW5nIGFuIGVtcHR5CiAqICAgb2JqZWN0IHJlc3VsdHMgaW4gbm8gcmVuZGVyaW5nLCBvbmNlIHRoZSBkYXRhIGFycml2ZXMgZnJvbSB0aGUgc2VydmVyIHRoZW4gdGhlIG9iamVjdCBpcwogKiAgIHBvcHVsYXRlZCB3aXRoIHRoZSBkYXRhIGFuZCB0aGUgdmlldyBhdXRvbWF0aWNhbGx5IHJlLXJlbmRlcnMgaXRzZWxmIHNob3dpbmcgdGhlIG5ldyBkYXRhLiBUaGlzCiAqICAgbWVhbnMgdGhhdCBpbiBtb3N0IGNhc2Ugb25lIG5ldmVyIGhhcyB0byB3cml0ZSBhIGNhbGxiYWNrIGZ1bmN0aW9uIGZvciB0aGUgYWN0aW9uIG1ldGhvZHMuCiAqCiAqICAgVGhlIGFjdGlvbiBtZXRob2RzIG9uIHRoZSBjbGFzcyBvYmplY3Qgb3IgaW5zdGFuY2Ugb2JqZWN0IGNhbiBiZSBpbnZva2VkIHdpdGggdGhlIGZvbGxvd2luZwogKiAgIHBhcmFtZXRlcnM6CiAqCiAqICAgLSBIVFRQIEdFVCAiY2xhc3MiIGFjdGlvbnM6IGBSZXNvdXJjZS5hY3Rpb24oW3BhcmFtZXRlcnNdLCBbc3VjY2Vzc10sIFtlcnJvcl0pYAogKiAgIC0gbm9uLUdFVCAiY2xhc3MiIGFjdGlvbnM6IGBSZXNvdXJjZS5hY3Rpb24ocG9zdERhdGEsIFtwYXJhbWV0ZXJzXSwgW3N1Y2Nlc3NdLCBbZXJyb3JdKWAKICogICAtIG5vbi1HRVQgaW5zdGFuY2UgYWN0aW9uczogIGBpbnN0YW5jZS4kYWN0aW9uKFtwYXJhbWV0ZXJzXSwgW3N1Y2Nlc3NdLCBbZXJyb3JdKWAKICoKICoKICogQGV4YW1wbGUKICoKICogIyBDcmVkaXQgY2FyZCByZXNvdXJjZQogKgogKiA8cHJlPgogICAgIC8vIERlZmluZSBDcmVkaXRDYXJkIGNsYXNzCiAgICAgdmFyIENyZWRpdENhcmQgPSAkcmVzb3VyY2UoJy91c2VyLzp1c2VySWQvY2FyZC86Y2FyZElkJywKICAgICAge3VzZXJJZDoxMjMsIGNhcmRJZDonQGlkJ30sIHsKICAgICAgIGNoYXJnZToge21ldGhvZDonUE9TVCcsIHBhcmFtczp7Y2hhcmdlOnRydWV9fQogICAgICB9KTsKCiAgICAgLy8gV2UgY2FuIHJldHJpZXZlIGEgY29sbGVjdGlvbiBmcm9tIHRoZSBzZXJ2ZXIKICAgICB2YXIgY2FyZHMgPSBDcmVkaXRDYXJkLnF1ZXJ5KCk7CiAgICAgLy8gR0VUOiAvdXNlci8xMjMvY2FyZAogICAgIC8vIHNlcnZlciByZXR1cm5zOiBbIHtpZDo0NTYsIG51bWJlcjonMTIzNCcsIG5hbWU6J1NtaXRoJ30gXTsKCiAgICAgdmFyIGNhcmQgPSBjYXJkc1swXTsKICAgICAvLyBlYWNoIGl0ZW0gaXMgYW4gaW5zdGFuY2Ugb2YgQ3JlZGl0Q2FyZAogICAgIGV4cGVjdChjYXJkIGluc3RhbmNlb2YgQ3JlZGl0Q2FyZCkudG9FcXVhbCh0cnVlKTsKICAgICBjYXJkLm5hbWUgPSAiSi4gU21pdGgiOwogICAgIC8vIG5vbiBHRVQgbWV0aG9kcyBhcmUgbWFwcGVkIG9udG8gdGhlIGluc3RhbmNlcwogICAgIGNhcmQuJHNhdmUoKTsKICAgICAvLyBQT1NUOiAvdXNlci8xMjMvY2FyZC80NTYge2lkOjQ1NiwgbnVtYmVyOicxMjM0JywgbmFtZTonSi4gU21pdGgnfQogICAgIC8vIHNlcnZlciByZXR1cm5zOiB7aWQ6NDU2LCBudW1iZXI6JzEyMzQnLCBuYW1lOiAnSi4gU21pdGgnfTsKCiAgICAgLy8gb3VyIGN1c3RvbSBtZXRob2QgaXMgbWFwcGVkIGFzIHdlbGwuCiAgICAgY2FyZC4kY2hhcmdlKHthbW91bnQ6OS45OX0pOwogICAgIC8vIFBPU1Q6IC91c2VyLzEyMy9jYXJkLzQ1Nj9hbW91bnQ9OS45OSZjaGFyZ2U9dHJ1ZSB7aWQ6NDU2LCBudW1iZXI6JzEyMzQnLCBuYW1lOidKLiBTbWl0aCd9CiAgICAgLy8gc2VydmVyIHJldHVybnM6IHtpZDo0NTYsIG51bWJlcjonMTIzNCcsIG5hbWU6ICdKLiBTbWl0aCd9OwoKICAgICAvLyB3ZSBjYW4gY3JlYXRlIGFuIGluc3RhbmNlIGFzIHdlbGwKICAgICB2YXIgbmV3Q2FyZCA9IG5ldyBDcmVkaXRDYXJkKHtudW1iZXI6JzAxMjMnfSk7CiAgICAgbmV3Q2FyZC5uYW1lID0gIk1pa2UgU21pdGgiOwogICAgIG5ld0NhcmQuJHNhdmUoKTsKICAgICAvLyBQT1NUOiAvdXNlci8xMjMvY2FyZCB7bnVtYmVyOicwMTIzJywgbmFtZTonTWlrZSBTbWl0aCd9CiAgICAgLy8gc2VydmVyIHJldHVybnM6IHtpZDo3ODksIG51bWJlcjonMDEyMzQnLCBuYW1lOiAnTWlrZSBTbWl0aCd9OwogICAgIGV4cGVjdChuZXdDYXJkLmlkKS50b0VxdWFsKDc4OSk7CiAqIDwvcHJlPgogKgogKiBUaGUgb2JqZWN0IHJldHVybmVkIGZyb20gdGhpcyBmdW5jdGlvbiBleGVjdXRpb24gaXMgYSByZXNvdXJjZSAiY2xhc3MiIHdoaWNoIGhhcyAic3RhdGljIiBtZXRob2QKICogZm9yIGVhY2ggYWN0aW9uIGluIHRoZSBkZWZpbml0aW9uLgogKgogKiBDYWxsaW5nIHRoZXNlIG1ldGhvZHMgaW52b2tlIGAkeGhyYCBvbiB0aGUgYHVybGAgdGVtcGxhdGUgd2l0aCB0aGUgZ2l2ZW4gYG1ldGhvZGAgYW5kIGBwYXJhbXNgLgogKiBXaGVuIHRoZSBkYXRhIGlzIHJldHVybmVkIGZyb20gdGhlIHNlcnZlciB0aGVuIHRoZSBvYmplY3QgaXMgYW4gaW5zdGFuY2Ugb2YgdGhlIHJlc291cmNlIHR5cGUgYW5kCiAqIGFsbCBvZiB0aGUgbm9uLUdFVCBtZXRob2RzIGFyZSBhdmFpbGFibGUgd2l0aCBgJGAgcHJlZml4LiBUaGlzIGFsbG93cyB5b3UgdG8gZWFzaWx5IHN1cHBvcnQgQ1JVRAogKiBvcGVyYXRpb25zIChjcmVhdGUsIHJlYWQsIHVwZGF0ZSwgZGVsZXRlKSBvbiBzZXJ2ZXItc2lkZSBkYXRhLgoKICAgPHByZT4KICAgICB2YXIgVXNlciA9ICRyZXNvdXJjZSgnL3VzZXIvOnVzZXJJZCcsIHt1c2VySWQ6J0BpZCd9KTsKICAgICB2YXIgdXNlciA9IFVzZXIuZ2V0KHt1c2VySWQ6MTIzfSwgZnVuY3Rpb24oKXsKICAgICAgIHVzZXIuYWJjID0gdHJ1ZTsKICAgICAgIHVzZXIuJHNhdmUoKTsKICAgICB9KTsKICAgPC9wcmU+CiAqCiAqICAgICBJdCdzIHdvcnRoIG5vdGluZyB0aGF0IHRoZSBzdWNjZXNzIGNhbGxiYWNrIGZvciBgZ2V0YCwgYHF1ZXJ5YCBhbmQgb3RoZXIgbWV0aG9kIGdldHMgcGFzc2VkCiAqICAgICBpbiB0aGUgcmVzcG9uc2UgdGhhdCBjYW1lIGZyb20gdGhlIHNlcnZlciwgc28gb25lIGNvdWxkIHJld3JpdGUgdGhlIGFib3ZlIGV4YW1wbGUgYXM6CiAqCiAgIDxwcmU+CiAgICAgdmFyIFVzZXIgPSAkcmVzb3VyY2UoJy91c2VyLzp1c2VySWQnLCB7dXNlcklkOidAaWQnfSk7CiAgICAgVXNlci5nZXQoe3VzZXJJZDoxMjN9LCBmdW5jdGlvbih1LCByZXNwb25zZUhlYWRlcnMpewogICAgICAgdS5hYmMgPSB0cnVlOwogICAgICAgdS4kc2F2ZShmdW5jdGlvbih1LCByZXNwb25zZUhlYWRlcnMpIHsKICAgICAgICAgLy8gR2V0IGFuIE9iamVjdCBjb250YWluaW5nIGFsbCByZXNwb25zZSBoZWFkZXJzCiAgICAgICAgIHZhciBhbGxIZWFkZXJzID0gcmVzcG9uc2VIZWFkZXJzKCk7CgogICAgICAgICAvLyBHZXQgYSBzcGVjaWZpYyByZXNwb25zZSBoZWFkZXIKICAgICAgICAgdS5uZXdJZCA9IHJlc3BvbnNlSGVhZGVycygnTG9jYXRpb24nKTsKICAgICAgIH0pOwogICAgIH0pOwogICA8L3ByZT4KCiAqICMgQnV6eiBjbGllbnQKCiAgIExldCdzIGxvb2sgYXQgd2hhdCBhIGJ1enogY2xpZW50IGNyZWF0ZWQgd2l0aCB0aGUgYCRyZXNvdXJjZWAgc2VydmljZSBsb29rcyBsaWtlOgogICAgPGRvYzpleGFtcGxlPgogICAgICA8ZG9jOnNvdXJjZSBqc2ZpZGRsZT0iZmFsc2UiPgogICAgICAgPHNjcmlwdD4KICAgICAgICAgZnVuY3Rpb24gQnV6ekNvbnRyb2xsZXIoJHJlc291cmNlKSB7CiAgICAgICAgICAgdGhpcy5BY3Rpdml0eSA9ICRyZXNvdXJjZSgKICAgICAgICAgICAgICdodHRwczovL3d3dy5nb29nbGVhcGlzLmNvbS9idXp6L3YxL2FjdGl2aXRpZXMvOnVzZXJJZC86dmlzaWJpbGl0eS86YWN0aXZpdHlJZC86Y29tbWVudHMnLAogICAgICAgICAgICAge2FsdDonanNvbicsIGNhbGxiYWNrOidKU09OX0NBTExCQUNLJ30sCiAgICAgICAgICAgICB7Z2V0OnttZXRob2Q6J0pTT04nLCBwYXJhbXM6e3Zpc2liaWxpdHk6J0BzZWxmJ319LCByZXBsaWVzOiB7bWV0aG9kOidKU09OJywgcGFyYW1zOnt2aXNpYmlsaXR5OidAc2VsZicsIGNvbW1lbnRzOidAY29tbWVudHMnfX19CiAgICAgICAgICAgKTsKICAgICAgICAgfQoKICAgICAgICAgQnV6ekNvbnRyb2xsZXIucHJvdG90eXBlID0gewogICAgICAgICAgIGZldGNoOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgIHRoaXMuYWN0aXZpdGllcyA9IHRoaXMuQWN0aXZpdHkuZ2V0KHt1c2VySWQ6dGhpcy51c2VySWR9KTsKICAgICAgICAgICB9LAogICAgICAgICAgIGV4cGFuZFJlcGxpZXM6IGZ1bmN0aW9uKGFjdGl2aXR5KSB7CiAgICAgICAgICAgICBhY3Rpdml0eS5yZXBsaWVzID0gdGhpcy5BY3Rpdml0eS5yZXBsaWVzKHt1c2VySWQ6dGhpcy51c2VySWQsIGFjdGl2aXR5SWQ6YWN0aXZpdHkuaWR9KTsKICAgICAgICAgICB9CiAgICAgICAgIH07CiAgICAgICAgIEJ1enpDb250cm9sbGVyLiRpbmplY3QgPSBbJyRyZXNvdXJjZSddOwogICAgICAgPC9zY3JpcHQ+CgogICAgICAgPGRpdiBuZzpjb250cm9sbGVyPSJCdXp6Q29udHJvbGxlciI+CiAgICAgICAgIDxpbnB1dCBuYW1lPSJ1c2VySWQiIHZhbHVlPSJnb29nbGVidXp6Ii8+CiAgICAgICAgIDxidXR0b24gbmc6Y2xpY2s9ImZldGNoKCkiPmZldGNoPC9idXR0b24+CiAgICAgICAgIDxoci8+CiAgICAgICAgIDxkaXYgbmc6cmVwZWF0PSJpdGVtIGluIGFjdGl2aXRpZXMuZGF0YS5pdGVtcyI+CiAgICAgICAgICAgPGgxIHN0eWxlPSJmb250LXNpemU6IDE1cHg7Ij4KICAgICAgICAgICAgIDxpbWcgc3JjPSJ7e2l0ZW0uYWN0b3IudGh1bWJuYWlsVXJsfX0iIHN0eWxlPSJtYXgtaGVpZ2h0OjMwcHg7bWF4LXdpZHRoOjMwcHg7Ii8+CiAgICAgICAgICAgICA8YSBocmVmPSJ7e2l0ZW0uYWN0b3IucHJvZmlsZVVybH19Ij57e2l0ZW0uYWN0b3IubmFtZX19PC9hPgogICAgICAgICAgICAgPGEgaHJlZiBuZzpjbGljaz0iZXhwYW5kUmVwbGllcyhpdGVtKSIgc3R5bGU9ImZsb2F0OiByaWdodDsiPkV4cGFuZCByZXBsaWVzOiB7e2l0ZW0ubGlua3MucmVwbGllc1swXS5jb3VudH19PC9hPgogICAgICAgICAgIDwvaDE+CiAgICAgICAgICAge3tpdGVtLm9iamVjdC5jb250ZW50IHwgaHRtbH19CiAgICAgICAgICAgPGRpdiBuZzpyZXBlYXQ9InJlcGx5IGluIGl0ZW0ucmVwbGllcy5kYXRhLml0ZW1zIiBzdHlsZT0ibWFyZ2luLWxlZnQ6IDIwcHg7Ij4KICAgICAgICAgICAgIDxpbWcgc3JjPSJ7e3JlcGx5LmFjdG9yLnRodW1ibmFpbFVybH19IiBzdHlsZT0ibWF4LWhlaWdodDozMHB4O21heC13aWR0aDozMHB4OyIvPgogICAgICAgICAgICAgPGEgaHJlZj0ie3tyZXBseS5hY3Rvci5wcm9maWxlVXJsfX0iPnt7cmVwbHkuYWN0b3IubmFtZX19PC9hPjoge3tyZXBseS5jb250ZW50IHwgaHRtbH19CiAgICAgICAgICAgPC9kaXY+CiAgICAgICAgIDwvZGl2PgogICAgICAgPC9kaXY+CiAgICAgIDwvZG9jOnNvdXJjZT4KICAgICAgPGRvYzpzY2VuYXJpbz4KICAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICA8L2RvYzpleGFtcGxlPgogKi8KYW5ndWxhclNlcnZpY2VJbmplY3QoJyRyZXNvdXJjZScsIGZ1bmN0aW9uKCR4aHIpewogIHZhciByZXNvdXJjZSA9IG5ldyBSZXNvdXJjZUZhY3RvcnkoJHhocik7CiAgcmV0dXJuIGJpbmQocmVzb3VyY2UsIHJlc291cmNlLnJvdXRlKTsKfSwgWyckeGhyLmNhY2hlJ10pOwondXNlIHN0cmljdCc7CgovKioKICogQHdvcmtJblByb2dyZXNzCiAqIEBuZ2RvYyBzZXJ2aWNlCiAqIEBuYW1lIGFuZ3VsYXIuc2VydmljZS4kcm91dGUKICogQHJlcXVpcmVzICRsb2NhdGlvbgogKgogKiBAcHJvcGVydHkge09iamVjdH0gY3VycmVudCBSZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnQgcm91dGUgZGVmaW5pdGlvbi4KICogQHByb3BlcnR5IHtBcnJheS48T2JqZWN0Pn0gcm91dGVzIEFycmF5IG9mIGFsbCBjb25maWd1cmVkIHJvdXRlcy4KICoKICogQGRlc2NyaXB0aW9uCiAqIFdhdGNoZXMgYCRsb2NhdGlvbi5oYXNoUGF0aGAgYW5kIHRyaWVzIHRvIG1hcCB0aGUgaGFzaCB0byBhbiBleGlzdGluZyByb3V0ZQogKiBkZWZpbml0aW9uLiBJdCBpcyB1c2VkIGZvciBkZWVwLWxpbmtpbmcgVVJMcyB0byBjb250cm9sbGVycyBhbmQgdmlld3MgKEhUTUwgcGFydGlhbHMpLgogKgogKiBUaGUgYCRyb3V0ZWAgc2VydmljZSBpcyB0eXBpY2FsbHkgdXNlZCBpbiBjb25qdW5jdGlvbiB3aXRoIHtAbGluayBhbmd1bGFyLndpZGdldC5uZzp2aWV3IG5nOnZpZXd9CiAqIHdpZGdldC4KICoKICogQGV4YW1wbGUKICAgVGhpcyBleGFtcGxlIHNob3dzIGhvdyBjaGFuZ2luZyB0aGUgVVJMIGhhc2ggY2F1c2VzIHRoZSA8dHQ+JHJvdXRlPC90dD4KICAgdG8gbWF0Y2ggYSByb3V0ZSBhZ2FpbnN0IHRoZSBVUkwsIGFuZCB0aGUgPHR0Pltbbmc6aW5jbHVkZV1dPC90dD4gcHVsbHMgaW4gdGhlIHBhcnRpYWwuCiAgIFRyeSBjaGFuZ2luZyB0aGUgVVJMIGluIHRoZSBpbnB1dCBib3ggdG8gc2VlIGNoYW5nZXMuCgogICAgPGRvYzpleGFtcGxlPgogICAgICA8ZG9jOnNvdXJjZSBqc2ZpZGRsZT0iZmFsc2UiPgogICAgICAgIDxzY3JpcHQ+CiAgICAgICAgICBmdW5jdGlvbiBNYWluQ250bCgkcm91dGUsICRsb2NhdGlvbikgewogICAgICAgICAgICB0aGlzLiRyb3V0ZSA9ICRyb3V0ZTsKICAgICAgICAgICAgdGhpcy4kbG9jYXRpb24gPSAkbG9jYXRpb247CgogICAgICAgICAgICAkcm91dGUud2hlbignL0Jvb2svOmJvb2tJZCcsIHt0ZW1wbGF0ZTogJ2V4YW1wbGVzL2Jvb2suaHRtbCcsIGNvbnRyb2xsZXI6IEJvb2tDbnRsfSk7CiAgICAgICAgICAgICRyb3V0ZS53aGVuKCcvQm9vay86Ym9va0lkL2NoLzpjaGFwdGVySWQnLCB7dGVtcGxhdGU6ICdleGFtcGxlcy9jaGFwdGVyLmh0bWwnLCBjb250cm9sbGVyOiBDaGFwdGVyQ250bH0pOwogICAgICAgICAgICAkcm91dGUub25DaGFuZ2UoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgJHJvdXRlLmN1cnJlbnQuc2NvcGUucGFyYW1zID0gJHJvdXRlLmN1cnJlbnQucGFyYW1zOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KCiAgICAgICAgICBmdW5jdGlvbiBCb29rQ250bCgpIHsKICAgICAgICAgICAgdGhpcy5uYW1lID0gIkJvb2tDbnRsIjsKICAgICAgICAgIH0KCiAgICAgICAgICBmdW5jdGlvbiBDaGFwdGVyQ250bCgpIHsKICAgICAgICAgICAgdGhpcy5uYW1lID0gIkNoYXB0ZXJDbnRsIjsKICAgICAgICAgIH0KICAgICAgICA8L3NjcmlwdD4KCiAgICAgICAgPGRpdiBuZzpjb250cm9sbGVyPSJNYWluQ250bCI+CiAgICAgICAgICBDaG9vc2U6CiAgICAgICAgICA8YSBocmVmPSIjL0Jvb2svTW9ieSI+TW9ieTwvYT4gfAogICAgICAgICAgPGEgaHJlZj0iIy9Cb29rL01vYnkvY2gvMSI+TW9ieTogQ2gxPC9hPiB8CiAgICAgICAgICA8YSBocmVmPSIjL0Jvb2svR2F0c2J5Ij5HYXRzYnk8L2E+IHwKICAgICAgICAgIDxhIGhyZWY9IiMvQm9vay9HYXRzYnkvY2gvND9rZXk9dmFsdWUiPkdhdHNieTogQ2g0PC9hPjxici8+CiAgICAgICAgICAkbG9jYXRpb24uaGFzaFBhdGg6IDxpbnB1dCB0eXBlPSJ0ZXh0IiBuYW1lPSIkbG9jYXRpb24uaGFzaFBhdGgiIHNpemU9IjgwIiAvPgogICAgICAgICAgPHByZT4kcm91dGUuY3VycmVudC50ZW1wbGF0ZSA9IHt7JHJvdXRlLmN1cnJlbnQudGVtcGxhdGV9fTwvcHJlPgogICAgICAgICAgPHByZT4kcm91dGUuY3VycmVudC5wYXJhbXMgPSB7eyRyb3V0ZS5jdXJyZW50LnBhcmFtc319PC9wcmU+CiAgICAgICAgICA8cHJlPiRyb3V0ZS5jdXJyZW50LnNjb3BlLm5hbWUgPSB7eyRyb3V0ZS5jdXJyZW50LnNjb3BlLm5hbWV9fTwvcHJlPgogICAgICAgICAgPGhyIC8+CiAgICAgICAgICA8bmc6dmlldz48L25nOnZpZXc+CiAgICAgICAgPC9kaXY+CiAgICAgIDwvZG9jOnNvdXJjZT4KICAgICAgPGRvYzpzY2VuYXJpbz4KICAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICA8L2RvYzpleGFtcGxlPgogKi8KYW5ndWxhclNlcnZpY2VJbmplY3QoJyRyb3V0ZScsIGZ1bmN0aW9uKGxvY2F0aW9uLCAkdXBkYXRlVmlldykgewogIHZhciByb3V0ZXMgPSB7fSwKICAgICAgb25DaGFuZ2UgPSBbXSwKICAgICAgbWF0Y2hlciA9IHN3aXRjaFJvdXRlTWF0Y2hlciwKICAgICAgcGFyZW50U2NvcGUgPSB0aGlzLAogICAgICBkaXJ0eSA9IDAsCiAgICAgIGxhc3RIYXNoUGF0aCwKICAgICAgbGFzdFJvdXRlUGFyYW1zLAogICAgICAkcm91dGUgPSB7CiAgICAgICAgcm91dGVzOiByb3V0ZXMsCgogICAgICAgIC8qKgogICAgICAgICAqIEB3b3JrSW5Qcm9ncmVzcwogICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgKiBAbmFtZSBhbmd1bGFyLnNlcnZpY2UuJHJvdXRlI29uQ2hhbmdlCiAgICAgICAgICogQG1ldGhvZE9mIGFuZ3VsYXIuc2VydmljZS4kcm91dGUKICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oKX0gZm4gRnVuY3Rpb24gdGhhdCB3aWxsIGJlIGNhbGxlZCB3aGVuIGAkcm91dGUuY3VycmVudGAgY2hhbmdlcy4KICAgICAgICAgKiBAcmV0dXJucyB7ZnVuY3Rpb24oKX0gVGhlIHJlZ2lzdGVyZWQgZnVuY3Rpb24uCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBSZWdpc3RlciBhIGhhbmRsZXIgZnVuY3Rpb24gdGhhdCB3aWxsIGJlIGNhbGxlZCB3aGVuIHJvdXRlIGNoYW5nZXMKICAgICAgICAgKi8KICAgICAgICBvbkNoYW5nZTogZnVuY3Rpb24oZm4pIHsKICAgICAgICAgIG9uQ2hhbmdlLnB1c2goZm4pOwogICAgICAgICAgcmV0dXJuIGZuOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEB3b3JrSW5Qcm9ncmVzcwogICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgKiBAbmFtZSBhbmd1bGFyLnNlcnZpY2UuJHJvdXRlI3BhcmVudAogICAgICAgICAqIEBtZXRob2RPZiBhbmd1bGFyLnNlcnZpY2UuJHJvdXRlCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge1Njb3BlfSBbc2NvcGU9cm9vdFNjb3BlXSBTY29wZSB0byBiZSB1c2VkIGFzIHBhcmVudCBmb3IgbmV3bHkgY3JlYXRlZAogICAgICAgICAqICAgIGAkcm91dGUuY3VycmVudC5zY29wZWAgc2NvcGVzLgogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogU2V0cyBhIHNjb3BlIHRvIGJlIHVzZWQgYXMgdGhlIHBhcmVudCBzY29wZSBmb3Igc2NvcGVzIGNyZWF0ZWQgb24gcm91dGUgY2hhbmdlLiBJZiBub3QKICAgICAgICAgKiBzZXQsIGRlZmF1bHRzIHRvIHRoZSByb290IHNjb3BlLgogICAgICAgICAqLwogICAgICAgIHBhcmVudDogZnVuY3Rpb24oc2NvcGUpIHsKICAgICAgICAgIGlmIChzY29wZSkgcGFyZW50U2NvcGUgPSBzY29wZTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAd29ya0luUHJvZ3Jlc3MKICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICogQG5hbWUgYW5ndWxhci5zZXJ2aWNlLiRyb3V0ZSN3aGVuCiAgICAgICAgICogQG1ldGhvZE9mIGFuZ3VsYXIuc2VydmljZS4kcm91dGUKICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBwYXRoIFJvdXRlIHBhdGggKG1hdGNoZWQgYWdhaW5zdCBgJGxvY2F0aW9uLmhhc2hgKQogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBwYXJhbXMgTWFwcGluZyBpbmZvcm1hdGlvbiB0byBiZSBhc3NpZ25lZCB0byBgJHJvdXRlLmN1cnJlbnRgIG9uIHJvdXRlCiAgICAgICAgICogICAgbWF0Y2guCiAgICAgICAgICoKICAgICAgICAgKiAgICBPYmplY3QgcHJvcGVydGllczoKICAgICAgICAgKgogICAgICAgICAqICAgIC0gYGNvbnRyb2xsZXJgIOKAkyBge2Z1bmN0aW9uKCk9fWAg4oCTIENvbnRyb2xsZXIgZm4gdGhhdCBzaG91bGQgYmUgYXNzb2NpYXRlZCB3aXRoIG5ld2x5CiAgICAgICAgICogICAgICBjcmVhdGVkIHNjb3BlLgogICAgICAgICAqICAgIC0gYHRlbXBsYXRlYCDigJMgYHtzdHJpbmc9fWAg4oCTIHBhdGggdG8gYW4gaHRtbCB0ZW1wbGF0ZSB0aGF0IHNob3VsZCBiZSB1c2VkIGJ5CiAgICAgICAgICogICAgICB7QGxpbmsgYW5ndWxhci53aWRnZXQubmc6dmlldyBuZzp2aWV3fSBvcgogICAgICAgICAqICAgICAge0BsaW5rIGFuZ3VsYXIud2lkZ2V0Lm5nOmluY2x1ZGUgbmc6aW5jbHVkZX0gd2lkZ2V0cy4KICAgICAgICAgKiAgICAtIGByZWRpcmVjdFRvYCDigJMgeyhzdHJpbmd8ZnVuY3Rpb24oKSk9fSDigJMgdmFsdWUgdG8gdXBkYXRlCiAgICAgICAgICogICAgICB7QGxpbmsgYW5ndWxhci5zZXJ2aWNlLiRsb2NhdGlvbiAkbG9jYXRpb259IGhhc2ggd2l0aCBhbmQgdHJpZ2dlciByb3V0ZSByZWRpcmVjdGlvbi4KICAgICAgICAgKgogICAgICAgICAqICAgICAgSWYgYHJlZGlyZWN0VG9gIGlzIGEgZnVuY3Rpb24sIGl0IHdpbGwgYmUgY2FsbGVkIHdpdGggdGhlIGZvbGxvd2luZyBwYXJhbWV0ZXJzOgogICAgICAgICAqCiAgICAgICAgICogICAgICAtIGB7T2JqZWN0LjxzdHJpbmc+fWAgLSByb3V0ZSBwYXJhbWV0ZXJzIGV4dHJhY3RlZCBmcm9tIHRoZSBjdXJyZW50CiAgICAgICAgICogICAgICAgIGAkbG9jYXRpb24uaGFzaFBhdGhgIGJ5IGFwcGx5aW5nIHRoZSBjdXJyZW50IHJvdXRlIHRlbXBsYXRlLgogICAgICAgICAqICAgICAgLSBge3N0cmluZ31gIC0gY3VycmVudCBgJGxvY2F0aW9uLmhhc2hgCiAgICAgICAgICogICAgICAtIGB7c3RyaW5nfWAgLSBjdXJyZW50IGAkbG9jYXRpb24uaGFzaFBhdGhgCiAgICAgICAgICogICAgICAtIGB7c3RyaW5nfWAgLSBjdXJyZW50IGAkbG9jYXRpb24uaGFzaFNlYXJjaGAKICAgICAgICAgKgogICAgICAgICAqICAgICAgVGhlIGN1c3RvbSBgcmVkaXJlY3RUb2AgZnVuY3Rpb24gaXMgZXhwZWN0ZWQgdG8gcmV0dXJuIGEgc3RyaW5nIHdoaWNoIHdpbGwgYmUgdXNlZAogICAgICAgICAqICAgICAgdG8gdXBkYXRlIGAkbG9jYXRpb24uaGFzaGAuCiAgICAgICAgICoKICAgICAgICAgKiAgICAtIGBbcmVsb2FkT25TZWFyY2g9dHJ1ZV1gIC0ge2Jvb2xlYW49fSAtIHJlbG9hZCByb3V0ZSB3aGVuICRsb2NhdGlvbi5oYXNoU2VhcmNoCiAgICAgICAgICogICAgICBjaGFuZ2VzLiBJZiB0aGlzIG9wdGlvbiBpcyBkaXNhYmxlZCwgeW91IHNob3VsZCBzZXQgdXAgYSAkd2F0Y2ggdG8gYmUgbm90aWZpZWQgb2YKICAgICAgICAgKiAgICAgIHBhcmFtIChoYXNoU2VhcmNoKSBjaGFuZ2VzIGFzIGZvbGxvd3M6CiAgICAgICAgICoKICAgICAgICAgKiAgICAgICAgICAgIGZ1bmN0aW9uIE15Q3RybCgkcm91dGUpIHsKICAgICAgICAgKiAgICAgICAgICAgICAgdGhpcy4kd2F0Y2goZnVuY3Rpb24oKSB7CiAgICAgICAgICogICAgICAgICAgICAgICAgcmV0dXJuICRyb3V0ZS5jdXJyZW50LnBhcmFtcy5teUhhc2hTZWFyY2hQYXJhbTsKICAgICAgICAgKiAgICAgICAgICAgICAgfSwgZnVuY3Rpb24ocGFyYW1zKSB7CiAgICAgICAgICogICAgICAgICAgICAgICAgLy9kbyBzdHVmZiB3aXRoIHBhcmFtcwogICAgICAgICAqICAgICAgICAgICAgICB9KTsKICAgICAgICAgKiAgICAgICAgICAgIH0KICAgICAgICAgKgogICAgICAgICAqIEByZXR1cm5zIHtPYmplY3R9IHJvdXRlIG9iamVjdAogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogQWRkcyBhIG5ldyByb3V0ZSBkZWZpbml0aW9uIHRvIHRoZSBgJHJvdXRlYCBzZXJ2aWNlLgogICAgICAgICAqLwogICAgICAgIHdoZW46ZnVuY3Rpb24gKHBhdGgsIHBhcmFtcykgewogICAgICAgICAgaWYgKGlzVW5kZWZpbmVkKHBhdGgpKSByZXR1cm4gcm91dGVzOyAvL1RPRE8oaW0pOiByZW1vdmUgLSBub3QgbmVlZGVkIQogICAgICAgICAgdmFyIHJvdXRlID0gcm91dGVzW3BhdGhdOwogICAgICAgICAgaWYgKCFyb3V0ZSkgcm91dGUgPSByb3V0ZXNbcGF0aF0gPSB7cmVsb2FkT25TZWFyY2g6IHRydWV9OwogICAgICAgICAgaWYgKHBhcmFtcykgZXh0ZW5kKHJvdXRlLCBwYXJhbXMpOyAvL1RPRE8oaW0pOiB3aGF0IHRoZSBoZWNrPyBtZXJnZSB0d28gcm91dGUgZGVmaW5pdGlvbnM/CiAgICAgICAgICBkaXJ0eSsrOwogICAgICAgICAgcmV0dXJuIHJvdXRlOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEB3b3JrSW5Qcm9ncmVzcwogICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgKiBAbmFtZSBhbmd1bGFyLnNlcnZpY2UuJHJvdXRlI290aGVyd2lzZQogICAgICAgICAqIEBtZXRob2RPZiBhbmd1bGFyLnNlcnZpY2UuJHJvdXRlCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBTZXRzIHJvdXRlIGRlZmluaXRpb24gdGhhdCB3aWxsIGJlIHVzZWQgb24gcm91dGUgY2hhbmdlIHdoZW4gbm8gb3RoZXIgcm91dGUgZGVmaW5pdGlvbgogICAgICAgICAqIGlzIG1hdGNoZWQuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gcGFyYW1zIE1hcHBpbmcgaW5mb3JtYXRpb24gdG8gYmUgYXNzaWduZWQgdG8gYCRyb3V0ZS5jdXJyZW50YC4KICAgICAgICAgKi8KICAgICAgICBvdGhlcndpc2U6IGZ1bmN0aW9uKHBhcmFtcykgewogICAgICAgICAgJHJvdXRlLndoZW4obnVsbCwgcGFyYW1zKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAd29ya0luUHJvZ3Jlc3MKICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICogQG5hbWUgYW5ndWxhci5zZXJ2aWNlLiRyb3V0ZSNyZWxvYWQKICAgICAgICAgKiBAbWV0aG9kT2YgYW5ndWxhci5zZXJ2aWNlLiRyb3V0ZQogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogQ2F1c2VzIGAkcm91dGVgIHNlcnZpY2UgdG8gcmVsb2FkIChhbmQgcmVjcmVhdGUgdGhlIGAkcm91dGUuY3VycmVudGAgc2NvcGUpIHVwb24gdGhlIG5leHQKICAgICAgICAgKiBldmFsIGV2ZW4gaWYge0BsaW5rIGFuZ3VsYXIuc2VydmljZS4kbG9jYXRpb24gJGxvY2F0aW9ufSBoYXNuJ3QgY2hhbmdlZC4KICAgICAgICAgKi8KICAgICAgICByZWxvYWQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgZGlydHkrKzsKICAgICAgICB9CiAgICAgIH07CgoKICBmdW5jdGlvbiBzd2l0Y2hSb3V0ZU1hdGNoZXIob24sIHdoZW4sIGRzdE5hbWUpIHsKICAgIHZhciByZWdleCA9ICdeJyArIHdoZW4ucmVwbGFjZSgvW1wuXFxcKFwpXF5cJF0vZywgIlwkMSIpICsgJyQnLAogICAgICAgIHBhcmFtcyA9IFtdLAogICAgICAgIGRzdCA9IHt9OwogICAgZm9yRWFjaCh3aGVuLnNwbGl0KC9cVy8pLCBmdW5jdGlvbihwYXJhbSl7CiAgICAgIGlmIChwYXJhbSkgewogICAgICAgIHZhciBwYXJhbVJlZ0V4cCA9IG5ldyBSZWdFeHAoIjoiICsgcGFyYW0gKyAiKFtcXFddKSIpOwogICAgICAgIGlmIChyZWdleC5tYXRjaChwYXJhbVJlZ0V4cCkpIHsKICAgICAgICAgIHJlZ2V4ID0gcmVnZXgucmVwbGFjZShwYXJhbVJlZ0V4cCwgIihbXlwvXSopJDEiKTsKICAgICAgICAgIHBhcmFtcy5wdXNoKHBhcmFtKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogICAgdmFyIG1hdGNoID0gb24ubWF0Y2gobmV3IFJlZ0V4cChyZWdleCkpOwogICAgaWYgKG1hdGNoKSB7CiAgICAgIGZvckVhY2gocGFyYW1zLCBmdW5jdGlvbihuYW1lLCBpbmRleCl7CiAgICAgICAgZHN0W25hbWVdID0gbWF0Y2hbaW5kZXggKyAxXTsKICAgICAgfSk7CiAgICAgIGlmIChkc3ROYW1lKSB0aGlzLiRzZXQoZHN0TmFtZSwgZHN0KTsKICAgIH0KICAgIHJldHVybiBtYXRjaCA/IGRzdCA6IG51bGw7CiAgfQoKCiAgZnVuY3Rpb24gdXBkYXRlUm91dGUoKXsKICAgIHZhciBjaGlsZFNjb3BlLCByb3V0ZVBhcmFtcywgcGF0aFBhcmFtcywgc2VnbWVudE1hdGNoLCBrZXksIHJlZGlyOwoKICAgIGlmICgkcm91dGUuY3VycmVudCkgewogICAgICBpZiAoISRyb3V0ZS5jdXJyZW50LnJlbG9hZE9uU2VhcmNoICYmIChsYXN0SGFzaFBhdGggPT0gbG9jYXRpb24uaGFzaFBhdGgpKSB7CiAgICAgICAgJHJvdXRlLmN1cnJlbnQucGFyYW1zID0gZXh0ZW5kKHt9LCBsb2NhdGlvbi5oYXNoU2VhcmNoLCBsYXN0Um91dGVQYXJhbXMpOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgfQoKICAgIGxhc3RIYXNoUGF0aCA9IGxvY2F0aW9uLmhhc2hQYXRoOwogICAgJHJvdXRlLmN1cnJlbnQgPSBudWxsOwogICAgZm9yRWFjaChyb3V0ZXMsIGZ1bmN0aW9uKHJQYXJhbXMsIHJQYXRoKSB7CiAgICAgIGlmICghcGF0aFBhcmFtcykgewogICAgICAgIGlmIChwYXRoUGFyYW1zID0gbWF0Y2hlcihsb2NhdGlvbi5oYXNoUGF0aCwgclBhdGgpKSB7CiAgICAgICAgICByb3V0ZVBhcmFtcyA9IHJQYXJhbXM7CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKCiAgICAvLyAib3RoZXJ3aXNlIiBmYWxsYmFjawogICAgcm91dGVQYXJhbXMgPSByb3V0ZVBhcmFtcyB8fCByb3V0ZXNbbnVsbF07CgogICAgaWYocm91dGVQYXJhbXMpIHsKICAgICAgaWYgKHJvdXRlUGFyYW1zLnJlZGlyZWN0VG8pIHsKICAgICAgICBpZiAoaXNTdHJpbmcocm91dGVQYXJhbXMucmVkaXJlY3RUbykpIHsKICAgICAgICAgIC8vIGludGVycG9sYXRlIHRoZSByZWRpcmVjdFRvIHN0cmluZwogICAgICAgICAgcmVkaXIgPSB7aGFzaFBhdGg6ICcnLAogICAgICAgICAgICAgICAgICAgaGFzaFNlYXJjaDogZXh0ZW5kKHt9LCBsb2NhdGlvbi5oYXNoU2VhcmNoLCBwYXRoUGFyYW1zKX07CgogICAgICAgICAgZm9yRWFjaChyb3V0ZVBhcmFtcy5yZWRpcmVjdFRvLnNwbGl0KCc6JyksIGZ1bmN0aW9uKHNlZ21lbnQsIGkpIHsKICAgICAgICAgICAgaWYgKGk9PTApIHsKICAgICAgICAgICAgICByZWRpci5oYXNoUGF0aCArPSBzZWdtZW50OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHNlZ21lbnRNYXRjaCA9IHNlZ21lbnQubWF0Y2goLyhcdyspKC4qKS8pOwogICAgICAgICAgICAgIGtleSA9IHNlZ21lbnRNYXRjaFsxXTsKICAgICAgICAgICAgICByZWRpci5oYXNoUGF0aCArPSBwYXRoUGFyYW1zW2tleV0gfHwgbG9jYXRpb24uaGFzaFNlYXJjaFtrZXldOwogICAgICAgICAgICAgIHJlZGlyLmhhc2hQYXRoICs9IHNlZ21lbnRNYXRjaFsyXSB8fCAnJzsKICAgICAgICAgICAgICBkZWxldGUgcmVkaXIuaGFzaFNlYXJjaFtrZXldOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgLy8gY2FsbCBjdXN0b20gcmVkaXJlY3RUbyBmdW5jdGlvbgogICAgICAgICAgcmVkaXIgPSB7aGFzaDogcm91dGVQYXJhbXMucmVkaXJlY3RUbyhwYXRoUGFyYW1zLCBsb2NhdGlvbi5oYXNoLCBsb2NhdGlvbi5oYXNoUGF0aCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9jYXRpb24uaGFzaFNlYXJjaCl9OwogICAgICAgIH0KCiAgICAgICAgbG9jYXRpb24udXBkYXRlKHJlZGlyKTsKICAgICAgICAkdXBkYXRlVmlldygpOyAvL1RPRE8gdGhpcyBpcyB0byB3b3JrIGFyb3VuZCB0aGUgJGxvY2F0aW9uPD0+JGJyb3dzZXIgaXNzdWVzCiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBjaGlsZFNjb3BlID0gY3JlYXRlU2NvcGUocGFyZW50U2NvcGUpOwogICAgICAkcm91dGUuY3VycmVudCA9IGV4dGVuZCh7fSwgcm91dGVQYXJhbXMsIHsKICAgICAgICBzY29wZTogY2hpbGRTY29wZSwKICAgICAgICBwYXJhbXM6IGV4dGVuZCh7fSwgbG9jYXRpb24uaGFzaFNlYXJjaCwgcGF0aFBhcmFtcykKICAgICAgfSk7CiAgICAgIGxhc3RSb3V0ZVBhcmFtcyA9IHBhdGhQYXJhbXM7CiAgICB9CgogICAgLy9maXJlIG9uQ2hhbmdlIGNhbGxiYWNrcwogICAgZm9yRWFjaChvbkNoYW5nZSwgcGFyZW50U2NvcGUuJHRyeUV2YWwpOwoKICAgIGlmIChjaGlsZFNjb3BlKSB7CiAgICAgIGNoaWxkU2NvcGUuJGJlY29tZSgkcm91dGUuY3VycmVudC5jb250cm9sbGVyKTsKICAgIH0KICB9CgoKICB0aGlzLiR3YXRjaChmdW5jdGlvbigpeyByZXR1cm4gZGlydHkgKyBsb2NhdGlvbi5oYXNoOyB9LCB1cGRhdGVSb3V0ZSk7CgogIHJldHVybiAkcm91dGU7Cn0sIFsnJGxvY2F0aW9uJywgJyR1cGRhdGVWaWV3J10pOwondXNlIHN0cmljdCc7CgovKioKICogQHdvcmtJblByb2dyZXNzCiAqIEBuZ2RvYyBzZXJ2aWNlCiAqIEBuYW1lIGFuZ3VsYXIuc2VydmljZS4kdXBkYXRlVmlldwogKiBAcmVxdWlyZXMgJGJyb3dzZXIKICoKICogQGRlc2NyaXB0aW9uCiAqIENhbGxpbmcgYCR1cGRhdGVWaWV3YCBlbnF1ZXVlcyB0aGUgZXZlbnR1YWwgdXBkYXRlIG9mIHRoZSB2aWV3LiAoVXBkYXRlIHRoZSBET00gdG8gcmVmbGVjdCB0aGUKICogbW9kZWwpLiBUaGUgdXBkYXRlIGlzIGV2ZW50dWFsLCBzaW5jZSB0aGVyZSBhcmUgb2Z0ZW4gbXVsdGlwbGUgdXBkYXRlcyB0byB0aGUgbW9kZWwgd2hpY2ggbWF5CiAqIGJlIGRlZmVycmVkLiBUaGUgZGVmYXVsdCB1cGRhdGUgZGVsYXllZCBpcyAyNSBtcy4gVGhpcyBtZWFucyB0aGF0IHRoZSB2aWV3IGxhZ3MgdGhlIG1vZGVsIGJ5CiAqIHRoYXQgdGltZS4gKDI1bXMgaXMgc21hbGwgZW5vdWdoIHRoYXQgaXQgaXMgcGVyY2VpdmVkIGFzIGluc3RhbnRhbmVvdXMgYnkgdGhlIHVzZXIpLiBUaGUgZGVsYXkKICogY2FuIGJlIGFkanVzdGVkIGJ5IHNldHRpbmcgdGhlIGRlbGF5IHByb3BlcnR5IG9mIHRoZSBzZXJ2aWNlLgogKgogKiA8cHJlPmFuZ3VsYXIuc2VydmljZSgnJHVwZGF0ZVZpZXcnKS5kZWxheSA9IDEwPC9wcmU+CiAqCiAqIFRoZSBkZWxheSBpcyB0aGVyZSBzbyB0aGF0IG11bHRpcGxlIHVwZGF0ZXMgdG8gdGhlIG1vZGVsIHdoaWNoIG9jY3VyIHN1ZmZpY2llbnRseSBjbG9zZQogKiB0b2dldGhlciBjYW4gYmUgbWVyZ2VkIGludG8gYSBzaW5nbGUgdXBkYXRlLgogKgogKiBZb3UgZG9uJ3QgdXN1YWxseSBjYWxsICckdXBkYXRlVmlldycgZGlyZWN0bHkgc2luY2UgYW5ndWxhciBkb2VzIGl0IGZvciB5b3UgaW4gbW9zdCBjYXNlcywKICogYnV0IHRoZXJlIGFyZSBzb21lIGNhc2VzIHdoZW4geW91IG5lZWQgdG8gY2FsbCBpdC4KICoKICogIC0gYCR1cGRhdGVWaWV3KClgIGNhbGxlZCBhdXRvbWF0aWNhbGx5IGJ5IGFuZ3VsYXI6CiAqICAgIC0gWW91ciBBcHBsaWNhdGlvbiBDb250cm9sbGVyczogWW91ciBjb250cm9sbGVyIGNvZGUgaXMgY2FsbGVkIGJ5IGFuZ3VsYXIgYW5kIGhlbmNlCiAqICAgICAgYW5ndWxhciBpcyBhd2FyZSB0aGF0IHlvdSBtYXkgaGF2ZSBjaGFuZ2VkIHRoZSBtb2RlbC4KICogICAgLSBZb3VyIFNlcnZpY2VzOiBZb3VyIHNlcnZpY2UgaXMgdXN1YWxseSBjYWxsZWQgYnkgeW91ciBjb250cm9sbGVyIGNvZGUsIGhlbmNlIHNhbWUgcnVsZXMKICogICAgICBhcHBseS4KICogIC0gTWF5IG5lZWQgdG8gY2FsbCBgJHVwZGF0ZVZpZXcoKWAgbWFudWFsbHk6CiAqICAgIC0gV2lkZ2V0cyAvIERpcmVjdGl2ZXM6IElmIHlvdSBsaXN0ZW4gdG8gYW55IERPTSBldmVudHMgb3IgZXZlbnRzIG9uIGFueSB0aGlyZCBwYXJ0eQogKiAgICAgIGxpYnJhcmllcywgdGhlbiBhbmd1bGFyIGlzIG5vdCBhd2FyZSB0aGF0IHlvdSBtYXkgaGF2ZSBjaGFuZ2VkIHN0YXRlIHN0YXRlIG9mIHRoZQogKiAgICAgIG1vZGVsLCBhbmQgaGVuY2UgeW91IG5lZWQgdG8gY2FsbCAnJHVwZGF0ZVZpZXcoKScgbWFudWFsbHkuCiAqICAgIC0gJ3NldFRpbWVvdXQnLydYSFInOiAgSWYgeW91IGNhbGwgJ3NldFRpbWVvdXQnIChpbnN0ZWFkIG9mIHtAbGluayBhbmd1bGFyLnNlcnZpY2UuJGRlZmVyfSkKICogICAgICBvciAnWEhSJyAoaW5zdGVhZCBvZiB7QGxpbmsgYW5ndWxhci5zZXJ2aWNlLiR4aHJ9KSB0aGVuIHlvdSBtYXkgYmUgY2hhbmdpbmcgdGhlIG1vZGVsCiAqICAgICAgd2l0aG91dCBhbmd1bGFyIGtub3dsZWRnZSBhbmQgeW91IG1heSBuZWVkIHRvIGNhbGwgJyR1cGRhdGVWaWV3KCknIGRpcmVjdGx5LgogKgogKiBOb3RlOiBpZiB5b3Ugd2lzaCB0byB1cGRhdGUgdGhlIHZpZXcgaW1tZWRpYXRlbHkgKHdpdGhvdXQgZGVsYXkpLCB5b3UgY2FuIGRvIHNvIGJ5IGNhbGxpbmcKICoge0BsaW5rIGFuZ3VsYXIuc2NvcGUuJGV2YWx9IGF0IGFueSB0aW1lIGZyb20geW91ciBjb2RlOgogKiA8cHJlPnNjb3BlLiRyb290LiRldmFsKCk8L3ByZT4KICoKICogSW4gdW5pdC10ZXN0IG1vZGUgdGhlIHVwZGF0ZSBpcyBpbnN0YW50YW5lb3VzIGFuZCBzeW5jaHJvbm91cyB0byBzaW1wbGlmeSB3cml0aW5nIHRlc3RzLgogKgogKi8KCmZ1bmN0aW9uIHNlcnZpY2VVcGRhdGVWaWV3RmFjdG9yeSgkYnJvd3Nlcil7CiAgdmFyIHJvb3RTY29wZSA9IHRoaXM7CiAgdmFyIHNjaGVkdWxlZDsKICBmdW5jdGlvbiB1cGRhdGUoKXsKICAgIHNjaGVkdWxlZCA9IGZhbHNlOwogICAgcm9vdFNjb3BlLiRldmFsKCk7CiAgfQogIHJldHVybiAkYnJvd3Nlci5pc01vY2sgPyB1cGRhdGUgOiBmdW5jdGlvbigpewogICAgaWYgKCFzY2hlZHVsZWQpIHsKICAgICAgc2NoZWR1bGVkID0gdHJ1ZTsKICAgICAgJGJyb3dzZXIuZGVmZXIodXBkYXRlLCBzZXJ2aWNlVXBkYXRlVmlld0ZhY3RvcnkuZGVsYXkpOwogICAgfQogIH07Cn0Kc2VydmljZVVwZGF0ZVZpZXdGYWN0b3J5LmRlbGF5ID0gMjU7Cgphbmd1bGFyU2VydmljZUluamVjdCgnJHVwZGF0ZVZpZXcnLCBzZXJ2aWNlVXBkYXRlVmlld0ZhY3RvcnksIFsnJGJyb3dzZXInXSk7Cid1c2Ugc3RyaWN0JzsKCi8qKgogKiBAd29ya0luUHJvZ3Jlc3MKICogQG5nZG9jIHNlcnZpY2UKICogQG5hbWUgYW5ndWxhci5zZXJ2aWNlLiR3aW5kb3cKICoKICogQGRlc2NyaXB0aW9uCiAqIEEgcmVmZXJlbmNlIHRvIHRoZSBicm93c2VyJ3MgYHdpbmRvd2Agb2JqZWN0LiBXaGlsZSBgd2luZG93YAogKiBpcyBnbG9iYWxseSBhdmFpbGFibGUgaW4gSmF2YVNjcmlwdCwgaXQgY2F1c2VzIHRlc3RhYmlsaXR5IHByb2JsZW1zLCBiZWNhdXNlCiAqIGl0IGlzIGEgZ2xvYmFsIHZhcmlhYmxlLiBJbiBhbmd1bGFyIHdlIGFsd2F5cyByZWZlciB0byBpdCB0aHJvdWdoIHRoZQogKiBgJHdpbmRvd2Agc2VydmljZSwgc28gaXQgbWF5IGJlIG92ZXJyaWRlbiwgcmVtb3ZlZCBvciBtb2NrZWQgZm9yIHRlc3RpbmcuCiAqCiAqIEFsbCBleHByZXNzaW9ucyBhcmUgZXZhbHVhdGVkIHdpdGggcmVzcGVjdCB0byBjdXJyZW50IHNjb3BlIHNvIHRoZXkgZG9uJ3QKICogc3VmZmVyIGZyb20gd2luZG93IGdsb2JhbGl0eS4KICoKICogQGV4YW1wbGUKICAgPGRvYzpleGFtcGxlPgogICAgIDxkb2M6c291cmNlPgogICAgICAgPGlucHV0IG5nOmluaXQ9IiR3aW5kb3cgPSAkc2VydmljZSgnJHdpbmRvdycpOyBncmVldGluZz0nSGVsbG8gV29ybGQhJyIgdHlwZT0idGV4dCIgbmFtZT0iZ3JlZXRpbmciIC8+CiAgICAgICA8YnV0dG9uIG5nOmNsaWNrPSIkd2luZG93LmFsZXJ0KGdyZWV0aW5nKSI+QUxFUlQ8L2J1dHRvbj4KICAgICA8L2RvYzpzb3VyY2U+CiAgICAgPGRvYzpzY2VuYXJpbz4KICAgICA8L2RvYzpzY2VuYXJpbz4KICAgPC9kb2M6ZXhhbXBsZT4KICovCmFuZ3VsYXJTZXJ2aWNlSW5qZWN0KCIkd2luZG93IiwgYmluZCh3aW5kb3csIGlkZW50aXR5LCB3aW5kb3cpKTsKJ3VzZSBzdHJpY3QnOwoKLyoqCiAqIEB3b3JrSW5Qcm9ncmVzcwogKiBAbmdkb2Mgc2VydmljZQogKiBAbmFtZSBhbmd1bGFyLnNlcnZpY2UuJHhoci5idWxrCiAqIEByZXF1aXJlcyAkeGhyCiAqIEByZXF1aXJlcyAkeGhyLmVycm9yCiAqIEByZXF1aXJlcyAkbG9nCiAqCiAqIEBkZXNjcmlwdGlvbgogKgogKiBAZXhhbXBsZQogKi8KYW5ndWxhclNlcnZpY2VJbmplY3QoJyR4aHIuYnVsaycsIGZ1bmN0aW9uKCR4aHIsICRlcnJvciwgJGxvZyl7CiAgdmFyIHJlcXVlc3RzID0gW10sCiAgICAgIHNjb3BlID0gdGhpczsKICBmdW5jdGlvbiBidWxrWEhSKG1ldGhvZCwgdXJsLCBwb3N0LCBzdWNjZXNzLCBlcnJvcikgewogICAgaWYgKGlzRnVuY3Rpb24ocG9zdCkpIHsKICAgICAgZXJyb3IgPSBzdWNjZXNzOwogICAgICBzdWNjZXNzID0gcG9zdDsKICAgICAgcG9zdCA9IG51bGw7CiAgICB9CiAgICB2YXIgY3VycmVudFF1ZXVlOwogICAgZm9yRWFjaChidWxrWEhSLnVybHMsIGZ1bmN0aW9uKHF1ZXVlKXsKICAgICAgaWYgKGlzRnVuY3Rpb24ocXVldWUubWF0Y2gpID8gcXVldWUubWF0Y2godXJsKSA6IHF1ZXVlLm1hdGNoLmV4ZWModXJsKSkgewogICAgICAgIGN1cnJlbnRRdWV1ZSA9IHF1ZXVlOwogICAgICB9CiAgICB9KTsKICAgIGlmIChjdXJyZW50UXVldWUpIHsKICAgICAgaWYgKCFjdXJyZW50UXVldWUucmVxdWVzdHMpIGN1cnJlbnRRdWV1ZS5yZXF1ZXN0cyA9IFtdOwogICAgICB2YXIgcmVxdWVzdCA9IHsKICAgICAgICAgIG1ldGhvZDogbWV0aG9kLAogICAgICAgICAgdXJsOiB1cmwsCiAgICAgICAgICBkYXRhOiBwb3N0LAogICAgICAgICAgc3VjY2Vzczogc3VjY2Vzc307CiAgICAgIGlmIChlcnJvcikgcmVxdWVzdC5lcnJvciA9IGVycm9yOwogICAgICBjdXJyZW50UXVldWUucmVxdWVzdHMucHVzaChyZXF1ZXN0KTsKICAgIH0gZWxzZSB7CiAgICAgICR4aHIobWV0aG9kLCB1cmwsIHBvc3QsIHN1Y2Nlc3MsIGVycm9yKTsKICAgIH0KICB9CiAgYnVsa1hIUi51cmxzID0ge307CiAgYnVsa1hIUi5mbHVzaCA9IGZ1bmN0aW9uKHN1Y2Nlc3MsIGVycm9yKSB7CiAgICBmb3JFYWNoKGJ1bGtYSFIudXJscywgZnVuY3Rpb24ocXVldWUsIHVybCkgewogICAgICB2YXIgY3VycmVudFJlcXVlc3RzID0gcXVldWUucmVxdWVzdHM7CiAgICAgIGlmIChjdXJyZW50UmVxdWVzdHMgJiYgY3VycmVudFJlcXVlc3RzLmxlbmd0aCkgewogICAgICAgIHF1ZXVlLnJlcXVlc3RzID0gW107CiAgICAgICAgcXVldWUuY2FsbGJhY2tzID0gW107CiAgICAgICAgJHhocignUE9TVCcsIHVybCwge3JlcXVlc3RzOiBjdXJyZW50UmVxdWVzdHN9LAogICAgICAgICAgZnVuY3Rpb24oY29kZSwgcmVzcG9uc2UsIHJlc3BvbnNlSGVhZGVycykgewogICAgICAgICAgICBmb3JFYWNoKHJlc3BvbnNlLCBmdW5jdGlvbihyZXNwb25zZSwgaSkgewogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBpZiAocmVzcG9uc2Uuc3RhdHVzID09IDIwMCkgewogICAgICAgICAgICAgICAgICAoY3VycmVudFJlcXVlc3RzW2ldLnN1Y2Nlc3MgfHwgbm9vcCkKICAgICAgICAgICAgICAgICAgICAgIChyZXNwb25zZS5zdGF0dXMsIHJlc3BvbnNlLnJlc3BvbnNlLCByZXNwb25zZUhlYWRlcnMpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChpc0Z1bmN0aW9uKGN1cnJlbnRSZXF1ZXN0c1tpXS5lcnJvcikpIHsKICAgICAgICAgICAgICAgICAgICBjdXJyZW50UmVxdWVzdHNbaV0uZXJyb3IocmVzcG9uc2Uuc3RhdHVzLCByZXNwb25zZS5yZXNwb25zZSwgcmVzcG9uc2VIZWFkZXJzKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICRlcnJvcihjdXJyZW50UmVxdWVzdHNbaV0sIHJlc3BvbnNlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGNhdGNoKGUpIHsKICAgICAgICAgICAgICAgICRsb2cuZXJyb3IoZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgKHN1Y2Nlc3MgfHwgbm9vcCkoKTsKICAgICAgICAgIH0sCiAgICAgICAgICBmdW5jdGlvbihjb2RlLCByZXNwb25zZSwgcmVzcG9uc2VIZWFkZXJzKSB7CiAgICAgICAgICAgIGZvckVhY2goY3VycmVudFJlcXVlc3RzLCBmdW5jdGlvbihyZXF1ZXN0LCBpKSB7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGlmIChpc0Z1bmN0aW9uKHJlcXVlc3QuZXJyb3IpKSB7CiAgICAgICAgICAgICAgICAgIHJlcXVlc3QuZXJyb3IoY29kZSwgcmVzcG9uc2UsIHJlc3BvbnNlSGVhZGVycyk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAkZXJyb3IocmVxdWVzdCwgcmVzcG9uc2UpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gY2F0Y2goZSkgewogICAgICAgICAgICAgICAgJGxvZy5lcnJvcihlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAoZXJyb3IgfHwgbm9vcCkoKTsKICAgICAgICAgIH0pOwogICAgICAgIHNjb3BlLiRldmFsKCk7CiAgICAgIH0KICAgIH0pOwogIH07CiAgdGhpcy4kb25FdmFsKFBSSU9SSVRZX0xBU1QsIGJ1bGtYSFIuZmx1c2gpOwogIHJldHVybiBidWxrWEhSOwp9LCBbJyR4aHInLCAnJHhoci5lcnJvcicsICckbG9nJ10pOwondXNlIHN0cmljdCc7CgovKioKICogQHdvcmtJblByb2dyZXNzCiAqIEBuZ2RvYyBzZXJ2aWNlCiAqIEBuYW1lIGFuZ3VsYXIuc2VydmljZS4keGhyLmNhY2hlCiAqIEBmdW5jdGlvbgogKgogKiBAcmVxdWlyZXMgJHhoci5idWxrCiAqIEByZXF1aXJlcyAkZGVmZXIKICogQHJlcXVpcmVzICR4aHIuZXJyb3IKICogQHJlcXVpcmVzICRsb2cKICoKICogQGRlc2NyaXB0aW9uCiAqIEFjdHMganVzdCBsaWtlIHRoZSB7QGxpbmsgYW5ndWxhci5zZXJ2aWNlLiR4aHIgJHhocn0gc2VydmljZSBidXQgY2FjaGVzIHJlc3BvbnNlcyBmb3IgYEdFVGAKICogcmVxdWVzdHMuIEFsbCBjYWNoZSBtaXNzZXMgYXJlIGRlbGVnYXRlZCB0byB0aGUgJHhociBzZXJ2aWNlLgogKgogKiBAcHJvcGVydHkge2Z1bmN0aW9uKCl9IGRlbGVnYXRlIEZ1bmN0aW9uIHRvIGRlbGVnYXRlIGFsbCB0aGUgY2FjaGUgbWlzc2VzIHRvLiBEZWZhdWx0cyB0bwogKiAgIHRoZSB7QGxpbmsgYW5ndWxhci5zZXJ2aWNlLiR4aHIgJHhocn0gc2VydmljZS4KICogQHByb3BlcnR5IHtvYmplY3R9IGRhdGEgVGhlIGhhc2htYXAgd2hlcmUgYWxsIGNhY2hlZCBlbnRyaWVzIGFyZSBzdG9yZWQuCiAqCiAqIEBwYXJhbSB7c3RyaW5nfSBtZXRob2QgSFRUUCBtZXRob2QuCiAqIEBwYXJhbSB7c3RyaW5nfSB1cmwgRGVzdGluYXRpb24gVVJMLgogKiBAcGFyYW0geyhzdHJpbmd8T2JqZWN0KT19IHBvc3QgUmVxdWVzdCBib2R5LgogKiBAcGFyYW0ge2Z1bmN0aW9uKG51bWJlciwgKHN0cmluZ3xPYmplY3QpLCBGdW5jdGlvbil9IHN1Y2Nlc3MgUmVzcG9uc2Ugc3VjY2VzcyBjYWxsYmFjay4KICogQHBhcmFtIHtmdW5jdGlvbihudW1iZXIsIChzdHJpbmd8T2JqZWN0KSwgRnVuY3Rpb24pfSBlcnJvciBSZXNwb25zZSBlcnJvciBjYWxsYmFjay4KICogQHBhcmFtIHtib29sZWFuPX0gW3ZlcmlmeUNhY2hlPWZhbHNlXSBJZiBgdHJ1ZWAgdGhlbiBhIHJlc3VsdCBpcyBpbW1lZGlhdGVseSByZXR1cm5lZCBmcm9tIGNhY2hlCiAqICAgKGlmIHByZXNlbnQpIHdoaWxlIGEgcmVxdWVzdCBpcyBzZW50IHRvIHRoZSBzZXJ2ZXIgZm9yIGEgZnJlc2ggcmVzcG9uc2UgdGhhdCB3aWxsIHVwZGF0ZSB0aGUKICogICBjYWNoZWQgZW50cnkuIFRoZSBgc3VjY2Vzc2AgZnVuY3Rpb24gd2lsbCBiZSBjYWxsZWQgd2hlbiB0aGUgcmVzcG9uc2UgaXMgcmVjZWl2ZWQuCiAqIEBwYXJhbSB7Ym9vbGVhbj19IFtzeW5jPWZhbHNlXSBpbiBjYXNlIG9mIGNhY2hlIGhpdCBleGVjdXRlIGBzdWNjZXNzYCBzeW5jaHJvbm91c2x5LgogKi8KYW5ndWxhclNlcnZpY2VJbmplY3QoJyR4aHIuY2FjaGUnLCBmdW5jdGlvbigkeGhyLCAkZGVmZXIsICRlcnJvciwgJGxvZykgewogIHZhciBpbmZsaWdodCA9IHt9LCBzZWxmID0gdGhpczsKICBmdW5jdGlvbiBjYWNoZShtZXRob2QsIHVybCwgcG9zdCwgc3VjY2VzcywgZXJyb3IsIHZlcmlmeUNhY2hlLCBzeW5jKSB7CiAgICBpZiAoaXNGdW5jdGlvbihwb3N0KSkgewogICAgICBpZiAoIWlzRnVuY3Rpb24oc3VjY2VzcykpIHsKICAgICAgICB2ZXJpZnlDYWNoZSA9IHN1Y2Nlc3M7CiAgICAgICAgc3luYyA9IGVycm9yOwogICAgICAgIGVycm9yID0gbnVsbDsKICAgICAgfSBlbHNlIHsKICAgICAgICBzeW5jID0gdmVyaWZ5Q2FjaGU7CiAgICAgICAgdmVyaWZ5Q2FjaGUgPSBlcnJvcjsKICAgICAgICBlcnJvciA9IHN1Y2Nlc3M7CiAgICAgIH0KICAgICAgc3VjY2VzcyA9IHBvc3Q7CiAgICAgIHBvc3QgPSBudWxsOwogICAgfSBlbHNlIGlmICghaXNGdW5jdGlvbihlcnJvcikpIHsKICAgICAgc3luYyA9IHZlcmlmeUNhY2hlOwogICAgICB2ZXJpZnlDYWNoZSA9IGVycm9yOwogICAgICBlcnJvciA9IG51bGw7CiAgICB9CgogICAgaWYgKG1ldGhvZCA9PSAnR0VUJykgewogICAgICB2YXIgZGF0YSwgZGF0YUNhY2hlZDsKICAgICAgaWYgKGRhdGFDYWNoZWQgPSBjYWNoZS5kYXRhW3VybF0pIHsKCiAgICAgICAgaWYgKHN5bmMpIHsKICAgICAgICAgIHN1Y2Nlc3MoMjAwLCBjb3B5KGRhdGFDYWNoZWQudmFsdWUpLCBjb3B5KGRhdGFDYWNoZWQuaGVhZGVycykpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAkZGVmZXIoZnVuY3Rpb24oKSB7IHN1Y2Nlc3MoMjAwLCBjb3B5KGRhdGFDYWNoZWQudmFsdWUpLCBjb3B5KGRhdGFDYWNoZWQuaGVhZGVycykpOyB9KTsKICAgICAgICB9CgogICAgICAgIGlmICghdmVyaWZ5Q2FjaGUpCiAgICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIGlmIChkYXRhID0gaW5mbGlnaHRbdXJsXSkgewogICAgICAgIGRhdGEuc3VjY2Vzc2VzLnB1c2goc3VjY2Vzcyk7CiAgICAgICAgZGF0YS5lcnJvcnMucHVzaChlcnJvcik7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaW5mbGlnaHRbdXJsXSA9IHtzdWNjZXNzZXM6IFtzdWNjZXNzXSwgZXJyb3JzOiBbZXJyb3JdfTsKICAgICAgICBjYWNoZS5kZWxlZ2F0ZShtZXRob2QsIHVybCwgcG9zdCwKICAgICAgICAgIGZ1bmN0aW9uKHN0YXR1cywgcmVzcG9uc2UsIHJlc3BvbnNlSGVhZGVycykgewogICAgICAgICAgICBpZiAoc3RhdHVzID09IDIwMCkKICAgICAgICAgICAgICBjYWNoZS5kYXRhW3VybF0gPSB7dmFsdWU6IHJlc3BvbnNlLCBoZWFkZXJzOiByZXNwb25zZUhlYWRlcnN9OwogICAgICAgICAgICB2YXIgc3VjY2Vzc2VzID0gaW5mbGlnaHRbdXJsXS5zdWNjZXNzZXM7CiAgICAgICAgICAgIGRlbGV0ZSBpbmZsaWdodFt1cmxdOwogICAgICAgICAgICBmb3JFYWNoKHN1Y2Nlc3NlcywgZnVuY3Rpb24oc3VjY2VzcykgewogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAoc3VjY2Vzc3x8bm9vcCkoc3RhdHVzLCBjb3B5KHJlc3BvbnNlKSwgcmVzcG9uc2VIZWFkZXJzKTsKICAgICAgICAgICAgICB9IGNhdGNoKGUpIHsKICAgICAgICAgICAgICAgICRsb2cuZXJyb3IoZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0sCiAgICAgICAgICBmdW5jdGlvbihzdGF0dXMsIHJlc3BvbnNlLCByZXNwb25zZUhlYWRlcnMpIHsKICAgICAgICAgICAgdmFyIGVycm9ycyA9IGluZmxpZ2h0W3VybF0uZXJyb3JzLAogICAgICAgICAgICAgICAgc3VjY2Vzc2VzID0gaW5mbGlnaHRbdXJsXS5zdWNjZXNzZXM7CiAgICAgICAgICAgIGRlbGV0ZSBpbmZsaWdodFt1cmxdOwoKICAgICAgICAgICAgZm9yRWFjaChlcnJvcnMsIGZ1bmN0aW9uKGVycm9yLCBpKSB7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGlmIChpc0Z1bmN0aW9uKGVycm9yKSkgewogICAgICAgICAgICAgICAgICBlcnJvcihzdGF0dXMsIGNvcHkocmVzcG9uc2UpLCBjb3B5KHJlc3BvbnNlSGVhZGVycykpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgJGVycm9yKAogICAgICAgICAgICAgICAgICAgIHttZXRob2Q6IG1ldGhvZCwgdXJsOiB1cmwsIGRhdGE6IHBvc3QsIHN1Y2Nlc3M6IHN1Y2Nlc3Nlc1tpXX0sCiAgICAgICAgICAgICAgICAgICAge3N0YXR1czogc3RhdHVzLCBib2R5OiByZXNwb25zZX0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gY2F0Y2goZSkgewogICAgICAgICAgICAgICAgJGxvZy5lcnJvcihlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSk7CiAgICAgIH0KCiAgICB9IGVsc2UgewogICAgICBjYWNoZS5kYXRhID0ge307CiAgICAgIGNhY2hlLmRlbGVnYXRlKG1ldGhvZCwgdXJsLCBwb3N0LCBzdWNjZXNzLCBlcnJvcik7CiAgICB9CiAgfQogIGNhY2hlLmRhdGEgPSB7fTsKICBjYWNoZS5kZWxlZ2F0ZSA9ICR4aHI7CiAgcmV0dXJuIGNhY2hlOwp9LCBbJyR4aHIuYnVsaycsICckZGVmZXInLCAnJHhoci5lcnJvcicsICckbG9nJ10pOwondXNlIHN0cmljdCc7CgovKioKICogQHdvcmtJblByb2dyZXNzCiAqIEBuZ2RvYyBzZXJ2aWNlCiAqIEBuYW1lIGFuZ3VsYXIuc2VydmljZS4keGhyLmVycm9yCiAqIEBmdW5jdGlvbgogKiBAcmVxdWlyZXMgJGxvZwogKgogKiBAZGVzY3JpcHRpb24KICogRXJyb3IgaGFuZGxlciBmb3Ige0BsaW5rIGFuZ3VsYXIuc2VydmljZS4keGhyICR4aHIgc2VydmljZX0uIEFuIGFwcGxpY2F0aW9uIGNhbiByZXBsYWNlcyB0aGlzCiAqIHNlcnZpY2Ugd2l0aCBvbmUgc3BlY2lmaWMgZm9yIHRoZSBhcHBsaWNhdGlvbi4gVGhlIGRlZmF1bHQgaW1wbGVtZW50YXRpb24gbG9ncyB0aGUgZXJyb3IgdG8KICoge0BsaW5rIGFuZ3VsYXIuc2VydmljZS4kbG9nICRsb2cuZXJyb3J9LgogKgogKiBAcGFyYW0ge09iamVjdH0gcmVxdWVzdCBSZXF1ZXN0IG9iamVjdC4KICoKICogICBUaGUgb2JqZWN0IGhhcyB0aGUgZm9sbG93aW5nIHByb3BlcnRpZXMKICoKICogICAtIGBtZXRob2RgIOKAkyBge3N0cmluZ31gIOKAkyBUaGUgaHR0cCByZXF1ZXN0IG1ldGhvZC4KICogICAtIGB1cmxgIOKAkyBge3N0cmluZ31gIOKAkyBUaGUgcmVxdWVzdCBkZXN0aW5hdGlvbi4KICogICAtIGBkYXRhYCDigJMgYHsoc3RyaW5nfE9iamVjdCk9fSDigJMgQW4gb3B0aW9uYWwgcmVxdWVzdCBib2R5LgogKiAgIC0gYHN1Y2Nlc3NgIOKAkyBge2Z1bmN0aW9uKCl9YCDigJMgVGhlIHN1Y2Nlc3MgY2FsbGJhY2sgZnVuY3Rpb24KICoKICogQHBhcmFtIHtPYmplY3R9IHJlc3BvbnNlIFJlc3BvbnNlIG9iamVjdC4KICoKICogICBUaGUgcmVzcG9uc2Ugb2JqZWN0IGhhcyB0aGUgZm9sbG93aW5nIHByb3BlcnRpZXM6CiAqCiAqICAgLSBzdGF0dXMg4oCTIHtudW1iZXJ9IOKAkyBIdHRwIHN0YXR1cyBjb2RlLgogKiAgIC0gYm9keSDigJMge3N0cmluZ3xPYmplY3R9IOKAkyBCb2R5IG9mIHRoZSByZXNwb25zZS4KICoKICogQGV4YW1wbGUKICAgIDxkb2M6ZXhhbXBsZT4KICAgICAgPGRvYzpzb3VyY2U+CiAgICAgICAgZmV0Y2ggYSBub24tZXhpc3RlbnQgZmlsZSBhbmQgbG9nIGFuIGVycm9yIGluIHRoZSBjb25zb2xlOgogICAgICAgIDxidXR0b24gbmc6Y2xpY2s9IiRzZXJ2aWNlKCckeGhyJykoJ0dFVCcsICcvRE9FU05UX0VYSVNUJykiPmZldGNoPC9idXR0b24+CiAgICAgIDwvZG9jOnNvdXJjZT4KICAgIDwvZG9jOmV4YW1wbGU+CiAqLwphbmd1bGFyU2VydmljZUluamVjdCgnJHhoci5lcnJvcicsIGZ1bmN0aW9uKCRsb2cpewogIHJldHVybiBmdW5jdGlvbihyZXF1ZXN0LCByZXNwb25zZSl7CiAgICAkbG9nLmVycm9yKCdFUlJPUjogWEhSOiAnICsgcmVxdWVzdC51cmwsIHJlcXVlc3QsIHJlc3BvbnNlKTsKICB9Owp9LCBbJyRsb2cnXSk7Cid1c2Ugc3RyaWN0JzsKCi8qKgogKiBAd29ya0luUHJvZ3Jlc3MKICogQG5nZG9jIHNlcnZpY2UKICogQG5hbWUgYW5ndWxhci5zZXJ2aWNlLiR4aHIKICogQGZ1bmN0aW9uCiAqIEByZXF1aXJlcyAkYnJvd3NlciAkeGhyIGRlbGVnYXRlcyBhbGwgWEhSIHJlcXVlc3RzIHRvIHRoZSBgJGJyb3dzZXIueGhyKClgLiBBIG1vY2sgdmVyc2lvbgogKiAgICAgICAgICAgICAgICAgICAgb2YgdGhlICRicm93c2VyIGV4aXN0cyB3aGljaCBhbGxvd3Mgc2V0dGluZyBleHBlY3RhdGlvbnMgb24gWEhSIHJlcXVlc3RzCiAqICAgICAgICAgICAgICAgICAgICBpbiB5b3VyIHRlc3RzCiAqIEByZXF1aXJlcyAkeGhyLmVycm9yICR4aHIgZGVsZWdhdGVzIGFsbCBub24gYDJ4eGAgcmVzcG9uc2UgY29kZSB0byB0aGlzIHNlcnZpY2UuCiAqIEByZXF1aXJlcyAkbG9nICR4aHIgZGVsZWdhdGVzIGFsbCBleGNlcHRpb25zIHRvIGAkbG9nLmVycm9yKClgLgogKiBAcmVxdWlyZXMgJHVwZGF0ZVZpZXcgQWZ0ZXIgYSBzZXJ2ZXIgcmVzcG9uc2UgdGhlIHZpZXcgbmVlZHMgdG8gYmUgdXBkYXRlZCBmb3IgZGF0YS1iaW5kaW5nIHRvCiAqICAgICAgICAgICB0YWtlIGVmZmVjdC4KICoKICogQGRlc2NyaXB0aW9uCiAqIEdlbmVyYXRlcyBhbiBYSFIgcmVxdWVzdC4gVGhlICR4aHIgc2VydmljZSBkZWxlZ2F0ZXMgYWxsIHJlcXVlc3RzIHRvCiAqIHtAbGluayBhbmd1bGFyLnNlcnZpY2UuJGJyb3dzZXIgJGJyb3dzZXIueGhyKCl9IGFuZCBhZGRzIGVycm9yIGhhbmRsaW5nIGFuZCBzZWN1cml0eSBmZWF0dXJlcy4KICogV2hpbGUgJHhociBzZXJ2aWNlIHByb3ZpZGVzIG5pY2VyIGFwaSB0aGFuIHJhdyBYbWxIdHRwUmVxdWVzdCwgaXQgaXMgc3RpbGwgY29uc2lkZXJlZCBhIGxvd2VyCiAqIGxldmVsIGFwaSBpbiBhbmd1bGFyLiBGb3IgYSBoaWdoZXIgbGV2ZWwgYWJzdHJhY3Rpb24gdGhhdCB1dGlsaXplcyBgJHhocmAsIHBsZWFzZSBjaGVjayBvdXQgdGhlCiAqIHtAbGluayBhbmd1bGFyLnNlcnZpY2UuJHJlc291cmNlICRyZXNvdXJjZX0gc2VydmljZS4KICoKICogIyBFcnJvciBoYW5kbGluZwogKiBJZiBubyBgZXJyb3IgY2FsbGJhY2tgIGlzIHNwZWNpZmllZCwgWEhSIHJlc3BvbnNlIHdpdGggcmVzcG9uc2UgY29kZSBvdGhlciB0aGVuIGAyeHhgIHdpbGwgYmUKICogZGVsZWdhdGVkIHRvIHtAbGluayBhbmd1bGFyLnNlcnZpY2UuJHhoci5lcnJvciAkeGhyLmVycm9yfS4gVGhlIGAkeGhyLmVycm9yYCBjYW4gaW50ZXJjZXB0IHRoZQogKiByZXF1ZXN0IGFuZCBwcm9jZXNzIGl0IGluIGFwcGxpY2F0aW9uIHNwZWNpZmljIHdheSwgb3IgcmVzdW1lIG5vcm1hbCBleGVjdXRpb24gYnkgY2FsbGluZyB0aGUKICogcmVxdWVzdCBgc3VjY2Vzc2AgbWV0aG9kLgogKgogKiAjIEhUVFAgSGVhZGVycwogKiBUaGUgJHhociBzZXJ2aWNlIHdpbGwgYXV0b21hdGljYWxseSBhZGQgY2VydGFpbiBodHRwIGhlYWRlcnMgdG8gYWxsIHJlcXVlc3RzLiBUaGVzZSBkZWZhdWx0cyBjYW4KICogYmUgZnVsbHkgY29uZmlndXJlZCBieSBhY2Nlc3NpbmcgdGhlIGAkeGhyLmRlZmF1bHRzLmhlYWRlcnNgIGNvbmZpZ3VyYXRpb24gb2JqZWN0LCB3aGljaAogKiBjdXJyZW50bHkgY29udGFpbnMgdGhpcyBkZWZhdWx0IGNvbmZpZ3VyYXRpb246CiAqCiAqIC0gYCR4aHIuZGVmYXVsdHMuaGVhZGVycy5jb21tb25gIChoZWFkZXJzIHRoYXQgYXJlIGNvbW1vbiBmb3IgYWxsIHJlcXVlc3RzKToKICogICAtIGBBY2NlcHQ6IGFwcGxpY2F0aW9uL2pzb24sIHRleHQvcGxhaW4sICpcLypgCiAqICAgLSBgWC1SZXF1ZXN0ZWQtV2l0aDogWE1MSHR0cFJlcXVlc3RgCiAqIC0gYCR4aHIuZGVmYXVsdHMuaGVhZGVycy5wb3N0YCAoaGVhZGVyIGRlZmF1bHRzIGZvciBIVFRQIFBPU1QgcmVxdWVzdHMpOgogKiAgIC0gYENvbnRlbnQtVHlwZTogYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkYAogKgogKiBUbyBhZGQgb3Igb3ZlcndyaXRlIHRoZXNlIGRlZmF1bHRzLCBzaW1wbGUgYWRkIG9yIHJlbW92ZSBhIHByb3BlcnR5IGZyb20gdGhpcyBjb25maWd1cmF0aW9uCiAqIG9iamVjdC4gVG8gYWRkIGhlYWRlcnMgZm9yIGFuIEhUVFAgbWV0aG9kIG90aGVyIHRoYW4gUE9TVCwgc2ltcGxlIGNyZWF0ZSBhIG5ldyBvYmplY3Qgd2l0aCBuYW1lCiAqIGVxdWFsIHRvIHRoZSBsb3dlcmNhc2VkIGh0dHAgbWV0aG9kIG5hbWUsIGUuZy4gYCR4aHIuZGVmYXVsdHMuaGVhZGVycy5nZXRbJ015LUhlYWRlciddPSd2YWx1ZSdgLgogKgogKgogKiAjIFNlY3VyaXR5IENvbnNpZGVyYXRpb25zCiAqIFdoZW4gZGVzaWduaW5nIHdlYiBhcHBsaWNhdGlvbnMgeW91ciBkZXNpZ24gbmVlZHMgdG8gY29uc2lkZXIgc2VjdXJpdHkgdGhyZWF0cyBmcm9tCiAqIHtAbGluayBodHRwOi8vaGFhY2tlZC5jb20vYXJjaGl2ZS8yMDA4LzExLzIwL2FuYXRvbXktb2YtYS1zdWJ0bGUtanNvbi12dWxuZXJhYmlsaXR5LmFzcHgKICogSlNPTiBWdWxuZXJhYmlsaXR5fSBhbmQge0BsaW5rIGh0dHA6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvQ3Jvc3Mtc2l0ZV9yZXF1ZXN0X2ZvcmdlcnkgWFNSRn0uCiAqIEJvdGggc2VydmVyIGFuZCB0aGUgY2xpZW50IG11c3QgY29vcGVyYXRlIGluIG9yZGVyIHRvIGVsaW1pbmF0ZSB0aGVzZSB0aHJlYXRzLiBBbmd1bGFyIGNvbWVzCiAqIHByZS1jb25maWd1cmVkIHdpdGggc3RyYXRlZ2llcyB0aGF0IGFkZHJlc3MgdGhlc2UgaXNzdWVzLCBidXQgZm9yIHRoaXMgdG8gd29yayBiYWNrZW5kIHNlcnZlcgogKiBjb29wZXJhdGlvbiBpcyByZXF1aXJlZC4KICoKICogIyMgSlNPTiBWdWxuZXJhYmlsaXR5IFByb3RlY3Rpb24KICogQSB7QGxpbmsgaHR0cDovL2hhYWNrZWQuY29tL2FyY2hpdmUvMjAwOC8xMS8yMC9hbmF0b215LW9mLWEtc3VidGxlLWpzb24tdnVsbmVyYWJpbGl0eS5hc3B4CiAqIEpTT04gVnVsbmVyYWJpbGl0eX0gYWxsb3dzIHRoaXJkIHBhcnR5IHdlYi1zaXRlIHRvIHR1cm4geW91ciBKU09OIHJlc291cmNlIFVSTCBpbnRvCiAqIHtAbGluayBodHRwOi8vZW4ud2lraXBlZGlhLm9yZy93aWtpL0pTT04jSlNPTlAgSlNPTlB9IHJlcXVlc3QgdW5kZXIgc29tZSBjb25kaXRpb25zLiBUbwogKiBjb3VudGVyIHRoaXMgeW91ciBzZXJ2ZXIgY2FuIHByZWZpeCBhbGwgSlNPTiByZXF1ZXN0cyB3aXRoIGZvbGxvd2luZyBzdHJpbmcgYCIpXX0nLFxuImAuCiAqIEFuZ3VsYXIgd2lsbCBhdXRvbWF0aWNhbGx5IHN0cmlwIHRoZSBwcmVmaXggYmVmb3JlIHByb2Nlc3NpbmcgaXQgYXMgSlNPTi4KICoKICogRm9yIGV4YW1wbGUgaWYgeW91ciBzZXJ2ZXIgbmVlZHMgdG8gcmV0dXJuOgogKiA8cHJlPgogKiBbJ29uZScsJ3R3byddCiAqIDwvcHJlPgogKgogKiB3aGljaCBpcyB2dWxuZXJhYmxlIHRvIGF0dGFjaywgeW91ciBzZXJ2ZXIgY2FuIHJldHVybjoKICogPHByZT4KICogKV19JywKICogWydvbmUnLCd0d28nXQogKiA8L3ByZT4KICoKICogYW5ndWxhciB3aWxsIHN0cmlwIHRoZSBwcmVmaXgsIGJlZm9yZSBwcm9jZXNzaW5nIHRoZSBKU09OLgogKgogKgogKiAjIyBDcm9zcyBTaXRlIFJlcXVlc3QgRm9yZ2VyeSAoWFNSRikgUHJvdGVjdGlvbgogKiB7QGxpbmsgaHR0cDovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9Dcm9zcy1zaXRlX3JlcXVlc3RfZm9yZ2VyeSBYU1JGfSBpcyBhIHRlY2huaXF1ZSBieSB3aGljaCBhbgogKiB1bmF1dGhvcml6ZWQgc2l0ZSBjYW4gZ2FpbiB5b3VyIHVzZXIncyBwcml2YXRlIGRhdGEuIEFuZ3VsYXIgcHJvdmlkZXMgZm9sbG93aW5nIG1lY2hhbmlzbSB0bwogKiBjb3VudGVyIFhTUkYuIFdoZW4gcGVyZm9ybWluZyBYSFIgcmVxdWVzdHMsIHRoZSAkeGhyIHNlcnZpY2UgcmVhZHMgYSB0b2tlbiBmcm9tIGEgY29va2llCiAqIGNhbGxlZCBgWFNSRi1UT0tFTmAgYW5kIHNldHMgaXQgYXMgdGhlIEhUVFAgaGVhZGVyIGBYLVhTUkYtVE9LRU5gLiBTaW5jZSBvbmx5IEphdmFTY3JpcHQgdGhhdAogKiBydW5zIG9uIHlvdXIgZG9tYWluIGNvdWxkIHJlYWQgdGhlIGNvb2tpZSwgeW91ciBzZXJ2ZXIgY2FuIGJlIGFzc3VyZWQgdGhhdCB0aGUgWEhSIGNhbWUgZnJvbQogKiBKYXZhU2NyaXB0IHJ1bm5pbmcgb24geW91ciBkb21haW4uCiAqCiAqIFRvIHRha2UgYWR2YW50YWdlIG9mIHRoaXMsIHlvdXIgc2VydmVyIG5lZWRzIHRvIHNldCBhIHRva2VuIGluIGEgSmF2YVNjcmlwdCByZWFkYWJsZSBzZXNzaW9uCiAqIGNvb2tpZSBjYWxsZWQgYFhTUkYtVE9LRU5gIG9uIGZpcnN0IEhUVFAgR0VUIHJlcXVlc3QuIE9uIHN1YnNlcXVlbnQgbm9uLUdFVCByZXF1ZXN0cyB0aGUgc2VydmVyCiAqIGNhbiB2ZXJpZnkgdGhhdCB0aGUgY29va2llIG1hdGNoZXMgYFgtWFNSRi1UT0tFTmAgSFRUUCBoZWFkZXIsIGFuZCB0aGVyZWZvcmUgYmUgc3VyZSB0aGF0IG9ubHkKICogSmF2YVNjcmlwdCBydW5uaW5nIG9uIHlvdXIgZG9tYWluIGNvdWxkIGhhdmUgcmVhZCB0aGUgdG9rZW4uIFRoZSB0b2tlbiBtdXN0IGJlIHVuaXF1ZSBmb3IgZWFjaAogKiB1c2VyIGFuZCBtdXN0IGJlIHZlcmlmaWFibGUgYnkgdGhlIHNlcnZlciAodG8gcHJldmVudCB0aGUgSmF2YVNjcmlwdCBtYWtpbmcgdXAgaXRzIG93biB0b2tlbnMpLgogKiBXZSByZWNvbW1lbmQgdGhhdCB0aGUgdG9rZW4gaXMgYSBkaWdlc3Qgb2YgeW91ciBzaXRlJ3MgYXV0aGVudGljYXRpb24gY29va2llIHdpdGgKICoge0BsaW5rIGh0dHA6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvUmFpbmJvd190YWJsZSBzYWx0IGZvciBhZGRlZCBzZWN1cml0eX0uCiAqCiAqIEBwYXJhbSB7c3RyaW5nfSBtZXRob2QgSFRUUCBtZXRob2QgdG8gdXNlLiBWYWxpZCB2YWx1ZXMgYXJlOiBgR0VUYCwgYFBPU1RgLCBgUFVUYCwgYERFTEVURWAsIGFuZAogKiAgIGBKU09OYC4gYEpTT05gIGlzIGEgc3BlY2lhbCBjYXNlIHdoaWNoIGNhdXNlcyBhCiAqICAgW0pTT05QXShodHRwOi8vZW4ud2lraXBlZGlhLm9yZy93aWtpL0pTT04jSlNPTlApIGNyb3NzIGRvbWFpbiByZXF1ZXN0IHVzaW5nIHNjcmlwdCB0YWcKICogICBpbnNlcnRpb24uCiAqIEBwYXJhbSB7c3RyaW5nfSB1cmwgUmVsYXRpdmUgb3IgYWJzb2x1dGUgVVJMIHNwZWNpZnlpbmcgdGhlIGRlc3RpbmF0aW9uIG9mIHRoZSByZXF1ZXN0LiAgRm9yCiAqICAgYEpTT05gIHJlcXVlc3RzLCBgdXJsYCBzaG91bGQgaW5jbHVkZSBgSlNPTl9DQUxMQkFDS2Agc3RyaW5nIHRvIGJlIHJlcGxhY2VkIHdpdGggYSBuYW1lIG9mIGFuCiAqICAgYW5ndWxhciBnZW5lcmF0ZWQgY2FsbGJhY2sgZnVuY3Rpb24uCiAqIEBwYXJhbSB7KHN0cmluZ3xPYmplY3QpPX0gcG9zdCBSZXF1ZXN0IGNvbnRlbnQgYXMgZWl0aGVyIGEgc3RyaW5nIG9yIGFuIG9iamVjdCB0byBiZSBzdHJpbmdpZmllZAogKiAgIGFzIEpTT04gYmVmb3JlIHNlbnQgdG8gdGhlIHNlcnZlci4KICogQHBhcmFtIHtmdW5jdGlvbihudW1iZXIsIChzdHJpbmd8T2JqZWN0KSwgRnVuY3Rpb24pfSBzdWNjZXNzIEEgZnVuY3Rpb24gdG8gYmUgY2FsbGVkIHdoZW4gdGhlIHJlc3BvbnNlIGlzCiAqICAgcmVjZWl2ZWQuIFRoZSBzdWNjZXNzIGZ1bmN0aW9uIHdpbGwgYmUgY2FsbGVkIHdpdGg6CiAqCiAqICAgLSB7bnVtYmVyfSBjb2RlIFtIVFRQIHN0YXR1cyBjb2RlXShodHRwOi8vZW4ud2lraXBlZGlhLm9yZy93aWtpL0xpc3Rfb2ZfSFRUUF9zdGF0dXNfY29kZXMpIG9mCiAqICAgICB0aGUgcmVzcG9uc2UuIFRoaXMgd2lsbCBjdXJyZW50bHkgYWx3YXlzIGJlIDIwMCwgc2luY2UgYWxsIG5vbi0yMDAgcmVzcG9uc2VzIGFyZSByb3V0ZWQgdG8KICogICAgIHtAbGluayBhbmd1bGFyLnNlcnZpY2UuJHhoci5lcnJvcn0gc2VydmljZSAob3IgY3VzdG9tIGVycm9yIGNhbGxiYWNrKS4KICogICAtIHtzdHJpbmd8T2JqZWN0fSByZXNwb25zZSBSZXNwb25zZSBvYmplY3QgYXMgc3RyaW5nIG9yIGFuIE9iamVjdCBpZiB0aGUgcmVzcG9uc2Ugd2FzIGluIEpTT04KICogICAgIGZvcm1hdC4KICogICAtIHtmdW5jdGlvbihzdHJpbmc9KX0gcmVzcG9uc2VIZWFkZXJzIEEgZnVuY3Rpb24gdGhhdCB3aGVuIGNhbGxlZCB3aXRoIGEge3N0cmluZ30gaGVhZGVyIG5hbWUsCiAqICAgICByZXR1cm5zIHRoZSB2YWx1ZSBvZiB0aGF0IGhlYWRlciBvciBudWxsIGlmIGl0IGRvZXMgbm90IGV4aXN0OyB3aGVuIGNhbGxlZCB3aXRob3V0CiAqICAgICBhcmd1bWVudHMsIHJldHVybnMgYW4gb2JqZWN0IGNvbnRhaW5pbmcgZXZlcnkgcmVzcG9uc2UgaGVhZGVyCiAqIEBwYXJhbSB7ZnVuY3Rpb24obnVtYmVyLCAoc3RyaW5nfE9iamVjdCkpfSBlcnJvciBBIGZ1bmN0aW9uIHRvIGJlIGNhbGxlZCBpZiB0aGUgcmVzcG9uc2UgY29kZSBpcwogKiAgIG5vdCAyeHguLiBBY2NlcHRzIHRoZSBzYW1lIGFyZ3VtZW50cyBhcyBzdWNjZXNzLCBhYm92ZS4KICoKICogQGV4YW1wbGUKICAgPGRvYzpleGFtcGxlPgogICAgIDxkb2M6c291cmNlIGpzZmlkZGxlPSJmYWxzZSI+CiAgICAgICA8c2NyaXB0PgogICAgICAgICBmdW5jdGlvbiBGZXRjaENudGwoJHhocikgewogICAgICAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgICAgICAgdGhpcy5mZXRjaCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgc2VsZi5jb2RlID0gbnVsbDsKICAgICAgICAgICAgIHNlbGYucmVzcG9uc2UgPSBudWxsOwoKICAgICAgICAgICAgICR4aHIoc2VsZi5tZXRob2QsIHNlbGYudXJsLCBmdW5jdGlvbihjb2RlLCByZXNwb25zZSkgewogICAgICAgICAgICAgICBzZWxmLmNvZGUgPSBjb2RlOwogICAgICAgICAgICAgICBzZWxmLnJlc3BvbnNlID0gcmVzcG9uc2U7CiAgICAgICAgICAgICB9LCBmdW5jdGlvbihjb2RlLCByZXNwb25zZSkgewogICAgICAgICAgICAgICBzZWxmLmNvZGUgPSBjb2RlOwogICAgICAgICAgICAgICBzZWxmLnJlc3BvbnNlID0gcmVzcG9uc2UgfHwgIlJlcXVlc3QgZmFpbGVkIjsKICAgICAgICAgICAgIH0pOwogICAgICAgICAgIH07CgogICAgICAgICAgIHRoaXMudXBkYXRlTW9kZWwgPSBmdW5jdGlvbihtZXRob2QsIHVybCkgewogICAgICAgICAgICAgc2VsZi5tZXRob2QgPSBtZXRob2Q7CiAgICAgICAgICAgICBzZWxmLnVybCA9IHVybDsKICAgICAgICAgICB9OwogICAgICAgICB9CiAgICAgICAgIEZldGNoQ250bC4kaW5qZWN0ID0gWyckeGhyJ107CiAgICAgICA8L3NjcmlwdD4KICAgICAgIDxkaXYgbmc6Y29udHJvbGxlcj0iRmV0Y2hDbnRsIj4KICAgICAgICAgPHNlbGVjdCBuYW1lPSJtZXRob2QiPgogICAgICAgICAgIDxvcHRpb24+R0VUPC9vcHRpb24+CiAgICAgICAgICAgPG9wdGlvbj5KU09OPC9vcHRpb24+CiAgICAgICAgIDwvc2VsZWN0PgogICAgICAgICA8aW5wdXQgdHlwZT0idGV4dCIgbmFtZT0idXJsIiB2YWx1ZT0iaW5kZXguaHRtbCIgc2l6ZT0iODAiLz4KICAgICAgICAgPGJ1dHRvbiBuZzpjbGljaz0iZmV0Y2goKSI+ZmV0Y2g8L2J1dHRvbj48YnI+CiAgICAgICAgIDxidXR0b24gbmc6Y2xpY2s9InVwZGF0ZU1vZGVsKCdHRVQnLCAnaW5kZXguaHRtbCcpIj5TYW1wbGUgR0VUPC9idXR0b24+CiAgICAgICAgIDxidXR0b24gbmc6Y2xpY2s9InVwZGF0ZU1vZGVsKCdKU09OJywgJ2h0dHBzOi8vd3d3Lmdvb2dsZWFwaXMuY29tL2J1enovdjEvYWN0aXZpdGllcy9nb29nbGVidXp6L0BzZWxmP2FsdD1qc29uJmNhbGxiYWNrPUpTT05fQ0FMTEJBQ0snKSI+U2FtcGxlIEpTT05QIChCdXp6IEFQSSk8L2J1dHRvbj4KICAgICAgICAgPGJ1dHRvbiBuZzpjbGljaz0idXBkYXRlTW9kZWwoJ0pTT04nLCAnaHR0cHM6Ly93d3cuaW52YWxpZF9KU09OUF9yZXF1ZXN0LmNvbSZjYWxsYmFjaz1KU09OX0NBTExCQUNLJykiPkludmFsaWQgSlNPTlA8L2J1dHRvbj4KICAgICAgICAgPHByZT5jb2RlPXt7Y29kZX19PC9wcmU+CiAgICAgICAgIDxwcmU+cmVzcG9uc2U9e3tyZXNwb25zZX19PC9wcmU+CiAgICAgICA8L2Rpdj4KICAgICA8L2RvYzpzb3VyY2U+CiAgICAgPGRvYzpzY2VuYXJpbz4KICAgICAgIGl0KCdzaG91bGQgbWFrZSB4aHIgR0VUIHJlcXVlc3QnLCBmdW5jdGlvbigpIHsKICAgICAgICAgZWxlbWVudCgnOmJ1dHRvbjpjb250YWlucygiU2FtcGxlIEdFVCIpJykuY2xpY2soKTsKICAgICAgICAgZWxlbWVudCgnOmJ1dHRvbjpjb250YWlucygiZmV0Y2giKScpLmNsaWNrKCk7CiAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdjb2RlJykpLnRvQmUoJ2NvZGU9MjAwJyk7CiAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdyZXNwb25zZScpKS50b01hdGNoKC9hbmd1bGFyanMub3JnLyk7CiAgICAgICB9KTsKCiAgICAgICBpdCgnc2hvdWxkIG1ha2UgSlNPTlAgcmVxdWVzdCB0byB0aGUgQnV6eiBBUEknLCBmdW5jdGlvbigpIHsKICAgICAgICAgZWxlbWVudCgnOmJ1dHRvbjpjb250YWlucygiQnV6eiBBUEkiKScpLmNsaWNrKCk7CiAgICAgICAgIGVsZW1lbnQoJzpidXR0b246Y29udGFpbnMoImZldGNoIiknKS5jbGljaygpOwogICAgICAgICBleHBlY3QoYmluZGluZygnY29kZScpKS50b0JlKCdjb2RlPTIwMCcpOwogICAgICAgICBleHBlY3QoYmluZGluZygncmVzcG9uc2UnKSkudG9NYXRjaCgvYnV6ei1mZWVkLyk7CiAgICAgICB9KTsKCiAgICAgICBpdCgnc2hvdWxkIG1ha2UgSlNPTlAgcmVxdWVzdCB0byBpbnZhbGlkIFVSTCBhbmQgaW52b2tlIHRoZSBlcnJvciBoYW5kbGVyJywKICAgICAgICAgICBmdW5jdGlvbigpIHsKICAgICAgICAgZWxlbWVudCgnOmJ1dHRvbjpjb250YWlucygiSW52YWxpZCBKU09OUCIpJykuY2xpY2soKTsKICAgICAgICAgZWxlbWVudCgnOmJ1dHRvbjpjb250YWlucygiZmV0Y2giKScpLmNsaWNrKCk7CiAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdjb2RlJykpLnRvQmUoJ2NvZGU9Jyk7CiAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdyZXNwb25zZScpKS50b0JlKCdyZXNwb25zZT1SZXF1ZXN0IGZhaWxlZCcpOwogICAgICAgfSk7CiAgICAgPC9kb2M6c2NlbmFyaW8+CiAgIDwvZG9jOmV4YW1wbGU+CiAqLwphbmd1bGFyU2VydmljZUluamVjdCgnJHhocicsIGZ1bmN0aW9uKCRicm93c2VyLCAkZXJyb3IsICRsb2csICR1cGRhdGVWaWV3KXsKCiAgdmFyIHhockhlYWRlckRlZmF1bHRzID0gewogICAgY29tbW9uOiB7CiAgICAgICJBY2NlcHQiOiAiYXBwbGljYXRpb24vanNvbiwgdGV4dC9wbGFpbiwgKi8qIiwKICAgICAgIlgtUmVxdWVzdGVkLVdpdGgiOiAiWE1MSHR0cFJlcXVlc3QiCiAgICB9LAogICAgcG9zdDogeydDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkJ30sCiAgICBnZXQ6IHt9LCAgICAgIC8vIGFsbCB0aGVzZSBlbXB0eSBwcm9wZXJ0aWVzIGFyZSBuZWVkZWQgc28gdGhhdCBjbGllbnQgYXBwcyBjYW4ganVzdCBkbzoKICAgIGhlYWQ6IHt9LCAgICAgLy8gJHhoci5kZWZhdWx0cy5oZWFkZXJzLmhlYWQuZm9vPSJiYXIiIHdpdGhvdXQgaGF2aW5nIHRvIGNyZWF0ZSBoZWFkIG9iamVjdAogICAgcHV0OiB7fSwgICAgICAvLyBpdCBhbHNvIG1lYW5zIHRoYXQgaWYgd2UgYWRkIGEgaGVhZGVyIGZvciB0aGVzZSBtZXRob2RzIGluIHRoZSBmdXR1cmUsIGl0CiAgICAnZGVsZXRlJzoge30sIC8vIHdvbid0IGJlIGVhc2lseSBzaWxlbnRseSBsb3N0IGR1ZSB0byBhbiBvYmplY3QgYXNzaWdubWVudC4KICAgIHBhdGNoOiB7fQogIH07CgogIGZ1bmN0aW9uIHhocihtZXRob2QsIHVybCwgcG9zdCwgc3VjY2VzcywgZXJyb3IpIHsKICAgIGlmIChpc0Z1bmN0aW9uKHBvc3QpKSB7CiAgICAgIGVycm9yID0gc3VjY2VzczsKICAgICAgc3VjY2VzcyA9IHBvc3Q7CiAgICAgIHBvc3QgPSBudWxsOwogICAgfQogICAgaWYgKHBvc3QgJiYgaXNPYmplY3QocG9zdCkpIHsKICAgICAgcG9zdCA9IHRvSnNvbihwb3N0KTsKICAgIH0KCiAgICAkYnJvd3Nlci54aHIobWV0aG9kLCB1cmwsIHBvc3QsIGZ1bmN0aW9uKGNvZGUsIHJlc3BvbnNlLCByZXNwb25zZUhlYWRlcnMpewogICAgICB0cnkgewogICAgICAgIGlmIChpc1N0cmluZyhyZXNwb25zZSkpIHsKICAgICAgICAgIGlmIChyZXNwb25zZS5tYXRjaCgvXlwpXF1cfScsXG4vKSkgcmVzcG9uc2U9cmVzcG9uc2Uuc3Vic3RyKDYpOwogICAgICAgICAgaWYgKC9eXHMqW1xbXHtdLy5leGVjKHJlc3BvbnNlKSAmJiAvW1x9XF1dXHMqJC8uZXhlYyhyZXNwb25zZSkpIHsKICAgICAgICAgICAgcmVzcG9uc2UgPSBmcm9tSnNvbihyZXNwb25zZSwgdHJ1ZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmICgyMDAgPD0gY29kZSAmJiBjb2RlIDwgMzAwKSB7CiAgICAgICAgICBzdWNjZXNzKGNvZGUsIHJlc3BvbnNlLCByZXNwb25zZUhlYWRlcnMpOwogICAgICAgIH0gZWxzZSBpZiAoaXNGdW5jdGlvbihlcnJvcikpIHsKICAgICAgICAgIGVycm9yKGNvZGUsIHJlc3BvbnNlLCByZXNwb25zZUhlYWRlcnMpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAkZXJyb3IoCiAgICAgICAgICAgIHttZXRob2Q6IG1ldGhvZCwgdXJsOiB1cmwsIGRhdGE6IHBvc3QsIHN1Y2Nlc3M6IHN1Y2Nlc3N9LAogICAgICAgICAgICB7c3RhdHVzOiBjb2RlLCBib2R5OiByZXNwb25zZX0pOwogICAgICAgIH0KICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICRsb2cuZXJyb3IoZSk7CiAgICAgIH0gZmluYWxseSB7CiAgICAgICAgJHVwZGF0ZVZpZXcoKTsKICAgICAgfQogICAgfSwgZXh0ZW5kKHsnWC1YU1JGLVRPS0VOJzogJGJyb3dzZXIuY29va2llcygpWydYU1JGLVRPS0VOJ119LAogICAgICAgICAgICAgIHhockhlYWRlckRlZmF1bHRzLmNvbW1vbiwKICAgICAgICAgICAgICB4aHJIZWFkZXJEZWZhdWx0c1tsb3dlcmNhc2UobWV0aG9kKV0pKTsKICB9OwoKICB4aHIuZGVmYXVsdHMgPSB7aGVhZGVyczogeGhySGVhZGVyRGVmYXVsdHN9OwoKICByZXR1cm4geGhyOwp9LCBbJyRicm93c2VyJywgJyR4aHIuZXJyb3InLCAnJGxvZycsICckdXBkYXRlVmlldyddKTsKJ3VzZSBzdHJpY3QnOwoKLyoqCiAqIEB3b3JrSW5Qcm9ncmVzcwogKiBAbmdkb2Mgb3ZlcnZpZXcKICogQG5hbWUgYW5ndWxhci5kaXJlY3RpdmUKICogQGRlc2NyaXB0aW9uCiAqCiAqIEN1c3RvbSBhdHRyaWJ1dGVzIGZvciBET00gZWxlbWVudHMuICBEaXJlY3RpdmVzIG1vZGlmeSB0aGUgYmVoYXZpb3Igb2YgdGhlIGVsZW1lbnQgdGhleSBhcmUKICogc3BlY2lmaWVkIGluLCBidXQgYXJlIG5vdCBpbnRlbmRlZCB0byBhZGQgZWxlbWVudHMgdG8gdGhlIERPTSBhcyBhcmUKICoge0BsaW5rIGFuZ3VsYXIud2lkZ2V0IHdpZGdldHN9LgogKgogKiBGb2xsb3dpbmcgaXMgdGhlIGxpc3Qgb2YgYnVpbHQtaW4gYW5ndWxhciBkaXJlY3RpdmVzOgogKgogKiAqIHtAbGluayBhbmd1bGFyLmRpcmVjdGl2ZS5uZzpiaW5kIG5nOmJpbmR9IC0gQ3JlYXRlcyBhIGRhdGEtYmluZGluZyBiZXR3ZWVuIEhUTUwgdGV4dCB2YWx1ZSBhbmQKICogZGF0YSBtb2RlbC4KICogKiB7QGxpbmsgYW5ndWxhci5kaXJlY3RpdmUubmc6YmluZC1hdHRyIG5nOmJpbmQtYXR0cn0gLSBDcmVhdGVzIGEgZGF0YS1iaW5kaW5nIGFzIGluIGBuZzpiaW5kYCwKICogYnV0IHVzZXMgSlNPTiBrZXkgLyB2YWx1ZSBwYWlycy4KICogKiB7QGxpbmsgYW5ndWxhci5kaXJlY3RpdmUubmc6YmluZC10ZW1wbGF0ZSBuZzpiaW5kLXRlbXBsYXRlfSAtIFJlcGxhY2VzIHRleHQgdmFsdWUgb2YgYW4gZWxlbWVudAogKiB3aXRoIGEgc3BlY2lmaWVkIHRlbXBsYXRlLgogKiAqIHtAbGluayBhbmd1bGFyLmRpcmVjdGl2ZS5uZzpjaGFuZ2Ugbmc6Y2hhbmdlfSAtIEV4ZWN1dGVzIGFuIGV4cHJlc3Npb24gd2hlbiB0aGUgdmFsdWUgb2YgYW4KICogaW5wdXQgd2lkZ2V0IGNoYW5nZXMuCiAqICoge0BsaW5rIGFuZ3VsYXIuZGlyZWN0aXZlLm5nOmNsYXNzIG5nOmNsYXNzfSAtIENvbmRpdGlvbmFsbHkgc2V0IENTUyBjbGFzcyBvbiBhbiBlbGVtZW50LgogKiAqIHtAbGluayBhbmd1bGFyLmRpcmVjdGl2ZS5uZzpjbGFzcy1ldmVuIG5nOmNsYXNzLWV2ZW59IC0gTGlrZSBgbmc6Y2xhc3NgLCBidXQgd29ya3MgaW4KICogY29uanVuY3Rpb24gd2l0aCB7QGxpbmsgYW5ndWxhci53aWRnZXQuQG5nOnJlcGVhdH0gdG8gYWZmZWN0IGV2ZW4gcm93cyBpbiBhIGNvbGxlY3Rpb24uCiAqICoge0BsaW5rIGFuZ3VsYXIuZGlyZWN0aXZlLm5nOmNsYXNzLW9kZCBuZzpjbGFzcy1vZGR9IC0gTGlrZSBgbmc6Y2xhc3NgLCBidXQgd29ya3Mgd2l0aCB7QGxpbmsKICogYW5ndWxhci53aWRnZXQuQG5nOnJlcGVhdH0gIHRvIGFmZmVjdCBvZGQgcm93cy4KICogKiB7QGxpbmsgYW5ndWxhci5kaXJlY3RpdmUubmc6Y2xpY2sgbmc6Y2xpY2t9IC0gRXhlY3V0ZXMgY3VzdG9tIGJlaGF2aW9yIHdoZW4gZWxlbWVudCBpcyBjbGlja2VkLgogKiAqIHtAbGluayBhbmd1bGFyLmRpcmVjdGl2ZS5uZzpjb250cm9sbGVyIG5nOmNvbnRyb2xsZXJ9IC0gQ3JlYXRlcyBhIHNjb3BlIG9iamVjdCBsaW5rZWQgdG8gdGhlCiAqIERPTSBlbGVtZW50IGFuZCBhc3NpZ25zIGJlaGF2aW9yIHRvIHRoZSBzY29wZS4KICogKiB7QGxpbmsgYW5ndWxhci5kaXJlY3RpdmUubmc6ZXZhbCBuZzpldmFsfSAtIEV4ZWN1dGVzIGEgYmluZGluZyBidXQgYmxvY2tzIG91dHB1dC4KICogKiB7QGxpbmsgYW5ndWxhci5kaXJlY3RpdmUubmc6ZXZhbC1vcmRlciBuZzpldmFsLW9yZGVyfSAtIENoYW5nZSBldmFsdWF0aW9uIG9yZGVyIHdoZW4gdXBkYXRpbmcKICogdGhlIHZpZXcuCiAqICoge0BsaW5rIGFuZ3VsYXIuZGlyZWN0aXZlLm5nOmhpZGUgbmc6aGlkZX0gLSBDb25kaXRpb25hbGx5IGhpZGVzIGEgcG9ydGlvbiBvZiBIVE1MLgogKiAqIHtAbGluayBhbmd1bGFyLmRpcmVjdGl2ZS5uZzpocmVmIG5nOmhyZWZ9IC0gUGxhY2VzIGFuIGhyZWYgaW4gdGhlIGFuZ3VsYXIgbmFtZXNwYWNlLgogKiAqIHtAbGluayBhbmd1bGFyLmRpcmVjdGl2ZS5uZzppbml0fSAtIEluaXRpYWxpemF0aW9uIHRhc2tzIHJ1biBiZWZvcmUgYSB0ZW1wbGF0ZSBpcyBleGVjdXRlZC4KICogKiB7QGxpbmsgYW5ndWxhci5kaXJlY3RpdmUubmc6c2hvdyBuZzpzaG93fSAtIENvbmRpdGlvbmFsbHkgZGlzcGxheXMgYSBwb3J0aW9uIG9mIEhUTUwuCiAqICoge0BsaW5rIGFuZ3VsYXIuZGlyZWN0aXZlLm5nOnNyYyBuZzpzcmN9IC0gUGxhY2VzIGEgYHNyY2AgYXR0cmlidXRlIGludG8gdGhlIGFuZ3VsYXIgbmFtZXNwYWNlLgogKiAqIHtAbGluayBhbmd1bGFyLmRpcmVjdGl2ZS5uZzpzdHlsZSBuZzpzdHlsZX0gLSBDb25kaXRpb25hbGx5IHNldCBDU1Mgc3R5bGVzIG9uIGFuIGVsZW1lbnQuCiAqICoge0BsaW5rIGFuZ3VsYXIuZGlyZWN0aXZlLm5nOnN1Ym1pdH0gLSBCaW5kcyBhbmd1bGFyIGV4cHJlc3Npb25zIHRvIGBvblN1Ym1pdGAgZXZlbnRzLgogKgogKiBGb3IgbW9yZSBpbmZvcm1hdGlvbiBhYm91dCBob3cgYW5ndWxhciBkaXJlY3RpdmVzIHdvcmssIGFuZCBob3cgdG8gY3JlYXRlIHlvdXIgb3duIGRpcmVjdGl2ZXMsCiAqIHNlZSB7QGxpbmsgZ3VpZGUvZGV2X2d1aWRlLmNvbXBpbGVyLmRpcmVjdGl2ZXMgVW5kZXJzdGFuZGluZyBBbmd1bGFyIERpcmVjdGl2ZXN9IGluIHRoZSBhbmd1bGFyCiAqIERldmVsb3BlciBHdWlkZS4KICovCgovKioKICogQHdvcmtJblByb2dyZXNzCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgYW5ndWxhci5kaXJlY3RpdmUubmc6aW5pdAogKgogKiBAZGVzY3JpcHRpb24KICogVGhlIGBuZzppbml0YCBhdHRyaWJ1dGUgc3BlY2lmaWVzIGluaXRpYWxpemF0aW9uIHRhc2tzIHRvIGJlIGV4ZWN1dGVkCiAqICBiZWZvcmUgdGhlIHRlbXBsYXRlIGVudGVycyBleGVjdXRpb24gbW9kZSBkdXJpbmcgYm9vdHN0cmFwLgogKgogKiBAZWxlbWVudCBBTlkKICogQHBhcmFtIHtleHByZXNzaW9ufSBleHByZXNzaW9uIHtAbGluayBndWlkZS9kZXZfZ3VpZGUuZXhwcmVzc2lvbnMgRXhwcmVzc2lvbn0gdG8gZXZhbC4KICoKICogQGV4YW1wbGUKICAgPGRvYzpleGFtcGxlPgogICAgIDxkb2M6c291cmNlPgogICAgPGRpdiBuZzppbml0PSJncmVldGluZz0nSGVsbG8nOyBwZXJzb249J1dvcmxkJyI+CiAgICAgIHt7Z3JlZXRpbmd9fSB7e3BlcnNvbn19IQogICAgPC9kaXY+CiAgICAgPC9kb2M6c291cmNlPgogICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgICBpdCgnc2hvdWxkIGNoZWNrIGdyZWV0aW5nJywgZnVuY3Rpb24oKXsKICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ2dyZWV0aW5nJykpLnRvQmUoJ0hlbGxvJyk7CiAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdwZXJzb24nKSkudG9CZSgnV29ybGQnKTsKICAgICAgIH0pOwogICAgIDwvZG9jOnNjZW5hcmlvPgogICA8L2RvYzpleGFtcGxlPgogKi8KYW5ndWxhckRpcmVjdGl2ZSgibmc6aW5pdCIsIGZ1bmN0aW9uKGV4cHJlc3Npb24pewogIHJldHVybiBmdW5jdGlvbihlbGVtZW50KXsKICAgIHRoaXMuJHRyeUV2YWwoZXhwcmVzc2lvbiwgZWxlbWVudCk7CiAgfTsKfSk7CgovKioKICogQHdvcmtJblByb2dyZXNzCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgYW5ndWxhci5kaXJlY3RpdmUubmc6Y29udHJvbGxlcgogKgogKiBAZGVzY3JpcHRpb24KICogVGhlIGBuZzpjb250cm9sbGVyYCBkaXJlY3RpdmUgYXNzaWducyBiZWhhdmlvciB0byBhIHNjb3BlLiBUaGlzIGlzIGEga2V5IGFzcGVjdCBvZiBob3cgYW5ndWxhcgogKiBzdXBwb3J0cyB0aGUgcHJpbmNpcGxlcyBiZWhpbmQgdGhlIE1vZGVsLVZpZXctQ29udHJvbGxlciBkZXNpZ24gcGF0dGVybi4KICoKICogTVZDIGNvbXBvbmVudHMgaW4gYW5ndWxhcjoKICoKICogKiBNb2RlbCDigJQgVGhlIE1vZGVsIGlzIGRhdGEgaW4gc2NvcGUgcHJvcGVydGllczsgc2NvcGVzIGFyZSBhdHRhY2hlZCB0byB0aGUgRE9NLgogKiAqIFZpZXcg4oCUIFRoZSB0ZW1wbGF0ZSAoSFRNTCB3aXRoIGRhdGEgYmluZGluZ3MpIGlzIHJlbmRlcmVkIGludG8gdGhlIFZpZXcuCiAqICogQ29udHJvbGxlciDigJQgVGhlIGBuZzpjb250cm9sbGVyYCBkaXJlY3RpdmUgc3BlY2lmaWVzIGEgQ29udHJvbGxlciBjbGFzczsgdGhlIGNsYXNzIGhhcwogKiAgIG1ldGhvZHMgdGhhdCB0eXBpY2FsbHkgZXhwcmVzcyB0aGUgYnVzaW5lc3MgbG9naWMgYmVoaW5kIHRoZSBhcHBsaWNhdGlvbi4KICoKICogTm90ZSB0aGF0IGFuIGFsdGVybmF0aXZlIHdheSB0byBkZWZpbmUgY29udHJvbGxlcnMgaXMgdmlhIHRoZSBge0BsaW5rIGFuZ3VsYXIuc2VydmljZS4kcm91dGV9YAogKiBzZXJ2aWNlLgogKgogKiBAZWxlbWVudCBBTlkKICogQHBhcmFtIHtleHByZXNzaW9ufSBleHByZXNzaW9uIE5hbWUgb2YgYSBnbG9iYWxseSBhY2Nlc3NpYmxlIGNvbnN0cnVjdG9yIGZ1bmN0aW9uIG9yIGFuCiAqICAgICB7QGxpbmsgZ3VpZGUvZGV2X2d1aWRlLmV4cHJlc3Npb25zIGV4cHJlc3Npb259IHRoYXQgb24gdGhlIGN1cnJlbnQgc2NvcGUgZXZhbHVhdGVzIHRvIGEKICogICAgIGNvbnN0cnVjdG9yIGZ1bmN0aW9uLgogKgogKiBAZXhhbXBsZQogKiBIZXJlIGlzIGEgc2ltcGxlIGZvcm0gZm9yIGVkaXRpbmcgdXNlciBjb250YWN0IGluZm9ybWF0aW9uLiBBZGRpbmcsIHJlbW92aW5nLCBjbGVhcmluZywgYW5kCiAqIGdyZWV0aW5nIGFyZSBtZXRob2RzIGRlY2xhcmVkIG9uIHRoZSBjb250cm9sbGVyIChzZWUgc291cmNlIHRhYikuIFRoZXNlIG1ldGhvZHMgY2FuCiAqIGVhc2lseSBiZSBjYWxsZWQgZnJvbSB0aGUgYW5ndWxhciBtYXJrdXAuIE5vdGljZSB0aGF0IHRoZSBzY29wZSBiZWNvbWVzIHRoZSBgdGhpc2AgZm9yIHRoZQogKiBjb250cm9sbGVyJ3MgaW5zdGFuY2UuIFRoaXMgYWxsb3dzIGZvciBlYXN5IGFjY2VzcyB0byB0aGUgdmlldyBkYXRhIGZyb20gdGhlIGNvbnRyb2xsZXIuIEFsc28KICogbm90aWNlIHRoYXQgYW55IGNoYW5nZXMgdG8gdGhlIGRhdGEgYXJlIGF1dG9tYXRpY2FsbHkgcmVmbGVjdGVkIGluIHRoZSBWaWV3IHdpdGhvdXQgdGhlIG5lZWQKICogZm9yIGEgbWFudWFsIHVwZGF0ZS4KICAgPGRvYzpleGFtcGxlPgogICAgIDxkb2M6c291cmNlPgogICAgICA8c2NyaXB0IHR5cGU9InRleHQvamF2YXNjcmlwdCI+CiAgICAgICAgZnVuY3Rpb24gU2V0dGluZ3NDb250cm9sbGVyKCkgewogICAgICAgICAgdGhpcy5uYW1lID0gIkpvaG4gU21pdGgiOwogICAgICAgICAgdGhpcy5jb250YWN0cyA9IFsKICAgICAgICAgICAge3R5cGU6J3Bob25lJywgdmFsdWU6JzQwOCA1NTUgMTIxMid9LAogICAgICAgICAgICB7dHlwZTonZW1haWwnLCB2YWx1ZTonam9obi5zbWl0aEBleGFtcGxlLm9yZyd9IF07CiAgICAgICAgfQogICAgICAgIFNldHRpbmdzQ29udHJvbGxlci5wcm90b3R5cGUgPSB7CiAgICAgICAgIGdyZWV0OiBmdW5jdGlvbigpewogICAgICAgICAgIGFsZXJ0KHRoaXMubmFtZSk7CiAgICAgICAgIH0sCiAgICAgICAgIGFkZENvbnRhY3Q6IGZ1bmN0aW9uKCl7CiAgICAgICAgICAgdGhpcy5jb250YWN0cy5wdXNoKHt0eXBlOidlbWFpbCcsIHZhbHVlOid5b3VybmFtZUBleGFtcGxlLm9yZyd9KTsKICAgICAgICAgfSwKICAgICAgICAgcmVtb3ZlQ29udGFjdDogZnVuY3Rpb24oY29udGFjdFRvUmVtb3ZlKSB7CiAgICAgICAgICAgYW5ndWxhci5BcnJheS5yZW1vdmUodGhpcy5jb250YWN0cywgY29udGFjdFRvUmVtb3ZlKTsKICAgICAgICAgfSwKICAgICAgICAgY2xlYXJDb250YWN0OiBmdW5jdGlvbihjb250YWN0KSB7CiAgICAgICAgICAgY29udGFjdC50eXBlID0gJ3Bob25lJzsKICAgICAgICAgICBjb250YWN0LnZhbHVlID0gJyc7CiAgICAgICAgIH0KICAgICAgICB9OwogICAgICA8L3NjcmlwdD4KICAgICAgPGRpdiBuZzpjb250cm9sbGVyPSJTZXR0aW5nc0NvbnRyb2xsZXIiPgogICAgICAgIE5hbWU6IDxpbnB1dCB0eXBlPSJ0ZXh0IiBuYW1lPSJuYW1lIi8+CiAgICAgICAgWyA8YSBocmVmPSIiIG5nOmNsaWNrPSJncmVldCgpIj5ncmVldDwvYT4gXTxici8+CiAgICAgICAgQ29udGFjdDoKICAgICAgICA8dWw+CiAgICAgICAgICA8bGkgbmc6cmVwZWF0PSJjb250YWN0IGluIGNvbnRhY3RzIj4KICAgICAgICAgICAgPHNlbGVjdCBuYW1lPSJjb250YWN0LnR5cGUiPgogICAgICAgICAgICAgICA8b3B0aW9uPnBob25lPC9vcHRpb24+CiAgICAgICAgICAgICAgIDxvcHRpb24+ZW1haWw8L29wdGlvbj4KICAgICAgICAgICAgPC9zZWxlY3Q+CiAgICAgICAgICAgIDxpbnB1dCB0eXBlPSJ0ZXh0IiBuYW1lPSJjb250YWN0LnZhbHVlIi8+CiAgICAgICAgICAgIFsgPGEgaHJlZj0iIiBuZzpjbGljaz0iY2xlYXJDb250YWN0KGNvbnRhY3QpIj5jbGVhcjwvYT4KICAgICAgICAgICAgfCA8YSBocmVmPSIiIG5nOmNsaWNrPSJyZW1vdmVDb250YWN0KGNvbnRhY3QpIj5YPC9hPiBdCiAgICAgICAgICA8L2xpPgogICAgICAgICAgPGxpPlsgPGEgaHJlZj0iIiBuZzpjbGljaz0iYWRkQ29udGFjdCgpIj5hZGQ8L2E+IF08L2xpPgogICAgICAgPC91bD4KICAgICAgPC9kaXY+CiAgICAgPC9kb2M6c291cmNlPgogICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgICBpdCgnc2hvdWxkIGNoZWNrIGNvbnRyb2xsZXInLCBmdW5jdGlvbigpewogICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgZGl2PjppbnB1dCcpLnZhbCgpKS50b0JlKCdKb2huIFNtaXRoJyk7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBsaVtuZ1xcOnJlcGVhdC1pbmRleD0iMCJdIGlucHV0JykudmFsKCkpLnRvQmUoJzQwOCA1NTUgMTIxMicpOwogICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgbGlbbmdcXDpyZXBlYXQtaW5kZXg9IjEiXSBpbnB1dCcpLnZhbCgpKS50b0JlKCdqb2huLnNtaXRoQGV4YW1wbGUub3JnJyk7CiAgICAgICAgIGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIGxpOmZpcnN0IGE6Y29udGFpbnMoImNsZWFyIiknKS5jbGljaygpOwogICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgbGk6Zmlyc3QgaW5wdXQnKS52YWwoKSkudG9CZSgnJyk7CiAgICAgICAgIGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIGxpOmxhc3QgYTpjb250YWlucygiYWRkIiknKS5jbGljaygpOwogICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgbGlbbmdcXDpyZXBlYXQtaW5kZXg9IjIiXSBpbnB1dCcpLnZhbCgpKS50b0JlKCd5b3VybmFtZUBleGFtcGxlLm9yZycpOwogICAgICAgfSk7CiAgICAgPC9kb2M6c2NlbmFyaW8+CiAgIDwvZG9jOmV4YW1wbGU+CiAqLwphbmd1bGFyRGlyZWN0aXZlKCJuZzpjb250cm9sbGVyIiwgZnVuY3Rpb24oZXhwcmVzc2lvbil7CiAgdGhpcy5zY29wZSh0cnVlKTsKICByZXR1cm4gZnVuY3Rpb24oZWxlbWVudCl7CiAgICB2YXIgY29udHJvbGxlciA9IGdldHRlcih3aW5kb3csIGV4cHJlc3Npb24sIHRydWUpIHx8IGdldHRlcih0aGlzLCBleHByZXNzaW9uLCB0cnVlKTsKICAgIGlmICghY29udHJvbGxlcikKICAgICAgdGhyb3cgIkNhbiBub3QgZmluZCAnIitleHByZXNzaW9uKyInIGNvbnRyb2xsZXIuIjsKICAgIGlmICghaXNGdW5jdGlvbihjb250cm9sbGVyKSkKICAgICAgdGhyb3cgIlJlZmVyZW5jZSAnIitleHByZXNzaW9uKyInIGlzIG5vdCBhIGNsYXNzLiI7CiAgICB0aGlzLiRiZWNvbWUoY29udHJvbGxlcik7CiAgfTsKfSk7CgovKioKICogQHdvcmtJblByb2dyZXNzCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgYW5ndWxhci5kaXJlY3RpdmUubmc6ZXZhbAogKgogKiBAZGVzY3JpcHRpb24KICogVGhlIGBuZzpldmFsYCBhbGxvd3MgeW91IHRvIGV4ZWN1dGUgYSBiaW5kaW5nIHdoaWNoIGhhcyBzaWRlIGVmZmVjdHMKICogd2l0aG91dCBkaXNwbGF5aW5nIHRoZSByZXN1bHQgdG8gdGhlIHVzZXIuCiAqCiAqIEBlbGVtZW50IEFOWQogKiBAcGFyYW0ge2V4cHJlc3Npb259IGV4cHJlc3Npb24ge0BsaW5rIGd1aWRlL2Rldl9ndWlkZS5leHByZXNzaW9ucyBFeHByZXNzaW9ufSB0byBldmFsLgogKgogKiBAZXhhbXBsZQogKiBOb3RpY2UgdGhhdCBge3tgIGBvYmoubXVsdGlwbGllZCA9IG9iai5hICogb2JqLmJgIGB9fWAgaGFzIGEgc2lkZSBlZmZlY3Qgb2YgYXNzaWduaW5nCiAqIGEgdmFsdWUgdG8gYG9iai5tdWx0aXBsaWVkYCBhbmQgZGlzcGxheWluZyB0aGUgcmVzdWx0IHRvIHRoZSB1c2VyLiBTb21ldGltZXMsCiAqIGhvd2V2ZXIsIGl0IGlzIGRlc2lyYWJsZSB0byBleGVjdXRlIGEgc2lkZSBlZmZlY3Qgd2l0aG91dCBzaG93aW5nIHRoZSB2YWx1ZSB0bwogKiB0aGUgdXNlci4gSW4gc3VjaCBhIGNhc2UgYG5nOmV2YWxgIGFsbG93cyB5b3UgdG8gZXhlY3V0ZSBjb2RlIHdpdGhvdXQgdXBkYXRpbmcKICogdGhlIGRpc3BsYXkuCiAgIDxkb2M6ZXhhbXBsZT4KICAgICA8ZG9jOnNvdXJjZT4KICAgICAgIDxpbnB1dCBuYW1lPSJvYmouYSIgdmFsdWU9IjYiID4KICAgICAgICAgKiA8aW5wdXQgbmFtZT0ib2JqLmIiIHZhbHVlPSIyIj4KICAgICAgICAgPSB7e29iai5tdWx0aXBsaWVkID0gb2JqLmEgKiBvYmouYn19IDxicj4KICAgICAgIDxzcGFuIG5nOmV2YWw9Im9iai5kaXZpZGUgPSBvYmouYSAvIG9iai5iIj48L3NwYW4+CiAgICAgICA8c3BhbiBuZzpldmFsPSJvYmoudXBkYXRlQ291bnQgPSAxICsgKG9iai51cGRhdGVDb3VudHx8MCkiPgogICAgICAgPC9zcGFuPgogICAgICAgPHR0Pm9iai5kaXZpZGUgPSB7e29iai5kaXZpZGV9fTwvdHQ+PGJyPgogICAgICAgPHR0Pm9iai51cGRhdGVDb3VudCA9IHt7b2JqLnVwZGF0ZUNvdW50fX08L3R0PgogICAgIDwvZG9jOnNvdXJjZT4KICAgICA8ZG9jOnNjZW5hcmlvPgogICAgICAgaXQoJ3Nob3VsZCBjaGVjayBldmFsJywgZnVuY3Rpb24oKXsKICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ29iai5kaXZpZGUnKSkudG9CZSgnMycpOwogICAgICAgICBleHBlY3QoYmluZGluZygnb2JqLnVwZGF0ZUNvdW50JykpLnRvQmUoJzInKTsKICAgICAgICAgaW5wdXQoJ29iai5hJykuZW50ZXIoJzEyJyk7CiAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdvYmouZGl2aWRlJykpLnRvQmUoJzYnKTsKICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ29iai51cGRhdGVDb3VudCcpKS50b0JlKCczJyk7CiAgICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgPC9kb2M6ZXhhbXBsZT4KICovCmFuZ3VsYXJEaXJlY3RpdmUoIm5nOmV2YWwiLCBmdW5jdGlvbihleHByZXNzaW9uKXsKICByZXR1cm4gZnVuY3Rpb24oZWxlbWVudCl7CiAgICB0aGlzLiRvbkV2YWwoZXhwcmVzc2lvbiwgZWxlbWVudCk7CiAgfTsKfSk7CgovKioKICogQHdvcmtJblByb2dyZXNzCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgYW5ndWxhci5kaXJlY3RpdmUubmc6YmluZAogKgogKiBAZGVzY3JpcHRpb24KICogVGhlIGBuZzpiaW5kYCBhdHRyaWJ1dGUgYXNrcyBhbmd1bGFyIHRvIHJlcGxhY2UgdGhlIHRleHQgY29udGVudCBvZiB0aGlzCiAqIEhUTUwgZWxlbWVudCB3aXRoIHRoZSB2YWx1ZSBvZiB0aGUgZ2l2ZW4gZXhwcmVzc2lvbiwgYW5kIHRvIGtlZXAgdGhlIHRleHQKICogY29udGVudCB1cCB0byBkYXRlIHdoZW4gdGhlIGV4cHJlc3Npb24ncyB2YWx1ZSBjaGFuZ2VzLiBVc3VhbGx5IHlvdSB3b3VsZAogKiBqdXN0IHdyaXRlIGB7eyBleHByZXNzaW9uIH19YCBhbmQgbGV0IGFuZ3VsYXIgY29tcGlsZSBpdCBpbnRvCiAqIGA8c3BhbiBuZzpiaW5kPSJleHByZXNzaW9uIj48L3NwYW4+YCBhdCBib290c3RyYXAgdGltZS4KICoKICogQGVsZW1lbnQgQU5ZCiAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gZXhwcmVzc2lvbiB7QGxpbmsgZ3VpZGUvZGV2X2d1aWRlLmV4cHJlc3Npb25zIEV4cHJlc3Npb259IHRvIGV2YWwuCiAqCiAqIEBleGFtcGxlCiAqIFlvdSBjYW4gdHJ5IGl0IHJpZ2h0IGhlcmU6IGVudGVyIHRleHQgaW4gdGhlIHRleHQgYm94IGFuZCB3YXRjaCB0aGUgZ3JlZXRpbmcgY2hhbmdlLgogICA8ZG9jOmV4YW1wbGU+CiAgICAgPGRvYzpzb3VyY2U+CiAgICAgICBFbnRlciBuYW1lOiA8aW5wdXQgdHlwZT0idGV4dCIgbmFtZT0ibmFtZSIgdmFsdWU9IldoaXJsZWQiPiA8YnI+CiAgICAgICBIZWxsbyA8c3BhbiBuZzpiaW5kPSJuYW1lIiAvPiEKICAgICA8L2RvYzpzb3VyY2U+CiAgICAgPGRvYzpzY2VuYXJpbz4KICAgICAgIGl0KCdzaG91bGQgY2hlY2sgbmc6YmluZCcsIGZ1bmN0aW9uKCl7CiAgICAgICAgIGV4cGVjdCh1c2luZygnLmRvYy1leGFtcGxlLWxpdmUnKS5iaW5kaW5nKCduYW1lJykpLnRvQmUoJ1doaXJsZWQnKTsKICAgICAgICAgdXNpbmcoJy5kb2MtZXhhbXBsZS1saXZlJykuaW5wdXQoJ25hbWUnKS5lbnRlcignd29ybGQnKTsKICAgICAgICAgZXhwZWN0KHVzaW5nKCcuZG9jLWV4YW1wbGUtbGl2ZScpLmJpbmRpbmcoJ25hbWUnKSkudG9CZSgnd29ybGQnKTsKICAgICAgIH0pOwogICAgIDwvZG9jOnNjZW5hcmlvPgogICA8L2RvYzpleGFtcGxlPgogKi8KYW5ndWxhckRpcmVjdGl2ZSgibmc6YmluZCIsIGZ1bmN0aW9uKGV4cHJlc3Npb24sIGVsZW1lbnQpewogIGVsZW1lbnQuYWRkQ2xhc3MoJ25nLWJpbmRpbmcnKTsKICByZXR1cm4gZnVuY3Rpb24oZWxlbWVudCkgewogICAgdmFyIGxhc3RWYWx1ZSA9IG5vb3AsIGxhc3RFcnJvciA9IG5vb3A7CiAgICB0aGlzLiRvbkV2YWwoZnVuY3Rpb24oKSB7CiAgICAgIHZhciBlcnJvciwgdmFsdWUsIGh0bWwsIGlzSHRtbCwgaXNEb21FbGVtZW50LAogICAgICAgICAgb2xkRWxlbWVudCA9IHRoaXMuaGFzT3duUHJvcGVydHkoJCRlbGVtZW50KSA/IHRoaXMuJGVsZW1lbnQgOiB1bmRlZmluZWQ7CiAgICAgIHRoaXMuJGVsZW1lbnQgPSBlbGVtZW50OwogICAgICB2YWx1ZSA9IHRoaXMuJHRyeUV2YWwoZXhwcmVzc2lvbiwgZnVuY3Rpb24oZSl7CiAgICAgICAgZXJyb3IgPSBmb3JtYXRFcnJvcihlKTsKICAgICAgfSk7CiAgICAgIHRoaXMuJGVsZW1lbnQgPSBvbGRFbGVtZW50OwogICAgICAvLyBJZiB3ZSBhcmUgSFRNTCB0aGVuIHNhdmUgdGhlIHJhdyBIVE1MIGRhdGEgc28gdGhhdCB3ZSBkb24ndAogICAgICAvLyByZWNvbXB1dGUgc2FuaXRpemF0aW9uIHNpbmNlIGl0IGlzIGV4cGVuc2l2ZS4KICAgICAgLy8gVE9ETzogdHVybiB0aGlzIGludG8gYSBtb3JlIGdlbmVyaWMgd2F5IHRvIGNvbXB1dGUgdGhpcwogICAgICBpZiAoaXNIdG1sID0gKHZhbHVlIGluc3RhbmNlb2YgSFRNTCkpCiAgICAgICAgdmFsdWUgPSAoaHRtbCA9IHZhbHVlKS5odG1sOwogICAgICBpZiAobGFzdFZhbHVlID09PSB2YWx1ZSAmJiBsYXN0RXJyb3IgPT0gZXJyb3IpIHJldHVybjsKICAgICAgaXNEb21FbGVtZW50ID0gaXNFbGVtZW50KHZhbHVlKTsKICAgICAgaWYgKCFpc0h0bWwgJiYgIWlzRG9tRWxlbWVudCAmJiBpc09iamVjdCh2YWx1ZSkpIHsKICAgICAgICB2YWx1ZSA9IHRvSnNvbih2YWx1ZSwgdHJ1ZSk7CiAgICAgIH0KICAgICAgaWYgKHZhbHVlICE9IGxhc3RWYWx1ZSB8fCBlcnJvciAhPSBsYXN0RXJyb3IpIHsKICAgICAgICBsYXN0VmFsdWUgPSB2YWx1ZTsKICAgICAgICBsYXN0RXJyb3IgPSBlcnJvcjsKICAgICAgICBlbGVtZW50RXJyb3IoZWxlbWVudCwgTkdfRVhDRVBUSU9OLCBlcnJvcik7CiAgICAgICAgaWYgKGVycm9yKSB2YWx1ZSA9IGVycm9yOwogICAgICAgIGlmIChpc0h0bWwpIHsKICAgICAgICAgIGVsZW1lbnQuaHRtbChodG1sLmdldCgpKTsKICAgICAgICB9IGVsc2UgaWYgKGlzRG9tRWxlbWVudCkgewogICAgICAgICAgZWxlbWVudC5odG1sKCcnKTsKICAgICAgICAgIGVsZW1lbnQuYXBwZW5kKHZhbHVlKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZWxlbWVudC50ZXh0KHZhbHVlID09IHVuZGVmaW5lZCA/ICcnIDogdmFsdWUpOwogICAgICAgIH0KICAgICAgfQogICAgfSwgZWxlbWVudCk7CiAgfTsKfSk7Cgp2YXIgYmluZFRlbXBsYXRlQ2FjaGUgPSB7fTsKZnVuY3Rpb24gY29tcGlsZUJpbmRUZW1wbGF0ZSh0ZW1wbGF0ZSl7CiAgdmFyIGZuID0gYmluZFRlbXBsYXRlQ2FjaGVbdGVtcGxhdGVdOwogIGlmICghZm4pIHsKICAgIHZhciBiaW5kaW5ncyA9IFtdOwogICAgZm9yRWFjaChwYXJzZUJpbmRpbmdzKHRlbXBsYXRlKSwgZnVuY3Rpb24odGV4dCl7CiAgICAgIHZhciBleHAgPSBiaW5kaW5nKHRleHQpOwogICAgICBiaW5kaW5ncy5wdXNoKGV4cAogICAgICAgID8gZnVuY3Rpb24oZWxlbWVudCl7CiAgICAgICAgICAgIHZhciBlcnJvciwgdmFsdWUgPSB0aGlzLiR0cnlFdmFsKGV4cCwgZnVuY3Rpb24oZSl7CiAgICAgICAgICAgICAgZXJyb3IgPSB0b0pzb24oZSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBlbGVtZW50RXJyb3IoZWxlbWVudCwgTkdfRVhDRVBUSU9OLCBlcnJvcik7CiAgICAgICAgICAgIHJldHVybiBlcnJvciA/IGVycm9yIDogdmFsdWU7CiAgICAgICAgICB9CiAgICAgICAgOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHRleHQ7CiAgICAgICAgICB9KTsKICAgIH0pOwogICAgYmluZFRlbXBsYXRlQ2FjaGVbdGVtcGxhdGVdID0gZm4gPSBmdW5jdGlvbihlbGVtZW50LCBwcmV0dHlQcmludEpzb24pewogICAgICB2YXIgcGFydHMgPSBbXSwgc2VsZiA9IHRoaXMsCiAgICAgICAgIG9sZEVsZW1lbnQgPSB0aGlzLmhhc093blByb3BlcnR5KCQkZWxlbWVudCkgPyBzZWxmLiRlbGVtZW50IDogdW5kZWZpbmVkOwogICAgICBzZWxmLiRlbGVtZW50ID0gZWxlbWVudDsKICAgICAgZm9yICggdmFyIGkgPSAwOyBpIDwgYmluZGluZ3MubGVuZ3RoOyBpKyspIHsKICAgICAgICB2YXIgdmFsdWUgPSBiaW5kaW5nc1tpXS5jYWxsKHNlbGYsIGVsZW1lbnQpOwogICAgICAgIGlmIChpc0VsZW1lbnQodmFsdWUpKQogICAgICAgICAgdmFsdWUgPSAnJzsKICAgICAgICBlbHNlIGlmIChpc09iamVjdCh2YWx1ZSkpCiAgICAgICAgICB2YWx1ZSA9IHRvSnNvbih2YWx1ZSwgcHJldHR5UHJpbnRKc29uKTsKICAgICAgICBwYXJ0cy5wdXNoKHZhbHVlKTsKICAgICAgfQogICAgICBzZWxmLiRlbGVtZW50ID0gb2xkRWxlbWVudDsKICAgICAgcmV0dXJuIHBhcnRzLmpvaW4oJycpOwogICAgfTsKICB9CiAgcmV0dXJuIGZuOwp9CgovKioKICogQHdvcmtJblByb2dyZXNzCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgYW5ndWxhci5kaXJlY3RpdmUubmc6YmluZC10ZW1wbGF0ZQogKgogKiBAZGVzY3JpcHRpb24KICogVGhlIGBuZzpiaW5kLXRlbXBsYXRlYCBhdHRyaWJ1dGUgc3BlY2lmaWVzIHRoYXQgdGhlIGVsZW1lbnQKICogdGV4dCBzaG91bGQgYmUgcmVwbGFjZWQgd2l0aCB0aGUgdGVtcGxhdGUgaW4gbmc6YmluZC10ZW1wbGF0ZS4KICogVW5saWtlIG5nOmJpbmQgdGhlIG5nOmJpbmQtdGVtcGxhdGUgY2FuIGNvbnRhaW4gbXVsdGlwbGUgYHt7YCBgfX1gCiAqIGV4cHJlc3Npb25zLiAoVGhpcyBpcyByZXF1aXJlZCBzaW5jZSBzb21lIEhUTUwgZWxlbWVudHMKICogY2FuIG5vdCBoYXZlIFNQQU4gZWxlbWVudHMgc3VjaCBhcyBUSVRMRSwgb3IgT1BUSU9OIHRvIG5hbWUgYSBmZXcuKQogKgogKiBAZWxlbWVudCBBTlkKICogQHBhcmFtIHtzdHJpbmd9IHRlbXBsYXRlIG9mIGZvcm0KICogICA8dHQ+e3s8L3R0PiA8dHQ+ZXhwcmVzc2lvbjwvdHQ+IDx0dD59fTwvdHQ+IHRvIGV2YWwuCiAqCiAqIEBleGFtcGxlCiAqIFRyeSBpdCBoZXJlOiBlbnRlciB0ZXh0IGluIHRleHQgYm94IGFuZCB3YXRjaCB0aGUgZ3JlZXRpbmcgY2hhbmdlLgogICA8ZG9jOmV4YW1wbGU+CiAgICAgPGRvYzpzb3VyY2U+CiAgICAgIFNhbHV0YXRpb246IDxpbnB1dCB0eXBlPSJ0ZXh0IiBuYW1lPSJzYWx1dGF0aW9uIiB2YWx1ZT0iSGVsbG8iPjxici8+CiAgICAgIE5hbWU6IDxpbnB1dCB0eXBlPSJ0ZXh0IiBuYW1lPSJuYW1lIiB2YWx1ZT0iV29ybGQiPjxici8+CiAgICAgIDxwcmUgbmc6YmluZC10ZW1wbGF0ZT0ie3tzYWx1dGF0aW9ufX0ge3tuYW1lfX0hIj48L3ByZT4KICAgICA8L2RvYzpzb3VyY2U+CiAgICAgPGRvYzpzY2VuYXJpbz4KICAgICAgIGl0KCdzaG91bGQgY2hlY2sgbmc6YmluZCcsIGZ1bmN0aW9uKCl7CiAgICAgICAgIGV4cGVjdCh1c2luZygnLmRvYy1leGFtcGxlLWxpdmUnKS5iaW5kaW5nKCd7e3NhbHV0YXRpb259fSB7e25hbWV9fScpKS4KICAgICAgICAgICB0b0JlKCdIZWxsbyBXb3JsZCEnKTsKICAgICAgICAgdXNpbmcoJy5kb2MtZXhhbXBsZS1saXZlJykuaW5wdXQoJ3NhbHV0YXRpb24nKS5lbnRlcignR3JlZXRpbmdzJyk7CiAgICAgICAgIHVzaW5nKCcuZG9jLWV4YW1wbGUtbGl2ZScpLmlucHV0KCduYW1lJykuZW50ZXIoJ3VzZXInKTsKICAgICAgICAgZXhwZWN0KHVzaW5nKCcuZG9jLWV4YW1wbGUtbGl2ZScpLmJpbmRpbmcoJ3t7c2FsdXRhdGlvbn19IHt7bmFtZX19JykpLgogICAgICAgICAgIHRvQmUoJ0dyZWV0aW5ncyB1c2VyIScpOwogICAgICAgfSk7CiAgICAgPC9kb2M6c2NlbmFyaW8+CiAgIDwvZG9jOmV4YW1wbGU+CiAqLwphbmd1bGFyRGlyZWN0aXZlKCJuZzpiaW5kLXRlbXBsYXRlIiwgZnVuY3Rpb24oZXhwcmVzc2lvbiwgZWxlbWVudCl7CiAgZWxlbWVudC5hZGRDbGFzcygnbmctYmluZGluZycpOwogIHZhciB0ZW1wbGF0ZUZuID0gY29tcGlsZUJpbmRUZW1wbGF0ZShleHByZXNzaW9uKTsKICByZXR1cm4gZnVuY3Rpb24oZWxlbWVudCkgewogICAgdmFyIGxhc3RWYWx1ZTsKICAgIHRoaXMuJG9uRXZhbChmdW5jdGlvbigpIHsKICAgICAgdmFyIHZhbHVlID0gdGVtcGxhdGVGbi5jYWxsKHRoaXMsIGVsZW1lbnQsIHRydWUpOwogICAgICBpZiAodmFsdWUgIT0gbGFzdFZhbHVlKSB7CiAgICAgICAgZWxlbWVudC50ZXh0KHZhbHVlKTsKICAgICAgICBsYXN0VmFsdWUgPSB2YWx1ZTsKICAgICAgfQogICAgfSwgZWxlbWVudCk7CiAgfTsKfSk7Cgp2YXIgUkVNT1ZFX0FUVFJJQlVURVMgPSB7CiAgJ2Rpc2FibGVkJzonZGlzYWJsZWQnLAogICdyZWFkb25seSc6J3JlYWRPbmx5JywKICAnY2hlY2tlZCc6J2NoZWNrZWQnLAogICdzZWxlY3RlZCc6J3NlbGVjdGVkJywKICAnbXVsdGlwbGUnOidtdWx0aXBsZScKfTsKLyoqCiAqIEB3b3JrSW5Qcm9ncmVzcwogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIGFuZ3VsYXIuZGlyZWN0aXZlLm5nOmJpbmQtYXR0cgogKgogKiBAZGVzY3JpcHRpb24KICogVGhlIGBuZzpiaW5kLWF0dHJgIGF0dHJpYnV0ZSBzcGVjaWZpZXMgdGhhdAogKiB7QGxpbmsgZ3VpZGUvZGV2X2d1aWRlLnRlbXBsYXRlcy5kYXRhYmluZGluZyBkYXRhYmluZGluZ3N9ICBzaG91bGQgYmUgY3JlYXRlZCBiZXR3ZWVuIGVsZW1lbnQKICogYXR0cmlidXRlcyBhbmQgZ2l2ZW4gZXhwcmVzc2lvbnMuIFVubGlrZSBgbmc6YmluZGAgdGhlIGBuZzpiaW5kLWF0dHJgIGNvbnRhaW5zIGEgSlNPTiBrZXkgdmFsdWUKICogcGFpcnMgcmVwcmVzZW50aW5nIHdoaWNoIGF0dHJpYnV0ZXMgbmVlZCB0byBiZSBtYXBwZWQgdG8gd2hpY2gKICoge0BsaW5rIGd1aWRlL2Rldl9ndWlkZS5leHByZXNzaW9ucyBleHByZXNzaW9uc30uCiAqCiAqIFlvdSBkb24ndCB1c3VhbGx5IHdyaXRlIHRoZSBgbmc6YmluZC1hdHRyYCBpbiB0aGUgSFRNTCBzaW5jZSBlbWJlZGRpbmcKICogPHR0IG5nOm5vbi1iaW5kYWJsZT57e2V4cHJlc3Npb259fTwvdHQ+IGludG8gdGhlIGF0dHJpYnV0ZSBkaXJlY3RseSBhcyB0aGUgYXR0cmlidXRlIHZhbHVlIGlzCiAqIHByZWZlcnJlZC4gVGhlIGF0dHJpYnV0ZXMgZ2V0IHRyYW5zbGF0ZWQgaW50byBgPHNwYW4gbmc6YmluZC1hdHRyPSJ7YXR0cjpleHByZXNzaW9ufSIvPmAgYXQKICogY29tcGlsZSB0aW1lLgogKgogKiBUaGlzIEhUTUwgc25pcHBldCBpcyBwcmVmZXJyZWQgd2F5IG9mIHdvcmtpbmcgd2l0aCBgbmc6YmluZC1hdHRyYAogKiA8cHJlPgogKiAgIDxhIGhyZWY9Imh0dHA6Ly93d3cuZ29vZ2xlLmNvbS9zZWFyY2g/cT17e3F1ZXJ5fX0iPkdvb2dsZTwvYT4KICogPC9wcmU+CiAqCiAqIFRoZSBhYm92ZSBnZXRzIHRyYW5zbGF0ZWQgdG8gYmVsbG93IGR1cmluZyBib290c3RyYXAgdGltZS4KICogPHByZT4KICogICA8YSBuZzpiaW5kLWF0dHI9J3siaHJlZiI6Imh0dHA6Ly93d3cuZ29vZ2xlLmNvbS9zZWFyY2g/cT17e3F1ZXJ5fX0ifSc+R29vZ2xlPC9hPgogKiA8L3ByZT4KICoKICogQGVsZW1lbnQgQU5ZCiAqIEBwYXJhbSB7c3RyaW5nfSBhdHRyaWJ1dGVfanNvbiBhIEpTT04ga2V5LXZhbHVlIHBhaXJzIHJlcHJlc2VudGluZwogKiAgICB0aGUgYXR0cmlidXRlcyB0byByZXBsYWNlLiBFYWNoIGtleSBtYXRjaGVzIHRoZSBhdHRyaWJ1dGUKICogICAgd2hpY2ggbmVlZHMgdG8gYmUgcmVwbGFjZWQuIEVhY2ggdmFsdWUgaXMgYSB0ZXh0IHRlbXBsYXRlIG9mCiAqICAgIHRoZSBhdHRyaWJ1dGUgd2l0aCBlbWJlZGRlZAogKiAgICA8dHQgbmc6bm9uLWJpbmRhYmxlPnt7ZXhwcmVzc2lvbn19PC90dD5zLiBBbnkgbnVtYmVyIG9mCiAqICAgIGtleS12YWx1ZSBwYWlycyBjYW4gYmUgc3BlY2lmaWVkLgogKgogKiBAZXhhbXBsZQogKiBUcnkgaXQgaGVyZTogZW50ZXIgdGV4dCBpbiB0ZXh0IGJveCBhbmQgY2xpY2sgR29vZ2xlLgogICA8ZG9jOmV4YW1wbGU+CiAgICAgPGRvYzpzb3VyY2U+CiAgICAgIEdvb2dsZSBmb3I6CiAgICAgIDxpbnB1dCB0eXBlPSJ0ZXh0IiBuYW1lPSJxdWVyeSIgdmFsdWU9IkFuZ3VsYXJKUyIvPgogICAgICA8YSBocmVmPSJodHRwOi8vd3d3Lmdvb2dsZS5jb20vc2VhcmNoP3E9e3txdWVyeX19Ij5Hb29nbGU8L2E+CiAgICAgPC9kb2M6c291cmNlPgogICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgICBpdCgnc2hvdWxkIGNoZWNrIG5nOmJpbmQtYXR0cicsIGZ1bmN0aW9uKCl7CiAgICAgICAgIGV4cGVjdCh1c2luZygnLmRvYy1leGFtcGxlLWxpdmUnKS5lbGVtZW50KCdhJykuYXR0cignaHJlZicpKS4KICAgICAgICAgICB0b0JlKCdodHRwOi8vd3d3Lmdvb2dsZS5jb20vc2VhcmNoP3E9QW5ndWxhckpTJyk7CiAgICAgICAgIHVzaW5nKCcuZG9jLWV4YW1wbGUtbGl2ZScpLmlucHV0KCdxdWVyeScpLmVudGVyKCdnb29nbGUnKTsKICAgICAgICAgZXhwZWN0KHVzaW5nKCcuZG9jLWV4YW1wbGUtbGl2ZScpLmVsZW1lbnQoJ2EnKS5hdHRyKCdocmVmJykpLgogICAgICAgICAgIHRvQmUoJ2h0dHA6Ly93d3cuZ29vZ2xlLmNvbS9zZWFyY2g/cT1nb29nbGUnKTsKICAgICAgIH0pOwogICAgIDwvZG9jOnNjZW5hcmlvPgogICA8L2RvYzpleGFtcGxlPgogKi8KYW5ndWxhckRpcmVjdGl2ZSgibmc6YmluZC1hdHRyIiwgZnVuY3Rpb24oZXhwcmVzc2lvbil7CiAgcmV0dXJuIGZ1bmN0aW9uKGVsZW1lbnQpewogICAgdmFyIGxhc3RWYWx1ZSA9IHt9OwogICAgdGhpcy4kb25FdmFsKGZ1bmN0aW9uKCl7CiAgICAgIHZhciB2YWx1ZXMgPSB0aGlzLiRldmFsKGV4cHJlc3Npb24pOwogICAgICBmb3IodmFyIGtleSBpbiB2YWx1ZXMpIHsKICAgICAgICB2YXIgdmFsdWUgPSBjb21waWxlQmluZFRlbXBsYXRlKHZhbHVlc1trZXldKS5jYWxsKHRoaXMsIGVsZW1lbnQpLAogICAgICAgICAgICBzcGVjaWFsTmFtZSA9IFJFTU9WRV9BVFRSSUJVVEVTW2xvd2VyY2FzZShrZXkpXTsKICAgICAgICBpZiAobGFzdFZhbHVlW2tleV0gIT09IHZhbHVlKSB7CiAgICAgICAgICBsYXN0VmFsdWVba2V5XSA9IHZhbHVlOwogICAgICAgICAgaWYgKHNwZWNpYWxOYW1lKSB7CiAgICAgICAgICAgIGlmICh0b0Jvb2xlYW4odmFsdWUpKSB7CiAgICAgICAgICAgICAgZWxlbWVudC5hdHRyKHNwZWNpYWxOYW1lLCBzcGVjaWFsTmFtZSk7CiAgICAgICAgICAgICAgZWxlbWVudC5hdHRyKCduZy0nICsgc3BlY2lhbE5hbWUsIHZhbHVlKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBlbGVtZW50LnJlbW92ZUF0dHIoc3BlY2lhbE5hbWUpOwogICAgICAgICAgICAgIGVsZW1lbnQucmVtb3ZlQXR0cignbmctJyArIHNwZWNpYWxOYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAoZWxlbWVudC5kYXRhKCQkdmFsaWRhdGUpfHxub29wKSgpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZWxlbWVudC5hdHRyKGtleSwgdmFsdWUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfSwgZWxlbWVudCk7CiAgfTsKfSk7CgoKLyoqCiAqIEB3b3JrSW5Qcm9ncmVzcwogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIGFuZ3VsYXIuZGlyZWN0aXZlLm5nOmNsaWNrCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBUaGUgbmc6Y2xpY2sgYWxsb3dzIHlvdSB0byBzcGVjaWZ5IGN1c3RvbSBiZWhhdmlvciB3aGVuCiAqIGVsZW1lbnQgaXMgY2xpY2tlZC4KICoKICogQGVsZW1lbnQgQU5ZCiAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gZXhwcmVzc2lvbiB7QGxpbmsgZ3VpZGUvZGV2X2d1aWRlLmV4cHJlc3Npb25zIEV4cHJlc3Npb259IHRvIGV2YWwgdXBvbiBjbGljay4KICoKICogQGV4YW1wbGUKICAgPGRvYzpleGFtcGxlPgogICAgIDxkb2M6c291cmNlPgogICAgICA8YnV0dG9uIG5nOmNsaWNrPSJjb3VudCA9IGNvdW50ICsgMSIgbmc6aW5pdD0iY291bnQ9MCI+CiAgICAgICAgSW5jcmVtZW50CiAgICAgIDwvYnV0dG9uPgogICAgICBjb3VudDoge3tjb3VudH19CiAgICAgPC9kb2M6c291cmNlPgogICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgICBpdCgnc2hvdWxkIGNoZWNrIG5nOmNsaWNrJywgZnVuY3Rpb24oKXsKICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ2NvdW50JykpLnRvQmUoJzAnKTsKICAgICAgICAgZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgOmJ1dHRvbicpLmNsaWNrKCk7CiAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdjb3VudCcpKS50b0JlKCcxJyk7CiAgICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgPC9kb2M6ZXhhbXBsZT4KICovCi8qCiAqIEEgZGlyZWN0aXZlIHRoYXQgYWxsb3dzIGNyZWF0aW9uIG9mIGN1c3RvbSBvbmNsaWNrIGhhbmRsZXJzIHRoYXQgYXJlIGRlZmluZWQgYXMgYW5ndWxhcgogKiBleHByZXNzaW9ucyBhbmQgYXJlIGNvbXBpbGVkIGFuZCBleGVjdXRlZCB3aXRoaW4gdGhlIGN1cnJlbnQgc2NvcGUuCiAqCiAqIEV2ZW50cyB0aGF0IGFyZSBoYW5kbGVkIHZpYSB0aGVzZSBoYW5kbGVyIGFyZSBhbHdheXMgY29uZmlndXJlZCBub3QgdG8gcHJvcGFnYXRlIGZ1cnRoZXIuCiAqCiAqIFRPRE86IG1heWJlIHdlIHNob3VsZCBjb25zaWRlciBhbGxvd2luZyB1c2VycyB0byBjb250cm9sIGV2ZW50IHByb3BhZ2F0aW9uIGluIHRoZSBmdXR1cmUuCiAqLwphbmd1bGFyRGlyZWN0aXZlKCJuZzpjbGljayIsIGZ1bmN0aW9uKGV4cHJlc3Npb24sIGVsZW1lbnQpewogIHJldHVybiBhbm5vdGF0ZSgnJHVwZGF0ZVZpZXcnLCBmdW5jdGlvbigkdXBkYXRlVmlldywgZWxlbWVudCl7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICBlbGVtZW50LmJpbmQoJ2NsaWNrJywgZnVuY3Rpb24oZXZlbnQpewogICAgICBzZWxmLiR0cnlFdmFsKGV4cHJlc3Npb24sIGVsZW1lbnQpOwogICAgICAkdXBkYXRlVmlldygpOwogICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTsKICAgIH0pOwogIH0pOwp9KTsKCgovKioKICogQHdvcmtJblByb2dyZXNzCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgYW5ndWxhci5kaXJlY3RpdmUubmc6c3VibWl0CiAqCiAqIEBkZXNjcmlwdGlvbgogKiBFbmFibGVzIGJpbmRpbmcgYW5ndWxhciBleHByZXNzaW9ucyB0byBvbnN1Ym1pdCBldmVudHMuCiAqCiAqIEFkZGl0aW9uYWxseSBpdCBwcmV2ZW50cyB0aGUgZGVmYXVsdCBhY3Rpb24gKHdoaWNoIGZvciBmb3JtIG1lYW5zIHNlbmRpbmcgdGhlIHJlcXVlc3QgdG8gdGhlCiAqIHNlcnZlciBhbmQgcmVsb2FkaW5nIHRoZSBjdXJyZW50IHBhZ2UpLgogKgogKiBAZWxlbWVudCBmb3JtCiAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gZXhwcmVzc2lvbiB7QGxpbmsgZ3VpZGUvZGV2X2d1aWRlLmV4cHJlc3Npb25zIEV4cHJlc3Npb259IHRvIGV2YWwuCiAqCiAqIEBleGFtcGxlCiAgIDxkb2M6ZXhhbXBsZT4KICAgICA8ZG9jOnNvdXJjZT4KICAgICAgPGZvcm0gbmc6c3VibWl0PSJsaXN0LnB1c2godGV4dCk7dGV4dD0nJzsiIG5nOmluaXQ9Imxpc3Q9W10iPgogICAgICAgIEVudGVyIHRleHQgYW5kIGhpdCBlbnRlcjoKICAgICAgICA8aW5wdXQgdHlwZT0idGV4dCIgbmFtZT0idGV4dCIgdmFsdWU9ImhlbGxvIi8+CiAgICAgICAgPGlucHV0IHR5cGU9InN1Ym1pdCIgaWQ9InN1Ym1pdCIgdmFsdWU9IlN1Ym1pdCIgLz4KICAgICAgPC9mb3JtPgogICAgICA8cHJlPmxpc3Q9e3tsaXN0fX08L3ByZT4KICAgICA8L2RvYzpzb3VyY2U+CiAgICAgPGRvYzpzY2VuYXJpbz4KICAgICAgIGl0KCdzaG91bGQgY2hlY2sgbmc6c3VibWl0JywgZnVuY3Rpb24oKXsKICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ2xpc3QnKSkudG9CZSgnbGlzdD1bXScpOwogICAgICAgICBlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSAjc3VibWl0JykuY2xpY2soKTsKICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ2xpc3QnKSkudG9CZSgnbGlzdD1bImhlbGxvIl0nKTsKICAgICAgIH0pOwogICAgIDwvZG9jOnNjZW5hcmlvPgogICA8L2RvYzpleGFtcGxlPgogKi8KYW5ndWxhckRpcmVjdGl2ZSgibmc6c3VibWl0IiwgZnVuY3Rpb24oZXhwcmVzc2lvbiwgZWxlbWVudCkgewogIHJldHVybiBhbm5vdGF0ZSgnJHVwZGF0ZVZpZXcnLCBmdW5jdGlvbigkdXBkYXRlVmlldywgZWxlbWVudCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgZWxlbWVudC5iaW5kKCdzdWJtaXQnLCBmdW5jdGlvbihldmVudCkgewogICAgICBzZWxmLiR0cnlFdmFsKGV4cHJlc3Npb24sIGVsZW1lbnQpOwogICAgICAkdXBkYXRlVmlldygpOwogICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgfSk7CiAgfSk7Cn0pOwoKCmZ1bmN0aW9uIG5nQ2xhc3Moc2VsZWN0b3IpIHsKICByZXR1cm4gZnVuY3Rpb24oZXhwcmVzc2lvbiwgZWxlbWVudCl7CiAgICB2YXIgZXhpc3RpbmcgPSBlbGVtZW50WzBdLmNsYXNzTmFtZSArICcgJzsKICAgIHJldHVybiBmdW5jdGlvbihlbGVtZW50KXsKICAgICAgdGhpcy4kb25FdmFsKGZ1bmN0aW9uKCl7CiAgICAgICAgdmFyIHNjb3BlID0gdGhpczsKCiAgICAgICAgaWYgKHNlbGVjdG9yKHNjb3BlLiRpbmRleCkpIHsKICAgICAgICAgIHZhciBuZ0NsYXNzVmFsID0gc2NvcGUuJGV2YWwoZWxlbWVudC5hdHRyKCduZzpjbGFzcycpIHx8ICcnKTsKICAgICAgICAgIGlmIChpc0FycmF5KG5nQ2xhc3NWYWwpKSBuZ0NsYXNzVmFsID0gbmdDbGFzc1ZhbC5qb2luKCcgJyk7CiAgICAgICAgICB2YXIgdmFsdWUgPSBzY29wZS4kZXZhbChleHByZXNzaW9uKTsKICAgICAgICAgIGlmIChpc0FycmF5KHZhbHVlKSkgdmFsdWUgPSB2YWx1ZS5qb2luKCcgJyk7CiAgICAgICAgICBpZiAobmdDbGFzc1ZhbCAmJiBuZ0NsYXNzVmFsICE9PSB2YWx1ZSkgdmFsdWUgPSB2YWx1ZSArICcgJyArIG5nQ2xhc3NWYWw7CiAgICAgICAgICBlbGVtZW50WzBdLmNsYXNzTmFtZSA9IHRyaW0oZXhpc3RpbmcgKyB2YWx1ZSk7CiAgICAgICAgfQogICAgICB9LCBlbGVtZW50KTsKICAgIH07CiAgfTsKfQoKLyoqCiAqIEB3b3JrSW5Qcm9ncmVzcwogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIGFuZ3VsYXIuZGlyZWN0aXZlLm5nOmNsYXNzCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBUaGUgYG5nOmNsYXNzYCBhbGxvd3MgeW91IHRvIHNldCBDU1MgY2xhc3Mgb24gSFRNTCBlbGVtZW50CiAqIGNvbmRpdGlvbmFsbHkuCiAqCiAqIEBlbGVtZW50IEFOWQogKiBAcGFyYW0ge2V4cHJlc3Npb259IGV4cHJlc3Npb24ge0BsaW5rIGd1aWRlL2Rldl9ndWlkZS5leHByZXNzaW9ucyBFeHByZXNzaW9ufSB0byBldmFsLgogKgogKiBAZXhhbXBsZQogICA8ZG9jOmV4YW1wbGU+CiAgICAgPGRvYzpzb3VyY2U+CiAgICAgIDxpbnB1dCB0eXBlPSJidXR0b24iIHZhbHVlPSJzZXQiIG5nOmNsaWNrPSJteVZhcj0nbmctaW5wdXQtaW5kaWNhdG9yLXdhaXQnIj4KICAgICAgPGlucHV0IHR5cGU9ImJ1dHRvbiIgdmFsdWU9ImNsZWFyIiBuZzpjbGljaz0ibXlWYXI9JyciPgogICAgICA8YnI+CiAgICAgIDxzcGFuIG5nOmNsYXNzPSJteVZhciI+U2FtcGxlIFRleHQgJm5ic3A7Jm5ic3A7Jm5ic3A7Jm5ic3A7PC9zcGFuPgogICAgIDwvZG9jOnNvdXJjZT4KICAgICA8ZG9jOnNjZW5hcmlvPgogICAgICAgaXQoJ3Nob3VsZCBjaGVjayBuZzpjbGFzcycsIGZ1bmN0aW9uKCl7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBzcGFuJykuYXR0cignY2xhc3NOYW1lJykpLm5vdCgpLgogICAgICAgICAgIHRvTWF0Y2goL25nLWlucHV0LWluZGljYXRvci13YWl0Lyk7CgogICAgICAgICB1c2luZygnLmRvYy1leGFtcGxlLWxpdmUnKS5lbGVtZW50KCc6YnV0dG9uOmZpcnN0JykuY2xpY2soKTsKCiAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBzcGFuJykuYXR0cignY2xhc3NOYW1lJykpLgogICAgICAgICAgIHRvTWF0Y2goL25nLWlucHV0LWluZGljYXRvci13YWl0Lyk7CgogICAgICAgICB1c2luZygnLmRvYy1leGFtcGxlLWxpdmUnKS5lbGVtZW50KCc6YnV0dG9uOmxhc3QnKS5jbGljaygpOwoKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIHNwYW4nKS5hdHRyKCdjbGFzc05hbWUnKSkubm90KCkuCiAgICAgICAgICAgdG9NYXRjaCgvbmctaW5wdXQtaW5kaWNhdG9yLXdhaXQvKTsKICAgICAgIH0pOwogICAgIDwvZG9jOnNjZW5hcmlvPgogICA8L2RvYzpleGFtcGxlPgogKi8KYW5ndWxhckRpcmVjdGl2ZSgibmc6Y2xhc3MiLCBuZ0NsYXNzKGZ1bmN0aW9uKCl7cmV0dXJuIHRydWU7fSkpOwoKLyoqCiAqIEB3b3JrSW5Qcm9ncmVzcwogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIGFuZ3VsYXIuZGlyZWN0aXZlLm5nOmNsYXNzLW9kZAogKgogKiBAZGVzY3JpcHRpb24KICogVGhlIGBuZzpjbGFzcy1vZGRgIGFuZCBgbmc6Y2xhc3MtZXZlbmAgd29ya3MgZXhhY3RseSBhcwogKiBgbmc6Y2xhc3NgLCBleGNlcHQgaXQgd29ya3MgaW4gY29uanVuY3Rpb24gd2l0aCBgbmc6cmVwZWF0YAogKiBhbmQgdGFrZXMgYWZmZWN0IG9ubHkgb24gb2RkIChldmVuKSByb3dzLgogKgogKiBAZWxlbWVudCBBTlkKICogQHBhcmFtIHtleHByZXNzaW9ufSBleHByZXNzaW9uIHtAbGluayBndWlkZS9kZXZfZ3VpZGUuZXhwcmVzc2lvbnMgRXhwcmVzc2lvbn0gdG8gZXZhbC4gTXVzdCBiZQogKiAgaW5zaWRlIGBuZzpyZXBlYXRgLgogKgogKiBAZXhhbXBsZQogICA8ZG9jOmV4YW1wbGU+CiAgICAgPGRvYzpzb3VyY2U+CiAgICAgICAgPG9sIG5nOmluaXQ9Im5hbWVzPVsnSm9obicsICdNYXJ5JywgJ0NhdGUnLCAnU3V6J10iPgogICAgICAgICAgPGxpIG5nOnJlcGVhdD0ibmFtZSBpbiBuYW1lcyI+CiAgICAgICAgICAgPHNwYW4gbmc6Y2xhc3Mtb2RkPSInbmctZm9ybWF0LW5lZ2F0aXZlJyIKICAgICAgICAgICAgICAgICBuZzpjbGFzcy1ldmVuPSInbmctaW5wdXQtaW5kaWNhdG9yLXdhaXQnIj4KICAgICAgICAgICAgIHt7bmFtZX19ICZuYnNwOyAmbmJzcDsgJm5ic3A7CiAgICAgICAgICAgPC9zcGFuPgogICAgICAgICAgPC9saT4KICAgICAgICA8L29sPgogICAgIDwvZG9jOnNvdXJjZT4KICAgICA8ZG9jOnNjZW5hcmlvPgogICAgICAgaXQoJ3Nob3VsZCBjaGVjayBuZzpjbGFzcy1vZGQgYW5kIG5nOmNsYXNzLWV2ZW4nLCBmdW5jdGlvbigpewogICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgbGk6Zmlyc3Qgc3BhbicpLmF0dHIoJ2NsYXNzTmFtZScpKS4KICAgICAgICAgICB0b01hdGNoKC9uZy1mb3JtYXQtbmVnYXRpdmUvKTsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIGxpOmxhc3Qgc3BhbicpLmF0dHIoJ2NsYXNzTmFtZScpKS4KICAgICAgICAgICB0b01hdGNoKC9uZy1pbnB1dC1pbmRpY2F0b3Itd2FpdC8pOwogICAgICAgfSk7CiAgICAgPC9kb2M6c2NlbmFyaW8+CiAgIDwvZG9jOmV4YW1wbGU+CiAqLwphbmd1bGFyRGlyZWN0aXZlKCJuZzpjbGFzcy1vZGQiLCBuZ0NsYXNzKGZ1bmN0aW9uKGkpe3JldHVybiBpICUgMiA9PT0gMDt9KSk7CgovKioKICogQHdvcmtJblByb2dyZXNzCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgYW5ndWxhci5kaXJlY3RpdmUubmc6Y2xhc3MtZXZlbgogKgogKiBAZGVzY3JpcHRpb24KICogVGhlIGBuZzpjbGFzcy1vZGRgIGFuZCBgbmc6Y2xhc3MtZXZlbmAgd29ya3MgZXhhY3RseSBhcwogKiBgbmc6Y2xhc3NgLCBleGNlcHQgaXQgd29ya3MgaW4gY29uanVuY3Rpb24gd2l0aCBgbmc6cmVwZWF0YAogKiBhbmQgdGFrZXMgYWZmZWN0IG9ubHkgb24gb2RkIChldmVuKSByb3dzLgogKgogKiBAZWxlbWVudCBBTlkKICogQHBhcmFtIHtleHByZXNzaW9ufSBleHByZXNzaW9uIHtAbGluayBndWlkZS9kZXZfZ3VpZGUuZXhwcmVzc2lvbnMgRXhwcmVzc2lvbn0gdG8gZXZhbC4gTXVzdCBiZQogKiAgaW5zaWRlIGBuZzpyZXBlYXRgLgogKgogKiBAZXhhbXBsZQogICA8ZG9jOmV4YW1wbGU+CiAgICAgPGRvYzpzb3VyY2U+CiAgICAgICAgPG9sIG5nOmluaXQ9Im5hbWVzPVsnSm9obicsICdNYXJ5JywgJ0NhdGUnLCAnU3V6J10iPgogICAgICAgICAgPGxpIG5nOnJlcGVhdD0ibmFtZSBpbiBuYW1lcyI+CiAgICAgICAgICAgPHNwYW4gbmc6Y2xhc3Mtb2RkPSInbmctZm9ybWF0LW5lZ2F0aXZlJyIKICAgICAgICAgICAgICAgICBuZzpjbGFzcy1ldmVuPSInbmctaW5wdXQtaW5kaWNhdG9yLXdhaXQnIj4KICAgICAgICAgICAgIHt7bmFtZX19ICZuYnNwOyAmbmJzcDsgJm5ic3A7CiAgICAgICAgICAgPC9zcGFuPgogICAgICAgICAgPC9saT4KICAgICAgICA8L29sPgogICAgIDwvZG9jOnNvdXJjZT4KICAgICA8ZG9jOnNjZW5hcmlvPgogICAgICAgaXQoJ3Nob3VsZCBjaGVjayBuZzpjbGFzcy1vZGQgYW5kIG5nOmNsYXNzLWV2ZW4nLCBmdW5jdGlvbigpewogICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgbGk6Zmlyc3Qgc3BhbicpLmF0dHIoJ2NsYXNzTmFtZScpKS4KICAgICAgICAgICB0b01hdGNoKC9uZy1mb3JtYXQtbmVnYXRpdmUvKTsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIGxpOmxhc3Qgc3BhbicpLmF0dHIoJ2NsYXNzTmFtZScpKS4KICAgICAgICAgICB0b01hdGNoKC9uZy1pbnB1dC1pbmRpY2F0b3Itd2FpdC8pOwogICAgICAgfSk7CiAgICAgPC9kb2M6c2NlbmFyaW8+CiAgIDwvZG9jOmV4YW1wbGU+CiAqLwphbmd1bGFyRGlyZWN0aXZlKCJuZzpjbGFzcy1ldmVuIiwgbmdDbGFzcyhmdW5jdGlvbihpKXtyZXR1cm4gaSAlIDIgPT09IDE7fSkpOwoKLyoqCiAqIEB3b3JrSW5Qcm9ncmVzcwogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIGFuZ3VsYXIuZGlyZWN0aXZlLm5nOnNob3cKICoKICogQGRlc2NyaXB0aW9uCiAqIFRoZSBgbmc6c2hvd2AgYW5kIGBuZzpoaWRlYCBkaXJlY3RpdmVzIHNob3cgb3IgaGlkZSBhIHBvcnRpb24gb2YgdGhlIERPTSB0cmVlIChIVE1MKQogKiBjb25kaXRpb25hbGx5LgogKgogKiBAZWxlbWVudCBBTlkKICogQHBhcmFtIHtleHByZXNzaW9ufSBleHByZXNzaW9uIElmIHRoZSB7QGxpbmsgZ3VpZGUvZGV2X2d1aWRlLmV4cHJlc3Npb25zIGV4cHJlc3Npb259IGlzIHRydXRoeQogKiAgICAgdGhlbiB0aGUgZWxlbWVudCBpcyBzaG93biBvciBoaWRkZW4gcmVzcGVjdGl2ZWx5LgogKgogKiBAZXhhbXBsZQogICA8ZG9jOmV4YW1wbGU+CiAgICAgPGRvYzpzb3VyY2U+CiAgICAgICAgQ2xpY2sgbWU6IDxpbnB1dCB0eXBlPSJjaGVja2JveCIgbmFtZT0iY2hlY2tlZCI+PGJyLz4KICAgICAgICBTaG93OiA8c3BhbiBuZzpzaG93PSJjaGVja2VkIj5JIHNob3cgdXAgd2hlbiB5b3VyIGNoZWNrYm94IGlzIGNoZWNrZWQuPC9zcGFuPiA8YnIvPgogICAgICAgIEhpZGU6IDxzcGFuIG5nOmhpZGU9ImNoZWNrZWQiPkkgaGlkZSB3aGVuIHlvdXIgY2hlY2tib3ggaXMgY2hlY2tlZC48L3NwYW4+CiAgICAgPC9kb2M6c291cmNlPgogICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgICBpdCgnc2hvdWxkIGNoZWNrIG5nOnNob3cgLyBuZzpoaWRlJywgZnVuY3Rpb24oKXsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIHNwYW46Zmlyc3Q6aGlkZGVuJykuY291bnQoKSkudG9FcXVhbCgxKTsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIHNwYW46bGFzdDp2aXNpYmxlJykuY291bnQoKSkudG9FcXVhbCgxKTsKCiAgICAgICAgIGlucHV0KCdjaGVja2VkJykuY2hlY2soKTsKCiAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBzcGFuOmZpcnN0OnZpc2libGUnKS5jb3VudCgpKS50b0VxdWFsKDEpOwogICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgc3BhbjpsYXN0OmhpZGRlbicpLmNvdW50KCkpLnRvRXF1YWwoMSk7CiAgICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgPC9kb2M6ZXhhbXBsZT4KICovCmFuZ3VsYXJEaXJlY3RpdmUoIm5nOnNob3ciLCBmdW5jdGlvbihleHByZXNzaW9uLCBlbGVtZW50KXsKICByZXR1cm4gZnVuY3Rpb24oZWxlbWVudCl7CiAgICB0aGlzLiRvbkV2YWwoZnVuY3Rpb24oKXsKICAgICAgZWxlbWVudC5jc3MoJ2Rpc3BsYXknLCB0b0Jvb2xlYW4odGhpcy4kZXZhbChleHByZXNzaW9uKSkgPyAnJyA6ICdub25lJyk7CiAgICB9LCBlbGVtZW50KTsKICB9Owp9KTsKCi8qKgogKiBAd29ya0luUHJvZ3Jlc3MKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBhbmd1bGFyLmRpcmVjdGl2ZS5uZzpoaWRlCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBUaGUgYG5nOmhpZGVgIGFuZCBgbmc6c2hvd2AgZGlyZWN0aXZlcyBoaWRlIG9yIHNob3cgYSBwb3J0aW9uCiAqIG9mIHRoZSBIVE1MIGNvbmRpdGlvbmFsbHkuCiAqCiAqIEBlbGVtZW50IEFOWQogKiBAcGFyYW0ge2V4cHJlc3Npb259IGV4cHJlc3Npb24gSWYgdGhlIHtAbGluayBndWlkZS9kZXZfZ3VpZGUuZXhwcmVzc2lvbnMgZXhwcmVzc2lvbn0gdHJ1dGh5IHRoZW4KICogICAgIHRoZSBlbGVtZW50IGlzIHNob3duIG9yIGhpZGRlbiByZXNwZWN0aXZlbHkuCiAqCiAqIEBleGFtcGxlCiAgIDxkb2M6ZXhhbXBsZT4KICAgICA8ZG9jOnNvdXJjZT4KICAgICAgICBDbGljayBtZTogPGlucHV0IHR5cGU9ImNoZWNrYm94IiBuYW1lPSJjaGVja2VkIj48YnIvPgogICAgICAgIFNob3c6IDxzcGFuIG5nOnNob3c9ImNoZWNrZWQiPkkgc2hvdyB1cCB3aGVuIHlvdSBjaGVja2JveCBpcyBjaGVja2VkPzwvc3Bhbj4gPGJyLz4KICAgICAgICBIaWRlOiA8c3BhbiBuZzpoaWRlPSJjaGVja2VkIj5JIGhpZGUgd2hlbiB5b3UgY2hlY2tib3ggaXMgY2hlY2tlZD88L3NwYW4+CiAgICAgPC9kb2M6c291cmNlPgogICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgICBpdCgnc2hvdWxkIGNoZWNrIG5nOnNob3cgLyBuZzpoaWRlJywgZnVuY3Rpb24oKXsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIHNwYW46Zmlyc3Q6aGlkZGVuJykuY291bnQoKSkudG9FcXVhbCgxKTsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIHNwYW46bGFzdDp2aXNpYmxlJykuY291bnQoKSkudG9FcXVhbCgxKTsKCiAgICAgICAgIGlucHV0KCdjaGVja2VkJykuY2hlY2soKTsKCiAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBzcGFuOmZpcnN0OnZpc2libGUnKS5jb3VudCgpKS50b0VxdWFsKDEpOwogICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgc3BhbjpsYXN0OmhpZGRlbicpLmNvdW50KCkpLnRvRXF1YWwoMSk7CiAgICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgPC9kb2M6ZXhhbXBsZT4KICovCmFuZ3VsYXJEaXJlY3RpdmUoIm5nOmhpZGUiLCBmdW5jdGlvbihleHByZXNzaW9uLCBlbGVtZW50KXsKICByZXR1cm4gZnVuY3Rpb24oZWxlbWVudCl7CiAgICB0aGlzLiRvbkV2YWwoZnVuY3Rpb24oKXsKICAgICAgZWxlbWVudC5jc3MoJ2Rpc3BsYXknLCB0b0Jvb2xlYW4odGhpcy4kZXZhbChleHByZXNzaW9uKSkgPyAnbm9uZScgOiAnJyk7CiAgICB9LCBlbGVtZW50KTsKICB9Owp9KTsKCi8qKgogKiBAd29ya0luUHJvZ3Jlc3MKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBhbmd1bGFyLmRpcmVjdGl2ZS5uZzpzdHlsZQogKgogKiBAZGVzY3JpcHRpb24KICogVGhlIG5nOnN0eWxlIGFsbG93cyB5b3UgdG8gc2V0IENTUyBzdHlsZSBvbiBhbiBIVE1MIGVsZW1lbnQgY29uZGl0aW9uYWxseS4KICoKICogQGVsZW1lbnQgQU5ZCiAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gZXhwcmVzc2lvbiB7QGxpbmsgZ3VpZGUvZGV2X2d1aWRlLmV4cHJlc3Npb25zIEV4cHJlc3Npb259IHdoaWNoIGV2YWxzIHRvIGFuCiAqICAgICAgb2JqZWN0IHdob3NlIGtleXMgYXJlIENTUyBzdHlsZSBuYW1lcyBhbmQgdmFsdWVzIGFyZSBjb3JyZXNwb25kaW5nIHZhbHVlcyBmb3IgdGhvc2UgQ1NTCiAqICAgICAga2V5cy4KICoKICogQGV4YW1wbGUKICAgPGRvYzpleGFtcGxlPgogICAgIDxkb2M6c291cmNlPgogICAgICAgIDxpbnB1dCB0eXBlPSJidXR0b24iIHZhbHVlPSJzZXQiIG5nOmNsaWNrPSJteVN0eWxlPXtjb2xvcjoncmVkJ30iPgogICAgICAgIDxpbnB1dCB0eXBlPSJidXR0b24iIHZhbHVlPSJjbGVhciIgbmc6Y2xpY2s9Im15U3R5bGU9e30iPgogICAgICAgIDxici8+CiAgICAgICAgPHNwYW4gbmc6c3R5bGU9Im15U3R5bGUiPlNhbXBsZSBUZXh0PC9zcGFuPgogICAgICAgIDxwcmU+bXlTdHlsZT17e215U3R5bGV9fTwvcHJlPgogICAgIDwvZG9jOnNvdXJjZT4KICAgICA8ZG9jOnNjZW5hcmlvPgogICAgICAgaXQoJ3Nob3VsZCBjaGVjayBuZzpzdHlsZScsIGZ1bmN0aW9uKCl7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBzcGFuJykuY3NzKCdjb2xvcicpKS50b0JlKCdyZ2IoMCwgMCwgMCknKTsKICAgICAgICAgZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgOmJ1dHRvblt2YWx1ZT1zZXRdJykuY2xpY2soKTsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIHNwYW4nKS5jc3MoJ2NvbG9yJykpLnRvQmUoJ3JlZCcpOwogICAgICAgICBlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSA6YnV0dG9uW3ZhbHVlPWNsZWFyXScpLmNsaWNrKCk7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBzcGFuJykuY3NzKCdjb2xvcicpKS50b0JlKCdyZ2IoMCwgMCwgMCknKTsKICAgICAgIH0pOwogICAgIDwvZG9jOnNjZW5hcmlvPgogICA8L2RvYzpleGFtcGxlPgogKi8KYW5ndWxhckRpcmVjdGl2ZSgibmc6c3R5bGUiLCBmdW5jdGlvbihleHByZXNzaW9uLCBlbGVtZW50KXsKICByZXR1cm4gZnVuY3Rpb24oZWxlbWVudCl7CiAgICB2YXIgcmVzZXRTdHlsZSA9IGdldFN0eWxlKGVsZW1lbnQpOwogICAgdGhpcy4kb25FdmFsKGZ1bmN0aW9uKCl7CiAgICAgIHZhciBzdHlsZSA9IHRoaXMuJGV2YWwoZXhwcmVzc2lvbikgfHwge30sIGtleSwgbWVyZ2VkU3R5bGUgPSB7fTsKICAgICAgZm9yKGtleSBpbiBzdHlsZSkgewogICAgICAgIGlmIChyZXNldFN0eWxlW2tleV0gPT09IHVuZGVmaW5lZCkgcmVzZXRTdHlsZVtrZXldID0gJyc7CiAgICAgICAgbWVyZ2VkU3R5bGVba2V5XSA9IHN0eWxlW2tleV07CiAgICAgIH0KICAgICAgZm9yKGtleSBpbiByZXNldFN0eWxlKSB7CiAgICAgICAgbWVyZ2VkU3R5bGVba2V5XSA9IG1lcmdlZFN0eWxlW2tleV0gfHwgcmVzZXRTdHlsZVtrZXldOwogICAgICB9CiAgICAgIGVsZW1lbnQuY3NzKG1lcmdlZFN0eWxlKTsKICAgIH0sIGVsZW1lbnQpOwogIH07Cn0pOwoKJ3VzZSBzdHJpY3QnOwoKLyoqCiAqIEB3b3JrSW5Qcm9ncmVzcwogKiBAbmdkb2Mgb3ZlcnZpZXcKICogQG5hbWUgYW5ndWxhci5tYXJrdXAKICogQGRlc2NyaXB0aW9uCiAqCiAqIEFuZ3VsYXIgbWFya3VwIHRyYW5zZm9ybXMgY29udGVudCBvZiBET00gZWxlbWVudHMgb3IgcG9ydGlvbnMgb2YgdGhpcyBjb250ZW50IGludG8gb3RoZXIgdGV4dCBvcgogKiBET00gZWxlbWVudHMgZm9yIGZ1cnRoZXIgY29tcGlsYXRpb24uCiAqCiAqIE1hcmt1cCBleHRlbnNpb25zIGRvIG5vdCB0aGVtc2VsdmVzIHByb2R1Y2UgbGlua2luZyBmdW5jdGlvbnMuIFRoaW5rIG9mIG1hcmt1cCBhcyBhIHdheSB0bwogKiBwcm9kdWNlIHNob3J0aGFuZCBmb3IgYSB7QGxpbmsgYW5ndWxhci53aWRnZXQgd2lkZ2V0fSBvciBhIHtAbGluayBhbmd1bGFyLmRpcmVjdGl2ZSBkaXJlY3RpdmV9LgogKgogKiBUaGUgbW9zdCBwcm9taW5lbnQgZXhhbXBsZSBvZiBhIG1hcmt1cCBpbiBhbmd1bGFyIGlzIHRoZSBidWlsdC1pbiBkb3VibGUgY3VybHkgbWFya3VwCiAqIGB7e2V4cHJlc3Npb259fWAsIHdoaWNoIGlzIHNob3J0aGFuZCBmb3IgYDxzcGFuIG5nOmJpbmQ9ImV4cHJlc3Npb24iPjwvc3Bhbj5gLgogKgogKiBDcmVhdGUgY3VzdG9tIG1hcmt1cCBsaWtlIHRoaXM6CiAqCiAqIDxwcmU+CiAqICAgYW5ndWxhci5tYXJrdXAoJ25ld01hcmt1cCcsIGZ1bmN0aW9uKHRleHQsIHRleHROb2RlLCBwYXJlbnRFbGVtZW50KXsKICogICAgIC8vdHJhbmZvcm1hdGlvbiBjb2RlCiAqICAgfSk7CiAqIDwvcHJlPgogKgogKiBGb3IgbW9yZSBpbmZvcm1hdGlvbiBhYm91dCBhbmd1bGFyIG1hcmt1cCwgc2VlIHtAbGluayBndWlkZS9kZXZfZ3VpZGUuY29tcGlsZXIubWFya3VwCiAqIFVuZGVyc3RhbmRpbmcgQW5ndWxhciBNYXJrdXB9IGluIHRoZSBhbmd1bGFyIERldmVsb3BlciBHdWlkZS4KICovCgovKioKICogQHdvcmtJblByb2dyZXNzCiAqIEBuZ2RvYyBvdmVydmlldwogKiBAbmFtZSBhbmd1bGFyLmF0dHJNYXJrdXAKICogQGRlc2NyaXB0aW9uCiAqCiAqIEF0dHJpYnV0ZSBtYXJrdXAgZXh0ZW5kcyB0aGUgYW5ndWxhciBjb21waWxlciBpbiBhIHZlcnkgc2ltaWxhciB3YXkgYXMge0BsaW5rIGFuZ3VsYXIubWFya3VwfQogKiBleGNlcHQgdGhhdCBpdCBhbGxvd3MgeW91IHRvIG1vZGlmeSB0aGUgc3RhdGUgb2YgdGhlIGF0dHJpYnV0ZSB0ZXh0IHJhdGhlciB0aGFuIHRoZSBjb250ZW50IG9mIGEKICogbm9kZS4KICoKICogQ3JlYXRlIGN1c3RvbSBhdHRyaWJ1dGUgbWFya3VwIGxpa2UgdGhpczoKICoKICogPHByZT4KICogICBhbmd1bGFyLmF0dHJNYXJrdXAoJ25ld0F0dHJNYXJrdXAnLCBmdW5jdGlvbihhdHRyVmFsdWUsIGF0dHJOYW1lLCBlbGVtZW50KXsKICogICAgIC8vdHJhbmZvcm1hdGlvbiBjb2RlCiAqICAgfSk7CiAqIDwvcHJlPgogKgogKiBGb3IgbW9yZSBpbmZvcm1hdGlvbiBhYm91dCBhbmd1bGFyIGF0dHJpYnV0ZSBtYXJrdXAsIHNlZSB7QGxpbmsgZ3VpZGUvZGV2X2d1aWRlLmNvbXBpbGVyLm1hcmt1cAogKiBVbmRlcnN0YW5kaW5nIEFuZ3VsYXIgTWFya3VwfSBpbiB0aGUgYW5ndWxhciBEZXZlbG9wZXIgR3VpZGUuCiAqLwoKZnVuY3Rpb24gcGFyc2VCaW5kaW5ncyhzdHJpbmcpIHsKICB2YXIgcmVzdWx0cyA9IFtdOwogIHZhciBsYXN0SW5kZXggPSAwOwogIHZhciBpbmRleDsKICB3aGlsZSgoaW5kZXggPSBzdHJpbmcuaW5kZXhPZigne3snLCBsYXN0SW5kZXgpKSA+IC0xKSB7CiAgICBpZiAobGFzdEluZGV4IDwgaW5kZXgpCiAgICAgIHJlc3VsdHMucHVzaChzdHJpbmcuc3Vic3RyKGxhc3RJbmRleCwgaW5kZXggLSBsYXN0SW5kZXgpKTsKICAgIGxhc3RJbmRleCA9IGluZGV4OwoKICAgIGluZGV4ID0gc3RyaW5nLmluZGV4T2YoJ319JywgaW5kZXgpOwogICAgaW5kZXggPSBpbmRleCA8IDAgPyBzdHJpbmcubGVuZ3RoIDogaW5kZXggKyAyOwoKICAgIHJlc3VsdHMucHVzaChzdHJpbmcuc3Vic3RyKGxhc3RJbmRleCwgaW5kZXggLSBsYXN0SW5kZXgpKTsKICAgIGxhc3RJbmRleCA9IGluZGV4OwogIH0KICBpZiAobGFzdEluZGV4ICE9IHN0cmluZy5sZW5ndGgpCiAgICByZXN1bHRzLnB1c2goc3RyaW5nLnN1YnN0cihsYXN0SW5kZXgsIHN0cmluZy5sZW5ndGggLSBsYXN0SW5kZXgpKTsKICByZXR1cm4gcmVzdWx0cy5sZW5ndGggPT09IDAgPyBbIHN0cmluZyBdIDogcmVzdWx0czsKfQoKZnVuY3Rpb24gYmluZGluZyhzdHJpbmcpIHsKICB2YXIgYmluZGluZyA9IHN0cmluZy5yZXBsYWNlKC9cbi9nbSwgJyAnKS5tYXRjaCgvXlx7XHsoLiopXH1cfSQvKTsKICByZXR1cm4gYmluZGluZyA/IGJpbmRpbmdbMV0gOiBudWxsOwp9CgpmdW5jdGlvbiBoYXNCaW5kaW5ncyhiaW5kaW5ncykgewogIHJldHVybiBiaW5kaW5ncy5sZW5ndGggPiAxIHx8IGJpbmRpbmcoYmluZGluZ3NbMF0pICE9PSBudWxsOwp9Cgphbmd1bGFyVGV4dE1hcmt1cCgne3t9fScsIGZ1bmN0aW9uKHRleHQsIHRleHROb2RlLCBwYXJlbnRFbGVtZW50KSB7CiAgdmFyIGJpbmRpbmdzID0gcGFyc2VCaW5kaW5ncyh0ZXh0KSwKICAgICAgc2VsZiA9IHRoaXM7CiAgaWYgKGhhc0JpbmRpbmdzKGJpbmRpbmdzKSkgewogICAgaWYgKGlzTGVhZk5vZGUocGFyZW50RWxlbWVudFswXSkpIHsKICAgICAgcGFyZW50RWxlbWVudC5hdHRyKCduZzpiaW5kLXRlbXBsYXRlJywgdGV4dCk7CiAgICB9IGVsc2UgewogICAgICB2YXIgY3Vyc29yID0gdGV4dE5vZGUsIG5ld0VsZW1lbnQ7CiAgICAgIGZvckVhY2gocGFyc2VCaW5kaW5ncyh0ZXh0KSwgZnVuY3Rpb24odGV4dCl7CiAgICAgICAgdmFyIGV4cCA9IGJpbmRpbmcodGV4dCk7CiAgICAgICAgaWYgKGV4cCkgewogICAgICAgICAgbmV3RWxlbWVudCA9IGpxTGl0ZSgnPHNwYW4+Jyk7CiAgICAgICAgICBuZXdFbGVtZW50LmF0dHIoJ25nOmJpbmQnLCBleHApOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBuZXdFbGVtZW50ID0ganFMaXRlKGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKHRleHQpKTsKICAgICAgICB9CiAgICAgICAgaWYgKG1zaWUgJiYgdGV4dC5jaGFyQXQoMCkgPT0gJyAnKSB7CiAgICAgICAgICBuZXdFbGVtZW50ID0ganFMaXRlKCc8c3Bhbj4mbmJzcDs8L3NwYW4+Jyk7CiAgICAgICAgICB2YXIgbmJzcCA9IG5ld0VsZW1lbnQuaHRtbCgpOwogICAgICAgICAgbmV3RWxlbWVudC50ZXh0KHRleHQuc3Vic3RyKDEpKTsKICAgICAgICAgIG5ld0VsZW1lbnQuaHRtbChuYnNwICsgbmV3RWxlbWVudC5odG1sKCkpOwogICAgICAgIH0KICAgICAgICBjdXJzb3IuYWZ0ZXIobmV3RWxlbWVudCk7CiAgICAgICAgY3Vyc29yID0gbmV3RWxlbWVudDsKICAgICAgfSk7CiAgICAgIHRleHROb2RlLnJlbW92ZSgpOwogICAgfQogIH0KfSk7CgovKioKICogVGhpcyB0cmllcyB0byBub3JtYWxpemUgdGhlIGJlaGF2aW9yIG9mIHZhbHVlIGF0dHJpYnV0ZSBhY3Jvc3MgYnJvd3NlcnMuIElmIHZhbHVlIGF0dHJpYnV0ZSBpcwogKiBub3Qgc3BlY2lmaWVkLCB0aGVuIHNwZWNpZnkgaXQgdG8gYmUgdGhhdCBvZiB0aGUgdGV4dC4KICovCmFuZ3VsYXJUZXh0TWFya3VwKCdvcHRpb24nLCBmdW5jdGlvbih0ZXh0LCB0ZXh0Tm9kZSwgcGFyZW50RWxlbWVudCl7CiAgaWYgKGxvd2VyY2FzZShub2RlTmFtZV8ocGFyZW50RWxlbWVudCkpID09ICdvcHRpb24nKSB7CiAgICBpZiAobXNpZSA8PSA3KSB7CiAgICAgIC8vIEluIElFNyBUaGUgaXNzdWUgaXMgdGhhdCB0aGVyZSBpcyBubyB3YXkgdG8gc2VlIGlmIHRoZSB2YWx1ZSB3YXMgc3BlY2lmaWVkIGhlbmNlCiAgICAgIC8vIHdlIGhhdmUgdG8gcmVzb3J0IHRvIHBhcnNpbmcgSFRNTDsKICAgICAgaHRtbFBhcnNlcihwYXJlbnRFbGVtZW50WzBdLm91dGVySFRNTCwgewogICAgICAgIHN0YXJ0OiBmdW5jdGlvbih0YWcsIGF0dHJzKSB7CiAgICAgICAgICBpZiAoaXNVbmRlZmluZWQoYXR0cnMudmFsdWUpKSB7CiAgICAgICAgICAgIHBhcmVudEVsZW1lbnQuYXR0cigndmFsdWUnLCB0ZXh0KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgfSBlbHNlIGlmIChwYXJlbnRFbGVtZW50WzBdLmdldEF0dHJpYnV0ZSgndmFsdWUnKSA9PSBudWxsKSB7CiAgICAgIC8vIGpRdWVyeSBkb2VzIG5vcm1hbGl6YXRpb24gb24gJ3ZhbHVlJyBzbyB3ZSBoYXZlIHRvIGJ5cGFzcyBpdC4KICAgICAgcGFyZW50RWxlbWVudC5hdHRyKCd2YWx1ZScsIHRleHQpOwogICAgfQogIH0KfSk7CgovKioKICogQHdvcmtJblByb2dyZXNzCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgYW5ndWxhci5kaXJlY3RpdmUubmc6aHJlZgogKgogKiBAZGVzY3JpcHRpb24KICogVXNpbmcgPGFuZ3VsYXIvPiBtYXJrdXAgbGlrZSB7e2hhc2h9fSBpbiBhbiBocmVmIGF0dHJpYnV0ZSBtYWtlcwogKiB0aGUgcGFnZSBvcGVuIHRvIGEgd3JvbmcgVVJMLCBpZiB0aGUgdXNlciBjbGlja3MgdGhhdCBsaW5rIGJlZm9yZQogKiBhbmd1bGFyIGhhcyBhIGNoYW5jZSB0byByZXBsYWNlIHRoZSB7e2hhc2h9fSB3aXRoIGFjdHVhbCBVUkwsIHRoZQogKiBsaW5rIHdpbGwgYmUgYnJva2VuIGFuZCB3aWxsIG1vc3QgbGlrZWx5IHJldHVybiBhIDQwNCBlcnJvci4KICogVGhlIGBuZzpocmVmYCBzb2x2ZXMgdGhpcyBwcm9ibGVtIGJ5IHBsYWNpbmcgdGhlIGBocmVmYCBpbiB0aGUKICogYG5nOmAgbmFtZXNwYWNlLgogKgogKiBUaGUgYnVnZ3kgd2F5IHRvIHdyaXRlIGl0OgogKiA8cHJlPgogKiA8YSBocmVmPSJodHRwOi8vd3d3LmdyYXZhdGFyLmNvbS9hdmF0YXIve3toYXNofX0iLz4KICogPC9wcmU+CiAqCiAqIFRoZSBjb3JyZWN0IHdheSB0byB3cml0ZSBpdDoKICogPHByZT4KICogPGEgbmc6aHJlZj0iaHR0cDovL3d3dy5ncmF2YXRhci5jb20vYXZhdGFyL3t7aGFzaH19Ii8+CiAqIDwvcHJlPgogKgogKiBAZWxlbWVudCBBTlkKICogQHBhcmFtIHt0ZW1wbGF0ZX0gdGVtcGxhdGUgYW55IHN0cmluZyB3aGljaCBjYW4gY29udGFpbiBge3t9fWAgbWFya3VwLgogKgogKiBAZXhhbXBsZQogKiBUaGlzIGV4YW1wbGUgdXNlcyBgbGlua2AgdmFyaWFibGUgaW5zaWRlIGBocmVmYCBhdHRyaWJ1dGU6CiAgICA8ZG9jOmV4YW1wbGU+CiAgICAgIDxkb2M6c291cmNlPgogICAgICAgIDxpbnB1dCBuYW1lPSJ2YWx1ZSIgLz48YnIgLz4KICAgICAgICA8YSBpZD0ibGluay0xIiBocmVmIG5nOmNsaWNrPSJ2YWx1ZSA9IDEiPmxpbmsgMTwvYT4gKGxpbmssIGRvbid0IHJlbG9hZCk8YnIgLz4KICAgICAgICA8YSBpZD0ibGluay0yIiBocmVmPSIiIG5nOmNsaWNrPSJ2YWx1ZSA9IDIiPmxpbmsgMjwvYT4gKGxpbmssIGRvbid0IHJlbG9hZCk8YnIgLz4KICAgICAgICA8YSBpZD0ibGluay0zIiBuZzpocmVmPSIje3snMTIzJ319IiBuZzpjbGljaz0idmFsdWUgPSAzIj5saW5rIDM8L2E+IChsaW5rLCByZWxvYWQhKTxiciAvPgogICAgICAgIDxhIGlkPSJsaW5rLTQiIGhyZWY9IiIgbmFtZT0ieHgiIG5nOmNsaWNrPSJ2YWx1ZSA9IDQiPmFuY2hvcjwvYT4gKGxpbmssIGRvbid0IHJlbG9hZCk8YnIgLz4KICAgICAgICA8YSBpZD0ibGluay01IiBuYW1lPSJ4eHgiIG5nOmNsaWNrPSJ2YWx1ZSA9IDUiPmFuY2hvcjwvYT4gKG5vIGxpbmspPGJyIC8+CiAgICAgICAgPGEgaWQ9ImxpbmstNiIgbmc6aHJlZj0iIy97e3ZhbHVlfX0iPmxpbms8L2E+IChsaW5rLCBjaGFuZ2UgaGFzaCkKICAgICAgPC9kb2M6c291cmNlPgogICAgICA8ZG9jOnNjZW5hcmlvPgogICAgICAgIGl0KCdzaG91bGQgZXhlY3V0ZSBuZzpjbGljayBidXQgbm90IHJlbG9hZCB3aGVuIGhyZWYgd2l0aG91dCB2YWx1ZScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgZWxlbWVudCgnI2xpbmstMScpLmNsaWNrKCk7CiAgICAgICAgICBleHBlY3QoaW5wdXQoJ3ZhbHVlJykudmFsKCkpLnRvRXF1YWwoJzEnKTsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcjbGluay0xJykuYXR0cignaHJlZicpKS50b0JlKCIiKTsKICAgICAgICB9KTsKCiAgICAgICAgaXQoJ3Nob3VsZCBleGVjdXRlIG5nOmNsaWNrIGJ1dCBub3QgcmVsb2FkIHdoZW4gaHJlZiBlbXB0eSBzdHJpbmcnLCBmdW5jdGlvbigpIHsKICAgICAgICAgIGVsZW1lbnQoJyNsaW5rLTInKS5jbGljaygpOwogICAgICAgICAgZXhwZWN0KGlucHV0KCd2YWx1ZScpLnZhbCgpKS50b0VxdWFsKCcyJyk7CiAgICAgICAgICBleHBlY3QoZWxlbWVudCgnI2xpbmstMicpLmF0dHIoJ2hyZWYnKSkudG9CZSgiIik7CiAgICAgICAgfSk7CgogICAgICAgIGl0KCdzaG91bGQgZXhlY3V0ZSBuZzpjbGljayBhbmQgY2hhbmdlIHVybCB3aGVuIG5nOmhyZWYgc3BlY2lmaWVkJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBlbGVtZW50KCcjbGluay0zJykuY2xpY2soKTsKICAgICAgICAgIGV4cGVjdChpbnB1dCgndmFsdWUnKS52YWwoKSkudG9FcXVhbCgnMycpOwogICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJyNsaW5rLTMnKS5hdHRyKCdocmVmJykpLnRvQmUoIiMxMjMiKTsKICAgICAgICAgIGV4cGVjdChicm93c2VyKCkubG9jYXRpb24oKS5oYXNoKCkpLnRvRXF1YWwoJzEyMycpOwogICAgICAgIH0pOwoKICAgICAgICBpdCgnc2hvdWxkIGV4ZWN1dGUgbmc6Y2xpY2sgYnV0IG5vdCByZWxvYWQgd2hlbiBocmVmIGVtcHR5IHN0cmluZyBhbmQgbmFtZSBzcGVjaWZpZWQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgIGVsZW1lbnQoJyNsaW5rLTQnKS5jbGljaygpOwogICAgICAgICAgZXhwZWN0KGlucHV0KCd2YWx1ZScpLnZhbCgpKS50b0VxdWFsKCc0Jyk7CiAgICAgICAgICBleHBlY3QoZWxlbWVudCgnI2xpbmstNCcpLmF0dHIoJ2hyZWYnKSkudG9CZSgiIik7CiAgICAgICAgfSk7CgogICAgICAgIGl0KCdzaG91bGQgZXhlY3V0ZSBuZzpjbGljayBidXQgbm90IHJlbG9hZCB3aGVuIG5vIGhyZWYgYnV0IG5hbWUgc3BlY2lmaWVkJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBlbGVtZW50KCcjbGluay01JykuY2xpY2soKTsKICAgICAgICAgIGV4cGVjdChpbnB1dCgndmFsdWUnKS52YWwoKSkudG9FcXVhbCgnNScpOwogICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJyNsaW5rLTUnKS5hdHRyKCdocmVmJykpLnRvQmUodW5kZWZpbmVkKTsKICAgICAgICB9KTsKCiAgICAgICAgaXQoJ3Nob3VsZCBvbmx5IGNoYW5nZSB1cmwgd2hlbiBvbmx5IG5nOmhyZWYnLCBmdW5jdGlvbigpIHsKICAgICAgICAgIGlucHV0KCd2YWx1ZScpLmVudGVyKCc2Jyk7CiAgICAgICAgICBlbGVtZW50KCcjbGluay02JykuY2xpY2soKTsKICAgICAgICAgIGV4cGVjdChicm93c2VyKCkubG9jYXRpb24oKS5oYXNoKCkpLnRvRXF1YWwoJy82Jyk7CiAgICAgICAgICBleHBlY3QoZWxlbWVudCgnI2xpbmstNicpLmF0dHIoJ2hyZWYnKSkudG9CZSgiIy82Iik7CiAgICAgICAgfSk7CiAgICAgIDwvZG9jOnNjZW5hcmlvPgogICAgPC9kb2M6ZXhhbXBsZT4KICovCgovKioKICogQHdvcmtJblByb2dyZXNzCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgYW5ndWxhci5kaXJlY3RpdmUubmc6c3JjCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBVc2luZyA8YW5ndWxhci8+IG1hcmt1cCBsaWtlIGB7e2hhc2h9fWAgaW4gYSBgc3JjYCBhdHRyaWJ1dGUgZG9lc24ndAogKiB3b3JrIHJpZ2h0OiBUaGUgYnJvd3NlciB3aWxsIGZldGNoIGZyb20gdGhlIFVSTCB3aXRoIHRoZSBsaXRlcmFsCiAqIHRleHQgYHt7aGFzaH19YCB1bnRpbCA8YW5ndWxhci8+IHJlcGxhY2VzIHRoZSBleHByZXNzaW9uIGluc2lkZQogKiBge3toYXNofX1gLiBUaGUgYG5nOnNyY2AgYXR0cmlidXRlIHNvbHZlcyB0aGlzIHByb2JsZW0gYnkgcGxhY2luZwogKiAgdGhlIGBzcmNgIGF0dHJpYnV0ZSBpbiB0aGUgYG5nOmAgbmFtZXNwYWNlLgogKgogKiBUaGUgYnVnZ3kgd2F5IHRvIHdyaXRlIGl0OgogKiA8cHJlPgogKiA8aW1nIHNyYz0iaHR0cDovL3d3dy5ncmF2YXRhci5jb20vYXZhdGFyL3t7aGFzaH19Ii8+CiAqIDwvcHJlPgogKgogKiBUaGUgY29ycmVjdCB3YXkgdG8gd3JpdGUgaXQ6CiAqIDxwcmU+CiAqIDxpbWcgbmc6c3JjPSJodHRwOi8vd3d3LmdyYXZhdGFyLmNvbS9hdmF0YXIve3toYXNofX0iLz4KICogPC9wcmU+CiAqCiAqIEBlbGVtZW50IEFOWQogKiBAcGFyYW0ge3RlbXBsYXRlfSB0ZW1wbGF0ZSBhbnkgc3RyaW5nIHdoaWNoIGNhbiBjb250YWluIGB7e319YCBtYXJrdXAuCiAqLwoKLyoqCiAqIEB3b3JrSW5Qcm9ncmVzcwogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIGFuZ3VsYXIuZGlyZWN0aXZlLm5nOmRpc2FibGVkCiAqCiAqIEBkZXNjcmlwdGlvbgogKgogKiBUaGUgZm9sbG93aW5nIG1hcmt1cCB3aWxsIG1ha2UgdGhlIGJ1dHRvbiBlbmFibGVkIG9uIENocm9tZS9GaXJlZm94IGJ1dCBub3Qgb24gSUU4IGFuZCBvbGRlciBJRXM6CiAqIDxwcmU+CiAqIDxkaXYgbmc6aW5pdD0ic2NvcGUgPSB7IGlzRGlzYWJsZWQ6IGZhbHNlIH0iPgogKiAgPGJ1dHRvbiBkaXNhYmxlZD0ie3tzY29wZS5pc0Rpc2FibGVkfX0iPkRpc2FibGVkPC9idXR0b24+CiAqIDwvZGl2PgogKiA8L3ByZT4KICoKICogVGhlIEhUTUwgc3BlY3MgZG8gbm90IHJlcXVpcmUgYnJvd3NlcnMgdG8gcHJlc2VydmUgdGhlIHNwZWNpYWwgYXR0cmlidXRlcyBzdWNoIGFzIGRpc2FibGVkLgogKiAoVGhlIHByZXNlbmNlIG9mIHRoZW0gbWVhbnMgdHJ1ZSBhbmQgYWJzZW5jZSBtZWFucyBmYWxzZSkKICogVGhpcyBwcmV2ZW50cyB0aGUgYW5ndWxhciBjb21waWxlciBmcm9tIGNvcnJlY3RseSByZXRyaWV2aW5nIHRoZSBiaW5kaW5nIGV4cHJlc3Npb24uCiAqIFRvIHNvbHZlIHRoaXMgcHJvYmxlbSwgd2UgaW50cm9kdWNlIG5nOmRpc2FibGVkLgogKgogKiBAZXhhbXBsZQogICAgPGRvYzpleGFtcGxlPgogICAgICA8ZG9jOnNvdXJjZT4KICAgICAgICBDbGljayBtZSB0byB0b2dnbGU6IDxpbnB1dCB0eXBlPSJjaGVja2JveCIgbmFtZT0iY2hlY2tlZCI+PGJyLz4KICAgICAgICA8YnV0dG9uIG5hbWU9ImJ1dHRvbiIgbmc6ZGlzYWJsZWQ9Int7Y2hlY2tlZH19Ij5CdXR0b248L2J1dHRvbj4KICAgICAgPC9kb2M6c291cmNlPgogICAgICA8ZG9jOnNjZW5hcmlvPgogICAgICAgIGl0KCdzaG91bGQgdG9nZ2xlIGJ1dHRvbicsIGZ1bmN0aW9uKCkgewogICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIDpidXR0b24nKS5hdHRyKCdkaXNhYmxlZCcpKS50b0JlRmFsc3koKTsKICAgICAgICAgIGlucHV0KCdjaGVja2VkJykuY2hlY2soKTsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSA6YnV0dG9uJykuYXR0cignZGlzYWJsZWQnKSkudG9CZVRydXRoeSgpOwogICAgICAgIH0pOwogICAgICA8L2RvYzpzY2VuYXJpbz4KICAgIDwvZG9jOmV4YW1wbGU+CiAqCiAqIEBlbGVtZW50IEFOWQogKiBAcGFyYW0ge3RlbXBsYXRlfSB0ZW1wbGF0ZSBhbnkgc3RyaW5nIHdoaWNoIGNhbiBjb250YWluICd7e319JyBtYXJrdXAuCiAqLwoKCi8qKgogKiBAd29ya0luUHJvZ3Jlc3MKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBhbmd1bGFyLmRpcmVjdGl2ZS5uZzpjaGVja2VkCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBUaGUgSFRNTCBzcGVjcyBkbyBub3QgcmVxdWlyZSBicm93c2VycyB0byBwcmVzZXJ2ZSB0aGUgc3BlY2lhbCBhdHRyaWJ1dGVzIHN1Y2ggYXMgY2hlY2tlZC4KICogKFRoZSBwcmVzZW5jZSBvZiB0aGVtIG1lYW5zIHRydWUgYW5kIGFic2VuY2UgbWVhbnMgZmFsc2UpCiAqIFRoaXMgcHJldmVudHMgdGhlIGFuZ3VsYXIgY29tcGlsZXIgZnJvbSBjb3JyZWN0bHkgcmV0cmlldmluZyB0aGUgYmluZGluZyBleHByZXNzaW9uLgogKiBUbyBzb2x2ZSB0aGlzIHByb2JsZW0sIHdlIGludHJvZHVjZSBuZzpjaGVja2VkLgogKiBAZXhhbXBsZQogICAgPGRvYzpleGFtcGxlPgogICAgICA8ZG9jOnNvdXJjZT4KICAgICAgICBDaGVjayBtZSB0byBjaGVjayBib3RoOiA8aW5wdXQgdHlwZT0iY2hlY2tib3giIG5hbWU9Im1hc3RlciI+PGJyLz4KICAgICAgICA8aW5wdXQgaWQ9ImNoZWNrU2xhdmUiIHR5cGU9ImNoZWNrYm94IiBuZzpjaGVja2VkPSJ7e21hc3Rlcn19Ij4KICAgICAgPC9kb2M6c291cmNlPgogICAgICA8ZG9jOnNjZW5hcmlvPgogICAgICAgIGl0KCdzaG91bGQgY2hlY2sgYm90aCBjaGVja0JveGVzJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgI2NoZWNrU2xhdmUnKS5hdHRyKCdjaGVja2VkJykpLnRvQmVGYWxzeSgpOwogICAgICAgICAgaW5wdXQoJ21hc3RlcicpLmNoZWNrKCk7CiAgICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgI2NoZWNrU2xhdmUnKS5hdHRyKCdjaGVja2VkJykpLnRvQmVUcnV0aHkoKTsKICAgICAgICB9KTsKICAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICA8L2RvYzpleGFtcGxlPgogKgogKiBAZWxlbWVudCBBTlkKICogQHBhcmFtIHt0ZW1wbGF0ZX0gdGVtcGxhdGUgYW55IHN0cmluZyB3aGljaCBjYW4gY29udGFpbiAne3t9fScgbWFya3VwLgogKi8KCgovKioKICogQHdvcmtJblByb2dyZXNzCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgYW5ndWxhci5kaXJlY3RpdmUubmc6bXVsdGlwbGUKICoKICogQGRlc2NyaXB0aW9uCiAqIFRoZSBIVE1MIHNwZWNzIGRvIG5vdCByZXF1aXJlIGJyb3dzZXJzIHRvIHByZXNlcnZlIHRoZSBzcGVjaWFsIGF0dHJpYnV0ZXMgc3VjaCBhcyBtdWx0aXBsZS4KICogKFRoZSBwcmVzZW5jZSBvZiB0aGVtIG1lYW5zIHRydWUgYW5kIGFic2VuY2UgbWVhbnMgZmFsc2UpCiAqIFRoaXMgcHJldmVudHMgdGhlIGFuZ3VsYXIgY29tcGlsZXIgZnJvbSBjb3JyZWN0bHkgcmV0cmlldmluZyB0aGUgYmluZGluZyBleHByZXNzaW9uLgogKiBUbyBzb2x2ZSB0aGlzIHByb2JsZW0sIHdlIGludHJvZHVjZSBuZzptdWx0aXBsZS4KICoKICogQGV4YW1wbGUKICAgICA8ZG9jOmV4YW1wbGU+CiAgICAgICA8ZG9jOnNvdXJjZT4KICAgICAgICAgQ2hlY2sgbWUgY2hlY2sgbXVsdGlwbGU6IDxpbnB1dCB0eXBlPSJjaGVja2JveCIgbmFtZT0iY2hlY2tlZCI+PGJyLz4KICAgICAgICAgPHNlbGVjdCBpZD0ic2VsZWN0IiBuZzptdWx0aXBsZT0ie3tjaGVja2VkfX0iPgogICAgICAgICAgIDxvcHRpb24+TWlza288L29wdGlvbj4KICAgICAgICAgICA8b3B0aW9uPklnb3I8L29wdGlvbj4KICAgICAgICAgICA8b3B0aW9uPlZvanRhPC9vcHRpb24+CiAgICAgICAgICAgPG9wdGlvbj5EaTwvb3B0aW9uPgogICAgICAgICA8L3NlbGVjdD4KICAgICAgIDwvZG9jOnNvdXJjZT4KICAgICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgICAgIGl0KCdzaG91bGQgdG9nZ2xlIG11bHRpcGxlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlICNzZWxlY3QnKS5hdHRyKCdtdWx0aXBsZScpKS50b0JlRmFsc3koKTsKICAgICAgICAgICBpbnB1dCgnY2hlY2tlZCcpLmNoZWNrKCk7CiAgICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlICNzZWxlY3QnKS5hdHRyKCdtdWx0aXBsZScpKS50b0JlVHJ1dGh5KCk7CiAgICAgICAgIH0pOwogICAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgPC9kb2M6ZXhhbXBsZT4KICoKICogQGVsZW1lbnQgQU5ZCiAqIEBwYXJhbSB7dGVtcGxhdGV9IHRlbXBsYXRlIGFueSBzdHJpbmcgd2hpY2ggY2FuIGNvbnRhaW4gJ3t7fX0nIG1hcmt1cC4KICovCgoKLyoqCiAqIEB3b3JrSW5Qcm9ncmVzcwogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIGFuZ3VsYXIuZGlyZWN0aXZlLm5nOnJlYWRvbmx5CiAqCiAqIEBkZXNjcmlwdGlvbgogKiBUaGUgSFRNTCBzcGVjcyBkbyBub3QgcmVxdWlyZSBicm93c2VycyB0byBwcmVzZXJ2ZSB0aGUgc3BlY2lhbCBhdHRyaWJ1dGVzIHN1Y2ggYXMgcmVhZG9ubHkuCiAqIChUaGUgcHJlc2VuY2Ugb2YgdGhlbSBtZWFucyB0cnVlIGFuZCBhYnNlbmNlIG1lYW5zIGZhbHNlKQogKiBUaGlzIHByZXZlbnRzIHRoZSBhbmd1bGFyIGNvbXBpbGVyIGZyb20gY29ycmVjdGx5IHJldHJpZXZpbmcgdGhlIGJpbmRpbmcgZXhwcmVzc2lvbi4KICogVG8gc29sdmUgdGhpcyBwcm9ibGVtLCB3ZSBpbnRyb2R1Y2Ugbmc6cmVhZG9ubHkuCiAqIEBleGFtcGxlCiAgICA8ZG9jOmV4YW1wbGU+CiAgICAgIDxkb2M6c291cmNlPgogICAgICAgIENoZWNrIG1lIHRvIG1ha2UgdGV4dCByZWFkb25seTogPGlucHV0IHR5cGU9ImNoZWNrYm94IiBuYW1lPSJjaGVja2VkIj48YnIvPgogICAgICAgIDxpbnB1dCB0eXBlPSJ0ZXh0IiBuZzpyZWFkb25seT0ie3tjaGVja2VkfX0iIHZhbHVlPSJJJ20gQW5ndWxhciIvPgogICAgICA8L2RvYzpzb3VyY2U+CiAgICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgICAgaXQoJ3Nob3VsZCB0b2dnbGUgcmVhZG9ubHkgYXR0cicsIGZ1bmN0aW9uKCkgewogICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIDp0ZXh0JykuYXR0cigncmVhZG9ubHknKSkudG9CZUZhbHN5KCk7CiAgICAgICAgICBpbnB1dCgnY2hlY2tlZCcpLmNoZWNrKCk7CiAgICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgOnRleHQnKS5hdHRyKCdyZWFkb25seScpKS50b0JlVHJ1dGh5KCk7CiAgICAgICAgfSk7CiAgICAgIDwvZG9jOnNjZW5hcmlvPgogICAgPC9kb2M6ZXhhbXBsZT4KICoKICogQGVsZW1lbnQgQU5ZCiAqIEBwYXJhbSB7dGVtcGxhdGV9IHRlbXBsYXRlIGFueSBzdHJpbmcgd2hpY2ggY2FuIGNvbnRhaW4gJ3t7fX0nIG1hcmt1cC4KICovCgoKLyoqCiogQHdvcmtJblByb2dyZXNzCiogQG5nZG9jIGRpcmVjdGl2ZQoqIEBuYW1lIGFuZ3VsYXIuZGlyZWN0aXZlLm5nOnNlbGVjdGVkCioKKiBAZGVzY3JpcHRpb24KKiBUaGUgSFRNTCBzcGVjcyBkbyBub3QgcmVxdWlyZSBicm93c2VycyB0byBwcmVzZXJ2ZSB0aGUgc3BlY2lhbCBhdHRyaWJ1dGVzIHN1Y2ggYXMgc2VsZWN0ZWQuCiogKFRoZSBwcmVzZW5jZSBvZiB0aGVtIG1lYW5zIHRydWUgYW5kIGFic2VuY2UgbWVhbnMgZmFsc2UpCiogVGhpcyBwcmV2ZW50cyB0aGUgYW5ndWxhciBjb21waWxlciBmcm9tIGNvcnJlY3RseSByZXRyaWV2aW5nIHRoZSBiaW5kaW5nIGV4cHJlc3Npb24uCiogVG8gc29sdmUgdGhpcyBwcm9ibGVtLCB3ZSBpbnRyb2R1Y2Ugbmc6c2VsZWN0ZWQuCiogQGV4YW1wbGUKICAgPGRvYzpleGFtcGxlPgogICAgIDxkb2M6c291cmNlPgogICAgICAgQ2hlY2sgbWUgdG8gc2VsZWN0OiA8aW5wdXQgdHlwZT0iY2hlY2tib3giIG5hbWU9ImNoZWNrZWQiPjxici8+CiAgICAgICA8c2VsZWN0PgogICAgICAgICA8b3B0aW9uPkhlbGxvITwvb3B0aW9uPgogICAgICAgICA8b3B0aW9uIGlkPSJncmVldCIgbmc6c2VsZWN0ZWQ9Int7Y2hlY2tlZH19Ij5HcmVldGluZ3MhPC9vcHRpb24+CiAgICAgICA8L3NlbGVjdD4KICAgICA8L2RvYzpzb3VyY2U+CiAgICAgPGRvYzpzY2VuYXJpbz4KICAgICAgIGl0KCdzaG91bGQgc2VsZWN0IEdyZWV0aW5ncyEnLCBmdW5jdGlvbigpIHsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlICNncmVldCcpLmF0dHIoJ3NlbGVjdGVkJykpLnRvQmVGYWxzeSgpOwogICAgICAgICBpbnB1dCgnY2hlY2tlZCcpLmNoZWNrKCk7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSAjZ3JlZXQnKS5hdHRyKCdzZWxlY3RlZCcpKS50b0JlVHJ1dGh5KCk7CiAgICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgPC9kb2M6ZXhhbXBsZT4KKiBAZWxlbWVudCBBTlkKKiBAcGFyYW0ge3RlbXBsYXRlfSB0ZW1wbGF0ZSBhbnkgc3RyaW5nIHdoaWNoIGNhbiBjb250YWluICd7e319JyBtYXJrdXAuCiovCgoKdmFyIE5HX0JJTkRfQVRUUiA9ICduZzpiaW5kLWF0dHInOwp2YXIgU1BFQ0lBTF9BVFRSUyA9IHt9OwoKZm9yRWFjaCgnc3JjLGhyZWYsY2hlY2tlZCxkaXNhYmxlZCxtdWx0aXBsZSxyZWFkb25seSxzZWxlY3RlZCcuc3BsaXQoJywnKSwgZnVuY3Rpb24obmFtZSkgewogIFNQRUNJQUxfQVRUUlNbJ25nOicgKyBuYW1lXSA9IG5hbWU7Cn0pOwoKYW5ndWxhckF0dHJNYXJrdXAoJ3t7fX0nLCBmdW5jdGlvbih2YWx1ZSwgbmFtZSwgZWxlbWVudCl7CiAgLy8gZG9uJ3QgcHJvY2VzcyBleGlzdGluZyBhdHRyaWJ1dGUgbWFya3VwCiAgaWYgKGFuZ3VsYXJEaXJlY3RpdmUobmFtZSkgfHwgYW5ndWxhckRpcmVjdGl2ZSgiQCIgKyBuYW1lKSkgcmV0dXJuOwogIGlmIChtc2llICYmIG5hbWUgPT0gJ3NyYycpCiAgICB2YWx1ZSA9IGRlY29kZVVSSSh2YWx1ZSk7CiAgdmFyIGJpbmRpbmdzID0gcGFyc2VCaW5kaW5ncyh2YWx1ZSksCiAgICAgIGJpbmRBdHRyOwogIGlmIChoYXNCaW5kaW5ncyhiaW5kaW5ncykpIHsKICAgIGVsZW1lbnQucmVtb3ZlQXR0cihuYW1lKTsKICAgIGJpbmRBdHRyID0gZnJvbUpzb24oZWxlbWVudC5hdHRyKE5HX0JJTkRfQVRUUikgfHwgInt9Iik7CiAgICBiaW5kQXR0cltTUEVDSUFMX0FUVFJTW25hbWVdIHx8IG5hbWVdID0gdmFsdWU7CiAgICBlbGVtZW50LmF0dHIoTkdfQklORF9BVFRSLCB0b0pzb24oYmluZEF0dHIpKTsKICB9Cn0pOwondXNlIHN0cmljdCc7CgovKioKICogQHdvcmtJblByb2dyZXNzCiAqIEBuZ2RvYyBvdmVydmlldwogKiBAbmFtZSBhbmd1bGFyLndpZGdldAogKiBAZGVzY3JpcHRpb24KICoKICogQW4gYW5ndWxhciB3aWRnZXQgY2FuIGJlIGVpdGhlciBhIGN1c3RvbSBhdHRyaWJ1dGUgdGhhdCBtb2RpZmllcyBhbiBleGlzdGluZyBET00gZWxlbWVudCBvciBhbgogKiBlbnRpcmVseSBuZXcgRE9NIGVsZW1lbnQuCiAqCiAqIER1cmluZyBodG1sIGNvbXBpbGF0aW9uLCB3aWRnZXRzIGFyZSBwcm9jZXNzZWQgYWZ0ZXIge0BsaW5rIGFuZ3VsYXIubWFya3VwIG1hcmt1cH0sIGJ1dCBiZWZvcmUKICoge0BsaW5rIGFuZ3VsYXIuZGlyZWN0aXZlIGRpcmVjdGl2ZXN9LgogKgogKiBGb2xsb3dpbmcgaXMgdGhlIGxpc3Qgb2YgYnVpbHQtaW4gYW5ndWxhciB3aWRnZXRzOgogKgogKiAqIHtAbGluayBhbmd1bGFyLndpZGdldC5Abmc6Zm9ybWF0IG5nOmZvcm1hdH0gLSBGb3JtYXRzIGRhdGEgZm9yIGRpc3BsYXkgdG8gdXNlciBhbmQgZm9yIHN0b3JhZ2UuCiAqICoge0BsaW5rIGFuZ3VsYXIud2lkZ2V0LkBuZzpub24tYmluZGFibGUgbmc6bm9uLWJpbmRhYmxlfSAtIEJsb2NrcyBhbmd1bGFyIGZyb20gcHJvY2Vzc2luZyBhbgogKiAgIEhUTUwgZWxlbWVudC4KICogKiB7QGxpbmsgYW5ndWxhci53aWRnZXQuQG5nOnJlcGVhdCBuZzpyZXBlYXR9IC0gQ3JlYXRlcyBhbmQgbWFuYWdlcyBhIGNvbGxlY3Rpb24gb2YgY2xvbmVkIEhUTUwKICogICBlbGVtZW50cy4KICogKiB7QGxpbmsgYW5ndWxhci53aWRnZXQuQG5nOnJlcXVpcmVkIG5nOnJlcXVpcmVkfSAtIFZlcmlmaWVzIHByZXNlbmNlIG9mIHVzZXIgaW5wdXQuCiAqICoge0BsaW5rIGFuZ3VsYXIud2lkZ2V0LkBuZzp2YWxpZGF0ZSBuZzp2YWxpZGF0ZX0gLSBWYWxpZGF0ZXMgY29udGVudCBvZiB1c2VyIGlucHV0LgogKiAqIHtAbGluayBhbmd1bGFyLndpZGdldC5IVE1MIEhUTUwgaW5wdXQgZWxlbWVudHN9IC0gU3RhbmRhcmQgSFRNTCBpbnB1dCBlbGVtZW50cyBkYXRhLWJvdW5kIGJ5CiAqICAgYW5ndWxhci4KICogKiB7QGxpbmsgYW5ndWxhci53aWRnZXQubmc6dmlldyBuZzp2aWV3fSAtIFdvcmtzIHdpdGggJHJvdXRlIHRvICJpbmNsdWRlIiBwYXJ0aWFsIHRlbXBsYXRlcwogKiAqIHtAbGluayBhbmd1bGFyLndpZGdldC5uZzpzd2l0Y2ggbmc6c3dpdGNofSAtIENvbmRpdGlvbmFsbHkgY2hhbmdlcyBET00gc3RydWN0dXJlCiAqICoge0BsaW5rIGFuZ3VsYXIud2lkZ2V0Lm5nOmluY2x1ZGUgbmc6aW5jbHVkZX0gLSBJbmNsdWRlcyBhbiBleHRlcm5hbCBIVE1MIGZyYWdtZW50CiAqCiAqIEZvciBtb3JlIGluZm9ybWF0aW9uIGFib3V0IGFuZ3VsYXIgd2lkZ2V0cywgc2VlIHtAbGluayBndWlkZS9kZXZfZ3VpZGUuY29tcGlsZXIud2lkZ2V0cwogKiBVbmRlcnN0YW5kaW5nIEFuZ3VsYXIgV2lkZ2V0c30gaW4gdGhlIGFuZ3VsYXIgRGV2ZWxvcGVyIEd1aWRlLgogKi8KCi8qKgogKiBAd29ya0luUHJvZ3Jlc3MKICogQG5nZG9jIHdpZGdldAogKiBAbmFtZSBhbmd1bGFyLndpZGdldC5IVE1MCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBUaGUgbW9zdCBjb21tb24gd2lkZ2V0cyB5b3Ugd2lsbCB1c2Ugd2lsbCBiZSBpbiB0aGUgZm9ybSBvZiB0aGUKICogc3RhbmRhcmQgSFRNTCBzZXQuIFRoZXNlIHdpZGdldHMgYXJlIGJvdW5kIHVzaW5nIHRoZSBgbmFtZWAgYXR0cmlidXRlCiAqIHRvIGFuIGV4cHJlc3Npb24uIEluIGFkZGl0aW9uLCB0aGV5IGNhbiBoYXZlIGBuZzp2YWxpZGF0ZWAsIGBuZzpyZXF1aXJlZGAsCiAqIGBuZzpmb3JtYXRgLCBgbmc6Y2hhbmdlYCBhdHRyaWJ1dGUgdG8gZnVydGhlciBjb250cm9sIHRoZWlyIGJlaGF2aW9yLgogKgogKiBAdXNhZ2VDb250ZW50CiAqICAgc2VlIGV4YW1wbGUgYmVsb3cgZm9yIHVzYWdlCiAqCiAqICAgPGlucHV0IHR5cGU9InRleHR8Y2hlY2tib3h8Li4uIiAuLi4gLz4KICogICA8dGV4dGFyZWEgLi4uIC8+CiAqICAgPHNlbGVjdCAuLi4+CiAqICAgICA8b3B0aW9uPi4uLjwvb3B0aW9uPgogKiAgIDwvc2VsZWN0PgogKgogKiBAZXhhbXBsZQogICAgPGRvYzpleGFtcGxlPgogICAgICA8ZG9jOnNvdXJjZT4KICAgICAgICA8dGFibGUgc3R5bGU9ImZvbnQtc2l6ZTouOWVtOyI+CiAgICAgICAgICA8dHI+CiAgICAgICAgICAgIDx0aD5OYW1lPC90aD4KICAgICAgICAgICAgPHRoPkZvcm1hdDwvdGg+CiAgICAgICAgICAgIDx0aD5IVE1MPC90aD4KICAgICAgICAgICAgPHRoPlVJPC90aD4KICAgICAgICAgICAgPHRoIG5nOm5vbi1iaW5kYWJsZT57e2lucHV0I319PC90aD4KICAgICAgICAgIDwvdHI+CiAgICAgICAgICA8dHI+CiAgICAgICAgICAgIDx0aD50ZXh0PC90aD4KICAgICAgICAgICAgPHRkPlN0cmluZzwvdGQ+CiAgICAgICAgICAgIDx0ZD48dHQ+Jmx0O2lucHV0IHR5cGU9InRleHQiIG5hbWU9ImlucHV0MSImZ3Q7PC90dD48L3RkPgogICAgICAgICAgICA8dGQ+PGlucHV0IHR5cGU9InRleHQiIG5hbWU9ImlucHV0MSIgc2l6ZT0iNCI+PC90ZD4KICAgICAgICAgICAgPHRkPjx0dD57e2lucHV0MXxqc29ufX08L3R0PjwvdGQ+CiAgICAgICAgICA8L3RyPgogICAgICAgICAgPHRyPgogICAgICAgICAgICA8dGg+dGV4dGFyZWE8L3RoPgogICAgICAgICAgICA8dGQ+U3RyaW5nPC90ZD4KICAgICAgICAgICAgPHRkPjx0dD4mbHQ7dGV4dGFyZWEgbmFtZT0iaW5wdXQyIiZndDsmbHQ7L3RleHRhcmVhJmd0OzwvdHQ+PC90ZD4KICAgICAgICAgICAgPHRkPjx0ZXh0YXJlYSBuYW1lPSJpbnB1dDIiIGNvbHM9JzYnPjwvdGV4dGFyZWE+PC90ZD4KICAgICAgICAgICAgPHRkPjx0dD57e2lucHV0Mnxqc29ufX08L3R0PjwvdGQ+CiAgICAgICAgICA8L3RyPgogICAgICAgICAgPHRyPgogICAgICAgICAgICA8dGg+cmFkaW88L3RoPgogICAgICAgICAgICA8dGQ+U3RyaW5nPC90ZD4KICAgICAgICAgICAgPHRkPjx0dD4KICAgICAgICAgICAgICAmbHQ7aW5wdXQgdHlwZT0icmFkaW8iIG5hbWU9ImlucHV0MyIgdmFsdWU9IkEiJmd0Ozxicj4KICAgICAgICAgICAgICAmbHQ7aW5wdXQgdHlwZT0icmFkaW8iIG5hbWU9ImlucHV0MyIgdmFsdWU9IkIiJmd0OwogICAgICAgICAgICA8L3R0PjwvdGQ+CiAgICAgICAgICAgIDx0ZD4KICAgICAgICAgICAgICA8aW5wdXQgdHlwZT0icmFkaW8iIG5hbWU9ImlucHV0MyIgdmFsdWU9IkEiPgogICAgICAgICAgICAgIDxpbnB1dCB0eXBlPSJyYWRpbyIgbmFtZT0iaW5wdXQzIiB2YWx1ZT0iQiI+CiAgICAgICAgICAgIDwvdGQ+CiAgICAgICAgICAgIDx0ZD48dHQ+e3tpbnB1dDN8anNvbn19PC90dD48L3RkPgogICAgICAgICAgPC90cj4KICAgICAgICAgIDx0cj4KICAgICAgICAgICAgPHRoPmNoZWNrYm94PC90aD4KICAgICAgICAgICAgPHRkPkJvb2xlYW48L3RkPgogICAgICAgICAgICA8dGQ+PHR0PiZsdDtpbnB1dCB0eXBlPSJjaGVja2JveCIgbmFtZT0iaW5wdXQ0IiB2YWx1ZT0iY2hlY2tlZCImZ3Q7PC90dD48L3RkPgogICAgICAgICAgICA8dGQ+PGlucHV0IHR5cGU9ImNoZWNrYm94IiBuYW1lPSJpbnB1dDQiIHZhbHVlPSJjaGVja2VkIj48L3RkPgogICAgICAgICAgICA8dGQ+PHR0Pnt7aW5wdXQ0fGpzb259fTwvdHQ+PC90ZD4KICAgICAgICAgIDwvdHI+CiAgICAgICAgICA8dHI+CiAgICAgICAgICAgIDx0aD5wdWxsZG93bjwvdGg+CiAgICAgICAgICAgIDx0ZD5TdHJpbmc8L3RkPgogICAgICAgICAgICA8dGQ+PHR0PgogICAgICAgICAgICAgICZsdDtzZWxlY3QgbmFtZT0iaW5wdXQ1IiZndDs8YnI+CiAgICAgICAgICAgICAgJm5ic3A7Jm5ic3A7Jmx0O29wdGlvbiB2YWx1ZT0iYyImZ3Q7QyZsdDsvb3B0aW9uJmd0Ozxicj4KICAgICAgICAgICAgICAmbmJzcDsmbmJzcDsmbHQ7b3B0aW9uIHZhbHVlPSJkIiZndDtEJmx0Oy9vcHRpb24mZ3Q7PGJyPgogICAgICAgICAgICAgICZsdDsvc2VsZWN0Jmd0Ozxicj4KICAgICAgICAgICAgPC90dD48L3RkPgogICAgICAgICAgICA8dGQ+CiAgICAgICAgICAgICAgPHNlbGVjdCBuYW1lPSJpbnB1dDUiPgogICAgICAgICAgICAgICAgPG9wdGlvbiB2YWx1ZT0iYyI+Qzwvb3B0aW9uPgogICAgICAgICAgICAgICAgPG9wdGlvbiB2YWx1ZT0iZCI+RDwvb3B0aW9uPgogICAgICAgICAgICAgIDwvc2VsZWN0PgogICAgICAgICAgICA8L3RkPgogICAgICAgICAgICA8dGQ+PHR0Pnt7aW5wdXQ1fGpzb259fTwvdHQ+PC90ZD4KICAgICAgICAgIDwvdHI+CiAgICAgICAgICA8dHI+CiAgICAgICAgICAgIDx0aD5tdWx0aXNlbGVjdDwvdGg+CiAgICAgICAgICAgIDx0ZD5BcnJheTwvdGQ+CiAgICAgICAgICAgIDx0ZD48dHQ+CiAgICAgICAgICAgICAgJmx0O3NlbGVjdCBuYW1lPSJpbnB1dDYiIG11bHRpcGxlIHNpemU9IjQiJmd0Ozxicj4KICAgICAgICAgICAgICAmbmJzcDsmbmJzcDsmbHQ7b3B0aW9uIHZhbHVlPSJlIiZndDtFJmx0Oy9vcHRpb24mZ3Q7PGJyPgogICAgICAgICAgICAgICZuYnNwOyZuYnNwOyZsdDtvcHRpb24gdmFsdWU9ImYiJmd0O0YmbHQ7L29wdGlvbiZndDs8YnI+CiAgICAgICAgICAgICAgJmx0Oy9zZWxlY3QmZ3Q7PGJyPgogICAgICAgICAgICA8L3R0PjwvdGQ+CiAgICAgICAgICAgIDx0ZD4KICAgICAgICAgICAgICA8c2VsZWN0IG5hbWU9ImlucHV0NiIgbXVsdGlwbGUgc2l6ZT0iNCI+CiAgICAgICAgICAgICAgICA8b3B0aW9uIHZhbHVlPSJlIj5FPC9vcHRpb24+CiAgICAgICAgICAgICAgICA8b3B0aW9uIHZhbHVlPSJmIj5GPC9vcHRpb24+CiAgICAgICAgICAgICAgPC9zZWxlY3Q+CiAgICAgICAgICAgIDwvdGQ+CiAgICAgICAgICAgIDx0ZD48dHQ+e3tpbnB1dDZ8anNvbn19PC90dD48L3RkPgogICAgICAgICAgPC90cj4KICAgICAgICA8L3RhYmxlPgogICAgICA8L2RvYzpzb3VyY2U+CiAgICAgIDxkb2M6c2NlbmFyaW8+CgogICAgICAgIGl0KCdzaG91bGQgZXhlcmNpc2UgdGV4dCcsIGZ1bmN0aW9uKCl7CiAgICAgICAgIGlucHV0KCdpbnB1dDEnKS5lbnRlcignQ2FybG9zJyk7CiAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdpbnB1dDEnKSkudG9FcXVhbCgnIkNhcmxvcyInKTsKICAgICAgICB9KTsKICAgICAgICBpdCgnc2hvdWxkIGV4ZXJjaXNlIHRleHRhcmVhJywgZnVuY3Rpb24oKXsKICAgICAgICAgaW5wdXQoJ2lucHV0MicpLmVudGVyKCdDYXJsb3MnKTsKICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ2lucHV0MicpKS50b0VxdWFsKCciQ2FybG9zIicpOwogICAgICAgIH0pOwogICAgICAgIGl0KCdzaG91bGQgZXhlcmNpc2UgcmFkaW8nLCBmdW5jdGlvbigpewogICAgICAgICBleHBlY3QoYmluZGluZygnaW5wdXQzJykpLnRvRXF1YWwoJ251bGwnKTsKICAgICAgICAgaW5wdXQoJ2lucHV0MycpLnNlbGVjdCgnQScpOwogICAgICAgICBleHBlY3QoYmluZGluZygnaW5wdXQzJykpLnRvRXF1YWwoJyJBIicpOwogICAgICAgICBpbnB1dCgnaW5wdXQzJykuc2VsZWN0KCdCJyk7CiAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdpbnB1dDMnKSkudG9FcXVhbCgnIkIiJyk7CiAgICAgICAgfSk7CiAgICAgICAgaXQoJ3Nob3VsZCBleGVyY2lzZSBjaGVja2JveCcsIGZ1bmN0aW9uKCl7CiAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdpbnB1dDQnKSkudG9FcXVhbCgnZmFsc2UnKTsKICAgICAgICAgaW5wdXQoJ2lucHV0NCcpLmNoZWNrKCk7CiAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdpbnB1dDQnKSkudG9FcXVhbCgndHJ1ZScpOwogICAgICAgIH0pOwogICAgICAgIGl0KCdzaG91bGQgZXhlcmNpc2UgcHVsbGRvd24nLCBmdW5jdGlvbigpewogICAgICAgICBleHBlY3QoYmluZGluZygnaW5wdXQ1JykpLnRvRXF1YWwoJyJjIicpOwogICAgICAgICBzZWxlY3QoJ2lucHV0NScpLm9wdGlvbignZCcpOwogICAgICAgICBleHBlY3QoYmluZGluZygnaW5wdXQ1JykpLnRvRXF1YWwoJyJkIicpOwogICAgICAgIH0pOwogICAgICAgIGl0KCdzaG91bGQgZXhlcmNpc2UgbXVsdGlzZWxlY3QnLCBmdW5jdGlvbigpewogICAgICAgICBleHBlY3QoYmluZGluZygnaW5wdXQ2JykpLnRvRXF1YWwoJ1tdJyk7CiAgICAgICAgIHNlbGVjdCgnaW5wdXQ2Jykub3B0aW9ucygnZScpOwogICAgICAgICBleHBlY3QoYmluZGluZygnaW5wdXQ2JykpLnRvRXF1YWwoJ1siZSJdJyk7CiAgICAgICAgIHNlbGVjdCgnaW5wdXQ2Jykub3B0aW9ucygnZScsICdmJyk7CiAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdpbnB1dDYnKSkudG9FcXVhbCgnWyJlIiwiZiJdJyk7CiAgICAgICAgfSk7CiAgICAgIDwvZG9jOnNjZW5hcmlvPgogICAgPC9kb2M6ZXhhbXBsZT4KICovCgpmdW5jdGlvbiBtb2RlbEFjY2Vzc29yKHNjb3BlLCBlbGVtZW50KSB7CiAgdmFyIGV4cHIgPSBlbGVtZW50LmF0dHIoJ25hbWUnKTsKICB2YXIgZXhwckZuLCBhc3NpZ25GbjsKICBpZiAoZXhwcikgewogICAgZXhwckZuID0gcGFyc2VyKGV4cHIpLmFzc2lnbmFibGUoKTsKICAgIGFzc2lnbkZuID0gZXhwckZuLmFzc2lnbjsKICAgIGlmICghYXNzaWduRm4pIHRocm93IG5ldyBFcnJvcigiRXhwcmVzc2lvbiAnIiArIGV4cHIgKyAiJyBpcyBub3QgYXNzaWduYWJsZS4iKTsKICAgIHJldHVybiB7CiAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIGV4cHJGbihzY29wZSk7CiAgICAgIH0sCiAgICAgIHNldDogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICBpZiAodmFsdWUgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgcmV0dXJuIHNjb3BlLiR0cnlFdmFsKGZ1bmN0aW9uKCl7CiAgICAgICAgICAgIGFzc2lnbkZuKHNjb3BlLCB2YWx1ZSk7CiAgICAgICAgICB9LCBlbGVtZW50KTsKICAgICAgICB9CiAgICAgIH0KICAgIH07CiAgfQp9CgpmdW5jdGlvbiBtb2RlbEZvcm1hdHRlZEFjY2Vzc29yKHNjb3BlLCBlbGVtZW50KSB7CiAgdmFyIGFjY2Vzc29yID0gbW9kZWxBY2Nlc3NvcihzY29wZSwgZWxlbWVudCksCiAgICAgIGZvcm1hdHRlck5hbWUgPSBlbGVtZW50LmF0dHIoJ25nOmZvcm1hdCcpIHx8IE5PT1AsCiAgICAgIGZvcm1hdHRlciA9IGNvbXBpbGVGb3JtYXR0ZXIoZm9ybWF0dGVyTmFtZSk7CiAgaWYgKGFjY2Vzc29yKSB7CiAgICByZXR1cm4gewogICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBmb3JtYXR0ZXIuZm9ybWF0KHNjb3BlLCBhY2Nlc3Nvci5nZXQoKSk7CiAgICAgIH0sCiAgICAgIHNldDogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICByZXR1cm4gYWNjZXNzb3Iuc2V0KGZvcm1hdHRlci5wYXJzZShzY29wZSwgdmFsdWUpKTsKICAgICAgfQogICAgfTsKICB9Cn0KCmZ1bmN0aW9uIGNvbXBpbGVWYWxpZGF0b3IoZXhwcikgewogIHJldHVybiBwYXJzZXIoZXhwcikudmFsaWRhdG9yKCkoKTsKfQoKZnVuY3Rpb24gY29tcGlsZUZvcm1hdHRlcihleHByKSB7CiAgcmV0dXJuIHBhcnNlcihleHByKS5mb3JtYXR0ZXIoKSgpOwp9CgovKioKICogQHdvcmtJblByb2dyZXNzCiAqIEBuZ2RvYyB3aWRnZXQKICogQG5hbWUgYW5ndWxhci53aWRnZXQuQG5nOnZhbGlkYXRlCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBUaGUgYG5nOnZhbGlkYXRlYCBhdHRyaWJ1dGUgd2lkZ2V0IHZhbGlkYXRlcyB0aGUgdXNlciBpbnB1dC4gSWYgdGhlIGlucHV0IGRvZXMgbm90IHBhc3MKICogdmFsaWRhdGlvbiwgdGhlIGBuZy12YWxpZGF0aW9uLWVycm9yYCBDU1MgY2xhc3MgYW5kIHRoZSBgbmc6ZXJyb3JgIGF0dHJpYnV0ZSBhcmUgc2V0IG9uIHRoZSBpbnB1dAogKiBlbGVtZW50LiBDaGVjayBvdXQge0BsaW5rIGFuZ3VsYXIudmFsaWRhdG9yIHZhbGlkYXRvcnN9IHRvIGZpbmQgb3V0IG1vcmUuCiAqCiAqIEBwYXJhbSB7c3RyaW5nfSB2YWxpZGF0b3IgVGhlIG5hbWUgb2YgYSBidWlsdC1pbiBvciBjdXN0b20ge0BsaW5rIGFuZ3VsYXIudmFsaWRhdG9yIHZhbGlkYXRvcn0gdG8KICogICAgIHRvIGJlIHVzZWQuCiAqCiAqIEBlbGVtZW50IElOUFVUCiAqIEBjc3MgbmctdmFsaWRhdGlvbi1lcnJvcgogKgogKiBAZXhhbXBsZQogKiBUaGlzIGV4YW1wbGUgc2hvd3MgaG93IHRoZSBpbnB1dCBlbGVtZW50IGJlY29tZXMgcmVkIHdoZW4gaXQgY29udGFpbnMgaW52YWxpZCBpbnB1dC4gQ29ycmVjdAogKiB0aGUgaW5wdXQgdG8gbWFrZSB0aGUgZXJyb3IgZGlzYXBwZWFyLgogKgogICAgPGRvYzpleGFtcGxlPgogICAgICA8ZG9jOnNvdXJjZT4KICAgICAgICBJIGRvbid0IHZhbGlkYXRlOgogICAgICAgIDxpbnB1dCB0eXBlPSJ0ZXh0IiBuYW1lPSJ2YWx1ZSIgdmFsdWU9Ik5vdEFOdW1iZXIiPjxici8+CgogICAgICAgIEkgbmVlZCBhbiBpbnRlZ2VyIG9yIG5vdGhpbmc6CiAgICAgICAgPGlucHV0IHR5cGU9InRleHQiIG5hbWU9InZhbHVlIiBuZzp2YWxpZGF0ZT0iaW50ZWdlciI+PGJyLz4KICAgICAgPC9kb2M6c291cmNlPgogICAgICA8ZG9jOnNjZW5hcmlvPgogICAgICAgICBpdCgnc2hvdWxkIGNoZWNrIG5nOnZhbGlkYXRlJywgZnVuY3Rpb24oKXsKICAgICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgOmlucHV0Omxhc3QnKS5hdHRyKCdjbGFzc05hbWUnKSkuCiAgICAgICAgICAgICB0b01hdGNoKC9uZy12YWxpZGF0aW9uLWVycm9yLyk7CgogICAgICAgICAgIGlucHV0KCd2YWx1ZScpLmVudGVyKCcxMjMnKTsKICAgICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgOmlucHV0Omxhc3QnKS5hdHRyKCdjbGFzc05hbWUnKSkuCiAgICAgICAgICAgICBub3QoKS50b01hdGNoKC9uZy12YWxpZGF0aW9uLWVycm9yLyk7CiAgICAgICAgIH0pOwogICAgICA8L2RvYzpzY2VuYXJpbz4KICAgIDwvZG9jOmV4YW1wbGU+CiAqLwovKioKICogQHdvcmtJblByb2dyZXNzCiAqIEBuZ2RvYyB3aWRnZXQKICogQG5hbWUgYW5ndWxhci53aWRnZXQuQG5nOnJlcXVpcmVkCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBUaGUgYG5nOnJlcXVpcmVkYCBhdHRyaWJ1dGUgd2lkZ2V0IHZhbGlkYXRlcyB0aGF0IHRoZSB1c2VyIGlucHV0IGlzIHByZXNlbnQuIEl0IGlzIGEgc3BlY2lhbCBjYXNlCiAqIG9mIHRoZSB7QGxpbmsgYW5ndWxhci53aWRnZXQuQG5nOnZhbGlkYXRlIG5nOnZhbGlkYXRlfSBhdHRyaWJ1dGUgd2lkZ2V0LgogKgogKiBAZWxlbWVudCBJTlBVVAogKiBAY3NzIG5nLXZhbGlkYXRpb24tZXJyb3IKICoKICogQGV4YW1wbGUKICogVGhpcyBleGFtcGxlIHNob3dzIGhvdyB0aGUgaW5wdXQgZWxlbWVudCBiZWNvbWVzIHJlZCB3aGVuIGl0IGNvbnRhaW5zIGludmFsaWQgaW5wdXQuIENvcnJlY3QKICogdGhlIGlucHV0IHRvIG1ha2UgdGhlIGVycm9yIGRpc2FwcGVhci4KICoKICAgIDxkb2M6ZXhhbXBsZT4KICAgICAgPGRvYzpzb3VyY2U+CiAgICAgICAgSSBjYW5ub3QgYmUgYmxhbms6IDxpbnB1dCB0eXBlPSJ0ZXh0IiBuYW1lPSJ2YWx1ZSIgbmc6cmVxdWlyZWQ+PGJyLz4KICAgICAgPC9kb2M6c291cmNlPgogICAgICA8ZG9jOnNjZW5hcmlvPgogICAgICAgaXQoJ3Nob3VsZCBjaGVjayBuZzpyZXF1aXJlZCcsIGZ1bmN0aW9uKCl7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSA6aW5wdXQnKS5hdHRyKCdjbGFzc05hbWUnKSkudG9NYXRjaCgvbmctdmFsaWRhdGlvbi1lcnJvci8pOwogICAgICAgICBpbnB1dCgndmFsdWUnKS5lbnRlcignMTIzJyk7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSA6aW5wdXQnKS5hdHRyKCdjbGFzc05hbWUnKSkubm90KCkudG9NYXRjaCgvbmctdmFsaWRhdGlvbi1lcnJvci8pOwogICAgICAgfSk7CiAgICAgIDwvZG9jOnNjZW5hcmlvPgogICAgPC9kb2M6ZXhhbXBsZT4KICovCi8qKgogKiBAd29ya0luUHJvZ3Jlc3MKICogQG5nZG9jIHdpZGdldAogKiBAbmFtZSBhbmd1bGFyLndpZGdldC5Abmc6Zm9ybWF0CiAqCiAqIEBkZXNjcmlwdGlvbgogKiBUaGUgYG5nOmZvcm1hdGAgYXR0cmlidXRlIHdpZGdldCBmb3JtYXRzIHN0b3JlZCBkYXRhIHRvIHVzZXItcmVhZGFibGUgdGV4dCBhbmQgcGFyc2VzIHRoZSB0ZXh0CiAqIGJhY2sgdG8gdGhlIHN0b3JlZCBmb3JtLiBZb3UgbWlnaHQgZmluZCB0aGlzIHVzZWZ1bCwgZm9yIGV4YW1wbGUsIGlmIHlvdSBjb2xsZWN0IHVzZXIgaW5wdXQgaW4gYQogKiB0ZXh0IGZpZWxkIGJ1dCBuZWVkIHRvIHN0b3JlIHRoZSBkYXRhIGluIHRoZSBtb2RlbCBhcyBhIGxpc3QuIENoZWNrIG91dAogKiB7QGxpbmsgYW5ndWxhci5mb3JtYXR0ZXIgZm9ybWF0dGVyc30gdG8gbGVhcm4gbW9yZS4KICoKICogQHBhcmFtIHtzdHJpbmd9IGZvcm1hdHRlciBUaGUgbmFtZSBvZiB0aGUgYnVpbHQtaW4gb3IgY3VzdG9tIHtAbGluayBhbmd1bGFyLmZvcm1hdHRlciBmb3JtYXR0ZXJ9CiAqICAgICB0byBiZSB1c2VkLgogKgogKiBAZWxlbWVudCBJTlBVVAogKgogKiBAZXhhbXBsZQogKiBUaGlzIGV4YW1wbGUgc2hvd3MgaG93IHRoZSB1c2VyIGlucHV0IGlzIGNvbnZlcnRlZCBmcm9tIGEgc3RyaW5nIGFuZCBpbnRlcm5hbGx5IHJlcHJlc2VudGVkIGFzIGFuCiAqIGFycmF5LgogKgogICAgPGRvYzpleGFtcGxlPgogICAgICA8ZG9jOnNvdXJjZT4KICAgICAgICBFbnRlciBhIGNvbW1hIHNlcGFyYXRlZCBsaXN0IG9mIGl0ZW1zOgogICAgICAgIDxpbnB1dCB0eXBlPSJ0ZXh0IiBuYW1lPSJsaXN0IiBuZzpmb3JtYXQ9Imxpc3QiIHZhbHVlPSJ0YWJsZSwgY2hhaXJzLCBwbGF0ZSI+CiAgICAgICAgPHByZT5saXN0PXt7bGlzdH19PC9wcmU+CiAgICAgIDwvZG9jOnNvdXJjZT4KICAgICAgPGRvYzpzY2VuYXJpbz4KICAgICAgIGl0KCdzaG91bGQgY2hlY2sgbmc6Zm9ybWF0JywgZnVuY3Rpb24oKXsKICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ2xpc3QnKSkudG9CZSgnbGlzdD1bInRhYmxlIiwiY2hhaXJzIiwicGxhdGUiXScpOwogICAgICAgICBpbnB1dCgnbGlzdCcpLmVudGVyKCcsLCwgYSAsLCwnKTsKICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ2xpc3QnKSkudG9CZSgnbGlzdD1bImEiXScpOwogICAgICAgfSk7CiAgICAgIDwvZG9jOnNjZW5hcmlvPgogICAgPC9kb2M6ZXhhbXBsZT4KICovCmZ1bmN0aW9uIHZhbHVlQWNjZXNzb3Ioc2NvcGUsIGVsZW1lbnQpIHsKICB2YXIgdmFsaWRhdG9yTmFtZSA9IGVsZW1lbnQuYXR0cignbmc6dmFsaWRhdGUnKSB8fCBOT09QLAogICAgICB2YWxpZGF0b3IgPSBjb21waWxlVmFsaWRhdG9yKHZhbGlkYXRvck5hbWUpLAogICAgICByZXF1aXJlZEV4cHIgPSBlbGVtZW50LmF0dHIoJ25nOnJlcXVpcmVkJyksCiAgICAgIGZvcm1hdHRlck5hbWUgPSBlbGVtZW50LmF0dHIoJ25nOmZvcm1hdCcpIHx8IE5PT1AsCiAgICAgIGZvcm1hdHRlciA9IGNvbXBpbGVGb3JtYXR0ZXIoZm9ybWF0dGVyTmFtZSksCiAgICAgIGZvcm1hdCwgcGFyc2UsIGxhc3RFcnJvciwgcmVxdWlyZWQsCiAgICAgIGludmFsaWRXaWRnZXRzID0gc2NvcGUuJHNlcnZpY2UoJyRpbnZhbGlkV2lkZ2V0cycpIHx8IHttYXJrVmFsaWQ6bm9vcCwgbWFya0ludmFsaWQ6bm9vcH07CiAgaWYgKCF2YWxpZGF0b3IpIHRocm93ICJWYWxpZGF0b3IgbmFtZWQgJyIgKyB2YWxpZGF0b3JOYW1lICsgIicgbm90IGZvdW5kLiI7CiAgZm9ybWF0ID0gZm9ybWF0dGVyLmZvcm1hdDsKICBwYXJzZSA9IGZvcm1hdHRlci5wYXJzZTsKICBpZiAocmVxdWlyZWRFeHByKSB7CiAgICBzY29wZS4kd2F0Y2gocmVxdWlyZWRFeHByLCBmdW5jdGlvbihuZXdWYWx1ZSkgewogICAgICByZXF1aXJlZCA9IG5ld1ZhbHVlOwogICAgICB2YWxpZGF0ZSgpOwogICAgfSk7CiAgfSBlbHNlIHsKICAgIHJlcXVpcmVkID0gcmVxdWlyZWRFeHByID09PSAnJzsKICB9CgogIGVsZW1lbnQuZGF0YSgkJHZhbGlkYXRlLCB2YWxpZGF0ZSk7CiAgcmV0dXJuIHsKICAgIGdldDogZnVuY3Rpb24oKXsKICAgICAgaWYgKGxhc3RFcnJvcikKICAgICAgICBlbGVtZW50RXJyb3IoZWxlbWVudCwgTkdfVkFMSURBVElPTl9FUlJPUiwgbnVsbCk7CiAgICAgIHRyeSB7CiAgICAgICAgdmFyIHZhbHVlID0gcGFyc2Uoc2NvcGUsIGVsZW1lbnQudmFsKCkpOwogICAgICAgIHZhbGlkYXRlKCk7CiAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgbGFzdEVycm9yID0gZTsKICAgICAgICBlbGVtZW50RXJyb3IoZWxlbWVudCwgTkdfVkFMSURBVElPTl9FUlJPUiwgZSk7CiAgICAgIH0KICAgIH0sCiAgICBzZXQ6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIHZhciBvbGRWYWx1ZSA9IGVsZW1lbnQudmFsKCksCiAgICAgICAgICBuZXdWYWx1ZSA9IGZvcm1hdChzY29wZSwgdmFsdWUpOwogICAgICBpZiAob2xkVmFsdWUgIT0gbmV3VmFsdWUpIHsKICAgICAgICBlbGVtZW50LnZhbChuZXdWYWx1ZSB8fCAnJyk7IC8vIG5lZWRlZCBmb3IgaWUKICAgICAgfQogICAgICB2YWxpZGF0ZSgpOwogICAgfQogIH07CgogIGZ1bmN0aW9uIHZhbGlkYXRlKCkgewogICAgdmFyIHZhbHVlID0gdHJpbShlbGVtZW50LnZhbCgpKTsKICAgIGlmIChlbGVtZW50WzBdLmRpc2FibGVkIHx8IGVsZW1lbnRbMF0ucmVhZE9ubHkpIHsKICAgICAgZWxlbWVudEVycm9yKGVsZW1lbnQsIE5HX1ZBTElEQVRJT05fRVJST1IsIG51bGwpOwogICAgICBpbnZhbGlkV2lkZ2V0cy5tYXJrVmFsaWQoZWxlbWVudCk7CiAgICB9IGVsc2UgewogICAgICB2YXIgZXJyb3IsIHZhbGlkYXRlU2NvcGUgPSBpbmhlcml0KHNjb3BlLCB7JGVsZW1lbnQ6ZWxlbWVudH0pOwogICAgICBlcnJvciA9IHJlcXVpcmVkICYmICF2YWx1ZQogICAgICAgICAgICAgID8gJ1JlcXVpcmVkJwogICAgICAgICAgICAgIDogKHZhbHVlID8gdmFsaWRhdG9yKHZhbGlkYXRlU2NvcGUsIHZhbHVlKSA6IG51bGwpOwogICAgICBlbGVtZW50RXJyb3IoZWxlbWVudCwgTkdfVkFMSURBVElPTl9FUlJPUiwgZXJyb3IpOwogICAgICBsYXN0RXJyb3IgPSBlcnJvcjsKICAgICAgaWYgKGVycm9yKSB7CiAgICAgICAgaW52YWxpZFdpZGdldHMubWFya0ludmFsaWQoZWxlbWVudCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaW52YWxpZFdpZGdldHMubWFya1ZhbGlkKGVsZW1lbnQpOwogICAgICB9CiAgICB9CiAgfQp9CgpmdW5jdGlvbiBjaGVja2VkQWNjZXNzb3Ioc2NvcGUsIGVsZW1lbnQpIHsKICB2YXIgZG9tRWxlbWVudCA9IGVsZW1lbnRbMF0sIGVsZW1lbnRWYWx1ZSA9IGRvbUVsZW1lbnQudmFsdWU7CiAgcmV0dXJuIHsKICAgIGdldDogZnVuY3Rpb24oKXsKICAgICAgcmV0dXJuICEhZG9tRWxlbWVudC5jaGVja2VkOwogICAgfSwKICAgIHNldDogZnVuY3Rpb24odmFsdWUpewogICAgICBkb21FbGVtZW50LmNoZWNrZWQgPSB0b0Jvb2xlYW4odmFsdWUpOwogICAgfQogIH07Cn0KCmZ1bmN0aW9uIHJhZGlvQWNjZXNzb3Ioc2NvcGUsIGVsZW1lbnQpIHsKICB2YXIgZG9tRWxlbWVudCA9IGVsZW1lbnRbMF07CiAgcmV0dXJuIHsKICAgIGdldDogZnVuY3Rpb24oKXsKICAgICAgcmV0dXJuIGRvbUVsZW1lbnQuY2hlY2tlZCA/IGRvbUVsZW1lbnQudmFsdWUgOiBudWxsOwogICAgfSwKICAgIHNldDogZnVuY3Rpb24odmFsdWUpewogICAgICBkb21FbGVtZW50LmNoZWNrZWQgPSB2YWx1ZSA9PSBkb21FbGVtZW50LnZhbHVlOwogICAgfQogIH07Cn0KCmZ1bmN0aW9uIG9wdGlvbnNBY2Nlc3NvcihzY29wZSwgZWxlbWVudCkgewogIHZhciBmb3JtYXR0ZXJOYW1lID0gZWxlbWVudC5hdHRyKCduZzpmb3JtYXQnKSB8fCBOT09QLAogICAgICBmb3JtYXR0ZXIgPSBjb21waWxlRm9ybWF0dGVyKGZvcm1hdHRlck5hbWUpOwogIHJldHVybiB7CiAgICBnZXQ6IGZ1bmN0aW9uKCl7CiAgICAgIHZhciB2YWx1ZXMgPSBbXTsKICAgICAgZm9yRWFjaChlbGVtZW50WzBdLm9wdGlvbnMsIGZ1bmN0aW9uKG9wdGlvbil7CiAgICAgICAgaWYgKG9wdGlvbi5zZWxlY3RlZCkgdmFsdWVzLnB1c2goZm9ybWF0dGVyLnBhcnNlKHNjb3BlLCBvcHRpb24udmFsdWUpKTsKICAgICAgfSk7CiAgICAgIHJldHVybiB2YWx1ZXM7CiAgICB9LAogICAgc2V0OiBmdW5jdGlvbih2YWx1ZXMpewogICAgICB2YXIga2V5cyA9IHt9OwogICAgICBmb3JFYWNoKHZhbHVlcywgZnVuY3Rpb24odmFsdWUpewogICAgICAgIGtleXNbZm9ybWF0dGVyLmZvcm1hdChzY29wZSwgdmFsdWUpXSA9IHRydWU7CiAgICAgIH0pOwogICAgICBmb3JFYWNoKGVsZW1lbnRbMF0ub3B0aW9ucywgZnVuY3Rpb24ob3B0aW9uKXsKICAgICAgICBvcHRpb24uc2VsZWN0ZWQgPSBrZXlzW29wdGlvbi52YWx1ZV07CiAgICAgIH0pOwogICAgfQogIH07Cn0KCmZ1bmN0aW9uIG5vb3BBY2Nlc3NvcigpIHsgcmV0dXJuIHsgZ2V0OiBub29wLCBzZXQ6IG5vb3AgfTsgfQoKLyoKICogVE9ETzogcmVmYWN0b3IKICoKICogVGhlIHRhYmxlIGJlbG93IGlzIG5vdCBxdWl0ZSByaWdodC4gSW4gc29tZSBjYXNlcyB0aGUgZm9ybWF0dGVyIGlzIG9uIHRoZSBtb2RlbCBzaWRlCiAqIGFuZCBpbiBzb21lIGNhc2VzIGl0IGlzIG9uIHRoZSB2aWV3IHNpZGUuIFRoaXMgaXMgYSBoaXN0b3JpY2FsIGFydGlmYWN0CiAqCiAqIFRoZSBjb25jZXB0IG9mIG1vZGVsL3ZpZXcgYWNjZXNzb3IgaXMgdXNlZnVsIGZvciBhbnlvbmUgd2hvIGlzIHRyeWluZyB0byBkZXZlbG9wIFVJLCBhbmQKICogc28gaXQgc2hvdWxkIGJlIGV4cG9zZWQgdG8gb3RoZXJzLiBUaGVyZSBzaG91bGQgYmUgYSBmb3JtIG9iamVjdCB3aGljaCBrZWVwcyB0cmFjayBvZiB0aGUKICogYWNjZXNzb3JzIGFuZCBhbHNvIGFjdHMgYXMgdGhlaXIgZmFjdG9yeS4gSXQgc2hvdWxkIGV4cG9zZSBpdCBhcyBhbiBvYmplY3QgYW5kIGFsbG93CiAqIHRoZSB2YWxpZGF0b3IgdG8gcHVibGlzaCBlcnJvcnMgdG8gaXQsIHNvIHRoYXQgdGhlIHRoZSBlcnJvciBtZXNzYWdlcyBjYW4gYmUgYm91bmQgdG8gaXQuCiAqCiAqLwp2YXIgdGV4dFdpZGdldCA9IGlucHV0V2lkZ2V0KCdrZXlkb3duIGNoYW5nZScsIG1vZGVsQWNjZXNzb3IsIHZhbHVlQWNjZXNzb3IsIGluaXRXaWRnZXRWYWx1ZSgpLCB0cnVlKSwKICAgIElOUFVUX1RZUEUgPSB7CiAgICAgICd0ZXh0JzogICAgICAgICAgICB0ZXh0V2lkZ2V0LAogICAgICAndGV4dGFyZWEnOiAgICAgICAgdGV4dFdpZGdldCwKICAgICAgJ2hpZGRlbic6ICAgICAgICAgIHRleHRXaWRnZXQsCiAgICAgICdwYXNzd29yZCc6ICAgICAgICB0ZXh0V2lkZ2V0LAogICAgICAnY2hlY2tib3gnOiAgICAgICAgaW5wdXRXaWRnZXQoJ2NsaWNrJywgbW9kZWxGb3JtYXR0ZWRBY2Nlc3NvciwgY2hlY2tlZEFjY2Vzc29yLCBpbml0V2lkZ2V0VmFsdWUoZmFsc2UpKSwKICAgICAgJ3JhZGlvJzogICAgICAgICAgIGlucHV0V2lkZ2V0KCdjbGljaycsIG1vZGVsRm9ybWF0dGVkQWNjZXNzb3IsIHJhZGlvQWNjZXNzb3IsIHJhZGlvSW5pdCksCiAgICAgICdzZWxlY3Qtb25lJzogICAgICBpbnB1dFdpZGdldCgnY2hhbmdlJywgbW9kZWxBY2Nlc3NvciwgdmFsdWVBY2Nlc3NvciwgaW5pdFdpZGdldFZhbHVlKG51bGwpKSwKICAgICAgJ3NlbGVjdC1tdWx0aXBsZSc6IGlucHV0V2lkZ2V0KCdjaGFuZ2UnLCBtb2RlbEFjY2Vzc29yLCBvcHRpb25zQWNjZXNzb3IsIGluaXRXaWRnZXRWYWx1ZShbXSkpCi8vICAgICAgJ2ZpbGUnOiAgICAgICAgICAgIGZpbGVXaWRnZXQ/Pz8KICAgIH07CgoKZnVuY3Rpb24gaW5pdFdpZGdldFZhbHVlKGluaXRWYWx1ZSkgewogIHJldHVybiBmdW5jdGlvbiAobW9kZWwsIHZpZXcpIHsKICAgIHZhciB2YWx1ZSA9IHZpZXcuZ2V0KCk7CiAgICBpZiAoIXZhbHVlICYmIGlzRGVmaW5lZChpbml0VmFsdWUpKSB7CiAgICAgIHZhbHVlID0gY29weShpbml0VmFsdWUpOwogICAgfQogICAgaWYgKGlzVW5kZWZpbmVkKG1vZGVsLmdldCgpKSAmJiBpc0RlZmluZWQodmFsdWUpKSB7CiAgICAgIG1vZGVsLnNldCh2YWx1ZSk7CiAgICB9CiAgfTsKfQoKZnVuY3Rpb24gcmFkaW9Jbml0KG1vZGVsLCB2aWV3LCBlbGVtZW50KSB7CiB2YXIgbW9kZWxWYWx1ZSA9IG1vZGVsLmdldCgpLCB2aWV3VmFsdWUgPSB2aWV3LmdldCgpLCBpbnB1dCA9IGVsZW1lbnRbMF07CiBpbnB1dC5jaGVja2VkID0gZmFsc2U7CiBpbnB1dC5uYW1lID0gdGhpcy4kaWQgKyAnQCcgKyBpbnB1dC5uYW1lOwogaWYgKGlzVW5kZWZpbmVkKG1vZGVsVmFsdWUpKSB7CiAgIG1vZGVsLnNldChtb2RlbFZhbHVlID0gbnVsbCk7CiB9CiBpZiAobW9kZWxWYWx1ZSA9PSBudWxsICYmIHZpZXdWYWx1ZSAhPT0gbnVsbCkgewogICBtb2RlbC5zZXQodmlld1ZhbHVlKTsKIH0KIHZpZXcuc2V0KG1vZGVsVmFsdWUpOwp9CgovKioKICogQHdvcmtJblByb2dyZXNzCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgYW5ndWxhci5kaXJlY3RpdmUubmc6Y2hhbmdlCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBUaGUgZGlyZWN0aXZlIGV4ZWN1dGVzIGFuIGV4cHJlc3Npb24gd2hlbmV2ZXIgdGhlIGlucHV0IHdpZGdldCBjaGFuZ2VzLgogKgogKiBAZWxlbWVudCBJTlBVVAogKiBAcGFyYW0ge2V4cHJlc3Npb259IGV4cHJlc3Npb24gdG8gZXhlY3V0ZS4KICoKICogQGV4YW1wbGUKICogQGV4YW1wbGUKICAgIDxkb2M6ZXhhbXBsZT4KICAgICAgPGRvYzpzb3VyY2U+CiAgICAgICAgPGRpdiBuZzppbml0PSJjaGVja2JveENvdW50PTA7IHRleHRDb3VudD0wIj48L2Rpdj4KICAgICAgICA8aW5wdXQgdHlwZT0idGV4dCIgbmFtZT0idGV4dCIgbmc6Y2hhbmdlPSJ0ZXh0Q291bnQgPSAxICsgdGV4dENvdW50Ij4KICAgICAgICAgICBjaGFuZ2VDb3VudCB7e3RleHRDb3VudH19PGJyLz4KICAgICAgICA8aW5wdXQgdHlwZT0iY2hlY2tib3giIG5hbWU9ImNoZWNrYm94IiBuZzpjaGFuZ2U9ImNoZWNrYm94Q291bnQgPSAxICsgY2hlY2tib3hDb3VudCI+CiAgICAgICAgICAgY2hhbmdlQ291bnQge3tjaGVja2JveENvdW50fX08YnIvPgogICAgICA8L2RvYzpzb3VyY2U+CiAgICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgICAgIGl0KCdzaG91bGQgY2hlY2sgbmc6Y2hhbmdlJywgZnVuY3Rpb24oKXsKICAgICAgICAgICBleHBlY3QoYmluZGluZygndGV4dENvdW50JykpLnRvQmUoJzAnKTsKICAgICAgICAgICBleHBlY3QoYmluZGluZygnY2hlY2tib3hDb3VudCcpKS50b0JlKCcwJyk7CgogICAgICAgICAgIHVzaW5nKCcuZG9jLWV4YW1wbGUtbGl2ZScpLmlucHV0KCd0ZXh0JykuZW50ZXIoJ2FiYycpOwogICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCd0ZXh0Q291bnQnKSkudG9CZSgnMScpOwogICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdjaGVja2JveENvdW50JykpLnRvQmUoJzAnKTsKCgogICAgICAgICAgIHVzaW5nKCcuZG9jLWV4YW1wbGUtbGl2ZScpLmlucHV0KCdjaGVja2JveCcpLmNoZWNrKCk7CiAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3RleHRDb3VudCcpKS50b0JlKCcxJyk7CiAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ2NoZWNrYm94Q291bnQnKSkudG9CZSgnMScpOwogICAgICAgICB9KTsKICAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICA8L2RvYzpleGFtcGxlPgogKi8KZnVuY3Rpb24gaW5wdXRXaWRnZXQoZXZlbnRzLCBtb2RlbEFjY2Vzc29yLCB2aWV3QWNjZXNzb3IsIGluaXRGbiwgdGV4dEJveCkgewogIHJldHVybiBhbm5vdGF0ZSgnJHVwZGF0ZVZpZXcnLCAnJGRlZmVyJywgZnVuY3Rpb24oJHVwZGF0ZVZpZXcsICRkZWZlciwgZWxlbWVudCkgewogICAgdmFyIHNjb3BlID0gdGhpcywKICAgICAgICBtb2RlbCA9IG1vZGVsQWNjZXNzb3Ioc2NvcGUsIGVsZW1lbnQpLAogICAgICAgIHZpZXcgPSB2aWV3QWNjZXNzb3Ioc2NvcGUsIGVsZW1lbnQpLAogICAgICAgIGFjdGlvbiA9IGVsZW1lbnQuYXR0cignbmc6Y2hhbmdlJykgfHwgJycsCiAgICAgICAgbGFzdFZhbHVlOwogICAgaWYgKG1vZGVsKSB7CiAgICAgIGluaXRGbi5jYWxsKHNjb3BlLCBtb2RlbCwgdmlldywgZWxlbWVudCk7CiAgICAgIHRoaXMuJGV2YWwoZWxlbWVudC5hdHRyKCduZzppbml0Jyl8fCcnKTsKICAgICAgZWxlbWVudC5iaW5kKGV2ZW50cywgZnVuY3Rpb24oZXZlbnQpewogICAgICAgIGZ1bmN0aW9uIGhhbmRsZXIoKXsKICAgICAgICAgIHZhciB2YWx1ZSA9IHZpZXcuZ2V0KCk7CiAgICAgICAgICBpZiAoIXRleHRCb3ggfHwgdmFsdWUgIT0gbGFzdFZhbHVlKSB7CiAgICAgICAgICAgIG1vZGVsLnNldCh2YWx1ZSk7CiAgICAgICAgICAgIGxhc3RWYWx1ZSA9IG1vZGVsLmdldCgpOwogICAgICAgICAgICBzY29wZS4kdHJ5RXZhbChhY3Rpb24sIGVsZW1lbnQpOwogICAgICAgICAgICAkdXBkYXRlVmlldygpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBldmVudC50eXBlID09ICdrZXlkb3duJyA/ICRkZWZlcihoYW5kbGVyKSA6IGhhbmRsZXIoKTsKICAgICAgfSk7CiAgICAgIHNjb3BlLiR3YXRjaChtb2RlbC5nZXQsIGZ1bmN0aW9uKHZhbHVlKXsKICAgICAgICBpZiAobGFzdFZhbHVlICE9PSB2YWx1ZSkgewogICAgICAgICAgdmlldy5zZXQobGFzdFZhbHVlID0gdmFsdWUpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgfSk7Cn0KCmZ1bmN0aW9uIGlucHV0V2lkZ2V0U2VsZWN0b3IoZWxlbWVudCl7CiAgdGhpcy5kaXJlY3RpdmVzKHRydWUpOwogIHRoaXMuZGVzY2VuZCh0cnVlKTsKICByZXR1cm4gSU5QVVRfVFlQRVtsb3dlcmNhc2UoZWxlbWVudFswXS50eXBlKV0gfHwgbm9vcDsKfQoKYW5ndWxhcldpZGdldCgnaW5wdXQnLCBpbnB1dFdpZGdldFNlbGVjdG9yKTsKYW5ndWxhcldpZGdldCgndGV4dGFyZWEnLCBpbnB1dFdpZGdldFNlbGVjdG9yKTsKCgovKioKICogQHdvcmtJblByb2dyZXNzCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgYW5ndWxhci5kaXJlY3RpdmUubmc6b3B0aW9ucwogKgogKiBAZGVzY3JpcHRpb24KICogRHluYW1pY2FsbHkgZ2VuZXJhdGUgYSBsaXN0IG9mIGA8b3B0aW9uPmAgZWxlbWVudHMgZm9yIGEgYDxzZWxlY3Q+YCBlbGVtZW50IHVzaW5nIGFuIGFycmF5IG9yCiAqIGFuIG9iamVjdCBvYnRhaW5lZCBieSBldmFsdWF0aW5nIHRoZSBgbmc6b3B0aW9uc2AgZXhwcmVzc2lvbi4KICoKICogV2hlbiBhbiBpdGVtIGluIHRoZSBzZWxlY3QgbWVudSBpcyBzZWxlY3QsIHRoZSB2YWx1ZSBvZiBhcnJheSBlbGVtZW50IG9yIG9iamVjdCBwcm9wZXJ0eQogKiByZXByZXNlbnRlZCBieSB0aGUgc2VsZWN0ZWQgb3B0aW9uIHdpbGwgYmUgYm91bmQgdG8gdGhlIG1vZGVsIGlkZW50aWZpZWQgYnkgdGhlIGBuYW1lYCBhdHRyaWJ1dGUKICogb2YgdGhlIHBhcmVudCBzZWxlY3QgZWxlbWVudC4KICoKICogT3B0aW9uYWxseSwgYSBzaW5nbGUgaGFyZC1jb2RlZCBgPG9wdGlvbj5gIGVsZW1lbnQsIHdpdGggdGhlIHZhbHVlIHNldCB0byBhbiBlbXB0eSBzdHJpbmcsIGNhbgogKiBiZSBuZXN0ZWQgaW50byB0aGUgYDxzZWxlY3Q+YCBlbGVtZW50LiBUaGlzIGVsZW1lbnQgd2lsbCB0aGVuIHJlcHJlc2VudCBgbnVsbGAgb3IgIm5vdCBzZWxlY3RlZCIKICogb3B0aW9uLiBTZWUgZXhhbXBsZSBiZWxvdyBmb3IgZGVtb25zdHJhdGlvbi4KICoKICogTm90ZTogYG5nOm9wdGlvbnNgIHByb3ZpZGVzIGl0ZXJhdG9yIGZhY2lsaXR5IGZvciBgPG9wdGlvbj5gIGVsZW1lbnQgd2hpY2ggbXVzdCBiZSB1c2VkIGluc3RlYWQKICogb2Yge0BsaW5rIGFuZ3VsYXIud2lkZ2V0LkBuZzpyZXBlYXQgbmc6cmVwZWF0fS4gYG5nOnJlcGVhdGAgaXMgbm90IHN1aXRhYmxlIGZvciB1c2Ugd2l0aAogKiBgPG9wdGlvbj5gIGVsZW1lbnQgYmVjYXVzZSBvZiB0aGUgZm9sbG93aW5nIHJlYXNvbnM6CiAqCiAqICAgKiB2YWx1ZSBhdHRyaWJ1dGUgb2YgdGhlIG9wdGlvbiBlbGVtZW50IHRoYXQgd2UgbmVlZCB0byBiaW5kIHRvIHJlcXVpcmVzIGEgc3RyaW5nLCBidXQgdGhlCiAqICAgICBzb3VyY2Ugb2YgZGF0YSBmb3IgdGhlIGl0ZXJhdGlvbiBtaWdodCBiZSBpbiBhIGZvcm0gb2YgYXJyYXkgY29udGFpbmluZyBvYmplY3RzIGluc3RlYWQgb2YKICogICAgIHN0cmluZ3MKICogICAqIHtAbGluayBhbmd1bGFyLndpZGdldC5Abmc6cmVwZWF0IG5nOnJlcGVhdH0gdW5yb2xscyBhZnRlciB0aGUgc2VsZWN0IGJpbmRzIGNhdXNpbmcKICogICAgIGluY29yZWN0IHJlbmRlcmluZyBvbiBtb3N0IGJyb3dzZXJzLgogKiAgICogYmluZGluZyB0byBhIHZhbHVlIG5vdCBpbiBsaXN0IGNvbmZ1c2VzIG1vc3QgYnJvd3NlcnMuCiAqCiAqIEBlbGVtZW50IHNlbGVjdAogKiBAcGFyYW0ge2NvbXByZWhlbnNpb25fZXhwcmVzc2lvbn0gY29tcHJlaGVuc2lvbiBpbiBvbmUgb2YgdGhlIGZvbGxvd2luZyBmb3JtczoKICoKICogICAqIGZvciBhcnJheSBkYXRhIHNvdXJjZXM6CiAqICAgICAqIGBsYWJlbGAgKipgZm9yYCoqIGB2YWx1ZWAgKipgaW5gKiogYGFycmF5YAogKiAgICAgKiBgc2VsZWN0YCAqKmBhc2AqKiBgbGFiZWxgICoqYGZvcmAqKiBgdmFsdWVgICoqYGluYCoqIGBhcnJheWAKICogICAgICogYGxhYmVsYCAgKipgZ3JvdXAgYnlgKiogYGdyb3VwYCAqKmBmb3JgKiogYHZhbHVlYCAqKmBpbmAqKiBgYXJyYXlgCiAqICAgICAqIGBzZWxlY3RgICoqYGFzYCoqIGBsYWJlbGAgKipgZ3JvdXAgYnlgKiogYGdyb3VwYCAqKmBmb3JgKiogYHZhbHVlYCAqKmBpbmAqKiBgYXJyYXlgCiAqICAgKiBmb3Igb2JqZWN0IGRhdGEgc291cmNlczoKICogICAgICogYGxhYmVsYCAqKmBmb3IgKGAqKmBrZXlgICoqYCxgKiogYHZhbHVlYCoqYCkgaW5gKiogYG9iamVjdGAKICogICAgICogYHNlbGVjdGAgKipgYXNgKiogYGxhYmVsYCAqKmBmb3IgKGAqKmBrZXlgICoqYCxgKiogYHZhbHVlYCoqYCkgaW5gKiogYG9iamVjdGAKICogICAgICogYGxhYmVsYCAqKmBncm91cCBieWAqKiBgZ3JvdXBgICoqYGZvciAoYCoqYGtleWAqKmAsYCoqIGB2YWx1ZWAqKmApIGluYCoqIGBvYmplY3RgCiAqICAgICAqIGBzZWxlY3RgICoqYGFzYCoqIGBsYWJlbGAgKipgZ3JvdXAgYnlgKiogYGdyb3VwYAogKiAgICAgICAgICoqYGZvcmAgYChgKipga2V5YCoqYCxgKiogYHZhbHVlYCoqYCkgaW5gKiogYG9iamVjdGAKICoKICogV2hlcmU6CiAqCiAqICAgKiBgYXJyYXlgIC8gYG9iamVjdGA6IGFuIGV4cHJlc3Npb24gd2hpY2ggZXZhbHVhdGVzIHRvIGFuIGFycmF5IC8gb2JqZWN0IHRvIGl0ZXJhdGUgb3Zlci4KICogICAqIGB2YWx1ZWA6IGxvY2FsIHZhcmlhYmxlIHdoaWNoIHdpbGwgcmVmZXIgdG8gZWFjaCBpdGVtIGluIHRoZSBgYXJyYXlgIG9yIGVhY2ggcHJvcGVydHkgdmFsdWUKICogICAgICBvZiBgb2JqZWN0YCBkdXJpbmcgaXRlcmF0aW9uLgogKiAgICogYGtleWA6IGxvY2FsIHZhcmlhYmxlIHdoaWNoIHdpbGwgcmVmZXIgdG8gYSBwcm9wZXJ0eSBuYW1lIGluIGBvYmplY3RgIGR1cmluZyBpdGVyYXRpb24uCiAqICAgKiBgbGFiZWxgOiBUaGUgcmVzdWx0IG9mIHRoaXMgZXhwcmVzc2lvbiB3aWxsIGJlIHRoZSBsYWJlbCBmb3IgYDxvcHRpb24+YCBlbGVtZW50LiBUaGUKICogICAgIGBleHByZXNzaW9uYCB3aWxsIG1vc3QgbGlrZWx5IHJlZmVyIHRvIHRoZSBgdmFsdWVgIHZhcmlhYmxlIChlLmcuIGB2YWx1ZS5wcm9wZXJ0eU5hbWVgKS4KICogICAqIGBzZWxlY3RgOiBUaGUgcmVzdWx0IG9mIHRoaXMgZXhwcmVzc2lvbiB3aWxsIGJlIGJvdW5kIHRvIHRoZSBtb2RlbCBvZiB0aGUgcGFyZW50IGA8c2VsZWN0PmAKICogICAgICBlbGVtZW50LiBJZiBub3Qgc3BlY2lmaWVkLCBgc2VsZWN0YCBleHByZXNzaW9uIHdpbGwgZGVmYXVsdCB0byBgdmFsdWVgLgogKiAgICogYGdyb3VwYDogVGhlIHJlc3VsdCBvZiB0aGlzIGV4cHJlc3Npb24gd2lsbCBiZSB1c2VkIHRvIGdyb3VwIG9wdGlvbnMgdXNpbmcgdGhlIGA8b3B0Z3JvdXA+YAogKiAgICAgIERPTSBlbGVtZW50LgogKgogKiBAZXhhbXBsZQogICAgPGRvYzpleGFtcGxlPgogICAgICA8ZG9jOnNvdXJjZT4KICAgICAgICA8c2NyaXB0PgogICAgICAgIGZ1bmN0aW9uIE15Q250cmwoKXsKICAgICAgICAgIHRoaXMuY29sb3JzID0gWwogICAgICAgICAgICB7bmFtZTonYmxhY2snLCBzaGFkZTonZGFyayd9LAogICAgICAgICAgICB7bmFtZTond2hpdGUnLCBzaGFkZTonbGlnaHQnfSwKICAgICAgICAgICAge25hbWU6J3JlZCcsIHNoYWRlOidkYXJrJ30sCiAgICAgICAgICAgIHtuYW1lOidibHVlJywgc2hhZGU6J2RhcmsnfSwKICAgICAgICAgICAge25hbWU6J3llbGxvdycsIHNoYWRlOidsaWdodCd9CiAgICAgICAgICBdOwogICAgICAgICAgdGhpcy5jb2xvciA9IHRoaXMuY29sb3JzWzJdOyAvLyByZWQKICAgICAgICB9CiAgICAgICAgPC9zY3JpcHQ+CiAgICAgICAgPGRpdiBuZzpjb250cm9sbGVyPSJNeUNudHJsIj4KICAgICAgICAgIDx1bD4KICAgICAgICAgICAgPGxpIG5nOnJlcGVhdD0iY29sb3IgaW4gY29sb3JzIj4KICAgICAgICAgICAgICBOYW1lOiA8aW5wdXQgbmFtZT0iY29sb3IubmFtZSI+CiAgICAgICAgICAgICAgWzxhIGhyZWYgbmc6Y2xpY2s9ImNvbG9ycy4kcmVtb3ZlKGNvbG9yKSI+WDwvYT5dCiAgICAgICAgICAgIDwvbGk+CiAgICAgICAgICAgIDxsaT4KICAgICAgICAgICAgICBbPGEgaHJlZiBuZzpjbGljaz0iY29sb3JzLnB1c2goe30pIj5hZGQ8L2E+XQogICAgICAgICAgICA8L2xpPgogICAgICAgICAgPC91bD4KICAgICAgICAgIDxoci8+CiAgICAgICAgICBDb2xvciAobnVsbCBub3QgYWxsb3dlZCk6CiAgICAgICAgICA8c2VsZWN0IG5hbWU9ImNvbG9yIiBuZzpvcHRpb25zPSJjLm5hbWUgZm9yIGMgaW4gY29sb3JzIj48L3NlbGVjdD48YnI+CgogICAgICAgICAgQ29sb3IgKG51bGwgYWxsb3dlZCk6CiAgICAgICAgICA8ZGl2ICBjbGFzcz0ibnVsbGFibGUiPgogICAgICAgICAgICA8c2VsZWN0IG5hbWU9ImNvbG9yIiBuZzpvcHRpb25zPSJjLm5hbWUgZm9yIGMgaW4gY29sb3JzIj4KICAgICAgICAgICAgICA8b3B0aW9uIHZhbHVlPSIiPi0tIGNob3NlIGNvbG9yIC0tPC9vcHRpb24+CiAgICAgICAgICAgIDwvc2VsZWN0PgogICAgICAgICAgPC9kaXY+PGJyLz4KCiAgICAgICAgICBDb2xvciBncm91cGVkIGJ5IHNoYWRlOgogICAgICAgICAgPHNlbGVjdCBuYW1lPSJjb2xvciIgbmc6b3B0aW9ucz0iYy5uYW1lIGdyb3VwIGJ5IGMuc2hhZGUgZm9yIGMgaW4gY29sb3JzIj4KICAgICAgICAgIDwvc2VsZWN0Pjxici8+CgoKICAgICAgICAgIFNlbGVjdCA8YSBocmVmIG5nOmNsaWNrPSJjb2xvcj17bmFtZTonbm90IGluIGxpc3QnfSI+Ym9ndXM8L2E+Ljxicj4KICAgICAgICAgIDxoci8+CiAgICAgICAgICBDdXJyZW50bHkgc2VsZWN0ZWQ6IHt7IHtzZWxlY3RlZF9jb2xvcjpjb2xvcn0gIH19CiAgICAgICAgICA8ZGl2IHN0eWxlPSJib3JkZXI6c29saWQgMXB4IGJsYWNrOyBoZWlnaHQ6MjBweCIKICAgICAgICAgICAgICAgbmc6c3R5bGU9InsnYmFja2dyb3VuZC1jb2xvcic6Y29sb3IubmFtZX0iPgogICAgICAgICAgPC9kaXY+CiAgICAgICAgPC9kaXY+CiAgICAgIDwvZG9jOnNvdXJjZT4KICAgICAgPGRvYzpzY2VuYXJpbz4KICAgICAgICAgaXQoJ3Nob3VsZCBjaGVjayBuZzpvcHRpb25zJywgZnVuY3Rpb24oKXsKICAgICAgICAgICBleHBlY3QoYmluZGluZygnY29sb3InKSkudG9NYXRjaCgncmVkJyk7CiAgICAgICAgICAgc2VsZWN0KCdjb2xvcicpLm9wdGlvbignMCcpOwogICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdjb2xvcicpKS50b01hdGNoKCdibGFjaycpOwogICAgICAgICAgIHVzaW5nKCcubnVsbGFibGUnKS5zZWxlY3QoJ2NvbG9yJykub3B0aW9uKCcnKTsKICAgICAgICAgICBleHBlY3QoYmluZGluZygnY29sb3InKSkudG9NYXRjaCgnbnVsbCcpOwogICAgICAgICB9KTsKICAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICA8L2RvYzpleGFtcGxlPgogKi8KLy8gICAgICAgICAgICAgICAgICAgICAgIDAwMDAxMTExMTAwMDAwMDAwMDAwMjIyMjAwMDAwMDAwMDAwMDAwMDAwMDAwMDAzMzMzMDAwMDAwMDAwMDAwMDQ0NDQ0NDQ0NDQ0NDQ0NDQ0MDAwMDAwMDAwNTU1NTU1NTU1NTU1NTU1NTUwMDAwMDAwNjY2NjY2NjY2NjY2NjY2NjYwMDAwMDAwMDAwMDAwMDA3Nzc3CnZhciBOR19PUFRJT05TX1JFR0VYUCA9IC9eXHMqKC4qPykoPzpccythc1xzKyguKj8pKT8oPzpccytncm91cFxzK2J5XHMrKC4qKSk/XHMrZm9yXHMrKD86KFtcJFx3XVtcJFx3XGRdKil8KD86XChccyooW1wkXHddW1wkXHdcZF0qKVxzKixccyooW1wkXHddW1wkXHdcZF0qKVxzKlwpKSlccytpblxzKyguKikkLzsKYW5ndWxhcldpZGdldCgnc2VsZWN0JywgZnVuY3Rpb24oZWxlbWVudCl7CiAgdGhpcy5kZXNjZW5kKHRydWUpOwogIHRoaXMuZGlyZWN0aXZlcyh0cnVlKTsKCiAgdmFyIGlzTXVsdGlzZWxlY3QgPSBlbGVtZW50LmF0dHIoJ211bHRpcGxlJyksCiAgICAgIGV4cHJlc3Npb24gPSBlbGVtZW50LmF0dHIoJ25nOm9wdGlvbnMnKSwKICAgICAgb25DaGFuZ2UgPSBleHByZXNzaW9uQ29tcGlsZShlbGVtZW50LmF0dHIoJ25nOmNoYW5nZScpIHx8ICIiKS5mblNlbGYsCiAgICAgIG1hdGNoOwoKICBpZiAoIWV4cHJlc3Npb24pIHsKICAgIHJldHVybiBpbnB1dFdpZGdldFNlbGVjdG9yLmNhbGwodGhpcywgZWxlbWVudCk7CiAgfQogIGlmICghIChtYXRjaCA9IGV4cHJlc3Npb24ubWF0Y2goTkdfT1BUSU9OU19SRUdFWFApKSkgewogICAgdGhyb3cgRXJyb3IoCiAgICAgICJFeHBlY3RlZCBuZzpvcHRpb25zIGluIGZvcm0gb2YgJ19zZWxlY3RfIChhcyBfbGFiZWxfKT8gZm9yIChfa2V5XywpP192YWx1ZV8gaW4gX2NvbGxlY3Rpb25fJyIgKwogICAgICAiIGJ1dCBnb3QgJyIgKyBleHByZXNzaW9uICsgIicuIik7CiAgfQoKICB2YXIgZGlzcGxheUZuID0gZXhwcmVzc2lvbkNvbXBpbGUobWF0Y2hbMl0gfHwgbWF0Y2hbMV0pLmZuU2VsZiwKICAgICAgdmFsdWVOYW1lID0gbWF0Y2hbNF0gfHwgbWF0Y2hbNl0sCiAgICAgIGtleU5hbWUgPSBtYXRjaFs1XSwKICAgICAgZ3JvdXBCeUZuID0gZXhwcmVzc2lvbkNvbXBpbGUobWF0Y2hbM10gfHwgJycpLmZuU2VsZiwKICAgICAgdmFsdWVGbiA9IGV4cHJlc3Npb25Db21waWxlKG1hdGNoWzJdID8gbWF0Y2hbMV0gOiB2YWx1ZU5hbWUpLmZuU2VsZiwKICAgICAgdmFsdWVzRm4gPSBleHByZXNzaW9uQ29tcGlsZShtYXRjaFs3XSkuZm5TZWxmLAogICAgICAvLyB3ZSBjYW4ndCBqdXN0IGpxTGl0ZSgnPG9wdGlvbj4nKSBzaW5jZSBqcUxpdGUgaXMgbm90IHNtYXJ0IGVub3VnaAogICAgICAvLyB0byBjcmVhdGUgaXQgaW4gPHNlbGVjdD4gYW5kIElFIGJhcmZzIG90aGVyd2lzZS4KICAgICAgb3B0aW9uVGVtcGxhdGUgPSBqcUxpdGUoZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnb3B0aW9uJykpLAogICAgICBvcHRHcm91cFRlbXBsYXRlID0ganFMaXRlKGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ29wdGdyb3VwJykpLAogICAgICBudWxsT3B0aW9uID0gZmFsc2U7IC8vIGlmIGZhbHNlIHRoZW4gdXNlciB3aWxsIG5vdCBiZSBhYmxlIHRvIHNlbGVjdCBpdAoKICByZXR1cm4gZnVuY3Rpb24oc2VsZWN0RWxlbWVudCl7CgogICAgLy8gVGhpcyBpcyBhbiBhcnJheSBvZiBhcnJheSBvZiBleGlzdGluZyBvcHRpb24gZ3JvdXBzIGluIERPTS4gV2UgdHJ5IHRvIHJldXNlIHRoZXNlIGlmIHBvc3NpYmxlCiAgICAvLyBvcHRpb25Hcm91cHNDYWNoZVswXSBpcyB0aGUgb3B0aW9ucyB3aXRoIG5vIG9wdGlvbiBncm91cAogICAgLy8gb3B0aW9uR3JvdXBzQ2FjaGVbP11bMF0gaXMgdGhlIHBhcmVudDogZWl0aGVyIHRoZSBTRUxFQ1Qgb3IgT1BUR1JPVVAgZWxlbWVudAogICAgdmFyIG9wdGlvbkdyb3Vwc0NhY2hlID0gW1t7ZWxlbWVudDogc2VsZWN0RWxlbWVudCwgbGFiZWw6Jyd9XV0sCiAgICAgICAgc2NvcGUgPSB0aGlzLAogICAgICAgIG1vZGVsID0gbW9kZWxBY2Nlc3NvcihzY29wZSwgZWxlbWVudCk7CgogICAgLy8gZmluZCBleGlzdGluZyBzcGVjaWFsIG9wdGlvbnMKICAgIGZvckVhY2goc2VsZWN0RWxlbWVudC5jaGlsZHJlbigpLCBmdW5jdGlvbihvcHRpb24pewogICAgICBpZiAob3B0aW9uLnZhbHVlID09ICcnKQogICAgICAgIC8vIFVzZXIgaXMgYWxsb3dlZCB0byBzZWxlY3QgdGhlIG51bGwuCiAgICAgICAgbnVsbE9wdGlvbiA9IHtsYWJlbDpqcUxpdGUob3B0aW9uKS50ZXh0KCksIGlkOicnfTsKICAgIH0pOwogICAgc2VsZWN0RWxlbWVudC5odG1sKCcnKTsgLy8gY2xlYXIgY29udGVudHMKCiAgICBzZWxlY3RFbGVtZW50LmJpbmQoJ2NoYW5nZScsIGZ1bmN0aW9uKCl7CiAgICAgIHZhciBvcHRpb25Hcm91cCwKICAgICAgICAgIGNvbGxlY3Rpb24gPSB2YWx1ZXNGbihzY29wZSkgfHwgW10sCiAgICAgICAgICBrZXkgPSBzZWxlY3RFbGVtZW50LnZhbCgpLAogICAgICAgICAgdGVtcFNjb3BlID0gaW5oZXJpdChzY29wZSksCiAgICAgICAgICB2YWx1ZSwgb3B0aW9uRWxlbWVudCwgaW5kZXgsIGdyb3VwSW5kZXgsIGxlbmd0aCwgZ3JvdXBMZW5ndGg7CgogICAgICB0cnkgewogICAgICAgIGlmIChpc011bHRpc2VsZWN0KSB7CiAgICAgICAgICB2YWx1ZSA9IFtdOwogICAgICAgICAgZm9yIChncm91cEluZGV4ID0gMCwgZ3JvdXBMZW5ndGggPSBvcHRpb25Hcm91cHNDYWNoZS5sZW5ndGg7CiAgICAgICAgICAgICAgIGdyb3VwSW5kZXggPCBncm91cExlbmd0aDsKICAgICAgICAgICAgICAgZ3JvdXBJbmRleCsrKSB7CiAgICAgICAgICAgIC8vIGxpc3Qgb2Ygb3B0aW9ucyBmb3IgdGhhdCBncm91cC4gKGZpcnN0IGl0ZW0gaGFzIHRoZSBwYXJlbnQpCiAgICAgICAgICAgIG9wdGlvbkdyb3VwID0gb3B0aW9uR3JvdXBzQ2FjaGVbZ3JvdXBJbmRleF07CgogICAgICAgICAgICBmb3IoaW5kZXggPSAxLCBsZW5ndGggPSBvcHRpb25Hcm91cC5sZW5ndGg7IGluZGV4IDwgbGVuZ3RoOyBpbmRleCsrKSB7CiAgICAgICAgICAgICAgaWYgKChvcHRpb25FbGVtZW50ID0gb3B0aW9uR3JvdXBbaW5kZXhdLmVsZW1lbnQpWzBdLnNlbGVjdGVkKSB7CiAgICAgICAgICAgICAgICBpZiAoa2V5TmFtZSkgdGVtcFNjb3BlW2tleU5hbWVdID0ga2V5OwogICAgICAgICAgICAgICAgdGVtcFNjb3BlW3ZhbHVlTmFtZV0gPSBjb2xsZWN0aW9uW29wdGlvbkVsZW1lbnQudmFsKCldOwogICAgICAgICAgICAgICAgdmFsdWUucHVzaCh2YWx1ZUZuKHRlbXBTY29wZSkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZiAoa2V5ID09ICc/JykgewogICAgICAgICAgICB2YWx1ZSA9IHVuZGVmaW5lZDsKICAgICAgICAgIH0gZWxzZSBpZiAoa2V5ID09ICcnKXsKICAgICAgICAgICAgdmFsdWUgPSBudWxsOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGVtcFNjb3BlW3ZhbHVlTmFtZV0gPSBjb2xsZWN0aW9uW2tleV07CiAgICAgICAgICAgIGlmIChrZXlOYW1lKSB0ZW1wU2NvcGVba2V5TmFtZV0gPSBrZXk7CiAgICAgICAgICAgIHZhbHVlID0gdmFsdWVGbih0ZW1wU2NvcGUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoaXNEZWZpbmVkKHZhbHVlKSAmJiBtb2RlbC5nZXQoKSAhPT0gdmFsdWUpIHsKICAgICAgICAgIG9uQ2hhbmdlKHNjb3BlKTsKICAgICAgICAgIG1vZGVsLnNldCh2YWx1ZSk7CiAgICAgICAgfQogICAgICAgIHNjb3BlLiR0cnlFdmFsKGZ1bmN0aW9uKCl7CiAgICAgICAgICBzY29wZS4kcm9vdC4kZXZhbCgpOwogICAgICAgIH0pOwogICAgICB9IGZpbmFsbHkgewogICAgICAgIHRlbXBTY29wZSA9IG51bGw7IC8vIFRPRE8obWlza28pOiBuZWVkcyB0byBiZSAkZGVzdHJveQogICAgICB9CiAgICB9KTsKCiAgICBzY29wZS4kb25FdmFsKGZ1bmN0aW9uKCl7CiAgICAgIHZhciBzY29wZSA9IHRoaXMsCiAgICAgICAgICBvcHRpb25Hcm91cHMgPSB7Jyc6W119LCAvLyBUZW1wb3JhcnkgbG9jYXRpb24gZm9yIHRoZSBvcHRpb24gZ3JvdXBzIGJlZm9yZSB3ZSByZW5kZXIgdGhlbQogICAgICAgICAgb3B0aW9uR3JvdXBOYW1lcyA9IFsnJ10sCiAgICAgICAgICBvcHRpb25Hcm91cE5hbWUsCiAgICAgICAgICBvcHRpb25Hcm91cCwKICAgICAgICAgIG9wdGlvbiwKICAgICAgICAgIGV4aXN0aW5nUGFyZW50LCBleGlzdGluZ09wdGlvbnMsIGV4aXN0aW5nT3B0aW9uLAogICAgICAgICAgdmFsdWVzID0gdmFsdWVzRm4oc2NvcGUpIHx8IFtdLAogICAgICAgICAga2V5cyA9IHZhbHVlcywKICAgICAgICAgIGtleSwKICAgICAgICAgIGdyb3VwTGVuZ3RoLCBsZW5ndGgsCiAgICAgICAgICBmcmFnbWVudCwKICAgICAgICAgIGdyb3VwSW5kZXgsIGluZGV4LAogICAgICAgICAgb3B0aW9uRWxlbWVudCwKICAgICAgICAgIG9wdGlvblNjb3BlID0gaW5oZXJpdChzY29wZSksCiAgICAgICAgICBtb2RlbFZhbHVlID0gbW9kZWwuZ2V0KCksCiAgICAgICAgICBzZWxlY3RlZCwKICAgICAgICAgIHNlbGVjdGVkU2V0ID0gZmFsc2UsIC8vIG5vdGhpbmcgaXMgc2VsZWN0ZWQgeWV0CiAgICAgICAgICBpc011bHRpID0gaXNNdWx0aXNlbGVjdCwKICAgICAgICAgIGxhc3RFbGVtZW50LAogICAgICAgICAgZWxlbWVudDsKCiAgICAgIHRyeSB7CiAgICAgICAgaWYgKGlzTXVsdGkpIHsKICAgICAgICAgIHNlbGVjdGVkU2V0ID0gbmV3IEhhc2hNYXAoKTsKICAgICAgICAgIGlmIChtb2RlbFZhbHVlICYmIGlzTnVtYmVyKGxlbmd0aCA9IG1vZGVsVmFsdWUubGVuZ3RoKSkgewogICAgICAgICAgICBmb3IgKGluZGV4ID0gMDsgaW5kZXggPCBsZW5ndGg7IGluZGV4KyspIHsKICAgICAgICAgICAgICBzZWxlY3RlZFNldC5wdXQobW9kZWxWYWx1ZVtpbmRleF0sIHRydWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmIChtb2RlbFZhbHVlID09PSBudWxsIHx8IG51bGxPcHRpb24pIHsKICAgICAgICAgIC8vIGlmIHdlIGFyZSBub3QgbXVsdGlzZWxlY3QsIGFuZCB3ZSBhcmUgbnVsbCB0aGVuIHdlIGhhdmUgdG8gYWRkIHRoZSBudWxsT3B0aW9uCiAgICAgICAgICBvcHRpb25Hcm91cHNbJyddLnB1c2goZXh0ZW5kKHtzZWxlY3RlZDptb2RlbFZhbHVlID09PSBudWxsLCBpZDonJywgbGFiZWw6Jyd9LCBudWxsT3B0aW9uKSk7CiAgICAgICAgICBzZWxlY3RlZFNldCA9IHRydWU7CiAgICAgICAgfQoKICAgICAgICAvLyBJZiB3ZSBoYXZlIGEga2V5TmFtZSB0aGVuIHdlIGFyZSBpdGVyYXRpbmcgb3ZlciBvbiBvYmplY3QuIEdyYWIgdGhlIGtleXMgYW5kIHNvcnQgdGhlbS4KICAgICAgICBpZihrZXlOYW1lKSB7CiAgICAgICAgICBrZXlzID0gW107CiAgICAgICAgICBmb3IgKGtleSBpbiB2YWx1ZXMpIHsKICAgICAgICAgICAgaWYgKHZhbHVlcy5oYXNPd25Qcm9wZXJ0eShrZXkpKQogICAgICAgICAgICAgIGtleXMucHVzaChrZXkpOwogICAgICAgICAgfQogICAgICAgICAga2V5cy5zb3J0KCk7CiAgICAgICAgfQoKICAgICAgICAvLyBXZSBub3cgYnVpbGQgdXAgdGhlIGxpc3Qgb2Ygb3B0aW9ucyB3ZSBuZWVkICh3ZSBtZXJnZSBsYXRlcikKICAgICAgICBmb3IgKGluZGV4ID0gMDsgbGVuZ3RoID0ga2V5cy5sZW5ndGgsIGluZGV4IDwgbGVuZ3RoOyBpbmRleCsrKSB7CiAgICAgICAgICBvcHRpb25TY29wZVt2YWx1ZU5hbWVdID0gdmFsdWVzW2tleU5hbWUgPyBvcHRpb25TY29wZVtrZXlOYW1lXT1rZXlzW2luZGV4XTppbmRleF07CiAgICAgICAgICBvcHRpb25Hcm91cE5hbWUgPSBncm91cEJ5Rm4ob3B0aW9uU2NvcGUpIHx8ICcnOwogICAgICAgICAgaWYgKCEob3B0aW9uR3JvdXAgPSBvcHRpb25Hcm91cHNbb3B0aW9uR3JvdXBOYW1lXSkpIHsKICAgICAgICAgICAgb3B0aW9uR3JvdXAgPSBvcHRpb25Hcm91cHNbb3B0aW9uR3JvdXBOYW1lXSA9IFtdOwogICAgICAgICAgICBvcHRpb25Hcm91cE5hbWVzLnB1c2gob3B0aW9uR3JvdXBOYW1lKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChpc011bHRpKSB7CiAgICAgICAgICAgIHNlbGVjdGVkID0gISFzZWxlY3RlZFNldC5yZW1vdmUodmFsdWVGbihvcHRpb25TY29wZSkpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc2VsZWN0ZWQgPSBtb2RlbFZhbHVlID09PSB2YWx1ZUZuKG9wdGlvblNjb3BlKTsKICAgICAgICAgICAgc2VsZWN0ZWRTZXQgPSBzZWxlY3RlZFNldCB8fCBzZWxlY3RlZDsgLy8gc2VlIGlmIGF0IGxlYXN0IG9uZSBpdGVtIGlzIHNlbGVjdGVkCiAgICAgICAgICB9CiAgICAgICAgICBvcHRpb25Hcm91cC5wdXNoKHsKICAgICAgICAgICAgICBpZDoga2V5TmFtZSA/IGtleXNbaW5kZXhdIDogaW5kZXgsICAgLy8gZWl0aGVyIHRoZSBpbmRleCBpbnRvIGFycmF5IG9yIGtleSBmcm9tIG9iamVjdAogICAgICAgICAgICAgIGxhYmVsOiBkaXNwbGF5Rm4ob3B0aW9uU2NvcGUpIHx8ICcnLCAvLyB3aGF0IHdpbGwgYmUgc2VlbiBieSB0aGUgdXNlcgogICAgICAgICAgICAgIHNlbGVjdGVkOiBzZWxlY3RlZCAgICAgICAgICAgICAgICAgICAvLyBkZXRlcm1pbmUgaWYgd2Ugc2hvdWxkIGJlIHNlbGVjdGVkCiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBvcHRpb25Hcm91cE5hbWVzLnNvcnQoKTsKICAgICAgICBpZiAoIWlzTXVsdGkgJiYgIXNlbGVjdGVkU2V0KSB7CiAgICAgICAgICAvLyBub3RoaW5nIHdhcyBzZWxlY3RlZCwgd2UgaGF2ZSB0byBpbnNlcnQgdGhlIHVuZGVmaW5lZCBpdGVtCiAgICAgICAgICBvcHRpb25Hcm91cHNbJyddLnVuc2hpZnQoe2lkOic/JywgbGFiZWw6JycsIHNlbGVjdGVkOnRydWV9KTsKICAgICAgICB9CgogICAgICAgIC8vIE5vdyB3ZSBuZWVkIHRvIHVwZGF0ZSB0aGUgbGlzdCBvZiBET00gbm9kZXMgdG8gbWF0Y2ggdGhlIG9wdGlvbkdyb3VwcyB3ZSBjb21wdXRlZCBhYm92ZQogICAgICAgIGZvciAoZ3JvdXBJbmRleCA9IDAsIGdyb3VwTGVuZ3RoID0gb3B0aW9uR3JvdXBOYW1lcy5sZW5ndGg7CiAgICAgICAgICAgICBncm91cEluZGV4IDwgZ3JvdXBMZW5ndGg7CiAgICAgICAgICAgICBncm91cEluZGV4KyspIHsKICAgICAgICAgIC8vIGN1cnJlbnQgb3B0aW9uIGdyb3VwIG5hbWUgb3IgJycgaWYgbm8gZ3JvdXAKICAgICAgICAgIG9wdGlvbkdyb3VwTmFtZSA9IG9wdGlvbkdyb3VwTmFtZXNbZ3JvdXBJbmRleF07CgogICAgICAgICAgLy8gbGlzdCBvZiBvcHRpb25zIGZvciB0aGF0IGdyb3VwLiAoZmlyc3QgaXRlbSBoYXMgdGhlIHBhcmVudCkKICAgICAgICAgIG9wdGlvbkdyb3VwID0gb3B0aW9uR3JvdXBzW29wdGlvbkdyb3VwTmFtZV07CgogICAgICAgICAgaWYgKG9wdGlvbkdyb3Vwc0NhY2hlLmxlbmd0aCA8PSBncm91cEluZGV4KSB7CiAgICAgICAgICAgIC8vIHdlIG5lZWQgdG8gZ3JvdyB0aGUgb3B0aW9uR3JvdXBzCiAgICAgICAgICAgIG9wdGlvbkdyb3Vwc0NhY2hlLnB1c2goCiAgICAgICAgICAgICAgICBleGlzdGluZ09wdGlvbnMgPSBbCiAgICAgICAgICAgICAgICAgIGV4aXN0aW5nUGFyZW50ID0gewogICAgICAgICAgICAgICAgICAgICAgZWxlbWVudDogb3B0R3JvdXBUZW1wbGF0ZS5jbG9uZSgpLmF0dHIoJ2xhYmVsJywgb3B0aW9uR3JvdXBOYW1lKSwKICAgICAgICAgICAgICAgICAgICAgIGxhYmVsOiBvcHRpb25Hcm91cC5sYWJlbAogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIF0KICAgICAgICAgICAgKTsKICAgICAgICAgICAgc2VsZWN0RWxlbWVudC5hcHBlbmQoZXhpc3RpbmdQYXJlbnQuZWxlbWVudCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBleGlzdGluZ09wdGlvbnMgPSBvcHRpb25Hcm91cHNDYWNoZVtncm91cEluZGV4XTsKICAgICAgICAgICAgZXhpc3RpbmdQYXJlbnQgPSBleGlzdGluZ09wdGlvbnNbMF07ICAvLyBlaXRoZXIgU0VMRUNUIChubyBncm91cCkgb3IgT1BUR1JPVVAgZWxlbWVudAoKICAgICAgICAgICAgLy8gdXBkYXRlIHRoZSBPUFRHUk9VUCBsYWJlbCBpZiBub3QgdGhlIHNhbWUuCiAgICAgICAgICAgIGlmIChleGlzdGluZ1BhcmVudC5sYWJlbCAhPSBvcHRpb25Hcm91cE5hbWUpIHsKICAgICAgICAgICAgICBleGlzdGluZ1BhcmVudC5lbGVtZW50LmF0dHIoJ2xhYmVsJywgZXhpc3RpbmdQYXJlbnQubGFiZWwgPSBvcHRpb25Hcm91cE5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgbGFzdEVsZW1lbnQgPSBudWxsOyAgLy8gc3RhcnQgYXQgdGhlIGJlZ2luaW5nCiAgICAgICAgICBmb3IoaW5kZXggPSAwLCBsZW5ndGggPSBvcHRpb25Hcm91cC5sZW5ndGg7IGluZGV4IDwgbGVuZ3RoOyBpbmRleCsrKSB7CiAgICAgICAgICAgIG9wdGlvbiA9IG9wdGlvbkdyb3VwW2luZGV4XTsKICAgICAgICAgICAgaWYgKGV4aXN0aW5nT3B0aW9uID0gZXhpc3RpbmdPcHRpb25zW2luZGV4KzFdKSB7CiAgICAgICAgICAgICAgLy8gcmV1c2UgZWxlbWVudHMKICAgICAgICAgICAgICBsYXN0RWxlbWVudCA9IGV4aXN0aW5nT3B0aW9uLmVsZW1lbnQ7CiAgICAgICAgICAgICAgaWYgKGV4aXN0aW5nT3B0aW9uLmxhYmVsICE9PSBvcHRpb24ubGFiZWwpIHsKICAgICAgICAgICAgICAgIGxhc3RFbGVtZW50LnRleHQoZXhpc3RpbmdPcHRpb24ubGFiZWwgPSBvcHRpb24ubGFiZWwpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoZXhpc3RpbmdPcHRpb24uaWQgIT09IG9wdGlvbi5pZCkgewogICAgICAgICAgICAgICAgbGFzdEVsZW1lbnQudmFsKGV4aXN0aW5nT3B0aW9uLmlkID0gb3B0aW9uLmlkKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGV4aXN0aW5nT3B0aW9uLnNlbGVjdGVkICE9PSBvcHRpb24uc2VsZWN0ZWQpIHsKICAgICAgICAgICAgICAgIGxhc3RFbGVtZW50LmF0dHIoJ3NlbGVjdGVkJywgb3B0aW9uLnNlbGVjdGVkKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgLy8gZ3JvdyBlbGVtZW50cwogICAgICAgICAgICAgIC8vIGpRdWVyeSh2MS40LjIpIEJ1ZzogV2Ugc2hvdWxkIGJlIGFibGUgdG8gY2hhaW4gdGhlIG1ldGhvZCBjYWxscywgYnV0CiAgICAgICAgICAgICAgLy8gaW4gdGhpcyB2ZXJzaW9uIG9mIGpRdWVyeSBvbiBzb21lIGJyb3dzZXIgdGhlIC50ZXh0KCkgcmV0dXJucyBhIHN0cmluZwogICAgICAgICAgICAgIC8vIHJhdGhlciB0aGVuIHRoZSBlbGVtZW50LgogICAgICAgICAgICAgIChlbGVtZW50ID0gb3B0aW9uVGVtcGxhdGUuY2xvbmUoKSkKICAgICAgICAgICAgICAgIC52YWwob3B0aW9uLmlkKQogICAgICAgICAgICAgICAgLmF0dHIoJ3NlbGVjdGVkJywgb3B0aW9uLnNlbGVjdGVkKQogICAgICAgICAgICAgICAgLnRleHQob3B0aW9uLmxhYmVsKTsKICAgICAgICAgICAgICBleGlzdGluZ09wdGlvbnMucHVzaChleGlzdGluZ09wdGlvbiA9IHsKICAgICAgICAgICAgICAgIGVsZW1lbnQ6IGVsZW1lbnQsCiAgICAgICAgICAgICAgICBsYWJlbDogb3B0aW9uLmxhYmVsLAogICAgICAgICAgICAgICAgaWQ6IG9wdGlvbi5pZCwKICAgICAgICAgICAgICAgIGNoZWNrZWQ6IG9wdGlvbi5zZWxlY3RlZAogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIGlmIChsYXN0RWxlbWVudCkgewogICAgICAgICAgICAgICAgbGFzdEVsZW1lbnQuYWZ0ZXIoZWxlbWVudCk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGV4aXN0aW5nUGFyZW50LmVsZW1lbnQuYXBwZW5kKGVsZW1lbnQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBsYXN0RWxlbWVudCA9IGVsZW1lbnQ7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIC8vIHJlbW92ZSBhbnkgZXhjZXNzaXZlIE9QVElPTnMgaW4gYSBncm91cAogICAgICAgICAgaW5kZXgrKzsgLy8gaW5jcmVtZW50IHNpbmNlIHRoZSBleGlzdGluZ09wdGlvbnNbMF0gaXMgcGFyZW50IGVsZW1lbnQgbm90IE9QVElPTgogICAgICAgICAgd2hpbGUoZXhpc3RpbmdPcHRpb25zLmxlbmd0aCA+IGluZGV4KSB7CiAgICAgICAgICAgIGV4aXN0aW5nT3B0aW9ucy5wb3AoKS5lbGVtZW50LnJlbW92ZSgpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAvLyByZW1vdmUgYW55IGV4Y2Vzc2l2ZSBPUFRHUk9VUHMgZnJvbSBzZWxlY3QKICAgICAgICB3aGlsZShvcHRpb25Hcm91cHNDYWNoZS5sZW5ndGggPiBncm91cEluZGV4KSB7CiAgICAgICAgICBvcHRpb25Hcm91cHNDYWNoZS5wb3AoKVswXS5lbGVtZW50LnJlbW92ZSgpOwogICAgICAgIH0KICAgICAgfSBmaW5hbGx5IHsKICAgICAgICBvcHRpb25TY29wZSA9IG51bGw7IC8vIFRPRE8obWlza28pOiBuZWVkcyB0byBiZSAkZGVzdHJveSgpCiAgICAgIH0KICAgIH0pOwogIH07Cn0pOwoKCi8qKgogKiBAd29ya0luUHJvZ3Jlc3MKICogQG5nZG9jIHdpZGdldAogKiBAbmFtZSBhbmd1bGFyLndpZGdldC5uZzppbmNsdWRlCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBGZXRjaGVzLCBjb21waWxlcyBhbmQgaW5jbHVkZXMgYW4gZXh0ZXJuYWwgSFRNTCBmcmFnbWVudC4KICoKICogS2VlcCBpbiBtaW5kIHRoYXQgU2FtZSBPcmlnaW4gUG9saWN5IGFwcGxpZXMgdG8gaW5jbHVkZWQgcmVzb3VyY2VzCiAqIChlLmcuIG5nOmluY2x1ZGUgd29uJ3Qgd29yayBmb3IgZmlsZTovLyBhY2Nlc3MpLgogKgogKiBAcGFyYW0ge3N0cmluZ30gc3JjIGFuZ3VsYXIgZXhwcmVzc2lvbiBldmFsdWF0aW5nIHRvIFVSTC4gSWYgdGhlIHNvdXJjZSBpcyBhIHN0cmluZyBjb25zdGFudCwKICogICAgICAgICAgICAgICAgIG1ha2Ugc3VyZSB5b3Ugd3JhcCBpdCBpbiBxdW90ZXMsIGUuZy4gYHNyYz0iJ215UGFydGlhbFRlbXBsYXRlLmh0bWwnImAuCiAqIEBwYXJhbSB7U2NvcGU9fSBbc2NvcGU9bmV3X2NoaWxkX3Njb3BlXSBvcHRpb25hbCBleHByZXNzaW9uIHdoaWNoIGV2YWx1YXRlcyB0byBhbgogKiAgICAgICAgICAgICAgICAgaW5zdGFuY2Ugb2YgYW5ndWxhci5zY29wZSB0byBzZXQgdGhlIEhUTUwgZnJhZ21lbnQgdG8uCiAqIEBwYXJhbSB7c3RyaW5nPX0gb25sb2FkIEV4cHJlc3Npb24gdG8gZXZhbHVhdGUgd2hlbiBhIG5ldyBwYXJ0aWFsIGlzIGxvYWRlZC4KICoKICogQGV4YW1wbGUKICAgIDxkb2M6ZXhhbXBsZT4KICAgICAgPGRvYzpzb3VyY2UganNmaWRkbGU9ImZhbHNlIj4KICAgICAgIDxzZWxlY3QgbmFtZT0idXJsIj4KICAgICAgICA8b3B0aW9uIHZhbHVlPSJleGFtcGxlcy9uZy1pbmNsdWRlL3RlbXBsYXRlMS5odG1sIj50ZW1wbGF0ZTEuaHRtbDwvb3B0aW9uPgogICAgICAgIDxvcHRpb24gdmFsdWU9ImV4YW1wbGVzL25nLWluY2x1ZGUvdGVtcGxhdGUyLmh0bWwiPnRlbXBsYXRlMi5odG1sPC9vcHRpb24+CiAgICAgICAgPG9wdGlvbiB2YWx1ZT0iIj4oYmxhbmspPC9vcHRpb24+CiAgICAgICA8L3NlbGVjdD4KICAgICAgIHVybCBvZiB0aGUgdGVtcGxhdGU6IDx0dD48YSBocmVmPSJ7e3VybH19Ij57e3VybH19PC9hPjwvdHQ+CiAgICAgICA8aHIvPgogICAgICAgPG5nOmluY2x1ZGUgc3JjPSJ1cmwiPjwvbmc6aW5jbHVkZT4KICAgICAgPC9kb2M6c291cmNlPgogICAgICA8ZG9jOnNjZW5hcmlvPgogICAgICAgIGl0KCdzaG91bGQgbG9hZCB0ZW1wbGF0ZTEuaHRtbCcsIGZ1bmN0aW9uKCl7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBuZ1xcOmluY2x1ZGUnKS50ZXh0KCkpLgogICAgICAgICAgIHRvQmUoJ0NvbnRlbnQgb2YgdGVtcGxhdGUxLmh0bWxcbicpOwogICAgICAgIH0pOwogICAgICAgIGl0KCdzaG91bGQgbG9hZCB0ZW1wbGF0ZTIuaHRtbCcsIGZ1bmN0aW9uKCl7CiAgICAgICAgIHNlbGVjdCgndXJsJykub3B0aW9uKCdleGFtcGxlcy9uZy1pbmNsdWRlL3RlbXBsYXRlMi5odG1sJyk7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBuZ1xcOmluY2x1ZGUnKS50ZXh0KCkpLgogICAgICAgICAgIHRvQmUoJ0NvbnRlbnQgb2YgdGVtcGxhdGUyLmh0bWxcbicpOwogICAgICAgIH0pOwogICAgICAgIGl0KCdzaG91bGQgY2hhbmdlIHRvIGJsYW5rJywgZnVuY3Rpb24oKXsKICAgICAgICAgc2VsZWN0KCd1cmwnKS5vcHRpb24oJycpOwogICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgbmdcXDppbmNsdWRlJykudGV4dCgpKS50b0VxdWFsKCcnKTsKICAgICAgICB9KTsKICAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICA8L2RvYzpleGFtcGxlPgogKi8KYW5ndWxhcldpZGdldCgnbmc6aW5jbHVkZScsIGZ1bmN0aW9uKGVsZW1lbnQpewogIHZhciBjb21waWxlciA9IHRoaXMsCiAgICAgIHNyY0V4cCA9IGVsZW1lbnQuYXR0cigic3JjIiksCiAgICAgIHNjb3BlRXhwID0gZWxlbWVudC5hdHRyKCJzY29wZSIpIHx8ICcnLAogICAgICBvbmxvYWRFeHAgPSBlbGVtZW50WzBdLmdldEF0dHJpYnV0ZSgnb25sb2FkJykgfHwgJyc7IC8vd29ya2Fyb3VuZCBmb3IganF1ZXJ5IGJ1ZyAjNzUzNwogIGlmIChlbGVtZW50WzBdWyduZzpjb21waWxlZCddKSB7CiAgICB0aGlzLmRlc2NlbmQodHJ1ZSk7CiAgICB0aGlzLmRpcmVjdGl2ZXModHJ1ZSk7CiAgfSBlbHNlIHsKICAgIGVsZW1lbnRbMF1bJ25nOmNvbXBpbGVkJ10gPSB0cnVlOwogICAgcmV0dXJuIGV4dGVuZChmdW5jdGlvbih4aHIsIGVsZW1lbnQpewogICAgICB2YXIgc2NvcGUgPSB0aGlzLCBjaGlsZFNjb3BlOwogICAgICB2YXIgY2hhbmdlQ291bnRlciA9IDA7CiAgICAgIHZhciBwcmV2ZW50UmVjdXJzaW9uID0gZmFsc2U7CiAgICAgIGZ1bmN0aW9uIGluY3JlbWVudENoYW5nZSgpeyBjaGFuZ2VDb3VudGVyKys7fQogICAgICB0aGlzLiR3YXRjaChzcmNFeHAsIGluY3JlbWVudENoYW5nZSk7CiAgICAgIHRoaXMuJHdhdGNoKHNjb3BlRXhwLCBpbmNyZW1lbnRDaGFuZ2UpOwoKICAgICAgLy8gbm90ZSB0aGF0IHRoaXMgcHJvcGFnYXRlcyBldmFsIHRvIHRoZSBjdXJyZW50IGNoaWxkU2NvcGUsIHdoZXJlIGNoaWxkU2NvcGUgaXMgZHluYW1pY2FsbHkKICAgICAgLy8gYm91bmQgKHZpYSAkcm91dGUub25DaGFuZ2UgY2FsbGJhY2spIHRvIHRoZSBjdXJyZW50IHNjb3BlIGNyZWF0ZWQgYnkgJHJvdXRlCiAgICAgIHNjb3BlLiRvbkV2YWwoZnVuY3Rpb24oKXsKICAgICAgICBpZiAoY2hpbGRTY29wZSAmJiAhcHJldmVudFJlY3Vyc2lvbikgewogICAgICAgICAgcHJldmVudFJlY3Vyc2lvbiA9IHRydWU7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBjaGlsZFNjb3BlLiRldmFsKCk7CiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICBwcmV2ZW50UmVjdXJzaW9uID0gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgICAgdGhpcy4kd2F0Y2goZnVuY3Rpb24oKXtyZXR1cm4gY2hhbmdlQ291bnRlcjt9LCBmdW5jdGlvbigpewogICAgICAgIHZhciBzcmMgPSB0aGlzLiRldmFsKHNyY0V4cCksCiAgICAgICAgICAgIHVzZVNjb3BlID0gdGhpcy4kZXZhbChzY29wZUV4cCk7CgogICAgICAgIGlmIChzcmMpIHsKICAgICAgICAgIHhocignR0VUJywgc3JjLCBudWxsLCBmdW5jdGlvbihjb2RlLCByZXNwb25zZSl7CiAgICAgICAgICAgIGVsZW1lbnQuaHRtbChyZXNwb25zZSk7CiAgICAgICAgICAgIGNoaWxkU2NvcGUgPSB1c2VTY29wZSB8fCBjcmVhdGVTY29wZShzY29wZSk7CiAgICAgICAgICAgIGNvbXBpbGVyLmNvbXBpbGUoZWxlbWVudCkoY2hpbGRTY29wZSk7CiAgICAgICAgICAgIHNjb3BlLiRldmFsKG9ubG9hZEV4cCk7CiAgICAgICAgICB9LCBmYWxzZSwgdHJ1ZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGNoaWxkU2NvcGUgPSBudWxsOwogICAgICAgICAgZWxlbWVudC5odG1sKCcnKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSwgeyRpbmplY3Q6WyckeGhyLmNhY2hlJ119KTsKICB9Cn0pOwoKLyoqCiAqIEB3b3JrSW5Qcm9ncmVzcwogKiBAbmdkb2Mgd2lkZ2V0CiAqIEBuYW1lIGFuZ3VsYXIud2lkZ2V0Lm5nOnN3aXRjaAogKgogKiBAZGVzY3JpcHRpb24KICogQ29uZGl0aW9uYWxseSBjaGFuZ2UgdGhlIERPTSBzdHJ1Y3R1cmUuCiAqCiAqIEB1c2FnZUNvbnRlbnQKICogPGFueSBuZzpzd2l0Y2gtd2hlbj0ibWF0Y2hWYWx1ZTEiPi4uLjwvYW55PgogKiAgIDxhbnkgbmc6c3dpdGNoLXdoZW49Im1hdGNoVmFsdWUyIj4uLi48L2FueT4KICogICAuLi4KICogICA8YW55IG5nOnN3aXRjaC1kZWZhdWx0Pi4uLjwvYW55PgogKgogKiBAcGFyYW0geyp9IG9uIGV4cHJlc3Npb24gdG8gbWF0Y2ggYWdhaW5zdCA8dHQ+bmc6c3dpdGNoLXdoZW48L3R0Pi4KICogQHBhcmFtRGVzY3JpcHRpb24KICogT24gY2hpbGQgZWxtZW50cyBhZGQ6CiAqCiAqICogYG5nOnN3aXRjaC13aGVuYDogdGhlIGNhc2Ugc3RhdGVtZW50IHRvIG1hdGNoIGFnYWluc3QuIElmIG1hdGNoIHRoZW4gdGhpcwogKiAgIGNhc2Ugd2lsbCBiZSBkaXNwbGF5ZWQuCiAqICogYG5nOnN3aXRjaC1kZWZhdWx0YDogdGhlIGRlZmF1bHQgY2FzZSB3aGVuIG5vIG90aGVyIGNhc3NlcyBtYXRjaC4KICoKICogQGV4YW1wbGUKICAgIDxkb2M6ZXhhbXBsZT4KICAgICAgPGRvYzpzb3VyY2U+CiAgICAgICAgPHNlbGVjdCBuYW1lPSJzd2l0Y2giPgogICAgICAgICAgPG9wdGlvbj5zZXR0aW5nczwvb3B0aW9uPgogICAgICAgICAgPG9wdGlvbj5ob21lPC9vcHRpb24+CiAgICAgICAgICA8b3B0aW9uPm90aGVyPC9vcHRpb24+CiAgICAgICAgPC9zZWxlY3Q+CiAgICAgICAgPHR0PnN3aXRjaD17e3N3aXRjaH19PC90dD4KICAgICAgICA8L2hyPgogICAgICAgIDxuZzpzd2l0Y2ggb249InN3aXRjaCIgPgogICAgICAgICAgPGRpdiBuZzpzd2l0Y2gtd2hlbj0ic2V0dGluZ3MiPlNldHRpbmdzIERpdjwvZGl2PgogICAgICAgICAgPHNwYW4gbmc6c3dpdGNoLXdoZW49ImhvbWUiPkhvbWUgU3Bhbjwvc3Bhbj4KICAgICAgICAgIDxzcGFuIG5nOnN3aXRjaC1kZWZhdWx0PmRlZmF1bHQ8L3NwYW4+CiAgICAgICAgPC9uZzpzd2l0Y2g+CiAgICAgICAgPC9jb2RlPgogICAgICA8L2RvYzpzb3VyY2U+CiAgICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgICAgaXQoJ3Nob3VsZCBzdGFydCBpbiBzZXR0aW5ncycsIGZ1bmN0aW9uKCl7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBuZ1xcOnN3aXRjaCcpLnRleHQoKSkudG9FcXVhbCgnU2V0dGluZ3MgRGl2Jyk7CiAgICAgICAgfSk7CiAgICAgICAgaXQoJ3Nob3VsZCBjaGFuZ2UgdG8gaG9tZScsIGZ1bmN0aW9uKCl7CiAgICAgICAgIHNlbGVjdCgnc3dpdGNoJykub3B0aW9uKCdob21lJyk7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBuZ1xcOnN3aXRjaCcpLnRleHQoKSkudG9FcXVhbCgnSG9tZSBTcGFuJyk7CiAgICAgICAgfSk7CiAgICAgICAgaXQoJ3Nob3VsZCBzZWxlY3QgZGVhZmF1bHQnLCBmdW5jdGlvbigpewogICAgICAgICBzZWxlY3QoJ3N3aXRjaCcpLm9wdGlvbignb3RoZXInKTsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIG5nXFw6c3dpdGNoJykudGV4dCgpKS50b0VxdWFsKCdkZWZhdWx0Jyk7CiAgICAgICAgfSk7CiAgICAgIDwvZG9jOnNjZW5hcmlvPgogICAgPC9kb2M6ZXhhbXBsZT4KICovCi8vVE9ETyhpbSk6IHJlbW92ZSBhbGwgdGhlIGNvZGUgcmVsYXRlZCB0byB1c2luZyBhbmQgaW5saW5lIGVxdWFscwp2YXIgbmdTd2l0Y2ggPSBhbmd1bGFyV2lkZ2V0KCduZzpzd2l0Y2gnLCBmdW5jdGlvbiAoZWxlbWVudCl7CiAgdmFyIGNvbXBpbGVyID0gdGhpcywKICAgICAgd2F0Y2hFeHByID0gZWxlbWVudC5hdHRyKCJvbiIpLAogICAgICB1c2luZ0V4cHIgPSAoZWxlbWVudC5hdHRyKCJ1c2luZyIpIHx8ICdlcXVhbHMnKSwKICAgICAgdXNpbmdFeHByUGFyYW1zID0gdXNpbmdFeHByLnNwbGl0KCI6IiksCiAgICAgIHVzaW5nRm4gPSBuZ1N3aXRjaFt1c2luZ0V4cHJQYXJhbXMuc2hpZnQoKV0sCiAgICAgIGNoYW5nZUV4cHIgPSBlbGVtZW50LmF0dHIoJ2NoYW5nZScpIHx8ICcnLAogICAgICBjYXNlcyA9IFtdOwogIGlmICghdXNpbmdGbikgdGhyb3cgIlVzaW5nIGV4cHJlc3Npb24gJyIgKyB1c2luZ0V4cHIgKyAiJyB1bmtub3duLiI7CiAgaWYgKCF3YXRjaEV4cHIpIHRocm93ICJNaXNzaW5nICdvbicgYXR0cmlidXRlLiI7CiAgZWFjaE5vZGUoZWxlbWVudCwgZnVuY3Rpb24oY2FzZUVsZW1lbnQpewogICAgdmFyIHdoZW4gPSBjYXNlRWxlbWVudC5hdHRyKCduZzpzd2l0Y2gtd2hlbicpOwogICAgdmFyIHN3aXRjaENhc2UgPSB7CiAgICAgICAgY2hhbmdlOiBjaGFuZ2VFeHByLAogICAgICAgIGVsZW1lbnQ6IGNhc2VFbGVtZW50LAogICAgICAgIHRlbXBsYXRlOiBjb21waWxlci5jb21waWxlKGNhc2VFbGVtZW50KQogICAgICB9OwogICAgaWYgKGlzU3RyaW5nKHdoZW4pKSB7CiAgICAgIHN3aXRjaENhc2Uud2hlbiA9IGZ1bmN0aW9uKHNjb3BlLCB2YWx1ZSl7CiAgICAgICAgdmFyIGFyZ3MgPSBbdmFsdWUsIHdoZW5dOwogICAgICAgIGZvckVhY2godXNpbmdFeHByUGFyYW1zLCBmdW5jdGlvbihhcmcpewogICAgICAgICAgYXJncy5wdXNoKGFyZyk7CiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIHVzaW5nRm4uYXBwbHkoc2NvcGUsIGFyZ3MpOwogICAgICB9OwogICAgICBjYXNlcy51bnNoaWZ0KHN3aXRjaENhc2UpOwogICAgfSBlbHNlIGlmIChpc1N0cmluZyhjYXNlRWxlbWVudC5hdHRyKCduZzpzd2l0Y2gtZGVmYXVsdCcpKSkgewogICAgICBzd2l0Y2hDYXNlLndoZW4gPSB2YWx1ZUZuKHRydWUpOwogICAgICBjYXNlcy5wdXNoKHN3aXRjaENhc2UpOwogICAgfQogIH0pOwoKICAvLyB0aGlzIG5lZWRzIHRvIGJlIGhlcmUgZm9yIElFCiAgZm9yRWFjaChjYXNlcywgZnVuY3Rpb24oX2Nhc2UpewogICAgX2Nhc2UuZWxlbWVudC5yZW1vdmUoKTsKICB9KTsKCiAgZWxlbWVudC5odG1sKCcnKTsKICByZXR1cm4gZnVuY3Rpb24oZWxlbWVudCl7CiAgICB2YXIgc2NvcGUgPSB0aGlzLCBjaGlsZFNjb3BlOwogICAgdGhpcy4kd2F0Y2god2F0Y2hFeHByLCBmdW5jdGlvbih2YWx1ZSl7CiAgICAgIHZhciBmb3VuZCA9IGZhbHNlOwogICAgICBlbGVtZW50Lmh0bWwoJycpOwogICAgICBjaGlsZFNjb3BlID0gY3JlYXRlU2NvcGUoc2NvcGUpOwogICAgICBmb3JFYWNoKGNhc2VzLCBmdW5jdGlvbihzd2l0Y2hDYXNlKXsKICAgICAgICBpZiAoIWZvdW5kICYmIHN3aXRjaENhc2Uud2hlbihjaGlsZFNjb3BlLCB2YWx1ZSkpIHsKICAgICAgICAgIGZvdW5kID0gdHJ1ZTsKICAgICAgICAgIGNoaWxkU2NvcGUuJHRyeUV2YWwoc3dpdGNoQ2FzZS5jaGFuZ2UsIGVsZW1lbnQpOwogICAgICAgICAgc3dpdGNoQ2FzZS50ZW1wbGF0ZShjaGlsZFNjb3BlLCBmdW5jdGlvbihjYXNlRWxlbWVudCl7CiAgICAgICAgICAgIGVsZW1lbnQuYXBwZW5kKGNhc2VFbGVtZW50KTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9KTsKICAgIHNjb3BlLiRvbkV2YWwoZnVuY3Rpb24oKXsKICAgICAgaWYgKGNoaWxkU2NvcGUpIGNoaWxkU2NvcGUuJGV2YWwoKTsKICAgIH0pOwogIH07Cn0sIHsKICBlcXVhbHM6IGZ1bmN0aW9uKG9uLCB3aGVuKSB7CiAgICByZXR1cm4gJycrb24gPT0gd2hlbjsKICB9Cn0pOwoKCi8qCiAqIE1vZGlmaWVzIHRoZSBkZWZhdWx0IGJlaGF2aW9yIG9mIGh0bWwgQSB0YWcsIHNvIHRoYXQgdGhlIGRlZmF1bHQgYWN0aW9uIGlzIHByZXZlbnRlZCB3aGVuIGhyZWYKICogYXR0cmlidXRlIGlzIGVtcHR5LgogKgogKiBUaGUgcmVhc29uaW5nIGZvciB0aGlzIGNoYW5nZSBpcyB0byBhbGxvdyBlYXN5IGNyZWF0aW9uIG9mIGFjdGlvbiBsaW5rcyB3aXRoIG5nOmNsaWNrIHdpdGhvdXQKICogY2hhbmdpbmcgdGhlIGxvY2F0aW9uIG9yIGNhdXNpbmcgcGFnZSByZWxvYWRzLCBlLmcuOgogKiA8YSBocmVmPSIiIG5nOmNsaWNrPSJtb2RlbC4kc2F2ZSgpIj5TYXZlPC9hPgogKi8KYW5ndWxhcldpZGdldCgnYScsIGZ1bmN0aW9uKCkgewogIHRoaXMuZGVzY2VuZCh0cnVlKTsKICB0aGlzLmRpcmVjdGl2ZXModHJ1ZSk7CgogIHJldHVybiBmdW5jdGlvbihlbGVtZW50KSB7CiAgICB2YXIgaGFzTmdIcmVmID0gKChlbGVtZW50LmF0dHIoJ25nOmJpbmQtYXR0cicpIHx8ICcnKS5pbmRleE9mKCciaHJlZiI6JykgIT09IC0xKTsKCiAgICAvLyB0dXJuIDxhIGhyZWYgbmc6Y2xpY2s9Ii4uIj5saW5rPC9hPiBpbnRvIGEgbGluayBpbiBJRQogICAgLy8gYnV0IG9ubHkgaWYgaXQgZG9lc24ndCBoYXZlIG5hbWUgYXR0cmlidXRlLCBpbiB3aGljaCBjYXNlIGl0J3MgYW4gYW5jaG9yCiAgICBpZiAoIWhhc05nSHJlZiAmJiAhZWxlbWVudC5hdHRyKCduYW1lJykgJiYgIWVsZW1lbnQuYXR0cignaHJlZicpKSB7CiAgICAgIGVsZW1lbnQuYXR0cignaHJlZicsICcnKTsKICAgIH0KCiAgICBpZiAoZWxlbWVudC5hdHRyKCdocmVmJykgPT09ICcnICYmICFoYXNOZ0hyZWYpIHsKICAgICAgZWxlbWVudC5iaW5kKCdjbGljaycsIGZ1bmN0aW9uKGV2ZW50KXsKICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICB9KTsKICAgIH0KICB9Owp9KTsKCgovKioKICogQHdvcmtJblByb2dyZXNzCiAqIEBuZ2RvYyB3aWRnZXQKICogQG5hbWUgYW5ndWxhci53aWRnZXQuQG5nOnJlcGVhdAogKgogKiBAZGVzY3JpcHRpb24KICogVGhlIGBuZzpyZXBlYXRgIHdpZGdldCBpbnN0YW50aWF0ZXMgYSB0ZW1wbGF0ZSBvbmNlIHBlciBpdGVtIGZyb20gYSBjb2xsZWN0aW9uLiBUaGUgY29sbGVjdGlvbiBpcwogKiBlbnVtZXJhdGVkIHdpdGggdGhlIGBuZzpyZXBlYXQtaW5kZXhgIGF0dHJpYnV0ZSwgc3RhcnRpbmcgZnJvbSAwLiBFYWNoIHRlbXBsYXRlIGluc3RhbmNlIGdldHMKICogaXRzIG93biBzY29wZSwgd2hlcmUgdGhlIGdpdmVuIGxvb3AgdmFyaWFibGUgaXMgc2V0IHRvIHRoZSBjdXJyZW50IGNvbGxlY3Rpb24gaXRlbSwgYW5kIGAkaW5kZXhgCiAqIGlzIHNldCB0byB0aGUgaXRlbSBpbmRleCBvciBrZXkuCiAqCiAqIFNwZWNpYWwgcHJvcGVydGllcyBhcmUgZXhwb3NlZCBvbiB0aGUgbG9jYWwgc2NvcGUgb2YgZWFjaCB0ZW1wbGF0ZSBpbnN0YW5jZSwgaW5jbHVkaW5nOgogKgogKiAgICogYCRpbmRleGAg4oCTIGB7bnVtYmVyfWAg4oCTIGl0ZXJhdG9yIG9mZnNldCBvZiB0aGUgcmVwZWF0ZWQgZWxlbWVudCAoMC4ubGVuZ3RoLTEpCiAqICAgKiBgJHBvc2l0aW9uYCDigJMgYHtzdHJpbmd9YCDigJMgcG9zaXRpb24gb2YgdGhlIHJlcGVhdGVkIGVsZW1lbnQgaW4gdGhlIGl0ZXJhdG9yLiBPbmUgb2Y6CiAqICAgICAgICAqIGAnZmlyc3QnYCwKICogICAgICAgICogYCdtaWRkbGUnYAogKiAgICAgICAgKiBgJ2xhc3QnYAogKgogKiBOb3RlOiBBbHRob3VnaCBgbmc6cmVwZWF0YCBsb29rcyBsaWtlIGEgZGlyZWN0aXZlLCBpdCBpcyBhY3R1YWxseSBhbiBhdHRyaWJ1dGUgd2lkZ2V0LgogKgogKiBAZWxlbWVudCBBTlkKICogQHBhcmFtIHtzdHJpbmd9IHJlcGVhdF9leHByZXNzaW9uIFRoZSBleHByZXNzaW9uIGluZGljYXRpbmcgaG93IHRvIGVudW1lcmF0ZSBhIGNvbGxlY3Rpb24uIFR3bwogKiAgIGZvcm1hdHMgYXJlIGN1cnJlbnRseSBzdXBwb3J0ZWQ6CiAqCiAqICAgKiBgdmFyaWFibGUgaW4gZXhwcmVzc2lvbmAg4oCTIHdoZXJlIHZhcmlhYmxlIGlzIHRoZSB1c2VyIGRlZmluZWQgbG9vcCB2YXJpYWJsZSBhbmQgYGV4cHJlc3Npb25gCiAqICAgICBpcyBhIHNjb3BlIGV4cHJlc3Npb24gZ2l2aW5nIHRoZSBjb2xsZWN0aW9uIHRvIGVudW1lcmF0ZS4KICoKICogICAgIEZvciBleGFtcGxlOiBgdHJhY2sgaW4gY2QudHJhY2tzYC4KICoKICogICAqIGAoa2V5LCB2YWx1ZSkgaW4gZXhwcmVzc2lvbmAg4oCTIHdoZXJlIGBrZXlgIGFuZCBgdmFsdWVgIGNhbiBiZSBhbnkgdXNlciBkZWZpbmVkIGlkZW50aWZpZXJzLAogKiAgICAgYW5kIGBleHByZXNzaW9uYCBpcyB0aGUgc2NvcGUgZXhwcmVzc2lvbiBnaXZpbmcgdGhlIGNvbGxlY3Rpb24gdG8gZW51bWVyYXRlLgogKgogKiAgICAgRm9yIGV4YW1wbGU6IGAobmFtZSwgYWdlKSBpbiB7J2FkYW0nOjEwLCAnYW1hbGllJzoxMn1gLgogKgogKiBAZXhhbXBsZQogKiBUaGlzIGV4YW1wbGUgaW5pdGlhbGl6ZXMgdGhlIHNjb3BlIHRvIGEgbGlzdCBvZiBuYW1lcyBhbmQKICogdGhlbiB1c2VzIGBuZzpyZXBlYXRgIHRvIGRpc3BsYXkgZXZlcnkgcGVyc29uOgogICAgPGRvYzpleGFtcGxlPgogICAgICA8ZG9jOnNvdXJjZT4KICAgICAgICA8ZGl2IG5nOmluaXQ9ImZyaWVuZHMgPSBbe25hbWU6J0pvaG4nLCBhZ2U6MjV9LCB7bmFtZTonTWFyeScsIGFnZToyOH1dIj4KICAgICAgICAgIEkgaGF2ZSB7e2ZyaWVuZHMubGVuZ3RofX0gZnJpZW5kcy4gVGhleSBhcmU6CiAgICAgICAgICA8dWw+CiAgICAgICAgICAgIDxsaSBuZzpyZXBlYXQ9ImZyaWVuZCBpbiBmcmllbmRzIj4KICAgICAgICAgICAgICBbe3skaW5kZXggKyAxfX1dIHt7ZnJpZW5kLm5hbWV9fSB3aG8gaXMge3tmcmllbmQuYWdlfX0geWVhcnMgb2xkLgogICAgICAgICAgICA8L2xpPgogICAgICAgICAgPC91bD4KICAgICAgICA8L2Rpdj4KICAgICAgPC9kb2M6c291cmNlPgogICAgICA8ZG9jOnNjZW5hcmlvPgogICAgICAgICBpdCgnc2hvdWxkIGNoZWNrIG5nOnJlcGVhdCcsIGZ1bmN0aW9uKCl7CiAgICAgICAgICAgdmFyIHIgPSB1c2luZygnLmRvYy1leGFtcGxlLWxpdmUnKS5yZXBlYXRlcigndWwgbGknKTsKICAgICAgICAgICBleHBlY3Qoci5jb3VudCgpKS50b0JlKDIpOwogICAgICAgICAgIGV4cGVjdChyLnJvdygwKSkudG9FcXVhbChbIjEiLCJKb2huIiwiMjUiXSk7CiAgICAgICAgICAgZXhwZWN0KHIucm93KDEpKS50b0VxdWFsKFsiMiIsIk1hcnkiLCIyOCJdKTsKICAgICAgICAgfSk7CiAgICAgIDwvZG9jOnNjZW5hcmlvPgogICAgPC9kb2M6ZXhhbXBsZT4KICovCmFuZ3VsYXJXaWRnZXQoJ0BuZzpyZXBlYXQnLCBmdW5jdGlvbihleHByZXNzaW9uLCBlbGVtZW50KXsKICBlbGVtZW50LnJlbW92ZUF0dHIoJ25nOnJlcGVhdCcpOwogIGVsZW1lbnQucmVwbGFjZVdpdGgoanFMaXRlKCc8IS0tIG5nOnJlcGVhdDogJyArIGV4cHJlc3Npb24gKyAnIC0tPicpKTsKICB2YXIgbGlua2VyID0gdGhpcy5jb21waWxlKGVsZW1lbnQpOwogIHJldHVybiBmdW5jdGlvbihpdGVyU3RhcnRFbGVtZW50KXsKICAgIHZhciBtYXRjaCA9IGV4cHJlc3Npb24ubWF0Y2goL15ccyooLispXHMraW5ccysoLiopXHMqJC8pLAogICAgICAgIGxocywgcmhzLCB2YWx1ZUlkZW50LCBrZXlJZGVudDsKICAgIGlmICghIG1hdGNoKSB7CiAgICAgIHRocm93IEVycm9yKCJFeHBlY3RlZCBuZzpyZXBlYXQgaW4gZm9ybSBvZiAnX2l0ZW1fIGluIF9jb2xsZWN0aW9uXycgYnV0IGdvdCAnIiArCiAgICAgIGV4cHJlc3Npb24gKyAiJy4iKTsKICAgIH0KICAgIGxocyA9IG1hdGNoWzFdOwogICAgcmhzID0gbWF0Y2hbMl07CiAgICBtYXRjaCA9IGxocy5tYXRjaCgvXihbXCRcd10rKXxcKChbXCRcd10rKVxzKixccyooW1wkXHddKylcKSQvKTsKICAgIGlmICghbWF0Y2gpIHsKICAgICAgdGhyb3cgRXJyb3IoIidpdGVtJyBpbiAnaXRlbSBpbiBjb2xsZWN0aW9uJyBzaG91bGQgYmUgaWRlbnRpZmllciBvciAoa2V5LCB2YWx1ZSkgYnV0IGdvdCAnIiArCiAgICAgIGtleVZhbHVlICsgIicuIik7CiAgICB9CiAgICB2YWx1ZUlkZW50ID0gbWF0Y2hbM10gfHwgbWF0Y2hbMV07CiAgICBrZXlJZGVudCA9IG1hdGNoWzJdOwoKICAgIHZhciBjaGlsZHJlbiA9IFtdLCBjdXJyZW50U2NvcGUgPSB0aGlzOwogICAgdGhpcy4kb25FdmFsKGZ1bmN0aW9uKCl7CiAgICAgIHZhciBpbmRleCA9IDAsCiAgICAgICAgICBjaGlsZENvdW50ID0gY2hpbGRyZW4ubGVuZ3RoLAogICAgICAgICAgbGFzdEl0ZXJFbGVtZW50ID0gaXRlclN0YXJ0RWxlbWVudCwKICAgICAgICAgIGNvbGxlY3Rpb24gPSB0aGlzLiR0cnlFdmFsKHJocywgaXRlclN0YXJ0RWxlbWVudCksCiAgICAgICAgICBjb2xsZWN0aW9uTGVuZ3RoID0gc2l6ZShjb2xsZWN0aW9uLCB0cnVlKSwKICAgICAgICAgIGZyYWdtZW50ID0gKGVsZW1lbnRbMF0ubm9kZU5hbWUgIT0gJ09QVElPTicpID8gZG9jdW1lbnQuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpIDogbnVsbCwKICAgICAgICAgIGFkZEZyYWdtZW50LAogICAgICAgICAgY2hpbGRTY29wZSwKICAgICAgICAgIGtleTsKCiAgICAgIGZvciAoa2V5IGluIGNvbGxlY3Rpb24pIHsKICAgICAgICBpZiAoY29sbGVjdGlvbi5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CiAgICAgICAgICBpZiAoaW5kZXggPCBjaGlsZENvdW50KSB7CiAgICAgICAgICAgIC8vIHJldXNlIGV4aXN0aW5nIGNoaWxkCiAgICAgICAgICAgIGNoaWxkU2NvcGUgPSBjaGlsZHJlbltpbmRleF07CiAgICAgICAgICAgIGNoaWxkU2NvcGVbdmFsdWVJZGVudF0gPSBjb2xsZWN0aW9uW2tleV07CiAgICAgICAgICAgIGlmIChrZXlJZGVudCkgY2hpbGRTY29wZVtrZXlJZGVudF0gPSBrZXk7CiAgICAgICAgICAgIGxhc3RJdGVyRWxlbWVudCA9IGNoaWxkU2NvcGUuJGVsZW1lbnQ7CiAgICAgICAgICAgIGNoaWxkU2NvcGUuJHBvc2l0aW9uID0gaW5kZXggPT0gMAogICAgICAgICAgICAgICAgPyAnZmlyc3QnCiAgICAgICAgICAgICAgICA6IChpbmRleCA9PSBjb2xsZWN0aW9uTGVuZ3RoIC0gMSA/ICdsYXN0JyA6ICdtaWRkbGUnKTsKICAgICAgICAgICAgY2hpbGRTY29wZS4kZXZhbCgpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgLy8gZ3JvdyBjaGlsZHJlbgogICAgICAgICAgICBjaGlsZFNjb3BlID0gY3JlYXRlU2NvcGUoY3VycmVudFNjb3BlKTsKICAgICAgICAgICAgY2hpbGRTY29wZVt2YWx1ZUlkZW50XSA9IGNvbGxlY3Rpb25ba2V5XTsKICAgICAgICAgICAgaWYgKGtleUlkZW50KSBjaGlsZFNjb3BlW2tleUlkZW50XSA9IGtleTsKICAgICAgICAgICAgY2hpbGRTY29wZS4kaW5kZXggPSBpbmRleDsKICAgICAgICAgICAgY2hpbGRTY29wZS4kcG9zaXRpb24gPSBpbmRleCA9PSAwCiAgICAgICAgICAgICAgICA/ICdmaXJzdCcKICAgICAgICAgICAgICAgIDogKGluZGV4ID09IGNvbGxlY3Rpb25MZW5ndGggLSAxID8gJ2xhc3QnIDogJ21pZGRsZScpOwogICAgICAgICAgICBjaGlsZHJlbi5wdXNoKGNoaWxkU2NvcGUpOwogICAgICAgICAgICBsaW5rZXIoY2hpbGRTY29wZSwgZnVuY3Rpb24oY2xvbmUpewogICAgICAgICAgICAgIGNsb25lLmF0dHIoJ25nOnJlcGVhdC1pbmRleCcsIGluZGV4KTsKCiAgICAgICAgICAgICAgaWYgKGZyYWdtZW50KSB7CiAgICAgICAgICAgICAgICBmcmFnbWVudC5hcHBlbmRDaGlsZChjbG9uZVswXSk7CiAgICAgICAgICAgICAgICBhZGRGcmFnbWVudCA9IHRydWU7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vdGVtcG9yYXJpbHkgcHJlc2VydmUgb2xkIHdheSBmb3Igb3B0aW9uIGVsZW1lbnQKICAgICAgICAgICAgICAgIGxhc3RJdGVyRWxlbWVudC5hZnRlcihjbG9uZSk7CiAgICAgICAgICAgICAgICBsYXN0SXRlckVsZW1lbnQgPSBjbG9uZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgICAgaW5kZXggKys7CiAgICAgICAgfQogICAgICB9CgogICAgICAvL2F0dGFjaCBuZXcgbm9kZXMgYnVmZmVyZWQgaW4gZG9jIGZyYWdtZW50CiAgICAgIGlmIChhZGRGcmFnbWVudCkgewogICAgICAgIGxhc3RJdGVyRWxlbWVudC5hZnRlcihqcUxpdGUoZnJhZ21lbnQpKTsKICAgICAgfQoKICAgICAgLy8gc2hyaW5rIGNoaWxkcmVuCiAgICAgIHdoaWxlKGNoaWxkcmVuLmxlbmd0aCA+IGluZGV4KSB7CiAgICAgICAgY2hpbGRyZW4ucG9wKCkuJGVsZW1lbnQucmVtb3ZlKCk7CiAgICAgIH0KICAgIH0sIGl0ZXJTdGFydEVsZW1lbnQpOwogIH07Cn0pOwoKCi8qKgogKiBAd29ya0luUHJvZ3Jlc3MKICogQG5nZG9jIHdpZGdldAogKiBAbmFtZSBhbmd1bGFyLndpZGdldC5Abmc6bm9uLWJpbmRhYmxlCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBTb21ldGltZXMgaXQgaXMgbmVjZXNzYXJ5IHRvIHdyaXRlIGNvZGUgd2hpY2ggbG9va3MgbGlrZSBiaW5kaW5ncyBidXQgd2hpY2ggc2hvdWxkIGJlIGxlZnQgYWxvbmUKICogYnkgYW5ndWxhci4gVXNlIGBuZzpub24tYmluZGFibGVgIHRvIG1ha2UgYW5ndWxhciBpZ25vcmUgYSBjaHVuayBvZiBIVE1MLgogKgogKiBOb3RlOiBgbmc6bm9uLWJpbmRhYmxlYCBsb29rcyBsaWtlIGEgZGlyZWN0aXZlLCBidXQgaXMgYWN0dWFsbHkgYW4gYXR0cmlidXRlIHdpZGdldC4KICoKICogQGVsZW1lbnQgQU5ZCiAqCiAqIEBleGFtcGxlCiAqIEluIHRoaXMgZXhhbXBsZSB0aGVyZSBhcmUgdHdvIGxvY2F0aW9uIHdoZXJlIGEgc2ltcGxlIGJpbmRpbmcgKGB7e319YCkgaXMgcHJlc2VudCwgYnV0IHRoZSBvbmUKICogd3JhcHBlZCBpbiBgbmc6bm9uLWJpbmRhYmxlYCBpcyBsZWZ0IGFsb25lLgogKgogKiBAZXhhbXBsZQogICAgPGRvYzpleGFtcGxlPgogICAgICA8ZG9jOnNvdXJjZT4KICAgICAgICA8ZGl2Pk5vcm1hbDoge3sxICsgMn19PC9kaXY+CiAgICAgICAgPGRpdiBuZzpub24tYmluZGFibGU+SWdub3JlZDoge3sxICsgMn19PC9kaXY+CiAgICAgIDwvZG9jOnNvdXJjZT4KICAgICAgPGRvYzpzY2VuYXJpbz4KICAgICAgIGl0KCdzaG91bGQgY2hlY2sgbmc6bm9uLWJpbmRhYmxlJywgZnVuY3Rpb24oKXsKICAgICAgICAgZXhwZWN0KHVzaW5nKCcuZG9jLWV4YW1wbGUtbGl2ZScpLmJpbmRpbmcoJzEgKyAyJykpLnRvQmUoJzMnKTsKICAgICAgICAgZXhwZWN0KHVzaW5nKCcuZG9jLWV4YW1wbGUtbGl2ZScpLmVsZW1lbnQoJ2RpdjpsYXN0JykudGV4dCgpKS4KICAgICAgICAgICB0b01hdGNoKC8xIFwrIDIvKTsKICAgICAgIH0pOwogICAgICA8L2RvYzpzY2VuYXJpbz4KICAgIDwvZG9jOmV4YW1wbGU+CiAqLwphbmd1bGFyV2lkZ2V0KCJAbmc6bm9uLWJpbmRhYmxlIiwgbm9vcCk7CgoKLyoqCiAqIEBuZ2RvYyB3aWRnZXQKICogQG5hbWUgYW5ndWxhci53aWRnZXQubmc6dmlldwogKgogKiBAZGVzY3JpcHRpb24KICogIyBPdmVydmlldwogKiBgbmc6dmlld2AgaXMgYSB3aWRnZXQgdGhhdCBjb21wbGVtZW50cyB0aGUge0BsaW5rIGFuZ3VsYXIuc2VydmljZS4kcm91dGUgJHJvdXRlfSBzZXJ2aWNlIGJ5CiAqIGluY2x1ZGluZyB0aGUgcmVuZGVyZWQgdGVtcGxhdGUgb2YgdGhlIGN1cnJlbnQgcm91dGUgaW50byB0aGUgbWFpbiBsYXlvdXQgKGBpbmRleC5odG1sYCkgZmlsZS4KICogRXZlcnkgdGltZSB0aGUgY3VycmVudCByb3V0ZSBjaGFuZ2VzLCB0aGUgaW5jbHVkZWQgdmlldyBjaGFuZ2VzIHdpdGggaXQgYWNjb3JkaW5nIHRvIHRoZQogKiBjb25maWd1cmF0aW9uIG9mIHRoZSBgJHJvdXRlYCBzZXJ2aWNlLgogKgogKiBUaGlzIHdpZGdldCBwcm92aWRlcyBmdW5jdGlvbmFsaXR5IHNpbWlsYXIgdG8ge0BsaW5rIGFuZ3VsYXIud2lkZ2V0Lm5nOmluY2x1ZGUgbmc6aW5jbHVkZX0gd2hlbgogKiB1c2VkIGxpa2UgdGhpczoKICoKICogICAgIDxuZzppbmNsdWRlIHNyYz0iJHJvdXRlLmN1cnJlbnQudGVtcGxhdGUiIHNjb3BlPSIkcm91dGUuY3VycmVudC5zY29wZSI+PC9uZzppbmNsdWRlPgogKgogKgogKiAjIEFkdmFudGFnZXMKICogQ29tcGFyZWQgdG8gYG5nOmluY2x1ZGVgLCBgbmc6dmlld2Agb2ZmZXJzIHRoZXNlIGFkdmFudGFnZXM6CiAqCiAqIC0gc2hvcnRlciBzeW50YXgKICogLSBtb3JlIGVmZmljaWVudCBleGVjdXRpb24KICogLSBkb2Vzbid0IHJlcXVpcmUgYCRyb3V0ZWAgc2VydmljZSB0byBiZSBhdmFpbGFibGUgb24gdGhlIHJvb3Qgc2NvcGUKICoKICoKICogQGV4YW1wbGUKICAgIDxkb2M6ZXhhbXBsZT4KICAgICAgPGRvYzpzb3VyY2UganNmaWRkbGU9ImZhbHNlIj4KICAgICAgICAgPHNjcmlwdD4KICAgICAgICAgICBmdW5jdGlvbiBNeUN0cmwoJHJvdXRlKSB7CiAgICAgICAgICAgICAkcm91dGUud2hlbignL292ZXJ2aWV3JywKICAgICAgICAgICAgICAgeyBjb250cm9sbGVyOiBPdmVydmlld0N0cmwsCiAgICAgICAgICAgICAgICAgdGVtcGxhdGU6ICdndWlkZS9kZXZfZ3VpZGUub3ZlcnZpZXcuaHRtbCd9KTsKICAgICAgICAgICAgICRyb3V0ZS53aGVuKCcvYm9vdHN0cmFwJywKICAgICAgICAgICAgICAgeyBjb250cm9sbGVyOiBCb290c3RyYXBDdHJsLAogICAgICAgICAgICAgICAgIHRlbXBsYXRlOiAnZ3VpZGUvZGV2X2d1aWRlLmJvb3RzdHJhcC5hdXRvX2Jvb3RzdHJhcC5odG1sJ30pOwogICAgICAgICAgIH07CiAgICAgICAgICAgTXlDdHJsLiRpbmplY3QgPSBbJyRyb3V0ZSddOwoKICAgICAgICAgICBmdW5jdGlvbiBCb290c3RyYXBDdHJsKCl7fQogICAgICAgICAgIGZ1bmN0aW9uIE92ZXJ2aWV3Q3RybCgpe30KICAgICAgICAgPC9zY3JpcHQ+CiAgICAgICAgIDxkaXYgbmc6Y29udHJvbGxlcj0iTXlDdHJsIj4KICAgICAgICAgICA8YSBocmVmPSIjL292ZXJ2aWV3Ij5vdmVydmlldzwvYT4gfAogICAgICAgICAgIDxhIGhyZWY9IiMvYm9vdHN0cmFwIj5ib290c3RyYXA8L2E+IHwKICAgICAgICAgICA8YSBocmVmPSIjL3VuZGVmaW5lZCI+dW5kZWZpbmVkPC9hPgoKICAgICAgICAgICA8YnIvPgoKICAgICAgICAgICBUaGUgdmlldyBpcyBpbmNsdWRlZCBiZWxvdzoKICAgICAgICAgICA8aHIvPgogICAgICAgICAgIDxuZzp2aWV3Pjwvbmc6dmlldz4KICAgICAgICAgPC9kaXY+CiAgICAgIDwvZG9jOnNvdXJjZT4KICAgICAgPGRvYzpzY2VuYXJpbz4KICAgICAgICBpdCgnc2hvdWxkIGxvYWQgdGVtcGxhdGVzJywgZnVuY3Rpb24oKXsKICAgICAgICAgIGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIGE6Y29udGFpbnMob3ZlcnZpZXcpJykuY2xpY2soKTsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBuZ1xcOnZpZXcnKS50ZXh0KCkpLnRvTWF0Y2goL0RldmVsb3BlciBHdWlkZTogT3ZlcnZpZXcvKTsKCiAgICAgICAgICBlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBhOmNvbnRhaW5zKGJvb3RzdHJhcCknKS5jbGljaygpOwogICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIG5nXFw6dmlldycpLnRleHQoKSkudG9NYXRjaCgvRGV2ZWxvcGVyIEd1aWRlOiBJbml0aWFsaXppbmcgQW5ndWxhcjogQXV0b21hdGljIEluaXRpaWFsaXphdGlvbi8pOwogICAgICAgIH0pOwogICAgICA8L2RvYzpzY2VuYXJpbz4KICAgIDwvZG9jOmV4YW1wbGU+CiAqLwphbmd1bGFyV2lkZ2V0KCduZzp2aWV3JywgZnVuY3Rpb24oZWxlbWVudCkgewogIHZhciBjb21waWxlciA9IHRoaXM7CgogIGlmICghZWxlbWVudFswXVsnbmc6Y29tcGlsZWQnXSkgewogICAgZWxlbWVudFswXVsnbmc6Y29tcGlsZWQnXSA9IHRydWU7CiAgICByZXR1cm4gYW5ub3RhdGUoJyR4aHIuY2FjaGUnLCAnJHJvdXRlJywgZnVuY3Rpb24oJHhociwgJHJvdXRlLCBlbGVtZW50KXsKICAgICAgdmFyIHBhcmVudFNjb3BlID0gdGhpcywKICAgICAgICAgIGNoaWxkU2NvcGU7CgogICAgICAkcm91dGUub25DaGFuZ2UoZnVuY3Rpb24oKXsKICAgICAgICB2YXIgc3JjOwoKICAgICAgICBpZiAoJHJvdXRlLmN1cnJlbnQpIHsKICAgICAgICAgIHNyYyA9ICRyb3V0ZS5jdXJyZW50LnRlbXBsYXRlOwogICAgICAgICAgY2hpbGRTY29wZSA9ICRyb3V0ZS5jdXJyZW50LnNjb3BlOwogICAgICAgIH0KCiAgICAgICAgaWYgKHNyYykgewogICAgICAgICAgLy94aHIncyBjYWxsYmFjayBtdXN0IGJlIGFzeW5jLCBzZWUgY29tbWl0IGhpc3RvcnkgZm9yIG1vcmUgaW5mbwogICAgICAgICAgJHhocignR0VUJywgc3JjLCBmdW5jdGlvbihjb2RlLCByZXNwb25zZSl7CiAgICAgICAgICAgIGVsZW1lbnQuaHRtbChyZXNwb25zZSk7CiAgICAgICAgICAgIGNvbXBpbGVyLmNvbXBpbGUoZWxlbWVudCkoY2hpbGRTY29wZSk7CiAgICAgICAgICB9KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZWxlbWVudC5odG1sKCcnKTsKICAgICAgICB9CiAgICAgIH0pKCk7IC8vaW5pdGlhbGl6ZSB0aGUgc3RhdGUgZm9yY2VmdWxseSwgaXQncyBwb3NzaWJsZSB0aGF0IHdlIG1pc3NlZCB0aGUgaW5pdGlhbAogICAgICAgICAgICAvLyRyb3V0ZSNvbkNoYW5nZSBhbHJlYWR5CgogICAgICAvLyBub3RlIHRoYXQgdGhpcyBwcm9wYWdhdGVzIGV2YWwgdG8gdGhlIGN1cnJlbnQgY2hpbGRTY29wZSwgd2hlcmUgY2hpbGRTY29wZSBpcyBkeW5hbWljYWxseQogICAgICAvLyBib3VuZCAodmlhICRyb3V0ZS5vbkNoYW5nZSBjYWxsYmFjaykgdG8gdGhlIGN1cnJlbnQgc2NvcGUgY3JlYXRlZCBieSAkcm91dGUKICAgICAgcGFyZW50U2NvcGUuJG9uRXZhbChmdW5jdGlvbigpIHsKICAgICAgICBpZiAoY2hpbGRTY29wZSkgewogICAgICAgICAgY2hpbGRTY29wZS4kZXZhbCgpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9KTsKICB9IGVsc2UgewogICAgdGhpcy5kZXNjZW5kKHRydWUpOwogICAgdGhpcy5kaXJlY3RpdmVzKHRydWUpOwogIH0KfSk7Cid1c2Ugc3RyaWN0JzsKCnZhciBicm93c2VyU2luZ2xldG9uOwoKYW5ndWxhclNlcnZpY2UoJyRicm93c2VyJywgZnVuY3Rpb24oJGxvZyl7CiAgaWYgKCFicm93c2VyU2luZ2xldG9uKSB7CiAgICBicm93c2VyU2luZ2xldG9uID0gbmV3IEJyb3dzZXIod2luZG93LCBqcUxpdGUod2luZG93LmRvY3VtZW50KSwganFMaXRlKHdpbmRvdy5kb2N1bWVudC5ib2R5KSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBYSFIsICRsb2cpOwogICAgYnJvd3NlclNpbmdsZXRvbi5iaW5kKCk7CiAgfQogIHJldHVybiBicm93c2VyU2luZ2xldG9uOwp9LCB7JGluamVjdDpbJyRsb2cnXX0pOwoKCmV4dGVuZChhbmd1bGFyLCB7CiAgLy8gZGlzYWJsZWQgZm9yIG5vdyB1bnRpbCB3ZSBhZ3JlZSBvbiBwdWJsaWMgbmFtZQogIC8vJ2Fubm90YXRlJzogYW5ub3RhdGUsCiAgJ2VsZW1lbnQnOiBqcUxpdGUsCiAgJ2NvbXBpbGUnOiBjb21waWxlLAogICdzY29wZSc6IGNyZWF0ZVNjb3BlLAogICdjb3B5JzogY29weSwKICAnZXh0ZW5kJzogZXh0ZW5kLAogICdlcXVhbHMnOiBlcXVhbHMsCiAgJ2ZvckVhY2gnOiBmb3JFYWNoLAogICdpbmplY3Rvcic6IGNyZWF0ZUluamVjdG9yLAogICdub29wJzpub29wLAogICdiaW5kJzpiaW5kLAogICd0b0pzb24nOiB0b0pzb24sCiAgJ2Zyb21Kc29uJzogZnJvbUpzb24sCiAgJ2lkZW50aXR5JzppZGVudGl0eSwKICAnaXNVbmRlZmluZWQnOiBpc1VuZGVmaW5lZCwKICAnaXNEZWZpbmVkJzogaXNEZWZpbmVkLAogICdpc1N0cmluZyc6IGlzU3RyaW5nLAogICdpc0Z1bmN0aW9uJzogaXNGdW5jdGlvbiwKICAnaXNPYmplY3QnOiBpc09iamVjdCwKICAnaXNOdW1iZXInOiBpc051bWJlciwKICAnaXNBcnJheSc6IGlzQXJyYXksCiAgJ3ZlcnNpb24nOiB2ZXJzaW9uCn0pOwoKLy90cnkgdG8gYmluZCB0byBqcXVlcnkgbm93IHNvIHRoYXQgb25lIGNhbiB3cml0ZSBhbmd1bGFyLmVsZW1lbnQoKS5yZWFkKCkKLy9idXQgd2Ugd2lsbCByZWJpbmQgb24gYm9vdHN0cmFwIGFnYWluLgpiaW5kSlF1ZXJ5KCk7CgoKJ3VzZSBzdHJpY3QnOwoKCi8qKgogKiBTZXR1cCBmaWxlIGZvciB0aGUgU2NlbmFyaW8uCiAqIE11c3QgYmUgZmlyc3QgaW4gdGhlIGNvbXBpbGF0aW9uL2Jvb3RzdHJhcCBsaXN0LgogKi8KCi8vIFB1YmxpYyBuYW1lc3BhY2UKYW5ndWxhci5zY2VuYXJpbyA9IGFuZ3VsYXIuc2NlbmFyaW8gfHwge307CgovKioKICogRGVmaW5lcyBhIG5ldyBvdXRwdXQgZm9ybWF0LgogKgogKiBAcGFyYW0ge3N0cmluZ30gbmFtZSB0aGUgbmFtZSBvZiB0aGUgbmV3IG91dHB1dCBmb3JtYXQKICogQHBhcmFtIHtGdW5jdGlvbn0gZm4gZnVuY3Rpb24oY29udGV4dCwgcnVubmVyKSB0aGF0IGdlbmVyYXRlcyB0aGUgb3V0cHV0CiAqLwphbmd1bGFyLnNjZW5hcmlvLm91dHB1dCA9IGFuZ3VsYXIuc2NlbmFyaW8ub3V0cHV0IHx8IGZ1bmN0aW9uKG5hbWUsIGZuKSB7CiAgYW5ndWxhci5zY2VuYXJpby5vdXRwdXRbbmFtZV0gPSBmbjsKfTsKCi8qKgogKiBEZWZpbmVzIGEgbmV3IERTTCBzdGF0ZW1lbnQuIElmIHlvdXIgZmFjdG9yeSBmdW5jdGlvbiByZXR1cm5zIGEgRnV0dXJlCiAqIGl0J3MgcmV0dXJuZWQsIG90aGVyd2lzZSB0aGUgcmVzdWx0IGlzIGFzc3VtZWQgdG8gYmUgYSBtYXAgb2YgZnVuY3Rpb25zCiAqIGZvciBjaGFpbmluZy4gQ2hhaW5lZCBmdW5jdGlvbnMgYXJlIHN1YmplY3QgdG8gdGhlIHNhbWUgcnVsZXMuCiAqCiAqIE5vdGU6IEFsbCBmdW5jdGlvbnMgb24gdGhlIGNoYWluIGFyZSBib3VuZCB0byB0aGUgY2hhaW4gc2NvcGUgc28gdmFsdWVzCiAqICAgc2V0IG9uICJ0aGlzIiBpbiB5b3VyIHN0YXRlbWVudCBmdW5jdGlvbiBhcmUgYXZhaWxhYmxlIGluIHRoZSBjaGFpbmVkCiAqICAgZnVuY3Rpb25zLgogKgogKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBUaGUgbmFtZSBvZiB0aGUgc3RhdGVtZW50CiAqIEBwYXJhbSB7RnVuY3Rpb259IGZuIEZhY3RvcnkgZnVuY3Rpb24oKSwgcmV0dXJuIGEgZnVuY3Rpb24gZm9yCiAqICB0aGUgc3RhdGVtZW50LgogKi8KYW5ndWxhci5zY2VuYXJpby5kc2wgPSBhbmd1bGFyLnNjZW5hcmlvLmRzbCB8fCBmdW5jdGlvbihuYW1lLCBmbikgewogIGFuZ3VsYXIuc2NlbmFyaW8uZHNsW25hbWVdID0gZnVuY3Rpb24oKSB7CiAgICBmdW5jdGlvbiBleGVjdXRlU3RhdGVtZW50KHN0YXRlbWVudCwgYXJncykgewogICAgICB2YXIgcmVzdWx0ID0gc3RhdGVtZW50LmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgICBpZiAoYW5ndWxhci5pc0Z1bmN0aW9uKHJlc3VsdCkgfHwgcmVzdWx0IGluc3RhbmNlb2YgYW5ndWxhci5zY2VuYXJpby5GdXR1cmUpCiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICB2YXIgY2hhaW4gPSBhbmd1bGFyLmV4dGVuZCh7fSwgcmVzdWx0KTsKICAgICAgYW5ndWxhci5mb3JFYWNoKGNoYWluLCBmdW5jdGlvbih2YWx1ZSwgbmFtZSkgewogICAgICAgIGlmIChhbmd1bGFyLmlzRnVuY3Rpb24odmFsdWUpKSB7CiAgICAgICAgICBjaGFpbltuYW1lXSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gZXhlY3V0ZVN0YXRlbWVudC5jYWxsKHNlbGYsIHZhbHVlLCBhcmd1bWVudHMpOwogICAgICAgICAgfTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY2hhaW5bbmFtZV0gPSB2YWx1ZTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICByZXR1cm4gY2hhaW47CiAgICB9CiAgICB2YXIgc3RhdGVtZW50ID0gZm4uYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIGV4ZWN1dGVTdGF0ZW1lbnQuY2FsbCh0aGlzLCBzdGF0ZW1lbnQsIGFyZ3VtZW50cyk7CiAgICB9OwogIH07Cn07CgovKioKICogRGVmaW5lcyBhIG5ldyBtYXRjaGVyIGZvciB1c2Ugd2l0aCB0aGUgZXhwZWN0cygpIHN0YXRlbWVudC4gVGhlIHZhbHVlCiAqIHRoaXMuYWN0dWFsIChsaWtlIGluIEphc21pbmUpIGlzIGF2YWlsYWJsZSBpbiB5b3VyIG1hdGNoZXIgdG8gY29tcGFyZQogKiBhZ2FpbnN0LiBZb3VyIGZ1bmN0aW9uIHNob3VsZCByZXR1cm4gYSBib29sZWFuLiBUaGUgZnV0dXJlIGlzIGF1dG9tYXRpY2FsbHkKICogY3JlYXRlZCBmb3IgeW91LgogKgogKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBUaGUgbmFtZSBvZiB0aGUgbWF0Y2hlcgogKiBAcGFyYW0ge0Z1bmN0aW9ufSBmbiBUaGUgbWF0Y2hpbmcgZnVuY3Rpb24oZXhwZWN0ZWQpLgogKi8KYW5ndWxhci5zY2VuYXJpby5tYXRjaGVyID0gYW5ndWxhci5zY2VuYXJpby5tYXRjaGVyIHx8IGZ1bmN0aW9uKG5hbWUsIGZuKSB7CiAgYW5ndWxhci5zY2VuYXJpby5tYXRjaGVyW25hbWVdID0gZnVuY3Rpb24oZXhwZWN0ZWQpIHsKICAgIHZhciBwcmVmaXggPSAnZXhwZWN0ICcgKyB0aGlzLmZ1dHVyZS5uYW1lICsgJyAnOwogICAgaWYgKHRoaXMuaW52ZXJzZSkgewogICAgICBwcmVmaXggKz0gJ25vdCAnOwogICAgfQogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdGhpcy5hZGRGdXR1cmUocHJlZml4ICsgbmFtZSArICcgJyArIGFuZ3VsYXIudG9Kc29uKGV4cGVjdGVkKSwKICAgICAgZnVuY3Rpb24oZG9uZSkgewogICAgICAgIHZhciBlcnJvcjsKICAgICAgICBzZWxmLmFjdHVhbCA9IHNlbGYuZnV0dXJlLnZhbHVlOwogICAgICAgIGlmICgoc2VsZi5pbnZlcnNlICYmIGZuLmNhbGwoc2VsZiwgZXhwZWN0ZWQpKSB8fAogICAgICAgICAgICAoIXNlbGYuaW52ZXJzZSAmJiAhZm4uY2FsbChzZWxmLCBleHBlY3RlZCkpKSB7CiAgICAgICAgICBlcnJvciA9ICdleHBlY3RlZCAnICsgYW5ndWxhci50b0pzb24oZXhwZWN0ZWQpICsKICAgICAgICAgICAgJyBidXQgd2FzICcgKyBhbmd1bGFyLnRvSnNvbihzZWxmLmFjdHVhbCk7CiAgICAgICAgfQogICAgICAgIGRvbmUoZXJyb3IpOwogICAgfSk7CiAgfTsKfTsKCi8qKgogKiBJbml0aWFsaXplIHRoZSBzY2VuYXJpbyBydW5uZXIgYW5kIHJ1biAhCiAqCiAqIEFjY2VzcyBnbG9iYWwgd2luZG93IGFuZCBkb2N1bWVudCBvYmplY3QKICogQWNjZXNzICRydW5uZXIgdGhyb3VnaCBjbG9zdXJlCiAqCiAqIEBwYXJhbSB7T2JqZWN0PX0gY29uZmlnIENvbmZpZyBvcHRpb25zCiAqLwphbmd1bGFyLnNjZW5hcmlvLnNldFVwQW5kUnVuID0gZnVuY3Rpb24gKGNvbmZpZykgewogIHZhciBocmVmID0gd2luZG93LmxvY2F0aW9uLmhyZWY7CiAgdmFyIGJvZHkgPSBfalF1ZXJ5KGRvY3VtZW50LmJvZHkpOwogIHZhciBvdXRwdXQgPSBbXTsKICB2YXIgb2JqTW9kZWwgPSBuZXcgYW5ndWxhci5zY2VuYXJpby5PYmplY3RNb2RlbCgkcnVubmVyKTsKCiAgaWYgKGNvbmZpZyAmJiBjb25maWcuc2NlbmFyaW9fb3V0cHV0KSB7CiAgICBvdXRwdXQgPSBjb25maWcuc2NlbmFyaW9fb3V0cHV0LnNwbGl0KCcsJyk7CiAgfQoKICBhbmd1bGFyLmZvckVhY2goYW5ndWxhci5zY2VuYXJpby5vdXRwdXQsIGZ1bmN0aW9uKGZuLCBuYW1lKSB7CiAgICBpZiAoIW91dHB1dC5sZW5ndGggfHwgaW5kZXhPZihvdXRwdXQsbmFtZSkgIT0gLTEpIHsKICAgICAgdmFyIGNvbnRleHQgPSBib2R5LmFwcGVuZCgnPGRpdj48L2Rpdj4nKS5maW5kKCdkaXY6bGFzdCcpOwogICAgICBjb250ZXh0LmF0dHIoJ2lkJywgbmFtZSk7CiAgICAgIGZuLmNhbGwoe30sIGNvbnRleHQsICRydW5uZXIsIG9iak1vZGVsKTsKICAgIH0KICB9KTsKCiAgaWYgKCEvXmh0dHAvLnRlc3QoaHJlZikgJiYgIS9eaHR0cHMvLnRlc3QoaHJlZikpIHsKICAgIGJvZHkuYXBwZW5kKCc8cCBpZD0ic3lzdGVtLWVycm9yIj48L3A+Jyk7CiAgICBib2R5LmZpbmQoJyNzeXN0ZW0tZXJyb3InKS50ZXh0KAogICAgICAnU2NlbmFyaW8gcnVubmVyIG11c3QgYmUgcnVuIHVzaW5nIGh0dHAgb3IgaHR0cHMuIFRoZSBwcm90b2NvbCAnICsKICAgICAgaHJlZi5zcGxpdCgnOicpWzBdICsgJzovLyBpcyBub3Qgc3VwcG9ydGVkLicKICAgICk7CiAgICByZXR1cm47CiAgfQoKICB2YXIgYXBwRnJhbWUgPSBib2R5LmFwcGVuZCgnPGRpdiBpZD0iYXBwbGljYXRpb24iPjwvZGl2PicpLmZpbmQoJyNhcHBsaWNhdGlvbicpOwogIHZhciBhcHBsaWNhdGlvbiA9IG5ldyBhbmd1bGFyLnNjZW5hcmlvLkFwcGxpY2F0aW9uKGFwcEZyYW1lKTsKCiAgJHJ1bm5lci5vbignUnVubmVyRW5kJywgZnVuY3Rpb24oKSB7CiAgICBhcHBGcmFtZS5jc3MoJ2Rpc3BsYXknLCAnbm9uZScpOwogICAgYXBwRnJhbWUuZmluZCgnaWZyYW1lJykuYXR0cignc3JjJywgJ2Fib3V0OmJsYW5rJyk7CiAgfSk7CgogICRydW5uZXIub24oJ1J1bm5lckVycm9yJywgZnVuY3Rpb24oZXJyb3IpIHsKICAgIGlmICh3aW5kb3cuY29uc29sZSkgewogICAgICBjb25zb2xlLmxvZyhmb3JtYXRFeGNlcHRpb24oZXJyb3IpKTsKICAgIH0gZWxzZSB7CiAgICAgIC8vIERvIHNvbWV0aGluZyBmb3IgSUUKICAgICAgYWxlcnQoZXJyb3IpOwogICAgfQogIH0pOwoKICAkcnVubmVyLnJ1bihhcHBsaWNhdGlvbik7Cn07CgovKioKICogSXRlcmF0ZXMgdGhyb3VnaCBsaXN0IHdpdGggaXRlcmF0b3IgZnVuY3Rpb24gdGhhdCBtdXN0IGNhbGwgdGhlCiAqIGNvbnRpbnVlRnVuY3Rpb24gdG8gY29udGludXRlIGl0ZXJhdGluZy4KICoKICogQHBhcmFtIHtBcnJheX0gbGlzdCBsaXN0IHRvIGl0ZXJhdGUgb3ZlcgogKiBAcGFyYW0ge0Z1bmN0aW9ufSBpdGVyYXRvciBDYWxsYmFjayBmdW5jdGlvbih2YWx1ZSwgY29udGludWVGdW5jdGlvbikKICogQHBhcmFtIHtGdW5jdGlvbn0gZG9uZSBDYWxsYmFjayBmdW5jdGlvbihlcnJvciwgcmVzdWx0KSBjYWxsZWQgd2hlbgogKiAgIGl0ZXJhdGlvbiBmaW5pc2hlcyBvciBhbiBlcnJvciBvY2N1cnMuCiAqLwpmdW5jdGlvbiBhc3luY0ZvckVhY2gobGlzdCwgaXRlcmF0b3IsIGRvbmUpIHsKICB2YXIgaSA9IDA7CiAgZnVuY3Rpb24gbG9vcChlcnJvciwgaW5kZXgpIHsKICAgIGlmIChpbmRleCAmJiBpbmRleCA+IGkpIHsKICAgICAgaSA9IGluZGV4OwogICAgfQogICAgaWYgKGVycm9yIHx8IGkgPj0gbGlzdC5sZW5ndGgpIHsKICAgICAgZG9uZShlcnJvcik7CiAgICB9IGVsc2UgewogICAgICB0cnkgewogICAgICAgIGl0ZXJhdG9yKGxpc3RbaSsrXSwgbG9vcCk7CiAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICBkb25lKGUpOwogICAgICB9CiAgICB9CiAgfQogIGxvb3AoKTsKfQoKLyoqCiAqIEZvcm1hdHMgYW4gZXhjZXB0aW9uIGludG8gYSBzdHJpbmcgd2l0aCB0aGUgc3RhY2sgdHJhY2UsIGJ1dCBsaW1pdHMKICogdG8gYSBzcGVjaWZpYyBsaW5lIGxlbmd0aC4KICoKICogQHBhcmFtIHtPYmplY3R9IGVycm9yIFRoZSBleGNlcHRpb24gdG8gZm9ybWF0LCBjYW4gYmUgYW55dGhpbmcgdGhyb3dhYmxlCiAqIEBwYXJhbSB7TnVtYmVyfSBtYXhTdGFja0xpbmVzIE9wdGlvbmFsLiBtYXggbGluZXMgb2YgdGhlIHN0YWNrIHRyYWNlIHRvIGluY2x1ZGUKICogIGRlZmF1bHQgaXMgNS4KICovCmZ1bmN0aW9uIGZvcm1hdEV4Y2VwdGlvbihlcnJvciwgbWF4U3RhY2tMaW5lcykgewogIG1heFN0YWNrTGluZXMgPSBtYXhTdGFja0xpbmVzIHx8IDU7CiAgdmFyIG1lc3NhZ2UgPSBlcnJvci50b1N0cmluZygpOwogIGlmIChlcnJvci5zdGFjaykgewogICAgdmFyIHN0YWNrID0gZXJyb3Iuc3RhY2suc3BsaXQoJ1xuJyk7CiAgICBpZiAoc3RhY2tbMF0uaW5kZXhPZihtZXNzYWdlKSA9PT0gLTEpIHsKICAgICAgbWF4U3RhY2tMaW5lcysrOwogICAgICBzdGFjay51bnNoaWZ0KGVycm9yLm1lc3NhZ2UpOwogICAgfQogICAgbWVzc2FnZSA9IHN0YWNrLnNsaWNlKDAsIG1heFN0YWNrTGluZXMpLmpvaW4oJ1xuJyk7CiAgfQogIHJldHVybiBtZXNzYWdlOwp9CgovKioKICogUmV0dXJucyBhIGZ1bmN0aW9uIHRoYXQgZ2V0cyB0aGUgZmlsZSBuYW1lIGFuZCBsaW5lIG51bWJlciBmcm9tIGEKICogbG9jYXRpb24gaW4gdGhlIHN0YWNrIGlmIGF2YWlsYWJsZSBiYXNlZCBvbiB0aGUgY2FsbCBzaXRlLgogKgogKiBOb3RlOiB0aGlzIHJldHVybnMgYW5vdGhlciBmdW5jdGlvbiBiZWNhdXNlIGFjY2Vzc2luZyAuc3RhY2sgaXMgdmVyeQogKiBleHBlbnNpdmUgaW4gQ2hyb21lLgogKgogKiBAcGFyYW0ge051bWJlcn0gb2Zmc2V0IE51bWJlciBvZiBzdGFjayBsaW5lcyB0byBza2lwCiAqLwpmdW5jdGlvbiBjYWxsZXJGaWxlKG9mZnNldCkgewogIHZhciBlcnJvciA9IG5ldyBFcnJvcigpOwoKICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICB2YXIgbGluZSA9IChlcnJvci5zdGFjayB8fCAnJykuc3BsaXQoJ1xuJylbb2Zmc2V0XTsKCiAgICAvLyBDbGVhbiB1cCB0aGUgc3RhY2sgdHJhY2UgbGluZQogICAgaWYgKGxpbmUpIHsKICAgICAgaWYgKGxpbmUuaW5kZXhPZignQCcpICE9PSAtMSkgewogICAgICAgIC8vIEZpcmVmb3gKICAgICAgICBsaW5lID0gbGluZS5zdWJzdHJpbmcobGluZS5pbmRleE9mKCdAJykrMSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gQ2hyb21lCiAgICAgICAgbGluZSA9IGxpbmUuc3Vic3RyaW5nKGxpbmUuaW5kZXhPZignKCcpKzEpLnJlcGxhY2UoJyknLCAnJyk7CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gbGluZSB8fCAnJzsKICB9Owp9CgovKioKICogVHJpZ2dlcnMgYSBicm93c2VyIGV2ZW50LiBBdHRlbXB0cyB0byBjaG9vc2UgdGhlIHJpZ2h0IGV2ZW50IGlmIG9uZSBpcwogKiBub3Qgc3BlY2lmaWVkLgogKgogKiBAcGFyYW0ge09iamVjdH0gRWl0aGVyIGEgd3JhcHBlZCBqUXVlcnkvanFMaXRlIG5vZGUgb3IgYSBET01FbGVtZW50CiAqIEBwYXJhbSB7c3RyaW5nfSBPcHRpb25hbCBldmVudCB0eXBlLgogKi8KZnVuY3Rpb24gYnJvd3NlclRyaWdnZXIoZWxlbWVudCwgdHlwZSkgewogIGlmIChlbGVtZW50ICYmICFlbGVtZW50Lm5vZGVOYW1lKSBlbGVtZW50ID0gZWxlbWVudFswXTsKICBpZiAoIWVsZW1lbnQpIHJldHVybjsKICBpZiAoIXR5cGUpIHsKICAgIHR5cGUgPSB7CiAgICAgICAgJ3RleHQnOiAgICAgICAgICAgICdjaGFuZ2UnLAogICAgICAgICd0ZXh0YXJlYSc6ICAgICAgICAnY2hhbmdlJywKICAgICAgICAnaGlkZGVuJzogICAgICAgICAgJ2NoYW5nZScsCiAgICAgICAgJ3Bhc3N3b3JkJzogICAgICAgICdjaGFuZ2UnLAogICAgICAgICdidXR0b24nOiAgICAgICAgICAnY2xpY2snLAogICAgICAgICdzdWJtaXQnOiAgICAgICAgICAnY2xpY2snLAogICAgICAgICdyZXNldCc6ICAgICAgICAgICAnY2xpY2snLAogICAgICAgICdpbWFnZSc6ICAgICAgICAgICAnY2xpY2snLAogICAgICAgICdjaGVja2JveCc6ICAgICAgICAnY2xpY2snLAogICAgICAgICdyYWRpbyc6ICAgICAgICAgICAnY2xpY2snLAogICAgICAgICdzZWxlY3Qtb25lJzogICAgICAnY2hhbmdlJywKICAgICAgICAnc2VsZWN0LW11bHRpcGxlJzogJ2NoYW5nZScKICAgIH1bZWxlbWVudC50eXBlXSB8fCAnY2xpY2snOwogIH0KICBpZiAobG93ZXJjYXNlKG5vZGVOYW1lXyhlbGVtZW50KSkgPT0gJ29wdGlvbicpIHsKICAgIGVsZW1lbnQucGFyZW50Tm9kZS52YWx1ZSA9IGVsZW1lbnQudmFsdWU7CiAgICBlbGVtZW50ID0gZWxlbWVudC5wYXJlbnROb2RlOwogICAgdHlwZSA9ICdjaGFuZ2UnOwogIH0KICBpZiAobXNpZSA8IDkpIHsKICAgIHN3aXRjaChlbGVtZW50LnR5cGUpIHsKICAgICAgY2FzZSAncmFkaW8nOgogICAgICBjYXNlICdjaGVja2JveCc6CiAgICAgICAgZWxlbWVudC5jaGVja2VkID0gIWVsZW1lbnQuY2hlY2tlZDsKICAgICAgICBicmVhazsKICAgIH0KICAgIC8vIFdURiEhISBFcnJvcjogVW5zcGVjaWZpZWQgZXJyb3IuCiAgICAvLyBEb24ndCBrbm93IHdoeSwgYnV0IHNvbWUgZWxlbWVudHMgd2hlbiBkZXRhY2hlZCBzZWVtIHRvIGJlIGluIGluY29uc2lzdGVudCBzdGF0ZSBhbmQKICAgIC8vIGNhbGxpbmcgLmZpcmVFdmVudCgpIG9uIHRoZW0gd2lsbCByZXN1bHQgaW4gdmVyeSB1bmhlbHBmdWwgZXJyb3IgKEVycm9yOiBVbnNwZWNpZmllZCBlcnJvcikKICAgIC8vIGZvcmNpbmcgdGhlIGJyb3dzZXIgdG8gY29tcHV0ZSB0aGUgZWxlbWVudCBwb3NpdGlvbiAoYnkgcmVhZGluZyBpdHMgQ1NTKQogICAgLy8gcHV0cyB0aGUgZWxlbWVudCBpbiBjb25zaXN0ZW50IHN0YXRlLgogICAgZWxlbWVudC5zdHlsZS5wb3NMZWZ0OwogICAgZWxlbWVudC5maXJlRXZlbnQoJ29uJyArIHR5cGUpOwogICAgaWYgKGxvd2VyY2FzZShlbGVtZW50LnR5cGUpID09ICdzdWJtaXQnKSB7CiAgICAgIHdoaWxlKGVsZW1lbnQpIHsKICAgICAgICBpZiAobG93ZXJjYXNlKGVsZW1lbnQubm9kZU5hbWUpID09ICdmb3JtJykgewogICAgICAgICAgZWxlbWVudC5maXJlRXZlbnQoJ29uc3VibWl0Jyk7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgICAgZWxlbWVudCA9IGVsZW1lbnQucGFyZW50Tm9kZTsKICAgICAgfQogICAgfQogIH0gZWxzZSB7CiAgICB2YXIgZXZudCA9IGRvY3VtZW50LmNyZWF0ZUV2ZW50KCdNb3VzZUV2ZW50cycpOwogICAgZXZudC5pbml0TW91c2VFdmVudCh0eXBlLCB0cnVlLCB0cnVlLCB3aW5kb3csIDAsIDAsIDAsIDAsIDAsIGZhbHNlLCBmYWxzZSwgZmFsc2UsIGZhbHNlLCAwLCBlbGVtZW50KTsKICAgIGVsZW1lbnQuZGlzcGF0Y2hFdmVudChldm50KTsKICB9Cn0KCi8qKgogKiBEb24ndCB1c2UgdGhlIGpRdWVyeSB0cmlnZ2VyIG1ldGhvZCBzaW5jZSBpdCB3b3JrcyBpbmNvcnJlY3RseS4KICoKICogalF1ZXJ5IG5vdGlmaWVzIGxpc3RlbmVycyBhbmQgdGhlbiBjaGFuZ2VzIHRoZSBzdGF0ZSBvZiBhIGNoZWNrYm94IGFuZAogKiBkb2VzIG5vdCBjcmVhdGUgYSByZWFsIGJyb3dzZXIgZXZlbnQuIEEgcmVhbCBjbGljayBjaGFuZ2VzIHRoZSBzdGF0ZSBvZgogKiB0aGUgY2hlY2tib3ggYW5kIHRoZW4gbm90aWZpZXMgbGlzdGVuZXJzLgogKgogKiBUbyB3b3JrIGFyb3VuZCB0aGlzIHdlIGluc3RlYWQgdXNlIG91ciBvd24gaGFuZGxlciB0aGF0IGZpcmVzIGEgcmVhbCBldmVudC4KICovCihmdW5jdGlvbihmbil7CiAgdmFyIHBhcmVudFRyaWdnZXIgPSBmbi50cmlnZ2VyOwogIGZuLnRyaWdnZXIgPSBmdW5jdGlvbih0eXBlKSB7CiAgICBpZiAoLyhjbGlja3xjaGFuZ2V8a2V5ZG93bikvLnRlc3QodHlwZSkpIHsKICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbihpbmRleCwgbm9kZSkgewogICAgICAgIGJyb3dzZXJUcmlnZ2VyKG5vZGUsIHR5cGUpOwogICAgICB9KTsKICAgIH0KICAgIHJldHVybiBwYXJlbnRUcmlnZ2VyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgfTsKfSkoX2pRdWVyeS5mbik7CgovKioKICogRmluZHMgYWxsIGJpbmRpbmdzIHdpdGggdGhlIHN1YnN0cmluZyBtYXRjaCBvZiBuYW1lIGFuZCByZXR1cm5zIGFuCiAqIGFycmF5IG9mIHRoZWlyIHZhbHVlcy4KICoKICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgVGhlIG5hbWUgdG8gbWF0Y2gKICogQHJldHVybiB7QXJyYXkuPHN0cmluZz59IFN0cmluZyBvZiBiaW5kaW5nIHZhbHVlcwogKi8KX2pRdWVyeS5mbi5iaW5kaW5ncyA9IGZ1bmN0aW9uKG5hbWUpIHsKICBmdW5jdGlvbiBjb250YWlucyh0ZXh0LCB2YWx1ZSkgewogICAgcmV0dXJuIHZhbHVlIGluc3RhbmNlb2YgUmVnRXhwCiAgICAgID8gdmFsdWUudGVzdCh0ZXh0KQogICAgICA6IHRleHQgJiYgdGV4dC5pbmRleE9mKHZhbHVlKSA+PSAwOwogIH0KICB2YXIgcmVzdWx0ID0gW107CiAgdGhpcy5maW5kKCcubmctYmluZGluZzp2aXNpYmxlJykuZWFjaChmdW5jdGlvbigpIHsKICAgIHZhciBlbGVtZW50ID0gbmV3IF9qUXVlcnkodGhpcyk7CiAgICBpZiAoIWFuZ3VsYXIuaXNEZWZpbmVkKG5hbWUpIHx8CiAgICAgIGNvbnRhaW5zKGVsZW1lbnQuYXR0cignbmc6YmluZCcpLCBuYW1lKSB8fAogICAgICBjb250YWlucyhlbGVtZW50LmF0dHIoJ25nOmJpbmQtdGVtcGxhdGUnKSwgbmFtZSkpIHsKICAgICAgaWYgKGVsZW1lbnQuaXMoJ2lucHV0LCB0ZXh0YXJlYScpKSB7CiAgICAgICAgcmVzdWx0LnB1c2goZWxlbWVudC52YWwoKSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmVzdWx0LnB1c2goZWxlbWVudC5odG1sKCkpOwogICAgICB9CiAgICB9CiAgfSk7CiAgcmV0dXJuIHJlc3VsdDsKfTsKJ3VzZSBzdHJpY3QnOwoKLyoqCiAqIFJlcHJlc2VudHMgdGhlIGFwcGxpY2F0aW9uIGN1cnJlbnRseSBiZWluZyB0ZXN0ZWQgYW5kIGFic3RyYWN0cyB1c2FnZQogKiBvZiBpZnJhbWVzIG9yIHNlcGFyYXRlIHdpbmRvd3MuCiAqCiAqIEBwYXJhbSB7T2JqZWN0fSBjb250ZXh0IGpRdWVyeSB3cmFwcGVyIGFyb3VuZCBIVE1MIGNvbnRleHQuCiAqLwphbmd1bGFyLnNjZW5hcmlvLkFwcGxpY2F0aW9uID0gZnVuY3Rpb24oY29udGV4dCkgewogIHRoaXMuY29udGV4dCA9IGNvbnRleHQ7CiAgY29udGV4dC5hcHBlbmQoCiAgICAnPGgyPkN1cnJlbnQgVVJMOiA8YSBocmVmPSJhYm91dDpibGFuayI+Tm9uZTwvYT48L2gyPicgKwogICAgJzxkaXYgaWQ9InRlc3QtZnJhbWVzIj48L2Rpdj4nCiAgKTsKfTsKCi8qKgogKiBHZXRzIHRoZSBqUXVlcnkgY29sbGVjdGlvbiBvZiBmcmFtZXMuIERvbid0IHVzZSB0aGlzIGRpcmVjdGx5IGJlY2F1c2UKICogZnJhbWVzIG1heSBnbyBzdGFsZS4KICoKICogQHByaXZhdGUKICogQHJldHVybiB7T2JqZWN0fSBqUXVlcnkgY29sbGVjdGlvbgogKi8KYW5ndWxhci5zY2VuYXJpby5BcHBsaWNhdGlvbi5wcm90b3R5cGUuZ2V0RnJhbWVfID0gZnVuY3Rpb24oKSB7CiAgcmV0dXJuIHRoaXMuY29udGV4dC5maW5kKCcjdGVzdC1mcmFtZXMgaWZyYW1lOmxhc3QnKTsKfTsKCi8qKgogKiBHZXRzIHRoZSB3aW5kb3cgb2YgdGhlIHRlc3QgcnVubmVyIGZyYW1lLiBBbHdheXMgZmF2b3IgZXhlY3V0ZUFjdGlvbigpCiAqIGluc3RlYWQgb2YgdGhpcyBtZXRob2Qgc2luY2UgaXQgcHJldmVudHMgeW91IGZyb20gZ2V0dGluZyBhIHN0YWxlIHdpbmRvdy4KICoKICogQHByaXZhdGUKICogQHJldHVybiB7T2JqZWN0fSB0aGUgd2luZG93IG9mIHRoZSBmcmFtZQogKi8KYW5ndWxhci5zY2VuYXJpby5BcHBsaWNhdGlvbi5wcm90b3R5cGUuZ2V0V2luZG93XyA9IGZ1bmN0aW9uKCkgewogIHZhciBjb250ZW50V2luZG93ID0gdGhpcy5nZXRGcmFtZV8oKS5hdHRyKCdjb250ZW50V2luZG93Jyk7CiAgaWYgKCFjb250ZW50V2luZG93KQogICAgdGhyb3cgJ0ZyYW1lIHdpbmRvdyBpcyBub3QgYWNjZXNzaWJsZS4nOwogIHJldHVybiBjb250ZW50V2luZG93Owp9OwoKLyoqCiAqIENoYW5nZXMgdGhlIGxvY2F0aW9uIG9mIHRoZSBmcmFtZS4KICoKICogQHBhcmFtIHtzdHJpbmd9IHVybCBUaGUgVVJMLiBJZiBpdCBiZWdpbnMgd2l0aCBhICMgdGhlbiBvbmx5IHRoZQogKiAgIGhhc2ggb2YgdGhlIHBhZ2UgaXMgY2hhbmdlZC4KICogQHBhcmFtIHtGdW5jdGlvbn0gbG9hZEZuIGZ1bmN0aW9uKCR3aW5kb3csICRkb2N1bWVudCkgQ2FsbGVkIHdoZW4gZnJhbWUgbG9hZHMuCiAqIEBwYXJhbSB7RnVuY3Rpb259IGVycm9yRm4gZnVuY3Rpb24oZXJyb3IpIENhbGxlZCBpZiBhbnkgZXJyb3Igd2hlbiBsb2FkaW5nLgogKi8KYW5ndWxhci5zY2VuYXJpby5BcHBsaWNhdGlvbi5wcm90b3R5cGUubmF2aWdhdGVUbyA9IGZ1bmN0aW9uKHVybCwgbG9hZEZuLCBlcnJvckZuKSB7CiAgdmFyIHNlbGYgPSB0aGlzOwogIHZhciBmcmFtZSA9IHRoaXMuZ2V0RnJhbWVfKCk7CiAgLy9UT0RPKGVzcHJlaG4pOiBSZWZhY3RvciB0byB1c2UgcmV0aHJvdygpCiAgZXJyb3JGbiA9IGVycm9yRm4gfHwgZnVuY3Rpb24oZSkgeyB0aHJvdyBlOyB9OwogIGlmICh1cmwgPT09ICdhYm91dDpibGFuaycpIHsKICAgIGVycm9yRm4oJ1NhbmRib3ggRXJyb3I6IE5hdmlnYXRpbmcgdG8gYWJvdXQ6YmxhbmsgaXMgbm90IGFsbG93ZWQuJyk7CiAgfSBlbHNlIGlmICh1cmwuY2hhckF0KDApID09PSAnIycpIHsKICAgIHVybCA9IGZyYW1lLmF0dHIoJ3NyYycpLnNwbGl0KCcjJylbMF0gKyB1cmw7CiAgICBmcmFtZS5hdHRyKCdzcmMnLCB1cmwpOwogICAgdGhpcy5leGVjdXRlQWN0aW9uKGxvYWRGbik7CiAgfSBlbHNlIHsKICAgIGZyYW1lLnJlbW92ZSgpOwogICAgdGhpcy5jb250ZXh0LmZpbmQoJyN0ZXN0LWZyYW1lcycpLmFwcGVuZCgnPGlmcmFtZT4nKTsKICAgIGZyYW1lID0gdGhpcy5nZXRGcmFtZV8oKTsKICAgIGZyYW1lLmxvYWQoZnVuY3Rpb24oKSB7CiAgICAgIGZyYW1lLnVuYmluZCgpOwogICAgICB0cnkgewogICAgICAgIHNlbGYuZXhlY3V0ZUFjdGlvbihsb2FkRm4pOwogICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgZXJyb3JGbihlKTsKICAgICAgfQogICAgfSkuYXR0cignc3JjJywgdXJsKTsKICB9CiAgdGhpcy5jb250ZXh0LmZpbmQoJz4gaDIgYScpLmF0dHIoJ2hyZWYnLCB1cmwpLnRleHQodXJsKTsKfTsKCi8qKgogKiBFeGVjdXRlcyBhIGZ1bmN0aW9uIGluIHRoZSBjb250ZXh0IG9mIHRoZSB0ZXN0ZWQgYXBwbGljYXRpb24uIFdpbGwgd2FpdAogKiBmb3IgYWxsIHBlbmRpbmcgYW5ndWxhciB4aHIgcmVxdWVzdHMgYmVmb3JlIGV4ZWN1dGluZy4KICoKICogQHBhcmFtIHtGdW5jdGlvbn0gYWN0aW9uIFRoZSBjYWxsYmFjayB0byBleGVjdXRlLiBmdW5jdGlvbigkd2luZG93LCAkZG9jdW1lbnQpCiAqICAkZG9jdW1lbnQgaXMgYSBqUXVlcnkgd3JhcHBlZCBkb2N1bWVudC4KICovCmFuZ3VsYXIuc2NlbmFyaW8uQXBwbGljYXRpb24ucHJvdG90eXBlLmV4ZWN1dGVBY3Rpb24gPSBmdW5jdGlvbihhY3Rpb24pIHsKICB2YXIgc2VsZiA9IHRoaXM7CiAgdmFyICR3aW5kb3cgPSB0aGlzLmdldFdpbmRvd18oKTsKICBpZiAoISR3aW5kb3cuZG9jdW1lbnQpIHsKICAgIHRocm93ICdTYW5kYm94IEVycm9yOiBBcHBsaWNhdGlvbiBkb2N1bWVudCBub3QgYWNjZXNzaWJsZS4nOwogIH0KICBpZiAoISR3aW5kb3cuYW5ndWxhcikgewogICAgcmV0dXJuIGFjdGlvbi5jYWxsKHRoaXMsICR3aW5kb3csIF9qUXVlcnkoJHdpbmRvdy5kb2N1bWVudCkpOwogIH0KICB2YXIgJGJyb3dzZXIgPSAkd2luZG93LmFuZ3VsYXIuc2VydmljZS4kYnJvd3NlcigpOwogICRicm93c2VyLm5vdGlmeVdoZW5Ob091dHN0YW5kaW5nUmVxdWVzdHMoZnVuY3Rpb24oKSB7CiAgICBhY3Rpb24uY2FsbChzZWxmLCAkd2luZG93LCBfalF1ZXJ5KCR3aW5kb3cuZG9jdW1lbnQpKTsKICB9KTsKfTsKJ3VzZSBzdHJpY3QnOwoKLyoqCiAqIFRoZSByZXByZXNlbnRhdGlvbiBvZiBkZWZpbmUgYmxvY2tzLiBEb24ndCB1c2VkIGRpcmVjdGx5LCBpbnN0ZWFkIHVzZQogKiBkZWZpbmUoKSBpbiB5b3VyIHRlc3RzLgogKgogKiBAcGFyYW0ge3N0cmluZ30gZGVzY05hbWUgTmFtZSBvZiB0aGUgYmxvY2sKICogQHBhcmFtIHtPYmplY3R9IHBhcmVudCBkZXNjcmliZSBvciB1bmRlZmluZWQgaWYgdGhlIHJvb3QuCiAqLwphbmd1bGFyLnNjZW5hcmlvLkRlc2NyaWJlID0gZnVuY3Rpb24oZGVzY05hbWUsIHBhcmVudCkgewogIHRoaXMub25seSA9IHBhcmVudCAmJiBwYXJlbnQub25seTsKICB0aGlzLmJlZm9yZUVhY2hGbnMgPSBbXTsKICB0aGlzLmFmdGVyRWFjaEZucyA9IFtdOwogIHRoaXMuaXRzID0gW107CiAgdGhpcy5jaGlsZHJlbiA9IFtdOwogIHRoaXMubmFtZSA9IGRlc2NOYW1lOwogIHRoaXMucGFyZW50ID0gcGFyZW50OwogIHRoaXMuaWQgPSBhbmd1bGFyLnNjZW5hcmlvLkRlc2NyaWJlLmlkKys7CgogIC8qKgogICAqIENhbGxzIGFsbCBiZWZvcmUgZnVuY3Rpb25zLgogICAqLwogIHZhciBiZWZvcmVFYWNoRm5zID0gdGhpcy5iZWZvcmVFYWNoRm5zOwogIHRoaXMuc2V0dXBCZWZvcmUgPSBmdW5jdGlvbigpIHsKICAgIGlmIChwYXJlbnQpIHBhcmVudC5zZXR1cEJlZm9yZS5jYWxsKHRoaXMpOwogICAgYW5ndWxhci5mb3JFYWNoKGJlZm9yZUVhY2hGbnMsIGZ1bmN0aW9uKGZuKSB7IGZuLmNhbGwodGhpcyk7IH0sIHRoaXMpOwogIH07CgogIC8qKgogICAqIENhbGxzIGFsbCBhZnRlciBmdW5jdGlvbnMuCiAgICovCiAgdmFyIGFmdGVyRWFjaEZucyA9IHRoaXMuYWZ0ZXJFYWNoRm5zOwogIHRoaXMuc2V0dXBBZnRlciAgPSBmdW5jdGlvbigpIHsKICAgIGFuZ3VsYXIuZm9yRWFjaChhZnRlckVhY2hGbnMsIGZ1bmN0aW9uKGZuKSB7IGZuLmNhbGwodGhpcyk7IH0sIHRoaXMpOwogICAgaWYgKHBhcmVudCkgcGFyZW50LnNldHVwQWZ0ZXIuY2FsbCh0aGlzKTsKICB9Owp9OwoKLy8gU2hhcmVkIFVuaXF1ZSBJRCBnZW5lcmF0b3IgZm9yIGV2ZXJ5IGRlc2NyaWJlIGJsb2NrCmFuZ3VsYXIuc2NlbmFyaW8uRGVzY3JpYmUuaWQgPSAwOwoKLy8gU2hhcmVkIFVuaXF1ZSBJRCBnZW5lcmF0b3IgZm9yIGV2ZXJ5IGl0IChzcGVjKQphbmd1bGFyLnNjZW5hcmlvLkRlc2NyaWJlLnNwZWNJZCA9IDA7CgovKioKICogRGVmaW5lcyBhIGJsb2NrIHRvIGV4ZWN1dGUgYmVmb3JlIGVhY2ggaXQgb3IgbmVzdGVkIGRlc2NyaWJlLgogKgogKiBAcGFyYW0ge0Z1bmN0aW9ufSBib2R5IEJvZHkgb2YgdGhlIGJsb2NrLgogKi8KYW5ndWxhci5zY2VuYXJpby5EZXNjcmliZS5wcm90b3R5cGUuYmVmb3JlRWFjaCA9IGZ1bmN0aW9uKGJvZHkpIHsKICB0aGlzLmJlZm9yZUVhY2hGbnMucHVzaChib2R5KTsKfTsKCi8qKgogKiBEZWZpbmVzIGEgYmxvY2sgdG8gZXhlY3V0ZSBhZnRlciBlYWNoIGl0IG9yIG5lc3RlZCBkZXNjcmliZS4KICoKICogQHBhcmFtIHtGdW5jdGlvbn0gYm9keSBCb2R5IG9mIHRoZSBibG9jay4KICovCmFuZ3VsYXIuc2NlbmFyaW8uRGVzY3JpYmUucHJvdG90eXBlLmFmdGVyRWFjaCA9IGZ1bmN0aW9uKGJvZHkpIHsKICB0aGlzLmFmdGVyRWFjaEZucy5wdXNoKGJvZHkpOwp9OwoKLyoqCiAqIENyZWF0ZXMgYSBuZXcgZGVzY3JpYmUgYmxvY2sgdGhhdCdzIGEgY2hpbGQgb2YgdGhpcyBvbmUuCiAqCiAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIE5hbWUgb2YgdGhlIGJsb2NrLiBBcHBlbmRlZCB0byB0aGUgcGFyZW50IGJsb2NrJ3MgbmFtZS4KICogQHBhcmFtIHtGdW5jdGlvbn0gYm9keSBCb2R5IG9mIHRoZSBibG9jay4KICovCmFuZ3VsYXIuc2NlbmFyaW8uRGVzY3JpYmUucHJvdG90eXBlLmRlc2NyaWJlID0gZnVuY3Rpb24obmFtZSwgYm9keSkgewogIHZhciBjaGlsZCA9IG5ldyBhbmd1bGFyLnNjZW5hcmlvLkRlc2NyaWJlKG5hbWUsIHRoaXMpOwogIHRoaXMuY2hpbGRyZW4ucHVzaChjaGlsZCk7CiAgYm9keS5jYWxsKGNoaWxkKTsKfTsKCi8qKgogKiBTYW1lIGFzIGRlc2NyaWJlKCkgYnV0IG1ha2VzIGRkZXNjcmliZSBibG9ja3MgdGhlIG9ubHkgdG8gcnVuLgogKgogKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBOYW1lIG9mIHRoZSB0ZXN0LgogKiBAcGFyYW0ge0Z1bmN0aW9ufSBib2R5IEJvZHkgb2YgdGhlIGJsb2NrLgogKi8KYW5ndWxhci5zY2VuYXJpby5EZXNjcmliZS5wcm90b3R5cGUuZGRlc2NyaWJlID0gZnVuY3Rpb24obmFtZSwgYm9keSkgewogIHZhciBjaGlsZCA9IG5ldyBhbmd1bGFyLnNjZW5hcmlvLkRlc2NyaWJlKG5hbWUsIHRoaXMpOwogIGNoaWxkLm9ubHkgPSB0cnVlOwogIHRoaXMuY2hpbGRyZW4ucHVzaChjaGlsZCk7CiAgYm9keS5jYWxsKGNoaWxkKTsKfTsKCi8qKgogKiBVc2UgdG8gZGlzYWJsZSBhIGRlc2NyaWJlIGJsb2NrLgogKi8KYW5ndWxhci5zY2VuYXJpby5EZXNjcmliZS5wcm90b3R5cGUueGRlc2NyaWJlID0gYW5ndWxhci5ub29wOwoKLyoqCiAqIERlZmluZXMgYSB0ZXN0LgogKgogKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBOYW1lIG9mIHRoZSB0ZXN0LgogKiBAcGFyYW0ge0Z1bmN0aW9ufSB2b2R5IEJvZHkgb2YgdGhlIGJsb2NrLgogKi8KYW5ndWxhci5zY2VuYXJpby5EZXNjcmliZS5wcm90b3R5cGUuaXQgPSBmdW5jdGlvbihuYW1lLCBib2R5KSB7CiAgdGhpcy5pdHMucHVzaCh7CiAgICBpZDogYW5ndWxhci5zY2VuYXJpby5EZXNjcmliZS5zcGVjSWQrKywKICAgIGRlZmluaXRpb246IHRoaXMsCiAgICBvbmx5OiB0aGlzLm9ubHksCiAgICBuYW1lOiBuYW1lLAogICAgYmVmb3JlOiB0aGlzLnNldHVwQmVmb3JlLAogICAgYm9keTogYm9keSwKICAgIGFmdGVyOiB0aGlzLnNldHVwQWZ0ZXIKICB9KTsKfTsKCi8qKgogKiBTYW1lIGFzIGl0KCkgYnV0IG1ha2VzIGlpdCB0ZXN0cyB0aGUgb25seSB0ZXN0IHRvIHJ1bi4KICoKICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgTmFtZSBvZiB0aGUgdGVzdC4KICogQHBhcmFtIHtGdW5jdGlvbn0gYm9keSBCb2R5IG9mIHRoZSBibG9jay4KICovCmFuZ3VsYXIuc2NlbmFyaW8uRGVzY3JpYmUucHJvdG90eXBlLmlpdCA9IGZ1bmN0aW9uKG5hbWUsIGJvZHkpIHsKICB0aGlzLml0LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgdGhpcy5pdHNbdGhpcy5pdHMubGVuZ3RoLTFdLm9ubHkgPSB0cnVlOwp9OwoKLyoqCiAqIFVzZSB0byBkaXNhYmxlIGEgdGVzdCBibG9jay4KICovCmFuZ3VsYXIuc2NlbmFyaW8uRGVzY3JpYmUucHJvdG90eXBlLnhpdCA9IGFuZ3VsYXIubm9vcDsKCi8qKgogKiBHZXRzIGFuIGFycmF5IG9mIGZ1bmN0aW9ucyByZXByZXNlbnRpbmcgYWxsIHRoZSB0ZXN0cyAocmVjdXJzaXZlbHkpLgogKiB0aGF0IGNhbiBiZSBleGVjdXRlZCB3aXRoIFNwZWNSdW5uZXIncy4KICoKICogQHJldHVybiB7QXJyYXk8T2JqZWN0Pn0gQXJyYXkgb2YgaXQgYmxvY2tzIHsKICogICBkZWZpbml0aW9uIDogT2JqZWN0IC8vIHBhcmVudCBEZXNjcmliZQogKiAgIG9ubHk6IGJvb2xlYW4KICogICBuYW1lOiBzdHJpbmcKICogICBiZWZvcmU6IEZ1bmN0aW9uCiAqICAgYm9keTogRnVuY3Rpb24KICogICBhZnRlcjogRnVuY3Rpb24KICogIH0KICovCmFuZ3VsYXIuc2NlbmFyaW8uRGVzY3JpYmUucHJvdG90eXBlLmdldFNwZWNzID0gZnVuY3Rpb24oKSB7CiAgdmFyIHNwZWNzID0gYXJndW1lbnRzWzBdIHx8IFtdOwogIGFuZ3VsYXIuZm9yRWFjaCh0aGlzLmNoaWxkcmVuLCBmdW5jdGlvbihjaGlsZCkgewogICAgY2hpbGQuZ2V0U3BlY3Moc3BlY3MpOwogIH0pOwogIGFuZ3VsYXIuZm9yRWFjaCh0aGlzLml0cywgZnVuY3Rpb24oaXQpIHsKICAgIHNwZWNzLnB1c2goaXQpOwogIH0pOwogIHZhciBvbmx5ID0gW107CiAgYW5ndWxhci5mb3JFYWNoKHNwZWNzLCBmdW5jdGlvbihpdCkgewogICAgaWYgKGl0Lm9ubHkpIHsKICAgICAgb25seS5wdXNoKGl0KTsKICAgIH0KICB9KTsKICByZXR1cm4gKG9ubHkubGVuZ3RoICYmIG9ubHkpIHx8IHNwZWNzOwp9OwondXNlIHN0cmljdCc7CgovKioKICogQSBmdXR1cmUgYWN0aW9uIGluIGEgc3BlYy4KICoKICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgb2YgdGhlIGZ1dHVyZSBhY3Rpb24KICogQHBhcmFtIHtGdW5jdGlvbn0gZnV0dXJlIGNhbGxiYWNrKGVycm9yLCByZXN1bHQpCiAqIEBwYXJhbSB7RnVuY3Rpb259IE9wdGlvbmFsLiBmdW5jdGlvbiB0aGF0IHJldHVybnMgdGhlIGZpbGUvbGluZSBudW1iZXIuCiAqLwphbmd1bGFyLnNjZW5hcmlvLkZ1dHVyZSA9IGZ1bmN0aW9uKG5hbWUsIGJlaGF2aW9yLCBsaW5lKSB7CiAgdGhpcy5uYW1lID0gbmFtZTsKICB0aGlzLmJlaGF2aW9yID0gYmVoYXZpb3I7CiAgdGhpcy5mdWxmaWxsZWQgPSBmYWxzZTsKICB0aGlzLnZhbHVlID0gdW5kZWZpbmVkOwogIHRoaXMucGFyc2VyID0gYW5ndWxhci5pZGVudGl0eTsKICB0aGlzLmxpbmUgPSBsaW5lIHx8IGZ1bmN0aW9uKCkgeyByZXR1cm4gJyc7IH07Cn07CgovKioKICogRXhlY3V0ZXMgdGhlIGJlaGF2aW9yIG9mIHRoZSBjbG9zdXJlLgogKgogKiBAcGFyYW0ge0Z1bmN0aW9ufSBkb25lRm4gQ2FsbGJhY2sgZnVuY3Rpb24oZXJyb3IsIHJlc3VsdCkKICovCmFuZ3VsYXIuc2NlbmFyaW8uRnV0dXJlLnByb3RvdHlwZS5leGVjdXRlID0gZnVuY3Rpb24oZG9uZUZuKSB7CiAgdmFyIHNlbGYgPSB0aGlzOwogIHRoaXMuYmVoYXZpb3IoZnVuY3Rpb24oZXJyb3IsIHJlc3VsdCkgewogICAgc2VsZi5mdWxmaWxsZWQgPSB0cnVlOwogICAgaWYgKHJlc3VsdCkgewogICAgICB0cnkgewogICAgICAgIHJlc3VsdCA9IHNlbGYucGFyc2VyKHJlc3VsdCk7CiAgICAgIH0gY2F0Y2goZSkgewogICAgICAgIGVycm9yID0gZTsKICAgICAgfQogICAgfQogICAgc2VsZi52YWx1ZSA9IGVycm9yIHx8IHJlc3VsdDsKICAgIGRvbmVGbihlcnJvciwgcmVzdWx0KTsKICB9KTsKfTsKCi8qKgogKiBDb25maWd1cmVzIHRoZSBmdXR1cmUgdG8gY29udmVydCBpdCdzIGZpbmFsIHdpdGggYSBmdW5jdGlvbiBmbih2YWx1ZSkKICoKICogQHBhcmFtIHtGdW5jdGlvbn0gZm4gZnVuY3Rpb24odmFsdWUpIHRoYXQgcmV0dXJucyB0aGUgcGFyc2VkIHZhbHVlCiAqLwphbmd1bGFyLnNjZW5hcmlvLkZ1dHVyZS5wcm90b3R5cGUucGFyc2VkV2l0aCA9IGZ1bmN0aW9uKGZuKSB7CiAgdGhpcy5wYXJzZXIgPSBmbjsKICByZXR1cm4gdGhpczsKfTsKCi8qKgogKiBDb25maWd1cmVzIHRoZSBmdXR1cmUgdG8gcGFyc2UgaXQncyBmaW5hbCB2YWx1ZSBmcm9tIEpTT04KICogaW50byBvYmplY3RzLgogKi8KYW5ndWxhci5zY2VuYXJpby5GdXR1cmUucHJvdG90eXBlLmZyb21Kc29uID0gZnVuY3Rpb24oKSB7CiAgcmV0dXJuIHRoaXMucGFyc2VkV2l0aChhbmd1bGFyLmZyb21Kc29uKTsKfTsKCi8qKgogKiBDb25maWd1cmVzIHRoZSBmdXR1cmUgdG8gY29udmVydCBpdCdzIGZpbmFsIHZhbHVlIGZyb20gb2JqZWN0cwogKiBpbnRvIEpTT04uCiAqLwphbmd1bGFyLnNjZW5hcmlvLkZ1dHVyZS5wcm90b3R5cGUudG9Kc29uID0gZnVuY3Rpb24oKSB7CiAgcmV0dXJuIHRoaXMucGFyc2VkV2l0aChhbmd1bGFyLnRvSnNvbik7Cn07Cid1c2Ugc3RyaWN0JzsKCi8qKgogKiBNYWludGFpbnMgYW4gb2JqZWN0IHRyZWUgZnJvbSB0aGUgcnVubmVyIGV2ZW50cy4KICoKICogQHBhcmFtIHtPYmplY3R9IHJ1bm5lciBUaGUgc2NlbmFyaW8gUnVubmVyIGluc3RhbmNlIHRvIGNvbm5lY3QgdG8uCiAqCiAqIFRPRE8oZXNwcmVobik6IEV2ZXJ5IG91dHB1dCB0eXBlIGNyZWF0ZXMgb25lIG9mIHRoZXNlLCBidXQgd2UgcHJvYmFibHkKICogIHdhbnQgb25lIGdsb2JhbCBzaGFyZWQgaW5zdGFuY2UuIE5lZWQgdG8gaGFuZGxlIGV2ZW50cyBiZXR0ZXIgdG9vCiAqICBzbyB0aGUgSFRNTCBvdXRwdXQgZG9lc24ndCBuZWVkIHRvIGRvIHNwZWMgbW9kZWwuZ2V0U3BlYyhzcGVjLmlkKQogKiAgc2lsbGluZXNzLgogKgogKiBUT0RPKHZvanRhKSByZWZhY3RvciBvbiwgZW1pdCBtZXRob2RzIChmcm9tIGFsbCBvYmplY3RzKSAtIHVzZSBpbmhlcml0YW5jZQogKi8KYW5ndWxhci5zY2VuYXJpby5PYmplY3RNb2RlbCA9IGZ1bmN0aW9uKHJ1bm5lcikgewogIHZhciBzZWxmID0gdGhpczsKCiAgdGhpcy5zcGVjTWFwID0ge307CiAgdGhpcy5saXN0ZW5lcnMgPSBbXTsKICB0aGlzLnZhbHVlID0gewogICAgbmFtZTogJycsCiAgICBjaGlsZHJlbjoge30KICB9OwoKICBydW5uZXIub24oJ1NwZWNCZWdpbicsIGZ1bmN0aW9uKHNwZWMpIHsKICAgIHZhciBibG9jayA9IHNlbGYudmFsdWUsCiAgICAgICAgZGVmaW5pdGlvbnMgPSBbXTsKCiAgICBhbmd1bGFyLmZvckVhY2goc2VsZi5nZXREZWZpbml0aW9uUGF0aChzcGVjKSwgZnVuY3Rpb24oZGVmKSB7CiAgICAgIGlmICghYmxvY2suY2hpbGRyZW5bZGVmLm5hbWVdKSB7CiAgICAgICAgYmxvY2suY2hpbGRyZW5bZGVmLm5hbWVdID0gewogICAgICAgICAgaWQ6IGRlZi5pZCwKICAgICAgICAgIG5hbWU6IGRlZi5uYW1lLAogICAgICAgICAgY2hpbGRyZW46IHt9LAogICAgICAgICAgc3BlY3M6IHt9CiAgICAgICAgfTsKICAgICAgfQogICAgICBibG9jayA9IGJsb2NrLmNoaWxkcmVuW2RlZi5uYW1lXTsKICAgICAgZGVmaW5pdGlvbnMucHVzaChkZWYubmFtZSk7CiAgICB9KTsKCiAgICB2YXIgaXQgPSBzZWxmLnNwZWNNYXBbc3BlYy5pZF0gPQogICAgICAgICAgICAgYmxvY2suc3BlY3Nbc3BlYy5uYW1lXSA9CiAgICAgICAgICAgICBuZXcgYW5ndWxhci5zY2VuYXJpby5PYmplY3RNb2RlbC5TcGVjKHNwZWMuaWQsIHNwZWMubmFtZSwgZGVmaW5pdGlvbnMpOwoKICAgIC8vIGZvcndhcmQgdGhlIGV2ZW50CiAgICBzZWxmLmVtaXQoJ1NwZWNCZWdpbicsIGl0KTsKICB9KTsKCiAgcnVubmVyLm9uKCdTcGVjRXJyb3InLCBmdW5jdGlvbihzcGVjLCBlcnJvcikgewogICAgdmFyIGl0ID0gc2VsZi5nZXRTcGVjKHNwZWMuaWQpOwogICAgaXQuc3RhdHVzID0gJ2Vycm9yJzsKICAgIGl0LmVycm9yID0gZXJyb3I7CgogICAgLy8gZm9yd2FyZCB0aGUgZXZlbnQKICAgIHNlbGYuZW1pdCgnU3BlY0Vycm9yJywgaXQsIGVycm9yKTsKICB9KTsKCiAgcnVubmVyLm9uKCdTcGVjRW5kJywgZnVuY3Rpb24oc3BlYykgewogICAgdmFyIGl0ID0gc2VsZi5nZXRTcGVjKHNwZWMuaWQpOwogICAgY29tcGxldGUoaXQpOwoKICAgIC8vIGZvcndhcmQgdGhlIGV2ZW50CiAgICBzZWxmLmVtaXQoJ1NwZWNFbmQnLCBpdCk7CiAgfSk7CgogIHJ1bm5lci5vbignU3RlcEJlZ2luJywgZnVuY3Rpb24oc3BlYywgc3RlcCkgewogICAgdmFyIGl0ID0gc2VsZi5nZXRTcGVjKHNwZWMuaWQpOwogICAgdmFyIHN0ZXAgPSBuZXcgYW5ndWxhci5zY2VuYXJpby5PYmplY3RNb2RlbC5TdGVwKHN0ZXAubmFtZSk7CiAgICBpdC5zdGVwcy5wdXNoKHN0ZXApOwoKICAgIC8vIGZvcndhcmQgdGhlIGV2ZW50CiAgICBzZWxmLmVtaXQoJ1N0ZXBCZWdpbicsIGl0LCBzdGVwKTsKICB9KTsKCiAgcnVubmVyLm9uKCdTdGVwRW5kJywgZnVuY3Rpb24oc3BlYywgc3RlcCkgewogICAgdmFyIGl0ID0gc2VsZi5nZXRTcGVjKHNwZWMuaWQpOwogICAgdmFyIHN0ZXAgPSBpdC5nZXRMYXN0U3RlcCgpOwogICAgaWYgKHN0ZXAubmFtZSAhPT0gc3RlcC5uYW1lKQogICAgICB0aHJvdyAnRXZlbnRzIGZpcmVkIGluIHRoZSB3cm9uZyBvcmRlci4gU3RlcCBuYW1lcyBkb25cJ3QgbWF0Y2guJzsKICAgIGNvbXBsZXRlKHN0ZXApOwoKICAgIC8vIGZvcndhcmQgdGhlIGV2ZW50CiAgICBzZWxmLmVtaXQoJ1N0ZXBFbmQnLCBpdCwgc3RlcCk7CiAgfSk7CgogIHJ1bm5lci5vbignU3RlcEZhaWx1cmUnLCBmdW5jdGlvbihzcGVjLCBzdGVwLCBlcnJvcikgewogICAgdmFyIGl0ID0gc2VsZi5nZXRTcGVjKHNwZWMuaWQpLAogICAgICAgIG1vZGVsU3RlcCA9IGl0LmdldExhc3RTdGVwKCk7CgogICAgbW9kZWxTdGVwLnNldEVycm9yU3RhdHVzKCdmYWlsdXJlJywgZXJyb3IsIHN0ZXAubGluZSgpKTsKICAgIGl0LnNldFN0YXR1c0Zyb21TdGVwKG1vZGVsU3RlcCk7CgogICAgLy8gZm9yd2FyZCB0aGUgZXZlbnQKICAgIHNlbGYuZW1pdCgnU3RlcEZhaWx1cmUnLCBpdCwgbW9kZWxTdGVwLCBlcnJvcik7CiAgfSk7CgogIHJ1bm5lci5vbignU3RlcEVycm9yJywgZnVuY3Rpb24oc3BlYywgc3RlcCwgZXJyb3IpIHsKICAgIHZhciBpdCA9IHNlbGYuZ2V0U3BlYyhzcGVjLmlkKSwKICAgICAgICBtb2RlbFN0ZXAgPSBpdC5nZXRMYXN0U3RlcCgpOwoKICAgIG1vZGVsU3RlcC5zZXRFcnJvclN0YXR1cygnZXJyb3InLCBlcnJvciwgc3RlcC5saW5lKCkpOwogICAgaXQuc2V0U3RhdHVzRnJvbVN0ZXAobW9kZWxTdGVwKTsKCiAgICAvLyBmb3J3YXJkIHRoZSBldmVudAogICAgc2VsZi5lbWl0KCdTdGVwRXJyb3InLCBpdCwgbW9kZWxTdGVwLCBlcnJvcik7CiAgfSk7CgogIHJ1bm5lci5vbignUnVubmVyRW5kJywgZnVuY3Rpb24oKSB7CiAgICBzZWxmLmVtaXQoJ1J1bm5lckVuZCcpOwogIH0pOwoKICBmdW5jdGlvbiBjb21wbGV0ZShpdGVtKSB7CiAgICBpdGVtLmVuZFRpbWUgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTsKICAgIGl0ZW0uZHVyYXRpb24gPSBpdGVtLmVuZFRpbWUgLSBpdGVtLnN0YXJ0VGltZTsKICAgIGl0ZW0uc3RhdHVzID0gaXRlbS5zdGF0dXMgfHwgJ3N1Y2Nlc3MnOwogIH0KfTsKCi8qKgogKiBBZGRzIGEgbGlzdGVuZXIgZm9yIGFuIGV2ZW50LgogKgogKiBAcGFyYW0ge3N0cmluZ30gZXZlbnROYW1lIE5hbWUgb2YgdGhlIGV2ZW50IHRvIGFkZCBhIGhhbmRsZXIgZm9yCiAqIEBwYXJhbSB7RnVuY3Rpb259IGxpc3RlbmVyIEZ1bmN0aW9uIHRoYXQgd2lsbCBiZSBjYWxsZWQgd2hlbiBldmVudCBpcyBmaXJlZAogKi8KYW5ndWxhci5zY2VuYXJpby5PYmplY3RNb2RlbC5wcm90b3R5cGUub24gPSBmdW5jdGlvbihldmVudE5hbWUsIGxpc3RlbmVyKSB7CiAgZXZlbnROYW1lID0gZXZlbnROYW1lLnRvTG93ZXJDYXNlKCk7CiAgdGhpcy5saXN0ZW5lcnNbZXZlbnROYW1lXSA9IHRoaXMubGlzdGVuZXJzW2V2ZW50TmFtZV0gfHwgW107CiAgdGhpcy5saXN0ZW5lcnNbZXZlbnROYW1lXS5wdXNoKGxpc3RlbmVyKTsKfTsKCi8qKgogKiBFbWl0cyBhbiBldmVudCB3aGljaCBub3RpZmllcyBsaXN0ZW5lcnMgYW5kIHBhc3NlcyBleHRyYQogKiBhcmd1bWVudHMuCiAqCiAqIEBwYXJhbSB7c3RyaW5nfSBldmVudE5hbWUgTmFtZSBvZiB0aGUgZXZlbnQgdG8gZmlyZS4KICovCmFuZ3VsYXIuc2NlbmFyaW8uT2JqZWN0TW9kZWwucHJvdG90eXBlLmVtaXQgPSBmdW5jdGlvbihldmVudE5hbWUpIHsKICB2YXIgc2VsZiA9IHRoaXMsCiAgICAgIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpLAogICAgICBldmVudE5hbWUgPSBldmVudE5hbWUudG9Mb3dlckNhc2UoKTsKCiAgaWYgKHRoaXMubGlzdGVuZXJzW2V2ZW50TmFtZV0pIHsKICAgIGFuZ3VsYXIuZm9yRWFjaCh0aGlzLmxpc3RlbmVyc1tldmVudE5hbWVdLCBmdW5jdGlvbihsaXN0ZW5lcikgewogICAgICBsaXN0ZW5lci5hcHBseShzZWxmLCBhcmdzKTsKICAgIH0pOwogIH0KfTsKCi8qKgogKiBDb21wdXRlcyB0aGUgcGF0aCBvZiBkZWZpbml0aW9uIGRlc2NyaWJlIGJsb2NrcyB0aGF0IHdyYXAgYXJvdW5kCiAqIHRoaXMgc3BlYy4KICoKICogQHBhcmFtIHNwZWMgU3BlYyB0byBjb21wdXRlIHRoZSBwYXRoIGZvci4KICogQHJldHVybiB7QXJyYXk8RGVzY3JpYmU+fSBUaGUgZGVzY3JpYmUgYmxvY2sgcGF0aAogKi8KYW5ndWxhci5zY2VuYXJpby5PYmplY3RNb2RlbC5wcm90b3R5cGUuZ2V0RGVmaW5pdGlvblBhdGggPSBmdW5jdGlvbihzcGVjKSB7CiAgdmFyIHBhdGggPSBbXTsKICB2YXIgY3VycmVudERlZmluaXRpb24gPSBzcGVjLmRlZmluaXRpb247CiAgd2hpbGUgKGN1cnJlbnREZWZpbml0aW9uICYmIGN1cnJlbnREZWZpbml0aW9uLm5hbWUpIHsKICAgIHBhdGgudW5zaGlmdChjdXJyZW50RGVmaW5pdGlvbik7CiAgICBjdXJyZW50RGVmaW5pdGlvbiA9IGN1cnJlbnREZWZpbml0aW9uLnBhcmVudDsKICB9CiAgcmV0dXJuIHBhdGg7Cn07CgovKioKICogR2V0cyBhIHNwZWMgYnkgaWQuCiAqCiAqIEBwYXJhbSB7c3RyaW5nfSBUaGUgaWQgb2YgdGhlIHNwZWMgdG8gZ2V0IHRoZSBvYmplY3QgZm9yLgogKiBAcmV0dXJuIHtPYmplY3R9IHRoZSBTcGVjIGluc3RhbmNlCiAqLwphbmd1bGFyLnNjZW5hcmlvLk9iamVjdE1vZGVsLnByb3RvdHlwZS5nZXRTcGVjID0gZnVuY3Rpb24oaWQpIHsKICByZXR1cm4gdGhpcy5zcGVjTWFwW2lkXTsKfTsKCi8qKgogKiBBIHNpbmdsZSBpdCBibG9jay4KICoKICogQHBhcmFtIHtzdHJpbmd9IGlkIElkIG9mIHRoZSBzcGVjCiAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIE5hbWUgb2YgdGhlIHNwZWMKICogQHBhcmFtIHtBcnJheTxzdHJpbmc+PX0gZGVmaW5pdGlvbk5hbWVzIExpc3Qgb2YgYWxsIGRlc2NyaWJlIGJsb2NrIG5hbWVzIHRoYXQgd3JhcCB0aGlzIHNwZWMKICovCmFuZ3VsYXIuc2NlbmFyaW8uT2JqZWN0TW9kZWwuU3BlYyA9IGZ1bmN0aW9uKGlkLCBuYW1lLCBkZWZpbml0aW9uTmFtZXMpIHsKICB0aGlzLmlkID0gaWQ7CiAgdGhpcy5uYW1lID0gbmFtZTsKICB0aGlzLnN0YXJ0VGltZSA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpOwogIHRoaXMuc3RlcHMgPSBbXTsKICB0aGlzLmZ1bGxEZWZpbml0aW9uTmFtZSA9IChkZWZpbml0aW9uTmFtZXMgfHwgW10pLmpvaW4oJyAnKTsKfTsKCi8qKgogKiBBZGRzIGEgbmV3IHN0ZXAgdG8gdGhlIFNwZWMuCiAqCiAqIEBwYXJhbSB7c3RyaW5nfSBzdGVwIE5hbWUgb2YgdGhlIHN0ZXAgKHJlYWxseSBuYW1lIG9mIHRoZSBmdXR1cmUpCiAqIEByZXR1cm4ge09iamVjdH0gdGhlIGFkZGVkIHN0ZXAKICovCmFuZ3VsYXIuc2NlbmFyaW8uT2JqZWN0TW9kZWwuU3BlYy5wcm90b3R5cGUuYWRkU3RlcCA9IGZ1bmN0aW9uKG5hbWUpIHsKICB2YXIgc3RlcCA9IG5ldyBhbmd1bGFyLnNjZW5hcmlvLk9iamVjdE1vZGVsLlN0ZXAobmFtZSk7CiAgdGhpcy5zdGVwcy5wdXNoKHN0ZXApOwogIHJldHVybiBzdGVwOwp9OwoKLyoqCiAqIEdldHMgdGhlIG1vc3QgcmVjZW50IHN0ZXAuCiAqCiAqIEByZXR1cm4ge09iamVjdH0gdGhlIHN0ZXAKICovCmFuZ3VsYXIuc2NlbmFyaW8uT2JqZWN0TW9kZWwuU3BlYy5wcm90b3R5cGUuZ2V0TGFzdFN0ZXAgPSBmdW5jdGlvbigpIHsKICByZXR1cm4gdGhpcy5zdGVwc1t0aGlzLnN0ZXBzLmxlbmd0aC0xXTsKfTsKCi8qKgogKiBTZXQgc3RhdHVzIG9mIHRoZSBTcGVjIGZyb20gZ2l2ZW4gU3RlcAogKgogKiBAcGFyYW0ge2FuZ3VsYXIuc2NlbmFyaW8uT2JqZWN0TW9kZWwuU3RlcH0gc3RlcAogKi8KYW5ndWxhci5zY2VuYXJpby5PYmplY3RNb2RlbC5TcGVjLnByb3RvdHlwZS5zZXRTdGF0dXNGcm9tU3RlcCA9IGZ1bmN0aW9uKHN0ZXApIHsKICBpZiAoIXRoaXMuc3RhdHVzIHx8IHN0ZXAuc3RhdHVzID09ICdlcnJvcicpIHsKICAgIHRoaXMuc3RhdHVzID0gc3RlcC5zdGF0dXM7CiAgICB0aGlzLmVycm9yID0gc3RlcC5lcnJvcjsKICAgIHRoaXMubGluZSA9IHN0ZXAubGluZTsKICB9Cn07CgovKioKICogQSBzaW5nbGUgc3RlcCBpbnNpZGUgYSBTcGVjLgogKgogKiBAcGFyYW0ge3N0cmluZ30gc3RlcCBOYW1lIG9mIHRoZSBzdGVwCiAqLwphbmd1bGFyLnNjZW5hcmlvLk9iamVjdE1vZGVsLlN0ZXAgPSBmdW5jdGlvbihuYW1lKSB7CiAgdGhpcy5uYW1lID0gbmFtZTsKICB0aGlzLnN0YXJ0VGltZSA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpOwp9OwoKLyoqCiAqIEhlbHBlciBtZXRob2QgZm9yIHNldHRpbmcgYWxsIGVycm9yIHN0YXR1cyByZWxhdGVkIHByb3BlcnRpZXMKICoKICogQHBhcmFtIHtzdHJpbmd9IHN0YXR1cwogKiBAcGFyYW0ge3N0cmluZ30gZXJyb3IKICogQHBhcmFtIHtzdHJpbmd9IGxpbmUKICovCmFuZ3VsYXIuc2NlbmFyaW8uT2JqZWN0TW9kZWwuU3RlcC5wcm90b3R5cGUuc2V0RXJyb3JTdGF0dXMgPSBmdW5jdGlvbihzdGF0dXMsIGVycm9yLCBsaW5lKSB7CiAgdGhpcy5zdGF0dXMgPSBzdGF0dXM7CiAgdGhpcy5lcnJvciA9IGVycm9yOwogIHRoaXMubGluZSA9IGxpbmU7Cn07Cid1c2Ugc3RyaWN0JzsKCi8qKgogKiBUaGUgcmVwcmVzZW50YXRpb24gb2YgZGVmaW5lIGJsb2Nrcy4gRG9uJ3QgdXNlZCBkaXJlY3RseSwgaW5zdGVhZCB1c2UKICogZGVmaW5lKCkgaW4geW91ciB0ZXN0cy4KICoKICogQHBhcmFtIHtzdHJpbmd9IGRlc2NOYW1lIE5hbWUgb2YgdGhlIGJsb2NrCiAqIEBwYXJhbSB7T2JqZWN0fSBwYXJlbnQgZGVzY3JpYmUgb3IgdW5kZWZpbmVkIGlmIHRoZSByb290LgogKi8KYW5ndWxhci5zY2VuYXJpby5EZXNjcmliZSA9IGZ1bmN0aW9uKGRlc2NOYW1lLCBwYXJlbnQpIHsKICB0aGlzLm9ubHkgPSBwYXJlbnQgJiYgcGFyZW50Lm9ubHk7CiAgdGhpcy5iZWZvcmVFYWNoRm5zID0gW107CiAgdGhpcy5hZnRlckVhY2hGbnMgPSBbXTsKICB0aGlzLml0cyA9IFtdOwogIHRoaXMuY2hpbGRyZW4gPSBbXTsKICB0aGlzLm5hbWUgPSBkZXNjTmFtZTsKICB0aGlzLnBhcmVudCA9IHBhcmVudDsKICB0aGlzLmlkID0gYW5ndWxhci5zY2VuYXJpby5EZXNjcmliZS5pZCsrOwoKICAvKioKICAgKiBDYWxscyBhbGwgYmVmb3JlIGZ1bmN0aW9ucy4KICAgKi8KICB2YXIgYmVmb3JlRWFjaEZucyA9IHRoaXMuYmVmb3JlRWFjaEZuczsKICB0aGlzLnNldHVwQmVmb3JlID0gZnVuY3Rpb24oKSB7CiAgICBpZiAocGFyZW50KSBwYXJlbnQuc2V0dXBCZWZvcmUuY2FsbCh0aGlzKTsKICAgIGFuZ3VsYXIuZm9yRWFjaChiZWZvcmVFYWNoRm5zLCBmdW5jdGlvbihmbikgeyBmbi5jYWxsKHRoaXMpOyB9LCB0aGlzKTsKICB9OwoKICAvKioKICAgKiBDYWxscyBhbGwgYWZ0ZXIgZnVuY3Rpb25zLgogICAqLwogIHZhciBhZnRlckVhY2hGbnMgPSB0aGlzLmFmdGVyRWFjaEZuczsKICB0aGlzLnNldHVwQWZ0ZXIgID0gZnVuY3Rpb24oKSB7CiAgICBhbmd1bGFyLmZvckVhY2goYWZ0ZXJFYWNoRm5zLCBmdW5jdGlvbihmbikgeyBmbi5jYWxsKHRoaXMpOyB9LCB0aGlzKTsKICAgIGlmIChwYXJlbnQpIHBhcmVudC5zZXR1cEFmdGVyLmNhbGwodGhpcyk7CiAgfTsKfTsKCi8vIFNoYXJlZCBVbmlxdWUgSUQgZ2VuZXJhdG9yIGZvciBldmVyeSBkZXNjcmliZSBibG9jawphbmd1bGFyLnNjZW5hcmlvLkRlc2NyaWJlLmlkID0gMDsKCi8vIFNoYXJlZCBVbmlxdWUgSUQgZ2VuZXJhdG9yIGZvciBldmVyeSBpdCAoc3BlYykKYW5ndWxhci5zY2VuYXJpby5EZXNjcmliZS5zcGVjSWQgPSAwOwoKLyoqCiAqIERlZmluZXMgYSBibG9jayB0byBleGVjdXRlIGJlZm9yZSBlYWNoIGl0IG9yIG5lc3RlZCBkZXNjcmliZS4KICoKICogQHBhcmFtIHtGdW5jdGlvbn0gYm9keSBCb2R5IG9mIHRoZSBibG9jay4KICovCmFuZ3VsYXIuc2NlbmFyaW8uRGVzY3JpYmUucHJvdG90eXBlLmJlZm9yZUVhY2ggPSBmdW5jdGlvbihib2R5KSB7CiAgdGhpcy5iZWZvcmVFYWNoRm5zLnB1c2goYm9keSk7Cn07CgovKioKICogRGVmaW5lcyBhIGJsb2NrIHRvIGV4ZWN1dGUgYWZ0ZXIgZWFjaCBpdCBvciBuZXN0ZWQgZGVzY3JpYmUuCiAqCiAqIEBwYXJhbSB7RnVuY3Rpb259IGJvZHkgQm9keSBvZiB0aGUgYmxvY2suCiAqLwphbmd1bGFyLnNjZW5hcmlvLkRlc2NyaWJlLnByb3RvdHlwZS5hZnRlckVhY2ggPSBmdW5jdGlvbihib2R5KSB7CiAgdGhpcy5hZnRlckVhY2hGbnMucHVzaChib2R5KTsKfTsKCi8qKgogKiBDcmVhdGVzIGEgbmV3IGRlc2NyaWJlIGJsb2NrIHRoYXQncyBhIGNoaWxkIG9mIHRoaXMgb25lLgogKgogKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBOYW1lIG9mIHRoZSBibG9jay4gQXBwZW5kZWQgdG8gdGhlIHBhcmVudCBibG9jaydzIG5hbWUuCiAqIEBwYXJhbSB7RnVuY3Rpb259IGJvZHkgQm9keSBvZiB0aGUgYmxvY2suCiAqLwphbmd1bGFyLnNjZW5hcmlvLkRlc2NyaWJlLnByb3RvdHlwZS5kZXNjcmliZSA9IGZ1bmN0aW9uKG5hbWUsIGJvZHkpIHsKICB2YXIgY2hpbGQgPSBuZXcgYW5ndWxhci5zY2VuYXJpby5EZXNjcmliZShuYW1lLCB0aGlzKTsKICB0aGlzLmNoaWxkcmVuLnB1c2goY2hpbGQpOwogIGJvZHkuY2FsbChjaGlsZCk7Cn07CgovKioKICogU2FtZSBhcyBkZXNjcmliZSgpIGJ1dCBtYWtlcyBkZGVzY3JpYmUgYmxvY2tzIHRoZSBvbmx5IHRvIHJ1bi4KICoKICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgTmFtZSBvZiB0aGUgdGVzdC4KICogQHBhcmFtIHtGdW5jdGlvbn0gYm9keSBCb2R5IG9mIHRoZSBibG9jay4KICovCmFuZ3VsYXIuc2NlbmFyaW8uRGVzY3JpYmUucHJvdG90eXBlLmRkZXNjcmliZSA9IGZ1bmN0aW9uKG5hbWUsIGJvZHkpIHsKICB2YXIgY2hpbGQgPSBuZXcgYW5ndWxhci5zY2VuYXJpby5EZXNjcmliZShuYW1lLCB0aGlzKTsKICBjaGlsZC5vbmx5ID0gdHJ1ZTsKICB0aGlzLmNoaWxkcmVuLnB1c2goY2hpbGQpOwogIGJvZHkuY2FsbChjaGlsZCk7Cn07CgovKioKICogVXNlIHRvIGRpc2FibGUgYSBkZXNjcmliZSBibG9jay4KICovCmFuZ3VsYXIuc2NlbmFyaW8uRGVzY3JpYmUucHJvdG90eXBlLnhkZXNjcmliZSA9IGFuZ3VsYXIubm9vcDsKCi8qKgogKiBEZWZpbmVzIGEgdGVzdC4KICoKICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgTmFtZSBvZiB0aGUgdGVzdC4KICogQHBhcmFtIHtGdW5jdGlvbn0gdm9keSBCb2R5IG9mIHRoZSBibG9jay4KICovCmFuZ3VsYXIuc2NlbmFyaW8uRGVzY3JpYmUucHJvdG90eXBlLml0ID0gZnVuY3Rpb24obmFtZSwgYm9keSkgewogIHRoaXMuaXRzLnB1c2goewogICAgaWQ6IGFuZ3VsYXIuc2NlbmFyaW8uRGVzY3JpYmUuc3BlY0lkKyssCiAgICBkZWZpbml0aW9uOiB0aGlzLAogICAgb25seTogdGhpcy5vbmx5LAogICAgbmFtZTogbmFtZSwKICAgIGJlZm9yZTogdGhpcy5zZXR1cEJlZm9yZSwKICAgIGJvZHk6IGJvZHksCiAgICBhZnRlcjogdGhpcy5zZXR1cEFmdGVyCiAgfSk7Cn07CgovKioKICogU2FtZSBhcyBpdCgpIGJ1dCBtYWtlcyBpaXQgdGVzdHMgdGhlIG9ubHkgdGVzdCB0byBydW4uCiAqCiAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIE5hbWUgb2YgdGhlIHRlc3QuCiAqIEBwYXJhbSB7RnVuY3Rpb259IGJvZHkgQm9keSBvZiB0aGUgYmxvY2suCiAqLwphbmd1bGFyLnNjZW5hcmlvLkRlc2NyaWJlLnByb3RvdHlwZS5paXQgPSBmdW5jdGlvbihuYW1lLCBib2R5KSB7CiAgdGhpcy5pdC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIHRoaXMuaXRzW3RoaXMuaXRzLmxlbmd0aC0xXS5vbmx5ID0gdHJ1ZTsKfTsKCi8qKgogKiBVc2UgdG8gZGlzYWJsZSBhIHRlc3QgYmxvY2suCiAqLwphbmd1bGFyLnNjZW5hcmlvLkRlc2NyaWJlLnByb3RvdHlwZS54aXQgPSBhbmd1bGFyLm5vb3A7CgovKioKICogR2V0cyBhbiBhcnJheSBvZiBmdW5jdGlvbnMgcmVwcmVzZW50aW5nIGFsbCB0aGUgdGVzdHMgKHJlY3Vyc2l2ZWx5KS4KICogdGhhdCBjYW4gYmUgZXhlY3V0ZWQgd2l0aCBTcGVjUnVubmVyJ3MuCiAqCiAqIEByZXR1cm4ge0FycmF5PE9iamVjdD59IEFycmF5IG9mIGl0IGJsb2NrcyB7CiAqICAgZGVmaW5pdGlvbiA6IE9iamVjdCAvLyBwYXJlbnQgRGVzY3JpYmUKICogICBvbmx5OiBib29sZWFuCiAqICAgbmFtZTogc3RyaW5nCiAqICAgYmVmb3JlOiBGdW5jdGlvbgogKiAgIGJvZHk6IEZ1bmN0aW9uCiAqICAgYWZ0ZXI6IEZ1bmN0aW9uCiAqICB9CiAqLwphbmd1bGFyLnNjZW5hcmlvLkRlc2NyaWJlLnByb3RvdHlwZS5nZXRTcGVjcyA9IGZ1bmN0aW9uKCkgewogIHZhciBzcGVjcyA9IGFyZ3VtZW50c1swXSB8fCBbXTsKICBhbmd1bGFyLmZvckVhY2godGhpcy5jaGlsZHJlbiwgZnVuY3Rpb24oY2hpbGQpIHsKICAgIGNoaWxkLmdldFNwZWNzKHNwZWNzKTsKICB9KTsKICBhbmd1bGFyLmZvckVhY2godGhpcy5pdHMsIGZ1bmN0aW9uKGl0KSB7CiAgICBzcGVjcy5wdXNoKGl0KTsKICB9KTsKICB2YXIgb25seSA9IFtdOwogIGFuZ3VsYXIuZm9yRWFjaChzcGVjcywgZnVuY3Rpb24oaXQpIHsKICAgIGlmIChpdC5vbmx5KSB7CiAgICAgIG9ubHkucHVzaChpdCk7CiAgICB9CiAgfSk7CiAgcmV0dXJuIChvbmx5Lmxlbmd0aCAmJiBvbmx5KSB8fCBzcGVjczsKfTsKJ3VzZSBzdHJpY3QnOwoKLyoqCiAqIFJ1bm5lciBmb3Igc2NlbmFyaW9zCiAqCiAqIEhhcyB0byBiZSBpbml0aWFsaXplZCBiZWZvcmUgYW55IHRlc3QgaXMgbG9hZGVkLAogKiBiZWNhdXNlIGl0IHB1Ymxpc2hlcyB0aGUgQVBJIGludG8gd2luZG93IChnbG9iYWwgc3BhY2UpLgogKi8KYW5ndWxhci5zY2VuYXJpby5SdW5uZXIgPSBmdW5jdGlvbigkd2luZG93KSB7CiAgdGhpcy5saXN0ZW5lcnMgPSBbXTsKICB0aGlzLiR3aW5kb3cgPSAkd2luZG93OwogIHRoaXMucm9vdERlc2NyaWJlID0gbmV3IGFuZ3VsYXIuc2NlbmFyaW8uRGVzY3JpYmUoKTsKICB0aGlzLmN1cnJlbnREZXNjcmliZSA9IHRoaXMucm9vdERlc2NyaWJlOwogIHRoaXMuYXBpID0gewogICAgaXQ6IHRoaXMuaXQsCiAgICBpaXQ6IHRoaXMuaWl0LAogICAgeGl0OiBhbmd1bGFyLm5vb3AsCiAgICBkZXNjcmliZTogdGhpcy5kZXNjcmliZSwKICAgIGRkZXNjcmliZTogdGhpcy5kZGVzY3JpYmUsCiAgICB4ZGVzY3JpYmU6IGFuZ3VsYXIubm9vcCwKICAgIGJlZm9yZUVhY2g6IHRoaXMuYmVmb3JlRWFjaCwKICAgIGFmdGVyRWFjaDogdGhpcy5hZnRlckVhY2gKICB9OwogIGFuZ3VsYXIuZm9yRWFjaCh0aGlzLmFwaSwgYW5ndWxhci5iaW5kKHRoaXMsIGZ1bmN0aW9uKGZuLCBrZXkpIHsKICAgIHRoaXMuJHdpbmRvd1trZXldID0gYW5ndWxhci5iaW5kKHRoaXMsIGZuKTsKICB9KSk7Cn07CgovKioKICogRW1pdHMgYW4gZXZlbnQgd2hpY2ggbm90aWZpZXMgbGlzdGVuZXJzIGFuZCBwYXNzZXMgZXh0cmEKICogYXJndW1lbnRzLgogKgogKiBAcGFyYW0ge3N0cmluZ30gZXZlbnROYW1lIE5hbWUgb2YgdGhlIGV2ZW50IHRvIGZpcmUuCiAqLwphbmd1bGFyLnNjZW5hcmlvLlJ1bm5lci5wcm90b3R5cGUuZW1pdCA9IGZ1bmN0aW9uKGV2ZW50TmFtZSkgewogIHZhciBzZWxmID0gdGhpczsKICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CiAgZXZlbnROYW1lID0gZXZlbnROYW1lLnRvTG93ZXJDYXNlKCk7CiAgaWYgKCF0aGlzLmxpc3RlbmVyc1tldmVudE5hbWVdKQogICAgcmV0dXJuOwogIGFuZ3VsYXIuZm9yRWFjaCh0aGlzLmxpc3RlbmVyc1tldmVudE5hbWVdLCBmdW5jdGlvbihsaXN0ZW5lcikgewogICAgbGlzdGVuZXIuYXBwbHkoc2VsZiwgYXJncyk7CiAgfSk7Cn07CgovKioKICogQWRkcyBhIGxpc3RlbmVyIGZvciBhbiBldmVudC4KICoKICogQHBhcmFtIHtzdHJpbmd9IGV2ZW50TmFtZSBUaGUgbmFtZSBvZiB0aGUgZXZlbnQgdG8gYWRkIGEgaGFuZGxlciBmb3IKICogQHBhcmFtIHtzdHJpbmd9IGxpc3RlbmVyIFRoZSBmbiguLi4pIHRoYXQgdGFrZXMgdGhlIGV4dHJhIGFyZ3VtZW50cyBmcm9tIGVtaXQoKQogKi8KYW5ndWxhci5zY2VuYXJpby5SdW5uZXIucHJvdG90eXBlLm9uID0gZnVuY3Rpb24oZXZlbnROYW1lLCBsaXN0ZW5lcikgewogIGV2ZW50TmFtZSA9IGV2ZW50TmFtZS50b0xvd2VyQ2FzZSgpOwogIHRoaXMubGlzdGVuZXJzW2V2ZW50TmFtZV0gPSB0aGlzLmxpc3RlbmVyc1tldmVudE5hbWVdIHx8IFtdOwogIHRoaXMubGlzdGVuZXJzW2V2ZW50TmFtZV0ucHVzaChsaXN0ZW5lcik7Cn07CgovKioKICogRGVmaW5lcyBhIGRlc2NyaWJlIGJsb2NrIG9mIGEgc3BlYy4KICoKICogQHNlZSBEZXNjcmliZS5qcwogKgogKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBOYW1lIG9mIHRoZSBibG9jawogKiBAcGFyYW0ge0Z1bmN0aW9ufSBib2R5IEJvZHkgb2YgdGhlIGJsb2NrCiAqLwphbmd1bGFyLnNjZW5hcmlvLlJ1bm5lci5wcm90b3R5cGUuZGVzY3JpYmUgPSBmdW5jdGlvbihuYW1lLCBib2R5KSB7CiAgdmFyIHNlbGYgPSB0aGlzOwogIHRoaXMuY3VycmVudERlc2NyaWJlLmRlc2NyaWJlKG5hbWUsIGZ1bmN0aW9uKCkgewogICAgdmFyIHBhcmVudERlc2NyaWJlID0gc2VsZi5jdXJyZW50RGVzY3JpYmU7CiAgICBzZWxmLmN1cnJlbnREZXNjcmliZSA9IHRoaXM7CiAgICB0cnkgewogICAgICBib2R5LmNhbGwodGhpcyk7CiAgICB9IGZpbmFsbHkgewogICAgICBzZWxmLmN1cnJlbnREZXNjcmliZSA9IHBhcmVudERlc2NyaWJlOwogICAgfQogIH0pOwp9OwoKLyoqCiAqIFNhbWUgYXMgZGVzY3JpYmUsIGJ1dCBtYWtlcyBkZGVzY3JpYmUgdGhlIG9ubHkgYmxvY2tzIHRvIHJ1bi4KICoKICogQHNlZSBEZXNjcmliZS5qcwogKgogKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBOYW1lIG9mIHRoZSBibG9jawogKiBAcGFyYW0ge0Z1bmN0aW9ufSBib2R5IEJvZHkgb2YgdGhlIGJsb2NrCiAqLwphbmd1bGFyLnNjZW5hcmlvLlJ1bm5lci5wcm90b3R5cGUuZGRlc2NyaWJlID0gZnVuY3Rpb24obmFtZSwgYm9keSkgewogIHZhciBzZWxmID0gdGhpczsKICB0aGlzLmN1cnJlbnREZXNjcmliZS5kZGVzY3JpYmUobmFtZSwgZnVuY3Rpb24oKSB7CiAgICB2YXIgcGFyZW50RGVzY3JpYmUgPSBzZWxmLmN1cnJlbnREZXNjcmliZTsKICAgIHNlbGYuY3VycmVudERlc2NyaWJlID0gdGhpczsKICAgIHRyeSB7CiAgICAgIGJvZHkuY2FsbCh0aGlzKTsKICAgIH0gZmluYWxseSB7CiAgICAgIHNlbGYuY3VycmVudERlc2NyaWJlID0gcGFyZW50RGVzY3JpYmU7CiAgICB9CiAgfSk7Cn07CgovKioKICogRGVmaW5lcyBhIHRlc3QgaW4gYSBkZXNjcmliZSBibG9jayBvZiBhIHNwZWMuCiAqCiAqIEBzZWUgRGVzY3JpYmUuanMKICoKICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgTmFtZSBvZiB0aGUgYmxvY2sKICogQHBhcmFtIHtGdW5jdGlvbn0gYm9keSBCb2R5IG9mIHRoZSBibG9jawogKi8KYW5ndWxhci5zY2VuYXJpby5SdW5uZXIucHJvdG90eXBlLml0ID0gZnVuY3Rpb24obmFtZSwgYm9keSkgewogIHRoaXMuY3VycmVudERlc2NyaWJlLml0KG5hbWUsIGJvZHkpOwp9OwoKLyoqCiAqIFNhbWUgYXMgaXQsIGJ1dCBtYWtlcyBpaXQgdGVzdHMgdGhlIG9ubHkgdGVzdHMgdG8gcnVuLgogKgogKiBAc2VlIERlc2NyaWJlLmpzCiAqCiAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIE5hbWUgb2YgdGhlIGJsb2NrCiAqIEBwYXJhbSB7RnVuY3Rpb259IGJvZHkgQm9keSBvZiB0aGUgYmxvY2sKICovCmFuZ3VsYXIuc2NlbmFyaW8uUnVubmVyLnByb3RvdHlwZS5paXQgPSBmdW5jdGlvbihuYW1lLCBib2R5KSB7CiAgdGhpcy5jdXJyZW50RGVzY3JpYmUuaWl0KG5hbWUsIGJvZHkpOwp9OwoKLyoqCiAqIERlZmluZXMgYSBmdW5jdGlvbiB0byBiZSBjYWxsZWQgYmVmb3JlIGVhY2ggaXQgYmxvY2sgaW4gdGhlIGRlc2NyaWJlCiAqIChhbmQgYmVmb3JlIGFsbCBuZXN0ZWQgZGVzY3JpYmVzKS4KICoKICogQHNlZSBEZXNjcmliZS5qcwogKgogKiBAcGFyYW0ge0Z1bmN0aW9ufSBDYWxsYmFjayB0byBleGVjdXRlCiAqLwphbmd1bGFyLnNjZW5hcmlvLlJ1bm5lci5wcm90b3R5cGUuYmVmb3JlRWFjaCA9IGZ1bmN0aW9uKGJvZHkpIHsKICB0aGlzLmN1cnJlbnREZXNjcmliZS5iZWZvcmVFYWNoKGJvZHkpOwp9OwoKLyoqCiAqIERlZmluZXMgYSBmdW5jdGlvbiB0byBiZSBjYWxsZWQgYWZ0ZXIgZWFjaCBpdCBibG9jayBpbiB0aGUgZGVzY3JpYmUKICogKGFuZCBiZWZvcmUgYWxsIG5lc3RlZCBkZXNjcmliZXMpLgogKgogKiBAc2VlIERlc2NyaWJlLmpzCiAqCiAqIEBwYXJhbSB7RnVuY3Rpb259IENhbGxiYWNrIHRvIGV4ZWN1dGUKICovCmFuZ3VsYXIuc2NlbmFyaW8uUnVubmVyLnByb3RvdHlwZS5hZnRlckVhY2ggPSBmdW5jdGlvbihib2R5KSB7CiAgdGhpcy5jdXJyZW50RGVzY3JpYmUuYWZ0ZXJFYWNoKGJvZHkpOwp9OwoKLyoqCiAqIENyZWF0ZXMgYSBuZXcgc3BlYyBydW5uZXIuCiAqCiAqIEBwcml2YXRlCiAqIEBwYXJhbSB7T2JqZWN0fSBzY29wZSBwYXJlbnQgc2NvcGUKICovCmFuZ3VsYXIuc2NlbmFyaW8uUnVubmVyLnByb3RvdHlwZS5jcmVhdGVTcGVjUnVubmVyXyA9IGZ1bmN0aW9uKHNjb3BlKSB7CiAgcmV0dXJuIHNjb3BlLiRuZXcoYW5ndWxhci5zY2VuYXJpby5TcGVjUnVubmVyKTsKfTsKCi8qKgogKiBSdW5zIGFsbCB0aGUgbG9hZGVkIHRlc3RzIHdpdGggdGhlIHNwZWNpZmllZCBydW5uZXIgY2xhc3Mgb24gdGhlCiAqIHByb3ZpZGVkIGFwcGxpY2F0aW9uLgogKgogKiBAcGFyYW0ge2FuZ3VsYXIuc2NlbmFyaW8uQXBwbGljYXRpb259IGFwcGxpY2F0aW9uIEFwcCB0byByZW1vdGUgY29udHJvbC4KICovCmFuZ3VsYXIuc2NlbmFyaW8uUnVubmVyLnByb3RvdHlwZS5ydW4gPSBmdW5jdGlvbihhcHBsaWNhdGlvbikgewogIHZhciBzZWxmID0gdGhpczsKICB2YXIgJHJvb3QgPSBhbmd1bGFyLnNjb3BlKHRoaXMpOwogICRyb290LmFwcGxpY2F0aW9uID0gYXBwbGljYXRpb247CiAgdGhpcy5lbWl0KCdSdW5uZXJCZWdpbicpOwogIGFzeW5jRm9yRWFjaCh0aGlzLnJvb3REZXNjcmliZS5nZXRTcGVjcygpLCBmdW5jdGlvbihzcGVjLCBzcGVjRG9uZSkgewogICAgdmFyIGRzbENhY2hlID0ge307CiAgICB2YXIgcnVubmVyID0gc2VsZi5jcmVhdGVTcGVjUnVubmVyXygkcm9vdCk7CiAgICBhbmd1bGFyLmZvckVhY2goYW5ndWxhci5zY2VuYXJpby5kc2wsIGZ1bmN0aW9uKGZuLCBrZXkpIHsKICAgICAgZHNsQ2FjaGVba2V5XSA9IGZuLmNhbGwoJHJvb3QpOwogICAgfSk7CiAgICBhbmd1bGFyLmZvckVhY2goYW5ndWxhci5zY2VuYXJpby5kc2wsIGZ1bmN0aW9uKGZuLCBrZXkpIHsKICAgICAgc2VsZi4kd2luZG93W2tleV0gPSBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgbGluZSA9IGNhbGxlckZpbGUoMyk7CiAgICAgICAgdmFyIHNjb3BlID0gYW5ndWxhci5zY29wZShydW5uZXIpOwoKICAgICAgICAvLyBNYWtlIHRoZSBkc2wgYWNjZXNzaWJsZSBvbiB0aGUgY3VycmVudCBjaGFpbgogICAgICAgIHNjb3BlLmRzbCA9IHt9OwogICAgICAgIGFuZ3VsYXIuZm9yRWFjaChkc2xDYWNoZSwgZnVuY3Rpb24oZm4sIGtleSkgewogICAgICAgICAgc2NvcGUuZHNsW2tleV0gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIGRzbENhY2hlW2tleV0uYXBwbHkoc2NvcGUsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9OwogICAgICAgIH0pOwoKICAgICAgICAvLyBNYWtlIHRoZXNlIG1ldGhvZHMgd29yayBvbiB0aGUgY3VycmVudCBjaGFpbgogICAgICAgIHNjb3BlLmFkZEZ1dHVyZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgQXJyYXkucHJvdG90eXBlLnB1c2guY2FsbChhcmd1bWVudHMsIGxpbmUpOwogICAgICAgICAgcmV0dXJuIGFuZ3VsYXIuc2NlbmFyaW8uU3BlY1J1bm5lci4KICAgICAgICAgICAgcHJvdG90eXBlLmFkZEZ1dHVyZS5hcHBseShzY29wZSwgYXJndW1lbnRzKTsKICAgICAgICB9OwogICAgICAgIHNjb3BlLmFkZEZ1dHVyZUFjdGlvbiA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgQXJyYXkucHJvdG90eXBlLnB1c2guY2FsbChhcmd1bWVudHMsIGxpbmUpOwogICAgICAgICAgcmV0dXJuIGFuZ3VsYXIuc2NlbmFyaW8uU3BlY1J1bm5lci4KICAgICAgICAgICAgcHJvdG90eXBlLmFkZEZ1dHVyZUFjdGlvbi5hcHBseShzY29wZSwgYXJndW1lbnRzKTsKICAgICAgICB9OwoKICAgICAgICByZXR1cm4gc2NvcGUuZHNsW2tleV0uYXBwbHkoc2NvcGUsIGFyZ3VtZW50cyk7CiAgICAgIH07CiAgICB9KTsKICAgIHJ1bm5lci5ydW4oc3BlYywgc3BlY0RvbmUpOwogIH0sCiAgZnVuY3Rpb24oZXJyb3IpIHsKICAgIGlmIChlcnJvcikgewogICAgICBzZWxmLmVtaXQoJ1J1bm5lckVycm9yJywgZXJyb3IpOwogICAgfQogICAgc2VsZi5lbWl0KCdSdW5uZXJFbmQnKTsKICB9KTsKfTsKJ3VzZSBzdHJpY3QnOwoKLyoqCiAqIFRoaXMgY2xhc3MgaXMgdGhlICJ0aGlzIiBvZiB0aGUgaXQvYmVmb3JlRWFjaC9hZnRlckVhY2ggbWV0aG9kLgogKiBSZXNwb25zaWJpbGl0aWVzOgogKiAgIC0gInRoaXMiIGZvciBpdC9iZWZvcmVFYWNoL2FmdGVyRWFjaAogKiAgIC0ga2VlcCBzdGF0ZSBmb3Igc2luZ2xlIGl0L2JlZm9yZUVhY2gvYWZ0ZXJFYWNoIGV4ZWN1dGlvbgogKiAgIC0ga2VlcCB0cmFjayBvZiBhbGwgb2YgdGhlIGZ1dHVyZXMgdG8gZXhlY3V0ZQogKiAgIC0gcnVuIHNpbmdsZSBzcGVjIChleGVjdXRlIGVhY2ggZnV0dXJlKQogKi8KYW5ndWxhci5zY2VuYXJpby5TcGVjUnVubmVyID0gZnVuY3Rpb24oKSB7CiAgdGhpcy5mdXR1cmVzID0gW107CiAgdGhpcy5hZnRlckluZGV4ID0gMDsKfTsKCi8qKgogKiBFeGVjdXRlcyBhIHNwZWMgd2hpY2ggaXMgYW4gaXQgYmxvY2sgd2l0aCBhc3NvY2lhdGVkIGJlZm9yZS9hZnRlciBmdW5jdGlvbnMKICogYmFzZWQgb24gdGhlIGRlc2NyaWJlIG5lc3RpbmcuCiAqCiAqIEBwYXJhbSB7T2JqZWN0fSBzcGVjIEEgc3BlYyBvYmplY3QKICogQHBhcmFtIHtGdW5jdGlvbn0gc3BlY0RvbmUgZnVuY3Rpb24gdGhhdCBpcyBjYWxsZWQgd2hlbiB0aGUgc3BlYyBmaW5zaGVzLiBGdW5jdGlvbihlcnJvciwgaW5kZXgpCiAqLwphbmd1bGFyLnNjZW5hcmlvLlNwZWNSdW5uZXIucHJvdG90eXBlLnJ1biA9IGZ1bmN0aW9uKHNwZWMsIHNwZWNEb25lKSB7CiAgdmFyIHNlbGYgPSB0aGlzOwogIHRoaXMuc3BlYyA9IHNwZWM7CgogIHRoaXMuZW1pdCgnU3BlY0JlZ2luJywgc3BlYyk7CgogIHRyeSB7CiAgICBzcGVjLmJlZm9yZS5jYWxsKHRoaXMpOwogICAgc3BlYy5ib2R5LmNhbGwodGhpcyk7CiAgICB0aGlzLmFmdGVySW5kZXggPSB0aGlzLmZ1dHVyZXMubGVuZ3RoOwogICAgc3BlYy5hZnRlci5jYWxsKHRoaXMpOwogIH0gY2F0Y2ggKGUpIHsKICAgIHRoaXMuZW1pdCgnU3BlY0Vycm9yJywgc3BlYywgZSk7CiAgICB0aGlzLmVtaXQoJ1NwZWNFbmQnLCBzcGVjKTsKICAgIHNwZWNEb25lKCk7CiAgICByZXR1cm47CiAgfQoKICB2YXIgaGFuZGxlRXJyb3IgPSBmdW5jdGlvbihlcnJvciwgZG9uZSkgewogICAgaWYgKHNlbGYuZXJyb3IpIHsKICAgICAgcmV0dXJuIGRvbmUoKTsKICAgIH0KICAgIHNlbGYuZXJyb3IgPSB0cnVlOwogICAgZG9uZShudWxsLCBzZWxmLmFmdGVySW5kZXgpOwogIH07CgogIGFzeW5jRm9yRWFjaCgKICAgIHRoaXMuZnV0dXJlcywKICAgIGZ1bmN0aW9uKGZ1dHVyZSwgZnV0dXJlRG9uZSkgewogICAgICBzZWxmLnN0ZXAgPSBmdXR1cmU7CiAgICAgIHNlbGYuZW1pdCgnU3RlcEJlZ2luJywgc3BlYywgZnV0dXJlKTsKICAgICAgdHJ5IHsKICAgICAgICBmdXR1cmUuZXhlY3V0ZShmdW5jdGlvbihlcnJvcikgewogICAgICAgICAgaWYgKGVycm9yKSB7CiAgICAgICAgICAgIHNlbGYuZW1pdCgnU3RlcEZhaWx1cmUnLCBzcGVjLCBmdXR1cmUsIGVycm9yKTsKICAgICAgICAgICAgc2VsZi5lbWl0KCdTdGVwRW5kJywgc3BlYywgZnV0dXJlKTsKICAgICAgICAgICAgcmV0dXJuIGhhbmRsZUVycm9yKGVycm9yLCBmdXR1cmVEb25lKTsKICAgICAgICAgIH0KICAgICAgICAgIHNlbGYuZW1pdCgnU3RlcEVuZCcsIHNwZWMsIGZ1dHVyZSk7CiAgICAgICAgICBzZWxmLiR3aW5kb3cuc2V0VGltZW91dChmdW5jdGlvbigpIHsgZnV0dXJlRG9uZSgpOyB9LCAwKTsKICAgICAgICB9KTsKICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgIHNlbGYuZW1pdCgnU3RlcEVycm9yJywgc3BlYywgZnV0dXJlLCBlKTsKICAgICAgICBzZWxmLmVtaXQoJ1N0ZXBFbmQnLCBzcGVjLCBmdXR1cmUpOwogICAgICAgIGhhbmRsZUVycm9yKGUsIGZ1dHVyZURvbmUpOwogICAgICB9CiAgICB9LAogICAgZnVuY3Rpb24oZSkgewogICAgICBpZiAoZSkgewogICAgICAgIHNlbGYuZW1pdCgnU3BlY0Vycm9yJywgc3BlYywgZSk7CiAgICAgIH0KICAgICAgc2VsZi5lbWl0KCdTcGVjRW5kJywgc3BlYyk7CiAgICAgIC8vIENhbGwgZG9uZSBpbiBhIHRpbWVvdXQgc28gZXhjZXB0aW9ucyBkb24ndCByZWN1cnNpdmVseQogICAgICAvLyBjYWxsIHRoaXMgZnVuY3Rpb24KICAgICAgc2VsZi4kd2luZG93LnNldFRpbWVvdXQoZnVuY3Rpb24oKSB7IHNwZWNEb25lKCk7IH0sIDApOwogICAgfQogICk7Cn07CgovKioKICogQWRkcyBhIG5ldyBmdXR1cmUgYWN0aW9uLgogKgogKiBOb3RlOiBEbyBub3QgcGFzcyBsaW5lIG1hbnVhbGx5LiBJdCBoYXBwZW5zIGF1dG9tYXRpY2FsbHkuCiAqCiAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIE5hbWUgb2YgdGhlIGZ1dHVyZQogKiBAcGFyYW0ge0Z1bmN0aW9ufSBiZWhhdmlvciBCZWhhdmlvciBvZiB0aGUgZnV0dXJlCiAqIEBwYXJhbSB7RnVuY3Rpb259IGxpbmUgZm4oKSB0aGF0IHJldHVybnMgZmlsZS9saW5lIG51bWJlcgogKi8KYW5ndWxhci5zY2VuYXJpby5TcGVjUnVubmVyLnByb3RvdHlwZS5hZGRGdXR1cmUgPSBmdW5jdGlvbihuYW1lLCBiZWhhdmlvciwgbGluZSkgewogIHZhciBmdXR1cmUgPSBuZXcgYW5ndWxhci5zY2VuYXJpby5GdXR1cmUobmFtZSwgYW5ndWxhci5iaW5kKHRoaXMsIGJlaGF2aW9yKSwgbGluZSk7CiAgdGhpcy5mdXR1cmVzLnB1c2goZnV0dXJlKTsKICByZXR1cm4gZnV0dXJlOwp9OwoKLyoqCiAqIEFkZHMgYSBuZXcgZnV0dXJlIGFjdGlvbiB0byBiZSBleGVjdXRlZCBvbiB0aGUgYXBwbGljYXRpb24gd2luZG93LgogKgogKiBOb3RlOiBEbyBub3QgcGFzcyBsaW5lIG1hbnVhbGx5LiBJdCBoYXBwZW5zIGF1dG9tYXRpY2FsbHkuCiAqCiAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIE5hbWUgb2YgdGhlIGZ1dHVyZQogKiBAcGFyYW0ge0Z1bmN0aW9ufSBiZWhhdmlvciBCZWhhdmlvciBvZiB0aGUgZnV0dXJlCiAqIEBwYXJhbSB7RnVuY3Rpb259IGxpbmUgZm4oKSB0aGF0IHJldHVybnMgZmlsZS9saW5lIG51bWJlcgogKi8KYW5ndWxhci5zY2VuYXJpby5TcGVjUnVubmVyLnByb3RvdHlwZS5hZGRGdXR1cmVBY3Rpb24gPSBmdW5jdGlvbihuYW1lLCBiZWhhdmlvciwgbGluZSkgewogIHZhciBzZWxmID0gdGhpczsKICByZXR1cm4gdGhpcy5hZGRGdXR1cmUobmFtZSwgZnVuY3Rpb24oZG9uZSkgewogICAgdGhpcy5hcHBsaWNhdGlvbi5leGVjdXRlQWN0aW9uKGZ1bmN0aW9uKCR3aW5kb3csICRkb2N1bWVudCkgewoKICAgICAgLy9UT0RPKGVzcHJlaG4pOiBSZWZhY3RvciB0aGlzIHNvIGl0IGRvZXNuJ3QgbmVlZCB0byBiZSBpbiBoZXJlLgogICAgICAkZG9jdW1lbnQuZWxlbWVudHMgPSBmdW5jdGlvbihzZWxlY3RvcikgewogICAgICAgIHZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKICAgICAgICBzZWxlY3RvciA9IChzZWxmLnNlbGVjdG9yIHx8ICcnKSArICcgJyArIChzZWxlY3RvciB8fCAnJyk7CiAgICAgICAgc2VsZWN0b3IgPSBfalF1ZXJ5LnRyaW0oc2VsZWN0b3IpIHx8ICcqJzsKICAgICAgICBhbmd1bGFyLmZvckVhY2goYXJncywgZnVuY3Rpb24odmFsdWUsIGluZGV4KSB7CiAgICAgICAgICBzZWxlY3RvciA9IHNlbGVjdG9yLnJlcGxhY2UoJyQnICsgKGluZGV4ICsgMSksIHZhbHVlKTsKICAgICAgICB9KTsKICAgICAgICB2YXIgcmVzdWx0ID0gJGRvY3VtZW50LmZpbmQoc2VsZWN0b3IpOwogICAgICAgIGlmICghcmVzdWx0Lmxlbmd0aCkgewogICAgICAgICAgdGhyb3cgewogICAgICAgICAgICB0eXBlOiAnc2VsZWN0b3InLAogICAgICAgICAgICBtZXNzYWdlOiAnU2VsZWN0b3IgJyArIHNlbGVjdG9yICsgJyBkaWQgbm90IG1hdGNoIGFueSBlbGVtZW50cy4nCiAgICAgICAgICB9OwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKCiAgICAgIHRyeSB7CiAgICAgICAgYmVoYXZpb3IuY2FsbChzZWxmLCAkd2luZG93LCAkZG9jdW1lbnQsIGRvbmUpOwogICAgICB9IGNhdGNoKGUpIHsKICAgICAgICBpZiAoZS50eXBlICYmIGUudHlwZSA9PT0gJ3NlbGVjdG9yJykgewogICAgICAgICAgZG9uZShlLm1lc3NhZ2UpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aHJvdyBlOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgfSwgbGluZSk7Cn07Cid1c2Ugc3RyaWN0JzsKCi8qKgogKiBTaGFyZWQgRFNMIHN0YXRlbWVudHMgdGhhdCBhcmUgdXNlZnVsIHRvIGFsbCBzY2VuYXJpb3MuCiAqLwoKIC8qKgogKiBVc2FnZToKICogICAgcGF1c2UoKSBwYXVzZXMgdW50aWwgeW91IGNhbGwgcmVzdW1lKCkgaW4gdGhlIGNvbnNvbGUKICovCmFuZ3VsYXIuc2NlbmFyaW8uZHNsKCdwYXVzZScsIGZ1bmN0aW9uKCkgewogIHJldHVybiBmdW5jdGlvbigpIHsKICAgIHJldHVybiB0aGlzLmFkZEZ1dHVyZSgncGF1c2luZyBmb3IgeW91IHRvIHJlc3VtZScsIGZ1bmN0aW9uKGRvbmUpIHsKICAgICAgdGhpcy5lbWl0KCdJbnRlcmFjdGl2ZVBhdXNlJywgdGhpcy5zcGVjLCB0aGlzLnN0ZXApOwogICAgICB0aGlzLiR3aW5kb3cucmVzdW1lID0gZnVuY3Rpb24oKSB7IGRvbmUoKTsgfTsKICAgIH0pOwogIH07Cn0pOwoKLyoqCiAqIFVzYWdlOgogKiAgICBzbGVlcChzZWNvbmRzKSBwYXVzZXMgdGhlIHRlc3QgZm9yIHNwZWNpZmllZCBudW1iZXIgb2Ygc2Vjb25kcwogKi8KYW5ndWxhci5zY2VuYXJpby5kc2woJ3NsZWVwJywgZnVuY3Rpb24oKSB7CiAgcmV0dXJuIGZ1bmN0aW9uKHRpbWUpIHsKICAgIHJldHVybiB0aGlzLmFkZEZ1dHVyZSgnc2xlZXAgZm9yICcgKyB0aW1lICsgJyBzZWNvbmRzJywgZnVuY3Rpb24oZG9uZSkgewogICAgICB0aGlzLiR3aW5kb3cuc2V0VGltZW91dChmdW5jdGlvbigpIHsgZG9uZShudWxsLCB0aW1lICogMTAwMCk7IH0sIHRpbWUgKiAxMDAwKTsKICAgIH0pOwogIH07Cn0pOwoKLyoqCiAqIFVzYWdlOgogKiAgICBicm93c2VyKCkubmF2aWdhdGVUbyh1cmwpIExvYWRzIHRoZSB1cmwgaW50byB0aGUgZnJhbWUKICogICAgYnJvd3NlcigpLm5hdmlnYXRlVG8odXJsLCBmbikgd2hlcmUgZm4odXJsKSBpcyBjYWxsZWQgYW5kIHJldHVybnMgdGhlIFVSTCB0byBuYXZpZ2F0ZSB0bwogKiAgICBicm93c2VyKCkucmVsb2FkKCkgcmVmcmVzaCB0aGUgcGFnZSAocmVsb2FkIHRoZSBzYW1lIFVSTCkKICogICAgYnJvd3NlcigpLmxvY2F0aW9uKCkuaHJlZigpIHRoZSBmdWxsIFVSTCBvZiB0aGUgcGFnZQogKiAgICBicm93c2VyKCkubG9jYXRpb24oKS5oYXNoKCkgdGhlIGZ1bGwgaGFzaCBpbiB0aGUgdXJsCiAqICAgIGJyb3dzZXIoKS5sb2NhdGlvbigpLnBhdGgoKSB0aGUgZnVsbCBwYXRoIGluIHRoZSB1cmwKICogICAgYnJvd3NlcigpLmxvY2F0aW9uKCkuaGFzaFNlYXJjaCgpIHRoZSBoYXNoU2VhcmNoIE9iamVjdCBmcm9tIGFuZ3VsYXIKICogICAgYnJvd3NlcigpLmxvY2F0aW9uKCkuaGFzaFBhdGgoKSB0aGUgaGFzaFBhdGggc3RyaW5nIGZyb20gYW5ndWxhcgogKi8KYW5ndWxhci5zY2VuYXJpby5kc2woJ2Jyb3dzZXInLCBmdW5jdGlvbigpIHsKICB2YXIgY2hhaW4gPSB7fTsKCiAgY2hhaW4ubmF2aWdhdGVUbyA9IGZ1bmN0aW9uKHVybCwgZGVsZWdhdGUpIHsKICAgIHZhciBhcHBsaWNhdGlvbiA9IHRoaXMuYXBwbGljYXRpb247CiAgICByZXR1cm4gdGhpcy5hZGRGdXR1cmUoImJyb3dzZXIgbmF2aWdhdGUgdG8gJyIgKyB1cmwgKyAiJyIsIGZ1bmN0aW9uKGRvbmUpIHsKICAgICAgaWYgKGRlbGVnYXRlKSB7CiAgICAgICAgdXJsID0gZGVsZWdhdGUuY2FsbCh0aGlzLCB1cmwpOwogICAgICB9CiAgICAgIGFwcGxpY2F0aW9uLm5hdmlnYXRlVG8odXJsLCBmdW5jdGlvbigpIHsKICAgICAgICBkb25lKG51bGwsIHVybCk7CiAgICAgIH0sIGRvbmUpOwogICAgfSk7CiAgfTsKCiAgY2hhaW4ucmVsb2FkID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgYXBwbGljYXRpb24gPSB0aGlzLmFwcGxpY2F0aW9uOwogICAgcmV0dXJuIHRoaXMuYWRkRnV0dXJlQWN0aW9uKCdicm93c2VyIHJlbG9hZCcsIGZ1bmN0aW9uKCR3aW5kb3csICRkb2N1bWVudCwgZG9uZSkgewogICAgICB2YXIgaHJlZiA9ICR3aW5kb3cubG9jYXRpb24uaHJlZjsKICAgICAgYXBwbGljYXRpb24ubmF2aWdhdGVUbyhocmVmLCBmdW5jdGlvbigpIHsKICAgICAgICBkb25lKG51bGwsIGhyZWYpOwogICAgICB9LCBkb25lKTsKICAgIH0pOwogIH07CgogIGNoYWluLmxvY2F0aW9uID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgYXBpID0ge307CgogICAgYXBpLmhyZWYgPSBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHRoaXMuYWRkRnV0dXJlQWN0aW9uKCdicm93c2VyIHVybCcsIGZ1bmN0aW9uKCR3aW5kb3csICRkb2N1bWVudCwgZG9uZSkgewogICAgICAgIGRvbmUobnVsbCwgJHdpbmRvdy5sb2NhdGlvbi5ocmVmKTsKICAgICAgfSk7CiAgICB9OwoKICAgIGFwaS5oYXNoID0gZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB0aGlzLmFkZEZ1dHVyZUFjdGlvbignYnJvd3NlciB1cmwgaGFzaCcsIGZ1bmN0aW9uKCR3aW5kb3csICRkb2N1bWVudCwgZG9uZSkgewogICAgICAgIGRvbmUobnVsbCwgJHdpbmRvdy5sb2NhdGlvbi5oYXNoLnJlcGxhY2UoJyMnLCAnJykpOwogICAgICB9KTsKICAgIH07CgogICAgYXBpLnBhdGggPSBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHRoaXMuYWRkRnV0dXJlQWN0aW9uKCdicm93c2VyIHVybCBwYXRoJywgZnVuY3Rpb24oJHdpbmRvdywgJGRvY3VtZW50LCBkb25lKSB7CiAgICAgICAgZG9uZShudWxsLCAkd2luZG93LmxvY2F0aW9uLnBhdGhuYW1lKTsKICAgICAgfSk7CiAgICB9OwoKICAgIGFwaS5zZWFyY2ggPSBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHRoaXMuYWRkRnV0dXJlQWN0aW9uKCdicm93c2VyIHVybCBzZWFyY2gnLCBmdW5jdGlvbigkd2luZG93LCAkZG9jdW1lbnQsIGRvbmUpIHsKICAgICAgICBkb25lKG51bGwsICR3aW5kb3cuYW5ndWxhci5zY29wZSgpLiRzZXJ2aWNlKCckbG9jYXRpb24nKS5zZWFyY2gpOwogICAgICB9KTsKICAgIH07CgogICAgYXBpLmhhc2hTZWFyY2ggPSBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHRoaXMuYWRkRnV0dXJlQWN0aW9uKCdicm93c2VyIHVybCBoYXNoIHNlYXJjaCcsIGZ1bmN0aW9uKCR3aW5kb3csICRkb2N1bWVudCwgZG9uZSkgewogICAgICAgIGRvbmUobnVsbCwgJHdpbmRvdy5hbmd1bGFyLnNjb3BlKCkuJHNlcnZpY2UoJyRsb2NhdGlvbicpLmhhc2hTZWFyY2gpOwogICAgICB9KTsKICAgIH07CgogICAgYXBpLmhhc2hQYXRoID0gZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB0aGlzLmFkZEZ1dHVyZUFjdGlvbignYnJvd3NlciB1cmwgaGFzaCBwYXRoJywgZnVuY3Rpb24oJHdpbmRvdywgJGRvY3VtZW50LCBkb25lKSB7CiAgICAgICAgZG9uZShudWxsLCAkd2luZG93LmFuZ3VsYXIuc2NvcGUoKS4kc2VydmljZSgnJGxvY2F0aW9uJykuaGFzaFBhdGgpOwogICAgICB9KTsKICAgIH07CgogICAgcmV0dXJuIGFwaTsKICB9OwoKICByZXR1cm4gZnVuY3Rpb24odGltZSkgewogICAgcmV0dXJuIGNoYWluOwogIH07Cn0pOwoKLyoqCiAqIFVzYWdlOgogKiAgICBleHBlY3QoZnV0dXJlKS57bWF0Y2hlcn0gd2hlcmUgbWF0Y2hlciBpcyBvbmUgb2YgdGhlIG1hdGNoZXJzIGRlZmluZWQKICogICAgd2l0aCBhbmd1bGFyLnNjZW5hcmlvLm1hdGNoZXIKICoKICogZXguIGV4cGVjdChiaW5kaW5nKCJuYW1lIikpLnRvRXF1YWwoIkVsbGlvdHQiKQogKi8KYW5ndWxhci5zY2VuYXJpby5kc2woJ2V4cGVjdCcsIGZ1bmN0aW9uKCkgewogIHZhciBjaGFpbiA9IGFuZ3VsYXIuZXh0ZW5kKHt9LCBhbmd1bGFyLnNjZW5hcmlvLm1hdGNoZXIpOwoKICBjaGFpbi5ub3QgPSBmdW5jdGlvbigpIHsKICAgIHRoaXMuaW52ZXJzZSA9IHRydWU7CiAgICByZXR1cm4gY2hhaW47CiAgfTsKCiAgcmV0dXJuIGZ1bmN0aW9uKGZ1dHVyZSkgewogICAgdGhpcy5mdXR1cmUgPSBmdXR1cmU7CiAgICByZXR1cm4gY2hhaW47CiAgfTsKfSk7CgovKioKICogVXNhZ2U6CiAqICAgIHVzaW5nKHNlbGVjdG9yLCBsYWJlbCkgc2NvcGVzIHRoZSBuZXh0IERTTCBlbGVtZW50IHNlbGVjdGlvbgogKgogKiBleC4KICogICB1c2luZygnI2ZvbycsICInRm9vJyB0ZXh0IGZpZWxkIikuaW5wdXQoJ2JhcicpCiAqLwphbmd1bGFyLnNjZW5hcmlvLmRzbCgndXNpbmcnLCBmdW5jdGlvbigpIHsKICByZXR1cm4gZnVuY3Rpb24oc2VsZWN0b3IsIGxhYmVsKSB7CiAgICB0aGlzLnNlbGVjdG9yID0gX2pRdWVyeS50cmltKCh0aGlzLnNlbGVjdG9yfHwnJykgKyAnICcgKyBzZWxlY3Rvcik7CiAgICBpZiAoYW5ndWxhci5pc1N0cmluZyhsYWJlbCkgJiYgbGFiZWwubGVuZ3RoKSB7CiAgICAgIHRoaXMubGFiZWwgPSBsYWJlbCArICcgKCAnICsgdGhpcy5zZWxlY3RvciArICcgKSc7CiAgICB9IGVsc2UgewogICAgICB0aGlzLmxhYmVsID0gdGhpcy5zZWxlY3RvcjsKICAgIH0KICAgIHJldHVybiB0aGlzLmRzbDsKICB9Owp9KTsKCi8qKgogKiBVc2FnZToKICogICAgYmluZGluZyhuYW1lKSByZXR1cm5zIHRoZSB2YWx1ZSBvZiB0aGUgZmlyc3QgbWF0Y2hpbmcgYmluZGluZwogKi8KYW5ndWxhci5zY2VuYXJpby5kc2woJ2JpbmRpbmcnLCBmdW5jdGlvbigpIHsKICByZXR1cm4gZnVuY3Rpb24obmFtZSkgewogICAgcmV0dXJuIHRoaXMuYWRkRnV0dXJlQWN0aW9uKCJzZWxlY3QgYmluZGluZyAnIiArIG5hbWUgKyAiJyIsIGZ1bmN0aW9uKCR3aW5kb3csICRkb2N1bWVudCwgZG9uZSkgewogICAgICB2YXIgdmFsdWVzID0gJGRvY3VtZW50LmVsZW1lbnRzKCkuYmluZGluZ3MobmFtZSk7CiAgICAgIGlmICghdmFsdWVzLmxlbmd0aCkgewogICAgICAgIHJldHVybiBkb25lKCJCaW5kaW5nIHNlbGVjdG9yICciICsgbmFtZSArICInIGRpZCBub3QgbWF0Y2guIik7CiAgICAgIH0KICAgICAgZG9uZShudWxsLCB2YWx1ZXNbMF0pOwogICAgfSk7CiAgfTsKfSk7CgovKioKICogVXNhZ2U6CiAqICAgIGlucHV0KG5hbWUpLmVudGVyKHZhbHVlKSBlbnRlcnMgdmFsdWUgaW4gaW5wdXQgd2l0aCBzcGVjaWZpZWQgbmFtZQogKiAgICBpbnB1dChuYW1lKS5jaGVjaygpIGNoZWNrcyBjaGVja2JveAogKiAgICBpbnB1dChuYW1lKS5zZWxlY3QodmFsdWUpIHNlbGVjdHMgdGhlIHJhZGlvIGJ1dHRvbiB3aXRoIHNwZWNpZmllZCBuYW1lL3ZhbHVlCiAqICAgIGlucHV0KG5hbWUpLnZhbCgpIHJldHVybnMgdGhlIHZhbHVlIG9mIHRoZSBpbnB1dC4KICovCmFuZ3VsYXIuc2NlbmFyaW8uZHNsKCdpbnB1dCcsIGZ1bmN0aW9uKCkgewogIHZhciBjaGFpbiA9IHt9OwoKICBjaGFpbi5lbnRlciA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICByZXR1cm4gdGhpcy5hZGRGdXR1cmVBY3Rpb24oImlucHV0ICciICsgdGhpcy5uYW1lICsgIicgZW50ZXIgJyIgKyB2YWx1ZSArICInIiwgZnVuY3Rpb24oJHdpbmRvdywgJGRvY3VtZW50LCBkb25lKSB7CiAgICAgIHZhciBpbnB1dCA9ICRkb2N1bWVudC5lbGVtZW50cygnOmlucHV0W25hbWU9IiQxIl0nLCB0aGlzLm5hbWUpOwogICAgICBpbnB1dC52YWwodmFsdWUpOwogICAgICBpbnB1dC50cmlnZ2VyKCdrZXlkb3duJyk7CiAgICAgIGRvbmUoKTsKICAgIH0pOwogIH07CgogIGNoYWluLmNoZWNrID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gdGhpcy5hZGRGdXR1cmVBY3Rpb24oImNoZWNrYm94ICciICsgdGhpcy5uYW1lICsgIicgdG9nZ2xlIiwgZnVuY3Rpb24oJHdpbmRvdywgJGRvY3VtZW50LCBkb25lKSB7CiAgICAgIHZhciBpbnB1dCA9ICRkb2N1bWVudC5lbGVtZW50cygnOmNoZWNrYm94W25hbWU9IiQxIl0nLCB0aGlzLm5hbWUpOwogICAgICBpbnB1dC50cmlnZ2VyKCdjbGljaycpOwogICAgICBkb25lKCk7CiAgICB9KTsKICB9OwoKICBjaGFpbi5zZWxlY3QgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgcmV0dXJuIHRoaXMuYWRkRnV0dXJlQWN0aW9uKCJyYWRpbyBidXR0b24gJyIgKyB0aGlzLm5hbWUgKyAiJyB0b2dnbGUgJyIgKyB2YWx1ZSArICInIiwgZnVuY3Rpb24oJHdpbmRvdywgJGRvY3VtZW50LCBkb25lKSB7CiAgICAgIHZhciBpbnB1dCA9ICRkb2N1bWVudC4KICAgICAgICBlbGVtZW50cygnOnJhZGlvW25hbWUkPSJAJDEiXVt2YWx1ZT0iJDIiXScsIHRoaXMubmFtZSwgdmFsdWUpOwogICAgICBpbnB1dC50cmlnZ2VyKCdjbGljaycpOwogICAgICBkb25lKCk7CiAgICB9KTsKICB9OwoKICBjaGFpbi52YWwgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiB0aGlzLmFkZEZ1dHVyZUFjdGlvbigicmV0dXJuIGlucHV0IHZhbCIsIGZ1bmN0aW9uKCR3aW5kb3csICRkb2N1bWVudCwgZG9uZSkgewogICAgICB2YXIgaW5wdXQgPSAkZG9jdW1lbnQuZWxlbWVudHMoJzppbnB1dFtuYW1lPSIkMSJdJywgdGhpcy5uYW1lKTsKICAgICAgZG9uZShudWxsLGlucHV0LnZhbCgpKTsKICAgIH0pOwogIH07CgogIHJldHVybiBmdW5jdGlvbihuYW1lKSB7CiAgICB0aGlzLm5hbWUgPSBuYW1lOwogICAgcmV0dXJuIGNoYWluOwogIH07Cn0pOwoKCi8qKgogKiBVc2FnZToKICogICAgcmVwZWF0ZXIoJyNwcm9kdWN0cyB0YWJsZScsICdQcm9kdWN0IExpc3QnKS5jb3VudCgpIG51bWJlciBvZiByb3dzCiAqICAgIHJlcGVhdGVyKCcjcHJvZHVjdHMgdGFibGUnLCAnUHJvZHVjdCBMaXN0Jykucm93KDEpIGFsbCBiaW5kaW5ncyBpbiByb3cgYXMgYW4gYXJyYXkKICogICAgcmVwZWF0ZXIoJyNwcm9kdWN0cyB0YWJsZScsICdQcm9kdWN0IExpc3QnKS5jb2x1bW4oJ3Byb2R1Y3QubmFtZScpIGFsbCB2YWx1ZXMgYWNyb3NzIGFsbCByb3dzIGluIGFuIGFycmF5CiAqLwphbmd1bGFyLnNjZW5hcmlvLmRzbCgncmVwZWF0ZXInLCBmdW5jdGlvbigpIHsKICB2YXIgY2hhaW4gPSB7fTsKCiAgY2hhaW4uY291bnQgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiB0aGlzLmFkZEZ1dHVyZUFjdGlvbigicmVwZWF0ZXIgJyIgKyB0aGlzLmxhYmVsICsgIicgY291bnQiLCBmdW5jdGlvbigkd2luZG93LCAkZG9jdW1lbnQsIGRvbmUpIHsKICAgICAgdHJ5IHsKICAgICAgICBkb25lKG51bGwsICRkb2N1bWVudC5lbGVtZW50cygpLmxlbmd0aCk7CiAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICBkb25lKG51bGwsIDApOwogICAgICB9CiAgICB9KTsKICB9OwoKICBjaGFpbi5jb2x1bW4gPSBmdW5jdGlvbihiaW5kaW5nKSB7CiAgICByZXR1cm4gdGhpcy5hZGRGdXR1cmVBY3Rpb24oInJlcGVhdGVyICciICsgdGhpcy5sYWJlbCArICInIGNvbHVtbiAnIiArIGJpbmRpbmcgKyAiJyIsIGZ1bmN0aW9uKCR3aW5kb3csICRkb2N1bWVudCwgZG9uZSkgewogICAgICBkb25lKG51bGwsICRkb2N1bWVudC5lbGVtZW50cygpLmJpbmRpbmdzKGJpbmRpbmcpKTsKICAgIH0pOwogIH07CgogIGNoYWluLnJvdyA9IGZ1bmN0aW9uKGluZGV4KSB7CiAgICByZXR1cm4gdGhpcy5hZGRGdXR1cmVBY3Rpb24oInJlcGVhdGVyICciICsgdGhpcy5sYWJlbCArICInIHJvdyAnIiArIGluZGV4ICsgIiciLCBmdW5jdGlvbigkd2luZG93LCAkZG9jdW1lbnQsIGRvbmUpIHsKICAgICAgdmFyIHZhbHVlcyA9IFtdOwogICAgICB2YXIgbWF0Y2hlcyA9ICRkb2N1bWVudC5lbGVtZW50cygpLnNsaWNlKGluZGV4LCBpbmRleCArIDEpOwogICAgICBpZiAoIW1hdGNoZXMubGVuZ3RoKQogICAgICAgIHJldHVybiBkb25lKCdyb3cgJyArIGluZGV4ICsgJyBvdXQgb2YgYm91bmRzJyk7CiAgICAgIGRvbmUobnVsbCwgbWF0Y2hlcy5iaW5kaW5ncygpKTsKICAgIH0pOwogIH07CgogIHJldHVybiBmdW5jdGlvbihzZWxlY3RvciwgbGFiZWwpIHsKICAgIHRoaXMuZHNsLnVzaW5nKHNlbGVjdG9yLCBsYWJlbCk7CiAgICByZXR1cm4gY2hhaW47CiAgfTsKfSk7CgovKioKICogVXNhZ2U6CiAqICAgIHNlbGVjdChuYW1lKS5vcHRpb24oJ3ZhbHVlJykgc2VsZWN0IG9uZSBvcHRpb24KICogICAgc2VsZWN0KG5hbWUpLm9wdGlvbnMoJ3ZhbHVlMScsICd2YWx1ZTInLCAuLi4pIHNlbGVjdCBvcHRpb25zIGZyb20gYSBtdWx0aSBzZWxlY3QKICovCmFuZ3VsYXIuc2NlbmFyaW8uZHNsKCdzZWxlY3QnLCBmdW5jdGlvbigpIHsKICB2YXIgY2hhaW4gPSB7fTsKCiAgY2hhaW4ub3B0aW9uID0gZnVuY3Rpb24odmFsdWUpIHsKICAgIHJldHVybiB0aGlzLmFkZEZ1dHVyZUFjdGlvbigic2VsZWN0ICciICsgdGhpcy5uYW1lICsgIicgb3B0aW9uICciICsgdmFsdWUgKyAiJyIsIGZ1bmN0aW9uKCR3aW5kb3csICRkb2N1bWVudCwgZG9uZSkgewogICAgICB2YXIgc2VsZWN0ID0gJGRvY3VtZW50LmVsZW1lbnRzKCdzZWxlY3RbbmFtZT0iJDEiXScsIHRoaXMubmFtZSk7CiAgICAgIHNlbGVjdC52YWwodmFsdWUpOwogICAgICBzZWxlY3QudHJpZ2dlcignY2hhbmdlJyk7CiAgICAgIGRvbmUoKTsKICAgIH0pOwogIH07CgogIGNoYWluLm9wdGlvbnMgPSBmdW5jdGlvbigpIHsKICAgIHZhciB2YWx1ZXMgPSBhcmd1bWVudHM7CiAgICByZXR1cm4gdGhpcy5hZGRGdXR1cmVBY3Rpb24oInNlbGVjdCAnIiArIHRoaXMubmFtZSArICInIG9wdGlvbnMgJyIgKyB2YWx1ZXMgKyAiJyIsIGZ1bmN0aW9uKCR3aW5kb3csICRkb2N1bWVudCwgZG9uZSkgewogICAgICB2YXIgc2VsZWN0ID0gJGRvY3VtZW50LmVsZW1lbnRzKCdzZWxlY3RbbXVsdGlwbGVdW25hbWU9IiQxIl0nLCB0aGlzLm5hbWUpOwogICAgICBzZWxlY3QudmFsKHZhbHVlcyk7CiAgICAgIHNlbGVjdC50cmlnZ2VyKCdjaGFuZ2UnKTsKICAgICAgZG9uZSgpOwogICAgfSk7CiAgfTsKCiAgcmV0dXJuIGZ1bmN0aW9uKG5hbWUpIHsKICAgIHRoaXMubmFtZSA9IG5hbWU7CiAgICByZXR1cm4gY2hhaW47CiAgfTsKfSk7CgovKioKICogVXNhZ2U6CiAqICAgIGVsZW1lbnQoc2VsZWN0b3IsIGxhYmVsKS5jb3VudCgpIGdldCB0aGUgbnVtYmVyIG9mIGVsZW1lbnRzIHRoYXQgbWF0Y2ggc2VsZWN0b3IKICogICAgZWxlbWVudChzZWxlY3RvciwgbGFiZWwpLmNsaWNrKCkgY2xpY2tzIGFuIGVsZW1lbnQKICogICAgZWxlbWVudChzZWxlY3RvciwgbGFiZWwpLnF1ZXJ5KGZuKSBleGVjdXRlcyBmbihzZWxlY3RlZEVsZW1lbnRzLCBkb25lKQogKiAgICBlbGVtZW50KHNlbGVjdG9yLCBsYWJlbCkue21ldGhvZH0oKSBnZXRzIHRoZSB2YWx1ZSAoYXMgZGVmaW5lZCBieSBqUXVlcnksIGV4LiB2YWwpCiAqICAgIGVsZW1lbnQoc2VsZWN0b3IsIGxhYmVsKS57bWV0aG9kfSh2YWx1ZSkgc2V0cyB0aGUgdmFsdWUgKGFzIGRlZmluZWQgYnkgalF1ZXJ5LCBleC4gdmFsKQogKiAgICBlbGVtZW50KHNlbGVjdG9yLCBsYWJlbCkue21ldGhvZH0oa2V5KSBnZXRzIHRoZSB2YWx1ZSAoYXMgZGVmaW5lZCBieSBqUXVlcnksIGV4LiBhdHRyKQogKiAgICBlbGVtZW50KHNlbGVjdG9yLCBsYWJlbCkue21ldGhvZH0oa2V5LCB2YWx1ZSkgc2V0cyB0aGUgdmFsdWUgKGFzIGRlZmluZWQgYnkgalF1ZXJ5LCBleC4gYXR0cikKICovCmFuZ3VsYXIuc2NlbmFyaW8uZHNsKCdlbGVtZW50JywgZnVuY3Rpb24oKSB7CiAgdmFyIEtFWV9WQUxVRV9NRVRIT0RTID0gWydhdHRyJywgJ2NzcyddOwogIHZhciBWQUxVRV9NRVRIT0RTID0gWwogICAgJ3ZhbCcsICd0ZXh0JywgJ2h0bWwnLCAnaGVpZ2h0JywgJ2lubmVySGVpZ2h0JywgJ291dGVySGVpZ2h0JywgJ3dpZHRoJywKICAgICdpbm5lcldpZHRoJywgJ291dGVyV2lkdGgnLCAncG9zaXRpb24nLCAnc2Nyb2xsTGVmdCcsICdzY3JvbGxUb3AnLCAnb2Zmc2V0JwogIF07CiAgdmFyIGNoYWluID0ge307CgogIGNoYWluLmNvdW50ID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gdGhpcy5hZGRGdXR1cmVBY3Rpb24oImVsZW1lbnQgJyIgKyB0aGlzLmxhYmVsICsgIicgY291bnQiLCBmdW5jdGlvbigkd2luZG93LCAkZG9jdW1lbnQsIGRvbmUpIHsKICAgICAgdHJ5IHsKICAgICAgICBkb25lKG51bGwsICRkb2N1bWVudC5lbGVtZW50cygpLmxlbmd0aCk7CiAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICBkb25lKG51bGwsIDApOwogICAgICB9CiAgICB9KTsKICB9OwoKICBjaGFpbi5jbGljayA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHRoaXMuYWRkRnV0dXJlQWN0aW9uKCJlbGVtZW50ICciICsgdGhpcy5sYWJlbCArICInIGNsaWNrIiwgZnVuY3Rpb24oJHdpbmRvdywgJGRvY3VtZW50LCBkb25lKSB7CiAgICAgIHZhciBlbGVtZW50cyA9ICRkb2N1bWVudC5lbGVtZW50cygpOwogICAgICB2YXIgaHJlZiA9IGVsZW1lbnRzLmF0dHIoJ2hyZWYnKTsKICAgICAgZWxlbWVudHMudHJpZ2dlcignY2xpY2snKTsKICAgICAgaWYgKGhyZWYgJiYgZWxlbWVudHNbMF0ubm9kZU5hbWUudG9VcHBlckNhc2UoKSA9PT0gJ0EnKSB7CiAgICAgICAgdGhpcy5hcHBsaWNhdGlvbi5uYXZpZ2F0ZVRvKGhyZWYsIGZ1bmN0aW9uKCkgewogICAgICAgICAgZG9uZSgpOwogICAgICAgIH0sIGRvbmUpOwogICAgICB9IGVsc2UgewogICAgICAgIGRvbmUoKTsKICAgICAgfQogICAgfSk7CiAgfTsKCiAgY2hhaW4ucXVlcnkgPSBmdW5jdGlvbihmbikgewogICAgcmV0dXJuIHRoaXMuYWRkRnV0dXJlQWN0aW9uKCdlbGVtZW50ICcgKyB0aGlzLmxhYmVsICsgJyBjdXN0b20gcXVlcnknLCBmdW5jdGlvbigkd2luZG93LCAkZG9jdW1lbnQsIGRvbmUpIHsKICAgICAgZm4uY2FsbCh0aGlzLCAkZG9jdW1lbnQuZWxlbWVudHMoKSwgZG9uZSk7CiAgICB9KTsKICB9OwoKICBhbmd1bGFyLmZvckVhY2goS0VZX1ZBTFVFX01FVEhPRFMsIGZ1bmN0aW9uKG1ldGhvZE5hbWUpIHsKICAgIGNoYWluW21ldGhvZE5hbWVdID0gZnVuY3Rpb24obmFtZSwgdmFsdWUpIHsKICAgICAgdmFyIGZ1dHVyZU5hbWUgPSAiZWxlbWVudCAnIiArIHRoaXMubGFiZWwgKyAiJyBnZXQgIiArIG1ldGhvZE5hbWUgKyAiICciICsgbmFtZSArICInIjsKICAgICAgaWYgKGFuZ3VsYXIuaXNEZWZpbmVkKHZhbHVlKSkgewogICAgICAgIGZ1dHVyZU5hbWUgPSAiZWxlbWVudCAnIiArIHRoaXMubGFiZWwgKyAiJyBzZXQgIiArIG1ldGhvZE5hbWUgKyAiICciICsgbmFtZSArICInIHRvICIgKyAiJyIgKyB2YWx1ZSArICInIjsKICAgICAgfQogICAgICByZXR1cm4gdGhpcy5hZGRGdXR1cmVBY3Rpb24oZnV0dXJlTmFtZSwgZnVuY3Rpb24oJHdpbmRvdywgJGRvY3VtZW50LCBkb25lKSB7CiAgICAgICAgdmFyIGVsZW1lbnQgPSAkZG9jdW1lbnQuZWxlbWVudHMoKTsKICAgICAgICBkb25lKG51bGwsIGVsZW1lbnRbbWV0aG9kTmFtZV0uY2FsbChlbGVtZW50LCBuYW1lLCB2YWx1ZSkpOwogICAgICB9KTsKICAgIH07CiAgfSk7CgogIGFuZ3VsYXIuZm9yRWFjaChWQUxVRV9NRVRIT0RTLCBmdW5jdGlvbihtZXRob2ROYW1lKSB7CiAgICBjaGFpblttZXRob2ROYW1lXSA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIHZhciBmdXR1cmVOYW1lID0gImVsZW1lbnQgJyIgKyB0aGlzLmxhYmVsICsgIicgIiArIG1ldGhvZE5hbWU7CiAgICAgIGlmIChhbmd1bGFyLmlzRGVmaW5lZCh2YWx1ZSkpIHsKICAgICAgICBmdXR1cmVOYW1lID0gImVsZW1lbnQgJyIgKyB0aGlzLmxhYmVsICsgIicgc2V0ICIgKyBtZXRob2ROYW1lICsgIiB0byAnIiArIHZhbHVlICsgIiciOwogICAgICB9CiAgICAgIHJldHVybiB0aGlzLmFkZEZ1dHVyZUFjdGlvbihmdXR1cmVOYW1lLCBmdW5jdGlvbigkd2luZG93LCAkZG9jdW1lbnQsIGRvbmUpIHsKICAgICAgICB2YXIgZWxlbWVudCA9ICRkb2N1bWVudC5lbGVtZW50cygpOwogICAgICAgIGRvbmUobnVsbCwgZWxlbWVudFttZXRob2ROYW1lXS5jYWxsKGVsZW1lbnQsIHZhbHVlKSk7CiAgICAgIH0pOwogICAgfTsKICB9KTsKCiAgcmV0dXJuIGZ1bmN0aW9uKHNlbGVjdG9yLCBsYWJlbCkgewogICAgdGhpcy5kc2wudXNpbmcoc2VsZWN0b3IsIGxhYmVsKTsKICAgIHJldHVybiBjaGFpbjsKICB9Owp9KTsKJ3VzZSBzdHJpY3QnOwoKLyoqCiAqIE1hdGNoZXJzIGZvciBpbXBsZW1lbnRpbmcgc3BlY3MuIEZvbGxvd3MgdGhlIEphc21pbmUgc3BlYyBjb252ZW50aW9ucy4KICovCgphbmd1bGFyLnNjZW5hcmlvLm1hdGNoZXIoJ3RvRXF1YWwnLCBmdW5jdGlvbihleHBlY3RlZCkgewogIHJldHVybiBhbmd1bGFyLmVxdWFscyh0aGlzLmFjdHVhbCwgZXhwZWN0ZWQpOwp9KTsKCmFuZ3VsYXIuc2NlbmFyaW8ubWF0Y2hlcigndG9CZScsIGZ1bmN0aW9uKGV4cGVjdGVkKSB7CiAgcmV0dXJuIHRoaXMuYWN0dWFsID09PSBleHBlY3RlZDsKfSk7Cgphbmd1bGFyLnNjZW5hcmlvLm1hdGNoZXIoJ3RvQmVEZWZpbmVkJywgZnVuY3Rpb24oKSB7CiAgcmV0dXJuIGFuZ3VsYXIuaXNEZWZpbmVkKHRoaXMuYWN0dWFsKTsKfSk7Cgphbmd1bGFyLnNjZW5hcmlvLm1hdGNoZXIoJ3RvQmVUcnV0aHknLCBmdW5jdGlvbigpIHsKICByZXR1cm4gdGhpcy5hY3R1YWw7Cn0pOwoKYW5ndWxhci5zY2VuYXJpby5tYXRjaGVyKCd0b0JlRmFsc3knLCBmdW5jdGlvbigpIHsKICByZXR1cm4gIXRoaXMuYWN0dWFsOwp9KTsKCmFuZ3VsYXIuc2NlbmFyaW8ubWF0Y2hlcigndG9NYXRjaCcsIGZ1bmN0aW9uKGV4cGVjdGVkKSB7CiAgcmV0dXJuIG5ldyBSZWdFeHAoZXhwZWN0ZWQpLnRlc3QodGhpcy5hY3R1YWwpOwp9KTsKCmFuZ3VsYXIuc2NlbmFyaW8ubWF0Y2hlcigndG9CZU51bGwnLCBmdW5jdGlvbigpIHsKICByZXR1cm4gdGhpcy5hY3R1YWwgPT09IG51bGw7Cn0pOwoKYW5ndWxhci5zY2VuYXJpby5tYXRjaGVyKCd0b0NvbnRhaW4nLCBmdW5jdGlvbihleHBlY3RlZCkgewogIHJldHVybiBpbmNsdWRlcyh0aGlzLmFjdHVhbCwgZXhwZWN0ZWQpOwp9KTsKCmFuZ3VsYXIuc2NlbmFyaW8ubWF0Y2hlcigndG9CZUxlc3NUaGFuJywgZnVuY3Rpb24oZXhwZWN0ZWQpIHsKICByZXR1cm4gdGhpcy5hY3R1YWwgPCBleHBlY3RlZDsKfSk7Cgphbmd1bGFyLnNjZW5hcmlvLm1hdGNoZXIoJ3RvQmVHcmVhdGVyVGhhbicsIGZ1bmN0aW9uKGV4cGVjdGVkKSB7CiAgcmV0dXJuIHRoaXMuYWN0dWFsID4gZXhwZWN0ZWQ7Cn0pOwondXNlIHN0cmljdCc7CgovKioKICogVXNlciBJbnRlcmZhY2UgZm9yIHRoZSBTY2VuYXJpbyBSdW5uZXIuCiAqCiAqIFRPRE8oZXNwcmVobik6IFRoaXMgc2hvdWxkIGJlIHJlZmFjdG9yZWQgbm93IHRoYXQgT2JqZWN0TW9kZWwgZXhpc3RzCiAqICB0byB1c2UgYW5ndWxhciBiaW5kaW5ncyBmb3IgdGhlIFVJLgogKi8KYW5ndWxhci5zY2VuYXJpby5vdXRwdXQoJ2h0bWwnLCBmdW5jdGlvbihjb250ZXh0LCBydW5uZXIsIG1vZGVsKSB7CiAgdmFyIHNwZWNVaU1hcCA9IHt9LAogICAgICBsYXN0U3RlcFVpTWFwID0ge307CgogIGNvbnRleHQuYXBwZW5kKAogICAgJzxkaXYgaWQ9ImhlYWRlciI+JyArCiAgICAnICA8aDE+PHNwYW4gY2xhc3M9ImFuZ3VsYXIiPiZsdDthbmd1bGFyLyZndDs8L3NwYW4+OiBTY2VuYXJpbyBUZXN0IFJ1bm5lcjwvaDE+JyArCiAgICAnICA8dWwgaWQ9InN0YXR1cy1sZWdlbmQiIGNsYXNzPSJzdGF0dXMtZGlzcGxheSI+JyArCiAgICAnICAgIDxsaSBjbGFzcz0ic3RhdHVzLWVycm9yIj4wIEVycm9yczwvbGk+JyArCiAgICAnICAgIDxsaSBjbGFzcz0ic3RhdHVzLWZhaWx1cmUiPjAgRmFpbHVyZXM8L2xpPicgKwogICAgJyAgICA8bGkgY2xhc3M9InN0YXR1cy1zdWNjZXNzIj4wIFBhc3NlZDwvbGk+JyArCiAgICAnICA8L3VsPicgKwogICAgJzwvZGl2PicgKwogICAgJzxkaXYgaWQ9InNwZWNzIj4nICsKICAgICcgIDxkaXYgY2xhc3M9InRlc3QtY2hpbGRyZW4iPjwvZGl2PicgKwogICAgJzwvZGl2PicKICApOwoKICBydW5uZXIub24oJ0ludGVyYWN0aXZlUGF1c2UnLCBmdW5jdGlvbihzcGVjLCBzdGVwKSB7CiAgICB2YXIgdWkgPSBsYXN0U3RlcFVpTWFwW3NwZWMuaWRdOwogICAgdWkuZmluZCgnLnRlc3QtdGl0bGUnKS4KICAgICAgaHRtbCgncGF1c2VkLi4uIDxhIGhyZWY9ImphdmFzY3JpcHQ6cmVzdW1lKCkiPnJlc3VtZTwvYT4gd2hlbiByZWFkeS4nKTsKICB9KTsKCiAgcnVubmVyLm9uKCdTcGVjQmVnaW4nLCBmdW5jdGlvbihzcGVjKSB7CiAgICB2YXIgdWkgPSBmaW5kQ29udGV4dChzcGVjKTsKICAgIHVpLmZpbmQoJz4gLnRlc3RzJykuYXBwZW5kKAogICAgICAnPGxpIGNsYXNzPSJzdGF0dXMtcGVuZGluZyB0ZXN0LWl0Ij48L2xpPicKICAgICk7CiAgICB1aSA9IHVpLmZpbmQoJz4gLnRlc3RzIGxpOmxhc3QnKTsKICAgIHVpLmFwcGVuZCgKICAgICAgJzxkaXYgY2xhc3M9InRlc3QtaW5mbyI+JyArCiAgICAgICcgIDxwIGNsYXNzPSJ0ZXN0LXRpdGxlIj4nICsKICAgICAgJyAgICA8c3BhbiBjbGFzcz0idGltZXItcmVzdWx0Ij48L3NwYW4+JyArCiAgICAgICcgICAgPHNwYW4gY2xhc3M9InRlc3QtbmFtZSI+PC9zcGFuPicgKwogICAgICAnICA8L3A+JyArCiAgICAgICc8L2Rpdj4nICsKICAgICAgJzxkaXYgY2xhc3M9InNjcm9sbHBhbmUiPicgKwogICAgICAnICA8b2wgY2xhc3M9InRlc3QtYWN0aW9ucyI+PC9vbD4nICsKICAgICAgJzwvZGl2PicKICAgICk7CiAgICB1aS5maW5kKCc+IC50ZXN0LWluZm8gLnRlc3QtbmFtZScpLnRleHQoc3BlYy5uYW1lKTsKICAgIHVpLmZpbmQoJz4gLnRlc3QtaW5mbycpLmNsaWNrKGZ1bmN0aW9uKCkgewogICAgICB2YXIgc2Nyb2xscGFuZSA9IHVpLmZpbmQoJz4gLnNjcm9sbHBhbmUnKTsKICAgICAgdmFyIGFjdGlvbnMgPSBzY3JvbGxwYW5lLmZpbmQoJz4gLnRlc3QtYWN0aW9ucycpOwogICAgICB2YXIgbmFtZSA9IGNvbnRleHQuZmluZCgnPiAudGVzdC1pbmZvIC50ZXN0LW5hbWUnKTsKICAgICAgaWYgKGFjdGlvbnMuZmluZCgnOnZpc2libGUnKS5sZW5ndGgpIHsKICAgICAgICBhY3Rpb25zLmhpZGUoKTsKICAgICAgICBuYW1lLnJlbW92ZUNsYXNzKCdvcGVuJykuYWRkQ2xhc3MoJ2Nsb3NlZCcpOwogICAgICB9IGVsc2UgewogICAgICAgIGFjdGlvbnMuc2hvdygpOwogICAgICAgIHNjcm9sbHBhbmUuYXR0cignc2Nyb2xsVG9wJywgc2Nyb2xscGFuZS5hdHRyKCdzY3JvbGxIZWlnaHQnKSk7CiAgICAgICAgbmFtZS5yZW1vdmVDbGFzcygnY2xvc2VkJykuYWRkQ2xhc3MoJ29wZW4nKTsKICAgICAgfQogICAgfSk7CgogICAgc3BlY1VpTWFwW3NwZWMuaWRdID0gdWk7CiAgfSk7CgogIHJ1bm5lci5vbignU3BlY0Vycm9yJywgZnVuY3Rpb24oc3BlYywgZXJyb3IpIHsKICAgIHZhciB1aSA9IHNwZWNVaU1hcFtzcGVjLmlkXTsKICAgIHVpLmFwcGVuZCgnPHByZT48L3ByZT4nKTsKICAgIHVpLmZpbmQoJz4gcHJlJykudGV4dChmb3JtYXRFeGNlcHRpb24oZXJyb3IpKTsKICB9KTsKCiAgcnVubmVyLm9uKCdTcGVjRW5kJywgZnVuY3Rpb24oc3BlYykgewogICAgdmFyIHVpID0gc3BlY1VpTWFwW3NwZWMuaWRdOwogICAgc3BlYyA9IG1vZGVsLmdldFNwZWMoc3BlYy5pZCk7CiAgICB1aS5yZW1vdmVDbGFzcygnc3RhdHVzLXBlbmRpbmcnKTsKICAgIHVpLmFkZENsYXNzKCdzdGF0dXMtJyArIHNwZWMuc3RhdHVzKTsKICAgIHVpLmZpbmQoIj4gLnRlc3QtaW5mbyAudGltZXItcmVzdWx0IikudGV4dChzcGVjLmR1cmF0aW9uICsgIm1zIik7CiAgICBpZiAoc3BlYy5zdGF0dXMgPT09ICdzdWNjZXNzJykgewogICAgICB1aS5maW5kKCc+IC50ZXN0LWluZm8gLnRlc3QtbmFtZScpLmFkZENsYXNzKCdjbG9zZWQnKTsKICAgICAgdWkuZmluZCgnPiAuc2Nyb2xscGFuZSAudGVzdC1hY3Rpb25zJykuaGlkZSgpOwogICAgfQogICAgdXBkYXRlVG90YWxzKHNwZWMuc3RhdHVzKTsKICB9KTsKCiAgcnVubmVyLm9uKCdTdGVwQmVnaW4nLCBmdW5jdGlvbihzcGVjLCBzdGVwKSB7CiAgICB2YXIgdWkgPSBzcGVjVWlNYXBbc3BlYy5pZF07CiAgICBzcGVjID0gbW9kZWwuZ2V0U3BlYyhzcGVjLmlkKTsKICAgIHN0ZXAgPSBzcGVjLmdldExhc3RTdGVwKCk7CiAgICB1aS5maW5kKCc+IC5zY3JvbGxwYW5lIC50ZXN0LWFjdGlvbnMnKS5hcHBlbmQoJzxsaSBjbGFzcz0ic3RhdHVzLXBlbmRpbmciPjwvbGk+Jyk7CiAgICB2YXIgc3RlcFVpID0gbGFzdFN0ZXBVaU1hcFtzcGVjLmlkXSA9IHVpLmZpbmQoJz4gLnNjcm9sbHBhbmUgLnRlc3QtYWN0aW9ucyBsaTpsYXN0Jyk7CiAgICBzdGVwVWkuYXBwZW5kKAogICAgICAnPGRpdiBjbGFzcz0idGltZXItcmVzdWx0Ij48L2Rpdj4nICsKICAgICAgJzxkaXYgY2xhc3M9InRlc3QtdGl0bGUiPjwvZGl2PicKICAgICk7CiAgICBzdGVwVWkuZmluZCgnPiAudGVzdC10aXRsZScpLnRleHQoc3RlcC5uYW1lKTsKICAgIHZhciBzY3JvbGxwYW5lID0gc3RlcFVpLnBhcmVudHMoJy5zY3JvbGxwYW5lJyk7CiAgICBzY3JvbGxwYW5lLmF0dHIoJ3Njcm9sbFRvcCcsIHNjcm9sbHBhbmUuYXR0cignc2Nyb2xsSGVpZ2h0JykpOwogIH0pOwoKICBydW5uZXIub24oJ1N0ZXBGYWlsdXJlJywgZnVuY3Rpb24oc3BlYywgc3RlcCwgZXJyb3IpIHsKICAgIHZhciB1aSA9IGxhc3RTdGVwVWlNYXBbc3BlYy5pZF07CiAgICBhZGRFcnJvcih1aSwgc3RlcC5saW5lLCBlcnJvcik7CiAgfSk7CgogIHJ1bm5lci5vbignU3RlcEVycm9yJywgZnVuY3Rpb24oc3BlYywgc3RlcCwgZXJyb3IpIHsKICAgIHZhciB1aSA9IGxhc3RTdGVwVWlNYXBbc3BlYy5pZF07CiAgICBhZGRFcnJvcih1aSwgc3RlcC5saW5lLCBlcnJvcik7CiAgfSk7CgogIHJ1bm5lci5vbignU3RlcEVuZCcsIGZ1bmN0aW9uKHNwZWMsIHN0ZXApIHsKICAgIHZhciBzdGVwVWkgPSBsYXN0U3RlcFVpTWFwW3NwZWMuaWRdOwogICAgc3BlYyA9IG1vZGVsLmdldFNwZWMoc3BlYy5pZCk7CiAgICBzdGVwID0gc3BlYy5nZXRMYXN0U3RlcCgpOwogICAgc3RlcFVpLmZpbmQoJy50aW1lci1yZXN1bHQnKS50ZXh0KHN0ZXAuZHVyYXRpb24gKyAnbXMnKTsKICAgIHN0ZXBVaS5yZW1vdmVDbGFzcygnc3RhdHVzLXBlbmRpbmcnKTsKICAgIHN0ZXBVaS5hZGRDbGFzcygnc3RhdHVzLScgKyBzdGVwLnN0YXR1cyk7CiAgICB2YXIgc2Nyb2xscGFuZSA9IHNwZWNVaU1hcFtzcGVjLmlkXS5maW5kKCc+IC5zY3JvbGxwYW5lJyk7CiAgICBzY3JvbGxwYW5lLmF0dHIoJ3Njcm9sbFRvcCcsIHNjcm9sbHBhbmUuYXR0cignc2Nyb2xsSGVpZ2h0JykpOwogIH0pOwoKICAvKioKICAgKiBGaW5kcyB0aGUgY29udGV4dCBvZiBhIHNwZWMgYmxvY2sgZGVmaW5lZCBieSB0aGUgcGFzc2VkIGRlZmluaXRpb24uCiAgICoKICAgKiBAcGFyYW0ge09iamVjdH0gVGhlIGRlZmluaXRpb24gY3JlYXRlZCBieSB0aGUgRGVzY3JpYmUgb2JqZWN0LgogICAqLwogIGZ1bmN0aW9uIGZpbmRDb250ZXh0KHNwZWMpIHsKICAgIHZhciBjdXJyZW50Q29udGV4dCA9IGNvbnRleHQuZmluZCgnI3NwZWNzJyk7CiAgICBhbmd1bGFyLmZvckVhY2gobW9kZWwuZ2V0RGVmaW5pdGlvblBhdGgoc3BlYyksIGZ1bmN0aW9uKGRlZm4pIHsKICAgICAgdmFyIGlkID0gJ2Rlc2NyaWJlLScgKyBkZWZuLmlkOwogICAgICBpZiAoIWNvbnRleHQuZmluZCgnIycgKyBpZCkubGVuZ3RoKSB7CiAgICAgICAgY3VycmVudENvbnRleHQuZmluZCgnPiAudGVzdC1jaGlsZHJlbicpLmFwcGVuZCgKICAgICAgICAgICc8ZGl2IGNsYXNzPSJ0ZXN0LWRlc2NyaWJlIiBpZD0iJyArIGlkICsgJyI+JyArCiAgICAgICAgICAnICA8aDI+PC9oMj4nICsKICAgICAgICAgICcgIDxkaXYgY2xhc3M9InRlc3QtY2hpbGRyZW4iPjwvZGl2PicgKwogICAgICAgICAgJyAgPHVsIGNsYXNzPSJ0ZXN0cyI+PC91bD4nICsKICAgICAgICAgICc8L2Rpdj4nCiAgICAgICAgKTsKICAgICAgICBjb250ZXh0LmZpbmQoJyMnICsgaWQpLmZpbmQoJz4gaDInKS50ZXh0KCdkZXNjcmliZTogJyArIGRlZm4ubmFtZSk7CiAgICAgIH0KICAgICAgY3VycmVudENvbnRleHQgPSBjb250ZXh0LmZpbmQoJyMnICsgaWQpOwogICAgfSk7CiAgICByZXR1cm4gY29udGV4dC5maW5kKCcjZGVzY3JpYmUtJyArIHNwZWMuZGVmaW5pdGlvbi5pZCk7CiAgfTsKCiAgLyoqCiAgICogVXBkYXRlcyB0aGUgdGVzdCBjb3VudGVyIGZvciB0aGUgc3RhdHVzLgogICAqCiAgICogQHBhcmFtIHtzdHJpbmd9IHRoZSBzdGF0dXMuCiAgICovCiAgZnVuY3Rpb24gdXBkYXRlVG90YWxzKHN0YXR1cykgewogICAgdmFyIGxlZ2VuZCA9IGNvbnRleHQuZmluZCgnI3N0YXR1cy1sZWdlbmQgLnN0YXR1cy0nICsgc3RhdHVzKTsKICAgIHZhciBwYXJ0cyA9IGxlZ2VuZC50ZXh0KCkuc3BsaXQoJyAnKTsKICAgIHZhciB2YWx1ZSA9IChwYXJ0c1swXSAqIDEpICsgMTsKICAgIGxlZ2VuZC50ZXh0KHZhbHVlICsgJyAnICsgcGFydHNbMV0pOwogIH0KCiAgLyoqCiAgICogQWRkIGFuIGVycm9yIHRvIGEgc3RlcC4KICAgKgogICAqIEBwYXJhbSB7T2JqZWN0fSBUaGUgSlF1ZXJ5IHdyYXBwZWQgY29udGV4dAogICAqIEBwYXJhbSB7RnVuY3Rpb259IGZuKCkgdGhhdCBzaG91bGQgcmV0dXJuIHRoZSBmaWxlL2xpbmUgbnVtYmVyIG9mIHRoZSBlcnJvcgogICAqIEBwYXJhbSB7T2JqZWN0fSB0aGUgZXJyb3IuCiAgICovCiAgZnVuY3Rpb24gYWRkRXJyb3IoY29udGV4dCwgbGluZSwgZXJyb3IpIHsKICAgIGNvbnRleHQuZmluZCgnLnRlc3QtdGl0bGUnKS5hcHBlbmQoJzxwcmU+PC9wcmU+Jyk7CiAgICB2YXIgbWVzc2FnZSA9IF9qUXVlcnkudHJpbShsaW5lKCkgKyAnXG5cbicgKyBmb3JtYXRFeGNlcHRpb24oZXJyb3IpKTsKICAgIGNvbnRleHQuZmluZCgnLnRlc3QtdGl0bGUgcHJlOmxhc3QnKS50ZXh0KG1lc3NhZ2UpOwogIH07Cn0pOwondXNlIHN0cmljdCc7CgovKioKICogR2VuZXJhdGVzIEpTT04gb3V0cHV0IGludG8gYSBjb250ZXh0LgogKi8KYW5ndWxhci5zY2VuYXJpby5vdXRwdXQoJ2pzb24nLCBmdW5jdGlvbihjb250ZXh0LCBydW5uZXIsIG1vZGVsKSB7CiAgbW9kZWwub24oJ1J1bm5lckVuZCcsIGZ1bmN0aW9uKCkgewogICAgY29udGV4dC50ZXh0KGFuZ3VsYXIudG9Kc29uKG1vZGVsLnZhbHVlKSk7CiAgfSk7Cn0pOwondXNlIHN0cmljdCc7CgovKioKICogR2VuZXJhdGVzIFhNTCBvdXRwdXQgaW50byBhIGNvbnRleHQuCiAqLwphbmd1bGFyLnNjZW5hcmlvLm91dHB1dCgneG1sJywgZnVuY3Rpb24oY29udGV4dCwgcnVubmVyLCBtb2RlbCkgewogIHZhciAkID0gZnVuY3Rpb24oYXJncykge3JldHVybiBuZXcgY29udGV4dC5pbml0KGFyZ3MpO307CiAgbW9kZWwub24oJ1J1bm5lckVuZCcsIGZ1bmN0aW9uKCkgewogICAgdmFyIHNjZW5hcmlvID0gJCgnPHNjZW5hcmlvPjwvc2NlbmFyaW8+Jyk7CiAgICBjb250ZXh0LmFwcGVuZChzY2VuYXJpbyk7CiAgICBzZXJpYWxpemVYbWwoc2NlbmFyaW8sIG1vZGVsLnZhbHVlKTsKICB9KTsKCiAgLyoqCiAgICogQ29udmVydCB0aGUgdHJlZSBpbnRvIFhNTC4KICAgKgogICAqIEBwYXJhbSB7T2JqZWN0fSBjb250ZXh0IGpRdWVyeSBjb250ZXh0IHRvIGFkZCB0aGUgWE1MIHRvLgogICAqIEBwYXJhbSB7T2JqZWN0fSB0cmVlIG5vZGUgdG8gc2VyaWFsaXplCiAgICovCiAgZnVuY3Rpb24gc2VyaWFsaXplWG1sKGNvbnRleHQsIHRyZWUpIHsKICAgICBhbmd1bGFyLmZvckVhY2godHJlZS5jaGlsZHJlbiwgZnVuY3Rpb24oY2hpbGQpIHsKICAgICAgIHZhciBkZXNjcmliZUNvbnRleHQgPSAkKCc8ZGVzY3JpYmU+PC9kZXNjcmliZT4nKTsKICAgICAgIGRlc2NyaWJlQ29udGV4dC5hdHRyKCdpZCcsIGNoaWxkLmlkKTsKICAgICAgIGRlc2NyaWJlQ29udGV4dC5hdHRyKCduYW1lJywgY2hpbGQubmFtZSk7CiAgICAgICBjb250ZXh0LmFwcGVuZChkZXNjcmliZUNvbnRleHQpOwogICAgICAgc2VyaWFsaXplWG1sKGRlc2NyaWJlQ29udGV4dCwgY2hpbGQpOwogICAgIH0pOwogICAgIHZhciBpdHMgPSAkKCc8aXRzPjwvaXRzPicpOwogICAgIGNvbnRleHQuYXBwZW5kKGl0cyk7CiAgICAgYW5ndWxhci5mb3JFYWNoKHRyZWUuc3BlY3MsIGZ1bmN0aW9uKHNwZWMpIHsKICAgICAgIHZhciBpdCA9ICQoJzxpdD48L2l0PicpOwogICAgICAgaXQuYXR0cignaWQnLCBzcGVjLmlkKTsKICAgICAgIGl0LmF0dHIoJ25hbWUnLCBzcGVjLm5hbWUpOwogICAgICAgaXQuYXR0cignZHVyYXRpb24nLCBzcGVjLmR1cmF0aW9uKTsKICAgICAgIGl0LmF0dHIoJ3N0YXR1cycsIHNwZWMuc3RhdHVzKTsKICAgICAgIGl0cy5hcHBlbmQoaXQpOwogICAgICAgYW5ndWxhci5mb3JFYWNoKHNwZWMuc3RlcHMsIGZ1bmN0aW9uKHN0ZXApIHsKICAgICAgICAgdmFyIHN0ZXBDb250ZXh0ID0gJCgnPHN0ZXA+PC9zdGVwPicpOwogICAgICAgICBzdGVwQ29udGV4dC5hdHRyKCduYW1lJywgc3RlcC5uYW1lKTsKICAgICAgICAgc3RlcENvbnRleHQuYXR0cignZHVyYXRpb24nLCBzdGVwLmR1cmF0aW9uKTsKICAgICAgICAgc3RlcENvbnRleHQuYXR0cignc3RhdHVzJywgc3RlcC5zdGF0dXMpOwogICAgICAgICBpdC5hcHBlbmQoc3RlcENvbnRleHQpOwogICAgICAgICBpZiAoc3RlcC5lcnJvcikgewogICAgICAgICAgIHZhciBlcnJvciA9ICQoJzxlcnJvcj48L2Vycm9yJyk7CiAgICAgICAgICAgc3RlcENvbnRleHQuYXBwZW5kKGVycm9yKTsKICAgICAgICAgICBlcnJvci50ZXh0KGZvcm1hdEV4Y2VwdGlvbihzdGVwQ29udGV4dC5lcnJvcikpOwogICAgICAgICB9CiAgICAgICB9KTsKICAgICB9KTsKICAgfQp9KTsKJ3VzZSBzdHJpY3QnOwoKLyoqCiAqIENyZWF0ZXMgYSBnbG9iYWwgdmFsdWUgJHJlc3VsdCB3aXRoIHRoZSByZXN1bHQgb2YgdGhlIHJ1bm5lci4KICovCmFuZ3VsYXIuc2NlbmFyaW8ub3V0cHV0KCdvYmplY3QnLCBmdW5jdGlvbihjb250ZXh0LCBydW5uZXIsIG1vZGVsKSB7CiAgcnVubmVyLiR3aW5kb3cuJHJlc3VsdCA9IG1vZGVsLnZhbHVlOwp9KTsKdmFyICRydW5uZXIgPSBuZXcgYW5ndWxhci5zY2VuYXJpby5SdW5uZXIod2luZG93KSwKICAgIGNvbmZpZyA9IGFuZ3VsYXJKc0NvbmZpZyhkb2N1bWVudCk7CgppZiAoY29uZmlnLmF1dG90ZXN0KSB7CiAganFMaXRlV3JhcChkb2N1bWVudCkucmVhZHkoZnVuY3Rpb24oKSB7CiAgICBhbmd1bGFyLnNjZW5hcmlvLnNldFVwQW5kUnVuKGNvbmZpZyk7CiAgfSk7Cn0KfSkod2luZG93LCBkb2N1bWVudCk7Cgphbmd1bGFyLmVsZW1lbnQoZG9jdW1lbnQpLmZpbmQoJ2hlYWQnKS5hcHBlbmQoJzxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+QGNoYXJzZXQgIlVURi04IjtcblxuLm5nLWZvcm1hdC1uZWdhdGl2ZSB7XG4gIGNvbG9yOiByZWQ7XG59XG5cbi5uZy1leGNlcHRpb24ge1xuICBib3JkZXI6IDJweCBzb2xpZCAjRkYwMDAwO1xuICBmb250LWZhbWlseTogIkNvdXJpZXIgTmV3IiwgQ291cmllciwgbW9ub3NwYWNlO1xuICBmb250LXNpemU6IHNtYWxsZXI7XG4gIHdoaXRlLXNwYWNlOiBwcmU7XG59XG5cbi5uZy12YWxpZGF0aW9uLWVycm9yIHtcbiAgYm9yZGVyOiAycHggc29saWQgI0ZGMDAwMDtcbn1cblxuXG4vKioqKioqKioqKioqKioqKipcbiAqIFRJUFxuICoqKioqKioqKioqKioqKioqL1xuI25nLWNhbGxvdXQge1xuICBtYXJnaW46IDA7XG4gIHBhZGRpbmc6IDA7XG4gIGJvcmRlcjogMDtcbiAgb3V0bGluZTogMDtcbiAgZm9udC1zaXplOiAxM3B4O1xuICBmb250LXdlaWdodDogbm9ybWFsO1xuICBmb250LWZhbWlseTogVmVyZGFuYSwgQXJpYWwsIEhlbHZldGljYSwgc2Fucy1zZXJpZjtcbiAgdmVydGljYWwtYWxpZ246IGJhc2VsaW5lO1xuICBiYWNrZ3JvdW5kOiB0cmFuc3BhcmVudDtcbiAgdGV4dC1kZWNvcmF0aW9uOiBub25lO1xufVxuXG4jbmctY2FsbG91dCAubmctYXJyb3ctbGVmdHtcbiAgYmFja2dyb3VuZC1pbWFnZTogdXJsKCJkYXRhOmltYWdlL2dpZjtiYXNlNjQsUjBsR09EbGhDd0FYQUtJQUFNek16Ty92Ny9mMzkvLy8vLy8vL3dBQUFBQUFBQUFBQUNINUJBVVVBQVFBTEFBQUFBQUxBQmNBQUFNclNMb2MvQUc4RmVVVUlOK3NHZWJXQW5iS1NKb2RxcWxzT3hKdHFZb29VOXZ2ayt2Y0pJY1RrZytRQUFBNyIpO1xuICBiYWNrZ3JvdW5kLXJlcGVhdDogbm8tcmVwZWF0O1xuICBiYWNrZ3JvdW5kLXBvc2l0aW9uOiBsZWZ0IHRvcDtcbiAgcG9zaXRpb246IGFic29sdXRlO1xuICB6LWluZGV4OjEwMTtcbiAgbGVmdDotMTJweDtcbiAgaGVpZ2h0OjIzcHg7XG4gIHdpZHRoOjEwcHg7XG4gIHRvcDotM3B4O1xufVxuXG4jbmctY2FsbG91dCAubmctYXJyb3ctcmlnaHR7XG4gIGJhY2tncm91bmQtaW1hZ2U6IHVybCgiZGF0YTppbWFnZS9naWY7YmFzZTY0LFIwbEdPRGxoQ3dBWEFLSUFBTXpNek8vdjcvZjM5Ly8vLy8vLy93QUFBQUFBQUFBQUFDSDVCQVVVQUFRQUxBQUFBQUFMQUJjQUFBTXJDTFRjb00yOXlONms5c29jczkxZTVYM0V5SmxvaXBZck80b2hUTXFBMEZuMlhWTnN3SmUrSCtTWEFBQTciKTtcbiAgYmFja2dyb3VuZC1yZXBlYXQ6IG5vLXJlcGVhdDtcbiAgYmFja2dyb3VuZC1wb3NpdGlvbjogbGVmdCB0b3A7XG4gIHBvc2l0aW9uOiBhYnNvbHV0ZTtcbiAgei1pbmRleDoxMDE7XG4gIGhlaWdodDoyM3B4O1xuICB3aWR0aDoxMXB4O1xuICAgIHRvcDotMnB4O1xufVxuXG4jbmctY2FsbG91dCB7XG4gIHBvc2l0aW9uOiBhYnNvbHV0ZTtcbiAgei1pbmRleDoxMDA7XG4gIGJvcmRlcjogMnB4IHNvbGlkICNDQ0NDQ0M7XG4gIGJhY2tncm91bmQtY29sb3I6ICNmZmY7XG59XG5cbiNuZy1jYWxsb3V0IC5uZy1jb250ZW50e1xuICBwYWRkaW5nOjEwcHggMTBweCAxMHB4IDEwcHg7XG4gIGNvbG9yOiMzMzMzMzM7XG59XG5cbiNuZy1jYWxsb3V0IC5uZy10aXRsZXtcbiAgYmFja2dyb3VuZC1jb2xvcjogI0NDQ0NDQztcbiAgdGV4dC1hbGlnbjogbGVmdDtcbiAgcGFkZGluZy1sZWZ0OiA4cHg7XG4gIHBhZGRpbmctYm90dG9tOiA1cHg7XG4gIHBhZGRpbmctdG9wOiAycHg7XG4gIGZvbnQtd2VpZ2h0OmJvbGQ7XG59XG5cblxuLyoqKioqKioqKioqKioqKioqXG4gKiBpbmRpY2F0b3JzXG4gKioqKioqKioqKioqKioqKiovXG4ubmctaW5wdXQtaW5kaWNhdG9yLXdhaXQge1xuICBiYWNrZ3JvdW5kLWltYWdlOiB1cmwoImRhdGE6aW1hZ2UvcG5nO2Jhc2U2NCxSMGxHT0RsaEVBQVFBUFFBQVAvLy93QUFBUER3OElxS2l1RGc0RVpHUm5wNmVnQUFBRmhZV0NRa0pLeXNyTDYrdmhRVUZKeWNuQVFFQkRZMk5taG9hQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQ0gvQzA1RlZGTkRRVkJGTWk0d0F3RUFBQUFoL2hwRGNtVmhkR1ZrSUhkcGRHZ2dZV3BoZUd4dllXUXVhVzVtYndBaCtRUUpDZ0FBQUN3QUFBQUFFQUFRQUFBRmR5QWdBZ0lKSWVXb0FrUkNDTWRCa0t0SUhJbmd5TUtzRXJQQlliQURwa1NDd2hEbVFDQmV0aFJCNlZqNGtGQ2tRUEc0SWxXRGdyTlJJd25PNFVLQlhEdWZ6UXZETWFvU0RCZ0ZiODg2TWlRYWRnTkFCQW9rZkN3ekJBOExDZzBFZ2w4akFnZ0dBQTFrQklBMUJBWXpseUlMY3pVTEMyVWhBQ0g1QkFrS0FBQUFMQUFBQUFBUUFCQUFBQVYySUNBQ0FtbEFaVG1PUkVFSXlVRVFqTEtLeFBIQURoRXZxeGxnY0dna0dJMURZU1ZBSUFXTXgrbHdTS2tJQ0owUXNIaTlSZ0tCd25WVGlSUVFnd0Y0STRVRkRRUUV3aTYvM1lTR1dSUm1qaEVFVEFKZklnTUZDbkFLTTBLRFY0RUVFQVFMaUYxOFRBWU5YRGFTZTN4Nm1qaWROMXMzSVFBaCtRUUpDZ0FBQUN3QUFBQUFFQUFRQUFBRmVDQWdBZ0xaREdVNWpnUkVDRVVpQ0kreWlvU0R3REp5TEtzWG9IRlF4QlNIQW9BQUZCaHF0TUpnOERnUUJnZnJFc0pBRUFnNFloWklFaXdnS3RIaU1CZ3RwZzN3YlVaWEdPN2tPYjFNVUtSRk15c0NDaEFvZ2dKQ0lnMEdDMmFOZTRncVFsZGZMNGwvQWcxQVh5U0pnbjVMY29FM1FYSTNJUUFoK1FRSkNnQUFBQ3dBQUFBQUVBQVFBQUFGZGlBZ0FnTFpOR1U1am9RaENFanhJc3NxRW84YkM5QlJqeTlBZzdHSUxRNFFFb0UwZ0JBRUJjT3BjQkEwRG94U0svZThMUklIbitpMWNLMEl5S2RnMFZBb2xqWUlnK0dnblJyd1ZTLzhJQWtJQ3lvc0JJUXBCQU1vS3k5ZElteFBoUytHS2tGcmtYK1RpZ3RMbEl5S1hVRitOamFnTmlFQUlma0VDUW9BQUFBc0FBQUFBQkFBRUFBQUJXd2dJQUlDYVJobE9ZNEVJZ2pIOFI3TEtoS0hHd3NNdmI0QUF5M1dPREJJQkJLQ3NZQTlUanVoRE5ES0VWU0VSZXpRRUwwV3JoWHVjUlVRR3VpazdiRmxuZ3pxVlc5TE1sOVhXdkxkakZhSnRERnFaMWNFWlVCMGRVZ3ZMM2RnUDRXSlpuNGprb21XTnBTVEl5RUFJZmtFQ1FvQUFBQXNBQUFBQUJBQUVBQUFCWDRnSUFJQ3VTeGxPWTZDSWdpRDhSckVLZ3FHT3d4d1VyTWxBb1N3SXpBR3BKcGdvU0RBR2lmRFk1a29wQllEbEVwQVFCd2V2eGZCdFJJVUdpOHh3V2tETkJDSXdtQzlWcTBhaVFRRFF1SytWZ1FQRFhWOWhDSmpCd2NGWVU1cEx3d0hYUWNNS1NtTkxRY0lBRXhsYkg4SkJ3dHRhWDBBQkFjTmJXVmJLeUVBSWZrRUNRb0FBQUFzQUFBQUFCQUFFQUFBQlhrZ0lBSUNTUkJsT1k3Q0lnaE44emJFS3NLb0lqZEZ6WmFFZ1VCSEtDaE1KdFJ3Y1dwQVdvV25pZm02RVNBTWhPOGxRSzBFRUFWM3JGb3BJQkNFY0d3REtBcVBoNEhVclk0SUNISDFkU29URmdjSFVpWmpCaEFKQjJBSER5a3BLQXdIQXdkemYxOUtrQVNJUGw5Y0RnY25Ea2R0TndpTUpDc2hBQ0g1QkFrS0FBQUFMQUFBQUFBUUFCQUFBQVYzSUNBQ0Fra1FaVG1PQWlvc2l5QW94Q3ErS1B4Q05Wc1NNUmdCc2lDbFdyTFRTV0ZvSVFaSGw2cGxlQmg2c3V4S01JaGx2emJBd2tCV2ZGV3JCUVR4TkxxMlJHMnloU1VrRHMyYjYzQVlEQW9KWEFjRlJ3QURlQWtKRFgwQVFDc0VmQVFNREFJUEJ6MHJDZ2N4a3kwSlJXRTFBbXdwS3lFQUlma0VDUW9BQUFBc0FBQUFBQkFBRUFBQUJYa2dJQUlDS1p6a3FKNG5RWnhMcVpLdjROcU5MS0syL1E0RWs0bEZYQ2hzZzV5cEpqczFJSTNnRURVU1JJbkVHWUF3NkI2ek00SmhyREF0RW9zVmtMVXRIQTdSSGFIQUdKUUVqc09EY0VnMEZCQUZWZ2tRSlExcEF3Y0REdzhLY0Z0U0lud0pBb3dDQ0E2Ukl3cVpBZ2tQTmdWcFduZGpkeW9oQUNINUJBa0tBQUFBTEFBQUFBQVFBQkFBQUFWNUlDQUNBaW1jNUtpZUxFdVVLdm0yeEFLTHFEQ2ZDMkdhTzllTDBMQUJXVGlCWW1BMDZXNmtIZ3ZDcUVKaUFJSml1M2djdmdVc3NjSFVFUm0ra2FDeHl4YSt6UlBrMFNnSkVnZkl2YkFkSUFRTENBWWxDajREQncwSUJRc01DaklxQkFjUEFvb0NCZzlwS2dzSkx3VUZPaENaS3lRREEzWXFJUUFoK1FRSkNnQUFBQ3dBQUFBQUVBQVFBQUFGZFNBZ0FnSXBuT1Nvbm14YnFpVGhDckpLRUhGYm84SnhERE9aWUZGYitBNDFFNEg0T2hrT2lwWHdCRWxZSVREQWNrRkVPQmdNUTNhcmtNa1VCZHhJVUdacEViN2thUUJSbEFTUGcwRlFRSEFiRUVNR0RTVkVBQTFRQmhBRUQxRTBOZ3dGQW9vQ0RXbGphUUlRQ0U1cU1IY05oQ2tqSVFBaCtRUUpDZ0FBQUN3QUFBQUFFQUFRQUFBRmVTQWdBZ0lwbk9Tb0xneHh2cWdLTEVjQ0M2NUtFQUJ5S0s4Y1NwQTREQWlIUS9Ea0toR0toNFpDdEN5WkdvNkY2aVlZUEFxRmdZeTAyeGtTYUxFTVYzNHRFTHlSWU5Fc0NReUhsdldrR0N6c1BnTUNFQVk3Q2cwNFVrNDhMQXNEaFJBOE1WUVBFRjBHQWdxWVl3U1JseWNOY1dza0NrQXBJeUVBT3dBQUFBQUFBQUFBQUE9PSIpO1xuICBiYWNrZ3JvdW5kLXBvc2l0aW9uOiByaWdodDtcbiAgYmFja2dyb3VuZC1yZXBlYXQ6IG5vLXJlcGVhdDtcbn1cbjwvc3R5bGU+Jyk7CmFuZ3VsYXIuZWxlbWVudChkb2N1bWVudCkuZmluZCgnaGVhZCcpLmFwcGVuZCgnPHN0eWxlIHR5cGU9InRleHQvY3NzIj5AY2hhcnNldCAiVVRGLTgiO1xuLyogQ1NTIERvY3VtZW50ICovXG5cbi8qKiBTdHJ1Y3R1cmUgKi9cbmJvZHkge1xuICBmb250LWZhbWlseTogQXJpYWwsIHNhbnMtc2VyaWY7XG4gIG1hcmdpbjogMDtcbiAgZm9udC1zaXplOiAxNHB4O1xufVxuXG4jc3lzdGVtLWVycm9yIHtcbiAgZm9udC1zaXplOiAxLjVlbTtcbiAgdGV4dC1hbGlnbjogY2VudGVyO1xufVxuXG4janNvbiwgI3htbCB7XG4gIGRpc3BsYXk6IG5vbmU7XG59XG5cbiNoZWFkZXIge1xuICBwb3NpdGlvbjogZml4ZWQ7XG4gIHdpZHRoOiAxMDAlO1xufVxuXG4jc3BlY3Mge1xuICBwYWRkaW5nLXRvcDogNTBweDtcbn1cblxuI2hlYWRlciAuYW5ndWxhciB7XG4gIGZvbnQtZmFtaWx5OiBDb3VyaWVyIE5ldywgbW9ub3NwYWNlO1xuICBmb250LXdlaWdodDogYm9sZDtcbn1cblxuI2hlYWRlciBoMSB7XG4gIGZvbnQtd2VpZ2h0OiBub3JtYWw7XG4gIGZsb2F0OiBsZWZ0O1xuICBmb250LXNpemU6IDMwcHg7XG4gIGxpbmUtaGVpZ2h0OiAzMHB4O1xuICBtYXJnaW46IDA7XG4gIHBhZGRpbmc6IDEwcHggMTBweDtcbiAgaGVpZ2h0OiAzMHB4O1xufVxuXG4jYXBwbGljYXRpb24gaDIsXG4jc3BlY3MgaDIge1xuICBtYXJnaW46IDA7XG4gIHBhZGRpbmc6IDAuNWVtO1xuICBmb250LXNpemU6IDEuMWVtO1xufVxuXG4jc3RhdHVzLWxlZ2VuZCB7XG4gIG1hcmdpbi10b3A6IDEwcHg7XG4gIG1hcmdpbi1yaWdodDogMTBweDtcbn1cblxuI2hlYWRlcixcbiNhcHBsaWNhdGlvbixcbi50ZXN0LWluZm8sXG4udGVzdC1hY3Rpb25zIGxpIHtcbiAgb3ZlcmZsb3c6IGhpZGRlbjtcbn1cblxuI2FwcGxpY2F0aW9uIHtcbiAgbWFyZ2luOiAxMHB4O1xufVxuXG4jYXBwbGljYXRpb24gaWZyYW1lIHtcbiAgd2lkdGg6IDEwMCU7XG4gIGhlaWdodDogNzU4cHg7XG59XG5cbiNhcHBsaWNhdGlvbiAucG9wb3V0IHtcbiAgZmxvYXQ6IHJpZ2h0O1xufVxuXG4jYXBwbGljYXRpb24gaWZyYW1lIHtcbiAgYm9yZGVyOiBub25lO1xufVxuXG4udGVzdHMgbGksXG4udGVzdC1hY3Rpb25zIGxpLFxuLnRlc3QtaXQgbGksXG4udGVzdC1pdCBvbCxcbi5zdGF0dXMtZGlzcGxheSB7XG4gIGxpc3Qtc3R5bGUtdHlwZTogbm9uZTtcbn1cblxuLnRlc3RzLFxuLnRlc3QtaXQgb2wsXG4uc3RhdHVzLWRpc3BsYXkge1xuICBtYXJnaW46IDA7XG4gIHBhZGRpbmc6IDA7XG59XG5cbi50ZXN0LWluZm8ge1xuICBtYXJnaW4tbGVmdDogMWVtO1xuICBtYXJnaW4tdG9wOiAwLjVlbTtcbiAgYm9yZGVyLXJhZGl1czogOHB4IDAgMCA4cHg7XG4gIC13ZWJraXQtYm9yZGVyLXJhZGl1czogOHB4IDAgMCA4cHg7XG4gIC1tb3otYm9yZGVyLXJhZGl1czogOHB4IDAgMCA4cHg7XG4gIGN1cnNvcjogcG9pbnRlcjtcbn1cblxuLnRlc3QtaW5mbzpob3ZlciAudGVzdC1uYW1lIHtcbiAgdGV4dC1kZWNvcmF0aW9uOiB1bmRlcmxpbmU7XG59XG5cbi50ZXN0LWluZm8gLmNsb3NlZDpiZWZvcmUge1xuICBjb250ZW50OiBcJ1xcMjViOFxcMDBBMFwnO1xufVxuXG4udGVzdC1pbmZvIC5vcGVuOmJlZm9yZSB7XG4gIGNvbnRlbnQ6IFwnXFwyNWJlXFwwMEEwXCc7XG4gIGZvbnQtd2VpZ2h0OiBib2xkO1xufVxuXG4udGVzdC1pdCBvbCB7XG4gIG1hcmdpbi1sZWZ0OiAyLjVlbTtcbn1cblxuLnN0YXR1cy1kaXNwbGF5LFxuLnN0YXR1cy1kaXNwbGF5IGxpIHtcbiAgZmxvYXQ6IHJpZ2h0O1xufVxuXG4uc3RhdHVzLWRpc3BsYXkgbGkge1xuICBwYWRkaW5nOiA1cHggMTBweDtcbn1cblxuLnRpbWVyLXJlc3VsdCxcbi50ZXN0LXRpdGxlIHtcbiAgZGlzcGxheTogaW5saW5lLWJsb2NrO1xuICBtYXJnaW46IDA7XG4gIHBhZGRpbmc6IDRweDtcbn1cblxuLnRlc3QtYWN0aW9ucyAudGVzdC10aXRsZSxcbi50ZXN0LWFjdGlvbnMgLnRlc3QtcmVzdWx0IHtcbiAgZGlzcGxheTogdGFibGUtY2VsbDtcbiAgcGFkZGluZy1sZWZ0OiAwLjVlbTtcbiAgcGFkZGluZy1yaWdodDogMC41ZW07XG59XG5cbi50ZXN0LWFjdGlvbnMge1xuICBkaXNwbGF5OiB0YWJsZTtcbn1cblxuLnRlc3QtYWN0aW9ucyBsaSB7XG4gIGRpc3BsYXk6IHRhYmxlLXJvdztcbn1cblxuLnRpbWVyLXJlc3VsdCB7XG4gIHdpZHRoOiA0ZW07XG4gIHBhZGRpbmc6IDAgMTBweDtcbiAgdGV4dC1hbGlnbjogcmlnaHQ7XG4gIGZvbnQtZmFtaWx5OiBtb25vc3BhY2U7XG59XG5cbi50ZXN0LWl0IHByZSxcbi50ZXN0LWFjdGlvbnMgcHJlIHtcbiAgY2xlYXI6IGxlZnQ7XG4gIGNvbG9yOiBibGFjaztcbiAgbWFyZ2luLWxlZnQ6IDZlbTtcbn1cblxuLnRlc3QtZGVzY3JpYmUge1xuICBwYWRkaW5nLWJvdHRvbTogMC41ZW07XG59XG5cbi50ZXN0LWRlc2NyaWJlIC50ZXN0LWRlc2NyaWJlIHtcbiAgbWFyZ2luOiA1cHggNXB4IDEwcHggMmVtO1xufVxuXG4udGVzdC1hY3Rpb25zIC5zdGF0dXMtcGVuZGluZyAudGVzdC10aXRsZTpiZWZvcmUge1xuICBjb250ZW50OiBcJ1xcMDBiYlxcMDBBMFwnO1xufVxuXG4uc2Nyb2xscGFuZSB7XG4gICBtYXgtaGVpZ2h0OiAyMGVtO1xuICAgb3ZlcmZsb3c6IGF1dG87XG59XG5cbi8qKiBDb2xvcnMgKi9cblxuI2hlYWRlciB7XG4gIGJhY2tncm91bmQtY29sb3I6ICNGMkMyMDA7XG59XG5cbiNzcGVjcyBoMiB7XG4gIGJvcmRlci10b3A6IDJweCBzb2xpZCAjQkFCQUQxO1xufVxuXG4jc3BlY3MgaDIsXG4jYXBwbGljYXRpb24gaDIge1xuICBiYWNrZ3JvdW5kLWNvbG9yOiAjZWZlZmVmO1xufVxuXG4jYXBwbGljYXRpb24ge1xuICBib3JkZXI6IDFweCBzb2xpZCAjQkFCQUQxO1xufVxuXG4udGVzdC1kZXNjcmliZSAudGVzdC1kZXNjcmliZSB7XG4gIGJvcmRlci1sZWZ0OiAxcHggc29saWQgI0JBQkFEMTtcbiAgYm9yZGVyLXJpZ2h0OiAxcHggc29saWQgI0JBQkFEMTtcbiAgYm9yZGVyLWJvdHRvbTogMXB4IHNvbGlkICNCQUJBRDE7XG59XG5cbi5zdGF0dXMtZGlzcGxheSB7XG4gIGJvcmRlcjogMXB4IHNvbGlkICM3Nzc7XG59XG5cbi5zdGF0dXMtZGlzcGxheSAuc3RhdHVzLXBlbmRpbmcsXG4uc3RhdHVzLXBlbmRpbmcgLnRlc3QtaW5mbyB7XG4gIGJhY2tncm91bmQtY29sb3I6ICNGOUVFQkM7XG59XG5cbi5zdGF0dXMtZGlzcGxheSAuc3RhdHVzLXN1Y2Nlc3MsXG4uc3RhdHVzLXN1Y2Nlc3MgLnRlc3QtaW5mbyB7XG4gIGJhY2tncm91bmQtY29sb3I6ICNCMUQ3QTE7XG59XG5cbi5zdGF0dXMtZGlzcGxheSAuc3RhdHVzLWZhaWx1cmUsXG4uc3RhdHVzLWZhaWx1cmUgLnRlc3QtaW5mbyB7XG4gIGJhY2tncm91bmQtY29sb3I6ICNGRjgyODY7XG59XG5cbi5zdGF0dXMtZGlzcGxheSAuc3RhdHVzLWVycm9yLFxuLnN0YXR1cy1lcnJvciAudGVzdC1pbmZvIHtcbiAgYmFja2dyb3VuZC1jb2xvcjogYmxhY2s7XG4gIGNvbG9yOiB3aGl0ZTtcbn1cblxuLnRlc3QtYWN0aW9ucyAuc3RhdHVzLXN1Y2Nlc3MgLnRlc3QtdGl0bGUge1xuICBjb2xvcjogIzMwQjMwQTtcbn1cblxuLnRlc3QtYWN0aW9ucyAuc3RhdHVzLWZhaWx1cmUgLnRlc3QtdGl0bGUge1xuICBjb2xvcjogI0RGMDAwMDtcbn1cblxuLnRlc3QtYWN0aW9ucyAuc3RhdHVzLWVycm9yIC50ZXN0LXRpdGxlIHtcbiAgY29sb3I6IGJsYWNrO1xufVxuXG4udGVzdC1hY3Rpb25zIC50aW1lci1yZXN1bHQge1xuICBjb2xvcjogIzg4ODtcbn1cbjwvc3R5bGU+Jyk7",
                "body": "LyohCiAqIGpRdWVyeSBKYXZhU2NyaXB0IExpYnJhcnkgdjEuNC4yCiAqIGh0dHA6Ly9qcXVlcnkuY29tLwogKgogKiBDb3B5cmlnaHQgMjAxMCwgSm9obiBSZXNpZwogKiBEdWFsIGxpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgb3IgR1BMIFZlcnNpb24gMiBsaWNlbnNlcy4KICogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQogKgogKiBJbmNsdWRlcyBTaXp6bGUuanMKICogaHR0cDovL3NpenpsZWpzLmNvbS8KICogQ29weXJpZ2h0IDIwMTAsIFRoZSBEb2pvIEZvdW5kYXRpb24KICogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCwgQlNELCBhbmQgR1BMIExpY2Vuc2VzLgogKgogKiBEYXRlOiBTYXQgRmViIDEzIDIyOjMzOjQ4IDIwMTAgLTA1MDAKICovCihmdW5jdGlvbiggd2luZG93LCB1bmRlZmluZWQgKSB7CgovLyBEZWZpbmUgYSBsb2NhbCBjb3B5IG9mIGpRdWVyeQp2YXIgalF1ZXJ5ID0gZnVuY3Rpb24oIHNlbGVjdG9yLCBjb250ZXh0ICkgewoJCS8vIFRoZSBqUXVlcnkgb2JqZWN0IGlzIGFjdHVhbGx5IGp1c3QgdGhlIGluaXQgY29uc3RydWN0b3IgJ2VuaGFuY2VkJwoJCXJldHVybiBuZXcgalF1ZXJ5LmZuLmluaXQoIHNlbGVjdG9yLCBjb250ZXh0ICk7Cgl9LAoKCS8vIE1hcCBvdmVyIGpRdWVyeSBpbiBjYXNlIG9mIG92ZXJ3cml0ZQoJX2pRdWVyeSA9IHdpbmRvdy5qUXVlcnksCgoJLy8gTWFwIG92ZXIgdGhlICQgaW4gY2FzZSBvZiBvdmVyd3JpdGUKCV8kID0gd2luZG93LiQsCgoJLy8gVXNlIHRoZSBjb3JyZWN0IGRvY3VtZW50IGFjY29yZGluZ2x5IHdpdGggd2luZG93IGFyZ3VtZW50IChzYW5kYm94KQoJZG9jdW1lbnQgPSB3aW5kb3cuZG9jdW1lbnQsCgoJLy8gQSBjZW50cmFsIHJlZmVyZW5jZSB0byB0aGUgcm9vdCBqUXVlcnkoZG9jdW1lbnQpCglyb290alF1ZXJ5LAoKCS8vIEEgc2ltcGxlIHdheSB0byBjaGVjayBmb3IgSFRNTCBzdHJpbmdzIG9yIElEIHN0cmluZ3MKCS8vIChib3RoIG9mIHdoaWNoIHdlIG9wdGltaXplIGZvcikKCXF1aWNrRXhwciA9IC9eW148XSooPFtcd1xXXSs+KVtePl0qJHxeIyhbXHctXSspJC8sCgoJLy8gSXMgaXQgYSBzaW1wbGUgc2VsZWN0b3IKCWlzU2ltcGxlID0gL14uW146I1xbXC4sXSokLywKCgkvLyBDaGVjayBpZiBhIHN0cmluZyBoYXMgYSBub24td2hpdGVzcGFjZSBjaGFyYWN0ZXIgaW4gaXQKCXJub3R3aGl0ZSA9IC9cUy8sCgoJLy8gVXNlZCBmb3IgdHJpbW1pbmcgd2hpdGVzcGFjZQoJcnRyaW0gPSAvXihcc3xcdTAwQTApK3woXHN8XHUwMEEwKSskL2csCgoJLy8gTWF0Y2ggYSBzdGFuZGFsb25lIHRhZwoJcnNpbmdsZVRhZyA9IC9ePChcdyspXHMqXC8/Pig/OjxcL1wxPik/JC8sCgoJLy8gS2VlcCBhIFVzZXJBZ2VudCBzdHJpbmcgZm9yIHVzZSB3aXRoIGpRdWVyeS5icm93c2VyCgl1c2VyQWdlbnQgPSBuYXZpZ2F0b3IudXNlckFnZW50LAoKCS8vIEZvciBtYXRjaGluZyB0aGUgZW5naW5lIGFuZCB2ZXJzaW9uIG9mIHRoZSBicm93c2VyCglicm93c2VyTWF0Y2gsCgkKCS8vIEhhcyB0aGUgcmVhZHkgZXZlbnRzIGFscmVhZHkgYmVlbiBib3VuZD8KCXJlYWR5Qm91bmQgPSBmYWxzZSwKCQoJLy8gVGhlIGZ1bmN0aW9ucyB0byBleGVjdXRlIG9uIERPTSByZWFkeQoJcmVhZHlMaXN0ID0gW10sCgoJLy8gVGhlIHJlYWR5IGV2ZW50IGhhbmRsZXIKCURPTUNvbnRlbnRMb2FkZWQsCgoJLy8gU2F2ZSBhIHJlZmVyZW5jZSB0byBzb21lIGNvcmUgbWV0aG9kcwoJdG9TdHJpbmcgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLAoJaGFzT3duUHJvcGVydHkgPSBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LAoJcHVzaCA9IEFycmF5LnByb3RvdHlwZS5wdXNoLAoJc2xpY2UgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UsCglpbmRleE9mID0gQXJyYXkucHJvdG90eXBlLmluZGV4T2Y7CgpqUXVlcnkuZm4gPSBqUXVlcnkucHJvdG90eXBlID0gewoJaW5pdDogZnVuY3Rpb24oIHNlbGVjdG9yLCBjb250ZXh0ICkgewoJCXZhciBtYXRjaCwgZWxlbSwgcmV0LCBkb2M7CgoJCS8vIEhhbmRsZSAkKCIiKSwgJChudWxsKSwgb3IgJCh1bmRlZmluZWQpCgkJaWYgKCAhc2VsZWN0b3IgKSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJLy8gSGFuZGxlICQoRE9NRWxlbWVudCkKCQlpZiAoIHNlbGVjdG9yLm5vZGVUeXBlICkgewoJCQl0aGlzLmNvbnRleHQgPSB0aGlzWzBdID0gc2VsZWN0b3I7CgkJCXRoaXMubGVuZ3RoID0gMTsKCQkJcmV0dXJuIHRoaXM7CgkJfQoJCQoJCS8vIFRoZSBib2R5IGVsZW1lbnQgb25seSBleGlzdHMgb25jZSwgb3B0aW1pemUgZmluZGluZyBpdAoJCWlmICggc2VsZWN0b3IgPT09ICJib2R5IiAmJiAhY29udGV4dCApIHsKCQkJdGhpcy5jb250ZXh0ID0gZG9jdW1lbnQ7CgkJCXRoaXNbMF0gPSBkb2N1bWVudC5ib2R5OwoJCQl0aGlzLnNlbGVjdG9yID0gImJvZHkiOwoJCQl0aGlzLmxlbmd0aCA9IDE7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJLy8gSGFuZGxlIEhUTUwgc3RyaW5ncwoJCWlmICggdHlwZW9mIHNlbGVjdG9yID09PSAic3RyaW5nIiApIHsKCQkJLy8gQXJlIHdlIGRlYWxpbmcgd2l0aCBIVE1MIHN0cmluZyBvciBhbiBJRD8KCQkJbWF0Y2ggPSBxdWlja0V4cHIuZXhlYyggc2VsZWN0b3IgKTsKCgkJCS8vIFZlcmlmeSBhIG1hdGNoLCBhbmQgdGhhdCBubyBjb250ZXh0IHdhcyBzcGVjaWZpZWQgZm9yICNpZAoJCQlpZiAoIG1hdGNoICYmIChtYXRjaFsxXSB8fCAhY29udGV4dCkgKSB7CgoJCQkJLy8gSEFORExFOiAkKGh0bWwpIC0+ICQoYXJyYXkpCgkJCQlpZiAoIG1hdGNoWzFdICkgewoJCQkJCWRvYyA9IChjb250ZXh0ID8gY29udGV4dC5vd25lckRvY3VtZW50IHx8IGNvbnRleHQgOiBkb2N1bWVudCk7CgoJCQkJCS8vIElmIGEgc2luZ2xlIHN0cmluZyBpcyBwYXNzZWQgaW4gYW5kIGl0J3MgYSBzaW5nbGUgdGFnCgkJCQkJLy8ganVzdCBkbyBhIGNyZWF0ZUVsZW1lbnQgYW5kIHNraXAgdGhlIHJlc3QKCQkJCQlyZXQgPSByc2luZ2xlVGFnLmV4ZWMoIHNlbGVjdG9yICk7CgoJCQkJCWlmICggcmV0ICkgewoJCQkJCQlpZiAoIGpRdWVyeS5pc1BsYWluT2JqZWN0KCBjb250ZXh0ICkgKSB7CgkJCQkJCQlzZWxlY3RvciA9IFsgZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggcmV0WzFdICkgXTsKCQkJCQkJCWpRdWVyeS5mbi5hdHRyLmNhbGwoIHNlbGVjdG9yLCBjb250ZXh0LCB0cnVlICk7CgoJCQkJCQl9IGVsc2UgewoJCQkJCQkJc2VsZWN0b3IgPSBbIGRvYy5jcmVhdGVFbGVtZW50KCByZXRbMV0gKSBdOwoJCQkJCQl9CgoJCQkJCX0gZWxzZSB7CgkJCQkJCXJldCA9IGJ1aWxkRnJhZ21lbnQoIFsgbWF0Y2hbMV0gXSwgWyBkb2MgXSApOwoJCQkJCQlzZWxlY3RvciA9IChyZXQuY2FjaGVhYmxlID8gcmV0LmZyYWdtZW50LmNsb25lTm9kZSh0cnVlKSA6IHJldC5mcmFnbWVudCkuY2hpbGROb2RlczsKCQkJCQl9CgkJCQkJCgkJCQkJcmV0dXJuIGpRdWVyeS5tZXJnZSggdGhpcywgc2VsZWN0b3IgKTsKCQkJCQkKCQkJCS8vIEhBTkRMRTogJCgiI2lkIikKCQkJCX0gZWxzZSB7CgkJCQkJZWxlbSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCBtYXRjaFsyXSApOwoKCQkJCQlpZiAoIGVsZW0gKSB7CgkJCQkJCS8vIEhhbmRsZSB0aGUgY2FzZSB3aGVyZSBJRSBhbmQgT3BlcmEgcmV0dXJuIGl0ZW1zCgkJCQkJCS8vIGJ5IG5hbWUgaW5zdGVhZCBvZiBJRAoJCQkJCQlpZiAoIGVsZW0uaWQgIT09IG1hdGNoWzJdICkgewoJCQkJCQkJcmV0dXJuIHJvb3RqUXVlcnkuZmluZCggc2VsZWN0b3IgKTsKCQkJCQkJfQoKCQkJCQkJLy8gT3RoZXJ3aXNlLCB3ZSBpbmplY3QgdGhlIGVsZW1lbnQgZGlyZWN0bHkgaW50byB0aGUgalF1ZXJ5IG9iamVjdAoJCQkJCQl0aGlzLmxlbmd0aCA9IDE7CgkJCQkJCXRoaXNbMF0gPSBlbGVtOwoJCQkJCX0KCgkJCQkJdGhpcy5jb250ZXh0ID0gZG9jdW1lbnQ7CgkJCQkJdGhpcy5zZWxlY3RvciA9IHNlbGVjdG9yOwoJCQkJCXJldHVybiB0aGlzOwoJCQkJfQoKCQkJLy8gSEFORExFOiAkKCJUQUciKQoJCQl9IGVsc2UgaWYgKCAhY29udGV4dCAmJiAvXlx3KyQvLnRlc3QoIHNlbGVjdG9yICkgKSB7CgkJCQl0aGlzLnNlbGVjdG9yID0gc2VsZWN0b3I7CgkJCQl0aGlzLmNvbnRleHQgPSBkb2N1bWVudDsKCQkJCXNlbGVjdG9yID0gZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoIHNlbGVjdG9yICk7CgkJCQlyZXR1cm4galF1ZXJ5Lm1lcmdlKCB0aGlzLCBzZWxlY3RvciApOwoKCQkJLy8gSEFORExFOiAkKGV4cHIsICQoLi4uKSkKCQkJfSBlbHNlIGlmICggIWNvbnRleHQgfHwgY29udGV4dC5qcXVlcnkgKSB7CgkJCQlyZXR1cm4gKGNvbnRleHQgfHwgcm9vdGpRdWVyeSkuZmluZCggc2VsZWN0b3IgKTsKCgkJCS8vIEhBTkRMRTogJChleHByLCBjb250ZXh0KQoJCQkvLyAod2hpY2ggaXMganVzdCBlcXVpdmFsZW50IHRvOiAkKGNvbnRleHQpLmZpbmQoZXhwcikKCQkJfSBlbHNlIHsKCQkJCXJldHVybiBqUXVlcnkoIGNvbnRleHQgKS5maW5kKCBzZWxlY3RvciApOwoJCQl9CgoJCS8vIEhBTkRMRTogJChmdW5jdGlvbikKCQkvLyBTaG9ydGN1dCBmb3IgZG9jdW1lbnQgcmVhZHkKCQl9IGVsc2UgaWYgKCBqUXVlcnkuaXNGdW5jdGlvbiggc2VsZWN0b3IgKSApIHsKCQkJcmV0dXJuIHJvb3RqUXVlcnkucmVhZHkoIHNlbGVjdG9yICk7CgkJfQoKCQlpZiAoc2VsZWN0b3Iuc2VsZWN0b3IgIT09IHVuZGVmaW5lZCkgewoJCQl0aGlzLnNlbGVjdG9yID0gc2VsZWN0b3Iuc2VsZWN0b3I7CgkJCXRoaXMuY29udGV4dCA9IHNlbGVjdG9yLmNvbnRleHQ7CgkJfQoKCQlyZXR1cm4galF1ZXJ5Lm1ha2VBcnJheSggc2VsZWN0b3IsIHRoaXMgKTsKCX0sCgoJLy8gU3RhcnQgd2l0aCBhbiBlbXB0eSBzZWxlY3RvcgoJc2VsZWN0b3I6ICIiLAoKCS8vIFRoZSBjdXJyZW50IHZlcnNpb24gb2YgalF1ZXJ5IGJlaW5nIHVzZWQKCWpxdWVyeTogIjEuNC4yIiwKCgkvLyBUaGUgZGVmYXVsdCBsZW5ndGggb2YgYSBqUXVlcnkgb2JqZWN0IGlzIDAKCWxlbmd0aDogMCwKCgkvLyBUaGUgbnVtYmVyIG9mIGVsZW1lbnRzIGNvbnRhaW5lZCBpbiB0aGUgbWF0Y2hlZCBlbGVtZW50IHNldAoJc2l6ZTogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMubGVuZ3RoOwoJfSwKCgl0b0FycmF5OiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gc2xpY2UuY2FsbCggdGhpcywgMCApOwoJfSwKCgkvLyBHZXQgdGhlIE50aCBlbGVtZW50IGluIHRoZSBtYXRjaGVkIGVsZW1lbnQgc2V0IE9SCgkvLyBHZXQgdGhlIHdob2xlIG1hdGNoZWQgZWxlbWVudCBzZXQgYXMgYSBjbGVhbiBhcnJheQoJZ2V0OiBmdW5jdGlvbiggbnVtICkgewoJCXJldHVybiBudW0gPT0gbnVsbCA/CgoJCQkvLyBSZXR1cm4gYSAnY2xlYW4nIGFycmF5CgkJCXRoaXMudG9BcnJheSgpIDoKCgkJCS8vIFJldHVybiBqdXN0IHRoZSBvYmplY3QKCQkJKCBudW0gPCAwID8gdGhpcy5zbGljZShudW0pWyAwIF0gOiB0aGlzWyBudW0gXSApOwoJfSwKCgkvLyBUYWtlIGFuIGFycmF5IG9mIGVsZW1lbnRzIGFuZCBwdXNoIGl0IG9udG8gdGhlIHN0YWNrCgkvLyAocmV0dXJuaW5nIHRoZSBuZXcgbWF0Y2hlZCBlbGVtZW50IHNldCkKCXB1c2hTdGFjazogZnVuY3Rpb24oIGVsZW1zLCBuYW1lLCBzZWxlY3RvciApIHsKCQkvLyBCdWlsZCBhIG5ldyBqUXVlcnkgbWF0Y2hlZCBlbGVtZW50IHNldAoJCXZhciByZXQgPSBqUXVlcnkoKTsKCgkJaWYgKCBqUXVlcnkuaXNBcnJheSggZWxlbXMgKSApIHsKCQkJcHVzaC5hcHBseSggcmV0LCBlbGVtcyApOwoJCQoJCX0gZWxzZSB7CgkJCWpRdWVyeS5tZXJnZSggcmV0LCBlbGVtcyApOwoJCX0KCgkJLy8gQWRkIHRoZSBvbGQgb2JqZWN0IG9udG8gdGhlIHN0YWNrIChhcyBhIHJlZmVyZW5jZSkKCQlyZXQucHJldk9iamVjdCA9IHRoaXM7CgoJCXJldC5jb250ZXh0ID0gdGhpcy5jb250ZXh0OwoKCQlpZiAoIG5hbWUgPT09ICJmaW5kIiApIHsKCQkJcmV0LnNlbGVjdG9yID0gdGhpcy5zZWxlY3RvciArICh0aGlzLnNlbGVjdG9yID8gIiAiIDogIiIpICsgc2VsZWN0b3I7CgkJfSBlbHNlIGlmICggbmFtZSApIHsKCQkJcmV0LnNlbGVjdG9yID0gdGhpcy5zZWxlY3RvciArICIuIiArIG5hbWUgKyAiKCIgKyBzZWxlY3RvciArICIpIjsKCQl9CgoJCS8vIFJldHVybiB0aGUgbmV3bHktZm9ybWVkIGVsZW1lbnQgc2V0CgkJcmV0dXJuIHJldDsKCX0sCgoJLy8gRXhlY3V0ZSBhIGNhbGxiYWNrIGZvciBldmVyeSBlbGVtZW50IGluIHRoZSBtYXRjaGVkIHNldC4KCS8vIChZb3UgY2FuIHNlZWQgdGhlIGFyZ3VtZW50cyB3aXRoIGFuIGFycmF5IG9mIGFyZ3MsIGJ1dCB0aGlzIGlzCgkvLyBvbmx5IHVzZWQgaW50ZXJuYWxseS4pCgllYWNoOiBmdW5jdGlvbiggY2FsbGJhY2ssIGFyZ3MgKSB7CgkJcmV0dXJuIGpRdWVyeS5lYWNoKCB0aGlzLCBjYWxsYmFjaywgYXJncyApOwoJfSwKCQoJcmVhZHk6IGZ1bmN0aW9uKCBmbiApIHsKCQkvLyBBdHRhY2ggdGhlIGxpc3RlbmVycwoJCWpRdWVyeS5iaW5kUmVhZHkoKTsKCgkJLy8gSWYgdGhlIERPTSBpcyBhbHJlYWR5IHJlYWR5CgkJaWYgKCBqUXVlcnkuaXNSZWFkeSApIHsKCQkJLy8gRXhlY3V0ZSB0aGUgZnVuY3Rpb24gaW1tZWRpYXRlbHkKCQkJZm4uY2FsbCggZG9jdW1lbnQsIGpRdWVyeSApOwoKCQkvLyBPdGhlcndpc2UsIHJlbWVtYmVyIHRoZSBmdW5jdGlvbiBmb3IgbGF0ZXIKCQl9IGVsc2UgaWYgKCByZWFkeUxpc3QgKSB7CgkJCS8vIEFkZCB0aGUgZnVuY3Rpb24gdG8gdGhlIHdhaXQgbGlzdAoJCQlyZWFkeUxpc3QucHVzaCggZm4gKTsKCQl9CgoJCXJldHVybiB0aGlzOwoJfSwKCQoJZXE6IGZ1bmN0aW9uKCBpICkgewoJCXJldHVybiBpID09PSAtMSA/CgkJCXRoaXMuc2xpY2UoIGkgKSA6CgkJCXRoaXMuc2xpY2UoIGksICtpICsgMSApOwoJfSwKCglmaXJzdDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuZXEoIDAgKTsKCX0sCgoJbGFzdDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuZXEoIC0xICk7Cgl9LAoKCXNsaWNlOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5wdXNoU3RhY2soIHNsaWNlLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKSwKCQkJInNsaWNlIiwgc2xpY2UuY2FsbChhcmd1bWVudHMpLmpvaW4oIiwiKSApOwoJfSwKCgltYXA6IGZ1bmN0aW9uKCBjYWxsYmFjayApIHsKCQlyZXR1cm4gdGhpcy5wdXNoU3RhY2soIGpRdWVyeS5tYXAodGhpcywgZnVuY3Rpb24oIGVsZW0sIGkgKSB7CgkJCXJldHVybiBjYWxsYmFjay5jYWxsKCBlbGVtLCBpLCBlbGVtICk7CgkJfSkpOwoJfSwKCQoJZW5kOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5wcmV2T2JqZWN0IHx8IGpRdWVyeShudWxsKTsKCX0sCgoJLy8gRm9yIGludGVybmFsIHVzZSBvbmx5LgoJLy8gQmVoYXZlcyBsaWtlIGFuIEFycmF5J3MgbWV0aG9kLCBub3QgbGlrZSBhIGpRdWVyeSBtZXRob2QuCglwdXNoOiBwdXNoLAoJc29ydDogW10uc29ydCwKCXNwbGljZTogW10uc3BsaWNlCn07CgovLyBHaXZlIHRoZSBpbml0IGZ1bmN0aW9uIHRoZSBqUXVlcnkgcHJvdG90eXBlIGZvciBsYXRlciBpbnN0YW50aWF0aW9uCmpRdWVyeS5mbi5pbml0LnByb3RvdHlwZSA9IGpRdWVyeS5mbjsKCmpRdWVyeS5leHRlbmQgPSBqUXVlcnkuZm4uZXh0ZW5kID0gZnVuY3Rpb24oKSB7CgkvLyBjb3B5IHJlZmVyZW5jZSB0byB0YXJnZXQgb2JqZWN0Cgl2YXIgdGFyZ2V0ID0gYXJndW1lbnRzWzBdIHx8IHt9LCBpID0gMSwgbGVuZ3RoID0gYXJndW1lbnRzLmxlbmd0aCwgZGVlcCA9IGZhbHNlLCBvcHRpb25zLCBuYW1lLCBzcmMsIGNvcHk7CgoJLy8gSGFuZGxlIGEgZGVlcCBjb3B5IHNpdHVhdGlvbgoJaWYgKCB0eXBlb2YgdGFyZ2V0ID09PSAiYm9vbGVhbiIgKSB7CgkJZGVlcCA9IHRhcmdldDsKCQl0YXJnZXQgPSBhcmd1bWVudHNbMV0gfHwge307CgkJLy8gc2tpcCB0aGUgYm9vbGVhbiBhbmQgdGhlIHRhcmdldAoJCWkgPSAyOwoJfQoKCS8vIEhhbmRsZSBjYXNlIHdoZW4gdGFyZ2V0IGlzIGEgc3RyaW5nIG9yIHNvbWV0aGluZyAocG9zc2libGUgaW4gZGVlcCBjb3B5KQoJaWYgKCB0eXBlb2YgdGFyZ2V0ICE9PSAib2JqZWN0IiAmJiAhalF1ZXJ5LmlzRnVuY3Rpb24odGFyZ2V0KSApIHsKCQl0YXJnZXQgPSB7fTsKCX0KCgkvLyBleHRlbmQgalF1ZXJ5IGl0c2VsZiBpZiBvbmx5IG9uZSBhcmd1bWVudCBpcyBwYXNzZWQKCWlmICggbGVuZ3RoID09PSBpICkgewoJCXRhcmdldCA9IHRoaXM7CgkJLS1pOwoJfQoKCWZvciAoIDsgaSA8IGxlbmd0aDsgaSsrICkgewoJCS8vIE9ubHkgZGVhbCB3aXRoIG5vbi1udWxsL3VuZGVmaW5lZCB2YWx1ZXMKCQlpZiAoIChvcHRpb25zID0gYXJndW1lbnRzWyBpIF0pICE9IG51bGwgKSB7CgkJCS8vIEV4dGVuZCB0aGUgYmFzZSBvYmplY3QKCQkJZm9yICggbmFtZSBpbiBvcHRpb25zICkgewoJCQkJc3JjID0gdGFyZ2V0WyBuYW1lIF07CgkJCQljb3B5ID0gb3B0aW9uc1sgbmFtZSBdOwoKCQkJCS8vIFByZXZlbnQgbmV2ZXItZW5kaW5nIGxvb3AKCQkJCWlmICggdGFyZ2V0ID09PSBjb3B5ICkgewoJCQkJCWNvbnRpbnVlOwoJCQkJfQoKCQkJCS8vIFJlY3Vyc2UgaWYgd2UncmUgbWVyZ2luZyBvYmplY3QgbGl0ZXJhbCB2YWx1ZXMgb3IgYXJyYXlzCgkJCQlpZiAoIGRlZXAgJiYgY29weSAmJiAoIGpRdWVyeS5pc1BsYWluT2JqZWN0KGNvcHkpIHx8IGpRdWVyeS5pc0FycmF5KGNvcHkpICkgKSB7CgkJCQkJdmFyIGNsb25lID0gc3JjICYmICggalF1ZXJ5LmlzUGxhaW5PYmplY3Qoc3JjKSB8fCBqUXVlcnkuaXNBcnJheShzcmMpICkgPyBzcmMKCQkJCQkJOiBqUXVlcnkuaXNBcnJheShjb3B5KSA/IFtdIDoge307CgoJCQkJCS8vIE5ldmVyIG1vdmUgb3JpZ2luYWwgb2JqZWN0cywgY2xvbmUgdGhlbQoJCQkJCXRhcmdldFsgbmFtZSBdID0galF1ZXJ5LmV4dGVuZCggZGVlcCwgY2xvbmUsIGNvcHkgKTsKCgkJCQkvLyBEb24ndCBicmluZyBpbiB1bmRlZmluZWQgdmFsdWVzCgkJCQl9IGVsc2UgaWYgKCBjb3B5ICE9PSB1bmRlZmluZWQgKSB7CgkJCQkJdGFyZ2V0WyBuYW1lIF0gPSBjb3B5OwoJCQkJfQoJCQl9CgkJfQoJfQoKCS8vIFJldHVybiB0aGUgbW9kaWZpZWQgb2JqZWN0CglyZXR1cm4gdGFyZ2V0Owp9OwoKalF1ZXJ5LmV4dGVuZCh7Cglub0NvbmZsaWN0OiBmdW5jdGlvbiggZGVlcCApIHsKCQl3aW5kb3cuJCA9IF8kOwoKCQlpZiAoIGRlZXAgKSB7CgkJCXdpbmRvdy5qUXVlcnkgPSBfalF1ZXJ5OwoJCX0KCgkJcmV0dXJuIGpRdWVyeTsKCX0sCgkKCS8vIElzIHRoZSBET00gcmVhZHkgdG8gYmUgdXNlZD8gU2V0IHRvIHRydWUgb25jZSBpdCBvY2N1cnMuCglpc1JlYWR5OiBmYWxzZSwKCQoJLy8gSGFuZGxlIHdoZW4gdGhlIERPTSBpcyByZWFkeQoJcmVhZHk6IGZ1bmN0aW9uKCkgewoJCS8vIE1ha2Ugc3VyZSB0aGF0IHRoZSBET00gaXMgbm90IGFscmVhZHkgbG9hZGVkCgkJaWYgKCAhalF1ZXJ5LmlzUmVhZHkgKSB7CgkJCS8vIE1ha2Ugc3VyZSBib2R5IGV4aXN0cywgYXQgbGVhc3QsIGluIGNhc2UgSUUgZ2V0cyBhIGxpdHRsZSBvdmVyemVhbG91cyAodGlja2V0ICM1NDQzKS4KCQkJaWYgKCAhZG9jdW1lbnQuYm9keSApIHsKCQkJCXJldHVybiBzZXRUaW1lb3V0KCBqUXVlcnkucmVhZHksIDEzICk7CgkJCX0KCgkJCS8vIFJlbWVtYmVyIHRoYXQgdGhlIERPTSBpcyByZWFkeQoJCQlqUXVlcnkuaXNSZWFkeSA9IHRydWU7CgoJCQkvLyBJZiB0aGVyZSBhcmUgZnVuY3Rpb25zIGJvdW5kLCB0byBleGVjdXRlCgkJCWlmICggcmVhZHlMaXN0ICkgewoJCQkJLy8gRXhlY3V0ZSBhbGwgb2YgdGhlbQoJCQkJdmFyIGZuLCBpID0gMDsKCQkJCXdoaWxlICggKGZuID0gcmVhZHlMaXN0WyBpKysgXSkgKSB7CgkJCQkJZm4uY2FsbCggZG9jdW1lbnQsIGpRdWVyeSApOwoJCQkJfQoKCQkJCS8vIFJlc2V0IHRoZSBsaXN0IG9mIGZ1bmN0aW9ucwoJCQkJcmVhZHlMaXN0ID0gbnVsbDsKCQkJfQoKCQkJLy8gVHJpZ2dlciBhbnkgYm91bmQgcmVhZHkgZXZlbnRzCgkJCWlmICggalF1ZXJ5LmZuLnRyaWdnZXJIYW5kbGVyICkgewoJCQkJalF1ZXJ5KCBkb2N1bWVudCApLnRyaWdnZXJIYW5kbGVyKCAicmVhZHkiICk7CgkJCX0KCQl9Cgl9LAoJCgliaW5kUmVhZHk6IGZ1bmN0aW9uKCkgewoJCWlmICggcmVhZHlCb3VuZCApIHsKCQkJcmV0dXJuOwoJCX0KCgkJcmVhZHlCb3VuZCA9IHRydWU7CgoJCS8vIENhdGNoIGNhc2VzIHdoZXJlICQoZG9jdW1lbnQpLnJlYWR5KCkgaXMgY2FsbGVkIGFmdGVyIHRoZQoJCS8vIGJyb3dzZXIgZXZlbnQgaGFzIGFscmVhZHkgb2NjdXJyZWQuCgkJaWYgKCBkb2N1bWVudC5yZWFkeVN0YXRlID09PSAiY29tcGxldGUiICkgewoJCQlyZXR1cm4galF1ZXJ5LnJlYWR5KCk7CgkJfQoKCQkvLyBNb3ppbGxhLCBPcGVyYSBhbmQgd2Via2l0IG5pZ2h0bGllcyBjdXJyZW50bHkgc3VwcG9ydCB0aGlzIGV2ZW50CgkJaWYgKCBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyICkgewoJCQkvLyBVc2UgdGhlIGhhbmR5IGV2ZW50IGNhbGxiYWNrCgkJCWRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoICJET01Db250ZW50TG9hZGVkIiwgRE9NQ29udGVudExvYWRlZCwgZmFsc2UgKTsKCQkJCgkJCS8vIEEgZmFsbGJhY2sgdG8gd2luZG93Lm9ubG9hZCwgdGhhdCB3aWxsIGFsd2F5cyB3b3JrCgkJCXdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCAibG9hZCIsIGpRdWVyeS5yZWFkeSwgZmFsc2UgKTsKCgkJLy8gSWYgSUUgZXZlbnQgbW9kZWwgaXMgdXNlZAoJCX0gZWxzZSBpZiAoIGRvY3VtZW50LmF0dGFjaEV2ZW50ICkgewoJCQkvLyBlbnN1cmUgZmlyaW5nIGJlZm9yZSBvbmxvYWQsCgkJCS8vIG1heWJlIGxhdGUgYnV0IHNhZmUgYWxzbyBmb3IgaWZyYW1lcwoJCQlkb2N1bWVudC5hdHRhY2hFdmVudCgib25yZWFkeXN0YXRlY2hhbmdlIiwgRE9NQ29udGVudExvYWRlZCk7CgkJCQoJCQkvLyBBIGZhbGxiYWNrIHRvIHdpbmRvdy5vbmxvYWQsIHRoYXQgd2lsbCBhbHdheXMgd29yawoJCQl3aW5kb3cuYXR0YWNoRXZlbnQoICJvbmxvYWQiLCBqUXVlcnkucmVhZHkgKTsKCgkJCS8vIElmIElFIGFuZCBub3QgYSBmcmFtZQoJCQkvLyBjb250aW51YWxseSBjaGVjayB0byBzZWUgaWYgdGhlIGRvY3VtZW50IGlzIHJlYWR5CgkJCXZhciB0b3BsZXZlbCA9IGZhbHNlOwoKCQkJdHJ5IHsKCQkJCXRvcGxldmVsID0gd2luZG93LmZyYW1lRWxlbWVudCA9PSBudWxsOwoJCQl9IGNhdGNoKGUpIHt9CgoJCQlpZiAoIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5kb1Njcm9sbCAmJiB0b3BsZXZlbCApIHsKCQkJCWRvU2Nyb2xsQ2hlY2soKTsKCQkJfQoJCX0KCX0sCgoJLy8gU2VlIHRlc3QvdW5pdC9jb3JlLmpzIGZvciBkZXRhaWxzIGNvbmNlcm5pbmcgaXNGdW5jdGlvbi4KCS8vIFNpbmNlIHZlcnNpb24gMS4zLCBET00gbWV0aG9kcyBhbmQgZnVuY3Rpb25zIGxpa2UgYWxlcnQKCS8vIGFyZW4ndCBzdXBwb3J0ZWQuIFRoZXkgcmV0dXJuIGZhbHNlIG9uIElFICgjMjk2OCkuCglpc0Z1bmN0aW9uOiBmdW5jdGlvbiggb2JqICkgewoJCXJldHVybiB0b1N0cmluZy5jYWxsKG9iaikgPT09ICJbb2JqZWN0IEZ1bmN0aW9uXSI7Cgl9LAoKCWlzQXJyYXk6IGZ1bmN0aW9uKCBvYmogKSB7CgkJcmV0dXJuIHRvU3RyaW5nLmNhbGwob2JqKSA9PT0gIltvYmplY3QgQXJyYXldIjsKCX0sCgoJaXNQbGFpbk9iamVjdDogZnVuY3Rpb24oIG9iaiApIHsKCQkvLyBNdXN0IGJlIGFuIE9iamVjdC4KCQkvLyBCZWNhdXNlIG9mIElFLCB3ZSBhbHNvIGhhdmUgdG8gY2hlY2sgdGhlIHByZXNlbmNlIG9mIHRoZSBjb25zdHJ1Y3RvciBwcm9wZXJ0eS4KCQkvLyBNYWtlIHN1cmUgdGhhdCBET00gbm9kZXMgYW5kIHdpbmRvdyBvYmplY3RzIGRvbid0IHBhc3MgdGhyb3VnaCwgYXMgd2VsbAoJCWlmICggIW9iaiB8fCB0b1N0cmluZy5jYWxsKG9iaikgIT09ICJbb2JqZWN0IE9iamVjdF0iIHx8IG9iai5ub2RlVHlwZSB8fCBvYmouc2V0SW50ZXJ2YWwgKSB7CgkJCXJldHVybiBmYWxzZTsKCQl9CgkJCgkJLy8gTm90IG93biBjb25zdHJ1Y3RvciBwcm9wZXJ0eSBtdXN0IGJlIE9iamVjdAoJCWlmICggb2JqLmNvbnN0cnVjdG9yCgkJCSYmICFoYXNPd25Qcm9wZXJ0eS5jYWxsKG9iaiwgImNvbnN0cnVjdG9yIikKCQkJJiYgIWhhc093blByb3BlcnR5LmNhbGwob2JqLmNvbnN0cnVjdG9yLnByb3RvdHlwZSwgImlzUHJvdG90eXBlT2YiKSApIHsKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCQkKCQkvLyBPd24gcHJvcGVydGllcyBhcmUgZW51bWVyYXRlZCBmaXJzdGx5LCBzbyB0byBzcGVlZCB1cCwKCQkvLyBpZiBsYXN0IG9uZSBpcyBvd24sIHRoZW4gYWxsIHByb3BlcnRpZXMgYXJlIG93bi4KCQoJCXZhciBrZXk7CgkJZm9yICgga2V5IGluIG9iaiApIHt9CgkJCgkJcmV0dXJuIGtleSA9PT0gdW5kZWZpbmVkIHx8IGhhc093blByb3BlcnR5LmNhbGwoIG9iaiwga2V5ICk7Cgl9LAoKCWlzRW1wdHlPYmplY3Q6IGZ1bmN0aW9uKCBvYmogKSB7CgkJZm9yICggdmFyIG5hbWUgaW4gb2JqICkgewoJCQlyZXR1cm4gZmFsc2U7CgkJfQoJCXJldHVybiB0cnVlOwoJfSwKCQoJZXJyb3I6IGZ1bmN0aW9uKCBtc2cgKSB7CgkJdGhyb3cgbXNnOwoJfSwKCQoJcGFyc2VKU09OOiBmdW5jdGlvbiggZGF0YSApIHsKCQlpZiAoIHR5cGVvZiBkYXRhICE9PSAic3RyaW5nIiB8fCAhZGF0YSApIHsKCQkJcmV0dXJuIG51bGw7CgkJfQoKCQkvLyBNYWtlIHN1cmUgbGVhZGluZy90cmFpbGluZyB3aGl0ZXNwYWNlIGlzIHJlbW92ZWQgKElFIGNhbid0IGhhbmRsZSBpdCkKCQlkYXRhID0galF1ZXJ5LnRyaW0oIGRhdGEgKTsKCQkKCQkvLyBNYWtlIHN1cmUgdGhlIGluY29taW5nIGRhdGEgaXMgYWN0dWFsIEpTT04KCQkvLyBMb2dpYyBib3Jyb3dlZCBmcm9tIGh0dHA6Ly9qc29uLm9yZy9qc29uMi5qcwoJCWlmICggL15bXF0sOnt9XHNdKiQvLnRlc3QoZGF0YS5yZXBsYWNlKC9cXCg/OlsiXFxcL2JmbnJ0XXx1WzAtOWEtZkEtRl17NH0pL2csICJAIikKCQkJLnJlcGxhY2UoLyJbXiJcXFxuXHJdKiJ8dHJ1ZXxmYWxzZXxudWxsfC0/XGQrKD86XC5cZCopPyg/OltlRV1bK1wtXT9cZCspPy9nLCAiXSIpCgkJCS5yZXBsYWNlKC8oPzpefDp8LCkoPzpccypcWykrL2csICIiKSkgKSB7CgoJCQkvLyBUcnkgdG8gdXNlIHRoZSBuYXRpdmUgSlNPTiBwYXJzZXIgZmlyc3QKCQkJcmV0dXJuIHdpbmRvdy5KU09OICYmIHdpbmRvdy5KU09OLnBhcnNlID8KCQkJCXdpbmRvdy5KU09OLnBhcnNlKCBkYXRhICkgOgoJCQkJKG5ldyBGdW5jdGlvbigicmV0dXJuICIgKyBkYXRhKSkoKTsKCgkJfSBlbHNlIHsKCQkJalF1ZXJ5LmVycm9yKCAiSW52YWxpZCBKU09OOiAiICsgZGF0YSApOwoJCX0KCX0sCgoJbm9vcDogZnVuY3Rpb24oKSB7fSwKCgkvLyBFdmFsdWxhdGVzIGEgc2NyaXB0IGluIGEgZ2xvYmFsIGNvbnRleHQKCWdsb2JhbEV2YWw6IGZ1bmN0aW9uKCBkYXRhICkgewoJCWlmICggZGF0YSAmJiBybm90d2hpdGUudGVzdChkYXRhKSApIHsKCQkJLy8gSW5zcGlyZWQgYnkgY29kZSBieSBBbmRyZWEgR2lhbW1hcmNoaQoJCQkvLyBodHRwOi8vd2VicmVmbGVjdGlvbi5ibG9nc3BvdC5jb20vMjAwNy8wOC9nbG9iYWwtc2NvcGUtZXZhbHVhdGlvbi1hbmQtZG9tLmh0bWwKCQkJdmFyIGhlYWQgPSBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgiaGVhZCIpWzBdIHx8IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudCwKCQkJCXNjcmlwdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInNjcmlwdCIpOwoKCQkJc2NyaXB0LnR5cGUgPSAidGV4dC9qYXZhc2NyaXB0IjsKCgkJCWlmICggalF1ZXJ5LnN1cHBvcnQuc2NyaXB0RXZhbCApIHsKCQkJCXNjcmlwdC5hcHBlbmRDaGlsZCggZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoIGRhdGEgKSApOwoJCQl9IGVsc2UgewoJCQkJc2NyaXB0LnRleHQgPSBkYXRhOwoJCQl9CgoJCQkvLyBVc2UgaW5zZXJ0QmVmb3JlIGluc3RlYWQgb2YgYXBwZW5kQ2hpbGQgdG8gY2lyY3VtdmVudCBhbiBJRTYgYnVnLgoJCQkvLyBUaGlzIGFyaXNlcyB3aGVuIGEgYmFzZSBub2RlIGlzIHVzZWQgKCMyNzA5KS4KCQkJaGVhZC5pbnNlcnRCZWZvcmUoIHNjcmlwdCwgaGVhZC5maXJzdENoaWxkICk7CgkJCWhlYWQucmVtb3ZlQ2hpbGQoIHNjcmlwdCApOwoJCX0KCX0sCgoJbm9kZU5hbWU6IGZ1bmN0aW9uKCBlbGVtLCBuYW1lICkgewoJCXJldHVybiBlbGVtLm5vZGVOYW1lICYmIGVsZW0ubm9kZU5hbWUudG9VcHBlckNhc2UoKSA9PT0gbmFtZS50b1VwcGVyQ2FzZSgpOwoJfSwKCgkvLyBhcmdzIGlzIGZvciBpbnRlcm5hbCB1c2FnZSBvbmx5CgllYWNoOiBmdW5jdGlvbiggb2JqZWN0LCBjYWxsYmFjaywgYXJncyApIHsKCQl2YXIgbmFtZSwgaSA9IDAsCgkJCWxlbmd0aCA9IG9iamVjdC5sZW5ndGgsCgkJCWlzT2JqID0gbGVuZ3RoID09PSB1bmRlZmluZWQgfHwgalF1ZXJ5LmlzRnVuY3Rpb24ob2JqZWN0KTsKCgkJaWYgKCBhcmdzICkgewoJCQlpZiAoIGlzT2JqICkgewoJCQkJZm9yICggbmFtZSBpbiBvYmplY3QgKSB7CgkJCQkJaWYgKCBjYWxsYmFjay5hcHBseSggb2JqZWN0WyBuYW1lIF0sIGFyZ3MgKSA9PT0gZmFsc2UgKSB7CgkJCQkJCWJyZWFrOwoJCQkJCX0KCQkJCX0KCQkJfSBlbHNlIHsKCQkJCWZvciAoIDsgaSA8IGxlbmd0aDsgKSB7CgkJCQkJaWYgKCBjYWxsYmFjay5hcHBseSggb2JqZWN0WyBpKysgXSwgYXJncyApID09PSBmYWxzZSApIHsKCQkJCQkJYnJlYWs7CgkJCQkJfQoJCQkJfQoJCQl9CgoJCS8vIEEgc3BlY2lhbCwgZmFzdCwgY2FzZSBmb3IgdGhlIG1vc3QgY29tbW9uIHVzZSBvZiBlYWNoCgkJfSBlbHNlIHsKCQkJaWYgKCBpc09iaiApIHsKCQkJCWZvciAoIG5hbWUgaW4gb2JqZWN0ICkgewoJCQkJCWlmICggY2FsbGJhY2suY2FsbCggb2JqZWN0WyBuYW1lIF0sIG5hbWUsIG9iamVjdFsgbmFtZSBdICkgPT09IGZhbHNlICkgewoJCQkJCQlicmVhazsKCQkJCQl9CgkJCQl9CgkJCX0gZWxzZSB7CgkJCQlmb3IgKCB2YXIgdmFsdWUgPSBvYmplY3RbMF07CgkJCQkJaSA8IGxlbmd0aCAmJiBjYWxsYmFjay5jYWxsKCB2YWx1ZSwgaSwgdmFsdWUgKSAhPT0gZmFsc2U7IHZhbHVlID0gb2JqZWN0WysraV0gKSB7fQoJCQl9CgkJfQoKCQlyZXR1cm4gb2JqZWN0OwoJfSwKCgl0cmltOiBmdW5jdGlvbiggdGV4dCApIHsKCQlyZXR1cm4gKHRleHQgfHwgIiIpLnJlcGxhY2UoIHJ0cmltLCAiIiApOwoJfSwKCgkvLyByZXN1bHRzIGlzIGZvciBpbnRlcm5hbCB1c2FnZSBvbmx5CgltYWtlQXJyYXk6IGZ1bmN0aW9uKCBhcnJheSwgcmVzdWx0cyApIHsKCQl2YXIgcmV0ID0gcmVzdWx0cyB8fCBbXTsKCgkJaWYgKCBhcnJheSAhPSBudWxsICkgewoJCQkvLyBUaGUgd2luZG93LCBzdHJpbmdzIChhbmQgZnVuY3Rpb25zKSBhbHNvIGhhdmUgJ2xlbmd0aCcKCQkJLy8gVGhlIGV4dHJhIHR5cGVvZiBmdW5jdGlvbiBjaGVjayBpcyB0byBwcmV2ZW50IGNyYXNoZXMKCQkJLy8gaW4gU2FmYXJpIDIgKFNlZTogIzMwMzkpCgkJCWlmICggYXJyYXkubGVuZ3RoID09IG51bGwgfHwgdHlwZW9mIGFycmF5ID09PSAic3RyaW5nIiB8fCBqUXVlcnkuaXNGdW5jdGlvbihhcnJheSkgfHwgKHR5cGVvZiBhcnJheSAhPT0gImZ1bmN0aW9uIiAmJiBhcnJheS5zZXRJbnRlcnZhbCkgKSB7CgkJCQlwdXNoLmNhbGwoIHJldCwgYXJyYXkgKTsKCQkJfSBlbHNlIHsKCQkJCWpRdWVyeS5tZXJnZSggcmV0LCBhcnJheSApOwoJCQl9CgkJfQoKCQlyZXR1cm4gcmV0OwoJfSwKCglpbkFycmF5OiBmdW5jdGlvbiggZWxlbSwgYXJyYXkgKSB7CgkJaWYgKCBhcnJheS5pbmRleE9mICkgewoJCQlyZXR1cm4gYXJyYXkuaW5kZXhPZiggZWxlbSApOwoJCX0KCgkJZm9yICggdmFyIGkgPSAwLCBsZW5ndGggPSBhcnJheS5sZW5ndGg7IGkgPCBsZW5ndGg7IGkrKyApIHsKCQkJaWYgKCBhcnJheVsgaSBdID09PSBlbGVtICkgewoJCQkJcmV0dXJuIGk7CgkJCX0KCQl9CgoJCXJldHVybiAtMTsKCX0sCgoJbWVyZ2U6IGZ1bmN0aW9uKCBmaXJzdCwgc2Vjb25kICkgewoJCXZhciBpID0gZmlyc3QubGVuZ3RoLCBqID0gMDsKCgkJaWYgKCB0eXBlb2Ygc2Vjb25kLmxlbmd0aCA9PT0gIm51bWJlciIgKSB7CgkJCWZvciAoIHZhciBsID0gc2Vjb25kLmxlbmd0aDsgaiA8IGw7IGorKyApIHsKCQkJCWZpcnN0WyBpKysgXSA9IHNlY29uZFsgaiBdOwoJCQl9CgkJCgkJfSBlbHNlIHsKCQkJd2hpbGUgKCBzZWNvbmRbal0gIT09IHVuZGVmaW5lZCApIHsKCQkJCWZpcnN0WyBpKysgXSA9IHNlY29uZFsgaisrIF07CgkJCX0KCQl9CgoJCWZpcnN0Lmxlbmd0aCA9IGk7CgoJCXJldHVybiBmaXJzdDsKCX0sCgoJZ3JlcDogZnVuY3Rpb24oIGVsZW1zLCBjYWxsYmFjaywgaW52ICkgewoJCXZhciByZXQgPSBbXTsKCgkJLy8gR28gdGhyb3VnaCB0aGUgYXJyYXksIG9ubHkgc2F2aW5nIHRoZSBpdGVtcwoJCS8vIHRoYXQgcGFzcyB0aGUgdmFsaWRhdG9yIGZ1bmN0aW9uCgkJZm9yICggdmFyIGkgPSAwLCBsZW5ndGggPSBlbGVtcy5sZW5ndGg7IGkgPCBsZW5ndGg7IGkrKyApIHsKCQkJaWYgKCAhaW52ICE9PSAhY2FsbGJhY2soIGVsZW1zWyBpIF0sIGkgKSApIHsKCQkJCXJldC5wdXNoKCBlbGVtc1sgaSBdICk7CgkJCX0KCQl9CgoJCXJldHVybiByZXQ7Cgl9LAoKCS8vIGFyZyBpcyBmb3IgaW50ZXJuYWwgdXNhZ2Ugb25seQoJbWFwOiBmdW5jdGlvbiggZWxlbXMsIGNhbGxiYWNrLCBhcmcgKSB7CgkJdmFyIHJldCA9IFtdLCB2YWx1ZTsKCgkJLy8gR28gdGhyb3VnaCB0aGUgYXJyYXksIHRyYW5zbGF0aW5nIGVhY2ggb2YgdGhlIGl0ZW1zIHRvIHRoZWlyCgkJLy8gbmV3IHZhbHVlIChvciB2YWx1ZXMpLgoJCWZvciAoIHZhciBpID0gMCwgbGVuZ3RoID0gZWxlbXMubGVuZ3RoOyBpIDwgbGVuZ3RoOyBpKysgKSB7CgkJCXZhbHVlID0gY2FsbGJhY2soIGVsZW1zWyBpIF0sIGksIGFyZyApOwoKCQkJaWYgKCB2YWx1ZSAhPSBudWxsICkgewoJCQkJcmV0WyByZXQubGVuZ3RoIF0gPSB2YWx1ZTsKCQkJfQoJCX0KCgkJcmV0dXJuIHJldC5jb25jYXQuYXBwbHkoIFtdLCByZXQgKTsKCX0sCgoJLy8gQSBnbG9iYWwgR1VJRCBjb3VudGVyIGZvciBvYmplY3RzCglndWlkOiAxLAoKCXByb3h5OiBmdW5jdGlvbiggZm4sIHByb3h5LCB0aGlzT2JqZWN0ICkgewoJCWlmICggYXJndW1lbnRzLmxlbmd0aCA9PT0gMiApIHsKCQkJaWYgKCB0eXBlb2YgcHJveHkgPT09ICJzdHJpbmciICkgewoJCQkJdGhpc09iamVjdCA9IGZuOwoJCQkJZm4gPSB0aGlzT2JqZWN0WyBwcm94eSBdOwoJCQkJcHJveHkgPSB1bmRlZmluZWQ7CgoJCQl9IGVsc2UgaWYgKCBwcm94eSAmJiAhalF1ZXJ5LmlzRnVuY3Rpb24oIHByb3h5ICkgKSB7CgkJCQl0aGlzT2JqZWN0ID0gcHJveHk7CgkJCQlwcm94eSA9IHVuZGVmaW5lZDsKCQkJfQoJCX0KCgkJaWYgKCAhcHJveHkgJiYgZm4gKSB7CgkJCXByb3h5ID0gZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gZm4uYXBwbHkoIHRoaXNPYmplY3QgfHwgdGhpcywgYXJndW1lbnRzICk7CgkJCX07CgkJfQoKCQkvLyBTZXQgdGhlIGd1aWQgb2YgdW5pcXVlIGhhbmRsZXIgdG8gdGhlIHNhbWUgb2Ygb3JpZ2luYWwgaGFuZGxlciwgc28gaXQgY2FuIGJlIHJlbW92ZWQKCQlpZiAoIGZuICkgewoJCQlwcm94eS5ndWlkID0gZm4uZ3VpZCA9IGZuLmd1aWQgfHwgcHJveHkuZ3VpZCB8fCBqUXVlcnkuZ3VpZCsrOwoJCX0KCgkJLy8gU28gcHJveHkgY2FuIGJlIGRlY2xhcmVkIGFzIGFuIGFyZ3VtZW50CgkJcmV0dXJuIHByb3h5OwoJfSwKCgkvLyBVc2Ugb2YgalF1ZXJ5LmJyb3dzZXIgaXMgZnJvd25lZCB1cG9uLgoJLy8gTW9yZSBkZXRhaWxzOiBodHRwOi8vZG9jcy5qcXVlcnkuY29tL1V0aWxpdGllcy9qUXVlcnkuYnJvd3NlcgoJdWFNYXRjaDogZnVuY3Rpb24oIHVhICkgewoJCXVhID0gdWEudG9Mb3dlckNhc2UoKTsKCgkJdmFyIG1hdGNoID0gLyh3ZWJraXQpWyBcL10oW1x3Ll0rKS8uZXhlYyggdWEgKSB8fAoJCQkvKG9wZXJhKSg/Oi4qdmVyc2lvbik/WyBcL10oW1x3Ll0rKS8uZXhlYyggdWEgKSB8fAoJCQkvKG1zaWUpIChbXHcuXSspLy5leGVjKCB1YSApIHx8CgkJCSEvY29tcGF0aWJsZS8udGVzdCggdWEgKSAmJiAvKG1vemlsbGEpKD86Lio/IHJ2OihbXHcuXSspKT8vLmV4ZWMoIHVhICkgfHwKCQkgIAlbXTsKCgkJcmV0dXJuIHsgYnJvd3NlcjogbWF0Y2hbMV0gfHwgIiIsIHZlcnNpb246IG1hdGNoWzJdIHx8ICIwIiB9OwoJfSwKCglicm93c2VyOiB7fQp9KTsKCmJyb3dzZXJNYXRjaCA9IGpRdWVyeS51YU1hdGNoKCB1c2VyQWdlbnQgKTsKaWYgKCBicm93c2VyTWF0Y2guYnJvd3NlciApIHsKCWpRdWVyeS5icm93c2VyWyBicm93c2VyTWF0Y2guYnJvd3NlciBdID0gdHJ1ZTsKCWpRdWVyeS5icm93c2VyLnZlcnNpb24gPSBicm93c2VyTWF0Y2gudmVyc2lvbjsKfQoKLy8gRGVwcmVjYXRlZCwgdXNlIGpRdWVyeS5icm93c2VyLndlYmtpdCBpbnN0ZWFkCmlmICggalF1ZXJ5LmJyb3dzZXIud2Via2l0ICkgewoJalF1ZXJ5LmJyb3dzZXIuc2FmYXJpID0gdHJ1ZTsKfQoKaWYgKCBpbmRleE9mICkgewoJalF1ZXJ5LmluQXJyYXkgPSBmdW5jdGlvbiggZWxlbSwgYXJyYXkgKSB7CgkJcmV0dXJuIGluZGV4T2YuY2FsbCggYXJyYXksIGVsZW0gKTsKCX07Cn0KCi8vIEFsbCBqUXVlcnkgb2JqZWN0cyBzaG91bGQgcG9pbnQgYmFjayB0byB0aGVzZQpyb290alF1ZXJ5ID0galF1ZXJ5KGRvY3VtZW50KTsKCi8vIENsZWFudXAgZnVuY3Rpb25zIGZvciB0aGUgZG9jdW1lbnQgcmVhZHkgbWV0aG9kCmlmICggZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lciApIHsKCURPTUNvbnRlbnRMb2FkZWQgPSBmdW5jdGlvbigpIHsKCQlkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCAiRE9NQ29udGVudExvYWRlZCIsIERPTUNvbnRlbnRMb2FkZWQsIGZhbHNlICk7CgkJalF1ZXJ5LnJlYWR5KCk7Cgl9OwoKfSBlbHNlIGlmICggZG9jdW1lbnQuYXR0YWNoRXZlbnQgKSB7CglET01Db250ZW50TG9hZGVkID0gZnVuY3Rpb24oKSB7CgkJLy8gTWFrZSBzdXJlIGJvZHkgZXhpc3RzLCBhdCBsZWFzdCwgaW4gY2FzZSBJRSBnZXRzIGEgbGl0dGxlIG92ZXJ6ZWFsb3VzICh0aWNrZXQgIzU0NDMpLgoJCWlmICggZG9jdW1lbnQucmVhZHlTdGF0ZSA9PT0gImNvbXBsZXRlIiApIHsKCQkJZG9jdW1lbnQuZGV0YWNoRXZlbnQoICJvbnJlYWR5c3RhdGVjaGFuZ2UiLCBET01Db250ZW50TG9hZGVkICk7CgkJCWpRdWVyeS5yZWFkeSgpOwoJCX0KCX07Cn0KCi8vIFRoZSBET00gcmVhZHkgY2hlY2sgZm9yIEludGVybmV0IEV4cGxvcmVyCmZ1bmN0aW9uIGRvU2Nyb2xsQ2hlY2soKSB7CglpZiAoIGpRdWVyeS5pc1JlYWR5ICkgewoJCXJldHVybjsKCX0KCgl0cnkgewoJCS8vIElmIElFIGlzIHVzZWQsIHVzZSB0aGUgdHJpY2sgYnkgRGllZ28gUGVyaW5pCgkJLy8gaHR0cDovL2phdmFzY3JpcHQubndib3guY29tL0lFQ29udGVudExvYWRlZC8KCQlkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuZG9TY3JvbGwoImxlZnQiKTsKCX0gY2F0Y2goIGVycm9yICkgewoJCXNldFRpbWVvdXQoIGRvU2Nyb2xsQ2hlY2ssIDEgKTsKCQlyZXR1cm47Cgl9CgoJLy8gYW5kIGV4ZWN1dGUgYW55IHdhaXRpbmcgZnVuY3Rpb25zCglqUXVlcnkucmVhZHkoKTsKfQoKZnVuY3Rpb24gZXZhbFNjcmlwdCggaSwgZWxlbSApIHsKCWlmICggZWxlbS5zcmMgKSB7CgkJalF1ZXJ5LmFqYXgoewoJCQl1cmw6IGVsZW0uc3JjLAoJCQlhc3luYzogZmFsc2UsCgkJCWRhdGFUeXBlOiAic2NyaXB0IgoJCX0pOwoJfSBlbHNlIHsKCQlqUXVlcnkuZ2xvYmFsRXZhbCggZWxlbS50ZXh0IHx8IGVsZW0udGV4dENvbnRlbnQgfHwgZWxlbS5pbm5lckhUTUwgfHwgIiIgKTsKCX0KCglpZiAoIGVsZW0ucGFyZW50Tm9kZSApIHsKCQllbGVtLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoIGVsZW0gKTsKCX0KfQoKLy8gTXV0aWZ1bmN0aW9uYWwgbWV0aG9kIHRvIGdldCBhbmQgc2V0IHZhbHVlcyB0byBhIGNvbGxlY3Rpb24KLy8gVGhlIHZhbHVlL3MgY2FuIGJlIG9wdGlvbmFsbHkgYnkgZXhlY3V0ZWQgaWYgaXRzIGEgZnVuY3Rpb24KZnVuY3Rpb24gYWNjZXNzKCBlbGVtcywga2V5LCB2YWx1ZSwgZXhlYywgZm4sIHBhc3MgKSB7Cgl2YXIgbGVuZ3RoID0gZWxlbXMubGVuZ3RoOwoJCgkvLyBTZXR0aW5nIG1hbnkgYXR0cmlidXRlcwoJaWYgKCB0eXBlb2Yga2V5ID09PSAib2JqZWN0IiApIHsKCQlmb3IgKCB2YXIgayBpbiBrZXkgKSB7CgkJCWFjY2VzcyggZWxlbXMsIGssIGtleVtrXSwgZXhlYywgZm4sIHZhbHVlICk7CgkJfQoJCXJldHVybiBlbGVtczsKCX0KCQoJLy8gU2V0dGluZyBvbmUgYXR0cmlidXRlCglpZiAoIHZhbHVlICE9PSB1bmRlZmluZWQgKSB7CgkJLy8gT3B0aW9uYWxseSwgZnVuY3Rpb24gdmFsdWVzIGdldCBleGVjdXRlZCBpZiBleGVjIGlzIHRydWUKCQlleGVjID0gIXBhc3MgJiYgZXhlYyAmJiBqUXVlcnkuaXNGdW5jdGlvbih2YWx1ZSk7CgkJCgkJZm9yICggdmFyIGkgPSAwOyBpIDwgbGVuZ3RoOyBpKysgKSB7CgkJCWZuKCBlbGVtc1tpXSwga2V5LCBleGVjID8gdmFsdWUuY2FsbCggZWxlbXNbaV0sIGksIGZuKCBlbGVtc1tpXSwga2V5ICkgKSA6IHZhbHVlLCBwYXNzICk7CgkJfQoJCQoJCXJldHVybiBlbGVtczsKCX0KCQoJLy8gR2V0dGluZyBhbiBhdHRyaWJ1dGUKCXJldHVybiBsZW5ndGggPyBmbiggZWxlbXNbMF0sIGtleSApIDogdW5kZWZpbmVkOwp9CgpmdW5jdGlvbiBub3coKSB7CglyZXR1cm4gKG5ldyBEYXRlKS5nZXRUaW1lKCk7Cn0KKGZ1bmN0aW9uKCkgewoKCWpRdWVyeS5zdXBwb3J0ID0ge307CgoJdmFyIHJvb3QgPSBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQsCgkJc2NyaXB0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgic2NyaXB0IiksCgkJZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2IiksCgkJaWQgPSAic2NyaXB0IiArIG5vdygpOwoKCWRpdi5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiOwoJZGl2LmlubmVySFRNTCA9ICIgICA8bGluay8+PHRhYmxlPjwvdGFibGU+PGEgaHJlZj0nL2EnIHN0eWxlPSdjb2xvcjpyZWQ7ZmxvYXQ6bGVmdDtvcGFjaXR5Oi41NTsnPmE8L2E+PGlucHV0IHR5cGU9J2NoZWNrYm94Jy8+IjsKCgl2YXIgYWxsID0gZGl2LmdldEVsZW1lbnRzQnlUYWdOYW1lKCIqIiksCgkJYSA9IGRpdi5nZXRFbGVtZW50c0J5VGFnTmFtZSgiYSIpWzBdOwoKCS8vIENhbid0IGdldCBiYXNpYyB0ZXN0IHN1cHBvcnQKCWlmICggIWFsbCB8fCAhYWxsLmxlbmd0aCB8fCAhYSApIHsKCQlyZXR1cm47Cgl9CgoJalF1ZXJ5LnN1cHBvcnQgPSB7CgkJLy8gSUUgc3RyaXBzIGxlYWRpbmcgd2hpdGVzcGFjZSB3aGVuIC5pbm5lckhUTUwgaXMgdXNlZAoJCWxlYWRpbmdXaGl0ZXNwYWNlOiBkaXYuZmlyc3RDaGlsZC5ub2RlVHlwZSA9PT0gMywKCgkJLy8gTWFrZSBzdXJlIHRoYXQgdGJvZHkgZWxlbWVudHMgYXJlbid0IGF1dG9tYXRpY2FsbHkgaW5zZXJ0ZWQKCQkvLyBJRSB3aWxsIGluc2VydCB0aGVtIGludG8gZW1wdHkgdGFibGVzCgkJdGJvZHk6ICFkaXYuZ2V0RWxlbWVudHNCeVRhZ05hbWUoInRib2R5IikubGVuZ3RoLAoKCQkvLyBNYWtlIHN1cmUgdGhhdCBsaW5rIGVsZW1lbnRzIGdldCBzZXJpYWxpemVkIGNvcnJlY3RseSBieSBpbm5lckhUTUwKCQkvLyBUaGlzIHJlcXVpcmVzIGEgd3JhcHBlciBlbGVtZW50IGluIElFCgkJaHRtbFNlcmlhbGl6ZTogISFkaXYuZ2V0RWxlbWVudHNCeVRhZ05hbWUoImxpbmsiKS5sZW5ndGgsCgoJCS8vIEdldCB0aGUgc3R5bGUgaW5mb3JtYXRpb24gZnJvbSBnZXRBdHRyaWJ1dGUKCQkvLyAoSUUgdXNlcyAuY3NzVGV4dCBpbnN0ZWQpCgkJc3R5bGU6IC9yZWQvLnRlc3QoIGEuZ2V0QXR0cmlidXRlKCJzdHlsZSIpICksCgoJCS8vIE1ha2Ugc3VyZSB0aGF0IFVSTHMgYXJlbid0IG1hbmlwdWxhdGVkCgkJLy8gKElFIG5vcm1hbGl6ZXMgaXQgYnkgZGVmYXVsdCkKCQlocmVmTm9ybWFsaXplZDogYS5nZXRBdHRyaWJ1dGUoImhyZWYiKSA9PT0gIi9hIiwKCgkJLy8gTWFrZSBzdXJlIHRoYXQgZWxlbWVudCBvcGFjaXR5IGV4aXN0cwoJCS8vIChJRSB1c2VzIGZpbHRlciBpbnN0ZWFkKQoJCS8vIFVzZSBhIHJlZ2V4IHRvIHdvcmsgYXJvdW5kIGEgV2ViS2l0IGlzc3VlLiBTZWUgIzUxNDUKCQlvcGFjaXR5OiAvXjAuNTUkLy50ZXN0KCBhLnN0eWxlLm9wYWNpdHkgKSwKCgkJLy8gVmVyaWZ5IHN0eWxlIGZsb2F0IGV4aXN0ZW5jZQoJCS8vIChJRSB1c2VzIHN0eWxlRmxvYXQgaW5zdGVhZCBvZiBjc3NGbG9hdCkKCQljc3NGbG9hdDogISFhLnN0eWxlLmNzc0Zsb2F0LAoKCQkvLyBNYWtlIHN1cmUgdGhhdCBpZiBubyB2YWx1ZSBpcyBzcGVjaWZpZWQgZm9yIGEgY2hlY2tib3gKCQkvLyB0aGF0IGl0IGRlZmF1bHRzIHRvICJvbiIuCgkJLy8gKFdlYktpdCBkZWZhdWx0cyB0byAiIiBpbnN0ZWFkKQoJCWNoZWNrT246IGRpdi5nZXRFbGVtZW50c0J5VGFnTmFtZSgiaW5wdXQiKVswXS52YWx1ZSA9PT0gIm9uIiwKCgkJLy8gTWFrZSBzdXJlIHRoYXQgYSBzZWxlY3RlZC1ieS1kZWZhdWx0IG9wdGlvbiBoYXMgYSB3b3JraW5nIHNlbGVjdGVkIHByb3BlcnR5LgoJCS8vIChXZWJLaXQgZGVmYXVsdHMgdG8gZmFsc2UgaW5zdGVhZCBvZiB0cnVlLCBJRSB0b28sIGlmIGl0J3MgaW4gYW4gb3B0Z3JvdXApCgkJb3B0U2VsZWN0ZWQ6IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInNlbGVjdCIpLmFwcGVuZENoaWxkKCBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJvcHRpb24iKSApLnNlbGVjdGVkLAoKCQlwYXJlbnROb2RlOiBkaXYucmVtb3ZlQ2hpbGQoIGRpdi5hcHBlbmRDaGlsZCggZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2IikgKSApLnBhcmVudE5vZGUgPT09IG51bGwsCgoJCS8vIFdpbGwgYmUgZGVmaW5lZCBsYXRlcgoJCWRlbGV0ZUV4cGFuZG86IHRydWUsCgkJY2hlY2tDbG9uZTogZmFsc2UsCgkJc2NyaXB0RXZhbDogZmFsc2UsCgkJbm9DbG9uZUV2ZW50OiB0cnVlLAoJCWJveE1vZGVsOiBudWxsCgl9OwoKCXNjcmlwdC50eXBlID0gInRleHQvamF2YXNjcmlwdCI7Cgl0cnkgewoJCXNjcmlwdC5hcHBlbmRDaGlsZCggZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoICJ3aW5kb3cuIiArIGlkICsgIj0xOyIgKSApOwoJfSBjYXRjaChlKSB7fQoKCXJvb3QuaW5zZXJ0QmVmb3JlKCBzY3JpcHQsIHJvb3QuZmlyc3RDaGlsZCApOwoKCS8vIE1ha2Ugc3VyZSB0aGF0IHRoZSBleGVjdXRpb24gb2YgY29kZSB3b3JrcyBieSBpbmplY3RpbmcgYSBzY3JpcHQKCS8vIHRhZyB3aXRoIGFwcGVuZENoaWxkL2NyZWF0ZVRleHROb2RlCgkvLyAoSUUgZG9lc24ndCBzdXBwb3J0IHRoaXMsIGZhaWxzLCBhbmQgdXNlcyAudGV4dCBpbnN0ZWFkKQoJaWYgKCB3aW5kb3dbIGlkIF0gKSB7CgkJalF1ZXJ5LnN1cHBvcnQuc2NyaXB0RXZhbCA9IHRydWU7CgkJZGVsZXRlIHdpbmRvd1sgaWQgXTsKCX0KCgkvLyBUZXN0IHRvIHNlZSBpZiBpdCdzIHBvc3NpYmxlIHRvIGRlbGV0ZSBhbiBleHBhbmRvIGZyb20gYW4gZWxlbWVudAoJLy8gRmFpbHMgaW4gSW50ZXJuZXQgRXhwbG9yZXIKCXRyeSB7CgkJZGVsZXRlIHNjcmlwdC50ZXN0OwoJCgl9IGNhdGNoKGUpIHsKCQlqUXVlcnkuc3VwcG9ydC5kZWxldGVFeHBhbmRvID0gZmFsc2U7Cgl9CgoJcm9vdC5yZW1vdmVDaGlsZCggc2NyaXB0ICk7CgoJaWYgKCBkaXYuYXR0YWNoRXZlbnQgJiYgZGl2LmZpcmVFdmVudCApIHsKCQlkaXYuYXR0YWNoRXZlbnQoIm9uY2xpY2siLCBmdW5jdGlvbiBjbGljaygpIHsKCQkJLy8gQ2xvbmluZyBhIG5vZGUgc2hvdWxkbid0IGNvcHkgb3ZlciBhbnkKCQkJLy8gYm91bmQgZXZlbnQgaGFuZGxlcnMgKElFIGRvZXMgdGhpcykKCQkJalF1ZXJ5LnN1cHBvcnQubm9DbG9uZUV2ZW50ID0gZmFsc2U7CgkJCWRpdi5kZXRhY2hFdmVudCgib25jbGljayIsIGNsaWNrKTsKCQl9KTsKCQlkaXYuY2xvbmVOb2RlKHRydWUpLmZpcmVFdmVudCgib25jbGljayIpOwoJfQoKCWRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwoJZGl2LmlubmVySFRNTCA9ICI8aW5wdXQgdHlwZT0ncmFkaW8nIG5hbWU9J3JhZGlvdGVzdCcgY2hlY2tlZD0nY2hlY2tlZCcvPiI7CgoJdmFyIGZyYWdtZW50ID0gZG9jdW1lbnQuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpOwoJZnJhZ21lbnQuYXBwZW5kQ2hpbGQoIGRpdi5maXJzdENoaWxkICk7CgoJLy8gV2ViS2l0IGRvZXNuJ3QgY2xvbmUgY2hlY2tlZCBzdGF0ZSBjb3JyZWN0bHkgaW4gZnJhZ21lbnRzCglqUXVlcnkuc3VwcG9ydC5jaGVja0Nsb25lID0gZnJhZ21lbnQuY2xvbmVOb2RlKHRydWUpLmNsb25lTm9kZSh0cnVlKS5sYXN0Q2hpbGQuY2hlY2tlZDsKCgkvLyBGaWd1cmUgb3V0IGlmIHRoZSBXM0MgYm94IG1vZGVsIHdvcmtzIGFzIGV4cGVjdGVkCgkvLyBkb2N1bWVudC5ib2R5IG11c3QgZXhpc3QgYmVmb3JlIHdlIGNhbiBkbyB0aGlzCglqUXVlcnkoZnVuY3Rpb24oKSB7CgkJdmFyIGRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwoJCWRpdi5zdHlsZS53aWR0aCA9IGRpdi5zdHlsZS5wYWRkaW5nTGVmdCA9ICIxcHgiOwoKCQlkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKCBkaXYgKTsKCQlqUXVlcnkuYm94TW9kZWwgPSBqUXVlcnkuc3VwcG9ydC5ib3hNb2RlbCA9IGRpdi5vZmZzZXRXaWR0aCA9PT0gMjsKCQlkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKCBkaXYgKS5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwoKCQlkaXYgPSBudWxsOwoJfSk7CgoJLy8gVGVjaG5pcXVlIGZyb20gSnVyaXkgWmF5dHNldgoJLy8gaHR0cDovL3RoaW5rd2ViMi5jb20vcHJvamVjdHMvcHJvdG90eXBlL2RldGVjdGluZy1ldmVudC1zdXBwb3J0LXdpdGhvdXQtYnJvd3Nlci1zbmlmZmluZy8KCXZhciBldmVudFN1cHBvcnRlZCA9IGZ1bmN0aW9uKCBldmVudE5hbWUgKSB7IAoJCXZhciBlbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOyAKCQlldmVudE5hbWUgPSAib24iICsgZXZlbnROYW1lOyAKCgkJdmFyIGlzU3VwcG9ydGVkID0gKGV2ZW50TmFtZSBpbiBlbCk7IAoJCWlmICggIWlzU3VwcG9ydGVkICkgeyAKCQkJZWwuc2V0QXR0cmlidXRlKGV2ZW50TmFtZSwgInJldHVybjsiKTsgCgkJCWlzU3VwcG9ydGVkID0gdHlwZW9mIGVsW2V2ZW50TmFtZV0gPT09ICJmdW5jdGlvbiI7IAoJCX0gCgkJZWwgPSBudWxsOyAKCgkJcmV0dXJuIGlzU3VwcG9ydGVkOyAKCX07CgkKCWpRdWVyeS5zdXBwb3J0LnN1Ym1pdEJ1YmJsZXMgPSBldmVudFN1cHBvcnRlZCgic3VibWl0Iik7CglqUXVlcnkuc3VwcG9ydC5jaGFuZ2VCdWJibGVzID0gZXZlbnRTdXBwb3J0ZWQoImNoYW5nZSIpOwoKCS8vIHJlbGVhc2UgbWVtb3J5IGluIElFCglyb290ID0gc2NyaXB0ID0gZGl2ID0gYWxsID0gYSA9IG51bGw7Cn0pKCk7CgpqUXVlcnkucHJvcHMgPSB7CgkiZm9yIjogImh0bWxGb3IiLAoJImNsYXNzIjogImNsYXNzTmFtZSIsCglyZWFkb25seTogInJlYWRPbmx5IiwKCW1heGxlbmd0aDogIm1heExlbmd0aCIsCgljZWxsc3BhY2luZzogImNlbGxTcGFjaW5nIiwKCXJvd3NwYW46ICJyb3dTcGFuIiwKCWNvbHNwYW46ICJjb2xTcGFuIiwKCXRhYmluZGV4OiAidGFiSW5kZXgiLAoJdXNlbWFwOiAidXNlTWFwIiwKCWZyYW1lYm9yZGVyOiAiZnJhbWVCb3JkZXIiCn07CnZhciBleHBhbmRvID0gImpRdWVyeSIgKyBub3coKSwgdXVpZCA9IDAsIHdpbmRvd0RhdGEgPSB7fTsKCmpRdWVyeS5leHRlbmQoewoJY2FjaGU6IHt9LAoJCglleHBhbmRvOmV4cGFuZG8sCgoJLy8gVGhlIGZvbGxvd2luZyBlbGVtZW50cyB0aHJvdyB1bmNhdGNoYWJsZSBleGNlcHRpb25zIGlmIHlvdQoJLy8gYXR0ZW1wdCB0byBhZGQgZXhwYW5kbyBwcm9wZXJ0aWVzIHRvIHRoZW0uCglub0RhdGE6IHsKCQkiZW1iZWQiOiB0cnVlLAoJCSJvYmplY3QiOiB0cnVlLAoJCSJhcHBsZXQiOiB0cnVlCgl9LAoKCWRhdGE6IGZ1bmN0aW9uKCBlbGVtLCBuYW1lLCBkYXRhICkgewoJCWlmICggZWxlbS5ub2RlTmFtZSAmJiBqUXVlcnkubm9EYXRhW2VsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKV0gKSB7CgkJCXJldHVybjsKCQl9CgoJCWVsZW0gPSBlbGVtID09IHdpbmRvdyA/CgkJCXdpbmRvd0RhdGEgOgoJCQllbGVtOwoKCQl2YXIgaWQgPSBlbGVtWyBleHBhbmRvIF0sIGNhY2hlID0galF1ZXJ5LmNhY2hlLCB0aGlzQ2FjaGU7CgoJCWlmICggIWlkICYmIHR5cGVvZiBuYW1lID09PSAic3RyaW5nIiAmJiBkYXRhID09PSB1bmRlZmluZWQgKSB7CgkJCXJldHVybiBudWxsOwoJCX0KCgkJLy8gQ29tcHV0ZSBhIHVuaXF1ZSBJRCBmb3IgdGhlIGVsZW1lbnQKCQlpZiAoICFpZCApIHsgCgkJCWlkID0gKyt1dWlkOwoJCX0KCgkJLy8gQXZvaWQgZ2VuZXJhdGluZyBhIG5ldyBjYWNoZSB1bmxlc3Mgbm9uZSBleGlzdHMgYW5kIHdlCgkJLy8gd2FudCB0byBtYW5pcHVsYXRlIGl0LgoJCWlmICggdHlwZW9mIG5hbWUgPT09ICJvYmplY3QiICkgewoJCQllbGVtWyBleHBhbmRvIF0gPSBpZDsKCQkJdGhpc0NhY2hlID0gY2FjaGVbIGlkIF0gPSBqUXVlcnkuZXh0ZW5kKHRydWUsIHt9LCBuYW1lKTsKCgkJfSBlbHNlIGlmICggIWNhY2hlWyBpZCBdICkgewoJCQllbGVtWyBleHBhbmRvIF0gPSBpZDsKCQkJY2FjaGVbIGlkIF0gPSB7fTsKCQl9CgoJCXRoaXNDYWNoZSA9IGNhY2hlWyBpZCBdOwoKCQkvLyBQcmV2ZW50IG92ZXJyaWRpbmcgdGhlIG5hbWVkIGNhY2hlIHdpdGggdW5kZWZpbmVkIHZhbHVlcwoJCWlmICggZGF0YSAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzQ2FjaGVbIG5hbWUgXSA9IGRhdGE7CgkJfQoKCQlyZXR1cm4gdHlwZW9mIG5hbWUgPT09ICJzdHJpbmciID8gdGhpc0NhY2hlWyBuYW1lIF0gOiB0aGlzQ2FjaGU7Cgl9LAoKCXJlbW92ZURhdGE6IGZ1bmN0aW9uKCBlbGVtLCBuYW1lICkgewoJCWlmICggZWxlbS5ub2RlTmFtZSAmJiBqUXVlcnkubm9EYXRhW2VsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKV0gKSB7CgkJCXJldHVybjsKCQl9CgoJCWVsZW0gPSBlbGVtID09IHdpbmRvdyA/CgkJCXdpbmRvd0RhdGEgOgoJCQllbGVtOwoKCQl2YXIgaWQgPSBlbGVtWyBleHBhbmRvIF0sIGNhY2hlID0galF1ZXJ5LmNhY2hlLCB0aGlzQ2FjaGUgPSBjYWNoZVsgaWQgXTsKCgkJLy8gSWYgd2Ugd2FudCB0byByZW1vdmUgYSBzcGVjaWZpYyBzZWN0aW9uIG9mIHRoZSBlbGVtZW50J3MgZGF0YQoJCWlmICggbmFtZSApIHsKCQkJaWYgKCB0aGlzQ2FjaGUgKSB7CgkJCQkvLyBSZW1vdmUgdGhlIHNlY3Rpb24gb2YgY2FjaGUgZGF0YQoJCQkJZGVsZXRlIHRoaXNDYWNoZVsgbmFtZSBdOwoKCQkJCS8vIElmIHdlJ3ZlIHJlbW92ZWQgYWxsIHRoZSBkYXRhLCByZW1vdmUgdGhlIGVsZW1lbnQncyBjYWNoZQoJCQkJaWYgKCBqUXVlcnkuaXNFbXB0eU9iamVjdCh0aGlzQ2FjaGUpICkgewoJCQkJCWpRdWVyeS5yZW1vdmVEYXRhKCBlbGVtICk7CgkJCQl9CgkJCX0KCgkJLy8gT3RoZXJ3aXNlLCB3ZSB3YW50IHRvIHJlbW92ZSBhbGwgb2YgdGhlIGVsZW1lbnQncyBkYXRhCgkJfSBlbHNlIHsKCQkJaWYgKCBqUXVlcnkuc3VwcG9ydC5kZWxldGVFeHBhbmRvICkgewoJCQkJZGVsZXRlIGVsZW1bIGpRdWVyeS5leHBhbmRvIF07CgoJCQl9IGVsc2UgaWYgKCBlbGVtLnJlbW92ZUF0dHJpYnV0ZSApIHsKCQkJCWVsZW0ucmVtb3ZlQXR0cmlidXRlKCBqUXVlcnkuZXhwYW5kbyApOwoJCQl9CgoJCQkvLyBDb21wbGV0ZWx5IHJlbW92ZSB0aGUgZGF0YSBjYWNoZQoJCQlkZWxldGUgY2FjaGVbIGlkIF07CgkJfQoJfQp9KTsKCmpRdWVyeS5mbi5leHRlbmQoewoJZGF0YTogZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CgkJaWYgKCB0eXBlb2Yga2V5ID09PSAidW5kZWZpbmVkIiAmJiB0aGlzLmxlbmd0aCApIHsKCQkJcmV0dXJuIGpRdWVyeS5kYXRhKCB0aGlzWzBdICk7CgoJCX0gZWxzZSBpZiAoIHR5cGVvZiBrZXkgPT09ICJvYmplY3QiICkgewoJCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJalF1ZXJ5LmRhdGEoIHRoaXMsIGtleSApOwoJCQl9KTsKCQl9CgoJCXZhciBwYXJ0cyA9IGtleS5zcGxpdCgiLiIpOwoJCXBhcnRzWzFdID0gcGFydHNbMV0gPyAiLiIgKyBwYXJ0c1sxXSA6ICIiOwoKCQlpZiAoIHZhbHVlID09PSB1bmRlZmluZWQgKSB7CgkJCXZhciBkYXRhID0gdGhpcy50cmlnZ2VySGFuZGxlcigiZ2V0RGF0YSIgKyBwYXJ0c1sxXSArICIhIiwgW3BhcnRzWzBdXSk7CgoJCQlpZiAoIGRhdGEgPT09IHVuZGVmaW5lZCAmJiB0aGlzLmxlbmd0aCApIHsKCQkJCWRhdGEgPSBqUXVlcnkuZGF0YSggdGhpc1swXSwga2V5ICk7CgkJCX0KCQkJcmV0dXJuIGRhdGEgPT09IHVuZGVmaW5lZCAmJiBwYXJ0c1sxXSA/CgkJCQl0aGlzLmRhdGEoIHBhcnRzWzBdICkgOgoJCQkJZGF0YTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy50cmlnZ2VyKCJzZXREYXRhIiArIHBhcnRzWzFdICsgIiEiLCBbcGFydHNbMF0sIHZhbHVlXSkuZWFjaChmdW5jdGlvbigpIHsKCQkJCWpRdWVyeS5kYXRhKCB0aGlzLCBrZXksIHZhbHVlICk7CgkJCX0pOwoJCX0KCX0sCgoJcmVtb3ZlRGF0YTogZnVuY3Rpb24oIGtleSApIHsKCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQlqUXVlcnkucmVtb3ZlRGF0YSggdGhpcywga2V5ICk7CgkJfSk7Cgl9Cn0pOwpqUXVlcnkuZXh0ZW5kKHsKCXF1ZXVlOiBmdW5jdGlvbiggZWxlbSwgdHlwZSwgZGF0YSApIHsKCQlpZiAoICFlbGVtICkgewoJCQlyZXR1cm47CgkJfQoKCQl0eXBlID0gKHR5cGUgfHwgImZ4IikgKyAicXVldWUiOwoJCXZhciBxID0galF1ZXJ5LmRhdGEoIGVsZW0sIHR5cGUgKTsKCgkJLy8gU3BlZWQgdXAgZGVxdWV1ZSBieSBnZXR0aW5nIG91dCBxdWlja2x5IGlmIHRoaXMgaXMganVzdCBhIGxvb2t1cAoJCWlmICggIWRhdGEgKSB7CgkJCXJldHVybiBxIHx8IFtdOwoJCX0KCgkJaWYgKCAhcSB8fCBqUXVlcnkuaXNBcnJheShkYXRhKSApIHsKCQkJcSA9IGpRdWVyeS5kYXRhKCBlbGVtLCB0eXBlLCBqUXVlcnkubWFrZUFycmF5KGRhdGEpICk7CgoJCX0gZWxzZSB7CgkJCXEucHVzaCggZGF0YSApOwoJCX0KCgkJcmV0dXJuIHE7Cgl9LAoKCWRlcXVldWU6IGZ1bmN0aW9uKCBlbGVtLCB0eXBlICkgewoJCXR5cGUgPSB0eXBlIHx8ICJmeCI7CgoJCXZhciBxdWV1ZSA9IGpRdWVyeS5xdWV1ZSggZWxlbSwgdHlwZSApLCBmbiA9IHF1ZXVlLnNoaWZ0KCk7CgoJCS8vIElmIHRoZSBmeCBxdWV1ZSBpcyBkZXF1ZXVlZCwgYWx3YXlzIHJlbW92ZSB0aGUgcHJvZ3Jlc3Mgc2VudGluZWwKCQlpZiAoIGZuID09PSAiaW5wcm9ncmVzcyIgKSB7CgkJCWZuID0gcXVldWUuc2hpZnQoKTsKCQl9CgoJCWlmICggZm4gKSB7CgkJCS8vIEFkZCBhIHByb2dyZXNzIHNlbnRpbmVsIHRvIHByZXZlbnQgdGhlIGZ4IHF1ZXVlIGZyb20gYmVpbmcKCQkJLy8gYXV0b21hdGljYWxseSBkZXF1ZXVlZAoJCQlpZiAoIHR5cGUgPT09ICJmeCIgKSB7CgkJCQlxdWV1ZS51bnNoaWZ0KCJpbnByb2dyZXNzIik7CgkJCX0KCgkJCWZuLmNhbGwoZWxlbSwgZnVuY3Rpb24oKSB7CgkJCQlqUXVlcnkuZGVxdWV1ZShlbGVtLCB0eXBlKTsKCQkJfSk7CgkJfQoJfQp9KTsKCmpRdWVyeS5mbi5leHRlbmQoewoJcXVldWU6IGZ1bmN0aW9uKCB0eXBlLCBkYXRhICkgewoJCWlmICggdHlwZW9mIHR5cGUgIT09ICJzdHJpbmciICkgewoJCQlkYXRhID0gdHlwZTsKCQkJdHlwZSA9ICJmeCI7CgkJfQoKCQlpZiAoIGRhdGEgPT09IHVuZGVmaW5lZCApIHsKCQkJcmV0dXJuIGpRdWVyeS5xdWV1ZSggdGhpc1swXSwgdHlwZSApOwoJCX0KCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCBpLCBlbGVtICkgewoJCQl2YXIgcXVldWUgPSBqUXVlcnkucXVldWUoIHRoaXMsIHR5cGUsIGRhdGEgKTsKCgkJCWlmICggdHlwZSA9PT0gImZ4IiAmJiBxdWV1ZVswXSAhPT0gImlucHJvZ3Jlc3MiICkgewoJCQkJalF1ZXJ5LmRlcXVldWUoIHRoaXMsIHR5cGUgKTsKCQkJfQoJCX0pOwoJfSwKCWRlcXVldWU6IGZ1bmN0aW9uKCB0eXBlICkgewoJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgkJCWpRdWVyeS5kZXF1ZXVlKCB0aGlzLCB0eXBlICk7CgkJfSk7Cgl9LAoKCS8vIEJhc2VkIG9mZiBvZiB0aGUgcGx1Z2luIGJ5IENsaW50IEhlbGZlcnMsIHdpdGggcGVybWlzc2lvbi4KCS8vIGh0dHA6Ly9ibGluZHNpZ25hbHMuY29tL2luZGV4LnBocC8yMDA5LzA3L2pxdWVyeS1kZWxheS8KCWRlbGF5OiBmdW5jdGlvbiggdGltZSwgdHlwZSApIHsKCQl0aW1lID0galF1ZXJ5LmZ4ID8galF1ZXJ5LmZ4LnNwZWVkc1t0aW1lXSB8fCB0aW1lIDogdGltZTsKCQl0eXBlID0gdHlwZSB8fCAiZngiOwoKCQlyZXR1cm4gdGhpcy5xdWV1ZSggdHlwZSwgZnVuY3Rpb24oKSB7CgkJCXZhciBlbGVtID0gdGhpczsKCQkJc2V0VGltZW91dChmdW5jdGlvbigpIHsKCQkJCWpRdWVyeS5kZXF1ZXVlKCBlbGVtLCB0eXBlICk7CgkJCX0sIHRpbWUgKTsKCQl9KTsKCX0sCgoJY2xlYXJRdWV1ZTogZnVuY3Rpb24oIHR5cGUgKSB7CgkJcmV0dXJuIHRoaXMucXVldWUoIHR5cGUgfHwgImZ4IiwgW10gKTsKCX0KfSk7CnZhciByY2xhc3MgPSAvW1xuXHRdL2csCglyc3BhY2UgPSAvXHMrLywKCXJyZXR1cm4gPSAvXHIvZywKCXJzcGVjaWFsdXJsID0gL2hyZWZ8c3JjfHN0eWxlLywKCXJ0eXBlID0gLyhidXR0b258aW5wdXQpL2ksCglyZm9jdXNhYmxlID0gLyhidXR0b258aW5wdXR8b2JqZWN0fHNlbGVjdHx0ZXh0YXJlYSkvaSwKCXJjbGlja2FibGUgPSAvXihhfGFyZWEpJC9pLAoJcnJhZGlvY2hlY2sgPSAvcmFkaW98Y2hlY2tib3gvOwoKalF1ZXJ5LmZuLmV4dGVuZCh7CglhdHRyOiBmdW5jdGlvbiggbmFtZSwgdmFsdWUgKSB7CgkJcmV0dXJuIGFjY2VzcyggdGhpcywgbmFtZSwgdmFsdWUsIHRydWUsIGpRdWVyeS5hdHRyICk7Cgl9LAoKCXJlbW92ZUF0dHI6IGZ1bmN0aW9uKCBuYW1lLCBmbiApIHsKCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCl7CgkJCWpRdWVyeS5hdHRyKCB0aGlzLCBuYW1lLCAiIiApOwoJCQlpZiAoIHRoaXMubm9kZVR5cGUgPT09IDEgKSB7CgkJCQl0aGlzLnJlbW92ZUF0dHJpYnV0ZSggbmFtZSApOwoJCQl9CgkJfSk7Cgl9LAoKCWFkZENsYXNzOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJaWYgKCBqUXVlcnkuaXNGdW5jdGlvbih2YWx1ZSkgKSB7CgkJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oaSkgewoJCQkJdmFyIHNlbGYgPSBqUXVlcnkodGhpcyk7CgkJCQlzZWxmLmFkZENsYXNzKCB2YWx1ZS5jYWxsKHRoaXMsIGksIHNlbGYuYXR0cigiY2xhc3MiKSkgKTsKCQkJfSk7CgkJfQoKCQlpZiAoIHZhbHVlICYmIHR5cGVvZiB2YWx1ZSA9PT0gInN0cmluZyIgKSB7CgkJCXZhciBjbGFzc05hbWVzID0gKHZhbHVlIHx8ICIiKS5zcGxpdCggcnNwYWNlICk7CgoJCQlmb3IgKCB2YXIgaSA9IDAsIGwgPSB0aGlzLmxlbmd0aDsgaSA8IGw7IGkrKyApIHsKCQkJCXZhciBlbGVtID0gdGhpc1tpXTsKCgkJCQlpZiAoIGVsZW0ubm9kZVR5cGUgPT09IDEgKSB7CgkJCQkJaWYgKCAhZWxlbS5jbGFzc05hbWUgKSB7CgkJCQkJCWVsZW0uY2xhc3NOYW1lID0gdmFsdWU7CgoJCQkJCX0gZWxzZSB7CgkJCQkJCXZhciBjbGFzc05hbWUgPSAiICIgKyBlbGVtLmNsYXNzTmFtZSArICIgIiwgc2V0Q2xhc3MgPSBlbGVtLmNsYXNzTmFtZTsKCQkJCQkJZm9yICggdmFyIGMgPSAwLCBjbCA9IGNsYXNzTmFtZXMubGVuZ3RoOyBjIDwgY2w7IGMrKyApIHsKCQkJCQkJCWlmICggY2xhc3NOYW1lLmluZGV4T2YoICIgIiArIGNsYXNzTmFtZXNbY10gKyAiICIgKSA8IDAgKSB7CgkJCQkJCQkJc2V0Q2xhc3MgKz0gIiAiICsgY2xhc3NOYW1lc1tjXTsKCQkJCQkJCX0KCQkJCQkJfQoJCQkJCQllbGVtLmNsYXNzTmFtZSA9IGpRdWVyeS50cmltKCBzZXRDbGFzcyApOwoJCQkJCX0KCQkJCX0KCQkJfQoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9LAoKCXJlbW92ZUNsYXNzOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJaWYgKCBqUXVlcnkuaXNGdW5jdGlvbih2YWx1ZSkgKSB7CgkJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oaSkgewoJCQkJdmFyIHNlbGYgPSBqUXVlcnkodGhpcyk7CgkJCQlzZWxmLnJlbW92ZUNsYXNzKCB2YWx1ZS5jYWxsKHRoaXMsIGksIHNlbGYuYXR0cigiY2xhc3MiKSkgKTsKCQkJfSk7CgkJfQoKCQlpZiAoICh2YWx1ZSAmJiB0eXBlb2YgdmFsdWUgPT09ICJzdHJpbmciKSB8fCB2YWx1ZSA9PT0gdW5kZWZpbmVkICkgewoJCQl2YXIgY2xhc3NOYW1lcyA9ICh2YWx1ZSB8fCAiIikuc3BsaXQocnNwYWNlKTsKCgkJCWZvciAoIHZhciBpID0gMCwgbCA9IHRoaXMubGVuZ3RoOyBpIDwgbDsgaSsrICkgewoJCQkJdmFyIGVsZW0gPSB0aGlzW2ldOwoKCQkJCWlmICggZWxlbS5ub2RlVHlwZSA9PT0gMSAmJiBlbGVtLmNsYXNzTmFtZSApIHsKCQkJCQlpZiAoIHZhbHVlICkgewoJCQkJCQl2YXIgY2xhc3NOYW1lID0gKCIgIiArIGVsZW0uY2xhc3NOYW1lICsgIiAiKS5yZXBsYWNlKHJjbGFzcywgIiAiKTsKCQkJCQkJZm9yICggdmFyIGMgPSAwLCBjbCA9IGNsYXNzTmFtZXMubGVuZ3RoOyBjIDwgY2w7IGMrKyApIHsKCQkJCQkJCWNsYXNzTmFtZSA9IGNsYXNzTmFtZS5yZXBsYWNlKCIgIiArIGNsYXNzTmFtZXNbY10gKyAiICIsICIgIik7CgkJCQkJCX0KCQkJCQkJZWxlbS5jbGFzc05hbWUgPSBqUXVlcnkudHJpbSggY2xhc3NOYW1lICk7CgoJCQkJCX0gZWxzZSB7CgkJCQkJCWVsZW0uY2xhc3NOYW1lID0gIiI7CgkJCQkJfQoJCQkJfQoJCQl9CgkJfQoKCQlyZXR1cm4gdGhpczsKCX0sCgoJdG9nZ2xlQ2xhc3M6IGZ1bmN0aW9uKCB2YWx1ZSwgc3RhdGVWYWwgKSB7CgkJdmFyIHR5cGUgPSB0eXBlb2YgdmFsdWUsIGlzQm9vbCA9IHR5cGVvZiBzdGF0ZVZhbCA9PT0gImJvb2xlYW4iOwoKCQlpZiAoIGpRdWVyeS5pc0Z1bmN0aW9uKCB2YWx1ZSApICkgewoJCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKGkpIHsKCQkJCXZhciBzZWxmID0galF1ZXJ5KHRoaXMpOwoJCQkJc2VsZi50b2dnbGVDbGFzcyggdmFsdWUuY2FsbCh0aGlzLCBpLCBzZWxmLmF0dHIoImNsYXNzIiksIHN0YXRlVmFsKSwgc3RhdGVWYWwgKTsKCQkJfSk7CgkJfQoKCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQlpZiAoIHR5cGUgPT09ICJzdHJpbmciICkgewoJCQkJLy8gdG9nZ2xlIGluZGl2aWR1YWwgY2xhc3MgbmFtZXMKCQkJCXZhciBjbGFzc05hbWUsIGkgPSAwLCBzZWxmID0galF1ZXJ5KHRoaXMpLAoJCQkJCXN0YXRlID0gc3RhdGVWYWwsCgkJCQkJY2xhc3NOYW1lcyA9IHZhbHVlLnNwbGl0KCByc3BhY2UgKTsKCgkJCQl3aGlsZSAoIChjbGFzc05hbWUgPSBjbGFzc05hbWVzWyBpKysgXSkgKSB7CgkJCQkJLy8gY2hlY2sgZWFjaCBjbGFzc05hbWUgZ2l2ZW4sIHNwYWNlIHNlcGVyYXRlZCBsaXN0CgkJCQkJc3RhdGUgPSBpc0Jvb2wgPyBzdGF0ZSA6ICFzZWxmLmhhc0NsYXNzKCBjbGFzc05hbWUgKTsKCQkJCQlzZWxmWyBzdGF0ZSA/ICJhZGRDbGFzcyIgOiAicmVtb3ZlQ2xhc3MiIF0oIGNsYXNzTmFtZSApOwoJCQkJfQoKCQkJfSBlbHNlIGlmICggdHlwZSA9PT0gInVuZGVmaW5lZCIgfHwgdHlwZSA9PT0gImJvb2xlYW4iICkgewoJCQkJaWYgKCB0aGlzLmNsYXNzTmFtZSApIHsKCQkJCQkvLyBzdG9yZSBjbGFzc05hbWUgaWYgc2V0CgkJCQkJalF1ZXJ5LmRhdGEoIHRoaXMsICJfX2NsYXNzTmFtZV9fIiwgdGhpcy5jbGFzc05hbWUgKTsKCQkJCX0KCgkJCQkvLyB0b2dnbGUgd2hvbGUgY2xhc3NOYW1lCgkJCQl0aGlzLmNsYXNzTmFtZSA9IHRoaXMuY2xhc3NOYW1lIHx8IHZhbHVlID09PSBmYWxzZSA/ICIiIDogalF1ZXJ5LmRhdGEoIHRoaXMsICJfX2NsYXNzTmFtZV9fIiApIHx8ICIiOwoJCQl9CgkJfSk7Cgl9LAoKCWhhc0NsYXNzOiBmdW5jdGlvbiggc2VsZWN0b3IgKSB7CgkJdmFyIGNsYXNzTmFtZSA9ICIgIiArIHNlbGVjdG9yICsgIiAiOwoJCWZvciAoIHZhciBpID0gMCwgbCA9IHRoaXMubGVuZ3RoOyBpIDwgbDsgaSsrICkgewoJCQlpZiAoICgiICIgKyB0aGlzW2ldLmNsYXNzTmFtZSArICIgIikucmVwbGFjZShyY2xhc3MsICIgIikuaW5kZXhPZiggY2xhc3NOYW1lICkgPiAtMSApIHsKCQkJCXJldHVybiB0cnVlOwoJCQl9CgkJfQoKCQlyZXR1cm4gZmFsc2U7Cgl9LAoKCXZhbDogZnVuY3Rpb24oIHZhbHVlICkgewoJCWlmICggdmFsdWUgPT09IHVuZGVmaW5lZCApIHsKCQkJdmFyIGVsZW0gPSB0aGlzWzBdOwoKCQkJaWYgKCBlbGVtICkgewoJCQkJaWYgKCBqUXVlcnkubm9kZU5hbWUoIGVsZW0sICJvcHRpb24iICkgKSB7CgkJCQkJcmV0dXJuIChlbGVtLmF0dHJpYnV0ZXMudmFsdWUgfHwge30pLnNwZWNpZmllZCA/IGVsZW0udmFsdWUgOiBlbGVtLnRleHQ7CgkJCQl9CgoJCQkJLy8gV2UgbmVlZCB0byBoYW5kbGUgc2VsZWN0IGJveGVzIHNwZWNpYWwKCQkJCWlmICggalF1ZXJ5Lm5vZGVOYW1lKCBlbGVtLCAic2VsZWN0IiApICkgewoJCQkJCXZhciBpbmRleCA9IGVsZW0uc2VsZWN0ZWRJbmRleCwKCQkJCQkJdmFsdWVzID0gW10sCgkJCQkJCW9wdGlvbnMgPSBlbGVtLm9wdGlvbnMsCgkJCQkJCW9uZSA9IGVsZW0udHlwZSA9PT0gInNlbGVjdC1vbmUiOwoKCQkJCQkvLyBOb3RoaW5nIHdhcyBzZWxlY3RlZAoJCQkJCWlmICggaW5kZXggPCAwICkgewoJCQkJCQlyZXR1cm4gbnVsbDsKCQkJCQl9CgoJCQkJCS8vIExvb3AgdGhyb3VnaCBhbGwgdGhlIHNlbGVjdGVkIG9wdGlvbnMKCQkJCQlmb3IgKCB2YXIgaSA9IG9uZSA/IGluZGV4IDogMCwgbWF4ID0gb25lID8gaW5kZXggKyAxIDogb3B0aW9ucy5sZW5ndGg7IGkgPCBtYXg7IGkrKyApIHsKCQkJCQkJdmFyIG9wdGlvbiA9IG9wdGlvbnNbIGkgXTsKCgkJCQkJCWlmICggb3B0aW9uLnNlbGVjdGVkICkgewoJCQkJCQkJLy8gR2V0IHRoZSBzcGVjaWZjIHZhbHVlIGZvciB0aGUgb3B0aW9uCgkJCQkJCQl2YWx1ZSA9IGpRdWVyeShvcHRpb24pLnZhbCgpOwoKCQkJCQkJCS8vIFdlIGRvbid0IG5lZWQgYW4gYXJyYXkgZm9yIG9uZSBzZWxlY3RzCgkJCQkJCQlpZiAoIG9uZSApIHsKCQkJCQkJCQlyZXR1cm4gdmFsdWU7CgkJCQkJCQl9CgoJCQkJCQkJLy8gTXVsdGktU2VsZWN0cyByZXR1cm4gYW4gYXJyYXkKCQkJCQkJCXZhbHVlcy5wdXNoKCB2YWx1ZSApOwoJCQkJCQl9CgkJCQkJfQoKCQkJCQlyZXR1cm4gdmFsdWVzOwoJCQkJfQoKCQkJCS8vIEhhbmRsZSB0aGUgY2FzZSB3aGVyZSBpbiBXZWJraXQgIiIgaXMgcmV0dXJuZWQgaW5zdGVhZCBvZiAib24iIGlmIGEgdmFsdWUgaXNuJ3Qgc3BlY2lmaWVkCgkJCQlpZiAoIHJyYWRpb2NoZWNrLnRlc3QoIGVsZW0udHlwZSApICYmICFqUXVlcnkuc3VwcG9ydC5jaGVja09uICkgewoJCQkJCXJldHVybiBlbGVtLmdldEF0dHJpYnV0ZSgidmFsdWUiKSA9PT0gbnVsbCA/ICJvbiIgOiBlbGVtLnZhbHVlOwoJCQkJfQoJCQkJCgoJCQkJLy8gRXZlcnl0aGluZyBlbHNlLCB3ZSBqdXN0IGdyYWIgdGhlIHZhbHVlCgkJCQlyZXR1cm4gKGVsZW0udmFsdWUgfHwgIiIpLnJlcGxhY2UocnJldHVybiwgIiIpOwoKCQkJfQoKCQkJcmV0dXJuIHVuZGVmaW5lZDsKCQl9CgoJCXZhciBpc0Z1bmN0aW9uID0galF1ZXJ5LmlzRnVuY3Rpb24odmFsdWUpOwoKCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKGkpIHsKCQkJdmFyIHNlbGYgPSBqUXVlcnkodGhpcyksIHZhbCA9IHZhbHVlOwoKCQkJaWYgKCB0aGlzLm5vZGVUeXBlICE9PSAxICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQlpZiAoIGlzRnVuY3Rpb24gKSB7CgkJCQl2YWwgPSB2YWx1ZS5jYWxsKHRoaXMsIGksIHNlbGYudmFsKCkpOwoJCQl9CgoJCQkvLyBUeXBlY2FzdCBlYWNoIHRpbWUgaWYgdGhlIHZhbHVlIGlzIGEgRnVuY3Rpb24gYW5kIHRoZSBhcHBlbmRlZAoJCQkvLyB2YWx1ZSBpcyB0aGVyZWZvcmUgZGlmZmVyZW50IGVhY2ggdGltZS4KCQkJaWYgKCB0eXBlb2YgdmFsID09PSAibnVtYmVyIiApIHsKCQkJCXZhbCArPSAiIjsKCQkJfQoKCQkJaWYgKCBqUXVlcnkuaXNBcnJheSh2YWwpICYmIHJyYWRpb2NoZWNrLnRlc3QoIHRoaXMudHlwZSApICkgewoJCQkJdGhpcy5jaGVja2VkID0galF1ZXJ5LmluQXJyYXkoIHNlbGYudmFsKCksIHZhbCApID49IDA7CgoJCQl9IGVsc2UgaWYgKCBqUXVlcnkubm9kZU5hbWUoIHRoaXMsICJzZWxlY3QiICkgKSB7CgkJCQl2YXIgdmFsdWVzID0galF1ZXJ5Lm1ha2VBcnJheSh2YWwpOwoKCQkJCWpRdWVyeSggIm9wdGlvbiIsIHRoaXMgKS5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJCXRoaXMuc2VsZWN0ZWQgPSBqUXVlcnkuaW5BcnJheSggalF1ZXJ5KHRoaXMpLnZhbCgpLCB2YWx1ZXMgKSA+PSAwOwoJCQkJfSk7CgoJCQkJaWYgKCAhdmFsdWVzLmxlbmd0aCApIHsKCQkJCQl0aGlzLnNlbGVjdGVkSW5kZXggPSAtMTsKCQkJCX0KCgkJCX0gZWxzZSB7CgkJCQl0aGlzLnZhbHVlID0gdmFsOwoJCQl9CgkJfSk7Cgl9Cn0pOwoKalF1ZXJ5LmV4dGVuZCh7CglhdHRyRm46IHsKCQl2YWw6IHRydWUsCgkJY3NzOiB0cnVlLAoJCWh0bWw6IHRydWUsCgkJdGV4dDogdHJ1ZSwKCQlkYXRhOiB0cnVlLAoJCXdpZHRoOiB0cnVlLAoJCWhlaWdodDogdHJ1ZSwKCQlvZmZzZXQ6IHRydWUKCX0sCgkJCglhdHRyOiBmdW5jdGlvbiggZWxlbSwgbmFtZSwgdmFsdWUsIHBhc3MgKSB7CgkJLy8gZG9uJ3Qgc2V0IGF0dHJpYnV0ZXMgb24gdGV4dCBhbmQgY29tbWVudCBub2RlcwoJCWlmICggIWVsZW0gfHwgZWxlbS5ub2RlVHlwZSA9PT0gMyB8fCBlbGVtLm5vZGVUeXBlID09PSA4ICkgewoJCQlyZXR1cm4gdW5kZWZpbmVkOwoJCX0KCgkJaWYgKCBwYXNzICYmIG5hbWUgaW4galF1ZXJ5LmF0dHJGbiApIHsKCQkJcmV0dXJuIGpRdWVyeShlbGVtKVtuYW1lXSh2YWx1ZSk7CgkJfQoKCQl2YXIgbm90eG1sID0gZWxlbS5ub2RlVHlwZSAhPT0gMSB8fCAhalF1ZXJ5LmlzWE1MRG9jKCBlbGVtICksCgkJCS8vIFdoZXRoZXIgd2UgYXJlIHNldHRpbmcgKG9yIGdldHRpbmcpCgkJCXNldCA9IHZhbHVlICE9PSB1bmRlZmluZWQ7CgoJCS8vIFRyeSB0byBub3JtYWxpemUvZml4IHRoZSBuYW1lCgkJbmFtZSA9IG5vdHhtbCAmJiBqUXVlcnkucHJvcHNbIG5hbWUgXSB8fCBuYW1lOwoKCQkvLyBPbmx5IGRvIGFsbCB0aGUgZm9sbG93aW5nIGlmIHRoaXMgaXMgYSBub2RlIChmYXN0ZXIgZm9yIHN0eWxlKQoJCWlmICggZWxlbS5ub2RlVHlwZSA9PT0gMSApIHsKCQkJLy8gVGhlc2UgYXR0cmlidXRlcyByZXF1aXJlIHNwZWNpYWwgdHJlYXRtZW50CgkJCXZhciBzcGVjaWFsID0gcnNwZWNpYWx1cmwudGVzdCggbmFtZSApOwoKCQkJLy8gU2FmYXJpIG1pcy1yZXBvcnRzIHRoZSBkZWZhdWx0IHNlbGVjdGVkIHByb3BlcnR5IG9mIGFuIG9wdGlvbgoJCQkvLyBBY2Nlc3NpbmcgdGhlIHBhcmVudCdzIHNlbGVjdGVkSW5kZXggcHJvcGVydHkgZml4ZXMgaXQKCQkJaWYgKCBuYW1lID09PSAic2VsZWN0ZWQiICYmICFqUXVlcnkuc3VwcG9ydC5vcHRTZWxlY3RlZCApIHsKCQkJCXZhciBwYXJlbnQgPSBlbGVtLnBhcmVudE5vZGU7CgkJCQlpZiAoIHBhcmVudCApIHsKCQkJCQlwYXJlbnQuc2VsZWN0ZWRJbmRleDsKCQoJCQkJCS8vIE1ha2Ugc3VyZSB0aGF0IGl0IGFsc28gd29ya3Mgd2l0aCBvcHRncm91cHMsIHNlZSAjNTcwMQoJCQkJCWlmICggcGFyZW50LnBhcmVudE5vZGUgKSB7CgkJCQkJCXBhcmVudC5wYXJlbnROb2RlLnNlbGVjdGVkSW5kZXg7CgkJCQkJfQoJCQkJfQoJCQl9CgoJCQkvLyBJZiBhcHBsaWNhYmxlLCBhY2Nlc3MgdGhlIGF0dHJpYnV0ZSB2aWEgdGhlIERPTSAwIHdheQoJCQlpZiAoIG5hbWUgaW4gZWxlbSAmJiBub3R4bWwgJiYgIXNwZWNpYWwgKSB7CgkJCQlpZiAoIHNldCApIHsKCQkJCQkvLyBXZSBjYW4ndCBhbGxvdyB0aGUgdHlwZSBwcm9wZXJ0eSB0byBiZSBjaGFuZ2VkIChzaW5jZSBpdCBjYXVzZXMgcHJvYmxlbXMgaW4gSUUpCgkJCQkJaWYgKCBuYW1lID09PSAidHlwZSIgJiYgcnR5cGUudGVzdCggZWxlbS5ub2RlTmFtZSApICYmIGVsZW0ucGFyZW50Tm9kZSApIHsKCQkJCQkJalF1ZXJ5LmVycm9yKCAidHlwZSBwcm9wZXJ0eSBjYW4ndCBiZSBjaGFuZ2VkIiApOwoJCQkJCX0KCgkJCQkJZWxlbVsgbmFtZSBdID0gdmFsdWU7CgkJCQl9CgoJCQkJLy8gYnJvd3NlcnMgaW5kZXggZWxlbWVudHMgYnkgaWQvbmFtZSBvbiBmb3JtcywgZ2l2ZSBwcmlvcml0eSB0byBhdHRyaWJ1dGVzLgoJCQkJaWYgKCBqUXVlcnkubm9kZU5hbWUoIGVsZW0sICJmb3JtIiApICYmIGVsZW0uZ2V0QXR0cmlidXRlTm9kZShuYW1lKSApIHsKCQkJCQlyZXR1cm4gZWxlbS5nZXRBdHRyaWJ1dGVOb2RlKCBuYW1lICkubm9kZVZhbHVlOwoJCQkJfQoKCQkJCS8vIGVsZW0udGFiSW5kZXggZG9lc24ndCBhbHdheXMgcmV0dXJuIHRoZSBjb3JyZWN0IHZhbHVlIHdoZW4gaXQgaGFzbid0IGJlZW4gZXhwbGljaXRseSBzZXQKCQkJCS8vIGh0dHA6Ly9mbHVpZHByb2plY3Qub3JnL2Jsb2cvMjAwOC8wMS8wOS9nZXR0aW5nLXNldHRpbmctYW5kLXJlbW92aW5nLXRhYmluZGV4LXZhbHVlcy13aXRoLWphdmFzY3JpcHQvCgkJCQlpZiAoIG5hbWUgPT09ICJ0YWJJbmRleCIgKSB7CgkJCQkJdmFyIGF0dHJpYnV0ZU5vZGUgPSBlbGVtLmdldEF0dHJpYnV0ZU5vZGUoICJ0YWJJbmRleCIgKTsKCgkJCQkJcmV0dXJuIGF0dHJpYnV0ZU5vZGUgJiYgYXR0cmlidXRlTm9kZS5zcGVjaWZpZWQgPwoJCQkJCQlhdHRyaWJ1dGVOb2RlLnZhbHVlIDoKCQkJCQkJcmZvY3VzYWJsZS50ZXN0KCBlbGVtLm5vZGVOYW1lICkgfHwgcmNsaWNrYWJsZS50ZXN0KCBlbGVtLm5vZGVOYW1lICkgJiYgZWxlbS5ocmVmID8KCQkJCQkJCTAgOgoJCQkJCQkJdW5kZWZpbmVkOwoJCQkJfQoKCQkJCXJldHVybiBlbGVtWyBuYW1lIF07CgkJCX0KCgkJCWlmICggIWpRdWVyeS5zdXBwb3J0LnN0eWxlICYmIG5vdHhtbCAmJiBuYW1lID09PSAic3R5bGUiICkgewoJCQkJaWYgKCBzZXQgKSB7CgkJCQkJZWxlbS5zdHlsZS5jc3NUZXh0ID0gIiIgKyB2YWx1ZTsKCQkJCX0KCgkJCQlyZXR1cm4gZWxlbS5zdHlsZS5jc3NUZXh0OwoJCQl9CgoJCQlpZiAoIHNldCApIHsKCQkJCS8vIGNvbnZlcnQgdGhlIHZhbHVlIHRvIGEgc3RyaW5nIChhbGwgYnJvd3NlcnMgZG8gdGhpcyBidXQgSUUpIHNlZSAjMTA3MAoJCQkJZWxlbS5zZXRBdHRyaWJ1dGUoIG5hbWUsICIiICsgdmFsdWUgKTsKCQkJfQoKCQkJdmFyIGF0dHIgPSAhalF1ZXJ5LnN1cHBvcnQuaHJlZk5vcm1hbGl6ZWQgJiYgbm90eG1sICYmIHNwZWNpYWwgPwoJCQkJCS8vIFNvbWUgYXR0cmlidXRlcyByZXF1aXJlIGEgc3BlY2lhbCBjYWxsIG9uIElFCgkJCQkJZWxlbS5nZXRBdHRyaWJ1dGUoIG5hbWUsIDIgKSA6CgkJCQkJZWxlbS5nZXRBdHRyaWJ1dGUoIG5hbWUgKTsKCgkJCS8vIE5vbi1leGlzdGVudCBhdHRyaWJ1dGVzIHJldHVybiBudWxsLCB3ZSBub3JtYWxpemUgdG8gdW5kZWZpbmVkCgkJCXJldHVybiBhdHRyID09PSBudWxsID8gdW5kZWZpbmVkIDogYXR0cjsKCQl9CgoJCS8vIGVsZW0gaXMgYWN0dWFsbHkgZWxlbS5zdHlsZSAuLi4gc2V0IHRoZSBzdHlsZQoJCS8vIFVzaW5nIGF0dHIgZm9yIHNwZWNpZmljIHN0eWxlIGluZm9ybWF0aW9uIGlzIG5vdyBkZXByZWNhdGVkLiBVc2Ugc3R5bGUgaW5zdGVhZC4KCQlyZXR1cm4galF1ZXJ5LnN0eWxlKCBlbGVtLCBuYW1lLCB2YWx1ZSApOwoJfQp9KTsKdmFyIHJuYW1lc3BhY2VzID0gL1wuKC4qKSQvLAoJZmNsZWFudXAgPSBmdW5jdGlvbiggbm0gKSB7CgkJcmV0dXJuIG5tLnJlcGxhY2UoL1teXHdcc1wuXHxgXS9nLCBmdW5jdGlvbiggY2ggKSB7CgkJCXJldHVybiAiXFwiICsgY2g7CgkJfSk7Cgl9OwoKLyoKICogQSBudW1iZXIgb2YgaGVscGVyIGZ1bmN0aW9ucyB1c2VkIGZvciBtYW5hZ2luZyBldmVudHMuCiAqIE1hbnkgb2YgdGhlIGlkZWFzIGJlaGluZCB0aGlzIGNvZGUgb3JpZ2luYXRlZCBmcm9tCiAqIERlYW4gRWR3YXJkcycgYWRkRXZlbnQgbGlicmFyeS4KICovCmpRdWVyeS5ldmVudCA9IHsKCgkvLyBCaW5kIGFuIGV2ZW50IHRvIGFuIGVsZW1lbnQKCS8vIE9yaWdpbmFsIGJ5IERlYW4gRWR3YXJkcwoJYWRkOiBmdW5jdGlvbiggZWxlbSwgdHlwZXMsIGhhbmRsZXIsIGRhdGEgKSB7CgkJaWYgKCBlbGVtLm5vZGVUeXBlID09PSAzIHx8IGVsZW0ubm9kZVR5cGUgPT09IDggKSB7CgkJCXJldHVybjsKCQl9CgoJCS8vIEZvciB3aGF0ZXZlciByZWFzb24sIElFIGhhcyB0cm91YmxlIHBhc3NpbmcgdGhlIHdpbmRvdyBvYmplY3QKCQkvLyBhcm91bmQsIGNhdXNpbmcgaXQgdG8gYmUgY2xvbmVkIGluIHRoZSBwcm9jZXNzCgkJaWYgKCBlbGVtLnNldEludGVydmFsICYmICggZWxlbSAhPT0gd2luZG93ICYmICFlbGVtLmZyYW1lRWxlbWVudCApICkgewoJCQllbGVtID0gd2luZG93OwoJCX0KCgkJdmFyIGhhbmRsZU9iakluLCBoYW5kbGVPYmo7CgoJCWlmICggaGFuZGxlci5oYW5kbGVyICkgewoJCQloYW5kbGVPYmpJbiA9IGhhbmRsZXI7CgkJCWhhbmRsZXIgPSBoYW5kbGVPYmpJbi5oYW5kbGVyOwoJCX0KCgkJLy8gTWFrZSBzdXJlIHRoYXQgdGhlIGZ1bmN0aW9uIGJlaW5nIGV4ZWN1dGVkIGhhcyBhIHVuaXF1ZSBJRAoJCWlmICggIWhhbmRsZXIuZ3VpZCApIHsKCQkJaGFuZGxlci5ndWlkID0galF1ZXJ5Lmd1aWQrKzsKCQl9CgoJCS8vIEluaXQgdGhlIGVsZW1lbnQncyBldmVudCBzdHJ1Y3R1cmUKCQl2YXIgZWxlbURhdGEgPSBqUXVlcnkuZGF0YSggZWxlbSApOwoKCQkvLyBJZiBubyBlbGVtRGF0YSBpcyBmb3VuZCB0aGVuIHdlIG11c3QgYmUgdHJ5aW5nIHRvIGJpbmQgdG8gb25lIG9mIHRoZQoJCS8vIGJhbm5lZCBub0RhdGEgZWxlbWVudHMKCQlpZiAoICFlbGVtRGF0YSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJdmFyIGV2ZW50cyA9IGVsZW1EYXRhLmV2ZW50cyA9IGVsZW1EYXRhLmV2ZW50cyB8fCB7fSwKCQkJZXZlbnRIYW5kbGUgPSBlbGVtRGF0YS5oYW5kbGUsIGV2ZW50SGFuZGxlOwoKCQlpZiAoICFldmVudEhhbmRsZSApIHsKCQkJZWxlbURhdGEuaGFuZGxlID0gZXZlbnRIYW5kbGUgPSBmdW5jdGlvbigpIHsKCQkJCS8vIEhhbmRsZSB0aGUgc2Vjb25kIGV2ZW50IG9mIGEgdHJpZ2dlciBhbmQgd2hlbgoJCQkJLy8gYW4gZXZlbnQgaXMgY2FsbGVkIGFmdGVyIGEgcGFnZSBoYXMgdW5sb2FkZWQKCQkJCXJldHVybiB0eXBlb2YgalF1ZXJ5ICE9PSAidW5kZWZpbmVkIiAmJiAhalF1ZXJ5LmV2ZW50LnRyaWdnZXJlZCA/CgkJCQkJalF1ZXJ5LmV2ZW50LmhhbmRsZS5hcHBseSggZXZlbnRIYW5kbGUuZWxlbSwgYXJndW1lbnRzICkgOgoJCQkJCXVuZGVmaW5lZDsKCQkJfTsKCQl9CgoJCS8vIEFkZCBlbGVtIGFzIGEgcHJvcGVydHkgb2YgdGhlIGhhbmRsZSBmdW5jdGlvbgoJCS8vIFRoaXMgaXMgdG8gcHJldmVudCBhIG1lbW9yeSBsZWFrIHdpdGggbm9uLW5hdGl2ZSBldmVudHMgaW4gSUUuCgkJZXZlbnRIYW5kbGUuZWxlbSA9IGVsZW07CgoJCS8vIEhhbmRsZSBtdWx0aXBsZSBldmVudHMgc2VwYXJhdGVkIGJ5IGEgc3BhY2UKCQkvLyBqUXVlcnkoLi4uKS5iaW5kKCJtb3VzZW92ZXIgbW91c2VvdXQiLCBmbik7CgkJdHlwZXMgPSB0eXBlcy5zcGxpdCgiICIpOwoKCQl2YXIgdHlwZSwgaSA9IDAsIG5hbWVzcGFjZXM7CgoJCXdoaWxlICggKHR5cGUgPSB0eXBlc1sgaSsrIF0pICkgewoJCQloYW5kbGVPYmogPSBoYW5kbGVPYmpJbiA/CgkJCQlqUXVlcnkuZXh0ZW5kKHt9LCBoYW5kbGVPYmpJbikgOgoJCQkJeyBoYW5kbGVyOiBoYW5kbGVyLCBkYXRhOiBkYXRhIH07CgoJCQkvLyBOYW1lc3BhY2VkIGV2ZW50IGhhbmRsZXJzCgkJCWlmICggdHlwZS5pbmRleE9mKCIuIikgPiAtMSApIHsKCQkJCW5hbWVzcGFjZXMgPSB0eXBlLnNwbGl0KCIuIik7CgkJCQl0eXBlID0gbmFtZXNwYWNlcy5zaGlmdCgpOwoJCQkJaGFuZGxlT2JqLm5hbWVzcGFjZSA9IG5hbWVzcGFjZXMuc2xpY2UoMCkuc29ydCgpLmpvaW4oIi4iKTsKCgkJCX0gZWxzZSB7CgkJCQluYW1lc3BhY2VzID0gW107CgkJCQloYW5kbGVPYmoubmFtZXNwYWNlID0gIiI7CgkJCX0KCgkJCWhhbmRsZU9iai50eXBlID0gdHlwZTsKCQkJaGFuZGxlT2JqLmd1aWQgPSBoYW5kbGVyLmd1aWQ7CgoJCQkvLyBHZXQgdGhlIGN1cnJlbnQgbGlzdCBvZiBmdW5jdGlvbnMgYm91bmQgdG8gdGhpcyBldmVudAoJCQl2YXIgaGFuZGxlcnMgPSBldmVudHNbIHR5cGUgXSwKCQkJCXNwZWNpYWwgPSBqUXVlcnkuZXZlbnQuc3BlY2lhbFsgdHlwZSBdIHx8IHt9OwoKCQkJLy8gSW5pdCB0aGUgZXZlbnQgaGFuZGxlciBxdWV1ZQoJCQlpZiAoICFoYW5kbGVycyApIHsKCQkJCWhhbmRsZXJzID0gZXZlbnRzWyB0eXBlIF0gPSBbXTsKCgkJCQkvLyBDaGVjayBmb3IgYSBzcGVjaWFsIGV2ZW50IGhhbmRsZXIKCQkJCS8vIE9ubHkgdXNlIGFkZEV2ZW50TGlzdGVuZXIvYXR0YWNoRXZlbnQgaWYgdGhlIHNwZWNpYWwKCQkJCS8vIGV2ZW50cyBoYW5kbGVyIHJldHVybnMgZmFsc2UKCQkJCWlmICggIXNwZWNpYWwuc2V0dXAgfHwgc3BlY2lhbC5zZXR1cC5jYWxsKCBlbGVtLCBkYXRhLCBuYW1lc3BhY2VzLCBldmVudEhhbmRsZSApID09PSBmYWxzZSApIHsKCQkJCQkvLyBCaW5kIHRoZSBnbG9iYWwgZXZlbnQgaGFuZGxlciB0byB0aGUgZWxlbWVudAoJCQkJCWlmICggZWxlbS5hZGRFdmVudExpc3RlbmVyICkgewoJCQkJCQllbGVtLmFkZEV2ZW50TGlzdGVuZXIoIHR5cGUsIGV2ZW50SGFuZGxlLCBmYWxzZSApOwoKCQkJCQl9IGVsc2UgaWYgKCBlbGVtLmF0dGFjaEV2ZW50ICkgewoJCQkJCQllbGVtLmF0dGFjaEV2ZW50KCAib24iICsgdHlwZSwgZXZlbnRIYW5kbGUgKTsKCQkJCQl9CgkJCQl9CgkJCX0KCQkJCgkJCWlmICggc3BlY2lhbC5hZGQgKSB7IAoJCQkJc3BlY2lhbC5hZGQuY2FsbCggZWxlbSwgaGFuZGxlT2JqICk7IAoKCQkJCWlmICggIWhhbmRsZU9iai5oYW5kbGVyLmd1aWQgKSB7CgkJCQkJaGFuZGxlT2JqLmhhbmRsZXIuZ3VpZCA9IGhhbmRsZXIuZ3VpZDsKCQkJCX0KCQkJfQoKCQkJLy8gQWRkIHRoZSBmdW5jdGlvbiB0byB0aGUgZWxlbWVudCdzIGhhbmRsZXIgbGlzdAoJCQloYW5kbGVycy5wdXNoKCBoYW5kbGVPYmogKTsKCgkJCS8vIEtlZXAgdHJhY2sgb2Ygd2hpY2ggZXZlbnRzIGhhdmUgYmVlbiB1c2VkLCBmb3IgZ2xvYmFsIHRyaWdnZXJpbmcKCQkJalF1ZXJ5LmV2ZW50Lmdsb2JhbFsgdHlwZSBdID0gdHJ1ZTsKCQl9CgoJCS8vIE51bGxpZnkgZWxlbSB0byBwcmV2ZW50IG1lbW9yeSBsZWFrcyBpbiBJRQoJCWVsZW0gPSBudWxsOwoJfSwKCglnbG9iYWw6IHt9LAoKCS8vIERldGFjaCBhbiBldmVudCBvciBzZXQgb2YgZXZlbnRzIGZyb20gYW4gZWxlbWVudAoJcmVtb3ZlOiBmdW5jdGlvbiggZWxlbSwgdHlwZXMsIGhhbmRsZXIsIHBvcyApIHsKCQkvLyBkb24ndCBkbyBldmVudHMgb24gdGV4dCBhbmQgY29tbWVudCBub2RlcwoJCWlmICggZWxlbS5ub2RlVHlwZSA9PT0gMyB8fCBlbGVtLm5vZGVUeXBlID09PSA4ICkgewoJCQlyZXR1cm47CgkJfQoKCQl2YXIgcmV0LCB0eXBlLCBmbiwgaSA9IDAsIGFsbCwgbmFtZXNwYWNlcywgbmFtZXNwYWNlLCBzcGVjaWFsLCBldmVudFR5cGUsIGhhbmRsZU9iaiwgb3JpZ1R5cGUsCgkJCWVsZW1EYXRhID0galF1ZXJ5LmRhdGEoIGVsZW0gKSwKCQkJZXZlbnRzID0gZWxlbURhdGEgJiYgZWxlbURhdGEuZXZlbnRzOwoKCQlpZiAoICFlbGVtRGF0YSB8fCAhZXZlbnRzICkgewoJCQlyZXR1cm47CgkJfQoKCQkvLyB0eXBlcyBpcyBhY3R1YWxseSBhbiBldmVudCBvYmplY3QgaGVyZQoJCWlmICggdHlwZXMgJiYgdHlwZXMudHlwZSApIHsKCQkJaGFuZGxlciA9IHR5cGVzLmhhbmRsZXI7CgkJCXR5cGVzID0gdHlwZXMudHlwZTsKCQl9CgoJCS8vIFVuYmluZCBhbGwgZXZlbnRzIGZvciB0aGUgZWxlbWVudAoJCWlmICggIXR5cGVzIHx8IHR5cGVvZiB0eXBlcyA9PT0gInN0cmluZyIgJiYgdHlwZXMuY2hhckF0KDApID09PSAiLiIgKSB7CgkJCXR5cGVzID0gdHlwZXMgfHwgIiI7CgoJCQlmb3IgKCB0eXBlIGluIGV2ZW50cyApIHsKCQkJCWpRdWVyeS5ldmVudC5yZW1vdmUoIGVsZW0sIHR5cGUgKyB0eXBlcyApOwoJCQl9CgoJCQlyZXR1cm47CgkJfQoKCQkvLyBIYW5kbGUgbXVsdGlwbGUgZXZlbnRzIHNlcGFyYXRlZCBieSBhIHNwYWNlCgkJLy8galF1ZXJ5KC4uLikudW5iaW5kKCJtb3VzZW92ZXIgbW91c2VvdXQiLCBmbik7CgkJdHlwZXMgPSB0eXBlcy5zcGxpdCgiICIpOwoKCQl3aGlsZSAoICh0eXBlID0gdHlwZXNbIGkrKyBdKSApIHsKCQkJb3JpZ1R5cGUgPSB0eXBlOwoJCQloYW5kbGVPYmogPSBudWxsOwoJCQlhbGwgPSB0eXBlLmluZGV4T2YoIi4iKSA8IDA7CgkJCW5hbWVzcGFjZXMgPSBbXTsKCgkJCWlmICggIWFsbCApIHsKCQkJCS8vIE5hbWVzcGFjZWQgZXZlbnQgaGFuZGxlcnMKCQkJCW5hbWVzcGFjZXMgPSB0eXBlLnNwbGl0KCIuIik7CgkJCQl0eXBlID0gbmFtZXNwYWNlcy5zaGlmdCgpOwoKCQkJCW5hbWVzcGFjZSA9IG5ldyBSZWdFeHAoIihefFxcLikiICsgCgkJCQkJalF1ZXJ5Lm1hcCggbmFtZXNwYWNlcy5zbGljZSgwKS5zb3J0KCksIGZjbGVhbnVwICkuam9pbigiXFwuKD86LipcXC4pPyIpICsgIihcXC58JCkiKQoJCQl9CgoJCQlldmVudFR5cGUgPSBldmVudHNbIHR5cGUgXTsKCgkJCWlmICggIWV2ZW50VHlwZSApIHsKCQkJCWNvbnRpbnVlOwoJCQl9CgoJCQlpZiAoICFoYW5kbGVyICkgewoJCQkJZm9yICggdmFyIGogPSAwOyBqIDwgZXZlbnRUeXBlLmxlbmd0aDsgaisrICkgewoJCQkJCWhhbmRsZU9iaiA9IGV2ZW50VHlwZVsgaiBdOwoKCQkJCQlpZiAoIGFsbCB8fCBuYW1lc3BhY2UudGVzdCggaGFuZGxlT2JqLm5hbWVzcGFjZSApICkgewoJCQkJCQlqUXVlcnkuZXZlbnQucmVtb3ZlKCBlbGVtLCBvcmlnVHlwZSwgaGFuZGxlT2JqLmhhbmRsZXIsIGogKTsKCQkJCQkJZXZlbnRUeXBlLnNwbGljZSggai0tLCAxICk7CgkJCQkJfQoJCQkJfQoKCQkJCWNvbnRpbnVlOwoJCQl9CgoJCQlzcGVjaWFsID0galF1ZXJ5LmV2ZW50LnNwZWNpYWxbIHR5cGUgXSB8fCB7fTsKCgkJCWZvciAoIHZhciBqID0gcG9zIHx8IDA7IGogPCBldmVudFR5cGUubGVuZ3RoOyBqKysgKSB7CgkJCQloYW5kbGVPYmogPSBldmVudFR5cGVbIGogXTsKCgkJCQlpZiAoIGhhbmRsZXIuZ3VpZCA9PT0gaGFuZGxlT2JqLmd1aWQgKSB7CgkJCQkJLy8gcmVtb3ZlIHRoZSBnaXZlbiBoYW5kbGVyIGZvciB0aGUgZ2l2ZW4gdHlwZQoJCQkJCWlmICggYWxsIHx8IG5hbWVzcGFjZS50ZXN0KCBoYW5kbGVPYmoubmFtZXNwYWNlICkgKSB7CgkJCQkJCWlmICggcG9zID09IG51bGwgKSB7CgkJCQkJCQlldmVudFR5cGUuc3BsaWNlKCBqLS0sIDEgKTsKCQkJCQkJfQoKCQkJCQkJaWYgKCBzcGVjaWFsLnJlbW92ZSApIHsKCQkJCQkJCXNwZWNpYWwucmVtb3ZlLmNhbGwoIGVsZW0sIGhhbmRsZU9iaiApOwoJCQkJCQl9CgkJCQkJfQoKCQkJCQlpZiAoIHBvcyAhPSBudWxsICkgewoJCQkJCQlicmVhazsKCQkJCQl9CgkJCQl9CgkJCX0KCgkJCS8vIHJlbW92ZSBnZW5lcmljIGV2ZW50IGhhbmRsZXIgaWYgbm8gbW9yZSBoYW5kbGVycyBleGlzdAoJCQlpZiAoIGV2ZW50VHlwZS5sZW5ndGggPT09IDAgfHwgcG9zICE9IG51bGwgJiYgZXZlbnRUeXBlLmxlbmd0aCA9PT0gMSApIHsKCQkJCWlmICggIXNwZWNpYWwudGVhcmRvd24gfHwgc3BlY2lhbC50ZWFyZG93bi5jYWxsKCBlbGVtLCBuYW1lc3BhY2VzICkgPT09IGZhbHNlICkgewoJCQkJCXJlbW92ZUV2ZW50KCBlbGVtLCB0eXBlLCBlbGVtRGF0YS5oYW5kbGUgKTsKCQkJCX0KCgkJCQlyZXQgPSBudWxsOwoJCQkJZGVsZXRlIGV2ZW50c1sgdHlwZSBdOwoJCQl9CgkJfQoKCQkvLyBSZW1vdmUgdGhlIGV4cGFuZG8gaWYgaXQncyBubyBsb25nZXIgdXNlZAoJCWlmICggalF1ZXJ5LmlzRW1wdHlPYmplY3QoIGV2ZW50cyApICkgewoJCQl2YXIgaGFuZGxlID0gZWxlbURhdGEuaGFuZGxlOwoJCQlpZiAoIGhhbmRsZSApIHsKCQkJCWhhbmRsZS5lbGVtID0gbnVsbDsKCQkJfQoKCQkJZGVsZXRlIGVsZW1EYXRhLmV2ZW50czsKCQkJZGVsZXRlIGVsZW1EYXRhLmhhbmRsZTsKCgkJCWlmICggalF1ZXJ5LmlzRW1wdHlPYmplY3QoIGVsZW1EYXRhICkgKSB7CgkJCQlqUXVlcnkucmVtb3ZlRGF0YSggZWxlbSApOwoJCQl9CgkJfQoJfSwKCgkvLyBidWJibGluZyBpcyBpbnRlcm5hbAoJdHJpZ2dlcjogZnVuY3Rpb24oIGV2ZW50LCBkYXRhLCBlbGVtIC8qLCBidWJibGluZyAqLyApIHsKCQkvLyBFdmVudCBvYmplY3Qgb3IgZXZlbnQgdHlwZQoJCXZhciB0eXBlID0gZXZlbnQudHlwZSB8fCBldmVudCwKCQkJYnViYmxpbmcgPSBhcmd1bWVudHNbM107CgoJCWlmICggIWJ1YmJsaW5nICkgewoJCQlldmVudCA9IHR5cGVvZiBldmVudCA9PT0gIm9iamVjdCIgPwoJCQkJLy8galF1ZXJ5LkV2ZW50IG9iamVjdAoJCQkJZXZlbnRbZXhwYW5kb10gPyBldmVudCA6CgkJCQkvLyBPYmplY3QgbGl0ZXJhbAoJCQkJalF1ZXJ5LmV4dGVuZCggalF1ZXJ5LkV2ZW50KHR5cGUpLCBldmVudCApIDoKCQkJCS8vIEp1c3QgdGhlIGV2ZW50IHR5cGUgKHN0cmluZykKCQkJCWpRdWVyeS5FdmVudCh0eXBlKTsKCgkJCWlmICggdHlwZS5pbmRleE9mKCIhIikgPj0gMCApIHsKCQkJCWV2ZW50LnR5cGUgPSB0eXBlID0gdHlwZS5zbGljZSgwLCAtMSk7CgkJCQlldmVudC5leGNsdXNpdmUgPSB0cnVlOwoJCQl9CgoJCQkvLyBIYW5kbGUgYSBnbG9iYWwgdHJpZ2dlcgoJCQlpZiAoICFlbGVtICkgewoJCQkJLy8gRG9uJ3QgYnViYmxlIGN1c3RvbSBldmVudHMgd2hlbiBnbG9iYWwgKHRvIGF2b2lkIHRvbyBtdWNoIG92ZXJoZWFkKQoJCQkJZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7CgoJCQkJLy8gT25seSB0cmlnZ2VyIGlmIHdlJ3ZlIGV2ZXIgYm91bmQgYW4gZXZlbnQgZm9yIGl0CgkJCQlpZiAoIGpRdWVyeS5ldmVudC5nbG9iYWxbIHR5cGUgXSApIHsKCQkJCQlqUXVlcnkuZWFjaCggalF1ZXJ5LmNhY2hlLCBmdW5jdGlvbigpIHsKCQkJCQkJaWYgKCB0aGlzLmV2ZW50cyAmJiB0aGlzLmV2ZW50c1t0eXBlXSApIHsKCQkJCQkJCWpRdWVyeS5ldmVudC50cmlnZ2VyKCBldmVudCwgZGF0YSwgdGhpcy5oYW5kbGUuZWxlbSApOwoJCQkJCQl9CgkJCQkJfSk7CgkJCQl9CgkJCX0KCgkJCS8vIEhhbmRsZSB0cmlnZ2VyaW5nIGEgc2luZ2xlIGVsZW1lbnQKCgkJCS8vIGRvbid0IGRvIGV2ZW50cyBvbiB0ZXh0IGFuZCBjb21tZW50IG5vZGVzCgkJCWlmICggIWVsZW0gfHwgZWxlbS5ub2RlVHlwZSA9PT0gMyB8fCBlbGVtLm5vZGVUeXBlID09PSA4ICkgewoJCQkJcmV0dXJuIHVuZGVmaW5lZDsKCQkJfQoKCQkJLy8gQ2xlYW4gdXAgaW4gY2FzZSBpdCBpcyByZXVzZWQKCQkJZXZlbnQucmVzdWx0ID0gdW5kZWZpbmVkOwoJCQlldmVudC50YXJnZXQgPSBlbGVtOwoKCQkJLy8gQ2xvbmUgdGhlIGluY29taW5nIGRhdGEsIGlmIGFueQoJCQlkYXRhID0galF1ZXJ5Lm1ha2VBcnJheSggZGF0YSApOwoJCQlkYXRhLnVuc2hpZnQoIGV2ZW50ICk7CgkJfQoKCQlldmVudC5jdXJyZW50VGFyZ2V0ID0gZWxlbTsKCgkJLy8gVHJpZ2dlciB0aGUgZXZlbnQsIGl0IGlzIGFzc3VtZWQgdGhhdCAiaGFuZGxlIiBpcyBhIGZ1bmN0aW9uCgkJdmFyIGhhbmRsZSA9IGpRdWVyeS5kYXRhKCBlbGVtLCAiaGFuZGxlIiApOwoJCWlmICggaGFuZGxlICkgewoJCQloYW5kbGUuYXBwbHkoIGVsZW0sIGRhdGEgKTsKCQl9CgoJCXZhciBwYXJlbnQgPSBlbGVtLnBhcmVudE5vZGUgfHwgZWxlbS5vd25lckRvY3VtZW50OwoKCQkvLyBUcmlnZ2VyIGFuIGlubGluZSBib3VuZCBzY3JpcHQKCQl0cnkgewoJCQlpZiAoICEoZWxlbSAmJiBlbGVtLm5vZGVOYW1lICYmIGpRdWVyeS5ub0RhdGFbZWxlbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpXSkgKSB7CgkJCQlpZiAoIGVsZW1bICJvbiIgKyB0eXBlIF0gJiYgZWxlbVsgIm9uIiArIHR5cGUgXS5hcHBseSggZWxlbSwgZGF0YSApID09PSBmYWxzZSApIHsKCQkJCQlldmVudC5yZXN1bHQgPSBmYWxzZTsKCQkJCX0KCQkJfQoKCQkvLyBwcmV2ZW50IElFIGZyb20gdGhyb3dpbmcgYW4gZXJyb3IgZm9yIHNvbWUgZWxlbWVudHMgd2l0aCBzb21lIGV2ZW50IHR5cGVzLCBzZWUgIzM1MzMKCQl9IGNhdGNoIChlKSB7fQoKCQlpZiAoICFldmVudC5pc1Byb3BhZ2F0aW9uU3RvcHBlZCgpICYmIHBhcmVudCApIHsKCQkJalF1ZXJ5LmV2ZW50LnRyaWdnZXIoIGV2ZW50LCBkYXRhLCBwYXJlbnQsIHRydWUgKTsKCgkJfSBlbHNlIGlmICggIWV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoJCQl2YXIgdGFyZ2V0ID0gZXZlbnQudGFyZ2V0LCBvbGQsCgkJCQlpc0NsaWNrID0galF1ZXJ5Lm5vZGVOYW1lKHRhcmdldCwgImEiKSAmJiB0eXBlID09PSAiY2xpY2siLAoJCQkJc3BlY2lhbCA9IGpRdWVyeS5ldmVudC5zcGVjaWFsWyB0eXBlIF0gfHwge307CgoJCQlpZiAoICghc3BlY2lhbC5fZGVmYXVsdCB8fCBzcGVjaWFsLl9kZWZhdWx0LmNhbGwoIGVsZW0sIGV2ZW50ICkgPT09IGZhbHNlKSAmJiAKCQkJCSFpc0NsaWNrICYmICEodGFyZ2V0ICYmIHRhcmdldC5ub2RlTmFtZSAmJiBqUXVlcnkubm9EYXRhW3RhcmdldC5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpXSkgKSB7CgoJCQkJdHJ5IHsKCQkJCQlpZiAoIHRhcmdldFsgdHlwZSBdICkgewoJCQkJCQkvLyBNYWtlIHN1cmUgdGhhdCB3ZSBkb24ndCBhY2NpZGVudGFsbHkgcmUtdHJpZ2dlciB0aGUgb25GT08gZXZlbnRzCgkJCQkJCW9sZCA9IHRhcmdldFsgIm9uIiArIHR5cGUgXTsKCgkJCQkJCWlmICggb2xkICkgewoJCQkJCQkJdGFyZ2V0WyAib24iICsgdHlwZSBdID0gbnVsbDsKCQkJCQkJfQoKCQkJCQkJalF1ZXJ5LmV2ZW50LnRyaWdnZXJlZCA9IHRydWU7CgkJCQkJCXRhcmdldFsgdHlwZSBdKCk7CgkJCQkJfQoKCQkJCS8vIHByZXZlbnQgSUUgZnJvbSB0aHJvd2luZyBhbiBlcnJvciBmb3Igc29tZSBlbGVtZW50cyB3aXRoIHNvbWUgZXZlbnQgdHlwZXMsIHNlZSAjMzUzMwoJCQkJfSBjYXRjaCAoZSkge30KCgkJCQlpZiAoIG9sZCApIHsKCQkJCQl0YXJnZXRbICJvbiIgKyB0eXBlIF0gPSBvbGQ7CgkJCQl9CgoJCQkJalF1ZXJ5LmV2ZW50LnRyaWdnZXJlZCA9IGZhbHNlOwoJCQl9CgkJfQoJfSwKCgloYW5kbGU6IGZ1bmN0aW9uKCBldmVudCApIHsKCQl2YXIgYWxsLCBoYW5kbGVycywgbmFtZXNwYWNlcywgbmFtZXNwYWNlLCBldmVudHM7CgoJCWV2ZW50ID0gYXJndW1lbnRzWzBdID0galF1ZXJ5LmV2ZW50LmZpeCggZXZlbnQgfHwgd2luZG93LmV2ZW50ICk7CgkJZXZlbnQuY3VycmVudFRhcmdldCA9IHRoaXM7CgoJCS8vIE5hbWVzcGFjZWQgZXZlbnQgaGFuZGxlcnMKCQlhbGwgPSBldmVudC50eXBlLmluZGV4T2YoIi4iKSA8IDAgJiYgIWV2ZW50LmV4Y2x1c2l2ZTsKCgkJaWYgKCAhYWxsICkgewoJCQluYW1lc3BhY2VzID0gZXZlbnQudHlwZS5zcGxpdCgiLiIpOwoJCQlldmVudC50eXBlID0gbmFtZXNwYWNlcy5zaGlmdCgpOwoJCQluYW1lc3BhY2UgPSBuZXcgUmVnRXhwKCIoXnxcXC4pIiArIG5hbWVzcGFjZXMuc2xpY2UoMCkuc29ydCgpLmpvaW4oIlxcLig/Oi4qXFwuKT8iKSArICIoXFwufCQpIik7CgkJfQoKCQl2YXIgZXZlbnRzID0galF1ZXJ5LmRhdGEodGhpcywgImV2ZW50cyIpLCBoYW5kbGVycyA9IGV2ZW50c1sgZXZlbnQudHlwZSBdOwoKCQlpZiAoIGV2ZW50cyAmJiBoYW5kbGVycyApIHsKCQkJLy8gQ2xvbmUgdGhlIGhhbmRsZXJzIHRvIHByZXZlbnQgbWFuaXB1bGF0aW9uCgkJCWhhbmRsZXJzID0gaGFuZGxlcnMuc2xpY2UoMCk7CgoJCQlmb3IgKCB2YXIgaiA9IDAsIGwgPSBoYW5kbGVycy5sZW5ndGg7IGogPCBsOyBqKysgKSB7CgkJCQl2YXIgaGFuZGxlT2JqID0gaGFuZGxlcnNbIGogXTsKCgkJCQkvLyBGaWx0ZXIgdGhlIGZ1bmN0aW9ucyBieSBjbGFzcwoJCQkJaWYgKCBhbGwgfHwgbmFtZXNwYWNlLnRlc3QoIGhhbmRsZU9iai5uYW1lc3BhY2UgKSApIHsKCQkJCQkvLyBQYXNzIGluIGEgcmVmZXJlbmNlIHRvIHRoZSBoYW5kbGVyIGZ1bmN0aW9uIGl0c2VsZgoJCQkJCS8vIFNvIHRoYXQgd2UgY2FuIGxhdGVyIHJlbW92ZSBpdAoJCQkJCWV2ZW50LmhhbmRsZXIgPSBoYW5kbGVPYmouaGFuZGxlcjsKCQkJCQlldmVudC5kYXRhID0gaGFuZGxlT2JqLmRhdGE7CgkJCQkJZXZlbnQuaGFuZGxlT2JqID0gaGFuZGxlT2JqOwoJCgkJCQkJdmFyIHJldCA9IGhhbmRsZU9iai5oYW5kbGVyLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsKCgkJCQkJaWYgKCByZXQgIT09IHVuZGVmaW5lZCApIHsKCQkJCQkJZXZlbnQucmVzdWx0ID0gcmV0OwoJCQkJCQlpZiAoIHJldCA9PT0gZmFsc2UgKSB7CgkJCQkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJCQkJZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7CgkJCQkJCX0KCQkJCQl9CgoJCQkJCWlmICggZXZlbnQuaXNJbW1lZGlhdGVQcm9wYWdhdGlvblN0b3BwZWQoKSApIHsKCQkJCQkJYnJlYWs7CgkJCQkJfQoJCQkJfQoJCQl9CgkJfQoKCQlyZXR1cm4gZXZlbnQucmVzdWx0OwoJfSwKCglwcm9wczogImFsdEtleSBhdHRyQ2hhbmdlIGF0dHJOYW1lIGJ1YmJsZXMgYnV0dG9uIGNhbmNlbGFibGUgY2hhckNvZGUgY2xpZW50WCBjbGllbnRZIGN0cmxLZXkgY3VycmVudFRhcmdldCBkYXRhIGRldGFpbCBldmVudFBoYXNlIGZyb21FbGVtZW50IGhhbmRsZXIga2V5Q29kZSBsYXllclggbGF5ZXJZIG1ldGFLZXkgbmV3VmFsdWUgb2Zmc2V0WCBvZmZzZXRZIG9yaWdpbmFsVGFyZ2V0IHBhZ2VYIHBhZ2VZIHByZXZWYWx1ZSByZWxhdGVkTm9kZSByZWxhdGVkVGFyZ2V0IHNjcmVlblggc2NyZWVuWSBzaGlmdEtleSBzcmNFbGVtZW50IHRhcmdldCB0b0VsZW1lbnQgdmlldyB3aGVlbERlbHRhIHdoaWNoIi5zcGxpdCgiICIpLAoKCWZpeDogZnVuY3Rpb24oIGV2ZW50ICkgewoJCWlmICggZXZlbnRbIGV4cGFuZG8gXSApIHsKCQkJcmV0dXJuIGV2ZW50OwoJCX0KCgkJLy8gc3RvcmUgYSBjb3B5IG9mIHRoZSBvcmlnaW5hbCBldmVudCBvYmplY3QKCQkvLyBhbmQgImNsb25lIiB0byBzZXQgcmVhZC1vbmx5IHByb3BlcnRpZXMKCQl2YXIgb3JpZ2luYWxFdmVudCA9IGV2ZW50OwoJCWV2ZW50ID0galF1ZXJ5LkV2ZW50KCBvcmlnaW5hbEV2ZW50ICk7CgoJCWZvciAoIHZhciBpID0gdGhpcy5wcm9wcy5sZW5ndGgsIHByb3A7IGk7ICkgewoJCQlwcm9wID0gdGhpcy5wcm9wc1sgLS1pIF07CgkJCWV2ZW50WyBwcm9wIF0gPSBvcmlnaW5hbEV2ZW50WyBwcm9wIF07CgkJfQoKCQkvLyBGaXggdGFyZ2V0IHByb3BlcnR5LCBpZiBuZWNlc3NhcnkKCQlpZiAoICFldmVudC50YXJnZXQgKSB7CgkJCWV2ZW50LnRhcmdldCA9IGV2ZW50LnNyY0VsZW1lbnQgfHwgZG9jdW1lbnQ7IC8vIEZpeGVzICMxOTI1IHdoZXJlIHNyY0VsZW1lbnQgbWlnaHQgbm90IGJlIGRlZmluZWQgZWl0aGVyCgkJfQoKCQkvLyBjaGVjayBpZiB0YXJnZXQgaXMgYSB0ZXh0bm9kZSAoc2FmYXJpKQoJCWlmICggZXZlbnQudGFyZ2V0Lm5vZGVUeXBlID09PSAzICkgewoJCQlldmVudC50YXJnZXQgPSBldmVudC50YXJnZXQucGFyZW50Tm9kZTsKCQl9CgoJCS8vIEFkZCByZWxhdGVkVGFyZ2V0LCBpZiBuZWNlc3NhcnkKCQlpZiAoICFldmVudC5yZWxhdGVkVGFyZ2V0ICYmIGV2ZW50LmZyb21FbGVtZW50ICkgewoJCQlldmVudC5yZWxhdGVkVGFyZ2V0ID0gZXZlbnQuZnJvbUVsZW1lbnQgPT09IGV2ZW50LnRhcmdldCA/IGV2ZW50LnRvRWxlbWVudCA6IGV2ZW50LmZyb21FbGVtZW50OwoJCX0KCgkJLy8gQ2FsY3VsYXRlIHBhZ2VYL1kgaWYgbWlzc2luZyBhbmQgY2xpZW50WC9ZIGF2YWlsYWJsZQoJCWlmICggZXZlbnQucGFnZVggPT0gbnVsbCAmJiBldmVudC5jbGllbnRYICE9IG51bGwgKSB7CgkJCXZhciBkb2MgPSBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQsIGJvZHkgPSBkb2N1bWVudC5ib2R5OwoJCQlldmVudC5wYWdlWCA9IGV2ZW50LmNsaWVudFggKyAoZG9jICYmIGRvYy5zY3JvbGxMZWZ0IHx8IGJvZHkgJiYgYm9keS5zY3JvbGxMZWZ0IHx8IDApIC0gKGRvYyAmJiBkb2MuY2xpZW50TGVmdCB8fCBib2R5ICYmIGJvZHkuY2xpZW50TGVmdCB8fCAwKTsKCQkJZXZlbnQucGFnZVkgPSBldmVudC5jbGllbnRZICsgKGRvYyAmJiBkb2Muc2Nyb2xsVG9wICB8fCBib2R5ICYmIGJvZHkuc2Nyb2xsVG9wICB8fCAwKSAtIChkb2MgJiYgZG9jLmNsaWVudFRvcCAgfHwgYm9keSAmJiBib2R5LmNsaWVudFRvcCAgfHwgMCk7CgkJfQoKCQkvLyBBZGQgd2hpY2ggZm9yIGtleSBldmVudHMKCQlpZiAoICFldmVudC53aGljaCAmJiAoKGV2ZW50LmNoYXJDb2RlIHx8IGV2ZW50LmNoYXJDb2RlID09PSAwKSA/IGV2ZW50LmNoYXJDb2RlIDogZXZlbnQua2V5Q29kZSkgKSB7CgkJCWV2ZW50LndoaWNoID0gZXZlbnQuY2hhckNvZGUgfHwgZXZlbnQua2V5Q29kZTsKCQl9CgoJCS8vIEFkZCBtZXRhS2V5IHRvIG5vbi1NYWMgYnJvd3NlcnMgKHVzZSBjdHJsIGZvciBQQydzIGFuZCBNZXRhIGZvciBNYWNzKQoJCWlmICggIWV2ZW50Lm1ldGFLZXkgJiYgZXZlbnQuY3RybEtleSApIHsKCQkJZXZlbnQubWV0YUtleSA9IGV2ZW50LmN0cmxLZXk7CgkJfQoKCQkvLyBBZGQgd2hpY2ggZm9yIGNsaWNrOiAxID09PSBsZWZ0OyAyID09PSBtaWRkbGU7IDMgPT09IHJpZ2h0CgkJLy8gTm90ZTogYnV0dG9uIGlzIG5vdCBub3JtYWxpemVkLCBzbyBkb24ndCB1c2UgaXQKCQlpZiAoICFldmVudC53aGljaCAmJiBldmVudC5idXR0b24gIT09IHVuZGVmaW5lZCApIHsKCQkJZXZlbnQud2hpY2ggPSAoZXZlbnQuYnV0dG9uICYgMSA/IDEgOiAoIGV2ZW50LmJ1dHRvbiAmIDIgPyAzIDogKCBldmVudC5idXR0b24gJiA0ID8gMiA6IDAgKSApKTsKCQl9CgoJCXJldHVybiBldmVudDsKCX0sCgoJLy8gRGVwcmVjYXRlZCwgdXNlIGpRdWVyeS5ndWlkIGluc3RlYWQKCWd1aWQ6IDFFOCwKCgkvLyBEZXByZWNhdGVkLCB1c2UgalF1ZXJ5LnByb3h5IGluc3RlYWQKCXByb3h5OiBqUXVlcnkucHJveHksCgoJc3BlY2lhbDogewoJCXJlYWR5OiB7CgkJCS8vIE1ha2Ugc3VyZSB0aGUgcmVhZHkgZXZlbnQgaXMgc2V0dXAKCQkJc2V0dXA6IGpRdWVyeS5iaW5kUmVhZHksCgkJCXRlYXJkb3duOiBqUXVlcnkubm9vcAoJCX0sCgoJCWxpdmU6IHsKCQkJYWRkOiBmdW5jdGlvbiggaGFuZGxlT2JqICkgewoJCQkJalF1ZXJ5LmV2ZW50LmFkZCggdGhpcywgaGFuZGxlT2JqLm9yaWdUeXBlLCBqUXVlcnkuZXh0ZW5kKHt9LCBoYW5kbGVPYmosIHtoYW5kbGVyOiBsaXZlSGFuZGxlcn0pICk7IAoJCQl9LAoKCQkJcmVtb3ZlOiBmdW5jdGlvbiggaGFuZGxlT2JqICkgewoJCQkJdmFyIHJlbW92ZSA9IHRydWUsCgkJCQkJdHlwZSA9IGhhbmRsZU9iai5vcmlnVHlwZS5yZXBsYWNlKHJuYW1lc3BhY2VzLCAiIik7CgkJCQkKCQkJCWpRdWVyeS5lYWNoKCBqUXVlcnkuZGF0YSh0aGlzLCAiZXZlbnRzIikubGl2ZSB8fCBbXSwgZnVuY3Rpb24oKSB7CgkJCQkJaWYgKCB0eXBlID09PSB0aGlzLm9yaWdUeXBlLnJlcGxhY2Uocm5hbWVzcGFjZXMsICIiKSApIHsKCQkJCQkJcmVtb3ZlID0gZmFsc2U7CgkJCQkJCXJldHVybiBmYWxzZTsKCQkJCQl9CgkJCQl9KTsKCgkJCQlpZiAoIHJlbW92ZSApIHsKCQkJCQlqUXVlcnkuZXZlbnQucmVtb3ZlKCB0aGlzLCBoYW5kbGVPYmoub3JpZ1R5cGUsIGxpdmVIYW5kbGVyICk7CgkJCQl9CgkJCX0KCgkJfSwKCgkJYmVmb3JldW5sb2FkOiB7CgkJCXNldHVwOiBmdW5jdGlvbiggZGF0YSwgbmFtZXNwYWNlcywgZXZlbnRIYW5kbGUgKSB7CgkJCQkvLyBXZSBvbmx5IHdhbnQgdG8gZG8gdGhpcyBzcGVjaWFsIGNhc2Ugb24gd2luZG93cwoJCQkJaWYgKCB0aGlzLnNldEludGVydmFsICkgewoJCQkJCXRoaXMub25iZWZvcmV1bmxvYWQgPSBldmVudEhhbmRsZTsKCQkJCX0KCgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0sCgkJCXRlYXJkb3duOiBmdW5jdGlvbiggbmFtZXNwYWNlcywgZXZlbnRIYW5kbGUgKSB7CgkJCQlpZiAoIHRoaXMub25iZWZvcmV1bmxvYWQgPT09IGV2ZW50SGFuZGxlICkgewoJCQkJCXRoaXMub25iZWZvcmV1bmxvYWQgPSBudWxsOwoJCQkJfQoJCQl9CgkJfQoJfQp9OwoKdmFyIHJlbW92ZUV2ZW50ID0gZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lciA/CglmdW5jdGlvbiggZWxlbSwgdHlwZSwgaGFuZGxlICkgewoJCWVsZW0ucmVtb3ZlRXZlbnRMaXN0ZW5lciggdHlwZSwgaGFuZGxlLCBmYWxzZSApOwoJfSA6IAoJZnVuY3Rpb24oIGVsZW0sIHR5cGUsIGhhbmRsZSApIHsKCQllbGVtLmRldGFjaEV2ZW50KCAib24iICsgdHlwZSwgaGFuZGxlICk7Cgl9OwoKalF1ZXJ5LkV2ZW50ID0gZnVuY3Rpb24oIHNyYyApIHsKCS8vIEFsbG93IGluc3RhbnRpYXRpb24gd2l0aG91dCB0aGUgJ25ldycga2V5d29yZAoJaWYgKCAhdGhpcy5wcmV2ZW50RGVmYXVsdCApIHsKCQlyZXR1cm4gbmV3IGpRdWVyeS5FdmVudCggc3JjICk7Cgl9CgoJLy8gRXZlbnQgb2JqZWN0CglpZiAoIHNyYyAmJiBzcmMudHlwZSApIHsKCQl0aGlzLm9yaWdpbmFsRXZlbnQgPSBzcmM7CgkJdGhpcy50eXBlID0gc3JjLnR5cGU7CgkvLyBFdmVudCB0eXBlCgl9IGVsc2UgewoJCXRoaXMudHlwZSA9IHNyYzsKCX0KCgkvLyB0aW1lU3RhbXAgaXMgYnVnZ3kgZm9yIHNvbWUgZXZlbnRzIG9uIEZpcmVmb3goIzM4NDMpCgkvLyBTbyB3ZSB3b24ndCByZWx5IG9uIHRoZSBuYXRpdmUgdmFsdWUKCXRoaXMudGltZVN0YW1wID0gbm93KCk7CgoJLy8gTWFyayBpdCBhcyBmaXhlZAoJdGhpc1sgZXhwYW5kbyBdID0gdHJ1ZTsKfTsKCmZ1bmN0aW9uIHJldHVybkZhbHNlKCkgewoJcmV0dXJuIGZhbHNlOwp9CmZ1bmN0aW9uIHJldHVyblRydWUoKSB7CglyZXR1cm4gdHJ1ZTsKfQoKLy8galF1ZXJ5LkV2ZW50IGlzIGJhc2VkIG9uIERPTTMgRXZlbnRzIGFzIHNwZWNpZmllZCBieSB0aGUgRUNNQVNjcmlwdCBMYW5ndWFnZSBCaW5kaW5nCi8vIGh0dHA6Ly93d3cudzMub3JnL1RSLzIwMDMvV0QtRE9NLUxldmVsLTMtRXZlbnRzLTIwMDMwMzMxL2VjbWEtc2NyaXB0LWJpbmRpbmcuaHRtbApqUXVlcnkuRXZlbnQucHJvdG90eXBlID0gewoJcHJldmVudERlZmF1bHQ6IGZ1bmN0aW9uKCkgewoJCXRoaXMuaXNEZWZhdWx0UHJldmVudGVkID0gcmV0dXJuVHJ1ZTsKCgkJdmFyIGUgPSB0aGlzLm9yaWdpbmFsRXZlbnQ7CgkJaWYgKCAhZSApIHsKCQkJcmV0dXJuOwoJCX0KCQkKCQkvLyBpZiBwcmV2ZW50RGVmYXVsdCBleGlzdHMgcnVuIGl0IG9uIHRoZSBvcmlnaW5hbCBldmVudAoJCWlmICggZS5wcmV2ZW50RGVmYXVsdCApIHsKCQkJZS5wcmV2ZW50RGVmYXVsdCgpOwoJCX0KCQkvLyBvdGhlcndpc2Ugc2V0IHRoZSByZXR1cm5WYWx1ZSBwcm9wZXJ0eSBvZiB0aGUgb3JpZ2luYWwgZXZlbnQgdG8gZmFsc2UgKElFKQoJCWUucmV0dXJuVmFsdWUgPSBmYWxzZTsKCX0sCglzdG9wUHJvcGFnYXRpb246IGZ1bmN0aW9uKCkgewoJCXRoaXMuaXNQcm9wYWdhdGlvblN0b3BwZWQgPSByZXR1cm5UcnVlOwoKCQl2YXIgZSA9IHRoaXMub3JpZ2luYWxFdmVudDsKCQlpZiAoICFlICkgewoJCQlyZXR1cm47CgkJfQoJCS8vIGlmIHN0b3BQcm9wYWdhdGlvbiBleGlzdHMgcnVuIGl0IG9uIHRoZSBvcmlnaW5hbCBldmVudAoJCWlmICggZS5zdG9wUHJvcGFnYXRpb24gKSB7CgkJCWUuc3RvcFByb3BhZ2F0aW9uKCk7CgkJfQoJCS8vIG90aGVyd2lzZSBzZXQgdGhlIGNhbmNlbEJ1YmJsZSBwcm9wZXJ0eSBvZiB0aGUgb3JpZ2luYWwgZXZlbnQgdG8gdHJ1ZSAoSUUpCgkJZS5jYW5jZWxCdWJibGUgPSB0cnVlOwoJfSwKCXN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbjogZnVuY3Rpb24oKSB7CgkJdGhpcy5pc0ltbWVkaWF0ZVByb3BhZ2F0aW9uU3RvcHBlZCA9IHJldHVyblRydWU7CgkJdGhpcy5zdG9wUHJvcGFnYXRpb24oKTsKCX0sCglpc0RlZmF1bHRQcmV2ZW50ZWQ6IHJldHVybkZhbHNlLAoJaXNQcm9wYWdhdGlvblN0b3BwZWQ6IHJldHVybkZhbHNlLAoJaXNJbW1lZGlhdGVQcm9wYWdhdGlvblN0b3BwZWQ6IHJldHVybkZhbHNlCn07CgovLyBDaGVja3MgaWYgYW4gZXZlbnQgaGFwcGVuZWQgb24gYW4gZWxlbWVudCB3aXRoaW4gYW5vdGhlciBlbGVtZW50Ci8vIFVzZWQgaW4galF1ZXJ5LmV2ZW50LnNwZWNpYWwubW91c2VlbnRlciBhbmQgbW91c2VsZWF2ZSBoYW5kbGVycwp2YXIgd2l0aGluRWxlbWVudCA9IGZ1bmN0aW9uKCBldmVudCApIHsKCS8vIENoZWNrIGlmIG1vdXNlKG92ZXJ8b3V0KSBhcmUgc3RpbGwgd2l0aGluIHRoZSBzYW1lIHBhcmVudCBlbGVtZW50Cgl2YXIgcGFyZW50ID0gZXZlbnQucmVsYXRlZFRhcmdldDsKCgkvLyBGaXJlZm94IHNvbWV0aW1lcyBhc3NpZ25zIHJlbGF0ZWRUYXJnZXQgYSBYVUwgZWxlbWVudAoJLy8gd2hpY2ggd2UgY2Fubm90IGFjY2VzcyB0aGUgcGFyZW50Tm9kZSBwcm9wZXJ0eSBvZgoJdHJ5IHsKCQkvLyBUcmF2ZXJzZSB1cCB0aGUgdHJlZQoJCXdoaWxlICggcGFyZW50ICYmIHBhcmVudCAhPT0gdGhpcyApIHsKCQkJcGFyZW50ID0gcGFyZW50LnBhcmVudE5vZGU7CgkJfQoKCQlpZiAoIHBhcmVudCAhPT0gdGhpcyApIHsKCQkJLy8gc2V0IHRoZSBjb3JyZWN0IGV2ZW50IHR5cGUKCQkJZXZlbnQudHlwZSA9IGV2ZW50LmRhdGE7CgoJCQkvLyBoYW5kbGUgZXZlbnQgaWYgd2UgYWN0dWFsbHkganVzdCBtb3VzZWQgb24gdG8gYSBub24gc3ViLWVsZW1lbnQKCQkJalF1ZXJ5LmV2ZW50LmhhbmRsZS5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgkJfQoKCS8vIGFzc3VtaW5nIHdlJ3ZlIGxlZnQgdGhlIGVsZW1lbnQgc2luY2Ugd2UgbW9zdCBsaWtlbHkgbW91c2Vkb3ZlciBhIHh1bCBlbGVtZW50Cgl9IGNhdGNoKGUpIHsgfQp9LAoKLy8gSW4gY2FzZSBvZiBldmVudCBkZWxlZ2F0aW9uLCB3ZSBvbmx5IG5lZWQgdG8gcmVuYW1lIHRoZSBldmVudC50eXBlLAovLyBsaXZlSGFuZGxlciB3aWxsIHRha2UgY2FyZSBvZiB0aGUgcmVzdC4KZGVsZWdhdGUgPSBmdW5jdGlvbiggZXZlbnQgKSB7CglldmVudC50eXBlID0gZXZlbnQuZGF0YTsKCWpRdWVyeS5ldmVudC5oYW5kbGUuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwp9OwoKLy8gQ3JlYXRlIG1vdXNlZW50ZXIgYW5kIG1vdXNlbGVhdmUgZXZlbnRzCmpRdWVyeS5lYWNoKHsKCW1vdXNlZW50ZXI6ICJtb3VzZW92ZXIiLAoJbW91c2VsZWF2ZTogIm1vdXNlb3V0Igp9LCBmdW5jdGlvbiggb3JpZywgZml4ICkgewoJalF1ZXJ5LmV2ZW50LnNwZWNpYWxbIG9yaWcgXSA9IHsKCQlzZXR1cDogZnVuY3Rpb24oIGRhdGEgKSB7CgkJCWpRdWVyeS5ldmVudC5hZGQoIHRoaXMsIGZpeCwgZGF0YSAmJiBkYXRhLnNlbGVjdG9yID8gZGVsZWdhdGUgOiB3aXRoaW5FbGVtZW50LCBvcmlnICk7CgkJfSwKCQl0ZWFyZG93bjogZnVuY3Rpb24oIGRhdGEgKSB7CgkJCWpRdWVyeS5ldmVudC5yZW1vdmUoIHRoaXMsIGZpeCwgZGF0YSAmJiBkYXRhLnNlbGVjdG9yID8gZGVsZWdhdGUgOiB3aXRoaW5FbGVtZW50ICk7CgkJfQoJfTsKfSk7CgovLyBzdWJtaXQgZGVsZWdhdGlvbgppZiAoICFqUXVlcnkuc3VwcG9ydC5zdWJtaXRCdWJibGVzICkgewoKCWpRdWVyeS5ldmVudC5zcGVjaWFsLnN1Ym1pdCA9IHsKCQlzZXR1cDogZnVuY3Rpb24oIGRhdGEsIG5hbWVzcGFjZXMgKSB7CgkJCWlmICggdGhpcy5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpICE9PSAiZm9ybSIgKSB7CgkJCQlqUXVlcnkuZXZlbnQuYWRkKHRoaXMsICJjbGljay5zcGVjaWFsU3VibWl0IiwgZnVuY3Rpb24oIGUgKSB7CgkJCQkJdmFyIGVsZW0gPSBlLnRhcmdldCwgdHlwZSA9IGVsZW0udHlwZTsKCgkJCQkJaWYgKCAodHlwZSA9PT0gInN1Ym1pdCIgfHwgdHlwZSA9PT0gImltYWdlIikgJiYgalF1ZXJ5KCBlbGVtICkuY2xvc2VzdCgiZm9ybSIpLmxlbmd0aCApIHsKCQkJCQkJcmV0dXJuIHRyaWdnZXIoICJzdWJtaXQiLCB0aGlzLCBhcmd1bWVudHMgKTsKCQkJCQl9CgkJCQl9KTsKCSAKCQkJCWpRdWVyeS5ldmVudC5hZGQodGhpcywgImtleXByZXNzLnNwZWNpYWxTdWJtaXQiLCBmdW5jdGlvbiggZSApIHsKCQkJCQl2YXIgZWxlbSA9IGUudGFyZ2V0LCB0eXBlID0gZWxlbS50eXBlOwoKCQkJCQlpZiAoICh0eXBlID09PSAidGV4dCIgfHwgdHlwZSA9PT0gInBhc3N3b3JkIikgJiYgalF1ZXJ5KCBlbGVtICkuY2xvc2VzdCgiZm9ybSIpLmxlbmd0aCAmJiBlLmtleUNvZGUgPT09IDEzICkgewoJCQkJCQlyZXR1cm4gdHJpZ2dlciggInN1Ym1pdCIsIHRoaXMsIGFyZ3VtZW50cyApOwoJCQkJCX0KCQkJCX0pOwoKCQkJfSBlbHNlIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoJCX0sCgoJCXRlYXJkb3duOiBmdW5jdGlvbiggbmFtZXNwYWNlcyApIHsKCQkJalF1ZXJ5LmV2ZW50LnJlbW92ZSggdGhpcywgIi5zcGVjaWFsU3VibWl0IiApOwoJCX0KCX07Cgp9CgovLyBjaGFuZ2UgZGVsZWdhdGlvbiwgaGFwcGVucyBoZXJlIHNvIHdlIGhhdmUgYmluZC4KaWYgKCAhalF1ZXJ5LnN1cHBvcnQuY2hhbmdlQnViYmxlcyApIHsKCgl2YXIgZm9ybUVsZW1zID0gL3RleHRhcmVhfGlucHV0fHNlbGVjdC9pLAoKCWNoYW5nZUZpbHRlcnMsCgoJZ2V0VmFsID0gZnVuY3Rpb24oIGVsZW0gKSB7CgkJdmFyIHR5cGUgPSBlbGVtLnR5cGUsIHZhbCA9IGVsZW0udmFsdWU7CgoJCWlmICggdHlwZSA9PT0gInJhZGlvIiB8fCB0eXBlID09PSAiY2hlY2tib3giICkgewoJCQl2YWwgPSBlbGVtLmNoZWNrZWQ7CgoJCX0gZWxzZSBpZiAoIHR5cGUgPT09ICJzZWxlY3QtbXVsdGlwbGUiICkgewoJCQl2YWwgPSBlbGVtLnNlbGVjdGVkSW5kZXggPiAtMSA/CgkJCQlqUXVlcnkubWFwKCBlbGVtLm9wdGlvbnMsIGZ1bmN0aW9uKCBlbGVtICkgewoJCQkJCXJldHVybiBlbGVtLnNlbGVjdGVkOwoJCQkJfSkuam9pbigiLSIpIDoKCQkJCSIiOwoKCQl9IGVsc2UgaWYgKCBlbGVtLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09ICJzZWxlY3QiICkgewoJCQl2YWwgPSBlbGVtLnNlbGVjdGVkSW5kZXg7CgkJfQoKCQlyZXR1cm4gdmFsOwoJfSwKCgl0ZXN0Q2hhbmdlID0gZnVuY3Rpb24gdGVzdENoYW5nZSggZSApIHsKCQl2YXIgZWxlbSA9IGUudGFyZ2V0LCBkYXRhLCB2YWw7CgoJCWlmICggIWZvcm1FbGVtcy50ZXN0KCBlbGVtLm5vZGVOYW1lICkgfHwgZWxlbS5yZWFkT25seSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJZGF0YSA9IGpRdWVyeS5kYXRhKCBlbGVtLCAiX2NoYW5nZV9kYXRhIiApOwoJCXZhbCA9IGdldFZhbChlbGVtKTsKCgkJLy8gdGhlIGN1cnJlbnQgZGF0YSB3aWxsIGJlIGFsc28gcmV0cmlldmVkIGJ5IGJlZm9yZWFjdGl2YXRlCgkJaWYgKCBlLnR5cGUgIT09ICJmb2N1c291dCIgfHwgZWxlbS50eXBlICE9PSAicmFkaW8iICkgewoJCQlqUXVlcnkuZGF0YSggZWxlbSwgIl9jaGFuZ2VfZGF0YSIsIHZhbCApOwoJCX0KCQkKCQlpZiAoIGRhdGEgPT09IHVuZGVmaW5lZCB8fCB2YWwgPT09IGRhdGEgKSB7CgkJCXJldHVybjsKCQl9CgoJCWlmICggZGF0YSAhPSBudWxsIHx8IHZhbCApIHsKCQkJZS50eXBlID0gImNoYW5nZSI7CgkJCXJldHVybiBqUXVlcnkuZXZlbnQudHJpZ2dlciggZSwgYXJndW1lbnRzWzFdLCBlbGVtICk7CgkJfQoJfTsKCglqUXVlcnkuZXZlbnQuc3BlY2lhbC5jaGFuZ2UgPSB7CgkJZmlsdGVyczogewoJCQlmb2N1c291dDogdGVzdENoYW5nZSwgCgoJCQljbGljazogZnVuY3Rpb24oIGUgKSB7CgkJCQl2YXIgZWxlbSA9IGUudGFyZ2V0LCB0eXBlID0gZWxlbS50eXBlOwoKCQkJCWlmICggdHlwZSA9PT0gInJhZGlvIiB8fCB0eXBlID09PSAiY2hlY2tib3giIHx8IGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gInNlbGVjdCIgKSB7CgkJCQkJcmV0dXJuIHRlc3RDaGFuZ2UuY2FsbCggdGhpcywgZSApOwoJCQkJfQoJCQl9LAoKCQkJLy8gQ2hhbmdlIGhhcyB0byBiZSBjYWxsZWQgYmVmb3JlIHN1Ym1pdAoJCQkvLyBLZXlkb3duIHdpbGwgYmUgY2FsbGVkIGJlZm9yZSBrZXlwcmVzcywgd2hpY2ggaXMgdXNlZCBpbiBzdWJtaXQtZXZlbnQgZGVsZWdhdGlvbgoJCQlrZXlkb3duOiBmdW5jdGlvbiggZSApIHsKCQkJCXZhciBlbGVtID0gZS50YXJnZXQsIHR5cGUgPSBlbGVtLnR5cGU7CgoJCQkJaWYgKCAoZS5rZXlDb2RlID09PSAxMyAmJiBlbGVtLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgIT09ICJ0ZXh0YXJlYSIpIHx8CgkJCQkJKGUua2V5Q29kZSA9PT0gMzIgJiYgKHR5cGUgPT09ICJjaGVja2JveCIgfHwgdHlwZSA9PT0gInJhZGlvIikpIHx8CgkJCQkJdHlwZSA9PT0gInNlbGVjdC1tdWx0aXBsZSIgKSB7CgkJCQkJcmV0dXJuIHRlc3RDaGFuZ2UuY2FsbCggdGhpcywgZSApOwoJCQkJfQoJCQl9LAoKCQkJLy8gQmVmb3JlYWN0aXZhdGUgaGFwcGVucyBhbHNvIGJlZm9yZSB0aGUgcHJldmlvdXMgZWxlbWVudCBpcyBibHVycmVkCgkJCS8vIHdpdGggdGhpcyBldmVudCB5b3UgY2FuJ3QgdHJpZ2dlciBhIGNoYW5nZSBldmVudCwgYnV0IHlvdSBjYW4gc3RvcmUKCQkJLy8gaW5mb3JtYXRpb24vZm9jdXNbaW5dIGlzIG5vdCBuZWVkZWQgYW55bW9yZQoJCQliZWZvcmVhY3RpdmF0ZTogZnVuY3Rpb24oIGUgKSB7CgkJCQl2YXIgZWxlbSA9IGUudGFyZ2V0OwoJCQkJalF1ZXJ5LmRhdGEoIGVsZW0sICJfY2hhbmdlX2RhdGEiLCBnZXRWYWwoZWxlbSkgKTsKCQkJfQoJCX0sCgoJCXNldHVwOiBmdW5jdGlvbiggZGF0YSwgbmFtZXNwYWNlcyApIHsKCQkJaWYgKCB0aGlzLnR5cGUgPT09ICJmaWxlIiApIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoKCQkJZm9yICggdmFyIHR5cGUgaW4gY2hhbmdlRmlsdGVycyApIHsKCQkJCWpRdWVyeS5ldmVudC5hZGQoIHRoaXMsIHR5cGUgKyAiLnNwZWNpYWxDaGFuZ2UiLCBjaGFuZ2VGaWx0ZXJzW3R5cGVdICk7CgkJCX0KCgkJCXJldHVybiBmb3JtRWxlbXMudGVzdCggdGhpcy5ub2RlTmFtZSApOwoJCX0sCgoJCXRlYXJkb3duOiBmdW5jdGlvbiggbmFtZXNwYWNlcyApIHsKCQkJalF1ZXJ5LmV2ZW50LnJlbW92ZSggdGhpcywgIi5zcGVjaWFsQ2hhbmdlIiApOwoKCQkJcmV0dXJuIGZvcm1FbGVtcy50ZXN0KCB0aGlzLm5vZGVOYW1lICk7CgkJfQoJfTsKCgljaGFuZ2VGaWx0ZXJzID0galF1ZXJ5LmV2ZW50LnNwZWNpYWwuY2hhbmdlLmZpbHRlcnM7Cn0KCmZ1bmN0aW9uIHRyaWdnZXIoIHR5cGUsIGVsZW0sIGFyZ3MgKSB7CglhcmdzWzBdLnR5cGUgPSB0eXBlOwoJcmV0dXJuIGpRdWVyeS5ldmVudC5oYW5kbGUuYXBwbHkoIGVsZW0sIGFyZ3MgKTsKfQoKLy8gQ3JlYXRlICJidWJibGluZyIgZm9jdXMgYW5kIGJsdXIgZXZlbnRzCmlmICggZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lciApIHsKCWpRdWVyeS5lYWNoKHsgZm9jdXM6ICJmb2N1c2luIiwgYmx1cjogImZvY3Vzb3V0IiB9LCBmdW5jdGlvbiggb3JpZywgZml4ICkgewoJCWpRdWVyeS5ldmVudC5zcGVjaWFsWyBmaXggXSA9IHsKCQkJc2V0dXA6IGZ1bmN0aW9uKCkgewoJCQkJdGhpcy5hZGRFdmVudExpc3RlbmVyKCBvcmlnLCBoYW5kbGVyLCB0cnVlICk7CgkJCX0sIAoJCQl0ZWFyZG93bjogZnVuY3Rpb24oKSB7IAoJCQkJdGhpcy5yZW1vdmVFdmVudExpc3RlbmVyKCBvcmlnLCBoYW5kbGVyLCB0cnVlICk7CgkJCX0KCQl9OwoKCQlmdW5jdGlvbiBoYW5kbGVyKCBlICkgeyAKCQkJZSA9IGpRdWVyeS5ldmVudC5maXgoIGUgKTsKCQkJZS50eXBlID0gZml4OwoJCQlyZXR1cm4galF1ZXJ5LmV2ZW50LmhhbmRsZS5jYWxsKCB0aGlzLCBlICk7CgkJfQoJfSk7Cn0KCmpRdWVyeS5lYWNoKFsiYmluZCIsICJvbmUiXSwgZnVuY3Rpb24oIGksIG5hbWUgKSB7CglqUXVlcnkuZm5bIG5hbWUgXSA9IGZ1bmN0aW9uKCB0eXBlLCBkYXRhLCBmbiApIHsKCQkvLyBIYW5kbGUgb2JqZWN0IGxpdGVyYWxzCgkJaWYgKCB0eXBlb2YgdHlwZSA9PT0gIm9iamVjdCIgKSB7CgkJCWZvciAoIHZhciBrZXkgaW4gdHlwZSApIHsKCQkJCXRoaXNbIG5hbWUgXShrZXksIGRhdGEsIHR5cGVba2V5XSwgZm4pOwoJCQl9CgkJCXJldHVybiB0aGlzOwoJCX0KCQkKCQlpZiAoIGpRdWVyeS5pc0Z1bmN0aW9uKCBkYXRhICkgKSB7CgkJCWZuID0gZGF0YTsKCQkJZGF0YSA9IHVuZGVmaW5lZDsKCQl9CgoJCXZhciBoYW5kbGVyID0gbmFtZSA9PT0gIm9uZSIgPyBqUXVlcnkucHJveHkoIGZuLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCWpRdWVyeSggdGhpcyApLnVuYmluZCggZXZlbnQsIGhhbmRsZXIgKTsKCQkJcmV0dXJuIGZuLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsKCQl9KSA6IGZuOwoKCQlpZiAoIHR5cGUgPT09ICJ1bmxvYWQiICYmIG5hbWUgIT09ICJvbmUiICkgewoJCQl0aGlzLm9uZSggdHlwZSwgZGF0YSwgZm4gKTsKCgkJfSBlbHNlIHsKCQkJZm9yICggdmFyIGkgPSAwLCBsID0gdGhpcy5sZW5ndGg7IGkgPCBsOyBpKysgKSB7CgkJCQlqUXVlcnkuZXZlbnQuYWRkKCB0aGlzW2ldLCB0eXBlLCBoYW5kbGVyLCBkYXRhICk7CgkJCX0KCQl9CgoJCXJldHVybiB0aGlzOwoJfTsKfSk7CgpqUXVlcnkuZm4uZXh0ZW5kKHsKCXVuYmluZDogZnVuY3Rpb24oIHR5cGUsIGZuICkgewoJCS8vIEhhbmRsZSBvYmplY3QgbGl0ZXJhbHMKCQlpZiAoIHR5cGVvZiB0eXBlID09PSAib2JqZWN0IiAmJiAhdHlwZS5wcmV2ZW50RGVmYXVsdCApIHsKCQkJZm9yICggdmFyIGtleSBpbiB0eXBlICkgewoJCQkJdGhpcy51bmJpbmQoa2V5LCB0eXBlW2tleV0pOwoJCQl9CgoJCX0gZWxzZSB7CgkJCWZvciAoIHZhciBpID0gMCwgbCA9IHRoaXMubGVuZ3RoOyBpIDwgbDsgaSsrICkgewoJCQkJalF1ZXJ5LmV2ZW50LnJlbW92ZSggdGhpc1tpXSwgdHlwZSwgZm4gKTsKCQkJfQoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9LAoJCglkZWxlZ2F0ZTogZnVuY3Rpb24oIHNlbGVjdG9yLCB0eXBlcywgZGF0YSwgZm4gKSB7CgkJcmV0dXJuIHRoaXMubGl2ZSggdHlwZXMsIGRhdGEsIGZuLCBzZWxlY3RvciApOwoJfSwKCQoJdW5kZWxlZ2F0ZTogZnVuY3Rpb24oIHNlbGVjdG9yLCB0eXBlcywgZm4gKSB7CgkJaWYgKCBhcmd1bWVudHMubGVuZ3RoID09PSAwICkgewoJCQkJcmV0dXJuIHRoaXMudW5iaW5kKCAibGl2ZSIgKTsKCQkKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5kaWUoIHR5cGVzLCBudWxsLCBmbiwgc2VsZWN0b3IgKTsKCQl9Cgl9LAoJCgl0cmlnZ2VyOiBmdW5jdGlvbiggdHlwZSwgZGF0YSApIHsKCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQlqUXVlcnkuZXZlbnQudHJpZ2dlciggdHlwZSwgZGF0YSwgdGhpcyApOwoJCX0pOwoJfSwKCgl0cmlnZ2VySGFuZGxlcjogZnVuY3Rpb24oIHR5cGUsIGRhdGEgKSB7CgkJaWYgKCB0aGlzWzBdICkgewoJCQl2YXIgZXZlbnQgPSBqUXVlcnkuRXZlbnQoIHR5cGUgKTsKCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7CgkJCWpRdWVyeS5ldmVudC50cmlnZ2VyKCBldmVudCwgZGF0YSwgdGhpc1swXSApOwoJCQlyZXR1cm4gZXZlbnQucmVzdWx0OwoJCX0KCX0sCgoJdG9nZ2xlOiBmdW5jdGlvbiggZm4gKSB7CgkJLy8gU2F2ZSByZWZlcmVuY2UgdG8gYXJndW1lbnRzIGZvciBhY2Nlc3MgaW4gY2xvc3VyZQoJCXZhciBhcmdzID0gYXJndW1lbnRzLCBpID0gMTsKCgkJLy8gbGluayBhbGwgdGhlIGZ1bmN0aW9ucywgc28gYW55IG9mIHRoZW0gY2FuIHVuYmluZCB0aGlzIGNsaWNrIGhhbmRsZXIKCQl3aGlsZSAoIGkgPCBhcmdzLmxlbmd0aCApIHsKCQkJalF1ZXJ5LnByb3h5KCBmbiwgYXJnc1sgaSsrIF0gKTsKCQl9CgoJCXJldHVybiB0aGlzLmNsaWNrKCBqUXVlcnkucHJveHkoIGZuLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCS8vIEZpZ3VyZSBvdXQgd2hpY2ggZnVuY3Rpb24gdG8gZXhlY3V0ZQoJCQl2YXIgbGFzdFRvZ2dsZSA9ICggalF1ZXJ5LmRhdGEoIHRoaXMsICJsYXN0VG9nZ2xlIiArIGZuLmd1aWQgKSB8fCAwICkgJSBpOwoJCQlqUXVlcnkuZGF0YSggdGhpcywgImxhc3RUb2dnbGUiICsgZm4uZ3VpZCwgbGFzdFRvZ2dsZSArIDEgKTsKCgkJCS8vIE1ha2Ugc3VyZSB0aGF0IGNsaWNrcyBzdG9wCgkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgoJCQkvLyBhbmQgZXhlY3V0ZSB0aGUgZnVuY3Rpb24KCQkJcmV0dXJuIGFyZ3NbIGxhc3RUb2dnbGUgXS5hcHBseSggdGhpcywgYXJndW1lbnRzICkgfHwgZmFsc2U7CgkJfSkpOwoJfSwKCglob3ZlcjogZnVuY3Rpb24oIGZuT3ZlciwgZm5PdXQgKSB7CgkJcmV0dXJuIHRoaXMubW91c2VlbnRlciggZm5PdmVyICkubW91c2VsZWF2ZSggZm5PdXQgfHwgZm5PdmVyICk7Cgl9Cn0pOwoKdmFyIGxpdmVNYXAgPSB7Cglmb2N1czogImZvY3VzaW4iLAoJYmx1cjogImZvY3Vzb3V0IiwKCW1vdXNlZW50ZXI6ICJtb3VzZW92ZXIiLAoJbW91c2VsZWF2ZTogIm1vdXNlb3V0Igp9OwoKalF1ZXJ5LmVhY2goWyJsaXZlIiwgImRpZSJdLCBmdW5jdGlvbiggaSwgbmFtZSApIHsKCWpRdWVyeS5mblsgbmFtZSBdID0gZnVuY3Rpb24oIHR5cGVzLCBkYXRhLCBmbiwgb3JpZ1NlbGVjdG9yIC8qIEludGVybmFsIFVzZSBPbmx5ICovICkgewoJCXZhciB0eXBlLCBpID0gMCwgbWF0Y2gsIG5hbWVzcGFjZXMsIHByZVR5cGUsCgkJCXNlbGVjdG9yID0gb3JpZ1NlbGVjdG9yIHx8IHRoaXMuc2VsZWN0b3IsCgkJCWNvbnRleHQgPSBvcmlnU2VsZWN0b3IgPyB0aGlzIDogalF1ZXJ5KCB0aGlzLmNvbnRleHQgKTsKCgkJaWYgKCBqUXVlcnkuaXNGdW5jdGlvbiggZGF0YSApICkgewoJCQlmbiA9IGRhdGE7CgkJCWRhdGEgPSB1bmRlZmluZWQ7CgkJfQoKCQl0eXBlcyA9ICh0eXBlcyB8fCAiIikuc3BsaXQoIiAiKTsKCgkJd2hpbGUgKCAodHlwZSA9IHR5cGVzWyBpKysgXSkgIT0gbnVsbCApIHsKCQkJbWF0Y2ggPSBybmFtZXNwYWNlcy5leGVjKCB0eXBlICk7CgkJCW5hbWVzcGFjZXMgPSAiIjsKCgkJCWlmICggbWF0Y2ggKSAgewoJCQkJbmFtZXNwYWNlcyA9IG1hdGNoWzBdOwoJCQkJdHlwZSA9IHR5cGUucmVwbGFjZSggcm5hbWVzcGFjZXMsICIiICk7CgkJCX0KCgkJCWlmICggdHlwZSA9PT0gImhvdmVyIiApIHsKCQkJCXR5cGVzLnB1c2goICJtb3VzZWVudGVyIiArIG5hbWVzcGFjZXMsICJtb3VzZWxlYXZlIiArIG5hbWVzcGFjZXMgKTsKCQkJCWNvbnRpbnVlOwoJCQl9CgoJCQlwcmVUeXBlID0gdHlwZTsKCgkJCWlmICggdHlwZSA9PT0gImZvY3VzIiB8fCB0eXBlID09PSAiYmx1ciIgKSB7CgkJCQl0eXBlcy5wdXNoKCBsaXZlTWFwWyB0eXBlIF0gKyBuYW1lc3BhY2VzICk7CgkJCQl0eXBlID0gdHlwZSArIG5hbWVzcGFjZXM7CgoJCQl9IGVsc2UgewoJCQkJdHlwZSA9IChsaXZlTWFwWyB0eXBlIF0gfHwgdHlwZSkgKyBuYW1lc3BhY2VzOwoJCQl9CgoJCQlpZiAoIG5hbWUgPT09ICJsaXZlIiApIHsKCQkJCS8vIGJpbmQgbGl2ZSBoYW5kbGVyCgkJCQljb250ZXh0LmVhY2goZnVuY3Rpb24oKXsKCQkJCQlqUXVlcnkuZXZlbnQuYWRkKCB0aGlzLCBsaXZlQ29udmVydCggdHlwZSwgc2VsZWN0b3IgKSwKCQkJCQkJeyBkYXRhOiBkYXRhLCBzZWxlY3Rvcjogc2VsZWN0b3IsIGhhbmRsZXI6IGZuLCBvcmlnVHlwZTogdHlwZSwgb3JpZ0hhbmRsZXI6IGZuLCBwcmVUeXBlOiBwcmVUeXBlIH0gKTsKCQkJCX0pOwoKCQkJfSBlbHNlIHsKCQkJCS8vIHVuYmluZCBsaXZlIGhhbmRsZXIKCQkJCWNvbnRleHQudW5iaW5kKCBsaXZlQ29udmVydCggdHlwZSwgc2VsZWN0b3IgKSwgZm4gKTsKCQkJfQoJCX0KCQkKCQlyZXR1cm4gdGhpczsKCX0KfSk7CgpmdW5jdGlvbiBsaXZlSGFuZGxlciggZXZlbnQgKSB7Cgl2YXIgc3RvcCwgZWxlbXMgPSBbXSwgc2VsZWN0b3JzID0gW10sIGFyZ3MgPSBhcmd1bWVudHMsCgkJcmVsYXRlZCwgbWF0Y2gsIGhhbmRsZU9iaiwgZWxlbSwgaiwgaSwgbCwgZGF0YSwKCQlldmVudHMgPSBqUXVlcnkuZGF0YSggdGhpcywgImV2ZW50cyIgKTsKCgkvLyBNYWtlIHN1cmUgd2UgYXZvaWQgbm9uLWxlZnQtY2xpY2sgYnViYmxpbmcgaW4gRmlyZWZveCAoIzM4NjEpCglpZiAoIGV2ZW50LmxpdmVGaXJlZCA9PT0gdGhpcyB8fCAhZXZlbnRzIHx8ICFldmVudHMubGl2ZSB8fCBldmVudC5idXR0b24gJiYgZXZlbnQudHlwZSA9PT0gImNsaWNrIiApIHsKCQlyZXR1cm47Cgl9CgoJZXZlbnQubGl2ZUZpcmVkID0gdGhpczsKCgl2YXIgbGl2ZSA9IGV2ZW50cy5saXZlLnNsaWNlKDApOwoKCWZvciAoIGogPSAwOyBqIDwgbGl2ZS5sZW5ndGg7IGorKyApIHsKCQloYW5kbGVPYmogPSBsaXZlW2pdOwoKCQlpZiAoIGhhbmRsZU9iai5vcmlnVHlwZS5yZXBsYWNlKCBybmFtZXNwYWNlcywgIiIgKSA9PT0gZXZlbnQudHlwZSApIHsKCQkJc2VsZWN0b3JzLnB1c2goIGhhbmRsZU9iai5zZWxlY3RvciApOwoKCQl9IGVsc2UgewoJCQlsaXZlLnNwbGljZSggai0tLCAxICk7CgkJfQoJfQoKCW1hdGNoID0galF1ZXJ5KCBldmVudC50YXJnZXQgKS5jbG9zZXN0KCBzZWxlY3RvcnMsIGV2ZW50LmN1cnJlbnRUYXJnZXQgKTsKCglmb3IgKCBpID0gMCwgbCA9IG1hdGNoLmxlbmd0aDsgaSA8IGw7IGkrKyApIHsKCQlmb3IgKCBqID0gMDsgaiA8IGxpdmUubGVuZ3RoOyBqKysgKSB7CgkJCWhhbmRsZU9iaiA9IGxpdmVbal07CgoJCQlpZiAoIG1hdGNoW2ldLnNlbGVjdG9yID09PSBoYW5kbGVPYmouc2VsZWN0b3IgKSB7CgkJCQllbGVtID0gbWF0Y2hbaV0uZWxlbTsKCQkJCXJlbGF0ZWQgPSBudWxsOwoKCQkJCS8vIFRob3NlIHR3byBldmVudHMgcmVxdWlyZSBhZGRpdGlvbmFsIGNoZWNraW5nCgkJCQlpZiAoIGhhbmRsZU9iai5wcmVUeXBlID09PSAibW91c2VlbnRlciIgfHwgaGFuZGxlT2JqLnByZVR5cGUgPT09ICJtb3VzZWxlYXZlIiApIHsKCQkJCQlyZWxhdGVkID0galF1ZXJ5KCBldmVudC5yZWxhdGVkVGFyZ2V0ICkuY2xvc2VzdCggaGFuZGxlT2JqLnNlbGVjdG9yIClbMF07CgkJCQl9CgoJCQkJaWYgKCAhcmVsYXRlZCB8fCByZWxhdGVkICE9PSBlbGVtICkgewoJCQkJCWVsZW1zLnB1c2goeyBlbGVtOiBlbGVtLCBoYW5kbGVPYmo6IGhhbmRsZU9iaiB9KTsKCQkJCX0KCQkJfQoJCX0KCX0KCglmb3IgKCBpID0gMCwgbCA9IGVsZW1zLmxlbmd0aDsgaSA8IGw7IGkrKyApIHsKCQltYXRjaCA9IGVsZW1zW2ldOwoJCWV2ZW50LmN1cnJlbnRUYXJnZXQgPSBtYXRjaC5lbGVtOwoJCWV2ZW50LmRhdGEgPSBtYXRjaC5oYW5kbGVPYmouZGF0YTsKCQlldmVudC5oYW5kbGVPYmogPSBtYXRjaC5oYW5kbGVPYmo7CgoJCWlmICggbWF0Y2guaGFuZGxlT2JqLm9yaWdIYW5kbGVyLmFwcGx5KCBtYXRjaC5lbGVtLCBhcmdzICkgPT09IGZhbHNlICkgewoJCQlzdG9wID0gZmFsc2U7CgkJCWJyZWFrOwoJCX0KCX0KCglyZXR1cm4gc3RvcDsKfQoKZnVuY3Rpb24gbGl2ZUNvbnZlcnQoIHR5cGUsIHNlbGVjdG9yICkgewoJcmV0dXJuICJsaXZlLiIgKyAodHlwZSAmJiB0eXBlICE9PSAiKiIgPyB0eXBlICsgIi4iIDogIiIpICsgc2VsZWN0b3IucmVwbGFjZSgvXC4vZywgImAiKS5yZXBsYWNlKC8gL2csICImIik7Cn0KCmpRdWVyeS5lYWNoKCAoImJsdXIgZm9jdXMgZm9jdXNpbiBmb2N1c291dCBsb2FkIHJlc2l6ZSBzY3JvbGwgdW5sb2FkIGNsaWNrIGRibGNsaWNrICIgKwoJIm1vdXNlZG93biBtb3VzZXVwIG1vdXNlbW92ZSBtb3VzZW92ZXIgbW91c2VvdXQgbW91c2VlbnRlciBtb3VzZWxlYXZlICIgKwoJImNoYW5nZSBzZWxlY3Qgc3VibWl0IGtleWRvd24ga2V5cHJlc3Mga2V5dXAgZXJyb3IiKS5zcGxpdCgiICIpLCBmdW5jdGlvbiggaSwgbmFtZSApIHsKCgkvLyBIYW5kbGUgZXZlbnQgYmluZGluZwoJalF1ZXJ5LmZuWyBuYW1lIF0gPSBmdW5jdGlvbiggZm4gKSB7CgkJcmV0dXJuIGZuID8gdGhpcy5iaW5kKCBuYW1lLCBmbiApIDogdGhpcy50cmlnZ2VyKCBuYW1lICk7Cgl9OwoKCWlmICggalF1ZXJ5LmF0dHJGbiApIHsKCQlqUXVlcnkuYXR0ckZuWyBuYW1lIF0gPSB0cnVlOwoJfQp9KTsKCi8vIFByZXZlbnQgbWVtb3J5IGxlYWtzIGluIElFCi8vIFdpbmRvdyBpc24ndCBpbmNsdWRlZCBzbyBhcyBub3QgdG8gdW5iaW5kIGV4aXN0aW5nIHVubG9hZCBldmVudHMKLy8gTW9yZSBpbmZvOgovLyAgLSBodHRwOi8vaXNhYWNzY2hsdWV0ZXIuY29tLzIwMDYvMTAvbXNpZS1tZW1vcnktbGVha3MvCmlmICggd2luZG93LmF0dGFjaEV2ZW50ICYmICF3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lciApIHsKCXdpbmRvdy5hdHRhY2hFdmVudCgib251bmxvYWQiLCBmdW5jdGlvbigpIHsKCQlmb3IgKCB2YXIgaWQgaW4galF1ZXJ5LmNhY2hlICkgewoJCQlpZiAoIGpRdWVyeS5jYWNoZVsgaWQgXS5oYW5kbGUgKSB7CgkJCQkvLyBUcnkvQ2F0Y2ggaXMgdG8gaGFuZGxlIGlmcmFtZXMgYmVpbmcgdW5sb2FkZWQsIHNlZSAjNDI4MAoJCQkJdHJ5IHsKCQkJCQlqUXVlcnkuZXZlbnQucmVtb3ZlKCBqUXVlcnkuY2FjaGVbIGlkIF0uaGFuZGxlLmVsZW0gKTsKCQkJCX0gY2F0Y2goZSkge30KCQkJfQoJCX0KCX0pOwp9Ci8qIQogKiBTaXp6bGUgQ1NTIFNlbGVjdG9yIEVuZ2luZSAtIHYxLjAKICogIENvcHlyaWdodCAyMDA5LCBUaGUgRG9qbyBGb3VuZGF0aW9uCiAqICBSZWxlYXNlZCB1bmRlciB0aGUgTUlULCBCU0QsIGFuZCBHUEwgTGljZW5zZXMuCiAqICBNb3JlIGluZm9ybWF0aW9uOiBodHRwOi8vc2l6emxlanMuY29tLwogKi8KKGZ1bmN0aW9uKCl7Cgp2YXIgY2h1bmtlciA9IC8oKD86XCgoPzpcKFteKCldK1wpfFteKCldKykrXCl8XFsoPzpcW1teW1xdXSpcXXxbJyJdW14nIl0qWyciXXxbXltcXSciXSspK1xdfFxcLnxbXiA+K34sKFxbXFxdKykrfFs+K35dKShccyosXHMqKT8oKD86LnxccnxcbikqKS9nLAoJZG9uZSA9IDAsCgl0b1N0cmluZyA9IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcsCgloYXNEdXBsaWNhdGUgPSBmYWxzZSwKCWJhc2VIYXNEdXBsaWNhdGUgPSB0cnVlOwoKLy8gSGVyZSB3ZSBjaGVjayBpZiB0aGUgSmF2YVNjcmlwdCBlbmdpbmUgaXMgdXNpbmcgc29tZSBzb3J0IG9mCi8vIG9wdGltaXphdGlvbiB3aGVyZSBpdCBkb2VzIG5vdCBhbHdheXMgY2FsbCBvdXIgY29tcGFyaXNpb24KLy8gZnVuY3Rpb24uIElmIHRoYXQgaXMgdGhlIGNhc2UsIGRpc2NhcmQgdGhlIGhhc0R1cGxpY2F0ZSB2YWx1ZS4KLy8gICBUaHVzIGZhciB0aGF0IGluY2x1ZGVzIEdvb2dsZSBDaHJvbWUuClswLCAwXS5zb3J0KGZ1bmN0aW9uKCl7CgliYXNlSGFzRHVwbGljYXRlID0gZmFsc2U7CglyZXR1cm4gMDsKfSk7Cgp2YXIgU2l6emxlID0gZnVuY3Rpb24oc2VsZWN0b3IsIGNvbnRleHQsIHJlc3VsdHMsIHNlZWQpIHsKCXJlc3VsdHMgPSByZXN1bHRzIHx8IFtdOwoJdmFyIG9yaWdDb250ZXh0ID0gY29udGV4dCA9IGNvbnRleHQgfHwgZG9jdW1lbnQ7CgoJaWYgKCBjb250ZXh0Lm5vZGVUeXBlICE9PSAxICYmIGNvbnRleHQubm9kZVR5cGUgIT09IDkgKSB7CgkJcmV0dXJuIFtdOwoJfQoJCglpZiAoICFzZWxlY3RvciB8fCB0eXBlb2Ygc2VsZWN0b3IgIT09ICJzdHJpbmciICkgewoJCXJldHVybiByZXN1bHRzOwoJfQoKCXZhciBwYXJ0cyA9IFtdLCBtLCBzZXQsIGNoZWNrU2V0LCBleHRyYSwgcHJ1bmUgPSB0cnVlLCBjb250ZXh0WE1MID0gaXNYTUwoY29udGV4dCksCgkJc29GYXIgPSBzZWxlY3RvcjsKCQoJLy8gUmVzZXQgdGhlIHBvc2l0aW9uIG9mIHRoZSBjaHVua2VyIHJlZ2V4cCAoc3RhcnQgZnJvbSBoZWFkKQoJd2hpbGUgKCAoY2h1bmtlci5leGVjKCIiKSwgbSA9IGNodW5rZXIuZXhlYyhzb0ZhcikpICE9PSBudWxsICkgewoJCXNvRmFyID0gbVszXTsKCQkKCQlwYXJ0cy5wdXNoKCBtWzFdICk7CgkJCgkJaWYgKCBtWzJdICkgewoJCQlleHRyYSA9IG1bM107CgkJCWJyZWFrOwoJCX0KCX0KCglpZiAoIHBhcnRzLmxlbmd0aCA+IDEgJiYgb3JpZ1BPUy5leGVjKCBzZWxlY3RvciApICkgewoJCWlmICggcGFydHMubGVuZ3RoID09PSAyICYmIEV4cHIucmVsYXRpdmVbIHBhcnRzWzBdIF0gKSB7CgkJCXNldCA9IHBvc1Byb2Nlc3MoIHBhcnRzWzBdICsgcGFydHNbMV0sIGNvbnRleHQgKTsKCQl9IGVsc2UgewoJCQlzZXQgPSBFeHByLnJlbGF0aXZlWyBwYXJ0c1swXSBdID8KCQkJCVsgY29udGV4dCBdIDoKCQkJCVNpenpsZSggcGFydHMuc2hpZnQoKSwgY29udGV4dCApOwoKCQkJd2hpbGUgKCBwYXJ0cy5sZW5ndGggKSB7CgkJCQlzZWxlY3RvciA9IHBhcnRzLnNoaWZ0KCk7CgoJCQkJaWYgKCBFeHByLnJlbGF0aXZlWyBzZWxlY3RvciBdICkgewoJCQkJCXNlbGVjdG9yICs9IHBhcnRzLnNoaWZ0KCk7CgkJCQl9CgkJCQkKCQkJCXNldCA9IHBvc1Byb2Nlc3MoIHNlbGVjdG9yLCBzZXQgKTsKCQkJfQoJCX0KCX0gZWxzZSB7CgkJLy8gVGFrZSBhIHNob3J0Y3V0IGFuZCBzZXQgdGhlIGNvbnRleHQgaWYgdGhlIHJvb3Qgc2VsZWN0b3IgaXMgYW4gSUQKCQkvLyAoYnV0IG5vdCBpZiBpdCdsbCBiZSBmYXN0ZXIgaWYgdGhlIGlubmVyIHNlbGVjdG9yIGlzIGFuIElEKQoJCWlmICggIXNlZWQgJiYgcGFydHMubGVuZ3RoID4gMSAmJiBjb250ZXh0Lm5vZGVUeXBlID09PSA5ICYmICFjb250ZXh0WE1MICYmCgkJCQlFeHByLm1hdGNoLklELnRlc3QocGFydHNbMF0pICYmICFFeHByLm1hdGNoLklELnRlc3QocGFydHNbcGFydHMubGVuZ3RoIC0gMV0pICkgewoJCQl2YXIgcmV0ID0gU2l6emxlLmZpbmQoIHBhcnRzLnNoaWZ0KCksIGNvbnRleHQsIGNvbnRleHRYTUwgKTsKCQkJY29udGV4dCA9IHJldC5leHByID8gU2l6emxlLmZpbHRlciggcmV0LmV4cHIsIHJldC5zZXQgKVswXSA6IHJldC5zZXRbMF07CgkJfQoKCQlpZiAoIGNvbnRleHQgKSB7CgkJCXZhciByZXQgPSBzZWVkID8KCQkJCXsgZXhwcjogcGFydHMucG9wKCksIHNldDogbWFrZUFycmF5KHNlZWQpIH0gOgoJCQkJU2l6emxlLmZpbmQoIHBhcnRzLnBvcCgpLCBwYXJ0cy5sZW5ndGggPT09IDEgJiYgKHBhcnRzWzBdID09PSAifiIgfHwgcGFydHNbMF0gPT09ICIrIikgJiYgY29udGV4dC5wYXJlbnROb2RlID8gY29udGV4dC5wYXJlbnROb2RlIDogY29udGV4dCwgY29udGV4dFhNTCApOwoJCQlzZXQgPSByZXQuZXhwciA/IFNpenpsZS5maWx0ZXIoIHJldC5leHByLCByZXQuc2V0ICkgOiByZXQuc2V0OwoKCQkJaWYgKCBwYXJ0cy5sZW5ndGggPiAwICkgewoJCQkJY2hlY2tTZXQgPSBtYWtlQXJyYXkoc2V0KTsKCQkJfSBlbHNlIHsKCQkJCXBydW5lID0gZmFsc2U7CgkJCX0KCgkJCXdoaWxlICggcGFydHMubGVuZ3RoICkgewoJCQkJdmFyIGN1ciA9IHBhcnRzLnBvcCgpLCBwb3AgPSBjdXI7CgoJCQkJaWYgKCAhRXhwci5yZWxhdGl2ZVsgY3VyIF0gKSB7CgkJCQkJY3VyID0gIiI7CgkJCQl9IGVsc2UgewoJCQkJCXBvcCA9IHBhcnRzLnBvcCgpOwoJCQkJfQoKCQkJCWlmICggcG9wID09IG51bGwgKSB7CgkJCQkJcG9wID0gY29udGV4dDsKCQkJCX0KCgkJCQlFeHByLnJlbGF0aXZlWyBjdXIgXSggY2hlY2tTZXQsIHBvcCwgY29udGV4dFhNTCApOwoJCQl9CgkJfSBlbHNlIHsKCQkJY2hlY2tTZXQgPSBwYXJ0cyA9IFtdOwoJCX0KCX0KCglpZiAoICFjaGVja1NldCApIHsKCQljaGVja1NldCA9IHNldDsKCX0KCglpZiAoICFjaGVja1NldCApIHsKCQlTaXp6bGUuZXJyb3IoIGN1ciB8fCBzZWxlY3RvciApOwoJfQoKCWlmICggdG9TdHJpbmcuY2FsbChjaGVja1NldCkgPT09ICJbb2JqZWN0IEFycmF5XSIgKSB7CgkJaWYgKCAhcHJ1bmUgKSB7CgkJCXJlc3VsdHMucHVzaC5hcHBseSggcmVzdWx0cywgY2hlY2tTZXQgKTsKCQl9IGVsc2UgaWYgKCBjb250ZXh0ICYmIGNvbnRleHQubm9kZVR5cGUgPT09IDEgKSB7CgkJCWZvciAoIHZhciBpID0gMDsgY2hlY2tTZXRbaV0gIT0gbnVsbDsgaSsrICkgewoJCQkJaWYgKCBjaGVja1NldFtpXSAmJiAoY2hlY2tTZXRbaV0gPT09IHRydWUgfHwgY2hlY2tTZXRbaV0ubm9kZVR5cGUgPT09IDEgJiYgY29udGFpbnMoY29udGV4dCwgY2hlY2tTZXRbaV0pKSApIHsKCQkJCQlyZXN1bHRzLnB1c2goIHNldFtpXSApOwoJCQkJfQoJCQl9CgkJfSBlbHNlIHsKCQkJZm9yICggdmFyIGkgPSAwOyBjaGVja1NldFtpXSAhPSBudWxsOyBpKysgKSB7CgkJCQlpZiAoIGNoZWNrU2V0W2ldICYmIGNoZWNrU2V0W2ldLm5vZGVUeXBlID09PSAxICkgewoJCQkJCXJlc3VsdHMucHVzaCggc2V0W2ldICk7CgkJCQl9CgkJCX0KCQl9Cgl9IGVsc2UgewoJCW1ha2VBcnJheSggY2hlY2tTZXQsIHJlc3VsdHMgKTsKCX0KCglpZiAoIGV4dHJhICkgewoJCVNpenpsZSggZXh0cmEsIG9yaWdDb250ZXh0LCByZXN1bHRzLCBzZWVkICk7CgkJU2l6emxlLnVuaXF1ZVNvcnQoIHJlc3VsdHMgKTsKCX0KCglyZXR1cm4gcmVzdWx0czsKfTsKClNpenpsZS51bmlxdWVTb3J0ID0gZnVuY3Rpb24ocmVzdWx0cyl7CglpZiAoIHNvcnRPcmRlciApIHsKCQloYXNEdXBsaWNhdGUgPSBiYXNlSGFzRHVwbGljYXRlOwoJCXJlc3VsdHMuc29ydChzb3J0T3JkZXIpOwoKCQlpZiAoIGhhc0R1cGxpY2F0ZSApIHsKCQkJZm9yICggdmFyIGkgPSAxOyBpIDwgcmVzdWx0cy5sZW5ndGg7IGkrKyApIHsKCQkJCWlmICggcmVzdWx0c1tpXSA9PT0gcmVzdWx0c1tpLTFdICkgewoJCQkJCXJlc3VsdHMuc3BsaWNlKGktLSwgMSk7CgkJCQl9CgkJCX0KCQl9Cgl9CgoJcmV0dXJuIHJlc3VsdHM7Cn07CgpTaXp6bGUubWF0Y2hlcyA9IGZ1bmN0aW9uKGV4cHIsIHNldCl7CglyZXR1cm4gU2l6emxlKGV4cHIsIG51bGwsIG51bGwsIHNldCk7Cn07CgpTaXp6bGUuZmluZCA9IGZ1bmN0aW9uKGV4cHIsIGNvbnRleHQsIGlzWE1MKXsKCXZhciBzZXQsIG1hdGNoOwoKCWlmICggIWV4cHIgKSB7CgkJcmV0dXJuIFtdOwoJfQoKCWZvciAoIHZhciBpID0gMCwgbCA9IEV4cHIub3JkZXIubGVuZ3RoOyBpIDwgbDsgaSsrICkgewoJCXZhciB0eXBlID0gRXhwci5vcmRlcltpXSwgbWF0Y2g7CgkJCgkJaWYgKCAobWF0Y2ggPSBFeHByLmxlZnRNYXRjaFsgdHlwZSBdLmV4ZWMoIGV4cHIgKSkgKSB7CgkJCXZhciBsZWZ0ID0gbWF0Y2hbMV07CgkJCW1hdGNoLnNwbGljZSgxLDEpOwoKCQkJaWYgKCBsZWZ0LnN1YnN0ciggbGVmdC5sZW5ndGggLSAxICkgIT09ICJcXCIgKSB7CgkJCQltYXRjaFsxXSA9IChtYXRjaFsxXSB8fCAiIikucmVwbGFjZSgvXFwvZywgIiIpOwoJCQkJc2V0ID0gRXhwci5maW5kWyB0eXBlIF0oIG1hdGNoLCBjb250ZXh0LCBpc1hNTCApOwoJCQkJaWYgKCBzZXQgIT0gbnVsbCApIHsKCQkJCQlleHByID0gZXhwci5yZXBsYWNlKCBFeHByLm1hdGNoWyB0eXBlIF0sICIiICk7CgkJCQkJYnJlYWs7CgkJCQl9CgkJCX0KCQl9Cgl9CgoJaWYgKCAhc2V0ICkgewoJCXNldCA9IGNvbnRleHQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoIioiKTsKCX0KCglyZXR1cm4ge3NldDogc2V0LCBleHByOiBleHByfTsKfTsKClNpenpsZS5maWx0ZXIgPSBmdW5jdGlvbihleHByLCBzZXQsIGlucGxhY2UsIG5vdCl7Cgl2YXIgb2xkID0gZXhwciwgcmVzdWx0ID0gW10sIGN1ckxvb3AgPSBzZXQsIG1hdGNoLCBhbnlGb3VuZCwKCQlpc1hNTEZpbHRlciA9IHNldCAmJiBzZXRbMF0gJiYgaXNYTUwoc2V0WzBdKTsKCgl3aGlsZSAoIGV4cHIgJiYgc2V0Lmxlbmd0aCApIHsKCQlmb3IgKCB2YXIgdHlwZSBpbiBFeHByLmZpbHRlciApIHsKCQkJaWYgKCAobWF0Y2ggPSBFeHByLmxlZnRNYXRjaFsgdHlwZSBdLmV4ZWMoIGV4cHIgKSkgIT0gbnVsbCAmJiBtYXRjaFsyXSApIHsKCQkJCXZhciBmaWx0ZXIgPSBFeHByLmZpbHRlclsgdHlwZSBdLCBmb3VuZCwgaXRlbSwgbGVmdCA9IG1hdGNoWzFdOwoJCQkJYW55Rm91bmQgPSBmYWxzZTsKCgkJCQltYXRjaC5zcGxpY2UoMSwxKTsKCgkJCQlpZiAoIGxlZnQuc3Vic3RyKCBsZWZ0Lmxlbmd0aCAtIDEgKSA9PT0gIlxcIiApIHsKCQkJCQljb250aW51ZTsKCQkJCX0KCgkJCQlpZiAoIGN1ckxvb3AgPT09IHJlc3VsdCApIHsKCQkJCQlyZXN1bHQgPSBbXTsKCQkJCX0KCgkJCQlpZiAoIEV4cHIucHJlRmlsdGVyWyB0eXBlIF0gKSB7CgkJCQkJbWF0Y2ggPSBFeHByLnByZUZpbHRlclsgdHlwZSBdKCBtYXRjaCwgY3VyTG9vcCwgaW5wbGFjZSwgcmVzdWx0LCBub3QsIGlzWE1MRmlsdGVyICk7CgoJCQkJCWlmICggIW1hdGNoICkgewoJCQkJCQlhbnlGb3VuZCA9IGZvdW5kID0gdHJ1ZTsKCQkJCQl9IGVsc2UgaWYgKCBtYXRjaCA9PT0gdHJ1ZSApIHsKCQkJCQkJY29udGludWU7CgkJCQkJfQoJCQkJfQoKCQkJCWlmICggbWF0Y2ggKSB7CgkJCQkJZm9yICggdmFyIGkgPSAwOyAoaXRlbSA9IGN1ckxvb3BbaV0pICE9IG51bGw7IGkrKyApIHsKCQkJCQkJaWYgKCBpdGVtICkgewoJCQkJCQkJZm91bmQgPSBmaWx0ZXIoIGl0ZW0sIG1hdGNoLCBpLCBjdXJMb29wICk7CgkJCQkJCQl2YXIgcGFzcyA9IG5vdCBeICEhZm91bmQ7CgoJCQkJCQkJaWYgKCBpbnBsYWNlICYmIGZvdW5kICE9IG51bGwgKSB7CgkJCQkJCQkJaWYgKCBwYXNzICkgewoJCQkJCQkJCQlhbnlGb3VuZCA9IHRydWU7CgkJCQkJCQkJfSBlbHNlIHsKCQkJCQkJCQkJY3VyTG9vcFtpXSA9IGZhbHNlOwoJCQkJCQkJCX0KCQkJCQkJCX0gZWxzZSBpZiAoIHBhc3MgKSB7CgkJCQkJCQkJcmVzdWx0LnB1c2goIGl0ZW0gKTsKCQkJCQkJCQlhbnlGb3VuZCA9IHRydWU7CgkJCQkJCQl9CgkJCQkJCX0KCQkJCQl9CgkJCQl9CgoJCQkJaWYgKCBmb3VuZCAhPT0gdW5kZWZpbmVkICkgewoJCQkJCWlmICggIWlucGxhY2UgKSB7CgkJCQkJCWN1ckxvb3AgPSByZXN1bHQ7CgkJCQkJfQoKCQkJCQlleHByID0gZXhwci5yZXBsYWNlKCBFeHByLm1hdGNoWyB0eXBlIF0sICIiICk7CgoJCQkJCWlmICggIWFueUZvdW5kICkgewoJCQkJCQlyZXR1cm4gW107CgkJCQkJfQoKCQkJCQlicmVhazsKCQkJCX0KCQkJfQoJCX0KCgkJLy8gSW1wcm9wZXIgZXhwcmVzc2lvbgoJCWlmICggZXhwciA9PT0gb2xkICkgewoJCQlpZiAoIGFueUZvdW5kID09IG51bGwgKSB7CgkJCQlTaXp6bGUuZXJyb3IoIGV4cHIgKTsKCQkJfSBlbHNlIHsKCQkJCWJyZWFrOwoJCQl9CgkJfQoKCQlvbGQgPSBleHByOwoJfQoKCXJldHVybiBjdXJMb29wOwp9OwoKU2l6emxlLmVycm9yID0gZnVuY3Rpb24oIG1zZyApIHsKCXRocm93ICJTeW50YXggZXJyb3IsIHVucmVjb2duaXplZCBleHByZXNzaW9uOiAiICsgbXNnOwp9OwoKdmFyIEV4cHIgPSBTaXp6bGUuc2VsZWN0b3JzID0gewoJb3JkZXI6IFsgIklEIiwgIk5BTUUiLCAiVEFHIiBdLAoJbWF0Y2g6IHsKCQlJRDogLyMoKD86W1x3XHUwMGMwLVx1RkZGRi1dfFxcLikrKS8sCgkJQ0xBU1M6IC9cLigoPzpbXHdcdTAwYzAtXHVGRkZGLV18XFwuKSspLywKCQlOQU1FOiAvXFtuYW1lPVsnIl0qKCg/Oltcd1x1MDBjMC1cdUZGRkYtXXxcXC4pKylbJyJdKlxdLywKCQlBVFRSOiAvXFtccyooKD86W1x3XHUwMGMwLVx1RkZGRi1dfFxcLikrKVxzKig/OihcUz89KVxzKihbJyJdKikoLio/KVwzfClccypcXS8sCgkJVEFHOiAvXigoPzpbXHdcdTAwYzAtXHVGRkZGXCotXXxcXC4pKykvLAoJCUNISUxEOiAvOihvbmx5fG50aHxsYXN0fGZpcnN0KS1jaGlsZCg/OlwoKGV2ZW58b2RkfFtcZG4rLV0qKVwpKT8vLAoJCVBPUzogLzoobnRofGVxfGd0fGx0fGZpcnN0fGxhc3R8ZXZlbnxvZGQpKD86XCgoXGQqKVwpKT8oPz1bXi1dfCQpLywKCQlQU0VVRE86IC86KCg/Oltcd1x1MDBjMC1cdUZGRkYtXXxcXC4pKykoPzpcKChbJyJdPykoKD86XChbXlwpXStcKXxbXlwoXCldKikrKVwyXCkpPy8KCX0sCglsZWZ0TWF0Y2g6IHt9LAoJYXR0ck1hcDogewoJCSJjbGFzcyI6ICJjbGFzc05hbWUiLAoJCSJmb3IiOiAiaHRtbEZvciIKCX0sCglhdHRySGFuZGxlOiB7CgkJaHJlZjogZnVuY3Rpb24oZWxlbSl7CgkJCXJldHVybiBlbGVtLmdldEF0dHJpYnV0ZSgiaHJlZiIpOwoJCX0KCX0sCglyZWxhdGl2ZTogewoJCSIrIjogZnVuY3Rpb24oY2hlY2tTZXQsIHBhcnQpewoJCQl2YXIgaXNQYXJ0U3RyID0gdHlwZW9mIHBhcnQgPT09ICJzdHJpbmciLAoJCQkJaXNUYWcgPSBpc1BhcnRTdHIgJiYgIS9cVy8udGVzdChwYXJ0KSwKCQkJCWlzUGFydFN0ck5vdFRhZyA9IGlzUGFydFN0ciAmJiAhaXNUYWc7CgoJCQlpZiAoIGlzVGFnICkgewoJCQkJcGFydCA9IHBhcnQudG9Mb3dlckNhc2UoKTsKCQkJfQoKCQkJZm9yICggdmFyIGkgPSAwLCBsID0gY2hlY2tTZXQubGVuZ3RoLCBlbGVtOyBpIDwgbDsgaSsrICkgewoJCQkJaWYgKCAoZWxlbSA9IGNoZWNrU2V0W2ldKSApIHsKCQkJCQl3aGlsZSAoIChlbGVtID0gZWxlbS5wcmV2aW91c1NpYmxpbmcpICYmIGVsZW0ubm9kZVR5cGUgIT09IDEgKSB7fQoKCQkJCQljaGVja1NldFtpXSA9IGlzUGFydFN0ck5vdFRhZyB8fCBlbGVtICYmIGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gcGFydCA/CgkJCQkJCWVsZW0gfHwgZmFsc2UgOgoJCQkJCQllbGVtID09PSBwYXJ0OwoJCQkJfQoJCQl9CgoJCQlpZiAoIGlzUGFydFN0ck5vdFRhZyApIHsKCQkJCVNpenpsZS5maWx0ZXIoIHBhcnQsIGNoZWNrU2V0LCB0cnVlICk7CgkJCX0KCQl9LAoJCSI+IjogZnVuY3Rpb24oY2hlY2tTZXQsIHBhcnQpewoJCQl2YXIgaXNQYXJ0U3RyID0gdHlwZW9mIHBhcnQgPT09ICJzdHJpbmciOwoKCQkJaWYgKCBpc1BhcnRTdHIgJiYgIS9cVy8udGVzdChwYXJ0KSApIHsKCQkJCXBhcnQgPSBwYXJ0LnRvTG93ZXJDYXNlKCk7CgoJCQkJZm9yICggdmFyIGkgPSAwLCBsID0gY2hlY2tTZXQubGVuZ3RoOyBpIDwgbDsgaSsrICkgewoJCQkJCXZhciBlbGVtID0gY2hlY2tTZXRbaV07CgkJCQkJaWYgKCBlbGVtICkgewoJCQkJCQl2YXIgcGFyZW50ID0gZWxlbS5wYXJlbnROb2RlOwoJCQkJCQljaGVja1NldFtpXSA9IHBhcmVudC5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpID09PSBwYXJ0ID8gcGFyZW50IDogZmFsc2U7CgkJCQkJfQoJCQkJfQoJCQl9IGVsc2UgewoJCQkJZm9yICggdmFyIGkgPSAwLCBsID0gY2hlY2tTZXQubGVuZ3RoOyBpIDwgbDsgaSsrICkgewoJCQkJCXZhciBlbGVtID0gY2hlY2tTZXRbaV07CgkJCQkJaWYgKCBlbGVtICkgewoJCQkJCQljaGVja1NldFtpXSA9IGlzUGFydFN0ciA/CgkJCQkJCQllbGVtLnBhcmVudE5vZGUgOgoJCQkJCQkJZWxlbS5wYXJlbnROb2RlID09PSBwYXJ0OwoJCQkJCX0KCQkJCX0KCgkJCQlpZiAoIGlzUGFydFN0ciApIHsKCQkJCQlTaXp6bGUuZmlsdGVyKCBwYXJ0LCBjaGVja1NldCwgdHJ1ZSApOwoJCQkJfQoJCQl9CgkJfSwKCQkiIjogZnVuY3Rpb24oY2hlY2tTZXQsIHBhcnQsIGlzWE1MKXsKCQkJdmFyIGRvbmVOYW1lID0gZG9uZSsrLCBjaGVja0ZuID0gZGlyQ2hlY2s7CgoJCQlpZiAoIHR5cGVvZiBwYXJ0ID09PSAic3RyaW5nIiAmJiAhL1xXLy50ZXN0KHBhcnQpICkgewoJCQkJdmFyIG5vZGVDaGVjayA9IHBhcnQgPSBwYXJ0LnRvTG93ZXJDYXNlKCk7CgkJCQljaGVja0ZuID0gZGlyTm9kZUNoZWNrOwoJCQl9CgoJCQljaGVja0ZuKCJwYXJlbnROb2RlIiwgcGFydCwgZG9uZU5hbWUsIGNoZWNrU2V0LCBub2RlQ2hlY2ssIGlzWE1MKTsKCQl9LAoJCSJ+IjogZnVuY3Rpb24oY2hlY2tTZXQsIHBhcnQsIGlzWE1MKXsKCQkJdmFyIGRvbmVOYW1lID0gZG9uZSsrLCBjaGVja0ZuID0gZGlyQ2hlY2s7CgoJCQlpZiAoIHR5cGVvZiBwYXJ0ID09PSAic3RyaW5nIiAmJiAhL1xXLy50ZXN0KHBhcnQpICkgewoJCQkJdmFyIG5vZGVDaGVjayA9IHBhcnQgPSBwYXJ0LnRvTG93ZXJDYXNlKCk7CgkJCQljaGVja0ZuID0gZGlyTm9kZUNoZWNrOwoJCQl9CgoJCQljaGVja0ZuKCJwcmV2aW91c1NpYmxpbmciLCBwYXJ0LCBkb25lTmFtZSwgY2hlY2tTZXQsIG5vZGVDaGVjaywgaXNYTUwpOwoJCX0KCX0sCglmaW5kOiB7CgkJSUQ6IGZ1bmN0aW9uKG1hdGNoLCBjb250ZXh0LCBpc1hNTCl7CgkJCWlmICggdHlwZW9mIGNvbnRleHQuZ2V0RWxlbWVudEJ5SWQgIT09ICJ1bmRlZmluZWQiICYmICFpc1hNTCApIHsKCQkJCXZhciBtID0gY29udGV4dC5nZXRFbGVtZW50QnlJZChtYXRjaFsxXSk7CgkJCQlyZXR1cm4gbSA/IFttXSA6IFtdOwoJCQl9CgkJfSwKCQlOQU1FOiBmdW5jdGlvbihtYXRjaCwgY29udGV4dCl7CgkJCWlmICggdHlwZW9mIGNvbnRleHQuZ2V0RWxlbWVudHNCeU5hbWUgIT09ICJ1bmRlZmluZWQiICkgewoJCQkJdmFyIHJldCA9IFtdLCByZXN1bHRzID0gY29udGV4dC5nZXRFbGVtZW50c0J5TmFtZShtYXRjaFsxXSk7CgoJCQkJZm9yICggdmFyIGkgPSAwLCBsID0gcmVzdWx0cy5sZW5ndGg7IGkgPCBsOyBpKysgKSB7CgkJCQkJaWYgKCByZXN1bHRzW2ldLmdldEF0dHJpYnV0ZSgibmFtZSIpID09PSBtYXRjaFsxXSApIHsKCQkJCQkJcmV0LnB1c2goIHJlc3VsdHNbaV0gKTsKCQkJCQl9CgkJCQl9CgoJCQkJcmV0dXJuIHJldC5sZW5ndGggPT09IDAgPyBudWxsIDogcmV0OwoJCQl9CgkJfSwKCQlUQUc6IGZ1bmN0aW9uKG1hdGNoLCBjb250ZXh0KXsKCQkJcmV0dXJuIGNvbnRleHQuZ2V0RWxlbWVudHNCeVRhZ05hbWUobWF0Y2hbMV0pOwoJCX0KCX0sCglwcmVGaWx0ZXI6IHsKCQlDTEFTUzogZnVuY3Rpb24obWF0Y2gsIGN1ckxvb3AsIGlucGxhY2UsIHJlc3VsdCwgbm90LCBpc1hNTCl7CgkJCW1hdGNoID0gIiAiICsgbWF0Y2hbMV0ucmVwbGFjZSgvXFwvZywgIiIpICsgIiAiOwoKCQkJaWYgKCBpc1hNTCApIHsKCQkJCXJldHVybiBtYXRjaDsKCQkJfQoKCQkJZm9yICggdmFyIGkgPSAwLCBlbGVtOyAoZWxlbSA9IGN1ckxvb3BbaV0pICE9IG51bGw7IGkrKyApIHsKCQkJCWlmICggZWxlbSApIHsKCQkJCQlpZiAoIG5vdCBeIChlbGVtLmNsYXNzTmFtZSAmJiAoIiAiICsgZWxlbS5jbGFzc05hbWUgKyAiICIpLnJlcGxhY2UoL1tcdFxuXS9nLCAiICIpLmluZGV4T2YobWF0Y2gpID49IDApICkgewoJCQkJCQlpZiAoICFpbnBsYWNlICkgewoJCQkJCQkJcmVzdWx0LnB1c2goIGVsZW0gKTsKCQkJCQkJfQoJCQkJCX0gZWxzZSBpZiAoIGlucGxhY2UgKSB7CgkJCQkJCWN1ckxvb3BbaV0gPSBmYWxzZTsKCQkJCQl9CgkJCQl9CgkJCX0KCgkJCXJldHVybiBmYWxzZTsKCQl9LAoJCUlEOiBmdW5jdGlvbihtYXRjaCl7CgkJCXJldHVybiBtYXRjaFsxXS5yZXBsYWNlKC9cXC9nLCAiIik7CgkJfSwKCQlUQUc6IGZ1bmN0aW9uKG1hdGNoLCBjdXJMb29wKXsKCQkJcmV0dXJuIG1hdGNoWzFdLnRvTG93ZXJDYXNlKCk7CgkJfSwKCQlDSElMRDogZnVuY3Rpb24obWF0Y2gpewoJCQlpZiAoIG1hdGNoWzFdID09PSAibnRoIiApIHsKCQkJCS8vIHBhcnNlIGVxdWF0aW9ucyBsaWtlICdldmVuJywgJ29kZCcsICc1JywgJzJuJywgJzNuKzInLCAnNG4tMScsICctbis2JwoJCQkJdmFyIHRlc3QgPSAvKC0/KShcZCopbigoPzpcK3wtKT9cZCopLy5leGVjKAoJCQkJCW1hdGNoWzJdID09PSAiZXZlbiIgJiYgIjJuIiB8fCBtYXRjaFsyXSA9PT0gIm9kZCIgJiYgIjJuKzEiIHx8CgkJCQkJIS9cRC8udGVzdCggbWF0Y2hbMl0gKSAmJiAiMG4rIiArIG1hdGNoWzJdIHx8IG1hdGNoWzJdKTsKCgkJCQkvLyBjYWxjdWxhdGUgdGhlIG51bWJlcnMgKGZpcnN0KW4rKGxhc3QpIGluY2x1ZGluZyBpZiB0aGV5IGFyZSBuZWdhdGl2ZQoJCQkJbWF0Y2hbMl0gPSAodGVzdFsxXSArICh0ZXN0WzJdIHx8IDEpKSAtIDA7CgkJCQltYXRjaFszXSA9IHRlc3RbM10gLSAwOwoJCQl9CgoJCQkvLyBUT0RPOiBNb3ZlIHRvIG5vcm1hbCBjYWNoaW5nIHN5c3RlbQoJCQltYXRjaFswXSA9IGRvbmUrKzsKCgkJCXJldHVybiBtYXRjaDsKCQl9LAoJCUFUVFI6IGZ1bmN0aW9uKG1hdGNoLCBjdXJMb29wLCBpbnBsYWNlLCByZXN1bHQsIG5vdCwgaXNYTUwpewoJCQl2YXIgbmFtZSA9IG1hdGNoWzFdLnJlcGxhY2UoL1xcL2csICIiKTsKCQkJCgkJCWlmICggIWlzWE1MICYmIEV4cHIuYXR0ck1hcFtuYW1lXSApIHsKCQkJCW1hdGNoWzFdID0gRXhwci5hdHRyTWFwW25hbWVdOwoJCQl9CgoJCQlpZiAoIG1hdGNoWzJdID09PSAifj0iICkgewoJCQkJbWF0Y2hbNF0gPSAiICIgKyBtYXRjaFs0XSArICIgIjsKCQkJfQoKCQkJcmV0dXJuIG1hdGNoOwoJCX0sCgkJUFNFVURPOiBmdW5jdGlvbihtYXRjaCwgY3VyTG9vcCwgaW5wbGFjZSwgcmVzdWx0LCBub3QpewoJCQlpZiAoIG1hdGNoWzFdID09PSAibm90IiApIHsKCQkJCS8vIElmIHdlJ3JlIGRlYWxpbmcgd2l0aCBhIGNvbXBsZXggZXhwcmVzc2lvbiwgb3IgYSBzaW1wbGUgb25lCgkJCQlpZiAoICggY2h1bmtlci5leGVjKG1hdGNoWzNdKSB8fCAiIiApLmxlbmd0aCA+IDEgfHwgL15cdy8udGVzdChtYXRjaFszXSkgKSB7CgkJCQkJbWF0Y2hbM10gPSBTaXp6bGUobWF0Y2hbM10sIG51bGwsIG51bGwsIGN1ckxvb3ApOwoJCQkJfSBlbHNlIHsKCQkJCQl2YXIgcmV0ID0gU2l6emxlLmZpbHRlcihtYXRjaFszXSwgY3VyTG9vcCwgaW5wbGFjZSwgdHJ1ZSBeIG5vdCk7CgkJCQkJaWYgKCAhaW5wbGFjZSApIHsKCQkJCQkJcmVzdWx0LnB1c2guYXBwbHkoIHJlc3VsdCwgcmV0ICk7CgkJCQkJfQoJCQkJCXJldHVybiBmYWxzZTsKCQkJCX0KCQkJfSBlbHNlIGlmICggRXhwci5tYXRjaC5QT1MudGVzdCggbWF0Y2hbMF0gKSB8fCBFeHByLm1hdGNoLkNISUxELnRlc3QoIG1hdGNoWzBdICkgKSB7CgkJCQlyZXR1cm4gdHJ1ZTsKCQkJfQoJCQkKCQkJcmV0dXJuIG1hdGNoOwoJCX0sCgkJUE9TOiBmdW5jdGlvbihtYXRjaCl7CgkJCW1hdGNoLnVuc2hpZnQoIHRydWUgKTsKCQkJcmV0dXJuIG1hdGNoOwoJCX0KCX0sCglmaWx0ZXJzOiB7CgkJZW5hYmxlZDogZnVuY3Rpb24oZWxlbSl7CgkJCXJldHVybiBlbGVtLmRpc2FibGVkID09PSBmYWxzZSAmJiBlbGVtLnR5cGUgIT09ICJoaWRkZW4iOwoJCX0sCgkJZGlzYWJsZWQ6IGZ1bmN0aW9uKGVsZW0pewoJCQlyZXR1cm4gZWxlbS5kaXNhYmxlZCA9PT0gdHJ1ZTsKCQl9LAoJCWNoZWNrZWQ6IGZ1bmN0aW9uKGVsZW0pewoJCQlyZXR1cm4gZWxlbS5jaGVja2VkID09PSB0cnVlOwoJCX0sCgkJc2VsZWN0ZWQ6IGZ1bmN0aW9uKGVsZW0pewoJCQkvLyBBY2Nlc3NpbmcgdGhpcyBwcm9wZXJ0eSBtYWtlcyBzZWxlY3RlZC1ieS1kZWZhdWx0CgkJCS8vIG9wdGlvbnMgaW4gU2FmYXJpIHdvcmsgcHJvcGVybHkKCQkJZWxlbS5wYXJlbnROb2RlLnNlbGVjdGVkSW5kZXg7CgkJCXJldHVybiBlbGVtLnNlbGVjdGVkID09PSB0cnVlOwoJCX0sCgkJcGFyZW50OiBmdW5jdGlvbihlbGVtKXsKCQkJcmV0dXJuICEhZWxlbS5maXJzdENoaWxkOwoJCX0sCgkJZW1wdHk6IGZ1bmN0aW9uKGVsZW0pewoJCQlyZXR1cm4gIWVsZW0uZmlyc3RDaGlsZDsKCQl9LAoJCWhhczogZnVuY3Rpb24oZWxlbSwgaSwgbWF0Y2gpewoJCQlyZXR1cm4gISFTaXp6bGUoIG1hdGNoWzNdLCBlbGVtICkubGVuZ3RoOwoJCX0sCgkJaGVhZGVyOiBmdW5jdGlvbihlbGVtKXsKCQkJcmV0dXJuIC9oXGQvaS50ZXN0KCBlbGVtLm5vZGVOYW1lICk7CgkJfSwKCQl0ZXh0OiBmdW5jdGlvbihlbGVtKXsKCQkJcmV0dXJuICJ0ZXh0IiA9PT0gZWxlbS50eXBlOwoJCX0sCgkJcmFkaW86IGZ1bmN0aW9uKGVsZW0pewoJCQlyZXR1cm4gInJhZGlvIiA9PT0gZWxlbS50eXBlOwoJCX0sCgkJY2hlY2tib3g6IGZ1bmN0aW9uKGVsZW0pewoJCQlyZXR1cm4gImNoZWNrYm94IiA9PT0gZWxlbS50eXBlOwoJCX0sCgkJZmlsZTogZnVuY3Rpb24oZWxlbSl7CgkJCXJldHVybiAiZmlsZSIgPT09IGVsZW0udHlwZTsKCQl9LAoJCXBhc3N3b3JkOiBmdW5jdGlvbihlbGVtKXsKCQkJcmV0dXJuICJwYXNzd29yZCIgPT09IGVsZW0udHlwZTsKCQl9LAoJCXN1Ym1pdDogZnVuY3Rpb24oZWxlbSl7CgkJCXJldHVybiAic3VibWl0IiA9PT0gZWxlbS50eXBlOwoJCX0sCgkJaW1hZ2U6IGZ1bmN0aW9uKGVsZW0pewoJCQlyZXR1cm4gImltYWdlIiA9PT0gZWxlbS50eXBlOwoJCX0sCgkJcmVzZXQ6IGZ1bmN0aW9uKGVsZW0pewoJCQlyZXR1cm4gInJlc2V0IiA9PT0gZWxlbS50eXBlOwoJCX0sCgkJYnV0dG9uOiBmdW5jdGlvbihlbGVtKXsKCQkJcmV0dXJuICJidXR0b24iID09PSBlbGVtLnR5cGUgfHwgZWxlbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpID09PSAiYnV0dG9uIjsKCQl9LAoJCWlucHV0OiBmdW5jdGlvbihlbGVtKXsKCQkJcmV0dXJuIC9pbnB1dHxzZWxlY3R8dGV4dGFyZWF8YnV0dG9uL2kudGVzdChlbGVtLm5vZGVOYW1lKTsKCQl9Cgl9LAoJc2V0RmlsdGVyczogewoJCWZpcnN0OiBmdW5jdGlvbihlbGVtLCBpKXsKCQkJcmV0dXJuIGkgPT09IDA7CgkJfSwKCQlsYXN0OiBmdW5jdGlvbihlbGVtLCBpLCBtYXRjaCwgYXJyYXkpewoJCQlyZXR1cm4gaSA9PT0gYXJyYXkubGVuZ3RoIC0gMTsKCQl9LAoJCWV2ZW46IGZ1bmN0aW9uKGVsZW0sIGkpewoJCQlyZXR1cm4gaSAlIDIgPT09IDA7CgkJfSwKCQlvZGQ6IGZ1bmN0aW9uKGVsZW0sIGkpewoJCQlyZXR1cm4gaSAlIDIgPT09IDE7CgkJfSwKCQlsdDogZnVuY3Rpb24oZWxlbSwgaSwgbWF0Y2gpewoJCQlyZXR1cm4gaSA8IG1hdGNoWzNdIC0gMDsKCQl9LAoJCWd0OiBmdW5jdGlvbihlbGVtLCBpLCBtYXRjaCl7CgkJCXJldHVybiBpID4gbWF0Y2hbM10gLSAwOwoJCX0sCgkJbnRoOiBmdW5jdGlvbihlbGVtLCBpLCBtYXRjaCl7CgkJCXJldHVybiBtYXRjaFszXSAtIDAgPT09IGk7CgkJfSwKCQllcTogZnVuY3Rpb24oZWxlbSwgaSwgbWF0Y2gpewoJCQlyZXR1cm4gbWF0Y2hbM10gLSAwID09PSBpOwoJCX0KCX0sCglmaWx0ZXI6IHsKCQlQU0VVRE86IGZ1bmN0aW9uKGVsZW0sIG1hdGNoLCBpLCBhcnJheSl7CgkJCXZhciBuYW1lID0gbWF0Y2hbMV0sIGZpbHRlciA9IEV4cHIuZmlsdGVyc1sgbmFtZSBdOwoKCQkJaWYgKCBmaWx0ZXIgKSB7CgkJCQlyZXR1cm4gZmlsdGVyKCBlbGVtLCBpLCBtYXRjaCwgYXJyYXkgKTsKCQkJfSBlbHNlIGlmICggbmFtZSA9PT0gImNvbnRhaW5zIiApIHsKCQkJCXJldHVybiAoZWxlbS50ZXh0Q29udGVudCB8fCBlbGVtLmlubmVyVGV4dCB8fCBnZXRUZXh0KFsgZWxlbSBdKSB8fCAiIikuaW5kZXhPZihtYXRjaFszXSkgPj0gMDsKCQkJfSBlbHNlIGlmICggbmFtZSA9PT0gIm5vdCIgKSB7CgkJCQl2YXIgbm90ID0gbWF0Y2hbM107CgoJCQkJZm9yICggdmFyIGkgPSAwLCBsID0gbm90Lmxlbmd0aDsgaSA8IGw7IGkrKyApIHsKCQkJCQlpZiAoIG5vdFtpXSA9PT0gZWxlbSApIHsKCQkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJCX0KCQkJCX0KCgkJCQlyZXR1cm4gdHJ1ZTsKCQkJfSBlbHNlIHsKCQkJCVNpenpsZS5lcnJvciggIlN5bnRheCBlcnJvciwgdW5yZWNvZ25pemVkIGV4cHJlc3Npb246ICIgKyBuYW1lICk7CgkJCX0KCQl9LAoJCUNISUxEOiBmdW5jdGlvbihlbGVtLCBtYXRjaCl7CgkJCXZhciB0eXBlID0gbWF0Y2hbMV0sIG5vZGUgPSBlbGVtOwoJCQlzd2l0Y2ggKHR5cGUpIHsKCQkJCWNhc2UgJ29ubHknOgoJCQkJY2FzZSAnZmlyc3QnOgoJCQkJCXdoaWxlICggKG5vZGUgPSBub2RlLnByZXZpb3VzU2libGluZykgKQkgewoJCQkJCQlpZiAoIG5vZGUubm9kZVR5cGUgPT09IDEgKSB7IAoJCQkJCQkJcmV0dXJuIGZhbHNlOyAKCQkJCQkJfQoJCQkJCX0KCQkJCQlpZiAoIHR5cGUgPT09ICJmaXJzdCIgKSB7IAoJCQkJCQlyZXR1cm4gdHJ1ZTsgCgkJCQkJfQoJCQkJCW5vZGUgPSBlbGVtOwoJCQkJY2FzZSAnbGFzdCc6CgkJCQkJd2hpbGUgKCAobm9kZSA9IG5vZGUubmV4dFNpYmxpbmcpICkJIHsKCQkJCQkJaWYgKCBub2RlLm5vZGVUeXBlID09PSAxICkgeyAKCQkJCQkJCXJldHVybiBmYWxzZTsgCgkJCQkJCX0KCQkJCQl9CgkJCQkJcmV0dXJuIHRydWU7CgkJCQljYXNlICdudGgnOgoJCQkJCXZhciBmaXJzdCA9IG1hdGNoWzJdLCBsYXN0ID0gbWF0Y2hbM107CgoJCQkJCWlmICggZmlyc3QgPT09IDEgJiYgbGFzdCA9PT0gMCApIHsKCQkJCQkJcmV0dXJuIHRydWU7CgkJCQkJfQoJCQkJCQoJCQkJCXZhciBkb25lTmFtZSA9IG1hdGNoWzBdLAoJCQkJCQlwYXJlbnQgPSBlbGVtLnBhcmVudE5vZGU7CgkKCQkJCQlpZiAoIHBhcmVudCAmJiAocGFyZW50LnNpemNhY2hlICE9PSBkb25lTmFtZSB8fCAhZWxlbS5ub2RlSW5kZXgpICkgewoJCQkJCQl2YXIgY291bnQgPSAwOwoJCQkJCQlmb3IgKCBub2RlID0gcGFyZW50LmZpcnN0Q2hpbGQ7IG5vZGU7IG5vZGUgPSBub2RlLm5leHRTaWJsaW5nICkgewoJCQkJCQkJaWYgKCBub2RlLm5vZGVUeXBlID09PSAxICkgewoJCQkJCQkJCW5vZGUubm9kZUluZGV4ID0gKytjb3VudDsKCQkJCQkJCX0KCQkJCQkJfSAKCQkJCQkJcGFyZW50LnNpemNhY2hlID0gZG9uZU5hbWU7CgkJCQkJfQoJCQkJCQoJCQkJCXZhciBkaWZmID0gZWxlbS5ub2RlSW5kZXggLSBsYXN0OwoJCQkJCWlmICggZmlyc3QgPT09IDAgKSB7CgkJCQkJCXJldHVybiBkaWZmID09PSAwOwoJCQkJCX0gZWxzZSB7CgkJCQkJCXJldHVybiAoIGRpZmYgJSBmaXJzdCA9PT0gMCAmJiBkaWZmIC8gZmlyc3QgPj0gMCApOwoJCQkJCX0KCQkJfQoJCX0sCgkJSUQ6IGZ1bmN0aW9uKGVsZW0sIG1hdGNoKXsKCQkJcmV0dXJuIGVsZW0ubm9kZVR5cGUgPT09IDEgJiYgZWxlbS5nZXRBdHRyaWJ1dGUoImlkIikgPT09IG1hdGNoOwoJCX0sCgkJVEFHOiBmdW5jdGlvbihlbGVtLCBtYXRjaCl7CgkJCXJldHVybiAobWF0Y2ggPT09ICIqIiAmJiBlbGVtLm5vZGVUeXBlID09PSAxKSB8fCBlbGVtLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09IG1hdGNoOwoJCX0sCgkJQ0xBU1M6IGZ1bmN0aW9uKGVsZW0sIG1hdGNoKXsKCQkJcmV0dXJuICgiICIgKyAoZWxlbS5jbGFzc05hbWUgfHwgZWxlbS5nZXRBdHRyaWJ1dGUoImNsYXNzIikpICsgIiAiKQoJCQkJLmluZGV4T2YoIG1hdGNoICkgPiAtMTsKCQl9LAoJCUFUVFI6IGZ1bmN0aW9uKGVsZW0sIG1hdGNoKXsKCQkJdmFyIG5hbWUgPSBtYXRjaFsxXSwKCQkJCXJlc3VsdCA9IEV4cHIuYXR0ckhhbmRsZVsgbmFtZSBdID8KCQkJCQlFeHByLmF0dHJIYW5kbGVbIG5hbWUgXSggZWxlbSApIDoKCQkJCQllbGVtWyBuYW1lIF0gIT0gbnVsbCA/CgkJCQkJCWVsZW1bIG5hbWUgXSA6CgkJCQkJCWVsZW0uZ2V0QXR0cmlidXRlKCBuYW1lICksCgkJCQl2YWx1ZSA9IHJlc3VsdCArICIiLAoJCQkJdHlwZSA9IG1hdGNoWzJdLAoJCQkJY2hlY2sgPSBtYXRjaFs0XTsKCgkJCXJldHVybiByZXN1bHQgPT0gbnVsbCA/CgkJCQl0eXBlID09PSAiIT0iIDoKCQkJCXR5cGUgPT09ICI9IiA/CgkJCQl2YWx1ZSA9PT0gY2hlY2sgOgoJCQkJdHlwZSA9PT0gIio9IiA/CgkJCQl2YWx1ZS5pbmRleE9mKGNoZWNrKSA+PSAwIDoKCQkJCXR5cGUgPT09ICJ+PSIgPwoJCQkJKCIgIiArIHZhbHVlICsgIiAiKS5pbmRleE9mKGNoZWNrKSA+PSAwIDoKCQkJCSFjaGVjayA/CgkJCQl2YWx1ZSAmJiByZXN1bHQgIT09IGZhbHNlIDoKCQkJCXR5cGUgPT09ICIhPSIgPwoJCQkJdmFsdWUgIT09IGNoZWNrIDoKCQkJCXR5cGUgPT09ICJePSIgPwoJCQkJdmFsdWUuaW5kZXhPZihjaGVjaykgPT09IDAgOgoJCQkJdHlwZSA9PT0gIiQ9IiA/CgkJCQl2YWx1ZS5zdWJzdHIodmFsdWUubGVuZ3RoIC0gY2hlY2subGVuZ3RoKSA9PT0gY2hlY2sgOgoJCQkJdHlwZSA9PT0gInw9IiA/CgkJCQl2YWx1ZSA9PT0gY2hlY2sgfHwgdmFsdWUuc3Vic3RyKDAsIGNoZWNrLmxlbmd0aCArIDEpID09PSBjaGVjayArICItIiA6CgkJCQlmYWxzZTsKCQl9LAoJCVBPUzogZnVuY3Rpb24oZWxlbSwgbWF0Y2gsIGksIGFycmF5KXsKCQkJdmFyIG5hbWUgPSBtYXRjaFsyXSwgZmlsdGVyID0gRXhwci5zZXRGaWx0ZXJzWyBuYW1lIF07CgoJCQlpZiAoIGZpbHRlciApIHsKCQkJCXJldHVybiBmaWx0ZXIoIGVsZW0sIGksIG1hdGNoLCBhcnJheSApOwoJCQl9CgkJfQoJfQp9OwoKdmFyIG9yaWdQT1MgPSBFeHByLm1hdGNoLlBPUzsKCmZvciAoIHZhciB0eXBlIGluIEV4cHIubWF0Y2ggKSB7CglFeHByLm1hdGNoWyB0eXBlIF0gPSBuZXcgUmVnRXhwKCBFeHByLm1hdGNoWyB0eXBlIF0uc291cmNlICsgLyg/IVteXFtdKlxdKSg/IVteXChdKlwpKS8uc291cmNlICk7CglFeHByLmxlZnRNYXRjaFsgdHlwZSBdID0gbmV3IFJlZ0V4cCggLyheKD86LnxccnxcbikqPykvLnNvdXJjZSArIEV4cHIubWF0Y2hbIHR5cGUgXS5zb3VyY2UucmVwbGFjZSgvXFwoXGQrKS9nLCBmdW5jdGlvbihhbGwsIG51bSl7CgkJcmV0dXJuICJcXCIgKyAobnVtIC0gMCArIDEpOwoJfSkpOwp9Cgp2YXIgbWFrZUFycmF5ID0gZnVuY3Rpb24oYXJyYXksIHJlc3VsdHMpIHsKCWFycmF5ID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoIGFycmF5LCAwICk7CgoJaWYgKCByZXN1bHRzICkgewoJCXJlc3VsdHMucHVzaC5hcHBseSggcmVzdWx0cywgYXJyYXkgKTsKCQlyZXR1cm4gcmVzdWx0czsKCX0KCQoJcmV0dXJuIGFycmF5Owp9OwoKLy8gUGVyZm9ybSBhIHNpbXBsZSBjaGVjayB0byBkZXRlcm1pbmUgaWYgdGhlIGJyb3dzZXIgaXMgY2FwYWJsZSBvZgovLyBjb252ZXJ0aW5nIGEgTm9kZUxpc3QgdG8gYW4gYXJyYXkgdXNpbmcgYnVpbHRpbiBtZXRob2RzLgovLyBBbHNvIHZlcmlmaWVzIHRoYXQgdGhlIHJldHVybmVkIGFycmF5IGhvbGRzIERPTSBub2RlcwovLyAod2hpY2ggaXMgbm90IHRoZSBjYXNlIGluIHRoZSBCbGFja2JlcnJ5IGJyb3dzZXIpCnRyeSB7CglBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbCggZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmNoaWxkTm9kZXMsIDAgKVswXS5ub2RlVHlwZTsKCi8vIFByb3ZpZGUgYSBmYWxsYmFjayBtZXRob2QgaWYgaXQgZG9lcyBub3Qgd29yawp9IGNhdGNoKGUpewoJbWFrZUFycmF5ID0gZnVuY3Rpb24oYXJyYXksIHJlc3VsdHMpIHsKCQl2YXIgcmV0ID0gcmVzdWx0cyB8fCBbXTsKCgkJaWYgKCB0b1N0cmluZy5jYWxsKGFycmF5KSA9PT0gIltvYmplY3QgQXJyYXldIiApIHsKCQkJQXJyYXkucHJvdG90eXBlLnB1c2guYXBwbHkoIHJldCwgYXJyYXkgKTsKCQl9IGVsc2UgewoJCQlpZiAoIHR5cGVvZiBhcnJheS5sZW5ndGggPT09ICJudW1iZXIiICkgewoJCQkJZm9yICggdmFyIGkgPSAwLCBsID0gYXJyYXkubGVuZ3RoOyBpIDwgbDsgaSsrICkgewoJCQkJCXJldC5wdXNoKCBhcnJheVtpXSApOwoJCQkJfQoJCQl9IGVsc2UgewoJCQkJZm9yICggdmFyIGkgPSAwOyBhcnJheVtpXTsgaSsrICkgewoJCQkJCXJldC5wdXNoKCBhcnJheVtpXSApOwoJCQkJfQoJCQl9CgkJfQoKCQlyZXR1cm4gcmV0OwoJfTsKfQoKdmFyIHNvcnRPcmRlcjsKCmlmICggZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uICkgewoJc29ydE9yZGVyID0gZnVuY3Rpb24oIGEsIGIgKSB7CgkJaWYgKCAhYS5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbiB8fCAhYi5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbiApIHsKCQkJaWYgKCBhID09IGIgKSB7CgkJCQloYXNEdXBsaWNhdGUgPSB0cnVlOwoJCQl9CgkJCXJldHVybiBhLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uID8gLTEgOiAxOwoJCX0KCgkJdmFyIHJldCA9IGEuY29tcGFyZURvY3VtZW50UG9zaXRpb24oYikgJiA0ID8gLTEgOiBhID09PSBiID8gMCA6IDE7CgkJaWYgKCByZXQgPT09IDAgKSB7CgkJCWhhc0R1cGxpY2F0ZSA9IHRydWU7CgkJfQoJCXJldHVybiByZXQ7Cgl9Owp9IGVsc2UgaWYgKCAic291cmNlSW5kZXgiIGluIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudCApIHsKCXNvcnRPcmRlciA9IGZ1bmN0aW9uKCBhLCBiICkgewoJCWlmICggIWEuc291cmNlSW5kZXggfHwgIWIuc291cmNlSW5kZXggKSB7CgkJCWlmICggYSA9PSBiICkgewoJCQkJaGFzRHVwbGljYXRlID0gdHJ1ZTsKCQkJfQoJCQlyZXR1cm4gYS5zb3VyY2VJbmRleCA/IC0xIDogMTsKCQl9CgoJCXZhciByZXQgPSBhLnNvdXJjZUluZGV4IC0gYi5zb3VyY2VJbmRleDsKCQlpZiAoIHJldCA9PT0gMCApIHsKCQkJaGFzRHVwbGljYXRlID0gdHJ1ZTsKCQl9CgkJcmV0dXJuIHJldDsKCX07Cn0gZWxzZSBpZiAoIGRvY3VtZW50LmNyZWF0ZVJhbmdlICkgewoJc29ydE9yZGVyID0gZnVuY3Rpb24oIGEsIGIgKSB7CgkJaWYgKCAhYS5vd25lckRvY3VtZW50IHx8ICFiLm93bmVyRG9jdW1lbnQgKSB7CgkJCWlmICggYSA9PSBiICkgewoJCQkJaGFzRHVwbGljYXRlID0gdHJ1ZTsKCQkJfQoJCQlyZXR1cm4gYS5vd25lckRvY3VtZW50ID8gLTEgOiAxOwoJCX0KCgkJdmFyIGFSYW5nZSA9IGEub3duZXJEb2N1bWVudC5jcmVhdGVSYW5nZSgpLCBiUmFuZ2UgPSBiLm93bmVyRG9jdW1lbnQuY3JlYXRlUmFuZ2UoKTsKCQlhUmFuZ2Uuc2V0U3RhcnQoYSwgMCk7CgkJYVJhbmdlLnNldEVuZChhLCAwKTsKCQliUmFuZ2Uuc2V0U3RhcnQoYiwgMCk7CgkJYlJhbmdlLnNldEVuZChiLCAwKTsKCQl2YXIgcmV0ID0gYVJhbmdlLmNvbXBhcmVCb3VuZGFyeVBvaW50cyhSYW5nZS5TVEFSVF9UT19FTkQsIGJSYW5nZSk7CgkJaWYgKCByZXQgPT09IDAgKSB7CgkJCWhhc0R1cGxpY2F0ZSA9IHRydWU7CgkJfQoJCXJldHVybiByZXQ7Cgl9Owp9CgovLyBVdGlsaXR5IGZ1bmN0aW9uIGZvciByZXRyZWl2aW5nIHRoZSB0ZXh0IHZhbHVlIG9mIGFuIGFycmF5IG9mIERPTSBub2RlcwpmdW5jdGlvbiBnZXRUZXh0KCBlbGVtcyApIHsKCXZhciByZXQgPSAiIiwgZWxlbTsKCglmb3IgKCB2YXIgaSA9IDA7IGVsZW1zW2ldOyBpKysgKSB7CgkJZWxlbSA9IGVsZW1zW2ldOwoKCQkvLyBHZXQgdGhlIHRleHQgZnJvbSB0ZXh0IG5vZGVzIGFuZCBDREFUQSBub2RlcwoJCWlmICggZWxlbS5ub2RlVHlwZSA9PT0gMyB8fCBlbGVtLm5vZGVUeXBlID09PSA0ICkgewoJCQlyZXQgKz0gZWxlbS5ub2RlVmFsdWU7CgoJCS8vIFRyYXZlcnNlIGV2ZXJ5dGhpbmcgZWxzZSwgZXhjZXB0IGNvbW1lbnQgbm9kZXMKCQl9IGVsc2UgaWYgKCBlbGVtLm5vZGVUeXBlICE9PSA4ICkgewoJCQlyZXQgKz0gZ2V0VGV4dCggZWxlbS5jaGlsZE5vZGVzICk7CgkJfQoJfQoKCXJldHVybiByZXQ7Cn0KCi8vIENoZWNrIHRvIHNlZSBpZiB0aGUgYnJvd3NlciByZXR1cm5zIGVsZW1lbnRzIGJ5IG5hbWUgd2hlbgovLyBxdWVyeWluZyBieSBnZXRFbGVtZW50QnlJZCAoYW5kIHByb3ZpZGUgYSB3b3JrYXJvdW5kKQooZnVuY3Rpb24oKXsKCS8vIFdlJ3JlIGdvaW5nIHRvIGluamVjdCBhIGZha2UgaW5wdXQgZWxlbWVudCB3aXRoIGEgc3BlY2lmaWVkIG5hbWUKCXZhciBmb3JtID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2IiksCgkJaWQgPSAic2NyaXB0IiArIChuZXcgRGF0ZSkuZ2V0VGltZSgpOwoJZm9ybS5pbm5lckhUTUwgPSAiPGEgbmFtZT0nIiArIGlkICsgIicvPiI7CgoJLy8gSW5qZWN0IGl0IGludG8gdGhlIHJvb3QgZWxlbWVudCwgY2hlY2sgaXRzIHN0YXR1cywgYW5kIHJlbW92ZSBpdCBxdWlja2x5Cgl2YXIgcm9vdCA9IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudDsKCXJvb3QuaW5zZXJ0QmVmb3JlKCBmb3JtLCByb290LmZpcnN0Q2hpbGQgKTsKCgkvLyBUaGUgd29ya2Fyb3VuZCBoYXMgdG8gZG8gYWRkaXRpb25hbCBjaGVja3MgYWZ0ZXIgYSBnZXRFbGVtZW50QnlJZAoJLy8gV2hpY2ggc2xvd3MgdGhpbmdzIGRvd24gZm9yIG90aGVyIGJyb3dzZXJzIChoZW5jZSB0aGUgYnJhbmNoaW5nKQoJaWYgKCBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCggaWQgKSApIHsKCQlFeHByLmZpbmQuSUQgPSBmdW5jdGlvbihtYXRjaCwgY29udGV4dCwgaXNYTUwpewoJCQlpZiAoIHR5cGVvZiBjb250ZXh0LmdldEVsZW1lbnRCeUlkICE9PSAidW5kZWZpbmVkIiAmJiAhaXNYTUwgKSB7CgkJCQl2YXIgbSA9IGNvbnRleHQuZ2V0RWxlbWVudEJ5SWQobWF0Y2hbMV0pOwoJCQkJcmV0dXJuIG0gPyBtLmlkID09PSBtYXRjaFsxXSB8fCB0eXBlb2YgbS5nZXRBdHRyaWJ1dGVOb2RlICE9PSAidW5kZWZpbmVkIiAmJiBtLmdldEF0dHJpYnV0ZU5vZGUoImlkIikubm9kZVZhbHVlID09PSBtYXRjaFsxXSA/IFttXSA6IHVuZGVmaW5lZCA6IFtdOwoJCQl9CgkJfTsKCgkJRXhwci5maWx0ZXIuSUQgPSBmdW5jdGlvbihlbGVtLCBtYXRjaCl7CgkJCXZhciBub2RlID0gdHlwZW9mIGVsZW0uZ2V0QXR0cmlidXRlTm9kZSAhPT0gInVuZGVmaW5lZCIgJiYgZWxlbS5nZXRBdHRyaWJ1dGVOb2RlKCJpZCIpOwoJCQlyZXR1cm4gZWxlbS5ub2RlVHlwZSA9PT0gMSAmJiBub2RlICYmIG5vZGUubm9kZVZhbHVlID09PSBtYXRjaDsKCQl9OwoJfQoKCXJvb3QucmVtb3ZlQ2hpbGQoIGZvcm0gKTsKCXJvb3QgPSBmb3JtID0gbnVsbDsgLy8gcmVsZWFzZSBtZW1vcnkgaW4gSUUKfSkoKTsKCihmdW5jdGlvbigpewoJLy8gQ2hlY2sgdG8gc2VlIGlmIHRoZSBicm93c2VyIHJldHVybnMgb25seSBlbGVtZW50cwoJLy8gd2hlbiBkb2luZyBnZXRFbGVtZW50c0J5VGFnTmFtZSgiKiIpCgoJLy8gQ3JlYXRlIGEgZmFrZSBlbGVtZW50Cgl2YXIgZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CglkaXYuYXBwZW5kQ2hpbGQoIGRvY3VtZW50LmNyZWF0ZUNvbW1lbnQoIiIpICk7CgoJLy8gTWFrZSBzdXJlIG5vIGNvbW1lbnRzIGFyZSBmb3VuZAoJaWYgKCBkaXYuZ2V0RWxlbWVudHNCeVRhZ05hbWUoIioiKS5sZW5ndGggPiAwICkgewoJCUV4cHIuZmluZC5UQUcgPSBmdW5jdGlvbihtYXRjaCwgY29udGV4dCl7CgkJCXZhciByZXN1bHRzID0gY29udGV4dC5nZXRFbGVtZW50c0J5VGFnTmFtZShtYXRjaFsxXSk7CgoJCQkvLyBGaWx0ZXIgb3V0IHBvc3NpYmxlIGNvbW1lbnRzCgkJCWlmICggbWF0Y2hbMV0gPT09ICIqIiApIHsKCQkJCXZhciB0bXAgPSBbXTsKCgkJCQlmb3IgKCB2YXIgaSA9IDA7IHJlc3VsdHNbaV07IGkrKyApIHsKCQkJCQlpZiAoIHJlc3VsdHNbaV0ubm9kZVR5cGUgPT09IDEgKSB7CgkJCQkJCXRtcC5wdXNoKCByZXN1bHRzW2ldICk7CgkJCQkJfQoJCQkJfQoKCQkJCXJlc3VsdHMgPSB0bXA7CgkJCX0KCgkJCXJldHVybiByZXN1bHRzOwoJCX07Cgl9CgoJLy8gQ2hlY2sgdG8gc2VlIGlmIGFuIGF0dHJpYnV0ZSByZXR1cm5zIG5vcm1hbGl6ZWQgaHJlZiBhdHRyaWJ1dGVzCglkaXYuaW5uZXJIVE1MID0gIjxhIGhyZWY9JyMnPjwvYT4iOwoJaWYgKCBkaXYuZmlyc3RDaGlsZCAmJiB0eXBlb2YgZGl2LmZpcnN0Q2hpbGQuZ2V0QXR0cmlidXRlICE9PSAidW5kZWZpbmVkIiAmJgoJCQlkaXYuZmlyc3RDaGlsZC5nZXRBdHRyaWJ1dGUoImhyZWYiKSAhPT0gIiMiICkgewoJCUV4cHIuYXR0ckhhbmRsZS5ocmVmID0gZnVuY3Rpb24oZWxlbSl7CgkJCXJldHVybiBlbGVtLmdldEF0dHJpYnV0ZSgiaHJlZiIsIDIpOwoJCX07Cgl9CgoJZGl2ID0gbnVsbDsgLy8gcmVsZWFzZSBtZW1vcnkgaW4gSUUKfSkoKTsKCmlmICggZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCApIHsKCShmdW5jdGlvbigpewoJCXZhciBvbGRTaXp6bGUgPSBTaXp6bGUsIGRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwoJCWRpdi5pbm5lckhUTUwgPSAiPHAgY2xhc3M9J1RFU1QnPjwvcD4iOwoKCQkvLyBTYWZhcmkgY2FuJ3QgaGFuZGxlIHVwcGVyY2FzZSBvciB1bmljb2RlIGNoYXJhY3RlcnMgd2hlbgoJCS8vIGluIHF1aXJrcyBtb2RlLgoJCWlmICggZGl2LnF1ZXJ5U2VsZWN0b3JBbGwgJiYgZGl2LnF1ZXJ5U2VsZWN0b3JBbGwoIi5URVNUIikubGVuZ3RoID09PSAwICkgewoJCQlyZXR1cm47CgkJfQoJCgkJU2l6emxlID0gZnVuY3Rpb24ocXVlcnksIGNvbnRleHQsIGV4dHJhLCBzZWVkKXsKCQkJY29udGV4dCA9IGNvbnRleHQgfHwgZG9jdW1lbnQ7CgoJCQkvLyBPbmx5IHVzZSBxdWVyeVNlbGVjdG9yQWxsIG9uIG5vbi1YTUwgZG9jdW1lbnRzCgkJCS8vIChJRCBzZWxlY3RvcnMgZG9uJ3Qgd29yayBpbiBub24tSFRNTCBkb2N1bWVudHMpCgkJCWlmICggIXNlZWQgJiYgY29udGV4dC5ub2RlVHlwZSA9PT0gOSAmJiAhaXNYTUwoY29udGV4dCkgKSB7CgkJCQl0cnkgewoJCQkJCXJldHVybiBtYWtlQXJyYXkoIGNvbnRleHQucXVlcnlTZWxlY3RvckFsbChxdWVyeSksIGV4dHJhICk7CgkJCQl9IGNhdGNoKGUpe30KCQkJfQoJCQoJCQlyZXR1cm4gb2xkU2l6emxlKHF1ZXJ5LCBjb250ZXh0LCBleHRyYSwgc2VlZCk7CgkJfTsKCgkJZm9yICggdmFyIHByb3AgaW4gb2xkU2l6emxlICkgewoJCQlTaXp6bGVbIHByb3AgXSA9IG9sZFNpenpsZVsgcHJvcCBdOwoJCX0KCgkJZGl2ID0gbnVsbDsgLy8gcmVsZWFzZSBtZW1vcnkgaW4gSUUKCX0pKCk7Cn0KCihmdW5jdGlvbigpewoJdmFyIGRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwoKCWRpdi5pbm5lckhUTUwgPSAiPGRpdiBjbGFzcz0ndGVzdCBlJz48L2Rpdj48ZGl2IGNsYXNzPSd0ZXN0Jz48L2Rpdj4iOwoKCS8vIE9wZXJhIGNhbid0IGZpbmQgYSBzZWNvbmQgY2xhc3NuYW1lIChpbiA5LjYpCgkvLyBBbHNvLCBtYWtlIHN1cmUgdGhhdCBnZXRFbGVtZW50c0J5Q2xhc3NOYW1lIGFjdHVhbGx5IGV4aXN0cwoJaWYgKCAhZGl2LmdldEVsZW1lbnRzQnlDbGFzc05hbWUgfHwgZGl2LmdldEVsZW1lbnRzQnlDbGFzc05hbWUoImUiKS5sZW5ndGggPT09IDAgKSB7CgkJcmV0dXJuOwoJfQoKCS8vIFNhZmFyaSBjYWNoZXMgY2xhc3MgYXR0cmlidXRlcywgZG9lc24ndCBjYXRjaCBjaGFuZ2VzIChpbiAzLjIpCglkaXYubGFzdENoaWxkLmNsYXNzTmFtZSA9ICJlIjsKCglpZiAoIGRpdi5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKCJlIikubGVuZ3RoID09PSAxICkgewoJCXJldHVybjsKCX0KCQoJRXhwci5vcmRlci5zcGxpY2UoMSwgMCwgIkNMQVNTIik7CglFeHByLmZpbmQuQ0xBU1MgPSBmdW5jdGlvbihtYXRjaCwgY29udGV4dCwgaXNYTUwpIHsKCQlpZiAoIHR5cGVvZiBjb250ZXh0LmdldEVsZW1lbnRzQnlDbGFzc05hbWUgIT09ICJ1bmRlZmluZWQiICYmICFpc1hNTCApIHsKCQkJcmV0dXJuIGNvbnRleHQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZShtYXRjaFsxXSk7CgkJfQoJfTsKCglkaXYgPSBudWxsOyAvLyByZWxlYXNlIG1lbW9yeSBpbiBJRQp9KSgpOwoKZnVuY3Rpb24gZGlyTm9kZUNoZWNrKCBkaXIsIGN1ciwgZG9uZU5hbWUsIGNoZWNrU2V0LCBub2RlQ2hlY2ssIGlzWE1MICkgewoJZm9yICggdmFyIGkgPSAwLCBsID0gY2hlY2tTZXQubGVuZ3RoOyBpIDwgbDsgaSsrICkgewoJCXZhciBlbGVtID0gY2hlY2tTZXRbaV07CgkJaWYgKCBlbGVtICkgewoJCQllbGVtID0gZWxlbVtkaXJdOwoJCQl2YXIgbWF0Y2ggPSBmYWxzZTsKCgkJCXdoaWxlICggZWxlbSApIHsKCQkJCWlmICggZWxlbS5zaXpjYWNoZSA9PT0gZG9uZU5hbWUgKSB7CgkJCQkJbWF0Y2ggPSBjaGVja1NldFtlbGVtLnNpenNldF07CgkJCQkJYnJlYWs7CgkJCQl9CgoJCQkJaWYgKCBlbGVtLm5vZGVUeXBlID09PSAxICYmICFpc1hNTCApewoJCQkJCWVsZW0uc2l6Y2FjaGUgPSBkb25lTmFtZTsKCQkJCQllbGVtLnNpenNldCA9IGk7CgkJCQl9CgoJCQkJaWYgKCBlbGVtLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09IGN1ciApIHsKCQkJCQltYXRjaCA9IGVsZW07CgkJCQkJYnJlYWs7CgkJCQl9CgoJCQkJZWxlbSA9IGVsZW1bZGlyXTsKCQkJfQoKCQkJY2hlY2tTZXRbaV0gPSBtYXRjaDsKCQl9Cgl9Cn0KCmZ1bmN0aW9uIGRpckNoZWNrKCBkaXIsIGN1ciwgZG9uZU5hbWUsIGNoZWNrU2V0LCBub2RlQ2hlY2ssIGlzWE1MICkgewoJZm9yICggdmFyIGkgPSAwLCBsID0gY2hlY2tTZXQubGVuZ3RoOyBpIDwgbDsgaSsrICkgewoJCXZhciBlbGVtID0gY2hlY2tTZXRbaV07CgkJaWYgKCBlbGVtICkgewoJCQllbGVtID0gZWxlbVtkaXJdOwoJCQl2YXIgbWF0Y2ggPSBmYWxzZTsKCgkJCXdoaWxlICggZWxlbSApIHsKCQkJCWlmICggZWxlbS5zaXpjYWNoZSA9PT0gZG9uZU5hbWUgKSB7CgkJCQkJbWF0Y2ggPSBjaGVja1NldFtlbGVtLnNpenNldF07CgkJCQkJYnJlYWs7CgkJCQl9CgoJCQkJaWYgKCBlbGVtLm5vZGVUeXBlID09PSAxICkgewoJCQkJCWlmICggIWlzWE1MICkgewoJCQkJCQllbGVtLnNpemNhY2hlID0gZG9uZU5hbWU7CgkJCQkJCWVsZW0uc2l6c2V0ID0gaTsKCQkJCQl9CgkJCQkJaWYgKCB0eXBlb2YgY3VyICE9PSAic3RyaW5nIiApIHsKCQkJCQkJaWYgKCBlbGVtID09PSBjdXIgKSB7CgkJCQkJCQltYXRjaCA9IHRydWU7CgkJCQkJCQlicmVhazsKCQkJCQkJfQoKCQkJCQl9IGVsc2UgaWYgKCBTaXp6bGUuZmlsdGVyKCBjdXIsIFtlbGVtXSApLmxlbmd0aCA+IDAgKSB7CgkJCQkJCW1hdGNoID0gZWxlbTsKCQkJCQkJYnJlYWs7CgkJCQkJfQoJCQkJfQoKCQkJCWVsZW0gPSBlbGVtW2Rpcl07CgkJCX0KCgkJCWNoZWNrU2V0W2ldID0gbWF0Y2g7CgkJfQoJfQp9Cgp2YXIgY29udGFpbnMgPSBkb2N1bWVudC5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbiA/IGZ1bmN0aW9uKGEsIGIpewoJcmV0dXJuICEhKGEuY29tcGFyZURvY3VtZW50UG9zaXRpb24oYikgJiAxNik7Cn0gOiBmdW5jdGlvbihhLCBiKXsKCXJldHVybiBhICE9PSBiICYmIChhLmNvbnRhaW5zID8gYS5jb250YWlucyhiKSA6IHRydWUpOwp9OwoKdmFyIGlzWE1MID0gZnVuY3Rpb24oZWxlbSl7CgkvLyBkb2N1bWVudEVsZW1lbnQgaXMgdmVyaWZpZWQgZm9yIGNhc2VzIHdoZXJlIGl0IGRvZXNuJ3QgeWV0IGV4aXN0CgkvLyAoc3VjaCBhcyBsb2FkaW5nIGlmcmFtZXMgaW4gSUUgLSAjNDgzMykgCgl2YXIgZG9jdW1lbnRFbGVtZW50ID0gKGVsZW0gPyBlbGVtLm93bmVyRG9jdW1lbnQgfHwgZWxlbSA6IDApLmRvY3VtZW50RWxlbWVudDsKCXJldHVybiBkb2N1bWVudEVsZW1lbnQgPyBkb2N1bWVudEVsZW1lbnQubm9kZU5hbWUgIT09ICJIVE1MIiA6IGZhbHNlOwp9OwoKdmFyIHBvc1Byb2Nlc3MgPSBmdW5jdGlvbihzZWxlY3RvciwgY29udGV4dCl7Cgl2YXIgdG1wU2V0ID0gW10sIGxhdGVyID0gIiIsIG1hdGNoLAoJCXJvb3QgPSBjb250ZXh0Lm5vZGVUeXBlID8gW2NvbnRleHRdIDogY29udGV4dDsKCgkvLyBQb3NpdGlvbiBzZWxlY3RvcnMgbXVzdCBiZSBkb25lIGFmdGVyIHRoZSBmaWx0ZXIKCS8vIEFuZCBzbyBtdXN0IDpub3QocG9zaXRpb25hbCkgc28gd2UgbW92ZSBhbGwgUFNFVURPcyB0byB0aGUgZW5kCgl3aGlsZSAoIChtYXRjaCA9IEV4cHIubWF0Y2guUFNFVURPLmV4ZWMoIHNlbGVjdG9yICkpICkgewoJCWxhdGVyICs9IG1hdGNoWzBdOwoJCXNlbGVjdG9yID0gc2VsZWN0b3IucmVwbGFjZSggRXhwci5tYXRjaC5QU0VVRE8sICIiICk7Cgl9CgoJc2VsZWN0b3IgPSBFeHByLnJlbGF0aXZlW3NlbGVjdG9yXSA/IHNlbGVjdG9yICsgIioiIDogc2VsZWN0b3I7CgoJZm9yICggdmFyIGkgPSAwLCBsID0gcm9vdC5sZW5ndGg7IGkgPCBsOyBpKysgKSB7CgkJU2l6emxlKCBzZWxlY3Rvciwgcm9vdFtpXSwgdG1wU2V0ICk7Cgl9CgoJcmV0dXJuIFNpenpsZS5maWx0ZXIoIGxhdGVyLCB0bXBTZXQgKTsKfTsKCi8vIEVYUE9TRQpqUXVlcnkuZmluZCA9IFNpenpsZTsKalF1ZXJ5LmV4cHIgPSBTaXp6bGUuc2VsZWN0b3JzOwpqUXVlcnkuZXhwclsiOiJdID0galF1ZXJ5LmV4cHIuZmlsdGVyczsKalF1ZXJ5LnVuaXF1ZSA9IFNpenpsZS51bmlxdWVTb3J0OwpqUXVlcnkudGV4dCA9IGdldFRleHQ7CmpRdWVyeS5pc1hNTERvYyA9IGlzWE1MOwpqUXVlcnkuY29udGFpbnMgPSBjb250YWluczsKCnJldHVybjsKCndpbmRvdy5TaXp6bGUgPSBTaXp6bGU7Cgp9KSgpOwp2YXIgcnVudGlsID0gL1VudGlsJC8sCglycGFyZW50c3ByZXYgPSAvXig/OnBhcmVudHN8cHJldlVudGlsfHByZXZBbGwpLywKCS8vIE5vdGU6IFRoaXMgUmVnRXhwIHNob3VsZCBiZSBpbXByb3ZlZCwgb3IgbGlrZWx5IHB1bGxlZCBmcm9tIFNpenpsZQoJcm11bHRpc2VsZWN0b3IgPSAvLC8sCglzbGljZSA9IEFycmF5LnByb3RvdHlwZS5zbGljZTsKCi8vIEltcGxlbWVudCB0aGUgaWRlbnRpY2FsIGZ1bmN0aW9uYWxpdHkgZm9yIGZpbHRlciBhbmQgbm90CnZhciB3aW5ub3cgPSBmdW5jdGlvbiggZWxlbWVudHMsIHF1YWxpZmllciwga2VlcCApIHsKCWlmICggalF1ZXJ5LmlzRnVuY3Rpb24oIHF1YWxpZmllciApICkgewoJCXJldHVybiBqUXVlcnkuZ3JlcChlbGVtZW50cywgZnVuY3Rpb24oIGVsZW0sIGkgKSB7CgkJCXJldHVybiAhIXF1YWxpZmllci5jYWxsKCBlbGVtLCBpLCBlbGVtICkgPT09IGtlZXA7CgkJfSk7CgoJfSBlbHNlIGlmICggcXVhbGlmaWVyLm5vZGVUeXBlICkgewoJCXJldHVybiBqUXVlcnkuZ3JlcChlbGVtZW50cywgZnVuY3Rpb24oIGVsZW0sIGkgKSB7CgkJCXJldHVybiAoZWxlbSA9PT0gcXVhbGlmaWVyKSA9PT0ga2VlcDsKCQl9KTsKCgl9IGVsc2UgaWYgKCB0eXBlb2YgcXVhbGlmaWVyID09PSAic3RyaW5nIiApIHsKCQl2YXIgZmlsdGVyZWQgPSBqUXVlcnkuZ3JlcChlbGVtZW50cywgZnVuY3Rpb24oIGVsZW0gKSB7CgkJCXJldHVybiBlbGVtLm5vZGVUeXBlID09PSAxOwoJCX0pOwoKCQlpZiAoIGlzU2ltcGxlLnRlc3QoIHF1YWxpZmllciApICkgewoJCQlyZXR1cm4galF1ZXJ5LmZpbHRlcihxdWFsaWZpZXIsIGZpbHRlcmVkLCAha2VlcCk7CgkJfSBlbHNlIHsKCQkJcXVhbGlmaWVyID0galF1ZXJ5LmZpbHRlciggcXVhbGlmaWVyLCBmaWx0ZXJlZCApOwoJCX0KCX0KCglyZXR1cm4galF1ZXJ5LmdyZXAoZWxlbWVudHMsIGZ1bmN0aW9uKCBlbGVtLCBpICkgewoJCXJldHVybiAoalF1ZXJ5LmluQXJyYXkoIGVsZW0sIHF1YWxpZmllciApID49IDApID09PSBrZWVwOwoJfSk7Cn07CgpqUXVlcnkuZm4uZXh0ZW5kKHsKCWZpbmQ6IGZ1bmN0aW9uKCBzZWxlY3RvciApIHsKCQl2YXIgcmV0ID0gdGhpcy5wdXNoU3RhY2soICIiLCAiZmluZCIsIHNlbGVjdG9yICksIGxlbmd0aCA9IDA7CgoJCWZvciAoIHZhciBpID0gMCwgbCA9IHRoaXMubGVuZ3RoOyBpIDwgbDsgaSsrICkgewoJCQlsZW5ndGggPSByZXQubGVuZ3RoOwoJCQlqUXVlcnkuZmluZCggc2VsZWN0b3IsIHRoaXNbaV0sIHJldCApOwoKCQkJaWYgKCBpID4gMCApIHsKCQkJCS8vIE1ha2Ugc3VyZSB0aGF0IHRoZSByZXN1bHRzIGFyZSB1bmlxdWUKCQkJCWZvciAoIHZhciBuID0gbGVuZ3RoOyBuIDwgcmV0Lmxlbmd0aDsgbisrICkgewoJCQkJCWZvciAoIHZhciByID0gMDsgciA8IGxlbmd0aDsgcisrICkgewoJCQkJCQlpZiAoIHJldFtyXSA9PT0gcmV0W25dICkgewoJCQkJCQkJcmV0LnNwbGljZShuLS0sIDEpOwoJCQkJCQkJYnJlYWs7CgkJCQkJCX0KCQkJCQl9CgkJCQl9CgkJCX0KCQl9CgoJCXJldHVybiByZXQ7Cgl9LAoKCWhhczogZnVuY3Rpb24oIHRhcmdldCApIHsKCQl2YXIgdGFyZ2V0cyA9IGpRdWVyeSggdGFyZ2V0ICk7CgkJcmV0dXJuIHRoaXMuZmlsdGVyKGZ1bmN0aW9uKCkgewoJCQlmb3IgKCB2YXIgaSA9IDAsIGwgPSB0YXJnZXRzLmxlbmd0aDsgaSA8IGw7IGkrKyApIHsKCQkJCWlmICggalF1ZXJ5LmNvbnRhaW5zKCB0aGlzLCB0YXJnZXRzW2ldICkgKSB7CgkJCQkJcmV0dXJuIHRydWU7CgkJCQl9CgkJCX0KCQl9KTsKCX0sCgoJbm90OiBmdW5jdGlvbiggc2VsZWN0b3IgKSB7CgkJcmV0dXJuIHRoaXMucHVzaFN0YWNrKCB3aW5ub3codGhpcywgc2VsZWN0b3IsIGZhbHNlKSwgIm5vdCIsIHNlbGVjdG9yKTsKCX0sCgoJZmlsdGVyOiBmdW5jdGlvbiggc2VsZWN0b3IgKSB7CgkJcmV0dXJuIHRoaXMucHVzaFN0YWNrKCB3aW5ub3codGhpcywgc2VsZWN0b3IsIHRydWUpLCAiZmlsdGVyIiwgc2VsZWN0b3IgKTsKCX0sCgkKCWlzOiBmdW5jdGlvbiggc2VsZWN0b3IgKSB7CgkJcmV0dXJuICEhc2VsZWN0b3IgJiYgalF1ZXJ5LmZpbHRlciggc2VsZWN0b3IsIHRoaXMgKS5sZW5ndGggPiAwOwoJfSwKCgljbG9zZXN0OiBmdW5jdGlvbiggc2VsZWN0b3JzLCBjb250ZXh0ICkgewoJCWlmICggalF1ZXJ5LmlzQXJyYXkoIHNlbGVjdG9ycyApICkgewoJCQl2YXIgcmV0ID0gW10sIGN1ciA9IHRoaXNbMF0sIG1hdGNoLCBtYXRjaGVzID0ge30sIHNlbGVjdG9yOwoKCQkJaWYgKCBjdXIgJiYgc2VsZWN0b3JzLmxlbmd0aCApIHsKCQkJCWZvciAoIHZhciBpID0gMCwgbCA9IHNlbGVjdG9ycy5sZW5ndGg7IGkgPCBsOyBpKysgKSB7CgkJCQkJc2VsZWN0b3IgPSBzZWxlY3RvcnNbaV07CgoJCQkJCWlmICggIW1hdGNoZXNbc2VsZWN0b3JdICkgewoJCQkJCQltYXRjaGVzW3NlbGVjdG9yXSA9IGpRdWVyeS5leHByLm1hdGNoLlBPUy50ZXN0KCBzZWxlY3RvciApID8gCgkJCQkJCQlqUXVlcnkoIHNlbGVjdG9yLCBjb250ZXh0IHx8IHRoaXMuY29udGV4dCApIDoKCQkJCQkJCXNlbGVjdG9yOwoJCQkJCX0KCQkJCX0KCgkJCQl3aGlsZSAoIGN1ciAmJiBjdXIub3duZXJEb2N1bWVudCAmJiBjdXIgIT09IGNvbnRleHQgKSB7CgkJCQkJZm9yICggc2VsZWN0b3IgaW4gbWF0Y2hlcyApIHsKCQkJCQkJbWF0Y2ggPSBtYXRjaGVzW3NlbGVjdG9yXTsKCgkJCQkJCWlmICggbWF0Y2guanF1ZXJ5ID8gbWF0Y2guaW5kZXgoY3VyKSA+IC0xIDogalF1ZXJ5KGN1cikuaXMobWF0Y2gpICkgewoJCQkJCQkJcmV0LnB1c2goeyBzZWxlY3Rvcjogc2VsZWN0b3IsIGVsZW06IGN1ciB9KTsKCQkJCQkJCWRlbGV0ZSBtYXRjaGVzW3NlbGVjdG9yXTsKCQkJCQkJfQoJCQkJCX0KCQkJCQljdXIgPSBjdXIucGFyZW50Tm9kZTsKCQkJCX0KCQkJfQoKCQkJcmV0dXJuIHJldDsKCQl9CgoJCXZhciBwb3MgPSBqUXVlcnkuZXhwci5tYXRjaC5QT1MudGVzdCggc2VsZWN0b3JzICkgPyAKCQkJalF1ZXJ5KCBzZWxlY3RvcnMsIGNvbnRleHQgfHwgdGhpcy5jb250ZXh0ICkgOiBudWxsOwoKCQlyZXR1cm4gdGhpcy5tYXAoZnVuY3Rpb24oIGksIGN1ciApIHsKCQkJd2hpbGUgKCBjdXIgJiYgY3VyLm93bmVyRG9jdW1lbnQgJiYgY3VyICE9PSBjb250ZXh0ICkgewoJCQkJaWYgKCBwb3MgPyBwb3MuaW5kZXgoY3VyKSA+IC0xIDogalF1ZXJ5KGN1cikuaXMoc2VsZWN0b3JzKSApIHsKCQkJCQlyZXR1cm4gY3VyOwoJCQkJfQoJCQkJY3VyID0gY3VyLnBhcmVudE5vZGU7CgkJCX0KCQkJcmV0dXJuIG51bGw7CgkJfSk7Cgl9LAoJCgkvLyBEZXRlcm1pbmUgdGhlIHBvc2l0aW9uIG9mIGFuIGVsZW1lbnQgd2l0aGluCgkvLyB0aGUgbWF0Y2hlZCBzZXQgb2YgZWxlbWVudHMKCWluZGV4OiBmdW5jdGlvbiggZWxlbSApIHsKCQlpZiAoICFlbGVtIHx8IHR5cGVvZiBlbGVtID09PSAic3RyaW5nIiApIHsKCQkJcmV0dXJuIGpRdWVyeS5pbkFycmF5KCB0aGlzWzBdLAoJCQkJLy8gSWYgaXQgcmVjZWl2ZXMgYSBzdHJpbmcsIHRoZSBzZWxlY3RvciBpcyB1c2VkCgkJCQkvLyBJZiBpdCByZWNlaXZlcyBub3RoaW5nLCB0aGUgc2libGluZ3MgYXJlIHVzZWQKCQkJCWVsZW0gPyBqUXVlcnkoIGVsZW0gKSA6IHRoaXMucGFyZW50KCkuY2hpbGRyZW4oKSApOwoJCX0KCQkvLyBMb2NhdGUgdGhlIHBvc2l0aW9uIG9mIHRoZSBkZXNpcmVkIGVsZW1lbnQKCQlyZXR1cm4galF1ZXJ5LmluQXJyYXkoCgkJCS8vIElmIGl0IHJlY2VpdmVzIGEgalF1ZXJ5IG9iamVjdCwgdGhlIGZpcnN0IGVsZW1lbnQgaXMgdXNlZAoJCQllbGVtLmpxdWVyeSA/IGVsZW1bMF0gOiBlbGVtLCB0aGlzICk7Cgl9LAoKCWFkZDogZnVuY3Rpb24oIHNlbGVjdG9yLCBjb250ZXh0ICkgewoJCXZhciBzZXQgPSB0eXBlb2Ygc2VsZWN0b3IgPT09ICJzdHJpbmciID8KCQkJCWpRdWVyeSggc2VsZWN0b3IsIGNvbnRleHQgfHwgdGhpcy5jb250ZXh0ICkgOgoJCQkJalF1ZXJ5Lm1ha2VBcnJheSggc2VsZWN0b3IgKSwKCQkJYWxsID0galF1ZXJ5Lm1lcmdlKCB0aGlzLmdldCgpLCBzZXQgKTsKCgkJcmV0dXJuIHRoaXMucHVzaFN0YWNrKCBpc0Rpc2Nvbm5lY3RlZCggc2V0WzBdICkgfHwgaXNEaXNjb25uZWN0ZWQoIGFsbFswXSApID8KCQkJYWxsIDoKCQkJalF1ZXJ5LnVuaXF1ZSggYWxsICkgKTsKCX0sCgoJYW5kU2VsZjogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuYWRkKCB0aGlzLnByZXZPYmplY3QgKTsKCX0KfSk7CgovLyBBIHBhaW5mdWxseSBzaW1wbGUgY2hlY2sgdG8gc2VlIGlmIGFuIGVsZW1lbnQgaXMgZGlzY29ubmVjdGVkCi8vIGZyb20gYSBkb2N1bWVudCAoc2hvdWxkIGJlIGltcHJvdmVkLCB3aGVyZSBmZWFzaWJsZSkuCmZ1bmN0aW9uIGlzRGlzY29ubmVjdGVkKCBub2RlICkgewoJcmV0dXJuICFub2RlIHx8ICFub2RlLnBhcmVudE5vZGUgfHwgbm9kZS5wYXJlbnROb2RlLm5vZGVUeXBlID09PSAxMTsKfQoKalF1ZXJ5LmVhY2goewoJcGFyZW50OiBmdW5jdGlvbiggZWxlbSApIHsKCQl2YXIgcGFyZW50ID0gZWxlbS5wYXJlbnROb2RlOwoJCXJldHVybiBwYXJlbnQgJiYgcGFyZW50Lm5vZGVUeXBlICE9PSAxMSA/IHBhcmVudCA6IG51bGw7Cgl9LAoJcGFyZW50czogZnVuY3Rpb24oIGVsZW0gKSB7CgkJcmV0dXJuIGpRdWVyeS5kaXIoIGVsZW0sICJwYXJlbnROb2RlIiApOwoJfSwKCXBhcmVudHNVbnRpbDogZnVuY3Rpb24oIGVsZW0sIGksIHVudGlsICkgewoJCXJldHVybiBqUXVlcnkuZGlyKCBlbGVtLCAicGFyZW50Tm9kZSIsIHVudGlsICk7Cgl9LAoJbmV4dDogZnVuY3Rpb24oIGVsZW0gKSB7CgkJcmV0dXJuIGpRdWVyeS5udGgoIGVsZW0sIDIsICJuZXh0U2libGluZyIgKTsKCX0sCglwcmV2OiBmdW5jdGlvbiggZWxlbSApIHsKCQlyZXR1cm4galF1ZXJ5Lm50aCggZWxlbSwgMiwgInByZXZpb3VzU2libGluZyIgKTsKCX0sCgluZXh0QWxsOiBmdW5jdGlvbiggZWxlbSApIHsKCQlyZXR1cm4galF1ZXJ5LmRpciggZWxlbSwgIm5leHRTaWJsaW5nIiApOwoJfSwKCXByZXZBbGw6IGZ1bmN0aW9uKCBlbGVtICkgewoJCXJldHVybiBqUXVlcnkuZGlyKCBlbGVtLCAicHJldmlvdXNTaWJsaW5nIiApOwoJfSwKCW5leHRVbnRpbDogZnVuY3Rpb24oIGVsZW0sIGksIHVudGlsICkgewoJCXJldHVybiBqUXVlcnkuZGlyKCBlbGVtLCAibmV4dFNpYmxpbmciLCB1bnRpbCApOwoJfSwKCXByZXZVbnRpbDogZnVuY3Rpb24oIGVsZW0sIGksIHVudGlsICkgewoJCXJldHVybiBqUXVlcnkuZGlyKCBlbGVtLCAicHJldmlvdXNTaWJsaW5nIiwgdW50aWwgKTsKCX0sCglzaWJsaW5nczogZnVuY3Rpb24oIGVsZW0gKSB7CgkJcmV0dXJuIGpRdWVyeS5zaWJsaW5nKCBlbGVtLnBhcmVudE5vZGUuZmlyc3RDaGlsZCwgZWxlbSApOwoJfSwKCWNoaWxkcmVuOiBmdW5jdGlvbiggZWxlbSApIHsKCQlyZXR1cm4galF1ZXJ5LnNpYmxpbmcoIGVsZW0uZmlyc3RDaGlsZCApOwoJfSwKCWNvbnRlbnRzOiBmdW5jdGlvbiggZWxlbSApIHsKCQlyZXR1cm4galF1ZXJ5Lm5vZGVOYW1lKCBlbGVtLCAiaWZyYW1lIiApID8KCQkJZWxlbS5jb250ZW50RG9jdW1lbnQgfHwgZWxlbS5jb250ZW50V2luZG93LmRvY3VtZW50IDoKCQkJalF1ZXJ5Lm1ha2VBcnJheSggZWxlbS5jaGlsZE5vZGVzICk7Cgl9Cn0sIGZ1bmN0aW9uKCBuYW1lLCBmbiApIHsKCWpRdWVyeS5mblsgbmFtZSBdID0gZnVuY3Rpb24oIHVudGlsLCBzZWxlY3RvciApIHsKCQl2YXIgcmV0ID0galF1ZXJ5Lm1hcCggdGhpcywgZm4sIHVudGlsICk7CgkJCgkJaWYgKCAhcnVudGlsLnRlc3QoIG5hbWUgKSApIHsKCQkJc2VsZWN0b3IgPSB1bnRpbDsKCQl9CgoJCWlmICggc2VsZWN0b3IgJiYgdHlwZW9mIHNlbGVjdG9yID09PSAic3RyaW5nIiApIHsKCQkJcmV0ID0galF1ZXJ5LmZpbHRlciggc2VsZWN0b3IsIHJldCApOwoJCX0KCgkJcmV0ID0gdGhpcy5sZW5ndGggPiAxID8galF1ZXJ5LnVuaXF1ZSggcmV0ICkgOiByZXQ7CgoJCWlmICggKHRoaXMubGVuZ3RoID4gMSB8fCBybXVsdGlzZWxlY3Rvci50ZXN0KCBzZWxlY3RvciApKSAmJiBycGFyZW50c3ByZXYudGVzdCggbmFtZSApICkgewoJCQlyZXQgPSByZXQucmV2ZXJzZSgpOwoJCX0KCgkJcmV0dXJuIHRoaXMucHVzaFN0YWNrKCByZXQsIG5hbWUsIHNsaWNlLmNhbGwoYXJndW1lbnRzKS5qb2luKCIsIikgKTsKCX07Cn0pOwoKalF1ZXJ5LmV4dGVuZCh7CglmaWx0ZXI6IGZ1bmN0aW9uKCBleHByLCBlbGVtcywgbm90ICkgewoJCWlmICggbm90ICkgewoJCQlleHByID0gIjpub3QoIiArIGV4cHIgKyAiKSI7CgkJfQoKCQlyZXR1cm4galF1ZXJ5LmZpbmQubWF0Y2hlcyhleHByLCBlbGVtcyk7Cgl9LAoJCglkaXI6IGZ1bmN0aW9uKCBlbGVtLCBkaXIsIHVudGlsICkgewoJCXZhciBtYXRjaGVkID0gW10sIGN1ciA9IGVsZW1bZGlyXTsKCQl3aGlsZSAoIGN1ciAmJiBjdXIubm9kZVR5cGUgIT09IDkgJiYgKHVudGlsID09PSB1bmRlZmluZWQgfHwgY3VyLm5vZGVUeXBlICE9PSAxIHx8ICFqUXVlcnkoIGN1ciApLmlzKCB1bnRpbCApKSApIHsKCQkJaWYgKCBjdXIubm9kZVR5cGUgPT09IDEgKSB7CgkJCQltYXRjaGVkLnB1c2goIGN1ciApOwoJCQl9CgkJCWN1ciA9IGN1cltkaXJdOwoJCX0KCQlyZXR1cm4gbWF0Y2hlZDsKCX0sCgoJbnRoOiBmdW5jdGlvbiggY3VyLCByZXN1bHQsIGRpciwgZWxlbSApIHsKCQlyZXN1bHQgPSByZXN1bHQgfHwgMTsKCQl2YXIgbnVtID0gMDsKCgkJZm9yICggOyBjdXI7IGN1ciA9IGN1cltkaXJdICkgewoJCQlpZiAoIGN1ci5ub2RlVHlwZSA9PT0gMSAmJiArK251bSA9PT0gcmVzdWx0ICkgewoJCQkJYnJlYWs7CgkJCX0KCQl9CgoJCXJldHVybiBjdXI7Cgl9LAoKCXNpYmxpbmc6IGZ1bmN0aW9uKCBuLCBlbGVtICkgewoJCXZhciByID0gW107CgoJCWZvciAoIDsgbjsgbiA9IG4ubmV4dFNpYmxpbmcgKSB7CgkJCWlmICggbi5ub2RlVHlwZSA9PT0gMSAmJiBuICE9PSBlbGVtICkgewoJCQkJci5wdXNoKCBuICk7CgkJCX0KCQl9CgoJCXJldHVybiByOwoJfQp9KTsKdmFyIHJpbmxpbmVqUXVlcnkgPSAvIGpRdWVyeVxkKz0iKD86XGQrfG51bGwpIi9nLAoJcmxlYWRpbmdXaGl0ZXNwYWNlID0gL15ccysvLAoJcnhodG1sVGFnID0gLyg8KFtcdzpdKylbXj5dKj8pXC8+L2csCglyc2VsZkNsb3NpbmcgPSAvXig/OmFyZWF8YnJ8Y29sfGVtYmVkfGhyfGltZ3xpbnB1dHxsaW5rfG1ldGF8cGFyYW0pJC9pLAoJcnRhZ05hbWUgPSAvPChbXHc6XSspLywKCXJ0Ym9keSA9IC88dGJvZHkvaSwKCXJodG1sID0gLzx8JiM/XHcrOy8sCglybm9jYWNoZSA9IC88c2NyaXB0fDxvYmplY3R8PGVtYmVkfDxvcHRpb258PHN0eWxlL2ksCglyY2hlY2tlZCA9IC9jaGVja2VkXHMqKD86W149XXw9XHMqLmNoZWNrZWQuKS9pLCAgLy8gY2hlY2tlZD0iY2hlY2tlZCIgb3IgY2hlY2tlZCAoaHRtbDUpCglmY2xvc2VUYWcgPSBmdW5jdGlvbiggYWxsLCBmcm9udCwgdGFnICkgewoJCXJldHVybiByc2VsZkNsb3NpbmcudGVzdCggdGFnICkgPwoJCQlhbGwgOgoJCQlmcm9udCArICI+PC8iICsgdGFnICsgIj4iOwoJfSwKCXdyYXBNYXAgPSB7CgkJb3B0aW9uOiBbIDEsICI8c2VsZWN0IG11bHRpcGxlPSdtdWx0aXBsZSc+IiwgIjwvc2VsZWN0PiIgXSwKCQlsZWdlbmQ6IFsgMSwgIjxmaWVsZHNldD4iLCAiPC9maWVsZHNldD4iIF0sCgkJdGhlYWQ6IFsgMSwgIjx0YWJsZT4iLCAiPC90YWJsZT4iIF0sCgkJdHI6IFsgMiwgIjx0YWJsZT48dGJvZHk+IiwgIjwvdGJvZHk+PC90YWJsZT4iIF0sCgkJdGQ6IFsgMywgIjx0YWJsZT48dGJvZHk+PHRyPiIsICI8L3RyPjwvdGJvZHk+PC90YWJsZT4iIF0sCgkJY29sOiBbIDIsICI8dGFibGU+PHRib2R5PjwvdGJvZHk+PGNvbGdyb3VwPiIsICI8L2NvbGdyb3VwPjwvdGFibGU+IiBdLAoJCWFyZWE6IFsgMSwgIjxtYXA+IiwgIjwvbWFwPiIgXSwKCQlfZGVmYXVsdDogWyAwLCAiIiwgIiIgXQoJfTsKCndyYXBNYXAub3B0Z3JvdXAgPSB3cmFwTWFwLm9wdGlvbjsKd3JhcE1hcC50Ym9keSA9IHdyYXBNYXAudGZvb3QgPSB3cmFwTWFwLmNvbGdyb3VwID0gd3JhcE1hcC5jYXB0aW9uID0gd3JhcE1hcC50aGVhZDsKd3JhcE1hcC50aCA9IHdyYXBNYXAudGQ7CgovLyBJRSBjYW4ndCBzZXJpYWxpemUgPGxpbms+IGFuZCA8c2NyaXB0PiB0YWdzIG5vcm1hbGx5CmlmICggIWpRdWVyeS5zdXBwb3J0Lmh0bWxTZXJpYWxpemUgKSB7Cgl3cmFwTWFwLl9kZWZhdWx0ID0gWyAxLCAiZGl2PGRpdj4iLCAiPC9kaXY+IiBdOwp9CgpqUXVlcnkuZm4uZXh0ZW5kKHsKCXRleHQ6IGZ1bmN0aW9uKCB0ZXh0ICkgewoJCWlmICggalF1ZXJ5LmlzRnVuY3Rpb24odGV4dCkgKSB7CgkJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oaSkgewoJCQkJdmFyIHNlbGYgPSBqUXVlcnkodGhpcyk7CgkJCQlzZWxmLnRleHQoIHRleHQuY2FsbCh0aGlzLCBpLCBzZWxmLnRleHQoKSkgKTsKCQkJfSk7CgkJfQoKCQlpZiAoIHR5cGVvZiB0ZXh0ICE9PSAib2JqZWN0IiAmJiB0ZXh0ICE9PSB1bmRlZmluZWQgKSB7CgkJCXJldHVybiB0aGlzLmVtcHR5KCkuYXBwZW5kKCAodGhpc1swXSAmJiB0aGlzWzBdLm93bmVyRG9jdW1lbnQgfHwgZG9jdW1lbnQpLmNyZWF0ZVRleHROb2RlKCB0ZXh0ICkgKTsKCQl9CgoJCXJldHVybiBqUXVlcnkudGV4dCggdGhpcyApOwoJfSwKCgl3cmFwQWxsOiBmdW5jdGlvbiggaHRtbCApIHsKCQlpZiAoIGpRdWVyeS5pc0Z1bmN0aW9uKCBodG1sICkgKSB7CgkJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oaSkgewoJCQkJalF1ZXJ5KHRoaXMpLndyYXBBbGwoIGh0bWwuY2FsbCh0aGlzLCBpKSApOwoJCQl9KTsKCQl9CgoJCWlmICggdGhpc1swXSApIHsKCQkJLy8gVGhlIGVsZW1lbnRzIHRvIHdyYXAgdGhlIHRhcmdldCBhcm91bmQKCQkJdmFyIHdyYXAgPSBqUXVlcnkoIGh0bWwsIHRoaXNbMF0ub3duZXJEb2N1bWVudCApLmVxKDApLmNsb25lKHRydWUpOwoKCQkJaWYgKCB0aGlzWzBdLnBhcmVudE5vZGUgKSB7CgkJCQl3cmFwLmluc2VydEJlZm9yZSggdGhpc1swXSApOwoJCQl9CgoJCQl3cmFwLm1hcChmdW5jdGlvbigpIHsKCQkJCXZhciBlbGVtID0gdGhpczsKCgkJCQl3aGlsZSAoIGVsZW0uZmlyc3RDaGlsZCAmJiBlbGVtLmZpcnN0Q2hpbGQubm9kZVR5cGUgPT09IDEgKSB7CgkJCQkJZWxlbSA9IGVsZW0uZmlyc3RDaGlsZDsKCQkJCX0KCgkJCQlyZXR1cm4gZWxlbTsKCQkJfSkuYXBwZW5kKHRoaXMpOwoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9LAoKCXdyYXBJbm5lcjogZnVuY3Rpb24oIGh0bWwgKSB7CgkJaWYgKCBqUXVlcnkuaXNGdW5jdGlvbiggaHRtbCApICkgewoJCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKGkpIHsKCQkJCWpRdWVyeSh0aGlzKS53cmFwSW5uZXIoIGh0bWwuY2FsbCh0aGlzLCBpKSApOwoJCQl9KTsKCQl9CgoJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgkJCXZhciBzZWxmID0galF1ZXJ5KCB0aGlzICksIGNvbnRlbnRzID0gc2VsZi5jb250ZW50cygpOwoKCQkJaWYgKCBjb250ZW50cy5sZW5ndGggKSB7CgkJCQljb250ZW50cy53cmFwQWxsKCBodG1sICk7CgoJCQl9IGVsc2UgewoJCQkJc2VsZi5hcHBlbmQoIGh0bWwgKTsKCQkJfQoJCX0pOwoJfSwKCgl3cmFwOiBmdW5jdGlvbiggaHRtbCApIHsKCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQlqUXVlcnkoIHRoaXMgKS53cmFwQWxsKCBodG1sICk7CgkJfSk7Cgl9LAoKCXVud3JhcDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMucGFyZW50KCkuZWFjaChmdW5jdGlvbigpIHsKCQkJaWYgKCAhalF1ZXJ5Lm5vZGVOYW1lKCB0aGlzLCAiYm9keSIgKSApIHsKCQkJCWpRdWVyeSggdGhpcyApLnJlcGxhY2VXaXRoKCB0aGlzLmNoaWxkTm9kZXMgKTsKCQkJfQoJCX0pLmVuZCgpOwoJfSwKCglhcHBlbmQ6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLmRvbU1hbmlwKGFyZ3VtZW50cywgdHJ1ZSwgZnVuY3Rpb24oIGVsZW0gKSB7CgkJCWlmICggdGhpcy5ub2RlVHlwZSA9PT0gMSApIHsKCQkJCXRoaXMuYXBwZW5kQ2hpbGQoIGVsZW0gKTsKCQkJfQoJCX0pOwoJfSwKCglwcmVwZW5kOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5kb21NYW5pcChhcmd1bWVudHMsIHRydWUsIGZ1bmN0aW9uKCBlbGVtICkgewoJCQlpZiAoIHRoaXMubm9kZVR5cGUgPT09IDEgKSB7CgkJCQl0aGlzLmluc2VydEJlZm9yZSggZWxlbSwgdGhpcy5maXJzdENoaWxkICk7CgkJCX0KCQl9KTsKCX0sCgoJYmVmb3JlOiBmdW5jdGlvbigpIHsKCQlpZiAoIHRoaXNbMF0gJiYgdGhpc1swXS5wYXJlbnROb2RlICkgewoJCQlyZXR1cm4gdGhpcy5kb21NYW5pcChhcmd1bWVudHMsIGZhbHNlLCBmdW5jdGlvbiggZWxlbSApIHsKCQkJCXRoaXMucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUoIGVsZW0sIHRoaXMgKTsKCQkJfSk7CgkJfSBlbHNlIGlmICggYXJndW1lbnRzLmxlbmd0aCApIHsKCQkJdmFyIHNldCA9IGpRdWVyeShhcmd1bWVudHNbMF0pOwoJCQlzZXQucHVzaC5hcHBseSggc2V0LCB0aGlzLnRvQXJyYXkoKSApOwoJCQlyZXR1cm4gdGhpcy5wdXNoU3RhY2soIHNldCwgImJlZm9yZSIsIGFyZ3VtZW50cyApOwoJCX0KCX0sCgoJYWZ0ZXI6IGZ1bmN0aW9uKCkgewoJCWlmICggdGhpc1swXSAmJiB0aGlzWzBdLnBhcmVudE5vZGUgKSB7CgkJCXJldHVybiB0aGlzLmRvbU1hbmlwKGFyZ3VtZW50cywgZmFsc2UsIGZ1bmN0aW9uKCBlbGVtICkgewoJCQkJdGhpcy5wYXJlbnROb2RlLmluc2VydEJlZm9yZSggZWxlbSwgdGhpcy5uZXh0U2libGluZyApOwoJCQl9KTsKCQl9IGVsc2UgaWYgKCBhcmd1bWVudHMubGVuZ3RoICkgewoJCQl2YXIgc2V0ID0gdGhpcy5wdXNoU3RhY2soIHRoaXMsICJhZnRlciIsIGFyZ3VtZW50cyApOwoJCQlzZXQucHVzaC5hcHBseSggc2V0LCBqUXVlcnkoYXJndW1lbnRzWzBdKS50b0FycmF5KCkgKTsKCQkJcmV0dXJuIHNldDsKCQl9Cgl9LAoJCgkvLyBrZWVwRGF0YSBpcyBmb3IgaW50ZXJuYWwgdXNlIG9ubHktLWRvIG5vdCBkb2N1bWVudAoJcmVtb3ZlOiBmdW5jdGlvbiggc2VsZWN0b3IsIGtlZXBEYXRhICkgewoJCWZvciAoIHZhciBpID0gMCwgZWxlbTsgKGVsZW0gPSB0aGlzW2ldKSAhPSBudWxsOyBpKysgKSB7CgkJCWlmICggIXNlbGVjdG9yIHx8IGpRdWVyeS5maWx0ZXIoIHNlbGVjdG9yLCBbIGVsZW0gXSApLmxlbmd0aCApIHsKCQkJCWlmICggIWtlZXBEYXRhICYmIGVsZW0ubm9kZVR5cGUgPT09IDEgKSB7CgkJCQkJalF1ZXJ5LmNsZWFuRGF0YSggZWxlbS5nZXRFbGVtZW50c0J5VGFnTmFtZSgiKiIpICk7CgkJCQkJalF1ZXJ5LmNsZWFuRGF0YSggWyBlbGVtIF0gKTsKCQkJCX0KCgkJCQlpZiAoIGVsZW0ucGFyZW50Tm9kZSApIHsKCQkJCQkgZWxlbS5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKCBlbGVtICk7CgkJCQl9CgkJCX0KCQl9CgkJCgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWVtcHR5OiBmdW5jdGlvbigpIHsKCQlmb3IgKCB2YXIgaSA9IDAsIGVsZW07IChlbGVtID0gdGhpc1tpXSkgIT0gbnVsbDsgaSsrICkgewoJCQkvLyBSZW1vdmUgZWxlbWVudCBub2RlcyBhbmQgcHJldmVudCBtZW1vcnkgbGVha3MKCQkJaWYgKCBlbGVtLm5vZGVUeXBlID09PSAxICkgewoJCQkJalF1ZXJ5LmNsZWFuRGF0YSggZWxlbS5nZXRFbGVtZW50c0J5VGFnTmFtZSgiKiIpICk7CgkJCX0KCgkJCS8vIFJlbW92ZSBhbnkgcmVtYWluaW5nIG5vZGVzCgkJCXdoaWxlICggZWxlbS5maXJzdENoaWxkICkgewoJCQkJZWxlbS5yZW1vdmVDaGlsZCggZWxlbS5maXJzdENoaWxkICk7CgkJCX0KCQl9CgkJCgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWNsb25lOiBmdW5jdGlvbiggZXZlbnRzICkgewoJCS8vIERvIHRoZSBjbG9uZQoJCXZhciByZXQgPSB0aGlzLm1hcChmdW5jdGlvbigpIHsKCQkJaWYgKCAhalF1ZXJ5LnN1cHBvcnQubm9DbG9uZUV2ZW50ICYmICFqUXVlcnkuaXNYTUxEb2ModGhpcykgKSB7CgkJCQkvLyBJRSBjb3BpZXMgZXZlbnRzIGJvdW5kIHZpYSBhdHRhY2hFdmVudCB3aGVuCgkJCQkvLyB1c2luZyBjbG9uZU5vZGUuIENhbGxpbmcgZGV0YWNoRXZlbnQgb24gdGhlCgkJCQkvLyBjbG9uZSB3aWxsIGFsc28gcmVtb3ZlIHRoZSBldmVudHMgZnJvbSB0aGUgb3JpZ25hbAoJCQkJLy8gSW4gb3JkZXIgdG8gZ2V0IGFyb3VuZCB0aGlzLCB3ZSB1c2UgaW5uZXJIVE1MLgoJCQkJLy8gVW5mb3J0dW5hdGVseSwgdGhpcyBtZWFucyBzb21lIG1vZGlmaWNhdGlvbnMgdG8KCQkJCS8vIGF0dHJpYnV0ZXMgaW4gSUUgdGhhdCBhcmUgYWN0dWFsbHkgb25seSBzdG9yZWQKCQkJCS8vIGFzIHByb3BlcnRpZXMgd2lsbCBub3QgYmUgY29waWVkIChzdWNoIGFzIHRoZQoJCQkJLy8gdGhlIG5hbWUgYXR0cmlidXRlIG9uIGFuIGlucHV0KS4KCQkJCXZhciBodG1sID0gdGhpcy5vdXRlckhUTUwsIG93bmVyRG9jdW1lbnQgPSB0aGlzLm93bmVyRG9jdW1lbnQ7CgkJCQlpZiAoICFodG1sICkgewoJCQkJCXZhciBkaXYgPSBvd25lckRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwoJCQkJCWRpdi5hcHBlbmRDaGlsZCggdGhpcy5jbG9uZU5vZGUodHJ1ZSkgKTsKCQkJCQlodG1sID0gZGl2LmlubmVySFRNTDsKCQkJCX0KCgkJCQlyZXR1cm4galF1ZXJ5LmNsZWFuKFtodG1sLnJlcGxhY2UocmlubGluZWpRdWVyeSwgIiIpCgkJCQkJLy8gSGFuZGxlIHRoZSBjYXNlIGluIElFIDggd2hlcmUgYWN0aW9uPS90ZXN0Lz4gc2VsZi1jbG9zZXMgYSB0YWcKCQkJCQkucmVwbGFjZSgvPShbXj0iJz5cc10rXC8pPi9nLCAnPSIkMSI+JykKCQkJCQkucmVwbGFjZShybGVhZGluZ1doaXRlc3BhY2UsICIiKV0sIG93bmVyRG9jdW1lbnQpWzBdOwoJCQl9IGVsc2UgewoJCQkJcmV0dXJuIHRoaXMuY2xvbmVOb2RlKHRydWUpOwoJCQl9CgkJfSk7CgoJCS8vIENvcHkgdGhlIGV2ZW50cyBmcm9tIHRoZSBvcmlnaW5hbCB0byB0aGUgY2xvbmUKCQlpZiAoIGV2ZW50cyA9PT0gdHJ1ZSApIHsKCQkJY2xvbmVDb3B5RXZlbnQoIHRoaXMsIHJldCApOwoJCQljbG9uZUNvcHlFdmVudCggdGhpcy5maW5kKCIqIiksIHJldC5maW5kKCIqIikgKTsKCQl9CgoJCS8vIFJldHVybiB0aGUgY2xvbmVkIHNldAoJCXJldHVybiByZXQ7Cgl9LAoKCWh0bWw6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQlpZiAoIHZhbHVlID09PSB1bmRlZmluZWQgKSB7CgkJCXJldHVybiB0aGlzWzBdICYmIHRoaXNbMF0ubm9kZVR5cGUgPT09IDEgPwoJCQkJdGhpc1swXS5pbm5lckhUTUwucmVwbGFjZShyaW5saW5lalF1ZXJ5LCAiIikgOgoJCQkJbnVsbDsKCgkJLy8gU2VlIGlmIHdlIGNhbiB0YWtlIGEgc2hvcnRjdXQgYW5kIGp1c3QgdXNlIGlubmVySFRNTAoJCX0gZWxzZSBpZiAoIHR5cGVvZiB2YWx1ZSA9PT0gInN0cmluZyIgJiYgIXJub2NhY2hlLnRlc3QoIHZhbHVlICkgJiYKCQkJKGpRdWVyeS5zdXBwb3J0LmxlYWRpbmdXaGl0ZXNwYWNlIHx8ICFybGVhZGluZ1doaXRlc3BhY2UudGVzdCggdmFsdWUgKSkgJiYKCQkJIXdyYXBNYXBbIChydGFnTmFtZS5leGVjKCB2YWx1ZSApIHx8IFsiIiwgIiJdKVsxXS50b0xvd2VyQ2FzZSgpIF0gKSB7CgoJCQl2YWx1ZSA9IHZhbHVlLnJlcGxhY2UocnhodG1sVGFnLCBmY2xvc2VUYWcpOwoKCQkJdHJ5IHsKCQkJCWZvciAoIHZhciBpID0gMCwgbCA9IHRoaXMubGVuZ3RoOyBpIDwgbDsgaSsrICkgewoJCQkJCS8vIFJlbW92ZSBlbGVtZW50IG5vZGVzIGFuZCBwcmV2ZW50IG1lbW9yeSBsZWFrcwoJCQkJCWlmICggdGhpc1tpXS5ub2RlVHlwZSA9PT0gMSApIHsKCQkJCQkJalF1ZXJ5LmNsZWFuRGF0YSggdGhpc1tpXS5nZXRFbGVtZW50c0J5VGFnTmFtZSgiKiIpICk7CgkJCQkJCXRoaXNbaV0uaW5uZXJIVE1MID0gdmFsdWU7CgkJCQkJfQoJCQkJfQoKCQkJLy8gSWYgdXNpbmcgaW5uZXJIVE1MIHRocm93cyBhbiBleGNlcHRpb24sIHVzZSB0aGUgZmFsbGJhY2sgbWV0aG9kCgkJCX0gY2F0Y2goZSkgewoJCQkJdGhpcy5lbXB0eSgpLmFwcGVuZCggdmFsdWUgKTsKCQkJfQoKCQl9IGVsc2UgaWYgKCBqUXVlcnkuaXNGdW5jdGlvbiggdmFsdWUgKSApIHsKCQkJdGhpcy5lYWNoKGZ1bmN0aW9uKGkpewoJCQkJdmFyIHNlbGYgPSBqUXVlcnkodGhpcyksIG9sZCA9IHNlbGYuaHRtbCgpOwoJCQkJc2VsZi5lbXB0eSgpLmFwcGVuZChmdW5jdGlvbigpewoJCQkJCXJldHVybiB2YWx1ZS5jYWxsKCB0aGlzLCBpLCBvbGQgKTsKCQkJCX0pOwoJCQl9KTsKCgkJfSBlbHNlIHsKCQkJdGhpcy5lbXB0eSgpLmFwcGVuZCggdmFsdWUgKTsKCQl9CgoJCXJldHVybiB0aGlzOwoJfSwKCglyZXBsYWNlV2l0aDogZnVuY3Rpb24oIHZhbHVlICkgewoJCWlmICggdGhpc1swXSAmJiB0aGlzWzBdLnBhcmVudE5vZGUgKSB7CgkJCS8vIE1ha2Ugc3VyZSB0aGF0IHRoZSBlbGVtZW50cyBhcmUgcmVtb3ZlZCBmcm9tIHRoZSBET00gYmVmb3JlIHRoZXkgYXJlIGluc2VydGVkCgkJCS8vIHRoaXMgY2FuIGhlbHAgZml4IHJlcGxhY2luZyBhIHBhcmVudCB3aXRoIGNoaWxkIGVsZW1lbnRzCgkJCWlmICggalF1ZXJ5LmlzRnVuY3Rpb24oIHZhbHVlICkgKSB7CgkJCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKGkpIHsKCQkJCQl2YXIgc2VsZiA9IGpRdWVyeSh0aGlzKSwgb2xkID0gc2VsZi5odG1sKCk7CgkJCQkJc2VsZi5yZXBsYWNlV2l0aCggdmFsdWUuY2FsbCggdGhpcywgaSwgb2xkICkgKTsKCQkJCX0pOwoJCQl9CgoJCQlpZiAoIHR5cGVvZiB2YWx1ZSAhPT0gInN0cmluZyIgKSB7CgkJCQl2YWx1ZSA9IGpRdWVyeSh2YWx1ZSkuZGV0YWNoKCk7CgkJCX0KCgkJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgkJCQl2YXIgbmV4dCA9IHRoaXMubmV4dFNpYmxpbmcsIHBhcmVudCA9IHRoaXMucGFyZW50Tm9kZTsKCgkJCQlqUXVlcnkodGhpcykucmVtb3ZlKCk7CgoJCQkJaWYgKCBuZXh0ICkgewoJCQkJCWpRdWVyeShuZXh0KS5iZWZvcmUoIHZhbHVlICk7CgkJCQl9IGVsc2UgewoJCQkJCWpRdWVyeShwYXJlbnQpLmFwcGVuZCggdmFsdWUgKTsKCQkJCX0KCQkJfSk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMucHVzaFN0YWNrKCBqUXVlcnkoalF1ZXJ5LmlzRnVuY3Rpb24odmFsdWUpID8gdmFsdWUoKSA6IHZhbHVlKSwgInJlcGxhY2VXaXRoIiwgdmFsdWUgKTsKCQl9Cgl9LAoKCWRldGFjaDogZnVuY3Rpb24oIHNlbGVjdG9yICkgewoJCXJldHVybiB0aGlzLnJlbW92ZSggc2VsZWN0b3IsIHRydWUgKTsKCX0sCgoJZG9tTWFuaXA6IGZ1bmN0aW9uKCBhcmdzLCB0YWJsZSwgY2FsbGJhY2sgKSB7CgkJdmFyIHJlc3VsdHMsIGZpcnN0LCB2YWx1ZSA9IGFyZ3NbMF0sIHNjcmlwdHMgPSBbXSwgZnJhZ21lbnQsIHBhcmVudDsKCgkJLy8gV2UgY2FuJ3QgY2xvbmVOb2RlIGZyYWdtZW50cyB0aGF0IGNvbnRhaW4gY2hlY2tlZCwgaW4gV2ViS2l0CgkJaWYgKCAhalF1ZXJ5LnN1cHBvcnQuY2hlY2tDbG9uZSAmJiBhcmd1bWVudHMubGVuZ3RoID09PSAzICYmIHR5cGVvZiB2YWx1ZSA9PT0gInN0cmluZyIgJiYgcmNoZWNrZWQudGVzdCggdmFsdWUgKSApIHsKCQkJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJCWpRdWVyeSh0aGlzKS5kb21NYW5pcCggYXJncywgdGFibGUsIGNhbGxiYWNrLCB0cnVlICk7CgkJCX0pOwoJCX0KCgkJaWYgKCBqUXVlcnkuaXNGdW5jdGlvbih2YWx1ZSkgKSB7CgkJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oaSkgewoJCQkJdmFyIHNlbGYgPSBqUXVlcnkodGhpcyk7CgkJCQlhcmdzWzBdID0gdmFsdWUuY2FsbCh0aGlzLCBpLCB0YWJsZSA/IHNlbGYuaHRtbCgpIDogdW5kZWZpbmVkKTsKCQkJCXNlbGYuZG9tTWFuaXAoIGFyZ3MsIHRhYmxlLCBjYWxsYmFjayApOwoJCQl9KTsKCQl9CgoJCWlmICggdGhpc1swXSApIHsKCQkJcGFyZW50ID0gdmFsdWUgJiYgdmFsdWUucGFyZW50Tm9kZTsKCgkJCS8vIElmIHdlJ3JlIGluIGEgZnJhZ21lbnQsIGp1c3QgdXNlIHRoYXQgaW5zdGVhZCBvZiBidWlsZGluZyBhIG5ldyBvbmUKCQkJaWYgKCBqUXVlcnkuc3VwcG9ydC5wYXJlbnROb2RlICYmIHBhcmVudCAmJiBwYXJlbnQubm9kZVR5cGUgPT09IDExICYmIHBhcmVudC5jaGlsZE5vZGVzLmxlbmd0aCA9PT0gdGhpcy5sZW5ndGggKSB7CgkJCQlyZXN1bHRzID0geyBmcmFnbWVudDogcGFyZW50IH07CgoJCQl9IGVsc2UgewoJCQkJcmVzdWx0cyA9IGJ1aWxkRnJhZ21lbnQoIGFyZ3MsIHRoaXMsIHNjcmlwdHMgKTsKCQkJfQoJCQkKCQkJZnJhZ21lbnQgPSByZXN1bHRzLmZyYWdtZW50OwoJCQkKCQkJaWYgKCBmcmFnbWVudC5jaGlsZE5vZGVzLmxlbmd0aCA9PT0gMSApIHsKCQkJCWZpcnN0ID0gZnJhZ21lbnQgPSBmcmFnbWVudC5maXJzdENoaWxkOwoJCQl9IGVsc2UgewoJCQkJZmlyc3QgPSBmcmFnbWVudC5maXJzdENoaWxkOwoJCQl9CgoJCQlpZiAoIGZpcnN0ICkgewoJCQkJdGFibGUgPSB0YWJsZSAmJiBqUXVlcnkubm9kZU5hbWUoIGZpcnN0LCAidHIiICk7CgoJCQkJZm9yICggdmFyIGkgPSAwLCBsID0gdGhpcy5sZW5ndGg7IGkgPCBsOyBpKysgKSB7CgkJCQkJY2FsbGJhY2suY2FsbCgKCQkJCQkJdGFibGUgPwoJCQkJCQkJcm9vdCh0aGlzW2ldLCBmaXJzdCkgOgoJCQkJCQkJdGhpc1tpXSwKCQkJCQkJaSA+IDAgfHwgcmVzdWx0cy5jYWNoZWFibGUgfHwgdGhpcy5sZW5ndGggPiAxICA/CgkJCQkJCQlmcmFnbWVudC5jbG9uZU5vZGUodHJ1ZSkgOgoJCQkJCQkJZnJhZ21lbnQKCQkJCQkpOwoJCQkJfQoJCQl9CgoJCQlpZiAoIHNjcmlwdHMubGVuZ3RoICkgewoJCQkJalF1ZXJ5LmVhY2goIHNjcmlwdHMsIGV2YWxTY3JpcHQgKTsKCQkJfQoJCX0KCgkJcmV0dXJuIHRoaXM7CgoJCWZ1bmN0aW9uIHJvb3QoIGVsZW0sIGN1ciApIHsKCQkJcmV0dXJuIGpRdWVyeS5ub2RlTmFtZShlbGVtLCAidGFibGUiKSA/CgkJCQkoZWxlbS5nZXRFbGVtZW50c0J5VGFnTmFtZSgidGJvZHkiKVswXSB8fAoJCQkJZWxlbS5hcHBlbmRDaGlsZChlbGVtLm93bmVyRG9jdW1lbnQuY3JlYXRlRWxlbWVudCgidGJvZHkiKSkpIDoKCQkJCWVsZW07CgkJfQoJfQp9KTsKCmZ1bmN0aW9uIGNsb25lQ29weUV2ZW50KG9yaWcsIHJldCkgewoJdmFyIGkgPSAwOwoKCXJldC5lYWNoKGZ1bmN0aW9uKCkgewoJCWlmICggdGhpcy5ub2RlTmFtZSAhPT0gKG9yaWdbaV0gJiYgb3JpZ1tpXS5ub2RlTmFtZSkgKSB7CgkJCXJldHVybjsKCQl9CgoJCXZhciBvbGREYXRhID0galF1ZXJ5LmRhdGEoIG9yaWdbaSsrXSApLCBjdXJEYXRhID0galF1ZXJ5LmRhdGEoIHRoaXMsIG9sZERhdGEgKSwgZXZlbnRzID0gb2xkRGF0YSAmJiBvbGREYXRhLmV2ZW50czsKCgkJaWYgKCBldmVudHMgKSB7CgkJCWRlbGV0ZSBjdXJEYXRhLmhhbmRsZTsKCQkJY3VyRGF0YS5ldmVudHMgPSB7fTsKCgkJCWZvciAoIHZhciB0eXBlIGluIGV2ZW50cyApIHsKCQkJCWZvciAoIHZhciBoYW5kbGVyIGluIGV2ZW50c1sgdHlwZSBdICkgewoJCQkJCWpRdWVyeS5ldmVudC5hZGQoIHRoaXMsIHR5cGUsIGV2ZW50c1sgdHlwZSBdWyBoYW5kbGVyIF0sIGV2ZW50c1sgdHlwZSBdWyBoYW5kbGVyIF0uZGF0YSApOwoJCQkJfQoJCQl9CgkJfQoJfSk7Cn0KCmZ1bmN0aW9uIGJ1aWxkRnJhZ21lbnQoIGFyZ3MsIG5vZGVzLCBzY3JpcHRzICkgewoJdmFyIGZyYWdtZW50LCBjYWNoZWFibGUsIGNhY2hlcmVzdWx0cywKCQlkb2MgPSAobm9kZXMgJiYgbm9kZXNbMF0gPyBub2Rlc1swXS5vd25lckRvY3VtZW50IHx8IG5vZGVzWzBdIDogZG9jdW1lbnQpOwoKCS8vIE9ubHkgY2FjaGUgInNtYWxsIiAoMS8yIEtCKSBzdHJpbmdzIHRoYXQgYXJlIGFzc29jaWF0ZWQgd2l0aCB0aGUgbWFpbiBkb2N1bWVudAoJLy8gQ2xvbmluZyBvcHRpb25zIGxvc2VzIHRoZSBzZWxlY3RlZCBzdGF0ZSwgc28gZG9uJ3QgY2FjaGUgdGhlbQoJLy8gSUUgNiBkb2Vzbid0IGxpa2UgaXQgd2hlbiB5b3UgcHV0IDxvYmplY3Q+IG9yIDxlbWJlZD4gZWxlbWVudHMgaW4gYSBmcmFnbWVudAoJLy8gQWxzbywgV2ViS2l0IGRvZXMgbm90IGNsb25lICdjaGVja2VkJyBhdHRyaWJ1dGVzIG9uIGNsb25lTm9kZSwgc28gZG9uJ3QgY2FjaGUKCWlmICggYXJncy5sZW5ndGggPT09IDEgJiYgdHlwZW9mIGFyZ3NbMF0gPT09ICJzdHJpbmciICYmIGFyZ3NbMF0ubGVuZ3RoIDwgNTEyICYmIGRvYyA9PT0gZG9jdW1lbnQgJiYKCQkhcm5vY2FjaGUudGVzdCggYXJnc1swXSApICYmIChqUXVlcnkuc3VwcG9ydC5jaGVja0Nsb25lIHx8ICFyY2hlY2tlZC50ZXN0KCBhcmdzWzBdICkpICkgewoKCQljYWNoZWFibGUgPSB0cnVlOwoJCWNhY2hlcmVzdWx0cyA9IGpRdWVyeS5mcmFnbWVudHNbIGFyZ3NbMF0gXTsKCQlpZiAoIGNhY2hlcmVzdWx0cyApIHsKCQkJaWYgKCBjYWNoZXJlc3VsdHMgIT09IDEgKSB7CgkJCQlmcmFnbWVudCA9IGNhY2hlcmVzdWx0czsKCQkJfQoJCX0KCX0KCglpZiAoICFmcmFnbWVudCApIHsKCQlmcmFnbWVudCA9IGRvYy5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCk7CgkJalF1ZXJ5LmNsZWFuKCBhcmdzLCBkb2MsIGZyYWdtZW50LCBzY3JpcHRzICk7Cgl9CgoJaWYgKCBjYWNoZWFibGUgKSB7CgkJalF1ZXJ5LmZyYWdtZW50c1sgYXJnc1swXSBdID0gY2FjaGVyZXN1bHRzID8gZnJhZ21lbnQgOiAxOwoJfQoKCXJldHVybiB7IGZyYWdtZW50OiBmcmFnbWVudCwgY2FjaGVhYmxlOiBjYWNoZWFibGUgfTsKfQoKalF1ZXJ5LmZyYWdtZW50cyA9IHt9OwoKalF1ZXJ5LmVhY2goewoJYXBwZW5kVG86ICJhcHBlbmQiLAoJcHJlcGVuZFRvOiAicHJlcGVuZCIsCglpbnNlcnRCZWZvcmU6ICJiZWZvcmUiLAoJaW5zZXJ0QWZ0ZXI6ICJhZnRlciIsCglyZXBsYWNlQWxsOiAicmVwbGFjZVdpdGgiCn0sIGZ1bmN0aW9uKCBuYW1lLCBvcmlnaW5hbCApIHsKCWpRdWVyeS5mblsgbmFtZSBdID0gZnVuY3Rpb24oIHNlbGVjdG9yICkgewoJCXZhciByZXQgPSBbXSwgaW5zZXJ0ID0galF1ZXJ5KCBzZWxlY3RvciApLAoJCQlwYXJlbnQgPSB0aGlzLmxlbmd0aCA9PT0gMSAmJiB0aGlzWzBdLnBhcmVudE5vZGU7CgkJCgkJaWYgKCBwYXJlbnQgJiYgcGFyZW50Lm5vZGVUeXBlID09PSAxMSAmJiBwYXJlbnQuY2hpbGROb2Rlcy5sZW5ndGggPT09IDEgJiYgaW5zZXJ0Lmxlbmd0aCA9PT0gMSApIHsKCQkJaW5zZXJ0WyBvcmlnaW5hbCBdKCB0aGlzWzBdICk7CgkJCXJldHVybiB0aGlzOwoJCQkKCQl9IGVsc2UgewoJCQlmb3IgKCB2YXIgaSA9IDAsIGwgPSBpbnNlcnQubGVuZ3RoOyBpIDwgbDsgaSsrICkgewoJCQkJdmFyIGVsZW1zID0gKGkgPiAwID8gdGhpcy5jbG9uZSh0cnVlKSA6IHRoaXMpLmdldCgpOwoJCQkJalF1ZXJ5LmZuWyBvcmlnaW5hbCBdLmFwcGx5KCBqUXVlcnkoaW5zZXJ0W2ldKSwgZWxlbXMgKTsKCQkJCXJldCA9IHJldC5jb25jYXQoIGVsZW1zICk7CgkJCX0KCQkKCQkJcmV0dXJuIHRoaXMucHVzaFN0YWNrKCByZXQsIG5hbWUsIGluc2VydC5zZWxlY3RvciApOwoJCX0KCX07Cn0pOwoKalF1ZXJ5LmV4dGVuZCh7CgljbGVhbjogZnVuY3Rpb24oIGVsZW1zLCBjb250ZXh0LCBmcmFnbWVudCwgc2NyaXB0cyApIHsKCQljb250ZXh0ID0gY29udGV4dCB8fCBkb2N1bWVudDsKCgkJLy8gIWNvbnRleHQuY3JlYXRlRWxlbWVudCBmYWlscyBpbiBJRSB3aXRoIGFuIGVycm9yIGJ1dCByZXR1cm5zIHR5cGVvZiAnb2JqZWN0JwoJCWlmICggdHlwZW9mIGNvbnRleHQuY3JlYXRlRWxlbWVudCA9PT0gInVuZGVmaW5lZCIgKSB7CgkJCWNvbnRleHQgPSBjb250ZXh0Lm93bmVyRG9jdW1lbnQgfHwgY29udGV4dFswXSAmJiBjb250ZXh0WzBdLm93bmVyRG9jdW1lbnQgfHwgZG9jdW1lbnQ7CgkJfQoKCQl2YXIgcmV0ID0gW107CgoJCWZvciAoIHZhciBpID0gMCwgZWxlbTsgKGVsZW0gPSBlbGVtc1tpXSkgIT0gbnVsbDsgaSsrICkgewoJCQlpZiAoIHR5cGVvZiBlbGVtID09PSAibnVtYmVyIiApIHsKCQkJCWVsZW0gKz0gIiI7CgkJCX0KCgkJCWlmICggIWVsZW0gKSB7CgkJCQljb250aW51ZTsKCQkJfQoKCQkJLy8gQ29udmVydCBodG1sIHN0cmluZyBpbnRvIERPTSBub2RlcwoJCQlpZiAoIHR5cGVvZiBlbGVtID09PSAic3RyaW5nIiAmJiAhcmh0bWwudGVzdCggZWxlbSApICkgewoJCQkJZWxlbSA9IGNvbnRleHQuY3JlYXRlVGV4dE5vZGUoIGVsZW0gKTsKCgkJCX0gZWxzZSBpZiAoIHR5cGVvZiBlbGVtID09PSAic3RyaW5nIiApIHsKCQkJCS8vIEZpeCAiWEhUTUwiLXN0eWxlIHRhZ3MgaW4gYWxsIGJyb3dzZXJzCgkJCQllbGVtID0gZWxlbS5yZXBsYWNlKHJ4aHRtbFRhZywgZmNsb3NlVGFnKTsKCgkJCQkvLyBUcmltIHdoaXRlc3BhY2UsIG90aGVyd2lzZSBpbmRleE9mIHdvbid0IHdvcmsgYXMgZXhwZWN0ZWQKCQkJCXZhciB0YWcgPSAocnRhZ05hbWUuZXhlYyggZWxlbSApIHx8IFsiIiwgIiJdKVsxXS50b0xvd2VyQ2FzZSgpLAoJCQkJCXdyYXAgPSB3cmFwTWFwWyB0YWcgXSB8fCB3cmFwTWFwLl9kZWZhdWx0LAoJCQkJCWRlcHRoID0gd3JhcFswXSwKCQkJCQlkaXYgPSBjb250ZXh0LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwoKCQkJCS8vIEdvIHRvIGh0bWwgYW5kIGJhY2ssIHRoZW4gcGVlbCBvZmYgZXh0cmEgd3JhcHBlcnMKCQkJCWRpdi5pbm5lckhUTUwgPSB3cmFwWzFdICsgZWxlbSArIHdyYXBbMl07CgoJCQkJLy8gTW92ZSB0byB0aGUgcmlnaHQgZGVwdGgKCQkJCXdoaWxlICggZGVwdGgtLSApIHsKCQkJCQlkaXYgPSBkaXYubGFzdENoaWxkOwoJCQkJfQoKCQkJCS8vIFJlbW92ZSBJRSdzIGF1dG9pbnNlcnRlZCA8dGJvZHk+IGZyb20gdGFibGUgZnJhZ21lbnRzCgkJCQlpZiAoICFqUXVlcnkuc3VwcG9ydC50Ym9keSApIHsKCgkJCQkJLy8gU3RyaW5nIHdhcyBhIDx0YWJsZT4sICptYXkqIGhhdmUgc3B1cmlvdXMgPHRib2R5PgoJCQkJCXZhciBoYXNCb2R5ID0gcnRib2R5LnRlc3QoZWxlbSksCgkJCQkJCXRib2R5ID0gdGFnID09PSAidGFibGUiICYmICFoYXNCb2R5ID8KCQkJCQkJCWRpdi5maXJzdENoaWxkICYmIGRpdi5maXJzdENoaWxkLmNoaWxkTm9kZXMgOgoKCQkJCQkJCS8vIFN0cmluZyB3YXMgYSBiYXJlIDx0aGVhZD4gb3IgPHRmb290PgoJCQkJCQkJd3JhcFsxXSA9PT0gIjx0YWJsZT4iICYmICFoYXNCb2R5ID8KCQkJCQkJCQlkaXYuY2hpbGROb2RlcyA6CgkJCQkJCQkJW107CgoJCQkJCWZvciAoIHZhciBqID0gdGJvZHkubGVuZ3RoIC0gMTsgaiA+PSAwIDsgLS1qICkgewoJCQkJCQlpZiAoIGpRdWVyeS5ub2RlTmFtZSggdGJvZHlbIGogXSwgInRib2R5IiApICYmICF0Ym9keVsgaiBdLmNoaWxkTm9kZXMubGVuZ3RoICkgewoJCQkJCQkJdGJvZHlbIGogXS5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKCB0Ym9keVsgaiBdICk7CgkJCQkJCX0KCQkJCQl9CgoJCQkJfQoKCQkJCS8vIElFIGNvbXBsZXRlbHkga2lsbHMgbGVhZGluZyB3aGl0ZXNwYWNlIHdoZW4gaW5uZXJIVE1MIGlzIHVzZWQKCQkJCWlmICggIWpRdWVyeS5zdXBwb3J0LmxlYWRpbmdXaGl0ZXNwYWNlICYmIHJsZWFkaW5nV2hpdGVzcGFjZS50ZXN0KCBlbGVtICkgKSB7CgkJCQkJZGl2Lmluc2VydEJlZm9yZSggY29udGV4dC5jcmVhdGVUZXh0Tm9kZSggcmxlYWRpbmdXaGl0ZXNwYWNlLmV4ZWMoZWxlbSlbMF0gKSwgZGl2LmZpcnN0Q2hpbGQgKTsKCQkJCX0KCgkJCQllbGVtID0gZGl2LmNoaWxkTm9kZXM7CgkJCX0KCgkJCWlmICggZWxlbS5ub2RlVHlwZSApIHsKCQkJCXJldC5wdXNoKCBlbGVtICk7CgkJCX0gZWxzZSB7CgkJCQlyZXQgPSBqUXVlcnkubWVyZ2UoIHJldCwgZWxlbSApOwoJCQl9CgkJfQoKCQlpZiAoIGZyYWdtZW50ICkgewoJCQlmb3IgKCB2YXIgaSA9IDA7IHJldFtpXTsgaSsrICkgewoJCQkJaWYgKCBzY3JpcHRzICYmIGpRdWVyeS5ub2RlTmFtZSggcmV0W2ldLCAic2NyaXB0IiApICYmICghcmV0W2ldLnR5cGUgfHwgcmV0W2ldLnR5cGUudG9Mb3dlckNhc2UoKSA9PT0gInRleHQvamF2YXNjcmlwdCIpICkgewoJCQkJCXNjcmlwdHMucHVzaCggcmV0W2ldLnBhcmVudE5vZGUgPyByZXRbaV0ucGFyZW50Tm9kZS5yZW1vdmVDaGlsZCggcmV0W2ldICkgOiByZXRbaV0gKTsKCQkJCQoJCQkJfSBlbHNlIHsKCQkJCQlpZiAoIHJldFtpXS5ub2RlVHlwZSA9PT0gMSApIHsKCQkJCQkJcmV0LnNwbGljZS5hcHBseSggcmV0LCBbaSArIDEsIDBdLmNvbmNhdChqUXVlcnkubWFrZUFycmF5KHJldFtpXS5nZXRFbGVtZW50c0J5VGFnTmFtZSgic2NyaXB0IikpKSApOwoJCQkJCX0KCQkJCQlmcmFnbWVudC5hcHBlbmRDaGlsZCggcmV0W2ldICk7CgkJCQl9CgkJCX0KCQl9CgoJCXJldHVybiByZXQ7Cgl9LAoJCgljbGVhbkRhdGE6IGZ1bmN0aW9uKCBlbGVtcyApIHsKCQl2YXIgZGF0YSwgaWQsIGNhY2hlID0galF1ZXJ5LmNhY2hlLAoJCQlzcGVjaWFsID0galF1ZXJ5LmV2ZW50LnNwZWNpYWwsCgkJCWRlbGV0ZUV4cGFuZG8gPSBqUXVlcnkuc3VwcG9ydC5kZWxldGVFeHBhbmRvOwoJCQoJCWZvciAoIHZhciBpID0gMCwgZWxlbTsgKGVsZW0gPSBlbGVtc1tpXSkgIT0gbnVsbDsgaSsrICkgewoJCQlpZCA9IGVsZW1bIGpRdWVyeS5leHBhbmRvIF07CgkJCQoJCQlpZiAoIGlkICkgewoJCQkJZGF0YSA9IGNhY2hlWyBpZCBdOwoJCQkJCgkJCQlpZiAoIGRhdGEuZXZlbnRzICkgewoJCQkJCWZvciAoIHZhciB0eXBlIGluIGRhdGEuZXZlbnRzICkgewoJCQkJCQlpZiAoIHNwZWNpYWxbIHR5cGUgXSApIHsKCQkJCQkJCWpRdWVyeS5ldmVudC5yZW1vdmUoIGVsZW0sIHR5cGUgKTsKCgkJCQkJCX0gZWxzZSB7CgkJCQkJCQlyZW1vdmVFdmVudCggZWxlbSwgdHlwZSwgZGF0YS5oYW5kbGUgKTsKCQkJCQkJfQoJCQkJCX0KCQkJCX0KCQkJCQoJCQkJaWYgKCBkZWxldGVFeHBhbmRvICkgewoJCQkJCWRlbGV0ZSBlbGVtWyBqUXVlcnkuZXhwYW5kbyBdOwoKCQkJCX0gZWxzZSBpZiAoIGVsZW0ucmVtb3ZlQXR0cmlidXRlICkgewoJCQkJCWVsZW0ucmVtb3ZlQXR0cmlidXRlKCBqUXVlcnkuZXhwYW5kbyApOwoJCQkJfQoJCQkJCgkJCQlkZWxldGUgY2FjaGVbIGlkIF07CgkJCX0KCQl9Cgl9Cn0pOwovLyBleGNsdWRlIHRoZSBmb2xsb3dpbmcgY3NzIHByb3BlcnRpZXMgdG8gYWRkIHB4CnZhciByZXhjbHVkZSA9IC96LT9pbmRleHxmb250LT93ZWlnaHR8b3BhY2l0eXx6b29tfGxpbmUtP2hlaWdodC9pLAoJcmFscGhhID0gL2FscGhhXChbXildKlwpLywKCXJvcGFjaXR5ID0gL29wYWNpdHk9KFteKV0qKS8sCglyZmxvYXQgPSAvZmxvYXQvaSwKCXJkYXNoQWxwaGEgPSAvLShbYS16XSkvaWcsCglydXBwZXIgPSAvKFtBLVpdKS9nLAoJcm51bXB4ID0gL14tP1xkKyg/OnB4KT8kL2ksCglybnVtID0gL14tP1xkLywKCgljc3NTaG93ID0geyBwb3NpdGlvbjogImFic29sdXRlIiwgdmlzaWJpbGl0eTogImhpZGRlbiIsIGRpc3BsYXk6ImJsb2NrIiB9LAoJY3NzV2lkdGggPSBbICJMZWZ0IiwgIlJpZ2h0IiBdLAoJY3NzSGVpZ2h0ID0gWyAiVG9wIiwgIkJvdHRvbSIgXSwKCgkvLyBjYWNoZSBjaGVjayBmb3IgZGVmYXVsdFZpZXcuZ2V0Q29tcHV0ZWRTdHlsZQoJZ2V0Q29tcHV0ZWRTdHlsZSA9IGRvY3VtZW50LmRlZmF1bHRWaWV3ICYmIGRvY3VtZW50LmRlZmF1bHRWaWV3LmdldENvbXB1dGVkU3R5bGUsCgkvLyBub3JtYWxpemUgZmxvYXQgY3NzIHByb3BlcnR5CglzdHlsZUZsb2F0ID0galF1ZXJ5LnN1cHBvcnQuY3NzRmxvYXQgPyAiY3NzRmxvYXQiIDogInN0eWxlRmxvYXQiLAoJZmNhbWVsQ2FzZSA9IGZ1bmN0aW9uKCBhbGwsIGxldHRlciApIHsKCQlyZXR1cm4gbGV0dGVyLnRvVXBwZXJDYXNlKCk7Cgl9OwoKalF1ZXJ5LmZuLmNzcyA9IGZ1bmN0aW9uKCBuYW1lLCB2YWx1ZSApIHsKCXJldHVybiBhY2Nlc3MoIHRoaXMsIG5hbWUsIHZhbHVlLCB0cnVlLCBmdW5jdGlvbiggZWxlbSwgbmFtZSwgdmFsdWUgKSB7CgkJaWYgKCB2YWx1ZSA9PT0gdW5kZWZpbmVkICkgewoJCQlyZXR1cm4galF1ZXJ5LmN1ckNTUyggZWxlbSwgbmFtZSApOwoJCX0KCQkKCQlpZiAoIHR5cGVvZiB2YWx1ZSA9PT0gIm51bWJlciIgJiYgIXJleGNsdWRlLnRlc3QobmFtZSkgKSB7CgkJCXZhbHVlICs9ICJweCI7CgkJfQoKCQlqUXVlcnkuc3R5bGUoIGVsZW0sIG5hbWUsIHZhbHVlICk7Cgl9KTsKfTsKCmpRdWVyeS5leHRlbmQoewoJc3R5bGU6IGZ1bmN0aW9uKCBlbGVtLCBuYW1lLCB2YWx1ZSApIHsKCQkvLyBkb24ndCBzZXQgc3R5bGVzIG9uIHRleHQgYW5kIGNvbW1lbnQgbm9kZXMKCQlpZiAoICFlbGVtIHx8IGVsZW0ubm9kZVR5cGUgPT09IDMgfHwgZWxlbS5ub2RlVHlwZSA9PT0gOCApIHsKCQkJcmV0dXJuIHVuZGVmaW5lZDsKCQl9CgoJCS8vIGlnbm9yZSBuZWdhdGl2ZSB3aWR0aCBhbmQgaGVpZ2h0IHZhbHVlcyAjMTU5OQoJCWlmICggKG5hbWUgPT09ICJ3aWR0aCIgfHwgbmFtZSA9PT0gImhlaWdodCIpICYmIHBhcnNlRmxvYXQodmFsdWUpIDwgMCApIHsKCQkJdmFsdWUgPSB1bmRlZmluZWQ7CgkJfQoKCQl2YXIgc3R5bGUgPSBlbGVtLnN0eWxlIHx8IGVsZW0sIHNldCA9IHZhbHVlICE9PSB1bmRlZmluZWQ7CgoJCS8vIElFIHVzZXMgZmlsdGVycyBmb3Igb3BhY2l0eQoJCWlmICggIWpRdWVyeS5zdXBwb3J0Lm9wYWNpdHkgJiYgbmFtZSA9PT0gIm9wYWNpdHkiICkgewoJCQlpZiAoIHNldCApIHsKCQkJCS8vIElFIGhhcyB0cm91YmxlIHdpdGggb3BhY2l0eSBpZiBpdCBkb2VzIG5vdCBoYXZlIGxheW91dAoJCQkJLy8gRm9yY2UgaXQgYnkgc2V0dGluZyB0aGUgem9vbSBsZXZlbAoJCQkJc3R5bGUuem9vbSA9IDE7CgoJCQkJLy8gU2V0IHRoZSBhbHBoYSBmaWx0ZXIgdG8gc2V0IHRoZSBvcGFjaXR5CgkJCQl2YXIgb3BhY2l0eSA9IHBhcnNlSW50KCB2YWx1ZSwgMTAgKSArICIiID09PSAiTmFOIiA/ICIiIDogImFscGhhKG9wYWNpdHk9IiArIHZhbHVlICogMTAwICsgIikiOwoJCQkJdmFyIGZpbHRlciA9IHN0eWxlLmZpbHRlciB8fCBqUXVlcnkuY3VyQ1NTKCBlbGVtLCAiZmlsdGVyIiApIHx8ICIiOwoJCQkJc3R5bGUuZmlsdGVyID0gcmFscGhhLnRlc3QoZmlsdGVyKSA/IGZpbHRlci5yZXBsYWNlKHJhbHBoYSwgb3BhY2l0eSkgOiBvcGFjaXR5OwoJCQl9CgoJCQlyZXR1cm4gc3R5bGUuZmlsdGVyICYmIHN0eWxlLmZpbHRlci5pbmRleE9mKCJvcGFjaXR5PSIpID49IDAgPwoJCQkJKHBhcnNlRmxvYXQoIHJvcGFjaXR5LmV4ZWMoc3R5bGUuZmlsdGVyKVsxXSApIC8gMTAwKSArICIiOgoJCQkJIiI7CgkJfQoKCQkvLyBNYWtlIHN1cmUgd2UncmUgdXNpbmcgdGhlIHJpZ2h0IG5hbWUgZm9yIGdldHRpbmcgdGhlIGZsb2F0IHZhbHVlCgkJaWYgKCByZmxvYXQudGVzdCggbmFtZSApICkgewoJCQluYW1lID0gc3R5bGVGbG9hdDsKCQl9CgoJCW5hbWUgPSBuYW1lLnJlcGxhY2UocmRhc2hBbHBoYSwgZmNhbWVsQ2FzZSk7CgoJCWlmICggc2V0ICkgewoJCQlzdHlsZVsgbmFtZSBdID0gdmFsdWU7CgkJfQoKCQlyZXR1cm4gc3R5bGVbIG5hbWUgXTsKCX0sCgoJY3NzOiBmdW5jdGlvbiggZWxlbSwgbmFtZSwgZm9yY2UsIGV4dHJhICkgewoJCWlmICggbmFtZSA9PT0gIndpZHRoIiB8fCBuYW1lID09PSAiaGVpZ2h0IiApIHsKCQkJdmFyIHZhbCwgcHJvcHMgPSBjc3NTaG93LCB3aGljaCA9IG5hbWUgPT09ICJ3aWR0aCIgPyBjc3NXaWR0aCA6IGNzc0hlaWdodDsKCgkJCWZ1bmN0aW9uIGdldFdIKCkgewoJCQkJdmFsID0gbmFtZSA9PT0gIndpZHRoIiA/IGVsZW0ub2Zmc2V0V2lkdGggOiBlbGVtLm9mZnNldEhlaWdodDsKCgkJCQlpZiAoIGV4dHJhID09PSAiYm9yZGVyIiApIHsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJalF1ZXJ5LmVhY2goIHdoaWNoLCBmdW5jdGlvbigpIHsKCQkJCQlpZiAoICFleHRyYSApIHsKCQkJCQkJdmFsIC09IHBhcnNlRmxvYXQoalF1ZXJ5LmN1ckNTUyggZWxlbSwgInBhZGRpbmciICsgdGhpcywgdHJ1ZSkpIHx8IDA7CgkJCQkJfQoKCQkJCQlpZiAoIGV4dHJhID09PSAibWFyZ2luIiApIHsKCQkJCQkJdmFsICs9IHBhcnNlRmxvYXQoalF1ZXJ5LmN1ckNTUyggZWxlbSwgIm1hcmdpbiIgKyB0aGlzLCB0cnVlKSkgfHwgMDsKCQkJCQl9IGVsc2UgewoJCQkJCQl2YWwgLT0gcGFyc2VGbG9hdChqUXVlcnkuY3VyQ1NTKCBlbGVtLCAiYm9yZGVyIiArIHRoaXMgKyAiV2lkdGgiLCB0cnVlKSkgfHwgMDsKCQkJCQl9CgkJCQl9KTsKCQkJfQoKCQkJaWYgKCBlbGVtLm9mZnNldFdpZHRoICE9PSAwICkgewoJCQkJZ2V0V0goKTsKCQkJfSBlbHNlIHsKCQkJCWpRdWVyeS5zd2FwKCBlbGVtLCBwcm9wcywgZ2V0V0ggKTsKCQkJfQoKCQkJcmV0dXJuIE1hdGgubWF4KDAsIE1hdGgucm91bmQodmFsKSk7CgkJfQoKCQlyZXR1cm4galF1ZXJ5LmN1ckNTUyggZWxlbSwgbmFtZSwgZm9yY2UgKTsKCX0sCgoJY3VyQ1NTOiBmdW5jdGlvbiggZWxlbSwgbmFtZSwgZm9yY2UgKSB7CgkJdmFyIHJldCwgc3R5bGUgPSBlbGVtLnN0eWxlLCBmaWx0ZXI7CgoJCS8vIElFIHVzZXMgZmlsdGVycyBmb3Igb3BhY2l0eQoJCWlmICggIWpRdWVyeS5zdXBwb3J0Lm9wYWNpdHkgJiYgbmFtZSA9PT0gIm9wYWNpdHkiICYmIGVsZW0uY3VycmVudFN0eWxlICkgewoJCQlyZXQgPSByb3BhY2l0eS50ZXN0KGVsZW0uY3VycmVudFN0eWxlLmZpbHRlciB8fCAiIikgPwoJCQkJKHBhcnNlRmxvYXQoUmVnRXhwLiQxKSAvIDEwMCkgKyAiIiA6CgkJCQkiIjsKCgkJCXJldHVybiByZXQgPT09ICIiID8KCQkJCSIxIiA6CgkJCQlyZXQ7CgkJfQoKCQkvLyBNYWtlIHN1cmUgd2UncmUgdXNpbmcgdGhlIHJpZ2h0IG5hbWUgZm9yIGdldHRpbmcgdGhlIGZsb2F0IHZhbHVlCgkJaWYgKCByZmxvYXQudGVzdCggbmFtZSApICkgewoJCQluYW1lID0gc3R5bGVGbG9hdDsKCQl9CgoJCWlmICggIWZvcmNlICYmIHN0eWxlICYmIHN0eWxlWyBuYW1lIF0gKSB7CgkJCXJldCA9IHN0eWxlWyBuYW1lIF07CgoJCX0gZWxzZSBpZiAoIGdldENvbXB1dGVkU3R5bGUgKSB7CgoJCQkvLyBPbmx5ICJmbG9hdCIgaXMgbmVlZGVkIGhlcmUKCQkJaWYgKCByZmxvYXQudGVzdCggbmFtZSApICkgewoJCQkJbmFtZSA9ICJmbG9hdCI7CgkJCX0KCgkJCW5hbWUgPSBuYW1lLnJlcGxhY2UoIHJ1cHBlciwgIi0kMSIgKS50b0xvd2VyQ2FzZSgpOwoKCQkJdmFyIGRlZmF1bHRWaWV3ID0gZWxlbS5vd25lckRvY3VtZW50LmRlZmF1bHRWaWV3OwoKCQkJaWYgKCAhZGVmYXVsdFZpZXcgKSB7CgkJCQlyZXR1cm4gbnVsbDsKCQkJfQoKCQkJdmFyIGNvbXB1dGVkU3R5bGUgPSBkZWZhdWx0Vmlldy5nZXRDb21wdXRlZFN0eWxlKCBlbGVtLCBudWxsICk7CgoJCQlpZiAoIGNvbXB1dGVkU3R5bGUgKSB7CgkJCQlyZXQgPSBjb21wdXRlZFN0eWxlLmdldFByb3BlcnR5VmFsdWUoIG5hbWUgKTsKCQkJfQoKCQkJLy8gV2Ugc2hvdWxkIGFsd2F5cyBnZXQgYSBudW1iZXIgYmFjayBmcm9tIG9wYWNpdHkKCQkJaWYgKCBuYW1lID09PSAib3BhY2l0eSIgJiYgcmV0ID09PSAiIiApIHsKCQkJCXJldCA9ICIxIjsKCQkJfQoKCQl9IGVsc2UgaWYgKCBlbGVtLmN1cnJlbnRTdHlsZSApIHsKCQkJdmFyIGNhbWVsQ2FzZSA9IG5hbWUucmVwbGFjZShyZGFzaEFscGhhLCBmY2FtZWxDYXNlKTsKCgkJCXJldCA9IGVsZW0uY3VycmVudFN0eWxlWyBuYW1lIF0gfHwgZWxlbS5jdXJyZW50U3R5bGVbIGNhbWVsQ2FzZSBdOwoKCQkJLy8gRnJvbSB0aGUgYXdlc29tZSBoYWNrIGJ5IERlYW4gRWR3YXJkcwoJCQkvLyBodHRwOi8vZXJpay5lYWUubmV0L2FyY2hpdmVzLzIwMDcvMDcvMjcvMTguNTQuMTUvI2NvbW1lbnQtMTAyMjkxCgoJCQkvLyBJZiB3ZSdyZSBub3QgZGVhbGluZyB3aXRoIGEgcmVndWxhciBwaXhlbCBudW1iZXIKCQkJLy8gYnV0IGEgbnVtYmVyIHRoYXQgaGFzIGEgd2VpcmQgZW5kaW5nLCB3ZSBuZWVkIHRvIGNvbnZlcnQgaXQgdG8gcGl4ZWxzCgkJCWlmICggIXJudW1weC50ZXN0KCByZXQgKSAmJiBybnVtLnRlc3QoIHJldCApICkgewoJCQkJLy8gUmVtZW1iZXIgdGhlIG9yaWdpbmFsIHZhbHVlcwoJCQkJdmFyIGxlZnQgPSBzdHlsZS5sZWZ0LCByc0xlZnQgPSBlbGVtLnJ1bnRpbWVTdHlsZS5sZWZ0OwoKCQkJCS8vIFB1dCBpbiB0aGUgbmV3IHZhbHVlcyB0byBnZXQgYSBjb21wdXRlZCB2YWx1ZSBvdXQKCQkJCWVsZW0ucnVudGltZVN0eWxlLmxlZnQgPSBlbGVtLmN1cnJlbnRTdHlsZS5sZWZ0OwoJCQkJc3R5bGUubGVmdCA9IGNhbWVsQ2FzZSA9PT0gImZvbnRTaXplIiA/ICIxZW0iIDogKHJldCB8fCAwKTsKCQkJCXJldCA9IHN0eWxlLnBpeGVsTGVmdCArICJweCI7CgoJCQkJLy8gUmV2ZXJ0IHRoZSBjaGFuZ2VkIHZhbHVlcwoJCQkJc3R5bGUubGVmdCA9IGxlZnQ7CgkJCQllbGVtLnJ1bnRpbWVTdHlsZS5sZWZ0ID0gcnNMZWZ0OwoJCQl9CgkJfQoKCQlyZXR1cm4gcmV0OwoJfSwKCgkvLyBBIG1ldGhvZCBmb3IgcXVpY2tseSBzd2FwcGluZyBpbi9vdXQgQ1NTIHByb3BlcnRpZXMgdG8gZ2V0IGNvcnJlY3QgY2FsY3VsYXRpb25zCglzd2FwOiBmdW5jdGlvbiggZWxlbSwgb3B0aW9ucywgY2FsbGJhY2sgKSB7CgkJdmFyIG9sZCA9IHt9OwoKCQkvLyBSZW1lbWJlciB0aGUgb2xkIHZhbHVlcywgYW5kIGluc2VydCB0aGUgbmV3IG9uZXMKCQlmb3IgKCB2YXIgbmFtZSBpbiBvcHRpb25zICkgewoJCQlvbGRbIG5hbWUgXSA9IGVsZW0uc3R5bGVbIG5hbWUgXTsKCQkJZWxlbS5zdHlsZVsgbmFtZSBdID0gb3B0aW9uc1sgbmFtZSBdOwoJCX0KCgkJY2FsbGJhY2suY2FsbCggZWxlbSApOwoKCQkvLyBSZXZlcnQgdGhlIG9sZCB2YWx1ZXMKCQlmb3IgKCB2YXIgbmFtZSBpbiBvcHRpb25zICkgewoJCQllbGVtLnN0eWxlWyBuYW1lIF0gPSBvbGRbIG5hbWUgXTsKCQl9Cgl9Cn0pOwoKaWYgKCBqUXVlcnkuZXhwciAmJiBqUXVlcnkuZXhwci5maWx0ZXJzICkgewoJalF1ZXJ5LmV4cHIuZmlsdGVycy5oaWRkZW4gPSBmdW5jdGlvbiggZWxlbSApIHsKCQl2YXIgd2lkdGggPSBlbGVtLm9mZnNldFdpZHRoLCBoZWlnaHQgPSBlbGVtLm9mZnNldEhlaWdodCwKCQkJc2tpcCA9IGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gInRyIjsKCgkJcmV0dXJuIHdpZHRoID09PSAwICYmIGhlaWdodCA9PT0gMCAmJiAhc2tpcCA/CgkJCXRydWUgOgoJCQl3aWR0aCA+IDAgJiYgaGVpZ2h0ID4gMCAmJiAhc2tpcCA/CgkJCQlmYWxzZSA6CgkJCQlqUXVlcnkuY3VyQ1NTKGVsZW0sICJkaXNwbGF5IikgPT09ICJub25lIjsKCX07CgoJalF1ZXJ5LmV4cHIuZmlsdGVycy52aXNpYmxlID0gZnVuY3Rpb24oIGVsZW0gKSB7CgkJcmV0dXJuICFqUXVlcnkuZXhwci5maWx0ZXJzLmhpZGRlbiggZWxlbSApOwoJfTsKfQp2YXIganNjID0gbm93KCksCglyc2NyaXB0ID0gLzxzY3JpcHQoLnxccykqP1wvc2NyaXB0Pi9naSwKCXJzZWxlY3RUZXh0YXJlYSA9IC9zZWxlY3R8dGV4dGFyZWEvaSwKCXJpbnB1dCA9IC9jb2xvcnxkYXRlfGRhdGV0aW1lfGVtYWlsfGhpZGRlbnxtb250aHxudW1iZXJ8cGFzc3dvcmR8cmFuZ2V8c2VhcmNofHRlbHx0ZXh0fHRpbWV8dXJsfHdlZWsvaSwKCWpzcmUgPSAvPVw/KCZ8JCkvLAoJcnF1ZXJ5ID0gL1w/LywKCXJ0cyA9IC8oXD98JilfPS4qPygmfCQpLywKCXJ1cmwgPSAvXihcdys6KT9cL1wvKFteXC8/I10rKS8sCglyMjAgPSAvJTIwL2csCgoJLy8gS2VlcCBhIGNvcHkgb2YgdGhlIG9sZCBsb2FkIG1ldGhvZAoJX2xvYWQgPSBqUXVlcnkuZm4ubG9hZDsKCmpRdWVyeS5mbi5leHRlbmQoewoJbG9hZDogZnVuY3Rpb24oIHVybCwgcGFyYW1zLCBjYWxsYmFjayApIHsKCQlpZiAoIHR5cGVvZiB1cmwgIT09ICJzdHJpbmciICkgewoJCQlyZXR1cm4gX2xvYWQuY2FsbCggdGhpcywgdXJsICk7CgoJCS8vIERvbid0IGRvIGEgcmVxdWVzdCBpZiBubyBlbGVtZW50cyBhcmUgYmVpbmcgcmVxdWVzdGVkCgkJfSBlbHNlIGlmICggIXRoaXMubGVuZ3RoICkgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCXZhciBvZmYgPSB1cmwuaW5kZXhPZigiICIpOwoJCWlmICggb2ZmID49IDAgKSB7CgkJCXZhciBzZWxlY3RvciA9IHVybC5zbGljZShvZmYsIHVybC5sZW5ndGgpOwoJCQl1cmwgPSB1cmwuc2xpY2UoMCwgb2ZmKTsKCQl9CgoJCS8vIERlZmF1bHQgdG8gYSBHRVQgcmVxdWVzdAoJCXZhciB0eXBlID0gIkdFVCI7CgoJCS8vIElmIHRoZSBzZWNvbmQgcGFyYW1ldGVyIHdhcyBwcm92aWRlZAoJCWlmICggcGFyYW1zICkgewoJCQkvLyBJZiBpdCdzIGEgZnVuY3Rpb24KCQkJaWYgKCBqUXVlcnkuaXNGdW5jdGlvbiggcGFyYW1zICkgKSB7CgkJCQkvLyBXZSBhc3N1bWUgdGhhdCBpdCdzIHRoZSBjYWxsYmFjawoJCQkJY2FsbGJhY2sgPSBwYXJhbXM7CgkJCQlwYXJhbXMgPSBudWxsOwoKCQkJLy8gT3RoZXJ3aXNlLCBidWlsZCBhIHBhcmFtIHN0cmluZwoJCQl9IGVsc2UgaWYgKCB0eXBlb2YgcGFyYW1zID09PSAib2JqZWN0IiApIHsKCQkJCXBhcmFtcyA9IGpRdWVyeS5wYXJhbSggcGFyYW1zLCBqUXVlcnkuYWpheFNldHRpbmdzLnRyYWRpdGlvbmFsICk7CgkJCQl0eXBlID0gIlBPU1QiOwoJCQl9CgkJfQoKCQl2YXIgc2VsZiA9IHRoaXM7CgoJCS8vIFJlcXVlc3QgdGhlIHJlbW90ZSBkb2N1bWVudAoJCWpRdWVyeS5hamF4KHsKCQkJdXJsOiB1cmwsCgkJCXR5cGU6IHR5cGUsCgkJCWRhdGFUeXBlOiAiaHRtbCIsCgkJCWRhdGE6IHBhcmFtcywKCQkJY29tcGxldGU6IGZ1bmN0aW9uKCByZXMsIHN0YXR1cyApIHsKCQkJCS8vIElmIHN1Y2Nlc3NmdWwsIGluamVjdCB0aGUgSFRNTCBpbnRvIGFsbCB0aGUgbWF0Y2hlZCBlbGVtZW50cwoJCQkJaWYgKCBzdGF0dXMgPT09ICJzdWNjZXNzIiB8fCBzdGF0dXMgPT09ICJub3Rtb2RpZmllZCIgKSB7CgkJCQkJLy8gU2VlIGlmIGEgc2VsZWN0b3Igd2FzIHNwZWNpZmllZAoJCQkJCXNlbGYuaHRtbCggc2VsZWN0b3IgPwoJCQkJCQkvLyBDcmVhdGUgYSBkdW1teSBkaXYgdG8gaG9sZCB0aGUgcmVzdWx0cwoJCQkJCQlqUXVlcnkoIjxkaXYgLz4iKQoJCQkJCQkJLy8gaW5qZWN0IHRoZSBjb250ZW50cyBvZiB0aGUgZG9jdW1lbnQgaW4sIHJlbW92aW5nIHRoZSBzY3JpcHRzCgkJCQkJCQkvLyB0byBhdm9pZCBhbnkgJ1Blcm1pc3Npb24gRGVuaWVkJyBlcnJvcnMgaW4gSUUKCQkJCQkJCS5hcHBlbmQocmVzLnJlc3BvbnNlVGV4dC5yZXBsYWNlKHJzY3JpcHQsICIiKSkKCgkJCQkJCQkvLyBMb2NhdGUgdGhlIHNwZWNpZmllZCBlbGVtZW50cwoJCQkJCQkJLmZpbmQoc2VsZWN0b3IpIDoKCgkJCQkJCS8vIElmIG5vdCwganVzdCBpbmplY3QgdGhlIGZ1bGwgcmVzdWx0CgkJCQkJCXJlcy5yZXNwb25zZVRleHQgKTsKCQkJCX0KCgkJCQlpZiAoIGNhbGxiYWNrICkgewoJCQkJCXNlbGYuZWFjaCggY2FsbGJhY2ssIFtyZXMucmVzcG9uc2VUZXh0LCBzdGF0dXMsIHJlc10gKTsKCQkJCX0KCQkJfQoJCX0pOwoKCQlyZXR1cm4gdGhpczsKCX0sCgoJc2VyaWFsaXplOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4galF1ZXJ5LnBhcmFtKHRoaXMuc2VyaWFsaXplQXJyYXkoKSk7Cgl9LAoJc2VyaWFsaXplQXJyYXk6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLm1hcChmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHRoaXMuZWxlbWVudHMgPyBqUXVlcnkubWFrZUFycmF5KHRoaXMuZWxlbWVudHMpIDogdGhpczsKCQl9KQoJCS5maWx0ZXIoZnVuY3Rpb24oKSB7CgkJCXJldHVybiB0aGlzLm5hbWUgJiYgIXRoaXMuZGlzYWJsZWQgJiYKCQkJCSh0aGlzLmNoZWNrZWQgfHwgcnNlbGVjdFRleHRhcmVhLnRlc3QodGhpcy5ub2RlTmFtZSkgfHwKCQkJCQlyaW5wdXQudGVzdCh0aGlzLnR5cGUpKTsKCQl9KQoJCS5tYXAoZnVuY3Rpb24oIGksIGVsZW0gKSB7CgkJCXZhciB2YWwgPSBqUXVlcnkodGhpcykudmFsKCk7CgoJCQlyZXR1cm4gdmFsID09IG51bGwgPwoJCQkJbnVsbCA6CgkJCQlqUXVlcnkuaXNBcnJheSh2YWwpID8KCQkJCQlqUXVlcnkubWFwKCB2YWwsIGZ1bmN0aW9uKCB2YWwsIGkgKSB7CgkJCQkJCXJldHVybiB7IG5hbWU6IGVsZW0ubmFtZSwgdmFsdWU6IHZhbCB9OwoJCQkJCX0pIDoKCQkJCQl7IG5hbWU6IGVsZW0ubmFtZSwgdmFsdWU6IHZhbCB9OwoJCX0pLmdldCgpOwoJfQp9KTsKCi8vIEF0dGFjaCBhIGJ1bmNoIG9mIGZ1bmN0aW9ucyBmb3IgaGFuZGxpbmcgY29tbW9uIEFKQVggZXZlbnRzCmpRdWVyeS5lYWNoKCAiYWpheFN0YXJ0IGFqYXhTdG9wIGFqYXhDb21wbGV0ZSBhamF4RXJyb3IgYWpheFN1Y2Nlc3MgYWpheFNlbmQiLnNwbGl0KCIgIiksIGZ1bmN0aW9uKCBpLCBvICkgewoJalF1ZXJ5LmZuW29dID0gZnVuY3Rpb24oIGYgKSB7CgkJcmV0dXJuIHRoaXMuYmluZChvLCBmKTsKCX07Cn0pOwoKalF1ZXJ5LmV4dGVuZCh7CgoJZ2V0OiBmdW5jdGlvbiggdXJsLCBkYXRhLCBjYWxsYmFjaywgdHlwZSApIHsKCQkvLyBzaGlmdCBhcmd1bWVudHMgaWYgZGF0YSBhcmd1bWVudCB3YXMgb21pdGVkCgkJaWYgKCBqUXVlcnkuaXNGdW5jdGlvbiggZGF0YSApICkgewoJCQl0eXBlID0gdHlwZSB8fCBjYWxsYmFjazsKCQkJY2FsbGJhY2sgPSBkYXRhOwoJCQlkYXRhID0gbnVsbDsKCQl9CgoJCXJldHVybiBqUXVlcnkuYWpheCh7CgkJCXR5cGU6ICJHRVQiLAoJCQl1cmw6IHVybCwKCQkJZGF0YTogZGF0YSwKCQkJc3VjY2VzczogY2FsbGJhY2ssCgkJCWRhdGFUeXBlOiB0eXBlCgkJfSk7Cgl9LAoKCWdldFNjcmlwdDogZnVuY3Rpb24oIHVybCwgY2FsbGJhY2sgKSB7CgkJcmV0dXJuIGpRdWVyeS5nZXQodXJsLCBudWxsLCBjYWxsYmFjaywgInNjcmlwdCIpOwoJfSwKCglnZXRKU09OOiBmdW5jdGlvbiggdXJsLCBkYXRhLCBjYWxsYmFjayApIHsKCQlyZXR1cm4galF1ZXJ5LmdldCh1cmwsIGRhdGEsIGNhbGxiYWNrLCAianNvbiIpOwoJfSwKCglwb3N0OiBmdW5jdGlvbiggdXJsLCBkYXRhLCBjYWxsYmFjaywgdHlwZSApIHsKCQkvLyBzaGlmdCBhcmd1bWVudHMgaWYgZGF0YSBhcmd1bWVudCB3YXMgb21pdGVkCgkJaWYgKCBqUXVlcnkuaXNGdW5jdGlvbiggZGF0YSApICkgewoJCQl0eXBlID0gdHlwZSB8fCBjYWxsYmFjazsKCQkJY2FsbGJhY2sgPSBkYXRhOwoJCQlkYXRhID0ge307CgkJfQoKCQlyZXR1cm4galF1ZXJ5LmFqYXgoewoJCQl0eXBlOiAiUE9TVCIsCgkJCXVybDogdXJsLAoJCQlkYXRhOiBkYXRhLAoJCQlzdWNjZXNzOiBjYWxsYmFjaywKCQkJZGF0YVR5cGU6IHR5cGUKCQl9KTsKCX0sCgoJYWpheFNldHVwOiBmdW5jdGlvbiggc2V0dGluZ3MgKSB7CgkJalF1ZXJ5LmV4dGVuZCggalF1ZXJ5LmFqYXhTZXR0aW5ncywgc2V0dGluZ3MgKTsKCX0sCgoJYWpheFNldHRpbmdzOiB7CgkJdXJsOiBsb2NhdGlvbi5ocmVmLAoJCWdsb2JhbDogdHJ1ZSwKCQl0eXBlOiAiR0VUIiwKCQljb250ZW50VHlwZTogImFwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZCIsCgkJcHJvY2Vzc0RhdGE6IHRydWUsCgkJYXN5bmM6IHRydWUsCgkJLyoKCQl0aW1lb3V0OiAwLAoJCWRhdGE6IG51bGwsCgkJdXNlcm5hbWU6IG51bGwsCgkJcGFzc3dvcmQ6IG51bGwsCgkJdHJhZGl0aW9uYWw6IGZhbHNlLAoJCSovCgkJLy8gQ3JlYXRlIHRoZSByZXF1ZXN0IG9iamVjdDsgTWljcm9zb2Z0IGZhaWxlZCB0byBwcm9wZXJseQoJCS8vIGltcGxlbWVudCB0aGUgWE1MSHR0cFJlcXVlc3QgaW4gSUU3IChjYW4ndCByZXF1ZXN0IGxvY2FsIGZpbGVzKSwKCQkvLyBzbyB3ZSB1c2UgdGhlIEFjdGl2ZVhPYmplY3Qgd2hlbiBpdCBpcyBhdmFpbGFibGUKCQkvLyBUaGlzIGZ1bmN0aW9uIGNhbiBiZSBvdmVycmlkZW4gYnkgY2FsbGluZyBqUXVlcnkuYWpheFNldHVwCgkJeGhyOiB3aW5kb3cuWE1MSHR0cFJlcXVlc3QgJiYgKHdpbmRvdy5sb2NhdGlvbi5wcm90b2NvbCAhPT0gImZpbGU6IiB8fCAhd2luZG93LkFjdGl2ZVhPYmplY3QpID8KCQkJZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gbmV3IHdpbmRvdy5YTUxIdHRwUmVxdWVzdCgpOwoJCQl9IDoKCQkJZnVuY3Rpb24oKSB7CgkJCQl0cnkgewoJCQkJCXJldHVybiBuZXcgd2luZG93LkFjdGl2ZVhPYmplY3QoIk1pY3Jvc29mdC5YTUxIVFRQIik7CgkJCQl9IGNhdGNoKGUpIHt9CgkJCX0sCgkJYWNjZXB0czogewoJCQl4bWw6ICJhcHBsaWNhdGlvbi94bWwsIHRleHQveG1sIiwKCQkJaHRtbDogInRleHQvaHRtbCIsCgkJCXNjcmlwdDogInRleHQvamF2YXNjcmlwdCwgYXBwbGljYXRpb24vamF2YXNjcmlwdCIsCgkJCWpzb246ICJhcHBsaWNhdGlvbi9qc29uLCB0ZXh0L2phdmFzY3JpcHQiLAoJCQl0ZXh0OiAidGV4dC9wbGFpbiIsCgkJCV9kZWZhdWx0OiAiKi8qIgoJCX0KCX0sCgoJLy8gTGFzdC1Nb2RpZmllZCBoZWFkZXIgY2FjaGUgZm9yIG5leHQgcmVxdWVzdAoJbGFzdE1vZGlmaWVkOiB7fSwKCWV0YWc6IHt9LAoKCWFqYXg6IGZ1bmN0aW9uKCBvcmlnU2V0dGluZ3MgKSB7CgkJdmFyIHMgPSBqUXVlcnkuZXh0ZW5kKHRydWUsIHt9LCBqUXVlcnkuYWpheFNldHRpbmdzLCBvcmlnU2V0dGluZ3MpOwoJCQoJCXZhciBqc29ucCwgc3RhdHVzLCBkYXRhLAoJCQljYWxsYmFja0NvbnRleHQgPSBvcmlnU2V0dGluZ3MgJiYgb3JpZ1NldHRpbmdzLmNvbnRleHQgfHwgcywKCQkJdHlwZSA9IHMudHlwZS50b1VwcGVyQ2FzZSgpOwoKCQkvLyBjb252ZXJ0IGRhdGEgaWYgbm90IGFscmVhZHkgYSBzdHJpbmcKCQlpZiAoIHMuZGF0YSAmJiBzLnByb2Nlc3NEYXRhICYmIHR5cGVvZiBzLmRhdGEgIT09ICJzdHJpbmciICkgewoJCQlzLmRhdGEgPSBqUXVlcnkucGFyYW0oIHMuZGF0YSwgcy50cmFkaXRpb25hbCApOwoJCX0KCgkJLy8gSGFuZGxlIEpTT05QIFBhcmFtZXRlciBDYWxsYmFja3MKCQlpZiAoIHMuZGF0YVR5cGUgPT09ICJqc29ucCIgKSB7CgkJCWlmICggdHlwZSA9PT0gIkdFVCIgKSB7CgkJCQlpZiAoICFqc3JlLnRlc3QoIHMudXJsICkgKSB7CgkJCQkJcy51cmwgKz0gKHJxdWVyeS50ZXN0KCBzLnVybCApID8gIiYiIDogIj8iKSArIChzLmpzb25wIHx8ICJjYWxsYmFjayIpICsgIj0/IjsKCQkJCX0KCQkJfSBlbHNlIGlmICggIXMuZGF0YSB8fCAhanNyZS50ZXN0KHMuZGF0YSkgKSB7CgkJCQlzLmRhdGEgPSAocy5kYXRhID8gcy5kYXRhICsgIiYiIDogIiIpICsgKHMuanNvbnAgfHwgImNhbGxiYWNrIikgKyAiPT8iOwoJCQl9CgkJCXMuZGF0YVR5cGUgPSAianNvbiI7CgkJfQoKCQkvLyBCdWlsZCB0ZW1wb3JhcnkgSlNPTlAgZnVuY3Rpb24KCQlpZiAoIHMuZGF0YVR5cGUgPT09ICJqc29uIiAmJiAocy5kYXRhICYmIGpzcmUudGVzdChzLmRhdGEpIHx8IGpzcmUudGVzdChzLnVybCkpICkgewoJCQlqc29ucCA9IHMuanNvbnBDYWxsYmFjayB8fCAoImpzb25wIiArIGpzYysrKTsKCgkJCS8vIFJlcGxhY2UgdGhlID0/IHNlcXVlbmNlIGJvdGggaW4gdGhlIHF1ZXJ5IHN0cmluZyBhbmQgdGhlIGRhdGEKCQkJaWYgKCBzLmRhdGEgKSB7CgkJCQlzLmRhdGEgPSAocy5kYXRhICsgIiIpLnJlcGxhY2UoanNyZSwgIj0iICsganNvbnAgKyAiJDEiKTsKCQkJfQoKCQkJcy51cmwgPSBzLnVybC5yZXBsYWNlKGpzcmUsICI9IiArIGpzb25wICsgIiQxIik7CgoJCQkvLyBXZSBuZWVkIHRvIG1ha2Ugc3VyZQoJCQkvLyB0aGF0IGEgSlNPTlAgc3R5bGUgcmVzcG9uc2UgaXMgZXhlY3V0ZWQgcHJvcGVybHkKCQkJcy5kYXRhVHlwZSA9ICJzY3JpcHQiOwoKCQkJLy8gSGFuZGxlIEpTT05QLXN0eWxlIGxvYWRpbmcKCQkJd2luZG93WyBqc29ucCBdID0gd2luZG93WyBqc29ucCBdIHx8IGZ1bmN0aW9uKCB0bXAgKSB7CgkJCQlkYXRhID0gdG1wOwoJCQkJc3VjY2VzcygpOwoJCQkJY29tcGxldGUoKTsKCQkJCS8vIEdhcmJhZ2UgY29sbGVjdAoJCQkJd2luZG93WyBqc29ucCBdID0gdW5kZWZpbmVkOwoKCQkJCXRyeSB7CgkJCQkJZGVsZXRlIHdpbmRvd1sganNvbnAgXTsKCQkJCX0gY2F0Y2goZSkge30KCgkJCQlpZiAoIGhlYWQgKSB7CgkJCQkJaGVhZC5yZW1vdmVDaGlsZCggc2NyaXB0ICk7CgkJCQl9CgkJCX07CgkJfQoKCQlpZiAoIHMuZGF0YVR5cGUgPT09ICJzY3JpcHQiICYmIHMuY2FjaGUgPT09IG51bGwgKSB7CgkJCXMuY2FjaGUgPSBmYWxzZTsKCQl9CgoJCWlmICggcy5jYWNoZSA9PT0gZmFsc2UgJiYgdHlwZSA9PT0gIkdFVCIgKSB7CgkJCXZhciB0cyA9IG5vdygpOwoKCQkJLy8gdHJ5IHJlcGxhY2luZyBfPSBpZiBpdCBpcyB0aGVyZQoJCQl2YXIgcmV0ID0gcy51cmwucmVwbGFjZShydHMsICIkMV89IiArIHRzICsgIiQyIik7CgoJCQkvLyBpZiBub3RoaW5nIHdhcyByZXBsYWNlZCwgYWRkIHRpbWVzdGFtcCB0byB0aGUgZW5kCgkJCXMudXJsID0gcmV0ICsgKChyZXQgPT09IHMudXJsKSA/IChycXVlcnkudGVzdChzLnVybCkgPyAiJiIgOiAiPyIpICsgIl89IiArIHRzIDogIiIpOwoJCX0KCgkJLy8gSWYgZGF0YSBpcyBhdmFpbGFibGUsIGFwcGVuZCBkYXRhIHRvIHVybCBmb3IgZ2V0IHJlcXVlc3RzCgkJaWYgKCBzLmRhdGEgJiYgdHlwZSA9PT0gIkdFVCIgKSB7CgkJCXMudXJsICs9IChycXVlcnkudGVzdChzLnVybCkgPyAiJiIgOiAiPyIpICsgcy5kYXRhOwoJCX0KCgkJLy8gV2F0Y2ggZm9yIGEgbmV3IHNldCBvZiByZXF1ZXN0cwoJCWlmICggcy5nbG9iYWwgJiYgISBqUXVlcnkuYWN0aXZlKysgKSB7CgkJCWpRdWVyeS5ldmVudC50cmlnZ2VyKCAiYWpheFN0YXJ0IiApOwoJCX0KCgkJLy8gTWF0Y2hlcyBhbiBhYnNvbHV0ZSBVUkwsIGFuZCBzYXZlcyB0aGUgZG9tYWluCgkJdmFyIHBhcnRzID0gcnVybC5leGVjKCBzLnVybCApLAoJCQlyZW1vdGUgPSBwYXJ0cyAmJiAocGFydHNbMV0gJiYgcGFydHNbMV0gIT09IGxvY2F0aW9uLnByb3RvY29sIHx8IHBhcnRzWzJdICE9PSBsb2NhdGlvbi5ob3N0KTsKCgkJLy8gSWYgd2UncmUgcmVxdWVzdGluZyBhIHJlbW90ZSBkb2N1bWVudAoJCS8vIGFuZCB0cnlpbmcgdG8gbG9hZCBKU09OIG9yIFNjcmlwdCB3aXRoIGEgR0VUCgkJaWYgKCBzLmRhdGFUeXBlID09PSAic2NyaXB0IiAmJiB0eXBlID09PSAiR0VUIiAmJiByZW1vdGUgKSB7CgkJCXZhciBoZWFkID0gZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoImhlYWQiKVswXSB8fCBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQ7CgkJCXZhciBzY3JpcHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzY3JpcHQiKTsKCQkJc2NyaXB0LnNyYyA9IHMudXJsOwoJCQlpZiAoIHMuc2NyaXB0Q2hhcnNldCApIHsKCQkJCXNjcmlwdC5jaGFyc2V0ID0gcy5zY3JpcHRDaGFyc2V0OwoJCQl9CgoJCQkvLyBIYW5kbGUgU2NyaXB0IGxvYWRpbmcKCQkJaWYgKCAhanNvbnAgKSB7CgkJCQl2YXIgZG9uZSA9IGZhbHNlOwoKCQkJCS8vIEF0dGFjaCBoYW5kbGVycyBmb3IgYWxsIGJyb3dzZXJzCgkJCQlzY3JpcHQub25sb2FkID0gc2NyaXB0Lm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGZ1bmN0aW9uKCkgewoJCQkJCWlmICggIWRvbmUgJiYgKCF0aGlzLnJlYWR5U3RhdGUgfHwKCQkJCQkJCXRoaXMucmVhZHlTdGF0ZSA9PT0gImxvYWRlZCIgfHwgdGhpcy5yZWFkeVN0YXRlID09PSAiY29tcGxldGUiKSApIHsKCQkJCQkJZG9uZSA9IHRydWU7CgkJCQkJCXN1Y2Nlc3MoKTsKCQkJCQkJY29tcGxldGUoKTsKCgkJCQkJCS8vIEhhbmRsZSBtZW1vcnkgbGVhayBpbiBJRQoJCQkJCQlzY3JpcHQub25sb2FkID0gc2NyaXB0Lm9ucmVhZHlzdGF0ZWNoYW5nZSA9IG51bGw7CgkJCQkJCWlmICggaGVhZCAmJiBzY3JpcHQucGFyZW50Tm9kZSApIHsKCQkJCQkJCWhlYWQucmVtb3ZlQ2hpbGQoIHNjcmlwdCApOwoJCQkJCQl9CgkJCQkJfQoJCQkJfTsKCQkJfQoKCQkJLy8gVXNlIGluc2VydEJlZm9yZSBpbnN0ZWFkIG9mIGFwcGVuZENoaWxkICB0byBjaXJjdW12ZW50IGFuIElFNiBidWcuCgkJCS8vIFRoaXMgYXJpc2VzIHdoZW4gYSBiYXNlIG5vZGUgaXMgdXNlZCAoIzI3MDkgYW5kICM0Mzc4KS4KCQkJaGVhZC5pbnNlcnRCZWZvcmUoIHNjcmlwdCwgaGVhZC5maXJzdENoaWxkICk7CgoJCQkvLyBXZSBoYW5kbGUgZXZlcnl0aGluZyB1c2luZyB0aGUgc2NyaXB0IGVsZW1lbnQgaW5qZWN0aW9uCgkJCXJldHVybiB1bmRlZmluZWQ7CgkJfQoKCQl2YXIgcmVxdWVzdERvbmUgPSBmYWxzZTsKCgkJLy8gQ3JlYXRlIHRoZSByZXF1ZXN0IG9iamVjdAoJCXZhciB4aHIgPSBzLnhocigpOwoKCQlpZiAoICF4aHIgKSB7CgkJCXJldHVybjsKCQl9CgoJCS8vIE9wZW4gdGhlIHNvY2tldAoJCS8vIFBhc3NpbmcgbnVsbCB1c2VybmFtZSwgZ2VuZXJhdGVzIGEgbG9naW4gcG9wdXAgb24gT3BlcmEgKCMyODY1KQoJCWlmICggcy51c2VybmFtZSApIHsKCQkJeGhyLm9wZW4odHlwZSwgcy51cmwsIHMuYXN5bmMsIHMudXNlcm5hbWUsIHMucGFzc3dvcmQpOwoJCX0gZWxzZSB7CgkJCXhoci5vcGVuKHR5cGUsIHMudXJsLCBzLmFzeW5jKTsKCQl9CgoJCS8vIE5lZWQgYW4gZXh0cmEgdHJ5L2NhdGNoIGZvciBjcm9zcyBkb21haW4gcmVxdWVzdHMgaW4gRmlyZWZveCAzCgkJdHJ5IHsKCQkJLy8gU2V0IHRoZSBjb3JyZWN0IGhlYWRlciwgaWYgZGF0YSBpcyBiZWluZyBzZW50CgkJCWlmICggcy5kYXRhIHx8IG9yaWdTZXR0aW5ncyAmJiBvcmlnU2V0dGluZ3MuY29udGVudFR5cGUgKSB7CgkJCQl4aHIuc2V0UmVxdWVzdEhlYWRlcigiQ29udGVudC1UeXBlIiwgcy5jb250ZW50VHlwZSk7CgkJCX0KCgkJCS8vIFNldCB0aGUgSWYtTW9kaWZpZWQtU2luY2UgYW5kL29yIElmLU5vbmUtTWF0Y2ggaGVhZGVyLCBpZiBpbiBpZk1vZGlmaWVkIG1vZGUuCgkJCWlmICggcy5pZk1vZGlmaWVkICkgewoJCQkJaWYgKCBqUXVlcnkubGFzdE1vZGlmaWVkW3MudXJsXSApIHsKCQkJCQl4aHIuc2V0UmVxdWVzdEhlYWRlcigiSWYtTW9kaWZpZWQtU2luY2UiLCBqUXVlcnkubGFzdE1vZGlmaWVkW3MudXJsXSk7CgkJCQl9CgoJCQkJaWYgKCBqUXVlcnkuZXRhZ1tzLnVybF0gKSB7CgkJCQkJeGhyLnNldFJlcXVlc3RIZWFkZXIoIklmLU5vbmUtTWF0Y2giLCBqUXVlcnkuZXRhZ1tzLnVybF0pOwoJCQkJfQoJCQl9CgoJCQkvLyBTZXQgaGVhZGVyIHNvIHRoZSBjYWxsZWQgc2NyaXB0IGtub3dzIHRoYXQgaXQncyBhbiBYTUxIdHRwUmVxdWVzdAoJCQkvLyBPbmx5IHNlbmQgdGhlIGhlYWRlciBpZiBpdCdzIG5vdCBhIHJlbW90ZSBYSFIKCQkJaWYgKCAhcmVtb3RlICkgewoJCQkJeGhyLnNldFJlcXVlc3RIZWFkZXIoIlgtUmVxdWVzdGVkLVdpdGgiLCAiWE1MSHR0cFJlcXVlc3QiKTsKCQkJfQoKCQkJLy8gU2V0IHRoZSBBY2NlcHRzIGhlYWRlciBmb3IgdGhlIHNlcnZlciwgZGVwZW5kaW5nIG9uIHRoZSBkYXRhVHlwZQoJCQl4aHIuc2V0UmVxdWVzdEhlYWRlcigiQWNjZXB0Iiwgcy5kYXRhVHlwZSAmJiBzLmFjY2VwdHNbIHMuZGF0YVR5cGUgXSA/CgkJCQlzLmFjY2VwdHNbIHMuZGF0YVR5cGUgXSArICIsICovKiIgOgoJCQkJcy5hY2NlcHRzLl9kZWZhdWx0ICk7CgkJfSBjYXRjaChlKSB7fQoKCQkvLyBBbGxvdyBjdXN0b20gaGVhZGVycy9taW1ldHlwZXMgYW5kIGVhcmx5IGFib3J0CgkJaWYgKCBzLmJlZm9yZVNlbmQgJiYgcy5iZWZvcmVTZW5kLmNhbGwoY2FsbGJhY2tDb250ZXh0LCB4aHIsIHMpID09PSBmYWxzZSApIHsKCQkJLy8gSGFuZGxlIHRoZSBnbG9iYWwgQUpBWCBjb3VudGVyCgkJCWlmICggcy5nbG9iYWwgJiYgISAtLWpRdWVyeS5hY3RpdmUgKSB7CgkJCQlqUXVlcnkuZXZlbnQudHJpZ2dlciggImFqYXhTdG9wIiApOwoJCQl9CgoJCQkvLyBjbG9zZSBvcGVuZGVkIHNvY2tldAoJCQl4aHIuYWJvcnQoKTsKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCgkJaWYgKCBzLmdsb2JhbCApIHsKCQkJdHJpZ2dlcigiYWpheFNlbmQiLCBbeGhyLCBzXSk7CgkJfQoKCQkvLyBXYWl0IGZvciBhIHJlc3BvbnNlIHRvIGNvbWUgYmFjawoJCXZhciBvbnJlYWR5c3RhdGVjaGFuZ2UgPSB4aHIub25yZWFkeXN0YXRlY2hhbmdlID0gZnVuY3Rpb24oIGlzVGltZW91dCApIHsKCQkJLy8gVGhlIHJlcXVlc3Qgd2FzIGFib3J0ZWQKCQkJaWYgKCAheGhyIHx8IHhoci5yZWFkeVN0YXRlID09PSAwIHx8IGlzVGltZW91dCA9PT0gImFib3J0IiApIHsKCQkJCS8vIE9wZXJhIGRvZXNuJ3QgY2FsbCBvbnJlYWR5c3RhdGVjaGFuZ2UgYmVmb3JlIHRoaXMgcG9pbnQKCQkJCS8vIHNvIHdlIHNpbXVsYXRlIHRoZSBjYWxsCgkJCQlpZiAoICFyZXF1ZXN0RG9uZSApIHsKCQkJCQljb21wbGV0ZSgpOwoJCQkJfQoKCQkJCXJlcXVlc3REb25lID0gdHJ1ZTsKCQkJCWlmICggeGhyICkgewoJCQkJCXhoci5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBqUXVlcnkubm9vcDsKCQkJCX0KCgkJCS8vIFRoZSB0cmFuc2ZlciBpcyBjb21wbGV0ZSBhbmQgdGhlIGRhdGEgaXMgYXZhaWxhYmxlLCBvciB0aGUgcmVxdWVzdCB0aW1lZCBvdXQKCQkJfSBlbHNlIGlmICggIXJlcXVlc3REb25lICYmIHhociAmJiAoeGhyLnJlYWR5U3RhdGUgPT09IDQgfHwgaXNUaW1lb3V0ID09PSAidGltZW91dCIpICkgewoJCQkJcmVxdWVzdERvbmUgPSB0cnVlOwoJCQkJeGhyLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGpRdWVyeS5ub29wOwoKCQkJCXN0YXR1cyA9IGlzVGltZW91dCA9PT0gInRpbWVvdXQiID8KCQkJCQkidGltZW91dCIgOgoJCQkJCSFqUXVlcnkuaHR0cFN1Y2Nlc3MoIHhociApID8KCQkJCQkJImVycm9yIiA6CgkJCQkJCXMuaWZNb2RpZmllZCAmJiBqUXVlcnkuaHR0cE5vdE1vZGlmaWVkKCB4aHIsIHMudXJsICkgPwoJCQkJCQkJIm5vdG1vZGlmaWVkIiA6CgkJCQkJCQkic3VjY2VzcyI7CgoJCQkJdmFyIGVyck1zZzsKCgkJCQlpZiAoIHN0YXR1cyA9PT0gInN1Y2Nlc3MiICkgewoJCQkJCS8vIFdhdGNoIGZvciwgYW5kIGNhdGNoLCBYTUwgZG9jdW1lbnQgcGFyc2UgZXJyb3JzCgkJCQkJdHJ5IHsKCQkJCQkJLy8gcHJvY2VzcyB0aGUgZGF0YSAocnVucyB0aGUgeG1sIHRocm91Z2ggaHR0cERhdGEgcmVnYXJkbGVzcyBvZiBjYWxsYmFjaykKCQkJCQkJZGF0YSA9IGpRdWVyeS5odHRwRGF0YSggeGhyLCBzLmRhdGFUeXBlLCBzICk7CgkJCQkJfSBjYXRjaChlcnIpIHsKCQkJCQkJc3RhdHVzID0gInBhcnNlcmVycm9yIjsKCQkJCQkJZXJyTXNnID0gZXJyOwoJCQkJCX0KCQkJCX0KCgkJCQkvLyBNYWtlIHN1cmUgdGhhdCB0aGUgcmVxdWVzdCB3YXMgc3VjY2Vzc2Z1bCBvciBub3Rtb2RpZmllZAoJCQkJaWYgKCBzdGF0dXMgPT09ICJzdWNjZXNzIiB8fCBzdGF0dXMgPT09ICJub3Rtb2RpZmllZCIgKSB7CgkJCQkJLy8gSlNPTlAgaGFuZGxlcyBpdHMgb3duIHN1Y2Nlc3MgY2FsbGJhY2sKCQkJCQlpZiAoICFqc29ucCApIHsKCQkJCQkJc3VjY2VzcygpOwoJCQkJCX0KCQkJCX0gZWxzZSB7CgkJCQkJalF1ZXJ5LmhhbmRsZUVycm9yKHMsIHhociwgc3RhdHVzLCBlcnJNc2cpOwoJCQkJfQoKCQkJCS8vIEZpcmUgdGhlIGNvbXBsZXRlIGhhbmRsZXJzCgkJCQljb21wbGV0ZSgpOwoKCQkJCWlmICggaXNUaW1lb3V0ID09PSAidGltZW91dCIgKSB7CgkJCQkJeGhyLmFib3J0KCk7CgkJCQl9CgoJCQkJLy8gU3RvcCBtZW1vcnkgbGVha3MKCQkJCWlmICggcy5hc3luYyApIHsKCQkJCQl4aHIgPSBudWxsOwoJCQkJfQoJCQl9CgkJfTsKCgkJLy8gT3ZlcnJpZGUgdGhlIGFib3J0IGhhbmRsZXIsIGlmIHdlIGNhbiAoSUUgZG9lc24ndCBhbGxvdyBpdCwgYnV0IHRoYXQncyBPSykKCQkvLyBPcGVyYSBkb2Vzbid0IGZpcmUgb25yZWFkeXN0YXRlY2hhbmdlIGF0IGFsbCBvbiBhYm9ydAoJCXRyeSB7CgkJCXZhciBvbGRBYm9ydCA9IHhoci5hYm9ydDsKCQkJeGhyLmFib3J0ID0gZnVuY3Rpb24oKSB7CgkJCQlpZiAoIHhociApIHsKCQkJCQlvbGRBYm9ydC5jYWxsKCB4aHIgKTsKCQkJCX0KCgkJCQlvbnJlYWR5c3RhdGVjaGFuZ2UoICJhYm9ydCIgKTsKCQkJfTsKCQl9IGNhdGNoKGUpIHsgfQoKCQkvLyBUaW1lb3V0IGNoZWNrZXIKCQlpZiAoIHMuYXN5bmMgJiYgcy50aW1lb3V0ID4gMCApIHsKCQkJc2V0VGltZW91dChmdW5jdGlvbigpIHsKCQkJCS8vIENoZWNrIHRvIHNlZSBpZiB0aGUgcmVxdWVzdCBpcyBzdGlsbCBoYXBwZW5pbmcKCQkJCWlmICggeGhyICYmICFyZXF1ZXN0RG9uZSApIHsKCQkJCQlvbnJlYWR5c3RhdGVjaGFuZ2UoICJ0aW1lb3V0IiApOwoJCQkJfQoJCQl9LCBzLnRpbWVvdXQpOwoJCX0KCgkJLy8gU2VuZCB0aGUgZGF0YQoJCXRyeSB7CgkJCXhoci5zZW5kKCB0eXBlID09PSAiUE9TVCIgfHwgdHlwZSA9PT0gIlBVVCIgfHwgdHlwZSA9PT0gIkRFTEVURSIgPyBzLmRhdGEgOiBudWxsICk7CgkJfSBjYXRjaChlKSB7CgkJCWpRdWVyeS5oYW5kbGVFcnJvcihzLCB4aHIsIG51bGwsIGUpOwoJCQkvLyBGaXJlIHRoZSBjb21wbGV0ZSBoYW5kbGVycwoJCQljb21wbGV0ZSgpOwoJCX0KCgkJLy8gZmlyZWZveCAxLjUgZG9lc24ndCBmaXJlIHN0YXRlY2hhbmdlIGZvciBzeW5jIHJlcXVlc3RzCgkJaWYgKCAhcy5hc3luYyApIHsKCQkJb25yZWFkeXN0YXRlY2hhbmdlKCk7CgkJfQoKCQlmdW5jdGlvbiBzdWNjZXNzKCkgewoJCQkvLyBJZiBhIGxvY2FsIGNhbGxiYWNrIHdhcyBzcGVjaWZpZWQsIGZpcmUgaXQgYW5kIHBhc3MgaXQgdGhlIGRhdGEKCQkJaWYgKCBzLnN1Y2Nlc3MgKSB7CgkJCQlzLnN1Y2Nlc3MuY2FsbCggY2FsbGJhY2tDb250ZXh0LCBkYXRhLCBzdGF0dXMsIHhociApOwoJCQl9CgoJCQkvLyBGaXJlIHRoZSBnbG9iYWwgY2FsbGJhY2sKCQkJaWYgKCBzLmdsb2JhbCApIHsKCQkJCXRyaWdnZXIoICJhamF4U3VjY2VzcyIsIFt4aHIsIHNdICk7CgkJCX0KCQl9CgoJCWZ1bmN0aW9uIGNvbXBsZXRlKCkgewoJCQkvLyBQcm9jZXNzIHJlc3VsdAoJCQlpZiAoIHMuY29tcGxldGUgKSB7CgkJCQlzLmNvbXBsZXRlLmNhbGwoIGNhbGxiYWNrQ29udGV4dCwgeGhyLCBzdGF0dXMpOwoJCQl9CgoJCQkvLyBUaGUgcmVxdWVzdCB3YXMgY29tcGxldGVkCgkJCWlmICggcy5nbG9iYWwgKSB7CgkJCQl0cmlnZ2VyKCAiYWpheENvbXBsZXRlIiwgW3hociwgc10gKTsKCQkJfQoKCQkJLy8gSGFuZGxlIHRoZSBnbG9iYWwgQUpBWCBjb3VudGVyCgkJCWlmICggcy5nbG9iYWwgJiYgISAtLWpRdWVyeS5hY3RpdmUgKSB7CgkJCQlqUXVlcnkuZXZlbnQudHJpZ2dlciggImFqYXhTdG9wIiApOwoJCQl9CgkJfQoJCQoJCWZ1bmN0aW9uIHRyaWdnZXIodHlwZSwgYXJncykgewoJCQkocy5jb250ZXh0ID8galF1ZXJ5KHMuY29udGV4dCkgOiBqUXVlcnkuZXZlbnQpLnRyaWdnZXIodHlwZSwgYXJncyk7CgkJfQoKCQkvLyByZXR1cm4gWE1MSHR0cFJlcXVlc3QgdG8gYWxsb3cgYWJvcnRpbmcgdGhlIHJlcXVlc3QgZXRjLgoJCXJldHVybiB4aHI7Cgl9LAoKCWhhbmRsZUVycm9yOiBmdW5jdGlvbiggcywgeGhyLCBzdGF0dXMsIGUgKSB7CgkJLy8gSWYgYSBsb2NhbCBjYWxsYmFjayB3YXMgc3BlY2lmaWVkLCBmaXJlIGl0CgkJaWYgKCBzLmVycm9yICkgewoJCQlzLmVycm9yLmNhbGwoIHMuY29udGV4dCB8fCBzLCB4aHIsIHN0YXR1cywgZSApOwoJCX0KCgkJLy8gRmlyZSB0aGUgZ2xvYmFsIGNhbGxiYWNrCgkJaWYgKCBzLmdsb2JhbCApIHsKCQkJKHMuY29udGV4dCA/IGpRdWVyeShzLmNvbnRleHQpIDogalF1ZXJ5LmV2ZW50KS50cmlnZ2VyKCAiYWpheEVycm9yIiwgW3hociwgcywgZV0gKTsKCQl9Cgl9LAoKCS8vIENvdW50ZXIgZm9yIGhvbGRpbmcgdGhlIG51bWJlciBvZiBhY3RpdmUgcXVlcmllcwoJYWN0aXZlOiAwLAoKCS8vIERldGVybWluZXMgaWYgYW4gWE1MSHR0cFJlcXVlc3Qgd2FzIHN1Y2Nlc3NmdWwgb3Igbm90CglodHRwU3VjY2VzczogZnVuY3Rpb24oIHhociApIHsKCQl0cnkgewoJCQkvLyBJRSBlcnJvciBzb21ldGltZXMgcmV0dXJucyAxMjIzIHdoZW4gaXQgc2hvdWxkIGJlIDIwNCBzbyB0cmVhdCBpdCBhcyBzdWNjZXNzLCBzZWUgIzE0NTAKCQkJcmV0dXJuICF4aHIuc3RhdHVzICYmIGxvY2F0aW9uLnByb3RvY29sID09PSAiZmlsZToiIHx8CgkJCQkvLyBPcGVyYSByZXR1cm5zIDAgd2hlbiBzdGF0dXMgaXMgMzA0CgkJCQkoIHhoci5zdGF0dXMgPj0gMjAwICYmIHhoci5zdGF0dXMgPCAzMDAgKSB8fAoJCQkJeGhyLnN0YXR1cyA9PT0gMzA0IHx8IHhoci5zdGF0dXMgPT09IDEyMjMgfHwgeGhyLnN0YXR1cyA9PT0gMDsKCQl9IGNhdGNoKGUpIHt9CgoJCXJldHVybiBmYWxzZTsKCX0sCgoJLy8gRGV0ZXJtaW5lcyBpZiBhbiBYTUxIdHRwUmVxdWVzdCByZXR1cm5zIE5vdE1vZGlmaWVkCglodHRwTm90TW9kaWZpZWQ6IGZ1bmN0aW9uKCB4aHIsIHVybCApIHsKCQl2YXIgbGFzdE1vZGlmaWVkID0geGhyLmdldFJlc3BvbnNlSGVhZGVyKCJMYXN0LU1vZGlmaWVkIiksCgkJCWV0YWcgPSB4aHIuZ2V0UmVzcG9uc2VIZWFkZXIoIkV0YWciKTsKCgkJaWYgKCBsYXN0TW9kaWZpZWQgKSB7CgkJCWpRdWVyeS5sYXN0TW9kaWZpZWRbdXJsXSA9IGxhc3RNb2RpZmllZDsKCQl9CgoJCWlmICggZXRhZyApIHsKCQkJalF1ZXJ5LmV0YWdbdXJsXSA9IGV0YWc7CgkJfQoKCQkvLyBPcGVyYSByZXR1cm5zIDAgd2hlbiBzdGF0dXMgaXMgMzA0CgkJcmV0dXJuIHhoci5zdGF0dXMgPT09IDMwNCB8fCB4aHIuc3RhdHVzID09PSAwOwoJfSwKCglodHRwRGF0YTogZnVuY3Rpb24oIHhociwgdHlwZSwgcyApIHsKCQl2YXIgY3QgPSB4aHIuZ2V0UmVzcG9uc2VIZWFkZXIoImNvbnRlbnQtdHlwZSIpIHx8ICIiLAoJCQl4bWwgPSB0eXBlID09PSAieG1sIiB8fCAhdHlwZSAmJiBjdC5pbmRleE9mKCJ4bWwiKSA+PSAwLAoJCQlkYXRhID0geG1sID8geGhyLnJlc3BvbnNlWE1MIDogeGhyLnJlc3BvbnNlVGV4dDsKCgkJaWYgKCB4bWwgJiYgZGF0YS5kb2N1bWVudEVsZW1lbnQubm9kZU5hbWUgPT09ICJwYXJzZXJlcnJvciIgKSB7CgkJCWpRdWVyeS5lcnJvciggInBhcnNlcmVycm9yIiApOwoJCX0KCgkJLy8gQWxsb3cgYSBwcmUtZmlsdGVyaW5nIGZ1bmN0aW9uIHRvIHNhbml0aXplIHRoZSByZXNwb25zZQoJCS8vIHMgaXMgY2hlY2tlZCB0byBrZWVwIGJhY2t3YXJkcyBjb21wYXRpYmlsaXR5CgkJaWYgKCBzICYmIHMuZGF0YUZpbHRlciApIHsKCQkJZGF0YSA9IHMuZGF0YUZpbHRlciggZGF0YSwgdHlwZSApOwoJCX0KCgkJLy8gVGhlIGZpbHRlciBjYW4gYWN0dWFsbHkgcGFyc2UgdGhlIHJlc3BvbnNlCgkJaWYgKCB0eXBlb2YgZGF0YSA9PT0gInN0cmluZyIgKSB7CgkJCS8vIEdldCB0aGUgSmF2YVNjcmlwdCBvYmplY3QsIGlmIEpTT04gaXMgdXNlZC4KCQkJaWYgKCB0eXBlID09PSAianNvbiIgfHwgIXR5cGUgJiYgY3QuaW5kZXhPZigianNvbiIpID49IDAgKSB7CgkJCQlkYXRhID0galF1ZXJ5LnBhcnNlSlNPTiggZGF0YSApOwoKCQkJLy8gSWYgdGhlIHR5cGUgaXMgInNjcmlwdCIsIGV2YWwgaXQgaW4gZ2xvYmFsIGNvbnRleHQKCQkJfSBlbHNlIGlmICggdHlwZSA9PT0gInNjcmlwdCIgfHwgIXR5cGUgJiYgY3QuaW5kZXhPZigiamF2YXNjcmlwdCIpID49IDAgKSB7CgkJCQlqUXVlcnkuZ2xvYmFsRXZhbCggZGF0YSApOwoJCQl9CgkJfQoKCQlyZXR1cm4gZGF0YTsKCX0sCgoJLy8gU2VyaWFsaXplIGFuIGFycmF5IG9mIGZvcm0gZWxlbWVudHMgb3IgYSBzZXQgb2YKCS8vIGtleS92YWx1ZXMgaW50byBhIHF1ZXJ5IHN0cmluZwoJcGFyYW06IGZ1bmN0aW9uKCBhLCB0cmFkaXRpb25hbCApIHsKCQl2YXIgcyA9IFtdOwoJCQoJCS8vIFNldCB0cmFkaXRpb25hbCB0byB0cnVlIGZvciBqUXVlcnkgPD0gMS4zLjIgYmVoYXZpb3IuCgkJaWYgKCB0cmFkaXRpb25hbCA9PT0gdW5kZWZpbmVkICkgewoJCQl0cmFkaXRpb25hbCA9IGpRdWVyeS5hamF4U2V0dGluZ3MudHJhZGl0aW9uYWw7CgkJfQoJCQoJCS8vIElmIGFuIGFycmF5IHdhcyBwYXNzZWQgaW4sIGFzc3VtZSB0aGF0IGl0IGlzIGFuIGFycmF5IG9mIGZvcm0gZWxlbWVudHMuCgkJaWYgKCBqUXVlcnkuaXNBcnJheShhKSB8fCBhLmpxdWVyeSApIHsKCQkJLy8gU2VyaWFsaXplIHRoZSBmb3JtIGVsZW1lbnRzCgkJCWpRdWVyeS5lYWNoKCBhLCBmdW5jdGlvbigpIHsKCQkJCWFkZCggdGhpcy5uYW1lLCB0aGlzLnZhbHVlICk7CgkJCX0pOwoJCQkKCQl9IGVsc2UgewoJCQkvLyBJZiB0cmFkaXRpb25hbCwgZW5jb2RlIHRoZSAib2xkIiB3YXkgKHRoZSB3YXkgMS4zLjIgb3Igb2xkZXIKCQkJLy8gZGlkIGl0KSwgb3RoZXJ3aXNlIGVuY29kZSBwYXJhbXMgcmVjdXJzaXZlbHkuCgkJCWZvciAoIHZhciBwcmVmaXggaW4gYSApIHsKCQkJCWJ1aWxkUGFyYW1zKCBwcmVmaXgsIGFbcHJlZml4XSApOwoJCQl9CgkJfQoKCQkvLyBSZXR1cm4gdGhlIHJlc3VsdGluZyBzZXJpYWxpemF0aW9uCgkJcmV0dXJuIHMuam9pbigiJiIpLnJlcGxhY2UocjIwLCAiKyIpOwoKCQlmdW5jdGlvbiBidWlsZFBhcmFtcyggcHJlZml4LCBvYmogKSB7CgkJCWlmICggalF1ZXJ5LmlzQXJyYXkob2JqKSApIHsKCQkJCS8vIFNlcmlhbGl6ZSBhcnJheSBpdGVtLgoJCQkJalF1ZXJ5LmVhY2goIG9iaiwgZnVuY3Rpb24oIGksIHYgKSB7CgkJCQkJaWYgKCB0cmFkaXRpb25hbCB8fCAvXFtcXSQvLnRlc3QoIHByZWZpeCApICkgewoJCQkJCQkvLyBUcmVhdCBlYWNoIGFycmF5IGl0ZW0gYXMgYSBzY2FsYXIuCgkJCQkJCWFkZCggcHJlZml4LCB2ICk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJLy8gSWYgYXJyYXkgaXRlbSBpcyBub24tc2NhbGFyIChhcnJheSBvciBvYmplY3QpLCBlbmNvZGUgaXRzCgkJCQkJCS8vIG51bWVyaWMgaW5kZXggdG8gcmVzb2x2ZSBkZXNlcmlhbGl6YXRpb24gYW1iaWd1aXR5IGlzc3Vlcy4KCQkJCQkJLy8gTm90ZSB0aGF0IHJhY2sgKGFzIG9mIDEuMC4wKSBjYW4ndCBjdXJyZW50bHkgZGVzZXJpYWxpemUKCQkJCQkJLy8gbmVzdGVkIGFycmF5cyBwcm9wZXJseSwgYW5kIGF0dGVtcHRpbmcgdG8gZG8gc28gbWF5IGNhdXNlCgkJCQkJCS8vIGEgc2VydmVyIGVycm9yLiBQb3NzaWJsZSBmaXhlcyBhcmUgdG8gbW9kaWZ5IHJhY2sncwoJCQkJCQkvLyBkZXNlcmlhbGl6YXRpb24gYWxnb3JpdGhtIG9yIHRvIHByb3ZpZGUgYW4gb3B0aW9uIG9yIGZsYWcKCQkJCQkJLy8gdG8gZm9yY2UgYXJyYXkgc2VyaWFsaXphdGlvbiB0byBiZSBzaGFsbG93LgoJCQkJCQlidWlsZFBhcmFtcyggcHJlZml4ICsgIlsiICsgKCB0eXBlb2YgdiA9PT0gIm9iamVjdCIgfHwgalF1ZXJ5LmlzQXJyYXkodikgPyBpIDogIiIgKSArICJdIiwgdiApOwoJCQkJCX0KCQkJCX0pOwoJCQkJCQoJCQl9IGVsc2UgaWYgKCAhdHJhZGl0aW9uYWwgJiYgb2JqICE9IG51bGwgJiYgdHlwZW9mIG9iaiA9PT0gIm9iamVjdCIgKSB7CgkJCQkvLyBTZXJpYWxpemUgb2JqZWN0IGl0ZW0uCgkJCQlqUXVlcnkuZWFjaCggb2JqLCBmdW5jdGlvbiggaywgdiApIHsKCQkJCQlidWlsZFBhcmFtcyggcHJlZml4ICsgIlsiICsgayArICJdIiwgdiApOwoJCQkJfSk7CgkJCQkJCgkJCX0gZWxzZSB7CgkJCQkvLyBTZXJpYWxpemUgc2NhbGFyIGl0ZW0uCgkJCQlhZGQoIHByZWZpeCwgb2JqICk7CgkJCX0KCQl9CgoJCWZ1bmN0aW9uIGFkZCgga2V5LCB2YWx1ZSApIHsKCQkJLy8gSWYgdmFsdWUgaXMgYSBmdW5jdGlvbiwgaW52b2tlIGl0IGFuZCByZXR1cm4gaXRzIHZhbHVlCgkJCXZhbHVlID0galF1ZXJ5LmlzRnVuY3Rpb24odmFsdWUpID8gdmFsdWUoKSA6IHZhbHVlOwoJCQlzWyBzLmxlbmd0aCBdID0gZW5jb2RlVVJJQ29tcG9uZW50KGtleSkgKyAiPSIgKyBlbmNvZGVVUklDb21wb25lbnQodmFsdWUpOwoJCX0KCX0KfSk7CnZhciBlbGVtZGlzcGxheSA9IHt9LAoJcmZ4dHlwZXMgPSAvdG9nZ2xlfHNob3d8aGlkZS8sCglyZnhudW0gPSAvXihbKy1dPSk/KFtcZCstLl0rKSguKikkLywKCXRpbWVySWQsCglmeEF0dHJzID0gWwoJCS8vIGhlaWdodCBhbmltYXRpb25zCgkJWyAiaGVpZ2h0IiwgIm1hcmdpblRvcCIsICJtYXJnaW5Cb3R0b20iLCAicGFkZGluZ1RvcCIsICJwYWRkaW5nQm90dG9tIiBdLAoJCS8vIHdpZHRoIGFuaW1hdGlvbnMKCQlbICJ3aWR0aCIsICJtYXJnaW5MZWZ0IiwgIm1hcmdpblJpZ2h0IiwgInBhZGRpbmdMZWZ0IiwgInBhZGRpbmdSaWdodCIgXSwKCQkvLyBvcGFjaXR5IGFuaW1hdGlvbnMKCQlbICJvcGFjaXR5IiBdCgldOwoKalF1ZXJ5LmZuLmV4dGVuZCh7CglzaG93OiBmdW5jdGlvbiggc3BlZWQsIGNhbGxiYWNrICkgewoJCWlmICggc3BlZWQgfHwgc3BlZWQgPT09IDApIHsKCQkJcmV0dXJuIHRoaXMuYW5pbWF0ZSggZ2VuRngoInNob3ciLCAzKSwgc3BlZWQsIGNhbGxiYWNrKTsKCgkJfSBlbHNlIHsKCQkJZm9yICggdmFyIGkgPSAwLCBsID0gdGhpcy5sZW5ndGg7IGkgPCBsOyBpKysgKSB7CgkJCQl2YXIgb2xkID0galF1ZXJ5LmRhdGEodGhpc1tpXSwgIm9sZGRpc3BsYXkiKTsKCgkJCQl0aGlzW2ldLnN0eWxlLmRpc3BsYXkgPSBvbGQgfHwgIiI7CgoJCQkJaWYgKCBqUXVlcnkuY3NzKHRoaXNbaV0sICJkaXNwbGF5IikgPT09ICJub25lIiApIHsKCQkJCQl2YXIgbm9kZU5hbWUgPSB0aGlzW2ldLm5vZGVOYW1lLCBkaXNwbGF5OwoKCQkJCQlpZiAoIGVsZW1kaXNwbGF5WyBub2RlTmFtZSBdICkgewoJCQkJCQlkaXNwbGF5ID0gZWxlbWRpc3BsYXlbIG5vZGVOYW1lIF07CgoJCQkJCX0gZWxzZSB7CgkJCQkJCXZhciBlbGVtID0galF1ZXJ5KCI8IiArIG5vZGVOYW1lICsgIiAvPiIpLmFwcGVuZFRvKCJib2R5Iik7CgoJCQkJCQlkaXNwbGF5ID0gZWxlbS5jc3MoImRpc3BsYXkiKTsKCgkJCQkJCWlmICggZGlzcGxheSA9PT0gIm5vbmUiICkgewoJCQkJCQkJZGlzcGxheSA9ICJibG9jayI7CgkJCQkJCX0KCgkJCQkJCWVsZW0ucmVtb3ZlKCk7CgoJCQkJCQllbGVtZGlzcGxheVsgbm9kZU5hbWUgXSA9IGRpc3BsYXk7CgkJCQkJfQoKCQkJCQlqUXVlcnkuZGF0YSh0aGlzW2ldLCAib2xkZGlzcGxheSIsIGRpc3BsYXkpOwoJCQkJfQoJCQl9CgoJCQkvLyBTZXQgdGhlIGRpc3BsYXkgb2YgdGhlIGVsZW1lbnRzIGluIGEgc2Vjb25kIGxvb3AKCQkJLy8gdG8gYXZvaWQgdGhlIGNvbnN0YW50IHJlZmxvdwoJCQlmb3IgKCB2YXIgaiA9IDAsIGsgPSB0aGlzLmxlbmd0aDsgaiA8IGs7IGorKyApIHsKCQkJCXRoaXNbal0uc3R5bGUuZGlzcGxheSA9IGpRdWVyeS5kYXRhKHRoaXNbal0sICJvbGRkaXNwbGF5IikgfHwgIiI7CgkJCX0KCgkJCXJldHVybiB0aGlzOwoJCX0KCX0sCgoJaGlkZTogZnVuY3Rpb24oIHNwZWVkLCBjYWxsYmFjayApIHsKCQlpZiAoIHNwZWVkIHx8IHNwZWVkID09PSAwICkgewoJCQlyZXR1cm4gdGhpcy5hbmltYXRlKCBnZW5GeCgiaGlkZSIsIDMpLCBzcGVlZCwgY2FsbGJhY2spOwoKCQl9IGVsc2UgewoJCQlmb3IgKCB2YXIgaSA9IDAsIGwgPSB0aGlzLmxlbmd0aDsgaSA8IGw7IGkrKyApIHsKCQkJCXZhciBvbGQgPSBqUXVlcnkuZGF0YSh0aGlzW2ldLCAib2xkZGlzcGxheSIpOwoJCQkJaWYgKCAhb2xkICYmIG9sZCAhPT0gIm5vbmUiICkgewoJCQkJCWpRdWVyeS5kYXRhKHRoaXNbaV0sICJvbGRkaXNwbGF5IiwgalF1ZXJ5LmNzcyh0aGlzW2ldLCAiZGlzcGxheSIpKTsKCQkJCX0KCQkJfQoKCQkJLy8gU2V0IHRoZSBkaXNwbGF5IG9mIHRoZSBlbGVtZW50cyBpbiBhIHNlY29uZCBsb29wCgkJCS8vIHRvIGF2b2lkIHRoZSBjb25zdGFudCByZWZsb3cKCQkJZm9yICggdmFyIGogPSAwLCBrID0gdGhpcy5sZW5ndGg7IGogPCBrOyBqKysgKSB7CgkJCQl0aGlzW2pdLnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7CgkJCX0KCgkJCXJldHVybiB0aGlzOwoJCX0KCX0sCgoJLy8gU2F2ZSB0aGUgb2xkIHRvZ2dsZSBmdW5jdGlvbgoJX3RvZ2dsZTogalF1ZXJ5LmZuLnRvZ2dsZSwKCgl0b2dnbGU6IGZ1bmN0aW9uKCBmbiwgZm4yICkgewoJCXZhciBib29sID0gdHlwZW9mIGZuID09PSAiYm9vbGVhbiI7CgoJCWlmICggalF1ZXJ5LmlzRnVuY3Rpb24oZm4pICYmIGpRdWVyeS5pc0Z1bmN0aW9uKGZuMikgKSB7CgkJCXRoaXMuX3RvZ2dsZS5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgoJCX0gZWxzZSBpZiAoIGZuID09IG51bGwgfHwgYm9vbCApIHsKCQkJdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJdmFyIHN0YXRlID0gYm9vbCA/IGZuIDogalF1ZXJ5KHRoaXMpLmlzKCI6aGlkZGVuIik7CgkJCQlqUXVlcnkodGhpcylbIHN0YXRlID8gInNob3ciIDogImhpZGUiIF0oKTsKCQkJfSk7CgoJCX0gZWxzZSB7CgkJCXRoaXMuYW5pbWF0ZShnZW5GeCgidG9nZ2xlIiwgMyksIGZuLCBmbjIpOwoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWZhZGVUbzogZnVuY3Rpb24oIHNwZWVkLCB0bywgY2FsbGJhY2sgKSB7CgkJcmV0dXJuIHRoaXMuZmlsdGVyKCI6aGlkZGVuIikuY3NzKCJvcGFjaXR5IiwgMCkuc2hvdygpLmVuZCgpCgkJCQkJLmFuaW1hdGUoe29wYWNpdHk6IHRvfSwgc3BlZWQsIGNhbGxiYWNrKTsKCX0sCgoJYW5pbWF0ZTogZnVuY3Rpb24oIHByb3AsIHNwZWVkLCBlYXNpbmcsIGNhbGxiYWNrICkgewoJCXZhciBvcHRhbGwgPSBqUXVlcnkuc3BlZWQoc3BlZWQsIGVhc2luZywgY2FsbGJhY2spOwoKCQlpZiAoIGpRdWVyeS5pc0VtcHR5T2JqZWN0KCBwcm9wICkgKSB7CgkJCXJldHVybiB0aGlzLmVhY2goIG9wdGFsbC5jb21wbGV0ZSApOwoJCX0KCgkJcmV0dXJuIHRoaXNbIG9wdGFsbC5xdWV1ZSA9PT0gZmFsc2UgPyAiZWFjaCIgOiAicXVldWUiIF0oZnVuY3Rpb24oKSB7CgkJCXZhciBvcHQgPSBqUXVlcnkuZXh0ZW5kKHt9LCBvcHRhbGwpLCBwLAoJCQkJaGlkZGVuID0gdGhpcy5ub2RlVHlwZSA9PT0gMSAmJiBqUXVlcnkodGhpcykuaXMoIjpoaWRkZW4iKSwKCQkJCXNlbGYgPSB0aGlzOwoKCQkJZm9yICggcCBpbiBwcm9wICkgewoJCQkJdmFyIG5hbWUgPSBwLnJlcGxhY2UocmRhc2hBbHBoYSwgZmNhbWVsQ2FzZSk7CgoJCQkJaWYgKCBwICE9PSBuYW1lICkgewoJCQkJCXByb3BbIG5hbWUgXSA9IHByb3BbIHAgXTsKCQkJCQlkZWxldGUgcHJvcFsgcCBdOwoJCQkJCXAgPSBuYW1lOwoJCQkJfQoKCQkJCWlmICggcHJvcFtwXSA9PT0gImhpZGUiICYmIGhpZGRlbiB8fCBwcm9wW3BdID09PSAic2hvdyIgJiYgIWhpZGRlbiApIHsKCQkJCQlyZXR1cm4gb3B0LmNvbXBsZXRlLmNhbGwodGhpcyk7CgkJCQl9CgoJCQkJaWYgKCAoIHAgPT09ICJoZWlnaHQiIHx8IHAgPT09ICJ3aWR0aCIgKSAmJiB0aGlzLnN0eWxlICkgewoJCQkJCS8vIFN0b3JlIGRpc3BsYXkgcHJvcGVydHkKCQkJCQlvcHQuZGlzcGxheSA9IGpRdWVyeS5jc3ModGhpcywgImRpc3BsYXkiKTsKCgkJCQkJLy8gTWFrZSBzdXJlIHRoYXQgbm90aGluZyBzbmVha3Mgb3V0CgkJCQkJb3B0Lm92ZXJmbG93ID0gdGhpcy5zdHlsZS5vdmVyZmxvdzsKCQkJCX0KCgkJCQlpZiAoIGpRdWVyeS5pc0FycmF5KCBwcm9wW3BdICkgKSB7CgkJCQkJLy8gQ3JlYXRlIChpZiBuZWVkZWQpIGFuZCBhZGQgdG8gc3BlY2lhbEVhc2luZwoJCQkJCShvcHQuc3BlY2lhbEVhc2luZyA9IG9wdC5zcGVjaWFsRWFzaW5nIHx8IHt9KVtwXSA9IHByb3BbcF1bMV07CgkJCQkJcHJvcFtwXSA9IHByb3BbcF1bMF07CgkJCQl9CgkJCX0KCgkJCWlmICggb3B0Lm92ZXJmbG93ICE9IG51bGwgKSB7CgkJCQl0aGlzLnN0eWxlLm92ZXJmbG93ID0gImhpZGRlbiI7CgkJCX0KCgkJCW9wdC5jdXJBbmltID0galF1ZXJ5LmV4dGVuZCh7fSwgcHJvcCk7CgoJCQlqUXVlcnkuZWFjaCggcHJvcCwgZnVuY3Rpb24oIG5hbWUsIHZhbCApIHsKCQkJCXZhciBlID0gbmV3IGpRdWVyeS5meCggc2VsZiwgb3B0LCBuYW1lICk7CgoJCQkJaWYgKCByZnh0eXBlcy50ZXN0KHZhbCkgKSB7CgkJCQkJZVsgdmFsID09PSAidG9nZ2xlIiA/IGhpZGRlbiA/ICJzaG93IiA6ICJoaWRlIiA6IHZhbCBdKCBwcm9wICk7CgoJCQkJfSBlbHNlIHsKCQkJCQl2YXIgcGFydHMgPSByZnhudW0uZXhlYyh2YWwpLAoJCQkJCQlzdGFydCA9IGUuY3VyKHRydWUpIHx8IDA7CgoJCQkJCWlmICggcGFydHMgKSB7CgkJCQkJCXZhciBlbmQgPSBwYXJzZUZsb2F0KCBwYXJ0c1syXSApLAoJCQkJCQkJdW5pdCA9IHBhcnRzWzNdIHx8ICJweCI7CgoJCQkJCQkvLyBXZSBuZWVkIHRvIGNvbXB1dGUgc3RhcnRpbmcgdmFsdWUKCQkJCQkJaWYgKCB1bml0ICE9PSAicHgiICkgewoJCQkJCQkJc2VsZi5zdHlsZVsgbmFtZSBdID0gKGVuZCB8fCAxKSArIHVuaXQ7CgkJCQkJCQlzdGFydCA9ICgoZW5kIHx8IDEpIC8gZS5jdXIodHJ1ZSkpICogc3RhcnQ7CgkJCQkJCQlzZWxmLnN0eWxlWyBuYW1lIF0gPSBzdGFydCArIHVuaXQ7CgkJCQkJCX0KCgkJCQkJCS8vIElmIGEgKz0vLT0gdG9rZW4gd2FzIHByb3ZpZGVkLCB3ZSdyZSBkb2luZyBhIHJlbGF0aXZlIGFuaW1hdGlvbgoJCQkJCQlpZiAoIHBhcnRzWzFdICkgewoJCQkJCQkJZW5kID0gKChwYXJ0c1sxXSA9PT0gIi09IiA/IC0xIDogMSkgKiBlbmQpICsgc3RhcnQ7CgkJCQkJCX0KCgkJCQkJCWUuY3VzdG9tKCBzdGFydCwgZW5kLCB1bml0ICk7CgoJCQkJCX0gZWxzZSB7CgkJCQkJCWUuY3VzdG9tKCBzdGFydCwgdmFsLCAiIiApOwoJCQkJCX0KCQkJCX0KCQkJfSk7CgoJCQkvLyBGb3IgSlMgc3RyaWN0IGNvbXBsaWFuY2UKCQkJcmV0dXJuIHRydWU7CgkJfSk7Cgl9LAoKCXN0b3A6IGZ1bmN0aW9uKCBjbGVhclF1ZXVlLCBnb3RvRW5kICkgewoJCXZhciB0aW1lcnMgPSBqUXVlcnkudGltZXJzOwoKCQlpZiAoIGNsZWFyUXVldWUgKSB7CgkJCXRoaXMucXVldWUoW10pOwoJCX0KCgkJdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQkvLyBnbyBpbiByZXZlcnNlIG9yZGVyIHNvIGFueXRoaW5nIGFkZGVkIHRvIHRoZSBxdWV1ZSBkdXJpbmcgdGhlIGxvb3AgaXMgaWdub3JlZAoJCQlmb3IgKCB2YXIgaSA9IHRpbWVycy5sZW5ndGggLSAxOyBpID49IDA7IGktLSApIHsKCQkJCWlmICggdGltZXJzW2ldLmVsZW0gPT09IHRoaXMgKSB7CgkJCQkJaWYgKGdvdG9FbmQpIHsKCQkJCQkJLy8gZm9yY2UgdGhlIG5leHQgc3RlcCB0byBiZSB0aGUgbGFzdAoJCQkJCQl0aW1lcnNbaV0odHJ1ZSk7CgkJCQkJfQoKCQkJCQl0aW1lcnMuc3BsaWNlKGksIDEpOwoJCQkJfQoJCQl9CgkJfSk7CgoJCS8vIHN0YXJ0IHRoZSBuZXh0IGluIHRoZSBxdWV1ZSBpZiB0aGUgbGFzdCBzdGVwIHdhc24ndCBmb3JjZWQKCQlpZiAoICFnb3RvRW5kICkgewoJCQl0aGlzLmRlcXVldWUoKTsKCQl9CgoJCXJldHVybiB0aGlzOwoJfQoKfSk7CgovLyBHZW5lcmF0ZSBzaG9ydGN1dHMgZm9yIGN1c3RvbSBhbmltYXRpb25zCmpRdWVyeS5lYWNoKHsKCXNsaWRlRG93bjogZ2VuRngoInNob3ciLCAxKSwKCXNsaWRlVXA6IGdlbkZ4KCJoaWRlIiwgMSksCglzbGlkZVRvZ2dsZTogZ2VuRngoInRvZ2dsZSIsIDEpLAoJZmFkZUluOiB7IG9wYWNpdHk6ICJzaG93IiB9LAoJZmFkZU91dDogeyBvcGFjaXR5OiAiaGlkZSIgfQp9LCBmdW5jdGlvbiggbmFtZSwgcHJvcHMgKSB7CglqUXVlcnkuZm5bIG5hbWUgXSA9IGZ1bmN0aW9uKCBzcGVlZCwgY2FsbGJhY2sgKSB7CgkJcmV0dXJuIHRoaXMuYW5pbWF0ZSggcHJvcHMsIHNwZWVkLCBjYWxsYmFjayApOwoJfTsKfSk7CgpqUXVlcnkuZXh0ZW5kKHsKCXNwZWVkOiBmdW5jdGlvbiggc3BlZWQsIGVhc2luZywgZm4gKSB7CgkJdmFyIG9wdCA9IHNwZWVkICYmIHR5cGVvZiBzcGVlZCA9PT0gIm9iamVjdCIgPyBzcGVlZCA6IHsKCQkJY29tcGxldGU6IGZuIHx8ICFmbiAmJiBlYXNpbmcgfHwKCQkJCWpRdWVyeS5pc0Z1bmN0aW9uKCBzcGVlZCApICYmIHNwZWVkLAoJCQlkdXJhdGlvbjogc3BlZWQsCgkJCWVhc2luZzogZm4gJiYgZWFzaW5nIHx8IGVhc2luZyAmJiAhalF1ZXJ5LmlzRnVuY3Rpb24oZWFzaW5nKSAmJiBlYXNpbmcKCQl9OwoKCQlvcHQuZHVyYXRpb24gPSBqUXVlcnkuZngub2ZmID8gMCA6IHR5cGVvZiBvcHQuZHVyYXRpb24gPT09ICJudW1iZXIiID8gb3B0LmR1cmF0aW9uIDoKCQkJalF1ZXJ5LmZ4LnNwZWVkc1tvcHQuZHVyYXRpb25dIHx8IGpRdWVyeS5meC5zcGVlZHMuX2RlZmF1bHQ7CgoJCS8vIFF1ZXVlaW5nCgkJb3B0Lm9sZCA9IG9wdC5jb21wbGV0ZTsKCQlvcHQuY29tcGxldGUgPSBmdW5jdGlvbigpIHsKCQkJaWYgKCBvcHQucXVldWUgIT09IGZhbHNlICkgewoJCQkJalF1ZXJ5KHRoaXMpLmRlcXVldWUoKTsKCQkJfQoJCQlpZiAoIGpRdWVyeS5pc0Z1bmN0aW9uKCBvcHQub2xkICkgKSB7CgkJCQlvcHQub2xkLmNhbGwoIHRoaXMgKTsKCQkJfQoJCX07CgoJCXJldHVybiBvcHQ7Cgl9LAoKCWVhc2luZzogewoJCWxpbmVhcjogZnVuY3Rpb24oIHAsIG4sIGZpcnN0TnVtLCBkaWZmICkgewoJCQlyZXR1cm4gZmlyc3ROdW0gKyBkaWZmICogcDsKCQl9LAoJCXN3aW5nOiBmdW5jdGlvbiggcCwgbiwgZmlyc3ROdW0sIGRpZmYgKSB7CgkJCXJldHVybiAoKC1NYXRoLmNvcyhwKk1hdGguUEkpLzIpICsgMC41KSAqIGRpZmYgKyBmaXJzdE51bTsKCQl9Cgl9LAoKCXRpbWVyczogW10sCgoJZng6IGZ1bmN0aW9uKCBlbGVtLCBvcHRpb25zLCBwcm9wICkgewoJCXRoaXMub3B0aW9ucyA9IG9wdGlvbnM7CgkJdGhpcy5lbGVtID0gZWxlbTsKCQl0aGlzLnByb3AgPSBwcm9wOwoKCQlpZiAoICFvcHRpb25zLm9yaWcgKSB7CgkJCW9wdGlvbnMub3JpZyA9IHt9OwoJCX0KCX0KCn0pOwoKalF1ZXJ5LmZ4LnByb3RvdHlwZSA9IHsKCS8vIFNpbXBsZSBmdW5jdGlvbiBmb3Igc2V0dGluZyBhIHN0eWxlIHZhbHVlCgl1cGRhdGU6IGZ1bmN0aW9uKCkgewoJCWlmICggdGhpcy5vcHRpb25zLnN0ZXAgKSB7CgkJCXRoaXMub3B0aW9ucy5zdGVwLmNhbGwoIHRoaXMuZWxlbSwgdGhpcy5ub3csIHRoaXMgKTsKCQl9CgoJCShqUXVlcnkuZnguc3RlcFt0aGlzLnByb3BdIHx8IGpRdWVyeS5meC5zdGVwLl9kZWZhdWx0KSggdGhpcyApOwoKCQkvLyBTZXQgZGlzcGxheSBwcm9wZXJ0eSB0byBibG9jayBmb3IgaGVpZ2h0L3dpZHRoIGFuaW1hdGlvbnMKCQlpZiAoICggdGhpcy5wcm9wID09PSAiaGVpZ2h0IiB8fCB0aGlzLnByb3AgPT09ICJ3aWR0aCIgKSAmJiB0aGlzLmVsZW0uc3R5bGUgKSB7CgkJCXRoaXMuZWxlbS5zdHlsZS5kaXNwbGF5ID0gImJsb2NrIjsKCQl9Cgl9LAoKCS8vIEdldCB0aGUgY3VycmVudCBzaXplCgljdXI6IGZ1bmN0aW9uKCBmb3JjZSApIHsKCQlpZiAoIHRoaXMuZWxlbVt0aGlzLnByb3BdICE9IG51bGwgJiYgKCF0aGlzLmVsZW0uc3R5bGUgfHwgdGhpcy5lbGVtLnN0eWxlW3RoaXMucHJvcF0gPT0gbnVsbCkgKSB7CgkJCXJldHVybiB0aGlzLmVsZW1bIHRoaXMucHJvcCBdOwoJCX0KCgkJdmFyIHIgPSBwYXJzZUZsb2F0KGpRdWVyeS5jc3ModGhpcy5lbGVtLCB0aGlzLnByb3AsIGZvcmNlKSk7CgkJcmV0dXJuIHIgJiYgciA+IC0xMDAwMCA/IHIgOiBwYXJzZUZsb2F0KGpRdWVyeS5jdXJDU1ModGhpcy5lbGVtLCB0aGlzLnByb3ApKSB8fCAwOwoJfSwKCgkvLyBTdGFydCBhbiBhbmltYXRpb24gZnJvbSBvbmUgbnVtYmVyIHRvIGFub3RoZXIKCWN1c3RvbTogZnVuY3Rpb24oIGZyb20sIHRvLCB1bml0ICkgewoJCXRoaXMuc3RhcnRUaW1lID0gbm93KCk7CgkJdGhpcy5zdGFydCA9IGZyb207CgkJdGhpcy5lbmQgPSB0bzsKCQl0aGlzLnVuaXQgPSB1bml0IHx8IHRoaXMudW5pdCB8fCAicHgiOwoJCXRoaXMubm93ID0gdGhpcy5zdGFydDsKCQl0aGlzLnBvcyA9IHRoaXMuc3RhdGUgPSAwOwoKCQl2YXIgc2VsZiA9IHRoaXM7CgkJZnVuY3Rpb24gdCggZ290b0VuZCApIHsKCQkJcmV0dXJuIHNlbGYuc3RlcChnb3RvRW5kKTsKCQl9CgoJCXQuZWxlbSA9IHRoaXMuZWxlbTsKCgkJaWYgKCB0KCkgJiYgalF1ZXJ5LnRpbWVycy5wdXNoKHQpICYmICF0aW1lcklkICkgewoJCQl0aW1lcklkID0gc2V0SW50ZXJ2YWwoalF1ZXJ5LmZ4LnRpY2ssIDEzKTsKCQl9Cgl9LAoKCS8vIFNpbXBsZSAnc2hvdycgZnVuY3Rpb24KCXNob3c6IGZ1bmN0aW9uKCkgewoJCS8vIFJlbWVtYmVyIHdoZXJlIHdlIHN0YXJ0ZWQsIHNvIHRoYXQgd2UgY2FuIGdvIGJhY2sgdG8gaXQgbGF0ZXIKCQl0aGlzLm9wdGlvbnMub3JpZ1t0aGlzLnByb3BdID0galF1ZXJ5LnN0eWxlKCB0aGlzLmVsZW0sIHRoaXMucHJvcCApOwoJCXRoaXMub3B0aW9ucy5zaG93ID0gdHJ1ZTsKCgkJLy8gQmVnaW4gdGhlIGFuaW1hdGlvbgoJCS8vIE1ha2Ugc3VyZSB0aGF0IHdlIHN0YXJ0IGF0IGEgc21hbGwgd2lkdGgvaGVpZ2h0IHRvIGF2b2lkIGFueQoJCS8vIGZsYXNoIG9mIGNvbnRlbnQKCQl0aGlzLmN1c3RvbSh0aGlzLnByb3AgPT09ICJ3aWR0aCIgfHwgdGhpcy5wcm9wID09PSAiaGVpZ2h0IiA/IDEgOiAwLCB0aGlzLmN1cigpKTsKCgkJLy8gU3RhcnQgYnkgc2hvd2luZyB0aGUgZWxlbWVudAoJCWpRdWVyeSggdGhpcy5lbGVtICkuc2hvdygpOwoJfSwKCgkvLyBTaW1wbGUgJ2hpZGUnIGZ1bmN0aW9uCgloaWRlOiBmdW5jdGlvbigpIHsKCQkvLyBSZW1lbWJlciB3aGVyZSB3ZSBzdGFydGVkLCBzbyB0aGF0IHdlIGNhbiBnbyBiYWNrIHRvIGl0IGxhdGVyCgkJdGhpcy5vcHRpb25zLm9yaWdbdGhpcy5wcm9wXSA9IGpRdWVyeS5zdHlsZSggdGhpcy5lbGVtLCB0aGlzLnByb3AgKTsKCQl0aGlzLm9wdGlvbnMuaGlkZSA9IHRydWU7CgoJCS8vIEJlZ2luIHRoZSBhbmltYXRpb24KCQl0aGlzLmN1c3RvbSh0aGlzLmN1cigpLCAwKTsKCX0sCgoJLy8gRWFjaCBzdGVwIG9mIGFuIGFuaW1hdGlvbgoJc3RlcDogZnVuY3Rpb24oIGdvdG9FbmQgKSB7CgkJdmFyIHQgPSBub3coKSwgZG9uZSA9IHRydWU7CgoJCWlmICggZ290b0VuZCB8fCB0ID49IHRoaXMub3B0aW9ucy5kdXJhdGlvbiArIHRoaXMuc3RhcnRUaW1lICkgewoJCQl0aGlzLm5vdyA9IHRoaXMuZW5kOwoJCQl0aGlzLnBvcyA9IHRoaXMuc3RhdGUgPSAxOwoJCQl0aGlzLnVwZGF0ZSgpOwoKCQkJdGhpcy5vcHRpb25zLmN1ckFuaW1bIHRoaXMucHJvcCBdID0gdHJ1ZTsKCgkJCWZvciAoIHZhciBpIGluIHRoaXMub3B0aW9ucy5jdXJBbmltICkgewoJCQkJaWYgKCB0aGlzLm9wdGlvbnMuY3VyQW5pbVtpXSAhPT0gdHJ1ZSApIHsKCQkJCQlkb25lID0gZmFsc2U7CgkJCQl9CgkJCX0KCgkJCWlmICggZG9uZSApIHsKCQkJCWlmICggdGhpcy5vcHRpb25zLmRpc3BsYXkgIT0gbnVsbCApIHsKCQkJCQkvLyBSZXNldCB0aGUgb3ZlcmZsb3cKCQkJCQl0aGlzLmVsZW0uc3R5bGUub3ZlcmZsb3cgPSB0aGlzLm9wdGlvbnMub3ZlcmZsb3c7CgoJCQkJCS8vIFJlc2V0IHRoZSBkaXNwbGF5CgkJCQkJdmFyIG9sZCA9IGpRdWVyeS5kYXRhKHRoaXMuZWxlbSwgIm9sZGRpc3BsYXkiKTsKCQkJCQl0aGlzLmVsZW0uc3R5bGUuZGlzcGxheSA9IG9sZCA/IG9sZCA6IHRoaXMub3B0aW9ucy5kaXNwbGF5OwoKCQkJCQlpZiAoIGpRdWVyeS5jc3ModGhpcy5lbGVtLCAiZGlzcGxheSIpID09PSAibm9uZSIgKSB7CgkJCQkJCXRoaXMuZWxlbS5zdHlsZS5kaXNwbGF5ID0gImJsb2NrIjsKCQkJCQl9CgkJCQl9CgoJCQkJLy8gSGlkZSB0aGUgZWxlbWVudCBpZiB0aGUgImhpZGUiIG9wZXJhdGlvbiB3YXMgZG9uZQoJCQkJaWYgKCB0aGlzLm9wdGlvbnMuaGlkZSApIHsKCQkJCQlqUXVlcnkodGhpcy5lbGVtKS5oaWRlKCk7CgkJCQl9CgoJCQkJLy8gUmVzZXQgdGhlIHByb3BlcnRpZXMsIGlmIHRoZSBpdGVtIGhhcyBiZWVuIGhpZGRlbiBvciBzaG93bgoJCQkJaWYgKCB0aGlzLm9wdGlvbnMuaGlkZSB8fCB0aGlzLm9wdGlvbnMuc2hvdyApIHsKCQkJCQlmb3IgKCB2YXIgcCBpbiB0aGlzLm9wdGlvbnMuY3VyQW5pbSApIHsKCQkJCQkJalF1ZXJ5LnN0eWxlKHRoaXMuZWxlbSwgcCwgdGhpcy5vcHRpb25zLm9yaWdbcF0pOwoJCQkJCX0KCQkJCX0KCgkJCQkvLyBFeGVjdXRlIHRoZSBjb21wbGV0ZSBmdW5jdGlvbgoJCQkJdGhpcy5vcHRpb25zLmNvbXBsZXRlLmNhbGwoIHRoaXMuZWxlbSApOwoJCQl9CgoJCQlyZXR1cm4gZmFsc2U7CgoJCX0gZWxzZSB7CgkJCXZhciBuID0gdCAtIHRoaXMuc3RhcnRUaW1lOwoJCQl0aGlzLnN0YXRlID0gbiAvIHRoaXMub3B0aW9ucy5kdXJhdGlvbjsKCgkJCS8vIFBlcmZvcm0gdGhlIGVhc2luZyBmdW5jdGlvbiwgZGVmYXVsdHMgdG8gc3dpbmcKCQkJdmFyIHNwZWNpYWxFYXNpbmcgPSB0aGlzLm9wdGlvbnMuc3BlY2lhbEVhc2luZyAmJiB0aGlzLm9wdGlvbnMuc3BlY2lhbEVhc2luZ1t0aGlzLnByb3BdOwoJCQl2YXIgZGVmYXVsdEVhc2luZyA9IHRoaXMub3B0aW9ucy5lYXNpbmcgfHwgKGpRdWVyeS5lYXNpbmcuc3dpbmcgPyAic3dpbmciIDogImxpbmVhciIpOwoJCQl0aGlzLnBvcyA9IGpRdWVyeS5lYXNpbmdbc3BlY2lhbEVhc2luZyB8fCBkZWZhdWx0RWFzaW5nXSh0aGlzLnN0YXRlLCBuLCAwLCAxLCB0aGlzLm9wdGlvbnMuZHVyYXRpb24pOwoJCQl0aGlzLm5vdyA9IHRoaXMuc3RhcnQgKyAoKHRoaXMuZW5kIC0gdGhpcy5zdGFydCkgKiB0aGlzLnBvcyk7CgoJCQkvLyBQZXJmb3JtIHRoZSBuZXh0IHN0ZXAgb2YgdGhlIGFuaW1hdGlvbgoJCQl0aGlzLnVwZGF0ZSgpOwoJCX0KCgkJcmV0dXJuIHRydWU7Cgl9Cn07CgpqUXVlcnkuZXh0ZW5kKCBqUXVlcnkuZngsIHsKCXRpY2s6IGZ1bmN0aW9uKCkgewoJCXZhciB0aW1lcnMgPSBqUXVlcnkudGltZXJzOwoKCQlmb3IgKCB2YXIgaSA9IDA7IGkgPCB0aW1lcnMubGVuZ3RoOyBpKysgKSB7CgkJCWlmICggIXRpbWVyc1tpXSgpICkgewoJCQkJdGltZXJzLnNwbGljZShpLS0sIDEpOwoJCQl9CgkJfQoKCQlpZiAoICF0aW1lcnMubGVuZ3RoICkgewoJCQlqUXVlcnkuZnguc3RvcCgpOwoJCX0KCX0sCgkJCglzdG9wOiBmdW5jdGlvbigpIHsKCQljbGVhckludGVydmFsKCB0aW1lcklkICk7CgkJdGltZXJJZCA9IG51bGw7Cgl9LAoJCglzcGVlZHM6IHsKCQlzbG93OiA2MDAsCiAJCWZhc3Q6IDIwMCwKIAkJLy8gRGVmYXVsdCBzcGVlZAogCQlfZGVmYXVsdDogNDAwCgl9LAoKCXN0ZXA6IHsKCQlvcGFjaXR5OiBmdW5jdGlvbiggZnggKSB7CgkJCWpRdWVyeS5zdHlsZShmeC5lbGVtLCAib3BhY2l0eSIsIGZ4Lm5vdyk7CgkJfSwKCgkJX2RlZmF1bHQ6IGZ1bmN0aW9uKCBmeCApIHsKCQkJaWYgKCBmeC5lbGVtLnN0eWxlICYmIGZ4LmVsZW0uc3R5bGVbIGZ4LnByb3AgXSAhPSBudWxsICkgewoJCQkJZnguZWxlbS5zdHlsZVsgZngucHJvcCBdID0gKGZ4LnByb3AgPT09ICJ3aWR0aCIgfHwgZngucHJvcCA9PT0gImhlaWdodCIgPyBNYXRoLm1heCgwLCBmeC5ub3cpIDogZngubm93KSArIGZ4LnVuaXQ7CgkJCX0gZWxzZSB7CgkJCQlmeC5lbGVtWyBmeC5wcm9wIF0gPSBmeC5ub3c7CgkJCX0KCQl9Cgl9Cn0pOwoKaWYgKCBqUXVlcnkuZXhwciAmJiBqUXVlcnkuZXhwci5maWx0ZXJzICkgewoJalF1ZXJ5LmV4cHIuZmlsdGVycy5hbmltYXRlZCA9IGZ1bmN0aW9uKCBlbGVtICkgewoJCXJldHVybiBqUXVlcnkuZ3JlcChqUXVlcnkudGltZXJzLCBmdW5jdGlvbiggZm4gKSB7CgkJCXJldHVybiBlbGVtID09PSBmbi5lbGVtOwoJCX0pLmxlbmd0aDsKCX07Cn0KCmZ1bmN0aW9uIGdlbkZ4KCB0eXBlLCBudW0gKSB7Cgl2YXIgb2JqID0ge307CgoJalF1ZXJ5LmVhY2goIGZ4QXR0cnMuY29uY2F0LmFwcGx5KFtdLCBmeEF0dHJzLnNsaWNlKDAsbnVtKSksIGZ1bmN0aW9uKCkgewoJCW9ialsgdGhpcyBdID0gdHlwZTsKCX0pOwoKCXJldHVybiBvYmo7Cn0KaWYgKCAiZ2V0Qm91bmRpbmdDbGllbnRSZWN0IiBpbiBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQgKSB7CglqUXVlcnkuZm4ub2Zmc2V0ID0gZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJdmFyIGVsZW0gPSB0aGlzWzBdOwoKCQlpZiAoIG9wdGlvbnMgKSB7IAoJCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCBpICkgewoJCQkJalF1ZXJ5Lm9mZnNldC5zZXRPZmZzZXQoIHRoaXMsIG9wdGlvbnMsIGkgKTsKCQkJfSk7CgkJfQoKCQlpZiAoICFlbGVtIHx8ICFlbGVtLm93bmVyRG9jdW1lbnQgKSB7CgkJCXJldHVybiBudWxsOwoJCX0KCgkJaWYgKCBlbGVtID09PSBlbGVtLm93bmVyRG9jdW1lbnQuYm9keSApIHsKCQkJcmV0dXJuIGpRdWVyeS5vZmZzZXQuYm9keU9mZnNldCggZWxlbSApOwoJCX0KCgkJdmFyIGJveCA9IGVsZW0uZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCksIGRvYyA9IGVsZW0ub3duZXJEb2N1bWVudCwgYm9keSA9IGRvYy5ib2R5LCBkb2NFbGVtID0gZG9jLmRvY3VtZW50RWxlbWVudCwKCQkJY2xpZW50VG9wID0gZG9jRWxlbS5jbGllbnRUb3AgfHwgYm9keS5jbGllbnRUb3AgfHwgMCwgY2xpZW50TGVmdCA9IGRvY0VsZW0uY2xpZW50TGVmdCB8fCBib2R5LmNsaWVudExlZnQgfHwgMCwKCQkJdG9wICA9IGJveC50b3AgICsgKHNlbGYucGFnZVlPZmZzZXQgfHwgalF1ZXJ5LnN1cHBvcnQuYm94TW9kZWwgJiYgZG9jRWxlbS5zY3JvbGxUb3AgIHx8IGJvZHkuc2Nyb2xsVG9wICkgLSBjbGllbnRUb3AsCgkJCWxlZnQgPSBib3gubGVmdCArIChzZWxmLnBhZ2VYT2Zmc2V0IHx8IGpRdWVyeS5zdXBwb3J0LmJveE1vZGVsICYmIGRvY0VsZW0uc2Nyb2xsTGVmdCB8fCBib2R5LnNjcm9sbExlZnQpIC0gY2xpZW50TGVmdDsKCgkJcmV0dXJuIHsgdG9wOiB0b3AsIGxlZnQ6IGxlZnQgfTsKCX07Cgp9IGVsc2UgewoJalF1ZXJ5LmZuLm9mZnNldCA9IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCXZhciBlbGVtID0gdGhpc1swXTsKCgkJaWYgKCBvcHRpb25zICkgeyAKCQkJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiggaSApIHsKCQkJCWpRdWVyeS5vZmZzZXQuc2V0T2Zmc2V0KCB0aGlzLCBvcHRpb25zLCBpICk7CgkJCX0pOwoJCX0KCgkJaWYgKCAhZWxlbSB8fCAhZWxlbS5vd25lckRvY3VtZW50ICkgewoJCQlyZXR1cm4gbnVsbDsKCQl9CgoJCWlmICggZWxlbSA9PT0gZWxlbS5vd25lckRvY3VtZW50LmJvZHkgKSB7CgkJCXJldHVybiBqUXVlcnkub2Zmc2V0LmJvZHlPZmZzZXQoIGVsZW0gKTsKCQl9CgoJCWpRdWVyeS5vZmZzZXQuaW5pdGlhbGl6ZSgpOwoKCQl2YXIgb2Zmc2V0UGFyZW50ID0gZWxlbS5vZmZzZXRQYXJlbnQsIHByZXZPZmZzZXRQYXJlbnQgPSBlbGVtLAoJCQlkb2MgPSBlbGVtLm93bmVyRG9jdW1lbnQsIGNvbXB1dGVkU3R5bGUsIGRvY0VsZW0gPSBkb2MuZG9jdW1lbnRFbGVtZW50LAoJCQlib2R5ID0gZG9jLmJvZHksIGRlZmF1bHRWaWV3ID0gZG9jLmRlZmF1bHRWaWV3LAoJCQlwcmV2Q29tcHV0ZWRTdHlsZSA9IGRlZmF1bHRWaWV3ID8gZGVmYXVsdFZpZXcuZ2V0Q29tcHV0ZWRTdHlsZSggZWxlbSwgbnVsbCApIDogZWxlbS5jdXJyZW50U3R5bGUsCgkJCXRvcCA9IGVsZW0ub2Zmc2V0VG9wLCBsZWZ0ID0gZWxlbS5vZmZzZXRMZWZ0OwoKCQl3aGlsZSAoIChlbGVtID0gZWxlbS5wYXJlbnROb2RlKSAmJiBlbGVtICE9PSBib2R5ICYmIGVsZW0gIT09IGRvY0VsZW0gKSB7CgkJCWlmICggalF1ZXJ5Lm9mZnNldC5zdXBwb3J0c0ZpeGVkUG9zaXRpb24gJiYgcHJldkNvbXB1dGVkU3R5bGUucG9zaXRpb24gPT09ICJmaXhlZCIgKSB7CgkJCQlicmVhazsKCQkJfQoKCQkJY29tcHV0ZWRTdHlsZSA9IGRlZmF1bHRWaWV3ID8gZGVmYXVsdFZpZXcuZ2V0Q29tcHV0ZWRTdHlsZShlbGVtLCBudWxsKSA6IGVsZW0uY3VycmVudFN0eWxlOwoJCQl0b3AgIC09IGVsZW0uc2Nyb2xsVG9wOwoJCQlsZWZ0IC09IGVsZW0uc2Nyb2xsTGVmdDsKCgkJCWlmICggZWxlbSA9PT0gb2Zmc2V0UGFyZW50ICkgewoJCQkJdG9wICArPSBlbGVtLm9mZnNldFRvcDsKCQkJCWxlZnQgKz0gZWxlbS5vZmZzZXRMZWZ0OwoKCQkJCWlmICggalF1ZXJ5Lm9mZnNldC5kb2VzTm90QWRkQm9yZGVyICYmICEoalF1ZXJ5Lm9mZnNldC5kb2VzQWRkQm9yZGVyRm9yVGFibGVBbmRDZWxscyAmJiAvXnQoYWJsZXxkfGgpJC9pLnRlc3QoZWxlbS5ub2RlTmFtZSkpICkgewoJCQkJCXRvcCAgKz0gcGFyc2VGbG9hdCggY29tcHV0ZWRTdHlsZS5ib3JkZXJUb3BXaWR0aCAgKSB8fCAwOwoJCQkJCWxlZnQgKz0gcGFyc2VGbG9hdCggY29tcHV0ZWRTdHlsZS5ib3JkZXJMZWZ0V2lkdGggKSB8fCAwOwoJCQkJfQoKCQkJCXByZXZPZmZzZXRQYXJlbnQgPSBvZmZzZXRQYXJlbnQsIG9mZnNldFBhcmVudCA9IGVsZW0ub2Zmc2V0UGFyZW50OwoJCQl9CgoJCQlpZiAoIGpRdWVyeS5vZmZzZXQuc3VidHJhY3RzQm9yZGVyRm9yT3ZlcmZsb3dOb3RWaXNpYmxlICYmIGNvbXB1dGVkU3R5bGUub3ZlcmZsb3cgIT09ICJ2aXNpYmxlIiApIHsKCQkJCXRvcCAgKz0gcGFyc2VGbG9hdCggY29tcHV0ZWRTdHlsZS5ib3JkZXJUb3BXaWR0aCAgKSB8fCAwOwoJCQkJbGVmdCArPSBwYXJzZUZsb2F0KCBjb21wdXRlZFN0eWxlLmJvcmRlckxlZnRXaWR0aCApIHx8IDA7CgkJCX0KCgkJCXByZXZDb21wdXRlZFN0eWxlID0gY29tcHV0ZWRTdHlsZTsKCQl9CgoJCWlmICggcHJldkNvbXB1dGVkU3R5bGUucG9zaXRpb24gPT09ICJyZWxhdGl2ZSIgfHwgcHJldkNvbXB1dGVkU3R5bGUucG9zaXRpb24gPT09ICJzdGF0aWMiICkgewoJCQl0b3AgICs9IGJvZHkub2Zmc2V0VG9wOwoJCQlsZWZ0ICs9IGJvZHkub2Zmc2V0TGVmdDsKCQl9CgoJCWlmICggalF1ZXJ5Lm9mZnNldC5zdXBwb3J0c0ZpeGVkUG9zaXRpb24gJiYgcHJldkNvbXB1dGVkU3R5bGUucG9zaXRpb24gPT09ICJmaXhlZCIgKSB7CgkJCXRvcCAgKz0gTWF0aC5tYXgoIGRvY0VsZW0uc2Nyb2xsVG9wLCBib2R5LnNjcm9sbFRvcCApOwoJCQlsZWZ0ICs9IE1hdGgubWF4KCBkb2NFbGVtLnNjcm9sbExlZnQsIGJvZHkuc2Nyb2xsTGVmdCApOwoJCX0KCgkJcmV0dXJuIHsgdG9wOiB0b3AsIGxlZnQ6IGxlZnQgfTsKCX07Cn0KCmpRdWVyeS5vZmZzZXQgPSB7Cglpbml0aWFsaXplOiBmdW5jdGlvbigpIHsKCQl2YXIgYm9keSA9IGRvY3VtZW50LmJvZHksIGNvbnRhaW5lciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpLCBpbm5lckRpdiwgY2hlY2tEaXYsIHRhYmxlLCB0ZCwgYm9keU1hcmdpblRvcCA9IHBhcnNlRmxvYXQoIGpRdWVyeS5jdXJDU1MoYm9keSwgIm1hcmdpblRvcCIsIHRydWUpICkgfHwgMCwKCQkJaHRtbCA9ICI8ZGl2IHN0eWxlPSdwb3NpdGlvbjphYnNvbHV0ZTt0b3A6MDtsZWZ0OjA7bWFyZ2luOjA7Ym9yZGVyOjVweCBzb2xpZCAjMDAwO3BhZGRpbmc6MDt3aWR0aDoxcHg7aGVpZ2h0OjFweDsnPjxkaXY+PC9kaXY+PC9kaXY+PHRhYmxlIHN0eWxlPSdwb3NpdGlvbjphYnNvbHV0ZTt0b3A6MDtsZWZ0OjA7bWFyZ2luOjA7Ym9yZGVyOjVweCBzb2xpZCAjMDAwO3BhZGRpbmc6MDt3aWR0aDoxcHg7aGVpZ2h0OjFweDsnIGNlbGxwYWRkaW5nPScwJyBjZWxsc3BhY2luZz0nMCc+PHRyPjx0ZD48L3RkPjwvdHI+PC90YWJsZT4iOwoKCQlqUXVlcnkuZXh0ZW5kKCBjb250YWluZXIuc3R5bGUsIHsgcG9zaXRpb246ICJhYnNvbHV0ZSIsIHRvcDogMCwgbGVmdDogMCwgbWFyZ2luOiAwLCBib3JkZXI6IDAsIHdpZHRoOiAiMXB4IiwgaGVpZ2h0OiAiMXB4IiwgdmlzaWJpbGl0eTogImhpZGRlbiIgfSApOwoKCQljb250YWluZXIuaW5uZXJIVE1MID0gaHRtbDsKCQlib2R5Lmluc2VydEJlZm9yZSggY29udGFpbmVyLCBib2R5LmZpcnN0Q2hpbGQgKTsKCQlpbm5lckRpdiA9IGNvbnRhaW5lci5maXJzdENoaWxkOwoJCWNoZWNrRGl2ID0gaW5uZXJEaXYuZmlyc3RDaGlsZDsKCQl0ZCA9IGlubmVyRGl2Lm5leHRTaWJsaW5nLmZpcnN0Q2hpbGQuZmlyc3RDaGlsZDsKCgkJdGhpcy5kb2VzTm90QWRkQm9yZGVyID0gKGNoZWNrRGl2Lm9mZnNldFRvcCAhPT0gNSk7CgkJdGhpcy5kb2VzQWRkQm9yZGVyRm9yVGFibGVBbmRDZWxscyA9ICh0ZC5vZmZzZXRUb3AgPT09IDUpOwoKCQljaGVja0Rpdi5zdHlsZS5wb3NpdGlvbiA9ICJmaXhlZCIsIGNoZWNrRGl2LnN0eWxlLnRvcCA9ICIyMHB4IjsKCQkvLyBzYWZhcmkgc3VidHJhY3RzIHBhcmVudCBib3JkZXIgd2lkdGggaGVyZSB3aGljaCBpcyA1cHgKCQl0aGlzLnN1cHBvcnRzRml4ZWRQb3NpdGlvbiA9IChjaGVja0Rpdi5vZmZzZXRUb3AgPT09IDIwIHx8IGNoZWNrRGl2Lm9mZnNldFRvcCA9PT0gMTUpOwoJCWNoZWNrRGl2LnN0eWxlLnBvc2l0aW9uID0gY2hlY2tEaXYuc3R5bGUudG9wID0gIiI7CgoJCWlubmVyRGl2LnN0eWxlLm92ZXJmbG93ID0gImhpZGRlbiIsIGlubmVyRGl2LnN0eWxlLnBvc2l0aW9uID0gInJlbGF0aXZlIjsKCQl0aGlzLnN1YnRyYWN0c0JvcmRlckZvck92ZXJmbG93Tm90VmlzaWJsZSA9IChjaGVja0Rpdi5vZmZzZXRUb3AgPT09IC01KTsKCgkJdGhpcy5kb2VzTm90SW5jbHVkZU1hcmdpbkluQm9keU9mZnNldCA9IChib2R5Lm9mZnNldFRvcCAhPT0gYm9keU1hcmdpblRvcCk7CgoJCWJvZHkucmVtb3ZlQ2hpbGQoIGNvbnRhaW5lciApOwoJCWJvZHkgPSBjb250YWluZXIgPSBpbm5lckRpdiA9IGNoZWNrRGl2ID0gdGFibGUgPSB0ZCA9IG51bGw7CgkJalF1ZXJ5Lm9mZnNldC5pbml0aWFsaXplID0galF1ZXJ5Lm5vb3A7Cgl9LAoKCWJvZHlPZmZzZXQ6IGZ1bmN0aW9uKCBib2R5ICkgewoJCXZhciB0b3AgPSBib2R5Lm9mZnNldFRvcCwgbGVmdCA9IGJvZHkub2Zmc2V0TGVmdDsKCgkJalF1ZXJ5Lm9mZnNldC5pbml0aWFsaXplKCk7CgoJCWlmICggalF1ZXJ5Lm9mZnNldC5kb2VzTm90SW5jbHVkZU1hcmdpbkluQm9keU9mZnNldCApIHsKCQkJdG9wICArPSBwYXJzZUZsb2F0KCBqUXVlcnkuY3VyQ1NTKGJvZHksICJtYXJnaW5Ub3AiLCAgdHJ1ZSkgKSB8fCAwOwoJCQlsZWZ0ICs9IHBhcnNlRmxvYXQoIGpRdWVyeS5jdXJDU1MoYm9keSwgIm1hcmdpbkxlZnQiLCB0cnVlKSApIHx8IDA7CgkJfQoKCQlyZXR1cm4geyB0b3A6IHRvcCwgbGVmdDogbGVmdCB9OwoJfSwKCQoJc2V0T2Zmc2V0OiBmdW5jdGlvbiggZWxlbSwgb3B0aW9ucywgaSApIHsKCQkvLyBzZXQgcG9zaXRpb24gZmlyc3QsIGluLWNhc2UgdG9wL2xlZnQgYXJlIHNldCBldmVuIG9uIHN0YXRpYyBlbGVtCgkJaWYgKCAvc3RhdGljLy50ZXN0KCBqUXVlcnkuY3VyQ1NTKCBlbGVtLCAicG9zaXRpb24iICkgKSApIHsKCQkJZWxlbS5zdHlsZS5wb3NpdGlvbiA9ICJyZWxhdGl2ZSI7CgkJfQoJCXZhciBjdXJFbGVtICAgPSBqUXVlcnkoIGVsZW0gKSwKCQkJY3VyT2Zmc2V0ID0gY3VyRWxlbS5vZmZzZXQoKSwKCQkJY3VyVG9wICAgID0gcGFyc2VJbnQoIGpRdWVyeS5jdXJDU1MoIGVsZW0sICJ0b3AiLCAgdHJ1ZSApLCAxMCApIHx8IDAsCgkJCWN1ckxlZnQgICA9IHBhcnNlSW50KCBqUXVlcnkuY3VyQ1NTKCBlbGVtLCAibGVmdCIsIHRydWUgKSwgMTAgKSB8fCAwOwoKCQlpZiAoIGpRdWVyeS5pc0Z1bmN0aW9uKCBvcHRpb25zICkgKSB7CgkJCW9wdGlvbnMgPSBvcHRpb25zLmNhbGwoIGVsZW0sIGksIGN1ck9mZnNldCApOwoJCX0KCgkJdmFyIHByb3BzID0gewoJCQl0b3A6ICAob3B0aW9ucy50b3AgIC0gY3VyT2Zmc2V0LnRvcCkgICsgY3VyVG9wLAoJCQlsZWZ0OiAob3B0aW9ucy5sZWZ0IC0gY3VyT2Zmc2V0LmxlZnQpICsgY3VyTGVmdAoJCX07CgkJCgkJaWYgKCAidXNpbmciIGluIG9wdGlvbnMgKSB7CgkJCW9wdGlvbnMudXNpbmcuY2FsbCggZWxlbSwgcHJvcHMgKTsKCQl9IGVsc2UgewoJCQljdXJFbGVtLmNzcyggcHJvcHMgKTsKCQl9Cgl9Cn07CgoKalF1ZXJ5LmZuLmV4dGVuZCh7Cglwb3NpdGlvbjogZnVuY3Rpb24oKSB7CgkJaWYgKCAhdGhpc1swXSApIHsKCQkJcmV0dXJuIG51bGw7CgkJfQoKCQl2YXIgZWxlbSA9IHRoaXNbMF0sCgoJCS8vIEdldCAqcmVhbCogb2Zmc2V0UGFyZW50CgkJb2Zmc2V0UGFyZW50ID0gdGhpcy5vZmZzZXRQYXJlbnQoKSwKCgkJLy8gR2V0IGNvcnJlY3Qgb2Zmc2V0cwoJCW9mZnNldCAgICAgICA9IHRoaXMub2Zmc2V0KCksCgkJcGFyZW50T2Zmc2V0ID0gL15ib2R5fGh0bWwkL2kudGVzdChvZmZzZXRQYXJlbnRbMF0ubm9kZU5hbWUpID8geyB0b3A6IDAsIGxlZnQ6IDAgfSA6IG9mZnNldFBhcmVudC5vZmZzZXQoKTsKCgkJLy8gU3VidHJhY3QgZWxlbWVudCBtYXJnaW5zCgkJLy8gbm90ZTogd2hlbiBhbiBlbGVtZW50IGhhcyBtYXJnaW46IGF1dG8gdGhlIG9mZnNldExlZnQgYW5kIG1hcmdpbkxlZnQKCQkvLyBhcmUgdGhlIHNhbWUgaW4gU2FmYXJpIGNhdXNpbmcgb2Zmc2V0LmxlZnQgdG8gaW5jb3JyZWN0bHkgYmUgMAoJCW9mZnNldC50b3AgIC09IHBhcnNlRmxvYXQoIGpRdWVyeS5jdXJDU1MoZWxlbSwgIm1hcmdpblRvcCIsICB0cnVlKSApIHx8IDA7CgkJb2Zmc2V0LmxlZnQgLT0gcGFyc2VGbG9hdCggalF1ZXJ5LmN1ckNTUyhlbGVtLCAibWFyZ2luTGVmdCIsIHRydWUpICkgfHwgMDsKCgkJLy8gQWRkIG9mZnNldFBhcmVudCBib3JkZXJzCgkJcGFyZW50T2Zmc2V0LnRvcCAgKz0gcGFyc2VGbG9hdCggalF1ZXJ5LmN1ckNTUyhvZmZzZXRQYXJlbnRbMF0sICJib3JkZXJUb3BXaWR0aCIsICB0cnVlKSApIHx8IDA7CgkJcGFyZW50T2Zmc2V0LmxlZnQgKz0gcGFyc2VGbG9hdCggalF1ZXJ5LmN1ckNTUyhvZmZzZXRQYXJlbnRbMF0sICJib3JkZXJMZWZ0V2lkdGgiLCB0cnVlKSApIHx8IDA7CgoJCS8vIFN1YnRyYWN0IHRoZSB0d28gb2Zmc2V0cwoJCXJldHVybiB7CgkJCXRvcDogIG9mZnNldC50b3AgIC0gcGFyZW50T2Zmc2V0LnRvcCwKCQkJbGVmdDogb2Zmc2V0LmxlZnQgLSBwYXJlbnRPZmZzZXQubGVmdAoJCX07Cgl9LAoKCW9mZnNldFBhcmVudDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMubWFwKGZ1bmN0aW9uKCkgewoJCQl2YXIgb2Zmc2V0UGFyZW50ID0gdGhpcy5vZmZzZXRQYXJlbnQgfHwgZG9jdW1lbnQuYm9keTsKCQkJd2hpbGUgKCBvZmZzZXRQYXJlbnQgJiYgKCEvXmJvZHl8aHRtbCQvaS50ZXN0KG9mZnNldFBhcmVudC5ub2RlTmFtZSkgJiYgalF1ZXJ5LmNzcyhvZmZzZXRQYXJlbnQsICJwb3NpdGlvbiIpID09PSAic3RhdGljIikgKSB7CgkJCQlvZmZzZXRQYXJlbnQgPSBvZmZzZXRQYXJlbnQub2Zmc2V0UGFyZW50OwoJCQl9CgkJCXJldHVybiBvZmZzZXRQYXJlbnQ7CgkJfSk7Cgl9Cn0pOwoKCi8vIENyZWF0ZSBzY3JvbGxMZWZ0IGFuZCBzY3JvbGxUb3AgbWV0aG9kcwpqUXVlcnkuZWFjaCggWyJMZWZ0IiwgIlRvcCJdLCBmdW5jdGlvbiggaSwgbmFtZSApIHsKCXZhciBtZXRob2QgPSAic2Nyb2xsIiArIG5hbWU7CgoJalF1ZXJ5LmZuWyBtZXRob2QgXSA9IGZ1bmN0aW9uKHZhbCkgewoJCXZhciBlbGVtID0gdGhpc1swXSwgd2luOwoJCQoJCWlmICggIWVsZW0gKSB7CgkJCXJldHVybiBudWxsOwoJCX0KCgkJaWYgKCB2YWwgIT09IHVuZGVmaW5lZCApIHsKCQkJLy8gU2V0IHRoZSBzY3JvbGwgb2Zmc2V0CgkJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgkJCQl3aW4gPSBnZXRXaW5kb3coIHRoaXMgKTsKCgkJCQlpZiAoIHdpbiApIHsKCQkJCQl3aW4uc2Nyb2xsVG8oCgkJCQkJCSFpID8gdmFsIDogalF1ZXJ5KHdpbikuc2Nyb2xsTGVmdCgpLAoJCQkJCQkgaSA/IHZhbCA6IGpRdWVyeSh3aW4pLnNjcm9sbFRvcCgpCgkJCQkJKTsKCgkJCQl9IGVsc2UgewoJCQkJCXRoaXNbIG1ldGhvZCBdID0gdmFsOwoJCQkJfQoJCQl9KTsKCQl9IGVsc2UgewoJCQl3aW4gPSBnZXRXaW5kb3coIGVsZW0gKTsKCgkJCS8vIFJldHVybiB0aGUgc2Nyb2xsIG9mZnNldAoJCQlyZXR1cm4gd2luID8gKCJwYWdlWE9mZnNldCIgaW4gd2luKSA/IHdpblsgaSA/ICJwYWdlWU9mZnNldCIgOiAicGFnZVhPZmZzZXQiIF0gOgoJCQkJalF1ZXJ5LnN1cHBvcnQuYm94TW9kZWwgJiYgd2luLmRvY3VtZW50LmRvY3VtZW50RWxlbWVudFsgbWV0aG9kIF0gfHwKCQkJCQl3aW4uZG9jdW1lbnQuYm9keVsgbWV0aG9kIF0gOgoJCQkJZWxlbVsgbWV0aG9kIF07CgkJfQoJfTsKfSk7CgpmdW5jdGlvbiBnZXRXaW5kb3coIGVsZW0gKSB7CglyZXR1cm4gKCJzY3JvbGxUbyIgaW4gZWxlbSAmJiBlbGVtLmRvY3VtZW50KSA/CgkJZWxlbSA6CgkJZWxlbS5ub2RlVHlwZSA9PT0gOSA/CgkJCWVsZW0uZGVmYXVsdFZpZXcgfHwgZWxlbS5wYXJlbnRXaW5kb3cgOgoJCQlmYWxzZTsKfQovLyBDcmVhdGUgaW5uZXJIZWlnaHQsIGlubmVyV2lkdGgsIG91dGVySGVpZ2h0IGFuZCBvdXRlcldpZHRoIG1ldGhvZHMKalF1ZXJ5LmVhY2goWyAiSGVpZ2h0IiwgIldpZHRoIiBdLCBmdW5jdGlvbiggaSwgbmFtZSApIHsKCgl2YXIgdHlwZSA9IG5hbWUudG9Mb3dlckNhc2UoKTsKCgkvLyBpbm5lckhlaWdodCBhbmQgaW5uZXJXaWR0aAoJalF1ZXJ5LmZuWyJpbm5lciIgKyBuYW1lXSA9IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzWzBdID8KCQkJalF1ZXJ5LmNzcyggdGhpc1swXSwgdHlwZSwgZmFsc2UsICJwYWRkaW5nIiApIDoKCQkJbnVsbDsKCX07CgoJLy8gb3V0ZXJIZWlnaHQgYW5kIG91dGVyV2lkdGgKCWpRdWVyeS5mblsib3V0ZXIiICsgbmFtZV0gPSBmdW5jdGlvbiggbWFyZ2luICkgewoJCXJldHVybiB0aGlzWzBdID8KCQkJalF1ZXJ5LmNzcyggdGhpc1swXSwgdHlwZSwgZmFsc2UsIG1hcmdpbiA/ICJtYXJnaW4iIDogImJvcmRlciIgKSA6CgkJCW51bGw7Cgl9OwoKCWpRdWVyeS5mblsgdHlwZSBdID0gZnVuY3Rpb24oIHNpemUgKSB7CgkJLy8gR2V0IHdpbmRvdyB3aWR0aCBvciBoZWlnaHQKCQl2YXIgZWxlbSA9IHRoaXNbMF07CgkJaWYgKCAhZWxlbSApIHsKCQkJcmV0dXJuIHNpemUgPT0gbnVsbCA/IG51bGwgOiB0aGlzOwoJCX0KCQkKCQlpZiAoIGpRdWVyeS5pc0Z1bmN0aW9uKCBzaXplICkgKSB7CgkJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oIGkgKSB7CgkJCQl2YXIgc2VsZiA9IGpRdWVyeSggdGhpcyApOwoJCQkJc2VsZlsgdHlwZSBdKCBzaXplLmNhbGwoIHRoaXMsIGksIHNlbGZbIHR5cGUgXSgpICkgKTsKCQkJfSk7CgkJfQoKCQlyZXR1cm4gKCJzY3JvbGxUbyIgaW4gZWxlbSAmJiBlbGVtLmRvY3VtZW50KSA/IC8vIGRvZXMgaXQgd2FsayBhbmQgcXVhY2sgbGlrZSBhIHdpbmRvdz8KCQkJLy8gRXZlcnlvbmUgZWxzZSB1c2UgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50IG9yIGRvY3VtZW50LmJvZHkgZGVwZW5kaW5nIG9uIFF1aXJrcyB2cyBTdGFuZGFyZHMgbW9kZQoJCQllbGVtLmRvY3VtZW50LmNvbXBhdE1vZGUgPT09ICJDU1MxQ29tcGF0IiAmJiBlbGVtLmRvY3VtZW50LmRvY3VtZW50RWxlbWVudFsgImNsaWVudCIgKyBuYW1lIF0gfHwKCQkJZWxlbS5kb2N1bWVudC5ib2R5WyAiY2xpZW50IiArIG5hbWUgXSA6CgoJCQkvLyBHZXQgZG9jdW1lbnQgd2lkdGggb3IgaGVpZ2h0CgkJCShlbGVtLm5vZGVUeXBlID09PSA5KSA/IC8vIGlzIGl0IGEgZG9jdW1lbnQKCQkJCS8vIEVpdGhlciBzY3JvbGxbV2lkdGgvSGVpZ2h0XSBvciBvZmZzZXRbV2lkdGgvSGVpZ2h0XSwgd2hpY2hldmVyIGlzIGdyZWF0ZXIKCQkJCU1hdGgubWF4KAoJCQkJCWVsZW0uZG9jdW1lbnRFbGVtZW50WyJjbGllbnQiICsgbmFtZV0sCgkJCQkJZWxlbS5ib2R5WyJzY3JvbGwiICsgbmFtZV0sIGVsZW0uZG9jdW1lbnRFbGVtZW50WyJzY3JvbGwiICsgbmFtZV0sCgkJCQkJZWxlbS5ib2R5WyJvZmZzZXQiICsgbmFtZV0sIGVsZW0uZG9jdW1lbnRFbGVtZW50WyJvZmZzZXQiICsgbmFtZV0KCQkJCSkgOgoKCQkJCS8vIEdldCBvciBzZXQgd2lkdGggb3IgaGVpZ2h0IG9uIHRoZSBlbGVtZW50CgkJCQlzaXplID09PSB1bmRlZmluZWQgPwoJCQkJCS8vIEdldCB3aWR0aCBvciBoZWlnaHQgb24gdGhlIGVsZW1lbnQKCQkJCQlqUXVlcnkuY3NzKCBlbGVtLCB0eXBlICkgOgoKCQkJCQkvLyBTZXQgdGhlIHdpZHRoIG9yIGhlaWdodCBvbiB0aGUgZWxlbWVudCAoZGVmYXVsdCB0byBwaXhlbHMgaWYgdmFsdWUgaXMgdW5pdGxlc3MpCgkJCQkJdGhpcy5jc3MoIHR5cGUsIHR5cGVvZiBzaXplID09PSAic3RyaW5nIiA/IHNpemUgOiBzaXplICsgInB4IiApOwoJfTsKCn0pOwovLyBFeHBvc2UgalF1ZXJ5IHRvIHRoZSBnbG9iYWwgb2JqZWN0CndpbmRvdy5qUXVlcnkgPSB3aW5kb3cuJCA9IGpRdWVyeTsKCn0pKHdpbmRvdyk7Ci8qKgogKiBAbGljZW5zZSBBbmd1bGFySlMgdjAuOS4xOQogKiAoYykgMjAxMC0yMDExIEFuZ3VsYXJKUyBodHRwOi8vYW5ndWxhcmpzLm9yZwogKiBMaWNlbnNlOiBNSVQKICovCihmdW5jdGlvbih3aW5kb3csIGRvY3VtZW50KXsKICB2YXIgX2pRdWVyeSA9IHdpbmRvdy5qUXVlcnkubm9Db25mbGljdCh0cnVlKTsKJ3VzZSBzdHJpY3QnOwoKLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCgppZiAodHlwZW9mIGRvY3VtZW50LmdldEF0dHJpYnV0ZSA9PSAkdW5kZWZpbmVkKQogIGRvY3VtZW50LmdldEF0dHJpYnV0ZSA9IGZ1bmN0aW9uKCkge307CgovKioKICogQHdvcmtJblByb2dyZXNzCiAqIEBuZ2RvYyBmdW5jdGlvbgogKiBAbmFtZSBhbmd1bGFyLmxvd2VyY2FzZQogKiBAZnVuY3Rpb24KICoKICogQGRlc2NyaXB0aW9uIENvbnZlcnRzIHN0cmluZyB0byBsb3dlcmNhc2UKICogQHBhcmFtIHtzdHJpbmd9IHN0cmluZyBTdHJpbmcgdG8gYmUgbG93ZXJjYXNlZC4KICogQHJldHVybnMge3N0cmluZ30gTG93ZXJjYXNlZCBzdHJpbmcuCiAqLwp2YXIgbG93ZXJjYXNlID0gZnVuY3Rpb24gKHN0cmluZyl7IHJldHVybiBpc1N0cmluZyhzdHJpbmcpID8gc3RyaW5nLnRvTG93ZXJDYXNlKCkgOiBzdHJpbmc7IH07CgoKLyoqCiAqIEB3b3JrSW5Qcm9ncmVzcwogKiBAbmdkb2MgZnVuY3Rpb24KICogQG5hbWUgYW5ndWxhci51cHBlcmNhc2UKICogQGZ1bmN0aW9uCiAqCiAqIEBkZXNjcmlwdGlvbiBDb252ZXJ0cyBzdHJpbmcgdG8gdXBwZXJjYXNlLgogKiBAcGFyYW0ge3N0cmluZ30gc3RyaW5nIFN0cmluZyB0byBiZSB1cHBlcmNhc2VkLgogKiBAcmV0dXJucyB7c3RyaW5nfSBVcHBlcmNhc2VkIHN0cmluZy4KICovCnZhciB1cHBlcmNhc2UgPSBmdW5jdGlvbiAoc3RyaW5nKXsgcmV0dXJuIGlzU3RyaW5nKHN0cmluZykgPyBzdHJpbmcudG9VcHBlckNhc2UoKSA6IHN0cmluZzsgfTsKCgp2YXIgbWFudWFsTG93ZXJjYXNlID0gZnVuY3Rpb24gKHMpIHsKICByZXR1cm4gaXNTdHJpbmcocykKICAgICAgPyBzLnJlcGxhY2UoL1tBLVpdL2csIGZ1bmN0aW9uIChjaCkge3JldHVybiBmcm9tQ2hhckNvZGUoY2guY2hhckNvZGVBdCgwKSB8IDMyKTsgfSkKICAgICAgOiBzOwp9Owp2YXIgbWFudWFsVXBwZXJjYXNlID0gZnVuY3Rpb24gKHMpIHsKICByZXR1cm4gaXNTdHJpbmcocykKICAgICAgPyBzLnJlcGxhY2UoL1thLXpdL2csIGZ1bmN0aW9uIChjaCkge3JldHVybiBmcm9tQ2hhckNvZGUoY2guY2hhckNvZGVBdCgwKSAmIH4zMik7IH0pCiAgICAgIDogczsKfTsKCgovLyBTdHJpbmcjdG9Mb3dlckNhc2UgYW5kIFN0cmluZyN0b1VwcGVyQ2FzZSBkb24ndCBwcm9kdWNlIGNvcnJlY3QgcmVzdWx0cyBpbiBicm93c2VycyB3aXRoIFR1cmtpc2gKLy8gbG9jYWxlLCBmb3IgdGhpcyByZWFzb24gd2UgbmVlZCB0byBkZXRlY3QgdGhpcyBjYXNlIGFuZCByZWRlZmluZSBsb3dlcmNhc2UvdXBwZXJjYXNlIG1ldGhvZHMgd2l0aAovLyBjb3JyZWN0IGJ1dCBzbG93ZXIgYWx0ZXJuYXRpdmVzLgppZiAoJ2knICE9PSAnSScudG9Mb3dlckNhc2UoKSkgewogIGxvd2VyY2FzZSA9IG1hbnVhbExvd2VyY2FzZTsKICB1cHBlcmNhc2UgPSBtYW51YWxVcHBlcmNhc2U7Cn0KCmZ1bmN0aW9uIGZyb21DaGFyQ29kZShjb2RlKSB7IHJldHVybiBTdHJpbmcuZnJvbUNoYXJDb2RlKGNvZGUpOyB9CgoKdmFyIF91bmRlZmluZWQgICAgICAgID0gdW5kZWZpbmVkLAogICAgX251bGwgICAgICAgICAgICAgPSBudWxsLAogICAgJCRlbGVtZW50ICAgICAgICAgPSAnJGVsZW1lbnQnLAogICAgJCRzY29wZSAgICAgICAgICAgPSAnJHNjb3BlJywKICAgICQkdmFsaWRhdGUgICAgICAgID0gJyR2YWxpZGF0ZScsCiAgICAkYW5ndWxhciAgICAgICAgICA9ICdhbmd1bGFyJywKICAgICRhcnJheSAgICAgICAgICAgID0gJ2FycmF5JywKICAgICRib29sZWFuICAgICAgICAgID0gJ2Jvb2xlYW4nLAogICAgJGNvbnNvbGUgICAgICAgICAgPSAnY29uc29sZScsCiAgICAkZGF0ZSAgICAgICAgICAgICA9ICdkYXRlJywKICAgICRlbGVtZW50ICAgICAgICAgID0gJ2VsZW1lbnQnLAogICAgJGZ1bmN0aW9uICAgICAgICAgPSAnZnVuY3Rpb24nLAogICAgJGxlbmd0aCAgICAgICAgICAgPSAnbGVuZ3RoJywKICAgICRuYW1lICAgICAgICAgICAgID0gJ25hbWUnLAogICAgJG5vb3AgICAgICAgICAgICAgPSAnbm9vcCcsCiAgICAkbnVsbCAgICAgICAgICAgICA9ICdudWxsJywKICAgICRudW1iZXIgICAgICAgICAgID0gJ251bWJlcicsCiAgICAkb2JqZWN0ICAgICAgICAgICA9ICdvYmplY3QnLAogICAgJHN0cmluZyAgICAgICAgICAgPSAnc3RyaW5nJywKICAgICR2YWx1ZSAgICAgICAgICAgID0gJ3ZhbHVlJywKICAgICRzZWxlY3RlZCAgICAgICAgID0gJ3NlbGVjdGVkJywKICAgICR1bmRlZmluZWQgICAgICAgID0gJ3VuZGVmaW5lZCcsCiAgICBOR19FWENFUFRJT04gICAgICA9ICduZy1leGNlcHRpb24nLAogICAgTkdfVkFMSURBVElPTl9FUlJPUiA9ICduZy12YWxpZGF0aW9uLWVycm9yJywKICAgIE5PT1AgICAgICAgICAgICAgID0gJ25vb3AnLAogICAgUFJJT1JJVFlfRklSU1QgICAgPSAtOTk5OTksCiAgICBQUklPUklUWV9XQVRDSCAgICA9IC0xMDAwLAogICAgUFJJT1JJVFlfTEFTVCAgICAgPSAgOTk5OTksCiAgICBQUklPUklUWSAgICAgICAgICA9IHsnRklSU1QnOiBQUklPUklUWV9GSVJTVCwgJ0xBU1QnOiBQUklPUklUWV9MQVNULCAnV0FUQ0gnOlBSSU9SSVRZX1dBVENIfSwKICAgIEVycm9yICAgICAgICAgICAgID0gd2luZG93LkVycm9yLAogICAgLyoqIGhvbGRzIG1ham9yIHZlcnNpb24gbnVtYmVyIGZvciBJRSBvciBOYU4gZm9yIHJlYWwgYnJvd3NlcnMgKi8KICAgIG1zaWUgICAgICAgICAgICAgID0gcGFyc2VJbnQoKC9tc2llIChcZCspLy5leGVjKGxvd2VyY2FzZShuYXZpZ2F0b3IudXNlckFnZW50KSkgfHwgW10pWzFdLCAxMCksCiAgICBqcUxpdGUsICAgICAgICAgICAvLyBkZWxheSBiaW5kaW5nIHNpbmNlIGpRdWVyeSBjb3VsZCBiZSBsb2FkZWQgYWZ0ZXIgdXMuCiAgICBqUXVlcnksICAgICAgICAgICAvLyBkZWxheSBiaW5kaW5nCiAgICBzbGljZSAgICAgICAgICAgICA9IFtdLnNsaWNlLAogICAgcHVzaCAgICAgICAgICAgICAgPSBbXS5wdXNoLAogICAgZXJyb3IgICAgICAgICAgICAgPSB3aW5kb3dbJGNvbnNvbGVdCiAgICAgICAgICAgICAgICAgICAgICAgICAgID8gYmluZCh3aW5kb3dbJGNvbnNvbGVdLCB3aW5kb3dbJGNvbnNvbGVdWydlcnJvciddIHx8IG5vb3ApCiAgICAgICAgICAgICAgICAgICAgICAgICAgIDogbm9vcCwKCiAgICAvKiogQG5hbWUgYW5ndWxhciAqLwogICAgYW5ndWxhciAgICAgICAgICAgPSB3aW5kb3dbJGFuZ3VsYXJdIHx8ICh3aW5kb3dbJGFuZ3VsYXJdID0ge30pLAogICAgLyoqIEBuYW1lIGFuZ3VsYXIubWFya3VwICovCiAgICBhbmd1bGFyVGV4dE1hcmt1cCA9IGV4dGVuc2lvbk1hcChhbmd1bGFyLCAnbWFya3VwJyksCiAgICAvKiogQG5hbWUgYW5ndWxhci5hdHRyTWFya3VwICovCiAgICBhbmd1bGFyQXR0ck1hcmt1cCA9IGV4dGVuc2lvbk1hcChhbmd1bGFyLCAnYXR0ck1hcmt1cCcpLAogICAgLyoqIEBuYW1lIGFuZ3VsYXIuZGlyZWN0aXZlICovCiAgICBhbmd1bGFyRGlyZWN0aXZlICA9IGV4dGVuc2lvbk1hcChhbmd1bGFyLCAnZGlyZWN0aXZlJyksCiAgICAvKiogQG5hbWUgYW5ndWxhci53aWRnZXQgKi8KICAgIGFuZ3VsYXJXaWRnZXQgICAgID0gZXh0ZW5zaW9uTWFwKGFuZ3VsYXIsICd3aWRnZXQnLCBsb3dlcmNhc2UpLAogICAgLyoqIEBuYW1lIGFuZ3VsYXIudmFsaWRhdG9yICovCiAgICBhbmd1bGFyVmFsaWRhdG9yICA9IGV4dGVuc2lvbk1hcChhbmd1bGFyLCAndmFsaWRhdG9yJyksCiAgICAvKiogQG5hbWUgYW5ndWxhci5maWxldGVyICovCiAgICBhbmd1bGFyRmlsdGVyICAgICA9IGV4dGVuc2lvbk1hcChhbmd1bGFyLCAnZmlsdGVyJyksCiAgICAvKiogQG5hbWUgYW5ndWxhci5mb3JtYXR0ZXIgKi8KICAgIGFuZ3VsYXJGb3JtYXR0ZXIgID0gZXh0ZW5zaW9uTWFwKGFuZ3VsYXIsICdmb3JtYXR0ZXInKSwKICAgIC8qKiBAbmFtZSBhbmd1bGFyLnNlcnZpY2UgKi8KICAgIGFuZ3VsYXJTZXJ2aWNlICAgID0gZXh0ZW5zaW9uTWFwKGFuZ3VsYXIsICdzZXJ2aWNlJyksCiAgICBhbmd1bGFyQ2FsbGJhY2tzICA9IGV4dGVuc2lvbk1hcChhbmd1bGFyLCAnY2FsbGJhY2tzJyksCiAgICBub2RlTmFtZV8sCiAgICBybmdTY3JpcHQgICAgICAgICA9IC9eKHwuKlwvKWFuZ3VsYXIoLS4qPyk/KFwubWluKT8uanMoXD9bXiNdKik/KCMoLiopKT8kLywKICAgIHVpZCAgICAgICAgICAgICAgID0gWycwJywgJzAnLCAnMCddLAogICAgREFURV9JU09TVFJJTkdfTE4gPSAyNDsKCi8qKgogKiBAd29ya0luUHJvZ3Jlc3MKICogQG5nZG9jIGZ1bmN0aW9uCiAqIEBuYW1lIGFuZ3VsYXIuZm9yRWFjaAogKiBAZnVuY3Rpb24KICoKICogQGRlc2NyaXB0aW9uCiAqIEludm9rZXMgdGhlIGBpdGVyYXRvcmAgZnVuY3Rpb24gb25jZSBmb3IgZWFjaCBpdGVtIGluIGBvYmpgIGNvbGxlY3Rpb24uIFRoZSBjb2xsZWN0aW9uIGNhbiBlaXRoZXIKICogYmUgYW4gb2JqZWN0IG9yIGFuIGFycmF5LiBUaGUgYGl0ZXJhdG9yYCBmdW5jdGlvbiBpcyBpbnZva2VkIHdpdGggYGl0ZXJhdG9yKHZhbHVlLCBrZXkpYCwgd2hlcmUKICogYHZhbHVlYCBpcyB0aGUgdmFsdWUgb2YgYW4gb2JqZWN0IHByb3BlcnR5IG9yIGFuIGFycmF5IGVsZW1lbnQgYW5kIGBrZXlgIGlzIHRoZSBvYmplY3QgcHJvcGVydHkKICoga2V5IG9yIGFycmF5IGVsZW1lbnQgaW5kZXguIE9wdGlvbmFsbHksIGBjb250ZXh0YCBjYW4gYmUgc3BlY2lmaWVkIGZvciB0aGUgaXRlcmF0b3IgZnVuY3Rpb24uCiAqCiAqIE5vdGU6IHRoaXMgZnVuY3Rpb24gd2FzIHByZXZpb3VzbHkga25vd24gYXMgYGFuZ3VsYXIuZm9yZWFjaGAuCiAqCiAgIDxwcmU+CiAgICAgdmFyIHZhbHVlcyA9IHtuYW1lOiAnbWlza28nLCBnZW5kZXI6ICdtYWxlJ307CiAgICAgdmFyIGxvZyA9IFtdOwogICAgIGFuZ3VsYXIuZm9yRWFjaCh2YWx1ZXMsIGZ1bmN0aW9uKHZhbHVlLCBrZXkpewogICAgICAgdGhpcy5wdXNoKGtleSArICc6ICcgKyB2YWx1ZSk7CiAgICAgfSwgbG9nKTsKICAgICBleHBlY3QobG9nKS50b0VxdWFsKFsnbmFtZTogbWlza28nLCAnZ2VuZGVyOm1hbGUnXSk7CiAgIDwvcHJlPgogKgogKiBAcGFyYW0ge09iamVjdHxBcnJheX0gb2JqIE9iamVjdCB0byBpdGVyYXRlIG92ZXIuCiAqIEBwYXJhbSB7ZnVuY3Rpb24oKX0gaXRlcmF0b3IgSXRlcmF0b3IgZnVuY3Rpb24uCiAqIEBwYXJhbSB7T2JqZWN0fSBjb250ZXh0IE9iamVjdCB0byBiZWNvbWUgY29udGV4dCAoYHRoaXNgKSBmb3IgdGhlIGl0ZXJhdG9yIGZ1bmN0aW9uLgogKiBAcmV0dXJucyB7T2JqZWN0fEFycmF5fSBSZWZlcmVuY2UgdG8gYG9iamAuCiAqLwpmdW5jdGlvbiBmb3JFYWNoKG9iaiwgaXRlcmF0b3IsIGNvbnRleHQpIHsKICB2YXIga2V5OwogIGlmIChvYmopIHsKICAgIGlmIChpc0Z1bmN0aW9uKG9iaikpewogICAgICBmb3IgKGtleSBpbiBvYmopIHsKICAgICAgICBpZiAoa2V5ICE9ICdwcm90b3R5cGUnICYmIGtleSAhPSAkbGVuZ3RoICYmIGtleSAhPSAkbmFtZSAmJiBvYmouaGFzT3duUHJvcGVydHkoa2V5KSkgewogICAgICAgICAgaXRlcmF0b3IuY2FsbChjb250ZXh0LCBvYmpba2V5XSwga2V5KTsKICAgICAgICB9CiAgICAgIH0KICAgIH0gZWxzZSBpZiAob2JqLmZvckVhY2ggJiYgb2JqLmZvckVhY2ggIT09IGZvckVhY2gpIHsKICAgICAgb2JqLmZvckVhY2goaXRlcmF0b3IsIGNvbnRleHQpOwogICAgfSBlbHNlIGlmIChpc09iamVjdChvYmopICYmIGlzTnVtYmVyKG9iai5sZW5ndGgpKSB7CiAgICAgIGZvciAoa2V5ID0gMDsga2V5IDwgb2JqLmxlbmd0aDsga2V5KyspCiAgICAgICAgaXRlcmF0b3IuY2FsbChjb250ZXh0LCBvYmpba2V5XSwga2V5KTsKICAgIH0gZWxzZSB7CiAgICAgIGZvciAoa2V5IGluIG9iaikKICAgICAgICBpdGVyYXRvci5jYWxsKGNvbnRleHQsIG9ialtrZXldLCBrZXkpOwogICAgfQogIH0KICByZXR1cm4gb2JqOwp9CgpmdW5jdGlvbiBmb3JFYWNoU29ydGVkKG9iaiwgaXRlcmF0b3IsIGNvbnRleHQpIHsKICB2YXIga2V5cyA9IFtdOwogIGZvciAodmFyIGtleSBpbiBvYmopIGtleXMucHVzaChrZXkpOwogIGtleXMuc29ydCgpOwogIGZvciAoIHZhciBpID0gMDsgaSA8IGtleXMubGVuZ3RoOyBpKyspIHsKICAgIGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgb2JqW2tleXNbaV1dLCBrZXlzW2ldKTsKICB9CiAgcmV0dXJuIGtleXM7Cn0KCgpmdW5jdGlvbiBmb3JtYXRFcnJvcihhcmcpIHsKICBpZiAoYXJnIGluc3RhbmNlb2YgRXJyb3IpIHsKICAgIGlmIChhcmcuc3RhY2spIHsKICAgICAgYXJnID0gKGFyZy5tZXNzYWdlICYmIGFyZy5zdGFjay5pbmRleE9mKGFyZy5tZXNzYWdlKSA9PT0gLTEpID8KICAgICAgICAgICAgJ0Vycm9yOiAnICsgYXJnLm1lc3NhZ2UgKyAnXG4nICsgYXJnLnN0YWNrIDogYXJnLnN0YWNrOwogICAgfSBlbHNlIGlmIChhcmcuc291cmNlVVJMKSB7CiAgICAgIGFyZyA9IGFyZy5tZXNzYWdlICsgJ1xuJyArIGFyZy5zb3VyY2VVUkwgKyAnOicgKyBhcmcubGluZTsKICAgIH0KICB9CiAgcmV0dXJuIGFyZzsKfQoKLyoqCiAqIEBkZXNjcmlwdGlvbgogKiBBIGNvbnNpc3RlbnQgd2F5IG9mIGNyZWF0aW5nIHVuaXF1ZSBJRHMgaW4gYW5ndWxhci4gVGhlIElEIGlzIGEgc2VxdWVuY2Ugb2YgYWxwaGEgbnVtZXJpYwogKiBjaGFyYWN0ZXJzIHN1Y2ggYXMgJzAxMkFCQycuIFRoZSByZWFzb24gd2h5IHdlIGFyZSBub3QgdXNpbmcgc2ltcGx5IGEgbnVtYmVyIGNvdW50ZXIgaXMgdGhhdAogKiB0aGUgbnVtYmVyIHN0cmluZyBnZXRzIGxvbmdlciBvdmVyIHRpbWUsIGFuZCBpdCBjYW4gYWxzbyBvdmVyZmxvdywgd2hlcmUgYXMgdGhlIHRoZSBuZXh0SWQKICogd2lsbCBncm93IG11Y2ggc2xvd2VyLCBpdCBpcyBhIHN0cmluZywgYW5kIGl0IHdpbGwgbmV2ZXIgb3ZlcmZsb3cuCiAqCiAqIEByZXR1cm5zIGFuIHVuaXF1ZSBhbHBoYS1udW1lcmljIHN0cmluZwogKi8KZnVuY3Rpb24gbmV4dFVpZCgpIHsKICB2YXIgaW5kZXggPSB1aWQubGVuZ3RoOwogIHZhciBkaWdpdDsKCiAgd2hpbGUoaW5kZXgpIHsKICAgIGluZGV4LS07CiAgICBkaWdpdCA9IHVpZFtpbmRleF0uY2hhckNvZGVBdCgwKTsKICAgIGlmIChkaWdpdCA9PSA1NyAvKic5JyovKSB7CiAgICAgIHVpZFtpbmRleF0gPSAnQSc7CiAgICAgIHJldHVybiB1aWQuam9pbignJyk7CiAgICB9CiAgICBpZiAoZGlnaXQgPT0gOTAgIC8qJ1onKi8pIHsKICAgICAgdWlkW2luZGV4XSA9ICcwJzsKICAgIH0gZWxzZSB7CiAgICAgIHVpZFtpbmRleF0gPSBTdHJpbmcuZnJvbUNoYXJDb2RlKGRpZ2l0ICsgMSk7CiAgICAgIHJldHVybiB1aWQuam9pbignJyk7CiAgICB9CiAgfQogIHVpZC51bnNoaWZ0KCcwJyk7CiAgcmV0dXJuIHVpZC5qb2luKCcnKTsKfQoKLyoqCiAqIEB3b3JrSW5Qcm9ncmVzcwogKiBAbmdkb2MgZnVuY3Rpb24KICogQG5hbWUgYW5ndWxhci5leHRlbmQKICogQGZ1bmN0aW9uCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBFeHRlbmRzIHRoZSBkZXN0aW5hdGlvbiBvYmplY3QgYGRzdGAgYnkgY29weWluZyBhbGwgb2YgdGhlIHByb3BlcnRpZXMgZnJvbSB0aGUgYHNyY2Agb2JqZWN0KHMpIHRvCiAqIGBkc3RgLiBZb3UgY2FuIHNwZWNpZnkgbXVsdGlwbGUgYHNyY2Agb2JqZWN0cy4KICoKICogQHBhcmFtIHtPYmplY3R9IGRzdCBUaGUgZGVzdGluYXRpb24gb2JqZWN0LgogKiBAcGFyYW0gey4uLk9iamVjdH0gc3JjIFRoZSBzb3VyY2Ugb2JqZWN0KHMpLgogKi8KZnVuY3Rpb24gZXh0ZW5kKGRzdCkgewogIGZvckVhY2goYXJndW1lbnRzLCBmdW5jdGlvbihvYmopewogICAgaWYgKG9iaiAhPT0gZHN0KSB7CiAgICAgIGZvckVhY2gob2JqLCBmdW5jdGlvbih2YWx1ZSwga2V5KXsKICAgICAgICBkc3Rba2V5XSA9IHZhbHVlOwogICAgICB9KTsKICAgIH0KICB9KTsKICByZXR1cm4gZHN0Owp9CgoKZnVuY3Rpb24gaW5oZXJpdChwYXJlbnQsIGV4dHJhKSB7CiAgcmV0dXJuIGV4dGVuZChuZXcgKGV4dGVuZChmdW5jdGlvbigpe30sIHtwcm90b3R5cGU6cGFyZW50fSkpKCksIGV4dHJhKTsKfQoKCi8qKgogKiBAd29ya0luUHJvZ3Jlc3MKICogQG5nZG9jIGZ1bmN0aW9uCiAqIEBuYW1lIGFuZ3VsYXIubm9vcAogKiBAZnVuY3Rpb24KICoKICogQGRlc2NyaXB0aW9uCiAqIEVtcHR5IGZ1bmN0aW9uIHRoYXQgcGVyZm9ybXMgbm8gb3BlcmF0aW9uIHdoYXRzb2V2ZXIuIFRoaXMgZnVuY3Rpb24gaXMgdXNlZnVsIHdoZW4gd3JpdGluZyBjb2RlCiAqIGluIHRoZSBmdW5jdGlvbmFsIHN0eWxlLgogICA8cHJlPgogICAgIGZ1bmN0aW9uIGZvbyhjYWxsYmFjaykgewogICAgICAgdmFyIHJlc3VsdCA9IGNhbGN1bGF0ZVJlc3VsdCgpOwogICAgICAgKGNhbGxiYWNrIHx8IGFuZ3VsYXIubm9vcCkocmVzdWx0KTsKICAgICB9CiAgIDwvcHJlPgogKi8KZnVuY3Rpb24gbm9vcCgpIHt9CgoKLyoqCiAqIEB3b3JrSW5Qcm9ncmVzcwogKiBAbmdkb2MgZnVuY3Rpb24KICogQG5hbWUgYW5ndWxhci5pZGVudGl0eQogKiBAZnVuY3Rpb24KICoKICogQGRlc2NyaXB0aW9uCiAqIEEgZnVuY3Rpb24gdGhhdCBkb2VzIG5vdGhpbmcgZXhjZXB0IGZvciByZXR1cm5pbmcgaXRzIGZpcnN0IGFyZ3VtZW50LiBUaGlzIGZ1bmN0aW9uIGlzIHVzZWZ1bAogKiB3aGVuIHdyaXRpbmcgY29kZSBpbiB0aGUgZnVuY3Rpb25hbCBzdHlsZS4KICoKICAgPHByZT4KICAgICBmdW5jdGlvbiB0cmFuc2Zvcm1lcih0cmFuc2Zvcm1hdGlvbkZuLCB2YWx1ZSkgewogICAgICAgcmV0dXJuICh0cmFuc2Zvcm1hdGlvbkZuIHx8IGlkZW50aXR5KSh2YWx1ZSk7CiAgICAgfTsKICAgPC9wcmU+CiAqLwpmdW5jdGlvbiBpZGVudGl0eSgkKSB7cmV0dXJuICQ7fQoKCmZ1bmN0aW9uIHZhbHVlRm4odmFsdWUpIHtyZXR1cm4gZnVuY3Rpb24oKXsgcmV0dXJuIHZhbHVlOyB9O30KCmZ1bmN0aW9uIGV4dGVuc2lvbk1hcChhbmd1bGFyLCBuYW1lLCB0cmFuc2Zvcm0pIHsKICB2YXIgZXh0UG9pbnQ7CiAgcmV0dXJuIGFuZ3VsYXJbbmFtZV0gfHwgKGV4dFBvaW50ID0gYW5ndWxhcltuYW1lXSA9IGZ1bmN0aW9uIChuYW1lLCBmbiwgcHJvcCl7CiAgICBuYW1lID0gKHRyYW5zZm9ybSB8fCBpZGVudGl0eSkobmFtZSk7CiAgICBpZiAoaXNEZWZpbmVkKGZuKSkgewogICAgICBleHRQb2ludFtuYW1lXSA9IGV4dGVuZChmbiwgcHJvcCB8fCB7fSk7CiAgICB9CiAgICByZXR1cm4gZXh0UG9pbnRbbmFtZV07CiAgfSk7Cn0KCi8qKgogKiBAd29ya0luUHJvZ3Jlc3MKICogQG5nZG9jIGZ1bmN0aW9uCiAqIEBuYW1lIGFuZ3VsYXIuaXNVbmRlZmluZWQKICogQGZ1bmN0aW9uCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBDaGVja3MgaWYgYSByZWZlcmVuY2UgaXMgdW5kZWZpbmVkLgogKgogKiBAcGFyYW0geyp9IHZhbHVlIFJlZmVyZW5jZSB0byBjaGVjay4KICogQHJldHVybnMge2Jvb2xlYW59IFRydWUgaWYgYHZhbHVlYCBpcyB1bmRlZmluZWQuCiAqLwpmdW5jdGlvbiBpc1VuZGVmaW5lZCh2YWx1ZSl7IHJldHVybiB0eXBlb2YgdmFsdWUgPT0gJHVuZGVmaW5lZDsgfQoKCi8qKgogKiBAd29ya0luUHJvZ3Jlc3MKICogQG5nZG9jIGZ1bmN0aW9uCiAqIEBuYW1lIGFuZ3VsYXIuaXNEZWZpbmVkCiAqIEBmdW5jdGlvbgogKgogKiBAZGVzY3JpcHRpb24KICogQ2hlY2tzIGlmIGEgcmVmZXJlbmNlIGlzIGRlZmluZWQuCiAqCiAqIEBwYXJhbSB7Kn0gdmFsdWUgUmVmZXJlbmNlIHRvIGNoZWNrLgogKiBAcmV0dXJucyB7Ym9vbGVhbn0gVHJ1ZSBpZiBgdmFsdWVgIGlzIGRlZmluZWQuCiAqLwpmdW5jdGlvbiBpc0RlZmluZWQodmFsdWUpeyByZXR1cm4gdHlwZW9mIHZhbHVlICE9ICR1bmRlZmluZWQ7IH0KCgovKioKICogQHdvcmtJblByb2dyZXNzCiAqIEBuZ2RvYyBmdW5jdGlvbgogKiBAbmFtZSBhbmd1bGFyLmlzT2JqZWN0CiAqIEBmdW5jdGlvbgogKgogKiBAZGVzY3JpcHRpb24KICogQ2hlY2tzIGlmIGEgcmVmZXJlbmNlIGlzIGFuIGBPYmplY3RgLiBVbmxpa2UgaW4gSmF2YVNjcmlwdCBgbnVsbGBzIGFyZSBub3QgY29uc2lkZXJlZCB0byBiZQogKiBvYmplY3RzLgogKgogKiBAcGFyYW0geyp9IHZhbHVlIFJlZmVyZW5jZSB0byBjaGVjay4KICogQHJldHVybnMge2Jvb2xlYW59IFRydWUgaWYgYHZhbHVlYCBpcyBhbiBgT2JqZWN0YCBidXQgbm90IGBudWxsYC4KICovCmZ1bmN0aW9uIGlzT2JqZWN0KHZhbHVlKXsgcmV0dXJuIHZhbHVlIT1udWxsICYmIHR5cGVvZiB2YWx1ZSA9PSAkb2JqZWN0O30KCgovKioKICogQHdvcmtJblByb2dyZXNzCiAqIEBuZ2RvYyBmdW5jdGlvbgogKiBAbmFtZSBhbmd1bGFyLmlzU3RyaW5nCiAqIEBmdW5jdGlvbgogKgogKiBAZGVzY3JpcHRpb24KICogQ2hlY2tzIGlmIGEgcmVmZXJlbmNlIGlzIGEgYFN0cmluZ2AuCiAqCiAqIEBwYXJhbSB7Kn0gdmFsdWUgUmVmZXJlbmNlIHRvIGNoZWNrLgogKiBAcmV0dXJucyB7Ym9vbGVhbn0gVHJ1ZSBpZiBgdmFsdWVgIGlzIGEgYFN0cmluZ2AuCiAqLwpmdW5jdGlvbiBpc1N0cmluZyh2YWx1ZSl7IHJldHVybiB0eXBlb2YgdmFsdWUgPT0gJHN0cmluZzt9CgoKLyoqCiAqIEB3b3JrSW5Qcm9ncmVzcwogKiBAbmdkb2MgZnVuY3Rpb24KICogQG5hbWUgYW5ndWxhci5pc051bWJlcgogKiBAZnVuY3Rpb24KICoKICogQGRlc2NyaXB0aW9uCiAqIENoZWNrcyBpZiBhIHJlZmVyZW5jZSBpcyBhIGBOdW1iZXJgLgogKgogKiBAcGFyYW0geyp9IHZhbHVlIFJlZmVyZW5jZSB0byBjaGVjay4KICogQHJldHVybnMge2Jvb2xlYW59IFRydWUgaWYgYHZhbHVlYCBpcyBhIGBOdW1iZXJgLgogKi8KZnVuY3Rpb24gaXNOdW1iZXIodmFsdWUpeyByZXR1cm4gdHlwZW9mIHZhbHVlID09ICRudW1iZXI7fQoKCi8qKgogKiBAd29ya0luUHJvZ3Jlc3MKICogQG5nZG9jIGZ1bmN0aW9uCiAqIEBuYW1lIGFuZ3VsYXIuaXNEYXRlCiAqIEBmdW5jdGlvbgogKgogKiBAZGVzY3JpcHRpb24KICogQ2hlY2tzIGlmIHZhbHVlIGlzIGEgZGF0ZS4KICoKICogQHBhcmFtIHsqfSB2YWx1ZSBSZWZlcmVuY2UgdG8gY2hlY2suCiAqIEByZXR1cm5zIHtib29sZWFufSBUcnVlIGlmIGB2YWx1ZWAgaXMgYSBgRGF0ZWAuCiAqLwpmdW5jdGlvbiBpc0RhdGUodmFsdWUpeyByZXR1cm4gdmFsdWUgaW5zdGFuY2VvZiBEYXRlOyB9CgoKLyoqCiAqIEB3b3JrSW5Qcm9ncmVzcwogKiBAbmdkb2MgZnVuY3Rpb24KICogQG5hbWUgYW5ndWxhci5pc0FycmF5CiAqIEBmdW5jdGlvbgogKgogKiBAZGVzY3JpcHRpb24KICogQ2hlY2tzIGlmIGEgcmVmZXJlbmNlIGlzIGFuIGBBcnJheWAuCiAqCiAqIEBwYXJhbSB7Kn0gdmFsdWUgUmVmZXJlbmNlIHRvIGNoZWNrLgogKiBAcmV0dXJucyB7Ym9vbGVhbn0gVHJ1ZSBpZiBgdmFsdWVgIGlzIGFuIGBBcnJheWAuCiAqLwpmdW5jdGlvbiBpc0FycmF5KHZhbHVlKSB7IHJldHVybiB2YWx1ZSBpbnN0YW5jZW9mIEFycmF5OyB9CgoKLyoqCiAqIEB3b3JrSW5Qcm9ncmVzcwogKiBAbmdkb2MgZnVuY3Rpb24KICogQG5hbWUgYW5ndWxhci5pc0Z1bmN0aW9uCiAqIEBmdW5jdGlvbgogKgogKiBAZGVzY3JpcHRpb24KICogQ2hlY2tzIGlmIGEgcmVmZXJlbmNlIGlzIGEgYEZ1bmN0aW9uYC4KICoKICogQHBhcmFtIHsqfSB2YWx1ZSBSZWZlcmVuY2UgdG8gY2hlY2suCiAqIEByZXR1cm5zIHtib29sZWFufSBUcnVlIGlmIGB2YWx1ZWAgaXMgYSBgRnVuY3Rpb25gLgogKi8KZnVuY3Rpb24gaXNGdW5jdGlvbih2YWx1ZSl7IHJldHVybiB0eXBlb2YgdmFsdWUgPT0gJGZ1bmN0aW9uO30KCgovKioKICogQ2hlY2tzIGlmIGBvYmpgIGlzIGEgd2luZG93IG9iamVjdC4KICoKICogQHByaXZhdGUKICogQHBhcmFtIHsqfSBvYmogT2JqZWN0IHRvIGNoZWNrCiAqIEByZXR1cm5zIHtib29sZWFufSBUcnVlIGlmIGBvYmpgIGlzIGEgd2luZG93IG9iai4KICovCmZ1bmN0aW9uIGlzV2luZG93KG9iaikgewogIHJldHVybiBvYmogJiYgb2JqLmRvY3VtZW50ICYmIG9iai5sb2NhdGlvbiAmJiBvYmouYWxlcnQgJiYgb2JqLnNldEludGVydmFsOwp9CgpmdW5jdGlvbiBpc0Jvb2xlYW4odmFsdWUpIHsgcmV0dXJuIHR5cGVvZiB2YWx1ZSA9PSAkYm9vbGVhbjt9CmZ1bmN0aW9uIGlzVGV4dE5vZGUobm9kZSkgeyByZXR1cm4gbm9kZU5hbWVfKG5vZGUpID09ICcjdGV4dCc7IH0KZnVuY3Rpb24gdHJpbSh2YWx1ZSkgeyByZXR1cm4gaXNTdHJpbmcodmFsdWUpID8gdmFsdWUucmVwbGFjZSgvXlxzKi8sICcnKS5yZXBsYWNlKC9ccyokLywgJycpIDogdmFsdWU7IH0KZnVuY3Rpb24gaXNFbGVtZW50KG5vZGUpIHsKICByZXR1cm4gbm9kZSAmJgogICAgKG5vZGUubm9kZU5hbWUgIC8vIHdlIGFyZSBhIGRpcmVjdCBlbGVtZW50CiAgICB8fCAobm9kZS5iaW5kICYmIG5vZGUuZmluZCkpOyAgLy8gd2UgaGF2ZSBhIGJpbmQgYW5kIGZpbmQgbWV0aG9kIHBhcnQgb2YgalF1ZXJ5IEFQSQp9CgovKioKICogQHBhcmFtIHN0ciAna2V5MSxrZXkyLC4uLicKICogQHJldHVybnMge29iamVjdH0gaW4gdGhlIGZvcm0gb2Yge2tleTE6dHJ1ZSwga2V5Mjp0cnVlLCAuLi59CiAqLwpmdW5jdGlvbiBtYWtlTWFwKHN0cil7CiAgdmFyIG9iaiA9IHt9LCBpdGVtcyA9IHN0ci5zcGxpdCgiLCIpLCBpOwogIGZvciAoIGkgPSAwOyBpIDwgaXRlbXMubGVuZ3RoOyBpKysgKQogICAgb2JqWyBpdGVtc1tpXSBdID0gdHJ1ZTsKICByZXR1cm4gb2JqOwp9CgoKCi8qKgogKiBIVE1MIGNsYXNzIHdoaWNoIGlzIHRoZSBvbmx5IGNsYXNzIHdoaWNoIGNhbiBiZSB1c2VkIGluIG5nOmJpbmQgdG8gaW5saW5lIEhUTUwgZm9yIHNlY3VyaXR5IHJlYXNvbnMuCiAqIEBjb25zdHJ1Y3RvcgogKiBAcGFyYW0gaHRtbCByYXcgKHVuc2FmZSkgaHRtbAogKiBAcGFyYW0ge3N0cmluZz19IG9wdGlvbiBpZiBzZXQgdG8gJ3VzYWZlJyB0aGVuIGdldCBtZXRob2Qgd2lsbCByZXR1cm4gcmF3ICh1bnNhZmUvdW5zYW5pdGl6ZWQpIGh0bWwKICovCmZ1bmN0aW9uIEhUTUwoaHRtbCwgb3B0aW9uKSB7CiAgdGhpcy5odG1sID0gaHRtbDsKICB0aGlzLmdldCA9IGxvd2VyY2FzZShvcHRpb24pID09ICd1bnNhZmUnCiAgICA/IHZhbHVlRm4oaHRtbCkKICAgIDogZnVuY3Rpb24gaHRtbFNhbml0aXplKCkgewogICAgICAgIHZhciBidWYgPSBbXTsKICAgICAgICBodG1sUGFyc2VyKGh0bWwsIGh0bWxTYW5pdGl6ZVdyaXRlcihidWYpKTsKICAgICAgICByZXR1cm4gYnVmLmpvaW4oJycpOwogICAgICB9Owp9CgppZiAobXNpZSA8IDkpIHsKICBub2RlTmFtZV8gPSBmdW5jdGlvbihlbGVtZW50KSB7CiAgICBlbGVtZW50ID0gZWxlbWVudC5ub2RlTmFtZSA/IGVsZW1lbnQgOiBlbGVtZW50WzBdOwogICAgcmV0dXJuIChlbGVtZW50LnNjb3BlTmFtZSAmJiBlbGVtZW50LnNjb3BlTmFtZSAhPSAnSFRNTCcgKSA/IHVwcGVyY2FzZShlbGVtZW50LnNjb3BlTmFtZSArICc6JyArIGVsZW1lbnQubm9kZU5hbWUpIDogZWxlbWVudC5ub2RlTmFtZTsKICB9Owp9IGVsc2UgewogIG5vZGVOYW1lXyA9IGZ1bmN0aW9uKGVsZW1lbnQpIHsKICAgIHJldHVybiBlbGVtZW50Lm5vZGVOYW1lID8gZWxlbWVudC5ub2RlTmFtZSA6IGVsZW1lbnRbMF0ubm9kZU5hbWU7CiAgfTsKfQoKZnVuY3Rpb24gaXNWaXNpYmxlKGVsZW1lbnQpIHsKICB2YXIgcmVjdCA9IGVsZW1lbnRbMF0uZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCksCiAgICAgIHdpZHRoID0gKHJlY3Qud2lkdGggfHwgKHJlY3QucmlnaHR8fDAgLSByZWN0LmxlZnR8fDApKSwKICAgICAgaGVpZ2h0ID0gKHJlY3QuaGVpZ2h0IHx8IChyZWN0LmJvdHRvbXx8MCAtIHJlY3QudG9wfHwwKSk7CiAgcmV0dXJuIHdpZHRoPjAgJiYgaGVpZ2h0PjA7Cn0KCmZ1bmN0aW9uIG1hcChvYmosIGl0ZXJhdG9yLCBjb250ZXh0KSB7CiAgdmFyIHJlc3VsdHMgPSBbXTsKICBmb3JFYWNoKG9iaiwgZnVuY3Rpb24odmFsdWUsIGluZGV4LCBsaXN0KSB7CiAgICByZXN1bHRzLnB1c2goaXRlcmF0b3IuY2FsbChjb250ZXh0LCB2YWx1ZSwgaW5kZXgsIGxpc3QpKTsKICB9KTsKICByZXR1cm4gcmVzdWx0czsKfQoKCi8qKgogKiBAbmdkb2MgZnVuY3Rpb24KICogQG5hbWUgYW5ndWxhci5PYmplY3Quc2l6ZQogKiBAZnVuY3Rpb24KICoKICogQGRlc2NyaXB0aW9uCiAqIERldGVybWluZXMgdGhlIG51bWJlciBvZiBlbGVtZW50cyBpbiBhbiBhcnJheSwgbnVtYmVyIG9mIHByb3BlcnRpZXMgb2YgYW4gb2JqZWN0IG9yIHN0cmluZwogKiBsZW5ndGguCiAqCiAqIE5vdGU6IHRoaXMgZnVuY3Rpb24gaXMgdXNlZCB0byBhdWdtZW50IHRoZSBPYmplY3QgdHlwZSBpbiBhbmd1bGFyIGV4cHJlc3Npb25zLiBTZWUKICoge0BsaW5rIGFuZ3VsYXIuT2JqZWN0fSBmb3IgbW9yZSBpbmZvLgogKgogKiBAcGFyYW0ge09iamVjdHxBcnJheXxzdHJpbmd9IG9iaiBPYmplY3QsIGFycmF5IG9yIHN0cmluZyB0byBpbnNwZWN0LgogKiBAcGFyYW0ge2Jvb2xlYW59IFtvd25Qcm9wc09ubHk9ZmFsc2VdIENvdW50IG9ubHkgIm93biIgcHJvcGVydGllcyBpbiBhbiBvYmplY3QKICogQHJldHVybnMge251bWJlcn0gVGhlIHNpemUgb2YgYG9iamAgb3IgYDBgIGlmIGBvYmpgIGlzIG5laXRoZXIgYW4gb2JqZWN0IG9yIGFuIGFycmF5LgogKgogKiBAZXhhbXBsZQogKiA8ZG9jOmV4YW1wbGU+CiAqICA8ZG9jOnNvdXJjZT4KICogICBOdW1iZXIgb2YgaXRlbXMgaW4gYXJyYXk6IHt7IFsxLDJdLiRzaXplKCkgfX08YnIvPgogKiAgIE51bWJlciBvZiBpdGVtcyBpbiBvYmplY3Q6IHt7IHthOjEsIGI6MiwgYzozfS4kc2l6ZSgpIH19PGJyLz4KICogIDwvZG9jOnNvdXJjZT4KICogIDxkb2M6c2NlbmFyaW8+CiAqICAgaXQoJ3Nob3VsZCBwcmludCBjb3JyZWN0IHNpemVzIGZvciBhbiBhcnJheSBhbmQgYW4gb2JqZWN0JywgZnVuY3Rpb24oKSB7CiAqICAgICBleHBlY3QoYmluZGluZygnWzEsMl0uJHNpemUoKScpKS50b0JlKCcyJyk7CiAqICAgICBleHBlY3QoYmluZGluZygne2E6MSwgYjoyLCBjOjN9LiRzaXplKCknKSkudG9CZSgnMycpOwogKiAgIH0pOwogKiAgPC9kb2M6c2NlbmFyaW8+CiAqIDwvZG9jOmV4YW1wbGU+CiAqLwpmdW5jdGlvbiBzaXplKG9iaiwgb3duUHJvcHNPbmx5KSB7CiAgdmFyIHNpemUgPSAwLCBrZXk7CgogIGlmIChpc0FycmF5KG9iaikgfHwgaXNTdHJpbmcob2JqKSkgewogICAgcmV0dXJuIG9iai5sZW5ndGg7CiAgfSBlbHNlIGlmIChpc09iamVjdChvYmopKXsKICAgIGZvciAoa2V5IGluIG9iaikKICAgICAgaWYgKCFvd25Qcm9wc09ubHkgfHwgb2JqLmhhc093blByb3BlcnR5KGtleSkpCiAgICAgICAgc2l6ZSsrOwogIH0KCiAgcmV0dXJuIHNpemU7Cn0KCgpmdW5jdGlvbiBpbmNsdWRlcyhhcnJheSwgb2JqKSB7CiAgZm9yICggdmFyIGkgPSAwOyBpIDwgYXJyYXkubGVuZ3RoOyBpKyspIHsKICAgIGlmIChvYmogPT09IGFycmF5W2ldKSByZXR1cm4gdHJ1ZTsKICB9CiAgcmV0dXJuIGZhbHNlOwp9CgpmdW5jdGlvbiBpbmRleE9mKGFycmF5LCBvYmopIHsKICBmb3IgKCB2YXIgaSA9IDA7IGkgPCBhcnJheS5sZW5ndGg7IGkrKykgewogICAgaWYgKG9iaiA9PT0gYXJyYXlbaV0pIHJldHVybiBpOwogIH0KICByZXR1cm4gLTE7Cn0KCmZ1bmN0aW9uIGlzTGVhZk5vZGUgKG5vZGUpIHsKICBpZiAobm9kZSkgewogICAgc3dpdGNoIChub2RlLm5vZGVOYW1lKSB7CiAgICBjYXNlICJPUFRJT04iOgogICAgY2FzZSAiUFJFIjoKICAgIGNhc2UgIlRJVExFIjoKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgfQogIHJldHVybiBmYWxzZTsKfQoKLyoqCiAqIEBuZ2RvYyBmdW5jdGlvbgogKiBAbmFtZSBhbmd1bGFyLk9iamVjdC5jb3B5CiAqIEBmdW5jdGlvbgogKgogKiBAZGVzY3JpcHRpb24KICogQ3JlYXRlcyBhIGRlZXAgY29weSBvZiBgc291cmNlYC4KICoKICogSWYgYHNvdXJjZWAgaXMgYW4gb2JqZWN0IG9yIGFuIGFycmF5LCBhbGwgb2YgaXRzIG1lbWJlcnMgd2lsbCBiZSBjb3BpZWQgaW50byB0aGUgYGRlc3RpbmF0aW9uYAogKiBvYmplY3QuCiAqCiAqIElmIGBkZXN0aW5hdGlvbmAgaXMgbm90IHByb3ZpZGVkIGFuZCBgc291cmNlYCBpcyBhbiBvYmplY3Qgb3IgYW4gYXJyYXksIGEgY29weSBpcyBjcmVhdGVkICYKICogcmV0dXJuZWQsIG90aGVyd2lzZSB0aGUgYHNvdXJjZWAgaXMgcmV0dXJuZWQuCiAqCiAqIElmIGBkZXN0aW5hdGlvbmAgaXMgcHJvdmlkZWQsIGFsbCBvZiBpdHMgcHJvcGVydGllcyB3aWxsIGJlIGRlbGV0ZWQuCiAqCiAqIE5vdGU6IHRoaXMgZnVuY3Rpb24gaXMgdXNlZCB0byBhdWdtZW50IHRoZSBPYmplY3QgdHlwZSBpbiBhbmd1bGFyIGV4cHJlc3Npb25zLiBTZWUKICoge0BsaW5rIGFuZ3VsYXIuT2JqZWN0fSBmb3IgbW9yZSBpbmZvLgogKgogKiBAcGFyYW0geyp9IHNvdXJjZSBUaGUgc291cmNlIHRvIGJlIHVzZWQgdG8gbWFrZSBhIGNvcHkuCiAqICAgICAgICAgICAgICAgICAgIENhbiBiZSBhbnkgdHlwZSBpbmNsdWRpbmcgcHJpbWl0aXZlcywgYG51bGxgIGFuZCBgdW5kZWZpbmVkYC4KICogQHBhcmFtIHsoT2JqZWN0fEFycmF5KT19IGRlc3RpbmF0aW9uIE9wdGlvbmFsIGRlc3RpbmF0aW9uIGludG8gd2hpY2ggdGhlIHNvdXJjZSBpcyBjb3BpZWQuIElmCiAqICAgICBwcm92aWRlZCwgbXVzdCBiZSBvZiB0aGUgc2FtZSB0eXBlIGFzIGBzb3VyY2VgLgogKiBAcmV0dXJucyB7Kn0gVGhlIGNvcHkgb3IgdXBkYXRlZCBgZGVzdGluYXRpb25gIGlmIGBkZXN0aW5hdGlvbmAgd2FzIHNwZWNpZmllZC4KICoKICogQGV4YW1wbGUKICogPGRvYzpleGFtcGxlPgogKiAgPGRvYzpzb3VyY2U+CiAgICAgU2FsdXRhdGlvbjogPGlucHV0IHR5cGU9InRleHQiIG5hbWU9Im1hc3Rlci5zYWx1dGF0aW9uIiB2YWx1ZT0iSGVsbG8iIC8+PGJyLz4KICAgICBOYW1lOiA8aW5wdXQgdHlwZT0idGV4dCIgbmFtZT0ibWFzdGVyLm5hbWUiIHZhbHVlPSJ3b3JsZCIvPjxici8+CiAgICAgPGJ1dHRvbiBuZzpjbGljaz0iZm9ybSA9IG1hc3Rlci4kY29weSgpIj5jb3B5PC9idXR0b24+CiAgICAgPGhyLz4KCiAgICAgVGhlIG1hc3RlciBvYmplY3QgaXMgPHNwYW4gbmc6aGlkZT0ibWFzdGVyLiRlcXVhbHMoZm9ybSkiPk5PVDwvc3Bhbj4gZXF1YWwgdG8gdGhlIGZvcm0gb2JqZWN0LgoKICAgICA8cHJlPm1hc3Rlcj17e21hc3Rlcn19PC9wcmU+CiAgICAgPHByZT5mb3JtPXt7Zm9ybX19PC9wcmU+CiAqICA8L2RvYzpzb3VyY2U+CiAqICA8ZG9jOnNjZW5hcmlvPgogICBpdCgnc2hvdWxkIHByaW50IHRoYXQgaW5pdGlhbHkgdGhlIGZvcm0gb2JqZWN0IGlzIE5PVCBlcXVhbCB0byBtYXN0ZXInLCBmdW5jdGlvbigpIHsKICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgaW5wdXRbbmFtZT1tYXN0ZXIuc2FsdXRhdGlvbl0nKS52YWwoKSkudG9CZSgnSGVsbG8nKTsKICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgaW5wdXRbbmFtZT1tYXN0ZXIubmFtZV0nKS52YWwoKSkudG9CZSgnd29ybGQnKTsKICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgc3BhbicpLmNzcygnZGlzcGxheScpKS50b0JlKCdpbmxpbmUnKTsKICAgfSk7CgogICBpdCgnc2hvdWxkIG1ha2UgZm9ybSBhbmQgbWFzdGVyIGVxdWFsIHdoZW4gdGhlIGNvcHkgYnV0dG9uIGlzIGNsaWNrZWQnLCBmdW5jdGlvbigpIHsKICAgICBlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBidXR0b24nKS5jbGljaygpOwogICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBzcGFuJykuY3NzKCdkaXNwbGF5JykpLnRvQmUoJ25vbmUnKTsKICAgfSk7CiAqICA8L2RvYzpzY2VuYXJpbz4KICogPC9kb2M6ZXhhbXBsZT4KICovCmZ1bmN0aW9uIGNvcHkoc291cmNlLCBkZXN0aW5hdGlvbil7CiAgaWYgKCFkZXN0aW5hdGlvbikgewogICAgZGVzdGluYXRpb24gPSBzb3VyY2U7CiAgICBpZiAoc291cmNlKSB7CiAgICAgIGlmIChpc0FycmF5KHNvdXJjZSkpIHsKICAgICAgICBkZXN0aW5hdGlvbiA9IGNvcHkoc291cmNlLCBbXSk7CiAgICAgIH0gZWxzZSBpZiAoaXNEYXRlKHNvdXJjZSkpIHsKICAgICAgICBkZXN0aW5hdGlvbiA9IG5ldyBEYXRlKHNvdXJjZS5nZXRUaW1lKCkpOwogICAgICB9IGVsc2UgaWYgKGlzT2JqZWN0KHNvdXJjZSkpIHsKICAgICAgICBkZXN0aW5hdGlvbiA9IGNvcHkoc291cmNlLCB7fSk7CiAgICAgIH0KICAgIH0KICB9IGVsc2UgewogICAgaWYgKGlzQXJyYXkoc291cmNlKSkgewogICAgICB3aGlsZShkZXN0aW5hdGlvbi5sZW5ndGgpIHsKICAgICAgICBkZXN0aW5hdGlvbi5wb3AoKTsKICAgICAgfQogICAgICBmb3IgKCB2YXIgaSA9IDA7IGkgPCBzb3VyY2UubGVuZ3RoOyBpKyspIHsKICAgICAgICBkZXN0aW5hdGlvbi5wdXNoKGNvcHkoc291cmNlW2ldKSk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGZvckVhY2goZGVzdGluYXRpb24sIGZ1bmN0aW9uKHZhbHVlLCBrZXkpewogICAgICAgIGRlbGV0ZSBkZXN0aW5hdGlvbltrZXldOwogICAgICB9KTsKICAgICAgZm9yICggdmFyIGtleSBpbiBzb3VyY2UpIHsKICAgICAgICBkZXN0aW5hdGlvbltrZXldID0gY29weShzb3VyY2Vba2V5XSk7CiAgICAgIH0KICAgIH0KICB9CiAgcmV0dXJuIGRlc3RpbmF0aW9uOwp9CgoKLyoqCiAqIEBuZ2RvYyBmdW5jdGlvbgogKiBAbmFtZSBhbmd1bGFyLk9iamVjdC5lcXVhbHMKICogQGZ1bmN0aW9uCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBEZXRlcm1pbmVzIGlmIHR3byBvYmplY3RzIG9yIHZhbHVlIGFyZSBlcXVpdmFsZW50LgogKgogKiBUbyBiZSBlcXVpdmFsZW50LCB0aGV5IG11c3QgcGFzcyBgPT1gIGNvbXBhcmlzb24gb3IgYmUgb2YgdGhlIHNhbWUgdHlwZSBhbmQgaGF2ZSBhbGwgdGhlaXIKICogcHJvcGVydGllcyBwYXNzIGA9PWAgY29tcGFyaXNvbi4gRHVyaW5nIHByb3BlcnR5IGNvbXBhcmlzaW9uIHByb3BlcnRpZXMgb2YgYGZ1bmN0aW9uYCB0eXBlIGFuZAogKiBwcm9wZXJ0aWVzIHdpdGggbmFtZSBzdGFydGluZyB3aXRoIGAkYCBhcmUgaWdub3JlZC4KICoKICogU3VwcG9ydHMgdmFsdWVzIHR5cGVzLCBhcnJheXMgYW5kIG9iamVjdHMuCiAqCiAqIE5vdGU6IHRoaXMgZnVuY3Rpb24gaXMgdXNlZCB0byBhdWdtZW50IHRoZSBPYmplY3QgdHlwZSBpbiBhbmd1bGFyIGV4cHJlc3Npb25zLiBTZWUKICoge0BsaW5rIGFuZ3VsYXIuT2JqZWN0fSBmb3IgbW9yZSBpbmZvLgogKgogKiBAcGFyYW0geyp9IG8xIE9iamVjdCBvciB2YWx1ZSB0byBjb21wYXJlLgogKiBAcGFyYW0geyp9IG8yIE9iamVjdCBvciB2YWx1ZSB0byBjb21wYXJlLgogKiBAcmV0dXJucyB7Ym9vbGVhbn0gVHJ1ZSBpZiBhcmd1bWVudHMgYXJlIGVxdWFsLgogKgogKiBAZXhhbXBsZQogKiA8ZG9jOmV4YW1wbGU+CiAqICA8ZG9jOnNvdXJjZT4KICAgICBTYWx1dGF0aW9uOiA8aW5wdXQgdHlwZT0idGV4dCIgbmFtZT0iZ3JlZXRpbmcuc2FsdXRhdGlvbiIgdmFsdWU9IkhlbGxvIiAvPjxici8+CiAgICAgTmFtZTogPGlucHV0IHR5cGU9InRleHQiIG5hbWU9ImdyZWV0aW5nLm5hbWUiIHZhbHVlPSJ3b3JsZCIvPjxici8+CiAgICAgPGhyLz4KCiAgICAgVGhlIDxjb2RlPmdyZWV0aW5nPC9jb2RlPiBvYmplY3QgaXMKICAgICA8c3BhbiBuZzpoaWRlPSJncmVldGluZy4kZXF1YWxzKHtzYWx1dGF0aW9uOidIZWxsbycsIG5hbWU6J3dvcmxkJ30pIj5OT1Q8L3NwYW4+IGVxdWFsIHRvCiAgICAgPGNvZGU+e3NhbHV0YXRpb246J0hlbGxvJywgbmFtZTond29ybGQnfTwvY29kZT4uCgogICAgIDxwcmU+Z3JlZXRpbmc9e3tncmVldGluZ319PC9wcmU+CiAqICA8L2RvYzpzb3VyY2U+CiAqICA8ZG9jOnNjZW5hcmlvPgogICAgIGl0KCdzaG91bGQgcHJpbnQgdGhhdCBpbml0aWFseSBncmVldGluZyBpcyBlcXVhbCB0byB0aGUgaGFyZGNvZGVkIHZhbHVlIG9iamVjdCcsIGZ1bmN0aW9uKCkgewogICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIGlucHV0W25hbWU9Z3JlZXRpbmcuc2FsdXRhdGlvbl0nKS52YWwoKSkudG9CZSgnSGVsbG8nKTsKICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBpbnB1dFtuYW1lPWdyZWV0aW5nLm5hbWVdJykudmFsKCkpLnRvQmUoJ3dvcmxkJyk7CiAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgc3BhbicpLmNzcygnZGlzcGxheScpKS50b0JlKCdub25lJyk7CiAgICAgfSk7CgogICAgIGl0KCdzaG91bGQgc2F5IHRoYXQgdGhlIG9iamVjdHMgYXJlIG5vdCBlcXVhbCB3aGVuIHRoZSBmb3JtIGlzIG1vZGlmaWVkJywgZnVuY3Rpb24oKSB7CiAgICAgICBpbnB1dCgnZ3JlZXRpbmcubmFtZScpLmVudGVyKCdraXR0eScpOwogICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIHNwYW4nKS5jc3MoJ2Rpc3BsYXknKSkudG9CZSgnaW5saW5lJyk7CiAgICAgfSk7CiAqICA8L2RvYzpzY2VuYXJpbz4KICogPC9kb2M6ZXhhbXBsZT4KICovCmZ1bmN0aW9uIGVxdWFscyhvMSwgbzIpIHsKICBpZiAobzEgPT0gbzIpIHJldHVybiB0cnVlOwogIGlmIChvMSA9PT0gbnVsbCB8fCBvMiA9PT0gbnVsbCkgcmV0dXJuIGZhbHNlOwogIHZhciB0MSA9IHR5cGVvZiBvMSwgdDIgPSB0eXBlb2YgbzIsIGxlbmd0aCwga2V5LCBrZXlTZXQ7CiAgaWYgKHQxID09IHQyICYmIHQxID09ICdvYmplY3QnKSB7CiAgICBpZiAobzEgaW5zdGFuY2VvZiBBcnJheSkgewogICAgICBpZiAoKGxlbmd0aCA9IG8xLmxlbmd0aCkgPT0gbzIubGVuZ3RoKSB7CiAgICAgICAgZm9yKGtleT0wOyBrZXk8bGVuZ3RoOyBrZXkrKykgewogICAgICAgICAgaWYgKCFlcXVhbHMobzFba2V5XSwgbzJba2V5XSkpIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGtleVNldCA9IHt9OwogICAgICBmb3Ioa2V5IGluIG8xKSB7CiAgICAgICAgaWYgKGtleS5jaGFyQXQoMCkgIT09ICckJyAmJiAhaXNGdW5jdGlvbihvMVtrZXldKSAmJiAhZXF1YWxzKG8xW2tleV0sIG8yW2tleV0pKSByZXR1cm4gZmFsc2U7CiAgICAgICAga2V5U2V0W2tleV0gPSB0cnVlOwogICAgICB9CiAgICAgIGZvcihrZXkgaW4gbzIpIHsKICAgICAgICBpZiAoIWtleVNldFtrZXldICYmIGtleS5jaGFyQXQoMCkgIT09ICckJyAmJiAhaXNGdW5jdGlvbihvMltrZXldKSkgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIHJldHVybiB0cnVlOwogICAgfQogIH0KICByZXR1cm4gZmFsc2U7Cn0KCmZ1bmN0aW9uIHNldEh0bWwobm9kZSwgaHRtbCkgewogIGlmIChpc0xlYWZOb2RlKG5vZGUpKSB7CiAgICBpZiAobXNpZSkgewogICAgICBub2RlLmlubmVyVGV4dCA9IGh0bWw7CiAgICB9IGVsc2UgewogICAgICBub2RlLnRleHRDb250ZW50ID0gaHRtbDsKICAgIH0KICB9IGVsc2UgewogICAgbm9kZS5pbm5lckhUTUwgPSBodG1sOwogIH0KfQoKZnVuY3Rpb24gaXNSZW5kZXJhYmxlRWxlbWVudChlbGVtZW50KSB7CiAgdmFyIG5hbWUgPSBlbGVtZW50ICYmIGVsZW1lbnRbMF0gJiYgZWxlbWVudFswXS5ub2RlTmFtZTsKICByZXR1cm4gbmFtZSAmJiBuYW1lLmNoYXJBdCgwKSAhPSAnIycgJiYKICAgICFpbmNsdWRlcyhbJ1RSJywgJ0NPTCcsICdDT0xHUk9VUCcsICdUQk9EWScsICdUSEVBRCcsICdURk9PVCddLCBuYW1lKTsKfQoKZnVuY3Rpb24gZWxlbWVudEVycm9yKGVsZW1lbnQsIHR5cGUsIGVycm9yKSB7CiAgdmFyIHBhcmVudDsKCiAgd2hpbGUgKCFpc1JlbmRlcmFibGVFbGVtZW50KGVsZW1lbnQpKSB7CiAgICBwYXJlbnQgPSBlbGVtZW50LnBhcmVudCgpOwogICAgaWYgKHBhcmVudC5sZW5ndGgpIHsKICAgICAgZWxlbWVudCA9IGVsZW1lbnQucGFyZW50KCk7CiAgICB9IGVsc2UgewogICAgICByZXR1cm47CiAgICB9CiAgfQoKICBpZiAoZWxlbWVudFswXVsnJE5HX0VSUk9SJ10gIT09IGVycm9yKSB7CiAgICBlbGVtZW50WzBdWyckTkdfRVJST1InXSA9IGVycm9yOwogICAgaWYgKGVycm9yKSB7CiAgICAgIGVsZW1lbnQuYWRkQ2xhc3ModHlwZSk7CiAgICAgIGVsZW1lbnQuYXR0cih0eXBlLCBlcnJvci5tZXNzYWdlIHx8IGVycm9yKTsKICAgIH0gZWxzZSB7CiAgICAgIGVsZW1lbnQucmVtb3ZlQ2xhc3ModHlwZSk7CiAgICAgIGVsZW1lbnQucmVtb3ZlQXR0cih0eXBlKTsKICAgIH0KICB9Cn0KCmZ1bmN0aW9uIGNvbmNhdChhcnJheTEsIGFycmF5MiwgaW5kZXgpIHsKICByZXR1cm4gYXJyYXkxLmNvbmNhdChzbGljZS5jYWxsKGFycmF5MiwgaW5kZXgsIGFycmF5Mi5sZW5ndGgpKTsKfQoKCi8qKgogKiBAd29ya0luUHJvZ3Jlc3MKICogQG5nZG9jIGZ1bmN0aW9uCiAqIEBuYW1lIGFuZ3VsYXIuYmluZAogKiBAZnVuY3Rpb24KICoKICogQGRlc2NyaXB0aW9uCiAqIFJldHVybnMgYSBmdW5jdGlvbiB3aGljaCBjYWxscyBmdW5jdGlvbiBgZm5gIGJvdW5kIHRvIGBzZWxmYCAoYHNlbGZgIGJlY29tZXMgdGhlIGB0aGlzYCBmb3IgYGZuYCkuCiAqIE9wdGlvbmFsIGBhcmdzYCBjYW4gYmUgc3VwcGxpZWQgd2hpY2ggYXJlIHByZWJvdW5kIHRvIHRoZSBmdW5jdGlvbiwgYWxzbyBrbm93biBhcwogKiBbZnVuY3Rpb24gY3VycnlpbmddKGh0dHA6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvQ3VycnlpbmcpLgogKgogKiBAcGFyYW0ge09iamVjdH0gc2VsZiBDb250ZXh0IHdoaWNoIGBmbmAgc2hvdWxkIGJlIGV2YWx1YXRlZCBpbi4KICogQHBhcmFtIHtmdW5jdGlvbigpfSBmbiBGdW5jdGlvbiB0byBiZSBib3VuZC4KICogQHBhcmFtIHsuLi4qfSBhcmdzIE9wdGlvbmFsIGFyZ3VtZW50cyB0byBiZSBwcmVib3VuZCB0byB0aGUgYGZuYCBmdW5jdGlvbiBjYWxsLgogKiBAcmV0dXJucyB7ZnVuY3Rpb24oKX0gRnVuY3Rpb24gdGhhdCB3cmFwcyB0aGUgYGZuYCB3aXRoIGFsbCB0aGUgc3BlY2lmaWVkIGJpbmRpbmdzLgogKi8KZnVuY3Rpb24gYmluZChzZWxmLCBmbikgewogIHZhciBjdXJyeUFyZ3MgPSBhcmd1bWVudHMubGVuZ3RoID4gMgogICAgPyBzbGljZS5jYWxsKGFyZ3VtZW50cywgMiwgYXJndW1lbnRzLmxlbmd0aCkKICAgIDogW107CiAgaWYgKHR5cGVvZiBmbiA9PSAkZnVuY3Rpb24gJiYgIShmbiBpbnN0YW5jZW9mIFJlZ0V4cCkpIHsKICAgIHJldHVybiBjdXJyeUFyZ3MubGVuZ3RoCiAgICAgID8gZnVuY3Rpb24oKSB7CiAgICAgICAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aAogICAgICAgICAgICA/IGZuLmFwcGx5KHNlbGYsIGN1cnJ5QXJncy5jb25jYXQoc2xpY2UuY2FsbChhcmd1bWVudHMsIDAsIGFyZ3VtZW50cy5sZW5ndGgpKSkKICAgICAgICAgICAgOiBmbi5hcHBseShzZWxmLCBjdXJyeUFyZ3MpOwogICAgICAgIH0KICAgICAgOiBmdW5jdGlvbigpIHsKICAgICAgICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoCiAgICAgICAgICAgID8gZm4uYXBwbHkoc2VsZiwgYXJndW1lbnRzKQogICAgICAgICAgICA6IGZuLmNhbGwoc2VsZik7CiAgICAgICAgfTsKICB9IGVsc2UgewogICAgLy8gaW4gSUUsIG5hdGl2ZSBtZXRob2RzIGFyZSBub3QgZnVuY3Rpb25zIGFuZCBzbyB0aGV5IGNhbiBub3QgYmUgYm91bmQgKGJ1dCB0aGV5IGRvbid0IG5lZWQgdG8gYmUpCiAgICByZXR1cm4gZm47CiAgfQp9CgpmdW5jdGlvbiB0b0Jvb2xlYW4odmFsdWUpIHsKICBpZiAodmFsdWUgJiYgdmFsdWUubGVuZ3RoICE9PSAwKSB7CiAgICB2YXIgdiA9IGxvd2VyY2FzZSgiIiArIHZhbHVlKTsKICAgIHZhbHVlID0gISh2ID09ICdmJyB8fCB2ID09ICcwJyB8fCB2ID09ICdmYWxzZScgfHwgdiA9PSAnbm8nIHx8IHYgPT0gJ24nIHx8IHYgPT0gJ1tdJyk7CiAgfSBlbHNlIHsKICAgIHZhbHVlID0gZmFsc2U7CiAgfQogIHJldHVybiB2YWx1ZTsKfQoKZnVuY3Rpb24gbWVyZ2Uoc3JjLCBkc3QpIHsKICBmb3IgKCB2YXIga2V5IGluIHNyYykgewogICAgdmFyIHZhbHVlID0gZHN0W2tleV07CiAgICB2YXIgdHlwZSA9IHR5cGVvZiB2YWx1ZTsKICAgIGlmICh0eXBlID09ICR1bmRlZmluZWQpIHsKICAgICAgZHN0W2tleV0gPSBmcm9tSnNvbih0b0pzb24oc3JjW2tleV0pKTsKICAgIH0gZWxzZSBpZiAodHlwZSA9PSAnb2JqZWN0JyAmJiB2YWx1ZS5jb25zdHJ1Y3RvciAhPSBhcnJheSAmJgogICAgICAgIGtleS5zdWJzdHJpbmcoMCwgMSkgIT0gIiQiKSB7CiAgICAgIG1lcmdlKHNyY1trZXldLCB2YWx1ZSk7CiAgICB9CiAgfQp9CgoKLyoqIEBuYW1lIGFuZ3VsYXIuY29tcGlsZSAqLwpmdW5jdGlvbiBjb21waWxlKGVsZW1lbnQpIHsKICByZXR1cm4gbmV3IENvbXBpbGVyKGFuZ3VsYXJUZXh0TWFya3VwLCBhbmd1bGFyQXR0ck1hcmt1cCwgYW5ndWxhckRpcmVjdGl2ZSwgYW5ndWxhcldpZGdldCkKICAgIC5jb21waWxlKGVsZW1lbnQpOwp9Ci8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KCi8qKgogKiBQYXJzZXMgYW4gZXNjYXBlZCB1cmwgcXVlcnkgc3RyaW5nIGludG8ga2V5LXZhbHVlIHBhaXJzLgogKiBAcmV0dXJucyBPYmplY3QuPChzdHJpbmd8Ym9vbGVhbik+CiAqLwpmdW5jdGlvbiBwYXJzZUtleVZhbHVlKC8qKnN0cmluZyova2V5VmFsdWUpIHsKICB2YXIgb2JqID0ge30sIGtleV92YWx1ZSwga2V5OwogIGZvckVhY2goKGtleVZhbHVlIHx8ICIiKS5zcGxpdCgnJicpLCBmdW5jdGlvbihrZXlWYWx1ZSl7CiAgICBpZiAoa2V5VmFsdWUpIHsKICAgICAga2V5X3ZhbHVlID0ga2V5VmFsdWUuc3BsaXQoJz0nKTsKICAgICAga2V5ID0gdW5lc2NhcGUoa2V5X3ZhbHVlWzBdKTsKICAgICAgb2JqW2tleV0gPSBpc0RlZmluZWQoa2V5X3ZhbHVlWzFdKSA/IHVuZXNjYXBlKGtleV92YWx1ZVsxXSkgOiB0cnVlOwogICAgfQogIH0pOwogIHJldHVybiBvYmo7Cn0KCmZ1bmN0aW9uIHRvS2V5VmFsdWUob2JqKSB7CiAgdmFyIHBhcnRzID0gW107CiAgZm9yRWFjaChvYmosIGZ1bmN0aW9uKHZhbHVlLCBrZXkpIHsKICAgIHBhcnRzLnB1c2goZXNjYXBlKGtleSkgKyAodmFsdWUgPT09IHRydWUgPyAnJyA6ICc9JyArIGVzY2FwZSh2YWx1ZSkpKTsKICB9KTsKICByZXR1cm4gcGFydHMubGVuZ3RoID8gcGFydHMuam9pbignJicpIDogJyc7Cn0KCgovKioKICogV2UgbmVlZCBvdXIgY3VzdG9tIG1laHRvZCBiZWNhdXNlIGVuY29kZVVSSUNvbXBvbmVudCBpcyB0b28gYWdyZXNzaXZlIGFuZCBkb2Vzbid0IGZvbGxvdwogKiBodHRwOi8vd3d3LmlldGYub3JnL3JmYy9yZmMzOTg2LnR4dCB3aXRoIHJlZ2FyZHMgdG8gdGhlIGNoYXJhY3RlciBzZXQgKHBjaGFyKSBhbGxvd2VkIGluIHBhdGgKICogc2VnbWVudHM6CiAqICAgIHNlZ21lbnQgICAgICAgPSAqcGNoYXIKICogICAgcGNoYXIgICAgICAgICA9IHVucmVzZXJ2ZWQgLyBwY3QtZW5jb2RlZCAvIHN1Yi1kZWxpbXMgLyAiOiIgLyAiQCIKICogICAgcGN0LWVuY29kZWQgICA9ICIlIiBIRVhESUcgSEVYRElHCiAqICAgIHVucmVzZXJ2ZWQgICAgPSBBTFBIQSAvIERJR0lUIC8gIi0iIC8gIi4iIC8gIl8iIC8gIn4iCiAqICAgIHN1Yi1kZWxpbXMgICAgPSAiISIgLyAiJCIgLyAiJiIgLyAiJyIgLyAiKCIgLyAiKSIKICogICAgICAgICAgICAgICAgICAgICAvICIqIiAvICIrIiAvICIsIiAvICI7IiAvICI9IgogKi8KZnVuY3Rpb24gZW5jb2RlVXJpU2VnbWVudCh2YWwpIHsKICByZXR1cm4gZW5jb2RlVXJpUXVlcnkodmFsLCB0cnVlKS4KICAgICAgICAgICAgIHJlcGxhY2UoLyUyNi9naSwgJyYnKS4KICAgICAgICAgICAgIHJlcGxhY2UoLyUzRC9naSwgJz0nKS4KICAgICAgICAgICAgIHJlcGxhY2UoLyUyQi9naSwgJysnKTsKfQoKCi8qKgogKiBUaGlzIG1ldGhvZCBpcyBpbnRlbmRlZCBmb3IgZW5jb2RpbmcgKmtleSogb3IgKnZhbHVlKiBwYXJ0cyBvZiBxdWVyeSBjb21wb25lbnQuIFdlIG5lZWQgYSBjdXN0b20KICogbWV0aG9kIGJlY3Vhc2UgZW5jb2RlVVJJQ29tcG9uZW50IGlzIHRvbyBhZ3Jlc3NpdmUgYW5kIGVuY29kZXMgc3R1ZmYgdGhhdCBkb2Vzbid0IGhhdmUgdG8gYmUKICogZW5jb2RlZCBwZXIgaHR0cDovL3Rvb2xzLmlldGYub3JnL2h0bWwvcmZjMzk4NjoKICogICAgcXVlcnkgICAgICAgPSAqKCBwY2hhciAvICIvIiAvICI/IiApCiAqICAgIHBjaGFyICAgICAgICAgPSB1bnJlc2VydmVkIC8gcGN0LWVuY29kZWQgLyBzdWItZGVsaW1zIC8gIjoiIC8gIkAiCiAqICAgIHVucmVzZXJ2ZWQgICAgPSBBTFBIQSAvIERJR0lUIC8gIi0iIC8gIi4iIC8gIl8iIC8gIn4iCiAqICAgIHBjdC1lbmNvZGVkICAgPSAiJSIgSEVYRElHIEhFWERJRwogKiAgICBzdWItZGVsaW1zICAgID0gIiEiIC8gIiQiIC8gIiYiIC8gIiciIC8gIigiIC8gIikiCiAqICAgICAgICAgICAgICAgICAgICAgLyAiKiIgLyAiKyIgLyAiLCIgLyAiOyIgLyAiPSIKICovCmZ1bmN0aW9uIGVuY29kZVVyaVF1ZXJ5KHZhbCwgcGN0RW5jb2RlU3BhY2VzKSB7CiAgcmV0dXJuIGVuY29kZVVSSUNvbXBvbmVudCh2YWwpLgogICAgICAgICAgICAgcmVwbGFjZSgvJTQwL2dpLCAnQCcpLgogICAgICAgICAgICAgcmVwbGFjZSgvJTNBL2dpLCAnOicpLgogICAgICAgICAgICAgcmVwbGFjZSgvJTI0L2csICckJykuCiAgICAgICAgICAgICByZXBsYWNlKC8lMkMvZ2ksICcsJykuCiAgICAgICAgICAgICByZXBsYWNlKChwY3RFbmNvZGVTcGFjZXMgPyBudWxsIDogLyUyMC9nKSwgJysnKTsKfQoKCi8qKgogKiBAd29ya0luUHJvZ3Jlc3MKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBhbmd1bGFyLmRpcmVjdGl2ZS5uZzphdXRvYmluZAogKiBAZWxlbWVudCBzY3JpcHQKICoKICogQFRPRE8gbmc6YXV0b2JpbmQgaXMgbm90IGEgZGlyZWN0aXZlISEgaXQgc2hvdWxkIGJlIGRvY3VtZW50ZWQgYXMgYm9vdHN0cmFwIHBhcmFtZXRlciBpbiBhCiAqICAgICBzZXBhcmF0ZSBib290c3RyYXAgc2VjdGlvbi4KICogQFRPRE8gcmVuYW1lIHRvIG5nOmF1dG9iaW5kIHRvIG5nOmF1dG9ib290CiAqCiAqIEBkZXNjcmlwdGlvbgogKgogKiBgbmc6YXV0b2JpbmRgIHdpdGggbm8gcGFyYW1ldGVycyB0ZWxscyBhbmd1bGFyIHRvIGNvbXBpbGUgYW5kIG1hbmFnZSB0aGUgd2hvbGUgcGFnZS4KICoKICogYG5nOmF1dG9iaW5kPSJbcm9vdCBlbGVtZW50IElEXSJgIHRlbGxzIGFuZ3VsYXIgdG8gY29tcGlsZSBhbmQgbWFuYWdlIHBhcnQgb2YgdGhlIGRvY3VjbWVudCwKICogc3RhcnRpbmcgYXQgInJvb3QgZWxlbWVudCBJRCIuCiAqCiAqIEZvciBkZXRhaWxzIG9uIGJvb3RzdHJhcHBpbmcgYW5ndWxhciwgc2VlIHtAbGluayBndWlkZS9kZXZfZ3VpZGUuYm9vdHN0cmFwIEluaXRpYWxpemluZyBBbmd1bGFyfQogKiBpbiB0aGUgQW5ndWxhciBEZXZlbG9wZXIgR3VpZGUuCiAqLwpmdW5jdGlvbiBhbmd1bGFySW5pdChjb25maWcsIGRvY3VtZW50KXsKICB2YXIgYXV0b2JpbmQgPSBjb25maWcuYXV0b2JpbmQ7CgogIGlmIChhdXRvYmluZCkgewogICAgdmFyIGVsZW1lbnQgPSBpc1N0cmluZyhhdXRvYmluZCkgPyBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChhdXRvYmluZCkgOiBkb2N1bWVudCwKICAgICAgICBzY29wZSA9IGNvbXBpbGUoZWxlbWVudCkoY3JlYXRlU2NvcGUoeyckY29uZmlnJzpjb25maWd9KSksCiAgICAgICAgJGJyb3dzZXIgPSBzY29wZS4kc2VydmljZSgnJGJyb3dzZXInKTsKCiAgICBpZiAoY29uZmlnLmNzcykKICAgICAgJGJyb3dzZXIuYWRkQ3NzKGNvbmZpZy5iYXNlX3VybCArIGNvbmZpZy5jc3MpOwogICAgZWxzZSBpZihtc2llPDgpCiAgICAgICRicm93c2VyLmFkZEpzKGNvbmZpZy5pZV9jb21wYXQsIGNvbmZpZy5pZV9jb21wYXRfaWQpOwogIH0KfQoKZnVuY3Rpb24gYW5ndWxhckpzQ29uZmlnKGRvY3VtZW50LCBjb25maWcpIHsKICBiaW5kSlF1ZXJ5KCk7CiAgdmFyIHNjcmlwdHMgPSBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgic2NyaXB0IiksCiAgICAgIG1hdGNoOwogIGNvbmZpZyA9IGV4dGVuZCh7CiAgICBpZV9jb21wYXRfaWQ6ICduZy1pZS1jb21wYXQnCiAgfSwgY29uZmlnKTsKICBmb3IodmFyIGogPSAwOyBqIDwgc2NyaXB0cy5sZW5ndGg7IGorKykgewogICAgbWF0Y2ggPSAoc2NyaXB0c1tqXS5zcmMgfHwgIiIpLm1hdGNoKHJuZ1NjcmlwdCk7CiAgICBpZiAobWF0Y2gpIHsKICAgICAgY29uZmlnLmJhc2VfdXJsID0gbWF0Y2hbMV07CiAgICAgIGNvbmZpZy5pZV9jb21wYXQgPSBtYXRjaFsxXSArICdhbmd1bGFyLWllLWNvbXBhdCcgKyAobWF0Y2hbMl0gfHwgJycpICsgJy5qcyc7CiAgICAgIGV4dGVuZChjb25maWcsIHBhcnNlS2V5VmFsdWUobWF0Y2hbNl0pKTsKICAgICAgZWFjaEF0dHJpYnV0ZShqcUxpdGUoc2NyaXB0c1tqXSksIGZ1bmN0aW9uKHZhbHVlLCBuYW1lKXsKICAgICAgICBpZiAoL15uZzovLmV4ZWMobmFtZSkpIHsKICAgICAgICAgIG5hbWUgPSBuYW1lLnN1YnN0cmluZygzKS5yZXBsYWNlKC8tL2csICdfJyk7CiAgICAgICAgICB2YWx1ZSA9IHZhbHVlIHx8IHRydWU7CiAgICAgICAgICBjb25maWdbbmFtZV0gPSB2YWx1ZTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQogIH0KICByZXR1cm4gY29uZmlnOwp9CgpmdW5jdGlvbiBiaW5kSlF1ZXJ5KCl7CiAgLy8gYmluZCB0byBqUXVlcnkgaWYgcHJlc2VudDsKICBqUXVlcnkgPSB3aW5kb3cualF1ZXJ5OwogIC8vIHJlc2V0IHRvIGpRdWVyeSBvciBkZWZhdWx0IHRvIHVzLgogIGlmIChqUXVlcnkpIHsKICAgIGpxTGl0ZSA9IGpRdWVyeTsKICAgIGV4dGVuZChqUXVlcnkuZm4sIHsKICAgICAgc2NvcGU6IEpRTGl0ZVByb3RvdHlwZS5zY29wZQogICAgfSk7CiAgfSBlbHNlIHsKICAgIGpxTGl0ZSA9IGpxTGl0ZVdyYXA7CiAgfQogIGFuZ3VsYXIuZWxlbWVudCA9IGpxTGl0ZTsKfQoKLyoqCiAqIHRocm93IGVycm9yIG9mIHRoZSBhcmd1bWVudCBpcyBmYWxzeS4KICovCmZ1bmN0aW9uIGFzc2VydEFyZyhhcmcsIG5hbWUsIHJlYXNvbikgewogIGlmICghYXJnKSB7CiAgICB2YXIgZXJyb3IgPSBuZXcgRXJyb3IoIkFyZ3VtZW50ICciICsgKG5hbWV8fCc/JykgKyAiJyBpcyAiICsKICAgICAgICAocmVhc29uIHx8ICJyZXF1aXJlZCIpKTsKICAgIHRocm93IGVycm9yOwogIH0KfQoKZnVuY3Rpb24gYXNzZXJ0QXJnRm4oYXJnLCBuYW1lKSB7CiAgYXNzZXJ0QXJnKGlzRnVuY3Rpb24oYXJnLCBuYW1lLCAnbm90IGEgZnVuY3Rpb24nKSk7Cn0KCgovKioKICogQG5nZG9jIHByb3BlcnR5CiAqIEBuYW1lIGFuZ3VsYXIudmVyc2lvbgogKiBAZGVzY3JpcHRpb24KICogT2JqZWN0IHdoaWNoIGNvbnRhaW5zIGluZm9ybWF0aW9uIGFib3V0IHRoZSBjdXJyZW50IEFuZ3VsYXJKUyB2ZXJzaW9uLiBUaGUgb2JqZWN0IGhhcyBmb2xsb3dpbmcKICogcHJvcGVydGllczoKICoKICogLSBgZnVsbGAg4oCTIGB7c3RyaW5nfWAg4oCTIGZ1bGwgdmVyc2lvbiBzdHJpbmcsIGUuZy4gIjAuOS4xOCIKICogLSBgbWFqb3JgIOKAkyBge251bWJlcn1gIOKAkyBtYWpvciB2ZXJzaW9uIG51bWJlciwgZS5nLiAwCiAqIC0gYG1pbm9yYCDigJMgYHtudW1iZXJ9YCDigJMgbWlub3IgdmVyc2lvbiBudW1iZXIsIGUuZy4gOQogKiAtIGBkb3RgIOKAkyBge251bWJlcn1gIOKAkyBkb3QgdmVyc2lvbiBudW1iZXIsIGUuZy4gMTgKICogLSBgY29kZU5hbWVgIOKAkyBge3N0cmluZ31gIOKAkyBjb2RlIG5hbWUgb2YgdGhlIHJlbGVhc2UsIGUuZy4gImppZ2dsaW5nLWFybWZhdCIKICovCnZhciB2ZXJzaW9uID0gewogIGZ1bGw6ICcwLjkuMTknLCAgICAvLyBhbGwgb2YgdGhlc2UgcGxhY2Vob2xkZXIgc3RyaW5ncyB3aWxsIGJlIHJlcGxhY2VkIGJ5IHJha2UncwogIG1ham9yOiAiTkdfVkVSU0lPTl9NQUpPUiIsICAgIC8vIGNvbXBpbGUgdGFzawogIG1pbm9yOiAiTkdfVkVSU0lPTl9NSU5PUiIsCiAgZG90OiAiTkdfVkVSU0lPTl9ET1QiLAogIGNvZGVOYW1lOiAnIk5HX1ZFUlNJT05fQ09ERU5BTUUiJwp9OwondXNlIHN0cmljdCc7Cgp2YXIgYXJyYXkgPSBbXS5jb25zdHJ1Y3RvcjsKCi8qKgogKiBAd29ya0luUHJvZ3Jlc3MKICogQG5nZG9jIGZ1bmN0aW9uCiAqIEBuYW1lIGFuZ3VsYXIudG9Kc29uCiAqIEBmdW5jdGlvbgogKgogKiBAZGVzY3JpcHRpb24KICogU2VyaWFsaXplcyB0aGUgaW5wdXQgaW50byBhIEpTT04gZm9ybWF0ZWQgc3RyaW5nLgogKgogKiBAcGFyYW0ge09iamVjdHxBcnJheXxEYXRlfHN0cmluZ3xudW1iZXJ9IG9iaiBJbnB1dCB0byBqc29uaWZ5LgogKiBAcGFyYW0ge2Jvb2xlYW49fSBwcmV0dHkgSWYgc2V0IHRvIHRydWUsIHRoZSBKU09OIG91dHB1dCB3aWxsIGNvbnRhaW4gbmV3bGluZXMgYW5kIHdoaXRlc3BhY2UuCiAqIEByZXR1cm5zIHtzdHJpbmd9IEpzb25pZmllZCBzdHJpbmcgcmVwcmVzZW50aW5nIGBvYmpgLgogKi8KZnVuY3Rpb24gdG9Kc29uKG9iaiwgcHJldHR5KSB7CiAgdmFyIGJ1ZiA9IFtdOwogIHRvSnNvbkFycmF5KGJ1Ziwgb2JqLCBwcmV0dHkgPyAiXG4gICIgOiBudWxsLCBbXSk7CiAgcmV0dXJuIGJ1Zi5qb2luKCcnKTsKfQoKLyoqCiAqIEB3b3JrSW5Qcm9ncmVzcwogKiBAbmdkb2MgZnVuY3Rpb24KICogQG5hbWUgYW5ndWxhci5mcm9tSnNvbgogKiBAZnVuY3Rpb24KICoKICogQGRlc2NyaXB0aW9uCiAqIERlc2VyaWFsaXplcyBhIHN0cmluZyBpbiB0aGUgSlNPTiBmb3JtYXQuCiAqCiAqIEBwYXJhbSB7c3RyaW5nfSBqc29uIEpTT04gc3RyaW5nIHRvIGRlc2VyaWFsaXplLgogKiBAcGFyYW0ge2Jvb2xlYW59IFt1c2VOYXRpdmU9ZmFsc2VdIFVzZSBuYXRpdmUgSlNPTiBwYXJzZXIgaWYgYXZhaWxhYmxlCiAqIEByZXR1cm5zIHtPYmplY3R8QXJyYXl8RGF0ZXxzdHJpbmd8bnVtYmVyfSBEZXNlcmlhbGl6ZWQgdGhpbmd5LgogKi8KZnVuY3Rpb24gZnJvbUpzb24oanNvbiwgdXNlTmF0aXZlKSB7CiAgaWYgKCFpc1N0cmluZyhqc29uKSkgcmV0dXJuIGpzb247CgogIHZhciBvYmo7CgogIHRyeSB7CiAgICBpZiAodXNlTmF0aXZlICYmIHdpbmRvdy5KU09OICYmIHdpbmRvdy5KU09OLnBhcnNlKSB7CiAgICAgIG9iaiA9IEpTT04ucGFyc2UoanNvbik7CiAgICAgIHJldHVybiB0cmFuc2Zvcm1EYXRlcyhvYmopOwogICAgfQogICAgcmV0dXJuIHBhcnNlcihqc29uLCB0cnVlKS5wcmltYXJ5KCkoKTsKICB9IGNhdGNoIChlKSB7CiAgICBlcnJvcigiZnJvbUpzb24gZXJyb3I6ICIsIGpzb24sIGUpOwogICAgdGhyb3cgZTsKICB9CgogIC8vIFRPRE8gbWFrZSBmb3JFYWNoIG9wdGlvbmFsbHkgcmVjdXJzaXZlIGFuZCByZW1vdmUgdGhpcyBmdW5jdGlvbgogIGZ1bmN0aW9uIHRyYW5zZm9ybURhdGVzKG9iaikgewogICAgaWYgKGlzU3RyaW5nKG9iaikgJiYgb2JqLmxlbmd0aCA9PT0gREFURV9JU09TVFJJTkdfTE4pIHsKICAgICAgcmV0dXJuIGFuZ3VsYXJTdHJpbmcudG9EYXRlKG9iaik7CiAgICB9IGVsc2UgaWYgKGlzQXJyYXkob2JqKSB8fCBpc09iamVjdChvYmopKSB7CiAgICAgIGZvckVhY2gob2JqLCBmdW5jdGlvbih2YWwsIG5hbWUpIHsKICAgICAgICBvYmpbbmFtZV0gPSB0cmFuc2Zvcm1EYXRlcyh2YWwpOwogICAgICB9KTsKICAgIH0KICAgIHJldHVybiBvYmo7CiAgfQp9Cgphbmd1bGFyLnRvSnNvbiA9IHRvSnNvbjsKYW5ndWxhci5mcm9tSnNvbiA9IGZyb21Kc29uOwoKZnVuY3Rpb24gdG9Kc29uQXJyYXkoYnVmLCBvYmosIHByZXR0eSwgc3RhY2spIHsKICBpZiAoaXNPYmplY3Qob2JqKSkgewogICAgaWYgKG9iaiA9PT0gd2luZG93KSB7CiAgICAgIGJ1Zi5wdXNoKCdXSU5ET1cnKTsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIGlmIChvYmogPT09IGRvY3VtZW50KSB7CiAgICAgIGJ1Zi5wdXNoKCdET0NVTUVOVCcpOwogICAgICByZXR1cm47CiAgICB9CgogICAgaWYgKGluY2x1ZGVzKHN0YWNrLCBvYmopKSB7CiAgICAgIGJ1Zi5wdXNoKCdSRUNVUlNJT04nKTsKICAgICAgcmV0dXJuOwogICAgfQogICAgc3RhY2sucHVzaChvYmopOwogIH0KICBpZiAob2JqID09PSBudWxsKSB7CiAgICBidWYucHVzaCgkbnVsbCk7CiAgfSBlbHNlIGlmIChvYmogaW5zdGFuY2VvZiBSZWdFeHApIHsKICAgIGJ1Zi5wdXNoKGFuZ3VsYXIuU3RyaW5nLnF1b3RlVW5pY29kZShvYmoudG9TdHJpbmcoKSkpOwogIH0gZWxzZSBpZiAoaXNGdW5jdGlvbihvYmopKSB7CiAgICByZXR1cm47CiAgfSBlbHNlIGlmIChpc0Jvb2xlYW4ob2JqKSkgewogICAgYnVmLnB1c2goJycgKyBvYmopOwogIH0gZWxzZSBpZiAoaXNOdW1iZXIob2JqKSkgewogICAgaWYgKGlzTmFOKG9iaikpIHsKICAgICAgYnVmLnB1c2goJG51bGwpOwogICAgfSBlbHNlIHsKICAgICAgYnVmLnB1c2goJycgKyBvYmopOwogICAgfQogIH0gZWxzZSBpZiAoaXNTdHJpbmcob2JqKSkgewogICAgcmV0dXJuIGJ1Zi5wdXNoKGFuZ3VsYXIuU3RyaW5nLnF1b3RlVW5pY29kZShvYmopKTsKICB9IGVsc2UgaWYgKGlzT2JqZWN0KG9iaikpIHsKICAgIGlmIChpc0FycmF5KG9iaikpIHsKICAgICAgYnVmLnB1c2goIlsiKTsKICAgICAgdmFyIGxlbiA9IG9iai5sZW5ndGg7CiAgICAgIHZhciBzZXAgPSBmYWxzZTsKICAgICAgZm9yKHZhciBpPTA7IGk8bGVuOyBpKyspIHsKICAgICAgICB2YXIgaXRlbSA9IG9ialtpXTsKICAgICAgICBpZiAoc2VwKSBidWYucHVzaCgiLCIpOwogICAgICAgIGlmICghKGl0ZW0gaW5zdGFuY2VvZiBSZWdFeHApICYmIChpc0Z1bmN0aW9uKGl0ZW0pIHx8IGlzVW5kZWZpbmVkKGl0ZW0pKSkgewogICAgICAgICAgYnVmLnB1c2goJG51bGwpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0b0pzb25BcnJheShidWYsIGl0ZW0sIHByZXR0eSwgc3RhY2spOwogICAgICAgIH0KICAgICAgICBzZXAgPSB0cnVlOwogICAgICB9CiAgICAgIGJ1Zi5wdXNoKCJdIik7CiAgICB9IGVsc2UgaWYgKGlzRGF0ZShvYmopKSB7CiAgICAgIGJ1Zi5wdXNoKGFuZ3VsYXIuU3RyaW5nLnF1b3RlVW5pY29kZShhbmd1bGFyLkRhdGUudG9TdHJpbmcob2JqKSkpOwogICAgfSBlbHNlIHsKICAgICAgYnVmLnB1c2goInsiKTsKICAgICAgaWYgKHByZXR0eSkgYnVmLnB1c2gocHJldHR5KTsKICAgICAgdmFyIGNvbW1hID0gZmFsc2U7CiAgICAgIHZhciBjaGlsZFByZXR0eSA9IHByZXR0eSA/IHByZXR0eSArICIgICIgOiBmYWxzZTsKICAgICAgdmFyIGtleXMgPSBbXTsKICAgICAgZm9yKHZhciBrIGluIG9iaikgewogICAgICAgIGlmIChvYmouaGFzT3duUHJvcGVydHkoaykgJiYgb2JqW2tdICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgIGtleXMucHVzaChrKTsKICAgICAgICB9CiAgICAgIH0KICAgICAga2V5cy5zb3J0KCk7CiAgICAgIGZvciAoIHZhciBrZXlJbmRleCA9IDA7IGtleUluZGV4IDwga2V5cy5sZW5ndGg7IGtleUluZGV4KyspIHsKICAgICAgICB2YXIga2V5ID0ga2V5c1trZXlJbmRleF07CiAgICAgICAgdmFyIHZhbHVlID0gb2JqW2tleV07CiAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSAhPSAkZnVuY3Rpb24pIHsKICAgICAgICAgIGlmIChjb21tYSkgewogICAgICAgICAgICBidWYucHVzaCgiLCIpOwogICAgICAgICAgICBpZiAocHJldHR5KSBidWYucHVzaChwcmV0dHkpOwogICAgICAgICAgfQogICAgICAgICAgYnVmLnB1c2goYW5ndWxhci5TdHJpbmcucXVvdGUoa2V5KSk7CiAgICAgICAgICBidWYucHVzaCgiOiIpOwogICAgICAgICAgdG9Kc29uQXJyYXkoYnVmLCB2YWx1ZSwgY2hpbGRQcmV0dHksIHN0YWNrKTsKICAgICAgICAgIGNvbW1hID0gdHJ1ZTsKICAgICAgICB9CiAgICAgIH0KICAgICAgYnVmLnB1c2goIn0iKTsKICAgIH0KICB9CiAgaWYgKGlzT2JqZWN0KG9iaikpIHsKICAgIHN0YWNrLnBvcCgpOwogIH0KfQondXNlIHN0cmljdCc7CgovKioKICogVGVtcGxhdGUgcHJvdmlkZXMgZGlyZWN0aW9ucyBhbiBob3cgdG8gYmluZCB0byBhIGdpdmVuIGVsZW1lbnQuCiAqIEl0IGNvbnRhaW5zIGEgbGlzdCBvZiBpbml0IGZ1bmN0aW9ucyB3aGljaCBuZWVkIHRvIGJlIGNhbGxlZCB0bwogKiBiaW5kIHRvIGEgbmV3IGluc3RhbmNlIG9mIGVsZW1lbnRzLiBJdCBhbHNvIHByb3ZpZGVzIGEgbGlzdAogKiBvZiBjaGlsZCBwYXRocyB3aGljaCBjb250YWluIGNoaWxkIHRlbXBsYXRlcwogKi8KZnVuY3Rpb24gVGVtcGxhdGUocHJpb3JpdHkpIHsKICB0aGlzLnBhdGhzID0gW107CiAgdGhpcy5jaGlsZHJlbiA9IFtdOwogIHRoaXMuaW5pdHMgPSBbXTsKICB0aGlzLnByaW9yaXR5ID0gcHJpb3JpdHk7CiAgdGhpcy5uZXdTY29wZSA9IGZhbHNlOwp9CgpUZW1wbGF0ZS5wcm90b3R5cGUgPSB7CiAgYXR0YWNoOiBmdW5jdGlvbihlbGVtZW50LCBzY29wZSkgewogICAgdmFyIGluaXRzID0ge307CiAgICB0aGlzLmNvbGxlY3RJbml0cyhlbGVtZW50LCBpbml0cywgc2NvcGUpOwogICAgZm9yRWFjaFNvcnRlZChpbml0cywgZnVuY3Rpb24ocXVldWUpewogICAgICBmb3JFYWNoKHF1ZXVlLCBmdW5jdGlvbihmbikge2ZuKCk7fSk7CiAgICB9KTsKICB9LAoKICBjb2xsZWN0SW5pdHM6IGZ1bmN0aW9uKGVsZW1lbnQsIGluaXRzLCBzY29wZSkgewogICAgdmFyIHF1ZXVlID0gaW5pdHNbdGhpcy5wcmlvcml0eV0sIGNoaWxkU2NvcGUgPSBzY29wZTsKICAgIGlmICghcXVldWUpIHsKICAgICAgaW5pdHNbdGhpcy5wcmlvcml0eV0gPSBxdWV1ZSA9IFtdOwogICAgfQogICAgaWYgKHRoaXMubmV3U2NvcGUpIHsKICAgICAgY2hpbGRTY29wZSA9IGNyZWF0ZVNjb3BlKHNjb3BlKTsKICAgICAgc2NvcGUuJG9uRXZhbChjaGlsZFNjb3BlLiRldmFsKTsKICAgICAgZWxlbWVudC5kYXRhKCQkc2NvcGUsIGNoaWxkU2NvcGUpOwogICAgfQogICAgZm9yRWFjaCh0aGlzLmluaXRzLCBmdW5jdGlvbihmbikgewogICAgICBxdWV1ZS5wdXNoKGZ1bmN0aW9uKCkgewogICAgICAgIGNoaWxkU2NvcGUuJHRyeUV2YWwoZnVuY3Rpb24oKXsKICAgICAgICAgIHJldHVybiBjaGlsZFNjb3BlLiRzZXJ2aWNlLmludm9rZShjaGlsZFNjb3BlLCBmbiwgW2VsZW1lbnRdKTsKICAgICAgICB9LCBlbGVtZW50KTsKICAgICAgfSk7CiAgICB9KTsKICAgIHZhciBpLAogICAgICAgIGNoaWxkTm9kZXMgPSBlbGVtZW50WzBdLmNoaWxkTm9kZXMsCiAgICAgICAgY2hpbGRyZW4gPSB0aGlzLmNoaWxkcmVuLAogICAgICAgIHBhdGhzID0gdGhpcy5wYXRocywKICAgICAgICBsZW5ndGggPSBwYXRocy5sZW5ndGg7CiAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgY2hpbGRyZW5baV0uY29sbGVjdEluaXRzKGpxTGl0ZShjaGlsZE5vZGVzW3BhdGhzW2ldXSksIGluaXRzLCBjaGlsZFNjb3BlKTsKICAgIH0KICB9LAoKCiAgYWRkSW5pdDpmdW5jdGlvbihsaW5raW5nRm4pIHsKICAgIGlmIChsaW5raW5nRm4pIHsKICAgICAgaWYgKCFsaW5raW5nRm4uJGluamVjdCkKICAgICAgICBsaW5raW5nRm4uJGluamVjdCA9IFtdOwogICAgICB0aGlzLmluaXRzLnB1c2gobGlua2luZ0ZuKTsKICAgIH0KICB9LAoKCiAgYWRkQ2hpbGQ6IGZ1bmN0aW9uKGluZGV4LCB0ZW1wbGF0ZSkgewogICAgaWYgKHRlbXBsYXRlKSB7CiAgICAgIHRoaXMucGF0aHMucHVzaChpbmRleCk7CiAgICAgIHRoaXMuY2hpbGRyZW4ucHVzaCh0ZW1wbGF0ZSk7CiAgICB9CiAgfSwKCiAgZW1wdHk6IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHRoaXMuaW5pdHMubGVuZ3RoID09PSAwICYmIHRoaXMucGF0aHMubGVuZ3RoID09PSAwOwogIH0KfTsKCi8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCi8vQ29tcGlsZXIKLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwoKLyoqCiAqIEB3b3JrSW5Qcm9ncmVzcwogKiBAbmdkb2MgZnVuY3Rpb24KICogQG5hbWUgYW5ndWxhci5jb21waWxlCiAqIEBmdW5jdGlvbgogKgogKiBAZGVzY3JpcHRpb24KICogQ29tcGlsZXMgYSBwaWVjZSBvZiBIVE1MIHN0cmluZyBvciBET00gaW50byBhIHRlbXBsYXRlIGFuZCBwcm9kdWNlcyBhIHRlbXBsYXRlIGZ1bmN0aW9uLCB3aGljaAogKiBjYW4gdGhlbiBiZSB1c2VkIHRvIGxpbmsge0BsaW5rIGFuZ3VsYXIuc2NvcGUgc2NvcGV9IGFuZCB0aGUgdGVtcGxhdGUgdG9nZXRoZXIuCiAqCiAqIFRoZSBjb21waWxhdGlvbiBpcyBhIHByb2Nlc3Mgb2Ygd2Fsa2luZyB0aGUgRE9NIHRyZWUgYW5kIHRyeWluZyB0byBtYXRjaCBET00gZWxlbWVudHMgdG8KICoge0BsaW5rIGFuZ3VsYXIubWFya3VwIG1hcmt1cH0sIHtAbGluayBhbmd1bGFyLmF0dHJNYXJrdXAgYXR0ck1hcmt1cH0sCiAqIHtAbGluayBhbmd1bGFyLndpZGdldCB3aWRnZXRzfSwgYW5kIHtAbGluayBhbmd1bGFyLmRpcmVjdGl2ZSBkaXJlY3RpdmVzfS4gRm9yIGVhY2ggbWF0Y2ggaXQKICogZXhlY3V0ZXMgY29ycmVzcG9uZGluZyBtYXJrdXAsIGF0dHJNYXJrdXAsIHdpZGdldCBvciBkaXJlY3RpdmUgdGVtcGxhdGUgZnVuY3Rpb24gYW5kIGNvbGxlY3RzIHRoZQogKiBpbnN0YW5jZSBmdW5jdGlvbnMgaW50byBhIHNpbmdsZSB0ZW1wbGF0ZSBmdW5jdGlvbiB3aGljaCBpcyB0aGVuIHJldHVybmVkLgogKgogKiBUaGUgdGVtcGxhdGUgZnVuY3Rpb24gY2FuIHRoZW4gYmUgdXNlZCBvbmNlIHRvIHByb2R1Y2UgdGhlIHZpZXcgb3IgYXMgaXQgaXMgdGhlIGNhc2Ugd2l0aAogKiB7QGxpbmsgYW5ndWxhci53aWRnZXQuQG5nOnJlcGVhdCByZXBlYXRlcn0gbWFueS10aW1lcywgaW4gd2hpY2ggY2FzZSBlYWNoIGNhbGwgcmVzdWx0cyBpbiBhIHZpZXcKICogdGhhdCBpcyBhIERPTSBjbG9uZSBvZiB0aGUgb3JpZ2luYWwgdGVtcGxhdGUuCiAqCiAgIDxwcmU+CiAgICAvLyBjb21waWxlIHRoZSBlbnRpcmUgd2luZG93LmRvY3VtZW50IGFuZCBnaXZlIG1lIHRoZSBzY29wZSBib3VuZCB0byB0aGlzIHRlbXBsYXRlLgogICAgdmFyIHJvb3RTY29wZSA9IGFuZ3VsYXIuY29tcGlsZSh3aW5kb3cuZG9jdW1lbnQpKCk7CgogICAgLy8gY29tcGlsZSBhIHBpZWNlIG9mIGh0bWwKICAgIHZhciByb290U2NvcGUyID0gYW5ndWxhci5jb21waWxlKCc8ZGl2IG5nOmNsaWNrPSJjbGlja2VkID0gdHJ1ZSI+Y2xpY2sgbWU8L2Rpdj4nKSgpOwoKICAgIC8vIGNvbXBpbGUgYSBwaWVjZSBvZiBodG1sIGFuZCByZXRhaW4gcmVmZXJlbmNlIHRvIGJvdGggdGhlIGRvbSBhbmQgc2NvcGUKICAgIHZhciB0ZW1wbGF0ZSA9IGFuZ3VsYXIuZWxlbWVudCgnPGRpdiBuZzpjbGljaz0iY2xpY2tlZCA9IHRydWUiPmNsaWNrIG1lPC9kaXY+JyksCiAgICAgICAgc2NvcGUgPSBhbmd1bGFyLmNvbXBpbGUodGVtcGxhdGUpKCk7CiAgICAvLyBhdCB0aGlzIHBvaW50IHRlbXBsYXRlIHdhcyB0cmFuc2Zvcm1lZCBpbnRvIGEgdmlldwogICA8L3ByZT4KICoKICoKICogQHBhcmFtIHtzdHJpbmd8RE9NRWxlbWVudH0gZWxlbWVudCBFbGVtZW50IG9yIEhUTUwgdG8gY29tcGlsZSBpbnRvIGEgdGVtcGxhdGUgZnVuY3Rpb24uCiAqIEByZXR1cm5zIHtmdW5jdGlvbihbc2NvcGVdWywgY2xvbmVBdHRhY2hGbl0pfSBhIHRlbXBsYXRlIGZ1bmN0aW9uIHdoaWNoIGlzIHVzZWQgdG8gYmluZCB0ZW1wbGF0ZQogKiAoYSBET00gZWxlbWVudC90cmVlKSB0byBhIHNjb3BlLiBXaGVyZToKICoKICogICogYHNjb3BlYCAtIEEge0BsaW5rIGFuZ3VsYXIuc2NvcGUgU2NvcGV9IHRvIGJpbmQgdG8uIElmIG5vbmUgc3BlY2lmaWVkLCB0aGVuIGEgbmV3CiAqICAgICAgICAgICAgICAgcm9vdCBzY29wZSBpcyBjcmVhdGVkLgogKiAgKiBgY2xvbmVBdHRhY2hGbmAgLSBJZiBgY2xvbmVBdHRhY2hGbmAgaXMgcHJvdmlkZWQsIHRoZW4gdGhlIGxpbmsgZnVuY3Rpb24gd2lsbCBjbG9uZSB0aGUKICogICAgICAgICAgICAgICBgdGVtcGxhdGVgIGFuZCBjYWxsIHRoZSBgY2xvbmVBdHRhY2hGbmAgZnVuY3Rpb24gYWxsb3dpbmcgdGhlIGNhbGxlciB0byBhdHRhY2ggdGhlCiAqICAgICAgICAgICAgICAgY2xvbmVkIGVsZW1lbnRzIHRvIHRoZSBET00gZG9jdW1lbnQgYXQgdGhlIGFwcHJvcHJpYXRlIHBsYWNlLiBUaGUgYGNsb25lQXR0YWNoRm5gIGlzCiAqICAgICAgICAgICAgICAgY2FsbGVkIGFzOiA8YnIvPiBgY2xvbmVBdHRhY2hGbihjbG9uZWRFbGVtZW50LCBzY29wZSlgIHdoZXJlOgogKgogKiAgICAgICogYGNsb25lZEVsZW1lbnRgIC0gaXMgYSBjbG9uZSBvZiB0aGUgb3JpZ2luYWwgYGVsZW1lbnRgIHBhc3NlZCBpbnRvIHRoZSBjb21waWxlci4KICogICAgICAqIGBzY29wZWAgLSBpcyB0aGUgY3VycmVudCBzY29wZSB3aXRoIHdoaWNoIHRoZSBsaW5raW5nIGZ1bmN0aW9uIGlzIHdvcmtpbmcgd2l0aC4KICoKICogQ2FsbGluZyB0aGUgdGVtcGxhdGUgZnVuY3Rpb24gcmV0dXJucyB0aGUgc2NvcGUgdG8gd2hpY2ggdGhlIGVsZW1lbnQgaXMgYm91bmQgdG8uIEl0IGlzIGVpdGhlcgogKiB0aGUgc2FtZSBzY29wZSBhcyB0aGUgb25lIHBhc3NlZCBpbnRvIHRoZSB0ZW1wbGF0ZSBmdW5jdGlvbiwgb3IgaWYgbm9uZSB3ZXJlIHByb3ZpZGVkIGl0J3MgdGhlCiAqIG5ld2x5IGNyZWF0ZSBzY29wZS4KICoKICogSWYgeW91IG5lZWQgYWNjZXNzIHRvIHRoZSBib3VuZCB2aWV3LCB0aGVyZSBhcmUgdHdvIHdheXMgdG8gZG8gaXQ6CiAqCiAqIC0gSWYgeW91IGFyZSBub3QgYXNraW5nIHRoZSBsaW5raW5nIGZ1bmN0aW9uIHRvIGNsb25lIHRoZSB0ZW1wbGF0ZSwgY3JlYXRlIHRoZSBET00gZWxlbWVudChzKQogKiAgIGJlZm9yZSB5b3Ugc2VuZCB0aGVtIHRvIHRoZSBjb21waWxlciBhbmQga2VlcCB0aGlzIHJlZmVyZW5jZSBhcm91bmQuCiAqICAgPHByZT4KICogICAgIHZhciB2aWV3ID0gYW5ndWxhci5lbGVtZW50KCc8cD57e3RvdGFsfX08L3A+JyksCiAqICAgICAgICAgc2NvcGUgPSBhbmd1bGFyLmNvbXBpbGUodmlldykoKTsKICogICA8L3ByZT4KICoKICogLSBpZiBvbiB0aGUgb3RoZXIgaGFuZCwgeW91IG5lZWQgdGhlIGVsZW1lbnQgdG8gYmUgY2xvbmVkLCB0aGUgdmlldyByZWZlcmVuY2UgZnJvbSB0aGUgb3JpZ2luYWwKICogICBleGFtcGxlIHdvdWxkIG5vdCBwb2ludCB0byB0aGUgY2xvbmUsIGJ1dCByYXRoZXIgdG8gdGhlIG9yaWdpbmFsIHRlbXBsYXRlIHRoYXQgd2FzIGNsb25lZC4gSW4KICogICB0aGlzIGNhc2UsIHlvdSBjYW4gYWNjZXNzIHRoZSBjbG9uZSB2aWEgdGhlIGNsb25lQXR0YWNoRm46CiAqICAgPHByZT4KICogICAgIHZhciBvcmlnaW5hbCA9IGFuZ3VsYXIuZWxlbWVudCgnPHA+e3t0b3RhbH19PC9wPicpLAogKiAgICAgICAgIHNjb3BlID0gc29tZVBhcmVudFNjb3BlLiRuZXcoKSwKICogICAgICAgICBjbG9uZTsKICoKICogICAgIGFuZ3VsYXIuY29tcGlsZShvcmlnaW5hbCkoc2NvcGUsIGZ1bmN0aW9uKGNsb25lZEVsZW1lbnQsIHNjb3BlKSB7CiAqICAgICAgIGNsb25lID0gY2xvbmVkRWxlbWVudDsKICogICAgICAgLy9hdHRhY2ggdGhlIGNsb25lIHRvIERPTSBkb2N1bWVudCBhdCB0aGUgcmlnaHQgcGxhY2UKICogICAgIH0pOwogKgogKiAgICAgLy9ub3cgd2UgaGF2ZSByZWZlcmVuY2UgdG8gdGhlIGNsb25lZCBET00gdmlhIGBjbG9uZWAKICogICA8L3ByZT4KICoKICoKICogQ29tcGlsZXIgTWV0aG9kcyBGb3IgV2lkZ2V0cyBhbmQgRGlyZWN0aXZlczoKICoKICogVGhlIGZvbGxvd2luZyBtZXRob2RzIGFyZSBhdmFpbGFibGUgZm9yIHVzZSB3aGVuIHlvdSB3cml0ZSB5b3VyIG93biB3aWRnZXRzLCBkaXJlY3RpdmVzLAogKiBhbmQgbWFya3VwLiAgKFJlY2FsbCB0aGF0IHRoZSBjb21waWxlIGZ1bmN0aW9uJ3MgdGhpcyBpcyBhIHJlZmVyZW5jZSB0byB0aGUgY29tcGlsZXIuKQogKgogKiAgYGNvbXBpbGUoZWxlbWVudClgIC0gcmV0dXJucyBsaW5rZXIgLQogKiAgSW52b2tlIGEgbmV3IGluc3RhbmNlIG9mIHRoZSBjb21waWxlciB0byBjb21waWxlIGEgRE9NIGVsZW1lbnQgYW5kIHJldHVybiBhIGxpbmtlciBmdW5jdGlvbi4KICogIFlvdSBjYW4gYXBwbHkgdGhlIGxpbmtlciBmdW5jdGlvbiB0byB0aGUgb3JpZ2luYWwgZWxlbWVudCBvciBhIGNsb25lIG9mIHRoZSBvcmlnaW5hbCBlbGVtZW50LgogKiAgVGhlIGxpbmtlciBmdW5jdGlvbiByZXR1cm5zIGEgc2NvcGUuCiAqCiAqICAqIGBjb21tZW50KGNvbW1lbnRUZXh0KWAgLSByZXR1cm5zIGVsZW1lbnQgLSBDcmVhdGUgYSBjb21tZW50IGVsZW1lbnQuCiAqCiAqICAqIGBlbGVtZW50KGVsZW1lbnROYW1lKWAgLSByZXR1cm5zIGVsZW1lbnQgLSBDcmVhdGUgYW4gZWxlbWVudCBieSBuYW1lLgogKgogKiAgKiBgdGV4dCh0ZXh0KWAgLSByZXR1cm5zIGVsZW1lbnQgLSBDcmVhdGUgYSB0ZXh0IGVsZW1lbnQuCiAqCiAqICAqIGBkZXNjZW5kKFtzZXRdKWAgLSByZXR1cm5zIGRlc2NlbmQgc3RhdGUgKHRydWUgb3IgZmFsc2UpLiBHZXQgb3Igc2V0IHRoZSBjdXJyZW50IGRlc2NlbmQKICogIHN0YXRlLiBJZiB0cnVlIHRoZSBjb21waWxlciB3aWxsIGRlc2NlbmQgdG8gY2hpbGRyZW4gZWxlbWVudHMuCiAqCiAqICAqIGBkaXJlY3RpdmVzKFtzZXRdKWAgLSByZXR1cm5zIGRpcmVjdGl2ZSBzdGF0ZSAodHJ1ZSBvciBmYWxzZSkuIEdldCBvciBzZXQgdGhlIGN1cnJlbnQKICogIGRpcmVjdGl2ZXMgcHJvY2Vzc2luZyBzdGF0ZS4gVGhlIGNvbXBpbGVyIHdpbGwgcHJvY2VzcyBkaXJlY3RpdmVzIG9ubHkgd2hlbiBkaXJlY3RpdmVzIHNldCB0bwogKiAgdHJ1ZS4KICoKICogRm9yIGluZm9ybWF0aW9uIG9uIGhvdyB0aGUgY29tcGlsZXIgd29ya3MsIHNlZSB0aGUKICoge0BsaW5rIGd1aWRlL2Rldl9ndWlkZS5jb21waWxlciBBbmd1bGFyIEhUTUwgQ29tcGlsZXJ9IHNlY3Rpb24gb2YgdGhlIERldmVsb3BlciBHdWlkZS4KICovCmZ1bmN0aW9uIENvbXBpbGVyKG1hcmt1cCwgYXR0ck1hcmt1cCwgZGlyZWN0aXZlcywgd2lkZ2V0cyl7CiAgdGhpcy5tYXJrdXAgPSBtYXJrdXA7CiAgdGhpcy5hdHRyTWFya3VwID0gYXR0ck1hcmt1cDsKICB0aGlzLmRpcmVjdGl2ZXMgPSBkaXJlY3RpdmVzOwogIHRoaXMud2lkZ2V0cyA9IHdpZGdldHM7Cn0KCkNvbXBpbGVyLnByb3RvdHlwZSA9IHsKICBjb21waWxlOiBmdW5jdGlvbih0ZW1wbGF0ZUVsZW1lbnQpIHsKICAgIHRlbXBsYXRlRWxlbWVudCA9IGpxTGl0ZSh0ZW1wbGF0ZUVsZW1lbnQpOwogICAgdmFyIGluZGV4ID0gMCwKICAgICAgICB0ZW1wbGF0ZSwKICAgICAgICBwYXJlbnQgPSB0ZW1wbGF0ZUVsZW1lbnQucGFyZW50KCk7CiAgICBpZiAodGVtcGxhdGVFbGVtZW50Lmxlbmd0aCA+IDEpIHsKICAgICAgLy8gaHR0cHM6Ly9naXRodWIuY29tL2FuZ3VsYXIvYW5ndWxhci5qcy9pc3N1ZXMvMzM4CiAgICAgIHRocm93IEVycm9yKCJDYW5ub3QgY29tcGlsZSBtdWx0aXBsZSBlbGVtZW50IHJvb3RzOiAiICsKICAgICAgICAgIGpxTGl0ZSgnPGRpdj4nKS5hcHBlbmQodGVtcGxhdGVFbGVtZW50LmNsb25lKCkpLmh0bWwoKSk7CiAgICB9CiAgICBpZiAocGFyZW50ICYmIHBhcmVudFswXSkgewogICAgICBwYXJlbnQgPSBwYXJlbnRbMF07CiAgICAgIGZvcih2YXIgaSA9IDA7IGkgPCBwYXJlbnQuY2hpbGROb2Rlcy5sZW5ndGg7IGkrKykgewogICAgICAgIGlmIChwYXJlbnQuY2hpbGROb2Rlc1tpXSA9PSB0ZW1wbGF0ZUVsZW1lbnRbMF0pIHsKICAgICAgICAgIGluZGV4ID0gaTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIHRlbXBsYXRlID0gdGhpcy50ZW1wbGF0aXplKHRlbXBsYXRlRWxlbWVudCwgaW5kZXgsIDApIHx8IG5ldyBUZW1wbGF0ZSgpOwogICAgcmV0dXJuIGZ1bmN0aW9uKHNjb3BlLCBjbG9uZUNvbm5lY3RGbil7CiAgICAgIC8vIGltcG9ydGFudCEhOiB3ZSBtdXN0IGNhbGwgb3VyIGpxTGl0ZS5jbG9uZSgpIHNpbmNlIHRoZSBqUXVlcnkgb25lIGlzIHRyeWluZyB0byBiZSBzbWFydAogICAgICAvLyBhbmQgc29tZXRpbWVzIGNoYW5nZXMgdGhlIHN0cnVjdHVyZSBvZiB0aGUgRE9NLgogICAgICB2YXIgZWxlbWVudCA9IGNsb25lQ29ubmVjdEZuCiAgICAgICAgPyBKUUxpdGVQcm90b3R5cGUuY2xvbmUuY2FsbCh0ZW1wbGF0ZUVsZW1lbnQpIC8vIElNUE9SVEFOVCEhIQogICAgICAgIDogdGVtcGxhdGVFbGVtZW50OwogICAgICAgIHNjb3BlID0gc2NvcGUgfHwgY3JlYXRlU2NvcGUoKTsKICAgICAgZWxlbWVudC5kYXRhKCQkc2NvcGUsIHNjb3BlKTsKICAgICAgc2NvcGUuJGVsZW1lbnQgPSBlbGVtZW50OwogICAgICAoY2xvbmVDb25uZWN0Rm58fG5vb3ApKGVsZW1lbnQsIHNjb3BlKTsKICAgICAgdGVtcGxhdGUuYXR0YWNoKGVsZW1lbnQsIHNjb3BlKTsKICAgICAgc2NvcGUuJGV2YWwoKTsKICAgICAgcmV0dXJuIHNjb3BlOwogICAgfTsKICB9LAoKCiAgLyoqCiAgICogQHdvcmtJblByb2dyZXNzCiAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAqIEBuYW1lIGFuZ3VsYXIuZGlyZWN0aXZlLm5nOmV2YWwtb3JkZXIKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIE5vcm1hbGx5IHRoZSB2aWV3IGlzIHVwZGF0ZWQgZnJvbSB0b3AgdG8gYm90dG9tLiBUaGlzIHVzdWFsbHkgaXMKICAgKiBub3QgYSBwcm9ibGVtLCBidXQgdW5kZXIgc29tZSBjaXJjdW1zdGFuY2VzIHRoZSB2YWx1ZXMgZm9yIGRhdGEKICAgKiBpcyBub3QgYXZhaWxhYmxlIHVudGlsIGFmdGVyIHRoZSBmdWxsIHZpZXcgaXMgY29tcHV0ZWQuIElmIHN1Y2gKICAgKiB2YWx1ZXMgYXJlIG5lZWRlZCBiZWZvcmUgdGhleSBhcmUgY29tcHV0ZWQgdGhlIG9yZGVyIG9mCiAgICogZXZhbHVhdGlvbiBjYW4gYmUgY2hhbmdlZCB1c2luZyBuZzpldmFsLW9yZGVyCiAgICoKICAgKiBAZWxlbWVudCBBTlkKICAgKiBAcGFyYW0ge2ludGVnZXJ8c3RyaW5nPX0gW3ByaW9yaXR5PTBdIHByaW9yaXR5IGludGVnZXIsIG9yIEZJUlNULCBMQVNUIGNvbnN0YW50CiAgICoKICAgKiBAZXhhbXBsZQogICAqIHRyeSBjaGFuZ2luZyB0aGUgaW52b2ljZSBhbmQgc2VlIHRoYXQgdGhlIFRvdGFsIHdpbGwgbGFnIGluIGV2YWx1YXRpb24KICAgKiBAZXhhbXBsZQogICAgIDxkb2M6ZXhhbXBsZT4KICAgICAgIDxkb2M6c291cmNlPgogICAgICAgIDxkaXY+VE9UQUw6IHdpdGhvdXQgbmc6ZXZhbC1vcmRlciB7eyBpdGVtcy4kc3VtKCd0b3RhbCcpIHwgY3VycmVuY3kgfX08L2Rpdj4KICAgICAgICA8ZGl2IG5nOmV2YWwtb3JkZXI9J0xBU1QnPlRPVEFMOiB3aXRoIG5nOmV2YWwtb3JkZXIge3sgaXRlbXMuJHN1bSgndG90YWwnKSB8IGN1cnJlbmN5IH19PC9kaXY+CiAgICAgICAgPHRhYmxlIG5nOmluaXQ9Iml0ZW1zPVt7cXR5OjEsIGNvc3Q6OS45OSwgZGVzYzonZ2FkZ2V0J31dIj4KICAgICAgICAgIDx0cj4KICAgICAgICAgICAgPHRkPlFUWTwvdGQ+CiAgICAgICAgICAgIDx0ZD5EZXNjcmlwdGlvbjwvdGQ+CiAgICAgICAgICAgIDx0ZD5Db3N0PC90ZD4KICAgICAgICAgICAgPHRkPlRvdGFsPC90ZD4KICAgICAgICAgICAgPHRkPjwvdGQ+CiAgICAgICAgICA8L3RyPgogICAgICAgICAgPHRyIG5nOnJlcGVhdD0iaXRlbSBpbiBpdGVtcyI+CiAgICAgICAgICAgIDx0ZD48aW5wdXQgbmFtZT0iaXRlbS5xdHkiLz48L3RkPgogICAgICAgICAgICA8dGQ+PGlucHV0IG5hbWU9Iml0ZW0uZGVzYyIvPjwvdGQ+CiAgICAgICAgICAgIDx0ZD48aW5wdXQgbmFtZT0iaXRlbS5jb3N0Ii8+PC90ZD4KICAgICAgICAgICAgPHRkPnt7aXRlbS50b3RhbCA9IGl0ZW0ucXR5ICogaXRlbS5jb3N0IHwgY3VycmVuY3l9fTwvdGQ+CiAgICAgICAgICAgIDx0ZD48YSBocmVmPSIiIG5nOmNsaWNrPSJpdGVtcy4kcmVtb3ZlKGl0ZW0pIj5YPC9hPjwvdGQ+CiAgICAgICAgICA8L3RyPgogICAgICAgICAgPHRyPgogICAgICAgICAgICA8dGQgY29sc3Bhbj0iMyI+PGEgaHJlZj0iIiBuZzpjbGljaz0iaXRlbXMuJGFkZCgpIj5hZGQ8L2E+PC90ZD4KICAgICAgICAgICAgPHRkPnt7IGl0ZW1zLiRzdW0oJ3RvdGFsJykgfCBjdXJyZW5jeSB9fTwvdGQ+CiAgICAgICAgICA8L3RyPgogICAgICAgIDwvdGFibGU+CiAgICAgICA8L2RvYzpzb3VyY2U+CiAgICAgICA8ZG9jOnNjZW5hcmlvPgogICAgICAgICBpdCgnc2hvdWxkIGNoZWNrIG5nOmZvcm1hdCcsIGZ1bmN0aW9uKCl7CiAgICAgICAgICAgZXhwZWN0KHVzaW5nKCcuZG9jLWV4YW1wbGUtbGl2ZSBkaXY6Zmlyc3QnKS5iaW5kaW5nKCJpdGVtcy4kc3VtKCd0b3RhbCcpIikpLnRvQmUoJyQ5Ljk5Jyk7CiAgICAgICAgICAgZXhwZWN0KHVzaW5nKCcuZG9jLWV4YW1wbGUtbGl2ZSBkaXY6bGFzdCcpLmJpbmRpbmcoIml0ZW1zLiRzdW0oJ3RvdGFsJykiKSkudG9CZSgnJDkuOTknKTsKICAgICAgICAgICBpbnB1dCgnaXRlbS5xdHknKS5lbnRlcignMicpOwogICAgICAgICAgIGV4cGVjdCh1c2luZygnLmRvYy1leGFtcGxlLWxpdmUgZGl2OmZpcnN0JykuYmluZGluZygiaXRlbXMuJHN1bSgndG90YWwnKSIpKS50b0JlKCckOS45OScpOwogICAgICAgICAgIGV4cGVjdCh1c2luZygnLmRvYy1leGFtcGxlLWxpdmUgZGl2Omxhc3QnKS5iaW5kaW5nKCJpdGVtcy4kc3VtKCd0b3RhbCcpIikpLnRvQmUoJyQxOS45OCcpOwogICAgICAgICB9KTsKICAgICAgIDwvZG9jOnNjZW5hcmlvPgogICAgIDwvZG9jOmV4YW1wbGU+CiAgICovCgogIHRlbXBsYXRpemU6IGZ1bmN0aW9uKGVsZW1lbnQsIGVsZW1lbnRJbmRleCwgcHJpb3JpdHkpewogICAgdmFyIHNlbGYgPSB0aGlzLAogICAgICAgIHdpZGdldCwKICAgICAgICBmbiwKICAgICAgICBkaXJlY3RpdmVGbnMgPSBzZWxmLmRpcmVjdGl2ZXMsCiAgICAgICAgZGVzY2VuZCA9IHRydWUsCiAgICAgICAgZGlyZWN0aXZlcyA9IHRydWUsCiAgICAgICAgZWxlbWVudE5hbWUgPSBub2RlTmFtZV8oZWxlbWVudCksCiAgICAgICAgZWxlbWVudE5hbWVzcGFjZSA9IGVsZW1lbnROYW1lLmluZGV4T2YoJzonKSA+IDAgPyBsb3dlcmNhc2UoZWxlbWVudE5hbWUpLnJlcGxhY2UoJzonLCAnLScpIDogJycsCiAgICAgICAgdGVtcGxhdGUsCiAgICAgICAgc2VsZkFwaSA9IHsKICAgICAgICAgIGNvbXBpbGU6IGJpbmQoc2VsZiwgc2VsZi5jb21waWxlKSwKICAgICAgICAgIGRlc2NlbmQ6IGZ1bmN0aW9uKHZhbHVlKXsgaWYoaXNEZWZpbmVkKHZhbHVlKSkgZGVzY2VuZCA9IHZhbHVlOyByZXR1cm4gZGVzY2VuZDt9LAogICAgICAgICAgZGlyZWN0aXZlczogZnVuY3Rpb24odmFsdWUpeyBpZihpc0RlZmluZWQodmFsdWUpKSBkaXJlY3RpdmVzID0gdmFsdWU7IHJldHVybiBkaXJlY3RpdmVzO30sCiAgICAgICAgICBzY29wZTogZnVuY3Rpb24odmFsdWUpeyBpZihpc0RlZmluZWQodmFsdWUpKSB0ZW1wbGF0ZS5uZXdTY29wZSA9IHRlbXBsYXRlLm5ld1Njb3BlIHx8IHZhbHVlOyByZXR1cm4gdGVtcGxhdGUubmV3U2NvcGU7fQogICAgICAgIH07CiAgICB0cnkgewogICAgICBwcmlvcml0eSA9IGVsZW1lbnQuYXR0cignbmc6ZXZhbC1vcmRlcicpIHx8IHByaW9yaXR5IHx8IDA7CiAgICB9IGNhdGNoIChlKSB7CiAgICAgIC8vIGZvciBzb21lIHJlYXNvbiBJRSB0aHJvd3MgZXJyb3IgdW5kZXIgc29tZSB3ZWlyZCBjaXJjdW1zdGFuY2VzLiBzbyBqdXN0IGFzc3VtZSBub3RoaW5nCiAgICAgIHByaW9yaXR5ID0gcHJpb3JpdHkgfHwgMDsKICAgIH0KICAgIGVsZW1lbnQuYWRkQ2xhc3MoZWxlbWVudE5hbWVzcGFjZSk7CiAgICBpZiAoaXNTdHJpbmcocHJpb3JpdHkpKSB7CiAgICAgIHByaW9yaXR5ID0gUFJJT1JJVFlbdXBwZXJjYXNlKHByaW9yaXR5KV0gfHwgcGFyc2VJbnQocHJpb3JpdHksIDEwKTsKICAgIH0KICAgIHRlbXBsYXRlID0gbmV3IFRlbXBsYXRlKHByaW9yaXR5KTsKICAgIGVhY2hBdHRyaWJ1dGUoZWxlbWVudCwgZnVuY3Rpb24odmFsdWUsIG5hbWUpewogICAgICBpZiAoIXdpZGdldCkgewogICAgICAgIGlmICh3aWRnZXQgPSBzZWxmLndpZGdldHMoJ0AnICsgbmFtZSkpIHsKICAgICAgICAgIGVsZW1lbnQuYWRkQ2xhc3MoJ25nLWF0dHItd2lkZ2V0Jyk7CiAgICAgICAgICB3aWRnZXQgPSBiaW5kKHNlbGZBcGksIHdpZGdldCwgdmFsdWUsIGVsZW1lbnQpOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgICBpZiAoIXdpZGdldCkgewogICAgICBpZiAod2lkZ2V0ID0gc2VsZi53aWRnZXRzKGVsZW1lbnROYW1lKSkgewogICAgICAgIGlmIChlbGVtZW50TmFtZXNwYWNlKQogICAgICAgICAgZWxlbWVudC5hZGRDbGFzcygnbmctd2lkZ2V0Jyk7CiAgICAgICAgd2lkZ2V0ID0gYmluZChzZWxmQXBpLCB3aWRnZXQsIGVsZW1lbnQpOwogICAgICB9CiAgICB9CiAgICBpZiAod2lkZ2V0KSB7CiAgICAgIGRlc2NlbmQgPSBmYWxzZTsKICAgICAgZGlyZWN0aXZlcyA9IGZhbHNlOwogICAgICB2YXIgcGFyZW50ID0gZWxlbWVudC5wYXJlbnQoKTsKICAgICAgdGVtcGxhdGUuYWRkSW5pdCh3aWRnZXQuY2FsbChzZWxmQXBpLCBlbGVtZW50KSk7CiAgICAgIGlmIChwYXJlbnQgJiYgcGFyZW50WzBdKSB7CiAgICAgICAgZWxlbWVudCA9IGpxTGl0ZShwYXJlbnRbMF0uY2hpbGROb2Rlc1tlbGVtZW50SW5kZXhdKTsKICAgICAgfQogICAgfQogICAgaWYgKGRlc2NlbmQpewogICAgICAvLyBwcm9jZXNzIG1hcmt1cCBmb3IgdGV4dCBub2RlcyBvbmx5CiAgICAgIGZvcih2YXIgaT0wLCBjaGlsZD1lbGVtZW50WzBdLmNoaWxkTm9kZXM7CiAgICAgICAgICBpPGNoaWxkLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgaWYgKGlzVGV4dE5vZGUoY2hpbGRbaV0pKSB7CiAgICAgICAgICBmb3JFYWNoKHNlbGYubWFya3VwLCBmdW5jdGlvbihtYXJrdXApewogICAgICAgICAgICBpZiAoaTxjaGlsZC5sZW5ndGgpIHsKICAgICAgICAgICAgICB2YXIgdGV4dE5vZGUgPSBqcUxpdGUoY2hpbGRbaV0pOwogICAgICAgICAgICAgIG1hcmt1cC5jYWxsKHNlbGZBcGksIHRleHROb2RlLnRleHQoKSwgdGV4dE5vZGUsIGVsZW1lbnQpOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICBpZiAoZGlyZWN0aXZlcykgewogICAgICAvLyBQcm9jZXNzIGF0dHJpYnV0ZXMvZGlyZWN0aXZlcwogICAgICBlYWNoQXR0cmlidXRlKGVsZW1lbnQsIGZ1bmN0aW9uKHZhbHVlLCBuYW1lKXsKICAgICAgICBmb3JFYWNoKHNlbGYuYXR0ck1hcmt1cCwgZnVuY3Rpb24obWFya3VwKXsKICAgICAgICAgIG1hcmt1cC5jYWxsKHNlbGZBcGksIHZhbHVlLCBuYW1lLCBlbGVtZW50KTsKICAgICAgICB9KTsKICAgICAgfSk7CiAgICAgIGVhY2hBdHRyaWJ1dGUoZWxlbWVudCwgZnVuY3Rpb24odmFsdWUsIG5hbWUpewogICAgICAgIGZuID0gZGlyZWN0aXZlRm5zW25hbWVdOwogICAgICAgIGlmIChmbikgewogICAgICAgICAgZWxlbWVudC5hZGRDbGFzcygnbmctZGlyZWN0aXZlJyk7CiAgICAgICAgICB0ZW1wbGF0ZS5hZGRJbml0KChkaXJlY3RpdmVGbnNbbmFtZV0pLmNhbGwoc2VsZkFwaSwgdmFsdWUsIGVsZW1lbnQpKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQogICAgLy8gUHJvY2VzcyBub24gdGV4dCBjaGlsZCBub2RlcwogICAgaWYgKGRlc2NlbmQpIHsKICAgICAgZWFjaE5vZGUoZWxlbWVudCwgZnVuY3Rpb24oY2hpbGQsIGkpewogICAgICAgIHRlbXBsYXRlLmFkZENoaWxkKGksIHNlbGYudGVtcGxhdGl6ZShjaGlsZCwgaSwgcHJpb3JpdHkpKTsKICAgICAgfSk7CiAgICB9CiAgICByZXR1cm4gdGVtcGxhdGUuZW1wdHkoKSA/IG51bGwgOiB0ZW1wbGF0ZTsKICB9Cn07CgpmdW5jdGlvbiBlYWNoTm9kZShlbGVtZW50LCBmbil7CiAgdmFyIGksIGNobGROb2RlcyA9IGVsZW1lbnRbMF0uY2hpbGROb2RlcyB8fCBbXSwgY2hsZDsKICBmb3IgKGkgPSAwOyBpIDwgY2hsZE5vZGVzLmxlbmd0aDsgaSsrKSB7CiAgICBpZighaXNUZXh0Tm9kZShjaGxkID0gY2hsZE5vZGVzW2ldKSkgewogICAgICBmbihqcUxpdGUoY2hsZCksIGkpOwogICAgfQogIH0KfQoKZnVuY3Rpb24gZWFjaEF0dHJpYnV0ZShlbGVtZW50LCBmbil7CiAgdmFyIGksIGF0dHJzID0gZWxlbWVudFswXS5hdHRyaWJ1dGVzIHx8IFtdLCBjaGxkLCBhdHRyLCBuYW1lLCB2YWx1ZSwgYXR0clZhbHVlID0ge307CiAgZm9yIChpID0gMDsgaSA8IGF0dHJzLmxlbmd0aDsgaSsrKSB7CiAgICBhdHRyID0gYXR0cnNbaV07CiAgICBuYW1lID0gYXR0ci5uYW1lOwogICAgdmFsdWUgPSBhdHRyLnZhbHVlOwogICAgaWYgKG1zaWUgJiYgbmFtZSA9PSAnaHJlZicpIHsKICAgICAgdmFsdWUgPSBkZWNvZGVVUklDb21wb25lbnQoZWxlbWVudFswXS5nZXRBdHRyaWJ1dGUobmFtZSwgMikpOwogICAgfQogICAgYXR0clZhbHVlW25hbWVdID0gdmFsdWU7CiAgfQogIGZvckVhY2hTb3J0ZWQoYXR0clZhbHVlLCBmbik7Cn0KCid1c2Ugc3RyaWN0JzsKCmZ1bmN0aW9uIGdldHRlcihpbnN0YW5jZSwgcGF0aCwgdW5ib3VuZEZuKSB7CiAgaWYgKCFwYXRoKSByZXR1cm4gaW5zdGFuY2U7CiAgdmFyIGVsZW1lbnQgPSBwYXRoLnNwbGl0KCcuJyk7CiAgdmFyIGtleTsKICB2YXIgbGFzdEluc3RhbmNlID0gaW5zdGFuY2U7CiAgdmFyIGxlbiA9IGVsZW1lbnQubGVuZ3RoOwogIGZvciAoIHZhciBpID0gMDsgaSA8IGxlbjsgaSsrKSB7CiAgICBrZXkgPSBlbGVtZW50W2ldOwogICAgaWYgKCFrZXkubWF0Y2goL15bXCRcd11bXCRcd1xkXSokLykpCiAgICAgICAgdGhyb3cgIkV4cHJlc3Npb24gJyIgKyBwYXRoICsgIicgaXMgbm90IGEgdmFsaWQgZXhwcmVzc2lvbiBmb3IgYWNjZXNzaW5nIHZhcmlhYmxlcy4iOwogICAgaWYgKGluc3RhbmNlKSB7CiAgICAgIGxhc3RJbnN0YW5jZSA9IGluc3RhbmNlOwogICAgICBpbnN0YW5jZSA9IGluc3RhbmNlW2tleV07CiAgICB9CiAgICBpZiAoaXNVbmRlZmluZWQoaW5zdGFuY2UpICAmJiBrZXkuY2hhckF0KDApID09ICckJykgewogICAgICB2YXIgdHlwZSA9IGFuZ3VsYXJbJ0dsb2JhbCddWyd0eXBlT2YnXShsYXN0SW5zdGFuY2UpOwogICAgICB0eXBlID0gYW5ndWxhclt0eXBlLmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpK3R5cGUuc3Vic3RyaW5nKDEpXTsKICAgICAgdmFyIGZuID0gdHlwZSA/IHR5cGVbW2tleS5zdWJzdHJpbmcoMSldXSA6IHVuZGVmaW5lZDsKICAgICAgaWYgKGZuKSB7CiAgICAgICAgaW5zdGFuY2UgPSBiaW5kKGxhc3RJbnN0YW5jZSwgZm4sIGxhc3RJbnN0YW5jZSk7CiAgICAgICAgcmV0dXJuIGluc3RhbmNlOwogICAgICB9CiAgICB9CiAgfQogIGlmICghdW5ib3VuZEZuICYmIGlzRnVuY3Rpb24oaW5zdGFuY2UpKSB7CiAgICByZXR1cm4gYmluZChsYXN0SW5zdGFuY2UsIGluc3RhbmNlKTsKICB9CiAgcmV0dXJuIGluc3RhbmNlOwp9CgpmdW5jdGlvbiBzZXR0ZXIoaW5zdGFuY2UsIHBhdGgsIHZhbHVlKXsKICB2YXIgZWxlbWVudCA9IHBhdGguc3BsaXQoJy4nKTsKICBmb3IgKCB2YXIgaSA9IDA7IGVsZW1lbnQubGVuZ3RoID4gMTsgaSsrKSB7CiAgICB2YXIga2V5ID0gZWxlbWVudC5zaGlmdCgpOwogICAgdmFyIG5ld0luc3RhbmNlID0gaW5zdGFuY2Vba2V5XTsKICAgIGlmICghbmV3SW5zdGFuY2UpIHsKICAgICAgbmV3SW5zdGFuY2UgPSB7fTsKICAgICAgaW5zdGFuY2Vba2V5XSA9IG5ld0luc3RhbmNlOwogICAgfQogICAgaW5zdGFuY2UgPSBuZXdJbnN0YW5jZTsKICB9CiAgaW5zdGFuY2VbZWxlbWVudC5zaGlmdCgpXSA9IHZhbHVlOwogIHJldHVybiB2YWx1ZTsKfQoKLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KdmFyIHNjb3BlSWQgPSAwLAogICAgZ2V0dGVyRm5DYWNoZSA9IHt9LAogICAgY29tcGlsZUNhY2hlID0ge30sCiAgICBKU19LRVlXT1JEUyA9IHt9Owpmb3JFYWNoKAogICAgKCJhYnN0cmFjdCxib29sZWFuLGJyZWFrLGJ5dGUsY2FzZSxjYXRjaCxjaGFyLGNsYXNzLGNvbnN0LGNvbnRpbnVlLGRlYnVnZ2VyLGRlZmF1bHQsIiArCiAgICAiZGVsZXRlLGRvLGRvdWJsZSxlbHNlLGVudW0sZXhwb3J0LGV4dGVuZHMsZmFsc2UsZmluYWwsZmluYWxseSxmbG9hdCxmb3IsZnVuY3Rpb24sZ290bywiICsKICAgICJpZixpbXBsZW1lbnRzLGltcG9ydCxpbmluc3RhbmNlb2YsaW50aW50ZXJmYWNlLGxvbmcsbmF0aXZlLG5ldyxudWxsLHBhY2thZ2UscHJpdmF0ZSwiICsKICAgICJwcm90ZWN0ZWQscHVibGljLHJldHVybixzaG9ydCxzdGF0aWMsc3VwZXIsc3dpdGNoLHN5bmNocm9uaXplZCx0aGlzLHRocm93LHRocm93cywiICsKICAgICJ0cmFuc2llbnQsdHJ1ZSx0cnksdHlwZW9mLHZhcix2b2xhdGlsZSx2b2lkLHVuZGVmaW5lZCx3aGlsZSx3aXRoIikuc3BsaXQoLywvKSwKICBmdW5jdGlvbihrZXkpeyBKU19LRVlXT1JEU1trZXldID0gdHJ1ZTt9Cik7CmZ1bmN0aW9uIGdldHRlckZuKHBhdGgpewogIHZhciBmbiA9IGdldHRlckZuQ2FjaGVbcGF0aF07CiAgaWYgKGZuKSByZXR1cm4gZm47CgogIHZhciBjb2RlID0gJ3ZhciBsLCBmbiwgdDtcbic7CiAgZm9yRWFjaChwYXRoLnNwbGl0KCcuJyksIGZ1bmN0aW9uKGtleSkgewogICAga2V5ID0gKEpTX0tFWVdPUkRTW2tleV0pID8gJ1siJyArIGtleSArICciXScgOiAnLicgKyBrZXk7CiAgICBjb2RlICs9ICdpZighcykgcmV0dXJuIHM7XG4nICsKICAgICAgICAgICAgJ2w9cztcbicgKwogICAgICAgICAgICAncz1zJyArIGtleSArICc7XG4nICsKICAgICAgICAgICAgJ2lmKHR5cGVvZiBzPT0iZnVuY3Rpb24iICYmICEocyBpbnN0YW5jZW9mIFJlZ0V4cCkpIHMgPSBmdW5jdGlvbigpeyByZXR1cm4gbCcra2V5KycuYXBwbHkobCwgYXJndW1lbnRzKTsgfTtcbic7CiAgICBpZiAoa2V5LmNoYXJBdCgxKSA9PSAnJCcpIHsKICAgICAgLy8gc3BlY2lhbCBjb2RlIGZvciBzdXBlci1pbXBvc2VkIGZ1bmN0aW9ucwogICAgICB2YXIgbmFtZSA9IGtleS5zdWJzdHIoMik7CiAgICAgIGNvZGUgKz0gJ2lmKCFzKSB7XG4nICsKICAgICAgICAgICAgICAnICB0ID0gYW5ndWxhci5HbG9iYWwudHlwZU9mKGwpO1xuJyArCiAgICAgICAgICAgICAgJyAgZm4gPSAoYW5ndWxhclt0LmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpICsgdC5zdWJzdHJpbmcoMSldfHx7fSlbIicgKyBuYW1lICsgJyJdO1xuJyArCiAgICAgICAgICAgICAgJyAgaWYgKGZuKSBzID0gZnVuY3Rpb24oKXsgcmV0dXJuIGZuLmFwcGx5KGwsIFtsXS5jb25jYXQoQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAwLCBhcmd1bWVudHMubGVuZ3RoKSkpOyB9O1xuJyArCiAgICAgICAgICAgICAgJ31cbic7CiAgICB9CiAgfSk7CiAgY29kZSArPSAncmV0dXJuIHM7JzsKICBmbiA9IEZ1bmN0aW9uKCdzJywgY29kZSk7CiAgZm5bInRvU3RyaW5nIl0gPSBmdW5jdGlvbigpeyByZXR1cm4gY29kZTsgfTsKCiAgcmV0dXJuIGdldHRlckZuQ2FjaGVbcGF0aF0gPSBmbjsKfQoKLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KCmZ1bmN0aW9uIGV4cHJlc3Npb25Db21waWxlKGV4cCl7CiAgaWYgKHR5cGVvZiBleHAgPT09ICRmdW5jdGlvbikgcmV0dXJuIGV4cDsKICB2YXIgZm4gPSBjb21waWxlQ2FjaGVbZXhwXTsKICBpZiAoIWZuKSB7CiAgICB2YXIgcCA9IHBhcnNlcihleHApOwogICAgdmFyIGZuU2VsZiA9IHAuc3RhdGVtZW50cygpOwogICAgZm4gPSBjb21waWxlQ2FjaGVbZXhwXSA9IGV4dGVuZCgKICAgICAgZnVuY3Rpb24oKXsgcmV0dXJuIGZuU2VsZih0aGlzKTt9LAogICAgICB7Zm5TZWxmOiBmblNlbGZ9KTsKICB9CiAgcmV0dXJuIGZuOwp9CgpmdW5jdGlvbiBlcnJvckhhbmRsZXJGb3IoZWxlbWVudCwgZXJyb3IpIHsKICBlbGVtZW50RXJyb3IoZWxlbWVudCwgTkdfRVhDRVBUSU9OLCBpc0RlZmluZWQoZXJyb3IpID8gZm9ybWF0RXJyb3IoZXJyb3IpIDogZXJyb3IpOwp9CgoKLyoqCiAqIEB3b3JrSW5Qcm9ncmVzcwogKiBAbmdkb2Mgb3ZlcnZpZXcKICogQG5hbWUgYW5ndWxhci5zY29wZQogKgogKiBAZGVzY3JpcHRpb24KICogU2NvcGUgaXMgYSBKYXZhU2NyaXB0IG9iamVjdCBhbmQgdGhlIGV4ZWN1dGlvbiBjb250ZXh0IGZvciBleHByZXNzaW9ucy4gWW91IGNhbiB0aGluayBhYm91dAogKiBzY29wZXMgYXMgSmF2YVNjcmlwdCBvYmplY3RzIHRoYXQgaGF2ZSBleHRyYSBBUElzIGZvciByZWdpc3RlcmluZyB3YXRjaGVycy4gQSBzY29wZSBpcyB0aGUKICogY29udGV4dCBpbiB3aGljaCBtb2RlbCAoZnJvbSB0aGUgbW9kZWwtdmlldy1jb250cm9sbGVyIGRlc2lnbiBwYXR0ZXJuKSBleGlzdHMuCiAqCiAqIEFuZ3VsYXIgc2NvcGUgb2JqZWN0cyBwcm92aWRlIHRoZSBmb2xsb3dpbmcgbWV0aG9kczoKICoKICogKiB7QGxpbmsgYW5ndWxhci5zY29wZS4kYmVjb21lICRiZWNvbWUoKX0gLQogKiAqIHtAbGluayBhbmd1bGFyLnNjb3BlLiRiaW5kICRiaW5kKCl9IC0KICogKiB7QGxpbmsgYW5ndWxhci5zY29wZS4kZXZhbCAkZXZhbCgpfSAtCiAqICoge0BsaW5rIGFuZ3VsYXIuc2NvcGUuJGdldCAkZ2V0KCl9IC0KICogKiB7QGxpbmsgYW5ndWxhci5zY29wZS4kbmV3ICRuZXcoKX0gLQogKiAqIHtAbGluayBhbmd1bGFyLnNjb3BlLiRvbkV2YWwgJG9uRXZhbCgpfSAtCiAqICoge0BsaW5rIGFuZ3VsYXIuc2NvcGUuJHNlcnZpY2UgJHNlcnZpY2UoKX0gLQogKiAqIHtAbGluayBhbmd1bGFyLnNjb3BlLiRzZXQgJHNldCgpfSAtCiAqICoge0BsaW5rIGFuZ3VsYXIuc2NvcGUuJHRyeUV2YWwgJHRyeUV2YWwoKX0gLQogKiAqIHtAbGluayBhbmd1bGFyLnNjb3BlLiR3YXRjaCAkd2F0Y2goKX0gLQogKgogKiBGb3IgbW9yZSBpbmZvcm1hdGlvbiBhYm91dCBob3cgYW5ndWxhciBzY29wZSBvYmplY3RzIHdvcmssIHNlZSB7QGxpbmsgZ3VpZGUvZGV2X2d1aWRlLnNjb3BlcwogKiBBbmd1bGFyIFNjb3BlIE9iamVjdHN9IGluIHRoZSBhbmd1bGFyIERldmVsb3BlciBHdWlkZS4KICovCmZ1bmN0aW9uIGNyZWF0ZVNjb3BlKHBhcmVudCwgcHJvdmlkZXJzLCBpbnN0YW5jZUNhY2hlKSB7CiAgZnVuY3Rpb24gUGFyZW50KCl7fQogIHBhcmVudCA9IFBhcmVudC5wcm90b3R5cGUgPSAocGFyZW50IHx8IHt9KTsKICB2YXIgaW5zdGFuY2UgPSBuZXcgUGFyZW50KCk7CiAgdmFyIGV2YWxMaXN0cyA9IHtzb3J0ZWQ6W119OwogIHZhciAkbG9nLCAkZXhjZXB0aW9uSGFuZGxlcjsKCiAgZXh0ZW5kKGluc3RhbmNlLCB7CiAgICAndGhpcyc6IGluc3RhbmNlLAogICAgJGlkOiAoc2NvcGVJZCsrKSwKICAgICRwYXJlbnQ6IHBhcmVudCwKCiAgICAvKioKICAgICAqIEB3b3JrSW5Qcm9ncmVzcwogICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgKiBAbmFtZSBhbmd1bGFyLnNjb3BlLiRiaW5kCiAgICAgKiBAZnVuY3Rpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIEJpbmRzIGEgZnVuY3Rpb24gYGZuYCB0byB0aGUgY3VycmVudCBzY29wZS4gU2VlOiB7QGxpbmsgYW5ndWxhci5iaW5kfS4KCiAgICAgICA8cHJlPgogICAgICAgICB2YXIgc2NvcGUgPSBhbmd1bGFyLnNjb3BlKCk7CiAgICAgICAgIHZhciBmbiA9IHNjb3BlLiRiaW5kKGZ1bmN0aW9uKCl7CiAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgIH0pOwogICAgICAgICBleHBlY3QoZm4oKSkudG9FcXVhbChzY29wZSk7CiAgICAgICA8L3ByZT4KICAgICAqCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKCl9IGZuIEZ1bmN0aW9uIHRvIGJlIGJvdW5kLgogICAgICovCiAgICAkYmluZDogYmluZChpbnN0YW5jZSwgYmluZCwgaW5zdGFuY2UpLAoKCiAgICAvKioKICAgICAqIEB3b3JrSW5Qcm9ncmVzcwogICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgKiBAbmFtZSBhbmd1bGFyLnNjb3BlLiRnZXQKICAgICAqIEBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogUmV0dXJucyB0aGUgdmFsdWUgZm9yIGBwcm9wZXJ0eV9jaGFpbmAgb24gdGhlIGN1cnJlbnQgc2NvcGUuIFVubGlrZSBpbiBKYXZhU2NyaXB0LCBpZiB0aGVyZQogICAgICogYXJlIGFueSBgdW5kZWZpbmVkYCBpbnRlcm1lZGlhcnkgcHJvcGVydGllcywgYHVuZGVmaW5lZGAgaXMgcmV0dXJuZWQgaW5zdGVhZCBvZiB0aHJvd2luZyBhbgogICAgICogZXhjZXB0aW9uLgogICAgICoKICAgICAgIDxwcmU+CiAgICAgICAgIHZhciBzY29wZSA9IGFuZ3VsYXIuc2NvcGUoKTsKICAgICAgICAgZXhwZWN0KHNjb3BlLiRnZXQoJ3BlcnNvbi5uYW1lJykpLnRvRXF1YWwodW5kZWZpbmVkKTsKICAgICAgICAgc2NvcGUucGVyc29uID0ge307CiAgICAgICAgIGV4cGVjdChzY29wZS4kZ2V0KCdwZXJzb24ubmFtZScpKS50b0VxdWFsKHVuZGVmaW5lZCk7CiAgICAgICAgIHNjb3BlLnBlcnNvbi5uYW1lID0gJ21pc2tvJzsKICAgICAgICAgZXhwZWN0KHNjb3BlLiRnZXQoJ3BlcnNvbi5uYW1lJykpLnRvRXF1YWwoJ21pc2tvJyk7CiAgICAgICA8L3ByZT4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gcHJvcGVydHlfY2hhaW4gU3RyaW5nIHJlcHJlc2VudGluZyBuYW1lIG9mIGEgc2NvcGUgcHJvcGVydHkuIE9wdGlvbmFsbHkKICAgICAqICAgICBwcm9wZXJ0aWVzIGNhbiBiZSBjaGFpbmVkIHdpdGggYC5gIChkb3QpLCBlLmcuIGAncGVyc29uLm5hbWUuZmlyc3QnYAogICAgICogQHJldHVybnMgeyp9IFZhbHVlIGZvciB0aGUgKG5lc3RlZCkgcHJvcGVydHkuCiAgICAgKi8KICAgICRnZXQ6IGJpbmQoaW5zdGFuY2UsIGdldHRlciwgaW5zdGFuY2UpLAoKCiAgICAvKioKICAgICAqIEB3b3JrSW5Qcm9ncmVzcwogICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgKiBAbmFtZSBhbmd1bGFyLnNjb3BlLiRzZXQKICAgICAqIEBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogQXNzaWducyBhIHZhbHVlIHRvIGEgcHJvcGVydHkgb2YgdGhlIGN1cnJlbnQgc2NvcGUgc3BlY2lmaWVkIHZpYSBgcHJvcGVydHlfY2hhaW5gLiBVbmxpa2UgaW4KICAgICAqIEphdmFTY3JpcHQsIGlmIHRoZXJlIGFyZSBhbnkgYHVuZGVmaW5lZGAgaW50ZXJtZWRpYXJ5IHByb3BlcnRpZXMsIGVtcHR5IG9iamVjdHMgYXJlIGNyZWF0ZWQKICAgICAqIGFuZCBhc3NpZ25lZCB0byB0aGVtIGluc3RlYWQgb2YgdGhyb3dpbmcgYW4gZXhjZXB0aW9uLgogICAgICoKICAgICAgIDxwcmU+CiAgICAgICAgIHZhciBzY29wZSA9IGFuZ3VsYXIuc2NvcGUoKTsKICAgICAgICAgZXhwZWN0KHNjb3BlLnBlcnNvbikudG9FcXVhbCh1bmRlZmluZWQpOwogICAgICAgICBzY29wZS4kc2V0KCdwZXJzb24ubmFtZScsICdtaXNrbycpOwogICAgICAgICBleHBlY3Qoc2NvcGUucGVyc29uKS50b0VxdWFsKHtuYW1lOidtaXNrbyd9KTsKICAgICAgICAgZXhwZWN0KHNjb3BlLnBlcnNvbi5uYW1lKS50b0VxdWFsKCdtaXNrbycpOwogICAgICAgPC9wcmU+CiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IHByb3BlcnR5X2NoYWluIFN0cmluZyByZXByZXNlbnRpbmcgbmFtZSBvZiBhIHNjb3BlIHByb3BlcnR5LiBPcHRpb25hbGx5CiAgICAgKiAgICAgcHJvcGVydGllcyBjYW4gYmUgY2hhaW5lZCB3aXRoIGAuYCAoZG90KSwgZS5nLiBgJ3BlcnNvbi5uYW1lLmZpcnN0J2AKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVmFsdWUgdG8gYXNzaWduIHRvIHRoZSBzY29wZSBwcm9wZXJ0eS4KICAgICAqLwogICAgJHNldDogYmluZChpbnN0YW5jZSwgc2V0dGVyLCBpbnN0YW5jZSksCgoKICAgIC8qKgogICAgICogQHdvcmtJblByb2dyZXNzCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIGFuZ3VsYXIuc2NvcGUuJGV2YWwKICAgICAqIEBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogV2l0aG91dCB0aGUgYGV4cGAgcGFyYW1ldGVyIHRyaWdnZXJzIGFuIGV2YWwgY3ljbGUgZm9yIHRoaXMgc2NvcGUgYW5kIGl0cyBjaGlsZCBzY29wZXMuCiAgICAgKgogICAgICogV2l0aCB0aGUgYGV4cGAgcGFyYW1ldGVyLCBjb21waWxlcyB0aGUgZXhwcmVzc2lvbiB0byBhIGZ1bmN0aW9uIGFuZCBjYWxscyBpdCB3aXRoIGB0aGlzYCBzZXQKICAgICAqIHRvIHRoZSBjdXJyZW50IHNjb3BlIGFuZCByZXR1cm5zIHRoZSByZXN1bHQuIEluIG90aGVyIHdvcmRzLCBldmFsdWF0ZXMgYGV4cGAgYXMgYW5ndWxhcgogICAgICogZXhwcmVzc2lvbiBpbiB0aGUgY29udGV4dCBvZiB0aGUgY3VycmVudCBzY29wZS4KICAgICAqCiAgICAgKiAjIEV4YW1wbGUKICAgICAgIDxwcmU+CiAgICAgICAgIHZhciBzY29wZSA9IGFuZ3VsYXIuc2NvcGUoKTsKICAgICAgICAgc2NvcGUuYSA9IDE7CiAgICAgICAgIHNjb3BlLmIgPSAyOwoKICAgICAgICAgZXhwZWN0KHNjb3BlLiRldmFsKCdhK2InKSkudG9FcXVhbCgzKTsKICAgICAgICAgZXhwZWN0KHNjb3BlLiRldmFsKGZ1bmN0aW9uKCl7IHJldHVybiB0aGlzLmEgKyB0aGlzLmI7IH0pKS50b0VxdWFsKDMpOwoKICAgICAgICAgc2NvcGUuJG9uRXZhbCgnc3VtID0gYStiJyk7CiAgICAgICAgIGV4cGVjdChzY29wZS5zdW0pLnRvRXF1YWwodW5kZWZpbmVkKTsKICAgICAgICAgc2NvcGUuJGV2YWwoKTsKICAgICAgICAgZXhwZWN0KHNjb3BlLnN1bSkudG9FcXVhbCgzKTsKICAgICAgIDwvcHJlPgogICAgICoKICAgICAqIEBwYXJhbSB7KHN0cmluZ3xmdW5jdGlvbigpKT19IGV4cCBBbiBhbmd1bGFyIGV4cHJlc3Npb24gdG8gYmUgY29tcGlsZWQgdG8gYSBmdW5jdGlvbiBvciBhIGpzCiAgICAgKiAgICAgZnVuY3Rpb24uCiAgICAgKgogICAgICogQHJldHVybnMgeyp9IFRoZSByZXN1bHQgb2YgY2FsbGluZyBjb21waWxlZCBgZXhwYCB3aXRoIGB0aGlzYCBzZXQgdG8gdGhlIGN1cnJlbnQgc2NvcGUuCiAgICAgKi8KICAgICRldmFsOiBmdW5jdGlvbihleHApIHsKICAgICAgdmFyIHR5cGUgPSB0eXBlb2YgZXhwOwogICAgICB2YXIgaSwgaVNpemU7CiAgICAgIHZhciBqLCBqU2l6ZTsKICAgICAgdmFyIHF1ZXVlOwogICAgICB2YXIgZm47CiAgICAgIGlmICh0eXBlID09ICR1bmRlZmluZWQpIHsKICAgICAgICBmb3IgKCBpID0gMCwgaVNpemUgPSBldmFsTGlzdHMuc29ydGVkLmxlbmd0aDsgaSA8IGlTaXplOyBpKyspIHsKICAgICAgICAgIGZvciAoIHF1ZXVlID0gZXZhbExpc3RzLnNvcnRlZFtpXSwKICAgICAgICAgICAgICBqU2l6ZSA9IHF1ZXVlLmxlbmd0aCwKICAgICAgICAgICAgICBqPSAwOyBqIDwgalNpemU7IGorKykgewogICAgICAgICAgICBpbnN0YW5jZS4kdHJ5RXZhbChxdWV1ZVtqXS5mbiwgcXVldWVbal0uaGFuZGxlcik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICRmdW5jdGlvbikgewogICAgICAgIHJldHVybiBleHAuY2FsbChpbnN0YW5jZSk7CiAgICAgIH0gZWxzZSAgaWYgKHR5cGUgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgcmV0dXJuIGV4cHJlc3Npb25Db21waWxlKGV4cCkuY2FsbChpbnN0YW5jZSk7CiAgICAgIH0KICAgIH0sCgoKICAgIC8qKgogICAgICogQHdvcmtJblByb2dyZXNzCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIGFuZ3VsYXIuc2NvcGUuJHRyeUV2YWwKICAgICAqIEBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogRXZhbHVhdGVzIHRoZSBleHByZXNzaW9uIGluIHRoZSBjb250ZXh0IG9mIHRoZSBjdXJyZW50IHNjb3BlIGp1c3QgbGlrZQogICAgICoge0BsaW5rIGFuZ3VsYXIuc2NvcGUuJGV2YWx9IHdpdGggZXhwcmVzc2lvbiBwYXJhbWV0ZXIsIGJ1dCBhbHNvIHdyYXBzIGl0IGluIGEgdHJ5L2NhdGNoCiAgICAgKiBibG9jay4KICAgICAqCiAgICAgKiBJZiBhbiBleGNlcHRpb24gaXMgdGhyb3duIHRoZW4gYGV4Y2VwdGlvbkhhbmRsZXJgIGlzIHVzZWQgdG8gaGFuZGxlIHRoZSBleGNlcHRpb24uCiAgICAgKgogICAgICogIyBFeGFtcGxlCiAgICAgICA8cHJlPgogICAgICAgICB2YXIgc2NvcGUgPSBhbmd1bGFyLnNjb3BlKCk7CiAgICAgICAgIHNjb3BlLmVycm9yID0gZnVuY3Rpb24oKXsgdGhyb3cgJ215ZXJyb3InOyB9OwogICAgICAgICBzY29wZS4kZXhjZXB0aW9uSGFuZGxlciA9IGZ1bmN0aW9uKGUpIHt0aGlzLmxhc3RFeGNlcHRpb24gPSBlOyB9OwoKICAgICAgICAgZXhwZWN0KHNjb3BlLiRldmFsKCdlcnJvcigpJykpOwogICAgICAgICBleHBlY3Qoc2NvcGUubGFzdEV4Y2VwdGlvbikudG9FcXVhbCgnbXllcnJvcicpOwogICAgICAgICB0aGlzLmxhc3RFeGNlcHRpb24gPSBudWxsOwoKICAgICAgICAgZXhwZWN0KHNjb3BlLiRldmFsKCdlcnJvcigpJyksICBmdW5jdGlvbihlKSB7dGhpcy5sYXN0RXhjZXB0aW9uID0gZTsgfSk7CiAgICAgICAgIGV4cGVjdChzY29wZS5sYXN0RXhjZXB0aW9uKS50b0VxdWFsKCdteWVycm9yJyk7CgogICAgICAgICB2YXIgYm9keSA9IGFuZ3VsYXIuZWxlbWVudCh3aW5kb3cuZG9jdW1lbnQuYm9keSk7CiAgICAgICAgIGV4cGVjdChzY29wZS4kZXZhbCgnZXJyb3IoKScpLCBib2R5KTsKICAgICAgICAgZXhwZWN0KGJvZHkuYXR0cignbmctZXhjZXB0aW9uJykpLnRvRXF1YWwoJyJteWVycm9yIicpOwogICAgICAgICBleHBlY3QoYm9keS5oYXNDbGFzcygnbmctZXhjZXB0aW9uJykpLnRvRXF1YWwodHJ1ZSk7CiAgICAgICA8L3ByZT4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ3xmdW5jdGlvbigpfSBleHByZXNzaW9uIEFuZ3VsYXIgZXhwcmVzc2lvbiB0byBldmFsdWF0ZS4KICAgICAqIEBwYXJhbSB7KGZ1bmN0aW9uKCl8RE9NRWxlbWVudCk9fSBleGNlcHRpb25IYW5kbGVyIEZ1bmN0aW9uIHRvIGJlIGNhbGxlZCBvciBET01FbGVtZW50IHRvIGJlCiAgICAgKiAgICAgZGVjb3JhdGVkLgogICAgICogQHJldHVybnMgeyp9IFRoZSByZXN1bHQgb2YgYGV4cHJlc3Npb25gIGV2YWx1YXRpb24uCiAgICAgKi8KICAgICR0cnlFdmFsOiBmdW5jdGlvbiAoZXhwcmVzc2lvbiwgZXhjZXB0aW9uSGFuZGxlcikgewogICAgICB2YXIgdHlwZSA9IHR5cGVvZiBleHByZXNzaW9uOwogICAgICB0cnkgewogICAgICAgIGlmICh0eXBlID09ICRmdW5jdGlvbikgewogICAgICAgICAgcmV0dXJuIGV4cHJlc3Npb24uY2FsbChpbnN0YW5jZSk7CiAgICAgICAgfSBlbHNlIGlmICh0eXBlID09ICdzdHJpbmcnKXsKICAgICAgICAgIHJldHVybiBleHByZXNzaW9uQ29tcGlsZShleHByZXNzaW9uKS5jYWxsKGluc3RhbmNlKTsKICAgICAgICB9CiAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICBpZiAoJGxvZykgJGxvZy5lcnJvcihlKTsKICAgICAgICBpZiAoaXNGdW5jdGlvbihleGNlcHRpb25IYW5kbGVyKSkgewogICAgICAgICAgZXhjZXB0aW9uSGFuZGxlcihlKTsKICAgICAgICB9IGVsc2UgaWYgKGV4Y2VwdGlvbkhhbmRsZXIpIHsKICAgICAgICAgIGVycm9ySGFuZGxlckZvcihleGNlcHRpb25IYW5kbGVyLCBlKTsKICAgICAgICB9IGVsc2UgaWYgKGlzRnVuY3Rpb24oJGV4Y2VwdGlvbkhhbmRsZXIpKSB7CiAgICAgICAgICAkZXhjZXB0aW9uSGFuZGxlcihlKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCgoKICAgIC8qKgogICAgICogQHdvcmtJblByb2dyZXNzCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIGFuZ3VsYXIuc2NvcGUuJHdhdGNoCiAgICAgKiBAZnVuY3Rpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFJlZ2lzdGVycyBgbGlzdGVuZXJgIGFzIGEgY2FsbGJhY2sgdG8gYmUgZXhlY3V0ZWQgZXZlcnkgdGltZSB0aGUgYHdhdGNoRXhwYCBjaGFuZ2VzLiBCZSBhd2FyZQogICAgICogdGhhdCB0aGUgY2FsbGJhY2sgZ2V0cywgYnkgZGVmYXVsdCwgY2FsbGVkIHVwb24gcmVnaXN0cmF0aW9uLCB0aGlzIGNhbiBiZSBwcmV2ZW50ZWQgdmlhIHRoZQogICAgICogYGluaXRSdW5gIHBhcmFtZXRlci4KICAgICAqCiAgICAgKiAjIEV4YW1wbGUKICAgICAgIDxwcmU+CiAgICAgICAgIHZhciBzY29wZSA9IGFuZ3VsYXIuc2NvcGUoKTsKICAgICAgICAgc2NvcGUubmFtZSA9ICdtaXNrbyc7CiAgICAgICAgIHNjb3BlLmNvdW50ZXIgPSAwOwoKICAgICAgICAgZXhwZWN0KHNjb3BlLmNvdW50ZXIpLnRvRXF1YWwoMCk7CiAgICAgICAgIHNjb3BlLiR3YXRjaCgnbmFtZScsICdjb3VudGVyID0gY291bnRlciArIDEnKTsKICAgICAgICAgZXhwZWN0KHNjb3BlLmNvdW50ZXIpLnRvRXF1YWwoMSk7CgogICAgICAgICBzY29wZS4kZXZhbCgpOwogICAgICAgICBleHBlY3Qoc2NvcGUuY291bnRlcikudG9FcXVhbCgxKTsKCiAgICAgICAgIHNjb3BlLm5hbWUgPSAnYWRhbSc7CiAgICAgICAgIHNjb3BlLiRldmFsKCk7CiAgICAgICAgIGV4cGVjdChzY29wZS5jb3VudGVyKS50b0VxdWFsKDIpOwogICAgICAgPC9wcmU+CiAgICAgKgogICAgICogQHBhcmFtIHtmdW5jdGlvbigpfHN0cmluZ30gd2F0Y2hFeHAgRXhwcmVzc2lvbiB0aGF0IHNob3VsZCBiZSBldmFsdWF0ZWQgYW5kIGNoZWNrZWQgZm9yCiAgICAgKiAgICBjaGFuZ2UgZHVyaW5nIGVhY2ggZXZhbCBjeWNsZS4gQ2FuIGJlIGFuIGFuZ3VsYXIgc3RyaW5nIGV4cHJlc3Npb24gb3IgYSBmdW5jdGlvbi4KICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oKXxzdHJpbmd9IGxpc3RlbmVyIEZ1bmN0aW9uIChvciBhbmd1bGFyIHN0cmluZyBleHByZXNzaW9uKSB0aGF0IGdldHMgY2FsbGVkCiAgICAgKiAgICBldmVyeSB0aW1lIHRoZSB2YWx1ZSBvZiB0aGUgYHdhdGNoRXhwYCBjaGFuZ2VzLiBUaGUgZnVuY3Rpb24gd2lsbCBiZSBjYWxsZWQgd2l0aCB0d28KICAgICAqICAgIHBhcmFtZXRlcnMsIGBuZXdWYWx1ZWAgYW5kIGBvbGRWYWx1ZWAuCiAgICAgKiBAcGFyYW0geyhmdW5jdGlvbigpfERPTUVsZW1lbnQpPX0gW2V4Y2VwdGlvbkhhbmxkZXI9YW5ndWxhci5zZXJ2aWNlLiRleGNlcHRpb25IYW5kbGVyXSBIYW5kbGVyCiAgICAgKiAgICB0aGF0IGdldHMgY2FsbGVkIHdoZW4gYHdhdGNoRXhwYCBvciBgbGlzdGVuZXJgIHRocm93cyBhbiBleGNlcHRpb24uIElmIGEgRE9NRWxlbWVudCBpcwogICAgICogICAgc3BlY2lmaWVkIGFzIGEgaGFuZGxlciwgdGhlIGVsZW1lbnQgZ2V0cyBkZWNvcmF0ZWQgYnkgYW5ndWxhciB3aXRoIHRoZSBpbmZvcm1hdGlvbiBhYm91dCB0aGUKICAgICAqICAgIGV4Y2VwdGlvbi4KICAgICAqIEBwYXJhbSB7Ym9vbGVhbj19IFtpbml0UnVuPXRydWVdIEZsYWcgdGhhdCBwcmV2ZW50cyB0aGUgZmlyc3QgZXhlY3V0aW9uIG9mIHRoZSBsaXN0ZW5lciB1cG9uCiAgICAgKiAgICByZWdpc3RyYXRpb24uCiAgICAgKgogICAgICovCiAgICAkd2F0Y2g6IGZ1bmN0aW9uKHdhdGNoRXhwLCBsaXN0ZW5lciwgZXhjZXB0aW9uSGFuZGxlciwgaW5pdFJ1bikgewogICAgICB2YXIgd2F0Y2ggPSBleHByZXNzaW9uQ29tcGlsZSh3YXRjaEV4cCksCiAgICAgICAgICBsYXN0ID0gd2F0Y2guY2FsbChpbnN0YW5jZSk7CiAgICAgIGxpc3RlbmVyID0gZXhwcmVzc2lvbkNvbXBpbGUobGlzdGVuZXIpOwogICAgICBmdW5jdGlvbiB3YXRjaGVyKGZpcnN0UnVuKXsKICAgICAgICB2YXIgdmFsdWUgPSB3YXRjaC5jYWxsKGluc3RhbmNlKSwKICAgICAgICAgICAgLy8gd2UgaGF2ZSB0byBzYXZlIHRoZSB2YWx1ZSBiZWNhdXNlIGxpc3RlbmVyIGNhbiBjYWxsIG91cnNlbHZlcyA9PiBpbmYgbG9vcAogICAgICAgICAgICBsYXN0VmFsdWUgPSBsYXN0OwogICAgICAgIGlmIChmaXJzdFJ1biB8fCBsYXN0VmFsdWUgIT09IHZhbHVlKSB7CiAgICAgICAgICBsYXN0ID0gdmFsdWU7CiAgICAgICAgICBpbnN0YW5jZS4kdHJ5RXZhbChmdW5jdGlvbigpewogICAgICAgICAgICByZXR1cm4gbGlzdGVuZXIuY2FsbChpbnN0YW5jZSwgdmFsdWUsIGxhc3RWYWx1ZSk7CiAgICAgICAgICB9LCBleGNlcHRpb25IYW5kbGVyKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgaW5zdGFuY2UuJG9uRXZhbChQUklPUklUWV9XQVRDSCwgd2F0Y2hlcik7CiAgICAgIGlmIChpc1VuZGVmaW5lZChpbml0UnVuKSkgaW5pdFJ1biA9IHRydWU7CiAgICAgIGlmIChpbml0UnVuKSB3YXRjaGVyKHRydWUpOwogICAgfSwKCiAgICAvKioKICAgICAqIEB3b3JrSW5Qcm9ncmVzcwogICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgKiBAbmFtZSBhbmd1bGFyLnNjb3BlLiRvbkV2YWwKICAgICAqIEBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogRXZhbHVhdGVzIHRoZSBgZXhwcmAgZXhwcmVzc2lvbiBpbiB0aGUgY29udGV4dCBvZiB0aGUgY3VycmVudCBzY29wZSBkdXJpbmcgZWFjaAogICAgICoge0BsaW5rIGFuZ3VsYXIuc2NvcGUuJGV2YWwgZXZhbCBjeWNsZX0uCiAgICAgKgogICAgICogIyBFeGFtcGxlCiAgICAgICA8cHJlPgogICAgICAgICB2YXIgc2NvcGUgPSBhbmd1bGFyLnNjb3BlKCk7CiAgICAgICAgIHNjb3BlLmNvdW50ZXIgPSAwOwogICAgICAgICBzY29wZS4kb25FdmFsKCdjb3VudGVyID0gY291bnRlciArIDEnKTsKICAgICAgICAgZXhwZWN0KHNjb3BlLmNvdW50ZXIpLnRvRXF1YWwoMCk7CiAgICAgICAgIHNjb3BlLiRldmFsKCk7CiAgICAgICAgIGV4cGVjdChzY29wZS5jb3VudGVyKS50b0VxdWFsKDEpOwogICAgICAgPC9wcmU+CiAgICAgKgogICAgICogQHBhcmFtIHtudW1iZXJ9IFtwcmlvcml0eT0wXSBFeGVjdXRpb24gcHJpb3JpdHkuIExvd2VyIHByaW9yaXR5IG51bWJlcnMgZ2V0IGV4ZWN1dGVkIGZpcnN0LgogICAgICogQHBhcmFtIHtzdHJpbmd8ZnVuY3Rpb24oKX0gZXhwciBBbmd1bGFyIGV4cHJlc3Npb24gb3IgZnVuY3Rpb24gdG8gYmUgZXhlY3V0ZWQuCiAgICAgKiBAcGFyYW0geyhmdW5jdGlvbigpfERPTUVsZW1lbnQpPX0gW2V4Y2VwdGlvbkhhbmRsZXI9YW5ndWxhci5zZXJ2aWNlLiRleGNlcHRpb25IYW5kbGVyXSBIYW5kbGVyCiAgICAgKiAgICAgZnVuY3Rpb24gdG8gY2FsbCBvciBET00gZWxlbWVudCB0byBkZWNvcmF0ZSB3aGVuIGFuIGV4Y2VwdGlvbiBvY2N1cnMuCiAgICAgKgogICAgICovCiAgICAkb25FdmFsOiBmdW5jdGlvbihwcmlvcml0eSwgZXhwciwgZXhjZXB0aW9uSGFuZGxlcil7CiAgICAgIGlmICghaXNOdW1iZXIocHJpb3JpdHkpKSB7CiAgICAgICAgZXhjZXB0aW9uSGFuZGxlciA9IGV4cHI7CiAgICAgICAgZXhwciA9IHByaW9yaXR5OwogICAgICAgIHByaW9yaXR5ID0gMDsKICAgICAgfQogICAgICB2YXIgZXZhbExpc3QgPSBldmFsTGlzdHNbcHJpb3JpdHldOwogICAgICBpZiAoIWV2YWxMaXN0KSB7CiAgICAgICAgZXZhbExpc3QgPSBldmFsTGlzdHNbcHJpb3JpdHldID0gW107CiAgICAgICAgZXZhbExpc3QucHJpb3JpdHkgPSBwcmlvcml0eTsKICAgICAgICBldmFsTGlzdHMuc29ydGVkLnB1c2goZXZhbExpc3QpOwogICAgICAgIGV2YWxMaXN0cy5zb3J0ZWQuc29ydChmdW5jdGlvbihhLGIpe3JldHVybiBhLnByaW9yaXR5LWIucHJpb3JpdHk7fSk7CiAgICAgIH0KICAgICAgZXZhbExpc3QucHVzaCh7CiAgICAgICAgZm46IGV4cHJlc3Npb25Db21waWxlKGV4cHIpLAogICAgICAgIGhhbmRsZXI6IGV4Y2VwdGlvbkhhbmRsZXIKICAgICAgfSk7CiAgICB9LAoKICAgIC8qKgogICAgICogQHdvcmtJblByb2dyZXNzCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIGFuZ3VsYXIuc2NvcGUuJGJlY29tZQogICAgICogQGZ1bmN0aW9uCiAgICAgKiBAZGVwcmVjYXRlZCBUaGlzIG1ldGhvZCB3aWxsIGJlIHJlbW92ZWQgYmVmb3JlIDEuMAogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogTW9kaWZpZXMgdGhlIHNjb3BlIHRvIGFjdCBsaWtlIGFuIGluc3RhbmNlIG9mIHRoZSBnaXZlbiBjbGFzcyBieToKICAgICAqCiAgICAgKiAtIGNvcHlpbmcgdGhlIGNsYXNzJ3MgcHJvdG90eXBlIG1ldGhvZHMKICAgICAqIC0gYXBwbHlpbmcgdGhlIGNsYXNzJ3MgaW5pdGlhbGl6YXRpb24gZnVuY3Rpb24gdG8gdGhlIHNjb3BlIGluc3RhbmNlICh3aXRob3V0IHVzaW5nIHRoZSBuZXcKICAgICAqICAgb3BlcmF0b3IpCiAgICAgKgogICAgICogVGhhdCBtYWtlcyB0aGUgc2NvcGUgYmUgYSBgdGhpc2AgZm9yIHRoZSBnaXZlbiBjbGFzcydzIG1ldGhvZHMg4oCUIGVmZmVjdGl2ZWx5IGFuIGluc3RhbmNlIG9mCiAgICAgKiB0aGUgZ2l2ZW4gY2xhc3Mgd2l0aCBhZGRpdGlvbmFsIChzY29wZSkgc3R1ZmYuIEEgc2NvcGUgY2FuIGxhdGVyIGAkYmVjb21lYCBhbm90aGVyIGNsYXNzLgogICAgICoKICAgICAqIGAkYmVjb21lYCBnZXRzIHVzZWQgdG8gbWFrZSB0aGUgY3VycmVudCBzY29wZSBhY3QgbGlrZSBhbiBpbnN0YW5jZSBvZiBhIGNvbnRyb2xsZXIgY2xhc3MuCiAgICAgKiBUaGlzIGFsbG93cyBmb3IgdXNlIG9mIGEgY29udHJvbGxlciBjbGFzcyBpbiB0d28gd2F5cy4KICAgICAqCiAgICAgKiAtIGFzIGFuIG9yZGluYXJ5IEphdmFTY3JpcHQgY2xhc3MgZm9yIHN0YW5kYWxvbmUgdGVzdGluZywgaW5zdGFudGlhdGVkIHVzaW5nIHRoZSBuZXcKICAgICAqICAgb3BlcmF0b3IsIHdpdGggbm8gYXR0YWNoZWQgdmlldy4KICAgICAqIC0gYXMgYSBjb250cm9sbGVyIGZvciBhbiBhbmd1bGFyIG1vZGVsIHN0b3JlZCBpbiBhIHNjb3BlLCAiaW5zdGFudGlhdGVkIiBieQogICAgICogICBgc2NvcGUuJGJlY29tZShDb250cm9sbGVyQ2xhc3MpYC4KICAgICAqCiAgICAgKiBFaXRoZXIgd2F5LCB0aGUgY29udHJvbGxlcidzIG1ldGhvZHMgcmVmZXIgdG8gdGhlIG1vZGVsICB2YXJpYWJsZXMgbGlrZSBgdGhpcy5uYW1lYC4gV2hlbgogICAgICogc3RvcmVkIGluIGEgc2NvcGUsIHRoZSBtb2RlbCBzdXBwb3J0cyBkYXRhIGJpbmRpbmcuIFdoZW4gYm91bmQgdG8gYSB2aWV3LCB7e25hbWV9fSBpbiB0aGUKICAgICAqIEhUTUwgdGVtcGxhdGUgcmVmZXJzIHRvIHRoZSBzYW1lIHZhcmlhYmxlLgogICAgICovCiAgICAkYmVjb21lOiBmdW5jdGlvbihDbGFzcykgewogICAgICBpZiAoaXNGdW5jdGlvbihDbGFzcykpIHsKICAgICAgICBpbnN0YW5jZS5jb25zdHJ1Y3RvciA9IENsYXNzOwogICAgICAgIGZvckVhY2goQ2xhc3MucHJvdG90eXBlLCBmdW5jdGlvbihmbiwgbmFtZSl7CiAgICAgICAgICBpbnN0YW5jZVtuYW1lXSA9IGJpbmQoaW5zdGFuY2UsIGZuKTsKICAgICAgICB9KTsKICAgICAgICBpbnN0YW5jZS4kc2VydmljZS5pbnZva2UoaW5zdGFuY2UsIENsYXNzLCBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSwgYXJndW1lbnRzLmxlbmd0aCkpOwoKICAgICAgICAvL1RPRE86IGJhY2t3YXJkcyBjb21wYXRpYmlsaXR5IGhhY2ssIHJlbW92ZSB3aGVuIHdlIGRvbid0IGRlcGVuZCBvbiBpbml0IG1ldGhvZHMKICAgICAgICBpZiAoaXNGdW5jdGlvbihDbGFzcy5wcm90b3R5cGUuaW5pdCkpIHsKICAgICAgICAgIGluc3RhbmNlLmluaXQoKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCgogICAgLyoqCiAgICAgKiBAd29ya0luUHJvZ3Jlc3MKICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICogQG5hbWUgYW5ndWxhci5zY29wZS4kbmV3CiAgICAgKiBAZnVuY3Rpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIENyZWF0ZXMgYSBuZXcge0BsaW5rIGFuZ3VsYXIuc2NvcGUgc2NvcGV9LCB0aGF0OgogICAgICoKICAgICAqIC0gaXMgYSBjaGlsZCBvZiB0aGUgY3VycmVudCBzY29wZQogICAgICogLSB3aWxsIHtAbGluayBhbmd1bGFyLnNjb3BlLiRiZWNvbWUgJGJlY29tZX0gb2YgdHlwZSBzcGVjaWZpZWQgdmlhIGBjb25zdHJ1Y3RvcmAKICAgICAqCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKCl9IGNvbnN0cnVjdG9yIENvbnN0cnVjdG9yIGZ1bmN0aW9uIG9mIHRoZSB0eXBlIHRoZSBuZXcgc2NvcGUgc2hvdWxkIGFzc3VtZS4KICAgICAqIEByZXR1cm5zIHtPYmplY3R9IFRoZSBuZXdseSBjcmVhdGVkIGNoaWxkIHNjb3BlLgogICAgICoKICAgICAqLwogICAgJG5ldzogZnVuY3Rpb24oY29uc3RydWN0b3IpIHsKICAgICAgdmFyIGNoaWxkID0gY3JlYXRlU2NvcGUoaW5zdGFuY2UpOwogICAgICBjaGlsZC4kYmVjb21lLmFwcGx5KGluc3RhbmNlLCBjb25jYXQoW2NvbnN0cnVjdG9yXSwgYXJndW1lbnRzLCAxKSk7CiAgICAgIGluc3RhbmNlLiRvbkV2YWwoY2hpbGQuJGV2YWwpOwogICAgICByZXR1cm4gY2hpbGQ7CiAgICB9CgogIH0pOwoKICBpZiAoIXBhcmVudC4kcm9vdCkgewogICAgaW5zdGFuY2UuJHJvb3QgPSBpbnN0YW5jZTsKICAgIGluc3RhbmNlLiRwYXJlbnQgPSBpbnN0YW5jZTsKCiAgICAvKioKICAgICAqIEB3b3JrSW5Qcm9ncmVzcwogICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgKiBAbmFtZSBhbmd1bGFyLnNjb3BlLiRzZXJ2aWNlCiAgICAgKiBAZnVuY3Rpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFByb3ZpZGVzIGFjY2VzcyB0byBhbmd1bGFyJ3MgZGVwZW5kZW5jeSBpbmplY3RvciBhbmQKICAgICAqIHtAbGluayBhbmd1bGFyLnNlcnZpY2UgcmVnaXN0ZXJlZCBzZXJ2aWNlc30uIEluIGdlbmVyYWwgdGhlIHVzZSBvZiB0aGlzIGFwaSBpcyBkaXNjb3VyYWdlZCwKICAgICAqIGV4Y2VwdCBmb3IgdGVzdHMgYW5kIGNvbXBvbmVudHMgdGhhdCBjdXJyZW50bHkgZG9uJ3Qgc3VwcG9ydCBkZXBlbmRlbmN5IGluamVjdGlvbiAod2lkZ2V0cywKICAgICAqIGZpbHRlcnMsIGV0YykuCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IHNlcnZpY2VJZCBTdHJpbmcgSUQgb2YgdGhlIHNlcnZpY2UgdG8gcmV0dXJuLgogICAgICogQHJldHVybnMgeyp9IFZhbHVlLCBvYmplY3Qgb3IgZnVuY3Rpb24gcmV0dXJuZWQgYnkgdGhlIHNlcnZpY2UgZmFjdG9yeSBmdW5jdGlvbiBpZiBhbnkuCiAgICAgKi8KICAgIChpbnN0YW5jZS4kc2VydmljZSA9IGNyZWF0ZUluamVjdG9yKGluc3RhbmNlLCBwcm92aWRlcnMsIGluc3RhbmNlQ2FjaGUpKS5lYWdlcigpOwogIH0KCiAgJGxvZyA9IGluc3RhbmNlLiRzZXJ2aWNlKCckbG9nJyk7CiAgJGV4Y2VwdGlvbkhhbmRsZXIgPSBpbnN0YW5jZS4kc2VydmljZSgnJGV4Y2VwdGlvbkhhbmRsZXInKTsKCiAgcmV0dXJuIGluc3RhbmNlOwp9Cid1c2Ugc3RyaWN0JzsKCi8qKgogKiBAbmdkb2MgZnVuY3Rpb24KICogQG5hbWUgYW5ndWxhci5pbmplY3RvcgogKiBAZnVuY3Rpb24KICoKICogQGRlc2NyaXB0aW9uCiAqIENyZWF0ZXMgYW4gaW5qZWN0b3IgZnVuY3Rpb24gdGhhdCBjYW4gYmUgdXNlZCBmb3IgcmV0cmlldmluZyBzZXJ2aWNlcyBhcyB3ZWxsIGFzIGZvcgogKiBkZXBlbmRlbmN5IGluamVjdGlvbiAoc2VlIHtAbGluayBndWlkZS9kZXZfZ3VpZGUuZGkgZGVwZW5kZW5jeSBpbmplY3Rpb259KS4KICoKICogQW5ndWxhciBjcmVhdGVzIGFuIGluamVjdG9yIGF1dG9tYXRpY2FsbHkgZm9yIHRoZSByb290IHNjb3BlIGFuZCBpdCBpcyBhdmFpbGFibGUgYXMgdGhlCiAqIHtAbGluayBhbmd1bGFyLnNjb3BlLiRzZXJ2aWNlICRzZXJ2aWNlfSBwcm9wZXJ0eS4gQ3JlYXRpb24gb2YgdGhlIGluamVjdG9yIGF1dG9tYXRpY2FsbHkgY3JlYXRlcwogKiBhbGwgb2YgdGhlIGAkZWFnZXJgIHtAbGluayBhbmd1bGFyLnNlcnZpY2Ugc2VydmljZXN9LgogKgogKiBAcGFyYW0ge09iamVjdD19IFtmYWN0b3J5U2NvcGU9e31dIGB0aGlzYCBmb3IgdGhlIHNlcnZpY2UgZmFjdG9yeSBmdW5jdGlvbi4KICogQHBhcmFtIHtPYmplY3QuPHN0cmluZywgZnVuY3Rpb24oKT49fSBbZmFjdG9yaWVzPWFuZ3VsYXIuc2VydmljZV0gTWFwIG9mIHNlcnZpY2UgZmFjdG9yeQogKiAgICAgZnVuY3Rpb25zLgogKiBAcGFyYW0ge09iamVjdC48c3RyaW5nLCBmdW5jdGlvbigpPj19IFtpbnN0YW5jZUNhY2hlPXt9XSBQbGFjZSB3aGVyZSBpbnN0YW5jZXMgb2Ygc2VydmljZXMgYXJlCiAqICAgICBzYXZlZCBmb3IgcmV1c2UuIENhbiBhbHNvIGJlIHVzZWQgdG8gb3ZlcnJpZGUgc2VydmljZXMgc3BlY2lmaWVkIGJ5IGBzZXJ2aWNlRmFjdG9yeWAKICogICAgICh1c2VmdWwgaW4gdGVzdHMpLgogKiBAcmV0dXJucyB7ZnVuY3Rpb24oKX0gSW5qZWN0b3IgZnVuY3Rpb246CiAqCiAqICAgKiBgaW5qZWN0b3Ioc2VydmljZU5hbWUpYDoKICogICAgICogYHNlcnZpY2VOYW1lYCAtIGB7c3RyaW5nPX1gIC0gbmFtZSBvZiB0aGUgc2VydmljZSB0byByZXRyaWV2ZS4KICoKICogVGhlIGluamVjdG9yIGZ1bmN0aW9uIGFsc28gaGFzIHRoZXNlIHByb3BlcnRpZXM6CiAqCiAqICAgKiBhbiBgaW52b2tlYCBwcm9wZXJ0eSB3aGljaCBjYW4gYmUgdXNlZCB0byBpbnZva2UgbWV0aG9kcyB3aXRoIGRlcGVuZGVuY3ktaW5qZWN0ZWQgYXJndW1lbnRzLgogKiAgICBgaW5qZWN0b3IuaW52b2tlKHNlbGYsIGZuLCBjdXJyeUFyZ3MpYAogKiAgICAgKiBgc2VsZmAgLSAgImB0aGlzYCIgdG8gYmUgdXNlZCB3aGVuIGludm9raW5nIHRoZSBmdW5jdGlvbi4KICogICAgICogYGZuYCAtIHRoZSBmdW5jdGlvbiB0byBiZSBpbnZva2VkLiBUaGUgZnVuY3Rpb24gbWF5IGhhdmUgdGhlIGAkaW5qZWN0YCBwcm9wZXJ0eSB3aGljaAogKiAgICAgICAgbGlzdHMgdGhlIHNldCBvZiBhcmd1bWVudHMgd2hpY2ggc2hvdWxkIGJlIGF1dG8gaW5qZWN0ZWQKICogICAgICAgIChzZWUge0BsaW5rIGd1aWRlL2Rldl9ndWlkZS5kaSBkZXBlbmRlbmN5IGluamVjdGlvbn0pLgogKiAgICAgKiBgY3VycnlBcmdzKGFycmF5KWAgLSBvcHRpb25hbCBhcnJheSBvZiBhcmd1bWVudHMgdG8gcGFzcyB0byBmdW5jdGlvbiBpbnZvY2F0aW9uIGFmdGVyIHRoZQogKiAgICAgICAgaW5qZWN0aW9uIGFyZ3VtZW50cyAoYWxzbyBrbm93biBhcyBjdXJyeSBhcmd1bWVudHMgb3IgY3VycnlpbmcpLgogKiAgICogYW4gYGVhZ2VyYCBwcm9wZXJ0eSB3aGljaCBpcyB1c2VkIHRvIGluaXRpYWxpemUgdGhlIGVhZ2VyIHNlcnZpY2VzLgogKiAgICAgYGluamVjdG9yLmVhZ2VyKClgCiAqLwpmdW5jdGlvbiBjcmVhdGVJbmplY3RvcihmYWN0b3J5U2NvcGUsIGZhY3RvcmllcywgaW5zdGFuY2VDYWNoZSkgewogIGZhY3RvcmllcyA9IGZhY3RvcmllcyB8fCBhbmd1bGFyU2VydmljZTsKICBpbnN0YW5jZUNhY2hlID0gaW5zdGFuY2VDYWNoZSB8fCB7fTsKICBmYWN0b3J5U2NvcGUgPSBmYWN0b3J5U2NvcGUgfHwge307CiAgaW5qZWN0b3IuaW52b2tlID0gaW52b2tlOwoKICBpbmplY3Rvci5lYWdlciA9IGZ1bmN0aW9uKCl7CiAgICBmb3JFYWNoKGZhY3RvcmllcywgZnVuY3Rpb24oZmFjdG9yeSwgbmFtZSl7CiAgICAgIGlmIChmYWN0b3J5LiRlYWdlcikKICAgICAgICBpbmplY3RvcihuYW1lKTsKCiAgICAgIGlmIChmYWN0b3J5LiRjcmVhdGlvbikKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkZhaWxlZCB0byByZWdpc3RlciBzZXJ2aWNlICciICsgbmFtZSArCiAgICAgICAgIic6ICRjcmVhdGlvbiBwcm9wZXJ0eSBpcyB1bnN1cHBvcnRlZC4gVXNlICRlYWdlcjp0cnVlIG9yIHNlZSByZWxlYXNlIG5vdGVzLiIpOwogICAgfSk7CiAgfTsKICByZXR1cm4gaW5qZWN0b3I7CgogIGZ1bmN0aW9uIGluamVjdG9yKHZhbHVlKXsKICAgIGlmICghKHZhbHVlIGluIGluc3RhbmNlQ2FjaGUpKSB7CiAgICAgIHZhciBmYWN0b3J5ID0gZmFjdG9yaWVzW3ZhbHVlXTsKICAgICAgaWYgKCFmYWN0b3J5KSB0aHJvdyBFcnJvcigiVW5rbm93biBwcm92aWRlciBmb3IgJyIrdmFsdWUrIicuIik7CiAgICAgIGluc3RhbmNlQ2FjaGVbdmFsdWVdID0gaW52b2tlKGZhY3RvcnlTY29wZSwgZmFjdG9yeSk7CiAgICB9CiAgICByZXR1cm4gaW5zdGFuY2VDYWNoZVt2YWx1ZV07CiAgfQoKICBmdW5jdGlvbiBpbnZva2Uoc2VsZiwgZm4sIGFyZ3MpewogICAgYXJncyA9IGFyZ3MgfHwgW107CiAgICB2YXIgaW5qZWN0TmFtZXMgPSBpbmplY3Rpb25BcmdzKGZuKTsKICAgIHZhciBpID0gaW5qZWN0TmFtZXMubGVuZ3RoOwogICAgd2hpbGUoaS0tKSB7CiAgICAgIGFyZ3MudW5zaGlmdChpbmplY3RvcihpbmplY3ROYW1lc1tpXSkpOwogICAgfQogICAgcmV0dXJuIGZuLmFwcGx5KHNlbGYsIGFyZ3MpOwogIH0KfQoKLyoqCiAqIFRISVMgSVMgTk9UIFBVQkxJQyBET0MgWUVUIQogKgogKiBAbmFtZSBhbmd1bGFyLmFubm90YXRlCiAqIEBmdW5jdGlvbgogKgogKiBAZGVzY3JpcHRpb24KICogQW5ub3RhdGUgdGhlIGZ1bmN0aW9uIHdpdGggaW5qZWN0aW9uIGFyZ3VtZW50cy4gVGhpcyBpcyBlcXVpdmFsZW50IHRvIHNldHRpbmcgdGhlIGAkaW5qZWN0YAogKiBwcm9wZXJ0eSBhcyBkZXNjcmliZWQgaW4ge0BsaW5rIGd1aWRlLmRpIGRlcGVuZGVuY3kgaW5qZWN0aW9ufS4KICoKICogPHByZT4KICogdmFyIE15Q29udHJvbGxlciA9IGFuZ3VsYXIuYW5ub3RhdGUoJyRsb2NhdGlvbicsIGZ1bmN0aW9uKCRsb2NhdGlvbil7IC4uLiB9KTsKICogPC9wcmU+CiAqCiAqIGlzIHRoZSBzYW1lIGFzCiAqCiAqIDxwcmU+CiAqIHZhciBNeUNvbnRyb2xsZXIgPSBmdW5jdGlvbigkbG9jYXRpb24peyAuLi4gfTsKICogTXlDb250cm9sbGVyLiRpbmplY3QgPSBbJyRsb2NhdGlvbiddOwogKiA8L3ByZT4KICoKICogQHBhcmFtIHtTdHJpbmd8QXJyYXl9IHNlcnZpY2VOYW1lLi4uIHplcm8gb3IgbW9yZSBzZXJ2aWNlIG5hbWVzIHRvIGluamVjdCBpbnRvIHRoZQogKiAgICAgYGFubm90YXRlZEZ1bmN0aW9uYC4KICogQHBhcmFtIHtmdW5jdGlvbn0gYW5ub3RhdGVkRnVuY3Rpb24gZnVuY3Rpb24gdG8gYW5ub3RhdGUgd2l0aCBgJGluamVjdGAKICogICAgIGZ1bmN0aW9ucy4KICogQHJldHVybnMge2Z1bmN0aW9ufSBgYW5ub3RhdGVkRnVuY3Rpb25gCiAqLwpmdW5jdGlvbiBhbm5vdGF0ZShzZXJ2aWNlcywgZm4pIHsKICBpZiAoc2VydmljZXMgaW5zdGFuY2VvZiBBcnJheSkgewogICAgZm4uJGluamVjdCA9IHNlcnZpY2VzOwogICAgcmV0dXJuIGZuOwogIH0gZWxzZSB7CiAgICB2YXIgaSA9IDAsCiAgICAgICAgbGVuZ3RoID0gYXJndW1lbnRzLmxlbmd0aCAtIDEsIC8vIGxhc3Qgb25lIGlzIHRoZSBkZXN0aW5hdGlvbiBmdW5jdGlvbgogICAgICAgICRpbmplY3QgPSBhcmd1bWVudHNbbGVuZ3RoXS4kaW5qZWN0ID0gW107CiAgICBmb3IgKDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICRpbmplY3QucHVzaChhcmd1bWVudHNbaV0pOwogICAgfQogICAgcmV0dXJuIGFyZ3VtZW50c1tsZW5ndGhdOyAvLyByZXR1cm4gdGhlIGxhc3Qgb25lCiAgfQp9CgpmdW5jdGlvbiBhbmd1bGFyU2VydmljZUluamVjdChuYW1lLCBmbiwgaW5qZWN0LCBlYWdlcikgewogIGFuZ3VsYXJTZXJ2aWNlKG5hbWUsIGZuLCB7JGluamVjdDppbmplY3QsICRlYWdlcjplYWdlcn0pOwp9CgoKLyoqCiAqIEByZXR1cm5zIHRoZSAkaW5qZWN0IHByb3BlcnR5IG9mIGZ1bmN0aW9uLiBJZiBub3QgZm91bmQgdGhlCiAqIHRoZSAkaW5qZWN0IGlzIGNvbXB1dGVkIGJ5IGxvb2tpbmcgYXQgdGhlIHRvU3RyaW5nIG9mIGZ1bmN0aW9uIGFuZAogKiBleHRyYWN0aW5nIGFsbCBhcmd1bWVudHMgd2hpY2ggYW5kIGFzc3VtaW5nIHRoYXQgdGhleSBhcmUgdGhlCiAqIGluamVjdGlvbiBuYW1lcy4KICovCnZhciBGTl9BUkdTID0gL15mdW5jdGlvblxzKlteXChdKlwoKFteXCldKilcKS9tOwp2YXIgRk5fQVJHX1NQTElUID0gLywvOwp2YXIgRk5fQVJHID0gL15ccyooLis/KVxzKiQvOwp2YXIgU1RSSVBfQ09NTUVOVFMgPSAvKChcL1wvLiokKXwoXC9cKltcc1xTXSo/XCpcLykpL21nOwpmdW5jdGlvbiBpbmplY3Rpb25BcmdzKGZuKSB7CiAgYXNzZXJ0QXJnRm4oZm4pOwogIGlmICghZm4uJGluamVjdCkgewogICAgdmFyIGFyZ3MgPSBmbi4kaW5qZWN0ID0gW107CiAgICB2YXIgZm5UZXh0ID0gZm4udG9TdHJpbmcoKS5yZXBsYWNlKFNUUklQX0NPTU1FTlRTLCAnJyk7CiAgICB2YXIgYXJnRGVjbCA9IGZuVGV4dC5tYXRjaChGTl9BUkdTKTsKICAgIGZvckVhY2goYXJnRGVjbFsxXS5zcGxpdChGTl9BUkdfU1BMSVQpLCBmdW5jdGlvbihhcmcpewogICAgICBhcmcucmVwbGFjZShGTl9BUkcsIGZ1bmN0aW9uKGFsbCwgbmFtZSl7CiAgICAgICAgYXJncy5wdXNoKG5hbWUpOwogICAgICB9KTsKICAgIH0pOwogIH0KICByZXR1cm4gZm4uJGluamVjdDsKfQondXNlIHN0cmljdCc7Cgp2YXIgT1BFUkFUT1JTID0gewogICAgJ251bGwnOmZ1bmN0aW9uKHNlbGYpe3JldHVybiBudWxsO30sCiAgICAndHJ1ZSc6ZnVuY3Rpb24oc2VsZil7cmV0dXJuIHRydWU7fSwKICAgICdmYWxzZSc6ZnVuY3Rpb24oc2VsZil7cmV0dXJuIGZhbHNlO30sCiAgICAkdW5kZWZpbmVkOm5vb3AsCiAgICAnKyc6ZnVuY3Rpb24oc2VsZiwgYSxiKXtyZXR1cm4gKGlzRGVmaW5lZChhKT9hOjApKyhpc0RlZmluZWQoYik/YjowKTt9LAogICAgJy0nOmZ1bmN0aW9uKHNlbGYsIGEsYil7cmV0dXJuIChpc0RlZmluZWQoYSk/YTowKS0oaXNEZWZpbmVkKGIpP2I6MCk7fSwKICAgICcqJzpmdW5jdGlvbihzZWxmLCBhLGIpe3JldHVybiBhKmI7fSwKICAgICcvJzpmdW5jdGlvbihzZWxmLCBhLGIpe3JldHVybiBhL2I7fSwKICAgICclJzpmdW5jdGlvbihzZWxmLCBhLGIpe3JldHVybiBhJWI7fSwKICAgICdeJzpmdW5jdGlvbihzZWxmLCBhLGIpe3JldHVybiBhXmI7fSwKICAgICc9Jzpub29wLAogICAgJz09JzpmdW5jdGlvbihzZWxmLCBhLGIpe3JldHVybiBhPT1iO30sCiAgICAnIT0nOmZ1bmN0aW9uKHNlbGYsIGEsYil7cmV0dXJuIGEhPWI7fSwKICAgICc8JzpmdW5jdGlvbihzZWxmLCBhLGIpe3JldHVybiBhPGI7fSwKICAgICc+JzpmdW5jdGlvbihzZWxmLCBhLGIpe3JldHVybiBhPmI7fSwKICAgICc8PSc6ZnVuY3Rpb24oc2VsZiwgYSxiKXtyZXR1cm4gYTw9Yjt9LAogICAgJz49JzpmdW5jdGlvbihzZWxmLCBhLGIpe3JldHVybiBhPj1iO30sCiAgICAnJiYnOmZ1bmN0aW9uKHNlbGYsIGEsYil7cmV0dXJuIGEmJmI7fSwKICAgICd8fCc6ZnVuY3Rpb24oc2VsZiwgYSxiKXtyZXR1cm4gYXx8Yjt9LAogICAgJyYnOmZ1bmN0aW9uKHNlbGYsIGEsYil7cmV0dXJuIGEmYjt9LAovLyAgICAnfCc6ZnVuY3Rpb24oc2VsZiwgYSxiKXtyZXR1cm4gYXxiO30sCiAgICAnfCc6ZnVuY3Rpb24oc2VsZiwgYSxiKXtyZXR1cm4gYihzZWxmLCBhKTt9LAogICAgJyEnOmZ1bmN0aW9uKHNlbGYsIGEpe3JldHVybiAhYTt9Cn07CnZhciBFU0NBUEUgPSB7Im4iOiJcbiIsICJmIjoiXGYiLCAiciI6IlxyIiwgInQiOiJcdCIsICJ2IjoiXHYiLCAiJyI6IiciLCAnIic6JyInfTsKCmZ1bmN0aW9uIGxleCh0ZXh0LCBwYXJzZVN0cmluZ3NGb3JPYmplY3RzKXsKICB2YXIgZGF0ZVBhcnNlTGVuZ3RoID0gcGFyc2VTdHJpbmdzRm9yT2JqZWN0cyA/IERBVEVfSVNPU1RSSU5HX0xOIDogLTEsCiAgICAgIHRva2VucyA9IFtdLAogICAgICB0b2tlbiwKICAgICAgaW5kZXggPSAwLAogICAgICBqc29uID0gW10sCiAgICAgIGNoLAogICAgICBsYXN0Q2ggPSAnOic7IC8vIGNhbiBzdGFydCByZWdleHAKCiAgd2hpbGUgKGluZGV4IDwgdGV4dC5sZW5ndGgpIHsKICAgIGNoID0gdGV4dC5jaGFyQXQoaW5kZXgpOwogICAgaWYgKGlzKCciXCcnKSkgewogICAgICByZWFkU3RyaW5nKGNoKTsKICAgIH0gZWxzZSBpZiAoaXNOdW1iZXIoY2gpIHx8IGlzKCcuJykgJiYgaXNOdW1iZXIocGVlaygpKSkgewogICAgICByZWFkTnVtYmVyKCk7CiAgICB9IGVsc2UgaWYgKGlzSWRlbnQoY2gpKSB7CiAgICAgIHJlYWRJZGVudCgpOwogICAgICAvLyBpZGVudGlmaWVycyBjYW4gb25seSBiZSBpZiB0aGUgcHJlY2VkaW5nIGNoYXIgd2FzIGEgeyBvciAsCiAgICAgIGlmICh3YXMoJ3ssJykgJiYganNvblswXT09J3snICYmCiAgICAgICAgICh0b2tlbj10b2tlbnNbdG9rZW5zLmxlbmd0aC0xXSkpIHsKICAgICAgICB0b2tlbi5qc29uID0gdG9rZW4udGV4dC5pbmRleE9mKCcuJykgPT0gLTE7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAoaXMoJygpe31bXS4sOzonKSkgewogICAgICB0b2tlbnMucHVzaCh7CiAgICAgICAgaW5kZXg6aW5kZXgsCiAgICAgICAgdGV4dDpjaCwKICAgICAgICBqc29uOih3YXMoJzpbLCcpICYmIGlzKCd7WycpKSB8fCBpcygnfV06LCcpCiAgICAgIH0pOwogICAgICBpZiAoaXMoJ3tbJykpIGpzb24udW5zaGlmdChjaCk7CiAgICAgIGlmIChpcygnfV0nKSkganNvbi5zaGlmdCgpOwogICAgICBpbmRleCsrOwogICAgfSBlbHNlIGlmIChpc1doaXRlc3BhY2UoY2gpKSB7CiAgICAgIGluZGV4Kys7CiAgICAgIGNvbnRpbnVlOwogICAgfSBlbHNlIHsKICAgICAgdmFyIGNoMiA9IGNoICsgcGVlaygpLAogICAgICAgICAgZm4gPSBPUEVSQVRPUlNbY2hdLAogICAgICAgICAgZm4yID0gT1BFUkFUT1JTW2NoMl07CiAgICAgIGlmIChmbjIpIHsKICAgICAgICB0b2tlbnMucHVzaCh7aW5kZXg6aW5kZXgsIHRleHQ6Y2gyLCBmbjpmbjJ9KTsKICAgICAgICBpbmRleCArPSAyOwogICAgICB9IGVsc2UgaWYgKGZuKSB7CiAgICAgICAgdG9rZW5zLnB1c2goe2luZGV4OmluZGV4LCB0ZXh0OmNoLCBmbjpmbiwganNvbjogd2FzKCdbLDonKSAmJiBpcygnKy0nKX0pOwogICAgICAgIGluZGV4ICs9IDE7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhyb3dFcnJvcigiVW5leHBlY3RlZCBuZXh0IGNoYXJhY3RlciAiLCBpbmRleCwgaW5kZXgrMSk7CiAgICAgIH0KICAgIH0KICAgIGxhc3RDaCA9IGNoOwogIH0KICByZXR1cm4gdG9rZW5zOwoKICBmdW5jdGlvbiBpcyhjaGFycykgewogICAgcmV0dXJuIGNoYXJzLmluZGV4T2YoY2gpICE9IC0xOwogIH0KCiAgZnVuY3Rpb24gd2FzKGNoYXJzKSB7CiAgICByZXR1cm4gY2hhcnMuaW5kZXhPZihsYXN0Q2gpICE9IC0xOwogIH0KCiAgZnVuY3Rpb24gcGVlaygpIHsKICAgIHJldHVybiBpbmRleCArIDEgPCB0ZXh0Lmxlbmd0aCA/IHRleHQuY2hhckF0KGluZGV4ICsgMSkgOiBmYWxzZTsKICB9CiAgZnVuY3Rpb24gaXNOdW1iZXIoY2gpIHsKICAgIHJldHVybiAnMCcgPD0gY2ggJiYgY2ggPD0gJzknOwogIH0KICBmdW5jdGlvbiBpc1doaXRlc3BhY2UoY2gpIHsKICAgIHJldHVybiBjaCA9PSAnICcgfHwgY2ggPT0gJ1xyJyB8fCBjaCA9PSAnXHQnIHx8CiAgICAgICAgICAgY2ggPT0gJ1xuJyB8fCBjaCA9PSAnXHYnIHx8IGNoID09ICdcdTAwQTAnOyAvLyBJRSB0cmVhdHMgbm9uLWJyZWFraW5nIHNwYWNlIGFzIFx1MDBBMAogIH0KICBmdW5jdGlvbiBpc0lkZW50KGNoKSB7CiAgICByZXR1cm4gJ2EnIDw9IGNoICYmIGNoIDw9ICd6JyB8fAogICAgICAgICAgICdBJyA8PSBjaCAmJiBjaCA8PSAnWicgfHwKICAgICAgICAgICAnXycgPT0gY2ggfHwgY2ggPT0gJyQnOwogIH0KICBmdW5jdGlvbiBpc0V4cE9wZXJhdG9yKGNoKSB7CiAgICByZXR1cm4gY2ggPT0gJy0nIHx8IGNoID09ICcrJyB8fCBpc051bWJlcihjaCk7CiAgfQoKICBmdW5jdGlvbiB0aHJvd0Vycm9yKGVycm9yLCBzdGFydCwgZW5kKSB7CiAgICBlbmQgPSBlbmQgfHwgaW5kZXg7CiAgICB0aHJvdyBFcnJvcigiTGV4ZXIgRXJyb3I6ICIgKyBlcnJvciArICIgYXQgY29sdW1uIiArCiAgICAgICAgKGlzRGVmaW5lZChzdGFydCkKICAgICAgICAgICAgPyAicyAiICsgc3RhcnQgKyAgIi0iICsgaW5kZXggKyAiIFsiICsgdGV4dC5zdWJzdHJpbmcoc3RhcnQsIGVuZCkgKyAiXSIKICAgICAgICAgICAgOiAiICIgKyBlbmQpICsKICAgICAgICAiIGluIGV4cHJlc3Npb24gWyIgKyB0ZXh0ICsgIl0uIik7CiAgfQoKICBmdW5jdGlvbiByZWFkTnVtYmVyKCkgewogICAgdmFyIG51bWJlciA9ICIiOwogICAgdmFyIHN0YXJ0ID0gaW5kZXg7CiAgICB3aGlsZSAoaW5kZXggPCB0ZXh0Lmxlbmd0aCkgewogICAgICB2YXIgY2ggPSBsb3dlcmNhc2UodGV4dC5jaGFyQXQoaW5kZXgpKTsKICAgICAgaWYgKGNoID09ICcuJyB8fCBpc051bWJlcihjaCkpIHsKICAgICAgICBudW1iZXIgKz0gY2g7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIHBlZWtDaCA9IHBlZWsoKTsKICAgICAgICBpZiAoY2ggPT0gJ2UnICYmIGlzRXhwT3BlcmF0b3IocGVla0NoKSkgewogICAgICAgICAgbnVtYmVyICs9IGNoOwogICAgICAgIH0gZWxzZSBpZiAoaXNFeHBPcGVyYXRvcihjaCkgJiYKICAgICAgICAgICAgcGVla0NoICYmIGlzTnVtYmVyKHBlZWtDaCkgJiYKICAgICAgICAgICAgbnVtYmVyLmNoYXJBdChudW1iZXIubGVuZ3RoIC0gMSkgPT0gJ2UnKSB7CiAgICAgICAgICBudW1iZXIgKz0gY2g7CiAgICAgICAgfSBlbHNlIGlmIChpc0V4cE9wZXJhdG9yKGNoKSAmJgogICAgICAgICAgICAoIXBlZWtDaCB8fCAhaXNOdW1iZXIocGVla0NoKSkgJiYKICAgICAgICAgICAgbnVtYmVyLmNoYXJBdChudW1iZXIubGVuZ3RoIC0gMSkgPT0gJ2UnKSB7CiAgICAgICAgICB0aHJvd0Vycm9yKCdJbnZhbGlkIGV4cG9uZW50Jyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgfQogICAgICBpbmRleCsrOwogICAgfQogICAgbnVtYmVyID0gMSAqIG51bWJlcjsKICAgIHRva2Vucy5wdXNoKHtpbmRleDpzdGFydCwgdGV4dDpudW1iZXIsIGpzb246dHJ1ZSwKICAgICAgZm46ZnVuY3Rpb24oKXtyZXR1cm4gbnVtYmVyO319KTsKICB9CiAgZnVuY3Rpb24gcmVhZElkZW50KCkgewogICAgdmFyIGlkZW50ID0gIiI7CiAgICB2YXIgc3RhcnQgPSBpbmRleDsKICAgIHZhciBmbjsKICAgIHdoaWxlIChpbmRleCA8IHRleHQubGVuZ3RoKSB7CiAgICAgIHZhciBjaCA9IHRleHQuY2hhckF0KGluZGV4KTsKICAgICAgaWYgKGNoID09ICcuJyB8fCBpc0lkZW50KGNoKSB8fCBpc051bWJlcihjaCkpIHsKICAgICAgICBpZGVudCArPSBjaDsKICAgICAgfSBlbHNlIHsKICAgICAgICBicmVhazsKICAgICAgfQogICAgICBpbmRleCsrOwogICAgfQogICAgZm4gPSBPUEVSQVRPUlNbaWRlbnRdOwogICAgdG9rZW5zLnB1c2goewogICAgICBpbmRleDpzdGFydCwKICAgICAgdGV4dDppZGVudCwKICAgICAganNvbjogZm4sCiAgICAgIGZuOmZufHxleHRlbmQoZ2V0dGVyRm4oaWRlbnQpLCB7CiAgICAgICAgYXNzaWduOmZ1bmN0aW9uKHNlbGYsIHZhbHVlKXsKICAgICAgICAgIHJldHVybiBzZXR0ZXIoc2VsZiwgaWRlbnQsIHZhbHVlKTsKICAgICAgICB9CiAgICAgIH0pCiAgICB9KTsKICB9CgogIGZ1bmN0aW9uIHJlYWRTdHJpbmcocXVvdGUpIHsKICAgIHZhciBzdGFydCA9IGluZGV4OwogICAgaW5kZXgrKzsKICAgIHZhciBzdHJpbmcgPSAiIjsKICAgIHZhciByYXdTdHJpbmcgPSBxdW90ZTsKICAgIHZhciBlc2NhcGUgPSBmYWxzZTsKICAgIHdoaWxlIChpbmRleCA8IHRleHQubGVuZ3RoKSB7CiAgICAgIHZhciBjaCA9IHRleHQuY2hhckF0KGluZGV4KTsKICAgICAgcmF3U3RyaW5nICs9IGNoOwogICAgICBpZiAoZXNjYXBlKSB7CiAgICAgICAgaWYgKGNoID09ICd1JykgewogICAgICAgICAgdmFyIGhleCA9IHRleHQuc3Vic3RyaW5nKGluZGV4ICsgMSwgaW5kZXggKyA1KTsKICAgICAgICAgIGlmICghaGV4Lm1hdGNoKC9bXGRhLWZdezR9L2kpKQogICAgICAgICAgICB0aHJvd0Vycm9yKCAiSW52YWxpZCB1bmljb2RlIGVzY2FwZSBbXFx1IiArIGhleCArICJdIik7CiAgICAgICAgICBpbmRleCArPSA0OwogICAgICAgICAgc3RyaW5nICs9IFN0cmluZy5mcm9tQ2hhckNvZGUocGFyc2VJbnQoaGV4LCAxNikpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB2YXIgcmVwID0gRVNDQVBFW2NoXTsKICAgICAgICAgIGlmIChyZXApIHsKICAgICAgICAgICAgc3RyaW5nICs9IHJlcDsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHN0cmluZyArPSBjaDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZXNjYXBlID0gZmFsc2U7CiAgICAgIH0gZWxzZSBpZiAoY2ggPT0gJ1xcJykgewogICAgICAgIGVzY2FwZSA9IHRydWU7CiAgICAgIH0gZWxzZSBpZiAoY2ggPT0gcXVvdGUpIHsKICAgICAgICBpbmRleCsrOwogICAgICAgIHRva2Vucy5wdXNoKHtpbmRleDpzdGFydCwgdGV4dDpyYXdTdHJpbmcsIHN0cmluZzpzdHJpbmcsIGpzb246dHJ1ZSwKICAgICAgICAgIGZuOmZ1bmN0aW9uKCl7CiAgICAgICAgICAgIHJldHVybiAoc3RyaW5nLmxlbmd0aCA9PSBkYXRlUGFyc2VMZW5ndGgpCiAgICAgICAgICAgICAgPyBhbmd1bGFyWydTdHJpbmcnXVsndG9EYXRlJ10oc3RyaW5nKQogICAgICAgICAgICAgIDogc3RyaW5nOwogICAgICAgICAgfX0pOwogICAgICAgIHJldHVybjsKICAgICAgfSBlbHNlIHsKICAgICAgICBzdHJpbmcgKz0gY2g7CiAgICAgIH0KICAgICAgaW5kZXgrKzsKICAgIH0KICAgIHRocm93RXJyb3IoIlVudGVybWluYXRlZCBxdW90ZSIsIHN0YXJ0KTsKICB9Cn0KCi8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCgpmdW5jdGlvbiBwYXJzZXIodGV4dCwganNvbil7CiAgdmFyIFpFUk8gPSB2YWx1ZUZuKDApLAogICAgICB0b2tlbnMgPSBsZXgodGV4dCwganNvbiksCiAgICAgIGFzc2lnbm1lbnQgPSBfYXNzaWdubWVudCwKICAgICAgYXNzaWduYWJsZSA9IGxvZ2ljYWxPUiwKICAgICAgZnVuY3Rpb25DYWxsID0gX2Z1bmN0aW9uQ2FsbCwKICAgICAgZmllbGRBY2Nlc3MgPSBfZmllbGRBY2Nlc3MsCiAgICAgIG9iamVjdEluZGV4ID0gX29iamVjdEluZGV4LAogICAgICBmaWx0ZXJDaGFpbiA9IF9maWx0ZXJDaGFpbiwKICAgICAgZnVuY3Rpb25JZGVudCA9IF9mdW5jdGlvbklkZW50LAogICAgICBwaXBlRnVuY3Rpb24gPSBfcGlwZUZ1bmN0aW9uOwogIGlmKGpzb24pewogICAgLy8gVGhlIGV4dHJhIGxldmVsIG9mIGFsaWFzaW5nIGlzIGhlcmUsIGp1c3QgaW4gY2FzZSB0aGUgbGV4ZXIgbWlzc2VzIHNvbWV0aGluZywgc28gdGhhdAogICAgLy8gd2UgcHJldmVudCBhbnkgYWNjaWRlbnRhbCBleGVjdXRpb24gaW4gSlNPTi4KICAgIGFzc2lnbm1lbnQgPSBsb2dpY2FsT1I7CiAgICBmdW5jdGlvbkNhbGwgPQogICAgICBmaWVsZEFjY2VzcyA9CiAgICAgIG9iamVjdEluZGV4ID0KICAgICAgYXNzaWduYWJsZSA9CiAgICAgIGZpbHRlckNoYWluID0KICAgICAgZnVuY3Rpb25JZGVudCA9CiAgICAgIHBpcGVGdW5jdGlvbiA9CiAgICAgICAgZnVuY3Rpb24gKCl7IHRocm93RXJyb3IoImlzIG5vdCB2YWxpZCBqc29uIiwge3RleHQ6dGV4dCwgaW5kZXg6MH0pOyB9OwogIH0KICAvL1RPRE86IFNob3VsZG4ndCBhbGwgb2YgdGhlIHB1YmxpYyBtZXRob2RzIGhhdmUgYXNzZXJ0QWxsQ29uc3VtZWQ/CiAgLy9UT0RPOiBJIHRoaW5rIHRoZXNlIHNob3VsZCBiZSBwdWJsaWMgYXMgcGFydCBvZiB0aGUgcGFyc2VyIGFwaSBpbnN0ZWFkIG9mIHNjb3BlLiRldmFsKCkuCiAgcmV0dXJuIHsKICAgICAgYXNzaWduYWJsZTogYXNzZXJ0Q29uc3VtZWQoYXNzaWduYWJsZSksCiAgICAgIHByaW1hcnk6IGFzc2VydENvbnN1bWVkKHByaW1hcnkpLAogICAgICBzdGF0ZW1lbnRzOiBhc3NlcnRDb25zdW1lZChzdGF0ZW1lbnRzKSwKICAgICAgdmFsaWRhdG9yOiBhc3NlcnRDb25zdW1lZCh2YWxpZGF0b3IpLAogICAgICBmb3JtYXR0ZXI6IGFzc2VydENvbnN1bWVkKGZvcm1hdHRlciksCiAgICAgIGZpbHRlcjogYXNzZXJ0Q29uc3VtZWQoZmlsdGVyKQogIH07CgogIGZ1bmN0aW9uIGFzc2VydENvbnN1bWVkKGZuKSB7CiAgICByZXR1cm4gZnVuY3Rpb24oKXsKICAgICAgdmFyIHZhbHVlID0gZm4oKTsKICAgICAgaWYgKHRva2Vucy5sZW5ndGggIT09IDApIHsKICAgICAgICB0aHJvd0Vycm9yKCJpcyBhbiB1bmV4cGVjdGVkIHRva2VuIiwgdG9rZW5zWzBdKTsKICAgICAgfQogICAgICByZXR1cm4gdmFsdWU7CiAgICB9OwogIH0KCiAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICBmdW5jdGlvbiB0aHJvd0Vycm9yKG1zZywgdG9rZW4pIHsKICAgIHRocm93IEVycm9yKCJTeW50YXggRXJyb3I6IFRva2VuICciICsgdG9rZW4udGV4dCArCiAgICAgICInICIgKyBtc2cgKyAiIGF0IGNvbHVtbiAiICsKICAgICAgKHRva2VuLmluZGV4ICsgMSkgKyAiIG9mIHRoZSBleHByZXNzaW9uIFsiICsKICAgICAgdGV4dCArICJdIHN0YXJ0aW5nIGF0IFsiICsgdGV4dC5zdWJzdHJpbmcodG9rZW4uaW5kZXgpICsgIl0uIik7CiAgfQoKICBmdW5jdGlvbiBwZWVrVG9rZW4oKSB7CiAgICBpZiAodG9rZW5zLmxlbmd0aCA9PT0gMCkKICAgICAgdGhyb3cgRXJyb3IoIlVuZXhwZWN0ZWQgZW5kIG9mIGV4cHJlc3Npb246ICIgKyB0ZXh0KTsKICAgIHJldHVybiB0b2tlbnNbMF07CiAgfQoKICBmdW5jdGlvbiBwZWVrKGUxLCBlMiwgZTMsIGU0KSB7CiAgICBpZiAodG9rZW5zLmxlbmd0aCA+IDApIHsKICAgICAgdmFyIHRva2VuID0gdG9rZW5zWzBdOwogICAgICB2YXIgdCA9IHRva2VuLnRleHQ7CiAgICAgIGlmICh0PT1lMSB8fCB0PT1lMiB8fCB0PT1lMyB8fCB0PT1lNCB8fAogICAgICAgICAgKCFlMSAmJiAhZTIgJiYgIWUzICYmICFlNCkpIHsKICAgICAgICByZXR1cm4gdG9rZW47CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBmYWxzZTsKICB9CgogIGZ1bmN0aW9uIGV4cGVjdChlMSwgZTIsIGUzLCBlNCl7CiAgICB2YXIgdG9rZW4gPSBwZWVrKGUxLCBlMiwgZTMsIGU0KTsKICAgIGlmICh0b2tlbikgewogICAgICBpZiAoanNvbiAmJiAhdG9rZW4uanNvbikgewogICAgICAgIHRocm93RXJyb3IoImlzIG5vdCB2YWxpZCBqc29uIiwgdG9rZW4pOwogICAgICB9CiAgICAgIHRva2Vucy5zaGlmdCgpOwogICAgICByZXR1cm4gdG9rZW47CiAgICB9CiAgICByZXR1cm4gZmFsc2U7CiAgfQoKICBmdW5jdGlvbiBjb25zdW1lKGUxKXsKICAgIGlmICghZXhwZWN0KGUxKSkgewogICAgICB0aHJvd0Vycm9yKCJpcyB1bmV4cGVjdGVkLCBleHBlY3RpbmcgWyIgKyBlMSArICJdIiwgcGVlaygpKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIHVuYXJ5Rm4oZm4sIHJpZ2h0KSB7CiAgICByZXR1cm4gZnVuY3Rpb24oc2VsZikgewogICAgICByZXR1cm4gZm4oc2VsZiwgcmlnaHQoc2VsZikpOwogICAgfTsKICB9CgogIGZ1bmN0aW9uIGJpbmFyeUZuKGxlZnQsIGZuLCByaWdodCkgewogICAgcmV0dXJuIGZ1bmN0aW9uKHNlbGYpIHsKICAgICAgcmV0dXJuIGZuKHNlbGYsIGxlZnQoc2VsZiksIHJpZ2h0KHNlbGYpKTsKICAgIH07CiAgfQoKICBmdW5jdGlvbiBoYXNUb2tlbnMgKCkgewogICAgcmV0dXJuIHRva2Vucy5sZW5ndGggPiAwOwogIH0KCiAgZnVuY3Rpb24gc3RhdGVtZW50cygpewogICAgdmFyIHN0YXRlbWVudHMgPSBbXTsKICAgIHdoaWxlKHRydWUpIHsKICAgICAgaWYgKHRva2Vucy5sZW5ndGggPiAwICYmICFwZWVrKCd9JywgJyknLCAnOycsICddJykpCiAgICAgICAgc3RhdGVtZW50cy5wdXNoKGZpbHRlckNoYWluKCkpOwogICAgICBpZiAoIWV4cGVjdCgnOycpKSB7CiAgICAgICAgLy8gb3B0aW1pemUgZm9yIHRoZSBjb21tb24gY2FzZSB3aGVyZSB0aGVyZSBpcyBvbmx5IG9uZSBzdGF0ZW1lbnQuCiAgICAgICAgLy8gVE9ETyhzaXplKTogbWF5YmUgd2Ugc2hvdWxkIG5vdCBzdXBwb3J0IG11bHRpcGxlIHN0YXRlbWVudHM/CiAgICAgICAgcmV0dXJuIHN0YXRlbWVudHMubGVuZ3RoID09IDEKICAgICAgICAgID8gc3RhdGVtZW50c1swXQogICAgICAgICAgOiBmdW5jdGlvbiAoc2VsZil7CiAgICAgICAgICAgIHZhciB2YWx1ZTsKICAgICAgICAgICAgZm9yICggdmFyIGkgPSAwOyBpIDwgc3RhdGVtZW50cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIHZhciBzdGF0ZW1lbnQgPSBzdGF0ZW1lbnRzW2ldOwogICAgICAgICAgICAgIGlmIChzdGF0ZW1lbnQpCiAgICAgICAgICAgICAgICB2YWx1ZSA9IHN0YXRlbWVudChzZWxmKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICB9OwogICAgICB9CiAgICB9CiAgfQoKICBmdW5jdGlvbiBfZmlsdGVyQ2hhaW4oKXsKICAgIHZhciBsZWZ0ID0gZXhwcmVzc2lvbigpOwogICAgdmFyIHRva2VuOwogICAgd2hpbGUodHJ1ZSkgewogICAgICBpZiAoKHRva2VuID0gZXhwZWN0KCd8JykpKSB7CiAgICAgICAgbGVmdCA9IGJpbmFyeUZuKGxlZnQsIHRva2VuLmZuLCBmaWx0ZXIoKSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIGxlZnQ7CiAgICAgIH0KICAgIH0KICB9CgogIGZ1bmN0aW9uIGZpbHRlcigpewogICAgcmV0dXJuIHBpcGVGdW5jdGlvbihhbmd1bGFyRmlsdGVyKTsKICB9CgogIGZ1bmN0aW9uIHZhbGlkYXRvcigpewogICAgcmV0dXJuIHBpcGVGdW5jdGlvbihhbmd1bGFyVmFsaWRhdG9yKTsKICB9CgogIGZ1bmN0aW9uIGZvcm1hdHRlcigpewogICAgdmFyIHRva2VuID0gZXhwZWN0KCk7CiAgICB2YXIgZm9ybWF0dGVyID0gYW5ndWxhckZvcm1hdHRlclt0b2tlbi50ZXh0XTsKICAgIHZhciBhcmdGbnMgPSBbXTsKICAgIGlmICghZm9ybWF0dGVyKSB0aHJvd0Vycm9yKCdpcyBub3QgYSB2YWxpZCBmb3JtYXR0ZXIuJywgdG9rZW4pOwogICAgd2hpbGUodHJ1ZSkgewogICAgICBpZiAoKHRva2VuID0gZXhwZWN0KCc6JykpKSB7CiAgICAgICAgYXJnRm5zLnB1c2goZXhwcmVzc2lvbigpKTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gdmFsdWVGbih7CiAgICAgICAgICBmb3JtYXQ6aW52b2tlRm4oZm9ybWF0dGVyLmZvcm1hdCksCiAgICAgICAgICBwYXJzZTppbnZva2VGbihmb3JtYXR0ZXIucGFyc2UpCiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0KICAgIGZ1bmN0aW9uIGludm9rZUZuKGZuKXsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKHNlbGYsIGlucHV0KXsKICAgICAgICB2YXIgYXJncyA9IFtpbnB1dF07CiAgICAgICAgZm9yICggdmFyIGkgPSAwOyBpIDwgYXJnRm5zLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBhcmdzLnB1c2goYXJnRm5zW2ldKHNlbGYpKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZuLmFwcGx5KHNlbGYsIGFyZ3MpOwogICAgICB9OwogICAgfQogIH0KCiAgZnVuY3Rpb24gX3BpcGVGdW5jdGlvbihmblNjb3BlKXsKICAgIHZhciBmbiA9IGZ1bmN0aW9uSWRlbnQoZm5TY29wZSk7CiAgICB2YXIgYXJnc0ZuID0gW107CiAgICB2YXIgdG9rZW47CiAgICB3aGlsZSh0cnVlKSB7CiAgICAgIGlmICgodG9rZW4gPSBleHBlY3QoJzonKSkpIHsKICAgICAgICBhcmdzRm4ucHVzaChleHByZXNzaW9uKCkpOwogICAgICB9IGVsc2UgewogICAgICAgIHZhciBmbkludm9rZSA9IGZ1bmN0aW9uKHNlbGYsIGlucHV0KXsKICAgICAgICAgIHZhciBhcmdzID0gW2lucHV0XTsKICAgICAgICAgIGZvciAoIHZhciBpID0gMDsgaSA8IGFyZ3NGbi5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBhcmdzLnB1c2goYXJnc0ZuW2ldKHNlbGYpKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmbi5hcHBseShzZWxmLCBhcmdzKTsKICAgICAgICB9OwogICAgICAgIHJldHVybiBmdW5jdGlvbigpewogICAgICAgICAgcmV0dXJuIGZuSW52b2tlOwogICAgICAgIH07CiAgICAgIH0KICAgIH0KICB9CgogIGZ1bmN0aW9uIGV4cHJlc3Npb24oKXsKICAgIHJldHVybiBhc3NpZ25tZW50KCk7CiAgfQoKICBmdW5jdGlvbiBfYXNzaWdubWVudCgpewogICAgdmFyIGxlZnQgPSBsb2dpY2FsT1IoKTsKICAgIHZhciByaWdodDsKICAgIHZhciB0b2tlbjsKICAgIGlmICh0b2tlbiA9IGV4cGVjdCgnPScpKSB7CiAgICAgIGlmICghbGVmdC5hc3NpZ24pIHsKICAgICAgICB0aHJvd0Vycm9yKCJpbXBsaWVzIGFzc2lnbm1lbnQgYnV0IFsiICsKICAgICAgICAgIHRleHQuc3Vic3RyaW5nKDAsIHRva2VuLmluZGV4KSArICJdIGNhbiBub3QgYmUgYXNzaWduZWQgdG8iLCB0b2tlbik7CiAgICAgIH0KICAgICAgcmlnaHQgPSBsb2dpY2FsT1IoKTsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKHNlbGYpewogICAgICAgIHJldHVybiBsZWZ0LmFzc2lnbihzZWxmLCByaWdodChzZWxmKSk7CiAgICAgIH07CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gbGVmdDsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGxvZ2ljYWxPUigpewogICAgdmFyIGxlZnQgPSBsb2dpY2FsQU5EKCk7CiAgICB2YXIgdG9rZW47CiAgICB3aGlsZSh0cnVlKSB7CiAgICAgIGlmICgodG9rZW4gPSBleHBlY3QoJ3x8JykpKSB7CiAgICAgICAgbGVmdCA9IGJpbmFyeUZuKGxlZnQsIHRva2VuLmZuLCBsb2dpY2FsQU5EKCkpOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBsZWZ0OwogICAgICB9CiAgICB9CiAgfQoKICBmdW5jdGlvbiBsb2dpY2FsQU5EKCl7CiAgICB2YXIgbGVmdCA9IGVxdWFsaXR5KCk7CiAgICB2YXIgdG9rZW47CiAgICBpZiAoKHRva2VuID0gZXhwZWN0KCcmJicpKSkgewogICAgICBsZWZ0ID0gYmluYXJ5Rm4obGVmdCwgdG9rZW4uZm4sIGxvZ2ljYWxBTkQoKSk7CiAgICB9CiAgICByZXR1cm4gbGVmdDsKICB9CgogIGZ1bmN0aW9uIGVxdWFsaXR5KCl7CiAgICB2YXIgbGVmdCA9IHJlbGF0aW9uYWwoKTsKICAgIHZhciB0b2tlbjsKICAgIGlmICgodG9rZW4gPSBleHBlY3QoJz09JywnIT0nKSkpIHsKICAgICAgbGVmdCA9IGJpbmFyeUZuKGxlZnQsIHRva2VuLmZuLCBlcXVhbGl0eSgpKTsKICAgIH0KICAgIHJldHVybiBsZWZ0OwogIH0KCiAgZnVuY3Rpb24gcmVsYXRpb25hbCgpewogICAgdmFyIGxlZnQgPSBhZGRpdGl2ZSgpOwogICAgdmFyIHRva2VuOwogICAgaWYgKHRva2VuID0gZXhwZWN0KCc8JywgJz4nLCAnPD0nLCAnPj0nKSkgewogICAgICBsZWZ0ID0gYmluYXJ5Rm4obGVmdCwgdG9rZW4uZm4sIHJlbGF0aW9uYWwoKSk7CiAgICB9CiAgICByZXR1cm4gbGVmdDsKICB9CgogIGZ1bmN0aW9uIGFkZGl0aXZlKCl7CiAgICB2YXIgbGVmdCA9IG11bHRpcGxpY2F0aXZlKCk7CiAgICB2YXIgdG9rZW47CiAgICB3aGlsZSh0b2tlbiA9IGV4cGVjdCgnKycsJy0nKSkgewogICAgICBsZWZ0ID0gYmluYXJ5Rm4obGVmdCwgdG9rZW4uZm4sIG11bHRpcGxpY2F0aXZlKCkpOwogICAgfQogICAgcmV0dXJuIGxlZnQ7CiAgfQoKICBmdW5jdGlvbiBtdWx0aXBsaWNhdGl2ZSgpewogICAgdmFyIGxlZnQgPSB1bmFyeSgpOwogICAgdmFyIHRva2VuOwogICAgd2hpbGUodG9rZW4gPSBleHBlY3QoJyonLCcvJywnJScpKSB7CiAgICAgIGxlZnQgPSBiaW5hcnlGbihsZWZ0LCB0b2tlbi5mbiwgdW5hcnkoKSk7CiAgICB9CiAgICByZXR1cm4gbGVmdDsKICB9CgogIGZ1bmN0aW9uIHVuYXJ5KCl7CiAgICB2YXIgdG9rZW47CiAgICBpZiAoZXhwZWN0KCcrJykpIHsKICAgICAgcmV0dXJuIHByaW1hcnkoKTsKICAgIH0gZWxzZSBpZiAodG9rZW4gPSBleHBlY3QoJy0nKSkgewogICAgICByZXR1cm4gYmluYXJ5Rm4oWkVSTywgdG9rZW4uZm4sIHVuYXJ5KCkpOwogICAgfSBlbHNlIGlmICh0b2tlbiA9IGV4cGVjdCgnIScpKSB7CiAgICAgIHJldHVybiB1bmFyeUZuKHRva2VuLmZuLCB1bmFyeSgpKTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBwcmltYXJ5KCk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBfZnVuY3Rpb25JZGVudChmblNjb3BlKSB7CiAgICB2YXIgdG9rZW4gPSBleHBlY3QoKTsKICAgIHZhciBlbGVtZW50ID0gdG9rZW4udGV4dC5zcGxpdCgnLicpOwogICAgdmFyIGluc3RhbmNlID0gZm5TY29wZTsKICAgIHZhciBrZXk7CiAgICBmb3IgKCB2YXIgaSA9IDA7IGkgPCBlbGVtZW50Lmxlbmd0aDsgaSsrKSB7CiAgICAgIGtleSA9IGVsZW1lbnRbaV07CiAgICAgIGlmIChpbnN0YW5jZSkKICAgICAgICBpbnN0YW5jZSA9IGluc3RhbmNlW2tleV07CiAgICB9CiAgICBpZiAodHlwZW9mIGluc3RhbmNlICE9ICRmdW5jdGlvbikgewogICAgICB0aHJvd0Vycm9yKCJzaG91bGQgYmUgYSBmdW5jdGlvbiIsIHRva2VuKTsKICAgIH0KICAgIHJldHVybiBpbnN0YW5jZTsKICB9CgogIGZ1bmN0aW9uIHByaW1hcnkoKSB7CiAgICB2YXIgcHJpbWFyeTsKICAgIGlmIChleHBlY3QoJygnKSkgewogICAgICB2YXIgZXhwcmVzc2lvbiA9IGZpbHRlckNoYWluKCk7CiAgICAgIGNvbnN1bWUoJyknKTsKICAgICAgcHJpbWFyeSA9IGV4cHJlc3Npb247CiAgICB9IGVsc2UgaWYgKGV4cGVjdCgnWycpKSB7CiAgICAgIHByaW1hcnkgPSBhcnJheURlY2xhcmF0aW9uKCk7CiAgICB9IGVsc2UgaWYgKGV4cGVjdCgneycpKSB7CiAgICAgIHByaW1hcnkgPSBvYmplY3QoKTsKICAgIH0gZWxzZSB7CiAgICAgIHZhciB0b2tlbiA9IGV4cGVjdCgpOwogICAgICBwcmltYXJ5ID0gdG9rZW4uZm47CiAgICAgIGlmICghcHJpbWFyeSkgewogICAgICAgIHRocm93RXJyb3IoIm5vdCBhIHByaW1hcnkgZXhwcmVzc2lvbiIsIHRva2VuKTsKICAgICAgfQogICAgfQogICAgdmFyIG5leHQ7CiAgICB3aGlsZSAobmV4dCA9IGV4cGVjdCgnKCcsICdbJywgJy4nKSkgewogICAgICBpZiAobmV4dC50ZXh0ID09PSAnKCcpIHsKICAgICAgICBwcmltYXJ5ID0gZnVuY3Rpb25DYWxsKHByaW1hcnkpOwogICAgICB9IGVsc2UgaWYgKG5leHQudGV4dCA9PT0gJ1snKSB7CiAgICAgICAgcHJpbWFyeSA9IG9iamVjdEluZGV4KHByaW1hcnkpOwogICAgICB9IGVsc2UgaWYgKG5leHQudGV4dCA9PT0gJy4nKSB7CiAgICAgICAgcHJpbWFyeSA9IGZpZWxkQWNjZXNzKHByaW1hcnkpOwogICAgICB9IGVsc2UgewogICAgICAgIHRocm93RXJyb3IoIklNUE9TU0lCTEUiKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHByaW1hcnk7CiAgfQoKICBmdW5jdGlvbiBfZmllbGRBY2Nlc3Mob2JqZWN0KSB7CiAgICB2YXIgZmllbGQgPSBleHBlY3QoKS50ZXh0OwogICAgdmFyIGdldHRlciA9IGdldHRlckZuKGZpZWxkKTsKICAgIHJldHVybiBleHRlbmQoZnVuY3Rpb24gKHNlbGYpewogICAgICByZXR1cm4gZ2V0dGVyKG9iamVjdChzZWxmKSk7CiAgICB9LCB7CiAgICAgIGFzc2lnbjpmdW5jdGlvbihzZWxmLCB2YWx1ZSl7CiAgICAgICAgcmV0dXJuIHNldHRlcihvYmplY3Qoc2VsZiksIGZpZWxkLCB2YWx1ZSk7CiAgICAgIH0KICAgIH0pOwogIH0KCiAgZnVuY3Rpb24gX29iamVjdEluZGV4KG9iaikgewogICAgdmFyIGluZGV4Rm4gPSBleHByZXNzaW9uKCk7CiAgICBjb25zdW1lKCddJyk7CiAgICByZXR1cm4gZXh0ZW5kKAogICAgICBmdW5jdGlvbiAoc2VsZil7CiAgICAgICAgdmFyIG8gPSBvYmooc2VsZik7CiAgICAgICAgdmFyIGkgPSBpbmRleEZuKHNlbGYpOwogICAgICAgIHJldHVybiAobykgPyBvW2ldIDogdW5kZWZpbmVkOwogICAgICB9LCB7CiAgICAgICAgYXNzaWduOmZ1bmN0aW9uKHNlbGYsIHZhbHVlKXsKICAgICAgICAgIHJldHVybiBvYmooc2VsZilbaW5kZXhGbihzZWxmKV0gPSB2YWx1ZTsKICAgICAgICB9CiAgICAgIH0pOwogIH0KCiAgZnVuY3Rpb24gX2Z1bmN0aW9uQ2FsbChmbikgewogICAgdmFyIGFyZ3NGbiA9IFtdOwogICAgaWYgKHBlZWtUb2tlbigpLnRleHQgIT0gJyknKSB7CiAgICAgIGRvIHsKICAgICAgICBhcmdzRm4ucHVzaChleHByZXNzaW9uKCkpOwogICAgICB9IHdoaWxlIChleHBlY3QoJywnKSk7CiAgICB9CiAgICBjb25zdW1lKCcpJyk7CiAgICByZXR1cm4gZnVuY3Rpb24gKHNlbGYpewogICAgICB2YXIgYXJncyA9IFtdOwogICAgICBmb3IgKCB2YXIgaSA9IDA7IGkgPCBhcmdzRm4ubGVuZ3RoOyBpKyspIHsKICAgICAgICBhcmdzLnB1c2goYXJnc0ZuW2ldKHNlbGYpKTsKICAgICAgfQogICAgICB2YXIgZm5QdHIgPSBmbihzZWxmKSB8fCBub29wOwogICAgICAvLyBJRSBzdHVwaWRpdHkhCiAgICAgIHJldHVybiBmblB0ci5hcHBseQogICAgICAgICAgPyBmblB0ci5hcHBseShzZWxmLCBhcmdzKQogICAgICAgICAgOiBmblB0cihhcmdzWzBdLCBhcmdzWzFdLCBhcmdzWzJdLCBhcmdzWzNdLCBhcmdzWzRdKTsKICAgIH07CiAgfQoKICAvLyBUaGlzIGlzIHVzZWQgd2l0aCBqc29uIGFycmF5IGRlY2xhcmF0aW9uCiAgZnVuY3Rpb24gYXJyYXlEZWNsYXJhdGlvbiAoKSB7CiAgICB2YXIgZWxlbWVudEZucyA9IFtdOwogICAgaWYgKHBlZWtUb2tlbigpLnRleHQgIT0gJ10nKSB7CiAgICAgIGRvIHsKICAgICAgICBlbGVtZW50Rm5zLnB1c2goZXhwcmVzc2lvbigpKTsKICAgICAgfSB3aGlsZSAoZXhwZWN0KCcsJykpOwogICAgfQogICAgY29uc3VtZSgnXScpOwogICAgcmV0dXJuIGZ1bmN0aW9uIChzZWxmKXsKICAgICAgdmFyIGFycmF5ID0gW107CiAgICAgIGZvciAoIHZhciBpID0gMDsgaSA8IGVsZW1lbnRGbnMubGVuZ3RoOyBpKyspIHsKICAgICAgICBhcnJheS5wdXNoKGVsZW1lbnRGbnNbaV0oc2VsZikpOwogICAgICB9CiAgICAgIHJldHVybiBhcnJheTsKICAgIH07CiAgfQoKICBmdW5jdGlvbiBvYmplY3QgKCkgewogICAgdmFyIGtleVZhbHVlcyA9IFtdOwogICAgaWYgKHBlZWtUb2tlbigpLnRleHQgIT0gJ30nKSB7CiAgICAgIGRvIHsKICAgICAgICB2YXIgdG9rZW4gPSBleHBlY3QoKSwKICAgICAgICBrZXkgPSB0b2tlbi5zdHJpbmcgfHwgdG9rZW4udGV4dDsKICAgICAgICBjb25zdW1lKCI6Iik7CiAgICAgICAgdmFyIHZhbHVlID0gZXhwcmVzc2lvbigpOwogICAgICAgIGtleVZhbHVlcy5wdXNoKHtrZXk6a2V5LCB2YWx1ZTp2YWx1ZX0pOwogICAgICB9IHdoaWxlIChleHBlY3QoJywnKSk7CiAgICB9CiAgICBjb25zdW1lKCd9Jyk7CiAgICByZXR1cm4gZnVuY3Rpb24gKHNlbGYpewogICAgICB2YXIgb2JqZWN0ID0ge307CiAgICAgIGZvciAoIHZhciBpID0gMDsgaSA8IGtleVZhbHVlcy5sZW5ndGg7IGkrKykgewogICAgICAgIHZhciBrZXlWYWx1ZSA9IGtleVZhbHVlc1tpXTsKICAgICAgICB2YXIgdmFsdWUgPSBrZXlWYWx1ZS52YWx1ZShzZWxmKTsKICAgICAgICBvYmplY3Rba2V5VmFsdWUua2V5XSA9IHZhbHVlOwogICAgICB9CiAgICAgIHJldHVybiBvYmplY3Q7CiAgICB9OwogIH0KCiAgZnVuY3Rpb24gd2F0Y2hEZWNsICgpIHsKICAgIHZhciBhbmNob3JOYW1lID0gZXhwZWN0KCkudGV4dDsKICAgIGNvbnN1bWUoIjoiKTsKICAgIHZhciBleHByZXNzaW9uRm47CiAgICBpZiAocGVla1Rva2VuKCkudGV4dCA9PSAneycpIHsKICAgICAgY29uc3VtZSgieyIpOwogICAgICBleHByZXNzaW9uRm4gPSBzdGF0ZW1lbnRzKCk7CiAgICAgIGNvbnN1bWUoIn0iKTsKICAgIH0gZWxzZSB7CiAgICAgIGV4cHJlc3Npb25GbiA9IGV4cHJlc3Npb24oKTsKICAgIH0KICAgIHJldHVybiBmdW5jdGlvbihzZWxmKSB7CiAgICAgIHJldHVybiB7bmFtZTphbmNob3JOYW1lLCBmbjpleHByZXNzaW9uRm59OwogICAgfTsKICB9Cn0KCgoKJ3VzZSBzdHJpY3QnOwoKCgpmdW5jdGlvbiBSb3V0ZSh0ZW1wbGF0ZSwgZGVmYXVsdHMpIHsKICB0aGlzLnRlbXBsYXRlID0gdGVtcGxhdGUgPSB0ZW1wbGF0ZSArICcjJzsKICB0aGlzLmRlZmF1bHRzID0gZGVmYXVsdHMgfHwge307CiAgdmFyIHVybFBhcmFtcyA9IHRoaXMudXJsUGFyYW1zID0ge307CiAgZm9yRWFjaCh0ZW1wbGF0ZS5zcGxpdCgvXFcvKSwgZnVuY3Rpb24ocGFyYW0pewogICAgaWYgKHBhcmFtICYmIHRlbXBsYXRlLm1hdGNoKG5ldyBSZWdFeHAoIjoiICsgcGFyYW0gKyAiXFxXIikpKSB7CiAgICAgIHVybFBhcmFtc1twYXJhbV0gPSB0cnVlOwogICAgfQogIH0pOwp9CgpSb3V0ZS5wcm90b3R5cGUgPSB7CiAgdXJsOiBmdW5jdGlvbihwYXJhbXMpIHsKICAgIHZhciBzZWxmID0gdGhpcywKICAgICAgICB1cmwgPSB0aGlzLnRlbXBsYXRlLAogICAgICAgIGVuY29kZWRWYWw7CgogICAgcGFyYW1zID0gcGFyYW1zIHx8IHt9OwogICAgZm9yRWFjaCh0aGlzLnVybFBhcmFtcywgZnVuY3Rpb24oXywgdXJsUGFyYW0pewogICAgICBlbmNvZGVkVmFsID0gZW5jb2RlVXJpU2VnbWVudChwYXJhbXNbdXJsUGFyYW1dIHx8IHNlbGYuZGVmYXVsdHNbdXJsUGFyYW1dIHx8ICIiKTsKICAgICAgdXJsID0gdXJsLnJlcGxhY2UobmV3IFJlZ0V4cCgiOiIgKyB1cmxQYXJhbSArICIoXFxXKSIpLCBlbmNvZGVkVmFsICsgIiQxIik7CiAgICB9KTsKICAgIHVybCA9IHVybC5yZXBsYWNlKC9cLz8jJC8sICcnKTsKICAgIHZhciBxdWVyeSA9IFtdOwogICAgZm9yRWFjaFNvcnRlZChwYXJhbXMsIGZ1bmN0aW9uKHZhbHVlLCBrZXkpewogICAgICBpZiAoIXNlbGYudXJsUGFyYW1zW2tleV0pIHsKICAgICAgICBxdWVyeS5wdXNoKGVuY29kZVVyaVF1ZXJ5KGtleSkgKyAnPScgKyBlbmNvZGVVcmlRdWVyeSh2YWx1ZSkpOwogICAgICB9CiAgICB9KTsKICAgIHVybCA9IHVybC5yZXBsYWNlKC9cLyokLywgJycpOwogICAgcmV0dXJuIHVybCArIChxdWVyeS5sZW5ndGggPyAnPycgKyBxdWVyeS5qb2luKCcmJykgOiAnJyk7CiAgfQp9OwoKZnVuY3Rpb24gUmVzb3VyY2VGYWN0b3J5KHhocikgewogIHRoaXMueGhyID0geGhyOwp9CgpSZXNvdXJjZUZhY3RvcnkuREVGQVVMVF9BQ1RJT05TID0gewogICdnZXQnOiAgICB7bWV0aG9kOidHRVQnfSwKICAnc2F2ZSc6ICAge21ldGhvZDonUE9TVCd9LAogICdxdWVyeSc6ICB7bWV0aG9kOidHRVQnLCBpc0FycmF5OnRydWV9LAogICdyZW1vdmUnOiB7bWV0aG9kOidERUxFVEUnfSwKICAnZGVsZXRlJzoge21ldGhvZDonREVMRVRFJ30KfTsKClJlc291cmNlRmFjdG9yeS5wcm90b3R5cGUgPSB7CiAgcm91dGU6IGZ1bmN0aW9uKHVybCwgcGFyYW1EZWZhdWx0cywgYWN0aW9ucyl7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB2YXIgcm91dGUgPSBuZXcgUm91dGUodXJsKTsKICAgIGFjdGlvbnMgPSBleHRlbmQoe30sIFJlc291cmNlRmFjdG9yeS5ERUZBVUxUX0FDVElPTlMsIGFjdGlvbnMpOwogICAgZnVuY3Rpb24gZXh0cmFjdFBhcmFtcyhkYXRhKXsKICAgICAgdmFyIGlkcyA9IHt9OwogICAgICBmb3JFYWNoKHBhcmFtRGVmYXVsdHMgfHwge30sIGZ1bmN0aW9uKHZhbHVlLCBrZXkpewogICAgICAgIGlkc1trZXldID0gdmFsdWUuY2hhckF0ICYmIHZhbHVlLmNoYXJBdCgwKSA9PSAnQCcgPyBnZXR0ZXIoZGF0YSwgdmFsdWUuc3Vic3RyKDEpKSA6IHZhbHVlOwogICAgICB9KTsKICAgICAgcmV0dXJuIGlkczsKICAgIH0KCiAgICBmdW5jdGlvbiBSZXNvdXJjZSh2YWx1ZSl7CiAgICAgIGNvcHkodmFsdWUgfHwge30sIHRoaXMpOwogICAgfQoKICAgIGZvckVhY2goYWN0aW9ucywgZnVuY3Rpb24oYWN0aW9uLCBuYW1lKXsKICAgICAgdmFyIGlzUG9zdE9yUHV0ID0gYWN0aW9uLm1ldGhvZCA9PSAnUE9TVCcgfHwgYWN0aW9uLm1ldGhvZCA9PSAnUFVUJzsKICAgICAgUmVzb3VyY2VbbmFtZV0gPSBmdW5jdGlvbiAoYTEsIGEyLCBhMywgYTQpIHsKICAgICAgICB2YXIgcGFyYW1zID0ge307CiAgICAgICAgdmFyIGRhdGE7CiAgICAgICAgdmFyIHN1Y2Nlc3MgPSBub29wOwogICAgICAgIHZhciBlcnJvciA9IG51bGw7CiAgICAgICAgc3dpdGNoKGFyZ3VtZW50cy5sZW5ndGgpIHsKICAgICAgICBjYXNlIDQ6CiAgICAgICAgICBlcnJvciA9IGE0OwogICAgICAgICAgc3VjY2VzcyA9IGEzOwogICAgICAgICAgLy9mYWxsdGhyb3VnaAogICAgICAgIGNhc2UgMzoKICAgICAgICBjYXNlIDI6CiAgICAgICAgICBpZiAoaXNGdW5jdGlvbihhMikpIHsKICAgICAgICAgICAgaWYgKGlzRnVuY3Rpb24oYTEpKSB7CiAgICAgICAgICAgICAgc3VjY2VzcyA9IGExOwogICAgICAgICAgICAgIGVycm9yID0gYTI7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHN1Y2Nlc3MgPSBhMjsKICAgICAgICAgICAgZXJyb3IgPSBhMzsKICAgICAgICAgICAgLy9mYWxsdGhyb3VnaAogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcGFyYW1zID0gYTE7CiAgICAgICAgICAgIGRhdGEgPSBhMjsKICAgICAgICAgICAgc3VjY2VzcyA9IGEzOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICBjYXNlIDE6CiAgICAgICAgICBpZiAoaXNGdW5jdGlvbihhMSkpIHN1Y2Nlc3MgPSBhMTsKICAgICAgICAgIGVsc2UgaWYgKGlzUG9zdE9yUHV0KSBkYXRhID0gYTE7CiAgICAgICAgICBlbHNlIHBhcmFtcyA9IGExOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAwOiBicmVhazsKICAgICAgICBkZWZhdWx0OgogICAgICAgICAgdGhyb3cgIkV4cGVjdGVkIGJldHdlZW4gMC00IGFyZ3VtZW50cyBbcGFyYW1zLCBkYXRhLCBzdWNjZXNzLCBlcnJvcl0sIGdvdCAiICsKICAgICAgICAgICAgYXJndW1lbnRzLmxlbmd0aCArICIgYXJndW1lbnRzLiI7CiAgICAgICAgfQoKICAgICAgICB2YXIgdmFsdWUgPSB0aGlzIGluc3RhbmNlb2YgUmVzb3VyY2UgPyB0aGlzIDogKGFjdGlvbi5pc0FycmF5ID8gW10gOiBuZXcgUmVzb3VyY2UoZGF0YSkpOwogICAgICAgIHNlbGYueGhyKAogICAgICAgICAgYWN0aW9uLm1ldGhvZCwKICAgICAgICAgIHJvdXRlLnVybChleHRlbmQoe30sIGFjdGlvbi5wYXJhbXMgfHwge30sIGV4dHJhY3RQYXJhbXMoZGF0YSksIHBhcmFtcykpLAogICAgICAgICAgZGF0YSwKICAgICAgICAgIGZ1bmN0aW9uKHN0YXR1cywgcmVzcG9uc2UsIHJlc3BvbnNlSGVhZGVycykgewogICAgICAgICAgICBpZiAocmVzcG9uc2UpIHsKICAgICAgICAgICAgICBpZiAoYWN0aW9uLmlzQXJyYXkpIHsKICAgICAgICAgICAgICAgIHZhbHVlLmxlbmd0aCA9IDA7CiAgICAgICAgICAgICAgICBmb3JFYWNoKHJlc3BvbnNlLCBmdW5jdGlvbihpdGVtKSB7CiAgICAgICAgICAgICAgICAgIHZhbHVlLnB1c2gobmV3IFJlc291cmNlKGl0ZW0pKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjb3B5KHJlc3BvbnNlLCB2YWx1ZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIChzdWNjZXNzfHxub29wKSh2YWx1ZSwgcmVzcG9uc2VIZWFkZXJzKTsKICAgICAgICAgIH0sCiAgICAgICAgICBlcnJvciB8fCBhY3Rpb24udmVyaWZ5Q2FjaGUsCiAgICAgICAgICBhY3Rpb24udmVyaWZ5Q2FjaGUpOwogICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgfTsKCiAgICAgIFJlc291cmNlLmJpbmQgPSBmdW5jdGlvbihhZGRpdGlvbmFsUGFyYW1EZWZhdWx0cyl7CiAgICAgICAgcmV0dXJuIHNlbGYucm91dGUodXJsLCBleHRlbmQoe30sIHBhcmFtRGVmYXVsdHMsIGFkZGl0aW9uYWxQYXJhbURlZmF1bHRzKSwgYWN0aW9ucyk7CiAgICAgIH07CgogICAgICBSZXNvdXJjZS5wcm90b3R5cGVbJyQnICsgbmFtZV0gPSBmdW5jdGlvbihhMSwgYTIsIGEzKSB7CiAgICAgICAgdmFyIHBhcmFtcyA9IGV4dHJhY3RQYXJhbXModGhpcyksCiAgICAgICAgICAgIHN1Y2Nlc3MgPSBub29wLAogICAgICAgICAgICBlcnJvcjsKCiAgICAgICAgc3dpdGNoKGFyZ3VtZW50cy5sZW5ndGgpIHsKICAgICAgICBjYXNlIDM6IHBhcmFtcyA9IGExOyBzdWNjZXNzID0gYTI7IGVycm9yID0gYTM7IGJyZWFrOwogICAgICAgIGNhc2UgMjoKICAgICAgICBjYXNlIDE6CiAgICAgICAgICBpZiAoaXNGdW5jdGlvbihhMSkpIHsKICAgICAgICAgICAgc3VjY2VzcyA9IGExOwogICAgICAgICAgICBlcnJvciA9IGEyOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcGFyYW1zID0gYTE7CiAgICAgICAgICAgIHN1Y2Nlc3MgPSBhMiB8fCBub29wOwogICAgICAgICAgfQogICAgICAgIGNhc2UgMDogYnJlYWs7CiAgICAgICAgZGVmYXVsdDoKICAgICAgICAgIHRocm93ICJFeHBlY3RlZCBiZXR3ZWVuIDEtMyBhcmd1bWVudHMgW3BhcmFtcywgc3VjY2VzcywgZXJyb3JdLCBnb3QgIiArCiAgICAgICAgICAgIGFyZ3VtZW50cy5sZW5ndGggKyAiIGFyZ3VtZW50cy4iOwogICAgICAgIH0KICAgICAgICB2YXIgZGF0YSA9IGlzUG9zdE9yUHV0ID8gdGhpcyA6IHVuZGVmaW5lZDsKICAgICAgICBSZXNvdXJjZVtuYW1lXS5jYWxsKHRoaXMsIHBhcmFtcywgZGF0YSwgc3VjY2VzcywgZXJyb3IpOwogICAgICB9OwogICAgfSk7CiAgICByZXR1cm4gUmVzb3VyY2U7CiAgfQp9OwondXNlIHN0cmljdCc7CgovLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KLy8gQnJvd3NlcgovLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KdmFyIFhIUiA9IHdpbmRvdy5YTUxIdHRwUmVxdWVzdCB8fCBmdW5jdGlvbiAoKSB7CiAgdHJ5IHsgcmV0dXJuIG5ldyBBY3RpdmVYT2JqZWN0KCJNc3htbDIuWE1MSFRUUC42LjAiKTsgfSBjYXRjaCAoZTEpIHt9CiAgdHJ5IHsgcmV0dXJuIG5ldyBBY3RpdmVYT2JqZWN0KCJNc3htbDIuWE1MSFRUUC4zLjAiKTsgfSBjYXRjaCAoZTIpIHt9CiAgdHJ5IHsgcmV0dXJuIG5ldyBBY3RpdmVYT2JqZWN0KCJNc3htbDIuWE1MSFRUUCIpOyB9IGNhdGNoIChlMykge30KICB0aHJvdyBuZXcgRXJyb3IoIlRoaXMgYnJvd3NlciBkb2VzIG5vdCBzdXBwb3J0IFhNTEh0dHBSZXF1ZXN0LiIpOwp9OwoKCi8qKgogKiBAbmdkb2Mgc2VydmljZQogKiBAbmFtZSBhbmd1bGFyLnNlcnZpY2UuJGJyb3dzZXIKICogQHJlcXVpcmVzICRsb2cKICoKICogQGRlc2NyaXB0aW9uCiAqIENvbnN0cnVjdG9yIGZvciB0aGUgb2JqZWN0IGV4cG9zZWQgYXMgJGJyb3dzZXIgc2VydmljZS4KICoKICogVGhpcyBvYmplY3QgaGFzIHR3byBnb2FsczoKICoKICogLSBoaWRlIGFsbCB0aGUgZ2xvYmFsIHN0YXRlIGluIHRoZSBicm93c2VyIGNhdXNlZCBieSB0aGUgd2luZG93IG9iamVjdAogKiAtIGFic3RyYWN0IGF3YXkgYWxsIHRoZSBicm93c2VyIHNwZWNpZmljIGZlYXR1cmVzIGFuZCBpbmNvbnNpc3RlbmNpZXMKICoKICogRm9yIHRlc3RzIHdlIHByb3ZpZGUge0BsaW5rIGFuZ3VsYXIubW9jay5zZXJ2aWNlLiRicm93c2VyIG1vY2sgaW1wbGVtZW50YXRpb259IG9mIHRoZSBgJGJyb3dzZXJgCiAqIHNlcnZpY2UsIHdoaWNoIGNhbiBiZSB1c2VkIGZvciBjb252ZW5pZW50IHRlc3Rpbmcgb2YgdGhlIGFwcGxpY2F0aW9uIHdpdGhvdXQgdGhlIGludGVyYWN0aW9uIHdpdGgKICogdGhlIHJlYWwgYnJvd3NlciBhcGlzLgogKi8KLyoqCiAqIEBwYXJhbSB7b2JqZWN0fSB3aW5kb3cgVGhlIGdsb2JhbCB3aW5kb3cgb2JqZWN0LgogKiBAcGFyYW0ge29iamVjdH0gZG9jdW1lbnQgalF1ZXJ5IHdyYXBwZWQgZG9jdW1lbnQuCiAqIEBwYXJhbSB7b2JqZWN0fSBib2R5IGpRdWVyeSB3cmFwcGVkIGRvY3VtZW50LmJvZHkuCiAqIEBwYXJhbSB7ZnVuY3Rpb24oKX0gWEhSIFhNTEh0dHBSZXF1ZXN0IGNvbnN0cnVjdG9yLgogKiBAcGFyYW0ge29iamVjdH0gJGxvZyBjb25zb2xlLmxvZyBvciBhbiBvYmplY3Qgd2l0aCB0aGUgc2FtZSBpbnRlcmZhY2UuCiAqLwpmdW5jdGlvbiBCcm93c2VyKHdpbmRvdywgZG9jdW1lbnQsIGJvZHksIFhIUiwgJGxvZykgewogIHZhciBzZWxmID0gdGhpcywKICAgICAgcmF3RG9jdW1lbnQgPSBkb2N1bWVudFswXSwKICAgICAgbG9jYXRpb24gPSB3aW5kb3cubG9jYXRpb24sCiAgICAgIHNldFRpbWVvdXQgPSB3aW5kb3cuc2V0VGltZW91dCwKICAgICAgY2xlYXJUaW1lb3V0ID0gd2luZG93LmNsZWFyVGltZW91dCwKICAgICAgcGVuZGluZ0RlZmVySWRzID0ge30sCiAgICAgIGxhc3RMb2NhdGlvblVybDsKCiAgc2VsZi5pc01vY2sgPSBmYWxzZTsKCiAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICAvLyBYSFIgQVBJCiAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICB2YXIgaWRDb3VudGVyID0gMDsKICB2YXIgb3V0c3RhbmRpbmdSZXF1ZXN0Q291bnQgPSAwOwogIHZhciBvdXRzdGFuZGluZ1JlcXVlc3RDYWxsYmFja3MgPSBbXTsKCgogIC8qKgogICAqIEV4ZWN1dGVzIHRoZSBgZm5gIGZ1bmN0aW9uIChzdXBwb3J0cyBjdXJyeWluZykgYW5kIGRlY3JlbWVudHMgdGhlIGBvdXRzdGFuZGluZ1JlcXVlc3RDYWxsYmFja3NgCiAgICogY291bnRlci4gSWYgdGhlIGNvdW50ZXIgcmVhY2hlcyAwLCBhbGwgdGhlIGBvdXRzdGFuZGluZ1JlcXVlc3RDYWxsYmFja3NgIGFyZSBleGVjdXRlZC4KICAgKi8KICBmdW5jdGlvbiBjb21wbGV0ZU91dHN0YW5kaW5nUmVxdWVzdChmbikgewogICAgdHJ5IHsKICAgICAgZm4uYXBwbHkobnVsbCwgc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpKTsKICAgIH0gZmluYWxseSB7CiAgICAgIG91dHN0YW5kaW5nUmVxdWVzdENvdW50LS07CiAgICAgIGlmIChvdXRzdGFuZGluZ1JlcXVlc3RDb3VudCA9PT0gMCkgewogICAgICAgIHdoaWxlKG91dHN0YW5kaW5nUmVxdWVzdENhbGxiYWNrcy5sZW5ndGgpIHsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIG91dHN0YW5kaW5nUmVxdWVzdENhbGxiYWNrcy5wb3AoKSgpOwogICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAkbG9nLmVycm9yKGUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQogIH0KCiAgLyoqCiAgICogQHdvcmtJblByb2dyZXNzCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lIGFuZ3VsYXIuc2VydmljZS4kYnJvd3NlciN4aHIKICAgKiBAbWV0aG9kT2YgYW5ndWxhci5zZXJ2aWNlLiRicm93c2VyCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gbWV0aG9kIFJlcXVlc3RlZCBtZXRob2QgKGdldHxwb3N0fHB1dHxkZWxldGV8aGVhZHxqc29uKQogICAqIEBwYXJhbSB7c3RyaW5nfSB1cmwgUmVxdWVzdGVkIHVybAogICAqIEBwYXJhbSB7P3N0cmluZ30gcG9zdCBQb3N0IGRhdGEgdG8gc2VuZCAobnVsbCBpZiBub3RoaW5nIHRvIHBvc3QpCiAgICogQHBhcmFtIHtmdW5jdGlvbihudW1iZXIsIHN0cmluZywgZnVuY3Rpb24oW3N0cmluZ10pKX0gY2FsbGJhY2sgRnVuY3Rpb24gdGhhdCB3aWxsIGJlIGNhbGxlZCBvbgogICAqICAgcmVzcG9uc2UuIFRoZSB0aGlyZCBhcmd1bWVudCBpcyBhIGZ1bmN0aW9uIHRoYXQgY2FuIGJlIGNhbGxlZCB0byByZXR1cm4gYSBzcGVjaWZpZWQgcmVzcG9uc2UKICAgKiAgIGhlYWRlciBvciBhbiBPYmplY3QgY29udGFpbmluZyBhbGwgaGVhZGVycyAod2hlbiBjYWxsZWQgd2l0aCBubyBhcmd1bWVudHMpLgogICAqIEBwYXJhbSB7b2JqZWN0PX0gaGVhZGVyIGFkZGl0aW9uYWwgSFRUUCBoZWFkZXJzIHRvIHNlbmQgd2l0aCBYSFIuCiAgICogICBTdGFuZGFyZCBoZWFkZXJzIGFyZToKICAgKiAgIDx1bD4KICAgKiAgICAgPGxpPjx0dD5Db250ZW50LVR5cGU8L3R0PjogPHR0PmFwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZDwvdHQ+PC9saT4KICAgKiAgICAgPGxpPjx0dD5BY2NlcHQ8L3R0PjogPHR0PmFwcGxpY2F0aW9uL2pzb24sIHRleHQvcGxhaW4sICYjNDI7LyYjNDI7PC90dD48L2xpPgogICAqICAgICA8bGk+PHR0PlgtUmVxdWVzdGVkLVdpdGg8L3R0PjogPHR0PlhNTEh0dHBSZXF1ZXN0PC90dD48L2xpPgogICAqICAgPC91bD4KICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFNlbmQgYWpheCByZXF1ZXN0CiAgICovCiAgc2VsZi54aHIgPSBmdW5jdGlvbihtZXRob2QsIHVybCwgcG9zdCwgY2FsbGJhY2ssIGhlYWRlcnMpIHsKICAgIHZhciBwYXJzZWRIZWFkZXJzOwoKICAgIG91dHN0YW5kaW5nUmVxdWVzdENvdW50ICsrOwogICAgaWYgKGxvd2VyY2FzZShtZXRob2QpID09ICdqc29uJykgewogICAgICB2YXIgY2FsbGJhY2tJZCA9ICgiYW5ndWxhcl8iICsgTWF0aC5yYW5kb20oKSArICdfJyArIChpZENvdW50ZXIrKykpLnJlcGxhY2UoL1xkXC4vLCAnJyk7CiAgICAgIHdpbmRvd1tjYWxsYmFja0lkXSA9IGZ1bmN0aW9uKGRhdGEpIHsKICAgICAgICB3aW5kb3dbY2FsbGJhY2tJZF0uZGF0YSA9IGRhdGE7CiAgICAgIH07CgogICAgICB2YXIgc2NyaXB0ID0gc2VsZi5hZGRKcyh1cmwucmVwbGFjZSgnSlNPTl9DQUxMQkFDSycsIGNhbGxiYWNrSWQpLCBudWxsLCBmdW5jdGlvbigpIHsKICAgICAgICBpZiAod2luZG93W2NhbGxiYWNrSWRdLmRhdGEpIHsKICAgICAgICAgIGNvbXBsZXRlT3V0c3RhbmRpbmdSZXF1ZXN0KGNhbGxiYWNrLCAyMDAsIHdpbmRvd1tjYWxsYmFja0lkXS5kYXRhKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY29tcGxldGVPdXRzdGFuZGluZ1JlcXVlc3QoY2FsbGJhY2spOwogICAgICAgIH0KICAgICAgICBkZWxldGUgd2luZG93W2NhbGxiYWNrSWRdOwogICAgICAgIGJvZHlbMF0ucmVtb3ZlQ2hpbGQoc2NyaXB0KTsKICAgICAgfSk7CiAgICB9IGVsc2UgewogICAgICB2YXIgeGhyID0gbmV3IFhIUigpOwogICAgICB4aHIub3BlbihtZXRob2QsIHVybCwgdHJ1ZSk7CiAgICAgIGZvckVhY2goaGVhZGVycywgZnVuY3Rpb24odmFsdWUsIGtleSkgewogICAgICAgICAgaWYgKHZhbHVlKSB4aHIuc2V0UmVxdWVzdEhlYWRlcihrZXksIHZhbHVlKTsKICAgICAgfSk7CiAgICAgIHhoci5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBmdW5jdGlvbigpIHsKICAgICAgICBpZiAoeGhyLnJlYWR5U3RhdGUgPT0gNCkgewogICAgICAgICAgLy8gbm9ybWFsaXplIElFIGJ1ZyAoaHR0cDovL2J1Z3MuanF1ZXJ5LmNvbS90aWNrZXQvMTQ1MCkKICAgICAgICAgIHZhciBzdGF0dXMgPSB4aHIuc3RhdHVzID09IDEyMjMgPyAyMDQgOiB4aHIuc3RhdHVzIHx8IDIwMDsKICAgICAgICAgIGNvbXBsZXRlT3V0c3RhbmRpbmdSZXF1ZXN0KGNhbGxiYWNrLCBzdGF0dXMsIHhoci5yZXNwb25zZVRleHQsIGZ1bmN0aW9uKGhlYWRlcikgewogICAgICAgICAgICBoZWFkZXIgPSBsb3dlcmNhc2UoaGVhZGVyKTsKCiAgICAgICAgICAgIGlmIChoZWFkZXIpIHsKICAgICAgICAgICAgICByZXR1cm4gcGFyc2VkSGVhZGVycwogICAgICAgICAgICAgICAgPyBwYXJzZWRIZWFkZXJzW2hlYWRlcl0gfHwgbnVsbAogICAgICAgICAgICAgICAgOiB4aHIuZ2V0UmVzcG9uc2VIZWFkZXIoaGVhZGVyKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAvLyBSZXR1cm4gYW4gb2JqZWN0IGNvbnRhaW5pbmcgZWFjaCByZXNwb25zZSBoZWFkZXIKICAgICAgICAgICAgICBwYXJzZWRIZWFkZXJzID0ge307CgogICAgICAgICAgICAgIGZvckVhY2goeGhyLmdldEFsbFJlc3BvbnNlSGVhZGVycygpLnNwbGl0KCdcbicpLCBmdW5jdGlvbihsaW5lKSB7CiAgICAgICAgICAgICAgICB2YXIgaSA9IGxpbmUuaW5kZXhPZignOicpLAogICAgICAgICAgICAgICAgICAgIGtleSA9IGxvd2VyY2FzZSh0cmltKGxpbmUuc3Vic3RyKDAsIGkpKSksCiAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSB0cmltKGxpbmUuc3Vic3RyKGkgKyAxKSk7CgogICAgICAgICAgICAgICAgaWYgKHBhcnNlZEhlYWRlcnNba2V5XSkgewogICAgICAgICAgICAgICAgICAvLyBDb21iaW5lIHJlcGVhdGVkIGhlYWRlcnMKICAgICAgICAgICAgICAgICAgLy8gaHR0cDovL3d3dy53My5vcmcvUHJvdG9jb2xzL3JmYzI2MTYvcmZjMjYxNi1zZWM0Lmh0bWwjc2VjNC4yCiAgICAgICAgICAgICAgICAgIHBhcnNlZEhlYWRlcnNba2V5XSArPSAnLCAnICsgdmFsdWU7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBwYXJzZWRIZWFkZXJzW2tleV0gPSB2YWx1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgcmV0dXJuIHBhcnNlZEhlYWRlcnM7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfTsKICAgICAgeGhyLnNlbmQocG9zdCB8fCAnJyk7CiAgICB9CiAgfTsKCiAgLyoqCiAgICogQHByaXZhdGUKICAgKiBOb3RlOiB0aGlzIG1ldGhvZCBpcyB1c2VkIG9ubHkgYnkgc2NlbmFyaW8gcnVubmVyCiAgICogVE9ETyh2b2p0YSk6IHByZWZpeCB0aGlzIG1ldGhvZCB3aXRoICQkID8KICAgKiBAcGFyYW0ge2Z1bmN0aW9uKCl9IGNhbGxiYWNrIEZ1bmN0aW9uIHRoYXQgd2lsbCBiZSBjYWxsZWQgd2hlbiBubyBvdXRzdGFuZGluZyByZXF1ZXN0CiAgICovCiAgc2VsZi5ub3RpZnlXaGVuTm9PdXRzdGFuZGluZ1JlcXVlc3RzID0gZnVuY3Rpb24oY2FsbGJhY2spIHsKICAgIC8vIGZvcmNlIGJyb3dzZXIgdG8gZXhlY3V0ZSBhbGwgcG9sbEZucyAtIHRoaXMgaXMgbmVlZGVkIHNvIHRoYXQgY29va2llcyBhbmQgb3RoZXIgcG9sbGVycyBmaXJlCiAgICAvLyBhdCBzb21lIGRldGVybWluaXN0aWMgdGltZSBpbiByZXNwZWN0IHRvIHRoZSB0ZXN0IHJ1bm5lcidzIGFjdGlvbnMuIExlYXZpbmcgdGhpbmdzIHVwIHRvIHRoZQogICAgLy8gcmVndWxhciBwb2xsZXIgd291bGQgcmVzdWx0IGluIGZsYWt5IHRlc3RzLgogICAgZm9yRWFjaChwb2xsRm5zLCBmdW5jdGlvbihwb2xsRm4peyBwb2xsRm4oKTsgfSk7CgogICAgaWYgKG91dHN0YW5kaW5nUmVxdWVzdENvdW50ID09PSAwKSB7CiAgICAgIGNhbGxiYWNrKCk7CiAgICB9IGVsc2UgewogICAgICBvdXRzdGFuZGluZ1JlcXVlc3RDYWxsYmFja3MucHVzaChjYWxsYmFjayk7CiAgICB9CiAgfTsKCiAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICAvLyBQb2xsIFdhdGNoZXIgQVBJCiAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICB2YXIgcG9sbEZucyA9IFtdLAogICAgICBwb2xsVGltZW91dDsKCiAgLyoqCiAgICogQHdvcmtJblByb2dyZXNzCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lIGFuZ3VsYXIuc2VydmljZS4kYnJvd3NlciNhZGRQb2xsRm4KICAgKiBAbWV0aG9kT2YgYW5ndWxhci5zZXJ2aWNlLiRicm93c2VyCiAgICoKICAgKiBAcGFyYW0ge2Z1bmN0aW9uKCl9IGZuIFBvbGwgZnVuY3Rpb24gdG8gYWRkCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBBZGRzIGEgZnVuY3Rpb24gdG8gdGhlIGxpc3Qgb2YgZnVuY3Rpb25zIHRoYXQgcG9sbGVyIHBlcmlvZGljYWxseSBleGVjdXRlcywKICAgKiBhbmQgc3RhcnRzIHBvbGxpbmcgaWYgbm90IHN0YXJ0ZWQgeWV0LgogICAqCiAgICogQHJldHVybnMge2Z1bmN0aW9uKCl9IHRoZSBhZGRlZCBmdW5jdGlvbgogICAqLwogIHNlbGYuYWRkUG9sbEZuID0gZnVuY3Rpb24oZm4pIHsKICAgIGlmIChpc1VuZGVmaW5lZChwb2xsVGltZW91dCkpIHN0YXJ0UG9sbGVyKDEwMCwgc2V0VGltZW91dCk7CiAgICBwb2xsRm5zLnB1c2goZm4pOwogICAgcmV0dXJuIGZuOwogIH07CgogIC8qKgogICAqIEBwYXJhbSB7bnVtYmVyfSBpbnRlcnZhbCBIb3cgb2Z0ZW4gc2hvdWxkIGJyb3dzZXIgY2FsbCBwb2xsIGZ1bmN0aW9ucyAobXMpCiAgICogQHBhcmFtIHtmdW5jdGlvbigpfSBzZXRUaW1lb3V0IFJlZmVyZW5jZSB0byBhIHJlYWwgb3IgZmFrZSBgc2V0VGltZW91dGAgZnVuY3Rpb24uCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBDb25maWd1cmVzIHRoZSBwb2xsZXIgdG8gcnVuIGluIHRoZSBzcGVjaWZpZWQgaW50ZXJ2YWxzLCB1c2luZyB0aGUgc3BlY2lmaWVkCiAgICogc2V0VGltZW91dCBmbiBhbmQga2lja3MgaXQgb2ZmLgogICAqLwogIGZ1bmN0aW9uIHN0YXJ0UG9sbGVyKGludGVydmFsLCBzZXRUaW1lb3V0KSB7CiAgICAoZnVuY3Rpb24gY2hlY2soKSB7CiAgICAgIGZvckVhY2gocG9sbEZucywgZnVuY3Rpb24ocG9sbEZuKXsgcG9sbEZuKCk7IH0pOwogICAgICBwb2xsVGltZW91dCA9IHNldFRpbWVvdXQoY2hlY2ssIGludGVydmFsKTsKICAgIH0pKCk7CiAgfTsKCiAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICAvLyBVUkwgQVBJCiAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KCiAgLyoqCiAgICogQHdvcmtJblByb2dyZXNzCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lIGFuZ3VsYXIuc2VydmljZS4kYnJvd3NlciNzZXRVcmwKICAgKiBAbWV0aG9kT2YgYW5ndWxhci5zZXJ2aWNlLiRicm93c2VyCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gdXJsIE5ldyB1cmwKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFNldHMgYnJvd3NlcidzIHVybAogICAqLwogIHNlbGYuc2V0VXJsID0gZnVuY3Rpb24odXJsKSB7CgogICAgdmFyIGV4aXN0aW5nVVJMID0gbGFzdExvY2F0aW9uVXJsOwogICAgaWYgKCFleGlzdGluZ1VSTC5tYXRjaCgvIy8pKSBleGlzdGluZ1VSTCArPSAnIyc7CiAgICBpZiAoIXVybC5tYXRjaCgvIy8pKSB1cmwgKz0gJyMnOwogICAgaWYgKGV4aXN0aW5nVVJMICE9IHVybCkgewogICAgICBsb2NhdGlvbi5ocmVmID0gdXJsOwogICAgfQogICB9OwoKICAvKioKICAgKiBAd29ya0luUHJvZ3Jlc3MKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgYW5ndWxhci5zZXJ2aWNlLiRicm93c2VyI2dldFVybAogICAqIEBtZXRob2RPZiBhbmd1bGFyLnNlcnZpY2UuJGJyb3dzZXIKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIEdldCBjdXJyZW50IGJyb3dzZXIncyB1cmwKICAgKgogICAqIEByZXR1cm5zIHtzdHJpbmd9IEJyb3dzZXIncyB1cmwKICAgKi8KICBzZWxmLmdldFVybCA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIGxhc3RMb2NhdGlvblVybCA9IGxvY2F0aW9uLmhyZWY7CiAgfTsKCgogIC8qKgogICAqIEB3b3JrSW5Qcm9ncmVzcwogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSBhbmd1bGFyLnNlcnZpY2UuJGJyb3dzZXIjb25IYXNoQ2hhbmdlCiAgICogQG1ldGhvZE9mIGFuZ3VsYXIuc2VydmljZS4kYnJvd3NlcgogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogRGV0ZWN0cyBpZiBicm93c2VyIHN1cHBvcnQgb25oYXNoY2hhbmdlIGV2ZW50cyBhbmQgcmVnaXN0ZXIgYSBsaXN0ZW5lciBvdGhlcndpc2UgcmVnaXN0ZXJzCiAgICogJGJyb3dzZXIgcG9sbGVyLiBUaGUgYGxpc3RlbmVyYCB3aWxsIHRoZW4gZ2V0IGNhbGxlZCB3aGVuIHRoZSBoYXNoIGNoYW5nZXMuCiAgICoKICAgKiBUaGUgbGlzdGVuZXIgZ2V0cyBjYWxsZWQgd2l0aCBlaXRoZXIgSGFzaENoYW5nZUV2ZW50IG9iamVjdCBvciBzaW1wbGUgb2JqZWN0IHRoYXQgYWxzbyBjb250YWlucwogICAqIGBvbGRVUkxgIGFuZCBgbmV3VVJMYCBwcm9wZXJ0aWVzLgogICAqCiAgICogTm90ZTogdGhpcyBhcGkgaXMgaW50ZW5kZWQgZm9yIHVzZSBvbmx5IGJ5IHRoZSAkbG9jYXRpb24gc2VydmljZS4gUGxlYXNlIHVzZSB0aGUKICAgKiB7QGxpbmsgYW5ndWxhci5zZXJ2aWNlLiRsb2NhdGlvbiAkbG9jYXRpb24gc2VydmljZX0gdG8gbW9uaXRvciBoYXNoIGNoYW5nZXMgaW4gYW5ndWxhciBhcHBzLgogICAqCiAgICogQHBhcmFtIHtmdW5jdGlvbihldmVudCl9IGxpc3RlbmVyIExpc3RlbmVyIGZ1bmN0aW9uIHRvIGJlIGNhbGxlZCB3aGVuIHVybCBoYXNoIGNoYW5nZXMuCiAgICogQHJldHVybiB7ZnVuY3Rpb24oKX0gUmV0dXJucyB0aGUgcmVnaXN0ZXJlZCBsaXN0ZW5lciBmbiAtIGhhbmR5IGlmIHRoZSBmbiBpcyBhbm9ueW1vdXMuCiAgICovCiAgc2VsZi5vbkhhc2hDaGFuZ2UgPSBmdW5jdGlvbihsaXN0ZW5lcikgewogICAgLy8gSUU4IGNvbXAgbW9kZSByZXR1cm5zIHRydWUsIGJ1dCBkb2Vzbid0IHN1cHBvcnQgaGFzaGNoYW5nZSBldmVudAogICAgdmFyIGRtID0gd2luZG93LmRvY3VtZW50LmRvY3VtZW50TW9kZTsKICAgIGlmICgnb25oYXNoY2hhbmdlJyBpbiB3aW5kb3cgJiYgKGlzVW5kZWZpbmVkKGRtKSB8fCBkbSA+PSA4KSkgewogICAgICBqcUxpdGUod2luZG93KS5iaW5kKCdoYXNoY2hhbmdlJywgbGlzdGVuZXIpOwogICAgfSBlbHNlIHsKICAgICAgdmFyIGxhc3RCcm93c2VyVXJsID0gc2VsZi5nZXRVcmwoKTsKCiAgICAgIHNlbGYuYWRkUG9sbEZuKGZ1bmN0aW9uKCkgewogICAgICAgIGlmIChsYXN0QnJvd3NlclVybCAhPSBzZWxmLmdldFVybCgpKSB7CiAgICAgICAgICBsaXN0ZW5lcigpOwogICAgICAgICAgbGFzdEJyb3dzZXJVcmwgPSBzZWxmLmdldFVybCgpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgICByZXR1cm4gbGlzdGVuZXI7CiAgfTsKCiAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICAvLyBDb29raWVzIEFQSQogIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgdmFyIGxhc3RDb29raWVzID0ge307CiAgdmFyIGxhc3RDb29raWVTdHJpbmcgPSAnJzsKCiAgLyoqCiAgICogQHdvcmtJblByb2dyZXNzCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lIGFuZ3VsYXIuc2VydmljZS4kYnJvd3NlciNjb29raWVzCiAgICogQG1ldGhvZE9mIGFuZ3VsYXIuc2VydmljZS4kYnJvd3NlcgogICAqCiAgICogQHBhcmFtIHtzdHJpbmc9fSBuYW1lIENvb2tpZSBuYW1lCiAgICogQHBhcmFtIHtzdHJpbmc9fSB2YWx1ZSBDb2traWUgdmFsdWUKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFRoZSBjb29raWVzIG1ldGhvZCBwcm92aWRlcyBhICdwcml2YXRlJyBsb3cgbGV2ZWwgYWNjZXNzIHRvIGJyb3dzZXIgY29va2llcy4KICAgKiBJdCBpcyBub3QgbWVhbnQgdG8gYmUgdXNlZCBkaXJlY3RseSwgdXNlIHRoZSAkY29va2llIHNlcnZpY2UgaW5zdGVhZC4KICAgKgogICAqIFRoZSByZXR1cm4gdmFsdWVzIHZhcnkgZGVwZW5kaW5nIG9uIHRoZSBhcmd1bWVudHMgdGhhdCB0aGUgbWV0aG9kIHdhcyBjYWxsZWQgd2l0aCBhcyBmb2xsb3dzOgogICAqIDx1bD4KICAgKiAgIDxsaT5jb29raWVzKCkgLT4gaGFzaCBvZiBhbGwgY29va2llcywgdGhpcyBpcyBOT1QgYSBjb3B5IG9mIHRoZSBpbnRlcm5hbCBzdGF0ZSwgc28gZG8gbm90IG1vZGlmeSBpdDwvbGk+CiAgICogICA8bGk+Y29va2llcyhuYW1lLCB2YWx1ZSkgLT4gc2V0IG5hbWUgdG8gdmFsdWUsIGlmIHZhbHVlIGlzIHVuZGVmaW5lZCBkZWxldGUgdGhlIGNvb2tpZTwvbGk+CiAgICogICA8bGk+Y29va2llcyhuYW1lKSAtPiB0aGUgc2FtZSBhcyAobmFtZSwgdW5kZWZpbmVkKSA9PSBERUxFVEVTIChubyBvbmUgY2FsbHMgaXQgcmlnaHQgbm93IHRoYXQgd2F5KTwvbGk+CiAgICogPC91bD4KICAgKgogICAqIEByZXR1cm5zIHtPYmplY3R9IEhhc2ggb2YgYWxsIGNvb2tpZXMgKGlmIGNhbGxlZCB3aXRob3V0IGFueSBwYXJhbWV0ZXIpCiAgICovCiAgc2VsZi5jb29raWVzID0gZnVuY3Rpb24gKG5hbWUsIHZhbHVlKSB7CiAgICB2YXIgY29va2llTGVuZ3RoLCBjb29raWVBcnJheSwgY29va2llLCBpLCBrZXlWYWx1ZSwgaW5kZXg7CgogICAgaWYgKG5hbWUpIHsKICAgICAgaWYgKHZhbHVlID09PSB1bmRlZmluZWQpIHsKICAgICAgICByYXdEb2N1bWVudC5jb29raWUgPSBlc2NhcGUobmFtZSkgKyAiPTtleHBpcmVzPVRodSwgMDEgSmFuIDE5NzAgMDA6MDA6MDAgR01UIjsKICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAoaXNTdHJpbmcodmFsdWUpKSB7CiAgICAgICAgICByYXdEb2N1bWVudC5jb29raWUgPSBlc2NhcGUobmFtZSkgKyAnPScgKyBlc2NhcGUodmFsdWUpOwoKICAgICAgICAgIGNvb2tpZUxlbmd0aCA9IG5hbWUubGVuZ3RoICsgdmFsdWUubGVuZ3RoICsgMTsKICAgICAgICAgIGlmIChjb29raWVMZW5ndGggPiA0MDk2KSB7CiAgICAgICAgICAgICRsb2cud2FybigiQ29va2llICciKyBuYW1lICsiJyBwb3NzaWJseSBub3Qgc2V0IG9yIG92ZXJmbG93ZWQgYmVjYXVzZSBpdCB3YXMgdG9vIGxhcmdlICgiKwogICAgICAgICAgICAgIGNvb2tpZUxlbmd0aCArICIgPiA0MDk2IGJ5dGVzKSEiKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChsYXN0Q29va2llcy5sZW5ndGggPiAyMCkgewogICAgICAgICAgICAkbG9nLndhcm4oIkNvb2tpZSAnIisgbmFtZSArIicgcG9zc2libHkgbm90IHNldCBvciBvdmVyZmxvd2VkIGJlY2F1c2UgdG9vIG1hbnkgY29va2llcyAiICsKICAgICAgICAgICAgICAid2VyZSBhbHJlYWR5IHNldCAoIiArIGxhc3RDb29raWVzLmxlbmd0aCArICIgPiAyMCApIik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9IGVsc2UgewogICAgICBpZiAocmF3RG9jdW1lbnQuY29va2llICE9PSBsYXN0Q29va2llU3RyaW5nKSB7CiAgICAgICAgbGFzdENvb2tpZVN0cmluZyA9IHJhd0RvY3VtZW50LmNvb2tpZTsKICAgICAgICBjb29raWVBcnJheSA9IGxhc3RDb29raWVTdHJpbmcuc3BsaXQoIjsgIik7CiAgICAgICAgbGFzdENvb2tpZXMgPSB7fTsKCiAgICAgICAgZm9yIChpID0gMDsgaSA8IGNvb2tpZUFycmF5Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBjb29raWUgPSBjb29raWVBcnJheVtpXTsKICAgICAgICAgIGluZGV4ID0gY29va2llLmluZGV4T2YoJz0nKTsKICAgICAgICAgIGlmIChpbmRleCA+IDApIHsgLy9pZ25vcmUgbmFtZWxlc3MgY29va2llcwogICAgICAgICAgICBsYXN0Q29va2llc1t1bmVzY2FwZShjb29raWUuc3Vic3RyaW5nKDAsIGluZGV4KSldID0gdW5lc2NhcGUoY29va2llLnN1YnN0cmluZyhpbmRleCArIDEpKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIGxhc3RDb29raWVzOwogICAgfQogIH07CgoKICAvKioKICAgKiBAd29ya0luUHJvZ3Jlc3MKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgYW5ndWxhci5zZXJ2aWNlLiRicm93c2VyI2RlZmVyCiAgICogQG1ldGhvZE9mIGFuZ3VsYXIuc2VydmljZS4kYnJvd3NlcgogICAqIEBwYXJhbSB7ZnVuY3Rpb24oKX0gZm4gQSBmdW5jdGlvbiwgd2hvJ3MgZXhlY3V0aW9uIHNob3VsZCBiZSBkZWZlcmVkLgogICAqIEBwYXJhbSB7bnVtYmVyPX0gW2RlbGF5PTBdIG9mIG1pbGxpc2Vjb25kcyB0byBkZWZlciB0aGUgZnVuY3Rpb24gZXhlY3V0aW9uLgogICAqIEByZXR1cm5zIHsqfSBEZWZlcklkIHRoYXQgY2FuIGJlIHVzZWQgdG8gY2FuY2VsIHRoZSB0YXNrIHZpYSBgJGJyb3dzZXIuZGVmZXIuY2FuY2VsKClgLgogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogRXhlY3V0ZXMgYSBmbiBhc3luY2hyb25pb3VzbHkgdmlhIGBzZXRUaW1lb3V0KGZuLCBkZWxheSlgLgogICAqCiAgICogVW5saWtlIHdoZW4gY2FsbGluZyBgc2V0VGltZW91dGAgZGlyZWN0bHksIGluIHRlc3QgdGhpcyBmdW5jdGlvbiBpcyBtb2NrZWQgYW5kIGluc3RlYWQgb2YgdXNpbmcKICAgKiBgc2V0VGltZW91dGAgaW4gdGVzdHMsIHRoZSBmbnMgYXJlIHF1ZXVlZCBpbiBhbiBhcnJheSwgd2hpY2ggY2FuIGJlIHByb2dyYW1tYXRpY2FsbHkgZmx1c2hlZAogICAqIHZpYSBgJGJyb3dzZXIuZGVmZXIuZmx1c2goKWAuCiAgICoKICAgKi8KICBzZWxmLmRlZmVyID0gZnVuY3Rpb24oZm4sIGRlbGF5KSB7CiAgICB2YXIgdGltZW91dElkOwogICAgb3V0c3RhbmRpbmdSZXF1ZXN0Q291bnQrKzsKICAgIHRpbWVvdXRJZCA9IHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgIGRlbGV0ZSBwZW5kaW5nRGVmZXJJZHNbdGltZW91dElkXTsKICAgICAgY29tcGxldGVPdXRzdGFuZGluZ1JlcXVlc3QoZm4pOwogICAgfSwgZGVsYXkgfHwgMCk7CiAgICBwZW5kaW5nRGVmZXJJZHNbdGltZW91dElkXSA9IHRydWU7CiAgICByZXR1cm4gdGltZW91dElkOwogIH07CgoKICAvKioKICAgKiBUSElTIERPQyBJUyBOT1QgVklTSUJMRSBiZWNhdXNlIG5nZG9jcyBjYW4ndCBwcm9jZXNzIGRvY3MgZm9yIGZvbyNtZXRob2QubWV0aG9kCiAgICoKICAgKiBAbmFtZSBhbmd1bGFyLnNlcnZpY2UuJGJyb3dzZXIjZGVmZXIuY2FuY2VsCiAgICogQG1ldGhvZE9mIGFuZ3VsYXIuc2VydmljZS4kYnJvd3Nlci5kZWZlcgogICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgdGFzayBoYXNuJ3QgZXhlY3V0ZWQgeWV0IGFuZCB3YXMgc3VjY2Vzc2Z1bHkgY2FuY2VsZWQuCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBDYW5jZWxzIGEgZGVmZXJlZCB0YXNrIGlkZW50aWZpZWQgd2l0aCBgZGVmZXJJZGAuCiAgICovCgogIHNlbGYuZGVmZXIuY2FuY2VsID0gZnVuY3Rpb24oZGVmZXJJZCkgewogICAgaWYgKHBlbmRpbmdEZWZlcklkc1tkZWZlcklkXSkgewogICAgICBkZWxldGUgcGVuZGluZ0RlZmVySWRzW2RlZmVySWRdOwogICAgICBjbGVhclRpbWVvdXQoZGVmZXJJZCk7CiAgICAgIGNvbXBsZXRlT3V0c3RhbmRpbmdSZXF1ZXN0KG5vb3ApOwogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICB9OwoKCiAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICAvLyBNaXNjIEFQSQogIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgdmFyIGhvdmVyTGlzdGVuZXIgPSBub29wOwoKICAvKioKICAgKiBAd29ya0luUHJvZ3Jlc3MKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgYW5ndWxhci5zZXJ2aWNlLiRicm93c2VyI2hvdmVyCiAgICogQG1ldGhvZE9mIGFuZ3VsYXIuc2VydmljZS4kYnJvd3NlcgogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogU2V0IGhvdmVyIGxpc3RlbmVyLgogICAqCiAgICogQHBhcmFtIHtmdW5jdGlvbihPYmplY3QsIGJvb2xlYW4pfSBsaXN0ZW5lciBGdW5jdGlvbiB0aGF0IHdpbGwgYmUgY2FsbGVkIHdoZW4gYSBob3ZlciBldmVudAogICAqICAgIG9jY3Vycy4KICAgKi8KICBzZWxmLmhvdmVyID0gZnVuY3Rpb24obGlzdGVuZXIpIHsgaG92ZXJMaXN0ZW5lciA9IGxpc3RlbmVyOyB9OwoKICAvKioKICAgKiBAd29ya0luUHJvZ3Jlc3MKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgYW5ndWxhci5zZXJ2aWNlLiRicm93c2VyI2JpbmQKICAgKiBAbWV0aG9kT2YgYW5ndWxhci5zZXJ2aWNlLiRicm93c2VyCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBSZWdpc3RlciBob3ZlciBmdW5jdGlvbiB0byByZWFsIGJyb3dzZXIKICAgKi8KICBzZWxmLmJpbmQgPSBmdW5jdGlvbigpIHsKICAgIGRvY3VtZW50LmJpbmQoIm1vdXNlb3ZlciIsIGZ1bmN0aW9uKGV2ZW50KXsKICAgICAgaG92ZXJMaXN0ZW5lcihqcUxpdGUobXNpZSA/IGV2ZW50LnNyY0VsZW1lbnQgOiBldmVudC50YXJnZXQpLCB0cnVlKTsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9KTsKICAgIGRvY3VtZW50LmJpbmQoIm1vdXNlbGVhdmUgbW91c2VvdXQgY2xpY2sgZGJsY2xpY2sga2V5cHJlc3Mga2V5dXAiLCBmdW5jdGlvbihldmVudCl7CiAgICAgIGhvdmVyTGlzdGVuZXIoanFMaXRlKGV2ZW50LnRhcmdldCksIGZhbHNlKTsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9KTsKICB9OwoKCiAgLyoqCiAgICogQHdvcmtJblByb2dyZXNzCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lIGFuZ3VsYXIuc2VydmljZS4kYnJvd3NlciNhZGRDc3MKICAgKiBAbWV0aG9kT2YgYW5ndWxhci5zZXJ2aWNlLiRicm93c2VyCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gdXJsIFVybCB0byBjc3MgZmlsZQogICAqIEBkZXNjcmlwdGlvbgogICAqIEFkZHMgYSBzdHlsZXNoZWV0IHRhZyB0byB0aGUgaGVhZC4KICAgKi8KICBzZWxmLmFkZENzcyA9IGZ1bmN0aW9uKHVybCkgewogICAgdmFyIGxpbmsgPSBqcUxpdGUocmF3RG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnbGluaycpKTsKICAgIGxpbmsuYXR0cigncmVsJywgJ3N0eWxlc2hlZXQnKTsKICAgIGxpbmsuYXR0cigndHlwZScsICd0ZXh0L2NzcycpOwogICAgbGluay5hdHRyKCdocmVmJywgdXJsKTsKICAgIGJvZHkuYXBwZW5kKGxpbmspOwogIH07CgoKICAvKioKICAgKiBAd29ya0luUHJvZ3Jlc3MKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgYW5ndWxhci5zZXJ2aWNlLiRicm93c2VyI2FkZEpzCiAgICogQG1ldGhvZE9mIGFuZ3VsYXIuc2VydmljZS4kYnJvd3NlcgogICAqCiAgICogQHBhcmFtIHtzdHJpbmd9IHVybCBVcmwgdG8ganMgZmlsZQogICAqIEBwYXJhbSB7c3RyaW5nPX0gZG9tSWQgT3B0aW9uYWwgaWQgZm9yIHRoZSBzY3JpcHQgdGFnCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBBZGRzIGEgc2NyaXB0IHRhZyB0byB0aGUgaGVhZC4KICAgKi8KICBzZWxmLmFkZEpzID0gZnVuY3Rpb24odXJsLCBkb21JZCwgZG9uZSkgewogICAgLy8gd2UgY2FuJ3QgdXNlIGpRdWVyeS9qcUxpdGUgaGVyZSBiZWNhdXNlIGpRdWVyeSBkb2VzIGNyYXp5IHNoaXQgd2l0aCBzY3JpcHQgZWxlbWVudHMsIGUuZy46CiAgICAvLyAtIGZldGNoZXMgbG9jYWwgc2NyaXB0cyB2aWEgWEhSIGFuZCBldmFscyB0aGVtCiAgICAvLyAtIGFkZHMgYW5kIGltbWVkaWF0ZWx5IHJlbW92ZXMgc2NyaXB0IGVsZW1lbnRzIGZyb20gdGhlIGRvY3VtZW50CiAgICAvLwogICAgLy8gV2UgbmVlZCBhZGRKcyB0byBiZSBhYmxlIHRvIGFkZCBhbmd1bGFyLWllLWNvbXBhdC5qcyB3aGljaCBpcyB2ZXJ5IHNwZWNpYWwgYW5kIG11c3QgcmVtYWluCiAgICAvLyBwYXJ0IG9mIHRoZSBET00gc28gdGhhdCB0aGUgZW1iZWRkZWQgaW1hZ2VzIGNhbiByZWZlcmVuY2UgaXQuIGpRdWVyeSdzIGFwcGVuZCBpbXBsZW1lbnRhdGlvbgogICAgLy8gKHYxLjQuMikgZnViYXJzIGl0LgogICAgdmFyIHNjcmlwdCA9IHJhd0RvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NjcmlwdCcpOwoKICAgIHNjcmlwdC50eXBlID0gJ3RleHQvamF2YXNjcmlwdCc7CiAgICBzY3JpcHQuc3JjID0gdXJsOwogICAgaWYgKGRvbUlkKSBzY3JpcHQuaWQgPSBkb21JZDsKCiAgICBpZiAobXNpZSkgewogICAgICBzY3JpcHQub25yZWFkeXN0YXRlY2hhbmdlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgL2xvYWRlZHxjb21wbGV0ZS8udGVzdChzY3JpcHQucmVhZHlTdGF0ZSkgJiYgZG9uZSAmJiBkb25lKCk7CiAgICAgIH07CiAgICB9IGVsc2UgewogICAgICBpZiAoZG9uZSkgc2NyaXB0Lm9ubG9hZCA9IHNjcmlwdC5vbmVycm9yID0gZG9uZTsKICAgIH0KCiAgICBib2R5WzBdLmFwcGVuZENoaWxkKHNjcmlwdCk7CgogICAgcmV0dXJuIHNjcmlwdDsKICB9Owp9Cid1c2Ugc3RyaWN0JzsKCi8qCiAqIEhUTUwgUGFyc2VyIEJ5IE1pc2tvIEhldmVyeSAobWlza29AaGV2ZXJ5LmNvbSkKICogYmFzZWQgb246ICBIVE1MIFBhcnNlciBCeSBKb2huIFJlc2lnIChlam9obi5vcmcpCiAqIE9yaWdpbmFsIGNvZGUgYnkgRXJpayBBcnZpZHNzb24sIE1vemlsbGEgUHVibGljIExpY2Vuc2UKICogaHR0cDovL2VyaWsuZWFlLm5ldC9zaW1wbGVodG1scGFyc2VyL3NpbXBsZWh0bWxwYXJzZXIuanMKICoKICogLy8gVXNlIGxpa2Ugc286CiAqIGh0bWxQYXJzZXIoaHRtbFN0cmluZywgewogKiAgICAgc3RhcnQ6IGZ1bmN0aW9uKHRhZywgYXR0cnMsIHVuYXJ5KSB7fSwKICogICAgIGVuZDogZnVuY3Rpb24odGFnKSB7fSwKICogICAgIGNoYXJzOiBmdW5jdGlvbih0ZXh0KSB7fSwKICogICAgIGNvbW1lbnQ6IGZ1bmN0aW9uKHRleHQpIHt9CiAqIH0pOwogKgogKi8KCi8vIFJlZ3VsYXIgRXhwcmVzc2lvbnMgZm9yIHBhcnNpbmcgdGFncyBhbmQgYXR0cmlidXRlcwp2YXIgU1RBUlRfVEFHX1JFR0VYUCA9IC9ePFxzKihbXHc6LV0rKSgoPzpccytbXHc6LV0rKD86XHMqPVxzKig/Oig/OiJbXiJdKiIpfCg/OidbXiddKicpfFtePlxzXSspKT8pKilccyooXC8/KVxzKj4vLAogIEVORF9UQUdfUkVHRVhQID0gL148XHMqXC9ccyooW1x3Oi1dKylbXj5dKj4vLAogIEFUVFJfUkVHRVhQID0gLyhbXHc6LV0rKSg/OlxzKj1ccyooPzooPzoiKCg/OlteIl0pKikiKXwoPzonKCg/OlteJ10pKiknKXwoW14+XHNdKykpKT8vZywKICBCRUdJTl9UQUdfUkVHRVhQID0gL148LywKICBCRUdJTkdfRU5EX1RBR0VfUkVHRVhQID0gL148XHMqXC8vLAogIENPTU1FTlRfUkVHRVhQID0gLzwhLS0oLio/KS0tPi9nLAogIENEQVRBX1JFR0VYUCA9IC88IVxbQ0RBVEFcWyguKj8pXV0+L2csCiAgVVJJX1JFR0VYUCA9IC9eKChmdHB8aHR0cHM/KTpcL1wvfG1haWx0bzp8IykvLAogIE5PTl9BTFBIQU5VTUVSSUNfUkVHRVhQID0gLyhbXlwjLX58IHwhXSkvZzsgLy8gTWF0Y2ggZXZlcnl0aGluZyBvdXRzaWRlIG9mIG5vcm1hbCBjaGFycyBhbmQgIiAocXVvdGUgY2hhcmFjdGVyKQoKLy8gRW1wdHkgRWxlbWVudHMgLSBIVE1MIDQuMDEKdmFyIGVtcHR5RWxlbWVudHMgPSBtYWtlTWFwKCJhcmVhLGJyLGNvbCxocixpbWciKTsKCi8vIEJsb2NrIEVsZW1lbnRzIC0gSFRNTCA0LjAxCnZhciBibG9ja0VsZW1lbnRzID0gbWFrZU1hcCgiYWRkcmVzcyxibG9ja3F1b3RlLGNlbnRlcixkZCxkZWwsZGlyLGRpdixkbCxkdCwiKwogICAgImhyLGlucyxsaSxtYXAsbWVudSxvbCxwLHByZSxzY3JpcHQsdGFibGUsdGJvZHksdGQsdGZvb3QsdGgsdGhlYWQsdHIsdWwiKTsKCi8vIElubGluZSBFbGVtZW50cyAtIEhUTUwgNC4wMQp2YXIgaW5saW5lRWxlbWVudHMgPSBtYWtlTWFwKCJhLGFiYnIsYWNyb255bSxiLGJkbyxiaWcsYnIsY2l0ZSxjb2RlLGRlbCxkZm4sZW0sZm9udCxpLGltZywiKwogICAgImlucyxrYmQsbGFiZWwsbWFwLHEscyxzYW1wLHNtYWxsLHNwYW4sc3RyaWtlLHN0cm9uZyxzdWIsc3VwLHR0LHUsdmFyIik7Ci8vIEVsZW1lbnRzIHRoYXQgeW91IGNhbiwgaW50ZW50aW9uYWxseSwgbGVhdmUgb3BlbgovLyAoYW5kIHdoaWNoIGNsb3NlIHRoZW1zZWx2ZXMpCnZhciBjbG9zZVNlbGZFbGVtZW50cyA9IG1ha2VNYXAoImNvbGdyb3VwLGRkLGR0LGxpLHAsdGQsdGZvb3QsdGgsdGhlYWQsdHIiKTsKLy8gU3BlY2lhbCBFbGVtZW50cyAoY2FuIGNvbnRhaW4gYW55dGhpbmcpCnZhciBzcGVjaWFsRWxlbWVudHMgPSBtYWtlTWFwKCJzY3JpcHQsc3R5bGUiKTsKdmFyIHZhbGlkRWxlbWVudHMgPSBleHRlbmQoe30sIGVtcHR5RWxlbWVudHMsIGJsb2NrRWxlbWVudHMsIGlubGluZUVsZW1lbnRzLCBjbG9zZVNlbGZFbGVtZW50cyk7CgovL0F0dHJpYnV0ZXMgdGhhdCBoYXZlIGhyZWYgYW5kIGhlbmNlIG5lZWQgdG8gYmUgc2FuaXRpemVkCnZhciB1cmlBdHRycyA9IG1ha2VNYXAoImJhY2tncm91bmQsaHJlZixsb25nZGVzYyxzcmMsdXNlbWFwIik7CnZhciB2YWxpZEF0dHJzID0gZXh0ZW5kKHt9LCB1cmlBdHRycywgbWFrZU1hcCgKICAgICdhYmJyLGFsaWduLGFsdCxheGlzLGJnY29sb3IsYm9yZGVyLGNlbGxwYWRkaW5nLGNlbGxzcGFjaW5nLGNsYXNzLGNsZWFyLCcrCiAgICAnY29sb3IsY29scyxjb2xzcGFuLGNvbXBhY3QsY29vcmRzLGRpcixmYWNlLGhlYWRlcnMsaGVpZ2h0LGhyZWZsYW5nLGhzcGFjZSwnKwogICAgJ2lzbWFwLGxhbmcsbGFuZ3VhZ2Usbm9ocmVmLG5vd3JhcCxyZWwscmV2LHJvd3Mscm93c3BhbixydWxlcywnKwogICAgJ3Njb3BlLHNjcm9sbGluZyxzaGFwZSxzcGFuLHN0YXJ0LHN1bW1hcnksdGFyZ2V0LHRpdGxlLHR5cGUsJysKICAgICd2YWxpZ24sdmFsdWUsdnNwYWNlLHdpZHRoJykpOwoKLyoqCiAqIEBleGFtcGxlCiAqIGh0bWxQYXJzZXIoaHRtbFN0cmluZywgewogKiAgICAgc3RhcnQ6IGZ1bmN0aW9uKHRhZywgYXR0cnMsIHVuYXJ5KSB7fSwKICogICAgIGVuZDogZnVuY3Rpb24odGFnKSB7fSwKICogICAgIGNoYXJzOiBmdW5jdGlvbih0ZXh0KSB7fSwKICogICAgIGNvbW1lbnQ6IGZ1bmN0aW9uKHRleHQpIHt9CiAqIH0pOwogKgogKiBAcGFyYW0ge3N0cmluZ30gaHRtbCBzdHJpbmcKICogQHBhcmFtIHtvYmplY3R9IGhhbmRsZXIKICovCmZ1bmN0aW9uIGh0bWxQYXJzZXIoIGh0bWwsIGhhbmRsZXIgKSB7CiAgdmFyIGluZGV4LCBjaGFycywgbWF0Y2gsIHN0YWNrID0gW10sIGxhc3QgPSBodG1sOwogIHN0YWNrLmxhc3QgPSBmdW5jdGlvbigpeyByZXR1cm4gc3RhY2tbIHN0YWNrLmxlbmd0aCAtIDEgXTsgfTsKCiAgd2hpbGUgKCBodG1sICkgewogICAgY2hhcnMgPSB0cnVlOwoKICAgIC8vIE1ha2Ugc3VyZSB3ZSdyZSBub3QgaW4gYSBzY3JpcHQgb3Igc3R5bGUgZWxlbWVudAogICAgaWYgKCAhc3RhY2subGFzdCgpIHx8ICFzcGVjaWFsRWxlbWVudHNbIHN0YWNrLmxhc3QoKSBdICkgewoKICAgICAgLy8gQ29tbWVudAogICAgICBpZiAoIGh0bWwuaW5kZXhPZigiPCEtLSIpID09PSAwICkgewogICAgICAgIGluZGV4ID0gaHRtbC5pbmRleE9mKCItLT4iKTsKCiAgICAgICAgaWYgKCBpbmRleCA+PSAwICkgewogICAgICAgICAgaWYgKGhhbmRsZXIuY29tbWVudCkgaGFuZGxlci5jb21tZW50KCBodG1sLnN1YnN0cmluZyggNCwgaW5kZXggKSApOwogICAgICAgICAgaHRtbCA9IGh0bWwuc3Vic3RyaW5nKCBpbmRleCArIDMgKTsKICAgICAgICAgIGNoYXJzID0gZmFsc2U7CiAgICAgICAgfQoKICAgICAgLy8gZW5kIHRhZwogICAgICB9IGVsc2UgaWYgKCBCRUdJTkdfRU5EX1RBR0VfUkVHRVhQLnRlc3QoaHRtbCkgKSB7CiAgICAgICAgbWF0Y2ggPSBodG1sLm1hdGNoKCBFTkRfVEFHX1JFR0VYUCApOwoKICAgICAgICBpZiAoIG1hdGNoICkgewogICAgICAgICAgaHRtbCA9IGh0bWwuc3Vic3RyaW5nKCBtYXRjaFswXS5sZW5ndGggKTsKICAgICAgICAgIG1hdGNoWzBdLnJlcGxhY2UoIEVORF9UQUdfUkVHRVhQLCBwYXJzZUVuZFRhZyApOwogICAgICAgICAgY2hhcnMgPSBmYWxzZTsKICAgICAgICB9CgogICAgICAvLyBzdGFydCB0YWcKICAgICAgfSBlbHNlIGlmICggQkVHSU5fVEFHX1JFR0VYUC50ZXN0KGh0bWwpICkgewogICAgICAgIG1hdGNoID0gaHRtbC5tYXRjaCggU1RBUlRfVEFHX1JFR0VYUCApOwoKICAgICAgICBpZiAoIG1hdGNoICkgewogICAgICAgICAgaHRtbCA9IGh0bWwuc3Vic3RyaW5nKCBtYXRjaFswXS5sZW5ndGggKTsKICAgICAgICAgIG1hdGNoWzBdLnJlcGxhY2UoIFNUQVJUX1RBR19SRUdFWFAsIHBhcnNlU3RhcnRUYWcgKTsKICAgICAgICAgIGNoYXJzID0gZmFsc2U7CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAoIGNoYXJzICkgewogICAgICAgIGluZGV4ID0gaHRtbC5pbmRleE9mKCI8Iik7CgogICAgICAgIHZhciB0ZXh0ID0gaW5kZXggPCAwID8gaHRtbCA6IGh0bWwuc3Vic3RyaW5nKCAwLCBpbmRleCApOwogICAgICAgIGh0bWwgPSBpbmRleCA8IDAgPyAiIiA6IGh0bWwuc3Vic3RyaW5nKCBpbmRleCApOwoKICAgICAgICBpZiAoaGFuZGxlci5jaGFycykgaGFuZGxlci5jaGFycyggZGVjb2RlRW50aXRpZXModGV4dCkgKTsKICAgICAgfQoKICAgIH0gZWxzZSB7CiAgICAgIGh0bWwgPSBodG1sLnJlcGxhY2UobmV3IFJlZ0V4cCgiKC4qKTxcXHMqXFwvXFxzKiIgKyBzdGFjay5sYXN0KCkgKyAiW14+XSo+IiwgJ2knKSwgZnVuY3Rpb24oYWxsLCB0ZXh0KXsKICAgICAgICB0ZXh0ID0gdGV4dC4KICAgICAgICAgIHJlcGxhY2UoQ09NTUVOVF9SRUdFWFAsICIkMSIpLgogICAgICAgICAgcmVwbGFjZShDREFUQV9SRUdFWFAsICIkMSIpOwoKICAgICAgICBpZiAoaGFuZGxlci5jaGFycykgaGFuZGxlci5jaGFycyggZGVjb2RlRW50aXRpZXModGV4dCkgKTsKCiAgICAgICAgcmV0dXJuICIiOwogICAgICB9KTsKCiAgICAgIHBhcnNlRW5kVGFnKCAiIiwgc3RhY2subGFzdCgpICk7CiAgICB9CgogICAgaWYgKCBodG1sID09IGxhc3QgKSB7CiAgICAgIHRocm93ICJQYXJzZSBFcnJvcjogIiArIGh0bWw7CiAgICB9CiAgICBsYXN0ID0gaHRtbDsKICB9CgogIC8vIENsZWFuIHVwIGFueSByZW1haW5pbmcgdGFncwogIHBhcnNlRW5kVGFnKCk7CgogIGZ1bmN0aW9uIHBhcnNlU3RhcnRUYWcoIHRhZywgdGFnTmFtZSwgcmVzdCwgdW5hcnkgKSB7CiAgICB0YWdOYW1lID0gbG93ZXJjYXNlKHRhZ05hbWUpOwogICAgaWYgKCBibG9ja0VsZW1lbnRzWyB0YWdOYW1lIF0gKSB7CiAgICAgIHdoaWxlICggc3RhY2subGFzdCgpICYmIGlubGluZUVsZW1lbnRzWyBzdGFjay5sYXN0KCkgXSApIHsKICAgICAgICBwYXJzZUVuZFRhZyggIiIsIHN0YWNrLmxhc3QoKSApOwogICAgICB9CiAgICB9CgogICAgaWYgKCBjbG9zZVNlbGZFbGVtZW50c1sgdGFnTmFtZSBdICYmIHN0YWNrLmxhc3QoKSA9PSB0YWdOYW1lICkgewogICAgICBwYXJzZUVuZFRhZyggIiIsIHRhZ05hbWUgKTsKICAgIH0KCiAgICB1bmFyeSA9IGVtcHR5RWxlbWVudHNbIHRhZ05hbWUgXSB8fCAhIXVuYXJ5OwoKICAgIGlmICggIXVuYXJ5ICkKICAgICAgc3RhY2sucHVzaCggdGFnTmFtZSApOwoKICAgIHZhciBhdHRycyA9IHt9OwoKICAgIHJlc3QucmVwbGFjZShBVFRSX1JFR0VYUCwgZnVuY3Rpb24obWF0Y2gsIG5hbWUsIGRvdWJsZVF1b3RlZFZhbHVlLCBzaW5nbGVRb3V0ZWRWYWx1ZSwgdW5xb3V0ZWRWYWx1ZSkgewogICAgICB2YXIgdmFsdWUgPSBkb3VibGVRdW90ZWRWYWx1ZQogICAgICAgIHx8IHNpbmdsZVFvdXRlZFZhbHVlCiAgICAgICAgfHwgdW5xb3V0ZWRWYWx1ZQogICAgICAgIHx8ICcnOwoKICAgICAgYXR0cnNbbmFtZV0gPSBkZWNvZGVFbnRpdGllcyh2YWx1ZSk7CiAgICB9KTsKICAgIGlmIChoYW5kbGVyLnN0YXJ0KSBoYW5kbGVyLnN0YXJ0KCB0YWdOYW1lLCBhdHRycywgdW5hcnkgKTsKICB9CgogIGZ1bmN0aW9uIHBhcnNlRW5kVGFnKCB0YWcsIHRhZ05hbWUgKSB7CiAgICB2YXIgcG9zID0gMCwgaTsKICAgIHRhZ05hbWUgPSBsb3dlcmNhc2UodGFnTmFtZSk7CiAgICBpZiAoIHRhZ05hbWUgKQogICAgICAvLyBGaW5kIHRoZSBjbG9zZXN0IG9wZW5lZCB0YWcgb2YgdGhlIHNhbWUgdHlwZQogICAgICBmb3IgKCBwb3MgPSBzdGFjay5sZW5ndGggLSAxOyBwb3MgPj0gMDsgcG9zLS0gKQogICAgICAgIGlmICggc3RhY2tbIHBvcyBdID09IHRhZ05hbWUgKQogICAgICAgICAgYnJlYWs7CgogICAgaWYgKCBwb3MgPj0gMCApIHsKICAgICAgLy8gQ2xvc2UgYWxsIHRoZSBvcGVuIGVsZW1lbnRzLCB1cCB0aGUgc3RhY2sKICAgICAgZm9yICggaSA9IHN0YWNrLmxlbmd0aCAtIDE7IGkgPj0gcG9zOyBpLS0gKQogICAgICAgIGlmIChoYW5kbGVyLmVuZCkgaGFuZGxlci5lbmQoIHN0YWNrWyBpIF0gKTsKCiAgICAgIC8vIFJlbW92ZSB0aGUgb3BlbiBlbGVtZW50cyBmcm9tIHRoZSBzdGFjawogICAgICBzdGFjay5sZW5ndGggPSBwb3M7CiAgICB9CiAgfQp9CgovKioKICogZGVjb2RlcyBhbGwgZW50aXRpZXMgaW50byByZWd1bGFyIHN0cmluZwogKiBAcGFyYW0gdmFsdWUKICogQHJldHVybnMge3N0cmluZ30gQSBzdHJpbmcgd2l0aCBkZWNvZGVkIGVudGl0aWVzLgogKi8KdmFyIGhpZGRlblByZT1kb2N1bWVudC5jcmVhdGVFbGVtZW50KCJwcmUiKTsKZnVuY3Rpb24gZGVjb2RlRW50aXRpZXModmFsdWUpIHsKICBoaWRkZW5QcmUuaW5uZXJIVE1MPXZhbHVlLnJlcGxhY2UoLzwvZywiJmx0OyIpOwogIHJldHVybiBoaWRkZW5QcmUuaW5uZXJUZXh0IHx8IGhpZGRlblByZS50ZXh0Q29udGVudCB8fCAnJzsKfQoKLyoqCiAqIEVzY2FwZXMgYWxsIHBvdGVudGlhbGx5IGRhbmdlcm91cyBjaGFyYWN0ZXJzLCBzbyB0aGF0IHRoZQogKiByZXN1bHRpbmcgc3RyaW5nIGNhbiBiZSBzYWZlbHkgaW5zZXJ0ZWQgaW50byBhdHRyaWJ1dGUgb3IKICogZWxlbWVudCB0ZXh0LgogKiBAcGFyYW0gdmFsdWUKICogQHJldHVybnMgZXNjYXBlZCB0ZXh0CiAqLwpmdW5jdGlvbiBlbmNvZGVFbnRpdGllcyh2YWx1ZSkgewogIHJldHVybiB2YWx1ZS4KICAgIHJlcGxhY2UoLyYvZywgJyZhbXA7JykuCiAgICByZXBsYWNlKE5PTl9BTFBIQU5VTUVSSUNfUkVHRVhQLCBmdW5jdGlvbih2YWx1ZSl7CiAgICAgIHJldHVybiAnJiMnICsgdmFsdWUuY2hhckNvZGVBdCgwKSArICc7JzsKICAgIH0pLgogICAgcmVwbGFjZSgvPC9nLCAnJmx0OycpLgogICAgcmVwbGFjZSgvPi9nLCAnJmd0OycpOwp9CgovKioKICogY3JlYXRlIGFuIEhUTUwvWE1MIHdyaXRlciB3aGljaCB3cml0ZXMgdG8gYnVmZmVyCiAqIEBwYXJhbSB7QXJyYXl9IGJ1ZiB1c2UgYnVmLmphaW4oJycpIHRvIGdldCBvdXQgc2FuaXRpemVkIGh0bWwgc3RyaW5nCiAqIEByZXR1cm5zIHtvYmplY3R9IGluIHRoZSBmb3JtIG9mIHsKICogICAgIHN0YXJ0OiBmdW5jdGlvbih0YWcsIGF0dHJzLCB1bmFyeSkge30sCiAqICAgICBlbmQ6IGZ1bmN0aW9uKHRhZykge30sCiAqICAgICBjaGFyczogZnVuY3Rpb24odGV4dCkge30sCiAqICAgICBjb21tZW50OiBmdW5jdGlvbih0ZXh0KSB7fQogKiB9CiAqLwpmdW5jdGlvbiBodG1sU2FuaXRpemVXcml0ZXIoYnVmKXsKICB2YXIgaWdub3JlID0gZmFsc2U7CiAgdmFyIG91dCA9IGJpbmQoYnVmLCBidWYucHVzaCk7CiAgcmV0dXJuIHsKICAgIHN0YXJ0OiBmdW5jdGlvbih0YWcsIGF0dHJzLCB1bmFyeSl7CiAgICAgIHRhZyA9IGxvd2VyY2FzZSh0YWcpOwogICAgICBpZiAoIWlnbm9yZSAmJiBzcGVjaWFsRWxlbWVudHNbdGFnXSkgewogICAgICAgIGlnbm9yZSA9IHRhZzsKICAgICAgfQogICAgICBpZiAoIWlnbm9yZSAmJiB2YWxpZEVsZW1lbnRzW3RhZ10gPT0gdHJ1ZSkgewogICAgICAgIG91dCgnPCcpOwogICAgICAgIG91dCh0YWcpOwogICAgICAgIGZvckVhY2goYXR0cnMsIGZ1bmN0aW9uKHZhbHVlLCBrZXkpewogICAgICAgICAgdmFyIGxrZXk9bG93ZXJjYXNlKGtleSk7CiAgICAgICAgICBpZiAodmFsaWRBdHRyc1tsa2V5XT09dHJ1ZSAmJiAodXJpQXR0cnNbbGtleV0hPT10cnVlIHx8IHZhbHVlLm1hdGNoKFVSSV9SRUdFWFApKSkgewogICAgICAgICAgICBvdXQoJyAnKTsKICAgICAgICAgICAgb3V0KGtleSk7CiAgICAgICAgICAgIG91dCgnPSInKTsKICAgICAgICAgICAgb3V0KGVuY29kZUVudGl0aWVzKHZhbHVlKSk7CiAgICAgICAgICAgIG91dCgnIicpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIG91dCh1bmFyeSA/ICcvPicgOiAnPicpOwogICAgICB9CiAgICB9LAogICAgZW5kOiBmdW5jdGlvbih0YWcpewogICAgICAgIHRhZyA9IGxvd2VyY2FzZSh0YWcpOwogICAgICAgIGlmICghaWdub3JlICYmIHZhbGlkRWxlbWVudHNbdGFnXSA9PSB0cnVlKSB7CiAgICAgICAgICBvdXQoJzwvJyk7CiAgICAgICAgICBvdXQodGFnKTsKICAgICAgICAgIG91dCgnPicpOwogICAgICAgIH0KICAgICAgICBpZiAodGFnID09IGlnbm9yZSkgewogICAgICAgICAgaWdub3JlID0gZmFsc2U7CiAgICAgICAgfQogICAgICB9LAogICAgY2hhcnM6IGZ1bmN0aW9uKGNoYXJzKXsKICAgICAgICBpZiAoIWlnbm9yZSkgewogICAgICAgICAgb3V0KGVuY29kZUVudGl0aWVzKGNoYXJzKSk7CiAgICAgICAgfQogICAgICB9CiAgfTsKfQondXNlIHN0cmljdCc7CgovLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCi8vSlFMaXRlCi8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KCi8qKgogKiBAd29ya0luUHJvZ3Jlc3MKICogQG5nZG9jIGZ1bmN0aW9uCiAqIEBuYW1lIGFuZ3VsYXIuZWxlbWVudAogKiBAZnVuY3Rpb24KICoKICogQGRlc2NyaXB0aW9uCiAqIFdyYXBzIGEgcmF3IERPTSBlbGVtZW50IG9yIEhUTUwgc3RyaW5nIGFzIFtqUXVlcnldKGh0dHA6Ly9qcXVlcnkuY29tKSBlbGVtZW50LgogKiBgYW5ndWxhci5lbGVtZW50YCBpcyBlaXRoZXIgYW4gYWxpYXMgZm9yIFtqUXVlcnldKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9qUXVlcnkvKSBmdW5jdGlvbiBpZgogKiBqUXVlcnkgaXMgbG9hZGVkIG9yIGEgZnVuY3Rpb24gdGhhdCB3cmFwcyB0aGUgZWxlbWVudCBvciBzdHJpbmcgaW4gYW5ndWxhcidzIGpRdWVyeSBsaXRlCiAqIGltcGxlbWVudGF0aW9uLgogKgogKiBSZWFsIGpRdWVyeSBhbHdheXMgdGFrZXMgcHJlY2VkZW5jZSAoYXMgbG9uZyBhcyBpdCB3YXMgbG9hZGVkIGJlZm9yZSBgRE9NQ29udGVudEV2ZW50YCkKICoKICogQW5ndWxhcidzIGpRdWVyeSBsaXRlIGltcGxlbWVudGF0aW9uIGlzIGEgdGlueSBBUEktY29tcGF0aWJsZSBzdWJzZXQgb2YgalF1ZXJ5IHdoaWNoIGFsbG93cwogKiBhbmd1bGFyIHRvIG1hbmlwdWxhdGUgRE9NLiBUaGUgalF1ZXJ5IGxpdGUgaW1wbGVtZW50cyBvbmx5IGEgc3Vic2V0IG9mIGpRdWVyeSBhcGksIHdpdGggdGhlCiAqIGZvY3VzIG9uIHRoZSBtb3N0IGNvbW1vbmx5IG5lZWRlZCBmdW5jdGlvbmFsaXR5IGFuZCBtaW5pbWFsIGZvb3RwcmludC4gRm9yIHRoaXMgcmVhc29uIG9ubHkgYQogKiBsaW1pdGVkIG51bWJlciBvZiBqUXVlcnkgbWV0aG9kcywgYXJndW1lbnRzIGFuZCBpbnZvY2F0aW9uIHN0eWxlcyBhcmUgc3VwcG9ydGVkLgogKgogKiBOb3RlOiBBbGwgZWxlbWVudCByZWZlcmVuY2VzIGluIGFuZ3VsYXIgYXJlIGFsd2F5cyB3cmFwcGVkIHdpdGggalF1ZXJ5IChsaXRlKSBhbmQgYXJlIG5ldmVyCiAqIHJhdyBET00gcmVmZXJlbmNlcy4KICoKICogIyMgQW5ndWxhcidzIGpRdWVyeSBsaXRlIGltcGxlbWVudHMgdGhlc2UgZnVuY3Rpb25zOgogKgogKiAtIFthZGRDbGFzcygpXShodHRwOi8vYXBpLmpxdWVyeS5jb20vYWRkQ2xhc3MvKQogKiAtIFthZnRlcigpXShodHRwOi8vYXBpLmpxdWVyeS5jb20vYWZ0ZXIvKQogKiAtIFthcHBlbmQoKV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL2FwcGVuZC8pCiAqIC0gW2F0dHIoKV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL2F0dHIvKQogKiAtIFtiaW5kKCldKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9iaW5kLykKICogLSBbY2hpbGRyZW4oKV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL2NoaWxkcmVuLykKICogLSBbY2xvbmUoKV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL2Nsb25lLykKICogLSBbY3NzKCldKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9jc3MvKQogKiAtIFtkYXRhKCldKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9kYXRhLykKICogLSBbaGFzQ2xhc3MoKV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL2hhc0NsYXNzLykKICogLSBbcGFyZW50KCldKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9wYXJlbnQvKQogKiAtIFtyZW1vdmUoKV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL3JlbW92ZS8pCiAqIC0gW3JlbW92ZUF0dHIoKV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL3JlbW92ZUF0dHIvKQogKiAtIFtyZW1vdmVDbGFzcygpXShodHRwOi8vYXBpLmpxdWVyeS5jb20vcmVtb3ZlQ2xhc3MvKQogKiAtIFtyZW1vdmVEYXRhKCldKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9yZW1vdmVEYXRhLykKICogLSBbcmVwbGFjZVdpdGgoKV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL3JlcGxhY2VXaXRoLykKICogLSBbdGV4dCgpXShodHRwOi8vYXBpLmpxdWVyeS5jb20vdGV4dC8pCiAqIC0gW3RyaWdnZXIoKV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL3RyaWdnZXIvKQogKiAtIFtlcSgpXShodHRwOi8vYXBpLmpxdWVyeS5jb20vZXEvKQogKgogKiAjIyBBZGRpdGlvbmFsbHkgdGhlc2UgbWV0aG9kcyBleHRlbmQgdGhlIGpRdWVyeSBhbmQgIGFyZSBhdmFpbGFibGUgaW4gYm90aCBqUXVlcnkgYW5kIGpRdWVyeSBsaXRlCiAqIHZlcnNpb246CiAqCiAqLSBgc2NvcGUoKWAgLSByZXRyaWV2ZXMgdGhlIGN1cnJlbnQgYW5ndWxhciBzY29wZSBvZiB0aGUgZWxlbWVudC4KICoKICogQHBhcmFtIHtzdHJpbmd8RE9NRWxlbWVudH0gZWxlbWVudCBIVE1MIHN0cmluZyBvciBET01FbGVtZW50IHRvIGJlIHdyYXBwZWQgaW50byBqUXVlcnkuCiAqIEByZXR1cm5zIHtPYmplY3R9IGpRdWVyeSBvYmplY3QuCiAqLwoKdmFyIGpxQ2FjaGUgPSB7fSwKICAgIGpxTmFtZSA9ICduZy0nICsgbmV3IERhdGUoKS5nZXRUaW1lKCksCiAgICBqcUlkID0gMSwKICAgIGFkZEV2ZW50TGlzdGVuZXJGbiA9ICh3aW5kb3cuZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcgogICAgICA/IGZ1bmN0aW9uKGVsZW1lbnQsIHR5cGUsIGZuKSB7ZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKHR5cGUsIGZuLCBmYWxzZSk7fQogICAgICA6IGZ1bmN0aW9uKGVsZW1lbnQsIHR5cGUsIGZuKSB7ZWxlbWVudC5hdHRhY2hFdmVudCgnb24nICsgdHlwZSwgZm4pO30pLAogICAgcmVtb3ZlRXZlbnRMaXN0ZW5lckZuID0gKHdpbmRvdy5kb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyCiAgICAgID8gZnVuY3Rpb24oZWxlbWVudCwgdHlwZSwgZm4pIHtlbGVtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIodHlwZSwgZm4sIGZhbHNlKTsgfQogICAgICA6IGZ1bmN0aW9uKGVsZW1lbnQsIHR5cGUsIGZuKSB7ZWxlbWVudC5kZXRhY2hFdmVudCgnb24nICsgdHlwZSwgZm4pOyB9KTsKCmZ1bmN0aW9uIGpxTmV4dElkKCkgeyByZXR1cm4gKGpxSWQrKyk7IH0KCgpmdW5jdGlvbiBnZXRTdHlsZShlbGVtZW50KSB7CiAgdmFyIGN1cnJlbnQgPSB7fSwgc3R5bGUgPSBlbGVtZW50WzBdLnN0eWxlLCB2YWx1ZSwgbmFtZSwgaTsKICBpZiAodHlwZW9mIHN0eWxlLmxlbmd0aCA9PSAnbnVtYmVyJykgewogICAgZm9yKGkgPSAwOyBpIDwgc3R5bGUubGVuZ3RoOyBpKyspIHsKICAgICAgbmFtZSA9IHN0eWxlW2ldOwogICAgICBjdXJyZW50W25hbWVdID0gc3R5bGVbbmFtZV07CiAgICB9CiAgfSBlbHNlIHsKICAgIGZvciAobmFtZSBpbiBzdHlsZSkgewogICAgICB2YWx1ZSA9IHN0eWxlW25hbWVdOwogICAgICBpZiAoMSpuYW1lICE9IG5hbWUgJiYgbmFtZSAhPSAnY3NzVGV4dCcgJiYgdmFsdWUgJiYgdHlwZW9mIHZhbHVlID09ICdzdHJpbmcnICYmIHZhbHVlICE9J2ZhbHNlJykKICAgICAgICBjdXJyZW50W25hbWVdID0gdmFsdWU7CiAgICB9CiAgfQogIHJldHVybiBjdXJyZW50Owp9CgovLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KZnVuY3Rpb24ganFMaXRlV3JhcChlbGVtZW50KSB7CiAgaWYgKGlzU3RyaW5nKGVsZW1lbnQpICYmIGVsZW1lbnQuY2hhckF0KDApICE9ICc8JykgewogICAgdGhyb3cgbmV3IEVycm9yKCdzZWxlY3RvcnMgbm90IGltcGxlbWVudGVkJyk7CiAgfQogIHJldHVybiBuZXcgSlFMaXRlKGVsZW1lbnQpOwp9CgpmdW5jdGlvbiBKUUxpdGUoZWxlbWVudCkgewogIGlmIChlbGVtZW50IGluc3RhbmNlb2YgSlFMaXRlKSB7CiAgICByZXR1cm4gZWxlbWVudDsKICB9IGVsc2UgaWYgKGlzU3RyaW5nKGVsZW1lbnQpKSB7CiAgICB2YXIgZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAvLyBSZWFkIGFib3V0IHRoZSBOb1Njb3BlIGVsZW1lbnRzIGhlcmU6CiAgICAvLyBodHRwOi8vbXNkbi5taWNyb3NvZnQuY29tL2VuLXVzL2xpYnJhcnkvbXM1MzM4OTcoVlMuODUpLmFzcHgKICAgIGRpdi5pbm5lckhUTUwgPSAnPGRpdj4mbmJzcDs8L2Rpdj4nICsgZWxlbWVudDsgLy8gSUUgaW5zYW5pdHkgdG8gbWFrZSBOb1Njb3BlIGVsZW1lbnRzIHdvcmshCiAgICBkaXYucmVtb3ZlQ2hpbGQoZGl2LmZpcnN0Q2hpbGQpOyAvLyByZW1vdmUgdGhlIHN1cGVyZmx1b3VzIGRpdgogICAgSlFMaXRlQWRkTm9kZXModGhpcywgZGl2LmNoaWxkTm9kZXMpOwogICAgdGhpcy5yZW1vdmUoKTsgLy8gZGV0YWNoIHRoZSBlbGVtZW50cyBmcm9tIHRoZSB0ZW1wb3JhcnkgRE9NIGRpdi4KICB9IGVsc2UgewogICAgSlFMaXRlQWRkTm9kZXModGhpcywgZWxlbWVudCk7CiAgfQp9CgpmdW5jdGlvbiBKUUxpdGVDbG9uZShlbGVtZW50KSB7CiAgcmV0dXJuIGVsZW1lbnQuY2xvbmVOb2RlKHRydWUpOwp9CgpmdW5jdGlvbiBKUUxpdGVEZWFsb2MoZWxlbWVudCl7CiAgSlFMaXRlUmVtb3ZlRGF0YShlbGVtZW50KTsKICBmb3IgKCB2YXIgaSA9IDAsIGNoaWxkcmVuID0gZWxlbWVudC5jaGlsZE5vZGVzIHx8IFtdOyBpIDwgY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHsKICAgIEpRTGl0ZURlYWxvYyhjaGlsZHJlbltpXSk7CiAgfQp9CgpmdW5jdGlvbiBKUUxpdGVSZW1vdmVEYXRhKGVsZW1lbnQpIHsKICB2YXIgY2FjaGVJZCA9IGVsZW1lbnRbanFOYW1lXSwKICBjYWNoZSA9IGpxQ2FjaGVbY2FjaGVJZF07CiAgaWYgKGNhY2hlKSB7CiAgICBmb3JFYWNoKGNhY2hlLmJpbmQgfHwge30sIGZ1bmN0aW9uKGZuLCB0eXBlKXsKICAgICAgcmVtb3ZlRXZlbnRMaXN0ZW5lckZuKGVsZW1lbnQsIHR5cGUsIGZuKTsKICAgIH0pOwogICAgZGVsZXRlIGpxQ2FjaGVbY2FjaGVJZF07CiAgICBlbGVtZW50W2pxTmFtZV0gPSB1bmRlZmluZWQ7IC8vIGllIGRvZXMgbm90IGFsbG93IGRlbGV0aW9uIG9mIGF0dHJpYnV0ZXMgb24gZWxlbWVudHMuCiAgfQp9CgpmdW5jdGlvbiBKUUxpdGVEYXRhKGVsZW1lbnQsIGtleSwgdmFsdWUpIHsKICB2YXIgY2FjaGVJZCA9IGVsZW1lbnRbanFOYW1lXSwKICAgICAgY2FjaGUgPSBqcUNhY2hlW2NhY2hlSWQgfHwgLTFdOwogIGlmIChpc0RlZmluZWQodmFsdWUpKSB7CiAgICBpZiAoIWNhY2hlKSB7CiAgICAgIGVsZW1lbnRbanFOYW1lXSA9IGNhY2hlSWQgPSBqcU5leHRJZCgpOwogICAgICBjYWNoZSA9IGpxQ2FjaGVbY2FjaGVJZF0gPSB7fTsKICAgIH0KICAgIGNhY2hlW2tleV0gPSB2YWx1ZTsKICB9IGVsc2UgewogICAgcmV0dXJuIGNhY2hlID8gY2FjaGVba2V5XSA6IG51bGw7CiAgfQp9CgpmdW5jdGlvbiBKUUxpdGVIYXNDbGFzcyhlbGVtZW50LCBzZWxlY3RvciwgXykgewogIC8vIHRoZSBhcmd1bWVudCAnXycgaXMgaW1wb3J0YW50LCBzaW5jZSBpdCBtYWtlcyB0aGUgZnVuY3Rpb24gaGF2ZSAzIGFyZ3VtZW50cywgd2hpY2gKICAvLyBpcyBuZWVkZWQgZm9yIGRlbGVnYXRlIGZ1bmN0aW9uIHRvIHJlYWxpemUgdGhlIHRoaXMgaXMgYSBnZXR0ZXIuCiAgdmFyIGNsYXNzTmFtZSA9ICIgIiArIHNlbGVjdG9yICsgIiAiOwogIHJldHVybiAoKCIgIiArIGVsZW1lbnQuY2xhc3NOYW1lICsgIiAiKS5yZXBsYWNlKC9bXG5cdF0vZywgIiAiKS5pbmRleE9mKCBjbGFzc05hbWUgKSA+IC0xKTsKfQoKZnVuY3Rpb24gSlFMaXRlUmVtb3ZlQ2xhc3MoZWxlbWVudCwgc2VsZWN0b3IpIHsKICBlbGVtZW50LmNsYXNzTmFtZSA9IHRyaW0oCiAgICAgICgiICIgKyBlbGVtZW50LmNsYXNzTmFtZSArICIgIikKICAgICAgLnJlcGxhY2UoL1tcblx0XS9nLCAiICIpCiAgICAgIC5yZXBsYWNlKCIgIiArIHNlbGVjdG9yICsgIiAiLCAiIikKICApOwp9CgpmdW5jdGlvbiBKUUxpdGVBZGRDbGFzcyhlbGVtZW50LCBzZWxlY3RvciApIHsKICBpZiAoIUpRTGl0ZUhhc0NsYXNzKGVsZW1lbnQsIHNlbGVjdG9yKSkgewogICAgZWxlbWVudC5jbGFzc05hbWUgPSB0cmltKGVsZW1lbnQuY2xhc3NOYW1lICsgJyAnICsgc2VsZWN0b3IpOwogIH0KfQoKZnVuY3Rpb24gSlFMaXRlQWRkTm9kZXMocm9vdCwgZWxlbWVudHMpIHsKICBpZiAoZWxlbWVudHMpIHsKICAgIGVsZW1lbnRzID0gKCFlbGVtZW50cy5ub2RlTmFtZSAmJiBpc0RlZmluZWQoZWxlbWVudHMubGVuZ3RoKSAmJiAhaXNXaW5kb3coZWxlbWVudHMpKQogICAgICA/IGVsZW1lbnRzCiAgICAgIDogWyBlbGVtZW50cyBdOwogICAgZm9yKHZhciBpPTA7IGkgPCBlbGVtZW50cy5sZW5ndGg7IGkrKykgewogICAgICByb290LnB1c2goZWxlbWVudHNbaV0pOwogICAgfQogIH0KfQoKLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCi8vIEZ1bmN0aW9ucyB3aGljaCBhcmUgZGVjbGFyZWQgZGlyZWN0bHkuCi8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwp2YXIgSlFMaXRlUHJvdG90eXBlID0gSlFMaXRlLnByb3RvdHlwZSA9IHsKICByZWFkeTogZnVuY3Rpb24oZm4pIHsKICAgIHZhciBmaXJlZCA9IGZhbHNlOwoKICAgIGZ1bmN0aW9uIHRyaWdnZXIoKSB7CiAgICAgIGlmIChmaXJlZCkgcmV0dXJuOwogICAgICBmaXJlZCA9IHRydWU7CiAgICAgIGZuKCk7CiAgICB9CgogICAgdGhpcy5iaW5kKCdET01Db250ZW50TG9hZGVkJywgdHJpZ2dlcik7IC8vIHdvcmtzIGZvciBtb2Rlcm4gYnJvd3NlcnMgYW5kIElFOQogICAgLy8gd2UgY2FuIG5vdCB1c2UganFMaXRlIHNpbmNlIHdlIGFyZSBub3QgZG9uZSBsb2FkaW5nIGFuZCBqUXVlcnkgY291bGQgYmUgbG9hZGVkIGxhdGVyLgogICAganFMaXRlV3JhcCh3aW5kb3cpLmJpbmQoJ2xvYWQnLCB0cmlnZ2VyKTsgLy8gZmFsbGJhY2sgdG8gd2luZG93Lm9ubG9hZCBmb3Igb3RoZXJzCiAgfSwKICB0b1N0cmluZzogZnVuY3Rpb24oKSB7CiAgICB2YXIgdmFsdWUgPSBbXTsKICAgIGZvckVhY2godGhpcywgZnVuY3Rpb24oZSl7IHZhbHVlLnB1c2goJycgKyBlKTt9KTsKICAgIHJldHVybiAnWycgKyB2YWx1ZS5qb2luKCcsICcpICsgJ10nOwogIH0sCgogIGVxOiBmdW5jdGlvbihpbmRleCkgewogICAgICByZXR1cm4gKGluZGV4ID49IDApID8ganFMaXRlKHRoaXNbaW5kZXhdKSA6IGpxTGl0ZSh0aGlzW3RoaXMubGVuZ3RoICsgaW5kZXhdKTsKICB9LAoKICBsZW5ndGg6IDAsCiAgcHVzaDogcHVzaCwKICBzb3J0OiBbXS5zb3J0LAogIHNwbGljZTogW10uc3BsaWNlCn07CgovLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KLy8gRnVuY3Rpb25zIGl0ZXJhdGluZyBnZXR0ZXIvc2V0dGVycy4KLy8gdGhlc2UgZnVuY3Rpb25zIHJldHVybiBzZWxmIG9uIHNldHRlciBhbmQKLy8gdmFsdWUgb24gZ2V0LgovLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KdmFyIFNQRUNJQUxfQVRUUiA9IG1ha2VNYXAoIm11bHRpcGxlLHNlbGVjdGVkLGNoZWNrZWQsZGlzYWJsZWQscmVhZG9ubHkiKTsKCmZvckVhY2goewogIGRhdGE6IEpRTGl0ZURhdGEsCgogIHNjb3BlOiBmdW5jdGlvbihlbGVtZW50KSB7CiAgICB2YXIgc2NvcGU7CiAgICB3aGlsZSAoZWxlbWVudCAmJiAhKHNjb3BlID0ganFMaXRlKGVsZW1lbnQpLmRhdGEoJCRzY29wZSkpKSB7CiAgICAgIGVsZW1lbnQgPSBlbGVtZW50LnBhcmVudE5vZGU7CiAgICB9CiAgICByZXR1cm4gc2NvcGU7CiAgfSwKCiAgcmVtb3ZlQXR0cjogZnVuY3Rpb24oZWxlbWVudCxuYW1lKSB7CiAgICBlbGVtZW50LnJlbW92ZUF0dHJpYnV0ZShuYW1lKTsKICB9LAoKICBoYXNDbGFzczogSlFMaXRlSGFzQ2xhc3MsCgogIGNzczogZnVuY3Rpb24oZWxlbWVudCwgbmFtZSwgdmFsdWUpIHsKICAgIGlmIChpc0RlZmluZWQodmFsdWUpKSB7CiAgICAgIGVsZW1lbnQuc3R5bGVbbmFtZV0gPSB2YWx1ZTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBlbGVtZW50LnN0eWxlW25hbWVdOwogICAgfQogIH0sCgogIGF0dHI6IGZ1bmN0aW9uKGVsZW1lbnQsIG5hbWUsIHZhbHVlKXsKICAgIGlmIChTUEVDSUFMX0FUVFJbbmFtZV0pIHsKICAgICAgaWYgKGlzRGVmaW5lZCh2YWx1ZSkpIHsKICAgICAgICBlbGVtZW50W25hbWVdID0gISF2YWx1ZTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gZWxlbWVudFtuYW1lXTsKICAgICAgfQogICAgfSBlbHNlIGlmIChpc0RlZmluZWQodmFsdWUpKSB7CiAgICAgIGVsZW1lbnQuc2V0QXR0cmlidXRlKG5hbWUsIHZhbHVlKTsKICAgIH0gZWxzZSBpZiAoZWxlbWVudC5nZXRBdHRyaWJ1dGUpIHsKICAgICAgLy8gdGhlIGV4dHJhIGFyZ3VtZW50ICIyIiBpcyB0byBnZXQgdGhlIHJpZ2h0IHRoaW5nIGZvciBhLmhyZWYgaW4gSUUsIHNlZSBqUXVlcnkgY29kZQogICAgICAvLyBzb21lIGVsZW1lbnRzIChlLmcuIERvY3VtZW50KSBkb24ndCBoYXZlIGdldCBhdHRyaWJ1dGUsIHNvIHJldHVybiB1bmRlZmluZWQKICAgICAgdmFyIHJldCA9IGVsZW1lbnQuZ2V0QXR0cmlidXRlKG5hbWUsIDIpOwogICAgICAvLyBub3JtYWxpemUgbm9uLWV4aXN0aW5nIGF0dHJpYnV0ZXMgdG8gdW5kZWZpbmVkIChhcyBqUXVlcnkpCiAgICAgIHJldHVybiByZXQgPT09IG51bGwgPyB1bmRlZmluZWQgOiByZXQ7CiAgICB9CiAgfSwKCiAgdGV4dDogZXh0ZW5kKChtc2llIDwgOSkKICAgICAgPyBmdW5jdGlvbihlbGVtZW50LCB2YWx1ZSkgewogICAgICAgIC8vIE5vZGVUeXBlID09IDMgaXMgdGV4dCBub2RlCiAgICAgICAgaWYgKGVsZW1lbnQubm9kZVR5cGUgPT0gMykgewogICAgICAgICAgaWYgKGlzVW5kZWZpbmVkKHZhbHVlKSkKICAgICAgICAgICAgcmV0dXJuIGVsZW1lbnQubm9kZVZhbHVlOwogICAgICAgICAgZWxlbWVudC5ub2RlVmFsdWUgPSB2YWx1ZTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgaWYgKGlzVW5kZWZpbmVkKHZhbHVlKSkKICAgICAgICAgICAgcmV0dXJuIGVsZW1lbnQuaW5uZXJUZXh0OwogICAgICAgICAgZWxlbWVudC5pbm5lclRleHQgPSB2YWx1ZTsKICAgICAgICB9CiAgICAgIH0KICAgICAgOiBmdW5jdGlvbihlbGVtZW50LCB2YWx1ZSkgewogICAgICAgIGlmIChpc1VuZGVmaW5lZCh2YWx1ZSkpIHsKICAgICAgICAgIHJldHVybiBlbGVtZW50LnRleHRDb250ZW50OwogICAgICAgIH0KICAgICAgICBlbGVtZW50LnRleHRDb250ZW50ID0gdmFsdWU7CiAgICAgIH0sIHskZHY6Jyd9KSwKCiAgdmFsOiBmdW5jdGlvbihlbGVtZW50LCB2YWx1ZSkgewogICAgaWYgKGlzVW5kZWZpbmVkKHZhbHVlKSkgewogICAgICByZXR1cm4gZWxlbWVudC52YWx1ZTsKICAgIH0KICAgIGVsZW1lbnQudmFsdWUgPSB2YWx1ZTsKICB9LAoKICBodG1sOiBmdW5jdGlvbihlbGVtZW50LCB2YWx1ZSkgewogICAgaWYgKGlzVW5kZWZpbmVkKHZhbHVlKSkgewogICAgICByZXR1cm4gZWxlbWVudC5pbm5lckhUTUw7CiAgICB9CiAgICBmb3IgKHZhciBpID0gMCwgY2hpbGROb2RlcyA9IGVsZW1lbnQuY2hpbGROb2RlczsgaSA8IGNoaWxkTm9kZXMubGVuZ3RoOyBpKyspIHsKICAgICAgSlFMaXRlRGVhbG9jKGNoaWxkTm9kZXNbaV0pOwogICAgfQogICAgZWxlbWVudC5pbm5lckhUTUwgPSB2YWx1ZTsKICB9Cn0sIGZ1bmN0aW9uKGZuLCBuYW1lKXsKICAvKioKICAgKiBQcm9wZXJ0aWVzOiB3cml0ZXMgcmV0dXJuIHNlbGVjdGlvbiwgcmVhZHMgcmV0dXJuIGZpcnN0IHZhbHVlCiAgICovCiAgSlFMaXRlLnByb3RvdHlwZVtuYW1lXSA9IGZ1bmN0aW9uKGFyZzEsIGFyZzIpIHsKICAgIHZhciBpLCBrZXk7CgogICAgaWYgKChmbi5sZW5ndGggPT0gMiA/IGFyZzEgOiBhcmcyKSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgIGlmIChpc09iamVjdChhcmcxKSkgewogICAgICAgIC8vIHdlIGFyZSBhIHdyaXRlLCBidXQgdGhlIG9iamVjdCBwcm9wZXJ0aWVzIGFyZSB0aGUga2V5L3ZhbHVlcwogICAgICAgIGZvcihpPTA7IGkgPCB0aGlzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBmb3IgKGtleSBpbiBhcmcxKSB7CiAgICAgICAgICAgIGZuKHRoaXNbaV0sIGtleSwgYXJnMVtrZXldKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgLy8gcmV0dXJuIHNlbGYgZm9yIGNoYWluaW5nCiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gd2UgYXJlIGEgcmVhZCwgc28gcmVhZCB0aGUgZmlyc3QgY2hpbGQuCiAgICAgICAgaWYgKHRoaXMubGVuZ3RoKQogICAgICAgICAgcmV0dXJuIGZuKHRoaXNbMF0sIGFyZzEsIGFyZzIpOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICAvLyB3ZSBhcmUgYSB3cml0ZSwgc28gYXBwbHkgdG8gYWxsIGNoaWxkcmVuCiAgICAgIGZvcihpPTA7IGkgPCB0aGlzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgZm4odGhpc1tpXSwgYXJnMSwgYXJnMik7CiAgICAgIH0KICAgICAgLy8gcmV0dXJuIHNlbGYgZm9yIGNoYWluaW5nCiAgICAgIHJldHVybiB0aGlzOwogICAgfQogICAgcmV0dXJuIGZuLiRkdjsKICB9Owp9KTsKCi8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwovLyBGdW5jdGlvbnMgaXRlcmF0aW5nIHRyYXZlcnNhbC4KLy8gVGhlc2UgZnVuY3Rpb25zIGNoYWluIHJlc3VsdHMgaW50byBhIHNpbmdsZQovLyBzZWxlY3Rvci4KLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCmZvckVhY2goewogIHJlbW92ZURhdGE6IEpRTGl0ZVJlbW92ZURhdGEsCgogIGRlYWxvYzogSlFMaXRlRGVhbG9jLAoKICBiaW5kOiBmdW5jdGlvbihlbGVtZW50LCB0eXBlLCBmbil7CiAgICB2YXIgYmluZCA9IEpRTGl0ZURhdGEoZWxlbWVudCwgJ2JpbmQnKTsKICAgIGlmICghYmluZCkgSlFMaXRlRGF0YShlbGVtZW50LCAnYmluZCcsIGJpbmQgPSB7fSk7CiAgICBmb3JFYWNoKHR5cGUuc3BsaXQoJyAnKSwgZnVuY3Rpb24odHlwZSl7CiAgICAgIHZhciBldmVudEhhbmRsZXIgPSBiaW5kW3R5cGVdOwogICAgICBpZiAoIWV2ZW50SGFuZGxlcikgewogICAgICAgIGJpbmRbdHlwZV0gPSBldmVudEhhbmRsZXIgPSBmdW5jdGlvbihldmVudCkgewogICAgICAgICAgaWYgKCFldmVudC5wcmV2ZW50RGVmYXVsdCkgewogICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCA9IGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICAgZXZlbnQucmV0dXJuVmFsdWUgPSBmYWxzZTsgLy9pZQogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgICAgaWYgKCFldmVudC5zdG9wUHJvcGFnYXRpb24pIHsKICAgICAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgZXZlbnQuY2FuY2VsQnViYmxlID0gdHJ1ZTsgLy9pZQogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgICAgaWYgKCFldmVudC50YXJnZXQpIHsKICAgICAgICAgICAgZXZlbnQudGFyZ2V0ID0gZXZlbnQuc3JjRWxlbWVudCB8fCBkb2N1bWVudDsKICAgICAgICAgIH0KICAgICAgICAgIGZvckVhY2goZXZlbnRIYW5kbGVyLmZucywgZnVuY3Rpb24oZm4pewogICAgICAgICAgICBmbi5jYWxsKGVsZW1lbnQsIGV2ZW50KTsKICAgICAgICAgIH0pOwogICAgICAgIH07CiAgICAgICAgZXZlbnRIYW5kbGVyLmZucyA9IFtdOwogICAgICAgIGFkZEV2ZW50TGlzdGVuZXJGbihlbGVtZW50LCB0eXBlLCBldmVudEhhbmRsZXIpOwogICAgICB9CiAgICAgIGV2ZW50SGFuZGxlci5mbnMucHVzaChmbik7CiAgICB9KTsKICB9LAoKICByZXBsYWNlV2l0aDogZnVuY3Rpb24oZWxlbWVudCwgcmVwbGFjZU5vZGUpIHsKICAgIHZhciBpbmRleCwgcGFyZW50ID0gZWxlbWVudC5wYXJlbnROb2RlOwogICAgSlFMaXRlRGVhbG9jKGVsZW1lbnQpOwogICAgZm9yRWFjaChuZXcgSlFMaXRlKHJlcGxhY2VOb2RlKSwgZnVuY3Rpb24obm9kZSl7CiAgICAgIGlmIChpbmRleCkgewogICAgICAgIHBhcmVudC5pbnNlcnRCZWZvcmUobm9kZSwgaW5kZXgubmV4dFNpYmxpbmcpOwogICAgICB9IGVsc2UgewogICAgICAgIHBhcmVudC5yZXBsYWNlQ2hpbGQobm9kZSwgZWxlbWVudCk7CiAgICAgIH0KICAgICAgaW5kZXggPSBub2RlOwogICAgfSk7CiAgfSwKCiAgY2hpbGRyZW46IGZ1bmN0aW9uKGVsZW1lbnQpIHsKICAgIHZhciBjaGlsZHJlbiA9IFtdOwogICAgZm9yRWFjaChlbGVtZW50LmNoaWxkTm9kZXMsIGZ1bmN0aW9uKGVsZW1lbnQpewogICAgICBpZiAoZWxlbWVudC5ub2RlTmFtZSAhPSAnI3RleHQnKQogICAgICAgIGNoaWxkcmVuLnB1c2goZWxlbWVudCk7CiAgICB9KTsKICAgIHJldHVybiBjaGlsZHJlbjsKICB9LAoKICBhcHBlbmQ6IGZ1bmN0aW9uKGVsZW1lbnQsIG5vZGUpIHsKICAgIGZvckVhY2gobmV3IEpRTGl0ZShub2RlKSwgZnVuY3Rpb24oY2hpbGQpewogICAgICBpZiAoZWxlbWVudC5ub2RlVHlwZSA9PT0gMSkKICAgICAgICBlbGVtZW50LmFwcGVuZENoaWxkKGNoaWxkKTsKICAgIH0pOwogIH0sCgogIHByZXBlbmQ6IGZ1bmN0aW9uKGVsZW1lbnQsIG5vZGUpIHsKICAgIGlmIChlbGVtZW50Lm5vZGVUeXBlID09PSAxKSB7CiAgICAgIHZhciBpbmRleCA9IGVsZW1lbnQuZmlyc3RDaGlsZDsKICAgICAgZm9yRWFjaChuZXcgSlFMaXRlKG5vZGUpLCBmdW5jdGlvbihjaGlsZCl7CiAgICAgICAgaWYgKGluZGV4KSB7CiAgICAgICAgICBlbGVtZW50Lmluc2VydEJlZm9yZShjaGlsZCwgaW5kZXgpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBlbGVtZW50LmFwcGVuZENoaWxkKGNoaWxkKTsKICAgICAgICAgIGluZGV4ID0gY2hpbGQ7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICB9LAoKICByZW1vdmU6IGZ1bmN0aW9uKGVsZW1lbnQpIHsKICAgIEpRTGl0ZURlYWxvYyhlbGVtZW50KTsKICAgIHZhciBwYXJlbnQgPSBlbGVtZW50LnBhcmVudE5vZGU7CiAgICBpZiAocGFyZW50KSBwYXJlbnQucmVtb3ZlQ2hpbGQoZWxlbWVudCk7CiAgfSwKCiAgYWZ0ZXI6IGZ1bmN0aW9uKGVsZW1lbnQsIG5ld0VsZW1lbnQpIHsKICAgIHZhciBpbmRleCA9IGVsZW1lbnQsIHBhcmVudCA9IGVsZW1lbnQucGFyZW50Tm9kZTsKICAgIGZvckVhY2gobmV3IEpRTGl0ZShuZXdFbGVtZW50KSwgZnVuY3Rpb24obm9kZSl7CiAgICAgIHBhcmVudC5pbnNlcnRCZWZvcmUobm9kZSwgaW5kZXgubmV4dFNpYmxpbmcpOwogICAgICBpbmRleCA9IG5vZGU7CiAgICB9KTsKICB9LAoKICBhZGRDbGFzczogSlFMaXRlQWRkQ2xhc3MsCiAgcmVtb3ZlQ2xhc3M6IEpRTGl0ZVJlbW92ZUNsYXNzLAoKICB0b2dnbGVDbGFzczogZnVuY3Rpb24oZWxlbWVudCwgc2VsZWN0b3IsIGNvbmRpdGlvbikgewogICAgaWYgKGlzVW5kZWZpbmVkKGNvbmRpdGlvbikpIHsKICAgICAgY29uZGl0aW9uID0gIUpRTGl0ZUhhc0NsYXNzKGVsZW1lbnQsIHNlbGVjdG9yKTsKICAgIH0KICAgIChjb25kaXRpb24gPyBKUUxpdGVBZGRDbGFzcyA6IEpRTGl0ZVJlbW92ZUNsYXNzKShlbGVtZW50LCBzZWxlY3Rvcik7CiAgfSwKCiAgcGFyZW50OiBmdW5jdGlvbihlbGVtZW50KSB7CiAgICB2YXIgcGFyZW50ID0gZWxlbWVudC5wYXJlbnROb2RlOwogICAgcmV0dXJuIHBhcmVudCAmJiBwYXJlbnQubm9kZVR5cGUgIT09IDExID8gcGFyZW50IDogbnVsbDsKICB9LAoKICBuZXh0OiBmdW5jdGlvbihlbGVtZW50KSB7CiAgICByZXR1cm4gZWxlbWVudC5uZXh0U2libGluZzsKICB9LAoKICBmaW5kOiBmdW5jdGlvbihlbGVtZW50LCBzZWxlY3RvcikgewogICAgcmV0dXJuIGVsZW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoc2VsZWN0b3IpOwogIH0sCgogIGNsb25lOiBKUUxpdGVDbG9uZQp9LCBmdW5jdGlvbihmbiwgbmFtZSl7CiAgLyoqCiAgICogY2hhaW5pbmcgZnVuY3Rpb25zCiAgICovCiAgSlFMaXRlLnByb3RvdHlwZVtuYW1lXSA9IGZ1bmN0aW9uKGFyZzEsIGFyZzIpIHsKICAgIHZhciB2YWx1ZTsKICAgIGZvcih2YXIgaT0wOyBpIDwgdGhpcy5sZW5ndGg7IGkrKykgewogICAgICBpZiAodmFsdWUgPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgdmFsdWUgPSBmbih0aGlzW2ldLCBhcmcxLCBhcmcyKTsKICAgICAgICBpZiAodmFsdWUgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgLy8gYW55IGZ1bmN0aW9uIHdoaWNoIHJldHVybnMgYSB2YWx1ZSBuZWVkcyB0byBiZSB3cmFwcGVkCiAgICAgICAgICB2YWx1ZSA9IGpxTGl0ZSh2YWx1ZSk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIEpRTGl0ZUFkZE5vZGVzKHZhbHVlLCBmbih0aGlzW2ldLCBhcmcxLCBhcmcyKSk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiB2YWx1ZSA9PSB1bmRlZmluZWQgPyB0aGlzIDogdmFsdWU7CiAgfTsKfSk7Cid1c2Ugc3RyaWN0JzsKCnZhciBhbmd1bGFyR2xvYmFsID0gewogICd0eXBlT2YnOmZ1bmN0aW9uKG9iail7CiAgICBpZiAob2JqID09PSBudWxsKSByZXR1cm4gJG51bGw7CiAgICB2YXIgdHlwZSA9IHR5cGVvZiBvYmo7CiAgICBpZiAodHlwZSA9PSAkb2JqZWN0KSB7CiAgICAgIGlmIChvYmogaW5zdGFuY2VvZiBBcnJheSkgcmV0dXJuICRhcnJheTsKICAgICAgaWYgKGlzRGF0ZShvYmopKSByZXR1cm4gJGRhdGU7CiAgICAgIGlmIChvYmoubm9kZVR5cGUgPT0gMSkgcmV0dXJuICRlbGVtZW50OwogICAgfQogICAgcmV0dXJuIHR5cGU7CiAgfQp9OwoKCi8qKgogKiBAbmdkb2Mgb3ZlcnZpZXcKICogQG5hbWUgYW5ndWxhci5PYmplY3QKICogQGZ1bmN0aW9uCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBBIG5hbWVzcGFjZSBmb3IgdXRpbGl0eSBmdW5jdGlvbnMgdXNlZCB0byB3b3JrIHdpdGggSmF2YVNjcmlwdCBvYmplY3RzLiBUaGVzZSBmdW5jdGlvbnMgYXJlCiAqIGV4cG9zZWQgaW4gdHdvIHdheXM6CiAqCiAqIF9fKiBBbmd1bGFyIGV4cHJlc3Npb25zOl9fIEZ1bmN0aW9ucyBhcmUgYm91bmQgdG8gYWxsIG9iamVjdHMgYW5kIGF1Z21lbnQgdGhlIE9iamVjdCB0eXBlLiBUaGUKICogbmFtZXMgb2YgdGhlc2UgbWV0aG9kcyBhcmUgcHJlZml4ZWQgd2l0aCB0aGUgJyQnIGNoYXJhY3RlciBpbiBvcmRlciB0byBtaW5pbWl6ZSBuYW1pbmcgY29sbGlzaW9ucy4KICogVG8gY2FsbCBhIG1ldGhvZCwgaW52b2tlIHRoZSBmdW5jdGlvbiB3aXRob3V0IHRoZSBmaXJzdCBhcmd1bWVudCwgZS5nLCBgbXlPYmplY3QuJGZvbyhwYXJhbTIpYC4KICoKICogX18qIEphdmFTY3JpcHQgY29kZTpfXyBGdW5jdGlvbnMgZG9uJ3QgYXVnbWVudCB0aGUgT2JqZWN0IHR5cGUgYW5kIG11c3QgYmUgaW52b2tlZCBhcyBmdW5jdGlvbnMgb2YKICogYGFuZ3VsYXIuT2JqZWN0YCBhcyBgYW5ndWxhci5PYmplY3QuZm9vKG15T2JqZWN0LCBwYXJhbTIpYC4KICoKICogKiB7QGxpbmsgYW5ndWxhci5PYmplY3QuY29weSBhbmd1bGFyLk9iamVjdC5jb3B5KCl9IC0gQ3JlYXRlcyBhIGRlZXAgY29weSBvZiB0aGUgc291cmNlIHBhcmFtZXRlcgogKiAqIHtAbGluayBhbmd1bGFyLk9iamVjdC5lcXVhbHMgYW5ndWxhci5PYmplY3QuZXF1YWxzKCl9IC0gRGV0ZXJtaW5lcyBpZiB0d28gb2JqZWN0cyBvciB2YWx1ZXMgYXJlCiAqIGVxdWl2YWxlbnQKICogKiB7QGxpbmsgYW5ndWxhci5PYmplY3Quc2l6ZSBhbmd1bGFyLk9iamVjdC5zaXplKCl9IC0gRGV0ZXJtaW5lcyB0aGUgbnVtYmVyIG9mIGVsZW1lbnRzIGluCiAqIHN0cmluZ3MsIGFycmF5cywgYW5kIG9iamVjdHMuCiAqLwp2YXIgYW5ndWxhckNvbGxlY3Rpb24gPSB7CiAgJ2NvcHknOiBjb3B5LAogICdzaXplJzogc2l6ZSwKICAnZXF1YWxzJzogZXF1YWxzCn07CnZhciBhbmd1bGFyT2JqZWN0ID0gewogICdleHRlbmQnOiBleHRlbmQKfTsKCi8qKgogKiBAbmdkb2Mgb3ZlcnZpZXcKICogQG5hbWUgYW5ndWxhci5BcnJheQogKgogKiBAZGVzY3JpcHRpb24KICogQSBuYW1lc3BhY2UgZm9yIHV0aWxpdHkgZnVuY3Rpb25zIGZvciB0aGUgbWFuaXB1bGF0aW9uIG9mIEphdmFTY3JpcHQgQXJyYXkgb2JqZWN0cy4KICoKICogVGhlc2UgZnVuY3Rpb25zIGFyZSBleHBvc2VkIGluIHR3byB3YXlzOgogKgogKiAqIF9fQW5ndWxhciBleHByZXNzaW9uczpfXyBGdW5jdGlvbnMgYXJlIGJvdW5kIHRvIHRoZSBBcnJheSBvYmplY3RzIGFuZCBhdWdtZW50IHRoZSBBcnJheSB0eXBlIGFzCiAqIGFycmF5IG1ldGhvZHMuIFRoZSBuYW1lcyBvZiB0aGVzZSBtZXRob2RzIGFyZSBwcmVmaXhlZCB3aXRoICQgY2hhcmFjdGVyIHRvIG1pbmltaXplIG5hbWluZwogKiBjb2xsaXNpb25zLiBUbyBjYWxsIGEgbWV0aG9kLCBpbnZva2UgbXlBcnJheU9iamVjdC4kZm9vKHBhcmFtcykuCiAqCiAqICAgICBCZWNhdXNlIEFycmF5IHR5cGUgaXMgYSBzdWJ0eXBlIG9mIHRoZSBPYmplY3QgdHlwZSwgYWxsIGFuZ3VsYXIuT2JqZWN0IGZ1bmN0aW9ucyBhdWdtZW50CiAqICAgICB0aGVBcnJheSB0eXBlIGluIGFuZ3VsYXIgZXhwcmVzc2lvbnMgYXMgd2VsbC4KICoKICogKiBfX0phdmFTY3JpcHQgY29kZTpfXyBGdW5jdGlvbnMgZG9uJ3QgYXVnbWVudCB0aGUgQXJyYXkgdHlwZSBhbmQgbXVzdCBiZSBpbnZva2VkIGFzIGZ1bmN0aW9ucyBvZgogKiBgYW5ndWxhci5BcnJheWAgYXMgYGFuZ3VsYXIuQXJyYXkuZm9vKG15QXJyYXlPYmplY3QsIHBhcmFtcylgLgogKgogKiBUaGUgZm9sbG93aW5nIEFQSXMgYXJlIGJ1aWx0LWluIHRvIHRoZSBhbmd1bGFyIEFycmF5IG9iamVjdDoKICoKICogKiB7QGxpbmsgYW5ndWxhci5BcnJheS5hZGQgYW5ndWxhci5BcnJheS5hZGQoKX0gLSBPcHRpb25hbGx5IGFkZHMgYSBuZXcgZWxlbWVudCB0byBhbiBhcnJheS4KICogKiB7QGxpbmsgYW5ndWxhci5BcnJheS5jb3VudCBhbmd1bGFyLkFycmF5LmNvdW50KCl9IC0gRGV0ZXJtaW5lcyB0aGUgbnVtYmVyIG9mIGVsZW1lbnRzIGluIGFuCiAqIGFycmF5LgogKiAqIHtAbGluayBhbmd1bGFyLkFycmF5LmZpbHRlciBhbmd1bGFyLkFycmF5LmZpbHRlcigpfSAtIFJldHVybnMgYSBzdWJzZXQgb2YgaXRlbXMgYXMgYSBuZXcgYXJyYXkuCiAqICoge0BsaW5rIGFuZ3VsYXIuQXJyYXkuaW5kZXhPZiBhbmd1bGFyLkFycmF5LmluZGV4T2YoKX0gLSBEZXRlcm1pbmVzIHRoZSBpbmRleCBvZiBhbiBhcnJheSB2YWx1ZS4KICogKiB7QGxpbmsgYW5ndWxhci5BcnJheS5saW1pdFRvIGFuZ3VsYXIuQXJyYXkubGltaXRUbygpfSAtIENyZWF0ZXMgYSBuZXcgYXJyYXkgb2ZmIHRoZSBmcm9udCBvcgogKiBiYWNrIG9mIGFuIGV4aXN0aW5nIGFycmF5LgogKiAqIHtAbGluayBhbmd1bGFyLkFycmF5Lm9yZGVyQnkgYW5ndWxhci5BcnJheS5vcmRlckJ5KCl9IC0gT3JkZXJzIGFycmF5IGVsZW1lbnRzCiAqICoge0BsaW5rIGFuZ3VsYXIuQXJyYXkucmVtb3ZlIGFuZ3VsYXIuQXJyYXkucmVtb3ZlKCl9IC0gUmVtb3ZlcyBhcnJheSBlbGVtZW50cwogKiAqIHtAbGluayBhbmd1bGFyLkFycmF5LnN1bSBhbmd1bGFyLkFycmF5LnN1bSgpfSAtIFN1bXMgdGhlIG51bWJlciBlbGVtZW50cyBpbiBhbiBhcnJheQogKi8KdmFyIGFuZ3VsYXJBcnJheSA9IHsKCgogIC8qKgogICAqIEBuZ2RvYyBmdW5jdGlvbgogICAqIEBuYW1lIGFuZ3VsYXIuQXJyYXkuaW5kZXhPZgogICAqIEBmdW5jdGlvbgogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogRGV0ZXJtaW5lcyB0aGUgaW5kZXggb2YgYHZhbHVlYCBpbiBgYXJyYXlgLgogICAqCiAgICogTm90ZTogdGhpcyBmdW5jdGlvbiBpcyB1c2VkIHRvIGF1Z21lbnQgdGhlIGBBcnJheWAgdHlwZSBpbiBhbmd1bGFyIGV4cHJlc3Npb25zLiBTZWUKICAgKiB7QGxpbmsgYW5ndWxhci5BcnJheX0gZm9yIG1vcmUgaW5mby4KICAgKgogICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IEFycmF5IHRvIHNlYXJjaC4KICAgKiBAcGFyYW0geyp9IHZhbHVlIFZhbHVlIHRvIHNlYXJjaCBmb3IuCiAgICogQHJldHVybnMge251bWJlcn0gVGhlIHBvc2l0aW9uIG9mIHRoZSBlbGVtZW50IGluIGBhcnJheWAuIFRoZSBwb3NpdGlvbiBpcyAwLWJhc2VkLiBgLTFgIGlzIHJldHVybmVkIGlmIHRoZSB2YWx1ZSBjYW4ndCBiZSBmb3VuZC4KICAgKgogICAqIEBleGFtcGxlCiAgICAgIDxkb2M6ZXhhbXBsZT4KICAgICAgICA8ZG9jOnNvdXJjZT4KICAgICAgICAgPGRpdiBuZzppbml0PSJib29rcyA9IFsnTW9ieSBEaWNrJywgJ0dyZWF0IEdhdHNieScsICdSb21lbyBhbmQgSnVsaWV0J10iPjwvZGl2PgogICAgICAgICA8aW5wdXQgbmFtZT0nYm9va05hbWUnIHZhbHVlPSdSb21lbyBhbmQgSnVsaWV0Jz4gPGJyPgogICAgICAgICBJbmRleCBvZiAne3tib29rTmFtZX19JyBpbiB0aGUgbGlzdCB7e2Jvb2tzfX0gaXMgPGVtPnt7Ym9va3MuJGluZGV4T2YoYm9va05hbWUpfX08L2VtPi4KICAgICAgICA8L2RvYzpzb3VyY2U+CiAgICAgICAgPGRvYzpzY2VuYXJpbz4KICAgICAgICAgaXQoJ3Nob3VsZCBjb3JyZWN0bHkgY2FsY3VsYXRlIHRoZSBpbml0aWFsIGluZGV4JywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ2Jvb2tzLiRpbmRleE9mKGJvb2tOYW1lKScpKS50b0JlKCcyJyk7CiAgICAgICAgIH0pOwoKICAgICAgICAgaXQoJ3Nob3VsZCByZWNhbGN1bGF0ZScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgIGlucHV0KCdib29rTmFtZScpLmVudGVyKCdmb28nKTsKICAgICAgICAgICBleHBlY3QoYmluZGluZygnYm9va3MuJGluZGV4T2YoYm9va05hbWUpJykpLnRvQmUoJy0xJyk7CgogICAgICAgICAgIGlucHV0KCdib29rTmFtZScpLmVudGVyKCdNb2J5IERpY2snKTsKICAgICAgICAgICBleHBlY3QoYmluZGluZygnYm9va3MuJGluZGV4T2YoYm9va05hbWUpJykpLnRvQmUoJzAnKTsKICAgICAgICAgfSk7CiAgICAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgIDwvZG9jOmV4YW1wbGU+CiAgICovCiAgJ2luZGV4T2YnOiBpbmRleE9mLAoKCiAgLyoqCiAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICogQG5hbWUgYW5ndWxhci5BcnJheS5zdW0KICAgKiBAZnVuY3Rpb24KICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFRoaXMgZnVuY3Rpb24gY2FsY3VsYXRlcyB0aGUgc3VtIG9mIGFsbCBudW1iZXJzIGluIGBhcnJheWAuIElmIHRoZSBgZXhwcmVzc2lvbnNgIGlzIHN1cHBsaWVkLAogICAqIGl0IGlzIGV2YWx1YXRlZCBvbmNlIGZvciBlYWNoIGVsZW1lbnQgaW4gYGFycmF5YCBhbmQgdGhlbiB0aGUgc3VtIG9mIHRoZXNlIHZhbHVlcyBpcyByZXR1cm5lZC4KICAgKgogICAqIE5vdGU6IHRoaXMgZnVuY3Rpb24gaXMgdXNlZCB0byBhdWdtZW50IHRoZSBgQXJyYXlgIHR5cGUgaW4gYW5ndWxhciBleHByZXNzaW9ucy4gU2VlCiAgICoge0BsaW5rIGFuZ3VsYXIuQXJyYXl9IGZvciBtb3JlIGluZm8uCiAgICoKICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBUaGUgc291cmNlIGFycmF5LgogICAqIEBwYXJhbSB7KHN0cmluZ3xmdW5jdGlvbigpKT19IGV4cHJlc3Npb24gQW5ndWxhciBleHByZXNzaW9uIG9yIGEgZnVuY3Rpb24gdG8gYmUgZXZhbHVhdGVkIGZvciBlYWNoCiAgICogICAgIGVsZW1lbnQgaW4gYGFycmF5YC4gVGhlIGFycmF5IGVsZW1lbnQgYmVjb21lcyB0aGUgYHRoaXNgIGR1cmluZyB0aGUgZXZhbHVhdGlvbi4KICAgKiBAcmV0dXJucyB7bnVtYmVyfSBTdW0gb2YgaXRlbXMgaW4gdGhlIGFycmF5LgogICAqCiAgICogQGV4YW1wbGUKICAgICAgPGRvYzpleGFtcGxlPgogICAgICAgIDxkb2M6c291cmNlPgogICAgICAgICA8dGFibGUgbmc6aW5pdD0iaW52b2ljZT0ge2l0ZW1zOlt7cXR5OjEwLCBkZXNjcmlwdGlvbjonZ2FkZ2V0JywgY29zdDo5Ljk1fV19Ij4KICAgICAgICAgICA8dHI+PHRoPlF0eTwvdGg+PHRoPkRlc2NyaXB0aW9uPC90aD48dGg+Q29zdDwvdGg+PHRoPlRvdGFsPC90aD48dGg+PC90aD48L3RyPgogICAgICAgICAgIDx0ciBuZzpyZXBlYXQ9Iml0ZW0gaW4gaW52b2ljZS5pdGVtcyI+CiAgICAgICAgICAgICA8dGQ+PGlucHV0IG5hbWU9Iml0ZW0ucXR5IiB2YWx1ZT0iMSIgc2l6ZT0iNCIgbmc6cmVxdWlyZWQgbmc6dmFsaWRhdGU9ImludGVnZXIiPjwvdGQ+CiAgICAgICAgICAgIDx0ZD48aW5wdXQgbmFtZT0iaXRlbS5kZXNjcmlwdGlvbiI+PC90ZD4KICAgICAgICAgICAgICA8dGQ+PGlucHV0IG5hbWU9Iml0ZW0uY29zdCIgdmFsdWU9IjAuMDAiIG5nOnJlcXVpcmVkIG5nOnZhbGlkYXRlPSJudW1iZXIiIHNpemU9IjYiPjwvdGQ+CiAgICAgICAgICAgICA8dGQ+e3tpdGVtLnF0eSAqIGl0ZW0uY29zdCB8IGN1cnJlbmN5fX08L3RkPgogICAgICAgICAgICAgPHRkPls8YSBocmVmIG5nOmNsaWNrPSJpbnZvaWNlLml0ZW1zLiRyZW1vdmUoaXRlbSkiPlg8L2E+XTwvdGQ+CiAgICAgICAgICAgPC90cj4KICAgICAgICAgICA8dHI+CiAgICAgICAgICAgICA8dGQ+PGEgaHJlZiBuZzpjbGljaz0iaW52b2ljZS5pdGVtcy4kYWRkKCkiPmFkZCBpdGVtPC9hPjwvdGQ+CiAgICAgICAgICAgICA8dGQ+PC90ZD4KICAgICAgICAgICAgIDx0ZD5Ub3RhbDo8L3RkPgogICAgICAgICAgICAgPHRkPnt7aW52b2ljZS5pdGVtcy4kc3VtKCdxdHkqY29zdCcpIHwgY3VycmVuY3l9fTwvdGQ+CiAgICAgICAgICAgPC90cj4KICAgICAgICAgPC90YWJsZT4KICAgICAgICA8L2RvYzpzb3VyY2U+CiAgICAgICAgPGRvYzpzY2VuYXJpbz4KICAgICAgICAgLy9UT0RPOiB0aGVzZSBzcGVjcyBhcmUgbGFtZSBiZWNhdXNlIEkgaGFkIHRvIHdvcmsgYXJvdW5kIGlzc3VlcyAjMTY0IGFuZCAjMTY3CiAgICAgICAgIGl0KCdzaG91bGQgaW5pdGlhbGl6ZSBhbmQgY2FsY3VsYXRlIHRoZSB0b3RhbHMnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICBleHBlY3QocmVwZWF0ZXIoJy5kb2MtZXhhbXBsZS1saXZlIHRhYmxlIHRyJywgJ2l0ZW0gaW4gaW52b2ljZS5pdGVtcycpLmNvdW50KCkpLnRvQmUoMyk7CiAgICAgICAgICAgZXhwZWN0KHJlcGVhdGVyKCcuZG9jLWV4YW1wbGUtbGl2ZSB0YWJsZSB0cicsICdpdGVtIGluIGludm9pY2UuaXRlbXMnKS5yb3coMSkpLgogICAgICAgICAgICAgdG9FcXVhbChbJyQ5OS41MCddKTsKICAgICAgICAgICBleHBlY3QoYmluZGluZygiaW52b2ljZS5pdGVtcy4kc3VtKCdxdHkqY29zdCcpIikpLnRvQmUoJyQ5OS41MCcpOwogICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCJpbnZvaWNlLml0ZW1zLiRzdW0oJ3F0eSpjb3N0JykiKSkudG9CZSgnJDk5LjUwJyk7CiAgICAgICAgIH0pOwoKICAgICAgICAgaXQoJ3Nob3VsZCBhZGQgYW4gZW50cnkgYW5kIHJlY2FsY3VsYXRlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgYTpjb250YWlucygiYWRkIGl0ZW0iKScpLmNsaWNrKCk7CiAgICAgICAgICAgdXNpbmcoJy5kb2MtZXhhbXBsZS1saXZlIHRyOm50aC1jaGlsZCgzKScpLmlucHV0KCdpdGVtLnF0eScpLmVudGVyKCcyMCcpOwogICAgICAgICAgIHVzaW5nKCcuZG9jLWV4YW1wbGUtbGl2ZSB0cjpudGgtY2hpbGQoMyknKS5pbnB1dCgnaXRlbS5jb3N0JykuZW50ZXIoJzEwMCcpOwoKICAgICAgICAgICBleHBlY3QocmVwZWF0ZXIoJy5kb2MtZXhhbXBsZS1saXZlIHRhYmxlIHRyJywgJ2l0ZW0gaW4gaW52b2ljZS5pdGVtcycpLnJvdygyKSkuCiAgICAgICAgICAgICB0b0VxdWFsKFsnJDIsMDAwLjAwJ10pOwogICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCJpbnZvaWNlLml0ZW1zLiRzdW0oJ3F0eSpjb3N0JykiKSkudG9CZSgnJDIsMDk5LjUwJyk7CiAgICAgICAgIH0pOwogICAgICAgIDwvZG9jOnNjZW5hcmlvPgogICAgICA8L2RvYzpleGFtcGxlPgogICAqLwogICdzdW0nOmZ1bmN0aW9uKGFycmF5LCBleHByZXNzaW9uKSB7CiAgICB2YXIgZm4gPSBhbmd1bGFyWydGdW5jdGlvbiddWydjb21waWxlJ10oZXhwcmVzc2lvbik7CiAgICB2YXIgc3VtID0gMDsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYXJyYXkubGVuZ3RoOyBpKyspIHsKICAgICAgdmFyIHZhbHVlID0gMSAqIGZuKGFycmF5W2ldKTsKICAgICAgaWYgKCFpc05hTih2YWx1ZSkpewogICAgICAgIHN1bSArPSB2YWx1ZTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHN1bTsKICB9LAoKCiAgLyoqCiAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICogQG5hbWUgYW5ndWxhci5BcnJheS5yZW1vdmUKICAgKiBAZnVuY3Rpb24KICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIE1vZGlmaWVzIGBhcnJheWAgYnkgcmVtb3ZpbmcgYW4gZWxlbWVudCBmcm9tIGl0LiBUaGUgZWxlbWVudCB3aWxsIGJlIGxvb2tlZCB1cCB1c2luZyB0aGUKICAgKiB7QGxpbmsgYW5ndWxhci5BcnJheS5pbmRleE9mIGluZGV4T2Z9IGZ1bmN0aW9uIG9uIHRoZSBgYXJyYXlgIGFuZCBvbmx5IHRoZSBmaXJzdCBpbnN0YW5jZSBvZgogICAqIHRoZSBlbGVtZW50IHdpbGwgYmUgcmVtb3ZlZC4KICAgKgogICAqIE5vdGU6IHRoaXMgZnVuY3Rpb24gaXMgdXNlZCB0byBhdWdtZW50IHRoZSBgQXJyYXlgIHR5cGUgaW4gYW5ndWxhciBleHByZXNzaW9ucy4gU2VlCiAgICoge0BsaW5rIGFuZ3VsYXIuQXJyYXl9IGZvciBtb3JlIGluZm8uCiAgICoKICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBBcnJheSBmcm9tIHdoaWNoIGFuIGVsZW1lbnQgc2hvdWxkIGJlIHJlbW92ZWQuCiAgICogQHBhcmFtIHsqfSB2YWx1ZSBFbGVtZW50IHRvIGJlIHJlbW92ZWQuCiAgICogQHJldHVybnMgeyp9IFRoZSByZW1vdmVkIGVsZW1lbnQuCiAgICoKICAgKiBAZXhhbXBsZQogICAgIDxkb2M6ZXhhbXBsZT4KICAgICAgIDxkb2M6c291cmNlPgogICAgICAgICA8dWwgbmc6aW5pdD0idGFza3M9WydMZWFybiBBbmd1bGFyJywgJ1JlYWQgRG9jdW1lbnRhdGlvbicsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ0NoZWNrIG91dCBkZW1vcycsICdCdWlsZCBjb29sIGFwcGxpY2F0aW9ucyddIj4KICAgICAgICAgICA8bGkgbmc6cmVwZWF0PSJ0YXNrIGluIHRhc2tzIj4KICAgICAgICAgICAgIHt7dGFza319IFs8YSBocmVmPSIiIG5nOmNsaWNrPSJ0YXNrcy4kcmVtb3ZlKHRhc2spIj5YPC9hPl0KICAgICAgICAgICA8L2xpPgogICAgICAgICA8L3VsPgogICAgICAgICA8aHIvPgogICAgICAgICB0YXNrcyA9IHt7dGFza3N9fQogICAgICAgPC9kb2M6c291cmNlPgogICAgICAgPGRvYzpzY2VuYXJpbz4KICAgICAgICAgaXQoJ3Nob3VsZCBpbml0aWFsaXplIHRoZSB0YXNrIGxpc3Qgd2l0aCBmb3IgdGFza3MnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICBleHBlY3QocmVwZWF0ZXIoJy5kb2MtZXhhbXBsZS1saXZlIHVsIGxpJywgJ3Rhc2sgaW4gdGFza3MnKS5jb3VudCgpKS50b0JlKDQpOwogICAgICAgICAgIGV4cGVjdChyZXBlYXRlcignLmRvYy1leGFtcGxlLWxpdmUgdWwgbGknLCAndGFzayBpbiB0YXNrcycpLmNvbHVtbigndGFzaycpKS4KICAgICAgICAgICAgIHRvRXF1YWwoWydMZWFybiBBbmd1bGFyJywgJ1JlYWQgRG9jdW1lbnRhdGlvbicsICdDaGVjayBvdXQgZGVtb3MnLAogICAgICAgICAgICAgICAgICAgICAgJ0J1aWxkIGNvb2wgYXBwbGljYXRpb25zJ10pOwogICAgICAgICB9KTsKCiAgICAgICAgIGl0KCdzaG91bGQgaW5pdGlhbGl6ZSB0aGUgdGFzayBsaXN0IHdpdGggZm9yIHRhc2tzJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgdWwgbGkgYTpjb250YWlucygiWCIpOmZpcnN0JykuY2xpY2soKTsKICAgICAgICAgICBleHBlY3QocmVwZWF0ZXIoJy5kb2MtZXhhbXBsZS1saXZlIHVsIGxpJywgJ3Rhc2sgaW4gdGFza3MnKS5jb3VudCgpKS50b0JlKDMpOwoKICAgICAgICAgICBlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSB1bCBsaSBhOmNvbnRhaW5zKCJYIik6bGFzdCcpLmNsaWNrKCk7CiAgICAgICAgICAgZXhwZWN0KHJlcGVhdGVyKCcuZG9jLWV4YW1wbGUtbGl2ZSB1bCBsaScsICd0YXNrIGluIHRhc2tzJykuY291bnQoKSkudG9CZSgyKTsKCiAgICAgICAgICAgZXhwZWN0KHJlcGVhdGVyKCcuZG9jLWV4YW1wbGUtbGl2ZSB1bCBsaScsICd0YXNrIGluIHRhc2tzJykuY29sdW1uKCd0YXNrJykpLgogICAgICAgICAgICAgdG9FcXVhbChbJ1JlYWQgRG9jdW1lbnRhdGlvbicsICdDaGVjayBvdXQgZGVtb3MnXSk7CiAgICAgICAgIH0pOwogICAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgPC9kb2M6ZXhhbXBsZT4KICAgKi8KICAncmVtb3ZlJzpmdW5jdGlvbihhcnJheSwgdmFsdWUpIHsKICAgIHZhciBpbmRleCA9IGluZGV4T2YoYXJyYXksIHZhbHVlKTsKICAgIGlmIChpbmRleCA+PTApCiAgICAgIGFycmF5LnNwbGljZShpbmRleCwgMSk7CiAgICByZXR1cm4gdmFsdWU7CiAgfSwKCgogIC8qKgogICAqIEBuZ2RvYyBmdW5jdGlvbgogICAqIEBuYW1lIGFuZ3VsYXIuQXJyYXkuZmlsdGVyCiAgICogQGZ1bmN0aW9uCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBTZWxlY3RzIGEgc3Vic2V0IG9mIGl0ZW1zIGZyb20gYGFycmF5YCBhbmQgcmV0dXJucyBpdCBhcyBhIG5ldyBhcnJheS4KICAgKgogICAqIE5vdGU6IHRoaXMgZnVuY3Rpb24gaXMgdXNlZCB0byBhdWdtZW50IHRoZSBgQXJyYXlgIHR5cGUgaW4gYW5ndWxhciBleHByZXNzaW9ucy4gU2VlCiAgICoge0BsaW5rIGFuZ3VsYXIuQXJyYXl9IGZvciBtb3JlIGluZm8uCiAgICoKICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBUaGUgc291cmNlIGFycmF5LgogICAqIEBwYXJhbSB7c3RyaW5nfE9iamVjdHxmdW5jdGlvbigpfSBleHByZXNzaW9uIFRoZSBwcmVkaWNhdGUgdG8gYmUgdXNlZCBmb3Igc2VsZWN0aW5nIGl0ZW1zIGZyb20KICAgKiAgIGBhcnJheWAuCiAgICoKICAgKiAgIENhbiBiZSBvbmUgb2Y6CiAgICoKICAgKiAgIC0gYHN0cmluZ2A6IFByZWRpY2F0ZSB0aGF0IHJlc3VsdHMgaW4gYSBzdWJzdHJpbmcgbWF0Y2ggdXNpbmcgdGhlIHZhbHVlIG9mIGBleHByZXNzaW9uYAogICAqICAgICBzdHJpbmcuIEFsbCBzdHJpbmdzIG9yIG9iamVjdHMgd2l0aCBzdHJpbmcgcHJvcGVydGllcyBpbiBgYXJyYXlgIHRoYXQgY29udGFpbiB0aGlzIHN0cmluZwogICAqICAgICB3aWxsIGJlIHJldHVybmVkLiBUaGUgcHJlZGljYXRlIGNhbiBiZSBuZWdhdGVkIGJ5IHByZWZpeGluZyB0aGUgc3RyaW5nIHdpdGggYCFgLgogICAqCiAgICogICAtIGBPYmplY3RgOiBBIHBhdHRlcm4gb2JqZWN0IGNhbiBiZSB1c2VkIHRvIGZpbHRlciBzcGVjaWZpYyBwcm9wZXJ0aWVzIG9uIG9iamVjdHMgY29udGFpbmVkCiAgICogICAgIGJ5IGBhcnJheWAuIEZvciBleGFtcGxlIGB7bmFtZToiTSIsIHBob25lOiIxIn1gIHByZWRpY2F0ZSB3aWxsIHJldHVybiBhbiBhcnJheSBvZiBpdGVtcwogICAqICAgICB3aGljaCBoYXZlIHByb3BlcnR5IGBuYW1lYCBjb250YWluaW5nICJNIiBhbmQgcHJvcGVydHkgYHBob25lYCBjb250YWluaW5nICIxIi4gQSBzcGVjaWFsCiAgICogICAgIHByb3BlcnR5IG5hbWUgYCRgIGNhbiBiZSB1c2VkIChhcyBpbiBgeyQ6InRleHQifWApIHRvIGFjY2VwdCBhIG1hdGNoIGFnYWluc3QgYW55CiAgICogICAgIHByb3BlcnR5IG9mIHRoZSBvYmplY3QuIFRoYXQncyBlcXVpdmFsZW50IHRvIHRoZSBzaW1wbGUgc3Vic3RyaW5nIG1hdGNoIHdpdGggYSBgc3RyaW5nYAogICAqICAgICBhcyBkZXNjcmliZWQgYWJvdmUuCiAgICoKICAgKiAgIC0gYGZ1bmN0aW9uYDogQSBwcmVkaWNhdGUgZnVuY3Rpb24gY2FuIGJlIHVzZWQgdG8gd3JpdGUgYXJiaXRyYXJ5IGZpbHRlcnMuIFRoZSBmdW5jdGlvbiBpcwogICAqICAgICBjYWxsZWQgZm9yIGVhY2ggZWxlbWVudCBvZiBgYXJyYXlgLiBUaGUgZmluYWwgcmVzdWx0IGlzIGFuIGFycmF5IG9mIHRob3NlIGVsZW1lbnRzIHRoYXQKICAgKiAgICAgdGhlIHByZWRpY2F0ZSByZXR1cm5lZCB0cnVlIGZvci4KICAgKgogICAqIEBleGFtcGxlCiAgICAgPGRvYzpleGFtcGxlPgogICAgICAgPGRvYzpzb3VyY2U+CiAgICAgICAgIDxkaXYgbmc6aW5pdD0iZnJpZW5kcyA9IFt7bmFtZTonSm9obicsIHBob25lOic1NTUtMTI3Nid9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAge25hbWU6J01hcnknLCBwaG9uZTonODAwLUJJRy1NQVJZJ30sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB7bmFtZTonTWlrZScsIHBob25lOic1NTUtNDMyMSd9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAge25hbWU6J0FkYW0nLCBwaG9uZTonNTU1LTU2NzgnfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHtuYW1lOidKdWxpZScsIHBob25lOic1NTUtODc2NSd9XSI+PC9kaXY+CgogICAgICAgICBTZWFyY2g6IDxpbnB1dCBuYW1lPSJzZWFyY2hUZXh0Ii8+CiAgICAgICAgIDx0YWJsZSBpZD0ic2VhcmNoVGV4dFJlc3VsdHMiPgogICAgICAgICAgIDx0cj48dGg+TmFtZTwvdGg+PHRoPlBob25lPC90aD48dHI+CiAgICAgICAgICAgPHRyIG5nOnJlcGVhdD0iZnJpZW5kIGluIGZyaWVuZHMuJGZpbHRlcihzZWFyY2hUZXh0KSI+CiAgICAgICAgICAgICA8dGQ+e3tmcmllbmQubmFtZX19PC90ZD4KICAgICAgICAgICAgIDx0ZD57e2ZyaWVuZC5waG9uZX19PC90ZD4KICAgICAgICAgICA8dHI+CiAgICAgICAgIDwvdGFibGU+CiAgICAgICAgIDxocj4KICAgICAgICAgQW55OiA8aW5wdXQgbmFtZT0ic2VhcmNoLiQiLz4gPGJyPgogICAgICAgICBOYW1lIG9ubHkgPGlucHV0IG5hbWU9InNlYXJjaC5uYW1lIi8+PGJyPgogICAgICAgICBQaG9uZSBvbmx5IDxpbnB1dCBuYW1lPSJzZWFyY2gucGhvbmUiLz48YnI+CiAgICAgICAgIDx0YWJsZSBpZD0ic2VhcmNoT2JqUmVzdWx0cyI+CiAgICAgICAgICAgPHRyPjx0aD5OYW1lPC90aD48dGg+UGhvbmU8L3RoPjx0cj4KICAgICAgICAgICA8dHIgbmc6cmVwZWF0PSJmcmllbmQgaW4gZnJpZW5kcy4kZmlsdGVyKHNlYXJjaCkiPgogICAgICAgICAgICAgPHRkPnt7ZnJpZW5kLm5hbWV9fTwvdGQ+CiAgICAgICAgICAgICA8dGQ+e3tmcmllbmQucGhvbmV9fTwvdGQ+CiAgICAgICAgICAgPHRyPgogICAgICAgICA8L3RhYmxlPgogICAgICAgPC9kb2M6c291cmNlPgogICAgICAgPGRvYzpzY2VuYXJpbz4KICAgICAgICAgaXQoJ3Nob3VsZCBzZWFyY2ggYWNyb3NzIGFsbCBmaWVsZHMgd2hlbiBmaWx0ZXJpbmcgd2l0aCBhIHN0cmluZycsIGZ1bmN0aW9uKCkgewogICAgICAgICAgIGlucHV0KCdzZWFyY2hUZXh0JykuZW50ZXIoJ20nKTsKICAgICAgICAgICBleHBlY3QocmVwZWF0ZXIoJyNzZWFyY2hUZXh0UmVzdWx0cyB0cicsICdmcmllbmQgaW4gZnJpZW5kcycpLmNvbHVtbignbmFtZScpKS4KICAgICAgICAgICAgIHRvRXF1YWwoWydNYXJ5JywgJ01pa2UnLCAnQWRhbSddKTsKCiAgICAgICAgICAgaW5wdXQoJ3NlYXJjaFRleHQnKS5lbnRlcignNzYnKTsKICAgICAgICAgICBleHBlY3QocmVwZWF0ZXIoJyNzZWFyY2hUZXh0UmVzdWx0cyB0cicsICdmcmllbmQgaW4gZnJpZW5kcycpLmNvbHVtbignbmFtZScpKS4KICAgICAgICAgICAgIHRvRXF1YWwoWydKb2huJywgJ0p1bGllJ10pOwogICAgICAgICB9KTsKCiAgICAgICAgIGl0KCdzaG91bGQgc2VhcmNoIGluIHNwZWNpZmljIGZpZWxkcyB3aGVuIGZpbHRlcmluZyB3aXRoIGEgcHJlZGljYXRlIG9iamVjdCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgIGlucHV0KCdzZWFyY2guJCcpLmVudGVyKCdpJyk7CiAgICAgICAgICAgZXhwZWN0KHJlcGVhdGVyKCcjc2VhcmNoT2JqUmVzdWx0cyB0cicsICdmcmllbmQgaW4gZnJpZW5kcycpLmNvbHVtbignbmFtZScpKS4KICAgICAgICAgICAgIHRvRXF1YWwoWydNYXJ5JywgJ01pa2UnLCAnSnVsaWUnXSk7CiAgICAgICAgIH0pOwogICAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgPC9kb2M6ZXhhbXBsZT4KICAgKi8KICAnZmlsdGVyJzpmdW5jdGlvbihhcnJheSwgZXhwcmVzc2lvbikgewogICAgdmFyIHByZWRpY2F0ZXMgPSBbXTsKICAgIHByZWRpY2F0ZXMuY2hlY2sgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICBmb3IgKHZhciBqID0gMDsgaiA8IHByZWRpY2F0ZXMubGVuZ3RoOyBqKyspIHsKICAgICAgICBpZighcHJlZGljYXRlc1tqXSh2YWx1ZSkpIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHRydWU7CiAgICB9OwogICAgdmFyIHNlYXJjaCA9IGZ1bmN0aW9uKG9iaiwgdGV4dCl7CiAgICAgIGlmICh0ZXh0LmNoYXJBdCgwKSA9PT0gJyEnKSB7CiAgICAgICAgcmV0dXJuICFzZWFyY2gob2JqLCB0ZXh0LnN1YnN0cigxKSk7CiAgICAgIH0KICAgICAgc3dpdGNoICh0eXBlb2Ygb2JqKSB7CiAgICAgIGNhc2UgImJvb2xlYW4iOgogICAgICBjYXNlICJudW1iZXIiOgogICAgICBjYXNlICJzdHJpbmciOgogICAgICAgIHJldHVybiAoJycgKyBvYmopLnRvTG93ZXJDYXNlKCkuaW5kZXhPZih0ZXh0KSA+IC0xOwogICAgICBjYXNlICJvYmplY3QiOgogICAgICAgIGZvciAoIHZhciBvYmpLZXkgaW4gb2JqKSB7CiAgICAgICAgICBpZiAob2JqS2V5LmNoYXJBdCgwKSAhPT0gJyQnICYmIHNlYXJjaChvYmpbb2JqS2V5XSwgdGV4dCkpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgY2FzZSAiYXJyYXkiOgogICAgICAgIGZvciAoIHZhciBpID0gMDsgaSA8IG9iai5sZW5ndGg7IGkrKykgewogICAgICAgICAgaWYgKHNlYXJjaChvYmpbaV0sIHRleHQpKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIGRlZmF1bHQ6CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICB9OwogICAgc3dpdGNoICh0eXBlb2YgZXhwcmVzc2lvbikgewogICAgICBjYXNlICJib29sZWFuIjoKICAgICAgY2FzZSAibnVtYmVyIjoKICAgICAgY2FzZSAic3RyaW5nIjoKICAgICAgICBleHByZXNzaW9uID0geyQ6ZXhwcmVzc2lvbn07CiAgICAgIGNhc2UgIm9iamVjdCI6CiAgICAgICAgZm9yICh2YXIga2V5IGluIGV4cHJlc3Npb24pIHsKICAgICAgICAgIGlmIChrZXkgPT0gJyQnKSB7CiAgICAgICAgICAgIChmdW5jdGlvbigpewogICAgICAgICAgICAgIHZhciB0ZXh0ID0gKCcnK2V4cHJlc3Npb25ba2V5XSkudG9Mb3dlckNhc2UoKTsKICAgICAgICAgICAgICBpZiAoIXRleHQpIHJldHVybjsKICAgICAgICAgICAgICBwcmVkaWNhdGVzLnB1c2goZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICAgIHJldHVybiBzZWFyY2godmFsdWUsIHRleHQpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KSgpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgKGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICAgdmFyIHBhdGggPSBrZXk7CiAgICAgICAgICAgICAgdmFyIHRleHQgPSAoJycrZXhwcmVzc2lvbltrZXldKS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICAgIGlmICghdGV4dCkgcmV0dXJuOwogICAgICAgICAgICAgIHByZWRpY2F0ZXMucHVzaChmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHNlYXJjaChnZXR0ZXIodmFsdWUsIHBhdGgpLCB0ZXh0KTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSkoKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgJGZ1bmN0aW9uOgogICAgICAgIHByZWRpY2F0ZXMucHVzaChleHByZXNzaW9uKTsKICAgICAgICBicmVhazsKICAgICAgZGVmYXVsdDoKICAgICAgICByZXR1cm4gYXJyYXk7CiAgICB9CiAgICB2YXIgZmlsdGVyZWQgPSBbXTsKICAgIGZvciAoIHZhciBqID0gMDsgaiA8IGFycmF5Lmxlbmd0aDsgaisrKSB7CiAgICAgIHZhciB2YWx1ZSA9IGFycmF5W2pdOwogICAgICBpZiAocHJlZGljYXRlcy5jaGVjayh2YWx1ZSkpIHsKICAgICAgICBmaWx0ZXJlZC5wdXNoKHZhbHVlKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIGZpbHRlcmVkOwogIH0sCgoKICAvKioKICAgKiBAd29ya0luUHJvZ3Jlc3MKICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgKiBAbmFtZSBhbmd1bGFyLkFycmF5LmFkZAogICAqIEBmdW5jdGlvbgogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogYGFkZGAgaXMgYSBmdW5jdGlvbiBzaW1pbGFyIHRvIEphdmFTY3JpcHQncyBgQXJyYXkjcHVzaGAgbWV0aG9kLCBpbiB0aGF0IGl0IGFwcGVuZHMgYSBuZXcKICAgKiBlbGVtZW50IHRvIGFuIGFycmF5LiBUaGUgZGlmZmVyZW5jZSBpcyB0aGF0IHRoZSB2YWx1ZSBiZWluZyBhZGRlZCBpcyBvcHRpb25hbCBhbmQgZGVmYXVsdHMgdG8KICAgKiBhbiBlbXB0eSBvYmplY3QuCiAgICoKICAgKiBOb3RlOiB0aGlzIGZ1bmN0aW9uIGlzIHVzZWQgdG8gYXVnbWVudCB0aGUgYEFycmF5YCB0eXBlIGluIGFuZ3VsYXIgZXhwcmVzc2lvbnMuIFNlZQogICAqIHtAbGluayBhbmd1bGFyLkFycmF5fSBmb3IgbW9yZSBpbmZvLgogICAqCiAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IGV4cGFuZC4KICAgKiBAcGFyYW0geyo9fSBbdmFsdWU9e31dIFRoZSB2YWx1ZSB0byBiZSBhZGRlZC4KICAgKiBAcmV0dXJucyB7QXJyYXl9IFRoZSBleHBhbmRlZCBhcnJheS4KICAgKgogICAqIEBUT0RPIHNpbXBsaWZ5IHRoZSBleGFtcGxlLgogICAqCiAgICogQGV4YW1wbGUKICAgKiBUaGlzIGV4YW1wbGUgc2hvd3MgaG93IGFuIGluaXRpYWxseSBlbXB0eSBhcnJheSBjYW4gYmUgZmlsbGVkIHdpdGggb2JqZWN0cyBjcmVhdGVkIGZyb20gdXNlcgogICAqIGlucHV0IHZpYSB0aGUgYCRhZGRgIG1ldGhvZC4KICAgICA8ZG9jOmV4YW1wbGU+CiAgICAgICA8ZG9jOnNvdXJjZT4KICAgICAgICAgWzxhIGhyZWY9IiIgbmc6Y2xpY2s9InBlb3BsZS4kYWRkKCkiPmFkZCBlbXB0eTwvYT5dCiAgICAgICAgIFs8YSBocmVmPSIiIG5nOmNsaWNrPSJwZW9wbGUuJGFkZCh7bmFtZTonSm9obicsIHNleDonbWFsZSd9KSI+YWRkICdKb2huJzwvYT5dCiAgICAgICAgIFs8YSBocmVmPSIiIG5nOmNsaWNrPSJwZW9wbGUuJGFkZCh7bmFtZTonTWFyeScsIHNleDonZmVtYWxlJ30pIj5hZGQgJ01hcnknPC9hPl0KCiAgICAgICAgIDx1bCBuZzppbml0PSJwZW9wbGU9W10iPgogICAgICAgICAgIDxsaSBuZzpyZXBlYXQ9InBlcnNvbiBpbiBwZW9wbGUiPgogICAgICAgICAgICAgPGlucHV0IG5hbWU9InBlcnNvbi5uYW1lIj4KICAgICAgICAgICAgIDxzZWxlY3QgbmFtZT0icGVyc29uLnNleCI+CiAgICAgICAgICAgICAgIDxvcHRpb24gdmFsdWU9IiI+LS1jaG9zZSBvbmUtLTwvb3B0aW9uPgogICAgICAgICAgICAgICA8b3B0aW9uPm1hbGU8L29wdGlvbj4KICAgICAgICAgICAgICAgPG9wdGlvbj5mZW1hbGU8L29wdGlvbj4KICAgICAgICAgICAgIDwvc2VsZWN0PgogICAgICAgICAgICAgWzxhIGhyZWY9IiIgbmc6Y2xpY2s9InBlb3BsZS4kcmVtb3ZlKHBlcnNvbikiPlg8L2E+XQogICAgICAgICAgIDwvbGk+CiAgICAgICAgIDwvdWw+CiAgICAgICAgIDxwcmU+cGVvcGxlID0ge3twZW9wbGV9fTwvcHJlPgogICAgICAgPC9kb2M6c291cmNlPgogICAgICAgPGRvYzpzY2VuYXJpbz4KICAgICAgICAgYmVmb3JlRWFjaChmdW5jdGlvbigpIHsKICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3Blb3BsZScpKS50b0JlKCdwZW9wbGUgPSBbXScpOwogICAgICAgICB9KTsKCiAgICAgICAgIGl0KCdzaG91bGQgY3JlYXRlIGFuIGVtcHR5IHJlY29yZCB3aGVuICJhZGQgZW1wdHkiIGlzIGNsaWNrZWQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICBlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBhOmNvbnRhaW5zKCJhZGQgZW1wdHkiKScpLmNsaWNrKCk7CiAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3Blb3BsZScpKS50b0JlKCdwZW9wbGUgPSBbe1xuICAibmFtZSI6IiIsXG4gICJzZXgiOm51bGx9XScpOwogICAgICAgICB9KTsKCiAgICAgICAgIGl0KCdzaG91bGQgY3JlYXRlIGEgIkpvaG4iIHJlY29yZCB3aGVuICJhZGQgXCdKb2huXCciIGlzIGNsaWNrZWQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICBlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBhOmNvbnRhaW5zKCJhZGQgXCdKb2huXCciKScpLmNsaWNrKCk7CiAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3Blb3BsZScpKS50b0JlKCdwZW9wbGUgPSBbe1xuICAibmFtZSI6IkpvaG4iLFxuICAic2V4IjoibWFsZSJ9XScpOwogICAgICAgICB9KTsKCiAgICAgICAgIGl0KCdzaG91bGQgY3JlYXRlIGEgIk1hcnkiIHJlY29yZCB3aGVuICJhZGQgXCdNYXJ5XCciIGlzIGNsaWNrZWQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICBlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBhOmNvbnRhaW5zKCJhZGQgXCdNYXJ5XCciKScpLmNsaWNrKCk7CiAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3Blb3BsZScpKS50b0JlKCdwZW9wbGUgPSBbe1xuICAibmFtZSI6Ik1hcnkiLFxuICAic2V4IjoiZmVtYWxlIn1dJyk7CiAgICAgICAgIH0pOwoKICAgICAgICAgaXQoJ3Nob3VsZCBkZWxldGUgYSByZWNvcmQgd2hlbiAiWCIgaXMgY2xpY2tlZCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBhOmNvbnRhaW5zKCJhZGQgZW1wdHkiKScpLmNsaWNrKCk7CiAgICAgICAgICAgIGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIGxpIGE6Y29udGFpbnMoIlgiKTpmaXJzdCcpLmNsaWNrKCk7CiAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdwZW9wbGUnKSkudG9CZSgncGVvcGxlID0gW10nKTsKICAgICAgICAgfSk7CiAgICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICA8L2RvYzpleGFtcGxlPgogICAqLwogICdhZGQnOmZ1bmN0aW9uKGFycmF5LCB2YWx1ZSkgewogICAgYXJyYXkucHVzaChpc1VuZGVmaW5lZCh2YWx1ZSk/IHt9IDogdmFsdWUpOwogICAgcmV0dXJuIGFycmF5OwogIH0sCgoKICAvKioKICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgKiBAbmFtZSBhbmd1bGFyLkFycmF5LmNvdW50CiAgICogQGZ1bmN0aW9uCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBEZXRlcm1pbmVzIHRoZSBudW1iZXIgb2YgZWxlbWVudHMgaW4gYW4gYXJyYXkuIE9wdGlvbmFsbHkgaXQgd2lsbCBjb3VudCBvbmx5IHRob3NlIGVsZW1lbnRzCiAgICogZm9yIHdoaWNoIHRoZSBgY29uZGl0aW9uYCBldmFsdWF0ZXMgdG8gYHRydWVgLgogICAqCiAgICogTm90ZTogdGhpcyBmdW5jdGlvbiBpcyB1c2VkIHRvIGF1Z21lbnQgdGhlIGBBcnJheWAgdHlwZSBpbiBhbmd1bGFyIGV4cHJlc3Npb25zLiBTZWUKICAgKiB7QGxpbmsgYW5ndWxhci5BcnJheX0gZm9yIG1vcmUgaW5mby4KICAgKgogICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IFRoZSBhcnJheSB0byBjb3VudCBlbGVtZW50cyBpbi4KICAgKiBAcGFyYW0geyhmdW5jdGlvbigpfHN0cmluZyk9fSBjb25kaXRpb24gQSBmdW5jdGlvbiB0byBiZSBldmFsdWF0ZWQgb3IgYW5ndWxhciBleHByZXNzaW9uIHRvIGJlCiAgICogICAgIGNvbXBpbGVkIGFuZCBldmFsdWF0ZWQuIFRoZSBlbGVtZW50IHRoYXQgaXMgY3VycmVudGx5IGJlaW5nIGl0ZXJhdGVkIG92ZXIsIGlzIGV4cG9zZWQgdG8KICAgKiAgICAgdGhlIGBjb25kaXRpb25gIGFzIGB0aGlzYC4KICAgKiBAcmV0dXJucyB7bnVtYmVyfSBOdW1iZXIgb2YgZWxlbWVudHMgaW4gdGhlIGFycmF5IChmb3Igd2hpY2ggdGhlIGNvbmRpdGlvbiBldmFsdWF0ZXMgdG8gdHJ1ZSkuCiAgICoKICAgKiBAZXhhbXBsZQogICAgIDxkb2M6ZXhhbXBsZT4KICAgICAgIDxkb2M6c291cmNlPgogICAgICAgICA8cHJlIG5nOmluaXQ9Iml0ZW1zID0gW3tuYW1lOidrbmlmZScsIHBvaW50czoxfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB7bmFtZTonZm9yaycsIHBvaW50czozfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB7bmFtZTonc3Bvb24nLCBwb2ludHM6MX1dIj48L3ByZT4KICAgICAgICAgPHVsPgogICAgICAgICAgIDxsaSBuZzpyZXBlYXQ9Iml0ZW0gaW4gaXRlbXMiPgogICAgICAgICAgICAgIHt7aXRlbS5uYW1lfX06IHBvaW50cz0KICAgICAgICAgICAgICA8aW5wdXQgdHlwZT0idGV4dCIgbmFtZT0iaXRlbS5wb2ludHMiLz4gPCEtLSBpZD0iaXRlbXt7JGluZGV4fX0gLS0+CiAgICAgICAgICAgPC9saT4KICAgICAgICAgPC91bD4KICAgICAgICAgPHA+TnVtYmVyIG9mIGl0ZW1zIHdoaWNoIGhhdmUgb25lIHBvaW50OiA8ZW0+e3sgaXRlbXMuJGNvdW50KCdwb2ludHM9PTEnKSB9fTwvZW0+PC9wPgogICAgICAgICA8cD5OdW1iZXIgb2YgaXRlbXMgd2hpY2ggaGF2ZSBtb3JlIHRoYW4gb25lIHBvaW50OiA8ZW0+e3tpdGVtcy4kY291bnQoJ3BvaW50cyZndDsxJyl9fTwvZW0+PC9wPgogICAgICAgPC9kb2M6c291cmNlPgogICAgICAgPGRvYzpzY2VuYXJpbz4KICAgICAgICAgaXQoJ3Nob3VsZCBjYWxjdWxhdGUgY291bnRzJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ2l0ZW1zLiRjb3VudChcJ3BvaW50cz09MVwnKScpKS50b0VxdWFsKDIpOwogICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdpdGVtcy4kY291bnQoXCdwb2ludHM+MVwnKScpKS50b0VxdWFsKDEpOwogICAgICAgICB9KTsKCiAgICAgICAgIGl0KCdzaG91bGQgcmVjYWxjdWxhdGUgd2hlbiB1cGRhdGVkJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgdXNpbmcoJy5kb2MtZXhhbXBsZS1saXZlIGxpOmZpcnN0LWNoaWxkJykuaW5wdXQoJ2l0ZW0ucG9pbnRzJykuZW50ZXIoJzIzJyk7CiAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ2l0ZW1zLiRjb3VudChcJ3BvaW50cz09MVwnKScpKS50b0VxdWFsKDEpOwogICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdpdGVtcy4kY291bnQoXCdwb2ludHM+MVwnKScpKS50b0VxdWFsKDIpOwogICAgICAgICB9KTsKICAgICAgIDwvZG9jOnNjZW5hcmlvPgogICAgIDwvZG9jOmV4YW1wbGU+CiAgICovCiAgJ2NvdW50JzpmdW5jdGlvbihhcnJheSwgY29uZGl0aW9uKSB7CiAgICBpZiAoIWNvbmRpdGlvbikgcmV0dXJuIGFycmF5Lmxlbmd0aDsKICAgIHZhciBmbiA9IGFuZ3VsYXJbJ0Z1bmN0aW9uJ11bJ2NvbXBpbGUnXShjb25kaXRpb24pLCBjb3VudCA9IDA7CiAgICBmb3JFYWNoKGFycmF5LCBmdW5jdGlvbih2YWx1ZSl7CiAgICAgIGlmIChmbih2YWx1ZSkpIHsKICAgICAgICBjb3VudCArKzsKICAgICAgfQogICAgfSk7CiAgICByZXR1cm4gY291bnQ7CiAgfSwKCgogIC8qKgogICAqIEBuZ2RvYyBmdW5jdGlvbgogICAqIEBuYW1lIGFuZ3VsYXIuQXJyYXkub3JkZXJCeQogICAqIEBmdW5jdGlvbgogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogT3JkZXJzIGBhcnJheWAgYnkgdGhlIGBleHByZXNzaW9uYCBwcmVkaWNhdGUuCiAgICoKICAgKiBOb3RlOiB0aGlzIGZ1bmN0aW9uIGlzIHVzZWQgdG8gYXVnbWVudCB0aGUgYEFycmF5YCB0eXBlIGluIGFuZ3VsYXIgZXhwcmVzc2lvbnMuIFNlZQogICAqIHtAbGluayBhbmd1bGFyLkFycmF5fSBmb3IgbW9yZSBpbmZvLgogICAqCiAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IHRvIHNvcnQuCiAgICogQHBhcmFtIHtmdW5jdGlvbigqKXxzdHJpbmd8QXJyYXkuPChmdW5jdGlvbigqKXxzdHJpbmcpPn0gZXhwcmVzc2lvbiBBIHByZWRpY2F0ZSB0byBiZQogICAqICAgIHVzZWQgYnkgdGhlIGNvbXBhcmF0b3IgdG8gZGV0ZXJtaW5lIHRoZSBvcmRlciBvZiBlbGVtZW50cy4KICAgKgogICAqICAgIENhbiBiZSBvbmUgb2Y6CiAgICoKICAgKiAgICAtIGBmdW5jdGlvbmA6IGdldHRlciBmdW5jdGlvbi4gVGhlIHJlc3VsdCBvZiB0aGlzIGZ1bmN0aW9uIHdpbGwgYmUgc29ydGVkIHVzaW5nIHRoZQogICAqICAgICAgYDxgLCBgPWAsIGA+YCBvcGVyYXRvcgogICAqICAgIC0gYHN0cmluZ2A6IGFuZ3VsYXIgZXhwcmVzc2lvbiB3aGljaCBldmFsdWF0ZXMgdG8gYW4gb2JqZWN0IHRvIG9yZGVyIGJ5LCBzdWNoIGFzICduYW1lJyB0bwogICAqICAgICAgc29ydCBieSBhIHByb3BlcnR5IGNhbGxlZCAnbmFtZScuIE9wdGlvbmFsbHkgcHJlZml4ZWQgd2l0aCBgK2Agb3IgYC1gIHRvIGNvbnRyb2wgYXNjZW5kaW5nCiAgICogICAgICBvciBkZXNjZW5kaW5nIHNvcnQgb3JkZXIgKGUuZy4gK25hbWUgb3IgLW5hbWUpLgogICAqICAgIC0gYEFycmF5YDogYXJyYXkgb2YgZnVuY3Rpb24gb3Igc3RyaW5nIHByZWRpY2F0ZXMsIHN1Y2ggdGhhdCBhIGZpcnN0IHByZWRpY2F0ZSBpbiB0aGUgYXJyYXkKICAgKiAgICAgIGlzIHVzZWQgZm9yIHNvcnRpbmcsIGJ1dCB3aGVuIHRoZSBpdGVtcyBhcmUgZXF1aXZhbGVudCBuZXh0IHByZWRpY2F0ZSBpcyB1c2VkLgogICAqCiAgICogQHBhcmFtIHtib29sZWFuPX0gcmV2ZXJzZSBSZXZlcnNlIHRoZSBvcmRlciB0aGUgYXJyYXkuCiAgICogQHJldHVybnMge0FycmF5fSBTb3J0ZWQgY29weSBvZiB0aGUgc291cmNlIGFycmF5LgogICAqCiAgICogQGV4YW1wbGUKICAgICA8ZG9jOmV4YW1wbGU+CiAgICAgICA8ZG9jOnNvdXJjZT4KICAgICAgICAgPGRpdiBuZzppbml0PSJmcmllbmRzID0gW3tuYW1lOidKb2huJywgcGhvbmU6JzU1NS0xMjEyJywgYWdlOjEwfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHtuYW1lOidNYXJ5JywgcGhvbmU6JzU1NS05ODc2JywgYWdlOjE5fSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHtuYW1lOidNaWtlJywgcGhvbmU6JzU1NS00MzIxJywgYWdlOjIxfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHtuYW1lOidBZGFtJywgcGhvbmU6JzU1NS01Njc4JywgYWdlOjM1fSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHtuYW1lOidKdWxpZScsIHBob25lOic1NTUtODc2NScsIGFnZToyOX1dIj48L2Rpdj4KCiAgICAgICAgIDxwcmU+U29ydGluZyBwcmVkaWNhdGUgPSB7e3ByZWRpY2F0ZX19OyByZXZlcnNlID0ge3tyZXZlcnNlfX08L3ByZT4KICAgICAgICAgPGhyLz4KICAgICAgICAgWyA8YSBocmVmPSIiIG5nOmNsaWNrPSJwcmVkaWNhdGU9JyciPnVuc29ydGVkPC9hPiBdCiAgICAgICAgIDx0YWJsZSBuZzppbml0PSJwcmVkaWNhdGU9Jy1hZ2UnIj4KICAgICAgICAgICA8dHI+CiAgICAgICAgICAgICA8dGg+PGEgaHJlZj0iIiBuZzpjbGljaz0icHJlZGljYXRlID0gJ25hbWUnOyByZXZlcnNlPWZhbHNlIj5OYW1lPC9hPgogICAgICAgICAgICAgICAgICg8YSBocmVmIG5nOmNsaWNrPSJwcmVkaWNhdGUgPSAnLW5hbWUnOyByZXZlcnNlPWZhbHNlIj5ePC9hPik8L3RoPgogICAgICAgICAgICAgPHRoPjxhIGhyZWY9IiIgbmc6Y2xpY2s9InByZWRpY2F0ZSA9ICdwaG9uZSc7IHJldmVyc2U9IXJldmVyc2UiPlBob25lIE51bWJlcjwvYT48L3RoPgogICAgICAgICAgICAgPHRoPjxhIGhyZWY9IiIgbmc6Y2xpY2s9InByZWRpY2F0ZSA9ICdhZ2UnOyByZXZlcnNlPSFyZXZlcnNlIj5BZ2U8L2E+PC90aD4KICAgICAgICAgICA8dHI+CiAgICAgICAgICAgPHRyIG5nOnJlcGVhdD0iZnJpZW5kIGluIGZyaWVuZHMuJG9yZGVyQnkocHJlZGljYXRlLCByZXZlcnNlKSI+CiAgICAgICAgICAgICA8dGQ+e3tmcmllbmQubmFtZX19PC90ZD4KICAgICAgICAgICAgIDx0ZD57e2ZyaWVuZC5waG9uZX19PC90ZD4KICAgICAgICAgICAgIDx0ZD57e2ZyaWVuZC5hZ2V9fTwvdGQ+CiAgICAgICAgICAgPHRyPgogICAgICAgICA8L3RhYmxlPgogICAgICAgPC9kb2M6c291cmNlPgogICAgICAgPGRvYzpzY2VuYXJpbz4KICAgICAgICAgaXQoJ3Nob3VsZCBiZSByZXZlcnNlIG9yZGVyZWQgYnkgYWdlZCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdwcmVkaWNhdGUnKSkudG9CZSgnU29ydGluZyBwcmVkaWNhdGUgPSAtYWdlOyByZXZlcnNlID0gJyk7CiAgICAgICAgICAgZXhwZWN0KHJlcGVhdGVyKCcuZG9jLWV4YW1wbGUtbGl2ZSB0YWJsZScsICdmcmllbmQgaW4gZnJpZW5kcycpLmNvbHVtbignZnJpZW5kLmFnZScpKS4KICAgICAgICAgICAgIHRvRXF1YWwoWyczNScsICcyOScsICcyMScsICcxOScsICcxMCddKTsKICAgICAgICAgICBleHBlY3QocmVwZWF0ZXIoJy5kb2MtZXhhbXBsZS1saXZlIHRhYmxlJywgJ2ZyaWVuZCBpbiBmcmllbmRzJykuY29sdW1uKCdmcmllbmQubmFtZScpKS4KICAgICAgICAgICAgIHRvRXF1YWwoWydBZGFtJywgJ0p1bGllJywgJ01pa2UnLCAnTWFyeScsICdKb2huJ10pOwogICAgICAgICB9KTsKCiAgICAgICAgIGl0KCdzaG91bGQgcmVvcmRlciB0aGUgdGFibGUgd2hlbiB1c2VyIHNlbGVjdHMgZGlmZmVyZW50IHByZWRpY2F0ZScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgIGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIGE6Y29udGFpbnMoIk5hbWUiKScpLmNsaWNrKCk7CiAgICAgICAgICAgZXhwZWN0KHJlcGVhdGVyKCcuZG9jLWV4YW1wbGUtbGl2ZSB0YWJsZScsICdmcmllbmQgaW4gZnJpZW5kcycpLmNvbHVtbignZnJpZW5kLm5hbWUnKSkuCiAgICAgICAgICAgICB0b0VxdWFsKFsnQWRhbScsICdKb2huJywgJ0p1bGllJywgJ01hcnknLCAnTWlrZSddKTsKICAgICAgICAgICBleHBlY3QocmVwZWF0ZXIoJy5kb2MtZXhhbXBsZS1saXZlIHRhYmxlJywgJ2ZyaWVuZCBpbiBmcmllbmRzJykuY29sdW1uKCdmcmllbmQuYWdlJykpLgogICAgICAgICAgICAgdG9FcXVhbChbJzM1JywgJzEwJywgJzI5JywgJzE5JywgJzIxJ10pOwoKICAgICAgICAgICBlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBhOmNvbnRhaW5zKCJQaG9uZSIpJykuY2xpY2soKTsKICAgICAgICAgICBleHBlY3QocmVwZWF0ZXIoJy5kb2MtZXhhbXBsZS1saXZlIHRhYmxlJywgJ2ZyaWVuZCBpbiBmcmllbmRzJykuY29sdW1uKCdmcmllbmQucGhvbmUnKSkuCiAgICAgICAgICAgICB0b0VxdWFsKFsnNTU1LTk4NzYnLCAnNTU1LTg3NjUnLCAnNTU1LTU2NzgnLCAnNTU1LTQzMjEnLCAnNTU1LTEyMTInXSk7CiAgICAgICAgICAgZXhwZWN0KHJlcGVhdGVyKCcuZG9jLWV4YW1wbGUtbGl2ZSB0YWJsZScsICdmcmllbmQgaW4gZnJpZW5kcycpLmNvbHVtbignZnJpZW5kLm5hbWUnKSkuCiAgICAgICAgICAgICB0b0VxdWFsKFsnTWFyeScsICdKdWxpZScsICdBZGFtJywgJ01pa2UnLCAnSm9obiddKTsKICAgICAgICAgfSk7CiAgICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICA8L2RvYzpleGFtcGxlPgogICAqLwogICdvcmRlckJ5JzpmdW5jdGlvbihhcnJheSwgc29ydFByZWRpY2F0ZSwgcmV2ZXJzZU9yZGVyKSB7CiAgICBpZiAoIXNvcnRQcmVkaWNhdGUpIHJldHVybiBhcnJheTsKICAgIHNvcnRQcmVkaWNhdGUgPSBpc0FycmF5KHNvcnRQcmVkaWNhdGUpID8gc29ydFByZWRpY2F0ZTogW3NvcnRQcmVkaWNhdGVdOwogICAgc29ydFByZWRpY2F0ZSA9IG1hcChzb3J0UHJlZGljYXRlLCBmdW5jdGlvbihwcmVkaWNhdGUpewogICAgICB2YXIgZGVzY2VuZGluZyA9IGZhbHNlLCBnZXQgPSBwcmVkaWNhdGUgfHwgaWRlbnRpdHk7CiAgICAgIGlmIChpc1N0cmluZyhwcmVkaWNhdGUpKSB7CiAgICAgICAgaWYgKChwcmVkaWNhdGUuY2hhckF0KDApID09ICcrJyB8fCBwcmVkaWNhdGUuY2hhckF0KDApID09ICctJykpIHsKICAgICAgICAgIGRlc2NlbmRpbmcgPSBwcmVkaWNhdGUuY2hhckF0KDApID09ICctJzsKICAgICAgICAgIHByZWRpY2F0ZSA9IHByZWRpY2F0ZS5zdWJzdHJpbmcoMSk7CiAgICAgICAgfQogICAgICAgIGdldCA9IGV4cHJlc3Npb25Db21waWxlKHByZWRpY2F0ZSkuZm5TZWxmOwogICAgICB9CiAgICAgIHJldHVybiByZXZlcnNlQ29tcGFyYXRvcihmdW5jdGlvbihhLGIpewogICAgICAgIHJldHVybiBjb21wYXJlKGdldChhKSxnZXQoYikpOwogICAgICB9LCBkZXNjZW5kaW5nKTsKICAgIH0pOwogICAgdmFyIGFycmF5Q29weSA9IFtdOwogICAgZm9yICggdmFyIGkgPSAwOyBpIDwgYXJyYXkubGVuZ3RoOyBpKyspIHsgYXJyYXlDb3B5LnB1c2goYXJyYXlbaV0pOyB9CiAgICByZXR1cm4gYXJyYXlDb3B5LnNvcnQocmV2ZXJzZUNvbXBhcmF0b3IoY29tcGFyYXRvciwgcmV2ZXJzZU9yZGVyKSk7CgogICAgZnVuY3Rpb24gY29tcGFyYXRvcihvMSwgbzIpewogICAgICBmb3IgKCB2YXIgaSA9IDA7IGkgPCBzb3J0UHJlZGljYXRlLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgdmFyIGNvbXAgPSBzb3J0UHJlZGljYXRlW2ldKG8xLCBvMik7CiAgICAgICAgaWYgKGNvbXAgIT09IDApIHJldHVybiBjb21wOwogICAgICB9CiAgICAgIHJldHVybiAwOwogICAgfQogICAgZnVuY3Rpb24gcmV2ZXJzZUNvbXBhcmF0b3IoY29tcCwgZGVzY2VuZGluZykgewogICAgICByZXR1cm4gdG9Cb29sZWFuKGRlc2NlbmRpbmcpCiAgICAgICAgICA/IGZ1bmN0aW9uKGEsYil7cmV0dXJuIGNvbXAoYixhKTt9CiAgICAgICAgICA6IGNvbXA7CiAgICB9CiAgICBmdW5jdGlvbiBjb21wYXJlKHYxLCB2Mil7CiAgICAgIHZhciB0MSA9IHR5cGVvZiB2MTsKICAgICAgdmFyIHQyID0gdHlwZW9mIHYyOwogICAgICBpZiAodDEgPT0gdDIpIHsKICAgICAgICBpZiAodDEgPT0gInN0cmluZyIpIHYxID0gdjEudG9Mb3dlckNhc2UoKTsKICAgICAgICBpZiAodDEgPT0gInN0cmluZyIpIHYyID0gdjIudG9Mb3dlckNhc2UoKTsKICAgICAgICBpZiAodjEgPT09IHYyKSByZXR1cm4gMDsKICAgICAgICByZXR1cm4gdjEgPCB2MiA/IC0xIDogMTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gdDEgPCB0MiA/IC0xIDogMTsKICAgICAgfQogICAgfQogIH0sCgoKICAvKioKICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgKiBAbmFtZSBhbmd1bGFyLkFycmF5LmxpbWl0VG8KICAgKiBAZnVuY3Rpb24KICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIENyZWF0ZXMgYSBuZXcgYXJyYXkgY29udGFpbmluZyBvbmx5IHRoZSBmaXJzdCwgb3IgbGFzdCBgbGltaXRgIG51bWJlciBvZiBlbGVtZW50cyBvZiB0aGUKICAgKiBzb3VyY2UgYGFycmF5YC4KICAgKgogICAqIE5vdGU6IHRoaXMgZnVuY3Rpb24gaXMgdXNlZCB0byBhdWdtZW50IHRoZSBgQXJyYXlgIHR5cGUgaW4gYW5ndWxhciBleHByZXNzaW9ucy4gU2VlCiAgICoge0BsaW5rIGFuZ3VsYXIuQXJyYXl9IGZvciBtb3JlIGluZm8uCiAgICoKICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBTb3VyY2UgYXJyYXkgdG8gYmUgbGltaXRlZC4KICAgKiBAcGFyYW0ge3N0cmluZ3xOdW1iZXJ9IGxpbWl0IFRoZSBsZW5ndGggb2YgdGhlIHJldHVybmVkIGFycmF5LiBJZiB0aGUgbnVtYmVyIGlzIHBvc2l0aXZlLCB0aGUKICAgKiAgICAgZmlyc3QgYGxpbWl0YCBpdGVtcyBmcm9tIHRoZSBzb3VyY2UgYXJyYXkgd2lsbCBiZSBjb3BpZWQsIGlmIHRoZSBudW1iZXIgaXMgbmVnYXRpdmUsIHRoZQogICAqICAgICBsYXN0IGBsaW1pdGAgaXRlbXMgd2lsbCBiZSBjb3BpZWQuCiAgICogQHJldHVybnMge0FycmF5fSBBIG5ldyBzdWItYXJyYXkgb2YgbGVuZ3RoIGBsaW1pdGAuCiAgICoKICAgKiBAZXhhbXBsZQogICAgIDxkb2M6ZXhhbXBsZT4KICAgICAgIDxkb2M6c291cmNlPgogICAgICAgICA8ZGl2IG5nOmluaXQ9Im51bWJlcnMgPSBbMSwyLDMsNCw1LDYsNyw4LDldIj4KICAgICAgICAgICBMaW1pdCBbMSwyLDMsNCw1LDYsNyw4LDldIHRvOiA8aW5wdXQgbmFtZT0ibGltaXQiIHZhbHVlPSIzIi8+CiAgICAgICAgICAgPHA+T3V0cHV0OiB7eyBudW1iZXJzLiRsaW1pdFRvKGxpbWl0KSB8IGpzb24gfX08L3A+CiAgICAgICAgIDwvZGl2PgogICAgICAgPC9kb2M6c291cmNlPgogICAgICAgPGRvYzpzY2VuYXJpbz4KICAgICAgICAgaXQoJ3Nob3VsZCBsaW1pdCB0aGUgbnVtZXIgYXJyYXkgdG8gZmlyc3QgdGhyZWUgaXRlbXMnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgaW5wdXRbbmFtZT1saW1pdF0nKS52YWwoKSkudG9CZSgnMycpOwogICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdudW1iZXJzLiRsaW1pdFRvKGxpbWl0KSB8IGpzb24nKSkudG9FcXVhbCgnWzEsMiwzXScpOwogICAgICAgICB9KTsKCiAgICAgICAgIGl0KCdzaG91bGQgdXBkYXRlIHRoZSBvdXRwdXQgd2hlbiAtMyBpcyBlbnRlcmVkJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgaW5wdXQoJ2xpbWl0JykuZW50ZXIoLTMpOwogICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdudW1iZXJzLiRsaW1pdFRvKGxpbWl0KSB8IGpzb24nKSkudG9FcXVhbCgnWzcsOCw5XScpOwogICAgICAgICB9KTsKICAgICAgIDwvZG9jOnNjZW5hcmlvPgogICAgIDwvZG9jOmV4YW1wbGU+CiAgICovCiAgbGltaXRUbzogZnVuY3Rpb24oYXJyYXksIGxpbWl0KSB7CiAgICBsaW1pdCA9IHBhcnNlSW50KGxpbWl0LCAxMCk7CiAgICB2YXIgb3V0ID0gW10sCiAgICAgICAgaSwgbjsKCiAgICBpZiAobGltaXQgPiAwKSB7CiAgICAgIGkgPSAwOwogICAgICBuID0gbGltaXQ7CiAgICB9IGVsc2UgewogICAgICBpID0gYXJyYXkubGVuZ3RoICsgbGltaXQ7CiAgICAgIG4gPSBhcnJheS5sZW5ndGg7CiAgICB9CgogICAgZm9yICg7IGk8bjsgaSsrKSB7CiAgICAgIG91dC5wdXNoKGFycmF5W2ldKTsKICAgIH0KCiAgICByZXR1cm4gb3V0OwogIH0KfTsKCnZhciBSX0lTTzgwNjFfU1RSID0gL14oXGR7NH0pLShcZFxkKS0oXGRcZCkoPzpUKFxkXGQpKD86XDooXGRcZCkoPzpcOihcZFxkKSg/OlwuKFxkezN9KSk/KT8pP1opPyQvOwoKdmFyIGFuZ3VsYXJTdHJpbmcgPSB7CiAgJ3F1b3RlJzpmdW5jdGlvbihzdHJpbmcpIHsKICAgIHJldHVybiAnIicgKyBzdHJpbmcucmVwbGFjZSgvXFwvZywgJ1xcXFwnKS4KICAgICAgICAgICAgICAgICAgICAgICAgcmVwbGFjZSgvIi9nLCAnXFwiJykuCiAgICAgICAgICAgICAgICAgICAgICAgIHJlcGxhY2UoL1xuL2csICdcXG4nKS4KICAgICAgICAgICAgICAgICAgICAgICAgcmVwbGFjZSgvXGYvZywgJ1xcZicpLgogICAgICAgICAgICAgICAgICAgICAgICByZXBsYWNlKC9cci9nLCAnXFxyJykuCiAgICAgICAgICAgICAgICAgICAgICAgIHJlcGxhY2UoL1x0L2csICdcXHQnKS4KICAgICAgICAgICAgICAgICAgICAgICAgcmVwbGFjZSgvXHYvZywgJ1xcdicpICsKICAgICAgICAgICAgICciJzsKICB9LAogICdxdW90ZVVuaWNvZGUnOmZ1bmN0aW9uKHN0cmluZykgewogICAgdmFyIHN0ciA9IGFuZ3VsYXJbJ1N0cmluZyddWydxdW90ZSddKHN0cmluZyk7CiAgICB2YXIgY2hhcnMgPSBbXTsKICAgIGZvciAoIHZhciBpID0gMDsgaSA8IHN0ci5sZW5ndGg7IGkrKykgewogICAgICB2YXIgY2ggPSBzdHIuY2hhckNvZGVBdChpKTsKICAgICAgaWYgKGNoIDwgMTI4KSB7CiAgICAgICAgY2hhcnMucHVzaChzdHIuY2hhckF0KGkpKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB2YXIgZW5jb2RlID0gIjAwMCIgKyBjaC50b1N0cmluZygxNik7CiAgICAgICAgY2hhcnMucHVzaCgiXFx1IiArIGVuY29kZS5zdWJzdHJpbmcoZW5jb2RlLmxlbmd0aCAtIDQpKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIGNoYXJzLmpvaW4oJycpOwogIH0sCgogIC8qKgogICAqIFRyaWVzIHRvIGNvbnZlcnQgaW5wdXQgdG8gZGF0ZSBhbmQgaWYgc3VjY2Vzc2Z1bCByZXR1cm5zIHRoZSBkYXRlLCBvdGhlcndpc2UgcmV0dXJucyB0aGUgaW5wdXQuCiAgICogQHBhcmFtIHtzdHJpbmd9IHN0cmluZwogICAqIEByZXR1cm4geyhEYXRlfHN0cmluZyl9CiAgICovCiAgJ3RvRGF0ZSc6ZnVuY3Rpb24oc3RyaW5nKXsKICAgIHZhciBtYXRjaDsKICAgIGlmIChpc1N0cmluZyhzdHJpbmcpICYmIChtYXRjaCA9IHN0cmluZy5tYXRjaChSX0lTTzgwNjFfU1RSKSkpewogICAgICB2YXIgZGF0ZSA9IG5ldyBEYXRlKDApOwogICAgICBkYXRlLnNldFVUQ0Z1bGxZZWFyKG1hdGNoWzFdLCBtYXRjaFsyXSAtIDEsIG1hdGNoWzNdKTsKICAgICAgZGF0ZS5zZXRVVENIb3VycyhtYXRjaFs0XXx8MCwgbWF0Y2hbNV18fDAsIG1hdGNoWzZdfHwwLCBtYXRjaFs3XXx8MCk7CiAgICAgIHJldHVybiBkYXRlOwogICAgfQogICAgcmV0dXJuIHN0cmluZzsKICB9Cn07Cgp2YXIgYW5ndWxhckRhdGUgPSB7CiAgICAndG9TdHJpbmcnOmZ1bmN0aW9uKGRhdGUpewogICAgICAgaWYgKCFkYXRlKSByZXR1cm4gZGF0ZTsKCiAgICAgICB2YXIgaXNvU3RyaW5nID0gZGF0ZS50b0lTT1N0cmluZyA/IGRhdGUudG9JU09TdHJpbmcoKSA6ICcnOwoKICAgICAgIHJldHVybiAoaXNvU3RyaW5nLmxlbmd0aD09MjQpID8KICAgICAgICAgICAgICAgIGlzb1N0cmluZyA6CiAgICAgICAgICAgICAgICBwYWROdW1iZXIoZGF0ZS5nZXRVVENGdWxsWWVhcigpLCA0KSArICctJyArCiAgICAgICAgICAgICAgICAgIHBhZE51bWJlcihkYXRlLmdldFVUQ01vbnRoKCkgKyAxLCAyKSArICctJyArCiAgICAgICAgICAgICAgICAgIHBhZE51bWJlcihkYXRlLmdldFVUQ0RhdGUoKSwgMikgKyAnVCcgKwogICAgICAgICAgICAgICAgICBwYWROdW1iZXIoZGF0ZS5nZXRVVENIb3VycygpLCAyKSArICc6JyArCiAgICAgICAgICAgICAgICAgIHBhZE51bWJlcihkYXRlLmdldFVUQ01pbnV0ZXMoKSwgMikgKyAnOicgKwogICAgICAgICAgICAgICAgICBwYWROdW1iZXIoZGF0ZS5nZXRVVENTZWNvbmRzKCksIDIpICsgJy4nICsKICAgICAgICAgICAgICAgICAgcGFkTnVtYmVyKGRhdGUuZ2V0VVRDTWlsbGlzZWNvbmRzKCksIDMpICsgJ1onOwogICAgfQogIH07Cgp2YXIgYW5ndWxhckZ1bmN0aW9uID0gewogICdjb21waWxlJzpmdW5jdGlvbihleHByZXNzaW9uKSB7CiAgICBpZiAoaXNGdW5jdGlvbihleHByZXNzaW9uKSl7CiAgICAgIHJldHVybiBleHByZXNzaW9uOwogICAgfSBlbHNlIGlmIChleHByZXNzaW9uKXsKICAgICAgcmV0dXJuIGV4cHJlc3Npb25Db21waWxlKGV4cHJlc3Npb24pLmZuU2VsZjsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBpZGVudGl0eTsKICAgIH0KICB9Cn07CgovKioKICogQ29tcHV0ZXMgYSBoYXNoIG9mIGFuICdvYmonLgogKiBIYXNoIG9mIGE6CiAqICBzdHJpbmcgaXMgc3RyaW5nCiAqICBudW1iZXIgaXMgbnVtYmVyIGFzIHN0cmluZwogKiAgb2JqZWN0IGlzIGVpdGhlciBjYWxsICRoYXNoS2V5IGZ1bmN0aW9uIG9uIG9iamVjdCBvciBhc3NpZ24gdW5pcXVlIGhhc2hLZXkgaWQuCiAqCiAqIEBwYXJhbSBvYmoKICogQHJldHVybnMge1N0cmluZ30gaGFzaCBzdHJpbmcgc3VjaCB0aGF0IHRoZSBzYW1lIGlucHV0IHdpbGwgaGF2ZSB0aGUgc2FtZSBoYXNoIHN0cmluZwogKi8KZnVuY3Rpb24gaGFzaEtleShvYmopIHsKICB2YXIgb2JqVHlwZSA9IHR5cGVvZiBvYmo7CiAgdmFyIGtleSA9IG9iajsKICBpZiAob2JqVHlwZSA9PSAnb2JqZWN0JykgewogICAgaWYgKHR5cGVvZiAoa2V5ID0gb2JqLiRoYXNoS2V5KSA9PSAnZnVuY3Rpb24nKSB7CiAgICAgIC8vIG11c3QgaW52b2tlIG9uIG9iamVjdCB0byBrZWVwIHRoZSByaWdodCB0aGlzCiAgICAgIGtleSA9IG9iai4kaGFzaEtleSgpOwogICAgfSBlbHNlIGlmIChrZXkgPT09IHVuZGVmaW5lZCkgewogICAgICBrZXkgPSBvYmouJGhhc2hLZXkgPSBuZXh0VWlkKCk7CiAgICB9CiAgfTsKICByZXR1cm4gb2JqVHlwZSArICc6JyArIGtleTsKfQoKLyoqCiAqIEhhc2hNYXAgd2hpY2ggY2FuIHVzZSBvYmplY3RzIGFzIGtleXMKICovCmZ1bmN0aW9uIEhhc2hNYXAoKXt9Ckhhc2hNYXAucHJvdG90eXBlID0gewogIC8qKgogICAqIFN0b3JlIGtleSB2YWx1ZSBwYWlyCiAgICogQHBhcmFtIGtleSBrZXkgdG8gc3RvcmUgY2FuIGJlIGFueSB0eXBlCiAgICogQHBhcmFtIHZhbHVlIHZhbHVlIHRvIHN0b3JlIGNhbiBiZSBhbnkgdHlwZQogICAqIEByZXR1cm5zIG9sZCB2YWx1ZSBpZiBhbnkKICAgKi8KICBwdXQ6IGZ1bmN0aW9uKGtleSwgdmFsdWUpIHsKICAgIHZhciBfa2V5ID0gaGFzaEtleShrZXkpOwogICAgdmFyIG9sZFZhbHVlID0gdGhpc1tfa2V5XTsKICAgIHRoaXNbX2tleV0gPSB2YWx1ZTsKICAgIHJldHVybiBvbGRWYWx1ZTsKICB9LAoKICAvKioKICAgKiBAcGFyYW0ga2V5CiAgICogQHJldHVybnMgdGhlIHZhbHVlIGZvciB0aGUga2V5CiAgICovCiAgZ2V0OiBmdW5jdGlvbihrZXkpIHsKICAgIHJldHVybiB0aGlzW2hhc2hLZXkoa2V5KV07CiAgfSwKCiAgLyoqCiAgICogUmVtb3ZlIHRoZSBrZXkvdmFsdWUgcGFpcgogICAqIEBwYXJhbSBrZXkKICAgKiBAcmV0dXJucyB2YWx1ZSBhc3NvY2lhdGVkIHdpdGgga2V5IGJlZm9yZSBpdCB3YXMgcmVtb3ZlZAogICAqLwogIHJlbW92ZTogZnVuY3Rpb24oa2V5KSB7CiAgICB2YXIgX2tleSA9IGhhc2hLZXkoa2V5KTsKICAgIHZhciB2YWx1ZSA9IHRoaXNbX2tleV07CiAgICBkZWxldGUgdGhpc1tfa2V5XTsKICAgIHJldHVybiB2YWx1ZTsKICB9Cn07CgpmdW5jdGlvbiBkZWZpbmVBcGkoZHN0LCBjaGFpbil7CiAgYW5ndWxhcltkc3RdID0gYW5ndWxhcltkc3RdIHx8IHt9OwogIGZvckVhY2goY2hhaW4sIGZ1bmN0aW9uKHBhcmVudCl7CiAgICBleHRlbmQoYW5ndWxhcltkc3RdLCBwYXJlbnQpOwogIH0pOwp9CmRlZmluZUFwaSgnR2xvYmFsJywgW2FuZ3VsYXJHbG9iYWxdKTsKZGVmaW5lQXBpKCdDb2xsZWN0aW9uJywgW2FuZ3VsYXJHbG9iYWwsIGFuZ3VsYXJDb2xsZWN0aW9uXSk7CmRlZmluZUFwaSgnQXJyYXknLCBbYW5ndWxhckdsb2JhbCwgYW5ndWxhckNvbGxlY3Rpb24sIGFuZ3VsYXJBcnJheV0pOwpkZWZpbmVBcGkoJ09iamVjdCcsIFthbmd1bGFyR2xvYmFsLCBhbmd1bGFyQ29sbGVjdGlvbiwgYW5ndWxhck9iamVjdF0pOwpkZWZpbmVBcGkoJ1N0cmluZycsIFthbmd1bGFyR2xvYmFsLCBhbmd1bGFyU3RyaW5nXSk7CmRlZmluZUFwaSgnRGF0ZScsIFthbmd1bGFyR2xvYmFsLCBhbmd1bGFyRGF0ZV0pOwovL0lFIGJ1Zwphbmd1bGFyLkRhdGUudG9TdHJpbmcgPSBhbmd1bGFyRGF0ZS50b1N0cmluZzsKZGVmaW5lQXBpKCdGdW5jdGlvbicsIFthbmd1bGFyR2xvYmFsLCBhbmd1bGFyQ29sbGVjdGlvbiwgYW5ndWxhckZ1bmN0aW9uXSk7Cid1c2Ugc3RyaWN0JzsKCi8qKgogKiBAd29ya0luUHJvZ3Jlc3MKICogQG5nZG9jIG92ZXJ2aWV3CiAqIEBuYW1lIGFuZ3VsYXIuZmlsdGVyCiAqIEBkZXNjcmlwdGlvbgogKgogKiBGaWx0ZXJzIGFyZSB1c2VkIGZvciBmb3JtYXR0aW5nIGRhdGEgZGlzcGxheWVkIHRvIHRoZSB1c2VyLgogKgogKiBUaGUgZ2VuZXJhbCBzeW50YXggaW4gdGVtcGxhdGVzIGlzIGFzIGZvbGxvd3M6CiAqCiAqICAgICAgICAge3sgZXhwcmVzc2lvbiB8IFsgZmlsdGVyX25hbWUgXSB9fQogKgogKiBGb2xsb3dpbmcgaXMgdGhlIGxpc3Qgb2YgYnVpbHQtaW4gYW5ndWxhciBmaWx0ZXJzOgogKgogKiAqIHtAbGluayBhbmd1bGFyLmZpbHRlci5jdXJyZW5jeSBjdXJyZW5jeX0KICogKiB7QGxpbmsgYW5ndWxhci5maWx0ZXIuZGF0ZSBkYXRlfQogKiAqIHtAbGluayBhbmd1bGFyLmZpbHRlci5odG1sIGh0bWx9CiAqICoge0BsaW5rIGFuZ3VsYXIuZmlsdGVyLmpzb24ganNvbn0KICogKiB7QGxpbmsgYW5ndWxhci5maWx0ZXIubGlua3kgbGlua3l9CiAqICoge0BsaW5rIGFuZ3VsYXIuZmlsdGVyLmxvd2VyY2FzZSBsb3dlcmNhc2V9CiAqICoge0BsaW5rIGFuZ3VsYXIuZmlsdGVyLm51bWJlciBudW1iZXJ9CiAqICoge0BsaW5rIGFuZ3VsYXIuZmlsdGVyLnVwcGVyY2FzZSB1cHBlcmNhc2V9CiAqCiAqIEZvciBtb3JlIGluZm9ybWF0aW9uIGFib3V0IGhvdyBhbmd1bGFyIGZpbHRlcnMgd29yaywgYW5kIGhvdyB0byBjcmVhdGUgeW91ciBvd24gZmlsdGVycywgc2VlCiAqIHtAbGluayBndWlkZS9kZXZfZ3VpZGUudGVtcGxhdGVzLmZpbHRlcnMgVW5kZXJzdGFuZGluZyBBbmd1bGFyIEZpbHRlcnN9IGluIHRoZSBhbmd1bGFyIERldmVsb3BlcgogKiBHdWlkZS4KICovCgovKioKICogQHdvcmtJblByb2dyZXNzCiAqIEBuZ2RvYyBmaWx0ZXIKICogQG5hbWUgYW5ndWxhci5maWx0ZXIuY3VycmVuY3kKICogQGZ1bmN0aW9uCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBGb3JtYXRzIGEgbnVtYmVyIGFzIGEgY3VycmVuY3kgKGllICQxLDIzNC41NikuIFdoZW4gbm8gY3VycmVuY3kgc3ltYm9sIGlzIHByb3ZpZGVkLCBkZWZhdWx0CiAqIHN5bWJvbCBmb3IgY3VycmVudCBsb2NhbGUgaXMgdXNlZC4KICoKICogQHBhcmFtIHtudW1iZXJ9IGFtb3VudCBJbnB1dCB0byBmaWx0ZXIuCiAqIEBwYXJhbSB7c3RyaW5nPX0gc3ltYm9sIEN1cnJlbmN5IHN5bWJvbCBvciBpZGVudGlmaWVyIHRvIGJlIGRpc3BsYXllZC4KICogQHJldHVybnMge3N0cmluZ30gRm9ybWF0dGVkIG51bWJlci4KICoKICogQGNzcyBuZy1mb3JtYXQtbmVnYXRpdmUKICogICBXaGVuIHRoZSB2YWx1ZSBpcyBuZWdhdGl2ZSwgdGhpcyBjc3MgY2xhc3MgaXMgYXBwbGllZCB0byB0aGUgYmluZGluZyBtYWtpbmcgaXQgKGJ5IGRlZmF1bHQpIHJlZC4KICoKICogQGV4YW1wbGUKICAgPGRvYzpleGFtcGxlPgogICAgIDxkb2M6c291cmNlPgogICAgICAgPGlucHV0IHR5cGU9InRleHQiIG5hbWU9ImFtb3VudCIgdmFsdWU9IjEyMzQuNTYiLz4gPGJyLz4KICAgICAgIGRlZmF1bHQgY3VycmVuY3kgc3ltYm9sICgkKToge3thbW91bnQgfCBjdXJyZW5jeX19PGJyLz4KICAgICAgIGN1c3RvbSBjdXJyZW5jeSBpZGVudGlmaWVyIChVU0QkKToge3thbW91bnQgfCBjdXJyZW5jeToiVVNEJCJ9fQogICAgIDwvZG9jOnNvdXJjZT4KICAgICA8ZG9jOnNjZW5hcmlvPgogICAgICAgaXQoJ3Nob3VsZCBpbml0IHdpdGggMTIzNC41NicsIGZ1bmN0aW9uKCl7CiAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdhbW91bnQgfCBjdXJyZW5jeScpKS50b0JlKCckMSwyMzQuNTYnKTsKICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ2Ftb3VudCB8IGN1cnJlbmN5OiJVU0QkIicpKS50b0JlKCdVU0QkMSwyMzQuNTYnKTsKICAgICAgIH0pOwogICAgICAgaXQoJ3Nob3VsZCB1cGRhdGUnLCBmdW5jdGlvbigpewogICAgICAgICBpbnB1dCgnYW1vdW50JykuZW50ZXIoJy0xMjM0Jyk7CiAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdhbW91bnQgfCBjdXJyZW5jeScpKS50b0JlKCcoJDEsMjM0LjAwKScpOwogICAgICAgICBleHBlY3QoYmluZGluZygnYW1vdW50IHwgY3VycmVuY3k6IlVTRCQiJykpLnRvQmUoJyhVU0QkMSwyMzQuMDApJyk7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSAubmctYmluZGluZycpLmF0dHIoJ2NsYXNzTmFtZScpKS4KICAgICAgICAgICB0b01hdGNoKC9uZy1mb3JtYXQtbmVnYXRpdmUvKTsKICAgICAgIH0pOwogICAgIDwvZG9jOnNjZW5hcmlvPgogICA8L2RvYzpleGFtcGxlPgogKi8KYW5ndWxhckZpbHRlci5jdXJyZW5jeSA9IGZ1bmN0aW9uKGFtb3VudCwgY3VycmVuY3lTeW1ib2wpewogIHRoaXMuJGVsZW1lbnQudG9nZ2xlQ2xhc3MoJ25nLWZvcm1hdC1uZWdhdGl2ZScsIGFtb3VudCA8IDApOwogIGlmIChpc1VuZGVmaW5lZChjdXJyZW5jeVN5bWJvbCkpIGN1cnJlbmN5U3ltYm9sID0gTlVNQkVSX0ZPUk1BVFMuQ1VSUkVOQ1lfU1lNOwogIHJldHVybiBmb3JtYXROdW1iZXIoYW1vdW50LCAyLCAxKS5yZXBsYWNlKC9cdTAwQTQvZywgY3VycmVuY3lTeW1ib2wpOwp9OwoKLyoqCiAqIEB3b3JrSW5Qcm9ncmVzcwogKiBAbmdkb2MgZmlsdGVyCiAqIEBuYW1lIGFuZ3VsYXIuZmlsdGVyLm51bWJlcgogKiBAZnVuY3Rpb24KICoKICogQGRlc2NyaXB0aW9uCiAqIEZvcm1hdHMgYSBudW1iZXIgYXMgdGV4dC4KICoKICogSWYgdGhlIGlucHV0IGlzIG5vdCBhIG51bWJlciBhbiBlbXB0eSBzdHJpbmcgaXMgcmV0dXJuZWQuCiAqCiAqIEBwYXJhbSB7bnVtYmVyfHN0cmluZ30gbnVtYmVyIE51bWJlciB0byBmb3JtYXQuCiAqIEBwYXJhbSB7KG51bWJlcnxzdHJpbmcpPX0gW2ZyYWN0aW9uU2l6ZT0yXSBOdW1iZXIgb2YgZGVjaW1hbCBwbGFjZXMgdG8gcm91bmQgdGhlIG51bWJlciB0by4KICogQHJldHVybnMge3N0cmluZ30gTnVtYmVyIHJvdW5kZWQgdG8gZGVjaW1hbFBsYWNlcyBhbmQgcGxhY2VzIGEg4oCcLOKAnSBhZnRlciBlYWNoIHRoaXJkIGRpZ2l0LgogKgogKiBAZXhhbXBsZQogICA8ZG9jOmV4YW1wbGU+CiAgICAgPGRvYzpzb3VyY2U+CiAgICAgICBFbnRlciBudW1iZXI6IDxpbnB1dCBuYW1lPSd2YWwnIHZhbHVlPScxMjM0LjU2Nzg5JyAvPjxici8+CiAgICAgICBEZWZhdWx0IGZvcm1hdHRpbmc6IHt7dmFsIHwgbnVtYmVyfX08YnIvPgogICAgICAgTm8gZnJhY3Rpb25zOiB7e3ZhbCB8IG51bWJlcjowfX08YnIvPgogICAgICAgTmVnYXRpdmUgbnVtYmVyOiB7ey12YWwgfCBudW1iZXI6NH19CiAgICAgPC9kb2M6c291cmNlPgogICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgICBpdCgnc2hvdWxkIGZvcm1hdCBudW1iZXJzJywgZnVuY3Rpb24oKXsKICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3ZhbCB8IG51bWJlcicpKS50b0JlKCcxLDIzNC41NjgnKTsKICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3ZhbCB8IG51bWJlcjowJykpLnRvQmUoJzEsMjM1Jyk7CiAgICAgICAgIGV4cGVjdChiaW5kaW5nKCctdmFsIHwgbnVtYmVyOjQnKSkudG9CZSgnLTEsMjM0LjU2NzknKTsKICAgICAgIH0pOwoKICAgICAgIGl0KCdzaG91bGQgdXBkYXRlJywgZnVuY3Rpb24oKXsKICAgICAgICAgaW5wdXQoJ3ZhbCcpLmVudGVyKCczMzc0LjMzMycpOwogICAgICAgICBleHBlY3QoYmluZGluZygndmFsIHwgbnVtYmVyJykpLnRvQmUoJzMsMzc0LjMzMycpOwogICAgICAgICBleHBlY3QoYmluZGluZygndmFsIHwgbnVtYmVyOjAnKSkudG9CZSgnMywzNzQnKTsKICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJy12YWwgfCBudW1iZXI6NCcpKS50b0JlKCctMywzNzQuMzMzMCcpOwogICAgICAgfSk7CiAgICAgPC9kb2M6c2NlbmFyaW8+CiAgIDwvZG9jOmV4YW1wbGU+CiAqLwoKLy8gUEFUVEVSTlNbMF0gaXMgYW4gYXJyYXkgZm9yIERlY2ltYWwgUGF0dGVybiwgUEFUVEVSTlNbMV0gaXMgYW4gYXJyYXkgQ3VycmVuY3kgUGF0dGVybgovLyBGb2xsb3dpbmcgaXMgdGhlIG9yZGVyIGluIGVhY2ggcGF0dGVybiBhcnJheToKLy8gMDogbWluSW50ZWdlciwKLy8gMTogbWluRnJhY3Rpb24sCi8vIDI6IG1heEZyYWN0aW9uLAovLyAzOiBwb3NpdGl2ZVByZWZpeCwKLy8gNDogcG9zaXRpdmVTdWZmaXgsCi8vIDU6IG5lZ2F0aXZlUHJlZml4LAovLyA2OiBuZWdhdGl2ZVN1ZmZpeCwKLy8gNzogZ3JvdXBTaXplLAovLyA4OiBsYXN0R3JvdXBTaXplCnZhciBOVU1CRVJfRk9STUFUUyA9IHsKICAgICAgREVDSU1BTF9TRVA6ICcuJywKICAgICAgR1JPVVBfU0VQOiAnLCcsCiAgICAgIFBBVFRFUk5TOiBbWzEsIDAsIDMsICcnLCAnJywgJy0nLCAnJywgMywgM10sWzEsIDIsIDIsICdcdTAwQTQnLCAnJywgJyhcdTAwQTQnLCAnKScsIDMsIDNdXSwKICAgICAgQ1VSUkVOQ1lfU1lNOiAnJCcKfTsKdmFyIERFQ0lNQUxfU0VQID0gJy4nOwoKYW5ndWxhckZpbHRlci5udW1iZXIgPSBmdW5jdGlvbihudW1iZXIsIGZyYWN0aW9uU2l6ZSkgewogIGlmIChpc05hTihudW1iZXIpIHx8ICFpc0Zpbml0ZShudW1iZXIpKSByZXR1cm4gJyc7CiAgcmV0dXJuIGZvcm1hdE51bWJlcihudW1iZXIsIGZyYWN0aW9uU2l6ZSwgMCk7Cn07CgpmdW5jdGlvbiBmb3JtYXROdW1iZXIobnVtYmVyLCBmcmFjdGlvblNpemUsIHR5cGUpIHsKICB2YXIgaXNOZWdhdGl2ZSA9IG51bWJlciA8IDAsCiAgICAgIHR5cGUgPSB0eXBlIHx8IDAsIC8vIDAgaXMgZGVjaW1hbCBwYXR0ZXJuLCAxIGlzIGN1cnJlbmN5IHBhdHRlcm4KICAgICAgcGF0dGVybiA9IE5VTUJFUl9GT1JNQVRTLlBBVFRFUk5TW3R5cGVdOwoKICBudW1iZXIgPSBNYXRoLmFicyhudW1iZXIpOwogIHZhciBudW1TdHIgPSAgbnVtYmVyICsgJycsCiAgICAgIGZvcm1hdGVkVGV4dCA9ICcnLAogICAgICBwYXJ0cyA9IFtdOwoKICBpZiAobnVtU3RyLmluZGV4T2YoJ2UnKSAhPT0gLTEpIHsKICAgIHZhciBmb3JtYXRlZFRleHQgPSBudW1TdHI7CiAgfSBlbHNlIHsKICAgIHZhciBmcmFjdGlvbkxlbiA9IChudW1TdHIuc3BsaXQoREVDSU1BTF9TRVApWzFdIHx8ICcnKS5sZW5ndGg7CgogICAgLy9kZXRlcm1pbmUgZnJhY3Rpb25TaXplIGlmIGl0IGlzIG5vdCBzcGVjaWZpZWQKICAgIGlmIChpc1VuZGVmaW5lZChmcmFjdGlvblNpemUpKSB7CiAgICAgIGZyYWN0aW9uU2l6ZSA9IE1hdGgubWluKE1hdGgubWF4KHBhdHRlcm5bMV0sIGZyYWN0aW9uTGVuKSwgcGF0dGVyblsyXSk7CiAgICB9CgogICAgdmFyIHBvdyA9IE1hdGgucG93KDEwLCBmcmFjdGlvblNpemUpOwogICAgbnVtYmVyID0gTWF0aC5yb3VuZChudW1iZXIgKiBwb3cpIC8gcG93OwogICAgdmFyIGZyYWN0aW9uID0gKCcnICsgbnVtYmVyKS5zcGxpdChERUNJTUFMX1NFUCk7CiAgICB2YXIgd2hvbGUgPSBmcmFjdGlvblswXTsKICAgIGZyYWN0aW9uID0gZnJhY3Rpb25bMV0gfHwgJyc7CgogICAgdmFyIHBvcyA9IDAsCiAgICAgICAgbGdyb3VwID0gcGF0dGVybls4XSwKICAgICAgICBncm91cCA9IHBhdHRlcm5bN107CgogICAgaWYgKHdob2xlLmxlbmd0aCA+PSAobGdyb3VwICsgZ3JvdXApKSB7CiAgICAgIHBvcyA9IHdob2xlLmxlbmd0aCAtIGxncm91cDsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwb3M7IGkrKykgewogICAgICAgIGlmICgocG9zIC0gaSklZ3JvdXAgPT09IDAgJiYgaSAhPT0gMCkgewogICAgICAgICAgZm9ybWF0ZWRUZXh0ICs9IE5VTUJFUl9GT1JNQVRTLkdST1VQX1NFUDsKICAgICAgICB9CiAgICAgICAgZm9ybWF0ZWRUZXh0ICs9IHdob2xlLmNoYXJBdChpKTsKICAgICAgfQogICAgfQoKICAgIGZvciAoaSA9IHBvczsgaSA8IHdob2xlLmxlbmd0aDsgaSsrKSB7CiAgICAgIGlmICgod2hvbGUubGVuZ3RoIC0gaSklbGdyb3VwID09PSAwICYmIGkgIT09IDApIHsKICAgICAgICBmb3JtYXRlZFRleHQgKz0gTlVNQkVSX0ZPUk1BVFMuR1JPVVBfU0VQOwogICAgICB9CiAgICAgIGZvcm1hdGVkVGV4dCArPSB3aG9sZS5jaGFyQXQoaSk7CiAgICB9CgogICAgLy8gZm9ybWF0IGZyYWN0aW9uIHBhcnQuCiAgICB3aGlsZShmcmFjdGlvbi5sZW5ndGggPCBmcmFjdGlvblNpemUpIHsKICAgICAgZnJhY3Rpb24gKz0gJzAnOwogICAgfQogICAgaWYgKGZyYWN0aW9uU2l6ZSkgZm9ybWF0ZWRUZXh0ICs9IE5VTUJFUl9GT1JNQVRTLkRFQ0lNQUxfU0VQICsgZnJhY3Rpb24uc3Vic3RyKDAsIGZyYWN0aW9uU2l6ZSk7CiAgfQoKICBwYXJ0cy5wdXNoKGlzTmVnYXRpdmUgPyBwYXR0ZXJuWzVdIDogcGF0dGVyblszXSk7CiAgcGFydHMucHVzaChmb3JtYXRlZFRleHQpOwogIHBhcnRzLnB1c2goaXNOZWdhdGl2ZSA/IHBhdHRlcm5bNl0gOiBwYXR0ZXJuWzRdKTsKICByZXR1cm4gcGFydHMuam9pbignJyk7Cn0KCmZ1bmN0aW9uIHBhZE51bWJlcihudW0sIGRpZ2l0cywgdHJpbSkgewogIHZhciBuZWcgPSAnJzsKICBpZiAobnVtIDwgMCkgewogICAgbmVnID0gICctJzsKICAgIG51bSA9IC1udW07CiAgfQogIG51bSA9ICcnICsgbnVtOwogIHdoaWxlKG51bS5sZW5ndGggPCBkaWdpdHMpIG51bSA9ICcwJyArIG51bTsKICBpZiAodHJpbSkKICAgIG51bSA9IG51bS5zdWJzdHIobnVtLmxlbmd0aCAtIGRpZ2l0cyk7CiAgcmV0dXJuIG5lZyArIG51bTsKfQoKCmZ1bmN0aW9uIGRhdGVHZXR0ZXIobmFtZSwgc2l6ZSwgb2Zmc2V0LCB0cmltKSB7CiAgcmV0dXJuIGZ1bmN0aW9uKGRhdGUpIHsKICAgIHZhciB2YWx1ZSA9IGRhdGVbJ2dldCcgKyBuYW1lXSgpOwogICAgaWYgKG9mZnNldCA+IDAgfHwgdmFsdWUgPiAtb2Zmc2V0KQogICAgICB2YWx1ZSArPSBvZmZzZXQ7CiAgICBpZiAodmFsdWUgPT09IDAgJiYgb2Zmc2V0ID09IC0xMiApIHZhbHVlID0gMTI7CiAgICByZXR1cm4gcGFkTnVtYmVyKHZhbHVlLCBzaXplLCB0cmltKTsKICB9Owp9CgpmdW5jdGlvbiBkYXRlU3RyR2V0dGVyKG5hbWUsIHNob3J0Rm9ybSkgewogIHJldHVybiBmdW5jdGlvbihkYXRlKSB7CiAgICB2YXIgdmFsdWUgPSBkYXRlWydnZXQnICsgbmFtZV0oKTsKCiAgICBpZihuYW1lID09ICdNb250aCcpIHsKICAgICAgdmFsdWUgPSBNT05USFt2YWx1ZV07CiAgICB9IGVsc2UgewogICAgICB2YWx1ZSA9IERBWVt2YWx1ZV07CiAgICB9CgogICAgcmV0dXJuIHNob3J0Rm9ybSA/IHZhbHVlLnN1YnN0cigwLDMpIDogdmFsdWU7CiAgfTsKfQoKZnVuY3Rpb24gdGltZVpvbmVHZXR0ZXIobnVtRm9ybWF0KSB7CiAgcmV0dXJuIGZ1bmN0aW9uKGRhdGUpIHsKICAgIHZhciB0aW1lWm9uZTsKICAgIGlmIChudW1Gb3JtYXQgfHwgISh0aW1lWm9uZSA9IEdFVF9USU1FX1pPTkUuZXhlYyhkYXRlLnRvU3RyaW5nKCkpKSkgewogICAgICB2YXIgb2Zmc2V0ID0gZGF0ZS5nZXRUaW1lem9uZU9mZnNldCgpOwogICAgICByZXR1cm4gcGFkTnVtYmVyKG9mZnNldCAvIDYwLCAyKSArIHBhZE51bWJlcihNYXRoLmFicyhvZmZzZXQgJSA2MCksIDIpOwogICAgfQogICAgcmV0dXJuIHRpbWVab25lWzBdOwogIH07Cn0KCnZhciBEQVkgPSAnU3VuZGF5LE1vbmRheSxUdWVzZGF5LFdlZG5lc2RheSxUaHVyc2RheSxGcmlkYXksU2F0dXJkYXknLnNwbGl0KCcsJyk7Cgp2YXIgTU9OVEggPSAnSmFudWFyeSxGZWJydWFyeSxNYXJjaCxBcHJpbCxNYXksSnVuZSxKdWx5LEF1Z3VzdCxTZXB0ZW1iZXIsT2N0b2JlcixOb3ZlbWJlcixEZWNlbWJlcicuCiAgICAgICAgICAgICBzcGxpdCgnLCcpOwoKdmFyIERBVEVfRk9STUFUUyA9IHsKICB5eXl5OiBkYXRlR2V0dGVyKCdGdWxsWWVhcicsIDQpLAogICAgeXk6IGRhdGVHZXR0ZXIoJ0Z1bGxZZWFyJywgMiwgMCwgdHJ1ZSksCiAgICAgeTogZGF0ZUdldHRlcignRnVsbFllYXInLCAxKSwKICBNTU1NOiBkYXRlU3RyR2V0dGVyKCdNb250aCcpLAogICBNTU06IGRhdGVTdHJHZXR0ZXIoJ01vbnRoJywgdHJ1ZSksCiAgICBNTTogZGF0ZUdldHRlcignTW9udGgnLCAyLCAxKSwKICAgICBNOiBkYXRlR2V0dGVyKCdNb250aCcsIDEsIDEpLAogICAgZGQ6IGRhdGVHZXR0ZXIoJ0RhdGUnLCAyKSwKICAgICBkOiBkYXRlR2V0dGVyKCdEYXRlJywgMSksCiAgICBISDogZGF0ZUdldHRlcignSG91cnMnLCAyKSwKICAgICBIOiBkYXRlR2V0dGVyKCdIb3VycycsIDEpLAogICAgaGg6IGRhdGVHZXR0ZXIoJ0hvdXJzJywgMiwgLTEyKSwKICAgICBoOiBkYXRlR2V0dGVyKCdIb3VycycsIDEsIC0xMiksCiAgICBtbTogZGF0ZUdldHRlcignTWludXRlcycsIDIpLAogICAgIG06IGRhdGVHZXR0ZXIoJ01pbnV0ZXMnLCAxKSwKICAgIHNzOiBkYXRlR2V0dGVyKCdTZWNvbmRzJywgMiksCiAgICAgczogZGF0ZUdldHRlcignU2Vjb25kcycsIDEpLAogIEVFRUU6IGRhdGVTdHJHZXR0ZXIoJ0RheScpLAogICBFRUU6IGRhdGVTdHJHZXR0ZXIoJ0RheScsIHRydWUpLAogICAgIGE6IGZ1bmN0aW9uKGRhdGUpe3JldHVybiBkYXRlLmdldEhvdXJzKCkgPCAxMiA/ICdhbScgOiAncG0nO30sCiAgICAgejogdGltZVpvbmVHZXR0ZXIoZmFsc2UpLAogICAgIFo6IHRpbWVab25lR2V0dGVyKHRydWUpCn07Cgp2YXIgREVGQVVMVF9EQVRFVElNRV9GT1JNQVRTID0gewogICAgICAgICBsb25nOiAnTU1NTSBkLCB5IGg6bW06c3MgYSB6JywKICAgICAgIG1lZGl1bTogJ01NTSBkLCB5IGg6bW06c3MgYScsCiAgICAgICAgc2hvcnQ6ICdNL2QveXkgaDptbSBhJywKICAgIGZ1bGxEYXRlOiAnRUVFRSwgTU1NTSBkLCB5JywKICAgIGxvbmdEYXRlOiAnTU1NTSBkLCB5JywKICBtZWRpdW1EYXRlOiAnTU1NIGQsIHknLAogICBzaG9ydERhdGU6ICdNL2QveXknLAogICAgbG9uZ1RpbWU6ICdoOm1tOnNzIGEgeicsCiAgbWVkaXVtVGltZTogJ2g6bW06c3MgYScsCiAgIHNob3J0VGltZTogJ2g6bW0gYScKfTsKCnZhciBHRVRfVElNRV9aT05FID0gL1tBLVpdezN9KD8hWytcLV0pLzsKdmFyIERBVEVfRk9STUFUU19TUExJVCA9IC8oW155TWRIaG1zYXpaRV0qKShFK3x5K3xNK3xkK3xIK3xoK3xtK3xzK3xhfFp8eikoLiopLzsKdmFyIE9QRVJBX1RPU1RSSU5HX1BBVFRFUk4gPSAvXltcZF0uKlokLzsKdmFyIE5VTUJFUl9TVFJJTkcgPSAvXlxkKyQvOwoKCi8qKgogKiBAd29ya0luUHJvZ3Jlc3MKICogQG5nZG9jIGZpbHRlcgogKiBAbmFtZSBhbmd1bGFyLmZpbHRlci5kYXRlCiAqIEBmdW5jdGlvbgogKgogKiBAZGVzY3JpcHRpb24KICogICBGb3JtYXRzIGBkYXRlYCB0byBhIHN0cmluZyBiYXNlZCBvbiB0aGUgcmVxdWVzdGVkIGBmb3JtYXRgLgogKgogKiAgIGBmb3JtYXRgIHN0cmluZyBjYW4gYmUgY29tcG9zZWQgb2YgdGhlIGZvbGxvd2luZyBlbGVtZW50czoKICoKICogICAqIGAneXl5eSdgOiA0IGRpZ2l0IHJlcHJlc2VudGF0aW9uIG9mIHllYXIgKGUuZy4gQUQgMSA9PiAwMDAxLCBBRCAyMDEwID0+IDIwMTApCiAqICAgKiBgJ3l5J2A6IDIgZGlnaXQgcmVwcmVzZW50YXRpb24gb2YgeWVhciwgcGFkZGVkICgwMC05OSkuIChlLmcuIEFEIDIwMDEgPT4gMDEsIEFEIDIwMTAgPT4gMTApCiAqICAgKiBgJ3knYDogMSBkaWdpdCByZXByZXNlbnRhdGlvbiBvZiB5ZWFyLCBlLmcuIChBRCAxID0+IDEsIEFEIDE5OSA9PiAxOTkpCiAqICAgKiBgJ01NTU0nYDogTW9udGggaW4geWVhciAoSmFudWFyeS1EZWNlbWJlcikKICogICAqIGAnTU1NJ2A6IE1vbnRoIGluIHllYXIgKEphbi1EZWMpCiAqICAgKiBgJ01NJ2A6IE1vbnRoIGluIHllYXIsIHBhZGRlZCAoMDEtMTIpCiAqICAgKiBgJ00nYDogTW9udGggaW4geWVhciAoMS0xMikKICogICAqIGAnZGQnYDogRGF5IGluIG1vbnRoLCBwYWRkZWQgKDAxLTMxKQogKiAgICogYCdkJ2A6IERheSBpbiBtb250aCAoMS0zMSkKICogICAqIGAnRUVFRSdgOiBEYXkgaW4gV2VlaywoU3VuZGF5LVNhdHVyZGF5KQogKiAgICogYCdFRUUnYDogRGF5IGluIFdlZWssIChTdW4tU2F0KQogKiAgICogYCdISCdgOiBIb3VyIGluIGRheSwgcGFkZGVkICgwMC0yMykKICogICAqIGAnSCdgOiBIb3VyIGluIGRheSAoMC0yMykKICogICAqIGAnaGgnYDogSG91ciBpbiBhbS9wbSwgcGFkZGVkICgwMS0xMikKICogICAqIGAnaCdgOiBIb3VyIGluIGFtL3BtLCAoMS0xMikKICogICAqIGAnbW0nYDogTWludXRlIGluIGhvdXIsIHBhZGRlZCAoMDAtNTkpCiAqICAgKiBgJ20nYDogTWludXRlIGluIGhvdXIgKDAtNTkpCiAqICAgKiBgJ3NzJ2A6IFNlY29uZCBpbiBtaW51dGUsIHBhZGRlZCAoMDAtNTkpCiAqICAgKiBgJ3MnYDogU2Vjb25kIGluIG1pbnV0ZSAoMC01OSkKICogICAqIGAnYSdgOiBhbS9wbSBtYXJrZXIKICogICAqIGAnWidgOiA0IGRpZ2l0ICgrc2lnbikgcmVwcmVzZW50YXRpb24gb2YgdGhlIHRpbWV6b25lIG9mZnNldCAoLTEyMDAtMTIwMCkKICogICAqIGAneidgOiBzaG9ydCBmb3JtIG9mIGN1cnJlbnQgdGltZXpvbmUgbmFtZSAoZS5nLiBQRFQpCiAqCiAqICAgYGZvcm1hdGAgc3RyaW5nIGNhbiBhbHNvIGJlIHRoZSBmb2xsb3dpbmcgZGVmYXVsdCBmb3JtYXRzIGZvciBgZW5fVVNgIGxvY2FsZSAoc3VwcG9ydCBmb3Igb3RoZXIKICogICAgbG9jYWxlcyB3aWxsIGJlIGFkZGVkIGluIHRoZSBmdXR1cmUgdmVyc2lvbnMpOgogKgogKiAgICogYCdsb25nJ2A6IGVxdWl2YWxlbnQgdG8gYCdNTU1NIGQsIHkgaDptbTpzcyBhIHonYCBmb3IgZW5fVVMgIGxvY2FsZQogKiAgICAgKGUuZy4gU2VwdGVtYmVyIDMsIDIwMTAgMTI6MDU6MDggcG0gUERUKQogKiAgICogYCdtZWRpdW0nYDogZXF1aXZhbGVudCB0byBgJ01NTSBkLCB5IGg6bW06c3MgYSdgIGZvciBlbl9VUyBsb2NhbGUKICogICAgIChlLmcuIFNlcCAzLCAyMDEwIDEyOjA1OjA4IHBtKQogKiAgICogYCdzaG9ydCdgOiBlcXVpdmFsZW50IHRvIGAnTS9kL3l5IGg6bW0gYSdgIGZvciBlbl9VUyAgbG9jYWxlIChlLmcuIDkvMy8xMCAxMjowNSBwbSkKICogICAqIGAnZnVsbERhdGUnYDogZXF1aXZhbGVudCB0byBgJ0VFRUUsIE1NTU0gZCx5J2AgZm9yIGVuX1VTICBsb2NhbGUKICogICAgIChlLmcuIEZyaWRheSwgU2VwdGVtYmVyIDMsIDIwMTApCiAqICAgKiBgJ2xvbmdEYXRlJ2A6IGVxdWl2YWxlbnQgdG8gYCdNTU1NIGQsIHknYCBmb3IgZW5fVVMgIGxvY2FsZSAoZS5nLiBTZXB0ZW1iZXIgMywgMjAxMAogKiAgICogYCdtZWRpdW1EYXRlJ2A6IGVxdWl2YWxlbnQgdG8gYCdNTU0gZCwgeSdgIGZvciBlbl9VUyAgbG9jYWxlIChlLmcuIFNlcCAzLCAyMDEwKQogKiAgICogYCdzaG9ydERhdGUnYDogZXF1aXZhbGVudCB0byBgJ00vZC95eSdgIGZvciBlbl9VUyBsb2NhbGUgKGUuZy4gOS8zLzEwKQogKiAgICogYCdsb25nVGltZSdgOiBlcXVpdmFsZW50IHRvIGAnaDptbTpzcyBhIHonYCBmb3IgZW5fVVMgbG9jYWxlIChlLmcuIDEyOjA1OjA4IHBtIFBEVCkKICogICAqIGAnbWVkaXVtVGltZSdgOiBlcXVpdmFsZW50IHRvIGAnaDptbTpzcyBhJ2AgZm9yIGVuX1VTIGxvY2FsZSAoZS5nLiAxMjowNTowOCBwbSkKICogICAqIGAnc2hvcnRUaW1lJ2A6IGVxdWl2YWxlbnQgdG8gYCdoOm1tIGEnYCBmb3IgZW5fVVMgbG9jYWxlIChlLmcuIDEyOjA1IHBtKQogKgogKiBAcGFyYW0geyhEYXRlfG51bWJlcnxzdHJpbmcpfSBkYXRlIERhdGUgdG8gZm9ybWF0IGVpdGhlciBhcyBEYXRlIG9iamVjdCwgbWlsbGlzZWNvbmRzIChzdHJpbmcgb3IKICogICAgbnVtYmVyKSBvciBJU08gODYwMSBleHRlbmRlZCBkYXRldGltZSBzdHJpbmcgKHl5eXktTU0tZGRUSEg6bW06c3MuU1NTWikuCiAqIEBwYXJhbSB7c3RyaW5nPX0gZm9ybWF0IEZvcm1hdHRpbmcgcnVsZXMgKHNlZSBEZXNjcmlwdGlvbikuIElmIG5vdCBzcGVjaWZpZWQsCiAqICAgIERhdGUjdG9Mb2NhbGVEYXRlU3RyaW5nIGlzIHVzZWQuCiAqIEByZXR1cm5zIHtzdHJpbmd9IEZvcm1hdHRlZCBzdHJpbmcgb3IgdGhlIGlucHV0IGlmIGlucHV0IGlzIG5vdCByZWNvZ25pemVkIGFzIGRhdGUvbWlsbGlzLgogKgogKiBAZXhhbXBsZQogICA8ZG9jOmV4YW1wbGU+CiAgICAgPGRvYzpzb3VyY2U+CiAgICAgICA8c3BhbiBuZzpub24tYmluZGFibGU+e3sxMjg4MzIzNjIzMDA2IHwgZGF0ZTonbWVkaXVtJ319PC9zcGFuPjoKICAgICAgICAgICB7ezEyODgzMjM2MjMwMDYgfCBkYXRlOidtZWRpdW0nfX08YnIvPgogICAgICAgPHNwYW4gbmc6bm9uLWJpbmRhYmxlPnt7MTI4ODMyMzYyMzAwNiB8IGRhdGU6J3l5eXktTU0tZGQgSEg6bW06c3MgWid9fTwvc3Bhbj46CiAgICAgICAgICB7ezEyODgzMjM2MjMwMDYgfCBkYXRlOid5eXl5LU1NLWRkIEhIOm1tOnNzIFonfX08YnIvPgogICAgICAgPHNwYW4gbmc6bm9uLWJpbmRhYmxlPnt7MTI4ODMyMzYyMzAwNiB8IGRhdGU6J01NL2RkL3l5eXkgQCBoOm1tYSd9fTwvc3Bhbj46CiAgICAgICAgICB7eycxMjg4MzIzNjIzMDA2JyB8IGRhdGU6J01NL2RkL3l5eXkgQCBoOm1tYSd9fTxici8+CiAgICAgPC9kb2M6c291cmNlPgogICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgICBpdCgnc2hvdWxkIGZvcm1hdCBkYXRlJywgZnVuY3Rpb24oKXsKICAgICAgICAgZXhwZWN0KGJpbmRpbmcoIjEyODgzMjM2MjMwMDYgfCBkYXRlOidtZWRpdW0nIikpLgogICAgICAgICAgICB0b01hdGNoKC9PY3QgMlxkLCAyMDEwIFxkezEsMn06XGR7Mn06XGR7Mn0gKGFtfHBtKS8pOwogICAgICAgICBleHBlY3QoYmluZGluZygiMTI4ODMyMzYyMzAwNiB8IGRhdGU6J3l5eXktTU0tZGQgSEg6bW06c3MgWiciKSkuCiAgICAgICAgICAgIHRvTWF0Y2goLzIwMTBcLTEwXC0yXGQgXGR7Mn06XGR7Mn06XGR7Mn0gXC0/XGR7NH0vKTsKICAgICAgICAgZXhwZWN0KGJpbmRpbmcoIicxMjg4MzIzNjIzMDA2JyB8IGRhdGU6J01NL2RkL3l5eXkgQCBoOm1tYSciKSkuCiAgICAgICAgICAgIHRvTWF0Y2goLzEwXC8yXGRcLzIwMTAgQCBcZHsxLDJ9OlxkezJ9KGFtfHBtKS8pOwogICAgICAgfSk7CiAgICAgPC9kb2M6c2NlbmFyaW8+CiAgIDwvZG9jOmV4YW1wbGU+CiAqLwphbmd1bGFyRmlsdGVyLmRhdGUgPSBmdW5jdGlvbihkYXRlLCBmb3JtYXQpIHsKICBmb3JtYXQgPSBERUZBVUxUX0RBVEVUSU1FX0ZPUk1BVFNbZm9ybWF0XSB8fCBmb3JtYXQ7CiAgaWYgKGlzU3RyaW5nKGRhdGUpKSB7CiAgICBpZiAoTlVNQkVSX1NUUklORy50ZXN0KGRhdGUpKSB7CiAgICAgIGRhdGUgPSBwYXJzZUludChkYXRlLCAxMCk7CiAgICB9IGVsc2UgewogICAgICBkYXRlID0gYW5ndWxhclN0cmluZy50b0RhdGUoZGF0ZSk7CiAgICB9CiAgfQoKICBpZiAoaXNOdW1iZXIoZGF0ZSkpIHsKICAgIGRhdGUgPSBuZXcgRGF0ZShkYXRlKTsKICB9CgogIGlmICghaXNEYXRlKGRhdGUpKSB7CiAgICByZXR1cm4gZGF0ZTsKICB9CgogIHZhciB0ZXh0ID0gZGF0ZS50b0xvY2FsZURhdGVTdHJpbmcoKSwgZm47CiAgaWYgKGZvcm1hdCAmJiBpc1N0cmluZyhmb3JtYXQpKSB7CiAgICB0ZXh0ID0gJyc7CiAgICB2YXIgcGFydHMgPSBbXSwgbWF0Y2g7CiAgICB3aGlsZShmb3JtYXQpIHsKICAgICAgbWF0Y2ggPSBEQVRFX0ZPUk1BVFNfU1BMSVQuZXhlYyhmb3JtYXQpOwogICAgICBpZiAobWF0Y2gpIHsKICAgICAgICBwYXJ0cyA9IGNvbmNhdChwYXJ0cywgbWF0Y2gsIDEpOwogICAgICAgIGZvcm1hdCA9IHBhcnRzLnBvcCgpOwogICAgICB9IGVsc2UgewogICAgICAgIHBhcnRzLnB1c2goZm9ybWF0KTsKICAgICAgICBmb3JtYXQgPSBudWxsOwogICAgICB9CiAgICB9CiAgICBmb3JFYWNoKHBhcnRzLCBmdW5jdGlvbih2YWx1ZSl7CiAgICAgIGZuID0gREFURV9GT1JNQVRTW3ZhbHVlXTsKICAgICAgdGV4dCArPSBmbiA/IGZuKGRhdGUpIDogdmFsdWU7CiAgICB9KTsKICB9CiAgcmV0dXJuIHRleHQ7Cn07CgoKLyoqCiAqIEB3b3JrSW5Qcm9ncmVzcwogKiBAbmdkb2MgZmlsdGVyCiAqIEBuYW1lIGFuZ3VsYXIuZmlsdGVyLmpzb24KICogQGZ1bmN0aW9uCiAqCiAqIEBkZXNjcmlwdGlvbgogKiAgIEFsbG93cyB5b3UgdG8gY29udmVydCBhIEphdmFTY3JpcHQgb2JqZWN0IGludG8gSlNPTiBzdHJpbmcuCiAqCiAqICAgVGhpcyBmaWx0ZXIgaXMgbW9zdGx5IHVzZWZ1bCBmb3IgZGVidWdnaW5nLiBXaGVuIHVzaW5nIHRoZSBkb3VibGUgY3VybHkge3t2YWx1ZX19IG5vdGF0aW9uCiAqICAgdGhlIGJpbmRpbmcgaXMgYXV0b21hdGljYWxseSBjb252ZXJ0ZWQgdG8gSlNPTi4KICoKICogQHBhcmFtIHsqfSBvYmplY3QgQW55IEphdmFTY3JpcHQgb2JqZWN0IChpbmNsdWRpbmcgYXJyYXlzIGFuZCBwcmltaXRpdmUgdHlwZXMpIHRvIGZpbHRlci4KICogQHJldHVybnMge3N0cmluZ30gSlNPTiBzdHJpbmcuCiAqCiAqIEBjc3MgbmctbW9ub3NwYWNlIEFsd2F5cyBhcHBsaWVkIHRvIHRoZSBlbmNhcHN1bGF0aW5nIGVsZW1lbnQuCiAqCiAqIEBleGFtcGxlOgogICA8ZG9jOmV4YW1wbGU+CiAgICAgPGRvYzpzb3VyY2U+CiAgICAgICA8aW5wdXQgdHlwZT0idGV4dCIgbmFtZT0ib2JqVHh0IiB2YWx1ZT0ie2E6MSwgYjpbXX0iCiAgICAgICAgICAgICAgbmc6ZXZhbD0ib2JqID0gJGV2YWwob2JqVHh0KSIvPgogICAgICAgPHByZT57eyBvYmogfCBqc29uIH19PC9wcmU+CiAgICAgPC9kb2M6c291cmNlPgogICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgICBpdCgnc2hvdWxkIGpzb25pZnkgZmlsdGVyZWQgb2JqZWN0cycsIGZ1bmN0aW9uKCkgewogICAgICAgICBleHBlY3QoYmluZGluZygnb2JqIHwganNvbicpKS50b0JlKCd7XG4gICJhIjoxLFxuICAiYiI6W119Jyk7CiAgICAgICB9KTsKCiAgICAgICBpdCgnc2hvdWxkIHVwZGF0ZScsIGZ1bmN0aW9uKCkgewogICAgICAgICBpbnB1dCgnb2JqVHh0JykuZW50ZXIoJ1sxLCAyLCAzXScpOwogICAgICAgICBleHBlY3QoYmluZGluZygnb2JqIHwganNvbicpKS50b0JlKCdbMSwyLDNdJyk7CiAgICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgPC9kb2M6ZXhhbXBsZT4KICoKICovCmFuZ3VsYXJGaWx0ZXIuanNvbiA9IGZ1bmN0aW9uKG9iamVjdCkgewogIHRoaXMuJGVsZW1lbnQuYWRkQ2xhc3MoIm5nLW1vbm9zcGFjZSIpOwogIHJldHVybiB0b0pzb24ob2JqZWN0LCB0cnVlKTsKfTsKCgovKioKICogQHdvcmtJblByb2dyZXNzCiAqIEBuZ2RvYyBmaWx0ZXIKICogQG5hbWUgYW5ndWxhci5maWx0ZXIubG93ZXJjYXNlCiAqIEBmdW5jdGlvbgogKgogKiBAc2VlIGFuZ3VsYXIubG93ZXJjYXNlCiAqLwphbmd1bGFyRmlsdGVyLmxvd2VyY2FzZSA9IGxvd2VyY2FzZTsKCgovKioKICogQHdvcmtJblByb2dyZXNzCiAqIEBuZ2RvYyBmaWx0ZXIKICogQG5hbWUgYW5ndWxhci5maWx0ZXIudXBwZXJjYXNlCiAqIEBmdW5jdGlvbgogKgogKiBAc2VlIGFuZ3VsYXIudXBwZXJjYXNlCiAqLwphbmd1bGFyRmlsdGVyLnVwcGVyY2FzZSA9IHVwcGVyY2FzZTsKCgovKioKICogQHdvcmtJblByb2dyZXNzCiAqIEBuZ2RvYyBmaWx0ZXIKICogQG5hbWUgYW5ndWxhci5maWx0ZXIuaHRtbAogKiBAZnVuY3Rpb24KICoKICogQGRlc2NyaXB0aW9uCiAqICAgUHJldmVudHMgdGhlIGlucHV0IGZyb20gZ2V0dGluZyBlc2NhcGVkIGJ5IGFuZ3VsYXIuIEJ5IGRlZmF1bHQgdGhlIGlucHV0IGlzIHNhbml0aXplZCBhbmQKICogICBpbnNlcnRlZCBpbnRvIHRoZSBET00gYXMgaXMuCiAqCiAqICAgVGhlIGlucHV0IGlzIHNhbml0aXplZCBieSBwYXJzaW5nIHRoZSBodG1sIGludG8gdG9rZW5zLiBBbGwgc2FmZSB0b2tlbnMgKGZyb20gYSB3aGl0ZWxpc3QpIGFyZQogKiAgIHRoZW4gc2VyaWFsaXplZCBiYWNrIHRvIHByb3Blcmx5IGVzY2FwZWQgaHRtbCBzdHJpbmcuIFRoaXMgbWVhbnMgdGhhdCBubyB1bnNhZmUgaW5wdXQgY2FuIG1ha2UKICogICBpdCBpbnRvIHRoZSByZXR1cm5lZCBzdHJpbmcsIGhvd2V2ZXIsIHNpbmNlIG91ciBwYXJzZXIgaXMgbW9yZSBzdHJpY3QgdGhhbiBhIHR5cGljYWwgYnJvd3NlcgogKiAgIHBhcnNlciwgaXQncyBwb3NzaWJsZSB0aGF0IHNvbWUgb2JzY3VyZSBpbnB1dCwgd2hpY2ggd291bGQgYmUgcmVjb2duaXplZCBhcyB2YWxpZCBIVE1MIGJ5IGEKICogICBicm93c2VyLCB3b24ndCBtYWtlIGl0IHRocm91Z2ggdGhlIHNhbml0aXplci4KICoKICogICBJZiB5b3UgaGF0ZSB5b3VyIHVzZXJzLCB5b3UgbWF5IGNhbGwgdGhlIGZpbHRlciB3aXRoIG9wdGlvbmFsICd1bnNhZmUnIGFyZ3VtZW50LCB3aGljaCBieXBhc3NlcwogKiAgIHRoZSBodG1sIHNhbml0aXplciwgYnV0IG1ha2VzIHlvdXIgYXBwbGljYXRpb24gdnVsbmVyYWJsZSB0byBYU1MgYW5kIG90aGVyIGF0dGFja3MuIFVzaW5nIHRoaXMKICogICBvcHRpb24gaXMgc3Ryb25nbHkgZGlzY291cmFnZWQgYW5kIHNob3VsZCBiZSB1c2VkIG9ubHkgaWYgeW91IGFic29sdXRlbHkgdHJ1c3QgdGhlIGlucHV0IGJlaW5nCiAqICAgZmlsdGVyZWQgYW5kIHlvdSBjYW4ndCBnZXQgdGhlIGNvbnRlbnQgdGhyb3VnaCB0aGUgc2FuaXRpemVyLgogKgogKiBAcGFyYW0ge3N0cmluZ30gaHRtbCBIdG1sIGlucHV0LgogKiBAcGFyYW0ge3N0cmluZz19IG9wdGlvbiBJZiAndW5zYWZlJyB0aGVuIGRvIG5vdCBzYW5pdGl6ZSB0aGUgSFRNTCBpbnB1dC4KICogQHJldHVybnMge3N0cmluZ30gU2FuaXRpemVkIG9yIHJhdyBodG1sLgogKgogKiBAZXhhbXBsZQogICA8ZG9jOmV4YW1wbGU+CiAgICAgPGRvYzpzb3VyY2U+CiAgICAgIFNuaXBwZXQ6IDx0ZXh0YXJlYSBuYW1lPSJzbmlwcGV0IiBjb2xzPSI2MCIgcm93cz0iMyI+CiAgICAgJmx0O3Agc3R5bGU9ImNvbG9yOmJsdWUiJmd0O2FuIGh0bWwKICAgICAmbHQ7ZW0gb25tb3VzZW92ZXI9InRoaXMudGV4dENvbnRlbnQ9J1BXTjNEISciJmd0O2NsaWNrIGhlcmUmbHQ7L2VtJmd0OwogICAgIHNuaXBwZXQmbHQ7L3AmZ3Q7PC90ZXh0YXJlYT4KICAgICAgIDx0YWJsZT4KICAgICAgICAgPHRyPgogICAgICAgICAgIDx0ZD5GaWx0ZXI8L3RkPgogICAgICAgICAgIDx0ZD5Tb3VyY2U8L3RkPgogICAgICAgICAgIDx0ZD5SZW5kZXJlZDwvdGQ+CiAgICAgICAgIDwvdHI+CiAgICAgICAgIDx0ciBpZD0iaHRtbC1maWx0ZXIiPgogICAgICAgICAgIDx0ZD5odG1sIGZpbHRlcjwvdGQ+CiAgICAgICAgICAgPHRkPgogICAgICAgICAgICAgPHByZT4mbHQ7ZGl2IG5nOmJpbmQ9InNuaXBwZXQgfCBodG1sIiZndDs8YnIvPiZsdDsvZGl2Jmd0OzwvcHJlPgogICAgICAgICAgIDwvdGQ+CiAgICAgICAgICAgPHRkPgogICAgICAgICAgICAgPGRpdiBuZzpiaW5kPSJzbmlwcGV0IHwgaHRtbCI+PC9kaXY+CiAgICAgICAgICAgPC90ZD4KICAgICAgICAgPC90cj4KICAgICAgICAgPHRyIGlkPSJlc2NhcGVkLWh0bWwiPgogICAgICAgICAgIDx0ZD5ubyBmaWx0ZXI8L3RkPgogICAgICAgICAgIDx0ZD48cHJlPiZsdDtkaXYgbmc6YmluZD0ic25pcHBldCImZ3Q7PGJyLz4mbHQ7L2RpdiZndDs8L3ByZT48L3RkPgogICAgICAgICAgIDx0ZD48ZGl2IG5nOmJpbmQ9InNuaXBwZXQiPjwvZGl2PjwvdGQ+CiAgICAgICAgIDwvdHI+CiAgICAgICAgIDx0ciBpZD0iaHRtbC11bnNhZmUtZmlsdGVyIj4KICAgICAgICAgICA8dGQ+dW5zYWZlIGh0bWwgZmlsdGVyPC90ZD4KICAgICAgICAgICA8dGQ+PHByZT4mbHQ7ZGl2IG5nOmJpbmQ9InNuaXBwZXQgfCBodG1sOid1bnNhZmUnIiZndDs8YnIvPiZsdDsvZGl2Jmd0OzwvcHJlPjwvdGQ+CiAgICAgICAgICAgPHRkPjxkaXYgbmc6YmluZD0ic25pcHBldCB8IGh0bWw6J3Vuc2FmZSciPjwvZGl2PjwvdGQ+CiAgICAgICAgIDwvdHI+CiAgICAgICA8L3RhYmxlPgogICAgIDwvZG9jOnNvdXJjZT4KICAgICA8ZG9jOnNjZW5hcmlvPgogICAgICAgaXQoJ3Nob3VsZCBzYW5pdGl6ZSB0aGUgaHRtbCBzbmlwcGV0ICcsIGZ1bmN0aW9uKCl7CiAgICAgICAgIGV4cGVjdCh1c2luZygnI2h0bWwtZmlsdGVyJykuYmluZGluZygnc25pcHBldCB8IGh0bWwnKSkuCiAgICAgICAgICAgdG9CZSgnPHA+YW4gaHRtbFxuPGVtPmNsaWNrIGhlcmU8L2VtPlxuc25pcHBldDwvcD4nKTsKICAgICAgIH0pOwoKICAgICAgIGl0KCdzaG91bGQgZXNjYXBlIHNuaXBwZXQgd2l0aG91dCBhbnkgZmlsdGVyJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGV4cGVjdCh1c2luZygnI2VzY2FwZWQtaHRtbCcpLmJpbmRpbmcoJ3NuaXBwZXQnKSkuCiAgICAgICAgICAgdG9CZSgiJmx0O3Agc3R5bGU9XCJjb2xvcjpibHVlXCImZ3Q7YW4gaHRtbFxuIiArCiAgICAgICAgICAgICAgICAiJmx0O2VtIG9ubW91c2VvdmVyPVwidGhpcy50ZXh0Q29udGVudD0nUFdOM0QhJ1wiJmd0O2NsaWNrIGhlcmUmbHQ7L2VtJmd0O1xuIiArCiAgICAgICAgICAgICAgICAic25pcHBldCZsdDsvcCZndDsiKTsKICAgICAgIH0pOwoKICAgICAgIGl0KCdzaG91bGQgaW5saW5lIHJhdyBzbmlwcGV0IGlmIGZpbHRlcmVkIGFzIHVuc2FmZScsIGZ1bmN0aW9uKCkgewogICAgICAgICBleHBlY3QodXNpbmcoJyNodG1sLXVuc2FmZS1maWx0ZXInKS5iaW5kaW5nKCJzbmlwcGV0IHwgaHRtbDondW5zYWZlJyIpKS4KICAgICAgICAgICB0b0JlKCI8cCBzdHlsZT1cImNvbG9yOmJsdWVcIj5hbiBodG1sXG4iICsKICAgICAgICAgICAgICAgICI8ZW0gb25tb3VzZW92ZXI9XCJ0aGlzLnRleHRDb250ZW50PSdQV04zRCEnXCI+Y2xpY2sgaGVyZTwvZW0+XG4iICsKICAgICAgICAgICAgICAgICJzbmlwcGV0PC9wPiIpOwogICAgICAgfSk7CgogICAgICAgaXQoJ3Nob3VsZCB1cGRhdGUnLCBmdW5jdGlvbigpewogICAgICAgICBpbnB1dCgnc25pcHBldCcpLmVudGVyKCduZXcgPGI+dGV4dDwvYj4nKTsKICAgICAgICAgZXhwZWN0KHVzaW5nKCcjaHRtbC1maWx0ZXInKS5iaW5kaW5nKCdzbmlwcGV0IHwgaHRtbCcpKS50b0JlKCduZXcgPGI+dGV4dDwvYj4nKTsKICAgICAgICAgZXhwZWN0KHVzaW5nKCcjZXNjYXBlZC1odG1sJykuYmluZGluZygnc25pcHBldCcpKS50b0JlKCJuZXcgJmx0O2ImZ3Q7dGV4dCZsdDsvYiZndDsiKTsKICAgICAgICAgZXhwZWN0KHVzaW5nKCcjaHRtbC11bnNhZmUtZmlsdGVyJykuYmluZGluZygic25pcHBldCB8IGh0bWw6J3Vuc2FmZSciKSkudG9CZSgnbmV3IDxiPnRleHQ8L2I+Jyk7CiAgICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgPC9kb2M6ZXhhbXBsZT4KICovCmFuZ3VsYXJGaWx0ZXIuaHRtbCA9ICBmdW5jdGlvbihodG1sLCBvcHRpb24pewogIHJldHVybiBuZXcgSFRNTChodG1sLCBvcHRpb24pOwp9OwoKCi8qKgogKiBAd29ya0luUHJvZ3Jlc3MKICogQG5nZG9jIGZpbHRlcgogKiBAbmFtZSBhbmd1bGFyLmZpbHRlci5saW5reQogKiBAZnVuY3Rpb24KICoKICogQGRlc2NyaXB0aW9uCiAqICAgRmluZHMgbGlua3MgaW4gdGV4dCBpbnB1dCBhbmQgdHVybnMgdGhlbSBpbnRvIGh0bWwgbGlua3MuIFN1cHBvcnRzIGh0dHAvaHR0cHMvZnRwL21haWx0byBhbmQKICogICBwbGFpbiBlbWFpbCBhZGRyZXNzIGxpbmtzLgogKgogKiBAcGFyYW0ge3N0cmluZ30gdGV4dCBJbnB1dCB0ZXh0LgogKiBAcmV0dXJucyB7c3RyaW5nfSBIdG1sLWxpbmtpZmllZCB0ZXh0LgogKgogKiBAZXhhbXBsZQogICA8ZG9jOmV4YW1wbGU+CiAgICAgPGRvYzpzb3VyY2U+CiAgICAgICBTbmlwcGV0OiA8dGV4dGFyZWEgbmFtZT0ic25pcHBldCIgY29scz0iNjAiIHJvd3M9IjMiPgogIFByZXR0eSB0ZXh0IHdpdGggc29tZSBsaW5rczoKICBodHRwOi8vYW5ndWxhcmpzLm9yZy8sCiAgbWFpbHRvOnVzQHNvbWV3aGVyZS5vcmcsCiAgYW5vdGhlckBzb21ld2hlcmUub3JnLAogIGFuZCBvbmUgbW9yZTogZnRwOi8vMTI3LjAuMC4xLy48L3RleHRhcmVhPgogICAgICAgPHRhYmxlPgogICAgICAgICA8dHI+CiAgICAgICAgICAgPHRkPkZpbHRlcjwvdGQ+CiAgICAgICAgICAgPHRkPlNvdXJjZTwvdGQ+CiAgICAgICAgICAgPHRkPlJlbmRlcmVkPC90ZD4KICAgICAgICAgPC90cj4KICAgICAgICAgPHRyIGlkPSJsaW5reS1maWx0ZXIiPgogICAgICAgICAgIDx0ZD5saW5reSBmaWx0ZXI8L3RkPgogICAgICAgICAgIDx0ZD4KICAgICAgICAgICAgIDxwcmU+Jmx0O2RpdiBuZzpiaW5kPSJzbmlwcGV0IHwgbGlua3kiJmd0Ozxici8+Jmx0Oy9kaXYmZ3Q7PC9wcmU+CiAgICAgICAgICAgPC90ZD4KICAgICAgICAgICA8dGQ+CiAgICAgICAgICAgICA8ZGl2IG5nOmJpbmQ9InNuaXBwZXQgfCBsaW5reSI+PC9kaXY+CiAgICAgICAgICAgPC90ZD4KICAgICAgICAgPC90cj4KICAgICAgICAgPHRyIGlkPSJlc2NhcGVkLWh0bWwiPgogICAgICAgICAgIDx0ZD5ubyBmaWx0ZXI8L3RkPgogICAgICAgICAgIDx0ZD48cHJlPiZsdDtkaXYgbmc6YmluZD0ic25pcHBldCImZ3Q7PGJyLz4mbHQ7L2RpdiZndDs8L3ByZT48L3RkPgogICAgICAgICAgIDx0ZD48ZGl2IG5nOmJpbmQ9InNuaXBwZXQiPjwvZGl2PjwvdGQ+CiAgICAgICAgIDwvdHI+CiAgICAgICA8L3RhYmxlPgogICAgIDwvZG9jOnNvdXJjZT4KICAgICA8ZG9jOnNjZW5hcmlvPgogICAgICAgaXQoJ3Nob3VsZCBsaW5raWZ5IHRoZSBzbmlwcGV0IHdpdGggdXJscycsIGZ1bmN0aW9uKCl7CiAgICAgICAgIGV4cGVjdCh1c2luZygnI2xpbmt5LWZpbHRlcicpLmJpbmRpbmcoJ3NuaXBwZXQgfCBsaW5reScpKS4KICAgICAgICAgICB0b0JlKCdQcmV0dHkgdGV4dCB3aXRoIHNvbWUgbGlua3M6XG4nICsKICAgICAgICAgICAgICAgICc8YSBocmVmPSJodHRwOi8vYW5ndWxhcmpzLm9yZy8iPmh0dHA6Ly9hbmd1bGFyanMub3JnLzwvYT4sXG4nICsKICAgICAgICAgICAgICAgICc8YSBocmVmPSJtYWlsdG86dXNAc29tZXdoZXJlLm9yZyI+dXNAc29tZXdoZXJlLm9yZzwvYT4sXG4nICsKICAgICAgICAgICAgICAgICc8YSBocmVmPSJtYWlsdG86YW5vdGhlckBzb21ld2hlcmUub3JnIj5hbm90aGVyQHNvbWV3aGVyZS5vcmc8L2E+LFxuJyArCiAgICAgICAgICAgICAgICAnYW5kIG9uZSBtb3JlOiA8YSBocmVmPSJmdHA6Ly8xMjcuMC4wLjEvIj5mdHA6Ly8xMjcuMC4wLjEvPC9hPi4nKTsKICAgICAgIH0pOwoKICAgICAgIGl0ICgnc2hvdWxkIG5vdCBsaW5raWZ5IHNuaXBwZXQgd2l0aG91dCB0aGUgbGlua3kgZmlsdGVyJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGV4cGVjdCh1c2luZygnI2VzY2FwZWQtaHRtbCcpLmJpbmRpbmcoJ3NuaXBwZXQnKSkuCiAgICAgICAgICAgdG9CZSgiUHJldHR5IHRleHQgd2l0aCBzb21lIGxpbmtzOlxuIiArCiAgICAgICAgICAgICAgICAiaHR0cDovL2FuZ3VsYXJqcy5vcmcvLFxuIiArCiAgICAgICAgICAgICAgICAibWFpbHRvOnVzQHNvbWV3aGVyZS5vcmcsXG4iICsKICAgICAgICAgICAgICAgICJhbm90aGVyQHNvbWV3aGVyZS5vcmcsXG4iICsKICAgICAgICAgICAgICAgICJhbmQgb25lIG1vcmU6IGZ0cDovLzEyNy4wLjAuMS8uIik7CiAgICAgICB9KTsKCiAgICAgICBpdCgnc2hvdWxkIHVwZGF0ZScsIGZ1bmN0aW9uKCl7CiAgICAgICAgIGlucHV0KCdzbmlwcGV0JykuZW50ZXIoJ25ldyBodHRwOi8vbGluay4nKTsKICAgICAgICAgZXhwZWN0KHVzaW5nKCcjbGlua3ktZmlsdGVyJykuYmluZGluZygnc25pcHBldCB8IGxpbmt5JykpLgogICAgICAgICAgIHRvQmUoJ25ldyA8YSBocmVmPSJodHRwOi8vbGluayI+aHR0cDovL2xpbms8L2E+LicpOwogICAgICAgICBleHBlY3QodXNpbmcoJyNlc2NhcGVkLWh0bWwnKS5iaW5kaW5nKCdzbmlwcGV0JykpLnRvQmUoJ25ldyBodHRwOi8vbGluay4nKTsKICAgICAgIH0pOwogICAgIDwvZG9jOnNjZW5hcmlvPgogICA8L2RvYzpleGFtcGxlPgogKi8KLy9UT0RPOiBleHRlcm5hbGl6ZSBhbGwgcmVnZXhwcwphbmd1bGFyRmlsdGVyLmxpbmt5ID0gZnVuY3Rpb24odGV4dCl7CiAgaWYgKCF0ZXh0KSByZXR1cm4gdGV4dDsKICB2YXIgVVJMID0gLygoZnRwfGh0dHBzPyk6XC9cL3wobWFpbHRvOik/W0EtWmEtejAtOS5fJSstXStAKVxTKlteXHNcLlw7XCxcKFwpXHtcfVw8XD5dLzsKICB2YXIgbWF0Y2g7CiAgdmFyIHJhdyA9IHRleHQ7CiAgdmFyIGh0bWwgPSBbXTsKICB2YXIgd3JpdGVyID0gaHRtbFNhbml0aXplV3JpdGVyKGh0bWwpOwogIHZhciB1cmw7CiAgdmFyIGk7CiAgd2hpbGUgKG1hdGNoPXJhdy5tYXRjaChVUkwpKSB7CiAgICAvLyBXZSBjYW4gbm90IGVuZCBpbiB0aGVzZSBhcyB0aGV5IGFyZSBzb21ldGltZXMgZm91bmQgYXQgdGhlIGVuZCBvZiB0aGUgc2VudGVuY2UKICAgIHVybCA9IG1hdGNoWzBdOwogICAgLy8gaWYgd2UgZGlkIG5vdCBtYXRjaCBmdHAvaHR0cC9tYWlsdG8gdGhlbiBhc3N1bWUgbWFpbHRvCiAgICBpZiAobWF0Y2hbMl09PW1hdGNoWzNdKSB1cmwgPSAnbWFpbHRvOicgKyB1cmw7CiAgICBpID0gbWF0Y2guaW5kZXg7CiAgICB3cml0ZXIuY2hhcnMocmF3LnN1YnN0cigwLCBpKSk7CiAgICB3cml0ZXIuc3RhcnQoJ2EnLCB7aHJlZjp1cmx9KTsKICAgIHdyaXRlci5jaGFycyhtYXRjaFswXS5yZXBsYWNlKC9ebWFpbHRvOi8sICcnKSk7CiAgICB3cml0ZXIuZW5kKCdhJyk7CiAgICByYXcgPSByYXcuc3Vic3RyaW5nKGkgKyBtYXRjaFswXS5sZW5ndGgpOwogIH0KICB3cml0ZXIuY2hhcnMocmF3KTsKICByZXR1cm4gbmV3IEhUTUwoaHRtbC5qb2luKCcnKSk7Cn07Cid1c2Ugc3RyaWN0JzsKCi8qKgogKiBAd29ya0luUHJvZ3Jlc3MKICogQG5nZG9jIG92ZXJ2aWV3CiAqIEBuYW1lIGFuZ3VsYXIuZm9ybWF0dGVyCiAqIEBkZXNjcmlwdGlvbgogKgogKiBGb3JtYXR0ZXJzIGFyZSB1c2VkIGZvciB0cmFuc2xhdGluZyBkYXRhIGZvcm1hdHMgYmV0d2VlbiB0aG9zZSB1c2VkIGZvciBkaXNwbGF5IGFuZCB0aG9zZSB1c2VkCiAqIGZvciBzdG9yYWdlLgogKgogKiBGb2xsb3dpbmcgaXMgdGhlIGxpc3Qgb2YgYnVpbHQtaW4gYW5ndWxhciBmb3JtYXR0ZXJzOgogKgogKiAqIHtAbGluayBhbmd1bGFyLmZvcm1hdHRlci5ib29sZWFuIGJvb2xlYW59IC0gRm9ybWF0cyB1c2VyIGlucHV0IGluIGJvb2xlYW4gZm9ybWF0CiAqICoge0BsaW5rIGFuZ3VsYXIuZm9ybWF0dGVyLmpzb24ganNvbn0gLSBGb3JtYXRzIHVzZXIgaW5wdXQgaW4gSlNPTiBmb3JtYXQKICogKiB7QGxpbmsgYW5ndWxhci5mb3JtYXR0ZXIubGlzdCBsaXN0fSAtIEZvcm1hdHMgdXNlciBpbnB1dCBzdHJpbmcgYXMgYW4gYXJyYXkKICogKiB7QGxpbmsgYW5ndWxhci5mb3JtYXR0ZXIubnVtYmVyIG51bWJlcn0gLSBGb3JtYXRzIHVzZXIgaW5wdXQgc3RyaW5ncyBhcyBhIG51bWJlcgogKiAqIHtAbGluayBhbmd1bGFyLmZvcm1hdHRlci50cmltIHRyaW19IC0gVHJpbXMgZXh0cmFzIHNwYWNlcyBmcm9tIGVuZCBvZiB1c2VyIGlucHV0CiAqCiAqIEZvciBtb3JlIGluZm9ybWF0aW9uIGFib3V0IGhvdyBhbmd1bGFyIGZvcm1hdHRlcnMgd29yaywgYW5kIGhvdyB0byBjcmVhdGUgeW91ciBvd24gZm9ybWF0dGVycywKICogc2VlIHtAbGluayBndWlkZS9kZXZfZ3VpZGUudGVtcGxhdGVzLmZvcm1hdHRlcnMgVW5kZXJzdGFuZGluZyBBbmd1bGFyIEZvcm1hdHRlcnN9IGluIHRoZSBhbmd1bGFyCiAqIERldmVsb3BlciBHdWlkZS4KICovCgpmdW5jdGlvbiBmb3JtYXR0ZXIoZm9ybWF0LCBwYXJzZSkge3JldHVybiB7J2Zvcm1hdCc6Zm9ybWF0LCAncGFyc2UnOnBhcnNlIHx8IGZvcm1hdH07fQpmdW5jdGlvbiB0b1N0cmluZyhvYmopIHsKICByZXR1cm4gKGlzRGVmaW5lZChvYmopICYmIG9iaiAhPT0gbnVsbCkgPyAiIiArIG9iaiA6IG9iajsKfQoKdmFyIE5VTUJFUiA9IC9eXHMqWy0rXT9cZCooXC5cZCopP1xzKiQvOwoKYW5ndWxhckZvcm1hdHRlci5ub29wID0gZm9ybWF0dGVyKGlkZW50aXR5LCBpZGVudGl0eSk7CgovKioKICogQHdvcmtJblByb2dyZXNzCiAqIEBuZ2RvYyBmb3JtYXR0ZXIKICogQG5hbWUgYW5ndWxhci5mb3JtYXR0ZXIuanNvbgogKgogKiBAZGVzY3JpcHRpb24KICogICBGb3JtYXRzIHRoZSB1c2VyIGlucHV0IGFzIEpTT04gdGV4dC4KICoKICogQHJldHVybnMgez9zdHJpbmd9IEEgSlNPTiBzdHJpbmcgcmVwcmVzZW50YXRpb24gb2YgdGhlIG1vZGVsLgogKgogKiBAZXhhbXBsZQogICA8ZG9jOmV4YW1wbGU+CiAgICAgPGRvYzpzb3VyY2U+CiAgICAgIDxkaXYgbmc6aW5pdD0iZGF0YT17bmFtZTonbWlza28nLCBwcm9qZWN0Oidhbmd1bGFyJ30iPgogICAgICAgIDxpbnB1dCB0eXBlPSJ0ZXh0IiBzaXplPSc1MCcgbmFtZT0iZGF0YSIgbmc6Zm9ybWF0PSJqc29uIi8+CiAgICAgICAgPHByZT5kYXRhPXt7ZGF0YX19PC9wcmU+CiAgICAgIDwvZGl2PgogICAgIDwvZG9jOnNvdXJjZT4KICAgICA8ZG9jOnNjZW5hcmlvPgogICAgICBpdCgnc2hvdWxkIGZvcm1hdCBqc29uJywgZnVuY3Rpb24oKXsKICAgICAgICBleHBlY3QoYmluZGluZygnZGF0YScpKS50b0VxdWFsKCdkYXRhPXtcbiAgXCJuYW1lXCI6XCJtaXNrb1wiLFxuICBcInByb2plY3RcIjpcImFuZ3VsYXJcIn0nKTsKICAgICAgICBpbnB1dCgnZGF0YScpLmVudGVyKCd7fScpOwogICAgICAgIGV4cGVjdChiaW5kaW5nKCdkYXRhJykpLnRvRXF1YWwoJ2RhdGE9e1xuICB9Jyk7CiAgICAgIH0pOwogICAgIDwvZG9jOnNjZW5hcmlvPgogICA8L2RvYzpleGFtcGxlPgogKi8KYW5ndWxhckZvcm1hdHRlci5qc29uID0gZm9ybWF0dGVyKHRvSnNvbiwgZnVuY3Rpb24odmFsdWUpewogIHJldHVybiBmcm9tSnNvbih2YWx1ZSB8fCAnbnVsbCcpOwp9KTsKCi8qKgogKiBAd29ya0luUHJvZ3Jlc3MKICogQG5nZG9jIGZvcm1hdHRlcgogKiBAbmFtZSBhbmd1bGFyLmZvcm1hdHRlci5ib29sZWFuCiAqCiAqIEBkZXNjcmlwdGlvbgogKiAgIFVzZSBib29sZWFuIGZvcm1hdHRlciBpZiB5b3Ugd2lzaCB0byBzdG9yZSB0aGUgZGF0YSBhcyBib29sZWFuLgogKgogKiBAcmV0dXJucyB7Ym9vbGVhbn0gQ29udmVydHMgdG8gYHRydWVgIHVubGVzcyB1c2VyIGVudGVycyAoYmxhbmspLCBgZmAsIGBmYWxzZWAsIGAwYCwgYG5vYCwgYFtdYC4KICoKICogQGV4YW1wbGUKICAgPGRvYzpleGFtcGxlPgogICAgIDxkb2M6c291cmNlPgogICAgICAgIEVudGVyIHRydXRoeSB0ZXh0OgogICAgICAgIDxpbnB1dCB0eXBlPSJ0ZXh0IiBuYW1lPSJ2YWx1ZSIgbmc6Zm9ybWF0PSJib29sZWFuIiB2YWx1ZT0ibm8iLz4KICAgICAgICA8aW5wdXQgdHlwZT0iY2hlY2tib3giIG5hbWU9InZhbHVlIi8+CiAgICAgICAgPHByZT52YWx1ZT17e3ZhbHVlfX08L3ByZT4KICAgICA8L2RvYzpzb3VyY2U+CiAgICAgPGRvYzpzY2VuYXJpbz4KICAgICAgICBpdCgnc2hvdWxkIGZvcm1hdCBib29sZWFuJywgZnVuY3Rpb24oKXsKICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCd2YWx1ZScpKS50b0VxdWFsKCd2YWx1ZT1mYWxzZScpOwogICAgICAgICAgaW5wdXQoJ3ZhbHVlJykuZW50ZXIoJ3RydXRoeScpOwogICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3ZhbHVlJykpLnRvRXF1YWwoJ3ZhbHVlPXRydWUnKTsKICAgICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgPC9kb2M6ZXhhbXBsZT4KICovCmFuZ3VsYXJGb3JtYXR0ZXJbJ2Jvb2xlYW4nXSA9IGZvcm1hdHRlcih0b1N0cmluZywgdG9Cb29sZWFuKTsKCi8qKgogKiBAd29ya0luUHJvZ3Jlc3MKICogQG5nZG9jIGZvcm1hdHRlcgogKiBAbmFtZSBhbmd1bGFyLmZvcm1hdHRlci5udW1iZXIKICoKICogQGRlc2NyaXB0aW9uCiAqIFVzZSBudW1iZXIgZm9ybWF0dGVyIGlmIHlvdSB3aXNoIHRvIGNvbnZlcnQgdGhlIHVzZXIgZW50ZXJlZCBzdHJpbmcgdG8gYSBudW1iZXIuCiAqCiAqIEByZXR1cm5zIHtudW1iZXJ9IE51bWJlciBmcm9tIHRoZSBwYXJzZWQgc3RyaW5nLgogKgogKiBAZXhhbXBsZQogICA8ZG9jOmV4YW1wbGU+CiAgICAgPGRvYzpzb3VyY2U+CiAgICAgIEVudGVyIHZhbGlkIG51bWJlcjoKICAgICAgPGlucHV0IHR5cGU9InRleHQiIG5hbWU9InZhbHVlIiBuZzpmb3JtYXQ9Im51bWJlciIgdmFsdWU9IjEyMzQiLz4KICAgICAgPHByZT52YWx1ZT17e3ZhbHVlfX08L3ByZT4KICAgICA8L2RvYzpzb3VyY2U+CiAgICAgPGRvYzpzY2VuYXJpbz4KICAgICAgaXQoJ3Nob3VsZCBmb3JtYXQgbnVtYmVycycsIGZ1bmN0aW9uKCl7CiAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3ZhbHVlJykpLnRvRXF1YWwoJ3ZhbHVlPTEyMzQnKTsKICAgICAgICBpbnB1dCgndmFsdWUnKS5lbnRlcignNTY3OCcpOwogICAgICAgIGV4cGVjdChiaW5kaW5nKCd2YWx1ZScpKS50b0VxdWFsKCd2YWx1ZT01Njc4Jyk7CiAgICAgIH0pOwogICAgIDwvZG9jOnNjZW5hcmlvPgogICA8L2RvYzpleGFtcGxlPgogKi8KYW5ndWxhckZvcm1hdHRlci5udW1iZXIgPSBmb3JtYXR0ZXIodG9TdHJpbmcsIGZ1bmN0aW9uKG9iail7CiAgaWYgKG9iaiA9PSBudWxsIHx8IE5VTUJFUi5leGVjKG9iaikpIHsKICAgIHJldHVybiBvYmo9PT1udWxsIHx8IG9iaiA9PT0gJycgPyBudWxsIDogMSpvYmo7CiAgfSBlbHNlIHsKICAgIHRocm93ICJOb3QgYSBudW1iZXIiOwogIH0KfSk7CgovKioKICogQHdvcmtJblByb2dyZXNzCiAqIEBuZ2RvYyBmb3JtYXR0ZXIKICogQG5hbWUgYW5ndWxhci5mb3JtYXR0ZXIubGlzdAogKgogKiBAZGVzY3JpcHRpb24KICogVXNlIGxpc3QgZm9ybWF0dGVyIGlmIHlvdSB3aXNoIHRvIGNvbnZlcnQgdGhlIHVzZXIgZW50ZXJlZCBzdHJpbmcgdG8gYW4gYXJyYXkuCiAqCiAqIEByZXR1cm5zIHtBcnJheX0gQXJyYXkgcGFyc2VkIGZyb20gdGhlIGVudGVyZWQgc3RyaW5nLgogKgogKiBAZXhhbXBsZQogICA8ZG9jOmV4YW1wbGU+CiAgICAgPGRvYzpzb3VyY2U+CiAgICAgICAgRW50ZXIgYSBsaXN0IG9mIGl0ZW1zOgogICAgICAgIDxpbnB1dCB0eXBlPSJ0ZXh0IiBuYW1lPSJ2YWx1ZSIgbmc6Zm9ybWF0PSJsaXN0IiB2YWx1ZT0iIGNoYWlyICwsIHRhYmxlIi8+CiAgICAgICAgPGlucHV0IHR5cGU9InRleHQiIG5hbWU9InZhbHVlIiBuZzpmb3JtYXQ9Imxpc3QiLz4KICAgICAgICA8cHJlPnZhbHVlPXt7dmFsdWV9fTwvcHJlPgogICAgIDwvZG9jOnNvdXJjZT4KICAgICA8ZG9jOnNjZW5hcmlvPgogICAgICBpdCgnc2hvdWxkIGZvcm1hdCBsaXN0cycsIGZ1bmN0aW9uKCl7CiAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3ZhbHVlJykpLnRvRXF1YWwoJ3ZhbHVlPVsiY2hhaXIiLCJ0YWJsZSJdJyk7CiAgICAgICAgdGhpcy5hZGRGdXR1cmVBY3Rpb24oJ2NoYW5nZSB0byBYWVonLCBmdW5jdGlvbigkd2luZG93LCAkZG9jdW1lbnQsIGRvbmUpewogICAgICAgICAgJGRvY3VtZW50LmVsZW1lbnRzKCcuZG9jLWV4YW1wbGUtbGl2ZSA6aW5wdXQ6bGFzdCcpLnZhbCgnLCxhLGIsJykudHJpZ2dlcignY2hhbmdlJyk7CiAgICAgICAgICBkb25lKCk7CiAgICAgICAgfSk7CiAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3ZhbHVlJykpLnRvRXF1YWwoJ3ZhbHVlPVsiYSIsImIiXScpOwogICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgPC9kb2M6ZXhhbXBsZT4KICovCmFuZ3VsYXJGb3JtYXR0ZXIubGlzdCA9IGZvcm1hdHRlcigKICBmdW5jdGlvbihvYmopIHsgcmV0dXJuIG9iaiA/IG9iai5qb2luKCIsICIpIDogb2JqOyB9LAogIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICB2YXIgbGlzdCA9IFtdOwogICAgZm9yRWFjaCgodmFsdWUgfHwgJycpLnNwbGl0KCcsJyksIGZ1bmN0aW9uKGl0ZW0pewogICAgICBpdGVtID0gdHJpbShpdGVtKTsKICAgICAgaWYgKGl0ZW0pIGxpc3QucHVzaChpdGVtKTsKICAgIH0pOwogICAgcmV0dXJuIGxpc3Q7CiAgfQopOwoKLyoqCiAqIEB3b3JrSW5Qcm9ncmVzcwogKiBAbmdkb2MgZm9ybWF0dGVyCiAqIEBuYW1lIGFuZ3VsYXIuZm9ybWF0dGVyLnRyaW0KICoKICogQGRlc2NyaXB0aW9uCiAqIFVzZSB0cmltIGZvcm1hdHRlciBpZiB5b3Ugd2lzaCB0byB0cmltIGV4dHJhIHNwYWNlcyBpbiB1c2VyIHRleHQuCiAqCiAqIEByZXR1cm5zIHtTdHJpbmd9IFRyaW0gZXhjZXNzIGxlYWRpbmcgYW5kIHRyYWlsaW5nIHNwYWNlLgogKgogKiBAZXhhbXBsZQogICA8ZG9jOmV4YW1wbGU+CiAgICAgPGRvYzpzb3VyY2U+CiAgICAgICAgRW50ZXIgdGV4dCB3aXRoIGxlYWRpbmcvdHJhaWxpbmcgc3BhY2VzOgogICAgICAgIDxpbnB1dCB0eXBlPSJ0ZXh0IiBuYW1lPSJ2YWx1ZSIgbmc6Zm9ybWF0PSJ0cmltIiB2YWx1ZT0iICBib29rICAiLz4KICAgICAgICA8aW5wdXQgdHlwZT0idGV4dCIgbmFtZT0idmFsdWUiIG5nOmZvcm1hdD0idHJpbSIvPgogICAgICAgIDxwcmU+dmFsdWU9e3t2YWx1ZXxqc29ufX08L3ByZT4KICAgICA8L2RvYzpzb3VyY2U+CiAgICAgPGRvYzpzY2VuYXJpbz4KICAgICAgICBpdCgnc2hvdWxkIGZvcm1hdCB0cmltJywgZnVuY3Rpb24oKXsKICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCd2YWx1ZScpKS50b0VxdWFsKCd2YWx1ZT0iYm9vayInKTsKICAgICAgICAgIHRoaXMuYWRkRnV0dXJlQWN0aW9uKCdjaGFuZ2UgdG8gWFlaJywgZnVuY3Rpb24oJHdpbmRvdywgJGRvY3VtZW50LCBkb25lKXsKICAgICAgICAgICAgJGRvY3VtZW50LmVsZW1lbnRzKCcuZG9jLWV4YW1wbGUtbGl2ZSA6aW5wdXQ6bGFzdCcpLnZhbCgnICB0ZXh0ICAnKS50cmlnZ2VyKCdjaGFuZ2UnKTsKICAgICAgICAgICAgZG9uZSgpOwogICAgICAgICAgfSk7CiAgICAgICAgICBleHBlY3QoYmluZGluZygndmFsdWUnKSkudG9FcXVhbCgndmFsdWU9InRleHQiJyk7CiAgICAgICAgfSk7CiAgICAgPC9kb2M6c2NlbmFyaW8+CiAgIDwvZG9jOmV4YW1wbGU+CiAqLwphbmd1bGFyRm9ybWF0dGVyLnRyaW0gPSBmb3JtYXR0ZXIoCiAgZnVuY3Rpb24ob2JqKSB7IHJldHVybiBvYmogPyB0cmltKCIiICsgb2JqKSA6ICIiOyB9Cik7Cid1c2Ugc3RyaWN0JzsKCi8qKgogKiBAd29ya0luUHJvZ3Jlc3MKICogQG5nZG9jIG92ZXJ2aWV3CiAqIEBuYW1lIGFuZ3VsYXIudmFsaWRhdG9yCiAqIEBkZXNjcmlwdGlvbgogKgogKiBNb3N0IG9mIHRoZSBidWlsdC1pbiBhbmd1bGFyIHZhbGlkYXRvcnMgYXJlIHVzZWQgdG8gY2hlY2sgdXNlciBpbnB1dCBhZ2FpbnN0IGRlZmluZWQgdHlwZXMgb3IKICogcGF0dGVybnMuICBZb3UgY2FuIGVhc2lseSBjcmVhdGUgeW91ciBvd24gY3VzdG9tIHZhbGlkYXRvcnMgYXMgd2VsbC4KICoKICogRm9sbG93aW5nIGlzIHRoZSBsaXN0IG9mIGJ1aWx0LWluIGFuZ3VsYXIgdmFsaWRhdG9yczoKICoKICogKiB7QGxpbmsgYW5ndWxhci52YWxpZGF0b3IuYXN5bmNocm9ub3VzIGFzeW5jaHJvbm91cygpfSAtIFByb3ZpZGVzIGFzeW5jaHJvbm91cyB2YWxpZGF0aW9uIHZpYSBhCiAqIGNhbGxiYWNrIGZ1bmN0aW9uLgogKiAqIHtAbGluayBhbmd1bGFyLnZhbGlkYXRvci5kYXRlIGRhdGUoKX0gLSBDaGVja3MgdXNlciBpbnB1dCBhZ2FpbnN0IGRlZmF1bHQgZGF0ZSBmb3JtYXQ6CiAqICJNTS9ERC9ZWVlZIgogKiAqIHtAbGluayBhbmd1bGFyLnZhbGlkYXRvci5lbWFpbCBlbWFpbCgpfSAtIFZhbGlkYXRlcyB0aGF0IHVzZXIgaW5wdXQgaXMgYSB3ZWxsLWZvcm1lZCBlbWFpbAogKiBhZGRyZXNzLgogKiAqIHtAbGluayBhbmd1bGFyLnZhbGlkYXRvci5pbnRlZ2VyIGludGVnZXIoKX0gLSBWYWxpZGF0ZXMgdGhhdCB1c2VyIGlucHV0IGlzIGFuIGludGVnZXIKICogKiB7QGxpbmsgYW5ndWxhci52YWxpZGF0b3IuanNvbiBqc29uKCl9IC0gVmFsaWRhdGVzIHRoYXQgdXNlciBpbnB1dCBpcyB2YWxpZCBKU09OCiAqICoge0BsaW5rIGFuZ3VsYXIudmFsaWRhdG9yLm51bWJlciBudW1iZXIoKX0gLSBWYWxpZGF0ZXMgdGhhdCB1c2VyIGlucHV0IGlzIGEgbnVtYmVyCiAqICoge0BsaW5rIGFuZ3VsYXIudmFsaWRhdG9yLnBob25lIHBob25lKCl9IC0gVmFsaWRhdGVzIHRoYXQgdXNlciBpbnB1dCBtYXRjaGVzIHRoZSBwYXR0ZXJuCiAqICIxKDEyMykxMjMtMTIzNCIKICogKiB7QGxpbmsgYW5ndWxhci52YWxpZGF0b3IucmVnZXhwIHJlZ2V4cCgpfSAtIFJlc3RyaWN0cyB2YWxpZCBpbnB1dCB0byBhIHNwZWNpZmllZCByZWd1bGFyCiAqIGV4cHJlc3Npb24gcGF0dGVybgogKiAqIHtAbGluayBhbmd1bGFyLnZhbGlkYXRvci51cmwgdXJsKCl9IC0gVmFsaWRhdGVzIHRoYXQgdXNlciBpbnB1dCBpcyBhIHdlbGwtZm9ybWVkIFVSTC4KICoKICogRm9yIG1vcmUgaW5mb3JtYXRpb24gYWJvdXQgaG93IGFuZ3VsYXIgdmFsaWRhdG9ycyB3b3JrLCBhbmQgaG93IHRvIGNyZWF0ZSB5b3VyIG93biB2YWxpZGF0b3JzLAogKiBzZWUge0BsaW5rIGd1aWRlL2Rldl9ndWlkZS50ZW1wbGF0ZXMudmFsaWRhdG9ycyBVbmRlcnN0YW5kaW5nIEFuZ3VsYXIgVmFsaWRhdG9yc30gaW4gdGhlIGFuZ3VsYXIKICogRGV2ZWxvcGVyIEd1aWRlLgogKi8KCmV4dGVuZChhbmd1bGFyVmFsaWRhdG9yLCB7CiAgJ25vb3AnOiBmdW5jdGlvbigpIHsgcmV0dXJuIG51bGw7IH0sCgogIC8qKgogICAqIEB3b3JrSW5Qcm9ncmVzcwogICAqIEBuZ2RvYyB2YWxpZGF0b3IKICAgKiBAbmFtZSBhbmd1bGFyLnZhbGlkYXRvci5yZWdleHAKICAgKiBAZGVzY3JpcHRpb24KICAgKiBVc2UgcmVnZXhwIHZhbGlkYXRvciB0byByZXN0cmljdCB0aGUgaW5wdXQgdG8gYW55IFJlZ3VsYXIgRXhwcmVzc2lvbi4KICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfSB2YWx1ZSB2YWx1ZSB0byB2YWxpZGF0ZQogICAqIEBwYXJhbSB7c3RyaW5nfHJlZ2V4cH0gZXhwcmVzc2lvbiByZWd1bGFyIGV4cHJlc3Npb24uCiAgICogQHBhcmFtIHtzdHJpbmc9fSBtc2cgZXJyb3IgbWVzc2FnZSB0byBkaXNwbGF5LgogICAqIEBjc3MgbmctdmFsaWRhdGlvbi1lcnJvcgogICAqCiAgICogQGV4YW1wbGUKICAgIDxkb2M6ZXhhbXBsZT4KICAgICAgPGRvYzpzb3VyY2U+CiAgICAgICAgPHNjcmlwdD4gZnVuY3Rpb24gQ250bCgpewogICAgICAgICB0aGlzLnNzblJlZ0V4cCA9IC9eXGRcZFxkLVxkXGQtXGRcZFxkXGQkLzsKICAgICAgICB9CiAgICAgICAgPC9zY3JpcHQ+CiAgICAgICAgRW50ZXIgdmFsaWQgU1NOOgogICAgICAgIDxkaXYgbmc6Y29udHJvbGxlcj0iQ250bCI+CiAgICAgICAgPGlucHV0IG5hbWU9InNzbiIgdmFsdWU9IjEyMy00NS02Nzg5IiBuZzp2YWxpZGF0ZT0icmVnZXhwOnNzblJlZ0V4cCIgPgogICAgICAgIDwvZGl2PgogICAgICA8L2RvYzpzb3VyY2U+CiAgICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgICAgaXQoJ3Nob3VsZCBpbnZhbGlkYXRlIG5vbiBzc24nLCBmdW5jdGlvbigpewogICAgICAgICB2YXIgdGV4dEJveCA9IGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIDppbnB1dCcpOwogICAgICAgICBleHBlY3QodGV4dEJveC5hdHRyKCdjbGFzc05hbWUnKSkubm90KCkudG9NYXRjaCgvbmctdmFsaWRhdGlvbi1lcnJvci8pOwogICAgICAgICBleHBlY3QodGV4dEJveC52YWwoKSkudG9FcXVhbCgnMTIzLTQ1LTY3ODknKTsKICAgICAgICAgaW5wdXQoJ3NzbicpLmVudGVyKCcxMjMtNDUtNjc4OTAnKTsKICAgICAgICAgZXhwZWN0KHRleHRCb3guYXR0cignY2xhc3NOYW1lJykpLnRvTWF0Y2goL25nLXZhbGlkYXRpb24tZXJyb3IvKTsKICAgICAgICB9KTsKICAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICA8L2RvYzpleGFtcGxlPgogICAqCiAgICovCiAgJ3JlZ2V4cCc6IGZ1bmN0aW9uKHZhbHVlLCByZWdleHAsIG1zZykgewogICAgaWYgKCF2YWx1ZS5tYXRjaChyZWdleHApKSB7CiAgICAgIHJldHVybiBtc2cgfHwKICAgICAgICAiVmFsdWUgZG9lcyBub3QgbWF0Y2ggZXhwZWN0ZWQgZm9ybWF0ICIgKyByZWdleHAgKyAiLiI7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KICB9LAoKICAvKioKICAgKiBAd29ya0luUHJvZ3Jlc3MKICAgKiBAbmdkb2MgdmFsaWRhdG9yCiAgICogQG5hbWUgYW5ndWxhci52YWxpZGF0b3IubnVtYmVyCiAgICogQGRlc2NyaXB0aW9uCiAgICogVXNlIG51bWJlciB2YWxpZGF0b3IgdG8gcmVzdHJpY3QgdGhlIGlucHV0IHRvIG51bWJlcnMgd2l0aCBhbgogICAqIG9wdGlvbmFsIHJhbmdlLiAoU2VlIGludGVnZXIgZm9yIHdob2xlIG51bWJlcnMgdmFsaWRhdG9yKS4KICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfSB2YWx1ZSB2YWx1ZSB0byB2YWxpZGF0ZQogICAqIEBwYXJhbSB7aW50PX0gW21pbj1NSU5fSU5UXSBtaW5pbXVtIHZhbHVlLgogICAqIEBwYXJhbSB7aW50PX0gW21heD1NQVhfSU5UXSBtYXhpbXVtIHZhbHVlLgogICAqIEBjc3MgbmctdmFsaWRhdGlvbi1lcnJvcgogICAqCiAgICogQGV4YW1wbGUKICAgIDxkb2M6ZXhhbXBsZT4KICAgICAgPGRvYzpzb3VyY2U+CiAgICAgICAgRW50ZXIgbnVtYmVyOiA8aW5wdXQgbmFtZT0ibjEiIG5nOnZhbGlkYXRlPSJudW1iZXIiID4gPGJyPgogICAgICAgIEVudGVyIG51bWJlciBncmVhdGVyIHRoYW4gMTA6IDxpbnB1dCBuYW1lPSJuMiIgbmc6dmFsaWRhdGU9Im51bWJlcjoxMCIgPiA8YnI+CiAgICAgICAgRW50ZXIgbnVtYmVyIGJldHdlZW4gMTAwIGFuZCAyMDA6IDxpbnB1dCBuYW1lPSJuMyIgbmc6dmFsaWRhdGU9Im51bWJlcjoxMDA6MjAwIiA+IDxicj4KICAgICAgPC9kb2M6c291cmNlPgogICAgICA8ZG9jOnNjZW5hcmlvPgogICAgICAgIGl0KCdzaG91bGQgaW52YWxpZGF0ZSBudW1iZXInLCBmdW5jdGlvbigpewogICAgICAgICB2YXIgbjEgPSBlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSA6aW5wdXRbbmFtZT1uMV0nKTsKICAgICAgICAgZXhwZWN0KG4xLmF0dHIoJ2NsYXNzTmFtZScpKS5ub3QoKS50b01hdGNoKC9uZy12YWxpZGF0aW9uLWVycm9yLyk7CiAgICAgICAgIGlucHV0KCduMScpLmVudGVyKCcxLngnKTsKICAgICAgICAgZXhwZWN0KG4xLmF0dHIoJ2NsYXNzTmFtZScpKS50b01hdGNoKC9uZy12YWxpZGF0aW9uLWVycm9yLyk7CiAgICAgICAgIHZhciBuMiA9IGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIDppbnB1dFtuYW1lPW4yXScpOwogICAgICAgICBleHBlY3QobjIuYXR0cignY2xhc3NOYW1lJykpLm5vdCgpLnRvTWF0Y2goL25nLXZhbGlkYXRpb24tZXJyb3IvKTsKICAgICAgICAgaW5wdXQoJ24yJykuZW50ZXIoJzknKTsKICAgICAgICAgZXhwZWN0KG4yLmF0dHIoJ2NsYXNzTmFtZScpKS50b01hdGNoKC9uZy12YWxpZGF0aW9uLWVycm9yLyk7CiAgICAgICAgIHZhciBuMyA9IGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIDppbnB1dFtuYW1lPW4zXScpOwogICAgICAgICBleHBlY3QobjMuYXR0cignY2xhc3NOYW1lJykpLm5vdCgpLnRvTWF0Y2goL25nLXZhbGlkYXRpb24tZXJyb3IvKTsKICAgICAgICAgaW5wdXQoJ24zJykuZW50ZXIoJzIwMScpOwogICAgICAgICBleHBlY3QobjMuYXR0cignY2xhc3NOYW1lJykpLnRvTWF0Y2goL25nLXZhbGlkYXRpb24tZXJyb3IvKTsKICAgICAgICB9KTsKICAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICA8L2RvYzpleGFtcGxlPgogICAqCiAgICovCiAgJ251bWJlcic6IGZ1bmN0aW9uKHZhbHVlLCBtaW4sIG1heCkgewogICAgdmFyIG51bSA9IDEgKiB2YWx1ZTsKICAgIGlmIChudW0gPT0gdmFsdWUpIHsKICAgICAgaWYgKHR5cGVvZiBtaW4gIT0gJHVuZGVmaW5lZCAmJiBudW0gPCBtaW4pIHsKICAgICAgICByZXR1cm4gIlZhbHVlIGNhbiBub3QgYmUgbGVzcyB0aGFuICIgKyBtaW4gKyAiLiI7CiAgICAgIH0KICAgICAgaWYgKHR5cGVvZiBtaW4gIT0gJHVuZGVmaW5lZCAmJiBudW0gPiBtYXgpIHsKICAgICAgICByZXR1cm4gIlZhbHVlIGNhbiBub3QgYmUgZ3JlYXRlciB0aGFuICIgKyBtYXggKyAiLiI7CiAgICAgIH0KICAgICAgcmV0dXJuIG51bGw7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gIk5vdCBhIG51bWJlciI7CiAgICB9CiAgfSwKCiAgLyoqCiAgICogQHdvcmtJblByb2dyZXNzCiAgICogQG5nZG9jIHZhbGlkYXRvcgogICAqIEBuYW1lIGFuZ3VsYXIudmFsaWRhdG9yLmludGVnZXIKICAgKiBAZGVzY3JpcHRpb24KICAgKiBVc2UgbnVtYmVyIHZhbGlkYXRvciB0byByZXN0cmljdCB0aGUgaW5wdXQgdG8gaW50ZWdlcnMgd2l0aCBhbgogICAqIG9wdGlvbmFsIHJhbmdlLiAoU2VlIGludGVnZXIgZm9yIHdob2xlIG51bWJlcnMgdmFsaWRhdG9yKS4KICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfSB2YWx1ZSB2YWx1ZSB0byB2YWxpZGF0ZQogICAqIEBwYXJhbSB7aW50PX0gW21pbj1NSU5fSU5UXSBtaW5pbXVtIHZhbHVlLgogICAqIEBwYXJhbSB7aW50PX0gW21heD1NQVhfSU5UXSBtYXhpbXVtIHZhbHVlLgogICAqIEBjc3MgbmctdmFsaWRhdGlvbi1lcnJvcgogICAqCiAgICogQGV4YW1wbGUKICAgIDxkb2M6ZXhhbXBsZT4KICAgICAgPGRvYzpzb3VyY2U+CiAgICAgICAgRW50ZXIgaW50ZWdlcjogPGlucHV0IG5hbWU9Im4xIiBuZzp2YWxpZGF0ZT0iaW50ZWdlciIgPiA8YnI+CiAgICAgICAgRW50ZXIgaW50ZWdlciBlcXVhbCBvciBncmVhdGVyIHRoYW4gMTA6IDxpbnB1dCBuYW1lPSJuMiIgbmc6dmFsaWRhdGU9ImludGVnZXI6MTAiID4gPGJyPgogICAgICAgIEVudGVyIGludGVnZXIgYmV0d2VlbiAxMDAgYW5kIDIwMCAoaW5jbHVzaXZlKTogPGlucHV0IG5hbWU9Im4zIiBuZzp2YWxpZGF0ZT0iaW50ZWdlcjoxMDA6MjAwIiA+IDxicj4KICAgICAgPC9kb2M6c291cmNlPgogICAgICA8ZG9jOnNjZW5hcmlvPgogICAgICAgIGl0KCdzaG91bGQgaW52YWxpZGF0ZSBpbnRlZ2VyJywgZnVuY3Rpb24oKXsKICAgICAgICAgdmFyIG4xID0gZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgOmlucHV0W25hbWU9bjFdJyk7CiAgICAgICAgIGV4cGVjdChuMS5hdHRyKCdjbGFzc05hbWUnKSkubm90KCkudG9NYXRjaCgvbmctdmFsaWRhdGlvbi1lcnJvci8pOwogICAgICAgICBpbnB1dCgnbjEnKS5lbnRlcignMS4xJyk7CiAgICAgICAgIGV4cGVjdChuMS5hdHRyKCdjbGFzc05hbWUnKSkudG9NYXRjaCgvbmctdmFsaWRhdGlvbi1lcnJvci8pOwogICAgICAgICB2YXIgbjIgPSBlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSA6aW5wdXRbbmFtZT1uMl0nKTsKICAgICAgICAgZXhwZWN0KG4yLmF0dHIoJ2NsYXNzTmFtZScpKS5ub3QoKS50b01hdGNoKC9uZy12YWxpZGF0aW9uLWVycm9yLyk7CiAgICAgICAgIGlucHV0KCduMicpLmVudGVyKCcxMC4xJyk7CiAgICAgICAgIGV4cGVjdChuMi5hdHRyKCdjbGFzc05hbWUnKSkudG9NYXRjaCgvbmctdmFsaWRhdGlvbi1lcnJvci8pOwogICAgICAgICB2YXIgbjMgPSBlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSA6aW5wdXRbbmFtZT1uM10nKTsKICAgICAgICAgZXhwZWN0KG4zLmF0dHIoJ2NsYXNzTmFtZScpKS5ub3QoKS50b01hdGNoKC9uZy12YWxpZGF0aW9uLWVycm9yLyk7CiAgICAgICAgIGlucHV0KCduMycpLmVudGVyKCcxMDAuMScpOwogICAgICAgICBleHBlY3QobjMuYXR0cignY2xhc3NOYW1lJykpLnRvTWF0Y2goL25nLXZhbGlkYXRpb24tZXJyb3IvKTsKICAgICAgICB9KTsKICAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICA8L2RvYzpleGFtcGxlPgogICAqLwogICdpbnRlZ2VyJzogZnVuY3Rpb24odmFsdWUsIG1pbiwgbWF4KSB7CiAgICB2YXIgbnVtYmVyRXJyb3IgPSBhbmd1bGFyVmFsaWRhdG9yWydudW1iZXInXSh2YWx1ZSwgbWluLCBtYXgpOwogICAgaWYgKG51bWJlckVycm9yKSByZXR1cm4gbnVtYmVyRXJyb3I7CiAgICBpZiAoISgiIiArIHZhbHVlKS5tYXRjaCgvXlxzKltcZCtdKlxzKiQvKSB8fCB2YWx1ZSAhPSBNYXRoLnJvdW5kKHZhbHVlKSkgewogICAgICByZXR1cm4gIk5vdCBhIHdob2xlIG51bWJlciI7CiAgICB9CiAgICByZXR1cm4gbnVsbDsKICB9LAoKICAvKioKICAgKiBAd29ya0luUHJvZ3Jlc3MKICAgKiBAbmdkb2MgdmFsaWRhdG9yCiAgICogQG5hbWUgYW5ndWxhci52YWxpZGF0b3IuZGF0ZQogICAqIEBkZXNjcmlwdGlvbgogICAqIFVzZSBkYXRlIHZhbGlkYXRvciB0byByZXN0cmljdCB0aGUgdXNlciBpbnB1dCB0byBhIHZhbGlkIGRhdGUKICAgKiBpbiBmb3JtYXQgaW4gZm9ybWF0IE1NL0REL1lZWVkuCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gdmFsdWUgdmFsdWUgdG8gdmFsaWRhdGUKICAgKiBAY3NzIG5nLXZhbGlkYXRpb24tZXJyb3IKICAgKgogICAqIEBleGFtcGxlCiAgICA8ZG9jOmV4YW1wbGU+CiAgICAgIDxkb2M6c291cmNlPgogICAgICAgIEVudGVyIHZhbGlkIGRhdGU6CiAgICAgICAgPGlucHV0IG5hbWU9InRleHQiIHZhbHVlPSIxLzEvMjAwOSIgbmc6dmFsaWRhdGU9ImRhdGUiID4KICAgICAgPC9kb2M6c291cmNlPgogICAgICA8ZG9jOnNjZW5hcmlvPgogICAgICAgIGl0KCdzaG91bGQgaW52YWxpZGF0ZSBkYXRlJywgZnVuY3Rpb24oKXsKICAgICAgICAgdmFyIG4xID0gZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgOmlucHV0Jyk7CiAgICAgICAgIGV4cGVjdChuMS5hdHRyKCdjbGFzc05hbWUnKSkubm90KCkudG9NYXRjaCgvbmctdmFsaWRhdGlvbi1lcnJvci8pOwogICAgICAgICBpbnB1dCgndGV4dCcpLmVudGVyKCcxMjMvMTIzLzEyMycpOwogICAgICAgICBleHBlY3QobjEuYXR0cignY2xhc3NOYW1lJykpLnRvTWF0Y2goL25nLXZhbGlkYXRpb24tZXJyb3IvKTsKICAgICAgICB9KTsKICAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICA8L2RvYzpleGFtcGxlPgogICAqCiAgICovCiAgJ2RhdGUnOiBmdW5jdGlvbih2YWx1ZSkgewogICAgdmFyIGZpZWxkcyA9IC9eKFxkXGQ/KVwvKFxkXGQ/KVwvKFxkXGRcZFxkKSQvLmV4ZWModmFsdWUpOwogICAgdmFyIGRhdGUgPSBmaWVsZHMgPyBuZXcgRGF0ZShmaWVsZHNbM10sIGZpZWxkc1sxXS0xLCBmaWVsZHNbMl0pIDogMDsKICAgIHJldHVybiAoZGF0ZSAmJgogICAgICAgICAgICBkYXRlLmdldEZ1bGxZZWFyKCkgPT0gZmllbGRzWzNdICYmCiAgICAgICAgICAgIGRhdGUuZ2V0TW9udGgoKSA9PSBmaWVsZHNbMV0tMSAmJgogICAgICAgICAgICBkYXRlLmdldERhdGUoKSA9PSBmaWVsZHNbMl0pCiAgICAgICAgICAgICAgPyBudWxsCiAgICAgICAgICAgICAgOiAiVmFsdWUgaXMgbm90IGEgZGF0ZS4gKEV4cGVjdGluZyBmb3JtYXQ6IDEyLzMxLzIwMDkpLiI7CiAgfSwKCiAgLyoqCiAgICogQHdvcmtJblByb2dyZXNzCiAgICogQG5nZG9jIHZhbGlkYXRvcgogICAqIEBuYW1lIGFuZ3VsYXIudmFsaWRhdG9yLmVtYWlsCiAgICogQGRlc2NyaXB0aW9uCiAgICogVXNlIGVtYWlsIHZhbGlkYXRvciBpZiB5b3Ugd2lzdCB0byByZXN0cmljdCB0aGUgdXNlciBpbnB1dCB0byBhIHZhbGlkIGVtYWlsLgogICAqCiAgICogQHBhcmFtIHtzdHJpbmd9IHZhbHVlIHZhbHVlIHRvIHZhbGlkYXRlCiAgICogQGNzcyBuZy12YWxpZGF0aW9uLWVycm9yCiAgICoKICAgKiBAZXhhbXBsZQogICAgPGRvYzpleGFtcGxlPgogICAgICA8ZG9jOnNvdXJjZT4KICAgICAgICBFbnRlciB2YWxpZCBlbWFpbDoKICAgICAgICA8aW5wdXQgbmFtZT0idGV4dCIgbmc6dmFsaWRhdGU9ImVtYWlsIiB2YWx1ZT0ibWVAZXhhbXBsZS5jb20iPgogICAgICA8L2RvYzpzb3VyY2U+CiAgICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgICAgaXQoJ3Nob3VsZCBpbnZhbGlkYXRlIGVtYWlsJywgZnVuY3Rpb24oKXsKICAgICAgICAgdmFyIG4xID0gZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgOmlucHV0Jyk7CiAgICAgICAgIGV4cGVjdChuMS5hdHRyKCdjbGFzc05hbWUnKSkubm90KCkudG9NYXRjaCgvbmctdmFsaWRhdGlvbi1lcnJvci8pOwogICAgICAgICBpbnB1dCgndGV4dCcpLmVudGVyKCdhQGIuYycpOwogICAgICAgICBleHBlY3QobjEuYXR0cignY2xhc3NOYW1lJykpLnRvTWF0Y2goL25nLXZhbGlkYXRpb24tZXJyb3IvKTsKICAgICAgICB9KTsKICAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICA8L2RvYzpleGFtcGxlPgogICAqCiAgICovCiAgJ2VtYWlsJzogZnVuY3Rpb24odmFsdWUpIHsKICAgIGlmICh2YWx1ZS5tYXRjaCgvXltBLVphLXowLTkuXyUrLV0rQFtBLVphLXowLTkuLV0rXC5bQS1aYS16XXsyLDR9JC8pKSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfQogICAgcmV0dXJuICJFbWFpbCBuZWVkcyB0byBiZSBpbiB1c2VybmFtZUBob3N0LmNvbSBmb3JtYXQuIjsKICB9LAoKICAvKioKICAgKiBAd29ya0luUHJvZ3Jlc3MKICAgKiBAbmdkb2MgdmFsaWRhdG9yCiAgICogQG5hbWUgYW5ndWxhci52YWxpZGF0b3IucGhvbmUKICAgKiBAZGVzY3JpcHRpb24KICAgKiBVc2UgcGhvbmUgdmFsaWRhdG9yIHRvIHJlc3RyaWN0IHRoZSBpbnB1dCBwaG9uZSBudW1iZXJzLgogICAqCiAgICogQHBhcmFtIHtzdHJpbmd9IHZhbHVlIHZhbHVlIHRvIHZhbGlkYXRlCiAgICogQGNzcyBuZy12YWxpZGF0aW9uLWVycm9yCiAgICoKICAgKiBAZXhhbXBsZQogICAgPGRvYzpleGFtcGxlPgogICAgICA8ZG9jOnNvdXJjZT4KICAgICAgICBFbnRlciB2YWxpZCBwaG9uZSBudW1iZXI6CiAgICAgICAgPGlucHV0IG5hbWU9InRleHQiIHZhbHVlPSIxKDIzNCk1NjctODkwMSIgbmc6dmFsaWRhdGU9InBob25lIiA+CiAgICAgIDwvZG9jOnNvdXJjZT4KICAgICAgPGRvYzpzY2VuYXJpbz4KICAgICAgICBpdCgnc2hvdWxkIGludmFsaWRhdGUgcGhvbmUnLCBmdW5jdGlvbigpewogICAgICAgICB2YXIgbjEgPSBlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSA6aW5wdXQnKTsKICAgICAgICAgZXhwZWN0KG4xLmF0dHIoJ2NsYXNzTmFtZScpKS5ub3QoKS50b01hdGNoKC9uZy12YWxpZGF0aW9uLWVycm9yLyk7CiAgICAgICAgIGlucHV0KCd0ZXh0JykuZW50ZXIoJysxMjM0NTY3OCcpOwogICAgICAgICBleHBlY3QobjEuYXR0cignY2xhc3NOYW1lJykpLnRvTWF0Y2goL25nLXZhbGlkYXRpb24tZXJyb3IvKTsKICAgICAgICB9KTsKICAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICA8L2RvYzpleGFtcGxlPgogICAqCiAgICovCiAgJ3Bob25lJzogZnVuY3Rpb24odmFsdWUpIHsKICAgIGlmICh2YWx1ZS5tYXRjaCgvXjFcKFxkXGRcZFwpXGRcZFxkLVxkXGRcZFxkJC8pKSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfQogICAgaWYgKHZhbHVlLm1hdGNoKC9eXCtcZHsyLDN9IChcKFxkezEsNX1cKSk/W1xkIF0rXGQkLykpIHsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CiAgICByZXR1cm4gIlBob25lIG51bWJlciBuZWVkcyB0byBiZSBpbiAxKDk4Nyk2NTQtMzIxMCBmb3JtYXQgaW4gTm9ydGggQW1lcmljYSAiICsKICAgICAgICAgICAib3IgKzk5OSAoMTIzKSA0NTY3OCA5MDYgaW50ZXJuYXRpb25hbGx5LiI7CiAgfSwKCiAgLyoqCiAgICogQHdvcmtJblByb2dyZXNzCiAgICogQG5nZG9jIHZhbGlkYXRvcgogICAqIEBuYW1lIGFuZ3VsYXIudmFsaWRhdG9yLnVybAogICAqIEBkZXNjcmlwdGlvbgogICAqIFVzZSBwaG9uZSB2YWxpZGF0b3IgdG8gcmVzdHJpY3QgdGhlIGlucHV0IFVSTHMuCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gdmFsdWUgdmFsdWUgdG8gdmFsaWRhdGUKICAgKiBAY3NzIG5nLXZhbGlkYXRpb24tZXJyb3IKICAgKgogICAqIEBleGFtcGxlCiAgICA8ZG9jOmV4YW1wbGU+CiAgICAgIDxkb2M6c291cmNlPgogICAgICAgIEVudGVyIHZhbGlkIFVSTDoKICAgICAgICA8aW5wdXQgbmFtZT0idGV4dCIgdmFsdWU9Imh0dHA6Ly9leGFtcGxlLmNvbS9hYmMuaHRtbCIgc2l6ZT0iNDAiIG5nOnZhbGlkYXRlPSJ1cmwiID4KICAgICAgPC9kb2M6c291cmNlPgogICAgICA8ZG9jOnNjZW5hcmlvPgogICAgICAgIGl0KCdzaG91bGQgaW52YWxpZGF0ZSB1cmwnLCBmdW5jdGlvbigpewogICAgICAgICB2YXIgbjEgPSBlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSA6aW5wdXQnKTsKICAgICAgICAgZXhwZWN0KG4xLmF0dHIoJ2NsYXNzTmFtZScpKS5ub3QoKS50b01hdGNoKC9uZy12YWxpZGF0aW9uLWVycm9yLyk7CiAgICAgICAgIGlucHV0KCd0ZXh0JykuZW50ZXIoJ2FiYzovL3NlcnZlci9wYXRoJyk7CiAgICAgICAgIGV4cGVjdChuMS5hdHRyKCdjbGFzc05hbWUnKSkudG9NYXRjaCgvbmctdmFsaWRhdGlvbi1lcnJvci8pOwogICAgICAgIH0pOwogICAgICA8L2RvYzpzY2VuYXJpbz4KICAgIDwvZG9jOmV4YW1wbGU+CiAgICoKICAgKi8KICAndXJsJzogZnVuY3Rpb24odmFsdWUpIHsKICAgIGlmICh2YWx1ZS5tYXRjaCgvXihmdHB8aHR0cHxodHRwcyk6XC9cLyhcdys6ezAsMX1cdypAKT8oXFMrKSg6WzAtOV0rKT8oXC98XC8oW1x3IyE6Lj8rPSYlQCFcLVwvXSkpPyQvKSkgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KICAgIHJldHVybiAiVVJMIG5lZWRzIHRvIGJlIGluIGh0dHA6Ly9zZXJ2ZXJbOnBvcnRdL3BhdGggZm9ybWF0LiI7CiAgfSwKCiAgLyoqCiAgICogQHdvcmtJblByb2dyZXNzCiAgICogQG5nZG9jIHZhbGlkYXRvcgogICAqIEBuYW1lIGFuZ3VsYXIudmFsaWRhdG9yLmpzb24KICAgKiBAZGVzY3JpcHRpb24KICAgKiBVc2UganNvbiB2YWxpZGF0b3IgaWYgeW91IHdpc2ggdG8gcmVzdHJpY3QgdGhlIHVzZXIgaW5wdXQgdG8gYSB2YWxpZCBKU09OLgogICAqCiAgICogQHBhcmFtIHtzdHJpbmd9IHZhbHVlIHZhbHVlIHRvIHZhbGlkYXRlCiAgICogQGNzcyBuZy12YWxpZGF0aW9uLWVycm9yCiAgICoKICAgKiBAZXhhbXBsZQogICAgPGRvYzpleGFtcGxlPgogICAgICA8ZG9jOnNvdXJjZT4KICAgICAgICA8dGV4dGFyZWEgbmFtZT0ianNvbiIgY29scz0iNjAiIHJvd3M9IjUiIG5nOnZhbGlkYXRlPSJqc29uIj4KICAgICAgICB7bmFtZTonYWJjJ30KICAgICAgICA8L3RleHRhcmVhPgogICAgICA8L2RvYzpzb3VyY2U+CiAgICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgICAgaXQoJ3Nob3VsZCBpbnZhbGlkYXRlIGpzb24nLCBmdW5jdGlvbigpewogICAgICAgICB2YXIgbjEgPSBlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSA6aW5wdXQnKTsKICAgICAgICAgZXhwZWN0KG4xLmF0dHIoJ2NsYXNzTmFtZScpKS5ub3QoKS50b01hdGNoKC9uZy12YWxpZGF0aW9uLWVycm9yLyk7CiAgICAgICAgIGlucHV0KCdqc29uJykuZW50ZXIoJ3tuYW1lfScpOwogICAgICAgICBleHBlY3QobjEuYXR0cignY2xhc3NOYW1lJykpLnRvTWF0Y2goL25nLXZhbGlkYXRpb24tZXJyb3IvKTsKICAgICAgICB9KTsKICAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICA8L2RvYzpleGFtcGxlPgogICAqCiAgICovCiAgJ2pzb24nOiBmdW5jdGlvbih2YWx1ZSkgewogICAgdHJ5IHsKICAgICAgZnJvbUpzb24odmFsdWUpOwogICAgICByZXR1cm4gbnVsbDsKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgcmV0dXJuIGUudG9TdHJpbmcoKTsKICAgIH0KICB9LAoKICAvKioKICAgKiBAd29ya0luUHJvZ3Jlc3MKICAgKiBAbmdkb2MgdmFsaWRhdG9yCiAgICogQG5hbWUgYW5ndWxhci52YWxpZGF0b3IuYXN5bmNocm9ub3VzCiAgICogQGRlc2NyaXB0aW9uCiAgICogVXNlIGFzeW5jaHJvbm91cyB2YWxpZGF0b3IgaWYgdGhlIHZhbGlkYXRpb24gY2FuIG5vdCBiZSBjb21wdXRlZAogICAqIGltbWVkaWF0ZWx5LCBidXQgaXMgcHJvdmlkZWQgdGhyb3VnaCBhIGNhbGxiYWNrLiBUaGUgd2lkZ2V0CiAgICogYXV0b21hdGljYWxseSBzaG93cyBhIHNwaW5uaW5nIGluZGljYXRvciB3aGlsZSB0aGUgdmFsaWRpdHkgb2YKICAgKiB0aGUgd2lkZ2V0IGlzIGNvbXB1dGVkLiBUaGlzIHZhbGlkYXRvciBjYWNoZXMgdGhlIHJlc3VsdC4KICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfSB2YWx1ZSB2YWx1ZSB0byB2YWxpZGF0ZQogICAqIEBwYXJhbSB7ZnVuY3Rpb24oaW5wdXRUb1ZhbGlkYXRlLHZhbGlkYXRpb25Eb25lKX0gdmFsaWRhdGUgZnVuY3Rpb24gdG8gY2FsbCB0byB2YWxpZGF0ZSB0aGUgc3RhdGUKICAgKiAgICAgICAgIG9mIHRoZSBpbnB1dC4KICAgKiBAcGFyYW0ge2Z1bmN0aW9uKGRhdGEpPX0gW3VwZGF0ZT1ub29wXSBmdW5jdGlvbiB0byBjYWxsIHdoZW4gc3RhdGUgb2YgdGhlCiAgICogICAgdmFsaWRhdG9yIGNoYW5nZXMKICAgKgogICAqIEBwYXJhbURlc2NyaXB0aW9uCiAgICogVGhlIGB2YWxpZGF0ZWAgZnVuY3Rpb24gKHNwZWNpZmllZCBieSB5b3UpIGlzIGNhbGxlZCBhcwogICAqIGB2YWxpZGF0ZShpbnB1dFRvVmFsaWRhdGUsIHZhbGlkYXRpb25Eb25lKWA6CiAgICoKICAgKiAgICAqIGBpbnB1dFRvVmFsaWRhdGVgOiB2YWx1ZSBvZiB0aGUgaW5wdXQgYm94LgogICAqICAgICogYHZhbGlkYXRpb25Eb25lYDogYGZ1bmN0aW9uKGVycm9yLCBkYXRhKXsuLi59YAogICAqICAgICAgICogYGVycm9yYDogZXJyb3IgdGV4dCB0byBkaXNwbGF5IGlmIHZhbGlkYXRpb24gZmFpbHMKICAgKiAgICAgICAqIGBkYXRhYDogZGF0YSBvYmplY3QgdG8gcGFzcyB0byB1cGRhdGUgZnVuY3Rpb24KICAgKgogICAqIFRoZSBgdXBkYXRlYCBmdW5jdGlvbiBpcyBvcHRpb25hbGx5IHNwZWNpZmllZCBieSB5b3UgYW5kIGlzCiAgICogY2FsbGVkIGJ5IDxhbmd1bGFyLz4gb24gaW5wdXQgY2hhbmdlLiBTaW5jZSB0aGUKICAgKiBhc3luY2hyb25vdXMgdmFsaWRhdG9yIGNhY2hlcyB0aGUgcmVzdWx0cywgdGhlIHVwZGF0ZQogICAqIGZ1bmN0aW9uIGNhbiBiZSBjYWxsZWQgd2l0aG91dCBhIGNhbGwgdG8gYHZhbGlkYXRlYAogICAqIGZ1bmN0aW9uLiBUaGUgZnVuY3Rpb24gaXMgY2FsbGVkIGFzIGB1cGRhdGUoZGF0YSlgOgogICAqCiAgICogICAgKiBgZGF0YWA6IGRhdGEgb2JqZWN0IGFzIHBhc3NlZCBmcm9tIHZhbGlkYXRlIGZ1bmN0aW9uCiAgICoKICAgKiBAY3NzIG5nLWlucHV0LWluZGljYXRvci13YWl0LCBuZy12YWxpZGF0aW9uLWVycm9yCiAgICoKICAgKiBAZXhhbXBsZQogICAgPGRvYzpleGFtcGxlPgogICAgICA8ZG9jOnNvdXJjZT4KICAgICAgICA8c2NyaXB0PgogICAgICAgIGZ1bmN0aW9uIE15Q250bCgpewogICAgICAgICB0aGlzLm15VmFsaWRhdG9yID0gZnVuY3Rpb24gKGlucHV0VG9WYWxpZGF0ZSwgdmFsaWRhdGlvbkRvbmUpIHsKICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICB2YWxpZGF0aW9uRG9uZShpbnB1dFRvVmFsaWRhdGUubGVuZ3RoICUgMik7CiAgICAgICAgICAgfSwgNTAwKTsKICAgICAgICAgfQogICAgICAgIH0KICAgICAgICA8L3NjcmlwdD4KICAgICAgICBUaGlzIGlucHV0IGlzIHZhbGlkYXRlZCBhc3luY2hyb25vdXNseToKICAgICAgICA8ZGl2IG5nOmNvbnRyb2xsZXI9Ik15Q250bCI+CiAgICAgICAgICA8aW5wdXQgbmFtZT0idGV4dCIgbmc6dmFsaWRhdGU9ImFzeW5jaHJvbm91czpteVZhbGlkYXRvciI+CiAgICAgICAgPC9kaXY+CiAgICAgIDwvZG9jOnNvdXJjZT4KICAgICAgPGRvYzpzY2VuYXJpbz4KICAgICAgICBpdCgnc2hvdWxkIGNoYW5nZSBjb2xvciBpbiBkZWxheWVkIHdheScsIGZ1bmN0aW9uKCl7CiAgICAgICAgIHZhciB0ZXh0Qm94ID0gZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgOmlucHV0Jyk7CiAgICAgICAgIGV4cGVjdCh0ZXh0Qm94LmF0dHIoJ2NsYXNzTmFtZScpKS5ub3QoKS50b01hdGNoKC9uZy1pbnB1dC1pbmRpY2F0b3Itd2FpdC8pOwogICAgICAgICBleHBlY3QodGV4dEJveC5hdHRyKCdjbGFzc05hbWUnKSkubm90KCkudG9NYXRjaCgvbmctdmFsaWRhdGlvbi1lcnJvci8pOwogICAgICAgICBpbnB1dCgndGV4dCcpLmVudGVyKCdYJyk7CiAgICAgICAgIGV4cGVjdCh0ZXh0Qm94LmF0dHIoJ2NsYXNzTmFtZScpKS50b01hdGNoKC9uZy1pbnB1dC1pbmRpY2F0b3Itd2FpdC8pOwogICAgICAgICBzbGVlcCguNik7CiAgICAgICAgIGV4cGVjdCh0ZXh0Qm94LmF0dHIoJ2NsYXNzTmFtZScpKS5ub3QoKS50b01hdGNoKC9uZy1pbnB1dC1pbmRpY2F0b3Itd2FpdC8pOwogICAgICAgICBleHBlY3QodGV4dEJveC5hdHRyKCdjbGFzc05hbWUnKSkudG9NYXRjaCgvbmctdmFsaWRhdGlvbi1lcnJvci8pOwogICAgICAgIH0pOwogICAgICA8L2RvYzpzY2VuYXJpbz4KICAgIDwvZG9jOmV4YW1wbGU+CiAgICoKICAgKi8KICAvKgogICAqIGNhY2hlIGlzIGF0dGFjaGVkIHRvIHRoZSBlbGVtZW50CiAgICogY2FjaGU6IHsKICAgKiAgIGlucHV0cyA6IHsKICAgKiAgICAgJ3VzZXIgaW5wdXQnOiB7CiAgICogICAgICAgIHJlc3BvbnNlOiBzZXJ2ZXIgcmVzcG9uc2UsCiAgICogICAgICAgIGVycm9yOiB2YWxpZGF0aW9uIGVycm9yCiAgICogICAgIH0sCiAgICogICAgIGN1cnJlbnQ6ICdjdXJyZW50IGlucHV0JwogICAqICAgfQogICAqIH0KICAgKgogICAqLwogICdhc3luY2hyb25vdXMnOiBmdW5jdGlvbihpbnB1dCwgYXN5bmNocm9ub3VzRm4sIHVwZGF0ZUZuKSB7CiAgICBpZiAoIWlucHV0KSByZXR1cm47CiAgICB2YXIgc2NvcGUgPSB0aGlzOwogICAgdmFyIGVsZW1lbnQgPSBzY29wZS4kZWxlbWVudDsKICAgIHZhciBjYWNoZSA9IGVsZW1lbnQuZGF0YSgnJGFzeW5jVmFsaWRhdG9yJyk7CiAgICBpZiAoIWNhY2hlKSB7CiAgICAgIGVsZW1lbnQuZGF0YSgnJGFzeW5jVmFsaWRhdG9yJywgY2FjaGUgPSB7aW5wdXRzOnt9fSk7CiAgICB9CgogICAgY2FjaGUuY3VycmVudCA9IGlucHV0OwoKICAgIHZhciBpbnB1dFN0YXRlID0gY2FjaGUuaW5wdXRzW2lucHV0XSwKICAgICAgICAkaW52YWxpZFdpZGdldHMgPSBzY29wZS4kc2VydmljZSgnJGludmFsaWRXaWRnZXRzJyk7CgogICAgaWYgKCFpbnB1dFN0YXRlKSB7CiAgICAgIGNhY2hlLmlucHV0c1tpbnB1dF0gPSBpbnB1dFN0YXRlID0geyBpbkZsaWdodDogdHJ1ZSB9OwogICAgICAkaW52YWxpZFdpZGdldHMubWFya0ludmFsaWQoc2NvcGUuJGVsZW1lbnQpOwogICAgICBlbGVtZW50LmFkZENsYXNzKCduZy1pbnB1dC1pbmRpY2F0b3Itd2FpdCcpOwogICAgICBhc3luY2hyb25vdXNGbihpbnB1dCwgZnVuY3Rpb24oZXJyb3IsIGRhdGEpIHsKICAgICAgICBpbnB1dFN0YXRlLnJlc3BvbnNlID0gZGF0YTsKICAgICAgICBpbnB1dFN0YXRlLmVycm9yID0gZXJyb3I7CiAgICAgICAgaW5wdXRTdGF0ZS5pbkZsaWdodCA9IGZhbHNlOwogICAgICAgIGlmIChjYWNoZS5jdXJyZW50ID09IGlucHV0KSB7CiAgICAgICAgICBlbGVtZW50LnJlbW92ZUNsYXNzKCduZy1pbnB1dC1pbmRpY2F0b3Itd2FpdCcpOwogICAgICAgICAgJGludmFsaWRXaWRnZXRzLm1hcmtWYWxpZChlbGVtZW50KTsKICAgICAgICB9CiAgICAgICAgZWxlbWVudC5kYXRhKCQkdmFsaWRhdGUpKCk7CiAgICAgICAgc2NvcGUuJHNlcnZpY2UoJyR1cGRhdGVWaWV3JykoKTsKICAgICAgfSk7CiAgICB9IGVsc2UgaWYgKGlucHV0U3RhdGUuaW5GbGlnaHQpIHsKICAgICAgLy8gcmVxdWVzdCBpbiBmbGlnaHQsIG1hcmsgd2lkZ2V0IGludmFsaWQsIGJ1dCBkb24ndCBzaG93IGl0IHRvIHVzZXIKICAgICAgJGludmFsaWRXaWRnZXRzLm1hcmtJbnZhbGlkKHNjb3BlLiRlbGVtZW50KTsKICAgIH0gZWxzZSB7CiAgICAgICh1cGRhdGVGbnx8bm9vcCkoaW5wdXRTdGF0ZS5yZXNwb25zZSk7CiAgICB9CiAgICByZXR1cm4gaW5wdXRTdGF0ZS5lcnJvcjsKICB9Cgp9KTsKJ3VzZSBzdHJpY3QnOwoKLyoqCiAqIEB3b3JrSW5Qcm9ncmVzcwogKiBAbmdkb2Mgc2VydmljZQogKiBAbmFtZSBhbmd1bGFyLnNlcnZpY2UuJGNvb2tpZVN0b3JlCiAqIEByZXF1aXJlcyAkY29va2llcwogKgogKiBAZGVzY3JpcHRpb24KICogUHJvdmlkZXMgYSBrZXktdmFsdWUgKHN0cmluZy1vYmplY3QpIHN0b3JhZ2UsIHRoYXQgaXMgYmFja2VkIGJ5IHNlc3Npb24gY29va2llcy4KICogT2JqZWN0cyBwdXQgb3IgcmV0cmlldmVkIGZyb20gdGhpcyBzdG9yYWdlIGFyZSBhdXRvbWF0aWNhbGx5IHNlcmlhbGl6ZWQgb3IKICogZGVzZXJpYWxpemVkIGJ5IGFuZ3VsYXIncyB0b0pzb24vZnJvbUpzb24uCiAqIEBleGFtcGxlCiAqLwphbmd1bGFyU2VydmljZUluamVjdCgnJGNvb2tpZVN0b3JlJywgZnVuY3Rpb24oJHN0b3JlKSB7CgogIHJldHVybiB7CiAgICAvKioKICAgICAqIEB3b3JrSW5Qcm9ncmVzcwogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgYW5ndWxhci5zZXJ2aWNlLiRjb29raWVTdG9yZSNnZXQKICAgICAqIEBtZXRob2RPZiBhbmd1bGFyLnNlcnZpY2UuJGNvb2tpZVN0b3JlCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBSZXR1cm5zIHRoZSB2YWx1ZSBvZiBnaXZlbiBjb29raWUga2V5CiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSBJZCB0byB1c2UgZm9yIGxvb2t1cC4KICAgICAqIEByZXR1cm5zIHtPYmplY3R9IERlc2VyaWFsaXplZCBjb29raWUgdmFsdWUuCiAgICAgKi8KICAgIGdldDogZnVuY3Rpb24oa2V5KSB7CiAgICAgIHJldHVybiBmcm9tSnNvbigkc3RvcmVba2V5XSk7CiAgICB9LAoKICAgIC8qKgogICAgICogQHdvcmtJblByb2dyZXNzCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSBhbmd1bGFyLnNlcnZpY2UuJGNvb2tpZVN0b3JlI3B1dAogICAgICogQG1ldGhvZE9mIGFuZ3VsYXIuc2VydmljZS4kY29va2llU3RvcmUKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFNldHMgYSB2YWx1ZSBmb3IgZ2l2ZW4gY29va2llIGtleQogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgSWQgZm9yIHRoZSBgdmFsdWVgLgogICAgICogQHBhcmFtIHtPYmplY3R9IHZhbHVlIFZhbHVlIHRvIGJlIHN0b3JlZC4KICAgICAqLwogICAgcHV0OiBmdW5jdGlvbihrZXksIHZhbHVlKSB7CiAgICAgICRzdG9yZVtrZXldID0gdG9Kc29uKHZhbHVlKTsKICAgIH0sCgogICAgLyoqCiAgICAgKiBAd29ya0luUHJvZ3Jlc3MKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lIGFuZ3VsYXIuc2VydmljZS4kY29va2llU3RvcmUjcmVtb3ZlCiAgICAgKiBAbWV0aG9kT2YgYW5ndWxhci5zZXJ2aWNlLiRjb29raWVTdG9yZQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogUmVtb3ZlIGdpdmVuIGNvb2tpZQogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgSWQgb2YgdGhlIGtleS12YWx1ZSBwYWlyIHRvIGRlbGV0ZS4KICAgICAqLwogICAgcmVtb3ZlOiBmdW5jdGlvbihrZXkpIHsKICAgICAgZGVsZXRlICRzdG9yZVtrZXldOwogICAgfQogIH07Cgp9LCBbJyRjb29raWVzJ10pOwondXNlIHN0cmljdCc7CgovKioKICogQHdvcmtJblByb2dyZXNzCiAqIEBuZ2RvYyBzZXJ2aWNlCiAqIEBuYW1lIGFuZ3VsYXIuc2VydmljZS4kY29va2llcwogKiBAcmVxdWlyZXMgJGJyb3dzZXIKICoKICogQGRlc2NyaXB0aW9uCiAqIFByb3ZpZGVzIHJlYWQvd3JpdGUgYWNjZXNzIHRvIGJyb3dzZXIncyBjb29raWVzLgogKgogKiBPbmx5IGEgc2ltcGxlIE9iamVjdCBpcyBleHBvc2VkIGFuZCBieSBhZGRpbmcgb3IgcmVtb3ZpbmcgcHJvcGVydGllcyB0by9mcm9tCiAqIHRoaXMgb2JqZWN0LCBuZXcgY29va2llcyBhcmUgY3JlYXRlZC9kZWxldGVkIGF0IHRoZSBlbmQgb2YgY3VycmVudCAkZXZhbC4KICoKICogQGV4YW1wbGUKICovCmFuZ3VsYXJTZXJ2aWNlSW5qZWN0KCckY29va2llcycsIGZ1bmN0aW9uKCRicm93c2VyKSB7CiAgdmFyIHJvb3RTY29wZSA9IHRoaXMsCiAgICAgIGNvb2tpZXMgPSB7fSwKICAgICAgbGFzdENvb2tpZXMgPSB7fSwKICAgICAgbGFzdEJyb3dzZXJDb29raWVzLAogICAgICBydW5FdmFsID0gZmFsc2U7CgogIC8vY3JlYXRlcyBhIHBvbGxlciBmbiB0aGF0IGNvcGllcyBhbGwgY29va2llcyBmcm9tIHRoZSAkYnJvd3NlciB0byBzZXJ2aWNlICYgaW5pdHMgdGhlIHNlcnZpY2UKICAkYnJvd3Nlci5hZGRQb2xsRm4oZnVuY3Rpb24oKSB7CiAgICB2YXIgY3VycmVudENvb2tpZXMgPSAkYnJvd3Nlci5jb29raWVzKCk7CiAgICBpZiAobGFzdEJyb3dzZXJDb29raWVzICE9IGN1cnJlbnRDb29raWVzKSB7IC8vcmVsaWVzIG9uIGJyb3dzZXIuY29va2llcygpIGltcGwKICAgICAgbGFzdEJyb3dzZXJDb29raWVzID0gY3VycmVudENvb2tpZXM7CiAgICAgIGNvcHkoY3VycmVudENvb2tpZXMsIGxhc3RDb29raWVzKTsKICAgICAgY29weShjdXJyZW50Q29va2llcywgY29va2llcyk7CiAgICAgIGlmIChydW5FdmFsKSByb290U2NvcGUuJGV2YWwoKTsKICAgIH0KICB9KSgpOwoKICBydW5FdmFsID0gdHJ1ZTsKCiAgLy9hdCB0aGUgZW5kIG9mIGVhY2ggZXZhbCwgcHVzaCBjb29raWVzCiAgLy9UT0RPOiB0aGlzIHNob3VsZCBoYXBwZW4gYmVmb3JlIHRoZSAiZGVsYXllZCIgd2F0Y2hlcyBmaXJlLCBiZWNhdXNlIGlmIHNvbWUgY29va2llcyBhcmUgbm90CiAgLy8gICAgICBzdHJpbmdzIG9yIGJyb3dzZXIgcmVmdXNlcyB0byBzdG9yZSBzb21lIGNvb2tpZXMsIHdlIHVwZGF0ZSB0aGUgbW9kZWwgaW4gdGhlIHB1c2ggZm4uCiAgdGhpcy4kb25FdmFsKFBSSU9SSVRZX0xBU1QsIHB1c2gpOwoKICByZXR1cm4gY29va2llczsKCgogIC8qKgogICAqIFB1c2hlcyBhbGwgdGhlIGNvb2tpZXMgZnJvbSB0aGUgc2VydmljZSB0byB0aGUgYnJvd3NlciBhbmQgdmVyaWZpZXMgaWYgYWxsIGNvb2tpZXMgd2VyZSBzdG9yZWQuCiAgICovCiAgZnVuY3Rpb24gcHVzaCgpewogICAgdmFyIG5hbWUsCiAgICAgICAgdmFsdWUsCiAgICAgICAgYnJvd3NlckNvb2tpZXMsCiAgICAgICAgdXBkYXRlZDsKCiAgICAvL2RlbGV0ZSBhbnkgY29va2llcyBkZWxldGVkIGluICRjb29raWVzCiAgICBmb3IgKG5hbWUgaW4gbGFzdENvb2tpZXMpIHsKICAgICAgaWYgKGlzVW5kZWZpbmVkKGNvb2tpZXNbbmFtZV0pKSB7CiAgICAgICAgJGJyb3dzZXIuY29va2llcyhuYW1lLCB1bmRlZmluZWQpOwogICAgICB9CiAgICB9CgogICAgLy91cGRhdGUgYWxsIGNvb2tpZXMgdXBkYXRlZCBpbiAkY29va2llcwogICAgZm9yKG5hbWUgaW4gY29va2llcykgewogICAgICB2YWx1ZSA9IGNvb2tpZXNbbmFtZV07CiAgICAgIGlmICghaXNTdHJpbmcodmFsdWUpKSB7CiAgICAgICAgaWYgKGlzRGVmaW5lZChsYXN0Q29va2llc1tuYW1lXSkpIHsKICAgICAgICAgIGNvb2tpZXNbbmFtZV0gPSBsYXN0Q29va2llc1tuYW1lXTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZGVsZXRlIGNvb2tpZXNbbmFtZV07CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKHZhbHVlICE9PSBsYXN0Q29va2llc1tuYW1lXSkgewogICAgICAgICRicm93c2VyLmNvb2tpZXMobmFtZSwgdmFsdWUpOwogICAgICAgIHVwZGF0ZWQgPSB0cnVlOwogICAgICB9CiAgICB9CgogICAgLy92ZXJpZnkgd2hhdCB3YXMgYWN0dWFsbHkgc3RvcmVkCiAgICBpZiAodXBkYXRlZCl7CiAgICAgIHVwZGF0ZWQgPSBmYWxzZTsKICAgICAgYnJvd3NlckNvb2tpZXMgPSAkYnJvd3Nlci5jb29raWVzKCk7CgogICAgICBmb3IgKG5hbWUgaW4gY29va2llcykgewogICAgICAgIGlmIChjb29raWVzW25hbWVdICE9PSBicm93c2VyQ29va2llc1tuYW1lXSkgewogICAgICAgICAgLy9kZWxldGUgb3IgcmVzZXQgYWxsIGNvb2tpZXMgdGhhdCB0aGUgYnJvd3NlciBkcm9wcGVkIGZyb20gJGNvb2tpZXMKICAgICAgICAgIGlmIChpc1VuZGVmaW5lZChicm93c2VyQ29va2llc1tuYW1lXSkpIHsKICAgICAgICAgICAgZGVsZXRlIGNvb2tpZXNbbmFtZV07CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjb29raWVzW25hbWVdID0gYnJvd3NlckNvb2tpZXNbbmFtZV07CiAgICAgICAgICB9CiAgICAgICAgICB1cGRhdGVkID0gdHJ1ZTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9Cn0sIFsnJGJyb3dzZXInXSk7Cid1c2Ugc3RyaWN0JzsKCi8qKgogKiBAd29ya0luUHJvZ3Jlc3MKICogQG5nZG9jIHNlcnZpY2UKICogQG5hbWUgYW5ndWxhci5zZXJ2aWNlLiRkZWZlcgogKiBAcmVxdWlyZXMgJGJyb3dzZXIKICogQHJlcXVpcmVzICRleGNlcHRpb25IYW5kbGVyCiAqIEByZXF1aXJlcyAkdXBkYXRlVmlldwogKgogKiBAZGVzY3JpcHRpb24KICogRGVsZWdhdGVzIHRvIHtAbGluayBhbmd1bGFyLnNlcnZpY2UuJGJyb3dzZXIgJGJyb3dzZXIuZGVmZXJ9LCBidXQgd3JhcHMgdGhlIGBmbmAgZnVuY3Rpb24KICogaW50byBhIHRyeS9jYXRjaCBibG9jayBhbmQgZGVsZWdhdGVzIGFueSBleGNlcHRpb25zIHRvCiAqIHtAbGluayBhbmd1bGFyLnNlcnZpY2UuJGV4Y2VwdGlvbkhhbmRsZXIgJGV4Y2VwdGlvbkhhbmRsZXJ9IHNlcnZpY2UuCiAqCiAqIEluIHRlc3RzIHlvdSBjYW4gdXNlIGAkYnJvd3Nlci5kZWZlci5mbHVzaCgpYCB0byBmbHVzaCB0aGUgcXVldWUgb2YgZGVmZXJyZWQgZnVuY3Rpb25zLgogKgogKiBAcGFyYW0ge2Z1bmN0aW9uKCl9IGZuIEEgZnVuY3Rpb24sIHdobydzIGV4ZWN1dGlvbiBzaG91bGQgYmUgZGVmZXJyZWQuCiAqIEBwYXJhbSB7bnVtYmVyPX0gW2RlbGF5PTBdIG9mIG1pbGxpc2Vjb25kcyB0byBkZWZlciB0aGUgZnVuY3Rpb24gZXhlY3V0aW9uLgogKi8KYW5ndWxhclNlcnZpY2VJbmplY3QoJyRkZWZlcicsIGZ1bmN0aW9uKCRicm93c2VyLCAkZXhjZXB0aW9uSGFuZGxlciwgJHVwZGF0ZVZpZXcpIHsKICByZXR1cm4gZnVuY3Rpb24oZm4sIGRlbGF5KSB7CiAgICAkYnJvd3Nlci5kZWZlcihmdW5jdGlvbigpIHsKICAgICAgdHJ5IHsKICAgICAgICBmbigpOwogICAgICB9IGNhdGNoKGUpIHsKICAgICAgICAkZXhjZXB0aW9uSGFuZGxlcihlKTsKICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAkdXBkYXRlVmlldygpOwogICAgICB9CiAgICB9LCBkZWxheSk7CiAgfTsKfSwgWyckYnJvd3NlcicsICckZXhjZXB0aW9uSGFuZGxlcicsICckdXBkYXRlVmlldyddKTsKJ3VzZSBzdHJpY3QnOwoKLyoqCiAqIEB3b3JrSW5Qcm9ncmVzcwogKiBAbmdkb2Mgc2VydmljZQogKiBAbmFtZSBhbmd1bGFyLnNlcnZpY2UuJGRvY3VtZW50CiAqIEByZXF1aXJlcyAkd2luZG93CiAqCiAqIEBkZXNjcmlwdGlvbgogKiBBIHtAbGluayBhbmd1bGFyLmVsZW1lbnQgalF1ZXJ5IChsaXRlKX0td3JhcHBlZCByZWZlcmVuY2UgdG8gdGhlIGJyb3dzZXIncyBgd2luZG93LmRvY3VtZW50YAogKiBlbGVtZW50LgogKi8KYW5ndWxhclNlcnZpY2VJbmplY3QoIiRkb2N1bWVudCIsIGZ1bmN0aW9uKHdpbmRvdyl7CiAgcmV0dXJuIGpxTGl0ZSh3aW5kb3cuZG9jdW1lbnQpOwp9LCBbJyR3aW5kb3cnXSk7Cid1c2Ugc3RyaWN0JzsKCi8qKgogKiBAd29ya0luUHJvZ3Jlc3MKICogQG5nZG9jIHNlcnZpY2UKICogQG5hbWUgYW5ndWxhci5zZXJ2aWNlLiRleGNlcHRpb25IYW5kbGVyCiAqIEByZXF1aXJlcyAkbG9nCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBBbnkgdW5jYXVnaHQgZXhjZXB0aW9uIGluIGFuZ3VsYXIgZXhwcmVzc2lvbnMgaXMgZGVsZWdhdGVkIHRvIHRoaXMgc2VydmljZS4KICogVGhlIGRlZmF1bHQgaW1wbGVtZW50YXRpb24gc2ltcGx5IGRlbGVnYXRlcyB0byBgJGxvZy5lcnJvcmAgd2hpY2ggbG9ncyBpdCBpbnRvCiAqIHRoZSBicm93c2VyIGNvbnNvbGUuCiAqCiAqIEluIHVuaXQgdGVzdHMsIGlmIGBhbmd1bGFyLW1vY2tzLmpzYCBpcyBsb2FkZWQsIHRoaXMgc2VydmljZSBpcyBvdmVycmlkZW4gYnkKICoge0BsaW5rIGFuZ3VsYXIubW9jay5zZXJ2aWNlLiRleGNlcHRpb25IYW5kbGVyIG1vY2sgJGV4Y2VwdGlvbkhhbmRsZXJ9CiAqCiAqIEBleGFtcGxlCiAqLwp2YXIgJGV4Y2VwdGlvbkhhbmRsZXJGYWN0b3J5OyAvL3JlZmVyZW5jZSB0byBiZSB1c2VkIG9ubHkgaW4gdGVzdHMKYW5ndWxhclNlcnZpY2VJbmplY3QoJyRleGNlcHRpb25IYW5kbGVyJywgJGV4Y2VwdGlvbkhhbmRsZXJGYWN0b3J5ID0gZnVuY3Rpb24oJGxvZyl7CiAgcmV0dXJuIGZ1bmN0aW9uKGUpIHsKICAgICRsb2cuZXJyb3IoZSk7CiAgfTsKfSwgWyckbG9nJ10pOwondXNlIHN0cmljdCc7CgovKioKICogQHdvcmtJblByb2dyZXNzCiAqIEBuZ2RvYyBzZXJ2aWNlCiAqIEBuYW1lIGFuZ3VsYXIuc2VydmljZS4kaG92ZXIKICogQHJlcXVpcmVzICRicm93c2VyCiAqIEByZXF1aXJlcyAkZG9jdW1lbnQKICoKICogQGRlc2NyaXB0aW9uCiAqCiAqIEBleGFtcGxlCiAqLwphbmd1bGFyU2VydmljZUluamVjdCgiJGhvdmVyIiwgZnVuY3Rpb24oYnJvd3NlciwgZG9jdW1lbnQpIHsKICB2YXIgdG9vbHRpcCwgc2VsZiA9IHRoaXMsIGVycm9yLCB3aWR0aCA9IDMwMCwgYXJyb3dXaWR0aCA9IDEwLCBib2R5ID0ganFMaXRlKGRvY3VtZW50WzBdLmJvZHkpOwogIGJyb3dzZXIuaG92ZXIoZnVuY3Rpb24oZWxlbWVudCwgc2hvdyl7CiAgICBpZiAoc2hvdyAmJiAoZXJyb3IgPSBlbGVtZW50LmF0dHIoTkdfRVhDRVBUSU9OKSB8fCBlbGVtZW50LmF0dHIoTkdfVkFMSURBVElPTl9FUlJPUikpKSB7CiAgICAgIGlmICghdG9vbHRpcCkgewogICAgICAgIHRvb2x0aXAgPSB7CiAgICAgICAgICAgIGNhbGxvdXQ6IGpxTGl0ZSgnPGRpdiBpZD0ibmctY2FsbG91dCI+PC9kaXY+JyksCiAgICAgICAgICAgIGFycm93OiBqcUxpdGUoJzxkaXY+PC9kaXY+JyksCiAgICAgICAgICAgIHRpdGxlOiBqcUxpdGUoJzxkaXYgY2xhc3M9Im5nLXRpdGxlIj48L2Rpdj4nKSwKICAgICAgICAgICAgY29udGVudDoganFMaXRlKCc8ZGl2IGNsYXNzPSJuZy1jb250ZW50Ij48L2Rpdj4nKQogICAgICAgIH07CiAgICAgICAgdG9vbHRpcC5jYWxsb3V0LmFwcGVuZCh0b29sdGlwLmFycm93KTsKICAgICAgICB0b29sdGlwLmNhbGxvdXQuYXBwZW5kKHRvb2x0aXAudGl0bGUpOwogICAgICAgIHRvb2x0aXAuY2FsbG91dC5hcHBlbmQodG9vbHRpcC5jb250ZW50KTsKICAgICAgICBib2R5LmFwcGVuZCh0b29sdGlwLmNhbGxvdXQpOwogICAgICB9CiAgICAgIHZhciBkb2NSZWN0ID0gYm9keVswXS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKSwKICAgICAgICAgIGVsZW1lbnRSZWN0ID0gZWxlbWVudFswXS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKSwKICAgICAgICAgIGxlZnRTcGFjZSA9IGRvY1JlY3QucmlnaHQgLSBlbGVtZW50UmVjdC5yaWdodCAtIGFycm93V2lkdGg7CiAgICAgIHRvb2x0aXAudGl0bGUudGV4dChlbGVtZW50Lmhhc0NsYXNzKCJuZy1leGNlcHRpb24iKSA/ICJFWENFUFRJT046IiA6ICJWYWxpZGF0aW9uIGVycm9yLi4uIik7CiAgICAgIHRvb2x0aXAuY29udGVudC50ZXh0KGVycm9yKTsKICAgICAgaWYgKGxlZnRTcGFjZSA8IHdpZHRoKSB7CiAgICAgICAgdG9vbHRpcC5hcnJvdy5hZGRDbGFzcygnbmctYXJyb3ctcmlnaHQnKTsKICAgICAgICB0b29sdGlwLmFycm93LmNzcyh7bGVmdDogKHdpZHRoICsgMSkrJ3B4J30pOwogICAgICAgIHRvb2x0aXAuY2FsbG91dC5jc3MoewogICAgICAgICAgcG9zaXRpb246ICdmaXhlZCcsCiAgICAgICAgICBsZWZ0OiAoZWxlbWVudFJlY3QubGVmdCAtIGFycm93V2lkdGggLSB3aWR0aCAtIDQpICsgInB4IiwKICAgICAgICAgIHRvcDogKGVsZW1lbnRSZWN0LnRvcCAtIDMpICsgInB4IiwKICAgICAgICAgIHdpZHRoOiB3aWR0aCArICJweCIKICAgICAgICB9KTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0b29sdGlwLmFycm93LmFkZENsYXNzKCduZy1hcnJvdy1sZWZ0Jyk7CiAgICAgICAgdG9vbHRpcC5jYWxsb3V0LmNzcyh7CiAgICAgICAgICBwb3NpdGlvbjogJ2ZpeGVkJywKICAgICAgICAgIGxlZnQ6IChlbGVtZW50UmVjdC5yaWdodCArIGFycm93V2lkdGgpICsgInB4IiwKICAgICAgICAgIHRvcDogKGVsZW1lbnRSZWN0LnRvcCAtIDMpICsgInB4IiwKICAgICAgICAgIHdpZHRoOiB3aWR0aCArICJweCIKICAgICAgICB9KTsKICAgICAgfQogICAgfSBlbHNlIGlmICh0b29sdGlwKSB7CiAgICAgIHRvb2x0aXAuY2FsbG91dC5yZW1vdmUoKTsKICAgICAgdG9vbHRpcCA9IG51bGw7CiAgICB9CiAgfSk7Cn0sIFsnJGJyb3dzZXInLCAnJGRvY3VtZW50J10sIHRydWUpOwondXNlIHN0cmljdCc7CgovKioKICogQHdvcmtJblByb2dyZXNzCiAqIEBuZ2RvYyBzZXJ2aWNlCiAqIEBuYW1lIGFuZ3VsYXIuc2VydmljZS4kaW52YWxpZFdpZGdldHMKICoKICogQGRlc2NyaXB0aW9uCiAqIEtlZXBzIHJlZmVyZW5jZXMgdG8gYWxsIGludmFsaWQgd2lkZ2V0cyBmb3VuZCBkdXJpbmcgdmFsaWRhdGlvbi4KICogQ2FuIGJlIHF1ZXJpZWQgdG8gZmluZCB3aGV0aGVyIHRoZXJlIGFyZSBhbnkgaW52YWxpZCB3aWRnZXRzIGN1cnJlbnRseSBkaXNwbGF5ZWQuCiAqCiAqIEBleGFtcGxlCiAqLwphbmd1bGFyU2VydmljZUluamVjdCgiJGludmFsaWRXaWRnZXRzIiwgZnVuY3Rpb24oKXsKICB2YXIgaW52YWxpZFdpZGdldHMgPSBbXTsKCgogIC8qKiBSZW1vdmUgYW4gZWxlbWVudCBmcm9tIHRoZSBhcnJheSBvZiBpbnZhbGlkIHdpZGdldHMgKi8KICBpbnZhbGlkV2lkZ2V0cy5tYXJrVmFsaWQgPSBmdW5jdGlvbihlbGVtZW50KXsKICAgIHZhciBpbmRleCA9IGluZGV4T2YoaW52YWxpZFdpZGdldHMsIGVsZW1lbnQpOwogICAgaWYgKGluZGV4ICE9IC0xKQogICAgICBpbnZhbGlkV2lkZ2V0cy5zcGxpY2UoaW5kZXgsIDEpOwogIH07CgoKICAvKiogQWRkIGFuIGVsZW1lbnQgdG8gdGhlIGFycmF5IG9mIGludmFsaWQgd2lkZ2V0cyAqLwogIGludmFsaWRXaWRnZXRzLm1hcmtJbnZhbGlkID0gZnVuY3Rpb24oZWxlbWVudCl7CiAgICB2YXIgaW5kZXggPSBpbmRleE9mKGludmFsaWRXaWRnZXRzLCBlbGVtZW50KTsKICAgIGlmIChpbmRleCA9PT0gLTEpCiAgICAgIGludmFsaWRXaWRnZXRzLnB1c2goZWxlbWVudCk7CiAgfTsKCgogIC8qKiBSZXR1cm4gY291bnQgb2YgYWxsIGludmFsaWQgd2lkZ2V0cyB0aGF0IGFyZSBjdXJyZW50bHkgdmlzaWJsZSAqLwogIGludmFsaWRXaWRnZXRzLnZpc2libGUgPSBmdW5jdGlvbigpIHsKICAgIHZhciBjb3VudCA9IDA7CiAgICBmb3JFYWNoKGludmFsaWRXaWRnZXRzLCBmdW5jdGlvbih3aWRnZXQpewogICAgICBjb3VudCA9IGNvdW50ICsgKGlzVmlzaWJsZSh3aWRnZXQpID8gMSA6IDApOwogICAgfSk7CiAgICByZXR1cm4gY291bnQ7CiAgfTsKCgogIC8qIEF0IHRoZSBlbmQgb2YgZWFjaCBldmFsIHJlbW92ZXMgYWxsIGludmFsaWQgd2lkZ2V0cyB0aGF0IGFyZSBub3QgcGFydCBvZiB0aGUgY3VycmVudCBET00uICovCiAgdGhpcy4kb25FdmFsKFBSSU9SSVRZX0xBU1QsIGZ1bmN0aW9uKCkgewogICAgZm9yKHZhciBpID0gMDsgaSA8IGludmFsaWRXaWRnZXRzLmxlbmd0aDspIHsKICAgICAgdmFyIHdpZGdldCA9IGludmFsaWRXaWRnZXRzW2ldOwogICAgICBpZiAoaXNPcnBoYW4od2lkZ2V0WzBdKSkgewogICAgICAgIGludmFsaWRXaWRnZXRzLnNwbGljZShpLCAxKTsKICAgICAgICBpZiAod2lkZ2V0LmRlYWxvYykgd2lkZ2V0LmRlYWxvYygpOwogICAgICB9IGVsc2UgewogICAgICAgIGkrKzsKICAgICAgfQogICAgfQogIH0pOwoKCiAgLyoqCiAgICogVHJhdmVyc2VzIERPTSBlbGVtZW50J3MgKHdpZGdldCdzKSBwYXJlbnRzIGFuZCBjb25zaWRlcnMgdGhlIGVsZW1lbnQgdG8gYmUgYW4gb3JwaGFudCBpZiBvbmUgb2YKICAgKiBpdCdzIHBhcmVudHMgaXNuJ3QgdGhlIGN1cnJlbnQgd2luZG93LmRvY3VtZW50LgogICAqLwogIGZ1bmN0aW9uIGlzT3JwaGFuKHdpZGdldCkgewogICAgaWYgKHdpZGdldCA9PSB3aW5kb3cuZG9jdW1lbnQpIHJldHVybiBmYWxzZTsKICAgIHZhciBwYXJlbnQgPSB3aWRnZXQucGFyZW50Tm9kZTsKICAgIHJldHVybiAhcGFyZW50IHx8IGlzT3JwaGFuKHBhcmVudCk7CiAgfQoKICByZXR1cm4gaW52YWxpZFdpZGdldHM7Cn0pOwondXNlIHN0cmljdCc7Cgp2YXIgVVJMX01BVENIID0gL14oZmlsZXxmdHB8aHR0cHxodHRwcyk6XC9cLyhcdys6ezAsMX1cdypAKT8oW1x3XC4tXSopKDooWzAtOV0rKSk/KFwvW15cPyNdKik/KFw/KFteI10qKSk/KCMoLiopKT8kLywKICAgIEhBU0hfTUFUQ0ggPSAvXihbXlw/XSopPyhcPyhbXlw/XSopKT8kLywKICAgIERFRkFVTFRfUE9SVFMgPSB7J2h0dHAnOiA4MCwgJ2h0dHBzJzogNDQzLCAnZnRwJzoyMX07CgovKioKICogQHdvcmtJblByb2dyZXNzCiAqIEBuZ2RvYyBzZXJ2aWNlCiAqIEBuYW1lIGFuZ3VsYXIuc2VydmljZS4kbG9jYXRpb24KICogQHJlcXVpcmVzICRicm93c2VyCiAqCiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBocmVmIFRoZSBmdWxsIFVSTCBvZiB0aGUgY3VycmVudCBsb2NhdGlvbi4KICogQHByb3BlcnR5IHtzdHJpbmd9IHByb3RvY29sIFRoZSBwcm90b2NvbCBwYXJ0IG9mIHRoZSBVUkwgKGUuZy4gaHR0cCBvciBodHRwcykuCiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBob3N0IFRoZSBob3N0IG5hbWUsIGlwIGFkZHJlc3Mgb3IgRlFETiBvZiB0aGUgY3VycmVudCBsb2NhdGlvbi4KICogQHByb3BlcnR5IHtudW1iZXJ9IHBvcnQgVGhlIHBvcnQgbnVtYmVyIG9mIHRoZSBjdXJyZW50IGxvY2F0aW9uIChlLmcuIDgwLCA0NDMsIDgwODApLgogKiBAcHJvcGVydHkge3N0cmluZ30gcGF0aCBUaGUgcGF0aCBvZiB0aGUgY3VycmVudCBsb2NhdGlvbiAoZS5nLiAvbXlhcHAvaW5ib3gpLgogKiBAcHJvcGVydHkge09iamVjdC48c3RyaW5nfGJvb2xlYW4+fSBzZWFyY2ggTWFwIG9mIHF1ZXJ5IHBhcmFtZXRlcnMgKGUuZy4ge3VzZXI6ImZvbyIsIHBhZ2U6MjN9KS4KICogQHByb3BlcnR5IHtzdHJpbmd9IGhhc2ggVGhlIGZyYWdtZW50IHBhcnQgb2YgdGhlIFVSTCBvZiB0aGUgY3VycmVudCBsb2NhdGlvbiAoZS5nLiAjZm9vKS4KICogQHByb3BlcnR5IHtzdHJpbmd9IGhhc2hQYXRoIFNpbWlsYXIgdG8gYHBhdGhgLCBidXQgbG9jYXRlZCBpbiB0aGUgYGhhc2hgIGZyYWdtZW50CiAqICAgICAoZS5nLiAuLi9mb28jL3NvbWUvcGF0aCAgPT4gL3NvbWUvcGF0aCkuCiAqIEBwcm9wZXJ0eSB7T2JqZWN0LjxzdHJpbmd8Ym9vbGVhbj59IGhhc2hTZWFyY2ggU2ltaWxhciB0byBgc2VhcmNoYCBidXQgbG9jYXRlZCBpbiBgaGFzaGAKICogICAgIGZyYWdtZW50IChlLmcuIC4uLi9mb28jL3NvbWUvcGF0aD9oYXNoUXVlcnk9cGFyYW0gID0+ICB7aGFzaFF1ZXJ5OiAicGFyYW0ifSkuCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBQYXJzZXMgdGhlIGJyb3dzZXIgbG9jYXRpb24gdXJsIGFuZCBtYWtlcyBpdCBhdmFpbGFibGUgdG8geW91ciBhcHBsaWNhdGlvbi4KICogQW55IGNoYW5nZXMgdG8gdGhlIHVybCBhcmUgcmVmbGVjdGVkIGludG8gYCRsb2NhdGlvbmAgc2VydmljZSBhbmQgY2hhbmdlcyB0bwogKiBgJGxvY2F0aW9uYCBhcmUgcmVmbGVjdGVkIGluIHRoZSBicm93c2VyIGxvY2F0aW9uIHVybC4KICoKICogTm90aWNlIHRoYXQgdXNpbmcgYnJvd3NlcidzIGZvcndhcmQvYmFjayBidXR0b25zIGNoYW5nZXMgdGhlICRsb2NhdGlvbi4KICoKICogQGV4YW1wbGUKICAgPGRvYzpleGFtcGxlPgogICAgIDxkb2M6c291cmNlPgogICAgICAgPGRpdiBuZzppbml0PSIkbG9jYXRpb24gPSAkc2VydmljZSgnJGxvY2F0aW9uJykiPgogICAgICAgICA8YSBpZD0iZXgtdGVzdCIgaHJlZj0iI215UGF0aD9uYW1lPW1pc2tvIj50ZXN0IGhhc2g8L2E+fAogICAgICAgICA8YSBpZD0iZXgtcmVzZXQiIGhyZWY9IiMhL2FwaS9hbmd1bGFyLnNlcnZpY2UuJGxvY2F0aW9uIj5yZXNldCBoYXNoPC9hPjxici8+CiAgICAgICAgIDxpbnB1dCB0eXBlPSd0ZXh0JyBuYW1lPSIkbG9jYXRpb24uaGFzaCIgc2l6ZT0iMzAiPgogICAgICAgICA8cHJlPiRsb2NhdGlvbiA9IHt7JGxvY2F0aW9ufX08L3ByZT4KICAgICAgIDwvZGl2PgogICAgIDwvZG9jOnNvdXJjZT4KICAgICA8ZG9jOnNjZW5hcmlvPgogICAgICAgaXQoJ3Nob3VsZCBpbml0aWFsaXplIHRoZSBpbnB1dCBmaWVsZCcsIGZ1bmN0aW9uKCkgewogICAgICAgICBleHBlY3QodXNpbmcoJy5kb2MtZXhhbXBsZS1saXZlJykuaW5wdXQoJyRsb2NhdGlvbi5oYXNoJykudmFsKCkpLgogICAgICAgICAgIHRvQmUoJyEvYXBpL2FuZ3VsYXIuc2VydmljZS4kbG9jYXRpb24nKTsKICAgICAgIH0pOwoKCiAgICAgICBpdCgnc2hvdWxkIGJpbmQgJGxvY2F0aW9uLmhhc2ggdG8gdGhlIGlucHV0IGZpZWxkJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIHVzaW5nKCcuZG9jLWV4YW1wbGUtbGl2ZScpLmlucHV0KCckbG9jYXRpb24uaGFzaCcpLmVudGVyKCdmb28nKTsKICAgICAgICAgZXhwZWN0KGJyb3dzZXIoKS5sb2NhdGlvbigpLmhhc2goKSkudG9CZSgnZm9vJyk7CiAgICAgICB9KTsKCgogICAgICAgaXQoJ3Nob3VsZCBzZXQgdGhlIGhhc2ggdG8gYSB0ZXN0IHN0cmluZyB3aXRoIHRlc3QgbGluayBpcyBwcmVzZWQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgdXNpbmcoJy5kb2MtZXhhbXBsZS1saXZlJykuZWxlbWVudCgnI2V4LXRlc3QnKS5jbGljaygpOwogICAgICAgICBleHBlY3QodXNpbmcoJy5kb2MtZXhhbXBsZS1saXZlJykuaW5wdXQoJyRsb2NhdGlvbi5oYXNoJykudmFsKCkpLgogICAgICAgICAgIHRvQmUoJ215UGF0aD9uYW1lPW1pc2tvJyk7CiAgICAgICB9KTsKCiAgICAgICBpdCgnc2hvdWxkIHJlc2V0ICRsb2NhdGlvbiB3aGVuIHJlc2V0IGxpbmsgaXMgcHJlc3NlZCcsIGZ1bmN0aW9uKCkgewogICAgICAgICB1c2luZygnLmRvYy1leGFtcGxlLWxpdmUnKS5pbnB1dCgnJGxvY2F0aW9uLmhhc2gnKS5lbnRlcignZm9vJyk7CiAgICAgICAgIHVzaW5nKCcuZG9jLWV4YW1wbGUtbGl2ZScpLmVsZW1lbnQoJyNleC1yZXNldCcpLmNsaWNrKCk7CiAgICAgICAgIGV4cGVjdCh1c2luZygnLmRvYy1leGFtcGxlLWxpdmUnKS5pbnB1dCgnJGxvY2F0aW9uLmhhc2gnKS52YWwoKSkuCiAgICAgICAgICAgdG9CZSgnIS9hcGkvYW5ndWxhci5zZXJ2aWNlLiRsb2NhdGlvbicpOwogICAgICAgfSk7CgogICAgIDwvZG9jOnNjZW5hcmlvPgogICAgPC9kb2M6ZXhhbXBsZT4KICovCmFuZ3VsYXJTZXJ2aWNlSW5qZWN0KCIkbG9jYXRpb24iLCBmdW5jdGlvbigkYnJvd3NlcikgewogIHZhciBzY29wZSA9IHRoaXMsCiAgICAgIGxvY2F0aW9uID0ge3VwZGF0ZTp1cGRhdGUsIHVwZGF0ZUhhc2g6IHVwZGF0ZUhhc2h9LAogICAgICBsYXN0TG9jYXRpb24gPSB7fTsKCiAgJGJyb3dzZXIub25IYXNoQ2hhbmdlKGZ1bmN0aW9uKCkgeyAvL3JlZ2lzdGVyCiAgICB1cGRhdGUoJGJyb3dzZXIuZ2V0VXJsKCkpOwogICAgY29weShsb2NhdGlvbiwgbGFzdExvY2F0aW9uKTsKICAgIHNjb3BlLiRldmFsKCk7CiAgfSkoKTsgLy9pbml0aWFsaXplCgogIHRoaXMuJG9uRXZhbChQUklPUklUWV9GSVJTVCwgc3luYyk7CiAgdGhpcy4kb25FdmFsKFBSSU9SSVRZX0xBU1QsIHVwZGF0ZUJyb3dzZXIpOwoKICByZXR1cm4gbG9jYXRpb247CgogIC8vIFBVQkxJQyBNRVRIT0RTCgogIC8qKgogICAqIEB3b3JrSW5Qcm9ncmVzcwogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSBhbmd1bGFyLnNlcnZpY2UuJGxvY2F0aW9uI3VwZGF0ZQogICAqIEBtZXRob2RPZiBhbmd1bGFyLnNlcnZpY2UuJGxvY2F0aW9uCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBVcGRhdGVzIHRoZSBsb2NhdGlvbiBvYmplY3QuCiAgICoKICAgKiBEb2VzIG5vdCBpbW1lZGlhdGVseSB1cGRhdGUgdGhlIGJyb3dzZXIuIEluc3RlYWQgdGhlIGJyb3dzZXIgaXMgdXBkYXRlZCBhdCB0aGUgZW5kIG9mICRldmFsKCkKICAgKiBjeWNsZS4KICAgKgogICAqIDxwcmU+CiAgICAgICAkbG9jYXRpb24udXBkYXRlKCdodHRwOi8vd3d3LmFuZ3VsYXJqcy5vcmcvcGF0aCNoYXNoP3NlYXJjaD14Jyk7CiAgICAgICAkbG9jYXRpb24udXBkYXRlKHtob3N0OiAnd3d3Lmdvb2dsZS5jb20nLCBwcm90b2NvbDogJ2h0dHBzJ30pOwogICAgICAgJGxvY2F0aW9uLnVwZGF0ZSh7aGFzaFBhdGg6ICcvcGF0aCcsIGhhc2hTZWFyY2g6IHthOiAnYicsIHg6IHRydWV9fSk7CiAgICAgPC9wcmU+CiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ3xPYmplY3R9IGhyZWYgRnVsbCBocmVmIGFzIGEgc3RyaW5nIG9yIG9iamVjdCB3aXRoIHByb3BlcnRpZXMKICAgKi8KICBmdW5jdGlvbiB1cGRhdGUoaHJlZikgewogICAgaWYgKGlzU3RyaW5nKGhyZWYpKSB7CiAgICAgIGV4dGVuZChsb2NhdGlvbiwgcGFyc2VIcmVmKGhyZWYpKTsKICAgIH0gZWxzZSB7CiAgICAgIGlmIChpc0RlZmluZWQoaHJlZi5oYXNoKSkgewogICAgICAgIGV4dGVuZChocmVmLCBpc1N0cmluZyhocmVmLmhhc2gpID8gcGFyc2VIYXNoKGhyZWYuaGFzaCkgOiBocmVmLmhhc2gpOwogICAgICB9CgogICAgICBleHRlbmQobG9jYXRpb24sIGhyZWYpOwoKICAgICAgaWYgKGlzRGVmaW5lZChocmVmLmhhc2hQYXRoIHx8IGhyZWYuaGFzaFNlYXJjaCkpIHsKICAgICAgICBsb2NhdGlvbi5oYXNoID0gY29tcG9zZUhhc2gobG9jYXRpb24pOwogICAgICB9CgogICAgICBsb2NhdGlvbi5ocmVmID0gY29tcG9zZUhyZWYobG9jYXRpb24pOwogICAgfQogIH0KCiAgLyoqCiAgICogQHdvcmtJblByb2dyZXNzCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lIGFuZ3VsYXIuc2VydmljZS4kbG9jYXRpb24jdXBkYXRlSGFzaAogICAqIEBtZXRob2RPZiBhbmd1bGFyLnNlcnZpY2UuJGxvY2F0aW9uCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBVcGRhdGVzIHRoZSBoYXNoIGZyYWdtZW50IHBhcnQgb2YgdGhlIHVybC4KICAgKgogICAqIEBzZWUgdXBkYXRlKCkKICAgKgogICAqIDxwcmU+CiAgICAgICBzY29wZS4kbG9jYXRpb24udXBkYXRlSGFzaCgnL2hwJykKICAgICAgICAgPT0+IHVwZGF0ZSh7aGFzaFBhdGg6ICcvaHAnfSkKICAgICAgIHNjb3BlLiRsb2NhdGlvbi51cGRhdGVIYXNoKHthOiB0cnVlLCBiOiAndmFsJ30pCiAgICAgICAgID09PiB1cGRhdGUoe2hhc2hTZWFyY2g6IHthOiB0cnVlLCBiOiAndmFsJ319KQogICAgICAgc2NvcGUuJGxvY2F0aW9uLnVwZGF0ZUhhc2goJy9ocCcsIHthOiB0cnVlfSkKICAgICAgICAgPT0+IHVwZGF0ZSh7aGFzaFBhdGg6ICcvaHAnLCBoYXNoU2VhcmNoOiB7YTogdHJ1ZX19KQogICAgIDwvcHJlPgogICAqCiAgICogQHBhcmFtIHtzdHJpbmd8T2JqZWN0fSBwYXRoIEEgaGFzaFBhdGggb3IgaGFzaFNlYXJjaCBvYmplY3QKICAgKiBAcGFyYW0ge09iamVjdD19IHNlYXJjaCBBIGhhc2hTZWFyY2ggb2JqZWN0CiAgICovCiAgZnVuY3Rpb24gdXBkYXRlSGFzaChwYXRoLCBzZWFyY2gpIHsKICAgIHZhciBoYXNoID0ge307CgogICAgaWYgKGlzU3RyaW5nKHBhdGgpKSB7CiAgICAgIGhhc2guaGFzaFBhdGggPSBwYXRoOwogICAgICBoYXNoLmhhc2hTZWFyY2ggPSBzZWFyY2ggfHwge307CiAgICB9IGVsc2UKICAgICAgaGFzaC5oYXNoU2VhcmNoID0gcGF0aDsKCiAgICBoYXNoLmhhc2ggPSBjb21wb3NlSGFzaChoYXNoKTsKCiAgICB1cGRhdGUoe2hhc2g6IGhhc2h9KTsKICB9CgoKICAvLyBJTk5FUiBNRVRIT0RTCgogIC8qKgogICAqIFN5bmNocm9uaXplcyBhbGwgbG9jYXRpb24gb2JqZWN0IHByb3BlcnRpZXMuCiAgICoKICAgKiBVc2VyIGlzIGFsbG93ZWQgdG8gY2hhbmdlIHByb3BlcnRpZXMsIHNvIGFmdGVyIHByb3BlcnR5IGNoYW5nZSwKICAgKiBsb2NhdGlvbiBvYmplY3QgaXMgbm90IGluIGNvbnNpc3RlbnQgc3RhdGUuCiAgICoKICAgKiBQcm9wZXJ0aWVzIGFyZSBzeW5jZWQgd2l0aCB0aGUgZm9sbG93aW5nIHByZWNlZGVuY2Ugb3JkZXI6CiAgICoKICAgKiAtIGAkbG9jYXRpb24uaHJlZmAKICAgKiAtIGAkbG9jYXRpb24uaGFzaGAKICAgKiAtIGV2ZXJ5dGhpbmcgZWxzZQogICAqCiAgICogS2VlcCBpbiBtaW5kIHRoYXQgaWYgdGhlIGZvbGxvd2luZyBjb2RlIGlzIGV4ZWN1dGVkOgogICAqCiAgICogc2NvcGUuJGxvY2F0aW9uLmhyZWYgPSAnaHR0cDovL3d3dy5hbmd1bGFyanMub3JnL3BhdGgjYS9iJwogICAqCiAgICogaW1tZWRpYXRlbHkgYWZ0ZXJ3YXJkcyBhbGwgb3RoZXIgcHJvcGVydGllcyBhcmUgc3RpbGwgdGhlIG9sZCBvbmVzLi4uCiAgICoKICAgKiBUaGlzIG1ldGhvZCBjaGVja3MgdGhlIGNoYW5nZXMgYW5kIHVwZGF0ZSBsb2NhdGlvbiB0byB0aGUgY29uc2lzdGVudCBzdGF0ZQogICAqLwogIGZ1bmN0aW9uIHN5bmMoKSB7CiAgICBpZiAoIWVxdWFscyhsb2NhdGlvbiwgbGFzdExvY2F0aW9uKSkgewogICAgICBpZiAobG9jYXRpb24uaHJlZiAhPSBsYXN0TG9jYXRpb24uaHJlZikgewogICAgICAgIHVwZGF0ZShsb2NhdGlvbi5ocmVmKTsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgaWYgKGxvY2F0aW9uLmhhc2ggIT0gbGFzdExvY2F0aW9uLmhhc2gpIHsKICAgICAgICB2YXIgaGFzaCA9IHBhcnNlSGFzaChsb2NhdGlvbi5oYXNoKTsKICAgICAgICB1cGRhdGVIYXNoKGhhc2guaGFzaFBhdGgsIGhhc2guaGFzaFNlYXJjaCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgbG9jYXRpb24uaGFzaCA9IGNvbXBvc2VIYXNoKGxvY2F0aW9uKTsKICAgICAgICBsb2NhdGlvbi5ocmVmID0gY29tcG9zZUhyZWYobG9jYXRpb24pOwogICAgICB9CiAgICAgIHVwZGF0ZShsb2NhdGlvbi5ocmVmKTsKICAgIH0KICB9CgoKICAvKioKICAgKiBJZiBsb2NhdGlvbiBoYXMgY2hhbmdlZCwgdXBkYXRlIHRoZSBicm93c2VyCiAgICogVGhpcyBtZXRob2QgaXMgY2FsbGVkIGF0IHRoZSBlbmQgb2YgJGV2YWwoKSBwaGFzZQogICAqLwogIGZ1bmN0aW9uIHVwZGF0ZUJyb3dzZXIoKSB7CiAgICBzeW5jKCk7CgogICAgaWYgKCRicm93c2VyLmdldFVybCgpICE9IGxvY2F0aW9uLmhyZWYpIHsKICAgICAgJGJyb3dzZXIuc2V0VXJsKGxvY2F0aW9uLmhyZWYpOwogICAgICBjb3B5KGxvY2F0aW9uLCBsYXN0TG9jYXRpb24pOwogICAgfQogIH0KCiAgLyoqCiAgICogQ29tcG9zZSBocmVmIHN0cmluZyBmcm9tIGEgbG9jYXRpb24gb2JqZWN0CiAgICoKICAgKiBAcGFyYW0ge09iamVjdH0gbG9jIFRoZSBsb2NhdGlvbiBvYmplY3Qgd2l0aCBhbGwgcHJvcGVydGllcwogICAqIEByZXR1cm4ge3N0cmluZ30gQ29tcG9zZWQgaHJlZgogICAqLwogIGZ1bmN0aW9uIGNvbXBvc2VIcmVmKGxvYykgewogICAgdmFyIHVybCA9IHRvS2V5VmFsdWUobG9jLnNlYXJjaCk7CiAgICB2YXIgcG9ydCA9IChsb2MucG9ydCA9PSBERUZBVUxUX1BPUlRTW2xvYy5wcm90b2NvbF0gPyBudWxsIDogbG9jLnBvcnQpOwoKICAgIHJldHVybiBsb2MucHJvdG9jb2wgICsgJzovLycgKyBsb2MuaG9zdCArCiAgICAgICAgICAocG9ydCA/ICc6JyArIHBvcnQgOiAnJykgKyBsb2MucGF0aCArCiAgICAgICAgICAodXJsID8gJz8nICsgdXJsIDogJycpICsgKGxvYy5oYXNoID8gJyMnICsgbG9jLmhhc2ggOiAnJyk7CiAgfQoKICAvKioKICAgKiBDb21wb3NlIGhhc2ggc3RyaW5nIGZyb20gbG9jYXRpb24gb2JqZWN0CiAgICoKICAgKiBAcGFyYW0ge09iamVjdH0gbG9jIE9iamVjdCB3aXRoIGhhc2hQYXRoIGFuZCBoYXNoU2VhcmNoIHByb3BlcnRpZXMKICAgKiBAcmV0dXJuIHtzdHJpbmd9IEhhc2ggc3RyaW5nCiAgICovCiAgZnVuY3Rpb24gY29tcG9zZUhhc2gobG9jKSB7CiAgICB2YXIgaGFzaFNlYXJjaCA9IHRvS2V5VmFsdWUobG9jLmhhc2hTZWFyY2gpOwogICAgLy9UT0RPOiB0ZW1wb3JhcnkgZml4IGZvciBpc3N1ZSAjMTU4CiAgICByZXR1cm4gZXNjYXBlKGxvYy5oYXNoUGF0aCkucmVwbGFjZSgvJTIxL2dpLCAnIScpLnJlcGxhY2UoLyUzQS9naSwgJzonKS5yZXBsYWNlKC8lMjQvZ2ksICckJykgKwogICAgICAgICAgKGhhc2hTZWFyY2ggPyAnPycgKyBoYXNoU2VhcmNoIDogJycpOwogIH0KCiAgLyoqCiAgICogUGFyc2UgaHJlZiBzdHJpbmcgaW50byBsb2NhdGlvbiBvYmplY3QKICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfSBocmVmCiAgICogQHJldHVybiB7T2JqZWN0fSBUaGUgbG9jYXRpb24gb2JqZWN0CiAgICovCiAgZnVuY3Rpb24gcGFyc2VIcmVmKGhyZWYpIHsKICAgIHZhciBsb2MgPSB7fTsKICAgIHZhciBtYXRjaCA9IFVSTF9NQVRDSC5leGVjKGhyZWYpOwoKICAgIGlmIChtYXRjaCkgewogICAgICBsb2MuaHJlZiA9IGhyZWYucmVwbGFjZSgvIyQvLCAnJyk7CiAgICAgIGxvYy5wcm90b2NvbCA9IG1hdGNoWzFdOwogICAgICBsb2MuaG9zdCA9IG1hdGNoWzNdIHx8ICcnOwogICAgICBsb2MucG9ydCA9IG1hdGNoWzVdIHx8IERFRkFVTFRfUE9SVFNbbG9jLnByb3RvY29sXSB8fCBudWxsOwogICAgICBsb2MucGF0aCA9IG1hdGNoWzZdIHx8ICcnOwogICAgICBsb2Muc2VhcmNoID0gcGFyc2VLZXlWYWx1ZShtYXRjaFs4XSk7CiAgICAgIGxvYy5oYXNoID0gbWF0Y2hbMTBdIHx8ICcnOwoKICAgICAgZXh0ZW5kKGxvYywgcGFyc2VIYXNoKGxvYy5oYXNoKSk7CiAgICB9CgogICAgcmV0dXJuIGxvYzsKICB9CgogIC8qKgogICAqIFBhcnNlIGhhc2ggc3RyaW5nIGludG8gb2JqZWN0CiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gaGFzaAogICAqLwogIGZ1bmN0aW9uIHBhcnNlSGFzaChoYXNoKSB7CiAgICB2YXIgaCA9IHt9OwogICAgdmFyIG1hdGNoID0gSEFTSF9NQVRDSC5leGVjKGhhc2gpOwoKICAgIGlmIChtYXRjaCkgewogICAgICBoLmhhc2ggPSBoYXNoOwogICAgICBoLmhhc2hQYXRoID0gdW5lc2NhcGUobWF0Y2hbMV0gfHwgJycpOwogICAgICBoLmhhc2hTZWFyY2ggPSBwYXJzZUtleVZhbHVlKG1hdGNoWzNdKTsKICAgIH0KCiAgICByZXR1cm4gaDsKICB9Cn0sIFsnJGJyb3dzZXInXSk7Cid1c2Ugc3RyaWN0JzsKCi8qKgogKiBAd29ya0luUHJvZ3Jlc3MKICogQG5nZG9jIHNlcnZpY2UKICogQG5hbWUgYW5ndWxhci5zZXJ2aWNlLiRsb2cKICogQHJlcXVpcmVzICR3aW5kb3cKICoKICogQGRlc2NyaXB0aW9uCiAqIFNpbXBsZSBzZXJ2aWNlIGZvciBsb2dnaW5nLiBEZWZhdWx0IGltcGxlbWVudGF0aW9uIHdyaXRlcyB0aGUgbWVzc2FnZQogKiBpbnRvIHRoZSBicm93c2VyJ3MgY29uc29sZSAoaWYgcHJlc2VudCkuCiAqCiAqIFRoZSBtYWluIHB1cnBvc2Ugb2YgdGhpcyBzZXJ2aWNlIGlzIHRvIHNpbXBsaWZ5IGRlYnVnZ2luZyBhbmQgdHJvdWJsZXNob290aW5nLgogKgogKiBAZXhhbXBsZQogICAgPGRvYzpleGFtcGxlPgogICAgICA8ZG9jOnNvdXJjZT4KICAgICAgICAgPHA+UmVsb2FkIHRoaXMgcGFnZSB3aXRoIG9wZW4gY29uc29sZSwgZW50ZXIgdGV4dCBhbmQgaGl0IHRoZSBsb2cgYnV0dG9uLi4uPC9wPgogICAgICAgICBNZXNzYWdlOgogICAgICAgICA8aW5wdXQgdHlwZT0idGV4dCIgbmFtZT0ibWVzc2FnZSIgdmFsdWU9IkhlbGxvIFdvcmxkISIvPgogICAgICAgICA8YnV0dG9uIG5nOmNsaWNrPSIkbG9nLmxvZyhtZXNzYWdlKSI+bG9nPC9idXR0b24+CiAgICAgICAgIDxidXR0b24gbmc6Y2xpY2s9IiRsb2cud2FybihtZXNzYWdlKSI+d2FybjwvYnV0dG9uPgogICAgICAgICA8YnV0dG9uIG5nOmNsaWNrPSIkbG9nLmluZm8obWVzc2FnZSkiPmluZm88L2J1dHRvbj4KICAgICAgICAgPGJ1dHRvbiBuZzpjbGljaz0iJGxvZy5lcnJvcihtZXNzYWdlKSI+ZXJyb3I8L2J1dHRvbj4KICAgICAgPC9kb2M6c291cmNlPgogICAgICA8ZG9jOnNjZW5hcmlvPgogICAgICA8L2RvYzpzY2VuYXJpbz4KICAgIDwvZG9jOmV4YW1wbGU+CiAqLwp2YXIgJGxvZ0ZhY3Rvcnk7IC8vcmVmZXJlbmNlIHRvIGJlIHVzZWQgb25seSBpbiB0ZXN0cwphbmd1bGFyU2VydmljZUluamVjdCgiJGxvZyIsICRsb2dGYWN0b3J5ID0gZnVuY3Rpb24oJHdpbmRvdyl7CiAgcmV0dXJuIHsKICAgIC8qKgogICAgICogQHdvcmtJblByb2dyZXNzCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSBhbmd1bGFyLnNlcnZpY2UuJGxvZyNsb2cKICAgICAqIEBtZXRob2RPZiBhbmd1bGFyLnNlcnZpY2UuJGxvZwogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogV3JpdGUgYSBsb2cgbWVzc2FnZQogICAgICovCiAgICBsb2c6IGNvbnNvbGVMb2coJ2xvZycpLAoKICAgIC8qKgogICAgICogQHdvcmtJblByb2dyZXNzCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSBhbmd1bGFyLnNlcnZpY2UuJGxvZyN3YXJuCiAgICAgKiBAbWV0aG9kT2YgYW5ndWxhci5zZXJ2aWNlLiRsb2cKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFdyaXRlIGEgd2FybmluZyBtZXNzYWdlCiAgICAgKi8KICAgIHdhcm46IGNvbnNvbGVMb2coJ3dhcm4nKSwKCiAgICAvKioKICAgICAqIEB3b3JrSW5Qcm9ncmVzcwogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgYW5ndWxhci5zZXJ2aWNlLiRsb2cjaW5mbwogICAgICogQG1ldGhvZE9mIGFuZ3VsYXIuc2VydmljZS4kbG9nCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBXcml0ZSBhbiBpbmZvcm1hdGlvbiBtZXNzYWdlCiAgICAgKi8KICAgIGluZm86IGNvbnNvbGVMb2coJ2luZm8nKSwKCiAgICAvKioKICAgICAqIEB3b3JrSW5Qcm9ncmVzcwogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgYW5ndWxhci5zZXJ2aWNlLiRsb2cjZXJyb3IKICAgICAqIEBtZXRob2RPZiBhbmd1bGFyLnNlcnZpY2UuJGxvZwogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogV3JpdGUgYW4gZXJyb3IgbWVzc2FnZQogICAgICovCiAgICBlcnJvcjogY29uc29sZUxvZygnZXJyb3InKQogIH07CgogIGZ1bmN0aW9uIGNvbnNvbGVMb2codHlwZSkgewogICAgdmFyIGNvbnNvbGUgPSAkd2luZG93LmNvbnNvbGUgfHwge307CiAgICB2YXIgbG9nRm4gPSBjb25zb2xlW3R5cGVdIHx8IGNvbnNvbGUubG9nIHx8IG5vb3A7CiAgICBpZiAobG9nRm4uYXBwbHkpIHsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKCl7CiAgICAgICAgdmFyIGFyZ3MgPSBbXTsKICAgICAgICBmb3JFYWNoKGFyZ3VtZW50cywgZnVuY3Rpb24oYXJnKXsKICAgICAgICAgIGFyZ3MucHVzaChmb3JtYXRFcnJvcihhcmcpKTsKICAgICAgICB9KTsKICAgICAgICByZXR1cm4gbG9nRm4uYXBwbHkoY29uc29sZSwgYXJncyk7CiAgICAgIH07CiAgICB9IGVsc2UgewogICAgICAvLyB3ZSBhcmUgSUUsIGluIHdoaWNoIGNhc2UgdGhlcmUgaXMgbm90aGluZyB3ZSBjYW4gZG8KICAgICAgcmV0dXJuIGxvZ0ZuOwogICAgfQogIH0KfSwgWyckd2luZG93J10pOwondXNlIHN0cmljdCc7CgovKioKICogQHdvcmtJblByb2dyZXNzCiAqIEBuZ2RvYyBzZXJ2aWNlCiAqIEBuYW1lIGFuZ3VsYXIuc2VydmljZS4kcmVzb3VyY2UKICogQHJlcXVpcmVzICR4aHIuY2FjaGUKICoKICogQGRlc2NyaXB0aW9uCiAqIEEgZmFjdG9yeSB3aGljaCBjcmVhdGVzIGEgcmVzb3VyY2Ugb2JqZWN0IHRoYXQgbGV0cyB5b3UgaW50ZXJhY3Qgd2l0aAogKiBbUkVTVGZ1bF0oaHR0cDovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9SZXByZXNlbnRhdGlvbmFsX1N0YXRlX1RyYW5zZmVyKSBzZXJ2ZXItc2lkZSBkYXRhIHNvdXJjZXMuCiAqCiAqIFRoZSByZXR1cm5lZCByZXNvdXJjZSBvYmplY3QgaGFzIGFjdGlvbiBtZXRob2RzIHdoaWNoIHByb3ZpZGUgaGlnaC1sZXZlbCBiZWhhdmlvcnMgd2l0aG91dAogKiB0aGUgbmVlZCB0byBpbnRlcmFjdCB3aXRoIHRoZSBsb3cgbGV2ZWwge0BsaW5rIGFuZ3VsYXIuc2VydmljZS4keGhyICR4aHJ9IHNlcnZpY2Ugb3IKICogcmF3IFhNTEh0dHBSZXF1ZXN0LgogKgogKiBAcGFyYW0ge3N0cmluZ30gdXJsIEEgcGFyYW1ldGVyaXplZCBVUkwgdGVtcGxhdGUgd2l0aCBwYXJhbWV0ZXJzIHByZWZpeGVkIGJ5IGA6YCBhcyBpbgogKiAgIGAvdXNlci86dXNlcm5hbWVgLgogKgogKiBAcGFyYW0ge09iamVjdD19IHBhcmFtRGVmYXVsdHMgRGVmYXVsdCB2YWx1ZXMgZm9yIGB1cmxgIHBhcmFtZXRlcnMuIFRoZXNlIGNhbiBiZSBvdmVycmlkZGVuIGluCiAqICAgYGFjdGlvbnNgIG1ldGhvZHMuCiAqCiAqICAgRWFjaCBrZXkgdmFsdWUgaW4gdGhlIHBhcmFtZXRlciBvYmplY3QgaXMgZmlyc3QgYm91bmQgdG8gdXJsIHRlbXBsYXRlIGlmIHByZXNlbnQgYW5kIHRoZW4gYW55CiAqICAgZXhjZXNzIGtleXMgYXJlIGFwcGVuZGVkIHRvIHRoZSB1cmwgc2VhcmNoIHF1ZXJ5IGFmdGVyIHRoZSBgP2AuCiAqCiAqICAgR2l2ZW4gYSB0ZW1wbGF0ZSBgL3BhdGgvOnZlcmJgIGFuZCBwYXJhbWV0ZXIgYHt2ZXJiOidncmVldCcsIHNhbHV0YXRpb246J0hlbGxvJ31gIHJlc3VsdHMgaW4KICogICBVUkwgYC9wYXRoL2dyZWV0P3NhbHV0YXRpb249SGVsbG9gLgogKgogKiAgIElmIHRoZSBwYXJhbWV0ZXIgdmFsdWUgaXMgcHJlZml4ZWQgd2l0aCBgQGAgdGhlbiB0aGUgdmFsdWUgb2YgdGhhdCBwYXJhbWV0ZXIgaXMgZXh0cmFjdGVkIGZyb20KICogICB0aGUgZGF0YSBvYmplY3QgKHVzZWZ1bCBmb3Igbm9uLUdFVCBvcGVyYXRpb25zKS4KICoKICogQHBhcmFtIHtPYmplY3QuPE9iamVjdD49fSBhY3Rpb25zIEhhc2ggd2l0aCBkZWNsYXJhdGlvbiBvZiBjdXN0b20gYWN0aW9uIHRoYXQgc2hvdWxkIGV4dGVuZCB0aGUKICogICBkZWZhdWx0IHNldCBvZiByZXNvdXJjZSBhY3Rpb25zLiBUaGUgZGVjbGFyYXRpb24gc2hvdWxkIGJlIGNyZWF0ZWQgaW4gdGhlIGZvbGxvd2luZyBmb3JtYXQ6CiAqCiAqICAgICAgIHthY3Rpb24xOiB7bWV0aG9kOj8sIHBhcmFtczo/LCBpc0FycmF5Oj8sIHZlcmlmeUNhY2hlOj99LAogKiAgICAgICAgYWN0aW9uMjoge21ldGhvZDo/LCBwYXJhbXM6PywgaXNBcnJheTo/LCB2ZXJpZnlDYWNoZTo/fSwKICogICAgICAgIC4uLn0KICoKICogICBXaGVyZToKICoKICogICAtIGBhY3Rpb25gIOKAkyB7c3RyaW5nfSDigJMgVGhlIG5hbWUgb2YgYWN0aW9uLiBUaGlzIG5hbWUgYmVjb21lcyB0aGUgbmFtZSBvZiB0aGUgbWV0aG9kIG9uIHlvdXIKICogICAgIHJlc291cmNlIG9iamVjdC4KICogICAtIGBtZXRob2RgIOKAkyB7c3RyaW5nfSDigJMgSFRUUCByZXF1ZXN0IG1ldGhvZC4gVmFsaWQgbWV0aG9kcyBhcmU6IGBHRVRgLCBgUE9TVGAsIGBQVVRgLCBgREVMRVRFYCwKICogICAgIGFuZCBgSlNPTmAgKGFsc28ga25vd24gYXMgSlNPTlApLgogKiAgIC0gYHBhcmFtc2Ag4oCTIHtvYmplY3Q9fSDigJMgT3B0aW9uYWwgc2V0IG9mIHByZS1ib3VuZCBwYXJhbWV0ZXJzIGZvciB0aGlzIGFjdGlvbi4KICogICAtIGlzQXJyYXkg4oCTIHtib29sZWFuPX0g4oCTIElmIHRydWUgdGhlbiB0aGUgcmV0dXJuZWQgb2JqZWN0IGZvciB0aGlzIGFjdGlvbiBpcyBhbiBhcnJheSwgc2VlCiAqICAgICBgcmV0dXJuc2Agc2VjdGlvbi4KICogICAtIHZlcmlmeUNhY2hlIOKAkyB7Ym9vbGVhbj19IOKAkyBJZiB0cnVlIHRoZW4gd2hlbmV2ZXIgY2FjaGUgaGl0IG9jY3VycywgdGhlIG9iamVjdCBpcyByZXR1cm5lZCBhbmQKICogICAgIGFuIGFzeW5jIHJlcXVlc3Qgd2lsbCBiZSBtYWRlIHRvIHRoZSBzZXJ2ZXIgYW5kIHRoZSByZXNvdXJjZXMgYXMgd2VsbCBhcyB0aGUgY2FjaGUgd2lsbCBiZQogKiAgICAgdXBkYXRlZCB3aGVuIHRoZSByZXNwb25zZSBpcyByZWNlaXZlZC4KICoKICogQHJldHVybnMge09iamVjdH0gQSByZXNvdXJjZSAiY2xhc3MiIG9iamVjdCB3aXRoIG1ldGhvZHMgZm9yIHRoZSBkZWZhdWx0IHNldCBvZiByZXNvdXJjZSBhY3Rpb25zCiAqICAgb3B0aW9uYWxseSBleHRlbmRlZCB3aXRoIGN1c3RvbSBgYWN0aW9uc2AuIFRoZSBkZWZhdWx0IHNldCBjb250YWlucyB0aGVzZSBhY3Rpb25zOgogKgogKiAgICAgICB7ICdnZXQnOiAgICB7bWV0aG9kOidHRVQnfSwKICogICAgICAgICAnc2F2ZSc6ICAge21ldGhvZDonUE9TVCd9LAogKiAgICAgICAgICdxdWVyeSc6ICB7bWV0aG9kOidHRVQnLCBpc0FycmF5OnRydWV9LAogKiAgICAgICAgICdyZW1vdmUnOiB7bWV0aG9kOidERUxFVEUnfSwKICogICAgICAgICAnZGVsZXRlJzoge21ldGhvZDonREVMRVRFJ30gfTsKICoKICogICBDYWxsaW5nIHRoZXNlIG1ldGhvZHMgaW52b2tlIGFuIHtAbGluayBhbmd1bGFyLnNlcnZpY2UuJHhocn0gd2l0aCB0aGUgc3BlY2lmaWVkIGh0dHAgbWV0aG9kLAogKiAgIGRlc3RpbmF0aW9uIGFuZCBwYXJhbWV0ZXJzLiBXaGVuIHRoZSBkYXRhIGlzIHJldHVybmVkIGZyb20gdGhlIHNlcnZlciB0aGVuIHRoZSBvYmplY3QgaXMgYW4KICogICBpbnN0YW5jZSBvZiB0aGUgcmVzb3VyY2UgY2xhc3MgYHNhdmVgLCBgcmVtb3ZlYCBhbmQgYGRlbGV0ZWAgYWN0aW9ucyBhcmUgYXZhaWxhYmxlIG9uIGl0IGFzCiAqICAgbWV0aG9kcyB3aXRoIHRoZSBgJGAgcHJlZml4LiBUaGlzIGFsbG93cyB5b3UgdG8gZWFzaWx5IHBlcmZvcm0gQ1JVRCBvcGVyYXRpb25zIChjcmVhdGUsIHJlYWQsCiAqICAgdXBkYXRlLCBkZWxldGUpIG9uIHNlcnZlci1zaWRlIGRhdGEgbGlrZSB0aGlzOgogKiAgIDxwcmU+CiAgICAgICAgdmFyIFVzZXIgPSAkcmVzb3VyY2UoJy91c2VyLzp1c2VySWQnLCB7dXNlcklkOidAaWQnfSk7CiAgICAgICAgdmFyIHVzZXIgPSBVc2VyLmdldCh7dXNlcklkOjEyM30sIGZ1bmN0aW9uKCl7CiAgICAgICAgICB1c2VyLmFiYyA9IHRydWU7CiAgICAgICAgICB1c2VyLiRzYXZlKCk7CiAgICAgICAgfSk7CiAgICAgPC9wcmU+CiAqCiAqICAgSXQgaXMgaW1wb3J0YW50IHRvIHJlYWxpemUgdGhhdCBpbnZva2luZyBhICRyZXNvdXJjZSBvYmplY3QgbWV0aG9kIGltbWVkaWF0ZWx5IHJldHVybnMgYW4KICogICBlbXB0eSByZWZlcmVuY2UgKG9iamVjdCBvciBhcnJheSBkZXBlbmRpbmcgb24gYGlzQXJyYXlgKS4gT25jZSB0aGUgZGF0YSBpcyByZXR1cm5lZCBmcm9tIHRoZQogKiAgIHNlcnZlciB0aGUgZXhpc3RpbmcgcmVmZXJlbmNlIGlzIHBvcHVsYXRlZCB3aXRoIHRoZSBhY3R1YWwgZGF0YS4gVGhpcyBpcyBhIHVzZWZ1bCB0cmljayBzaW5jZQogKiAgIHVzdWFsbHkgdGhlIHJlc291cmNlIGlzIGFzc2lnbmVkIHRvIGEgbW9kZWwgd2hpY2ggaXMgdGhlbiByZW5kZXJlZCBieSB0aGUgdmlldy4gSGF2aW5nIGFuIGVtcHR5CiAqICAgb2JqZWN0IHJlc3VsdHMgaW4gbm8gcmVuZGVyaW5nLCBvbmNlIHRoZSBkYXRhIGFycml2ZXMgZnJvbSB0aGUgc2VydmVyIHRoZW4gdGhlIG9iamVjdCBpcwogKiAgIHBvcHVsYXRlZCB3aXRoIHRoZSBkYXRhIGFuZCB0aGUgdmlldyBhdXRvbWF0aWNhbGx5IHJlLXJlbmRlcnMgaXRzZWxmIHNob3dpbmcgdGhlIG5ldyBkYXRhLiBUaGlzCiAqICAgbWVhbnMgdGhhdCBpbiBtb3N0IGNhc2Ugb25lIG5ldmVyIGhhcyB0byB3cml0ZSBhIGNhbGxiYWNrIGZ1bmN0aW9uIGZvciB0aGUgYWN0aW9uIG1ldGhvZHMuCiAqCiAqICAgVGhlIGFjdGlvbiBtZXRob2RzIG9uIHRoZSBjbGFzcyBvYmplY3Qgb3IgaW5zdGFuY2Ugb2JqZWN0IGNhbiBiZSBpbnZva2VkIHdpdGggdGhlIGZvbGxvd2luZwogKiAgIHBhcmFtZXRlcnM6CiAqCiAqICAgLSBIVFRQIEdFVCAiY2xhc3MiIGFjdGlvbnM6IGBSZXNvdXJjZS5hY3Rpb24oW3BhcmFtZXRlcnNdLCBbc3VjY2Vzc10sIFtlcnJvcl0pYAogKiAgIC0gbm9uLUdFVCAiY2xhc3MiIGFjdGlvbnM6IGBSZXNvdXJjZS5hY3Rpb24ocG9zdERhdGEsIFtwYXJhbWV0ZXJzXSwgW3N1Y2Nlc3NdLCBbZXJyb3JdKWAKICogICAtIG5vbi1HRVQgaW5zdGFuY2UgYWN0aW9uczogIGBpbnN0YW5jZS4kYWN0aW9uKFtwYXJhbWV0ZXJzXSwgW3N1Y2Nlc3NdLCBbZXJyb3JdKWAKICoKICoKICogQGV4YW1wbGUKICoKICogIyBDcmVkaXQgY2FyZCByZXNvdXJjZQogKgogKiA8cHJlPgogICAgIC8vIERlZmluZSBDcmVkaXRDYXJkIGNsYXNzCiAgICAgdmFyIENyZWRpdENhcmQgPSAkcmVzb3VyY2UoJy91c2VyLzp1c2VySWQvY2FyZC86Y2FyZElkJywKICAgICAge3VzZXJJZDoxMjMsIGNhcmRJZDonQGlkJ30sIHsKICAgICAgIGNoYXJnZToge21ldGhvZDonUE9TVCcsIHBhcmFtczp7Y2hhcmdlOnRydWV9fQogICAgICB9KTsKCiAgICAgLy8gV2UgY2FuIHJldHJpZXZlIGEgY29sbGVjdGlvbiBmcm9tIHRoZSBzZXJ2ZXIKICAgICB2YXIgY2FyZHMgPSBDcmVkaXRDYXJkLnF1ZXJ5KCk7CiAgICAgLy8gR0VUOiAvdXNlci8xMjMvY2FyZAogICAgIC8vIHNlcnZlciByZXR1cm5zOiBbIHtpZDo0NTYsIG51bWJlcjonMTIzNCcsIG5hbWU6J1NtaXRoJ30gXTsKCiAgICAgdmFyIGNhcmQgPSBjYXJkc1swXTsKICAgICAvLyBlYWNoIGl0ZW0gaXMgYW4gaW5zdGFuY2Ugb2YgQ3JlZGl0Q2FyZAogICAgIGV4cGVjdChjYXJkIGluc3RhbmNlb2YgQ3JlZGl0Q2FyZCkudG9FcXVhbCh0cnVlKTsKICAgICBjYXJkLm5hbWUgPSAiSi4gU21pdGgiOwogICAgIC8vIG5vbiBHRVQgbWV0aG9kcyBhcmUgbWFwcGVkIG9udG8gdGhlIGluc3RhbmNlcwogICAgIGNhcmQuJHNhdmUoKTsKICAgICAvLyBQT1NUOiAvdXNlci8xMjMvY2FyZC80NTYge2lkOjQ1NiwgbnVtYmVyOicxMjM0JywgbmFtZTonSi4gU21pdGgnfQogICAgIC8vIHNlcnZlciByZXR1cm5zOiB7aWQ6NDU2LCBudW1iZXI6JzEyMzQnLCBuYW1lOiAnSi4gU21pdGgnfTsKCiAgICAgLy8gb3VyIGN1c3RvbSBtZXRob2QgaXMgbWFwcGVkIGFzIHdlbGwuCiAgICAgY2FyZC4kY2hhcmdlKHthbW91bnQ6OS45OX0pOwogICAgIC8vIFBPU1Q6IC91c2VyLzEyMy9jYXJkLzQ1Nj9hbW91bnQ9OS45OSZjaGFyZ2U9dHJ1ZSB7aWQ6NDU2LCBudW1iZXI6JzEyMzQnLCBuYW1lOidKLiBTbWl0aCd9CiAgICAgLy8gc2VydmVyIHJldHVybnM6IHtpZDo0NTYsIG51bWJlcjonMTIzNCcsIG5hbWU6ICdKLiBTbWl0aCd9OwoKICAgICAvLyB3ZSBjYW4gY3JlYXRlIGFuIGluc3RhbmNlIGFzIHdlbGwKICAgICB2YXIgbmV3Q2FyZCA9IG5ldyBDcmVkaXRDYXJkKHtudW1iZXI6JzAxMjMnfSk7CiAgICAgbmV3Q2FyZC5uYW1lID0gIk1pa2UgU21pdGgiOwogICAgIG5ld0NhcmQuJHNhdmUoKTsKICAgICAvLyBQT1NUOiAvdXNlci8xMjMvY2FyZCB7bnVtYmVyOicwMTIzJywgbmFtZTonTWlrZSBTbWl0aCd9CiAgICAgLy8gc2VydmVyIHJldHVybnM6IHtpZDo3ODksIG51bWJlcjonMDEyMzQnLCBuYW1lOiAnTWlrZSBTbWl0aCd9OwogICAgIGV4cGVjdChuZXdDYXJkLmlkKS50b0VxdWFsKDc4OSk7CiAqIDwvcHJlPgogKgogKiBUaGUgb2JqZWN0IHJldHVybmVkIGZyb20gdGhpcyBmdW5jdGlvbiBleGVjdXRpb24gaXMgYSByZXNvdXJjZSAiY2xhc3MiIHdoaWNoIGhhcyAic3RhdGljIiBtZXRob2QKICogZm9yIGVhY2ggYWN0aW9uIGluIHRoZSBkZWZpbml0aW9uLgogKgogKiBDYWxsaW5nIHRoZXNlIG1ldGhvZHMgaW52b2tlIGAkeGhyYCBvbiB0aGUgYHVybGAgdGVtcGxhdGUgd2l0aCB0aGUgZ2l2ZW4gYG1ldGhvZGAgYW5kIGBwYXJhbXNgLgogKiBXaGVuIHRoZSBkYXRhIGlzIHJldHVybmVkIGZyb20gdGhlIHNlcnZlciB0aGVuIHRoZSBvYmplY3QgaXMgYW4gaW5zdGFuY2Ugb2YgdGhlIHJlc291cmNlIHR5cGUgYW5kCiAqIGFsbCBvZiB0aGUgbm9uLUdFVCBtZXRob2RzIGFyZSBhdmFpbGFibGUgd2l0aCBgJGAgcHJlZml4LiBUaGlzIGFsbG93cyB5b3UgdG8gZWFzaWx5IHN1cHBvcnQgQ1JVRAogKiBvcGVyYXRpb25zIChjcmVhdGUsIHJlYWQsIHVwZGF0ZSwgZGVsZXRlKSBvbiBzZXJ2ZXItc2lkZSBkYXRhLgoKICAgPHByZT4KICAgICB2YXIgVXNlciA9ICRyZXNvdXJjZSgnL3VzZXIvOnVzZXJJZCcsIHt1c2VySWQ6J0BpZCd9KTsKICAgICB2YXIgdXNlciA9IFVzZXIuZ2V0KHt1c2VySWQ6MTIzfSwgZnVuY3Rpb24oKXsKICAgICAgIHVzZXIuYWJjID0gdHJ1ZTsKICAgICAgIHVzZXIuJHNhdmUoKTsKICAgICB9KTsKICAgPC9wcmU+CiAqCiAqICAgICBJdCdzIHdvcnRoIG5vdGluZyB0aGF0IHRoZSBzdWNjZXNzIGNhbGxiYWNrIGZvciBgZ2V0YCwgYHF1ZXJ5YCBhbmQgb3RoZXIgbWV0aG9kIGdldHMgcGFzc2VkCiAqICAgICBpbiB0aGUgcmVzcG9uc2UgdGhhdCBjYW1lIGZyb20gdGhlIHNlcnZlciwgc28gb25lIGNvdWxkIHJld3JpdGUgdGhlIGFib3ZlIGV4YW1wbGUgYXM6CiAqCiAgIDxwcmU+CiAgICAgdmFyIFVzZXIgPSAkcmVzb3VyY2UoJy91c2VyLzp1c2VySWQnLCB7dXNlcklkOidAaWQnfSk7CiAgICAgVXNlci5nZXQoe3VzZXJJZDoxMjN9LCBmdW5jdGlvbih1LCByZXNwb25zZUhlYWRlcnMpewogICAgICAgdS5hYmMgPSB0cnVlOwogICAgICAgdS4kc2F2ZShmdW5jdGlvbih1LCByZXNwb25zZUhlYWRlcnMpIHsKICAgICAgICAgLy8gR2V0IGFuIE9iamVjdCBjb250YWluaW5nIGFsbCByZXNwb25zZSBoZWFkZXJzCiAgICAgICAgIHZhciBhbGxIZWFkZXJzID0gcmVzcG9uc2VIZWFkZXJzKCk7CgogICAgICAgICAvLyBHZXQgYSBzcGVjaWZpYyByZXNwb25zZSBoZWFkZXIKICAgICAgICAgdS5uZXdJZCA9IHJlc3BvbnNlSGVhZGVycygnTG9jYXRpb24nKTsKICAgICAgIH0pOwogICAgIH0pOwogICA8L3ByZT4KCiAqICMgQnV6eiBjbGllbnQKCiAgIExldCdzIGxvb2sgYXQgd2hhdCBhIGJ1enogY2xpZW50IGNyZWF0ZWQgd2l0aCB0aGUgYCRyZXNvdXJjZWAgc2VydmljZSBsb29rcyBsaWtlOgogICAgPGRvYzpleGFtcGxlPgogICAgICA8ZG9jOnNvdXJjZSBqc2ZpZGRsZT0iZmFsc2UiPgogICAgICAgPHNjcmlwdD4KICAgICAgICAgZnVuY3Rpb24gQnV6ekNvbnRyb2xsZXIoJHJlc291cmNlKSB7CiAgICAgICAgICAgdGhpcy5BY3Rpdml0eSA9ICRyZXNvdXJjZSgKICAgICAgICAgICAgICdodHRwczovL3d3dy5nb29nbGVhcGlzLmNvbS9idXp6L3YxL2FjdGl2aXRpZXMvOnVzZXJJZC86dmlzaWJpbGl0eS86YWN0aXZpdHlJZC86Y29tbWVudHMnLAogICAgICAgICAgICAge2FsdDonanNvbicsIGNhbGxiYWNrOidKU09OX0NBTExCQUNLJ30sCiAgICAgICAgICAgICB7Z2V0OnttZXRob2Q6J0pTT04nLCBwYXJhbXM6e3Zpc2liaWxpdHk6J0BzZWxmJ319LCByZXBsaWVzOiB7bWV0aG9kOidKU09OJywgcGFyYW1zOnt2aXNpYmlsaXR5OidAc2VsZicsIGNvbW1lbnRzOidAY29tbWVudHMnfX19CiAgICAgICAgICAgKTsKICAgICAgICAgfQoKICAgICAgICAgQnV6ekNvbnRyb2xsZXIucHJvdG90eXBlID0gewogICAgICAgICAgIGZldGNoOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgIHRoaXMuYWN0aXZpdGllcyA9IHRoaXMuQWN0aXZpdHkuZ2V0KHt1c2VySWQ6dGhpcy51c2VySWR9KTsKICAgICAgICAgICB9LAogICAgICAgICAgIGV4cGFuZFJlcGxpZXM6IGZ1bmN0aW9uKGFjdGl2aXR5KSB7CiAgICAgICAgICAgICBhY3Rpdml0eS5yZXBsaWVzID0gdGhpcy5BY3Rpdml0eS5yZXBsaWVzKHt1c2VySWQ6dGhpcy51c2VySWQsIGFjdGl2aXR5SWQ6YWN0aXZpdHkuaWR9KTsKICAgICAgICAgICB9CiAgICAgICAgIH07CiAgICAgICAgIEJ1enpDb250cm9sbGVyLiRpbmplY3QgPSBbJyRyZXNvdXJjZSddOwogICAgICAgPC9zY3JpcHQ+CgogICAgICAgPGRpdiBuZzpjb250cm9sbGVyPSJCdXp6Q29udHJvbGxlciI+CiAgICAgICAgIDxpbnB1dCBuYW1lPSJ1c2VySWQiIHZhbHVlPSJnb29nbGVidXp6Ii8+CiAgICAgICAgIDxidXR0b24gbmc6Y2xpY2s9ImZldGNoKCkiPmZldGNoPC9idXR0b24+CiAgICAgICAgIDxoci8+CiAgICAgICAgIDxkaXYgbmc6cmVwZWF0PSJpdGVtIGluIGFjdGl2aXRpZXMuZGF0YS5pdGVtcyI+CiAgICAgICAgICAgPGgxIHN0eWxlPSJmb250LXNpemU6IDE1cHg7Ij4KICAgICAgICAgICAgIDxpbWcgc3JjPSJ7e2l0ZW0uYWN0b3IudGh1bWJuYWlsVXJsfX0iIHN0eWxlPSJtYXgtaGVpZ2h0OjMwcHg7bWF4LXdpZHRoOjMwcHg7Ii8+CiAgICAgICAgICAgICA8YSBocmVmPSJ7e2l0ZW0uYWN0b3IucHJvZmlsZVVybH19Ij57e2l0ZW0uYWN0b3IubmFtZX19PC9hPgogICAgICAgICAgICAgPGEgaHJlZiBuZzpjbGljaz0iZXhwYW5kUmVwbGllcyhpdGVtKSIgc3R5bGU9ImZsb2F0OiByaWdodDsiPkV4cGFuZCByZXBsaWVzOiB7e2l0ZW0ubGlua3MucmVwbGllc1swXS5jb3VudH19PC9hPgogICAgICAgICAgIDwvaDE+CiAgICAgICAgICAge3tpdGVtLm9iamVjdC5jb250ZW50IHwgaHRtbH19CiAgICAgICAgICAgPGRpdiBuZzpyZXBlYXQ9InJlcGx5IGluIGl0ZW0ucmVwbGllcy5kYXRhLml0ZW1zIiBzdHlsZT0ibWFyZ2luLWxlZnQ6IDIwcHg7Ij4KICAgICAgICAgICAgIDxpbWcgc3JjPSJ7e3JlcGx5LmFjdG9yLnRodW1ibmFpbFVybH19IiBzdHlsZT0ibWF4LWhlaWdodDozMHB4O21heC13aWR0aDozMHB4OyIvPgogICAgICAgICAgICAgPGEgaHJlZj0ie3tyZXBseS5hY3Rvci5wcm9maWxlVXJsfX0iPnt7cmVwbHkuYWN0b3IubmFtZX19PC9hPjoge3tyZXBseS5jb250ZW50IHwgaHRtbH19CiAgICAgICAgICAgPC9kaXY+CiAgICAgICAgIDwvZGl2PgogICAgICAgPC9kaXY+CiAgICAgIDwvZG9jOnNvdXJjZT4KICAgICAgPGRvYzpzY2VuYXJpbz4KICAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICA8L2RvYzpleGFtcGxlPgogKi8KYW5ndWxhclNlcnZpY2VJbmplY3QoJyRyZXNvdXJjZScsIGZ1bmN0aW9uKCR4aHIpewogIHZhciByZXNvdXJjZSA9IG5ldyBSZXNvdXJjZUZhY3RvcnkoJHhocik7CiAgcmV0dXJuIGJpbmQocmVzb3VyY2UsIHJlc291cmNlLnJvdXRlKTsKfSwgWyckeGhyLmNhY2hlJ10pOwondXNlIHN0cmljdCc7CgovKioKICogQHdvcmtJblByb2dyZXNzCiAqIEBuZ2RvYyBzZXJ2aWNlCiAqIEBuYW1lIGFuZ3VsYXIuc2VydmljZS4kcm91dGUKICogQHJlcXVpcmVzICRsb2NhdGlvbgogKgogKiBAcHJvcGVydHkge09iamVjdH0gY3VycmVudCBSZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnQgcm91dGUgZGVmaW5pdGlvbi4KICogQHByb3BlcnR5IHtBcnJheS48T2JqZWN0Pn0gcm91dGVzIEFycmF5IG9mIGFsbCBjb25maWd1cmVkIHJvdXRlcy4KICoKICogQGRlc2NyaXB0aW9uCiAqIFdhdGNoZXMgYCRsb2NhdGlvbi5oYXNoUGF0aGAgYW5kIHRyaWVzIHRvIG1hcCB0aGUgaGFzaCB0byBhbiBleGlzdGluZyByb3V0ZQogKiBkZWZpbml0aW9uLiBJdCBpcyB1c2VkIGZvciBkZWVwLWxpbmtpbmcgVVJMcyB0byBjb250cm9sbGVycyBhbmQgdmlld3MgKEhUTUwgcGFydGlhbHMpLgogKgogKiBUaGUgYCRyb3V0ZWAgc2VydmljZSBpcyB0eXBpY2FsbHkgdXNlZCBpbiBjb25qdW5jdGlvbiB3aXRoIHtAbGluayBhbmd1bGFyLndpZGdldC5uZzp2aWV3IG5nOnZpZXd9CiAqIHdpZGdldC4KICoKICogQGV4YW1wbGUKICAgVGhpcyBleGFtcGxlIHNob3dzIGhvdyBjaGFuZ2luZyB0aGUgVVJMIGhhc2ggY2F1c2VzIHRoZSA8dHQ+JHJvdXRlPC90dD4KICAgdG8gbWF0Y2ggYSByb3V0ZSBhZ2FpbnN0IHRoZSBVUkwsIGFuZCB0aGUgPHR0Pltbbmc6aW5jbHVkZV1dPC90dD4gcHVsbHMgaW4gdGhlIHBhcnRpYWwuCiAgIFRyeSBjaGFuZ2luZyB0aGUgVVJMIGluIHRoZSBpbnB1dCBib3ggdG8gc2VlIGNoYW5nZXMuCgogICAgPGRvYzpleGFtcGxlPgogICAgICA8ZG9jOnNvdXJjZSBqc2ZpZGRsZT0iZmFsc2UiPgogICAgICAgIDxzY3JpcHQ+CiAgICAgICAgICBmdW5jdGlvbiBNYWluQ250bCgkcm91dGUsICRsb2NhdGlvbikgewogICAgICAgICAgICB0aGlzLiRyb3V0ZSA9ICRyb3V0ZTsKICAgICAgICAgICAgdGhpcy4kbG9jYXRpb24gPSAkbG9jYXRpb247CgogICAgICAgICAgICAkcm91dGUud2hlbignL0Jvb2svOmJvb2tJZCcsIHt0ZW1wbGF0ZTogJ2V4YW1wbGVzL2Jvb2suaHRtbCcsIGNvbnRyb2xsZXI6IEJvb2tDbnRsfSk7CiAgICAgICAgICAgICRyb3V0ZS53aGVuKCcvQm9vay86Ym9va0lkL2NoLzpjaGFwdGVySWQnLCB7dGVtcGxhdGU6ICdleGFtcGxlcy9jaGFwdGVyLmh0bWwnLCBjb250cm9sbGVyOiBDaGFwdGVyQ250bH0pOwogICAgICAgICAgICAkcm91dGUub25DaGFuZ2UoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgJHJvdXRlLmN1cnJlbnQuc2NvcGUucGFyYW1zID0gJHJvdXRlLmN1cnJlbnQucGFyYW1zOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KCiAgICAgICAgICBmdW5jdGlvbiBCb29rQ250bCgpIHsKICAgICAgICAgICAgdGhpcy5uYW1lID0gIkJvb2tDbnRsIjsKICAgICAgICAgIH0KCiAgICAgICAgICBmdW5jdGlvbiBDaGFwdGVyQ250bCgpIHsKICAgICAgICAgICAgdGhpcy5uYW1lID0gIkNoYXB0ZXJDbnRsIjsKICAgICAgICAgIH0KICAgICAgICA8L3NjcmlwdD4KCiAgICAgICAgPGRpdiBuZzpjb250cm9sbGVyPSJNYWluQ250bCI+CiAgICAgICAgICBDaG9vc2U6CiAgICAgICAgICA8YSBocmVmPSIjL0Jvb2svTW9ieSI+TW9ieTwvYT4gfAogICAgICAgICAgPGEgaHJlZj0iIy9Cb29rL01vYnkvY2gvMSI+TW9ieTogQ2gxPC9hPiB8CiAgICAgICAgICA8YSBocmVmPSIjL0Jvb2svR2F0c2J5Ij5HYXRzYnk8L2E+IHwKICAgICAgICAgIDxhIGhyZWY9IiMvQm9vay9HYXRzYnkvY2gvND9rZXk9dmFsdWUiPkdhdHNieTogQ2g0PC9hPjxici8+CiAgICAgICAgICAkbG9jYXRpb24uaGFzaFBhdGg6IDxpbnB1dCB0eXBlPSJ0ZXh0IiBuYW1lPSIkbG9jYXRpb24uaGFzaFBhdGgiIHNpemU9IjgwIiAvPgogICAgICAgICAgPHByZT4kcm91dGUuY3VycmVudC50ZW1wbGF0ZSA9IHt7JHJvdXRlLmN1cnJlbnQudGVtcGxhdGV9fTwvcHJlPgogICAgICAgICAgPHByZT4kcm91dGUuY3VycmVudC5wYXJhbXMgPSB7eyRyb3V0ZS5jdXJyZW50LnBhcmFtc319PC9wcmU+CiAgICAgICAgICA8cHJlPiRyb3V0ZS5jdXJyZW50LnNjb3BlLm5hbWUgPSB7eyRyb3V0ZS5jdXJyZW50LnNjb3BlLm5hbWV9fTwvcHJlPgogICAgICAgICAgPGhyIC8+CiAgICAgICAgICA8bmc6dmlldz48L25nOnZpZXc+CiAgICAgICAgPC9kaXY+CiAgICAgIDwvZG9jOnNvdXJjZT4KICAgICAgPGRvYzpzY2VuYXJpbz4KICAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICA8L2RvYzpleGFtcGxlPgogKi8KYW5ndWxhclNlcnZpY2VJbmplY3QoJyRyb3V0ZScsIGZ1bmN0aW9uKGxvY2F0aW9uLCAkdXBkYXRlVmlldykgewogIHZhciByb3V0ZXMgPSB7fSwKICAgICAgb25DaGFuZ2UgPSBbXSwKICAgICAgbWF0Y2hlciA9IHN3aXRjaFJvdXRlTWF0Y2hlciwKICAgICAgcGFyZW50U2NvcGUgPSB0aGlzLAogICAgICBkaXJ0eSA9IDAsCiAgICAgIGxhc3RIYXNoUGF0aCwKICAgICAgbGFzdFJvdXRlUGFyYW1zLAogICAgICAkcm91dGUgPSB7CiAgICAgICAgcm91dGVzOiByb3V0ZXMsCgogICAgICAgIC8qKgogICAgICAgICAqIEB3b3JrSW5Qcm9ncmVzcwogICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgKiBAbmFtZSBhbmd1bGFyLnNlcnZpY2UuJHJvdXRlI29uQ2hhbmdlCiAgICAgICAgICogQG1ldGhvZE9mIGFuZ3VsYXIuc2VydmljZS4kcm91dGUKICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oKX0gZm4gRnVuY3Rpb24gdGhhdCB3aWxsIGJlIGNhbGxlZCB3aGVuIGAkcm91dGUuY3VycmVudGAgY2hhbmdlcy4KICAgICAgICAgKiBAcmV0dXJucyB7ZnVuY3Rpb24oKX0gVGhlIHJlZ2lzdGVyZWQgZnVuY3Rpb24uCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBSZWdpc3RlciBhIGhhbmRsZXIgZnVuY3Rpb24gdGhhdCB3aWxsIGJlIGNhbGxlZCB3aGVuIHJvdXRlIGNoYW5nZXMKICAgICAgICAgKi8KICAgICAgICBvbkNoYW5nZTogZnVuY3Rpb24oZm4pIHsKICAgICAgICAgIG9uQ2hhbmdlLnB1c2goZm4pOwogICAgICAgICAgcmV0dXJuIGZuOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEB3b3JrSW5Qcm9ncmVzcwogICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgKiBAbmFtZSBhbmd1bGFyLnNlcnZpY2UuJHJvdXRlI3BhcmVudAogICAgICAgICAqIEBtZXRob2RPZiBhbmd1bGFyLnNlcnZpY2UuJHJvdXRlCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge1Njb3BlfSBbc2NvcGU9cm9vdFNjb3BlXSBTY29wZSB0byBiZSB1c2VkIGFzIHBhcmVudCBmb3IgbmV3bHkgY3JlYXRlZAogICAgICAgICAqICAgIGAkcm91dGUuY3VycmVudC5zY29wZWAgc2NvcGVzLgogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogU2V0cyBhIHNjb3BlIHRvIGJlIHVzZWQgYXMgdGhlIHBhcmVudCBzY29wZSBmb3Igc2NvcGVzIGNyZWF0ZWQgb24gcm91dGUgY2hhbmdlLiBJZiBub3QKICAgICAgICAgKiBzZXQsIGRlZmF1bHRzIHRvIHRoZSByb290IHNjb3BlLgogICAgICAgICAqLwogICAgICAgIHBhcmVudDogZnVuY3Rpb24oc2NvcGUpIHsKICAgICAgICAgIGlmIChzY29wZSkgcGFyZW50U2NvcGUgPSBzY29wZTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAd29ya0luUHJvZ3Jlc3MKICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICogQG5hbWUgYW5ndWxhci5zZXJ2aWNlLiRyb3V0ZSN3aGVuCiAgICAgICAgICogQG1ldGhvZE9mIGFuZ3VsYXIuc2VydmljZS4kcm91dGUKICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBwYXRoIFJvdXRlIHBhdGggKG1hdGNoZWQgYWdhaW5zdCBgJGxvY2F0aW9uLmhhc2hgKQogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBwYXJhbXMgTWFwcGluZyBpbmZvcm1hdGlvbiB0byBiZSBhc3NpZ25lZCB0byBgJHJvdXRlLmN1cnJlbnRgIG9uIHJvdXRlCiAgICAgICAgICogICAgbWF0Y2guCiAgICAgICAgICoKICAgICAgICAgKiAgICBPYmplY3QgcHJvcGVydGllczoKICAgICAgICAgKgogICAgICAgICAqICAgIC0gYGNvbnRyb2xsZXJgIOKAkyBge2Z1bmN0aW9uKCk9fWAg4oCTIENvbnRyb2xsZXIgZm4gdGhhdCBzaG91bGQgYmUgYXNzb2NpYXRlZCB3aXRoIG5ld2x5CiAgICAgICAgICogICAgICBjcmVhdGVkIHNjb3BlLgogICAgICAgICAqICAgIC0gYHRlbXBsYXRlYCDigJMgYHtzdHJpbmc9fWAg4oCTIHBhdGggdG8gYW4gaHRtbCB0ZW1wbGF0ZSB0aGF0IHNob3VsZCBiZSB1c2VkIGJ5CiAgICAgICAgICogICAgICB7QGxpbmsgYW5ndWxhci53aWRnZXQubmc6dmlldyBuZzp2aWV3fSBvcgogICAgICAgICAqICAgICAge0BsaW5rIGFuZ3VsYXIud2lkZ2V0Lm5nOmluY2x1ZGUgbmc6aW5jbHVkZX0gd2lkZ2V0cy4KICAgICAgICAgKiAgICAtIGByZWRpcmVjdFRvYCDigJMgeyhzdHJpbmd8ZnVuY3Rpb24oKSk9fSDigJMgdmFsdWUgdG8gdXBkYXRlCiAgICAgICAgICogICAgICB7QGxpbmsgYW5ndWxhci5zZXJ2aWNlLiRsb2NhdGlvbiAkbG9jYXRpb259IGhhc2ggd2l0aCBhbmQgdHJpZ2dlciByb3V0ZSByZWRpcmVjdGlvbi4KICAgICAgICAgKgogICAgICAgICAqICAgICAgSWYgYHJlZGlyZWN0VG9gIGlzIGEgZnVuY3Rpb24sIGl0IHdpbGwgYmUgY2FsbGVkIHdpdGggdGhlIGZvbGxvd2luZyBwYXJhbWV0ZXJzOgogICAgICAgICAqCiAgICAgICAgICogICAgICAtIGB7T2JqZWN0LjxzdHJpbmc+fWAgLSByb3V0ZSBwYXJhbWV0ZXJzIGV4dHJhY3RlZCBmcm9tIHRoZSBjdXJyZW50CiAgICAgICAgICogICAgICAgIGAkbG9jYXRpb24uaGFzaFBhdGhgIGJ5IGFwcGx5aW5nIHRoZSBjdXJyZW50IHJvdXRlIHRlbXBsYXRlLgogICAgICAgICAqICAgICAgLSBge3N0cmluZ31gIC0gY3VycmVudCBgJGxvY2F0aW9uLmhhc2hgCiAgICAgICAgICogICAgICAtIGB7c3RyaW5nfWAgLSBjdXJyZW50IGAkbG9jYXRpb24uaGFzaFBhdGhgCiAgICAgICAgICogICAgICAtIGB7c3RyaW5nfWAgLSBjdXJyZW50IGAkbG9jYXRpb24uaGFzaFNlYXJjaGAKICAgICAgICAgKgogICAgICAgICAqICAgICAgVGhlIGN1c3RvbSBgcmVkaXJlY3RUb2AgZnVuY3Rpb24gaXMgZXhwZWN0ZWQgdG8gcmV0dXJuIGEgc3RyaW5nIHdoaWNoIHdpbGwgYmUgdXNlZAogICAgICAgICAqICAgICAgdG8gdXBkYXRlIGAkbG9jYXRpb24uaGFzaGAuCiAgICAgICAgICoKICAgICAgICAgKiAgICAtIGBbcmVsb2FkT25TZWFyY2g9dHJ1ZV1gIC0ge2Jvb2xlYW49fSAtIHJlbG9hZCByb3V0ZSB3aGVuICRsb2NhdGlvbi5oYXNoU2VhcmNoCiAgICAgICAgICogICAgICBjaGFuZ2VzLiBJZiB0aGlzIG9wdGlvbiBpcyBkaXNhYmxlZCwgeW91IHNob3VsZCBzZXQgdXAgYSAkd2F0Y2ggdG8gYmUgbm90aWZpZWQgb2YKICAgICAgICAgKiAgICAgIHBhcmFtIChoYXNoU2VhcmNoKSBjaGFuZ2VzIGFzIGZvbGxvd3M6CiAgICAgICAgICoKICAgICAgICAgKiAgICAgICAgICAgIGZ1bmN0aW9uIE15Q3RybCgkcm91dGUpIHsKICAgICAgICAgKiAgICAgICAgICAgICAgdGhpcy4kd2F0Y2goZnVuY3Rpb24oKSB7CiAgICAgICAgICogICAgICAgICAgICAgICAgcmV0dXJuICRyb3V0ZS5jdXJyZW50LnBhcmFtcy5teUhhc2hTZWFyY2hQYXJhbTsKICAgICAgICAgKiAgICAgICAgICAgICAgfSwgZnVuY3Rpb24ocGFyYW1zKSB7CiAgICAgICAgICogICAgICAgICAgICAgICAgLy9kbyBzdHVmZiB3aXRoIHBhcmFtcwogICAgICAgICAqICAgICAgICAgICAgICB9KTsKICAgICAgICAgKiAgICAgICAgICAgIH0KICAgICAgICAgKgogICAgICAgICAqIEByZXR1cm5zIHtPYmplY3R9IHJvdXRlIG9iamVjdAogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogQWRkcyBhIG5ldyByb3V0ZSBkZWZpbml0aW9uIHRvIHRoZSBgJHJvdXRlYCBzZXJ2aWNlLgogICAgICAgICAqLwogICAgICAgIHdoZW46ZnVuY3Rpb24gKHBhdGgsIHBhcmFtcykgewogICAgICAgICAgaWYgKGlzVW5kZWZpbmVkKHBhdGgpKSByZXR1cm4gcm91dGVzOyAvL1RPRE8oaW0pOiByZW1vdmUgLSBub3QgbmVlZGVkIQogICAgICAgICAgdmFyIHJvdXRlID0gcm91dGVzW3BhdGhdOwogICAgICAgICAgaWYgKCFyb3V0ZSkgcm91dGUgPSByb3V0ZXNbcGF0aF0gPSB7cmVsb2FkT25TZWFyY2g6IHRydWV9OwogICAgICAgICAgaWYgKHBhcmFtcykgZXh0ZW5kKHJvdXRlLCBwYXJhbXMpOyAvL1RPRE8oaW0pOiB3aGF0IHRoZSBoZWNrPyBtZXJnZSB0d28gcm91dGUgZGVmaW5pdGlvbnM/CiAgICAgICAgICBkaXJ0eSsrOwogICAgICAgICAgcmV0dXJuIHJvdXRlOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEB3b3JrSW5Qcm9ncmVzcwogICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgKiBAbmFtZSBhbmd1bGFyLnNlcnZpY2UuJHJvdXRlI290aGVyd2lzZQogICAgICAgICAqIEBtZXRob2RPZiBhbmd1bGFyLnNlcnZpY2UuJHJvdXRlCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBTZXRzIHJvdXRlIGRlZmluaXRpb24gdGhhdCB3aWxsIGJlIHVzZWQgb24gcm91dGUgY2hhbmdlIHdoZW4gbm8gb3RoZXIgcm91dGUgZGVmaW5pdGlvbgogICAgICAgICAqIGlzIG1hdGNoZWQuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gcGFyYW1zIE1hcHBpbmcgaW5mb3JtYXRpb24gdG8gYmUgYXNzaWduZWQgdG8gYCRyb3V0ZS5jdXJyZW50YC4KICAgICAgICAgKi8KICAgICAgICBvdGhlcndpc2U6IGZ1bmN0aW9uKHBhcmFtcykgewogICAgICAgICAgJHJvdXRlLndoZW4obnVsbCwgcGFyYW1zKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAd29ya0luUHJvZ3Jlc3MKICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICogQG5hbWUgYW5ndWxhci5zZXJ2aWNlLiRyb3V0ZSNyZWxvYWQKICAgICAgICAgKiBAbWV0aG9kT2YgYW5ndWxhci5zZXJ2aWNlLiRyb3V0ZQogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogQ2F1c2VzIGAkcm91dGVgIHNlcnZpY2UgdG8gcmVsb2FkIChhbmQgcmVjcmVhdGUgdGhlIGAkcm91dGUuY3VycmVudGAgc2NvcGUpIHVwb24gdGhlIG5leHQKICAgICAgICAgKiBldmFsIGV2ZW4gaWYge0BsaW5rIGFuZ3VsYXIuc2VydmljZS4kbG9jYXRpb24gJGxvY2F0aW9ufSBoYXNuJ3QgY2hhbmdlZC4KICAgICAgICAgKi8KICAgICAgICByZWxvYWQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgZGlydHkrKzsKICAgICAgICB9CiAgICAgIH07CgoKICBmdW5jdGlvbiBzd2l0Y2hSb3V0ZU1hdGNoZXIob24sIHdoZW4sIGRzdE5hbWUpIHsKICAgIHZhciByZWdleCA9ICdeJyArIHdoZW4ucmVwbGFjZSgvW1wuXFxcKFwpXF5cJF0vZywgIlwkMSIpICsgJyQnLAogICAgICAgIHBhcmFtcyA9IFtdLAogICAgICAgIGRzdCA9IHt9OwogICAgZm9yRWFjaCh3aGVuLnNwbGl0KC9cVy8pLCBmdW5jdGlvbihwYXJhbSl7CiAgICAgIGlmIChwYXJhbSkgewogICAgICAgIHZhciBwYXJhbVJlZ0V4cCA9IG5ldyBSZWdFeHAoIjoiICsgcGFyYW0gKyAiKFtcXFddKSIpOwogICAgICAgIGlmIChyZWdleC5tYXRjaChwYXJhbVJlZ0V4cCkpIHsKICAgICAgICAgIHJlZ2V4ID0gcmVnZXgucmVwbGFjZShwYXJhbVJlZ0V4cCwgIihbXlwvXSopJDEiKTsKICAgICAgICAgIHBhcmFtcy5wdXNoKHBhcmFtKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogICAgdmFyIG1hdGNoID0gb24ubWF0Y2gobmV3IFJlZ0V4cChyZWdleCkpOwogICAgaWYgKG1hdGNoKSB7CiAgICAgIGZvckVhY2gocGFyYW1zLCBmdW5jdGlvbihuYW1lLCBpbmRleCl7CiAgICAgICAgZHN0W25hbWVdID0gbWF0Y2hbaW5kZXggKyAxXTsKICAgICAgfSk7CiAgICAgIGlmIChkc3ROYW1lKSB0aGlzLiRzZXQoZHN0TmFtZSwgZHN0KTsKICAgIH0KICAgIHJldHVybiBtYXRjaCA/IGRzdCA6IG51bGw7CiAgfQoKCiAgZnVuY3Rpb24gdXBkYXRlUm91dGUoKXsKICAgIHZhciBjaGlsZFNjb3BlLCByb3V0ZVBhcmFtcywgcGF0aFBhcmFtcywgc2VnbWVudE1hdGNoLCBrZXksIHJlZGlyOwoKICAgIGlmICgkcm91dGUuY3VycmVudCkgewogICAgICBpZiAoISRyb3V0ZS5jdXJyZW50LnJlbG9hZE9uU2VhcmNoICYmIChsYXN0SGFzaFBhdGggPT0gbG9jYXRpb24uaGFzaFBhdGgpKSB7CiAgICAgICAgJHJvdXRlLmN1cnJlbnQucGFyYW1zID0gZXh0ZW5kKHt9LCBsb2NhdGlvbi5oYXNoU2VhcmNoLCBsYXN0Um91dGVQYXJhbXMpOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgfQoKICAgIGxhc3RIYXNoUGF0aCA9IGxvY2F0aW9uLmhhc2hQYXRoOwogICAgJHJvdXRlLmN1cnJlbnQgPSBudWxsOwogICAgZm9yRWFjaChyb3V0ZXMsIGZ1bmN0aW9uKHJQYXJhbXMsIHJQYXRoKSB7CiAgICAgIGlmICghcGF0aFBhcmFtcykgewogICAgICAgIGlmIChwYXRoUGFyYW1zID0gbWF0Y2hlcihsb2NhdGlvbi5oYXNoUGF0aCwgclBhdGgpKSB7CiAgICAgICAgICByb3V0ZVBhcmFtcyA9IHJQYXJhbXM7CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKCiAgICAvLyAib3RoZXJ3aXNlIiBmYWxsYmFjawogICAgcm91dGVQYXJhbXMgPSByb3V0ZVBhcmFtcyB8fCByb3V0ZXNbbnVsbF07CgogICAgaWYocm91dGVQYXJhbXMpIHsKICAgICAgaWYgKHJvdXRlUGFyYW1zLnJlZGlyZWN0VG8pIHsKICAgICAgICBpZiAoaXNTdHJpbmcocm91dGVQYXJhbXMucmVkaXJlY3RUbykpIHsKICAgICAgICAgIC8vIGludGVycG9sYXRlIHRoZSByZWRpcmVjdFRvIHN0cmluZwogICAgICAgICAgcmVkaXIgPSB7aGFzaFBhdGg6ICcnLAogICAgICAgICAgICAgICAgICAgaGFzaFNlYXJjaDogZXh0ZW5kKHt9LCBsb2NhdGlvbi5oYXNoU2VhcmNoLCBwYXRoUGFyYW1zKX07CgogICAgICAgICAgZm9yRWFjaChyb3V0ZVBhcmFtcy5yZWRpcmVjdFRvLnNwbGl0KCc6JyksIGZ1bmN0aW9uKHNlZ21lbnQsIGkpIHsKICAgICAgICAgICAgaWYgKGk9PTApIHsKICAgICAgICAgICAgICByZWRpci5oYXNoUGF0aCArPSBzZWdtZW50OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHNlZ21lbnRNYXRjaCA9IHNlZ21lbnQubWF0Y2goLyhcdyspKC4qKS8pOwogICAgICAgICAgICAgIGtleSA9IHNlZ21lbnRNYXRjaFsxXTsKICAgICAgICAgICAgICByZWRpci5oYXNoUGF0aCArPSBwYXRoUGFyYW1zW2tleV0gfHwgbG9jYXRpb24uaGFzaFNlYXJjaFtrZXldOwogICAgICAgICAgICAgIHJlZGlyLmhhc2hQYXRoICs9IHNlZ21lbnRNYXRjaFsyXSB8fCAnJzsKICAgICAgICAgICAgICBkZWxldGUgcmVkaXIuaGFzaFNlYXJjaFtrZXldOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgLy8gY2FsbCBjdXN0b20gcmVkaXJlY3RUbyBmdW5jdGlvbgogICAgICAgICAgcmVkaXIgPSB7aGFzaDogcm91dGVQYXJhbXMucmVkaXJlY3RUbyhwYXRoUGFyYW1zLCBsb2NhdGlvbi5oYXNoLCBsb2NhdGlvbi5oYXNoUGF0aCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9jYXRpb24uaGFzaFNlYXJjaCl9OwogICAgICAgIH0KCiAgICAgICAgbG9jYXRpb24udXBkYXRlKHJlZGlyKTsKICAgICAgICAkdXBkYXRlVmlldygpOyAvL1RPRE8gdGhpcyBpcyB0byB3b3JrIGFyb3VuZCB0aGUgJGxvY2F0aW9uPD0+JGJyb3dzZXIgaXNzdWVzCiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBjaGlsZFNjb3BlID0gY3JlYXRlU2NvcGUocGFyZW50U2NvcGUpOwogICAgICAkcm91dGUuY3VycmVudCA9IGV4dGVuZCh7fSwgcm91dGVQYXJhbXMsIHsKICAgICAgICBzY29wZTogY2hpbGRTY29wZSwKICAgICAgICBwYXJhbXM6IGV4dGVuZCh7fSwgbG9jYXRpb24uaGFzaFNlYXJjaCwgcGF0aFBhcmFtcykKICAgICAgfSk7CiAgICAgIGxhc3RSb3V0ZVBhcmFtcyA9IHBhdGhQYXJhbXM7CiAgICB9CgogICAgLy9maXJlIG9uQ2hhbmdlIGNhbGxiYWNrcwogICAgZm9yRWFjaChvbkNoYW5nZSwgcGFyZW50U2NvcGUuJHRyeUV2YWwpOwoKICAgIGlmIChjaGlsZFNjb3BlKSB7CiAgICAgIGNoaWxkU2NvcGUuJGJlY29tZSgkcm91dGUuY3VycmVudC5jb250cm9sbGVyKTsKICAgIH0KICB9CgoKICB0aGlzLiR3YXRjaChmdW5jdGlvbigpeyByZXR1cm4gZGlydHkgKyBsb2NhdGlvbi5oYXNoOyB9LCB1cGRhdGVSb3V0ZSk7CgogIHJldHVybiAkcm91dGU7Cn0sIFsnJGxvY2F0aW9uJywgJyR1cGRhdGVWaWV3J10pOwondXNlIHN0cmljdCc7CgovKioKICogQHdvcmtJblByb2dyZXNzCiAqIEBuZ2RvYyBzZXJ2aWNlCiAqIEBuYW1lIGFuZ3VsYXIuc2VydmljZS4kdXBkYXRlVmlldwogKiBAcmVxdWlyZXMgJGJyb3dzZXIKICoKICogQGRlc2NyaXB0aW9uCiAqIENhbGxpbmcgYCR1cGRhdGVWaWV3YCBlbnF1ZXVlcyB0aGUgZXZlbnR1YWwgdXBkYXRlIG9mIHRoZSB2aWV3LiAoVXBkYXRlIHRoZSBET00gdG8gcmVmbGVjdCB0aGUKICogbW9kZWwpLiBUaGUgdXBkYXRlIGlzIGV2ZW50dWFsLCBzaW5jZSB0aGVyZSBhcmUgb2Z0ZW4gbXVsdGlwbGUgdXBkYXRlcyB0byB0aGUgbW9kZWwgd2hpY2ggbWF5CiAqIGJlIGRlZmVycmVkLiBUaGUgZGVmYXVsdCB1cGRhdGUgZGVsYXllZCBpcyAyNSBtcy4gVGhpcyBtZWFucyB0aGF0IHRoZSB2aWV3IGxhZ3MgdGhlIG1vZGVsIGJ5CiAqIHRoYXQgdGltZS4gKDI1bXMgaXMgc21hbGwgZW5vdWdoIHRoYXQgaXQgaXMgcGVyY2VpdmVkIGFzIGluc3RhbnRhbmVvdXMgYnkgdGhlIHVzZXIpLiBUaGUgZGVsYXkKICogY2FuIGJlIGFkanVzdGVkIGJ5IHNldHRpbmcgdGhlIGRlbGF5IHByb3BlcnR5IG9mIHRoZSBzZXJ2aWNlLgogKgogKiA8cHJlPmFuZ3VsYXIuc2VydmljZSgnJHVwZGF0ZVZpZXcnKS5kZWxheSA9IDEwPC9wcmU+CiAqCiAqIFRoZSBkZWxheSBpcyB0aGVyZSBzbyB0aGF0IG11bHRpcGxlIHVwZGF0ZXMgdG8gdGhlIG1vZGVsIHdoaWNoIG9jY3VyIHN1ZmZpY2llbnRseSBjbG9zZQogKiB0b2dldGhlciBjYW4gYmUgbWVyZ2VkIGludG8gYSBzaW5nbGUgdXBkYXRlLgogKgogKiBZb3UgZG9uJ3QgdXN1YWxseSBjYWxsICckdXBkYXRlVmlldycgZGlyZWN0bHkgc2luY2UgYW5ndWxhciBkb2VzIGl0IGZvciB5b3UgaW4gbW9zdCBjYXNlcywKICogYnV0IHRoZXJlIGFyZSBzb21lIGNhc2VzIHdoZW4geW91IG5lZWQgdG8gY2FsbCBpdC4KICoKICogIC0gYCR1cGRhdGVWaWV3KClgIGNhbGxlZCBhdXRvbWF0aWNhbGx5IGJ5IGFuZ3VsYXI6CiAqICAgIC0gWW91ciBBcHBsaWNhdGlvbiBDb250cm9sbGVyczogWW91ciBjb250cm9sbGVyIGNvZGUgaXMgY2FsbGVkIGJ5IGFuZ3VsYXIgYW5kIGhlbmNlCiAqICAgICAgYW5ndWxhciBpcyBhd2FyZSB0aGF0IHlvdSBtYXkgaGF2ZSBjaGFuZ2VkIHRoZSBtb2RlbC4KICogICAgLSBZb3VyIFNlcnZpY2VzOiBZb3VyIHNlcnZpY2UgaXMgdXN1YWxseSBjYWxsZWQgYnkgeW91ciBjb250cm9sbGVyIGNvZGUsIGhlbmNlIHNhbWUgcnVsZXMKICogICAgICBhcHBseS4KICogIC0gTWF5IG5lZWQgdG8gY2FsbCBgJHVwZGF0ZVZpZXcoKWAgbWFudWFsbHk6CiAqICAgIC0gV2lkZ2V0cyAvIERpcmVjdGl2ZXM6IElmIHlvdSBsaXN0ZW4gdG8gYW55IERPTSBldmVudHMgb3IgZXZlbnRzIG9uIGFueSB0aGlyZCBwYXJ0eQogKiAgICAgIGxpYnJhcmllcywgdGhlbiBhbmd1bGFyIGlzIG5vdCBhd2FyZSB0aGF0IHlvdSBtYXkgaGF2ZSBjaGFuZ2VkIHN0YXRlIHN0YXRlIG9mIHRoZQogKiAgICAgIG1vZGVsLCBhbmQgaGVuY2UgeW91IG5lZWQgdG8gY2FsbCAnJHVwZGF0ZVZpZXcoKScgbWFudWFsbHkuCiAqICAgIC0gJ3NldFRpbWVvdXQnLydYSFInOiAgSWYgeW91IGNhbGwgJ3NldFRpbWVvdXQnIChpbnN0ZWFkIG9mIHtAbGluayBhbmd1bGFyLnNlcnZpY2UuJGRlZmVyfSkKICogICAgICBvciAnWEhSJyAoaW5zdGVhZCBvZiB7QGxpbmsgYW5ndWxhci5zZXJ2aWNlLiR4aHJ9KSB0aGVuIHlvdSBtYXkgYmUgY2hhbmdpbmcgdGhlIG1vZGVsCiAqICAgICAgd2l0aG91dCBhbmd1bGFyIGtub3dsZWRnZSBhbmQgeW91IG1heSBuZWVkIHRvIGNhbGwgJyR1cGRhdGVWaWV3KCknIGRpcmVjdGx5LgogKgogKiBOb3RlOiBpZiB5b3Ugd2lzaCB0byB1cGRhdGUgdGhlIHZpZXcgaW1tZWRpYXRlbHkgKHdpdGhvdXQgZGVsYXkpLCB5b3UgY2FuIGRvIHNvIGJ5IGNhbGxpbmcKICoge0BsaW5rIGFuZ3VsYXIuc2NvcGUuJGV2YWx9IGF0IGFueSB0aW1lIGZyb20geW91ciBjb2RlOgogKiA8cHJlPnNjb3BlLiRyb290LiRldmFsKCk8L3ByZT4KICoKICogSW4gdW5pdC10ZXN0IG1vZGUgdGhlIHVwZGF0ZSBpcyBpbnN0YW50YW5lb3VzIGFuZCBzeW5jaHJvbm91cyB0byBzaW1wbGlmeSB3cml0aW5nIHRlc3RzLgogKgogKi8KCmZ1bmN0aW9uIHNlcnZpY2VVcGRhdGVWaWV3RmFjdG9yeSgkYnJvd3Nlcil7CiAgdmFyIHJvb3RTY29wZSA9IHRoaXM7CiAgdmFyIHNjaGVkdWxlZDsKICBmdW5jdGlvbiB1cGRhdGUoKXsKICAgIHNjaGVkdWxlZCA9IGZhbHNlOwogICAgcm9vdFNjb3BlLiRldmFsKCk7CiAgfQogIHJldHVybiAkYnJvd3Nlci5pc01vY2sgPyB1cGRhdGUgOiBmdW5jdGlvbigpewogICAgaWYgKCFzY2hlZHVsZWQpIHsKICAgICAgc2NoZWR1bGVkID0gdHJ1ZTsKICAgICAgJGJyb3dzZXIuZGVmZXIodXBkYXRlLCBzZXJ2aWNlVXBkYXRlVmlld0ZhY3RvcnkuZGVsYXkpOwogICAgfQogIH07Cn0Kc2VydmljZVVwZGF0ZVZpZXdGYWN0b3J5LmRlbGF5ID0gMjU7Cgphbmd1bGFyU2VydmljZUluamVjdCgnJHVwZGF0ZVZpZXcnLCBzZXJ2aWNlVXBkYXRlVmlld0ZhY3RvcnksIFsnJGJyb3dzZXInXSk7Cid1c2Ugc3RyaWN0JzsKCi8qKgogKiBAd29ya0luUHJvZ3Jlc3MKICogQG5nZG9jIHNlcnZpY2UKICogQG5hbWUgYW5ndWxhci5zZXJ2aWNlLiR3aW5kb3cKICoKICogQGRlc2NyaXB0aW9uCiAqIEEgcmVmZXJlbmNlIHRvIHRoZSBicm93c2VyJ3MgYHdpbmRvd2Agb2JqZWN0LiBXaGlsZSBgd2luZG93YAogKiBpcyBnbG9iYWxseSBhdmFpbGFibGUgaW4gSmF2YVNjcmlwdCwgaXQgY2F1c2VzIHRlc3RhYmlsaXR5IHByb2JsZW1zLCBiZWNhdXNlCiAqIGl0IGlzIGEgZ2xvYmFsIHZhcmlhYmxlLiBJbiBhbmd1bGFyIHdlIGFsd2F5cyByZWZlciB0byBpdCB0aHJvdWdoIHRoZQogKiBgJHdpbmRvd2Agc2VydmljZSwgc28gaXQgbWF5IGJlIG92ZXJyaWRlbiwgcmVtb3ZlZCBvciBtb2NrZWQgZm9yIHRlc3RpbmcuCiAqCiAqIEFsbCBleHByZXNzaW9ucyBhcmUgZXZhbHVhdGVkIHdpdGggcmVzcGVjdCB0byBjdXJyZW50IHNjb3BlIHNvIHRoZXkgZG9uJ3QKICogc3VmZmVyIGZyb20gd2luZG93IGdsb2JhbGl0eS4KICoKICogQGV4YW1wbGUKICAgPGRvYzpleGFtcGxlPgogICAgIDxkb2M6c291cmNlPgogICAgICAgPGlucHV0IG5nOmluaXQ9IiR3aW5kb3cgPSAkc2VydmljZSgnJHdpbmRvdycpOyBncmVldGluZz0nSGVsbG8gV29ybGQhJyIgdHlwZT0idGV4dCIgbmFtZT0iZ3JlZXRpbmciIC8+CiAgICAgICA8YnV0dG9uIG5nOmNsaWNrPSIkd2luZG93LmFsZXJ0KGdyZWV0aW5nKSI+QUxFUlQ8L2J1dHRvbj4KICAgICA8L2RvYzpzb3VyY2U+CiAgICAgPGRvYzpzY2VuYXJpbz4KICAgICA8L2RvYzpzY2VuYXJpbz4KICAgPC9kb2M6ZXhhbXBsZT4KICovCmFuZ3VsYXJTZXJ2aWNlSW5qZWN0KCIkd2luZG93IiwgYmluZCh3aW5kb3csIGlkZW50aXR5LCB3aW5kb3cpKTsKJ3VzZSBzdHJpY3QnOwoKLyoqCiAqIEB3b3JrSW5Qcm9ncmVzcwogKiBAbmdkb2Mgc2VydmljZQogKiBAbmFtZSBhbmd1bGFyLnNlcnZpY2UuJHhoci5idWxrCiAqIEByZXF1aXJlcyAkeGhyCiAqIEByZXF1aXJlcyAkeGhyLmVycm9yCiAqIEByZXF1aXJlcyAkbG9nCiAqCiAqIEBkZXNjcmlwdGlvbgogKgogKiBAZXhhbXBsZQogKi8KYW5ndWxhclNlcnZpY2VJbmplY3QoJyR4aHIuYnVsaycsIGZ1bmN0aW9uKCR4aHIsICRlcnJvciwgJGxvZyl7CiAgdmFyIHJlcXVlc3RzID0gW10sCiAgICAgIHNjb3BlID0gdGhpczsKICBmdW5jdGlvbiBidWxrWEhSKG1ldGhvZCwgdXJsLCBwb3N0LCBzdWNjZXNzLCBlcnJvcikgewogICAgaWYgKGlzRnVuY3Rpb24ocG9zdCkpIHsKICAgICAgZXJyb3IgPSBzdWNjZXNzOwogICAgICBzdWNjZXNzID0gcG9zdDsKICAgICAgcG9zdCA9IG51bGw7CiAgICB9CiAgICB2YXIgY3VycmVudFF1ZXVlOwogICAgZm9yRWFjaChidWxrWEhSLnVybHMsIGZ1bmN0aW9uKHF1ZXVlKXsKICAgICAgaWYgKGlzRnVuY3Rpb24ocXVldWUubWF0Y2gpID8gcXVldWUubWF0Y2godXJsKSA6IHF1ZXVlLm1hdGNoLmV4ZWModXJsKSkgewogICAgICAgIGN1cnJlbnRRdWV1ZSA9IHF1ZXVlOwogICAgICB9CiAgICB9KTsKICAgIGlmIChjdXJyZW50UXVldWUpIHsKICAgICAgaWYgKCFjdXJyZW50UXVldWUucmVxdWVzdHMpIGN1cnJlbnRRdWV1ZS5yZXF1ZXN0cyA9IFtdOwogICAgICB2YXIgcmVxdWVzdCA9IHsKICAgICAgICAgIG1ldGhvZDogbWV0aG9kLAogICAgICAgICAgdXJsOiB1cmwsCiAgICAgICAgICBkYXRhOiBwb3N0LAogICAgICAgICAgc3VjY2Vzczogc3VjY2Vzc307CiAgICAgIGlmIChlcnJvcikgcmVxdWVzdC5lcnJvciA9IGVycm9yOwogICAgICBjdXJyZW50UXVldWUucmVxdWVzdHMucHVzaChyZXF1ZXN0KTsKICAgIH0gZWxzZSB7CiAgICAgICR4aHIobWV0aG9kLCB1cmwsIHBvc3QsIHN1Y2Nlc3MsIGVycm9yKTsKICAgIH0KICB9CiAgYnVsa1hIUi51cmxzID0ge307CiAgYnVsa1hIUi5mbHVzaCA9IGZ1bmN0aW9uKHN1Y2Nlc3MsIGVycm9yKSB7CiAgICBmb3JFYWNoKGJ1bGtYSFIudXJscywgZnVuY3Rpb24ocXVldWUsIHVybCkgewogICAgICB2YXIgY3VycmVudFJlcXVlc3RzID0gcXVldWUucmVxdWVzdHM7CiAgICAgIGlmIChjdXJyZW50UmVxdWVzdHMgJiYgY3VycmVudFJlcXVlc3RzLmxlbmd0aCkgewogICAgICAgIHF1ZXVlLnJlcXVlc3RzID0gW107CiAgICAgICAgcXVldWUuY2FsbGJhY2tzID0gW107CiAgICAgICAgJHhocignUE9TVCcsIHVybCwge3JlcXVlc3RzOiBjdXJyZW50UmVxdWVzdHN9LAogICAgICAgICAgZnVuY3Rpb24oY29kZSwgcmVzcG9uc2UsIHJlc3BvbnNlSGVhZGVycykgewogICAgICAgICAgICBmb3JFYWNoKHJlc3BvbnNlLCBmdW5jdGlvbihyZXNwb25zZSwgaSkgewogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBpZiAocmVzcG9uc2Uuc3RhdHVzID09IDIwMCkgewogICAgICAgICAgICAgICAgICAoY3VycmVudFJlcXVlc3RzW2ldLnN1Y2Nlc3MgfHwgbm9vcCkKICAgICAgICAgICAgICAgICAgICAgIChyZXNwb25zZS5zdGF0dXMsIHJlc3BvbnNlLnJlc3BvbnNlLCByZXNwb25zZUhlYWRlcnMpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChpc0Z1bmN0aW9uKGN1cnJlbnRSZXF1ZXN0c1tpXS5lcnJvcikpIHsKICAgICAgICAgICAgICAgICAgICBjdXJyZW50UmVxdWVzdHNbaV0uZXJyb3IocmVzcG9uc2Uuc3RhdHVzLCByZXNwb25zZS5yZXNwb25zZSwgcmVzcG9uc2VIZWFkZXJzKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICRlcnJvcihjdXJyZW50UmVxdWVzdHNbaV0sIHJlc3BvbnNlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGNhdGNoKGUpIHsKICAgICAgICAgICAgICAgICRsb2cuZXJyb3IoZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgKHN1Y2Nlc3MgfHwgbm9vcCkoKTsKICAgICAgICAgIH0sCiAgICAgICAgICBmdW5jdGlvbihjb2RlLCByZXNwb25zZSwgcmVzcG9uc2VIZWFkZXJzKSB7CiAgICAgICAgICAgIGZvckVhY2goY3VycmVudFJlcXVlc3RzLCBmdW5jdGlvbihyZXF1ZXN0LCBpKSB7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGlmIChpc0Z1bmN0aW9uKHJlcXVlc3QuZXJyb3IpKSB7CiAgICAgICAgICAgICAgICAgIHJlcXVlc3QuZXJyb3IoY29kZSwgcmVzcG9uc2UsIHJlc3BvbnNlSGVhZGVycyk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAkZXJyb3IocmVxdWVzdCwgcmVzcG9uc2UpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gY2F0Y2goZSkgewogICAgICAgICAgICAgICAgJGxvZy5lcnJvcihlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAoZXJyb3IgfHwgbm9vcCkoKTsKICAgICAgICAgIH0pOwogICAgICAgIHNjb3BlLiRldmFsKCk7CiAgICAgIH0KICAgIH0pOwogIH07CiAgdGhpcy4kb25FdmFsKFBSSU9SSVRZX0xBU1QsIGJ1bGtYSFIuZmx1c2gpOwogIHJldHVybiBidWxrWEhSOwp9LCBbJyR4aHInLCAnJHhoci5lcnJvcicsICckbG9nJ10pOwondXNlIHN0cmljdCc7CgovKioKICogQHdvcmtJblByb2dyZXNzCiAqIEBuZ2RvYyBzZXJ2aWNlCiAqIEBuYW1lIGFuZ3VsYXIuc2VydmljZS4keGhyLmNhY2hlCiAqIEBmdW5jdGlvbgogKgogKiBAcmVxdWlyZXMgJHhoci5idWxrCiAqIEByZXF1aXJlcyAkZGVmZXIKICogQHJlcXVpcmVzICR4aHIuZXJyb3IKICogQHJlcXVpcmVzICRsb2cKICoKICogQGRlc2NyaXB0aW9uCiAqIEFjdHMganVzdCBsaWtlIHRoZSB7QGxpbmsgYW5ndWxhci5zZXJ2aWNlLiR4aHIgJHhocn0gc2VydmljZSBidXQgY2FjaGVzIHJlc3BvbnNlcyBmb3IgYEdFVGAKICogcmVxdWVzdHMuIEFsbCBjYWNoZSBtaXNzZXMgYXJlIGRlbGVnYXRlZCB0byB0aGUgJHhociBzZXJ2aWNlLgogKgogKiBAcHJvcGVydHkge2Z1bmN0aW9uKCl9IGRlbGVnYXRlIEZ1bmN0aW9uIHRvIGRlbGVnYXRlIGFsbCB0aGUgY2FjaGUgbWlzc2VzIHRvLiBEZWZhdWx0cyB0bwogKiAgIHRoZSB7QGxpbmsgYW5ndWxhci5zZXJ2aWNlLiR4aHIgJHhocn0gc2VydmljZS4KICogQHByb3BlcnR5IHtvYmplY3R9IGRhdGEgVGhlIGhhc2htYXAgd2hlcmUgYWxsIGNhY2hlZCBlbnRyaWVzIGFyZSBzdG9yZWQuCiAqCiAqIEBwYXJhbSB7c3RyaW5nfSBtZXRob2QgSFRUUCBtZXRob2QuCiAqIEBwYXJhbSB7c3RyaW5nfSB1cmwgRGVzdGluYXRpb24gVVJMLgogKiBAcGFyYW0geyhzdHJpbmd8T2JqZWN0KT19IHBvc3QgUmVxdWVzdCBib2R5LgogKiBAcGFyYW0ge2Z1bmN0aW9uKG51bWJlciwgKHN0cmluZ3xPYmplY3QpLCBGdW5jdGlvbil9IHN1Y2Nlc3MgUmVzcG9uc2Ugc3VjY2VzcyBjYWxsYmFjay4KICogQHBhcmFtIHtmdW5jdGlvbihudW1iZXIsIChzdHJpbmd8T2JqZWN0KSwgRnVuY3Rpb24pfSBlcnJvciBSZXNwb25zZSBlcnJvciBjYWxsYmFjay4KICogQHBhcmFtIHtib29sZWFuPX0gW3ZlcmlmeUNhY2hlPWZhbHNlXSBJZiBgdHJ1ZWAgdGhlbiBhIHJlc3VsdCBpcyBpbW1lZGlhdGVseSByZXR1cm5lZCBmcm9tIGNhY2hlCiAqICAgKGlmIHByZXNlbnQpIHdoaWxlIGEgcmVxdWVzdCBpcyBzZW50IHRvIHRoZSBzZXJ2ZXIgZm9yIGEgZnJlc2ggcmVzcG9uc2UgdGhhdCB3aWxsIHVwZGF0ZSB0aGUKICogICBjYWNoZWQgZW50cnkuIFRoZSBgc3VjY2Vzc2AgZnVuY3Rpb24gd2lsbCBiZSBjYWxsZWQgd2hlbiB0aGUgcmVzcG9uc2UgaXMgcmVjZWl2ZWQuCiAqIEBwYXJhbSB7Ym9vbGVhbj19IFtzeW5jPWZhbHNlXSBpbiBjYXNlIG9mIGNhY2hlIGhpdCBleGVjdXRlIGBzdWNjZXNzYCBzeW5jaHJvbm91c2x5LgogKi8KYW5ndWxhclNlcnZpY2VJbmplY3QoJyR4aHIuY2FjaGUnLCBmdW5jdGlvbigkeGhyLCAkZGVmZXIsICRlcnJvciwgJGxvZykgewogIHZhciBpbmZsaWdodCA9IHt9LCBzZWxmID0gdGhpczsKICBmdW5jdGlvbiBjYWNoZShtZXRob2QsIHVybCwgcG9zdCwgc3VjY2VzcywgZXJyb3IsIHZlcmlmeUNhY2hlLCBzeW5jKSB7CiAgICBpZiAoaXNGdW5jdGlvbihwb3N0KSkgewogICAgICBpZiAoIWlzRnVuY3Rpb24oc3VjY2VzcykpIHsKICAgICAgICB2ZXJpZnlDYWNoZSA9IHN1Y2Nlc3M7CiAgICAgICAgc3luYyA9IGVycm9yOwogICAgICAgIGVycm9yID0gbnVsbDsKICAgICAgfSBlbHNlIHsKICAgICAgICBzeW5jID0gdmVyaWZ5Q2FjaGU7CiAgICAgICAgdmVyaWZ5Q2FjaGUgPSBlcnJvcjsKICAgICAgICBlcnJvciA9IHN1Y2Nlc3M7CiAgICAgIH0KICAgICAgc3VjY2VzcyA9IHBvc3Q7CiAgICAgIHBvc3QgPSBudWxsOwogICAgfSBlbHNlIGlmICghaXNGdW5jdGlvbihlcnJvcikpIHsKICAgICAgc3luYyA9IHZlcmlmeUNhY2hlOwogICAgICB2ZXJpZnlDYWNoZSA9IGVycm9yOwogICAgICBlcnJvciA9IG51bGw7CiAgICB9CgogICAgaWYgKG1ldGhvZCA9PSAnR0VUJykgewogICAgICB2YXIgZGF0YSwgZGF0YUNhY2hlZDsKICAgICAgaWYgKGRhdGFDYWNoZWQgPSBjYWNoZS5kYXRhW3VybF0pIHsKCiAgICAgICAgaWYgKHN5bmMpIHsKICAgICAgICAgIHN1Y2Nlc3MoMjAwLCBjb3B5KGRhdGFDYWNoZWQudmFsdWUpLCBjb3B5KGRhdGFDYWNoZWQuaGVhZGVycykpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAkZGVmZXIoZnVuY3Rpb24oKSB7IHN1Y2Nlc3MoMjAwLCBjb3B5KGRhdGFDYWNoZWQudmFsdWUpLCBjb3B5KGRhdGFDYWNoZWQuaGVhZGVycykpOyB9KTsKICAgICAgICB9CgogICAgICAgIGlmICghdmVyaWZ5Q2FjaGUpCiAgICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIGlmIChkYXRhID0gaW5mbGlnaHRbdXJsXSkgewogICAgICAgIGRhdGEuc3VjY2Vzc2VzLnB1c2goc3VjY2Vzcyk7CiAgICAgICAgZGF0YS5lcnJvcnMucHVzaChlcnJvcik7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaW5mbGlnaHRbdXJsXSA9IHtzdWNjZXNzZXM6IFtzdWNjZXNzXSwgZXJyb3JzOiBbZXJyb3JdfTsKICAgICAgICBjYWNoZS5kZWxlZ2F0ZShtZXRob2QsIHVybCwgcG9zdCwKICAgICAgICAgIGZ1bmN0aW9uKHN0YXR1cywgcmVzcG9uc2UsIHJlc3BvbnNlSGVhZGVycykgewogICAgICAgICAgICBpZiAoc3RhdHVzID09IDIwMCkKICAgICAgICAgICAgICBjYWNoZS5kYXRhW3VybF0gPSB7dmFsdWU6IHJlc3BvbnNlLCBoZWFkZXJzOiByZXNwb25zZUhlYWRlcnN9OwogICAgICAgICAgICB2YXIgc3VjY2Vzc2VzID0gaW5mbGlnaHRbdXJsXS5zdWNjZXNzZXM7CiAgICAgICAgICAgIGRlbGV0ZSBpbmZsaWdodFt1cmxdOwogICAgICAgICAgICBmb3JFYWNoKHN1Y2Nlc3NlcywgZnVuY3Rpb24oc3VjY2VzcykgewogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAoc3VjY2Vzc3x8bm9vcCkoc3RhdHVzLCBjb3B5KHJlc3BvbnNlKSwgcmVzcG9uc2VIZWFkZXJzKTsKICAgICAgICAgICAgICB9IGNhdGNoKGUpIHsKICAgICAgICAgICAgICAgICRsb2cuZXJyb3IoZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0sCiAgICAgICAgICBmdW5jdGlvbihzdGF0dXMsIHJlc3BvbnNlLCByZXNwb25zZUhlYWRlcnMpIHsKICAgICAgICAgICAgdmFyIGVycm9ycyA9IGluZmxpZ2h0W3VybF0uZXJyb3JzLAogICAgICAgICAgICAgICAgc3VjY2Vzc2VzID0gaW5mbGlnaHRbdXJsXS5zdWNjZXNzZXM7CiAgICAgICAgICAgIGRlbGV0ZSBpbmZsaWdodFt1cmxdOwoKICAgICAgICAgICAgZm9yRWFjaChlcnJvcnMsIGZ1bmN0aW9uKGVycm9yLCBpKSB7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGlmIChpc0Z1bmN0aW9uKGVycm9yKSkgewogICAgICAgICAgICAgICAgICBlcnJvcihzdGF0dXMsIGNvcHkocmVzcG9uc2UpLCBjb3B5KHJlc3BvbnNlSGVhZGVycykpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgJGVycm9yKAogICAgICAgICAgICAgICAgICAgIHttZXRob2Q6IG1ldGhvZCwgdXJsOiB1cmwsIGRhdGE6IHBvc3QsIHN1Y2Nlc3M6IHN1Y2Nlc3Nlc1tpXX0sCiAgICAgICAgICAgICAgICAgICAge3N0YXR1czogc3RhdHVzLCBib2R5OiByZXNwb25zZX0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gY2F0Y2goZSkgewogICAgICAgICAgICAgICAgJGxvZy5lcnJvcihlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSk7CiAgICAgIH0KCiAgICB9IGVsc2UgewogICAgICBjYWNoZS5kYXRhID0ge307CiAgICAgIGNhY2hlLmRlbGVnYXRlKG1ldGhvZCwgdXJsLCBwb3N0LCBzdWNjZXNzLCBlcnJvcik7CiAgICB9CiAgfQogIGNhY2hlLmRhdGEgPSB7fTsKICBjYWNoZS5kZWxlZ2F0ZSA9ICR4aHI7CiAgcmV0dXJuIGNhY2hlOwp9LCBbJyR4aHIuYnVsaycsICckZGVmZXInLCAnJHhoci5lcnJvcicsICckbG9nJ10pOwondXNlIHN0cmljdCc7CgovKioKICogQHdvcmtJblByb2dyZXNzCiAqIEBuZ2RvYyBzZXJ2aWNlCiAqIEBuYW1lIGFuZ3VsYXIuc2VydmljZS4keGhyLmVycm9yCiAqIEBmdW5jdGlvbgogKiBAcmVxdWlyZXMgJGxvZwogKgogKiBAZGVzY3JpcHRpb24KICogRXJyb3IgaGFuZGxlciBmb3Ige0BsaW5rIGFuZ3VsYXIuc2VydmljZS4keGhyICR4aHIgc2VydmljZX0uIEFuIGFwcGxpY2F0aW9uIGNhbiByZXBsYWNlcyB0aGlzCiAqIHNlcnZpY2Ugd2l0aCBvbmUgc3BlY2lmaWMgZm9yIHRoZSBhcHBsaWNhdGlvbi4gVGhlIGRlZmF1bHQgaW1wbGVtZW50YXRpb24gbG9ncyB0aGUgZXJyb3IgdG8KICoge0BsaW5rIGFuZ3VsYXIuc2VydmljZS4kbG9nICRsb2cuZXJyb3J9LgogKgogKiBAcGFyYW0ge09iamVjdH0gcmVxdWVzdCBSZXF1ZXN0IG9iamVjdC4KICoKICogICBUaGUgb2JqZWN0IGhhcyB0aGUgZm9sbG93aW5nIHByb3BlcnRpZXMKICoKICogICAtIGBtZXRob2RgIOKAkyBge3N0cmluZ31gIOKAkyBUaGUgaHR0cCByZXF1ZXN0IG1ldGhvZC4KICogICAtIGB1cmxgIOKAkyBge3N0cmluZ31gIOKAkyBUaGUgcmVxdWVzdCBkZXN0aW5hdGlvbi4KICogICAtIGBkYXRhYCDigJMgYHsoc3RyaW5nfE9iamVjdCk9fSDigJMgQW4gb3B0aW9uYWwgcmVxdWVzdCBib2R5LgogKiAgIC0gYHN1Y2Nlc3NgIOKAkyBge2Z1bmN0aW9uKCl9YCDigJMgVGhlIHN1Y2Nlc3MgY2FsbGJhY2sgZnVuY3Rpb24KICoKICogQHBhcmFtIHtPYmplY3R9IHJlc3BvbnNlIFJlc3BvbnNlIG9iamVjdC4KICoKICogICBUaGUgcmVzcG9uc2Ugb2JqZWN0IGhhcyB0aGUgZm9sbG93aW5nIHByb3BlcnRpZXM6CiAqCiAqICAgLSBzdGF0dXMg4oCTIHtudW1iZXJ9IOKAkyBIdHRwIHN0YXR1cyBjb2RlLgogKiAgIC0gYm9keSDigJMge3N0cmluZ3xPYmplY3R9IOKAkyBCb2R5IG9mIHRoZSByZXNwb25zZS4KICoKICogQGV4YW1wbGUKICAgIDxkb2M6ZXhhbXBsZT4KICAgICAgPGRvYzpzb3VyY2U+CiAgICAgICAgZmV0Y2ggYSBub24tZXhpc3RlbnQgZmlsZSBhbmQgbG9nIGFuIGVycm9yIGluIHRoZSBjb25zb2xlOgogICAgICAgIDxidXR0b24gbmc6Y2xpY2s9IiRzZXJ2aWNlKCckeGhyJykoJ0dFVCcsICcvRE9FU05UX0VYSVNUJykiPmZldGNoPC9idXR0b24+CiAgICAgIDwvZG9jOnNvdXJjZT4KICAgIDwvZG9jOmV4YW1wbGU+CiAqLwphbmd1bGFyU2VydmljZUluamVjdCgnJHhoci5lcnJvcicsIGZ1bmN0aW9uKCRsb2cpewogIHJldHVybiBmdW5jdGlvbihyZXF1ZXN0LCByZXNwb25zZSl7CiAgICAkbG9nLmVycm9yKCdFUlJPUjogWEhSOiAnICsgcmVxdWVzdC51cmwsIHJlcXVlc3QsIHJlc3BvbnNlKTsKICB9Owp9LCBbJyRsb2cnXSk7Cid1c2Ugc3RyaWN0JzsKCi8qKgogKiBAd29ya0luUHJvZ3Jlc3MKICogQG5nZG9jIHNlcnZpY2UKICogQG5hbWUgYW5ndWxhci5zZXJ2aWNlLiR4aHIKICogQGZ1bmN0aW9uCiAqIEByZXF1aXJlcyAkYnJvd3NlciAkeGhyIGRlbGVnYXRlcyBhbGwgWEhSIHJlcXVlc3RzIHRvIHRoZSBgJGJyb3dzZXIueGhyKClgLiBBIG1vY2sgdmVyc2lvbgogKiAgICAgICAgICAgICAgICAgICAgb2YgdGhlICRicm93c2VyIGV4aXN0cyB3aGljaCBhbGxvd3Mgc2V0dGluZyBleHBlY3RhdGlvbnMgb24gWEhSIHJlcXVlc3RzCiAqICAgICAgICAgICAgICAgICAgICBpbiB5b3VyIHRlc3RzCiAqIEByZXF1aXJlcyAkeGhyLmVycm9yICR4aHIgZGVsZWdhdGVzIGFsbCBub24gYDJ4eGAgcmVzcG9uc2UgY29kZSB0byB0aGlzIHNlcnZpY2UuCiAqIEByZXF1aXJlcyAkbG9nICR4aHIgZGVsZWdhdGVzIGFsbCBleGNlcHRpb25zIHRvIGAkbG9nLmVycm9yKClgLgogKiBAcmVxdWlyZXMgJHVwZGF0ZVZpZXcgQWZ0ZXIgYSBzZXJ2ZXIgcmVzcG9uc2UgdGhlIHZpZXcgbmVlZHMgdG8gYmUgdXBkYXRlZCBmb3IgZGF0YS1iaW5kaW5nIHRvCiAqICAgICAgICAgICB0YWtlIGVmZmVjdC4KICoKICogQGRlc2NyaXB0aW9uCiAqIEdlbmVyYXRlcyBhbiBYSFIgcmVxdWVzdC4gVGhlICR4aHIgc2VydmljZSBkZWxlZ2F0ZXMgYWxsIHJlcXVlc3RzIHRvCiAqIHtAbGluayBhbmd1bGFyLnNlcnZpY2UuJGJyb3dzZXIgJGJyb3dzZXIueGhyKCl9IGFuZCBhZGRzIGVycm9yIGhhbmRsaW5nIGFuZCBzZWN1cml0eSBmZWF0dXJlcy4KICogV2hpbGUgJHhociBzZXJ2aWNlIHByb3ZpZGVzIG5pY2VyIGFwaSB0aGFuIHJhdyBYbWxIdHRwUmVxdWVzdCwgaXQgaXMgc3RpbGwgY29uc2lkZXJlZCBhIGxvd2VyCiAqIGxldmVsIGFwaSBpbiBhbmd1bGFyLiBGb3IgYSBoaWdoZXIgbGV2ZWwgYWJzdHJhY3Rpb24gdGhhdCB1dGlsaXplcyBgJHhocmAsIHBsZWFzZSBjaGVjayBvdXQgdGhlCiAqIHtAbGluayBhbmd1bGFyLnNlcnZpY2UuJHJlc291cmNlICRyZXNvdXJjZX0gc2VydmljZS4KICoKICogIyBFcnJvciBoYW5kbGluZwogKiBJZiBubyBgZXJyb3IgY2FsbGJhY2tgIGlzIHNwZWNpZmllZCwgWEhSIHJlc3BvbnNlIHdpdGggcmVzcG9uc2UgY29kZSBvdGhlciB0aGVuIGAyeHhgIHdpbGwgYmUKICogZGVsZWdhdGVkIHRvIHtAbGluayBhbmd1bGFyLnNlcnZpY2UuJHhoci5lcnJvciAkeGhyLmVycm9yfS4gVGhlIGAkeGhyLmVycm9yYCBjYW4gaW50ZXJjZXB0IHRoZQogKiByZXF1ZXN0IGFuZCBwcm9jZXNzIGl0IGluIGFwcGxpY2F0aW9uIHNwZWNpZmljIHdheSwgb3IgcmVzdW1lIG5vcm1hbCBleGVjdXRpb24gYnkgY2FsbGluZyB0aGUKICogcmVxdWVzdCBgc3VjY2Vzc2AgbWV0aG9kLgogKgogKiAjIEhUVFAgSGVhZGVycwogKiBUaGUgJHhociBzZXJ2aWNlIHdpbGwgYXV0b21hdGljYWxseSBhZGQgY2VydGFpbiBodHRwIGhlYWRlcnMgdG8gYWxsIHJlcXVlc3RzLiBUaGVzZSBkZWZhdWx0cyBjYW4KICogYmUgZnVsbHkgY29uZmlndXJlZCBieSBhY2Nlc3NpbmcgdGhlIGAkeGhyLmRlZmF1bHRzLmhlYWRlcnNgIGNvbmZpZ3VyYXRpb24gb2JqZWN0LCB3aGljaAogKiBjdXJyZW50bHkgY29udGFpbnMgdGhpcyBkZWZhdWx0IGNvbmZpZ3VyYXRpb246CiAqCiAqIC0gYCR4aHIuZGVmYXVsdHMuaGVhZGVycy5jb21tb25gIChoZWFkZXJzIHRoYXQgYXJlIGNvbW1vbiBmb3IgYWxsIHJlcXVlc3RzKToKICogICAtIGBBY2NlcHQ6IGFwcGxpY2F0aW9uL2pzb24sIHRleHQvcGxhaW4sICpcLypgCiAqICAgLSBgWC1SZXF1ZXN0ZWQtV2l0aDogWE1MSHR0cFJlcXVlc3RgCiAqIC0gYCR4aHIuZGVmYXVsdHMuaGVhZGVycy5wb3N0YCAoaGVhZGVyIGRlZmF1bHRzIGZvciBIVFRQIFBPU1QgcmVxdWVzdHMpOgogKiAgIC0gYENvbnRlbnQtVHlwZTogYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkYAogKgogKiBUbyBhZGQgb3Igb3ZlcndyaXRlIHRoZXNlIGRlZmF1bHRzLCBzaW1wbGUgYWRkIG9yIHJlbW92ZSBhIHByb3BlcnR5IGZyb20gdGhpcyBjb25maWd1cmF0aW9uCiAqIG9iamVjdC4gVG8gYWRkIGhlYWRlcnMgZm9yIGFuIEhUVFAgbWV0aG9kIG90aGVyIHRoYW4gUE9TVCwgc2ltcGxlIGNyZWF0ZSBhIG5ldyBvYmplY3Qgd2l0aCBuYW1lCiAqIGVxdWFsIHRvIHRoZSBsb3dlcmNhc2VkIGh0dHAgbWV0aG9kIG5hbWUsIGUuZy4gYCR4aHIuZGVmYXVsdHMuaGVhZGVycy5nZXRbJ015LUhlYWRlciddPSd2YWx1ZSdgLgogKgogKgogKiAjIFNlY3VyaXR5IENvbnNpZGVyYXRpb25zCiAqIFdoZW4gZGVzaWduaW5nIHdlYiBhcHBsaWNhdGlvbnMgeW91ciBkZXNpZ24gbmVlZHMgdG8gY29uc2lkZXIgc2VjdXJpdHkgdGhyZWF0cyBmcm9tCiAqIHtAbGluayBodHRwOi8vaGFhY2tlZC5jb20vYXJjaGl2ZS8yMDA4LzExLzIwL2FuYXRvbXktb2YtYS1zdWJ0bGUtanNvbi12dWxuZXJhYmlsaXR5LmFzcHgKICogSlNPTiBWdWxuZXJhYmlsaXR5fSBhbmQge0BsaW5rIGh0dHA6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvQ3Jvc3Mtc2l0ZV9yZXF1ZXN0X2ZvcmdlcnkgWFNSRn0uCiAqIEJvdGggc2VydmVyIGFuZCB0aGUgY2xpZW50IG11c3QgY29vcGVyYXRlIGluIG9yZGVyIHRvIGVsaW1pbmF0ZSB0aGVzZSB0aHJlYXRzLiBBbmd1bGFyIGNvbWVzCiAqIHByZS1jb25maWd1cmVkIHdpdGggc3RyYXRlZ2llcyB0aGF0IGFkZHJlc3MgdGhlc2UgaXNzdWVzLCBidXQgZm9yIHRoaXMgdG8gd29yayBiYWNrZW5kIHNlcnZlcgogKiBjb29wZXJhdGlvbiBpcyByZXF1aXJlZC4KICoKICogIyMgSlNPTiBWdWxuZXJhYmlsaXR5IFByb3RlY3Rpb24KICogQSB7QGxpbmsgaHR0cDovL2hhYWNrZWQuY29tL2FyY2hpdmUvMjAwOC8xMS8yMC9hbmF0b215LW9mLWEtc3VidGxlLWpzb24tdnVsbmVyYWJpbGl0eS5hc3B4CiAqIEpTT04gVnVsbmVyYWJpbGl0eX0gYWxsb3dzIHRoaXJkIHBhcnR5IHdlYi1zaXRlIHRvIHR1cm4geW91ciBKU09OIHJlc291cmNlIFVSTCBpbnRvCiAqIHtAbGluayBodHRwOi8vZW4ud2lraXBlZGlhLm9yZy93aWtpL0pTT04jSlNPTlAgSlNPTlB9IHJlcXVlc3QgdW5kZXIgc29tZSBjb25kaXRpb25zLiBUbwogKiBjb3VudGVyIHRoaXMgeW91ciBzZXJ2ZXIgY2FuIHByZWZpeCBhbGwgSlNPTiByZXF1ZXN0cyB3aXRoIGZvbGxvd2luZyBzdHJpbmcgYCIpXX0nLFxuImAuCiAqIEFuZ3VsYXIgd2lsbCBhdXRvbWF0aWNhbGx5IHN0cmlwIHRoZSBwcmVmaXggYmVmb3JlIHByb2Nlc3NpbmcgaXQgYXMgSlNPTi4KICoKICogRm9yIGV4YW1wbGUgaWYgeW91ciBzZXJ2ZXIgbmVlZHMgdG8gcmV0dXJuOgogKiA8cHJlPgogKiBbJ29uZScsJ3R3byddCiAqIDwvcHJlPgogKgogKiB3aGljaCBpcyB2dWxuZXJhYmxlIHRvIGF0dGFjaywgeW91ciBzZXJ2ZXIgY2FuIHJldHVybjoKICogPHByZT4KICogKV19JywKICogWydvbmUnLCd0d28nXQogKiA8L3ByZT4KICoKICogYW5ndWxhciB3aWxsIHN0cmlwIHRoZSBwcmVmaXgsIGJlZm9yZSBwcm9jZXNzaW5nIHRoZSBKU09OLgogKgogKgogKiAjIyBDcm9zcyBTaXRlIFJlcXVlc3QgRm9yZ2VyeSAoWFNSRikgUHJvdGVjdGlvbgogKiB7QGxpbmsgaHR0cDovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9Dcm9zcy1zaXRlX3JlcXVlc3RfZm9yZ2VyeSBYU1JGfSBpcyBhIHRlY2huaXF1ZSBieSB3aGljaCBhbgogKiB1bmF1dGhvcml6ZWQgc2l0ZSBjYW4gZ2FpbiB5b3VyIHVzZXIncyBwcml2YXRlIGRhdGEuIEFuZ3VsYXIgcHJvdmlkZXMgZm9sbG93aW5nIG1lY2hhbmlzbSB0bwogKiBjb3VudGVyIFhTUkYuIFdoZW4gcGVyZm9ybWluZyBYSFIgcmVxdWVzdHMsIHRoZSAkeGhyIHNlcnZpY2UgcmVhZHMgYSB0b2tlbiBmcm9tIGEgY29va2llCiAqIGNhbGxlZCBgWFNSRi1UT0tFTmAgYW5kIHNldHMgaXQgYXMgdGhlIEhUVFAgaGVhZGVyIGBYLVhTUkYtVE9LRU5gLiBTaW5jZSBvbmx5IEphdmFTY3JpcHQgdGhhdAogKiBydW5zIG9uIHlvdXIgZG9tYWluIGNvdWxkIHJlYWQgdGhlIGNvb2tpZSwgeW91ciBzZXJ2ZXIgY2FuIGJlIGFzc3VyZWQgdGhhdCB0aGUgWEhSIGNhbWUgZnJvbQogKiBKYXZhU2NyaXB0IHJ1bm5pbmcgb24geW91ciBkb21haW4uCiAqCiAqIFRvIHRha2UgYWR2YW50YWdlIG9mIHRoaXMsIHlvdXIgc2VydmVyIG5lZWRzIHRvIHNldCBhIHRva2VuIGluIGEgSmF2YVNjcmlwdCByZWFkYWJsZSBzZXNzaW9uCiAqIGNvb2tpZSBjYWxsZWQgYFhTUkYtVE9LRU5gIG9uIGZpcnN0IEhUVFAgR0VUIHJlcXVlc3QuIE9uIHN1YnNlcXVlbnQgbm9uLUdFVCByZXF1ZXN0cyB0aGUgc2VydmVyCiAqIGNhbiB2ZXJpZnkgdGhhdCB0aGUgY29va2llIG1hdGNoZXMgYFgtWFNSRi1UT0tFTmAgSFRUUCBoZWFkZXIsIGFuZCB0aGVyZWZvcmUgYmUgc3VyZSB0aGF0IG9ubHkKICogSmF2YVNjcmlwdCBydW5uaW5nIG9uIHlvdXIgZG9tYWluIGNvdWxkIGhhdmUgcmVhZCB0aGUgdG9rZW4uIFRoZSB0b2tlbiBtdXN0IGJlIHVuaXF1ZSBmb3IgZWFjaAogKiB1c2VyIGFuZCBtdXN0IGJlIHZlcmlmaWFibGUgYnkgdGhlIHNlcnZlciAodG8gcHJldmVudCB0aGUgSmF2YVNjcmlwdCBtYWtpbmcgdXAgaXRzIG93biB0b2tlbnMpLgogKiBXZSByZWNvbW1lbmQgdGhhdCB0aGUgdG9rZW4gaXMgYSBkaWdlc3Qgb2YgeW91ciBzaXRlJ3MgYXV0aGVudGljYXRpb24gY29va2llIHdpdGgKICoge0BsaW5rIGh0dHA6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvUmFpbmJvd190YWJsZSBzYWx0IGZvciBhZGRlZCBzZWN1cml0eX0uCiAqCiAqIEBwYXJhbSB7c3RyaW5nfSBtZXRob2QgSFRUUCBtZXRob2QgdG8gdXNlLiBWYWxpZCB2YWx1ZXMgYXJlOiBgR0VUYCwgYFBPU1RgLCBgUFVUYCwgYERFTEVURWAsIGFuZAogKiAgIGBKU09OYC4gYEpTT05gIGlzIGEgc3BlY2lhbCBjYXNlIHdoaWNoIGNhdXNlcyBhCiAqICAgW0pTT05QXShodHRwOi8vZW4ud2lraXBlZGlhLm9yZy93aWtpL0pTT04jSlNPTlApIGNyb3NzIGRvbWFpbiByZXF1ZXN0IHVzaW5nIHNjcmlwdCB0YWcKICogICBpbnNlcnRpb24uCiAqIEBwYXJhbSB7c3RyaW5nfSB1cmwgUmVsYXRpdmUgb3IgYWJzb2x1dGUgVVJMIHNwZWNpZnlpbmcgdGhlIGRlc3RpbmF0aW9uIG9mIHRoZSByZXF1ZXN0LiAgRm9yCiAqICAgYEpTT05gIHJlcXVlc3RzLCBgdXJsYCBzaG91bGQgaW5jbHVkZSBgSlNPTl9DQUxMQkFDS2Agc3RyaW5nIHRvIGJlIHJlcGxhY2VkIHdpdGggYSBuYW1lIG9mIGFuCiAqICAgYW5ndWxhciBnZW5lcmF0ZWQgY2FsbGJhY2sgZnVuY3Rpb24uCiAqIEBwYXJhbSB7KHN0cmluZ3xPYmplY3QpPX0gcG9zdCBSZXF1ZXN0IGNvbnRlbnQgYXMgZWl0aGVyIGEgc3RyaW5nIG9yIGFuIG9iamVjdCB0byBiZSBzdHJpbmdpZmllZAogKiAgIGFzIEpTT04gYmVmb3JlIHNlbnQgdG8gdGhlIHNlcnZlci4KICogQHBhcmFtIHtmdW5jdGlvbihudW1iZXIsIChzdHJpbmd8T2JqZWN0KSwgRnVuY3Rpb24pfSBzdWNjZXNzIEEgZnVuY3Rpb24gdG8gYmUgY2FsbGVkIHdoZW4gdGhlIHJlc3BvbnNlIGlzCiAqICAgcmVjZWl2ZWQuIFRoZSBzdWNjZXNzIGZ1bmN0aW9uIHdpbGwgYmUgY2FsbGVkIHdpdGg6CiAqCiAqICAgLSB7bnVtYmVyfSBjb2RlIFtIVFRQIHN0YXR1cyBjb2RlXShodHRwOi8vZW4ud2lraXBlZGlhLm9yZy93aWtpL0xpc3Rfb2ZfSFRUUF9zdGF0dXNfY29kZXMpIG9mCiAqICAgICB0aGUgcmVzcG9uc2UuIFRoaXMgd2lsbCBjdXJyZW50bHkgYWx3YXlzIGJlIDIwMCwgc2luY2UgYWxsIG5vbi0yMDAgcmVzcG9uc2VzIGFyZSByb3V0ZWQgdG8KICogICAgIHtAbGluayBhbmd1bGFyLnNlcnZpY2UuJHhoci5lcnJvcn0gc2VydmljZSAob3IgY3VzdG9tIGVycm9yIGNhbGxiYWNrKS4KICogICAtIHtzdHJpbmd8T2JqZWN0fSByZXNwb25zZSBSZXNwb25zZSBvYmplY3QgYXMgc3RyaW5nIG9yIGFuIE9iamVjdCBpZiB0aGUgcmVzcG9uc2Ugd2FzIGluIEpTT04KICogICAgIGZvcm1hdC4KICogICAtIHtmdW5jdGlvbihzdHJpbmc9KX0gcmVzcG9uc2VIZWFkZXJzIEEgZnVuY3Rpb24gdGhhdCB3aGVuIGNhbGxlZCB3aXRoIGEge3N0cmluZ30gaGVhZGVyIG5hbWUsCiAqICAgICByZXR1cm5zIHRoZSB2YWx1ZSBvZiB0aGF0IGhlYWRlciBvciBudWxsIGlmIGl0IGRvZXMgbm90IGV4aXN0OyB3aGVuIGNhbGxlZCB3aXRob3V0CiAqICAgICBhcmd1bWVudHMsIHJldHVybnMgYW4gb2JqZWN0IGNvbnRhaW5pbmcgZXZlcnkgcmVzcG9uc2UgaGVhZGVyCiAqIEBwYXJhbSB7ZnVuY3Rpb24obnVtYmVyLCAoc3RyaW5nfE9iamVjdCkpfSBlcnJvciBBIGZ1bmN0aW9uIHRvIGJlIGNhbGxlZCBpZiB0aGUgcmVzcG9uc2UgY29kZSBpcwogKiAgIG5vdCAyeHguLiBBY2NlcHRzIHRoZSBzYW1lIGFyZ3VtZW50cyBhcyBzdWNjZXNzLCBhYm92ZS4KICoKICogQGV4YW1wbGUKICAgPGRvYzpleGFtcGxlPgogICAgIDxkb2M6c291cmNlIGpzZmlkZGxlPSJmYWxzZSI+CiAgICAgICA8c2NyaXB0PgogICAgICAgICBmdW5jdGlvbiBGZXRjaENudGwoJHhocikgewogICAgICAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgICAgICAgdGhpcy5mZXRjaCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgc2VsZi5jb2RlID0gbnVsbDsKICAgICAgICAgICAgIHNlbGYucmVzcG9uc2UgPSBudWxsOwoKICAgICAgICAgICAgICR4aHIoc2VsZi5tZXRob2QsIHNlbGYudXJsLCBmdW5jdGlvbihjb2RlLCByZXNwb25zZSkgewogICAgICAgICAgICAgICBzZWxmLmNvZGUgPSBjb2RlOwogICAgICAgICAgICAgICBzZWxmLnJlc3BvbnNlID0gcmVzcG9uc2U7CiAgICAgICAgICAgICB9LCBmdW5jdGlvbihjb2RlLCByZXNwb25zZSkgewogICAgICAgICAgICAgICBzZWxmLmNvZGUgPSBjb2RlOwogICAgICAgICAgICAgICBzZWxmLnJlc3BvbnNlID0gcmVzcG9uc2UgfHwgIlJlcXVlc3QgZmFpbGVkIjsKICAgICAgICAgICAgIH0pOwogICAgICAgICAgIH07CgogICAgICAgICAgIHRoaXMudXBkYXRlTW9kZWwgPSBmdW5jdGlvbihtZXRob2QsIHVybCkgewogICAgICAgICAgICAgc2VsZi5tZXRob2QgPSBtZXRob2Q7CiAgICAgICAgICAgICBzZWxmLnVybCA9IHVybDsKICAgICAgICAgICB9OwogICAgICAgICB9CiAgICAgICAgIEZldGNoQ250bC4kaW5qZWN0ID0gWyckeGhyJ107CiAgICAgICA8L3NjcmlwdD4KICAgICAgIDxkaXYgbmc6Y29udHJvbGxlcj0iRmV0Y2hDbnRsIj4KICAgICAgICAgPHNlbGVjdCBuYW1lPSJtZXRob2QiPgogICAgICAgICAgIDxvcHRpb24+R0VUPC9vcHRpb24+CiAgICAgICAgICAgPG9wdGlvbj5KU09OPC9vcHRpb24+CiAgICAgICAgIDwvc2VsZWN0PgogICAgICAgICA8aW5wdXQgdHlwZT0idGV4dCIgbmFtZT0idXJsIiB2YWx1ZT0iaW5kZXguaHRtbCIgc2l6ZT0iODAiLz4KICAgICAgICAgPGJ1dHRvbiBuZzpjbGljaz0iZmV0Y2goKSI+ZmV0Y2g8L2J1dHRvbj48YnI+CiAgICAgICAgIDxidXR0b24gbmc6Y2xpY2s9InVwZGF0ZU1vZGVsKCdHRVQnLCAnaW5kZXguaHRtbCcpIj5TYW1wbGUgR0VUPC9idXR0b24+CiAgICAgICAgIDxidXR0b24gbmc6Y2xpY2s9InVwZGF0ZU1vZGVsKCdKU09OJywgJ2h0dHBzOi8vd3d3Lmdvb2dsZWFwaXMuY29tL2J1enovdjEvYWN0aXZpdGllcy9nb29nbGVidXp6L0BzZWxmP2FsdD1qc29uJmNhbGxiYWNrPUpTT05fQ0FMTEJBQ0snKSI+U2FtcGxlIEpTT05QIChCdXp6IEFQSSk8L2J1dHRvbj4KICAgICAgICAgPGJ1dHRvbiBuZzpjbGljaz0idXBkYXRlTW9kZWwoJ0pTT04nLCAnaHR0cHM6Ly93d3cuaW52YWxpZF9KU09OUF9yZXF1ZXN0LmNvbSZjYWxsYmFjaz1KU09OX0NBTExCQUNLJykiPkludmFsaWQgSlNPTlA8L2J1dHRvbj4KICAgICAgICAgPHByZT5jb2RlPXt7Y29kZX19PC9wcmU+CiAgICAgICAgIDxwcmU+cmVzcG9uc2U9e3tyZXNwb25zZX19PC9wcmU+CiAgICAgICA8L2Rpdj4KICAgICA8L2RvYzpzb3VyY2U+CiAgICAgPGRvYzpzY2VuYXJpbz4KICAgICAgIGl0KCdzaG91bGQgbWFrZSB4aHIgR0VUIHJlcXVlc3QnLCBmdW5jdGlvbigpIHsKICAgICAgICAgZWxlbWVudCgnOmJ1dHRvbjpjb250YWlucygiU2FtcGxlIEdFVCIpJykuY2xpY2soKTsKICAgICAgICAgZWxlbWVudCgnOmJ1dHRvbjpjb250YWlucygiZmV0Y2giKScpLmNsaWNrKCk7CiAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdjb2RlJykpLnRvQmUoJ2NvZGU9MjAwJyk7CiAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdyZXNwb25zZScpKS50b01hdGNoKC9hbmd1bGFyanMub3JnLyk7CiAgICAgICB9KTsKCiAgICAgICBpdCgnc2hvdWxkIG1ha2UgSlNPTlAgcmVxdWVzdCB0byB0aGUgQnV6eiBBUEknLCBmdW5jdGlvbigpIHsKICAgICAgICAgZWxlbWVudCgnOmJ1dHRvbjpjb250YWlucygiQnV6eiBBUEkiKScpLmNsaWNrKCk7CiAgICAgICAgIGVsZW1lbnQoJzpidXR0b246Y29udGFpbnMoImZldGNoIiknKS5jbGljaygpOwogICAgICAgICBleHBlY3QoYmluZGluZygnY29kZScpKS50b0JlKCdjb2RlPTIwMCcpOwogICAgICAgICBleHBlY3QoYmluZGluZygncmVzcG9uc2UnKSkudG9NYXRjaCgvYnV6ei1mZWVkLyk7CiAgICAgICB9KTsKCiAgICAgICBpdCgnc2hvdWxkIG1ha2UgSlNPTlAgcmVxdWVzdCB0byBpbnZhbGlkIFVSTCBhbmQgaW52b2tlIHRoZSBlcnJvciBoYW5kbGVyJywKICAgICAgICAgICBmdW5jdGlvbigpIHsKICAgICAgICAgZWxlbWVudCgnOmJ1dHRvbjpjb250YWlucygiSW52YWxpZCBKU09OUCIpJykuY2xpY2soKTsKICAgICAgICAgZWxlbWVudCgnOmJ1dHRvbjpjb250YWlucygiZmV0Y2giKScpLmNsaWNrKCk7CiAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdjb2RlJykpLnRvQmUoJ2NvZGU9Jyk7CiAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdyZXNwb25zZScpKS50b0JlKCdyZXNwb25zZT1SZXF1ZXN0IGZhaWxlZCcpOwogICAgICAgfSk7CiAgICAgPC9kb2M6c2NlbmFyaW8+CiAgIDwvZG9jOmV4YW1wbGU+CiAqLwphbmd1bGFyU2VydmljZUluamVjdCgnJHhocicsIGZ1bmN0aW9uKCRicm93c2VyLCAkZXJyb3IsICRsb2csICR1cGRhdGVWaWV3KXsKCiAgdmFyIHhockhlYWRlckRlZmF1bHRzID0gewogICAgY29tbW9uOiB7CiAgICAgICJBY2NlcHQiOiAiYXBwbGljYXRpb24vanNvbiwgdGV4dC9wbGFpbiwgKi8qIiwKICAgICAgIlgtUmVxdWVzdGVkLVdpdGgiOiAiWE1MSHR0cFJlcXVlc3QiCiAgICB9LAogICAgcG9zdDogeydDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkJ30sCiAgICBnZXQ6IHt9LCAgICAgIC8vIGFsbCB0aGVzZSBlbXB0eSBwcm9wZXJ0aWVzIGFyZSBuZWVkZWQgc28gdGhhdCBjbGllbnQgYXBwcyBjYW4ganVzdCBkbzoKICAgIGhlYWQ6IHt9LCAgICAgLy8gJHhoci5kZWZhdWx0cy5oZWFkZXJzLmhlYWQuZm9vPSJiYXIiIHdpdGhvdXQgaGF2aW5nIHRvIGNyZWF0ZSBoZWFkIG9iamVjdAogICAgcHV0OiB7fSwgICAgICAvLyBpdCBhbHNvIG1lYW5zIHRoYXQgaWYgd2UgYWRkIGEgaGVhZGVyIGZvciB0aGVzZSBtZXRob2RzIGluIHRoZSBmdXR1cmUsIGl0CiAgICAnZGVsZXRlJzoge30sIC8vIHdvbid0IGJlIGVhc2lseSBzaWxlbnRseSBsb3N0IGR1ZSB0byBhbiBvYmplY3QgYXNzaWdubWVudC4KICAgIHBhdGNoOiB7fQogIH07CgogIGZ1bmN0aW9uIHhocihtZXRob2QsIHVybCwgcG9zdCwgc3VjY2VzcywgZXJyb3IpIHsKICAgIGlmIChpc0Z1bmN0aW9uKHBvc3QpKSB7CiAgICAgIGVycm9yID0gc3VjY2VzczsKICAgICAgc3VjY2VzcyA9IHBvc3Q7CiAgICAgIHBvc3QgPSBudWxsOwogICAgfQogICAgaWYgKHBvc3QgJiYgaXNPYmplY3QocG9zdCkpIHsKICAgICAgcG9zdCA9IHRvSnNvbihwb3N0KTsKICAgIH0KCiAgICAkYnJvd3Nlci54aHIobWV0aG9kLCB1cmwsIHBvc3QsIGZ1bmN0aW9uKGNvZGUsIHJlc3BvbnNlLCByZXNwb25zZUhlYWRlcnMpewogICAgICB0cnkgewogICAgICAgIGlmIChpc1N0cmluZyhyZXNwb25zZSkpIHsKICAgICAgICAgIGlmIChyZXNwb25zZS5tYXRjaCgvXlwpXF1cfScsXG4vKSkgcmVzcG9uc2U9cmVzcG9uc2Uuc3Vic3RyKDYpOwogICAgICAgICAgaWYgKC9eXHMqW1xbXHtdLy5leGVjKHJlc3BvbnNlKSAmJiAvW1x9XF1dXHMqJC8uZXhlYyhyZXNwb25zZSkpIHsKICAgICAgICAgICAgcmVzcG9uc2UgPSBmcm9tSnNvbihyZXNwb25zZSwgdHJ1ZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmICgyMDAgPD0gY29kZSAmJiBjb2RlIDwgMzAwKSB7CiAgICAgICAgICBzdWNjZXNzKGNvZGUsIHJlc3BvbnNlLCByZXNwb25zZUhlYWRlcnMpOwogICAgICAgIH0gZWxzZSBpZiAoaXNGdW5jdGlvbihlcnJvcikpIHsKICAgICAgICAgIGVycm9yKGNvZGUsIHJlc3BvbnNlLCByZXNwb25zZUhlYWRlcnMpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAkZXJyb3IoCiAgICAgICAgICAgIHttZXRob2Q6IG1ldGhvZCwgdXJsOiB1cmwsIGRhdGE6IHBvc3QsIHN1Y2Nlc3M6IHN1Y2Nlc3N9LAogICAgICAgICAgICB7c3RhdHVzOiBjb2RlLCBib2R5OiByZXNwb25zZX0pOwogICAgICAgIH0KICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICRsb2cuZXJyb3IoZSk7CiAgICAgIH0gZmluYWxseSB7CiAgICAgICAgJHVwZGF0ZVZpZXcoKTsKICAgICAgfQogICAgfSwgZXh0ZW5kKHsnWC1YU1JGLVRPS0VOJzogJGJyb3dzZXIuY29va2llcygpWydYU1JGLVRPS0VOJ119LAogICAgICAgICAgICAgIHhockhlYWRlckRlZmF1bHRzLmNvbW1vbiwKICAgICAgICAgICAgICB4aHJIZWFkZXJEZWZhdWx0c1tsb3dlcmNhc2UobWV0aG9kKV0pKTsKICB9OwoKICB4aHIuZGVmYXVsdHMgPSB7aGVhZGVyczogeGhySGVhZGVyRGVmYXVsdHN9OwoKICByZXR1cm4geGhyOwp9LCBbJyRicm93c2VyJywgJyR4aHIuZXJyb3InLCAnJGxvZycsICckdXBkYXRlVmlldyddKTsKJ3VzZSBzdHJpY3QnOwoKLyoqCiAqIEB3b3JrSW5Qcm9ncmVzcwogKiBAbmdkb2Mgb3ZlcnZpZXcKICogQG5hbWUgYW5ndWxhci5kaXJlY3RpdmUKICogQGRlc2NyaXB0aW9uCiAqCiAqIEN1c3RvbSBhdHRyaWJ1dGVzIGZvciBET00gZWxlbWVudHMuICBEaXJlY3RpdmVzIG1vZGlmeSB0aGUgYmVoYXZpb3Igb2YgdGhlIGVsZW1lbnQgdGhleSBhcmUKICogc3BlY2lmaWVkIGluLCBidXQgYXJlIG5vdCBpbnRlbmRlZCB0byBhZGQgZWxlbWVudHMgdG8gdGhlIERPTSBhcyBhcmUKICoge0BsaW5rIGFuZ3VsYXIud2lkZ2V0IHdpZGdldHN9LgogKgogKiBGb2xsb3dpbmcgaXMgdGhlIGxpc3Qgb2YgYnVpbHQtaW4gYW5ndWxhciBkaXJlY3RpdmVzOgogKgogKiAqIHtAbGluayBhbmd1bGFyLmRpcmVjdGl2ZS5uZzpiaW5kIG5nOmJpbmR9IC0gQ3JlYXRlcyBhIGRhdGEtYmluZGluZyBiZXR3ZWVuIEhUTUwgdGV4dCB2YWx1ZSBhbmQKICogZGF0YSBtb2RlbC4KICogKiB7QGxpbmsgYW5ndWxhci5kaXJlY3RpdmUubmc6YmluZC1hdHRyIG5nOmJpbmQtYXR0cn0gLSBDcmVhdGVzIGEgZGF0YS1iaW5kaW5nIGFzIGluIGBuZzpiaW5kYCwKICogYnV0IHVzZXMgSlNPTiBrZXkgLyB2YWx1ZSBwYWlycy4KICogKiB7QGxpbmsgYW5ndWxhci5kaXJlY3RpdmUubmc6YmluZC10ZW1wbGF0ZSBuZzpiaW5kLXRlbXBsYXRlfSAtIFJlcGxhY2VzIHRleHQgdmFsdWUgb2YgYW4gZWxlbWVudAogKiB3aXRoIGEgc3BlY2lmaWVkIHRlbXBsYXRlLgogKiAqIHtAbGluayBhbmd1bGFyLmRpcmVjdGl2ZS5uZzpjaGFuZ2Ugbmc6Y2hhbmdlfSAtIEV4ZWN1dGVzIGFuIGV4cHJlc3Npb24gd2hlbiB0aGUgdmFsdWUgb2YgYW4KICogaW5wdXQgd2lkZ2V0IGNoYW5nZXMuCiAqICoge0BsaW5rIGFuZ3VsYXIuZGlyZWN0aXZlLm5nOmNsYXNzIG5nOmNsYXNzfSAtIENvbmRpdGlvbmFsbHkgc2V0IENTUyBjbGFzcyBvbiBhbiBlbGVtZW50LgogKiAqIHtAbGluayBhbmd1bGFyLmRpcmVjdGl2ZS5uZzpjbGFzcy1ldmVuIG5nOmNsYXNzLWV2ZW59IC0gTGlrZSBgbmc6Y2xhc3NgLCBidXQgd29ya3MgaW4KICogY29uanVuY3Rpb24gd2l0aCB7QGxpbmsgYW5ndWxhci53aWRnZXQuQG5nOnJlcGVhdH0gdG8gYWZmZWN0IGV2ZW4gcm93cyBpbiBhIGNvbGxlY3Rpb24uCiAqICoge0BsaW5rIGFuZ3VsYXIuZGlyZWN0aXZlLm5nOmNsYXNzLW9kZCBuZzpjbGFzcy1vZGR9IC0gTGlrZSBgbmc6Y2xhc3NgLCBidXQgd29ya3Mgd2l0aCB7QGxpbmsKICogYW5ndWxhci53aWRnZXQuQG5nOnJlcGVhdH0gIHRvIGFmZmVjdCBvZGQgcm93cy4KICogKiB7QGxpbmsgYW5ndWxhci5kaXJlY3RpdmUubmc6Y2xpY2sgbmc6Y2xpY2t9IC0gRXhlY3V0ZXMgY3VzdG9tIGJlaGF2aW9yIHdoZW4gZWxlbWVudCBpcyBjbGlja2VkLgogKiAqIHtAbGluayBhbmd1bGFyLmRpcmVjdGl2ZS5uZzpjb250cm9sbGVyIG5nOmNvbnRyb2xsZXJ9IC0gQ3JlYXRlcyBhIHNjb3BlIG9iamVjdCBsaW5rZWQgdG8gdGhlCiAqIERPTSBlbGVtZW50IGFuZCBhc3NpZ25zIGJlaGF2aW9yIHRvIHRoZSBzY29wZS4KICogKiB7QGxpbmsgYW5ndWxhci5kaXJlY3RpdmUubmc6ZXZhbCBuZzpldmFsfSAtIEV4ZWN1dGVzIGEgYmluZGluZyBidXQgYmxvY2tzIG91dHB1dC4KICogKiB7QGxpbmsgYW5ndWxhci5kaXJlY3RpdmUubmc6ZXZhbC1vcmRlciBuZzpldmFsLW9yZGVyfSAtIENoYW5nZSBldmFsdWF0aW9uIG9yZGVyIHdoZW4gdXBkYXRpbmcKICogdGhlIHZpZXcuCiAqICoge0BsaW5rIGFuZ3VsYXIuZGlyZWN0aXZlLm5nOmhpZGUgbmc6aGlkZX0gLSBDb25kaXRpb25hbGx5IGhpZGVzIGEgcG9ydGlvbiBvZiBIVE1MLgogKiAqIHtAbGluayBhbmd1bGFyLmRpcmVjdGl2ZS5uZzpocmVmIG5nOmhyZWZ9IC0gUGxhY2VzIGFuIGhyZWYgaW4gdGhlIGFuZ3VsYXIgbmFtZXNwYWNlLgogKiAqIHtAbGluayBhbmd1bGFyLmRpcmVjdGl2ZS5uZzppbml0fSAtIEluaXRpYWxpemF0aW9uIHRhc2tzIHJ1biBiZWZvcmUgYSB0ZW1wbGF0ZSBpcyBleGVjdXRlZC4KICogKiB7QGxpbmsgYW5ndWxhci5kaXJlY3RpdmUubmc6c2hvdyBuZzpzaG93fSAtIENvbmRpdGlvbmFsbHkgZGlzcGxheXMgYSBwb3J0aW9uIG9mIEhUTUwuCiAqICoge0BsaW5rIGFuZ3VsYXIuZGlyZWN0aXZlLm5nOnNyYyBuZzpzcmN9IC0gUGxhY2VzIGEgYHNyY2AgYXR0cmlidXRlIGludG8gdGhlIGFuZ3VsYXIgbmFtZXNwYWNlLgogKiAqIHtAbGluayBhbmd1bGFyLmRpcmVjdGl2ZS5uZzpzdHlsZSBuZzpzdHlsZX0gLSBDb25kaXRpb25hbGx5IHNldCBDU1Mgc3R5bGVzIG9uIGFuIGVsZW1lbnQuCiAqICoge0BsaW5rIGFuZ3VsYXIuZGlyZWN0aXZlLm5nOnN1Ym1pdH0gLSBCaW5kcyBhbmd1bGFyIGV4cHJlc3Npb25zIHRvIGBvblN1Ym1pdGAgZXZlbnRzLgogKgogKiBGb3IgbW9yZSBpbmZvcm1hdGlvbiBhYm91dCBob3cgYW5ndWxhciBkaXJlY3RpdmVzIHdvcmssIGFuZCBob3cgdG8gY3JlYXRlIHlvdXIgb3duIGRpcmVjdGl2ZXMsCiAqIHNlZSB7QGxpbmsgZ3VpZGUvZGV2X2d1aWRlLmNvbXBpbGVyLmRpcmVjdGl2ZXMgVW5kZXJzdGFuZGluZyBBbmd1bGFyIERpcmVjdGl2ZXN9IGluIHRoZSBhbmd1bGFyCiAqIERldmVsb3BlciBHdWlkZS4KICovCgovKioKICogQHdvcmtJblByb2dyZXNzCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgYW5ndWxhci5kaXJlY3RpdmUubmc6aW5pdAogKgogKiBAZGVzY3JpcHRpb24KICogVGhlIGBuZzppbml0YCBhdHRyaWJ1dGUgc3BlY2lmaWVzIGluaXRpYWxpemF0aW9uIHRhc2tzIHRvIGJlIGV4ZWN1dGVkCiAqICBiZWZvcmUgdGhlIHRlbXBsYXRlIGVudGVycyBleGVjdXRpb24gbW9kZSBkdXJpbmcgYm9vdHN0cmFwLgogKgogKiBAZWxlbWVudCBBTlkKICogQHBhcmFtIHtleHByZXNzaW9ufSBleHByZXNzaW9uIHtAbGluayBndWlkZS9kZXZfZ3VpZGUuZXhwcmVzc2lvbnMgRXhwcmVzc2lvbn0gdG8gZXZhbC4KICoKICogQGV4YW1wbGUKICAgPGRvYzpleGFtcGxlPgogICAgIDxkb2M6c291cmNlPgogICAgPGRpdiBuZzppbml0PSJncmVldGluZz0nSGVsbG8nOyBwZXJzb249J1dvcmxkJyI+CiAgICAgIHt7Z3JlZXRpbmd9fSB7e3BlcnNvbn19IQogICAgPC9kaXY+CiAgICAgPC9kb2M6c291cmNlPgogICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgICBpdCgnc2hvdWxkIGNoZWNrIGdyZWV0aW5nJywgZnVuY3Rpb24oKXsKICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ2dyZWV0aW5nJykpLnRvQmUoJ0hlbGxvJyk7CiAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdwZXJzb24nKSkudG9CZSgnV29ybGQnKTsKICAgICAgIH0pOwogICAgIDwvZG9jOnNjZW5hcmlvPgogICA8L2RvYzpleGFtcGxlPgogKi8KYW5ndWxhckRpcmVjdGl2ZSgibmc6aW5pdCIsIGZ1bmN0aW9uKGV4cHJlc3Npb24pewogIHJldHVybiBmdW5jdGlvbihlbGVtZW50KXsKICAgIHRoaXMuJHRyeUV2YWwoZXhwcmVzc2lvbiwgZWxlbWVudCk7CiAgfTsKfSk7CgovKioKICogQHdvcmtJblByb2dyZXNzCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgYW5ndWxhci5kaXJlY3RpdmUubmc6Y29udHJvbGxlcgogKgogKiBAZGVzY3JpcHRpb24KICogVGhlIGBuZzpjb250cm9sbGVyYCBkaXJlY3RpdmUgYXNzaWducyBiZWhhdmlvciB0byBhIHNjb3BlLiBUaGlzIGlzIGEga2V5IGFzcGVjdCBvZiBob3cgYW5ndWxhcgogKiBzdXBwb3J0cyB0aGUgcHJpbmNpcGxlcyBiZWhpbmQgdGhlIE1vZGVsLVZpZXctQ29udHJvbGxlciBkZXNpZ24gcGF0dGVybi4KICoKICogTVZDIGNvbXBvbmVudHMgaW4gYW5ndWxhcjoKICoKICogKiBNb2RlbCDigJQgVGhlIE1vZGVsIGlzIGRhdGEgaW4gc2NvcGUgcHJvcGVydGllczsgc2NvcGVzIGFyZSBhdHRhY2hlZCB0byB0aGUgRE9NLgogKiAqIFZpZXcg4oCUIFRoZSB0ZW1wbGF0ZSAoSFRNTCB3aXRoIGRhdGEgYmluZGluZ3MpIGlzIHJlbmRlcmVkIGludG8gdGhlIFZpZXcuCiAqICogQ29udHJvbGxlciDigJQgVGhlIGBuZzpjb250cm9sbGVyYCBkaXJlY3RpdmUgc3BlY2lmaWVzIGEgQ29udHJvbGxlciBjbGFzczsgdGhlIGNsYXNzIGhhcwogKiAgIG1ldGhvZHMgdGhhdCB0eXBpY2FsbHkgZXhwcmVzcyB0aGUgYnVzaW5lc3MgbG9naWMgYmVoaW5kIHRoZSBhcHBsaWNhdGlvbi4KICoKICogTm90ZSB0aGF0IGFuIGFsdGVybmF0aXZlIHdheSB0byBkZWZpbmUgY29udHJvbGxlcnMgaXMgdmlhIHRoZSBge0BsaW5rIGFuZ3VsYXIuc2VydmljZS4kcm91dGV9YAogKiBzZXJ2aWNlLgogKgogKiBAZWxlbWVudCBBTlkKICogQHBhcmFtIHtleHByZXNzaW9ufSBleHByZXNzaW9uIE5hbWUgb2YgYSBnbG9iYWxseSBhY2Nlc3NpYmxlIGNvbnN0cnVjdG9yIGZ1bmN0aW9uIG9yIGFuCiAqICAgICB7QGxpbmsgZ3VpZGUvZGV2X2d1aWRlLmV4cHJlc3Npb25zIGV4cHJlc3Npb259IHRoYXQgb24gdGhlIGN1cnJlbnQgc2NvcGUgZXZhbHVhdGVzIHRvIGEKICogICAgIGNvbnN0cnVjdG9yIGZ1bmN0aW9uLgogKgogKiBAZXhhbXBsZQogKiBIZXJlIGlzIGEgc2ltcGxlIGZvcm0gZm9yIGVkaXRpbmcgdXNlciBjb250YWN0IGluZm9ybWF0aW9uLiBBZGRpbmcsIHJlbW92aW5nLCBjbGVhcmluZywgYW5kCiAqIGdyZWV0aW5nIGFyZSBtZXRob2RzIGRlY2xhcmVkIG9uIHRoZSBjb250cm9sbGVyIChzZWUgc291cmNlIHRhYikuIFRoZXNlIG1ldGhvZHMgY2FuCiAqIGVhc2lseSBiZSBjYWxsZWQgZnJvbSB0aGUgYW5ndWxhciBtYXJrdXAuIE5vdGljZSB0aGF0IHRoZSBzY29wZSBiZWNvbWVzIHRoZSBgdGhpc2AgZm9yIHRoZQogKiBjb250cm9sbGVyJ3MgaW5zdGFuY2UuIFRoaXMgYWxsb3dzIGZvciBlYXN5IGFjY2VzcyB0byB0aGUgdmlldyBkYXRhIGZyb20gdGhlIGNvbnRyb2xsZXIuIEFsc28KICogbm90aWNlIHRoYXQgYW55IGNoYW5nZXMgdG8gdGhlIGRhdGEgYXJlIGF1dG9tYXRpY2FsbHkgcmVmbGVjdGVkIGluIHRoZSBWaWV3IHdpdGhvdXQgdGhlIG5lZWQKICogZm9yIGEgbWFudWFsIHVwZGF0ZS4KICAgPGRvYzpleGFtcGxlPgogICAgIDxkb2M6c291cmNlPgogICAgICA8c2NyaXB0IHR5cGU9InRleHQvamF2YXNjcmlwdCI+CiAgICAgICAgZnVuY3Rpb24gU2V0dGluZ3NDb250cm9sbGVyKCkgewogICAgICAgICAgdGhpcy5uYW1lID0gIkpvaG4gU21pdGgiOwogICAgICAgICAgdGhpcy5jb250YWN0cyA9IFsKICAgICAgICAgICAge3R5cGU6J3Bob25lJywgdmFsdWU6JzQwOCA1NTUgMTIxMid9LAogICAgICAgICAgICB7dHlwZTonZW1haWwnLCB2YWx1ZTonam9obi5zbWl0aEBleGFtcGxlLm9yZyd9IF07CiAgICAgICAgfQogICAgICAgIFNldHRpbmdzQ29udHJvbGxlci5wcm90b3R5cGUgPSB7CiAgICAgICAgIGdyZWV0OiBmdW5jdGlvbigpewogICAgICAgICAgIGFsZXJ0KHRoaXMubmFtZSk7CiAgICAgICAgIH0sCiAgICAgICAgIGFkZENvbnRhY3Q6IGZ1bmN0aW9uKCl7CiAgICAgICAgICAgdGhpcy5jb250YWN0cy5wdXNoKHt0eXBlOidlbWFpbCcsIHZhbHVlOid5b3VybmFtZUBleGFtcGxlLm9yZyd9KTsKICAgICAgICAgfSwKICAgICAgICAgcmVtb3ZlQ29udGFjdDogZnVuY3Rpb24oY29udGFjdFRvUmVtb3ZlKSB7CiAgICAgICAgICAgYW5ndWxhci5BcnJheS5yZW1vdmUodGhpcy5jb250YWN0cywgY29udGFjdFRvUmVtb3ZlKTsKICAgICAgICAgfSwKICAgICAgICAgY2xlYXJDb250YWN0OiBmdW5jdGlvbihjb250YWN0KSB7CiAgICAgICAgICAgY29udGFjdC50eXBlID0gJ3Bob25lJzsKICAgICAgICAgICBjb250YWN0LnZhbHVlID0gJyc7CiAgICAgICAgIH0KICAgICAgICB9OwogICAgICA8L3NjcmlwdD4KICAgICAgPGRpdiBuZzpjb250cm9sbGVyPSJTZXR0aW5nc0NvbnRyb2xsZXIiPgogICAgICAgIE5hbWU6IDxpbnB1dCB0eXBlPSJ0ZXh0IiBuYW1lPSJuYW1lIi8+CiAgICAgICAgWyA8YSBocmVmPSIiIG5nOmNsaWNrPSJncmVldCgpIj5ncmVldDwvYT4gXTxici8+CiAgICAgICAgQ29udGFjdDoKICAgICAgICA8dWw+CiAgICAgICAgICA8bGkgbmc6cmVwZWF0PSJjb250YWN0IGluIGNvbnRhY3RzIj4KICAgICAgICAgICAgPHNlbGVjdCBuYW1lPSJjb250YWN0LnR5cGUiPgogICAgICAgICAgICAgICA8b3B0aW9uPnBob25lPC9vcHRpb24+CiAgICAgICAgICAgICAgIDxvcHRpb24+ZW1haWw8L29wdGlvbj4KICAgICAgICAgICAgPC9zZWxlY3Q+CiAgICAgICAgICAgIDxpbnB1dCB0eXBlPSJ0ZXh0IiBuYW1lPSJjb250YWN0LnZhbHVlIi8+CiAgICAgICAgICAgIFsgPGEgaHJlZj0iIiBuZzpjbGljaz0iY2xlYXJDb250YWN0KGNvbnRhY3QpIj5jbGVhcjwvYT4KICAgICAgICAgICAgfCA8YSBocmVmPSIiIG5nOmNsaWNrPSJyZW1vdmVDb250YWN0KGNvbnRhY3QpIj5YPC9hPiBdCiAgICAgICAgICA8L2xpPgogICAgICAgICAgPGxpPlsgPGEgaHJlZj0iIiBuZzpjbGljaz0iYWRkQ29udGFjdCgpIj5hZGQ8L2E+IF08L2xpPgogICAgICAgPC91bD4KICAgICAgPC9kaXY+CiAgICAgPC9kb2M6c291cmNlPgogICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgICBpdCgnc2hvdWxkIGNoZWNrIGNvbnRyb2xsZXInLCBmdW5jdGlvbigpewogICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgZGl2PjppbnB1dCcpLnZhbCgpKS50b0JlKCdKb2huIFNtaXRoJyk7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBsaVtuZ1xcOnJlcGVhdC1pbmRleD0iMCJdIGlucHV0JykudmFsKCkpLnRvQmUoJzQwOCA1NTUgMTIxMicpOwogICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgbGlbbmdcXDpyZXBlYXQtaW5kZXg9IjEiXSBpbnB1dCcpLnZhbCgpKS50b0JlKCdqb2huLnNtaXRoQGV4YW1wbGUub3JnJyk7CiAgICAgICAgIGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIGxpOmZpcnN0IGE6Y29udGFpbnMoImNsZWFyIiknKS5jbGljaygpOwogICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgbGk6Zmlyc3QgaW5wdXQnKS52YWwoKSkudG9CZSgnJyk7CiAgICAgICAgIGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIGxpOmxhc3QgYTpjb250YWlucygiYWRkIiknKS5jbGljaygpOwogICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgbGlbbmdcXDpyZXBlYXQtaW5kZXg9IjIiXSBpbnB1dCcpLnZhbCgpKS50b0JlKCd5b3VybmFtZUBleGFtcGxlLm9yZycpOwogICAgICAgfSk7CiAgICAgPC9kb2M6c2NlbmFyaW8+CiAgIDwvZG9jOmV4YW1wbGU+CiAqLwphbmd1bGFyRGlyZWN0aXZlKCJuZzpjb250cm9sbGVyIiwgZnVuY3Rpb24oZXhwcmVzc2lvbil7CiAgdGhpcy5zY29wZSh0cnVlKTsKICByZXR1cm4gZnVuY3Rpb24oZWxlbWVudCl7CiAgICB2YXIgY29udHJvbGxlciA9IGdldHRlcih3aW5kb3csIGV4cHJlc3Npb24sIHRydWUpIHx8IGdldHRlcih0aGlzLCBleHByZXNzaW9uLCB0cnVlKTsKICAgIGlmICghY29udHJvbGxlcikKICAgICAgdGhyb3cgIkNhbiBub3QgZmluZCAnIitleHByZXNzaW9uKyInIGNvbnRyb2xsZXIuIjsKICAgIGlmICghaXNGdW5jdGlvbihjb250cm9sbGVyKSkKICAgICAgdGhyb3cgIlJlZmVyZW5jZSAnIitleHByZXNzaW9uKyInIGlzIG5vdCBhIGNsYXNzLiI7CiAgICB0aGlzLiRiZWNvbWUoY29udHJvbGxlcik7CiAgfTsKfSk7CgovKioKICogQHdvcmtJblByb2dyZXNzCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgYW5ndWxhci5kaXJlY3RpdmUubmc6ZXZhbAogKgogKiBAZGVzY3JpcHRpb24KICogVGhlIGBuZzpldmFsYCBhbGxvd3MgeW91IHRvIGV4ZWN1dGUgYSBiaW5kaW5nIHdoaWNoIGhhcyBzaWRlIGVmZmVjdHMKICogd2l0aG91dCBkaXNwbGF5aW5nIHRoZSByZXN1bHQgdG8gdGhlIHVzZXIuCiAqCiAqIEBlbGVtZW50IEFOWQogKiBAcGFyYW0ge2V4cHJlc3Npb259IGV4cHJlc3Npb24ge0BsaW5rIGd1aWRlL2Rldl9ndWlkZS5leHByZXNzaW9ucyBFeHByZXNzaW9ufSB0byBldmFsLgogKgogKiBAZXhhbXBsZQogKiBOb3RpY2UgdGhhdCBge3tgIGBvYmoubXVsdGlwbGllZCA9IG9iai5hICogb2JqLmJgIGB9fWAgaGFzIGEgc2lkZSBlZmZlY3Qgb2YgYXNzaWduaW5nCiAqIGEgdmFsdWUgdG8gYG9iai5tdWx0aXBsaWVkYCBhbmQgZGlzcGxheWluZyB0aGUgcmVzdWx0IHRvIHRoZSB1c2VyLiBTb21ldGltZXMsCiAqIGhvd2V2ZXIsIGl0IGlzIGRlc2lyYWJsZSB0byBleGVjdXRlIGEgc2lkZSBlZmZlY3Qgd2l0aG91dCBzaG93aW5nIHRoZSB2YWx1ZSB0bwogKiB0aGUgdXNlci4gSW4gc3VjaCBhIGNhc2UgYG5nOmV2YWxgIGFsbG93cyB5b3UgdG8gZXhlY3V0ZSBjb2RlIHdpdGhvdXQgdXBkYXRpbmcKICogdGhlIGRpc3BsYXkuCiAgIDxkb2M6ZXhhbXBsZT4KICAgICA8ZG9jOnNvdXJjZT4KICAgICAgIDxpbnB1dCBuYW1lPSJvYmouYSIgdmFsdWU9IjYiID4KICAgICAgICAgKiA8aW5wdXQgbmFtZT0ib2JqLmIiIHZhbHVlPSIyIj4KICAgICAgICAgPSB7e29iai5tdWx0aXBsaWVkID0gb2JqLmEgKiBvYmouYn19IDxicj4KICAgICAgIDxzcGFuIG5nOmV2YWw9Im9iai5kaXZpZGUgPSBvYmouYSAvIG9iai5iIj48L3NwYW4+CiAgICAgICA8c3BhbiBuZzpldmFsPSJvYmoudXBkYXRlQ291bnQgPSAxICsgKG9iai51cGRhdGVDb3VudHx8MCkiPgogICAgICAgPC9zcGFuPgogICAgICAgPHR0Pm9iai5kaXZpZGUgPSB7e29iai5kaXZpZGV9fTwvdHQ+PGJyPgogICAgICAgPHR0Pm9iai51cGRhdGVDb3VudCA9IHt7b2JqLnVwZGF0ZUNvdW50fX08L3R0PgogICAgIDwvZG9jOnNvdXJjZT4KICAgICA8ZG9jOnNjZW5hcmlvPgogICAgICAgaXQoJ3Nob3VsZCBjaGVjayBldmFsJywgZnVuY3Rpb24oKXsKICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ29iai5kaXZpZGUnKSkudG9CZSgnMycpOwogICAgICAgICBleHBlY3QoYmluZGluZygnb2JqLnVwZGF0ZUNvdW50JykpLnRvQmUoJzInKTsKICAgICAgICAgaW5wdXQoJ29iai5hJykuZW50ZXIoJzEyJyk7CiAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdvYmouZGl2aWRlJykpLnRvQmUoJzYnKTsKICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ29iai51cGRhdGVDb3VudCcpKS50b0JlKCczJyk7CiAgICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgPC9kb2M6ZXhhbXBsZT4KICovCmFuZ3VsYXJEaXJlY3RpdmUoIm5nOmV2YWwiLCBmdW5jdGlvbihleHByZXNzaW9uKXsKICByZXR1cm4gZnVuY3Rpb24oZWxlbWVudCl7CiAgICB0aGlzLiRvbkV2YWwoZXhwcmVzc2lvbiwgZWxlbWVudCk7CiAgfTsKfSk7CgovKioKICogQHdvcmtJblByb2dyZXNzCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgYW5ndWxhci5kaXJlY3RpdmUubmc6YmluZAogKgogKiBAZGVzY3JpcHRpb24KICogVGhlIGBuZzpiaW5kYCBhdHRyaWJ1dGUgYXNrcyBhbmd1bGFyIHRvIHJlcGxhY2UgdGhlIHRleHQgY29udGVudCBvZiB0aGlzCiAqIEhUTUwgZWxlbWVudCB3aXRoIHRoZSB2YWx1ZSBvZiB0aGUgZ2l2ZW4gZXhwcmVzc2lvbiwgYW5kIHRvIGtlZXAgdGhlIHRleHQKICogY29udGVudCB1cCB0byBkYXRlIHdoZW4gdGhlIGV4cHJlc3Npb24ncyB2YWx1ZSBjaGFuZ2VzLiBVc3VhbGx5IHlvdSB3b3VsZAogKiBqdXN0IHdyaXRlIGB7eyBleHByZXNzaW9uIH19YCBhbmQgbGV0IGFuZ3VsYXIgY29tcGlsZSBpdCBpbnRvCiAqIGA8c3BhbiBuZzpiaW5kPSJleHByZXNzaW9uIj48L3NwYW4+YCBhdCBib290c3RyYXAgdGltZS4KICoKICogQGVsZW1lbnQgQU5ZCiAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gZXhwcmVzc2lvbiB7QGxpbmsgZ3VpZGUvZGV2X2d1aWRlLmV4cHJlc3Npb25zIEV4cHJlc3Npb259IHRvIGV2YWwuCiAqCiAqIEBleGFtcGxlCiAqIFlvdSBjYW4gdHJ5IGl0IHJpZ2h0IGhlcmU6IGVudGVyIHRleHQgaW4gdGhlIHRleHQgYm94IGFuZCB3YXRjaCB0aGUgZ3JlZXRpbmcgY2hhbmdlLgogICA8ZG9jOmV4YW1wbGU+CiAgICAgPGRvYzpzb3VyY2U+CiAgICAgICBFbnRlciBuYW1lOiA8aW5wdXQgdHlwZT0idGV4dCIgbmFtZT0ibmFtZSIgdmFsdWU9IldoaXJsZWQiPiA8YnI+CiAgICAgICBIZWxsbyA8c3BhbiBuZzpiaW5kPSJuYW1lIiAvPiEKICAgICA8L2RvYzpzb3VyY2U+CiAgICAgPGRvYzpzY2VuYXJpbz4KICAgICAgIGl0KCdzaG91bGQgY2hlY2sgbmc6YmluZCcsIGZ1bmN0aW9uKCl7CiAgICAgICAgIGV4cGVjdCh1c2luZygnLmRvYy1leGFtcGxlLWxpdmUnKS5iaW5kaW5nKCduYW1lJykpLnRvQmUoJ1doaXJsZWQnKTsKICAgICAgICAgdXNpbmcoJy5kb2MtZXhhbXBsZS1saXZlJykuaW5wdXQoJ25hbWUnKS5lbnRlcignd29ybGQnKTsKICAgICAgICAgZXhwZWN0KHVzaW5nKCcuZG9jLWV4YW1wbGUtbGl2ZScpLmJpbmRpbmcoJ25hbWUnKSkudG9CZSgnd29ybGQnKTsKICAgICAgIH0pOwogICAgIDwvZG9jOnNjZW5hcmlvPgogICA8L2RvYzpleGFtcGxlPgogKi8KYW5ndWxhckRpcmVjdGl2ZSgibmc6YmluZCIsIGZ1bmN0aW9uKGV4cHJlc3Npb24sIGVsZW1lbnQpewogIGVsZW1lbnQuYWRkQ2xhc3MoJ25nLWJpbmRpbmcnKTsKICByZXR1cm4gZnVuY3Rpb24oZWxlbWVudCkgewogICAgdmFyIGxhc3RWYWx1ZSA9IG5vb3AsIGxhc3RFcnJvciA9IG5vb3A7CiAgICB0aGlzLiRvbkV2YWwoZnVuY3Rpb24oKSB7CiAgICAgIHZhciBlcnJvciwgdmFsdWUsIGh0bWwsIGlzSHRtbCwgaXNEb21FbGVtZW50LAogICAgICAgICAgb2xkRWxlbWVudCA9IHRoaXMuaGFzT3duUHJvcGVydHkoJCRlbGVtZW50KSA/IHRoaXMuJGVsZW1lbnQgOiB1bmRlZmluZWQ7CiAgICAgIHRoaXMuJGVsZW1lbnQgPSBlbGVtZW50OwogICAgICB2YWx1ZSA9IHRoaXMuJHRyeUV2YWwoZXhwcmVzc2lvbiwgZnVuY3Rpb24oZSl7CiAgICAgICAgZXJyb3IgPSBmb3JtYXRFcnJvcihlKTsKICAgICAgfSk7CiAgICAgIHRoaXMuJGVsZW1lbnQgPSBvbGRFbGVtZW50OwogICAgICAvLyBJZiB3ZSBhcmUgSFRNTCB0aGVuIHNhdmUgdGhlIHJhdyBIVE1MIGRhdGEgc28gdGhhdCB3ZSBkb24ndAogICAgICAvLyByZWNvbXB1dGUgc2FuaXRpemF0aW9uIHNpbmNlIGl0IGlzIGV4cGVuc2l2ZS4KICAgICAgLy8gVE9ETzogdHVybiB0aGlzIGludG8gYSBtb3JlIGdlbmVyaWMgd2F5IHRvIGNvbXB1dGUgdGhpcwogICAgICBpZiAoaXNIdG1sID0gKHZhbHVlIGluc3RhbmNlb2YgSFRNTCkpCiAgICAgICAgdmFsdWUgPSAoaHRtbCA9IHZhbHVlKS5odG1sOwogICAgICBpZiAobGFzdFZhbHVlID09PSB2YWx1ZSAmJiBsYXN0RXJyb3IgPT0gZXJyb3IpIHJldHVybjsKICAgICAgaXNEb21FbGVtZW50ID0gaXNFbGVtZW50KHZhbHVlKTsKICAgICAgaWYgKCFpc0h0bWwgJiYgIWlzRG9tRWxlbWVudCAmJiBpc09iamVjdCh2YWx1ZSkpIHsKICAgICAgICB2YWx1ZSA9IHRvSnNvbih2YWx1ZSwgdHJ1ZSk7CiAgICAgIH0KICAgICAgaWYgKHZhbHVlICE9IGxhc3RWYWx1ZSB8fCBlcnJvciAhPSBsYXN0RXJyb3IpIHsKICAgICAgICBsYXN0VmFsdWUgPSB2YWx1ZTsKICAgICAgICBsYXN0RXJyb3IgPSBlcnJvcjsKICAgICAgICBlbGVtZW50RXJyb3IoZWxlbWVudCwgTkdfRVhDRVBUSU9OLCBlcnJvcik7CiAgICAgICAgaWYgKGVycm9yKSB2YWx1ZSA9IGVycm9yOwogICAgICAgIGlmIChpc0h0bWwpIHsKICAgICAgICAgIGVsZW1lbnQuaHRtbChodG1sLmdldCgpKTsKICAgICAgICB9IGVsc2UgaWYgKGlzRG9tRWxlbWVudCkgewogICAgICAgICAgZWxlbWVudC5odG1sKCcnKTsKICAgICAgICAgIGVsZW1lbnQuYXBwZW5kKHZhbHVlKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZWxlbWVudC50ZXh0KHZhbHVlID09IHVuZGVmaW5lZCA/ICcnIDogdmFsdWUpOwogICAgICAgIH0KICAgICAgfQogICAgfSwgZWxlbWVudCk7CiAgfTsKfSk7Cgp2YXIgYmluZFRlbXBsYXRlQ2FjaGUgPSB7fTsKZnVuY3Rpb24gY29tcGlsZUJpbmRUZW1wbGF0ZSh0ZW1wbGF0ZSl7CiAgdmFyIGZuID0gYmluZFRlbXBsYXRlQ2FjaGVbdGVtcGxhdGVdOwogIGlmICghZm4pIHsKICAgIHZhciBiaW5kaW5ncyA9IFtdOwogICAgZm9yRWFjaChwYXJzZUJpbmRpbmdzKHRlbXBsYXRlKSwgZnVuY3Rpb24odGV4dCl7CiAgICAgIHZhciBleHAgPSBiaW5kaW5nKHRleHQpOwogICAgICBiaW5kaW5ncy5wdXNoKGV4cAogICAgICAgID8gZnVuY3Rpb24oZWxlbWVudCl7CiAgICAgICAgICAgIHZhciBlcnJvciwgdmFsdWUgPSB0aGlzLiR0cnlFdmFsKGV4cCwgZnVuY3Rpb24oZSl7CiAgICAgICAgICAgICAgZXJyb3IgPSB0b0pzb24oZSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBlbGVtZW50RXJyb3IoZWxlbWVudCwgTkdfRVhDRVBUSU9OLCBlcnJvcik7CiAgICAgICAgICAgIHJldHVybiBlcnJvciA/IGVycm9yIDogdmFsdWU7CiAgICAgICAgICB9CiAgICAgICAgOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHRleHQ7CiAgICAgICAgICB9KTsKICAgIH0pOwogICAgYmluZFRlbXBsYXRlQ2FjaGVbdGVtcGxhdGVdID0gZm4gPSBmdW5jdGlvbihlbGVtZW50LCBwcmV0dHlQcmludEpzb24pewogICAgICB2YXIgcGFydHMgPSBbXSwgc2VsZiA9IHRoaXMsCiAgICAgICAgIG9sZEVsZW1lbnQgPSB0aGlzLmhhc093blByb3BlcnR5KCQkZWxlbWVudCkgPyBzZWxmLiRlbGVtZW50IDogdW5kZWZpbmVkOwogICAgICBzZWxmLiRlbGVtZW50ID0gZWxlbWVudDsKICAgICAgZm9yICggdmFyIGkgPSAwOyBpIDwgYmluZGluZ3MubGVuZ3RoOyBpKyspIHsKICAgICAgICB2YXIgdmFsdWUgPSBiaW5kaW5nc1tpXS5jYWxsKHNlbGYsIGVsZW1lbnQpOwogICAgICAgIGlmIChpc0VsZW1lbnQodmFsdWUpKQogICAgICAgICAgdmFsdWUgPSAnJzsKICAgICAgICBlbHNlIGlmIChpc09iamVjdCh2YWx1ZSkpCiAgICAgICAgICB2YWx1ZSA9IHRvSnNvbih2YWx1ZSwgcHJldHR5UHJpbnRKc29uKTsKICAgICAgICBwYXJ0cy5wdXNoKHZhbHVlKTsKICAgICAgfQogICAgICBzZWxmLiRlbGVtZW50ID0gb2xkRWxlbWVudDsKICAgICAgcmV0dXJuIHBhcnRzLmpvaW4oJycpOwogICAgfTsKICB9CiAgcmV0dXJuIGZuOwp9CgovKioKICogQHdvcmtJblByb2dyZXNzCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgYW5ndWxhci5kaXJlY3RpdmUubmc6YmluZC10ZW1wbGF0ZQogKgogKiBAZGVzY3JpcHRpb24KICogVGhlIGBuZzpiaW5kLXRlbXBsYXRlYCBhdHRyaWJ1dGUgc3BlY2lmaWVzIHRoYXQgdGhlIGVsZW1lbnQKICogdGV4dCBzaG91bGQgYmUgcmVwbGFjZWQgd2l0aCB0aGUgdGVtcGxhdGUgaW4gbmc6YmluZC10ZW1wbGF0ZS4KICogVW5saWtlIG5nOmJpbmQgdGhlIG5nOmJpbmQtdGVtcGxhdGUgY2FuIGNvbnRhaW4gbXVsdGlwbGUgYHt7YCBgfX1gCiAqIGV4cHJlc3Npb25zLiAoVGhpcyBpcyByZXF1aXJlZCBzaW5jZSBzb21lIEhUTUwgZWxlbWVudHMKICogY2FuIG5vdCBoYXZlIFNQQU4gZWxlbWVudHMgc3VjaCBhcyBUSVRMRSwgb3IgT1BUSU9OIHRvIG5hbWUgYSBmZXcuKQogKgogKiBAZWxlbWVudCBBTlkKICogQHBhcmFtIHtzdHJpbmd9IHRlbXBsYXRlIG9mIGZvcm0KICogICA8dHQ+e3s8L3R0PiA8dHQ+ZXhwcmVzc2lvbjwvdHQ+IDx0dD59fTwvdHQ+IHRvIGV2YWwuCiAqCiAqIEBleGFtcGxlCiAqIFRyeSBpdCBoZXJlOiBlbnRlciB0ZXh0IGluIHRleHQgYm94IGFuZCB3YXRjaCB0aGUgZ3JlZXRpbmcgY2hhbmdlLgogICA8ZG9jOmV4YW1wbGU+CiAgICAgPGRvYzpzb3VyY2U+CiAgICAgIFNhbHV0YXRpb246IDxpbnB1dCB0eXBlPSJ0ZXh0IiBuYW1lPSJzYWx1dGF0aW9uIiB2YWx1ZT0iSGVsbG8iPjxici8+CiAgICAgIE5hbWU6IDxpbnB1dCB0eXBlPSJ0ZXh0IiBuYW1lPSJuYW1lIiB2YWx1ZT0iV29ybGQiPjxici8+CiAgICAgIDxwcmUgbmc6YmluZC10ZW1wbGF0ZT0ie3tzYWx1dGF0aW9ufX0ge3tuYW1lfX0hIj48L3ByZT4KICAgICA8L2RvYzpzb3VyY2U+CiAgICAgPGRvYzpzY2VuYXJpbz4KICAgICAgIGl0KCdzaG91bGQgY2hlY2sgbmc6YmluZCcsIGZ1bmN0aW9uKCl7CiAgICAgICAgIGV4cGVjdCh1c2luZygnLmRvYy1leGFtcGxlLWxpdmUnKS5iaW5kaW5nKCd7e3NhbHV0YXRpb259fSB7e25hbWV9fScpKS4KICAgICAgICAgICB0b0JlKCdIZWxsbyBXb3JsZCEnKTsKICAgICAgICAgdXNpbmcoJy5kb2MtZXhhbXBsZS1saXZlJykuaW5wdXQoJ3NhbHV0YXRpb24nKS5lbnRlcignR3JlZXRpbmdzJyk7CiAgICAgICAgIHVzaW5nKCcuZG9jLWV4YW1wbGUtbGl2ZScpLmlucHV0KCduYW1lJykuZW50ZXIoJ3VzZXInKTsKICAgICAgICAgZXhwZWN0KHVzaW5nKCcuZG9jLWV4YW1wbGUtbGl2ZScpLmJpbmRpbmcoJ3t7c2FsdXRhdGlvbn19IHt7bmFtZX19JykpLgogICAgICAgICAgIHRvQmUoJ0dyZWV0aW5ncyB1c2VyIScpOwogICAgICAgfSk7CiAgICAgPC9kb2M6c2NlbmFyaW8+CiAgIDwvZG9jOmV4YW1wbGU+CiAqLwphbmd1bGFyRGlyZWN0aXZlKCJuZzpiaW5kLXRlbXBsYXRlIiwgZnVuY3Rpb24oZXhwcmVzc2lvbiwgZWxlbWVudCl7CiAgZWxlbWVudC5hZGRDbGFzcygnbmctYmluZGluZycpOwogIHZhciB0ZW1wbGF0ZUZuID0gY29tcGlsZUJpbmRUZW1wbGF0ZShleHByZXNzaW9uKTsKICByZXR1cm4gZnVuY3Rpb24oZWxlbWVudCkgewogICAgdmFyIGxhc3RWYWx1ZTsKICAgIHRoaXMuJG9uRXZhbChmdW5jdGlvbigpIHsKICAgICAgdmFyIHZhbHVlID0gdGVtcGxhdGVGbi5jYWxsKHRoaXMsIGVsZW1lbnQsIHRydWUpOwogICAgICBpZiAodmFsdWUgIT0gbGFzdFZhbHVlKSB7CiAgICAgICAgZWxlbWVudC50ZXh0KHZhbHVlKTsKICAgICAgICBsYXN0VmFsdWUgPSB2YWx1ZTsKICAgICAgfQogICAgfSwgZWxlbWVudCk7CiAgfTsKfSk7Cgp2YXIgUkVNT1ZFX0FUVFJJQlVURVMgPSB7CiAgJ2Rpc2FibGVkJzonZGlzYWJsZWQnLAogICdyZWFkb25seSc6J3JlYWRPbmx5JywKICAnY2hlY2tlZCc6J2NoZWNrZWQnLAogICdzZWxlY3RlZCc6J3NlbGVjdGVkJywKICAnbXVsdGlwbGUnOidtdWx0aXBsZScKfTsKLyoqCiAqIEB3b3JrSW5Qcm9ncmVzcwogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIGFuZ3VsYXIuZGlyZWN0aXZlLm5nOmJpbmQtYXR0cgogKgogKiBAZGVzY3JpcHRpb24KICogVGhlIGBuZzpiaW5kLWF0dHJgIGF0dHJpYnV0ZSBzcGVjaWZpZXMgdGhhdAogKiB7QGxpbmsgZ3VpZGUvZGV2X2d1aWRlLnRlbXBsYXRlcy5kYXRhYmluZGluZyBkYXRhYmluZGluZ3N9ICBzaG91bGQgYmUgY3JlYXRlZCBiZXR3ZWVuIGVsZW1lbnQKICogYXR0cmlidXRlcyBhbmQgZ2l2ZW4gZXhwcmVzc2lvbnMuIFVubGlrZSBgbmc6YmluZGAgdGhlIGBuZzpiaW5kLWF0dHJgIGNvbnRhaW5zIGEgSlNPTiBrZXkgdmFsdWUKICogcGFpcnMgcmVwcmVzZW50aW5nIHdoaWNoIGF0dHJpYnV0ZXMgbmVlZCB0byBiZSBtYXBwZWQgdG8gd2hpY2gKICoge0BsaW5rIGd1aWRlL2Rldl9ndWlkZS5leHByZXNzaW9ucyBleHByZXNzaW9uc30uCiAqCiAqIFlvdSBkb24ndCB1c3VhbGx5IHdyaXRlIHRoZSBgbmc6YmluZC1hdHRyYCBpbiB0aGUgSFRNTCBzaW5jZSBlbWJlZGRpbmcKICogPHR0IG5nOm5vbi1iaW5kYWJsZT57e2V4cHJlc3Npb259fTwvdHQ+IGludG8gdGhlIGF0dHJpYnV0ZSBkaXJlY3RseSBhcyB0aGUgYXR0cmlidXRlIHZhbHVlIGlzCiAqIHByZWZlcnJlZC4gVGhlIGF0dHJpYnV0ZXMgZ2V0IHRyYW5zbGF0ZWQgaW50byBgPHNwYW4gbmc6YmluZC1hdHRyPSJ7YXR0cjpleHByZXNzaW9ufSIvPmAgYXQKICogY29tcGlsZSB0aW1lLgogKgogKiBUaGlzIEhUTUwgc25pcHBldCBpcyBwcmVmZXJyZWQgd2F5IG9mIHdvcmtpbmcgd2l0aCBgbmc6YmluZC1hdHRyYAogKiA8cHJlPgogKiAgIDxhIGhyZWY9Imh0dHA6Ly93d3cuZ29vZ2xlLmNvbS9zZWFyY2g/cT17e3F1ZXJ5fX0iPkdvb2dsZTwvYT4KICogPC9wcmU+CiAqCiAqIFRoZSBhYm92ZSBnZXRzIHRyYW5zbGF0ZWQgdG8gYmVsbG93IGR1cmluZyBib290c3RyYXAgdGltZS4KICogPHByZT4KICogICA8YSBuZzpiaW5kLWF0dHI9J3siaHJlZiI6Imh0dHA6Ly93d3cuZ29vZ2xlLmNvbS9zZWFyY2g/cT17e3F1ZXJ5fX0ifSc+R29vZ2xlPC9hPgogKiA8L3ByZT4KICoKICogQGVsZW1lbnQgQU5ZCiAqIEBwYXJhbSB7c3RyaW5nfSBhdHRyaWJ1dGVfanNvbiBhIEpTT04ga2V5LXZhbHVlIHBhaXJzIHJlcHJlc2VudGluZwogKiAgICB0aGUgYXR0cmlidXRlcyB0byByZXBsYWNlLiBFYWNoIGtleSBtYXRjaGVzIHRoZSBhdHRyaWJ1dGUKICogICAgd2hpY2ggbmVlZHMgdG8gYmUgcmVwbGFjZWQuIEVhY2ggdmFsdWUgaXMgYSB0ZXh0IHRlbXBsYXRlIG9mCiAqICAgIHRoZSBhdHRyaWJ1dGUgd2l0aCBlbWJlZGRlZAogKiAgICA8dHQgbmc6bm9uLWJpbmRhYmxlPnt7ZXhwcmVzc2lvbn19PC90dD5zLiBBbnkgbnVtYmVyIG9mCiAqICAgIGtleS12YWx1ZSBwYWlycyBjYW4gYmUgc3BlY2lmaWVkLgogKgogKiBAZXhhbXBsZQogKiBUcnkgaXQgaGVyZTogZW50ZXIgdGV4dCBpbiB0ZXh0IGJveCBhbmQgY2xpY2sgR29vZ2xlLgogICA8ZG9jOmV4YW1wbGU+CiAgICAgPGRvYzpzb3VyY2U+CiAgICAgIEdvb2dsZSBmb3I6CiAgICAgIDxpbnB1dCB0eXBlPSJ0ZXh0IiBuYW1lPSJxdWVyeSIgdmFsdWU9IkFuZ3VsYXJKUyIvPgogICAgICA8YSBocmVmPSJodHRwOi8vd3d3Lmdvb2dsZS5jb20vc2VhcmNoP3E9e3txdWVyeX19Ij5Hb29nbGU8L2E+CiAgICAgPC9kb2M6c291cmNlPgogICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgICBpdCgnc2hvdWxkIGNoZWNrIG5nOmJpbmQtYXR0cicsIGZ1bmN0aW9uKCl7CiAgICAgICAgIGV4cGVjdCh1c2luZygnLmRvYy1leGFtcGxlLWxpdmUnKS5lbGVtZW50KCdhJykuYXR0cignaHJlZicpKS4KICAgICAgICAgICB0b0JlKCdodHRwOi8vd3d3Lmdvb2dsZS5jb20vc2VhcmNoP3E9QW5ndWxhckpTJyk7CiAgICAgICAgIHVzaW5nKCcuZG9jLWV4YW1wbGUtbGl2ZScpLmlucHV0KCdxdWVyeScpLmVudGVyKCdnb29nbGUnKTsKICAgICAgICAgZXhwZWN0KHVzaW5nKCcuZG9jLWV4YW1wbGUtbGl2ZScpLmVsZW1lbnQoJ2EnKS5hdHRyKCdocmVmJykpLgogICAgICAgICAgIHRvQmUoJ2h0dHA6Ly93d3cuZ29vZ2xlLmNvbS9zZWFyY2g/cT1nb29nbGUnKTsKICAgICAgIH0pOwogICAgIDwvZG9jOnNjZW5hcmlvPgogICA8L2RvYzpleGFtcGxlPgogKi8KYW5ndWxhckRpcmVjdGl2ZSgibmc6YmluZC1hdHRyIiwgZnVuY3Rpb24oZXhwcmVzc2lvbil7CiAgcmV0dXJuIGZ1bmN0aW9uKGVsZW1lbnQpewogICAgdmFyIGxhc3RWYWx1ZSA9IHt9OwogICAgdGhpcy4kb25FdmFsKGZ1bmN0aW9uKCl7CiAgICAgIHZhciB2YWx1ZXMgPSB0aGlzLiRldmFsKGV4cHJlc3Npb24pOwogICAgICBmb3IodmFyIGtleSBpbiB2YWx1ZXMpIHsKICAgICAgICB2YXIgdmFsdWUgPSBjb21waWxlQmluZFRlbXBsYXRlKHZhbHVlc1trZXldKS5jYWxsKHRoaXMsIGVsZW1lbnQpLAogICAgICAgICAgICBzcGVjaWFsTmFtZSA9IFJFTU9WRV9BVFRSSUJVVEVTW2xvd2VyY2FzZShrZXkpXTsKICAgICAgICBpZiAobGFzdFZhbHVlW2tleV0gIT09IHZhbHVlKSB7CiAgICAgICAgICBsYXN0VmFsdWVba2V5XSA9IHZhbHVlOwogICAgICAgICAgaWYgKHNwZWNpYWxOYW1lKSB7CiAgICAgICAgICAgIGlmICh0b0Jvb2xlYW4odmFsdWUpKSB7CiAgICAgICAgICAgICAgZWxlbWVudC5hdHRyKHNwZWNpYWxOYW1lLCBzcGVjaWFsTmFtZSk7CiAgICAgICAgICAgICAgZWxlbWVudC5hdHRyKCduZy0nICsgc3BlY2lhbE5hbWUsIHZhbHVlKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBlbGVtZW50LnJlbW92ZUF0dHIoc3BlY2lhbE5hbWUpOwogICAgICAgICAgICAgIGVsZW1lbnQucmVtb3ZlQXR0cignbmctJyArIHNwZWNpYWxOYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAoZWxlbWVudC5kYXRhKCQkdmFsaWRhdGUpfHxub29wKSgpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZWxlbWVudC5hdHRyKGtleSwgdmFsdWUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfSwgZWxlbWVudCk7CiAgfTsKfSk7CgoKLyoqCiAqIEB3b3JrSW5Qcm9ncmVzcwogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIGFuZ3VsYXIuZGlyZWN0aXZlLm5nOmNsaWNrCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBUaGUgbmc6Y2xpY2sgYWxsb3dzIHlvdSB0byBzcGVjaWZ5IGN1c3RvbSBiZWhhdmlvciB3aGVuCiAqIGVsZW1lbnQgaXMgY2xpY2tlZC4KICoKICogQGVsZW1lbnQgQU5ZCiAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gZXhwcmVzc2lvbiB7QGxpbmsgZ3VpZGUvZGV2X2d1aWRlLmV4cHJlc3Npb25zIEV4cHJlc3Npb259IHRvIGV2YWwgdXBvbiBjbGljay4KICoKICogQGV4YW1wbGUKICAgPGRvYzpleGFtcGxlPgogICAgIDxkb2M6c291cmNlPgogICAgICA8YnV0dG9uIG5nOmNsaWNrPSJjb3VudCA9IGNvdW50ICsgMSIgbmc6aW5pdD0iY291bnQ9MCI+CiAgICAgICAgSW5jcmVtZW50CiAgICAgIDwvYnV0dG9uPgogICAgICBjb3VudDoge3tjb3VudH19CiAgICAgPC9kb2M6c291cmNlPgogICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgICBpdCgnc2hvdWxkIGNoZWNrIG5nOmNsaWNrJywgZnVuY3Rpb24oKXsKICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ2NvdW50JykpLnRvQmUoJzAnKTsKICAgICAgICAgZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgOmJ1dHRvbicpLmNsaWNrKCk7CiAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdjb3VudCcpKS50b0JlKCcxJyk7CiAgICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgPC9kb2M6ZXhhbXBsZT4KICovCi8qCiAqIEEgZGlyZWN0aXZlIHRoYXQgYWxsb3dzIGNyZWF0aW9uIG9mIGN1c3RvbSBvbmNsaWNrIGhhbmRsZXJzIHRoYXQgYXJlIGRlZmluZWQgYXMgYW5ndWxhcgogKiBleHByZXNzaW9ucyBhbmQgYXJlIGNvbXBpbGVkIGFuZCBleGVjdXRlZCB3aXRoaW4gdGhlIGN1cnJlbnQgc2NvcGUuCiAqCiAqIEV2ZW50cyB0aGF0IGFyZSBoYW5kbGVkIHZpYSB0aGVzZSBoYW5kbGVyIGFyZSBhbHdheXMgY29uZmlndXJlZCBub3QgdG8gcHJvcGFnYXRlIGZ1cnRoZXIuCiAqCiAqIFRPRE86IG1heWJlIHdlIHNob3VsZCBjb25zaWRlciBhbGxvd2luZyB1c2VycyB0byBjb250cm9sIGV2ZW50IHByb3BhZ2F0aW9uIGluIHRoZSBmdXR1cmUuCiAqLwphbmd1bGFyRGlyZWN0aXZlKCJuZzpjbGljayIsIGZ1bmN0aW9uKGV4cHJlc3Npb24sIGVsZW1lbnQpewogIHJldHVybiBhbm5vdGF0ZSgnJHVwZGF0ZVZpZXcnLCBmdW5jdGlvbigkdXBkYXRlVmlldywgZWxlbWVudCl7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICBlbGVtZW50LmJpbmQoJ2NsaWNrJywgZnVuY3Rpb24oZXZlbnQpewogICAgICBzZWxmLiR0cnlFdmFsKGV4cHJlc3Npb24sIGVsZW1lbnQpOwogICAgICAkdXBkYXRlVmlldygpOwogICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTsKICAgIH0pOwogIH0pOwp9KTsKCgovKioKICogQHdvcmtJblByb2dyZXNzCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgYW5ndWxhci5kaXJlY3RpdmUubmc6c3VibWl0CiAqCiAqIEBkZXNjcmlwdGlvbgogKiBFbmFibGVzIGJpbmRpbmcgYW5ndWxhciBleHByZXNzaW9ucyB0byBvbnN1Ym1pdCBldmVudHMuCiAqCiAqIEFkZGl0aW9uYWxseSBpdCBwcmV2ZW50cyB0aGUgZGVmYXVsdCBhY3Rpb24gKHdoaWNoIGZvciBmb3JtIG1lYW5zIHNlbmRpbmcgdGhlIHJlcXVlc3QgdG8gdGhlCiAqIHNlcnZlciBhbmQgcmVsb2FkaW5nIHRoZSBjdXJyZW50IHBhZ2UpLgogKgogKiBAZWxlbWVudCBmb3JtCiAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gZXhwcmVzc2lvbiB7QGxpbmsgZ3VpZGUvZGV2X2d1aWRlLmV4cHJlc3Npb25zIEV4cHJlc3Npb259IHRvIGV2YWwuCiAqCiAqIEBleGFtcGxlCiAgIDxkb2M6ZXhhbXBsZT4KICAgICA8ZG9jOnNvdXJjZT4KICAgICAgPGZvcm0gbmc6c3VibWl0PSJsaXN0LnB1c2godGV4dCk7dGV4dD0nJzsiIG5nOmluaXQ9Imxpc3Q9W10iPgogICAgICAgIEVudGVyIHRleHQgYW5kIGhpdCBlbnRlcjoKICAgICAgICA8aW5wdXQgdHlwZT0idGV4dCIgbmFtZT0idGV4dCIgdmFsdWU9ImhlbGxvIi8+CiAgICAgICAgPGlucHV0IHR5cGU9InN1Ym1pdCIgaWQ9InN1Ym1pdCIgdmFsdWU9IlN1Ym1pdCIgLz4KICAgICAgPC9mb3JtPgogICAgICA8cHJlPmxpc3Q9e3tsaXN0fX08L3ByZT4KICAgICA8L2RvYzpzb3VyY2U+CiAgICAgPGRvYzpzY2VuYXJpbz4KICAgICAgIGl0KCdzaG91bGQgY2hlY2sgbmc6c3VibWl0JywgZnVuY3Rpb24oKXsKICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ2xpc3QnKSkudG9CZSgnbGlzdD1bXScpOwogICAgICAgICBlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSAjc3VibWl0JykuY2xpY2soKTsKICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ2xpc3QnKSkudG9CZSgnbGlzdD1bImhlbGxvIl0nKTsKICAgICAgIH0pOwogICAgIDwvZG9jOnNjZW5hcmlvPgogICA8L2RvYzpleGFtcGxlPgogKi8KYW5ndWxhckRpcmVjdGl2ZSgibmc6c3VibWl0IiwgZnVuY3Rpb24oZXhwcmVzc2lvbiwgZWxlbWVudCkgewogIHJldHVybiBhbm5vdGF0ZSgnJHVwZGF0ZVZpZXcnLCBmdW5jdGlvbigkdXBkYXRlVmlldywgZWxlbWVudCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgZWxlbWVudC5iaW5kKCdzdWJtaXQnLCBmdW5jdGlvbihldmVudCkgewogICAgICBzZWxmLiR0cnlFdmFsKGV4cHJlc3Npb24sIGVsZW1lbnQpOwogICAgICAkdXBkYXRlVmlldygpOwogICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgfSk7CiAgfSk7Cn0pOwoKCmZ1bmN0aW9uIG5nQ2xhc3Moc2VsZWN0b3IpIHsKICByZXR1cm4gZnVuY3Rpb24oZXhwcmVzc2lvbiwgZWxlbWVudCl7CiAgICB2YXIgZXhpc3RpbmcgPSBlbGVtZW50WzBdLmNsYXNzTmFtZSArICcgJzsKICAgIHJldHVybiBmdW5jdGlvbihlbGVtZW50KXsKICAgICAgdGhpcy4kb25FdmFsKGZ1bmN0aW9uKCl7CiAgICAgICAgdmFyIHNjb3BlID0gdGhpczsKCiAgICAgICAgaWYgKHNlbGVjdG9yKHNjb3BlLiRpbmRleCkpIHsKICAgICAgICAgIHZhciBuZ0NsYXNzVmFsID0gc2NvcGUuJGV2YWwoZWxlbWVudC5hdHRyKCduZzpjbGFzcycpIHx8ICcnKTsKICAgICAgICAgIGlmIChpc0FycmF5KG5nQ2xhc3NWYWwpKSBuZ0NsYXNzVmFsID0gbmdDbGFzc1ZhbC5qb2luKCcgJyk7CiAgICAgICAgICB2YXIgdmFsdWUgPSBzY29wZS4kZXZhbChleHByZXNzaW9uKTsKICAgICAgICAgIGlmIChpc0FycmF5KHZhbHVlKSkgdmFsdWUgPSB2YWx1ZS5qb2luKCcgJyk7CiAgICAgICAgICBpZiAobmdDbGFzc1ZhbCAmJiBuZ0NsYXNzVmFsICE9PSB2YWx1ZSkgdmFsdWUgPSB2YWx1ZSArICcgJyArIG5nQ2xhc3NWYWw7CiAgICAgICAgICBlbGVtZW50WzBdLmNsYXNzTmFtZSA9IHRyaW0oZXhpc3RpbmcgKyB2YWx1ZSk7CiAgICAgICAgfQogICAgICB9LCBlbGVtZW50KTsKICAgIH07CiAgfTsKfQoKLyoqCiAqIEB3b3JrSW5Qcm9ncmVzcwogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIGFuZ3VsYXIuZGlyZWN0aXZlLm5nOmNsYXNzCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBUaGUgYG5nOmNsYXNzYCBhbGxvd3MgeW91IHRvIHNldCBDU1MgY2xhc3Mgb24gSFRNTCBlbGVtZW50CiAqIGNvbmRpdGlvbmFsbHkuCiAqCiAqIEBlbGVtZW50IEFOWQogKiBAcGFyYW0ge2V4cHJlc3Npb259IGV4cHJlc3Npb24ge0BsaW5rIGd1aWRlL2Rldl9ndWlkZS5leHByZXNzaW9ucyBFeHByZXNzaW9ufSB0byBldmFsLgogKgogKiBAZXhhbXBsZQogICA8ZG9jOmV4YW1wbGU+CiAgICAgPGRvYzpzb3VyY2U+CiAgICAgIDxpbnB1dCB0eXBlPSJidXR0b24iIHZhbHVlPSJzZXQiIG5nOmNsaWNrPSJteVZhcj0nbmctaW5wdXQtaW5kaWNhdG9yLXdhaXQnIj4KICAgICAgPGlucHV0IHR5cGU9ImJ1dHRvbiIgdmFsdWU9ImNsZWFyIiBuZzpjbGljaz0ibXlWYXI9JyciPgogICAgICA8YnI+CiAgICAgIDxzcGFuIG5nOmNsYXNzPSJteVZhciI+U2FtcGxlIFRleHQgJm5ic3A7Jm5ic3A7Jm5ic3A7Jm5ic3A7PC9zcGFuPgogICAgIDwvZG9jOnNvdXJjZT4KICAgICA8ZG9jOnNjZW5hcmlvPgogICAgICAgaXQoJ3Nob3VsZCBjaGVjayBuZzpjbGFzcycsIGZ1bmN0aW9uKCl7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBzcGFuJykuYXR0cignY2xhc3NOYW1lJykpLm5vdCgpLgogICAgICAgICAgIHRvTWF0Y2goL25nLWlucHV0LWluZGljYXRvci13YWl0Lyk7CgogICAgICAgICB1c2luZygnLmRvYy1leGFtcGxlLWxpdmUnKS5lbGVtZW50KCc6YnV0dG9uOmZpcnN0JykuY2xpY2soKTsKCiAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBzcGFuJykuYXR0cignY2xhc3NOYW1lJykpLgogICAgICAgICAgIHRvTWF0Y2goL25nLWlucHV0LWluZGljYXRvci13YWl0Lyk7CgogICAgICAgICB1c2luZygnLmRvYy1leGFtcGxlLWxpdmUnKS5lbGVtZW50KCc6YnV0dG9uOmxhc3QnKS5jbGljaygpOwoKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIHNwYW4nKS5hdHRyKCdjbGFzc05hbWUnKSkubm90KCkuCiAgICAgICAgICAgdG9NYXRjaCgvbmctaW5wdXQtaW5kaWNhdG9yLXdhaXQvKTsKICAgICAgIH0pOwogICAgIDwvZG9jOnNjZW5hcmlvPgogICA8L2RvYzpleGFtcGxlPgogKi8KYW5ndWxhckRpcmVjdGl2ZSgibmc6Y2xhc3MiLCBuZ0NsYXNzKGZ1bmN0aW9uKCl7cmV0dXJuIHRydWU7fSkpOwoKLyoqCiAqIEB3b3JrSW5Qcm9ncmVzcwogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIGFuZ3VsYXIuZGlyZWN0aXZlLm5nOmNsYXNzLW9kZAogKgogKiBAZGVzY3JpcHRpb24KICogVGhlIGBuZzpjbGFzcy1vZGRgIGFuZCBgbmc6Y2xhc3MtZXZlbmAgd29ya3MgZXhhY3RseSBhcwogKiBgbmc6Y2xhc3NgLCBleGNlcHQgaXQgd29ya3MgaW4gY29uanVuY3Rpb24gd2l0aCBgbmc6cmVwZWF0YAogKiBhbmQgdGFrZXMgYWZmZWN0IG9ubHkgb24gb2RkIChldmVuKSByb3dzLgogKgogKiBAZWxlbWVudCBBTlkKICogQHBhcmFtIHtleHByZXNzaW9ufSBleHByZXNzaW9uIHtAbGluayBndWlkZS9kZXZfZ3VpZGUuZXhwcmVzc2lvbnMgRXhwcmVzc2lvbn0gdG8gZXZhbC4gTXVzdCBiZQogKiAgaW5zaWRlIGBuZzpyZXBlYXRgLgogKgogKiBAZXhhbXBsZQogICA8ZG9jOmV4YW1wbGU+CiAgICAgPGRvYzpzb3VyY2U+CiAgICAgICAgPG9sIG5nOmluaXQ9Im5hbWVzPVsnSm9obicsICdNYXJ5JywgJ0NhdGUnLCAnU3V6J10iPgogICAgICAgICAgPGxpIG5nOnJlcGVhdD0ibmFtZSBpbiBuYW1lcyI+CiAgICAgICAgICAgPHNwYW4gbmc6Y2xhc3Mtb2RkPSInbmctZm9ybWF0LW5lZ2F0aXZlJyIKICAgICAgICAgICAgICAgICBuZzpjbGFzcy1ldmVuPSInbmctaW5wdXQtaW5kaWNhdG9yLXdhaXQnIj4KICAgICAgICAgICAgIHt7bmFtZX19ICZuYnNwOyAmbmJzcDsgJm5ic3A7CiAgICAgICAgICAgPC9zcGFuPgogICAgICAgICAgPC9saT4KICAgICAgICA8L29sPgogICAgIDwvZG9jOnNvdXJjZT4KICAgICA8ZG9jOnNjZW5hcmlvPgogICAgICAgaXQoJ3Nob3VsZCBjaGVjayBuZzpjbGFzcy1vZGQgYW5kIG5nOmNsYXNzLWV2ZW4nLCBmdW5jdGlvbigpewogICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgbGk6Zmlyc3Qgc3BhbicpLmF0dHIoJ2NsYXNzTmFtZScpKS4KICAgICAgICAgICB0b01hdGNoKC9uZy1mb3JtYXQtbmVnYXRpdmUvKTsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIGxpOmxhc3Qgc3BhbicpLmF0dHIoJ2NsYXNzTmFtZScpKS4KICAgICAgICAgICB0b01hdGNoKC9uZy1pbnB1dC1pbmRpY2F0b3Itd2FpdC8pOwogICAgICAgfSk7CiAgICAgPC9kb2M6c2NlbmFyaW8+CiAgIDwvZG9jOmV4YW1wbGU+CiAqLwphbmd1bGFyRGlyZWN0aXZlKCJuZzpjbGFzcy1vZGQiLCBuZ0NsYXNzKGZ1bmN0aW9uKGkpe3JldHVybiBpICUgMiA9PT0gMDt9KSk7CgovKioKICogQHdvcmtJblByb2dyZXNzCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgYW5ndWxhci5kaXJlY3RpdmUubmc6Y2xhc3MtZXZlbgogKgogKiBAZGVzY3JpcHRpb24KICogVGhlIGBuZzpjbGFzcy1vZGRgIGFuZCBgbmc6Y2xhc3MtZXZlbmAgd29ya3MgZXhhY3RseSBhcwogKiBgbmc6Y2xhc3NgLCBleGNlcHQgaXQgd29ya3MgaW4gY29uanVuY3Rpb24gd2l0aCBgbmc6cmVwZWF0YAogKiBhbmQgdGFrZXMgYWZmZWN0IG9ubHkgb24gb2RkIChldmVuKSByb3dzLgogKgogKiBAZWxlbWVudCBBTlkKICogQHBhcmFtIHtleHByZXNzaW9ufSBleHByZXNzaW9uIHtAbGluayBndWlkZS9kZXZfZ3VpZGUuZXhwcmVzc2lvbnMgRXhwcmVzc2lvbn0gdG8gZXZhbC4gTXVzdCBiZQogKiAgaW5zaWRlIGBuZzpyZXBlYXRgLgogKgogKiBAZXhhbXBsZQogICA8ZG9jOmV4YW1wbGU+CiAgICAgPGRvYzpzb3VyY2U+CiAgICAgICAgPG9sIG5nOmluaXQ9Im5hbWVzPVsnSm9obicsICdNYXJ5JywgJ0NhdGUnLCAnU3V6J10iPgogICAgICAgICAgPGxpIG5nOnJlcGVhdD0ibmFtZSBpbiBuYW1lcyI+CiAgICAgICAgICAgPHNwYW4gbmc6Y2xhc3Mtb2RkPSInbmctZm9ybWF0LW5lZ2F0aXZlJyIKICAgICAgICAgICAgICAgICBuZzpjbGFzcy1ldmVuPSInbmctaW5wdXQtaW5kaWNhdG9yLXdhaXQnIj4KICAgICAgICAgICAgIHt7bmFtZX19ICZuYnNwOyAmbmJzcDsgJm5ic3A7CiAgICAgICAgICAgPC9zcGFuPgogICAgICAgICAgPC9saT4KICAgICAgICA8L29sPgogICAgIDwvZG9jOnNvdXJjZT4KICAgICA8ZG9jOnNjZW5hcmlvPgogICAgICAgaXQoJ3Nob3VsZCBjaGVjayBuZzpjbGFzcy1vZGQgYW5kIG5nOmNsYXNzLWV2ZW4nLCBmdW5jdGlvbigpewogICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgbGk6Zmlyc3Qgc3BhbicpLmF0dHIoJ2NsYXNzTmFtZScpKS4KICAgICAgICAgICB0b01hdGNoKC9uZy1mb3JtYXQtbmVnYXRpdmUvKTsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIGxpOmxhc3Qgc3BhbicpLmF0dHIoJ2NsYXNzTmFtZScpKS4KICAgICAgICAgICB0b01hdGNoKC9uZy1pbnB1dC1pbmRpY2F0b3Itd2FpdC8pOwogICAgICAgfSk7CiAgICAgPC9kb2M6c2NlbmFyaW8+CiAgIDwvZG9jOmV4YW1wbGU+CiAqLwphbmd1bGFyRGlyZWN0aXZlKCJuZzpjbGFzcy1ldmVuIiwgbmdDbGFzcyhmdW5jdGlvbihpKXtyZXR1cm4gaSAlIDIgPT09IDE7fSkpOwoKLyoqCiAqIEB3b3JrSW5Qcm9ncmVzcwogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIGFuZ3VsYXIuZGlyZWN0aXZlLm5nOnNob3cKICoKICogQGRlc2NyaXB0aW9uCiAqIFRoZSBgbmc6c2hvd2AgYW5kIGBuZzpoaWRlYCBkaXJlY3RpdmVzIHNob3cgb3IgaGlkZSBhIHBvcnRpb24gb2YgdGhlIERPTSB0cmVlIChIVE1MKQogKiBjb25kaXRpb25hbGx5LgogKgogKiBAZWxlbWVudCBBTlkKICogQHBhcmFtIHtleHByZXNzaW9ufSBleHByZXNzaW9uIElmIHRoZSB7QGxpbmsgZ3VpZGUvZGV2X2d1aWRlLmV4cHJlc3Npb25zIGV4cHJlc3Npb259IGlzIHRydXRoeQogKiAgICAgdGhlbiB0aGUgZWxlbWVudCBpcyBzaG93biBvciBoaWRkZW4gcmVzcGVjdGl2ZWx5LgogKgogKiBAZXhhbXBsZQogICA8ZG9jOmV4YW1wbGU+CiAgICAgPGRvYzpzb3VyY2U+CiAgICAgICAgQ2xpY2sgbWU6IDxpbnB1dCB0eXBlPSJjaGVja2JveCIgbmFtZT0iY2hlY2tlZCI+PGJyLz4KICAgICAgICBTaG93OiA8c3BhbiBuZzpzaG93PSJjaGVja2VkIj5JIHNob3cgdXAgd2hlbiB5b3VyIGNoZWNrYm94IGlzIGNoZWNrZWQuPC9zcGFuPiA8YnIvPgogICAgICAgIEhpZGU6IDxzcGFuIG5nOmhpZGU9ImNoZWNrZWQiPkkgaGlkZSB3aGVuIHlvdXIgY2hlY2tib3ggaXMgY2hlY2tlZC48L3NwYW4+CiAgICAgPC9kb2M6c291cmNlPgogICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgICBpdCgnc2hvdWxkIGNoZWNrIG5nOnNob3cgLyBuZzpoaWRlJywgZnVuY3Rpb24oKXsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIHNwYW46Zmlyc3Q6aGlkZGVuJykuY291bnQoKSkudG9FcXVhbCgxKTsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIHNwYW46bGFzdDp2aXNpYmxlJykuY291bnQoKSkudG9FcXVhbCgxKTsKCiAgICAgICAgIGlucHV0KCdjaGVja2VkJykuY2hlY2soKTsKCiAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBzcGFuOmZpcnN0OnZpc2libGUnKS5jb3VudCgpKS50b0VxdWFsKDEpOwogICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgc3BhbjpsYXN0OmhpZGRlbicpLmNvdW50KCkpLnRvRXF1YWwoMSk7CiAgICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgPC9kb2M6ZXhhbXBsZT4KICovCmFuZ3VsYXJEaXJlY3RpdmUoIm5nOnNob3ciLCBmdW5jdGlvbihleHByZXNzaW9uLCBlbGVtZW50KXsKICByZXR1cm4gZnVuY3Rpb24oZWxlbWVudCl7CiAgICB0aGlzLiRvbkV2YWwoZnVuY3Rpb24oKXsKICAgICAgZWxlbWVudC5jc3MoJ2Rpc3BsYXknLCB0b0Jvb2xlYW4odGhpcy4kZXZhbChleHByZXNzaW9uKSkgPyAnJyA6ICdub25lJyk7CiAgICB9LCBlbGVtZW50KTsKICB9Owp9KTsKCi8qKgogKiBAd29ya0luUHJvZ3Jlc3MKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBhbmd1bGFyLmRpcmVjdGl2ZS5uZzpoaWRlCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBUaGUgYG5nOmhpZGVgIGFuZCBgbmc6c2hvd2AgZGlyZWN0aXZlcyBoaWRlIG9yIHNob3cgYSBwb3J0aW9uCiAqIG9mIHRoZSBIVE1MIGNvbmRpdGlvbmFsbHkuCiAqCiAqIEBlbGVtZW50IEFOWQogKiBAcGFyYW0ge2V4cHJlc3Npb259IGV4cHJlc3Npb24gSWYgdGhlIHtAbGluayBndWlkZS9kZXZfZ3VpZGUuZXhwcmVzc2lvbnMgZXhwcmVzc2lvbn0gdHJ1dGh5IHRoZW4KICogICAgIHRoZSBlbGVtZW50IGlzIHNob3duIG9yIGhpZGRlbiByZXNwZWN0aXZlbHkuCiAqCiAqIEBleGFtcGxlCiAgIDxkb2M6ZXhhbXBsZT4KICAgICA8ZG9jOnNvdXJjZT4KICAgICAgICBDbGljayBtZTogPGlucHV0IHR5cGU9ImNoZWNrYm94IiBuYW1lPSJjaGVja2VkIj48YnIvPgogICAgICAgIFNob3c6IDxzcGFuIG5nOnNob3c9ImNoZWNrZWQiPkkgc2hvdyB1cCB3aGVuIHlvdSBjaGVja2JveCBpcyBjaGVja2VkPzwvc3Bhbj4gPGJyLz4KICAgICAgICBIaWRlOiA8c3BhbiBuZzpoaWRlPSJjaGVja2VkIj5JIGhpZGUgd2hlbiB5b3UgY2hlY2tib3ggaXMgY2hlY2tlZD88L3NwYW4+CiAgICAgPC9kb2M6c291cmNlPgogICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgICBpdCgnc2hvdWxkIGNoZWNrIG5nOnNob3cgLyBuZzpoaWRlJywgZnVuY3Rpb24oKXsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIHNwYW46Zmlyc3Q6aGlkZGVuJykuY291bnQoKSkudG9FcXVhbCgxKTsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIHNwYW46bGFzdDp2aXNpYmxlJykuY291bnQoKSkudG9FcXVhbCgxKTsKCiAgICAgICAgIGlucHV0KCdjaGVja2VkJykuY2hlY2soKTsKCiAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBzcGFuOmZpcnN0OnZpc2libGUnKS5jb3VudCgpKS50b0VxdWFsKDEpOwogICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgc3BhbjpsYXN0OmhpZGRlbicpLmNvdW50KCkpLnRvRXF1YWwoMSk7CiAgICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgPC9kb2M6ZXhhbXBsZT4KICovCmFuZ3VsYXJEaXJlY3RpdmUoIm5nOmhpZGUiLCBmdW5jdGlvbihleHByZXNzaW9uLCBlbGVtZW50KXsKICByZXR1cm4gZnVuY3Rpb24oZWxlbWVudCl7CiAgICB0aGlzLiRvbkV2YWwoZnVuY3Rpb24oKXsKICAgICAgZWxlbWVudC5jc3MoJ2Rpc3BsYXknLCB0b0Jvb2xlYW4odGhpcy4kZXZhbChleHByZXNzaW9uKSkgPyAnbm9uZScgOiAnJyk7CiAgICB9LCBlbGVtZW50KTsKICB9Owp9KTsKCi8qKgogKiBAd29ya0luUHJvZ3Jlc3MKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBhbmd1bGFyLmRpcmVjdGl2ZS5uZzpzdHlsZQogKgogKiBAZGVzY3JpcHRpb24KICogVGhlIG5nOnN0eWxlIGFsbG93cyB5b3UgdG8gc2V0IENTUyBzdHlsZSBvbiBhbiBIVE1MIGVsZW1lbnQgY29uZGl0aW9uYWxseS4KICoKICogQGVsZW1lbnQgQU5ZCiAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gZXhwcmVzc2lvbiB7QGxpbmsgZ3VpZGUvZGV2X2d1aWRlLmV4cHJlc3Npb25zIEV4cHJlc3Npb259IHdoaWNoIGV2YWxzIHRvIGFuCiAqICAgICAgb2JqZWN0IHdob3NlIGtleXMgYXJlIENTUyBzdHlsZSBuYW1lcyBhbmQgdmFsdWVzIGFyZSBjb3JyZXNwb25kaW5nIHZhbHVlcyBmb3IgdGhvc2UgQ1NTCiAqICAgICAga2V5cy4KICoKICogQGV4YW1wbGUKICAgPGRvYzpleGFtcGxlPgogICAgIDxkb2M6c291cmNlPgogICAgICAgIDxpbnB1dCB0eXBlPSJidXR0b24iIHZhbHVlPSJzZXQiIG5nOmNsaWNrPSJteVN0eWxlPXtjb2xvcjoncmVkJ30iPgogICAgICAgIDxpbnB1dCB0eXBlPSJidXR0b24iIHZhbHVlPSJjbGVhciIgbmc6Y2xpY2s9Im15U3R5bGU9e30iPgogICAgICAgIDxici8+CiAgICAgICAgPHNwYW4gbmc6c3R5bGU9Im15U3R5bGUiPlNhbXBsZSBUZXh0PC9zcGFuPgogICAgICAgIDxwcmU+bXlTdHlsZT17e215U3R5bGV9fTwvcHJlPgogICAgIDwvZG9jOnNvdXJjZT4KICAgICA8ZG9jOnNjZW5hcmlvPgogICAgICAgaXQoJ3Nob3VsZCBjaGVjayBuZzpzdHlsZScsIGZ1bmN0aW9uKCl7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBzcGFuJykuY3NzKCdjb2xvcicpKS50b0JlKCdyZ2IoMCwgMCwgMCknKTsKICAgICAgICAgZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgOmJ1dHRvblt2YWx1ZT1zZXRdJykuY2xpY2soKTsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIHNwYW4nKS5jc3MoJ2NvbG9yJykpLnRvQmUoJ3JlZCcpOwogICAgICAgICBlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSA6YnV0dG9uW3ZhbHVlPWNsZWFyXScpLmNsaWNrKCk7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBzcGFuJykuY3NzKCdjb2xvcicpKS50b0JlKCdyZ2IoMCwgMCwgMCknKTsKICAgICAgIH0pOwogICAgIDwvZG9jOnNjZW5hcmlvPgogICA8L2RvYzpleGFtcGxlPgogKi8KYW5ndWxhckRpcmVjdGl2ZSgibmc6c3R5bGUiLCBmdW5jdGlvbihleHByZXNzaW9uLCBlbGVtZW50KXsKICByZXR1cm4gZnVuY3Rpb24oZWxlbWVudCl7CiAgICB2YXIgcmVzZXRTdHlsZSA9IGdldFN0eWxlKGVsZW1lbnQpOwogICAgdGhpcy4kb25FdmFsKGZ1bmN0aW9uKCl7CiAgICAgIHZhciBzdHlsZSA9IHRoaXMuJGV2YWwoZXhwcmVzc2lvbikgfHwge30sIGtleSwgbWVyZ2VkU3R5bGUgPSB7fTsKICAgICAgZm9yKGtleSBpbiBzdHlsZSkgewogICAgICAgIGlmIChyZXNldFN0eWxlW2tleV0gPT09IHVuZGVmaW5lZCkgcmVzZXRTdHlsZVtrZXldID0gJyc7CiAgICAgICAgbWVyZ2VkU3R5bGVba2V5XSA9IHN0eWxlW2tleV07CiAgICAgIH0KICAgICAgZm9yKGtleSBpbiByZXNldFN0eWxlKSB7CiAgICAgICAgbWVyZ2VkU3R5bGVba2V5XSA9IG1lcmdlZFN0eWxlW2tleV0gfHwgcmVzZXRTdHlsZVtrZXldOwogICAgICB9CiAgICAgIGVsZW1lbnQuY3NzKG1lcmdlZFN0eWxlKTsKICAgIH0sIGVsZW1lbnQpOwogIH07Cn0pOwoKJ3VzZSBzdHJpY3QnOwoKLyoqCiAqIEB3b3JrSW5Qcm9ncmVzcwogKiBAbmdkb2Mgb3ZlcnZpZXcKICogQG5hbWUgYW5ndWxhci5tYXJrdXAKICogQGRlc2NyaXB0aW9uCiAqCiAqIEFuZ3VsYXIgbWFya3VwIHRyYW5zZm9ybXMgY29udGVudCBvZiBET00gZWxlbWVudHMgb3IgcG9ydGlvbnMgb2YgdGhpcyBjb250ZW50IGludG8gb3RoZXIgdGV4dCBvcgogKiBET00gZWxlbWVudHMgZm9yIGZ1cnRoZXIgY29tcGlsYXRpb24uCiAqCiAqIE1hcmt1cCBleHRlbnNpb25zIGRvIG5vdCB0aGVtc2VsdmVzIHByb2R1Y2UgbGlua2luZyBmdW5jdGlvbnMuIFRoaW5rIG9mIG1hcmt1cCBhcyBhIHdheSB0bwogKiBwcm9kdWNlIHNob3J0aGFuZCBmb3IgYSB7QGxpbmsgYW5ndWxhci53aWRnZXQgd2lkZ2V0fSBvciBhIHtAbGluayBhbmd1bGFyLmRpcmVjdGl2ZSBkaXJlY3RpdmV9LgogKgogKiBUaGUgbW9zdCBwcm9taW5lbnQgZXhhbXBsZSBvZiBhIG1hcmt1cCBpbiBhbmd1bGFyIGlzIHRoZSBidWlsdC1pbiBkb3VibGUgY3VybHkgbWFya3VwCiAqIGB7e2V4cHJlc3Npb259fWAsIHdoaWNoIGlzIHNob3J0aGFuZCBmb3IgYDxzcGFuIG5nOmJpbmQ9ImV4cHJlc3Npb24iPjwvc3Bhbj5gLgogKgogKiBDcmVhdGUgY3VzdG9tIG1hcmt1cCBsaWtlIHRoaXM6CiAqCiAqIDxwcmU+CiAqICAgYW5ndWxhci5tYXJrdXAoJ25ld01hcmt1cCcsIGZ1bmN0aW9uKHRleHQsIHRleHROb2RlLCBwYXJlbnRFbGVtZW50KXsKICogICAgIC8vdHJhbmZvcm1hdGlvbiBjb2RlCiAqICAgfSk7CiAqIDwvcHJlPgogKgogKiBGb3IgbW9yZSBpbmZvcm1hdGlvbiBhYm91dCBhbmd1bGFyIG1hcmt1cCwgc2VlIHtAbGluayBndWlkZS9kZXZfZ3VpZGUuY29tcGlsZXIubWFya3VwCiAqIFVuZGVyc3RhbmRpbmcgQW5ndWxhciBNYXJrdXB9IGluIHRoZSBhbmd1bGFyIERldmVsb3BlciBHdWlkZS4KICovCgovKioKICogQHdvcmtJblByb2dyZXNzCiAqIEBuZ2RvYyBvdmVydmlldwogKiBAbmFtZSBhbmd1bGFyLmF0dHJNYXJrdXAKICogQGRlc2NyaXB0aW9uCiAqCiAqIEF0dHJpYnV0ZSBtYXJrdXAgZXh0ZW5kcyB0aGUgYW5ndWxhciBjb21waWxlciBpbiBhIHZlcnkgc2ltaWxhciB3YXkgYXMge0BsaW5rIGFuZ3VsYXIubWFya3VwfQogKiBleGNlcHQgdGhhdCBpdCBhbGxvd3MgeW91IHRvIG1vZGlmeSB0aGUgc3RhdGUgb2YgdGhlIGF0dHJpYnV0ZSB0ZXh0IHJhdGhlciB0aGFuIHRoZSBjb250ZW50IG9mIGEKICogbm9kZS4KICoKICogQ3JlYXRlIGN1c3RvbSBhdHRyaWJ1dGUgbWFya3VwIGxpa2UgdGhpczoKICoKICogPHByZT4KICogICBhbmd1bGFyLmF0dHJNYXJrdXAoJ25ld0F0dHJNYXJrdXAnLCBmdW5jdGlvbihhdHRyVmFsdWUsIGF0dHJOYW1lLCBlbGVtZW50KXsKICogICAgIC8vdHJhbmZvcm1hdGlvbiBjb2RlCiAqICAgfSk7CiAqIDwvcHJlPgogKgogKiBGb3IgbW9yZSBpbmZvcm1hdGlvbiBhYm91dCBhbmd1bGFyIGF0dHJpYnV0ZSBtYXJrdXAsIHNlZSB7QGxpbmsgZ3VpZGUvZGV2X2d1aWRlLmNvbXBpbGVyLm1hcmt1cAogKiBVbmRlcnN0YW5kaW5nIEFuZ3VsYXIgTWFya3VwfSBpbiB0aGUgYW5ndWxhciBEZXZlbG9wZXIgR3VpZGUuCiAqLwoKZnVuY3Rpb24gcGFyc2VCaW5kaW5ncyhzdHJpbmcpIHsKICB2YXIgcmVzdWx0cyA9IFtdOwogIHZhciBsYXN0SW5kZXggPSAwOwogIHZhciBpbmRleDsKICB3aGlsZSgoaW5kZXggPSBzdHJpbmcuaW5kZXhPZigne3snLCBsYXN0SW5kZXgpKSA+IC0xKSB7CiAgICBpZiAobGFzdEluZGV4IDwgaW5kZXgpCiAgICAgIHJlc3VsdHMucHVzaChzdHJpbmcuc3Vic3RyKGxhc3RJbmRleCwgaW5kZXggLSBsYXN0SW5kZXgpKTsKICAgIGxhc3RJbmRleCA9IGluZGV4OwoKICAgIGluZGV4ID0gc3RyaW5nLmluZGV4T2YoJ319JywgaW5kZXgpOwogICAgaW5kZXggPSBpbmRleCA8IDAgPyBzdHJpbmcubGVuZ3RoIDogaW5kZXggKyAyOwoKICAgIHJlc3VsdHMucHVzaChzdHJpbmcuc3Vic3RyKGxhc3RJbmRleCwgaW5kZXggLSBsYXN0SW5kZXgpKTsKICAgIGxhc3RJbmRleCA9IGluZGV4OwogIH0KICBpZiAobGFzdEluZGV4ICE9IHN0cmluZy5sZW5ndGgpCiAgICByZXN1bHRzLnB1c2goc3RyaW5nLnN1YnN0cihsYXN0SW5kZXgsIHN0cmluZy5sZW5ndGggLSBsYXN0SW5kZXgpKTsKICByZXR1cm4gcmVzdWx0cy5sZW5ndGggPT09IDAgPyBbIHN0cmluZyBdIDogcmVzdWx0czsKfQoKZnVuY3Rpb24gYmluZGluZyhzdHJpbmcpIHsKICB2YXIgYmluZGluZyA9IHN0cmluZy5yZXBsYWNlKC9cbi9nbSwgJyAnKS5tYXRjaCgvXlx7XHsoLiopXH1cfSQvKTsKICByZXR1cm4gYmluZGluZyA/IGJpbmRpbmdbMV0gOiBudWxsOwp9CgpmdW5jdGlvbiBoYXNCaW5kaW5ncyhiaW5kaW5ncykgewogIHJldHVybiBiaW5kaW5ncy5sZW5ndGggPiAxIHx8IGJpbmRpbmcoYmluZGluZ3NbMF0pICE9PSBudWxsOwp9Cgphbmd1bGFyVGV4dE1hcmt1cCgne3t9fScsIGZ1bmN0aW9uKHRleHQsIHRleHROb2RlLCBwYXJlbnRFbGVtZW50KSB7CiAgdmFyIGJpbmRpbmdzID0gcGFyc2VCaW5kaW5ncyh0ZXh0KSwKICAgICAgc2VsZiA9IHRoaXM7CiAgaWYgKGhhc0JpbmRpbmdzKGJpbmRpbmdzKSkgewogICAgaWYgKGlzTGVhZk5vZGUocGFyZW50RWxlbWVudFswXSkpIHsKICAgICAgcGFyZW50RWxlbWVudC5hdHRyKCduZzpiaW5kLXRlbXBsYXRlJywgdGV4dCk7CiAgICB9IGVsc2UgewogICAgICB2YXIgY3Vyc29yID0gdGV4dE5vZGUsIG5ld0VsZW1lbnQ7CiAgICAgIGZvckVhY2gocGFyc2VCaW5kaW5ncyh0ZXh0KSwgZnVuY3Rpb24odGV4dCl7CiAgICAgICAgdmFyIGV4cCA9IGJpbmRpbmcodGV4dCk7CiAgICAgICAgaWYgKGV4cCkgewogICAgICAgICAgbmV3RWxlbWVudCA9IGpxTGl0ZSgnPHNwYW4+Jyk7CiAgICAgICAgICBuZXdFbGVtZW50LmF0dHIoJ25nOmJpbmQnLCBleHApOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBuZXdFbGVtZW50ID0ganFMaXRlKGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKHRleHQpKTsKICAgICAgICB9CiAgICAgICAgaWYgKG1zaWUgJiYgdGV4dC5jaGFyQXQoMCkgPT0gJyAnKSB7CiAgICAgICAgICBuZXdFbGVtZW50ID0ganFMaXRlKCc8c3Bhbj4mbmJzcDs8L3NwYW4+Jyk7CiAgICAgICAgICB2YXIgbmJzcCA9IG5ld0VsZW1lbnQuaHRtbCgpOwogICAgICAgICAgbmV3RWxlbWVudC50ZXh0KHRleHQuc3Vic3RyKDEpKTsKICAgICAgICAgIG5ld0VsZW1lbnQuaHRtbChuYnNwICsgbmV3RWxlbWVudC5odG1sKCkpOwogICAgICAgIH0KICAgICAgICBjdXJzb3IuYWZ0ZXIobmV3RWxlbWVudCk7CiAgICAgICAgY3Vyc29yID0gbmV3RWxlbWVudDsKICAgICAgfSk7CiAgICAgIHRleHROb2RlLnJlbW92ZSgpOwogICAgfQogIH0KfSk7CgovKioKICogVGhpcyB0cmllcyB0byBub3JtYWxpemUgdGhlIGJlaGF2aW9yIG9mIHZhbHVlIGF0dHJpYnV0ZSBhY3Jvc3MgYnJvd3NlcnMuIElmIHZhbHVlIGF0dHJpYnV0ZSBpcwogKiBub3Qgc3BlY2lmaWVkLCB0aGVuIHNwZWNpZnkgaXQgdG8gYmUgdGhhdCBvZiB0aGUgdGV4dC4KICovCmFuZ3VsYXJUZXh0TWFya3VwKCdvcHRpb24nLCBmdW5jdGlvbih0ZXh0LCB0ZXh0Tm9kZSwgcGFyZW50RWxlbWVudCl7CiAgaWYgKGxvd2VyY2FzZShub2RlTmFtZV8ocGFyZW50RWxlbWVudCkpID09ICdvcHRpb24nKSB7CiAgICBpZiAobXNpZSA8PSA3KSB7CiAgICAgIC8vIEluIElFNyBUaGUgaXNzdWUgaXMgdGhhdCB0aGVyZSBpcyBubyB3YXkgdG8gc2VlIGlmIHRoZSB2YWx1ZSB3YXMgc3BlY2lmaWVkIGhlbmNlCiAgICAgIC8vIHdlIGhhdmUgdG8gcmVzb3J0IHRvIHBhcnNpbmcgSFRNTDsKICAgICAgaHRtbFBhcnNlcihwYXJlbnRFbGVtZW50WzBdLm91dGVySFRNTCwgewogICAgICAgIHN0YXJ0OiBmdW5jdGlvbih0YWcsIGF0dHJzKSB7CiAgICAgICAgICBpZiAoaXNVbmRlZmluZWQoYXR0cnMudmFsdWUpKSB7CiAgICAgICAgICAgIHBhcmVudEVsZW1lbnQuYXR0cigndmFsdWUnLCB0ZXh0KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgfSBlbHNlIGlmIChwYXJlbnRFbGVtZW50WzBdLmdldEF0dHJpYnV0ZSgndmFsdWUnKSA9PSBudWxsKSB7CiAgICAgIC8vIGpRdWVyeSBkb2VzIG5vcm1hbGl6YXRpb24gb24gJ3ZhbHVlJyBzbyB3ZSBoYXZlIHRvIGJ5cGFzcyBpdC4KICAgICAgcGFyZW50RWxlbWVudC5hdHRyKCd2YWx1ZScsIHRleHQpOwogICAgfQogIH0KfSk7CgovKioKICogQHdvcmtJblByb2dyZXNzCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgYW5ndWxhci5kaXJlY3RpdmUubmc6aHJlZgogKgogKiBAZGVzY3JpcHRpb24KICogVXNpbmcgPGFuZ3VsYXIvPiBtYXJrdXAgbGlrZSB7e2hhc2h9fSBpbiBhbiBocmVmIGF0dHJpYnV0ZSBtYWtlcwogKiB0aGUgcGFnZSBvcGVuIHRvIGEgd3JvbmcgVVJMLCBpZiB0aGUgdXNlciBjbGlja3MgdGhhdCBsaW5rIGJlZm9yZQogKiBhbmd1bGFyIGhhcyBhIGNoYW5jZSB0byByZXBsYWNlIHRoZSB7e2hhc2h9fSB3aXRoIGFjdHVhbCBVUkwsIHRoZQogKiBsaW5rIHdpbGwgYmUgYnJva2VuIGFuZCB3aWxsIG1vc3QgbGlrZWx5IHJldHVybiBhIDQwNCBlcnJvci4KICogVGhlIGBuZzpocmVmYCBzb2x2ZXMgdGhpcyBwcm9ibGVtIGJ5IHBsYWNpbmcgdGhlIGBocmVmYCBpbiB0aGUKICogYG5nOmAgbmFtZXNwYWNlLgogKgogKiBUaGUgYnVnZ3kgd2F5IHRvIHdyaXRlIGl0OgogKiA8cHJlPgogKiA8YSBocmVmPSJodHRwOi8vd3d3LmdyYXZhdGFyLmNvbS9hdmF0YXIve3toYXNofX0iLz4KICogPC9wcmU+CiAqCiAqIFRoZSBjb3JyZWN0IHdheSB0byB3cml0ZSBpdDoKICogPHByZT4KICogPGEgbmc6aHJlZj0iaHR0cDovL3d3dy5ncmF2YXRhci5jb20vYXZhdGFyL3t7aGFzaH19Ii8+CiAqIDwvcHJlPgogKgogKiBAZWxlbWVudCBBTlkKICogQHBhcmFtIHt0ZW1wbGF0ZX0gdGVtcGxhdGUgYW55IHN0cmluZyB3aGljaCBjYW4gY29udGFpbiBge3t9fWAgbWFya3VwLgogKgogKiBAZXhhbXBsZQogKiBUaGlzIGV4YW1wbGUgdXNlcyBgbGlua2AgdmFyaWFibGUgaW5zaWRlIGBocmVmYCBhdHRyaWJ1dGU6CiAgICA8ZG9jOmV4YW1wbGU+CiAgICAgIDxkb2M6c291cmNlPgogICAgICAgIDxpbnB1dCBuYW1lPSJ2YWx1ZSIgLz48YnIgLz4KICAgICAgICA8YSBpZD0ibGluay0xIiBocmVmIG5nOmNsaWNrPSJ2YWx1ZSA9IDEiPmxpbmsgMTwvYT4gKGxpbmssIGRvbid0IHJlbG9hZCk8YnIgLz4KICAgICAgICA8YSBpZD0ibGluay0yIiBocmVmPSIiIG5nOmNsaWNrPSJ2YWx1ZSA9IDIiPmxpbmsgMjwvYT4gKGxpbmssIGRvbid0IHJlbG9hZCk8YnIgLz4KICAgICAgICA8YSBpZD0ibGluay0zIiBuZzpocmVmPSIje3snMTIzJ319IiBuZzpjbGljaz0idmFsdWUgPSAzIj5saW5rIDM8L2E+IChsaW5rLCByZWxvYWQhKTxiciAvPgogICAgICAgIDxhIGlkPSJsaW5rLTQiIGhyZWY9IiIgbmFtZT0ieHgiIG5nOmNsaWNrPSJ2YWx1ZSA9IDQiPmFuY2hvcjwvYT4gKGxpbmssIGRvbid0IHJlbG9hZCk8YnIgLz4KICAgICAgICA8YSBpZD0ibGluay01IiBuYW1lPSJ4eHgiIG5nOmNsaWNrPSJ2YWx1ZSA9IDUiPmFuY2hvcjwvYT4gKG5vIGxpbmspPGJyIC8+CiAgICAgICAgPGEgaWQ9ImxpbmstNiIgbmc6aHJlZj0iIy97e3ZhbHVlfX0iPmxpbms8L2E+IChsaW5rLCBjaGFuZ2UgaGFzaCkKICAgICAgPC9kb2M6c291cmNlPgogICAgICA8ZG9jOnNjZW5hcmlvPgogICAgICAgIGl0KCdzaG91bGQgZXhlY3V0ZSBuZzpjbGljayBidXQgbm90IHJlbG9hZCB3aGVuIGhyZWYgd2l0aG91dCB2YWx1ZScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgZWxlbWVudCgnI2xpbmstMScpLmNsaWNrKCk7CiAgICAgICAgICBleHBlY3QoaW5wdXQoJ3ZhbHVlJykudmFsKCkpLnRvRXF1YWwoJzEnKTsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcjbGluay0xJykuYXR0cignaHJlZicpKS50b0JlKCIiKTsKICAgICAgICB9KTsKCiAgICAgICAgaXQoJ3Nob3VsZCBleGVjdXRlIG5nOmNsaWNrIGJ1dCBub3QgcmVsb2FkIHdoZW4gaHJlZiBlbXB0eSBzdHJpbmcnLCBmdW5jdGlvbigpIHsKICAgICAgICAgIGVsZW1lbnQoJyNsaW5rLTInKS5jbGljaygpOwogICAgICAgICAgZXhwZWN0KGlucHV0KCd2YWx1ZScpLnZhbCgpKS50b0VxdWFsKCcyJyk7CiAgICAgICAgICBleHBlY3QoZWxlbWVudCgnI2xpbmstMicpLmF0dHIoJ2hyZWYnKSkudG9CZSgiIik7CiAgICAgICAgfSk7CgogICAgICAgIGl0KCdzaG91bGQgZXhlY3V0ZSBuZzpjbGljayBhbmQgY2hhbmdlIHVybCB3aGVuIG5nOmhyZWYgc3BlY2lmaWVkJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBlbGVtZW50KCcjbGluay0zJykuY2xpY2soKTsKICAgICAgICAgIGV4cGVjdChpbnB1dCgndmFsdWUnKS52YWwoKSkudG9FcXVhbCgnMycpOwogICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJyNsaW5rLTMnKS5hdHRyKCdocmVmJykpLnRvQmUoIiMxMjMiKTsKICAgICAgICAgIGV4cGVjdChicm93c2VyKCkubG9jYXRpb24oKS5oYXNoKCkpLnRvRXF1YWwoJzEyMycpOwogICAgICAgIH0pOwoKICAgICAgICBpdCgnc2hvdWxkIGV4ZWN1dGUgbmc6Y2xpY2sgYnV0IG5vdCByZWxvYWQgd2hlbiBocmVmIGVtcHR5IHN0cmluZyBhbmQgbmFtZSBzcGVjaWZpZWQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgIGVsZW1lbnQoJyNsaW5rLTQnKS5jbGljaygpOwogICAgICAgICAgZXhwZWN0KGlucHV0KCd2YWx1ZScpLnZhbCgpKS50b0VxdWFsKCc0Jyk7CiAgICAgICAgICBleHBlY3QoZWxlbWVudCgnI2xpbmstNCcpLmF0dHIoJ2hyZWYnKSkudG9CZSgiIik7CiAgICAgICAgfSk7CgogICAgICAgIGl0KCdzaG91bGQgZXhlY3V0ZSBuZzpjbGljayBidXQgbm90IHJlbG9hZCB3aGVuIG5vIGhyZWYgYnV0IG5hbWUgc3BlY2lmaWVkJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBlbGVtZW50KCcjbGluay01JykuY2xpY2soKTsKICAgICAgICAgIGV4cGVjdChpbnB1dCgndmFsdWUnKS52YWwoKSkudG9FcXVhbCgnNScpOwogICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJyNsaW5rLTUnKS5hdHRyKCdocmVmJykpLnRvQmUodW5kZWZpbmVkKTsKICAgICAgICB9KTsKCiAgICAgICAgaXQoJ3Nob3VsZCBvbmx5IGNoYW5nZSB1cmwgd2hlbiBvbmx5IG5nOmhyZWYnLCBmdW5jdGlvbigpIHsKICAgICAgICAgIGlucHV0KCd2YWx1ZScpLmVudGVyKCc2Jyk7CiAgICAgICAgICBlbGVtZW50KCcjbGluay02JykuY2xpY2soKTsKICAgICAgICAgIGV4cGVjdChicm93c2VyKCkubG9jYXRpb24oKS5oYXNoKCkpLnRvRXF1YWwoJy82Jyk7CiAgICAgICAgICBleHBlY3QoZWxlbWVudCgnI2xpbmstNicpLmF0dHIoJ2hyZWYnKSkudG9CZSgiIy82Iik7CiAgICAgICAgfSk7CiAgICAgIDwvZG9jOnNjZW5hcmlvPgogICAgPC9kb2M6ZXhhbXBsZT4KICovCgovKioKICogQHdvcmtJblByb2dyZXNzCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgYW5ndWxhci5kaXJlY3RpdmUubmc6c3JjCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBVc2luZyA8YW5ndWxhci8+IG1hcmt1cCBsaWtlIGB7e2hhc2h9fWAgaW4gYSBgc3JjYCBhdHRyaWJ1dGUgZG9lc24ndAogKiB3b3JrIHJpZ2h0OiBUaGUgYnJvd3NlciB3aWxsIGZldGNoIGZyb20gdGhlIFVSTCB3aXRoIHRoZSBsaXRlcmFsCiAqIHRleHQgYHt7aGFzaH19YCB1bnRpbCA8YW5ndWxhci8+IHJlcGxhY2VzIHRoZSBleHByZXNzaW9uIGluc2lkZQogKiBge3toYXNofX1gLiBUaGUgYG5nOnNyY2AgYXR0cmlidXRlIHNvbHZlcyB0aGlzIHByb2JsZW0gYnkgcGxhY2luZwogKiAgdGhlIGBzcmNgIGF0dHJpYnV0ZSBpbiB0aGUgYG5nOmAgbmFtZXNwYWNlLgogKgogKiBUaGUgYnVnZ3kgd2F5IHRvIHdyaXRlIGl0OgogKiA8cHJlPgogKiA8aW1nIHNyYz0iaHR0cDovL3d3dy5ncmF2YXRhci5jb20vYXZhdGFyL3t7aGFzaH19Ii8+CiAqIDwvcHJlPgogKgogKiBUaGUgY29ycmVjdCB3YXkgdG8gd3JpdGUgaXQ6CiAqIDxwcmU+CiAqIDxpbWcgbmc6c3JjPSJodHRwOi8vd3d3LmdyYXZhdGFyLmNvbS9hdmF0YXIve3toYXNofX0iLz4KICogPC9wcmU+CiAqCiAqIEBlbGVtZW50IEFOWQogKiBAcGFyYW0ge3RlbXBsYXRlfSB0ZW1wbGF0ZSBhbnkgc3RyaW5nIHdoaWNoIGNhbiBjb250YWluIGB7e319YCBtYXJrdXAuCiAqLwoKLyoqCiAqIEB3b3JrSW5Qcm9ncmVzcwogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIGFuZ3VsYXIuZGlyZWN0aXZlLm5nOmRpc2FibGVkCiAqCiAqIEBkZXNjcmlwdGlvbgogKgogKiBUaGUgZm9sbG93aW5nIG1hcmt1cCB3aWxsIG1ha2UgdGhlIGJ1dHRvbiBlbmFibGVkIG9uIENocm9tZS9GaXJlZm94IGJ1dCBub3Qgb24gSUU4IGFuZCBvbGRlciBJRXM6CiAqIDxwcmU+CiAqIDxkaXYgbmc6aW5pdD0ic2NvcGUgPSB7IGlzRGlzYWJsZWQ6IGZhbHNlIH0iPgogKiAgPGJ1dHRvbiBkaXNhYmxlZD0ie3tzY29wZS5pc0Rpc2FibGVkfX0iPkRpc2FibGVkPC9idXR0b24+CiAqIDwvZGl2PgogKiA8L3ByZT4KICoKICogVGhlIEhUTUwgc3BlY3MgZG8gbm90IHJlcXVpcmUgYnJvd3NlcnMgdG8gcHJlc2VydmUgdGhlIHNwZWNpYWwgYXR0cmlidXRlcyBzdWNoIGFzIGRpc2FibGVkLgogKiAoVGhlIHByZXNlbmNlIG9mIHRoZW0gbWVhbnMgdHJ1ZSBhbmQgYWJzZW5jZSBtZWFucyBmYWxzZSkKICogVGhpcyBwcmV2ZW50cyB0aGUgYW5ndWxhciBjb21waWxlciBmcm9tIGNvcnJlY3RseSByZXRyaWV2aW5nIHRoZSBiaW5kaW5nIGV4cHJlc3Npb24uCiAqIFRvIHNvbHZlIHRoaXMgcHJvYmxlbSwgd2UgaW50cm9kdWNlIG5nOmRpc2FibGVkLgogKgogKiBAZXhhbXBsZQogICAgPGRvYzpleGFtcGxlPgogICAgICA8ZG9jOnNvdXJjZT4KICAgICAgICBDbGljayBtZSB0byB0b2dnbGU6IDxpbnB1dCB0eXBlPSJjaGVja2JveCIgbmFtZT0iY2hlY2tlZCI+PGJyLz4KICAgICAgICA8YnV0dG9uIG5hbWU9ImJ1dHRvbiIgbmc6ZGlzYWJsZWQ9Int7Y2hlY2tlZH19Ij5CdXR0b248L2J1dHRvbj4KICAgICAgPC9kb2M6c291cmNlPgogICAgICA8ZG9jOnNjZW5hcmlvPgogICAgICAgIGl0KCdzaG91bGQgdG9nZ2xlIGJ1dHRvbicsIGZ1bmN0aW9uKCkgewogICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIDpidXR0b24nKS5hdHRyKCdkaXNhYmxlZCcpKS50b0JlRmFsc3koKTsKICAgICAgICAgIGlucHV0KCdjaGVja2VkJykuY2hlY2soKTsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSA6YnV0dG9uJykuYXR0cignZGlzYWJsZWQnKSkudG9CZVRydXRoeSgpOwogICAgICAgIH0pOwogICAgICA8L2RvYzpzY2VuYXJpbz4KICAgIDwvZG9jOmV4YW1wbGU+CiAqCiAqIEBlbGVtZW50IEFOWQogKiBAcGFyYW0ge3RlbXBsYXRlfSB0ZW1wbGF0ZSBhbnkgc3RyaW5nIHdoaWNoIGNhbiBjb250YWluICd7e319JyBtYXJrdXAuCiAqLwoKCi8qKgogKiBAd29ya0luUHJvZ3Jlc3MKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBhbmd1bGFyLmRpcmVjdGl2ZS5uZzpjaGVja2VkCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBUaGUgSFRNTCBzcGVjcyBkbyBub3QgcmVxdWlyZSBicm93c2VycyB0byBwcmVzZXJ2ZSB0aGUgc3BlY2lhbCBhdHRyaWJ1dGVzIHN1Y2ggYXMgY2hlY2tlZC4KICogKFRoZSBwcmVzZW5jZSBvZiB0aGVtIG1lYW5zIHRydWUgYW5kIGFic2VuY2UgbWVhbnMgZmFsc2UpCiAqIFRoaXMgcHJldmVudHMgdGhlIGFuZ3VsYXIgY29tcGlsZXIgZnJvbSBjb3JyZWN0bHkgcmV0cmlldmluZyB0aGUgYmluZGluZyBleHByZXNzaW9uLgogKiBUbyBzb2x2ZSB0aGlzIHByb2JsZW0sIHdlIGludHJvZHVjZSBuZzpjaGVja2VkLgogKiBAZXhhbXBsZQogICAgPGRvYzpleGFtcGxlPgogICAgICA8ZG9jOnNvdXJjZT4KICAgICAgICBDaGVjayBtZSB0byBjaGVjayBib3RoOiA8aW5wdXQgdHlwZT0iY2hlY2tib3giIG5hbWU9Im1hc3RlciI+PGJyLz4KICAgICAgICA8aW5wdXQgaWQ9ImNoZWNrU2xhdmUiIHR5cGU9ImNoZWNrYm94IiBuZzpjaGVja2VkPSJ7e21hc3Rlcn19Ij4KICAgICAgPC9kb2M6c291cmNlPgogICAgICA8ZG9jOnNjZW5hcmlvPgogICAgICAgIGl0KCdzaG91bGQgY2hlY2sgYm90aCBjaGVja0JveGVzJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgI2NoZWNrU2xhdmUnKS5hdHRyKCdjaGVja2VkJykpLnRvQmVGYWxzeSgpOwogICAgICAgICAgaW5wdXQoJ21hc3RlcicpLmNoZWNrKCk7CiAgICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgI2NoZWNrU2xhdmUnKS5hdHRyKCdjaGVja2VkJykpLnRvQmVUcnV0aHkoKTsKICAgICAgICB9KTsKICAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICA8L2RvYzpleGFtcGxlPgogKgogKiBAZWxlbWVudCBBTlkKICogQHBhcmFtIHt0ZW1wbGF0ZX0gdGVtcGxhdGUgYW55IHN0cmluZyB3aGljaCBjYW4gY29udGFpbiAne3t9fScgbWFya3VwLgogKi8KCgovKioKICogQHdvcmtJblByb2dyZXNzCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgYW5ndWxhci5kaXJlY3RpdmUubmc6bXVsdGlwbGUKICoKICogQGRlc2NyaXB0aW9uCiAqIFRoZSBIVE1MIHNwZWNzIGRvIG5vdCByZXF1aXJlIGJyb3dzZXJzIHRvIHByZXNlcnZlIHRoZSBzcGVjaWFsIGF0dHJpYnV0ZXMgc3VjaCBhcyBtdWx0aXBsZS4KICogKFRoZSBwcmVzZW5jZSBvZiB0aGVtIG1lYW5zIHRydWUgYW5kIGFic2VuY2UgbWVhbnMgZmFsc2UpCiAqIFRoaXMgcHJldmVudHMgdGhlIGFuZ3VsYXIgY29tcGlsZXIgZnJvbSBjb3JyZWN0bHkgcmV0cmlldmluZyB0aGUgYmluZGluZyBleHByZXNzaW9uLgogKiBUbyBzb2x2ZSB0aGlzIHByb2JsZW0sIHdlIGludHJvZHVjZSBuZzptdWx0aXBsZS4KICoKICogQGV4YW1wbGUKICAgICA8ZG9jOmV4YW1wbGU+CiAgICAgICA8ZG9jOnNvdXJjZT4KICAgICAgICAgQ2hlY2sgbWUgY2hlY2sgbXVsdGlwbGU6IDxpbnB1dCB0eXBlPSJjaGVja2JveCIgbmFtZT0iY2hlY2tlZCI+PGJyLz4KICAgICAgICAgPHNlbGVjdCBpZD0ic2VsZWN0IiBuZzptdWx0aXBsZT0ie3tjaGVja2VkfX0iPgogICAgICAgICAgIDxvcHRpb24+TWlza288L29wdGlvbj4KICAgICAgICAgICA8b3B0aW9uPklnb3I8L29wdGlvbj4KICAgICAgICAgICA8b3B0aW9uPlZvanRhPC9vcHRpb24+CiAgICAgICAgICAgPG9wdGlvbj5EaTwvb3B0aW9uPgogICAgICAgICA8L3NlbGVjdD4KICAgICAgIDwvZG9jOnNvdXJjZT4KICAgICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgICAgIGl0KCdzaG91bGQgdG9nZ2xlIG11bHRpcGxlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlICNzZWxlY3QnKS5hdHRyKCdtdWx0aXBsZScpKS50b0JlRmFsc3koKTsKICAgICAgICAgICBpbnB1dCgnY2hlY2tlZCcpLmNoZWNrKCk7CiAgICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlICNzZWxlY3QnKS5hdHRyKCdtdWx0aXBsZScpKS50b0JlVHJ1dGh5KCk7CiAgICAgICAgIH0pOwogICAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgPC9kb2M6ZXhhbXBsZT4KICoKICogQGVsZW1lbnQgQU5ZCiAqIEBwYXJhbSB7dGVtcGxhdGV9IHRlbXBsYXRlIGFueSBzdHJpbmcgd2hpY2ggY2FuIGNvbnRhaW4gJ3t7fX0nIG1hcmt1cC4KICovCgoKLyoqCiAqIEB3b3JrSW5Qcm9ncmVzcwogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIGFuZ3VsYXIuZGlyZWN0aXZlLm5nOnJlYWRvbmx5CiAqCiAqIEBkZXNjcmlwdGlvbgogKiBUaGUgSFRNTCBzcGVjcyBkbyBub3QgcmVxdWlyZSBicm93c2VycyB0byBwcmVzZXJ2ZSB0aGUgc3BlY2lhbCBhdHRyaWJ1dGVzIHN1Y2ggYXMgcmVhZG9ubHkuCiAqIChUaGUgcHJlc2VuY2Ugb2YgdGhlbSBtZWFucyB0cnVlIGFuZCBhYnNlbmNlIG1lYW5zIGZhbHNlKQogKiBUaGlzIHByZXZlbnRzIHRoZSBhbmd1bGFyIGNvbXBpbGVyIGZyb20gY29ycmVjdGx5IHJldHJpZXZpbmcgdGhlIGJpbmRpbmcgZXhwcmVzc2lvbi4KICogVG8gc29sdmUgdGhpcyBwcm9ibGVtLCB3ZSBpbnRyb2R1Y2Ugbmc6cmVhZG9ubHkuCiAqIEBleGFtcGxlCiAgICA8ZG9jOmV4YW1wbGU+CiAgICAgIDxkb2M6c291cmNlPgogICAgICAgIENoZWNrIG1lIHRvIG1ha2UgdGV4dCByZWFkb25seTogPGlucHV0IHR5cGU9ImNoZWNrYm94IiBuYW1lPSJjaGVja2VkIj48YnIvPgogICAgICAgIDxpbnB1dCB0eXBlPSJ0ZXh0IiBuZzpyZWFkb25seT0ie3tjaGVja2VkfX0iIHZhbHVlPSJJJ20gQW5ndWxhciIvPgogICAgICA8L2RvYzpzb3VyY2U+CiAgICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgICAgaXQoJ3Nob3VsZCB0b2dnbGUgcmVhZG9ubHkgYXR0cicsIGZ1bmN0aW9uKCkgewogICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIDp0ZXh0JykuYXR0cigncmVhZG9ubHknKSkudG9CZUZhbHN5KCk7CiAgICAgICAgICBpbnB1dCgnY2hlY2tlZCcpLmNoZWNrKCk7CiAgICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgOnRleHQnKS5hdHRyKCdyZWFkb25seScpKS50b0JlVHJ1dGh5KCk7CiAgICAgICAgfSk7CiAgICAgIDwvZG9jOnNjZW5hcmlvPgogICAgPC9kb2M6ZXhhbXBsZT4KICoKICogQGVsZW1lbnQgQU5ZCiAqIEBwYXJhbSB7dGVtcGxhdGV9IHRlbXBsYXRlIGFueSBzdHJpbmcgd2hpY2ggY2FuIGNvbnRhaW4gJ3t7fX0nIG1hcmt1cC4KICovCgoKLyoqCiogQHdvcmtJblByb2dyZXNzCiogQG5nZG9jIGRpcmVjdGl2ZQoqIEBuYW1lIGFuZ3VsYXIuZGlyZWN0aXZlLm5nOnNlbGVjdGVkCioKKiBAZGVzY3JpcHRpb24KKiBUaGUgSFRNTCBzcGVjcyBkbyBub3QgcmVxdWlyZSBicm93c2VycyB0byBwcmVzZXJ2ZSB0aGUgc3BlY2lhbCBhdHRyaWJ1dGVzIHN1Y2ggYXMgc2VsZWN0ZWQuCiogKFRoZSBwcmVzZW5jZSBvZiB0aGVtIG1lYW5zIHRydWUgYW5kIGFic2VuY2UgbWVhbnMgZmFsc2UpCiogVGhpcyBwcmV2ZW50cyB0aGUgYW5ndWxhciBjb21waWxlciBmcm9tIGNvcnJlY3RseSByZXRyaWV2aW5nIHRoZSBiaW5kaW5nIGV4cHJlc3Npb24uCiogVG8gc29sdmUgdGhpcyBwcm9ibGVtLCB3ZSBpbnRyb2R1Y2Ugbmc6c2VsZWN0ZWQuCiogQGV4YW1wbGUKICAgPGRvYzpleGFtcGxlPgogICAgIDxkb2M6c291cmNlPgogICAgICAgQ2hlY2sgbWUgdG8gc2VsZWN0OiA8aW5wdXQgdHlwZT0iY2hlY2tib3giIG5hbWU9ImNoZWNrZWQiPjxici8+CiAgICAgICA8c2VsZWN0PgogICAgICAgICA8b3B0aW9uPkhlbGxvITwvb3B0aW9uPgogICAgICAgICA8b3B0aW9uIGlkPSJncmVldCIgbmc6c2VsZWN0ZWQ9Int7Y2hlY2tlZH19Ij5HcmVldGluZ3MhPC9vcHRpb24+CiAgICAgICA8L3NlbGVjdD4KICAgICA8L2RvYzpzb3VyY2U+CiAgICAgPGRvYzpzY2VuYXJpbz4KICAgICAgIGl0KCdzaG91bGQgc2VsZWN0IEdyZWV0aW5ncyEnLCBmdW5jdGlvbigpIHsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlICNncmVldCcpLmF0dHIoJ3NlbGVjdGVkJykpLnRvQmVGYWxzeSgpOwogICAgICAgICBpbnB1dCgnY2hlY2tlZCcpLmNoZWNrKCk7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSAjZ3JlZXQnKS5hdHRyKCdzZWxlY3RlZCcpKS50b0JlVHJ1dGh5KCk7CiAgICAgICB9KTsKICAgICA8L2RvYzpzY2VuYXJpbz4KICAgPC9kb2M6ZXhhbXBsZT4KKiBAZWxlbWVudCBBTlkKKiBAcGFyYW0ge3RlbXBsYXRlfSB0ZW1wbGF0ZSBhbnkgc3RyaW5nIHdoaWNoIGNhbiBjb250YWluICd7e319JyBtYXJrdXAuCiovCgoKdmFyIE5HX0JJTkRfQVRUUiA9ICduZzpiaW5kLWF0dHInOwp2YXIgU1BFQ0lBTF9BVFRSUyA9IHt9OwoKZm9yRWFjaCgnc3JjLGhyZWYsY2hlY2tlZCxkaXNhYmxlZCxtdWx0aXBsZSxyZWFkb25seSxzZWxlY3RlZCcuc3BsaXQoJywnKSwgZnVuY3Rpb24obmFtZSkgewogIFNQRUNJQUxfQVRUUlNbJ25nOicgKyBuYW1lXSA9IG5hbWU7Cn0pOwoKYW5ndWxhckF0dHJNYXJrdXAoJ3t7fX0nLCBmdW5jdGlvbih2YWx1ZSwgbmFtZSwgZWxlbWVudCl7CiAgLy8gZG9uJ3QgcHJvY2VzcyBleGlzdGluZyBhdHRyaWJ1dGUgbWFya3VwCiAgaWYgKGFuZ3VsYXJEaXJlY3RpdmUobmFtZSkgfHwgYW5ndWxhckRpcmVjdGl2ZSgiQCIgKyBuYW1lKSkgcmV0dXJuOwogIGlmIChtc2llICYmIG5hbWUgPT0gJ3NyYycpCiAgICB2YWx1ZSA9IGRlY29kZVVSSSh2YWx1ZSk7CiAgdmFyIGJpbmRpbmdzID0gcGFyc2VCaW5kaW5ncyh2YWx1ZSksCiAgICAgIGJpbmRBdHRyOwogIGlmIChoYXNCaW5kaW5ncyhiaW5kaW5ncykpIHsKICAgIGVsZW1lbnQucmVtb3ZlQXR0cihuYW1lKTsKICAgIGJpbmRBdHRyID0gZnJvbUpzb24oZWxlbWVudC5hdHRyKE5HX0JJTkRfQVRUUikgfHwgInt9Iik7CiAgICBiaW5kQXR0cltTUEVDSUFMX0FUVFJTW25hbWVdIHx8IG5hbWVdID0gdmFsdWU7CiAgICBlbGVtZW50LmF0dHIoTkdfQklORF9BVFRSLCB0b0pzb24oYmluZEF0dHIpKTsKICB9Cn0pOwondXNlIHN0cmljdCc7CgovKioKICogQHdvcmtJblByb2dyZXNzCiAqIEBuZ2RvYyBvdmVydmlldwogKiBAbmFtZSBhbmd1bGFyLndpZGdldAogKiBAZGVzY3JpcHRpb24KICoKICogQW4gYW5ndWxhciB3aWRnZXQgY2FuIGJlIGVpdGhlciBhIGN1c3RvbSBhdHRyaWJ1dGUgdGhhdCBtb2RpZmllcyBhbiBleGlzdGluZyBET00gZWxlbWVudCBvciBhbgogKiBlbnRpcmVseSBuZXcgRE9NIGVsZW1lbnQuCiAqCiAqIER1cmluZyBodG1sIGNvbXBpbGF0aW9uLCB3aWRnZXRzIGFyZSBwcm9jZXNzZWQgYWZ0ZXIge0BsaW5rIGFuZ3VsYXIubWFya3VwIG1hcmt1cH0sIGJ1dCBiZWZvcmUKICoge0BsaW5rIGFuZ3VsYXIuZGlyZWN0aXZlIGRpcmVjdGl2ZXN9LgogKgogKiBGb2xsb3dpbmcgaXMgdGhlIGxpc3Qgb2YgYnVpbHQtaW4gYW5ndWxhciB3aWRnZXRzOgogKgogKiAqIHtAbGluayBhbmd1bGFyLndpZGdldC5Abmc6Zm9ybWF0IG5nOmZvcm1hdH0gLSBGb3JtYXRzIGRhdGEgZm9yIGRpc3BsYXkgdG8gdXNlciBhbmQgZm9yIHN0b3JhZ2UuCiAqICoge0BsaW5rIGFuZ3VsYXIud2lkZ2V0LkBuZzpub24tYmluZGFibGUgbmc6bm9uLWJpbmRhYmxlfSAtIEJsb2NrcyBhbmd1bGFyIGZyb20gcHJvY2Vzc2luZyBhbgogKiAgIEhUTUwgZWxlbWVudC4KICogKiB7QGxpbmsgYW5ndWxhci53aWRnZXQuQG5nOnJlcGVhdCBuZzpyZXBlYXR9IC0gQ3JlYXRlcyBhbmQgbWFuYWdlcyBhIGNvbGxlY3Rpb24gb2YgY2xvbmVkIEhUTUwKICogICBlbGVtZW50cy4KICogKiB7QGxpbmsgYW5ndWxhci53aWRnZXQuQG5nOnJlcXVpcmVkIG5nOnJlcXVpcmVkfSAtIFZlcmlmaWVzIHByZXNlbmNlIG9mIHVzZXIgaW5wdXQuCiAqICoge0BsaW5rIGFuZ3VsYXIud2lkZ2V0LkBuZzp2YWxpZGF0ZSBuZzp2YWxpZGF0ZX0gLSBWYWxpZGF0ZXMgY29udGVudCBvZiB1c2VyIGlucHV0LgogKiAqIHtAbGluayBhbmd1bGFyLndpZGdldC5IVE1MIEhUTUwgaW5wdXQgZWxlbWVudHN9IC0gU3RhbmRhcmQgSFRNTCBpbnB1dCBlbGVtZW50cyBkYXRhLWJvdW5kIGJ5CiAqICAgYW5ndWxhci4KICogKiB7QGxpbmsgYW5ndWxhci53aWRnZXQubmc6dmlldyBuZzp2aWV3fSAtIFdvcmtzIHdpdGggJHJvdXRlIHRvICJpbmNsdWRlIiBwYXJ0aWFsIHRlbXBsYXRlcwogKiAqIHtAbGluayBhbmd1bGFyLndpZGdldC5uZzpzd2l0Y2ggbmc6c3dpdGNofSAtIENvbmRpdGlvbmFsbHkgY2hhbmdlcyBET00gc3RydWN0dXJlCiAqICoge0BsaW5rIGFuZ3VsYXIud2lkZ2V0Lm5nOmluY2x1ZGUgbmc6aW5jbHVkZX0gLSBJbmNsdWRlcyBhbiBleHRlcm5hbCBIVE1MIGZyYWdtZW50CiAqCiAqIEZvciBtb3JlIGluZm9ybWF0aW9uIGFib3V0IGFuZ3VsYXIgd2lkZ2V0cywgc2VlIHtAbGluayBndWlkZS9kZXZfZ3VpZGUuY29tcGlsZXIud2lkZ2V0cwogKiBVbmRlcnN0YW5kaW5nIEFuZ3VsYXIgV2lkZ2V0c30gaW4gdGhlIGFuZ3VsYXIgRGV2ZWxvcGVyIEd1aWRlLgogKi8KCi8qKgogKiBAd29ya0luUHJvZ3Jlc3MKICogQG5nZG9jIHdpZGdldAogKiBAbmFtZSBhbmd1bGFyLndpZGdldC5IVE1MCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBUaGUgbW9zdCBjb21tb24gd2lkZ2V0cyB5b3Ugd2lsbCB1c2Ugd2lsbCBiZSBpbiB0aGUgZm9ybSBvZiB0aGUKICogc3RhbmRhcmQgSFRNTCBzZXQuIFRoZXNlIHdpZGdldHMgYXJlIGJvdW5kIHVzaW5nIHRoZSBgbmFtZWAgYXR0cmlidXRlCiAqIHRvIGFuIGV4cHJlc3Npb24uIEluIGFkZGl0aW9uLCB0aGV5IGNhbiBoYXZlIGBuZzp2YWxpZGF0ZWAsIGBuZzpyZXF1aXJlZGAsCiAqIGBuZzpmb3JtYXRgLCBgbmc6Y2hhbmdlYCBhdHRyaWJ1dGUgdG8gZnVydGhlciBjb250cm9sIHRoZWlyIGJlaGF2aW9yLgogKgogKiBAdXNhZ2VDb250ZW50CiAqICAgc2VlIGV4YW1wbGUgYmVsb3cgZm9yIHVzYWdlCiAqCiAqICAgPGlucHV0IHR5cGU9InRleHR8Y2hlY2tib3h8Li4uIiAuLi4gLz4KICogICA8dGV4dGFyZWEgLi4uIC8+CiAqICAgPHNlbGVjdCAuLi4+CiAqICAgICA8b3B0aW9uPi4uLjwvb3B0aW9uPgogKiAgIDwvc2VsZWN0PgogKgogKiBAZXhhbXBsZQogICAgPGRvYzpleGFtcGxlPgogICAgICA8ZG9jOnNvdXJjZT4KICAgICAgICA8dGFibGUgc3R5bGU9ImZvbnQtc2l6ZTouOWVtOyI+CiAgICAgICAgICA8dHI+CiAgICAgICAgICAgIDx0aD5OYW1lPC90aD4KICAgICAgICAgICAgPHRoPkZvcm1hdDwvdGg+CiAgICAgICAgICAgIDx0aD5IVE1MPC90aD4KICAgICAgICAgICAgPHRoPlVJPC90aD4KICAgICAgICAgICAgPHRoIG5nOm5vbi1iaW5kYWJsZT57e2lucHV0I319PC90aD4KICAgICAgICAgIDwvdHI+CiAgICAgICAgICA8dHI+CiAgICAgICAgICAgIDx0aD50ZXh0PC90aD4KICAgICAgICAgICAgPHRkPlN0cmluZzwvdGQ+CiAgICAgICAgICAgIDx0ZD48dHQ+Jmx0O2lucHV0IHR5cGU9InRleHQiIG5hbWU9ImlucHV0MSImZ3Q7PC90dD48L3RkPgogICAgICAgICAgICA8dGQ+PGlucHV0IHR5cGU9InRleHQiIG5hbWU9ImlucHV0MSIgc2l6ZT0iNCI+PC90ZD4KICAgICAgICAgICAgPHRkPjx0dD57e2lucHV0MXxqc29ufX08L3R0PjwvdGQ+CiAgICAgICAgICA8L3RyPgogICAgICAgICAgPHRyPgogICAgICAgICAgICA8dGg+dGV4dGFyZWE8L3RoPgogICAgICAgICAgICA8dGQ+U3RyaW5nPC90ZD4KICAgICAgICAgICAgPHRkPjx0dD4mbHQ7dGV4dGFyZWEgbmFtZT0iaW5wdXQyIiZndDsmbHQ7L3RleHRhcmVhJmd0OzwvdHQ+PC90ZD4KICAgICAgICAgICAgPHRkPjx0ZXh0YXJlYSBuYW1lPSJpbnB1dDIiIGNvbHM9JzYnPjwvdGV4dGFyZWE+PC90ZD4KICAgICAgICAgICAgPHRkPjx0dD57e2lucHV0Mnxqc29ufX08L3R0PjwvdGQ+CiAgICAgICAgICA8L3RyPgogICAgICAgICAgPHRyPgogICAgICAgICAgICA8dGg+cmFkaW88L3RoPgogICAgICAgICAgICA8dGQ+U3RyaW5nPC90ZD4KICAgICAgICAgICAgPHRkPjx0dD4KICAgICAgICAgICAgICAmbHQ7aW5wdXQgdHlwZT0icmFkaW8iIG5hbWU9ImlucHV0MyIgdmFsdWU9IkEiJmd0Ozxicj4KICAgICAgICAgICAgICAmbHQ7aW5wdXQgdHlwZT0icmFkaW8iIG5hbWU9ImlucHV0MyIgdmFsdWU9IkIiJmd0OwogICAgICAgICAgICA8L3R0PjwvdGQ+CiAgICAgICAgICAgIDx0ZD4KICAgICAgICAgICAgICA8aW5wdXQgdHlwZT0icmFkaW8iIG5hbWU9ImlucHV0MyIgdmFsdWU9IkEiPgogICAgICAgICAgICAgIDxpbnB1dCB0eXBlPSJyYWRpbyIgbmFtZT0iaW5wdXQzIiB2YWx1ZT0iQiI+CiAgICAgICAgICAgIDwvdGQ+CiAgICAgICAgICAgIDx0ZD48dHQ+e3tpbnB1dDN8anNvbn19PC90dD48L3RkPgogICAgICAgICAgPC90cj4KICAgICAgICAgIDx0cj4KICAgICAgICAgICAgPHRoPmNoZWNrYm94PC90aD4KICAgICAgICAgICAgPHRkPkJvb2xlYW48L3RkPgogICAgICAgICAgICA8dGQ+PHR0PiZsdDtpbnB1dCB0eXBlPSJjaGVja2JveCIgbmFtZT0iaW5wdXQ0IiB2YWx1ZT0iY2hlY2tlZCImZ3Q7PC90dD48L3RkPgogICAgICAgICAgICA8dGQ+PGlucHV0IHR5cGU9ImNoZWNrYm94IiBuYW1lPSJpbnB1dDQiIHZhbHVlPSJjaGVja2VkIj48L3RkPgogICAgICAgICAgICA8dGQ+PHR0Pnt7aW5wdXQ0fGpzb259fTwvdHQ+PC90ZD4KICAgICAgICAgIDwvdHI+CiAgICAgICAgICA8dHI+CiAgICAgICAgICAgIDx0aD5wdWxsZG93bjwvdGg+CiAgICAgICAgICAgIDx0ZD5TdHJpbmc8L3RkPgogICAgICAgICAgICA8dGQ+PHR0PgogICAgICAgICAgICAgICZsdDtzZWxlY3QgbmFtZT0iaW5wdXQ1IiZndDs8YnI+CiAgICAgICAgICAgICAgJm5ic3A7Jm5ic3A7Jmx0O29wdGlvbiB2YWx1ZT0iYyImZ3Q7QyZsdDsvb3B0aW9uJmd0Ozxicj4KICAgICAgICAgICAgICAmbmJzcDsmbmJzcDsmbHQ7b3B0aW9uIHZhbHVlPSJkIiZndDtEJmx0Oy9vcHRpb24mZ3Q7PGJyPgogICAgICAgICAgICAgICZsdDsvc2VsZWN0Jmd0Ozxicj4KICAgICAgICAgICAgPC90dD48L3RkPgogICAgICAgICAgICA8dGQ+CiAgICAgICAgICAgICAgPHNlbGVjdCBuYW1lPSJpbnB1dDUiPgogICAgICAgICAgICAgICAgPG9wdGlvbiB2YWx1ZT0iYyI+Qzwvb3B0aW9uPgogICAgICAgICAgICAgICAgPG9wdGlvbiB2YWx1ZT0iZCI+RDwvb3B0aW9uPgogICAgICAgICAgICAgIDwvc2VsZWN0PgogICAgICAgICAgICA8L3RkPgogICAgICAgICAgICA8dGQ+PHR0Pnt7aW5wdXQ1fGpzb259fTwvdHQ+PC90ZD4KICAgICAgICAgIDwvdHI+CiAgICAgICAgICA8dHI+CiAgICAgICAgICAgIDx0aD5tdWx0aXNlbGVjdDwvdGg+CiAgICAgICAgICAgIDx0ZD5BcnJheTwvdGQ+CiAgICAgICAgICAgIDx0ZD48dHQ+CiAgICAgICAgICAgICAgJmx0O3NlbGVjdCBuYW1lPSJpbnB1dDYiIG11bHRpcGxlIHNpemU9IjQiJmd0Ozxicj4KICAgICAgICAgICAgICAmbmJzcDsmbmJzcDsmbHQ7b3B0aW9uIHZhbHVlPSJlIiZndDtFJmx0Oy9vcHRpb24mZ3Q7PGJyPgogICAgICAgICAgICAgICZuYnNwOyZuYnNwOyZsdDtvcHRpb24gdmFsdWU9ImYiJmd0O0YmbHQ7L29wdGlvbiZndDs8YnI+CiAgICAgICAgICAgICAgJmx0Oy9zZWxlY3QmZ3Q7PGJyPgogICAgICAgICAgICA8L3R0PjwvdGQ+CiAgICAgICAgICAgIDx0ZD4KICAgICAgICAgICAgICA8c2VsZWN0IG5hbWU9ImlucHV0NiIgbXVsdGlwbGUgc2l6ZT0iNCI+CiAgICAgICAgICAgICAgICA8b3B0aW9uIHZhbHVlPSJlIj5FPC9vcHRpb24+CiAgICAgICAgICAgICAgICA8b3B0aW9uIHZhbHVlPSJmIj5GPC9vcHRpb24+CiAgICAgICAgICAgICAgPC9zZWxlY3Q+CiAgICAgICAgICAgIDwvdGQ+CiAgICAgICAgICAgIDx0ZD48dHQ+e3tpbnB1dDZ8anNvbn19PC90dD48L3RkPgogICAgICAgICAgPC90cj4KICAgICAgICA8L3RhYmxlPgogICAgICA8L2RvYzpzb3VyY2U+CiAgICAgIDxkb2M6c2NlbmFyaW8+CgogICAgICAgIGl0KCdzaG91bGQgZXhlcmNpc2UgdGV4dCcsIGZ1bmN0aW9uKCl7CiAgICAgICAgIGlucHV0KCdpbnB1dDEnKS5lbnRlcignQ2FybG9zJyk7CiAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdpbnB1dDEnKSkudG9FcXVhbCgnIkNhcmxvcyInKTsKICAgICAgICB9KTsKICAgICAgICBpdCgnc2hvdWxkIGV4ZXJjaXNlIHRleHRhcmVhJywgZnVuY3Rpb24oKXsKICAgICAgICAgaW5wdXQoJ2lucHV0MicpLmVudGVyKCdDYXJsb3MnKTsKICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ2lucHV0MicpKS50b0VxdWFsKCciQ2FybG9zIicpOwogICAgICAgIH0pOwogICAgICAgIGl0KCdzaG91bGQgZXhlcmNpc2UgcmFkaW8nLCBmdW5jdGlvbigpewogICAgICAgICBleHBlY3QoYmluZGluZygnaW5wdXQzJykpLnRvRXF1YWwoJ251bGwnKTsKICAgICAgICAgaW5wdXQoJ2lucHV0MycpLnNlbGVjdCgnQScpOwogICAgICAgICBleHBlY3QoYmluZGluZygnaW5wdXQzJykpLnRvRXF1YWwoJyJBIicpOwogICAgICAgICBpbnB1dCgnaW5wdXQzJykuc2VsZWN0KCdCJyk7CiAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdpbnB1dDMnKSkudG9FcXVhbCgnIkIiJyk7CiAgICAgICAgfSk7CiAgICAgICAgaXQoJ3Nob3VsZCBleGVyY2lzZSBjaGVja2JveCcsIGZ1bmN0aW9uKCl7CiAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdpbnB1dDQnKSkudG9FcXVhbCgnZmFsc2UnKTsKICAgICAgICAgaW5wdXQoJ2lucHV0NCcpLmNoZWNrKCk7CiAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdpbnB1dDQnKSkudG9FcXVhbCgndHJ1ZScpOwogICAgICAgIH0pOwogICAgICAgIGl0KCdzaG91bGQgZXhlcmNpc2UgcHVsbGRvd24nLCBmdW5jdGlvbigpewogICAgICAgICBleHBlY3QoYmluZGluZygnaW5wdXQ1JykpLnRvRXF1YWwoJyJjIicpOwogICAgICAgICBzZWxlY3QoJ2lucHV0NScpLm9wdGlvbignZCcpOwogICAgICAgICBleHBlY3QoYmluZGluZygnaW5wdXQ1JykpLnRvRXF1YWwoJyJkIicpOwogICAgICAgIH0pOwogICAgICAgIGl0KCdzaG91bGQgZXhlcmNpc2UgbXVsdGlzZWxlY3QnLCBmdW5jdGlvbigpewogICAgICAgICBleHBlY3QoYmluZGluZygnaW5wdXQ2JykpLnRvRXF1YWwoJ1tdJyk7CiAgICAgICAgIHNlbGVjdCgnaW5wdXQ2Jykub3B0aW9ucygnZScpOwogICAgICAgICBleHBlY3QoYmluZGluZygnaW5wdXQ2JykpLnRvRXF1YWwoJ1siZSJdJyk7CiAgICAgICAgIHNlbGVjdCgnaW5wdXQ2Jykub3B0aW9ucygnZScsICdmJyk7CiAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdpbnB1dDYnKSkudG9FcXVhbCgnWyJlIiwiZiJdJyk7CiAgICAgICAgfSk7CiAgICAgIDwvZG9jOnNjZW5hcmlvPgogICAgPC9kb2M6ZXhhbXBsZT4KICovCgpmdW5jdGlvbiBtb2RlbEFjY2Vzc29yKHNjb3BlLCBlbGVtZW50KSB7CiAgdmFyIGV4cHIgPSBlbGVtZW50LmF0dHIoJ25hbWUnKTsKICB2YXIgZXhwckZuLCBhc3NpZ25GbjsKICBpZiAoZXhwcikgewogICAgZXhwckZuID0gcGFyc2VyKGV4cHIpLmFzc2lnbmFibGUoKTsKICAgIGFzc2lnbkZuID0gZXhwckZuLmFzc2lnbjsKICAgIGlmICghYXNzaWduRm4pIHRocm93IG5ldyBFcnJvcigiRXhwcmVzc2lvbiAnIiArIGV4cHIgKyAiJyBpcyBub3QgYXNzaWduYWJsZS4iKTsKICAgIHJldHVybiB7CiAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIGV4cHJGbihzY29wZSk7CiAgICAgIH0sCiAgICAgIHNldDogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICBpZiAodmFsdWUgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgcmV0dXJuIHNjb3BlLiR0cnlFdmFsKGZ1bmN0aW9uKCl7CiAgICAgICAgICAgIGFzc2lnbkZuKHNjb3BlLCB2YWx1ZSk7CiAgICAgICAgICB9LCBlbGVtZW50KTsKICAgICAgICB9CiAgICAgIH0KICAgIH07CiAgfQp9CgpmdW5jdGlvbiBtb2RlbEZvcm1hdHRlZEFjY2Vzc29yKHNjb3BlLCBlbGVtZW50KSB7CiAgdmFyIGFjY2Vzc29yID0gbW9kZWxBY2Nlc3NvcihzY29wZSwgZWxlbWVudCksCiAgICAgIGZvcm1hdHRlck5hbWUgPSBlbGVtZW50LmF0dHIoJ25nOmZvcm1hdCcpIHx8IE5PT1AsCiAgICAgIGZvcm1hdHRlciA9IGNvbXBpbGVGb3JtYXR0ZXIoZm9ybWF0dGVyTmFtZSk7CiAgaWYgKGFjY2Vzc29yKSB7CiAgICByZXR1cm4gewogICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBmb3JtYXR0ZXIuZm9ybWF0KHNjb3BlLCBhY2Nlc3Nvci5nZXQoKSk7CiAgICAgIH0sCiAgICAgIHNldDogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICByZXR1cm4gYWNjZXNzb3Iuc2V0KGZvcm1hdHRlci5wYXJzZShzY29wZSwgdmFsdWUpKTsKICAgICAgfQogICAgfTsKICB9Cn0KCmZ1bmN0aW9uIGNvbXBpbGVWYWxpZGF0b3IoZXhwcikgewogIHJldHVybiBwYXJzZXIoZXhwcikudmFsaWRhdG9yKCkoKTsKfQoKZnVuY3Rpb24gY29tcGlsZUZvcm1hdHRlcihleHByKSB7CiAgcmV0dXJuIHBhcnNlcihleHByKS5mb3JtYXR0ZXIoKSgpOwp9CgovKioKICogQHdvcmtJblByb2dyZXNzCiAqIEBuZ2RvYyB3aWRnZXQKICogQG5hbWUgYW5ndWxhci53aWRnZXQuQG5nOnZhbGlkYXRlCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBUaGUgYG5nOnZhbGlkYXRlYCBhdHRyaWJ1dGUgd2lkZ2V0IHZhbGlkYXRlcyB0aGUgdXNlciBpbnB1dC4gSWYgdGhlIGlucHV0IGRvZXMgbm90IHBhc3MKICogdmFsaWRhdGlvbiwgdGhlIGBuZy12YWxpZGF0aW9uLWVycm9yYCBDU1MgY2xhc3MgYW5kIHRoZSBgbmc6ZXJyb3JgIGF0dHJpYnV0ZSBhcmUgc2V0IG9uIHRoZSBpbnB1dAogKiBlbGVtZW50LiBDaGVjayBvdXQge0BsaW5rIGFuZ3VsYXIudmFsaWRhdG9yIHZhbGlkYXRvcnN9IHRvIGZpbmQgb3V0IG1vcmUuCiAqCiAqIEBwYXJhbSB7c3RyaW5nfSB2YWxpZGF0b3IgVGhlIG5hbWUgb2YgYSBidWlsdC1pbiBvciBjdXN0b20ge0BsaW5rIGFuZ3VsYXIudmFsaWRhdG9yIHZhbGlkYXRvcn0gdG8KICogICAgIHRvIGJlIHVzZWQuCiAqCiAqIEBlbGVtZW50IElOUFVUCiAqIEBjc3MgbmctdmFsaWRhdGlvbi1lcnJvcgogKgogKiBAZXhhbXBsZQogKiBUaGlzIGV4YW1wbGUgc2hvd3MgaG93IHRoZSBpbnB1dCBlbGVtZW50IGJlY29tZXMgcmVkIHdoZW4gaXQgY29udGFpbnMgaW52YWxpZCBpbnB1dC4gQ29ycmVjdAogKiB0aGUgaW5wdXQgdG8gbWFrZSB0aGUgZXJyb3IgZGlzYXBwZWFyLgogKgogICAgPGRvYzpleGFtcGxlPgogICAgICA8ZG9jOnNvdXJjZT4KICAgICAgICBJIGRvbid0IHZhbGlkYXRlOgogICAgICAgIDxpbnB1dCB0eXBlPSJ0ZXh0IiBuYW1lPSJ2YWx1ZSIgdmFsdWU9Ik5vdEFOdW1iZXIiPjxici8+CgogICAgICAgIEkgbmVlZCBhbiBpbnRlZ2VyIG9yIG5vdGhpbmc6CiAgICAgICAgPGlucHV0IHR5cGU9InRleHQiIG5hbWU9InZhbHVlIiBuZzp2YWxpZGF0ZT0iaW50ZWdlciI+PGJyLz4KICAgICAgPC9kb2M6c291cmNlPgogICAgICA8ZG9jOnNjZW5hcmlvPgogICAgICAgICBpdCgnc2hvdWxkIGNoZWNrIG5nOnZhbGlkYXRlJywgZnVuY3Rpb24oKXsKICAgICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgOmlucHV0Omxhc3QnKS5hdHRyKCdjbGFzc05hbWUnKSkuCiAgICAgICAgICAgICB0b01hdGNoKC9uZy12YWxpZGF0aW9uLWVycm9yLyk7CgogICAgICAgICAgIGlucHV0KCd2YWx1ZScpLmVudGVyKCcxMjMnKTsKICAgICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgOmlucHV0Omxhc3QnKS5hdHRyKCdjbGFzc05hbWUnKSkuCiAgICAgICAgICAgICBub3QoKS50b01hdGNoKC9uZy12YWxpZGF0aW9uLWVycm9yLyk7CiAgICAgICAgIH0pOwogICAgICA8L2RvYzpzY2VuYXJpbz4KICAgIDwvZG9jOmV4YW1wbGU+CiAqLwovKioKICogQHdvcmtJblByb2dyZXNzCiAqIEBuZ2RvYyB3aWRnZXQKICogQG5hbWUgYW5ndWxhci53aWRnZXQuQG5nOnJlcXVpcmVkCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBUaGUgYG5nOnJlcXVpcmVkYCBhdHRyaWJ1dGUgd2lkZ2V0IHZhbGlkYXRlcyB0aGF0IHRoZSB1c2VyIGlucHV0IGlzIHByZXNlbnQuIEl0IGlzIGEgc3BlY2lhbCBjYXNlCiAqIG9mIHRoZSB7QGxpbmsgYW5ndWxhci53aWRnZXQuQG5nOnZhbGlkYXRlIG5nOnZhbGlkYXRlfSBhdHRyaWJ1dGUgd2lkZ2V0LgogKgogKiBAZWxlbWVudCBJTlBVVAogKiBAY3NzIG5nLXZhbGlkYXRpb24tZXJyb3IKICoKICogQGV4YW1wbGUKICogVGhpcyBleGFtcGxlIHNob3dzIGhvdyB0aGUgaW5wdXQgZWxlbWVudCBiZWNvbWVzIHJlZCB3aGVuIGl0IGNvbnRhaW5zIGludmFsaWQgaW5wdXQuIENvcnJlY3QKICogdGhlIGlucHV0IHRvIG1ha2UgdGhlIGVycm9yIGRpc2FwcGVhci4KICoKICAgIDxkb2M6ZXhhbXBsZT4KICAgICAgPGRvYzpzb3VyY2U+CiAgICAgICAgSSBjYW5ub3QgYmUgYmxhbms6IDxpbnB1dCB0eXBlPSJ0ZXh0IiBuYW1lPSJ2YWx1ZSIgbmc6cmVxdWlyZWQ+PGJyLz4KICAgICAgPC9kb2M6c291cmNlPgogICAgICA8ZG9jOnNjZW5hcmlvPgogICAgICAgaXQoJ3Nob3VsZCBjaGVjayBuZzpyZXF1aXJlZCcsIGZ1bmN0aW9uKCl7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSA6aW5wdXQnKS5hdHRyKCdjbGFzc05hbWUnKSkudG9NYXRjaCgvbmctdmFsaWRhdGlvbi1lcnJvci8pOwogICAgICAgICBpbnB1dCgndmFsdWUnKS5lbnRlcignMTIzJyk7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSA6aW5wdXQnKS5hdHRyKCdjbGFzc05hbWUnKSkubm90KCkudG9NYXRjaCgvbmctdmFsaWRhdGlvbi1lcnJvci8pOwogICAgICAgfSk7CiAgICAgIDwvZG9jOnNjZW5hcmlvPgogICAgPC9kb2M6ZXhhbXBsZT4KICovCi8qKgogKiBAd29ya0luUHJvZ3Jlc3MKICogQG5nZG9jIHdpZGdldAogKiBAbmFtZSBhbmd1bGFyLndpZGdldC5Abmc6Zm9ybWF0CiAqCiAqIEBkZXNjcmlwdGlvbgogKiBUaGUgYG5nOmZvcm1hdGAgYXR0cmlidXRlIHdpZGdldCBmb3JtYXRzIHN0b3JlZCBkYXRhIHRvIHVzZXItcmVhZGFibGUgdGV4dCBhbmQgcGFyc2VzIHRoZSB0ZXh0CiAqIGJhY2sgdG8gdGhlIHN0b3JlZCBmb3JtLiBZb3UgbWlnaHQgZmluZCB0aGlzIHVzZWZ1bCwgZm9yIGV4YW1wbGUsIGlmIHlvdSBjb2xsZWN0IHVzZXIgaW5wdXQgaW4gYQogKiB0ZXh0IGZpZWxkIGJ1dCBuZWVkIHRvIHN0b3JlIHRoZSBkYXRhIGluIHRoZSBtb2RlbCBhcyBhIGxpc3QuIENoZWNrIG91dAogKiB7QGxpbmsgYW5ndWxhci5mb3JtYXR0ZXIgZm9ybWF0dGVyc30gdG8gbGVhcm4gbW9yZS4KICoKICogQHBhcmFtIHtzdHJpbmd9IGZvcm1hdHRlciBUaGUgbmFtZSBvZiB0aGUgYnVpbHQtaW4gb3IgY3VzdG9tIHtAbGluayBhbmd1bGFyLmZvcm1hdHRlciBmb3JtYXR0ZXJ9CiAqICAgICB0byBiZSB1c2VkLgogKgogKiBAZWxlbWVudCBJTlBVVAogKgogKiBAZXhhbXBsZQogKiBUaGlzIGV4YW1wbGUgc2hvd3MgaG93IHRoZSB1c2VyIGlucHV0IGlzIGNvbnZlcnRlZCBmcm9tIGEgc3RyaW5nIGFuZCBpbnRlcm5hbGx5IHJlcHJlc2VudGVkIGFzIGFuCiAqIGFycmF5LgogKgogICAgPGRvYzpleGFtcGxlPgogICAgICA8ZG9jOnNvdXJjZT4KICAgICAgICBFbnRlciBhIGNvbW1hIHNlcGFyYXRlZCBsaXN0IG9mIGl0ZW1zOgogICAgICAgIDxpbnB1dCB0eXBlPSJ0ZXh0IiBuYW1lPSJsaXN0IiBuZzpmb3JtYXQ9Imxpc3QiIHZhbHVlPSJ0YWJsZSwgY2hhaXJzLCBwbGF0ZSI+CiAgICAgICAgPHByZT5saXN0PXt7bGlzdH19PC9wcmU+CiAgICAgIDwvZG9jOnNvdXJjZT4KICAgICAgPGRvYzpzY2VuYXJpbz4KICAgICAgIGl0KCdzaG91bGQgY2hlY2sgbmc6Zm9ybWF0JywgZnVuY3Rpb24oKXsKICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ2xpc3QnKSkudG9CZSgnbGlzdD1bInRhYmxlIiwiY2hhaXJzIiwicGxhdGUiXScpOwogICAgICAgICBpbnB1dCgnbGlzdCcpLmVudGVyKCcsLCwgYSAsLCwnKTsKICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ2xpc3QnKSkudG9CZSgnbGlzdD1bImEiXScpOwogICAgICAgfSk7CiAgICAgIDwvZG9jOnNjZW5hcmlvPgogICAgPC9kb2M6ZXhhbXBsZT4KICovCmZ1bmN0aW9uIHZhbHVlQWNjZXNzb3Ioc2NvcGUsIGVsZW1lbnQpIHsKICB2YXIgdmFsaWRhdG9yTmFtZSA9IGVsZW1lbnQuYXR0cignbmc6dmFsaWRhdGUnKSB8fCBOT09QLAogICAgICB2YWxpZGF0b3IgPSBjb21waWxlVmFsaWRhdG9yKHZhbGlkYXRvck5hbWUpLAogICAgICByZXF1aXJlZEV4cHIgPSBlbGVtZW50LmF0dHIoJ25nOnJlcXVpcmVkJyksCiAgICAgIGZvcm1hdHRlck5hbWUgPSBlbGVtZW50LmF0dHIoJ25nOmZvcm1hdCcpIHx8IE5PT1AsCiAgICAgIGZvcm1hdHRlciA9IGNvbXBpbGVGb3JtYXR0ZXIoZm9ybWF0dGVyTmFtZSksCiAgICAgIGZvcm1hdCwgcGFyc2UsIGxhc3RFcnJvciwgcmVxdWlyZWQsCiAgICAgIGludmFsaWRXaWRnZXRzID0gc2NvcGUuJHNlcnZpY2UoJyRpbnZhbGlkV2lkZ2V0cycpIHx8IHttYXJrVmFsaWQ6bm9vcCwgbWFya0ludmFsaWQ6bm9vcH07CiAgaWYgKCF2YWxpZGF0b3IpIHRocm93ICJWYWxpZGF0b3IgbmFtZWQgJyIgKyB2YWxpZGF0b3JOYW1lICsgIicgbm90IGZvdW5kLiI7CiAgZm9ybWF0ID0gZm9ybWF0dGVyLmZvcm1hdDsKICBwYXJzZSA9IGZvcm1hdHRlci5wYXJzZTsKICBpZiAocmVxdWlyZWRFeHByKSB7CiAgICBzY29wZS4kd2F0Y2gocmVxdWlyZWRFeHByLCBmdW5jdGlvbihuZXdWYWx1ZSkgewogICAgICByZXF1aXJlZCA9IG5ld1ZhbHVlOwogICAgICB2YWxpZGF0ZSgpOwogICAgfSk7CiAgfSBlbHNlIHsKICAgIHJlcXVpcmVkID0gcmVxdWlyZWRFeHByID09PSAnJzsKICB9CgogIGVsZW1lbnQuZGF0YSgkJHZhbGlkYXRlLCB2YWxpZGF0ZSk7CiAgcmV0dXJuIHsKICAgIGdldDogZnVuY3Rpb24oKXsKICAgICAgaWYgKGxhc3RFcnJvcikKICAgICAgICBlbGVtZW50RXJyb3IoZWxlbWVudCwgTkdfVkFMSURBVElPTl9FUlJPUiwgbnVsbCk7CiAgICAgIHRyeSB7CiAgICAgICAgdmFyIHZhbHVlID0gcGFyc2Uoc2NvcGUsIGVsZW1lbnQudmFsKCkpOwogICAgICAgIHZhbGlkYXRlKCk7CiAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgbGFzdEVycm9yID0gZTsKICAgICAgICBlbGVtZW50RXJyb3IoZWxlbWVudCwgTkdfVkFMSURBVElPTl9FUlJPUiwgZSk7CiAgICAgIH0KICAgIH0sCiAgICBzZXQ6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIHZhciBvbGRWYWx1ZSA9IGVsZW1lbnQudmFsKCksCiAgICAgICAgICBuZXdWYWx1ZSA9IGZvcm1hdChzY29wZSwgdmFsdWUpOwogICAgICBpZiAob2xkVmFsdWUgIT0gbmV3VmFsdWUpIHsKICAgICAgICBlbGVtZW50LnZhbChuZXdWYWx1ZSB8fCAnJyk7IC8vIG5lZWRlZCBmb3IgaWUKICAgICAgfQogICAgICB2YWxpZGF0ZSgpOwogICAgfQogIH07CgogIGZ1bmN0aW9uIHZhbGlkYXRlKCkgewogICAgdmFyIHZhbHVlID0gdHJpbShlbGVtZW50LnZhbCgpKTsKICAgIGlmIChlbGVtZW50WzBdLmRpc2FibGVkIHx8IGVsZW1lbnRbMF0ucmVhZE9ubHkpIHsKICAgICAgZWxlbWVudEVycm9yKGVsZW1lbnQsIE5HX1ZBTElEQVRJT05fRVJST1IsIG51bGwpOwogICAgICBpbnZhbGlkV2lkZ2V0cy5tYXJrVmFsaWQoZWxlbWVudCk7CiAgICB9IGVsc2UgewogICAgICB2YXIgZXJyb3IsIHZhbGlkYXRlU2NvcGUgPSBpbmhlcml0KHNjb3BlLCB7JGVsZW1lbnQ6ZWxlbWVudH0pOwogICAgICBlcnJvciA9IHJlcXVpcmVkICYmICF2YWx1ZQogICAgICAgICAgICAgID8gJ1JlcXVpcmVkJwogICAgICAgICAgICAgIDogKHZhbHVlID8gdmFsaWRhdG9yKHZhbGlkYXRlU2NvcGUsIHZhbHVlKSA6IG51bGwpOwogICAgICBlbGVtZW50RXJyb3IoZWxlbWVudCwgTkdfVkFMSURBVElPTl9FUlJPUiwgZXJyb3IpOwogICAgICBsYXN0RXJyb3IgPSBlcnJvcjsKICAgICAgaWYgKGVycm9yKSB7CiAgICAgICAgaW52YWxpZFdpZGdldHMubWFya0ludmFsaWQoZWxlbWVudCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaW52YWxpZFdpZGdldHMubWFya1ZhbGlkKGVsZW1lbnQpOwogICAgICB9CiAgICB9CiAgfQp9CgpmdW5jdGlvbiBjaGVja2VkQWNjZXNzb3Ioc2NvcGUsIGVsZW1lbnQpIHsKICB2YXIgZG9tRWxlbWVudCA9IGVsZW1lbnRbMF0sIGVsZW1lbnRWYWx1ZSA9IGRvbUVsZW1lbnQudmFsdWU7CiAgcmV0dXJuIHsKICAgIGdldDogZnVuY3Rpb24oKXsKICAgICAgcmV0dXJuICEhZG9tRWxlbWVudC5jaGVja2VkOwogICAgfSwKICAgIHNldDogZnVuY3Rpb24odmFsdWUpewogICAgICBkb21FbGVtZW50LmNoZWNrZWQgPSB0b0Jvb2xlYW4odmFsdWUpOwogICAgfQogIH07Cn0KCmZ1bmN0aW9uIHJhZGlvQWNjZXNzb3Ioc2NvcGUsIGVsZW1lbnQpIHsKICB2YXIgZG9tRWxlbWVudCA9IGVsZW1lbnRbMF07CiAgcmV0dXJuIHsKICAgIGdldDogZnVuY3Rpb24oKXsKICAgICAgcmV0dXJuIGRvbUVsZW1lbnQuY2hlY2tlZCA/IGRvbUVsZW1lbnQudmFsdWUgOiBudWxsOwogICAgfSwKICAgIHNldDogZnVuY3Rpb24odmFsdWUpewogICAgICBkb21FbGVtZW50LmNoZWNrZWQgPSB2YWx1ZSA9PSBkb21FbGVtZW50LnZhbHVlOwogICAgfQogIH07Cn0KCmZ1bmN0aW9uIG9wdGlvbnNBY2Nlc3NvcihzY29wZSwgZWxlbWVudCkgewogIHZhciBmb3JtYXR0ZXJOYW1lID0gZWxlbWVudC5hdHRyKCduZzpmb3JtYXQnKSB8fCBOT09QLAogICAgICBmb3JtYXR0ZXIgPSBjb21waWxlRm9ybWF0dGVyKGZvcm1hdHRlck5hbWUpOwogIHJldHVybiB7CiAgICBnZXQ6IGZ1bmN0aW9uKCl7CiAgICAgIHZhciB2YWx1ZXMgPSBbXTsKICAgICAgZm9yRWFjaChlbGVtZW50WzBdLm9wdGlvbnMsIGZ1bmN0aW9uKG9wdGlvbil7CiAgICAgICAgaWYgKG9wdGlvbi5zZWxlY3RlZCkgdmFsdWVzLnB1c2goZm9ybWF0dGVyLnBhcnNlKHNjb3BlLCBvcHRpb24udmFsdWUpKTsKICAgICAgfSk7CiAgICAgIHJldHVybiB2YWx1ZXM7CiAgICB9LAogICAgc2V0OiBmdW5jdGlvbih2YWx1ZXMpewogICAgICB2YXIga2V5cyA9IHt9OwogICAgICBmb3JFYWNoKHZhbHVlcywgZnVuY3Rpb24odmFsdWUpewogICAgICAgIGtleXNbZm9ybWF0dGVyLmZvcm1hdChzY29wZSwgdmFsdWUpXSA9IHRydWU7CiAgICAgIH0pOwogICAgICBmb3JFYWNoKGVsZW1lbnRbMF0ub3B0aW9ucywgZnVuY3Rpb24ob3B0aW9uKXsKICAgICAgICBvcHRpb24uc2VsZWN0ZWQgPSBrZXlzW29wdGlvbi52YWx1ZV07CiAgICAgIH0pOwogICAgfQogIH07Cn0KCmZ1bmN0aW9uIG5vb3BBY2Nlc3NvcigpIHsgcmV0dXJuIHsgZ2V0OiBub29wLCBzZXQ6IG5vb3AgfTsgfQoKLyoKICogVE9ETzogcmVmYWN0b3IKICoKICogVGhlIHRhYmxlIGJlbG93IGlzIG5vdCBxdWl0ZSByaWdodC4gSW4gc29tZSBjYXNlcyB0aGUgZm9ybWF0dGVyIGlzIG9uIHRoZSBtb2RlbCBzaWRlCiAqIGFuZCBpbiBzb21lIGNhc2VzIGl0IGlzIG9uIHRoZSB2aWV3IHNpZGUuIFRoaXMgaXMgYSBoaXN0b3JpY2FsIGFydGlmYWN0CiAqCiAqIFRoZSBjb25jZXB0IG9mIG1vZGVsL3ZpZXcgYWNjZXNzb3IgaXMgdXNlZnVsIGZvciBhbnlvbmUgd2hvIGlzIHRyeWluZyB0byBkZXZlbG9wIFVJLCBhbmQKICogc28gaXQgc2hvdWxkIGJlIGV4cG9zZWQgdG8gb3RoZXJzLiBUaGVyZSBzaG91bGQgYmUgYSBmb3JtIG9iamVjdCB3aGljaCBrZWVwcyB0cmFjayBvZiB0aGUKICogYWNjZXNzb3JzIGFuZCBhbHNvIGFjdHMgYXMgdGhlaXIgZmFjdG9yeS4gSXQgc2hvdWxkIGV4cG9zZSBpdCBhcyBhbiBvYmplY3QgYW5kIGFsbG93CiAqIHRoZSB2YWxpZGF0b3IgdG8gcHVibGlzaCBlcnJvcnMgdG8gaXQsIHNvIHRoYXQgdGhlIHRoZSBlcnJvciBtZXNzYWdlcyBjYW4gYmUgYm91bmQgdG8gaXQuCiAqCiAqLwp2YXIgdGV4dFdpZGdldCA9IGlucHV0V2lkZ2V0KCdrZXlkb3duIGNoYW5nZScsIG1vZGVsQWNjZXNzb3IsIHZhbHVlQWNjZXNzb3IsIGluaXRXaWRnZXRWYWx1ZSgpLCB0cnVlKSwKICAgIElOUFVUX1RZUEUgPSB7CiAgICAgICd0ZXh0JzogICAgICAgICAgICB0ZXh0V2lkZ2V0LAogICAgICAndGV4dGFyZWEnOiAgICAgICAgdGV4dFdpZGdldCwKICAgICAgJ2hpZGRlbic6ICAgICAgICAgIHRleHRXaWRnZXQsCiAgICAgICdwYXNzd29yZCc6ICAgICAgICB0ZXh0V2lkZ2V0LAogICAgICAnY2hlY2tib3gnOiAgICAgICAgaW5wdXRXaWRnZXQoJ2NsaWNrJywgbW9kZWxGb3JtYXR0ZWRBY2Nlc3NvciwgY2hlY2tlZEFjY2Vzc29yLCBpbml0V2lkZ2V0VmFsdWUoZmFsc2UpKSwKICAgICAgJ3JhZGlvJzogICAgICAgICAgIGlucHV0V2lkZ2V0KCdjbGljaycsIG1vZGVsRm9ybWF0dGVkQWNjZXNzb3IsIHJhZGlvQWNjZXNzb3IsIHJhZGlvSW5pdCksCiAgICAgICdzZWxlY3Qtb25lJzogICAgICBpbnB1dFdpZGdldCgnY2hhbmdlJywgbW9kZWxBY2Nlc3NvciwgdmFsdWVBY2Nlc3NvciwgaW5pdFdpZGdldFZhbHVlKG51bGwpKSwKICAgICAgJ3NlbGVjdC1tdWx0aXBsZSc6IGlucHV0V2lkZ2V0KCdjaGFuZ2UnLCBtb2RlbEFjY2Vzc29yLCBvcHRpb25zQWNjZXNzb3IsIGluaXRXaWRnZXRWYWx1ZShbXSkpCi8vICAgICAgJ2ZpbGUnOiAgICAgICAgICAgIGZpbGVXaWRnZXQ/Pz8KICAgIH07CgoKZnVuY3Rpb24gaW5pdFdpZGdldFZhbHVlKGluaXRWYWx1ZSkgewogIHJldHVybiBmdW5jdGlvbiAobW9kZWwsIHZpZXcpIHsKICAgIHZhciB2YWx1ZSA9IHZpZXcuZ2V0KCk7CiAgICBpZiAoIXZhbHVlICYmIGlzRGVmaW5lZChpbml0VmFsdWUpKSB7CiAgICAgIHZhbHVlID0gY29weShpbml0VmFsdWUpOwogICAgfQogICAgaWYgKGlzVW5kZWZpbmVkKG1vZGVsLmdldCgpKSAmJiBpc0RlZmluZWQodmFsdWUpKSB7CiAgICAgIG1vZGVsLnNldCh2YWx1ZSk7CiAgICB9CiAgfTsKfQoKZnVuY3Rpb24gcmFkaW9Jbml0KG1vZGVsLCB2aWV3LCBlbGVtZW50KSB7CiB2YXIgbW9kZWxWYWx1ZSA9IG1vZGVsLmdldCgpLCB2aWV3VmFsdWUgPSB2aWV3LmdldCgpLCBpbnB1dCA9IGVsZW1lbnRbMF07CiBpbnB1dC5jaGVja2VkID0gZmFsc2U7CiBpbnB1dC5uYW1lID0gdGhpcy4kaWQgKyAnQCcgKyBpbnB1dC5uYW1lOwogaWYgKGlzVW5kZWZpbmVkKG1vZGVsVmFsdWUpKSB7CiAgIG1vZGVsLnNldChtb2RlbFZhbHVlID0gbnVsbCk7CiB9CiBpZiAobW9kZWxWYWx1ZSA9PSBudWxsICYmIHZpZXdWYWx1ZSAhPT0gbnVsbCkgewogICBtb2RlbC5zZXQodmlld1ZhbHVlKTsKIH0KIHZpZXcuc2V0KG1vZGVsVmFsdWUpOwp9CgovKioKICogQHdvcmtJblByb2dyZXNzCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgYW5ndWxhci5kaXJlY3RpdmUubmc6Y2hhbmdlCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBUaGUgZGlyZWN0aXZlIGV4ZWN1dGVzIGFuIGV4cHJlc3Npb24gd2hlbmV2ZXIgdGhlIGlucHV0IHdpZGdldCBjaGFuZ2VzLgogKgogKiBAZWxlbWVudCBJTlBVVAogKiBAcGFyYW0ge2V4cHJlc3Npb259IGV4cHJlc3Npb24gdG8gZXhlY3V0ZS4KICoKICogQGV4YW1wbGUKICogQGV4YW1wbGUKICAgIDxkb2M6ZXhhbXBsZT4KICAgICAgPGRvYzpzb3VyY2U+CiAgICAgICAgPGRpdiBuZzppbml0PSJjaGVja2JveENvdW50PTA7IHRleHRDb3VudD0wIj48L2Rpdj4KICAgICAgICA8aW5wdXQgdHlwZT0idGV4dCIgbmFtZT0idGV4dCIgbmc6Y2hhbmdlPSJ0ZXh0Q291bnQgPSAxICsgdGV4dENvdW50Ij4KICAgICAgICAgICBjaGFuZ2VDb3VudCB7e3RleHRDb3VudH19PGJyLz4KICAgICAgICA8aW5wdXQgdHlwZT0iY2hlY2tib3giIG5hbWU9ImNoZWNrYm94IiBuZzpjaGFuZ2U9ImNoZWNrYm94Q291bnQgPSAxICsgY2hlY2tib3hDb3VudCI+CiAgICAgICAgICAgY2hhbmdlQ291bnQge3tjaGVja2JveENvdW50fX08YnIvPgogICAgICA8L2RvYzpzb3VyY2U+CiAgICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgICAgIGl0KCdzaG91bGQgY2hlY2sgbmc6Y2hhbmdlJywgZnVuY3Rpb24oKXsKICAgICAgICAgICBleHBlY3QoYmluZGluZygndGV4dENvdW50JykpLnRvQmUoJzAnKTsKICAgICAgICAgICBleHBlY3QoYmluZGluZygnY2hlY2tib3hDb3VudCcpKS50b0JlKCcwJyk7CgogICAgICAgICAgIHVzaW5nKCcuZG9jLWV4YW1wbGUtbGl2ZScpLmlucHV0KCd0ZXh0JykuZW50ZXIoJ2FiYycpOwogICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCd0ZXh0Q291bnQnKSkudG9CZSgnMScpOwogICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdjaGVja2JveENvdW50JykpLnRvQmUoJzAnKTsKCgogICAgICAgICAgIHVzaW5nKCcuZG9jLWV4YW1wbGUtbGl2ZScpLmlucHV0KCdjaGVja2JveCcpLmNoZWNrKCk7CiAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3RleHRDb3VudCcpKS50b0JlKCcxJyk7CiAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ2NoZWNrYm94Q291bnQnKSkudG9CZSgnMScpOwogICAgICAgICB9KTsKICAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICA8L2RvYzpleGFtcGxlPgogKi8KZnVuY3Rpb24gaW5wdXRXaWRnZXQoZXZlbnRzLCBtb2RlbEFjY2Vzc29yLCB2aWV3QWNjZXNzb3IsIGluaXRGbiwgdGV4dEJveCkgewogIHJldHVybiBhbm5vdGF0ZSgnJHVwZGF0ZVZpZXcnLCAnJGRlZmVyJywgZnVuY3Rpb24oJHVwZGF0ZVZpZXcsICRkZWZlciwgZWxlbWVudCkgewogICAgdmFyIHNjb3BlID0gdGhpcywKICAgICAgICBtb2RlbCA9IG1vZGVsQWNjZXNzb3Ioc2NvcGUsIGVsZW1lbnQpLAogICAgICAgIHZpZXcgPSB2aWV3QWNjZXNzb3Ioc2NvcGUsIGVsZW1lbnQpLAogICAgICAgIGFjdGlvbiA9IGVsZW1lbnQuYXR0cignbmc6Y2hhbmdlJykgfHwgJycsCiAgICAgICAgbGFzdFZhbHVlOwogICAgaWYgKG1vZGVsKSB7CiAgICAgIGluaXRGbi5jYWxsKHNjb3BlLCBtb2RlbCwgdmlldywgZWxlbWVudCk7CiAgICAgIHRoaXMuJGV2YWwoZWxlbWVudC5hdHRyKCduZzppbml0Jyl8fCcnKTsKICAgICAgZWxlbWVudC5iaW5kKGV2ZW50cywgZnVuY3Rpb24oZXZlbnQpewogICAgICAgIGZ1bmN0aW9uIGhhbmRsZXIoKXsKICAgICAgICAgIHZhciB2YWx1ZSA9IHZpZXcuZ2V0KCk7CiAgICAgICAgICBpZiAoIXRleHRCb3ggfHwgdmFsdWUgIT0gbGFzdFZhbHVlKSB7CiAgICAgICAgICAgIG1vZGVsLnNldCh2YWx1ZSk7CiAgICAgICAgICAgIGxhc3RWYWx1ZSA9IG1vZGVsLmdldCgpOwogICAgICAgICAgICBzY29wZS4kdHJ5RXZhbChhY3Rpb24sIGVsZW1lbnQpOwogICAgICAgICAgICAkdXBkYXRlVmlldygpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBldmVudC50eXBlID09ICdrZXlkb3duJyA/ICRkZWZlcihoYW5kbGVyKSA6IGhhbmRsZXIoKTsKICAgICAgfSk7CiAgICAgIHNjb3BlLiR3YXRjaChtb2RlbC5nZXQsIGZ1bmN0aW9uKHZhbHVlKXsKICAgICAgICBpZiAobGFzdFZhbHVlICE9PSB2YWx1ZSkgewogICAgICAgICAgdmlldy5zZXQobGFzdFZhbHVlID0gdmFsdWUpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgfSk7Cn0KCmZ1bmN0aW9uIGlucHV0V2lkZ2V0U2VsZWN0b3IoZWxlbWVudCl7CiAgdGhpcy5kaXJlY3RpdmVzKHRydWUpOwogIHRoaXMuZGVzY2VuZCh0cnVlKTsKICByZXR1cm4gSU5QVVRfVFlQRVtsb3dlcmNhc2UoZWxlbWVudFswXS50eXBlKV0gfHwgbm9vcDsKfQoKYW5ndWxhcldpZGdldCgnaW5wdXQnLCBpbnB1dFdpZGdldFNlbGVjdG9yKTsKYW5ndWxhcldpZGdldCgndGV4dGFyZWEnLCBpbnB1dFdpZGdldFNlbGVjdG9yKTsKCgovKioKICogQHdvcmtJblByb2dyZXNzCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgYW5ndWxhci5kaXJlY3RpdmUubmc6b3B0aW9ucwogKgogKiBAZGVzY3JpcHRpb24KICogRHluYW1pY2FsbHkgZ2VuZXJhdGUgYSBsaXN0IG9mIGA8b3B0aW9uPmAgZWxlbWVudHMgZm9yIGEgYDxzZWxlY3Q+YCBlbGVtZW50IHVzaW5nIGFuIGFycmF5IG9yCiAqIGFuIG9iamVjdCBvYnRhaW5lZCBieSBldmFsdWF0aW5nIHRoZSBgbmc6b3B0aW9uc2AgZXhwcmVzc2lvbi4KICoKICogV2hlbiBhbiBpdGVtIGluIHRoZSBzZWxlY3QgbWVudSBpcyBzZWxlY3QsIHRoZSB2YWx1ZSBvZiBhcnJheSBlbGVtZW50IG9yIG9iamVjdCBwcm9wZXJ0eQogKiByZXByZXNlbnRlZCBieSB0aGUgc2VsZWN0ZWQgb3B0aW9uIHdpbGwgYmUgYm91bmQgdG8gdGhlIG1vZGVsIGlkZW50aWZpZWQgYnkgdGhlIGBuYW1lYCBhdHRyaWJ1dGUKICogb2YgdGhlIHBhcmVudCBzZWxlY3QgZWxlbWVudC4KICoKICogT3B0aW9uYWxseSwgYSBzaW5nbGUgaGFyZC1jb2RlZCBgPG9wdGlvbj5gIGVsZW1lbnQsIHdpdGggdGhlIHZhbHVlIHNldCB0byBhbiBlbXB0eSBzdHJpbmcsIGNhbgogKiBiZSBuZXN0ZWQgaW50byB0aGUgYDxzZWxlY3Q+YCBlbGVtZW50LiBUaGlzIGVsZW1lbnQgd2lsbCB0aGVuIHJlcHJlc2VudCBgbnVsbGAgb3IgIm5vdCBzZWxlY3RlZCIKICogb3B0aW9uLiBTZWUgZXhhbXBsZSBiZWxvdyBmb3IgZGVtb25zdHJhdGlvbi4KICoKICogTm90ZTogYG5nOm9wdGlvbnNgIHByb3ZpZGVzIGl0ZXJhdG9yIGZhY2lsaXR5IGZvciBgPG9wdGlvbj5gIGVsZW1lbnQgd2hpY2ggbXVzdCBiZSB1c2VkIGluc3RlYWQKICogb2Yge0BsaW5rIGFuZ3VsYXIud2lkZ2V0LkBuZzpyZXBlYXQgbmc6cmVwZWF0fS4gYG5nOnJlcGVhdGAgaXMgbm90IHN1aXRhYmxlIGZvciB1c2Ugd2l0aAogKiBgPG9wdGlvbj5gIGVsZW1lbnQgYmVjYXVzZSBvZiB0aGUgZm9sbG93aW5nIHJlYXNvbnM6CiAqCiAqICAgKiB2YWx1ZSBhdHRyaWJ1dGUgb2YgdGhlIG9wdGlvbiBlbGVtZW50IHRoYXQgd2UgbmVlZCB0byBiaW5kIHRvIHJlcXVpcmVzIGEgc3RyaW5nLCBidXQgdGhlCiAqICAgICBzb3VyY2Ugb2YgZGF0YSBmb3IgdGhlIGl0ZXJhdGlvbiBtaWdodCBiZSBpbiBhIGZvcm0gb2YgYXJyYXkgY29udGFpbmluZyBvYmplY3RzIGluc3RlYWQgb2YKICogICAgIHN0cmluZ3MKICogICAqIHtAbGluayBhbmd1bGFyLndpZGdldC5Abmc6cmVwZWF0IG5nOnJlcGVhdH0gdW5yb2xscyBhZnRlciB0aGUgc2VsZWN0IGJpbmRzIGNhdXNpbmcKICogICAgIGluY29yZWN0IHJlbmRlcmluZyBvbiBtb3N0IGJyb3dzZXJzLgogKiAgICogYmluZGluZyB0byBhIHZhbHVlIG5vdCBpbiBsaXN0IGNvbmZ1c2VzIG1vc3QgYnJvd3NlcnMuCiAqCiAqIEBlbGVtZW50IHNlbGVjdAogKiBAcGFyYW0ge2NvbXByZWhlbnNpb25fZXhwcmVzc2lvbn0gY29tcHJlaGVuc2lvbiBpbiBvbmUgb2YgdGhlIGZvbGxvd2luZyBmb3JtczoKICoKICogICAqIGZvciBhcnJheSBkYXRhIHNvdXJjZXM6CiAqICAgICAqIGBsYWJlbGAgKipgZm9yYCoqIGB2YWx1ZWAgKipgaW5gKiogYGFycmF5YAogKiAgICAgKiBgc2VsZWN0YCAqKmBhc2AqKiBgbGFiZWxgICoqYGZvcmAqKiBgdmFsdWVgICoqYGluYCoqIGBhcnJheWAKICogICAgICogYGxhYmVsYCAgKipgZ3JvdXAgYnlgKiogYGdyb3VwYCAqKmBmb3JgKiogYHZhbHVlYCAqKmBpbmAqKiBgYXJyYXlgCiAqICAgICAqIGBzZWxlY3RgICoqYGFzYCoqIGBsYWJlbGAgKipgZ3JvdXAgYnlgKiogYGdyb3VwYCAqKmBmb3JgKiogYHZhbHVlYCAqKmBpbmAqKiBgYXJyYXlgCiAqICAgKiBmb3Igb2JqZWN0IGRhdGEgc291cmNlczoKICogICAgICogYGxhYmVsYCAqKmBmb3IgKGAqKmBrZXlgICoqYCxgKiogYHZhbHVlYCoqYCkgaW5gKiogYG9iamVjdGAKICogICAgICogYHNlbGVjdGAgKipgYXNgKiogYGxhYmVsYCAqKmBmb3IgKGAqKmBrZXlgICoqYCxgKiogYHZhbHVlYCoqYCkgaW5gKiogYG9iamVjdGAKICogICAgICogYGxhYmVsYCAqKmBncm91cCBieWAqKiBgZ3JvdXBgICoqYGZvciAoYCoqYGtleWAqKmAsYCoqIGB2YWx1ZWAqKmApIGluYCoqIGBvYmplY3RgCiAqICAgICAqIGBzZWxlY3RgICoqYGFzYCoqIGBsYWJlbGAgKipgZ3JvdXAgYnlgKiogYGdyb3VwYAogKiAgICAgICAgICoqYGZvcmAgYChgKipga2V5YCoqYCxgKiogYHZhbHVlYCoqYCkgaW5gKiogYG9iamVjdGAKICoKICogV2hlcmU6CiAqCiAqICAgKiBgYXJyYXlgIC8gYG9iamVjdGA6IGFuIGV4cHJlc3Npb24gd2hpY2ggZXZhbHVhdGVzIHRvIGFuIGFycmF5IC8gb2JqZWN0IHRvIGl0ZXJhdGUgb3Zlci4KICogICAqIGB2YWx1ZWA6IGxvY2FsIHZhcmlhYmxlIHdoaWNoIHdpbGwgcmVmZXIgdG8gZWFjaCBpdGVtIGluIHRoZSBgYXJyYXlgIG9yIGVhY2ggcHJvcGVydHkgdmFsdWUKICogICAgICBvZiBgb2JqZWN0YCBkdXJpbmcgaXRlcmF0aW9uLgogKiAgICogYGtleWA6IGxvY2FsIHZhcmlhYmxlIHdoaWNoIHdpbGwgcmVmZXIgdG8gYSBwcm9wZXJ0eSBuYW1lIGluIGBvYmplY3RgIGR1cmluZyBpdGVyYXRpb24uCiAqICAgKiBgbGFiZWxgOiBUaGUgcmVzdWx0IG9mIHRoaXMgZXhwcmVzc2lvbiB3aWxsIGJlIHRoZSBsYWJlbCBmb3IgYDxvcHRpb24+YCBlbGVtZW50LiBUaGUKICogICAgIGBleHByZXNzaW9uYCB3aWxsIG1vc3QgbGlrZWx5IHJlZmVyIHRvIHRoZSBgdmFsdWVgIHZhcmlhYmxlIChlLmcuIGB2YWx1ZS5wcm9wZXJ0eU5hbWVgKS4KICogICAqIGBzZWxlY3RgOiBUaGUgcmVzdWx0IG9mIHRoaXMgZXhwcmVzc2lvbiB3aWxsIGJlIGJvdW5kIHRvIHRoZSBtb2RlbCBvZiB0aGUgcGFyZW50IGA8c2VsZWN0PmAKICogICAgICBlbGVtZW50LiBJZiBub3Qgc3BlY2lmaWVkLCBgc2VsZWN0YCBleHByZXNzaW9uIHdpbGwgZGVmYXVsdCB0byBgdmFsdWVgLgogKiAgICogYGdyb3VwYDogVGhlIHJlc3VsdCBvZiB0aGlzIGV4cHJlc3Npb24gd2lsbCBiZSB1c2VkIHRvIGdyb3VwIG9wdGlvbnMgdXNpbmcgdGhlIGA8b3B0Z3JvdXA+YAogKiAgICAgIERPTSBlbGVtZW50LgogKgogKiBAZXhhbXBsZQogICAgPGRvYzpleGFtcGxlPgogICAgICA8ZG9jOnNvdXJjZT4KICAgICAgICA8c2NyaXB0PgogICAgICAgIGZ1bmN0aW9uIE15Q250cmwoKXsKICAgICAgICAgIHRoaXMuY29sb3JzID0gWwogICAgICAgICAgICB7bmFtZTonYmxhY2snLCBzaGFkZTonZGFyayd9LAogICAgICAgICAgICB7bmFtZTond2hpdGUnLCBzaGFkZTonbGlnaHQnfSwKICAgICAgICAgICAge25hbWU6J3JlZCcsIHNoYWRlOidkYXJrJ30sCiAgICAgICAgICAgIHtuYW1lOidibHVlJywgc2hhZGU6J2RhcmsnfSwKICAgICAgICAgICAge25hbWU6J3llbGxvdycsIHNoYWRlOidsaWdodCd9CiAgICAgICAgICBdOwogICAgICAgICAgdGhpcy5jb2xvciA9IHRoaXMuY29sb3JzWzJdOyAvLyByZWQKICAgICAgICB9CiAgICAgICAgPC9zY3JpcHQ+CiAgICAgICAgPGRpdiBuZzpjb250cm9sbGVyPSJNeUNudHJsIj4KICAgICAgICAgIDx1bD4KICAgICAgICAgICAgPGxpIG5nOnJlcGVhdD0iY29sb3IgaW4gY29sb3JzIj4KICAgICAgICAgICAgICBOYW1lOiA8aW5wdXQgbmFtZT0iY29sb3IubmFtZSI+CiAgICAgICAgICAgICAgWzxhIGhyZWYgbmc6Y2xpY2s9ImNvbG9ycy4kcmVtb3ZlKGNvbG9yKSI+WDwvYT5dCiAgICAgICAgICAgIDwvbGk+CiAgICAgICAgICAgIDxsaT4KICAgICAgICAgICAgICBbPGEgaHJlZiBuZzpjbGljaz0iY29sb3JzLnB1c2goe30pIj5hZGQ8L2E+XQogICAgICAgICAgICA8L2xpPgogICAgICAgICAgPC91bD4KICAgICAgICAgIDxoci8+CiAgICAgICAgICBDb2xvciAobnVsbCBub3QgYWxsb3dlZCk6CiAgICAgICAgICA8c2VsZWN0IG5hbWU9ImNvbG9yIiBuZzpvcHRpb25zPSJjLm5hbWUgZm9yIGMgaW4gY29sb3JzIj48L3NlbGVjdD48YnI+CgogICAgICAgICAgQ29sb3IgKG51bGwgYWxsb3dlZCk6CiAgICAgICAgICA8ZGl2ICBjbGFzcz0ibnVsbGFibGUiPgogICAgICAgICAgICA8c2VsZWN0IG5hbWU9ImNvbG9yIiBuZzpvcHRpb25zPSJjLm5hbWUgZm9yIGMgaW4gY29sb3JzIj4KICAgICAgICAgICAgICA8b3B0aW9uIHZhbHVlPSIiPi0tIGNob3NlIGNvbG9yIC0tPC9vcHRpb24+CiAgICAgICAgICAgIDwvc2VsZWN0PgogICAgICAgICAgPC9kaXY+PGJyLz4KCiAgICAgICAgICBDb2xvciBncm91cGVkIGJ5IHNoYWRlOgogICAgICAgICAgPHNlbGVjdCBuYW1lPSJjb2xvciIgbmc6b3B0aW9ucz0iYy5uYW1lIGdyb3VwIGJ5IGMuc2hhZGUgZm9yIGMgaW4gY29sb3JzIj4KICAgICAgICAgIDwvc2VsZWN0Pjxici8+CgoKICAgICAgICAgIFNlbGVjdCA8YSBocmVmIG5nOmNsaWNrPSJjb2xvcj17bmFtZTonbm90IGluIGxpc3QnfSI+Ym9ndXM8L2E+Ljxicj4KICAgICAgICAgIDxoci8+CiAgICAgICAgICBDdXJyZW50bHkgc2VsZWN0ZWQ6IHt7IHtzZWxlY3RlZF9jb2xvcjpjb2xvcn0gIH19CiAgICAgICAgICA8ZGl2IHN0eWxlPSJib3JkZXI6c29saWQgMXB4IGJsYWNrOyBoZWlnaHQ6MjBweCIKICAgICAgICAgICAgICAgbmc6c3R5bGU9InsnYmFja2dyb3VuZC1jb2xvcic6Y29sb3IubmFtZX0iPgogICAgICAgICAgPC9kaXY+CiAgICAgICAgPC9kaXY+CiAgICAgIDwvZG9jOnNvdXJjZT4KICAgICAgPGRvYzpzY2VuYXJpbz4KICAgICAgICAgaXQoJ3Nob3VsZCBjaGVjayBuZzpvcHRpb25zJywgZnVuY3Rpb24oKXsKICAgICAgICAgICBleHBlY3QoYmluZGluZygnY29sb3InKSkudG9NYXRjaCgncmVkJyk7CiAgICAgICAgICAgc2VsZWN0KCdjb2xvcicpLm9wdGlvbignMCcpOwogICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdjb2xvcicpKS50b01hdGNoKCdibGFjaycpOwogICAgICAgICAgIHVzaW5nKCcubnVsbGFibGUnKS5zZWxlY3QoJ2NvbG9yJykub3B0aW9uKCcnKTsKICAgICAgICAgICBleHBlY3QoYmluZGluZygnY29sb3InKSkudG9NYXRjaCgnbnVsbCcpOwogICAgICAgICB9KTsKICAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICA8L2RvYzpleGFtcGxlPgogKi8KLy8gICAgICAgICAgICAgICAgICAgICAgIDAwMDAxMTExMTAwMDAwMDAwMDAwMjIyMjAwMDAwMDAwMDAwMDAwMDAwMDAwMDAzMzMzMDAwMDAwMDAwMDAwMDQ0NDQ0NDQ0NDQ0NDQ0NDQ0MDAwMDAwMDAwNTU1NTU1NTU1NTU1NTU1NTUwMDAwMDAwNjY2NjY2NjY2NjY2NjY2NjYwMDAwMDAwMDAwMDAwMDA3Nzc3CnZhciBOR19PUFRJT05TX1JFR0VYUCA9IC9eXHMqKC4qPykoPzpccythc1xzKyguKj8pKT8oPzpccytncm91cFxzK2J5XHMrKC4qKSk/XHMrZm9yXHMrKD86KFtcJFx3XVtcJFx3XGRdKil8KD86XChccyooW1wkXHddW1wkXHdcZF0qKVxzKixccyooW1wkXHddW1wkXHdcZF0qKVxzKlwpKSlccytpblxzKyguKikkLzsKYW5ndWxhcldpZGdldCgnc2VsZWN0JywgZnVuY3Rpb24oZWxlbWVudCl7CiAgdGhpcy5kZXNjZW5kKHRydWUpOwogIHRoaXMuZGlyZWN0aXZlcyh0cnVlKTsKCiAgdmFyIGlzTXVsdGlzZWxlY3QgPSBlbGVtZW50LmF0dHIoJ211bHRpcGxlJyksCiAgICAgIGV4cHJlc3Npb24gPSBlbGVtZW50LmF0dHIoJ25nOm9wdGlvbnMnKSwKICAgICAgb25DaGFuZ2UgPSBleHByZXNzaW9uQ29tcGlsZShlbGVtZW50LmF0dHIoJ25nOmNoYW5nZScpIHx8ICIiKS5mblNlbGYsCiAgICAgIG1hdGNoOwoKICBpZiAoIWV4cHJlc3Npb24pIHsKICAgIHJldHVybiBpbnB1dFdpZGdldFNlbGVjdG9yLmNhbGwodGhpcywgZWxlbWVudCk7CiAgfQogIGlmICghIChtYXRjaCA9IGV4cHJlc3Npb24ubWF0Y2goTkdfT1BUSU9OU19SRUdFWFApKSkgewogICAgdGhyb3cgRXJyb3IoCiAgICAgICJFeHBlY3RlZCBuZzpvcHRpb25zIGluIGZvcm0gb2YgJ19zZWxlY3RfIChhcyBfbGFiZWxfKT8gZm9yIChfa2V5XywpP192YWx1ZV8gaW4gX2NvbGxlY3Rpb25fJyIgKwogICAgICAiIGJ1dCBnb3QgJyIgKyBleHByZXNzaW9uICsgIicuIik7CiAgfQoKICB2YXIgZGlzcGxheUZuID0gZXhwcmVzc2lvbkNvbXBpbGUobWF0Y2hbMl0gfHwgbWF0Y2hbMV0pLmZuU2VsZiwKICAgICAgdmFsdWVOYW1lID0gbWF0Y2hbNF0gfHwgbWF0Y2hbNl0sCiAgICAgIGtleU5hbWUgPSBtYXRjaFs1XSwKICAgICAgZ3JvdXBCeUZuID0gZXhwcmVzc2lvbkNvbXBpbGUobWF0Y2hbM10gfHwgJycpLmZuU2VsZiwKICAgICAgdmFsdWVGbiA9IGV4cHJlc3Npb25Db21waWxlKG1hdGNoWzJdID8gbWF0Y2hbMV0gOiB2YWx1ZU5hbWUpLmZuU2VsZiwKICAgICAgdmFsdWVzRm4gPSBleHByZXNzaW9uQ29tcGlsZShtYXRjaFs3XSkuZm5TZWxmLAogICAgICAvLyB3ZSBjYW4ndCBqdXN0IGpxTGl0ZSgnPG9wdGlvbj4nKSBzaW5jZSBqcUxpdGUgaXMgbm90IHNtYXJ0IGVub3VnaAogICAgICAvLyB0byBjcmVhdGUgaXQgaW4gPHNlbGVjdD4gYW5kIElFIGJhcmZzIG90aGVyd2lzZS4KICAgICAgb3B0aW9uVGVtcGxhdGUgPSBqcUxpdGUoZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnb3B0aW9uJykpLAogICAgICBvcHRHcm91cFRlbXBsYXRlID0ganFMaXRlKGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ29wdGdyb3VwJykpLAogICAgICBudWxsT3B0aW9uID0gZmFsc2U7IC8vIGlmIGZhbHNlIHRoZW4gdXNlciB3aWxsIG5vdCBiZSBhYmxlIHRvIHNlbGVjdCBpdAoKICByZXR1cm4gZnVuY3Rpb24oc2VsZWN0RWxlbWVudCl7CgogICAgLy8gVGhpcyBpcyBhbiBhcnJheSBvZiBhcnJheSBvZiBleGlzdGluZyBvcHRpb24gZ3JvdXBzIGluIERPTS4gV2UgdHJ5IHRvIHJldXNlIHRoZXNlIGlmIHBvc3NpYmxlCiAgICAvLyBvcHRpb25Hcm91cHNDYWNoZVswXSBpcyB0aGUgb3B0aW9ucyB3aXRoIG5vIG9wdGlvbiBncm91cAogICAgLy8gb3B0aW9uR3JvdXBzQ2FjaGVbP11bMF0gaXMgdGhlIHBhcmVudDogZWl0aGVyIHRoZSBTRUxFQ1Qgb3IgT1BUR1JPVVAgZWxlbWVudAogICAgdmFyIG9wdGlvbkdyb3Vwc0NhY2hlID0gW1t7ZWxlbWVudDogc2VsZWN0RWxlbWVudCwgbGFiZWw6Jyd9XV0sCiAgICAgICAgc2NvcGUgPSB0aGlzLAogICAgICAgIG1vZGVsID0gbW9kZWxBY2Nlc3NvcihzY29wZSwgZWxlbWVudCk7CgogICAgLy8gZmluZCBleGlzdGluZyBzcGVjaWFsIG9wdGlvbnMKICAgIGZvckVhY2goc2VsZWN0RWxlbWVudC5jaGlsZHJlbigpLCBmdW5jdGlvbihvcHRpb24pewogICAgICBpZiAob3B0aW9uLnZhbHVlID09ICcnKQogICAgICAgIC8vIFVzZXIgaXMgYWxsb3dlZCB0byBzZWxlY3QgdGhlIG51bGwuCiAgICAgICAgbnVsbE9wdGlvbiA9IHtsYWJlbDpqcUxpdGUob3B0aW9uKS50ZXh0KCksIGlkOicnfTsKICAgIH0pOwogICAgc2VsZWN0RWxlbWVudC5odG1sKCcnKTsgLy8gY2xlYXIgY29udGVudHMKCiAgICBzZWxlY3RFbGVtZW50LmJpbmQoJ2NoYW5nZScsIGZ1bmN0aW9uKCl7CiAgICAgIHZhciBvcHRpb25Hcm91cCwKICAgICAgICAgIGNvbGxlY3Rpb24gPSB2YWx1ZXNGbihzY29wZSkgfHwgW10sCiAgICAgICAgICBrZXkgPSBzZWxlY3RFbGVtZW50LnZhbCgpLAogICAgICAgICAgdGVtcFNjb3BlID0gaW5oZXJpdChzY29wZSksCiAgICAgICAgICB2YWx1ZSwgb3B0aW9uRWxlbWVudCwgaW5kZXgsIGdyb3VwSW5kZXgsIGxlbmd0aCwgZ3JvdXBMZW5ndGg7CgogICAgICB0cnkgewogICAgICAgIGlmIChpc011bHRpc2VsZWN0KSB7CiAgICAgICAgICB2YWx1ZSA9IFtdOwogICAgICAgICAgZm9yIChncm91cEluZGV4ID0gMCwgZ3JvdXBMZW5ndGggPSBvcHRpb25Hcm91cHNDYWNoZS5sZW5ndGg7CiAgICAgICAgICAgICAgIGdyb3VwSW5kZXggPCBncm91cExlbmd0aDsKICAgICAgICAgICAgICAgZ3JvdXBJbmRleCsrKSB7CiAgICAgICAgICAgIC8vIGxpc3Qgb2Ygb3B0aW9ucyBmb3IgdGhhdCBncm91cC4gKGZpcnN0IGl0ZW0gaGFzIHRoZSBwYXJlbnQpCiAgICAgICAgICAgIG9wdGlvbkdyb3VwID0gb3B0aW9uR3JvdXBzQ2FjaGVbZ3JvdXBJbmRleF07CgogICAgICAgICAgICBmb3IoaW5kZXggPSAxLCBsZW5ndGggPSBvcHRpb25Hcm91cC5sZW5ndGg7IGluZGV4IDwgbGVuZ3RoOyBpbmRleCsrKSB7CiAgICAgICAgICAgICAgaWYgKChvcHRpb25FbGVtZW50ID0gb3B0aW9uR3JvdXBbaW5kZXhdLmVsZW1lbnQpWzBdLnNlbGVjdGVkKSB7CiAgICAgICAgICAgICAgICBpZiAoa2V5TmFtZSkgdGVtcFNjb3BlW2tleU5hbWVdID0ga2V5OwogICAgICAgICAgICAgICAgdGVtcFNjb3BlW3ZhbHVlTmFtZV0gPSBjb2xsZWN0aW9uW29wdGlvbkVsZW1lbnQudmFsKCldOwogICAgICAgICAgICAgICAgdmFsdWUucHVzaCh2YWx1ZUZuKHRlbXBTY29wZSkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZiAoa2V5ID09ICc/JykgewogICAgICAgICAgICB2YWx1ZSA9IHVuZGVmaW5lZDsKICAgICAgICAgIH0gZWxzZSBpZiAoa2V5ID09ICcnKXsKICAgICAgICAgICAgdmFsdWUgPSBudWxsOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGVtcFNjb3BlW3ZhbHVlTmFtZV0gPSBjb2xsZWN0aW9uW2tleV07CiAgICAgICAgICAgIGlmIChrZXlOYW1lKSB0ZW1wU2NvcGVba2V5TmFtZV0gPSBrZXk7CiAgICAgICAgICAgIHZhbHVlID0gdmFsdWVGbih0ZW1wU2NvcGUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoaXNEZWZpbmVkKHZhbHVlKSAmJiBtb2RlbC5nZXQoKSAhPT0gdmFsdWUpIHsKICAgICAgICAgIG9uQ2hhbmdlKHNjb3BlKTsKICAgICAgICAgIG1vZGVsLnNldCh2YWx1ZSk7CiAgICAgICAgfQogICAgICAgIHNjb3BlLiR0cnlFdmFsKGZ1bmN0aW9uKCl7CiAgICAgICAgICBzY29wZS4kcm9vdC4kZXZhbCgpOwogICAgICAgIH0pOwogICAgICB9IGZpbmFsbHkgewogICAgICAgIHRlbXBTY29wZSA9IG51bGw7IC8vIFRPRE8obWlza28pOiBuZWVkcyB0byBiZSAkZGVzdHJveQogICAgICB9CiAgICB9KTsKCiAgICBzY29wZS4kb25FdmFsKGZ1bmN0aW9uKCl7CiAgICAgIHZhciBzY29wZSA9IHRoaXMsCiAgICAgICAgICBvcHRpb25Hcm91cHMgPSB7Jyc6W119LCAvLyBUZW1wb3JhcnkgbG9jYXRpb24gZm9yIHRoZSBvcHRpb24gZ3JvdXBzIGJlZm9yZSB3ZSByZW5kZXIgdGhlbQogICAgICAgICAgb3B0aW9uR3JvdXBOYW1lcyA9IFsnJ10sCiAgICAgICAgICBvcHRpb25Hcm91cE5hbWUsCiAgICAgICAgICBvcHRpb25Hcm91cCwKICAgICAgICAgIG9wdGlvbiwKICAgICAgICAgIGV4aXN0aW5nUGFyZW50LCBleGlzdGluZ09wdGlvbnMsIGV4aXN0aW5nT3B0aW9uLAogICAgICAgICAgdmFsdWVzID0gdmFsdWVzRm4oc2NvcGUpIHx8IFtdLAogICAgICAgICAga2V5cyA9IHZhbHVlcywKICAgICAgICAgIGtleSwKICAgICAgICAgIGdyb3VwTGVuZ3RoLCBsZW5ndGgsCiAgICAgICAgICBmcmFnbWVudCwKICAgICAgICAgIGdyb3VwSW5kZXgsIGluZGV4LAogICAgICAgICAgb3B0aW9uRWxlbWVudCwKICAgICAgICAgIG9wdGlvblNjb3BlID0gaW5oZXJpdChzY29wZSksCiAgICAgICAgICBtb2RlbFZhbHVlID0gbW9kZWwuZ2V0KCksCiAgICAgICAgICBzZWxlY3RlZCwKICAgICAgICAgIHNlbGVjdGVkU2V0ID0gZmFsc2UsIC8vIG5vdGhpbmcgaXMgc2VsZWN0ZWQgeWV0CiAgICAgICAgICBpc011bHRpID0gaXNNdWx0aXNlbGVjdCwKICAgICAgICAgIGxhc3RFbGVtZW50LAogICAgICAgICAgZWxlbWVudDsKCiAgICAgIHRyeSB7CiAgICAgICAgaWYgKGlzTXVsdGkpIHsKICAgICAgICAgIHNlbGVjdGVkU2V0ID0gbmV3IEhhc2hNYXAoKTsKICAgICAgICAgIGlmIChtb2RlbFZhbHVlICYmIGlzTnVtYmVyKGxlbmd0aCA9IG1vZGVsVmFsdWUubGVuZ3RoKSkgewogICAgICAgICAgICBmb3IgKGluZGV4ID0gMDsgaW5kZXggPCBsZW5ndGg7IGluZGV4KyspIHsKICAgICAgICAgICAgICBzZWxlY3RlZFNldC5wdXQobW9kZWxWYWx1ZVtpbmRleF0sIHRydWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmIChtb2RlbFZhbHVlID09PSBudWxsIHx8IG51bGxPcHRpb24pIHsKICAgICAgICAgIC8vIGlmIHdlIGFyZSBub3QgbXVsdGlzZWxlY3QsIGFuZCB3ZSBhcmUgbnVsbCB0aGVuIHdlIGhhdmUgdG8gYWRkIHRoZSBudWxsT3B0aW9uCiAgICAgICAgICBvcHRpb25Hcm91cHNbJyddLnB1c2goZXh0ZW5kKHtzZWxlY3RlZDptb2RlbFZhbHVlID09PSBudWxsLCBpZDonJywgbGFiZWw6Jyd9LCBudWxsT3B0aW9uKSk7CiAgICAgICAgICBzZWxlY3RlZFNldCA9IHRydWU7CiAgICAgICAgfQoKICAgICAgICAvLyBJZiB3ZSBoYXZlIGEga2V5TmFtZSB0aGVuIHdlIGFyZSBpdGVyYXRpbmcgb3ZlciBvbiBvYmplY3QuIEdyYWIgdGhlIGtleXMgYW5kIHNvcnQgdGhlbS4KICAgICAgICBpZihrZXlOYW1lKSB7CiAgICAgICAgICBrZXlzID0gW107CiAgICAgICAgICBmb3IgKGtleSBpbiB2YWx1ZXMpIHsKICAgICAgICAgICAgaWYgKHZhbHVlcy5oYXNPd25Qcm9wZXJ0eShrZXkpKQogICAgICAgICAgICAgIGtleXMucHVzaChrZXkpOwogICAgICAgICAgfQogICAgICAgICAga2V5cy5zb3J0KCk7CiAgICAgICAgfQoKICAgICAgICAvLyBXZSBub3cgYnVpbGQgdXAgdGhlIGxpc3Qgb2Ygb3B0aW9ucyB3ZSBuZWVkICh3ZSBtZXJnZSBsYXRlcikKICAgICAgICBmb3IgKGluZGV4ID0gMDsgbGVuZ3RoID0ga2V5cy5sZW5ndGgsIGluZGV4IDwgbGVuZ3RoOyBpbmRleCsrKSB7CiAgICAgICAgICBvcHRpb25TY29wZVt2YWx1ZU5hbWVdID0gdmFsdWVzW2tleU5hbWUgPyBvcHRpb25TY29wZVtrZXlOYW1lXT1rZXlzW2luZGV4XTppbmRleF07CiAgICAgICAgICBvcHRpb25Hcm91cE5hbWUgPSBncm91cEJ5Rm4ob3B0aW9uU2NvcGUpIHx8ICcnOwogICAgICAgICAgaWYgKCEob3B0aW9uR3JvdXAgPSBvcHRpb25Hcm91cHNbb3B0aW9uR3JvdXBOYW1lXSkpIHsKICAgICAgICAgICAgb3B0aW9uR3JvdXAgPSBvcHRpb25Hcm91cHNbb3B0aW9uR3JvdXBOYW1lXSA9IFtdOwogICAgICAgICAgICBvcHRpb25Hcm91cE5hbWVzLnB1c2gob3B0aW9uR3JvdXBOYW1lKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChpc011bHRpKSB7CiAgICAgICAgICAgIHNlbGVjdGVkID0gISFzZWxlY3RlZFNldC5yZW1vdmUodmFsdWVGbihvcHRpb25TY29wZSkpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc2VsZWN0ZWQgPSBtb2RlbFZhbHVlID09PSB2YWx1ZUZuKG9wdGlvblNjb3BlKTsKICAgICAgICAgICAgc2VsZWN0ZWRTZXQgPSBzZWxlY3RlZFNldCB8fCBzZWxlY3RlZDsgLy8gc2VlIGlmIGF0IGxlYXN0IG9uZSBpdGVtIGlzIHNlbGVjdGVkCiAgICAgICAgICB9CiAgICAgICAgICBvcHRpb25Hcm91cC5wdXNoKHsKICAgICAgICAgICAgICBpZDoga2V5TmFtZSA/IGtleXNbaW5kZXhdIDogaW5kZXgsICAgLy8gZWl0aGVyIHRoZSBpbmRleCBpbnRvIGFycmF5IG9yIGtleSBmcm9tIG9iamVjdAogICAgICAgICAgICAgIGxhYmVsOiBkaXNwbGF5Rm4ob3B0aW9uU2NvcGUpIHx8ICcnLCAvLyB3aGF0IHdpbGwgYmUgc2VlbiBieSB0aGUgdXNlcgogICAgICAgICAgICAgIHNlbGVjdGVkOiBzZWxlY3RlZCAgICAgICAgICAgICAgICAgICAvLyBkZXRlcm1pbmUgaWYgd2Ugc2hvdWxkIGJlIHNlbGVjdGVkCiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBvcHRpb25Hcm91cE5hbWVzLnNvcnQoKTsKICAgICAgICBpZiAoIWlzTXVsdGkgJiYgIXNlbGVjdGVkU2V0KSB7CiAgICAgICAgICAvLyBub3RoaW5nIHdhcyBzZWxlY3RlZCwgd2UgaGF2ZSB0byBpbnNlcnQgdGhlIHVuZGVmaW5lZCBpdGVtCiAgICAgICAgICBvcHRpb25Hcm91cHNbJyddLnVuc2hpZnQoe2lkOic/JywgbGFiZWw6JycsIHNlbGVjdGVkOnRydWV9KTsKICAgICAgICB9CgogICAgICAgIC8vIE5vdyB3ZSBuZWVkIHRvIHVwZGF0ZSB0aGUgbGlzdCBvZiBET00gbm9kZXMgdG8gbWF0Y2ggdGhlIG9wdGlvbkdyb3VwcyB3ZSBjb21wdXRlZCBhYm92ZQogICAgICAgIGZvciAoZ3JvdXBJbmRleCA9IDAsIGdyb3VwTGVuZ3RoID0gb3B0aW9uR3JvdXBOYW1lcy5sZW5ndGg7CiAgICAgICAgICAgICBncm91cEluZGV4IDwgZ3JvdXBMZW5ndGg7CiAgICAgICAgICAgICBncm91cEluZGV4KyspIHsKICAgICAgICAgIC8vIGN1cnJlbnQgb3B0aW9uIGdyb3VwIG5hbWUgb3IgJycgaWYgbm8gZ3JvdXAKICAgICAgICAgIG9wdGlvbkdyb3VwTmFtZSA9IG9wdGlvbkdyb3VwTmFtZXNbZ3JvdXBJbmRleF07CgogICAgICAgICAgLy8gbGlzdCBvZiBvcHRpb25zIGZvciB0aGF0IGdyb3VwLiAoZmlyc3QgaXRlbSBoYXMgdGhlIHBhcmVudCkKICAgICAgICAgIG9wdGlvbkdyb3VwID0gb3B0aW9uR3JvdXBzW29wdGlvbkdyb3VwTmFtZV07CgogICAgICAgICAgaWYgKG9wdGlvbkdyb3Vwc0NhY2hlLmxlbmd0aCA8PSBncm91cEluZGV4KSB7CiAgICAgICAgICAgIC8vIHdlIG5lZWQgdG8gZ3JvdyB0aGUgb3B0aW9uR3JvdXBzCiAgICAgICAgICAgIG9wdGlvbkdyb3Vwc0NhY2hlLnB1c2goCiAgICAgICAgICAgICAgICBleGlzdGluZ09wdGlvbnMgPSBbCiAgICAgICAgICAgICAgICAgIGV4aXN0aW5nUGFyZW50ID0gewogICAgICAgICAgICAgICAgICAgICAgZWxlbWVudDogb3B0R3JvdXBUZW1wbGF0ZS5jbG9uZSgpLmF0dHIoJ2xhYmVsJywgb3B0aW9uR3JvdXBOYW1lKSwKICAgICAgICAgICAgICAgICAgICAgIGxhYmVsOiBvcHRpb25Hcm91cC5sYWJlbAogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIF0KICAgICAgICAgICAgKTsKICAgICAgICAgICAgc2VsZWN0RWxlbWVudC5hcHBlbmQoZXhpc3RpbmdQYXJlbnQuZWxlbWVudCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBleGlzdGluZ09wdGlvbnMgPSBvcHRpb25Hcm91cHNDYWNoZVtncm91cEluZGV4XTsKICAgICAgICAgICAgZXhpc3RpbmdQYXJlbnQgPSBleGlzdGluZ09wdGlvbnNbMF07ICAvLyBlaXRoZXIgU0VMRUNUIChubyBncm91cCkgb3IgT1BUR1JPVVAgZWxlbWVudAoKICAgICAgICAgICAgLy8gdXBkYXRlIHRoZSBPUFRHUk9VUCBsYWJlbCBpZiBub3QgdGhlIHNhbWUuCiAgICAgICAgICAgIGlmIChleGlzdGluZ1BhcmVudC5sYWJlbCAhPSBvcHRpb25Hcm91cE5hbWUpIHsKICAgICAgICAgICAgICBleGlzdGluZ1BhcmVudC5lbGVtZW50LmF0dHIoJ2xhYmVsJywgZXhpc3RpbmdQYXJlbnQubGFiZWwgPSBvcHRpb25Hcm91cE5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgbGFzdEVsZW1lbnQgPSBudWxsOyAgLy8gc3RhcnQgYXQgdGhlIGJlZ2luaW5nCiAgICAgICAgICBmb3IoaW5kZXggPSAwLCBsZW5ndGggPSBvcHRpb25Hcm91cC5sZW5ndGg7IGluZGV4IDwgbGVuZ3RoOyBpbmRleCsrKSB7CiAgICAgICAgICAgIG9wdGlvbiA9IG9wdGlvbkdyb3VwW2luZGV4XTsKICAgICAgICAgICAgaWYgKGV4aXN0aW5nT3B0aW9uID0gZXhpc3RpbmdPcHRpb25zW2luZGV4KzFdKSB7CiAgICAgICAgICAgICAgLy8gcmV1c2UgZWxlbWVudHMKICAgICAgICAgICAgICBsYXN0RWxlbWVudCA9IGV4aXN0aW5nT3B0aW9uLmVsZW1lbnQ7CiAgICAgICAgICAgICAgaWYgKGV4aXN0aW5nT3B0aW9uLmxhYmVsICE9PSBvcHRpb24ubGFiZWwpIHsKICAgICAgICAgICAgICAgIGxhc3RFbGVtZW50LnRleHQoZXhpc3RpbmdPcHRpb24ubGFiZWwgPSBvcHRpb24ubGFiZWwpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoZXhpc3RpbmdPcHRpb24uaWQgIT09IG9wdGlvbi5pZCkgewogICAgICAgICAgICAgICAgbGFzdEVsZW1lbnQudmFsKGV4aXN0aW5nT3B0aW9uLmlkID0gb3B0aW9uLmlkKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGV4aXN0aW5nT3B0aW9uLnNlbGVjdGVkICE9PSBvcHRpb24uc2VsZWN0ZWQpIHsKICAgICAgICAgICAgICAgIGxhc3RFbGVtZW50LmF0dHIoJ3NlbGVjdGVkJywgb3B0aW9uLnNlbGVjdGVkKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgLy8gZ3JvdyBlbGVtZW50cwogICAgICAgICAgICAgIC8vIGpRdWVyeSh2MS40LjIpIEJ1ZzogV2Ugc2hvdWxkIGJlIGFibGUgdG8gY2hhaW4gdGhlIG1ldGhvZCBjYWxscywgYnV0CiAgICAgICAgICAgICAgLy8gaW4gdGhpcyB2ZXJzaW9uIG9mIGpRdWVyeSBvbiBzb21lIGJyb3dzZXIgdGhlIC50ZXh0KCkgcmV0dXJucyBhIHN0cmluZwogICAgICAgICAgICAgIC8vIHJhdGhlciB0aGVuIHRoZSBlbGVtZW50LgogICAgICAgICAgICAgIChlbGVtZW50ID0gb3B0aW9uVGVtcGxhdGUuY2xvbmUoKSkKICAgICAgICAgICAgICAgIC52YWwob3B0aW9uLmlkKQogICAgICAgICAgICAgICAgLmF0dHIoJ3NlbGVjdGVkJywgb3B0aW9uLnNlbGVjdGVkKQogICAgICAgICAgICAgICAgLnRleHQob3B0aW9uLmxhYmVsKTsKICAgICAgICAgICAgICBleGlzdGluZ09wdGlvbnMucHVzaChleGlzdGluZ09wdGlvbiA9IHsKICAgICAgICAgICAgICAgIGVsZW1lbnQ6IGVsZW1lbnQsCiAgICAgICAgICAgICAgICBsYWJlbDogb3B0aW9uLmxhYmVsLAogICAgICAgICAgICAgICAgaWQ6IG9wdGlvbi5pZCwKICAgICAgICAgICAgICAgIGNoZWNrZWQ6IG9wdGlvbi5zZWxlY3RlZAogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIGlmIChsYXN0RWxlbWVudCkgewogICAgICAgICAgICAgICAgbGFzdEVsZW1lbnQuYWZ0ZXIoZWxlbWVudCk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGV4aXN0aW5nUGFyZW50LmVsZW1lbnQuYXBwZW5kKGVsZW1lbnQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBsYXN0RWxlbWVudCA9IGVsZW1lbnQ7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIC8vIHJlbW92ZSBhbnkgZXhjZXNzaXZlIE9QVElPTnMgaW4gYSBncm91cAogICAgICAgICAgaW5kZXgrKzsgLy8gaW5jcmVtZW50IHNpbmNlIHRoZSBleGlzdGluZ09wdGlvbnNbMF0gaXMgcGFyZW50IGVsZW1lbnQgbm90IE9QVElPTgogICAgICAgICAgd2hpbGUoZXhpc3RpbmdPcHRpb25zLmxlbmd0aCA+IGluZGV4KSB7CiAgICAgICAgICAgIGV4aXN0aW5nT3B0aW9ucy5wb3AoKS5lbGVtZW50LnJlbW92ZSgpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAvLyByZW1vdmUgYW55IGV4Y2Vzc2l2ZSBPUFRHUk9VUHMgZnJvbSBzZWxlY3QKICAgICAgICB3aGlsZShvcHRpb25Hcm91cHNDYWNoZS5sZW5ndGggPiBncm91cEluZGV4KSB7CiAgICAgICAgICBvcHRpb25Hcm91cHNDYWNoZS5wb3AoKVswXS5lbGVtZW50LnJlbW92ZSgpOwogICAgICAgIH0KICAgICAgfSBmaW5hbGx5IHsKICAgICAgICBvcHRpb25TY29wZSA9IG51bGw7IC8vIFRPRE8obWlza28pOiBuZWVkcyB0byBiZSAkZGVzdHJveSgpCiAgICAgIH0KICAgIH0pOwogIH07Cn0pOwoKCi8qKgogKiBAd29ya0luUHJvZ3Jlc3MKICogQG5nZG9jIHdpZGdldAogKiBAbmFtZSBhbmd1bGFyLndpZGdldC5uZzppbmNsdWRlCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBGZXRjaGVzLCBjb21waWxlcyBhbmQgaW5jbHVkZXMgYW4gZXh0ZXJuYWwgSFRNTCBmcmFnbWVudC4KICoKICogS2VlcCBpbiBtaW5kIHRoYXQgU2FtZSBPcmlnaW4gUG9saWN5IGFwcGxpZXMgdG8gaW5jbHVkZWQgcmVzb3VyY2VzCiAqIChlLmcuIG5nOmluY2x1ZGUgd29uJ3Qgd29yayBmb3IgZmlsZTovLyBhY2Nlc3MpLgogKgogKiBAcGFyYW0ge3N0cmluZ30gc3JjIGFuZ3VsYXIgZXhwcmVzc2lvbiBldmFsdWF0aW5nIHRvIFVSTC4gSWYgdGhlIHNvdXJjZSBpcyBhIHN0cmluZyBjb25zdGFudCwKICogICAgICAgICAgICAgICAgIG1ha2Ugc3VyZSB5b3Ugd3JhcCBpdCBpbiBxdW90ZXMsIGUuZy4gYHNyYz0iJ215UGFydGlhbFRlbXBsYXRlLmh0bWwnImAuCiAqIEBwYXJhbSB7U2NvcGU9fSBbc2NvcGU9bmV3X2NoaWxkX3Njb3BlXSBvcHRpb25hbCBleHByZXNzaW9uIHdoaWNoIGV2YWx1YXRlcyB0byBhbgogKiAgICAgICAgICAgICAgICAgaW5zdGFuY2Ugb2YgYW5ndWxhci5zY29wZSB0byBzZXQgdGhlIEhUTUwgZnJhZ21lbnQgdG8uCiAqIEBwYXJhbSB7c3RyaW5nPX0gb25sb2FkIEV4cHJlc3Npb24gdG8gZXZhbHVhdGUgd2hlbiBhIG5ldyBwYXJ0aWFsIGlzIGxvYWRlZC4KICoKICogQGV4YW1wbGUKICAgIDxkb2M6ZXhhbXBsZT4KICAgICAgPGRvYzpzb3VyY2UganNmaWRkbGU9ImZhbHNlIj4KICAgICAgIDxzZWxlY3QgbmFtZT0idXJsIj4KICAgICAgICA8b3B0aW9uIHZhbHVlPSJleGFtcGxlcy9uZy1pbmNsdWRlL3RlbXBsYXRlMS5odG1sIj50ZW1wbGF0ZTEuaHRtbDwvb3B0aW9uPgogICAgICAgIDxvcHRpb24gdmFsdWU9ImV4YW1wbGVzL25nLWluY2x1ZGUvdGVtcGxhdGUyLmh0bWwiPnRlbXBsYXRlMi5odG1sPC9vcHRpb24+CiAgICAgICAgPG9wdGlvbiB2YWx1ZT0iIj4oYmxhbmspPC9vcHRpb24+CiAgICAgICA8L3NlbGVjdD4KICAgICAgIHVybCBvZiB0aGUgdGVtcGxhdGU6IDx0dD48YSBocmVmPSJ7e3VybH19Ij57e3VybH19PC9hPjwvdHQ+CiAgICAgICA8aHIvPgogICAgICAgPG5nOmluY2x1ZGUgc3JjPSJ1cmwiPjwvbmc6aW5jbHVkZT4KICAgICAgPC9kb2M6c291cmNlPgogICAgICA8ZG9jOnNjZW5hcmlvPgogICAgICAgIGl0KCdzaG91bGQgbG9hZCB0ZW1wbGF0ZTEuaHRtbCcsIGZ1bmN0aW9uKCl7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBuZ1xcOmluY2x1ZGUnKS50ZXh0KCkpLgogICAgICAgICAgIHRvQmUoJ0NvbnRlbnQgb2YgdGVtcGxhdGUxLmh0bWxcbicpOwogICAgICAgIH0pOwogICAgICAgIGl0KCdzaG91bGQgbG9hZCB0ZW1wbGF0ZTIuaHRtbCcsIGZ1bmN0aW9uKCl7CiAgICAgICAgIHNlbGVjdCgndXJsJykub3B0aW9uKCdleGFtcGxlcy9uZy1pbmNsdWRlL3RlbXBsYXRlMi5odG1sJyk7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBuZ1xcOmluY2x1ZGUnKS50ZXh0KCkpLgogICAgICAgICAgIHRvQmUoJ0NvbnRlbnQgb2YgdGVtcGxhdGUyLmh0bWxcbicpOwogICAgICAgIH0pOwogICAgICAgIGl0KCdzaG91bGQgY2hhbmdlIHRvIGJsYW5rJywgZnVuY3Rpb24oKXsKICAgICAgICAgc2VsZWN0KCd1cmwnKS5vcHRpb24oJycpOwogICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgbmdcXDppbmNsdWRlJykudGV4dCgpKS50b0VxdWFsKCcnKTsKICAgICAgICB9KTsKICAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICA8L2RvYzpleGFtcGxlPgogKi8KYW5ndWxhcldpZGdldCgnbmc6aW5jbHVkZScsIGZ1bmN0aW9uKGVsZW1lbnQpewogIHZhciBjb21waWxlciA9IHRoaXMsCiAgICAgIHNyY0V4cCA9IGVsZW1lbnQuYXR0cigic3JjIiksCiAgICAgIHNjb3BlRXhwID0gZWxlbWVudC5hdHRyKCJzY29wZSIpIHx8ICcnLAogICAgICBvbmxvYWRFeHAgPSBlbGVtZW50WzBdLmdldEF0dHJpYnV0ZSgnb25sb2FkJykgfHwgJyc7IC8vd29ya2Fyb3VuZCBmb3IganF1ZXJ5IGJ1ZyAjNzUzNwogIGlmIChlbGVtZW50WzBdWyduZzpjb21waWxlZCddKSB7CiAgICB0aGlzLmRlc2NlbmQodHJ1ZSk7CiAgICB0aGlzLmRpcmVjdGl2ZXModHJ1ZSk7CiAgfSBlbHNlIHsKICAgIGVsZW1lbnRbMF1bJ25nOmNvbXBpbGVkJ10gPSB0cnVlOwogICAgcmV0dXJuIGV4dGVuZChmdW5jdGlvbih4aHIsIGVsZW1lbnQpewogICAgICB2YXIgc2NvcGUgPSB0aGlzLCBjaGlsZFNjb3BlOwogICAgICB2YXIgY2hhbmdlQ291bnRlciA9IDA7CiAgICAgIHZhciBwcmV2ZW50UmVjdXJzaW9uID0gZmFsc2U7CiAgICAgIGZ1bmN0aW9uIGluY3JlbWVudENoYW5nZSgpeyBjaGFuZ2VDb3VudGVyKys7fQogICAgICB0aGlzLiR3YXRjaChzcmNFeHAsIGluY3JlbWVudENoYW5nZSk7CiAgICAgIHRoaXMuJHdhdGNoKHNjb3BlRXhwLCBpbmNyZW1lbnRDaGFuZ2UpOwoKICAgICAgLy8gbm90ZSB0aGF0IHRoaXMgcHJvcGFnYXRlcyBldmFsIHRvIHRoZSBjdXJyZW50IGNoaWxkU2NvcGUsIHdoZXJlIGNoaWxkU2NvcGUgaXMgZHluYW1pY2FsbHkKICAgICAgLy8gYm91bmQgKHZpYSAkcm91dGUub25DaGFuZ2UgY2FsbGJhY2spIHRvIHRoZSBjdXJyZW50IHNjb3BlIGNyZWF0ZWQgYnkgJHJvdXRlCiAgICAgIHNjb3BlLiRvbkV2YWwoZnVuY3Rpb24oKXsKICAgICAgICBpZiAoY2hpbGRTY29wZSAmJiAhcHJldmVudFJlY3Vyc2lvbikgewogICAgICAgICAgcHJldmVudFJlY3Vyc2lvbiA9IHRydWU7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBjaGlsZFNjb3BlLiRldmFsKCk7CiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICBwcmV2ZW50UmVjdXJzaW9uID0gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgICAgdGhpcy4kd2F0Y2goZnVuY3Rpb24oKXtyZXR1cm4gY2hhbmdlQ291bnRlcjt9LCBmdW5jdGlvbigpewogICAgICAgIHZhciBzcmMgPSB0aGlzLiRldmFsKHNyY0V4cCksCiAgICAgICAgICAgIHVzZVNjb3BlID0gdGhpcy4kZXZhbChzY29wZUV4cCk7CgogICAgICAgIGlmIChzcmMpIHsKICAgICAgICAgIHhocignR0VUJywgc3JjLCBudWxsLCBmdW5jdGlvbihjb2RlLCByZXNwb25zZSl7CiAgICAgICAgICAgIGVsZW1lbnQuaHRtbChyZXNwb25zZSk7CiAgICAgICAgICAgIGNoaWxkU2NvcGUgPSB1c2VTY29wZSB8fCBjcmVhdGVTY29wZShzY29wZSk7CiAgICAgICAgICAgIGNvbXBpbGVyLmNvbXBpbGUoZWxlbWVudCkoY2hpbGRTY29wZSk7CiAgICAgICAgICAgIHNjb3BlLiRldmFsKG9ubG9hZEV4cCk7CiAgICAgICAgICB9LCBmYWxzZSwgdHJ1ZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGNoaWxkU2NvcGUgPSBudWxsOwogICAgICAgICAgZWxlbWVudC5odG1sKCcnKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSwgeyRpbmplY3Q6WyckeGhyLmNhY2hlJ119KTsKICB9Cn0pOwoKLyoqCiAqIEB3b3JrSW5Qcm9ncmVzcwogKiBAbmdkb2Mgd2lkZ2V0CiAqIEBuYW1lIGFuZ3VsYXIud2lkZ2V0Lm5nOnN3aXRjaAogKgogKiBAZGVzY3JpcHRpb24KICogQ29uZGl0aW9uYWxseSBjaGFuZ2UgdGhlIERPTSBzdHJ1Y3R1cmUuCiAqCiAqIEB1c2FnZUNvbnRlbnQKICogPGFueSBuZzpzd2l0Y2gtd2hlbj0ibWF0Y2hWYWx1ZTEiPi4uLjwvYW55PgogKiAgIDxhbnkgbmc6c3dpdGNoLXdoZW49Im1hdGNoVmFsdWUyIj4uLi48L2FueT4KICogICAuLi4KICogICA8YW55IG5nOnN3aXRjaC1kZWZhdWx0Pi4uLjwvYW55PgogKgogKiBAcGFyYW0geyp9IG9uIGV4cHJlc3Npb24gdG8gbWF0Y2ggYWdhaW5zdCA8dHQ+bmc6c3dpdGNoLXdoZW48L3R0Pi4KICogQHBhcmFtRGVzY3JpcHRpb24KICogT24gY2hpbGQgZWxtZW50cyBhZGQ6CiAqCiAqICogYG5nOnN3aXRjaC13aGVuYDogdGhlIGNhc2Ugc3RhdGVtZW50IHRvIG1hdGNoIGFnYWluc3QuIElmIG1hdGNoIHRoZW4gdGhpcwogKiAgIGNhc2Ugd2lsbCBiZSBkaXNwbGF5ZWQuCiAqICogYG5nOnN3aXRjaC1kZWZhdWx0YDogdGhlIGRlZmF1bHQgY2FzZSB3aGVuIG5vIG90aGVyIGNhc3NlcyBtYXRjaC4KICoKICogQGV4YW1wbGUKICAgIDxkb2M6ZXhhbXBsZT4KICAgICAgPGRvYzpzb3VyY2U+CiAgICAgICAgPHNlbGVjdCBuYW1lPSJzd2l0Y2giPgogICAgICAgICAgPG9wdGlvbj5zZXR0aW5nczwvb3B0aW9uPgogICAgICAgICAgPG9wdGlvbj5ob21lPC9vcHRpb24+CiAgICAgICAgICA8b3B0aW9uPm90aGVyPC9vcHRpb24+CiAgICAgICAgPC9zZWxlY3Q+CiAgICAgICAgPHR0PnN3aXRjaD17e3N3aXRjaH19PC90dD4KICAgICAgICA8L2hyPgogICAgICAgIDxuZzpzd2l0Y2ggb249InN3aXRjaCIgPgogICAgICAgICAgPGRpdiBuZzpzd2l0Y2gtd2hlbj0ic2V0dGluZ3MiPlNldHRpbmdzIERpdjwvZGl2PgogICAgICAgICAgPHNwYW4gbmc6c3dpdGNoLXdoZW49ImhvbWUiPkhvbWUgU3Bhbjwvc3Bhbj4KICAgICAgICAgIDxzcGFuIG5nOnN3aXRjaC1kZWZhdWx0PmRlZmF1bHQ8L3NwYW4+CiAgICAgICAgPC9uZzpzd2l0Y2g+CiAgICAgICAgPC9jb2RlPgogICAgICA8L2RvYzpzb3VyY2U+CiAgICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgICAgaXQoJ3Nob3VsZCBzdGFydCBpbiBzZXR0aW5ncycsIGZ1bmN0aW9uKCl7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBuZ1xcOnN3aXRjaCcpLnRleHQoKSkudG9FcXVhbCgnU2V0dGluZ3MgRGl2Jyk7CiAgICAgICAgfSk7CiAgICAgICAgaXQoJ3Nob3VsZCBjaGFuZ2UgdG8gaG9tZScsIGZ1bmN0aW9uKCl7CiAgICAgICAgIHNlbGVjdCgnc3dpdGNoJykub3B0aW9uKCdob21lJyk7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBuZ1xcOnN3aXRjaCcpLnRleHQoKSkudG9FcXVhbCgnSG9tZSBTcGFuJyk7CiAgICAgICAgfSk7CiAgICAgICAgaXQoJ3Nob3VsZCBzZWxlY3QgZGVhZmF1bHQnLCBmdW5jdGlvbigpewogICAgICAgICBzZWxlY3QoJ3N3aXRjaCcpLm9wdGlvbignb3RoZXInKTsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIG5nXFw6c3dpdGNoJykudGV4dCgpKS50b0VxdWFsKCdkZWZhdWx0Jyk7CiAgICAgICAgfSk7CiAgICAgIDwvZG9jOnNjZW5hcmlvPgogICAgPC9kb2M6ZXhhbXBsZT4KICovCi8vVE9ETyhpbSk6IHJlbW92ZSBhbGwgdGhlIGNvZGUgcmVsYXRlZCB0byB1c2luZyBhbmQgaW5saW5lIGVxdWFscwp2YXIgbmdTd2l0Y2ggPSBhbmd1bGFyV2lkZ2V0KCduZzpzd2l0Y2gnLCBmdW5jdGlvbiAoZWxlbWVudCl7CiAgdmFyIGNvbXBpbGVyID0gdGhpcywKICAgICAgd2F0Y2hFeHByID0gZWxlbWVudC5hdHRyKCJvbiIpLAogICAgICB1c2luZ0V4cHIgPSAoZWxlbWVudC5hdHRyKCJ1c2luZyIpIHx8ICdlcXVhbHMnKSwKICAgICAgdXNpbmdFeHByUGFyYW1zID0gdXNpbmdFeHByLnNwbGl0KCI6IiksCiAgICAgIHVzaW5nRm4gPSBuZ1N3aXRjaFt1c2luZ0V4cHJQYXJhbXMuc2hpZnQoKV0sCiAgICAgIGNoYW5nZUV4cHIgPSBlbGVtZW50LmF0dHIoJ2NoYW5nZScpIHx8ICcnLAogICAgICBjYXNlcyA9IFtdOwogIGlmICghdXNpbmdGbikgdGhyb3cgIlVzaW5nIGV4cHJlc3Npb24gJyIgKyB1c2luZ0V4cHIgKyAiJyB1bmtub3duLiI7CiAgaWYgKCF3YXRjaEV4cHIpIHRocm93ICJNaXNzaW5nICdvbicgYXR0cmlidXRlLiI7CiAgZWFjaE5vZGUoZWxlbWVudCwgZnVuY3Rpb24oY2FzZUVsZW1lbnQpewogICAgdmFyIHdoZW4gPSBjYXNlRWxlbWVudC5hdHRyKCduZzpzd2l0Y2gtd2hlbicpOwogICAgdmFyIHN3aXRjaENhc2UgPSB7CiAgICAgICAgY2hhbmdlOiBjaGFuZ2VFeHByLAogICAgICAgIGVsZW1lbnQ6IGNhc2VFbGVtZW50LAogICAgICAgIHRlbXBsYXRlOiBjb21waWxlci5jb21waWxlKGNhc2VFbGVtZW50KQogICAgICB9OwogICAgaWYgKGlzU3RyaW5nKHdoZW4pKSB7CiAgICAgIHN3aXRjaENhc2Uud2hlbiA9IGZ1bmN0aW9uKHNjb3BlLCB2YWx1ZSl7CiAgICAgICAgdmFyIGFyZ3MgPSBbdmFsdWUsIHdoZW5dOwogICAgICAgIGZvckVhY2godXNpbmdFeHByUGFyYW1zLCBmdW5jdGlvbihhcmcpewogICAgICAgICAgYXJncy5wdXNoKGFyZyk7CiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIHVzaW5nRm4uYXBwbHkoc2NvcGUsIGFyZ3MpOwogICAgICB9OwogICAgICBjYXNlcy51bnNoaWZ0KHN3aXRjaENhc2UpOwogICAgfSBlbHNlIGlmIChpc1N0cmluZyhjYXNlRWxlbWVudC5hdHRyKCduZzpzd2l0Y2gtZGVmYXVsdCcpKSkgewogICAgICBzd2l0Y2hDYXNlLndoZW4gPSB2YWx1ZUZuKHRydWUpOwogICAgICBjYXNlcy5wdXNoKHN3aXRjaENhc2UpOwogICAgfQogIH0pOwoKICAvLyB0aGlzIG5lZWRzIHRvIGJlIGhlcmUgZm9yIElFCiAgZm9yRWFjaChjYXNlcywgZnVuY3Rpb24oX2Nhc2UpewogICAgX2Nhc2UuZWxlbWVudC5yZW1vdmUoKTsKICB9KTsKCiAgZWxlbWVudC5odG1sKCcnKTsKICByZXR1cm4gZnVuY3Rpb24oZWxlbWVudCl7CiAgICB2YXIgc2NvcGUgPSB0aGlzLCBjaGlsZFNjb3BlOwogICAgdGhpcy4kd2F0Y2god2F0Y2hFeHByLCBmdW5jdGlvbih2YWx1ZSl7CiAgICAgIHZhciBmb3VuZCA9IGZhbHNlOwogICAgICBlbGVtZW50Lmh0bWwoJycpOwogICAgICBjaGlsZFNjb3BlID0gY3JlYXRlU2NvcGUoc2NvcGUpOwogICAgICBmb3JFYWNoKGNhc2VzLCBmdW5jdGlvbihzd2l0Y2hDYXNlKXsKICAgICAgICBpZiAoIWZvdW5kICYmIHN3aXRjaENhc2Uud2hlbihjaGlsZFNjb3BlLCB2YWx1ZSkpIHsKICAgICAgICAgIGZvdW5kID0gdHJ1ZTsKICAgICAgICAgIGNoaWxkU2NvcGUuJHRyeUV2YWwoc3dpdGNoQ2FzZS5jaGFuZ2UsIGVsZW1lbnQpOwogICAgICAgICAgc3dpdGNoQ2FzZS50ZW1wbGF0ZShjaGlsZFNjb3BlLCBmdW5jdGlvbihjYXNlRWxlbWVudCl7CiAgICAgICAgICAgIGVsZW1lbnQuYXBwZW5kKGNhc2VFbGVtZW50KTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9KTsKICAgIHNjb3BlLiRvbkV2YWwoZnVuY3Rpb24oKXsKICAgICAgaWYgKGNoaWxkU2NvcGUpIGNoaWxkU2NvcGUuJGV2YWwoKTsKICAgIH0pOwogIH07Cn0sIHsKICBlcXVhbHM6IGZ1bmN0aW9uKG9uLCB3aGVuKSB7CiAgICByZXR1cm4gJycrb24gPT0gd2hlbjsKICB9Cn0pOwoKCi8qCiAqIE1vZGlmaWVzIHRoZSBkZWZhdWx0IGJlaGF2aW9yIG9mIGh0bWwgQSB0YWcsIHNvIHRoYXQgdGhlIGRlZmF1bHQgYWN0aW9uIGlzIHByZXZlbnRlZCB3aGVuIGhyZWYKICogYXR0cmlidXRlIGlzIGVtcHR5LgogKgogKiBUaGUgcmVhc29uaW5nIGZvciB0aGlzIGNoYW5nZSBpcyB0byBhbGxvdyBlYXN5IGNyZWF0aW9uIG9mIGFjdGlvbiBsaW5rcyB3aXRoIG5nOmNsaWNrIHdpdGhvdXQKICogY2hhbmdpbmcgdGhlIGxvY2F0aW9uIG9yIGNhdXNpbmcgcGFnZSByZWxvYWRzLCBlLmcuOgogKiA8YSBocmVmPSIiIG5nOmNsaWNrPSJtb2RlbC4kc2F2ZSgpIj5TYXZlPC9hPgogKi8KYW5ndWxhcldpZGdldCgnYScsIGZ1bmN0aW9uKCkgewogIHRoaXMuZGVzY2VuZCh0cnVlKTsKICB0aGlzLmRpcmVjdGl2ZXModHJ1ZSk7CgogIHJldHVybiBmdW5jdGlvbihlbGVtZW50KSB7CiAgICB2YXIgaGFzTmdIcmVmID0gKChlbGVtZW50LmF0dHIoJ25nOmJpbmQtYXR0cicpIHx8ICcnKS5pbmRleE9mKCciaHJlZiI6JykgIT09IC0xKTsKCiAgICAvLyB0dXJuIDxhIGhyZWYgbmc6Y2xpY2s9Ii4uIj5saW5rPC9hPiBpbnRvIGEgbGluayBpbiBJRQogICAgLy8gYnV0IG9ubHkgaWYgaXQgZG9lc24ndCBoYXZlIG5hbWUgYXR0cmlidXRlLCBpbiB3aGljaCBjYXNlIGl0J3MgYW4gYW5jaG9yCiAgICBpZiAoIWhhc05nSHJlZiAmJiAhZWxlbWVudC5hdHRyKCduYW1lJykgJiYgIWVsZW1lbnQuYXR0cignaHJlZicpKSB7CiAgICAgIGVsZW1lbnQuYXR0cignaHJlZicsICcnKTsKICAgIH0KCiAgICBpZiAoZWxlbWVudC5hdHRyKCdocmVmJykgPT09ICcnICYmICFoYXNOZ0hyZWYpIHsKICAgICAgZWxlbWVudC5iaW5kKCdjbGljaycsIGZ1bmN0aW9uKGV2ZW50KXsKICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICB9KTsKICAgIH0KICB9Owp9KTsKCgovKioKICogQHdvcmtJblByb2dyZXNzCiAqIEBuZ2RvYyB3aWRnZXQKICogQG5hbWUgYW5ndWxhci53aWRnZXQuQG5nOnJlcGVhdAogKgogKiBAZGVzY3JpcHRpb24KICogVGhlIGBuZzpyZXBlYXRgIHdpZGdldCBpbnN0YW50aWF0ZXMgYSB0ZW1wbGF0ZSBvbmNlIHBlciBpdGVtIGZyb20gYSBjb2xsZWN0aW9uLiBUaGUgY29sbGVjdGlvbiBpcwogKiBlbnVtZXJhdGVkIHdpdGggdGhlIGBuZzpyZXBlYXQtaW5kZXhgIGF0dHJpYnV0ZSwgc3RhcnRpbmcgZnJvbSAwLiBFYWNoIHRlbXBsYXRlIGluc3RhbmNlIGdldHMKICogaXRzIG93biBzY29wZSwgd2hlcmUgdGhlIGdpdmVuIGxvb3AgdmFyaWFibGUgaXMgc2V0IHRvIHRoZSBjdXJyZW50IGNvbGxlY3Rpb24gaXRlbSwgYW5kIGAkaW5kZXhgCiAqIGlzIHNldCB0byB0aGUgaXRlbSBpbmRleCBvciBrZXkuCiAqCiAqIFNwZWNpYWwgcHJvcGVydGllcyBhcmUgZXhwb3NlZCBvbiB0aGUgbG9jYWwgc2NvcGUgb2YgZWFjaCB0ZW1wbGF0ZSBpbnN0YW5jZSwgaW5jbHVkaW5nOgogKgogKiAgICogYCRpbmRleGAg4oCTIGB7bnVtYmVyfWAg4oCTIGl0ZXJhdG9yIG9mZnNldCBvZiB0aGUgcmVwZWF0ZWQgZWxlbWVudCAoMC4ubGVuZ3RoLTEpCiAqICAgKiBgJHBvc2l0aW9uYCDigJMgYHtzdHJpbmd9YCDigJMgcG9zaXRpb24gb2YgdGhlIHJlcGVhdGVkIGVsZW1lbnQgaW4gdGhlIGl0ZXJhdG9yLiBPbmUgb2Y6CiAqICAgICAgICAqIGAnZmlyc3QnYCwKICogICAgICAgICogYCdtaWRkbGUnYAogKiAgICAgICAgKiBgJ2xhc3QnYAogKgogKiBOb3RlOiBBbHRob3VnaCBgbmc6cmVwZWF0YCBsb29rcyBsaWtlIGEgZGlyZWN0aXZlLCBpdCBpcyBhY3R1YWxseSBhbiBhdHRyaWJ1dGUgd2lkZ2V0LgogKgogKiBAZWxlbWVudCBBTlkKICogQHBhcmFtIHtzdHJpbmd9IHJlcGVhdF9leHByZXNzaW9uIFRoZSBleHByZXNzaW9uIGluZGljYXRpbmcgaG93IHRvIGVudW1lcmF0ZSBhIGNvbGxlY3Rpb24uIFR3bwogKiAgIGZvcm1hdHMgYXJlIGN1cnJlbnRseSBzdXBwb3J0ZWQ6CiAqCiAqICAgKiBgdmFyaWFibGUgaW4gZXhwcmVzc2lvbmAg4oCTIHdoZXJlIHZhcmlhYmxlIGlzIHRoZSB1c2VyIGRlZmluZWQgbG9vcCB2YXJpYWJsZSBhbmQgYGV4cHJlc3Npb25gCiAqICAgICBpcyBhIHNjb3BlIGV4cHJlc3Npb24gZ2l2aW5nIHRoZSBjb2xsZWN0aW9uIHRvIGVudW1lcmF0ZS4KICoKICogICAgIEZvciBleGFtcGxlOiBgdHJhY2sgaW4gY2QudHJhY2tzYC4KICoKICogICAqIGAoa2V5LCB2YWx1ZSkgaW4gZXhwcmVzc2lvbmAg4oCTIHdoZXJlIGBrZXlgIGFuZCBgdmFsdWVgIGNhbiBiZSBhbnkgdXNlciBkZWZpbmVkIGlkZW50aWZpZXJzLAogKiAgICAgYW5kIGBleHByZXNzaW9uYCBpcyB0aGUgc2NvcGUgZXhwcmVzc2lvbiBnaXZpbmcgdGhlIGNvbGxlY3Rpb24gdG8gZW51bWVyYXRlLgogKgogKiAgICAgRm9yIGV4YW1wbGU6IGAobmFtZSwgYWdlKSBpbiB7J2FkYW0nOjEwLCAnYW1hbGllJzoxMn1gLgogKgogKiBAZXhhbXBsZQogKiBUaGlzIGV4YW1wbGUgaW5pdGlhbGl6ZXMgdGhlIHNjb3BlIHRvIGEgbGlzdCBvZiBuYW1lcyBhbmQKICogdGhlbiB1c2VzIGBuZzpyZXBlYXRgIHRvIGRpc3BsYXkgZXZlcnkgcGVyc29uOgogICAgPGRvYzpleGFtcGxlPgogICAgICA8ZG9jOnNvdXJjZT4KICAgICAgICA8ZGl2IG5nOmluaXQ9ImZyaWVuZHMgPSBbe25hbWU6J0pvaG4nLCBhZ2U6MjV9LCB7bmFtZTonTWFyeScsIGFnZToyOH1dIj4KICAgICAgICAgIEkgaGF2ZSB7e2ZyaWVuZHMubGVuZ3RofX0gZnJpZW5kcy4gVGhleSBhcmU6CiAgICAgICAgICA8dWw+CiAgICAgICAgICAgIDxsaSBuZzpyZXBlYXQ9ImZyaWVuZCBpbiBmcmllbmRzIj4KICAgICAgICAgICAgICBbe3skaW5kZXggKyAxfX1dIHt7ZnJpZW5kLm5hbWV9fSB3aG8gaXMge3tmcmllbmQuYWdlfX0geWVhcnMgb2xkLgogICAgICAgICAgICA8L2xpPgogICAgICAgICAgPC91bD4KICAgICAgICA8L2Rpdj4KICAgICAgPC9kb2M6c291cmNlPgogICAgICA8ZG9jOnNjZW5hcmlvPgogICAgICAgICBpdCgnc2hvdWxkIGNoZWNrIG5nOnJlcGVhdCcsIGZ1bmN0aW9uKCl7CiAgICAgICAgICAgdmFyIHIgPSB1c2luZygnLmRvYy1leGFtcGxlLWxpdmUnKS5yZXBlYXRlcigndWwgbGknKTsKICAgICAgICAgICBleHBlY3Qoci5jb3VudCgpKS50b0JlKDIpOwogICAgICAgICAgIGV4cGVjdChyLnJvdygwKSkudG9FcXVhbChbIjEiLCJKb2huIiwiMjUiXSk7CiAgICAgICAgICAgZXhwZWN0KHIucm93KDEpKS50b0VxdWFsKFsiMiIsIk1hcnkiLCIyOCJdKTsKICAgICAgICAgfSk7CiAgICAgIDwvZG9jOnNjZW5hcmlvPgogICAgPC9kb2M6ZXhhbXBsZT4KICovCmFuZ3VsYXJXaWRnZXQoJ0BuZzpyZXBlYXQnLCBmdW5jdGlvbihleHByZXNzaW9uLCBlbGVtZW50KXsKICBlbGVtZW50LnJlbW92ZUF0dHIoJ25nOnJlcGVhdCcpOwogIGVsZW1lbnQucmVwbGFjZVdpdGgoanFMaXRlKCc8IS0tIG5nOnJlcGVhdDogJyArIGV4cHJlc3Npb24gKyAnIC0tPicpKTsKICB2YXIgbGlua2VyID0gdGhpcy5jb21waWxlKGVsZW1lbnQpOwogIHJldHVybiBmdW5jdGlvbihpdGVyU3RhcnRFbGVtZW50KXsKICAgIHZhciBtYXRjaCA9IGV4cHJlc3Npb24ubWF0Y2goL15ccyooLispXHMraW5ccysoLiopXHMqJC8pLAogICAgICAgIGxocywgcmhzLCB2YWx1ZUlkZW50LCBrZXlJZGVudDsKICAgIGlmICghIG1hdGNoKSB7CiAgICAgIHRocm93IEVycm9yKCJFeHBlY3RlZCBuZzpyZXBlYXQgaW4gZm9ybSBvZiAnX2l0ZW1fIGluIF9jb2xsZWN0aW9uXycgYnV0IGdvdCAnIiArCiAgICAgIGV4cHJlc3Npb24gKyAiJy4iKTsKICAgIH0KICAgIGxocyA9IG1hdGNoWzFdOwogICAgcmhzID0gbWF0Y2hbMl07CiAgICBtYXRjaCA9IGxocy5tYXRjaCgvXihbXCRcd10rKXxcKChbXCRcd10rKVxzKixccyooW1wkXHddKylcKSQvKTsKICAgIGlmICghbWF0Y2gpIHsKICAgICAgdGhyb3cgRXJyb3IoIidpdGVtJyBpbiAnaXRlbSBpbiBjb2xsZWN0aW9uJyBzaG91bGQgYmUgaWRlbnRpZmllciBvciAoa2V5LCB2YWx1ZSkgYnV0IGdvdCAnIiArCiAgICAgIGtleVZhbHVlICsgIicuIik7CiAgICB9CiAgICB2YWx1ZUlkZW50ID0gbWF0Y2hbM10gfHwgbWF0Y2hbMV07CiAgICBrZXlJZGVudCA9IG1hdGNoWzJdOwoKICAgIHZhciBjaGlsZHJlbiA9IFtdLCBjdXJyZW50U2NvcGUgPSB0aGlzOwogICAgdGhpcy4kb25FdmFsKGZ1bmN0aW9uKCl7CiAgICAgIHZhciBpbmRleCA9IDAsCiAgICAgICAgICBjaGlsZENvdW50ID0gY2hpbGRyZW4ubGVuZ3RoLAogICAgICAgICAgbGFzdEl0ZXJFbGVtZW50ID0gaXRlclN0YXJ0RWxlbWVudCwKICAgICAgICAgIGNvbGxlY3Rpb24gPSB0aGlzLiR0cnlFdmFsKHJocywgaXRlclN0YXJ0RWxlbWVudCksCiAgICAgICAgICBjb2xsZWN0aW9uTGVuZ3RoID0gc2l6ZShjb2xsZWN0aW9uLCB0cnVlKSwKICAgICAgICAgIGZyYWdtZW50ID0gKGVsZW1lbnRbMF0ubm9kZU5hbWUgIT0gJ09QVElPTicpID8gZG9jdW1lbnQuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpIDogbnVsbCwKICAgICAgICAgIGFkZEZyYWdtZW50LAogICAgICAgICAgY2hpbGRTY29wZSwKICAgICAgICAgIGtleTsKCiAgICAgIGZvciAoa2V5IGluIGNvbGxlY3Rpb24pIHsKICAgICAgICBpZiAoY29sbGVjdGlvbi5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CiAgICAgICAgICBpZiAoaW5kZXggPCBjaGlsZENvdW50KSB7CiAgICAgICAgICAgIC8vIHJldXNlIGV4aXN0aW5nIGNoaWxkCiAgICAgICAgICAgIGNoaWxkU2NvcGUgPSBjaGlsZHJlbltpbmRleF07CiAgICAgICAgICAgIGNoaWxkU2NvcGVbdmFsdWVJZGVudF0gPSBjb2xsZWN0aW9uW2tleV07CiAgICAgICAgICAgIGlmIChrZXlJZGVudCkgY2hpbGRTY29wZVtrZXlJZGVudF0gPSBrZXk7CiAgICAgICAgICAgIGxhc3RJdGVyRWxlbWVudCA9IGNoaWxkU2NvcGUuJGVsZW1lbnQ7CiAgICAgICAgICAgIGNoaWxkU2NvcGUuJHBvc2l0aW9uID0gaW5kZXggPT0gMAogICAgICAgICAgICAgICAgPyAnZmlyc3QnCiAgICAgICAgICAgICAgICA6IChpbmRleCA9PSBjb2xsZWN0aW9uTGVuZ3RoIC0gMSA/ICdsYXN0JyA6ICdtaWRkbGUnKTsKICAgICAgICAgICAgY2hpbGRTY29wZS4kZXZhbCgpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgLy8gZ3JvdyBjaGlsZHJlbgogICAgICAgICAgICBjaGlsZFNjb3BlID0gY3JlYXRlU2NvcGUoY3VycmVudFNjb3BlKTsKICAgICAgICAgICAgY2hpbGRTY29wZVt2YWx1ZUlkZW50XSA9IGNvbGxlY3Rpb25ba2V5XTsKICAgICAgICAgICAgaWYgKGtleUlkZW50KSBjaGlsZFNjb3BlW2tleUlkZW50XSA9IGtleTsKICAgICAgICAgICAgY2hpbGRTY29wZS4kaW5kZXggPSBpbmRleDsKICAgICAgICAgICAgY2hpbGRTY29wZS4kcG9zaXRpb24gPSBpbmRleCA9PSAwCiAgICAgICAgICAgICAgICA/ICdmaXJzdCcKICAgICAgICAgICAgICAgIDogKGluZGV4ID09IGNvbGxlY3Rpb25MZW5ndGggLSAxID8gJ2xhc3QnIDogJ21pZGRsZScpOwogICAgICAgICAgICBjaGlsZHJlbi5wdXNoKGNoaWxkU2NvcGUpOwogICAgICAgICAgICBsaW5rZXIoY2hpbGRTY29wZSwgZnVuY3Rpb24oY2xvbmUpewogICAgICAgICAgICAgIGNsb25lLmF0dHIoJ25nOnJlcGVhdC1pbmRleCcsIGluZGV4KTsKCiAgICAgICAgICAgICAgaWYgKGZyYWdtZW50KSB7CiAgICAgICAgICAgICAgICBmcmFnbWVudC5hcHBlbmRDaGlsZChjbG9uZVswXSk7CiAgICAgICAgICAgICAgICBhZGRGcmFnbWVudCA9IHRydWU7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vdGVtcG9yYXJpbHkgcHJlc2VydmUgb2xkIHdheSBmb3Igb3B0aW9uIGVsZW1lbnQKICAgICAgICAgICAgICAgIGxhc3RJdGVyRWxlbWVudC5hZnRlcihjbG9uZSk7CiAgICAgICAgICAgICAgICBsYXN0SXRlckVsZW1lbnQgPSBjbG9uZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgICAgaW5kZXggKys7CiAgICAgICAgfQogICAgICB9CgogICAgICAvL2F0dGFjaCBuZXcgbm9kZXMgYnVmZmVyZWQgaW4gZG9jIGZyYWdtZW50CiAgICAgIGlmIChhZGRGcmFnbWVudCkgewogICAgICAgIGxhc3RJdGVyRWxlbWVudC5hZnRlcihqcUxpdGUoZnJhZ21lbnQpKTsKICAgICAgfQoKICAgICAgLy8gc2hyaW5rIGNoaWxkcmVuCiAgICAgIHdoaWxlKGNoaWxkcmVuLmxlbmd0aCA+IGluZGV4KSB7CiAgICAgICAgY2hpbGRyZW4ucG9wKCkuJGVsZW1lbnQucmVtb3ZlKCk7CiAgICAgIH0KICAgIH0sIGl0ZXJTdGFydEVsZW1lbnQpOwogIH07Cn0pOwoKCi8qKgogKiBAd29ya0luUHJvZ3Jlc3MKICogQG5nZG9jIHdpZGdldAogKiBAbmFtZSBhbmd1bGFyLndpZGdldC5Abmc6bm9uLWJpbmRhYmxlCiAqCiAqIEBkZXNjcmlwdGlvbgogKiBTb21ldGltZXMgaXQgaXMgbmVjZXNzYXJ5IHRvIHdyaXRlIGNvZGUgd2hpY2ggbG9va3MgbGlrZSBiaW5kaW5ncyBidXQgd2hpY2ggc2hvdWxkIGJlIGxlZnQgYWxvbmUKICogYnkgYW5ndWxhci4gVXNlIGBuZzpub24tYmluZGFibGVgIHRvIG1ha2UgYW5ndWxhciBpZ25vcmUgYSBjaHVuayBvZiBIVE1MLgogKgogKiBOb3RlOiBgbmc6bm9uLWJpbmRhYmxlYCBsb29rcyBsaWtlIGEgZGlyZWN0aXZlLCBidXQgaXMgYWN0dWFsbHkgYW4gYXR0cmlidXRlIHdpZGdldC4KICoKICogQGVsZW1lbnQgQU5ZCiAqCiAqIEBleGFtcGxlCiAqIEluIHRoaXMgZXhhbXBsZSB0aGVyZSBhcmUgdHdvIGxvY2F0aW9uIHdoZXJlIGEgc2ltcGxlIGJpbmRpbmcgKGB7e319YCkgaXMgcHJlc2VudCwgYnV0IHRoZSBvbmUKICogd3JhcHBlZCBpbiBgbmc6bm9uLWJpbmRhYmxlYCBpcyBsZWZ0IGFsb25lLgogKgogKiBAZXhhbXBsZQogICAgPGRvYzpleGFtcGxlPgogICAgICA8ZG9jOnNvdXJjZT4KICAgICAgICA8ZGl2Pk5vcm1hbDoge3sxICsgMn19PC9kaXY+CiAgICAgICAgPGRpdiBuZzpub24tYmluZGFibGU+SWdub3JlZDoge3sxICsgMn19PC9kaXY+CiAgICAgIDwvZG9jOnNvdXJjZT4KICAgICAgPGRvYzpzY2VuYXJpbz4KICAgICAgIGl0KCdzaG91bGQgY2hlY2sgbmc6bm9uLWJpbmRhYmxlJywgZnVuY3Rpb24oKXsKICAgICAgICAgZXhwZWN0KHVzaW5nKCcuZG9jLWV4YW1wbGUtbGl2ZScpLmJpbmRpbmcoJzEgKyAyJykpLnRvQmUoJzMnKTsKICAgICAgICAgZXhwZWN0KHVzaW5nKCcuZG9jLWV4YW1wbGUtbGl2ZScpLmVsZW1lbnQoJ2RpdjpsYXN0JykudGV4dCgpKS4KICAgICAgICAgICB0b01hdGNoKC8xIFwrIDIvKTsKICAgICAgIH0pOwogICAgICA8L2RvYzpzY2VuYXJpbz4KICAgIDwvZG9jOmV4YW1wbGU+CiAqLwphbmd1bGFyV2lkZ2V0KCJAbmc6bm9uLWJpbmRhYmxlIiwgbm9vcCk7CgoKLyoqCiAqIEBuZ2RvYyB3aWRnZXQKICogQG5hbWUgYW5ndWxhci53aWRnZXQubmc6dmlldwogKgogKiBAZGVzY3JpcHRpb24KICogIyBPdmVydmlldwogKiBgbmc6dmlld2AgaXMgYSB3aWRnZXQgdGhhdCBjb21wbGVtZW50cyB0aGUge0BsaW5rIGFuZ3VsYXIuc2VydmljZS4kcm91dGUgJHJvdXRlfSBzZXJ2aWNlIGJ5CiAqIGluY2x1ZGluZyB0aGUgcmVuZGVyZWQgdGVtcGxhdGUgb2YgdGhlIGN1cnJlbnQgcm91dGUgaW50byB0aGUgbWFpbiBsYXlvdXQgKGBpbmRleC5odG1sYCkgZmlsZS4KICogRXZlcnkgdGltZSB0aGUgY3VycmVudCByb3V0ZSBjaGFuZ2VzLCB0aGUgaW5jbHVkZWQgdmlldyBjaGFuZ2VzIHdpdGggaXQgYWNjb3JkaW5nIHRvIHRoZQogKiBjb25maWd1cmF0aW9uIG9mIHRoZSBgJHJvdXRlYCBzZXJ2aWNlLgogKgogKiBUaGlzIHdpZGdldCBwcm92aWRlcyBmdW5jdGlvbmFsaXR5IHNpbWlsYXIgdG8ge0BsaW5rIGFuZ3VsYXIud2lkZ2V0Lm5nOmluY2x1ZGUgbmc6aW5jbHVkZX0gd2hlbgogKiB1c2VkIGxpa2UgdGhpczoKICoKICogICAgIDxuZzppbmNsdWRlIHNyYz0iJHJvdXRlLmN1cnJlbnQudGVtcGxhdGUiIHNjb3BlPSIkcm91dGUuY3VycmVudC5zY29wZSI+PC9uZzppbmNsdWRlPgogKgogKgogKiAjIEFkdmFudGFnZXMKICogQ29tcGFyZWQgdG8gYG5nOmluY2x1ZGVgLCBgbmc6dmlld2Agb2ZmZXJzIHRoZXNlIGFkdmFudGFnZXM6CiAqCiAqIC0gc2hvcnRlciBzeW50YXgKICogLSBtb3JlIGVmZmljaWVudCBleGVjdXRpb24KICogLSBkb2Vzbid0IHJlcXVpcmUgYCRyb3V0ZWAgc2VydmljZSB0byBiZSBhdmFpbGFibGUgb24gdGhlIHJvb3Qgc2NvcGUKICoKICoKICogQGV4YW1wbGUKICAgIDxkb2M6ZXhhbXBsZT4KICAgICAgPGRvYzpzb3VyY2UganNmaWRkbGU9ImZhbHNlIj4KICAgICAgICAgPHNjcmlwdD4KICAgICAgICAgICBmdW5jdGlvbiBNeUN0cmwoJHJvdXRlKSB7CiAgICAgICAgICAgICAkcm91dGUud2hlbignL292ZXJ2aWV3JywKICAgICAgICAgICAgICAgeyBjb250cm9sbGVyOiBPdmVydmlld0N0cmwsCiAgICAgICAgICAgICAgICAgdGVtcGxhdGU6ICdndWlkZS9kZXZfZ3VpZGUub3ZlcnZpZXcuaHRtbCd9KTsKICAgICAgICAgICAgICRyb3V0ZS53aGVuKCcvYm9vdHN0cmFwJywKICAgICAgICAgICAgICAgeyBjb250cm9sbGVyOiBCb290c3RyYXBDdHJsLAogICAgICAgICAgICAgICAgIHRlbXBsYXRlOiAnZ3VpZGUvZGV2X2d1aWRlLmJvb3RzdHJhcC5hdXRvX2Jvb3RzdHJhcC5odG1sJ30pOwogICAgICAgICAgIH07CiAgICAgICAgICAgTXlDdHJsLiRpbmplY3QgPSBbJyRyb3V0ZSddOwoKICAgICAgICAgICBmdW5jdGlvbiBCb290c3RyYXBDdHJsKCl7fQogICAgICAgICAgIGZ1bmN0aW9uIE92ZXJ2aWV3Q3RybCgpe30KICAgICAgICAgPC9zY3JpcHQ+CiAgICAgICAgIDxkaXYgbmc6Y29udHJvbGxlcj0iTXlDdHJsIj4KICAgICAgICAgICA8YSBocmVmPSIjL292ZXJ2aWV3Ij5vdmVydmlldzwvYT4gfAogICAgICAgICAgIDxhIGhyZWY9IiMvYm9vdHN0cmFwIj5ib290c3RyYXA8L2E+IHwKICAgICAgICAgICA8YSBocmVmPSIjL3VuZGVmaW5lZCI+dW5kZWZpbmVkPC9hPgoKICAgICAgICAgICA8YnIvPgoKICAgICAgICAgICBUaGUgdmlldyBpcyBpbmNsdWRlZCBiZWxvdzoKICAgICAgICAgICA8aHIvPgogICAgICAgICAgIDxuZzp2aWV3Pjwvbmc6dmlldz4KICAgICAgICAgPC9kaXY+CiAgICAgIDwvZG9jOnNvdXJjZT4KICAgICAgPGRvYzpzY2VuYXJpbz4KICAgICAgICBpdCgnc2hvdWxkIGxvYWQgdGVtcGxhdGVzJywgZnVuY3Rpb24oKXsKICAgICAgICAgIGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIGE6Y29udGFpbnMob3ZlcnZpZXcpJykuY2xpY2soKTsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBuZ1xcOnZpZXcnKS50ZXh0KCkpLnRvTWF0Y2goL0RldmVsb3BlciBHdWlkZTogT3ZlcnZpZXcvKTsKCiAgICAgICAgICBlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBhOmNvbnRhaW5zKGJvb3RzdHJhcCknKS5jbGljaygpOwogICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIG5nXFw6dmlldycpLnRleHQoKSkudG9NYXRjaCgvRGV2ZWxvcGVyIEd1aWRlOiBJbml0aWFsaXppbmcgQW5ndWxhcjogQXV0b21hdGljIEluaXRpaWFsaXphdGlvbi8pOwogICAgICAgIH0pOwogICAgICA8L2RvYzpzY2VuYXJpbz4KICAgIDwvZG9jOmV4YW1wbGU+CiAqLwphbmd1bGFyV2lkZ2V0KCduZzp2aWV3JywgZnVuY3Rpb24oZWxlbWVudCkgewogIHZhciBjb21waWxlciA9IHRoaXM7CgogIGlmICghZWxlbWVudFswXVsnbmc6Y29tcGlsZWQnXSkgewogICAgZWxlbWVudFswXVsnbmc6Y29tcGlsZWQnXSA9IHRydWU7CiAgICByZXR1cm4gYW5ub3RhdGUoJyR4aHIuY2FjaGUnLCAnJHJvdXRlJywgZnVuY3Rpb24oJHhociwgJHJvdXRlLCBlbGVtZW50KXsKICAgICAgdmFyIHBhcmVudFNjb3BlID0gdGhpcywKICAgICAgICAgIGNoaWxkU2NvcGU7CgogICAgICAkcm91dGUub25DaGFuZ2UoZnVuY3Rpb24oKXsKICAgICAgICB2YXIgc3JjOwoKICAgICAgICBpZiAoJHJvdXRlLmN1cnJlbnQpIHsKICAgICAgICAgIHNyYyA9ICRyb3V0ZS5jdXJyZW50LnRlbXBsYXRlOwogICAgICAgICAgY2hpbGRTY29wZSA9ICRyb3V0ZS5jdXJyZW50LnNjb3BlOwogICAgICAgIH0KCiAgICAgICAgaWYgKHNyYykgewogICAgICAgICAgLy94aHIncyBjYWxsYmFjayBtdXN0IGJlIGFzeW5jLCBzZWUgY29tbWl0IGhpc3RvcnkgZm9yIG1vcmUgaW5mbwogICAgICAgICAgJHhocignR0VUJywgc3JjLCBmdW5jdGlvbihjb2RlLCByZXNwb25zZSl7CiAgICAgICAgICAgIGVsZW1lbnQuaHRtbChyZXNwb25zZSk7CiAgICAgICAgICAgIGNvbXBpbGVyLmNvbXBpbGUoZWxlbWVudCkoY2hpbGRTY29wZSk7CiAgICAgICAgICB9KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZWxlbWVudC5odG1sKCcnKTsKICAgICAgICB9CiAgICAgIH0pKCk7IC8vaW5pdGlhbGl6ZSB0aGUgc3RhdGUgZm9yY2VmdWxseSwgaXQncyBwb3NzaWJsZSB0aGF0IHdlIG1pc3NlZCB0aGUgaW5pdGlhbAogICAgICAgICAgICAvLyRyb3V0ZSNvbkNoYW5nZSBhbHJlYWR5CgogICAgICAvLyBub3RlIHRoYXQgdGhpcyBwcm9wYWdhdGVzIGV2YWwgdG8gdGhlIGN1cnJlbnQgY2hpbGRTY29wZSwgd2hlcmUgY2hpbGRTY29wZSBpcyBkeW5hbWljYWxseQogICAgICAvLyBib3VuZCAodmlhICRyb3V0ZS5vbkNoYW5nZSBjYWxsYmFjaykgdG8gdGhlIGN1cnJlbnQgc2NvcGUgY3JlYXRlZCBieSAkcm91dGUKICAgICAgcGFyZW50U2NvcGUuJG9uRXZhbChmdW5jdGlvbigpIHsKICAgICAgICBpZiAoY2hpbGRTY29wZSkgewogICAgICAgICAgY2hpbGRTY29wZS4kZXZhbCgpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9KTsKICB9IGVsc2UgewogICAgdGhpcy5kZXNjZW5kKHRydWUpOwogICAgdGhpcy5kaXJlY3RpdmVzKHRydWUpOwogIH0KfSk7Cid1c2Ugc3RyaWN0JzsKCnZhciBicm93c2VyU2luZ2xldG9uOwoKYW5ndWxhclNlcnZpY2UoJyRicm93c2VyJywgZnVuY3Rpb24oJGxvZyl7CiAgaWYgKCFicm93c2VyU2luZ2xldG9uKSB7CiAgICBicm93c2VyU2luZ2xldG9uID0gbmV3IEJyb3dzZXIod2luZG93LCBqcUxpdGUod2luZG93LmRvY3VtZW50KSwganFMaXRlKHdpbmRvdy5kb2N1bWVudC5ib2R5KSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBYSFIsICRsb2cpOwogICAgYnJvd3NlclNpbmdsZXRvbi5iaW5kKCk7CiAgfQogIHJldHVybiBicm93c2VyU2luZ2xldG9uOwp9LCB7JGluamVjdDpbJyRsb2cnXX0pOwoKCmV4dGVuZChhbmd1bGFyLCB7CiAgLy8gZGlzYWJsZWQgZm9yIG5vdyB1bnRpbCB3ZSBhZ3JlZSBvbiBwdWJsaWMgbmFtZQogIC8vJ2Fubm90YXRlJzogYW5ub3RhdGUsCiAgJ2VsZW1lbnQnOiBqcUxpdGUsCiAgJ2NvbXBpbGUnOiBjb21waWxlLAogICdzY29wZSc6IGNyZWF0ZVNjb3BlLAogICdjb3B5JzogY29weSwKICAnZXh0ZW5kJzogZXh0ZW5kLAogICdlcXVhbHMnOiBlcXVhbHMsCiAgJ2ZvckVhY2gnOiBmb3JFYWNoLAogICdpbmplY3Rvcic6IGNyZWF0ZUluamVjdG9yLAogICdub29wJzpub29wLAogICdiaW5kJzpiaW5kLAogICd0b0pzb24nOiB0b0pzb24sCiAgJ2Zyb21Kc29uJzogZnJvbUpzb24sCiAgJ2lkZW50aXR5JzppZGVudGl0eSwKICAnaXNVbmRlZmluZWQnOiBpc1VuZGVmaW5lZCwKICAnaXNEZWZpbmVkJzogaXNEZWZpbmVkLAogICdpc1N0cmluZyc6IGlzU3RyaW5nLAogICdpc0Z1bmN0aW9uJzogaXNGdW5jdGlvbiwKICAnaXNPYmplY3QnOiBpc09iamVjdCwKICAnaXNOdW1iZXInOiBpc051bWJlciwKICAnaXNBcnJheSc6IGlzQXJyYXksCiAgJ3ZlcnNpb24nOiB2ZXJzaW9uCn0pOwoKLy90cnkgdG8gYmluZCB0byBqcXVlcnkgbm93IHNvIHRoYXQgb25lIGNhbiB3cml0ZSBhbmd1bGFyLmVsZW1lbnQoKS5yZWFkKCkKLy9idXQgd2Ugd2lsbCByZWJpbmQgb24gYm9vdHN0cmFwIGFnYWluLgpiaW5kSlF1ZXJ5KCk7CgoKJ3VzZSBzdHJpY3QnOwoKCi8qKgogKiBTZXR1cCBmaWxlIGZvciB0aGUgU2NlbmFyaW8uCiAqIE11c3QgYmUgZmlyc3QgaW4gdGhlIGNvbXBpbGF0aW9uL2Jvb3RzdHJhcCBsaXN0LgogKi8KCi8vIFB1YmxpYyBuYW1lc3BhY2UKYW5ndWxhci5zY2VuYXJpbyA9IGFuZ3VsYXIuc2NlbmFyaW8gfHwge307CgovKioKICogRGVmaW5lcyBhIG5ldyBvdXRwdXQgZm9ybWF0LgogKgogKiBAcGFyYW0ge3N0cmluZ30gbmFtZSB0aGUgbmFtZSBvZiB0aGUgbmV3IG91dHB1dCBmb3JtYXQKICogQHBhcmFtIHtGdW5jdGlvbn0gZm4gZnVuY3Rpb24oY29udGV4dCwgcnVubmVyKSB0aGF0IGdlbmVyYXRlcyB0aGUgb3V0cHV0CiAqLwphbmd1bGFyLnNjZW5hcmlvLm91dHB1dCA9IGFuZ3VsYXIuc2NlbmFyaW8ub3V0cHV0IHx8IGZ1bmN0aW9uKG5hbWUsIGZuKSB7CiAgYW5ndWxhci5zY2VuYXJpby5vdXRwdXRbbmFtZV0gPSBmbjsKfTsKCi8qKgogKiBEZWZpbmVzIGEgbmV3IERTTCBzdGF0ZW1lbnQuIElmIHlvdXIgZmFjdG9yeSBmdW5jdGlvbiByZXR1cm5zIGEgRnV0dXJlCiAqIGl0J3MgcmV0dXJuZWQsIG90aGVyd2lzZSB0aGUgcmVzdWx0IGlzIGFzc3VtZWQgdG8gYmUgYSBtYXAgb2YgZnVuY3Rpb25zCiAqIGZvciBjaGFpbmluZy4gQ2hhaW5lZCBmdW5jdGlvbnMgYXJlIHN1YmplY3QgdG8gdGhlIHNhbWUgcnVsZXMuCiAqCiAqIE5vdGU6IEFsbCBmdW5jdGlvbnMgb24gdGhlIGNoYWluIGFyZSBib3VuZCB0byB0aGUgY2hhaW4gc2NvcGUgc28gdmFsdWVzCiAqICAgc2V0IG9uICJ0aGlzIiBpbiB5b3VyIHN0YXRlbWVudCBmdW5jdGlvbiBhcmUgYXZhaWxhYmxlIGluIHRoZSBjaGFpbmVkCiAqICAgZnVuY3Rpb25zLgogKgogKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBUaGUgbmFtZSBvZiB0aGUgc3RhdGVtZW50CiAqIEBwYXJhbSB7RnVuY3Rpb259IGZuIEZhY3RvcnkgZnVuY3Rpb24oKSwgcmV0dXJuIGEgZnVuY3Rpb24gZm9yCiAqICB0aGUgc3RhdGVtZW50LgogKi8KYW5ndWxhci5zY2VuYXJpby5kc2wgPSBhbmd1bGFyLnNjZW5hcmlvLmRzbCB8fCBmdW5jdGlvbihuYW1lLCBmbikgewogIGFuZ3VsYXIuc2NlbmFyaW8uZHNsW25hbWVdID0gZnVuY3Rpb24oKSB7CiAgICBmdW5jdGlvbiBleGVjdXRlU3RhdGVtZW50KHN0YXRlbWVudCwgYXJncykgewogICAgICB2YXIgcmVzdWx0ID0gc3RhdGVtZW50LmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgICBpZiAoYW5ndWxhci5pc0Z1bmN0aW9uKHJlc3VsdCkgfHwgcmVzdWx0IGluc3RhbmNlb2YgYW5ndWxhci5zY2VuYXJpby5GdXR1cmUpCiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICB2YXIgY2hhaW4gPSBhbmd1bGFyLmV4dGVuZCh7fSwgcmVzdWx0KTsKICAgICAgYW5ndWxhci5mb3JFYWNoKGNoYWluLCBmdW5jdGlvbih2YWx1ZSwgbmFtZSkgewogICAgICAgIGlmIChhbmd1bGFyLmlzRnVuY3Rpb24odmFsdWUpKSB7CiAgICAgICAgICBjaGFpbltuYW1lXSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gZXhlY3V0ZVN0YXRlbWVudC5jYWxsKHNlbGYsIHZhbHVlLCBhcmd1bWVudHMpOwogICAgICAgICAgfTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY2hhaW5bbmFtZV0gPSB2YWx1ZTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICByZXR1cm4gY2hhaW47CiAgICB9CiAgICB2YXIgc3RhdGVtZW50ID0gZm4uYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIGV4ZWN1dGVTdGF0ZW1lbnQuY2FsbCh0aGlzLCBzdGF0ZW1lbnQsIGFyZ3VtZW50cyk7CiAgICB9OwogIH07Cn07CgovKioKICogRGVmaW5lcyBhIG5ldyBtYXRjaGVyIGZvciB1c2Ugd2l0aCB0aGUgZXhwZWN0cygpIHN0YXRlbWVudC4gVGhlIHZhbHVlCiAqIHRoaXMuYWN0dWFsIChsaWtlIGluIEphc21pbmUpIGlzIGF2YWlsYWJsZSBpbiB5b3VyIG1hdGNoZXIgdG8gY29tcGFyZQogKiBhZ2FpbnN0LiBZb3VyIGZ1bmN0aW9uIHNob3VsZCByZXR1cm4gYSBib29sZWFuLiBUaGUgZnV0dXJlIGlzIGF1dG9tYXRpY2FsbHkKICogY3JlYXRlZCBmb3IgeW91LgogKgogKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBUaGUgbmFtZSBvZiB0aGUgbWF0Y2hlcgogKiBAcGFyYW0ge0Z1bmN0aW9ufSBmbiBUaGUgbWF0Y2hpbmcgZnVuY3Rpb24oZXhwZWN0ZWQpLgogKi8KYW5ndWxhci5zY2VuYXJpby5tYXRjaGVyID0gYW5ndWxhci5zY2VuYXJpby5tYXRjaGVyIHx8IGZ1bmN0aW9uKG5hbWUsIGZuKSB7CiAgYW5ndWxhci5zY2VuYXJpby5tYXRjaGVyW25hbWVdID0gZnVuY3Rpb24oZXhwZWN0ZWQpIHsKICAgIHZhciBwcmVmaXggPSAnZXhwZWN0ICcgKyB0aGlzLmZ1dHVyZS5uYW1lICsgJyAnOwogICAgaWYgKHRoaXMuaW52ZXJzZSkgewogICAgICBwcmVmaXggKz0gJ25vdCAnOwogICAgfQogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdGhpcy5hZGRGdXR1cmUocHJlZml4ICsgbmFtZSArICcgJyArIGFuZ3VsYXIudG9Kc29uKGV4cGVjdGVkKSwKICAgICAgZnVuY3Rpb24oZG9uZSkgewogICAgICAgIHZhciBlcnJvcjsKICAgICAgICBzZWxmLmFjdHVhbCA9IHNlbGYuZnV0dXJlLnZhbHVlOwogICAgICAgIGlmICgoc2VsZi5pbnZlcnNlICYmIGZuLmNhbGwoc2VsZiwgZXhwZWN0ZWQpKSB8fAogICAgICAgICAgICAoIXNlbGYuaW52ZXJzZSAmJiAhZm4uY2FsbChzZWxmLCBleHBlY3RlZCkpKSB7CiAgICAgICAgICBlcnJvciA9ICdleHBlY3RlZCAnICsgYW5ndWxhci50b0pzb24oZXhwZWN0ZWQpICsKICAgICAgICAgICAgJyBidXQgd2FzICcgKyBhbmd1bGFyLnRvSnNvbihzZWxmLmFjdHVhbCk7CiAgICAgICAgfQogICAgICAgIGRvbmUoZXJyb3IpOwogICAgfSk7CiAgfTsKfTsKCi8qKgogKiBJbml0aWFsaXplIHRoZSBzY2VuYXJpbyBydW5uZXIgYW5kIHJ1biAhCiAqCiAqIEFjY2VzcyBnbG9iYWwgd2luZG93IGFuZCBkb2N1bWVudCBvYmplY3QKICogQWNjZXNzICRydW5uZXIgdGhyb3VnaCBjbG9zdXJlCiAqCiAqIEBwYXJhbSB7T2JqZWN0PX0gY29uZmlnIENvbmZpZyBvcHRpb25zCiAqLwphbmd1bGFyLnNjZW5hcmlvLnNldFVwQW5kUnVuID0gZnVuY3Rpb24gKGNvbmZpZykgewogIHZhciBocmVmID0gd2luZG93LmxvY2F0aW9uLmhyZWY7CiAgdmFyIGJvZHkgPSBfalF1ZXJ5KGRvY3VtZW50LmJvZHkpOwogIHZhciBvdXRwdXQgPSBbXTsKICB2YXIgb2JqTW9kZWwgPSBuZXcgYW5ndWxhci5zY2VuYXJpby5PYmplY3RNb2RlbCgkcnVubmVyKTsKCiAgaWYgKGNvbmZpZyAmJiBjb25maWcuc2NlbmFyaW9fb3V0cHV0KSB7CiAgICBvdXRwdXQgPSBjb25maWcuc2NlbmFyaW9fb3V0cHV0LnNwbGl0KCcsJyk7CiAgfQoKICBhbmd1bGFyLmZvckVhY2goYW5ndWxhci5zY2VuYXJpby5vdXRwdXQsIGZ1bmN0aW9uKGZuLCBuYW1lKSB7CiAgICBpZiAoIW91dHB1dC5sZW5ndGggfHwgaW5kZXhPZihvdXRwdXQsbmFtZSkgIT0gLTEpIHsKICAgICAgdmFyIGNvbnRleHQgPSBib2R5LmFwcGVuZCgnPGRpdj48L2Rpdj4nKS5maW5kKCdkaXY6bGFzdCcpOwogICAgICBjb250ZXh0LmF0dHIoJ2lkJywgbmFtZSk7CiAgICAgIGZuLmNhbGwoe30sIGNvbnRleHQsICRydW5uZXIsIG9iak1vZGVsKTsKICAgIH0KICB9KTsKCiAgaWYgKCEvXmh0dHAvLnRlc3QoaHJlZikgJiYgIS9eaHR0cHMvLnRlc3QoaHJlZikpIHsKICAgIGJvZHkuYXBwZW5kKCc8cCBpZD0ic3lzdGVtLWVycm9yIj48L3A+Jyk7CiAgICBib2R5LmZpbmQoJyNzeXN0ZW0tZXJyb3InKS50ZXh0KAogICAgICAnU2NlbmFyaW8gcnVubmVyIG11c3QgYmUgcnVuIHVzaW5nIGh0dHAgb3IgaHR0cHMuIFRoZSBwcm90b2NvbCAnICsKICAgICAgaHJlZi5zcGxpdCgnOicpWzBdICsgJzovLyBpcyBub3Qgc3VwcG9ydGVkLicKICAgICk7CiAgICByZXR1cm47CiAgfQoKICB2YXIgYXBwRnJhbWUgPSBib2R5LmFwcGVuZCgnPGRpdiBpZD0iYXBwbGljYXRpb24iPjwvZGl2PicpLmZpbmQoJyNhcHBsaWNhdGlvbicpOwogIHZhciBhcHBsaWNhdGlvbiA9IG5ldyBhbmd1bGFyLnNjZW5hcmlvLkFwcGxpY2F0aW9uKGFwcEZyYW1lKTsKCiAgJHJ1bm5lci5vbignUnVubmVyRW5kJywgZnVuY3Rpb24oKSB7CiAgICBhcHBGcmFtZS5jc3MoJ2Rpc3BsYXknLCAnbm9uZScpOwogICAgYXBwRnJhbWUuZmluZCgnaWZyYW1lJykuYXR0cignc3JjJywgJ2Fib3V0OmJsYW5rJyk7CiAgfSk7CgogICRydW5uZXIub24oJ1J1bm5lckVycm9yJywgZnVuY3Rpb24oZXJyb3IpIHsKICAgIGlmICh3aW5kb3cuY29uc29sZSkgewogICAgICBjb25zb2xlLmxvZyhmb3JtYXRFeGNlcHRpb24oZXJyb3IpKTsKICAgIH0gZWxzZSB7CiAgICAgIC8vIERvIHNvbWV0aGluZyBmb3IgSUUKICAgICAgYWxlcnQoZXJyb3IpOwogICAgfQogIH0pOwoKICAkcnVubmVyLnJ1bihhcHBsaWNhdGlvbik7Cn07CgovKioKICogSXRlcmF0ZXMgdGhyb3VnaCBsaXN0IHdpdGggaXRlcmF0b3IgZnVuY3Rpb24gdGhhdCBtdXN0IGNhbGwgdGhlCiAqIGNvbnRpbnVlRnVuY3Rpb24gdG8gY29udGludXRlIGl0ZXJhdGluZy4KICoKICogQHBhcmFtIHtBcnJheX0gbGlzdCBsaXN0IHRvIGl0ZXJhdGUgb3ZlcgogKiBAcGFyYW0ge0Z1bmN0aW9ufSBpdGVyYXRvciBDYWxsYmFjayBmdW5jdGlvbih2YWx1ZSwgY29udGludWVGdW5jdGlvbikKICogQHBhcmFtIHtGdW5jdGlvbn0gZG9uZSBDYWxsYmFjayBmdW5jdGlvbihlcnJvciwgcmVzdWx0KSBjYWxsZWQgd2hlbgogKiAgIGl0ZXJhdGlvbiBmaW5pc2hlcyBvciBhbiBlcnJvciBvY2N1cnMuCiAqLwpmdW5jdGlvbiBhc3luY0ZvckVhY2gobGlzdCwgaXRlcmF0b3IsIGRvbmUpIHsKICB2YXIgaSA9IDA7CiAgZnVuY3Rpb24gbG9vcChlcnJvciwgaW5kZXgpIHsKICAgIGlmIChpbmRleCAmJiBpbmRleCA+IGkpIHsKICAgICAgaSA9IGluZGV4OwogICAgfQogICAgaWYgKGVycm9yIHx8IGkgPj0gbGlzdC5sZW5ndGgpIHsKICAgICAgZG9uZShlcnJvcik7CiAgICB9IGVsc2UgewogICAgICB0cnkgewogICAgICAgIGl0ZXJhdG9yKGxpc3RbaSsrXSwgbG9vcCk7CiAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICBkb25lKGUpOwogICAgICB9CiAgICB9CiAgfQogIGxvb3AoKTsKfQoKLyoqCiAqIEZvcm1hdHMgYW4gZXhjZXB0aW9uIGludG8gYSBzdHJpbmcgd2l0aCB0aGUgc3RhY2sgdHJhY2UsIGJ1dCBsaW1pdHMKICogdG8gYSBzcGVjaWZpYyBsaW5lIGxlbmd0aC4KICoKICogQHBhcmFtIHtPYmplY3R9IGVycm9yIFRoZSBleGNlcHRpb24gdG8gZm9ybWF0LCBjYW4gYmUgYW55dGhpbmcgdGhyb3dhYmxlCiAqIEBwYXJhbSB7TnVtYmVyfSBtYXhTdGFja0xpbmVzIE9wdGlvbmFsLiBtYXggbGluZXMgb2YgdGhlIHN0YWNrIHRyYWNlIHRvIGluY2x1ZGUKICogIGRlZmF1bHQgaXMgNS4KICovCmZ1bmN0aW9uIGZvcm1hdEV4Y2VwdGlvbihlcnJvciwgbWF4U3RhY2tMaW5lcykgewogIG1heFN0YWNrTGluZXMgPSBtYXhTdGFja0xpbmVzIHx8IDU7CiAgdmFyIG1lc3NhZ2UgPSBlcnJvci50b1N0cmluZygpOwogIGlmIChlcnJvci5zdGFjaykgewogICAgdmFyIHN0YWNrID0gZXJyb3Iuc3RhY2suc3BsaXQoJ1xuJyk7CiAgICBpZiAoc3RhY2tbMF0uaW5kZXhPZihtZXNzYWdlKSA9PT0gLTEpIHsKICAgICAgbWF4U3RhY2tMaW5lcysrOwogICAgICBzdGFjay51bnNoaWZ0KGVycm9yLm1lc3NhZ2UpOwogICAgfQogICAgbWVzc2FnZSA9IHN0YWNrLnNsaWNlKDAsIG1heFN0YWNrTGluZXMpLmpvaW4oJ1xuJyk7CiAgfQogIHJldHVybiBtZXNzYWdlOwp9CgovKioKICogUmV0dXJucyBhIGZ1bmN0aW9uIHRoYXQgZ2V0cyB0aGUgZmlsZSBuYW1lIGFuZCBsaW5lIG51bWJlciBmcm9tIGEKICogbG9jYXRpb24gaW4gdGhlIHN0YWNrIGlmIGF2YWlsYWJsZSBiYXNlZCBvbiB0aGUgY2FsbCBzaXRlLgogKgogKiBOb3RlOiB0aGlzIHJldHVybnMgYW5vdGhlciBmdW5jdGlvbiBiZWNhdXNlIGFjY2Vzc2luZyAuc3RhY2sgaXMgdmVyeQogKiBleHBlbnNpdmUgaW4gQ2hyb21lLgogKgogKiBAcGFyYW0ge051bWJlcn0gb2Zmc2V0IE51bWJlciBvZiBzdGFjayBsaW5lcyB0byBza2lwCiAqLwpmdW5jdGlvbiBjYWxsZXJGaWxlKG9mZnNldCkgewogIHZhciBlcnJvciA9IG5ldyBFcnJvcigpOwoKICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICB2YXIgbGluZSA9IChlcnJvci5zdGFjayB8fCAnJykuc3BsaXQoJ1xuJylbb2Zmc2V0XTsKCiAgICAvLyBDbGVhbiB1cCB0aGUgc3RhY2sgdHJhY2UgbGluZQogICAgaWYgKGxpbmUpIHsKICAgICAgaWYgKGxpbmUuaW5kZXhPZignQCcpICE9PSAtMSkgewogICAgICAgIC8vIEZpcmVmb3gKICAgICAgICBsaW5lID0gbGluZS5zdWJzdHJpbmcobGluZS5pbmRleE9mKCdAJykrMSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gQ2hyb21lCiAgICAgICAgbGluZSA9IGxpbmUuc3Vic3RyaW5nKGxpbmUuaW5kZXhPZignKCcpKzEpLnJlcGxhY2UoJyknLCAnJyk7CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gbGluZSB8fCAnJzsKICB9Owp9CgovKioKICogVHJpZ2dlcnMgYSBicm93c2VyIGV2ZW50LiBBdHRlbXB0cyB0byBjaG9vc2UgdGhlIHJpZ2h0IGV2ZW50IGlmIG9uZSBpcwogKiBub3Qgc3BlY2lmaWVkLgogKgogKiBAcGFyYW0ge09iamVjdH0gRWl0aGVyIGEgd3JhcHBlZCBqUXVlcnkvanFMaXRlIG5vZGUgb3IgYSBET01FbGVtZW50CiAqIEBwYXJhbSB7c3RyaW5nfSBPcHRpb25hbCBldmVudCB0eXBlLgogKi8KZnVuY3Rpb24gYnJvd3NlclRyaWdnZXIoZWxlbWVudCwgdHlwZSkgewogIGlmIChlbGVtZW50ICYmICFlbGVtZW50Lm5vZGVOYW1lKSBlbGVtZW50ID0gZWxlbWVudFswXTsKICBpZiAoIWVsZW1lbnQpIHJldHVybjsKICBpZiAoIXR5cGUpIHsKICAgIHR5cGUgPSB7CiAgICAgICAgJ3RleHQnOiAgICAgICAgICAgICdjaGFuZ2UnLAogICAgICAgICd0ZXh0YXJlYSc6ICAgICAgICAnY2hhbmdlJywKICAgICAgICAnaGlkZGVuJzogICAgICAgICAgJ2NoYW5nZScsCiAgICAgICAgJ3Bhc3N3b3JkJzogICAgICAgICdjaGFuZ2UnLAogICAgICAgICdidXR0b24nOiAgICAgICAgICAnY2xpY2snLAogICAgICAgICdzdWJtaXQnOiAgICAgICAgICAnY2xpY2snLAogICAgICAgICdyZXNldCc6ICAgICAgICAgICAnY2xpY2snLAogICAgICAgICdpbWFnZSc6ICAgICAgICAgICAnY2xpY2snLAogICAgICAgICdjaGVja2JveCc6ICAgICAgICAnY2xpY2snLAogICAgICAgICdyYWRpbyc6ICAgICAgICAgICAnY2xpY2snLAogICAgICAgICdzZWxlY3Qtb25lJzogICAgICAnY2hhbmdlJywKICAgICAgICAnc2VsZWN0LW11bHRpcGxlJzogJ2NoYW5nZScKICAgIH1bZWxlbWVudC50eXBlXSB8fCAnY2xpY2snOwogIH0KICBpZiAobG93ZXJjYXNlKG5vZGVOYW1lXyhlbGVtZW50KSkgPT0gJ29wdGlvbicpIHsKICAgIGVsZW1lbnQucGFyZW50Tm9kZS52YWx1ZSA9IGVsZW1lbnQudmFsdWU7CiAgICBlbGVtZW50ID0gZWxlbWVudC5wYXJlbnROb2RlOwogICAgdHlwZSA9ICdjaGFuZ2UnOwogIH0KICBpZiAobXNpZSA8IDkpIHsKICAgIHN3aXRjaChlbGVtZW50LnR5cGUpIHsKICAgICAgY2FzZSAncmFkaW8nOgogICAgICBjYXNlICdjaGVja2JveCc6CiAgICAgICAgZWxlbWVudC5jaGVja2VkID0gIWVsZW1lbnQuY2hlY2tlZDsKICAgICAgICBicmVhazsKICAgIH0KICAgIC8vIFdURiEhISBFcnJvcjogVW5zcGVjaWZpZWQgZXJyb3IuCiAgICAvLyBEb24ndCBrbm93IHdoeSwgYnV0IHNvbWUgZWxlbWVudHMgd2hlbiBkZXRhY2hlZCBzZWVtIHRvIGJlIGluIGluY29uc2lzdGVudCBzdGF0ZSBhbmQKICAgIC8vIGNhbGxpbmcgLmZpcmVFdmVudCgpIG9uIHRoZW0gd2lsbCByZXN1bHQgaW4gdmVyeSB1bmhlbHBmdWwgZXJyb3IgKEVycm9yOiBVbnNwZWNpZmllZCBlcnJvcikKICAgIC8vIGZvcmNpbmcgdGhlIGJyb3dzZXIgdG8gY29tcHV0ZSB0aGUgZWxlbWVudCBwb3NpdGlvbiAoYnkgcmVhZGluZyBpdHMgQ1NTKQogICAgLy8gcHV0cyB0aGUgZWxlbWVudCBpbiBjb25zaXN0ZW50IHN0YXRlLgogICAgZWxlbWVudC5zdHlsZS5wb3NMZWZ0OwogICAgZWxlbWVudC5maXJlRXZlbnQoJ29uJyArIHR5cGUpOwogICAgaWYgKGxvd2VyY2FzZShlbGVtZW50LnR5cGUpID09ICdzdWJtaXQnKSB7CiAgICAgIHdoaWxlKGVsZW1lbnQpIHsKICAgICAgICBpZiAobG93ZXJjYXNlKGVsZW1lbnQubm9kZU5hbWUpID09ICdmb3JtJykgewogICAgICAgICAgZWxlbWVudC5maXJlRXZlbnQoJ29uc3VibWl0Jyk7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgICAgZWxlbWVudCA9IGVsZW1lbnQucGFyZW50Tm9kZTsKICAgICAgfQogICAgfQogIH0gZWxzZSB7CiAgICB2YXIgZXZudCA9IGRvY3VtZW50LmNyZWF0ZUV2ZW50KCdNb3VzZUV2ZW50cycpOwogICAgZXZudC5pbml0TW91c2VFdmVudCh0eXBlLCB0cnVlLCB0cnVlLCB3aW5kb3csIDAsIDAsIDAsIDAsIDAsIGZhbHNlLCBmYWxzZSwgZmFsc2UsIGZhbHNlLCAwLCBlbGVtZW50KTsKICAgIGVsZW1lbnQuZGlzcGF0Y2hFdmVudChldm50KTsKICB9Cn0KCi8qKgogKiBEb24ndCB1c2UgdGhlIGpRdWVyeSB0cmlnZ2VyIG1ldGhvZCBzaW5jZSBpdCB3b3JrcyBpbmNvcnJlY3RseS4KICoKICogalF1ZXJ5IG5vdGlmaWVzIGxpc3RlbmVycyBhbmQgdGhlbiBjaGFuZ2VzIHRoZSBzdGF0ZSBvZiBhIGNoZWNrYm94IGFuZAogKiBkb2VzIG5vdCBjcmVhdGUgYSByZWFsIGJyb3dzZXIgZXZlbnQuIEEgcmVhbCBjbGljayBjaGFuZ2VzIHRoZSBzdGF0ZSBvZgogKiB0aGUgY2hlY2tib3ggYW5kIHRoZW4gbm90aWZpZXMgbGlzdGVuZXJzLgogKgogKiBUbyB3b3JrIGFyb3VuZCB0aGlzIHdlIGluc3RlYWQgdXNlIG91ciBvd24gaGFuZGxlciB0aGF0IGZpcmVzIGEgcmVhbCBldmVudC4KICovCihmdW5jdGlvbihmbil7CiAgdmFyIHBhcmVudFRyaWdnZXIgPSBmbi50cmlnZ2VyOwogIGZuLnRyaWdnZXIgPSBmdW5jdGlvbih0eXBlKSB7CiAgICBpZiAoLyhjbGlja3xjaGFuZ2V8a2V5ZG93bikvLnRlc3QodHlwZSkpIHsKICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbihpbmRleCwgbm9kZSkgewogICAgICAgIGJyb3dzZXJUcmlnZ2VyKG5vZGUsIHR5cGUpOwogICAgICB9KTsKICAgIH0KICAgIHJldHVybiBwYXJlbnRUcmlnZ2VyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgfTsKfSkoX2pRdWVyeS5mbik7CgovKioKICogRmluZHMgYWxsIGJpbmRpbmdzIHdpdGggdGhlIHN1YnN0cmluZyBtYXRjaCBvZiBuYW1lIGFuZCByZXR1cm5zIGFuCiAqIGFycmF5IG9mIHRoZWlyIHZhbHVlcy4KICoKICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgVGhlIG5hbWUgdG8gbWF0Y2gKICogQHJldHVybiB7QXJyYXkuPHN0cmluZz59IFN0cmluZyBvZiBiaW5kaW5nIHZhbHVlcwogKi8KX2pRdWVyeS5mbi5iaW5kaW5ncyA9IGZ1bmN0aW9uKG5hbWUpIHsKICBmdW5jdGlvbiBjb250YWlucyh0ZXh0LCB2YWx1ZSkgewogICAgcmV0dXJuIHZhbHVlIGluc3RhbmNlb2YgUmVnRXhwCiAgICAgID8gdmFsdWUudGVzdCh0ZXh0KQogICAgICA6IHRleHQgJiYgdGV4dC5pbmRleE9mKHZhbHVlKSA+PSAwOwogIH0KICB2YXIgcmVzdWx0ID0gW107CiAgdGhpcy5maW5kKCcubmctYmluZGluZzp2aXNpYmxlJykuZWFjaChmdW5jdGlvbigpIHsKICAgIHZhciBlbGVtZW50ID0gbmV3IF9qUXVlcnkodGhpcyk7CiAgICBpZiAoIWFuZ3VsYXIuaXNEZWZpbmVkKG5hbWUpIHx8CiAgICAgIGNvbnRhaW5zKGVsZW1lbnQuYXR0cignbmc6YmluZCcpLCBuYW1lKSB8fAogICAgICBjb250YWlucyhlbGVtZW50LmF0dHIoJ25nOmJpbmQtdGVtcGxhdGUnKSwgbmFtZSkpIHsKICAgICAgaWYgKGVsZW1lbnQuaXMoJ2lucHV0LCB0ZXh0YXJlYScpKSB7CiAgICAgICAgcmVzdWx0LnB1c2goZWxlbWVudC52YWwoKSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmVzdWx0LnB1c2goZWxlbWVudC5odG1sKCkpOwogICAgICB9CiAgICB9CiAgfSk7CiAgcmV0dXJuIHJlc3VsdDsKfTsKJ3VzZSBzdHJpY3QnOwoKLyoqCiAqIFJlcHJlc2VudHMgdGhlIGFwcGxpY2F0aW9uIGN1cnJlbnRseSBiZWluZyB0ZXN0ZWQgYW5kIGFic3RyYWN0cyB1c2FnZQogKiBvZiBpZnJhbWVzIG9yIHNlcGFyYXRlIHdpbmRvd3MuCiAqCiAqIEBwYXJhbSB7T2JqZWN0fSBjb250ZXh0IGpRdWVyeSB3cmFwcGVyIGFyb3VuZCBIVE1MIGNvbnRleHQuCiAqLwphbmd1bGFyLnNjZW5hcmlvLkFwcGxpY2F0aW9uID0gZnVuY3Rpb24oY29udGV4dCkgewogIHRoaXMuY29udGV4dCA9IGNvbnRleHQ7CiAgY29udGV4dC5hcHBlbmQoCiAgICAnPGgyPkN1cnJlbnQgVVJMOiA8YSBocmVmPSJhYm91dDpibGFuayI+Tm9uZTwvYT48L2gyPicgKwogICAgJzxkaXYgaWQ9InRlc3QtZnJhbWVzIj48L2Rpdj4nCiAgKTsKfTsKCi8qKgogKiBHZXRzIHRoZSBqUXVlcnkgY29sbGVjdGlvbiBvZiBmcmFtZXMuIERvbid0IHVzZSB0aGlzIGRpcmVjdGx5IGJlY2F1c2UKICogZnJhbWVzIG1heSBnbyBzdGFsZS4KICoKICogQHByaXZhdGUKICogQHJldHVybiB7T2JqZWN0fSBqUXVlcnkgY29sbGVjdGlvbgogKi8KYW5ndWxhci5zY2VuYXJpby5BcHBsaWNhdGlvbi5wcm90b3R5cGUuZ2V0RnJhbWVfID0gZnVuY3Rpb24oKSB7CiAgcmV0dXJuIHRoaXMuY29udGV4dC5maW5kKCcjdGVzdC1mcmFtZXMgaWZyYW1lOmxhc3QnKTsKfTsKCi8qKgogKiBHZXRzIHRoZSB3aW5kb3cgb2YgdGhlIHRlc3QgcnVubmVyIGZyYW1lLiBBbHdheXMgZmF2b3IgZXhlY3V0ZUFjdGlvbigpCiAqIGluc3RlYWQgb2YgdGhpcyBtZXRob2Qgc2luY2UgaXQgcHJldmVudHMgeW91IGZyb20gZ2V0dGluZyBhIHN0YWxlIHdpbmRvdy4KICoKICogQHByaXZhdGUKICogQHJldHVybiB7T2JqZWN0fSB0aGUgd2luZG93IG9mIHRoZSBmcmFtZQogKi8KYW5ndWxhci5zY2VuYXJpby5BcHBsaWNhdGlvbi5wcm90b3R5cGUuZ2V0V2luZG93XyA9IGZ1bmN0aW9uKCkgewogIHZhciBjb250ZW50V2luZG93ID0gdGhpcy5nZXRGcmFtZV8oKS5hdHRyKCdjb250ZW50V2luZG93Jyk7CiAgaWYgKCFjb250ZW50V2luZG93KQogICAgdGhyb3cgJ0ZyYW1lIHdpbmRvdyBpcyBub3QgYWNjZXNzaWJsZS4nOwogIHJldHVybiBjb250ZW50V2luZG93Owp9OwoKLyoqCiAqIENoYW5nZXMgdGhlIGxvY2F0aW9uIG9mIHRoZSBmcmFtZS4KICoKICogQHBhcmFtIHtzdHJpbmd9IHVybCBUaGUgVVJMLiBJZiBpdCBiZWdpbnMgd2l0aCBhICMgdGhlbiBvbmx5IHRoZQogKiAgIGhhc2ggb2YgdGhlIHBhZ2UgaXMgY2hhbmdlZC4KICogQHBhcmFtIHtGdW5jdGlvbn0gbG9hZEZuIGZ1bmN0aW9uKCR3aW5kb3csICRkb2N1bWVudCkgQ2FsbGVkIHdoZW4gZnJhbWUgbG9hZHMuCiAqIEBwYXJhbSB7RnVuY3Rpb259IGVycm9yRm4gZnVuY3Rpb24oZXJyb3IpIENhbGxlZCBpZiBhbnkgZXJyb3Igd2hlbiBsb2FkaW5nLgogKi8KYW5ndWxhci5zY2VuYXJpby5BcHBsaWNhdGlvbi5wcm90b3R5cGUubmF2aWdhdGVUbyA9IGZ1bmN0aW9uKHVybCwgbG9hZEZuLCBlcnJvckZuKSB7CiAgdmFyIHNlbGYgPSB0aGlzOwogIHZhciBmcmFtZSA9IHRoaXMuZ2V0RnJhbWVfKCk7CiAgLy9UT0RPKGVzcHJlaG4pOiBSZWZhY3RvciB0byB1c2UgcmV0aHJvdygpCiAgZXJyb3JGbiA9IGVycm9yRm4gfHwgZnVuY3Rpb24oZSkgeyB0aHJvdyBlOyB9OwogIGlmICh1cmwgPT09ICdhYm91dDpibGFuaycpIHsKICAgIGVycm9yRm4oJ1NhbmRib3ggRXJyb3I6IE5hdmlnYXRpbmcgdG8gYWJvdXQ6YmxhbmsgaXMgbm90IGFsbG93ZWQuJyk7CiAgfSBlbHNlIGlmICh1cmwuY2hhckF0KDApID09PSAnIycpIHsKICAgIHVybCA9IGZyYW1lLmF0dHIoJ3NyYycpLnNwbGl0KCcjJylbMF0gKyB1cmw7CiAgICBmcmFtZS5hdHRyKCdzcmMnLCB1cmwpOwogICAgdGhpcy5leGVjdXRlQWN0aW9uKGxvYWRGbik7CiAgfSBlbHNlIHsKICAgIGZyYW1lLnJlbW92ZSgpOwogICAgdGhpcy5jb250ZXh0LmZpbmQoJyN0ZXN0LWZyYW1lcycpLmFwcGVuZCgnPGlmcmFtZT4nKTsKICAgIGZyYW1lID0gdGhpcy5nZXRGcmFtZV8oKTsKICAgIGZyYW1lLmxvYWQoZnVuY3Rpb24oKSB7CiAgICAgIGZyYW1lLnVuYmluZCgpOwogICAgICB0cnkgewogICAgICAgIHNlbGYuZXhlY3V0ZUFjdGlvbihsb2FkRm4pOwogICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgZXJyb3JGbihlKTsKICAgICAgfQogICAgfSkuYXR0cignc3JjJywgdXJsKTsKICB9CiAgdGhpcy5jb250ZXh0LmZpbmQoJz4gaDIgYScpLmF0dHIoJ2hyZWYnLCB1cmwpLnRleHQodXJsKTsKfTsKCi8qKgogKiBFeGVjdXRlcyBhIGZ1bmN0aW9uIGluIHRoZSBjb250ZXh0IG9mIHRoZSB0ZXN0ZWQgYXBwbGljYXRpb24uIFdpbGwgd2FpdAogKiBmb3IgYWxsIHBlbmRpbmcgYW5ndWxhciB4aHIgcmVxdWVzdHMgYmVmb3JlIGV4ZWN1dGluZy4KICoKICogQHBhcmFtIHtGdW5jdGlvbn0gYWN0aW9uIFRoZSBjYWxsYmFjayB0byBleGVjdXRlLiBmdW5jdGlvbigkd2luZG93LCAkZG9jdW1lbnQpCiAqICAkZG9jdW1lbnQgaXMgYSBqUXVlcnkgd3JhcHBlZCBkb2N1bWVudC4KICovCmFuZ3VsYXIuc2NlbmFyaW8uQXBwbGljYXRpb24ucHJvdG90eXBlLmV4ZWN1dGVBY3Rpb24gPSBmdW5jdGlvbihhY3Rpb24pIHsKICB2YXIgc2VsZiA9IHRoaXM7CiAgdmFyICR3aW5kb3cgPSB0aGlzLmdldFdpbmRvd18oKTsKICBpZiAoISR3aW5kb3cuZG9jdW1lbnQpIHsKICAgIHRocm93ICdTYW5kYm94IEVycm9yOiBBcHBsaWNhdGlvbiBkb2N1bWVudCBub3QgYWNjZXNzaWJsZS4nOwogIH0KICBpZiAoISR3aW5kb3cuYW5ndWxhcikgewogICAgcmV0dXJuIGFjdGlvbi5jYWxsKHRoaXMsICR3aW5kb3csIF9qUXVlcnkoJHdpbmRvdy5kb2N1bWVudCkpOwogIH0KICB2YXIgJGJyb3dzZXIgPSAkd2luZG93LmFuZ3VsYXIuc2VydmljZS4kYnJvd3NlcigpOwogICRicm93c2VyLm5vdGlmeVdoZW5Ob091dHN0YW5kaW5nUmVxdWVzdHMoZnVuY3Rpb24oKSB7CiAgICBhY3Rpb24uY2FsbChzZWxmLCAkd2luZG93LCBfalF1ZXJ5KCR3aW5kb3cuZG9jdW1lbnQpKTsKICB9KTsKfTsKJ3VzZSBzdHJpY3QnOwoKLyoqCiAqIFRoZSByZXByZXNlbnRhdGlvbiBvZiBkZWZpbmUgYmxvY2tzLiBEb24ndCB1c2VkIGRpcmVjdGx5LCBpbnN0ZWFkIHVzZQogKiBkZWZpbmUoKSBpbiB5b3VyIHRlc3RzLgogKgogKiBAcGFyYW0ge3N0cmluZ30gZGVzY05hbWUgTmFtZSBvZiB0aGUgYmxvY2sKICogQHBhcmFtIHtPYmplY3R9IHBhcmVudCBkZXNjcmliZSBvciB1bmRlZmluZWQgaWYgdGhlIHJvb3QuCiAqLwphbmd1bGFyLnNjZW5hcmlvLkRlc2NyaWJlID0gZnVuY3Rpb24oZGVzY05hbWUsIHBhcmVudCkgewogIHRoaXMub25seSA9IHBhcmVudCAmJiBwYXJlbnQub25seTsKICB0aGlzLmJlZm9yZUVhY2hGbnMgPSBbXTsKICB0aGlzLmFmdGVyRWFjaEZucyA9IFtdOwogIHRoaXMuaXRzID0gW107CiAgdGhpcy5jaGlsZHJlbiA9IFtdOwogIHRoaXMubmFtZSA9IGRlc2NOYW1lOwogIHRoaXMucGFyZW50ID0gcGFyZW50OwogIHRoaXMuaWQgPSBhbmd1bGFyLnNjZW5hcmlvLkRlc2NyaWJlLmlkKys7CgogIC8qKgogICAqIENhbGxzIGFsbCBiZWZvcmUgZnVuY3Rpb25zLgogICAqLwogIHZhciBiZWZvcmVFYWNoRm5zID0gdGhpcy5iZWZvcmVFYWNoRm5zOwogIHRoaXMuc2V0dXBCZWZvcmUgPSBmdW5jdGlvbigpIHsKICAgIGlmIChwYXJlbnQpIHBhcmVudC5zZXR1cEJlZm9yZS5jYWxsKHRoaXMpOwogICAgYW5ndWxhci5mb3JFYWNoKGJlZm9yZUVhY2hGbnMsIGZ1bmN0aW9uKGZuKSB7IGZuLmNhbGwodGhpcyk7IH0sIHRoaXMpOwogIH07CgogIC8qKgogICAqIENhbGxzIGFsbCBhZnRlciBmdW5jdGlvbnMuCiAgICovCiAgdmFyIGFmdGVyRWFjaEZucyA9IHRoaXMuYWZ0ZXJFYWNoRm5zOwogIHRoaXMuc2V0dXBBZnRlciAgPSBmdW5jdGlvbigpIHsKICAgIGFuZ3VsYXIuZm9yRWFjaChhZnRlckVhY2hGbnMsIGZ1bmN0aW9uKGZuKSB7IGZuLmNhbGwodGhpcyk7IH0sIHRoaXMpOwogICAgaWYgKHBhcmVudCkgcGFyZW50LnNldHVwQWZ0ZXIuY2FsbCh0aGlzKTsKICB9Owp9OwoKLy8gU2hhcmVkIFVuaXF1ZSBJRCBnZW5lcmF0b3IgZm9yIGV2ZXJ5IGRlc2NyaWJlIGJsb2NrCmFuZ3VsYXIuc2NlbmFyaW8uRGVzY3JpYmUuaWQgPSAwOwoKLy8gU2hhcmVkIFVuaXF1ZSBJRCBnZW5lcmF0b3IgZm9yIGV2ZXJ5IGl0IChzcGVjKQphbmd1bGFyLnNjZW5hcmlvLkRlc2NyaWJlLnNwZWNJZCA9IDA7CgovKioKICogRGVmaW5lcyBhIGJsb2NrIHRvIGV4ZWN1dGUgYmVmb3JlIGVhY2ggaXQgb3IgbmVzdGVkIGRlc2NyaWJlLgogKgogKiBAcGFyYW0ge0Z1bmN0aW9ufSBib2R5IEJvZHkgb2YgdGhlIGJsb2NrLgogKi8KYW5ndWxhci5zY2VuYXJpby5EZXNjcmliZS5wcm90b3R5cGUuYmVmb3JlRWFjaCA9IGZ1bmN0aW9uKGJvZHkpIHsKICB0aGlzLmJlZm9yZUVhY2hGbnMucHVzaChib2R5KTsKfTsKCi8qKgogKiBEZWZpbmVzIGEgYmxvY2sgdG8gZXhlY3V0ZSBhZnRlciBlYWNoIGl0IG9yIG5lc3RlZCBkZXNjcmliZS4KICoKICogQHBhcmFtIHtGdW5jdGlvbn0gYm9keSBCb2R5IG9mIHRoZSBibG9jay4KICovCmFuZ3VsYXIuc2NlbmFyaW8uRGVzY3JpYmUucHJvdG90eXBlLmFmdGVyRWFjaCA9IGZ1bmN0aW9uKGJvZHkpIHsKICB0aGlzLmFmdGVyRWFjaEZucy5wdXNoKGJvZHkpOwp9OwoKLyoqCiAqIENyZWF0ZXMgYSBuZXcgZGVzY3JpYmUgYmxvY2sgdGhhdCdzIGEgY2hpbGQgb2YgdGhpcyBvbmUuCiAqCiAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIE5hbWUgb2YgdGhlIGJsb2NrLiBBcHBlbmRlZCB0byB0aGUgcGFyZW50IGJsb2NrJ3MgbmFtZS4KICogQHBhcmFtIHtGdW5jdGlvbn0gYm9keSBCb2R5IG9mIHRoZSBibG9jay4KICovCmFuZ3VsYXIuc2NlbmFyaW8uRGVzY3JpYmUucHJvdG90eXBlLmRlc2NyaWJlID0gZnVuY3Rpb24obmFtZSwgYm9keSkgewogIHZhciBjaGlsZCA9IG5ldyBhbmd1bGFyLnNjZW5hcmlvLkRlc2NyaWJlKG5hbWUsIHRoaXMpOwogIHRoaXMuY2hpbGRyZW4ucHVzaChjaGlsZCk7CiAgYm9keS5jYWxsKGNoaWxkKTsKfTsKCi8qKgogKiBTYW1lIGFzIGRlc2NyaWJlKCkgYnV0IG1ha2VzIGRkZXNjcmliZSBibG9ja3MgdGhlIG9ubHkgdG8gcnVuLgogKgogKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBOYW1lIG9mIHRoZSB0ZXN0LgogKiBAcGFyYW0ge0Z1bmN0aW9ufSBib2R5IEJvZHkgb2YgdGhlIGJsb2NrLgogKi8KYW5ndWxhci5zY2VuYXJpby5EZXNjcmliZS5wcm90b3R5cGUuZGRlc2NyaWJlID0gZnVuY3Rpb24obmFtZSwgYm9keSkgewogIHZhciBjaGlsZCA9IG5ldyBhbmd1bGFyLnNjZW5hcmlvLkRlc2NyaWJlKG5hbWUsIHRoaXMpOwogIGNoaWxkLm9ubHkgPSB0cnVlOwogIHRoaXMuY2hpbGRyZW4ucHVzaChjaGlsZCk7CiAgYm9keS5jYWxsKGNoaWxkKTsKfTsKCi8qKgogKiBVc2UgdG8gZGlzYWJsZSBhIGRlc2NyaWJlIGJsb2NrLgogKi8KYW5ndWxhci5zY2VuYXJpby5EZXNjcmliZS5wcm90b3R5cGUueGRlc2NyaWJlID0gYW5ndWxhci5ub29wOwoKLyoqCiAqIERlZmluZXMgYSB0ZXN0LgogKgogKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBOYW1lIG9mIHRoZSB0ZXN0LgogKiBAcGFyYW0ge0Z1bmN0aW9ufSB2b2R5IEJvZHkgb2YgdGhlIGJsb2NrLgogKi8KYW5ndWxhci5zY2VuYXJpby5EZXNjcmliZS5wcm90b3R5cGUuaXQgPSBmdW5jdGlvbihuYW1lLCBib2R5KSB7CiAgdGhpcy5pdHMucHVzaCh7CiAgICBpZDogYW5ndWxhci5zY2VuYXJpby5EZXNjcmliZS5zcGVjSWQrKywKICAgIGRlZmluaXRpb246IHRoaXMsCiAgICBvbmx5OiB0aGlzLm9ubHksCiAgICBuYW1lOiBuYW1lLAogICAgYmVmb3JlOiB0aGlzLnNldHVwQmVmb3JlLAogICAgYm9keTogYm9keSwKICAgIGFmdGVyOiB0aGlzLnNldHVwQWZ0ZXIKICB9KTsKfTsKCi8qKgogKiBTYW1lIGFzIGl0KCkgYnV0IG1ha2VzIGlpdCB0ZXN0cyB0aGUgb25seSB0ZXN0IHRvIHJ1bi4KICoKICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgTmFtZSBvZiB0aGUgdGVzdC4KICogQHBhcmFtIHtGdW5jdGlvbn0gYm9keSBCb2R5IG9mIHRoZSBibG9jay4KICovCmFuZ3VsYXIuc2NlbmFyaW8uRGVzY3JpYmUucHJvdG90eXBlLmlpdCA9IGZ1bmN0aW9uKG5hbWUsIGJvZHkpIHsKICB0aGlzLml0LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgdGhpcy5pdHNbdGhpcy5pdHMubGVuZ3RoLTFdLm9ubHkgPSB0cnVlOwp9OwoKLyoqCiAqIFVzZSB0byBkaXNhYmxlIGEgdGVzdCBibG9jay4KICovCmFuZ3VsYXIuc2NlbmFyaW8uRGVzY3JpYmUucHJvdG90eXBlLnhpdCA9IGFuZ3VsYXIubm9vcDsKCi8qKgogKiBHZXRzIGFuIGFycmF5IG9mIGZ1bmN0aW9ucyByZXByZXNlbnRpbmcgYWxsIHRoZSB0ZXN0cyAocmVjdXJzaXZlbHkpLgogKiB0aGF0IGNhbiBiZSBleGVjdXRlZCB3aXRoIFNwZWNSdW5uZXIncy4KICoKICogQHJldHVybiB7QXJyYXk8T2JqZWN0Pn0gQXJyYXkgb2YgaXQgYmxvY2tzIHsKICogICBkZWZpbml0aW9uIDogT2JqZWN0IC8vIHBhcmVudCBEZXNjcmliZQogKiAgIG9ubHk6IGJvb2xlYW4KICogICBuYW1lOiBzdHJpbmcKICogICBiZWZvcmU6IEZ1bmN0aW9uCiAqICAgYm9keTogRnVuY3Rpb24KICogICBhZnRlcjogRnVuY3Rpb24KICogIH0KICovCmFuZ3VsYXIuc2NlbmFyaW8uRGVzY3JpYmUucHJvdG90eXBlLmdldFNwZWNzID0gZnVuY3Rpb24oKSB7CiAgdmFyIHNwZWNzID0gYXJndW1lbnRzWzBdIHx8IFtdOwogIGFuZ3VsYXIuZm9yRWFjaCh0aGlzLmNoaWxkcmVuLCBmdW5jdGlvbihjaGlsZCkgewogICAgY2hpbGQuZ2V0U3BlY3Moc3BlY3MpOwogIH0pOwogIGFuZ3VsYXIuZm9yRWFjaCh0aGlzLml0cywgZnVuY3Rpb24oaXQpIHsKICAgIHNwZWNzLnB1c2goaXQpOwogIH0pOwogIHZhciBvbmx5ID0gW107CiAgYW5ndWxhci5mb3JFYWNoKHNwZWNzLCBmdW5jdGlvbihpdCkgewogICAgaWYgKGl0Lm9ubHkpIHsKICAgICAgb25seS5wdXNoKGl0KTsKICAgIH0KICB9KTsKICByZXR1cm4gKG9ubHkubGVuZ3RoICYmIG9ubHkpIHx8IHNwZWNzOwp9OwondXNlIHN0cmljdCc7CgovKioKICogQSBmdXR1cmUgYWN0aW9uIGluIGEgc3BlYy4KICoKICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgb2YgdGhlIGZ1dHVyZSBhY3Rpb24KICogQHBhcmFtIHtGdW5jdGlvbn0gZnV0dXJlIGNhbGxiYWNrKGVycm9yLCByZXN1bHQpCiAqIEBwYXJhbSB7RnVuY3Rpb259IE9wdGlvbmFsLiBmdW5jdGlvbiB0aGF0IHJldHVybnMgdGhlIGZpbGUvbGluZSBudW1iZXIuCiAqLwphbmd1bGFyLnNjZW5hcmlvLkZ1dHVyZSA9IGZ1bmN0aW9uKG5hbWUsIGJlaGF2aW9yLCBsaW5lKSB7CiAgdGhpcy5uYW1lID0gbmFtZTsKICB0aGlzLmJlaGF2aW9yID0gYmVoYXZpb3I7CiAgdGhpcy5mdWxmaWxsZWQgPSBmYWxzZTsKICB0aGlzLnZhbHVlID0gdW5kZWZpbmVkOwogIHRoaXMucGFyc2VyID0gYW5ndWxhci5pZGVudGl0eTsKICB0aGlzLmxpbmUgPSBsaW5lIHx8IGZ1bmN0aW9uKCkgeyByZXR1cm4gJyc7IH07Cn07CgovKioKICogRXhlY3V0ZXMgdGhlIGJlaGF2aW9yIG9mIHRoZSBjbG9zdXJlLgogKgogKiBAcGFyYW0ge0Z1bmN0aW9ufSBkb25lRm4gQ2FsbGJhY2sgZnVuY3Rpb24oZXJyb3IsIHJlc3VsdCkKICovCmFuZ3VsYXIuc2NlbmFyaW8uRnV0dXJlLnByb3RvdHlwZS5leGVjdXRlID0gZnVuY3Rpb24oZG9uZUZuKSB7CiAgdmFyIHNlbGYgPSB0aGlzOwogIHRoaXMuYmVoYXZpb3IoZnVuY3Rpb24oZXJyb3IsIHJlc3VsdCkgewogICAgc2VsZi5mdWxmaWxsZWQgPSB0cnVlOwogICAgaWYgKHJlc3VsdCkgewogICAgICB0cnkgewogICAgICAgIHJlc3VsdCA9IHNlbGYucGFyc2VyKHJlc3VsdCk7CiAgICAgIH0gY2F0Y2goZSkgewogICAgICAgIGVycm9yID0gZTsKICAgICAgfQogICAgfQogICAgc2VsZi52YWx1ZSA9IGVycm9yIHx8IHJlc3VsdDsKICAgIGRvbmVGbihlcnJvciwgcmVzdWx0KTsKICB9KTsKfTsKCi8qKgogKiBDb25maWd1cmVzIHRoZSBmdXR1cmUgdG8gY29udmVydCBpdCdzIGZpbmFsIHdpdGggYSBmdW5jdGlvbiBmbih2YWx1ZSkKICoKICogQHBhcmFtIHtGdW5jdGlvbn0gZm4gZnVuY3Rpb24odmFsdWUpIHRoYXQgcmV0dXJucyB0aGUgcGFyc2VkIHZhbHVlCiAqLwphbmd1bGFyLnNjZW5hcmlvLkZ1dHVyZS5wcm90b3R5cGUucGFyc2VkV2l0aCA9IGZ1bmN0aW9uKGZuKSB7CiAgdGhpcy5wYXJzZXIgPSBmbjsKICByZXR1cm4gdGhpczsKfTsKCi8qKgogKiBDb25maWd1cmVzIHRoZSBmdXR1cmUgdG8gcGFyc2UgaXQncyBmaW5hbCB2YWx1ZSBmcm9tIEpTT04KICogaW50byBvYmplY3RzLgogKi8KYW5ndWxhci5zY2VuYXJpby5GdXR1cmUucHJvdG90eXBlLmZyb21Kc29uID0gZnVuY3Rpb24oKSB7CiAgcmV0dXJuIHRoaXMucGFyc2VkV2l0aChhbmd1bGFyLmZyb21Kc29uKTsKfTsKCi8qKgogKiBDb25maWd1cmVzIHRoZSBmdXR1cmUgdG8gY29udmVydCBpdCdzIGZpbmFsIHZhbHVlIGZyb20gb2JqZWN0cwogKiBpbnRvIEpTT04uCiAqLwphbmd1bGFyLnNjZW5hcmlvLkZ1dHVyZS5wcm90b3R5cGUudG9Kc29uID0gZnVuY3Rpb24oKSB7CiAgcmV0dXJuIHRoaXMucGFyc2VkV2l0aChhbmd1bGFyLnRvSnNvbik7Cn07Cid1c2Ugc3RyaWN0JzsKCi8qKgogKiBNYWludGFpbnMgYW4gb2JqZWN0IHRyZWUgZnJvbSB0aGUgcnVubmVyIGV2ZW50cy4KICoKICogQHBhcmFtIHtPYmplY3R9IHJ1bm5lciBUaGUgc2NlbmFyaW8gUnVubmVyIGluc3RhbmNlIHRvIGNvbm5lY3QgdG8uCiAqCiAqIFRPRE8oZXNwcmVobik6IEV2ZXJ5IG91dHB1dCB0eXBlIGNyZWF0ZXMgb25lIG9mIHRoZXNlLCBidXQgd2UgcHJvYmFibHkKICogIHdhbnQgb25lIGdsb2JhbCBzaGFyZWQgaW5zdGFuY2UuIE5lZWQgdG8gaGFuZGxlIGV2ZW50cyBiZXR0ZXIgdG9vCiAqICBzbyB0aGUgSFRNTCBvdXRwdXQgZG9lc24ndCBuZWVkIHRvIGRvIHNwZWMgbW9kZWwuZ2V0U3BlYyhzcGVjLmlkKQogKiAgc2lsbGluZXNzLgogKgogKiBUT0RPKHZvanRhKSByZWZhY3RvciBvbiwgZW1pdCBtZXRob2RzIChmcm9tIGFsbCBvYmplY3RzKSAtIHVzZSBpbmhlcml0YW5jZQogKi8KYW5ndWxhci5zY2VuYXJpby5PYmplY3RNb2RlbCA9IGZ1bmN0aW9uKHJ1bm5lcikgewogIHZhciBzZWxmID0gdGhpczsKCiAgdGhpcy5zcGVjTWFwID0ge307CiAgdGhpcy5saXN0ZW5lcnMgPSBbXTsKICB0aGlzLnZhbHVlID0gewogICAgbmFtZTogJycsCiAgICBjaGlsZHJlbjoge30KICB9OwoKICBydW5uZXIub24oJ1NwZWNCZWdpbicsIGZ1bmN0aW9uKHNwZWMpIHsKICAgIHZhciBibG9jayA9IHNlbGYudmFsdWUsCiAgICAgICAgZGVmaW5pdGlvbnMgPSBbXTsKCiAgICBhbmd1bGFyLmZvckVhY2goc2VsZi5nZXREZWZpbml0aW9uUGF0aChzcGVjKSwgZnVuY3Rpb24oZGVmKSB7CiAgICAgIGlmICghYmxvY2suY2hpbGRyZW5bZGVmLm5hbWVdKSB7CiAgICAgICAgYmxvY2suY2hpbGRyZW5bZGVmLm5hbWVdID0gewogICAgICAgICAgaWQ6IGRlZi5pZCwKICAgICAgICAgIG5hbWU6IGRlZi5uYW1lLAogICAgICAgICAgY2hpbGRyZW46IHt9LAogICAgICAgICAgc3BlY3M6IHt9CiAgICAgICAgfTsKICAgICAgfQogICAgICBibG9jayA9IGJsb2NrLmNoaWxkcmVuW2RlZi5uYW1lXTsKICAgICAgZGVmaW5pdGlvbnMucHVzaChkZWYubmFtZSk7CiAgICB9KTsKCiAgICB2YXIgaXQgPSBzZWxmLnNwZWNNYXBbc3BlYy5pZF0gPQogICAgICAgICAgICAgYmxvY2suc3BlY3Nbc3BlYy5uYW1lXSA9CiAgICAgICAgICAgICBuZXcgYW5ndWxhci5zY2VuYXJpby5PYmplY3RNb2RlbC5TcGVjKHNwZWMuaWQsIHNwZWMubmFtZSwgZGVmaW5pdGlvbnMpOwoKICAgIC8vIGZvcndhcmQgdGhlIGV2ZW50CiAgICBzZWxmLmVtaXQoJ1NwZWNCZWdpbicsIGl0KTsKICB9KTsKCiAgcnVubmVyLm9uKCdTcGVjRXJyb3InLCBmdW5jdGlvbihzcGVjLCBlcnJvcikgewogICAgdmFyIGl0ID0gc2VsZi5nZXRTcGVjKHNwZWMuaWQpOwogICAgaXQuc3RhdHVzID0gJ2Vycm9yJzsKICAgIGl0LmVycm9yID0gZXJyb3I7CgogICAgLy8gZm9yd2FyZCB0aGUgZXZlbnQKICAgIHNlbGYuZW1pdCgnU3BlY0Vycm9yJywgaXQsIGVycm9yKTsKICB9KTsKCiAgcnVubmVyLm9uKCdTcGVjRW5kJywgZnVuY3Rpb24oc3BlYykgewogICAgdmFyIGl0ID0gc2VsZi5nZXRTcGVjKHNwZWMuaWQpOwogICAgY29tcGxldGUoaXQpOwoKICAgIC8vIGZvcndhcmQgdGhlIGV2ZW50CiAgICBzZWxmLmVtaXQoJ1NwZWNFbmQnLCBpdCk7CiAgfSk7CgogIHJ1bm5lci5vbignU3RlcEJlZ2luJywgZnVuY3Rpb24oc3BlYywgc3RlcCkgewogICAgdmFyIGl0ID0gc2VsZi5nZXRTcGVjKHNwZWMuaWQpOwogICAgdmFyIHN0ZXAgPSBuZXcgYW5ndWxhci5zY2VuYXJpby5PYmplY3RNb2RlbC5TdGVwKHN0ZXAubmFtZSk7CiAgICBpdC5zdGVwcy5wdXNoKHN0ZXApOwoKICAgIC8vIGZvcndhcmQgdGhlIGV2ZW50CiAgICBzZWxmLmVtaXQoJ1N0ZXBCZWdpbicsIGl0LCBzdGVwKTsKICB9KTsKCiAgcnVubmVyLm9uKCdTdGVwRW5kJywgZnVuY3Rpb24oc3BlYywgc3RlcCkgewogICAgdmFyIGl0ID0gc2VsZi5nZXRTcGVjKHNwZWMuaWQpOwogICAgdmFyIHN0ZXAgPSBpdC5nZXRMYXN0U3RlcCgpOwogICAgaWYgKHN0ZXAubmFtZSAhPT0gc3RlcC5uYW1lKQogICAgICB0aHJvdyAnRXZlbnRzIGZpcmVkIGluIHRoZSB3cm9uZyBvcmRlci4gU3RlcCBuYW1lcyBkb25cJ3QgbWF0Y2guJzsKICAgIGNvbXBsZXRlKHN0ZXApOwoKICAgIC8vIGZvcndhcmQgdGhlIGV2ZW50CiAgICBzZWxmLmVtaXQoJ1N0ZXBFbmQnLCBpdCwgc3RlcCk7CiAgfSk7CgogIHJ1bm5lci5vbignU3RlcEZhaWx1cmUnLCBmdW5jdGlvbihzcGVjLCBzdGVwLCBlcnJvcikgewogICAgdmFyIGl0ID0gc2VsZi5nZXRTcGVjKHNwZWMuaWQpLAogICAgICAgIG1vZGVsU3RlcCA9IGl0LmdldExhc3RTdGVwKCk7CgogICAgbW9kZWxTdGVwLnNldEVycm9yU3RhdHVzKCdmYWlsdXJlJywgZXJyb3IsIHN0ZXAubGluZSgpKTsKICAgIGl0LnNldFN0YXR1c0Zyb21TdGVwKG1vZGVsU3RlcCk7CgogICAgLy8gZm9yd2FyZCB0aGUgZXZlbnQKICAgIHNlbGYuZW1pdCgnU3RlcEZhaWx1cmUnLCBpdCwgbW9kZWxTdGVwLCBlcnJvcik7CiAgfSk7CgogIHJ1bm5lci5vbignU3RlcEVycm9yJywgZnVuY3Rpb24oc3BlYywgc3RlcCwgZXJyb3IpIHsKICAgIHZhciBpdCA9IHNlbGYuZ2V0U3BlYyhzcGVjLmlkKSwKICAgICAgICBtb2RlbFN0ZXAgPSBpdC5nZXRMYXN0U3RlcCgpOwoKICAgIG1vZGVsU3RlcC5zZXRFcnJvclN0YXR1cygnZXJyb3InLCBlcnJvciwgc3RlcC5saW5lKCkpOwogICAgaXQuc2V0U3RhdHVzRnJvbVN0ZXAobW9kZWxTdGVwKTsKCiAgICAvLyBmb3J3YXJkIHRoZSBldmVudAogICAgc2VsZi5lbWl0KCdTdGVwRXJyb3InLCBpdCwgbW9kZWxTdGVwLCBlcnJvcik7CiAgfSk7CgogIHJ1bm5lci5vbignUnVubmVyRW5kJywgZnVuY3Rpb24oKSB7CiAgICBzZWxmLmVtaXQoJ1J1bm5lckVuZCcpOwogIH0pOwoKICBmdW5jdGlvbiBjb21wbGV0ZShpdGVtKSB7CiAgICBpdGVtLmVuZFRpbWUgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTsKICAgIGl0ZW0uZHVyYXRpb24gPSBpdGVtLmVuZFRpbWUgLSBpdGVtLnN0YXJ0VGltZTsKICAgIGl0ZW0uc3RhdHVzID0gaXRlbS5zdGF0dXMgfHwgJ3N1Y2Nlc3MnOwogIH0KfTsKCi8qKgogKiBBZGRzIGEgbGlzdGVuZXIgZm9yIGFuIGV2ZW50LgogKgogKiBAcGFyYW0ge3N0cmluZ30gZXZlbnROYW1lIE5hbWUgb2YgdGhlIGV2ZW50IHRvIGFkZCBhIGhhbmRsZXIgZm9yCiAqIEBwYXJhbSB7RnVuY3Rpb259IGxpc3RlbmVyIEZ1bmN0aW9uIHRoYXQgd2lsbCBiZSBjYWxsZWQgd2hlbiBldmVudCBpcyBmaXJlZAogKi8KYW5ndWxhci5zY2VuYXJpby5PYmplY3RNb2RlbC5wcm90b3R5cGUub24gPSBmdW5jdGlvbihldmVudE5hbWUsIGxpc3RlbmVyKSB7CiAgZXZlbnROYW1lID0gZXZlbnROYW1lLnRvTG93ZXJDYXNlKCk7CiAgdGhpcy5saXN0ZW5lcnNbZXZlbnROYW1lXSA9IHRoaXMubGlzdGVuZXJzW2V2ZW50TmFtZV0gfHwgW107CiAgdGhpcy5saXN0ZW5lcnNbZXZlbnROYW1lXS5wdXNoKGxpc3RlbmVyKTsKfTsKCi8qKgogKiBFbWl0cyBhbiBldmVudCB3aGljaCBub3RpZmllcyBsaXN0ZW5lcnMgYW5kIHBhc3NlcyBleHRyYQogKiBhcmd1bWVudHMuCiAqCiAqIEBwYXJhbSB7c3RyaW5nfSBldmVudE5hbWUgTmFtZSBvZiB0aGUgZXZlbnQgdG8gZmlyZS4KICovCmFuZ3VsYXIuc2NlbmFyaW8uT2JqZWN0TW9kZWwucHJvdG90eXBlLmVtaXQgPSBmdW5jdGlvbihldmVudE5hbWUpIHsKICB2YXIgc2VsZiA9IHRoaXMsCiAgICAgIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpLAogICAgICBldmVudE5hbWUgPSBldmVudE5hbWUudG9Mb3dlckNhc2UoKTsKCiAgaWYgKHRoaXMubGlzdGVuZXJzW2V2ZW50TmFtZV0pIHsKICAgIGFuZ3VsYXIuZm9yRWFjaCh0aGlzLmxpc3RlbmVyc1tldmVudE5hbWVdLCBmdW5jdGlvbihsaXN0ZW5lcikgewogICAgICBsaXN0ZW5lci5hcHBseShzZWxmLCBhcmdzKTsKICAgIH0pOwogIH0KfTsKCi8qKgogKiBDb21wdXRlcyB0aGUgcGF0aCBvZiBkZWZpbml0aW9uIGRlc2NyaWJlIGJsb2NrcyB0aGF0IHdyYXAgYXJvdW5kCiAqIHRoaXMgc3BlYy4KICoKICogQHBhcmFtIHNwZWMgU3BlYyB0byBjb21wdXRlIHRoZSBwYXRoIGZvci4KICogQHJldHVybiB7QXJyYXk8RGVzY3JpYmU+fSBUaGUgZGVzY3JpYmUgYmxvY2sgcGF0aAogKi8KYW5ndWxhci5zY2VuYXJpby5PYmplY3RNb2RlbC5wcm90b3R5cGUuZ2V0RGVmaW5pdGlvblBhdGggPSBmdW5jdGlvbihzcGVjKSB7CiAgdmFyIHBhdGggPSBbXTsKICB2YXIgY3VycmVudERlZmluaXRpb24gPSBzcGVjLmRlZmluaXRpb247CiAgd2hpbGUgKGN1cnJlbnREZWZpbml0aW9uICYmIGN1cnJlbnREZWZpbml0aW9uLm5hbWUpIHsKICAgIHBhdGgudW5zaGlmdChjdXJyZW50RGVmaW5pdGlvbik7CiAgICBjdXJyZW50RGVmaW5pdGlvbiA9IGN1cnJlbnREZWZpbml0aW9uLnBhcmVudDsKICB9CiAgcmV0dXJuIHBhdGg7Cn07CgovKioKICogR2V0cyBhIHNwZWMgYnkgaWQuCiAqCiAqIEBwYXJhbSB7c3RyaW5nfSBUaGUgaWQgb2YgdGhlIHNwZWMgdG8gZ2V0IHRoZSBvYmplY3QgZm9yLgogKiBAcmV0dXJuIHtPYmplY3R9IHRoZSBTcGVjIGluc3RhbmNlCiAqLwphbmd1bGFyLnNjZW5hcmlvLk9iamVjdE1vZGVsLnByb3RvdHlwZS5nZXRTcGVjID0gZnVuY3Rpb24oaWQpIHsKICByZXR1cm4gdGhpcy5zcGVjTWFwW2lkXTsKfTsKCi8qKgogKiBBIHNpbmdsZSBpdCBibG9jay4KICoKICogQHBhcmFtIHtzdHJpbmd9IGlkIElkIG9mIHRoZSBzcGVjCiAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIE5hbWUgb2YgdGhlIHNwZWMKICogQHBhcmFtIHtBcnJheTxzdHJpbmc+PX0gZGVmaW5pdGlvbk5hbWVzIExpc3Qgb2YgYWxsIGRlc2NyaWJlIGJsb2NrIG5hbWVzIHRoYXQgd3JhcCB0aGlzIHNwZWMKICovCmFuZ3VsYXIuc2NlbmFyaW8uT2JqZWN0TW9kZWwuU3BlYyA9IGZ1bmN0aW9uKGlkLCBuYW1lLCBkZWZpbml0aW9uTmFtZXMpIHsKICB0aGlzLmlkID0gaWQ7CiAgdGhpcy5uYW1lID0gbmFtZTsKICB0aGlzLnN0YXJ0VGltZSA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpOwogIHRoaXMuc3RlcHMgPSBbXTsKICB0aGlzLmZ1bGxEZWZpbml0aW9uTmFtZSA9IChkZWZpbml0aW9uTmFtZXMgfHwgW10pLmpvaW4oJyAnKTsKfTsKCi8qKgogKiBBZGRzIGEgbmV3IHN0ZXAgdG8gdGhlIFNwZWMuCiAqCiAqIEBwYXJhbSB7c3RyaW5nfSBzdGVwIE5hbWUgb2YgdGhlIHN0ZXAgKHJlYWxseSBuYW1lIG9mIHRoZSBmdXR1cmUpCiAqIEByZXR1cm4ge09iamVjdH0gdGhlIGFkZGVkIHN0ZXAKICovCmFuZ3VsYXIuc2NlbmFyaW8uT2JqZWN0TW9kZWwuU3BlYy5wcm90b3R5cGUuYWRkU3RlcCA9IGZ1bmN0aW9uKG5hbWUpIHsKICB2YXIgc3RlcCA9IG5ldyBhbmd1bGFyLnNjZW5hcmlvLk9iamVjdE1vZGVsLlN0ZXAobmFtZSk7CiAgdGhpcy5zdGVwcy5wdXNoKHN0ZXApOwogIHJldHVybiBzdGVwOwp9OwoKLyoqCiAqIEdldHMgdGhlIG1vc3QgcmVjZW50IHN0ZXAuCiAqCiAqIEByZXR1cm4ge09iamVjdH0gdGhlIHN0ZXAKICovCmFuZ3VsYXIuc2NlbmFyaW8uT2JqZWN0TW9kZWwuU3BlYy5wcm90b3R5cGUuZ2V0TGFzdFN0ZXAgPSBmdW5jdGlvbigpIHsKICByZXR1cm4gdGhpcy5zdGVwc1t0aGlzLnN0ZXBzLmxlbmd0aC0xXTsKfTsKCi8qKgogKiBTZXQgc3RhdHVzIG9mIHRoZSBTcGVjIGZyb20gZ2l2ZW4gU3RlcAogKgogKiBAcGFyYW0ge2FuZ3VsYXIuc2NlbmFyaW8uT2JqZWN0TW9kZWwuU3RlcH0gc3RlcAogKi8KYW5ndWxhci5zY2VuYXJpby5PYmplY3RNb2RlbC5TcGVjLnByb3RvdHlwZS5zZXRTdGF0dXNGcm9tU3RlcCA9IGZ1bmN0aW9uKHN0ZXApIHsKICBpZiAoIXRoaXMuc3RhdHVzIHx8IHN0ZXAuc3RhdHVzID09ICdlcnJvcicpIHsKICAgIHRoaXMuc3RhdHVzID0gc3RlcC5zdGF0dXM7CiAgICB0aGlzLmVycm9yID0gc3RlcC5lcnJvcjsKICAgIHRoaXMubGluZSA9IHN0ZXAubGluZTsKICB9Cn07CgovKioKICogQSBzaW5nbGUgc3RlcCBpbnNpZGUgYSBTcGVjLgogKgogKiBAcGFyYW0ge3N0cmluZ30gc3RlcCBOYW1lIG9mIHRoZSBzdGVwCiAqLwphbmd1bGFyLnNjZW5hcmlvLk9iamVjdE1vZGVsLlN0ZXAgPSBmdW5jdGlvbihuYW1lKSB7CiAgdGhpcy5uYW1lID0gbmFtZTsKICB0aGlzLnN0YXJ0VGltZSA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpOwp9OwoKLyoqCiAqIEhlbHBlciBtZXRob2QgZm9yIHNldHRpbmcgYWxsIGVycm9yIHN0YXR1cyByZWxhdGVkIHByb3BlcnRpZXMKICoKICogQHBhcmFtIHtzdHJpbmd9IHN0YXR1cwogKiBAcGFyYW0ge3N0cmluZ30gZXJyb3IKICogQHBhcmFtIHtzdHJpbmd9IGxpbmUKICovCmFuZ3VsYXIuc2NlbmFyaW8uT2JqZWN0TW9kZWwuU3RlcC5wcm90b3R5cGUuc2V0RXJyb3JTdGF0dXMgPSBmdW5jdGlvbihzdGF0dXMsIGVycm9yLCBsaW5lKSB7CiAgdGhpcy5zdGF0dXMgPSBzdGF0dXM7CiAgdGhpcy5lcnJvciA9IGVycm9yOwogIHRoaXMubGluZSA9IGxpbmU7Cn07Cid1c2Ugc3RyaWN0JzsKCi8qKgogKiBUaGUgcmVwcmVzZW50YXRpb24gb2YgZGVmaW5lIGJsb2Nrcy4gRG9uJ3QgdXNlZCBkaXJlY3RseSwgaW5zdGVhZCB1c2UKICogZGVmaW5lKCkgaW4geW91ciB0ZXN0cy4KICoKICogQHBhcmFtIHtzdHJpbmd9IGRlc2NOYW1lIE5hbWUgb2YgdGhlIGJsb2NrCiAqIEBwYXJhbSB7T2JqZWN0fSBwYXJlbnQgZGVzY3JpYmUgb3IgdW5kZWZpbmVkIGlmIHRoZSByb290LgogKi8KYW5ndWxhci5zY2VuYXJpby5EZXNjcmliZSA9IGZ1bmN0aW9uKGRlc2NOYW1lLCBwYXJlbnQpIHsKICB0aGlzLm9ubHkgPSBwYXJlbnQgJiYgcGFyZW50Lm9ubHk7CiAgdGhpcy5iZWZvcmVFYWNoRm5zID0gW107CiAgdGhpcy5hZnRlckVhY2hGbnMgPSBbXTsKICB0aGlzLml0cyA9IFtdOwogIHRoaXMuY2hpbGRyZW4gPSBbXTsKICB0aGlzLm5hbWUgPSBkZXNjTmFtZTsKICB0aGlzLnBhcmVudCA9IHBhcmVudDsKICB0aGlzLmlkID0gYW5ndWxhci5zY2VuYXJpby5EZXNjcmliZS5pZCsrOwoKICAvKioKICAgKiBDYWxscyBhbGwgYmVmb3JlIGZ1bmN0aW9ucy4KICAgKi8KICB2YXIgYmVmb3JlRWFjaEZucyA9IHRoaXMuYmVmb3JlRWFjaEZuczsKICB0aGlzLnNldHVwQmVmb3JlID0gZnVuY3Rpb24oKSB7CiAgICBpZiAocGFyZW50KSBwYXJlbnQuc2V0dXBCZWZvcmUuY2FsbCh0aGlzKTsKICAgIGFuZ3VsYXIuZm9yRWFjaChiZWZvcmVFYWNoRm5zLCBmdW5jdGlvbihmbikgeyBmbi5jYWxsKHRoaXMpOyB9LCB0aGlzKTsKICB9OwoKICAvKioKICAgKiBDYWxscyBhbGwgYWZ0ZXIgZnVuY3Rpb25zLgogICAqLwogIHZhciBhZnRlckVhY2hGbnMgPSB0aGlzLmFmdGVyRWFjaEZuczsKICB0aGlzLnNldHVwQWZ0ZXIgID0gZnVuY3Rpb24oKSB7CiAgICBhbmd1bGFyLmZvckVhY2goYWZ0ZXJFYWNoRm5zLCBmdW5jdGlvbihmbikgeyBmbi5jYWxsKHRoaXMpOyB9LCB0aGlzKTsKICAgIGlmIChwYXJlbnQpIHBhcmVudC5zZXR1cEFmdGVyLmNhbGwodGhpcyk7CiAgfTsKfTsKCi8vIFNoYXJlZCBVbmlxdWUgSUQgZ2VuZXJhdG9yIGZvciBldmVyeSBkZXNjcmliZSBibG9jawphbmd1bGFyLnNjZW5hcmlvLkRlc2NyaWJlLmlkID0gMDsKCi8vIFNoYXJlZCBVbmlxdWUgSUQgZ2VuZXJhdG9yIGZvciBldmVyeSBpdCAoc3BlYykKYW5ndWxhci5zY2VuYXJpby5EZXNjcmliZS5zcGVjSWQgPSAwOwoKLyoqCiAqIERlZmluZXMgYSBibG9jayB0byBleGVjdXRlIGJlZm9yZSBlYWNoIGl0IG9yIG5lc3RlZCBkZXNjcmliZS4KICoKICogQHBhcmFtIHtGdW5jdGlvbn0gYm9keSBCb2R5IG9mIHRoZSBibG9jay4KICovCmFuZ3VsYXIuc2NlbmFyaW8uRGVzY3JpYmUucHJvdG90eXBlLmJlZm9yZUVhY2ggPSBmdW5jdGlvbihib2R5KSB7CiAgdGhpcy5iZWZvcmVFYWNoRm5zLnB1c2goYm9keSk7Cn07CgovKioKICogRGVmaW5lcyBhIGJsb2NrIHRvIGV4ZWN1dGUgYWZ0ZXIgZWFjaCBpdCBvciBuZXN0ZWQgZGVzY3JpYmUuCiAqCiAqIEBwYXJhbSB7RnVuY3Rpb259IGJvZHkgQm9keSBvZiB0aGUgYmxvY2suCiAqLwphbmd1bGFyLnNjZW5hcmlvLkRlc2NyaWJlLnByb3RvdHlwZS5hZnRlckVhY2ggPSBmdW5jdGlvbihib2R5KSB7CiAgdGhpcy5hZnRlckVhY2hGbnMucHVzaChib2R5KTsKfTsKCi8qKgogKiBDcmVhdGVzIGEgbmV3IGRlc2NyaWJlIGJsb2NrIHRoYXQncyBhIGNoaWxkIG9mIHRoaXMgb25lLgogKgogKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBOYW1lIG9mIHRoZSBibG9jay4gQXBwZW5kZWQgdG8gdGhlIHBhcmVudCBibG9jaydzIG5hbWUuCiAqIEBwYXJhbSB7RnVuY3Rpb259IGJvZHkgQm9keSBvZiB0aGUgYmxvY2suCiAqLwphbmd1bGFyLnNjZW5hcmlvLkRlc2NyaWJlLnByb3RvdHlwZS5kZXNjcmliZSA9IGZ1bmN0aW9uKG5hbWUsIGJvZHkpIHsKICB2YXIgY2hpbGQgPSBuZXcgYW5ndWxhci5zY2VuYXJpby5EZXNjcmliZShuYW1lLCB0aGlzKTsKICB0aGlzLmNoaWxkcmVuLnB1c2goY2hpbGQpOwogIGJvZHkuY2FsbChjaGlsZCk7Cn07CgovKioKICogU2FtZSBhcyBkZXNjcmliZSgpIGJ1dCBtYWtlcyBkZGVzY3JpYmUgYmxvY2tzIHRoZSBvbmx5IHRvIHJ1bi4KICoKICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgTmFtZSBvZiB0aGUgdGVzdC4KICogQHBhcmFtIHtGdW5jdGlvbn0gYm9keSBCb2R5IG9mIHRoZSBibG9jay4KICovCmFuZ3VsYXIuc2NlbmFyaW8uRGVzY3JpYmUucHJvdG90eXBlLmRkZXNjcmliZSA9IGZ1bmN0aW9uKG5hbWUsIGJvZHkpIHsKICB2YXIgY2hpbGQgPSBuZXcgYW5ndWxhci5zY2VuYXJpby5EZXNjcmliZShuYW1lLCB0aGlzKTsKICBjaGlsZC5vbmx5ID0gdHJ1ZTsKICB0aGlzLmNoaWxkcmVuLnB1c2goY2hpbGQpOwogIGJvZHkuY2FsbChjaGlsZCk7Cn07CgovKioKICogVXNlIHRvIGRpc2FibGUgYSBkZXNjcmliZSBibG9jay4KICovCmFuZ3VsYXIuc2NlbmFyaW8uRGVzY3JpYmUucHJvdG90eXBlLnhkZXNjcmliZSA9IGFuZ3VsYXIubm9vcDsKCi8qKgogKiBEZWZpbmVzIGEgdGVzdC4KICoKICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgTmFtZSBvZiB0aGUgdGVzdC4KICogQHBhcmFtIHtGdW5jdGlvbn0gdm9keSBCb2R5IG9mIHRoZSBibG9jay4KICovCmFuZ3VsYXIuc2NlbmFyaW8uRGVzY3JpYmUucHJvdG90eXBlLml0ID0gZnVuY3Rpb24obmFtZSwgYm9keSkgewogIHRoaXMuaXRzLnB1c2goewogICAgaWQ6IGFuZ3VsYXIuc2NlbmFyaW8uRGVzY3JpYmUuc3BlY0lkKyssCiAgICBkZWZpbml0aW9uOiB0aGlzLAogICAgb25seTogdGhpcy5vbmx5LAogICAgbmFtZTogbmFtZSwKICAgIGJlZm9yZTogdGhpcy5zZXR1cEJlZm9yZSwKICAgIGJvZHk6IGJvZHksCiAgICBhZnRlcjogdGhpcy5zZXR1cEFmdGVyCiAgfSk7Cn07CgovKioKICogU2FtZSBhcyBpdCgpIGJ1dCBtYWtlcyBpaXQgdGVzdHMgdGhlIG9ubHkgdGVzdCB0byBydW4uCiAqCiAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIE5hbWUgb2YgdGhlIHRlc3QuCiAqIEBwYXJhbSB7RnVuY3Rpb259IGJvZHkgQm9keSBvZiB0aGUgYmxvY2suCiAqLwphbmd1bGFyLnNjZW5hcmlvLkRlc2NyaWJlLnByb3RvdHlwZS5paXQgPSBmdW5jdGlvbihuYW1lLCBib2R5KSB7CiAgdGhpcy5pdC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIHRoaXMuaXRzW3RoaXMuaXRzLmxlbmd0aC0xXS5vbmx5ID0gdHJ1ZTsKfTsKCi8qKgogKiBVc2UgdG8gZGlzYWJsZSBhIHRlc3QgYmxvY2suCiAqLwphbmd1bGFyLnNjZW5hcmlvLkRlc2NyaWJlLnByb3RvdHlwZS54aXQgPSBhbmd1bGFyLm5vb3A7CgovKioKICogR2V0cyBhbiBhcnJheSBvZiBmdW5jdGlvbnMgcmVwcmVzZW50aW5nIGFsbCB0aGUgdGVzdHMgKHJlY3Vyc2l2ZWx5KS4KICogdGhhdCBjYW4gYmUgZXhlY3V0ZWQgd2l0aCBTcGVjUnVubmVyJ3MuCiAqCiAqIEByZXR1cm4ge0FycmF5PE9iamVjdD59IEFycmF5IG9mIGl0IGJsb2NrcyB7CiAqICAgZGVmaW5pdGlvbiA6IE9iamVjdCAvLyBwYXJlbnQgRGVzY3JpYmUKICogICBvbmx5OiBib29sZWFuCiAqICAgbmFtZTogc3RyaW5nCiAqICAgYmVmb3JlOiBGdW5jdGlvbgogKiAgIGJvZHk6IEZ1bmN0aW9uCiAqICAgYWZ0ZXI6IEZ1bmN0aW9uCiAqICB9CiAqLwphbmd1bGFyLnNjZW5hcmlvLkRlc2NyaWJlLnByb3RvdHlwZS5nZXRTcGVjcyA9IGZ1bmN0aW9uKCkgewogIHZhciBzcGVjcyA9IGFyZ3VtZW50c1swXSB8fCBbXTsKICBhbmd1bGFyLmZvckVhY2godGhpcy5jaGlsZHJlbiwgZnVuY3Rpb24oY2hpbGQpIHsKICAgIGNoaWxkLmdldFNwZWNzKHNwZWNzKTsKICB9KTsKICBhbmd1bGFyLmZvckVhY2godGhpcy5pdHMsIGZ1bmN0aW9uKGl0KSB7CiAgICBzcGVjcy5wdXNoKGl0KTsKICB9KTsKICB2YXIgb25seSA9IFtdOwogIGFuZ3VsYXIuZm9yRWFjaChzcGVjcywgZnVuY3Rpb24oaXQpIHsKICAgIGlmIChpdC5vbmx5KSB7CiAgICAgIG9ubHkucHVzaChpdCk7CiAgICB9CiAgfSk7CiAgcmV0dXJuIChvbmx5Lmxlbmd0aCAmJiBvbmx5KSB8fCBzcGVjczsKfTsKJ3VzZSBzdHJpY3QnOwoKLyoqCiAqIFJ1bm5lciBmb3Igc2NlbmFyaW9zCiAqCiAqIEhhcyB0byBiZSBpbml0aWFsaXplZCBiZWZvcmUgYW55IHRlc3QgaXMgbG9hZGVkLAogKiBiZWNhdXNlIGl0IHB1Ymxpc2hlcyB0aGUgQVBJIGludG8gd2luZG93IChnbG9iYWwgc3BhY2UpLgogKi8KYW5ndWxhci5zY2VuYXJpby5SdW5uZXIgPSBmdW5jdGlvbigkd2luZG93KSB7CiAgdGhpcy5saXN0ZW5lcnMgPSBbXTsKICB0aGlzLiR3aW5kb3cgPSAkd2luZG93OwogIHRoaXMucm9vdERlc2NyaWJlID0gbmV3IGFuZ3VsYXIuc2NlbmFyaW8uRGVzY3JpYmUoKTsKICB0aGlzLmN1cnJlbnREZXNjcmliZSA9IHRoaXMucm9vdERlc2NyaWJlOwogIHRoaXMuYXBpID0gewogICAgaXQ6IHRoaXMuaXQsCiAgICBpaXQ6IHRoaXMuaWl0LAogICAgeGl0OiBhbmd1bGFyLm5vb3AsCiAgICBkZXNjcmliZTogdGhpcy5kZXNjcmliZSwKICAgIGRkZXNjcmliZTogdGhpcy5kZGVzY3JpYmUsCiAgICB4ZGVzY3JpYmU6IGFuZ3VsYXIubm9vcCwKICAgIGJlZm9yZUVhY2g6IHRoaXMuYmVmb3JlRWFjaCwKICAgIGFmdGVyRWFjaDogdGhpcy5hZnRlckVhY2gKICB9OwogIGFuZ3VsYXIuZm9yRWFjaCh0aGlzLmFwaSwgYW5ndWxhci5iaW5kKHRoaXMsIGZ1bmN0aW9uKGZuLCBrZXkpIHsKICAgIHRoaXMuJHdpbmRvd1trZXldID0gYW5ndWxhci5iaW5kKHRoaXMsIGZuKTsKICB9KSk7Cn07CgovKioKICogRW1pdHMgYW4gZXZlbnQgd2hpY2ggbm90aWZpZXMgbGlzdGVuZXJzIGFuZCBwYXNzZXMgZXh0cmEKICogYXJndW1lbnRzLgogKgogKiBAcGFyYW0ge3N0cmluZ30gZXZlbnROYW1lIE5hbWUgb2YgdGhlIGV2ZW50IHRvIGZpcmUuCiAqLwphbmd1bGFyLnNjZW5hcmlvLlJ1bm5lci5wcm90b3R5cGUuZW1pdCA9IGZ1bmN0aW9uKGV2ZW50TmFtZSkgewogIHZhciBzZWxmID0gdGhpczsKICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CiAgZXZlbnROYW1lID0gZXZlbnROYW1lLnRvTG93ZXJDYXNlKCk7CiAgaWYgKCF0aGlzLmxpc3RlbmVyc1tldmVudE5hbWVdKQogICAgcmV0dXJuOwogIGFuZ3VsYXIuZm9yRWFjaCh0aGlzLmxpc3RlbmVyc1tldmVudE5hbWVdLCBmdW5jdGlvbihsaXN0ZW5lcikgewogICAgbGlzdGVuZXIuYXBwbHkoc2VsZiwgYXJncyk7CiAgfSk7Cn07CgovKioKICogQWRkcyBhIGxpc3RlbmVyIGZvciBhbiBldmVudC4KICoKICogQHBhcmFtIHtzdHJpbmd9IGV2ZW50TmFtZSBUaGUgbmFtZSBvZiB0aGUgZXZlbnQgdG8gYWRkIGEgaGFuZGxlciBmb3IKICogQHBhcmFtIHtzdHJpbmd9IGxpc3RlbmVyIFRoZSBmbiguLi4pIHRoYXQgdGFrZXMgdGhlIGV4dHJhIGFyZ3VtZW50cyBmcm9tIGVtaXQoKQogKi8KYW5ndWxhci5zY2VuYXJpby5SdW5uZXIucHJvdG90eXBlLm9uID0gZnVuY3Rpb24oZXZlbnROYW1lLCBsaXN0ZW5lcikgewogIGV2ZW50TmFtZSA9IGV2ZW50TmFtZS50b0xvd2VyQ2FzZSgpOwogIHRoaXMubGlzdGVuZXJzW2V2ZW50TmFtZV0gPSB0aGlzLmxpc3RlbmVyc1tldmVudE5hbWVdIHx8IFtdOwogIHRoaXMubGlzdGVuZXJzW2V2ZW50TmFtZV0ucHVzaChsaXN0ZW5lcik7Cn07CgovKioKICogRGVmaW5lcyBhIGRlc2NyaWJlIGJsb2NrIG9mIGEgc3BlYy4KICoKICogQHNlZSBEZXNjcmliZS5qcwogKgogKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBOYW1lIG9mIHRoZSBibG9jawogKiBAcGFyYW0ge0Z1bmN0aW9ufSBib2R5IEJvZHkgb2YgdGhlIGJsb2NrCiAqLwphbmd1bGFyLnNjZW5hcmlvLlJ1bm5lci5wcm90b3R5cGUuZGVzY3JpYmUgPSBmdW5jdGlvbihuYW1lLCBib2R5KSB7CiAgdmFyIHNlbGYgPSB0aGlzOwogIHRoaXMuY3VycmVudERlc2NyaWJlLmRlc2NyaWJlKG5hbWUsIGZ1bmN0aW9uKCkgewogICAgdmFyIHBhcmVudERlc2NyaWJlID0gc2VsZi5jdXJyZW50RGVzY3JpYmU7CiAgICBzZWxmLmN1cnJlbnREZXNjcmliZSA9IHRoaXM7CiAgICB0cnkgewogICAgICBib2R5LmNhbGwodGhpcyk7CiAgICB9IGZpbmFsbHkgewogICAgICBzZWxmLmN1cnJlbnREZXNjcmliZSA9IHBhcmVudERlc2NyaWJlOwogICAgfQogIH0pOwp9OwoKLyoqCiAqIFNhbWUgYXMgZGVzY3JpYmUsIGJ1dCBtYWtlcyBkZGVzY3JpYmUgdGhlIG9ubHkgYmxvY2tzIHRvIHJ1bi4KICoKICogQHNlZSBEZXNjcmliZS5qcwogKgogKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBOYW1lIG9mIHRoZSBibG9jawogKiBAcGFyYW0ge0Z1bmN0aW9ufSBib2R5IEJvZHkgb2YgdGhlIGJsb2NrCiAqLwphbmd1bGFyLnNjZW5hcmlvLlJ1bm5lci5wcm90b3R5cGUuZGRlc2NyaWJlID0gZnVuY3Rpb24obmFtZSwgYm9keSkgewogIHZhciBzZWxmID0gdGhpczsKICB0aGlzLmN1cnJlbnREZXNjcmliZS5kZGVzY3JpYmUobmFtZSwgZnVuY3Rpb24oKSB7CiAgICB2YXIgcGFyZW50RGVzY3JpYmUgPSBzZWxmLmN1cnJlbnREZXNjcmliZTsKICAgIHNlbGYuY3VycmVudERlc2NyaWJlID0gdGhpczsKICAgIHRyeSB7CiAgICAgIGJvZHkuY2FsbCh0aGlzKTsKICAgIH0gZmluYWxseSB7CiAgICAgIHNlbGYuY3VycmVudERlc2NyaWJlID0gcGFyZW50RGVzY3JpYmU7CiAgICB9CiAgfSk7Cn07CgovKioKICogRGVmaW5lcyBhIHRlc3QgaW4gYSBkZXNjcmliZSBibG9jayBvZiBhIHNwZWMuCiAqCiAqIEBzZWUgRGVzY3JpYmUuanMKICoKICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgTmFtZSBvZiB0aGUgYmxvY2sKICogQHBhcmFtIHtGdW5jdGlvbn0gYm9keSBCb2R5IG9mIHRoZSBibG9jawogKi8KYW5ndWxhci5zY2VuYXJpby5SdW5uZXIucHJvdG90eXBlLml0ID0gZnVuY3Rpb24obmFtZSwgYm9keSkgewogIHRoaXMuY3VycmVudERlc2NyaWJlLml0KG5hbWUsIGJvZHkpOwp9OwoKLyoqCiAqIFNhbWUgYXMgaXQsIGJ1dCBtYWtlcyBpaXQgdGVzdHMgdGhlIG9ubHkgdGVzdHMgdG8gcnVuLgogKgogKiBAc2VlIERlc2NyaWJlLmpzCiAqCiAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIE5hbWUgb2YgdGhlIGJsb2NrCiAqIEBwYXJhbSB7RnVuY3Rpb259IGJvZHkgQm9keSBvZiB0aGUgYmxvY2sKICovCmFuZ3VsYXIuc2NlbmFyaW8uUnVubmVyLnByb3RvdHlwZS5paXQgPSBmdW5jdGlvbihuYW1lLCBib2R5KSB7CiAgdGhpcy5jdXJyZW50RGVzY3JpYmUuaWl0KG5hbWUsIGJvZHkpOwp9OwoKLyoqCiAqIERlZmluZXMgYSBmdW5jdGlvbiB0byBiZSBjYWxsZWQgYmVmb3JlIGVhY2ggaXQgYmxvY2sgaW4gdGhlIGRlc2NyaWJlCiAqIChhbmQgYmVmb3JlIGFsbCBuZXN0ZWQgZGVzY3JpYmVzKS4KICoKICogQHNlZSBEZXNjcmliZS5qcwogKgogKiBAcGFyYW0ge0Z1bmN0aW9ufSBDYWxsYmFjayB0byBleGVjdXRlCiAqLwphbmd1bGFyLnNjZW5hcmlvLlJ1bm5lci5wcm90b3R5cGUuYmVmb3JlRWFjaCA9IGZ1bmN0aW9uKGJvZHkpIHsKICB0aGlzLmN1cnJlbnREZXNjcmliZS5iZWZvcmVFYWNoKGJvZHkpOwp9OwoKLyoqCiAqIERlZmluZXMgYSBmdW5jdGlvbiB0byBiZSBjYWxsZWQgYWZ0ZXIgZWFjaCBpdCBibG9jayBpbiB0aGUgZGVzY3JpYmUKICogKGFuZCBiZWZvcmUgYWxsIG5lc3RlZCBkZXNjcmliZXMpLgogKgogKiBAc2VlIERlc2NyaWJlLmpzCiAqCiAqIEBwYXJhbSB7RnVuY3Rpb259IENhbGxiYWNrIHRvIGV4ZWN1dGUKICovCmFuZ3VsYXIuc2NlbmFyaW8uUnVubmVyLnByb3RvdHlwZS5hZnRlckVhY2ggPSBmdW5jdGlvbihib2R5KSB7CiAgdGhpcy5jdXJyZW50RGVzY3JpYmUuYWZ0ZXJFYWNoKGJvZHkpOwp9OwoKLyoqCiAqIENyZWF0ZXMgYSBuZXcgc3BlYyBydW5uZXIuCiAqCiAqIEBwcml2YXRlCiAqIEBwYXJhbSB7T2JqZWN0fSBzY29wZSBwYXJlbnQgc2NvcGUKICovCmFuZ3VsYXIuc2NlbmFyaW8uUnVubmVyLnByb3RvdHlwZS5jcmVhdGVTcGVjUnVubmVyXyA9IGZ1bmN0aW9uKHNjb3BlKSB7CiAgcmV0dXJuIHNjb3BlLiRuZXcoYW5ndWxhci5zY2VuYXJpby5TcGVjUnVubmVyKTsKfTsKCi8qKgogKiBSdW5zIGFsbCB0aGUgbG9hZGVkIHRlc3RzIHdpdGggdGhlIHNwZWNpZmllZCBydW5uZXIgY2xhc3Mgb24gdGhlCiAqIHByb3ZpZGVkIGFwcGxpY2F0aW9uLgogKgogKiBAcGFyYW0ge2FuZ3VsYXIuc2NlbmFyaW8uQXBwbGljYXRpb259IGFwcGxpY2F0aW9uIEFwcCB0byByZW1vdGUgY29udHJvbC4KICovCmFuZ3VsYXIuc2NlbmFyaW8uUnVubmVyLnByb3RvdHlwZS5ydW4gPSBmdW5jdGlvbihhcHBsaWNhdGlvbikgewogIHZhciBzZWxmID0gdGhpczsKICB2YXIgJHJvb3QgPSBhbmd1bGFyLnNjb3BlKHRoaXMpOwogICRyb290LmFwcGxpY2F0aW9uID0gYXBwbGljYXRpb247CiAgdGhpcy5lbWl0KCdSdW5uZXJCZWdpbicpOwogIGFzeW5jRm9yRWFjaCh0aGlzLnJvb3REZXNjcmliZS5nZXRTcGVjcygpLCBmdW5jdGlvbihzcGVjLCBzcGVjRG9uZSkgewogICAgdmFyIGRzbENhY2hlID0ge307CiAgICB2YXIgcnVubmVyID0gc2VsZi5jcmVhdGVTcGVjUnVubmVyXygkcm9vdCk7CiAgICBhbmd1bGFyLmZvckVhY2goYW5ndWxhci5zY2VuYXJpby5kc2wsIGZ1bmN0aW9uKGZuLCBrZXkpIHsKICAgICAgZHNsQ2FjaGVba2V5XSA9IGZuLmNhbGwoJHJvb3QpOwogICAgfSk7CiAgICBhbmd1bGFyLmZvckVhY2goYW5ndWxhci5zY2VuYXJpby5kc2wsIGZ1bmN0aW9uKGZuLCBrZXkpIHsKICAgICAgc2VsZi4kd2luZG93W2tleV0gPSBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgbGluZSA9IGNhbGxlckZpbGUoMyk7CiAgICAgICAgdmFyIHNjb3BlID0gYW5ndWxhci5zY29wZShydW5uZXIpOwoKICAgICAgICAvLyBNYWtlIHRoZSBkc2wgYWNjZXNzaWJsZSBvbiB0aGUgY3VycmVudCBjaGFpbgogICAgICAgIHNjb3BlLmRzbCA9IHt9OwogICAgICAgIGFuZ3VsYXIuZm9yRWFjaChkc2xDYWNoZSwgZnVuY3Rpb24oZm4sIGtleSkgewogICAgICAgICAgc2NvcGUuZHNsW2tleV0gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIGRzbENhY2hlW2tleV0uYXBwbHkoc2NvcGUsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9OwogICAgICAgIH0pOwoKICAgICAgICAvLyBNYWtlIHRoZXNlIG1ldGhvZHMgd29yayBvbiB0aGUgY3VycmVudCBjaGFpbgogICAgICAgIHNjb3BlLmFkZEZ1dHVyZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgQXJyYXkucHJvdG90eXBlLnB1c2guY2FsbChhcmd1bWVudHMsIGxpbmUpOwogICAgICAgICAgcmV0dXJuIGFuZ3VsYXIuc2NlbmFyaW8uU3BlY1J1bm5lci4KICAgICAgICAgICAgcHJvdG90eXBlLmFkZEZ1dHVyZS5hcHBseShzY29wZSwgYXJndW1lbnRzKTsKICAgICAgICB9OwogICAgICAgIHNjb3BlLmFkZEZ1dHVyZUFjdGlvbiA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgQXJyYXkucHJvdG90eXBlLnB1c2guY2FsbChhcmd1bWVudHMsIGxpbmUpOwogICAgICAgICAgcmV0dXJuIGFuZ3VsYXIuc2NlbmFyaW8uU3BlY1J1bm5lci4KICAgICAgICAgICAgcHJvdG90eXBlLmFkZEZ1dHVyZUFjdGlvbi5hcHBseShzY29wZSwgYXJndW1lbnRzKTsKICAgICAgICB9OwoKICAgICAgICByZXR1cm4gc2NvcGUuZHNsW2tleV0uYXBwbHkoc2NvcGUsIGFyZ3VtZW50cyk7CiAgICAgIH07CiAgICB9KTsKICAgIHJ1bm5lci5ydW4oc3BlYywgc3BlY0RvbmUpOwogIH0sCiAgZnVuY3Rpb24oZXJyb3IpIHsKICAgIGlmIChlcnJvcikgewogICAgICBzZWxmLmVtaXQoJ1J1bm5lckVycm9yJywgZXJyb3IpOwogICAgfQogICAgc2VsZi5lbWl0KCdSdW5uZXJFbmQnKTsKICB9KTsKfTsKJ3VzZSBzdHJpY3QnOwoKLyoqCiAqIFRoaXMgY2xhc3MgaXMgdGhlICJ0aGlzIiBvZiB0aGUgaXQvYmVmb3JlRWFjaC9hZnRlckVhY2ggbWV0aG9kLgogKiBSZXNwb25zaWJpbGl0aWVzOgogKiAgIC0gInRoaXMiIGZvciBpdC9iZWZvcmVFYWNoL2FmdGVyRWFjaAogKiAgIC0ga2VlcCBzdGF0ZSBmb3Igc2luZ2xlIGl0L2JlZm9yZUVhY2gvYWZ0ZXJFYWNoIGV4ZWN1dGlvbgogKiAgIC0ga2VlcCB0cmFjayBvZiBhbGwgb2YgdGhlIGZ1dHVyZXMgdG8gZXhlY3V0ZQogKiAgIC0gcnVuIHNpbmdsZSBzcGVjIChleGVjdXRlIGVhY2ggZnV0dXJlKQogKi8KYW5ndWxhci5zY2VuYXJpby5TcGVjUnVubmVyID0gZnVuY3Rpb24oKSB7CiAgdGhpcy5mdXR1cmVzID0gW107CiAgdGhpcy5hZnRlckluZGV4ID0gMDsKfTsKCi8qKgogKiBFeGVjdXRlcyBhIHNwZWMgd2hpY2ggaXMgYW4gaXQgYmxvY2sgd2l0aCBhc3NvY2lhdGVkIGJlZm9yZS9hZnRlciBmdW5jdGlvbnMKICogYmFzZWQgb24gdGhlIGRlc2NyaWJlIG5lc3RpbmcuCiAqCiAqIEBwYXJhbSB7T2JqZWN0fSBzcGVjIEEgc3BlYyBvYmplY3QKICogQHBhcmFtIHtGdW5jdGlvbn0gc3BlY0RvbmUgZnVuY3Rpb24gdGhhdCBpcyBjYWxsZWQgd2hlbiB0aGUgc3BlYyBmaW5zaGVzLiBGdW5jdGlvbihlcnJvciwgaW5kZXgpCiAqLwphbmd1bGFyLnNjZW5hcmlvLlNwZWNSdW5uZXIucHJvdG90eXBlLnJ1biA9IGZ1bmN0aW9uKHNwZWMsIHNwZWNEb25lKSB7CiAgdmFyIHNlbGYgPSB0aGlzOwogIHRoaXMuc3BlYyA9IHNwZWM7CgogIHRoaXMuZW1pdCgnU3BlY0JlZ2luJywgc3BlYyk7CgogIHRyeSB7CiAgICBzcGVjLmJlZm9yZS5jYWxsKHRoaXMpOwogICAgc3BlYy5ib2R5LmNhbGwodGhpcyk7CiAgICB0aGlzLmFmdGVySW5kZXggPSB0aGlzLmZ1dHVyZXMubGVuZ3RoOwogICAgc3BlYy5hZnRlci5jYWxsKHRoaXMpOwogIH0gY2F0Y2ggKGUpIHsKICAgIHRoaXMuZW1pdCgnU3BlY0Vycm9yJywgc3BlYywgZSk7CiAgICB0aGlzLmVtaXQoJ1NwZWNFbmQnLCBzcGVjKTsKICAgIHNwZWNEb25lKCk7CiAgICByZXR1cm47CiAgfQoKICB2YXIgaGFuZGxlRXJyb3IgPSBmdW5jdGlvbihlcnJvciwgZG9uZSkgewogICAgaWYgKHNlbGYuZXJyb3IpIHsKICAgICAgcmV0dXJuIGRvbmUoKTsKICAgIH0KICAgIHNlbGYuZXJyb3IgPSB0cnVlOwogICAgZG9uZShudWxsLCBzZWxmLmFmdGVySW5kZXgpOwogIH07CgogIGFzeW5jRm9yRWFjaCgKICAgIHRoaXMuZnV0dXJlcywKICAgIGZ1bmN0aW9uKGZ1dHVyZSwgZnV0dXJlRG9uZSkgewogICAgICBzZWxmLnN0ZXAgPSBmdXR1cmU7CiAgICAgIHNlbGYuZW1pdCgnU3RlcEJlZ2luJywgc3BlYywgZnV0dXJlKTsKICAgICAgdHJ5IHsKICAgICAgICBmdXR1cmUuZXhlY3V0ZShmdW5jdGlvbihlcnJvcikgewogICAgICAgICAgaWYgKGVycm9yKSB7CiAgICAgICAgICAgIHNlbGYuZW1pdCgnU3RlcEZhaWx1cmUnLCBzcGVjLCBmdXR1cmUsIGVycm9yKTsKICAgICAgICAgICAgc2VsZi5lbWl0KCdTdGVwRW5kJywgc3BlYywgZnV0dXJlKTsKICAgICAgICAgICAgcmV0dXJuIGhhbmRsZUVycm9yKGVycm9yLCBmdXR1cmVEb25lKTsKICAgICAgICAgIH0KICAgICAgICAgIHNlbGYuZW1pdCgnU3RlcEVuZCcsIHNwZWMsIGZ1dHVyZSk7CiAgICAgICAgICBzZWxmLiR3aW5kb3cuc2V0VGltZW91dChmdW5jdGlvbigpIHsgZnV0dXJlRG9uZSgpOyB9LCAwKTsKICAgICAgICB9KTsKICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgIHNlbGYuZW1pdCgnU3RlcEVycm9yJywgc3BlYywgZnV0dXJlLCBlKTsKICAgICAgICBzZWxmLmVtaXQoJ1N0ZXBFbmQnLCBzcGVjLCBmdXR1cmUpOwogICAgICAgIGhhbmRsZUVycm9yKGUsIGZ1dHVyZURvbmUpOwogICAgICB9CiAgICB9LAogICAgZnVuY3Rpb24oZSkgewogICAgICBpZiAoZSkgewogICAgICAgIHNlbGYuZW1pdCgnU3BlY0Vycm9yJywgc3BlYywgZSk7CiAgICAgIH0KICAgICAgc2VsZi5lbWl0KCdTcGVjRW5kJywgc3BlYyk7CiAgICAgIC8vIENhbGwgZG9uZSBpbiBhIHRpbWVvdXQgc28gZXhjZXB0aW9ucyBkb24ndCByZWN1cnNpdmVseQogICAgICAvLyBjYWxsIHRoaXMgZnVuY3Rpb24KICAgICAgc2VsZi4kd2luZG93LnNldFRpbWVvdXQoZnVuY3Rpb24oKSB7IHNwZWNEb25lKCk7IH0sIDApOwogICAgfQogICk7Cn07CgovKioKICogQWRkcyBhIG5ldyBmdXR1cmUgYWN0aW9uLgogKgogKiBOb3RlOiBEbyBub3QgcGFzcyBsaW5lIG1hbnVhbGx5LiBJdCBoYXBwZW5zIGF1dG9tYXRpY2FsbHkuCiAqCiAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIE5hbWUgb2YgdGhlIGZ1dHVyZQogKiBAcGFyYW0ge0Z1bmN0aW9ufSBiZWhhdmlvciBCZWhhdmlvciBvZiB0aGUgZnV0dXJlCiAqIEBwYXJhbSB7RnVuY3Rpb259IGxpbmUgZm4oKSB0aGF0IHJldHVybnMgZmlsZS9saW5lIG51bWJlcgogKi8KYW5ndWxhci5zY2VuYXJpby5TcGVjUnVubmVyLnByb3RvdHlwZS5hZGRGdXR1cmUgPSBmdW5jdGlvbihuYW1lLCBiZWhhdmlvciwgbGluZSkgewogIHZhciBmdXR1cmUgPSBuZXcgYW5ndWxhci5zY2VuYXJpby5GdXR1cmUobmFtZSwgYW5ndWxhci5iaW5kKHRoaXMsIGJlaGF2aW9yKSwgbGluZSk7CiAgdGhpcy5mdXR1cmVzLnB1c2goZnV0dXJlKTsKICByZXR1cm4gZnV0dXJlOwp9OwoKLyoqCiAqIEFkZHMgYSBuZXcgZnV0dXJlIGFjdGlvbiB0byBiZSBleGVjdXRlZCBvbiB0aGUgYXBwbGljYXRpb24gd2luZG93LgogKgogKiBOb3RlOiBEbyBub3QgcGFzcyBsaW5lIG1hbnVhbGx5LiBJdCBoYXBwZW5zIGF1dG9tYXRpY2FsbHkuCiAqCiAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIE5hbWUgb2YgdGhlIGZ1dHVyZQogKiBAcGFyYW0ge0Z1bmN0aW9ufSBiZWhhdmlvciBCZWhhdmlvciBvZiB0aGUgZnV0dXJlCiAqIEBwYXJhbSB7RnVuY3Rpb259IGxpbmUgZm4oKSB0aGF0IHJldHVybnMgZmlsZS9saW5lIG51bWJlcgogKi8KYW5ndWxhci5zY2VuYXJpby5TcGVjUnVubmVyLnByb3RvdHlwZS5hZGRGdXR1cmVBY3Rpb24gPSBmdW5jdGlvbihuYW1lLCBiZWhhdmlvciwgbGluZSkgewogIHZhciBzZWxmID0gdGhpczsKICByZXR1cm4gdGhpcy5hZGRGdXR1cmUobmFtZSwgZnVuY3Rpb24oZG9uZSkgewogICAgdGhpcy5hcHBsaWNhdGlvbi5leGVjdXRlQWN0aW9uKGZ1bmN0aW9uKCR3aW5kb3csICRkb2N1bWVudCkgewoKICAgICAgLy9UT0RPKGVzcHJlaG4pOiBSZWZhY3RvciB0aGlzIHNvIGl0IGRvZXNuJ3QgbmVlZCB0byBiZSBpbiBoZXJlLgogICAgICAkZG9jdW1lbnQuZWxlbWVudHMgPSBmdW5jdGlvbihzZWxlY3RvcikgewogICAgICAgIHZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKICAgICAgICBzZWxlY3RvciA9IChzZWxmLnNlbGVjdG9yIHx8ICcnKSArICcgJyArIChzZWxlY3RvciB8fCAnJyk7CiAgICAgICAgc2VsZWN0b3IgPSBfalF1ZXJ5LnRyaW0oc2VsZWN0b3IpIHx8ICcqJzsKICAgICAgICBhbmd1bGFyLmZvckVhY2goYXJncywgZnVuY3Rpb24odmFsdWUsIGluZGV4KSB7CiAgICAgICAgICBzZWxlY3RvciA9IHNlbGVjdG9yLnJlcGxhY2UoJyQnICsgKGluZGV4ICsgMSksIHZhbHVlKTsKICAgICAgICB9KTsKICAgICAgICB2YXIgcmVzdWx0ID0gJGRvY3VtZW50LmZpbmQoc2VsZWN0b3IpOwogICAgICAgIGlmICghcmVzdWx0Lmxlbmd0aCkgewogICAgICAgICAgdGhyb3cgewogICAgICAgICAgICB0eXBlOiAnc2VsZWN0b3InLAogICAgICAgICAgICBtZXNzYWdlOiAnU2VsZWN0b3IgJyArIHNlbGVjdG9yICsgJyBkaWQgbm90IG1hdGNoIGFueSBlbGVtZW50cy4nCiAgICAgICAgICB9OwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKCiAgICAgIHRyeSB7CiAgICAgICAgYmVoYXZpb3IuY2FsbChzZWxmLCAkd2luZG93LCAkZG9jdW1lbnQsIGRvbmUpOwogICAgICB9IGNhdGNoKGUpIHsKICAgICAgICBpZiAoZS50eXBlICYmIGUudHlwZSA9PT0gJ3NlbGVjdG9yJykgewogICAgICAgICAgZG9uZShlLm1lc3NhZ2UpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aHJvdyBlOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgfSwgbGluZSk7Cn07Cid1c2Ugc3RyaWN0JzsKCi8qKgogKiBTaGFyZWQgRFNMIHN0YXRlbWVudHMgdGhhdCBhcmUgdXNlZnVsIHRvIGFsbCBzY2VuYXJpb3MuCiAqLwoKIC8qKgogKiBVc2FnZToKICogICAgcGF1c2UoKSBwYXVzZXMgdW50aWwgeW91IGNhbGwgcmVzdW1lKCkgaW4gdGhlIGNvbnNvbGUKICovCmFuZ3VsYXIuc2NlbmFyaW8uZHNsKCdwYXVzZScsIGZ1bmN0aW9uKCkgewogIHJldHVybiBmdW5jdGlvbigpIHsKICAgIHJldHVybiB0aGlzLmFkZEZ1dHVyZSgncGF1c2luZyBmb3IgeW91IHRvIHJlc3VtZScsIGZ1bmN0aW9uKGRvbmUpIHsKICAgICAgdGhpcy5lbWl0KCdJbnRlcmFjdGl2ZVBhdXNlJywgdGhpcy5zcGVjLCB0aGlzLnN0ZXApOwogICAgICB0aGlzLiR3aW5kb3cucmVzdW1lID0gZnVuY3Rpb24oKSB7IGRvbmUoKTsgfTsKICAgIH0pOwogIH07Cn0pOwoKLyoqCiAqIFVzYWdlOgogKiAgICBzbGVlcChzZWNvbmRzKSBwYXVzZXMgdGhlIHRlc3QgZm9yIHNwZWNpZmllZCBudW1iZXIgb2Ygc2Vjb25kcwogKi8KYW5ndWxhci5zY2VuYXJpby5kc2woJ3NsZWVwJywgZnVuY3Rpb24oKSB7CiAgcmV0dXJuIGZ1bmN0aW9uKHRpbWUpIHsKICAgIHJldHVybiB0aGlzLmFkZEZ1dHVyZSgnc2xlZXAgZm9yICcgKyB0aW1lICsgJyBzZWNvbmRzJywgZnVuY3Rpb24oZG9uZSkgewogICAgICB0aGlzLiR3aW5kb3cuc2V0VGltZW91dChmdW5jdGlvbigpIHsgZG9uZShudWxsLCB0aW1lICogMTAwMCk7IH0sIHRpbWUgKiAxMDAwKTsKICAgIH0pOwogIH07Cn0pOwoKLyoqCiAqIFVzYWdlOgogKiAgICBicm93c2VyKCkubmF2aWdhdGVUbyh1cmwpIExvYWRzIHRoZSB1cmwgaW50byB0aGUgZnJhbWUKICogICAgYnJvd3NlcigpLm5hdmlnYXRlVG8odXJsLCBmbikgd2hlcmUgZm4odXJsKSBpcyBjYWxsZWQgYW5kIHJldHVybnMgdGhlIFVSTCB0byBuYXZpZ2F0ZSB0bwogKiAgICBicm93c2VyKCkucmVsb2FkKCkgcmVmcmVzaCB0aGUgcGFnZSAocmVsb2FkIHRoZSBzYW1lIFVSTCkKICogICAgYnJvd3NlcigpLmxvY2F0aW9uKCkuaHJlZigpIHRoZSBmdWxsIFVSTCBvZiB0aGUgcGFnZQogKiAgICBicm93c2VyKCkubG9jYXRpb24oKS5oYXNoKCkgdGhlIGZ1bGwgaGFzaCBpbiB0aGUgdXJsCiAqICAgIGJyb3dzZXIoKS5sb2NhdGlvbigpLnBhdGgoKSB0aGUgZnVsbCBwYXRoIGluIHRoZSB1cmwKICogICAgYnJvd3NlcigpLmxvY2F0aW9uKCkuaGFzaFNlYXJjaCgpIHRoZSBoYXNoU2VhcmNoIE9iamVjdCBmcm9tIGFuZ3VsYXIKICogICAgYnJvd3NlcigpLmxvY2F0aW9uKCkuaGFzaFBhdGgoKSB0aGUgaGFzaFBhdGggc3RyaW5nIGZyb20gYW5ndWxhcgogKi8KYW5ndWxhci5zY2VuYXJpby5kc2woJ2Jyb3dzZXInLCBmdW5jdGlvbigpIHsKICB2YXIgY2hhaW4gPSB7fTsKCiAgY2hhaW4ubmF2aWdhdGVUbyA9IGZ1bmN0aW9uKHVybCwgZGVsZWdhdGUpIHsKICAgIHZhciBhcHBsaWNhdGlvbiA9IHRoaXMuYXBwbGljYXRpb247CiAgICByZXR1cm4gdGhpcy5hZGRGdXR1cmUoImJyb3dzZXIgbmF2aWdhdGUgdG8gJyIgKyB1cmwgKyAiJyIsIGZ1bmN0aW9uKGRvbmUpIHsKICAgICAgaWYgKGRlbGVnYXRlKSB7CiAgICAgICAgdXJsID0gZGVsZWdhdGUuY2FsbCh0aGlzLCB1cmwpOwogICAgICB9CiAgICAgIGFwcGxpY2F0aW9uLm5hdmlnYXRlVG8odXJsLCBmdW5jdGlvbigpIHsKICAgICAgICBkb25lKG51bGwsIHVybCk7CiAgICAgIH0sIGRvbmUpOwogICAgfSk7CiAgfTsKCiAgY2hhaW4ucmVsb2FkID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgYXBwbGljYXRpb24gPSB0aGlzLmFwcGxpY2F0aW9uOwogICAgcmV0dXJuIHRoaXMuYWRkRnV0dXJlQWN0aW9uKCdicm93c2VyIHJlbG9hZCcsIGZ1bmN0aW9uKCR3aW5kb3csICRkb2N1bWVudCwgZG9uZSkgewogICAgICB2YXIgaHJlZiA9ICR3aW5kb3cubG9jYXRpb24uaHJlZjsKICAgICAgYXBwbGljYXRpb24ubmF2aWdhdGVUbyhocmVmLCBmdW5jdGlvbigpIHsKICAgICAgICBkb25lKG51bGwsIGhyZWYpOwogICAgICB9LCBkb25lKTsKICAgIH0pOwogIH07CgogIGNoYWluLmxvY2F0aW9uID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgYXBpID0ge307CgogICAgYXBpLmhyZWYgPSBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHRoaXMuYWRkRnV0dXJlQWN0aW9uKCdicm93c2VyIHVybCcsIGZ1bmN0aW9uKCR3aW5kb3csICRkb2N1bWVudCwgZG9uZSkgewogICAgICAgIGRvbmUobnVsbCwgJHdpbmRvdy5sb2NhdGlvbi5ocmVmKTsKICAgICAgfSk7CiAgICB9OwoKICAgIGFwaS5oYXNoID0gZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB0aGlzLmFkZEZ1dHVyZUFjdGlvbignYnJvd3NlciB1cmwgaGFzaCcsIGZ1bmN0aW9uKCR3aW5kb3csICRkb2N1bWVudCwgZG9uZSkgewogICAgICAgIGRvbmUobnVsbCwgJHdpbmRvdy5sb2NhdGlvbi5oYXNoLnJlcGxhY2UoJyMnLCAnJykpOwogICAgICB9KTsKICAgIH07CgogICAgYXBpLnBhdGggPSBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHRoaXMuYWRkRnV0dXJlQWN0aW9uKCdicm93c2VyIHVybCBwYXRoJywgZnVuY3Rpb24oJHdpbmRvdywgJGRvY3VtZW50LCBkb25lKSB7CiAgICAgICAgZG9uZShudWxsLCAkd2luZG93LmxvY2F0aW9uLnBhdGhuYW1lKTsKICAgICAgfSk7CiAgICB9OwoKICAgIGFwaS5zZWFyY2ggPSBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHRoaXMuYWRkRnV0dXJlQWN0aW9uKCdicm93c2VyIHVybCBzZWFyY2gnLCBmdW5jdGlvbigkd2luZG93LCAkZG9jdW1lbnQsIGRvbmUpIHsKICAgICAgICBkb25lKG51bGwsICR3aW5kb3cuYW5ndWxhci5zY29wZSgpLiRzZXJ2aWNlKCckbG9jYXRpb24nKS5zZWFyY2gpOwogICAgICB9KTsKICAgIH07CgogICAgYXBpLmhhc2hTZWFyY2ggPSBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHRoaXMuYWRkRnV0dXJlQWN0aW9uKCdicm93c2VyIHVybCBoYXNoIHNlYXJjaCcsIGZ1bmN0aW9uKCR3aW5kb3csICRkb2N1bWVudCwgZG9uZSkgewogICAgICAgIGRvbmUobnVsbCwgJHdpbmRvdy5hbmd1bGFyLnNjb3BlKCkuJHNlcnZpY2UoJyRsb2NhdGlvbicpLmhhc2hTZWFyY2gpOwogICAgICB9KTsKICAgIH07CgogICAgYXBpLmhhc2hQYXRoID0gZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB0aGlzLmFkZEZ1dHVyZUFjdGlvbignYnJvd3NlciB1cmwgaGFzaCBwYXRoJywgZnVuY3Rpb24oJHdpbmRvdywgJGRvY3VtZW50LCBkb25lKSB7CiAgICAgICAgZG9uZShudWxsLCAkd2luZG93LmFuZ3VsYXIuc2NvcGUoKS4kc2VydmljZSgnJGxvY2F0aW9uJykuaGFzaFBhdGgpOwogICAgICB9KTsKICAgIH07CgogICAgcmV0dXJuIGFwaTsKICB9OwoKICByZXR1cm4gZnVuY3Rpb24odGltZSkgewogICAgcmV0dXJuIGNoYWluOwogIH07Cn0pOwoKLyoqCiAqIFVzYWdlOgogKiAgICBleHBlY3QoZnV0dXJlKS57bWF0Y2hlcn0gd2hlcmUgbWF0Y2hlciBpcyBvbmUgb2YgdGhlIG1hdGNoZXJzIGRlZmluZWQKICogICAgd2l0aCBhbmd1bGFyLnNjZW5hcmlvLm1hdGNoZXIKICoKICogZXguIGV4cGVjdChiaW5kaW5nKCJuYW1lIikpLnRvRXF1YWwoIkVsbGlvdHQiKQogKi8KYW5ndWxhci5zY2VuYXJpby5kc2woJ2V4cGVjdCcsIGZ1bmN0aW9uKCkgewogIHZhciBjaGFpbiA9IGFuZ3VsYXIuZXh0ZW5kKHt9LCBhbmd1bGFyLnNjZW5hcmlvLm1hdGNoZXIpOwoKICBjaGFpbi5ub3QgPSBmdW5jdGlvbigpIHsKICAgIHRoaXMuaW52ZXJzZSA9IHRydWU7CiAgICByZXR1cm4gY2hhaW47CiAgfTsKCiAgcmV0dXJuIGZ1bmN0aW9uKGZ1dHVyZSkgewogICAgdGhpcy5mdXR1cmUgPSBmdXR1cmU7CiAgICByZXR1cm4gY2hhaW47CiAgfTsKfSk7CgovKioKICogVXNhZ2U6CiAqICAgIHVzaW5nKHNlbGVjdG9yLCBsYWJlbCkgc2NvcGVzIHRoZSBuZXh0IERTTCBlbGVtZW50IHNlbGVjdGlvbgogKgogKiBleC4KICogICB1c2luZygnI2ZvbycsICInRm9vJyB0ZXh0IGZpZWxkIikuaW5wdXQoJ2JhcicpCiAqLwphbmd1bGFyLnNjZW5hcmlvLmRzbCgndXNpbmcnLCBmdW5jdGlvbigpIHsKICByZXR1cm4gZnVuY3Rpb24oc2VsZWN0b3IsIGxhYmVsKSB7CiAgICB0aGlzLnNlbGVjdG9yID0gX2pRdWVyeS50cmltKCh0aGlzLnNlbGVjdG9yfHwnJykgKyAnICcgKyBzZWxlY3Rvcik7CiAgICBpZiAoYW5ndWxhci5pc1N0cmluZyhsYWJlbCkgJiYgbGFiZWwubGVuZ3RoKSB7CiAgICAgIHRoaXMubGFiZWwgPSBsYWJlbCArICcgKCAnICsgdGhpcy5zZWxlY3RvciArICcgKSc7CiAgICB9IGVsc2UgewogICAgICB0aGlzLmxhYmVsID0gdGhpcy5zZWxlY3RvcjsKICAgIH0KICAgIHJldHVybiB0aGlzLmRzbDsKICB9Owp9KTsKCi8qKgogKiBVc2FnZToKICogICAgYmluZGluZyhuYW1lKSByZXR1cm5zIHRoZSB2YWx1ZSBvZiB0aGUgZmlyc3QgbWF0Y2hpbmcgYmluZGluZwogKi8KYW5ndWxhci5zY2VuYXJpby5kc2woJ2JpbmRpbmcnLCBmdW5jdGlvbigpIHsKICByZXR1cm4gZnVuY3Rpb24obmFtZSkgewogICAgcmV0dXJuIHRoaXMuYWRkRnV0dXJlQWN0aW9uKCJzZWxlY3QgYmluZGluZyAnIiArIG5hbWUgKyAiJyIsIGZ1bmN0aW9uKCR3aW5kb3csICRkb2N1bWVudCwgZG9uZSkgewogICAgICB2YXIgdmFsdWVzID0gJGRvY3VtZW50LmVsZW1lbnRzKCkuYmluZGluZ3MobmFtZSk7CiAgICAgIGlmICghdmFsdWVzLmxlbmd0aCkgewogICAgICAgIHJldHVybiBkb25lKCJCaW5kaW5nIHNlbGVjdG9yICciICsgbmFtZSArICInIGRpZCBub3QgbWF0Y2guIik7CiAgICAgIH0KICAgICAgZG9uZShudWxsLCB2YWx1ZXNbMF0pOwogICAgfSk7CiAgfTsKfSk7CgovKioKICogVXNhZ2U6CiAqICAgIGlucHV0KG5hbWUpLmVudGVyKHZhbHVlKSBlbnRlcnMgdmFsdWUgaW4gaW5wdXQgd2l0aCBzcGVjaWZpZWQgbmFtZQogKiAgICBpbnB1dChuYW1lKS5jaGVjaygpIGNoZWNrcyBjaGVja2JveAogKiAgICBpbnB1dChuYW1lKS5zZWxlY3QodmFsdWUpIHNlbGVjdHMgdGhlIHJhZGlvIGJ1dHRvbiB3aXRoIHNwZWNpZmllZCBuYW1lL3ZhbHVlCiAqICAgIGlucHV0KG5hbWUpLnZhbCgpIHJldHVybnMgdGhlIHZhbHVlIG9mIHRoZSBpbnB1dC4KICovCmFuZ3VsYXIuc2NlbmFyaW8uZHNsKCdpbnB1dCcsIGZ1bmN0aW9uKCkgewogIHZhciBjaGFpbiA9IHt9OwoKICBjaGFpbi5lbnRlciA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICByZXR1cm4gdGhpcy5hZGRGdXR1cmVBY3Rpb24oImlucHV0ICciICsgdGhpcy5uYW1lICsgIicgZW50ZXIgJyIgKyB2YWx1ZSArICInIiwgZnVuY3Rpb24oJHdpbmRvdywgJGRvY3VtZW50LCBkb25lKSB7CiAgICAgIHZhciBpbnB1dCA9ICRkb2N1bWVudC5lbGVtZW50cygnOmlucHV0W25hbWU9IiQxIl0nLCB0aGlzLm5hbWUpOwogICAgICBpbnB1dC52YWwodmFsdWUpOwogICAgICBpbnB1dC50cmlnZ2VyKCdrZXlkb3duJyk7CiAgICAgIGRvbmUoKTsKICAgIH0pOwogIH07CgogIGNoYWluLmNoZWNrID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gdGhpcy5hZGRGdXR1cmVBY3Rpb24oImNoZWNrYm94ICciICsgdGhpcy5uYW1lICsgIicgdG9nZ2xlIiwgZnVuY3Rpb24oJHdpbmRvdywgJGRvY3VtZW50LCBkb25lKSB7CiAgICAgIHZhciBpbnB1dCA9ICRkb2N1bWVudC5lbGVtZW50cygnOmNoZWNrYm94W25hbWU9IiQxIl0nLCB0aGlzLm5hbWUpOwogICAgICBpbnB1dC50cmlnZ2VyKCdjbGljaycpOwogICAgICBkb25lKCk7CiAgICB9KTsKICB9OwoKICBjaGFpbi5zZWxlY3QgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgcmV0dXJuIHRoaXMuYWRkRnV0dXJlQWN0aW9uKCJyYWRpbyBidXR0b24gJyIgKyB0aGlzLm5hbWUgKyAiJyB0b2dnbGUgJyIgKyB2YWx1ZSArICInIiwgZnVuY3Rpb24oJHdpbmRvdywgJGRvY3VtZW50LCBkb25lKSB7CiAgICAgIHZhciBpbnB1dCA9ICRkb2N1bWVudC4KICAgICAgICBlbGVtZW50cygnOnJhZGlvW25hbWUkPSJAJDEiXVt2YWx1ZT0iJDIiXScsIHRoaXMubmFtZSwgdmFsdWUpOwogICAgICBpbnB1dC50cmlnZ2VyKCdjbGljaycpOwogICAgICBkb25lKCk7CiAgICB9KTsKICB9OwoKICBjaGFpbi52YWwgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiB0aGlzLmFkZEZ1dHVyZUFjdGlvbigicmV0dXJuIGlucHV0IHZhbCIsIGZ1bmN0aW9uKCR3aW5kb3csICRkb2N1bWVudCwgZG9uZSkgewogICAgICB2YXIgaW5wdXQgPSAkZG9jdW1lbnQuZWxlbWVudHMoJzppbnB1dFtuYW1lPSIkMSJdJywgdGhpcy5uYW1lKTsKICAgICAgZG9uZShudWxsLGlucHV0LnZhbCgpKTsKICAgIH0pOwogIH07CgogIHJldHVybiBmdW5jdGlvbihuYW1lKSB7CiAgICB0aGlzLm5hbWUgPSBuYW1lOwogICAgcmV0dXJuIGNoYWluOwogIH07Cn0pOwoKCi8qKgogKiBVc2FnZToKICogICAgcmVwZWF0ZXIoJyNwcm9kdWN0cyB0YWJsZScsICdQcm9kdWN0IExpc3QnKS5jb3VudCgpIG51bWJlciBvZiByb3dzCiAqICAgIHJlcGVhdGVyKCcjcHJvZHVjdHMgdGFibGUnLCAnUHJvZHVjdCBMaXN0Jykucm93KDEpIGFsbCBiaW5kaW5ncyBpbiByb3cgYXMgYW4gYXJyYXkKICogICAgcmVwZWF0ZXIoJyNwcm9kdWN0cyB0YWJsZScsICdQcm9kdWN0IExpc3QnKS5jb2x1bW4oJ3Byb2R1Y3QubmFtZScpIGFsbCB2YWx1ZXMgYWNyb3NzIGFsbCByb3dzIGluIGFuIGFycmF5CiAqLwphbmd1bGFyLnNjZW5hcmlvLmRzbCgncmVwZWF0ZXInLCBmdW5jdGlvbigpIHsKICB2YXIgY2hhaW4gPSB7fTsKCiAgY2hhaW4uY291bnQgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiB0aGlzLmFkZEZ1dHVyZUFjdGlvbigicmVwZWF0ZXIgJyIgKyB0aGlzLmxhYmVsICsgIicgY291bnQiLCBmdW5jdGlvbigkd2luZG93LCAkZG9jdW1lbnQsIGRvbmUpIHsKICAgICAgdHJ5IHsKICAgICAgICBkb25lKG51bGwsICRkb2N1bWVudC5lbGVtZW50cygpLmxlbmd0aCk7CiAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICBkb25lKG51bGwsIDApOwogICAgICB9CiAgICB9KTsKICB9OwoKICBjaGFpbi5jb2x1bW4gPSBmdW5jdGlvbihiaW5kaW5nKSB7CiAgICByZXR1cm4gdGhpcy5hZGRGdXR1cmVBY3Rpb24oInJlcGVhdGVyICciICsgdGhpcy5sYWJlbCArICInIGNvbHVtbiAnIiArIGJpbmRpbmcgKyAiJyIsIGZ1bmN0aW9uKCR3aW5kb3csICRkb2N1bWVudCwgZG9uZSkgewogICAgICBkb25lKG51bGwsICRkb2N1bWVudC5lbGVtZW50cygpLmJpbmRpbmdzKGJpbmRpbmcpKTsKICAgIH0pOwogIH07CgogIGNoYWluLnJvdyA9IGZ1bmN0aW9uKGluZGV4KSB7CiAgICByZXR1cm4gdGhpcy5hZGRGdXR1cmVBY3Rpb24oInJlcGVhdGVyICciICsgdGhpcy5sYWJlbCArICInIHJvdyAnIiArIGluZGV4ICsgIiciLCBmdW5jdGlvbigkd2luZG93LCAkZG9jdW1lbnQsIGRvbmUpIHsKICAgICAgdmFyIHZhbHVlcyA9IFtdOwogICAgICB2YXIgbWF0Y2hlcyA9ICRkb2N1bWVudC5lbGVtZW50cygpLnNsaWNlKGluZGV4LCBpbmRleCArIDEpOwogICAgICBpZiAoIW1hdGNoZXMubGVuZ3RoKQogICAgICAgIHJldHVybiBkb25lKCdyb3cgJyArIGluZGV4ICsgJyBvdXQgb2YgYm91bmRzJyk7CiAgICAgIGRvbmUobnVsbCwgbWF0Y2hlcy5iaW5kaW5ncygpKTsKICAgIH0pOwogIH07CgogIHJldHVybiBmdW5jdGlvbihzZWxlY3RvciwgbGFiZWwpIHsKICAgIHRoaXMuZHNsLnVzaW5nKHNlbGVjdG9yLCBsYWJlbCk7CiAgICByZXR1cm4gY2hhaW47CiAgfTsKfSk7CgovKioKICogVXNhZ2U6CiAqICAgIHNlbGVjdChuYW1lKS5vcHRpb24oJ3ZhbHVlJykgc2VsZWN0IG9uZSBvcHRpb24KICogICAgc2VsZWN0KG5hbWUpLm9wdGlvbnMoJ3ZhbHVlMScsICd2YWx1ZTInLCAuLi4pIHNlbGVjdCBvcHRpb25zIGZyb20gYSBtdWx0aSBzZWxlY3QKICovCmFuZ3VsYXIuc2NlbmFyaW8uZHNsKCdzZWxlY3QnLCBmdW5jdGlvbigpIHsKICB2YXIgY2hhaW4gPSB7fTsKCiAgY2hhaW4ub3B0aW9uID0gZnVuY3Rpb24odmFsdWUpIHsKICAgIHJldHVybiB0aGlzLmFkZEZ1dHVyZUFjdGlvbigic2VsZWN0ICciICsgdGhpcy5uYW1lICsgIicgb3B0aW9uICciICsgdmFsdWUgKyAiJyIsIGZ1bmN0aW9uKCR3aW5kb3csICRkb2N1bWVudCwgZG9uZSkgewogICAgICB2YXIgc2VsZWN0ID0gJGRvY3VtZW50LmVsZW1lbnRzKCdzZWxlY3RbbmFtZT0iJDEiXScsIHRoaXMubmFtZSk7CiAgICAgIHNlbGVjdC52YWwodmFsdWUpOwogICAgICBzZWxlY3QudHJpZ2dlcignY2hhbmdlJyk7CiAgICAgIGRvbmUoKTsKICAgIH0pOwogIH07CgogIGNoYWluLm9wdGlvbnMgPSBmdW5jdGlvbigpIHsKICAgIHZhciB2YWx1ZXMgPSBhcmd1bWVudHM7CiAgICByZXR1cm4gdGhpcy5hZGRGdXR1cmVBY3Rpb24oInNlbGVjdCAnIiArIHRoaXMubmFtZSArICInIG9wdGlvbnMgJyIgKyB2YWx1ZXMgKyAiJyIsIGZ1bmN0aW9uKCR3aW5kb3csICRkb2N1bWVudCwgZG9uZSkgewogICAgICB2YXIgc2VsZWN0ID0gJGRvY3VtZW50LmVsZW1lbnRzKCdzZWxlY3RbbXVsdGlwbGVdW25hbWU9IiQxIl0nLCB0aGlzLm5hbWUpOwogICAgICBzZWxlY3QudmFsKHZhbHVlcyk7CiAgICAgIHNlbGVjdC50cmlnZ2VyKCdjaGFuZ2UnKTsKICAgICAgZG9uZSgpOwogICAgfSk7CiAgfTsKCiAgcmV0dXJuIGZ1bmN0aW9uKG5hbWUpIHsKICAgIHRoaXMubmFtZSA9IG5hbWU7CiAgICByZXR1cm4gY2hhaW47CiAgfTsKfSk7CgovKioKICogVXNhZ2U6CiAqICAgIGVsZW1lbnQoc2VsZWN0b3IsIGxhYmVsKS5jb3VudCgpIGdldCB0aGUgbnVtYmVyIG9mIGVsZW1lbnRzIHRoYXQgbWF0Y2ggc2VsZWN0b3IKICogICAgZWxlbWVudChzZWxlY3RvciwgbGFiZWwpLmNsaWNrKCkgY2xpY2tzIGFuIGVsZW1lbnQKICogICAgZWxlbWVudChzZWxlY3RvciwgbGFiZWwpLnF1ZXJ5KGZuKSBleGVjdXRlcyBmbihzZWxlY3RlZEVsZW1lbnRzLCBkb25lKQogKiAgICBlbGVtZW50KHNlbGVjdG9yLCBsYWJlbCkue21ldGhvZH0oKSBnZXRzIHRoZSB2YWx1ZSAoYXMgZGVmaW5lZCBieSBqUXVlcnksIGV4LiB2YWwpCiAqICAgIGVsZW1lbnQoc2VsZWN0b3IsIGxhYmVsKS57bWV0aG9kfSh2YWx1ZSkgc2V0cyB0aGUgdmFsdWUgKGFzIGRlZmluZWQgYnkgalF1ZXJ5LCBleC4gdmFsKQogKiAgICBlbGVtZW50KHNlbGVjdG9yLCBsYWJlbCkue21ldGhvZH0oa2V5KSBnZXRzIHRoZSB2YWx1ZSAoYXMgZGVmaW5lZCBieSBqUXVlcnksIGV4LiBhdHRyKQogKiAgICBlbGVtZW50KHNlbGVjdG9yLCBsYWJlbCkue21ldGhvZH0oa2V5LCB2YWx1ZSkgc2V0cyB0aGUgdmFsdWUgKGFzIGRlZmluZWQgYnkgalF1ZXJ5LCBleC4gYXR0cikKICovCmFuZ3VsYXIuc2NlbmFyaW8uZHNsKCdlbGVtZW50JywgZnVuY3Rpb24oKSB7CiAgdmFyIEtFWV9WQUxVRV9NRVRIT0RTID0gWydhdHRyJywgJ2NzcyddOwogIHZhciBWQUxVRV9NRVRIT0RTID0gWwogICAgJ3ZhbCcsICd0ZXh0JywgJ2h0bWwnLCAnaGVpZ2h0JywgJ2lubmVySGVpZ2h0JywgJ291dGVySGVpZ2h0JywgJ3dpZHRoJywKICAgICdpbm5lcldpZHRoJywgJ291dGVyV2lkdGgnLCAncG9zaXRpb24nLCAnc2Nyb2xsTGVmdCcsICdzY3JvbGxUb3AnLCAnb2Zmc2V0JwogIF07CiAgdmFyIGNoYWluID0ge307CgogIGNoYWluLmNvdW50ID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gdGhpcy5hZGRGdXR1cmVBY3Rpb24oImVsZW1lbnQgJyIgKyB0aGlzLmxhYmVsICsgIicgY291bnQiLCBmdW5jdGlvbigkd2luZG93LCAkZG9jdW1lbnQsIGRvbmUpIHsKICAgICAgdHJ5IHsKICAgICAgICBkb25lKG51bGwsICRkb2N1bWVudC5lbGVtZW50cygpLmxlbmd0aCk7CiAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICBkb25lKG51bGwsIDApOwogICAgICB9CiAgICB9KTsKICB9OwoKICBjaGFpbi5jbGljayA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHRoaXMuYWRkRnV0dXJlQWN0aW9uKCJlbGVtZW50ICciICsgdGhpcy5sYWJlbCArICInIGNsaWNrIiwgZnVuY3Rpb24oJHdpbmRvdywgJGRvY3VtZW50LCBkb25lKSB7CiAgICAgIHZhciBlbGVtZW50cyA9ICRkb2N1bWVudC5lbGVtZW50cygpOwogICAgICB2YXIgaHJlZiA9IGVsZW1lbnRzLmF0dHIoJ2hyZWYnKTsKICAgICAgZWxlbWVudHMudHJpZ2dlcignY2xpY2snKTsKICAgICAgaWYgKGhyZWYgJiYgZWxlbWVudHNbMF0ubm9kZU5hbWUudG9VcHBlckNhc2UoKSA9PT0gJ0EnKSB7CiAgICAgICAgdGhpcy5hcHBsaWNhdGlvbi5uYXZpZ2F0ZVRvKGhyZWYsIGZ1bmN0aW9uKCkgewogICAgICAgICAgZG9uZSgpOwogICAgICAgIH0sIGRvbmUpOwogICAgICB9IGVsc2UgewogICAgICAgIGRvbmUoKTsKICAgICAgfQogICAgfSk7CiAgfTsKCiAgY2hhaW4ucXVlcnkgPSBmdW5jdGlvbihmbikgewogICAgcmV0dXJuIHRoaXMuYWRkRnV0dXJlQWN0aW9uKCdlbGVtZW50ICcgKyB0aGlzLmxhYmVsICsgJyBjdXN0b20gcXVlcnknLCBmdW5jdGlvbigkd2luZG93LCAkZG9jdW1lbnQsIGRvbmUpIHsKICAgICAgZm4uY2FsbCh0aGlzLCAkZG9jdW1lbnQuZWxlbWVudHMoKSwgZG9uZSk7CiAgICB9KTsKICB9OwoKICBhbmd1bGFyLmZvckVhY2goS0VZX1ZBTFVFX01FVEhPRFMsIGZ1bmN0aW9uKG1ldGhvZE5hbWUpIHsKICAgIGNoYWluW21ldGhvZE5hbWVdID0gZnVuY3Rpb24obmFtZSwgdmFsdWUpIHsKICAgICAgdmFyIGZ1dHVyZU5hbWUgPSAiZWxlbWVudCAnIiArIHRoaXMubGFiZWwgKyAiJyBnZXQgIiArIG1ldGhvZE5hbWUgKyAiICciICsgbmFtZSArICInIjsKICAgICAgaWYgKGFuZ3VsYXIuaXNEZWZpbmVkKHZhbHVlKSkgewogICAgICAgIGZ1dHVyZU5hbWUgPSAiZWxlbWVudCAnIiArIHRoaXMubGFiZWwgKyAiJyBzZXQgIiArIG1ldGhvZE5hbWUgKyAiICciICsgbmFtZSArICInIHRvICIgKyAiJyIgKyB2YWx1ZSArICInIjsKICAgICAgfQogICAgICByZXR1cm4gdGhpcy5hZGRGdXR1cmVBY3Rpb24oZnV0dXJlTmFtZSwgZnVuY3Rpb24oJHdpbmRvdywgJGRvY3VtZW50LCBkb25lKSB7CiAgICAgICAgdmFyIGVsZW1lbnQgPSAkZG9jdW1lbnQuZWxlbWVudHMoKTsKICAgICAgICBkb25lKG51bGwsIGVsZW1lbnRbbWV0aG9kTmFtZV0uY2FsbChlbGVtZW50LCBuYW1lLCB2YWx1ZSkpOwogICAgICB9KTsKICAgIH07CiAgfSk7CgogIGFuZ3VsYXIuZm9yRWFjaChWQUxVRV9NRVRIT0RTLCBmdW5jdGlvbihtZXRob2ROYW1lKSB7CiAgICBjaGFpblttZXRob2ROYW1lXSA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIHZhciBmdXR1cmVOYW1lID0gImVsZW1lbnQgJyIgKyB0aGlzLmxhYmVsICsgIicgIiArIG1ldGhvZE5hbWU7CiAgICAgIGlmIChhbmd1bGFyLmlzRGVmaW5lZCh2YWx1ZSkpIHsKICAgICAgICBmdXR1cmVOYW1lID0gImVsZW1lbnQgJyIgKyB0aGlzLmxhYmVsICsgIicgc2V0ICIgKyBtZXRob2ROYW1lICsgIiB0byAnIiArIHZhbHVlICsgIiciOwogICAgICB9CiAgICAgIHJldHVybiB0aGlzLmFkZEZ1dHVyZUFjdGlvbihmdXR1cmVOYW1lLCBmdW5jdGlvbigkd2luZG93LCAkZG9jdW1lbnQsIGRvbmUpIHsKICAgICAgICB2YXIgZWxlbWVudCA9ICRkb2N1bWVudC5lbGVtZW50cygpOwogICAgICAgIGRvbmUobnVsbCwgZWxlbWVudFttZXRob2ROYW1lXS5jYWxsKGVsZW1lbnQsIHZhbHVlKSk7CiAgICAgIH0pOwogICAgfTsKICB9KTsKCiAgcmV0dXJuIGZ1bmN0aW9uKHNlbGVjdG9yLCBsYWJlbCkgewogICAgdGhpcy5kc2wudXNpbmcoc2VsZWN0b3IsIGxhYmVsKTsKICAgIHJldHVybiBjaGFpbjsKICB9Owp9KTsKJ3VzZSBzdHJpY3QnOwoKLyoqCiAqIE1hdGNoZXJzIGZvciBpbXBsZW1lbnRpbmcgc3BlY3MuIEZvbGxvd3MgdGhlIEphc21pbmUgc3BlYyBjb252ZW50aW9ucy4KICovCgphbmd1bGFyLnNjZW5hcmlvLm1hdGNoZXIoJ3RvRXF1YWwnLCBmdW5jdGlvbihleHBlY3RlZCkgewogIHJldHVybiBhbmd1bGFyLmVxdWFscyh0aGlzLmFjdHVhbCwgZXhwZWN0ZWQpOwp9KTsKCmFuZ3VsYXIuc2NlbmFyaW8ubWF0Y2hlcigndG9CZScsIGZ1bmN0aW9uKGV4cGVjdGVkKSB7CiAgcmV0dXJuIHRoaXMuYWN0dWFsID09PSBleHBlY3RlZDsKfSk7Cgphbmd1bGFyLnNjZW5hcmlvLm1hdGNoZXIoJ3RvQmVEZWZpbmVkJywgZnVuY3Rpb24oKSB7CiAgcmV0dXJuIGFuZ3VsYXIuaXNEZWZpbmVkKHRoaXMuYWN0dWFsKTsKfSk7Cgphbmd1bGFyLnNjZW5hcmlvLm1hdGNoZXIoJ3RvQmVUcnV0aHknLCBmdW5jdGlvbigpIHsKICByZXR1cm4gdGhpcy5hY3R1YWw7Cn0pOwoKYW5ndWxhci5zY2VuYXJpby5tYXRjaGVyKCd0b0JlRmFsc3knLCBmdW5jdGlvbigpIHsKICByZXR1cm4gIXRoaXMuYWN0dWFsOwp9KTsKCmFuZ3VsYXIuc2NlbmFyaW8ubWF0Y2hlcigndG9NYXRjaCcsIGZ1bmN0aW9uKGV4cGVjdGVkKSB7CiAgcmV0dXJuIG5ldyBSZWdFeHAoZXhwZWN0ZWQpLnRlc3QodGhpcy5hY3R1YWwpOwp9KTsKCmFuZ3VsYXIuc2NlbmFyaW8ubWF0Y2hlcigndG9CZU51bGwnLCBmdW5jdGlvbigpIHsKICByZXR1cm4gdGhpcy5hY3R1YWwgPT09IG51bGw7Cn0pOwoKYW5ndWxhci5zY2VuYXJpby5tYXRjaGVyKCd0b0NvbnRhaW4nLCBmdW5jdGlvbihleHBlY3RlZCkgewogIHJldHVybiBpbmNsdWRlcyh0aGlzLmFjdHVhbCwgZXhwZWN0ZWQpOwp9KTsKCmFuZ3VsYXIuc2NlbmFyaW8ubWF0Y2hlcigndG9CZUxlc3NUaGFuJywgZnVuY3Rpb24oZXhwZWN0ZWQpIHsKICByZXR1cm4gdGhpcy5hY3R1YWwgPCBleHBlY3RlZDsKfSk7Cgphbmd1bGFyLnNjZW5hcmlvLm1hdGNoZXIoJ3RvQmVHcmVhdGVyVGhhbicsIGZ1bmN0aW9uKGV4cGVjdGVkKSB7CiAgcmV0dXJuIHRoaXMuYWN0dWFsID4gZXhwZWN0ZWQ7Cn0pOwondXNlIHN0cmljdCc7CgovKioKICogVXNlciBJbnRlcmZhY2UgZm9yIHRoZSBTY2VuYXJpbyBSdW5uZXIuCiAqCiAqIFRPRE8oZXNwcmVobik6IFRoaXMgc2hvdWxkIGJlIHJlZmFjdG9yZWQgbm93IHRoYXQgT2JqZWN0TW9kZWwgZXhpc3RzCiAqICB0byB1c2UgYW5ndWxhciBiaW5kaW5ncyBmb3IgdGhlIFVJLgogKi8KYW5ndWxhci5zY2VuYXJpby5vdXRwdXQoJ2h0bWwnLCBmdW5jdGlvbihjb250ZXh0LCBydW5uZXIsIG1vZGVsKSB7CiAgdmFyIHNwZWNVaU1hcCA9IHt9LAogICAgICBsYXN0U3RlcFVpTWFwID0ge307CgogIGNvbnRleHQuYXBwZW5kKAogICAgJzxkaXYgaWQ9ImhlYWRlciI+JyArCiAgICAnICA8aDE+PHNwYW4gY2xhc3M9ImFuZ3VsYXIiPiZsdDthbmd1bGFyLyZndDs8L3NwYW4+OiBTY2VuYXJpbyBUZXN0IFJ1bm5lcjwvaDE+JyArCiAgICAnICA8dWwgaWQ9InN0YXR1cy1sZWdlbmQiIGNsYXNzPSJzdGF0dXMtZGlzcGxheSI+JyArCiAgICAnICAgIDxsaSBjbGFzcz0ic3RhdHVzLWVycm9yIj4wIEVycm9yczwvbGk+JyArCiAgICAnICAgIDxsaSBjbGFzcz0ic3RhdHVzLWZhaWx1cmUiPjAgRmFpbHVyZXM8L2xpPicgKwogICAgJyAgICA8bGkgY2xhc3M9InN0YXR1cy1zdWNjZXNzIj4wIFBhc3NlZDwvbGk+JyArCiAgICAnICA8L3VsPicgKwogICAgJzwvZGl2PicgKwogICAgJzxkaXYgaWQ9InNwZWNzIj4nICsKICAgICcgIDxkaXYgY2xhc3M9InRlc3QtY2hpbGRyZW4iPjwvZGl2PicgKwogICAgJzwvZGl2PicKICApOwoKICBydW5uZXIub24oJ0ludGVyYWN0aXZlUGF1c2UnLCBmdW5jdGlvbihzcGVjLCBzdGVwKSB7CiAgICB2YXIgdWkgPSBsYXN0U3RlcFVpTWFwW3NwZWMuaWRdOwogICAgdWkuZmluZCgnLnRlc3QtdGl0bGUnKS4KICAgICAgaHRtbCgncGF1c2VkLi4uIDxhIGhyZWY9ImphdmFzY3JpcHQ6cmVzdW1lKCkiPnJlc3VtZTwvYT4gd2hlbiByZWFkeS4nKTsKICB9KTsKCiAgcnVubmVyLm9uKCdTcGVjQmVnaW4nLCBmdW5jdGlvbihzcGVjKSB7CiAgICB2YXIgdWkgPSBmaW5kQ29udGV4dChzcGVjKTsKICAgIHVpLmZpbmQoJz4gLnRlc3RzJykuYXBwZW5kKAogICAgICAnPGxpIGNsYXNzPSJzdGF0dXMtcGVuZGluZyB0ZXN0LWl0Ij48L2xpPicKICAgICk7CiAgICB1aSA9IHVpLmZpbmQoJz4gLnRlc3RzIGxpOmxhc3QnKTsKICAgIHVpLmFwcGVuZCgKICAgICAgJzxkaXYgY2xhc3M9InRlc3QtaW5mbyI+JyArCiAgICAgICcgIDxwIGNsYXNzPSJ0ZXN0LXRpdGxlIj4nICsKICAgICAgJyAgICA8c3BhbiBjbGFzcz0idGltZXItcmVzdWx0Ij48L3NwYW4+JyArCiAgICAgICcgICAgPHNwYW4gY2xhc3M9InRlc3QtbmFtZSI+PC9zcGFuPicgKwogICAgICAnICA8L3A+JyArCiAgICAgICc8L2Rpdj4nICsKICAgICAgJzxkaXYgY2xhc3M9InNjcm9sbHBhbmUiPicgKwogICAgICAnICA8b2wgY2xhc3M9InRlc3QtYWN0aW9ucyI+PC9vbD4nICsKICAgICAgJzwvZGl2PicKICAgICk7CiAgICB1aS5maW5kKCc+IC50ZXN0LWluZm8gLnRlc3QtbmFtZScpLnRleHQoc3BlYy5uYW1lKTsKICAgIHVpLmZpbmQoJz4gLnRlc3QtaW5mbycpLmNsaWNrKGZ1bmN0aW9uKCkgewogICAgICB2YXIgc2Nyb2xscGFuZSA9IHVpLmZpbmQoJz4gLnNjcm9sbHBhbmUnKTsKICAgICAgdmFyIGFjdGlvbnMgPSBzY3JvbGxwYW5lLmZpbmQoJz4gLnRlc3QtYWN0aW9ucycpOwogICAgICB2YXIgbmFtZSA9IGNvbnRleHQuZmluZCgnPiAudGVzdC1pbmZvIC50ZXN0LW5hbWUnKTsKICAgICAgaWYgKGFjdGlvbnMuZmluZCgnOnZpc2libGUnKS5sZW5ndGgpIHsKICAgICAgICBhY3Rpb25zLmhpZGUoKTsKICAgICAgICBuYW1lLnJlbW92ZUNsYXNzKCdvcGVuJykuYWRkQ2xhc3MoJ2Nsb3NlZCcpOwogICAgICB9IGVsc2UgewogICAgICAgIGFjdGlvbnMuc2hvdygpOwogICAgICAgIHNjcm9sbHBhbmUuYXR0cignc2Nyb2xsVG9wJywgc2Nyb2xscGFuZS5hdHRyKCdzY3JvbGxIZWlnaHQnKSk7CiAgICAgICAgbmFtZS5yZW1vdmVDbGFzcygnY2xvc2VkJykuYWRkQ2xhc3MoJ29wZW4nKTsKICAgICAgfQogICAgfSk7CgogICAgc3BlY1VpTWFwW3NwZWMuaWRdID0gdWk7CiAgfSk7CgogIHJ1bm5lci5vbignU3BlY0Vycm9yJywgZnVuY3Rpb24oc3BlYywgZXJyb3IpIHsKICAgIHZhciB1aSA9IHNwZWNVaU1hcFtzcGVjLmlkXTsKICAgIHVpLmFwcGVuZCgnPHByZT48L3ByZT4nKTsKICAgIHVpLmZpbmQoJz4gcHJlJykudGV4dChmb3JtYXRFeGNlcHRpb24oZXJyb3IpKTsKICB9KTsKCiAgcnVubmVyLm9uKCdTcGVjRW5kJywgZnVuY3Rpb24oc3BlYykgewogICAgdmFyIHVpID0gc3BlY1VpTWFwW3NwZWMuaWRdOwogICAgc3BlYyA9IG1vZGVsLmdldFNwZWMoc3BlYy5pZCk7CiAgICB1aS5yZW1vdmVDbGFzcygnc3RhdHVzLXBlbmRpbmcnKTsKICAgIHVpLmFkZENsYXNzKCdzdGF0dXMtJyArIHNwZWMuc3RhdHVzKTsKICAgIHVpLmZpbmQoIj4gLnRlc3QtaW5mbyAudGltZXItcmVzdWx0IikudGV4dChzcGVjLmR1cmF0aW9uICsgIm1zIik7CiAgICBpZiAoc3BlYy5zdGF0dXMgPT09ICdzdWNjZXNzJykgewogICAgICB1aS5maW5kKCc+IC50ZXN0LWluZm8gLnRlc3QtbmFtZScpLmFkZENsYXNzKCdjbG9zZWQnKTsKICAgICAgdWkuZmluZCgnPiAuc2Nyb2xscGFuZSAudGVzdC1hY3Rpb25zJykuaGlkZSgpOwogICAgfQogICAgdXBkYXRlVG90YWxzKHNwZWMuc3RhdHVzKTsKICB9KTsKCiAgcnVubmVyLm9uKCdTdGVwQmVnaW4nLCBmdW5jdGlvbihzcGVjLCBzdGVwKSB7CiAgICB2YXIgdWkgPSBzcGVjVWlNYXBbc3BlYy5pZF07CiAgICBzcGVjID0gbW9kZWwuZ2V0U3BlYyhzcGVjLmlkKTsKICAgIHN0ZXAgPSBzcGVjLmdldExhc3RTdGVwKCk7CiAgICB1aS5maW5kKCc+IC5zY3JvbGxwYW5lIC50ZXN0LWFjdGlvbnMnKS5hcHBlbmQoJzxsaSBjbGFzcz0ic3RhdHVzLXBlbmRpbmciPjwvbGk+Jyk7CiAgICB2YXIgc3RlcFVpID0gbGFzdFN0ZXBVaU1hcFtzcGVjLmlkXSA9IHVpLmZpbmQoJz4gLnNjcm9sbHBhbmUgLnRlc3QtYWN0aW9ucyBsaTpsYXN0Jyk7CiAgICBzdGVwVWkuYXBwZW5kKAogICAgICAnPGRpdiBjbGFzcz0idGltZXItcmVzdWx0Ij48L2Rpdj4nICsKICAgICAgJzxkaXYgY2xhc3M9InRlc3QtdGl0bGUiPjwvZGl2PicKICAgICk7CiAgICBzdGVwVWkuZmluZCgnPiAudGVzdC10aXRsZScpLnRleHQoc3RlcC5uYW1lKTsKICAgIHZhciBzY3JvbGxwYW5lID0gc3RlcFVpLnBhcmVudHMoJy5zY3JvbGxwYW5lJyk7CiAgICBzY3JvbGxwYW5lLmF0dHIoJ3Njcm9sbFRvcCcsIHNjcm9sbHBhbmUuYXR0cignc2Nyb2xsSGVpZ2h0JykpOwogIH0pOwoKICBydW5uZXIub24oJ1N0ZXBGYWlsdXJlJywgZnVuY3Rpb24oc3BlYywgc3RlcCwgZXJyb3IpIHsKICAgIHZhciB1aSA9IGxhc3RTdGVwVWlNYXBbc3BlYy5pZF07CiAgICBhZGRFcnJvcih1aSwgc3RlcC5saW5lLCBlcnJvcik7CiAgfSk7CgogIHJ1bm5lci5vbignU3RlcEVycm9yJywgZnVuY3Rpb24oc3BlYywgc3RlcCwgZXJyb3IpIHsKICAgIHZhciB1aSA9IGxhc3RTdGVwVWlNYXBbc3BlYy5pZF07CiAgICBhZGRFcnJvcih1aSwgc3RlcC5saW5lLCBlcnJvcik7CiAgfSk7CgogIHJ1bm5lci5vbignU3RlcEVuZCcsIGZ1bmN0aW9uKHNwZWMsIHN0ZXApIHsKICAgIHZhciBzdGVwVWkgPSBsYXN0U3RlcFVpTWFwW3NwZWMuaWRdOwogICAgc3BlYyA9IG1vZGVsLmdldFNwZWMoc3BlYy5pZCk7CiAgICBzdGVwID0gc3BlYy5nZXRMYXN0U3RlcCgpOwogICAgc3RlcFVpLmZpbmQoJy50aW1lci1yZXN1bHQnKS50ZXh0KHN0ZXAuZHVyYXRpb24gKyAnbXMnKTsKICAgIHN0ZXBVaS5yZW1vdmVDbGFzcygnc3RhdHVzLXBlbmRpbmcnKTsKICAgIHN0ZXBVaS5hZGRDbGFzcygnc3RhdHVzLScgKyBzdGVwLnN0YXR1cyk7CiAgICB2YXIgc2Nyb2xscGFuZSA9IHNwZWNVaU1hcFtzcGVjLmlkXS5maW5kKCc+IC5zY3JvbGxwYW5lJyk7CiAgICBzY3JvbGxwYW5lLmF0dHIoJ3Njcm9sbFRvcCcsIHNjcm9sbHBhbmUuYXR0cignc2Nyb2xsSGVpZ2h0JykpOwogIH0pOwoKICAvKioKICAgKiBGaW5kcyB0aGUgY29udGV4dCBvZiBhIHNwZWMgYmxvY2sgZGVmaW5lZCBieSB0aGUgcGFzc2VkIGRlZmluaXRpb24uCiAgICoKICAgKiBAcGFyYW0ge09iamVjdH0gVGhlIGRlZmluaXRpb24gY3JlYXRlZCBieSB0aGUgRGVzY3JpYmUgb2JqZWN0LgogICAqLwogIGZ1bmN0aW9uIGZpbmRDb250ZXh0KHNwZWMpIHsKICAgIHZhciBjdXJyZW50Q29udGV4dCA9IGNvbnRleHQuZmluZCgnI3NwZWNzJyk7CiAgICBhbmd1bGFyLmZvckVhY2gobW9kZWwuZ2V0RGVmaW5pdGlvblBhdGgoc3BlYyksIGZ1bmN0aW9uKGRlZm4pIHsKICAgICAgdmFyIGlkID0gJ2Rlc2NyaWJlLScgKyBkZWZuLmlkOwogICAgICBpZiAoIWNvbnRleHQuZmluZCgnIycgKyBpZCkubGVuZ3RoKSB7CiAgICAgICAgY3VycmVudENvbnRleHQuZmluZCgnPiAudGVzdC1jaGlsZHJlbicpLmFwcGVuZCgKICAgICAgICAgICc8ZGl2IGNsYXNzPSJ0ZXN0LWRlc2NyaWJlIiBpZD0iJyArIGlkICsgJyI+JyArCiAgICAgICAgICAnICA8aDI+PC9oMj4nICsKICAgICAgICAgICcgIDxkaXYgY2xhc3M9InRlc3QtY2hpbGRyZW4iPjwvZGl2PicgKwogICAgICAgICAgJyAgPHVsIGNsYXNzPSJ0ZXN0cyI+PC91bD4nICsKICAgICAgICAgICc8L2Rpdj4nCiAgICAgICAgKTsKICAgICAgICBjb250ZXh0LmZpbmQoJyMnICsgaWQpLmZpbmQoJz4gaDInKS50ZXh0KCdkZXNjcmliZTogJyArIGRlZm4ubmFtZSk7CiAgICAgIH0KICAgICAgY3VycmVudENvbnRleHQgPSBjb250ZXh0LmZpbmQoJyMnICsgaWQpOwogICAgfSk7CiAgICByZXR1cm4gY29udGV4dC5maW5kKCcjZGVzY3JpYmUtJyArIHNwZWMuZGVmaW5pdGlvbi5pZCk7CiAgfTsKCiAgLyoqCiAgICogVXBkYXRlcyB0aGUgdGVzdCBjb3VudGVyIGZvciB0aGUgc3RhdHVzLgogICAqCiAgICogQHBhcmFtIHtzdHJpbmd9IHRoZSBzdGF0dXMuCiAgICovCiAgZnVuY3Rpb24gdXBkYXRlVG90YWxzKHN0YXR1cykgewogICAgdmFyIGxlZ2VuZCA9IGNvbnRleHQuZmluZCgnI3N0YXR1cy1sZWdlbmQgLnN0YXR1cy0nICsgc3RhdHVzKTsKICAgIHZhciBwYXJ0cyA9IGxlZ2VuZC50ZXh0KCkuc3BsaXQoJyAnKTsKICAgIHZhciB2YWx1ZSA9IChwYXJ0c1swXSAqIDEpICsgMTsKICAgIGxlZ2VuZC50ZXh0KHZhbHVlICsgJyAnICsgcGFydHNbMV0pOwogIH0KCiAgLyoqCiAgICogQWRkIGFuIGVycm9yIHRvIGEgc3RlcC4KICAgKgogICAqIEBwYXJhbSB7T2JqZWN0fSBUaGUgSlF1ZXJ5IHdyYXBwZWQgY29udGV4dAogICAqIEBwYXJhbSB7RnVuY3Rpb259IGZuKCkgdGhhdCBzaG91bGQgcmV0dXJuIHRoZSBmaWxlL2xpbmUgbnVtYmVyIG9mIHRoZSBlcnJvcgogICAqIEBwYXJhbSB7T2JqZWN0fSB0aGUgZXJyb3IuCiAgICovCiAgZnVuY3Rpb24gYWRkRXJyb3IoY29udGV4dCwgbGluZSwgZXJyb3IpIHsKICAgIGNvbnRleHQuZmluZCgnLnRlc3QtdGl0bGUnKS5hcHBlbmQoJzxwcmU+PC9wcmU+Jyk7CiAgICB2YXIgbWVzc2FnZSA9IF9qUXVlcnkudHJpbShsaW5lKCkgKyAnXG5cbicgKyBmb3JtYXRFeGNlcHRpb24oZXJyb3IpKTsKICAgIGNvbnRleHQuZmluZCgnLnRlc3QtdGl0bGUgcHJlOmxhc3QnKS50ZXh0KG1lc3NhZ2UpOwogIH07Cn0pOwondXNlIHN0cmljdCc7CgovKioKICogR2VuZXJhdGVzIEpTT04gb3V0cHV0IGludG8gYSBjb250ZXh0LgogKi8KYW5ndWxhci5zY2VuYXJpby5vdXRwdXQoJ2pzb24nLCBmdW5jdGlvbihjb250ZXh0LCBydW5uZXIsIG1vZGVsKSB7CiAgbW9kZWwub24oJ1J1bm5lckVuZCcsIGZ1bmN0aW9uKCkgewogICAgY29udGV4dC50ZXh0KGFuZ3VsYXIudG9Kc29uKG1vZGVsLnZhbHVlKSk7CiAgfSk7Cn0pOwondXNlIHN0cmljdCc7CgovKioKICogR2VuZXJhdGVzIFhNTCBvdXRwdXQgaW50byBhIGNvbnRleHQuCiAqLwphbmd1bGFyLnNjZW5hcmlvLm91dHB1dCgneG1sJywgZnVuY3Rpb24oY29udGV4dCwgcnVubmVyLCBtb2RlbCkgewogIHZhciAkID0gZnVuY3Rpb24oYXJncykge3JldHVybiBuZXcgY29udGV4dC5pbml0KGFyZ3MpO307CiAgbW9kZWwub24oJ1J1bm5lckVuZCcsIGZ1bmN0aW9uKCkgewogICAgdmFyIHNjZW5hcmlvID0gJCgnPHNjZW5hcmlvPjwvc2NlbmFyaW8+Jyk7CiAgICBjb250ZXh0LmFwcGVuZChzY2VuYXJpbyk7CiAgICBzZXJpYWxpemVYbWwoc2NlbmFyaW8sIG1vZGVsLnZhbHVlKTsKICB9KTsKCiAgLyoqCiAgICogQ29udmVydCB0aGUgdHJlZSBpbnRvIFhNTC4KICAgKgogICAqIEBwYXJhbSB7T2JqZWN0fSBjb250ZXh0IGpRdWVyeSBjb250ZXh0IHRvIGFkZCB0aGUgWE1MIHRvLgogICAqIEBwYXJhbSB7T2JqZWN0fSB0cmVlIG5vZGUgdG8gc2VyaWFsaXplCiAgICovCiAgZnVuY3Rpb24gc2VyaWFsaXplWG1sKGNvbnRleHQsIHRyZWUpIHsKICAgICBhbmd1bGFyLmZvckVhY2godHJlZS5jaGlsZHJlbiwgZnVuY3Rpb24oY2hpbGQpIHsKICAgICAgIHZhciBkZXNjcmliZUNvbnRleHQgPSAkKCc8ZGVzY3JpYmU+PC9kZXNjcmliZT4nKTsKICAgICAgIGRlc2NyaWJlQ29udGV4dC5hdHRyKCdpZCcsIGNoaWxkLmlkKTsKICAgICAgIGRlc2NyaWJlQ29udGV4dC5hdHRyKCduYW1lJywgY2hpbGQubmFtZSk7CiAgICAgICBjb250ZXh0LmFwcGVuZChkZXNjcmliZUNvbnRleHQpOwogICAgICAgc2VyaWFsaXplWG1sKGRlc2NyaWJlQ29udGV4dCwgY2hpbGQpOwogICAgIH0pOwogICAgIHZhciBpdHMgPSAkKCc8aXRzPjwvaXRzPicpOwogICAgIGNvbnRleHQuYXBwZW5kKGl0cyk7CiAgICAgYW5ndWxhci5mb3JFYWNoKHRyZWUuc3BlY3MsIGZ1bmN0aW9uKHNwZWMpIHsKICAgICAgIHZhciBpdCA9ICQoJzxpdD48L2l0PicpOwogICAgICAgaXQuYXR0cignaWQnLCBzcGVjLmlkKTsKICAgICAgIGl0LmF0dHIoJ25hbWUnLCBzcGVjLm5hbWUpOwogICAgICAgaXQuYXR0cignZHVyYXRpb24nLCBzcGVjLmR1cmF0aW9uKTsKICAgICAgIGl0LmF0dHIoJ3N0YXR1cycsIHNwZWMuc3RhdHVzKTsKICAgICAgIGl0cy5hcHBlbmQoaXQpOwogICAgICAgYW5ndWxhci5mb3JFYWNoKHNwZWMuc3RlcHMsIGZ1bmN0aW9uKHN0ZXApIHsKICAgICAgICAgdmFyIHN0ZXBDb250ZXh0ID0gJCgnPHN0ZXA+PC9zdGVwPicpOwogICAgICAgICBzdGVwQ29udGV4dC5hdHRyKCduYW1lJywgc3RlcC5uYW1lKTsKICAgICAgICAgc3RlcENvbnRleHQuYXR0cignZHVyYXRpb24nLCBzdGVwLmR1cmF0aW9uKTsKICAgICAgICAgc3RlcENvbnRleHQuYXR0cignc3RhdHVzJywgc3RlcC5zdGF0dXMpOwogICAgICAgICBpdC5hcHBlbmQoc3RlcENvbnRleHQpOwogICAgICAgICBpZiAoc3RlcC5lcnJvcikgewogICAgICAgICAgIHZhciBlcnJvciA9ICQoJzxlcnJvcj48L2Vycm9yJyk7CiAgICAgICAgICAgc3RlcENvbnRleHQuYXBwZW5kKGVycm9yKTsKICAgICAgICAgICBlcnJvci50ZXh0KGZvcm1hdEV4Y2VwdGlvbihzdGVwQ29udGV4dC5lcnJvcikpOwogICAgICAgICB9CiAgICAgICB9KTsKICAgICB9KTsKICAgfQp9KTsKJ3VzZSBzdHJpY3QnOwoKLyoqCiAqIENyZWF0ZXMgYSBnbG9iYWwgdmFsdWUgJHJlc3VsdCB3aXRoIHRoZSByZXN1bHQgb2YgdGhlIHJ1bm5lci4KICovCmFuZ3VsYXIuc2NlbmFyaW8ub3V0cHV0KCdvYmplY3QnLCBmdW5jdGlvbihjb250ZXh0LCBydW5uZXIsIG1vZGVsKSB7CiAgcnVubmVyLiR3aW5kb3cuJHJlc3VsdCA9IG1vZGVsLnZhbHVlOwp9KTsKdmFyICRydW5uZXIgPSBuZXcgYW5ndWxhci5zY2VuYXJpby5SdW5uZXIod2luZG93KSwKICAgIGNvbmZpZyA9IGFuZ3VsYXJKc0NvbmZpZyhkb2N1bWVudCk7CgppZiAoY29uZmlnLmF1dG90ZXN0KSB7CiAganFMaXRlV3JhcChkb2N1bWVudCkucmVhZHkoZnVuY3Rpb24oKSB7CiAgICBhbmd1bGFyLnNjZW5hcmlvLnNldFVwQW5kUnVuKGNvbmZpZyk7CiAgfSk7Cn0KfSkod2luZG93LCBkb2N1bWVudCk7Cgphbmd1bGFyLmVsZW1lbnQoZG9jdW1lbnQpLmZpbmQoJ2hlYWQnKS5hcHBlbmQoJzxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+QGNoYXJzZXQgIlVURi04IjtcblxuLm5nLWZvcm1hdC1uZWdhdGl2ZSB7XG4gIGNvbG9yOiByZWQ7XG59XG5cbi5uZy1leGNlcHRpb24ge1xuICBib3JkZXI6IDJweCBzb2xpZCAjRkYwMDAwO1xuICBmb250LWZhbWlseTogIkNvdXJpZXIgTmV3IiwgQ291cmllciwgbW9ub3NwYWNlO1xuICBmb250LXNpemU6IHNtYWxsZXI7XG4gIHdoaXRlLXNwYWNlOiBwcmU7XG59XG5cbi5uZy12YWxpZGF0aW9uLWVycm9yIHtcbiAgYm9yZGVyOiAycHggc29saWQgI0ZGMDAwMDtcbn1cblxuXG4vKioqKioqKioqKioqKioqKipcbiAqIFRJUFxuICoqKioqKioqKioqKioqKioqL1xuI25nLWNhbGxvdXQge1xuICBtYXJnaW46IDA7XG4gIHBhZGRpbmc6IDA7XG4gIGJvcmRlcjogMDtcbiAgb3V0bGluZTogMDtcbiAgZm9udC1zaXplOiAxM3B4O1xuICBmb250LXdlaWdodDogbm9ybWFsO1xuICBmb250LWZhbWlseTogVmVyZGFuYSwgQXJpYWwsIEhlbHZldGljYSwgc2Fucy1zZXJpZjtcbiAgdmVydGljYWwtYWxpZ246IGJhc2VsaW5lO1xuICBiYWNrZ3JvdW5kOiB0cmFuc3BhcmVudDtcbiAgdGV4dC1kZWNvcmF0aW9uOiBub25lO1xufVxuXG4jbmctY2FsbG91dCAubmctYXJyb3ctbGVmdHtcbiAgYmFja2dyb3VuZC1pbWFnZTogdXJsKCJkYXRhOmltYWdlL2dpZjtiYXNlNjQsUjBsR09EbGhDd0FYQUtJQUFNek16Ty92Ny9mMzkvLy8vLy8vL3dBQUFBQUFBQUFBQUNINUJBVVVBQVFBTEFBQUFBQUxBQmNBQUFNclNMb2MvQUc4RmVVVUlOK3NHZWJXQW5iS1NKb2RxcWxzT3hKdHFZb29VOXZ2ayt2Y0pJY1RrZytRQUFBNyIpO1xuICBiYWNrZ3JvdW5kLXJlcGVhdDogbm8tcmVwZWF0O1xuICBiYWNrZ3JvdW5kLXBvc2l0aW9uOiBsZWZ0IHRvcDtcbiAgcG9zaXRpb246IGFic29sdXRlO1xuICB6LWluZGV4OjEwMTtcbiAgbGVmdDotMTJweDtcbiAgaGVpZ2h0OjIzcHg7XG4gIHdpZHRoOjEwcHg7XG4gIHRvcDotM3B4O1xufVxuXG4jbmctY2FsbG91dCAubmctYXJyb3ctcmlnaHR7XG4gIGJhY2tncm91bmQtaW1hZ2U6IHVybCgiZGF0YTppbWFnZS9naWY7YmFzZTY0LFIwbEdPRGxoQ3dBWEFLSUFBTXpNek8vdjcvZjM5Ly8vLy8vLy93QUFBQUFBQUFBQUFDSDVCQVVVQUFRQUxBQUFBQUFMQUJjQUFBTXJDTFRjb00yOXlONms5c29jczkxZTVYM0V5SmxvaXBZck80b2hUTXFBMEZuMlhWTnN3SmUrSCtTWEFBQTciKTtcbiAgYmFja2dyb3VuZC1yZXBlYXQ6IG5vLXJlcGVhdDtcbiAgYmFja2dyb3VuZC1wb3NpdGlvbjogbGVmdCB0b3A7XG4gIHBvc2l0aW9uOiBhYnNvbHV0ZTtcbiAgei1pbmRleDoxMDE7XG4gIGhlaWdodDoyM3B4O1xuICB3aWR0aDoxMXB4O1xuICAgIHRvcDotMnB4O1xufVxuXG4jbmctY2FsbG91dCB7XG4gIHBvc2l0aW9uOiBhYnNvbHV0ZTtcbiAgei1pbmRleDoxMDA7XG4gIGJvcmRlcjogMnB4IHNvbGlkICNDQ0NDQ0M7XG4gIGJhY2tncm91bmQtY29sb3I6ICNmZmY7XG59XG5cbiNuZy1jYWxsb3V0IC5uZy1jb250ZW50e1xuICBwYWRkaW5nOjEwcHggMTBweCAxMHB4IDEwcHg7XG4gIGNvbG9yOiMzMzMzMzM7XG59XG5cbiNuZy1jYWxsb3V0IC5uZy10aXRsZXtcbiAgYmFja2dyb3VuZC1jb2xvcjogI0NDQ0NDQztcbiAgdGV4dC1hbGlnbjogbGVmdDtcbiAgcGFkZGluZy1sZWZ0OiA4cHg7XG4gIHBhZGRpbmctYm90dG9tOiA1cHg7XG4gIHBhZGRpbmctdG9wOiAycHg7XG4gIGZvbnQtd2VpZ2h0OmJvbGQ7XG59XG5cblxuLyoqKioqKioqKioqKioqKioqXG4gKiBpbmRpY2F0b3JzXG4gKioqKioqKioqKioqKioqKiovXG4ubmctaW5wdXQtaW5kaWNhdG9yLXdhaXQge1xuICBiYWNrZ3JvdW5kLWltYWdlOiB1cmwoImRhdGE6aW1hZ2UvcG5nO2Jhc2U2NCxSMGxHT0RsaEVBQVFBUFFBQVAvLy93QUFBUER3OElxS2l1RGc0RVpHUm5wNmVnQUFBRmhZV0NRa0pLeXNyTDYrdmhRVUZKeWNuQVFFQkRZMk5taG9hQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQ0gvQzA1RlZGTkRRVkJGTWk0d0F3RUFBQUFoL2hwRGNtVmhkR1ZrSUhkcGRHZ2dZV3BoZUd4dllXUXVhVzVtYndBaCtRUUpDZ0FBQUN3QUFBQUFFQUFRQUFBRmR5QWdBZ0lKSWVXb0FrUkNDTWRCa0t0SUhJbmd5TUtzRXJQQlliQURwa1NDd2hEbVFDQmV0aFJCNlZqNGtGQ2tRUEc0SWxXRGdyTlJJd25PNFVLQlhEdWZ6UXZETWFvU0RCZ0ZiODg2TWlRYWRnTkFCQW9rZkN3ekJBOExDZzBFZ2w4akFnZ0dBQTFrQklBMUJBWXpseUlMY3pVTEMyVWhBQ0g1QkFrS0FBQUFMQUFBQUFBUUFCQUFBQVYySUNBQ0FtbEFaVG1PUkVFSXlVRVFqTEtLeFBIQURoRXZxeGxnY0dna0dJMURZU1ZBSUFXTXgrbHdTS2tJQ0owUXNIaTlSZ0tCd25WVGlSUVFnd0Y0STRVRkRRUUV3aTYvM1lTR1dSUm1qaEVFVEFKZklnTUZDbkFLTTBLRFY0RUVFQVFMaUYxOFRBWU5YRGFTZTN4Nm1qaWROMXMzSVFBaCtRUUpDZ0FBQUN3QUFBQUFFQUFRQUFBRmVDQWdBZ0xaREdVNWpnUkVDRVVpQ0kreWlvU0R3REp5TEtzWG9IRlF4QlNIQW9BQUZCaHF0TUpnOERnUUJnZnJFc0pBRUFnNFloWklFaXdnS3RIaU1CZ3RwZzN3YlVaWEdPN2tPYjFNVUtSRk15c0NDaEFvZ2dKQ0lnMEdDMmFOZTRncVFsZGZMNGwvQWcxQVh5U0pnbjVMY29FM1FYSTNJUUFoK1FRSkNnQUFBQ3dBQUFBQUVBQVFBQUFGZGlBZ0FnTFpOR1U1am9RaENFanhJc3NxRW84YkM5QlJqeTlBZzdHSUxRNFFFb0UwZ0JBRUJjT3BjQkEwRG94U0svZThMUklIbitpMWNLMEl5S2RnMFZBb2xqWUlnK0dnblJyd1ZTLzhJQWtJQ3lvc0JJUXBCQU1vS3k5ZElteFBoUytHS2tGcmtYK1RpZ3RMbEl5S1hVRitOamFnTmlFQUlma0VDUW9BQUFBc0FBQUFBQkFBRUFBQUJXd2dJQUlDYVJobE9ZNEVJZ2pIOFI3TEtoS0hHd3NNdmI0QUF5M1dPREJJQkJLQ3NZQTlUanVoRE5ES0VWU0VSZXpRRUwwV3JoWHVjUlVRR3VpazdiRmxuZ3pxVlc5TE1sOVhXdkxkakZhSnRERnFaMWNFWlVCMGRVZ3ZMM2RnUDRXSlpuNGprb21XTnBTVEl5RUFJZmtFQ1FvQUFBQXNBQUFBQUJBQUVBQUFCWDRnSUFJQ3VTeGxPWTZDSWdpRDhSckVLZ3FHT3d4d1VyTWxBb1N3SXpBR3BKcGdvU0RBR2lmRFk1a29wQllEbEVwQVFCd2V2eGZCdFJJVUdpOHh3V2tETkJDSXdtQzlWcTBhaVFRRFF1SytWZ1FQRFhWOWhDSmpCd2NGWVU1cEx3d0hYUWNNS1NtTkxRY0lBRXhsYkg4SkJ3dHRhWDBBQkFjTmJXVmJLeUVBSWZrRUNRb0FBQUFzQUFBQUFCQUFFQUFBQlhrZ0lBSUNTUkJsT1k3Q0lnaE44emJFS3NLb0lqZEZ6WmFFZ1VCSEtDaE1KdFJ3Y1dwQVdvV25pZm02RVNBTWhPOGxRSzBFRUFWM3JGb3BJQkNFY0d3REtBcVBoNEhVclk0SUNISDFkU29URmdjSFVpWmpCaEFKQjJBSER5a3BLQXdIQXdkemYxOUtrQVNJUGw5Y0RnY25Ea2R0TndpTUpDc2hBQ0g1QkFrS0FBQUFMQUFBQUFBUUFCQUFBQVYzSUNBQ0Fra1FaVG1PQWlvc2l5QW94Q3ErS1B4Q05Wc1NNUmdCc2lDbFdyTFRTV0ZvSVFaSGw2cGxlQmg2c3V4S01JaGx2emJBd2tCV2ZGV3JCUVR4TkxxMlJHMnloU1VrRHMyYjYzQVlEQW9KWEFjRlJ3QURlQWtKRFgwQVFDc0VmQVFNREFJUEJ6MHJDZ2N4a3kwSlJXRTFBbXdwS3lFQUlma0VDUW9BQUFBc0FBQUFBQkFBRUFBQUJYa2dJQUlDS1p6a3FKNG5RWnhMcVpLdjROcU5MS0syL1E0RWs0bEZYQ2hzZzV5cEpqczFJSTNnRURVU1JJbkVHWUF3NkI2ek00SmhyREF0RW9zVmtMVXRIQTdSSGFIQUdKUUVqc09EY0VnMEZCQUZWZ2tRSlExcEF3Y0REdzhLY0Z0U0lud0pBb3dDQ0E2Ukl3cVpBZ2tQTmdWcFduZGpkeW9oQUNINUJBa0tBQUFBTEFBQUFBQVFBQkFBQUFWNUlDQUNBaW1jNUtpZUxFdVVLdm0yeEFLTHFEQ2ZDMkdhTzllTDBMQUJXVGlCWW1BMDZXNmtIZ3ZDcUVKaUFJSml1M2djdmdVc3NjSFVFUm0ra2FDeHl4YSt6UlBrMFNnSkVnZkl2YkFkSUFRTENBWWxDajREQncwSUJRc01DaklxQkFjUEFvb0NCZzlwS2dzSkx3VUZPaENaS3lRREEzWXFJUUFoK1FRSkNnQUFBQ3dBQUFBQUVBQVFBQUFGZFNBZ0FnSXBuT1Nvbm14YnFpVGhDckpLRUhGYm84SnhERE9aWUZGYitBNDFFNEg0T2hrT2lwWHdCRWxZSVREQWNrRkVPQmdNUTNhcmtNa1VCZHhJVUdacEViN2thUUJSbEFTUGcwRlFRSEFiRUVNR0RTVkVBQTFRQmhBRUQxRTBOZ3dGQW9vQ0RXbGphUUlRQ0U1cU1IY05oQ2tqSVFBaCtRUUpDZ0FBQUN3QUFBQUFFQUFRQUFBRmVTQWdBZ0lwbk9Tb0xneHh2cWdLTEVjQ0M2NUtFQUJ5S0s4Y1NwQTREQWlIUS9Ea0toR0toNFpDdEN5WkdvNkY2aVlZUEFxRmdZeTAyeGtTYUxFTVYzNHRFTHlSWU5Fc0NReUhsdldrR0N6c1BnTUNFQVk3Q2cwNFVrNDhMQXNEaFJBOE1WUVBFRjBHQWdxWVl3U1JseWNOY1dza0NrQXBJeUVBT3dBQUFBQUFBQUFBQUE9PSIpO1xuICBiYWNrZ3JvdW5kLXBvc2l0aW9uOiByaWdodDtcbiAgYmFja2dyb3VuZC1yZXBlYXQ6IG5vLXJlcGVhdDtcbn1cbjwvc3R5bGU+Jyk7CmFuZ3VsYXIuZWxlbWVudChkb2N1bWVudCkuZmluZCgnaGVhZCcpLmFwcGVuZCgnPHN0eWxlIHR5cGU9InRleHQvY3NzIj5AY2hhcnNldCAiVVRGLTgiO1xuLyogQ1NTIERvY3VtZW50ICovXG5cbi8qKiBTdHJ1Y3R1cmUgKi9cbmJvZHkge1xuICBmb250LWZhbWlseTogQXJpYWwsIHNhbnMtc2VyaWY7XG4gIG1hcmdpbjogMDtcbiAgZm9udC1zaXplOiAxNHB4O1xufVxuXG4jc3lzdGVtLWVycm9yIHtcbiAgZm9udC1zaXplOiAxLjVlbTtcbiAgdGV4dC1hbGlnbjogY2VudGVyO1xufVxuXG4janNvbiwgI3htbCB7XG4gIGRpc3BsYXk6IG5vbmU7XG59XG5cbiNoZWFkZXIge1xuICBwb3NpdGlvbjogZml4ZWQ7XG4gIHdpZHRoOiAxMDAlO1xufVxuXG4jc3BlY3Mge1xuICBwYWRkaW5nLXRvcDogNTBweDtcbn1cblxuI2hlYWRlciAuYW5ndWxhciB7XG4gIGZvbnQtZmFtaWx5OiBDb3VyaWVyIE5ldywgbW9ub3NwYWNlO1xuICBmb250LXdlaWdodDogYm9sZDtcbn1cblxuI2hlYWRlciBoMSB7XG4gIGZvbnQtd2VpZ2h0OiBub3JtYWw7XG4gIGZsb2F0OiBsZWZ0O1xuICBmb250LXNpemU6IDMwcHg7XG4gIGxpbmUtaGVpZ2h0OiAzMHB4O1xuICBtYXJnaW46IDA7XG4gIHBhZGRpbmc6IDEwcHggMTBweDtcbiAgaGVpZ2h0OiAzMHB4O1xufVxuXG4jYXBwbGljYXRpb24gaDIsXG4jc3BlY3MgaDIge1xuICBtYXJnaW46IDA7XG4gIHBhZGRpbmc6IDAuNWVtO1xuICBmb250LXNpemU6IDEuMWVtO1xufVxuXG4jc3RhdHVzLWxlZ2VuZCB7XG4gIG1hcmdpbi10b3A6IDEwcHg7XG4gIG1hcmdpbi1yaWdodDogMTBweDtcbn1cblxuI2hlYWRlcixcbiNhcHBsaWNhdGlvbixcbi50ZXN0LWluZm8sXG4udGVzdC1hY3Rpb25zIGxpIHtcbiAgb3ZlcmZsb3c6IGhpZGRlbjtcbn1cblxuI2FwcGxpY2F0aW9uIHtcbiAgbWFyZ2luOiAxMHB4O1xufVxuXG4jYXBwbGljYXRpb24gaWZyYW1lIHtcbiAgd2lkdGg6IDEwMCU7XG4gIGhlaWdodDogNzU4cHg7XG59XG5cbiNhcHBsaWNhdGlvbiAucG9wb3V0IHtcbiAgZmxvYXQ6IHJpZ2h0O1xufVxuXG4jYXBwbGljYXRpb24gaWZyYW1lIHtcbiAgYm9yZGVyOiBub25lO1xufVxuXG4udGVzdHMgbGksXG4udGVzdC1hY3Rpb25zIGxpLFxuLnRlc3QtaXQgbGksXG4udGVzdC1pdCBvbCxcbi5zdGF0dXMtZGlzcGxheSB7XG4gIGxpc3Qtc3R5bGUtdHlwZTogbm9uZTtcbn1cblxuLnRlc3RzLFxuLnRlc3QtaXQgb2wsXG4uc3RhdHVzLWRpc3BsYXkge1xuICBtYXJnaW46IDA7XG4gIHBhZGRpbmc6IDA7XG59XG5cbi50ZXN0LWluZm8ge1xuICBtYXJnaW4tbGVmdDogMWVtO1xuICBtYXJnaW4tdG9wOiAwLjVlbTtcbiAgYm9yZGVyLXJhZGl1czogOHB4IDAgMCA4cHg7XG4gIC13ZWJraXQtYm9yZGVyLXJhZGl1czogOHB4IDAgMCA4cHg7XG4gIC1tb3otYm9yZGVyLXJhZGl1czogOHB4IDAgMCA4cHg7XG4gIGN1cnNvcjogcG9pbnRlcjtcbn1cblxuLnRlc3QtaW5mbzpob3ZlciAudGVzdC1uYW1lIHtcbiAgdGV4dC1kZWNvcmF0aW9uOiB1bmRlcmxpbmU7XG59XG5cbi50ZXN0LWluZm8gLmNsb3NlZDpiZWZvcmUge1xuICBjb250ZW50OiBcJ1xcMjViOFxcMDBBMFwnO1xufVxuXG4udGVzdC1pbmZvIC5vcGVuOmJlZm9yZSB7XG4gIGNvbnRlbnQ6IFwnXFwyNWJlXFwwMEEwXCc7XG4gIGZvbnQtd2VpZ2h0OiBib2xkO1xufVxuXG4udGVzdC1pdCBvbCB7XG4gIG1hcmdpbi1sZWZ0OiAyLjVlbTtcbn1cblxuLnN0YXR1cy1kaXNwbGF5LFxuLnN0YXR1cy1kaXNwbGF5IGxpIHtcbiAgZmxvYXQ6IHJpZ2h0O1xufVxuXG4uc3RhdHVzLWRpc3BsYXkgbGkge1xuICBwYWRkaW5nOiA1cHggMTBweDtcbn1cblxuLnRpbWVyLXJlc3VsdCxcbi50ZXN0LXRpdGxlIHtcbiAgZGlzcGxheTogaW5saW5lLWJsb2NrO1xuICBtYXJnaW46IDA7XG4gIHBhZGRpbmc6IDRweDtcbn1cblxuLnRlc3QtYWN0aW9ucyAudGVzdC10aXRsZSxcbi50ZXN0LWFjdGlvbnMgLnRlc3QtcmVzdWx0IHtcbiAgZGlzcGxheTogdGFibGUtY2VsbDtcbiAgcGFkZGluZy1sZWZ0OiAwLjVlbTtcbiAgcGFkZGluZy1yaWdodDogMC41ZW07XG59XG5cbi50ZXN0LWFjdGlvbnMge1xuICBkaXNwbGF5OiB0YWJsZTtcbn1cblxuLnRlc3QtYWN0aW9ucyBsaSB7XG4gIGRpc3BsYXk6IHRhYmxlLXJvdztcbn1cblxuLnRpbWVyLXJlc3VsdCB7XG4gIHdpZHRoOiA0ZW07XG4gIHBhZGRpbmc6IDAgMTBweDtcbiAgdGV4dC1hbGlnbjogcmlnaHQ7XG4gIGZvbnQtZmFtaWx5OiBtb25vc3BhY2U7XG59XG5cbi50ZXN0LWl0IHByZSxcbi50ZXN0LWFjdGlvbnMgcHJlIHtcbiAgY2xlYXI6IGxlZnQ7XG4gIGNvbG9yOiBibGFjaztcbiAgbWFyZ2luLWxlZnQ6IDZlbTtcbn1cblxuLnRlc3QtZGVzY3JpYmUge1xuICBwYWRkaW5nLWJvdHRvbTogMC41ZW07XG59XG5cbi50ZXN0LWRlc2NyaWJlIC50ZXN0LWRlc2NyaWJlIHtcbiAgbWFyZ2luOiA1cHggNXB4IDEwcHggMmVtO1xufVxuXG4udGVzdC1hY3Rpb25zIC5zdGF0dXMtcGVuZGluZyAudGVzdC10aXRsZTpiZWZvcmUge1xuICBjb250ZW50OiBcJ1xcMDBiYlxcMDBBMFwnO1xufVxuXG4uc2Nyb2xscGFuZSB7XG4gICBtYXgtaGVpZ2h0OiAyMGVtO1xuICAgb3ZlcmZsb3c6IGF1dG87XG59XG5cbi8qKiBDb2xvcnMgKi9cblxuI2hlYWRlciB7XG4gIGJhY2tncm91bmQtY29sb3I6ICNGMkMyMDA7XG59XG5cbiNzcGVjcyBoMiB7XG4gIGJvcmRlci10b3A6IDJweCBzb2xpZCAjQkFCQUQxO1xufVxuXG4jc3BlY3MgaDIsXG4jYXBwbGljYXRpb24gaDIge1xuICBiYWNrZ3JvdW5kLWNvbG9yOiAjZWZlZmVmO1xufVxuXG4jYXBwbGljYXRpb24ge1xuICBib3JkZXI6IDFweCBzb2xpZCAjQkFCQUQxO1xufVxuXG4udGVzdC1kZXNjcmliZSAudGVzdC1kZXNjcmliZSB7XG4gIGJvcmRlci1sZWZ0OiAxcHggc29saWQgI0JBQkFEMTtcbiAgYm9yZGVyLXJpZ2h0OiAxcHggc29saWQgI0JBQkFEMTtcbiAgYm9yZGVyLWJvdHRvbTogMXB4IHNvbGlkICNCQUJBRDE7XG59XG5cbi5zdGF0dXMtZGlzcGxheSB7XG4gIGJvcmRlcjogMXB4IHNvbGlkICM3Nzc7XG59XG5cbi5zdGF0dXMtZGlzcGxheSAuc3RhdHVzLXBlbmRpbmcsXG4uc3RhdHVzLXBlbmRpbmcgLnRlc3QtaW5mbyB7XG4gIGJhY2tncm91bmQtY29sb3I6ICNGOUVFQkM7XG59XG5cbi5zdGF0dXMtZGlzcGxheSAuc3RhdHVzLXN1Y2Nlc3MsXG4uc3RhdHVzLXN1Y2Nlc3MgLnRlc3QtaW5mbyB7XG4gIGJhY2tncm91bmQtY29sb3I6ICNCMUQ3QTE7XG59XG5cbi5zdGF0dXMtZGlzcGxheSAuc3RhdHVzLWZhaWx1cmUsXG4uc3RhdHVzLWZhaWx1cmUgLnRlc3QtaW5mbyB7XG4gIGJhY2tncm91bmQtY29sb3I6ICNGRjgyODY7XG59XG5cbi5zdGF0dXMtZGlzcGxheSAuc3RhdHVzLWVycm9yLFxuLnN0YXR1cy1lcnJvciAudGVzdC1pbmZvIHtcbiAgYmFja2dyb3VuZC1jb2xvcjogYmxhY2s7XG4gIGNvbG9yOiB3aGl0ZTtcbn1cblxuLnRlc3QtYWN0aW9ucyAuc3RhdHVzLXN1Y2Nlc3MgLnRlc3QtdGl0bGUge1xuICBjb2xvcjogIzMwQjMwQTtcbn1cblxuLnRlc3QtYWN0aW9ucyAuc3RhdHVzLWZhaWx1cmUgLnRlc3QtdGl0bGUge1xuICBjb2xvcjogI0RGMDAwMDtcbn1cblxuLnRlc3QtYWN0aW9ucyAuc3RhdHVzLWVycm9yIC50ZXN0LXRpdGxlIHtcbiAgY29sb3I6IGJsYWNrO1xufVxuXG4udGVzdC1hY3Rpb25zIC50aW1lci1yZXN1bHQge1xuICBjb2xvcjogIzg4ODtcbn1cbjwvc3R5bGU+Jyk7",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Thu, 06 Nov 2014 08:25:26 GMT",
                    "Content-Length": "601059",
                    "Date": "Thu, 06 Nov 2014 08:25:26 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}