{
    "url": "http://localhost:9999/miguelmota/inview/node_modules/jsdoc/node_modules/esprima/test/3rdparty/jquery.mobile-1.2.0.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Link manipulation (DOM-based)",
    "issueType": 5246976,
    "severity": "Low",
    "confidence": "Firm",
    "issueBackground": "DOM-based link manipulation vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this to a navigation target within the current page, such as a clickable link or the submission URL of a form. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will modify the target of links within the response. An attacker may be able to leverage this to perform various attacks, including:<ul><li>Causing the user to redirect to an arbitrary external URL, to facilitate a phishing attack.</li><li>Causing the user to submit sensitive form data to a server controlled by the attacker.</li><li>Causing the user to perform an unintended action within the application, by changing the file or query string associated with a link.</li><li>Bypassing browser anti-XSS defenses by injecting on-site links containing XSS exploits, since browser anti-XSS defenses typically do not operate on on-site links.</li></ul>",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based link manipulation vulnerabilities is not to dynamically set the target URLs of links or forms using data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing an arbitrary URL as a link target. In general, this is best achieved by using a whitelist of URLs that are permitted link targets, and strictly validating the target against this list before setting the link target.",
    "issueDetail": "The application may be vulnerable to DOM-based link manipulation. Data is read from <b>location.pathname</b> and written to <b>the 'href' property of a DOM element</b> via the following statement:<ul><li>base[ 0 ].href = href || location.pathname;</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/miguelmota/inview/node_modules/jsdoc/node_modules/esprima/test/3rdparty/jquery.mobile-1.2.0.js",
                "path": "/miguelmota/inview/node_modules/jsdoc/node_modules/esprima/test/3rdparty/jquery.mobile-1.2.0.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9taWd1ZWxtb3RhL2ludmlldy9ub2RlX21vZHVsZXMvanNkb2Mvbm9kZV9tb2R1bGVzL2VzcHJpbWEvdGVzdC8zcmRwYXJ0eS9qcXVlcnkubW9iaWxlLTEuMi4wLmpzIEhUVFAvMS4xDQpIb3N0OiBsb2NhbGhvc3Q6OTk5OQ0KDQo=",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogMjkzNTM1DQpBY2NlcHQtUmFuZ2VzOiBieXRlcw0KQ29udGVudC1UeXBlOiBhcHBsaWNhdGlvbi9qYXZhc2NyaXB0DQpEYXRlOiBGcmksIDA3IE5vdiAyMDE0IDA1OjA0OjIxIEdNVA0KTGFzdC1Nb2RpZmllZDogRnJpLCAwNyBOb3YgMjAxNCAwNTowMzoyMyBHTVQNCg0KLyoKKiBqUXVlcnkgTW9iaWxlIEZyYW1ld29yayBHaXQgQnVpbGQ6IFNIQTE6IGMyZDYxZTJlNTkyYzY3NTE5ZDlhOWVkMGJhNzk2ZmE0NDc4N2UxMzYgPD4gRGF0ZTogVHVlIFNlcCAyNSAxMDozODoxMiAyMDEyIC0wNzAwCiogaHR0cDovL2pxdWVyeW1vYmlsZS5jb20KKgoqIENvcHlyaWdodCAyMDEyIGpRdWVyeSBGb3VuZGF0aW9uIGFuZCBvdGhlciBjb250cmlidXRvcnMKKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuCiogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQoqCiovCgoKKGZ1bmN0aW9uICggcm9vdCwgZG9jLCBmYWN0b3J5ICkgewoJaWYgKCB0eXBlb2YgZGVmaW5lID09PSAiZnVuY3Rpb24iICYmIGRlZmluZS5hbWQgKSB7CgkJLy8gQU1ELiBSZWdpc3RlciBhcyBhbiBhbm9ueW1vdXMgbW9kdWxlLgoJCWRlZmluZSggWyAianF1ZXJ5IiBdLCBmdW5jdGlvbiAoICQgKSB7CgkJCWZhY3RvcnkoICQsIHJvb3QsIGRvYyApOwoJCQlyZXR1cm4gJC5tb2JpbGU7CgkJfSk7Cgl9IGVsc2UgewoJCS8vIEJyb3dzZXIgZ2xvYmFscwoJCWZhY3RvcnkoIHJvb3QualF1ZXJ5LCByb290LCBkb2MgKTsKCX0KfSggdGhpcywgZG9jdW1lbnQsIGZ1bmN0aW9uICggalF1ZXJ5LCB3aW5kb3csIGRvY3VtZW50LCB1bmRlZmluZWQgKSB7CihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgoJdmFyIG5zTm9ybWFsaXplRGljdCA9IHt9OwoKCS8vIGpRdWVyeS5tb2JpbGUgY29uZmlndXJhYmxlIG9wdGlvbnMKCSQubW9iaWxlID0gJC5leHRlbmQoIHt9LCB7CgoJCS8vIFZlcnNpb24gb2YgdGhlIGpRdWVyeSBNb2JpbGUgRnJhbWV3b3JrCgkJdmVyc2lvbjogIjEuMi4wIiwKCgkJLy8gTmFtZXNwYWNlIHVzZWQgZnJhbWV3b3JrLXdpZGUgZm9yIGRhdGEtYXR0cnMuIERlZmF1bHQgaXMgbm8gbmFtZXNwYWNlCgkJbnM6ICIiLAoKCQkvLyBEZWZpbmUgdGhlIHVybCBwYXJhbWV0ZXIgdXNlZCBmb3IgcmVmZXJlbmNpbmcgd2lkZ2V0LWdlbmVyYXRlZCBzdWItcGFnZXMuCgkJLy8gVHJhbnNsYXRlcyB0byB0byBleGFtcGxlLmh0bWwmdWktcGFnZT1zdWJwYWdlSWRlbnRpZmllcgoJCS8vIGhhc2ggc2VnbWVudCBiZWZvcmUgJnVpLXBhZ2U9IGlzIHVzZWQgdG8gbWFrZSBBamF4IHJlcXVlc3QKCQlzdWJQYWdlVXJsS2V5OiAidWktcGFnZSIsCgoJCS8vIENsYXNzIGFzc2lnbmVkIHRvIHBhZ2UgY3VycmVudGx5IGluIHZpZXcsIGFuZCBkdXJpbmcgdHJhbnNpdGlvbnMKCQlhY3RpdmVQYWdlQ2xhc3M6ICJ1aS1wYWdlLWFjdGl2ZSIsCgoJCS8vIENsYXNzIHVzZWQgZm9yICJhY3RpdmUiIGJ1dHRvbiBzdGF0ZSwgZnJvbSBDU1MgZnJhbWV3b3JrCgkJYWN0aXZlQnRuQ2xhc3M6ICJ1aS1idG4tYWN0aXZlIiwKCgkJLy8gQ2xhc3MgdXNlZCBmb3IgImZvY3VzIiBmb3JtIGVsZW1lbnQgc3RhdGUsIGZyb20gQ1NTIGZyYW1ld29yawoJCWZvY3VzQ2xhc3M6ICJ1aS1mb2N1cyIsCgoJCS8vIEF1dG9tYXRpY2FsbHkgaGFuZGxlIGNsaWNrcyBhbmQgZm9ybSBzdWJtaXNzaW9ucyB0aHJvdWdoIEFqYXgsIHdoZW4gc2FtZS1kb21haW4KCQlhamF4RW5hYmxlZDogdHJ1ZSwKCgkJLy8gQXV0b21hdGljYWxseSBsb2FkIGFuZCBzaG93IHBhZ2VzIGJhc2VkIG9uIGxvY2F0aW9uLmhhc2gKCQloYXNoTGlzdGVuaW5nRW5hYmxlZDogdHJ1ZSwKCgkJLy8gZGlzYWJsZSB0byBwcmV2ZW50IGpxdWVyeSBmcm9tIGJvdGhlcmluZyB3aXRoIGxpbmtzCgkJbGlua0JpbmRpbmdFbmFibGVkOiB0cnVlLAoKCQkvLyBTZXQgZGVmYXVsdCBwYWdlIHRyYW5zaXRpb24gLSAnbm9uZScgZm9yIG5vIHRyYW5zaXRpb25zCgkJZGVmYXVsdFBhZ2VUcmFuc2l0aW9uOiAiZmFkZSIsCgoJCS8vIFNldCBtYXhpbXVtIHdpbmRvdyB3aWR0aCBmb3IgdHJhbnNpdGlvbnMgdG8gYXBwbHkgLSAnZmFsc2UnIGZvciBubyBsaW1pdAoJCW1heFRyYW5zaXRpb25XaWR0aDogZmFsc2UsCgoJCS8vIE1pbmltdW0gc2Nyb2xsIGRpc3RhbmNlIHRoYXQgd2lsbCBiZSByZW1lbWJlcmVkIHdoZW4gcmV0dXJuaW5nIHRvIGEgcGFnZQoJCW1pblNjcm9sbEJhY2s6IDI1MCwKCgkJLy8gREVQUkVDQVRFRDogdGhlIGZvbGxvd2luZyBwcm9wZXJ0eSBpcyBubyBsb25nZXIgaW4gdXNlLCBidXQgZGVmaW5lZCB1bnRpbCAyLjAgdG8gcHJldmVudCBjb25mbGljdHMKCQl0b3VjaE92ZXJmbG93RW5hYmxlZDogZmFsc2UsCgoJCS8vIFNldCBkZWZhdWx0IGRpYWxvZyB0cmFuc2l0aW9uIC0gJ25vbmUnIGZvciBubyB0cmFuc2l0aW9ucwoJCWRlZmF1bHREaWFsb2dUcmFuc2l0aW9uOiAicG9wIiwKCgkJLy8gRXJyb3IgcmVzcG9uc2UgbWVzc2FnZSAtIGFwcGVhcnMgd2hlbiBhbiBBamF4IHBhZ2UgcmVxdWVzdCBmYWlscwoJCXBhZ2VMb2FkRXJyb3JNZXNzYWdlOiAiRXJyb3IgTG9hZGluZyBQYWdlIiwKCgkJLy8gRm9yIGVycm9yIG1lc3NhZ2VzLCB3aGljaCB0aGVtZSBkb2VzIHRoZSBib3ggdXNlcz8KCQlwYWdlTG9hZEVycm9yTWVzc2FnZVRoZW1lOiAiZSIsCgoJCS8vIHJlcGxhY2UgY2FsbHMgdG8gd2luZG93Lmhpc3RvcnkuYmFjayB3aXRoIHBob25lZ2FwcyBuYXZpZ2F0aW9uIGhlbHBlcgoJCS8vIHdoZXJlIGl0IGlzIHByb3ZpZGVkIG9uIHRoZSB3aW5kb3cgb2JqZWN0CgkJcGhvbmVnYXBOYXZpZ2F0aW9uRW5hYmxlZDogZmFsc2UsCgoJCS8vYXV0b21hdGljYWxseSBpbml0aWFsaXplIHRoZSBET00gd2hlbiBpdCdzIHJlYWR5CgkJYXV0b0luaXRpYWxpemVQYWdlOiB0cnVlLAoKCQlwdXNoU3RhdGVFbmFibGVkOiB0cnVlLAoKCQkvLyBhbGxvd3MgdXNlcnMgdG8gb3B0IGluIHRvIGlnbm9yaW5nIGNvbnRlbnQgYnkgbWFya2luZyBhIHBhcmVudCBlbGVtZW50IGFzCgkJLy8gZGF0YS1pZ25vcmVkCgkJaWdub3JlQ29udGVudEVuYWJsZWQ6IGZhbHNlLAoKCQkvLyB0dXJuIG9mIGJpbmRpbmcgdG8gdGhlIG5hdGl2ZSBvcmllbnRhdGlvbmNoYW5nZSBkdWUgdG8gYW5kcm9pZCBvcmllbnRhdGlvbiBiZWhhdmlvcgoJCW9yaWVudGF0aW9uQ2hhbmdlRW5hYmxlZDogdHJ1ZSwKCgkJYnV0dG9uTWFya3VwOiB7CgkJCWhvdmVyRGVsYXk6IDIwMAoJCX0sCgoJCS8vIFRPRE8gbWlnaHQgYmUgdXNlZnVsIHVwc3RyZWFtIGluIGpxdWVyeSBpdHNlbGYgPwoJCWtleUNvZGU6IHsKCQkJQUxUOiAxOCwKCQkJQkFDS1NQQUNFOiA4LAoJCQlDQVBTX0xPQ0s6IDIwLAoJCQlDT01NQTogMTg4LAoJCQlDT01NQU5EOiA5MSwKCQkJQ09NTUFORF9MRUZUOiA5MSwgLy8gQ09NTUFORAoJCQlDT01NQU5EX1JJR0hUOiA5MywKCQkJQ09OVFJPTDogMTcsCgkJCURFTEVURTogNDYsCgkJCURPV046IDQwLAoJCQlFTkQ6IDM1LAoJCQlFTlRFUjogMTMsCgkJCUVTQ0FQRTogMjcsCgkJCUhPTUU6IDM2LAoJCQlJTlNFUlQ6IDQ1LAoJCQlMRUZUOiAzNywKCQkJTUVOVTogOTMsIC8vIENPTU1BTkRfUklHSFQKCQkJTlVNUEFEX0FERDogMTA3LAoJCQlOVU1QQURfREVDSU1BTDogMTEwLAoJCQlOVU1QQURfRElWSURFOiAxMTEsCgkJCU5VTVBBRF9FTlRFUjogMTA4LAoJCQlOVU1QQURfTVVMVElQTFk6IDEwNiwKCQkJTlVNUEFEX1NVQlRSQUNUOiAxMDksCgkJCVBBR0VfRE9XTjogMzQsCgkJCVBBR0VfVVA6IDMzLAoJCQlQRVJJT0Q6IDE5MCwKCQkJUklHSFQ6IDM5LAoJCQlTSElGVDogMTYsCgkJCVNQQUNFOiAzMiwKCQkJVEFCOiA5LAoJCQlVUDogMzgsCgkJCVdJTkRPV1M6IDkxIC8vIENPTU1BTkQKCQl9LAoKCQkvLyBTY3JvbGwgcGFnZSB2ZXJ0aWNhbGx5OiBzY3JvbGwgdG8gMCB0byBoaWRlIGlPUyBhZGRyZXNzIGJhciwgb3IgcGFzcyBhIFkgdmFsdWUKCQlzaWxlbnRTY3JvbGw6IGZ1bmN0aW9uKCB5cG9zICkgewoJCQlpZiAoICQudHlwZSggeXBvcyApICE9PSAibnVtYmVyIiApIHsKCQkJCXlwb3MgPSAkLm1vYmlsZS5kZWZhdWx0SG9tZVNjcm9sbDsKCQkJfQoKCQkJLy8gcHJldmVudCBzY3JvbGxzdGFydCBhbmQgc2Nyb2xsc3RvcCBldmVudHMKCQkJJC5ldmVudC5zcGVjaWFsLnNjcm9sbHN0YXJ0LmVuYWJsZWQgPSBmYWxzZTsKCgkJCXNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCQkJd2luZG93LnNjcm9sbFRvKCAwLCB5cG9zICk7CgkJCQkkKCBkb2N1bWVudCApLnRyaWdnZXIoICJzaWxlbnRzY3JvbGwiLCB7IHg6IDAsIHk6IHlwb3MgfSk7CgkJCX0sIDIwICk7CgoJCQlzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJCSQuZXZlbnQuc3BlY2lhbC5zY3JvbGxzdGFydC5lbmFibGVkID0gdHJ1ZTsKCQkJfSwgMTUwICk7CgkJfSwKCgkJLy8gRXhwb3NlIG91ciBjYWNoZSBmb3IgdGVzdGluZyBwdXJwb3Nlcy4KCQluc05vcm1hbGl6ZURpY3Q6IG5zTm9ybWFsaXplRGljdCwKCgkJLy8gVGFrZSBhIGRhdGEgYXR0cmlidXRlIHByb3BlcnR5LCBwcmVwZW5kIHRoZSBuYW1lc3BhY2UKCQkvLyBhbmQgdGhlbiBjYW1lbCBjYXNlIHRoZSBhdHRyaWJ1dGUgc3RyaW5nLiBBZGQgdGhlIHJlc3VsdAoJCS8vIHRvIG91ciBuc05vcm1hbGl6ZURpY3Qgc28gd2UgZG9uJ3QgaGF2ZSB0byBkbyB0aGlzIGFnYWluLgoJCW5zTm9ybWFsaXplOiBmdW5jdGlvbiggcHJvcCApIHsKCQkJaWYgKCAhcHJvcCApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJcmV0dXJuIG5zTm9ybWFsaXplRGljdFsgcHJvcCBdIHx8ICggbnNOb3JtYWxpemVEaWN0WyBwcm9wIF0gPSAkLmNhbWVsQ2FzZSggJC5tb2JpbGUubnMgKyBwcm9wICkgKTsKCQl9LAoKCQkvLyBGaW5kIHRoZSBjbG9zZXN0IHBhcmVudCB3aXRoIGEgdGhlbWUgY2xhc3Mgb24gaXQuIE5vdGUgdGhhdAoJCS8vIHdlIGFyZSBub3QgdXNpbmcgJC5mbi5jbG9zZXN0KCkgb24gcHVycG9zZSBoZXJlIGJlY2F1c2UgdGhpcwoJCS8vIG1ldGhvZCBnZXRzIGNhbGxlZCBxdWl0ZSBhIGJpdCBhbmQgd2UgbmVlZCBpdCB0byBiZSBhcyBmYXN0CgkJLy8gYXMgcG9zc2libGUuCgkJZ2V0SW5oZXJpdGVkVGhlbWU6IGZ1bmN0aW9uKCBlbCwgZGVmYXVsdFRoZW1lICkgewoJCQl2YXIgZSA9IGVsWyAwIF0sCgkJCQlsdHIgPSAiIiwKCQkJCXJlID0gL3VpLShiYXJ8Ym9keXxvdmVybGF5KS0oW2Etel0pXGIvLAoJCQkJYywgbTsKCgkJCXdoaWxlICggZSApIHsKCQkJCWMgPSBlLmNsYXNzTmFtZSB8fCAiIjsKCQkJCWlmICggYyAmJiAoIG0gPSByZS5leGVjKCBjICkgKSAmJiAoIGx0ciA9IG1bIDIgXSApICkgewoJCQkJCS8vIFdlIGZvdW5kIGEgcGFyZW50IHdpdGggYSB0aGVtZSBjbGFzcwoJCQkJCS8vIG9uIGl0IHNvIGJhaWwgZnJvbSB0aGlzIGxvb3AuCgkJCQkJYnJlYWs7CgkJCQl9CgoJCQkJZSA9IGUucGFyZW50Tm9kZTsKCQkJfQoKCQkJLy8gUmV0dXJuIHRoZSB0aGVtZSBsZXR0ZXIgd2UgZm91bmQsIGlmIG5vbmUsIHJldHVybiB0aGUKCQkJLy8gc3BlY2lmaWVkIGRlZmF1bHQuCgoJCQlyZXR1cm4gbHRyIHx8IGRlZmF1bHRUaGVtZSB8fCAiYSI7CgkJfSwKCgkJLy8gVE9ETyB0aGUgZm9sbG93aW5nICQgYW5kICQuZm4gZXh0ZW5zaW9ucyBjYW4vcHJvYmFibHkgc2hvdWxkIGJlIG1vdmVkIGludG8ganF1ZXJ5Lm1vYmlsZS5jb3JlLmhlbHBlcnMKCQkvLwoJCS8vIEZpbmQgdGhlIGNsb3Nlc3QgamF2YXNjcmlwdCBwYWdlIGVsZW1lbnQgdG8gZ2F0aGVyIHNldHRpbmdzIGRhdGEganNwZXJmIHRlc3QKCQkvLyBodHRwOi8vanNwZXJmLmNvbS9zaW5nbGUtY29tcGxleC1zZWxlY3Rvci12cy1tYW55LWNvbXBsZXgtc2VsZWN0b3JzL2VkaXQKCQkvLyBwb3NzaWJseSBuYWl2ZSwgYnV0IGl0IHNob3dzIHRoYXQgdGhlIHBhcnNpbmcgb3ZlcmhlYWQgZm9yICpqdXN0KiB0aGUgcGFnZSBzZWxlY3RvciB2cwoJCS8vIHRoZSBwYWdlIGFuZCBkaWFsb2cgc2VsZWN0b3IgaXMgbmVnbGlnYWJsZS4gVGhpcyBjb3VsZCBwcm9iYWJseSBiZSBzcGVlZCB1cCBieQoJCS8vIGRvaW5nIGEgc2ltaWxhciBwYXJlbnQgbm9kZSB0cmF2ZXJzYWwgdG8gdGhlIG9uZSBmb3VuZCBpbiB0aGUgaW5oZXJpdGVkIHRoZW1lIGNvZGUgYWJvdmUKCQljbG9zZXN0UGFnZURhdGE6IGZ1bmN0aW9uKCAkdGFyZ2V0ICkgewoJCQlyZXR1cm4gJHRhcmdldAoJCQkJLmNsb3Nlc3QoICc6anFtRGF0YShyb2xlPSJwYWdlIiksIDpqcW1EYXRhKHJvbGU9ImRpYWxvZyIpJyApCgkJCQkuZGF0YSggInBhZ2UiICk7CgkJfSwKCgkJZW5oYW5jZWFibGU6IGZ1bmN0aW9uKCAkc2V0ICkgewoJCQlyZXR1cm4gdGhpcy5oYXZlUGFyZW50cyggJHNldCwgImVuaGFuY2UiICk7CgkJfSwKCgkJaGlqYWNrYWJsZTogZnVuY3Rpb24oICRzZXQgKSB7CgkJCXJldHVybiB0aGlzLmhhdmVQYXJlbnRzKCAkc2V0LCAiYWpheCIgKTsKCQl9LAoKCQloYXZlUGFyZW50czogZnVuY3Rpb24oICRzZXQsIGF0dHIgKSB7CgkJCWlmICggISQubW9iaWxlLmlnbm9yZUNvbnRlbnRFbmFibGVkICkgewoJCQkJcmV0dXJuICRzZXQ7CgkJCX0KCgkJCXZhciBjb3VudCA9ICRzZXQubGVuZ3RoLAoJCQkJJG5ld1NldCA9ICQoKSwKCQkJCWUsICRlbGVtZW50LCBleGNsdWRlZDsKCgkJCWZvciAoIHZhciBpID0gMDsgaSA8IGNvdW50OyBpKysgKSB7CgkJCQkkZWxlbWVudCA9ICRzZXQuZXEoIGkgKTsKCQkJCWV4Y2x1ZGVkID0gZmFsc2U7CgkJCQllID0gJHNldFsgaSBdOwoKCQkJCXdoaWxlICggZSApIHsKCQkJCQl2YXIgYyA9IGUuZ2V0QXR0cmlidXRlID8gZS5nZXRBdHRyaWJ1dGUoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArIGF0dHIgKSA6ICIiOwoKCQkJCQlpZiAoIGMgPT09ICJmYWxzZSIgKSB7CgkJCQkJCWV4Y2x1ZGVkID0gdHJ1ZTsKCQkJCQkJYnJlYWs7CgkJCQkJfQoKCQkJCQllID0gZS5wYXJlbnROb2RlOwoJCQkJfQoKCQkJCWlmICggIWV4Y2x1ZGVkICkgewoJCQkJCSRuZXdTZXQgPSAkbmV3U2V0LmFkZCggJGVsZW1lbnQgKTsKCQkJCX0KCQkJfQoKCQkJcmV0dXJuICRuZXdTZXQ7CgkJfSwKCgkJZ2V0U2NyZWVuSGVpZ2h0OiBmdW5jdGlvbigpIHsKCQkJLy8gTmF0aXZlIGlubmVySGVpZ2h0IHJldHVybnMgbW9yZSBhY2N1cmF0ZSB2YWx1ZSBmb3IgdGhpcyBhY3Jvc3MgcGxhdGZvcm1zLAoJCQkvLyBqUXVlcnkgdmVyc2lvbiBpcyBoZXJlIGFzIGEgbm9ybWFsaXplZCBmYWxsYmFjayBmb3IgcGxhdGZvcm1zIGxpa2UgU3ltYmlhbgoJCQlyZXR1cm4gd2luZG93LmlubmVySGVpZ2h0IHx8ICQoIHdpbmRvdyApLmhlaWdodCgpOwoJCX0KCX0sICQubW9iaWxlICk7CgoJLy8gTW9iaWxlIHZlcnNpb24gb2YgZGF0YSBhbmQgcmVtb3ZlRGF0YSBhbmQgaGFzRGF0YSBtZXRob2RzCgkvLyBlbnN1cmVzIGFsbCBkYXRhIGlzIHNldCBhbmQgcmV0cmlldmVkIHVzaW5nIGpRdWVyeSBNb2JpbGUncyBkYXRhIG5hbWVzcGFjZQoJJC5mbi5qcW1EYXRhID0gZnVuY3Rpb24oIHByb3AsIHZhbHVlICkgewoJCXZhciByZXN1bHQ7CgkJaWYgKCB0eXBlb2YgcHJvcCAhPT0gInVuZGVmaW5lZCIgKSB7CgkJCWlmICggcHJvcCApIHsKCQkJCXByb3AgPSAkLm1vYmlsZS5uc05vcm1hbGl6ZSggcHJvcCApOwoJCQl9CgoJCQkvLyB1bmRlZmluZWQgaXMgcGVybWl0dGVkIGFzIGFuIGV4cGxpY2l0IGlucHV0IGZvciB0aGUgc2Vjb25kIHBhcmFtCgkJCS8vIGluIHRoaXMgY2FzZSBpdCByZXR1cm5zIHRoZSB2YWx1ZSBhbmQgZG9lcyBub3Qgc2V0IGl0IHRvIHVuZGVmaW5lZAoJCQlpZiggYXJndW1lbnRzLmxlbmd0aCA8IDIgfHwgdmFsdWUgPT09IHVuZGVmaW5lZCApewoJCQkJcmVzdWx0ID0gdGhpcy5kYXRhKCBwcm9wICk7CgkJCX0gZWxzZSB7CgkJCQlyZXN1bHQgPSB0aGlzLmRhdGEoIHByb3AsIHZhbHVlICk7CgkJCX0KCQl9CgkJcmV0dXJuIHJlc3VsdDsKCX07CgoJJC5qcW1EYXRhID0gZnVuY3Rpb24oIGVsZW0sIHByb3AsIHZhbHVlICkgewoJCXZhciByZXN1bHQ7CgkJaWYgKCB0eXBlb2YgcHJvcCAhPT0gInVuZGVmaW5lZCIgKSB7CgkJCXJlc3VsdCA9ICQuZGF0YSggZWxlbSwgcHJvcCA/ICQubW9iaWxlLm5zTm9ybWFsaXplKCBwcm9wICkgOiBwcm9wLCB2YWx1ZSApOwoJCX0KCQlyZXR1cm4gcmVzdWx0OwoJfTsKCgkkLmZuLmpxbVJlbW92ZURhdGEgPSBmdW5jdGlvbiggcHJvcCApIHsKCQlyZXR1cm4gdGhpcy5yZW1vdmVEYXRhKCAkLm1vYmlsZS5uc05vcm1hbGl6ZSggcHJvcCApICk7Cgl9OwoKCSQuanFtUmVtb3ZlRGF0YSA9IGZ1bmN0aW9uKCBlbGVtLCBwcm9wICkgewoJCXJldHVybiAkLnJlbW92ZURhdGEoIGVsZW0sICQubW9iaWxlLm5zTm9ybWFsaXplKCBwcm9wICkgKTsKCX07CgoJJC5mbi5yZW1vdmVXaXRoRGVwZW5kZW50cyA9IGZ1bmN0aW9uKCkgewoJCSQucmVtb3ZlV2l0aERlcGVuZGVudHMoIHRoaXMgKTsKCX07CgoJJC5yZW1vdmVXaXRoRGVwZW5kZW50cyA9IGZ1bmN0aW9uKCBlbGVtICkgewoJCXZhciAkZWxlbSA9ICQoIGVsZW0gKTsKCgkJKCAkZWxlbS5qcW1EYXRhKCAnZGVwZW5kZW50cycgKSB8fCAkKCkgKS5yZW1vdmUoKTsKCQkkZWxlbS5yZW1vdmUoKTsKCX07CgoJJC5mbi5hZGREZXBlbmRlbnRzID0gZnVuY3Rpb24oIG5ld0RlcGVuZGVudHMgKSB7CgkJJC5hZGREZXBlbmRlbnRzKCAkKCB0aGlzICksIG5ld0RlcGVuZGVudHMgKTsKCX07CgoJJC5hZGREZXBlbmRlbnRzID0gZnVuY3Rpb24oIGVsZW0sIG5ld0RlcGVuZGVudHMgKSB7CgkJdmFyIGRlcGVuZGVudHMgPSAkKCBlbGVtICkuanFtRGF0YSggJ2RlcGVuZGVudHMnICkgfHwgJCgpOwoKCQkkKCBlbGVtICkuanFtRGF0YSggJ2RlcGVuZGVudHMnLCAkLm1lcmdlKCBkZXBlbmRlbnRzLCBuZXdEZXBlbmRlbnRzICkgKTsKCX07CgoJLy8gbm90ZSB0aGF0IHRoaXMgaGVscGVyIGRvZXNuJ3QgYXR0ZW1wdCB0byBoYW5kbGUgdGhlIGNhbGxiYWNrCgkvLyBvciBzZXR0aW5nIG9mIGFuIGh0bWwgZWxlbWVudHMgdGV4dCwgaXRzIG9ubHkgcHVycG9zZSBpcwoJLy8gdG8gcmV0dXJuIHRoZSBodG1sIGVuY29kZWQgdmVyc2lvbiBvZiB0aGUgdGV4dCBpbiBhbGwgY2FzZXMuICh0aHVzIHRoZSBuYW1lKQoJJC5mbi5nZXRFbmNvZGVkVGV4dCA9IGZ1bmN0aW9uKCkgewoJCXJldHVybiAkKCAiPGRpdi8+IiApLnRleHQoICQoIHRoaXMgKS50ZXh0KCkgKS5odG1sKCk7Cgl9OwoKCS8vIGZsdWVudCBoZWxwZXIgZnVuY3Rpb24gZm9yIHRoZSBtb2JpbGUgbmFtZXNwYWNlZCBlcXVpdmFsZW50CgkkLmZuLmpxbUVuaGFuY2VhYmxlID0gZnVuY3Rpb24oKSB7CgkJcmV0dXJuICQubW9iaWxlLmVuaGFuY2VhYmxlKCB0aGlzICk7Cgl9OwoKCSQuZm4uanFtSGlqYWNrYWJsZSA9IGZ1bmN0aW9uKCkgewoJCXJldHVybiAkLm1vYmlsZS5oaWphY2thYmxlKCB0aGlzICk7Cgl9OwoKCS8vIE1vbmtleS1wYXRjaGluZyBTaXp6bGUgdG8gZmlsdGVyIHRoZSA6anFtRGF0YSBzZWxlY3RvcgoJdmFyIG9sZEZpbmQgPSAkLmZpbmQsCgkJanFtRGF0YVJFID0gLzpqcW1EYXRhXCgoW14pXSopXCkvZzsKCgkkLmZpbmQgPSBmdW5jdGlvbiggc2VsZWN0b3IsIGNvbnRleHQsIHJldCwgZXh0cmEgKSB7CgkJc2VsZWN0b3IgPSBzZWxlY3Rvci5yZXBsYWNlKCBqcW1EYXRhUkUsICJbZGF0YS0iICsgKCAkLm1vYmlsZS5ucyB8fCAiIiApICsgIiQxXSIgKTsKCgkJcmV0dXJuIG9sZEZpbmQuY2FsbCggdGhpcywgc2VsZWN0b3IsIGNvbnRleHQsIHJldCwgZXh0cmEgKTsKCX07CgoJJC5leHRlbmQoICQuZmluZCwgb2xkRmluZCApOwoKCSQuZmluZC5tYXRjaGVzID0gZnVuY3Rpb24oIGV4cHIsIHNldCApIHsKCQlyZXR1cm4gJC5maW5kKCBleHByLCBudWxsLCBudWxsLCBzZXQgKTsKCX07CgoJJC5maW5kLm1hdGNoZXNTZWxlY3RvciA9IGZ1bmN0aW9uKCBub2RlLCBleHByICkgewoJCXJldHVybiAkLmZpbmQoIGV4cHIsIG51bGwsIG51bGwsIFsgbm9kZSBdICkubGVuZ3RoID4gMDsKCX07Cn0pKCBqUXVlcnksIHRoaXMgKTsKCgovKiEKICogalF1ZXJ5IFVJIFdpZGdldCB2MS45LjAtYmV0YS4xCiAqCiAqIENvcHlyaWdodCAyMDEyLCBodHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L2pxdWVyeS11aS9ibG9iLzEuOS4wLWJldGEuMS9BVVRIT1JTLnR4dCAoaHR0cDovL2pxdWVyeXVpLmNvbS9hYm91dCkKICogRHVhbCBsaWNlbnNlZCB1bmRlciB0aGUgTUlUIG9yIEdQTCBWZXJzaW9uIDIgbGljZW5zZXMuCiAqIGh0dHA6Ly9qcXVlcnkub3JnL2xpY2Vuc2UKICoKICogaHR0cDovL2RvY3MuanF1ZXJ5LmNvbS9VSS9XaWRnZXQKICovCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKdmFyIHV1aWQgPSAwLAoJc2xpY2UgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UsCglfY2xlYW5EYXRhID0gJC5jbGVhbkRhdGE7CiQuY2xlYW5EYXRhID0gZnVuY3Rpb24oIGVsZW1zICkgewoJZm9yICggdmFyIGkgPSAwLCBlbGVtOyAoZWxlbSA9IGVsZW1zW2ldKSAhPSBudWxsOyBpKysgKSB7CgkJdHJ5IHsKCQkJJCggZWxlbSApLnRyaWdnZXJIYW5kbGVyKCAicmVtb3ZlIiApOwoJCS8vIGh0dHA6Ly9idWdzLmpxdWVyeS5jb20vdGlja2V0LzgyMzUKCQl9IGNhdGNoKCBlICkge30KCX0KCV9jbGVhbkRhdGEoIGVsZW1zICk7Cn07CgokLndpZGdldCA9IGZ1bmN0aW9uKCBuYW1lLCBiYXNlLCBwcm90b3R5cGUgKSB7Cgl2YXIgZnVsbE5hbWUsIGV4aXN0aW5nQ29uc3RydWN0b3IsIGNvbnN0cnVjdG9yLCBiYXNlUHJvdG90eXBlLAoJCW5hbWVzcGFjZSA9IG5hbWUuc3BsaXQoICIuIiApWyAwIF07CgoJbmFtZSA9IG5hbWUuc3BsaXQoICIuIiApWyAxIF07CglmdWxsTmFtZSA9IG5hbWVzcGFjZSArICItIiArIG5hbWU7CgoJaWYgKCAhcHJvdG90eXBlICkgewoJCXByb3RvdHlwZSA9IGJhc2U7CgkJYmFzZSA9ICQuV2lkZ2V0OwoJfQoKCS8vIGNyZWF0ZSBzZWxlY3RvciBmb3IgcGx1Z2luCgkkLmV4cHJbICI6IiBdWyBmdWxsTmFtZSBdID0gZnVuY3Rpb24oIGVsZW0gKSB7CgkJcmV0dXJuICEhJC5kYXRhKCBlbGVtLCBmdWxsTmFtZSApOwoJfTsKCgkkWyBuYW1lc3BhY2UgXSA9ICRbIG5hbWVzcGFjZSBdIHx8IHt9OwoJZXhpc3RpbmdDb25zdHJ1Y3RvciA9ICRbIG5hbWVzcGFjZSBdWyBuYW1lIF07Cgljb25zdHJ1Y3RvciA9ICRbIG5hbWVzcGFjZSBdWyBuYW1lIF0gPSBmdW5jdGlvbiggb3B0aW9ucywgZWxlbWVudCApIHsKCQkvLyBhbGxvdyBpbnN0YW50aWF0aW9uIHdpdGhvdXQgIm5ldyIga2V5d29yZAoJCWlmICggIXRoaXMuX2NyZWF0ZVdpZGdldCApIHsKCQkJcmV0dXJuIG5ldyBjb25zdHJ1Y3Rvciggb3B0aW9ucywgZWxlbWVudCApOwoJCX0KCgkJLy8gYWxsb3cgaW5zdGFudGlhdGlvbiB3aXRob3V0IGluaXRpYWxpemluZyBmb3Igc2ltcGxlIGluaGVyaXRhbmNlCgkJLy8gbXVzdCB1c2UgIm5ldyIga2V5d29yZCAodGhlIGNvZGUgYWJvdmUgYWx3YXlzIHBhc3NlcyBhcmdzKQoJCWlmICggYXJndW1lbnRzLmxlbmd0aCApIHsKCQkJdGhpcy5fY3JlYXRlV2lkZ2V0KCBvcHRpb25zLCBlbGVtZW50ICk7CgkJfQoJfTsKCS8vIGV4dGVuZCB3aXRoIHRoZSBleGlzdGluZyBjb25zdHJ1Y3RvciB0byBjYXJyeSBvdmVyIGFueSBzdGF0aWMgcHJvcGVydGllcwoJJC5leHRlbmQoIGNvbnN0cnVjdG9yLCBleGlzdGluZ0NvbnN0cnVjdG9yLCB7CgkJdmVyc2lvbjogcHJvdG90eXBlLnZlcnNpb24sCgkJLy8gY29weSB0aGUgb2JqZWN0IHVzZWQgdG8gY3JlYXRlIHRoZSBwcm90b3R5cGUgaW4gY2FzZSB3ZSBuZWVkIHRvCgkJLy8gcmVkZWZpbmUgdGhlIHdpZGdldCBsYXRlcgoJCV9wcm90bzogJC5leHRlbmQoIHt9LCBwcm90b3R5cGUgKSwKCQkvLyB0cmFjayB3aWRnZXRzIHRoYXQgaW5oZXJpdCBmcm9tIHRoaXMgd2lkZ2V0IGluIGNhc2UgdGhpcyB3aWRnZXQgaXMKCQkvLyByZWRlZmluZWQgYWZ0ZXIgYSB3aWRnZXQgaW5oZXJpdHMgZnJvbSBpdAoJCV9jaGlsZENvbnN0cnVjdG9yczogW10KCX0pOwoKCWJhc2VQcm90b3R5cGUgPSBuZXcgYmFzZSgpOwoJLy8gd2UgbmVlZCB0byBtYWtlIHRoZSBvcHRpb25zIGhhc2ggYSBwcm9wZXJ0eSBkaXJlY3RseSBvbiB0aGUgbmV3IGluc3RhbmNlCgkvLyBvdGhlcndpc2Ugd2UnbGwgbW9kaWZ5IHRoZSBvcHRpb25zIGhhc2ggb24gdGhlIHByb3RvdHlwZSB0aGF0IHdlJ3JlCgkvLyBpbmhlcml0aW5nIGZyb20KCWJhc2VQcm90b3R5cGUub3B0aW9ucyA9ICQud2lkZ2V0LmV4dGVuZCgge30sIGJhc2VQcm90b3R5cGUub3B0aW9ucyApOwoJJC5lYWNoKCBwcm90b3R5cGUsIGZ1bmN0aW9uKCBwcm9wLCB2YWx1ZSApIHsKCQlpZiAoICQuaXNGdW5jdGlvbiggdmFsdWUgKSApIHsKCQkJcHJvdG90eXBlWyBwcm9wIF0gPSAoZnVuY3Rpb24oKSB7CgkJCQl2YXIgX3N1cGVyID0gZnVuY3Rpb24oKSB7CgkJCQkJCXJldHVybiBiYXNlLnByb3RvdHlwZVsgcHJvcCBdLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsKCQkJCQl9LAoJCQkJCV9zdXBlckFwcGx5ID0gZnVuY3Rpb24oIGFyZ3MgKSB7CgkJCQkJCXJldHVybiBiYXNlLnByb3RvdHlwZVsgcHJvcCBdLmFwcGx5KCB0aGlzLCBhcmdzICk7CgkJCQkJfTsKCQkJCXJldHVybiBmdW5jdGlvbigpIHsKCQkJCQl2YXIgX19zdXBlciA9IHRoaXMuX3N1cGVyLAoJCQkJCQlfX3N1cGVyQXBwbHkgPSB0aGlzLl9zdXBlckFwcGx5LAoJCQkJCQlyZXR1cm5WYWx1ZTsKCgkJCQkJdGhpcy5fc3VwZXIgPSBfc3VwZXI7CgkJCQkJdGhpcy5fc3VwZXJBcHBseSA9IF9zdXBlckFwcGx5OwoKCQkJCQlyZXR1cm5WYWx1ZSA9IHZhbHVlLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsKCgkJCQkJdGhpcy5fc3VwZXIgPSBfX3N1cGVyOwoJCQkJCXRoaXMuX3N1cGVyQXBwbHkgPSBfX3N1cGVyQXBwbHk7CgoJCQkJCXJldHVybiByZXR1cm5WYWx1ZTsKCQkJCX07CgkJCX0pKCk7CgkJfQoJfSk7Cgljb25zdHJ1Y3Rvci5wcm90b3R5cGUgPSAkLndpZGdldC5leHRlbmQoIGJhc2VQcm90b3R5cGUsIHsKCQkvLyBUT0RPOiByZW1vdmUgc3VwcG9ydCBmb3Igd2lkZ2V0RXZlbnRQcmVmaXgKCQkvLyBhbHdheXMgdXNlIHRoZSBuYW1lICsgYSBjb2xvbiBhcyB0aGUgcHJlZml4LCBlLmcuLCBkcmFnZ2FibGU6c3RhcnQKCQkvLyBkb24ndCBwcmVmaXggZm9yIHdpZGdldHMgdGhhdCBhcmVuJ3QgRE9NLWJhc2VkCgkJd2lkZ2V0RXZlbnRQcmVmaXg6IG5hbWUKCX0sIHByb3RvdHlwZSwgewoJCWNvbnN0cnVjdG9yOiBjb25zdHJ1Y3RvciwKCQluYW1lc3BhY2U6IG5hbWVzcGFjZSwKCQl3aWRnZXROYW1lOiBuYW1lLAoJCS8vIFRPRE8gcmVtb3ZlIHdpZGdldEJhc2VDbGFzcywgc2VlICM4MTU1CgkJd2lkZ2V0QmFzZUNsYXNzOiBmdWxsTmFtZSwKCQl3aWRnZXRGdWxsTmFtZTogZnVsbE5hbWUKCX0pOwoKCS8vIElmIHRoaXMgd2lkZ2V0IGlzIGJlaW5nIHJlZGVmaW5lZCB0aGVuIHdlIG5lZWQgdG8gZmluZCBhbGwgd2lkZ2V0cyB0aGF0CgkvLyBhcmUgaW5oZXJpdGluZyBmcm9tIGl0IGFuZCByZWRlZmluZSBhbGwgb2YgdGhlbSBzbyB0aGF0IHRoZXkgaW5oZXJpdCBmcm9tCgkvLyB0aGUgbmV3IHZlcnNpb24gb2YgdGhpcyB3aWRnZXQuIFdlJ3JlIGVzc2VudGlhbGx5IHRyeWluZyB0byByZXBsYWNlIG9uZQoJLy8gbGV2ZWwgaW4gdGhlIHByb3RvdHlwZSBjaGFpbi4KCWlmICggZXhpc3RpbmdDb25zdHJ1Y3RvciApIHsKCQkkLmVhY2goIGV4aXN0aW5nQ29uc3RydWN0b3IuX2NoaWxkQ29uc3RydWN0b3JzLCBmdW5jdGlvbiggaSwgY2hpbGQgKSB7CgkJCXZhciBjaGlsZFByb3RvdHlwZSA9IGNoaWxkLnByb3RvdHlwZTsKCgkJCS8vIHJlZGVmaW5lIHRoZSBjaGlsZCB3aWRnZXQgdXNpbmcgdGhlIHNhbWUgcHJvdG90eXBlIHRoYXQgd2FzCgkJCS8vIG9yaWdpbmFsbHkgdXNlZCwgYnV0IGluaGVyaXQgZnJvbSB0aGUgbmV3IHZlcnNpb24gb2YgdGhlIGJhc2UKCQkJJC53aWRnZXQoIGNoaWxkUHJvdG90eXBlLm5hbWVzcGFjZSArICIuIiArIGNoaWxkUHJvdG90eXBlLndpZGdldE5hbWUsIGNvbnN0cnVjdG9yLCBjaGlsZC5fcHJvdG8gKTsKCQl9KTsKCQkvLyByZW1vdmUgdGhlIGxpc3Qgb2YgZXhpc3RpbmcgY2hpbGQgY29uc3RydWN0b3JzIGZyb20gdGhlIG9sZCBjb25zdHJ1Y3RvcgoJCS8vIHNvIHRoZSBvbGQgY2hpbGQgY29uc3RydWN0b3JzIGNhbiBiZSBnYXJiYWdlIGNvbGxlY3RlZAoJCWRlbGV0ZSBleGlzdGluZ0NvbnN0cnVjdG9yLl9jaGlsZENvbnN0cnVjdG9yczsKCX0gZWxzZSB7CgkJYmFzZS5fY2hpbGRDb25zdHJ1Y3RvcnMucHVzaCggY29uc3RydWN0b3IgKTsKCX0KCgkkLndpZGdldC5icmlkZ2UoIG5hbWUsIGNvbnN0cnVjdG9yICk7Cn07CgokLndpZGdldC5leHRlbmQgPSBmdW5jdGlvbiggdGFyZ2V0ICkgewoJdmFyIGlucHV0ID0gc2xpY2UuY2FsbCggYXJndW1lbnRzLCAxICksCgkJaW5wdXRJbmRleCA9IDAsCgkJaW5wdXRMZW5ndGggPSBpbnB1dC5sZW5ndGgsCgkJa2V5LAoJCXZhbHVlOwoJZm9yICggOyBpbnB1dEluZGV4IDwgaW5wdXRMZW5ndGg7IGlucHV0SW5kZXgrKyApIHsKCQlmb3IgKCBrZXkgaW4gaW5wdXRbIGlucHV0SW5kZXggXSApIHsKCQkJdmFsdWUgPSBpbnB1dFsgaW5wdXRJbmRleCBdWyBrZXkgXTsKCQkJaWYgKGlucHV0WyBpbnB1dEluZGV4IF0uaGFzT3duUHJvcGVydHkoIGtleSApICYmIHZhbHVlICE9PSB1bmRlZmluZWQgKSB7CgkJCQl0YXJnZXRbIGtleSBdID0gJC5pc1BsYWluT2JqZWN0KCB2YWx1ZSApID8gJC53aWRnZXQuZXh0ZW5kKCB7fSwgdGFyZ2V0WyBrZXkgXSwgdmFsdWUgKSA6IHZhbHVlOwoJCQl9CgkJfQoJfQoJcmV0dXJuIHRhcmdldDsKfTsKCiQud2lkZ2V0LmJyaWRnZSA9IGZ1bmN0aW9uKCBuYW1lLCBvYmplY3QgKSB7Cgl2YXIgZnVsbE5hbWUgPSBvYmplY3QucHJvdG90eXBlLndpZGdldEZ1bGxOYW1lOwoJJC5mblsgbmFtZSBdID0gZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJdmFyIGlzTWV0aG9kQ2FsbCA9IHR5cGVvZiBvcHRpb25zID09PSAic3RyaW5nIiwKCQkJYXJncyA9IHNsaWNlLmNhbGwoIGFyZ3VtZW50cywgMSApLAoJCQlyZXR1cm5WYWx1ZSA9IHRoaXM7CgoJCS8vIGFsbG93IG11bHRpcGxlIGhhc2hlcyB0byBiZSBwYXNzZWQgb24gaW5pdAoJCW9wdGlvbnMgPSAhaXNNZXRob2RDYWxsICYmIGFyZ3MubGVuZ3RoID8KCQkJJC53aWRnZXQuZXh0ZW5kLmFwcGx5KCBudWxsLCBbIG9wdGlvbnMgXS5jb25jYXQoYXJncykgKSA6CgkJCW9wdGlvbnM7CgoJCWlmICggaXNNZXRob2RDYWxsICkgewoJCQl0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgkJCQl2YXIgbWV0aG9kVmFsdWUsCgkJCQkJaW5zdGFuY2UgPSAkLmRhdGEoIHRoaXMsIGZ1bGxOYW1lICk7CgkJCQlpZiAoICFpbnN0YW5jZSApIHsKCQkJCQlyZXR1cm4gJC5lcnJvciggImNhbm5vdCBjYWxsIG1ldGhvZHMgb24gIiArIG5hbWUgKyAiIHByaW9yIHRvIGluaXRpYWxpemF0aW9uOyAiICsKCQkJCQkJImF0dGVtcHRlZCB0byBjYWxsIG1ldGhvZCAnIiArIG9wdGlvbnMgKyAiJyIgKTsKCQkJCX0KCQkJCWlmICggISQuaXNGdW5jdGlvbiggaW5zdGFuY2Vbb3B0aW9uc10gKSB8fCBvcHRpb25zLmNoYXJBdCggMCApID09PSAiXyIgKSB7CgkJCQkJcmV0dXJuICQuZXJyb3IoICJubyBzdWNoIG1ldGhvZCAnIiArIG9wdGlvbnMgKyAiJyBmb3IgIiArIG5hbWUgKyAiIHdpZGdldCBpbnN0YW5jZSIgKTsKCQkJCX0KCQkJCW1ldGhvZFZhbHVlID0gaW5zdGFuY2VbIG9wdGlvbnMgXS5hcHBseSggaW5zdGFuY2UsIGFyZ3MgKTsKCQkJCWlmICggbWV0aG9kVmFsdWUgIT09IGluc3RhbmNlICYmIG1ldGhvZFZhbHVlICE9PSB1bmRlZmluZWQgKSB7CgkJCQkJcmV0dXJuVmFsdWUgPSBtZXRob2RWYWx1ZSAmJiBtZXRob2RWYWx1ZS5qcXVlcnkgPwoJCQkJCQlyZXR1cm5WYWx1ZS5wdXNoU3RhY2soIG1ldGhvZFZhbHVlLmdldCgpICkgOgoJCQkJCQltZXRob2RWYWx1ZTsKCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQl9CgkJCX0pOwoJCX0gZWxzZSB7CgkJCXRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJCXZhciBpbnN0YW5jZSA9ICQuZGF0YSggdGhpcywgZnVsbE5hbWUgKTsKCQkJCWlmICggaW5zdGFuY2UgKSB7CgkJCQkJaW5zdGFuY2Uub3B0aW9uKCBvcHRpb25zIHx8IHt9ICkuX2luaXQoKTsKCQkJCX0gZWxzZSB7CgkJCQkJbmV3IG9iamVjdCggb3B0aW9ucywgdGhpcyApOwoJCQkJfQoJCQl9KTsKCQl9CgoJCXJldHVybiByZXR1cm5WYWx1ZTsKCX07Cn07CgokLldpZGdldCA9IGZ1bmN0aW9uKCBvcHRpb25zLCBlbGVtZW50ICkge307CiQuV2lkZ2V0Ll9jaGlsZENvbnN0cnVjdG9ycyA9IFtdOwoKJC5XaWRnZXQucHJvdG90eXBlID0gewoJd2lkZ2V0TmFtZTogIndpZGdldCIsCgl3aWRnZXRFdmVudFByZWZpeDogIiIsCglkZWZhdWx0RWxlbWVudDogIjxkaXY+IiwKCW9wdGlvbnM6IHsKCQlkaXNhYmxlZDogZmFsc2UsCgoJCS8vIGNhbGxiYWNrcwoJCWNyZWF0ZTogbnVsbAoJfSwKCV9jcmVhdGVXaWRnZXQ6IGZ1bmN0aW9uKCBvcHRpb25zLCBlbGVtZW50ICkgewoJCWVsZW1lbnQgPSAkKCBlbGVtZW50IHx8IHRoaXMuZGVmYXVsdEVsZW1lbnQgfHwgdGhpcyApWyAwIF07CgkJdGhpcy5lbGVtZW50ID0gJCggZWxlbWVudCApOwoJCXRoaXMudXVpZCA9IHV1aWQrKzsKCQl0aGlzLmV2ZW50TmFtZXNwYWNlID0gIi4iICsgdGhpcy53aWRnZXROYW1lICsgdGhpcy51dWlkOwoJCXRoaXMub3B0aW9ucyA9ICQud2lkZ2V0LmV4dGVuZCgge30sCgkJCXRoaXMub3B0aW9ucywKCQkJdGhpcy5fZ2V0Q3JlYXRlT3B0aW9ucygpLAoJCQlvcHRpb25zICk7CgoJCXRoaXMuYmluZGluZ3MgPSAkKCk7CgkJdGhpcy5ob3ZlcmFibGUgPSAkKCk7CgkJdGhpcy5mb2N1c2FibGUgPSAkKCk7CgoJCWlmICggZWxlbWVudCAhPT0gdGhpcyApIHsKCQkJLy8gMS45IEJDIGZvciAjNzgxMAoJCQkvLyBUT0RPIHJlbW92ZSBkdWFsIHN0b3JhZ2UKCQkJJC5kYXRhKCBlbGVtZW50LCB0aGlzLndpZGdldE5hbWUsIHRoaXMgKTsKCQkJJC5kYXRhKCBlbGVtZW50LCB0aGlzLndpZGdldEZ1bGxOYW1lLCB0aGlzICk7CgkJCXRoaXMuX29uKHsgcmVtb3ZlOiAiZGVzdHJveSIgfSk7CgkJCXRoaXMuZG9jdW1lbnQgPSAkKCBlbGVtZW50LnN0eWxlID8KCQkJCS8vIGVsZW1lbnQgd2l0aGluIHRoZSBkb2N1bWVudAoJCQkJZWxlbWVudC5vd25lckRvY3VtZW50IDoKCQkJCS8vIGVsZW1lbnQgaXMgd2luZG93IG9yIGRvY3VtZW50CgkJCQllbGVtZW50LmRvY3VtZW50IHx8IGVsZW1lbnQgKTsKCQkJdGhpcy53aW5kb3cgPSAkKCB0aGlzLmRvY3VtZW50WzBdLmRlZmF1bHRWaWV3IHx8IHRoaXMuZG9jdW1lbnRbMF0ucGFyZW50V2luZG93ICk7CgkJfQoKCQl0aGlzLl9jcmVhdGUoKTsKCQl0aGlzLl90cmlnZ2VyKCAiY3JlYXRlIiwgbnVsbCwgdGhpcy5fZ2V0Q3JlYXRlRXZlbnREYXRhKCkgKTsKCQl0aGlzLl9pbml0KCk7Cgl9LAoJX2dldENyZWF0ZU9wdGlvbnM6ICQubm9vcCwKCV9nZXRDcmVhdGVFdmVudERhdGE6ICQubm9vcCwKCV9jcmVhdGU6ICQubm9vcCwKCV9pbml0OiAkLm5vb3AsCgoJZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJdGhpcy5fZGVzdHJveSgpOwoJCS8vIHdlIGNhbiBwcm9iYWJseSByZW1vdmUgdGhlIHVuYmluZCBjYWxscyBpbiAyLjAKCQkvLyBhbGwgZXZlbnQgYmluZGluZ3Mgc2hvdWxkIGdvIHRocm91Z2ggdGhpcy5fb24oKQoJCXRoaXMuZWxlbWVudAoJCQkudW5iaW5kKCB0aGlzLmV2ZW50TmFtZXNwYWNlICkKCQkJLy8gMS45IEJDIGZvciAjNzgxMAoJCQkvLyBUT0RPIHJlbW92ZSBkdWFsIHN0b3JhZ2UKCQkJLnJlbW92ZURhdGEoIHRoaXMud2lkZ2V0TmFtZSApCgkJCS5yZW1vdmVEYXRhKCB0aGlzLndpZGdldEZ1bGxOYW1lICkKCQkJLy8gc3VwcG9ydDoganF1ZXJ5IDwxLjYuMwoJCQkvLyBodHRwOi8vYnVncy5qcXVlcnkuY29tL3RpY2tldC85NDEzCgkJCS5yZW1vdmVEYXRhKCAkLmNhbWVsQ2FzZSggdGhpcy53aWRnZXRGdWxsTmFtZSApICk7CgkJdGhpcy53aWRnZXQoKQoJCQkudW5iaW5kKCB0aGlzLmV2ZW50TmFtZXNwYWNlICkKCQkJLnJlbW92ZUF0dHIoICJhcmlhLWRpc2FibGVkIiApCgkJCS5yZW1vdmVDbGFzcygKCQkJCXRoaXMud2lkZ2V0RnVsbE5hbWUgKyAiLWRpc2FibGVkICIgKwoJCQkJInVpLXN0YXRlLWRpc2FibGVkIiApOwoKCQkvLyBjbGVhbiB1cCBldmVudHMgYW5kIHN0YXRlcwoJCXRoaXMuYmluZGluZ3MudW5iaW5kKCB0aGlzLmV2ZW50TmFtZXNwYWNlICk7CgkJdGhpcy5ob3ZlcmFibGUucmVtb3ZlQ2xhc3MoICJ1aS1zdGF0ZS1ob3ZlciIgKTsKCQl0aGlzLmZvY3VzYWJsZS5yZW1vdmVDbGFzcyggInVpLXN0YXRlLWZvY3VzIiApOwoJfSwKCV9kZXN0cm95OiAkLm5vb3AsCgoJd2lkZ2V0OiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5lbGVtZW50OwoJfSwKCglvcHRpb246IGZ1bmN0aW9uKCBrZXksIHZhbHVlICkgewoJCXZhciBvcHRpb25zID0ga2V5LAoJCQlwYXJ0cywKCQkJY3VyT3B0aW9uLAoJCQlpOwoKCQlpZiAoIGFyZ3VtZW50cy5sZW5ndGggPT09IDAgKSB7CgkJCS8vIGRvbid0IHJldHVybiBhIHJlZmVyZW5jZSB0byB0aGUgaW50ZXJuYWwgaGFzaAoJCQlyZXR1cm4gJC53aWRnZXQuZXh0ZW5kKCB7fSwgdGhpcy5vcHRpb25zICk7CgkJfQoKCQlpZiAoIHR5cGVvZiBrZXkgPT09ICJzdHJpbmciICkgewoJCQkvLyBoYW5kbGUgbmVzdGVkIGtleXMsIGUuZy4sICJmb28uYmFyIiA9PiB7IGZvbzogeyBiYXI6IF9fXyB9IH0KCQkJb3B0aW9ucyA9IHt9OwoJCQlwYXJ0cyA9IGtleS5zcGxpdCggIi4iICk7CgkJCWtleSA9IHBhcnRzLnNoaWZ0KCk7CgkJCWlmICggcGFydHMubGVuZ3RoICkgewoJCQkJY3VyT3B0aW9uID0gb3B0aW9uc1sga2V5IF0gPSAkLndpZGdldC5leHRlbmQoIHt9LCB0aGlzLm9wdGlvbnNbIGtleSBdICk7CgkJCQlmb3IgKCBpID0gMDsgaSA8IHBhcnRzLmxlbmd0aCAtIDE7IGkrKyApIHsKCQkJCQljdXJPcHRpb25bIHBhcnRzWyBpIF0gXSA9IGN1ck9wdGlvblsgcGFydHNbIGkgXSBdIHx8IHt9OwoJCQkJCWN1ck9wdGlvbiA9IGN1ck9wdGlvblsgcGFydHNbIGkgXSBdOwoJCQkJfQoJCQkJa2V5ID0gcGFydHMucG9wKCk7CgkJCQlpZiAoIHZhbHVlID09PSB1bmRlZmluZWQgKSB7CgkJCQkJcmV0dXJuIGN1ck9wdGlvblsga2V5IF0gPT09IHVuZGVmaW5lZCA/IG51bGwgOiBjdXJPcHRpb25bIGtleSBdOwoJCQkJfQoJCQkJY3VyT3B0aW9uWyBrZXkgXSA9IHZhbHVlOwoJCQl9IGVsc2UgewoJCQkJaWYgKCB2YWx1ZSA9PT0gdW5kZWZpbmVkICkgewoJCQkJCXJldHVybiB0aGlzLm9wdGlvbnNbIGtleSBdID09PSB1bmRlZmluZWQgPyBudWxsIDogdGhpcy5vcHRpb25zWyBrZXkgXTsKCQkJCX0KCQkJCW9wdGlvbnNbIGtleSBdID0gdmFsdWU7CgkJCX0KCQl9CgoJCXRoaXMuX3NldE9wdGlvbnMoIG9wdGlvbnMgKTsKCgkJcmV0dXJuIHRoaXM7Cgl9LAoJX3NldE9wdGlvbnM6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCXZhciBrZXk7CgoJCWZvciAoIGtleSBpbiBvcHRpb25zICkgewoJCQl0aGlzLl9zZXRPcHRpb24oIGtleSwgb3B0aW9uc1sga2V5IF0gKTsKCQl9CgoJCXJldHVybiB0aGlzOwoJfSwKCV9zZXRPcHRpb246IGZ1bmN0aW9uKCBrZXksIHZhbHVlICkgewoJCXRoaXMub3B0aW9uc1sga2V5IF0gPSB2YWx1ZTsKCgkJaWYgKCBrZXkgPT09ICJkaXNhYmxlZCIgKSB7CgkJCXRoaXMud2lkZ2V0KCkKCQkJCS50b2dnbGVDbGFzcyggdGhpcy53aWRnZXRGdWxsTmFtZSArICItZGlzYWJsZWQgdWktc3RhdGUtZGlzYWJsZWQiLCAhIXZhbHVlICkKCQkJCS5hdHRyKCAiYXJpYS1kaXNhYmxlZCIsIHZhbHVlICk7CgkJCXRoaXMuaG92ZXJhYmxlLnJlbW92ZUNsYXNzKCAidWktc3RhdGUtaG92ZXIiICk7CgkJCXRoaXMuZm9jdXNhYmxlLnJlbW92ZUNsYXNzKCAidWktc3RhdGUtZm9jdXMiICk7CgkJfQoKCQlyZXR1cm4gdGhpczsKCX0sCgoJZW5hYmxlOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5fc2V0T3B0aW9uKCAiZGlzYWJsZWQiLCBmYWxzZSApOwoJfSwKCWRpc2FibGU6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLl9zZXRPcHRpb24oICJkaXNhYmxlZCIsIHRydWUgKTsKCX0sCgoJX29uOiBmdW5jdGlvbiggZWxlbWVudCwgaGFuZGxlcnMgKSB7CgkJLy8gbm8gZWxlbWVudCBhcmd1bWVudCwgc2h1ZmZsZSBhbmQgdXNlIHRoaXMuZWxlbWVudAoJCWlmICggIWhhbmRsZXJzICkgewoJCQloYW5kbGVycyA9IGVsZW1lbnQ7CgkJCWVsZW1lbnQgPSB0aGlzLmVsZW1lbnQ7CgkJfSBlbHNlIHsKCQkJLy8gYWNjZXB0IHNlbGVjdG9ycywgRE9NIGVsZW1lbnRzCgkJCWVsZW1lbnQgPSAkKCBlbGVtZW50ICk7CgkJCXRoaXMuYmluZGluZ3MgPSB0aGlzLmJpbmRpbmdzLmFkZCggZWxlbWVudCApOwoJCX0KCgkJdmFyIGluc3RhbmNlID0gdGhpczsKCQkkLmVhY2goIGhhbmRsZXJzLCBmdW5jdGlvbiggZXZlbnQsIGhhbmRsZXIgKSB7CgkJCWZ1bmN0aW9uIGhhbmRsZXJQcm94eSgpIHsKCQkJCS8vIGFsbG93IHdpZGdldHMgdG8gY3VzdG9taXplIHRoZSBkaXNhYmxlZCBoYW5kbGluZwoJCQkJLy8gLSBkaXNhYmxlZCBhcyBhbiBhcnJheSBpbnN0ZWFkIG9mIGJvb2xlYW4KCQkJCS8vIC0gZGlzYWJsZWQgY2xhc3MgYXMgbWV0aG9kIGZvciBkaXNhYmxpbmcgaW5kaXZpZHVhbCBwYXJ0cwoJCQkJaWYgKCBpbnN0YW5jZS5vcHRpb25zLmRpc2FibGVkID09PSB0cnVlIHx8CgkJCQkJCSQoIHRoaXMgKS5oYXNDbGFzcyggInVpLXN0YXRlLWRpc2FibGVkIiApICkgewoJCQkJCXJldHVybjsKCQkJCX0KCQkJCXJldHVybiAoIHR5cGVvZiBoYW5kbGVyID09PSAic3RyaW5nIiA/IGluc3RhbmNlWyBoYW5kbGVyIF0gOiBoYW5kbGVyICkKCQkJCQkuYXBwbHkoIGluc3RhbmNlLCBhcmd1bWVudHMgKTsKCQkJfQoKCQkJLy8gY29weSB0aGUgZ3VpZCBzbyBkaXJlY3QgdW5iaW5kaW5nIHdvcmtzCgkJCWlmICggdHlwZW9mIGhhbmRsZXIgIT09ICJzdHJpbmciICkgewoJCQkJaGFuZGxlclByb3h5Lmd1aWQgPSBoYW5kbGVyLmd1aWQgPQoJCQkJCWhhbmRsZXIuZ3VpZCB8fCBoYW5kbGVyUHJveHkuZ3VpZCB8fCAkLmd1aWQrKzsKCQkJfQoKCQkJdmFyIG1hdGNoID0gZXZlbnQubWF0Y2goIC9eKFx3KylccyooLiopJC8gKSwKCQkJCWV2ZW50TmFtZSA9IG1hdGNoWzFdICsgaW5zdGFuY2UuZXZlbnROYW1lc3BhY2UsCgkJCQlzZWxlY3RvciA9IG1hdGNoWzJdOwoJCQlpZiAoIHNlbGVjdG9yICkgewoJCQkJaW5zdGFuY2Uud2lkZ2V0KCkuZGVsZWdhdGUoIHNlbGVjdG9yLCBldmVudE5hbWUsIGhhbmRsZXJQcm94eSApOwoJCQl9IGVsc2UgewoJCQkJZWxlbWVudC5iaW5kKCBldmVudE5hbWUsIGhhbmRsZXJQcm94eSApOwoJCQl9CgkJfSk7Cgl9LAoKCV9vZmY6IGZ1bmN0aW9uKCBlbGVtZW50LCBldmVudE5hbWUgKSB7CgkJZXZlbnROYW1lID0gKGV2ZW50TmFtZSB8fCAiIikuc3BsaXQoICIgIiApLmpvaW4oIHRoaXMuZXZlbnROYW1lc3BhY2UgKyAiICIgKSArIHRoaXMuZXZlbnROYW1lc3BhY2U7CgkJZWxlbWVudC51bmJpbmQoIGV2ZW50TmFtZSApLnVuZGVsZWdhdGUoIGV2ZW50TmFtZSApOwoJfSwKCglfZGVsYXk6IGZ1bmN0aW9uKCBoYW5kbGVyLCBkZWxheSApIHsKCQlmdW5jdGlvbiBoYW5kbGVyUHJveHkoKSB7CgkJCXJldHVybiAoIHR5cGVvZiBoYW5kbGVyID09PSAic3RyaW5nIiA/IGluc3RhbmNlWyBoYW5kbGVyIF0gOiBoYW5kbGVyICkKCQkJCS5hcHBseSggaW5zdGFuY2UsIGFyZ3VtZW50cyApOwoJCX0KCQl2YXIgaW5zdGFuY2UgPSB0aGlzOwoJCXJldHVybiBzZXRUaW1lb3V0KCBoYW5kbGVyUHJveHksIGRlbGF5IHx8IDAgKTsKCX0sCgoJX2hvdmVyYWJsZTogZnVuY3Rpb24oIGVsZW1lbnQgKSB7CgkJdGhpcy5ob3ZlcmFibGUgPSB0aGlzLmhvdmVyYWJsZS5hZGQoIGVsZW1lbnQgKTsKCQl0aGlzLl9vbiggZWxlbWVudCwgewoJCQltb3VzZWVudGVyOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkkKCBldmVudC5jdXJyZW50VGFyZ2V0ICkuYWRkQ2xhc3MoICJ1aS1zdGF0ZS1ob3ZlciIgKTsKCQkJfSwKCQkJbW91c2VsZWF2ZTogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJJCggZXZlbnQuY3VycmVudFRhcmdldCApLnJlbW92ZUNsYXNzKCAidWktc3RhdGUtaG92ZXIiICk7CgkJCX0KCQl9KTsKCX0sCgoJX2ZvY3VzYWJsZTogZnVuY3Rpb24oIGVsZW1lbnQgKSB7CgkJdGhpcy5mb2N1c2FibGUgPSB0aGlzLmZvY3VzYWJsZS5hZGQoIGVsZW1lbnQgKTsKCQl0aGlzLl9vbiggZWxlbWVudCwgewoJCQlmb2N1c2luOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkkKCBldmVudC5jdXJyZW50VGFyZ2V0ICkuYWRkQ2xhc3MoICJ1aS1zdGF0ZS1mb2N1cyIgKTsKCQkJfSwKCQkJZm9jdXNvdXQ6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCSQoIGV2ZW50LmN1cnJlbnRUYXJnZXQgKS5yZW1vdmVDbGFzcyggInVpLXN0YXRlLWZvY3VzIiApOwoJCQl9CgkJfSk7Cgl9LAoKCV90cmlnZ2VyOiBmdW5jdGlvbiggdHlwZSwgZXZlbnQsIGRhdGEgKSB7CgkJdmFyIHByb3AsIG9yaWcsCgkJCWNhbGxiYWNrID0gdGhpcy5vcHRpb25zWyB0eXBlIF07CgoJCWRhdGEgPSBkYXRhIHx8IHt9OwoJCWV2ZW50ID0gJC5FdmVudCggZXZlbnQgKTsKCQlldmVudC50eXBlID0gKCB0eXBlID09PSB0aGlzLndpZGdldEV2ZW50UHJlZml4ID8KCQkJdHlwZSA6CgkJCXRoaXMud2lkZ2V0RXZlbnRQcmVmaXggKyB0eXBlICkudG9Mb3dlckNhc2UoKTsKCQkvLyB0aGUgb3JpZ2luYWwgZXZlbnQgbWF5IGNvbWUgZnJvbSBhbnkgZWxlbWVudAoJCS8vIHNvIHdlIG5lZWQgdG8gcmVzZXQgdGhlIHRhcmdldCBvbiB0aGUgbmV3IGV2ZW50CgkJZXZlbnQudGFyZ2V0ID0gdGhpcy5lbGVtZW50WyAwIF07CgoJCS8vIGNvcHkgb3JpZ2luYWwgZXZlbnQgcHJvcGVydGllcyBvdmVyIHRvIHRoZSBuZXcgZXZlbnQKCQlvcmlnID0gZXZlbnQub3JpZ2luYWxFdmVudDsKCQlpZiAoIG9yaWcgKSB7CgkJCWZvciAoIHByb3AgaW4gb3JpZyApIHsKCQkJCWlmICggISggcHJvcCBpbiBldmVudCApICkgewoJCQkJCWV2ZW50WyBwcm9wIF0gPSBvcmlnWyBwcm9wIF07CgkJCQl9CgkJCX0KCQl9CgoJCXRoaXMuZWxlbWVudC50cmlnZ2VyKCBldmVudCwgZGF0YSApOwoJCXJldHVybiAhKCAkLmlzRnVuY3Rpb24oIGNhbGxiYWNrICkgJiYKCQkJY2FsbGJhY2suYXBwbHkoIHRoaXMuZWxlbWVudFswXSwgWyBldmVudCBdLmNvbmNhdCggZGF0YSApICkgPT09IGZhbHNlIHx8CgkJCWV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICk7Cgl9Cn07CgokLmVhY2goIHsgc2hvdzogImZhZGVJbiIsIGhpZGU6ICJmYWRlT3V0IiB9LCBmdW5jdGlvbiggbWV0aG9kLCBkZWZhdWx0RWZmZWN0ICkgewoJJC5XaWRnZXQucHJvdG90eXBlWyAiXyIgKyBtZXRob2QgXSA9IGZ1bmN0aW9uKCBlbGVtZW50LCBvcHRpb25zLCBjYWxsYmFjayApIHsKCQlpZiAoIHR5cGVvZiBvcHRpb25zID09PSAic3RyaW5nIiApIHsKCQkJb3B0aW9ucyA9IHsgZWZmZWN0OiBvcHRpb25zIH07CgkJfQoJCXZhciBoYXNPcHRpb25zLAoJCQllZmZlY3ROYW1lID0gIW9wdGlvbnMgPwoJCQkJbWV0aG9kIDoKCQkJCW9wdGlvbnMgPT09IHRydWUgfHwgdHlwZW9mIG9wdGlvbnMgPT09ICJudW1iZXIiID8KCQkJCQlkZWZhdWx0RWZmZWN0IDoKCQkJCQlvcHRpb25zLmVmZmVjdCB8fCBkZWZhdWx0RWZmZWN0OwoJCW9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoJCWlmICggdHlwZW9mIG9wdGlvbnMgPT09ICJudW1iZXIiICkgewoJCQlvcHRpb25zID0geyBkdXJhdGlvbjogb3B0aW9ucyB9OwoJCX0KCQloYXNPcHRpb25zID0gISQuaXNFbXB0eU9iamVjdCggb3B0aW9ucyApOwoJCW9wdGlvbnMuY29tcGxldGUgPSBjYWxsYmFjazsKCQlpZiAoIG9wdGlvbnMuZGVsYXkgKSB7CgkJCWVsZW1lbnQuZGVsYXkoIG9wdGlvbnMuZGVsYXkgKTsKCQl9CgkJaWYgKCBoYXNPcHRpb25zICYmICQuZWZmZWN0cyAmJiAoICQuZWZmZWN0cy5lZmZlY3RbIGVmZmVjdE5hbWUgXSB8fCAkLnVpQmFja0NvbXBhdCAhPT0gZmFsc2UgJiYgJC5lZmZlY3RzWyBlZmZlY3ROYW1lIF0gKSApIHsKCQkJZWxlbWVudFsgbWV0aG9kIF0oIG9wdGlvbnMgKTsKCQl9IGVsc2UgaWYgKCBlZmZlY3ROYW1lICE9PSBtZXRob2QgJiYgZWxlbWVudFsgZWZmZWN0TmFtZSBdICkgewoJCQllbGVtZW50WyBlZmZlY3ROYW1lIF0oIG9wdGlvbnMuZHVyYXRpb24sIG9wdGlvbnMuZWFzaW5nLCBjYWxsYmFjayApOwoJCX0gZWxzZSB7CgkJCWVsZW1lbnQucXVldWUoZnVuY3Rpb24oIG5leHQgKSB7CgkJCQkkKCB0aGlzIClbIG1ldGhvZCBdKCk7CgkJCQlpZiAoIGNhbGxiYWNrICkgewoJCQkJCWNhbGxiYWNrLmNhbGwoIGVsZW1lbnRbIDAgXSApOwoJCQkJfQoJCQkJbmV4dCgpOwoJCQl9KTsKCQl9Cgl9Owp9KTsKCi8vIERFUFJFQ0FURUQKaWYgKCAkLnVpQmFja0NvbXBhdCAhPT0gZmFsc2UgKSB7CgkkLldpZGdldC5wcm90b3R5cGUuX2dldENyZWF0ZU9wdGlvbnMgPSBmdW5jdGlvbigpIHsKCQlyZXR1cm4gJC5tZXRhZGF0YSAmJiAkLm1ldGFkYXRhLmdldCggdGhpcy5lbGVtZW50WzBdIClbIHRoaXMud2lkZ2V0TmFtZSBdOwoJfTsKfQoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS53aWRnZXQiLCB7CgkvLyBkZWNvcmF0ZSB0aGUgcGFyZW50IF9jcmVhdGVXaWRnZXQgdG8gdHJpZ2dlciBgd2lkZ2V0aW5pdGAgZm9yIHVzZXJzCgkvLyB3aG8gd2lzaCB0byBkbyBwb3N0IHBvc3QgYHdpZGdldGNyZWF0ZWAgYWx0ZXJhdGlvbnMvYWRkaXRpb25zCgkvLwoJLy8gVE9ETyBjcmVhdGUgYSBwdWxsIHJlcXVlc3QgZm9yIGpxdWVyeSB1aSB0byB0cmlnZ2VyIHRoaXMgZXZlbnQKCS8vIGluIHRoZSBvcmlnaW5hbCBfY3JlYXRlV2lkZ2V0CglfY3JlYXRlV2lkZ2V0OiBmdW5jdGlvbigpIHsKCQkkLldpZGdldC5wcm90b3R5cGUuX2NyZWF0ZVdpZGdldC5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgkJdGhpcy5fdHJpZ2dlciggJ2luaXQnICk7Cgl9LAoKCV9nZXRDcmVhdGVPcHRpb25zOiBmdW5jdGlvbigpIHsKCgkJdmFyIGVsZW0gPSB0aGlzLmVsZW1lbnQsCgkJCW9wdGlvbnMgPSB7fTsKCgkJJC5lYWNoKCB0aGlzLm9wdGlvbnMsIGZ1bmN0aW9uKCBvcHRpb24gKSB7CgoJCQl2YXIgdmFsdWUgPSBlbGVtLmpxbURhdGEoIG9wdGlvbi5yZXBsYWNlKCAvW0EtWl0vZywgZnVuY3Rpb24oIGMgKSB7CgkJCQkJCQlyZXR1cm4gIi0iICsgYy50b0xvd2VyQ2FzZSgpOwoJCQkJCQl9KQoJCQkJCSk7CgoJCQlpZiAoIHZhbHVlICE9PSB1bmRlZmluZWQgKSB7CgkJCQlvcHRpb25zWyBvcHRpb24gXSA9IHZhbHVlOwoJCQl9CgkJfSk7CgoJCXJldHVybiBvcHRpb25zOwoJfSwKCgllbmhhbmNlV2l0aGluOiBmdW5jdGlvbiggdGFyZ2V0LCB1c2VLZWVwTmF0aXZlICkgewoJCXRoaXMuZW5oYW5jZSggJCggdGhpcy5vcHRpb25zLmluaXRTZWxlY3RvciwgJCggdGFyZ2V0ICkpLCB1c2VLZWVwTmF0aXZlICk7Cgl9LAoKCWVuaGFuY2U6IGZ1bmN0aW9uKCB0YXJnZXRzLCB1c2VLZWVwTmF0aXZlICkgewoJCXZhciBwYWdlLCBrZWVwTmF0aXZlLCAkd2lkZ2V0RWxlbWVudHMgPSAkKCB0YXJnZXRzICksIHNlbGYgPSB0aGlzOwoKCQkvLyBpZiBpZ25vcmVDb250ZW50RW5hYmxlZCBpcyBzZXQgdG8gdHJ1ZSB0aGUgZnJhbWV3b3JrIHNob3VsZAoJCS8vIG9ubHkgZW5oYW5jZSB0aGUgc2VsZWN0ZWQgZWxlbWVudHMgd2hlbiB0aGV5IGRvIE5PVCBoYXZlIGEKCQkvLyBwYXJlbnQgd2l0aCB0aGUgZGF0YS1uYW1lc3BhY2UtaWdub3JlIGF0dHJpYnV0ZQoJCSR3aWRnZXRFbGVtZW50cyA9ICQubW9iaWxlLmVuaGFuY2VhYmxlKCAkd2lkZ2V0RWxlbWVudHMgKTsKCgkJaWYgKCB1c2VLZWVwTmF0aXZlICYmICR3aWRnZXRFbGVtZW50cy5sZW5ndGggKSB7CgkJCS8vIFRPRE8gcmVtb3ZlIGRlcGVuZGVuY3kgb24gdGhlIHBhZ2Ugd2lkZ2V0IGZvciB0aGUga2VlcE5hdGl2ZS4KCQkJLy8gQ3VycmVudGx5IHRoZSBrZWVwTmF0aXZlIHZhbHVlIGlzIGRlZmluZWQgb24gdGhlIHBhZ2UgcHJvdG90eXBlIHNvCgkJCS8vIHRoZSBtZXRob2QgaXMgYXMgd2VsbAoJCQlwYWdlID0gJC5tb2JpbGUuY2xvc2VzdFBhZ2VEYXRhKCAkd2lkZ2V0RWxlbWVudHMgKTsKCQkJa2VlcE5hdGl2ZSA9ICggcGFnZSAmJiBwYWdlLmtlZXBOYXRpdmVTZWxlY3RvcigpKSB8fCAiIjsKCgkJCSR3aWRnZXRFbGVtZW50cyA9ICR3aWRnZXRFbGVtZW50cy5ub3QoIGtlZXBOYXRpdmUgKTsKCQl9CgoJCSR3aWRnZXRFbGVtZW50c1sgdGhpcy53aWRnZXROYW1lIF0oKTsKCX0sCgoJcmFpc2U6IGZ1bmN0aW9uKCBtc2cgKSB7CgkJdGhyb3cgIldpZGdldCBbIiArIHRoaXMud2lkZ2V0TmFtZSArICJdOiAiICsgbXNnOwoJfQp9KTsKCn0pKCBqUXVlcnkgKTsKCgooZnVuY3Rpb24oICQsIHdpbmRvdyApIHsKCS8vIERFUFJFQ0FURUQKCS8vIE5PVEUgZ2xvYmFsIG1vYmlsZSBvYmplY3Qgc2V0dGluZ3MKCSQuZXh0ZW5kKCAkLm1vYmlsZSwgewoJCS8vIERFUFJFQ0FURUQgU2hvdWxkIHRoZSB0ZXh0IGJlIHZpc2JsZSBpbiB0aGUgbG9hZGluZyBtZXNzYWdlPwoJCWxvYWRpbmdNZXNzYWdlVGV4dFZpc2libGU6IHVuZGVmaW5lZCwKCgkJLy8gREVQUkVDQVRFRCBXaGVuIHRoZSB0ZXh0IGlzIHZpc2libGUsIHdoYXQgdGhlbWUgZG9lcyB0aGUgbG9hZGluZyBib3ggdXNlPwoJCWxvYWRpbmdNZXNzYWdlVGhlbWU6IHVuZGVmaW5lZCwKCgkJLy8gREVQUkVDQVRFRCBkZWZhdWx0IG1lc3NhZ2Ugc2V0dGluZwoJCWxvYWRpbmdNZXNzYWdlOiB1bmRlZmluZWQsCgoJCS8vIERFUFJFQ0FURUQKCQkvLyBUdXJuIG9uL29mZiBwYWdlIGxvYWRpbmcgbWVzc2FnZS4gVGhlbWUgZG91YmxlcyBhcyBhbiBvYmplY3QgYXJndW1lbnQKCQkvLyB3aXRoIHRoZSBmb2xsb3dpbmcgc2hhcGU6IHsgdGhlbWU6ICcnLCB0ZXh0OiAnJywgaHRtbDogJycsIHRleHRWaXNpYmxlOiAnJyB9CgkJLy8gTk9URSB0aGF0IHRoZSAkLm1vYmlsZS5sb2FkaW5nKiBzZXR0aW5ncyBhbmQgcGFyYW1zIHBhc3QgdGhlIGZpcnN0IGFyZSBkZXByZWNhdGVkCgkJc2hvd1BhZ2VMb2FkaW5nTXNnOiBmdW5jdGlvbiggdGhlbWUsIG1zZ1RleHQsIHRleHRvbmx5ICkgewoJCQkkLm1vYmlsZS5sb2FkaW5nKCAnc2hvdycsIHRoZW1lLCBtc2dUZXh0LCB0ZXh0b25seSApOwoJCX0sCgoJCS8vIERFUFJFQ0FURUQKCQloaWRlUGFnZUxvYWRpbmdNc2c6IGZ1bmN0aW9uKCkgewoJCQkkLm1vYmlsZS5sb2FkaW5nKCAnaGlkZScgKTsKCQl9LAoKCQlsb2FkaW5nOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5sb2FkZXJXaWRnZXQubG9hZGVyLmFwcGx5KCB0aGlzLmxvYWRlcldpZGdldCwgYXJndW1lbnRzICk7CgkJfQoJfSk7CgoJLy8gVE9ETyBtb3ZlIGxvYWRlciBjbGFzcyBkb3duIGludG8gdGhlIHdpZGdldCBzZXR0aW5ncwoJdmFyIGxvYWRlckNsYXNzID0gInVpLWxvYWRlciIsICRodG1sID0gJCggImh0bWwiICksICR3aW5kb3cgPSAkKCB3aW5kb3cgKTsKCgkkLndpZGdldCggIm1vYmlsZS5sb2FkZXIiLCB7CgkJLy8gTk9URSBpZiB0aGUgZ2xvYmFsIGNvbmZpZyBzZXR0aW5ncyBhcmUgZGVmaW5lZCB0aGV5IHdpbGwgb3ZlcnJpZGUgdGhlc2UKCQkvLyAgICAgIG9wdGlvbnMKCQlvcHRpb25zOiB7CgkJCS8vIHRoZSB0aGVtZSBmb3IgdGhlIGxvYWRpbmcgbWVzc2FnZQoJCQl0aGVtZTogImEiLAoKCQkJLy8gd2hldGhlciB0aGUgdGV4dCBpbiB0aGUgbG9hZGluZyBtZXNzYWdlIGlzIHNob3duCgkJCXRleHRWaXNpYmxlOiBmYWxzZSwKCgkJCS8vIGN1c3RvbSBodG1sIGZvciB0aGUgaW5uZXIgY29udGVudCBvZiB0aGUgbG9hZGluZyBtZXNzYWdlCgkJCWh0bWw6ICIiLAoKCQkJLy8gdGhlIHRleHQgdG8gYmUgZGlzcGxheWVkIHdoZW4gdGhlIHBvcHVwIGlzIHNob3duCgkJCXRleHQ6ICJsb2FkaW5nIgoJCX0sCgoJCWRlZmF1bHRIdG1sOiAiPGRpdiBjbGFzcz0nIiArIGxvYWRlckNsYXNzICsgIic+IiArCgkJCSI8c3BhbiBjbGFzcz0ndWktaWNvbiB1aS1pY29uLWxvYWRpbmcnPjwvc3Bhbj4iICsKCQkJIjxoMT48L2gxPiIgKwoJCQkiPC9kaXY+IiwKCgkJLy8gRm9yIG5vbi1maXhlZCBzdXBwb3J0aW4gYnJvd3NlcnMuIFBvc2l0aW9uIGF0IHkgY2VudGVyIChpZiBzY3JvbGxUb3Agc3VwcG9ydGVkKSwgYWJvdmUgdGhlIGFjdGl2ZUJ0biAoaWYgZGVmaW5lZCksIG9yIGp1c3QgMTAwcHggZnJvbSB0b3AKCQlmYWtlRml4TG9hZGVyOiBmdW5jdGlvbigpIHsKCQkJdmFyIGFjdGl2ZUJ0biA9ICQoICIuIiArICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICkuZmlyc3QoKTsKCgkJCXRoaXMuZWxlbWVudAoJCQkJLmNzcyh7CgkJCQkJdG9wOiAkLnN1cHBvcnQuc2Nyb2xsVG9wICYmICR3aW5kb3cuc2Nyb2xsVG9wKCkgKyAkd2luZG93LmhlaWdodCgpIC8gMiB8fAoJCQkJCQlhY3RpdmVCdG4ubGVuZ3RoICYmIGFjdGl2ZUJ0bi5vZmZzZXQoKS50b3AgfHwgMTAwCgkJCQl9KTsKCQl9LAoKCQkvLyBjaGVjayBwb3NpdGlvbiBvZiBsb2FkZXIgdG8gc2VlIGlmIGl0IGFwcGVhcnMgdG8gYmUgImZpeGVkIiB0byBjZW50ZXIKCQkvLyBpZiBub3QsIHVzZSBhYnMgcG9zaXRpb25pbmcKCQljaGVja0xvYWRlclBvc2l0aW9uOiBmdW5jdGlvbigpIHsKCQkJdmFyIG9mZnNldCA9IHRoaXMuZWxlbWVudC5vZmZzZXQoKSwKCQkJCXNjcm9sbFRvcCA9ICR3aW5kb3cuc2Nyb2xsVG9wKCksCgkJCQlzY3JlZW5IZWlnaHQgPSAkLm1vYmlsZS5nZXRTY3JlZW5IZWlnaHQoKTsKCgkJCWlmICggb2Zmc2V0LnRvcCA8IHNjcm9sbFRvcCB8fCAoIG9mZnNldC50b3AgLSBzY3JvbGxUb3AgKSA+IHNjcmVlbkhlaWdodCApIHsKCQkJCXRoaXMuZWxlbWVudC5hZGRDbGFzcyggInVpLWxvYWRlci1mYWtlZml4IiApOwoJCQkJdGhpcy5mYWtlRml4TG9hZGVyKCk7CgkJCQkkd2luZG93CgkJCQkJLnVuYmluZCggInNjcm9sbCIsIHRoaXMuY2hlY2tMb2FkZXJQb3NpdGlvbiApCgkJCQkJLmJpbmQoICJzY3JvbGwiLCB0aGlzLmZha2VGaXhMb2FkZXIgKTsKCQkJfQoJCX0sCgoJCXJlc2V0SHRtbDogZnVuY3Rpb24oKSB7CgkJCXRoaXMuZWxlbWVudC5odG1sKCAkKCB0aGlzLmRlZmF1bHRIdG1sICkuaHRtbCgpICk7CgkJfSwKCgkJLy8gVHVybiBvbi9vZmYgcGFnZSBsb2FkaW5nIG1lc3NhZ2UuIFRoZW1lIGRvdWJsZXMgYXMgYW4gb2JqZWN0IGFyZ3VtZW50CgkJLy8gd2l0aCB0aGUgZm9sbG93aW5nIHNoYXBlOiB7IHRoZW1lOiAnJywgdGV4dDogJycsIGh0bWw6ICcnLCB0ZXh0VmlzaWJsZTogJycgfQoJCS8vIE5PVEUgdGhhdCB0aGUgJC5tb2JpbGUubG9hZGluZyogc2V0dGluZ3MgYW5kIHBhcmFtcyBwYXN0IHRoZSBmaXJzdCBhcmUgZGVwcmVjYXRlZAoJCS8vIFRPRE8gc3dlZXQgamVzdXMgd2UgbmVlZCB0byBicmVhayBzb21lIG9mIHRoaXMgb3V0CgkJc2hvdzogZnVuY3Rpb24oIHRoZW1lLCBtc2dUZXh0LCB0ZXh0b25seSApIHsKCQkJdmFyIHRleHRWaXNpYmxlLCBtZXNzYWdlLCAkaGVhZGVyLCBsb2FkU2V0dGluZ3M7CgoJCQl0aGlzLnJlc2V0SHRtbCgpOwoKCQkJLy8gdXNlIHRoZSBwcm90b3R5cGUgb3B0aW9ucyBzbyB0aGF0IHBlb3BsZSBjYW4gc2V0IHRoZW0gZ2xvYmFsbHkgYXQKCQkJLy8gbW9iaWxlIGluaXQuIENvbnNpc3RlbmN5LCBpdCdzIHdoYXQncyBmb3IgZGlubmVyCgkJCWlmICggJC50eXBlKHRoZW1lKSA9PT0gIm9iamVjdCIgKSB7CgkJCQlsb2FkU2V0dGluZ3MgPSAkLmV4dGVuZCgge30sIHRoaXMub3B0aW9ucywgdGhlbWUgKTsKCgkJCQkvLyBwcmVmZXIgb2JqZWN0IHByb3BlcnR5IGZyb20gdGhlIHBhcmFtIHRoZW4gdGhlIG9sZCB0aGVtZSBzZXR0aW5nCgkJCQl0aGVtZSA9IGxvYWRTZXR0aW5ncy50aGVtZSB8fCAkLm1vYmlsZS5sb2FkaW5nTWVzc2FnZVRoZW1lOwoJCQl9IGVsc2UgewoJCQkJbG9hZFNldHRpbmdzID0gdGhpcy5vcHRpb25zOwoKCQkJCS8vIGhlcmUgd2UgcHJlZmVyIHRoZSB0aGVtIHZhbHVlIHBhc3NlZCBhcyBhIHN0cmluZyBhcmd1bWVudCwgdGhlbgoJCQkJLy8gd2UgcHJlZmVyIHRoZSBnbG9iYWwgb3B0aW9uIGJlY2F1c2Ugd2UgY2FuJ3QgdXNlIHVuZGVmaW5lZCBkZWZhdWx0CgkJCQkvLyBwcm90b3R5cGUgb3B0aW9ucywgdGhlbiB0aGUgcHJvdG90eXBlIG9wdGlvbgoJCQkJdGhlbWUgPSB0aGVtZSB8fCAkLm1vYmlsZS5sb2FkaW5nTWVzc2FnZVRoZW1lIHx8IGxvYWRTZXR0aW5ncy50aGVtZTsKCQkJfQoKCQkJLy8gc2V0IHRoZSBtZXNzYWdlIHRleHQsIHByZWZlciB0aGUgcGFyYW0sIHRoZW4gdGhlIHNldHRpbmdzIG9iamVjdAoJCQkvLyB0aGVuIGxvYWRpbmcgbWVzc2FnZQoJCQltZXNzYWdlID0gbXNnVGV4dCB8fCAkLm1vYmlsZS5sb2FkaW5nTWVzc2FnZSB8fCBsb2FkU2V0dGluZ3MudGV4dDsKCgkJCS8vIHByZXBhcmUgdGhlIGRvbQoJCQkkaHRtbC5hZGRDbGFzcyggInVpLWxvYWRpbmciICk7CgoJCQlpZiAoICQubW9iaWxlLmxvYWRpbmdNZXNzYWdlICE9PSBmYWxzZSB8fCBsb2FkU2V0dGluZ3MuaHRtbCApIHsKCQkJCS8vIGJvb2xlYW4gdmFsdWVzIHJlcXVpcmUgYSBiaXQgbW9yZSB3b3JrIDpQLCBzdXBwb3J0cyBvYmplY3QgcHJvcGVydGllcwoJCQkJLy8gYW5kIG9sZCBzZXR0aW5ncwoJCQkJaWYgKCAkLm1vYmlsZS5sb2FkaW5nTWVzc2FnZVRleHRWaXNpYmxlICE9PSB1bmRlZmluZWQgKSB7CgkJCQkJdGV4dFZpc2libGUgPSAkLm1vYmlsZS5sb2FkaW5nTWVzc2FnZVRleHRWaXNpYmxlOwoJCQkJfSBlbHNlIHsKCQkJCQl0ZXh0VmlzaWJsZSA9IGxvYWRTZXR0aW5ncy50ZXh0VmlzaWJsZTsKCQkJCX0KCgkJCQkvLyBhZGQgdGhlIHByb3BlciBjc3MgZ2l2ZW4gdGhlIG9wdGlvbnMgKHRoZW1lLCB0ZXh0LCBldGMpCgkJCQkvLyBGb3JjZSB0ZXh0IHZpc2liaWxpdHkgaWYgdGhlIHNlY29uZCBhcmd1bWVudCB3YXMgc3VwcGxpZWQsIG9yCgkJCQkvLyBpZiB0aGUgdGV4dCB3YXMgZXhwbGljaXRseSBzZXQgaW4gdGhlIG9iamVjdCBhcmdzCgkJCQl0aGlzLmVsZW1lbnQuYXR0cigiY2xhc3MiLCBsb2FkZXJDbGFzcyArCgkJCQkJIiB1aS1jb3JuZXItYWxsIHVpLWJvZHktIiArIHRoZW1lICsKCQkJCQkiIHVpLWxvYWRlci0iICsgKCB0ZXh0VmlzaWJsZSB8fCBtc2dUZXh0IHx8IHRoZW1lLnRleHQgPyAidmVyYm9zZSIgOiAiZGVmYXVsdCIgKSArCgkJCQkJKCBsb2FkU2V0dGluZ3MudGV4dG9ubHkgfHwgdGV4dG9ubHkgPyAiIHVpLWxvYWRlci10ZXh0b25seSIgOiAiIiApICk7CgoJCQkJLy8gVE9ETyB2ZXJpZnkgdGhhdCBqcXVlcnkuZm4uaHRtbCBpcyBvayB0byB1c2UgaW4gYm90aCBjYXNlcyBoZXJlCgkJCQkvLyAgICAgIHRoaXMgbWlnaHQgYmUgb3Zlcmx5IGRlZmVuc2l2ZSBpbiBwcmV2ZW50aW5nIHVua25vd2luZyB4c3MKCQkJCS8vIGlmIHRoZSBodG1sIGF0dHJpYnV0ZSBpcyBkZWZpbmVkIG9uIHRoZSBsb2FkaW5nIHNldHRpbmdzLCB1c2UgdGhhdAoJCQkJLy8gb3RoZXJ3aXNlIHVzZSB0aGUgZmFsbGJhY2tzIGZyb20gYWJvdmUKCQkJCWlmICggbG9hZFNldHRpbmdzLmh0bWwgKSB7CgkJCQkJdGhpcy5lbGVtZW50Lmh0bWwoIGxvYWRTZXR0aW5ncy5odG1sICk7CgkJCQl9IGVsc2UgewoJCQkJCXRoaXMuZWxlbWVudC5maW5kKCAiaDEiICkudGV4dCggbWVzc2FnZSApOwoJCQkJfQoKCQkJCS8vIGF0dGFjaCB0aGUgbG9hZGVyIHRvIHRoZSBET00KCQkJCXRoaXMuZWxlbWVudC5hcHBlbmRUbyggJC5tb2JpbGUucGFnZUNvbnRhaW5lciApOwoKCQkJCS8vIGNoZWNrIHRoYXQgdGhlIGxvYWRlciBpcyB2aXNpYmxlCgkJCQl0aGlzLmNoZWNrTG9hZGVyUG9zaXRpb24oKTsKCgkJCQkvLyBvbiBzY3JvbGwgY2hlY2sgdGhlIGxvYWRlciBwb3NpdGlvbgoJCQkJJHdpbmRvdy5iaW5kKCAic2Nyb2xsIiwgJC5wcm94eSggdGhpcy5jaGVja0xvYWRlclBvc2l0aW9uLCB0aGlzICkgKTsKCQkJfQoJCX0sCgoJCWhpZGU6IGZ1bmN0aW9uKCkgewoJCQkkaHRtbC5yZW1vdmVDbGFzcyggInVpLWxvYWRpbmciICk7CgoJCQlpZiAoICQubW9iaWxlLmxvYWRpbmdNZXNzYWdlICkgewoJCQkJdGhpcy5lbGVtZW50LnJlbW92ZUNsYXNzKCAidWktbG9hZGVyLWZha2VmaXgiICk7CgkJCX0KCgkJCSQoIHdpbmRvdyApLnVuYmluZCggInNjcm9sbCIsICQucHJveHkoIHRoaXMuZmFrZUZpeExvYWRlciwgdGhpcykgKTsKCQkJJCggd2luZG93ICkudW5iaW5kKCAic2Nyb2xsIiwgJC5wcm94eSggdGhpcy5jaGVja0xvYWRlclBvc2l0aW9uLCB0aGlzICkgKTsKCQl9Cgl9KTsKCgkkd2luZG93LmJpbmQoICdwYWdlY29udGFpbmVyY3JlYXRlJywgZnVuY3Rpb24oKSB7CgkJJC5tb2JpbGUubG9hZGVyV2lkZ2V0ID0gJC5tb2JpbGUubG9hZGVyV2lkZ2V0IHx8ICQoICQubW9iaWxlLmxvYWRlci5wcm90b3R5cGUuZGVmYXVsdEh0bWwgKS5sb2FkZXIoKTsKCX0pOwp9KShqUXVlcnksIHRoaXMpOwoKCgovLyBUaGlzIHBsdWdpbiBpcyBhbiBleHBlcmltZW50IGZvciBhYnN0cmFjdGluZyBhd2F5IHRoZSB0b3VjaCBhbmQgbW91c2UKLy8gZXZlbnRzIHNvIHRoYXQgZGV2ZWxvcGVycyBkb24ndCBoYXZlIHRvIHdvcnJ5IGFib3V0IHdoaWNoIG1ldGhvZCBvZiBpbnB1dAovLyB0aGUgZGV2aWNlIHRoZWlyIGRvY3VtZW50IGlzIGxvYWRlZCBvbiBzdXBwb3J0cy4KLy8KLy8gVGhlIGlkZWEgaGVyZSBpcyB0byBhbGxvdyB0aGUgZGV2ZWxvcGVyIHRvIHJlZ2lzdGVyIGxpc3RlbmVycyBmb3IgdGhlCi8vIGJhc2ljIG1vdXNlIGV2ZW50cywgc3VjaCBhcyBtb3VzZWRvd24sIG1vdXNlbW92ZSwgbW91c2V1cCwgYW5kIGNsaWNrLAovLyBhbmQgdGhlIHBsdWdpbiB3aWxsIHRha2UgY2FyZSBvZiByZWdpc3RlcmluZyB0aGUgY29ycmVjdCBsaXN0ZW5lcnMKLy8gYmVoaW5kIHRoZSBzY2VuZXMgdG8gaW52b2tlIHRoZSBsaXN0ZW5lciBhdCB0aGUgZmFzdGVzdCBwb3NzaWJsZSB0aW1lCi8vIGZvciB0aGF0IGRldmljZSwgd2hpbGUgc3RpbGwgcmV0YWluaW5nIHRoZSBvcmRlciBvZiBldmVudCBmaXJpbmcgaW4KLy8gdGhlIHRyYWRpdGlvbmFsIG1vdXNlIGVudmlyb25tZW50LCBzaG91bGQgbXVsdGlwbGUgaGFuZGxlcnMgYmUgcmVnaXN0ZXJlZAovLyBvbiB0aGUgc2FtZSBlbGVtZW50IGZvciBkaWZmZXJlbnQgZXZlbnRzLgovLwovLyBUaGUgY3VycmVudCB2ZXJzaW9uIGV4cG9zZXMgdGhlIGZvbGxvd2luZyB2aXJ0dWFsIGV2ZW50cyB0byBqUXVlcnkgYmluZCBtZXRob2RzOgovLyAidm1vdXNlb3ZlciB2bW91c2Vkb3duIHZtb3VzZW1vdmUgdm1vdXNldXAgdmNsaWNrIHZtb3VzZW91dCB2bW91c2VjYW5jZWwiCgooZnVuY3Rpb24oICQsIHdpbmRvdywgZG9jdW1lbnQsIHVuZGVmaW5lZCApIHsKCnZhciBkYXRhUHJvcGVydHlOYW1lID0gInZpcnR1YWxNb3VzZUJpbmRpbmdzIiwKCXRvdWNoVGFyZ2V0UHJvcGVydHlOYW1lID0gInZpcnR1YWxUb3VjaElEIiwKCXZpcnR1YWxFdmVudE5hbWVzID0gInZtb3VzZW92ZXIgdm1vdXNlZG93biB2bW91c2Vtb3ZlIHZtb3VzZXVwIHZjbGljayB2bW91c2VvdXQgdm1vdXNlY2FuY2VsIi5zcGxpdCggIiAiICksCgl0b3VjaEV2ZW50UHJvcHMgPSAiY2xpZW50WCBjbGllbnRZIHBhZ2VYIHBhZ2VZIHNjcmVlblggc2NyZWVuWSIuc3BsaXQoICIgIiApLAoJbW91c2VIb29rUHJvcHMgPSAkLmV2ZW50Lm1vdXNlSG9va3MgPyAkLmV2ZW50Lm1vdXNlSG9va3MucHJvcHMgOiBbXSwKCW1vdXNlRXZlbnRQcm9wcyA9ICQuZXZlbnQucHJvcHMuY29uY2F0KCBtb3VzZUhvb2tQcm9wcyApLAoJYWN0aXZlRG9jSGFuZGxlcnMgPSB7fSwKCXJlc2V0VGltZXJJRCA9IDAsCglzdGFydFggPSAwLAoJc3RhcnRZID0gMCwKCWRpZFNjcm9sbCA9IGZhbHNlLAoJY2xpY2tCbG9ja0xpc3QgPSBbXSwKCWJsb2NrTW91c2VUcmlnZ2VycyA9IGZhbHNlLAoJYmxvY2tUb3VjaFRyaWdnZXJzID0gZmFsc2UsCglldmVudENhcHR1cmVTdXBwb3J0ZWQgPSAiYWRkRXZlbnRMaXN0ZW5lciIgaW4gZG9jdW1lbnQsCgkkZG9jdW1lbnQgPSAkKCBkb2N1bWVudCApLAoJbmV4dFRvdWNoSUQgPSAxLAoJbGFzdFRvdWNoSUQgPSAwLCB0aHJlc2hvbGQ7CgokLnZtb3VzZSA9IHsKCW1vdmVEaXN0YW5jZVRocmVzaG9sZDogMTAsCgljbGlja0Rpc3RhbmNlVGhyZXNob2xkOiAxMCwKCXJlc2V0VGltZXJEdXJhdGlvbjogMTUwMAp9OwoKZnVuY3Rpb24gZ2V0TmF0aXZlRXZlbnQoIGV2ZW50ICkgewoKCXdoaWxlICggZXZlbnQgJiYgdHlwZW9mIGV2ZW50Lm9yaWdpbmFsRXZlbnQgIT09ICJ1bmRlZmluZWQiICkgewoJCWV2ZW50ID0gZXZlbnQub3JpZ2luYWxFdmVudDsKCX0KCXJldHVybiBldmVudDsKfQoKZnVuY3Rpb24gY3JlYXRlVmlydHVhbEV2ZW50KCBldmVudCwgZXZlbnRUeXBlICkgewoKCXZhciB0ID0gZXZlbnQudHlwZSwKCQlvZSwgcHJvcHMsIG5lLCBwcm9wLCBjdCwgdG91Y2gsIGksIGosIGxlbjsKCglldmVudCA9ICQuRXZlbnQoIGV2ZW50ICk7CglldmVudC50eXBlID0gZXZlbnRUeXBlOwoKCW9lID0gZXZlbnQub3JpZ2luYWxFdmVudDsKCXByb3BzID0gJC5ldmVudC5wcm9wczsKCgkvLyBhZGRyZXNzZXMgc2VwYXJhdGlvbiBvZiAkLmV2ZW50LnByb3BzIGluIHRvICQuZXZlbnQubW91c2VIb29rLnByb3BzIGFuZCBJc3N1ZSAzMjgwCgkvLyBodHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L2pxdWVyeS1tb2JpbGUvaXNzdWVzLzMyODAKCWlmICggdC5zZWFyY2goIC9eKG1vdXNlfGNsaWNrKS8gKSA+IC0xICkgewoJCXByb3BzID0gbW91c2VFdmVudFByb3BzOwoJfQoKCS8vIGNvcHkgb3JpZ2luYWwgZXZlbnQgcHJvcGVydGllcyBvdmVyIHRvIHRoZSBuZXcgZXZlbnQKCS8vIHRoaXMgd291bGQgaGFwcGVuIGlmIHdlIGNvdWxkIGNhbGwgJC5ldmVudC5maXggaW5zdGVhZCBvZiAkLkV2ZW50CgkvLyBidXQgd2UgZG9uJ3QgaGF2ZSBhIHdheSB0byBmb3JjZSBhbiBldmVudCB0byBiZSBmaXhlZCBtdWx0aXBsZSB0aW1lcwoJaWYgKCBvZSApIHsKCQlmb3IgKCBpID0gcHJvcHMubGVuZ3RoLCBwcm9wOyBpOyApIHsKCQkJcHJvcCA9IHByb3BzWyAtLWkgXTsKCQkJZXZlbnRbIHByb3AgXSA9IG9lWyBwcm9wIF07CgkJfQoJfQoKCS8vIG1ha2Ugc3VyZSB0aGF0IGlmIHRoZSBtb3VzZSBhbmQgY2xpY2sgdmlydHVhbCBldmVudHMgYXJlIGdlbmVyYXRlZAoJLy8gd2l0aG91dCBhIC53aGljaCBvbmUgaXMgZGVmaW5lZAoJaWYgKCB0LnNlYXJjaCgvbW91c2UoZG93bnx1cCl8Y2xpY2svKSA+IC0xICYmICFldmVudC53aGljaCApIHsKCQlldmVudC53aGljaCA9IDE7Cgl9CgoJaWYgKCB0LnNlYXJjaCgvXnRvdWNoLykgIT09IC0xICkgewoJCW5lID0gZ2V0TmF0aXZlRXZlbnQoIG9lICk7CgkJdCA9IG5lLnRvdWNoZXM7CgkJY3QgPSBuZS5jaGFuZ2VkVG91Y2hlczsKCQl0b3VjaCA9ICggdCAmJiB0Lmxlbmd0aCApID8gdFswXSA6ICggKCBjdCAmJiBjdC5sZW5ndGggKSA/IGN0WyAwIF0gOiB1bmRlZmluZWQgKTsKCgkJaWYgKCB0b3VjaCApIHsKCQkJZm9yICggaiA9IDAsIGxlbiA9IHRvdWNoRXZlbnRQcm9wcy5sZW5ndGg7IGogPCBsZW47IGorKykgewoJCQkJcHJvcCA9IHRvdWNoRXZlbnRQcm9wc1sgaiBdOwoJCQkJZXZlbnRbIHByb3AgXSA9IHRvdWNoWyBwcm9wIF07CgkJCX0KCQl9Cgl9CgoJcmV0dXJuIGV2ZW50Owp9CgpmdW5jdGlvbiBnZXRWaXJ0dWFsQmluZGluZ0ZsYWdzKCBlbGVtZW50ICkgewoKCXZhciBmbGFncyA9IHt9LAoJCWIsIGs7CgoJd2hpbGUgKCBlbGVtZW50ICkgewoKCQliID0gJC5kYXRhKCBlbGVtZW50LCBkYXRhUHJvcGVydHlOYW1lICk7CgoJCWZvciAoICBrIGluIGIgKSB7CgkJCWlmICggYlsgayBdICkgewoJCQkJZmxhZ3NbIGsgXSA9IGZsYWdzLmhhc1ZpcnR1YWxCaW5kaW5nID0gdHJ1ZTsKCQkJfQoJCX0KCQllbGVtZW50ID0gZWxlbWVudC5wYXJlbnROb2RlOwoJfQoJcmV0dXJuIGZsYWdzOwp9CgpmdW5jdGlvbiBnZXRDbG9zZXN0RWxlbWVudFdpdGhWaXJ0dWFsQmluZGluZyggZWxlbWVudCwgZXZlbnRUeXBlICkgewoJdmFyIGI7Cgl3aGlsZSAoIGVsZW1lbnQgKSB7CgoJCWIgPSAkLmRhdGEoIGVsZW1lbnQsIGRhdGFQcm9wZXJ0eU5hbWUgKTsKCgkJaWYgKCBiICYmICggIWV2ZW50VHlwZSB8fCBiWyBldmVudFR5cGUgXSApICkgewoJCQlyZXR1cm4gZWxlbWVudDsKCQl9CgkJZWxlbWVudCA9IGVsZW1lbnQucGFyZW50Tm9kZTsKCX0KCXJldHVybiBudWxsOwp9CgpmdW5jdGlvbiBlbmFibGVUb3VjaEJpbmRpbmdzKCkgewoJYmxvY2tUb3VjaFRyaWdnZXJzID0gZmFsc2U7Cn0KCmZ1bmN0aW9uIGRpc2FibGVUb3VjaEJpbmRpbmdzKCkgewoJYmxvY2tUb3VjaFRyaWdnZXJzID0gdHJ1ZTsKfQoKZnVuY3Rpb24gZW5hYmxlTW91c2VCaW5kaW5ncygpIHsKCWxhc3RUb3VjaElEID0gMDsKCWNsaWNrQmxvY2tMaXN0Lmxlbmd0aCA9IDA7CglibG9ja01vdXNlVHJpZ2dlcnMgPSBmYWxzZTsKCgkvLyBXaGVuIG1vdXNlIGJpbmRpbmdzIGFyZSBlbmFibGVkLCBvdXIKCS8vIHRvdWNoIGJpbmRpbmdzIGFyZSBkaXNhYmxlZC4KCWRpc2FibGVUb3VjaEJpbmRpbmdzKCk7Cn0KCmZ1bmN0aW9uIGRpc2FibGVNb3VzZUJpbmRpbmdzKCkgewoJLy8gV2hlbiBtb3VzZSBiaW5kaW5ncyBhcmUgZGlzYWJsZWQsIG91cgoJLy8gdG91Y2ggYmluZGluZ3MgYXJlIGVuYWJsZWQuCgllbmFibGVUb3VjaEJpbmRpbmdzKCk7Cn0KCmZ1bmN0aW9uIHN0YXJ0UmVzZXRUaW1lcigpIHsKCWNsZWFyUmVzZXRUaW1lcigpOwoJcmVzZXRUaW1lcklEID0gc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJcmVzZXRUaW1lcklEID0gMDsKCQllbmFibGVNb3VzZUJpbmRpbmdzKCk7Cgl9LCAkLnZtb3VzZS5yZXNldFRpbWVyRHVyYXRpb24gKTsKfQoKZnVuY3Rpb24gY2xlYXJSZXNldFRpbWVyKCkgewoJaWYgKCByZXNldFRpbWVySUQgKSB7CgkJY2xlYXJUaW1lb3V0KCByZXNldFRpbWVySUQgKTsKCQlyZXNldFRpbWVySUQgPSAwOwoJfQp9CgpmdW5jdGlvbiB0cmlnZ2VyVmlydHVhbEV2ZW50KCBldmVudFR5cGUsIGV2ZW50LCBmbGFncyApIHsKCXZhciB2ZTsKCglpZiAoICggZmxhZ3MgJiYgZmxhZ3NbIGV2ZW50VHlwZSBdICkgfHwKCQkJCSggIWZsYWdzICYmIGdldENsb3Nlc3RFbGVtZW50V2l0aFZpcnR1YWxCaW5kaW5nKCBldmVudC50YXJnZXQsIGV2ZW50VHlwZSApICkgKSB7CgoJCXZlID0gY3JlYXRlVmlydHVhbEV2ZW50KCBldmVudCwgZXZlbnRUeXBlICk7CgoJCSQoIGV2ZW50LnRhcmdldCkudHJpZ2dlciggdmUgKTsKCX0KCglyZXR1cm4gdmU7Cn0KCmZ1bmN0aW9uIG1vdXNlRXZlbnRDYWxsYmFjayggZXZlbnQgKSB7Cgl2YXIgdG91Y2hJRCA9ICQuZGF0YSggZXZlbnQudGFyZ2V0LCB0b3VjaFRhcmdldFByb3BlcnR5TmFtZSApOwoKCWlmICggIWJsb2NrTW91c2VUcmlnZ2VycyAmJiAoICFsYXN0VG91Y2hJRCB8fCBsYXN0VG91Y2hJRCAhPT0gdG91Y2hJRCApICkgewoJCXZhciB2ZSA9IHRyaWdnZXJWaXJ0dWFsRXZlbnQoICJ2IiArIGV2ZW50LnR5cGUsIGV2ZW50ICk7CgkJaWYgKCB2ZSApIHsKCQkJaWYgKCB2ZS5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCX0KCQkJaWYgKCB2ZS5pc1Byb3BhZ2F0aW9uU3RvcHBlZCgpICkgewoJCQkJZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7CgkJCX0KCQkJaWYgKCB2ZS5pc0ltbWVkaWF0ZVByb3BhZ2F0aW9uU3RvcHBlZCgpICkgewoJCQkJZXZlbnQuc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uKCk7CgkJCX0KCQl9Cgl9Cn0KCmZ1bmN0aW9uIGhhbmRsZVRvdWNoU3RhcnQoIGV2ZW50ICkgewoKCXZhciB0b3VjaGVzID0gZ2V0TmF0aXZlRXZlbnQoIGV2ZW50ICkudG91Y2hlcywKCQl0YXJnZXQsIGZsYWdzOwoKCWlmICggdG91Y2hlcyAmJiB0b3VjaGVzLmxlbmd0aCA9PT0gMSApIHsKCgkJdGFyZ2V0ID0gZXZlbnQudGFyZ2V0OwoJCWZsYWdzID0gZ2V0VmlydHVhbEJpbmRpbmdGbGFncyggdGFyZ2V0ICk7CgoJCWlmICggZmxhZ3MuaGFzVmlydHVhbEJpbmRpbmcgKSB7CgoJCQlsYXN0VG91Y2hJRCA9IG5leHRUb3VjaElEKys7CgkJCSQuZGF0YSggdGFyZ2V0LCB0b3VjaFRhcmdldFByb3BlcnR5TmFtZSwgbGFzdFRvdWNoSUQgKTsKCgkJCWNsZWFyUmVzZXRUaW1lcigpOwoKCQkJZGlzYWJsZU1vdXNlQmluZGluZ3MoKTsKCQkJZGlkU2Nyb2xsID0gZmFsc2U7CgoJCQl2YXIgdCA9IGdldE5hdGl2ZUV2ZW50KCBldmVudCApLnRvdWNoZXNbIDAgXTsKCQkJc3RhcnRYID0gdC5wYWdlWDsKCQkJc3RhcnRZID0gdC5wYWdlWTsKCgkJCXRyaWdnZXJWaXJ0dWFsRXZlbnQoICJ2bW91c2VvdmVyIiwgZXZlbnQsIGZsYWdzICk7CgkJCXRyaWdnZXJWaXJ0dWFsRXZlbnQoICJ2bW91c2Vkb3duIiwgZXZlbnQsIGZsYWdzICk7CgkJfQoJfQp9CgpmdW5jdGlvbiBoYW5kbGVTY3JvbGwoIGV2ZW50ICkgewoJaWYgKCBibG9ja1RvdWNoVHJpZ2dlcnMgKSB7CgkJcmV0dXJuOwoJfQoKCWlmICggIWRpZFNjcm9sbCApIHsKCQl0cmlnZ2VyVmlydHVhbEV2ZW50KCAidm1vdXNlY2FuY2VsIiwgZXZlbnQsIGdldFZpcnR1YWxCaW5kaW5nRmxhZ3MoIGV2ZW50LnRhcmdldCApICk7Cgl9CgoJZGlkU2Nyb2xsID0gdHJ1ZTsKCXN0YXJ0UmVzZXRUaW1lcigpOwp9CgpmdW5jdGlvbiBoYW5kbGVUb3VjaE1vdmUoIGV2ZW50ICkgewoJaWYgKCBibG9ja1RvdWNoVHJpZ2dlcnMgKSB7CgkJcmV0dXJuOwoJfQoKCXZhciB0ID0gZ2V0TmF0aXZlRXZlbnQoIGV2ZW50ICkudG91Y2hlc1sgMCBdLAoJCWRpZENhbmNlbCA9IGRpZFNjcm9sbCwKCQltb3ZlVGhyZXNob2xkID0gJC52bW91c2UubW92ZURpc3RhbmNlVGhyZXNob2xkLAoJCWZsYWdzID0gZ2V0VmlydHVhbEJpbmRpbmdGbGFncyggZXZlbnQudGFyZ2V0ICk7CgoJCWRpZFNjcm9sbCA9IGRpZFNjcm9sbCB8fAoJCQkoIE1hdGguYWJzKCB0LnBhZ2VYIC0gc3RhcnRYICkgPiBtb3ZlVGhyZXNob2xkIHx8CgkJCQlNYXRoLmFicyggdC5wYWdlWSAtIHN0YXJ0WSApID4gbW92ZVRocmVzaG9sZCApOwoKCglpZiAoIGRpZFNjcm9sbCAmJiAhZGlkQ2FuY2VsICkgewoJCXRyaWdnZXJWaXJ0dWFsRXZlbnQoICJ2bW91c2VjYW5jZWwiLCBldmVudCwgZmxhZ3MgKTsKCX0KCgl0cmlnZ2VyVmlydHVhbEV2ZW50KCAidm1vdXNlbW92ZSIsIGV2ZW50LCBmbGFncyApOwoJc3RhcnRSZXNldFRpbWVyKCk7Cn0KCmZ1bmN0aW9uIGhhbmRsZVRvdWNoRW5kKCBldmVudCApIHsKCWlmICggYmxvY2tUb3VjaFRyaWdnZXJzICkgewoJCXJldHVybjsKCX0KCglkaXNhYmxlVG91Y2hCaW5kaW5ncygpOwoKCXZhciBmbGFncyA9IGdldFZpcnR1YWxCaW5kaW5nRmxhZ3MoIGV2ZW50LnRhcmdldCApLAoJCXQ7Cgl0cmlnZ2VyVmlydHVhbEV2ZW50KCAidm1vdXNldXAiLCBldmVudCwgZmxhZ3MgKTsKCglpZiAoICFkaWRTY3JvbGwgKSB7CgkJdmFyIHZlID0gdHJpZ2dlclZpcnR1YWxFdmVudCggInZjbGljayIsIGV2ZW50LCBmbGFncyApOwoJCWlmICggdmUgJiYgdmUuaXNEZWZhdWx0UHJldmVudGVkKCkgKSB7CgkJCS8vIFRoZSB0YXJnZXQgb2YgdGhlIG1vdXNlIGV2ZW50cyB0aGF0IGZvbGxvdyB0aGUgdG91Y2hlbmQKCQkJLy8gZXZlbnQgZG9uJ3QgbmVjZXNzYXJpbHkgbWF0Y2ggdGhlIHRhcmdldCB1c2VkIGR1cmluZyB0aGUKCQkJLy8gdG91Y2guIFRoaXMgbWVhbnMgd2UgbmVlZCB0byByZWx5IG9uIGNvb3JkaW5hdGVzIGZvciBibG9ja2luZwoJCQkvLyBhbnkgY2xpY2sgdGhhdCBpcyBnZW5lcmF0ZWQuCgkJCXQgPSBnZXROYXRpdmVFdmVudCggZXZlbnQgKS5jaGFuZ2VkVG91Y2hlc1sgMCBdOwoJCQljbGlja0Jsb2NrTGlzdC5wdXNoKHsKCQkJCXRvdWNoSUQ6IGxhc3RUb3VjaElELAoJCQkJeDogdC5jbGllbnRYLAoJCQkJeTogdC5jbGllbnRZCgkJCX0pOwoKCQkJLy8gUHJldmVudCBhbnkgbW91c2UgZXZlbnRzIHRoYXQgZm9sbG93IGZyb20gdHJpZ2dlcmluZwoJCQkvLyB2aXJ0dWFsIGV2ZW50IG5vdGlmaWNhdGlvbnMuCgkJCWJsb2NrTW91c2VUcmlnZ2VycyA9IHRydWU7CgkJfQoJfQoJdHJpZ2dlclZpcnR1YWxFdmVudCggInZtb3VzZW91dCIsIGV2ZW50LCBmbGFncyk7CglkaWRTY3JvbGwgPSBmYWxzZTsKCglzdGFydFJlc2V0VGltZXIoKTsKfQoKZnVuY3Rpb24gaGFzVmlydHVhbEJpbmRpbmdzKCBlbGUgKSB7Cgl2YXIgYmluZGluZ3MgPSAkLmRhdGEoIGVsZSwgZGF0YVByb3BlcnR5TmFtZSApLAoJCWs7CgoJaWYgKCBiaW5kaW5ncyApIHsKCQlmb3IgKCBrIGluIGJpbmRpbmdzICkgewoJCQlpZiAoIGJpbmRpbmdzWyBrIF0gKSB7CgkJCQlyZXR1cm4gdHJ1ZTsKCQkJfQoJCX0KCX0KCXJldHVybiBmYWxzZTsKfQoKZnVuY3Rpb24gZHVtbXlNb3VzZUhhbmRsZXIoKSB7fQoKZnVuY3Rpb24gZ2V0U3BlY2lhbEV2ZW50T2JqZWN0KCBldmVudFR5cGUgKSB7Cgl2YXIgcmVhbFR5cGUgPSBldmVudFR5cGUuc3Vic3RyKCAxICk7CgoJcmV0dXJuIHsKCQlzZXR1cDogZnVuY3Rpb24oIGRhdGEsIG5hbWVzcGFjZSApIHsKCQkJLy8gSWYgdGhpcyBpcyB0aGUgZmlyc3QgdmlydHVhbCBtb3VzZSBiaW5kaW5nIGZvciB0aGlzIGVsZW1lbnQsCgkJCS8vIGFkZCBhIGJpbmRpbmdzIG9iamVjdCB0byBpdHMgZGF0YS4KCgkJCWlmICggIWhhc1ZpcnR1YWxCaW5kaW5ncyggdGhpcyApICkgewoJCQkJJC5kYXRhKCB0aGlzLCBkYXRhUHJvcGVydHlOYW1lLCB7fSApOwoJCQl9CgoJCQkvLyBJZiBzZXR1cCBpcyBjYWxsZWQsIHdlIGtub3cgaXQgaXMgdGhlIGZpcnN0IGJpbmRpbmcgZm9yIHRoaXMKCQkJLy8gZXZlbnRUeXBlLCBzbyBpbml0aWFsaXplIHRoZSBjb3VudCBmb3IgdGhlIGV2ZW50VHlwZSB0byB6ZXJvLgoJCQl2YXIgYmluZGluZ3MgPSAkLmRhdGEoIHRoaXMsIGRhdGFQcm9wZXJ0eU5hbWUgKTsKCQkJYmluZGluZ3NbIGV2ZW50VHlwZSBdID0gdHJ1ZTsKCgkJCS8vIElmIHRoaXMgaXMgdGhlIGZpcnN0IHZpcnR1YWwgbW91c2UgZXZlbnQgZm9yIHRoaXMgdHlwZSwKCQkJLy8gcmVnaXN0ZXIgYSBnbG9iYWwgaGFuZGxlciBvbiB0aGUgZG9jdW1lbnQuCgoJCQlhY3RpdmVEb2NIYW5kbGVyc1sgZXZlbnRUeXBlIF0gPSAoIGFjdGl2ZURvY0hhbmRsZXJzWyBldmVudFR5cGUgXSB8fCAwICkgKyAxOwoKCQkJaWYgKCBhY3RpdmVEb2NIYW5kbGVyc1sgZXZlbnRUeXBlIF0gPT09IDEgKSB7CgkJCQkkZG9jdW1lbnQuYmluZCggcmVhbFR5cGUsIG1vdXNlRXZlbnRDYWxsYmFjayApOwoJCQl9CgoJCQkvLyBTb21lIGJyb3dzZXJzLCBsaWtlIE9wZXJhIE1pbmksIHdvbid0IGRpc3BhdGNoIG1vdXNlL2NsaWNrIGV2ZW50cwoJCQkvLyBmb3IgZWxlbWVudHMgdW5sZXNzIHRoZXkgYWN0dWFsbHkgaGF2ZSBoYW5kbGVycyByZWdpc3RlcmVkIG9uIHRoZW0uCgkJCS8vIFRvIGdldCBhcm91bmQgdGhpcywgd2UgcmVnaXN0ZXIgZHVtbXkgaGFuZGxlcnMgb24gdGhlIGVsZW1lbnRzLgoKCQkJJCggdGhpcyApLmJpbmQoIHJlYWxUeXBlLCBkdW1teU1vdXNlSGFuZGxlciApOwoKCQkJLy8gRm9yIG5vdywgaWYgZXZlbnQgY2FwdHVyZSBpcyBub3Qgc3VwcG9ydGVkLCB3ZSByZWx5IG9uIG1vdXNlIGhhbmRsZXJzLgoJCQlpZiAoIGV2ZW50Q2FwdHVyZVN1cHBvcnRlZCApIHsKCQkJCS8vIElmIHRoaXMgaXMgdGhlIGZpcnN0IHZpcnR1YWwgbW91c2UgYmluZGluZyBmb3IgdGhlIGRvY3VtZW50LAoJCQkJLy8gcmVnaXN0ZXIgb3VyIHRvdWNoc3RhcnQgaGFuZGxlciBvbiB0aGUgZG9jdW1lbnQuCgoJCQkJYWN0aXZlRG9jSGFuZGxlcnNbICJ0b3VjaHN0YXJ0IiBdID0gKCBhY3RpdmVEb2NIYW5kbGVyc1sgInRvdWNoc3RhcnQiIF0gfHwgMCkgKyAxOwoKCQkJCWlmICggYWN0aXZlRG9jSGFuZGxlcnNbICJ0b3VjaHN0YXJ0IiBdID09PSAxICkgewoJCQkJCSRkb2N1bWVudC5iaW5kKCAidG91Y2hzdGFydCIsIGhhbmRsZVRvdWNoU3RhcnQgKQoJCQkJCQkuYmluZCggInRvdWNoZW5kIiwgaGFuZGxlVG91Y2hFbmQgKQoKCQkJCQkJLy8gT24gdG91Y2ggcGxhdGZvcm1zLCB0b3VjaGluZyB0aGUgc2NyZWVuIGFuZCB0aGVuIGRyYWdnaW5nIHlvdXIgZmluZ2VyCgkJCQkJCS8vIGNhdXNlcyB0aGUgd2luZG93IGNvbnRlbnQgdG8gc2Nyb2xsIGFmdGVyIHNvbWUgZGlzdGFuY2UgdGhyZXNob2xkIGlzCgkJCQkJCS8vIGV4Y2VlZGVkLiBPbiB0aGVzZSBwbGF0Zm9ybXMsIGEgc2Nyb2xsIHByZXZlbnRzIGEgY2xpY2sgZXZlbnQgZnJvbSBiZWluZwoJCQkJCQkvLyBkaXNwYXRjaGVkLCBhbmQgb24gc29tZSBwbGF0Zm9ybXMsIGV2ZW4gdGhlIHRvdWNoZW5kIGlzIHN1cHByZXNzZWQuIFRvCgkJCQkJCS8vIG1pbWljIHRoZSBzdXBwcmVzc2lvbiBvZiB0aGUgY2xpY2sgZXZlbnQsIHdlIG5lZWQgdG8gd2F0Y2ggZm9yIGEgc2Nyb2xsCgkJCQkJCS8vIGV2ZW50LiBVbmZvcnR1bmF0ZWx5LCBzb21lIHBsYXRmb3JtcyBsaWtlIGlPUyBkb24ndCBkaXNwYXRjaCBzY3JvbGwKCQkJCQkJLy8gZXZlbnRzIHVudGlsICpBRlRFUiogdGhlIHVzZXIgbGlmdHMgdGhlaXIgZmluZ2VyICh0b3VjaGVuZCkuIFRoaXMgbWVhbnMKCQkJCQkJLy8gd2UgbmVlZCB0byB3YXRjaCBib3RoIHNjcm9sbCBhbmQgdG91Y2htb3ZlIGV2ZW50cyB0byBmaWd1cmUgb3V0IHdoZXRoZXIKCQkJCQkJLy8gb3Igbm90IGEgc2Nyb2xsIGhhcHBlbmVucyBiZWZvcmUgdGhlIHRvdWNoZW5kIGV2ZW50IGlzIGZpcmVkLgoKCQkJCQkJLmJpbmQoICJ0b3VjaG1vdmUiLCBoYW5kbGVUb3VjaE1vdmUgKQoJCQkJCQkuYmluZCggInNjcm9sbCIsIGhhbmRsZVNjcm9sbCApOwoJCQkJfQoJCQl9CgkJfSwKCgkJdGVhcmRvd246IGZ1bmN0aW9uKCBkYXRhLCBuYW1lc3BhY2UgKSB7CgkJCS8vIElmIHRoaXMgaXMgdGhlIGxhc3QgdmlydHVhbCBiaW5kaW5nIGZvciB0aGlzIGV2ZW50VHlwZSwKCQkJLy8gcmVtb3ZlIGl0cyBnbG9iYWwgaGFuZGxlciBmcm9tIHRoZSBkb2N1bWVudC4KCgkJCS0tYWN0aXZlRG9jSGFuZGxlcnNbIGV2ZW50VHlwZSBdOwoKCQkJaWYgKCAhYWN0aXZlRG9jSGFuZGxlcnNbIGV2ZW50VHlwZSBdICkgewoJCQkJJGRvY3VtZW50LnVuYmluZCggcmVhbFR5cGUsIG1vdXNlRXZlbnRDYWxsYmFjayApOwoJCQl9CgoJCQlpZiAoIGV2ZW50Q2FwdHVyZVN1cHBvcnRlZCApIHsKCQkJCS8vIElmIHRoaXMgaXMgdGhlIGxhc3QgdmlydHVhbCBtb3VzZSBiaW5kaW5nIGluIGV4aXN0ZW5jZSwKCQkJCS8vIHJlbW92ZSBvdXIgZG9jdW1lbnQgdG91Y2hzdGFydCBsaXN0ZW5lci4KCgkJCQktLWFjdGl2ZURvY0hhbmRsZXJzWyAidG91Y2hzdGFydCIgXTsKCgkJCQlpZiAoICFhY3RpdmVEb2NIYW5kbGVyc1sgInRvdWNoc3RhcnQiIF0gKSB7CgkJCQkJJGRvY3VtZW50LnVuYmluZCggInRvdWNoc3RhcnQiLCBoYW5kbGVUb3VjaFN0YXJ0ICkKCQkJCQkJLnVuYmluZCggInRvdWNobW92ZSIsIGhhbmRsZVRvdWNoTW92ZSApCgkJCQkJCS51bmJpbmQoICJ0b3VjaGVuZCIsIGhhbmRsZVRvdWNoRW5kICkKCQkJCQkJLnVuYmluZCggInNjcm9sbCIsIGhhbmRsZVNjcm9sbCApOwoJCQkJfQoJCQl9CgoJCQl2YXIgJHRoaXMgPSAkKCB0aGlzICksCgkJCQliaW5kaW5ncyA9ICQuZGF0YSggdGhpcywgZGF0YVByb3BlcnR5TmFtZSApOwoKCQkJLy8gdGVhcmRvd24gbWF5IGJlIGNhbGxlZCB3aGVuIGFuIGVsZW1lbnQgd2FzCgkJCS8vIHJlbW92ZWQgZnJvbSB0aGUgRE9NLiBJZiB0aGlzIGlzIHRoZSBjYXNlLAoJCQkvLyBqUXVlcnkgY29yZSBtYXkgaGF2ZSBhbHJlYWR5IHN0cmlwcGVkIHRoZSBlbGVtZW50CgkJCS8vIG9mIGFueSBkYXRhIGJpbmRpbmdzIHNvIHdlIG5lZWQgdG8gY2hlY2sgaXQgYmVmb3JlCgkJCS8vIHVzaW5nIGl0LgoJCQlpZiAoIGJpbmRpbmdzICkgewoJCQkJYmluZGluZ3NbIGV2ZW50VHlwZSBdID0gZmFsc2U7CgkJCX0KCgkJCS8vIFVucmVnaXN0ZXIgdGhlIGR1bW15IGV2ZW50IGhhbmRsZXIuCgoJCQkkdGhpcy51bmJpbmQoIHJlYWxUeXBlLCBkdW1teU1vdXNlSGFuZGxlciApOwoKCQkJLy8gSWYgdGhpcyBpcyB0aGUgbGFzdCB2aXJ0dWFsIG1vdXNlIGJpbmRpbmcgb24gdGhlCgkJCS8vIGVsZW1lbnQsIHJlbW92ZSB0aGUgYmluZGluZyBkYXRhIGZyb20gdGhlIGVsZW1lbnQuCgoJCQlpZiAoICFoYXNWaXJ0dWFsQmluZGluZ3MoIHRoaXMgKSApIHsKCQkJCSR0aGlzLnJlbW92ZURhdGEoIGRhdGFQcm9wZXJ0eU5hbWUgKTsKCQkJfQoJCX0KCX07Cn0KCi8vIEV4cG9zZSBvdXIgY3VzdG9tIGV2ZW50cyB0byB0aGUgalF1ZXJ5IGJpbmQvdW5iaW5kIG1lY2hhbmlzbS4KCmZvciAoIHZhciBpID0gMDsgaSA8IHZpcnR1YWxFdmVudE5hbWVzLmxlbmd0aDsgaSsrICkgewoJJC5ldmVudC5zcGVjaWFsWyB2aXJ0dWFsRXZlbnROYW1lc1sgaSBdIF0gPSBnZXRTcGVjaWFsRXZlbnRPYmplY3QoIHZpcnR1YWxFdmVudE5hbWVzWyBpIF0gKTsKfQoKLy8gQWRkIGEgY2FwdHVyZSBjbGljayBoYW5kbGVyIHRvIGJsb2NrIGNsaWNrcy4KLy8gTm90ZSB0aGF0IHdlIHJlcXVpcmUgZXZlbnQgY2FwdHVyZSBzdXBwb3J0IGZvciB0aGlzIHNvIGlmIHRoZSBkZXZpY2UKLy8gZG9lc24ndCBzdXBwb3J0IGl0LCB3ZSBwdW50IGZvciBub3cgYW5kIHJlbHkgc29sZWx5IG9uIG1vdXNlIGV2ZW50cy4KaWYgKCBldmVudENhcHR1cmVTdXBwb3J0ZWQgKSB7Cglkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCAiY2xpY2siLCBmdW5jdGlvbiggZSApIHsKCQl2YXIgY250ID0gY2xpY2tCbG9ja0xpc3QubGVuZ3RoLAoJCQl0YXJnZXQgPSBlLnRhcmdldCwKCQkJeCwgeSwgZWxlLCBpLCBvLCB0b3VjaElEOwoKCQlpZiAoIGNudCApIHsKCQkJeCA9IGUuY2xpZW50WDsKCQkJeSA9IGUuY2xpZW50WTsKCQkJdGhyZXNob2xkID0gJC52bW91c2UuY2xpY2tEaXN0YW5jZVRocmVzaG9sZDsKCgkJCS8vIFRoZSBpZGVhIGhlcmUgaXMgdG8gcnVuIHRocm91Z2ggdGhlIGNsaWNrQmxvY2tMaXN0IHRvIHNlZSBpZgoJCQkvLyB0aGUgY3VycmVudCBjbGljayBldmVudCBpcyBpbiB0aGUgcHJveGltaXR5IG9mIG9uZSBvZiBvdXIKCQkJLy8gdmNsaWNrIGV2ZW50cyB0aGF0IGhhZCBwcmV2ZW50RGVmYXVsdCgpIGNhbGxlZCBvbiBpdC4gSWYgd2UgZmluZAoJCQkvLyBvbmUsIHRoZW4gd2UgYmxvY2sgdGhlIGNsaWNrLgoJCQkvLwoJCQkvLyBXaHkgZG8gd2UgaGF2ZSB0byByZWx5IG9uIHByb3hpbWl0eT8KCQkJLy8KCQkJLy8gQmVjYXVzZSB0aGUgdGFyZ2V0IG9mIHRoZSB0b3VjaCBldmVudCB0aGF0IHRyaWdnZXJlZCB0aGUgdmNsaWNrCgkJCS8vIGNhbiBiZSBkaWZmZXJlbnQgZnJvbSB0aGUgdGFyZ2V0IG9mIHRoZSBjbGljayBldmVudCBzeW50aGVzaXplZAoJCQkvLyBieSB0aGUgYnJvd3Nlci4gVGhlIHRhcmdldCBvZiBhIG1vdXNlL2NsaWNrIGV2ZW50IHRoYXQgaXMgc3ludGVoc2l6ZWQKCQkJLy8gZnJvbSBhIHRvdWNoIGV2ZW50IHNlZW1zIHRvIGJlIGltcGxlbWVudGF0aW9uIHNwZWNpZmljLiBGb3IgZXhhbXBsZSwKCQkJLy8gc29tZSBicm93c2VycyB3aWxsIGZpcmUgbW91c2UvY2xpY2sgZXZlbnRzIGZvciBhIGxpbmsgdGhhdCBpcyBuZWFyCgkJCS8vIGEgdG91Y2ggZXZlbnQsIGV2ZW4gdGhvdWdoIHRoZSB0YXJnZXQgb2YgdGhlIHRvdWNoc3RhcnQvdG91Y2hlbmQgZXZlbnQKCQkJLy8gc2F5cyB0aGUgdXNlciB0b3VjaGVkIG91dHNpZGUgdGhlIGxpbmsuIEFsc28sIGl0IHNlZW1zIHRoYXQgd2l0aCBtb3N0CgkJCS8vIGJyb3dzZXJzLCB0aGUgdGFyZ2V0IG9mIHRoZSBtb3VzZS9jbGljayBldmVudCBpcyBub3QgY2FsY3VsYXRlZCB1bnRpbCB0aGUKCQkJLy8gdGltZSBpdCBpcyBkaXNwYXRjaGVkLCBzbyBpZiB5b3UgcmVwbGFjZSBhbiBlbGVtZW50IHRoYXQgeW91IHRvdWNoZWQKCQkJLy8gd2l0aCBhbm90aGVyIGVsZW1lbnQsIHRoZSB0YXJnZXQgb2YgdGhlIG1vdXNlL2NsaWNrIHdpbGwgYmUgdGhlIG5ldwoJCQkvLyBlbGVtZW50IHVuZGVybmVhdGggdGhhdCBwb2ludC4KCQkJLy8KCQkJLy8gQXNpZGUgZnJvbSBwcm94aW1pdHksIHdlIGFsc28gY2hlY2sgdG8gc2VlIGlmIHRoZSB0YXJnZXQgYW5kIGFueQoJCQkvLyBvZiBpdHMgYW5jZXN0b3JzIHdlcmUgdGhlIG9uZXMgdGhhdCBibG9ja2VkIGEgY2xpY2suIFRoaXMgaXMgbmVjZXNzYXJ5CgkJCS8vIGJlY2F1c2Ugb2YgdGhlIHN0cmFuZ2UgbW91c2UvY2xpY2sgdGFyZ2V0IGNhbGN1bGF0aW9uIGRvbmUgaW4gdGhlCgkJCS8vIEFuZHJvaWQgMi4xIGJyb3dzZXIsIHdoZXJlIGlmIHlvdSBjbGljayBvbiBhbiBlbGVtZW50LCBhbmQgdGhlcmUgaXMgYQoJCQkvLyBtb3VzZS9jbGljayBoYW5kbGVyIG9uIG9uZSBvZiBpdHMgYW5jZXN0b3JzLCB0aGUgdGFyZ2V0IHdpbGwgYmUgdGhlCgkJCS8vIGlubmVybW9zdCBjaGlsZCBvZiB0aGUgdG91Y2hlZCBlbGVtZW50LCBldmVuIGlmIHRoYXQgY2hpbGQgaXMgbm8gd2hlcmUKCQkJLy8gbmVhciB0aGUgcG9pbnQgb2YgdG91Y2guCgoJCQllbGUgPSB0YXJnZXQ7CgoJCQl3aGlsZSAoIGVsZSApIHsKCQkJCWZvciAoIGkgPSAwOyBpIDwgY250OyBpKysgKSB7CgkJCQkJbyA9IGNsaWNrQmxvY2tMaXN0WyBpIF07CgkJCQkJdG91Y2hJRCA9IDA7CgoJCQkJCWlmICggKCBlbGUgPT09IHRhcmdldCAmJiBNYXRoLmFicyggby54IC0geCApIDwgdGhyZXNob2xkICYmIE1hdGguYWJzKCBvLnkgLSB5ICkgPCB0aHJlc2hvbGQgKSB8fAoJCQkJCQkJCSQuZGF0YSggZWxlLCB0b3VjaFRhcmdldFByb3BlcnR5TmFtZSApID09PSBvLnRvdWNoSUQgKSB7CgkJCQkJCS8vIFhYWDogV2UgbWF5IHdhbnQgdG8gY29uc2lkZXIgcmVtb3ZpbmcgbWF0Y2hlcyBmcm9tIHRoZSBibG9jayBsaXN0CgkJCQkJCS8vICAgICAgaW5zdGVhZCBvZiB3YWl0aW5nIGZvciB0aGUgcmVzZXQgdGltZXIgdG8gZmlyZS4KCQkJCQkJZS5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJCQllLnN0b3BQcm9wYWdhdGlvbigpOwoJCQkJCQlyZXR1cm47CgkJCQkJfQoJCQkJfQoJCQkJZWxlID0gZWxlLnBhcmVudE5vZGU7CgkJCX0KCQl9Cgl9LCB0cnVlKTsKfQp9KSggalF1ZXJ5LCB3aW5kb3csIGRvY3VtZW50ICk7CgoJKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgkJdmFyIHN1cHBvcnQgPSB7CgkJCXRvdWNoOiAib250b3VjaGVuZCIgaW4gZG9jdW1lbnQKCQl9OwoKCQkkLm1vYmlsZSA9ICQubW9iaWxlIHx8IHt9OwoJCSQubW9iaWxlLnN1cHBvcnQgPSAkLm1vYmlsZS5zdXBwb3J0IHx8IHt9OwoJCSQuZXh0ZW5kKCAkLnN1cHBvcnQsIHN1cHBvcnQgKTsKCQkkLmV4dGVuZCggJC5tb2JpbGUuc3VwcG9ydCwgc3VwcG9ydCApOwoJfSggalF1ZXJ5ICkpOwoKCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgkvLyBhZGQgbmV3IGV2ZW50IHNob3J0Y3V0cwoJJC5lYWNoKCAoICJ0b3VjaHN0YXJ0IHRvdWNobW92ZSB0b3VjaGVuZCAiICsKCQkidGFwIHRhcGhvbGQgIiArCgkJInN3aXBlIHN3aXBlbGVmdCBzd2lwZXJpZ2h0ICIgKwoJCSJzY3JvbGxzdGFydCBzY3JvbGxzdG9wIiApLnNwbGl0KCAiICIgKSwgZnVuY3Rpb24oIGksIG5hbWUgKSB7CgoJCSQuZm5bIG5hbWUgXSA9IGZ1bmN0aW9uKCBmbiApIHsKCQkJcmV0dXJuIGZuID8gdGhpcy5iaW5kKCBuYW1lLCBmbiApIDogdGhpcy50cmlnZ2VyKCBuYW1lICk7CgkJfTsKCgkJLy8galF1ZXJ5IDwgMS44CgkJaWYgKCAkLmF0dHJGbiApIHsKCQkJJC5hdHRyRm5bIG5hbWUgXSA9IHRydWU7CgkJfQoJfSk7CgoJdmFyIHN1cHBvcnRUb3VjaCA9ICQubW9iaWxlLnN1cHBvcnQudG91Y2gsCgkJc2Nyb2xsRXZlbnQgPSAidG91Y2htb3ZlIHNjcm9sbCIsCgkJdG91Y2hTdGFydEV2ZW50ID0gc3VwcG9ydFRvdWNoID8gInRvdWNoc3RhcnQiIDogIm1vdXNlZG93biIsCgkJdG91Y2hTdG9wRXZlbnQgPSBzdXBwb3J0VG91Y2ggPyAidG91Y2hlbmQiIDogIm1vdXNldXAiLAoJCXRvdWNoTW92ZUV2ZW50ID0gc3VwcG9ydFRvdWNoID8gInRvdWNobW92ZSIgOiAibW91c2Vtb3ZlIjsKCglmdW5jdGlvbiB0cmlnZ2VyQ3VzdG9tRXZlbnQoIG9iaiwgZXZlbnRUeXBlLCBldmVudCApIHsKCQl2YXIgb3JpZ2luYWxUeXBlID0gZXZlbnQudHlwZTsKCQlldmVudC50eXBlID0gZXZlbnRUeXBlOwoJCSQuZXZlbnQuaGFuZGxlLmNhbGwoIG9iaiwgZXZlbnQgKTsKCQlldmVudC50eXBlID0gb3JpZ2luYWxUeXBlOwoJfQoKCS8vIGFsc28gaGFuZGxlcyBzY3JvbGxzdG9wCgkkLmV2ZW50LnNwZWNpYWwuc2Nyb2xsc3RhcnQgPSB7CgoJCWVuYWJsZWQ6IHRydWUsCgoJCXNldHVwOiBmdW5jdGlvbigpIHsKCgkJCXZhciB0aGlzT2JqZWN0ID0gdGhpcywKCQkJCSR0aGlzID0gJCggdGhpc09iamVjdCApLAoJCQkJc2Nyb2xsaW5nLAoJCQkJdGltZXI7CgoJCQlmdW5jdGlvbiB0cmlnZ2VyKCBldmVudCwgc3RhdGUgKSB7CgkJCQlzY3JvbGxpbmcgPSBzdGF0ZTsKCQkJCXRyaWdnZXJDdXN0b21FdmVudCggdGhpc09iamVjdCwgc2Nyb2xsaW5nID8gInNjcm9sbHN0YXJ0IiA6ICJzY3JvbGxzdG9wIiwgZXZlbnQgKTsKCQkJfQoKCQkJLy8gaVBob25lIHRyaWdnZXJzIHNjcm9sbCBhZnRlciBhIHNtYWxsIGRlbGF5OyB1c2UgdG91Y2htb3ZlIGluc3RlYWQKCQkJJHRoaXMuYmluZCggc2Nyb2xsRXZlbnQsIGZ1bmN0aW9uKCBldmVudCApIHsKCgkJCQlpZiAoICEkLmV2ZW50LnNwZWNpYWwuc2Nyb2xsc3RhcnQuZW5hYmxlZCApIHsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKCAhc2Nyb2xsaW5nICkgewoJCQkJCXRyaWdnZXIoIGV2ZW50LCB0cnVlICk7CgkJCQl9CgoJCQkJY2xlYXJUaW1lb3V0KCB0aW1lciApOwoJCQkJdGltZXIgPSBzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJCQl0cmlnZ2VyKCBldmVudCwgZmFsc2UgKTsKCQkJCX0sIDUwICk7CgkJCX0pOwoJCX0KCX07CgoJLy8gYWxzbyBoYW5kbGVzIHRhcGhvbGQKCSQuZXZlbnQuc3BlY2lhbC50YXAgPSB7CgkJdGFwaG9sZFRocmVzaG9sZDogNzUwLAoKCQlzZXR1cDogZnVuY3Rpb24oKSB7CgkJCXZhciB0aGlzT2JqZWN0ID0gdGhpcywKCQkJCSR0aGlzID0gJCggdGhpc09iamVjdCApOwoKCQkJJHRoaXMuYmluZCggInZtb3VzZWRvd24iLCBmdW5jdGlvbiggZXZlbnQgKSB7CgoJCQkJaWYgKCBldmVudC53aGljaCAmJiBldmVudC53aGljaCAhPT0gMSApIHsKCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQl9CgoJCQkJdmFyIG9yaWdUYXJnZXQgPSBldmVudC50YXJnZXQsCgkJCQkJb3JpZ0V2ZW50ID0gZXZlbnQub3JpZ2luYWxFdmVudCwKCQkJCQl0aW1lcjsKCgkJCQlmdW5jdGlvbiBjbGVhclRhcFRpbWVyKCkgewoJCQkJCWNsZWFyVGltZW91dCggdGltZXIgKTsKCQkJCX0KCgkJCQlmdW5jdGlvbiBjbGVhclRhcEhhbmRsZXJzKCkgewoJCQkJCWNsZWFyVGFwVGltZXIoKTsKCgkJCQkJJHRoaXMudW5iaW5kKCAidmNsaWNrIiwgY2xpY2tIYW5kbGVyICkKCQkJCQkJLnVuYmluZCggInZtb3VzZXVwIiwgY2xlYXJUYXBUaW1lciApOwoJCQkJCSQoIGRvY3VtZW50ICkudW5iaW5kKCAidm1vdXNlY2FuY2VsIiwgY2xlYXJUYXBIYW5kbGVycyApOwoJCQkJfQoKCQkJCWZ1bmN0aW9uIGNsaWNrSGFuZGxlciggZXZlbnQgKSB7CgkJCQkJY2xlYXJUYXBIYW5kbGVycygpOwoKCQkJCQkvLyBPTkxZIHRyaWdnZXIgYSAndGFwJyBldmVudCBpZiB0aGUgc3RhcnQgdGFyZ2V0IGlzCgkJCQkJLy8gdGhlIHNhbWUgYXMgdGhlIHN0b3AgdGFyZ2V0LgoJCQkJCWlmICggb3JpZ1RhcmdldCA9PT0gZXZlbnQudGFyZ2V0ICkgewoJCQkJCQl0cmlnZ2VyQ3VzdG9tRXZlbnQoIHRoaXNPYmplY3QsICJ0YXAiLCBldmVudCApOwoJCQkJCX0KCQkJCX0KCgkJCQkkdGhpcy5iaW5kKCAidm1vdXNldXAiLCBjbGVhclRhcFRpbWVyICkKCQkJCQkuYmluZCggInZjbGljayIsIGNsaWNrSGFuZGxlciApOwoJCQkJJCggZG9jdW1lbnQgKS5iaW5kKCAidm1vdXNlY2FuY2VsIiwgY2xlYXJUYXBIYW5kbGVycyApOwoKCQkJCXRpbWVyID0gc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQkJdHJpZ2dlckN1c3RvbUV2ZW50KCB0aGlzT2JqZWN0LCAidGFwaG9sZCIsICQuRXZlbnQoICJ0YXBob2xkIiwgeyB0YXJnZXQ6IG9yaWdUYXJnZXQgfSApICk7CgkJCQl9LCAkLmV2ZW50LnNwZWNpYWwudGFwLnRhcGhvbGRUaHJlc2hvbGQgKTsKCQkJfSk7CgkJfQoJfTsKCgkvLyBhbHNvIGhhbmRsZXMgc3dpcGVsZWZ0LCBzd2lwZXJpZ2h0CgkkLmV2ZW50LnNwZWNpYWwuc3dpcGUgPSB7CgkJc2Nyb2xsU3VwcmVzc2lvblRocmVzaG9sZDogMzAsIC8vIE1vcmUgdGhhbiB0aGlzIGhvcml6b250YWwgZGlzcGxhY2VtZW50LCBhbmQgd2Ugd2lsbCBzdXBwcmVzcyBzY3JvbGxpbmcuCgoJCWR1cmF0aW9uVGhyZXNob2xkOiAxMDAwLCAvLyBNb3JlIHRpbWUgdGhhbiB0aGlzLCBhbmQgaXQgaXNuJ3QgYSBzd2lwZS4KCgkJaG9yaXpvbnRhbERpc3RhbmNlVGhyZXNob2xkOiAzMCwgIC8vIFN3aXBlIGhvcml6b250YWwgZGlzcGxhY2VtZW50IG11c3QgYmUgbW9yZSB0aGFuIHRoaXMuCgoJCXZlcnRpY2FsRGlzdGFuY2VUaHJlc2hvbGQ6IDc1LCAgLy8gU3dpcGUgdmVydGljYWwgZGlzcGxhY2VtZW50IG11c3QgYmUgbGVzcyB0aGFuIHRoaXMuCgoJCXNldHVwOiBmdW5jdGlvbigpIHsKCQkJdmFyIHRoaXNPYmplY3QgPSB0aGlzLAoJCQkJJHRoaXMgPSAkKCB0aGlzT2JqZWN0ICk7CgoJCQkkdGhpcy5iaW5kKCB0b3VjaFN0YXJ0RXZlbnQsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCXZhciBkYXRhID0gZXZlbnQub3JpZ2luYWxFdmVudC50b3VjaGVzID8KCQkJCQkJZXZlbnQub3JpZ2luYWxFdmVudC50b3VjaGVzWyAwIF0gOiBldmVudCwKCQkJCQlzdGFydCA9IHsKCQkJCQkJdGltZTogKCBuZXcgRGF0ZSgpICkuZ2V0VGltZSgpLAoJCQkJCQljb29yZHM6IFsgZGF0YS5wYWdlWCwgZGF0YS5wYWdlWSBdLAoJCQkJCQlvcmlnaW46ICQoIGV2ZW50LnRhcmdldCApCgkJCQkJfSwKCQkJCQlzdG9wOwoKCQkJCWZ1bmN0aW9uIG1vdmVIYW5kbGVyKCBldmVudCApIHsKCgkJCQkJaWYgKCAhc3RhcnQgKSB7CgkJCQkJCXJldHVybjsKCQkJCQl9CgoJCQkJCXZhciBkYXRhID0gZXZlbnQub3JpZ2luYWxFdmVudC50b3VjaGVzID8KCQkJCQkJZXZlbnQub3JpZ2luYWxFdmVudC50b3VjaGVzWyAwIF0gOiBldmVudDsKCgkJCQkJc3RvcCA9IHsKCQkJCQkJdGltZTogKCBuZXcgRGF0ZSgpICkuZ2V0VGltZSgpLAoJCQkJCQljb29yZHM6IFsgZGF0YS5wYWdlWCwgZGF0YS5wYWdlWSBdCgkJCQkJfTsKCgkJCQkJLy8gcHJldmVudCBzY3JvbGxpbmcKCQkJCQlpZiAoIE1hdGguYWJzKCBzdGFydC5jb29yZHNbIDAgXSAtIHN0b3AuY29vcmRzWyAwIF0gKSA+ICQuZXZlbnQuc3BlY2lhbC5zd2lwZS5zY3JvbGxTdXByZXNzaW9uVGhyZXNob2xkICkgewoJCQkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJCX0KCQkJCX0KCgkJCQkkdGhpcy5iaW5kKCB0b3VjaE1vdmVFdmVudCwgbW92ZUhhbmRsZXIgKQoJCQkJCS5vbmUoIHRvdWNoU3RvcEV2ZW50LCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkJCSR0aGlzLnVuYmluZCggdG91Y2hNb3ZlRXZlbnQsIG1vdmVIYW5kbGVyICk7CgoJCQkJCQlpZiAoIHN0YXJ0ICYmIHN0b3AgKSB7CgkJCQkJCQlpZiAoIHN0b3AudGltZSAtIHN0YXJ0LnRpbWUgPCAkLmV2ZW50LnNwZWNpYWwuc3dpcGUuZHVyYXRpb25UaHJlc2hvbGQgJiYKCQkJCQkJCQlNYXRoLmFicyggc3RhcnQuY29vcmRzWyAwIF0gLSBzdG9wLmNvb3Jkc1sgMCBdICkgPiAkLmV2ZW50LnNwZWNpYWwuc3dpcGUuaG9yaXpvbnRhbERpc3RhbmNlVGhyZXNob2xkICYmCgkJCQkJCQkJTWF0aC5hYnMoIHN0YXJ0LmNvb3Jkc1sgMSBdIC0gc3RvcC5jb29yZHNbIDEgXSApIDwgJC5ldmVudC5zcGVjaWFsLnN3aXBlLnZlcnRpY2FsRGlzdGFuY2VUaHJlc2hvbGQgKSB7CgoJCQkJCQkJCXN0YXJ0Lm9yaWdpbi50cmlnZ2VyKCAic3dpcGUiICkKCQkJCQkJCQkJLnRyaWdnZXIoIHN0YXJ0LmNvb3Jkc1swXSA+IHN0b3AuY29vcmRzWyAwIF0gPyAic3dpcGVsZWZ0IiA6ICJzd2lwZXJpZ2h0IiApOwoJCQkJCQkJfQoJCQkJCQl9CgkJCQkJCXN0YXJ0ID0gc3RvcCA9IHVuZGVmaW5lZDsKCQkJCQl9KTsKCQkJfSk7CgkJfQoJfTsKCSQuZWFjaCh7CgkJc2Nyb2xsc3RvcDogInNjcm9sbHN0YXJ0IiwKCQl0YXBob2xkOiAidGFwIiwKCQlzd2lwZWxlZnQ6ICJzd2lwZSIsCgkJc3dpcGVyaWdodDogInN3aXBlIgoJfSwgZnVuY3Rpb24oIGV2ZW50LCBzb3VyY2VFdmVudCApIHsKCgkJJC5ldmVudC5zcGVjaWFsWyBldmVudCBdID0gewoJCQlzZXR1cDogZnVuY3Rpb24oKSB7CgkJCQkkKCB0aGlzICkuYmluZCggc291cmNlRXZlbnQsICQubm9vcCApOwoJCQl9CgkJfTsKCX0pOwoKfSkoIGpRdWVyeSwgdGhpcyApOwoKCShmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoJCSQuZXh0ZW5kKCAkLnN1cHBvcnQsIHsKCQkJb3JpZW50YXRpb246ICJvcmllbnRhdGlvbiIgaW4gd2luZG93ICYmICJvbm9yaWVudGF0aW9uY2hhbmdlIiBpbiB3aW5kb3cKCQl9KTsKCX0oIGpRdWVyeSApKTsKCgoJLy8gdGhyb3R0bGVkIHJlc2l6ZSBldmVudAoJKGZ1bmN0aW9uKCAkICkgewoJCSQuZXZlbnQuc3BlY2lhbC50aHJvdHRsZWRyZXNpemUgPSB7CgkJCXNldHVwOiBmdW5jdGlvbigpIHsKCQkJCSQoIHRoaXMgKS5iaW5kKCAicmVzaXplIiwgaGFuZGxlciApOwoJCQl9LAoJCQl0ZWFyZG93bjogZnVuY3Rpb24oKSB7CgkJCQkkKCB0aGlzICkudW5iaW5kKCAicmVzaXplIiwgaGFuZGxlciApOwoJCQl9CgkJfTsKCgkJdmFyIHRocm90dGxlID0gMjUwLAoJCQloYW5kbGVyID0gZnVuY3Rpb24oKSB7CgkJCQljdXJyID0gKCBuZXcgRGF0ZSgpICkuZ2V0VGltZSgpOwoJCQkJZGlmZiA9IGN1cnIgLSBsYXN0Q2FsbDsKCgkJCQlpZiAoIGRpZmYgPj0gdGhyb3R0bGUgKSB7CgoJCQkJCWxhc3RDYWxsID0gY3VycjsKCQkJCQkkKCB0aGlzICkudHJpZ2dlciggInRocm90dGxlZHJlc2l6ZSIgKTsKCgkJCQl9IGVsc2UgewoKCQkJCQlpZiAoIGhlbGRDYWxsICkgewoJCQkJCQljbGVhclRpbWVvdXQoIGhlbGRDYWxsICk7CgkJCQkJfQoKCQkJCQkvLyBQcm9taXNlIGEgaGVsZCBjYWxsIHdpbGwgc3RpbGwgZXhlY3V0ZQoJCQkJCWhlbGRDYWxsID0gc2V0VGltZW91dCggaGFuZGxlciwgdGhyb3R0bGUgLSBkaWZmICk7CgkJCQl9CgkJCX0sCgkJCWxhc3RDYWxsID0gMCwKCQkJaGVsZENhbGwsCgkJCWN1cnIsCgkJCWRpZmY7Cgl9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHdpbmRvdyApIHsKCXZhciB3aW4gPSAkKCB3aW5kb3cgKSwKCQlldmVudF9uYW1lID0gIm9yaWVudGF0aW9uY2hhbmdlIiwKCQlzcGVjaWFsX2V2ZW50LAoJCWdldF9vcmllbnRhdGlvbiwKCQlsYXN0X29yaWVudGF0aW9uLAoJCWluaXRpYWxfb3JpZW50YXRpb25faXNfbGFuZHNjYXBlLAoJCWluaXRpYWxfb3JpZW50YXRpb25faXNfZGVmYXVsdCwKCQlwb3J0cmFpdF9tYXAgPSB7ICIwIjogdHJ1ZSwgIjE4MCI6IHRydWUgfTsKCgkvLyBJdCBzZWVtcyB0aGF0IHNvbWUgZGV2aWNlL2Jyb3dzZXIgdmVuZG9ycyB1c2Ugd2luZG93Lm9yaWVudGF0aW9uIHZhbHVlcyAwIGFuZCAxODAgdG8KCS8vIGRlbm90ZSB0aGUgImRlZmF1bHQiIG9yaWVudGF0aW9uLiBGb3IgaU9TIGRldmljZXMsIGFuZCBtb3N0IG90aGVyIHNtYXJ0LXBob25lcyB0ZXN0ZWQsCgkvLyB0aGUgZGVmYXVsdCBvcmllbnRhdGlvbiBpcyBhbHdheXMgInBvcnRyYWl0IiwgYnV0IGluIHNvbWUgQW5kcm9pZCBhbmQgUklNIGJhc2VkIHRhYmxldHMsCgkvLyB0aGUgZGVmYXVsdCBvcmllbnRhdGlvbiBpcyAibGFuZHNjYXBlIi4gVGhlIGZvbGxvd2luZyBjb2RlIGF0dGVtcHRzIHRvIHVzZSB0aGUgd2luZG93CgkvLyBkaW1lbnNpb25zIHRvIGZpZ3VyZSBvdXQgd2hhdCB0aGUgY3VycmVudCBvcmllbnRhdGlvbiBpcywgYW5kIHRoZW4gbWFrZXMgYWRqdXN0bWVudHMKCS8vIHRvIHRoZSB0byB0aGUgcG9ydHJhaXRfbWFwIGlmIG5lY2Vzc2FyeSwgc28gdGhhdCB3ZSBjYW4gcHJvcGVybHkgZGVjb2RlIHRoZQoJLy8gd2luZG93Lm9yaWVudGF0aW9uIHZhbHVlIHdoZW5ldmVyIGdldF9vcmllbnRhdGlvbigpIGlzIGNhbGxlZC4KCS8vCgkvLyBOb3RlIHRoYXQgd2UgdXNlZCB0byB1c2UgYSBtZWRpYSBxdWVyeSB0byBmaWd1cmUgb3V0IHdoYXQgdGhlIG9yaWVudGF0aW9uIHRoZSBicm93c2VyCgkvLyB0aGlua3MgaXQgaXMgaW46CgkvLwoJLy8gICAgIGluaXRpYWxfb3JpZW50YXRpb25faXNfbGFuZHNjYXBlID0gJC5tb2JpbGUubWVkaWEoImFsbCBhbmQgKG9yaWVudGF0aW9uOiBsYW5kc2NhcGUpIik7CgkvLwoJLy8gYnV0IHRoZXJlIHdhcyBhbiBpUGhvbmUvaVBvZCBUb3VjaCBidWcgYmVnaW5uaW5nIHdpdGggaU9TIDQuMiwgdXAgdGhyb3VnaCBpT1MgNS4xLAoJLy8gd2hlcmUgdGhlIGJyb3dzZXIgKkFMV0FZUyogYXBwbGllZCB0aGUgbGFuZHNjYXBlIG1lZGlhIHF1ZXJ5LiBUaGlzIGJ1ZyBkb2VzIG5vdAoJLy8gaGFwcGVuIG9uIGlQYWQuCgoJaWYgKCAkLnN1cHBvcnQub3JpZW50YXRpb24gKSB7CgoJCS8vIENoZWNrIHRoZSB3aW5kb3cgd2lkdGggYW5kIGhlaWdodCB0byBmaWd1cmUgb3V0IHdoYXQgdGhlIGN1cnJlbnQgb3JpZW50YXRpb24KCQkvLyBvZiB0aGUgZGV2aWNlIGlzIGF0IHRoaXMgbW9tZW50LiBOb3RlIHRoYXQgd2UndmUgaW5pdGlhbGl6ZWQgdGhlIHBvcnRyYWl0IG1hcAoJCS8vIHZhbHVlcyB0byAwIGFuZCAxODAsICpBTkQqIHdlIHB1cnBvc2VseSBjaGVjayBmb3IgbGFuZHNjYXBlIHNvIHRoYXQgaWYgd2UgZ3Vlc3MKCQkvLyB3cm9uZywgLCB3ZSBkZWZhdWx0IHRvIHRoZSBhc3N1bXB0aW9uIHRoYXQgcG9ydHJhaXQgaXMgdGhlIGRlZmF1bHQgb3JpZW50YXRpb24uCgkJLy8gV2UgdXNlIGEgdGhyZXNob2xkIGNoZWNrIGJlbG93IGJlY2F1c2Ugb24gc29tZSBwbGF0Zm9ybXMgbGlrZSBpT1MsIHRoZSBpUGhvbmUKCQkvLyBmb3JtLWZhY3RvciBjYW4gcmVwb3J0IGEgbGFyZ2VyIHdpZHRoIHRoYW4gaGVpZ2h0IGlmIHRoZSB1c2VyIHR1cm5zIG9uIHRoZQoJCS8vIGRldmVsb3BlciBjb25zb2xlLiBUaGUgYWN0dWFsIHRocmVzaG9sZCB2YWx1ZSBpcyBzb21ld2hhdCBhcmJpdHJhcnksIHdlIGp1c3QKCQkvLyBuZWVkIHRvIG1ha2Ugc3VyZSBpdCBpcyBsYXJnZSBlbm91Z2ggdG8gZXhjbHVkZSB0aGUgZGV2ZWxvcGVyIGNvbnNvbGUgY2FzZS4KCgkJdmFyIHd3ID0gd2luZG93LmlubmVyV2lkdGggfHwgJCggd2luZG93ICkud2lkdGgoKSwKCQkJd2ggPSB3aW5kb3cuaW5uZXJIZWlnaHQgfHwgJCggd2luZG93ICkuaGVpZ2h0KCksCgkJCWxhbmRzY2FwZV90aHJlc2hvbGQgPSA1MDsKCgkJaW5pdGlhbF9vcmllbnRhdGlvbl9pc19sYW5kc2NhcGUgPSB3dyA+IHdoICYmICggd3cgLSB3aCApID4gbGFuZHNjYXBlX3RocmVzaG9sZDsKCgoJCS8vIE5vdyBjaGVjayB0byBzZWUgaWYgdGhlIGN1cnJlbnQgd2luZG93Lm9yaWVudGF0aW9uIGlzIDAgb3IgMTgwLgoJCWluaXRpYWxfb3JpZW50YXRpb25faXNfZGVmYXVsdCA9IHBvcnRyYWl0X21hcFsgd2luZG93Lm9yaWVudGF0aW9uIF07CgoJCS8vIElmIHRoZSBpbml0aWFsIG9yaWVudGF0aW9uIGlzIGxhbmRzY2FwZSwgYnV0IHdpbmRvdy5vcmllbnRhdGlvbiByZXBvcnRzIDAgb3IgMTgwLCAqT1IqCgkJLy8gaWYgdGhlIGluaXRpYWwgb3JpZW50YXRpb24gaXMgcG9ydHJhaXQsIGJ1dCB3aW5kb3cub3JpZW50YXRpb24gcmVwb3J0cyA5MCBvciAtOTAsIHdlCgkJLy8gbmVlZCB0byBmbGlwIG91ciBwb3J0cmFpdF9tYXAgdmFsdWVzIGJlY2F1c2UgbGFuZHNjYXBlIGlzIHRoZSBkZWZhdWx0IG9yaWVudGF0aW9uIGZvcgoJCS8vIHRoaXMgZGV2aWNlL2Jyb3dzZXIuCgkJaWYgKCAoIGluaXRpYWxfb3JpZW50YXRpb25faXNfbGFuZHNjYXBlICYmIGluaXRpYWxfb3JpZW50YXRpb25faXNfZGVmYXVsdCApIHx8ICggIWluaXRpYWxfb3JpZW50YXRpb25faXNfbGFuZHNjYXBlICYmICFpbml0aWFsX29yaWVudGF0aW9uX2lzX2RlZmF1bHQgKSApIHsKCQkJcG9ydHJhaXRfbWFwID0geyAiLTkwIjogdHJ1ZSwgIjkwIjogdHJ1ZSB9OwoJCX0KCX0KCgkkLmV2ZW50LnNwZWNpYWwub3JpZW50YXRpb25jaGFuZ2UgPSAkLmV4dGVuZCgge30sICQuZXZlbnQuc3BlY2lhbC5vcmllbnRhdGlvbmNoYW5nZSwgewoJCXNldHVwOiBmdW5jdGlvbigpIHsKCQkJLy8gSWYgdGhlIGV2ZW50IGlzIHN1cHBvcnRlZCBuYXRpdmVseSwgcmV0dXJuIGZhbHNlIHNvIHRoYXQgalF1ZXJ5CgkJCS8vIHdpbGwgYmluZCB0byB0aGUgZXZlbnQgdXNpbmcgRE9NIG1ldGhvZHMuCgkJCWlmICggJC5zdXBwb3J0Lm9yaWVudGF0aW9uICYmICEkLmV2ZW50LnNwZWNpYWwub3JpZW50YXRpb25jaGFuZ2UuZGlzYWJsZWQgKSB7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCgkJCS8vIEdldCB0aGUgY3VycmVudCBvcmllbnRhdGlvbiB0byBhdm9pZCBpbml0aWFsIGRvdWJsZS10cmlnZ2VyaW5nLgoJCQlsYXN0X29yaWVudGF0aW9uID0gZ2V0X29yaWVudGF0aW9uKCk7CgoJCQkvLyBCZWNhdXNlIHRoZSBvcmllbnRhdGlvbmNoYW5nZSBldmVudCBkb2Vzbid0IGV4aXN0LCBzaW11bGF0ZSB0aGUKCQkJLy8gZXZlbnQgYnkgdGVzdGluZyB3aW5kb3cgZGltZW5zaW9ucyBvbiByZXNpemUuCgkJCXdpbi5iaW5kKCAidGhyb3R0bGVkcmVzaXplIiwgaGFuZGxlciApOwoJCX0sCgkJdGVhcmRvd246IGZ1bmN0aW9uKCkgewoJCQkvLyBJZiB0aGUgZXZlbnQgaXMgbm90IHN1cHBvcnRlZCBuYXRpdmVseSwgcmV0dXJuIGZhbHNlIHNvIHRoYXQKCQkJLy8galF1ZXJ5IHdpbGwgdW5iaW5kIHRoZSBldmVudCB1c2luZyBET00gbWV0aG9kcy4KCQkJaWYgKCAkLnN1cHBvcnQub3JpZW50YXRpb24gJiYgISQuZXZlbnQuc3BlY2lhbC5vcmllbnRhdGlvbmNoYW5nZS5kaXNhYmxlZCApIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoKCQkJLy8gQmVjYXVzZSB0aGUgb3JpZW50YXRpb25jaGFuZ2UgZXZlbnQgZG9lc24ndCBleGlzdCwgdW5iaW5kIHRoZQoJCQkvLyByZXNpemUgZXZlbnQgaGFuZGxlci4KCQkJd2luLnVuYmluZCggInRocm90dGxlZHJlc2l6ZSIsIGhhbmRsZXIgKTsKCQl9LAoJCWFkZDogZnVuY3Rpb24oIGhhbmRsZU9iaiApIHsKCQkJLy8gU2F2ZSBhIHJlZmVyZW5jZSB0byB0aGUgYm91bmQgZXZlbnQgaGFuZGxlci4KCQkJdmFyIG9sZF9oYW5kbGVyID0gaGFuZGxlT2JqLmhhbmRsZXI7CgoKCQkJaGFuZGxlT2JqLmhhbmRsZXIgPSBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkvLyBNb2RpZnkgZXZlbnQgb2JqZWN0LCBhZGRpbmcgdGhlIC5vcmllbnRhdGlvbiBwcm9wZXJ0eS4KCQkJCWV2ZW50Lm9yaWVudGF0aW9uID0gZ2V0X29yaWVudGF0aW9uKCk7CgoJCQkJLy8gQ2FsbCB0aGUgb3JpZ2luYWxseS1ib3VuZCBldmVudCBoYW5kbGVyIGFuZCByZXR1cm4gaXRzIHJlc3VsdC4KCQkJCXJldHVybiBvbGRfaGFuZGxlci5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgkJCX07CgkJfQoJfSk7CgoJLy8gSWYgdGhlIGV2ZW50IGlzIG5vdCBzdXBwb3J0ZWQgbmF0aXZlbHksIHRoaXMgaGFuZGxlciB3aWxsIGJlIGJvdW5kIHRvCgkvLyB0aGUgd2luZG93IHJlc2l6ZSBldmVudCB0byBzaW11bGF0ZSB0aGUgb3JpZW50YXRpb25jaGFuZ2UgZXZlbnQuCglmdW5jdGlvbiBoYW5kbGVyKCkgewoJCS8vIEdldCB0aGUgY3VycmVudCBvcmllbnRhdGlvbi4KCQl2YXIgb3JpZW50YXRpb24gPSBnZXRfb3JpZW50YXRpb24oKTsKCgkJaWYgKCBvcmllbnRhdGlvbiAhPT0gbGFzdF9vcmllbnRhdGlvbiApIHsKCQkJLy8gVGhlIG9yaWVudGF0aW9uIGhhcyBjaGFuZ2VkLCBzbyB0cmlnZ2VyIHRoZSBvcmllbnRhdGlvbmNoYW5nZSBldmVudC4KCQkJbGFzdF9vcmllbnRhdGlvbiA9IG9yaWVudGF0aW9uOwoJCQl3aW4udHJpZ2dlciggZXZlbnRfbmFtZSApOwoJCX0KCX0KCgkvLyBHZXQgdGhlIGN1cnJlbnQgcGFnZSBvcmllbnRhdGlvbi4gVGhpcyBtZXRob2QgaXMgZXhwb3NlZCBwdWJsaWNseSwgc2hvdWxkIGl0CgkvLyBiZSBuZWVkZWQsIGFzIGpRdWVyeS5ldmVudC5zcGVjaWFsLm9yaWVudGF0aW9uY2hhbmdlLm9yaWVudGF0aW9uKCkKCSQuZXZlbnQuc3BlY2lhbC5vcmllbnRhdGlvbmNoYW5nZS5vcmllbnRhdGlvbiA9IGdldF9vcmllbnRhdGlvbiA9IGZ1bmN0aW9uKCkgewoJCXZhciBpc1BvcnRyYWl0ID0gdHJ1ZSwgZWxlbSA9IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudDsKCgkJLy8gcHJlZmVyIHdpbmRvdyBvcmllbnRhdGlvbiB0byB0aGUgY2FsY3VsYXRpb24gYmFzZWQgb24gc2NyZWVuc2l6ZSBhcwoJCS8vIHRoZSBhY3R1YWwgc2NyZWVuIHJlc2l6ZSB0YWtlcyBwbGFjZSBiZWZvcmUgb3IgYWZ0ZXIgdGhlIG9yaWVudGF0aW9uIGNoYW5nZSBldmVudAoJCS8vIGhhcyBiZWVuIGZpcmVkIGRlcGVuZGluZyBvbiBpbXBsZW1lbnRhdGlvbiAoZWcgYW5kcm9pZCAyLjMgaXMgYmVmb3JlLCBpcGhvbmUgYWZ0ZXIpLgoJCS8vIE1vcmUgdGVzdGluZyBpcyByZXF1aXJlZCB0byBkZXRlcm1pbmUgaWYgYSBtb3JlIHJlbGlhYmxlIG1ldGhvZCBvZiBkZXRlcm1pbmluZyB0aGUgbmV3IHNjcmVlbnNpemUKCQkvLyBpcyBwb3NzaWJsZSB3aGVuIG9yaWVudGF0aW9uY2hhbmdlIGlzIGZpcmVkLiAoZWcsIHVzZSBtZWRpYSBxdWVyaWVzICsgZWxlbWVudCArIG9wYWNpdHkpCgkJaWYgKCAkLnN1cHBvcnQub3JpZW50YXRpb24gKSB7CgkJCS8vIGlmIHRoZSB3aW5kb3cgb3JpZW50YXRpb24gcmVnaXN0ZXJzIGFzIDAgb3IgMTgwIGRlZ3JlZXMgcmVwb3J0CgkJCS8vIHBvcnRyYWl0LCBvdGhlcndpc2UgbGFuZHNjYXBlCgkJCWlzUG9ydHJhaXQgPSBwb3J0cmFpdF9tYXBbIHdpbmRvdy5vcmllbnRhdGlvbiBdOwoJCX0gZWxzZSB7CgkJCWlzUG9ydHJhaXQgPSBlbGVtICYmIGVsZW0uY2xpZW50V2lkdGggLyBlbGVtLmNsaWVudEhlaWdodCA8IDEuMTsKCQl9CgoJCXJldHVybiBpc1BvcnRyYWl0ID8gInBvcnRyYWl0IiA6ICJsYW5kc2NhcGUiOwoJfTsKCgkkLmZuWyBldmVudF9uYW1lIF0gPSBmdW5jdGlvbiggZm4gKSB7CgkJcmV0dXJuIGZuID8gdGhpcy5iaW5kKCBldmVudF9uYW1lLCBmbiApIDogdGhpcy50cmlnZ2VyKCBldmVudF9uYW1lICk7Cgl9OwoKCS8vIGpRdWVyeSA8IDEuOAoJaWYgKCAkLmF0dHJGbiApIHsKCQkkLmF0dHJGblsgZXZlbnRfbmFtZSBdID0gdHJ1ZTsKCX0KCn0oIGpRdWVyeSwgdGhpcyApKTsKCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCnZhciAkd2luZG93ID0gJCggd2luZG93ICksCgkkaHRtbCA9ICQoICJodG1sIiApOwoKLyogJC5tb2JpbGUubWVkaWEgbWV0aG9kOiBwYXNzIGEgQ1NTIG1lZGlhIHR5cGUgb3IgcXVlcnkgYW5kIGdldCBhIGJvb2wgcmV0dXJuCglub3RlOiB0aGlzIGZlYXR1cmUgcmVsaWVzIG9uIGFjdHVhbCBtZWRpYSBxdWVyeSBzdXBwb3J0IGZvciBtZWRpYSBxdWVyaWVzLCB0aG91Z2ggdHlwZXMgd2lsbCB3b3JrIG1vc3QgYW55d2hlcmUKCWV4YW1wbGVzOgoJCSQubW9iaWxlLm1lZGlhKCdzY3JlZW4nKSAvLyB0ZXN0cyBmb3Igc2NyZWVuIG1lZGlhIHR5cGUKCQkkLm1vYmlsZS5tZWRpYSgnc2NyZWVuIGFuZCAobWluLXdpZHRoOiA0ODBweCknKSAvLyB0ZXN0cyBmb3Igc2NyZWVuIG1lZGlhIHR5cGUgd2l0aCB3aW5kb3cgd2lkdGggPiA0ODBweAoJCSQubW9iaWxlLm1lZGlhKCdAbWVkaWEgc2NyZWVuIGFuZCAoLXdlYmtpdC1taW4tZGV2aWNlLXBpeGVsLXJhdGlvOiAyKScpIC8vIHRlc3RzIGZvciB3ZWJraXQgMnggcGl4ZWwgcmF0aW8gKGlQaG9uZSA0KQoqLwokLm1vYmlsZS5tZWRpYSA9IChmdW5jdGlvbigpIHsKCS8vIFRPRE86IHVzZSB3aW5kb3cubWF0Y2hNZWRpYSBvbmNlIGF0IGxlYXN0IG9uZSBVQSBpbXBsZW1lbnRzIGl0Cgl2YXIgY2FjaGUgPSB7fSwKCQl0ZXN0RGl2ID0gJCggIjxkaXYgaWQ9J2pxdWVyeS1tZWRpYXRlc3QnPjwvZGl2PiIgKSwKCQlmYWtlQm9keSA9ICQoICI8Ym9keT4iICkuYXBwZW5kKCB0ZXN0RGl2ICk7CgoJcmV0dXJuIGZ1bmN0aW9uKCBxdWVyeSApIHsKCQlpZiAoICEoIHF1ZXJ5IGluIGNhY2hlICkgKSB7CgkJCXZhciBzdHlsZUJsb2NrID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggInN0eWxlIiApLAoJCQkJY3NzcnVsZSA9ICJAbWVkaWEgIiArIHF1ZXJ5ICsgIiB7ICNqcXVlcnktbWVkaWF0ZXN0IHsgcG9zaXRpb246YWJzb2x1dGU7IH0gfSI7CgoJCQkvL211c3Qgc2V0IHR5cGUgZm9yIElFIQoJCQlzdHlsZUJsb2NrLnR5cGUgPSAidGV4dC9jc3MiOwoKCQkJaWYgKCBzdHlsZUJsb2NrLnN0eWxlU2hlZXQgKSB7CgkJCQlzdHlsZUJsb2NrLnN0eWxlU2hlZXQuY3NzVGV4dCA9IGNzc3J1bGU7CgkJCX0gZWxzZSB7CgkJCQlzdHlsZUJsb2NrLmFwcGVuZENoaWxkKCBkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZShjc3NydWxlKSApOwoJCQl9CgoJCQkkaHRtbC5wcmVwZW5kKCBmYWtlQm9keSApLnByZXBlbmQoIHN0eWxlQmxvY2sgKTsKCQkJY2FjaGVbIHF1ZXJ5IF0gPSB0ZXN0RGl2LmNzcyggInBvc2l0aW9uIiApID09PSAiYWJzb2x1dGUiOwoJCQlmYWtlQm9keS5hZGQoIHN0eWxlQmxvY2sgKS5yZW1vdmUoKTsKCQl9CgkJcmV0dXJuIGNhY2hlWyBxdWVyeSBdOwoJfTsKfSkoKTsKCn0pKGpRdWVyeSk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCi8vIHRoeCBNb2Rlcm5penIKZnVuY3Rpb24gcHJvcEV4aXN0cyggcHJvcCApIHsKCXZhciB1Y19wcm9wID0gcHJvcC5jaGFyQXQoIDAgKS50b1VwcGVyQ2FzZSgpICsgcHJvcC5zdWJzdHIoIDEgKSwKCQlwcm9wcyA9ICggcHJvcCArICIgIiArIHZlbmRvcnMuam9pbiggdWNfcHJvcCArICIgIiApICsgdWNfcHJvcCApLnNwbGl0KCAiICIgKTsKCglmb3IgKCB2YXIgdiBpbiBwcm9wcyApIHsKCQlpZiAoIGZiQ1NTWyBwcm9wc1sgdiBdIF0gIT09IHVuZGVmaW5lZCApIHsKCQkJcmV0dXJuIHRydWU7CgkJfQoJfQp9Cgp2YXIgZmFrZUJvZHkgPSAkKCAiPGJvZHk+IiApLnByZXBlbmRUbyggImh0bWwiICksCglmYkNTUyA9IGZha2VCb2R5WyAwIF0uc3R5bGUsCgl2ZW5kb3JzID0gWyAiV2Via2l0IiwgIk1veiIsICJPIiBdLAoJd2Vib3MgPSAicGFsbUdldFJlc291cmNlIiBpbiB3aW5kb3csIC8vb25seSB1c2VkIHRvIHJ1bGUgb3V0IHNjcm9sbFRvcAoJb3BlcmEgPSB3aW5kb3cub3BlcmEsCglvcGVyYW1pbmkgPSB3aW5kb3cub3BlcmFtaW5pICYmICh7fSkudG9TdHJpbmcuY2FsbCggd2luZG93Lm9wZXJhbWluaSApID09PSAiW29iamVjdCBPcGVyYU1pbmldIiwKCWJiID0gd2luZG93LmJsYWNrYmVycnkgJiYgIXByb3BFeGlzdHMoICItd2Via2l0LXRyYW5zZm9ybSIgKTsgLy9vbmx5IHVzZWQgdG8gcnVsZSBvdXQgYm94IHNoYWRvdywgYXMgaXQncyBmaWxsZWQgb3BhcXVlIG9uIEJCIDUgYW5kIGxvd2VyCgoKZnVuY3Rpb24gdmFsaWRTdHlsZSggcHJvcCwgdmFsdWUsIGNoZWNrX3ZlbmQgKSB7Cgl2YXIgZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggJ2RpdicgKSwKCQl1YyA9IGZ1bmN0aW9uKCB0eHQgKSB7CgkJCXJldHVybiB0eHQuY2hhckF0KCAwICkudG9VcHBlckNhc2UoKSArIHR4dC5zdWJzdHIoIDEgKTsKCQl9LAoJCXZlbmRfcHJlZiA9IGZ1bmN0aW9uKCB2ZW5kICkgewoJCQlyZXR1cm4gICItIiArIHZlbmQuY2hhckF0KCAwICkudG9Mb3dlckNhc2UoKSArIHZlbmQuc3Vic3RyKCAxICkgKyAiLSI7CgkJfSwKCQljaGVja19zdHlsZSA9IGZ1bmN0aW9uKCB2ZW5kICkgewoJCQl2YXIgdmVuZF9wcm9wID0gdmVuZF9wcmVmKCB2ZW5kICkgKyBwcm9wICsgIjogIiArIHZhbHVlICsgIjsiLAoJCQkJdWNfdmVuZCA9IHVjKCB2ZW5kICksCgkJCQlwcm9wU3R5bGUgPSB1Y192ZW5kICsgdWMoIHByb3AgKTsKCgkJCWRpdi5zZXRBdHRyaWJ1dGUoICJzdHlsZSIsIHZlbmRfcHJvcCApOwoKCQkJaWYgKCAhIWRpdi5zdHlsZVsgcHJvcFN0eWxlIF0gKSB7CgkJCQlyZXQgPSB0cnVlOwoJCQl9CgkJfSwKCQljaGVja192ZW5kcyA9IGNoZWNrX3ZlbmQgPyBbIGNoZWNrX3ZlbmQgXSA6IHZlbmRvcnMsCgkJcmV0OwoKCWZvciggdmFyIGkgPSAwOyBpIDwgY2hlY2tfdmVuZHMubGVuZ3RoOyBpKysgKSB7CgkJY2hlY2tfc3R5bGUoIGNoZWNrX3ZlbmRzW2ldICk7Cgl9CglyZXR1cm4gISFyZXQ7Cn0KCi8vIFRoYW5rcyB0byBNb2Rlcm5penIgc3JjIGZvciB0aGlzIHRlc3QgaWRlYS4gYHBlcnNwZWN0aXZlYCBjaGVjayBpcyBsaW1pdGVkIHRvIE1veiB0byBwcmV2ZW50IGEgZmFsc2UgcG9zaXRpdmUgZm9yIDNEIHRyYW5zZm9ybXMgb24gQW5kcm9pZC4KZnVuY3Rpb24gdHJhbnNmb3JtM2RUZXN0KCkgewoJdmFyIHByb3AgPSAidHJhbnNmb3JtLTNkIjsKCXJldHVybiB2YWxpZFN0eWxlKCAncGVyc3BlY3RpdmUnLCAnMTBweCcsICdtb3onICkgfHwgJC5tb2JpbGUubWVkaWEoICIoLSIgKyB2ZW5kb3JzLmpvaW4oICItIiArIHByb3AgKyAiKSwoLSIgKSArICItIiArIHByb3AgKyAiKSwoIiArIHByb3AgKyAiKSIgKTsKfQoKLy8gVGVzdCBmb3IgZHluYW1pYy11cGRhdGluZyBiYXNlIHRhZyBzdXBwb3J0ICggYWxsb3dzIHVzIHRvIGF2b2lkIGhyZWYsc3JjIGF0dHIgcmV3cml0aW5nICkKZnVuY3Rpb24gYmFzZVRhZ1Rlc3QoKSB7Cgl2YXIgZmF1eEJhc2UgPSBsb2NhdGlvbi5wcm90b2NvbCArICIvLyIgKyBsb2NhdGlvbi5ob3N0ICsgbG9jYXRpb24ucGF0aG5hbWUgKyAidWktZGlyLyIsCgkJYmFzZSA9ICQoICJoZWFkIGJhc2UiICksCgkJZmF1eEVsZSA9IG51bGwsCgkJaHJlZiA9ICIiLAoJCWxpbmssIHJlYmFzZTsKCglpZiAoICFiYXNlLmxlbmd0aCApIHsKCQliYXNlID0gZmF1eEVsZSA9ICQoICI8YmFzZT4iLCB7ICJocmVmIjogZmF1eEJhc2UgfSkuYXBwZW5kVG8oICJoZWFkIiApOwoJfSBlbHNlIHsKCQlocmVmID0gYmFzZS5hdHRyKCAiaHJlZiIgKTsKCX0KCglsaW5rID0gJCggIjxhIGhyZWY9J3Rlc3R1cmwnIC8+IiApLnByZXBlbmRUbyggZmFrZUJvZHkgKTsKCXJlYmFzZSA9IGxpbmtbIDAgXS5ocmVmOwoJYmFzZVsgMCBdLmhyZWYgPSBocmVmIHx8IGxvY2F0aW9uLnBhdGhuYW1lOwoKCWlmICggZmF1eEVsZSApIHsKCQlmYXV4RWxlLnJlbW92ZSgpOwoJfQoJcmV0dXJuIHJlYmFzZS5pbmRleE9mKCBmYXV4QmFzZSApID09PSAwOwp9CgovLyBUaGFua3MgTW9kZXJuaXpyCmZ1bmN0aW9uIGNzc1BvaW50ZXJFdmVudHNUZXN0KCkgewoJdmFyIGVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAneCcgKSwKCQlkb2N1bWVudEVsZW1lbnQgPSBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQsCgkJZ2V0Q29tcHV0ZWRTdHlsZSA9IHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlLAoJCXN1cHBvcnRzOwoKCWlmICggISggJ3BvaW50ZXJFdmVudHMnIGluIGVsZW1lbnQuc3R5bGUgKSApIHsKCQlyZXR1cm4gZmFsc2U7Cgl9CgoJZWxlbWVudC5zdHlsZS5wb2ludGVyRXZlbnRzID0gJ2F1dG8nOwoJZWxlbWVudC5zdHlsZS5wb2ludGVyRXZlbnRzID0gJ3gnOwoJZG9jdW1lbnRFbGVtZW50LmFwcGVuZENoaWxkKCBlbGVtZW50ICk7CglzdXBwb3J0cyA9IGdldENvbXB1dGVkU3R5bGUgJiYKCWdldENvbXB1dGVkU3R5bGUoIGVsZW1lbnQsICcnICkucG9pbnRlckV2ZW50cyA9PT0gJ2F1dG8nOwoJZG9jdW1lbnRFbGVtZW50LnJlbW92ZUNoaWxkKCBlbGVtZW50ICk7CglyZXR1cm4gISFzdXBwb3J0czsKfQoKZnVuY3Rpb24gYm91bmRpbmdSZWN0KCkgewoJdmFyIGRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJkaXYiICk7CglyZXR1cm4gdHlwZW9mIGRpdi5nZXRCb3VuZGluZ0NsaWVudFJlY3QgIT09ICJ1bmRlZmluZWQiOwp9CgovLyBub24tVUEtYmFzZWQgSUUgdmVyc2lvbiBjaGVjayBieSBKYW1lcyBQYWRvbHNleSwgbW9kaWZpZWQgYnkgamRhbHRvbiAtIGZyb20gaHR0cDovL2dpc3QuZ2l0aHViLmNvbS81Mjc2ODMKLy8gYWxsb3dzIGZvciBpbmNsdXNpb24gb2YgSUUgNissIGluY2x1ZGluZyBXaW5kb3dzIE1vYmlsZSA3CiQuZXh0ZW5kKCAkLm1vYmlsZSwgeyBicm93c2VyOiB7fSB9ICk7CiQubW9iaWxlLmJyb3dzZXIuaWUgPSAoZnVuY3Rpb24oKSB7Cgl2YXIgdiA9IDMsCgkJZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImRpdiIgKSwKCQlhID0gZGl2LmFsbCB8fCBbXTsKCglkbyB7CgkJZGl2LmlubmVySFRNTCA9ICI8IS0tW2lmIGd0IElFICIgKyAoICsrdiApICsgIl0+PGJyPjwhW2VuZGlmXS0tPiI7Cgl9IHdoaWxlKCBhWzBdICk7CgoJcmV0dXJuIHYgPiA0ID8gdiA6ICF2Owp9KSgpOwoKCiQuZXh0ZW5kKCAkLnN1cHBvcnQsIHsKCWNzc1RyYW5zaXRpb25zOiAiV2ViS2l0VHJhbnNpdGlvbkV2ZW50IiBpbiB3aW5kb3cgfHwgdmFsaWRTdHlsZSggJ3RyYW5zaXRpb24nLCAnaGVpZ2h0IDEwMG1zIGxpbmVhcicgKSAmJiAhb3BlcmEsCglwdXNoU3RhdGU6ICJwdXNoU3RhdGUiIGluIGhpc3RvcnkgJiYgInJlcGxhY2VTdGF0ZSIgaW4gaGlzdG9yeSwKCW1lZGlhcXVlcnk6ICQubW9iaWxlLm1lZGlhKCAib25seSBhbGwiICksCgljc3NQc2V1ZG9FbGVtZW50OiAhIXByb3BFeGlzdHMoICJjb250ZW50IiApLAoJdG91Y2hPdmVyZmxvdzogISFwcm9wRXhpc3RzKCAib3ZlcmZsb3dTY3JvbGxpbmciICksCgljc3NUcmFuc2Zvcm0zZDogdHJhbnNmb3JtM2RUZXN0KCksCglib3hTaGFkb3c6ICEhcHJvcEV4aXN0cyggImJveFNoYWRvdyIgKSAmJiAhYmIsCglzY3JvbGxUb3A6ICggInBhZ2VYT2Zmc2V0IiBpbiB3aW5kb3cgfHwgInNjcm9sbFRvcCIgaW4gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50IHx8ICJzY3JvbGxUb3AiIGluIGZha2VCb2R5WyAwIF0gKSAmJiAhd2Vib3MgJiYgIW9wZXJhbWluaSwKCWR5bmFtaWNCYXNlVGFnOiBiYXNlVGFnVGVzdCgpLAoJY3NzUG9pbnRlckV2ZW50czogY3NzUG9pbnRlckV2ZW50c1Rlc3QoKSwKCWJvdW5kaW5nUmVjdDogYm91bmRpbmdSZWN0KCkKfSk7CgpmYWtlQm9keS5yZW1vdmUoKTsKCgovLyAkLm1vYmlsZS5hamF4QmxhY2tsaXN0IGlzIHVzZWQgdG8gb3ZlcnJpZGUgYWpheEVuYWJsZWQgb24gcGxhdGZvcm1zIHRoYXQgaGF2ZSBrbm93biBjb25mbGljdHMgd2l0aCBoYXNoIGhpc3RvcnkgdXBkYXRlcyAoQkI1LCBTeW1iaWFuKQovLyBvciB0aGF0IGdlbmVyYWxseSB3b3JrIGJldHRlciBicm93c2luZyBpbiByZWd1bGFyIGh0dHAgZm9yIGZ1bGwgcGFnZSByZWZyZXNoZXMgKE9wZXJhIE1pbmkpCi8vIE5vdGU6IFRoaXMgZGV0ZWN0aW9uIGJlbG93IGlzIHVzZWQgYXMgYSBsYXN0IHJlc29ydC4KLy8gV2UgcmVjb21tZW5kIG9ubHkgdXNpbmcgdGhlc2UgZGV0ZWN0aW9uIG1ldGhvZHMgd2hlbiBhbGwgb3RoZXIgbW9yZSByZWxpYWJsZS9mb3J3YXJkLWxvb2tpbmcgYXBwcm9hY2hlcyBhcmUgbm90IHBvc3NpYmxlCnZhciBub2tpYUxURTdfMyA9IChmdW5jdGlvbigpIHsKCgl2YXIgdWEgPSB3aW5kb3cubmF2aWdhdG9yLnVzZXJBZ2VudDsKCgkvL1RoZSBmb2xsb3dpbmcgaXMgYW4gYXR0ZW1wdCB0byBtYXRjaCBOb2tpYSBicm93c2VycyB0aGF0IGFyZSBydW5uaW5nIFN5bWJpYW4vczYwLCB3aXRoIHdlYmtpdCwgdmVyc2lvbiA3LjMgb3Igb2xkZXIKCXJldHVybiB1YS5pbmRleE9mKCAiTm9raWEiICkgPiAtMSAmJgoJCQkoIHVhLmluZGV4T2YoICJTeW1iaWFuLzMiICkgPiAtMSB8fCB1YS5pbmRleE9mKCAiU2VyaWVzNjAvNSIgKSA+IC0xICkgJiYKCQkJdWEuaW5kZXhPZiggIkFwcGxlV2ViS2l0IiApID4gLTEgJiYKCQkJdWEubWF0Y2goIC8oQnJvd3Nlck5HfE5va2lhQnJvd3NlcilcLzdcLlswLTNdLyApOwp9KSgpOwoKLy8gU3VwcG9ydCBjb25kaXRpb25zIHRoYXQgbXVzdCBiZSBtZXQgaW4gb3JkZXIgdG8gcHJvY2VlZAovLyBkZWZhdWx0IGVuaGFuY2VkIHF1YWxpZmljYXRpb25zIGFyZSBtZWRpYSBxdWVyeSBzdXBwb3J0IE9SIElFIDcrCgokLm1vYmlsZS5ncmFkZUEgPSBmdW5jdGlvbigpIHsKCXJldHVybiAoICQuc3VwcG9ydC5tZWRpYXF1ZXJ5IHx8ICQubW9iaWxlLmJyb3dzZXIuaWUgJiYgJC5tb2JpbGUuYnJvd3Nlci5pZSA+PSA3ICkgJiYgKCAkLnN1cHBvcnQuYm91bmRpbmdSZWN0IHx8ICQuZm4uanF1ZXJ5Lm1hdGNoKC8xXC5bMC03K11cLlswLTkrXT8vKSAhPT0gbnVsbCApOwp9OwoKJC5tb2JpbGUuYWpheEJsYWNrbGlzdCA9CgkJCS8vIEJsYWNrQmVycnkgYnJvd3NlcnMsIHByZS13ZWJraXQKCQkJd2luZG93LmJsYWNrYmVycnkgJiYgIXdpbmRvdy5XZWJLaXRQb2ludCB8fAoJCQkvLyBPcGVyYSBNaW5pCgkJCW9wZXJhbWluaSB8fAoJCQkvLyBTeW1iaWFuIHdlYmtpdHMgcHJlIDcuMwoJCQlub2tpYUxURTdfMzsKCi8vIExhc3RseSwgdGhpcyB3b3JrYXJvdW5kIGlzIHRoZSBvbmx5IHdheSB3ZSd2ZSBmb3VuZCBzbyBmYXIgdG8gZ2V0IHByZSA3LjMgU3ltYmlhbiB3ZWJraXQgZGV2aWNlcwovLyB0byByZW5kZXIgdGhlIHN0eWxlc2hlZXRzIHdoZW4gdGhleSdyZSByZWZlcmVuY2VkIGJlZm9yZSB0aGlzIHNjcmlwdCwgYXMgd2UnZCByZWNvbW1lbmQgZG9pbmcuCi8vIFRoaXMgc2ltcGx5IHJlYXBwZW5kcyB0aGUgQ1NTIGluIHBsYWNlLCB3aGljaCBmb3Igc29tZSByZWFzb24gbWFrZXMgaXQgYXBwbHkKaWYgKCBub2tpYUxURTdfMyApIHsKCSQoZnVuY3Rpb24oKSB7CgkJJCggImhlYWQgbGlua1tyZWw9J3N0eWxlc2hlZXQnXSIgKS5hdHRyKCAicmVsIiwgImFsdGVybmF0ZSBzdHlsZXNoZWV0IiApLmF0dHIoICJyZWwiLCAic3R5bGVzaGVldCIgKTsKCX0pOwp9CgovLyBGb3IgcnVsaW5nIG91dCBzaGFkb3dzIHZpYSBjc3MKaWYgKCAhJC5zdXBwb3J0LmJveFNoYWRvdyApIHsKCSQoICJodG1sIiApLmFkZENsYXNzKCAidWktbW9iaWxlLW5vc3VwcG9ydC1ib3hzaGFkb3ciICk7Cn0KCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUucGFnZSIsICQubW9iaWxlLndpZGdldCwgewoJb3B0aW9uczogewoJCXRoZW1lOiAiYyIsCgkJZG9tQ2FjaGU6IGZhbHNlLAoJCWtlZXBOYXRpdmVEZWZhdWx0OiAiOmpxbURhdGEocm9sZT0nbm9uZScpLCA6anFtRGF0YShyb2xlPSdub2pzJykiCgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCQoJCXZhciBzZWxmID0gdGhpczsKCQkKCQkvLyBpZiBmYWxzZSBpcyByZXR1cm5lZCBieSB0aGUgY2FsbGJhY2tzIGRvIG5vdCBjcmVhdGUgdGhlIHBhZ2UKCQlpZiAoIHNlbGYuX3RyaWdnZXIoICJiZWZvcmVjcmVhdGUiICkgPT09IGZhbHNlICkgewoJCQlyZXR1cm4gZmFsc2U7CgkJfQoKCQlzZWxmLmVsZW1lbnQKCQkJLmF0dHIoICJ0YWJpbmRleCIsICIwIiApCgkJCS5hZGRDbGFzcyggInVpLXBhZ2UgdWktYm9keS0iICsgc2VsZi5vcHRpb25zLnRoZW1lICkKCQkJLmJpbmQoICJwYWdlYmVmb3JlaGlkZSIsIGZ1bmN0aW9uKCkgewoJCQkJc2VsZi5yZW1vdmVDb250YWluZXJCYWNrZ3JvdW5kKCk7CgkJCX0gKQoJCQkuYmluZCggInBhZ2ViZWZvcmVzaG93IiwgZnVuY3Rpb24oKSB7CgkJCQlzZWxmLnNldENvbnRhaW5lckJhY2tncm91bmQoKTsKCQkJfSApOwoKCX0sCgkKCXJlbW92ZUNvbnRhaW5lckJhY2tncm91bmQ6IGZ1bmN0aW9uKCkgewoJCSQubW9iaWxlLnBhZ2VDb250YWluZXIucmVtb3ZlQ2xhc3MoICJ1aS1vdmVybGF5LSIgKyAkLm1vYmlsZS5nZXRJbmhlcml0ZWRUaGVtZSggdGhpcy5lbGVtZW50LnBhcmVudCgpICkgKTsKCX0sCgkKCS8vIHNldCB0aGUgcGFnZSBjb250YWluZXIgYmFja2dyb3VuZCB0byB0aGUgcGFnZSB0aGVtZQoJc2V0Q29udGFpbmVyQmFja2dyb3VuZDogZnVuY3Rpb24oIHRoZW1lICkgewoJCWlmICggdGhpcy5vcHRpb25zLnRoZW1lICkgewoJCQkkLm1vYmlsZS5wYWdlQ29udGFpbmVyLmFkZENsYXNzKCAidWktb3ZlcmxheS0iICsgKCB0aGVtZSB8fCB0aGlzLm9wdGlvbnMudGhlbWUgKSApOwoJCX0KCX0sCgoJa2VlcE5hdGl2ZVNlbGVjdG9yOiBmdW5jdGlvbigpIHsKCQl2YXIgb3B0aW9ucyA9IHRoaXMub3B0aW9ucywKCQkJa2VlcE5hdGl2ZURlZmluZWQgPSBvcHRpb25zLmtlZXBOYXRpdmUgJiYgJC50cmltKCBvcHRpb25zLmtlZXBOYXRpdmUgKTsKCgkJaWYgKCBrZWVwTmF0aXZlRGVmaW5lZCAmJiBvcHRpb25zLmtlZXBOYXRpdmUgIT09IG9wdGlvbnMua2VlcE5hdGl2ZURlZmF1bHQgKSB7CgkJCXJldHVybiBbb3B0aW9ucy5rZWVwTmF0aXZlLCBvcHRpb25zLmtlZXBOYXRpdmVEZWZhdWx0XS5qb2luKCAiLCAiICk7CgkJfQoKCQlyZXR1cm4gb3B0aW9ucy5rZWVwTmF0aXZlRGVmYXVsdDsKCX0KfSk7Cn0pKCBqUXVlcnkgKTsKCi8vIFNjcmlwdDogalF1ZXJ5IGhhc2hjaGFuZ2UgZXZlbnQKLy8gCi8vICpWZXJzaW9uOiAxLjMsIExhc3QgdXBkYXRlZDogNy8yMS8yMDEwKgovLyAKLy8gUHJvamVjdCBIb21lIC0gaHR0cDovL2JlbmFsbWFuLmNvbS9wcm9qZWN0cy9qcXVlcnktaGFzaGNoYW5nZS1wbHVnaW4vCi8vIEdpdEh1YiAgICAgICAtIGh0dHA6Ly9naXRodWIuY29tL2Nvd2JveS9qcXVlcnktaGFzaGNoYW5nZS8KLy8gU291cmNlICAgICAgIC0gaHR0cDovL2dpdGh1Yi5jb20vY293Ym95L2pxdWVyeS1oYXNoY2hhbmdlL3Jhdy9tYXN0ZXIvanF1ZXJ5LmJhLWhhc2hjaGFuZ2UuanMKLy8gKE1pbmlmaWVkKSAgIC0gaHR0cDovL2dpdGh1Yi5jb20vY293Ym95L2pxdWVyeS1oYXNoY2hhbmdlL3Jhdy9tYXN0ZXIvanF1ZXJ5LmJhLWhhc2hjaGFuZ2UubWluLmpzICgwLjhrYiBnemlwcGVkKQovLyAKLy8gQWJvdXQ6IExpY2Vuc2UKLy8gCi8vIENvcHlyaWdodCAoYykgMjAxMCAiQ293Ym95IiBCZW4gQWxtYW4sCi8vIER1YWwgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBhbmQgR1BMIGxpY2Vuc2VzLgovLyBodHRwOi8vYmVuYWxtYW4uY29tL2Fib3V0L2xpY2Vuc2UvCi8vIAovLyBBYm91dDogRXhhbXBsZXMKLy8gCi8vIFRoZXNlIHdvcmtpbmcgZXhhbXBsZXMsIGNvbXBsZXRlIHdpdGggZnVsbHkgY29tbWVudGVkIGNvZGUsIGlsbHVzdHJhdGUgYSBmZXcKLy8gd2F5cyBpbiB3aGljaCB0aGlzIHBsdWdpbiBjYW4gYmUgdXNlZC4KLy8gCi8vIGhhc2hjaGFuZ2UgZXZlbnQgLSBodHRwOi8vYmVuYWxtYW4uY29tL2NvZGUvcHJvamVjdHMvanF1ZXJ5LWhhc2hjaGFuZ2UvZXhhbXBsZXMvaGFzaGNoYW5nZS8KLy8gZG9jdW1lbnQuZG9tYWluIC0gaHR0cDovL2JlbmFsbWFuLmNvbS9jb2RlL3Byb2plY3RzL2pxdWVyeS1oYXNoY2hhbmdlL2V4YW1wbGVzL2RvY3VtZW50X2RvbWFpbi8KLy8gCi8vIEFib3V0OiBTdXBwb3J0IGFuZCBUZXN0aW5nCi8vIAovLyBJbmZvcm1hdGlvbiBhYm91dCB3aGF0IHZlcnNpb24gb3IgdmVyc2lvbnMgb2YgalF1ZXJ5IHRoaXMgcGx1Z2luIGhhcyBiZWVuCi8vIHRlc3RlZCB3aXRoLCB3aGF0IGJyb3dzZXJzIGl0IGhhcyBiZWVuIHRlc3RlZCBpbiwgYW5kIHdoZXJlIHRoZSB1bml0IHRlc3RzCi8vIHJlc2lkZSAoc28geW91IGNhbiB0ZXN0IGl0IHlvdXJzZWxmKS4KLy8gCi8vIGpRdWVyeSBWZXJzaW9ucyAtIDEuMi42LCAxLjMuMiwgMS40LjEsIDEuNC4yCi8vIEJyb3dzZXJzIFRlc3RlZCAtIEludGVybmV0IEV4cGxvcmVyIDYtOCwgRmlyZWZveCAyLTQsIENocm9tZSA1LTYsIFNhZmFyaSAzLjItNSwKLy8gICAgICAgICAgICAgICAgICAgT3BlcmEgOS42LTEwLjYwLCBpUGhvbmUgMy4xLCBBbmRyb2lkIDEuNi0yLjIsIEJsYWNrQmVycnkgNC42LTUuCi8vIFVuaXQgVGVzdHMgICAgICAtIGh0dHA6Ly9iZW5hbG1hbi5jb20vY29kZS9wcm9qZWN0cy9qcXVlcnktaGFzaGNoYW5nZS91bml0LwovLyAKLy8gQWJvdXQ6IEtub3duIGlzc3VlcwovLyAKLy8gV2hpbGUgdGhpcyBqUXVlcnkgaGFzaGNoYW5nZSBldmVudCBpbXBsZW1lbnRhdGlvbiBpcyBxdWl0ZSBzdGFibGUgYW5kCi8vIHJvYnVzdCwgdGhlcmUgYXJlIGEgZmV3IHVuZm9ydHVuYXRlIGJyb3dzZXIgYnVncyBzdXJyb3VuZGluZyBleHBlY3RlZAovLyBoYXNoY2hhbmdlIGV2ZW50LWJhc2VkIGJlaGF2aW9ycywgaW5kZXBlbmRlbnQgb2YgYW55IEphdmFTY3JpcHQKLy8gd2luZG93Lm9uaGFzaGNoYW5nZSBhYnN0cmFjdGlvbi4gU2VlIHRoZSBmb2xsb3dpbmcgZXhhbXBsZXMgZm9yIG1vcmUKLy8gaW5mb3JtYXRpb246Ci8vIAovLyBDaHJvbWU6IEJhY2sgQnV0dG9uIC0gaHR0cDovL2JlbmFsbWFuLmNvbS9jb2RlL3Byb2plY3RzL2pxdWVyeS1oYXNoY2hhbmdlL2V4YW1wbGVzL2J1Zy1jaHJvbWUtYmFjay1idXR0b24vCi8vIEZpcmVmb3g6IFJlbW90ZSBYTUxIdHRwUmVxdWVzdCAtIGh0dHA6Ly9iZW5hbG1hbi5jb20vY29kZS9wcm9qZWN0cy9qcXVlcnktaGFzaGNoYW5nZS9leGFtcGxlcy9idWctZmlyZWZveC1yZW1vdGUteGhyLwovLyBXZWJLaXQ6IEJhY2sgQnV0dG9uIGluIGFuIElmcmFtZSAtIGh0dHA6Ly9iZW5hbG1hbi5jb20vY29kZS9wcm9qZWN0cy9qcXVlcnktaGFzaGNoYW5nZS9leGFtcGxlcy9idWctd2Via2l0LWhhc2gtaWZyYW1lLwovLyBTYWZhcmk6IEJhY2sgQnV0dG9uIGZyb20gYSBkaWZmZXJlbnQgZG9tYWluIC0gaHR0cDovL2JlbmFsbWFuLmNvbS9jb2RlL3Byb2plY3RzL2pxdWVyeS1oYXNoY2hhbmdlL2V4YW1wbGVzL2J1Zy1zYWZhcmktYmFjay1mcm9tLWRpZmYtZG9tYWluLwovLyAKLy8gQWxzbyBub3RlIHRoYXQgc2hvdWxkIGEgYnJvd3NlciBuYXRpdmVseSBzdXBwb3J0IHRoZSB3aW5kb3cub25oYXNoY2hhbmdlIAovLyBldmVudCwgYnV0IG5vdCByZXBvcnQgdGhhdCBpdCBkb2VzLCB0aGUgZmFsbGJhY2sgcG9sbGluZyBsb29wIHdpbGwgYmUgdXNlZC4KLy8gCi8vIEFib3V0OiBSZWxlYXNlIEhpc3RvcnkKLy8gCi8vIDEuMyAgIC0gKDcvMjEvMjAxMCkgUmVvcmdhbml6ZWQgSUU2LzcgSWZyYW1lIGNvZGUgdG8gbWFrZSBpdCBtb3JlCi8vICAgICAgICAgInJlbW92YWJsZSIgZm9yIG1vYmlsZS1vbmx5IGRldmVsb3BtZW50LiBBZGRlZCBJRTYvNyBkb2N1bWVudC50aXRsZQovLyAgICAgICAgIHN1cHBvcnQuIEF0dGVtcHRlZCB0byBtYWtlIElmcmFtZSBhcyBoaWRkZW4gYXMgcG9zc2libGUgYnkgdXNpbmcKLy8gICAgICAgICB0ZWNobmlxdWVzIGZyb20gaHR0cDovL3d3dy5wYWNpZWxsb2dyb3VwLmNvbS9ibG9nLz9wPTYwNC4gQWRkZWQgCi8vICAgICAgICAgc3VwcG9ydCBmb3IgdGhlICJzaG9ydGN1dCIgZm9ybWF0ICQod2luZG93KS5oYXNoY2hhbmdlKCBmbiApIGFuZAovLyAgICAgICAgICQod2luZG93KS5oYXNoY2hhbmdlKCkgbGlrZSBqUXVlcnkgcHJvdmlkZXMgZm9yIGJ1aWx0LWluIGV2ZW50cy4KLy8gICAgICAgICBSZW5hbWVkIGpRdWVyeS5oYXNoY2hhbmdlRGVsYXkgdG8gPGpRdWVyeS5mbi5oYXNoY2hhbmdlLmRlbGF5PiBhbmQKLy8gICAgICAgICBsb3dlcmVkIGl0cyBkZWZhdWx0IHZhbHVlIHRvIDUwLiBBZGRlZCA8alF1ZXJ5LmZuLmhhc2hjaGFuZ2UuZG9tYWluPgovLyAgICAgICAgIGFuZCA8alF1ZXJ5LmZuLmhhc2hjaGFuZ2Uuc3JjPiBwcm9wZXJ0aWVzIHBsdXMgZG9jdW1lbnQtZG9tYWluLmh0bWwKLy8gICAgICAgICBmaWxlIHRvIGFkZHJlc3MgYWNjZXNzIGRlbmllZCBpc3N1ZXMgd2hlbiBzZXR0aW5nIGRvY3VtZW50LmRvbWFpbiBpbgovLyAgICAgICAgIElFNi83LgovLyAxLjIgICAtICgyLzExLzIwMTApIEZpeGVkIGEgYnVnIHdoZXJlIGNvbWluZyBiYWNrIHRvIGEgcGFnZSB1c2luZyB0aGlzIHBsdWdpbgovLyAgICAgICAgIGZyb20gYSBwYWdlIG9uIGFub3RoZXIgZG9tYWluIHdvdWxkIGNhdXNlIGFuIGVycm9yIGluIFNhZmFyaSA0LiBBbHNvLAovLyAgICAgICAgIElFNi83IElmcmFtZSBpcyBub3cgaW5zZXJ0ZWQgYWZ0ZXIgdGhlIGJvZHkgKHRoaXMgYWN0dWFsbHkgd29ya3MpLAovLyAgICAgICAgIHdoaWNoIHByZXZlbnRzIHRoZSBwYWdlIGZyb20gc2Nyb2xsaW5nIHdoZW4gdGhlIGV2ZW50IGlzIGZpcnN0IGJvdW5kLgovLyAgICAgICAgIEV2ZW50IGNhbiBhbHNvIG5vdyBiZSBib3VuZCBiZWZvcmUgRE9NIHJlYWR5LCBidXQgaXQgd29uJ3QgYmUgdXNhYmxlCi8vICAgICAgICAgYmVmb3JlIHRoZW4gaW4gSUU2LzcuCi8vIDEuMSAgIC0gKDEvMjEvMjAxMCkgSW5jb3Jwb3JhdGVkIGRvY3VtZW50LmRvY3VtZW50TW9kZSB0ZXN0IHRvIGZpeCBJRTggYnVnCi8vICAgICAgICAgd2hlcmUgYnJvd3NlciB2ZXJzaW9uIGlzIGluY29ycmVjdGx5IHJlcG9ydGVkIGFzIDguMCwgZGVzcGl0ZQovLyAgICAgICAgIGluY2x1c2lvbiBvZiB0aGUgWC1VQS1Db21wYXRpYmxlIElFPUVtdWxhdGVJRTcgbWV0YSB0YWcuCi8vIDEuMCAgIC0gKDEvOS8yMDEwKSBJbml0aWFsIFJlbGVhc2UuIEJyb2tlIG91dCB0aGUgalF1ZXJ5IEJCUSBldmVudC5zcGVjaWFsCi8vICAgICAgICAgd2luZG93Lm9uaGFzaGNoYW5nZSBmdW5jdGlvbmFsaXR5IGludG8gYSBzZXBhcmF0ZSBwbHVnaW4gZm9yIHVzZXJzCi8vICAgICAgICAgd2hvIHdhbnQganVzdCB0aGUgYmFzaWMgZXZlbnQgJiBiYWNrIGJ1dHRvbiBzdXBwb3J0LCB3aXRob3V0IGFsbCB0aGUKLy8gICAgICAgICBleHRyYSBhd2Vzb21lbmVzcyB0aGF0IEJCUSBwcm92aWRlcy4gVGhpcyBwbHVnaW4gd2lsbCBiZSBpbmNsdWRlZCBhcwovLyAgICAgICAgIHBhcnQgb2YgalF1ZXJ5IEJCUSwgYnV0IGFsc28gYmUgYXZhaWxhYmxlIHNlcGFyYXRlbHkuCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewogIC8vIFJldXNlZCBzdHJpbmcuCiAgdmFyIHN0cl9oYXNoY2hhbmdlID0gJ2hhc2hjaGFuZ2UnLAogICAgCiAgICAvLyBNZXRob2QgLyBvYmplY3QgcmVmZXJlbmNlcy4KICAgIGRvYyA9IGRvY3VtZW50LAogICAgZmFrZV9vbmhhc2hjaGFuZ2UsCiAgICBzcGVjaWFsID0gJC5ldmVudC5zcGVjaWFsLAogICAgCiAgICAvLyBEb2VzIHRoZSBicm93c2VyIHN1cHBvcnQgd2luZG93Lm9uaGFzaGNoYW5nZT8gTm90ZSB0aGF0IElFOCBydW5uaW5nIGluCiAgICAvLyBJRTcgY29tcGF0aWJpbGl0eSBtb2RlIHJlcG9ydHMgdHJ1ZSBmb3IgJ29uaGFzaGNoYW5nZScgaW4gd2luZG93LCBldmVuCiAgICAvLyB0aG91Z2ggdGhlIGV2ZW50IGlzbid0IHN1cHBvcnRlZCwgc28gYWxzbyB0ZXN0IGRvY3VtZW50LmRvY3VtZW50TW9kZS4KICAgIGRvY19tb2RlID0gZG9jLmRvY3VtZW50TW9kZSwKICAgIHN1cHBvcnRzX29uaGFzaGNoYW5nZSA9ICdvbicgKyBzdHJfaGFzaGNoYW5nZSBpbiB3aW5kb3cgJiYgKCBkb2NfbW9kZSA9PT0gdW5kZWZpbmVkIHx8IGRvY19tb2RlID4gNyApOwogIAogIC8vIEdldCBsb2NhdGlvbi5oYXNoIChvciB3aGF0IHlvdSdkIGV4cGVjdCBsb2NhdGlvbi5oYXNoIHRvIGJlKSBzYW5zIGFueQogIC8vIGxlYWRpbmcgIy4gVGhhbmtzIGZvciBtYWtpbmcgdGhpcyBuZWNlc3NhcnksIEZpcmVmb3ghCiAgZnVuY3Rpb24gZ2V0X2ZyYWdtZW50KCB1cmwgKSB7CiAgICB1cmwgPSB1cmwgfHwgbG9jYXRpb24uaHJlZjsKICAgIHJldHVybiAnIycgKyB1cmwucmVwbGFjZSggL15bXiNdKiM/KC4qKSQvLCAnJDEnICk7CiAgfTsKICAKICAvLyBNZXRob2Q6IGpRdWVyeS5mbi5oYXNoY2hhbmdlCiAgLy8gCiAgLy8gQmluZCBhIGhhbmRsZXIgdG8gdGhlIHdpbmRvdy5vbmhhc2hjaGFuZ2UgZXZlbnQgb3IgdHJpZ2dlciBhbGwgYm91bmQKICAvLyB3aW5kb3cub25oYXNoY2hhbmdlIGV2ZW50IGhhbmRsZXJzLiBUaGlzIGJlaGF2aW9yIGlzIGNvbnNpc3RlbnQgd2l0aAogIC8vIGpRdWVyeSdzIGJ1aWx0LWluIGV2ZW50IGhhbmRsZXJzLgogIC8vIAogIC8vIFVzYWdlOgogIC8vIAogIC8vID4galF1ZXJ5KHdpbmRvdykuaGFzaGNoYW5nZSggWyBoYW5kbGVyIF0gKTsKICAvLyAKICAvLyBBcmd1bWVudHM6CiAgLy8gCiAgLy8gIGhhbmRsZXIgLSAoRnVuY3Rpb24pIE9wdGlvbmFsIGhhbmRsZXIgdG8gYmUgYm91bmQgdG8gdGhlIGhhc2hjaGFuZ2UKICAvLyAgICBldmVudC4gVGhpcyBpcyBhICJzaG9ydGN1dCIgZm9yIHRoZSBtb3JlIHZlcmJvc2UgZm9ybToKICAvLyAgICBqUXVlcnkod2luZG93KS5iaW5kKCAnaGFzaGNoYW5nZScsIGhhbmRsZXIgKS4gSWYgaGFuZGxlciBpcyBvbWl0dGVkLAogIC8vICAgIGFsbCBib3VuZCB3aW5kb3cub25oYXNoY2hhbmdlIGV2ZW50IGhhbmRsZXJzIHdpbGwgYmUgdHJpZ2dlcmVkLiBUaGlzCiAgLy8gICAgaXMgYSBzaG9ydGN1dCBmb3IgdGhlIG1vcmUgdmVyYm9zZQogIC8vICAgIGpRdWVyeSh3aW5kb3cpLnRyaWdnZXIoICdoYXNoY2hhbmdlJyApLiBUaGVzZSBmb3JtcyBhcmUgZGVzY3JpYmVkIGluCiAgLy8gICAgdGhlIDxoYXNoY2hhbmdlIGV2ZW50PiBzZWN0aW9uLgogIC8vIAogIC8vIFJldHVybnM6CiAgLy8gCiAgLy8gIChqUXVlcnkpIFRoZSBpbml0aWFsIGpRdWVyeSBjb2xsZWN0aW9uIG9mIGVsZW1lbnRzLgogIAogIC8vIEFsbG93IHRoZSAic2hvcnRjdXQiIGZvcm1hdCAkKGVsZW0pLmhhc2hjaGFuZ2UoIGZuICkgZm9yIGJpbmRpbmcgYW5kCiAgLy8gJChlbGVtKS5oYXNoY2hhbmdlKCkgZm9yIHRyaWdnZXJpbmcsIGxpa2UgalF1ZXJ5IGRvZXMgZm9yIGJ1aWx0LWluIGV2ZW50cy4KICAkLmZuWyBzdHJfaGFzaGNoYW5nZSBdID0gZnVuY3Rpb24oIGZuICkgewogICAgcmV0dXJuIGZuID8gdGhpcy5iaW5kKCBzdHJfaGFzaGNoYW5nZSwgZm4gKSA6IHRoaXMudHJpZ2dlciggc3RyX2hhc2hjaGFuZ2UgKTsKICB9OwogIAogIC8vIFByb3BlcnR5OiBqUXVlcnkuZm4uaGFzaGNoYW5nZS5kZWxheQogIC8vIAogIC8vIFRoZSBudW1lcmljIGludGVydmFsIChpbiBtaWxsaXNlY29uZHMpIGF0IHdoaWNoIHRoZSA8aGFzaGNoYW5nZSBldmVudD4KICAvLyBwb2xsaW5nIGxvb3AgZXhlY3V0ZXMuIERlZmF1bHRzIHRvIDUwLgogIAogIC8vIFByb3BlcnR5OiBqUXVlcnkuZm4uaGFzaGNoYW5nZS5kb21haW4KICAvLyAKICAvLyBJZiB5b3UncmUgc2V0dGluZyBkb2N1bWVudC5kb21haW4gaW4geW91ciBKYXZhU2NyaXB0LCBhbmQgeW91IHdhbnQgaGFzaAogIC8vIGhpc3RvcnkgdG8gd29yayBpbiBJRTYvNywgbm90IG9ubHkgbXVzdCB0aGlzIHByb3BlcnR5IGJlIHNldCwgYnV0IHlvdSBtdXN0CiAgLy8gYWxzbyBzZXQgZG9jdW1lbnQuZG9tYWluIEJFRk9SRSBqUXVlcnkgaXMgbG9hZGVkIGludG8gdGhlIHBhZ2UuIFRoaXMKICAvLyBwcm9wZXJ0eSBpcyBvbmx5IGFwcGxpY2FibGUgaWYgeW91IGFyZSBzdXBwb3J0aW5nIElFNi83IChvciBJRTggb3BlcmF0aW5nCiAgLy8gaW4gIklFNyBjb21wYXRpYmlsaXR5IiBtb2RlKS4KICAvLyAKICAvLyBJbiBhZGRpdGlvbiwgdGhlIDxqUXVlcnkuZm4uaGFzaGNoYW5nZS5zcmM+IHByb3BlcnR5IG11c3QgYmUgc2V0IHRvIHRoZQogIC8vIHBhdGggb2YgdGhlIGluY2x1ZGVkICJkb2N1bWVudC1kb21haW4uaHRtbCIgZmlsZSwgd2hpY2ggY2FuIGJlIHJlbmFtZWQgb3IKICAvLyBtb2RpZmllZCBpZiBuZWNlc3NhcnkgKG5vdGUgdGhhdCB0aGUgZG9jdW1lbnQuZG9tYWluIHNwZWNpZmllZCBtdXN0IGJlIHRoZQogIC8vIHNhbWUgaW4gYm90aCB5b3VyIG1haW4gSmF2YVNjcmlwdCBhcyB3ZWxsIGFzIGluIHRoaXMgZmlsZSkuCiAgLy8gCiAgLy8gVXNhZ2U6CiAgLy8gCiAgLy8galF1ZXJ5LmZuLmhhc2hjaGFuZ2UuZG9tYWluID0gZG9jdW1lbnQuZG9tYWluOwogIAogIC8vIFByb3BlcnR5OiBqUXVlcnkuZm4uaGFzaGNoYW5nZS5zcmMKICAvLyAKICAvLyBJZiwgZm9yIHNvbWUgcmVhc29uLCB5b3UgbmVlZCB0byBzcGVjaWZ5IGFuIElmcmFtZSBzcmMgZmlsZSAoZm9yIGV4YW1wbGUsCiAgLy8gd2hlbiBzZXR0aW5nIGRvY3VtZW50LmRvbWFpbiBhcyBpbiA8alF1ZXJ5LmZuLmhhc2hjaGFuZ2UuZG9tYWluPiksIHlvdSBjYW4KICAvLyBkbyBzbyB1c2luZyB0aGlzIHByb3BlcnR5LiBOb3RlIHRoYXQgd2hlbiB1c2luZyB0aGlzIHByb3BlcnR5LCBoaXN0b3J5CiAgLy8gd29uJ3QgYmUgcmVjb3JkZWQgaW4gSUU2LzcgdW50aWwgdGhlIElmcmFtZSBzcmMgZmlsZSBsb2Fkcy4gVGhpcyBwcm9wZXJ0eQogIC8vIGlzIG9ubHkgYXBwbGljYWJsZSBpZiB5b3UgYXJlIHN1cHBvcnRpbmcgSUU2LzcgKG9yIElFOCBvcGVyYXRpbmcgaW4gIklFNwogIC8vIGNvbXBhdGliaWxpdHkiIG1vZGUpLgogIC8vIAogIC8vIFVzYWdlOgogIC8vIAogIC8vIGpRdWVyeS5mbi5oYXNoY2hhbmdlLnNyYyA9ICdwYXRoL3RvL2ZpbGUuaHRtbCc7CiAgCiAgJC5mblsgc3RyX2hhc2hjaGFuZ2UgXS5kZWxheSA9IDUwOwogIC8qCiAgJC5mblsgc3RyX2hhc2hjaGFuZ2UgXS5kb21haW4gPSBudWxsOwogICQuZm5bIHN0cl9oYXNoY2hhbmdlIF0uc3JjID0gbnVsbDsKICAqLwogIAogIC8vIEV2ZW50OiBoYXNoY2hhbmdlIGV2ZW50CiAgLy8gCiAgLy8gRmlyZWQgd2hlbiBsb2NhdGlvbi5oYXNoIGNoYW5nZXMuIEluIGJyb3dzZXJzIHRoYXQgc3VwcG9ydCBpdCwgdGhlIG5hdGl2ZQogIC8vIEhUTUw1IHdpbmRvdy5vbmhhc2hjaGFuZ2UgZXZlbnQgaXMgdXNlZCwgb3RoZXJ3aXNlIGEgcG9sbGluZyBsb29wIGlzCiAgLy8gaW5pdGlhbGl6ZWQsIHJ1bm5pbmcgZXZlcnkgPGpRdWVyeS5mbi5oYXNoY2hhbmdlLmRlbGF5PiBtaWxsaXNlY29uZHMgdG8KICAvLyBzZWUgaWYgdGhlIGhhc2ggaGFzIGNoYW5nZWQuIEluIElFNi83IChhbmQgSUU4IG9wZXJhdGluZyBpbiAiSUU3CiAgLy8gY29tcGF0aWJpbGl0eSIgbW9kZSksIGEgaGlkZGVuIElmcmFtZSBpcyBjcmVhdGVkIHRvIGFsbG93IHRoZSBiYWNrIGJ1dHRvbgogIC8vIGFuZCBoYXNoLWJhc2VkIGhpc3RvcnkgdG8gd29yay4KICAvLyAKICAvLyBVc2FnZSBhcyBkZXNjcmliZWQgaW4gPGpRdWVyeS5mbi5oYXNoY2hhbmdlPjoKICAvLyAKICAvLyA+IC8vIEJpbmQgYW4gZXZlbnQgaGFuZGxlci4KICAvLyA+IGpRdWVyeSh3aW5kb3cpLmhhc2hjaGFuZ2UoIGZ1bmN0aW9uKGUpIHsKICAvLyA+ICAgdmFyIGhhc2ggPSBsb2NhdGlvbi5oYXNoOwogIC8vID4gICAuLi4KICAvLyA+IH0pOwogIC8vID4gCiAgLy8gPiAvLyBNYW51YWxseSB0cmlnZ2VyIHRoZSBldmVudCBoYW5kbGVyLgogIC8vID4galF1ZXJ5KHdpbmRvdykuaGFzaGNoYW5nZSgpOwogIC8vIAogIC8vIEEgbW9yZSB2ZXJib3NlIHVzYWdlIHRoYXQgYWxsb3dzIGZvciBldmVudCBuYW1lc3BhY2luZzoKICAvLyAKICAvLyA+IC8vIEJpbmQgYW4gZXZlbnQgaGFuZGxlci4KICAvLyA+IGpRdWVyeSh3aW5kb3cpLmJpbmQoICdoYXNoY2hhbmdlJywgZnVuY3Rpb24oZSkgewogIC8vID4gICB2YXIgaGFzaCA9IGxvY2F0aW9uLmhhc2g7CiAgLy8gPiAgIC4uLgogIC8vID4gfSk7CiAgLy8gPiAKICAvLyA+IC8vIE1hbnVhbGx5IHRyaWdnZXIgdGhlIGV2ZW50IGhhbmRsZXIuCiAgLy8gPiBqUXVlcnkod2luZG93KS50cmlnZ2VyKCAnaGFzaGNoYW5nZScgKTsKICAvLyAKICAvLyBBZGRpdGlvbmFsIE5vdGVzOgogIC8vIAogIC8vICogVGhlIHBvbGxpbmcgbG9vcCBhbmQgSWZyYW1lIGFyZSBub3QgY3JlYXRlZCB1bnRpbCBhdCBsZWFzdCBvbmUgaGFuZGxlcgogIC8vICAgaXMgYWN0dWFsbHkgYm91bmQgdG8gdGhlICdoYXNoY2hhbmdlJyBldmVudC4KICAvLyAqIElmIHlvdSBuZWVkIHRoZSBib3VuZCBoYW5kbGVyKHMpIHRvIGV4ZWN1dGUgaW1tZWRpYXRlbHksIGluIGNhc2VzIHdoZXJlCiAgLy8gICBhIGxvY2F0aW9uLmhhc2ggZXhpc3RzIG9uIHBhZ2UgbG9hZCwgdmlhIGJvb2ttYXJrIG9yIHBhZ2UgcmVmcmVzaCBmb3IKICAvLyAgIGV4YW1wbGUsIHVzZSBqUXVlcnkod2luZG93KS5oYXNoY2hhbmdlKCkgb3IgdGhlIG1vcmUgdmVyYm9zZSAKICAvLyAgIGpRdWVyeSh3aW5kb3cpLnRyaWdnZXIoICdoYXNoY2hhbmdlJyApLgogIC8vICogVGhlIGV2ZW50IGNhbiBiZSBib3VuZCBiZWZvcmUgRE9NIHJlYWR5LCBidXQgc2luY2UgaXQgd29uJ3QgYmUgdXNhYmxlCiAgLy8gICBiZWZvcmUgdGhlbiBpbiBJRTYvNyAoZHVlIHRvIHRoZSBuZWNlc3NhcnkgSWZyYW1lKSwgcmVjb21tZW5kZWQgdXNhZ2UgaXMKICAvLyAgIHRvIGJpbmQgaXQgaW5zaWRlIGEgRE9NIHJlYWR5IGhhbmRsZXIuCiAgCiAgLy8gT3ZlcnJpZGUgZXhpc3RpbmcgJC5ldmVudC5zcGVjaWFsLmhhc2hjaGFuZ2UgbWV0aG9kcyAoYWxsb3dpbmcgdGhpcyBwbHVnaW4KICAvLyB0byBiZSBkZWZpbmVkIGFmdGVyIGpRdWVyeSBCQlEgaW4gQkJRJ3Mgc291cmNlIGNvZGUpLgogIHNwZWNpYWxbIHN0cl9oYXNoY2hhbmdlIF0gPSAkLmV4dGVuZCggc3BlY2lhbFsgc3RyX2hhc2hjaGFuZ2UgXSwgewogICAgCiAgICAvLyBDYWxsZWQgb25seSB3aGVuIHRoZSBmaXJzdCAnaGFzaGNoYW5nZScgZXZlbnQgaXMgYm91bmQgdG8gd2luZG93LgogICAgc2V0dXA6IGZ1bmN0aW9uKCkgewogICAgICAvLyBJZiB3aW5kb3cub25oYXNoY2hhbmdlIGlzIHN1cHBvcnRlZCBuYXRpdmVseSwgdGhlcmUncyBub3RoaW5nIHRvIGRvLi4KICAgICAgaWYgKCBzdXBwb3J0c19vbmhhc2hjaGFuZ2UgKSB7IHJldHVybiBmYWxzZTsgfQogICAgICAKICAgICAgLy8gT3RoZXJ3aXNlLCB3ZSBuZWVkIHRvIGNyZWF0ZSBvdXIgb3duLiBBbmQgd2UgZG9uJ3Qgd2FudCB0byBjYWxsIHRoaXMKICAgICAgLy8gdW50aWwgdGhlIHVzZXIgYmluZHMgdG8gdGhlIGV2ZW50LCBqdXN0IGluIGNhc2UgdGhleSBuZXZlciBkbywgc2luY2UgaXQKICAgICAgLy8gd2lsbCBjcmVhdGUgYSBwb2xsaW5nIGxvb3AgYW5kIHBvc3NpYmx5IGV2ZW4gYSBoaWRkZW4gSWZyYW1lLgogICAgICAkKCBmYWtlX29uaGFzaGNoYW5nZS5zdGFydCApOwogICAgfSwKICAgIAogICAgLy8gQ2FsbGVkIG9ubHkgd2hlbiB0aGUgbGFzdCAnaGFzaGNoYW5nZScgZXZlbnQgaXMgdW5ib3VuZCBmcm9tIHdpbmRvdy4KICAgIHRlYXJkb3duOiBmdW5jdGlvbigpIHsKICAgICAgLy8gSWYgd2luZG93Lm9uaGFzaGNoYW5nZSBpcyBzdXBwb3J0ZWQgbmF0aXZlbHksIHRoZXJlJ3Mgbm90aGluZyB0byBkby4uCiAgICAgIGlmICggc3VwcG9ydHNfb25oYXNoY2hhbmdlICkgeyByZXR1cm4gZmFsc2U7IH0KICAgICAgCiAgICAgIC8vIE90aGVyd2lzZSwgd2UgbmVlZCB0byBzdG9wIG91cnMgKGlmIHBvc3NpYmxlKS4KICAgICAgJCggZmFrZV9vbmhhc2hjaGFuZ2Uuc3RvcCApOwogICAgfQogICAgCiAgfSk7CiAgCiAgLy8gZmFrZV9vbmhhc2hjaGFuZ2UgZG9lcyBhbGwgdGhlIHdvcmsgb2YgdHJpZ2dlcmluZyB0aGUgd2luZG93Lm9uaGFzaGNoYW5nZQogIC8vIGV2ZW50IGZvciBicm93c2VycyB0aGF0IGRvbid0IG5hdGl2ZWx5IHN1cHBvcnQgaXQsIGluY2x1ZGluZyBjcmVhdGluZyBhCiAgLy8gcG9sbGluZyBsb29wIHRvIHdhdGNoIGZvciBoYXNoIGNoYW5nZXMgYW5kIGluIElFIDYvNyBjcmVhdGluZyBhIGhpZGRlbgogIC8vIElmcmFtZSB0byBlbmFibGUgYmFjayBhbmQgZm9yd2FyZC4KICBmYWtlX29uaGFzaGNoYW5nZSA9IChmdW5jdGlvbigpIHsKICAgIHZhciBzZWxmID0ge30sCiAgICAgIHRpbWVvdXRfaWQsCiAgICAgIAogICAgICAvLyBSZW1lbWJlciB0aGUgaW5pdGlhbCBoYXNoIHNvIGl0IGRvZXNuJ3QgZ2V0IHRyaWdnZXJlZCBpbW1lZGlhdGVseS4KICAgICAgbGFzdF9oYXNoID0gZ2V0X2ZyYWdtZW50KCksCiAgICAgIAogICAgICBmbl9yZXR2YWwgPSBmdW5jdGlvbiggdmFsICkgeyByZXR1cm4gdmFsOyB9LAogICAgICBoaXN0b3J5X3NldCA9IGZuX3JldHZhbCwKICAgICAgaGlzdG9yeV9nZXQgPSBmbl9yZXR2YWw7CiAgICAKICAgIC8vIFN0YXJ0IHRoZSBwb2xsaW5nIGxvb3AuCiAgICBzZWxmLnN0YXJ0ID0gZnVuY3Rpb24oKSB7CiAgICAgIHRpbWVvdXRfaWQgfHwgcG9sbCgpOwogICAgfTsKICAgIAogICAgLy8gU3RvcCB0aGUgcG9sbGluZyBsb29wLgogICAgc2VsZi5zdG9wID0gZnVuY3Rpb24oKSB7CiAgICAgIHRpbWVvdXRfaWQgJiYgY2xlYXJUaW1lb3V0KCB0aW1lb3V0X2lkICk7CiAgICAgIHRpbWVvdXRfaWQgPSB1bmRlZmluZWQ7CiAgICB9OwogICAgCiAgICAvLyBUaGlzIHBvbGxpbmcgbG9vcCBjaGVja3MgZXZlcnkgJC5mbi5oYXNoY2hhbmdlLmRlbGF5IG1pbGxpc2Vjb25kcyB0byBzZWUKICAgIC8vIGlmIGxvY2F0aW9uLmhhc2ggaGFzIGNoYW5nZWQsIGFuZCB0cmlnZ2VycyB0aGUgJ2hhc2hjaGFuZ2UnIGV2ZW50IG9uCiAgICAvLyB3aW5kb3cgd2hlbiBuZWNlc3NhcnkuCiAgICBmdW5jdGlvbiBwb2xsKCkgewogICAgICB2YXIgaGFzaCA9IGdldF9mcmFnbWVudCgpLAogICAgICAgIGhpc3RvcnlfaGFzaCA9IGhpc3RvcnlfZ2V0KCBsYXN0X2hhc2ggKTsKICAgICAgCiAgICAgIGlmICggaGFzaCAhPT0gbGFzdF9oYXNoICkgewogICAgICAgIGhpc3Rvcnlfc2V0KCBsYXN0X2hhc2ggPSBoYXNoLCBoaXN0b3J5X2hhc2ggKTsKICAgICAgICAKICAgICAgICAkKHdpbmRvdykudHJpZ2dlciggc3RyX2hhc2hjaGFuZ2UgKTsKICAgICAgICAKICAgICAgfSBlbHNlIGlmICggaGlzdG9yeV9oYXNoICE9PSBsYXN0X2hhc2ggKSB7CiAgICAgICAgbG9jYXRpb24uaHJlZiA9IGxvY2F0aW9uLmhyZWYucmVwbGFjZSggLyMuKi8sICcnICkgKyBoaXN0b3J5X2hhc2g7CiAgICAgIH0KICAgICAgCiAgICAgIHRpbWVvdXRfaWQgPSBzZXRUaW1lb3V0KCBwb2xsLCAkLmZuWyBzdHJfaGFzaGNoYW5nZSBdLmRlbGF5ICk7CiAgICB9OwogICAgCiAgICAvLyB2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnYKICAgIC8vIHZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnYgUkVNT1ZFIElGIE5PVCBTVVBQT1JUSU5HIElFNi83LzggdnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dgogICAgLy8gdnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2CiAgICAkLmJyb3dzZXIubXNpZSAmJiAhc3VwcG9ydHNfb25oYXNoY2hhbmdlICYmIChmdW5jdGlvbigpIHsKICAgICAgLy8gTm90IG9ubHkgZG8gSUU2LzcgbmVlZCB0aGUgIm1hZ2ljYWwiIElmcmFtZSB0cmVhdG1lbnQsIGJ1dCBzbyBkb2VzIElFOAogICAgICAvLyB3aGVuIHJ1bm5pbmcgaW4gIklFNyBjb21wYXRpYmlsaXR5IiBtb2RlLgogICAgICAKICAgICAgdmFyIGlmcmFtZSwKICAgICAgICBpZnJhbWVfc3JjOwogICAgICAKICAgICAgLy8gV2hlbiB0aGUgZXZlbnQgaXMgYm91bmQgYW5kIHBvbGxpbmcgc3RhcnRzIGluIElFIDYvNywgY3JlYXRlIGEgaGlkZGVuCiAgICAgIC8vIElmcmFtZSBmb3IgaGlzdG9yeSBoYW5kbGluZy4KICAgICAgc2VsZi5zdGFydCA9IGZ1bmN0aW9uKCkgewogICAgICAgIGlmICggIWlmcmFtZSApIHsKICAgICAgICAgIGlmcmFtZV9zcmMgPSAkLmZuWyBzdHJfaGFzaGNoYW5nZSBdLnNyYzsKICAgICAgICAgIGlmcmFtZV9zcmMgPSBpZnJhbWVfc3JjICYmIGlmcmFtZV9zcmMgKyBnZXRfZnJhZ21lbnQoKTsKICAgICAgICAgIAogICAgICAgICAgLy8gQ3JlYXRlIGhpZGRlbiBJZnJhbWUuIEF0dGVtcHQgdG8gbWFrZSBJZnJhbWUgYXMgaGlkZGVuIGFzIHBvc3NpYmxlCiAgICAgICAgICAvLyBieSB1c2luZyB0ZWNobmlxdWVzIGZyb20gaHR0cDovL3d3dy5wYWNpZWxsb2dyb3VwLmNvbS9ibG9nLz9wPTYwNC4KICAgICAgICAgIGlmcmFtZSA9ICQoJzxpZnJhbWUgdGFiaW5kZXg9Ii0xIiB0aXRsZT0iZW1wdHkiLz4nKS5oaWRlKCkKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFdoZW4gSWZyYW1lIGhhcyBjb21wbGV0ZWx5IGxvYWRlZCwgaW5pdGlhbGl6ZSB0aGUgaGlzdG9yeSBhbmQKICAgICAgICAgICAgLy8gc3RhcnQgcG9sbGluZy4KICAgICAgICAgICAgLm9uZSggJ2xvYWQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBpZnJhbWVfc3JjIHx8IGhpc3Rvcnlfc2V0KCBnZXRfZnJhZ21lbnQoKSApOwogICAgICAgICAgICAgIHBvbGwoKTsKICAgICAgICAgICAgfSkKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIExvYWQgSWZyYW1lIHNyYyBpZiBzcGVjaWZpZWQsIG90aGVyd2lzZSBub3RoaW5nLgogICAgICAgICAgICAuYXR0ciggJ3NyYycsIGlmcmFtZV9zcmMgfHwgJ2phdmFzY3JpcHQ6MCcgKQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQXBwZW5kIElmcmFtZSBhZnRlciB0aGUgZW5kIG9mIHRoZSBib2R5IHRvIHByZXZlbnQgdW5uZWNlc3NhcnkKICAgICAgICAgICAgLy8gaW5pdGlhbCBwYWdlIHNjcm9sbGluZyAoeWVzLCB0aGlzIHdvcmtzKS4KICAgICAgICAgICAgLmluc2VydEFmdGVyKCAnYm9keScgKVswXS5jb250ZW50V2luZG93OwogICAgICAgICAgCiAgICAgICAgICAvLyBXaGVuZXZlciBgZG9jdW1lbnQudGl0bGVgIGNoYW5nZXMsIHVwZGF0ZSB0aGUgSWZyYW1lJ3MgdGl0bGUgdG8KICAgICAgICAgIC8vIHByZXR0aWZ5IHRoZSBiYWNrL25leHQgaGlzdG9yeSBtZW51IGVudHJpZXMuIFNpbmNlIElFIHNvbWV0aW1lcwogICAgICAgICAgLy8gZXJyb3JzIHdpdGggIlVuc3BlY2lmaWVkIGVycm9yIiB0aGUgdmVyeSBmaXJzdCB0aW1lIHRoaXMgaXMgc2V0CiAgICAgICAgICAvLyAoeWVzLCB2ZXJ5IHVzZWZ1bCkgd3JhcCB0aGlzIHdpdGggYSB0cnkvY2F0Y2ggYmxvY2suCiAgICAgICAgICBkb2Mub25wcm9wZXJ0eWNoYW5nZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIGlmICggZXZlbnQucHJvcGVydHlOYW1lID09PSAndGl0bGUnICkgewogICAgICAgICAgICAgICAgaWZyYW1lLmRvY3VtZW50LnRpdGxlID0gZG9jLnRpdGxlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBjYXRjaChlKSB7fQogICAgICAgICAgfTsKICAgICAgICAgIAogICAgICAgIH0KICAgICAgfTsKICAgICAgCiAgICAgIC8vIE92ZXJyaWRlIHRoZSAic3RvcCIgbWV0aG9kIHNpbmNlIGFuIElFNi83IElmcmFtZSB3YXMgY3JlYXRlZC4gRXZlbgogICAgICAvLyBpZiB0aGVyZSBhcmUgbm8gbG9uZ2VyIGFueSBib3VuZCBldmVudCBoYW5kbGVycywgdGhlIHBvbGxpbmcgbG9vcAogICAgICAvLyBpcyBzdGlsbCBuZWNlc3NhcnkgZm9yIGJhY2svbmV4dCB0byB3b3JrIGF0IGFsbCEKICAgICAgc2VsZi5zdG9wID0gZm5fcmV0dmFsOwogICAgICAKICAgICAgLy8gR2V0IGhpc3RvcnkgYnkgbG9va2luZyBhdCB0aGUgaGlkZGVuIElmcmFtZSdzIGxvY2F0aW9uLmhhc2guCiAgICAgIGhpc3RvcnlfZ2V0ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIGdldF9mcmFnbWVudCggaWZyYW1lLmxvY2F0aW9uLmhyZWYgKTsKICAgICAgfTsKICAgICAgCiAgICAgIC8vIFNldCBhIG5ldyBoaXN0b3J5IGl0ZW0gYnkgb3BlbmluZyBhbmQgdGhlbiBjbG9zaW5nIHRoZSBJZnJhbWUKICAgICAgLy8gZG9jdW1lbnQsICp0aGVuKiBzZXR0aW5nIGl0cyBsb2NhdGlvbi5oYXNoLiBJZiBkb2N1bWVudC5kb21haW4gaGFzCiAgICAgIC8vIGJlZW4gc2V0LCB1cGRhdGUgdGhhdCBhcyB3ZWxsLgogICAgICBoaXN0b3J5X3NldCA9IGZ1bmN0aW9uKCBoYXNoLCBoaXN0b3J5X2hhc2ggKSB7CiAgICAgICAgdmFyIGlmcmFtZV9kb2MgPSBpZnJhbWUuZG9jdW1lbnQsCiAgICAgICAgICBkb21haW4gPSAkLmZuWyBzdHJfaGFzaGNoYW5nZSBdLmRvbWFpbjsKICAgICAgICAKICAgICAgICBpZiAoIGhhc2ggIT09IGhpc3RvcnlfaGFzaCApIHsKICAgICAgICAgIC8vIFVwZGF0ZSBJZnJhbWUgd2l0aCBhbnkgaW5pdGlhbCBgZG9jdW1lbnQudGl0bGVgIHRoYXQgbWlnaHQgYmUgc2V0LgogICAgICAgICAgaWZyYW1lX2RvYy50aXRsZSA9IGRvYy50aXRsZTsKICAgICAgICAgIAogICAgICAgICAgLy8gT3BlbmluZyB0aGUgSWZyYW1lJ3MgZG9jdW1lbnQgYWZ0ZXIgaXQgaGFzIGJlZW4gY2xvc2VkIGlzIHdoYXQKICAgICAgICAgIC8vIGFjdHVhbGx5IGFkZHMgYSBoaXN0b3J5IGVudHJ5LgogICAgICAgICAgaWZyYW1lX2RvYy5vcGVuKCk7CiAgICAgICAgICAKICAgICAgICAgIC8vIFNldCBkb2N1bWVudC5kb21haW4gZm9yIHRoZSBJZnJhbWUgZG9jdW1lbnQgYXMgd2VsbCwgaWYgbmVjZXNzYXJ5LgogICAgICAgICAgZG9tYWluICYmIGlmcmFtZV9kb2Mud3JpdGUoICc8c2NyaXB0PmRvY3VtZW50LmRvbWFpbj0iJyArIGRvbWFpbiArICciPC9zY3JpcHQ+JyApOwogICAgICAgICAgCiAgICAgICAgICBpZnJhbWVfZG9jLmNsb3NlKCk7CiAgICAgICAgICAKICAgICAgICAgIC8vIFVwZGF0ZSB0aGUgSWZyYW1lJ3MgaGFzaCwgZm9yIGdyZWF0IGp1c3RpY2UuCiAgICAgICAgICBpZnJhbWUubG9jYXRpb24uaGFzaCA9IGhhc2g7CiAgICAgICAgfQogICAgICB9OwogICAgICAKICAgIH0pKCk7CiAgICAvLyBeXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl4KICAgIC8vIF5eXl5eXl5eXl5eXl5eXl5eXl4gUkVNT1ZFIElGIE5PVCBTVVBQT1JUSU5HIElFNi83LzggXl5eXl5eXl5eXl5eXl5eXl5eXgogICAgLy8gXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eCiAgICAKICAgIHJldHVybiBzZWxmOwogIH0pKCk7CiAgCn0pKGpRdWVyeSx0aGlzKTsKCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKdmFyIGNyZWF0ZUhhbmRsZXIgPSBmdW5jdGlvbiggc2VxdWVudGlhbCApIHsKCgkvLyBEZWZhdWx0IHRvIHNlcXVlbnRpYWwKCWlmICggc2VxdWVudGlhbCA9PT0gdW5kZWZpbmVkICkgewoJCXNlcXVlbnRpYWwgPSB0cnVlOwoJfQoKCXJldHVybiBmdW5jdGlvbiggbmFtZSwgcmV2ZXJzZSwgJHRvLCAkZnJvbSApIHsKCgkJdmFyIGRlZmVycmVkID0gbmV3ICQuRGVmZXJyZWQoKSwKCQkJcmV2ZXJzZUNsYXNzID0gcmV2ZXJzZSA/ICIgcmV2ZXJzZSIgOiAiIiwKCQkJYWN0aXZlCT0gJC5tb2JpbGUudXJsSGlzdG9yeS5nZXRBY3RpdmUoKSwKCQkJdG9TY3JvbGwgPSBhY3RpdmUubGFzdFNjcm9sbCB8fCAkLm1vYmlsZS5kZWZhdWx0SG9tZVNjcm9sbCwKCQkJc2NyZWVuSGVpZ2h0ID0gJC5tb2JpbGUuZ2V0U2NyZWVuSGVpZ2h0KCksCgkJCW1heFRyYW5zaXRpb25PdmVycmlkZSA9ICQubW9iaWxlLm1heFRyYW5zaXRpb25XaWR0aCAhPT0gZmFsc2UgJiYgJCggd2luZG93ICkud2lkdGgoKSA+ICQubW9iaWxlLm1heFRyYW5zaXRpb25XaWR0aCwKCQkJbm9uZSA9ICEkLnN1cHBvcnQuY3NzVHJhbnNpdGlvbnMgfHwgbWF4VHJhbnNpdGlvbk92ZXJyaWRlIHx8ICFuYW1lIHx8IG5hbWUgPT09ICJub25lIiB8fCBNYXRoLm1heCggJCggd2luZG93ICkuc2Nyb2xsVG9wKCksIHRvU2Nyb2xsICkgPiAkLm1vYmlsZS5nZXRNYXhTY3JvbGxGb3JUcmFuc2l0aW9uKCksCgkJCXRvUHJlQ2xhc3MgPSAiIHVpLXBhZ2UtcHJlLWluIiwKCQkJdG9nZ2xlVmlld3BvcnRDbGFzcyA9IGZ1bmN0aW9uKCkgewoJCQkJJC5tb2JpbGUucGFnZUNvbnRhaW5lci50b2dnbGVDbGFzcyggInVpLW1vYmlsZS12aWV3cG9ydC10cmFuc2l0aW9uaW5nIHZpZXdwb3J0LSIgKyBuYW1lICk7CgkJCX0sCgkJCXNjcm9sbFBhZ2UgPSBmdW5jdGlvbigpIHsKCQkJCS8vIEJ5IHVzaW5nIHNjcm9sbFRvIGluc3RlYWQgb2Ygc2lsZW50U2Nyb2xsLCB3ZSBjYW4ga2VlcCB0aGluZ3MgYmV0dGVyIGluIG9yZGVyCgkJCQkvLyBKdXN0IHRvIGJlIHByZWNhdXRpb3MsIGRpc2FibGUgc2Nyb2xsc3RhcnQgbGlzdGVuaW5nIGxpa2Ugc2lsZW50U2Nyb2xsIHdvdWxkCgkJCQkkLmV2ZW50LnNwZWNpYWwuc2Nyb2xsc3RhcnQuZW5hYmxlZCA9IGZhbHNlOwoKCQkJCXdpbmRvdy5zY3JvbGxUbyggMCwgdG9TY3JvbGwgKTsKCgkJCQkvLyByZWVuYWJsZSBzY3JvbGxzdGFydCBsaXN0ZW5pbmcgbGlrZSBzaWxlbnRTY3JvbGwgd291bGQKCQkJCXNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCQkJCSQuZXZlbnQuc3BlY2lhbC5zY3JvbGxzdGFydC5lbmFibGVkID0gdHJ1ZTsKCQkJCX0sIDE1MCApOwoJCQl9LAoJCQljbGVhbkZyb20gPSBmdW5jdGlvbigpIHsKCQkJCSRmcm9tCgkJCQkJLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVQYWdlQ2xhc3MgKyAiIG91dCBpbiByZXZlcnNlICIgKyBuYW1lICkKCQkJCQkuaGVpZ2h0KCAiIiApOwoJCQl9LAoJCQlzdGFydE91dCA9IGZ1bmN0aW9uKCkgewoJCQkJLy8gaWYgaXQncyBub3Qgc2VxdWVudGlhbCwgY2FsbCB0aGUgZG9uZU91dCB0cmFuc2l0aW9uIHRvIHN0YXJ0IHRoZSBUTyBwYWdlIGFuaW1hdGluZyBpbiBzaW11bHRhbmVvdXNseQoJCQkJaWYgKCAhc2VxdWVudGlhbCApIHsKCQkJCQlkb25lT3V0KCk7CgkJCQl9CgkJCQllbHNlIHsKCQkJCQkkZnJvbS5hbmltYXRpb25Db21wbGV0ZSggZG9uZU91dCApOwoJCQkJfQoKCQkJCS8vIFNldCB0aGUgZnJvbSBwYWdlJ3MgaGVpZ2h0IGFuZCBzdGFydCBpdCB0cmFuc2l0aW9uaW5nIG91dAoJCQkJLy8gTm90ZTogc2V0dGluZyBhbiBleHBsaWNpdCBoZWlnaHQgaGVscHMgZWxpbWluYXRlIHRpbGluZyBpbiB0aGUgdHJhbnNpdGlvbnMKCQkJCSRmcm9tCgkJCQkJLmhlaWdodCggc2NyZWVuSGVpZ2h0ICsgJCggd2luZG93ICkuc2Nyb2xsVG9wKCkgKQoJCQkJCS5hZGRDbGFzcyggbmFtZSArICIgb3V0IiArIHJldmVyc2VDbGFzcyApOwoJCQl9LAoKCQkJZG9uZU91dCA9IGZ1bmN0aW9uKCkgewoKCQkJCWlmICggJGZyb20gJiYgc2VxdWVudGlhbCApIHsKCQkJCQljbGVhbkZyb20oKTsKCQkJCX0KCgkJCQlzdGFydEluKCk7CgkJCX0sCgoJCQlzdGFydEluID0gZnVuY3Rpb24oKSB7CgoJCQkJLy8gUHJldmVudCBmbGlja2VyaW5nIGluIHBob25lZ2FwIGNvbnRhaW5lcjogc2VlIGNvbW1lbnRzIGF0ICM0MDI0IHJlZ2FyZGluZyBpT1MKCQkJCSR0by5jc3MoICJ6LWluZGV4IiwgLTEwICk7CgoJCQkJJHRvLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVQYWdlQ2xhc3MgKyB0b1ByZUNsYXNzICk7CgoJCQkJLy8gU2VuZCBmb2N1cyB0byBwYWdlIGFzIGl0IGlzIG5vdyBkaXNwbGF5OiBibG9jawoJCQkJJC5tb2JpbGUuZm9jdXNQYWdlKCAkdG8gKTsKCgkJCQkvLyBTZXQgdG8gcGFnZSBoZWlnaHQKCQkJCSR0by5oZWlnaHQoIHNjcmVlbkhlaWdodCArIHRvU2Nyb2xsICk7CgoJCQkJc2Nyb2xsUGFnZSgpOwoKCQkJCS8vIFJlc3RvcmVzIHZpc2liaWxpdHkgb2YgdGhlIG5ldyBwYWdlOiBhZGRlZCB0b2dldGhlciB3aXRoICR0by5jc3MoICJ6LWluZGV4IiwgLTEwICk7CgkJCQkkdG8uY3NzKCAiei1pbmRleCIsICIiICk7CgoJCQkJaWYgKCAhbm9uZSApIHsKCQkJCQkkdG8uYW5pbWF0aW9uQ29tcGxldGUoIGRvbmVJbiApOwoJCQkJfQoKCQkJCSR0bwoJCQkJCS5yZW1vdmVDbGFzcyggdG9QcmVDbGFzcyApCgkJCQkJLmFkZENsYXNzKCBuYW1lICsgIiBpbiIgKyByZXZlcnNlQ2xhc3MgKTsKCgkJCQlpZiAoIG5vbmUgKSB7CgkJCQkJZG9uZUluKCk7CgkJCQl9CgoJCQl9LAoKCQkJZG9uZUluID0gZnVuY3Rpb24oKSB7CgoJCQkJaWYgKCAhc2VxdWVudGlhbCApIHsKCgkJCQkJaWYgKCAkZnJvbSApIHsKCQkJCQkJY2xlYW5Gcm9tKCk7CgkJCQkJfQoJCQkJfQoKCQkJCSR0bwoJCQkJCS5yZW1vdmVDbGFzcyggIm91dCBpbiByZXZlcnNlICIgKyBuYW1lICkKCQkJCQkuaGVpZ2h0KCAiIiApOwoKCQkJCXRvZ2dsZVZpZXdwb3J0Q2xhc3MoKTsKCgkJCQkvLyBJbiBzb21lIGJyb3dzZXJzIChpT1M1KSwgM0QgdHJhbnNpdGlvbnMgYmxvY2sgdGhlIGFiaWxpdHkgdG8gc2Nyb2xsIHRvIHRoZSBkZXNpcmVkIGxvY2F0aW9uIGR1cmluZyB0cmFuc2l0aW9uCgkJCQkvLyBUaGlzIGVuc3VyZXMgd2UganVtcCB0byB0aGF0IHNwb3QgYWZ0ZXIgdGhlIGZhY3QsIGlmIHdlIGFyZW4ndCB0aGVyZSBhbHJlYWR5LgoJCQkJaWYgKCAkKCB3aW5kb3cgKS5zY3JvbGxUb3AoKSAhPT0gdG9TY3JvbGwgKSB7CgkJCQkJc2Nyb2xsUGFnZSgpOwoJCQkJfQoKCQkJCWRlZmVycmVkLnJlc29sdmUoIG5hbWUsIHJldmVyc2UsICR0bywgJGZyb20sIHRydWUgKTsKCQkJfTsKCgkJdG9nZ2xlVmlld3BvcnRDbGFzcygpOwoKCQlpZiAoICRmcm9tICYmICFub25lICkgewoJCQlzdGFydE91dCgpOwoJCX0KCQllbHNlIHsKCQkJZG9uZU91dCgpOwoJCX0KCgkJcmV0dXJuIGRlZmVycmVkLnByb21pc2UoKTsKCX07Cn07CgovLyBnZW5lcmF0ZSB0aGUgaGFuZGxlcnMgZnJvbSB0aGUgYWJvdmUKdmFyIHNlcXVlbnRpYWxIYW5kbGVyID0gY3JlYXRlSGFuZGxlcigpLAoJc2ltdWx0YW5lb3VzSGFuZGxlciA9IGNyZWF0ZUhhbmRsZXIoIGZhbHNlICksCglkZWZhdWx0R2V0TWF4U2Nyb2xsRm9yVHJhbnNpdGlvbiA9IGZ1bmN0aW9uKCkgewoJCXJldHVybiAkLm1vYmlsZS5nZXRTY3JlZW5IZWlnaHQoKSAqIDM7Cgl9OwoKLy8gTWFrZSBvdXIgdHJhbnNpdGlvbiBoYW5kbGVyIHRoZSBwdWJsaWMgZGVmYXVsdC4KJC5tb2JpbGUuZGVmYXVsdFRyYW5zaXRpb25IYW5kbGVyID0gc2VxdWVudGlhbEhhbmRsZXI7CgovL3RyYW5zaXRpb24gaGFuZGxlciBkaWN0aW9uYXJ5IGZvciAzcmQgcGFydHkgdHJhbnNpdGlvbnMKJC5tb2JpbGUudHJhbnNpdGlvbkhhbmRsZXJzID0gewoJImRlZmF1bHQiOiAkLm1vYmlsZS5kZWZhdWx0VHJhbnNpdGlvbkhhbmRsZXIsCgkic2VxdWVudGlhbCI6IHNlcXVlbnRpYWxIYW5kbGVyLAoJInNpbXVsdGFuZW91cyI6IHNpbXVsdGFuZW91c0hhbmRsZXIKfTsKCiQubW9iaWxlLnRyYW5zaXRpb25GYWxsYmFja3MgPSB7fTsKCi8vIElmIHRyYW5zaXRpb24gaXMgZGVmaW5lZCwgY2hlY2sgaWYgY3NzIDNEIHRyYW5zZm9ybXMgYXJlIHN1cHBvcnRlZCwgYW5kIGlmIG5vdCwgaWYgYSBmYWxsYmFjayBpcyBzcGVjaWZpZWQKJC5tb2JpbGUuX21heWJlRGVncmFkZVRyYW5zaXRpb24gPSBmdW5jdGlvbiggdHJhbnNpdGlvbiApIHsKCQlpZiAoIHRyYW5zaXRpb24gJiYgISQuc3VwcG9ydC5jc3NUcmFuc2Zvcm0zZCAmJiAkLm1vYmlsZS50cmFuc2l0aW9uRmFsbGJhY2tzWyB0cmFuc2l0aW9uIF0gKSB7CgkJCXRyYW5zaXRpb24gPSAkLm1vYmlsZS50cmFuc2l0aW9uRmFsbGJhY2tzWyB0cmFuc2l0aW9uIF07CgkJfQoKCQlyZXR1cm4gdHJhbnNpdGlvbjsKfTsKCi8vIFNldCB0aGUgZ2V0TWF4U2Nyb2xsRm9yVHJhbnNpdGlvbiB0byBkZWZhdWx0IGlmIG5vIGltcGxlbWVudGF0aW9uIHdhcyBzZXQgYnkgdXNlcgokLm1vYmlsZS5nZXRNYXhTY3JvbGxGb3JUcmFuc2l0aW9uID0gJC5tb2JpbGUuZ2V0TWF4U2Nyb2xsRm9yVHJhbnNpdGlvbiB8fCBkZWZhdWx0R2V0TWF4U2Nyb2xsRm9yVHJhbnNpdGlvbjsKfSkoIGpRdWVyeSwgdGhpcyApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgoJLy9kZWZpbmUgdmFycyBmb3IgaW50ZXJhbCB1c2UKCXZhciAkd2luZG93ID0gJCggd2luZG93ICksCgkJJGh0bWwgPSAkKCAnaHRtbCcgKSwKCQkkaGVhZCA9ICQoICdoZWFkJyApLAoKCQkvL3VybCBwYXRoIGhlbHBlcnMgZm9yIHVzZSBpbiByZWxhdGl2ZSB1cmwgbWFuYWdlbWVudAoJCXBhdGggPSB7CgoJCQkvLyBUaGlzIHNjYXJ5IGxvb2tpbmcgcmVndWxhciBleHByZXNzaW9uIHBhcnNlcyBhbiBhYnNvbHV0ZSBVUkwgb3IgaXRzIHJlbGF0aXZlCgkJCS8vIHZhcmlhbnRzIChwcm90b2NvbCwgc2l0ZSwgZG9jdW1lbnQsIHF1ZXJ5LCBhbmQgaGFzaCksIGludG8gdGhlIHZhcmlvdXMKCQkJLy8gY29tcG9uZW50cyAocHJvdG9jb2wsIGhvc3QsIHBhdGgsIHF1ZXJ5LCBmcmFnbWVudCwgZXRjIHRoYXQgbWFrZSB1cCB0aGUKCQkJLy8gVVJMIGFzIHdlbGwgYXMgc29tZSBvdGhlciBjb21tb25seSB1c2VkIHN1Yi1wYXJ0cy4gV2hlbiB1c2VkIHdpdGggUmVnRXhwLmV4ZWMoKQoJCQkvLyBvciBTdHJpbmcubWF0Y2gsIGl0IHBhcnNlcyB0aGUgVVJMIGludG8gYSByZXN1bHRzIGFycmF5IHRoYXQgbG9va3MgbGlrZSB0aGlzOgoJCQkvLwoJCQkvLyAgICAgWzBdOiBodHRwOi8vamJsYXM6cGFzc3dvcmRAbXljb21wYW55LmNvbTo4MDgwL21haWwvaW5ib3g/bXNnPTEyMzQmdHlwZT11bnJlYWQjbXNnLWNvbnRlbnQKCQkJLy8gICAgIFsxXTogaHR0cDovL2pibGFzOnBhc3N3b3JkQG15Y29tcGFueS5jb206ODA4MC9tYWlsL2luYm94P21zZz0xMjM0JnR5cGU9dW5yZWFkCgkJCS8vICAgICBbMl06IGh0dHA6Ly9qYmxhczpwYXNzd29yZEBteWNvbXBhbnkuY29tOjgwODAvbWFpbC9pbmJveAoJCQkvLyAgICAgWzNdOiBodHRwOi8vamJsYXM6cGFzc3dvcmRAbXljb21wYW55LmNvbTo4MDgwCgkJCS8vICAgICBbNF06IGh0dHA6CgkJCS8vICAgICBbNV06IC8vCgkJCS8vICAgICBbNl06IGpibGFzOnBhc3N3b3JkQG15Y29tcGFueS5jb206ODA4MAoJCQkvLyAgICAgWzddOiBqYmxhczpwYXNzd29yZAoJCQkvLyAgICAgWzhdOiBqYmxhcwoJCQkvLyAgICAgWzldOiBwYXNzd29yZAoJCQkvLyAgICBbMTBdOiBteWNvbXBhbnkuY29tOjgwODAKCQkJLy8gICAgWzExXTogbXljb21wYW55LmNvbQoJCQkvLyAgICBbMTJdOiA4MDgwCgkJCS8vICAgIFsxM106IC9tYWlsL2luYm94CgkJCS8vICAgIFsxNF06IC9tYWlsLwoJCQkvLyAgICBbMTVdOiBpbmJveAoJCQkvLyAgICBbMTZdOiA/bXNnPTEyMzQmdHlwZT11bnJlYWQKCQkJLy8gICAgWzE3XTogI21zZy1jb250ZW50CgkJCS8vCgkJCXVybFBhcnNlUkU6IC9eKCgoKFteOlwvI1w/XSs6KT8oPzooXC9cLykoKD86KChbXjpAXC8jXD9dKykoPzpcOihbXjpAXC8jXD9dKykpPylAKT8oKFteOlwvI1w/XF1cW10rfFxbW15cL1xdQCM/XStcXSkoPzpcOihbMC05XSspKT8pKT8pPyk/KChcLz8oPzpbXlwvXD8jXStcLyspKikoW15cPyNdKikpKT8oXD9bXiNdKyk/KSgjLiopPy8sCgoJCQkvLyBBYnN0cmFjdGlvbiB0byBhZGRyZXNzIHhzcyAoSXNzdWUgIzQ3ODcpIGJ5IHJlbW92aW5nIHRoZSBhdXRob3JpdHkgaW4KCQkJLy8gYnJvd3NlcnMgdGhhdCBhdXRvCWRlY29kZSBpdC4gQWxsIHJlZmVyZW5jZXMgdG8gbG9jYXRpb24uaHJlZiBzaG91bGQgYmUKCQkJLy8gcmVwbGFjZWQgd2l0aCBhIGNhbGwgdG8gdGhpcyBtZXRob2Qgc28gdGhhdCBpdCBjYW4gYmUgZGVhbHQgd2l0aCBwcm9wZXJseSBoZXJlCgkJCWdldExvY2F0aW9uOiBmdW5jdGlvbiggdXJsICkgewoJCQkJdmFyIHVyaSA9IHVybCA/IHRoaXMucGFyc2VVcmwoIHVybCApIDogbG9jYXRpb24sCgkJCQkJaGFzaCA9IHRoaXMucGFyc2VVcmwoIHVybCB8fCBsb2NhdGlvbi5ocmVmICkuaGFzaDsKCgkJCQkvLyBtaW1pYyB0aGUgYnJvd3NlciB3aXRoIGFuIGVtcHR5IHN0cmluZyB3aGVuIHRoZSBoYXNoIGlzIGVtcHR5CgkJCQloYXNoID0gaGFzaCA9PT0gIiMiID8gIiIgOiBoYXNoOwoKCQkJCS8vIE1ha2Ugc3VyZSB0byBwYXJzZSB0aGUgdXJsIG9yIHRoZSBsb2NhdGlvbiBvYmplY3QgZm9yIHRoZSBoYXNoIGJlY2F1c2UgdXNpbmcgbG9jYXRpb24uaGFzaAoJCQkJLy8gaXMgYXV0b2RlY29kZWQgaW4gZmlyZWZveCwgdGhlIHJlc3Qgb2YgdGhlIHVybCBzaG91bGQgYmUgZnJvbSB0aGUgb2JqZWN0IChsb2NhdGlvbiB1bmxlc3MKCQkJCS8vIHdlJ3JlIHRlc3RpbmcpIHRvIGF2b2lkIHRoZSBpbmNsdXNpb24gb2YgdGhlIGF1dGhvcml0eQoJCQkJcmV0dXJuIHVyaS5wcm90b2NvbCArICIvLyIgKyB1cmkuaG9zdCArIHVyaS5wYXRobmFtZSArIHVyaS5zZWFyY2ggKyBoYXNoOwoJCQl9LAoKCQkJcGFyc2VMb2NhdGlvbjogZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gdGhpcy5wYXJzZVVybCggdGhpcy5nZXRMb2NhdGlvbigpICk7CgkJCX0sCgoJCQkvL1BhcnNlIGEgVVJMIGludG8gYSBzdHJ1Y3R1cmUgdGhhdCBhbGxvd3MgZWFzeSBhY2Nlc3MgdG8KCQkJLy9hbGwgb2YgdGhlIFVSTCBjb21wb25lbnRzIGJ5IG5hbWUuCgkJCXBhcnNlVXJsOiBmdW5jdGlvbiggdXJsICkgewoJCQkJLy8gSWYgd2UncmUgcGFzc2VkIGFuIG9iamVjdCwgd2UnbGwgYXNzdW1lIHRoYXQgaXQgaXMKCQkJCS8vIGEgcGFyc2VkIHVybCBvYmplY3QgYW5kIGp1c3QgcmV0dXJuIGl0IGJhY2sgdG8gdGhlIGNhbGxlci4KCQkJCWlmICggJC50eXBlKCB1cmwgKSA9PT0gIm9iamVjdCIgKSB7CgkJCQkJcmV0dXJuIHVybDsKCQkJCX0KCgkJCQl2YXIgbWF0Y2hlcyA9IHBhdGgudXJsUGFyc2VSRS5leGVjKCB1cmwgfHwgIiIgKSB8fCBbXTsKCgkJCQkJLy8gQ3JlYXRlIGFuIG9iamVjdCB0aGF0IGFsbG93cyB0aGUgY2FsbGVyIHRvIGFjY2VzcyB0aGUgc3ViLW1hdGNoZXMKCQkJCQkvLyBieSBuYW1lLiBOb3RlIHRoYXQgSUUgcmV0dXJucyBhbiBlbXB0eSBzdHJpbmcgaW5zdGVhZCBvZiB1bmRlZmluZWQsCgkJCQkJLy8gbGlrZSBhbGwgb3RoZXIgYnJvd3NlcnMgZG8sIHNvIHdlIG5vcm1hbGl6ZSBldmVyeXRoaW5nIHNvIGl0cyBjb25zaXN0ZW50CgkJCQkJLy8gbm8gbWF0dGVyIHdoYXQgYnJvd3NlciB3ZSdyZSBydW5uaW5nIG9uLgoJCQkJCXJldHVybiB7CgkJCQkJCWhyZWY6ICAgICAgICAgbWF0Y2hlc1sgIDAgXSB8fCAiIiwKCQkJCQkJaHJlZk5vSGFzaDogICBtYXRjaGVzWyAgMSBdIHx8ICIiLAoJCQkJCQlocmVmTm9TZWFyY2g6IG1hdGNoZXNbICAyIF0gfHwgIiIsCgkJCQkJCWRvbWFpbjogICAgICAgbWF0Y2hlc1sgIDMgXSB8fCAiIiwKCQkJCQkJcHJvdG9jb2w6ICAgICBtYXRjaGVzWyAgNCBdIHx8ICIiLAoJCQkJCQlkb3VibGVTbGFzaDogIG1hdGNoZXNbICA1IF0gfHwgIiIsCgkJCQkJCWF1dGhvcml0eTogICAgbWF0Y2hlc1sgIDYgXSB8fCAiIiwKCQkJCQkJdXNlcm5hbWU6ICAgICBtYXRjaGVzWyAgOCBdIHx8ICIiLAoJCQkJCQlwYXNzd29yZDogICAgIG1hdGNoZXNbICA5IF0gfHwgIiIsCgkJCQkJCWhvc3Q6ICAgICAgICAgbWF0Y2hlc1sgMTAgXSB8fCAiIiwKCQkJCQkJaG9zdG5hbWU6ICAgICBtYXRjaGVzWyAxMSBdIHx8ICIiLAoJCQkJCQlwb3J0OiAgICAgICAgIG1hdGNoZXNbIDEyIF0gfHwgIiIsCgkJCQkJCXBhdGhuYW1lOiAgICAgbWF0Y2hlc1sgMTMgXSB8fCAiIiwKCQkJCQkJZGlyZWN0b3J5OiAgICBtYXRjaGVzWyAxNCBdIHx8ICIiLAoJCQkJCQlmaWxlbmFtZTogICAgIG1hdGNoZXNbIDE1IF0gfHwgIiIsCgkJCQkJCXNlYXJjaDogICAgICAgbWF0Y2hlc1sgMTYgXSB8fCAiIiwKCQkJCQkJaGFzaDogICAgICAgICBtYXRjaGVzWyAxNyBdIHx8ICIiCgkJCQkJfTsKCQkJfSwKCgkJCS8vVHVybiByZWxQYXRoIGludG8gYW4gYXNib2x1dGUgcGF0aC4gYWJzUGF0aCBpcwoJCQkvL2FuIG9wdGlvbmFsIGFic29sdXRlIHBhdGggd2hpY2ggZGVzY3JpYmVzIHdoYXQKCQkJLy9yZWxQYXRoIGlzIHJlbGF0aXZlIHRvLgoJCQltYWtlUGF0aEFic29sdXRlOiBmdW5jdGlvbiggcmVsUGF0aCwgYWJzUGF0aCApIHsKCQkJCWlmICggcmVsUGF0aCAmJiByZWxQYXRoLmNoYXJBdCggMCApID09PSAiLyIgKSB7CgkJCQkJcmV0dXJuIHJlbFBhdGg7CgkJCQl9CgoJCQkJcmVsUGF0aCA9IHJlbFBhdGggfHwgIiI7CgkJCQlhYnNQYXRoID0gYWJzUGF0aCA/IGFic1BhdGgucmVwbGFjZSggL15cL3woXC9bXlwvXSp8W15cL10rKSQvZywgIiIgKSA6ICIiOwoKCQkJCXZhciBhYnNTdGFjayA9IGFic1BhdGggPyBhYnNQYXRoLnNwbGl0KCAiLyIgKSA6IFtdLAoJCQkJCXJlbFN0YWNrID0gcmVsUGF0aC5zcGxpdCggIi8iICk7CgkJCQlmb3IgKCB2YXIgaSA9IDA7IGkgPCByZWxTdGFjay5sZW5ndGg7IGkrKyApIHsKCQkJCQl2YXIgZCA9IHJlbFN0YWNrWyBpIF07CgkJCQkJc3dpdGNoICggZCApIHsKCQkJCQkJY2FzZSAiLiI6CgkJCQkJCQlicmVhazsKCQkJCQkJY2FzZSAiLi4iOgoJCQkJCQkJaWYgKCBhYnNTdGFjay5sZW5ndGggKSB7CgkJCQkJCQkJYWJzU3RhY2sucG9wKCk7CgkJCQkJCQl9CgkJCQkJCQlicmVhazsKCQkJCQkJZGVmYXVsdDoKCQkJCQkJCWFic1N0YWNrLnB1c2goIGQgKTsKCQkJCQkJCWJyZWFrOwoJCQkJCX0KCQkJCX0KCQkJCXJldHVybiAiLyIgKyBhYnNTdGFjay5qb2luKCAiLyIgKTsKCQkJfSwKCgkJCS8vUmV0dXJucyB0cnVlIGlmIGJvdGggdXJscyBoYXZlIHRoZSBzYW1lIGRvbWFpbi4KCQkJaXNTYW1lRG9tYWluOiBmdW5jdGlvbiggYWJzVXJsMSwgYWJzVXJsMiApIHsKCQkJCXJldHVybiBwYXRoLnBhcnNlVXJsKCBhYnNVcmwxICkuZG9tYWluID09PSBwYXRoLnBhcnNlVXJsKCBhYnNVcmwyICkuZG9tYWluOwoJCQl9LAoKCQkJLy9SZXR1cm5zIHRydWUgZm9yIGFueSByZWxhdGl2ZSB2YXJpYW50LgoJCQlpc1JlbGF0aXZlVXJsOiBmdW5jdGlvbiggdXJsICkgewoJCQkJLy8gQWxsIHJlbGF0aXZlIFVybCB2YXJpYW50cyBoYXZlIG9uZSB0aGluZyBpbiBjb21tb24sIG5vIHByb3RvY29sLgoJCQkJcmV0dXJuIHBhdGgucGFyc2VVcmwoIHVybCApLnByb3RvY29sID09PSAiIjsKCQkJfSwKCgkJCS8vUmV0dXJucyB0cnVlIGZvciBhbiBhYnNvbHV0ZSB1cmwuCgkJCWlzQWJzb2x1dGVVcmw6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQlyZXR1cm4gcGF0aC5wYXJzZVVybCggdXJsICkucHJvdG9jb2wgIT09ICIiOwoJCQl9LAoKCQkJLy9UdXJuIHRoZSBzcGVjaWZpZWQgcmVhbHRpdmUgVVJMIGludG8gYW4gYWJzb2x1dGUgb25lLiBUaGlzIGZ1bmN0aW9uCgkJCS8vY2FuIGhhbmRsZSBhbGwgcmVsYXRpdmUgdmFyaWFudHMgKHByb3RvY29sLCBzaXRlLCBkb2N1bWVudCwgcXVlcnksIGZyYWdtZW50KS4KCQkJbWFrZVVybEFic29sdXRlOiBmdW5jdGlvbiggcmVsVXJsLCBhYnNVcmwgKSB7CgkJCQlpZiAoICFwYXRoLmlzUmVsYXRpdmVVcmwoIHJlbFVybCApICkgewoJCQkJCXJldHVybiByZWxVcmw7CgkJCQl9CgoJCQkJaWYgKCBhYnNVcmwgPT09IHVuZGVmaW5lZCApIHsKCQkJCQlhYnNVcmwgPSBkb2N1bWVudEJhc2U7CgkJCQl9CgoJCQkJdmFyIHJlbE9iaiA9IHBhdGgucGFyc2VVcmwoIHJlbFVybCApLAoJCQkJCWFic09iaiA9IHBhdGgucGFyc2VVcmwoIGFic1VybCApLAoJCQkJCXByb3RvY29sID0gcmVsT2JqLnByb3RvY29sIHx8IGFic09iai5wcm90b2NvbCwKCQkJCQlkb3VibGVTbGFzaCA9IHJlbE9iai5wcm90b2NvbCA/IHJlbE9iai5kb3VibGVTbGFzaCA6ICggcmVsT2JqLmRvdWJsZVNsYXNoIHx8IGFic09iai5kb3VibGVTbGFzaCApLAoJCQkJCWF1dGhvcml0eSA9IHJlbE9iai5hdXRob3JpdHkgfHwgYWJzT2JqLmF1dGhvcml0eSwKCQkJCQloYXNQYXRoID0gcmVsT2JqLnBhdGhuYW1lICE9PSAiIiwKCQkJCQlwYXRobmFtZSA9IHBhdGgubWFrZVBhdGhBYnNvbHV0ZSggcmVsT2JqLnBhdGhuYW1lIHx8IGFic09iai5maWxlbmFtZSwgYWJzT2JqLnBhdGhuYW1lICksCgkJCQkJc2VhcmNoID0gcmVsT2JqLnNlYXJjaCB8fCAoICFoYXNQYXRoICYmIGFic09iai5zZWFyY2ggKSB8fCAiIiwKCQkJCQloYXNoID0gcmVsT2JqLmhhc2g7CgoJCQkJcmV0dXJuIHByb3RvY29sICsgZG91YmxlU2xhc2ggKyBhdXRob3JpdHkgKyBwYXRobmFtZSArIHNlYXJjaCArIGhhc2g7CgkJCX0sCgoJCQkvL0FkZCBzZWFyY2ggKGFrYSBxdWVyeSkgcGFyYW1zIHRvIHRoZSBzcGVjaWZpZWQgdXJsLgoJCQlhZGRTZWFyY2hQYXJhbXM6IGZ1bmN0aW9uKCB1cmwsIHBhcmFtcyApIHsKCQkJCXZhciB1ID0gcGF0aC5wYXJzZVVybCggdXJsICksCgkJCQkJcCA9ICggdHlwZW9mIHBhcmFtcyA9PT0gIm9iamVjdCIgKSA/ICQucGFyYW0oIHBhcmFtcyApIDogcGFyYW1zLAoJCQkJCXMgPSB1LnNlYXJjaCB8fCAiPyI7CgkJCQlyZXR1cm4gdS5ocmVmTm9TZWFyY2ggKyBzICsgKCBzLmNoYXJBdCggcy5sZW5ndGggLSAxICkgIT09ICI/IiA/ICImIiA6ICIiICkgKyBwICsgKCB1Lmhhc2ggfHwgIiIgKTsKCQkJfSwKCgkJCWNvbnZlcnRVcmxUb0RhdGFVcmw6IGZ1bmN0aW9uKCBhYnNVcmwgKSB7CgkJCQl2YXIgdSA9IHBhdGgucGFyc2VVcmwoIGFic1VybCApOwoJCQkJaWYgKCBwYXRoLmlzRW1iZWRkZWRQYWdlKCB1ICkgKSB7CgkJCQkJLy8gRm9yIGVtYmVkZGVkIHBhZ2VzLCByZW1vdmUgdGhlIGRpYWxvZyBoYXNoIGtleSBhcyBpbiBnZXRGaWxlUGF0aCgpLAoJCQkJCS8vIG90aGVyd2lzZSB0aGUgRGF0YSBVcmwgd29uJ3QgbWF0Y2ggdGhlIGlkIG9mIHRoZSBlbWJlZGRlZCBQYWdlLgoJCQkJCXJldHVybiB1Lmhhc2guc3BsaXQoIGRpYWxvZ0hhc2hLZXkgKVswXS5yZXBsYWNlKCAvXiMvLCAiIiApOwoJCQkJfSBlbHNlIGlmICggcGF0aC5pc1NhbWVEb21haW4oIHUsIGRvY3VtZW50QmFzZSApICkgewoJCQkJCXJldHVybiB1LmhyZWZOb0hhc2gucmVwbGFjZSggZG9jdW1lbnRCYXNlLmRvbWFpbiwgIiIgKS5zcGxpdCggZGlhbG9nSGFzaEtleSApWzBdOwoJCQkJfQoKCQkJCXJldHVybiB3aW5kb3cuZGVjb2RlVVJJQ29tcG9uZW50KGFic1VybCk7CgkJCX0sCgoJCQkvL2dldCBwYXRoIGZyb20gY3VycmVudCBoYXNoLCBvciBmcm9tIGEgZmlsZSBwYXRoCgkJCWdldDogZnVuY3Rpb24oIG5ld1BhdGggKSB7CgkJCQlpZiAoIG5ld1BhdGggPT09IHVuZGVmaW5lZCApIHsKCQkJCQluZXdQYXRoID0gcGF0aC5wYXJzZUxvY2F0aW9uKCkuaGFzaDsKCQkJCX0KCQkJCXJldHVybiBwYXRoLnN0cmlwSGFzaCggbmV3UGF0aCApLnJlcGxhY2UoIC9bXlwvXSpcLlteXC8qXSskLywgJycgKTsKCQkJfSwKCgkJCS8vcmV0dXJuIHRoZSBzdWJzdHJpbmcgb2YgYSBmaWxlcGF0aCBiZWZvcmUgdGhlIHN1Yi1wYWdlIGtleSwgZm9yIG1ha2luZyBhIHNlcnZlciByZXF1ZXN0CgkJCWdldEZpbGVQYXRoOiBmdW5jdGlvbiggcGF0aCApIHsKCQkJCXZhciBzcGxpdGtleSA9ICcmJyArICQubW9iaWxlLnN1YlBhZ2VVcmxLZXk7CgkJCQlyZXR1cm4gcGF0aCAmJiBwYXRoLnNwbGl0KCBzcGxpdGtleSApWzBdLnNwbGl0KCBkaWFsb2dIYXNoS2V5IClbMF07CgkJCX0sCgoJCQkvL3NldCBsb2NhdGlvbiBoYXNoIHRvIHBhdGgKCQkJc2V0OiBmdW5jdGlvbiggcGF0aCApIHsKCQkJCWxvY2F0aW9uLmhhc2ggPSBwYXRoOwoJCQl9LAoKCQkJLy90ZXN0IGlmIGEgZ2l2ZW4gdXJsIChzdHJpbmcpIGlzIGEgcGF0aAoJCQkvL05PVEUgbWlnaHQgYmUgZXhjZXB0aW9uYWxseSBuYWl2ZQoJCQlpc1BhdGg6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQlyZXR1cm4gKCAvXC8vICkudGVzdCggdXJsICk7CgkJCX0sCgoJCQkvL3JldHVybiBhIHVybCBwYXRoIHdpdGggdGhlIHdpbmRvdydzIGxvY2F0aW9uIHByb3RvY29sL2hvc3RuYW1lL3BhdGhuYW1lIHJlbW92ZWQKCQkJY2xlYW46IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQlyZXR1cm4gdXJsLnJlcGxhY2UoIGRvY3VtZW50QmFzZS5kb21haW4sICIiICk7CgkJCX0sCgoJCQkvL2p1c3QgcmV0dXJuIHRoZSB1cmwgd2l0aG91dCBhbiBpbml0aWFsICMKCQkJc3RyaXBIYXNoOiBmdW5jdGlvbiggdXJsICkgewoJCQkJcmV0dXJuIHVybC5yZXBsYWNlKCAvXiMvLCAiIiApOwoJCQl9LAoKCQkJLy9yZW1vdmUgdGhlIHByZWNlZGluZyBoYXNoLCBhbnkgcXVlcnkgcGFyYW1zLCBhbmQgZGlhbG9nIG5vdGF0aW9ucwoJCQljbGVhbkhhc2g6IGZ1bmN0aW9uKCBoYXNoICkgewoJCQkJcmV0dXJuIHBhdGguc3RyaXBIYXNoKCBoYXNoLnJlcGxhY2UoIC9cPy4qJC8sICIiICkucmVwbGFjZSggZGlhbG9nSGFzaEtleSwgIiIgKSApOwoJCQl9LAoKCQkJaXNIYXNoVmFsaWQ6IGZ1bmN0aW9uKCBoYXNoICkgewoJCQkJcmV0dXJuICggL14jW14jXSskLyApLnRlc3QoIGhhc2ggKTsKCQkJfSwKCgkJCS8vY2hlY2sgd2hldGhlciBhIHVybCBpcyByZWZlcmVuY2luZyB0aGUgc2FtZSBkb21haW4sIG9yIGFuIGV4dGVybmFsIGRvbWFpbiBvciBkaWZmZXJlbnQgcHJvdG9jb2wKCQkJLy9jb3VsZCBiZSBtYWlsdG8sIGV0YwoJCQlpc0V4dGVybmFsOiBmdW5jdGlvbiggdXJsICkgewoJCQkJdmFyIHUgPSBwYXRoLnBhcnNlVXJsKCB1cmwgKTsKCQkJCXJldHVybiB1LnByb3RvY29sICYmIHUuZG9tYWluICE9PSBkb2N1bWVudFVybC5kb21haW4gPyB0cnVlIDogZmFsc2U7CgkJCX0sCgoJCQloYXNQcm90b2NvbDogZnVuY3Rpb24oIHVybCApIHsKCQkJCXJldHVybiAoIC9eKDo/XHcrOikvICkudGVzdCggdXJsICk7CgkJCX0sCgoJCQkvL2NoZWNrIGlmIHRoZSBzcGVjaWZpZWQgdXJsIHJlZmVycyB0byB0aGUgZmlyc3QgcGFnZSBpbiB0aGUgbWFpbiBhcHBsaWNhdGlvbiBkb2N1bWVudC4KCQkJaXNGaXJzdFBhZ2VVcmw6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQkvLyBXZSBvbmx5IGRlYWwgd2l0aCBhYnNvbHV0ZSBwYXRocy4KCQkJCXZhciB1ID0gcGF0aC5wYXJzZVVybCggcGF0aC5tYWtlVXJsQWJzb2x1dGUoIHVybCwgZG9jdW1lbnRCYXNlICkgKSwKCgkJCQkJLy8gRG9lcyB0aGUgdXJsIGhhdmUgdGhlIHNhbWUgcGF0aCBhcyB0aGUgZG9jdW1lbnQ/CgkJCQkJc2FtZVBhdGggPSB1LmhyZWZOb0hhc2ggPT09IGRvY3VtZW50VXJsLmhyZWZOb0hhc2ggfHwgKCBkb2N1bWVudEJhc2VEaWZmZXJzICYmIHUuaHJlZk5vSGFzaCA9PT0gZG9jdW1lbnRCYXNlLmhyZWZOb0hhc2ggKSwKCgkJCQkJLy8gR2V0IHRoZSBmaXJzdCBwYWdlIGVsZW1lbnQuCgkJCQkJZnAgPSAkLm1vYmlsZS5maXJzdFBhZ2UsCgoJCQkJCS8vIEdldCB0aGUgaWQgb2YgdGhlIGZpcnN0IHBhZ2UgZWxlbWVudCBpZiBpdCBoYXMgb25lLgoJCQkJCWZwSWQgPSBmcCAmJiBmcFswXSA/IGZwWzBdLmlkIDogdW5kZWZpbmVkOwoKCQkJCQkvLyBUaGUgdXJsIHJlZmVycyB0byB0aGUgZmlyc3QgcGFnZSBpZiB0aGUgcGF0aCBtYXRjaGVzIHRoZSBkb2N1bWVudCBhbmQKCQkJCQkvLyBpdCBlaXRoZXIgaGFzIG5vIGhhc2ggdmFsdWUsIG9yIHRoZSBoYXNoIGlzIGV4YWN0bHkgZXF1YWwgdG8gdGhlIGlkIG9mIHRoZQoJCQkJCS8vIGZpcnN0IHBhZ2UgZWxlbWVudC4KCQkJCQlyZXR1cm4gc2FtZVBhdGggJiYgKCAhdS5oYXNoIHx8IHUuaGFzaCA9PT0gIiMiIHx8ICggZnBJZCAmJiB1Lmhhc2gucmVwbGFjZSggL14jLywgIiIgKSA9PT0gZnBJZCApICk7CgkJCX0sCgoJCQlpc0VtYmVkZGVkUGFnZTogZnVuY3Rpb24oIHVybCApIHsKCQkJCXZhciB1ID0gcGF0aC5wYXJzZVVybCggdXJsICk7CgoJCQkJLy9pZiB0aGUgcGF0aCBpcyBhYnNvbHV0ZSwgdGhlbiB3ZSBuZWVkIHRvIGNvbXBhcmUgdGhlIHVybCBhZ2FpbnN0CgkJCQkvL2JvdGggdGhlIGRvY3VtZW50VXJsIGFuZCB0aGUgZG9jdW1lbnRCYXNlLiBUaGUgbWFpbiByZWFzb24gZm9yIHRoaXMKCQkJCS8vaXMgdGhhdCBsaW5rcyBlbWJlZGRlZCB3aXRoaW4gZXh0ZXJuYWwgZG9jdW1lbnRzIHdpbGwgcmVmZXIgdG8gdGhlCgkJCQkvL2FwcGxpY2F0aW9uIGRvY3VtZW50LCB3aGVyZWFzIGxpbmtzIGVtYmVkZGVkIHdpdGhpbiB0aGUgYXBwbGljYXRpb24KCQkJCS8vZG9jdW1lbnQgd2lsbCBiZSByZXNvbHZlZCBhZ2FpbnN0IHRoZSBkb2N1bWVudCBiYXNlLgoJCQkJaWYgKCB1LnByb3RvY29sICE9PSAiIiApIHsKCQkJCQlyZXR1cm4gKCB1Lmhhc2ggJiYgKCB1LmhyZWZOb0hhc2ggPT09IGRvY3VtZW50VXJsLmhyZWZOb0hhc2ggfHwgKCBkb2N1bWVudEJhc2VEaWZmZXJzICYmIHUuaHJlZk5vSGFzaCA9PT0gZG9jdW1lbnRCYXNlLmhyZWZOb0hhc2ggKSApICk7CgkJCQl9CgkJCQlyZXR1cm4gKCAvXiMvICkudGVzdCggdS5ocmVmICk7CgkJCX0sCgoKCQkJLy8gU29tZSBlbWJlZGRlZCBicm93c2VycywgbGlrZSB0aGUgd2ViIHZpZXcgaW4gUGhvbmUgR2FwLCBhbGxvdyBjcm9zcy1kb21haW4gWEhSCgkJCS8vIHJlcXVlc3RzIGlmIHRoZSBkb2N1bWVudCBkb2luZyB0aGUgcmVxdWVzdCB3YXMgbG9hZGVkIHZpYSB0aGUgZmlsZTovLyBwcm90b2NvbC4KCQkJLy8gVGhpcyBpcyB1c3VhbGx5IHRvIGFsbG93IHRoZSBhcHBsaWNhdGlvbiB0byAicGhvbmUgaG9tZSIgYW5kIGZldGNoIGFwcCBzcGVjaWZpYwoJCQkvLyBkYXRhLiBXZSBub3JtYWxseSBsZXQgdGhlIGJyb3dzZXIgaGFuZGxlIGV4dGVybmFsL2Nyb3NzLWRvbWFpbiB1cmxzLCBidXQgaWYgdGhlCgkJCS8vIGFsbG93Q3Jvc3NEb21haW5QYWdlcyBvcHRpb24gaXMgdHJ1ZSwgd2Ugd2lsbCBhbGxvdyBjcm9zcy1kb21haW4gaHR0cC9odHRwcwoJCQkvLyByZXF1ZXN0cyB0byBnbyB0aHJvdWdoIG91ciBwYWdlIGxvYWRpbmcgbG9naWMuCgkJCWlzUGVybWl0dGVkQ3Jvc3NEb21haW5SZXF1ZXN0OiBmdW5jdGlvbiggZG9jVXJsLCByZXFVcmwgKSB7CgkJCQlyZXR1cm4gJC5tb2JpbGUuYWxsb3dDcm9zc0RvbWFpblBhZ2VzICYmCgkJCQkJZG9jVXJsLnByb3RvY29sID09PSAiZmlsZToiICYmCgkJCQkJcmVxVXJsLnNlYXJjaCggL15odHRwcz86LyApICE9PSAtMTsKCQkJfQoJCX0sCgoJCS8vd2lsbCBiZSBkZWZpbmVkIHdoZW4gYSBsaW5rIGlzIGNsaWNrZWQgYW5kIGdpdmVuIGFuIGFjdGl2ZSBjbGFzcwoJCSRhY3RpdmVDbGlja2VkTGluayA9IG51bGwsCgoJCS8vdXJsSGlzdG9yeSBpcyBwdXJlbHkgaGVyZSB0byBtYWtlIGd1ZXNzZXMgYXQgd2hldGhlciB0aGUgYmFjayBvciBmb3J3YXJkIGJ1dHRvbiB3YXMgY2xpY2tlZAoJCS8vYW5kIHByb3ZpZGUgYW4gYXBwcm9wcmlhdGUgdHJhbnNpdGlvbgoJCXVybEhpc3RvcnkgPSB7CgkJCS8vIEFycmF5IG9mIHBhZ2VzIHRoYXQgYXJlIHZpc2l0ZWQgZHVyaW5nIGEgc2luZ2xlIHBhZ2UgbG9hZC4KCQkJLy8gRWFjaCBoYXMgYSB1cmwgYW5kIG9wdGlvbmFsIHRyYW5zaXRpb24sIHRpdGxlLCBhbmQgcGFnZVVybCAod2hpY2ggcmVwcmVzZW50cyB0aGUgZmlsZSBwYXRoLCBpbiBjYXNlcyB3aGVyZSBVUkwgaXMgb2JzY3VyZWQsIHN1Y2ggYXMgZGlhbG9ncykKCQkJc3RhY2s6IFtdLAoKCQkJLy9tYWludGFpbiBhbiBpbmRleCBudW1iZXIgZm9yIHRoZSBhY3RpdmUgcGFnZSBpbiB0aGUgc3RhY2sKCQkJYWN0aXZlSW5kZXg6IDAsCgoJCQkvL2dldCBhY3RpdmUKCQkJZ2V0QWN0aXZlOiBmdW5jdGlvbigpIHsKCQkJCXJldHVybiB1cmxIaXN0b3J5LnN0YWNrWyB1cmxIaXN0b3J5LmFjdGl2ZUluZGV4IF07CgkJCX0sCgoJCQlnZXRQcmV2OiBmdW5jdGlvbigpIHsKCQkJCXJldHVybiB1cmxIaXN0b3J5LnN0YWNrWyB1cmxIaXN0b3J5LmFjdGl2ZUluZGV4IC0gMSBdOwoJCQl9LAoKCQkJZ2V0TmV4dDogZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gdXJsSGlzdG9yeS5zdGFja1sgdXJsSGlzdG9yeS5hY3RpdmVJbmRleCArIDEgXTsKCQkJfSwKCgkJCS8vIGFkZE5ldyBpcyB1c2VkIHdoZW5ldmVyIGEgbmV3IHBhZ2UgaXMgYWRkZWQKCQkJYWRkTmV3OiBmdW5jdGlvbiggdXJsLCB0cmFuc2l0aW9uLCB0aXRsZSwgcGFnZVVybCwgcm9sZSApIHsKCQkJCS8vaWYgdGhlcmUncyBmb3J3YXJkIGhpc3RvcnksIHdpcGUgaXQKCQkJCWlmICggdXJsSGlzdG9yeS5nZXROZXh0KCkgKSB7CgkJCQkJdXJsSGlzdG9yeS5jbGVhckZvcndhcmQoKTsKCQkJCX0KCgkJCQl1cmxIaXN0b3J5LnN0YWNrLnB1c2goIHt1cmwgOiB1cmwsIHRyYW5zaXRpb246IHRyYW5zaXRpb24sIHRpdGxlOiB0aXRsZSwgcGFnZVVybDogcGFnZVVybCwgcm9sZTogcm9sZSB9ICk7CgoJCQkJdXJsSGlzdG9yeS5hY3RpdmVJbmRleCA9IHVybEhpc3Rvcnkuc3RhY2subGVuZ3RoIC0gMTsKCQkJfSwKCgkJCS8vd2lwZSB1cmxzIGFoZWFkIG9mIGFjdGl2ZSBpbmRleAoJCQljbGVhckZvcndhcmQ6IGZ1bmN0aW9uKCkgewoJCQkJdXJsSGlzdG9yeS5zdGFjayA9IHVybEhpc3Rvcnkuc3RhY2suc2xpY2UoIDAsIHVybEhpc3RvcnkuYWN0aXZlSW5kZXggKyAxICk7CgkJCX0sCgoJCQlkaXJlY3RIYXNoQ2hhbmdlOiBmdW5jdGlvbiggb3B0cyApIHsKCQkJCXZhciBiYWNrICwgZm9yd2FyZCwgbmV3QWN0aXZlSW5kZXgsIHByZXYgPSB0aGlzLmdldEFjdGl2ZSgpOwoKCQkJCS8vIGNoZWNrIGlmIHVybCBpcyBpbiBoaXN0b3J5IGFuZCBpZiBpdCdzIGFoZWFkIG9yIGJlaGluZCBjdXJyZW50IHBhZ2UKCQkJCSQuZWFjaCggdXJsSGlzdG9yeS5zdGFjaywgZnVuY3Rpb24oIGksIGhpc3RvcnlFbnRyeSApIHsKCgkJCQkJLy9pZiB0aGUgdXJsIGlzIGluIHRoZSBzdGFjaywgaXQncyBhIGZvcndhcmQgb3IgYSBiYWNrCgkJCQkJaWYgKCBkZWNvZGVVUklDb21wb25lbnQoIG9wdHMuY3VycmVudFVybCApID09PSBkZWNvZGVVUklDb21wb25lbnQoIGhpc3RvcnlFbnRyeS51cmwgKSApIHsKCQkJCQkJLy9kZWZpbmUgYmFjayBhbmQgZm9yd2FyZCBieSB3aGV0aGVyIHVybCBpcyBvbGRlciBvciBuZXdlciB0aGFuIGN1cnJlbnQgcGFnZQoJCQkJCQliYWNrID0gaSA8IHVybEhpc3RvcnkuYWN0aXZlSW5kZXg7CgkJCQkJCWZvcndhcmQgPSAhYmFjazsKCQkJCQkJbmV3QWN0aXZlSW5kZXggPSBpOwoJCQkJCX0KCQkJCX0pOwoKCQkJCS8vIHNhdmUgbmV3IHBhZ2UgaW5kZXgsIG51bGwgY2hlY2sgdG8gcHJldmVudCBmYWxzZXkgMCByZXN1bHQKCQkJCXRoaXMuYWN0aXZlSW5kZXggPSBuZXdBY3RpdmVJbmRleCAhPT0gdW5kZWZpbmVkID8gbmV3QWN0aXZlSW5kZXggOiB0aGlzLmFjdGl2ZUluZGV4OwoKCQkJCWlmICggYmFjayApIHsKCQkJCQkoIG9wdHMuZWl0aGVyIHx8IG9wdHMuaXNCYWNrICkoIHRydWUgKTsKCQkJCX0gZWxzZSBpZiAoIGZvcndhcmQgKSB7CgkJCQkJKCBvcHRzLmVpdGhlciB8fCBvcHRzLmlzRm9yd2FyZCApKCBmYWxzZSApOwoJCQkJfQoJCQl9LAoKCQkJLy9kaXNhYmxlIGhhc2hjaGFuZ2UgZXZlbnQgbGlzdGVuZXIgaW50ZXJuYWxseSB0byBpZ25vcmUgb25lIGNoYW5nZQoJCQkvL3RvZ2dsZWQgaW50ZXJuYWxseSB3aGVuIGxvY2F0aW9uLmhhc2ggaXMgdXBkYXRlZCB0byBtYXRjaCB0aGUgdXJsIG9mIGEgc3VjY2Vzc2Z1bCBwYWdlIGxvYWQKCQkJaWdub3JlTmV4dEhhc2hDaGFuZ2U6IGZhbHNlCgkJfSwKCgkJLy9kZWZpbmUgZmlyc3Qgc2VsZWN0b3IgdG8gcmVjZWl2ZSBmb2N1cyB3aGVuIGEgcGFnZSBpcyBzaG93bgoJCWZvY3VzYWJsZSA9ICJbdGFiaW5kZXhdLGEsYnV0dG9uOnZpc2libGUsc2VsZWN0OnZpc2libGUsaW5wdXQiLAoKCQkvL3F1ZXVlIHRvIGhvbGQgc2ltdWx0YW5pb3VzIHBhZ2UgdHJhbnNpdGlvbnMKCQlwYWdlVHJhbnNpdGlvblF1ZXVlID0gW10sCgoJCS8vaW5kaWNhdGVzIHdoZXRoZXIgb3Igbm90IHBhZ2UgaXMgaW4gcHJvY2VzcyBvZiB0cmFuc2l0aW9uaW5nCgkJaXNQYWdlVHJhbnNpdGlvbmluZyA9IGZhbHNlLAoKCQkvL25vbnNlbnNlIGhhc2ggY2hhbmdlIGtleSBmb3IgZGlhbG9ncywgc28gdGhleSBjcmVhdGUgYSBoaXN0b3J5IGVudHJ5CgkJZGlhbG9nSGFzaEtleSA9ICImdWktc3RhdGU9ZGlhbG9nIiwKCgkJLy9leGlzdGluZyBiYXNlIHRhZz8KCQkkYmFzZSA9ICRoZWFkLmNoaWxkcmVuKCAiYmFzZSIgKSwKCgkJLy90dWNrIGF3YXkgdGhlIG9yaWdpbmFsIGRvY3VtZW50IFVSTCBtaW51cyBhbnkgZnJhZ21lbnQuCgkJZG9jdW1lbnRVcmwgPSBwYXRoLnBhcnNlTG9jYXRpb24oKSwKCgkJLy9pZiB0aGUgZG9jdW1lbnQgaGFzIGFuIGVtYmVkZGVkIGJhc2UgdGFnLCBkb2N1bWVudEJhc2UgaXMgc2V0IHRvIGl0cwoJCS8vaW5pdGlhbCB2YWx1ZS4gSWYgYSBiYXNlIHRhZyBkb2VzIG5vdCBleGlzdCwgdGhlbiB3ZSBkZWZhdWx0IHRvIHRoZSBkb2N1bWVudFVybC4KCQlkb2N1bWVudEJhc2UgPSAkYmFzZS5sZW5ndGggPyBwYXRoLnBhcnNlVXJsKCBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggJGJhc2UuYXR0ciggImhyZWYiICksIGRvY3VtZW50VXJsLmhyZWYgKSApIDogZG9jdW1lbnRVcmwsCgoJCS8vY2FjaGUgdGhlIGNvbXBhcmlzb24gb25jZS4KCQlkb2N1bWVudEJhc2VEaWZmZXJzID0gKCBkb2N1bWVudFVybC5ocmVmTm9IYXNoICE9PSBkb2N1bWVudEJhc2UuaHJlZk5vSGFzaCApLAoKCQlnZXRTY3JlZW5IZWlnaHQgPSAkLm1vYmlsZS5nZXRTY3JlZW5IZWlnaHQ7CgoJCS8vYmFzZSBlbGVtZW50IG1hbmFnZW1lbnQsIGRlZmluZWQgZGVwZW5kaW5nIG9uIGR5bmFtaWMgYmFzZSB0YWcgc3VwcG9ydAoJCXZhciBiYXNlID0gJC5zdXBwb3J0LmR5bmFtaWNCYXNlVGFnID8gewoKCQkJLy9kZWZpbmUgYmFzZSBlbGVtZW50LCBmb3IgdXNlIGluIHJvdXRpbmcgYXNzZXQgdXJscyB0aGF0IGFyZSByZWZlcmVuY2VkIGluIEFqYXgtcmVxdWVzdGVkIG1hcmt1cAoJCQllbGVtZW50OiAoICRiYXNlLmxlbmd0aCA/ICRiYXNlIDogJCggIjxiYXNlPiIsIHsgaHJlZjogZG9jdW1lbnRCYXNlLmhyZWZOb0hhc2ggfSApLnByZXBlbmRUbyggJGhlYWQgKSApLAoKCQkJLy9zZXQgdGhlIGdlbmVyYXRlZCBCQVNFIGVsZW1lbnQncyBocmVmIGF0dHJpYnV0ZSB0byBhIG5ldyBwYWdlJ3MgYmFzZSBwYXRoCgkJCXNldDogZnVuY3Rpb24oIGhyZWYgKSB7CgkJCQliYXNlLmVsZW1lbnQuYXR0ciggImhyZWYiLCBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggaHJlZiwgZG9jdW1lbnRCYXNlICkgKTsKCQkJfSwKCgkJCS8vc2V0IHRoZSBnZW5lcmF0ZWQgQkFTRSBlbGVtZW50J3MgaHJlZiBhdHRyaWJ1dGUgdG8gYSBuZXcgcGFnZSdzIGJhc2UgcGF0aAoJCQlyZXNldDogZnVuY3Rpb24oKSB7CgkJCQliYXNlLmVsZW1lbnQuYXR0ciggImhyZWYiLCBkb2N1bWVudEJhc2UuaHJlZk5vSGFzaCApOwoJCQl9CgoJCX0gOiB1bmRlZmluZWQ7CgoJLyogaW50ZXJuYWwgdXRpbGl0eSBmdW5jdGlvbnMgKi8KCgkvLyBOT1RFIElzc3VlICM0OTUwIEFuZHJvaWQgcGhvbmVnYXAgZG9lc24ndCBuYXZpZ2F0ZSBiYWNrIHByb3Blcmx5CgkvLyAgICAgIHdoZW4gYSBmdWxsIHBhZ2UgcmVmcmVzaCBoYXMgdGFrZW4gcGxhY2UuIEl0IGFwcGVhcnMgdGhhdCBoYXNoY2hhbmdlCgkvLyAgICAgIGFuZCByZXBsYWNlc3RhdGUgaGlzdG9yeSBhbHRlcmF0aW9ucyB3b3JrIGZpbmUgYnV0IHdlIG5lZWQgdG8gc3VwcG9ydAoJLy8gICAgICBib3RoIGZvcm1zIG9mIGhpc3RvcnkgdHJhdmVyc2FsIGluIG91ciBjb2RlIHRoYXQgdXNlcyBiYWNrd2FyZCBoaXN0b3J5CgkvLyAgICAgIG1vdmVtZW50CgkkLm1vYmlsZS5iYWNrID0gZnVuY3Rpb24oKSB7CgkJdmFyIG5hdiA9IHdpbmRvdy5uYXZpZ2F0b3I7CgoJCS8vIGlmIHRoZSBzZXR0aW5nIGlzIG9uIGFuZCB0aGUgbmF2aWdhdG9yIG9iamVjdCBpcwoJCS8vIGF2YWlsYWJsZSB1c2UgdGhlIHBob25lZ2FwIG5hdmlnYXRpb24gY2FwYWJpbGl0eQoJCWlmKCB0aGlzLnBob25lZ2FwTmF2aWdhdGlvbkVuYWJsZWQgJiYKCQkJbmF2ICYmCgkJCW5hdi5hcHAgJiYKCQkJbmF2LmFwcC5iYWNrSGlzdG9yeSApewoJCQluYXYuYXBwLmJhY2tIaXN0b3J5KCk7CgkJfSBlbHNlIHsKCQkJd2luZG93Lmhpc3RvcnkuYmFjaygpOwoJCX0KCX07CgoJLy9kaXJlY3QgZm9jdXMgdG8gdGhlIHBhZ2UgdGl0bGUsIG9yIG90aGVyd2lzZSBmaXJzdCBmb2N1c2FibGUgZWxlbWVudAoJJC5tb2JpbGUuZm9jdXNQYWdlID0gZnVuY3Rpb24gKCBwYWdlICkgewoJCXZhciBhdXRvZm9jdXMgPSBwYWdlLmZpbmQoICJbYXV0b2ZvY3VzXSIgKSwKCQkJcGFnZVRpdGxlID0gcGFnZS5maW5kKCAiLnVpLXRpdGxlOmVxKDApIiApOwoKCQlpZiAoIGF1dG9mb2N1cy5sZW5ndGggKSB7CgkJCWF1dG9mb2N1cy5mb2N1cygpOwoJCQlyZXR1cm47CgkJfQoKCQlpZiAoIHBhZ2VUaXRsZS5sZW5ndGggKSB7CgkJCXBhZ2VUaXRsZS5mb2N1cygpOwoJCX0gZWxzZXsKCQkJcGFnZS5mb2N1cygpOwoJCX0KCX07CgoJLy9yZW1vdmUgYWN0aXZlIGNsYXNzZXMgYWZ0ZXIgcGFnZSB0cmFuc2l0aW9uIG9yIGVycm9yCglmdW5jdGlvbiByZW1vdmVBY3RpdmVMaW5rQ2xhc3MoIGZvcmNlUmVtb3ZhbCApIHsKCQlpZiAoICEhJGFjdGl2ZUNsaWNrZWRMaW5rICYmICggISRhY3RpdmVDbGlja2VkTGluay5jbG9zZXN0KCAiLiIgKyAkLm1vYmlsZS5hY3RpdmVQYWdlQ2xhc3MgKS5sZW5ndGggfHwgZm9yY2VSZW1vdmFsICkgKSB7CgkJCSRhY3RpdmVDbGlja2VkTGluay5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQl9CgkJJGFjdGl2ZUNsaWNrZWRMaW5rID0gbnVsbDsKCX0KCglmdW5jdGlvbiByZWxlYXNlUGFnZVRyYW5zaXRpb25Mb2NrKCkgewoJCWlzUGFnZVRyYW5zaXRpb25pbmcgPSBmYWxzZTsKCQlpZiAoIHBhZ2VUcmFuc2l0aW9uUXVldWUubGVuZ3RoID4gMCApIHsKCQkJJC5tb2JpbGUuY2hhbmdlUGFnZS5hcHBseSggbnVsbCwgcGFnZVRyYW5zaXRpb25RdWV1ZS5wb3AoKSApOwoJCX0KCX0KCgkvLyBTYXZlIHRoZSBsYXN0IHNjcm9sbCBkaXN0YW5jZSBwZXIgcGFnZSwgYmVmb3JlIGl0IGlzIGhpZGRlbgoJdmFyIHNldExhc3RTY3JvbGxFbmFibGVkID0gdHJ1ZSwKCQlzZXRMYXN0U2Nyb2xsLCBkZWxheWVkU2V0TGFzdFNjcm9sbDsKCglzZXRMYXN0U2Nyb2xsID0gZnVuY3Rpb24oKSB7CgkJLy8gdGhpcyBiYXJyaWVyIHByZXZlbnRzIHNldHRpbmcgdGhlIHNjcm9sbCB2YWx1ZSBiYXNlZCBvbiB0aGUgYnJvd3NlcgoJCS8vIHNjcm9sbGluZyB0aGUgd2luZG93IGJhc2VkIG9uIGEgaGFzaGNoYW5nZQoJCWlmICggIXNldExhc3RTY3JvbGxFbmFibGVkICkgewoJCQlyZXR1cm47CgkJfQoKCQl2YXIgYWN0aXZlID0gJC5tb2JpbGUudXJsSGlzdG9yeS5nZXRBY3RpdmUoKTsKCgkJaWYgKCBhY3RpdmUgKSB7CgkJCXZhciBsYXN0U2Nyb2xsID0gJHdpbmRvdy5zY3JvbGxUb3AoKTsKCgkJCS8vIFNldCBhY3RpdmUgcGFnZSdzIGxhc3RTY3JvbGwgcHJvcC4KCQkJLy8gSWYgdGhlIGxvY2F0aW9uIHdlJ3JlIHNjcm9sbGluZyB0byBpcyBsZXNzIHRoYW4gbWluU2Nyb2xsQmFjaywgbGV0IGl0IGdvLgoJCQlhY3RpdmUubGFzdFNjcm9sbCA9IGxhc3RTY3JvbGwgPCAkLm1vYmlsZS5taW5TY3JvbGxCYWNrID8gJC5tb2JpbGUuZGVmYXVsdEhvbWVTY3JvbGwgOiBsYXN0U2Nyb2xsOwoJCX0KCX07CgoJLy8gYmluZCB0byBzY3JvbGxzdG9wIHRvIGdhdGhlciBzY3JvbGwgcG9zaXRpb24uIFRoZSBkZWxheSBhbGxvd3MgZm9yIHRoZSBoYXNoY2hhbmdlCgkvLyBldmVudCB0byBmaXJlIGFuZCBkaXNhYmxlIHNjcm9sbCByZWNvcmRpbmcgaW4gdGhlIGNhc2Ugd2hlcmUgdGhlIGJyb3dzZXIgc2Nyb2xscwoJLy8gdG8gdGhlIGhhc2ggdGFyZ2V0cyBsb2NhdGlvbiAoc29tZXRpbWVzIHRoZSB0b3Agb2YgdGhlIHBhZ2UpLiBvbmNlIHBhZ2VjaGFuZ2UgZmlyZXMKCS8vIGdldExhc3RTY3JvbGwgaXMgYWdhaW4gcGVybWl0dGVkIHRvIG9wZXJhdGUKCWRlbGF5ZWRTZXRMYXN0U2Nyb2xsID0gZnVuY3Rpb24oKSB7CgkJc2V0VGltZW91dCggc2V0TGFzdFNjcm9sbCwgMTAwICk7Cgl9OwoKCS8vIGRpc2FibGUgYW4gc2Nyb2xsIHNldHRpbmcgd2hlbiBhIGhhc2hjaGFuZ2UgaGFzIGJlZW4gZmlyZWQsIHRoaXMgb25seSB3b3JrcwoJLy8gYmVjYXVzZSB0aGUgcmVjb3JkaW5nIG9mIHRoZSBzY3JvbGwgcG9zaXRpb24gaXMgZGVsYXllZCBmb3IgMTAwbXMgYWZ0ZXIKCS8vIHRoZSBicm93c2VyIG1pZ2h0IGhhdmUgY2hhbmdlZCB0aGUgcG9zaXRpb24gYmVjYXVzZSBvZiB0aGUgaGFzaGNoYW5nZQoJJHdpbmRvdy5iaW5kKCAkLnN1cHBvcnQucHVzaFN0YXRlID8gInBvcHN0YXRlIiA6ICJoYXNoY2hhbmdlIiwgZnVuY3Rpb24oKSB7CgkJc2V0TGFzdFNjcm9sbEVuYWJsZWQgPSBmYWxzZTsKCX0pOwoKCS8vIGhhbmRsZSBpbml0aWFsIGhhc2hjaGFuZ2UgZnJvbSBjaHJvbWUgOigKCSR3aW5kb3cub25lKCAkLnN1cHBvcnQucHVzaFN0YXRlID8gInBvcHN0YXRlIiA6ICJoYXNoY2hhbmdlIiwgZnVuY3Rpb24oKSB7CgkJc2V0TGFzdFNjcm9sbEVuYWJsZWQgPSB0cnVlOwoJfSk7CgoJLy8gd2FpdCB1bnRpbCB0aGUgbW9iaWxlIHBhZ2UgY29udGFpbmVyIGhhcyBiZWVuIGRldGVybWluZWQgdG8gYmluZCB0byBwYWdlY2hhbmdlCgkkd2luZG93Lm9uZSggInBhZ2Vjb250YWluZXJjcmVhdGUiLCBmdW5jdGlvbigpIHsKCQkvLyBvbmNlIHRoZSBwYWdlIGhhcyBjaGFuZ2VkLCByZS1lbmFibGUgdGhlIHNjcm9sbCByZWNvcmRpbmcKCQkkLm1vYmlsZS5wYWdlQ29udGFpbmVyLmJpbmQoICJwYWdlY2hhbmdlIiwgZnVuY3Rpb24oKSB7CgoJCQlzZXRMYXN0U2Nyb2xsRW5hYmxlZCA9IHRydWU7CgoJCQkvLyByZW1vdmUgYW55IGJpbmRpbmcgdGhhdCBwcmV2aW91c2x5IGV4aXN0ZWQgb24gdGhlIGdldCBzY3JvbGwKCQkJLy8gd2hpY2ggbWF5IG9yIG1heSBub3QgYmUgZGlmZmVyZW50IHRoYW4gdGhlIHNjcm9sbCBlbGVtZW50IGRldGVybWluZWQgZm9yCgkJCS8vIHRoaXMgcGFnZSBwcmV2aW91c2x5CgkJCSR3aW5kb3cudW5iaW5kKCAic2Nyb2xsc3RvcCIsIGRlbGF5ZWRTZXRMYXN0U2Nyb2xsICk7CgoJCQkvLyBkZXRlcm1pbmUgYW5kIGJpbmQgdG8gdGhlIGN1cnJlbnQgc2NvbGwgZWxlbWVudCB3aGljaCBtYXkgYmUgdGhlIHdpbmRvdwoJCQkvLyBvciBpbiB0aGUgY2FzZSBvZiB0b3VjaCBvdmVyZmxvdyB0aGUgZWxlbWVudCB3aXRoIHRvdWNoIG92ZXJmbG93CgkJCSR3aW5kb3cuYmluZCggInNjcm9sbHN0b3AiLCBkZWxheWVkU2V0TGFzdFNjcm9sbCApOwoJCX0pOwoJfSk7CgoJLy8gYmluZCB0byBzY3JvbGxzdG9wIGZvciB0aGUgZmlyc3QgcGFnZSBhcyAicGFnZWNoYW5nZSIgd29uJ3QgYmUgZmlyZWQgaW4gdGhhdCBjYXNlCgkkd2luZG93LmJpbmQoICJzY3JvbGxzdG9wIiwgZGVsYXllZFNldExhc3RTY3JvbGwgKTsKCgkvLyBOby1vcCBpbXBsZW1lbnRhdGlvbiBvZiB0cmFuc2l0aW9uIGRlZ3JhZGF0aW9uCgkkLm1vYmlsZS5fbWF5YmVEZWdyYWRlVHJhbnNpdGlvbiA9ICQubW9iaWxlLl9tYXliZURlZ3JhZGVUcmFuc2l0aW9uIHx8IGZ1bmN0aW9uKCB0cmFuc2l0aW9uICkgewoJCXJldHVybiB0cmFuc2l0aW9uOwoJfTsKCgkvL2Z1bmN0aW9uIGZvciB0cmFuc2l0aW9uaW5nIGJldHdlZW4gdHdvIGV4aXN0aW5nIHBhZ2VzCglmdW5jdGlvbiB0cmFuc2l0aW9uUGFnZXMoIHRvUGFnZSwgZnJvbVBhZ2UsIHRyYW5zaXRpb24sIHJldmVyc2UgKSB7CgoJCWlmICggZnJvbVBhZ2UgKSB7CgkJCS8vdHJpZ2dlciBiZWZvcmUgc2hvdy9oaWRlIGV2ZW50cwoJCQlmcm9tUGFnZS5kYXRhKCAicGFnZSIgKS5fdHJpZ2dlciggImJlZm9yZWhpZGUiLCBudWxsLCB7IG5leHRQYWdlOiB0b1BhZ2UgfSApOwoJCX0KCgkJdG9QYWdlLmRhdGEoICJwYWdlIiApLl90cmlnZ2VyKCAiYmVmb3Jlc2hvdyIsIG51bGwsIHsgcHJldlBhZ2U6IGZyb21QYWdlIHx8ICQoICIiICkgfSApOwoKCQkvL2NsZWFyIHBhZ2UgbG9hZGVyCgkJJC5tb2JpbGUuaGlkZVBhZ2VMb2FkaW5nTXNnKCk7CgoJCXRyYW5zaXRpb24gPSAkLm1vYmlsZS5fbWF5YmVEZWdyYWRlVHJhbnNpdGlvbiggdHJhbnNpdGlvbiApOwoKCQkvL2ZpbmQgdGhlIHRyYW5zaXRpb24gaGFuZGxlciBmb3IgdGhlIHNwZWNpZmllZCB0cmFuc2l0aW9uLiBJZiB0aGVyZQoJCS8vaXNuJ3Qgb25lIGluIG91ciB0cmFuc2l0aW9uSGFuZGxlcnMgZGljdGlvbmFyeSwgdXNlIHRoZSBkZWZhdWx0IG9uZS4KCQkvL2NhbGwgdGhlIGhhbmRsZXIgaW1tZWRpYXRlbHkgdG8ga2ljay1vZmYgdGhlIHRyYW5zaXRpb24uCgkJdmFyIHRoID0gJC5tb2JpbGUudHJhbnNpdGlvbkhhbmRsZXJzWyB0cmFuc2l0aW9uIHx8ICJkZWZhdWx0IiBdIHx8ICQubW9iaWxlLmRlZmF1bHRUcmFuc2l0aW9uSGFuZGxlciwKCQkJcHJvbWlzZSA9IHRoKCB0cmFuc2l0aW9uLCByZXZlcnNlLCB0b1BhZ2UsIGZyb21QYWdlICk7CgoJCXByb21pc2UuZG9uZShmdW5jdGlvbigpIHsKCgkJCS8vdHJpZ2dlciBzaG93L2hpZGUgZXZlbnRzCgkJCWlmICggZnJvbVBhZ2UgKSB7CgkJCQlmcm9tUGFnZS5kYXRhKCAicGFnZSIgKS5fdHJpZ2dlciggImhpZGUiLCBudWxsLCB7IG5leHRQYWdlOiB0b1BhZ2UgfSApOwoJCQl9CgoJCQkvL3RyaWdnZXIgcGFnZXNob3csIGRlZmluZSBwcmV2UGFnZSBhcyBlaXRoZXIgZnJvbVBhZ2Ugb3IgZW1wdHkgalF1ZXJ5IG9iagoJCQl0b1BhZ2UuZGF0YSggInBhZ2UiICkuX3RyaWdnZXIoICJzaG93IiwgbnVsbCwgeyBwcmV2UGFnZTogZnJvbVBhZ2UgfHwgJCggIiIgKSB9ICk7CgkJfSk7CgoJCXJldHVybiBwcm9taXNlOwoJfQoKCS8vc2ltcGx5IHNldCB0aGUgYWN0aXZlIHBhZ2UncyBtaW5pbXVtIGhlaWdodCB0byBzY3JlZW4gaGVpZ2h0LCBkZXBlbmRpbmcgb24gb3JpZW50YXRpb24KCWZ1bmN0aW9uIHJlc2V0QWN0aXZlUGFnZUhlaWdodCgpIHsKCQl2YXIgYVBhZ2UgPSAkKCAiLiIgKyAkLm1vYmlsZS5hY3RpdmVQYWdlQ2xhc3MgKSwKCQkJYVBhZ2VQYWRUID0gcGFyc2VGbG9hdCggYVBhZ2UuY3NzKCAicGFkZGluZy10b3AiICkgKSwKCQkJYVBhZ2VQYWRCID0gcGFyc2VGbG9hdCggYVBhZ2UuY3NzKCAicGFkZGluZy1ib3R0b20iICkgKSwKCQkJYVBhZ2VCb3JkZXJUID0gcGFyc2VGbG9hdCggYVBhZ2UuY3NzKCAiYm9yZGVyLXRvcC13aWR0aCIgKSApLAoJCQlhUGFnZUJvcmRlckIgPSBwYXJzZUZsb2F0KCBhUGFnZS5jc3MoICJib3JkZXItYm90dG9tLXdpZHRoIiApICk7CgoJCWFQYWdlLmNzcyggIm1pbi1oZWlnaHQiLCBnZXRTY3JlZW5IZWlnaHQoKSAtIGFQYWdlUGFkVCAtIGFQYWdlUGFkQiAtIGFQYWdlQm9yZGVyVCAtIGFQYWdlQm9yZGVyQiApOwoJfQoKCS8vc2hhcmVkIHBhZ2UgZW5oYW5jZW1lbnRzCglmdW5jdGlvbiBlbmhhbmNlUGFnZSggJHBhZ2UsIHJvbGUgKSB7CgkJLy8gSWYgYSByb2xlIHdhcyBzcGVjaWZpZWQsIG1ha2Ugc3VyZSB0aGUgZGF0YS1yb2xlIGF0dHJpYnV0ZQoJCS8vIG9uIHRoZSBwYWdlIGVsZW1lbnQgaXMgaW4gc3luYy4KCQlpZiAoIHJvbGUgKSB7CgkJCSRwYWdlLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyb2xlIiwgcm9sZSApOwoJCX0KCgkJLy9ydW4gcGFnZSBwbHVnaW4KCQkkcGFnZS5wYWdlKCk7Cgl9CgoJLyogZXhwb3NlZCAkLm1vYmlsZSBtZXRob2RzICovCgoJLy9hbmltYXRpb24gY29tcGxldGUgY2FsbGJhY2sKCSQuZm4uYW5pbWF0aW9uQ29tcGxldGUgPSBmdW5jdGlvbiggY2FsbGJhY2sgKSB7CgkJaWYgKCAkLnN1cHBvcnQuY3NzVHJhbnNpdGlvbnMgKSB7CgkJCXJldHVybiAkKCB0aGlzICkub25lKCAnd2Via2l0QW5pbWF0aW9uRW5kIGFuaW1hdGlvbmVuZCcsIGNhbGxiYWNrICk7CgkJfQoJCWVsc2V7CgkJCS8vIGRlZmVyIGV4ZWN1dGlvbiBmb3IgY29uc2lzdGVuY3kgYmV0d2VlbiB3ZWJraXQvbm9uIHdlYmtpdAoJCQlzZXRUaW1lb3V0KCBjYWxsYmFjaywgMCApOwoJCQlyZXR1cm4gJCggdGhpcyApOwoJCX0KCX07CgoJLy9leHBvc2UgcGF0aCBvYmplY3Qgb24gJC5tb2JpbGUKCSQubW9iaWxlLnBhdGggPSBwYXRoOwoKCS8vZXhwb3NlIGJhc2Ugb2JqZWN0IG9uICQubW9iaWxlCgkkLm1vYmlsZS5iYXNlID0gYmFzZTsKCgkvL2hpc3Rvcnkgc3RhY2sKCSQubW9iaWxlLnVybEhpc3RvcnkgPSB1cmxIaXN0b3J5OwoKCSQubW9iaWxlLmRpYWxvZ0hhc2hLZXkgPSBkaWFsb2dIYXNoS2V5OwoKCgoJLy9lbmFibGUgY3Jvc3MtZG9tYWluIHBhZ2Ugc3VwcG9ydAoJJC5tb2JpbGUuYWxsb3dDcm9zc0RvbWFpblBhZ2VzID0gZmFsc2U7CgoJLy9yZXR1cm4gdGhlIG9yaWdpbmFsIGRvY3VtZW50IHVybAoJJC5tb2JpbGUuZ2V0RG9jdW1lbnRVcmwgPSBmdW5jdGlvbiggYXNQYXJzZWRPYmplY3QgKSB7CgkJcmV0dXJuIGFzUGFyc2VkT2JqZWN0ID8gJC5leHRlbmQoIHt9LCBkb2N1bWVudFVybCApIDogZG9jdW1lbnRVcmwuaHJlZjsKCX07CgoJLy9yZXR1cm4gdGhlIG9yaWdpbmFsIGRvY3VtZW50IGJhc2UgdXJsCgkkLm1vYmlsZS5nZXREb2N1bWVudEJhc2UgPSBmdW5jdGlvbiggYXNQYXJzZWRPYmplY3QgKSB7CgkJcmV0dXJuIGFzUGFyc2VkT2JqZWN0ID8gJC5leHRlbmQoIHt9LCBkb2N1bWVudEJhc2UgKSA6IGRvY3VtZW50QmFzZS5ocmVmOwoJfTsKCgkkLm1vYmlsZS5fYmluZFBhZ2VSZW1vdmUgPSBmdW5jdGlvbigpIHsKCQl2YXIgcGFnZSA9ICQoIHRoaXMgKTsKCgkJLy8gd2hlbiBkb20gY2FjaGluZyBpcyBub3QgZW5hYmxlZCBvciB0aGUgcGFnZSBpcyBlbWJlZGRlZCBiaW5kIHRvIHJlbW92ZSB0aGUgcGFnZSBvbiBoaWRlCgkJaWYgKCAhcGFnZS5kYXRhKCAicGFnZSIgKS5vcHRpb25zLmRvbUNhY2hlICYmCgkJCQlwYWdlLmlzKCAiOmpxbURhdGEoZXh0ZXJuYWwtcGFnZT0ndHJ1ZScpIiApICkgewoKCQkJcGFnZS5iaW5kKCAncGFnZWhpZGUucmVtb3ZlJywgZnVuY3Rpb24oKSB7CgkJCQl2YXIgJHRoaXMgPSAkKCB0aGlzICksCgkJCQkJcHJFdmVudCA9IG5ldyAkLkV2ZW50KCAicGFnZXJlbW92ZSIgKTsKCgkJCQkkdGhpcy50cmlnZ2VyKCBwckV2ZW50ICk7CgoJCQkJaWYgKCAhcHJFdmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJCQkkdGhpcy5yZW1vdmVXaXRoRGVwZW5kZW50cygpOwoJCQkJfQoJCQl9KTsKCQl9Cgl9OwoKCS8vIExvYWQgYSBwYWdlIGludG8gdGhlIERPTS4KCSQubW9iaWxlLmxvYWRQYWdlID0gZnVuY3Rpb24oIHVybCwgb3B0aW9ucyApIHsKCQkvLyBUaGlzIGZ1bmN0aW9uIHVzZXMgZGVmZXJyZWQgbm90aWZpY2F0aW9ucyB0byBsZXQgY2FsbGVycwoJCS8vIGtub3cgd2hlbiB0aGUgcGFnZSBpcyBkb25lIGxvYWRpbmcsIG9yIGlmIGFuIGVycm9yIGhhcyBvY2N1cnJlZC4KCQl2YXIgZGVmZXJyZWQgPSAkLkRlZmVycmVkKCksCgoJCQkvLyBUaGUgZGVmYXVsdCBsb2FkUGFnZSBvcHRpb25zIHdpdGggb3ZlcnJpZGVzIHNwZWNpZmllZCBieQoJCQkvLyB0aGUgY2FsbGVyLgoJCQlzZXR0aW5ncyA9ICQuZXh0ZW5kKCB7fSwgJC5tb2JpbGUubG9hZFBhZ2UuZGVmYXVsdHMsIG9wdGlvbnMgKSwKCgkJCS8vIFRoZSBET00gZWxlbWVudCBmb3IgdGhlIHBhZ2UgYWZ0ZXIgaXQgaGFzIGJlZW4gbG9hZGVkLgoJCQlwYWdlID0gbnVsbCwKCgkJCS8vIElmIHRoZSByZWxvYWRQYWdlIG9wdGlvbiBpcyB0cnVlLCBhbmQgdGhlIHBhZ2UgaXMgYWxyZWFkeQoJCQkvLyBpbiB0aGUgRE9NLCBkdXBDYWNoZWRQYWdlIHdpbGwgYmUgc2V0IHRvIHRoZSBwYWdlIGVsZW1lbnQKCQkJLy8gc28gdGhhdCBpdCBjYW4gYmUgcmVtb3ZlZCBhZnRlciB0aGUgbmV3IHZlcnNpb24gb2YgdGhlCgkJCS8vIHBhZ2UgaXMgbG9hZGVkIG9mZiB0aGUgbmV0d29yay4KCQkJZHVwQ2FjaGVkUGFnZSA9IG51bGwsCgoJCQkvLyBkZXRlcm1pbmUgdGhlIGN1cnJlbnQgYmFzZSB1cmwKCQkJZmluZEJhc2VXaXRoRGVmYXVsdCA9IGZ1bmN0aW9uKCkgewoJCQkJdmFyIGNsb3Nlc3RCYXNlID0gKCAkLm1vYmlsZS5hY3RpdmVQYWdlICYmIGdldENsb3Nlc3RCYXNlVXJsKCAkLm1vYmlsZS5hY3RpdmVQYWdlICkgKTsKCQkJCXJldHVybiBjbG9zZXN0QmFzZSB8fCBkb2N1bWVudEJhc2UuaHJlZk5vSGFzaDsKCQkJfSwKCgkJCS8vIFRoZSBhYnNvbHV0ZSB2ZXJzaW9uIG9mIHRoZSBVUkwgcGFzc2VkIGludG8gdGhlIGZ1bmN0aW9uLiBUaGlzCgkJCS8vIHZlcnNpb24gb2YgdGhlIFVSTCBtYXkgY29udGFpbiBkaWFsb2cvc3VicGFnZSBwYXJhbXMgaW4gaXQuCgkJCWFic1VybCA9IHBhdGgubWFrZVVybEFic29sdXRlKCB1cmwsIGZpbmRCYXNlV2l0aERlZmF1bHQoKSApOwoKCgkJLy8gSWYgdGhlIGNhbGxlciBwcm92aWRlZCBkYXRhLCBhbmQgd2UncmUgdXNpbmcgImdldCIgcmVxdWVzdCwKCQkvLyBhcHBlbmQgdGhlIGRhdGEgdG8gdGhlIFVSTC4KCQlpZiAoIHNldHRpbmdzLmRhdGEgJiYgc2V0dGluZ3MudHlwZSA9PT0gImdldCIgKSB7CgkJCWFic1VybCA9IHBhdGguYWRkU2VhcmNoUGFyYW1zKCBhYnNVcmwsIHNldHRpbmdzLmRhdGEgKTsKCQkJc2V0dGluZ3MuZGF0YSA9IHVuZGVmaW5lZDsKCQl9CgoJCS8vIElmIHRoZSBjYWxsZXIgaXMgdXNpbmcgYSAicG9zdCIgcmVxdWVzdCwgcmVsb2FkUGFnZSBtdXN0IGJlIHRydWUKCQlpZiAoIHNldHRpbmdzLmRhdGEgJiYgc2V0dGluZ3MudHlwZSA9PT0gInBvc3QiICkgewoJCQlzZXR0aW5ncy5yZWxvYWRQYWdlID0gdHJ1ZTsKCQl9CgoJCS8vIFRoZSBhYnNvbHV0ZSB2ZXJzaW9uIG9mIHRoZSBVUkwgbWludXMgYW55IGRpYWxvZy9zdWJwYWdlIHBhcmFtcy4KCQkvLyBJbiBvdGhlcndvcmRzIHRoZSByZWFsIFVSTCBvZiB0aGUgcGFnZSB0byBiZSBsb2FkZWQuCgkJdmFyIGZpbGVVcmwgPSBwYXRoLmdldEZpbGVQYXRoKCBhYnNVcmwgKSwKCgkJCS8vIFRoZSB2ZXJzaW9uIG9mIHRoZSBVcmwgYWN0dWFsbHkgc3RvcmVkIGluIHRoZSBkYXRhLXVybCBhdHRyaWJ1dGUgb2YKCQkJLy8gdGhlIHBhZ2UuIEZvciBlbWJlZGRlZCBwYWdlcywgaXQgaXMganVzdCB0aGUgaWQgb2YgdGhlIHBhZ2UuIEZvciBwYWdlcwoJCQkvLyB3aXRoaW4gdGhlIHNhbWUgZG9tYWluIGFzIHRoZSBkb2N1bWVudCBiYXNlLCBpdCBpcyB0aGUgc2l0ZSByZWxhdGl2ZQoJCQkvLyBwYXRoLiBGb3IgY3Jvc3MtZG9tYWluIHBhZ2VzIChQaG9uZSBHYXAgb25seSkgdGhlIGVudGlyZSBhYnNvbHV0ZSBVcmwKCQkJLy8gdXNlZCB0byBsb2FkIHRoZSBwYWdlLgoJCQlkYXRhVXJsID0gcGF0aC5jb252ZXJ0VXJsVG9EYXRhVXJsKCBhYnNVcmwgKTsKCgkJLy8gTWFrZSBzdXJlIHdlIGhhdmUgYSBwYWdlQ29udGFpbmVyIHRvIHdvcmsgd2l0aC4KCQlzZXR0aW5ncy5wYWdlQ29udGFpbmVyID0gc2V0dGluZ3MucGFnZUNvbnRhaW5lciB8fCAkLm1vYmlsZS5wYWdlQ29udGFpbmVyOwoKCQkvLyBDaGVjayB0byBzZWUgaWYgdGhlIHBhZ2UgYWxyZWFkeSBleGlzdHMgaW4gdGhlIERPTS4KCQkvLyBOT1RFIGRvIF9ub3RfIHVzZSB0aGUgOmpxbURhdGEgcHN1ZWRvIHNlbGVjdG9yIGJlY2F1c2UgcGFyZW50aGVzaXMKCQkvLyAgICAgIGFyZSBhIHZhbGlkIHVybCBjaGFyIGFuZCBpdCBicmVha3Mgb24gdGhlIGZpcnN0IG9jY3VyZW5jZQoJCXBhZ2UgPSBzZXR0aW5ncy5wYWdlQ29udGFpbmVyLmNoaWxkcmVuKCAiW2RhdGEtIiArICQubW9iaWxlLm5zICsidXJsPSciICsgZGF0YVVybCArICInXSIgKTsKCgkJLy8gSWYgd2UgZmFpbGVkIHRvIGZpbmQgdGhlIHBhZ2UsIGNoZWNrIHRvIHNlZSBpZiB0aGUgdXJsIGlzIGEKCQkvLyByZWZlcmVuY2UgdG8gYW4gZW1iZWRkZWQgcGFnZS4gSWYgc28sIGl0IG1heSBoYXZlIGJlZW4gZHluYW1pY2FsbHkKCQkvLyBpbmplY3RlZCBieSBhIGRldmVsb3BlciwgaW4gd2hpY2ggY2FzZSBpdCB3b3VsZCBiZSBsYWNraW5nIGEgZGF0YS11cmwKCQkvLyBhdHRyaWJ1dGUgYW5kIGluIG5lZWQgb2YgZW5oYW5jZW1lbnQuCgkJaWYgKCBwYWdlLmxlbmd0aCA9PT0gMCAmJiBkYXRhVXJsICYmICFwYXRoLmlzUGF0aCggZGF0YVVybCApICkgewoJCQlwYWdlID0gc2V0dGluZ3MucGFnZUNvbnRhaW5lci5jaGlsZHJlbiggIiMiICsgZGF0YVVybCApCgkJCQkuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgInVybCIsIGRhdGFVcmwgKQoJCQkJLmpxbURhdGEoICJ1cmwiLCBkYXRhVXJsICk7CgkJfQoKCQkvLyBJZiB3ZSBmYWlsZWQgdG8gZmluZCBhIHBhZ2UgaW4gdGhlIERPTSwgY2hlY2sgdGhlIFVSTCB0byBzZWUgaWYgaXQKCQkvLyByZWZlcnMgdG8gdGhlIGZpcnN0IHBhZ2UgaW4gdGhlIGFwcGxpY2F0aW9uLiBJZiBpdCBpc24ndCBhIHJlZmVyZW5jZQoJCS8vIHRvIHRoZSBmaXJzdCBwYWdlIGFuZCByZWZlcnMgdG8gbm9uLWV4aXN0ZW50IGVtYmVkZGVkIHBhZ2UsIGVycm9yIG91dC4KCQlpZiAoIHBhZ2UubGVuZ3RoID09PSAwICkgewoJCQlpZiAoICQubW9iaWxlLmZpcnN0UGFnZSAmJiBwYXRoLmlzRmlyc3RQYWdlVXJsKCBmaWxlVXJsICkgKSB7CgkJCQkvLyBDaGVjayB0byBtYWtlIHN1cmUgb3VyIGNhY2hlZC1maXJzdC1wYWdlIGlzIGFjdHVhbGx5CgkJCQkvLyBpbiB0aGUgRE9NLiBTb21lIHVzZXIgZGVwbG95ZWQgYXBwcyBhcmUgcHJ1bmluZyB0aGUgZmlyc3QKCQkJCS8vIHBhZ2UgZnJvbSB0aGUgRE9NIGZvciB2YXJpb3VzIHJlYXNvbnMsIHdlIGNoZWNrIGZvciB0aGlzCgkJCQkvLyBjYXNlIGhlcmUgYmVjYXVzZSB3ZSBkb24ndCB3YW50IGEgZmlyc3QtcGFnZSB3aXRoIGFuIGlkCgkJCQkvLyBmYWxsaW5nIHRocm91Z2ggdG8gdGhlIG5vbi1leGlzdGVudCBlbWJlZGRlZCBwYWdlIGVycm9yCgkJCQkvLyBjYXNlLiBJZiB0aGUgZmlyc3QtcGFnZSBpcyBub3QgaW4gdGhlIERPTSwgdGhlbiB3ZSBsZXQKCQkJCS8vIHRoaW5ncyBmYWxsIHRocm91Z2ggdG8gdGhlIGFqYXggbG9hZGluZyBjb2RlIGJlbG93IHNvCgkJCQkvLyB0aGF0IGl0IGdldHMgcmVsb2FkZWQuCgkJCQlpZiAoICQubW9iaWxlLmZpcnN0UGFnZS5wYXJlbnQoKS5sZW5ndGggKSB7CgkJCQkJcGFnZSA9ICQoICQubW9iaWxlLmZpcnN0UGFnZSApOwoJCQkJfQoJCQl9IGVsc2UgaWYgKCBwYXRoLmlzRW1iZWRkZWRQYWdlKCBmaWxlVXJsICkgICkgewoJCQkJZGVmZXJyZWQucmVqZWN0KCBhYnNVcmwsIG9wdGlvbnMgKTsKCQkJCXJldHVybiBkZWZlcnJlZC5wcm9taXNlKCk7CgkJCX0KCQl9CgoJCS8vIElmIHRoZSBwYWdlIHdlIGFyZSBpbnRlcmVzdGVkIGluIGlzIGFscmVhZHkgaW4gdGhlIERPTSwKCQkvLyBhbmQgdGhlIGNhbGxlciBkaWQgbm90IGluZGljYXRlIHRoYXQgd2Ugc2hvdWxkIGZvcmNlIGEKCQkvLyByZWxvYWQgb2YgdGhlIGZpbGUsIHdlIGFyZSBkb25lLiBPdGhlcndpc2UsIHRyYWNrIHRoZQoJCS8vIGV4aXN0aW5nIHBhZ2UgYXMgYSBkdXBsaWNhdGVkLgoJCWlmICggcGFnZS5sZW5ndGggKSB7CgkJCWlmICggIXNldHRpbmdzLnJlbG9hZFBhZ2UgKSB7CgkJCQllbmhhbmNlUGFnZSggcGFnZSwgc2V0dGluZ3Mucm9sZSApOwoJCQkJZGVmZXJyZWQucmVzb2x2ZSggYWJzVXJsLCBvcHRpb25zLCBwYWdlICk7CgkJCQlyZXR1cm4gZGVmZXJyZWQucHJvbWlzZSgpOwoJCQl9CgkJCWR1cENhY2hlZFBhZ2UgPSBwYWdlOwoJCX0KCgkJdmFyIG1wYyA9IHNldHRpbmdzLnBhZ2VDb250YWluZXIsCgkJCXBibEV2ZW50ID0gbmV3ICQuRXZlbnQoICJwYWdlYmVmb3JlbG9hZCIgKSwKCQkJdHJpZ2dlckRhdGEgPSB7IHVybDogdXJsLCBhYnNVcmw6IGFic1VybCwgZGF0YVVybDogZGF0YVVybCwgZGVmZXJyZWQ6IGRlZmVycmVkLCBvcHRpb25zOiBzZXR0aW5ncyB9OwoKCQkvLyBMZXQgbGlzdGVuZXJzIGtub3cgd2UncmUgYWJvdXQgdG8gbG9hZCBhIHBhZ2UuCgkJbXBjLnRyaWdnZXIoIHBibEV2ZW50LCB0cmlnZ2VyRGF0YSApOwoKCQkvLyBJZiB0aGUgZGVmYXVsdCBiZWhhdmlvciBpcyBwcmV2ZW50ZWQsIHN0b3AgaGVyZSEKCQlpZiAoIHBibEV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoJCQlyZXR1cm4gZGVmZXJyZWQucHJvbWlzZSgpOwoJCX0KCgkJaWYgKCBzZXR0aW5ncy5zaG93TG9hZE1zZyApIHsKCgkJCS8vIFRoaXMgY29uZmlndXJhYmxlIHRpbWVvdXQgYWxsb3dzIGNhY2hlZCBwYWdlcyBhIGJyaWVmIGRlbGF5IHRvIGxvYWQgd2l0aG91dCBzaG93aW5nIGEgbWVzc2FnZQoJCQl2YXIgbG9hZE1zZ0RlbGF5ID0gc2V0VGltZW91dChmdW5jdGlvbigpIHsKCQkJCQkkLm1vYmlsZS5zaG93UGFnZUxvYWRpbmdNc2coKTsKCQkJCX0sIHNldHRpbmdzLmxvYWRNc2dEZWxheSApLAoKCQkJCS8vIFNoYXJlZCBsb2dpYyBmb3IgY2xlYXJpbmcgdGltZW91dCBhbmQgcmVtb3ZpbmcgbWVzc2FnZS4KCQkJCWhpZGVNc2cgPSBmdW5jdGlvbigpIHsKCgkJCQkJLy8gU3RvcCBtZXNzYWdlIHNob3cgdGltZXIKCQkJCQljbGVhclRpbWVvdXQoIGxvYWRNc2dEZWxheSApOwoKCQkJCQkvLyBIaWRlIGxvYWRpbmcgbWVzc2FnZQoJCQkJCSQubW9iaWxlLmhpZGVQYWdlTG9hZGluZ01zZygpOwoJCQkJfTsKCQl9CgoJCS8vIFJlc2V0IGJhc2UgdG8gdGhlIGRlZmF1bHQgZG9jdW1lbnQgYmFzZS4KCQlpZiAoIGJhc2UgKSB7CgkJCWJhc2UucmVzZXQoKTsKCQl9CgoJCWlmICggISggJC5tb2JpbGUuYWxsb3dDcm9zc0RvbWFpblBhZ2VzIHx8IHBhdGguaXNTYW1lRG9tYWluKCBkb2N1bWVudFVybCwgYWJzVXJsICkgKSApIHsKCQkJZGVmZXJyZWQucmVqZWN0KCBhYnNVcmwsIG9wdGlvbnMgKTsKCQl9IGVsc2UgewoJCQkvLyBMb2FkIHRoZSBuZXcgcGFnZS4KCQkJJC5hamF4KHsKCQkJCXVybDogZmlsZVVybCwKCQkJCXR5cGU6IHNldHRpbmdzLnR5cGUsCgkJCQlkYXRhOiBzZXR0aW5ncy5kYXRhLAoJCQkJZGF0YVR5cGU6ICJodG1sIiwKCQkJCXN1Y2Nlc3M6IGZ1bmN0aW9uKCBodG1sLCB0ZXh0U3RhdHVzLCB4aHIgKSB7CgkJCQkJLy9wcmUtcGFyc2UgaHRtbCB0byBjaGVjayBmb3IgYSBkYXRhLXVybCwKCQkJCQkvL3VzZSBpdCBhcyB0aGUgbmV3IGZpbGVVcmwsIGJhc2UgcGF0aCwgZXRjCgkJCQkJdmFyIGFsbCA9ICQoICI8ZGl2PjwvZGl2PiIgKSwKCgkJCQkJCS8vcGFnZSB0aXRsZSByZWdleHAKCQkJCQkJbmV3UGFnZVRpdGxlID0gaHRtbC5tYXRjaCggLzx0aXRsZVtePl0qPihbXjxdKikvICkgJiYgUmVnRXhwLiQxLAoKCQkJCQkJLy8gVE9ETyBoYW5kbGUgZGlhbG9ncyBhZ2FpbgoJCQkJCQlwYWdlRWxlbVJlZ2V4ID0gbmV3IFJlZ0V4cCggIig8W14+XStcXGJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyb2xlPVtcIiddP3BhZ2VbXCInXT9bXj5dKj4pIiApLAoJCQkJCQlkYXRhVXJsUmVnZXggPSBuZXcgUmVnRXhwKCAiXFxiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidXJsPVtcIiddPyhbXlwiJz5dKilbXCInXT8iICk7CgoKCQkJCQkvLyBkYXRhLXVybCBtdXN0IGJlIHByb3ZpZGVkIGZvciB0aGUgYmFzZSB0YWcgc28gcmVzb3VyY2UgcmVxdWVzdHMgY2FuIGJlIGRpcmVjdGVkIHRvIHRoZQoJCQkJCS8vIGNvcnJlY3QgdXJsLiBsb2FkaW5nIGludG8gYSB0ZW1wcm9yYXJ5IGVsZW1lbnQgbWFrZXMgdGhlc2UgcmVxdWVzdHMgaW1tZWRpYXRlbHkKCQkJCQlpZiAoIHBhZ2VFbGVtUmVnZXgudGVzdCggaHRtbCApICYmCgkJCQkJCQlSZWdFeHAuJDEgJiYKCQkJCQkJCWRhdGFVcmxSZWdleC50ZXN0KCBSZWdFeHAuJDEgKSAmJgoJCQkJCQkJUmVnRXhwLiQxICkgewoJCQkJCQl1cmwgPSBmaWxlVXJsID0gcGF0aC5nZXRGaWxlUGF0aCggJCggIjxkaXY+IiArIFJlZ0V4cC4kMSArICI8L2Rpdj4iICkudGV4dCgpICk7CgkJCQkJfQoKCQkJCQlpZiAoIGJhc2UgKSB7CgkJCQkJCWJhc2Uuc2V0KCBmaWxlVXJsICk7CgkJCQkJfQoKCQkJCQkvL3dvcmthcm91bmQgdG8gYWxsb3cgc2NyaXB0cyB0byBleGVjdXRlIHdoZW4gaW5jbHVkZWQgaW4gcGFnZSBkaXZzCgkJCQkJYWxsLmdldCggMCApLmlubmVySFRNTCA9IGh0bWw7CgkJCQkJcGFnZSA9IGFsbC5maW5kKCAiOmpxbURhdGEocm9sZT0ncGFnZScpLCA6anFtRGF0YShyb2xlPSdkaWFsb2cnKSIgKS5maXJzdCgpOwoKCQkJCQkvL2lmIHBhZ2UgZWxlbSBjb3VsZG4ndCBiZSBmb3VuZCwgY3JlYXRlIG9uZSBhbmQgaW5zZXJ0IHRoZSBib2R5IGVsZW1lbnQncyBjb250ZW50cwoJCQkJCWlmICggIXBhZ2UubGVuZ3RoICkgewoJCQkJCQlwYWdlID0gJCggIjxkaXYgZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicm9sZT0ncGFnZSc+IiArIGh0bWwuc3BsaXQoIC88XC8/Ym9keVtePl0qPi9nbWkgKVsxXSArICI8L2Rpdj4iICk7CgkJCQkJfQoKCQkJCQlpZiAoIG5ld1BhZ2VUaXRsZSAmJiAhcGFnZS5qcW1EYXRhKCAidGl0bGUiICkgKSB7CgkJCQkJCWlmICggfm5ld1BhZ2VUaXRsZS5pbmRleE9mKCAiJiIgKSApIHsKCQkJCQkJCW5ld1BhZ2VUaXRsZSA9ICQoICI8ZGl2PiIgKyBuZXdQYWdlVGl0bGUgKyAiPC9kaXY+IiApLnRleHQoKTsKCQkJCQkJfQoJCQkJCQlwYWdlLmpxbURhdGEoICJ0aXRsZSIsIG5ld1BhZ2VUaXRsZSApOwoJCQkJCX0KCgkJCQkJLy9yZXdyaXRlIHNyYyBhbmQgaHJlZiBhdHRycyB0byB1c2UgYSBiYXNlIHVybAoJCQkJCWlmICggISQuc3VwcG9ydC5keW5hbWljQmFzZVRhZyApIHsKCQkJCQkJdmFyIG5ld1BhdGggPSBwYXRoLmdldCggZmlsZVVybCApOwoJCQkJCQlwYWdlLmZpbmQoICJbc3JjXSwgbGlua1tocmVmXSwgYVtyZWw9J2V4dGVybmFsJ10sIDpqcW1EYXRhKGFqYXg9J2ZhbHNlJyksIGFbdGFyZ2V0XSIgKS5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJCQkJdmFyIHRoaXNBdHRyID0gJCggdGhpcyApLmlzKCAnW2hyZWZdJyApID8gJ2hyZWYnIDoKCQkJCQkJCQkJJCggdGhpcyApLmlzKCAnW3NyY10nICkgPyAnc3JjJyA6ICdhY3Rpb24nLAoJCQkJCQkJCXRoaXNVcmwgPSAkKCB0aGlzICkuYXR0ciggdGhpc0F0dHIgKTsKCgkJCQkJCQkvLyBYWFhfamJsYXM6IFdlIG5lZWQgdG8gZml4IHRoaXMgc28gdGhhdCBpdCByZW1vdmVzIHRoZSBkb2N1bWVudAoJCQkJCQkJLy8gICAgICAgICAgICBiYXNlIFVSTCwgYW5kIHRoZW4gcHJlcGVuZHMgd2l0aCB0aGUgbmV3IHBhZ2UgVVJMLgoJCQkJCQkJLy9pZiBmdWxsIHBhdGggZXhpc3RzIGFuZCBpcyBzYW1lLCBjaG9wIGl0IC0gaGVscHMgSUUgb3V0CgkJCQkJCQl0aGlzVXJsID0gdGhpc1VybC5yZXBsYWNlKCBsb2NhdGlvbi5wcm90b2NvbCArICcvLycgKyBsb2NhdGlvbi5ob3N0ICsgbG9jYXRpb24ucGF0aG5hbWUsICcnICk7CgoJCQkJCQkJaWYgKCAhL14oXHcrOnwjfFwvKS8udGVzdCggdGhpc1VybCApICkgewoJCQkJCQkJCSQoIHRoaXMgKS5hdHRyKCB0aGlzQXR0ciwgbmV3UGF0aCArIHRoaXNVcmwgKTsKCQkJCQkJCX0KCQkJCQkJfSk7CgkJCQkJfQoKCQkJCQkvL2FwcGVuZCB0byBwYWdlIGFuZCBlbmhhbmNlCgkJCQkJLy8gVE9ETyB0YWdpbmcgYSBwYWdlIHdpdGggZXh0ZXJuYWwgdG8gbWFrZSBzdXJlIHRoYXQgZW1iZWRkZWQgcGFnZXMgYXJlbid0IHJlbW92ZWQKCQkJCQkvLyAgICAgIGJ5IHRoZSB2YXJpb3VzIHBhZ2UgaGFuZGxpbmcgY29kZSBpcyBiYWQuIEhhdmluZyBwYWdlIGhhbmRsaW5nIGNvZGUgaW4gbWFueQoJCQkJCS8vICAgICAgcGxhY2VzIGlzIGJhZC4gU29sdXRpb25zIHBvc3QgMS4wCgkJCQkJcGFnZQoJCQkJCQkuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgInVybCIsIHBhdGguY29udmVydFVybFRvRGF0YVVybCggZmlsZVVybCApICkKCQkJCQkJLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJleHRlcm5hbC1wYWdlIiwgdHJ1ZSApCgkJCQkJCS5hcHBlbmRUbyggc2V0dGluZ3MucGFnZUNvbnRhaW5lciApOwoKCQkJCQkvLyB3YWl0IGZvciBwYWdlIGNyZWF0aW9uIHRvIGxldmVyYWdlIG9wdGlvbnMgZGVmaW5lZCBvbiB3aWRnZXQKCQkJCQlwYWdlLm9uZSggJ3BhZ2VjcmVhdGUnLCAkLm1vYmlsZS5fYmluZFBhZ2VSZW1vdmUgKTsKCgkJCQkJZW5oYW5jZVBhZ2UoIHBhZ2UsIHNldHRpbmdzLnJvbGUgKTsKCgkJCQkJLy8gRW5oYW5jaW5nIHRoZSBwYWdlIG1heSByZXN1bHQgaW4gbmV3IGRpYWxvZ3Mvc3ViIHBhZ2VzIGJlaW5nIGluc2VydGVkCgkJCQkJLy8gaW50byB0aGUgRE9NLiBJZiB0aGUgb3JpZ2luYWwgYWJzVXJsIHJlZmVycyB0byBhIHN1Yi1wYWdlLCB0aGF0IGlzIHRoZQoJCQkJCS8vIHJlYWwgcGFnZSB3ZSBhcmUgaW50ZXJlc3RlZCBpbi4KCQkJCQlpZiAoIGFic1VybC5pbmRleE9mKCAiJiIgKyAkLm1vYmlsZS5zdWJQYWdlVXJsS2V5ICkgPiAtMSApIHsKCQkJCQkJcGFnZSA9IHNldHRpbmdzLnBhZ2VDb250YWluZXIuY2hpbGRyZW4oICJbZGF0YS0iICsgJC5tb2JpbGUubnMgKyJ1cmw9JyIgKyBkYXRhVXJsICsgIiddIiApOwoJCQkJCX0KCgkJCQkJLy9iaW5kIHBhZ2VIaWRlIHRvIHJlbW92ZVBhZ2UgYWZ0ZXIgaXQncyBoaWRkZW4sIGlmIHRoZSBwYWdlIG9wdGlvbnMgc3BlY2lmeSB0byBkbyBzbwoKCQkJCQkvLyBSZW1vdmUgbG9hZGluZyBtZXNzYWdlLgoJCQkJCWlmICggc2V0dGluZ3Muc2hvd0xvYWRNc2cgKSB7CgkJCQkJCWhpZGVNc2coKTsKCQkJCQl9CgoJCQkJCS8vIEFkZCB0aGUgcGFnZSByZWZlcmVuY2UgYW5kIHhociB0byBvdXIgdHJpZ2dlckRhdGEuCgkJCQkJdHJpZ2dlckRhdGEueGhyID0geGhyOwoJCQkJCXRyaWdnZXJEYXRhLnRleHRTdGF0dXMgPSB0ZXh0U3RhdHVzOwoJCQkJCXRyaWdnZXJEYXRhLnBhZ2UgPSBwYWdlOwoKCQkJCQkvLyBMZXQgbGlzdGVuZXJzIGtub3cgdGhlIHBhZ2UgbG9hZGVkIHN1Y2Nlc3NmdWxseS4KCQkJCQlzZXR0aW5ncy5wYWdlQ29udGFpbmVyLnRyaWdnZXIoICJwYWdlbG9hZCIsIHRyaWdnZXJEYXRhICk7CgoJCQkJCWRlZmVycmVkLnJlc29sdmUoIGFic1VybCwgb3B0aW9ucywgcGFnZSwgZHVwQ2FjaGVkUGFnZSApOwoJCQkJfSwKCQkJCWVycm9yOiBmdW5jdGlvbiggeGhyLCB0ZXh0U3RhdHVzLCBlcnJvclRocm93biApIHsKCQkJCQkvL3NldCBiYXNlIGJhY2sgdG8gY3VycmVudCBwYXRoCgkJCQkJaWYgKCBiYXNlICkgewoJCQkJCQliYXNlLnNldCggcGF0aC5nZXQoKSApOwoJCQkJCX0KCgkJCQkJLy8gQWRkIGVycm9yIGluZm8gdG8gb3VyIHRyaWdnZXJEYXRhLgoJCQkJCXRyaWdnZXJEYXRhLnhociA9IHhocjsKCQkJCQl0cmlnZ2VyRGF0YS50ZXh0U3RhdHVzID0gdGV4dFN0YXR1czsKCQkJCQl0cmlnZ2VyRGF0YS5lcnJvclRocm93biA9IGVycm9yVGhyb3duOwoKCQkJCQl2YXIgcGxmRXZlbnQgPSBuZXcgJC5FdmVudCggInBhZ2Vsb2FkZmFpbGVkIiApOwoKCQkJCQkvLyBMZXQgbGlzdGVuZXJzIGtub3cgdGhlIHBhZ2UgbG9hZCBmYWlsZWQuCgkJCQkJc2V0dGluZ3MucGFnZUNvbnRhaW5lci50cmlnZ2VyKCBwbGZFdmVudCwgdHJpZ2dlckRhdGEgKTsKCgkJCQkJLy8gSWYgdGhlIGRlZmF1bHQgYmVoYXZpb3IgaXMgcHJldmVudGVkLCBzdG9wIGhlcmUhCgkJCQkJLy8gTm90ZSB0aGF0IGl0IGlzIHRoZSByZXNwb25zaWJpbGl0eSBvZiB0aGUgbGlzdGVuZXIvaGFuZGxlcgoJCQkJCS8vIHRoYXQgY2FsbGVkIHByZXZlbnREZWZhdWx0KCksIHRvIHJlc29sdmUvcmVqZWN0IHRoZQoJCQkJCS8vIGRlZmVycmVkIG9iamVjdCB3aXRoaW4gdGhlIHRyaWdnZXJEYXRhLgoJCQkJCWlmICggcGxmRXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKSB7CgkJCQkJCXJldHVybjsKCQkJCQl9CgoJCQkJCS8vIFJlbW92ZSBsb2FkaW5nIG1lc3NhZ2UuCgkJCQkJaWYgKCBzZXR0aW5ncy5zaG93TG9hZE1zZyApIHsKCgkJCQkJCS8vIFJlbW92ZSBsb2FkaW5nIG1lc3NhZ2UuCgkJCQkJCWhpZGVNc2coKTsKCgkJCQkJCS8vIHNob3cgZXJyb3IgbWVzc2FnZQoJCQkJCQkkLm1vYmlsZS5zaG93UGFnZUxvYWRpbmdNc2coICQubW9iaWxlLnBhZ2VMb2FkRXJyb3JNZXNzYWdlVGhlbWUsICQubW9iaWxlLnBhZ2VMb2FkRXJyb3JNZXNzYWdlLCB0cnVlICk7CgoJCQkJCQkvLyBoaWRlIGFmdGVyIGRlbGF5CgkJCQkJCXNldFRpbWVvdXQoICQubW9iaWxlLmhpZGVQYWdlTG9hZGluZ01zZywgMTUwMCApOwoJCQkJCX0KCgkJCQkJZGVmZXJyZWQucmVqZWN0KCBhYnNVcmwsIG9wdGlvbnMgKTsKCQkJCX0KCQkJfSk7CgkJfQoKCQlyZXR1cm4gZGVmZXJyZWQucHJvbWlzZSgpOwoJfTsKCgkkLm1vYmlsZS5sb2FkUGFnZS5kZWZhdWx0cyA9IHsKCQl0eXBlOiAiZ2V0IiwKCQlkYXRhOiB1bmRlZmluZWQsCgkJcmVsb2FkUGFnZTogZmFsc2UsCgkJcm9sZTogdW5kZWZpbmVkLCAvLyBCeSBkZWZhdWx0IHdlIHJlbHkgb24gdGhlIHJvbGUgZGVmaW5lZCBieSB0aGUgQGRhdGEtcm9sZSBhdHRyaWJ1dGUuCgkJc2hvd0xvYWRNc2c6IGZhbHNlLAoJCXBhZ2VDb250YWluZXI6IHVuZGVmaW5lZCwKCQlsb2FkTXNnRGVsYXk6IDUwIC8vIFRoaXMgZGVsYXkgYWxsb3dzIGxvYWRzIHRoYXQgcHVsbCBmcm9tIGJyb3dzZXIgY2FjaGUgdG8gb2NjdXIgd2l0aG91dCBzaG93aW5nIHRoZSBsb2FkaW5nIG1lc3NhZ2UuCgl9OwoKCS8vIFNob3cgYSBzcGVjaWZpYyBwYWdlIGluIHRoZSBwYWdlIGNvbnRhaW5lci4KCSQubW9iaWxlLmNoYW5nZVBhZ2UgPSBmdW5jdGlvbiggdG9QYWdlLCBvcHRpb25zICkgewoJCS8vIElmIHdlIGFyZSBpbiB0aGUgbWlkc3Qgb2YgYSB0cmFuc2l0aW9uLCBxdWV1ZSB0aGUgY3VycmVudCByZXF1ZXN0LgoJCS8vIFdlJ2xsIGNhbGwgY2hhbmdlUGFnZSgpIG9uY2Ugd2UncmUgZG9uZSB3aXRoIHRoZSBjdXJyZW50IHRyYW5zaXRpb24gdG8KCQkvLyBzZXJ2aWNlIHRoZSByZXF1ZXN0LgoJCWlmICggaXNQYWdlVHJhbnNpdGlvbmluZyApIHsKCQkJcGFnZVRyYW5zaXRpb25RdWV1ZS51bnNoaWZ0KCBhcmd1bWVudHMgKTsKCQkJcmV0dXJuOwoJCX0KCgkJdmFyIHNldHRpbmdzID0gJC5leHRlbmQoIHt9LCAkLm1vYmlsZS5jaGFuZ2VQYWdlLmRlZmF1bHRzLCBvcHRpb25zICk7CgoJCS8vIE1ha2Ugc3VyZSB3ZSBoYXZlIGEgcGFnZUNvbnRhaW5lciB0byB3b3JrIHdpdGguCgkJc2V0dGluZ3MucGFnZUNvbnRhaW5lciA9IHNldHRpbmdzLnBhZ2VDb250YWluZXIgfHwgJC5tb2JpbGUucGFnZUNvbnRhaW5lcjsKCgkJLy8gTWFrZSBzdXJlIHdlIGhhdmUgYSBmcm9tUGFnZS4KCQlzZXR0aW5ncy5mcm9tUGFnZSA9IHNldHRpbmdzLmZyb21QYWdlIHx8ICQubW9iaWxlLmFjdGl2ZVBhZ2U7CgoJCXZhciBtcGMgPSBzZXR0aW5ncy5wYWdlQ29udGFpbmVyLAoJCQlwYmNFdmVudCA9IG5ldyAkLkV2ZW50KCAicGFnZWJlZm9yZWNoYW5nZSIgKSwKCQkJdHJpZ2dlckRhdGEgPSB7IHRvUGFnZTogdG9QYWdlLCBvcHRpb25zOiBzZXR0aW5ncyB9OwoKCQkvLyBMZXQgbGlzdGVuZXJzIGtub3cgd2UncmUgYWJvdXQgdG8gY2hhbmdlIHRoZSBjdXJyZW50IHBhZ2UuCgkJbXBjLnRyaWdnZXIoIHBiY0V2ZW50LCB0cmlnZ2VyRGF0YSApOwoKCQkvLyBJZiB0aGUgZGVmYXVsdCBiZWhhdmlvciBpcyBwcmV2ZW50ZWQsIHN0b3AgaGVyZSEKCQlpZiAoIHBiY0V2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoJCQlyZXR1cm47CgkJfQoKCQkvLyBXZSBhbGxvdyAicGFnZWJlZm9yZWNoYW5nZSIgb2JzZXJ2ZXJzIHRvIG1vZGlmeSB0aGUgdG9QYWdlIGluIHRoZSB0cmlnZ2VyCgkJLy8gZGF0YSB0byBhbGxvdyBmb3IgcmVkaXJlY3RzLiBNYWtlIHN1cmUgb3VyIHRvUGFnZSBpcyB1cGRhdGVkLgoKCQl0b1BhZ2UgPSB0cmlnZ2VyRGF0YS50b1BhZ2U7CgoJCS8vIFNldCB0aGUgaXNQYWdlVHJhbnNpdGlvbmluZyBmbGFnIHRvIHByZXZlbnQgYW55IHJlcXVlc3RzIGZyb20KCQkvLyBlbnRlcmluZyB0aGlzIG1ldGhvZCB3aGlsZSB3ZSBhcmUgaW4gdGhlIG1pZHN0IG9mIGxvYWRpbmcgYSBwYWdlCgkJLy8gb3IgdHJhbnNpdGlvbmluZy4KCgkJaXNQYWdlVHJhbnNpdGlvbmluZyA9IHRydWU7CgoJCS8vIElmIHRoZSBjYWxsZXIgcGFzc2VkIHVzIGEgdXJsLCBjYWxsIGxvYWRQYWdlKCkKCQkvLyB0byBtYWtlIHN1cmUgaXQgaXMgbG9hZGVkIGludG8gdGhlIERPTS4gV2UnbGwgbGlzdGVuCgkJLy8gdG8gdGhlIHByb21pc2Ugb2JqZWN0IGl0IHJldHVybnMgc28gd2Uga25vdyB3aGVuCgkJLy8gaXQgaXMgZG9uZSBsb2FkaW5nIG9yIGlmIGFuIGVycm9yIG9jdXJyZWQuCgkJaWYgKCB0eXBlb2YgdG9QYWdlID09PSAic3RyaW5nIiApIHsKCQkJJC5tb2JpbGUubG9hZFBhZ2UoIHRvUGFnZSwgc2V0dGluZ3MgKQoJCQkJLmRvbmUoZnVuY3Rpb24oIHVybCwgb3B0aW9ucywgbmV3UGFnZSwgZHVwQ2FjaGVkUGFnZSApIHsKCQkJCQlpc1BhZ2VUcmFuc2l0aW9uaW5nID0gZmFsc2U7CgkJCQkJb3B0aW9ucy5kdXBsaWNhdGVDYWNoZWRQYWdlID0gZHVwQ2FjaGVkUGFnZTsKCQkJCQkkLm1vYmlsZS5jaGFuZ2VQYWdlKCBuZXdQYWdlLCBvcHRpb25zICk7CgkJCQl9KQoJCQkJLmZhaWwoZnVuY3Rpb24oIHVybCwgb3B0aW9ucyApIHsKCQkJCQlpc1BhZ2VUcmFuc2l0aW9uaW5nID0gZmFsc2U7CgoJCQkJCS8vY2xlYXIgb3V0IHRoZSBhY3RpdmUgYnV0dG9uIHN0YXRlCgkJCQkJcmVtb3ZlQWN0aXZlTGlua0NsYXNzKCB0cnVlICk7CgoJCQkJCS8vcmVsZWFzZSB0cmFuc2l0aW9uIGxvY2sgc28gbmF2aWdhdGlvbiBpcyBmcmVlIGFnYWluCgkJCQkJcmVsZWFzZVBhZ2VUcmFuc2l0aW9uTG9jaygpOwoJCQkJCXNldHRpbmdzLnBhZ2VDb250YWluZXIudHJpZ2dlciggInBhZ2VjaGFuZ2VmYWlsZWQiLCB0cmlnZ2VyRGF0YSApOwoJCQkJfSk7CgkJCXJldHVybjsKCQl9CgoJCS8vIElmIHdlIGFyZSBnb2luZyB0byB0aGUgZmlyc3QtcGFnZSBvZiB0aGUgYXBwbGljYXRpb24sIHdlIG5lZWQgdG8gbWFrZQoJCS8vIHN1cmUgc2V0dGluZ3MuZGF0YVVybCBpcyBzZXQgdG8gdGhlIGFwcGxpY2F0aW9uIGRvY3VtZW50IHVybC4gVGhpcyBhbGxvd3MKCQkvLyB1cyB0byBhdm9pZCBnZW5lcmF0aW5nIGEgZG9jdW1lbnQgdXJsIHdpdGggYW4gaWQgaGFzaCBpbiB0aGUgY2FzZSB3aGVyZSB0aGUKCQkvLyBmaXJzdC1wYWdlIG9mIHRoZSBkb2N1bWVudCBoYXMgYW4gaWQgYXR0cmlidXRlIHNwZWNpZmllZC4KCQlpZiAoIHRvUGFnZVsgMCBdID09PSAkLm1vYmlsZS5maXJzdFBhZ2VbIDAgXSAmJiAhc2V0dGluZ3MuZGF0YVVybCApIHsKCQkJc2V0dGluZ3MuZGF0YVVybCA9IGRvY3VtZW50VXJsLmhyZWZOb0hhc2g7CgkJfQoKCQkvLyBUaGUgY2FsbGVyIHBhc3NlZCB1cyBhIHJlYWwgcGFnZSBET00gZWxlbWVudC4gVXBkYXRlIG91cgoJCS8vIGludGVybmFsIHN0YXRlIGFuZCB0aGVuIHRyaWdnZXIgYSB0cmFuc2l0aW9uIHRvIHRoZSBwYWdlLgoJCXZhciBmcm9tUGFnZSA9IHNldHRpbmdzLmZyb21QYWdlLAoJCQl1cmwgPSAoIHNldHRpbmdzLmRhdGFVcmwgJiYgcGF0aC5jb252ZXJ0VXJsVG9EYXRhVXJsKCBzZXR0aW5ncy5kYXRhVXJsICkgKSB8fCB0b1BhZ2UuanFtRGF0YSggInVybCIgKSwKCQkJLy8gVGhlIHBhZ2VVcmwgdmFyIGlzIHVzdWFsbHkgdGhlIHNhbWUgYXMgdXJsLCBleGNlcHQgd2hlbiB1cmwgaXMgb2JzY3VyZWQgYXMgYSBkaWFsb2cgdXJsLiBwYWdlVXJsIGFsd2F5cyBjb250YWlucyB0aGUgZmlsZSBwYXRoCgkJCXBhZ2VVcmwgPSB1cmwsCgkJCWZpbGVVcmwgPSBwYXRoLmdldEZpbGVQYXRoKCB1cmwgKSwKCQkJYWN0aXZlID0gdXJsSGlzdG9yeS5nZXRBY3RpdmUoKSwKCQkJYWN0aXZlSXNJbml0aWFsUGFnZSA9IHVybEhpc3RvcnkuYWN0aXZlSW5kZXggPT09IDAsCgkJCWhpc3RvcnlEaXIgPSAwLAoJCQlwYWdlVGl0bGUgPSBkb2N1bWVudC50aXRsZSwKCQkJaXNEaWFsb2cgPSBzZXR0aW5ncy5yb2xlID09PSAiZGlhbG9nIiB8fCB0b1BhZ2UuanFtRGF0YSggInJvbGUiICkgPT09ICJkaWFsb2ciOwoKCQkvLyBCeSBkZWZhdWx0LCB3ZSBwcmV2ZW50IGNoYW5nZVBhZ2UgcmVxdWVzdHMgd2hlbiB0aGUgZnJvbVBhZ2UgYW5kIHRvUGFnZQoJCS8vIGFyZSB0aGUgc2FtZSBlbGVtZW50LCBidXQgZm9sa3MgdGhhdCBnZW5lcmF0ZSBjb250ZW50IG1hbnVhbGx5L2R5bmFtaWNhbGx5CgkJLy8gYW5kIHJldXNlIHBhZ2VzIHdhbnQgdG8gYmUgYWJsZSB0byB0cmFuc2l0aW9uIHRvIHRoZSBzYW1lIHBhZ2UuIFRvIGFsbG93CgkJLy8gdGhpcywgdGhleSB3aWxsIG5lZWQgdG8gY2hhbmdlIHRoZSBkZWZhdWx0IHZhbHVlIG9mIGFsbG93U2FtZVBhZ2VUcmFuc2l0aW9uCgkJLy8gdG8gdHJ1ZSwgKk9SKiwgcGFzcyBpdCBpbiBhcyBhbiBvcHRpb24gd2hlbiB0aGV5IG1hbnVhbGx5IGNhbGwgY2hhbmdlUGFnZSgpLgoJCS8vIEl0IHNob3VsZCBiZSBub3RlZCB0aGF0IG91ciBkZWZhdWx0IHRyYW5zaXRpb24gYW5pbWF0aW9ucyBhc3N1bWUgdGhhdCB0aGUKCQkvLyBmb3JtUGFnZSBhbmQgdG9QYWdlIGFyZSBkaWZmZXJlbnQgZWxlbWVudHMsIHNvIHRoZXkgbWF5IGJlaGF2ZSB1bmV4cGVjdGVkbHkuCgkJLy8gSXQgaXMgdXAgdG8gdGhlIGRldmVsb3BlciB0aGF0IHR1cm5zIG9uIHRoZSBhbGxvd1NhbWVQYWdlVHJhbnNpdGlvbmEgb3B0aW9uCgkJLy8gdG8gZWl0aGVyIHR1cm4gb2ZmIHRyYW5zaXRpb24gYW5pbWF0aW9ucywgb3IgbWFrZSBzdXJlIHRoYXQgYW4gYXBwcm9wcmlhdGUKCQkvLyBhbmltYXRpb24gdHJhbnNpdGlvbiBpcyB1c2VkLgoJCWlmICggZnJvbVBhZ2UgJiYgZnJvbVBhZ2VbMF0gPT09IHRvUGFnZVswXSAmJiAhc2V0dGluZ3MuYWxsb3dTYW1lUGFnZVRyYW5zaXRpb24gKSB7CgkJCWlzUGFnZVRyYW5zaXRpb25pbmcgPSBmYWxzZTsKCQkJbXBjLnRyaWdnZXIoICJwYWdlY2hhbmdlIiwgdHJpZ2dlckRhdGEgKTsKCgkJCS8vIEV2ZW4gaWYgdGhlcmUgaXMgbm8gcGFnZSBjaGFuZ2UgdG8gYmUgZG9uZSwgd2Ugc2hvdWxkIGtlZXAgdGhlIHVybEhpc3RvcnkgaW4gc3luYyB3aXRoIHRoZSBoYXNoIGNoYW5nZXMKCQkJaWYgKCBzZXR0aW5ncy5mcm9tSGFzaENoYW5nZSApIHsKCQkJCXVybEhpc3RvcnkuZGlyZWN0SGFzaENoYW5nZSh7CgkJCQkJY3VycmVudFVybDoJdXJsLAoJCQkJCWlzQmFjazoJCWZ1bmN0aW9uKCkge30sCgkJCQkJaXNGb3J3YXJkOglmdW5jdGlvbigpIHt9CgkJCQl9KTsKCQkJfQoKCQkJcmV0dXJuOwoJCX0KCgkJLy8gV2UgbmVlZCB0byBtYWtlIHN1cmUgdGhlIHBhZ2Ugd2UgYXJlIGdpdmVuIGhhcyBhbHJlYWR5IGJlZW4gZW5oYW5jZWQuCgkJZW5oYW5jZVBhZ2UoIHRvUGFnZSwgc2V0dGluZ3Mucm9sZSApOwoKCQkvLyBJZiB0aGUgY2hhbmdlUGFnZSByZXF1ZXN0IHdhcyBzZW50IGZyb20gYSBoYXNoQ2hhbmdlIGV2ZW50LCBjaGVjayB0byBzZWUgaWYgdGhlCgkJLy8gcGFnZSBpcyBhbHJlYWR5IHdpdGhpbiB0aGUgdXJsSGlzdG9yeSBzdGFjay4gSWYgc28sIHdlJ2xsIGFzc3VtZSB0aGUgdXNlciBoaXQKCQkvLyB0aGUgZm9yd2FyZC9iYWNrIGJ1dHRvbiBhbmQgd2lsbCB0cnkgdG8gbWF0Y2ggdGhlIHRyYW5zaXRpb24gYWNjb3JkaW5nbHkuCgkJaWYgKCBzZXR0aW5ncy5mcm9tSGFzaENoYW5nZSApIHsKCQkJdXJsSGlzdG9yeS5kaXJlY3RIYXNoQ2hhbmdlKHsKCQkJCWN1cnJlbnRVcmw6CXVybCwKCQkJCWlzQmFjazoJCWZ1bmN0aW9uKCkgeyBoaXN0b3J5RGlyID0gLTE7IH0sCgkJCQlpc0ZvcndhcmQ6CWZ1bmN0aW9uKCkgeyBoaXN0b3J5RGlyID0gMTsgfQoJCQl9KTsKCQl9CgoJCS8vIEtpbGwgdGhlIGtleWJvYXJkLgoJCS8vIFhYWF9qYmxhczogV2UgbmVlZCB0byBzdG9wIGNyYXdsaW5nIHRoZSBlbnRpcmUgZG9jdW1lbnQgdG8ga2lsbCBmb2N1cy4gSW5zdGVhZCwKCQkvLyAgICAgICAgICAgIHdlIHNob3VsZCBiZSB0cmFja2luZyBmb2N1cyB3aXRoIGEgZGVsZWdhdGUoKSBoYW5kbGVyIHNvIHdlIGFscmVhZHkgaGF2ZQoJCS8vICAgICAgICAgICAgdGhlIGVsZW1lbnQgaW4gaGFuZCBhdCB0aGlzIHBvaW50LgoJCS8vIFdyYXAgdGhpcyBpbiBhIHRyeS9jYXRjaCBibG9jayBzaW5jZSBJRTkgdGhyb3cgIlVuc3BlY2lmaWVkIGVycm9yIiBpZiBkb2N1bWVudC5hY3RpdmVFbGVtZW50CgkJLy8gaXMgdW5kZWZpbmVkIHdoZW4gd2UgYXJlIGluIGFuIElGcmFtZS4KCQl0cnkgewoJCQlpZiAoIGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQgJiYgZG9jdW1lbnQuYWN0aXZlRWxlbWVudC5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpICE9PSAnYm9keScgKSB7CgkJCQkkKCBkb2N1bWVudC5hY3RpdmVFbGVtZW50ICkuYmx1cigpOwoJCQl9IGVsc2UgewoJCQkJJCggImlucHV0OmZvY3VzLCB0ZXh0YXJlYTpmb2N1cywgc2VsZWN0OmZvY3VzIiApLmJsdXIoKTsKCQkJfQoJCX0gY2F0Y2goIGUgKSB7fQoKCQkvLyBSZWNvcmQgd2hldGhlciB3ZSBhcmUgYXQgYSBwbGFjZSBpbiBoaXN0b3J5IHdoZXJlIGEgZGlhbG9nIHVzZWQgdG8gYmUgLSBpZiBzbywgZG8gbm90IGFkZCBhIG5ldyBoaXN0b3J5IGVudHJ5IGFuZCBkbyBub3QgY2hhbmdlIHRoZSBoYXNoIGVpdGhlcgoJCXZhciBhbHJlYWR5VGhlcmUgPSBmYWxzZTsKCgkJLy8gSWYgd2UncmUgZGlzcGxheWluZyB0aGUgcGFnZSBhcyBhIGRpYWxvZywgd2UgZG9uJ3Qgd2FudCB0aGUgdXJsCgkJLy8gZm9yIHRoZSBkaWFsb2cgY29udGVudCB0byBiZSB1c2VkIGluIHRoZSBoYXNoLiBJbnN0ZWFkLCB3ZSB3YW50CgkJLy8gdG8gYXBwZW5kIHRoZSBkaWFsb2dIYXNoS2V5IHRvIHRoZSB1cmwgb2YgdGhlIGN1cnJlbnQgcGFnZS4KCQlpZiAoIGlzRGlhbG9nICYmIGFjdGl2ZSApIHsKCQkJLy8gb24gdGhlIGluaXRpYWwgcGFnZSBsb2FkIGFjdGl2ZS51cmwgaXMgdW5kZWZpbmVkIGFuZCBpbiB0aGF0IGNhc2Ugc2hvdWxkCgkJCS8vIGJlIGFuIGVtcHR5IHN0cmluZy4gTW92aW5nIHRoZSB1bmRlZmluZWQgLT4gZW1wdHkgc3RyaW5nIGJhY2sgaW50bwoJCQkvLyB1cmxIaXN0b3J5LmFkZE5ldyBzZWVtZWQgaW1wcnVkZW50IGdpdmVuIHVuZGVmaW5lZCBiZXR0ZXIgcmVwcmVzZW50cwoJCQkvLyB0aGUgdXJsIHN0YXRlCgoJCQkvLyBJZiB3ZSBhcmUgYXQgYSBwbGFjZSBpbiBoaXN0b3J5IHRoYXQgb25jZSBiZWxvbmdlZCB0byBhIGRpYWxvZywgcmV1c2UKCQkJLy8gdGhpcyBzdGF0ZSB3aXRob3V0IGFkZGluZyB0byB1cmxIaXN0b3J5IGFuZCB3aXRob3V0IG1vZGlmeWluZyB0aGUgaGFzaC4KCQkJLy8gSG93ZXZlciwgaWYgYSBkaWFsb2cgaXMgYWxyZWFkeSBkaXNwbGF5ZWQgYXQgdGhpcyBwb2ludCwgYW5kIHdlJ3JlCgkJCS8vIGFib3V0IHRvIGRpc3BsYXkgYW5vdGhlciBkaWFsb2csIHRoZW4gd2UgbXVzdCBhZGQgYW5vdGhlciBoYXNoIGFuZAoJCQkvLyBoaXN0b3J5IGVudHJ5IG9uIHRvcCBzbyB0aGF0IG9uZSBtYXkgbmF2aWdhdGUgYmFjayB0byB0aGUgb3JpZ2luYWwgZGlhbG9nCgkJCWlmICggYWN0aXZlLnVybC5pbmRleE9mKCBkaWFsb2dIYXNoS2V5ICkgPiAtMSAmJiAhJC5tb2JpbGUuYWN0aXZlUGFnZS5pcyggIi51aS1kaWFsb2ciICkgKSB7CgkJCQlzZXR0aW5ncy5jaGFuZ2VIYXNoID0gZmFsc2U7CgkJCQlhbHJlYWR5VGhlcmUgPSB0cnVlOwoJCQl9CgoJCQkvLyBOb3JtYWxseSwgd2UgdGFjayBvbiBhIGRpYWxvZyBoYXNoIGtleSwgYnV0IGlmIHRoaXMgaXMgdGhlIGxvY2F0aW9uIG9mIGEgc3RhbGUgZGlhbG9nLAoJCQkvLyB3ZSByZXVzZSB0aGUgVVJMIGZyb20gdGhlIGVudHJ5CgkJCXVybCA9ICggYWN0aXZlLnVybCB8fCAiIiApICsgKCBhbHJlYWR5VGhlcmUgPyAiIiA6IGRpYWxvZ0hhc2hLZXkgKTsKCgkJCS8vIHRhY2sgb24gYW5vdGhlciBkaWFsb2dIYXNoS2V5IGlmIHRoaXMgaXMgdGhlIHNhbWUgYXMgdGhlIGluaXRpYWwgaGFzaAoJCQkvLyB0aGlzIG1ha2VzIHN1cmUgdGhhdCBhIGhpc3RvcnkgZW50cnkgaXMgY3JlYXRlZCBmb3IgdGhpcyBkaWFsb2cKCQkJaWYgKCB1cmxIaXN0b3J5LmFjdGl2ZUluZGV4ID09PSAwICYmIHVybCA9PT0gdXJsSGlzdG9yeS5pbml0aWFsRHN0ICkgewoJCQkJdXJsICs9IGRpYWxvZ0hhc2hLZXk7CgkJCX0KCQl9CgoJCS8vIFNldCB0aGUgbG9jYXRpb24gaGFzaC4KCQlpZiAoIHNldHRpbmdzLmNoYW5nZUhhc2ggIT09IGZhbHNlICYmIHVybCApIHsKCQkJLy9kaXNhYmxlIGhhc2ggbGlzdGVuaW5nIHRlbXBvcmFyaWx5CgkJCXVybEhpc3RvcnkuaWdub3JlTmV4dEhhc2hDaGFuZ2UgPSB0cnVlOwoJCQkvL3VwZGF0ZSBoYXNoIGFuZCBoaXN0b3J5CgkJCXBhdGguc2V0KCB1cmwgKTsKCQl9CgoJCS8vIGlmIHRpdGxlIGVsZW1lbnQgd2Fzbid0IGZvdW5kLCB0cnkgdGhlIHBhZ2UgZGl2IGRhdGEgYXR0ciB0b28KCQkvLyBJZiB0aGlzIGlzIGEgZGVlcC1saW5rIG9yIGEgcmVsb2FkICggYWN0aXZlID09PSB1bmRlZmluZWQgKSB0aGVuIGp1c3QgdXNlIHBhZ2VUaXRsZQoJCXZhciBuZXdQYWdlVGl0bGUgPSAoICFhY3RpdmUgKT8gcGFnZVRpdGxlIDogdG9QYWdlLmpxbURhdGEoICJ0aXRsZSIgKSB8fCB0b1BhZ2UuY2hpbGRyZW4oICI6anFtRGF0YShyb2xlPSdoZWFkZXInKSIgKS5maW5kKCAiLnVpLXRpdGxlIiApLmdldEVuY29kZWRUZXh0KCk7CgkJaWYgKCAhIW5ld1BhZ2VUaXRsZSAmJiBwYWdlVGl0bGUgPT09IGRvY3VtZW50LnRpdGxlICkgewoJCQlwYWdlVGl0bGUgPSBuZXdQYWdlVGl0bGU7CgkJfQoJCWlmICggIXRvUGFnZS5qcW1EYXRhKCAidGl0bGUiICkgKSB7CgkJCXRvUGFnZS5qcW1EYXRhKCAidGl0bGUiLCBwYWdlVGl0bGUgKTsKCQl9CgoJCS8vIE1ha2Ugc3VyZSB3ZSBoYXZlIGEgdHJhbnNpdGlvbiBkZWZpbmVkLgoJCXNldHRpbmdzLnRyYW5zaXRpb24gPSBzZXR0aW5ncy50cmFuc2l0aW9uIHx8CgkJCSggKCBoaXN0b3J5RGlyICYmICFhY3RpdmVJc0luaXRpYWxQYWdlICkgPyBhY3RpdmUudHJhbnNpdGlvbiA6IHVuZGVmaW5lZCApIHx8CgkJCSggaXNEaWFsb2cgPyAkLm1vYmlsZS5kZWZhdWx0RGlhbG9nVHJhbnNpdGlvbiA6ICQubW9iaWxlLmRlZmF1bHRQYWdlVHJhbnNpdGlvbiApOwoKCQkvL2FkZCBwYWdlIHRvIGhpc3Rvcnkgc3RhY2sgaWYgaXQncyBub3QgYmFjayBvciBmb3J3YXJkCgkJaWYgKCAhaGlzdG9yeURpciApIHsKCQkJLy8gT3ZlcndyaXRlIHRoZSBjdXJyZW50IGVudHJ5IGlmIGl0J3MgYSBsZWZ0b3ZlciBmcm9tIGEgZGlhbG9nCgkJCWlmICggYWxyZWFkeVRoZXJlICkgewoJCQkJdXJsSGlzdG9yeS5hY3RpdmVJbmRleCA9IE1hdGgubWF4KCAwLCB1cmxIaXN0b3J5LmFjdGl2ZUluZGV4IC0gMSApOwoJCQl9CgkJCXVybEhpc3RvcnkuYWRkTmV3KCB1cmwsIHNldHRpbmdzLnRyYW5zaXRpb24sIHBhZ2VUaXRsZSwgcGFnZVVybCwgc2V0dGluZ3Mucm9sZSApOwoJCX0KCgkJLy9zZXQgcGFnZSB0aXRsZQoJCWRvY3VtZW50LnRpdGxlID0gdXJsSGlzdG9yeS5nZXRBY3RpdmUoKS50aXRsZTsKCgkJLy9zZXQgInRvUGFnZSIgYXMgYWN0aXZlUGFnZQoJCSQubW9iaWxlLmFjdGl2ZVBhZ2UgPSB0b1BhZ2U7CgoJCS8vIElmIHdlJ3JlIG5hdmlnYXRpbmcgYmFjayBpbiB0aGUgVVJMIGhpc3RvcnksIHNldCByZXZlcnNlIGFjY29yZGluZ2x5LgoJCXNldHRpbmdzLnJldmVyc2UgPSBzZXR0aW5ncy5yZXZlcnNlIHx8IGhpc3RvcnlEaXIgPCAwOwoKCQl0cmFuc2l0aW9uUGFnZXMoIHRvUGFnZSwgZnJvbVBhZ2UsIHNldHRpbmdzLnRyYW5zaXRpb24sIHNldHRpbmdzLnJldmVyc2UgKQoJCQkuZG9uZShmdW5jdGlvbiggbmFtZSwgcmV2ZXJzZSwgJHRvLCAkZnJvbSwgYWxyZWFkeUZvY3VzZWQgKSB7CgkJCQlyZW1vdmVBY3RpdmVMaW5rQ2xhc3MoKTsKCgkJCQkvL2lmIHRoZXJlJ3MgYSBkdXBsaWNhdGVDYWNoZWRQYWdlLCByZW1vdmUgaXQgZnJvbSB0aGUgRE9NIG5vdyB0aGF0IGl0J3MgaGlkZGVuCgkJCQlpZiAoIHNldHRpbmdzLmR1cGxpY2F0ZUNhY2hlZFBhZ2UgKSB7CgkJCQkJc2V0dGluZ3MuZHVwbGljYXRlQ2FjaGVkUGFnZS5yZW1vdmUoKTsKCQkJCX0KCgkJCQkvLyBTZW5kIGZvY3VzIHRvIHRoZSBuZXdseSBzaG93biBwYWdlLiBNb3ZlZCBmcm9tIHByb21pc2UgLmRvbmUgYmluZGluZyBpbiB0cmFuc2l0aW9uUGFnZXMKCQkJCS8vIGl0c2VsZiB0byBhdm9pZCBpZSBidWcgdGhhdCByZXBvcnRzIG9mZnNldFdpZHRoIGFzID4gMCAoY29yZSBjaGVjayBmb3IgdmlzaWJpbGl0eSkKCQkJCS8vIGRlc3BpdGUgdmlzaWJpbGl0eTogaGlkZGVuIGFkZHJlc3NlcyBpc3N1ZSAjMjk2NQoJCQkJLy8gaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnktbW9iaWxlL2lzc3Vlcy8yOTY1CgkJCQlpZiAoICFhbHJlYWR5Rm9jdXNlZCApIHsKCQkJCQkkLm1vYmlsZS5mb2N1c1BhZ2UoIHRvUGFnZSApOwoJCQkJfQoKCQkJCXJlbGVhc2VQYWdlVHJhbnNpdGlvbkxvY2soKTsKCgkJCQkvLyBMZXQgbGlzdGVuZXJzIGtub3cgd2UncmUgYWxsIGRvbmUgY2hhbmdpbmcgdGhlIGN1cnJlbnQgcGFnZS4KCQkJCW1wYy50cmlnZ2VyKCAicGFnZWNoYW5nZSIsIHRyaWdnZXJEYXRhICk7CgkJCX0pOwoJfTsKCgkkLm1vYmlsZS5jaGFuZ2VQYWdlLmRlZmF1bHRzID0gewoJCXRyYW5zaXRpb246IHVuZGVmaW5lZCwKCQlyZXZlcnNlOiBmYWxzZSwKCQljaGFuZ2VIYXNoOiB0cnVlLAoJCWZyb21IYXNoQ2hhbmdlOiBmYWxzZSwKCQlyb2xlOiB1bmRlZmluZWQsIC8vIEJ5IGRlZmF1bHQgd2UgcmVseSBvbiB0aGUgcm9sZSBkZWZpbmVkIGJ5IHRoZSBAZGF0YS1yb2xlIGF0dHJpYnV0ZS4KCQlkdXBsaWNhdGVDYWNoZWRQYWdlOiB1bmRlZmluZWQsCgkJcGFnZUNvbnRhaW5lcjogdW5kZWZpbmVkLAoJCXNob3dMb2FkTXNnOiB0cnVlLCAvL2xvYWRpbmcgbWVzc2FnZSBzaG93cyBieSBkZWZhdWx0IHdoZW4gcGFnZXMgYXJlIGJlaW5nIGZldGNoZWQgZHVyaW5nIGNoYW5nZVBhZ2UKCQlkYXRhVXJsOiB1bmRlZmluZWQsCgkJZnJvbVBhZ2U6IHVuZGVmaW5lZCwKCQlhbGxvd1NhbWVQYWdlVHJhbnNpdGlvbjogZmFsc2UKCX07CgovKiBFdmVudCBCaW5kaW5ncyAtIGhhc2hjaGFuZ2UsIHN1Ym1pdCwgYW5kIGNsaWNrICovCglmdW5jdGlvbiBmaW5kQ2xvc2VzdExpbmsoIGVsZSApCgl7CgkJd2hpbGUgKCBlbGUgKSB7CgkJCS8vIExvb2sgZm9yIHRoZSBjbG9zZXN0IGVsZW1lbnQgd2l0aCBhIG5vZGVOYW1lIG9mICJhIi4KCQkJLy8gTm90ZSB0aGF0IHdlIGFyZSBjaGVja2luZyBpZiB3ZSBoYXZlIGEgdmFsaWQgbm9kZU5hbWUKCQkJLy8gYmVmb3JlIGF0dGVtcHRpbmcgdG8gYWNjZXNzIGl0LiBUaGlzIGlzIGJlY2F1c2UgdGhlCgkJCS8vIG5vZGUgd2UgZ2V0IGNhbGxlZCB3aXRoIGNvdWxkIGhhdmUgb3JpZ2luYXRlZCBmcm9tIHdpdGhpbgoJCQkvLyBhbiBlbWJlZGRlZCBTVkcgZG9jdW1lbnQgd2hlcmUgc29tZSBzeW1ib2wgaW5zdGFuY2UgZWxlbWVudHMKCQkJLy8gZG9uJ3QgaGF2ZSBub2RlTmFtZSBkZWZpbmVkIG9uIHRoZW0sIG9yIHN0cmluZ3MgYXJlIG9mIHR5cGUKCQkJLy8gU1ZHQW5pbWF0ZWRTdHJpbmcuCgkJCWlmICggKCB0eXBlb2YgZWxlLm5vZGVOYW1lID09PSAic3RyaW5nIiApICYmIGVsZS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpID09PSAiYSIgKSB7CgkJCQlicmVhazsKCQkJfQoJCQllbGUgPSBlbGUucGFyZW50Tm9kZTsKCQl9CgkJcmV0dXJuIGVsZTsKCX0KCgkvLyBUaGUgYmFzZSBVUkwgZm9yIGFueSBnaXZlbiBlbGVtZW50IGRlcGVuZHMgb24gdGhlIHBhZ2UgaXQgcmVzaWRlcyBpbi4KCWZ1bmN0aW9uIGdldENsb3Nlc3RCYXNlVXJsKCBlbGUgKQoJewoJCS8vIEZpbmQgdGhlIGNsb3Nlc3QgcGFnZSBhbmQgZXh0cmFjdCBvdXQgaXRzIHVybC4KCQl2YXIgdXJsID0gJCggZWxlICkuY2xvc2VzdCggIi51aS1wYWdlIiApLmpxbURhdGEoICJ1cmwiICksCgkJCWJhc2UgPSBkb2N1bWVudEJhc2UuaHJlZk5vSGFzaDsKCgkJaWYgKCAhdXJsIHx8ICFwYXRoLmlzUGF0aCggdXJsICkgKSB7CgkJCXVybCA9IGJhc2U7CgkJfQoKCQlyZXR1cm4gcGF0aC5tYWtlVXJsQWJzb2x1dGUoIHVybCwgYmFzZSk7Cgl9CgoJLy9UaGUgZm9sbG93aW5nIGV2ZW50IGJpbmRpbmdzIHNob3VsZCBiZSBib3VuZCBhZnRlciBtb2JpbGVpbml0IGhhcyBiZWVuIHRyaWdnZXJlZAoJLy90aGUgZm9sbG93aW5nIGRlZmVycmVkIGlzIHJlc29sdmVkIGluIHRoZSBpbml0IGZpbGUKCSQubW9iaWxlLm5hdnJlYWR5RGVmZXJyZWQgPSAkLkRlZmVycmVkKCk7CgkkLm1vYmlsZS5uYXZyZWFkeURlZmVycmVkLmRvbmUoZnVuY3Rpb24oKSB7CgkJLy9iaW5kIHRvIGZvcm0gc3VibWl0IGV2ZW50cywgaGFuZGxlIHdpdGggQWpheAoJCSQoIGRvY3VtZW50ICkuZGVsZWdhdGUoICJmb3JtIiwgInN1Ym1pdCIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdmFyICR0aGlzID0gJCggdGhpcyApOwoKCQkJaWYgKCAhJC5tb2JpbGUuYWpheEVuYWJsZWQgfHwKCQkJCQkvLyB0ZXN0IHRoYXQgdGhlIGZvcm0gaXMsIGl0c2VsZiwgYWpheCBmYWxzZQoJCQkJCSR0aGlzLmlzKCAiOmpxbURhdGEoYWpheD0nZmFsc2UnKSIgKSB8fAoJCQkJCS8vIHRlc3QgdGhhdCAkLm1vYmlsZS5pZ25vcmVDb250ZW50RW5hYmxlZCBpcyBzZXQgYW5kCgkJCQkJLy8gdGhlIGZvcm0gb3Igb25lIG9mIGl0J3MgcGFyZW50cyBpcyBhamF4PWZhbHNlCgkJCQkJISR0aGlzLmpxbUhpamFja2FibGUoKS5sZW5ndGggKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCXZhciB0eXBlID0gJHRoaXMuYXR0ciggIm1ldGhvZCIgKSwKCQkJCXRhcmdldCA9ICR0aGlzLmF0dHIoICJ0YXJnZXQiICksCgkJCQl1cmwgPSAkdGhpcy5hdHRyKCAiYWN0aW9uIiApOwoKCQkJLy8gSWYgbm8gYWN0aW9uIGlzIHNwZWNpZmllZCwgYnJvd3NlcnMgZGVmYXVsdCB0byB1c2luZyB0aGUKCQkJLy8gVVJMIG9mIHRoZSBkb2N1bWVudCBjb250YWluaW5nIHRoZSBmb3JtLiBTaW5jZSB3ZSBkeW5hbWljYWxseQoJCQkvLyBwdWxsIGluIHBhZ2VzIGZyb20gZXh0ZXJuYWwgZG9jdW1lbnRzLCB0aGUgZm9ybSBzaG91bGQgc3VibWl0CgkJCS8vIHRvIHRoZSBVUkwgZm9yIHRoZSBzb3VyY2UgZG9jdW1lbnQgb2YgdGhlIHBhZ2UgY29udGFpbmluZwoJCQkvLyB0aGUgZm9ybS4KCQkJaWYgKCAhdXJsICkgewoJCQkJLy8gR2V0IHRoZSBAZGF0YS11cmwgZm9yIHRoZSBwYWdlIGNvbnRhaW5pbmcgdGhlIGZvcm0uCgkJCQl1cmwgPSBnZXRDbG9zZXN0QmFzZVVybCggJHRoaXMgKTsKCQkJCWlmICggdXJsID09PSBkb2N1bWVudEJhc2UuaHJlZk5vSGFzaCApIHsKCQkJCQkvLyBUaGUgdXJsIHdlIGdvdCBiYWNrIG1hdGNoZXMgdGhlIGRvY3VtZW50IGJhc2UsCgkJCQkJLy8gd2hpY2ggbWVhbnMgdGhlIHBhZ2UgbXVzdCBiZSBhbiBpbnRlcm5hbC9lbWJlZGRlZCBwYWdlLAoJCQkJCS8vIHNvIGRlZmF1bHQgdG8gdXNpbmcgdGhlIGFjdHVhbCBkb2N1bWVudCB1cmwgYXMgYSBicm93c2VyCgkJCQkJLy8gd291bGQuCgkJCQkJdXJsID0gZG9jdW1lbnRVcmwuaHJlZk5vU2VhcmNoOwoJCQkJfQoJCQl9CgoJCQl1cmwgPSBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggIHVybCwgZ2V0Q2xvc2VzdEJhc2VVcmwoICR0aGlzICkgKTsKCgkJCWlmICggKCBwYXRoLmlzRXh0ZXJuYWwoIHVybCApICYmICFwYXRoLmlzUGVybWl0dGVkQ3Jvc3NEb21haW5SZXF1ZXN0KCBkb2N1bWVudFVybCwgdXJsICkgKSB8fCB0YXJnZXQgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCSQubW9iaWxlLmNoYW5nZVBhZ2UoCgkJCQl1cmwsCgkJCQl7CgkJCQkJdHlwZToJCXR5cGUgJiYgdHlwZS5sZW5ndGggJiYgdHlwZS50b0xvd2VyQ2FzZSgpIHx8ICJnZXQiLAoJCQkJCWRhdGE6CQkkdGhpcy5zZXJpYWxpemUoKSwKCQkJCQl0cmFuc2l0aW9uOgkkdGhpcy5qcW1EYXRhKCAidHJhbnNpdGlvbiIgKSwKCQkJCQlyZXZlcnNlOgkkdGhpcy5qcW1EYXRhKCAiZGlyZWN0aW9uIiApID09PSAicmV2ZXJzZSIsCgkJCQkJcmVsb2FkUGFnZToJdHJ1ZQoJCQkJfQoJCQkpOwoJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCX0pOwoKCQkvL2FkZCBhY3RpdmUgc3RhdGUgb24gdmNsaWNrCgkJJCggZG9jdW1lbnQgKS5iaW5kKCAidmNsaWNrIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkvLyBpZiB0aGlzIGlzbid0IGEgbGVmdCBjbGljayB3ZSBkb24ndCBjYXJlLiBJdHMgaW1wb3J0YW50IHRvIG5vdGUKCQkJLy8gdGhhdCB3aGVuIHRoZSB2aXJ0dWFsIGV2ZW50IGlzIGdlbmVyYXRlZCBpdCB3aWxsIGNyZWF0ZSB0aGUgd2hpY2ggYXR0cgoJCQlpZiAoIGV2ZW50LndoaWNoID4gMSB8fCAhJC5tb2JpbGUubGlua0JpbmRpbmdFbmFibGVkICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQl2YXIgbGluayA9IGZpbmRDbG9zZXN0TGluayggZXZlbnQudGFyZ2V0ICk7CgoJCQkvLyBzcGxpdCBmcm9tIHRoZSBwcmV2aW91cyByZXR1cm4gbG9naWMgdG8gYXZvaWQgZmluZCBjbG9zZXN0IHdoZXJlIHBvc3NpYmxlCgkJCS8vIFRPRE8gdGVhY2ggJC5tb2JpbGUuaGlqYWNrYWJsZSB0byBvcGVyYXRlIG9uIHJhdyBkb20gZWxlbWVudHMgc28gdGhlIGxpbmsgd3JhcHBpbmcKCQkJLy8gY2FuIGJlIGF2b2lkZWQKCQkJaWYgKCAhJCggbGluayApLmpxbUhpamFja2FibGUoKS5sZW5ndGggKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCWlmICggbGluayApIHsKCQkJCWlmICggcGF0aC5wYXJzZVVybCggbGluay5nZXRBdHRyaWJ1dGUoICJocmVmIiApIHx8ICIjIiApLmhhc2ggIT09ICIjIiApIHsKCQkJCQlyZW1vdmVBY3RpdmVMaW5rQ2xhc3MoIHRydWUgKTsKCQkJCQkkYWN0aXZlQ2xpY2tlZExpbmsgPSAkKCBsaW5rICkuY2xvc2VzdCggIi51aS1idG4iICkubm90KCAiLnVpLWRpc2FibGVkIiApOwoJCQkJCSRhY3RpdmVDbGlja2VkTGluay5hZGRDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJCX0KCQkJfQoJCX0pOwoKCQkvLyBjbGljayByb3V0aW5nIC0gZGlyZWN0IHRvIEhUVFAgb3IgQWpheCwgYWNjb3JkaW5nbHkKCQkkKCBkb2N1bWVudCApLmJpbmQoICJjbGljayIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJaWYgKCAhJC5tb2JpbGUubGlua0JpbmRpbmdFbmFibGVkICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQl2YXIgbGluayA9IGZpbmRDbG9zZXN0TGluayggZXZlbnQudGFyZ2V0ICksICRsaW5rID0gJCggbGluayApLCBodHRwQ2xlYW51cDsKCgkJCS8vIElmIHRoZXJlIGlzIG5vIGxpbmsgYXNzb2NpYXRlZCB3aXRoIHRoZSBjbGljayBvciBpdHMgbm90IGEgbGVmdAoJCQkvLyBjbGljayB3ZSB3YW50IHRvIGlnbm9yZSB0aGUgY2xpY2sKCQkJLy8gVE9ETyB0ZWFjaCAkLm1vYmlsZS5oaWphY2thYmxlIHRvIG9wZXJhdGUgb24gcmF3IGRvbSBlbGVtZW50cyBzbyB0aGUgbGluayB3cmFwcGluZwoJCQkvLyBjYW4gYmUgYXZvaWRlZAoJCQlpZiAoICFsaW5rIHx8IGV2ZW50LndoaWNoID4gMSB8fCAhJGxpbmsuanFtSGlqYWNrYWJsZSgpLmxlbmd0aCApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJLy9yZW1vdmUgYWN0aXZlIGxpbmsgY2xhc3MgaWYgZXh0ZXJuYWwgKHRoZW4gaXQgd29uJ3QgYmUgdGhlcmUgaWYgeW91IGNvbWUgYmFjaykKCQkJaHR0cENsZWFudXAgPSBmdW5jdGlvbigpIHsKCQkJCXdpbmRvdy5zZXRUaW1lb3V0KGZ1bmN0aW9uKCkgeyByZW1vdmVBY3RpdmVMaW5rQ2xhc3MoIHRydWUgKTsgfSwgMjAwICk7CgkJCX07CgoJCQkvL2lmIHRoZXJlJ3MgYSBkYXRhLXJlbD1iYWNrIGF0dHIsIGdvIGJhY2sgaW4gaGlzdG9yeQoJCQlpZiAoICRsaW5rLmlzKCAiOmpxbURhdGEocmVsPSdiYWNrJykiICkgKSB7CgkJCQkkLm1vYmlsZS5iYWNrKCk7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCgkJCXZhciBiYXNlVXJsID0gZ2V0Q2xvc2VzdEJhc2VVcmwoICRsaW5rICksCgoJCQkJLy9nZXQgaHJlZiwgaWYgZGVmaW5lZCwgb3RoZXJ3aXNlIGRlZmF1bHQgdG8gZW1wdHkgaGFzaAoJCQkJaHJlZiA9IHBhdGgubWFrZVVybEFic29sdXRlKCAkbGluay5hdHRyKCAiaHJlZiIgKSB8fCAiIyIsIGJhc2VVcmwgKTsKCgkJCS8vaWYgYWpheCBpcyBkaXNhYmxlZCwgZXhpdCBlYXJseQoJCQlpZiAoICEkLm1vYmlsZS5hamF4RW5hYmxlZCAmJiAhcGF0aC5pc0VtYmVkZGVkUGFnZSggaHJlZiApICkgewoJCQkJaHR0cENsZWFudXAoKTsKCQkJCS8vdXNlIGRlZmF1bHQgY2xpY2sgaGFuZGxpbmcKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gWFhYX2pibGFzOiBJZGVhbGx5IGxpbmtzIHRvIGFwcGxpY2F0aW9uIHBhZ2VzIHNob3VsZCBiZSBzcGVjaWZpZWQgYXMKCQkJLy8gICAgICAgICAgICBhbiB1cmwgdG8gdGhlIGFwcGxpY2F0aW9uIGRvY3VtZW50IHdpdGggYSBoYXNoIHRoYXQgaXMgZWl0aGVyCgkJCS8vICAgICAgICAgICAgdGhlIHNpdGUgcmVsYXRpdmUgcGF0aCBvciBpZCB0byB0aGUgcGFnZS4gQnV0IHNvbWUgb2YgdGhlCgkJCS8vICAgICAgICAgICAgaW50ZXJuYWwgY29kZSB0aGF0IGR5bmFtaWNhbGx5IGdlbmVyYXRlcyBzdWItcGFnZXMgZm9yIG5lc3RlZAoJCQkvLyAgICAgICAgICAgIGxpc3RzIGFuZCBzZWxlY3QgZGlhbG9ncywganVzdCB3cml0ZSBhIGhhc2ggaW4gdGhlIGxpbmsgdGhleQoJCQkvLyAgICAgICAgICAgIGNyZWF0ZS4gVGhpcyBtZWFucyB0aGUgYWN0dWFsIFVSTCBwYXRoIGlzIGJhc2VkIG9uIHdoYXRldmVyCgkJCS8vICAgICAgICAgICAgdGhlIGN1cnJlbnQgdmFsdWUgb2YgdGhlIGJhc2UgdGFnIGlzIGF0IHRoZSB0aW1lIHRoaXMgY29kZQoJCQkvLyAgICAgICAgICAgIGlzIGNhbGxlZC4gRm9yIG5vdyB3ZSBhcmUganVzdCBhc3N1bWluZyB0aGF0IGFueSB1cmwgd2l0aCBhCgkJCS8vICAgICAgICAgICAgaGFzaCBpbiBpdCBpcyBhbiBhcHBsaWNhdGlvbiBwYWdlIHJlZmVyZW5jZS4KCQkJaWYgKCBocmVmLnNlYXJjaCggIiMiICkgIT09IC0xICkgewoJCQkJaHJlZiA9IGhyZWYucmVwbGFjZSggL1teI10qIy8sICIiICk7CgkJCQlpZiAoICFocmVmICkgewoJCQkJCS8vbGluayB3YXMgYW4gZW1wdHkgaGFzaCBtZWFudCBwdXJlbHkKCQkJCQkvL2ZvciBpbnRlcmFjdGlvbiwgc28gd2UgaWdub3JlIGl0LgoJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQkJcmV0dXJuOwoJCQkJfSBlbHNlIGlmICggcGF0aC5pc1BhdGgoIGhyZWYgKSApIHsKCQkJCQkvL3dlIGhhdmUgYXBhdGggc28gbWFrZSBpdCB0aGUgaHJlZiB3ZSB3YW50IHRvIGxvYWQuCgkJCQkJaHJlZiA9IHBhdGgubWFrZVVybEFic29sdXRlKCBocmVmLCBiYXNlVXJsICk7CgkJCQl9IGVsc2UgewoJCQkJCS8vd2UgaGF2ZSBhIHNpbXBsZSBpZCBzbyB1c2UgdGhlIGRvY3VtZW50VXJsIGFzIGl0cyBiYXNlLgoJCQkJCWhyZWYgPSBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggIiMiICsgaHJlZiwgZG9jdW1lbnRVcmwuaHJlZk5vSGFzaCApOwoJCQkJfQoJCQl9CgoJCQkJLy8gU2hvdWxkIHdlIGhhbmRsZSB0aGlzIGxpbmssIG9yIGxldCB0aGUgYnJvd3NlciBkZWFsIHdpdGggaXQ/CgkJCXZhciB1c2VEZWZhdWx0VXJsSGFuZGxpbmcgPSAkbGluay5pcyggIltyZWw9J2V4dGVybmFsJ10iICkgfHwgJGxpbmsuaXMoICI6anFtRGF0YShhamF4PSdmYWxzZScpIiApIHx8ICRsaW5rLmlzKCAiW3RhcmdldF0iICksCgoJCQkJLy8gU29tZSBlbWJlZGRlZCBicm93c2VycywgbGlrZSB0aGUgd2ViIHZpZXcgaW4gUGhvbmUgR2FwLCBhbGxvdyBjcm9zcy1kb21haW4gWEhSCgkJCQkvLyByZXF1ZXN0cyBpZiB0aGUgZG9jdW1lbnQgZG9pbmcgdGhlIHJlcXVlc3Qgd2FzIGxvYWRlZCB2aWEgdGhlIGZpbGU6Ly8gcHJvdG9jb2wuCgkJCQkvLyBUaGlzIGlzIHVzdWFsbHkgdG8gYWxsb3cgdGhlIGFwcGxpY2F0aW9uIHRvICJwaG9uZSBob21lIiBhbmQgZmV0Y2ggYXBwIHNwZWNpZmljCgkJCQkvLyBkYXRhLiBXZSBub3JtYWxseSBsZXQgdGhlIGJyb3dzZXIgaGFuZGxlIGV4dGVybmFsL2Nyb3NzLWRvbWFpbiB1cmxzLCBidXQgaWYgdGhlCgkJCQkvLyBhbGxvd0Nyb3NzRG9tYWluUGFnZXMgb3B0aW9uIGlzIHRydWUsIHdlIHdpbGwgYWxsb3cgY3Jvc3MtZG9tYWluIGh0dHAvaHR0cHMKCQkJCS8vIHJlcXVlc3RzIHRvIGdvIHRocm91Z2ggb3VyIHBhZ2UgbG9hZGluZyBsb2dpYy4KCgkJCQkvL2NoZWNrIGZvciBwcm90b2NvbCBvciByZWwgYW5kIGl0cyBub3QgYW4gZW1iZWRkZWQgcGFnZQoJCQkJLy9UT0RPIG92ZXJsYXAgaW4gbG9naWMgZnJvbSBpc0V4dGVybmFsLCByZWw9ZXh0ZXJuYWwgY2hlY2sgc2hvdWxkIGJlCgkJCQkvLyAgICAgbW92ZWQgaW50byBtb3JlIGNvbXByZWhlbnNpdmUgaXNFeHRlcm5hbExpbmsKCQkJCWlzRXh0ZXJuYWwgPSB1c2VEZWZhdWx0VXJsSGFuZGxpbmcgfHwgKCBwYXRoLmlzRXh0ZXJuYWwoIGhyZWYgKSAmJiAhcGF0aC5pc1Blcm1pdHRlZENyb3NzRG9tYWluUmVxdWVzdCggZG9jdW1lbnRVcmwsIGhyZWYgKSApOwoKCQkJaWYgKCBpc0V4dGVybmFsICkgewoJCQkJaHR0cENsZWFudXAoKTsKCQkJCS8vdXNlIGRlZmF1bHQgY2xpY2sgaGFuZGxpbmcKCQkJCXJldHVybjsKCQkJfQoKCQkJLy91c2UgYWpheAoJCQl2YXIgdHJhbnNpdGlvbiA9ICRsaW5rLmpxbURhdGEoICJ0cmFuc2l0aW9uIiApLAoJCQkJcmV2ZXJzZSA9ICRsaW5rLmpxbURhdGEoICJkaXJlY3Rpb24iICkgPT09ICJyZXZlcnNlIiB8fAoJCQkJCQkJLy8gZGVwcmVjYXRlZCAtIHJlbW92ZSBieSAxLjAKCQkJCQkJCSRsaW5rLmpxbURhdGEoICJiYWNrIiApLAoKCQkJCS8vdGhpcyBtYXkgbmVlZCB0byBiZSBtb3JlIHNwZWNpZmljIGFzIHdlIHVzZSBkYXRhLXJlbCBtb3JlCgkJCQlyb2xlID0gJGxpbmsuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgInJlbCIgKSB8fCB1bmRlZmluZWQ7CgoJCQkkLm1vYmlsZS5jaGFuZ2VQYWdlKCBocmVmLCB7IHRyYW5zaXRpb246IHRyYW5zaXRpb24sIHJldmVyc2U6IHJldmVyc2UsIHJvbGU6IHJvbGUsIGxpbms6ICRsaW5rIH0gKTsKCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQl9KTsKCgkJLy9wcmVmZXRjaCBwYWdlcyB3aGVuIGFuY2hvcnMgd2l0aCBkYXRhLXByZWZldGNoIGFyZSBlbmNvdW50ZXJlZAoJCSQoIGRvY3VtZW50ICkuZGVsZWdhdGUoICIudWktcGFnZSIsICJwYWdlc2hvdy5wcmVmZXRjaCIsIGZ1bmN0aW9uKCkgewoJCQl2YXIgdXJscyA9IFtdOwoJCQkkKCB0aGlzICkuZmluZCggImE6anFtRGF0YShwcmVmZXRjaCkiICkuZWFjaChmdW5jdGlvbigpIHsKCQkJCXZhciAkbGluayA9ICQoIHRoaXMgKSwKCQkJCQl1cmwgPSAkbGluay5hdHRyKCAiaHJlZiIgKTsKCgkJCQlpZiAoIHVybCAmJiAkLmluQXJyYXkoIHVybCwgdXJscyApID09PSAtMSApIHsKCQkJCQl1cmxzLnB1c2goIHVybCApOwoKCQkJCQkkLm1vYmlsZS5sb2FkUGFnZSggdXJsLCB7IHJvbGU6ICRsaW5rLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyZWwiICkgfSApOwoJCQkJfQoJCQl9KTsKCQl9KTsKCgkJJC5tb2JpbGUuX2hhbmRsZUhhc2hDaGFuZ2UgPSBmdW5jdGlvbiggaGFzaCApIHsKCQkJLy9maW5kIGZpcnN0IHBhZ2UgdmlhIGhhc2gKCQkJdmFyIHRvID0gcGF0aC5zdHJpcEhhc2goIGhhc2ggKSwKCQkJCS8vdHJhbnNpdGlvbiBpcyBmYWxzZSBpZiBpdCdzIHRoZSBmaXJzdCBwYWdlLCB1bmRlZmluZWQgb3RoZXJ3aXNlIChhbmQgbWF5IGJlIG92ZXJyaWRkZW4gYnkgZGVmYXVsdCkKCQkJCXRyYW5zaXRpb24gPSAkLm1vYmlsZS51cmxIaXN0b3J5LnN0YWNrLmxlbmd0aCA9PT0gMCA/ICJub25lIiA6IHVuZGVmaW5lZCwKCgkJCQkvLyAibmF2aWdhdGUiIGV2ZW50IGZpcmVkIHRvIGFsbG93IG90aGVycyB0byB0YWtlIGFkdmFudGFnZSBvZiB0aGUgbW9yZSByb2J1c3QgaGFzaGNoYW5nZSBoYW5kbGluZwoJCQkJbmF2RXZlbnQgPSBuZXcgJC5FdmVudCggIm5hdmlnYXRlIiApLAoKCQkJCS8vIGRlZmF1bHQgb3B0aW9ucyBmb3IgdGhlIGNoYW5nUGFnZSBjYWxscyBtYWRlIGFmdGVyIGV4YW1pbmluZyB0aGUgY3VycmVudCBzdGF0ZQoJCQkJLy8gb2YgdGhlIHBhZ2UgYW5kIHRoZSBoYXNoCgkJCQljaGFuZ2VQYWdlT3B0aW9ucyA9IHsKCQkJCQl0cmFuc2l0aW9uOiB0cmFuc2l0aW9uLAoJCQkJCWNoYW5nZUhhc2g6IGZhbHNlLAoJCQkJCWZyb21IYXNoQ2hhbmdlOiB0cnVlCgkJCQl9OwoKCQkJaWYgKCAwID09PSB1cmxIaXN0b3J5LnN0YWNrLmxlbmd0aCApIHsKCQkJCXVybEhpc3RvcnkuaW5pdGlhbERzdCA9IHRvOwoJCQl9CgoJCQkvLyBXZSBzaG91bGQgcHJvYmFibHkgZmlyZSB0aGUgIm5hdmlnYXRlIiBldmVudCBmcm9tIHRob3NlIHBsYWNlcyB0aGF0IG1ha2UgY2FsbHMgdG8gX2hhbmRsZUhhc2hDaGFuZ2UsCgkJCS8vIGFuZCBoYXZlIF9oYW5kbGVIYXNoQ2hhbmdlIGhvb2sgaW50byB0aGUgIm5hdmlnYXRlIiBldmVudCBpbnN0ZWFkIG9mIHRyaWdnZXJpbmcgaXQgaGVyZQoJCQkkLm1vYmlsZS5wYWdlQ29udGFpbmVyLnRyaWdnZXIoIG5hdkV2ZW50ICk7CgkJCWlmICggbmF2RXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vaWYgbGlzdGVuaW5nIGlzIGRpc2FibGVkIChlaXRoZXIgZ2xvYmFsbHkgb3IgdGVtcG9yYXJpbHkpLCBvciBpdCdzIGEgZGlhbG9nIGhhc2gKCQkJaWYgKCAhJC5tb2JpbGUuaGFzaExpc3RlbmluZ0VuYWJsZWQgfHwgdXJsSGlzdG9yeS5pZ25vcmVOZXh0SGFzaENoYW5nZSApIHsKCQkJCXVybEhpc3RvcnkuaWdub3JlTmV4dEhhc2hDaGFuZ2UgPSBmYWxzZTsKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gc3BlY2lhbCBjYXNlIGZvciBkaWFsb2dzCgkJCWlmICggdXJsSGlzdG9yeS5zdGFjay5sZW5ndGggPiAxICYmIHRvLmluZGV4T2YoIGRpYWxvZ0hhc2hLZXkgKSA+IC0xICYmIHVybEhpc3RvcnkuaW5pdGlhbERzdCAhPT0gdG8gKSB7CgoJCQkJLy8gSWYgY3VycmVudCBhY3RpdmUgcGFnZSBpcyBub3QgYSBkaWFsb2cgc2tpcCB0aGUgZGlhbG9nIGFuZCBjb250aW51ZQoJCQkJLy8gaW4gdGhlIHNhbWUgZGlyZWN0aW9uCgkJCQlpZiAoICEkLm1vYmlsZS5hY3RpdmVQYWdlLmlzKCAiLnVpLWRpYWxvZyIgKSApIHsKCQkJCQkvL2RldGVybWluZSBpZiB3ZSdyZSBoZWFkaW5nIGZvcndhcmQgb3IgYmFja3dhcmQgYW5kIGNvbnRpbnVlIGFjY29yZGluZ2x5IHBhc3QKCQkJCQkvL3RoZSBjdXJyZW50IGRpYWxvZwoJCQkJCXVybEhpc3RvcnkuZGlyZWN0SGFzaENoYW5nZSh7CgkJCQkJCWN1cnJlbnRVcmw6IHRvLAoJCQkJCQlpc0JhY2s6IGZ1bmN0aW9uKCkgeyAkLm1vYmlsZS5iYWNrKCk7IH0sCgkJCQkJCWlzRm9yd2FyZDogZnVuY3Rpb24oKSB7IHdpbmRvdy5oaXN0b3J5LmZvcndhcmQoKTsgfQoJCQkJCX0pOwoKCQkJCQkvLyBwcmV2ZW50IGNoYW5nZVBhZ2UoKQoJCQkJCXJldHVybjsKCQkJCX0gZWxzZSB7CgkJCQkJLy8gaWYgdGhlIGN1cnJlbnQgYWN0aXZlIHBhZ2UgaXMgYSBkaWFsb2cgYW5kIHdlJ3JlIG5hdmlnYXRpbmcKCQkJCQkvLyB0byBhIGRpYWxvZyB1c2UgdGhlIGRpYWxvZyBvYmplY3RlZCBzYXZlZCBpbiB0aGUgc3RhY2sKCQkJCQl1cmxIaXN0b3J5LmRpcmVjdEhhc2hDaGFuZ2UoewoJCQkJCQljdXJyZW50VXJsOiB0bywKCgkJCQkJCS8vIHJlZ2FyZGxlc3Mgb2YgdGhlIGRpcmVjdGlvbiBvZiB0aGUgaGlzdG9yeSBjaGFuZ2UKCQkJCQkJLy8gZG8gdGhlIGZvbGxvd2luZwoJCQkJCQllaXRoZXI6IGZ1bmN0aW9uKCBpc0JhY2sgKSB7CgkJCQkJCQl2YXIgYWN0aXZlID0gJC5tb2JpbGUudXJsSGlzdG9yeS5nZXRBY3RpdmUoKTsKCgkJCQkJCQl0byA9IGFjdGl2ZS5wYWdlVXJsOwoKCQkJCQkJCS8vIG1ha2Ugc3VyZSB0byBzZXQgdGhlIHJvbGUsIHRyYW5zaXRpb24gYW5kIHJldmVyc2FsCgkJCQkJCQkvLyBhcyBtb3N0IG9mIHRoaXMgaXMgbG9zdCBieSB0aGUgZG9tQ2FjaGUgY2xlYW5pbmcKCQkJCQkJCSQuZXh0ZW5kKCBjaGFuZ2VQYWdlT3B0aW9ucywgewoJCQkJCQkJCXJvbGU6IGFjdGl2ZS5yb2xlLAoJCQkJCQkJCXRyYW5zaXRpb246IGFjdGl2ZS50cmFuc2l0aW9uLAoJCQkJCQkJCXJldmVyc2U6IGlzQmFjawoJCQkJCQkJfSk7CgkJCQkJCX0KCQkJCQl9KTsKCQkJCX0KCQkJfQoKCQkJLy9pZiB0byBpcyBkZWZpbmVkLCBsb2FkIGl0CgkJCWlmICggdG8gKSB7CgkJCQkvLyBBdCB0aGlzIHBvaW50LCAndG8nIGNhbiBiZSBvbmUgb2YgMyB0aGluZ3MsIGEgY2FjaGVkIHBhZ2UgZWxlbWVudCBmcm9tCgkJCQkvLyBhIGhpc3Rvcnkgc3RhY2sgZW50cnksIGFuIGlkLCBvciBzaXRlLXJlbGF0aXZlL2Fic29sdXRlIFVSTC4gSWYgJ3RvJyBpcwoJCQkJLy8gYW4gaWQsIHdlIG5lZWQgdG8gcmVzb2x2ZSBpdCBhZ2FpbnN0IHRoZSBkb2N1bWVudEJhc2UsIG5vdCB0aGUgbG9jYXRpb24uaHJlZiwKCQkJCS8vIHNpbmNlIHRoZSBoYXNoY2hhbmdlIGNvdWxkJ3ZlIGJlZW4gdGhlIHJlc3VsdCBvZiBhIGZvcndhcmQvYmFja3dhcmQgbmF2aWdhdGlvbgoJCQkJLy8gdGhhdCBjcm9zc2VzIGZyb20gYW4gZXh0ZXJuYWwgcGFnZS9kaWFsb2cgdG8gYW4gaW50ZXJuYWwgcGFnZS9kaWFsb2cuCgkJCQl0byA9ICggdHlwZW9mIHRvID09PSAic3RyaW5nIiAmJiAhcGF0aC5pc1BhdGgoIHRvICkgKSA/ICggcGF0aC5tYWtlVXJsQWJzb2x1dGUoICcjJyArIHRvLCBkb2N1bWVudEJhc2UgKSApIDogdG87CgoJCQkJLy8gSWYgd2UncmUgYWJvdXQgdG8gZ28gdG8gYW4gaW5pdGlhbCBVUkwgdGhhdCBjb250YWlucyBhIHJlZmVyZW5jZSB0byBhIG5vbi1leGlzdGVudAoJCQkJLy8gaW50ZXJuYWwgcGFnZSwgZ28gdG8gdGhlIGZpcnN0IHBhZ2UgaW5zdGVhZC4gV2Uga25vdyB0aGF0IHRoZSBpbml0aWFsIGhhc2ggcmVmZXJzIHRvIGEKCQkJCS8vIG5vbi1leGlzdGVudCBwYWdlLCBiZWNhdXNlIHRoZSBpbml0aWFsIGhhc2ggZGlkIG5vdCBlbmQgdXAgaW4gdGhlIGluaXRpYWwgdXJsSGlzdG9yeSBlbnRyeQoJCQkJaWYgKCB0byA9PT0gcGF0aC5tYWtlVXJsQWJzb2x1dGUoICcjJyArIHVybEhpc3RvcnkuaW5pdGlhbERzdCwgZG9jdW1lbnRCYXNlICkgJiYKCQkJCQl1cmxIaXN0b3J5LnN0YWNrLmxlbmd0aCAmJiB1cmxIaXN0b3J5LnN0YWNrWzBdLnVybCAhPT0gdXJsSGlzdG9yeS5pbml0aWFsRHN0LnJlcGxhY2UoIGRpYWxvZ0hhc2hLZXksICIiICkgKSB7CgkJCQkJdG8gPSAkLm1vYmlsZS5maXJzdFBhZ2U7CgkJCQl9CgkJCQkkLm1vYmlsZS5jaGFuZ2VQYWdlKCB0bywgY2hhbmdlUGFnZU9wdGlvbnMgKTsKCQkJfQllbHNlIHsKCQkJCS8vdGhlcmUncyBubyBoYXNoLCBnbyB0byB0aGUgZmlyc3QgcGFnZSBpbiB0aGUgZG9tCgkJCQkkLm1vYmlsZS5jaGFuZ2VQYWdlKCAkLm1vYmlsZS5maXJzdFBhZ2UsIGNoYW5nZVBhZ2VPcHRpb25zICk7CgkJCX0KCQl9OwoKCQkvL2hhc2hjaGFuZ2UgZXZlbnQgaGFuZGxlcgoJCSR3aW5kb3cuYmluZCggImhhc2hjaGFuZ2UiLCBmdW5jdGlvbiggZSwgdHJpZ2dlcmVkICkgewoJCQkvLyBGaXJlZm94IGF1dG8tZXNjYXBlcyB0aGUgbG9jYXRpb24uaGFzaCBhcyBmb3IgdjEzIGJ1dAoJCQkvLyBsZWF2ZXMgdGhlIGhyZWYgdW50b3VjaGVkCgkJCSQubW9iaWxlLl9oYW5kbGVIYXNoQ2hhbmdlKCBwYXRoLnBhcnNlTG9jYXRpb24oKS5oYXNoICk7CgkJfSk7CgoJCS8vc2V0IHBhZ2UgbWluLWhlaWdodHMgdG8gYmUgZGV2aWNlIHNwZWNpZmljCgkJJCggZG9jdW1lbnQgKS5iaW5kKCAicGFnZXNob3ciLCByZXNldEFjdGl2ZVBhZ2VIZWlnaHQgKTsKCQkkKCB3aW5kb3cgKS5iaW5kKCAidGhyb3R0bGVkcmVzaXplIiwgcmVzZXRBY3RpdmVQYWdlSGVpZ2h0ICk7CgoJfSk7Ly9uYXZyZWFkeURlZmVycmVkIGRvbmUgY2FsbGJhY2sKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgd2luZG93ICkgewoJLy8gRm9yIG5vdywgbGV0J3MgTW9ua2V5cGF0Y2ggdGhpcyBvbnRvIHRoZSBlbmQgb2YgJC5tb2JpbGUuX3JlZ2lzdGVySW50ZXJuYWxFdmVudHMKCS8vIFNjb3BlIHNlbGYgdG8gcHVzaFN0YXRlSGFuZGxlciBzbyB3ZSBjYW4gcmVmZXJlbmNlIGl0IHNhbmVseSB3aXRoaW4gdGhlCgkvLyBtZXRob2RzIGhhbmRlZCBvZmYgYXMgZXZlbnQgaGFuZGxlcnMKCXZhcglwdXNoU3RhdGVIYW5kbGVyID0ge30sCgkJc2VsZiA9IHB1c2hTdGF0ZUhhbmRsZXIsCgkJJHdpbiA9ICQoIHdpbmRvdyApLAoJCXVybCA9ICQubW9iaWxlLnBhdGgucGFyc2VMb2NhdGlvbigpLAoJCW1vYmlsZWluaXREZWZlcnJlZCA9ICQuRGVmZXJyZWQoKSwKCQlkb21yZWFkeURlZmVycmVkID0gJC5EZWZlcnJlZCgpOwoKCSQoIGRvY3VtZW50ICkucmVhZHkoICQucHJveHkoIGRvbXJlYWR5RGVmZXJyZWQsICJyZXNvbHZlIiApICk7CgoJJCggZG9jdW1lbnQgKS5vbmUoICJtb2JpbGVpbml0IiwgJC5wcm94eSggbW9iaWxlaW5pdERlZmVycmVkLCAicmVzb2x2ZSIgKSApOwoKCSQuZXh0ZW5kKCBwdXNoU3RhdGVIYW5kbGVyLCB7CgkJLy8gVE9ETyBtb3ZlIHRvIGEgcGF0aCBoZWxwZXIsIHRoaXMgaXMgcmF0aGVyIGNvbW1vbiBmdW5jdGlvbmFsaXR5CgkJaW5pdGlhbEZpbGVQYXRoOiAoZnVuY3Rpb24oKSB7CgkJCXJldHVybiB1cmwucGF0aG5hbWUgKyB1cmwuc2VhcmNoOwoJCX0pKCksCgoJCWhhc2hDaGFuZ2VUaW1lb3V0OiAyMDAsCgoJCWhhc2hDaGFuZ2VFbmFibGVUaW1lcjogdW5kZWZpbmVkLAoKCQlpbml0aWFsSHJlZjogdXJsLmhyZWZOb0hhc2gsCgoJCXN0YXRlOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHsKCQkJCS8vIGZpcmVmb3ggYXV0byBkZWNvZGVzIHRoZSB1cmwgd2hlbiB1c2luZyBsb2NhdGlvbi5oYXNoIGJ1dCBub3QgaHJlZgoJCQkJaGFzaDogJC5tb2JpbGUucGF0aC5wYXJzZUxvY2F0aW9uKCkuaGFzaCB8fCAiIyIgKyBzZWxmLmluaXRpYWxGaWxlUGF0aCwKCQkJCXRpdGxlOiBkb2N1bWVudC50aXRsZSwKCgkJCQkvLyBwZXJzaXN0IGFjcm9zcyByZWZyZXNoCgkJCQlpbml0aWFsSHJlZjogc2VsZi5pbml0aWFsSHJlZgoJCQl9OwoJCX0sCgoJCXJlc2V0VUlLZXlzOiBmdW5jdGlvbiggdXJsICkgewoJCQl2YXIgZGlhbG9nID0gJC5tb2JpbGUuZGlhbG9nSGFzaEtleSwKCQkJCXN1YmtleSA9ICImIiArICQubW9iaWxlLnN1YlBhZ2VVcmxLZXksCgkJCQlkaWFsb2dJbmRleCA9IHVybC5pbmRleE9mKCBkaWFsb2cgKTsKCgkJCWlmICggZGlhbG9nSW5kZXggPiAtMSApIHsKCQkJCXVybCA9IHVybC5zbGljZSggMCwgZGlhbG9nSW5kZXggKSArICIjIiArIHVybC5zbGljZSggZGlhbG9nSW5kZXggKTsKCQkJfSBlbHNlIGlmICggdXJsLmluZGV4T2YoIHN1YmtleSApID4gLTEgKSB7CgkJCQl1cmwgPSB1cmwuc3BsaXQoIHN1YmtleSApLmpvaW4oICIjIiArIHN1YmtleSApOwoJCQl9CgoJCQlyZXR1cm4gdXJsOwoJCX0sCgoJCS8vIFRPRE8gc29ydCBvdXQgYSBzaW5nbGUgYmFycmllciB0byBoYXNoY2hhbmdlIGZ1bmN0aW9uYWxpdHkKCQluZXh0SGFzaENoYW5nZVByZXZlbnRlZDogZnVuY3Rpb24oIHZhbHVlICkgewoJCQkkLm1vYmlsZS51cmxIaXN0b3J5Lmlnbm9yZU5leHRIYXNoQ2hhbmdlID0gdmFsdWU7CgkJCXNlbGYub25IYXNoQ2hhbmdlRGlzYWJsZWQgPSB2YWx1ZTsKCQl9LAoKCQkvLyBvbiBoYXNoIGNoYW5nZSB3ZSB3YW50IHRvIGNsZWFuIHVwIHRoZSB1cmwKCQkvLyBOT1RFIHRoaXMgdGFrZXMgcGxhY2UgKmFmdGVyKiB0aGUgdmFuaWxsYSBuYXZpZ2F0aW9uIGhhc2ggY2hhbmdlCgkJLy8gaGFuZGxpbmcgaGFzIHRha2VuIHBsYWNlIGFuZCBzZXQgdGhlIHN0YXRlIG9mIHRoZSBET00KCQlvbkhhc2hDaGFuZ2U6IGZ1bmN0aW9uKCBlICkgewoJCQkvLyBkaXNhYmxlIHRoaXMgaGFzaCBjaGFuZ2UKCQkJaWYgKCBzZWxmLm9uSGFzaENoYW5nZURpc2FibGVkICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQl2YXIgaHJlZiwgc3RhdGUsCgkJCQkvLyBmaXJlZm94IGF1dG8gZGVjb2RlcyB0aGUgdXJsIHdoZW4gdXNpbmcgbG9jYXRpb24uaGFzaCBidXQgbm90IGhyZWYKCQkJCWhhc2ggPSAkLm1vYmlsZS5wYXRoLnBhcnNlTG9jYXRpb24oKS5oYXNoLAoJCQkJaXNQYXRoID0gJC5tb2JpbGUucGF0aC5pc1BhdGgoIGhhc2ggKSwKCQkJCXJlc29sdXRpb25VcmwgPSBpc1BhdGggPyAkLm1vYmlsZS5wYXRoLmdldExvY2F0aW9uKCkgOiAkLm1vYmlsZS5nZXREb2N1bWVudFVybCgpOwoKCQkJaGFzaCA9IGlzUGF0aCA/IGhhc2gucmVwbGFjZSggIiMiLCAiIiApIDogaGFzaDsKCgoJCQkvLyBwcm9wdWxhdGUgdGhlIGhhc2ggd2hlbiBpdHMgbm90IGF2YWlsYWJsZQoJCQlzdGF0ZSA9IHNlbGYuc3RhdGUoKTsKCgkJCS8vIG1ha2UgdGhlIGhhc2ggYWJvbHV0ZSB3aXRoIHRoZSBjdXJyZW50IGhyZWYKCQkJaHJlZiA9ICQubW9iaWxlLnBhdGgubWFrZVVybEFic29sdXRlKCBoYXNoLCByZXNvbHV0aW9uVXJsICk7CgoJCQlpZiAoIGlzUGF0aCApIHsKCQkJCWhyZWYgPSBzZWxmLnJlc2V0VUlLZXlzKCBocmVmICk7CgkJCX0KCgkJCS8vIHJlcGxhY2UgdGhlIGN1cnJlbnQgdXJsIHdpdGggdGhlIG5ldyBocmVmIGFuZCBzdG9yZSB0aGUgc3RhdGUKCQkJLy8gTm90ZSB0aGF0IGluIHNvbWUgY2FzZXMgd2UgbWlnaHQgYmUgcmVwbGFjaW5nIGFuIHVybCB3aXRoIHRoZQoJCQkvLyBzYW1lIHVybC4gV2UgZG8gdGhpcyBhbnl3YXlzIGJlY2F1c2Ugd2UgbmVlZCB0byBtYWtlIHN1cmUgdGhhdAoJCQkvLyBhbGwgb2Ygb3VyIGhpc3RvcnkgZW50cmllcyBoYXZlIGEgc3RhdGUgb2JqZWN0IGFzc29jaWF0ZWQgd2l0aAoJCQkvLyB0aGVtLiBUaGlzIGFsbG93cyB1cyB0byB3b3JrIGFyb3VuZCB0aGUgY2FzZSB3aGVyZSAkLm1vYmlsZS5iYWNrKCkKCQkJLy8gaXMgY2FsbGVkIHRvIHRyYW5zaXRpb24gZnJvbSBhbiBleHRlcm5hbCBwYWdlIHRvIGFuIGVtYmVkZGVkIHBhZ2UuCgkJCS8vIEluIHRoYXQgcGFydGljdWxhciBjYXNlLCBhIGhhc2hjaGFuZ2UgZXZlbnQgaXMgKk5PVCogZ2VuZXJhdGVkIGJ5IHRoZSBicm93c2VyLgoJCQkvLyBFbnN1cmluZyBlYWNoIGhpc3RvcnkgZW50cnkgaGFzIGEgc3RhdGUgb2JqZWN0IG1lYW5zIHRoYXQgb25Qb3BTdGF0ZSgpCgkJCS8vIHdpbGwgYWx3YXlzIHRyaWdnZXIgb3VyIGhhc2hjaGFuZ2UgY2FsbGJhY2sgZXZlbiB3aGVuIGEgaGFzaGNoYW5nZSBldmVudAoJCQkvLyBpcyBub3QgZmlyZWQuCgkJCWhpc3RvcnkucmVwbGFjZVN0YXRlKCBzdGF0ZSwgZG9jdW1lbnQudGl0bGUsIGhyZWYgKTsKCQl9LAoKCQkvLyBvbiBwb3BzdGF0ZSAoaWUgYmFjayBvciBmb3J3YXJkKSB3ZSBuZWVkIHRvIHJlcGxhY2UgdGhlIGhhc2ggdGhhdCB3YXMgdGhlcmUgcHJldmlvdXNseQoJCS8vIGNsZWFuZWQgdXAgYnkgdGhlIGFkZGl0aW9uYWwgaGFzaCBoYW5kbGluZwoJCW9uUG9wU3RhdGU6IGZ1bmN0aW9uKCBlICkgewoJCQl2YXIgcG9wcGVkU3RhdGUgPSBlLm9yaWdpbmFsRXZlbnQuc3RhdGUsCgkJCQlmcm9tSGFzaCwgdG9IYXNoLCBoYXNoQ2hhbmdlZDsKCgkJCS8vIGlmIHRoZXJlJ3Mgbm8gc3RhdGUgaXRzIG5vdCBhIHBvcHN0YXRlIHdlIGNhcmUgYWJvdXQsIGVnIGNocm9tZSdzIGluaXRpYWwgcG9wc3RhdGUKCQkJaWYgKCBwb3BwZWRTdGF0ZSApIHsKCQkJCS8vIGlmIHdlIGdldCB0d28gcG9wIHN0YXRlcyBpbiB1bmRlciB0aGlzLmhhc2hDaGFuZ2VUaW1lb3V0CgkJCQkvLyBtYWtlIHN1cmUgdG8gY2xlYXIgYW55IHRpbWVyIHNldCBmb3IgdGhlIHByZXZpb3VzIGNoYW5nZQoJCQkJY2xlYXJUaW1lb3V0KCBzZWxmLmhhc2hDaGFuZ2VFbmFibGVUaW1lciApOwoKCQkJCS8vIG1ha2Ugc3VyZSB0byBlbmFibGUgaGFzaCBoYW5kbGluZyBmb3IgdGhlIHRoZSBfaGFuZGxlSGFzaENoYW5nZSBjYWxsCgkJCQlzZWxmLm5leHRIYXNoQ2hhbmdlUHJldmVudGVkKCBmYWxzZSApOwoKCQkJCS8vIGNoYW5nZSB0aGUgcGFnZSBiYXNlZCBvbiB0aGUgaGFzaCBpbiB0aGUgcG9wcGVkIHN0YXRlCgkJCQkkLm1vYmlsZS5faGFuZGxlSGFzaENoYW5nZSggcG9wcGVkU3RhdGUuaGFzaCApOwoKCQkJCS8vIHByZXZlbnQgYW55IGhhc2hjaGFuZ2UgaW4gdGhlIG5leHQgc2VsZi5oYXNoQ2hhbmdlVGltZW91dAoJCQkJc2VsZi5uZXh0SGFzaENoYW5nZVByZXZlbnRlZCggdHJ1ZSApOwoKCQkJCS8vIHJlLWVuYWJsZSBoYXNoIGNoYW5nZSBoYW5kbGluZyBhZnRlciBzd2FsbG93aW5nIGEgcG9zc2libGUgaGFzaAoJCQkJLy8gY2hhbmdlIGV2ZW50IHRoYXQgY29tZXMgb24gYWxsIHBvcHN0YXRlcyBjb3VydGVzeSBvZiBicm93c2VycyBsaWtlIEFuZHJvaWQKCQkJCXNlbGYuaGFzaENoYW5nZUVuYWJsZVRpbWVyID0gc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQkJc2VsZi5uZXh0SGFzaENoYW5nZVByZXZlbnRlZCggZmFsc2UgKTsKCQkJCX0sIHNlbGYuaGFzaENoYW5nZVRpbWVvdXQgKTsKCQkJfQoJCX0sCgoJCWluaXQ6IGZ1bmN0aW9uKCkgewoJCQkkd2luLmJpbmQoICJoYXNoY2hhbmdlIiwgc2VsZi5vbkhhc2hDaGFuZ2UgKTsKCgkJCS8vIEhhbmRsZSBwb3BzdGF0ZSBldmVudHMgdGhlIG9jY3VyIHRocm91Z2ggaGlzdG9yeSBjaGFuZ2VzCgkJCSR3aW4uYmluZCggInBvcHN0YXRlIiwgc2VsZi5vblBvcFN0YXRlICk7CgoJCQkvLyBpZiB0aGVyZSdzIG5vIGhhc2gsIHdlIG5lZWQgdG8gcmVwbGFjZXN0YXRlIGZvciByZXR1cm5pbmcgdG8gaG9tZQoJCQlpZiAoIGxvY2F0aW9uLmhhc2ggPT09ICIiICkgewoJCQkJaGlzdG9yeS5yZXBsYWNlU3RhdGUoIHNlbGYuc3RhdGUoKSwgZG9jdW1lbnQudGl0bGUsICQubW9iaWxlLnBhdGguZ2V0TG9jYXRpb24oKSApOwoJCQl9CgkJfQoJfSk7CgoJLy8gV2UgbmVlZCB0byBpbml0IHdoZW4gIm1vYmlsZWluaXQiLCAiZG9tcmVhZHkiLCBhbmQgIm5hdnJlYWR5IiBoYXZlIGFsbCBoYXBwZW5lZAoJJC53aGVuKCBkb21yZWFkeURlZmVycmVkLCBtb2JpbGVpbml0RGVmZXJyZWQsICQubW9iaWxlLm5hdnJlYWR5RGVmZXJyZWQgKS5kb25lKGZ1bmN0aW9uKCkgewoJCWlmICggJC5tb2JpbGUucHVzaFN0YXRlRW5hYmxlZCAmJiAkLnN1cHBvcnQucHVzaFN0YXRlICkgewoJCQlwdXNoU3RhdGVIYW5kbGVyLmluaXQoKTsKCQl9Cgl9KTsKfSkoIGpRdWVyeSwgdGhpcyApOwoKLyoKKiBmYWxsYmFjayB0cmFuc2l0aW9uIGZvciBmbGlwIGluIG5vbi0zRCBzdXBwb3J0aW5nIGJyb3dzZXJzICh3aGljaCB0ZW5kIHRvIGhhbmRsZSBjb21wbGV4IHRyYW5zaXRpb25zIHBvb3JseSBpbiBnZW5lcmFsCiovCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrcy5mbGlwID0gImZhZGUiOwoKfSkoIGpRdWVyeSwgdGhpcyApOwovKgoqIGZhbGxiYWNrIHRyYW5zaXRpb24gZm9yIGZsb3cgaW4gbm9uLTNEIHN1cHBvcnRpbmcgYnJvd3NlcnMgKHdoaWNoIHRlbmQgdG8gaGFuZGxlIGNvbXBsZXggdHJhbnNpdGlvbnMgcG9vcmx5IGluIGdlbmVyYWwKKi8KCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS50cmFuc2l0aW9uRmFsbGJhY2tzLmZsb3cgPSAiZmFkZSI7Cgp9KSggalF1ZXJ5LCB0aGlzICk7Ci8qCiogZmFsbGJhY2sgdHJhbnNpdGlvbiBmb3IgcG9wIGluIG5vbi0zRCBzdXBwb3J0aW5nIGJyb3dzZXJzICh3aGljaCB0ZW5kIHRvIGhhbmRsZSBjb21wbGV4IHRyYW5zaXRpb25zIHBvb3JseSBpbiBnZW5lcmFsCiovCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrcy5wb3AgPSAiZmFkZSI7Cgp9KSggalF1ZXJ5LCB0aGlzICk7Ci8qCiogZmFsbGJhY2sgdHJhbnNpdGlvbiBmb3Igc2xpZGUgaW4gbm9uLTNEIHN1cHBvcnRpbmcgYnJvd3NlcnMgKHdoaWNoIHRlbmQgdG8gaGFuZGxlIGNvbXBsZXggdHJhbnNpdGlvbnMgcG9vcmx5IGluIGdlbmVyYWwKKi8KCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgovLyBVc2UgdGhlIHNpbXVsdGFuZW91cyB0cmFuc2l0aW9ucyBoYW5kbGVyIGZvciBzbGlkZSB0cmFuc2l0aW9ucwokLm1vYmlsZS50cmFuc2l0aW9uSGFuZGxlcnMuc2xpZGUgPSAkLm1vYmlsZS50cmFuc2l0aW9uSGFuZGxlcnMuc2ltdWx0YW5lb3VzOwoKLy8gU2V0IHRoZSBzbGlkZSB0cmFuc2l0aW9ucydzIGZhbGxiYWNrIHRvICJmYWRlIgokLm1vYmlsZS50cmFuc2l0aW9uRmFsbGJhY2tzLnNsaWRlID0gImZhZGUiOwoKfSkoIGpRdWVyeSwgdGhpcyApOwovKgoqIGZhbGxiYWNrIHRyYW5zaXRpb24gZm9yIHNsaWRlZG93biBpbiBub24tM0Qgc3VwcG9ydGluZyBicm93c2VycyAod2hpY2ggdGVuZCB0byBoYW5kbGUgY29tcGxleCB0cmFuc2l0aW9ucyBwb29ybHkgaW4gZ2VuZXJhbAoqLwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLnRyYW5zaXRpb25GYWxsYmFja3Muc2xpZGVkb3duID0gImZhZGUiOwoKfSkoIGpRdWVyeSwgdGhpcyApOwovKgoqIGZhbGxiYWNrIHRyYW5zaXRpb24gZm9yIHNsaWRlZmFkZSBpbiBub24tM0Qgc3VwcG9ydGluZyBicm93c2VycyAod2hpY2ggdGVuZCB0byBoYW5kbGUgY29tcGxleCB0cmFuc2l0aW9ucyBwb29ybHkgaW4gZ2VuZXJhbAoqLwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCi8vIFNldCB0aGUgc2xpZGUgdHJhbnNpdGlvbnMncyBmYWxsYmFjayB0byAiZmFkZSIKJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrcy5zbGlkZWZhZGUgPSAiZmFkZSI7Cgp9KSggalF1ZXJ5LCB0aGlzICk7Ci8qCiogZmFsbGJhY2sgdHJhbnNpdGlvbiBmb3Igc2xpZGV1cCBpbiBub24tM0Qgc3VwcG9ydGluZyBicm93c2VycyAod2hpY2ggdGVuZCB0byBoYW5kbGUgY29tcGxleCB0cmFuc2l0aW9ucyBwb29ybHkgaW4gZ2VuZXJhbAoqLwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLnRyYW5zaXRpb25GYWxsYmFja3Muc2xpZGV1cCA9ICJmYWRlIjsKCn0pKCBqUXVlcnksIHRoaXMgKTsKLyoKKiBmYWxsYmFjayB0cmFuc2l0aW9uIGZvciB0dXJuIGluIG5vbi0zRCBzdXBwb3J0aW5nIGJyb3dzZXJzICh3aGljaCB0ZW5kIHRvIGhhbmRsZSBjb21wbGV4IHRyYW5zaXRpb25zIHBvb3JseSBpbiBnZW5lcmFsCiovCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrcy50dXJuID0gImZhZGUiOwoKfSkoIGpRdWVyeSwgdGhpcyApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS5wYWdlLnByb3RvdHlwZS5vcHRpb25zLmRlZ3JhZGVJbnB1dHMgPSB7Cgljb2xvcjogZmFsc2UsCglkYXRlOiBmYWxzZSwKCWRhdGV0aW1lOiBmYWxzZSwKCSJkYXRldGltZS1sb2NhbCI6IGZhbHNlLAoJZW1haWw6IGZhbHNlLAoJbW9udGg6IGZhbHNlLAoJbnVtYmVyOiBmYWxzZSwKCXJhbmdlOiAibnVtYmVyIiwKCXNlYXJjaDogInRleHQiLAoJdGVsOiBmYWxzZSwKCXRpbWU6IGZhbHNlLAoJdXJsOiBmYWxzZSwKCXdlZWs6IGZhbHNlCn07CgoKLy9hdXRvIHNlbGYtaW5pdCB3aWRnZXRzCiQoIGRvY3VtZW50ICkuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKSB7CgoJdmFyIHBhZ2UgPSAkLm1vYmlsZS5jbG9zZXN0UGFnZURhdGEoICQoIGUudGFyZ2V0ICkgKSwgb3B0aW9uczsKCglpZiAoICFwYWdlICkgewoJCXJldHVybjsKCX0KCglvcHRpb25zID0gcGFnZS5vcHRpb25zOwoKCS8vIGRlZ3JhZGUgaW5wdXRzIHRvIGF2b2lkIHBvb3JseSBpbXBsZW1lbnRlZCBuYXRpdmUgZnVuY3Rpb25hbGl0eQoJJCggZS50YXJnZXQgKS5maW5kKCAiaW5wdXQiICkubm90KCBwYWdlLmtlZXBOYXRpdmVTZWxlY3RvcigpICkuZWFjaChmdW5jdGlvbigpIHsKCQl2YXIgJHRoaXMgPSAkKCB0aGlzICksCgkJCXR5cGUgPSB0aGlzLmdldEF0dHJpYnV0ZSggInR5cGUiICksCgkJCW9wdFR5cGUgPSBvcHRpb25zLmRlZ3JhZGVJbnB1dHNbIHR5cGUgXSB8fCAidGV4dCI7CgoJCWlmICggb3B0aW9ucy5kZWdyYWRlSW5wdXRzWyB0eXBlIF0gKSB7CgkJCXZhciBodG1sID0gJCggIjxkaXY+IiApLmh0bWwoICR0aGlzLmNsb25lKCkgKS5odG1sKCksCgkJCQkvLyBJbiBJRSBicm93c2VycywgdGhlIHR5cGUgc29tZXRpbWVzIGRvZXNuJ3QgZXhpc3QgaW4gdGhlIGNsb25lZCBtYXJrdXAsIHNvIHdlIHJlcGxhY2UgdGhlIGNsb3NpbmcgdGFnIGluc3RlYWQKCQkJCWhhc1R5cGUgPSBodG1sLmluZGV4T2YoICIgdHlwZT0iICkgPiAtMSwKCQkJCWZpbmRzdHIgPSBoYXNUeXBlID8gL1xzK3R5cGU9WyInXT9cdytbJyJdPy8gOiAvXC8/Pi8sCgkJCQlyZXBzdHIgPSAiIHR5cGU9XCIiICsgb3B0VHlwZSArICJcIiBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJ0eXBlPVwiIiArIHR5cGUgKyAiXCIiICsgKCBoYXNUeXBlID8gIiIgOiAiPiIgKTsKCgkJCSR0aGlzLnJlcGxhY2VXaXRoKCBodG1sLnJlcGxhY2UoIGZpbmRzdHIsIHJlcHN0ciApICk7CgkJfQoJfSk7Cgp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS5kaWFsb2ciLCAkLm1vYmlsZS53aWRnZXQsIHsKCW9wdGlvbnM6IHsKCQljbG9zZUJ0blRleHQ6ICJDbG9zZSIsCgkJb3ZlcmxheVRoZW1lOiAiYSIsCgkJaW5pdFNlbGVjdG9yOiAiOmpxbURhdGEocm9sZT0nZGlhbG9nJykiCgl9LAoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzLAoJCQkkZWwgPSB0aGlzLmVsZW1lbnQsCgkJCWhlYWRlckNsb3NlQnV0dG9uID0gJCggIjxhIGhyZWY9JyMnIGRhdGEtIiArICQubW9iaWxlLm5zICsgImljb249J2RlbGV0ZScgZGF0YS0iICsgJC5tb2JpbGUubnMgKyAiaWNvbnBvcz0nbm90ZXh0Jz4iKyB0aGlzLm9wdGlvbnMuY2xvc2VCdG5UZXh0ICsgIjwvYT4iICksCgkJCWRpYWxvZ1dyYXAgPSAkKCAiPGRpdi8+IiwgewoJCQkJCSJyb2xlIiA6ICJkaWFsb2ciLAoJCQkJCSJjbGFzcyIgOiAidWktZGlhbG9nLWNvbnRhaW4gdWktY29ybmVyLWFsbCB1aS1vdmVybGF5LXNoYWRvdyIKCQkJCX0pOwoKCQkkZWwuYWRkQ2xhc3MoICJ1aS1kaWFsb2cgdWktb3ZlcmxheS0iICsgdGhpcy5vcHRpb25zLm92ZXJsYXlUaGVtZSApOwoKCQkvLyBDbGFzcyB0aGUgbWFya3VwIGZvciBkaWFsb2cgc3R5bGluZwoJCS8vIFNldCBhcmlhIHJvbGUKCQkkZWwKCQkJLndyYXBJbm5lciggZGlhbG9nV3JhcCApCgkJCS5jaGlsZHJlbigpCgkJCQkuZmluZCggIjpqcW1EYXRhKHJvbGU9J2hlYWRlcicpIiApCgkJCQkJLnByZXBlbmQoIGhlYWRlckNsb3NlQnV0dG9uICkKCQkJCS5lbmQoKQoJCQkJLmNoaWxkcmVuKCAnOmZpcnN0LWNoaWxkJykKCQkJCQkuYWRkQ2xhc3MoICJ1aS1jb3JuZXItdG9wIiApCgkJCQkuZW5kKCkKCQkJCS5jaGlsZHJlbiggIjpsYXN0LWNoaWxkIiApCgkJCQkJLmFkZENsYXNzKCAidWktY29ybmVyLWJvdHRvbSIgKTsKCgkJLy8gdGhpcyBtdXN0IGJlIGFuIGFub255bW91cyBmdW5jdGlvbiBzbyB0aGF0IHNlbGVjdCBtZW51IGRpYWxvZ3MgY2FuIHJlcGxhY2UKCQkvLyB0aGUgY2xvc2UgbWV0aG9kLiBUaGlzIGlzIGEgY2hhbmdlIGZyb20gcHJldmlvdXNseSBqdXN0IGRlZmluaW5nIGRhdGEtcmVsPWJhY2sKCQkvLyBvbiB0aGUgYnV0dG9uIGFuZCBsZXR0aW5nIG5hdiBoYW5kbGUgaXQKCQkvLwoJCS8vIFVzZSBjbGljayByYXRoZXIgdGhhbiB2Y2xpY2sgaW4gb3JkZXIgdG8gcHJldmVudCB0aGUgcG9zc2liaWxpdHkgb2YgdW5pbnRlbnRpb25hbGx5CgkJLy8gcmVvcGVuaW5nIHRoZSBkaWFsb2cgaWYgdGhlIGRpYWxvZyBvcGVuaW5nIGl0ZW0gd2FzIGRpcmVjdGx5IHVuZGVyIHRoZSBjbG9zZSBidXR0b24uCgkJaGVhZGVyQ2xvc2VCdXR0b24uYmluZCggImNsaWNrIiwgZnVuY3Rpb24oKSB7CgkJCXNlbGYuY2xvc2UoKTsKCQl9KTsKCgkJLyogYmluZCBldmVudHMKCQkJLSBjbGlja3MgYW5kIHN1Ym1pdHMgc2hvdWxkIHVzZSB0aGUgY2xvc2luZyB0cmFuc2l0aW9uIHRoYXQgdGhlIGRpYWxvZyBvcGVuZWQgd2l0aAoJCQkJdW5sZXNzIGEgZGF0YS10cmFuc2l0aW9uIGlzIHNwZWNpZmllZCBvbiB0aGUgbGluay9mb3JtCgkJCS0gaWYgdGhlIGNsaWNrIHdhcyBvbiB0aGUgY2xvc2UgYnV0dG9uLCBvciB0aGUgbGluayBoYXMgYSBkYXRhLXJlbD0iYmFjayIgaXQnbGwgZ28gYmFjayBpbiBoaXN0b3J5IG5hdHVyYWxseQoJCSovCgkJJGVsLmJpbmQoICJ2Y2xpY2sgc3VibWl0IiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQl2YXIgJHRhcmdldCA9ICQoIGV2ZW50LnRhcmdldCApLmNsb3Nlc3QoIGV2ZW50LnR5cGUgPT09ICJ2Y2xpY2siID8gImEiIDogImZvcm0iICksCgkJCQlhY3RpdmU7CgoJCQlpZiAoICR0YXJnZXQubGVuZ3RoICYmICEkdGFyZ2V0LmpxbURhdGEoICJ0cmFuc2l0aW9uIiApICkgewoKCQkJCWFjdGl2ZSA9ICQubW9iaWxlLnVybEhpc3RvcnkuZ2V0QWN0aXZlKCkgfHwge307CgoJCQkJJHRhcmdldC5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidHJhbnNpdGlvbiIsICggYWN0aXZlLnRyYW5zaXRpb24gfHwgJC5tb2JpbGUuZGVmYXVsdERpYWxvZ1RyYW5zaXRpb24gKSApCgkJCQkJLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJkaXJlY3Rpb24iLCAicmV2ZXJzZSIgKTsKCQkJfQoJCX0pCgkJLmJpbmQoICJwYWdlaGlkZSIsIGZ1bmN0aW9uKCBlLCB1aSApIHsKCQkJJCggdGhpcyApLmZpbmQoICIuIiArICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICkubm90KCAiLnVpLXNsaWRlci1iZyIgKS5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQl9KQoJCS8vIE92ZXJyaWRlIHRoZSB0aGVtZSBzZXQgYnkgdGhlIHBhZ2UgcGx1Z2luIG9uIHBhZ2VzaG93CgkJLmJpbmQoICJwYWdlYmVmb3Jlc2hvdyIsIGZ1bmN0aW9uKCkgewoJCQlzZWxmLl9pc0Nsb3NlYWJsZSA9IHRydWU7CgkJCWlmICggc2VsZi5vcHRpb25zLm92ZXJsYXlUaGVtZSApIHsKCQkJCXNlbGYuZWxlbWVudAoJCQkJCS5wYWdlKCAicmVtb3ZlQ29udGFpbmVyQmFja2dyb3VuZCIgKQoJCQkJCS5wYWdlKCAic2V0Q29udGFpbmVyQmFja2dyb3VuZCIsIHNlbGYub3B0aW9ucy5vdmVybGF5VGhlbWUgKTsKCQkJfQoJCX0pOwoJfSwKCgkvLyBDbG9zZSBtZXRob2QgZ29lcyBiYWNrIGluIGhpc3RvcnkKCWNsb3NlOiBmdW5jdGlvbigpIHsKCQl2YXIgZHN0OwoKCQlpZiAoIHRoaXMuX2lzQ2xvc2VhYmxlICkgewoJCQl0aGlzLl9pc0Nsb3NlYWJsZSA9IGZhbHNlOwoJCQlpZiAoICQubW9iaWxlLmhhc2hMaXN0ZW5pbmdFbmFibGVkICkgewoJCQkJJC5tb2JpbGUuYmFjaygpOwoJCQl9IGVsc2UgewoJCQkJZHN0ID0gJC5tb2JpbGUudXJsSGlzdG9yeS5nZXRQcmV2KCkudXJsOwoJCQkJaWYgKCAhJC5tb2JpbGUucGF0aC5pc1BhdGgoIGRzdCApICkgewoJCQkJCWRzdCA9ICQubW9iaWxlLnBhdGgubWFrZVVybEFic29sdXRlKCAiIyIgKyBkc3QgKTsKCQkJCX0KCgkJCQkkLm1vYmlsZS5jaGFuZ2VQYWdlKCBkc3QsIHsgY2hhbmdlSGFzaDogZmFsc2UsIGZyb21IYXNoQ2hhbmdlOiB0cnVlIH0gKTsKCQkJfQoJCX0KCX0KfSk7CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJCggZG9jdW1lbnQgKS5kZWxlZ2F0ZSggJC5tb2JpbGUuZGlhbG9nLnByb3RvdHlwZS5vcHRpb25zLmluaXRTZWxlY3RvciwgInBhZ2VjcmVhdGUiLCBmdW5jdGlvbigpIHsKCSQubW9iaWxlLmRpYWxvZy5wcm90b3R5cGUuZW5oYW5jZSggdGhpcyApOwp9KTsKCn0pKCBqUXVlcnksIHRoaXMgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUucGFnZS5wcm90b3R5cGUub3B0aW9ucy5iYWNrQnRuVGV4dCAgPSAiQmFjayI7CiQubW9iaWxlLnBhZ2UucHJvdG90eXBlLm9wdGlvbnMuYWRkQmFja0J0biAgID0gZmFsc2U7CiQubW9iaWxlLnBhZ2UucHJvdG90eXBlLm9wdGlvbnMuYmFja0J0blRoZW1lID0gbnVsbDsKJC5tb2JpbGUucGFnZS5wcm90b3R5cGUub3B0aW9ucy5oZWFkZXJUaGVtZSAgPSAiYSI7CiQubW9iaWxlLnBhZ2UucHJvdG90eXBlLm9wdGlvbnMuZm9vdGVyVGhlbWUgID0gImEiOwokLm1vYmlsZS5wYWdlLnByb3RvdHlwZS5vcHRpb25zLmNvbnRlbnRUaGVtZSA9IG51bGw7CgovLyBOT1RFIGJpbmQgdXNlZCB0byBmb3JjZSB0aGlzIGJpbmRpbmcgdG8gcnVuIGJlZm9yZSB0aGUgYnV0dG9uTWFya3VwIGJpbmRpbmcKLy8gICAgICB3aGljaCBleHBlY3RzIC51aS1mb290ZXIgdG9wIGJlIGFwcGxpZWQgaW4gaXRzIGdpZ2FudGljIHNlbGVjdG9yCi8vIFRPRE8gcmVtb3ZlIHRoZSBidXR0b25NYXJrdXAgZ2lhbnQgc2VsZWN0b3IgYW5kIG1vdmUgaXQgdG8gdGhlIHZhcmlvdXMgbW9kdWxlcwovLyAgICAgIG9uIHdoaWNoIGl0IGRlcGVuZHMKJCggZG9jdW1lbnQgKS5iaW5kKCAicGFnZWNyZWF0ZSIsIGZ1bmN0aW9uKCBlICkgewoJdmFyICRwYWdlID0gJCggZS50YXJnZXQgKSwKCQlvID0gJHBhZ2UuZGF0YSggInBhZ2UiICkub3B0aW9ucywKCQlwYWdlUm9sZSA9ICRwYWdlLmpxbURhdGEoICJyb2xlIiApLAoJCXBhZ2VUaGVtZSA9IG8udGhlbWU7CgoJJCggIjpqcW1EYXRhKHJvbGU9J2hlYWRlcicpLCA6anFtRGF0YShyb2xlPSdmb290ZXInKSwgOmpxbURhdGEocm9sZT0nY29udGVudCcpIiwgJHBhZ2UgKQoJCS5qcW1FbmhhbmNlYWJsZSgpCgkJLmVhY2goZnVuY3Rpb24oKSB7CgoJCXZhciAkdGhpcyA9ICQoIHRoaXMgKSwKCQkJcm9sZSA9ICR0aGlzLmpxbURhdGEoICJyb2xlIiApLAoJCQl0aGVtZSA9ICR0aGlzLmpxbURhdGEoICJ0aGVtZSIgKSwKCQkJY29udGVudFRoZW1lID0gdGhlbWUgfHwgby5jb250ZW50VGhlbWUgfHwgKCBwYWdlUm9sZSA9PT0gImRpYWxvZyIgJiYgcGFnZVRoZW1lICksCgkJCSRoZWFkZXJhbmNob3JzLAoJCQlsZWZ0YnRuLAoJCQlyaWdodGJ0biwKCQkJYmFja0J0bjsKCgkJJHRoaXMuYWRkQ2xhc3MoICJ1aS0iICsgcm9sZSApOwoKCQkvL2FwcGx5IHRoZW1pbmcgYW5kIG1hcmt1cCBtb2RpZmljYXRpb25zIHRvIHBhZ2UsaGVhZGVyLGNvbnRlbnQsZm9vdGVyCgkJaWYgKCByb2xlID09PSAiaGVhZGVyIiB8fCByb2xlID09PSAiZm9vdGVyIiApIHsKCgkJCXZhciB0aGlzVGhlbWUgPSB0aGVtZSB8fCAoIHJvbGUgPT09ICJoZWFkZXIiID8gby5oZWFkZXJUaGVtZSA6IG8uZm9vdGVyVGhlbWUgKSB8fCBwYWdlVGhlbWU7CgoJCQkkdGhpcwoJCQkJLy9hZGQgdGhlbWUgY2xhc3MKCQkJCS5hZGRDbGFzcyggInVpLWJhci0iICsgdGhpc1RoZW1lICkKCQkJCS8vIEFkZCBBUklBIHJvbGUKCQkJCS5hdHRyKCAicm9sZSIsIHJvbGUgPT09ICJoZWFkZXIiID8gImJhbm5lciIgOiAiY29udGVudGluZm8iICk7CgoJCQlpZiAoIHJvbGUgPT09ICJoZWFkZXIiKSB7CgkJCQkvLyBSaWdodCxsZWZ0IGJ1dHRvbnMKCQkJCSRoZWFkZXJhbmNob3JzCT0gJHRoaXMuY2hpbGRyZW4oICJhLCBidXR0b24iICk7CgkJCQlsZWZ0YnRuCT0gJGhlYWRlcmFuY2hvcnMuaGFzQ2xhc3MoICJ1aS1idG4tbGVmdCIgKTsKCQkJCXJpZ2h0YnRuID0gJGhlYWRlcmFuY2hvcnMuaGFzQ2xhc3MoICJ1aS1idG4tcmlnaHQiICk7CgoJCQkJbGVmdGJ0biA9IGxlZnRidG4gfHwgJGhlYWRlcmFuY2hvcnMuZXEoIDAgKS5ub3QoICIudWktYnRuLXJpZ2h0IiApLmFkZENsYXNzKCAidWktYnRuLWxlZnQiICkubGVuZ3RoOwoKCQkJCXJpZ2h0YnRuID0gcmlnaHRidG4gfHwgJGhlYWRlcmFuY2hvcnMuZXEoIDEgKS5hZGRDbGFzcyggInVpLWJ0bi1yaWdodCIgKS5sZW5ndGg7CgkJCX0KCgkJCS8vIEF1dG8tYWRkIGJhY2sgYnRuIG9uIHBhZ2VzIGJleW9uZCBmaXJzdCB2aWV3CgkJCWlmICggby5hZGRCYWNrQnRuICYmCgkJCQlyb2xlID09PSAiaGVhZGVyIiAmJgoJCQkJJCggIi51aS1wYWdlIiApLmxlbmd0aCA+IDEgJiYKCQkJCSRwYWdlLmpxbURhdGEoICJ1cmwiICkgIT09ICQubW9iaWxlLnBhdGguc3RyaXBIYXNoKCBsb2NhdGlvbi5oYXNoICkgJiYKCQkJCSFsZWZ0YnRuICkgewoKCQkJCWJhY2tCdG4gPSAkKCAiPGEgaHJlZj0namF2YXNjcmlwdDp2b2lkKDApOycgY2xhc3M9J3VpLWJ0bi1sZWZ0JyBkYXRhLSIrICQubW9iaWxlLm5zICsicmVsPSdiYWNrJyBkYXRhLSIrICQubW9iaWxlLm5zICsiaWNvbj0nYXJyb3ctbCc+Iisgby5iYWNrQnRuVGV4dCArIjwvYT4iICkKCQkJCQkvLyBJZiB0aGVtZSBpcyBwcm92aWRlZCwgb3ZlcnJpZGUgZGVmYXVsdCBpbmhlcml0YW5jZQoJCQkJCS5hdHRyKCAiZGF0YS0iKyAkLm1vYmlsZS5ucyArInRoZW1lIiwgby5iYWNrQnRuVGhlbWUgfHwgdGhpc1RoZW1lICkKCQkJCQkucHJlcGVuZFRvKCAkdGhpcyApOwoJCQl9CgoJCQkvLyBQYWdlIHRpdGxlCgkJCSR0aGlzLmNoaWxkcmVuKCAiaDEsIGgyLCBoMywgaDQsIGg1LCBoNiIgKQoJCQkJLmFkZENsYXNzKCAidWktdGl0bGUiICkKCQkJCS8vIFJlZ2FyZGxlc3Mgb2YgaCBlbGVtZW50IG51bWJlciBpbiBzcmMsIGl0IGJlY29tZXMgaDEgZm9yIHRoZSBlbmhhbmNlZCBwYWdlCgkJCQkuYXR0cih7CgkJCQkJInJvbGUiOiAiaGVhZGluZyIsCgkJCQkJImFyaWEtbGV2ZWwiOiAiMSIKCQkJCX0pOwoKCQl9IGVsc2UgaWYgKCByb2xlID09PSAiY29udGVudCIgKSB7CgkJCWlmICggY29udGVudFRoZW1lICkgewoJCQkJJHRoaXMuYWRkQ2xhc3MoICJ1aS1ib2R5LSIgKyAoIGNvbnRlbnRUaGVtZSApICk7CgkJCX0KCgkJCS8vIEFkZCBBUklBIHJvbGUKCQkJJHRoaXMuYXR0ciggInJvbGUiLCAibWFpbiIgKTsKCQl9Cgl9KTsKfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCi8vIGZpbHRlciBmdW5jdGlvbiByZW1vdmVzIHdoaXRlc3BhY2UgYmV0d2VlbiBsYWJlbCBhbmQgZm9ybSBlbGVtZW50IHNvIHdlIGNhbiB1c2UgaW5saW5lLWJsb2NrIChub2RlVHlwZSAzID0gdGV4dCkKJC5mbi5maWVsZGNvbnRhaW4gPSBmdW5jdGlvbiggb3B0aW9ucyApIHsKCXJldHVybiB0aGlzCgkJLmFkZENsYXNzKCAidWktZmllbGQtY29udGFpbiB1aS1ib2R5IHVpLWJyIiApCgkJLmNvbnRlbnRzKCkuZmlsdGVyKCBmdW5jdGlvbigpIHsKCQkJcmV0dXJuICggdGhpcy5ub2RlVHlwZSA9PT0gMyAmJiAhL1xTLy50ZXN0KCB0aGlzLm5vZGVWYWx1ZSApICk7CgkJfSkucmVtb3ZlKCk7Cn07CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJCggZG9jdW1lbnQgKS5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApIHsKCSQoICI6anFtRGF0YShyb2xlPSdmaWVsZGNvbnRhaW4nKSIsIGUudGFyZ2V0ICkuanFtRW5oYW5jZWFibGUoKS5maWVsZGNvbnRhaW4oKTsKfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQuZm4uZ3JpZCA9IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKCgkJdmFyICR0aGlzID0gJCggdGhpcyApLAoJCQlvID0gJC5leHRlbmQoewoJCQkJZ3JpZDogbnVsbAoJCQl9LCBvcHRpb25zICksCgkJCSRraWRzID0gJHRoaXMuY2hpbGRyZW4oKSwKCQkJZ3JpZENvbHMgPSB7IHNvbG86MSwgYToyLCBiOjMsIGM6NCwgZDo1IH0sCgkJCWdyaWQgPSBvLmdyaWQsCgkJCWl0ZXJhdG9yOwoKCQkJaWYgKCAhZ3JpZCApIHsKCQkJCWlmICggJGtpZHMubGVuZ3RoIDw9IDUgKSB7CgkJCQkJZm9yICggdmFyIGxldHRlciBpbiBncmlkQ29scyApIHsKCQkJCQkJaWYgKCBncmlkQ29sc1sgbGV0dGVyIF0gPT09ICRraWRzLmxlbmd0aCApIHsKCQkJCQkJCWdyaWQgPSBsZXR0ZXI7CgkJCQkJCX0KCQkJCQl9CgkJCQl9IGVsc2UgewoJCQkJCWdyaWQgPSAiYSI7CgkJCQkJJHRoaXMuYWRkQ2xhc3MoICJ1aS1ncmlkLWR1byIgKTsKCQkJCX0KCQkJfQoJCQlpdGVyYXRvciA9IGdyaWRDb2xzW2dyaWRdOwoKCQkkdGhpcy5hZGRDbGFzcyggInVpLWdyaWQtIiArIGdyaWQgKTsKCgkJJGtpZHMuZmlsdGVyKCAiOm50aC1jaGlsZCgiICsgaXRlcmF0b3IgKyAibisxKSIgKS5hZGRDbGFzcyggInVpLWJsb2NrLWEiICk7CgoJCWlmICggaXRlcmF0b3IgPiAxICkgewoJCQkka2lkcy5maWx0ZXIoICI6bnRoLWNoaWxkKCIgKyBpdGVyYXRvciArICJuKzIpIiApLmFkZENsYXNzKCAidWktYmxvY2stYiIgKTsKCQl9CgkJaWYgKCBpdGVyYXRvciA+IDIgKSB7CgkJCSRraWRzLmZpbHRlciggIjpudGgtY2hpbGQoIiArIGl0ZXJhdG9yICsgIm4rMykiICkuYWRkQ2xhc3MoICJ1aS1ibG9jay1jIiApOwoJCX0KCQlpZiAoIGl0ZXJhdG9yID4gMyApIHsKCQkJJGtpZHMuZmlsdGVyKCAiOm50aC1jaGlsZCgiICsgaXRlcmF0b3IgKyAibis0KSIgKS5hZGRDbGFzcyggInVpLWJsb2NrLWQiICk7CgkJfQoJCWlmICggaXRlcmF0b3IgPiA0ICkgewoJCQkka2lkcy5maWx0ZXIoICI6bnRoLWNoaWxkKCIgKyBpdGVyYXRvciArICJuKzUpIiApLmFkZENsYXNzKCAidWktYmxvY2stZSIgKTsKCQl9Cgl9KTsKfTsKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokKCBkb2N1bWVudCApLmJpbmQoICJwYWdlY3JlYXRlIGNyZWF0ZSIsIGZ1bmN0aW9uKCBlICkgewoJJCggIjpqcW1EYXRhKHJvbGU9J25vanMnKSIsIGUudGFyZ2V0ICkuYWRkQ2xhc3MoICJ1aS1ub2pzIiApOwoJCn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLmZuLmJ1dHRvbk1hcmt1cCA9IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJdmFyICR3b3JraW5nU2V0ID0gdGhpcywKCQltYXBUb0RhdGFBdHRyID0gZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CgkJCWUuc2V0QXR0cmlidXRlKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyBrZXksIHZhbHVlICk7CgkJCWVsLmpxbURhdGEoIGtleSwgdmFsdWUgKTsKCQl9OwoKCS8vIEVuZm9yY2Ugb3B0aW9ucyB0byBiZSBvZiB0eXBlIHN0cmluZwoJb3B0aW9ucyA9ICggb3B0aW9ucyAmJiAoICQudHlwZSggb3B0aW9ucyApID09PSAib2JqZWN0IiApICk/IG9wdGlvbnMgOiB7fTsKCWZvciAoIHZhciBpID0gMDsgaSA8ICR3b3JraW5nU2V0Lmxlbmd0aDsgaSsrICkgewoJCXZhciBlbCA9ICR3b3JraW5nU2V0LmVxKCBpICksCgkJCWUgPSBlbFsgMCBdLAoJCQlvID0gJC5leHRlbmQoIHt9LCAkLmZuLmJ1dHRvbk1hcmt1cC5kZWZhdWx0cywgewoJCQkJaWNvbjogICAgICAgb3B0aW9ucy5pY29uICAgICAgICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLmljb24gICAgICAgOiBlbC5qcW1EYXRhKCAiaWNvbiIgKSwKCQkJCWljb25wb3M6ICAgIG9wdGlvbnMuaWNvbnBvcyAgICAhPT0gdW5kZWZpbmVkID8gb3B0aW9ucy5pY29ucG9zICAgIDogZWwuanFtRGF0YSggImljb25wb3MiICksCgkJCQl0aGVtZTogICAgICBvcHRpb25zLnRoZW1lICAgICAgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMudGhlbWUgICAgICA6IGVsLmpxbURhdGEoICJ0aGVtZSIgKSB8fCAkLm1vYmlsZS5nZXRJbmhlcml0ZWRUaGVtZSggZWwsICJjIiApLAoJCQkJaW5saW5lOiAgICAgb3B0aW9ucy5pbmxpbmUgICAgICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLmlubGluZSAgICAgOiBlbC5qcW1EYXRhKCAiaW5saW5lIiApLAoJCQkJc2hhZG93OiAgICAgb3B0aW9ucy5zaGFkb3cgICAgICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLnNoYWRvdyAgICAgOiBlbC5qcW1EYXRhKCAic2hhZG93IiApLAoJCQkJY29ybmVyczogICAgb3B0aW9ucy5jb3JuZXJzICAgICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLmNvcm5lcnMgICAgOiBlbC5qcW1EYXRhKCAiY29ybmVycyIgKSwKCQkJCWljb25zaGFkb3c6IG9wdGlvbnMuaWNvbnNoYWRvdyAhPT0gdW5kZWZpbmVkID8gb3B0aW9ucy5pY29uc2hhZG93IDogZWwuanFtRGF0YSggImljb25zaGFkb3ciICksCgkJCQltaW5pOiAgICAgICBvcHRpb25zLm1pbmkgICAgICAgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMubWluaSAgICAgICA6IGVsLmpxbURhdGEoICJtaW5pIiApCgkJCX0sIG9wdGlvbnMgKSwKCgkJCS8vIENsYXNzZXMgRGVmaW5lZAoJCQlpbm5lckNsYXNzID0gInVpLWJ0bi1pbm5lciIsCgkJCXRleHRDbGFzcyA9ICJ1aS1idG4tdGV4dCIsCgkJCWJ1dHRvbkNsYXNzLCBpY29uQ2xhc3MsCgkJCS8vIEJ1dHRvbiBpbm5lciBtYXJrdXAKCQkJYnV0dG9uSW5uZXIsCgkJCWJ1dHRvblRleHQsCgkJCWJ1dHRvbkljb24sCgkJCWJ1dHRvbkVsZW1lbnRzOwoKCQkkLmVhY2goIG8sIG1hcFRvRGF0YUF0dHIgKTsKCgkJaWYgKCBlbC5qcW1EYXRhKCAicmVsIiApID09PSAicG9wdXAiICYmIGVsLmF0dHIoICJocmVmIiApICkgewoJCQllLnNldEF0dHJpYnV0ZSggImFyaWEtaGFzcG9wdXAiLCB0cnVlICk7CgkJCWUuc2V0QXR0cmlidXRlKCAiYXJpYS1vd25zIiwgZS5nZXRBdHRyaWJ1dGUoICJocmVmIiApICk7CgkJfQoKCQkvLyBDaGVjayBpZiB0aGlzIGVsZW1lbnQgaXMgYWxyZWFkeSBlbmhhbmNlZAoJCWJ1dHRvbkVsZW1lbnRzID0gJC5kYXRhKCAoICggZS50YWdOYW1lID09PSAiSU5QVVQiIHx8IGUudGFnTmFtZSA9PT0gIkJVVFRPTiIgKSA/IGUucGFyZW50Tm9kZSA6IGUgKSwgImJ1dHRvbkVsZW1lbnRzIiApOwoKCQlpZiAoIGJ1dHRvbkVsZW1lbnRzICkgewoJCQllID0gYnV0dG9uRWxlbWVudHMub3V0ZXI7CgkJCWVsID0gJCggZSApOwoJCQlidXR0b25Jbm5lciA9IGJ1dHRvbkVsZW1lbnRzLmlubmVyOwoJCQlidXR0b25UZXh0ID0gYnV0dG9uRWxlbWVudHMudGV4dDsKCQkJLy8gV2Ugd2lsbCByZWNyZWF0ZSB0aGlzIGljb24gYmVsb3cKCQkJJCggYnV0dG9uRWxlbWVudHMuaWNvbiApLnJlbW92ZSgpOwoJCQlidXR0b25FbGVtZW50cy5pY29uID0gbnVsbDsKCQl9CgkJZWxzZSB7CgkJCWJ1dHRvbklubmVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggby53cmFwcGVyRWxzICk7CgkJCWJ1dHRvblRleHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCBvLndyYXBwZXJFbHMgKTsKCQl9CgkJYnV0dG9uSWNvbiA9IG8uaWNvbiA/IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJzcGFuIiApIDogbnVsbDsKCgkJaWYgKCBhdHRhY2hFdmVudHMgJiYgIWJ1dHRvbkVsZW1lbnRzICkgewoJCQlhdHRhY2hFdmVudHMoKTsKCQl9CgoJCS8vIGlmIG5vdCwgdHJ5IHRvIGZpbmQgY2xvc2VzdCB0aGVtZSBjb250YWluZXIKCQlpZiAoICFvLnRoZW1lICkgewoJCQlvLnRoZW1lID0gJC5tb2JpbGUuZ2V0SW5oZXJpdGVkVGhlbWUoIGVsLCAiYyIgKTsKCQl9CgoJCWJ1dHRvbkNsYXNzID0gInVpLWJ0biB1aS1idG4tdXAtIiArIG8udGhlbWU7CgkJYnV0dG9uQ2xhc3MgKz0gby5zaGFkb3cgPyAiIHVpLXNoYWRvdyIgOiAiIjsKCQlidXR0b25DbGFzcyArPSBvLmNvcm5lcnMgPyAiIHVpLWJ0bi1jb3JuZXItYWxsIiA6ICIiOwoKCQlpZiAoIG8ubWluaSAhPT0gdW5kZWZpbmVkICkgewoJCQkvLyBVc2VkIHRvIGNvbnRyb2wgc3R5bGluZyBpbiBoZWFkZXJzL2Zvb3RlcnMsIHdoZXJlIGJ1dHRvbnMgZGVmYXVsdCB0byBgbWluaWAgc3R5bGUuCgkJCWJ1dHRvbkNsYXNzICs9IG8ubWluaSA9PT0gdHJ1ZSA/ICIgdWktbWluaSIgOiAiIHVpLWZ1bGxzaXplIjsKCQl9CgoJCWlmICggby5pbmxpbmUgIT09IHVuZGVmaW5lZCApIHsKCQkJLy8gVXNlZCB0byBjb250cm9sIHN0eWxpbmcgaW4gaGVhZGVycy9mb290ZXJzLCB3aGVyZSBidXR0b25zIGRlZmF1bHQgdG8gYGlubGluZWAgc3R5bGUuCgkJCWJ1dHRvbkNsYXNzICs9IG8uaW5saW5lID09PSB0cnVlID8gIiB1aS1idG4taW5saW5lIiA6ICIgdWktYnRuLWJsb2NrIjsKCQl9CgoJCWlmICggby5pY29uICkgewoJCQlvLmljb24gPSAidWktaWNvbi0iICsgby5pY29uOwoJCQlvLmljb25wb3MgPSBvLmljb25wb3MgfHwgImxlZnQiOwoKCQkJaWNvbkNsYXNzID0gInVpLWljb24gIiArIG8uaWNvbjsKCgkJCWlmICggby5pY29uc2hhZG93ICkgewoJCQkJaWNvbkNsYXNzICs9ICIgdWktaWNvbi1zaGFkb3ciOwoJCQl9CgkJfQoKCQlpZiAoIG8uaWNvbnBvcyApIHsKCQkJYnV0dG9uQ2xhc3MgKz0gIiB1aS1idG4taWNvbi0iICsgby5pY29ucG9zOwoKCQkJaWYgKCBvLmljb25wb3MgPT09ICJub3RleHQiICYmICFlbC5hdHRyKCAidGl0bGUiICkgKSB7CgkJCQllbC5hdHRyKCAidGl0bGUiLCBlbC5nZXRFbmNvZGVkVGV4dCgpICk7CgkJCX0KCQl9CgoJCWlubmVyQ2xhc3MgKz0gby5jb3JuZXJzID8gIiB1aS1idG4tY29ybmVyLWFsbCIgOiAiIjsKCgkJaWYgKCBvLmljb25wb3MgJiYgby5pY29ucG9zID09PSAibm90ZXh0IiAmJiAhZWwuYXR0ciggInRpdGxlIiApICkgewoJCQllbC5hdHRyKCAidGl0bGUiLCBlbC5nZXRFbmNvZGVkVGV4dCgpICk7CgkJfQoKCQlpZiAoIGJ1dHRvbkVsZW1lbnRzICkgewoJCQllbC5yZW1vdmVDbGFzcyggYnV0dG9uRWxlbWVudHMuYmNscyB8fCAiIiApOwoJCX0KCQllbC5yZW1vdmVDbGFzcyggInVpLWxpbmsiICkuYWRkQ2xhc3MoIGJ1dHRvbkNsYXNzICk7CgoJCWJ1dHRvbklubmVyLmNsYXNzTmFtZSA9IGlubmVyQ2xhc3M7CgoJCWJ1dHRvblRleHQuY2xhc3NOYW1lID0gdGV4dENsYXNzOwoJCWlmICggIWJ1dHRvbkVsZW1lbnRzICkgewoJCQlidXR0b25Jbm5lci5hcHBlbmRDaGlsZCggYnV0dG9uVGV4dCApOwoJCX0KCQlpZiAoIGJ1dHRvbkljb24gKSB7CgkJCWJ1dHRvbkljb24uY2xhc3NOYW1lID0gaWNvbkNsYXNzOwoJCQlpZiAoICEoIGJ1dHRvbkVsZW1lbnRzICYmIGJ1dHRvbkVsZW1lbnRzLmljb24gKSApIHsKCQkJCWJ1dHRvbkljb24uaW5uZXJIVE1MID0gIiYjMTYwOyI7CgkJCQlidXR0b25Jbm5lci5hcHBlbmRDaGlsZCggYnV0dG9uSWNvbiApOwoJCQl9CgkJfQoKCQl3aGlsZSAoIGUuZmlyc3RDaGlsZCAmJiAhYnV0dG9uRWxlbWVudHMgKSB7CgkJCWJ1dHRvblRleHQuYXBwZW5kQ2hpbGQoIGUuZmlyc3RDaGlsZCApOwoJCX0KCgkJaWYgKCAhYnV0dG9uRWxlbWVudHMgKSB7CgkJCWUuYXBwZW5kQ2hpbGQoIGJ1dHRvbklubmVyICk7CgkJfQoKCQkvLyBBc3NpZ24gYSBzdHJ1Y3R1cmUgY29udGFpbmluZyB0aGUgZWxlbWVudHMgb2YgdGhpcyBidXR0b24gdG8gdGhlIGVsZW1lbnRzIG9mIHRoaXMgYnV0dG9uLiBUaGlzCgkJLy8gd2lsbCBhbGxvdyB1cyB0byByZWNvZ25pemUgdGhpcyBhcyBhbiBhbHJlYWR5LWVuaGFuY2VkIGJ1dHRvbiBpbiBmdXR1cmUgY2FsbHMgdG8gYnV0dG9uTWFya3VwKCkuCgkJYnV0dG9uRWxlbWVudHMgPSB7CgkJCWJjbHMgIDogYnV0dG9uQ2xhc3MsCgkJCW91dGVyIDogZSwKCQkJaW5uZXIgOiBidXR0b25Jbm5lciwKCQkJdGV4dCAgOiBidXR0b25UZXh0LAoJCQlpY29uICA6IGJ1dHRvbkljb24KCQl9OwoKCQkkLmRhdGEoIGUsICAgICAgICAgICAnYnV0dG9uRWxlbWVudHMnLCBidXR0b25FbGVtZW50cyApOwoJCSQuZGF0YSggYnV0dG9uSW5uZXIsICdidXR0b25FbGVtZW50cycsIGJ1dHRvbkVsZW1lbnRzICk7CgkJJC5kYXRhKCBidXR0b25UZXh0LCAgJ2J1dHRvbkVsZW1lbnRzJywgYnV0dG9uRWxlbWVudHMgKTsKCQlpZiAoIGJ1dHRvbkljb24gKSB7CgkJCSQuZGF0YSggYnV0dG9uSWNvbiwgJ2J1dHRvbkVsZW1lbnRzJywgYnV0dG9uRWxlbWVudHMgKTsKCQl9Cgl9CgoJcmV0dXJuIHRoaXM7Cn07CgokLmZuLmJ1dHRvbk1hcmt1cC5kZWZhdWx0cyA9IHsKCWNvcm5lcnM6IHRydWUsCglzaGFkb3c6IHRydWUsCglpY29uc2hhZG93OiB0cnVlLAoJd3JhcHBlckVsczogInNwYW4iCn07CgpmdW5jdGlvbiBjbG9zZXN0RW5hYmxlZEJ1dHRvbiggZWxlbWVudCApIHsKICAgIHZhciBjbmFtZTsKCiAgICB3aGlsZSAoIGVsZW1lbnQgKSB7CgkJLy8gTm90ZSB0aGF0IHdlIGNoZWNrIGZvciB0eXBlb2YgY2xhc3NOYW1lIGJlbG93IGJlY2F1c2UgdGhlIGVsZW1lbnQgd2UKCQkvLyBoYW5kZWQgY291bGQgYmUgaW4gYW4gU1ZHIERPTSB3aGVyZSBjbGFzc05hbWUgb24gU1ZHIGVsZW1lbnRzIGlzIGRlZmluZWQgdG8KCQkvLyBiZSBvZiBhIGRpZmZlcmVudCB0eXBlIChTVkdBbmltYXRlZFN0cmluZykuIFdlIG9ubHkgb3BlcmF0ZSBvbiBIVE1MIERPTQoJCS8vIGVsZW1lbnRzLCBzbyB3ZSBsb29rIGZvciBwbGFpbiAic3RyaW5nIi4KICAgICAgICBjbmFtZSA9ICggdHlwZW9mIGVsZW1lbnQuY2xhc3NOYW1lID09PSAnc3RyaW5nJyApICYmICggZWxlbWVudC5jbGFzc05hbWUgKyAnICcgKTsKICAgICAgICBpZiAoIGNuYW1lICYmIGNuYW1lLmluZGV4T2YoICJ1aS1idG4gIiApID4gLTEgJiYgY25hbWUuaW5kZXhPZiggInVpLWRpc2FibGVkICIgKSA8IDAgKSB7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KCiAgICAgICAgZWxlbWVudCA9IGVsZW1lbnQucGFyZW50Tm9kZTsKICAgIH0KCiAgICByZXR1cm4gZWxlbWVudDsKfQoKdmFyIGF0dGFjaEV2ZW50cyA9IGZ1bmN0aW9uKCkgewoJdmFyIGhvdmVyRGVsYXkgPSAkLm1vYmlsZS5idXR0b25NYXJrdXAuaG92ZXJEZWxheSwgaG92LCBmb2M7CgoJJCggZG9jdW1lbnQgKS5iaW5kKCB7CgkJInZtb3VzZWRvd24gdm1vdXNlY2FuY2VsIHZtb3VzZXVwIHZtb3VzZW92ZXIgdm1vdXNlb3V0IGZvY3VzIGJsdXIgc2Nyb2xsc3RhcnQiOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciB0aGVtZSwKCQkJCSRidG4gPSAkKCBjbG9zZXN0RW5hYmxlZEJ1dHRvbiggZXZlbnQudGFyZ2V0ICkgKSwKCQkJCWlzVG91Y2hFdmVudCA9IGV2ZW50Lm9yaWdpbmFsRXZlbnQgJiYgL150b3VjaC8udGVzdCggZXZlbnQub3JpZ2luYWxFdmVudC50eXBlICksCgkJCQlldnQgPSBldmVudC50eXBlOwoKCQkJaWYgKCAkYnRuLmxlbmd0aCApIHsKCQkJCXRoZW1lID0gJGJ0bi5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidGhlbWUiICk7CgoJCQkJaWYgKCBldnQgPT09ICJ2bW91c2Vkb3duIiApIHsKCQkJCQlpZiAoIGlzVG91Y2hFdmVudCApIHsKCQkJCQkJLy8gVXNlIGEgc2hvcnQgZGVsYXkgdG8gZGV0ZXJtaW5lIGlmIHRoZSB1c2VyIGlzIHNjcm9sbGluZyBiZWZvcmUgaGlnaGxpZ2h0aW5nCgkJCQkJCWhvdiA9IHNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCQkJCQkJJGJ0bi5yZW1vdmVDbGFzcyggInVpLWJ0bi11cC0iICsgdGhlbWUgKS5hZGRDbGFzcyggInVpLWJ0bi1kb3duLSIgKyB0aGVtZSApOwoJCQkJCQl9LCBob3ZlckRlbGF5ICk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJJGJ0bi5yZW1vdmVDbGFzcyggInVpLWJ0bi11cC0iICsgdGhlbWUgKS5hZGRDbGFzcyggInVpLWJ0bi1kb3duLSIgKyB0aGVtZSApOwoJCQkJCX0KCQkJCX0gZWxzZSBpZiAoIGV2dCA9PT0gInZtb3VzZWNhbmNlbCIgfHwgZXZ0ID09PSAidm1vdXNldXAiICkgewoJCQkJCSRidG4ucmVtb3ZlQ2xhc3MoICJ1aS1idG4tZG93bi0iICsgdGhlbWUgKS5hZGRDbGFzcyggInVpLWJ0bi11cC0iICsgdGhlbWUgKTsKCQkJCX0gZWxzZSBpZiAoIGV2dCA9PT0gInZtb3VzZW92ZXIiIHx8IGV2dCA9PT0gImZvY3VzIiApIHsKCQkJCQlpZiAoIGlzVG91Y2hFdmVudCApIHsKCQkJCQkJLy8gVXNlIGEgc2hvcnQgZGVsYXkgdG8gZGV0ZXJtaW5lIGlmIHRoZSB1c2VyIGlzIHNjcm9sbGluZyBiZWZvcmUgaGlnaGxpZ2h0aW5nCgkJCQkJCWZvYyA9IHNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCQkJCQkJJGJ0bi5yZW1vdmVDbGFzcyggInVpLWJ0bi11cC0iICsgdGhlbWUgKS5hZGRDbGFzcyggInVpLWJ0bi1ob3Zlci0iICsgdGhlbWUgKTsKCQkJCQkJfSwgaG92ZXJEZWxheSApOwoJCQkJCX0gZWxzZSB7CgkJCQkJCSRidG4ucmVtb3ZlQ2xhc3MoICJ1aS1idG4tdXAtIiArIHRoZW1lICkuYWRkQ2xhc3MoICJ1aS1idG4taG92ZXItIiArIHRoZW1lICk7CgkJCQkJfQoJCQkJfSBlbHNlIGlmICggZXZ0ID09PSAidm1vdXNlb3V0IiB8fCBldnQgPT09ICJibHVyIiB8fCBldnQgPT09ICJzY3JvbGxzdGFydCIgKSB7CgkJCQkJJGJ0bi5yZW1vdmVDbGFzcyggInVpLWJ0bi1ob3Zlci0iICsgdGhlbWUgICsgIiB1aS1idG4tZG93bi0iICsgdGhlbWUgKS5hZGRDbGFzcyggInVpLWJ0bi11cC0iICsgdGhlbWUgKTsKCQkJCQlpZiAoIGhvdiApIHsKCQkJCQkJY2xlYXJUaW1lb3V0KCBob3YgKTsKCQkJCQl9CgkJCQkJaWYgKCBmb2MgKSB7CgkJCQkJCWNsZWFyVGltZW91dCggZm9jICk7CgkJCQkJfQoJCQkJfQoJCQl9CgkJfSwKCQkiZm9jdXNpbiBmb2N1cyI6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJJCggY2xvc2VzdEVuYWJsZWRCdXR0b24oIGV2ZW50LnRhcmdldCApICkuYWRkQ2xhc3MoICQubW9iaWxlLmZvY3VzQ2xhc3MgKTsKCQl9LAoJCSJmb2N1c291dCBibHVyIjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkkKCBjbG9zZXN0RW5hYmxlZEJ1dHRvbiggZXZlbnQudGFyZ2V0ICkgKS5yZW1vdmVDbGFzcyggJC5tb2JpbGUuZm9jdXNDbGFzcyApOwoJCX0KCX0pOwoKCWF0dGFjaEV2ZW50cyA9IG51bGw7Cn07CgovL2xpbmtzIGluIGJhcnMsIG9yIHRob3NlIHdpdGggIGRhdGEtcm9sZSBiZWNvbWUgYnV0dG9ucwovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJCggZG9jdW1lbnQgKS5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApIHsKCgkkKCAiOmpxbURhdGEocm9sZT0nYnV0dG9uJyksIC51aS1iYXIgPiBhLCAudWktaGVhZGVyID4gYSwgLnVpLWZvb3RlciA+IGEsIC51aS1iYXIgPiA6anFtRGF0YShyb2xlPSdjb250cm9sZ3JvdXAnKSA+IGEiLCBlLnRhcmdldCApCgkJLmpxbUVuaGFuY2VhYmxlKCkKCQkubm90KCAiYnV0dG9uLCBpbnB1dCwgLnVpLWJ0biwgOmpxbURhdGEocm9sZT0nbm9uZScpLCA6anFtRGF0YShyb2xlPSdub2pzJykiICkKCQkuYnV0dG9uTWFya3VwKCk7Cn0pOwoKfSkoIGpRdWVyeSApOwoKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUuY29sbGFwc2libGUiLCAkLm1vYmlsZS53aWRnZXQsIHsKCW9wdGlvbnM6IHsKCQlleHBhbmRDdWVUZXh0OiAiIGNsaWNrIHRvIGV4cGFuZCBjb250ZW50cyIsCgkJY29sbGFwc2VDdWVUZXh0OiAiIGNsaWNrIHRvIGNvbGxhcHNlIGNvbnRlbnRzIiwKCQljb2xsYXBzZWQ6IHRydWUsCgkJaGVhZGluZzogImgxLGgyLGgzLGg0LGg1LGg2LGxlZ2VuZCIsCgkJdGhlbWU6IG51bGwsCgkJY29udGVudFRoZW1lOiBudWxsLAoJCWluc2V0OiB0cnVlLAoJCW1pbmk6IGZhbHNlLAoJCWluaXRTZWxlY3RvcjogIjpqcW1EYXRhKHJvbGU9J2NvbGxhcHNpYmxlJykiCgl9LAoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgoJCXZhciAkZWwgPSB0aGlzLmVsZW1lbnQsCgkJCW8gPSB0aGlzLm9wdGlvbnMsCgkJCWNvbGxhcHNpYmxlID0gJGVsLmFkZENsYXNzKCAidWktY29sbGFwc2libGUiICksCgkJCWNvbGxhcHNpYmxlSGVhZGluZyA9ICRlbC5jaGlsZHJlbiggby5oZWFkaW5nICkuZmlyc3QoKSwKCQkJY29sbGFwc2VkSWNvbiA9ICRlbC5qcW1EYXRhKCAiY29sbGFwc2VkLWljb24iICkgfHwgby5jb2xsYXBzZWRJY29uLAoJCQlleHBhbmRlZEljb24gPSAkZWwuanFtRGF0YSggImV4cGFuZGVkLWljb24iICkgfHwgby5leHBhbmRlZEljb24sCgkJCWNvbGxhcHNpYmxlQ29udGVudCA9IGNvbGxhcHNpYmxlLndyYXBJbm5lciggIjxkaXYgY2xhc3M9J3VpLWNvbGxhcHNpYmxlLWNvbnRlbnQnPjwvZGl2PiIgKS5jaGlsZHJlbiggIi51aS1jb2xsYXBzaWJsZS1jb250ZW50IiApLAoJCQljb2xsYXBzaWJsZVNldCA9ICRlbC5jbG9zZXN0KCAiOmpxbURhdGEocm9sZT0nY29sbGFwc2libGUtc2V0JykiICkuYWRkQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZS1zZXQiICk7CgoJCS8vIFJlcGxhY2UgY29sbGFwc2libGVIZWFkaW5nIGlmIGl0J3MgYSBsZWdlbmQKCQlpZiAoIGNvbGxhcHNpYmxlSGVhZGluZy5pcyggImxlZ2VuZCIgKSApIHsKCQkJY29sbGFwc2libGVIZWFkaW5nID0gJCggIjxkaXYgcm9sZT0naGVhZGluZyc+IisgY29sbGFwc2libGVIZWFkaW5nLmh0bWwoKSArIjwvZGl2PiIgKS5pbnNlcnRCZWZvcmUoIGNvbGxhcHNpYmxlSGVhZGluZyApOwoJCQljb2xsYXBzaWJsZUhlYWRpbmcubmV4dCgpLnJlbW92ZSgpOwoJCX0KCgkJLy8gSWYgd2UgYXJlIGluIGEgY29sbGFwc2libGUgc2V0CgkJaWYgKCBjb2xsYXBzaWJsZVNldC5sZW5ndGggKSB7CgkJCS8vIEluaGVyaXQgdGhlIHRoZW1lIGZyb20gY29sbGFwc2libGUtc2V0CgkJCWlmICggIW8udGhlbWUgKSB7CgkJCQlvLnRoZW1lID0gY29sbGFwc2libGVTZXQuanFtRGF0YSggInRoZW1lIiApIHx8ICQubW9iaWxlLmdldEluaGVyaXRlZFRoZW1lKCBjb2xsYXBzaWJsZVNldCwgImMiICk7CgkJCX0KCQkJLy8gSW5oZXJpdCB0aGUgY29udGVudC10aGVtZSBmcm9tIGNvbGxhcHNpYmxlLXNldAoJCQlpZiAoICFvLmNvbnRlbnRUaGVtZSApIHsKCQkJCW8uY29udGVudFRoZW1lID0gY29sbGFwc2libGVTZXQuanFtRGF0YSggImNvbnRlbnQtdGhlbWUiICk7CgkJCX0KCgkJCS8vIEdldCB0aGUgcHJlZmVyZW5jZSBmb3IgY29sbGFwc2VkIGljb24gaW4gdGhlIHNldAoJCQlpZiAoICFvLmNvbGxhcHNlZEljb24gKSB7CgkJCQlvLmNvbGxhcHNlZEljb24gPSBjb2xsYXBzaWJsZVNldC5qcW1EYXRhKCAiY29sbGFwc2VkLWljb24iICk7CgkJCX0KCQkJLy8gR2V0IHRoZSBwcmVmZXJlbmNlIGZvciBleHBhbmRlZCBpY29uIGluIHRoZSBzZXQKCQkJaWYgKCAhby5leHBhbmRlZEljb24gKSB7CgkJCQlvLmV4cGFuZGVkSWNvbiA9IGNvbGxhcHNpYmxlU2V0LmpxbURhdGEoICJleHBhbmRlZC1pY29uIiApOwoJCQl9CgkJCS8vIEdldHMgdGhlIHByZWZlcmVuY2UgaWNvbiBwb3NpdGlvbiBpbiB0aGUgc2V0CgkJCWlmICggIW8uaWNvblBvcyApIHsKCQkJCW8uaWNvblBvcyA9IGNvbGxhcHNpYmxlU2V0LmpxbURhdGEoICJpY29ucG9zIiApOwoJCQl9CgkJCS8vIEluaGVyaXQgdGhlIHByZWZlcmVuY2UgZm9yIGluc2V0IGZyb20gY29sbGFwc2libGUtc2V0IG9yIHNldCB0aGUgZGVmYXVsdCB2YWx1ZSB0byBlbnN1cmUgZXF1YWx0eSB3aXRoaW4gYSBzZXQKCQkJaWYgKCBjb2xsYXBzaWJsZVNldC5qcW1EYXRhKCAiaW5zZXQiICkgIT09IHVuZGVmaW5lZCApIHsKCQkJCW8uaW5zZXQgPSBjb2xsYXBzaWJsZVNldC5qcW1EYXRhKCAiaW5zZXQiICk7CgkJCX0gZWxzZSB7CgkJCQlvLmluc2V0ID0gdHJ1ZTsKCQkJfQoJCQkvLyBHZXRzIHRoZSBwcmVmZXJlbmNlIGZvciBtaW5pIGluIHRoZSBzZXQKCQkJaWYgKCAhby5taW5pICkgewoJCQkJby5taW5pID0gY29sbGFwc2libGVTZXQuanFtRGF0YSggIm1pbmkiICk7CgkJCX0KCQl9IGVsc2UgewoJCQkvLyBnZXQgaW5oZXJpdGVkIHRoZW1lIGlmIG5vdCBhIHNldCBhbmQgbm8gdGhlbWUgaGFzIGJlZW4gc2V0CgkJCWlmICggIW8udGhlbWUgKSB7CgkJCQlvLnRoZW1lID0gJC5tb2JpbGUuZ2V0SW5oZXJpdGVkVGhlbWUoICRlbCwgImMiICk7CgkJCX0KCQl9CgkJCgkJaWYgKCAhIW8uaW5zZXQgKSB7CgkJCWNvbGxhcHNpYmxlLmFkZENsYXNzKCAidWktY29sbGFwc2libGUtaW5zZXQiICk7CgkJfQoJCQoJCWNvbGxhcHNpYmxlQ29udGVudC5hZGRDbGFzcyggKCBvLmNvbnRlbnRUaGVtZSApID8gKCAidWktYm9keS0iICsgby5jb250ZW50VGhlbWUgKSA6ICIiKTsKCgkJY29sbGFwc2VkSWNvbiA9ICRlbC5qcW1EYXRhKCAiY29sbGFwc2VkLWljb24iICkgfHwgby5jb2xsYXBzZWRJY29uIHx8ICJwbHVzIjsKCQlleHBhbmRlZEljb24gPSAkZWwuanFtRGF0YSggImV4cGFuZGVkLWljb24iICkgfHwgby5leHBhbmRlZEljb24gfHwgIm1pbnVzIjsKCgkJY29sbGFwc2libGVIZWFkaW5nCgkJCS8vZHJvcCBoZWFkaW5nIGluIGJlZm9yZSBjb250ZW50CgkJCS5pbnNlcnRCZWZvcmUoIGNvbGxhcHNpYmxlQ29udGVudCApCgkJCS8vbW9kaWZ5IG1hcmt1cCAmIGF0dHJpYnV0ZXMKCQkJLmFkZENsYXNzKCAidWktY29sbGFwc2libGUtaGVhZGluZyIgKQoJCQkuYXBwZW5kKCAiPHNwYW4gY2xhc3M9J3VpLWNvbGxhcHNpYmxlLWhlYWRpbmctc3RhdHVzJz48L3NwYW4+IiApCgkJCS53cmFwSW5uZXIoICI8YSBocmVmPScjJyBjbGFzcz0ndWktY29sbGFwc2libGUtaGVhZGluZy10b2dnbGUnPjwvYT4iICkKCQkJLmZpbmQoICJhIiApCgkJCQkuZmlyc3QoKQoJCQkJLmJ1dHRvbk1hcmt1cCh7CgkJCQkJc2hhZG93OiBmYWxzZSwKCQkJCQljb3JuZXJzOiBmYWxzZSwKCQkJCQlpY29ucG9zOiAkZWwuanFtRGF0YSggImljb25wb3MiICkgfHwgby5pY29uUG9zIHx8ICJsZWZ0IiwKCQkJCQlpY29uOiBjb2xsYXBzZWRJY29uLAoJCQkJCW1pbmk6IG8ubWluaSwKCQkJCQl0aGVtZTogby50aGVtZQoJCQkJfSk7CgoJCWlmICggISFvLmluc2V0ICkgewkJCQkKCQkJY29sbGFwc2libGVIZWFkaW5nCgkJCQkuZmluZCggImEiICkuZmlyc3QoKS5hZGQoICIudWktYnRuLWlubmVyIiwgJGVsICkKCQkJCQkuYWRkQ2xhc3MoICJ1aS1jb3JuZXItdG9wIHVpLWNvcm5lci1ib3R0b20iICk7CgkJfQoKCQkvL2V2ZW50cwoJCWNvbGxhcHNpYmxlCgkJCS5iaW5kKCAiZXhwYW5kIGNvbGxhcHNlIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJaWYgKCAhZXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKSB7CgkJCQkJdmFyICR0aGlzID0gJCggdGhpcyApLAoJCQkJCQlpc0NvbGxhcHNlID0gKCBldmVudC50eXBlID09PSAiY29sbGFwc2UiICksCgkJCQkJCWNvbnRlbnRUaGVtZSA9IG8uY29udGVudFRoZW1lOwoKCQkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoKCQkJCQljb2xsYXBzaWJsZUhlYWRpbmcKCQkJCQkJLnRvZ2dsZUNsYXNzKCAidWktY29sbGFwc2libGUtaGVhZGluZy1jb2xsYXBzZWQiLCBpc0NvbGxhcHNlICkKCQkJCQkJLmZpbmQoICIudWktY29sbGFwc2libGUtaGVhZGluZy1zdGF0dXMiICkKCQkJCQkJCS50ZXh0KCBpc0NvbGxhcHNlID8gby5leHBhbmRDdWVUZXh0IDogby5jb2xsYXBzZUN1ZVRleHQgKQoJCQkJCQkuZW5kKCkKCQkJCQkJLmZpbmQoICIudWktaWNvbiIgKQoJCQkJCQkJLnRvZ2dsZUNsYXNzKCAidWktaWNvbi0iICsgZXhwYW5kZWRJY29uLCAhaXNDb2xsYXBzZSApCgkJCQkJCQkvLyBsb2dpYyBvciBjYXVzZSBzYW1lIGljb24gZm9yIGV4cGFuZGVkL2NvbGxhcHNlZCBzdGF0ZSB3b3VsZCByZW1vdmUgdGhlIHVpLWljb24tY2xhc3MKCQkJCQkJCS50b2dnbGVDbGFzcyggInVpLWljb24tIiArIGNvbGxhcHNlZEljb24sICggaXNDb2xsYXBzZSB8fCBleHBhbmRlZEljb24gPT09IGNvbGxhcHNlZEljb24gKSApCgkJCQkJCS5lbmQoKQoJCQkJCQkuZmluZCggImEiICkuZmlyc3QoKS5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCgkJCQkJJHRoaXMudG9nZ2xlQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZS1jb2xsYXBzZWQiLCBpc0NvbGxhcHNlICk7CgkJCQkJY29sbGFwc2libGVDb250ZW50LnRvZ2dsZUNsYXNzKCAidWktY29sbGFwc2libGUtY29udGVudC1jb2xsYXBzZWQiLCBpc0NvbGxhcHNlICkuYXR0ciggImFyaWEtaGlkZGVuIiwgaXNDb2xsYXBzZSApOwoKCQkJCQlpZiAoIGNvbnRlbnRUaGVtZSAmJiAhIW8uaW5zZXQgJiYgKCAhY29sbGFwc2libGVTZXQubGVuZ3RoIHx8IGNvbGxhcHNpYmxlLmpxbURhdGEoICJjb2xsYXBzaWJsZS1sYXN0IiApICkgKSB7CgkJCQkJCWNvbGxhcHNpYmxlSGVhZGluZwoJCQkJCQkJLmZpbmQoICJhIiApLmZpcnN0KCkuYWRkKCBjb2xsYXBzaWJsZUhlYWRpbmcuZmluZCggIi51aS1idG4taW5uZXIiICkgKQoJCQkJCQkJLnRvZ2dsZUNsYXNzKCAidWktY29ybmVyLWJvdHRvbSIsIGlzQ29sbGFwc2UgKTsKCQkJCQkJY29sbGFwc2libGVDb250ZW50LnRvZ2dsZUNsYXNzKCAidWktY29ybmVyLWJvdHRvbSIsICFpc0NvbGxhcHNlICk7CgkJCQkJfQoJCQkJCWNvbGxhcHNpYmxlQ29udGVudC50cmlnZ2VyKCAidXBkYXRlbGF5b3V0IiApOwoJCQkJfQoJCQl9KQoJCQkudHJpZ2dlciggby5jb2xsYXBzZWQgPyAiY29sbGFwc2UiIDogImV4cGFuZCIgKTsKCgkJY29sbGFwc2libGVIZWFkaW5nCgkJCS5iaW5kKCAidGFwIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJY29sbGFwc2libGVIZWFkaW5nLmZpbmQoICJhIiApLmZpcnN0KCkuYWRkQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCX0pCgkJCS5iaW5kKCAiY2xpY2siLCBmdW5jdGlvbiggZXZlbnQgKSB7CgoJCQkJdmFyIHR5cGUgPSBjb2xsYXBzaWJsZUhlYWRpbmcuaXMoICIudWktY29sbGFwc2libGUtaGVhZGluZy1jb2xsYXBzZWQiICkgPyAiZXhwYW5kIiA6ICJjb2xsYXBzZSI7CgoJCQkJY29sbGFwc2libGUudHJpZ2dlciggdHlwZSApOwoKCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQlldmVudC5zdG9wUHJvcGFnYXRpb24oKTsKCQkJfSk7Cgl9Cn0pOwoKLy9hdXRvIHNlbGYtaW5pdCB3aWRnZXRzCiQoIGRvY3VtZW50ICkuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKSB7CgkkLm1vYmlsZS5jb2xsYXBzaWJsZS5wcm90b3R5cGUuZW5oYW5jZVdpdGhpbiggZS50YXJnZXQgKTsKfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLmNvbGxhcHNpYmxlc2V0IiwgJC5tb2JpbGUud2lkZ2V0LCB7CglvcHRpb25zOiB7CgkJaW5pdFNlbGVjdG9yOiAiOmpxbURhdGEocm9sZT0nY29sbGFwc2libGUtc2V0JykiCgl9LAoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdmFyICRlbCA9IHRoaXMuZWxlbWVudC5hZGRDbGFzcyggInVpLWNvbGxhcHNpYmxlLXNldCIgKSwKCQkJbyA9IHRoaXMub3B0aW9uczsKCgkJLy8gSW5oZXJpdCB0aGUgdGhlbWUgZnJvbSBjb2xsYXBzaWJsZS1zZXQKCQlpZiAoICFvLnRoZW1lICkgewoJCQlvLnRoZW1lID0gJC5tb2JpbGUuZ2V0SW5oZXJpdGVkVGhlbWUoICRlbCwgImMiICk7CgkJfQoJCS8vIEluaGVyaXQgdGhlIGNvbnRlbnQtdGhlbWUgZnJvbSBjb2xsYXBzaWJsZS1zZXQKCQlpZiAoICFvLmNvbnRlbnRUaGVtZSApIHsKCQkJby5jb250ZW50VGhlbWUgPSAkZWwuanFtRGF0YSggImNvbnRlbnQtdGhlbWUiICk7CgkJfQoKCQlpZiAoICRlbC5qcW1EYXRhKCAiaW5zZXQiICkgIT09IHVuZGVmaW5lZCApIHsKCQkJby5pbnNldCA9ICRlbC5qcW1EYXRhKCAiaW5zZXQiICk7CgkJfQoJCW8uaW5zZXQgPSBvLmluc2V0ICE9PSB1bmRlZmluZWQgPyBvLmluc2V0IDogdHJ1ZTsKCgkJLy8gSW5pdGlhbGl6ZSB0aGUgY29sbGFwc2libGUgc2V0IGlmIGl0J3Mgbm90IGFscmVhZHkgaW5pdGlhbGl6ZWQKCQlpZiAoICEkZWwuanFtRGF0YSggImNvbGxhcHNpYmxlYm91bmQiICkgKSB7CgkJCSRlbAoJCQkJLmpxbURhdGEoICJjb2xsYXBzaWJsZWJvdW5kIiwgdHJ1ZSApCgkJCQkuYmluZCggImV4cGFuZCBjb2xsYXBzZSIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCQl2YXIgaXNDb2xsYXBzZSA9ICggZXZlbnQudHlwZSA9PT0gImNvbGxhcHNlIiApLAoJCQkJCQljb2xsYXBzaWJsZSA9ICQoIGV2ZW50LnRhcmdldCApLmNsb3Nlc3QoICIudWktY29sbGFwc2libGUiICksCgkJCQkJCXdpZGdldCA9IGNvbGxhcHNpYmxlLmRhdGEoICJjb2xsYXBzaWJsZSIgKTsKCQkJCQlpZiAoIGNvbGxhcHNpYmxlLmpxbURhdGEoICJjb2xsYXBzaWJsZS1sYXN0IiApICYmICEhby5pbnNldCApIHsKCQkJCQkJY29sbGFwc2libGUuZmluZCggIi51aS1jb2xsYXBzaWJsZS1oZWFkaW5nIiApLmZpcnN0KCkKCQkJCQkJCS5maW5kKCAiYSIgKS5maXJzdCgpCgkJCQkJCQkudG9nZ2xlQ2xhc3MoICJ1aS1jb3JuZXItYm90dG9tIiwgaXNDb2xsYXBzZSApCgkJCQkJCQkuZmluZCggIi51aS1idG4taW5uZXIiICkKCQkJCQkJCS50b2dnbGVDbGFzcyggInVpLWNvcm5lci1ib3R0b20iLCBpc0NvbGxhcHNlICk7CgkJCQkJCWNvbGxhcHNpYmxlLmZpbmQoICIudWktY29sbGFwc2libGUtY29udGVudCIgKS50b2dnbGVDbGFzcyggInVpLWNvcm5lci1ib3R0b20iLCAhaXNDb2xsYXBzZSApOwoJCQkJCX0KCQkJCX0pCgkJCQkuYmluZCggImV4cGFuZCIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCQl2YXIgY2xvc2VzdENvbGxhcHNpYmxlID0gJCggZXZlbnQudGFyZ2V0ICkKCQkJCQkJLmNsb3Nlc3QoICIudWktY29sbGFwc2libGUiICk7CgkJCQkJaWYgKCBjbG9zZXN0Q29sbGFwc2libGUucGFyZW50KCkuaXMoICI6anFtRGF0YShyb2xlPSdjb2xsYXBzaWJsZS1zZXQnKSIgKSApIHsKCQkJCQkJY2xvc2VzdENvbGxhcHNpYmxlCgkJCQkJCQkuc2libGluZ3MoICIudWktY29sbGFwc2libGUiICkKCQkJCQkJCS50cmlnZ2VyKCAiY29sbGFwc2UiICk7CgkJCQkJfQoJCQkJfSk7CgkJfQoJfSwKCglfaW5pdDogZnVuY3Rpb24oKSB7CgkJdmFyICRlbCA9IHRoaXMuZWxlbWVudCwKCQkJY29sbGFwc2libGVzSW5TZXQgPSAkZWwuY2hpbGRyZW4oICI6anFtRGF0YShyb2xlPSdjb2xsYXBzaWJsZScpIiApLAoJCQlleHBhbmRlZCA9IGNvbGxhcHNpYmxlc0luU2V0LmZpbHRlciggIjpqcW1EYXRhKGNvbGxhcHNlZD0nZmFsc2UnKSIgKTsKCQl0aGlzLnJlZnJlc2goKTsKCgkJLy8gQmVjYXVzZSB0aGUgY29ybmVycyBhcmUgaGFuZGxlZCBieSB0aGUgY29sbGFwc2libGUgaXRzZWxmIGFuZCB0aGUgZGVmYXVsdCBzdGF0ZSBpcyBjb2xsYXBzZWQKCQkvLyBUaGF0IHdhcyBjYXVzaW5nIGh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5LW1vYmlsZS9pc3N1ZXMvNDExNgoJCWV4cGFuZGVkLnRyaWdnZXIoICJleHBhbmQiICk7Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCXZhciAkZWwgPSB0aGlzLmVsZW1lbnQsCgkJCW8gPSB0aGlzLm9wdGlvbnMsCgkJCWNvbGxhcHNpYmxlc0luU2V0ID0gJGVsLmNoaWxkcmVuKCAiOmpxbURhdGEocm9sZT0nY29sbGFwc2libGUnKSIgKTsKCgkJJC5tb2JpbGUuY29sbGFwc2libGUucHJvdG90eXBlLmVuaGFuY2UoIGNvbGxhcHNpYmxlc0luU2V0Lm5vdCggIi51aS1jb2xsYXBzaWJsZSIgKSApOwoKCQkvLyBjbGVhbiB1cCBib3JkZXJzCgkJaWYgKCAhIW8uaW5zZXQgKSB7CgkJCWNvbGxhcHNpYmxlc0luU2V0LmVhY2goZnVuY3Rpb24oKSB7CgkJCQkkKCB0aGlzICkuanFtUmVtb3ZlRGF0YSggImNvbGxhcHNpYmxlLWxhc3QiICkKCQkJCQkuZmluZCggIi51aS1jb2xsYXBzaWJsZS1oZWFkaW5nIiApCgkJCQkJLmZpbmQoICJhIiApLmZpcnN0KCkKCQkJCQkucmVtb3ZlQ2xhc3MoICJ1aS1jb3JuZXItdG9wIHVpLWNvcm5lci1ib3R0b20iICkKCQkJCQkuZmluZCggIi51aS1idG4taW5uZXIiICkKCQkJCQkucmVtb3ZlQ2xhc3MoICJ1aS1jb3JuZXItdG9wIHVpLWNvcm5lci1ib3R0b20iICk7CgkJCX0pOwoKCQkJY29sbGFwc2libGVzSW5TZXQuZmlyc3QoKQoJCQkJLmZpbmQoICJhIiApCgkJCQkJLmZpcnN0KCkKCQkJCQkuYWRkQ2xhc3MoICJ1aS1jb3JuZXItdG9wIiApCgkJCQkJLmZpbmQoICIudWktYnRuLWlubmVyIiApCgkJCQkJCS5hZGRDbGFzcyggInVpLWNvcm5lci10b3AiICk7CgkKCQkJY29sbGFwc2libGVzSW5TZXQubGFzdCgpCgkJCQkuanFtRGF0YSggImNvbGxhcHNpYmxlLWxhc3QiLCB0cnVlICkKCQkJCS5maW5kKCAiYSIgKQoJCQkJCS5maXJzdCgpCgkJCQkJLmFkZENsYXNzKCAidWktY29ybmVyLWJvdHRvbSIgKQoJCQkJCS5maW5kKCAiLnVpLWJ0bi1pbm5lciIgKQoJCQkJCQkuYWRkQ2xhc3MoICJ1aS1jb3JuZXItYm90dG9tIiApOwoJCX0KCX0KfSk7CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJCggZG9jdW1lbnQgKS5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApIHsKCSQubW9iaWxlLmNvbGxhcHNpYmxlc2V0LnByb3RvdHlwZS5lbmhhbmNlV2l0aGluKCBlLnRhcmdldCApOwp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUubmF2YmFyIiwgJC5tb2JpbGUud2lkZ2V0LCB7CglvcHRpb25zOiB7CgkJaWNvbnBvczogInRvcCIsCgkJZ3JpZDogbnVsbCwKCQlpbml0U2VsZWN0b3I6ICI6anFtRGF0YShyb2xlPSduYXZiYXInKSIKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgoJCXZhciAkbmF2YmFyID0gdGhpcy5lbGVtZW50LAoJCQkkbmF2YnRucyA9ICRuYXZiYXIuZmluZCggImEiICksCgkJCWljb25wb3MgPSAkbmF2YnRucy5maWx0ZXIoICI6anFtRGF0YShpY29uKSIgKS5sZW5ndGggPwoJCQkJCQkJCQl0aGlzLm9wdGlvbnMuaWNvbnBvcyA6IHVuZGVmaW5lZDsKCgkJJG5hdmJhci5hZGRDbGFzcyggInVpLW5hdmJhciB1aS1taW5pIiApCgkJCS5hdHRyKCAicm9sZSIsICJuYXZpZ2F0aW9uIiApCgkJCS5maW5kKCAidWwiICkKCQkJLmpxbUVuaGFuY2VhYmxlKCkKCQkJLmdyaWQoeyBncmlkOiB0aGlzLm9wdGlvbnMuZ3JpZCB9KTsKCgkJJG5hdmJ0bnMuYnV0dG9uTWFya3VwKHsKCQkJY29ybmVyczoJZmFsc2UsCgkJCXNoYWRvdzoJCWZhbHNlLAoJCQlpbmxpbmU6ICAgICB0cnVlLAoJCQlpY29ucG9zOglpY29ucG9zCgkJfSk7CgoJCSRuYXZiYXIuZGVsZWdhdGUoICJhIiwgInZjbGljayIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJaWYgKCAhJChldmVudC50YXJnZXQpLmhhc0NsYXNzKCAidWktZGlzYWJsZWQiICkgKSB7CgkJCQkkbmF2YnRucy5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJCSQoIHRoaXMgKS5hZGRDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJfQoJCX0pOwoKCQkvLyBCdXR0b25zIGluIHRoZSBuYXZiYXIgd2l0aCB1aS1zdGF0ZS1wZXJzaXN0IGNsYXNzIHNob3VsZCByZWdhaW4gdGhlaXIgYWN0aXZlIHN0YXRlIGJlZm9yZSBwYWdlIHNob3cKCQkkbmF2YmFyLmNsb3Nlc3QoICIudWktcGFnZSIgKS5iaW5kKCAicGFnZWJlZm9yZXNob3ciLCBmdW5jdGlvbigpIHsKCQkJJG5hdmJ0bnMuZmlsdGVyKCAiLnVpLXN0YXRlLXBlcnNpc3QiICkuYWRkQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJfSk7Cgl9Cn0pOwoKLy9hdXRvIHNlbGYtaW5pdCB3aWRnZXRzCiQoIGRvY3VtZW50ICkuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKSB7CgkkLm1vYmlsZS5uYXZiYXIucHJvdG90eXBlLmVuaGFuY2VXaXRoaW4oIGUudGFyZ2V0ICk7Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgovL0tlZXBzIHRyYWNrIG9mIHRoZSBudW1iZXIgb2YgbGlzdHMgcGVyIHBhZ2UgVUlECi8vVGhpcyBhbGxvd3Mgc3VwcG9ydCBmb3IgbXVsdGlwbGUgbmVzdGVkIGxpc3QgaW4gdGhlIHNhbWUgcGFnZQovL2h0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5LW1vYmlsZS9pc3N1ZXMvMTYxNwp2YXIgbGlzdENvdW50UGVyUGFnZSA9IHt9OwoKJC53aWRnZXQoICJtb2JpbGUubGlzdHZpZXciLCAkLm1vYmlsZS53aWRnZXQsIHsKCglvcHRpb25zOiB7CgkJdGhlbWU6IG51bGwsCgkJY291bnRUaGVtZTogImMiLAoJCWhlYWRlclRoZW1lOiAiYiIsCgkJZGl2aWRlclRoZW1lOiAiYiIsCgkJc3BsaXRJY29uOiAiYXJyb3ctciIsCgkJc3BsaXRUaGVtZTogImIiLAoJCWluc2V0OiBmYWxzZSwKCQlpbml0U2VsZWN0b3I6ICI6anFtRGF0YShyb2xlPSdsaXN0dmlldycpIgoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl2YXIgdCA9IHRoaXMsCgkJCWxpc3R2aWV3Q2xhc3NlcyA9ICIiOwoKCQlsaXN0dmlld0NsYXNzZXMgKz0gdC5vcHRpb25zLmluc2V0ID8gIiB1aS1saXN0dmlldy1pbnNldCB1aS1jb3JuZXItYWxsIHVpLXNoYWRvdyAiIDogIiI7CgoJCS8vIGNyZWF0ZSBsaXN0dmlldyBtYXJrdXAKCQl0LmVsZW1lbnQuYWRkQ2xhc3MoZnVuY3Rpb24oIGksIG9yaWcgKSB7CgkJCXJldHVybiBvcmlnICsgIiB1aS1saXN0dmlldyAiICsgbGlzdHZpZXdDbGFzc2VzOwoJCX0pOwoKCQl0LnJlZnJlc2goIHRydWUgKTsKCX0sCgoJX3JlbW92ZUNvcm5lcnM6IGZ1bmN0aW9uKCBsaSwgd2hpY2ggKSB7CgkJdmFyIHRvcCA9ICJ1aS1jb3JuZXItdG9wIHVpLWNvcm5lci10ciB1aS1jb3JuZXItdGwiLAoJCQlib3QgPSAidWktY29ybmVyLWJvdHRvbSB1aS1jb3JuZXItYnIgdWktY29ybmVyLWJsIjsKCgkJbGkgPSBsaS5hZGQoIGxpLmZpbmQoICIudWktYnRuLWlubmVyLCAudWktbGktbGluay1hbHQsIC51aS1saS10aHVtYiIgKSApOwoKCQlpZiAoIHdoaWNoID09PSAidG9wIiApIHsKCQkJbGkucmVtb3ZlQ2xhc3MoIHRvcCApOwoJCX0gZWxzZSBpZiAoIHdoaWNoID09PSAiYm90dG9tIiApIHsKCQkJbGkucmVtb3ZlQ2xhc3MoIGJvdCApOwoJCX0gZWxzZSB7CgkJCWxpLnJlbW92ZUNsYXNzKCB0b3AgKyAiICIgKyBib3QgKTsKCQl9Cgl9LAoKCV9yZWZyZXNoQ29ybmVyczogZnVuY3Rpb24oIGNyZWF0ZSApIHsKCQl2YXIgJGxpLAoJCQkkdmlzaWJsZWxpLAoJCQkkdG9wbGksCgkJCSRib3R0b21saTsKCgkJJGxpID0gdGhpcy5lbGVtZW50LmNoaWxkcmVuKCAibGkiICk7CgkJLy8gQXQgY3JlYXRlIHRpbWUgYW5kIHdoZW4gYXV0b2RpdmlkZXJzIGNhbGxzIHJlZnJlc2ggdGhlIGxpIGFyZSBub3QgdmlzaWJsZSB5ZXQgc28gd2UgbmVlZCB0byByZWx5IG9uIC51aS1zY3JlZW4taGlkZGVuCgkJJHZpc2libGVsaSA9IGNyZWF0ZSB8fCAkbGkuZmlsdGVyKCAiOnZpc2libGUiICkubGVuZ3RoID09PSAwID8gJGxpLm5vdCggIi51aS1zY3JlZW4taGlkZGVuIiApIDogJGxpLmZpbHRlciggIjp2aXNpYmxlIiApOwoKCQkvLyB1aS1saS1sYXN0IGlzIHVzZWQgZm9yIHNldHRpbmcgYm9yZGVyLWJvdHRvbSBvbiB0aGUgbGFzdCBsaQkJCgkJJGxpLmZpbHRlciggIi51aS1saS1sYXN0IiApLnJlbW92ZUNsYXNzKCAidWktbGktbGFzdCIgKTsKCQkJCQkKCQlpZiAoIHRoaXMub3B0aW9ucy5pbnNldCApIHsKCQkJdGhpcy5fcmVtb3ZlQ29ybmVycyggJGxpICk7CgoJCQkvLyBTZWxlY3QgdGhlIGZpcnN0IHZpc2libGUgbGkgZWxlbWVudAoJCQkkdG9wbGkgPSAkdmlzaWJsZWxpLmZpcnN0KCkKCQkJCS5hZGRDbGFzcyggInVpLWNvcm5lci10b3AiICk7CgoJCQkkdG9wbGkuYWRkKCAkdG9wbGkuZmluZCggIi51aS1idG4taW5uZXIiICkKCQkJCS5ub3QoICIudWktbGktbGluay1hbHQgc3BhbjpmaXJzdC1jaGlsZCIgKSApCgkJCQkJLmFkZENsYXNzKCAidWktY29ybmVyLXRvcCIgKQoJCQkJLmVuZCgpCgkJCQkuZmluZCggIi51aS1saS1saW5rLWFsdCwgLnVpLWxpLWxpbmstYWx0IHNwYW46Zmlyc3QtY2hpbGQiICkKCQkJCQkuYWRkQ2xhc3MoICJ1aS1jb3JuZXItdHIiICkKCQkJCS5lbmQoKQoJCQkJLmZpbmQoICIudWktbGktdGh1bWIiICkKCQkJCQkubm90KCAiLnVpLWxpLWljb24iICkKCQkJCQkuYWRkQ2xhc3MoICJ1aS1jb3JuZXItdGwiICk7CgoJCQkvLyBTZWxlY3QgdGhlIGxhc3QgdmlzaWJsZSBsaSBlbGVtZW50CgkJCSRib3R0b21saSA9ICR2aXNpYmxlbGkubGFzdCgpCgkJCQkuYWRkQ2xhc3MoICJ1aS1jb3JuZXItYm90dG9tIHVpLWxpLWxhc3QiICk7CgoJCQkkYm90dG9tbGkuYWRkKCAkYm90dG9tbGkuZmluZCggIi51aS1idG4taW5uZXIiICkgKQoJCQkJLmZpbmQoICIudWktbGktbGluay1hbHQiICkKCQkJCQkuYWRkQ2xhc3MoICJ1aS1jb3JuZXItYnIiICkKCQkJCS5lbmQoKQoJCQkJLmZpbmQoICIudWktbGktdGh1bWIiICkKCQkJCQkubm90KCAiLnVpLWxpLWljb24iICkKCQkJCQkuYWRkQ2xhc3MoICJ1aS1jb3JuZXItYmwiICk7CgkJfSBlbHNlIHsKCQkJJHZpc2libGVsaS5sYXN0KCkuYWRkQ2xhc3MoICJ1aS1saS1sYXN0IiApOwoJCX0KCQlpZiAoICFjcmVhdGUgKSB7CgkJCXRoaXMuZWxlbWVudC50cmlnZ2VyKCAidXBkYXRlbGF5b3V0IiApOwoJCX0KCX0sCgoJLy8gVGhpcyBpcyBhIGdlbmVyaWMgdXRpbGl0eSBtZXRob2QgZm9yIGZpbmRpbmcgdGhlIGZpcnN0CgkvLyBub2RlIHdpdGggYSBnaXZlbiBub2RlTmFtZS4gSXQgdXNlcyBiYXNpYyBET00gdHJhdmVyc2FsCgkvLyB0byBiZSBmYXN0IGFuZCBpcyBtZWFudCB0byBiZSBhIHN1YnN0aXR1dGUgZm9yIHNpbXBsZQoJLy8gJC5mbi5jbG9zZXN0KCkgYW5kICQuZm4uY2hpbGRyZW4oKSBjYWxscyBvbiBhIHNpbmdsZQoJLy8gZWxlbWVudC4gTm90ZSB0aGF0IGNhbGxlcnMgbXVzdCBwYXNzIGJvdGggdGhlIGxvd2VyQ2FzZQoJLy8gYW5kIHVwcGVyQ2FzZSB2ZXJzaW9uIG9mIHRoZSBub2RlTmFtZSB0aGV5IGFyZSBsb29raW5nIGZvci4KCS8vIFRoZSBtYWluIHJlYXNvbiBmb3IgdGhpcyBpcyB0aGF0IHRoaXMgZnVuY3Rpb24gd2lsbCBiZQoJLy8gY2FsbGVkIG1hbnkgdGltZXMgYW5kIHdlIHdhbnQgdG8gYXZvaWQgaGF2aW5nIHRvIGxvd2VyY2FzZQoJLy8gdGhlIG5vZGVOYW1lIGZyb20gdGhlIGVsZW1lbnQgZXZlcnkgdGltZSB0byBlbnN1cmUgd2UgaGF2ZQoJLy8gYSBtYXRjaC4gTm90ZSB0aGF0IHRoaXMgZnVuY3Rpb24gbGl2ZXMgaGVyZSBmb3Igbm93LCBidXQgbWF5CgkvLyBiZSBtb3ZlZCBpbnRvICQubW9iaWxlIGlmIG90aGVyIGNvbXBvbmVudHMgbmVlZCBhIHNpbWlsYXIgbWV0aG9kLgoJX2ZpbmRGaXJzdEVsZW1lbnRCeVRhZ05hbWU6IGZ1bmN0aW9uKCBlbGUsIG5leHRQcm9wLCBsY05hbWUsIHVjTmFtZSApIHsKCQl2YXIgZGljdCA9IHt9OwoJCWRpY3RbIGxjTmFtZSBdID0gZGljdFsgdWNOYW1lIF0gPSB0cnVlOwoJCXdoaWxlICggZWxlICkgewoJCQlpZiAoIGRpY3RbIGVsZS5ub2RlTmFtZSBdICkgewoJCQkJcmV0dXJuIGVsZTsKCQkJfQoJCQllbGUgPSBlbGVbIG5leHRQcm9wIF07CgkJfQoJCXJldHVybiBudWxsOwoJfSwKCV9nZXRDaGlsZHJlbkJ5VGFnTmFtZTogZnVuY3Rpb24oIGVsZSwgbGNOYW1lLCB1Y05hbWUgKSB7CgkJdmFyIHJlc3VsdHMgPSBbXSwKCQkJZGljdCA9IHt9OwoJCWRpY3RbIGxjTmFtZSBdID0gZGljdFsgdWNOYW1lIF0gPSB0cnVlOwoJCWVsZSA9IGVsZS5maXJzdENoaWxkOwoJCXdoaWxlICggZWxlICkgewoJCQlpZiAoIGRpY3RbIGVsZS5ub2RlTmFtZSBdICkgewoJCQkJcmVzdWx0cy5wdXNoKCBlbGUgKTsKCQkJfQoJCQllbGUgPSBlbGUubmV4dFNpYmxpbmc7CgkJfQoJCXJldHVybiAkKCByZXN1bHRzICk7Cgl9LAoKCV9hZGRUaHVtYkNsYXNzZXM6IGZ1bmN0aW9uKCBjb250YWluZXJzICkgewoJCXZhciBpLCBpbWcsIGxlbiA9IGNvbnRhaW5lcnMubGVuZ3RoOwoJCWZvciAoIGkgPSAwOyBpIDwgbGVuOyBpKysgKSB7CgkJCWltZyA9ICQoIHRoaXMuX2ZpbmRGaXJzdEVsZW1lbnRCeVRhZ05hbWUoIGNvbnRhaW5lcnNbIGkgXS5maXJzdENoaWxkLCAibmV4dFNpYmxpbmciLCAiaW1nIiwgIklNRyIgKSApOwoJCQlpZiAoIGltZy5sZW5ndGggKSB7CgkJCQlpbWcuYWRkQ2xhc3MoICJ1aS1saS10aHVtYiIgKTsKCQkJCSQoIHRoaXMuX2ZpbmRGaXJzdEVsZW1lbnRCeVRhZ05hbWUoIGltZ1sgMCBdLnBhcmVudE5vZGUsICJwYXJlbnROb2RlIiwgImxpIiwgIkxJIiApICkuYWRkQ2xhc3MoIGltZy5pcyggIi51aS1saS1pY29uIiApID8gInVpLWxpLWhhcy1pY29uIiA6ICJ1aS1saS1oYXMtdGh1bWIiICk7CgkJCX0KCQl9Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCBjcmVhdGUgKSB7CgkJdGhpcy5wYXJlbnRQYWdlID0gdGhpcy5lbGVtZW50LmNsb3Nlc3QoICIudWktcGFnZSIgKTsKCQl0aGlzLl9jcmVhdGVTdWJQYWdlcygpOwoKCQl2YXIgbyA9IHRoaXMub3B0aW9ucywKCQkJJGxpc3QgPSB0aGlzLmVsZW1lbnQsCgkJCXNlbGYgPSB0aGlzLAoJCQlkaXZpZGVydGhlbWUgPSAkbGlzdC5qcW1EYXRhKCAiZGl2aWRlcnRoZW1lIiApIHx8IG8uZGl2aWRlclRoZW1lLAoJCQlsaXN0c3BsaXR0aGVtZSA9ICRsaXN0LmpxbURhdGEoICJzcGxpdHRoZW1lIiApLAoJCQlsaXN0c3BsaXRpY29uID0gJGxpc3QuanFtRGF0YSggInNwbGl0aWNvbiIgKSwKCQkJbGkgPSB0aGlzLl9nZXRDaGlsZHJlbkJ5VGFnTmFtZSggJGxpc3RbIDAgXSwgImxpIiwgIkxJIiApLAoJCQlvbCA9ICEhJC5ub2RlTmFtZSggJGxpc3RbIDAgXSwgIm9sIiApLAoJCQlqc0NvdW50ID0gISQuc3VwcG9ydC5jc3NQc2V1ZG9FbGVtZW50LAoJCQlzdGFydCA9ICRsaXN0LmF0dHIoICJzdGFydCIgKSwKCQkJaXRlbUNsYXNzRGljdCA9IHt9LAoJCQlpdGVtLCBpdGVtQ2xhc3MsIGl0ZW1UaGVtZSwKCQkJYSwgbGFzdCwgc3BsaXR0aGVtZSwgY291bnRlciwgc3RhcnRDb3VudCwgbmV3U3RhcnRDb3VudCwgY291bnRQYXJlbnQsIGljb24sIGltZ1BhcmVudHMsIGltZywgbGlua0ljb247CgoJCWlmICggb2wgJiYganNDb3VudCApIHsKCQkJJGxpc3QuZmluZCggIi51aS1saS1kZWMiICkucmVtb3ZlKCk7CgkJfQoKCQlpZiAoIG9sICkgewkKCQkJLy8gQ2hlY2sgaWYgYSBzdGFydCBhdHRyaWJ1dGUgaGFzIGJlZW4gc2V0IHdoaWxlIHRha2luZyBhIHZhbHVlIG9mIDAgaW50byBhY2NvdW50CgkJCWlmICggc3RhcnQgfHwgc3RhcnQgPT09IDAgKSB7CgkJCQlpZiAoICFqc0NvdW50ICkgewoJCQkJCXN0YXJ0Q291bnQgPSBwYXJzZUZsb2F0KCBzdGFydCApIC0gMTsKCQkJCQkkbGlzdC5jc3MoICJjb3VudGVyLXJlc2V0IiwgImxpc3RudW1iZXJpbmcgIiArIHN0YXJ0Q291bnQgKTsKCQkJCX0gZWxzZSB7CgkJCQkJY291bnRlciA9IHBhcnNlRmxvYXQoIHN0YXJ0ICk7CgkJCQl9CgkJCX0gZWxzZSBpZiAoIGpzQ291bnQgKSB7CgkJCQkJY291bnRlciA9IDE7CgkJCX0JCgkJfQoKCQlpZiAoICFvLnRoZW1lICkgewoJCQlvLnRoZW1lID0gJC5tb2JpbGUuZ2V0SW5oZXJpdGVkVGhlbWUoIHRoaXMuZWxlbWVudCwgImMiICk7CgkJfQoKCQlmb3IgKCB2YXIgcG9zID0gMCwgbnVtbGkgPSBsaS5sZW5ndGg7IHBvcyA8IG51bWxpOyBwb3MrKyApIHsKCQkJaXRlbSA9IGxpLmVxKCBwb3MgKTsKCQkJaXRlbUNsYXNzID0gInVpLWxpIjsKCgkJCS8vIElmIHdlJ3JlIGNyZWF0aW5nIHRoZSBlbGVtZW50LCB3ZSB1cGRhdGUgaXQgcmVnYXJkbGVzcwoJCQlpZiAoIGNyZWF0ZSB8fCAhaXRlbS5oYXNDbGFzcyggInVpLWxpIiApICkgewoJCQkJaXRlbVRoZW1lID0gaXRlbS5qcW1EYXRhKCAidGhlbWUiICkgfHwgby50aGVtZTsKCQkJCWEgPSB0aGlzLl9nZXRDaGlsZHJlbkJ5VGFnTmFtZSggaXRlbVsgMCBdLCAiYSIsICJBIiApOwoJCQkJdmFyIGlzRGl2aWRlciA9ICggaXRlbS5qcW1EYXRhKCAicm9sZSIgKSA9PT0gImxpc3QtZGl2aWRlciIgKTsKCgkJCQlpZiAoIGEubGVuZ3RoICYmICFpc0RpdmlkZXIgKSB7CgkJCQkJaWNvbiA9IGl0ZW0uanFtRGF0YSggImljb24iICk7CgoJCQkJCWl0ZW0uYnV0dG9uTWFya3VwKHsKCQkJCQkJd3JhcHBlckVsczogImRpdiIsCgkJCQkJCXNoYWRvdzogZmFsc2UsCgkJCQkJCWNvcm5lcnM6IGZhbHNlLAoJCQkJCQlpY29ucG9zOiAicmlnaHQiLAoJCQkJCQlpY29uOiBhLmxlbmd0aCA+IDEgfHwgaWNvbiA9PT0gZmFsc2UgPyBmYWxzZSA6IGljb24gfHwgImFycm93LXIiLAoJCQkJCQl0aGVtZTogaXRlbVRoZW1lCgkJCQkJfSk7CgoJCQkJCWlmICggKCBpY29uICE9PSBmYWxzZSApICYmICggYS5sZW5ndGggPT09IDEgKSApIHsKCQkJCQkJaXRlbS5hZGRDbGFzcyggInVpLWxpLWhhcy1hcnJvdyIgKTsKCQkJCQl9CgoJCQkJCWEuZmlyc3QoKS5yZW1vdmVDbGFzcyggInVpLWxpbmsiICkuYWRkQ2xhc3MoICJ1aS1saW5rLWluaGVyaXQiICk7CgoJCQkJCWlmICggYS5sZW5ndGggPiAxICkgewoJCQkJCQlpdGVtQ2xhc3MgKz0gIiB1aS1saS1oYXMtYWx0IjsKCgkJCQkJCWxhc3QgPSBhLmxhc3QoKTsKCQkJCQkJc3BsaXR0aGVtZSA9IGxpc3RzcGxpdHRoZW1lIHx8IGxhc3QuanFtRGF0YSggInRoZW1lIiApIHx8IG8uc3BsaXRUaGVtZTsKCQkJCQkJbGlua0ljb24gPSBsYXN0LmpxbURhdGEoICJpY29uIiApOwoKCQkJCQkJbGFzdC5hcHBlbmRUbyggaXRlbSApCgkJCQkJCQkuYXR0ciggInRpdGxlIiwgbGFzdC5nZXRFbmNvZGVkVGV4dCgpICkKCQkJCQkJCS5hZGRDbGFzcyggInVpLWxpLWxpbmstYWx0IiApCgkJCQkJCQkuZW1wdHkoKQoJCQkJCQkJLmJ1dHRvbk1hcmt1cCh7CgkJCQkJCQkJc2hhZG93OiBmYWxzZSwKCQkJCQkJCQljb3JuZXJzOiBmYWxzZSwKCQkJCQkJCQl0aGVtZTogaXRlbVRoZW1lLAoJCQkJCQkJCWljb246IGZhbHNlLAoJCQkJCQkJCWljb25wb3M6ICJub3RleHQiCgkJCQkJCQl9KQoJCQkJCQkJLmZpbmQoICIudWktYnRuLWlubmVyIiApCgkJCQkJCQkJLmFwcGVuZCgKCQkJCQkJCQkJJCggZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggInNwYW4iICkgKS5idXR0b25NYXJrdXAoewoJCQkJCQkJCQkJc2hhZG93OiB0cnVlLAoJCQkJCQkJCQkJY29ybmVyczogdHJ1ZSwKCQkJCQkJCQkJCXRoZW1lOiBzcGxpdHRoZW1lLAoJCQkJCQkJCQkJaWNvbnBvczogIm5vdGV4dCIsCgkJCQkJCQkJCQkvLyBsaW5rIGljb24gb3ZlcnJpZGVzIGxpc3QgaXRlbSBpY29uIG92ZXJyaWRlcyB1bCBlbGVtZW50IG92ZXJyaWRlcyBvcHRpb25zCgkJCQkJCQkJCQlpY29uOiBsaW5rSWNvbiB8fCBpY29uIHx8IGxpc3RzcGxpdGljb24gfHwgby5zcGxpdEljb24KCQkJCQkJCQkJfSkKCQkJCQkJCQkpOwoJCQkJCX0KCQkJCX0gZWxzZSBpZiAoIGlzRGl2aWRlciApIHsKCgkJCQkJaXRlbUNsYXNzICs9ICIgdWktbGktZGl2aWRlciB1aS1iYXItIiArIGRpdmlkZXJ0aGVtZTsKCQkJCQlpdGVtLmF0dHIoICJyb2xlIiwgImhlYWRpbmciICk7CgoJCQkJCWlmICggb2wgKSB7CQoJCQkJCQkvL3Jlc2V0IGNvdW50ZXIgd2hlbiBhIGRpdmlkZXIgaGVhZGluZyBpcyBlbmNvdW50ZXJlZAoJCQkJCQlpZiAoIHN0YXJ0IHx8IHN0YXJ0ID09PSAwICkgewoJCQkJCQkJaWYgKCAhanNDb3VudCApIHsKCQkJCQkJCQluZXdTdGFydENvdW50ID0gcGFyc2VGbG9hdCggc3RhcnQgKSAtIDE7CgkJCQkJCQkJaXRlbS5jc3MoICJjb3VudGVyLXJlc2V0IiwgImxpc3RudW1iZXJpbmcgIiArIG5ld1N0YXJ0Q291bnQgKTsKCQkJCQkJCX0gZWxzZSB7CgkJCQkJCQkJY291bnRlciA9IHBhcnNlRmxvYXQoIHN0YXJ0ICk7CgkJCQkJCQl9CgkJCQkJCX0gZWxzZSBpZiAoIGpzQ291bnQgKSB7CgkJCQkJCQkJY291bnRlciA9IDE7CgkJCQkJCX0JCgkJCQkJfQoJCQkJCgkJCQl9IGVsc2UgewoJCQkJCWl0ZW1DbGFzcyArPSAiIHVpLWxpLXN0YXRpYyB1aS1idG4tdXAtIiArIGl0ZW1UaGVtZTsKCQkJCX0KCQkJfQoKCQkJaWYgKCBvbCAmJiBqc0NvdW50ICYmIGl0ZW1DbGFzcy5pbmRleE9mKCAidWktbGktZGl2aWRlciIgKSA8IDAgKSB7CgkJCQljb3VudFBhcmVudCA9IGl0ZW1DbGFzcy5pbmRleE9mKCAidWktbGktc3RhdGljIiApID4gMCA/IGl0ZW0gOiBpdGVtLmZpbmQoICIudWktbGluay1pbmhlcml0IiApOwoKCQkJCWNvdW50UGFyZW50LmFkZENsYXNzKCAidWktbGktanNudW1iZXJpbmciICkKCQkJCQkucHJlcGVuZCggIjxzcGFuIGNsYXNzPSd1aS1saS1kZWMnPiIgKyAoIGNvdW50ZXIrKyApICsgIi4gPC9zcGFuPiIgKTsKCQkJfQoKCQkJLy8gSW5zdGVhZCBvZiBzZXR0aW5nIGl0ZW0gY2xhc3MgZGlyZWN0bHkgb24gdGhlIGxpc3QgaXRlbSBhbmQgaXRzCgkJCS8vIGJ0bi1pbm5lciBhdCB0aGlzIHBvaW50IGluIHRpbWUsIHB1c2ggdGhlIGl0ZW0gaW50byBhIGRpY3Rpb25hcnkKCQkJLy8gdGhhdCB0ZWxscyB1cyB3aGF0IGNsYXNzIHRvIHNldCBvbiBpdCBzbyB3ZSBjYW4gZG8gdGhpcyBhZnRlciB0aGlzCgkJCS8vIHByb2Nlc3NpbmcgbG9vcCBpcyBmaW5pc2hlZC4KCgkJCWlmICggIWl0ZW1DbGFzc0RpY3RbIGl0ZW1DbGFzcyBdICkgewoJCQkJaXRlbUNsYXNzRGljdFsgaXRlbUNsYXNzIF0gPSBbXTsKCQkJfQoKCQkJaXRlbUNsYXNzRGljdFsgaXRlbUNsYXNzIF0ucHVzaCggaXRlbVsgMCBdICk7CgkJfQoKCQkvLyBTZXQgdGhlIGFwcHJvcHJpYXRlIGxpc3R2aWV3IGl0ZW0gY2xhc3NlcyBvbiBlYWNoIGxpc3QgaXRlbQoJCS8vIGFuZCB0aGVpciBidG4taW5uZXIgZWxlbWVudHMuIFRoZSBtYWluIHJlYXNvbiB3ZSBkaWRuJ3QgZG8gdGhpcwoJCS8vIGluIHRoZSBmb3ItbG9vcCBhYm92ZSBpcyBiZWNhdXNlIHdlIGNhbiBlbGltaW5hdGUgcGVyLWl0ZW0gZnVuY3Rpb24gb3ZlcmhlYWQKCQkvLyBieSBjYWxsaW5nIGFkZENsYXNzKCkgYW5kIGNoaWxkcmVuKCkgb25jZSBvciB0d2ljZSBhZnRlcndhcmRzLiBUaGlzCgkJLy8gY2FuIGdpdmUgdXMgYSBzaWduaWZpY2FudCBib29zdCBvbiBwbGF0Zm9ybXMgbGlrZSBXUDcuNS4KCgkJZm9yICggaXRlbUNsYXNzIGluIGl0ZW1DbGFzc0RpY3QgKSB7CgkJCSQoIGl0ZW1DbGFzc0RpY3RbIGl0ZW1DbGFzcyBdICkuYWRkQ2xhc3MoIGl0ZW1DbGFzcyApLmNoaWxkcmVuKCAiLnVpLWJ0bi1pbm5lciIgKS5hZGRDbGFzcyggaXRlbUNsYXNzICk7CgkJfQoKCQkkbGlzdC5maW5kKCAiaDEsIGgyLCBoMywgaDQsIGg1LCBoNiIgKS5hZGRDbGFzcyggInVpLWxpLWhlYWRpbmciICkKCQkJLmVuZCgpCgoJCQkuZmluZCggInAsIGRsIiApLmFkZENsYXNzKCAidWktbGktZGVzYyIgKQoJCQkuZW5kKCkKCgkJCS5maW5kKCAiLnVpLWxpLWFzaWRlIiApLmVhY2goZnVuY3Rpb24oKSB7CgkJCQkJdmFyICR0aGlzID0gJCggdGhpcyApOwoJCQkJCSR0aGlzLnByZXBlbmRUbyggJHRoaXMucGFyZW50KCkgKTsgLy9zaGlmdCBhc2lkZSB0byBmcm9udCBmb3IgY3NzIGZsb2F0CgkJCQl9KQoJCQkuZW5kKCkKCgkJCS5maW5kKCAiLnVpLWxpLWNvdW50IiApLmVhY2goZnVuY3Rpb24oKSB7CgkJCQkJJCggdGhpcyApLmNsb3Nlc3QoICJsaSIgKS5hZGRDbGFzcyggInVpLWxpLWhhcy1jb3VudCIgKTsKCQkJCX0pLmFkZENsYXNzKCAidWktYnRuLXVwLSIgKyAoICRsaXN0LmpxbURhdGEoICJjb3VudHRoZW1lIiApIHx8IHRoaXMub3B0aW9ucy5jb3VudFRoZW1lKSArICIgdWktYnRuLWNvcm5lci1hbGwiICk7CgoJCS8vIFRoZSBpZGVhIGhlcmUgaXMgdG8gbG9vayBhdCB0aGUgZmlyc3QgaW1hZ2UgaW4gdGhlIGxpc3QgaXRlbQoJCS8vIGl0c2VsZiwgYW5kIGFueSAudWktbGluay1pbmhlcml0IGVsZW1lbnQgaXQgbWF5IGNvbnRhaW4sIHNvIHdlCgkJLy8gY2FuIHBsYWNlIHRoZSBhcHByb3ByaWF0ZSBjbGFzc2VzIG9uIHRoZSBpbWFnZSBhbmQgbGlzdCBpdGVtLgoJCS8vIE5vdGUgdGhhdCB3ZSB1c2VkIHRvIHVzZSBzb21ldGhpbmcgbGlrZToKCQkvLwoJCS8vICAgIGxpLmZpbmQoIj5pbWc6ZXEoMCksIC51aS1saW5rLWluaGVyaXQ+aW1nOmVxKDApIikuZWFjaCggLi4uICk7CgkJLy8KCQkvLyBCdXQgZXhlY3V0aW5nIGEgZmluZCgpIGxpa2UgdGhhdCBvbiBXaW5kb3dzIFBob25lIDcuNSB0b29rIGEKCQkvLyByZWFsbHkgbG9uZyB0aW1lLiBXYWxraW5nIHRoaW5ncyBtYW51YWxseSB3aXRoIHRoZSBjb2RlIGJlbG93CgkJLy8gYWxsb3dzIHRoZSA0MDAgbGlzdHZpZXcgaXRlbSBwYWdlIHRvIGxvYWQgaW4gYWJvdXQgMyBzZWNvbmRzIGFzCgkJLy8gb3Bwb3NlZCB0byAzMCBzZWNvbmRzLgoKCQl0aGlzLl9hZGRUaHVtYkNsYXNzZXMoIGxpICk7CgkJdGhpcy5fYWRkVGh1bWJDbGFzc2VzKCAkbGlzdC5maW5kKCAiLnVpLWxpbmstaW5oZXJpdCIgKSApOwoKCQl0aGlzLl9yZWZyZXNoQ29ybmVycyggY3JlYXRlICk7CgogICAgLy8gYXV0b2RpdmlkZXJzIGJpbmRzIHRvIHRoaXMgdG8gcmVkcmF3IGRpdmlkZXJzIGFmdGVyIHRoZSBsaXN0dmlldyByZWZyZXNoCgkJdGhpcy5fdHJpZ2dlciggImFmdGVycmVmcmVzaCIgKTsKCX0sCgoJLy9jcmVhdGUgYSBzdHJpbmcgZm9yIElEL3N1YnBhZ2UgdXJsIGNyZWF0aW9uCglfaWRTdHJpbmdFc2NhcGU6IGZ1bmN0aW9uKCBzdHIgKSB7CgkJcmV0dXJuIHN0ci5yZXBsYWNlKC9bXmEtekEtWjAtOV0vZywgJy0nKTsKCX0sCgoJX2NyZWF0ZVN1YlBhZ2VzOiBmdW5jdGlvbigpIHsKCQl2YXIgcGFyZW50TGlzdCA9IHRoaXMuZWxlbWVudCwKCQkJcGFyZW50UGFnZSA9IHBhcmVudExpc3QuY2xvc2VzdCggIi51aS1wYWdlIiApLAoJCQlwYXJlbnRVcmwgPSBwYXJlbnRQYWdlLmpxbURhdGEoICJ1cmwiICksCgkJCXBhcmVudElkID0gcGFyZW50VXJsIHx8IHBhcmVudFBhZ2VbIDAgXVsgJC5leHBhbmRvIF0sCgkJCXBhcmVudExpc3RJZCA9IHBhcmVudExpc3QuYXR0ciggImlkIiApLAoJCQlvID0gdGhpcy5vcHRpb25zLAoJCQlkbnMgPSAiZGF0YS0iICsgJC5tb2JpbGUubnMsCgkJCXNlbGYgPSB0aGlzLAoJCQlwZXJzaXN0ZW50Rm9vdGVySUQgPSBwYXJlbnRQYWdlLmZpbmQoICI6anFtRGF0YShyb2xlPSdmb290ZXInKSIgKS5qcW1EYXRhKCAiaWQiICksCgkJCWhhc1N1YlBhZ2VzOwoKCQlpZiAoIHR5cGVvZiBsaXN0Q291bnRQZXJQYWdlWyBwYXJlbnRJZCBdID09PSAidW5kZWZpbmVkIiApIHsKCQkJbGlzdENvdW50UGVyUGFnZVsgcGFyZW50SWQgXSA9IC0xOwoJCX0KCgkJcGFyZW50TGlzdElkID0gcGFyZW50TGlzdElkIHx8ICsrbGlzdENvdW50UGVyUGFnZVsgcGFyZW50SWQgXTsKCgkJJCggcGFyZW50TGlzdC5maW5kKCAibGk+dWwsIGxpPm9sIiApLnRvQXJyYXkoKS5yZXZlcnNlKCkgKS5lYWNoKGZ1bmN0aW9uKCBpICkgewoJCQl2YXIgc2VsZiA9IHRoaXMsCgkJCQlsaXN0ID0gJCggdGhpcyApLAoJCQkJbGlzdElkID0gbGlzdC5hdHRyKCAiaWQiICkgfHwgcGFyZW50TGlzdElkICsgIi0iICsgaSwKCQkJCXBhcmVudCA9IGxpc3QucGFyZW50KCksCgkJCQlub2RlRWxzRnVsbCA9ICQoIGxpc3QucHJldkFsbCgpLnRvQXJyYXkoKS5yZXZlcnNlKCkgKSwKCQkJCW5vZGVFbHMgPSBub2RlRWxzRnVsbC5sZW5ndGggPyBub2RlRWxzRnVsbCA6ICQoICI8c3Bhbj4iICsgJC50cmltKHBhcmVudC5jb250ZW50cygpWyAwIF0ubm9kZVZhbHVlKSArICI8L3NwYW4+IiApLAoJCQkJdGl0bGUgPSBub2RlRWxzLmZpcnN0KCkuZ2V0RW5jb2RlZFRleHQoKSwvL3VybCBsaW1pdHMgdG8gZmlyc3QgMzAgY2hhcnMgb2YgdGV4dAoJCQkJaWQgPSAoIHBhcmVudFVybCB8fCAiIiApICsgIiYiICsgJC5tb2JpbGUuc3ViUGFnZVVybEtleSArICI9IiArIGxpc3RJZCwKCQkJCXRoZW1lID0gbGlzdC5qcW1EYXRhKCAidGhlbWUiICkgfHwgby50aGVtZSwKCQkJCWNvdW50VGhlbWUgPSBsaXN0LmpxbURhdGEoICJjb3VudHRoZW1lIiApIHx8IHBhcmVudExpc3QuanFtRGF0YSggImNvdW50dGhlbWUiICkgfHwgby5jb3VudFRoZW1lLAoJCQkJbmV3UGFnZSwgYW5jaG9yOwoKCQkJLy9kZWZpbmUgaGFzU3ViUGFnZXMgZm9yIHVzZSBpbiBsYXRlciByZW1vdmFsCgkJCWhhc1N1YlBhZ2VzID0gdHJ1ZTsKCgkJCW5ld1BhZ2UgPSBsaXN0LmRldGFjaCgpCgkJCQkJCS53cmFwKCAiPGRpdiAiICsgZG5zICsgInJvbGU9J3BhZ2UnICIgKyBkbnMgKyAidXJsPSciICsgaWQgKyAiJyAiICsgZG5zICsgInRoZW1lPSciICsgdGhlbWUgKyAiJyAiICsgZG5zICsgImNvdW50LXRoZW1lPSciICsgY291bnRUaGVtZSArICInPjxkaXYgIiArIGRucyArICJyb2xlPSdjb250ZW50Jz48L2Rpdj48L2Rpdj4iICkKCQkJCQkJLnBhcmVudCgpCgkJCQkJCQkuYmVmb3JlKCAiPGRpdiAiICsgZG5zICsgInJvbGU9J2hlYWRlcicgIiArIGRucyArICJ0aGVtZT0nIiArIG8uaGVhZGVyVGhlbWUgKyAiJz48ZGl2IGNsYXNzPSd1aS10aXRsZSc+IiArIHRpdGxlICsgIjwvZGl2PjwvZGl2PiIgKQoJCQkJCQkJLmFmdGVyKCBwZXJzaXN0ZW50Rm9vdGVySUQgPyAkKCAiPGRpdiAiICsgZG5zICsgInJvbGU9J2Zvb3RlcicgIiArIGRucyArICJpZD0nIisgcGVyc2lzdGVudEZvb3RlcklEICsiJz4iICkgOiAiIiApCgkJCQkJCQkucGFyZW50KCkKCQkJCQkJCQkuYXBwZW5kVG8oICQubW9iaWxlLnBhZ2VDb250YWluZXIgKTsKCgkJCW5ld1BhZ2UucGFnZSgpOwoKCQkJYW5jaG9yID0gcGFyZW50LmZpbmQoICdhOmZpcnN0JyApOwoKCQkJaWYgKCAhYW5jaG9yLmxlbmd0aCApIHsKCQkJCWFuY2hvciA9ICQoICI8YS8+IiApLmh0bWwoIG5vZGVFbHMgfHwgdGl0bGUgKS5wcmVwZW5kVG8oIHBhcmVudC5lbXB0eSgpICk7CgkJCX0KCgkJCWFuY2hvci5hdHRyKCAiaHJlZiIsICIjIiArIGlkICk7CgoJCX0pLmxpc3R2aWV3KCk7CgoJCS8vIG9uIHBhZ2VoaWRlLCByZW1vdmUgYW55IG5lc3RlZCBwYWdlcyBhbG9uZyB3aXRoIHRoZSBwYXJlbnQgcGFnZSwgYXMgbG9uZyBhcyB0aGV5IGFyZW4ndCBhY3RpdmUKCQkvLyBhbmQgYXJlbid0IGVtYmVkZGVkCgkJaWYgKCBoYXNTdWJQYWdlcyAmJgoJCQlwYXJlbnRQYWdlLmlzKCAiOmpxbURhdGEoZXh0ZXJuYWwtcGFnZT0ndHJ1ZScpIiApICYmCgkJCXBhcmVudFBhZ2UuZGF0YSggInBhZ2UiICkub3B0aW9ucy5kb21DYWNoZSA9PT0gZmFsc2UgKSB7CgoJCQl2YXIgbmV3UmVtb3ZlID0gZnVuY3Rpb24oIGUsIHVpICkgewoJCQkJdmFyIG5leHRQYWdlID0gdWkubmV4dFBhZ2UsIG5wVVJMLAoJCQkJCXByRXZlbnQgPSBuZXcgJC5FdmVudCggInBhZ2VyZW1vdmUiICk7CgoJCQkJaWYgKCB1aS5uZXh0UGFnZSApIHsKCQkJCQlucFVSTCA9IG5leHRQYWdlLmpxbURhdGEoICJ1cmwiICk7CgkJCQkJaWYgKCBucFVSTC5pbmRleE9mKCBwYXJlbnRVcmwgKyAiJiIgKyAkLm1vYmlsZS5zdWJQYWdlVXJsS2V5ICkgIT09IDAgKSB7CgkJCQkJCXNlbGYuY2hpbGRQYWdlcygpLnJlbW92ZSgpOwoJCQkJCQlwYXJlbnRQYWdlLnRyaWdnZXIoIHByRXZlbnQgKTsKCQkJCQkJaWYgKCAhcHJFdmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJCQkJCXBhcmVudFBhZ2UucmVtb3ZlV2l0aERlcGVuZGVudHMoKTsKCQkJCQkJfQoJCQkJCX0KCQkJCX0KCQkJfTsKCgkJCS8vIHVuYmluZCB0aGUgb3JpZ2luYWwgcGFnZSByZW1vdmUgYW5kIHJlcGxhY2Ugd2l0aCBvdXIgc3BlY2lhbGl6ZWQgdmVyc2lvbgoJCQlwYXJlbnRQYWdlCgkJCQkudW5iaW5kKCAicGFnZWhpZGUucmVtb3ZlIiApCgkJCQkuYmluZCggInBhZ2VoaWRlLnJlbW92ZSIsIG5ld1JlbW92ZSk7CgkJfQoJfSwKCgkvLyBUT0RPIHNvcnQgb3V0IGEgYmV0dGVyIHdheSB0byB0cmFjayBzdWIgcGFnZXMgb2YgdGhlIGxpc3R2aWV3IHRoaXMgaXMgYnJpdHRsZQoJY2hpbGRQYWdlczogZnVuY3Rpb24oKSB7CgkJdmFyIHBhcmVudFVybCA9IHRoaXMucGFyZW50UGFnZS5qcW1EYXRhKCAidXJsIiApOwoKCQlyZXR1cm4gJCggIjpqcW1EYXRhKHVybF49JyIrICBwYXJlbnRVcmwgKyAiJiIgKyAkLm1vYmlsZS5zdWJQYWdlVXJsS2V5ICsgIicpIiApOwoJfQp9KTsKCi8vYXV0byBzZWxmLWluaXQgd2lkZ2V0cwokKCBkb2N1bWVudCApLmJpbmQoICJwYWdlY3JlYXRlIGNyZWF0ZSIsIGZ1bmN0aW9uKCBlICkgewoJJC5tb2JpbGUubGlzdHZpZXcucHJvdG90eXBlLmVuaGFuY2VXaXRoaW4oIGUudGFyZ2V0ICk7Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS5saXN0dmlldy5wcm90b3R5cGUub3B0aW9ucy5hdXRvZGl2aWRlcnMgPSBmYWxzZTsKJC5tb2JpbGUubGlzdHZpZXcucHJvdG90eXBlLm9wdGlvbnMuYXV0b2RpdmlkZXJzU2VsZWN0b3IgPSBmdW5jdGlvbiggZWx0ICkgewoJLy8gbG9vayBmb3IgdGhlIHRleHQgaW4gdGhlIGdpdmVuIGVsZW1lbnQKCXZhciB0ZXh0ID0gZWx0LnRleHQoKSB8fCBudWxsOwoKCWlmICggIXRleHQgKSB7CgkJcmV0dXJuIG51bGw7Cgl9CgoJLy8gY3JlYXRlIHRoZSB0ZXh0IGZvciB0aGUgZGl2aWRlciAoZmlyc3QgdXBwZXJjYXNlZCBsZXR0ZXIpCgl0ZXh0ID0gdGV4dC5zbGljZSggMCwgMSApLnRvVXBwZXJDYXNlKCk7CgoJcmV0dXJuIHRleHQ7Cn07CgokKCBkb2N1bWVudCApLmRlbGVnYXRlKCAidWwsb2wiLCAibGlzdHZpZXdjcmVhdGUiLCBmdW5jdGlvbigpIHsKCgl2YXIgbGlzdCA9ICQoIHRoaXMgKSwKCQkJbGlzdHZpZXcgPSBsaXN0LmRhdGEoICJsaXN0dmlldyIgKTsKCglpZiAoICFsaXN0dmlldyB8fCAhbGlzdHZpZXcub3B0aW9ucy5hdXRvZGl2aWRlcnMgKSB7CgkJcmV0dXJuOwoJfQoKCXZhciByZXBsYWNlRGl2aWRlcnMgPSBmdW5jdGlvbiAoKSB7CgkJbGlzdC5maW5kKCAibGk6anFtRGF0YShyb2xlPSdsaXN0LWRpdmlkZXInKSIgKS5yZW1vdmUoKTsKCgkJdmFyIGxpcyA9IGxpc3QuZmluZCggJ2xpJyApLAoJCQlsYXN0RGl2aWRlclRleHQgPSBudWxsLCBsaSwgZGl2aWRlclRleHQ7CgoJCWZvciAoIHZhciBpID0gMDsgaSA8IGxpcy5sZW5ndGggOyBpKysgKSB7CgkJCWxpID0gbGlzW2ldOwoJCQlkaXZpZGVyVGV4dCA9IGxpc3R2aWV3Lm9wdGlvbnMuYXV0b2RpdmlkZXJzU2VsZWN0b3IoICQoIGxpICkgKTsKCgkJCWlmICggZGl2aWRlclRleHQgJiYgbGFzdERpdmlkZXJUZXh0ICE9PSBkaXZpZGVyVGV4dCApIHsKCQkJCXZhciBkaXZpZGVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggJ2xpJyApOwoJCQkJZGl2aWRlci5hcHBlbmRDaGlsZCggZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoIGRpdmlkZXJUZXh0ICkgKTsKCQkJCWRpdmlkZXIuc2V0QXR0cmlidXRlKCAnZGF0YS0nICsgJC5tb2JpbGUubnMgKyAncm9sZScsICdsaXN0LWRpdmlkZXInICk7CgkJCQlsaS5wYXJlbnROb2RlLmluc2VydEJlZm9yZSggZGl2aWRlciwgbGkgKTsKCQkJfQoKCQkJbGFzdERpdmlkZXJUZXh0ID0gZGl2aWRlclRleHQ7CgkJfQoJfTsKCgl2YXIgYWZ0ZXJMaXN0dmlld1JlZnJlc2ggPSBmdW5jdGlvbiAoKSB7CgkJbGlzdC51bmJpbmQoICdsaXN0dmlld2FmdGVycmVmcmVzaCcsIGFmdGVyTGlzdHZpZXdSZWZyZXNoICk7CgkJcmVwbGFjZURpdmlkZXJzKCk7CgkJbGlzdHZpZXcucmVmcmVzaCgpOwoJCWxpc3QuYmluZCggJ2xpc3R2aWV3YWZ0ZXJyZWZyZXNoJywgYWZ0ZXJMaXN0dmlld1JlZnJlc2ggKTsKCX07CgoJYWZ0ZXJMaXN0dmlld1JlZnJlc2goKTsKfSk7Cgp9KSggalF1ZXJ5ICk7CgovKgoqICJjaGVja2JveHJhZGlvIiBwbHVnaW4KKi8KCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUuY2hlY2tib3hyYWRpbyIsICQubW9iaWxlLndpZGdldCwgewoJb3B0aW9uczogewoJCXRoZW1lOiBudWxsLAoJCWluaXRTZWxlY3RvcjogImlucHV0W3R5cGU9J2NoZWNrYm94J10saW5wdXRbdHlwZT0ncmFkaW8nXSIKCX0sCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXMsCgkJCWlucHV0ID0gdGhpcy5lbGVtZW50LAoJCQlpbmhlcml0QXR0ciA9IGZ1bmN0aW9uKCBpbnB1dCwgZGF0YUF0dHIgKSB7CgkJCQlyZXR1cm4gaW5wdXQuanFtRGF0YSggZGF0YUF0dHIgKSB8fCBpbnB1dC5jbG9zZXN0KCAiZm9ybSwgZmllbGRzZXQiICkuanFtRGF0YSggZGF0YUF0dHIgKTsKCQkJfSwKCQkJLy8gTk9URTogV2luZG93cyBQaG9uZSBjb3VsZCBub3QgZmluZCB0aGUgbGFiZWwgdGhyb3VnaCBhIHNlbGVjdG9yCgkJCS8vIGZpbHRlciB3b3JrcyB0aG91Z2guCgkJCXBhcmVudExhYmVsID0gJCggaW5wdXQgKS5jbG9zZXN0KCAibGFiZWwiICksCgkJCWxhYmVsID0gcGFyZW50TGFiZWwubGVuZ3RoID8gcGFyZW50TGFiZWwgOiAkKCBpbnB1dCApLmNsb3Nlc3QoICJmb3JtLCBmaWVsZHNldCwgOmpxbURhdGEocm9sZT0ncGFnZScpLCA6anFtRGF0YShyb2xlPSdkaWFsb2cnKSIgKS5maW5kKCAibGFiZWwiICkuZmlsdGVyKCAiW2Zvcj0nIiArIGlucHV0WzBdLmlkICsgIiddIiApLmZpcnN0KCksCgkJCWlucHV0dHlwZSA9IGlucHV0WzBdLnR5cGUsCgkJCW1pbmkgPSBpbmhlcml0QXR0ciggaW5wdXQsICJtaW5pIiApLAoJCQljaGVja2VkU3RhdGUgPSBpbnB1dHR5cGUgKyAiLW9uIiwKCQkJdW5jaGVja2VkU3RhdGUgPSBpbnB1dHR5cGUgKyAiLW9mZiIsCgkJCWljb24gPSBpbnB1dC5wYXJlbnRzKCAiOmpxbURhdGEodHlwZT0naG9yaXpvbnRhbCcpIiApLmxlbmd0aCA/IHVuZGVmaW5lZCA6IHVuY2hlY2tlZFN0YXRlLAoJCQlpY29ucG9zID0gaW5oZXJpdEF0dHIoIGlucHV0LCAiaWNvbnBvcyIgKSwKCQkJYWN0aXZlQnRuID0gaWNvbiA/ICIiIDogIiAiICsgJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MsCgkJCWNoZWNrZWRDbGFzcyA9ICJ1aS0iICsgY2hlY2tlZFN0YXRlICsgYWN0aXZlQnRuLAoJCQl1bmNoZWNrZWRDbGFzcyA9ICJ1aS0iICsgdW5jaGVja2VkU3RhdGUsCgkJCWNoZWNrZWRpY29uID0gInVpLWljb24tIiArIGNoZWNrZWRTdGF0ZSwKCQkJdW5jaGVja2VkaWNvbiA9ICJ1aS1pY29uLSIgKyB1bmNoZWNrZWRTdGF0ZTsKCgkJaWYgKCBpbnB1dHR5cGUgIT09ICJjaGVja2JveCIgJiYgaW5wdXR0eXBlICE9PSAicmFkaW8iICkgewoJCQlyZXR1cm47CgkJfQoKCQkvLyBFeHBvc2UgZm9yIG90aGVyIG1ldGhvZHMKCQkkLmV4dGVuZCggdGhpcywgewoJCQlsYWJlbDogbGFiZWwsCgkJCWlucHV0dHlwZTogaW5wdXR0eXBlLAoJCQljaGVja2VkQ2xhc3M6IGNoZWNrZWRDbGFzcywKCQkJdW5jaGVja2VkQ2xhc3M6IHVuY2hlY2tlZENsYXNzLAoJCQljaGVja2VkaWNvbjogY2hlY2tlZGljb24sCgkJCXVuY2hlY2tlZGljb246IHVuY2hlY2tlZGljb24KCQl9KTsKCgkJLy8gSWYgdGhlcmUncyBubyBzZWxlY3RlZCB0aGVtZSBjaGVjayB0aGUgZGF0YSBhdHRyCgkJaWYgKCAhdGhpcy5vcHRpb25zLnRoZW1lICkgewoJCQl0aGlzLm9wdGlvbnMudGhlbWUgPSAkLm1vYmlsZS5nZXRJbmhlcml0ZWRUaGVtZSggdGhpcy5lbGVtZW50LCAiYyIgKTsKCQl9CgoJCWxhYmVsLmJ1dHRvbk1hcmt1cCh7CgkJCXRoZW1lOiB0aGlzLm9wdGlvbnMudGhlbWUsCgkJCWljb246IGljb24sCgkJCXNoYWRvdzogZmFsc2UsCgkJCW1pbmk6IG1pbmksCgkJCWljb25wb3M6IGljb25wb3MKCQl9KTsKCgkJLy8gV3JhcCB0aGUgaW5wdXQgKyBsYWJlbCBpbiBhIGRpdgoJCXZhciB3cmFwcGVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CgkJd3JhcHBlci5jbGFzc05hbWUgPSAndWktJyArIGlucHV0dHlwZTsKCgkJaW5wdXQuYWRkKCBsYWJlbCApLndyYXBBbGwoIHdyYXBwZXIgKTsKCgkJbGFiZWwuYmluZCh7CgkJCXZtb3VzZW92ZXI6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCWlmICggJCggdGhpcyApLnBhcmVudCgpLmlzKCAiLnVpLWRpc2FibGVkIiApICkgewoJCQkJCWV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOwoJCQkJfQoJCQl9LAoKCQkJdmNsaWNrOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQlpZiAoIGlucHV0LmlzKCAiOmRpc2FibGVkIiApICkgewoJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCXNlbGYuX2NhY2hlVmFscygpOwoKCQkJCWlucHV0LnByb3AoICJjaGVja2VkIiwgaW5wdXR0eXBlID09PSAicmFkaW8iICYmIHRydWUgfHwgIWlucHV0LnByb3AoICJjaGVja2VkIiApICk7CgoJCQkJLy8gdHJpZ2dlciBjbGljayBoYW5kbGVyJ3MgYm91bmQgZGlyZWN0bHkgdG8gdGhlIGlucHV0IGFzIGEgc3Vic3RpdHV0ZSBmb3IKCQkJCS8vIGhvdyBsYWJlbCBjbGlja3MgYmVoYXZlIG5vcm1hbGx5IGluIHRoZSBicm93c2VycwoJCQkJLy8gVE9ETzogaXQgd291bGQgYmUgbmljZSB0byBsZXQgdGhlIGJyb3dzZXIncyBoYW5kbGUgdGhlIGNsaWNrcyBhbmQgcGFzcyB0aGVtCgkJCQkvLyAgICAgICB0aHJvdWdoIHRvIHRoZSBhc3NvY2lhdGUgaW5wdXQuIHdlIGNhbiBzd2FsbG93IHRoYXQgY2xpY2sgYXQgdGhlIHBhcmVudAoJCQkJLy8gICAgICAgd3JhcHBlciBlbGVtZW50IGxldmVsCgkJCQlpbnB1dC50cmlnZ2VySGFuZGxlciggJ2NsaWNrJyApOwoKCQkJCS8vIElucHV0IHNldCBmb3IgY29tbW9uIHJhZGlvIGJ1dHRvbnMgd2lsbCBjb250YWluIGFsbCB0aGUgcmFkaW8KCQkJCS8vIGJ1dHRvbnMsIGJ1dCB3aWxsIG5vdCBmb3IgY2hlY2tib3hlcy4gY2xlYXJpbmcgdGhlIGNoZWNrZWQgc3RhdHVzCgkJCQkvLyBvZiBvdGhlciByYWRpb3MgZW5zdXJlcyB0aGUgYWN0aXZlIGJ1dHRvbiBzdGF0ZSBpcyBhcHBsaWVkIHByb3Blcmx5CgkJCQlzZWxmLl9nZXRJbnB1dFNldCgpLm5vdCggaW5wdXQgKS5wcm9wKCAiY2hlY2tlZCIsIGZhbHNlICk7CgoJCQkJc2VsZi5fdXBkYXRlQWxsKCk7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCQl9KTsKCgkJaW5wdXQKCQkJLmJpbmQoewoJCQkJdm1vdXNlZG93bjogZnVuY3Rpb24oKSB7CgkJCQkJc2VsZi5fY2FjaGVWYWxzKCk7CgkJCQl9LAoKCQkJCXZjbGljazogZnVuY3Rpb24oKSB7CgkJCQkJdmFyICR0aGlzID0gJCggdGhpcyApOwoKCQkJCQkvLyBBZGRzIGNoZWNrZWQgYXR0cmlidXRlIHRvIGNoZWNrZWQgaW5wdXQgd2hlbiBrZXlib2FyZCBpcyB1c2VkCgkJCQkJaWYgKCAkdGhpcy5pcyggIjpjaGVja2VkIiApICkgewoKCQkJCQkJJHRoaXMucHJvcCggImNoZWNrZWQiLCB0cnVlKTsKCQkJCQkJc2VsZi5fZ2V0SW5wdXRTZXQoKS5ub3QoICR0aGlzICkucHJvcCggImNoZWNrZWQiLCBmYWxzZSApOwoJCQkJCX0gZWxzZSB7CgoJCQkJCQkkdGhpcy5wcm9wKCAiY2hlY2tlZCIsIGZhbHNlICk7CgkJCQkJfQoKCQkJCQlzZWxmLl91cGRhdGVBbGwoKTsKCQkJCX0sCgoJCQkJZm9jdXM6IGZ1bmN0aW9uKCkgewoJCQkJCWxhYmVsLmFkZENsYXNzKCAkLm1vYmlsZS5mb2N1c0NsYXNzICk7CgkJCQl9LAoKCQkJCWJsdXI6IGZ1bmN0aW9uKCkgewoJCQkJCWxhYmVsLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5mb2N1c0NsYXNzICk7CgkJCQl9CgkJCX0pOwoKCQl0aGlzLnJlZnJlc2goKTsKCX0sCgoJX2NhY2hlVmFsczogZnVuY3Rpb24oKSB7CgkJdGhpcy5fZ2V0SW5wdXRTZXQoKS5lYWNoKGZ1bmN0aW9uKCkgewoJCQkkKCB0aGlzICkuanFtRGF0YSggImNhY2hlVmFsIiwgdGhpcy5jaGVja2VkICk7CgkJfSk7Cgl9LAoKCS8vcmV0dXJucyBlaXRoZXIgYSBzZXQgb2YgcmFkaW9zIHdpdGggdGhlIHNhbWUgbmFtZSBhdHRyaWJ1dGUsIG9yIGEgc2luZ2xlIGNoZWNrYm94CglfZ2V0SW5wdXRTZXQ6IGZ1bmN0aW9uKCkgewoJCWlmICggdGhpcy5pbnB1dHR5cGUgPT09ICJjaGVja2JveCIgKSB7CgkJCXJldHVybiB0aGlzLmVsZW1lbnQ7CgkJfQoKCQlyZXR1cm4gdGhpcy5lbGVtZW50LmNsb3Nlc3QoICJmb3JtLCBmaWVsZHNldCwgOmpxbURhdGEocm9sZT0ncGFnZScpLCA6anFtRGF0YShyb2xlPSdkaWFsb2cnKSIgKQoJCQkuZmluZCggImlucHV0W25hbWU9JyIgKyB0aGlzLmVsZW1lbnRbMF0ubmFtZSArICInXVt0eXBlPSciICsgdGhpcy5pbnB1dHR5cGUgKyAiJ10iICk7Cgl9LAoKCV91cGRhdGVBbGw6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpczsKCgkJdGhpcy5fZ2V0SW5wdXRTZXQoKS5lYWNoKGZ1bmN0aW9uKCkgewoJCQl2YXIgJHRoaXMgPSAkKCB0aGlzICk7CgoJCQlpZiAoIHRoaXMuY2hlY2tlZCB8fCBzZWxmLmlucHV0dHlwZSA9PT0gImNoZWNrYm94IiApIHsKCQkJCSR0aGlzLnRyaWdnZXIoICJjaGFuZ2UiICk7CgkJCX0KCQl9KQoJCS5jaGVja2JveHJhZGlvKCAicmVmcmVzaCIgKTsKCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJdmFyIGlucHV0ID0gdGhpcy5lbGVtZW50WzBdLAoJCQlsYWJlbCA9IHRoaXMubGFiZWwsCgkJCWljb24gPSBsYWJlbC5maW5kKCAiLnVpLWljb24iICk7CgoJCWlmICggaW5wdXQuY2hlY2tlZCApIHsKCQkJbGFiZWwuYWRkQ2xhc3MoIHRoaXMuY2hlY2tlZENsYXNzICkucmVtb3ZlQ2xhc3MoIHRoaXMudW5jaGVja2VkQ2xhc3MgKTsKCQkJaWNvbi5hZGRDbGFzcyggdGhpcy5jaGVja2VkaWNvbiApLnJlbW92ZUNsYXNzKCB0aGlzLnVuY2hlY2tlZGljb24gKTsKCQl9IGVsc2UgewoJCQlsYWJlbC5yZW1vdmVDbGFzcyggdGhpcy5jaGVja2VkQ2xhc3MgKS5hZGRDbGFzcyggdGhpcy51bmNoZWNrZWRDbGFzcyApOwoJCQlpY29uLnJlbW92ZUNsYXNzKCB0aGlzLmNoZWNrZWRpY29uICkuYWRkQ2xhc3MoIHRoaXMudW5jaGVja2VkaWNvbiApOwoJCX0KCgkJaWYgKCBpbnB1dC5kaXNhYmxlZCApIHsKCQkJdGhpcy5kaXNhYmxlKCk7CgkJfSBlbHNlIHsKCQkJdGhpcy5lbmFibGUoKTsKCQl9Cgl9LAoKCWRpc2FibGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuZWxlbWVudC5wcm9wKCAiZGlzYWJsZWQiLCB0cnVlICkucGFyZW50KCkuYWRkQ2xhc3MoICJ1aS1kaXNhYmxlZCIgKTsKCX0sCgoJZW5hYmxlOiBmdW5jdGlvbigpIHsKCQl0aGlzLmVsZW1lbnQucHJvcCggImRpc2FibGVkIiwgZmFsc2UgKS5wYXJlbnQoKS5yZW1vdmVDbGFzcyggInVpLWRpc2FibGVkIiApOwoJfQp9KTsKCi8vYXV0byBzZWxmLWluaXQgd2lkZ2V0cwokKCBkb2N1bWVudCApLmJpbmQoICJwYWdlY3JlYXRlIGNyZWF0ZSIsIGZ1bmN0aW9uKCBlICkgewoJJC5tb2JpbGUuY2hlY2tib3hyYWRpby5wcm90b3R5cGUuZW5oYW5jZVdpdGhpbiggZS50YXJnZXQsIHRydWUgKTsKfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLmJ1dHRvbiIsICQubW9iaWxlLndpZGdldCwgewoJb3B0aW9uczogewoJCXRoZW1lOiBudWxsLAoJCWljb246IG51bGwsCgkJaWNvbnBvczogbnVsbCwKCQljb3JuZXJzOiB0cnVlLAoJCXNoYWRvdzogdHJ1ZSwKCQlpY29uc2hhZG93OiB0cnVlLAoJCWluaXRTZWxlY3RvcjogImJ1dHRvbiwgW3R5cGU9J2J1dHRvbiddLCBbdHlwZT0nc3VibWl0J10sIFt0eXBlPSdyZXNldCddIgoJfSwKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXZhciAkZWwgPSB0aGlzLmVsZW1lbnQsCgkJCSRidXR0b24sCgkJCW8gPSB0aGlzLm9wdGlvbnMsCgkJCXR5cGUsCgkJCW5hbWUsCgkJCWlubGluZSA9IG8uaW5saW5lIHx8ICRlbC5qcW1EYXRhKCAiaW5saW5lIiApLAoJCQltaW5pID0gby5taW5pIHx8ICRlbC5qcW1EYXRhKCAibWluaSIgKSwKCQkJY2xhc3NlcyA9ICIiLAoJCQkkYnV0dG9uUGxhY2Vob2xkZXI7CgoJCS8vIGlmIHRoaXMgaXMgYSBsaW5rLCBjaGVjayBpZiBpdCdzIGJlZW4gZW5oYW5jZWQgYW5kLCBpZiBub3QsIHVzZSB0aGUgcmlnaHQgZnVuY3Rpb24KCQlpZiAoICRlbFsgMCBdLnRhZ05hbWUgPT09ICJBIiApIHsKCQkJaWYgKCAhJGVsLmhhc0NsYXNzKCAidWktYnRuIiApICkgewoJCQkJJGVsLmJ1dHRvbk1hcmt1cCgpOwoJCQl9CgoJCQlyZXR1cm47CgkJfQoKCQkvLyBnZXQgdGhlIGluaGVyaXRlZCB0aGVtZQoJCS8vIFRPRE8gY2VudHJhbGl6ZSBmb3IgYWxsIHdpZGdldHMKCQlpZiAoICF0aGlzLm9wdGlvbnMudGhlbWUgKSB7CgkJCXRoaXMub3B0aW9ucy50aGVtZSA9ICQubW9iaWxlLmdldEluaGVyaXRlZFRoZW1lKCB0aGlzLmVsZW1lbnQsICJjIiApOwoJCX0KCgkJLy8gVE9ETzogUG9zdCAxLjEtLW9uY2Ugd2UgaGF2ZSB0aW1lIHRvIHRlc3QgdGhvcm91Z2hseS0tYW55IGNsYXNzZXMgbWFudWFsbHkgYXBwbGllZCB0byB0aGUgb3JpZ2luYWwgZWxlbWVudCBzaG91bGQgYmUgY2FycmllZCBvdmVyIHRvIHRoZSBlbmhhbmNlZCBlbGVtZW50LCB3aXRoIGFuIGAtZW5oYW5jZWRgIHN1ZmZpeC4gU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5LW1vYmlsZS9pc3N1ZXMvMzU3NwoJCS8qIGlmICggJGVsWzBdLmNsYXNzTmFtZS5sZW5ndGggKSB7CgkJCWNsYXNzZXMgPSAkZWxbMF0uY2xhc3NOYW1lOwoJCX0gKi8KCQlpZiAoICEhfiRlbFswXS5jbGFzc05hbWUuaW5kZXhPZiggInVpLWJ0bi1sZWZ0IiApICkgewoJCQljbGFzc2VzID0gInVpLWJ0bi1sZWZ0IjsKCQl9CgoJCWlmICggICEhfiRlbFswXS5jbGFzc05hbWUuaW5kZXhPZiggInVpLWJ0bi1yaWdodCIgKSApIHsKCQkJY2xhc3NlcyA9ICJ1aS1idG4tcmlnaHQiOwoJCX0KCgkJaWYgKCAgJGVsLmF0dHIoICJ0eXBlIiApID09PSAic3VibWl0IiB8fCAkZWwuYXR0ciggInR5cGUiICkgPT09ICJyZXNldCIgKSB7CgkJCWNsYXNzZXMgPyBjbGFzc2VzICs9ICIgdWktc3VibWl0IiA6ICBjbGFzc2VzID0gInVpLXN1Ym1pdCI7CgkJfQoJCSQoICJsYWJlbFtmb3I9JyIgKyAkZWwuYXR0ciggImlkIiApICsgIiddIiApLmFkZENsYXNzKCAidWktc3VibWl0IiApOwoKCQkvLyBBZGQgQVJJQSByb2xlCgkJdGhpcy5idXR0b24gPSAkKCAiPGRpdj48L2Rpdj4iICkKCQkJWyAkZWwuaHRtbCgpID8gImh0bWwiIDogInRleHQiIF0oICRlbC5odG1sKCkgfHwgJGVsLnZhbCgpICkKCQkJLmluc2VydEJlZm9yZSggJGVsICkKCQkJLmJ1dHRvbk1hcmt1cCh7CgkJCQl0aGVtZTogby50aGVtZSwKCQkJCWljb246IG8uaWNvbiwKCQkJCWljb25wb3M6IG8uaWNvbnBvcywKCQkJCWlubGluZTogaW5saW5lLAoJCQkJY29ybmVyczogby5jb3JuZXJzLAoJCQkJc2hhZG93OiBvLnNoYWRvdywKCQkJCWljb25zaGFkb3c6IG8uaWNvbnNoYWRvdywKCQkJCW1pbmk6IG1pbmkKCQkJfSkKCQkJLmFkZENsYXNzKCBjbGFzc2VzICkKCQkJLmFwcGVuZCggJGVsLmFkZENsYXNzKCAidWktYnRuLWhpZGRlbiIgKSApOwoKICAgICAgICAkYnV0dG9uID0gdGhpcy5idXR0b247CgkJdHlwZSA9ICRlbC5hdHRyKCAidHlwZSIgKTsKCQluYW1lID0gJGVsLmF0dHIoICJuYW1lIiApOwoKCQkvLyBBZGQgaGlkZGVuIGlucHV0IGR1cmluZyBzdWJtaXQgaWYgaW5wdXQgdHlwZT0ic3VibWl0IiBoYXMgYSBuYW1lLgoJCWlmICggdHlwZSAhPT0gImJ1dHRvbiIgJiYgdHlwZSAhPT0gInJlc2V0IiAmJiBuYW1lICkgewoJCQkJJGVsLmJpbmQoICJ2Y2xpY2siLCBmdW5jdGlvbigpIHsKCQkJCQkvLyBBZGQgaGlkZGVuIGlucHV0IGlmIGl0IGRvZXNuJ3QgYWxyZWFkeSBleGlzdC4KCQkJCQlpZiAoICRidXR0b25QbGFjZWhvbGRlciA9PT0gdW5kZWZpbmVkICkgewoJCQkJCQkkYnV0dG9uUGxhY2Vob2xkZXIgPSAkKCAiPGlucHV0PiIsIHsKCQkJCQkJCXR5cGU6ICJoaWRkZW4iLAoJCQkJCQkJbmFtZTogJGVsLmF0dHIoICJuYW1lIiApLAoJCQkJCQkJdmFsdWU6ICRlbC5hdHRyKCAidmFsdWUiICkKCQkJCQkJfSkuaW5zZXJ0QmVmb3JlKCAkZWwgKTsKCgkJCQkJCS8vIEJpbmQgdG8gZG9jIHRvIHJlbW92ZSBhZnRlciBzdWJtaXQgaGFuZGxpbmcKCQkJCQkJJCggZG9jdW1lbnQgKS5vbmUoICJzdWJtaXQiLCBmdW5jdGlvbigpIHsKCQkJCQkJCSRidXR0b25QbGFjZWhvbGRlci5yZW1vdmUoKTsKCgkJCQkJCQkvLyByZXNldCB0aGUgbG9jYWwgdmFyIHNvIHRoYXQgdGhlIGhpZGRlbiBpbnB1dAoJCQkJCQkJLy8gd2lsbCBiZSByZS1hZGRlZCBvbiBzdWJzZXF1ZW50IGNsaWNrcwoJCQkJCQkJJGJ1dHRvblBsYWNlaG9sZGVyID0gdW5kZWZpbmVkOwoJCQkJCQl9KTsKCQkJCQl9CgkJCQl9KTsKCQl9CgoJCSRlbC5iaW5kKHsKCQkJZm9jdXM6IGZ1bmN0aW9uKCkgewoJCQkJJGJ1dHRvbi5hZGRDbGFzcyggJC5tb2JpbGUuZm9jdXNDbGFzcyApOwoJCQl9LAoKCQkJYmx1cjogZnVuY3Rpb24oKSB7CgkJCQkkYnV0dG9uLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5mb2N1c0NsYXNzICk7CgkJCX0KCQl9KTsKCgkJdGhpcy5yZWZyZXNoKCk7Cgl9LAoKCWVuYWJsZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5lbGVtZW50LmF0dHIoICJkaXNhYmxlZCIsIGZhbHNlICk7CgkJdGhpcy5idXR0b24ucmVtb3ZlQ2xhc3MoICJ1aS1kaXNhYmxlZCIgKS5hdHRyKCAiYXJpYS1kaXNhYmxlZCIsIGZhbHNlICk7CgkJcmV0dXJuIHRoaXMuX3NldE9wdGlvbiggImRpc2FibGVkIiwgZmFsc2UgKTsKCX0sCgoJZGlzYWJsZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5lbGVtZW50LmF0dHIoICJkaXNhYmxlZCIsIHRydWUgKTsKCQl0aGlzLmJ1dHRvbi5hZGRDbGFzcyggInVpLWRpc2FibGVkIiApLmF0dHIoICJhcmlhLWRpc2FibGVkIiwgdHJ1ZSApOwoJCXJldHVybiB0aGlzLl9zZXRPcHRpb24oICJkaXNhYmxlZCIsIHRydWUgKTsKCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJdmFyICRlbCA9IHRoaXMuZWxlbWVudDsKCgkJaWYgKCAkZWwucHJvcCgiZGlzYWJsZWQiKSApIHsKCQkJdGhpcy5kaXNhYmxlKCk7CgkJfSBlbHNlIHsKCQkJdGhpcy5lbmFibGUoKTsKCQl9CgoJCS8vIEdyYWIgdGhlIGJ1dHRvbidzIHRleHQgZWxlbWVudCBmcm9tIGl0cyBpbXBsZW1lbnRhdGlvbi1pbmRlcGVuZGVudCBkYXRhIGl0ZW0KCQkkKCB0aGlzLmJ1dHRvbi5kYXRhKCAnYnV0dG9uRWxlbWVudHMnICkudGV4dCApWyAkZWwuaHRtbCgpID8gImh0bWwiIDogInRleHQiIF0oICRlbC5odG1sKCkgfHwgJGVsLnZhbCgpICk7Cgl9Cn0pOwoKLy9hdXRvIHNlbGYtaW5pdCB3aWRnZXRzCiQoIGRvY3VtZW50ICkuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKSB7CgkkLm1vYmlsZS5idXR0b24ucHJvdG90eXBlLmVuaGFuY2VXaXRoaW4oIGUudGFyZ2V0LCB0cnVlICk7Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLmZuLmNvbnRyb2xncm91cCA9IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJZnVuY3Rpb24gZmxpcENsYXNzZXMoIGVscywgZmxDb3JuZXJzICApIHsKCQllbHMucmVtb3ZlQ2xhc3MoICJ1aS1idG4tY29ybmVyLWFsbCB1aS1jb3JuZXItdG9wIHVpLWNvcm5lci1ib3R0b20gdWktY29ybmVyLWxlZnQgdWktY29ybmVyLXJpZ2h0IHVpLWNvbnRyb2xncm91cC1sYXN0IHVpLXNoYWRvdyIgKQoJCQkuZXEoIDAgKS5hZGRDbGFzcyggZmxDb3JuZXJzWyAwIF0gKQoJCQkuZW5kKCkKCQkJLmxhc3QoKS5hZGRDbGFzcyggZmxDb3JuZXJzWyAxIF0gKS5hZGRDbGFzcyggInVpLWNvbnRyb2xncm91cC1sYXN0IiApOwoJfQoKCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgkJdmFyICRlbCA9ICQoIHRoaXMgKSwKCQkJbyA9ICQuZXh0ZW5kKHsKCQkJCQkJZGlyZWN0aW9uOiAkZWwuanFtRGF0YSggInR5cGUiICkgfHwgInZlcnRpY2FsIiwKCQkJCQkJc2hhZG93OiBmYWxzZSwKCQkJCQkJZXhjbHVkZUludmlzaWJsZTogdHJ1ZSwKCQkJCQkJbWluaTogJGVsLmpxbURhdGEoICJtaW5pIiApCgkJCQkJfSwgb3B0aW9ucyApLAoJCQlncm91cGxlZ2VuZCA9ICRlbC5jaGlsZHJlbiggImxlZ2VuZCIgKSwKCQkJZ3JvdXBoZWFkaW5nID0gJGVsLmNoaWxkcmVuKCAiLnVpLWNvbnRyb2xncm91cC1sYWJlbCIgKSwKCQkJZ3JvdXBjb250cm9scyA9ICRlbC5jaGlsZHJlbiggIi51aS1jb250cm9sZ3JvdXAtY29udHJvbHMiICksCgkJCWZsQ29ybmVycyA9IG8uZGlyZWN0aW9uID09PSAiaG9yaXpvbnRhbCIgPyBbICJ1aS1jb3JuZXItbGVmdCIsICJ1aS1jb3JuZXItcmlnaHQiIF0gOiBbICJ1aS1jb3JuZXItdG9wIiwgInVpLWNvcm5lci1ib3R0b20iIF0sCgkJCXR5cGUgPSAkZWwuZmluZCggImlucHV0IiApLmZpcnN0KCkuYXR0ciggInR5cGUiICk7CgoJCS8vIEZpcnN0IHVud3JhcCB0aGUgY29udHJvbHMgaWYgdGhlIGNvbnRyb2xncm91cCB3YXMgYWxyZWFkeSBlbmhhbmNlZAoJCWlmICggZ3JvdXBjb250cm9scy5sZW5ndGggKSB7CgkJCWdyb3VwY29udHJvbHMuY29udGVudHMoKS51bndyYXAoKTsKCQl9CgkJJGVsLndyYXBJbm5lciggIjxkaXYgY2xhc3M9J3VpLWNvbnRyb2xncm91cC1jb250cm9scyc+PC9kaXY+IiApOwoKCQlpZiAoIGdyb3VwbGVnZW5kLmxlbmd0aCApIHsKCQkJLy8gUmVwbGFjZSBsZWdlbmQgd2l0aCBtb3JlIHN0eWxhYmxlIHJlcGxhY2VtZW50IGRpdgoJCQkkKCAiPGRpdiByb2xlPSdoZWFkaW5nJyBjbGFzcz0ndWktY29udHJvbGdyb3VwLWxhYmVsJz4iICsgZ3JvdXBsZWdlbmQuaHRtbCgpICsgIjwvZGl2PiIgKS5pbnNlcnRCZWZvcmUoICRlbC5jaGlsZHJlbiggMCApICk7CgkJCWdyb3VwbGVnZW5kLnJlbW92ZSgpOwoJCX0gZWxzZSBpZiAoIGdyb3VwaGVhZGluZy5sZW5ndGggKSB7CgkJCS8vIEp1c3QgbW92ZSB0aGUgaGVhZGluZyBpZiB0aGUgY29udHJvbGdyb3VwIHdhcyBhbHJlYWR5IGVuaGFuY2VkCgkJCSRlbC5wcmVwZW5kKCBncm91cGhlYWRpbmcgKTsKCQl9CgoJCSRlbC5hZGRDbGFzcyggInVpLWNvcm5lci1hbGwgdWktY29udHJvbGdyb3VwIHVpLWNvbnRyb2xncm91cC0iICsgby5kaXJlY3Rpb24gKTsKCgkJZmxpcENsYXNzZXMoICRlbC5maW5kKCAiLnVpLWJ0biIgKyAoIG8uZXhjbHVkZUludmlzaWJsZSA/ICI6dmlzaWJsZSIgOiAiIiApICkubm90KCAnLnVpLXNsaWRlci1oYW5kbGUnICksIGZsQ29ybmVycyApOwoJCWZsaXBDbGFzc2VzKCAkZWwuZmluZCggIi51aS1idG4taW5uZXIiICksIGZsQ29ybmVycyApOwoKCQlpZiAoIG8uc2hhZG93ICkgewoJCQkkZWwuYWRkQ2xhc3MoICJ1aS1zaGFkb3ciICk7CgkJfQoKCQlpZiAoIG8ubWluaSApIHsKCQkJJGVsLmFkZENsYXNzKCAidWktbWluaSIgKTsKCQl9CgoJfSk7Cn07CgovLyBUaGUgcGFnZWNyZWF0ZSBoYW5kbGVyIGZvciBjb250cm9sZ3JvdXAgaXMgaW4ganF1ZXJ5Lm1vYmlsZS5pbml0IGJlY2F1c2Ugb2YgdGhlIHNvZnQtZGVwZW5kZW5jeSBvbiB0aGUgd3JhcHBlZCB3aWRnZXRzCgp9KShqUXVlcnkpOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokKCBkb2N1bWVudCApLmJpbmQoICJwYWdlY3JlYXRlIGNyZWF0ZSIsIGZ1bmN0aW9uKCBlICkgewoKCS8vbGlua3Mgd2l0aGluIGNvbnRlbnQgYXJlYXMsIHRlc3RzIGluY2x1ZGVkIHdpdGggcGFnZQoJJCggZS50YXJnZXQgKQoJCS5maW5kKCAiYSIgKQoJCS5qcW1FbmhhbmNlYWJsZSgpCgkJLm5vdCggIi51aS1idG4sIC51aS1saW5rLWluaGVyaXQsIDpqcW1EYXRhKHJvbGU9J25vbmUnKSwgOmpxbURhdGEocm9sZT0nbm9qcycpIiApCgkJLmFkZENsYXNzKCAidWktbGluayIgKTsKCn0pOwoKfSkoIGpRdWVyeSApOwoKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKCWZ1bmN0aW9uIGZpdFNlZ21lbnRJbnNpZGVTZWdtZW50KCB3aW5TaXplLCBzZWdTaXplLCBvZmZzZXQsIGRlc2lyZWQgKSB7CgkJdmFyIHJldCA9IGRlc2lyZWQ7CgoJCWlmICggd2luU2l6ZSA8IHNlZ1NpemUgKSB7CgkJCS8vIENlbnRlciBzZWdtZW50IGlmIGl0J3MgYmlnZ2VyIHRoYW4gdGhlIHdpbmRvdwoJCQlyZXQgPSBvZmZzZXQgKyAoIHdpblNpemUgLSBzZWdTaXplICkgLyAyOwoJCX0gZWxzZSB7CgkJCS8vIE90aGVyd2lzZSBjZW50ZXIgaXQgYXQgdGhlIGRlc2lyZWQgY29vcmRpbmF0ZSB3aGlsZSBrZWVwaW5nIGl0IGNvbXBsZXRlbHkgaW5zaWRlIHRoZSB3aW5kb3cKCQkJcmV0ID0gTWF0aC5taW4oIE1hdGgubWF4KCBvZmZzZXQsIGRlc2lyZWQgLSBzZWdTaXplIC8gMiApLCBvZmZzZXQgKyB3aW5TaXplIC0gc2VnU2l6ZSApOwoJCX0KCgkJcmV0dXJuIHJldDsKCX0KCglmdW5jdGlvbiB3aW5kb3dDb29yZHMoKSB7CgkJdmFyICR3aW4gPSAkKCB3aW5kb3cgKTsKCgkJcmV0dXJuIHsKCQkJeDogJHdpbi5zY3JvbGxMZWZ0KCksCgkJCXk6ICR3aW4uc2Nyb2xsVG9wKCksCgkJCWN4OiAoIHdpbmRvdy5pbm5lcldpZHRoIHx8ICR3aW4ud2lkdGgoKSApLAoJCQljeTogKCB3aW5kb3cuaW5uZXJIZWlnaHQgfHwgJHdpbi5oZWlnaHQoKSApCgkJfTsKCX0KCgkkLndpZGdldCggIm1vYmlsZS5wb3B1cCIsICQubW9iaWxlLndpZGdldCwgewoJCW9wdGlvbnM6IHsKCQkJdGhlbWU6IG51bGwsCgkJCW92ZXJsYXlUaGVtZTogbnVsbCwKCQkJc2hhZG93OiB0cnVlLAoJCQljb3JuZXJzOiB0cnVlLAoJCQl0cmFuc2l0aW9uOiAibm9uZSIsCgkJCXBvc2l0aW9uVG86ICJvcmlnaW4iLAoJCQl0b2xlcmFuY2U6IG51bGwsCgkJCWluaXRTZWxlY3RvcjogIjpqcW1EYXRhKHJvbGU9J3BvcHVwJykiLAoJCQljbG9zZUxpbmtTZWxlY3RvcjogImE6anFtRGF0YShyZWw9J2JhY2snKSIsCgkJCWNsb3NlTGlua0V2ZW50czogImNsaWNrLnBvcHVwIiwKCQkJbmF2aWdhdGVFdmVudHM6ICJuYXZpZ2F0ZS5wb3B1cCIsCgkJCWNsb3NlRXZlbnRzOiAibmF2aWdhdGUucG9wdXAgcGFnZWJlZm9yZWNoYW5nZS5wb3B1cCIsCgoJCQkvLyBOT1RFIFdpbmRvd3MgUGhvbmUgNyBoYXMgYSBzY3JvbGwgcG9zaXRpb24gY2FjaGluZyBpc3N1ZSB0aGF0CgkJCS8vICAgICAgcmVxdWlyZXMgdXMgdG8gZGlzYWJsZSBwb3B1cCBoaXN0b3J5IG1hbmFnZW1lbnQgYnkgZGVmYXVsdAoJCQkvLyAgICAgIGh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5LW1vYmlsZS9pc3N1ZXMvNDc4NAoJCQkvLwoJCQkvLyBOT1RFIHRoaXMgb3B0aW9uIGlzIG1vZGlmaWVkIGluIF9jcmVhdGUhCgkJCWhpc3Rvcnk6ICEkLm1vYmlsZS5icm93c2VyLmllCgkJfSwKCgkJX2VhdEV2ZW50QW5kQ2xvc2U6IGZ1bmN0aW9uKCBlICkgewoJCQllLnByZXZlbnREZWZhdWx0KCk7CgkJCWUuc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uKCk7CgkJCXRoaXMuY2xvc2UoKTsKCQkJcmV0dXJuIGZhbHNlOwoJCX0sCgoJCS8vIE1ha2Ugc3VyZSB0aGUgc2NyZWVuIHNpemUgaXMgaW5jcmVhc2VkIGJleW9uZCB0aGUgcGFnZSBoZWlnaHQgaWYgdGhlIHBvcHVwJ3MgY2F1c2VzIHRoZSBkb2N1bWVudCB0byBpbmNyZWFzZSBpbiBoZWlnaHQKCQlfcmVzaXplU2NyZWVuOiBmdW5jdGlvbigpIHsKCQkJdmFyIHBvcHVwSGVpZ2h0ID0gdGhpcy5fdWkuY29udGFpbmVyLm91dGVySGVpZ2h0KCB0cnVlICk7CgoJCQl0aGlzLl91aS5zY3JlZW4ucmVtb3ZlQXR0ciggInN0eWxlIiApOwoJCQlpZiAoIHBvcHVwSGVpZ2h0ID4gdGhpcy5fdWkuc2NyZWVuLmhlaWdodCgpICkgewoJCQkJdGhpcy5fdWkuc2NyZWVuLmhlaWdodCggcG9wdXBIZWlnaHQgKTsKCQkJfQoJCX0sCgoJCV9oYW5kbGVXaW5kb3dLZXlVcDogZnVuY3Rpb24oIGUgKSB7CgkJCWlmICggdGhpcy5faXNPcGVuICYmIGUua2V5Q29kZSA9PT0gJC5tb2JpbGUua2V5Q29kZS5FU0NBUEUgKSB7CgkJCQlyZXR1cm4gdGhpcy5fZWF0RXZlbnRBbmRDbG9zZSggZSApOwoJCQl9CgkJfSwKCgkJX21heWJlUmVmcmVzaFRpbWVvdXQ6IGZ1bmN0aW9uKCkgewoJCQl2YXIgd2luQ29vcmRzID0gd2luZG93Q29vcmRzKCk7CgoJCQlpZiAoIHRoaXMuX3Jlc2l6ZURhdGEgKSB7CgkJCQlpZiAoIHdpbkNvb3Jkcy54ID09PSB0aGlzLl9yZXNpemVEYXRhLndpbkNvb3Jkcy54ICYmCgkJCQkJd2luQ29vcmRzLnkgPT09IHRoaXMuX3Jlc2l6ZURhdGEud2luQ29vcmRzLnkgJiYKCQkJCQl3aW5Db29yZHMuY3ggPT09IHRoaXMuX3Jlc2l6ZURhdGEud2luQ29vcmRzLmN4ICYmCgkJCQkJd2luQ29vcmRzLmN5ID09PSB0aGlzLl9yZXNpemVEYXRhLndpbkNvb3Jkcy5jeSApIHsKCQkJCQkvLyB0aW1lb3V0IG5vdCByZWZyZXNoZWQKCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQl9IGVsc2UgewoJCQkJCS8vIGNsZWFyIGV4aXN0aW5nIHRpbWVvdXQgLSBpdCB3aWxsIGJlIHJlZnJlc2hlZCBiZWxvdwoJCQkJCWNsZWFyVGltZW91dCggdGhpcy5fcmVzaXplRGF0YS50aW1lb3V0SWQgKTsKCQkJCX0KCQkJfQoKCQkJdGhpcy5fcmVzaXplRGF0YSA9IHsKCQkJCXRpbWVvdXRJZDogc2V0VGltZW91dCggJC5wcm94eSggdGhpcywgIl9yZXNpemVUaW1lb3V0IiApLCAyMDAgKSwKCQkJCXdpbkNvb3Jkczogd2luQ29vcmRzCgkJCX07CgoJCQlyZXR1cm4gdHJ1ZTsKCQl9LAoKCQlfcmVzaXplVGltZW91dDogZnVuY3Rpb24oKSB7CgkJCWlmICggIXRoaXMuX21heWJlUmVmcmVzaFRpbWVvdXQoKSApIHsKCQkJCS8vIGVmZmVjdGl2ZWx5IHJhcGlkLW9wZW4gdGhlIHBvcHVwIHdoaWxlIGxlYXZpbmcgdGhlIHNjcmVlbiBpbnRhY3QKCQkJCXRoaXMuX3RyaWdnZXIoICJiZWZvcmVwb3NpdGlvbiIgKTsKCQkJCXRoaXMuX3VpLmNvbnRhaW5lcgoJCQkJCS5yZW1vdmVDbGFzcyggInVpLXNlbGVjdG1lbnUtaGlkZGVuIiApCgkJCQkJLm9mZnNldCggdGhpcy5fcGxhY2VtZW50Q29vcmRzKCB0aGlzLl9kZXNpcmVkQ29vcmRzKCB1bmRlZmluZWQsIHVuZGVmaW5lZCwgIndpbmRvdyIgKSApICk7CgoJCQkJdGhpcy5fcmVzaXplU2NyZWVuKCk7CgkJCQl0aGlzLl9yZXNpemVEYXRhID0gbnVsbDsKCQkJCXRoaXMuX29yaWVudGF0aW9uY2hhbmdlSW5Qcm9ncmVzcyA9IGZhbHNlOwoJCQl9CgkJfSwKCgkJX2hhbmRsZVdpbmRvd1Jlc2l6ZTogZnVuY3Rpb24oIGUgKSB7CgkJCWlmICggdGhpcy5faXNPcGVuICkgewoJCQkJdGhpcy5fbWF5YmVSZWZyZXNoVGltZW91dCgpOwoJCQl9CgkJfSwKCgkJX2hhbmRsZVdpbmRvd09yaWVudGF0aW9uY2hhbmdlOiBmdW5jdGlvbiggZSApIHsKCgkJCWlmICggIXRoaXMuX29yaWVudGF0aW9uY2hhbmdlSW5Qcm9ncmVzcyApIHsKCQkJCS8vIGVmZmVjdGl2ZWx5IHJhcGlkLWNsb3NlIHRoZSBwb3B1cCB3aGlsZSBsZWF2aW5nIHRoZSBzY3JlZW4gaW50YWN0CgkJCQl0aGlzLl91aS5jb250YWluZXIKCQkJCQkuYWRkQ2xhc3MoICJ1aS1zZWxlY3RtZW51LWhpZGRlbiIgKQoJCQkJCS5yZW1vdmVBdHRyKCAic3R5bGUiICk7CgoJCQkJdGhpcy5fb3JpZW50YXRpb25jaGFuZ2VJblByb2dyZXNzID0gdHJ1ZTsKCQkJfQoJCX0sCgoJCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCQl2YXIgdWkgPSB7CgkJCQkJc2NyZWVuOiAkKCAiPGRpdiBjbGFzcz0ndWktc2NyZWVuLWhpZGRlbiB1aS1wb3B1cC1zY3JlZW4nPjwvZGl2PiIgKSwKCQkJCQlwbGFjZWhvbGRlcjogJCggIjxkaXYgc3R5bGU9J2Rpc3BsYXk6IG5vbmU7Jz48IS0tIHBsYWNlaG9sZGVyIC0tPjwvZGl2PiIgKSwKCQkJCQljb250YWluZXI6ICQoICI8ZGl2IGNsYXNzPSd1aS1wb3B1cC1jb250YWluZXIgdWktc2VsZWN0bWVudS1oaWRkZW4nPjwvZGl2PiIgKQoJCQkJfSwKCQkJCXRoaXNQYWdlID0gdGhpcy5lbGVtZW50LmNsb3Nlc3QoICIudWktcGFnZSIgKSwKCQkJCW15SWQgPSB0aGlzLmVsZW1lbnQuYXR0ciggImlkIiApLAoJCQkJc2VsZiA9IHRoaXM7CgoJCQkvLyBXZSBuZWVkIHRvIGFkanVzdCB0aGUgaGlzdG9yeSBvcHRpb24gdG8gYmUgZmFsc2UgaWYgdGhlcmUncyBubyBBSkFYIG5hdi4KCQkJLy8gV2UgY2FuJ3QgZG8gaXQgaW4gdGhlIG9wdGlvbiBkZWNsYXJhdGlvbnMgYmVjYXVzZSB0aG9zZSBhcmUgcnVuIGJlZm9yZQoJCQkvLyBpdCBpcyBkZXRlcm1pbmVkIHdoZXRoZXIgdGhlcmUgc2hhbGwgYmUgQUpBWCBuYXYuCgkJCXRoaXMub3B0aW9ucy5oaXN0b3J5ID0gdGhpcy5vcHRpb25zLmhpc3RvcnkgJiYgJC5tb2JpbGUuYWpheEVuYWJsZWQgJiYgJC5tb2JpbGUuaGFzaExpc3RlbmluZ0VuYWJsZWQ7CgoJCQlpZiAoIHRoaXNQYWdlLmxlbmd0aCA9PT0gMCApIHsKCQkJCXRoaXNQYWdlID0gJCggImJvZHkiICk7CgkJCX0KCgkJCS8vIGRlZmluZSB0aGUgY29udGFpbmVyIGZvciBuYXZpZ2F0aW9uIGV2ZW50IGJpbmRpbmdzCgkJCS8vIFRPRE8gdGhpcyB3b3VsZCBiZSBuaWNlIGF0IHRoZSB0aGUgbW9iaWxlIHdpZGdldCBsZXZlbAoJCQl0aGlzLm9wdGlvbnMuY29udGFpbmVyID0gdGhpcy5vcHRpb25zLmNvbnRhaW5lciB8fCAkLm1vYmlsZS5wYWdlQ29udGFpbmVyOwoKCQkJLy8gQXBwbHkgdGhlIHByb3RvCgkJCXRoaXNQYWdlLmFwcGVuZCggdWkuc2NyZWVuICk7CgkJCXVpLmNvbnRhaW5lci5pbnNlcnRBZnRlciggdWkuc2NyZWVuICk7CgkJCS8vIExlYXZlIGEgcGxhY2Vob2xkZXIgd2hlcmUgdGhlIGVsZW1lbnQgdXNlZCB0byBiZQoJCQl1aS5wbGFjZWhvbGRlci5pbnNlcnRBZnRlciggdGhpcy5lbGVtZW50ICk7CgkJCWlmICggbXlJZCApIHsKCQkJCXVpLnNjcmVlbi5hdHRyKCAiaWQiLCBteUlkICsgIi1zY3JlZW4iICk7CgkJCQl1aS5jb250YWluZXIuYXR0ciggImlkIiwgbXlJZCArICItcG9wdXAiICk7CgkJCQl1aS5wbGFjZWhvbGRlci5odG1sKCAiPCEtLSBwbGFjZWhvbGRlciBmb3IgIiArIG15SWQgKyAiIC0tPiIgKTsKCQkJfQoJCQl1aS5jb250YWluZXIuYXBwZW5kKCB0aGlzLmVsZW1lbnQgKTsKCgkJCS8vIEFkZCBjbGFzcyB0byBwb3B1cCBlbGVtZW50CgkJCXRoaXMuZWxlbWVudC5hZGRDbGFzcyggInVpLXBvcHVwIiApOwoKCQkJLy8gRGVmaW5lIGluc3RhbmNlIHZhcmlhYmxlcwoJCQkkLmV4dGVuZCggdGhpcywgewoJCQkJX3BhZ2U6IHRoaXNQYWdlLAoJCQkJX3VpOiB1aSwKCQkJCV9mYWxsYmFja1RyYW5zaXRpb246ICIiLAoJCQkJX2N1cnJlbnRUcmFuc2l0aW9uOiBmYWxzZSwKCQkJCV9wcmVyZXFzOiBudWxsLAoJCQkJX2lzT3BlbjogZmFsc2UsCgkJCQlfdG9sZXJhbmNlOiBudWxsLAoJCQkJX3Jlc2l6ZURhdGE6IG51bGwsCgkJCQlfb3JpZW50YXRpb25jaGFuZ2VJblByb2dyZXNzOiBmYWxzZSwKCQkJCV9nbG9iYWxIYW5kbGVyczogWwoJCQkJCXsKCQkJCQkJc3JjOiAkKCB3aW5kb3cgKSwKCQkJCQkJaGFuZGxlcjogewoJCQkJCQkJb3JpZW50YXRpb25jaGFuZ2U6ICQucHJveHkoIHRoaXMsICJfaGFuZGxlV2luZG93T3JpZW50YXRpb25jaGFuZ2UiICksCgkJCQkJCQlyZXNpemU6ICQucHJveHkoIHRoaXMsICJfaGFuZGxlV2luZG93UmVzaXplIiApLAoJCQkJCQkJa2V5dXA6ICQucHJveHkoIHRoaXMsICJfaGFuZGxlV2luZG93S2V5VXAiICkKCQkJCQkJfQoJCQkJCX0KCQkJCV0KCQkJfSk7CgoJCQkkLmVhY2goIHRoaXMub3B0aW9ucywgZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CgkJCQkvLyBDYXVzZSBpbml0aWFsIG9wdGlvbnMgdG8gYmUgYXBwbGllZCBieSB0aGVpciBoYW5kbGVyIGJ5IHRlbXBvcmFyaWx5IHNldHRpbmcgdGhlIG9wdGlvbiB0byB1bmRlZmluZWQKCQkJCS8vIC0gdGhlIGhhbmRsZXIgdGhlbiBzZXRzIGl0IHRvIHRoZSBpbml0aWFsIHZhbHVlCgkJCQlzZWxmLm9wdGlvbnNbIGtleSBdID0gdW5kZWZpbmVkOwoJCQkJc2VsZi5fc2V0T3B0aW9uKCBrZXksIHZhbHVlLCB0cnVlICk7CgkJCX0pOwoKCQkJdWkuc2NyZWVuLmJpbmQoICJ2Y2xpY2siLCAkLnByb3h5KCB0aGlzLCAiX2VhdEV2ZW50QW5kQ2xvc2UiICkgKTsKCgkJCSQuZWFjaCggdGhpcy5fZ2xvYmFsSGFuZGxlcnMsIGZ1bmN0aW9uKCBpZHgsIHZhbHVlICkgewoJCQkJdmFsdWUuc3JjLmJpbmQoIHZhbHVlLmhhbmRsZXIgKTsKCQkJfSk7CgkJfSwKCgkJX2FwcGx5VGhlbWU6IGZ1bmN0aW9uKCBkc3QsIHRoZW1lLCBwcmVmaXggKSB7CgkJCXZhciBjbGFzc2VzID0gKCBkc3QuYXR0ciggImNsYXNzIiApIHx8ICIiKS5zcGxpdCggIiAiICksCgkJCQlhbHJlYWR5QWRkZWQgPSB0cnVlLAoJCQkJY3VycmVudFRoZW1lID0gbnVsbCwKCQkJCW1hdGNoZXMsCgkJCQl0aGVtZVN0ciA9IFN0cmluZyggdGhlbWUgKTsKCgkJCXdoaWxlICggY2xhc3Nlcy5sZW5ndGggPiAwICkgewoJCQkJY3VycmVudFRoZW1lID0gY2xhc3Nlcy5wb3AoKTsKCQkJCW1hdGNoZXMgPSAoIG5ldyBSZWdFeHAoICJedWktIiArIHByZWZpeCArICItKFthLXpdKSQiICkgKS5leGVjKCBjdXJyZW50VGhlbWUgKTsKCQkJCWlmICggbWF0Y2hlcyAmJiBtYXRjaGVzLmxlbmd0aCA+IDEgKSB7CgkJCQkJY3VycmVudFRoZW1lID0gbWF0Y2hlc1sgMSBdOwoJCQkJCWJyZWFrOwoJCQkJfSBlbHNlIHsKCQkJCQljdXJyZW50VGhlbWUgPSBudWxsOwoJCQkJfQoJCQl9CgoJCQlpZiAoIHRoZW1lICE9PSBjdXJyZW50VGhlbWUgKSB7CgkJCQlkc3QucmVtb3ZlQ2xhc3MoICJ1aS0iICsgcHJlZml4ICsgIi0iICsgY3VycmVudFRoZW1lICk7CgkJCQlpZiAoICEgKCB0aGVtZSA9PT0gbnVsbCB8fCB0aGVtZSA9PT0gIm5vbmUiICkgKSB7CgkJCQkJZHN0LmFkZENsYXNzKCAidWktIiArIHByZWZpeCArICItIiArIHRoZW1lU3RyICk7CgkJCQl9CgkJCX0KCQl9LAoKCQlfc2V0VGhlbWU6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQkJdGhpcy5fYXBwbHlUaGVtZSggdGhpcy5lbGVtZW50LCB2YWx1ZSwgImJvZHkiICk7CgkJfSwKCgkJX3NldE92ZXJsYXlUaGVtZTogZnVuY3Rpb24oIHZhbHVlICkgewoJCQl0aGlzLl9hcHBseVRoZW1lKCB0aGlzLl91aS5zY3JlZW4sIHZhbHVlLCAib3ZlcmxheSIgKTsKCgkJCWlmICggdGhpcy5faXNPcGVuICkgewoJCQkJdGhpcy5fdWkuc2NyZWVuLmFkZENsYXNzKCAiaW4iICk7CgkJCX0KCQl9LAoKCQlfc2V0U2hhZG93OiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJCXRoaXMuZWxlbWVudC50b2dnbGVDbGFzcyggInVpLW92ZXJsYXktc2hhZG93IiwgdmFsdWUgKTsKCQl9LAoKCQlfc2V0Q29ybmVyczogZnVuY3Rpb24oIHZhbHVlICkgewoJCQl0aGlzLmVsZW1lbnQudG9nZ2xlQ2xhc3MoICJ1aS1jb3JuZXItYWxsIiwgdmFsdWUgKTsKCQl9LAoKCQlfYXBwbHlUcmFuc2l0aW9uOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJCXRoaXMuX3VpLmNvbnRhaW5lci5yZW1vdmVDbGFzcyggdGhpcy5fZmFsbGJhY2tUcmFuc2l0aW9uICk7CgkJCWlmICggdmFsdWUgJiYgdmFsdWUgIT09ICJub25lIiApIHsKCQkJCXRoaXMuX2ZhbGxiYWNrVHJhbnNpdGlvbiA9ICQubW9iaWxlLl9tYXliZURlZ3JhZGVUcmFuc2l0aW9uKCB2YWx1ZSApOwoJCQkJdGhpcy5fdWkuY29udGFpbmVyLmFkZENsYXNzKCB0aGlzLl9mYWxsYmFja1RyYW5zaXRpb24gKTsKCQkJfQoJCX0sCgoJCV9zZXRUcmFuc2l0aW9uOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJCWlmICggIXRoaXMuX2N1cnJlbnRUcmFuc2l0aW9uICkgewoJCQkJdGhpcy5fYXBwbHlUcmFuc2l0aW9uKCB2YWx1ZSApOwoJCQl9CgkJfSwKCgkJX3NldFRvbGVyYW5jZTogZnVuY3Rpb24oIHZhbHVlICkgewoJCQl2YXIgdG9sID0geyB0OiAzMCwgcjogMTUsIGI6IDMwLCBsOiAxNSB9OwoKCQkJaWYgKCB2YWx1ZSApIHsKCQkJCXZhciBhciA9IFN0cmluZyggdmFsdWUgKS5zcGxpdCggIiwiICk7CgoJCQkJJC5lYWNoKCBhciwgZnVuY3Rpb24oIGlkeCwgdmFsICkgeyBhclsgaWR4IF0gPSBwYXJzZUludCggdmFsLCAxMCApOyB9ICk7CgoJCQkJc3dpdGNoKCBhci5sZW5ndGggKSB7CgkJCQkJLy8gQWxsIHZhbHVlcyBhcmUgdG8gYmUgdGhlIHNhbWUKCQkJCQljYXNlIDE6CgkJCQkJCWlmICggIWlzTmFOKCBhclsgMCBdICkgKSB7CgkJCQkJCQl0b2wudCA9IHRvbC5yID0gdG9sLmIgPSB0b2wubCA9IGFyWyAwIF07CgkJCQkJCX0KCQkJCQkJYnJlYWs7CgoJCQkJCS8vIFRoZSBmaXJzdCB2YWx1ZSBkZW5vdGVzIHRvcC9ib3R0b20gdG9sZXJhbmNlLCBhbmQgdGhlIHNlY29uZCB2YWx1ZSBkZW5vdGVzIGxlZnQvcmlnaHQgdG9sZXJhbmNlCgkJCQkJY2FzZSAyOgoJCQkJCQlpZiAoICFpc05hTiggYXJbIDAgXSApICkgewoJCQkJCQkJdG9sLnQgPSB0b2wuYiA9IGFyWyAwIF07CgkJCQkJCX0KCQkJCQkJaWYgKCAhaXNOYU4oIGFyWyAxIF0gKSApIHsKCQkJCQkJCXRvbC5sID0gdG9sLnIgPSBhclsgMSBdOwoJCQkJCQl9CgkJCQkJCWJyZWFrOwoKCQkJCQkvLyBUaGUgYXJyYXkgY29udGFpbnMgdmFsdWVzIGluIHRoZSBvcmRlciB0b3AsIHJpZ2h0LCBib3R0b20sIGxlZnQKCQkJCQljYXNlIDQ6CgkJCQkJCWlmICggIWlzTmFOKCBhclsgMCBdICkgKSB7CgkJCQkJCQl0b2wudCA9IGFyWyAwIF07CgkJCQkJCX0KCQkJCQkJaWYgKCAhaXNOYU4oIGFyWyAxIF0gKSApIHsKCQkJCQkJCXRvbC5yID0gYXJbIDEgXTsKCQkJCQkJfQoJCQkJCQlpZiAoICFpc05hTiggYXJbIDIgXSApICkgewoJCQkJCQkJdG9sLmIgPSBhclsgMiBdOwoJCQkJCQl9CgkJCQkJCWlmICggIWlzTmFOKCBhclsgMyBdICkgKSB7CgkJCQkJCQl0b2wubCA9IGFyWyAzIF07CgkJCQkJCX0KCQkJCQkJYnJlYWs7CgoJCQkJCWRlZmF1bHQ6CgkJCQkJCWJyZWFrOwoJCQkJfQoJCQl9CgoJCQl0aGlzLl90b2xlcmFuY2UgPSB0b2w7CgkJfSwKCgkJX3NldE9wdGlvbjogZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CgkJCXZhciBleGNsdXNpb25zLCBzZXR0ZXIgPSAiX3NldCIgKyBrZXkuY2hhckF0KCAwICkudG9VcHBlckNhc2UoKSArIGtleS5zbGljZSggMSApOwoKCQkJaWYgKCB0aGlzWyBzZXR0ZXIgXSAhPT0gdW5kZWZpbmVkICkgewoJCQkJdGhpc1sgc2V0dGVyIF0oIHZhbHVlICk7CgkJCX0KCgkJCS8vIFRPRE8gUkVNT1ZFIEZPUiAxLjIuMSBieSBtb3ZpbmcgdGhlbSBvdXQgdG8gYSBkZWZhdWx0IG9wdGlvbnMgb2JqZWN0CgkJCWV4Y2x1c2lvbnMgPSBbCgkJCQkiaW5pdFNlbGVjdG9yIiwKCQkJCSJjbG9zZUxpbmtTZWxlY3RvciIsCgkJCQkiY2xvc2VMaW5rRXZlbnRzIiwKCQkJCSJuYXZpZ2F0ZUV2ZW50cyIsCgkJCQkiY2xvc2VFdmVudHMiLAoJCQkJImhpc3RvcnkiLAoJCQkJImNvbnRhaW5lciIKCQkJXTsKCgkJCSQubW9iaWxlLndpZGdldC5wcm90b3R5cGUuX3NldE9wdGlvbi5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgkJCWlmICggJC5pbkFycmF5KCBrZXksIGV4Y2x1c2lvbnMgKSA9PT0gLTEgKSB7CgkJCQkvLyBSZWNvcmQgdGhlIG9wdGlvbiBjaGFuZ2UgaW4gdGhlIG9wdGlvbnMgYW5kIGluIHRoZSBET00gZGF0YS0qIGF0dHJpYnV0ZXMKCQkJCXRoaXMuZWxlbWVudC5hdHRyKCAiZGF0YS0iICsgKCAkLm1vYmlsZS5ucyB8fCAiIiApICsgKCBrZXkucmVwbGFjZSggLyhbQS1aXSkvLCAiLSQxIiApLnRvTG93ZXJDYXNlKCkgKSwgdmFsdWUgKTsKCQkJfQoJCX0sCgoJCS8vIFRyeSBhbmQgY2VudGVyIHRoZSBvdmVybGF5IG92ZXIgdGhlIGdpdmVuIGNvb3JkaW5hdGVzCgkJX3BsYWNlbWVudENvb3JkczogZnVuY3Rpb24oIGRlc2lyZWQgKSB7CgkJCS8vIHJlY3RhbmdsZSB3aXRoaW4gd2hpY2ggdGhlIHBvcHVwIG11c3QgZml0CgkJCXZhcgoJCQkJd2luQ29vcmRzID0gd2luZG93Q29vcmRzKCksCgkJCQlyYyA9IHsKCQkJCQl4OiB0aGlzLl90b2xlcmFuY2UubCwKCQkJCQl5OiB3aW5Db29yZHMueSArIHRoaXMuX3RvbGVyYW5jZS50LAoJCQkJCWN4OiB3aW5Db29yZHMuY3ggLSB0aGlzLl90b2xlcmFuY2UubCAtIHRoaXMuX3RvbGVyYW5jZS5yLAoJCQkJCWN5OiB3aW5Db29yZHMuY3kgLSB0aGlzLl90b2xlcmFuY2UudCAtIHRoaXMuX3RvbGVyYW5jZS5iCgkJCQl9LAoJCQkJbWVudVNpemUsIHJldDsKCgkJCS8vIENsYW1wIHRoZSB3aWR0aCBvZiB0aGUgbWVudSBiZWZvcmUgZ3JhYmJpbmcgaXRzIHNpemUKCQkJdGhpcy5fdWkuY29udGFpbmVyLmNzcyggIm1heC13aWR0aCIsIHJjLmN4ICk7CgkJCW1lbnVTaXplID0gewoJCQkJY3g6IHRoaXMuX3VpLmNvbnRhaW5lci5vdXRlcldpZHRoKCB0cnVlICksCgkJCQljeTogdGhpcy5fdWkuY29udGFpbmVyLm91dGVySGVpZ2h0KCB0cnVlICkKCQkJfTsKCgkJCS8vIENlbnRlciB0aGUgbWVudSBvdmVyIHRoZSBkZXNpcmVkIGNvb3JkaW5hdGVzLCB3aGlsZSBub3QgZ29pbmcgb3V0c2lkZQoJCQkvLyB0aGUgd2luZG93IHRvbGVyYW5jZXMuIFRoaXMgd2lsbCBjZW50ZXIgd3J0LiB0aGUgd2luZG93IGlmIHRoZSBwb3B1cCBpcyB0b28gbGFyZ2UuCgkJCXJldCA9IHsKCQkJCXg6IGZpdFNlZ21lbnRJbnNpZGVTZWdtZW50KCByYy5jeCwgbWVudVNpemUuY3gsIHJjLngsIGRlc2lyZWQueCApLAoJCQkJeTogZml0U2VnbWVudEluc2lkZVNlZ21lbnQoIHJjLmN5LCBtZW51U2l6ZS5jeSwgcmMueSwgZGVzaXJlZC55ICkKCQkJfTsKCgkJCS8vIE1ha2Ugc3VyZSB0aGUgdG9wIG9mIHRoZSBtZW51IGlzIHZpc2libGUKCQkJcmV0LnkgPSBNYXRoLm1heCggMCwgcmV0LnkgKTsKCgkJCS8vIElmIHRoZSBoZWlnaHQgb2YgdGhlIG1lbnUgaXMgc21hbGxlciB0aGFuIHRoZSBoZWlnaHQgb2YgdGhlIGRvY3VtZW50CgkJCS8vIGFsaWduIHRoZSBib3R0b20gd2l0aCB0aGUgYm90dG9tIG9mIHRoZSBkb2N1bWVudAoKCQkJLy8gZml4IGZvciAkKCBkb2N1bWVudCApLmhlaWdodCgpIGJ1ZyBpbiBjb3JlIDEuNy4yLgoJCQl2YXIgZG9jRWwgPSBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQsIGRvY0JvZHkgPSBkb2N1bWVudC5ib2R5LAoJCQkJZG9jSGVpZ2h0ID0gTWF0aC5tYXgoIGRvY0VsLmNsaWVudEhlaWdodCwgZG9jQm9keS5zY3JvbGxIZWlnaHQsIGRvY0JvZHkub2Zmc2V0SGVpZ2h0LCBkb2NFbC5zY3JvbGxIZWlnaHQsIGRvY0VsLm9mZnNldEhlaWdodCApOwoKCQkJcmV0LnkgLT0gTWF0aC5taW4oIHJldC55LCBNYXRoLm1heCggMCwgcmV0LnkgKyBtZW51U2l6ZS5jeSAtIGRvY0hlaWdodCApICk7CgoJCQlyZXR1cm4geyBsZWZ0OiByZXQueCwgdG9wOiByZXQueSB9OwoJCX0sCgoJCV9jcmVhdGVQcmVyZXFzOiBmdW5jdGlvbiggc2NyZWVuUHJlcmVxLCBjb250YWluZXJQcmVyZXEsIHdoZW5Eb25lICkgewoJCQl2YXIgc2VsZiA9IHRoaXMsIHByZXJlcXM7CgoJCQkvLyBJdCBpcyBpbXBvcnRhbnQgdG8gbWFpbnRhaW4gYm90aCB0aGUgbG9jYWwgdmFyaWFibGUgcHJlcmVxcyBhbmQgc2VsZi5fcHJlcmVxcy4gVGhlIGxvY2FsIHZhcmlhYmxlIHJlbWFpbnMgaW4KCQkJLy8gdGhlIGNsb3N1cmUgb2YgdGhlIGZ1bmN0aW9ucyB3aGljaCBjYWxsIHRoZSBjYWxsYmFja3MgcGFzc2VkIGluLiBUaGUgY29tcGFyaXNvbiBiZXR3ZWVuIHRoZSBsb2NhbCB2YXJpYWJsZSBhbmQKCQkJLy8gc2VsZi5fcHJlcmVxcyBpcyBuZWNlc3NhcnksIGJlY2F1c2Ugb25jZSBhIGZ1bmN0aW9uIGhhcyBiZWVuIHBhc3NlZCB0byAuYW5pbWF0aW9uQ29tcGxldGUoKSBpdCB3aWxsIGJlIGNhbGxlZAoJCQkvLyBuZXh0IHRpbWUgYW4gYW5pbWF0aW9uIGNvbXBsZXRlcywgZXZlbiBpZiB0aGF0J3Mgbm90IHRoZSBhbmltYXRpb24gd2hvc2UgZW5kIHRoZSBmdW5jdGlvbiB3YXMgc3VwcG9zZWQgdG8gY2F0Y2gKCQkJLy8gKGZvciBleGFtcGxlLCBpZiBhbiBhYm9ydCBoYXBwZW5zIGR1cmluZyB0aGUgb3BlbmluZyBhbmltYXRpb24sIHRoZSAuYW5pbWF0aW9uQ29tcGxldGUgaGFuZGxlciBpcyBub3QgY2FsbGVkIGZvcgoJCQkvLyB0aGF0IGFuaW1hdGlvbiBhbnltb3JlLCBidXQgdGhlIGhhbmRsZXIgcmVtYWlucyBhdHRhY2hlZCwgc28gaXQgaXMgY2FsbGVkIHRoZSBuZXh0IHRpbWUgdGhlIHBvcHVwIGlzIG9wZW5lZAoJCQkvLyAtIG1ha2luZyBpdCBzdGFsZS4gQ29tcGFyaW5nIHRoZSBsb2NhbCB2YXJpYWJsZSBwcmVyZXFzIHRvIHRoZSB3aWRnZXQtbGV2ZWwgdmFyaWFibGUgc2VsZi5fcHJlcmVxcyBlbnN1cmVzIHRoYXQKCQkJLy8gY2FsbGJhY2tzIHRyaWdnZXJlZCBieSBhIHN0YWxlIC5hbmltYXRpb25Db21wbGV0ZSB3aWxsIGJlIGlnbm9yZWQuCgoJCQlwcmVyZXFzID0gewoJCQkJc2NyZWVuOiAkLkRlZmVycmVkKCksCgkJCQljb250YWluZXI6ICQuRGVmZXJyZWQoKQoJCQl9OwoKCQkJcHJlcmVxcy5zY3JlZW4udGhlbiggZnVuY3Rpb24oKSB7CgkJCQlpZiAoIHByZXJlcXMgPT09IHNlbGYuX3ByZXJlcXMgKSB7CgkJCQkJc2NyZWVuUHJlcmVxKCk7CgkJCQl9CgkJCX0pOwoKCQkJcHJlcmVxcy5jb250YWluZXIudGhlbiggZnVuY3Rpb24oKSB7CgkJCQlpZiAoIHByZXJlcXMgPT09IHNlbGYuX3ByZXJlcXMgKSB7CgkJCQkJY29udGFpbmVyUHJlcmVxKCk7CgkJCQl9CgkJCX0pOwoKCQkJJC53aGVuKCBwcmVyZXFzLnNjcmVlbiwgcHJlcmVxcy5jb250YWluZXIgKS5kb25lKCBmdW5jdGlvbigpIHsKCQkJCWlmICggcHJlcmVxcyA9PT0gc2VsZi5fcHJlcmVxcyApIHsKCQkJCQlzZWxmLl9wcmVyZXFzID0gbnVsbDsKCQkJCQl3aGVuRG9uZSgpOwoJCQkJfQoJCQl9KTsKCgkJCXNlbGYuX3ByZXJlcXMgPSBwcmVyZXFzOwoJCX0sCgoJCV9hbmltYXRlOiBmdW5jdGlvbiggYXJncyApIHsKCQkJLy8gTk9URSBiZWZvcmUgcmVtb3ZpbmcgdGhlIGRlZmF1bHQgYW5pbWF0aW9uIG9mIHRoZSBzY3JlZW4KCQkJLy8gICAgICB0aGlzIGhhZCBhbiBhbmltYXRlIGNhbGxiYWNrIHRoYXQgd291bGQgcmVsb3ZlIHRoZSBkZWZlcnJlZAoJCQkvLyAgICAgIG5vdyB0aGUgZGVmZXJyZWQgaXMgcmVzb2x2ZWQgaW1tZWRpYXRlbHkKCQkJLy8gVE9ETyByZW1vdmUgdGhlIGRlcGVuZGVuY3kgb24gdGhlIHNjcmVlbiBkZWZlcnJlZAoJCQl0aGlzLl91aS5zY3JlZW4KCQkJCS5yZW1vdmVDbGFzcyggYXJncy5jbGFzc1RvUmVtb3ZlICkKCQkJCS5hZGRDbGFzcyggYXJncy5zY3JlZW5DbGFzc1RvQWRkICk7CgoJCQlhcmdzLnByZXJlcXMuc2NyZWVuLnJlc29sdmUoKTsKCgkJCWlmICggYXJncy50cmFuc2l0aW9uICYmIGFyZ3MudHJhbnNpdGlvbiAhPT0gIm5vbmUiICkgewoJCQkJaWYgKCBhcmdzLmFwcGx5VHJhbnNpdGlvbiApIHsKCQkJCQl0aGlzLl9hcHBseVRyYW5zaXRpb24oIGFyZ3MudHJhbnNpdGlvbiApOwoJCQkJfQoJCQkJdGhpcy5fdWkuY29udGFpbmVyCgkJCQkJLmFuaW1hdGlvbkNvbXBsZXRlKCAkLnByb3h5KCBhcmdzLnByZXJlcXMuY29udGFpbmVyLCAicmVzb2x2ZSIgKSApCgkJCQkJLmFkZENsYXNzKCBhcmdzLmNvbnRhaW5lckNsYXNzVG9BZGQgKQoJCQkJCS5yZW1vdmVDbGFzcyggYXJncy5jbGFzc1RvUmVtb3ZlICk7CgkJCX0gZWxzZSB7CgkJCQlhcmdzLnByZXJlcXMuY29udGFpbmVyLnJlc29sdmUoKTsKCQkJfQoJCX0sCgoJCS8vIFRoZSBkZXNpcmVkIGNvb3JkaW5hdGVzIHBhc3NlZCBpbiB3aWxsIGJlIHJldHVybmVkIHVudG91Y2hlZCBpZiBubyByZWZlcmVuY2UgZWxlbWVudCBjYW4gYmUgaWRlbnRpZmllZCB2aWEKCQkvLyBkZXNpcmVkUG9zaXRpb24ucG9zaXRpb25Uby4gTmV2ZXJ0aGVsZXNzLCB0aGlzIGZ1bmN0aW9uIGVuc3VyZXMgdGhhdCBpdHMgcmV0dXJuIHZhbHVlIGFsd2F5cyBjb250YWlucyB2YWxpZAoJCS8vIHggYW5kIHkgY29vcmRpbmF0ZXMgYnkgc3BlY2lmeWluZyB0aGUgY2VudGVyIG1pZGRsZSBvZiB0aGUgd2luZG93IGlmIHRoZSBjb29yZGluYXRlcyBhcmUgYWJzZW50LgoJCV9kZXNpcmVkQ29vcmRzOiBmdW5jdGlvbiggeCwgeSwgcG9zaXRpb25UbyApIHsKCQkJdmFyIGRzdCA9IG51bGwsIG9mZnNldCwgd2luQ29vcmRzID0gd2luZG93Q29vcmRzKCk7CgoJCQkvLyBFc3RhYmxpc2ggd2hpY2ggZWxlbWVudCB3aWxsIHNlcnZlIGFzIHRoZSByZWZlcmVuY2UKCQkJaWYgKCBwb3NpdGlvblRvICYmIHBvc2l0aW9uVG8gIT09ICJvcmlnaW4iICkgewoJCQkJaWYgKCBwb3NpdGlvblRvID09PSAid2luZG93IiApIHsKCQkJCQl4ID0gd2luQ29vcmRzLmN4IC8gMiArIHdpbkNvb3Jkcy54OwoJCQkJCXkgPSB3aW5Db29yZHMuY3kgLyAyICsgd2luQ29vcmRzLnk7CgkJCQl9IGVsc2UgewoJCQkJCXRyeSB7CgkJCQkJCWRzdCA9ICQoIHBvc2l0aW9uVG8gKTsKCQkJCQl9IGNhdGNoKCBlICkgewoJCQkJCQlkc3QgPSBudWxsOwoJCQkJCX0KCQkJCQlpZiAoIGRzdCApIHsKCQkJCQkJZHN0LmZpbHRlciggIjp2aXNpYmxlIiApOwoJCQkJCQlpZiAoIGRzdC5sZW5ndGggPT09IDAgKSB7CgkJCQkJCQlkc3QgPSBudWxsOwoJCQkJCQl9CgkJCQkJfQoJCQkJfQoJCQl9CgoJCQkvLyBJZiBhbiBlbGVtZW50IHdhcyBmb3VuZCwgY2VudGVyIG92ZXIgaXQKCQkJaWYgKCBkc3QgKSB7CgkJCQlvZmZzZXQgPSBkc3Qub2Zmc2V0KCk7CgkJCQl4ID0gb2Zmc2V0LmxlZnQgKyBkc3Qub3V0ZXJXaWR0aCgpIC8gMjsKCQkJCXkgPSBvZmZzZXQudG9wICsgZHN0Lm91dGVySGVpZ2h0KCkgLyAyOwoJCQl9CgoJCQkvLyBNYWtlIHN1cmUgeCBhbmQgeSBhcmUgdmFsaWQgbnVtYmVycyAtIGNlbnRlciBvdmVyIHRoZSB3aW5kb3cKCQkJaWYgKCAkLnR5cGUoIHggKSAhPT0gIm51bWJlciIgfHwgaXNOYU4oIHggKSApIHsKCQkJCXggPSB3aW5Db29yZHMuY3ggLyAyICsgd2luQ29vcmRzLng7CgkJCX0KCQkJaWYgKCAkLnR5cGUoIHkgKSAhPT0gIm51bWJlciIgfHwgaXNOYU4oIHkgKSApIHsKCQkJCXkgPSB3aW5Db29yZHMuY3kgLyAyICsgd2luQ29vcmRzLnk7CgkJCX0KCgkJCXJldHVybiB7IHg6IHgsIHk6IHkgfTsKCQl9LAoKCQlfb3BlblByZXJlcXNDb21wbGV0ZTogZnVuY3Rpb24oKSB7CgkJCXZhciBzZWxmID0gdGhpczsKCgkJCXNlbGYuX3VpLmNvbnRhaW5lci5hZGRDbGFzcyggInVpLXBvcHVwLWFjdGl2ZSIgKTsKCQkJc2VsZi5faXNPcGVuID0gdHJ1ZTsKCQkJc2VsZi5fcmVzaXplU2NyZWVuKCk7CgoJCQkvLyBBbmRyb2lkIGFwcGVhcnMgdG8gdHJpZ2dlciB0aGUgYW5pbWF0aW9uIGNvbXBsZXRlIGJlZm9yZSB0aGUgcG9wdXAKCQkJLy8gaXMgdmlzaWJsZS4gQWxsb3dpbmcgdGhlIHN0YWNrIHRvIHVud2luZCBiZWZvcmUgYXBwbHlpbmcgZm9jdXMgcHJldmVudHMKCQkJLy8gdGhlICJibHVlIGZsYXNoIiBvZiBlbGVtZW50IGZvY3VzIGluIGFuZHJvaWQgNC4wCgkJCXNldFRpbWVvdXQoZnVuY3Rpb24oKXsKCQkJCXNlbGYuX3VpLmNvbnRhaW5lci5hdHRyKCAidGFiaW5kZXgiLCAiMCIgKS5mb2N1cygpOwoJCQkJc2VsZi5fdHJpZ2dlciggImFmdGVyb3BlbiIgKTsKCQkJfSk7CgkJfSwKCgkJX29wZW46IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCQl2YXIgY29vcmRzLCB0cmFuc2l0aW9uLAoJCQkJYW5kcm9pZEJsYWNrbGlzdCA9ICggZnVuY3Rpb24oKSB7CgkJCQkJdmFyIHcgPSB3aW5kb3csCgkJCQkJCXVhID0gbmF2aWdhdG9yLnVzZXJBZ2VudCwKCQkJCQkJLy8gUmVuZGVyaW5nIGVuZ2luZSBpcyBXZWJraXQsIGFuZCBjYXB0dXJlIG1ham9yIHZlcnNpb24KCQkJCQkJd2ttYXRjaCA9IHVhLm1hdGNoKCAvQXBwbGVXZWJLaXRcLyhbMC05XC5dKykvICksCgkJCQkJCXdrdmVyc2lvbiA9ICEhd2ttYXRjaCAmJiB3a21hdGNoWyAxIF0sCgkJCQkJCWFuZHJvaWRtYXRjaCA9IHVhLm1hdGNoKCAvQW5kcm9pZCAoXGQrKD86XC5cZCspKS8gKSwKCQkJCQkJYW5kdmVyc2lvbiA9ICEhYW5kcm9pZG1hdGNoICYmIGFuZHJvaWRtYXRjaFsgMSBdLAoJCQkJCQljaHJvbWVtYXRjaCA9IHVhLmluZGV4T2YoICJDaHJvbWUiICkgPiAtMTsKCgkJCQkJLy8gUGxhdGZvcm0gaXMgQW5kcm9pZCwgV2ViS2l0IHZlcnNpb24gaXMgZ3JlYXRlciB0aGFuIDUzNC4xMyAoIEFuZHJvaWQgMy4yLjEgKSBhbmQgbm90IENocm9tZS4KCQkJCQlpZiggYW5kcm9pZG1hdGNoICE9PSBudWxsICYmIGFuZHZlcnNpb24gPT09ICI0LjAiICYmIHdrdmVyc2lvbiAmJiB3a3ZlcnNpb24gPiA1MzQuMTMgJiYgIWNocm9tZW1hdGNoICkgewoJCQkJCQlyZXR1cm4gdHJ1ZTsKCQkJCQl9CgkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJfSgpKTsKCgkJCS8vIE1ha2Ugc3VyZSBvcHRpb25zIGlzIGRlZmluZWQKCQkJb3B0aW9ucyA9ICggb3B0aW9ucyB8fCB7fSApOwoKCQkJLy8gQ29weSBvdXQgdGhlIHRyYW5zaXRpb24sIGJlY2F1c2Ugd2UgbWF5IGJlIG92ZXJ3cml0aW5nIGl0IGxhdGVyIGFuZCB3ZSBkb24ndCB3YW50IHRvIHBhc3MgdGhhdCBjaGFuZ2UgYmFjayB0byB0aGUgY2FsbGVyCgkJCXRyYW5zaXRpb24gPSBvcHRpb25zLnRyYW5zaXRpb24gfHwgdGhpcy5vcHRpb25zLnRyYW5zaXRpb247CgoJCQkvLyBHaXZlIGFwcGxpY2F0aW9ucyBhIGNoYW5jZSB0byBtb2RpZnkgdGhlIGNvbnRlbnRzIG9mIHRoZSBjb250YWluZXIgYmVmb3JlIGl0IGFwcGVhcnMKCQkJdGhpcy5fdHJpZ2dlciggImJlZm9yZXBvc2l0aW9uIiApOwoKCQkJY29vcmRzID0gdGhpcy5fcGxhY2VtZW50Q29vcmRzKCB0aGlzLl9kZXNpcmVkQ29vcmRzKCBvcHRpb25zLngsIG9wdGlvbnMueSwgb3B0aW9ucy5wb3NpdGlvblRvIHx8IHRoaXMub3B0aW9ucy5wb3NpdGlvblRvIHx8ICJvcmlnaW4iICkgKTsKCgkJCS8vIENvdW50IGRvd24gdG8gdHJpZ2dlcmluZyAicG9wdXBhZnRlcm9wZW4iIC0gd2UgaGF2ZSB0d28gcHJlcmVxdWlzaXRlczoKCQkJLy8gMS4gVGhlIHBvcHVwIHdpbmRvdyBhbmltYXRpb24gY29tcGxldGVzIChjb250YWluZXIoKSkKCQkJLy8gMi4gVGhlIHNjcmVlbiBvcGFjaXR5IGFuaW1hdGlvbiBjb21wbGV0ZXMgKHNjcmVlbigpKQoJCQl0aGlzLl9jcmVhdGVQcmVyZXFzKAoJCQkJJC5ub29wLAoJCQkJJC5ub29wLAoJCQkJJC5wcm94eSggdGhpcywgIl9vcGVuUHJlcmVxc0NvbXBsZXRlIiApICk7CgoJCQlpZiAoIHRyYW5zaXRpb24gKSB7CgkJCQl0aGlzLl9jdXJyZW50VHJhbnNpdGlvbiA9IHRyYW5zaXRpb247CgkJCQl0aGlzLl9hcHBseVRyYW5zaXRpb24oIHRyYW5zaXRpb24gKTsKCQkJfSBlbHNlIHsKCQkJCXRyYW5zaXRpb24gPSB0aGlzLm9wdGlvbnMudHJhbnNpdGlvbjsKCQkJfQoKCQkJaWYgKCAhdGhpcy5vcHRpb25zLnRoZW1lICkgewoJCQkJdGhpcy5fc2V0VGhlbWUoIHRoaXMuX3BhZ2UuanFtRGF0YSggInRoZW1lIiApIHx8ICQubW9iaWxlLmdldEluaGVyaXRlZFRoZW1lKCB0aGlzLl9wYWdlLCAiYyIgKSApOwoJCQl9CgoJCQl0aGlzLl91aS5zY3JlZW4ucmVtb3ZlQ2xhc3MoICJ1aS1zY3JlZW4taGlkZGVuIiApOwoKCQkJdGhpcy5fdWkuY29udGFpbmVyCgkJCQkucmVtb3ZlQ2xhc3MoICJ1aS1zZWxlY3RtZW51LWhpZGRlbiIgKQoJCQkJLm9mZnNldCggY29vcmRzICk7CgoJCQlpZiAoIHRoaXMub3B0aW9ucy5vdmVybGF5VGhlbWUgJiYgYW5kcm9pZEJsYWNrbGlzdCApIHsKCQkJCS8qIFRPRE86CgkJCQlUaGUgbmF0aXZlIGJyb3dzZXIgb24gQW5kcm9pZCA0LjAuWCAoIkljZSBDcmVhbSBTYW5kd2ljaCIpIHN1ZmZlcnMgZnJvbSBhbiBpc3N1ZSB3aGVyZSB0aGUgcG9wdXAgb3ZlcmxheSBhcHBlYXJzIHRvIGJlIHotaW5kZXhlZAoJCQkJYWJvdmUgdGhlIHBvcHVwIGl0c2VsZiB3aGVuIGNlcnRhaW4gb3RoZXIgc3R5bGVzIGV4aXN0IG9uIHRoZSBzYW1lIHBhZ2UgLS0gbmFtZWx5LCBhbnkgZWxlbWVudCBzZXQgdG8gYHBvc2l0aW9uOiBmaXhlZGAgYW5kIGNlcnRhaW4KCQkJCXR5cGVzIG9mIGlucHV0LiBUaGVzZSBpc3N1ZXMgYXJlIHJlbWluaXNjZW50IG9mIHByZXZpb3VzbHkgdW5jb3ZlcmVkIGJ1Z3MgaW4gb2xkZXIgdmVyc2lvbnMgb2YgQW5kcm9pZCdzIG5hdGl2ZSBicm93c2VyOgoJCQkJaHR0cHM6Ly9naXRodWIuY29tL3Njb3R0amVobC9EZXZpY2UtQnVncy9pc3N1ZXMvMwoKCQkJCVRoaXMgZml4IGNsb3NlcyB0aGUgZm9sbG93aW5nIGJ1Z3MgKCBJIHVzZSAiY2xvc2VzIiB3aXRoIHJlbHVjdGFuY2UsIGFuZCBzdHJlc3MgdGhhdCB0aGlzIGlzc3VlIHNob3VsZCBiZSByZXZpc2l0ZWQgYXMgc29vbiBhcyBwb3NzaWJsZSApOgoKCQkJCWh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5LW1vYmlsZS9pc3N1ZXMvNDgxNgoJCQkJaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnktbW9iaWxlL2lzc3Vlcy80ODQ0CgkJCQlodHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L2pxdWVyeS1tb2JpbGUvaXNzdWVzLzQ4NzQKCQkJCSovCgoJCQkJLy8gVE9ETyBzb3J0IG91dCB3aHkgdGhpcy5fcGFnZSBpc24ndCB3b3JraW5nCgkJCQl0aGlzLmVsZW1lbnQuY2xvc2VzdCggIi51aS1wYWdlIiApLmFkZENsYXNzKCAidWktcG9wdXAtb3BlbiIgKTsKCQkJfQoJCQl0aGlzLl9hbmltYXRlKHsKCQkJCWFkZGl0aW9uYWxDb25kaXRpb246IHRydWUsCgkJCQl0cmFuc2l0aW9uOiB0cmFuc2l0aW9uLAoJCQkJY2xhc3NUb1JlbW92ZTogIiIsCgkJCQlzY3JlZW5DbGFzc1RvQWRkOiAiaW4iLAoJCQkJY29udGFpbmVyQ2xhc3NUb0FkZDogImluIiwKCQkJCWFwcGx5VHJhbnNpdGlvbjogZmFsc2UsCgkJCQlwcmVyZXFzOiB0aGlzLl9wcmVyZXFzCgkJCX0pOwoJCX0sCgoJCV9jbG9zZVByZXJlcVNjcmVlbjogZnVuY3Rpb24oKSB7CgkJCXRoaXMuX3VpLnNjcmVlbgoJCQkJLnJlbW92ZUNsYXNzKCAib3V0IiApCgkJCQkuYWRkQ2xhc3MoICJ1aS1zY3JlZW4taGlkZGVuIiApOwoJCX0sCgoJCV9jbG9zZVByZXJlcUNvbnRhaW5lcjogZnVuY3Rpb24oKSB7CgkJCXRoaXMuX3VpLmNvbnRhaW5lcgoJCQkJLnJlbW92ZUNsYXNzKCAicmV2ZXJzZSBvdXQiICkKCQkJCS5hZGRDbGFzcyggInVpLXNlbGVjdG1lbnUtaGlkZGVuIiApCgkJCQkucmVtb3ZlQXR0ciggInN0eWxlIiApOwoJCX0sCgoJCV9jbG9zZVByZXJlcXNEb25lOiBmdW5jdGlvbigpIHsKCQkJdmFyIHNlbGYgPSB0aGlzLCBvcHRzID0gc2VsZi5vcHRpb25zOwoKCQkJc2VsZi5fdWkuY29udGFpbmVyLnJlbW92ZUF0dHIoICJ0YWJpbmRleCIgKTsKCgkJCS8vIHJlbW92ZSBuYXYgYmluZGluZ3MgaWYgdGhleSBhcmUgc3RpbGwgcHJlc2VudAoJCQlvcHRzLmNvbnRhaW5lci51bmJpbmQoIG9wdHMuY2xvc2VFdmVudHMgKTsKCgkJCS8vIHVuYmluZCBjbGljayBoYW5kbGVycyBhZGRlZCB3aGVuIGhpc3RvcnkgaXMgZGlzYWJsZWQKCQkJc2VsZi5lbGVtZW50LnVuZGVsZWdhdGUoIG9wdHMuY2xvc2VMaW5rU2VsZWN0b3IsIG9wdHMuY2xvc2VMaW5rRXZlbnRzICk7CgoJCQkvLyByZW1vdmUgdGhlIGdsb2JhbCBtdXRleCBmb3IgcG9wdXBzCgkJCSQubW9iaWxlLnBvcHVwLmFjdGl2ZSA9IHVuZGVmaW5lZDsKCgkJCS8vIGFsZXJ0IHVzZXJzIHRoYXQgdGhlIHBvcHVwIGlzIGNsb3NlZAoJCQlzZWxmLl90cmlnZ2VyKCAiYWZ0ZXJjbG9zZSIgKTsKCQl9LAoKCQlfY2xvc2U6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLl91aS5jb250YWluZXIucmVtb3ZlQ2xhc3MoICJ1aS1wb3B1cC1hY3RpdmUiICk7CgkJCXRoaXMuX3BhZ2UucmVtb3ZlQ2xhc3MoICJ1aS1wb3B1cC1vcGVuIiApOwoKCQkJdGhpcy5faXNPcGVuID0gZmFsc2U7CgoJCQkvLyBDb3VudCBkb3duIHRvIHRyaWdnZXJpbmcgInBvcHVwYWZ0ZXJjbG9zZSIgLSB3ZSBoYXZlIHR3byBwcmVyZXF1aXNpdGVzOgoJCQkvLyAxLiBUaGUgcG9wdXAgd2luZG93IHJldmVyc2UgYW5pbWF0aW9uIGNvbXBsZXRlcyAoY29udGFpbmVyKCkpCgkJCS8vIDIuIFRoZSBzY3JlZW4gb3BhY2l0eSBhbmltYXRpb24gY29tcGxldGVzIChzY3JlZW4oKSkKCQkJdGhpcy5fY3JlYXRlUHJlcmVxcygKCQkJCSQucHJveHkoIHRoaXMsICJfY2xvc2VQcmVyZXFTY3JlZW4iICksCgkJCQkkLnByb3h5KCB0aGlzLCAiX2Nsb3NlUHJlcmVxQ29udGFpbmVyIiApLAoJCQkJJC5wcm94eSggdGhpcywgIl9jbG9zZVByZXJlcXNEb25lIiApICk7CgoJCQl0aGlzLl9hbmltYXRlKCB7CgkJCQlhZGRpdGlvbmFsQ29uZGl0aW9uOiB0aGlzLl91aS5zY3JlZW4uaGFzQ2xhc3MoICJpbiIgKSwKCQkJCXRyYW5zaXRpb246ICggdGhpcy5fY3VycmVudFRyYW5zaXRpb24gfHwgdGhpcy5vcHRpb25zLnRyYW5zaXRpb24gKSwKCQkJCWNsYXNzVG9SZW1vdmU6ICJpbiIsCgkJCQlzY3JlZW5DbGFzc1RvQWRkOiAib3V0IiwKCQkJCWNvbnRhaW5lckNsYXNzVG9BZGQ6ICJyZXZlcnNlIG91dCIsCgkJCQlhcHBseVRyYW5zaXRpb246IHRydWUsCgkJCQlwcmVyZXFzOiB0aGlzLl9wcmVyZXFzCgkJCX0pOwoJCX0sCgoJCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCQkJdmFyIHNlbGYgPSB0aGlzOwoKCQkJLy8gaGlkZSBhbmQgcmVtb3ZlIGJpbmRpbmdzCgkJCXNlbGYuX2Nsb3NlKCk7CgoJCQkvLyBQdXQgdGhlIGVsZW1lbnQgYmFjayB0byB3aGVyZSB0aGUgcGxhY2Vob2xkZXIgd2FzIGFuZCByZW1vdmUgdGhlICJ1aS1wb3B1cCIgY2xhc3MKCQkJc2VsZi5fc2V0VGhlbWUoICJub25lIiApOwoJCQlzZWxmLmVsZW1lbnQKCQkJCS5pbnNlcnRBZnRlciggc2VsZi5fdWkucGxhY2Vob2xkZXIgKQoJCQkJLnJlbW92ZUNsYXNzKCAidWktcG9wdXAgdWktb3ZlcmxheS1zaGFkb3cgdWktY29ybmVyLWFsbCIgKTsKCQkJc2VsZi5fdWkuc2NyZWVuLnJlbW92ZSgpOwoJCQlzZWxmLl91aS5jb250YWluZXIucmVtb3ZlKCk7CgkJCXNlbGYuX3VpLnBsYWNlaG9sZGVyLnJlbW92ZSgpOwoKCQkJLy8gVW5iaW5kIGhhbmRsZXJzIHRoYXQgd2VyZSBib3VuZCB0byBlbGVtZW50cyBvdXRzaWRlIHNlbGYuZWxlbWVudCAodGhlIHdpbmRvdywgaW4gc2VsZiBjYXNlKQoJCQkkLmVhY2goIHNlbGYuX2dsb2JhbEhhbmRsZXJzLCBmdW5jdGlvbiggaWR4LCBvbmVTcmMgKSB7CgkJCQkkLmVhY2goIG9uZVNyYy5oYW5kbGVyLCBmdW5jdGlvbiggZXZlbnRUeXBlLCBoYW5kbGVyICkgewoJCQkJCW9uZVNyYy5zcmMudW5iaW5kKCBldmVudFR5cGUsIGhhbmRsZXIgKTsKCQkJCX0pOwoJCQl9KTsKCQl9LAoKCQkvLyBhbnkgbmF2aWdhdGlvbiBldmVudCBhZnRlciBhIHBvcHVwIGlzIG9wZW5lZCBzaG91bGQgY2xvc2UgdGhlIHBvcHVwCgkJLy8gTk9URSB0aGUgcGFnZWJlZm9yZWNoYW5nZSBpcyBib3VuZCB0byBjYXRjaCBuYXZpZ2F0aW9uIGV2ZW50cyB0aGF0IGRvbid0CgkJLy8gICAgICBhbHRlciB0aGUgdXJsIChlZywgZGlhbG9ncyBmcm9tIHBvcHVwcykKCQlfYmluZENvbnRhaW5lckNsb3NlOiBmdW5jdGlvbigpIHsKCQkJdmFyIHNlbGYgPSB0aGlzOwoKCQkJc2VsZi5vcHRpb25zLmNvbnRhaW5lcgoJCQkJLm9uZSggc2VsZi5vcHRpb25zLmNsb3NlRXZlbnRzLCAkLnByb3h5KCBzZWxmLl9jbG9zZSwgc2VsZiApKTsKCQl9LAoKCQkvLyBUT0RPIG5vIGNsZWFyIGRlbGluaWF0aW9uIG9mIHdoYXQgc2hvdWxkIGJlIGhlcmUgYW5kCgkJLy8gd2hhdCBzaG91bGQgYmUgaW4gX29wZW4uIFNlZW1zIHRvIGJlICJ2aXN1YWwiIHZzICJoaXN0b3J5IiBmb3Igbm93CgkJb3BlbjogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJCXZhciBzZWxmID0gdGhpcywgb3B0cyA9IHRoaXMub3B0aW9ucywgdXJsLCBoYXNoa2V5LCBhY3RpdmVQYWdlLCBjdXJyZW50SXNEaWFsb2csIGhhc0hhc2gsIHVybEhpc3Rvcnk7CgoJCQkvLyBtYWtlIHN1cmUgb3BlbiBpcyBpZGVtcG90ZW50CgkJCWlmKCAkLm1vYmlsZS5wb3B1cC5hY3RpdmUgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIHNldCB0aGUgZ2xvYmFsIHBvcHVwIG11dGV4CgkJCSQubW9iaWxlLnBvcHVwLmFjdGl2ZSA9IHRoaXM7CgoJCQkvLyBpZiBoaXN0b3J5IGFsdGVyYXRpb24gaXMgZGlzYWJsZWQgY2xvc2Ugb24gbmF2aWdhdGUgZXZlbnRzCgkJCS8vIGFuZCBsZWF2ZSB0aGUgdXJsIGFzIGlzCgkJCWlmKCAhKCBvcHRzLmhpc3RvcnkgKSApIHsKCQkJCXNlbGYuX29wZW4oIG9wdGlvbnMgKTsKCQkJCXNlbGYuX2JpbmRDb250YWluZXJDbG9zZSgpOwoKCQkJCS8vIFdoZW4gaGlzdG95IGlzIGRpc2FibGVkIHdlIGhhdmUgdG8gZ3JhYiB0aGUgZGF0YS1yZWwKCQkJCS8vIGJhY2sgbGluayBjbGlja3Mgc28gd2UgY2FuIGNsb3NlIHRoZSBwb3B1cCBpbnN0ZWFkIG9mCgkJCQkvLyByZWx5aW5nIG9uIGhpc3RvcnkgdG8gZG8gaXQgZm9yIHVzCgkJCQlzZWxmLmVsZW1lbnQKCQkJCQkuZGVsZWdhdGUoIG9wdHMuY2xvc2VMaW5rU2VsZWN0b3IsIG9wdHMuY2xvc2VMaW5rRXZlbnRzLCBmdW5jdGlvbiggZSApIHsKCQkJCQkJc2VsZi5fY2xvc2UoKTsKCgkJCQkJCS8vIE5PVEUgcHJldmVudCB0aGUgYnJvd3NlciBhbmQgbmF2aWdhdGlvbiBoYW5kbGVycyBmcm9tCgkJCQkJCS8vIHdvcmtpbmcgd2l0aCB0aGUgbGluaydzIHJlbD1iYWNrLiBUaGlzIG1heSBjYXVzZQoJCQkJCQkvLyBpc3N1ZXMgZm9yIGRldmVsb3BlcnMgZXhwZWN0aW5nIHRoZSBldmVudCB0byBidWJibGUKCQkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJCX0pOwoKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gY2FjaGUgc29tZSB2YWx1ZXMgZm9yIG1pbi9yZWFkYWJpbGl0eQoJCQloYXNoa2V5ID0gJC5tb2JpbGUuZGlhbG9nSGFzaEtleTsKCQkJYWN0aXZlUGFnZSA9ICQubW9iaWxlLmFjdGl2ZVBhZ2U7CgkJCWN1cnJlbnRJc0RpYWxvZyA9IGFjdGl2ZVBhZ2UuaXMoICIudWktZGlhbG9nIiApOwoJCQl1cmwgPSAkLm1vYmlsZS51cmxIaXN0b3J5LmdldEFjdGl2ZSgpLnVybDsKCQkJaGFzSGFzaCA9ICggdXJsLmluZGV4T2YoIGhhc2hrZXkgKSA+IC0xICkgJiYgIWN1cnJlbnRJc0RpYWxvZzsKCQkJdXJsSGlzdG9yeSA9ICQubW9iaWxlLnVybEhpc3Rvcnk7CgoJCQlpZiAoIGhhc0hhc2ggKSB7CgkJCQlzZWxmLl9vcGVuKCBvcHRpb25zICk7CgkJCQlzZWxmLl9iaW5kQ29udGFpbmVyQ2xvc2UoKTsKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gaWYgdGhlIGN1cnJlbnQgdXJsIGhhcyBubyBkaWFsb2cgaGFzaCBrZXkgcHJvY2VlZCBhcyBub3JtYWwKCQkJLy8gb3RoZXJ3aXNlLCBpZiB0aGUgcGFnZSBpcyBhIGRpYWxvZyBzaW1wbHkgdGFjayBvbiB0aGUgaGFzaCBrZXkKCQkJaWYgKCB1cmwuaW5kZXhPZiggaGFzaGtleSApID09PSAtMSAmJiAhY3VycmVudElzRGlhbG9nICl7CgkJCQl1cmwgPSB1cmwgKyBoYXNoa2V5OwoJCQl9IGVsc2UgewoJCQkJdXJsID0gJC5tb2JpbGUucGF0aC5wYXJzZUxvY2F0aW9uKCkuaGFzaCArIGhhc2hrZXk7CgkJCX0KCgkJCS8vIFRhY2sgb24gYW4gZXh0cmEgaGFzaGtleSBpZiB0aGlzIGlzIHRoZSBmaXJzdCBwYWdlIGFuZCB3ZSd2ZSBqdXN0IHJlY29uc3RydWN0ZWQgdGhlIGluaXRpYWwgaGFzaAoJCQlpZiAoIHVybEhpc3RvcnkuYWN0aXZlSW5kZXggPT09IDAgJiYgdXJsID09PSB1cmxIaXN0b3J5LmluaXRpYWxEc3QgKSB7CgkJCQl1cmwgKz0gaGFzaGtleTsKCQkJfQoKCQkJLy8gc3dhbGxvdyB0aGUgdGhlIGluaXRpYWwgbmF2aWdhdGlvbiBldmVudCwgYW5kIGJpbmQgZm9yIHRoZSBuZXh0CgkJCW9wdHMuY29udGFpbmVyLm9uZSggb3B0cy5uYXZpZ2F0ZUV2ZW50cywgZnVuY3Rpb24oIGUgKSB7CgkJCQllLnByZXZlbnREZWZhdWx0KCk7CgkJCQlzZWxmLl9vcGVuKCBvcHRpb25zICk7CgkJCQlzZWxmLl9iaW5kQ29udGFpbmVyQ2xvc2UoKTsKCQkJfSk7CgoJCQl1cmxIaXN0b3J5Lmlnbm9yZU5leHRIYXNoQ2hhbmdlID0gY3VycmVudElzRGlhbG9nOwoKCQkJLy8gR290dGEgbG92ZSBtZXRob2RzIHdpdGggMW1tIGFyZ3MgOigKCQkJdXJsSGlzdG9yeS5hZGROZXcoIHVybCwgdW5kZWZpbmVkLCB1bmRlZmluZWQsIHVuZGVmaW5lZCwgImRpYWxvZyIgKTsKCgkJCS8vIHNldCB0aGUgbmV3IHVybCB3aXRoIChvciB3aXRob3V0KSB0aGUgbmV3IGRpYWxvZyBoYXNoIGtleQoJCQkkLm1vYmlsZS5wYXRoLnNldCggdXJsICk7CgkJfSwKCgkJY2xvc2U6IGZ1bmN0aW9uKCkgewoJCQkvLyBtYWtlIHN1cmUgY2xvc2UgaXMgaWRlbXBvdGVudAoJCQlpZiggISQubW9iaWxlLnBvcHVwLmFjdGl2ZSApewoJCQkJcmV0dXJuOwoJCQl9CgoJCQlpZiggdGhpcy5vcHRpb25zLmhpc3RvcnkgKSB7CgkJCQkkLm1vYmlsZS5iYWNrKCk7CgkJCX0gZWxzZSB7CgkJCQl0aGlzLl9jbG9zZSgpOwoJCQl9CgkJfQoJfSk7CgoKCS8vIFRPRE8gdGhpcyBjYW4gYmUgbW92ZWQgaW5zaWRlIHRoZSB3aWRnZXQKCSQubW9iaWxlLnBvcHVwLmhhbmRsZUxpbmsgPSBmdW5jdGlvbiggJGxpbmsgKSB7CgkJdmFyIGNsb3Nlc3RQYWdlID0gJGxpbmsuY2xvc2VzdCggIjpqcW1EYXRhKHJvbGU9J3BhZ2UnKSIgKSwKCQkJc2NvcGUgPSAoICggY2xvc2VzdFBhZ2UubGVuZ3RoID09PSAwICkgPyAkKCAiYm9keSIgKSA6IGNsb3Nlc3RQYWdlICksCgkJCS8vIE5PVEUgbWFrZSBzdXJlIHRvIGdldCBvbmx5IHRoZSBoYXNoLCBpZTcgKHdwNykgcmV0dXJuIHRoZSBhYnNvbHV0ZSBocmVmCgkJCS8vICAgICAgaW4gdGhpcyBjYXNlIHJ1aW5pbmcgdGhlIGVsZW1lbnQgc2VsZWN0aW9uCgkJCXBvcHVwID0gJCggJC5tb2JpbGUucGF0aC5wYXJzZVVybCgkbGluay5hdHRyKCAiaHJlZiIgKSkuaGFzaCwgc2NvcGVbMF0gKSwKCQkJb2Zmc2V0OwoKCQlpZiAoIHBvcHVwLmRhdGEoICJwb3B1cCIgKSApIHsKCQkJb2Zmc2V0ID0gJGxpbmsub2Zmc2V0KCk7CgkJCXBvcHVwLnBvcHVwKCAib3BlbiIsIHsKCQkJCXg6IG9mZnNldC5sZWZ0ICsgJGxpbmsub3V0ZXJXaWR0aCgpIC8gMiwKCQkJCXk6IG9mZnNldC50b3AgKyAkbGluay5vdXRlckhlaWdodCgpIC8gMiwKCQkJCXRyYW5zaXRpb246ICRsaW5rLmpxbURhdGEoICJ0cmFuc2l0aW9uIiApLAoJCQkJcG9zaXRpb25UbzogJGxpbmsuanFtRGF0YSggInBvc2l0aW9uLXRvIiApLAoJCQkJbGluazogJGxpbmsKCQkJfSk7CgkJfQoKCQkvL3JlbW92ZSBhZnRlciBkZWxheQoJCXNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCQkkbGluay5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQl9LCAzMDAgKTsKCX07CgoJLy8gVE9ETyBtb3ZlIGluc2lkZSBfY3JlYXRlCgkkKCBkb2N1bWVudCApLmJpbmQoICJwYWdlYmVmb3JlY2hhbmdlIiwgZnVuY3Rpb24oIGUsIGRhdGEgKSB7CgkJaWYgKCBkYXRhLm9wdGlvbnMucm9sZSA9PT0gInBvcHVwIiApIHsKCQkJJC5tb2JpbGUucG9wdXAuaGFuZGxlTGluayggZGF0YS5vcHRpb25zLmxpbmsgKTsKCQkJZS5wcmV2ZW50RGVmYXVsdCgpOwoJCX0KCX0pOwoKCSQoIGRvY3VtZW50ICkuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKSAgewoJCSQubW9iaWxlLnBvcHVwLnByb3RvdHlwZS5lbmhhbmNlV2l0aGluKCBlLnRhcmdldCwgdHJ1ZSApOwoJfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQgKSB7Cgl2YXIJbWV0YSA9ICQoICJtZXRhW25hbWU9dmlld3BvcnRdIiApLAoJCWluaXRpYWxDb250ZW50ID0gbWV0YS5hdHRyKCAiY29udGVudCIgKSwKCQlkaXNhYmxlZFpvb20gPSBpbml0aWFsQ29udGVudCArICIsbWF4aW11bS1zY2FsZT0xLCB1c2VyLXNjYWxhYmxlPW5vIiwKCQllbmFibGVkWm9vbSA9IGluaXRpYWxDb250ZW50ICsgIixtYXhpbXVtLXNjYWxlPTEwLCB1c2VyLXNjYWxhYmxlPXllcyIsCgkJZGlzYWJsZWRJbml0aWFsbHkgPSAvKHVzZXItc2NhbGFibGVbXHNdKj1bXHNdKm5vKXwobWF4aW11bS1zY2FsZVtcc10qPVtcc10qMSlbJCxcc10vLnRlc3QoIGluaXRpYWxDb250ZW50ICk7CgoJJC5tb2JpbGUuem9vbSA9ICQuZXh0ZW5kKCB7fSwgewoJCWVuYWJsZWQ6ICFkaXNhYmxlZEluaXRpYWxseSwKCQlsb2NrZWQ6IGZhbHNlLAoJCWRpc2FibGU6IGZ1bmN0aW9uKCBsb2NrICkgewoJCQlpZiAoICFkaXNhYmxlZEluaXRpYWxseSAmJiAhJC5tb2JpbGUuem9vbS5sb2NrZWQgKSB7CgkJCQltZXRhLmF0dHIoICJjb250ZW50IiwgZGlzYWJsZWRab29tICk7CgkJCQkkLm1vYmlsZS56b29tLmVuYWJsZWQgPSBmYWxzZTsKCQkJCSQubW9iaWxlLnpvb20ubG9ja2VkID0gbG9jayB8fCBmYWxzZTsKCQkJfQoJCX0sCgkJZW5hYmxlOiBmdW5jdGlvbiggdW5sb2NrICkgewoJCQlpZiAoICFkaXNhYmxlZEluaXRpYWxseSAmJiAoICEkLm1vYmlsZS56b29tLmxvY2tlZCB8fCB1bmxvY2sgPT09IHRydWUgKSApIHsKCQkJCW1ldGEuYXR0ciggImNvbnRlbnQiLCBlbmFibGVkWm9vbSApOwoJCQkJJC5tb2JpbGUuem9vbS5lbmFibGVkID0gdHJ1ZTsKCQkJCSQubW9iaWxlLnpvb20ubG9ja2VkID0gZmFsc2U7CgkJCX0KCQl9LAoJCXJlc3RvcmU6IGZ1bmN0aW9uKCkgewoJCQlpZiAoICFkaXNhYmxlZEluaXRpYWxseSApIHsKCQkJCW1ldGEuYXR0ciggImNvbnRlbnQiLCBpbml0aWFsQ29udGVudCApOwoJCQkJJC5tb2JpbGUuem9vbS5lbmFibGVkID0gdHJ1ZTsKCQkJfQoJCX0KCX0pOwoKfSggalF1ZXJ5ICkpOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS50ZXh0aW5wdXQiLCAkLm1vYmlsZS53aWRnZXQsIHsKCW9wdGlvbnM6IHsKCQl0aGVtZTogbnVsbCwKCQkvLyBUaGlzIG9wdGlvbiBkZWZhdWx0cyB0byB0cnVlIG9uIGlPUyBkZXZpY2VzLgoJCXByZXZlbnRGb2N1c1pvb206IC9pUGhvbmV8aVBhZHxpUG9kLy50ZXN0KCBuYXZpZ2F0b3IucGxhdGZvcm0gKSAmJiBuYXZpZ2F0b3IudXNlckFnZW50LmluZGV4T2YoICJBcHBsZVdlYktpdCIgKSA+IC0xLAoJCWluaXRTZWxlY3RvcjogImlucHV0W3R5cGU9J3RleHQnXSwgaW5wdXRbdHlwZT0nc2VhcmNoJ10sIDpqcW1EYXRhKHR5cGU9J3NlYXJjaCcpLCBpbnB1dFt0eXBlPSdudW1iZXInXSwgOmpxbURhdGEodHlwZT0nbnVtYmVyJyksIGlucHV0W3R5cGU9J3Bhc3N3b3JkJ10sIGlucHV0W3R5cGU9J2VtYWlsJ10sIGlucHV0W3R5cGU9J3VybCddLCBpbnB1dFt0eXBlPSd0ZWwnXSwgdGV4dGFyZWEsIGlucHV0W3R5cGU9J3RpbWUnXSwgaW5wdXRbdHlwZT0nZGF0ZSddLCBpbnB1dFt0eXBlPSdtb250aCddLCBpbnB1dFt0eXBlPSd3ZWVrJ10sIGlucHV0W3R5cGU9J2RhdGV0aW1lJ10sIGlucHV0W3R5cGU9J2RhdGV0aW1lLWxvY2FsJ10sIGlucHV0W3R5cGU9J2NvbG9yJ10sIGlucHV0Om5vdChbdHlwZV0pIiwKCQljbGVhclNlYXJjaEJ1dHRvblRleHQ6ICJjbGVhciB0ZXh0IiwKCQlkaXNhYmxlZDogZmFsc2UKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgoJCXZhciBzZWxmID0gdGhpcywKCQkJaW5wdXQgPSB0aGlzLmVsZW1lbnQsCgkJCW8gPSB0aGlzLm9wdGlvbnMsCgkJCXRoZW1lID0gby50aGVtZSB8fCAkLm1vYmlsZS5nZXRJbmhlcml0ZWRUaGVtZSggdGhpcy5lbGVtZW50LCAiYyIgKSwKCQkJdGhlbWVjbGFzcyAgPSAiIHVpLWJvZHktIiArIHRoZW1lLAoJCQltaW5pID0gaW5wdXQuanFtRGF0YSggIm1pbmkiICkgPT09IHRydWUsCgkJCW1pbmljbGFzcyA9IG1pbmkgPyAiIHVpLW1pbmkiIDogIiIsCgkJCWZvY3VzZWRFbCwgY2xlYXJidG47CgoJCWZ1bmN0aW9uIHRvZ2dsZUNsZWFyKCkgewoJCQlzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJCWNsZWFyYnRuLnRvZ2dsZUNsYXNzKCAidWktaW5wdXQtY2xlYXItaGlkZGVuIiwgIWlucHV0LnZhbCgpICk7CgkJCX0sIDAgKTsKCQl9CgoJCSQoICJsYWJlbFtmb3I9JyIgKyBpbnB1dC5hdHRyKCAiaWQiICkgKyAiJ10iICkuYWRkQ2xhc3MoICJ1aS1pbnB1dC10ZXh0IiApOwoKCQlmb2N1c2VkRWwgPSBpbnB1dC5hZGRDbGFzcygidWktaW5wdXQtdGV4dCB1aS1ib2R5LSIrIHRoZW1lICk7CgoJCS8vIFhYWDogVGVtcG9yYXJ5IHdvcmthcm91bmQgZm9yIGlzc3VlIDc4NSAoQXBwbGUgYnVnIDg5MTA1ODkpLgoJCS8vICAgICAgVHVybiBvZmYgYXV0b2NvcnJlY3QgYW5kIGF1dG9jb21wbGV0ZSBvbiBub24taU9TIDUgZGV2aWNlcwoJCS8vICAgICAgc2luY2UgdGhlIHBvcHVwIHRoZXkgdXNlIGNhbid0IGJlIGRpc21pc3NlZCBieSB0aGUgdXNlci4gTm90ZQoJCS8vICAgICAgdGhhdCB3ZSB0ZXN0IGZvciB0aGUgcHJlc2VuY2Ugb2YgdGhlIGZlYXR1cmUgYnkgbG9va2luZyBmb3IKCQkvLyAgICAgIHRoZSBhdXRvY29ycmVjdCBwcm9wZXJ0eSBvbiB0aGUgaW5wdXQgZWxlbWVudC4gV2UgY3VycmVudGx5CgkJLy8gICAgICBoYXZlIG5vIHRlc3QgZm9yIGlPUyA1IG9yIG5ld2VyIHNvIHdlJ3JlIHRlbXBvcmFyaWx5IHVzaW5nCgkJLy8gICAgICB0aGUgdG91Y2hPdmVyZmxvdyBzdXBwb3J0IGZsYWcgZm9yIGpRTSAxLjAuIFllcywgSSBmZWVsIGRpcnR5LiAtIGpibGFzCgkJaWYgKCB0eXBlb2YgaW5wdXRbMF0uYXV0b2NvcnJlY3QgIT09ICJ1bmRlZmluZWQiICYmICEkLnN1cHBvcnQudG91Y2hPdmVyZmxvdyApIHsKCQkJLy8gU2V0IHRoZSBhdHRyaWJ1dGUgaW5zdGVhZCBvZiB0aGUgcHJvcGVydHkganVzdCBpbiBjYXNlIHRoZXJlCgkJCS8vIGlzIGNvZGUgdGhhdCBhdHRlbXB0cyB0byBtYWtlIG1vZGlmaWNhdGlvbnMgdmlhIEhUTUwuCgkJCWlucHV0WzBdLnNldEF0dHJpYnV0ZSggImF1dG9jb3JyZWN0IiwgIm9mZiIgKTsKCQkJaW5wdXRbMF0uc2V0QXR0cmlidXRlKCAiYXV0b2NvbXBsZXRlIiwgIm9mZiIgKTsKCQl9CgoKCQkvLyJzZWFyY2giIGlucHV0IHdpZGdldAoJCWlmICggaW5wdXQuaXMoICJbdHlwZT0nc2VhcmNoJ10sOmpxbURhdGEodHlwZT0nc2VhcmNoJykiICkgKSB7CgoJCQlmb2N1c2VkRWwgPSBpbnB1dC53cmFwKCAiPGRpdiBjbGFzcz0ndWktaW5wdXQtc2VhcmNoIHVpLXNoYWRvdy1pbnNldCB1aS1idG4tY29ybmVyLWFsbCB1aS1idG4tc2hhZG93IHVpLWljb24tc2VhcmNoZmllbGQiICsgdGhlbWVjbGFzcyArIG1pbmljbGFzcyArICInPjwvZGl2PiIgKS5wYXJlbnQoKTsKCQkJY2xlYXJidG4gPSAkKCAiPGEgaHJlZj0nIycgY2xhc3M9J3VpLWlucHV0LWNsZWFyJyB0aXRsZT0nIiArIG8uY2xlYXJTZWFyY2hCdXR0b25UZXh0ICsgIic+IiArIG8uY2xlYXJTZWFyY2hCdXR0b25UZXh0ICsgIjwvYT4iICkKCQkJCS5iaW5kKCdjbGljaycsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCQlpbnB1dAoJCQkJCQkudmFsKCAiIiApCgkJCQkJCS5mb2N1cygpCgkJCQkJCS50cmlnZ2VyKCAiY2hhbmdlIiApOwoJCQkJCWNsZWFyYnRuLmFkZENsYXNzKCAidWktaW5wdXQtY2xlYXItaGlkZGVuIiApOwoJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQl9KQoJCQkJLmFwcGVuZFRvKCBmb2N1c2VkRWwgKQoJCQkJLmJ1dHRvbk1hcmt1cCh7CgkJCQkJaWNvbjogImRlbGV0ZSIsCgkJCQkJaWNvbnBvczogIm5vdGV4dCIsCgkJCQkJY29ybmVyczogdHJ1ZSwKCQkJCQlzaGFkb3c6IHRydWUsCgkJCQkJbWluaTogbWluaQoJCQkJfSk7CgoJCQl0b2dnbGVDbGVhcigpOwoKCQkJaW5wdXQuYmluZCggJ3Bhc3RlIGN1dCBrZXl1cCBmb2N1cyBjaGFuZ2UgYmx1cicsIHRvZ2dsZUNsZWFyICk7CgoJCX0gZWxzZSB7CgkJCWlucHV0LmFkZENsYXNzKCAidWktY29ybmVyLWFsbCB1aS1zaGFkb3ctaW5zZXQiICsgdGhlbWVjbGFzcyArIG1pbmljbGFzcyApOwoJCX0KCgkJaW5wdXQuZm9jdXMoZnVuY3Rpb24oKSB7CgkJCQlmb2N1c2VkRWwuYWRkQ2xhc3MoICQubW9iaWxlLmZvY3VzQ2xhc3MgKTsKCQkJfSkKCQkJLmJsdXIoZnVuY3Rpb24oKSB7CgkJCQlmb2N1c2VkRWwucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmZvY3VzQ2xhc3MgKTsKCQkJfSkKCQkJLy8gSW4gbWFueSBzaXR1YXRpb25zLCBpT1Mgd2lsbCB6b29tIGludG8gdGhlIHNlbGVjdCB1cG9uIHRhcCwgdGhpcyBwcmV2ZW50cyB0aGF0IGZyb20gaGFwcGVuaW5nCgkJCS5iaW5kKCAiZm9jdXMiLCBmdW5jdGlvbigpIHsKCQkJCWlmICggby5wcmV2ZW50Rm9jdXNab29tICkgewoJCQkJCSQubW9iaWxlLnpvb20uZGlzYWJsZSggdHJ1ZSApOwoJCQkJfQoJCQl9KQoJCQkuYmluZCggImJsdXIiLCBmdW5jdGlvbigpIHsKCQkJCWlmICggby5wcmV2ZW50Rm9jdXNab29tICkgewoJCQkJCSQubW9iaWxlLnpvb20uZW5hYmxlKCB0cnVlICk7CgkJCQl9CgkJCX0pOwoKCQkvLyBBdXRvZ3JvdwoJCWlmICggaW5wdXQuaXMoICJ0ZXh0YXJlYSIgKSApIHsKCQkJdmFyIGV4dHJhTGluZUhlaWdodCA9IDE1LAoJCQkJa2V5dXBUaW1lb3V0QnVmZmVyID0gMTAwLAoJCQkJa2V5dXBUaW1lb3V0OwoKCQkJdGhpcy5fa2V5dXAgPSBmdW5jdGlvbigpIHsKCQkJCXZhciBzY3JvbGxIZWlnaHQgPSBpbnB1dFsgMCBdLnNjcm9sbEhlaWdodCwKCQkJCQljbGllbnRIZWlnaHQgPSBpbnB1dFsgMCBdLmNsaWVudEhlaWdodDsKCgkJCQlpZiAoIGNsaWVudEhlaWdodCA8IHNjcm9sbEhlaWdodCApIHsKCQkJCQlpbnB1dC5oZWlnaHQoc2Nyb2xsSGVpZ2h0ICsgZXh0cmFMaW5lSGVpZ2h0KTsKCQkJCX0KCQkJfTsKCgkJCWlucHV0LmtleXVwKGZ1bmN0aW9uKCkgewoJCQkJY2xlYXJUaW1lb3V0KCBrZXl1cFRpbWVvdXQgKTsKCQkJCWtleXVwVGltZW91dCA9IHNldFRpbWVvdXQoIHNlbGYuX2tleXVwLCBrZXl1cFRpbWVvdXRCdWZmZXIgKTsKCQkJfSk7CgoJCQkvLyBiaW5kaW5nIHRvIHBhZ2VjaGFuZ2UgaGVyZSBlbnN1cmVzIHRoYXQgZm9yIHBhZ2VzIGxvYWRlZCB2aWEKCQkJLy8gYWpheCB0aGUgaGVpZ2h0IGlzIHJlY2FsY3VsYXRlZCB3aXRob3V0IHVzZXIgaW5wdXQKCQkJdGhpcy5fb24oICQoZG9jdW1lbnQpLCB7InBhZ2VjaGFuZ2UiOiAiX2tleXVwIiB9KTsKCgkJCS8vIElzc3VlIDUwOTogdGhlIGJyb3dzZXIgaXMgbm90IHByb3ZpZGluZyBzY3JvbGxIZWlnaHQgcHJvcGVybHkgdW50aWwgdGhlIHN0eWxlcyBsb2FkCgkJCWlmICggJC50cmltKCBpbnB1dC52YWwoKSApICkgewoJCQkJLy8gYmluZCB0byB0aGUgd2luZG93IGxvYWQgdG8gbWFrZSBzdXJlIHRoZSBoZWlnaHQgaXMgY2FsY3VsYXRlZCBiYXNlZCBvbiBCT1RICgkJCQkvLyB0aGUgRE9NIGFuZCBDU1MKCQkJCXRoaXMuX29uKCAkKHdpbmRvdyksIHsibG9hZCI6ICJfa2V5dXAifSk7CgkJCX0KCQl9CgkJaWYgKCBpbnB1dC5hdHRyKCAiZGlzYWJsZWQiICkgKSB7CgkJCXRoaXMuZGlzYWJsZSgpOwoJCX0KCX0sCgoJZGlzYWJsZTogZnVuY3Rpb24oKSB7CgkJdmFyICRlbDsKCQlpZiAoIHRoaXMuZWxlbWVudC5hdHRyKCAiZGlzYWJsZWQiLCB0cnVlICkuaXMoICJbdHlwZT0nc2VhcmNoJ10sIDpqcW1EYXRhKHR5cGU9J3NlYXJjaCcpIiApICkgewoJCQkkZWwgPSB0aGlzLmVsZW1lbnQucGFyZW50KCk7CgkJfSBlbHNlIHsKCQkJJGVsID0gdGhpcy5lbGVtZW50OwoJCX0KCQkkZWwuYWRkQ2xhc3MoICJ1aS1kaXNhYmxlZCIgKTsKCQlyZXR1cm4gdGhpcy5fc2V0T3B0aW9uKCAiZGlzYWJsZWQiLCB0cnVlICk7Cgl9LAoKCWVuYWJsZTogZnVuY3Rpb24oKSB7CgkJdmFyICRlbDsKCgkJLy8gVE9ETyB1c2luZyBtb3JlIHRoYW4gb25lIGxpbmUgb2YgY29kZSBpcyBhY2NlcHRhYmxlIDspCgkJaWYgKCB0aGlzLmVsZW1lbnQuYXR0ciggImRpc2FibGVkIiwgZmFsc2UgKS5pcyggIlt0eXBlPSdzZWFyY2gnXSwgOmpxbURhdGEodHlwZT0nc2VhcmNoJykiICkgKSB7CgkJCSRlbCA9IHRoaXMuZWxlbWVudC5wYXJlbnQoKTsKCQl9IGVsc2UgewoJCQkkZWwgPSB0aGlzLmVsZW1lbnQ7CgkJfQoJCSRlbC5yZW1vdmVDbGFzcyggInVpLWRpc2FibGVkIiApOwoJCXJldHVybiB0aGlzLl9zZXRPcHRpb24oICJkaXNhYmxlZCIsIGZhbHNlICk7Cgl9Cn0pOwoKLy9hdXRvIHNlbGYtaW5pdCB3aWRnZXRzCiQoIGRvY3VtZW50ICkuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKSB7CgkkLm1vYmlsZS50ZXh0aW5wdXQucHJvdG90eXBlLmVuaGFuY2VXaXRoaW4oIGUudGFyZ2V0LCB0cnVlICk7Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS5saXN0dmlldy5wcm90b3R5cGUub3B0aW9ucy5maWx0ZXIgPSBmYWxzZTsKJC5tb2JpbGUubGlzdHZpZXcucHJvdG90eXBlLm9wdGlvbnMuZmlsdGVyUGxhY2Vob2xkZXIgPSAiRmlsdGVyIGl0ZW1zLi4uIjsKJC5tb2JpbGUubGlzdHZpZXcucHJvdG90eXBlLm9wdGlvbnMuZmlsdGVyVGhlbWUgPSAiYyI7Ci8vIFRPRE8gcmVuYW1lIGNhbGxiYWNrL2RlcHJlY2F0ZSBhbmQgZGVmYXVsdCB0byB0aGUgaXRlbSBpdHNlbGYgYXMgdGhlIGZpcnN0IGFyZ3VtZW50CnZhciBkZWZhdWx0RmlsdGVyQ2FsbGJhY2sgPSBmdW5jdGlvbiggdGV4dCwgc2VhcmNoVmFsdWUsIGl0ZW0gKSB7CgkJcmV0dXJuIHRleHQudG9TdHJpbmcoKS50b0xvd2VyQ2FzZSgpLmluZGV4T2YoIHNlYXJjaFZhbHVlICkgPT09IC0xOwoJfTsKCiQubW9iaWxlLmxpc3R2aWV3LnByb3RvdHlwZS5vcHRpb25zLmZpbHRlckNhbGxiYWNrID0gZGVmYXVsdEZpbHRlckNhbGxiYWNrOwoKJCggZG9jdW1lbnQgKS5kZWxlZ2F0ZSggIjpqcW1EYXRhKHJvbGU9J2xpc3R2aWV3JykiLCAibGlzdHZpZXdjcmVhdGUiLCBmdW5jdGlvbigpIHsKCgl2YXIgbGlzdCA9ICQoIHRoaXMgKSwKCQlsaXN0dmlldyA9IGxpc3QuZGF0YSggImxpc3R2aWV3IiApOwoKCWlmICggIWxpc3R2aWV3Lm9wdGlvbnMuZmlsdGVyICkgewoJCXJldHVybjsKCX0KCgl2YXIgd3JhcHBlciA9ICQoICI8Zm9ybT4iLCB7CgkJCSJjbGFzcyI6ICJ1aS1saXN0dmlldy1maWx0ZXIgdWktYmFyLSIgKyBsaXN0dmlldy5vcHRpb25zLmZpbHRlclRoZW1lLAoJCQkicm9sZSI6ICJzZWFyY2giCgkJfSksCgkJc2VhcmNoID0gJCggIjxpbnB1dD4iLCB7CgkJCXBsYWNlaG9sZGVyOiBsaXN0dmlldy5vcHRpb25zLmZpbHRlclBsYWNlaG9sZGVyCgkJfSkKCQkuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgInR5cGUiLCAic2VhcmNoIiApCgkJLmpxbURhdGEoICJsYXN0dmFsIiwgIiIgKQoJCS5iaW5kKCAia2V5dXAgY2hhbmdlIiwgZnVuY3Rpb24oKSB7CgoJCQl2YXIgJHRoaXMgPSAkKCB0aGlzICksCgkJCQl2YWwgPSB0aGlzLnZhbHVlLnRvTG93ZXJDYXNlKCksCgkJCQlsaXN0SXRlbXMgPSBudWxsLAoJCQkJbGFzdHZhbCA9ICR0aGlzLmpxbURhdGEoICJsYXN0dmFsIiApICsgIiIsCgkJCQljaGlsZEl0ZW1zID0gZmFsc2UsCgkJCQlpdGVtdGV4dCA9ICIiLAoJCQkJaXRlbSwKCQkJCS8vIENoZWNrIGlmIGEgY3VzdG9tIGZpbHRlciBjYWxsYmFjayBhcHBsaWVzCgkJCQlpc0N1c3RvbUZpbHRlckNhbGxiYWNrID0gbGlzdHZpZXcub3B0aW9ucy5maWx0ZXJDYWxsYmFjayAhPT0gZGVmYXVsdEZpbHRlckNhbGxiYWNrOwoKCQkJbGlzdHZpZXcuX3RyaWdnZXIoICJiZWZvcmVmaWx0ZXIiLCAiYmVmb3JlZmlsdGVyIiwgeyBpbnB1dDogdGhpcyB9ICk7CgoJCQkvLyBDaGFuZ2UgdmFsIGFzIGxhc3R2YWwgZm9yIG5leHQgZXhlY3V0aW9uCgkJCSR0aGlzLmpxbURhdGEoICJsYXN0dmFsIiAsIHZhbCApOwoJCQlpZiAoIGlzQ3VzdG9tRmlsdGVyQ2FsbGJhY2sgfHwgdmFsLmxlbmd0aCA8IGxhc3R2YWwubGVuZ3RoIHx8IHZhbC5pbmRleE9mKCBsYXN0dmFsICkgIT09IDAgKSB7CgoJCQkJLy8gQ3VzdG9tIGZpbHRlciBjYWxsYmFjayBhcHBsaWVzIG9yIHJlbW92ZWQgY2hhcnMgb3IgcGFzdGVkIHNvbWV0aGluZyB0b3RhbGx5IGRpZmZlcmVudCwgY2hlY2sgYWxsIGl0ZW1zCgkJCQlsaXN0SXRlbXMgPSBsaXN0LmNoaWxkcmVuKCk7CgkJCX0gZWxzZSB7CgoJCQkJLy8gT25seSBjaGFycyBhZGRlZCwgbm90IHJlbW92ZWQsIG9ubHkgdXNlIHZpc2libGUgc3Vic2V0CgkJCQlsaXN0SXRlbXMgPSBsaXN0LmNoaWxkcmVuKCAiOm5vdCgudWktc2NyZWVuLWhpZGRlbikiICk7CgkJCX0KCgkJCWlmICggdmFsICkgewoKCQkJCS8vIFRoaXMgaGFuZGxlcyBoaWRpbmcgcmVndWxhciByb3dzIHdpdGhvdXQgdGhlIHRleHQgd2Ugc2VhcmNoIGZvcgoJCQkJLy8gYW5kIGFueSBsaXN0IGRpdmlkZXJzIHdpdGhvdXQgcmVndWxhciByb3dzIHNob3duIHVuZGVyIGl0CgoJCQkJZm9yICggdmFyIGkgPSBsaXN0SXRlbXMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0gKSB7CgkJCQkJaXRlbSA9ICQoIGxpc3RJdGVtc1sgaSBdICk7CgkJCQkJaXRlbXRleHQgPSBpdGVtLmpxbURhdGEoICJmaWx0ZXJ0ZXh0IiApIHx8IGl0ZW0udGV4dCgpOwoKCQkJCQlpZiAoIGl0ZW0uaXMoICJsaTpqcW1EYXRhKHJvbGU9bGlzdC1kaXZpZGVyKSIgKSApIHsKCgkJCQkJCWl0ZW0udG9nZ2xlQ2xhc3MoICJ1aS1maWx0ZXItaGlkZXF1ZXVlIiAsICFjaGlsZEl0ZW1zICk7CgoJCQkJCQkvLyBOZXcgYnVja2V0IQoJCQkJCQljaGlsZEl0ZW1zID0gZmFsc2U7CgoJCQkJCX0gZWxzZSBpZiAoIGxpc3R2aWV3Lm9wdGlvbnMuZmlsdGVyQ2FsbGJhY2soIGl0ZW10ZXh0LCB2YWwsIGl0ZW0gKSApIHsKCgkJCQkJCS8vbWFyayB0byBiZSBoaWRkZW4KCQkJCQkJaXRlbS50b2dnbGVDbGFzcyggInVpLWZpbHRlci1oaWRlcXVldWUiICwgdHJ1ZSApOwoJCQkJCX0gZWxzZSB7CgoJCQkJCQkvLyBUaGVyZSdzIGEgc2hvd24gaXRlbSBpbiB0aGUgYnVja2V0CgkJCQkJCWNoaWxkSXRlbXMgPSB0cnVlOwoJCQkJCX0KCQkJCX0KCgkJCQkvLyBTaG93IGl0ZW1zLCBub3QgbWFya2VkIHRvIGJlIGhpZGRlbgoJCQkJbGlzdEl0ZW1zCgkJCQkJLmZpbHRlciggIjpub3QoLnVpLWZpbHRlci1oaWRlcXVldWUpIiApCgkJCQkJLnRvZ2dsZUNsYXNzKCAidWktc2NyZWVuLWhpZGRlbiIsIGZhbHNlICk7CgoJCQkJLy8gSGlkZSBpdGVtcywgbWFya2VkIHRvIGJlIGhpZGRlbgoJCQkJbGlzdEl0ZW1zCgkJCQkJLmZpbHRlciggIi51aS1maWx0ZXItaGlkZXF1ZXVlIiApCgkJCQkJLnRvZ2dsZUNsYXNzKCAidWktc2NyZWVuLWhpZGRlbiIsIHRydWUgKQoJCQkJCS50b2dnbGVDbGFzcyggInVpLWZpbHRlci1oaWRlcXVldWUiLCBmYWxzZSApOwoKCQkJfSBlbHNlIHsKCgkJCQkvL2ZpbHRlcnZhbHVlIGlzIGVtcHR5ID0+IHNob3cgYWxsCgkJCQlsaXN0SXRlbXMudG9nZ2xlQ2xhc3MoICJ1aS1zY3JlZW4taGlkZGVuIiwgZmFsc2UgKTsKCQkJfQoJCQlsaXN0dmlldy5fcmVmcmVzaENvcm5lcnMoKTsKCQl9KQoJCS5hcHBlbmRUbyggd3JhcHBlciApCgkJLnRleHRpbnB1dCgpOwoKCWlmICggbGlzdHZpZXcub3B0aW9ucy5pbnNldCApIHsKCQl3cmFwcGVyLmFkZENsYXNzKCAidWktbGlzdHZpZXctZmlsdGVyLWluc2V0IiApOwoJfQoKCXdyYXBwZXIuYmluZCggInN1Ym1pdCIsIGZ1bmN0aW9uKCkgewoJCXJldHVybiBmYWxzZTsKCX0pCgkuaW5zZXJ0QmVmb3JlKCBsaXN0ICk7Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS5zbGlkZXIiLCAkLm1vYmlsZS53aWRnZXQsIHsKCXdpZGdldEV2ZW50UHJlZml4OiAic2xpZGUiLAoKCW9wdGlvbnM6IHsKCQl0aGVtZTogbnVsbCwKCQl0cmFja1RoZW1lOiBudWxsLAoJCWRpc2FibGVkOiBmYWxzZSwKCQlpbml0U2VsZWN0b3I6ICJpbnB1dFt0eXBlPSdyYW5nZSddLCA6anFtRGF0YSh0eXBlPSdyYW5nZScpLCA6anFtRGF0YShyb2xlPSdzbGlkZXInKSIsCgkJbWluaTogZmFsc2UKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgoJCS8vIFRPRE86IEVhY2ggb2YgdGhlc2Ugc2hvdWxkIGhhdmUgY29tbWVudHMgZXhwbGFpbiB3aGF0IHRoZXkncmUgZm9yCgkJdmFyIHNlbGYgPSB0aGlzLAoKCQkJY29udHJvbCA9IHRoaXMuZWxlbWVudCwKCgkJCXBhcmVudFRoZW1lID0gJC5tb2JpbGUuZ2V0SW5oZXJpdGVkVGhlbWUoIGNvbnRyb2wsICJjIiApLAoKCQkJdGhlbWUgPSB0aGlzLm9wdGlvbnMudGhlbWUgfHwgcGFyZW50VGhlbWUsCgoJCQl0cmFja1RoZW1lID0gdGhpcy5vcHRpb25zLnRyYWNrVGhlbWUgfHwgcGFyZW50VGhlbWUsCgoJCQljVHlwZSA9IGNvbnRyb2xbIDAgXS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpLAoKCQkJc2VsZWN0Q2xhc3MgPSAoIGNUeXBlID09PSAic2VsZWN0IiApID8gInVpLXNsaWRlci1zd2l0Y2giIDogIiIsCgoJCQljb250cm9sSUQgPSBjb250cm9sLmF0dHIoICJpZCIgKSwKCgkJCSRsYWJlbCA9ICQoICJbZm9yPSciICsgY29udHJvbElEICsgIiddIiApLAoKCQkJbGFiZWxJRCA9ICRsYWJlbC5hdHRyKCAiaWQiICkgfHwgY29udHJvbElEICsgIi1sYWJlbCIsCgoJCQlsYWJlbCA9ICRsYWJlbC5hdHRyKCAiaWQiLCBsYWJlbElEICksCgoJCQl2YWwgPSBmdW5jdGlvbigpIHsKCQkJCXJldHVybiAgY1R5cGUgPT09ICJpbnB1dCIgID8gcGFyc2VGbG9hdCggY29udHJvbC52YWwoKSApIDogY29udHJvbFswXS5zZWxlY3RlZEluZGV4OwoJCQl9LAoKCQkJbWluID0gIGNUeXBlID09PSAiaW5wdXQiID8gcGFyc2VGbG9hdCggY29udHJvbC5hdHRyKCAibWluIiApICkgOiAwLAoKCQkJbWF4ID0gIGNUeXBlID09PSAiaW5wdXQiID8gcGFyc2VGbG9hdCggY29udHJvbC5hdHRyKCAibWF4IiApICkgOiBjb250cm9sLmZpbmQoICJvcHRpb24iICkubGVuZ3RoLTEsCgoJCQlzdGVwID0gd2luZG93LnBhcnNlRmxvYXQoIGNvbnRyb2wuYXR0ciggInN0ZXAiICkgfHwgMSApLAoKCQkJaW5saW5lQ2xhc3MgPSAoIHRoaXMub3B0aW9ucy5pbmxpbmUgfHwgY29udHJvbC5qcW1EYXRhKCAiaW5saW5lIiApID09PSB0cnVlICkgPyAiIHVpLXNsaWRlci1pbmxpbmUiIDogIiIsCgoJCQltaW5pQ2xhc3MgPSAoIHRoaXMub3B0aW9ucy5taW5pIHx8IGNvbnRyb2wuanFtRGF0YSggIm1pbmkiICkgKSA/ICIgdWktc2xpZGVyLW1pbmkiIDogIiIsCgoKCQkJZG9tSGFuZGxlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggJ2EnICksCgkJCWhhbmRsZSA9ICQoIGRvbUhhbmRsZSApLAoJCQlkb21TbGlkZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAnZGl2JyApLAoJCQlzbGlkZXIgPSAkKCBkb21TbGlkZXIgKSwKCgkJCXZhbHVlYmcgPSBjb250cm9sLmpxbURhdGEoICJoaWdobGlnaHQiICkgJiYgY1R5cGUgIT09ICJzZWxlY3QiID8gKGZ1bmN0aW9uKCkgewoJCQkJdmFyIGJnID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CgkJCQliZy5jbGFzc05hbWUgPSAndWktc2xpZGVyLWJnICcgKyAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyArICcgdWktYnRuLWNvcm5lci1hbGwnOwoJCQkJcmV0dXJuICQoIGJnICkucHJlcGVuZFRvKCBzbGlkZXIgKTsKCQkJfSkoKSA6IGZhbHNlLAoKCQkJb3B0aW9uczsKCgkJdGhpcy5fdHlwZSA9IGNUeXBlOwoKCQlkb21IYW5kbGUuc2V0QXR0cmlidXRlKCAnaHJlZicsICIjIiApOwoJCWRvbVNsaWRlci5zZXRBdHRyaWJ1dGUoJ3JvbGUnLCdhcHBsaWNhdGlvbicpOwoJCWRvbVNsaWRlci5jbGFzc05hbWUgPSBbJ3VpLXNsaWRlciAnLHNlbGVjdENsYXNzLCIgdWktYnRuLWRvd24tIix0cmFja1RoZW1lLCcgdWktYnRuLWNvcm5lci1hbGwnLCBpbmxpbmVDbGFzcywgbWluaUNsYXNzXS5qb2luKCAiIiApOwoJCWRvbUhhbmRsZS5jbGFzc05hbWUgPSAndWktc2xpZGVyLWhhbmRsZSc7CgkJZG9tU2xpZGVyLmFwcGVuZENoaWxkKCBkb21IYW5kbGUgKTsKCgkJaGFuZGxlLmJ1dHRvbk1hcmt1cCh7IGNvcm5lcnM6IHRydWUsIHRoZW1lOiB0aGVtZSwgc2hhZG93OiB0cnVlIH0pCgkJCQkuYXR0cih7CgkJCQkJInJvbGUiOiAic2xpZGVyIiwKCQkJCQkiYXJpYS12YWx1ZW1pbiI6IG1pbiwKCQkJCQkiYXJpYS12YWx1ZW1heCI6IG1heCwKCQkJCQkiYXJpYS12YWx1ZW5vdyI6IHZhbCgpLAoJCQkJCSJhcmlhLXZhbHVldGV4dCI6IHZhbCgpLAoJCQkJCSJ0aXRsZSI6IHZhbCgpLAoJCQkJCSJhcmlhLWxhYmVsbGVkYnkiOiBsYWJlbElECgkJCQl9KTsKCgkJJC5leHRlbmQoIHRoaXMsIHsKCQkJc2xpZGVyOiBzbGlkZXIsCgkJCWhhbmRsZTogaGFuZGxlLAoJCQl2YWx1ZWJnOiB2YWx1ZWJnLAoJCQlkcmFnZ2luZzogZmFsc2UsCgkJCWJlZm9yZVN0YXJ0OiBudWxsLAoJCQl1c2VyTW9kaWZpZWQ6IGZhbHNlLAoJCQltb3VzZU1vdmVkOiBmYWxzZQoJCX0pOwoKCQlpZiAoIGNUeXBlID09PSAic2VsZWN0IiApIHsKCQkJdmFyIHdyYXBwZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKCQkJd3JhcHBlci5jbGFzc05hbWUgPSAndWktc2xpZGVyLWlubmVyb2Zmc2V0JzsKCgkJCWZvciAoIHZhciBqID0gMCxsZW5ndGggPSBkb21TbGlkZXIuY2hpbGROb2Rlcy5sZW5ndGg7aiA8IGxlbmd0aDtqKysgKSB7CgkJCQl3cmFwcGVyLmFwcGVuZENoaWxkKCBkb21TbGlkZXIuY2hpbGROb2Rlc1tqXSApOwoJCQl9CgoJCQlkb21TbGlkZXIuYXBwZW5kQ2hpbGQoIHdyYXBwZXIgKTsKCgkJCS8vIHNsaWRlci53cmFwSW5uZXIoICI8ZGl2IGNsYXNzPSd1aS1zbGlkZXItaW5uZXJvZmZzZXQnPjwvZGl2PiIgKTsKCgkJCS8vIG1ha2UgdGhlIGhhbmRsZSBtb3ZlIHdpdGggYSBzbW9vdGggdHJhbnNpdGlvbgoJCQloYW5kbGUuYWRkQ2xhc3MoICJ1aS1zbGlkZXItaGFuZGxlLXNuYXBwaW5nIiApOwoKCQkJb3B0aW9ucyA9IGNvbnRyb2wuZmluZCggIm9wdGlvbiIgKTsKCgkJCWZvciAoIHZhciBpID0gMCwgb3B0aW9uc0NvdW50ID0gb3B0aW9ucy5sZW5ndGg7IGkgPCBvcHRpb25zQ291bnQ7IGkrKyApIHsKCQkJCXZhciBzaWRlID0gIWkgPyAiYiIgOiAiYSIsCgkJCQkJc2xpZGVyVGhlbWUgPSAhaSA/ICIgdWktYnRuLWRvd24tIiArIHRyYWNrVGhlbWUgOiAoICIgIiArICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICksCgkJCQkJc2xpZGVyTGFiZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAnZGl2JyApLAoJCQkJCXNsaWRlckltZyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICdzcGFuJyApOwoKCQkJCXNsaWRlckltZy5jbGFzc05hbWUgPSBbJ3VpLXNsaWRlci1sYWJlbCB1aS1zbGlkZXItbGFiZWwtJyxzaWRlLHNsaWRlclRoZW1lLCIgdWktYnRuLWNvcm5lci1hbGwiXS5qb2luKCAiIiApOwoJCQkJc2xpZGVySW1nLnNldEF0dHJpYnV0ZSgncm9sZScsJ2ltZycpOwoJCQkJc2xpZGVySW1nLmFwcGVuZENoaWxkKCBkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSggb3B0aW9uc1tpXS5pbm5lckhUTUwgKSApOwoJCQkJJChzbGlkZXJJbWcpLnByZXBlbmRUbyggc2xpZGVyICk7CgkJCX0KCgkJCXNlbGYuX2xhYmVscyA9ICQoICIudWktc2xpZGVyLWxhYmVsIiwgc2xpZGVyICk7CgoJCX0KCgkJbGFiZWwuYWRkQ2xhc3MoICJ1aS1zbGlkZXIiICk7CgoJCS8vIG1vbml0b3IgdGhlIGlucHV0IGZvciB1cGRhdGVkIHZhbHVlcwoJCWNvbnRyb2wuYWRkQ2xhc3MoIGNUeXBlID09PSAiaW5wdXQiID8gInVpLXNsaWRlci1pbnB1dCIgOiAidWktc2xpZGVyLXN3aXRjaCIgKQoJCQkuY2hhbmdlKGZ1bmN0aW9uKCkgewoJCQkJLy8gaWYgdGhlIHVzZXIgZHJhZ2dlZCB0aGUgaGFuZGxlLCB0aGUgImNoYW5nZSIgZXZlbnQgd2FzIHRyaWdnZXJlZCBmcm9tIGluc2lkZSByZWZyZXNoKCk7IGRvbid0IGNhbGwgcmVmcmVzaCgpIGFnYWluCgkJCQlpZiAoICFzZWxmLm1vdXNlTW92ZWQgKSB7CgkJCQkJc2VsZi5yZWZyZXNoKCB2YWwoKSwgdHJ1ZSApOwoJCQkJfQoJCQl9KQoJCQkua2V5dXAoZnVuY3Rpb24oKSB7IC8vIG5lY2Vzc2FyeT8KCQkJCXNlbGYucmVmcmVzaCggdmFsKCksIHRydWUsIHRydWUgKTsKCQkJfSkKCQkJLmJsdXIoZnVuY3Rpb24oKSB7CgkJCQlzZWxmLnJlZnJlc2goIHZhbCgpLCB0cnVlICk7CgkJCX0pOwoKCQl0aGlzLl9wcmV2ZW50RG9jdW1lbnREcmFnID0gZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkvLyBOT1RFOiB3ZSBkb24ndCBkbyB0aGlzIGluIHJlZnJlc2ggYmVjYXVzZSB3ZSBzdGlsbCB3YW50IHRvCgkJCS8vICAgICAgIHN1cHBvcnQgcHJvZ3JhbW1hdGljIGFsdGVyYXRpb24gb2YgZGlzYWJsZWQgaW5wdXRzCgkJCWlmICggc2VsZi5kcmFnZ2luZyAmJiAhc2VsZi5vcHRpb25zLmRpc2FibGVkICkgewoKCQkJCS8vIHNlbGYubW91c2VNb3ZlZCBtdXN0IGJlIHVwZGF0ZWQgYmVmb3JlIHJlZnJlc2goKSBiZWNhdXNlIGl0IHdpbGwgYmUgdXNlZCBpbiB0aGUgY29udHJvbCAiY2hhbmdlIiBldmVudAoJCQkJc2VsZi5tb3VzZU1vdmVkID0gdHJ1ZTsKCgkJCQlpZiAoIGNUeXBlID09PSAic2VsZWN0IiApIHsKCQkJCQkvLyBtYWtlIHRoZSBoYW5kbGUgbW92ZSBpbiBzeW5jIHdpdGggdGhlIG1vdXNlCgkJCQkJaGFuZGxlLnJlbW92ZUNsYXNzKCAidWktc2xpZGVyLWhhbmRsZS1zbmFwcGluZyIgKTsKCQkJCX0KCgkJCQlzZWxmLnJlZnJlc2goIGV2ZW50ICk7CgoJCQkJLy8gb25seSBhZnRlciByZWZyZXNoKCkgeW91IGNhbiBjYWxjdWxhdGUgc2VsZi51c2VyTW9kaWZpZWQKCQkJCXNlbGYudXNlck1vZGlmaWVkID0gc2VsZi5iZWZvcmVTdGFydCAhPT0gY29udHJvbFswXS5zZWxlY3RlZEluZGV4OwoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgkJfQoKCQl0aGlzLl9vbiggJCggZG9jdW1lbnQgKSwgeyAidm1vdXNlbW92ZSI6IHRoaXMuX3ByZXZlbnREb2N1bWVudERyYWcgfSk7CgoJCS8vIGl0IGFwcGVhcnMgdGhlIGNsaWNraW5nIHRoZSB1cCBhbmQgZG93biBidXR0b25zIGluIGNocm9tZSBvbgoJCS8vIHJhbmdlL251bWJlciBpbnB1dHMgZG9lc24ndCB0cmlnZ2VyIGEgY2hhbmdlIHVudGlsIHRoZSBmaWVsZCBpcwoJCS8vIGJsdXJyZWQuIEhlcmUgd2UgY2hlY2sgdGhpZiB0aGUgdmFsdWUgaGFzIGNoYW5nZWQgYW5kIHJlZnJlc2gKCQljb250cm9sLmJpbmQoICJ2bW91c2V1cCIsICQucHJveHkoIHNlbGYuX2NoZWNrZWRSZWZyZXNoLCBzZWxmKSk7CgoJCXNsaWRlci5iaW5kKCAidm1vdXNlZG93biIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJLy8gTk9URTogd2UgZG9uJ3QgZG8gdGhpcyBpbiByZWZyZXNoIGJlY2F1c2Ugd2Ugc3RpbGwgd2FudCB0bwoJCQkvLyAgICAgICBzdXBwb3J0IHByb2dyYW1tYXRpYyBhbHRlcmF0aW9uIG9mIGRpc2FibGVkIGlucHV0cwoJCQlpZiAoIHNlbGYub3B0aW9ucy5kaXNhYmxlZCApIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoKCQkJc2VsZi5kcmFnZ2luZyA9IHRydWU7CgkJCXNlbGYudXNlck1vZGlmaWVkID0gZmFsc2U7CgkJCXNlbGYubW91c2VNb3ZlZCA9IGZhbHNlOwoKCQkJaWYgKCBjVHlwZSA9PT0gInNlbGVjdCIgKSB7CgkJCQlzZWxmLmJlZm9yZVN0YXJ0ID0gY29udHJvbFswXS5zZWxlY3RlZEluZGV4OwoJCQl9CgoJCQlzZWxmLnJlZnJlc2goIGV2ZW50ICk7CgkJCXNlbGYuX3RyaWdnZXIoICJzdGFydCIgKTsKCQkJcmV0dXJuIGZhbHNlOwoJCX0pCgkJLmJpbmQoICJ2Y2xpY2siLCBmYWxzZSApOwoKCQl0aGlzLl9zbGlkZXJNb3VzZVVwID0gZnVuY3Rpb24oKSB7CgkJCWlmICggc2VsZi5kcmFnZ2luZyApIHsKCQkJCXNlbGYuZHJhZ2dpbmcgPSBmYWxzZTsKCgkJCQlpZiAoIGNUeXBlID09PSAic2VsZWN0IikgewoJCQkJCS8vIG1ha2UgdGhlIGhhbmRsZSBtb3ZlIHdpdGggYSBzbW9vdGggdHJhbnNpdGlvbgoJCQkJCWhhbmRsZS5hZGRDbGFzcyggInVpLXNsaWRlci1oYW5kbGUtc25hcHBpbmciICk7CgoJCQkJCWlmICggc2VsZi5tb3VzZU1vdmVkICkgewoJCQkJCQkvLyB0aGlzIGlzIGEgZHJhZywgY2hhbmdlIHRoZSB2YWx1ZSBvbmx5IGlmIHVzZXIgZHJhZ2dlZCBlbm91Z2gKCQkJCQkJaWYgKCBzZWxmLnVzZXJNb2RpZmllZCApIHsKCQkJCQkJICAgIHNlbGYucmVmcmVzaCggc2VsZi5iZWZvcmVTdGFydCA9PT0gMCA/IDEgOiAwICk7CgkJCQkJCX0KCQkJCQkJZWxzZSB7CgkJCQkJCSAgICBzZWxmLnJlZnJlc2goIHNlbGYuYmVmb3JlU3RhcnQgKTsKCQkJCQkJfQoJCQkJCX0KCQkJCQllbHNlIHsKCQkJCQkJLy8gdGhpcyBpcyBqdXN0IGEgY2xpY2ssIGNoYW5nZSB0aGUgdmFsdWUKCQkJCQkJc2VsZi5yZWZyZXNoKCBzZWxmLmJlZm9yZVN0YXJ0ID09PSAwID8gMSA6IDAgKTsKCQkJCQl9CgkJCQl9CgoJCQkJc2VsZi5tb3VzZU1vdmVkID0gZmFsc2U7CgkJCQlzZWxmLl90cmlnZ2VyKCAic3RvcCIgKTsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoJCX07CgoJCXRoaXMuX29uKCBzbGlkZXIuYWRkKCBkb2N1bWVudCApLCB7ICJ2bW91c2V1cCI6IHRoaXMuX3NsaWRlck1vdXNlVXAgfSk7CgkJc2xpZGVyLmluc2VydEFmdGVyKCBjb250cm9sICk7CgoJCS8vIE9ubHkgYWRkIGZvY3VzIGNsYXNzIHRvIHRvZ2dsZSBzd2l0Y2gsIHNsaWRlcnMgZ2V0IGl0IGF1dG9tYXRpY2FsbHkgZnJvbSB1aS1idG4KCQlpZiAoIGNUeXBlID09PSAnc2VsZWN0JyApIHsKCQkJdGhpcy5oYW5kbGUuYmluZCh7CgkJCQlmb2N1czogZnVuY3Rpb24oKSB7CgkJCQkJc2xpZGVyLmFkZENsYXNzKCAkLm1vYmlsZS5mb2N1c0NsYXNzICk7CgkJCQl9LAoKCQkJCWJsdXI6IGZ1bmN0aW9uKCkgewoJCQkJCXNsaWRlci5yZW1vdmVDbGFzcyggJC5tb2JpbGUuZm9jdXNDbGFzcyApOwoJCQkJfQoJCQl9KTsKCQl9CgoJCXRoaXMuaGFuZGxlLmJpbmQoewoJCQkvLyBOT1RFIGZvcmNlIGZvY3VzIG9uIGhhbmRsZQoJCQl2bW91c2Vkb3duOiBmdW5jdGlvbigpIHsKCQkJCSQoIHRoaXMgKS5mb2N1cygpOwoJCQl9LAoKCQkJdmNsaWNrOiBmYWxzZSwKCgkJCWtleWRvd246IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCXZhciBpbmRleCA9IHZhbCgpOwoKCQkJCWlmICggc2VsZi5vcHRpb25zLmRpc2FibGVkICkgewoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQkvLyBJbiBhbGwgY2FzZXMgcHJldmVudCB0aGUgZGVmYXVsdCBhbmQgbWFyayB0aGUgaGFuZGxlIGFzIGFjdGl2ZQoJCQkJc3dpdGNoICggZXZlbnQua2V5Q29kZSApIHsKCQkJCQljYXNlICQubW9iaWxlLmtleUNvZGUuSE9NRToKCQkJCQljYXNlICQubW9iaWxlLmtleUNvZGUuRU5EOgoJCQkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5QQUdFX1VQOgoJCQkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5QQUdFX0RPV046CgkJCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLlVQOgoJCQkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5SSUdIVDoKCQkJCQljYXNlICQubW9iaWxlLmtleUNvZGUuRE9XTjoKCQkJCQljYXNlICQubW9iaWxlLmtleUNvZGUuTEVGVDoKCQkJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCgkJCQkJCWlmICggIXNlbGYuX2tleVNsaWRpbmcgKSB7CgkJCQkJCQlzZWxmLl9rZXlTbGlkaW5nID0gdHJ1ZTsKCQkJCQkJCSQoIHRoaXMgKS5hZGRDbGFzcyggInVpLXN0YXRlLWFjdGl2ZSIgKTsKCQkJCQkJfQoJCQkJCQlicmVhazsKCQkJCX0KCgkJCQkvLyBtb3ZlIHRoZSBzbGlkZXIgYWNjb3JkaW5nIHRvIHRoZSBrZXlwcmVzcwoJCQkJc3dpdGNoICggZXZlbnQua2V5Q29kZSApIHsKCQkJCQljYXNlICQubW9iaWxlLmtleUNvZGUuSE9NRToKCQkJCQkJc2VsZi5yZWZyZXNoKCBtaW4gKTsKCQkJCQkJYnJlYWs7CgkJCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLkVORDoKCQkJCQkJc2VsZi5yZWZyZXNoKCBtYXggKTsKCQkJCQkJYnJlYWs7CgkJCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLlBBR0VfVVA6CgkJCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLlVQOgoJCQkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5SSUdIVDoKCQkJCQkJc2VsZi5yZWZyZXNoKCBpbmRleCArIHN0ZXAgKTsKCQkJCQkJYnJlYWs7CgkJCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLlBBR0VfRE9XTjoKCQkJCQljYXNlICQubW9iaWxlLmtleUNvZGUuRE9XTjoKCQkJCQljYXNlICQubW9iaWxlLmtleUNvZGUuTEVGVDoKCQkJCQkJc2VsZi5yZWZyZXNoKCBpbmRleCAtIHN0ZXAgKTsKCQkJCQkJYnJlYWs7CgkJCQl9CgkJCX0sIC8vIHJlbW92ZSBhY3RpdmUgbWFyawoKCQkJa2V5dXA6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCWlmICggc2VsZi5fa2V5U2xpZGluZyApIHsKCQkJCQlzZWxmLl9rZXlTbGlkaW5nID0gZmFsc2U7CgkJCQkJJCggdGhpcyApLnJlbW92ZUNsYXNzKCAidWktc3RhdGUtYWN0aXZlIiApOwoJCQkJfQoJCQl9CgkJCX0pOwoKCQl0aGlzLnJlZnJlc2goIHVuZGVmaW5lZCwgdW5kZWZpbmVkLCB0cnVlICk7Cgl9LAoKCV9jaGVja2VkUmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJaWYoIHRoaXMudmFsdWUgIT0gdGhpcy5fdmFsdWUoKSApewoJCQl0aGlzLnJlZnJlc2goIHRoaXMuX3ZhbHVlKCkgKTsKCQl9Cgl9LAoKCV92YWx1ZTogZnVuY3Rpb24oKSB7CgkJcmV0dXJuICB0aGlzLl90eXBlID09PSAiaW5wdXQiID8KCQkJcGFyc2VGbG9hdCggdGhpcy5lbGVtZW50LnZhbCgpICkgOiB0aGlzLmVsZW1lbnRbMF0uc2VsZWN0ZWRJbmRleDsKCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oIHZhbCwgaXNmcm9tQ29udHJvbCwgcHJldmVudElucHV0VXBkYXRlICkgewoKCQkvLyBOT1RFOiB3ZSBkb24ndCByZXR1cm4gaGVyZSBiZWNhdXNlIHdlIHdhbnQgdG8gc3VwcG9ydCBwcm9ncmFtbWF0aWMKCQkvLyAgICAgICBhbHRlcmF0aW9uIG9mIHRoZSBpbnB1dCB2YWx1ZSwgd2hpY2ggc2hvdWxkIHN0aWxsIHVwZGF0ZSB0aGUgc2xpZGVyCgkJaWYgKCB0aGlzLm9wdGlvbnMuZGlzYWJsZWQgfHwgdGhpcy5lbGVtZW50LmF0dHIoJ2Rpc2FibGVkJykpIHsKCQkJdGhpcy5kaXNhYmxlKCk7CgkJfQoKCQkvLyBzZXQgdGhlIHN0b3JlZCB2YWx1ZSBmb3IgY29tcGFyaXNvbiBsYXRlcgoJCXRoaXMudmFsdWUgPSB0aGlzLl92YWx1ZSgpOwoKCQl2YXIgY29udHJvbCA9IHRoaXMuZWxlbWVudCwgcGVyY2VudCwKCQkJY1R5cGUgPSBjb250cm9sWzBdLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCksCgkJCW1pbiA9IGNUeXBlID09PSAiaW5wdXQiID8gcGFyc2VGbG9hdCggY29udHJvbC5hdHRyKCAibWluIiApICkgOiAwLAoJCQltYXggPSBjVHlwZSA9PT0gImlucHV0IiA/IHBhcnNlRmxvYXQoIGNvbnRyb2wuYXR0ciggIm1heCIgKSApIDogY29udHJvbC5maW5kKCAib3B0aW9uIiApLmxlbmd0aCAtIDEsCgkJCXN0ZXAgPSAoIGNUeXBlID09PSAiaW5wdXQiICYmIHBhcnNlRmxvYXQoIGNvbnRyb2wuYXR0ciggInN0ZXAiICkgKSA+IDAgKSA/IHBhcnNlRmxvYXQoIGNvbnRyb2wuYXR0ciggInN0ZXAiICkgKSA6IDE7CgoJCWlmICggdHlwZW9mIHZhbCA9PT0gIm9iamVjdCIgKSB7CgkJCXZhciBkYXRhID0gdmFsLAoJCQkJLy8gYSBzbGlnaHQgdG9sZXJhbmNlIGhlbHBlZCBnZXQgdG8gdGhlIGVuZHMgb2YgdGhlIHNsaWRlcgoJCQkJdG9sID0gODsKCQkJaWYgKCAhdGhpcy5kcmFnZ2luZyB8fAoJCQkJCWRhdGEucGFnZVggPCB0aGlzLnNsaWRlci5vZmZzZXQoKS5sZWZ0IC0gdG9sIHx8CgkJCQkJZGF0YS5wYWdlWCA+IHRoaXMuc2xpZGVyLm9mZnNldCgpLmxlZnQgKyB0aGlzLnNsaWRlci53aWR0aCgpICsgdG9sICkgewoJCQkJcmV0dXJuOwoJCQl9CgkJCXBlcmNlbnQgPSBNYXRoLnJvdW5kKCAoICggZGF0YS5wYWdlWCAtIHRoaXMuc2xpZGVyLm9mZnNldCgpLmxlZnQgKSAvIHRoaXMuc2xpZGVyLndpZHRoKCkgKSAqIDEwMCApOwoJCX0gZWxzZSB7CgkJCWlmICggdmFsID09IG51bGwgKSB7CgkJCQl2YWwgPSBjVHlwZSA9PT0gImlucHV0IiA/IHBhcnNlRmxvYXQoIGNvbnRyb2wudmFsKCkgfHwgMCApIDogY29udHJvbFswXS5zZWxlY3RlZEluZGV4OwoJCQl9CgkJCXBlcmNlbnQgPSAoIHBhcnNlRmxvYXQoIHZhbCApIC0gbWluICkgLyAoIG1heCAtIG1pbiApICogMTAwOwoJCX0KCgkJaWYgKCBpc05hTiggcGVyY2VudCApICkgewoJCQlyZXR1cm47CgkJfQoKCQlpZiAoIHBlcmNlbnQgPCAwICkgewoJCQlwZXJjZW50ID0gMDsKCQl9CgoJCWlmICggcGVyY2VudCA+IDEwMCApIHsKCQkJcGVyY2VudCA9IDEwMDsKCQl9CgoJCXZhciBuZXd2YWwgPSAoIHBlcmNlbnQgLyAxMDAgKSAqICggbWF4IC0gbWluICkgKyBtaW47CgoJCS8vZnJvbSBqUXVlcnkgVUkgc2xpZGVyLCB0aGUgZm9sbG93aW5nIHNvdXJjZSB3aWxsIHJvdW5kIHRvIHRoZSBuZWFyZXN0IHN0ZXAKCQl2YXIgdmFsTW9kU3RlcCA9ICggbmV3dmFsIC0gbWluICkgJSBzdGVwOwoJCXZhciBhbGlnblZhbHVlID0gbmV3dmFsIC0gdmFsTW9kU3RlcDsKCgkJaWYgKCBNYXRoLmFicyggdmFsTW9kU3RlcCApICogMiA+PSBzdGVwICkgewoJCQlhbGlnblZhbHVlICs9ICggdmFsTW9kU3RlcCA+IDAgKSA/IHN0ZXAgOiAoIC1zdGVwICk7CgkJfQoJCS8vIFNpbmNlIEphdmFTY3JpcHQgaGFzIHByb2JsZW1zIHdpdGggbGFyZ2UgZmxvYXRzLCByb3VuZAoJCS8vIHRoZSBmaW5hbCB2YWx1ZSB0byA1IGRpZ2l0cyBhZnRlciB0aGUgZGVjaW1hbCBwb2ludCAoc2VlIGpRdWVyeVVJOiAjNDEyNCkKCQluZXd2YWwgPSBwYXJzZUZsb2F0KCBhbGlnblZhbHVlLnRvRml4ZWQoNSkgKTsKCgkJaWYgKCBuZXd2YWwgPCBtaW4gKSB7CgkJCW5ld3ZhbCA9IG1pbjsKCQl9CgoJCWlmICggbmV3dmFsID4gbWF4ICkgewoJCQluZXd2YWwgPSBtYXg7CgkJfQoKCQl0aGlzLmhhbmRsZS5jc3MoICJsZWZ0IiwgcGVyY2VudCArICIlIiApOwoJCXRoaXMuaGFuZGxlLmF0dHIoIHsKCQkJCSJhcmlhLXZhbHVlbm93IjogY1R5cGUgPT09ICJpbnB1dCIgPyBuZXd2YWwgOiBjb250cm9sLmZpbmQoICJvcHRpb24iICkuZXEoIG5ld3ZhbCApLmF0dHIoICJ2YWx1ZSIgKSwKCQkJCSJhcmlhLXZhbHVldGV4dCI6IGNUeXBlID09PSAiaW5wdXQiID8gbmV3dmFsIDogY29udHJvbC5maW5kKCAib3B0aW9uIiApLmVxKCBuZXd2YWwgKS5nZXRFbmNvZGVkVGV4dCgpLAoJCQkJdGl0bGU6IGNUeXBlID09PSAiaW5wdXQiID8gbmV3dmFsIDogY29udHJvbC5maW5kKCAib3B0aW9uIiApLmVxKCBuZXd2YWwgKS5nZXRFbmNvZGVkVGV4dCgpCgkJCX0pOwoKCQlpZiAoIHRoaXMudmFsdWViZyApIHsKCQkJdGhpcy52YWx1ZWJnLmNzcyggIndpZHRoIiwgcGVyY2VudCArICIlIiApOwoJCX0KCgkJLy8gZHJhZyB0aGUgbGFiZWwgd2lkdGhzCgkJaWYgKCB0aGlzLl9sYWJlbHMgKSB7CgkJCXZhciBoYW5kbGVQZXJjZW50ID0gdGhpcy5oYW5kbGUud2lkdGgoKSAvIHRoaXMuc2xpZGVyLndpZHRoKCkgKiAxMDAsCgkJCQlhUGVyY2VudCA9IHBlcmNlbnQgJiYgaGFuZGxlUGVyY2VudCArICggMTAwIC0gaGFuZGxlUGVyY2VudCApICogcGVyY2VudCAvIDEwMCwKCQkJCWJQZXJjZW50ID0gcGVyY2VudCA9PT0gMTAwID8gMCA6IE1hdGgubWluKCBoYW5kbGVQZXJjZW50ICsgMTAwIC0gYVBlcmNlbnQsIDEwMCApOwoKCQkJdGhpcy5fbGFiZWxzLmVhY2goZnVuY3Rpb24oKSB7CgkJCQl2YXIgYWIgPSAkKCB0aGlzICkuaXMoICIudWktc2xpZGVyLWxhYmVsLWEiICk7CgkJCQkkKCB0aGlzICkud2lkdGgoICggYWIgPyBhUGVyY2VudCA6IGJQZXJjZW50ICApICsgIiUiICk7CgkJCX0pOwoJCX0KCgkJaWYgKCAhcHJldmVudElucHV0VXBkYXRlICkgewoJCQl2YXIgdmFsdWVDaGFuZ2VkID0gZmFsc2U7CgoJCQkvLyB1cGRhdGUgY29udHJvbCJzIHZhbHVlCgkJCWlmICggY1R5cGUgPT09ICJpbnB1dCIgKSB7CgkJCQl2YWx1ZUNoYW5nZWQgPSBjb250cm9sLnZhbCgpICE9PSBuZXd2YWw7CgkJCQljb250cm9sLnZhbCggbmV3dmFsICk7CgkJCX0gZWxzZSB7CgkJCQl2YWx1ZUNoYW5nZWQgPSBjb250cm9sWyAwIF0uc2VsZWN0ZWRJbmRleCAhPT0gbmV3dmFsOwoJCQkJY29udHJvbFsgMCBdLnNlbGVjdGVkSW5kZXggPSBuZXd2YWw7CgkJCX0KCQkJaWYgKCAhaXNmcm9tQ29udHJvbCAmJiB2YWx1ZUNoYW5nZWQgKSB7CgkJCQljb250cm9sLnRyaWdnZXIoICJjaGFuZ2UiICk7CgkJCX0KCQl9Cgl9LAoKCWVuYWJsZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5lbGVtZW50LmF0dHIoICJkaXNhYmxlZCIsIGZhbHNlICk7CgkJdGhpcy5zbGlkZXIucmVtb3ZlQ2xhc3MoICJ1aS1kaXNhYmxlZCIgKS5hdHRyKCAiYXJpYS1kaXNhYmxlZCIsIGZhbHNlICk7CgkJcmV0dXJuIHRoaXMuX3NldE9wdGlvbiggImRpc2FibGVkIiwgZmFsc2UgKTsKCX0sCgoJZGlzYWJsZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5lbGVtZW50LmF0dHIoICJkaXNhYmxlZCIsIHRydWUgKTsKCQl0aGlzLnNsaWRlci5hZGRDbGFzcyggInVpLWRpc2FibGVkIiApLmF0dHIoICJhcmlhLWRpc2FibGVkIiwgdHJ1ZSApOwoJCXJldHVybiB0aGlzLl9zZXRPcHRpb24oICJkaXNhYmxlZCIsIHRydWUgKTsKCX0KCn0pOwoKLy9hdXRvIHNlbGYtaW5pdCB3aWRnZXRzCiQoIGRvY3VtZW50ICkuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKSB7CgkkLm1vYmlsZS5zbGlkZXIucHJvdG90eXBlLmVuaGFuY2VXaXRoaW4oIGUudGFyZ2V0LCB0cnVlICk7Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS5zZWxlY3RtZW51IiwgJC5tb2JpbGUud2lkZ2V0LCB7CglvcHRpb25zOiB7CgkJdGhlbWU6IG51bGwsCgkJZGlzYWJsZWQ6IGZhbHNlLAoJCWljb246ICJhcnJvdy1kIiwKCQlpY29ucG9zOiAicmlnaHQiLAoJCWlubGluZTogZmFsc2UsCgkJY29ybmVyczogdHJ1ZSwKCQlzaGFkb3c6IHRydWUsCgkJaWNvbnNoYWRvdzogdHJ1ZSwKCQlvdmVybGF5VGhlbWU6ICJhIiwKCQloaWRlUGxhY2Vob2xkZXJNZW51SXRlbXM6IHRydWUsCgkJY2xvc2VUZXh0OiAiQ2xvc2UiLAoJCW5hdGl2ZU1lbnU6IHRydWUsCgkJLy8gVGhpcyBvcHRpb24gZGVmYXVsdHMgdG8gdHJ1ZSBvbiBpT1MgZGV2aWNlcy4KCQlwcmV2ZW50Rm9jdXNab29tOiAvaVBob25lfGlQYWR8aVBvZC8udGVzdCggbmF2aWdhdG9yLnBsYXRmb3JtICkgJiYgbmF2aWdhdG9yLnVzZXJBZ2VudC5pbmRleE9mKCAiQXBwbGVXZWJLaXQiICkgPiAtMSwKCQlpbml0U2VsZWN0b3I6ICJzZWxlY3Q6bm90KCA6anFtRGF0YShyb2xlPSdzbGlkZXInKSApIiwKCQltaW5pOiBmYWxzZQoJfSwKCglfYnV0dG9uOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gJCggIjxkaXYvPiIgKTsKCX0sCgoJX3NldERpc2FibGVkOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJdGhpcy5lbGVtZW50LmF0dHIoICJkaXNhYmxlZCIsIHZhbHVlICk7CgkJdGhpcy5idXR0b24uYXR0ciggImFyaWEtZGlzYWJsZWQiLCB2YWx1ZSApOwoJCXJldHVybiB0aGlzLl9zZXRPcHRpb24oICJkaXNhYmxlZCIsIHZhbHVlICk7Cgl9LAoKCV9mb2N1c0J1dHRvbiA6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpczsKCgkJc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCXNlbGYuYnV0dG9uLmZvY3VzKCk7CgkJfSwgNDApOwoJfSwKCglfc2VsZWN0T3B0aW9uczogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuc2VsZWN0LmZpbmQoICJvcHRpb24iICk7Cgl9LAoKCS8vIHNldHVwIGl0ZW1zIHRoYXQgYXJlIGdlbmVyYWxseSBuZWNlc3NhcnkgZm9yIHNlbGVjdCBtZW51IGV4dGVuc2lvbgoJX3ByZUV4dGVuc2lvbjogZnVuY3Rpb24oKSB7CgkJdmFyIGNsYXNzZXMgPSAiIjsKCQkvLyBUT0RPOiBQb3N0IDEuMS0tb25jZSB3ZSBoYXZlIHRpbWUgdG8gdGVzdCB0aG9yb3VnaGx5LS1hbnkgY2xhc3NlcyBtYW51YWxseSBhcHBsaWVkIHRvIHRoZSBvcmlnaW5hbCBlbGVtZW50IHNob3VsZCBiZSBjYXJyaWVkIG92ZXIgdG8gdGhlIGVuaGFuY2VkIGVsZW1lbnQsIHdpdGggYW4gYC1lbmhhbmNlZGAgc3VmZml4LiBTZWUgaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnktbW9iaWxlL2lzc3Vlcy8zNTc3CgkJLyogaWYgKCAkZWxbMF0uY2xhc3NOYW1lLmxlbmd0aCApIHsKCQkJY2xhc3NlcyA9ICRlbFswXS5jbGFzc05hbWU7CgkJfSAqLwoJCWlmICggISF+dGhpcy5lbGVtZW50WzBdLmNsYXNzTmFtZS5pbmRleE9mKCAidWktYnRuLWxlZnQiICkgKSB7CgkJCWNsYXNzZXMgPSAgIiB1aS1idG4tbGVmdCI7CgkJfQoKCQlpZiAoICAhIX50aGlzLmVsZW1lbnRbMF0uY2xhc3NOYW1lLmluZGV4T2YoICJ1aS1idG4tcmlnaHQiICkgKSB7CgkJCWNsYXNzZXMgPSAiIHVpLWJ0bi1yaWdodCI7CgkJfQoKCQl0aGlzLnNlbGVjdCA9IHRoaXMuZWxlbWVudC53cmFwKCAiPGRpdiBjbGFzcz0ndWktc2VsZWN0IiArIGNsYXNzZXMgKyAiJz4iICk7CgkJdGhpcy5zZWxlY3RJRCAgPSB0aGlzLnNlbGVjdC5hdHRyKCAiaWQiICk7CgkJdGhpcy5sYWJlbCA9ICQoICJsYWJlbFtmb3I9JyIrIHRoaXMuc2VsZWN0SUQgKyInXSIgKS5hZGRDbGFzcyggInVpLXNlbGVjdCIgKTsKCQl0aGlzLmlzTXVsdGlwbGUgPSB0aGlzLnNlbGVjdFsgMCBdLm11bHRpcGxlOwoJCWlmICggIXRoaXMub3B0aW9ucy50aGVtZSApIHsKCQkJdGhpcy5vcHRpb25zLnRoZW1lID0gJC5tb2JpbGUuZ2V0SW5oZXJpdGVkVGhlbWUoIHRoaXMuc2VsZWN0LCAiYyIgKTsKCQl9Cgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3ByZUV4dGVuc2lvbigpOwoKCQkvLyBBbGxvd3MgZm9yIGV4dGVuc2lvbiBvZiB0aGUgbmF0aXZlIHNlbGVjdCBmb3IgY3VzdG9tIHNlbGVjdHMgYW5kIG90aGVyIHBsdWdpbnMKCQkvLyBzZWUgc2VsZWN0LmN1c3RvbSBmb3IgZXhhbXBsZSBleHRlbnNpb24KCQkvLyBUT0RPIGV4cGxvcmUgcGx1Z2luIHJlZ2lzdHJhdGlvbgoJCXRoaXMuX3RyaWdnZXIoICJiZWZvcmVDcmVhdGUiICk7CgoJCXRoaXMuYnV0dG9uID0gdGhpcy5fYnV0dG9uKCk7CgoJCXZhciBzZWxmID0gdGhpcywKCgkJCW9wdGlvbnMgPSB0aGlzLm9wdGlvbnMsCgoJCQlpbmxpbmUgPSBvcHRpb25zLmlubGluZSB8fCB0aGlzLnNlbGVjdC5qcW1EYXRhKCAiaW5saW5lIiApLAoJCQltaW5pID0gb3B0aW9ucy5taW5pIHx8IHRoaXMuc2VsZWN0LmpxbURhdGEoICJtaW5pIiApLAoJCQlpY29ucG9zID0gb3B0aW9ucy5pY29uID8gKCBvcHRpb25zLmljb25wb3MgfHwgdGhpcy5zZWxlY3QuanFtRGF0YSggImljb25wb3MiICkgKSA6IGZhbHNlLAoKCQkJLy8gSUUgdGhyb3dzIGFuIGV4Y2VwdGlvbiBhdCBvcHRpb25zLml0ZW0oKSBmdW5jdGlvbiB3aGVuCgkJCS8vIHRoZXJlIGlzIG5vIHNlbGVjdGVkIGl0ZW0KCQkJLy8gc2VsZWN0IGZpcnN0IGluIHRoaXMgY2FzZQoJCQlzZWxlY3RlZEluZGV4ID0gdGhpcy5zZWxlY3RbIDAgXS5zZWxlY3RlZEluZGV4ID09PSAtMSA/IDAgOiB0aGlzLnNlbGVjdFsgMCBdLnNlbGVjdGVkSW5kZXgsCgoJCQkvLyBUT0RPIHZhbHVlcyBidXR0b25JZCBhbmQgbWVudUlkIGFyZSB1bmRlZmluZWQgaGVyZQoJCQlidXR0b24gPSB0aGlzLmJ1dHRvbgoJCQkJLmluc2VydEJlZm9yZSggdGhpcy5zZWxlY3QgKQoJCQkJLmJ1dHRvbk1hcmt1cCggewoJCQkJCXRoZW1lOiBvcHRpb25zLnRoZW1lLAoJCQkJCWljb246IG9wdGlvbnMuaWNvbiwKCQkJCQlpY29ucG9zOiBpY29ucG9zLAoJCQkJCWlubGluZTogaW5saW5lLAoJCQkJCWNvcm5lcnM6IG9wdGlvbnMuY29ybmVycywKCQkJCQlzaGFkb3c6IG9wdGlvbnMuc2hhZG93LAoJCQkJCWljb25zaGFkb3c6IG9wdGlvbnMuaWNvbnNoYWRvdywKCQkJCQltaW5pOiBtaW5pCgkJCQl9KTsKCgkJdGhpcy5zZXRCdXR0b25UZXh0KCk7CgoJCS8vIE9wZXJhIGRvZXMgbm90IHByb3Blcmx5IHN1cHBvcnQgb3BhY2l0eSBvbiBzZWxlY3QgZWxlbWVudHMKCQkvLyBJbiBNaW5pLCBpdCBoaWRlcyB0aGUgZWxlbWVudCwgYnV0IG5vdCBpdHMgdGV4dAoJCS8vIE9uIHRoZSBkZXNrdG9wLGl0IHNlZW1zIHRvIGRvIHRoZSBvcHBvc2l0ZQoJCS8vIGZvciB0aGVzZSByZWFzb25zLCB1c2luZyB0aGUgbmF0aXZlTWVudSBvcHRpb24gcmVzdWx0cyBpbiBhIGZ1bGwgbmF0aXZlIHNlbGVjdCBpbiBPcGVyYQoJCWlmICggb3B0aW9ucy5uYXRpdmVNZW51ICYmIHdpbmRvdy5vcGVyYSAmJiB3aW5kb3cub3BlcmEudmVyc2lvbiApIHsKCQkJYnV0dG9uLmFkZENsYXNzKCAidWktc2VsZWN0LW5hdGl2ZW9ubHkiICk7CgkJfQoKCQkvLyBBZGQgY291bnRlciBmb3IgbXVsdGkgc2VsZWN0cwoJCWlmICggdGhpcy5pc011bHRpcGxlICkgewoJCQl0aGlzLmJ1dHRvbkNvdW50ID0gJCggIjxzcGFuPiIgKQoJCQkJLmFkZENsYXNzKCAidWktbGktY291bnQgdWktYnRuLXVwLWMgdWktYnRuLWNvcm5lci1hbGwiICkKCQkJCS5oaWRlKCkKCQkJCS5hcHBlbmRUbyggYnV0dG9uLmFkZENsYXNzKCd1aS1saS1oYXMtY291bnQnKSApOwoJCX0KCgkJLy8gRGlzYWJsZSBpZiBzcGVjaWZpZWQKCQlpZiAoIG9wdGlvbnMuZGlzYWJsZWQgfHwgdGhpcy5lbGVtZW50LmF0dHIoJ2Rpc2FibGVkJykpIHsKCQkJdGhpcy5kaXNhYmxlKCk7CgkJfQoKCQkvLyBFdmVudHMgb24gbmF0aXZlIHNlbGVjdAoJCXRoaXMuc2VsZWN0LmNoYW5nZShmdW5jdGlvbigpIHsKCQkJc2VsZi5yZWZyZXNoKCk7CgkJfSk7CgoJCXRoaXMuYnVpbGQoKTsKCX0sCgoJYnVpbGQ6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpczsKCgkJdGhpcy5zZWxlY3QKCQkJLmFwcGVuZFRvKCBzZWxmLmJ1dHRvbiApCgkJCS5iaW5kKCAidm1vdXNlZG93biIsIGZ1bmN0aW9uKCkgewoJCQkJLy8gQWRkIGFjdGl2ZSBjbGFzcyB0byBidXR0b24KCQkJCXNlbGYuYnV0dG9uLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQl9KQoJCQkuYmluZCggImZvY3VzIiwgZnVuY3Rpb24oKSB7CgkJCQlzZWxmLmJ1dHRvbi5hZGRDbGFzcyggJC5tb2JpbGUuZm9jdXNDbGFzcyApOwoJCQl9KQoJCQkuYmluZCggImJsdXIiLCBmdW5jdGlvbigpIHsKCQkJCXNlbGYuYnV0dG9uLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5mb2N1c0NsYXNzICk7CgkJCX0pCgkJCS5iaW5kKCAiZm9jdXMgdm1vdXNlb3ZlciIsIGZ1bmN0aW9uKCkgewoJCQkJc2VsZi5idXR0b24udHJpZ2dlciggInZtb3VzZW92ZXIiICk7CgkJCX0pCgkJCS5iaW5kKCAidm1vdXNlbW92ZSIsIGZ1bmN0aW9uKCkgewoJCQkJLy8gUmVtb3ZlIGFjdGl2ZSBjbGFzcyBvbiBzY3JvbGwvdG91Y2htb3ZlCgkJCQlzZWxmLmJ1dHRvbi5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJfSkKCQkJLmJpbmQoICJjaGFuZ2UgYmx1ciB2bW91c2VvdXQiLCBmdW5jdGlvbigpIHsKCQkJCXNlbGYuYnV0dG9uLnRyaWdnZXIoICJ2bW91c2VvdXQiICkKCQkJCQkucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCX0pCgkJCS5iaW5kKCAiY2hhbmdlIGJsdXIiLCBmdW5jdGlvbigpIHsKCQkJCXNlbGYuYnV0dG9uLnJlbW92ZUNsYXNzKCAidWktYnRuLWRvd24tIiArIHNlbGYub3B0aW9ucy50aGVtZSApOwoJCQl9KTsKCgkJLy8gSW4gbWFueSBzaXR1YXRpb25zLCBpT1Mgd2lsbCB6b29tIGludG8gdGhlIHNlbGVjdCB1cG9uIHRhcCwgdGhpcyBwcmV2ZW50cyB0aGF0IGZyb20gaGFwcGVuaW5nCgkJc2VsZi5idXR0b24uYmluZCggInZtb3VzZWRvd24iLCBmdW5jdGlvbigpIHsKCQkJaWYgKCBzZWxmLm9wdGlvbnMucHJldmVudEZvY3VzWm9vbSApIHsKCQkJCSQubW9iaWxlLnpvb20uZGlzYWJsZSggdHJ1ZSApOwoJCQl9CgkJfSkuYmluZCggIm1vdXNldXAiLCBmdW5jdGlvbigpIHsKCQkJaWYgKCBzZWxmLm9wdGlvbnMucHJldmVudEZvY3VzWm9vbSApIHsKCQkJCXNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CgkJCQkJJC5tb2JpbGUuem9vbS5lbmFibGUoIHRydWUgKTsKCQkJCX0sIDApOwoJCQl9CgkJfSk7Cgl9LAoKCXNlbGVjdGVkOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5fc2VsZWN0T3B0aW9ucygpLmZpbHRlciggIjpzZWxlY3RlZCIgKTsKCX0sCgoJc2VsZWN0ZWRJbmRpY2VzOiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXM7CgoJCXJldHVybiB0aGlzLnNlbGVjdGVkKCkubWFwKGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gc2VsZi5fc2VsZWN0T3B0aW9ucygpLmluZGV4KCB0aGlzICk7CgkJfSkuZ2V0KCk7Cgl9LAoKCXNldEJ1dHRvblRleHQ6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpcywKCQkJc2VsZWN0ZWQgPSB0aGlzLnNlbGVjdGVkKCksCgkJCXRleHQgPSB0aGlzLnBsYWNlaG9sZGVyLAoJCQlzcGFuID0gJCggZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggInNwYW4iICkgKTsKCgkJdGhpcy5idXR0b24uZmluZCggIi51aS1idG4tdGV4dCIgKS5odG1sKGZ1bmN0aW9uKCkgewoJCQlpZiAoIHNlbGVjdGVkLmxlbmd0aCApIHsKCQkJCXRleHQgPSBzZWxlY3RlZC5tYXAoZnVuY3Rpb24oKSB7CgkJCQkJcmV0dXJuICQoIHRoaXMgKS50ZXh0KCk7CgkJCQl9KS5nZXQoKS5qb2luKCAiLCAiICk7CgkJCX0gZWxzZSB7CgkJCQl0ZXh0ID0gc2VsZi5wbGFjZWhvbGRlcjsKCQkJfQoKCQkJLy8gVE9ETyBwb3NzaWJseSBhZ2dyZWdhdGUgbXVsdGlwbGUgc2VsZWN0IG9wdGlvbiBjbGFzc2VzCgkJCXJldHVybiBzcGFuLnRleHQoIHRleHQgKQoJCQkJLmFkZENsYXNzKCBzZWxmLnNlbGVjdC5hdHRyKCAiY2xhc3MiICkgKQoJCQkJLmFkZENsYXNzKCBzZWxlY3RlZC5hdHRyKCAiY2xhc3MiICkgKTsKCQl9KTsKCX0sCgoJc2V0QnV0dG9uQ291bnQ6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxlY3RlZCA9IHRoaXMuc2VsZWN0ZWQoKTsKCgkJLy8gbXVsdGlwbGUgY291bnQgaW5zaWRlIGJ1dHRvbgoJCWlmICggdGhpcy5pc011bHRpcGxlICkgewoJCQl0aGlzLmJ1dHRvbkNvdW50WyBzZWxlY3RlZC5sZW5ndGggPiAxID8gInNob3ciIDogImhpZGUiIF0oKS50ZXh0KCBzZWxlY3RlZC5sZW5ndGggKTsKCQl9Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCXRoaXMuc2V0QnV0dG9uVGV4dCgpOwoJCXRoaXMuc2V0QnV0dG9uQ291bnQoKTsKCX0sCgoJLy8gb3BlbiBhbmQgY2xvc2UgcHJlc2VydmVkIGluIG5hdGl2ZSBzZWxlY3RzCgkvLyB0byBzaW1wbGlmeSB1c2VycyBjb2RlIHdoZW4gbG9vcGluZyBvdmVyIHNlbGVjdHMKCW9wZW46ICQubm9vcCwKCWNsb3NlOiAkLm5vb3AsCgoJZGlzYWJsZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5fc2V0RGlzYWJsZWQoIHRydWUgKTsKCQl0aGlzLmJ1dHRvbi5hZGRDbGFzcyggInVpLWRpc2FibGVkIiApOwoJfSwKCgllbmFibGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3NldERpc2FibGVkKCBmYWxzZSApOwoJCXRoaXMuYnV0dG9uLnJlbW92ZUNsYXNzKCAidWktZGlzYWJsZWQiICk7Cgl9Cn0pOwoKLy9hdXRvIHNlbGYtaW5pdCB3aWRnZXRzCiQoIGRvY3VtZW50ICkuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKSB7CgkkLm1vYmlsZS5zZWxlY3RtZW51LnByb3RvdHlwZS5lbmhhbmNlV2l0aGluKCBlLnRhcmdldCwgdHJ1ZSApOwp9KTsKfSkoIGpRdWVyeSApOwoKLyoKKiBjdXN0b20gInNlbGVjdG1lbnUiIHBsdWdpbgoqLwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7Cgl2YXIgZXh0ZW5kU2VsZWN0ID0gZnVuY3Rpb24oIHdpZGdldCApIHsKCgkJdmFyIHNlbGVjdCA9IHdpZGdldC5zZWxlY3QsCgkJCXNlbGVjdElEICA9IHdpZGdldC5zZWxlY3RJRCwKCQkJbGFiZWwgPSB3aWRnZXQubGFiZWwsCgkJCXRoaXNQYWdlID0gd2lkZ2V0LnNlbGVjdC5jbG9zZXN0KCAiLnVpLXBhZ2UiICksCgkJCXNlbGVjdE9wdGlvbnMgPSB3aWRnZXQuX3NlbGVjdE9wdGlvbnMoKSwKCQkJaXNNdWx0aXBsZSA9IHdpZGdldC5pc011bHRpcGxlID0gd2lkZ2V0LnNlbGVjdFsgMCBdLm11bHRpcGxlLAoJCQlidXR0b25JZCA9IHNlbGVjdElEICsgIi1idXR0b24iLAoJCQltZW51SWQgPSBzZWxlY3RJRCArICItbWVudSIsCgkJCW1lbnVQYWdlID0gJCggIjxkaXYgZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicm9sZT0nZGlhbG9nJyBkYXRhLSIgKyQubW9iaWxlLm5zICsgInRoZW1lPSciKyB3aWRnZXQub3B0aW9ucy50aGVtZSArIicgZGF0YS0iICskLm1vYmlsZS5ucyArICJvdmVybGF5LXRoZW1lPSciKyB3aWRnZXQub3B0aW9ucy5vdmVybGF5VGhlbWUgKyInPiIgKwoJCQkJIjxkaXYgZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicm9sZT0naGVhZGVyJz4iICsKCQkJCSI8ZGl2IGNsYXNzPSd1aS10aXRsZSc+IiArIGxhYmVsLmdldEVuY29kZWRUZXh0KCkgKyAiPC9kaXY+IisKCQkJCSI8L2Rpdj4iKwoJCQkJIjxkaXYgZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicm9sZT0nY29udGVudCc+PC9kaXY+IisKCQkJCSI8L2Rpdj4iICksCgoJCQlsaXN0Ym94ID0gICQoICI8ZGl2PiIsIHsgImNsYXNzIjogInVpLXNlbGVjdG1lbnUiIH0gKS5pbnNlcnRBZnRlciggd2lkZ2V0LnNlbGVjdCApLnBvcHVwKCB7IHRoZW1lOiAiYSIgfSApLAoKCQkJbGlzdCA9ICQoICI8dWw+IiwgewoJCQkJImNsYXNzIjogInVpLXNlbGVjdG1lbnUtbGlzdCIsCgkJCQkiaWQiOiBtZW51SWQsCgkJCQkicm9sZSI6ICJsaXN0Ym94IiwKCQkJCSJhcmlhLWxhYmVsbGVkYnkiOiBidXR0b25JZAoJCQl9KS5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidGhlbWUiLCB3aWRnZXQub3B0aW9ucy50aGVtZSApLmFwcGVuZFRvKCBsaXN0Ym94ICksCgoJCQloZWFkZXIgPSAkKCAiPGRpdj4iLCB7CgkJCQkiY2xhc3MiOiAidWktaGVhZGVyIHVpLWJhci0iICsgd2lkZ2V0Lm9wdGlvbnMudGhlbWUKCQkJfSkucHJlcGVuZFRvKCBsaXN0Ym94ICksCgoJCQloZWFkZXJUaXRsZSA9ICQoICI8aDE+IiwgewoJCQkJImNsYXNzIjogInVpLXRpdGxlIgoJCQl9KS5hcHBlbmRUbyggaGVhZGVyICksCgoJCQltZW51UGFnZUNvbnRlbnQsCgkJCW1lbnVQYWdlQ2xvc2UsCgkJCWhlYWRlckNsb3NlOwoKCQlpZiAoIHdpZGdldC5pc011bHRpcGxlICkgewoJCQloZWFkZXJDbG9zZSA9ICQoICI8YT4iLCB7CgkJCQkidGV4dCI6IHdpZGdldC5vcHRpb25zLmNsb3NlVGV4dCwKCQkJCSJocmVmIjogIiMiLAoJCQkJImNsYXNzIjogInVpLWJ0bi1sZWZ0IgoJCQl9KS5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAiaWNvbnBvcyIsICJub3RleHQiICkuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgImljb24iLCAiZGVsZXRlIiApLmFwcGVuZFRvKCBoZWFkZXIgKS5idXR0b25NYXJrdXAoKTsKCQl9CgoJCSQuZXh0ZW5kKCB3aWRnZXQsIHsKCQkJc2VsZWN0OiB3aWRnZXQuc2VsZWN0LAoJCQlzZWxlY3RJRDogc2VsZWN0SUQsCgkJCWJ1dHRvbklkOiBidXR0b25JZCwKCQkJbWVudUlkOiBtZW51SWQsCgkJCXRoaXNQYWdlOiB0aGlzUGFnZSwKCQkJbWVudVBhZ2U6IG1lbnVQYWdlLAoJCQlsYWJlbDogbGFiZWwsCgkJCXNlbGVjdE9wdGlvbnM6IHNlbGVjdE9wdGlvbnMsCgkJCWlzTXVsdGlwbGU6IGlzTXVsdGlwbGUsCgkJCXRoZW1lOiB3aWRnZXQub3B0aW9ucy50aGVtZSwKCQkJbGlzdGJveDogbGlzdGJveCwKCQkJbGlzdDogbGlzdCwKCQkJaGVhZGVyOiBoZWFkZXIsCgkJCWhlYWRlclRpdGxlOiBoZWFkZXJUaXRsZSwKCQkJaGVhZGVyQ2xvc2U6IGhlYWRlckNsb3NlLAoJCQltZW51UGFnZUNvbnRlbnQ6IG1lbnVQYWdlQ29udGVudCwKCQkJbWVudVBhZ2VDbG9zZTogbWVudVBhZ2VDbG9zZSwKCQkJcGxhY2Vob2xkZXI6ICIiLAoKCQkJYnVpbGQ6IGZ1bmN0aW9uKCkgewoJCQkJdmFyIHNlbGYgPSB0aGlzOwoKCQkJCS8vIENyZWF0ZSBsaXN0IGZyb20gc2VsZWN0LCB1cGRhdGUgc3RhdGUKCQkJCXNlbGYucmVmcmVzaCgpOwoKCQkJCXNlbGYuc2VsZWN0LmF0dHIoICJ0YWJpbmRleCIsICItMSIgKS5mb2N1cyhmdW5jdGlvbigpIHsKCQkJCQkkKCB0aGlzICkuYmx1cigpOwoJCQkJCXNlbGYuYnV0dG9uLmZvY3VzKCk7CgkJCQl9KTsKCgkJCQkvLyBCdXR0b24gZXZlbnRzCgkJCQlzZWxmLmJ1dHRvbi5iaW5kKCAidmNsaWNrIGtleWRvd24iICwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJCWlmIChldmVudC50eXBlID09PSAidmNsaWNrIiB8fAoJCQkJCQkJZXZlbnQua2V5Q29kZSAmJiAoZXZlbnQua2V5Q29kZSA9PT0gJC5tb2JpbGUua2V5Q29kZS5FTlRFUiB8fAoJCQkJCQkJCQkJCQkJCQkJZXZlbnQua2V5Q29kZSA9PT0gJC5tb2JpbGUua2V5Q29kZS5TUEFDRSkpIHsKCgkJCQkJCXNlbGYub3BlbigpOwoJCQkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJCX0KCQkJCX0pOwoKCQkJCS8vIEV2ZW50cyBmb3IgbGlzdCBpdGVtcwoJCQkJc2VsZi5saXN0LmF0dHIoICJyb2xlIiwgImxpc3Rib3giICkKCQkJCQkuYmluZCggImZvY3VzaW4iLCBmdW5jdGlvbiggZSApIHsKCQkJCQkJJCggZS50YXJnZXQgKQoJCQkJCQkJLmF0dHIoICJ0YWJpbmRleCIsICIwIiApCgkJCQkJCQkudHJpZ2dlciggInZtb3VzZW92ZXIiICk7CgoJCQkJCX0pCgkJCQkJLmJpbmQoICJmb2N1c291dCIsIGZ1bmN0aW9uKCBlICkgewoJCQkJCQkkKCBlLnRhcmdldCApCgkJCQkJCQkuYXR0ciggInRhYmluZGV4IiwgIi0xIiApCgkJCQkJCQkudHJpZ2dlciggInZtb3VzZW91dCIgKTsKCQkJCQl9KQoJCQkJCS5kZWxlZ2F0ZSggImxpOm5vdCgudWktZGlzYWJsZWQsIC51aS1saS1kaXZpZGVyKSIsICJjbGljayIsIGZ1bmN0aW9uKCBldmVudCApIHsKCgkJCQkJCS8vIGluZGV4IG9mIG9wdGlvbiB0YWcgdG8gYmUgc2VsZWN0ZWQKCQkJCQkJdmFyIG9sZEluZGV4ID0gc2VsZi5zZWxlY3RbIDAgXS5zZWxlY3RlZEluZGV4LAoJCQkJCQkJbmV3SW5kZXggPSBzZWxmLmxpc3QuZmluZCggImxpOm5vdCgudWktbGktZGl2aWRlcikiICkuaW5kZXgoIHRoaXMgKSwKCQkJCQkJCW9wdGlvbiA9IHNlbGYuX3NlbGVjdE9wdGlvbnMoKS5lcSggbmV3SW5kZXggKVsgMCBdOwoKCQkJCQkJLy8gdG9nZ2xlIHNlbGVjdGVkIHN0YXR1cyBvbiB0aGUgdGFnIGZvciBtdWx0aSBzZWxlY3RzCgkJCQkJCW9wdGlvbi5zZWxlY3RlZCA9IHNlbGYuaXNNdWx0aXBsZSA/ICFvcHRpb24uc2VsZWN0ZWQgOiB0cnVlOwoKCQkJCQkJLy8gdG9nZ2xlIGNoZWNrYm94IGNsYXNzIGZvciBtdWx0aXBsZSBzZWxlY3RzCgkJCQkJCWlmICggc2VsZi5pc011bHRpcGxlICkgewoJCQkJCQkJJCggdGhpcyApLmZpbmQoICIudWktaWNvbiIgKQoJCQkJCQkJCS50b2dnbGVDbGFzcyggInVpLWljb24tY2hlY2tib3gtb24iLCBvcHRpb24uc2VsZWN0ZWQgKQoJCQkJCQkJCS50b2dnbGVDbGFzcyggInVpLWljb24tY2hlY2tib3gtb2ZmIiwgIW9wdGlvbi5zZWxlY3RlZCApOwoJCQkJCQl9CgoJCQkJCQkvLyB0cmlnZ2VyIGNoYW5nZSBpZiB2YWx1ZSBjaGFuZ2VkCgkJCQkJCWlmICggc2VsZi5pc011bHRpcGxlIHx8IG9sZEluZGV4ICE9PSBuZXdJbmRleCApIHsKCQkJCQkJCXNlbGYuc2VsZWN0LnRyaWdnZXIoICJjaGFuZ2UiICk7CgkJCQkJCX0KCgkJCQkJCS8vIGhpZGUgY3VzdG9tIHNlbGVjdCBmb3Igc2luZ2xlIHNlbGVjdHMgb25seSAtIG90aGVyd2lzZSBmb2N1cyBjbGlja2VkIGl0ZW0KCQkJCQkJLy8gV2UgbmVlZCB0byBncmFiIHRoZSBjbGlja2VkIGl0ZW0gdGhlIGhhcmQgd2F5LCBiZWNhdXNlIHRoZSBsaXN0IG1heSBoYXZlIGJlZW4gcmVidWlsdAoJCQkJCQlpZiAoIHNlbGYuaXNNdWx0aXBsZSApIHsKCQkJCQkJCXNlbGYubGlzdC5maW5kKCAibGk6bm90KC51aS1saS1kaXZpZGVyKSIgKS5lcSggbmV3SW5kZXggKQoJCQkJCQkJCS5hZGRDbGFzcyggInVpLWJ0bi1kb3duLSIgKyB3aWRnZXQub3B0aW9ucy50aGVtZSApLmZpbmQoICJhIiApLmZpcnN0KCkuZm9jdXMoKTsKCQkJCQkJfQoJCQkJCQllbHNlIHsKCQkJCQkJCXNlbGYuY2xvc2UoKTsKCQkJCQkJfQoKCQkJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCQl9KQoJCQkJCS5rZXlkb3duKGZ1bmN0aW9uKCBldmVudCApIHsgIC8va2V5Ym9hcmQgZXZlbnRzIGZvciBtZW51IGl0ZW1zCgkJCQkJCXZhciB0YXJnZXQgPSAkKCBldmVudC50YXJnZXQgKSwKCQkJCQkJCWxpID0gdGFyZ2V0LmNsb3Nlc3QoICJsaSIgKSwKCQkJCQkJCXByZXYsIG5leHQ7CgoJCQkJCQkvLyBzd2l0Y2ggbG9naWMgYmFzZWQgb24gd2hpY2gga2V5IHdhcyBwcmVzc2VkCgkJCQkJCXN3aXRjaCAoIGV2ZW50LmtleUNvZGUgKSB7CgkJCQkJCQkvLyB1cCBvciBsZWZ0IGFycm93IGtleXMKCQkJCQkJY2FzZSAzODoKCQkJCQkJCXByZXYgPSBsaS5wcmV2KCkubm90KCAiLnVpLXNlbGVjdG1lbnUtcGxhY2Vob2xkZXIiICk7CgoJCQkJCQkJaWYgKCBwcmV2LmlzKCAiLnVpLWxpLWRpdmlkZXIiICkgKSB7CgkJCQkJCQkJcHJldiA9IHByZXYucHJldigpOwoJCQkJCQkJfQoKCQkJCQkJCS8vIGlmIHRoZXJlJ3MgYSBwcmV2aW91cyBvcHRpb24sIGZvY3VzIGl0CgkJCQkJCQlpZiAoIHByZXYubGVuZ3RoICkgewoJCQkJCQkJCXRhcmdldAoJCQkJCQkJCQkuYmx1cigpCgkJCQkJCQkJCS5hdHRyKCAidGFiaW5kZXgiLCAiLTEiICk7CgoJCQkJCQkJCXByZXYuYWRkQ2xhc3MoICJ1aS1idG4tZG93bi0iICsgd2lkZ2V0Lm9wdGlvbnMudGhlbWUgKS5maW5kKCAiYSIgKS5maXJzdCgpLmZvY3VzKCk7CgkJCQkJCQl9CgoJCQkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJCQkJLy8gZG93biBvciByaWdodCBhcnJvdyBrZXlzCgkJCQkJCWNhc2UgNDA6CgkJCQkJCQluZXh0ID0gbGkubmV4dCgpOwoKCQkJCQkJCWlmICggbmV4dC5pcyggIi51aS1saS1kaXZpZGVyIiApICkgewoJCQkJCQkJCW5leHQgPSBuZXh0Lm5leHQoKTsKCQkJCQkJCX0KCgkJCQkJCQkvLyBpZiB0aGVyZSdzIGEgbmV4dCBvcHRpb24sIGZvY3VzIGl0CgkJCQkJCQlpZiAoIG5leHQubGVuZ3RoICkgewoJCQkJCQkJCXRhcmdldAoJCQkJCQkJCQkuYmx1cigpCgkJCQkJCQkJCS5hdHRyKCAidGFiaW5kZXgiLCAiLTEiICk7CgoJCQkJCQkJCW5leHQuYWRkQ2xhc3MoICJ1aS1idG4tZG93bi0iICsgd2lkZ2V0Lm9wdGlvbnMudGhlbWUgKS5maW5kKCAiYSIgKS5maXJzdCgpLmZvY3VzKCk7CgkJCQkJCQl9CgoJCQkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJCQkJLy8gSWYgZW50ZXIgb3Igc3BhY2UgaXMgcHJlc3NlZCwgdHJpZ2dlciBjbGljawoJCQkJCQljYXNlIDEzOgoJCQkJCQljYXNlIDMyOgoJCQkJCQkJdGFyZ2V0LnRyaWdnZXIoICJjbGljayIgKTsKCgkJCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQkJCX0KCQkJCQl9KTsKCgkJCQkvLyBidXR0b24gcmVmb2N1cyBlbnN1cmVzIHByb3BlciBoZWlnaHQgY2FsY3VsYXRpb24KCQkJCS8vIGJ5IHJlbW92aW5nIHRoZSBpbmxpbmUgc3R5bGUgYW5kIGVuc3VyaW5nIHBhZ2UgaW5jbHVzaW9uCgkJCQlzZWxmLm1lbnVQYWdlLmJpbmQoICJwYWdlaGlkZSIsIGZ1bmN0aW9uKCkgewoJCQkJCXNlbGYubGlzdC5hcHBlbmRUbyggc2VsZi5saXN0Ym94ICk7CgkJCQkJc2VsZi5fZm9jdXNCdXR0b24oKTsKCgkJCQkJLy8gVE9ETyBjZW50cmFsaXplIHBhZ2UgcmVtb3ZhbCBiaW5kaW5nIC8gaGFuZGxpbmcgaW4gdGhlIHBhZ2UgcGx1Z2luLgoJCQkJCS8vIFN1Z2dlc3Rpb24gZnJvbSBAamJsYXMgdG8gZG8gcmVmY291bnRpbmcKCQkJCQkvLwoJCQkJCS8vIFRPRE8gZXh0cmVtZWx5IGNvbmZ1c2luZyBkZXBlbmRlbmN5IG9uIHRoZSBvcGVuIG1ldGhvZCB3aGVyZSB0aGUgcGFnZWhpZGUucmVtb3ZlCgkJCQkJLy8gYmluZGluZ3MgYXJlIHN0cmlwcGVkIHRvIHByZXZlbnQgdGhlIHBhcmVudCBwYWdlIGZyb20gZGlzYXBwZWFyaW5nLiBUaGUgd2F5CgkJCQkJLy8gd2UncmUga2VlcGluZyBwYWdlcyBpbiB0aGUgRE9NIHJpZ2h0IG5vdyBzdWNrcwoJCQkJCS8vCgkJCQkJLy8gcmViaW5kIHRoZSBwYWdlIHJlbW92ZSB0aGF0IHdhcyB1bmJvdW5kIGluIHRoZSBvcGVuIGZ1bmN0aW9uCgkJCQkJLy8gdG8gYWxsb3cgZm9yIHRoZSBwYXJlbnQgcGFnZSByZW1vdmFsIGZyb20gYWN0aW9ucyBvdGhlciB0aGFuIHRoZSB1c2UKCQkJCQkvLyBvZiBhIGRpYWxvZyBzaXplZCBjdXN0b20gc2VsZWN0CgkJCQkJLy8KCQkJCQkvLyBkb2luZyB0aGlzIGhlcmUgcHJvdmlkZXMgZm9yIHRoZSBiYWNrIGJ1dHRvbiBvbiB0aGUgY3VzdG9tIHNlbGVjdCBkaWFsb2cKCQkJCQkkLm1vYmlsZS5fYmluZFBhZ2VSZW1vdmUuY2FsbCggc2VsZi50aGlzUGFnZSApOwoJCQkJfSk7CgoJCQkJLy8gRXZlbnRzIG9uIHRoZSBwb3B1cAoJCQkJc2VsZi5saXN0Ym94LmJpbmQoICJwb3B1cGFmdGVyY2xvc2UiLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkJc2VsZi5jbG9zZSgpOwoJCQkJfSk7CgoJCQkJLy8gQ2xvc2UgYnV0dG9uIG9uIHNtYWxsIG92ZXJsYXlzCgkJCQlpZiAoIHNlbGYuaXNNdWx0aXBsZSApIHsKCQkJCQlzZWxmLmhlYWRlckNsb3NlLmNsaWNrKGZ1bmN0aW9uKCkgewoJCQkJCQlpZiAoIHNlbGYubWVudVR5cGUgPT09ICJvdmVybGF5IiApIHsKCQkJCQkJCXNlbGYuY2xvc2UoKTsKCQkJCQkJCXJldHVybiBmYWxzZTsKCQkJCQkJfQoJCQkJCX0pOwoJCQkJfQoKCQkJCS8vIHRyYWNrIHRoaXMgZGVwZW5kZW5jeSBzbyB0aGF0IHdoZW4gdGhlIHBhcmVudCBwYWdlCgkJCQkvLyBpcyByZW1vdmVkIG9uIHBhZ2VoaWRlIGl0IHdpbGwgYWxzbyByZW1vdmUgdGhlIG1lbnVwYWdlCgkJCQlzZWxmLnRoaXNQYWdlLmFkZERlcGVuZGVudHMoIHRoaXMubWVudVBhZ2UgKTsKCQkJfSwKCgkJCV9pc1JlYnVpbGRSZXF1aXJlZDogZnVuY3Rpb24oKSB7CgkJCQl2YXIgbGlzdCA9IHRoaXMubGlzdC5maW5kKCAibGkiICksCgkJCQkJb3B0aW9ucyA9IHRoaXMuX3NlbGVjdE9wdGlvbnMoKTsKCgkJCQkvLyBUT0RPIGV4Y2VlZGluZ2x5IG5haXZlIG1ldGhvZCB0byBkZXRlcm1pbmUgZGlmZmVyZW5jZQoJCQkJLy8gaWdub3JlcyB2YWx1ZSBjaGFuZ2VzIGV0YyBpbiBmYXZvciBvZiBhIGZvcmNlZFJlYnVpbGQKCQkJCS8vIGZyb20gdGhlIHVzZXIgaW4gdGhlIHJlZnJlc2ggbWV0aG9kCgkJCQlyZXR1cm4gb3B0aW9ucy50ZXh0KCkgIT09IGxpc3QudGV4dCgpOwoJCQl9LAoKCQkJc2VsZWN0ZWQ6IGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuIHRoaXMuX3NlbGVjdE9wdGlvbnMoKS5maWx0ZXIoICI6c2VsZWN0ZWQ6bm90KCA6anFtRGF0YShwbGFjZWhvbGRlcj0ndHJ1ZScpICkiICk7CgkJCX0sCgoJCQlyZWZyZXNoOiBmdW5jdGlvbiggZm9yY2VSZWJ1aWxkICwgZm9vICkgewoJCQkJdmFyIHNlbGYgPSB0aGlzLAoJCQkJc2VsZWN0ID0gdGhpcy5lbGVtZW50LAoJCQkJaXNNdWx0aXBsZSA9IHRoaXMuaXNNdWx0aXBsZSwKCQkJCWluZGljaWVzOwoKCQkJCWlmICggIGZvcmNlUmVidWlsZCB8fCB0aGlzLl9pc1JlYnVpbGRSZXF1aXJlZCgpICkgewoJCQkJCXNlbGYuX2J1aWxkTGlzdCgpOwoJCQkJfQoKCQkJCWluZGljaWVzID0gdGhpcy5zZWxlY3RlZEluZGljZXMoKTsKCgkJCQlzZWxmLnNldEJ1dHRvblRleHQoKTsKCQkJCXNlbGYuc2V0QnV0dG9uQ291bnQoKTsKCgkJCQlzZWxmLmxpc3QuZmluZCggImxpOm5vdCgudWktbGktZGl2aWRlcikiICkKCQkJCQkucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICkKCQkJCQkuYXR0ciggImFyaWEtc2VsZWN0ZWQiLCBmYWxzZSApCgkJCQkJLmVhY2goZnVuY3Rpb24oIGkgKSB7CgoJCQkJCQlpZiAoICQuaW5BcnJheSggaSwgaW5kaWNpZXMgKSA+IC0xICkgewoJCQkJCQkJdmFyIGl0ZW0gPSAkKCB0aGlzICk7CgoJCQkJCQkJLy8gQXJpYSBzZWxlY3RlZCBhdHRyCgkJCQkJCQlpdGVtLmF0dHIoICJhcmlhLXNlbGVjdGVkIiwgdHJ1ZSApOwoKCQkJCQkJCS8vIE11bHRpcGxlIHNlbGVjdHM6IGFkZCB0aGUgIm9uIiBjaGVja2JveCBzdGF0ZSB0byB0aGUgaWNvbgoJCQkJCQkJaWYgKCBzZWxmLmlzTXVsdGlwbGUgKSB7CgkJCQkJCQkJaXRlbS5maW5kKCAiLnVpLWljb24iICkucmVtb3ZlQ2xhc3MoICJ1aS1pY29uLWNoZWNrYm94LW9mZiIgKS5hZGRDbGFzcyggInVpLWljb24tY2hlY2tib3gtb24iICk7CgkJCQkJCQl9IGVsc2UgewoJCQkJCQkJCWlmICggaXRlbS5pcyggIi51aS1zZWxlY3RtZW51LXBsYWNlaG9sZGVyIiApICkgewoJCQkJCQkJCQlpdGVtLm5leHQoKS5hZGRDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJCQkJCQl9IGVsc2UgewoJCQkJCQkJCQlpdGVtLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQkJCQkJCX0KCQkJCQkJCX0KCQkJCQkJfQoJCQkJCX0pOwoJCQl9LAoKCQkJY2xvc2U6IGZ1bmN0aW9uKCkgewoJCQkJaWYgKCB0aGlzLm9wdGlvbnMuZGlzYWJsZWQgfHwgIXRoaXMuaXNPcGVuICkgewoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQl2YXIgc2VsZiA9IHRoaXM7CgoJCQkJaWYgKCBzZWxmLm1lbnVUeXBlID09PSAicGFnZSIgKSB7CgkJCQkJLy8gZG9lc24ndCBzb2x2ZSB0aGUgcG9zc2libGUgaXNzdWUgd2l0aCBjYWxsaW5nIGNoYW5nZSBwYWdlCgkJCQkJLy8gd2hlcmUgdGhlIG9iamVjdHMgZG9uJ3QgZGVmaW5lIGRhdGEgdXJscyB3aGljaCBwcmV2ZW50cyBkaWFsb2cga2V5CgkJCQkJLy8gc3RyaXBwaW5nIC0gY2hhbmdlUGFnZSBoYXMgaW5jb21pbmcgcmVmYWN0b3IKCQkJCQkkLm1vYmlsZS5iYWNrKCk7CgkJCQl9IGVsc2UgewoJCQkJCXNlbGYubGlzdGJveC5wb3B1cCggImNsb3NlIiApOwoJCQkJCXNlbGYubGlzdC5hcHBlbmRUbyggc2VsZi5saXN0Ym94ICk7CgkJCQkJc2VsZi5fZm9jdXNCdXR0b24oKTsKCQkJCX0KCgkJCQkvLyBhbGxvdyB0aGUgZGlhbG9nIHRvIGJlIGNsb3NlZCBhZ2FpbgoJCQkJc2VsZi5pc09wZW4gPSBmYWxzZTsKCQkJfSwKCgkJCW9wZW46IGZ1bmN0aW9uKCkgewoJCQkJaWYgKCB0aGlzLm9wdGlvbnMuZGlzYWJsZWQgKSB7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCXZhciBzZWxmID0gdGhpcywKCQkJCQkkd2luZG93ID0gJCggd2luZG93ICksCgkJCQkJc2VsZkxpc3RQYXJlbnQgPSBzZWxmLmxpc3QucGFyZW50KCksCgkJCQkJbWVudUhlaWdodCA9IHNlbGZMaXN0UGFyZW50Lm91dGVySGVpZ2h0KCksCgkJCQkJbWVudVdpZHRoID0gc2VsZkxpc3RQYXJlbnQub3V0ZXJXaWR0aCgpLAoJCQkJCWFjdGl2ZVBhZ2UgPSAkKCAiLiIgKyAkLm1vYmlsZS5hY3RpdmVQYWdlQ2xhc3MgKSwKCQkJCQlzY3JvbGxUb3AgPSAkd2luZG93LnNjcm9sbFRvcCgpLAoJCQkJCWJ0bk9mZnNldCA9IHNlbGYuYnV0dG9uLm9mZnNldCgpLnRvcCwKCQkJCQlzY3JlZW5IZWlnaHQgPSAkd2luZG93LmhlaWdodCgpLAoJCQkJCXNjcmVlbldpZHRoID0gJHdpbmRvdy53aWR0aCgpOwoKCQkJCS8vYWRkIGFjdGl2ZSBjbGFzcyB0byBidXR0b24KCQkJCXNlbGYuYnV0dG9uLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoKCQkJCS8vcmVtb3ZlIGFmdGVyIGRlbGF5CgkJCQlzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJCQlzZWxmLmJ1dHRvbi5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJCX0sIDMwMCk7CgoJCQkJZnVuY3Rpb24gZm9jdXNNZW51SXRlbSgpIHsKCQkJCQl2YXIgc2VsZWN0b3IgPSBzZWxmLmxpc3QuZmluZCggIi4iICsgJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKyAiIGEiICk7CgkJCQkJaWYgKCBzZWxlY3Rvci5sZW5ndGggPT09IDAgKSB7CgkJCQkJCXNlbGVjdG9yID0gc2VsZi5saXN0LmZpbmQoICJsaS51aS1idG46bm90KCA6anFtRGF0YShwbGFjZWhvbGRlcj0ndHJ1ZScpICkgYSIgKTsKCQkJCQl9CgkJCQkJc2VsZWN0b3IuZmlyc3QoKS5mb2N1cygpLmNsb3Nlc3QoICJsaSIgKS5hZGRDbGFzcyggInVpLWJ0bi1kb3duLSIgKyB3aWRnZXQub3B0aW9ucy50aGVtZSApOwoJCQkJfQoKCQkJCWlmICggbWVudUhlaWdodCA+IHNjcmVlbkhlaWdodCAtIDgwIHx8ICEkLnN1cHBvcnQuc2Nyb2xsVG9wICkgewoKCQkJCQlzZWxmLm1lbnVQYWdlLmFwcGVuZFRvKCAkLm1vYmlsZS5wYWdlQ29udGFpbmVyICkucGFnZSgpOwoJCQkJCXNlbGYubWVudVBhZ2VDb250ZW50ID0gbWVudVBhZ2UuZmluZCggIi51aS1jb250ZW50IiApOwoJCQkJCXNlbGYubWVudVBhZ2VDbG9zZSA9IG1lbnVQYWdlLmZpbmQoICIudWktaGVhZGVyIGEiICk7CgoJCQkJCS8vIHByZXZlbnQgdGhlIHBhcmVudCBwYWdlIGZyb20gYmVpbmcgcmVtb3ZlZCBmcm9tIHRoZSBET00sCgkJCQkJLy8gb3RoZXJ3aXNlIHRoZSByZXN1bHRzIG9mIHNlbGVjdGluZyBhIGxpc3QgaXRlbSBpbiB0aGUgZGlhbG9nCgkJCQkJLy8gZmFsbCBpbnRvIGEgYmxhY2sgaG9sZQoJCQkJCXNlbGYudGhpc1BhZ2UudW5iaW5kKCAicGFnZWhpZGUucmVtb3ZlIiApOwoKCQkJCQkvL2ZvciBXZWJPUy9PcGVyYSBNaW5pIChzZXQgbGFzdHNjcm9sbCB1c2luZyBidXR0b24gb2Zmc2V0KQoJCQkJCWlmICggc2Nyb2xsVG9wID09PSAwICYmIGJ0bk9mZnNldCA+IHNjcmVlbkhlaWdodCApIHsKCQkJCQkJc2VsZi50aGlzUGFnZS5vbmUoICJwYWdlaGlkZSIsIGZ1bmN0aW9uKCkgewoJCQkJCQkJJCggdGhpcyApLmpxbURhdGEoICJsYXN0U2Nyb2xsIiwgYnRuT2Zmc2V0ICk7CgkJCQkJCX0pOwoJCQkJCX0KCgkJCQkJc2VsZi5tZW51UGFnZS5vbmUoICJwYWdlc2hvdyIsIGZ1bmN0aW9uKCkgewoJCQkJCQlmb2N1c01lbnVJdGVtKCk7CgkJCQkJCXNlbGYuaXNPcGVuID0gdHJ1ZTsKCQkJCQl9KTsKCgkJCQkJc2VsZi5tZW51VHlwZSA9ICJwYWdlIjsKCQkJCQlzZWxmLm1lbnVQYWdlQ29udGVudC5hcHBlbmQoIHNlbGYubGlzdCApOwoJCQkJCXNlbGYubWVudVBhZ2UuZmluZCgiZGl2IC51aS10aXRsZSIpLnRleHQoc2VsZi5sYWJlbC50ZXh0KCkpOwoJCQkJCSQubW9iaWxlLmNoYW5nZVBhZ2UoIHNlbGYubWVudVBhZ2UsIHsKCQkJCQkJdHJhbnNpdGlvbjogJC5tb2JpbGUuZGVmYXVsdERpYWxvZ1RyYW5zaXRpb24KCQkJCQl9KTsKCQkJCX0gZWxzZSB7CgkJCQkJc2VsZi5tZW51VHlwZSA9ICJvdmVybGF5IjsKCgkJCQkJc2VsZi5saXN0Ym94CgkJCQkJCS5vbmUoICJwb3B1cGFmdGVyb3BlbiIsIGZvY3VzTWVudUl0ZW0gKQoJCQkJCQkucG9wdXAoICJvcGVuIiwgewoJCQkJCQkJeDogc2VsZi5idXR0b24ub2Zmc2V0KCkubGVmdCArIHNlbGYuYnV0dG9uLm91dGVyV2lkdGgoKSAvIDIsCgkJCQkJCQl5OiBzZWxmLmJ1dHRvbi5vZmZzZXQoKS50b3AgKyBzZWxmLmJ1dHRvbi5vdXRlckhlaWdodCgpIC8gMgoJCQkJCQl9KTsKCgkJCQkJLy8gZHVwbGljYXRlIHdpdGggdmFsdWUgc2V0IGluIHBhZ2Ugc2hvdyBmb3IgZGlhbG9nIHNpemVkIHNlbGVjdHMKCQkJCQlzZWxmLmlzT3BlbiA9IHRydWU7CgkJCQl9CgkJCX0sCgoJCQlfYnVpbGRMaXN0OiBmdW5jdGlvbigpIHsKCQkJCXZhciBzZWxmID0gdGhpcywKCQkJCQlvID0gdGhpcy5vcHRpb25zLAoJCQkJCXBsYWNlaG9sZGVyID0gdGhpcy5wbGFjZWhvbGRlciwKCQkJCQluZWVkUGxhY2Vob2xkZXIgPSB0cnVlLAoJCQkJCW9wdGdyb3VwcyA9IFtdLAoJCQkJCWxpcyA9IFtdLAoJCQkJCWRhdGFJY29uID0gc2VsZi5pc011bHRpcGxlID8gImNoZWNrYm94LW9mZiIgOiAiZmFsc2UiOwoKCQkJCXNlbGYubGlzdC5lbXB0eSgpLmZpbHRlciggIi51aS1saXN0dmlldyIgKS5saXN0dmlldyggImRlc3Ryb3kiICk7CgoJCQkJdmFyICRvcHRpb25zID0gc2VsZi5zZWxlY3QuZmluZCggIm9wdGlvbiIgKSwKCQkJCQludW1PcHRpb25zID0gJG9wdGlvbnMubGVuZ3RoLAoJCQkJCXNlbGVjdCA9IHRoaXMuc2VsZWN0WyAwIF0sCgkJCQkJZGF0YVByZWZpeCA9ICdkYXRhLScgKyAkLm1vYmlsZS5ucywKCQkJCQlkYXRhSW5kZXhBdHRyID0gZGF0YVByZWZpeCArICdvcHRpb24taW5kZXgnLAoJCQkJCWRhdGFJY29uQXR0ciA9IGRhdGFQcmVmaXggKyAnaWNvbicsCgkJCQkJZGF0YVJvbGVBdHRyID0gZGF0YVByZWZpeCArICdyb2xlJywKCQkJCQlkYXRhUGxhY2Vob2xkZXJBdHRyID0gZGF0YVByZWZpeCArICdwbGFjZWhvbGRlcicsCgkJCQkJZnJhZ21lbnQgPSBkb2N1bWVudC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCksCgkJCQkJaXNQbGFjZWhvbGRlckl0ZW0gPSBmYWxzZSwKCQkJCQlvcHRHcm91cDsKCgkJCQlmb3IgKHZhciBpID0gMDsgaSA8IG51bU9wdGlvbnM7aSsrLCBpc1BsYWNlaG9sZGVySXRlbSA9IGZhbHNlKSB7CgkJCQkJdmFyIG9wdGlvbiA9ICRvcHRpb25zW2ldLAoJCQkJCQkkb3B0aW9uID0gJCggb3B0aW9uICksCgkJCQkJCXBhcmVudCA9IG9wdGlvbi5wYXJlbnROb2RlLAoJCQkJCQl0ZXh0ID0gJG9wdGlvbi50ZXh0KCksCgkJCQkJCWFuY2hvciAgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAnYScgKSwKCQkJCQkJY2xhc3NlcyA9IFtdOwoKCQkJCQlhbmNob3Iuc2V0QXR0cmlidXRlKCAnaHJlZicsICcjJyApOwoJCQkJCWFuY2hvci5hcHBlbmRDaGlsZCggZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoIHRleHQgKSApOwoKCQkJCQkvLyBBcmUgd2UgaW5zaWRlIGFuIG9wdGdyb3VwPwoJCQkJCWlmICggcGFyZW50ICE9PSBzZWxlY3QgJiYgcGFyZW50Lm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09ICJvcHRncm91cCIgKSB7CgkJCQkJCXZhciBvcHRMYWJlbCA9IHBhcmVudC5nZXRBdHRyaWJ1dGUoICdsYWJlbCcgKTsKCQkJCQkJaWYgKCBvcHRMYWJlbCAhPT0gb3B0R3JvdXAgKSB7CgkJCQkJCQl2YXIgZGl2aWRlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICdsaScgKTsKCQkJCQkJCWRpdmlkZXIuc2V0QXR0cmlidXRlKCBkYXRhUm9sZUF0dHIsICdsaXN0LWRpdmlkZXInICk7CgkJCQkJCQlkaXZpZGVyLnNldEF0dHJpYnV0ZSggJ3JvbGUnLCAnb3B0aW9uJyApOwoJCQkJCQkJZGl2aWRlci5zZXRBdHRyaWJ1dGUoICd0YWJpbmRleCcsICctMScgKTsKCQkJCQkJCWRpdmlkZXIuYXBwZW5kQ2hpbGQoIGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKCBvcHRMYWJlbCApICk7CgkJCQkJCQlmcmFnbWVudC5hcHBlbmRDaGlsZCggZGl2aWRlciApOwoJCQkJCQkJb3B0R3JvdXAgPSBvcHRMYWJlbDsKCQkJCQkJfQoJCQkJCX0KCgkJCQkJaWYgKCBuZWVkUGxhY2Vob2xkZXIgJiYgKCAhb3B0aW9uLmdldEF0dHJpYnV0ZSggInZhbHVlIiApIHx8IHRleHQubGVuZ3RoID09PSAwIHx8ICRvcHRpb24uanFtRGF0YSggInBsYWNlaG9sZGVyIiApICkgKSB7CgkJCQkJCW5lZWRQbGFjZWhvbGRlciA9IGZhbHNlOwoJCQkJCQlpc1BsYWNlaG9sZGVySXRlbSA9IHRydWU7CgoJCQkJCQkvLyBJZiB3ZSBoYXZlIGlkZW50aWZpZWQgYSBwbGFjZWhvbGRlciwgbWFyayBpdCByZXRyb2FjdGl2ZWx5IGluIHRoZSBzZWxlY3QgYXMgd2VsbAoJCQkJCQlvcHRpb24uc2V0QXR0cmlidXRlKCBkYXRhUGxhY2Vob2xkZXJBdHRyLCB0cnVlICk7CgkJCQkJCWlmICggby5oaWRlUGxhY2Vob2xkZXJNZW51SXRlbXMgKSB7CgkJCQkJCQljbGFzc2VzLnB1c2goICJ1aS1zZWxlY3RtZW51LXBsYWNlaG9sZGVyIiApOwoJCQkJCQl9CgkJCQkJCWlmICghcGxhY2Vob2xkZXIpIHsKCQkJCQkJCXBsYWNlaG9sZGVyID0gc2VsZi5wbGFjZWhvbGRlciA9IHRleHQ7CgkJCQkJCX0KCQkJCQl9CgoJCQkJCXZhciBpdGVtID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnbGknKTsKCQkJCQlpZiAoIG9wdGlvbi5kaXNhYmxlZCApIHsKCQkJCQkJY2xhc3Nlcy5wdXNoKCAidWktZGlzYWJsZWQiICk7CgkJCQkJCWl0ZW0uc2V0QXR0cmlidXRlKCdhcmlhLWRpc2FibGVkJyx0cnVlKTsKCQkJCQl9CgkJCQkJaXRlbS5zZXRBdHRyaWJ1dGUoIGRhdGFJbmRleEF0dHIsaSApOwoJCQkJCWl0ZW0uc2V0QXR0cmlidXRlKCBkYXRhSWNvbkF0dHIsIGRhdGFJY29uICk7CgkJCQkJaWYgKCBpc1BsYWNlaG9sZGVySXRlbSApIHsKCQkJCQkJaXRlbS5zZXRBdHRyaWJ1dGUoIGRhdGFQbGFjZWhvbGRlckF0dHIsIHRydWUgKTsKCQkJCQl9CgkJCQkJaXRlbS5jbGFzc05hbWUgPSBjbGFzc2VzLmpvaW4oICIgIiApOwoJCQkJCWl0ZW0uc2V0QXR0cmlidXRlKCAncm9sZScsICdvcHRpb24nICk7CgkJCQkJYW5jaG9yLnNldEF0dHJpYnV0ZSggJ3RhYmluZGV4JywgJy0xJyApOwoJCQkJCWl0ZW0uYXBwZW5kQ2hpbGQoIGFuY2hvciApOwoJCQkJCWZyYWdtZW50LmFwcGVuZENoaWxkKCBpdGVtICk7CgkJCQl9CgoJCQkJc2VsZi5saXN0WzBdLmFwcGVuZENoaWxkKCBmcmFnbWVudCApOwoKCQkJCS8vIEhpZGUgaGVhZGVyIGlmIGl0J3Mgbm90IGEgbXVsdGlzZWxlY3QgYW5kIHRoZXJlJ3Mgbm8gcGxhY2Vob2xkZXIKCQkJCWlmICggIXRoaXMuaXNNdWx0aXBsZSAmJiAhcGxhY2Vob2xkZXIubGVuZ3RoICkgewoJCQkJCXRoaXMuaGVhZGVyLmhpZGUoKTsKCQkJCX0gZWxzZSB7CgkJCQkJdGhpcy5oZWFkZXJUaXRsZS50ZXh0KCB0aGlzLnBsYWNlaG9sZGVyICk7CgkJCQl9CgoJCQkJLy8gTm93IHBvcHVsYXRlZCwgY3JlYXRlIGxpc3R2aWV3CgkJCQlzZWxmLmxpc3QubGlzdHZpZXcoKTsKCQkJfSwKCgkJCV9idXR0b246IGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuICQoICI8YT4iLCB7CgkJCQkJImhyZWYiOiAiIyIsCgkJCQkJInJvbGUiOiAiYnV0dG9uIiwKCQkJCQkvLyBUT0RPIHZhbHVlIGlzIHVuZGVmaW5lZCBhdCBjcmVhdGlvbgoJCQkJCSJpZCI6IHRoaXMuYnV0dG9uSWQsCgkJCQkJImFyaWEtaGFzcG9wdXAiOiAidHJ1ZSIsCgoJCQkJCS8vIFRPRE8gdmFsdWUgaXMgdW5kZWZpbmVkIGF0IGNyZWF0aW9uCgkJCQkJImFyaWEtb3ducyI6IHRoaXMubWVudUlkCgkJCQl9KTsKCQkJfQoJCX0pOwoJfTsKCgkvLyBpc3N1ZSAjMzg5NCAtIGNvcmUgZG9lc24ndCB0cmlnZ2VyIGV2ZW50cyBvbiBkaXNhYmxlZCBkZWxlZ2F0ZXMKCSQoIGRvY3VtZW50ICkuYmluZCggInNlbGVjdG1lbnViZWZvcmVjcmVhdGUiLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJdmFyIHNlbGVjdG1lbnVXaWRnZXQgPSAkKCBldmVudC50YXJnZXQgKS5kYXRhKCAic2VsZWN0bWVudSIgKTsKCgkJaWYgKCAhc2VsZWN0bWVudVdpZGdldC5vcHRpb25zLm5hdGl2ZU1lbnUgJiYKCQkJCXNlbGVjdG1lbnVXaWRnZXQuZWxlbWVudC5wYXJlbnRzKCAiOmpxbURhdGEocm9sZT0ncG9wdXAnKSIgKS5sZW5ndGggPT09IDAgKSB7CgkJCWV4dGVuZFNlbGVjdCggc2VsZWN0bWVudVdpZGdldCApOwoJCX0KCX0pOwp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCgoJJC53aWRnZXQoICJtb2JpbGUuZml4ZWR0b29sYmFyIiwgJC5tb2JpbGUud2lkZ2V0LCB7CgkJb3B0aW9uczogewoJCQl2aXNpYmxlT25QYWdlU2hvdzogdHJ1ZSwKCQkJZGlzYWJsZVBhZ2Vab29tOiB0cnVlLAoJCQl0cmFuc2l0aW9uOiAic2xpZGUiLCAvL2NhbiBiZSBub25lLCBmYWRlLCBzbGlkZSAoc2xpZGUgbWFwcyB0byBzbGlkZXVwIG9yIHNsaWRlZG93bikKCQkJZnVsbHNjcmVlbjogZmFsc2UsCgkJCXRhcFRvZ2dsZTogdHJ1ZSwKCQkJdGFwVG9nZ2xlQmxhY2tsaXN0OiAiYSwgYnV0dG9uLCBpbnB1dCwgc2VsZWN0LCB0ZXh0YXJlYSwgLnVpLWhlYWRlci1maXhlZCwgLnVpLWZvb3Rlci1maXhlZCwgLnVpLXBvcHVwIiwKCQkJaGlkZUR1cmluZ0ZvY3VzOiAiaW5wdXQsIHRleHRhcmVhLCBzZWxlY3QiLAoJCQl1cGRhdGVQYWdlUGFkZGluZzogdHJ1ZSwKCQkJdHJhY2tQZXJzaXN0ZW50VG9vbGJhcnM6IHRydWUsCgoJCQkvLyBCcm93c2VyIGRldGVjdGlvbiEgV2VlZWUsIGhlcmUgd2UgZ28uLi4KCQkJLy8gVW5mb3J0dW5hdGVseSwgcG9zaXRpb246Zml4ZWQgaXMgY29zdGx5LCBub3QgdG8gbWVudGlvbiBwcm9iYWJseSBpbXBvc3NpYmxlLCB0byBmZWF0dXJlLWRldGVjdCBhY2N1cmF0ZWx5LgoJCQkvLyBTb21lIHRlc3RzIGV4aXN0LCBidXQgdGhleSBjdXJyZW50bHkgcmV0dXJuIGZhbHNlIHJlc3VsdHMgaW4gY3JpdGljYWwgZGV2aWNlcyBhbmQgYnJvd3NlcnMsIHdoaWNoIGNvdWxkIGxlYWQgdG8gYSBicm9rZW4gZXhwZXJpZW5jZS4KCQkJLy8gVGVzdGluZyBmaXhlZCBwb3NpdGlvbmluZyBpcyBhbHNvIHByZXR0eSBvYnRydXNpdmUgdG8gcGFnZSBsb2FkLCByZXF1aXJpbmcgaW5qZWN0ZWQgZWxlbWVudHMgYW5kIHNjcm9sbGluZyB0aGUgd2luZG93CgkJCS8vIFRoZSBmb2xsb3dpbmcgZnVuY3Rpb24gc2VydmVzIHRvIHJ1bGUgb3V0IHNvbWUgcG9wdWxhciBicm93c2VycyB3aXRoIGtub3duIGZpeGVkLXBvc2l0aW9uaW5nIGlzc3VlcwoJCQkvLyBUaGlzIGlzIGEgcGx1Z2luIG9wdGlvbiBsaWtlIGFueSBvdGhlciwgc28gZmVlbCBmcmVlIHRvIGltcHJvdmUgb3Igb3ZlcndyaXRlIGl0CgkJCXN1cHBvcnRCbGFja2xpc3Q6IGZ1bmN0aW9uKCkgewoJCQkJdmFyIHcgPSB3aW5kb3csCgkJCQkJdWEgPSBuYXZpZ2F0b3IudXNlckFnZW50LAoJCQkJCXBsYXRmb3JtID0gbmF2aWdhdG9yLnBsYXRmb3JtLAoJCQkJCS8vIFJlbmRlcmluZyBlbmdpbmUgaXMgV2Via2l0LCBhbmQgY2FwdHVyZSBtYWpvciB2ZXJzaW9uCgkJCQkJd2ttYXRjaCA9IHVhLm1hdGNoKCAvQXBwbGVXZWJLaXRcLyhbMC05XSspLyApLAoJCQkJCXdrdmVyc2lvbiA9ICEhd2ttYXRjaCAmJiB3a21hdGNoWyAxIF0sCgkJCQkJZmZtYXRjaCA9IHVhLm1hdGNoKCAvRmVubmVjXC8oWzAtOV0rKS8gKSwKCQkJCQlmZnZlcnNpb24gPSAhIWZmbWF0Y2ggJiYgZmZtYXRjaFsgMSBdLAoJCQkJCW9wZXJhbW1vYmlsZW1hdGNoID0gdWEubWF0Y2goIC9PcGVyYSBNb2JpXC8oWzAtOV0rKS8gKSwKCQkJCQlvbXZlcnNpb24gPSAhIW9wZXJhbW1vYmlsZW1hdGNoICYmIG9wZXJhbW1vYmlsZW1hdGNoWyAxIF07CgoJCQkJaWYoCgkJCQkJLy8gaU9TIDQuMyBhbmQgb2xkZXIgOiBQbGF0Zm9ybSBpcyBpUGhvbmUvUGFkL1RvdWNoIGFuZCBXZWJraXQgdmVyc2lvbiBpcyBsZXNzIHRoYW4gNTM0IChpb3M1KQoJCQkJCSggKCBwbGF0Zm9ybS5pbmRleE9mKCAiaVBob25lIiApID4gLTEgfHwgcGxhdGZvcm0uaW5kZXhPZiggImlQYWQiICkgPiAtMSAgfHwgcGxhdGZvcm0uaW5kZXhPZiggImlQb2QiICkgPiAtMSApICYmIHdrdmVyc2lvbiAmJiB3a3ZlcnNpb24gPCA1MzQgKSB8fAoJCQkJCS8vIE9wZXJhIE1pbmkKCQkJCQkoIHcub3BlcmFtaW5pICYmICh7fSkudG9TdHJpbmcuY2FsbCggdy5vcGVyYW1pbmkgKSA9PT0gIltvYmplY3QgT3BlcmFNaW5pXSIgKSB8fAoJCQkJCSggb3BlcmFtbW9iaWxlbWF0Y2ggJiYgb212ZXJzaW9uIDwgNzQ1OCApCXx8CgkJCQkJLy9BbmRyb2lkIGx0ZSAyLjE6IFBsYXRmb3JtIGlzIEFuZHJvaWQgYW5kIFdlYmtpdCB2ZXJzaW9uIGlzIGxlc3MgdGhhbiA1MzMgKEFuZHJvaWQgMi4yKQoJCQkJCSggdWEuaW5kZXhPZiggIkFuZHJvaWQiICkgPiAtMSAmJiB3a3ZlcnNpb24gJiYgd2t2ZXJzaW9uIDwgNTMzICkgfHwKCQkJCQkvLyBGaXJlZm94IE1vYmlsZSBiZWZvcmUgNi4wIC0KCQkJCQkoIGZmdmVyc2lvbiAmJiBmZnZlcnNpb24gPCA2ICkgfHwKCQkJCQkvLyBXZWJPUyBsZXNzIHRoYW4gMwoJCQkJCSggInBhbG1HZXRSZXNvdXJjZSIgaW4gd2luZG93ICYmIHdrdmVyc2lvbiAmJiB3a3ZlcnNpb24gPCA1MzQgKQl8fAoJCQkJCS8vIE1lZUdvCgkJCQkJKCB1YS5pbmRleE9mKCAiTWVlR28iICkgPiAtMSAmJiB1YS5pbmRleE9mKCAiTm9raWFCcm93c2VyLzguNS4wIiApID4gLTEgKSApIHsKCQkJCQlyZXR1cm4gdHJ1ZTsKCQkJCX0KCgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0sCgkJCWluaXRTZWxlY3RvcjogIjpqcW1EYXRhKHBvc2l0aW9uPSdmaXhlZCcpIgoJCX0sCgoJCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoKCQkJdmFyIHNlbGYgPSB0aGlzLAoJCQkJbyA9IHNlbGYub3B0aW9ucywKCQkJCSRlbCA9IHNlbGYuZWxlbWVudCwKCQkJCXRidHlwZSA9ICRlbC5pcyggIjpqcW1EYXRhKHJvbGU9J2hlYWRlcicpIiApID8gImhlYWRlciIgOiAiZm9vdGVyIiwKCQkJCSRwYWdlID0gJGVsLmNsb3Nlc3QoICIudWktcGFnZSIgKTsKCgkJCS8vIEZlYXR1cmUgZGV0ZWN0aW5nIHN1cHBvcnQgZm9yCgkJCWlmICggby5zdXBwb3J0QmxhY2tsaXN0KCkgKSB7CgkJCQlzZWxmLmRlc3Ryb3koKTsKCQkJCXJldHVybjsKCQkJfQoKCQkJJGVsLmFkZENsYXNzKCAidWktIisgdGJ0eXBlICsiLWZpeGVkIiApOwoKCQkJLy8gImZ1bGxzY3JlZW4iIG92ZXJsYXkgcG9zaXRpb25pbmcKCQkJaWYgKCBvLmZ1bGxzY3JlZW4gKSB7CgkJCQkkZWwuYWRkQ2xhc3MoICJ1aS0iKyB0YnR5cGUgKyItZnVsbHNjcmVlbiIgKTsKCQkJCSRwYWdlLmFkZENsYXNzKCAidWktcGFnZS0iICsgdGJ0eXBlICsgIi1mdWxsc2NyZWVuIiApOwoJCQl9CgkJCS8vIElmIG5vdCBmdWxsc2NyZWVuLCBhZGQgY2xhc3MgdG8gcGFnZSB0byBzZXQgdG9wIG9yIGJvdHRvbSBwYWRkaW5nCgkJCWVsc2V7CgkJCQkkcGFnZS5hZGRDbGFzcyggInVpLXBhZ2UtIiArIHRidHlwZSArICItZml4ZWQiICk7CgkJCX0KCgkJCXNlbGYuX2FkZFRyYW5zaXRpb25DbGFzcygpOwoJCQlzZWxmLl9iaW5kUGFnZUV2ZW50cygpOwoJCQlzZWxmLl9iaW5kVG9nZ2xlSGFuZGxlcnMoKTsKCQl9LAoKCQlfYWRkVHJhbnNpdGlvbkNsYXNzOiBmdW5jdGlvbigpIHsKCQkJdmFyIHRjbGFzcyA9IHRoaXMub3B0aW9ucy50cmFuc2l0aW9uOwoKCQkJaWYgKCB0Y2xhc3MgJiYgdGNsYXNzICE9PSAibm9uZSIgKSB7CgkJCQkvLyB1c2UgYXBwcm9wcmlhdGUgc2xpZGUgZm9yIGhlYWRlciBvciBmb290ZXIKCQkJCWlmICggdGNsYXNzID09PSAic2xpZGUiICkgewoJCQkJCXRjbGFzcyA9IHRoaXMuZWxlbWVudC5pcyggIi51aS1oZWFkZXIiICkgPyAic2xpZGVkb3duIiA6ICJzbGlkZXVwIjsKCQkJCX0KCgkJCQl0aGlzLmVsZW1lbnQuYWRkQ2xhc3MoIHRjbGFzcyApOwoJCQl9CgkJfSwKCgkJX2JpbmRQYWdlRXZlbnRzOiBmdW5jdGlvbigpIHsKCQkJdmFyIHNlbGYgPSB0aGlzLAoJCQkJbyA9IHNlbGYub3B0aW9ucywKCQkJCSRlbCA9IHNlbGYuZWxlbWVudDsKCgkJCS8vcGFnZSBldmVudCBiaW5kaW5ncwoJCQkvLyBGaXhlZCB0b29sYmFycyByZXF1aXJlIHBhZ2Ugem9vbSB0byBiZSBkaXNhYmxlZCwgb3RoZXJ3aXNlIHVzYWJpbGl0eSBpc3N1ZXMgY3JvcCB1cAoJCQkvLyBUaGlzIG1ldGhvZCBpcyBtZWFudCB0byBkaXNhYmxlIHpvb20gd2hpbGUgYSBmaXhlZC1wb3NpdGlvbmVkIHRvb2xiYXIgcGFnZSBpcyB2aXNpYmxlCgkJCSRlbC5jbG9zZXN0KCAiLnVpLXBhZ2UiICkKCQkJCS5iaW5kKCAicGFnZWJlZm9yZXNob3ciLCBmdW5jdGlvbigpIHsKCQkJCQlpZiAoIG8uZGlzYWJsZVBhZ2Vab29tICkgewoJCQkJCQkkLm1vYmlsZS56b29tLmRpc2FibGUoIHRydWUgKTsKCQkJCQl9CgkJCQkJaWYgKCAhby52aXNpYmxlT25QYWdlU2hvdyApIHsKCQkJCQkJc2VsZi5oaWRlKCB0cnVlICk7CgkJCQkJfQoJCQkJfSApCgkJCQkuYmluZCggIndlYmtpdEFuaW1hdGlvblN0YXJ0IGFuaW1hdGlvbnN0YXJ0IHVwZGF0ZWxheW91dCIsIGZ1bmN0aW9uKCkgewoJCQkJCXZhciB0aGlzUGFnZSA9IHRoaXM7CgkJCQkJaWYgKCBvLnVwZGF0ZVBhZ2VQYWRkaW5nICkgewoJCQkJCQlzZWxmLnVwZGF0ZVBhZ2VQYWRkaW5nKCB0aGlzUGFnZSApOwoJCQkJCX0KCQkJCX0pCgkJCQkuYmluZCggInBhZ2VzaG93IiwgZnVuY3Rpb24oKSB7CgkJCQkJdmFyIHRoaXNQYWdlID0gdGhpczsKCQkJCQlzZWxmLnVwZGF0ZVBhZ2VQYWRkaW5nKCB0aGlzUGFnZSApOwoJCQkJCWlmICggby51cGRhdGVQYWdlUGFkZGluZyApIHsKCQkJCQkJJCggd2luZG93ICkuYmluZCggInRocm90dGxlZHJlc2l6ZS4iICsgc2VsZi53aWRnZXROYW1lLCBmdW5jdGlvbigpIHsKCQkJCQkJCXNlbGYudXBkYXRlUGFnZVBhZGRpbmcoIHRoaXNQYWdlICk7CgkJCQkJCX0pOwoJCQkJCX0KCQkJCX0pCgkJCQkuYmluZCggInBhZ2ViZWZvcmVoaWRlIiwgZnVuY3Rpb24oIGUsIHVpICkgewoJCQkJCWlmICggby5kaXNhYmxlUGFnZVpvb20gKSB7CgkJCQkJCSQubW9iaWxlLnpvb20uZW5hYmxlKCB0cnVlICk7CgkJCQkJfQoJCQkJCWlmICggby51cGRhdGVQYWdlUGFkZGluZyApIHsKCQkJCQkJJCggd2luZG93ICkudW5iaW5kKCAidGhyb3R0bGVkcmVzaXplLiIgKyBzZWxmLndpZGdldE5hbWUgKTsKCQkJCQl9CgoJCQkJCWlmICggby50cmFja1BlcnNpc3RlbnRUb29sYmFycyApIHsKCQkJCQkJdmFyIHRoaXNGb290ZXIgPSAkKCAiLnVpLWZvb3Rlci1maXhlZDpqcW1EYXRhKGlkKSIsIHRoaXMgKSwKCQkJCQkJCXRoaXNIZWFkZXIgPSAkKCAiLnVpLWhlYWRlci1maXhlZDpqcW1EYXRhKGlkKSIsIHRoaXMgKSwKCQkJCQkJCW5leHRGb290ZXIgPSB0aGlzRm9vdGVyLmxlbmd0aCAmJiB1aS5uZXh0UGFnZSAmJiAkKCAiLnVpLWZvb3Rlci1maXhlZDpqcW1EYXRhKGlkPSciICsgdGhpc0Zvb3Rlci5qcW1EYXRhKCAiaWQiICkgKyAiJykiLCB1aS5uZXh0UGFnZSApIHx8ICQoKSwKCQkJCQkJCW5leHRIZWFkZXIgPSB0aGlzSGVhZGVyLmxlbmd0aCAmJiB1aS5uZXh0UGFnZSAmJiAkKCAiLnVpLWhlYWRlci1maXhlZDpqcW1EYXRhKGlkPSciICsgdGhpc0hlYWRlci5qcW1EYXRhKCAiaWQiICkgKyAiJykiLCB1aS5uZXh0UGFnZSApIHx8ICQoKTsKCgkJCQkJCQlpZiAoIG5leHRGb290ZXIubGVuZ3RoIHx8IG5leHRIZWFkZXIubGVuZ3RoICkgewoKCQkJCQkJCQluZXh0Rm9vdGVyLmFkZCggbmV4dEhlYWRlciApLmFwcGVuZFRvKCAkLm1vYmlsZS5wYWdlQ29udGFpbmVyICk7CgoJCQkJCQkJCXVpLm5leHRQYWdlLm9uZSggInBhZ2VzaG93IiwgZnVuY3Rpb24oKSB7CgkJCQkJCQkJCW5leHRGb290ZXIuYWRkKCBuZXh0SGVhZGVyICkuYXBwZW5kVG8oIHRoaXMgKTsKCQkJCQkJCQl9KTsKCQkJCQkJCX0KCQkJCQl9CgkJCQl9KTsKCQl9LAoKCQlfdmlzaWJsZTogdHJ1ZSwKCgkJLy8gVGhpcyB3aWxsIHNldCB0aGUgY29udGVudCBlbGVtZW50J3MgdG9wIG9yIGJvdHRvbSBwYWRkaW5nIGVxdWFsIHRvIHRoZSB0b29sYmFyJ3MgaGVpZ2h0CgkJdXBkYXRlUGFnZVBhZGRpbmc6IGZ1bmN0aW9uKCB0YlBhZ2UgKSB7CgkJCXZhciAkZWwgPSB0aGlzLmVsZW1lbnQsCgkJCQloZWFkZXIgPSAkZWwuaXMoICIudWktaGVhZGVyIiApOwoKCQkJLy8gVGhpcyBiZWhhdmlvciBvbmx5IGFwcGxpZXMgdG8gImZpeGVkIiwgbm90ICJmdWxsc2NyZWVuIgoJCQlpZiAoIHRoaXMub3B0aW9ucy5mdWxsc2NyZWVuICkgeyByZXR1cm47IH0KCgkJCXRiUGFnZSA9IHRiUGFnZSB8fCAkZWwuY2xvc2VzdCggIi51aS1wYWdlIiApOwoJCQkkKCB0YlBhZ2UgKS5jc3MoICJwYWRkaW5nLSIgKyAoIGhlYWRlciA/ICJ0b3AiIDogImJvdHRvbSIgKSwgJGVsLm91dGVySGVpZ2h0KCkgKTsKCQl9LAoKCQlfdXNlVHJhbnNpdGlvbjogZnVuY3Rpb24oIG5vdHJhbnNpdGlvbiApIHsKCQkJdmFyICR3aW4gPSAkKCB3aW5kb3cgKSwKCQkJCSRlbCA9IHRoaXMuZWxlbWVudCwKCQkJCXNjcm9sbCA9ICR3aW4uc2Nyb2xsVG9wKCksCgkJCQllbEhlaWdodCA9ICRlbC5oZWlnaHQoKSwKCQkJCXBIZWlnaHQgPSAkZWwuY2xvc2VzdCggIi51aS1wYWdlIiApLmhlaWdodCgpLAoJCQkJdmlld3BvcnRIZWlnaHQgPSAkLm1vYmlsZS5nZXRTY3JlZW5IZWlnaHQoKSwKCQkJCXRidHlwZSA9ICRlbC5pcyggIjpqcW1EYXRhKHJvbGU9J2hlYWRlcicpIiApID8gImhlYWRlciIgOiAiZm9vdGVyIjsKCgkJCXJldHVybiAhbm90cmFuc2l0aW9uICYmCgkJCQkoIHRoaXMub3B0aW9ucy50cmFuc2l0aW9uICYmIHRoaXMub3B0aW9ucy50cmFuc2l0aW9uICE9PSAibm9uZSIgJiYKCQkJCSgKCQkJCQkoIHRidHlwZSA9PT0gImhlYWRlciIgJiYgIXRoaXMub3B0aW9ucy5mdWxsc2NyZWVuICYmIHNjcm9sbCA+IGVsSGVpZ2h0ICkgfHwKCQkJCQkoIHRidHlwZSA9PT0gImZvb3RlciIgJiYgIXRoaXMub3B0aW9ucy5mdWxsc2NyZWVuICYmIHNjcm9sbCArIHZpZXdwb3J0SGVpZ2h0IDwgcEhlaWdodCAtIGVsSGVpZ2h0ICkKCQkJCSkgfHwgdGhpcy5vcHRpb25zLmZ1bGxzY3JlZW4KCQkJCSk7CgkJfSwKCgkJc2hvdzogZnVuY3Rpb24oIG5vdHJhbnNpdGlvbiApIHsKCQkJdmFyIGhpZGVDbGFzcyA9ICJ1aS1maXhlZC1oaWRkZW4iLAoJCQkJJGVsID0gdGhpcy5lbGVtZW50OwoKCQkJaWYgKCB0aGlzLl91c2VUcmFuc2l0aW9uKCBub3RyYW5zaXRpb24gKSApIHsKCQkJCSRlbAoJCQkJCS5yZW1vdmVDbGFzcyggIm91dCAiICsgaGlkZUNsYXNzICkKCQkJCQkuYWRkQ2xhc3MoICJpbiIgKTsKCQkJfQoJCQllbHNlIHsKCQkJCSRlbC5yZW1vdmVDbGFzcyggaGlkZUNsYXNzICk7CgkJCX0KCQkJdGhpcy5fdmlzaWJsZSA9IHRydWU7CgkJfSwKCgkJaGlkZTogZnVuY3Rpb24oIG5vdHJhbnNpdGlvbiApIHsKCQkJdmFyIGhpZGVDbGFzcyA9ICJ1aS1maXhlZC1oaWRkZW4iLAoJCQkJJGVsID0gdGhpcy5lbGVtZW50LAoJCQkJLy8gaWYgaXQncyBhIHNsaWRlIHRyYW5zaXRpb24sIG91ciBuZXcgdHJhbnNpdGlvbnMgbmVlZCB0aGUgcmV2ZXJzZSBjbGFzcyBhcyB3ZWxsIHRvIHNsaWRlIG91dHdhcmQKCQkJCW91dGNsYXNzID0gIm91dCIgKyAoIHRoaXMub3B0aW9ucy50cmFuc2l0aW9uID09PSAic2xpZGUiID8gIiByZXZlcnNlIiA6ICIiICk7CgoJCQlpZiggdGhpcy5fdXNlVHJhbnNpdGlvbiggbm90cmFuc2l0aW9uICkgKSB7CgkJCQkkZWwKCQkJCQkuYWRkQ2xhc3MoIG91dGNsYXNzICkKCQkJCQkucmVtb3ZlQ2xhc3MoICJpbiIgKQoJCQkJCS5hbmltYXRpb25Db21wbGV0ZShmdW5jdGlvbigpIHsKCQkJCQkJJGVsLmFkZENsYXNzKCBoaWRlQ2xhc3MgKS5yZW1vdmVDbGFzcyggb3V0Y2xhc3MgKTsKCQkJCQl9KTsKCQkJfQoJCQllbHNlIHsKCQkJCSRlbC5hZGRDbGFzcyggaGlkZUNsYXNzICkucmVtb3ZlQ2xhc3MoIG91dGNsYXNzICk7CgkJCX0KCQkJdGhpcy5fdmlzaWJsZSA9IGZhbHNlOwoJCX0sCgoJCXRvZ2dsZTogZnVuY3Rpb24oKSB7CgkJCXRoaXNbIHRoaXMuX3Zpc2libGUgPyAiaGlkZSIgOiAic2hvdyIgXSgpOwoJCX0sCgoJCV9iaW5kVG9nZ2xlSGFuZGxlcnM6IGZ1bmN0aW9uKCkgewoJCQl2YXIgc2VsZiA9IHRoaXMsCgkJCQlvID0gc2VsZi5vcHRpb25zLAoJCQkJJGVsID0gc2VsZi5lbGVtZW50OwoKCQkJLy8gdGFwIHRvZ2dsZQoJCQkkZWwuY2xvc2VzdCggIi51aS1wYWdlIiApCgkJCQkuYmluZCggInZjbGljayIsIGZ1bmN0aW9uKCBlICkgewoJCQkJCWlmICggby50YXBUb2dnbGUgJiYgISQoIGUudGFyZ2V0ICkuY2xvc2VzdCggby50YXBUb2dnbGVCbGFja2xpc3QgKS5sZW5ndGggKSB7CgkJCQkJCXNlbGYudG9nZ2xlKCk7CgkJCQkJfQoJCQkJfSkKCQkJCS5iaW5kKCAiZm9jdXNpbiBmb2N1c291dCIsIGZ1bmN0aW9uKCBlICkgewoJCQkJCWlmICggc2NyZWVuLndpZHRoIDwgNTAwICYmICQoIGUudGFyZ2V0ICkuaXMoIG8uaGlkZUR1cmluZ0ZvY3VzICkgJiYgISQoIGUudGFyZ2V0ICkuY2xvc2VzdCggIi51aS1oZWFkZXItZml4ZWQsIC51aS1mb290ZXItZml4ZWQiICkubGVuZ3RoICkgewoJCQkJCQlzZWxmWyAoIGUudHlwZSA9PT0gImZvY3VzaW4iICYmIHNlbGYuX3Zpc2libGUgKSA/ICJoaWRlIiA6ICJzaG93IiBdKCk7CgkJCQkJfQoJCQkJfSk7CgkJfSwKCgkJZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJCXRoaXMuZWxlbWVudC5yZW1vdmVDbGFzcyggInVpLWhlYWRlci1maXhlZCB1aS1mb290ZXItZml4ZWQgdWktaGVhZGVyLWZ1bGxzY3JlZW4gdWktZm9vdGVyLWZ1bGxzY3JlZW4gaW4gb3V0IGZhZGUgc2xpZGVkb3duIHNsaWRldXAgdWktZml4ZWQtaGlkZGVuIiApOwoJCQl0aGlzLmVsZW1lbnQuY2xvc2VzdCggIi51aS1wYWdlIiApLnJlbW92ZUNsYXNzKCAidWktcGFnZS1oZWFkZXItZml4ZWQgdWktcGFnZS1mb290ZXItZml4ZWQgdWktcGFnZS1oZWFkZXItZnVsbHNjcmVlbiB1aS1wYWdlLWZvb3Rlci1mdWxsc2NyZWVuIiApOwoJCX0KCgl9KTsKCgkvL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKCSQoIGRvY3VtZW50ICkKCQkuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKSB7CgoJCQkvLyBERVBSRUNBVEVEIGluIDEuMTogc3VwcG9ydCBmb3IgZGF0YS1mdWxsc2NyZWVuPXRydWV8ZmFsc2Ugb24gdGhlIHBhZ2UgZWxlbWVudC4KCQkJLy8gVGhpcyBsaW5lIGVuc3VyZXMgaXQgc3RpbGwgd29ya3MsIGJ1dCB3ZSByZWNvbW1lbmQgbW92aW5nIHRoZSBhdHRyaWJ1dGUgdG8gdGhlIHRvb2xiYXJzIHRoZW1zZWx2ZXMuCgkJCWlmICggJCggZS50YXJnZXQgKS5qcW1EYXRhKCAiZnVsbHNjcmVlbiIgKSApIHsKCQkJCSQoICQubW9iaWxlLmZpeGVkdG9vbGJhci5wcm90b3R5cGUub3B0aW9ucy5pbml0U2VsZWN0b3IsIGUudGFyZ2V0ICkubm90KCAiOmpxbURhdGEoZnVsbHNjcmVlbikiICkuanFtRGF0YSggImZ1bGxzY3JlZW4iLCB0cnVlICk7CgkJCX0KCgkJCSQubW9iaWxlLmZpeGVkdG9vbGJhci5wcm90b3R5cGUuZW5oYW5jZVdpdGhpbiggZS50YXJnZXQgKTsKCQl9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgd2luZG93ICkgewoKCS8vIFRoaXMgZml4IGFkZHJlc3NlcyBhbiBpT1MgYnVnLCBzbyByZXR1cm4gZWFybHkgaWYgdGhlIFVBIGNsYWltcyBpdCdzIHNvbWV0aGluZyBlbHNlLgoJaWYgKCAhKC9pUGhvbmV8aVBhZHxpUG9kLy50ZXN0KCBuYXZpZ2F0b3IucGxhdGZvcm0gKSAmJiBuYXZpZ2F0b3IudXNlckFnZW50LmluZGV4T2YoICJBcHBsZVdlYktpdCIgKSA+IC0xICkgKSB7CgkJcmV0dXJuOwoJfQoKICB2YXIgem9vbSA9ICQubW9iaWxlLnpvb20sCgkJZXZ0LCB4LCB5LCB6LCBhaWc7CgogIGZ1bmN0aW9uIGNoZWNrVGlsdCggZSApIHsKCQlldnQgPSBlLm9yaWdpbmFsRXZlbnQ7CgkJYWlnID0gZXZ0LmFjY2VsZXJhdGlvbkluY2x1ZGluZ0dyYXZpdHk7CgoJCXggPSBNYXRoLmFicyggYWlnLnggKTsKCQl5ID0gTWF0aC5hYnMoIGFpZy55ICk7CgkJeiA9IE1hdGguYWJzKCBhaWcueiApOwoKCQkvLyBJZiBwb3J0cmFpdCBvcmllbnRhdGlvbiBhbmQgaW4gb25lIG9mIHRoZSBkYW5nZXIgem9uZXMKICAgIGlmICggIXdpbmRvdy5vcmllbnRhdGlvbiAmJiAoIHggPiA3IHx8ICggKCB6ID4gNiAmJiB5IDwgOCB8fCB6IDwgOCAmJiB5ID4gNiApICYmIHggPiA1ICkgKSApIHsKCQkJaWYgKCB6b29tLmVuYWJsZWQgKSB7CgkJCQl6b29tLmRpc2FibGUoKTsKCQkJfQogICAgfQllbHNlIGlmICggIXpvb20uZW5hYmxlZCApIHsKCQkJem9vbS5lbmFibGUoKTsKICAgIH0KICB9CgogICQoIHdpbmRvdyApCgkJLmJpbmQoICJvcmllbnRhdGlvbmNoYW5nZS5pb3NvcmllbnRhdGlvbmZpeCIsIHpvb20uZW5hYmxlICkKCQkuYmluZCggImRldmljZW1vdGlvbi5pb3NvcmllbnRhdGlvbmZpeCIsIGNoZWNrVGlsdCApOwoKfSggalF1ZXJ5LCB0aGlzICkpOwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCXZhcgkkaHRtbCA9ICQoICJodG1sIiApLAoJCQkkaGVhZCA9ICQoICJoZWFkIiApLAoJCQkkd2luZG93ID0gJCggd2luZG93ICk7CgoJLy9yZW1vdmUgaW5pdGlhbCBidWlsZCBjbGFzcyAob25seSBwcmVzZW50IG9uIGZpcnN0IHBhZ2VzaG93KQoJZnVuY3Rpb24gaGlkZVJlbmRlcmluZ0NsYXNzKCkgewoJCSRodG1sLnJlbW92ZUNsYXNzKCAidWktbW9iaWxlLXJlbmRlcmluZyIgKTsKCX0KCgkvLyB0cmlnZ2VyIG1vYmlsZWluaXQgZXZlbnQgLSB1c2VmdWwgaG9vayBmb3IgY29uZmlndXJpbmcgJC5tb2JpbGUgc2V0dGluZ3MgYmVmb3JlIHRoZXkncmUgdXNlZAoJJCggd2luZG93LmRvY3VtZW50ICkudHJpZ2dlciggIm1vYmlsZWluaXQiICk7CgoJLy8gc3VwcG9ydCBjb25kaXRpb25zCgkvLyBpZiBkZXZpY2Ugc3VwcG9ydCBjb25kaXRpb24ocykgYXJlbid0IG1ldCwgbGVhdmUgdGhpbmdzIGFzIHRoZXkgYXJlIC0+IGEgYmFzaWMsIHVzYWJsZSBleHBlcmllbmNlLAoJLy8gb3RoZXJ3aXNlLCBwcm9jZWVkIHdpdGggdGhlIGVuaGFuY2VtZW50cwoJaWYgKCAhJC5tb2JpbGUuZ3JhZGVBKCkgKSB7CgkJcmV0dXJuOwoJfQoKCS8vIG92ZXJyaWRlIGFqYXhFbmFibGVkIG9uIHBsYXRmb3JtcyB0aGF0IGhhdmUga25vd24gY29uZmxpY3RzIHdpdGggaGFzaCBoaXN0b3J5IHVwZGF0ZXMKCS8vIG9yIGdlbmVyYWxseSB3b3JrIGJldHRlciBicm93c2luZyBpbiByZWd1bGFyIGh0dHAgZm9yIGZ1bGwgcGFnZSByZWZyZXNoZXMgKEJCNSwgT3BlcmEgTWluaSkKCWlmICggJC5tb2JpbGUuYWpheEJsYWNrbGlzdCApIHsKCQkkLm1vYmlsZS5hamF4RW5hYmxlZCA9IGZhbHNlOwoJfQoKCS8vIEFkZCBtb2JpbGUsIGluaXRpYWwgbG9hZCAicmVuZGVyaW5nIiBjbGFzc2VzIHRvIGRvY0VsCgkkaHRtbC5hZGRDbGFzcyggInVpLW1vYmlsZSB1aS1tb2JpbGUtcmVuZGVyaW5nIiApOwoKCS8vIFRoaXMgaXMgYSBmYWxsYmFjay4gSWYgYW55dGhpbmcgZ29lcyB3cm9uZyAoSlMgZXJyb3JzLCBldGMpLCBvciBldmVudHMgZG9uJ3QgZmlyZSwKCS8vIHRoaXMgZW5zdXJlcyB0aGUgcmVuZGVyaW5nIGNsYXNzIGlzIHJlbW92ZWQgYWZ0ZXIgNSBzZWNvbmRzLCBzbyBjb250ZW50IGlzIHZpc2libGUgYW5kIGFjY2Vzc2libGUKCXNldFRpbWVvdXQoIGhpZGVSZW5kZXJpbmdDbGFzcywgNTAwMCApOwoKCSQuZXh0ZW5kKCAkLm1vYmlsZSwgewoJCS8vIGZpbmQgYW5kIGVuaGFuY2UgdGhlIHBhZ2VzIGluIHRoZSBkb20gYW5kIHRyYW5zaXRpb24gdG8gdGhlIGZpcnN0IHBhZ2UuCgkJaW5pdGlhbGl6ZVBhZ2U6IGZ1bmN0aW9uKCkgewoJCQkvLyBmaW5kIHByZXNlbnQgcGFnZXMKCQkJdmFyICRwYWdlcyA9ICQoICI6anFtRGF0YShyb2xlPSdwYWdlJyksIDpqcW1EYXRhKHJvbGU9J2RpYWxvZycpIiApLAoJCQkJaGFzaCA9ICQubW9iaWxlLnBhdGgucGFyc2VMb2NhdGlvbigpLmhhc2gucmVwbGFjZSgiIyIsICIiKSwKCQkJCWhhc2hQYWdlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoIGhhc2ggKTsKCgkJCS8vIGlmIG5vIHBhZ2VzIGFyZSBmb3VuZCwgY3JlYXRlIG9uZSB3aXRoIGJvZHkncyBpbm5lciBodG1sCgkJCWlmICggISRwYWdlcy5sZW5ndGggKSB7CgkJCQkkcGFnZXMgPSAkKCAiYm9keSIgKS53cmFwSW5uZXIoICI8ZGl2IGRhdGEtIiArICQubW9iaWxlLm5zICsgInJvbGU9J3BhZ2UnPjwvZGl2PiIgKS5jaGlsZHJlbiggMCApOwoJCQl9CgoJCQkvLyBhZGQgZGlhbG9ncywgc2V0IGRhdGEtdXJsIGF0dHJzCgkJCSRwYWdlcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJdmFyICR0aGlzID0gJCggdGhpcyApOwoKCQkJCS8vIHVubGVzcyB0aGUgZGF0YSB1cmwgaXMgYWxyZWFkeSBzZXQgc2V0IGl0IHRvIHRoZSBwYXRobmFtZQoJCQkJaWYgKCAhJHRoaXMuanFtRGF0YSggInVybCIgKSApIHsKCQkJCQkkdGhpcy5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidXJsIiwgJHRoaXMuYXR0ciggImlkIiApIHx8IGxvY2F0aW9uLnBhdGhuYW1lICsgbG9jYXRpb24uc2VhcmNoICk7CgkJCQl9CgkJCX0pOwoKCQkJLy8gZGVmaW5lIGZpcnN0IHBhZ2UgaW4gZG9tIGNhc2Ugb25lIGJhY2tzIG91dCB0byB0aGUgZGlyZWN0b3J5IHJvb3QgKG5vdCBhbHdheXMgdGhlIGZpcnN0IHBhZ2UgdmlzaXRlZCwgYnV0IGRlZmluZWQgYXMgZmFsbGJhY2spCgkJCSQubW9iaWxlLmZpcnN0UGFnZSA9ICRwYWdlcy5maXJzdCgpOwoKCQkJLy8gZGVmaW5lIHBhZ2UgY29udGFpbmVyCgkJCSQubW9iaWxlLnBhZ2VDb250YWluZXIgPSAkcGFnZXMuZmlyc3QoKS5wYXJlbnQoKS5hZGRDbGFzcyggInVpLW1vYmlsZS12aWV3cG9ydCIgKTsKCgkJCS8vIGFsZXJ0IGxpc3RlbmVycyB0aGF0IHRoZSBwYWdlY29udGFpbmVyIGhhcyBiZWVuIGRldGVybWluZWQgZm9yIGJpbmRpbmcKCQkJLy8gdG8gZXZlbnRzIHRyaWdnZXJlZCBvbiBpdAoJCQkkd2luZG93LnRyaWdnZXIoICJwYWdlY29udGFpbmVyY3JlYXRlIiApOwoKCQkJLy8gY3VlIHBhZ2UgbG9hZGluZyBtZXNzYWdlCgkJCSQubW9iaWxlLnNob3dQYWdlTG9hZGluZ01zZygpOwoKCQkJLy9yZW1vdmUgaW5pdGlhbCBidWlsZCBjbGFzcyAob25seSBwcmVzZW50IG9uIGZpcnN0IHBhZ2VzaG93KQoJCQloaWRlUmVuZGVyaW5nQ2xhc3MoKTsKCgkJCS8vIGlmIGhhc2hjaGFuZ2UgbGlzdGVuaW5nIGlzIGRpc2FibGVkLCB0aGVyZSdzIG5vIGhhc2ggZGVlcGxpbmssCgkJCS8vIHRoZSBoYXNoIGlzIG5vdCB2YWxpZCAoY29udGFpbnMgbW9yZSB0aGFuIG9uZSAjIG9yIGRvZXMgbm90IHN0YXJ0IHdpdGggIykKCQkJLy8gb3IgdGhlcmUgaXMgbm8gcGFnZSB3aXRoIHRoYXQgaGFzaCwgY2hhbmdlIHRvIHRoZSBmaXJzdCBwYWdlIGluIHRoZSBET00KCQkJLy8gUmVtZW1iZXIsIGhvd2V2ZXIsIHRoYXQgdGhlIGhhc2ggY2FuIGFsc28gYmUgYSBwYXRoIQoJCQlpZiAoICEgKCAkLm1vYmlsZS5oYXNoTGlzdGVuaW5nRW5hYmxlZCAmJgoJCQkJJC5tb2JpbGUucGF0aC5pc0hhc2hWYWxpZCggbG9jYXRpb24uaGFzaCApICYmCgkJCQkoICQoIGhhc2hQYWdlICkuaXMoICc6anFtRGF0YShyb2xlPSJwYWdlIiknICkgfHwKCQkJCQkkLm1vYmlsZS5wYXRoLmlzUGF0aCggaGFzaCApIHx8CgkJCQkJaGFzaCA9PT0gJC5tb2JpbGUuZGlhbG9nSGFzaEtleSApICkgKSB7CgoJCQkJLy8gU3RvcmUgdGhlIGluaXRpYWwgZGVzdGluYXRpb24KCQkJCWlmICggJC5tb2JpbGUucGF0aC5pc0hhc2hWYWxpZCggbG9jYXRpb24uaGFzaCApICkgewoJCQkJCSQubW9iaWxlLnVybEhpc3RvcnkuaW5pdGlhbERzdCA9IGhhc2gucmVwbGFjZSggIiMiLCAiIiApOwoJCQkJfQoJCQkJJC5tb2JpbGUuY2hhbmdlUGFnZSggJC5tb2JpbGUuZmlyc3RQYWdlLCB7IHRyYW5zaXRpb246ICJub25lIiwgcmV2ZXJzZTogdHJ1ZSwgY2hhbmdlSGFzaDogZmFsc2UsIGZyb21IYXNoQ2hhbmdlOiB0cnVlIH0gKTsKCQkJfQoJCQkvLyBvdGhlcndpc2UsIHRyaWdnZXIgYSBoYXNoY2hhbmdlIHRvIGxvYWQgYSBkZWVwbGluawoJCQllbHNlIHsKCQkJCSR3aW5kb3cudHJpZ2dlciggImhhc2hjaGFuZ2UiLCBbIHRydWUgXSApOwoJCQl9CgkJfQoJfSk7CgoJLy8gaW5pdGlhbGl6ZSBldmVudHMgbm93LCBhZnRlciBtb2JpbGVpbml0IGhhcyBvY2N1cnJlZAoJJC5tb2JpbGUubmF2cmVhZHlEZWZlcnJlZC5yZXNvbHZlKCk7CgoJLy8gY2hlY2sgd2hpY2ggc2Nyb2xsVG9wIHZhbHVlIHNob3VsZCBiZSB1c2VkIGJ5IHNjcm9sbGluZyB0byAxIGltbWVkaWF0ZWx5IGF0IGRvbXJlYWR5CgkvLyB0aGVuIGNoZWNrIHdoYXQgdGhlIHNjcm9sbCB0b3AgaXMuIEFuZHJvaWQgd2lsbCByZXBvcnQgMC4uLiBvdGhlcnMgMQoJLy8gbm90ZSB0aGF0IHRoaXMgaW5pdGlhbCBzY3JvbGwgd29uJ3QgaGlkZSB0aGUgYWRkcmVzcyBiYXIuIEl0J3MganVzdCBmb3IgdGhlIGNoZWNrLgoJJChmdW5jdGlvbigpIHsKCQl3aW5kb3cuc2Nyb2xsVG8oIDAsIDEgKTsKCgkJLy8gaWYgZGVmYXVsdEhvbWVTY3JvbGwgaGFzbid0IGJlZW4gc2V0IHlldCwgc2VlIGlmIHNjcm9sbFRvcCBpcyAxCgkJLy8gaXQgc2hvdWxkIGJlIDEgaW4gbW9zdCBicm93c2VycywgYnV0IGFuZHJvaWQgdHJlYXRzIDEgYXMgMCAoZm9yIGhpZGluZyBhZGRyIGJhcikKCQkvLyBzbyBpZiBpdCdzIDEsIHVzZSAwIGZyb20gbm93IG9uCgkJJC5tb2JpbGUuZGVmYXVsdEhvbWVTY3JvbGwgPSAoICEkLnN1cHBvcnQuc2Nyb2xsVG9wIHx8ICQoIHdpbmRvdyApLnNjcm9sbFRvcCgpID09PSAxICkgPyAwIDogMTsKCgoJCS8vIFRPRE86IEltcGxlbWVudCBhIHByb3BlciByZWdpc3RyYXRpb24gbWVjaGFuaXNtIHdpdGggZGVwZW5kZW5jeSBoYW5kbGluZyBpbiBvcmRlciB0byBub3QgaGF2ZSBleGNlcHRpb25zIGxpa2UgdGhlIG9uZSBiZWxvdwoJCS8vYXV0byBzZWxmLWluaXQgd2lkZ2V0cyBmb3IgdGhvc2Ugd2lkZ2V0cyB0aGF0IGhhdmUgYSBzb2Z0IGRlcGVuZGVuY3kgb24gb3RoZXJzCgkJaWYgKCAkLmZuLmNvbnRyb2xncm91cCApIHsKCQkJJCggZG9jdW1lbnQgKS5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApIHsKCQkJCSQoICI6anFtRGF0YShyb2xlPSdjb250cm9sZ3JvdXAnKSIsIGUudGFyZ2V0ICkKCQkJCQkuanFtRW5oYW5jZWFibGUoKQoJCQkJCS5jb250cm9sZ3JvdXAoeyBleGNsdWRlSW52aXNpYmxlOiBmYWxzZSB9KTsKCQkJfSk7CgkJfQoKCQkvL2RvbS1yZWFkeSBpbml0cwoJCWlmICggJC5tb2JpbGUuYXV0b0luaXRpYWxpemVQYWdlICkgewoJCQkkLm1vYmlsZS5pbml0aWFsaXplUGFnZSgpOwoJCX0KCgkJLy8gd2luZG93IGxvYWQgZXZlbnQKCQkvLyBoaWRlIGlPUyBicm93c2VyIGNocm9tZSBvbiBsb2FkCgkJJHdpbmRvdy5sb2FkKCAkLm1vYmlsZS5zaWxlbnRTY3JvbGwgKTsKCgkJaWYgKCAhJC5zdXBwb3J0LmNzc1BvaW50ZXJFdmVudHMgKSB7CgkJCS8vIElFIGFuZCBPcGVyYSBkb24ndCBzdXBwb3J0IENTUyBwb2ludGVyLWV2ZW50czogbm9uZSB0aGF0IHdlIHVzZSB0byBkaXNhYmxlIGxpbmstYmFzZWQgYnV0dG9ucwoJCQkvLyBieSBhZGRpbmcgdGhlICd1aS1kaXNhYmxlZCcgY2xhc3MgdG8gdGhlbS4gVXNpbmcgYSBKYXZhU2NyaXB0IHdvcmthcm91bmQgZm9yIHRob3NlIGJyb3dzZXIuCgkJCS8vIGh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5LW1vYmlsZS9pc3N1ZXMvMzU1OAoKCQkJJCggZG9jdW1lbnQgKS5kZWxlZ2F0ZSggIi51aS1kaXNhYmxlZCIsICJ2Y2xpY2siLAoJCQkJZnVuY3Rpb24oIGUgKSB7CgkJCQkJZS5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJCWUuc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uKCk7CgkJCQl9CgkJCSk7CgkJfQoJfSk7Cn0oIGpRdWVyeSwgdGhpcyApKTsKCn0pKTsK",
                "body": "LyoKKiBqUXVlcnkgTW9iaWxlIEZyYW1ld29yayBHaXQgQnVpbGQ6IFNIQTE6IGMyZDYxZTJlNTkyYzY3NTE5ZDlhOWVkMGJhNzk2ZmE0NDc4N2UxMzYgPD4gRGF0ZTogVHVlIFNlcCAyNSAxMDozODoxMiAyMDEyIC0wNzAwCiogaHR0cDovL2pxdWVyeW1vYmlsZS5jb20KKgoqIENvcHlyaWdodCAyMDEyIGpRdWVyeSBGb3VuZGF0aW9uIGFuZCBvdGhlciBjb250cmlidXRvcnMKKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuCiogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQoqCiovCgoKKGZ1bmN0aW9uICggcm9vdCwgZG9jLCBmYWN0b3J5ICkgewoJaWYgKCB0eXBlb2YgZGVmaW5lID09PSAiZnVuY3Rpb24iICYmIGRlZmluZS5hbWQgKSB7CgkJLy8gQU1ELiBSZWdpc3RlciBhcyBhbiBhbm9ueW1vdXMgbW9kdWxlLgoJCWRlZmluZSggWyAianF1ZXJ5IiBdLCBmdW5jdGlvbiAoICQgKSB7CgkJCWZhY3RvcnkoICQsIHJvb3QsIGRvYyApOwoJCQlyZXR1cm4gJC5tb2JpbGU7CgkJfSk7Cgl9IGVsc2UgewoJCS8vIEJyb3dzZXIgZ2xvYmFscwoJCWZhY3RvcnkoIHJvb3QualF1ZXJ5LCByb290LCBkb2MgKTsKCX0KfSggdGhpcywgZG9jdW1lbnQsIGZ1bmN0aW9uICggalF1ZXJ5LCB3aW5kb3csIGRvY3VtZW50LCB1bmRlZmluZWQgKSB7CihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgoJdmFyIG5zTm9ybWFsaXplRGljdCA9IHt9OwoKCS8vIGpRdWVyeS5tb2JpbGUgY29uZmlndXJhYmxlIG9wdGlvbnMKCSQubW9iaWxlID0gJC5leHRlbmQoIHt9LCB7CgoJCS8vIFZlcnNpb24gb2YgdGhlIGpRdWVyeSBNb2JpbGUgRnJhbWV3b3JrCgkJdmVyc2lvbjogIjEuMi4wIiwKCgkJLy8gTmFtZXNwYWNlIHVzZWQgZnJhbWV3b3JrLXdpZGUgZm9yIGRhdGEtYXR0cnMuIERlZmF1bHQgaXMgbm8gbmFtZXNwYWNlCgkJbnM6ICIiLAoKCQkvLyBEZWZpbmUgdGhlIHVybCBwYXJhbWV0ZXIgdXNlZCBmb3IgcmVmZXJlbmNpbmcgd2lkZ2V0LWdlbmVyYXRlZCBzdWItcGFnZXMuCgkJLy8gVHJhbnNsYXRlcyB0byB0byBleGFtcGxlLmh0bWwmdWktcGFnZT1zdWJwYWdlSWRlbnRpZmllcgoJCS8vIGhhc2ggc2VnbWVudCBiZWZvcmUgJnVpLXBhZ2U9IGlzIHVzZWQgdG8gbWFrZSBBamF4IHJlcXVlc3QKCQlzdWJQYWdlVXJsS2V5OiAidWktcGFnZSIsCgoJCS8vIENsYXNzIGFzc2lnbmVkIHRvIHBhZ2UgY3VycmVudGx5IGluIHZpZXcsIGFuZCBkdXJpbmcgdHJhbnNpdGlvbnMKCQlhY3RpdmVQYWdlQ2xhc3M6ICJ1aS1wYWdlLWFjdGl2ZSIsCgoJCS8vIENsYXNzIHVzZWQgZm9yICJhY3RpdmUiIGJ1dHRvbiBzdGF0ZSwgZnJvbSBDU1MgZnJhbWV3b3JrCgkJYWN0aXZlQnRuQ2xhc3M6ICJ1aS1idG4tYWN0aXZlIiwKCgkJLy8gQ2xhc3MgdXNlZCBmb3IgImZvY3VzIiBmb3JtIGVsZW1lbnQgc3RhdGUsIGZyb20gQ1NTIGZyYW1ld29yawoJCWZvY3VzQ2xhc3M6ICJ1aS1mb2N1cyIsCgoJCS8vIEF1dG9tYXRpY2FsbHkgaGFuZGxlIGNsaWNrcyBhbmQgZm9ybSBzdWJtaXNzaW9ucyB0aHJvdWdoIEFqYXgsIHdoZW4gc2FtZS1kb21haW4KCQlhamF4RW5hYmxlZDogdHJ1ZSwKCgkJLy8gQXV0b21hdGljYWxseSBsb2FkIGFuZCBzaG93IHBhZ2VzIGJhc2VkIG9uIGxvY2F0aW9uLmhhc2gKCQloYXNoTGlzdGVuaW5nRW5hYmxlZDogdHJ1ZSwKCgkJLy8gZGlzYWJsZSB0byBwcmV2ZW50IGpxdWVyeSBmcm9tIGJvdGhlcmluZyB3aXRoIGxpbmtzCgkJbGlua0JpbmRpbmdFbmFibGVkOiB0cnVlLAoKCQkvLyBTZXQgZGVmYXVsdCBwYWdlIHRyYW5zaXRpb24gLSAnbm9uZScgZm9yIG5vIHRyYW5zaXRpb25zCgkJZGVmYXVsdFBhZ2VUcmFuc2l0aW9uOiAiZmFkZSIsCgoJCS8vIFNldCBtYXhpbXVtIHdpbmRvdyB3aWR0aCBmb3IgdHJhbnNpdGlvbnMgdG8gYXBwbHkgLSAnZmFsc2UnIGZvciBubyBsaW1pdAoJCW1heFRyYW5zaXRpb25XaWR0aDogZmFsc2UsCgoJCS8vIE1pbmltdW0gc2Nyb2xsIGRpc3RhbmNlIHRoYXQgd2lsbCBiZSByZW1lbWJlcmVkIHdoZW4gcmV0dXJuaW5nIHRvIGEgcGFnZQoJCW1pblNjcm9sbEJhY2s6IDI1MCwKCgkJLy8gREVQUkVDQVRFRDogdGhlIGZvbGxvd2luZyBwcm9wZXJ0eSBpcyBubyBsb25nZXIgaW4gdXNlLCBidXQgZGVmaW5lZCB1bnRpbCAyLjAgdG8gcHJldmVudCBjb25mbGljdHMKCQl0b3VjaE92ZXJmbG93RW5hYmxlZDogZmFsc2UsCgoJCS8vIFNldCBkZWZhdWx0IGRpYWxvZyB0cmFuc2l0aW9uIC0gJ25vbmUnIGZvciBubyB0cmFuc2l0aW9ucwoJCWRlZmF1bHREaWFsb2dUcmFuc2l0aW9uOiAicG9wIiwKCgkJLy8gRXJyb3IgcmVzcG9uc2UgbWVzc2FnZSAtIGFwcGVhcnMgd2hlbiBhbiBBamF4IHBhZ2UgcmVxdWVzdCBmYWlscwoJCXBhZ2VMb2FkRXJyb3JNZXNzYWdlOiAiRXJyb3IgTG9hZGluZyBQYWdlIiwKCgkJLy8gRm9yIGVycm9yIG1lc3NhZ2VzLCB3aGljaCB0aGVtZSBkb2VzIHRoZSBib3ggdXNlcz8KCQlwYWdlTG9hZEVycm9yTWVzc2FnZVRoZW1lOiAiZSIsCgoJCS8vIHJlcGxhY2UgY2FsbHMgdG8gd2luZG93Lmhpc3RvcnkuYmFjayB3aXRoIHBob25lZ2FwcyBuYXZpZ2F0aW9uIGhlbHBlcgoJCS8vIHdoZXJlIGl0IGlzIHByb3ZpZGVkIG9uIHRoZSB3aW5kb3cgb2JqZWN0CgkJcGhvbmVnYXBOYXZpZ2F0aW9uRW5hYmxlZDogZmFsc2UsCgoJCS8vYXV0b21hdGljYWxseSBpbml0aWFsaXplIHRoZSBET00gd2hlbiBpdCdzIHJlYWR5CgkJYXV0b0luaXRpYWxpemVQYWdlOiB0cnVlLAoKCQlwdXNoU3RhdGVFbmFibGVkOiB0cnVlLAoKCQkvLyBhbGxvd3MgdXNlcnMgdG8gb3B0IGluIHRvIGlnbm9yaW5nIGNvbnRlbnQgYnkgbWFya2luZyBhIHBhcmVudCBlbGVtZW50IGFzCgkJLy8gZGF0YS1pZ25vcmVkCgkJaWdub3JlQ29udGVudEVuYWJsZWQ6IGZhbHNlLAoKCQkvLyB0dXJuIG9mIGJpbmRpbmcgdG8gdGhlIG5hdGl2ZSBvcmllbnRhdGlvbmNoYW5nZSBkdWUgdG8gYW5kcm9pZCBvcmllbnRhdGlvbiBiZWhhdmlvcgoJCW9yaWVudGF0aW9uQ2hhbmdlRW5hYmxlZDogdHJ1ZSwKCgkJYnV0dG9uTWFya3VwOiB7CgkJCWhvdmVyRGVsYXk6IDIwMAoJCX0sCgoJCS8vIFRPRE8gbWlnaHQgYmUgdXNlZnVsIHVwc3RyZWFtIGluIGpxdWVyeSBpdHNlbGYgPwoJCWtleUNvZGU6IHsKCQkJQUxUOiAxOCwKCQkJQkFDS1NQQUNFOiA4LAoJCQlDQVBTX0xPQ0s6IDIwLAoJCQlDT01NQTogMTg4LAoJCQlDT01NQU5EOiA5MSwKCQkJQ09NTUFORF9MRUZUOiA5MSwgLy8gQ09NTUFORAoJCQlDT01NQU5EX1JJR0hUOiA5MywKCQkJQ09OVFJPTDogMTcsCgkJCURFTEVURTogNDYsCgkJCURPV046IDQwLAoJCQlFTkQ6IDM1LAoJCQlFTlRFUjogMTMsCgkJCUVTQ0FQRTogMjcsCgkJCUhPTUU6IDM2LAoJCQlJTlNFUlQ6IDQ1LAoJCQlMRUZUOiAzNywKCQkJTUVOVTogOTMsIC8vIENPTU1BTkRfUklHSFQKCQkJTlVNUEFEX0FERDogMTA3LAoJCQlOVU1QQURfREVDSU1BTDogMTEwLAoJCQlOVU1QQURfRElWSURFOiAxMTEsCgkJCU5VTVBBRF9FTlRFUjogMTA4LAoJCQlOVU1QQURfTVVMVElQTFk6IDEwNiwKCQkJTlVNUEFEX1NVQlRSQUNUOiAxMDksCgkJCVBBR0VfRE9XTjogMzQsCgkJCVBBR0VfVVA6IDMzLAoJCQlQRVJJT0Q6IDE5MCwKCQkJUklHSFQ6IDM5LAoJCQlTSElGVDogMTYsCgkJCVNQQUNFOiAzMiwKCQkJVEFCOiA5LAoJCQlVUDogMzgsCgkJCVdJTkRPV1M6IDkxIC8vIENPTU1BTkQKCQl9LAoKCQkvLyBTY3JvbGwgcGFnZSB2ZXJ0aWNhbGx5OiBzY3JvbGwgdG8gMCB0byBoaWRlIGlPUyBhZGRyZXNzIGJhciwgb3IgcGFzcyBhIFkgdmFsdWUKCQlzaWxlbnRTY3JvbGw6IGZ1bmN0aW9uKCB5cG9zICkgewoJCQlpZiAoICQudHlwZSggeXBvcyApICE9PSAibnVtYmVyIiApIHsKCQkJCXlwb3MgPSAkLm1vYmlsZS5kZWZhdWx0SG9tZVNjcm9sbDsKCQkJfQoKCQkJLy8gcHJldmVudCBzY3JvbGxzdGFydCBhbmQgc2Nyb2xsc3RvcCBldmVudHMKCQkJJC5ldmVudC5zcGVjaWFsLnNjcm9sbHN0YXJ0LmVuYWJsZWQgPSBmYWxzZTsKCgkJCXNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCQkJd2luZG93LnNjcm9sbFRvKCAwLCB5cG9zICk7CgkJCQkkKCBkb2N1bWVudCApLnRyaWdnZXIoICJzaWxlbnRzY3JvbGwiLCB7IHg6IDAsIHk6IHlwb3MgfSk7CgkJCX0sIDIwICk7CgoJCQlzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJCSQuZXZlbnQuc3BlY2lhbC5zY3JvbGxzdGFydC5lbmFibGVkID0gdHJ1ZTsKCQkJfSwgMTUwICk7CgkJfSwKCgkJLy8gRXhwb3NlIG91ciBjYWNoZSBmb3IgdGVzdGluZyBwdXJwb3Nlcy4KCQluc05vcm1hbGl6ZURpY3Q6IG5zTm9ybWFsaXplRGljdCwKCgkJLy8gVGFrZSBhIGRhdGEgYXR0cmlidXRlIHByb3BlcnR5LCBwcmVwZW5kIHRoZSBuYW1lc3BhY2UKCQkvLyBhbmQgdGhlbiBjYW1lbCBjYXNlIHRoZSBhdHRyaWJ1dGUgc3RyaW5nLiBBZGQgdGhlIHJlc3VsdAoJCS8vIHRvIG91ciBuc05vcm1hbGl6ZURpY3Qgc28gd2UgZG9uJ3QgaGF2ZSB0byBkbyB0aGlzIGFnYWluLgoJCW5zTm9ybWFsaXplOiBmdW5jdGlvbiggcHJvcCApIHsKCQkJaWYgKCAhcHJvcCApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJcmV0dXJuIG5zTm9ybWFsaXplRGljdFsgcHJvcCBdIHx8ICggbnNOb3JtYWxpemVEaWN0WyBwcm9wIF0gPSAkLmNhbWVsQ2FzZSggJC5tb2JpbGUubnMgKyBwcm9wICkgKTsKCQl9LAoKCQkvLyBGaW5kIHRoZSBjbG9zZXN0IHBhcmVudCB3aXRoIGEgdGhlbWUgY2xhc3Mgb24gaXQuIE5vdGUgdGhhdAoJCS8vIHdlIGFyZSBub3QgdXNpbmcgJC5mbi5jbG9zZXN0KCkgb24gcHVycG9zZSBoZXJlIGJlY2F1c2UgdGhpcwoJCS8vIG1ldGhvZCBnZXRzIGNhbGxlZCBxdWl0ZSBhIGJpdCBhbmQgd2UgbmVlZCBpdCB0byBiZSBhcyBmYXN0CgkJLy8gYXMgcG9zc2libGUuCgkJZ2V0SW5oZXJpdGVkVGhlbWU6IGZ1bmN0aW9uKCBlbCwgZGVmYXVsdFRoZW1lICkgewoJCQl2YXIgZSA9IGVsWyAwIF0sCgkJCQlsdHIgPSAiIiwKCQkJCXJlID0gL3VpLShiYXJ8Ym9keXxvdmVybGF5KS0oW2Etel0pXGIvLAoJCQkJYywgbTsKCgkJCXdoaWxlICggZSApIHsKCQkJCWMgPSBlLmNsYXNzTmFtZSB8fCAiIjsKCQkJCWlmICggYyAmJiAoIG0gPSByZS5leGVjKCBjICkgKSAmJiAoIGx0ciA9IG1bIDIgXSApICkgewoJCQkJCS8vIFdlIGZvdW5kIGEgcGFyZW50IHdpdGggYSB0aGVtZSBjbGFzcwoJCQkJCS8vIG9uIGl0IHNvIGJhaWwgZnJvbSB0aGlzIGxvb3AuCgkJCQkJYnJlYWs7CgkJCQl9CgoJCQkJZSA9IGUucGFyZW50Tm9kZTsKCQkJfQoKCQkJLy8gUmV0dXJuIHRoZSB0aGVtZSBsZXR0ZXIgd2UgZm91bmQsIGlmIG5vbmUsIHJldHVybiB0aGUKCQkJLy8gc3BlY2lmaWVkIGRlZmF1bHQuCgoJCQlyZXR1cm4gbHRyIHx8IGRlZmF1bHRUaGVtZSB8fCAiYSI7CgkJfSwKCgkJLy8gVE9ETyB0aGUgZm9sbG93aW5nICQgYW5kICQuZm4gZXh0ZW5zaW9ucyBjYW4vcHJvYmFibHkgc2hvdWxkIGJlIG1vdmVkIGludG8ganF1ZXJ5Lm1vYmlsZS5jb3JlLmhlbHBlcnMKCQkvLwoJCS8vIEZpbmQgdGhlIGNsb3Nlc3QgamF2YXNjcmlwdCBwYWdlIGVsZW1lbnQgdG8gZ2F0aGVyIHNldHRpbmdzIGRhdGEganNwZXJmIHRlc3QKCQkvLyBodHRwOi8vanNwZXJmLmNvbS9zaW5nbGUtY29tcGxleC1zZWxlY3Rvci12cy1tYW55LWNvbXBsZXgtc2VsZWN0b3JzL2VkaXQKCQkvLyBwb3NzaWJseSBuYWl2ZSwgYnV0IGl0IHNob3dzIHRoYXQgdGhlIHBhcnNpbmcgb3ZlcmhlYWQgZm9yICpqdXN0KiB0aGUgcGFnZSBzZWxlY3RvciB2cwoJCS8vIHRoZSBwYWdlIGFuZCBkaWFsb2cgc2VsZWN0b3IgaXMgbmVnbGlnYWJsZS4gVGhpcyBjb3VsZCBwcm9iYWJseSBiZSBzcGVlZCB1cCBieQoJCS8vIGRvaW5nIGEgc2ltaWxhciBwYXJlbnQgbm9kZSB0cmF2ZXJzYWwgdG8gdGhlIG9uZSBmb3VuZCBpbiB0aGUgaW5oZXJpdGVkIHRoZW1lIGNvZGUgYWJvdmUKCQljbG9zZXN0UGFnZURhdGE6IGZ1bmN0aW9uKCAkdGFyZ2V0ICkgewoJCQlyZXR1cm4gJHRhcmdldAoJCQkJLmNsb3Nlc3QoICc6anFtRGF0YShyb2xlPSJwYWdlIiksIDpqcW1EYXRhKHJvbGU9ImRpYWxvZyIpJyApCgkJCQkuZGF0YSggInBhZ2UiICk7CgkJfSwKCgkJZW5oYW5jZWFibGU6IGZ1bmN0aW9uKCAkc2V0ICkgewoJCQlyZXR1cm4gdGhpcy5oYXZlUGFyZW50cyggJHNldCwgImVuaGFuY2UiICk7CgkJfSwKCgkJaGlqYWNrYWJsZTogZnVuY3Rpb24oICRzZXQgKSB7CgkJCXJldHVybiB0aGlzLmhhdmVQYXJlbnRzKCAkc2V0LCAiYWpheCIgKTsKCQl9LAoKCQloYXZlUGFyZW50czogZnVuY3Rpb24oICRzZXQsIGF0dHIgKSB7CgkJCWlmICggISQubW9iaWxlLmlnbm9yZUNvbnRlbnRFbmFibGVkICkgewoJCQkJcmV0dXJuICRzZXQ7CgkJCX0KCgkJCXZhciBjb3VudCA9ICRzZXQubGVuZ3RoLAoJCQkJJG5ld1NldCA9ICQoKSwKCQkJCWUsICRlbGVtZW50LCBleGNsdWRlZDsKCgkJCWZvciAoIHZhciBpID0gMDsgaSA8IGNvdW50OyBpKysgKSB7CgkJCQkkZWxlbWVudCA9ICRzZXQuZXEoIGkgKTsKCQkJCWV4Y2x1ZGVkID0gZmFsc2U7CgkJCQllID0gJHNldFsgaSBdOwoKCQkJCXdoaWxlICggZSApIHsKCQkJCQl2YXIgYyA9IGUuZ2V0QXR0cmlidXRlID8gZS5nZXRBdHRyaWJ1dGUoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArIGF0dHIgKSA6ICIiOwoKCQkJCQlpZiAoIGMgPT09ICJmYWxzZSIgKSB7CgkJCQkJCWV4Y2x1ZGVkID0gdHJ1ZTsKCQkJCQkJYnJlYWs7CgkJCQkJfQoKCQkJCQllID0gZS5wYXJlbnROb2RlOwoJCQkJfQoKCQkJCWlmICggIWV4Y2x1ZGVkICkgewoJCQkJCSRuZXdTZXQgPSAkbmV3U2V0LmFkZCggJGVsZW1lbnQgKTsKCQkJCX0KCQkJfQoKCQkJcmV0dXJuICRuZXdTZXQ7CgkJfSwKCgkJZ2V0U2NyZWVuSGVpZ2h0OiBmdW5jdGlvbigpIHsKCQkJLy8gTmF0aXZlIGlubmVySGVpZ2h0IHJldHVybnMgbW9yZSBhY2N1cmF0ZSB2YWx1ZSBmb3IgdGhpcyBhY3Jvc3MgcGxhdGZvcm1zLAoJCQkvLyBqUXVlcnkgdmVyc2lvbiBpcyBoZXJlIGFzIGEgbm9ybWFsaXplZCBmYWxsYmFjayBmb3IgcGxhdGZvcm1zIGxpa2UgU3ltYmlhbgoJCQlyZXR1cm4gd2luZG93LmlubmVySGVpZ2h0IHx8ICQoIHdpbmRvdyApLmhlaWdodCgpOwoJCX0KCX0sICQubW9iaWxlICk7CgoJLy8gTW9iaWxlIHZlcnNpb24gb2YgZGF0YSBhbmQgcmVtb3ZlRGF0YSBhbmQgaGFzRGF0YSBtZXRob2RzCgkvLyBlbnN1cmVzIGFsbCBkYXRhIGlzIHNldCBhbmQgcmV0cmlldmVkIHVzaW5nIGpRdWVyeSBNb2JpbGUncyBkYXRhIG5hbWVzcGFjZQoJJC5mbi5qcW1EYXRhID0gZnVuY3Rpb24oIHByb3AsIHZhbHVlICkgewoJCXZhciByZXN1bHQ7CgkJaWYgKCB0eXBlb2YgcHJvcCAhPT0gInVuZGVmaW5lZCIgKSB7CgkJCWlmICggcHJvcCApIHsKCQkJCXByb3AgPSAkLm1vYmlsZS5uc05vcm1hbGl6ZSggcHJvcCApOwoJCQl9CgoJCQkvLyB1bmRlZmluZWQgaXMgcGVybWl0dGVkIGFzIGFuIGV4cGxpY2l0IGlucHV0IGZvciB0aGUgc2Vjb25kIHBhcmFtCgkJCS8vIGluIHRoaXMgY2FzZSBpdCByZXR1cm5zIHRoZSB2YWx1ZSBhbmQgZG9lcyBub3Qgc2V0IGl0IHRvIHVuZGVmaW5lZAoJCQlpZiggYXJndW1lbnRzLmxlbmd0aCA8IDIgfHwgdmFsdWUgPT09IHVuZGVmaW5lZCApewoJCQkJcmVzdWx0ID0gdGhpcy5kYXRhKCBwcm9wICk7CgkJCX0gZWxzZSB7CgkJCQlyZXN1bHQgPSB0aGlzLmRhdGEoIHByb3AsIHZhbHVlICk7CgkJCX0KCQl9CgkJcmV0dXJuIHJlc3VsdDsKCX07CgoJJC5qcW1EYXRhID0gZnVuY3Rpb24oIGVsZW0sIHByb3AsIHZhbHVlICkgewoJCXZhciByZXN1bHQ7CgkJaWYgKCB0eXBlb2YgcHJvcCAhPT0gInVuZGVmaW5lZCIgKSB7CgkJCXJlc3VsdCA9ICQuZGF0YSggZWxlbSwgcHJvcCA/ICQubW9iaWxlLm5zTm9ybWFsaXplKCBwcm9wICkgOiBwcm9wLCB2YWx1ZSApOwoJCX0KCQlyZXR1cm4gcmVzdWx0OwoJfTsKCgkkLmZuLmpxbVJlbW92ZURhdGEgPSBmdW5jdGlvbiggcHJvcCApIHsKCQlyZXR1cm4gdGhpcy5yZW1vdmVEYXRhKCAkLm1vYmlsZS5uc05vcm1hbGl6ZSggcHJvcCApICk7Cgl9OwoKCSQuanFtUmVtb3ZlRGF0YSA9IGZ1bmN0aW9uKCBlbGVtLCBwcm9wICkgewoJCXJldHVybiAkLnJlbW92ZURhdGEoIGVsZW0sICQubW9iaWxlLm5zTm9ybWFsaXplKCBwcm9wICkgKTsKCX07CgoJJC5mbi5yZW1vdmVXaXRoRGVwZW5kZW50cyA9IGZ1bmN0aW9uKCkgewoJCSQucmVtb3ZlV2l0aERlcGVuZGVudHMoIHRoaXMgKTsKCX07CgoJJC5yZW1vdmVXaXRoRGVwZW5kZW50cyA9IGZ1bmN0aW9uKCBlbGVtICkgewoJCXZhciAkZWxlbSA9ICQoIGVsZW0gKTsKCgkJKCAkZWxlbS5qcW1EYXRhKCAnZGVwZW5kZW50cycgKSB8fCAkKCkgKS5yZW1vdmUoKTsKCQkkZWxlbS5yZW1vdmUoKTsKCX07CgoJJC5mbi5hZGREZXBlbmRlbnRzID0gZnVuY3Rpb24oIG5ld0RlcGVuZGVudHMgKSB7CgkJJC5hZGREZXBlbmRlbnRzKCAkKCB0aGlzICksIG5ld0RlcGVuZGVudHMgKTsKCX07CgoJJC5hZGREZXBlbmRlbnRzID0gZnVuY3Rpb24oIGVsZW0sIG5ld0RlcGVuZGVudHMgKSB7CgkJdmFyIGRlcGVuZGVudHMgPSAkKCBlbGVtICkuanFtRGF0YSggJ2RlcGVuZGVudHMnICkgfHwgJCgpOwoKCQkkKCBlbGVtICkuanFtRGF0YSggJ2RlcGVuZGVudHMnLCAkLm1lcmdlKCBkZXBlbmRlbnRzLCBuZXdEZXBlbmRlbnRzICkgKTsKCX07CgoJLy8gbm90ZSB0aGF0IHRoaXMgaGVscGVyIGRvZXNuJ3QgYXR0ZW1wdCB0byBoYW5kbGUgdGhlIGNhbGxiYWNrCgkvLyBvciBzZXR0aW5nIG9mIGFuIGh0bWwgZWxlbWVudHMgdGV4dCwgaXRzIG9ubHkgcHVycG9zZSBpcwoJLy8gdG8gcmV0dXJuIHRoZSBodG1sIGVuY29kZWQgdmVyc2lvbiBvZiB0aGUgdGV4dCBpbiBhbGwgY2FzZXMuICh0aHVzIHRoZSBuYW1lKQoJJC5mbi5nZXRFbmNvZGVkVGV4dCA9IGZ1bmN0aW9uKCkgewoJCXJldHVybiAkKCAiPGRpdi8+IiApLnRleHQoICQoIHRoaXMgKS50ZXh0KCkgKS5odG1sKCk7Cgl9OwoKCS8vIGZsdWVudCBoZWxwZXIgZnVuY3Rpb24gZm9yIHRoZSBtb2JpbGUgbmFtZXNwYWNlZCBlcXVpdmFsZW50CgkkLmZuLmpxbUVuaGFuY2VhYmxlID0gZnVuY3Rpb24oKSB7CgkJcmV0dXJuICQubW9iaWxlLmVuaGFuY2VhYmxlKCB0aGlzICk7Cgl9OwoKCSQuZm4uanFtSGlqYWNrYWJsZSA9IGZ1bmN0aW9uKCkgewoJCXJldHVybiAkLm1vYmlsZS5oaWphY2thYmxlKCB0aGlzICk7Cgl9OwoKCS8vIE1vbmtleS1wYXRjaGluZyBTaXp6bGUgdG8gZmlsdGVyIHRoZSA6anFtRGF0YSBzZWxlY3RvcgoJdmFyIG9sZEZpbmQgPSAkLmZpbmQsCgkJanFtRGF0YVJFID0gLzpqcW1EYXRhXCgoW14pXSopXCkvZzsKCgkkLmZpbmQgPSBmdW5jdGlvbiggc2VsZWN0b3IsIGNvbnRleHQsIHJldCwgZXh0cmEgKSB7CgkJc2VsZWN0b3IgPSBzZWxlY3Rvci5yZXBsYWNlKCBqcW1EYXRhUkUsICJbZGF0YS0iICsgKCAkLm1vYmlsZS5ucyB8fCAiIiApICsgIiQxXSIgKTsKCgkJcmV0dXJuIG9sZEZpbmQuY2FsbCggdGhpcywgc2VsZWN0b3IsIGNvbnRleHQsIHJldCwgZXh0cmEgKTsKCX07CgoJJC5leHRlbmQoICQuZmluZCwgb2xkRmluZCApOwoKCSQuZmluZC5tYXRjaGVzID0gZnVuY3Rpb24oIGV4cHIsIHNldCApIHsKCQlyZXR1cm4gJC5maW5kKCBleHByLCBudWxsLCBudWxsLCBzZXQgKTsKCX07CgoJJC5maW5kLm1hdGNoZXNTZWxlY3RvciA9IGZ1bmN0aW9uKCBub2RlLCBleHByICkgewoJCXJldHVybiAkLmZpbmQoIGV4cHIsIG51bGwsIG51bGwsIFsgbm9kZSBdICkubGVuZ3RoID4gMDsKCX07Cn0pKCBqUXVlcnksIHRoaXMgKTsKCgovKiEKICogalF1ZXJ5IFVJIFdpZGdldCB2MS45LjAtYmV0YS4xCiAqCiAqIENvcHlyaWdodCAyMDEyLCBodHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L2pxdWVyeS11aS9ibG9iLzEuOS4wLWJldGEuMS9BVVRIT1JTLnR4dCAoaHR0cDovL2pxdWVyeXVpLmNvbS9hYm91dCkKICogRHVhbCBsaWNlbnNlZCB1bmRlciB0aGUgTUlUIG9yIEdQTCBWZXJzaW9uIDIgbGljZW5zZXMuCiAqIGh0dHA6Ly9qcXVlcnkub3JnL2xpY2Vuc2UKICoKICogaHR0cDovL2RvY3MuanF1ZXJ5LmNvbS9VSS9XaWRnZXQKICovCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKdmFyIHV1aWQgPSAwLAoJc2xpY2UgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UsCglfY2xlYW5EYXRhID0gJC5jbGVhbkRhdGE7CiQuY2xlYW5EYXRhID0gZnVuY3Rpb24oIGVsZW1zICkgewoJZm9yICggdmFyIGkgPSAwLCBlbGVtOyAoZWxlbSA9IGVsZW1zW2ldKSAhPSBudWxsOyBpKysgKSB7CgkJdHJ5IHsKCQkJJCggZWxlbSApLnRyaWdnZXJIYW5kbGVyKCAicmVtb3ZlIiApOwoJCS8vIGh0dHA6Ly9idWdzLmpxdWVyeS5jb20vdGlja2V0LzgyMzUKCQl9IGNhdGNoKCBlICkge30KCX0KCV9jbGVhbkRhdGEoIGVsZW1zICk7Cn07CgokLndpZGdldCA9IGZ1bmN0aW9uKCBuYW1lLCBiYXNlLCBwcm90b3R5cGUgKSB7Cgl2YXIgZnVsbE5hbWUsIGV4aXN0aW5nQ29uc3RydWN0b3IsIGNvbnN0cnVjdG9yLCBiYXNlUHJvdG90eXBlLAoJCW5hbWVzcGFjZSA9IG5hbWUuc3BsaXQoICIuIiApWyAwIF07CgoJbmFtZSA9IG5hbWUuc3BsaXQoICIuIiApWyAxIF07CglmdWxsTmFtZSA9IG5hbWVzcGFjZSArICItIiArIG5hbWU7CgoJaWYgKCAhcHJvdG90eXBlICkgewoJCXByb3RvdHlwZSA9IGJhc2U7CgkJYmFzZSA9ICQuV2lkZ2V0OwoJfQoKCS8vIGNyZWF0ZSBzZWxlY3RvciBmb3IgcGx1Z2luCgkkLmV4cHJbICI6IiBdWyBmdWxsTmFtZSBdID0gZnVuY3Rpb24oIGVsZW0gKSB7CgkJcmV0dXJuICEhJC5kYXRhKCBlbGVtLCBmdWxsTmFtZSApOwoJfTsKCgkkWyBuYW1lc3BhY2UgXSA9ICRbIG5hbWVzcGFjZSBdIHx8IHt9OwoJZXhpc3RpbmdDb25zdHJ1Y3RvciA9ICRbIG5hbWVzcGFjZSBdWyBuYW1lIF07Cgljb25zdHJ1Y3RvciA9ICRbIG5hbWVzcGFjZSBdWyBuYW1lIF0gPSBmdW5jdGlvbiggb3B0aW9ucywgZWxlbWVudCApIHsKCQkvLyBhbGxvdyBpbnN0YW50aWF0aW9uIHdpdGhvdXQgIm5ldyIga2V5d29yZAoJCWlmICggIXRoaXMuX2NyZWF0ZVdpZGdldCApIHsKCQkJcmV0dXJuIG5ldyBjb25zdHJ1Y3Rvciggb3B0aW9ucywgZWxlbWVudCApOwoJCX0KCgkJLy8gYWxsb3cgaW5zdGFudGlhdGlvbiB3aXRob3V0IGluaXRpYWxpemluZyBmb3Igc2ltcGxlIGluaGVyaXRhbmNlCgkJLy8gbXVzdCB1c2UgIm5ldyIga2V5d29yZCAodGhlIGNvZGUgYWJvdmUgYWx3YXlzIHBhc3NlcyBhcmdzKQoJCWlmICggYXJndW1lbnRzLmxlbmd0aCApIHsKCQkJdGhpcy5fY3JlYXRlV2lkZ2V0KCBvcHRpb25zLCBlbGVtZW50ICk7CgkJfQoJfTsKCS8vIGV4dGVuZCB3aXRoIHRoZSBleGlzdGluZyBjb25zdHJ1Y3RvciB0byBjYXJyeSBvdmVyIGFueSBzdGF0aWMgcHJvcGVydGllcwoJJC5leHRlbmQoIGNvbnN0cnVjdG9yLCBleGlzdGluZ0NvbnN0cnVjdG9yLCB7CgkJdmVyc2lvbjogcHJvdG90eXBlLnZlcnNpb24sCgkJLy8gY29weSB0aGUgb2JqZWN0IHVzZWQgdG8gY3JlYXRlIHRoZSBwcm90b3R5cGUgaW4gY2FzZSB3ZSBuZWVkIHRvCgkJLy8gcmVkZWZpbmUgdGhlIHdpZGdldCBsYXRlcgoJCV9wcm90bzogJC5leHRlbmQoIHt9LCBwcm90b3R5cGUgKSwKCQkvLyB0cmFjayB3aWRnZXRzIHRoYXQgaW5oZXJpdCBmcm9tIHRoaXMgd2lkZ2V0IGluIGNhc2UgdGhpcyB3aWRnZXQgaXMKCQkvLyByZWRlZmluZWQgYWZ0ZXIgYSB3aWRnZXQgaW5oZXJpdHMgZnJvbSBpdAoJCV9jaGlsZENvbnN0cnVjdG9yczogW10KCX0pOwoKCWJhc2VQcm90b3R5cGUgPSBuZXcgYmFzZSgpOwoJLy8gd2UgbmVlZCB0byBtYWtlIHRoZSBvcHRpb25zIGhhc2ggYSBwcm9wZXJ0eSBkaXJlY3RseSBvbiB0aGUgbmV3IGluc3RhbmNlCgkvLyBvdGhlcndpc2Ugd2UnbGwgbW9kaWZ5IHRoZSBvcHRpb25zIGhhc2ggb24gdGhlIHByb3RvdHlwZSB0aGF0IHdlJ3JlCgkvLyBpbmhlcml0aW5nIGZyb20KCWJhc2VQcm90b3R5cGUub3B0aW9ucyA9ICQud2lkZ2V0LmV4dGVuZCgge30sIGJhc2VQcm90b3R5cGUub3B0aW9ucyApOwoJJC5lYWNoKCBwcm90b3R5cGUsIGZ1bmN0aW9uKCBwcm9wLCB2YWx1ZSApIHsKCQlpZiAoICQuaXNGdW5jdGlvbiggdmFsdWUgKSApIHsKCQkJcHJvdG90eXBlWyBwcm9wIF0gPSAoZnVuY3Rpb24oKSB7CgkJCQl2YXIgX3N1cGVyID0gZnVuY3Rpb24oKSB7CgkJCQkJCXJldHVybiBiYXNlLnByb3RvdHlwZVsgcHJvcCBdLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsKCQkJCQl9LAoJCQkJCV9zdXBlckFwcGx5ID0gZnVuY3Rpb24oIGFyZ3MgKSB7CgkJCQkJCXJldHVybiBiYXNlLnByb3RvdHlwZVsgcHJvcCBdLmFwcGx5KCB0aGlzLCBhcmdzICk7CgkJCQkJfTsKCQkJCXJldHVybiBmdW5jdGlvbigpIHsKCQkJCQl2YXIgX19zdXBlciA9IHRoaXMuX3N1cGVyLAoJCQkJCQlfX3N1cGVyQXBwbHkgPSB0aGlzLl9zdXBlckFwcGx5LAoJCQkJCQlyZXR1cm5WYWx1ZTsKCgkJCQkJdGhpcy5fc3VwZXIgPSBfc3VwZXI7CgkJCQkJdGhpcy5fc3VwZXJBcHBseSA9IF9zdXBlckFwcGx5OwoKCQkJCQlyZXR1cm5WYWx1ZSA9IHZhbHVlLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsKCgkJCQkJdGhpcy5fc3VwZXIgPSBfX3N1cGVyOwoJCQkJCXRoaXMuX3N1cGVyQXBwbHkgPSBfX3N1cGVyQXBwbHk7CgoJCQkJCXJldHVybiByZXR1cm5WYWx1ZTsKCQkJCX07CgkJCX0pKCk7CgkJfQoJfSk7Cgljb25zdHJ1Y3Rvci5wcm90b3R5cGUgPSAkLndpZGdldC5leHRlbmQoIGJhc2VQcm90b3R5cGUsIHsKCQkvLyBUT0RPOiByZW1vdmUgc3VwcG9ydCBmb3Igd2lkZ2V0RXZlbnRQcmVmaXgKCQkvLyBhbHdheXMgdXNlIHRoZSBuYW1lICsgYSBjb2xvbiBhcyB0aGUgcHJlZml4LCBlLmcuLCBkcmFnZ2FibGU6c3RhcnQKCQkvLyBkb24ndCBwcmVmaXggZm9yIHdpZGdldHMgdGhhdCBhcmVuJ3QgRE9NLWJhc2VkCgkJd2lkZ2V0RXZlbnRQcmVmaXg6IG5hbWUKCX0sIHByb3RvdHlwZSwgewoJCWNvbnN0cnVjdG9yOiBjb25zdHJ1Y3RvciwKCQluYW1lc3BhY2U6IG5hbWVzcGFjZSwKCQl3aWRnZXROYW1lOiBuYW1lLAoJCS8vIFRPRE8gcmVtb3ZlIHdpZGdldEJhc2VDbGFzcywgc2VlICM4MTU1CgkJd2lkZ2V0QmFzZUNsYXNzOiBmdWxsTmFtZSwKCQl3aWRnZXRGdWxsTmFtZTogZnVsbE5hbWUKCX0pOwoKCS8vIElmIHRoaXMgd2lkZ2V0IGlzIGJlaW5nIHJlZGVmaW5lZCB0aGVuIHdlIG5lZWQgdG8gZmluZCBhbGwgd2lkZ2V0cyB0aGF0CgkvLyBhcmUgaW5oZXJpdGluZyBmcm9tIGl0IGFuZCByZWRlZmluZSBhbGwgb2YgdGhlbSBzbyB0aGF0IHRoZXkgaW5oZXJpdCBmcm9tCgkvLyB0aGUgbmV3IHZlcnNpb24gb2YgdGhpcyB3aWRnZXQuIFdlJ3JlIGVzc2VudGlhbGx5IHRyeWluZyB0byByZXBsYWNlIG9uZQoJLy8gbGV2ZWwgaW4gdGhlIHByb3RvdHlwZSBjaGFpbi4KCWlmICggZXhpc3RpbmdDb25zdHJ1Y3RvciApIHsKCQkkLmVhY2goIGV4aXN0aW5nQ29uc3RydWN0b3IuX2NoaWxkQ29uc3RydWN0b3JzLCBmdW5jdGlvbiggaSwgY2hpbGQgKSB7CgkJCXZhciBjaGlsZFByb3RvdHlwZSA9IGNoaWxkLnByb3RvdHlwZTsKCgkJCS8vIHJlZGVmaW5lIHRoZSBjaGlsZCB3aWRnZXQgdXNpbmcgdGhlIHNhbWUgcHJvdG90eXBlIHRoYXQgd2FzCgkJCS8vIG9yaWdpbmFsbHkgdXNlZCwgYnV0IGluaGVyaXQgZnJvbSB0aGUgbmV3IHZlcnNpb24gb2YgdGhlIGJhc2UKCQkJJC53aWRnZXQoIGNoaWxkUHJvdG90eXBlLm5hbWVzcGFjZSArICIuIiArIGNoaWxkUHJvdG90eXBlLndpZGdldE5hbWUsIGNvbnN0cnVjdG9yLCBjaGlsZC5fcHJvdG8gKTsKCQl9KTsKCQkvLyByZW1vdmUgdGhlIGxpc3Qgb2YgZXhpc3RpbmcgY2hpbGQgY29uc3RydWN0b3JzIGZyb20gdGhlIG9sZCBjb25zdHJ1Y3RvcgoJCS8vIHNvIHRoZSBvbGQgY2hpbGQgY29uc3RydWN0b3JzIGNhbiBiZSBnYXJiYWdlIGNvbGxlY3RlZAoJCWRlbGV0ZSBleGlzdGluZ0NvbnN0cnVjdG9yLl9jaGlsZENvbnN0cnVjdG9yczsKCX0gZWxzZSB7CgkJYmFzZS5fY2hpbGRDb25zdHJ1Y3RvcnMucHVzaCggY29uc3RydWN0b3IgKTsKCX0KCgkkLndpZGdldC5icmlkZ2UoIG5hbWUsIGNvbnN0cnVjdG9yICk7Cn07CgokLndpZGdldC5leHRlbmQgPSBmdW5jdGlvbiggdGFyZ2V0ICkgewoJdmFyIGlucHV0ID0gc2xpY2UuY2FsbCggYXJndW1lbnRzLCAxICksCgkJaW5wdXRJbmRleCA9IDAsCgkJaW5wdXRMZW5ndGggPSBpbnB1dC5sZW5ndGgsCgkJa2V5LAoJCXZhbHVlOwoJZm9yICggOyBpbnB1dEluZGV4IDwgaW5wdXRMZW5ndGg7IGlucHV0SW5kZXgrKyApIHsKCQlmb3IgKCBrZXkgaW4gaW5wdXRbIGlucHV0SW5kZXggXSApIHsKCQkJdmFsdWUgPSBpbnB1dFsgaW5wdXRJbmRleCBdWyBrZXkgXTsKCQkJaWYgKGlucHV0WyBpbnB1dEluZGV4IF0uaGFzT3duUHJvcGVydHkoIGtleSApICYmIHZhbHVlICE9PSB1bmRlZmluZWQgKSB7CgkJCQl0YXJnZXRbIGtleSBdID0gJC5pc1BsYWluT2JqZWN0KCB2YWx1ZSApID8gJC53aWRnZXQuZXh0ZW5kKCB7fSwgdGFyZ2V0WyBrZXkgXSwgdmFsdWUgKSA6IHZhbHVlOwoJCQl9CgkJfQoJfQoJcmV0dXJuIHRhcmdldDsKfTsKCiQud2lkZ2V0LmJyaWRnZSA9IGZ1bmN0aW9uKCBuYW1lLCBvYmplY3QgKSB7Cgl2YXIgZnVsbE5hbWUgPSBvYmplY3QucHJvdG90eXBlLndpZGdldEZ1bGxOYW1lOwoJJC5mblsgbmFtZSBdID0gZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJdmFyIGlzTWV0aG9kQ2FsbCA9IHR5cGVvZiBvcHRpb25zID09PSAic3RyaW5nIiwKCQkJYXJncyA9IHNsaWNlLmNhbGwoIGFyZ3VtZW50cywgMSApLAoJCQlyZXR1cm5WYWx1ZSA9IHRoaXM7CgoJCS8vIGFsbG93IG11bHRpcGxlIGhhc2hlcyB0byBiZSBwYXNzZWQgb24gaW5pdAoJCW9wdGlvbnMgPSAhaXNNZXRob2RDYWxsICYmIGFyZ3MubGVuZ3RoID8KCQkJJC53aWRnZXQuZXh0ZW5kLmFwcGx5KCBudWxsLCBbIG9wdGlvbnMgXS5jb25jYXQoYXJncykgKSA6CgkJCW9wdGlvbnM7CgoJCWlmICggaXNNZXRob2RDYWxsICkgewoJCQl0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgkJCQl2YXIgbWV0aG9kVmFsdWUsCgkJCQkJaW5zdGFuY2UgPSAkLmRhdGEoIHRoaXMsIGZ1bGxOYW1lICk7CgkJCQlpZiAoICFpbnN0YW5jZSApIHsKCQkJCQlyZXR1cm4gJC5lcnJvciggImNhbm5vdCBjYWxsIG1ldGhvZHMgb24gIiArIG5hbWUgKyAiIHByaW9yIHRvIGluaXRpYWxpemF0aW9uOyAiICsKCQkJCQkJImF0dGVtcHRlZCB0byBjYWxsIG1ldGhvZCAnIiArIG9wdGlvbnMgKyAiJyIgKTsKCQkJCX0KCQkJCWlmICggISQuaXNGdW5jdGlvbiggaW5zdGFuY2Vbb3B0aW9uc10gKSB8fCBvcHRpb25zLmNoYXJBdCggMCApID09PSAiXyIgKSB7CgkJCQkJcmV0dXJuICQuZXJyb3IoICJubyBzdWNoIG1ldGhvZCAnIiArIG9wdGlvbnMgKyAiJyBmb3IgIiArIG5hbWUgKyAiIHdpZGdldCBpbnN0YW5jZSIgKTsKCQkJCX0KCQkJCW1ldGhvZFZhbHVlID0gaW5zdGFuY2VbIG9wdGlvbnMgXS5hcHBseSggaW5zdGFuY2UsIGFyZ3MgKTsKCQkJCWlmICggbWV0aG9kVmFsdWUgIT09IGluc3RhbmNlICYmIG1ldGhvZFZhbHVlICE9PSB1bmRlZmluZWQgKSB7CgkJCQkJcmV0dXJuVmFsdWUgPSBtZXRob2RWYWx1ZSAmJiBtZXRob2RWYWx1ZS5qcXVlcnkgPwoJCQkJCQlyZXR1cm5WYWx1ZS5wdXNoU3RhY2soIG1ldGhvZFZhbHVlLmdldCgpICkgOgoJCQkJCQltZXRob2RWYWx1ZTsKCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQl9CgkJCX0pOwoJCX0gZWxzZSB7CgkJCXRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJCXZhciBpbnN0YW5jZSA9ICQuZGF0YSggdGhpcywgZnVsbE5hbWUgKTsKCQkJCWlmICggaW5zdGFuY2UgKSB7CgkJCQkJaW5zdGFuY2Uub3B0aW9uKCBvcHRpb25zIHx8IHt9ICkuX2luaXQoKTsKCQkJCX0gZWxzZSB7CgkJCQkJbmV3IG9iamVjdCggb3B0aW9ucywgdGhpcyApOwoJCQkJfQoJCQl9KTsKCQl9CgoJCXJldHVybiByZXR1cm5WYWx1ZTsKCX07Cn07CgokLldpZGdldCA9IGZ1bmN0aW9uKCBvcHRpb25zLCBlbGVtZW50ICkge307CiQuV2lkZ2V0Ll9jaGlsZENvbnN0cnVjdG9ycyA9IFtdOwoKJC5XaWRnZXQucHJvdG90eXBlID0gewoJd2lkZ2V0TmFtZTogIndpZGdldCIsCgl3aWRnZXRFdmVudFByZWZpeDogIiIsCglkZWZhdWx0RWxlbWVudDogIjxkaXY+IiwKCW9wdGlvbnM6IHsKCQlkaXNhYmxlZDogZmFsc2UsCgoJCS8vIGNhbGxiYWNrcwoJCWNyZWF0ZTogbnVsbAoJfSwKCV9jcmVhdGVXaWRnZXQ6IGZ1bmN0aW9uKCBvcHRpb25zLCBlbGVtZW50ICkgewoJCWVsZW1lbnQgPSAkKCBlbGVtZW50IHx8IHRoaXMuZGVmYXVsdEVsZW1lbnQgfHwgdGhpcyApWyAwIF07CgkJdGhpcy5lbGVtZW50ID0gJCggZWxlbWVudCApOwoJCXRoaXMudXVpZCA9IHV1aWQrKzsKCQl0aGlzLmV2ZW50TmFtZXNwYWNlID0gIi4iICsgdGhpcy53aWRnZXROYW1lICsgdGhpcy51dWlkOwoJCXRoaXMub3B0aW9ucyA9ICQud2lkZ2V0LmV4dGVuZCgge30sCgkJCXRoaXMub3B0aW9ucywKCQkJdGhpcy5fZ2V0Q3JlYXRlT3B0aW9ucygpLAoJCQlvcHRpb25zICk7CgoJCXRoaXMuYmluZGluZ3MgPSAkKCk7CgkJdGhpcy5ob3ZlcmFibGUgPSAkKCk7CgkJdGhpcy5mb2N1c2FibGUgPSAkKCk7CgoJCWlmICggZWxlbWVudCAhPT0gdGhpcyApIHsKCQkJLy8gMS45IEJDIGZvciAjNzgxMAoJCQkvLyBUT0RPIHJlbW92ZSBkdWFsIHN0b3JhZ2UKCQkJJC5kYXRhKCBlbGVtZW50LCB0aGlzLndpZGdldE5hbWUsIHRoaXMgKTsKCQkJJC5kYXRhKCBlbGVtZW50LCB0aGlzLndpZGdldEZ1bGxOYW1lLCB0aGlzICk7CgkJCXRoaXMuX29uKHsgcmVtb3ZlOiAiZGVzdHJveSIgfSk7CgkJCXRoaXMuZG9jdW1lbnQgPSAkKCBlbGVtZW50LnN0eWxlID8KCQkJCS8vIGVsZW1lbnQgd2l0aGluIHRoZSBkb2N1bWVudAoJCQkJZWxlbWVudC5vd25lckRvY3VtZW50IDoKCQkJCS8vIGVsZW1lbnQgaXMgd2luZG93IG9yIGRvY3VtZW50CgkJCQllbGVtZW50LmRvY3VtZW50IHx8IGVsZW1lbnQgKTsKCQkJdGhpcy53aW5kb3cgPSAkKCB0aGlzLmRvY3VtZW50WzBdLmRlZmF1bHRWaWV3IHx8IHRoaXMuZG9jdW1lbnRbMF0ucGFyZW50V2luZG93ICk7CgkJfQoKCQl0aGlzLl9jcmVhdGUoKTsKCQl0aGlzLl90cmlnZ2VyKCAiY3JlYXRlIiwgbnVsbCwgdGhpcy5fZ2V0Q3JlYXRlRXZlbnREYXRhKCkgKTsKCQl0aGlzLl9pbml0KCk7Cgl9LAoJX2dldENyZWF0ZU9wdGlvbnM6ICQubm9vcCwKCV9nZXRDcmVhdGVFdmVudERhdGE6ICQubm9vcCwKCV9jcmVhdGU6ICQubm9vcCwKCV9pbml0OiAkLm5vb3AsCgoJZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJdGhpcy5fZGVzdHJveSgpOwoJCS8vIHdlIGNhbiBwcm9iYWJseSByZW1vdmUgdGhlIHVuYmluZCBjYWxscyBpbiAyLjAKCQkvLyBhbGwgZXZlbnQgYmluZGluZ3Mgc2hvdWxkIGdvIHRocm91Z2ggdGhpcy5fb24oKQoJCXRoaXMuZWxlbWVudAoJCQkudW5iaW5kKCB0aGlzLmV2ZW50TmFtZXNwYWNlICkKCQkJLy8gMS45IEJDIGZvciAjNzgxMAoJCQkvLyBUT0RPIHJlbW92ZSBkdWFsIHN0b3JhZ2UKCQkJLnJlbW92ZURhdGEoIHRoaXMud2lkZ2V0TmFtZSApCgkJCS5yZW1vdmVEYXRhKCB0aGlzLndpZGdldEZ1bGxOYW1lICkKCQkJLy8gc3VwcG9ydDoganF1ZXJ5IDwxLjYuMwoJCQkvLyBodHRwOi8vYnVncy5qcXVlcnkuY29tL3RpY2tldC85NDEzCgkJCS5yZW1vdmVEYXRhKCAkLmNhbWVsQ2FzZSggdGhpcy53aWRnZXRGdWxsTmFtZSApICk7CgkJdGhpcy53aWRnZXQoKQoJCQkudW5iaW5kKCB0aGlzLmV2ZW50TmFtZXNwYWNlICkKCQkJLnJlbW92ZUF0dHIoICJhcmlhLWRpc2FibGVkIiApCgkJCS5yZW1vdmVDbGFzcygKCQkJCXRoaXMud2lkZ2V0RnVsbE5hbWUgKyAiLWRpc2FibGVkICIgKwoJCQkJInVpLXN0YXRlLWRpc2FibGVkIiApOwoKCQkvLyBjbGVhbiB1cCBldmVudHMgYW5kIHN0YXRlcwoJCXRoaXMuYmluZGluZ3MudW5iaW5kKCB0aGlzLmV2ZW50TmFtZXNwYWNlICk7CgkJdGhpcy5ob3ZlcmFibGUucmVtb3ZlQ2xhc3MoICJ1aS1zdGF0ZS1ob3ZlciIgKTsKCQl0aGlzLmZvY3VzYWJsZS5yZW1vdmVDbGFzcyggInVpLXN0YXRlLWZvY3VzIiApOwoJfSwKCV9kZXN0cm95OiAkLm5vb3AsCgoJd2lkZ2V0OiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5lbGVtZW50OwoJfSwKCglvcHRpb246IGZ1bmN0aW9uKCBrZXksIHZhbHVlICkgewoJCXZhciBvcHRpb25zID0ga2V5LAoJCQlwYXJ0cywKCQkJY3VyT3B0aW9uLAoJCQlpOwoKCQlpZiAoIGFyZ3VtZW50cy5sZW5ndGggPT09IDAgKSB7CgkJCS8vIGRvbid0IHJldHVybiBhIHJlZmVyZW5jZSB0byB0aGUgaW50ZXJuYWwgaGFzaAoJCQlyZXR1cm4gJC53aWRnZXQuZXh0ZW5kKCB7fSwgdGhpcy5vcHRpb25zICk7CgkJfQoKCQlpZiAoIHR5cGVvZiBrZXkgPT09ICJzdHJpbmciICkgewoJCQkvLyBoYW5kbGUgbmVzdGVkIGtleXMsIGUuZy4sICJmb28uYmFyIiA9PiB7IGZvbzogeyBiYXI6IF9fXyB9IH0KCQkJb3B0aW9ucyA9IHt9OwoJCQlwYXJ0cyA9IGtleS5zcGxpdCggIi4iICk7CgkJCWtleSA9IHBhcnRzLnNoaWZ0KCk7CgkJCWlmICggcGFydHMubGVuZ3RoICkgewoJCQkJY3VyT3B0aW9uID0gb3B0aW9uc1sga2V5IF0gPSAkLndpZGdldC5leHRlbmQoIHt9LCB0aGlzLm9wdGlvbnNbIGtleSBdICk7CgkJCQlmb3IgKCBpID0gMDsgaSA8IHBhcnRzLmxlbmd0aCAtIDE7IGkrKyApIHsKCQkJCQljdXJPcHRpb25bIHBhcnRzWyBpIF0gXSA9IGN1ck9wdGlvblsgcGFydHNbIGkgXSBdIHx8IHt9OwoJCQkJCWN1ck9wdGlvbiA9IGN1ck9wdGlvblsgcGFydHNbIGkgXSBdOwoJCQkJfQoJCQkJa2V5ID0gcGFydHMucG9wKCk7CgkJCQlpZiAoIHZhbHVlID09PSB1bmRlZmluZWQgKSB7CgkJCQkJcmV0dXJuIGN1ck9wdGlvblsga2V5IF0gPT09IHVuZGVmaW5lZCA/IG51bGwgOiBjdXJPcHRpb25bIGtleSBdOwoJCQkJfQoJCQkJY3VyT3B0aW9uWyBrZXkgXSA9IHZhbHVlOwoJCQl9IGVsc2UgewoJCQkJaWYgKCB2YWx1ZSA9PT0gdW5kZWZpbmVkICkgewoJCQkJCXJldHVybiB0aGlzLm9wdGlvbnNbIGtleSBdID09PSB1bmRlZmluZWQgPyBudWxsIDogdGhpcy5vcHRpb25zWyBrZXkgXTsKCQkJCX0KCQkJCW9wdGlvbnNbIGtleSBdID0gdmFsdWU7CgkJCX0KCQl9CgoJCXRoaXMuX3NldE9wdGlvbnMoIG9wdGlvbnMgKTsKCgkJcmV0dXJuIHRoaXM7Cgl9LAoJX3NldE9wdGlvbnM6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCXZhciBrZXk7CgoJCWZvciAoIGtleSBpbiBvcHRpb25zICkgewoJCQl0aGlzLl9zZXRPcHRpb24oIGtleSwgb3B0aW9uc1sga2V5IF0gKTsKCQl9CgoJCXJldHVybiB0aGlzOwoJfSwKCV9zZXRPcHRpb246IGZ1bmN0aW9uKCBrZXksIHZhbHVlICkgewoJCXRoaXMub3B0aW9uc1sga2V5IF0gPSB2YWx1ZTsKCgkJaWYgKCBrZXkgPT09ICJkaXNhYmxlZCIgKSB7CgkJCXRoaXMud2lkZ2V0KCkKCQkJCS50b2dnbGVDbGFzcyggdGhpcy53aWRnZXRGdWxsTmFtZSArICItZGlzYWJsZWQgdWktc3RhdGUtZGlzYWJsZWQiLCAhIXZhbHVlICkKCQkJCS5hdHRyKCAiYXJpYS1kaXNhYmxlZCIsIHZhbHVlICk7CgkJCXRoaXMuaG92ZXJhYmxlLnJlbW92ZUNsYXNzKCAidWktc3RhdGUtaG92ZXIiICk7CgkJCXRoaXMuZm9jdXNhYmxlLnJlbW92ZUNsYXNzKCAidWktc3RhdGUtZm9jdXMiICk7CgkJfQoKCQlyZXR1cm4gdGhpczsKCX0sCgoJZW5hYmxlOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5fc2V0T3B0aW9uKCAiZGlzYWJsZWQiLCBmYWxzZSApOwoJfSwKCWRpc2FibGU6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLl9zZXRPcHRpb24oICJkaXNhYmxlZCIsIHRydWUgKTsKCX0sCgoJX29uOiBmdW5jdGlvbiggZWxlbWVudCwgaGFuZGxlcnMgKSB7CgkJLy8gbm8gZWxlbWVudCBhcmd1bWVudCwgc2h1ZmZsZSBhbmQgdXNlIHRoaXMuZWxlbWVudAoJCWlmICggIWhhbmRsZXJzICkgewoJCQloYW5kbGVycyA9IGVsZW1lbnQ7CgkJCWVsZW1lbnQgPSB0aGlzLmVsZW1lbnQ7CgkJfSBlbHNlIHsKCQkJLy8gYWNjZXB0IHNlbGVjdG9ycywgRE9NIGVsZW1lbnRzCgkJCWVsZW1lbnQgPSAkKCBlbGVtZW50ICk7CgkJCXRoaXMuYmluZGluZ3MgPSB0aGlzLmJpbmRpbmdzLmFkZCggZWxlbWVudCApOwoJCX0KCgkJdmFyIGluc3RhbmNlID0gdGhpczsKCQkkLmVhY2goIGhhbmRsZXJzLCBmdW5jdGlvbiggZXZlbnQsIGhhbmRsZXIgKSB7CgkJCWZ1bmN0aW9uIGhhbmRsZXJQcm94eSgpIHsKCQkJCS8vIGFsbG93IHdpZGdldHMgdG8gY3VzdG9taXplIHRoZSBkaXNhYmxlZCBoYW5kbGluZwoJCQkJLy8gLSBkaXNhYmxlZCBhcyBhbiBhcnJheSBpbnN0ZWFkIG9mIGJvb2xlYW4KCQkJCS8vIC0gZGlzYWJsZWQgY2xhc3MgYXMgbWV0aG9kIGZvciBkaXNhYmxpbmcgaW5kaXZpZHVhbCBwYXJ0cwoJCQkJaWYgKCBpbnN0YW5jZS5vcHRpb25zLmRpc2FibGVkID09PSB0cnVlIHx8CgkJCQkJCSQoIHRoaXMgKS5oYXNDbGFzcyggInVpLXN0YXRlLWRpc2FibGVkIiApICkgewoJCQkJCXJldHVybjsKCQkJCX0KCQkJCXJldHVybiAoIHR5cGVvZiBoYW5kbGVyID09PSAic3RyaW5nIiA/IGluc3RhbmNlWyBoYW5kbGVyIF0gOiBoYW5kbGVyICkKCQkJCQkuYXBwbHkoIGluc3RhbmNlLCBhcmd1bWVudHMgKTsKCQkJfQoKCQkJLy8gY29weSB0aGUgZ3VpZCBzbyBkaXJlY3QgdW5iaW5kaW5nIHdvcmtzCgkJCWlmICggdHlwZW9mIGhhbmRsZXIgIT09ICJzdHJpbmciICkgewoJCQkJaGFuZGxlclByb3h5Lmd1aWQgPSBoYW5kbGVyLmd1aWQgPQoJCQkJCWhhbmRsZXIuZ3VpZCB8fCBoYW5kbGVyUHJveHkuZ3VpZCB8fCAkLmd1aWQrKzsKCQkJfQoKCQkJdmFyIG1hdGNoID0gZXZlbnQubWF0Y2goIC9eKFx3KylccyooLiopJC8gKSwKCQkJCWV2ZW50TmFtZSA9IG1hdGNoWzFdICsgaW5zdGFuY2UuZXZlbnROYW1lc3BhY2UsCgkJCQlzZWxlY3RvciA9IG1hdGNoWzJdOwoJCQlpZiAoIHNlbGVjdG9yICkgewoJCQkJaW5zdGFuY2Uud2lkZ2V0KCkuZGVsZWdhdGUoIHNlbGVjdG9yLCBldmVudE5hbWUsIGhhbmRsZXJQcm94eSApOwoJCQl9IGVsc2UgewoJCQkJZWxlbWVudC5iaW5kKCBldmVudE5hbWUsIGhhbmRsZXJQcm94eSApOwoJCQl9CgkJfSk7Cgl9LAoKCV9vZmY6IGZ1bmN0aW9uKCBlbGVtZW50LCBldmVudE5hbWUgKSB7CgkJZXZlbnROYW1lID0gKGV2ZW50TmFtZSB8fCAiIikuc3BsaXQoICIgIiApLmpvaW4oIHRoaXMuZXZlbnROYW1lc3BhY2UgKyAiICIgKSArIHRoaXMuZXZlbnROYW1lc3BhY2U7CgkJZWxlbWVudC51bmJpbmQoIGV2ZW50TmFtZSApLnVuZGVsZWdhdGUoIGV2ZW50TmFtZSApOwoJfSwKCglfZGVsYXk6IGZ1bmN0aW9uKCBoYW5kbGVyLCBkZWxheSApIHsKCQlmdW5jdGlvbiBoYW5kbGVyUHJveHkoKSB7CgkJCXJldHVybiAoIHR5cGVvZiBoYW5kbGVyID09PSAic3RyaW5nIiA/IGluc3RhbmNlWyBoYW5kbGVyIF0gOiBoYW5kbGVyICkKCQkJCS5hcHBseSggaW5zdGFuY2UsIGFyZ3VtZW50cyApOwoJCX0KCQl2YXIgaW5zdGFuY2UgPSB0aGlzOwoJCXJldHVybiBzZXRUaW1lb3V0KCBoYW5kbGVyUHJveHksIGRlbGF5IHx8IDAgKTsKCX0sCgoJX2hvdmVyYWJsZTogZnVuY3Rpb24oIGVsZW1lbnQgKSB7CgkJdGhpcy5ob3ZlcmFibGUgPSB0aGlzLmhvdmVyYWJsZS5hZGQoIGVsZW1lbnQgKTsKCQl0aGlzLl9vbiggZWxlbWVudCwgewoJCQltb3VzZWVudGVyOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkkKCBldmVudC5jdXJyZW50VGFyZ2V0ICkuYWRkQ2xhc3MoICJ1aS1zdGF0ZS1ob3ZlciIgKTsKCQkJfSwKCQkJbW91c2VsZWF2ZTogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJJCggZXZlbnQuY3VycmVudFRhcmdldCApLnJlbW92ZUNsYXNzKCAidWktc3RhdGUtaG92ZXIiICk7CgkJCX0KCQl9KTsKCX0sCgoJX2ZvY3VzYWJsZTogZnVuY3Rpb24oIGVsZW1lbnQgKSB7CgkJdGhpcy5mb2N1c2FibGUgPSB0aGlzLmZvY3VzYWJsZS5hZGQoIGVsZW1lbnQgKTsKCQl0aGlzLl9vbiggZWxlbWVudCwgewoJCQlmb2N1c2luOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkkKCBldmVudC5jdXJyZW50VGFyZ2V0ICkuYWRkQ2xhc3MoICJ1aS1zdGF0ZS1mb2N1cyIgKTsKCQkJfSwKCQkJZm9jdXNvdXQ6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCSQoIGV2ZW50LmN1cnJlbnRUYXJnZXQgKS5yZW1vdmVDbGFzcyggInVpLXN0YXRlLWZvY3VzIiApOwoJCQl9CgkJfSk7Cgl9LAoKCV90cmlnZ2VyOiBmdW5jdGlvbiggdHlwZSwgZXZlbnQsIGRhdGEgKSB7CgkJdmFyIHByb3AsIG9yaWcsCgkJCWNhbGxiYWNrID0gdGhpcy5vcHRpb25zWyB0eXBlIF07CgoJCWRhdGEgPSBkYXRhIHx8IHt9OwoJCWV2ZW50ID0gJC5FdmVudCggZXZlbnQgKTsKCQlldmVudC50eXBlID0gKCB0eXBlID09PSB0aGlzLndpZGdldEV2ZW50UHJlZml4ID8KCQkJdHlwZSA6CgkJCXRoaXMud2lkZ2V0RXZlbnRQcmVmaXggKyB0eXBlICkudG9Mb3dlckNhc2UoKTsKCQkvLyB0aGUgb3JpZ2luYWwgZXZlbnQgbWF5IGNvbWUgZnJvbSBhbnkgZWxlbWVudAoJCS8vIHNvIHdlIG5lZWQgdG8gcmVzZXQgdGhlIHRhcmdldCBvbiB0aGUgbmV3IGV2ZW50CgkJZXZlbnQudGFyZ2V0ID0gdGhpcy5lbGVtZW50WyAwIF07CgoJCS8vIGNvcHkgb3JpZ2luYWwgZXZlbnQgcHJvcGVydGllcyBvdmVyIHRvIHRoZSBuZXcgZXZlbnQKCQlvcmlnID0gZXZlbnQub3JpZ2luYWxFdmVudDsKCQlpZiAoIG9yaWcgKSB7CgkJCWZvciAoIHByb3AgaW4gb3JpZyApIHsKCQkJCWlmICggISggcHJvcCBpbiBldmVudCApICkgewoJCQkJCWV2ZW50WyBwcm9wIF0gPSBvcmlnWyBwcm9wIF07CgkJCQl9CgkJCX0KCQl9CgoJCXRoaXMuZWxlbWVudC50cmlnZ2VyKCBldmVudCwgZGF0YSApOwoJCXJldHVybiAhKCAkLmlzRnVuY3Rpb24oIGNhbGxiYWNrICkgJiYKCQkJY2FsbGJhY2suYXBwbHkoIHRoaXMuZWxlbWVudFswXSwgWyBldmVudCBdLmNvbmNhdCggZGF0YSApICkgPT09IGZhbHNlIHx8CgkJCWV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICk7Cgl9Cn07CgokLmVhY2goIHsgc2hvdzogImZhZGVJbiIsIGhpZGU6ICJmYWRlT3V0IiB9LCBmdW5jdGlvbiggbWV0aG9kLCBkZWZhdWx0RWZmZWN0ICkgewoJJC5XaWRnZXQucHJvdG90eXBlWyAiXyIgKyBtZXRob2QgXSA9IGZ1bmN0aW9uKCBlbGVtZW50LCBvcHRpb25zLCBjYWxsYmFjayApIHsKCQlpZiAoIHR5cGVvZiBvcHRpb25zID09PSAic3RyaW5nIiApIHsKCQkJb3B0aW9ucyA9IHsgZWZmZWN0OiBvcHRpb25zIH07CgkJfQoJCXZhciBoYXNPcHRpb25zLAoJCQllZmZlY3ROYW1lID0gIW9wdGlvbnMgPwoJCQkJbWV0aG9kIDoKCQkJCW9wdGlvbnMgPT09IHRydWUgfHwgdHlwZW9mIG9wdGlvbnMgPT09ICJudW1iZXIiID8KCQkJCQlkZWZhdWx0RWZmZWN0IDoKCQkJCQlvcHRpb25zLmVmZmVjdCB8fCBkZWZhdWx0RWZmZWN0OwoJCW9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoJCWlmICggdHlwZW9mIG9wdGlvbnMgPT09ICJudW1iZXIiICkgewoJCQlvcHRpb25zID0geyBkdXJhdGlvbjogb3B0aW9ucyB9OwoJCX0KCQloYXNPcHRpb25zID0gISQuaXNFbXB0eU9iamVjdCggb3B0aW9ucyApOwoJCW9wdGlvbnMuY29tcGxldGUgPSBjYWxsYmFjazsKCQlpZiAoIG9wdGlvbnMuZGVsYXkgKSB7CgkJCWVsZW1lbnQuZGVsYXkoIG9wdGlvbnMuZGVsYXkgKTsKCQl9CgkJaWYgKCBoYXNPcHRpb25zICYmICQuZWZmZWN0cyAmJiAoICQuZWZmZWN0cy5lZmZlY3RbIGVmZmVjdE5hbWUgXSB8fCAkLnVpQmFja0NvbXBhdCAhPT0gZmFsc2UgJiYgJC5lZmZlY3RzWyBlZmZlY3ROYW1lIF0gKSApIHsKCQkJZWxlbWVudFsgbWV0aG9kIF0oIG9wdGlvbnMgKTsKCQl9IGVsc2UgaWYgKCBlZmZlY3ROYW1lICE9PSBtZXRob2QgJiYgZWxlbWVudFsgZWZmZWN0TmFtZSBdICkgewoJCQllbGVtZW50WyBlZmZlY3ROYW1lIF0oIG9wdGlvbnMuZHVyYXRpb24sIG9wdGlvbnMuZWFzaW5nLCBjYWxsYmFjayApOwoJCX0gZWxzZSB7CgkJCWVsZW1lbnQucXVldWUoZnVuY3Rpb24oIG5leHQgKSB7CgkJCQkkKCB0aGlzIClbIG1ldGhvZCBdKCk7CgkJCQlpZiAoIGNhbGxiYWNrICkgewoJCQkJCWNhbGxiYWNrLmNhbGwoIGVsZW1lbnRbIDAgXSApOwoJCQkJfQoJCQkJbmV4dCgpOwoJCQl9KTsKCQl9Cgl9Owp9KTsKCi8vIERFUFJFQ0FURUQKaWYgKCAkLnVpQmFja0NvbXBhdCAhPT0gZmFsc2UgKSB7CgkkLldpZGdldC5wcm90b3R5cGUuX2dldENyZWF0ZU9wdGlvbnMgPSBmdW5jdGlvbigpIHsKCQlyZXR1cm4gJC5tZXRhZGF0YSAmJiAkLm1ldGFkYXRhLmdldCggdGhpcy5lbGVtZW50WzBdIClbIHRoaXMud2lkZ2V0TmFtZSBdOwoJfTsKfQoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS53aWRnZXQiLCB7CgkvLyBkZWNvcmF0ZSB0aGUgcGFyZW50IF9jcmVhdGVXaWRnZXQgdG8gdHJpZ2dlciBgd2lkZ2V0aW5pdGAgZm9yIHVzZXJzCgkvLyB3aG8gd2lzaCB0byBkbyBwb3N0IHBvc3QgYHdpZGdldGNyZWF0ZWAgYWx0ZXJhdGlvbnMvYWRkaXRpb25zCgkvLwoJLy8gVE9ETyBjcmVhdGUgYSBwdWxsIHJlcXVlc3QgZm9yIGpxdWVyeSB1aSB0byB0cmlnZ2VyIHRoaXMgZXZlbnQKCS8vIGluIHRoZSBvcmlnaW5hbCBfY3JlYXRlV2lkZ2V0CglfY3JlYXRlV2lkZ2V0OiBmdW5jdGlvbigpIHsKCQkkLldpZGdldC5wcm90b3R5cGUuX2NyZWF0ZVdpZGdldC5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgkJdGhpcy5fdHJpZ2dlciggJ2luaXQnICk7Cgl9LAoKCV9nZXRDcmVhdGVPcHRpb25zOiBmdW5jdGlvbigpIHsKCgkJdmFyIGVsZW0gPSB0aGlzLmVsZW1lbnQsCgkJCW9wdGlvbnMgPSB7fTsKCgkJJC5lYWNoKCB0aGlzLm9wdGlvbnMsIGZ1bmN0aW9uKCBvcHRpb24gKSB7CgoJCQl2YXIgdmFsdWUgPSBlbGVtLmpxbURhdGEoIG9wdGlvbi5yZXBsYWNlKCAvW0EtWl0vZywgZnVuY3Rpb24oIGMgKSB7CgkJCQkJCQlyZXR1cm4gIi0iICsgYy50b0xvd2VyQ2FzZSgpOwoJCQkJCQl9KQoJCQkJCSk7CgoJCQlpZiAoIHZhbHVlICE9PSB1bmRlZmluZWQgKSB7CgkJCQlvcHRpb25zWyBvcHRpb24gXSA9IHZhbHVlOwoJCQl9CgkJfSk7CgoJCXJldHVybiBvcHRpb25zOwoJfSwKCgllbmhhbmNlV2l0aGluOiBmdW5jdGlvbiggdGFyZ2V0LCB1c2VLZWVwTmF0aXZlICkgewoJCXRoaXMuZW5oYW5jZSggJCggdGhpcy5vcHRpb25zLmluaXRTZWxlY3RvciwgJCggdGFyZ2V0ICkpLCB1c2VLZWVwTmF0aXZlICk7Cgl9LAoKCWVuaGFuY2U6IGZ1bmN0aW9uKCB0YXJnZXRzLCB1c2VLZWVwTmF0aXZlICkgewoJCXZhciBwYWdlLCBrZWVwTmF0aXZlLCAkd2lkZ2V0RWxlbWVudHMgPSAkKCB0YXJnZXRzICksIHNlbGYgPSB0aGlzOwoKCQkvLyBpZiBpZ25vcmVDb250ZW50RW5hYmxlZCBpcyBzZXQgdG8gdHJ1ZSB0aGUgZnJhbWV3b3JrIHNob3VsZAoJCS8vIG9ubHkgZW5oYW5jZSB0aGUgc2VsZWN0ZWQgZWxlbWVudHMgd2hlbiB0aGV5IGRvIE5PVCBoYXZlIGEKCQkvLyBwYXJlbnQgd2l0aCB0aGUgZGF0YS1uYW1lc3BhY2UtaWdub3JlIGF0dHJpYnV0ZQoJCSR3aWRnZXRFbGVtZW50cyA9ICQubW9iaWxlLmVuaGFuY2VhYmxlKCAkd2lkZ2V0RWxlbWVudHMgKTsKCgkJaWYgKCB1c2VLZWVwTmF0aXZlICYmICR3aWRnZXRFbGVtZW50cy5sZW5ndGggKSB7CgkJCS8vIFRPRE8gcmVtb3ZlIGRlcGVuZGVuY3kgb24gdGhlIHBhZ2Ugd2lkZ2V0IGZvciB0aGUga2VlcE5hdGl2ZS4KCQkJLy8gQ3VycmVudGx5IHRoZSBrZWVwTmF0aXZlIHZhbHVlIGlzIGRlZmluZWQgb24gdGhlIHBhZ2UgcHJvdG90eXBlIHNvCgkJCS8vIHRoZSBtZXRob2QgaXMgYXMgd2VsbAoJCQlwYWdlID0gJC5tb2JpbGUuY2xvc2VzdFBhZ2VEYXRhKCAkd2lkZ2V0RWxlbWVudHMgKTsKCQkJa2VlcE5hdGl2ZSA9ICggcGFnZSAmJiBwYWdlLmtlZXBOYXRpdmVTZWxlY3RvcigpKSB8fCAiIjsKCgkJCSR3aWRnZXRFbGVtZW50cyA9ICR3aWRnZXRFbGVtZW50cy5ub3QoIGtlZXBOYXRpdmUgKTsKCQl9CgoJCSR3aWRnZXRFbGVtZW50c1sgdGhpcy53aWRnZXROYW1lIF0oKTsKCX0sCgoJcmFpc2U6IGZ1bmN0aW9uKCBtc2cgKSB7CgkJdGhyb3cgIldpZGdldCBbIiArIHRoaXMud2lkZ2V0TmFtZSArICJdOiAiICsgbXNnOwoJfQp9KTsKCn0pKCBqUXVlcnkgKTsKCgooZnVuY3Rpb24oICQsIHdpbmRvdyApIHsKCS8vIERFUFJFQ0FURUQKCS8vIE5PVEUgZ2xvYmFsIG1vYmlsZSBvYmplY3Qgc2V0dGluZ3MKCSQuZXh0ZW5kKCAkLm1vYmlsZSwgewoJCS8vIERFUFJFQ0FURUQgU2hvdWxkIHRoZSB0ZXh0IGJlIHZpc2JsZSBpbiB0aGUgbG9hZGluZyBtZXNzYWdlPwoJCWxvYWRpbmdNZXNzYWdlVGV4dFZpc2libGU6IHVuZGVmaW5lZCwKCgkJLy8gREVQUkVDQVRFRCBXaGVuIHRoZSB0ZXh0IGlzIHZpc2libGUsIHdoYXQgdGhlbWUgZG9lcyB0aGUgbG9hZGluZyBib3ggdXNlPwoJCWxvYWRpbmdNZXNzYWdlVGhlbWU6IHVuZGVmaW5lZCwKCgkJLy8gREVQUkVDQVRFRCBkZWZhdWx0IG1lc3NhZ2Ugc2V0dGluZwoJCWxvYWRpbmdNZXNzYWdlOiB1bmRlZmluZWQsCgoJCS8vIERFUFJFQ0FURUQKCQkvLyBUdXJuIG9uL29mZiBwYWdlIGxvYWRpbmcgbWVzc2FnZS4gVGhlbWUgZG91YmxlcyBhcyBhbiBvYmplY3QgYXJndW1lbnQKCQkvLyB3aXRoIHRoZSBmb2xsb3dpbmcgc2hhcGU6IHsgdGhlbWU6ICcnLCB0ZXh0OiAnJywgaHRtbDogJycsIHRleHRWaXNpYmxlOiAnJyB9CgkJLy8gTk9URSB0aGF0IHRoZSAkLm1vYmlsZS5sb2FkaW5nKiBzZXR0aW5ncyBhbmQgcGFyYW1zIHBhc3QgdGhlIGZpcnN0IGFyZSBkZXByZWNhdGVkCgkJc2hvd1BhZ2VMb2FkaW5nTXNnOiBmdW5jdGlvbiggdGhlbWUsIG1zZ1RleHQsIHRleHRvbmx5ICkgewoJCQkkLm1vYmlsZS5sb2FkaW5nKCAnc2hvdycsIHRoZW1lLCBtc2dUZXh0LCB0ZXh0b25seSApOwoJCX0sCgoJCS8vIERFUFJFQ0FURUQKCQloaWRlUGFnZUxvYWRpbmdNc2c6IGZ1bmN0aW9uKCkgewoJCQkkLm1vYmlsZS5sb2FkaW5nKCAnaGlkZScgKTsKCQl9LAoKCQlsb2FkaW5nOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5sb2FkZXJXaWRnZXQubG9hZGVyLmFwcGx5KCB0aGlzLmxvYWRlcldpZGdldCwgYXJndW1lbnRzICk7CgkJfQoJfSk7CgoJLy8gVE9ETyBtb3ZlIGxvYWRlciBjbGFzcyBkb3duIGludG8gdGhlIHdpZGdldCBzZXR0aW5ncwoJdmFyIGxvYWRlckNsYXNzID0gInVpLWxvYWRlciIsICRodG1sID0gJCggImh0bWwiICksICR3aW5kb3cgPSAkKCB3aW5kb3cgKTsKCgkkLndpZGdldCggIm1vYmlsZS5sb2FkZXIiLCB7CgkJLy8gTk9URSBpZiB0aGUgZ2xvYmFsIGNvbmZpZyBzZXR0aW5ncyBhcmUgZGVmaW5lZCB0aGV5IHdpbGwgb3ZlcnJpZGUgdGhlc2UKCQkvLyAgICAgIG9wdGlvbnMKCQlvcHRpb25zOiB7CgkJCS8vIHRoZSB0aGVtZSBmb3IgdGhlIGxvYWRpbmcgbWVzc2FnZQoJCQl0aGVtZTogImEiLAoKCQkJLy8gd2hldGhlciB0aGUgdGV4dCBpbiB0aGUgbG9hZGluZyBtZXNzYWdlIGlzIHNob3duCgkJCXRleHRWaXNpYmxlOiBmYWxzZSwKCgkJCS8vIGN1c3RvbSBodG1sIGZvciB0aGUgaW5uZXIgY29udGVudCBvZiB0aGUgbG9hZGluZyBtZXNzYWdlCgkJCWh0bWw6ICIiLAoKCQkJLy8gdGhlIHRleHQgdG8gYmUgZGlzcGxheWVkIHdoZW4gdGhlIHBvcHVwIGlzIHNob3duCgkJCXRleHQ6ICJsb2FkaW5nIgoJCX0sCgoJCWRlZmF1bHRIdG1sOiAiPGRpdiBjbGFzcz0nIiArIGxvYWRlckNsYXNzICsgIic+IiArCgkJCSI8c3BhbiBjbGFzcz0ndWktaWNvbiB1aS1pY29uLWxvYWRpbmcnPjwvc3Bhbj4iICsKCQkJIjxoMT48L2gxPiIgKwoJCQkiPC9kaXY+IiwKCgkJLy8gRm9yIG5vbi1maXhlZCBzdXBwb3J0aW4gYnJvd3NlcnMuIFBvc2l0aW9uIGF0IHkgY2VudGVyIChpZiBzY3JvbGxUb3Agc3VwcG9ydGVkKSwgYWJvdmUgdGhlIGFjdGl2ZUJ0biAoaWYgZGVmaW5lZCksIG9yIGp1c3QgMTAwcHggZnJvbSB0b3AKCQlmYWtlRml4TG9hZGVyOiBmdW5jdGlvbigpIHsKCQkJdmFyIGFjdGl2ZUJ0biA9ICQoICIuIiArICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICkuZmlyc3QoKTsKCgkJCXRoaXMuZWxlbWVudAoJCQkJLmNzcyh7CgkJCQkJdG9wOiAkLnN1cHBvcnQuc2Nyb2xsVG9wICYmICR3aW5kb3cuc2Nyb2xsVG9wKCkgKyAkd2luZG93LmhlaWdodCgpIC8gMiB8fAoJCQkJCQlhY3RpdmVCdG4ubGVuZ3RoICYmIGFjdGl2ZUJ0bi5vZmZzZXQoKS50b3AgfHwgMTAwCgkJCQl9KTsKCQl9LAoKCQkvLyBjaGVjayBwb3NpdGlvbiBvZiBsb2FkZXIgdG8gc2VlIGlmIGl0IGFwcGVhcnMgdG8gYmUgImZpeGVkIiB0byBjZW50ZXIKCQkvLyBpZiBub3QsIHVzZSBhYnMgcG9zaXRpb25pbmcKCQljaGVja0xvYWRlclBvc2l0aW9uOiBmdW5jdGlvbigpIHsKCQkJdmFyIG9mZnNldCA9IHRoaXMuZWxlbWVudC5vZmZzZXQoKSwKCQkJCXNjcm9sbFRvcCA9ICR3aW5kb3cuc2Nyb2xsVG9wKCksCgkJCQlzY3JlZW5IZWlnaHQgPSAkLm1vYmlsZS5nZXRTY3JlZW5IZWlnaHQoKTsKCgkJCWlmICggb2Zmc2V0LnRvcCA8IHNjcm9sbFRvcCB8fCAoIG9mZnNldC50b3AgLSBzY3JvbGxUb3AgKSA+IHNjcmVlbkhlaWdodCApIHsKCQkJCXRoaXMuZWxlbWVudC5hZGRDbGFzcyggInVpLWxvYWRlci1mYWtlZml4IiApOwoJCQkJdGhpcy5mYWtlRml4TG9hZGVyKCk7CgkJCQkkd2luZG93CgkJCQkJLnVuYmluZCggInNjcm9sbCIsIHRoaXMuY2hlY2tMb2FkZXJQb3NpdGlvbiApCgkJCQkJLmJpbmQoICJzY3JvbGwiLCB0aGlzLmZha2VGaXhMb2FkZXIgKTsKCQkJfQoJCX0sCgoJCXJlc2V0SHRtbDogZnVuY3Rpb24oKSB7CgkJCXRoaXMuZWxlbWVudC5odG1sKCAkKCB0aGlzLmRlZmF1bHRIdG1sICkuaHRtbCgpICk7CgkJfSwKCgkJLy8gVHVybiBvbi9vZmYgcGFnZSBsb2FkaW5nIG1lc3NhZ2UuIFRoZW1lIGRvdWJsZXMgYXMgYW4gb2JqZWN0IGFyZ3VtZW50CgkJLy8gd2l0aCB0aGUgZm9sbG93aW5nIHNoYXBlOiB7IHRoZW1lOiAnJywgdGV4dDogJycsIGh0bWw6ICcnLCB0ZXh0VmlzaWJsZTogJycgfQoJCS8vIE5PVEUgdGhhdCB0aGUgJC5tb2JpbGUubG9hZGluZyogc2V0dGluZ3MgYW5kIHBhcmFtcyBwYXN0IHRoZSBmaXJzdCBhcmUgZGVwcmVjYXRlZAoJCS8vIFRPRE8gc3dlZXQgamVzdXMgd2UgbmVlZCB0byBicmVhayBzb21lIG9mIHRoaXMgb3V0CgkJc2hvdzogZnVuY3Rpb24oIHRoZW1lLCBtc2dUZXh0LCB0ZXh0b25seSApIHsKCQkJdmFyIHRleHRWaXNpYmxlLCBtZXNzYWdlLCAkaGVhZGVyLCBsb2FkU2V0dGluZ3M7CgoJCQl0aGlzLnJlc2V0SHRtbCgpOwoKCQkJLy8gdXNlIHRoZSBwcm90b3R5cGUgb3B0aW9ucyBzbyB0aGF0IHBlb3BsZSBjYW4gc2V0IHRoZW0gZ2xvYmFsbHkgYXQKCQkJLy8gbW9iaWxlIGluaXQuIENvbnNpc3RlbmN5LCBpdCdzIHdoYXQncyBmb3IgZGlubmVyCgkJCWlmICggJC50eXBlKHRoZW1lKSA9PT0gIm9iamVjdCIgKSB7CgkJCQlsb2FkU2V0dGluZ3MgPSAkLmV4dGVuZCgge30sIHRoaXMub3B0aW9ucywgdGhlbWUgKTsKCgkJCQkvLyBwcmVmZXIgb2JqZWN0IHByb3BlcnR5IGZyb20gdGhlIHBhcmFtIHRoZW4gdGhlIG9sZCB0aGVtZSBzZXR0aW5nCgkJCQl0aGVtZSA9IGxvYWRTZXR0aW5ncy50aGVtZSB8fCAkLm1vYmlsZS5sb2FkaW5nTWVzc2FnZVRoZW1lOwoJCQl9IGVsc2UgewoJCQkJbG9hZFNldHRpbmdzID0gdGhpcy5vcHRpb25zOwoKCQkJCS8vIGhlcmUgd2UgcHJlZmVyIHRoZSB0aGVtIHZhbHVlIHBhc3NlZCBhcyBhIHN0cmluZyBhcmd1bWVudCwgdGhlbgoJCQkJLy8gd2UgcHJlZmVyIHRoZSBnbG9iYWwgb3B0aW9uIGJlY2F1c2Ugd2UgY2FuJ3QgdXNlIHVuZGVmaW5lZCBkZWZhdWx0CgkJCQkvLyBwcm90b3R5cGUgb3B0aW9ucywgdGhlbiB0aGUgcHJvdG90eXBlIG9wdGlvbgoJCQkJdGhlbWUgPSB0aGVtZSB8fCAkLm1vYmlsZS5sb2FkaW5nTWVzc2FnZVRoZW1lIHx8IGxvYWRTZXR0aW5ncy50aGVtZTsKCQkJfQoKCQkJLy8gc2V0IHRoZSBtZXNzYWdlIHRleHQsIHByZWZlciB0aGUgcGFyYW0sIHRoZW4gdGhlIHNldHRpbmdzIG9iamVjdAoJCQkvLyB0aGVuIGxvYWRpbmcgbWVzc2FnZQoJCQltZXNzYWdlID0gbXNnVGV4dCB8fCAkLm1vYmlsZS5sb2FkaW5nTWVzc2FnZSB8fCBsb2FkU2V0dGluZ3MudGV4dDsKCgkJCS8vIHByZXBhcmUgdGhlIGRvbQoJCQkkaHRtbC5hZGRDbGFzcyggInVpLWxvYWRpbmciICk7CgoJCQlpZiAoICQubW9iaWxlLmxvYWRpbmdNZXNzYWdlICE9PSBmYWxzZSB8fCBsb2FkU2V0dGluZ3MuaHRtbCApIHsKCQkJCS8vIGJvb2xlYW4gdmFsdWVzIHJlcXVpcmUgYSBiaXQgbW9yZSB3b3JrIDpQLCBzdXBwb3J0cyBvYmplY3QgcHJvcGVydGllcwoJCQkJLy8gYW5kIG9sZCBzZXR0aW5ncwoJCQkJaWYgKCAkLm1vYmlsZS5sb2FkaW5nTWVzc2FnZVRleHRWaXNpYmxlICE9PSB1bmRlZmluZWQgKSB7CgkJCQkJdGV4dFZpc2libGUgPSAkLm1vYmlsZS5sb2FkaW5nTWVzc2FnZVRleHRWaXNpYmxlOwoJCQkJfSBlbHNlIHsKCQkJCQl0ZXh0VmlzaWJsZSA9IGxvYWRTZXR0aW5ncy50ZXh0VmlzaWJsZTsKCQkJCX0KCgkJCQkvLyBhZGQgdGhlIHByb3BlciBjc3MgZ2l2ZW4gdGhlIG9wdGlvbnMgKHRoZW1lLCB0ZXh0LCBldGMpCgkJCQkvLyBGb3JjZSB0ZXh0IHZpc2liaWxpdHkgaWYgdGhlIHNlY29uZCBhcmd1bWVudCB3YXMgc3VwcGxpZWQsIG9yCgkJCQkvLyBpZiB0aGUgdGV4dCB3YXMgZXhwbGljaXRseSBzZXQgaW4gdGhlIG9iamVjdCBhcmdzCgkJCQl0aGlzLmVsZW1lbnQuYXR0cigiY2xhc3MiLCBsb2FkZXJDbGFzcyArCgkJCQkJIiB1aS1jb3JuZXItYWxsIHVpLWJvZHktIiArIHRoZW1lICsKCQkJCQkiIHVpLWxvYWRlci0iICsgKCB0ZXh0VmlzaWJsZSB8fCBtc2dUZXh0IHx8IHRoZW1lLnRleHQgPyAidmVyYm9zZSIgOiAiZGVmYXVsdCIgKSArCgkJCQkJKCBsb2FkU2V0dGluZ3MudGV4dG9ubHkgfHwgdGV4dG9ubHkgPyAiIHVpLWxvYWRlci10ZXh0b25seSIgOiAiIiApICk7CgoJCQkJLy8gVE9ETyB2ZXJpZnkgdGhhdCBqcXVlcnkuZm4uaHRtbCBpcyBvayB0byB1c2UgaW4gYm90aCBjYXNlcyBoZXJlCgkJCQkvLyAgICAgIHRoaXMgbWlnaHQgYmUgb3Zlcmx5IGRlZmVuc2l2ZSBpbiBwcmV2ZW50aW5nIHVua25vd2luZyB4c3MKCQkJCS8vIGlmIHRoZSBodG1sIGF0dHJpYnV0ZSBpcyBkZWZpbmVkIG9uIHRoZSBsb2FkaW5nIHNldHRpbmdzLCB1c2UgdGhhdAoJCQkJLy8gb3RoZXJ3aXNlIHVzZSB0aGUgZmFsbGJhY2tzIGZyb20gYWJvdmUKCQkJCWlmICggbG9hZFNldHRpbmdzLmh0bWwgKSB7CgkJCQkJdGhpcy5lbGVtZW50Lmh0bWwoIGxvYWRTZXR0aW5ncy5odG1sICk7CgkJCQl9IGVsc2UgewoJCQkJCXRoaXMuZWxlbWVudC5maW5kKCAiaDEiICkudGV4dCggbWVzc2FnZSApOwoJCQkJfQoKCQkJCS8vIGF0dGFjaCB0aGUgbG9hZGVyIHRvIHRoZSBET00KCQkJCXRoaXMuZWxlbWVudC5hcHBlbmRUbyggJC5tb2JpbGUucGFnZUNvbnRhaW5lciApOwoKCQkJCS8vIGNoZWNrIHRoYXQgdGhlIGxvYWRlciBpcyB2aXNpYmxlCgkJCQl0aGlzLmNoZWNrTG9hZGVyUG9zaXRpb24oKTsKCgkJCQkvLyBvbiBzY3JvbGwgY2hlY2sgdGhlIGxvYWRlciBwb3NpdGlvbgoJCQkJJHdpbmRvdy5iaW5kKCAic2Nyb2xsIiwgJC5wcm94eSggdGhpcy5jaGVja0xvYWRlclBvc2l0aW9uLCB0aGlzICkgKTsKCQkJfQoJCX0sCgoJCWhpZGU6IGZ1bmN0aW9uKCkgewoJCQkkaHRtbC5yZW1vdmVDbGFzcyggInVpLWxvYWRpbmciICk7CgoJCQlpZiAoICQubW9iaWxlLmxvYWRpbmdNZXNzYWdlICkgewoJCQkJdGhpcy5lbGVtZW50LnJlbW92ZUNsYXNzKCAidWktbG9hZGVyLWZha2VmaXgiICk7CgkJCX0KCgkJCSQoIHdpbmRvdyApLnVuYmluZCggInNjcm9sbCIsICQucHJveHkoIHRoaXMuZmFrZUZpeExvYWRlciwgdGhpcykgKTsKCQkJJCggd2luZG93ICkudW5iaW5kKCAic2Nyb2xsIiwgJC5wcm94eSggdGhpcy5jaGVja0xvYWRlclBvc2l0aW9uLCB0aGlzICkgKTsKCQl9Cgl9KTsKCgkkd2luZG93LmJpbmQoICdwYWdlY29udGFpbmVyY3JlYXRlJywgZnVuY3Rpb24oKSB7CgkJJC5tb2JpbGUubG9hZGVyV2lkZ2V0ID0gJC5tb2JpbGUubG9hZGVyV2lkZ2V0IHx8ICQoICQubW9iaWxlLmxvYWRlci5wcm90b3R5cGUuZGVmYXVsdEh0bWwgKS5sb2FkZXIoKTsKCX0pOwp9KShqUXVlcnksIHRoaXMpOwoKCgovLyBUaGlzIHBsdWdpbiBpcyBhbiBleHBlcmltZW50IGZvciBhYnN0cmFjdGluZyBhd2F5IHRoZSB0b3VjaCBhbmQgbW91c2UKLy8gZXZlbnRzIHNvIHRoYXQgZGV2ZWxvcGVycyBkb24ndCBoYXZlIHRvIHdvcnJ5IGFib3V0IHdoaWNoIG1ldGhvZCBvZiBpbnB1dAovLyB0aGUgZGV2aWNlIHRoZWlyIGRvY3VtZW50IGlzIGxvYWRlZCBvbiBzdXBwb3J0cy4KLy8KLy8gVGhlIGlkZWEgaGVyZSBpcyB0byBhbGxvdyB0aGUgZGV2ZWxvcGVyIHRvIHJlZ2lzdGVyIGxpc3RlbmVycyBmb3IgdGhlCi8vIGJhc2ljIG1vdXNlIGV2ZW50cywgc3VjaCBhcyBtb3VzZWRvd24sIG1vdXNlbW92ZSwgbW91c2V1cCwgYW5kIGNsaWNrLAovLyBhbmQgdGhlIHBsdWdpbiB3aWxsIHRha2UgY2FyZSBvZiByZWdpc3RlcmluZyB0aGUgY29ycmVjdCBsaXN0ZW5lcnMKLy8gYmVoaW5kIHRoZSBzY2VuZXMgdG8gaW52b2tlIHRoZSBsaXN0ZW5lciBhdCB0aGUgZmFzdGVzdCBwb3NzaWJsZSB0aW1lCi8vIGZvciB0aGF0IGRldmljZSwgd2hpbGUgc3RpbGwgcmV0YWluaW5nIHRoZSBvcmRlciBvZiBldmVudCBmaXJpbmcgaW4KLy8gdGhlIHRyYWRpdGlvbmFsIG1vdXNlIGVudmlyb25tZW50LCBzaG91bGQgbXVsdGlwbGUgaGFuZGxlcnMgYmUgcmVnaXN0ZXJlZAovLyBvbiB0aGUgc2FtZSBlbGVtZW50IGZvciBkaWZmZXJlbnQgZXZlbnRzLgovLwovLyBUaGUgY3VycmVudCB2ZXJzaW9uIGV4cG9zZXMgdGhlIGZvbGxvd2luZyB2aXJ0dWFsIGV2ZW50cyB0byBqUXVlcnkgYmluZCBtZXRob2RzOgovLyAidm1vdXNlb3ZlciB2bW91c2Vkb3duIHZtb3VzZW1vdmUgdm1vdXNldXAgdmNsaWNrIHZtb3VzZW91dCB2bW91c2VjYW5jZWwiCgooZnVuY3Rpb24oICQsIHdpbmRvdywgZG9jdW1lbnQsIHVuZGVmaW5lZCApIHsKCnZhciBkYXRhUHJvcGVydHlOYW1lID0gInZpcnR1YWxNb3VzZUJpbmRpbmdzIiwKCXRvdWNoVGFyZ2V0UHJvcGVydHlOYW1lID0gInZpcnR1YWxUb3VjaElEIiwKCXZpcnR1YWxFdmVudE5hbWVzID0gInZtb3VzZW92ZXIgdm1vdXNlZG93biB2bW91c2Vtb3ZlIHZtb3VzZXVwIHZjbGljayB2bW91c2VvdXQgdm1vdXNlY2FuY2VsIi5zcGxpdCggIiAiICksCgl0b3VjaEV2ZW50UHJvcHMgPSAiY2xpZW50WCBjbGllbnRZIHBhZ2VYIHBhZ2VZIHNjcmVlblggc2NyZWVuWSIuc3BsaXQoICIgIiApLAoJbW91c2VIb29rUHJvcHMgPSAkLmV2ZW50Lm1vdXNlSG9va3MgPyAkLmV2ZW50Lm1vdXNlSG9va3MucHJvcHMgOiBbXSwKCW1vdXNlRXZlbnRQcm9wcyA9ICQuZXZlbnQucHJvcHMuY29uY2F0KCBtb3VzZUhvb2tQcm9wcyApLAoJYWN0aXZlRG9jSGFuZGxlcnMgPSB7fSwKCXJlc2V0VGltZXJJRCA9IDAsCglzdGFydFggPSAwLAoJc3RhcnRZID0gMCwKCWRpZFNjcm9sbCA9IGZhbHNlLAoJY2xpY2tCbG9ja0xpc3QgPSBbXSwKCWJsb2NrTW91c2VUcmlnZ2VycyA9IGZhbHNlLAoJYmxvY2tUb3VjaFRyaWdnZXJzID0gZmFsc2UsCglldmVudENhcHR1cmVTdXBwb3J0ZWQgPSAiYWRkRXZlbnRMaXN0ZW5lciIgaW4gZG9jdW1lbnQsCgkkZG9jdW1lbnQgPSAkKCBkb2N1bWVudCApLAoJbmV4dFRvdWNoSUQgPSAxLAoJbGFzdFRvdWNoSUQgPSAwLCB0aHJlc2hvbGQ7CgokLnZtb3VzZSA9IHsKCW1vdmVEaXN0YW5jZVRocmVzaG9sZDogMTAsCgljbGlja0Rpc3RhbmNlVGhyZXNob2xkOiAxMCwKCXJlc2V0VGltZXJEdXJhdGlvbjogMTUwMAp9OwoKZnVuY3Rpb24gZ2V0TmF0aXZlRXZlbnQoIGV2ZW50ICkgewoKCXdoaWxlICggZXZlbnQgJiYgdHlwZW9mIGV2ZW50Lm9yaWdpbmFsRXZlbnQgIT09ICJ1bmRlZmluZWQiICkgewoJCWV2ZW50ID0gZXZlbnQub3JpZ2luYWxFdmVudDsKCX0KCXJldHVybiBldmVudDsKfQoKZnVuY3Rpb24gY3JlYXRlVmlydHVhbEV2ZW50KCBldmVudCwgZXZlbnRUeXBlICkgewoKCXZhciB0ID0gZXZlbnQudHlwZSwKCQlvZSwgcHJvcHMsIG5lLCBwcm9wLCBjdCwgdG91Y2gsIGksIGosIGxlbjsKCglldmVudCA9ICQuRXZlbnQoIGV2ZW50ICk7CglldmVudC50eXBlID0gZXZlbnRUeXBlOwoKCW9lID0gZXZlbnQub3JpZ2luYWxFdmVudDsKCXByb3BzID0gJC5ldmVudC5wcm9wczsKCgkvLyBhZGRyZXNzZXMgc2VwYXJhdGlvbiBvZiAkLmV2ZW50LnByb3BzIGluIHRvICQuZXZlbnQubW91c2VIb29rLnByb3BzIGFuZCBJc3N1ZSAzMjgwCgkvLyBodHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L2pxdWVyeS1tb2JpbGUvaXNzdWVzLzMyODAKCWlmICggdC5zZWFyY2goIC9eKG1vdXNlfGNsaWNrKS8gKSA+IC0xICkgewoJCXByb3BzID0gbW91c2VFdmVudFByb3BzOwoJfQoKCS8vIGNvcHkgb3JpZ2luYWwgZXZlbnQgcHJvcGVydGllcyBvdmVyIHRvIHRoZSBuZXcgZXZlbnQKCS8vIHRoaXMgd291bGQgaGFwcGVuIGlmIHdlIGNvdWxkIGNhbGwgJC5ldmVudC5maXggaW5zdGVhZCBvZiAkLkV2ZW50CgkvLyBidXQgd2UgZG9uJ3QgaGF2ZSBhIHdheSB0byBmb3JjZSBhbiBldmVudCB0byBiZSBmaXhlZCBtdWx0aXBsZSB0aW1lcwoJaWYgKCBvZSApIHsKCQlmb3IgKCBpID0gcHJvcHMubGVuZ3RoLCBwcm9wOyBpOyApIHsKCQkJcHJvcCA9IHByb3BzWyAtLWkgXTsKCQkJZXZlbnRbIHByb3AgXSA9IG9lWyBwcm9wIF07CgkJfQoJfQoKCS8vIG1ha2Ugc3VyZSB0aGF0IGlmIHRoZSBtb3VzZSBhbmQgY2xpY2sgdmlydHVhbCBldmVudHMgYXJlIGdlbmVyYXRlZAoJLy8gd2l0aG91dCBhIC53aGljaCBvbmUgaXMgZGVmaW5lZAoJaWYgKCB0LnNlYXJjaCgvbW91c2UoZG93bnx1cCl8Y2xpY2svKSA+IC0xICYmICFldmVudC53aGljaCApIHsKCQlldmVudC53aGljaCA9IDE7Cgl9CgoJaWYgKCB0LnNlYXJjaCgvXnRvdWNoLykgIT09IC0xICkgewoJCW5lID0gZ2V0TmF0aXZlRXZlbnQoIG9lICk7CgkJdCA9IG5lLnRvdWNoZXM7CgkJY3QgPSBuZS5jaGFuZ2VkVG91Y2hlczsKCQl0b3VjaCA9ICggdCAmJiB0Lmxlbmd0aCApID8gdFswXSA6ICggKCBjdCAmJiBjdC5sZW5ndGggKSA/IGN0WyAwIF0gOiB1bmRlZmluZWQgKTsKCgkJaWYgKCB0b3VjaCApIHsKCQkJZm9yICggaiA9IDAsIGxlbiA9IHRvdWNoRXZlbnRQcm9wcy5sZW5ndGg7IGogPCBsZW47IGorKykgewoJCQkJcHJvcCA9IHRvdWNoRXZlbnRQcm9wc1sgaiBdOwoJCQkJZXZlbnRbIHByb3AgXSA9IHRvdWNoWyBwcm9wIF07CgkJCX0KCQl9Cgl9CgoJcmV0dXJuIGV2ZW50Owp9CgpmdW5jdGlvbiBnZXRWaXJ0dWFsQmluZGluZ0ZsYWdzKCBlbGVtZW50ICkgewoKCXZhciBmbGFncyA9IHt9LAoJCWIsIGs7CgoJd2hpbGUgKCBlbGVtZW50ICkgewoKCQliID0gJC5kYXRhKCBlbGVtZW50LCBkYXRhUHJvcGVydHlOYW1lICk7CgoJCWZvciAoICBrIGluIGIgKSB7CgkJCWlmICggYlsgayBdICkgewoJCQkJZmxhZ3NbIGsgXSA9IGZsYWdzLmhhc1ZpcnR1YWxCaW5kaW5nID0gdHJ1ZTsKCQkJfQoJCX0KCQllbGVtZW50ID0gZWxlbWVudC5wYXJlbnROb2RlOwoJfQoJcmV0dXJuIGZsYWdzOwp9CgpmdW5jdGlvbiBnZXRDbG9zZXN0RWxlbWVudFdpdGhWaXJ0dWFsQmluZGluZyggZWxlbWVudCwgZXZlbnRUeXBlICkgewoJdmFyIGI7Cgl3aGlsZSAoIGVsZW1lbnQgKSB7CgoJCWIgPSAkLmRhdGEoIGVsZW1lbnQsIGRhdGFQcm9wZXJ0eU5hbWUgKTsKCgkJaWYgKCBiICYmICggIWV2ZW50VHlwZSB8fCBiWyBldmVudFR5cGUgXSApICkgewoJCQlyZXR1cm4gZWxlbWVudDsKCQl9CgkJZWxlbWVudCA9IGVsZW1lbnQucGFyZW50Tm9kZTsKCX0KCXJldHVybiBudWxsOwp9CgpmdW5jdGlvbiBlbmFibGVUb3VjaEJpbmRpbmdzKCkgewoJYmxvY2tUb3VjaFRyaWdnZXJzID0gZmFsc2U7Cn0KCmZ1bmN0aW9uIGRpc2FibGVUb3VjaEJpbmRpbmdzKCkgewoJYmxvY2tUb3VjaFRyaWdnZXJzID0gdHJ1ZTsKfQoKZnVuY3Rpb24gZW5hYmxlTW91c2VCaW5kaW5ncygpIHsKCWxhc3RUb3VjaElEID0gMDsKCWNsaWNrQmxvY2tMaXN0Lmxlbmd0aCA9IDA7CglibG9ja01vdXNlVHJpZ2dlcnMgPSBmYWxzZTsKCgkvLyBXaGVuIG1vdXNlIGJpbmRpbmdzIGFyZSBlbmFibGVkLCBvdXIKCS8vIHRvdWNoIGJpbmRpbmdzIGFyZSBkaXNhYmxlZC4KCWRpc2FibGVUb3VjaEJpbmRpbmdzKCk7Cn0KCmZ1bmN0aW9uIGRpc2FibGVNb3VzZUJpbmRpbmdzKCkgewoJLy8gV2hlbiBtb3VzZSBiaW5kaW5ncyBhcmUgZGlzYWJsZWQsIG91cgoJLy8gdG91Y2ggYmluZGluZ3MgYXJlIGVuYWJsZWQuCgllbmFibGVUb3VjaEJpbmRpbmdzKCk7Cn0KCmZ1bmN0aW9uIHN0YXJ0UmVzZXRUaW1lcigpIHsKCWNsZWFyUmVzZXRUaW1lcigpOwoJcmVzZXRUaW1lcklEID0gc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJcmVzZXRUaW1lcklEID0gMDsKCQllbmFibGVNb3VzZUJpbmRpbmdzKCk7Cgl9LCAkLnZtb3VzZS5yZXNldFRpbWVyRHVyYXRpb24gKTsKfQoKZnVuY3Rpb24gY2xlYXJSZXNldFRpbWVyKCkgewoJaWYgKCByZXNldFRpbWVySUQgKSB7CgkJY2xlYXJUaW1lb3V0KCByZXNldFRpbWVySUQgKTsKCQlyZXNldFRpbWVySUQgPSAwOwoJfQp9CgpmdW5jdGlvbiB0cmlnZ2VyVmlydHVhbEV2ZW50KCBldmVudFR5cGUsIGV2ZW50LCBmbGFncyApIHsKCXZhciB2ZTsKCglpZiAoICggZmxhZ3MgJiYgZmxhZ3NbIGV2ZW50VHlwZSBdICkgfHwKCQkJCSggIWZsYWdzICYmIGdldENsb3Nlc3RFbGVtZW50V2l0aFZpcnR1YWxCaW5kaW5nKCBldmVudC50YXJnZXQsIGV2ZW50VHlwZSApICkgKSB7CgoJCXZlID0gY3JlYXRlVmlydHVhbEV2ZW50KCBldmVudCwgZXZlbnRUeXBlICk7CgoJCSQoIGV2ZW50LnRhcmdldCkudHJpZ2dlciggdmUgKTsKCX0KCglyZXR1cm4gdmU7Cn0KCmZ1bmN0aW9uIG1vdXNlRXZlbnRDYWxsYmFjayggZXZlbnQgKSB7Cgl2YXIgdG91Y2hJRCA9ICQuZGF0YSggZXZlbnQudGFyZ2V0LCB0b3VjaFRhcmdldFByb3BlcnR5TmFtZSApOwoKCWlmICggIWJsb2NrTW91c2VUcmlnZ2VycyAmJiAoICFsYXN0VG91Y2hJRCB8fCBsYXN0VG91Y2hJRCAhPT0gdG91Y2hJRCApICkgewoJCXZhciB2ZSA9IHRyaWdnZXJWaXJ0dWFsRXZlbnQoICJ2IiArIGV2ZW50LnR5cGUsIGV2ZW50ICk7CgkJaWYgKCB2ZSApIHsKCQkJaWYgKCB2ZS5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCX0KCQkJaWYgKCB2ZS5pc1Byb3BhZ2F0aW9uU3RvcHBlZCgpICkgewoJCQkJZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7CgkJCX0KCQkJaWYgKCB2ZS5pc0ltbWVkaWF0ZVByb3BhZ2F0aW9uU3RvcHBlZCgpICkgewoJCQkJZXZlbnQuc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uKCk7CgkJCX0KCQl9Cgl9Cn0KCmZ1bmN0aW9uIGhhbmRsZVRvdWNoU3RhcnQoIGV2ZW50ICkgewoKCXZhciB0b3VjaGVzID0gZ2V0TmF0aXZlRXZlbnQoIGV2ZW50ICkudG91Y2hlcywKCQl0YXJnZXQsIGZsYWdzOwoKCWlmICggdG91Y2hlcyAmJiB0b3VjaGVzLmxlbmd0aCA9PT0gMSApIHsKCgkJdGFyZ2V0ID0gZXZlbnQudGFyZ2V0OwoJCWZsYWdzID0gZ2V0VmlydHVhbEJpbmRpbmdGbGFncyggdGFyZ2V0ICk7CgoJCWlmICggZmxhZ3MuaGFzVmlydHVhbEJpbmRpbmcgKSB7CgoJCQlsYXN0VG91Y2hJRCA9IG5leHRUb3VjaElEKys7CgkJCSQuZGF0YSggdGFyZ2V0LCB0b3VjaFRhcmdldFByb3BlcnR5TmFtZSwgbGFzdFRvdWNoSUQgKTsKCgkJCWNsZWFyUmVzZXRUaW1lcigpOwoKCQkJZGlzYWJsZU1vdXNlQmluZGluZ3MoKTsKCQkJZGlkU2Nyb2xsID0gZmFsc2U7CgoJCQl2YXIgdCA9IGdldE5hdGl2ZUV2ZW50KCBldmVudCApLnRvdWNoZXNbIDAgXTsKCQkJc3RhcnRYID0gdC5wYWdlWDsKCQkJc3RhcnRZID0gdC5wYWdlWTsKCgkJCXRyaWdnZXJWaXJ0dWFsRXZlbnQoICJ2bW91c2VvdmVyIiwgZXZlbnQsIGZsYWdzICk7CgkJCXRyaWdnZXJWaXJ0dWFsRXZlbnQoICJ2bW91c2Vkb3duIiwgZXZlbnQsIGZsYWdzICk7CgkJfQoJfQp9CgpmdW5jdGlvbiBoYW5kbGVTY3JvbGwoIGV2ZW50ICkgewoJaWYgKCBibG9ja1RvdWNoVHJpZ2dlcnMgKSB7CgkJcmV0dXJuOwoJfQoKCWlmICggIWRpZFNjcm9sbCApIHsKCQl0cmlnZ2VyVmlydHVhbEV2ZW50KCAidm1vdXNlY2FuY2VsIiwgZXZlbnQsIGdldFZpcnR1YWxCaW5kaW5nRmxhZ3MoIGV2ZW50LnRhcmdldCApICk7Cgl9CgoJZGlkU2Nyb2xsID0gdHJ1ZTsKCXN0YXJ0UmVzZXRUaW1lcigpOwp9CgpmdW5jdGlvbiBoYW5kbGVUb3VjaE1vdmUoIGV2ZW50ICkgewoJaWYgKCBibG9ja1RvdWNoVHJpZ2dlcnMgKSB7CgkJcmV0dXJuOwoJfQoKCXZhciB0ID0gZ2V0TmF0aXZlRXZlbnQoIGV2ZW50ICkudG91Y2hlc1sgMCBdLAoJCWRpZENhbmNlbCA9IGRpZFNjcm9sbCwKCQltb3ZlVGhyZXNob2xkID0gJC52bW91c2UubW92ZURpc3RhbmNlVGhyZXNob2xkLAoJCWZsYWdzID0gZ2V0VmlydHVhbEJpbmRpbmdGbGFncyggZXZlbnQudGFyZ2V0ICk7CgoJCWRpZFNjcm9sbCA9IGRpZFNjcm9sbCB8fAoJCQkoIE1hdGguYWJzKCB0LnBhZ2VYIC0gc3RhcnRYICkgPiBtb3ZlVGhyZXNob2xkIHx8CgkJCQlNYXRoLmFicyggdC5wYWdlWSAtIHN0YXJ0WSApID4gbW92ZVRocmVzaG9sZCApOwoKCglpZiAoIGRpZFNjcm9sbCAmJiAhZGlkQ2FuY2VsICkgewoJCXRyaWdnZXJWaXJ0dWFsRXZlbnQoICJ2bW91c2VjYW5jZWwiLCBldmVudCwgZmxhZ3MgKTsKCX0KCgl0cmlnZ2VyVmlydHVhbEV2ZW50KCAidm1vdXNlbW92ZSIsIGV2ZW50LCBmbGFncyApOwoJc3RhcnRSZXNldFRpbWVyKCk7Cn0KCmZ1bmN0aW9uIGhhbmRsZVRvdWNoRW5kKCBldmVudCApIHsKCWlmICggYmxvY2tUb3VjaFRyaWdnZXJzICkgewoJCXJldHVybjsKCX0KCglkaXNhYmxlVG91Y2hCaW5kaW5ncygpOwoKCXZhciBmbGFncyA9IGdldFZpcnR1YWxCaW5kaW5nRmxhZ3MoIGV2ZW50LnRhcmdldCApLAoJCXQ7Cgl0cmlnZ2VyVmlydHVhbEV2ZW50KCAidm1vdXNldXAiLCBldmVudCwgZmxhZ3MgKTsKCglpZiAoICFkaWRTY3JvbGwgKSB7CgkJdmFyIHZlID0gdHJpZ2dlclZpcnR1YWxFdmVudCggInZjbGljayIsIGV2ZW50LCBmbGFncyApOwoJCWlmICggdmUgJiYgdmUuaXNEZWZhdWx0UHJldmVudGVkKCkgKSB7CgkJCS8vIFRoZSB0YXJnZXQgb2YgdGhlIG1vdXNlIGV2ZW50cyB0aGF0IGZvbGxvdyB0aGUgdG91Y2hlbmQKCQkJLy8gZXZlbnQgZG9uJ3QgbmVjZXNzYXJpbHkgbWF0Y2ggdGhlIHRhcmdldCB1c2VkIGR1cmluZyB0aGUKCQkJLy8gdG91Y2guIFRoaXMgbWVhbnMgd2UgbmVlZCB0byByZWx5IG9uIGNvb3JkaW5hdGVzIGZvciBibG9ja2luZwoJCQkvLyBhbnkgY2xpY2sgdGhhdCBpcyBnZW5lcmF0ZWQuCgkJCXQgPSBnZXROYXRpdmVFdmVudCggZXZlbnQgKS5jaGFuZ2VkVG91Y2hlc1sgMCBdOwoJCQljbGlja0Jsb2NrTGlzdC5wdXNoKHsKCQkJCXRvdWNoSUQ6IGxhc3RUb3VjaElELAoJCQkJeDogdC5jbGllbnRYLAoJCQkJeTogdC5jbGllbnRZCgkJCX0pOwoKCQkJLy8gUHJldmVudCBhbnkgbW91c2UgZXZlbnRzIHRoYXQgZm9sbG93IGZyb20gdHJpZ2dlcmluZwoJCQkvLyB2aXJ0dWFsIGV2ZW50IG5vdGlmaWNhdGlvbnMuCgkJCWJsb2NrTW91c2VUcmlnZ2VycyA9IHRydWU7CgkJfQoJfQoJdHJpZ2dlclZpcnR1YWxFdmVudCggInZtb3VzZW91dCIsIGV2ZW50LCBmbGFncyk7CglkaWRTY3JvbGwgPSBmYWxzZTsKCglzdGFydFJlc2V0VGltZXIoKTsKfQoKZnVuY3Rpb24gaGFzVmlydHVhbEJpbmRpbmdzKCBlbGUgKSB7Cgl2YXIgYmluZGluZ3MgPSAkLmRhdGEoIGVsZSwgZGF0YVByb3BlcnR5TmFtZSApLAoJCWs7CgoJaWYgKCBiaW5kaW5ncyApIHsKCQlmb3IgKCBrIGluIGJpbmRpbmdzICkgewoJCQlpZiAoIGJpbmRpbmdzWyBrIF0gKSB7CgkJCQlyZXR1cm4gdHJ1ZTsKCQkJfQoJCX0KCX0KCXJldHVybiBmYWxzZTsKfQoKZnVuY3Rpb24gZHVtbXlNb3VzZUhhbmRsZXIoKSB7fQoKZnVuY3Rpb24gZ2V0U3BlY2lhbEV2ZW50T2JqZWN0KCBldmVudFR5cGUgKSB7Cgl2YXIgcmVhbFR5cGUgPSBldmVudFR5cGUuc3Vic3RyKCAxICk7CgoJcmV0dXJuIHsKCQlzZXR1cDogZnVuY3Rpb24oIGRhdGEsIG5hbWVzcGFjZSApIHsKCQkJLy8gSWYgdGhpcyBpcyB0aGUgZmlyc3QgdmlydHVhbCBtb3VzZSBiaW5kaW5nIGZvciB0aGlzIGVsZW1lbnQsCgkJCS8vIGFkZCBhIGJpbmRpbmdzIG9iamVjdCB0byBpdHMgZGF0YS4KCgkJCWlmICggIWhhc1ZpcnR1YWxCaW5kaW5ncyggdGhpcyApICkgewoJCQkJJC5kYXRhKCB0aGlzLCBkYXRhUHJvcGVydHlOYW1lLCB7fSApOwoJCQl9CgoJCQkvLyBJZiBzZXR1cCBpcyBjYWxsZWQsIHdlIGtub3cgaXQgaXMgdGhlIGZpcnN0IGJpbmRpbmcgZm9yIHRoaXMKCQkJLy8gZXZlbnRUeXBlLCBzbyBpbml0aWFsaXplIHRoZSBjb3VudCBmb3IgdGhlIGV2ZW50VHlwZSB0byB6ZXJvLgoJCQl2YXIgYmluZGluZ3MgPSAkLmRhdGEoIHRoaXMsIGRhdGFQcm9wZXJ0eU5hbWUgKTsKCQkJYmluZGluZ3NbIGV2ZW50VHlwZSBdID0gdHJ1ZTsKCgkJCS8vIElmIHRoaXMgaXMgdGhlIGZpcnN0IHZpcnR1YWwgbW91c2UgZXZlbnQgZm9yIHRoaXMgdHlwZSwKCQkJLy8gcmVnaXN0ZXIgYSBnbG9iYWwgaGFuZGxlciBvbiB0aGUgZG9jdW1lbnQuCgoJCQlhY3RpdmVEb2NIYW5kbGVyc1sgZXZlbnRUeXBlIF0gPSAoIGFjdGl2ZURvY0hhbmRsZXJzWyBldmVudFR5cGUgXSB8fCAwICkgKyAxOwoKCQkJaWYgKCBhY3RpdmVEb2NIYW5kbGVyc1sgZXZlbnRUeXBlIF0gPT09IDEgKSB7CgkJCQkkZG9jdW1lbnQuYmluZCggcmVhbFR5cGUsIG1vdXNlRXZlbnRDYWxsYmFjayApOwoJCQl9CgoJCQkvLyBTb21lIGJyb3dzZXJzLCBsaWtlIE9wZXJhIE1pbmksIHdvbid0IGRpc3BhdGNoIG1vdXNlL2NsaWNrIGV2ZW50cwoJCQkvLyBmb3IgZWxlbWVudHMgdW5sZXNzIHRoZXkgYWN0dWFsbHkgaGF2ZSBoYW5kbGVycyByZWdpc3RlcmVkIG9uIHRoZW0uCgkJCS8vIFRvIGdldCBhcm91bmQgdGhpcywgd2UgcmVnaXN0ZXIgZHVtbXkgaGFuZGxlcnMgb24gdGhlIGVsZW1lbnRzLgoKCQkJJCggdGhpcyApLmJpbmQoIHJlYWxUeXBlLCBkdW1teU1vdXNlSGFuZGxlciApOwoKCQkJLy8gRm9yIG5vdywgaWYgZXZlbnQgY2FwdHVyZSBpcyBub3Qgc3VwcG9ydGVkLCB3ZSByZWx5IG9uIG1vdXNlIGhhbmRsZXJzLgoJCQlpZiAoIGV2ZW50Q2FwdHVyZVN1cHBvcnRlZCApIHsKCQkJCS8vIElmIHRoaXMgaXMgdGhlIGZpcnN0IHZpcnR1YWwgbW91c2UgYmluZGluZyBmb3IgdGhlIGRvY3VtZW50LAoJCQkJLy8gcmVnaXN0ZXIgb3VyIHRvdWNoc3RhcnQgaGFuZGxlciBvbiB0aGUgZG9jdW1lbnQuCgoJCQkJYWN0aXZlRG9jSGFuZGxlcnNbICJ0b3VjaHN0YXJ0IiBdID0gKCBhY3RpdmVEb2NIYW5kbGVyc1sgInRvdWNoc3RhcnQiIF0gfHwgMCkgKyAxOwoKCQkJCWlmICggYWN0aXZlRG9jSGFuZGxlcnNbICJ0b3VjaHN0YXJ0IiBdID09PSAxICkgewoJCQkJCSRkb2N1bWVudC5iaW5kKCAidG91Y2hzdGFydCIsIGhhbmRsZVRvdWNoU3RhcnQgKQoJCQkJCQkuYmluZCggInRvdWNoZW5kIiwgaGFuZGxlVG91Y2hFbmQgKQoKCQkJCQkJLy8gT24gdG91Y2ggcGxhdGZvcm1zLCB0b3VjaGluZyB0aGUgc2NyZWVuIGFuZCB0aGVuIGRyYWdnaW5nIHlvdXIgZmluZ2VyCgkJCQkJCS8vIGNhdXNlcyB0aGUgd2luZG93IGNvbnRlbnQgdG8gc2Nyb2xsIGFmdGVyIHNvbWUgZGlzdGFuY2UgdGhyZXNob2xkIGlzCgkJCQkJCS8vIGV4Y2VlZGVkLiBPbiB0aGVzZSBwbGF0Zm9ybXMsIGEgc2Nyb2xsIHByZXZlbnRzIGEgY2xpY2sgZXZlbnQgZnJvbSBiZWluZwoJCQkJCQkvLyBkaXNwYXRjaGVkLCBhbmQgb24gc29tZSBwbGF0Zm9ybXMsIGV2ZW4gdGhlIHRvdWNoZW5kIGlzIHN1cHByZXNzZWQuIFRvCgkJCQkJCS8vIG1pbWljIHRoZSBzdXBwcmVzc2lvbiBvZiB0aGUgY2xpY2sgZXZlbnQsIHdlIG5lZWQgdG8gd2F0Y2ggZm9yIGEgc2Nyb2xsCgkJCQkJCS8vIGV2ZW50LiBVbmZvcnR1bmF0ZWx5LCBzb21lIHBsYXRmb3JtcyBsaWtlIGlPUyBkb24ndCBkaXNwYXRjaCBzY3JvbGwKCQkJCQkJLy8gZXZlbnRzIHVudGlsICpBRlRFUiogdGhlIHVzZXIgbGlmdHMgdGhlaXIgZmluZ2VyICh0b3VjaGVuZCkuIFRoaXMgbWVhbnMKCQkJCQkJLy8gd2UgbmVlZCB0byB3YXRjaCBib3RoIHNjcm9sbCBhbmQgdG91Y2htb3ZlIGV2ZW50cyB0byBmaWd1cmUgb3V0IHdoZXRoZXIKCQkJCQkJLy8gb3Igbm90IGEgc2Nyb2xsIGhhcHBlbmVucyBiZWZvcmUgdGhlIHRvdWNoZW5kIGV2ZW50IGlzIGZpcmVkLgoKCQkJCQkJLmJpbmQoICJ0b3VjaG1vdmUiLCBoYW5kbGVUb3VjaE1vdmUgKQoJCQkJCQkuYmluZCggInNjcm9sbCIsIGhhbmRsZVNjcm9sbCApOwoJCQkJfQoJCQl9CgkJfSwKCgkJdGVhcmRvd246IGZ1bmN0aW9uKCBkYXRhLCBuYW1lc3BhY2UgKSB7CgkJCS8vIElmIHRoaXMgaXMgdGhlIGxhc3QgdmlydHVhbCBiaW5kaW5nIGZvciB0aGlzIGV2ZW50VHlwZSwKCQkJLy8gcmVtb3ZlIGl0cyBnbG9iYWwgaGFuZGxlciBmcm9tIHRoZSBkb2N1bWVudC4KCgkJCS0tYWN0aXZlRG9jSGFuZGxlcnNbIGV2ZW50VHlwZSBdOwoKCQkJaWYgKCAhYWN0aXZlRG9jSGFuZGxlcnNbIGV2ZW50VHlwZSBdICkgewoJCQkJJGRvY3VtZW50LnVuYmluZCggcmVhbFR5cGUsIG1vdXNlRXZlbnRDYWxsYmFjayApOwoJCQl9CgoJCQlpZiAoIGV2ZW50Q2FwdHVyZVN1cHBvcnRlZCApIHsKCQkJCS8vIElmIHRoaXMgaXMgdGhlIGxhc3QgdmlydHVhbCBtb3VzZSBiaW5kaW5nIGluIGV4aXN0ZW5jZSwKCQkJCS8vIHJlbW92ZSBvdXIgZG9jdW1lbnQgdG91Y2hzdGFydCBsaXN0ZW5lci4KCgkJCQktLWFjdGl2ZURvY0hhbmRsZXJzWyAidG91Y2hzdGFydCIgXTsKCgkJCQlpZiAoICFhY3RpdmVEb2NIYW5kbGVyc1sgInRvdWNoc3RhcnQiIF0gKSB7CgkJCQkJJGRvY3VtZW50LnVuYmluZCggInRvdWNoc3RhcnQiLCBoYW5kbGVUb3VjaFN0YXJ0ICkKCQkJCQkJLnVuYmluZCggInRvdWNobW92ZSIsIGhhbmRsZVRvdWNoTW92ZSApCgkJCQkJCS51bmJpbmQoICJ0b3VjaGVuZCIsIGhhbmRsZVRvdWNoRW5kICkKCQkJCQkJLnVuYmluZCggInNjcm9sbCIsIGhhbmRsZVNjcm9sbCApOwoJCQkJfQoJCQl9CgoJCQl2YXIgJHRoaXMgPSAkKCB0aGlzICksCgkJCQliaW5kaW5ncyA9ICQuZGF0YSggdGhpcywgZGF0YVByb3BlcnR5TmFtZSApOwoKCQkJLy8gdGVhcmRvd24gbWF5IGJlIGNhbGxlZCB3aGVuIGFuIGVsZW1lbnQgd2FzCgkJCS8vIHJlbW92ZWQgZnJvbSB0aGUgRE9NLiBJZiB0aGlzIGlzIHRoZSBjYXNlLAoJCQkvLyBqUXVlcnkgY29yZSBtYXkgaGF2ZSBhbHJlYWR5IHN0cmlwcGVkIHRoZSBlbGVtZW50CgkJCS8vIG9mIGFueSBkYXRhIGJpbmRpbmdzIHNvIHdlIG5lZWQgdG8gY2hlY2sgaXQgYmVmb3JlCgkJCS8vIHVzaW5nIGl0LgoJCQlpZiAoIGJpbmRpbmdzICkgewoJCQkJYmluZGluZ3NbIGV2ZW50VHlwZSBdID0gZmFsc2U7CgkJCX0KCgkJCS8vIFVucmVnaXN0ZXIgdGhlIGR1bW15IGV2ZW50IGhhbmRsZXIuCgoJCQkkdGhpcy51bmJpbmQoIHJlYWxUeXBlLCBkdW1teU1vdXNlSGFuZGxlciApOwoKCQkJLy8gSWYgdGhpcyBpcyB0aGUgbGFzdCB2aXJ0dWFsIG1vdXNlIGJpbmRpbmcgb24gdGhlCgkJCS8vIGVsZW1lbnQsIHJlbW92ZSB0aGUgYmluZGluZyBkYXRhIGZyb20gdGhlIGVsZW1lbnQuCgoJCQlpZiAoICFoYXNWaXJ0dWFsQmluZGluZ3MoIHRoaXMgKSApIHsKCQkJCSR0aGlzLnJlbW92ZURhdGEoIGRhdGFQcm9wZXJ0eU5hbWUgKTsKCQkJfQoJCX0KCX07Cn0KCi8vIEV4cG9zZSBvdXIgY3VzdG9tIGV2ZW50cyB0byB0aGUgalF1ZXJ5IGJpbmQvdW5iaW5kIG1lY2hhbmlzbS4KCmZvciAoIHZhciBpID0gMDsgaSA8IHZpcnR1YWxFdmVudE5hbWVzLmxlbmd0aDsgaSsrICkgewoJJC5ldmVudC5zcGVjaWFsWyB2aXJ0dWFsRXZlbnROYW1lc1sgaSBdIF0gPSBnZXRTcGVjaWFsRXZlbnRPYmplY3QoIHZpcnR1YWxFdmVudE5hbWVzWyBpIF0gKTsKfQoKLy8gQWRkIGEgY2FwdHVyZSBjbGljayBoYW5kbGVyIHRvIGJsb2NrIGNsaWNrcy4KLy8gTm90ZSB0aGF0IHdlIHJlcXVpcmUgZXZlbnQgY2FwdHVyZSBzdXBwb3J0IGZvciB0aGlzIHNvIGlmIHRoZSBkZXZpY2UKLy8gZG9lc24ndCBzdXBwb3J0IGl0LCB3ZSBwdW50IGZvciBub3cgYW5kIHJlbHkgc29sZWx5IG9uIG1vdXNlIGV2ZW50cy4KaWYgKCBldmVudENhcHR1cmVTdXBwb3J0ZWQgKSB7Cglkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCAiY2xpY2siLCBmdW5jdGlvbiggZSApIHsKCQl2YXIgY250ID0gY2xpY2tCbG9ja0xpc3QubGVuZ3RoLAoJCQl0YXJnZXQgPSBlLnRhcmdldCwKCQkJeCwgeSwgZWxlLCBpLCBvLCB0b3VjaElEOwoKCQlpZiAoIGNudCApIHsKCQkJeCA9IGUuY2xpZW50WDsKCQkJeSA9IGUuY2xpZW50WTsKCQkJdGhyZXNob2xkID0gJC52bW91c2UuY2xpY2tEaXN0YW5jZVRocmVzaG9sZDsKCgkJCS8vIFRoZSBpZGVhIGhlcmUgaXMgdG8gcnVuIHRocm91Z2ggdGhlIGNsaWNrQmxvY2tMaXN0IHRvIHNlZSBpZgoJCQkvLyB0aGUgY3VycmVudCBjbGljayBldmVudCBpcyBpbiB0aGUgcHJveGltaXR5IG9mIG9uZSBvZiBvdXIKCQkJLy8gdmNsaWNrIGV2ZW50cyB0aGF0IGhhZCBwcmV2ZW50RGVmYXVsdCgpIGNhbGxlZCBvbiBpdC4gSWYgd2UgZmluZAoJCQkvLyBvbmUsIHRoZW4gd2UgYmxvY2sgdGhlIGNsaWNrLgoJCQkvLwoJCQkvLyBXaHkgZG8gd2UgaGF2ZSB0byByZWx5IG9uIHByb3hpbWl0eT8KCQkJLy8KCQkJLy8gQmVjYXVzZSB0aGUgdGFyZ2V0IG9mIHRoZSB0b3VjaCBldmVudCB0aGF0IHRyaWdnZXJlZCB0aGUgdmNsaWNrCgkJCS8vIGNhbiBiZSBkaWZmZXJlbnQgZnJvbSB0aGUgdGFyZ2V0IG9mIHRoZSBjbGljayBldmVudCBzeW50aGVzaXplZAoJCQkvLyBieSB0aGUgYnJvd3Nlci4gVGhlIHRhcmdldCBvZiBhIG1vdXNlL2NsaWNrIGV2ZW50IHRoYXQgaXMgc3ludGVoc2l6ZWQKCQkJLy8gZnJvbSBhIHRvdWNoIGV2ZW50IHNlZW1zIHRvIGJlIGltcGxlbWVudGF0aW9uIHNwZWNpZmljLiBGb3IgZXhhbXBsZSwKCQkJLy8gc29tZSBicm93c2VycyB3aWxsIGZpcmUgbW91c2UvY2xpY2sgZXZlbnRzIGZvciBhIGxpbmsgdGhhdCBpcyBuZWFyCgkJCS8vIGEgdG91Y2ggZXZlbnQsIGV2ZW4gdGhvdWdoIHRoZSB0YXJnZXQgb2YgdGhlIHRvdWNoc3RhcnQvdG91Y2hlbmQgZXZlbnQKCQkJLy8gc2F5cyB0aGUgdXNlciB0b3VjaGVkIG91dHNpZGUgdGhlIGxpbmsuIEFsc28sIGl0IHNlZW1zIHRoYXQgd2l0aCBtb3N0CgkJCS8vIGJyb3dzZXJzLCB0aGUgdGFyZ2V0IG9mIHRoZSBtb3VzZS9jbGljayBldmVudCBpcyBub3QgY2FsY3VsYXRlZCB1bnRpbCB0aGUKCQkJLy8gdGltZSBpdCBpcyBkaXNwYXRjaGVkLCBzbyBpZiB5b3UgcmVwbGFjZSBhbiBlbGVtZW50IHRoYXQgeW91IHRvdWNoZWQKCQkJLy8gd2l0aCBhbm90aGVyIGVsZW1lbnQsIHRoZSB0YXJnZXQgb2YgdGhlIG1vdXNlL2NsaWNrIHdpbGwgYmUgdGhlIG5ldwoJCQkvLyBlbGVtZW50IHVuZGVybmVhdGggdGhhdCBwb2ludC4KCQkJLy8KCQkJLy8gQXNpZGUgZnJvbSBwcm94aW1pdHksIHdlIGFsc28gY2hlY2sgdG8gc2VlIGlmIHRoZSB0YXJnZXQgYW5kIGFueQoJCQkvLyBvZiBpdHMgYW5jZXN0b3JzIHdlcmUgdGhlIG9uZXMgdGhhdCBibG9ja2VkIGEgY2xpY2suIFRoaXMgaXMgbmVjZXNzYXJ5CgkJCS8vIGJlY2F1c2Ugb2YgdGhlIHN0cmFuZ2UgbW91c2UvY2xpY2sgdGFyZ2V0IGNhbGN1bGF0aW9uIGRvbmUgaW4gdGhlCgkJCS8vIEFuZHJvaWQgMi4xIGJyb3dzZXIsIHdoZXJlIGlmIHlvdSBjbGljayBvbiBhbiBlbGVtZW50LCBhbmQgdGhlcmUgaXMgYQoJCQkvLyBtb3VzZS9jbGljayBoYW5kbGVyIG9uIG9uZSBvZiBpdHMgYW5jZXN0b3JzLCB0aGUgdGFyZ2V0IHdpbGwgYmUgdGhlCgkJCS8vIGlubmVybW9zdCBjaGlsZCBvZiB0aGUgdG91Y2hlZCBlbGVtZW50LCBldmVuIGlmIHRoYXQgY2hpbGQgaXMgbm8gd2hlcmUKCQkJLy8gbmVhciB0aGUgcG9pbnQgb2YgdG91Y2guCgoJCQllbGUgPSB0YXJnZXQ7CgoJCQl3aGlsZSAoIGVsZSApIHsKCQkJCWZvciAoIGkgPSAwOyBpIDwgY250OyBpKysgKSB7CgkJCQkJbyA9IGNsaWNrQmxvY2tMaXN0WyBpIF07CgkJCQkJdG91Y2hJRCA9IDA7CgoJCQkJCWlmICggKCBlbGUgPT09IHRhcmdldCAmJiBNYXRoLmFicyggby54IC0geCApIDwgdGhyZXNob2xkICYmIE1hdGguYWJzKCBvLnkgLSB5ICkgPCB0aHJlc2hvbGQgKSB8fAoJCQkJCQkJCSQuZGF0YSggZWxlLCB0b3VjaFRhcmdldFByb3BlcnR5TmFtZSApID09PSBvLnRvdWNoSUQgKSB7CgkJCQkJCS8vIFhYWDogV2UgbWF5IHdhbnQgdG8gY29uc2lkZXIgcmVtb3ZpbmcgbWF0Y2hlcyBmcm9tIHRoZSBibG9jayBsaXN0CgkJCQkJCS8vICAgICAgaW5zdGVhZCBvZiB3YWl0aW5nIGZvciB0aGUgcmVzZXQgdGltZXIgdG8gZmlyZS4KCQkJCQkJZS5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJCQllLnN0b3BQcm9wYWdhdGlvbigpOwoJCQkJCQlyZXR1cm47CgkJCQkJfQoJCQkJfQoJCQkJZWxlID0gZWxlLnBhcmVudE5vZGU7CgkJCX0KCQl9Cgl9LCB0cnVlKTsKfQp9KSggalF1ZXJ5LCB3aW5kb3csIGRvY3VtZW50ICk7CgoJKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgkJdmFyIHN1cHBvcnQgPSB7CgkJCXRvdWNoOiAib250b3VjaGVuZCIgaW4gZG9jdW1lbnQKCQl9OwoKCQkkLm1vYmlsZSA9ICQubW9iaWxlIHx8IHt9OwoJCSQubW9iaWxlLnN1cHBvcnQgPSAkLm1vYmlsZS5zdXBwb3J0IHx8IHt9OwoJCSQuZXh0ZW5kKCAkLnN1cHBvcnQsIHN1cHBvcnQgKTsKCQkkLmV4dGVuZCggJC5tb2JpbGUuc3VwcG9ydCwgc3VwcG9ydCApOwoJfSggalF1ZXJ5ICkpOwoKCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgkvLyBhZGQgbmV3IGV2ZW50IHNob3J0Y3V0cwoJJC5lYWNoKCAoICJ0b3VjaHN0YXJ0IHRvdWNobW92ZSB0b3VjaGVuZCAiICsKCQkidGFwIHRhcGhvbGQgIiArCgkJInN3aXBlIHN3aXBlbGVmdCBzd2lwZXJpZ2h0ICIgKwoJCSJzY3JvbGxzdGFydCBzY3JvbGxzdG9wIiApLnNwbGl0KCAiICIgKSwgZnVuY3Rpb24oIGksIG5hbWUgKSB7CgoJCSQuZm5bIG5hbWUgXSA9IGZ1bmN0aW9uKCBmbiApIHsKCQkJcmV0dXJuIGZuID8gdGhpcy5iaW5kKCBuYW1lLCBmbiApIDogdGhpcy50cmlnZ2VyKCBuYW1lICk7CgkJfTsKCgkJLy8galF1ZXJ5IDwgMS44CgkJaWYgKCAkLmF0dHJGbiApIHsKCQkJJC5hdHRyRm5bIG5hbWUgXSA9IHRydWU7CgkJfQoJfSk7CgoJdmFyIHN1cHBvcnRUb3VjaCA9ICQubW9iaWxlLnN1cHBvcnQudG91Y2gsCgkJc2Nyb2xsRXZlbnQgPSAidG91Y2htb3ZlIHNjcm9sbCIsCgkJdG91Y2hTdGFydEV2ZW50ID0gc3VwcG9ydFRvdWNoID8gInRvdWNoc3RhcnQiIDogIm1vdXNlZG93biIsCgkJdG91Y2hTdG9wRXZlbnQgPSBzdXBwb3J0VG91Y2ggPyAidG91Y2hlbmQiIDogIm1vdXNldXAiLAoJCXRvdWNoTW92ZUV2ZW50ID0gc3VwcG9ydFRvdWNoID8gInRvdWNobW92ZSIgOiAibW91c2Vtb3ZlIjsKCglmdW5jdGlvbiB0cmlnZ2VyQ3VzdG9tRXZlbnQoIG9iaiwgZXZlbnRUeXBlLCBldmVudCApIHsKCQl2YXIgb3JpZ2luYWxUeXBlID0gZXZlbnQudHlwZTsKCQlldmVudC50eXBlID0gZXZlbnRUeXBlOwoJCSQuZXZlbnQuaGFuZGxlLmNhbGwoIG9iaiwgZXZlbnQgKTsKCQlldmVudC50eXBlID0gb3JpZ2luYWxUeXBlOwoJfQoKCS8vIGFsc28gaGFuZGxlcyBzY3JvbGxzdG9wCgkkLmV2ZW50LnNwZWNpYWwuc2Nyb2xsc3RhcnQgPSB7CgoJCWVuYWJsZWQ6IHRydWUsCgoJCXNldHVwOiBmdW5jdGlvbigpIHsKCgkJCXZhciB0aGlzT2JqZWN0ID0gdGhpcywKCQkJCSR0aGlzID0gJCggdGhpc09iamVjdCApLAoJCQkJc2Nyb2xsaW5nLAoJCQkJdGltZXI7CgoJCQlmdW5jdGlvbiB0cmlnZ2VyKCBldmVudCwgc3RhdGUgKSB7CgkJCQlzY3JvbGxpbmcgPSBzdGF0ZTsKCQkJCXRyaWdnZXJDdXN0b21FdmVudCggdGhpc09iamVjdCwgc2Nyb2xsaW5nID8gInNjcm9sbHN0YXJ0IiA6ICJzY3JvbGxzdG9wIiwgZXZlbnQgKTsKCQkJfQoKCQkJLy8gaVBob25lIHRyaWdnZXJzIHNjcm9sbCBhZnRlciBhIHNtYWxsIGRlbGF5OyB1c2UgdG91Y2htb3ZlIGluc3RlYWQKCQkJJHRoaXMuYmluZCggc2Nyb2xsRXZlbnQsIGZ1bmN0aW9uKCBldmVudCApIHsKCgkJCQlpZiAoICEkLmV2ZW50LnNwZWNpYWwuc2Nyb2xsc3RhcnQuZW5hYmxlZCApIHsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKCAhc2Nyb2xsaW5nICkgewoJCQkJCXRyaWdnZXIoIGV2ZW50LCB0cnVlICk7CgkJCQl9CgoJCQkJY2xlYXJUaW1lb3V0KCB0aW1lciApOwoJCQkJdGltZXIgPSBzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJCQl0cmlnZ2VyKCBldmVudCwgZmFsc2UgKTsKCQkJCX0sIDUwICk7CgkJCX0pOwoJCX0KCX07CgoJLy8gYWxzbyBoYW5kbGVzIHRhcGhvbGQKCSQuZXZlbnQuc3BlY2lhbC50YXAgPSB7CgkJdGFwaG9sZFRocmVzaG9sZDogNzUwLAoKCQlzZXR1cDogZnVuY3Rpb24oKSB7CgkJCXZhciB0aGlzT2JqZWN0ID0gdGhpcywKCQkJCSR0aGlzID0gJCggdGhpc09iamVjdCApOwoKCQkJJHRoaXMuYmluZCggInZtb3VzZWRvd24iLCBmdW5jdGlvbiggZXZlbnQgKSB7CgoJCQkJaWYgKCBldmVudC53aGljaCAmJiBldmVudC53aGljaCAhPT0gMSApIHsKCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQl9CgoJCQkJdmFyIG9yaWdUYXJnZXQgPSBldmVudC50YXJnZXQsCgkJCQkJb3JpZ0V2ZW50ID0gZXZlbnQub3JpZ2luYWxFdmVudCwKCQkJCQl0aW1lcjsKCgkJCQlmdW5jdGlvbiBjbGVhclRhcFRpbWVyKCkgewoJCQkJCWNsZWFyVGltZW91dCggdGltZXIgKTsKCQkJCX0KCgkJCQlmdW5jdGlvbiBjbGVhclRhcEhhbmRsZXJzKCkgewoJCQkJCWNsZWFyVGFwVGltZXIoKTsKCgkJCQkJJHRoaXMudW5iaW5kKCAidmNsaWNrIiwgY2xpY2tIYW5kbGVyICkKCQkJCQkJLnVuYmluZCggInZtb3VzZXVwIiwgY2xlYXJUYXBUaW1lciApOwoJCQkJCSQoIGRvY3VtZW50ICkudW5iaW5kKCAidm1vdXNlY2FuY2VsIiwgY2xlYXJUYXBIYW5kbGVycyApOwoJCQkJfQoKCQkJCWZ1bmN0aW9uIGNsaWNrSGFuZGxlciggZXZlbnQgKSB7CgkJCQkJY2xlYXJUYXBIYW5kbGVycygpOwoKCQkJCQkvLyBPTkxZIHRyaWdnZXIgYSAndGFwJyBldmVudCBpZiB0aGUgc3RhcnQgdGFyZ2V0IGlzCgkJCQkJLy8gdGhlIHNhbWUgYXMgdGhlIHN0b3AgdGFyZ2V0LgoJCQkJCWlmICggb3JpZ1RhcmdldCA9PT0gZXZlbnQudGFyZ2V0ICkgewoJCQkJCQl0cmlnZ2VyQ3VzdG9tRXZlbnQoIHRoaXNPYmplY3QsICJ0YXAiLCBldmVudCApOwoJCQkJCX0KCQkJCX0KCgkJCQkkdGhpcy5iaW5kKCAidm1vdXNldXAiLCBjbGVhclRhcFRpbWVyICkKCQkJCQkuYmluZCggInZjbGljayIsIGNsaWNrSGFuZGxlciApOwoJCQkJJCggZG9jdW1lbnQgKS5iaW5kKCAidm1vdXNlY2FuY2VsIiwgY2xlYXJUYXBIYW5kbGVycyApOwoKCQkJCXRpbWVyID0gc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQkJdHJpZ2dlckN1c3RvbUV2ZW50KCB0aGlzT2JqZWN0LCAidGFwaG9sZCIsICQuRXZlbnQoICJ0YXBob2xkIiwgeyB0YXJnZXQ6IG9yaWdUYXJnZXQgfSApICk7CgkJCQl9LCAkLmV2ZW50LnNwZWNpYWwudGFwLnRhcGhvbGRUaHJlc2hvbGQgKTsKCQkJfSk7CgkJfQoJfTsKCgkvLyBhbHNvIGhhbmRsZXMgc3dpcGVsZWZ0LCBzd2lwZXJpZ2h0CgkkLmV2ZW50LnNwZWNpYWwuc3dpcGUgPSB7CgkJc2Nyb2xsU3VwcmVzc2lvblRocmVzaG9sZDogMzAsIC8vIE1vcmUgdGhhbiB0aGlzIGhvcml6b250YWwgZGlzcGxhY2VtZW50LCBhbmQgd2Ugd2lsbCBzdXBwcmVzcyBzY3JvbGxpbmcuCgoJCWR1cmF0aW9uVGhyZXNob2xkOiAxMDAwLCAvLyBNb3JlIHRpbWUgdGhhbiB0aGlzLCBhbmQgaXQgaXNuJ3QgYSBzd2lwZS4KCgkJaG9yaXpvbnRhbERpc3RhbmNlVGhyZXNob2xkOiAzMCwgIC8vIFN3aXBlIGhvcml6b250YWwgZGlzcGxhY2VtZW50IG11c3QgYmUgbW9yZSB0aGFuIHRoaXMuCgoJCXZlcnRpY2FsRGlzdGFuY2VUaHJlc2hvbGQ6IDc1LCAgLy8gU3dpcGUgdmVydGljYWwgZGlzcGxhY2VtZW50IG11c3QgYmUgbGVzcyB0aGFuIHRoaXMuCgoJCXNldHVwOiBmdW5jdGlvbigpIHsKCQkJdmFyIHRoaXNPYmplY3QgPSB0aGlzLAoJCQkJJHRoaXMgPSAkKCB0aGlzT2JqZWN0ICk7CgoJCQkkdGhpcy5iaW5kKCB0b3VjaFN0YXJ0RXZlbnQsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCXZhciBkYXRhID0gZXZlbnQub3JpZ2luYWxFdmVudC50b3VjaGVzID8KCQkJCQkJZXZlbnQub3JpZ2luYWxFdmVudC50b3VjaGVzWyAwIF0gOiBldmVudCwKCQkJCQlzdGFydCA9IHsKCQkJCQkJdGltZTogKCBuZXcgRGF0ZSgpICkuZ2V0VGltZSgpLAoJCQkJCQljb29yZHM6IFsgZGF0YS5wYWdlWCwgZGF0YS5wYWdlWSBdLAoJCQkJCQlvcmlnaW46ICQoIGV2ZW50LnRhcmdldCApCgkJCQkJfSwKCQkJCQlzdG9wOwoKCQkJCWZ1bmN0aW9uIG1vdmVIYW5kbGVyKCBldmVudCApIHsKCgkJCQkJaWYgKCAhc3RhcnQgKSB7CgkJCQkJCXJldHVybjsKCQkJCQl9CgoJCQkJCXZhciBkYXRhID0gZXZlbnQub3JpZ2luYWxFdmVudC50b3VjaGVzID8KCQkJCQkJZXZlbnQub3JpZ2luYWxFdmVudC50b3VjaGVzWyAwIF0gOiBldmVudDsKCgkJCQkJc3RvcCA9IHsKCQkJCQkJdGltZTogKCBuZXcgRGF0ZSgpICkuZ2V0VGltZSgpLAoJCQkJCQljb29yZHM6IFsgZGF0YS5wYWdlWCwgZGF0YS5wYWdlWSBdCgkJCQkJfTsKCgkJCQkJLy8gcHJldmVudCBzY3JvbGxpbmcKCQkJCQlpZiAoIE1hdGguYWJzKCBzdGFydC5jb29yZHNbIDAgXSAtIHN0b3AuY29vcmRzWyAwIF0gKSA+ICQuZXZlbnQuc3BlY2lhbC5zd2lwZS5zY3JvbGxTdXByZXNzaW9uVGhyZXNob2xkICkgewoJCQkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJCX0KCQkJCX0KCgkJCQkkdGhpcy5iaW5kKCB0b3VjaE1vdmVFdmVudCwgbW92ZUhhbmRsZXIgKQoJCQkJCS5vbmUoIHRvdWNoU3RvcEV2ZW50LCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkJCSR0aGlzLnVuYmluZCggdG91Y2hNb3ZlRXZlbnQsIG1vdmVIYW5kbGVyICk7CgoJCQkJCQlpZiAoIHN0YXJ0ICYmIHN0b3AgKSB7CgkJCQkJCQlpZiAoIHN0b3AudGltZSAtIHN0YXJ0LnRpbWUgPCAkLmV2ZW50LnNwZWNpYWwuc3dpcGUuZHVyYXRpb25UaHJlc2hvbGQgJiYKCQkJCQkJCQlNYXRoLmFicyggc3RhcnQuY29vcmRzWyAwIF0gLSBzdG9wLmNvb3Jkc1sgMCBdICkgPiAkLmV2ZW50LnNwZWNpYWwuc3dpcGUuaG9yaXpvbnRhbERpc3RhbmNlVGhyZXNob2xkICYmCgkJCQkJCQkJTWF0aC5hYnMoIHN0YXJ0LmNvb3Jkc1sgMSBdIC0gc3RvcC5jb29yZHNbIDEgXSApIDwgJC5ldmVudC5zcGVjaWFsLnN3aXBlLnZlcnRpY2FsRGlzdGFuY2VUaHJlc2hvbGQgKSB7CgoJCQkJCQkJCXN0YXJ0Lm9yaWdpbi50cmlnZ2VyKCAic3dpcGUiICkKCQkJCQkJCQkJLnRyaWdnZXIoIHN0YXJ0LmNvb3Jkc1swXSA+IHN0b3AuY29vcmRzWyAwIF0gPyAic3dpcGVsZWZ0IiA6ICJzd2lwZXJpZ2h0IiApOwoJCQkJCQkJfQoJCQkJCQl9CgkJCQkJCXN0YXJ0ID0gc3RvcCA9IHVuZGVmaW5lZDsKCQkJCQl9KTsKCQkJfSk7CgkJfQoJfTsKCSQuZWFjaCh7CgkJc2Nyb2xsc3RvcDogInNjcm9sbHN0YXJ0IiwKCQl0YXBob2xkOiAidGFwIiwKCQlzd2lwZWxlZnQ6ICJzd2lwZSIsCgkJc3dpcGVyaWdodDogInN3aXBlIgoJfSwgZnVuY3Rpb24oIGV2ZW50LCBzb3VyY2VFdmVudCApIHsKCgkJJC5ldmVudC5zcGVjaWFsWyBldmVudCBdID0gewoJCQlzZXR1cDogZnVuY3Rpb24oKSB7CgkJCQkkKCB0aGlzICkuYmluZCggc291cmNlRXZlbnQsICQubm9vcCApOwoJCQl9CgkJfTsKCX0pOwoKfSkoIGpRdWVyeSwgdGhpcyApOwoKCShmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoJCSQuZXh0ZW5kKCAkLnN1cHBvcnQsIHsKCQkJb3JpZW50YXRpb246ICJvcmllbnRhdGlvbiIgaW4gd2luZG93ICYmICJvbm9yaWVudGF0aW9uY2hhbmdlIiBpbiB3aW5kb3cKCQl9KTsKCX0oIGpRdWVyeSApKTsKCgoJLy8gdGhyb3R0bGVkIHJlc2l6ZSBldmVudAoJKGZ1bmN0aW9uKCAkICkgewoJCSQuZXZlbnQuc3BlY2lhbC50aHJvdHRsZWRyZXNpemUgPSB7CgkJCXNldHVwOiBmdW5jdGlvbigpIHsKCQkJCSQoIHRoaXMgKS5iaW5kKCAicmVzaXplIiwgaGFuZGxlciApOwoJCQl9LAoJCQl0ZWFyZG93bjogZnVuY3Rpb24oKSB7CgkJCQkkKCB0aGlzICkudW5iaW5kKCAicmVzaXplIiwgaGFuZGxlciApOwoJCQl9CgkJfTsKCgkJdmFyIHRocm90dGxlID0gMjUwLAoJCQloYW5kbGVyID0gZnVuY3Rpb24oKSB7CgkJCQljdXJyID0gKCBuZXcgRGF0ZSgpICkuZ2V0VGltZSgpOwoJCQkJZGlmZiA9IGN1cnIgLSBsYXN0Q2FsbDsKCgkJCQlpZiAoIGRpZmYgPj0gdGhyb3R0bGUgKSB7CgoJCQkJCWxhc3RDYWxsID0gY3VycjsKCQkJCQkkKCB0aGlzICkudHJpZ2dlciggInRocm90dGxlZHJlc2l6ZSIgKTsKCgkJCQl9IGVsc2UgewoKCQkJCQlpZiAoIGhlbGRDYWxsICkgewoJCQkJCQljbGVhclRpbWVvdXQoIGhlbGRDYWxsICk7CgkJCQkJfQoKCQkJCQkvLyBQcm9taXNlIGEgaGVsZCBjYWxsIHdpbGwgc3RpbGwgZXhlY3V0ZQoJCQkJCWhlbGRDYWxsID0gc2V0VGltZW91dCggaGFuZGxlciwgdGhyb3R0bGUgLSBkaWZmICk7CgkJCQl9CgkJCX0sCgkJCWxhc3RDYWxsID0gMCwKCQkJaGVsZENhbGwsCgkJCWN1cnIsCgkJCWRpZmY7Cgl9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHdpbmRvdyApIHsKCXZhciB3aW4gPSAkKCB3aW5kb3cgKSwKCQlldmVudF9uYW1lID0gIm9yaWVudGF0aW9uY2hhbmdlIiwKCQlzcGVjaWFsX2V2ZW50LAoJCWdldF9vcmllbnRhdGlvbiwKCQlsYXN0X29yaWVudGF0aW9uLAoJCWluaXRpYWxfb3JpZW50YXRpb25faXNfbGFuZHNjYXBlLAoJCWluaXRpYWxfb3JpZW50YXRpb25faXNfZGVmYXVsdCwKCQlwb3J0cmFpdF9tYXAgPSB7ICIwIjogdHJ1ZSwgIjE4MCI6IHRydWUgfTsKCgkvLyBJdCBzZWVtcyB0aGF0IHNvbWUgZGV2aWNlL2Jyb3dzZXIgdmVuZG9ycyB1c2Ugd2luZG93Lm9yaWVudGF0aW9uIHZhbHVlcyAwIGFuZCAxODAgdG8KCS8vIGRlbm90ZSB0aGUgImRlZmF1bHQiIG9yaWVudGF0aW9uLiBGb3IgaU9TIGRldmljZXMsIGFuZCBtb3N0IG90aGVyIHNtYXJ0LXBob25lcyB0ZXN0ZWQsCgkvLyB0aGUgZGVmYXVsdCBvcmllbnRhdGlvbiBpcyBhbHdheXMgInBvcnRyYWl0IiwgYnV0IGluIHNvbWUgQW5kcm9pZCBhbmQgUklNIGJhc2VkIHRhYmxldHMsCgkvLyB0aGUgZGVmYXVsdCBvcmllbnRhdGlvbiBpcyAibGFuZHNjYXBlIi4gVGhlIGZvbGxvd2luZyBjb2RlIGF0dGVtcHRzIHRvIHVzZSB0aGUgd2luZG93CgkvLyBkaW1lbnNpb25zIHRvIGZpZ3VyZSBvdXQgd2hhdCB0aGUgY3VycmVudCBvcmllbnRhdGlvbiBpcywgYW5kIHRoZW4gbWFrZXMgYWRqdXN0bWVudHMKCS8vIHRvIHRoZSB0byB0aGUgcG9ydHJhaXRfbWFwIGlmIG5lY2Vzc2FyeSwgc28gdGhhdCB3ZSBjYW4gcHJvcGVybHkgZGVjb2RlIHRoZQoJLy8gd2luZG93Lm9yaWVudGF0aW9uIHZhbHVlIHdoZW5ldmVyIGdldF9vcmllbnRhdGlvbigpIGlzIGNhbGxlZC4KCS8vCgkvLyBOb3RlIHRoYXQgd2UgdXNlZCB0byB1c2UgYSBtZWRpYSBxdWVyeSB0byBmaWd1cmUgb3V0IHdoYXQgdGhlIG9yaWVudGF0aW9uIHRoZSBicm93c2VyCgkvLyB0aGlua3MgaXQgaXMgaW46CgkvLwoJLy8gICAgIGluaXRpYWxfb3JpZW50YXRpb25faXNfbGFuZHNjYXBlID0gJC5tb2JpbGUubWVkaWEoImFsbCBhbmQgKG9yaWVudGF0aW9uOiBsYW5kc2NhcGUpIik7CgkvLwoJLy8gYnV0IHRoZXJlIHdhcyBhbiBpUGhvbmUvaVBvZCBUb3VjaCBidWcgYmVnaW5uaW5nIHdpdGggaU9TIDQuMiwgdXAgdGhyb3VnaCBpT1MgNS4xLAoJLy8gd2hlcmUgdGhlIGJyb3dzZXIgKkFMV0FZUyogYXBwbGllZCB0aGUgbGFuZHNjYXBlIG1lZGlhIHF1ZXJ5LiBUaGlzIGJ1ZyBkb2VzIG5vdAoJLy8gaGFwcGVuIG9uIGlQYWQuCgoJaWYgKCAkLnN1cHBvcnQub3JpZW50YXRpb24gKSB7CgoJCS8vIENoZWNrIHRoZSB3aW5kb3cgd2lkdGggYW5kIGhlaWdodCB0byBmaWd1cmUgb3V0IHdoYXQgdGhlIGN1cnJlbnQgb3JpZW50YXRpb24KCQkvLyBvZiB0aGUgZGV2aWNlIGlzIGF0IHRoaXMgbW9tZW50LiBOb3RlIHRoYXQgd2UndmUgaW5pdGlhbGl6ZWQgdGhlIHBvcnRyYWl0IG1hcAoJCS8vIHZhbHVlcyB0byAwIGFuZCAxODAsICpBTkQqIHdlIHB1cnBvc2VseSBjaGVjayBmb3IgbGFuZHNjYXBlIHNvIHRoYXQgaWYgd2UgZ3Vlc3MKCQkvLyB3cm9uZywgLCB3ZSBkZWZhdWx0IHRvIHRoZSBhc3N1bXB0aW9uIHRoYXQgcG9ydHJhaXQgaXMgdGhlIGRlZmF1bHQgb3JpZW50YXRpb24uCgkJLy8gV2UgdXNlIGEgdGhyZXNob2xkIGNoZWNrIGJlbG93IGJlY2F1c2Ugb24gc29tZSBwbGF0Zm9ybXMgbGlrZSBpT1MsIHRoZSBpUGhvbmUKCQkvLyBmb3JtLWZhY3RvciBjYW4gcmVwb3J0IGEgbGFyZ2VyIHdpZHRoIHRoYW4gaGVpZ2h0IGlmIHRoZSB1c2VyIHR1cm5zIG9uIHRoZQoJCS8vIGRldmVsb3BlciBjb25zb2xlLiBUaGUgYWN0dWFsIHRocmVzaG9sZCB2YWx1ZSBpcyBzb21ld2hhdCBhcmJpdHJhcnksIHdlIGp1c3QKCQkvLyBuZWVkIHRvIG1ha2Ugc3VyZSBpdCBpcyBsYXJnZSBlbm91Z2ggdG8gZXhjbHVkZSB0aGUgZGV2ZWxvcGVyIGNvbnNvbGUgY2FzZS4KCgkJdmFyIHd3ID0gd2luZG93LmlubmVyV2lkdGggfHwgJCggd2luZG93ICkud2lkdGgoKSwKCQkJd2ggPSB3aW5kb3cuaW5uZXJIZWlnaHQgfHwgJCggd2luZG93ICkuaGVpZ2h0KCksCgkJCWxhbmRzY2FwZV90aHJlc2hvbGQgPSA1MDsKCgkJaW5pdGlhbF9vcmllbnRhdGlvbl9pc19sYW5kc2NhcGUgPSB3dyA+IHdoICYmICggd3cgLSB3aCApID4gbGFuZHNjYXBlX3RocmVzaG9sZDsKCgoJCS8vIE5vdyBjaGVjayB0byBzZWUgaWYgdGhlIGN1cnJlbnQgd2luZG93Lm9yaWVudGF0aW9uIGlzIDAgb3IgMTgwLgoJCWluaXRpYWxfb3JpZW50YXRpb25faXNfZGVmYXVsdCA9IHBvcnRyYWl0X21hcFsgd2luZG93Lm9yaWVudGF0aW9uIF07CgoJCS8vIElmIHRoZSBpbml0aWFsIG9yaWVudGF0aW9uIGlzIGxhbmRzY2FwZSwgYnV0IHdpbmRvdy5vcmllbnRhdGlvbiByZXBvcnRzIDAgb3IgMTgwLCAqT1IqCgkJLy8gaWYgdGhlIGluaXRpYWwgb3JpZW50YXRpb24gaXMgcG9ydHJhaXQsIGJ1dCB3aW5kb3cub3JpZW50YXRpb24gcmVwb3J0cyA5MCBvciAtOTAsIHdlCgkJLy8gbmVlZCB0byBmbGlwIG91ciBwb3J0cmFpdF9tYXAgdmFsdWVzIGJlY2F1c2UgbGFuZHNjYXBlIGlzIHRoZSBkZWZhdWx0IG9yaWVudGF0aW9uIGZvcgoJCS8vIHRoaXMgZGV2aWNlL2Jyb3dzZXIuCgkJaWYgKCAoIGluaXRpYWxfb3JpZW50YXRpb25faXNfbGFuZHNjYXBlICYmIGluaXRpYWxfb3JpZW50YXRpb25faXNfZGVmYXVsdCApIHx8ICggIWluaXRpYWxfb3JpZW50YXRpb25faXNfbGFuZHNjYXBlICYmICFpbml0aWFsX29yaWVudGF0aW9uX2lzX2RlZmF1bHQgKSApIHsKCQkJcG9ydHJhaXRfbWFwID0geyAiLTkwIjogdHJ1ZSwgIjkwIjogdHJ1ZSB9OwoJCX0KCX0KCgkkLmV2ZW50LnNwZWNpYWwub3JpZW50YXRpb25jaGFuZ2UgPSAkLmV4dGVuZCgge30sICQuZXZlbnQuc3BlY2lhbC5vcmllbnRhdGlvbmNoYW5nZSwgewoJCXNldHVwOiBmdW5jdGlvbigpIHsKCQkJLy8gSWYgdGhlIGV2ZW50IGlzIHN1cHBvcnRlZCBuYXRpdmVseSwgcmV0dXJuIGZhbHNlIHNvIHRoYXQgalF1ZXJ5CgkJCS8vIHdpbGwgYmluZCB0byB0aGUgZXZlbnQgdXNpbmcgRE9NIG1ldGhvZHMuCgkJCWlmICggJC5zdXBwb3J0Lm9yaWVudGF0aW9uICYmICEkLmV2ZW50LnNwZWNpYWwub3JpZW50YXRpb25jaGFuZ2UuZGlzYWJsZWQgKSB7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCgkJCS8vIEdldCB0aGUgY3VycmVudCBvcmllbnRhdGlvbiB0byBhdm9pZCBpbml0aWFsIGRvdWJsZS10cmlnZ2VyaW5nLgoJCQlsYXN0X29yaWVudGF0aW9uID0gZ2V0X29yaWVudGF0aW9uKCk7CgoJCQkvLyBCZWNhdXNlIHRoZSBvcmllbnRhdGlvbmNoYW5nZSBldmVudCBkb2Vzbid0IGV4aXN0LCBzaW11bGF0ZSB0aGUKCQkJLy8gZXZlbnQgYnkgdGVzdGluZyB3aW5kb3cgZGltZW5zaW9ucyBvbiByZXNpemUuCgkJCXdpbi5iaW5kKCAidGhyb3R0bGVkcmVzaXplIiwgaGFuZGxlciApOwoJCX0sCgkJdGVhcmRvd246IGZ1bmN0aW9uKCkgewoJCQkvLyBJZiB0aGUgZXZlbnQgaXMgbm90IHN1cHBvcnRlZCBuYXRpdmVseSwgcmV0dXJuIGZhbHNlIHNvIHRoYXQKCQkJLy8galF1ZXJ5IHdpbGwgdW5iaW5kIHRoZSBldmVudCB1c2luZyBET00gbWV0aG9kcy4KCQkJaWYgKCAkLnN1cHBvcnQub3JpZW50YXRpb24gJiYgISQuZXZlbnQuc3BlY2lhbC5vcmllbnRhdGlvbmNoYW5nZS5kaXNhYmxlZCApIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoKCQkJLy8gQmVjYXVzZSB0aGUgb3JpZW50YXRpb25jaGFuZ2UgZXZlbnQgZG9lc24ndCBleGlzdCwgdW5iaW5kIHRoZQoJCQkvLyByZXNpemUgZXZlbnQgaGFuZGxlci4KCQkJd2luLnVuYmluZCggInRocm90dGxlZHJlc2l6ZSIsIGhhbmRsZXIgKTsKCQl9LAoJCWFkZDogZnVuY3Rpb24oIGhhbmRsZU9iaiApIHsKCQkJLy8gU2F2ZSBhIHJlZmVyZW5jZSB0byB0aGUgYm91bmQgZXZlbnQgaGFuZGxlci4KCQkJdmFyIG9sZF9oYW5kbGVyID0gaGFuZGxlT2JqLmhhbmRsZXI7CgoKCQkJaGFuZGxlT2JqLmhhbmRsZXIgPSBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkvLyBNb2RpZnkgZXZlbnQgb2JqZWN0LCBhZGRpbmcgdGhlIC5vcmllbnRhdGlvbiBwcm9wZXJ0eS4KCQkJCWV2ZW50Lm9yaWVudGF0aW9uID0gZ2V0X29yaWVudGF0aW9uKCk7CgoJCQkJLy8gQ2FsbCB0aGUgb3JpZ2luYWxseS1ib3VuZCBldmVudCBoYW5kbGVyIGFuZCByZXR1cm4gaXRzIHJlc3VsdC4KCQkJCXJldHVybiBvbGRfaGFuZGxlci5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgkJCX07CgkJfQoJfSk7CgoJLy8gSWYgdGhlIGV2ZW50IGlzIG5vdCBzdXBwb3J0ZWQgbmF0aXZlbHksIHRoaXMgaGFuZGxlciB3aWxsIGJlIGJvdW5kIHRvCgkvLyB0aGUgd2luZG93IHJlc2l6ZSBldmVudCB0byBzaW11bGF0ZSB0aGUgb3JpZW50YXRpb25jaGFuZ2UgZXZlbnQuCglmdW5jdGlvbiBoYW5kbGVyKCkgewoJCS8vIEdldCB0aGUgY3VycmVudCBvcmllbnRhdGlvbi4KCQl2YXIgb3JpZW50YXRpb24gPSBnZXRfb3JpZW50YXRpb24oKTsKCgkJaWYgKCBvcmllbnRhdGlvbiAhPT0gbGFzdF9vcmllbnRhdGlvbiApIHsKCQkJLy8gVGhlIG9yaWVudGF0aW9uIGhhcyBjaGFuZ2VkLCBzbyB0cmlnZ2VyIHRoZSBvcmllbnRhdGlvbmNoYW5nZSBldmVudC4KCQkJbGFzdF9vcmllbnRhdGlvbiA9IG9yaWVudGF0aW9uOwoJCQl3aW4udHJpZ2dlciggZXZlbnRfbmFtZSApOwoJCX0KCX0KCgkvLyBHZXQgdGhlIGN1cnJlbnQgcGFnZSBvcmllbnRhdGlvbi4gVGhpcyBtZXRob2QgaXMgZXhwb3NlZCBwdWJsaWNseSwgc2hvdWxkIGl0CgkvLyBiZSBuZWVkZWQsIGFzIGpRdWVyeS5ldmVudC5zcGVjaWFsLm9yaWVudGF0aW9uY2hhbmdlLm9yaWVudGF0aW9uKCkKCSQuZXZlbnQuc3BlY2lhbC5vcmllbnRhdGlvbmNoYW5nZS5vcmllbnRhdGlvbiA9IGdldF9vcmllbnRhdGlvbiA9IGZ1bmN0aW9uKCkgewoJCXZhciBpc1BvcnRyYWl0ID0gdHJ1ZSwgZWxlbSA9IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudDsKCgkJLy8gcHJlZmVyIHdpbmRvdyBvcmllbnRhdGlvbiB0byB0aGUgY2FsY3VsYXRpb24gYmFzZWQgb24gc2NyZWVuc2l6ZSBhcwoJCS8vIHRoZSBhY3R1YWwgc2NyZWVuIHJlc2l6ZSB0YWtlcyBwbGFjZSBiZWZvcmUgb3IgYWZ0ZXIgdGhlIG9yaWVudGF0aW9uIGNoYW5nZSBldmVudAoJCS8vIGhhcyBiZWVuIGZpcmVkIGRlcGVuZGluZyBvbiBpbXBsZW1lbnRhdGlvbiAoZWcgYW5kcm9pZCAyLjMgaXMgYmVmb3JlLCBpcGhvbmUgYWZ0ZXIpLgoJCS8vIE1vcmUgdGVzdGluZyBpcyByZXF1aXJlZCB0byBkZXRlcm1pbmUgaWYgYSBtb3JlIHJlbGlhYmxlIG1ldGhvZCBvZiBkZXRlcm1pbmluZyB0aGUgbmV3IHNjcmVlbnNpemUKCQkvLyBpcyBwb3NzaWJsZSB3aGVuIG9yaWVudGF0aW9uY2hhbmdlIGlzIGZpcmVkLiAoZWcsIHVzZSBtZWRpYSBxdWVyaWVzICsgZWxlbWVudCArIG9wYWNpdHkpCgkJaWYgKCAkLnN1cHBvcnQub3JpZW50YXRpb24gKSB7CgkJCS8vIGlmIHRoZSB3aW5kb3cgb3JpZW50YXRpb24gcmVnaXN0ZXJzIGFzIDAgb3IgMTgwIGRlZ3JlZXMgcmVwb3J0CgkJCS8vIHBvcnRyYWl0LCBvdGhlcndpc2UgbGFuZHNjYXBlCgkJCWlzUG9ydHJhaXQgPSBwb3J0cmFpdF9tYXBbIHdpbmRvdy5vcmllbnRhdGlvbiBdOwoJCX0gZWxzZSB7CgkJCWlzUG9ydHJhaXQgPSBlbGVtICYmIGVsZW0uY2xpZW50V2lkdGggLyBlbGVtLmNsaWVudEhlaWdodCA8IDEuMTsKCQl9CgoJCXJldHVybiBpc1BvcnRyYWl0ID8gInBvcnRyYWl0IiA6ICJsYW5kc2NhcGUiOwoJfTsKCgkkLmZuWyBldmVudF9uYW1lIF0gPSBmdW5jdGlvbiggZm4gKSB7CgkJcmV0dXJuIGZuID8gdGhpcy5iaW5kKCBldmVudF9uYW1lLCBmbiApIDogdGhpcy50cmlnZ2VyKCBldmVudF9uYW1lICk7Cgl9OwoKCS8vIGpRdWVyeSA8IDEuOAoJaWYgKCAkLmF0dHJGbiApIHsKCQkkLmF0dHJGblsgZXZlbnRfbmFtZSBdID0gdHJ1ZTsKCX0KCn0oIGpRdWVyeSwgdGhpcyApKTsKCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCnZhciAkd2luZG93ID0gJCggd2luZG93ICksCgkkaHRtbCA9ICQoICJodG1sIiApOwoKLyogJC5tb2JpbGUubWVkaWEgbWV0aG9kOiBwYXNzIGEgQ1NTIG1lZGlhIHR5cGUgb3IgcXVlcnkgYW5kIGdldCBhIGJvb2wgcmV0dXJuCglub3RlOiB0aGlzIGZlYXR1cmUgcmVsaWVzIG9uIGFjdHVhbCBtZWRpYSBxdWVyeSBzdXBwb3J0IGZvciBtZWRpYSBxdWVyaWVzLCB0aG91Z2ggdHlwZXMgd2lsbCB3b3JrIG1vc3QgYW55d2hlcmUKCWV4YW1wbGVzOgoJCSQubW9iaWxlLm1lZGlhKCdzY3JlZW4nKSAvLyB0ZXN0cyBmb3Igc2NyZWVuIG1lZGlhIHR5cGUKCQkkLm1vYmlsZS5tZWRpYSgnc2NyZWVuIGFuZCAobWluLXdpZHRoOiA0ODBweCknKSAvLyB0ZXN0cyBmb3Igc2NyZWVuIG1lZGlhIHR5cGUgd2l0aCB3aW5kb3cgd2lkdGggPiA0ODBweAoJCSQubW9iaWxlLm1lZGlhKCdAbWVkaWEgc2NyZWVuIGFuZCAoLXdlYmtpdC1taW4tZGV2aWNlLXBpeGVsLXJhdGlvOiAyKScpIC8vIHRlc3RzIGZvciB3ZWJraXQgMnggcGl4ZWwgcmF0aW8gKGlQaG9uZSA0KQoqLwokLm1vYmlsZS5tZWRpYSA9IChmdW5jdGlvbigpIHsKCS8vIFRPRE86IHVzZSB3aW5kb3cubWF0Y2hNZWRpYSBvbmNlIGF0IGxlYXN0IG9uZSBVQSBpbXBsZW1lbnRzIGl0Cgl2YXIgY2FjaGUgPSB7fSwKCQl0ZXN0RGl2ID0gJCggIjxkaXYgaWQ9J2pxdWVyeS1tZWRpYXRlc3QnPjwvZGl2PiIgKSwKCQlmYWtlQm9keSA9ICQoICI8Ym9keT4iICkuYXBwZW5kKCB0ZXN0RGl2ICk7CgoJcmV0dXJuIGZ1bmN0aW9uKCBxdWVyeSApIHsKCQlpZiAoICEoIHF1ZXJ5IGluIGNhY2hlICkgKSB7CgkJCXZhciBzdHlsZUJsb2NrID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggInN0eWxlIiApLAoJCQkJY3NzcnVsZSA9ICJAbWVkaWEgIiArIHF1ZXJ5ICsgIiB7ICNqcXVlcnktbWVkaWF0ZXN0IHsgcG9zaXRpb246YWJzb2x1dGU7IH0gfSI7CgoJCQkvL211c3Qgc2V0IHR5cGUgZm9yIElFIQoJCQlzdHlsZUJsb2NrLnR5cGUgPSAidGV4dC9jc3MiOwoKCQkJaWYgKCBzdHlsZUJsb2NrLnN0eWxlU2hlZXQgKSB7CgkJCQlzdHlsZUJsb2NrLnN0eWxlU2hlZXQuY3NzVGV4dCA9IGNzc3J1bGU7CgkJCX0gZWxzZSB7CgkJCQlzdHlsZUJsb2NrLmFwcGVuZENoaWxkKCBkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZShjc3NydWxlKSApOwoJCQl9CgoJCQkkaHRtbC5wcmVwZW5kKCBmYWtlQm9keSApLnByZXBlbmQoIHN0eWxlQmxvY2sgKTsKCQkJY2FjaGVbIHF1ZXJ5IF0gPSB0ZXN0RGl2LmNzcyggInBvc2l0aW9uIiApID09PSAiYWJzb2x1dGUiOwoJCQlmYWtlQm9keS5hZGQoIHN0eWxlQmxvY2sgKS5yZW1vdmUoKTsKCQl9CgkJcmV0dXJuIGNhY2hlWyBxdWVyeSBdOwoJfTsKfSkoKTsKCn0pKGpRdWVyeSk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCi8vIHRoeCBNb2Rlcm5penIKZnVuY3Rpb24gcHJvcEV4aXN0cyggcHJvcCApIHsKCXZhciB1Y19wcm9wID0gcHJvcC5jaGFyQXQoIDAgKS50b1VwcGVyQ2FzZSgpICsgcHJvcC5zdWJzdHIoIDEgKSwKCQlwcm9wcyA9ICggcHJvcCArICIgIiArIHZlbmRvcnMuam9pbiggdWNfcHJvcCArICIgIiApICsgdWNfcHJvcCApLnNwbGl0KCAiICIgKTsKCglmb3IgKCB2YXIgdiBpbiBwcm9wcyApIHsKCQlpZiAoIGZiQ1NTWyBwcm9wc1sgdiBdIF0gIT09IHVuZGVmaW5lZCApIHsKCQkJcmV0dXJuIHRydWU7CgkJfQoJfQp9Cgp2YXIgZmFrZUJvZHkgPSAkKCAiPGJvZHk+IiApLnByZXBlbmRUbyggImh0bWwiICksCglmYkNTUyA9IGZha2VCb2R5WyAwIF0uc3R5bGUsCgl2ZW5kb3JzID0gWyAiV2Via2l0IiwgIk1veiIsICJPIiBdLAoJd2Vib3MgPSAicGFsbUdldFJlc291cmNlIiBpbiB3aW5kb3csIC8vb25seSB1c2VkIHRvIHJ1bGUgb3V0IHNjcm9sbFRvcAoJb3BlcmEgPSB3aW5kb3cub3BlcmEsCglvcGVyYW1pbmkgPSB3aW5kb3cub3BlcmFtaW5pICYmICh7fSkudG9TdHJpbmcuY2FsbCggd2luZG93Lm9wZXJhbWluaSApID09PSAiW29iamVjdCBPcGVyYU1pbmldIiwKCWJiID0gd2luZG93LmJsYWNrYmVycnkgJiYgIXByb3BFeGlzdHMoICItd2Via2l0LXRyYW5zZm9ybSIgKTsgLy9vbmx5IHVzZWQgdG8gcnVsZSBvdXQgYm94IHNoYWRvdywgYXMgaXQncyBmaWxsZWQgb3BhcXVlIG9uIEJCIDUgYW5kIGxvd2VyCgoKZnVuY3Rpb24gdmFsaWRTdHlsZSggcHJvcCwgdmFsdWUsIGNoZWNrX3ZlbmQgKSB7Cgl2YXIgZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggJ2RpdicgKSwKCQl1YyA9IGZ1bmN0aW9uKCB0eHQgKSB7CgkJCXJldHVybiB0eHQuY2hhckF0KCAwICkudG9VcHBlckNhc2UoKSArIHR4dC5zdWJzdHIoIDEgKTsKCQl9LAoJCXZlbmRfcHJlZiA9IGZ1bmN0aW9uKCB2ZW5kICkgewoJCQlyZXR1cm4gICItIiArIHZlbmQuY2hhckF0KCAwICkudG9Mb3dlckNhc2UoKSArIHZlbmQuc3Vic3RyKCAxICkgKyAiLSI7CgkJfSwKCQljaGVja19zdHlsZSA9IGZ1bmN0aW9uKCB2ZW5kICkgewoJCQl2YXIgdmVuZF9wcm9wID0gdmVuZF9wcmVmKCB2ZW5kICkgKyBwcm9wICsgIjogIiArIHZhbHVlICsgIjsiLAoJCQkJdWNfdmVuZCA9IHVjKCB2ZW5kICksCgkJCQlwcm9wU3R5bGUgPSB1Y192ZW5kICsgdWMoIHByb3AgKTsKCgkJCWRpdi5zZXRBdHRyaWJ1dGUoICJzdHlsZSIsIHZlbmRfcHJvcCApOwoKCQkJaWYgKCAhIWRpdi5zdHlsZVsgcHJvcFN0eWxlIF0gKSB7CgkJCQlyZXQgPSB0cnVlOwoJCQl9CgkJfSwKCQljaGVja192ZW5kcyA9IGNoZWNrX3ZlbmQgPyBbIGNoZWNrX3ZlbmQgXSA6IHZlbmRvcnMsCgkJcmV0OwoKCWZvciggdmFyIGkgPSAwOyBpIDwgY2hlY2tfdmVuZHMubGVuZ3RoOyBpKysgKSB7CgkJY2hlY2tfc3R5bGUoIGNoZWNrX3ZlbmRzW2ldICk7Cgl9CglyZXR1cm4gISFyZXQ7Cn0KCi8vIFRoYW5rcyB0byBNb2Rlcm5penIgc3JjIGZvciB0aGlzIHRlc3QgaWRlYS4gYHBlcnNwZWN0aXZlYCBjaGVjayBpcyBsaW1pdGVkIHRvIE1veiB0byBwcmV2ZW50IGEgZmFsc2UgcG9zaXRpdmUgZm9yIDNEIHRyYW5zZm9ybXMgb24gQW5kcm9pZC4KZnVuY3Rpb24gdHJhbnNmb3JtM2RUZXN0KCkgewoJdmFyIHByb3AgPSAidHJhbnNmb3JtLTNkIjsKCXJldHVybiB2YWxpZFN0eWxlKCAncGVyc3BlY3RpdmUnLCAnMTBweCcsICdtb3onICkgfHwgJC5tb2JpbGUubWVkaWEoICIoLSIgKyB2ZW5kb3JzLmpvaW4oICItIiArIHByb3AgKyAiKSwoLSIgKSArICItIiArIHByb3AgKyAiKSwoIiArIHByb3AgKyAiKSIgKTsKfQoKLy8gVGVzdCBmb3IgZHluYW1pYy11cGRhdGluZyBiYXNlIHRhZyBzdXBwb3J0ICggYWxsb3dzIHVzIHRvIGF2b2lkIGhyZWYsc3JjIGF0dHIgcmV3cml0aW5nICkKZnVuY3Rpb24gYmFzZVRhZ1Rlc3QoKSB7Cgl2YXIgZmF1eEJhc2UgPSBsb2NhdGlvbi5wcm90b2NvbCArICIvLyIgKyBsb2NhdGlvbi5ob3N0ICsgbG9jYXRpb24ucGF0aG5hbWUgKyAidWktZGlyLyIsCgkJYmFzZSA9ICQoICJoZWFkIGJhc2UiICksCgkJZmF1eEVsZSA9IG51bGwsCgkJaHJlZiA9ICIiLAoJCWxpbmssIHJlYmFzZTsKCglpZiAoICFiYXNlLmxlbmd0aCApIHsKCQliYXNlID0gZmF1eEVsZSA9ICQoICI8YmFzZT4iLCB7ICJocmVmIjogZmF1eEJhc2UgfSkuYXBwZW5kVG8oICJoZWFkIiApOwoJfSBlbHNlIHsKCQlocmVmID0gYmFzZS5hdHRyKCAiaHJlZiIgKTsKCX0KCglsaW5rID0gJCggIjxhIGhyZWY9J3Rlc3R1cmwnIC8+IiApLnByZXBlbmRUbyggZmFrZUJvZHkgKTsKCXJlYmFzZSA9IGxpbmtbIDAgXS5ocmVmOwoJYmFzZVsgMCBdLmhyZWYgPSBocmVmIHx8IGxvY2F0aW9uLnBhdGhuYW1lOwoKCWlmICggZmF1eEVsZSApIHsKCQlmYXV4RWxlLnJlbW92ZSgpOwoJfQoJcmV0dXJuIHJlYmFzZS5pbmRleE9mKCBmYXV4QmFzZSApID09PSAwOwp9CgovLyBUaGFua3MgTW9kZXJuaXpyCmZ1bmN0aW9uIGNzc1BvaW50ZXJFdmVudHNUZXN0KCkgewoJdmFyIGVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAneCcgKSwKCQlkb2N1bWVudEVsZW1lbnQgPSBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQsCgkJZ2V0Q29tcHV0ZWRTdHlsZSA9IHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlLAoJCXN1cHBvcnRzOwoKCWlmICggISggJ3BvaW50ZXJFdmVudHMnIGluIGVsZW1lbnQuc3R5bGUgKSApIHsKCQlyZXR1cm4gZmFsc2U7Cgl9CgoJZWxlbWVudC5zdHlsZS5wb2ludGVyRXZlbnRzID0gJ2F1dG8nOwoJZWxlbWVudC5zdHlsZS5wb2ludGVyRXZlbnRzID0gJ3gnOwoJZG9jdW1lbnRFbGVtZW50LmFwcGVuZENoaWxkKCBlbGVtZW50ICk7CglzdXBwb3J0cyA9IGdldENvbXB1dGVkU3R5bGUgJiYKCWdldENvbXB1dGVkU3R5bGUoIGVsZW1lbnQsICcnICkucG9pbnRlckV2ZW50cyA9PT0gJ2F1dG8nOwoJZG9jdW1lbnRFbGVtZW50LnJlbW92ZUNoaWxkKCBlbGVtZW50ICk7CglyZXR1cm4gISFzdXBwb3J0czsKfQoKZnVuY3Rpb24gYm91bmRpbmdSZWN0KCkgewoJdmFyIGRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJkaXYiICk7CglyZXR1cm4gdHlwZW9mIGRpdi5nZXRCb3VuZGluZ0NsaWVudFJlY3QgIT09ICJ1bmRlZmluZWQiOwp9CgovLyBub24tVUEtYmFzZWQgSUUgdmVyc2lvbiBjaGVjayBieSBKYW1lcyBQYWRvbHNleSwgbW9kaWZpZWQgYnkgamRhbHRvbiAtIGZyb20gaHR0cDovL2dpc3QuZ2l0aHViLmNvbS81Mjc2ODMKLy8gYWxsb3dzIGZvciBpbmNsdXNpb24gb2YgSUUgNissIGluY2x1ZGluZyBXaW5kb3dzIE1vYmlsZSA3CiQuZXh0ZW5kKCAkLm1vYmlsZSwgeyBicm93c2VyOiB7fSB9ICk7CiQubW9iaWxlLmJyb3dzZXIuaWUgPSAoZnVuY3Rpb24oKSB7Cgl2YXIgdiA9IDMsCgkJZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImRpdiIgKSwKCQlhID0gZGl2LmFsbCB8fCBbXTsKCglkbyB7CgkJZGl2LmlubmVySFRNTCA9ICI8IS0tW2lmIGd0IElFICIgKyAoICsrdiApICsgIl0+PGJyPjwhW2VuZGlmXS0tPiI7Cgl9IHdoaWxlKCBhWzBdICk7CgoJcmV0dXJuIHYgPiA0ID8gdiA6ICF2Owp9KSgpOwoKCiQuZXh0ZW5kKCAkLnN1cHBvcnQsIHsKCWNzc1RyYW5zaXRpb25zOiAiV2ViS2l0VHJhbnNpdGlvbkV2ZW50IiBpbiB3aW5kb3cgfHwgdmFsaWRTdHlsZSggJ3RyYW5zaXRpb24nLCAnaGVpZ2h0IDEwMG1zIGxpbmVhcicgKSAmJiAhb3BlcmEsCglwdXNoU3RhdGU6ICJwdXNoU3RhdGUiIGluIGhpc3RvcnkgJiYgInJlcGxhY2VTdGF0ZSIgaW4gaGlzdG9yeSwKCW1lZGlhcXVlcnk6ICQubW9iaWxlLm1lZGlhKCAib25seSBhbGwiICksCgljc3NQc2V1ZG9FbGVtZW50OiAhIXByb3BFeGlzdHMoICJjb250ZW50IiApLAoJdG91Y2hPdmVyZmxvdzogISFwcm9wRXhpc3RzKCAib3ZlcmZsb3dTY3JvbGxpbmciICksCgljc3NUcmFuc2Zvcm0zZDogdHJhbnNmb3JtM2RUZXN0KCksCglib3hTaGFkb3c6ICEhcHJvcEV4aXN0cyggImJveFNoYWRvdyIgKSAmJiAhYmIsCglzY3JvbGxUb3A6ICggInBhZ2VYT2Zmc2V0IiBpbiB3aW5kb3cgfHwgInNjcm9sbFRvcCIgaW4gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50IHx8ICJzY3JvbGxUb3AiIGluIGZha2VCb2R5WyAwIF0gKSAmJiAhd2Vib3MgJiYgIW9wZXJhbWluaSwKCWR5bmFtaWNCYXNlVGFnOiBiYXNlVGFnVGVzdCgpLAoJY3NzUG9pbnRlckV2ZW50czogY3NzUG9pbnRlckV2ZW50c1Rlc3QoKSwKCWJvdW5kaW5nUmVjdDogYm91bmRpbmdSZWN0KCkKfSk7CgpmYWtlQm9keS5yZW1vdmUoKTsKCgovLyAkLm1vYmlsZS5hamF4QmxhY2tsaXN0IGlzIHVzZWQgdG8gb3ZlcnJpZGUgYWpheEVuYWJsZWQgb24gcGxhdGZvcm1zIHRoYXQgaGF2ZSBrbm93biBjb25mbGljdHMgd2l0aCBoYXNoIGhpc3RvcnkgdXBkYXRlcyAoQkI1LCBTeW1iaWFuKQovLyBvciB0aGF0IGdlbmVyYWxseSB3b3JrIGJldHRlciBicm93c2luZyBpbiByZWd1bGFyIGh0dHAgZm9yIGZ1bGwgcGFnZSByZWZyZXNoZXMgKE9wZXJhIE1pbmkpCi8vIE5vdGU6IFRoaXMgZGV0ZWN0aW9uIGJlbG93IGlzIHVzZWQgYXMgYSBsYXN0IHJlc29ydC4KLy8gV2UgcmVjb21tZW5kIG9ubHkgdXNpbmcgdGhlc2UgZGV0ZWN0aW9uIG1ldGhvZHMgd2hlbiBhbGwgb3RoZXIgbW9yZSByZWxpYWJsZS9mb3J3YXJkLWxvb2tpbmcgYXBwcm9hY2hlcyBhcmUgbm90IHBvc3NpYmxlCnZhciBub2tpYUxURTdfMyA9IChmdW5jdGlvbigpIHsKCgl2YXIgdWEgPSB3aW5kb3cubmF2aWdhdG9yLnVzZXJBZ2VudDsKCgkvL1RoZSBmb2xsb3dpbmcgaXMgYW4gYXR0ZW1wdCB0byBtYXRjaCBOb2tpYSBicm93c2VycyB0aGF0IGFyZSBydW5uaW5nIFN5bWJpYW4vczYwLCB3aXRoIHdlYmtpdCwgdmVyc2lvbiA3LjMgb3Igb2xkZXIKCXJldHVybiB1YS5pbmRleE9mKCAiTm9raWEiICkgPiAtMSAmJgoJCQkoIHVhLmluZGV4T2YoICJTeW1iaWFuLzMiICkgPiAtMSB8fCB1YS5pbmRleE9mKCAiU2VyaWVzNjAvNSIgKSA+IC0xICkgJiYKCQkJdWEuaW5kZXhPZiggIkFwcGxlV2ViS2l0IiApID4gLTEgJiYKCQkJdWEubWF0Y2goIC8oQnJvd3Nlck5HfE5va2lhQnJvd3NlcilcLzdcLlswLTNdLyApOwp9KSgpOwoKLy8gU3VwcG9ydCBjb25kaXRpb25zIHRoYXQgbXVzdCBiZSBtZXQgaW4gb3JkZXIgdG8gcHJvY2VlZAovLyBkZWZhdWx0IGVuaGFuY2VkIHF1YWxpZmljYXRpb25zIGFyZSBtZWRpYSBxdWVyeSBzdXBwb3J0IE9SIElFIDcrCgokLm1vYmlsZS5ncmFkZUEgPSBmdW5jdGlvbigpIHsKCXJldHVybiAoICQuc3VwcG9ydC5tZWRpYXF1ZXJ5IHx8ICQubW9iaWxlLmJyb3dzZXIuaWUgJiYgJC5tb2JpbGUuYnJvd3Nlci5pZSA+PSA3ICkgJiYgKCAkLnN1cHBvcnQuYm91bmRpbmdSZWN0IHx8ICQuZm4uanF1ZXJ5Lm1hdGNoKC8xXC5bMC03K11cLlswLTkrXT8vKSAhPT0gbnVsbCApOwp9OwoKJC5tb2JpbGUuYWpheEJsYWNrbGlzdCA9CgkJCS8vIEJsYWNrQmVycnkgYnJvd3NlcnMsIHByZS13ZWJraXQKCQkJd2luZG93LmJsYWNrYmVycnkgJiYgIXdpbmRvdy5XZWJLaXRQb2ludCB8fAoJCQkvLyBPcGVyYSBNaW5pCgkJCW9wZXJhbWluaSB8fAoJCQkvLyBTeW1iaWFuIHdlYmtpdHMgcHJlIDcuMwoJCQlub2tpYUxURTdfMzsKCi8vIExhc3RseSwgdGhpcyB3b3JrYXJvdW5kIGlzIHRoZSBvbmx5IHdheSB3ZSd2ZSBmb3VuZCBzbyBmYXIgdG8gZ2V0IHByZSA3LjMgU3ltYmlhbiB3ZWJraXQgZGV2aWNlcwovLyB0byByZW5kZXIgdGhlIHN0eWxlc2hlZXRzIHdoZW4gdGhleSdyZSByZWZlcmVuY2VkIGJlZm9yZSB0aGlzIHNjcmlwdCwgYXMgd2UnZCByZWNvbW1lbmQgZG9pbmcuCi8vIFRoaXMgc2ltcGx5IHJlYXBwZW5kcyB0aGUgQ1NTIGluIHBsYWNlLCB3aGljaCBmb3Igc29tZSByZWFzb24gbWFrZXMgaXQgYXBwbHkKaWYgKCBub2tpYUxURTdfMyApIHsKCSQoZnVuY3Rpb24oKSB7CgkJJCggImhlYWQgbGlua1tyZWw9J3N0eWxlc2hlZXQnXSIgKS5hdHRyKCAicmVsIiwgImFsdGVybmF0ZSBzdHlsZXNoZWV0IiApLmF0dHIoICJyZWwiLCAic3R5bGVzaGVldCIgKTsKCX0pOwp9CgovLyBGb3IgcnVsaW5nIG91dCBzaGFkb3dzIHZpYSBjc3MKaWYgKCAhJC5zdXBwb3J0LmJveFNoYWRvdyApIHsKCSQoICJodG1sIiApLmFkZENsYXNzKCAidWktbW9iaWxlLW5vc3VwcG9ydC1ib3hzaGFkb3ciICk7Cn0KCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUucGFnZSIsICQubW9iaWxlLndpZGdldCwgewoJb3B0aW9uczogewoJCXRoZW1lOiAiYyIsCgkJZG9tQ2FjaGU6IGZhbHNlLAoJCWtlZXBOYXRpdmVEZWZhdWx0OiAiOmpxbURhdGEocm9sZT0nbm9uZScpLCA6anFtRGF0YShyb2xlPSdub2pzJykiCgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCQoJCXZhciBzZWxmID0gdGhpczsKCQkKCQkvLyBpZiBmYWxzZSBpcyByZXR1cm5lZCBieSB0aGUgY2FsbGJhY2tzIGRvIG5vdCBjcmVhdGUgdGhlIHBhZ2UKCQlpZiAoIHNlbGYuX3RyaWdnZXIoICJiZWZvcmVjcmVhdGUiICkgPT09IGZhbHNlICkgewoJCQlyZXR1cm4gZmFsc2U7CgkJfQoKCQlzZWxmLmVsZW1lbnQKCQkJLmF0dHIoICJ0YWJpbmRleCIsICIwIiApCgkJCS5hZGRDbGFzcyggInVpLXBhZ2UgdWktYm9keS0iICsgc2VsZi5vcHRpb25zLnRoZW1lICkKCQkJLmJpbmQoICJwYWdlYmVmb3JlaGlkZSIsIGZ1bmN0aW9uKCkgewoJCQkJc2VsZi5yZW1vdmVDb250YWluZXJCYWNrZ3JvdW5kKCk7CgkJCX0gKQoJCQkuYmluZCggInBhZ2ViZWZvcmVzaG93IiwgZnVuY3Rpb24oKSB7CgkJCQlzZWxmLnNldENvbnRhaW5lckJhY2tncm91bmQoKTsKCQkJfSApOwoKCX0sCgkKCXJlbW92ZUNvbnRhaW5lckJhY2tncm91bmQ6IGZ1bmN0aW9uKCkgewoJCSQubW9iaWxlLnBhZ2VDb250YWluZXIucmVtb3ZlQ2xhc3MoICJ1aS1vdmVybGF5LSIgKyAkLm1vYmlsZS5nZXRJbmhlcml0ZWRUaGVtZSggdGhpcy5lbGVtZW50LnBhcmVudCgpICkgKTsKCX0sCgkKCS8vIHNldCB0aGUgcGFnZSBjb250YWluZXIgYmFja2dyb3VuZCB0byB0aGUgcGFnZSB0aGVtZQoJc2V0Q29udGFpbmVyQmFja2dyb3VuZDogZnVuY3Rpb24oIHRoZW1lICkgewoJCWlmICggdGhpcy5vcHRpb25zLnRoZW1lICkgewoJCQkkLm1vYmlsZS5wYWdlQ29udGFpbmVyLmFkZENsYXNzKCAidWktb3ZlcmxheS0iICsgKCB0aGVtZSB8fCB0aGlzLm9wdGlvbnMudGhlbWUgKSApOwoJCX0KCX0sCgoJa2VlcE5hdGl2ZVNlbGVjdG9yOiBmdW5jdGlvbigpIHsKCQl2YXIgb3B0aW9ucyA9IHRoaXMub3B0aW9ucywKCQkJa2VlcE5hdGl2ZURlZmluZWQgPSBvcHRpb25zLmtlZXBOYXRpdmUgJiYgJC50cmltKCBvcHRpb25zLmtlZXBOYXRpdmUgKTsKCgkJaWYgKCBrZWVwTmF0aXZlRGVmaW5lZCAmJiBvcHRpb25zLmtlZXBOYXRpdmUgIT09IG9wdGlvbnMua2VlcE5hdGl2ZURlZmF1bHQgKSB7CgkJCXJldHVybiBbb3B0aW9ucy5rZWVwTmF0aXZlLCBvcHRpb25zLmtlZXBOYXRpdmVEZWZhdWx0XS5qb2luKCAiLCAiICk7CgkJfQoKCQlyZXR1cm4gb3B0aW9ucy5rZWVwTmF0aXZlRGVmYXVsdDsKCX0KfSk7Cn0pKCBqUXVlcnkgKTsKCi8vIFNjcmlwdDogalF1ZXJ5IGhhc2hjaGFuZ2UgZXZlbnQKLy8gCi8vICpWZXJzaW9uOiAxLjMsIExhc3QgdXBkYXRlZDogNy8yMS8yMDEwKgovLyAKLy8gUHJvamVjdCBIb21lIC0gaHR0cDovL2JlbmFsbWFuLmNvbS9wcm9qZWN0cy9qcXVlcnktaGFzaGNoYW5nZS1wbHVnaW4vCi8vIEdpdEh1YiAgICAgICAtIGh0dHA6Ly9naXRodWIuY29tL2Nvd2JveS9qcXVlcnktaGFzaGNoYW5nZS8KLy8gU291cmNlICAgICAgIC0gaHR0cDovL2dpdGh1Yi5jb20vY293Ym95L2pxdWVyeS1oYXNoY2hhbmdlL3Jhdy9tYXN0ZXIvanF1ZXJ5LmJhLWhhc2hjaGFuZ2UuanMKLy8gKE1pbmlmaWVkKSAgIC0gaHR0cDovL2dpdGh1Yi5jb20vY293Ym95L2pxdWVyeS1oYXNoY2hhbmdlL3Jhdy9tYXN0ZXIvanF1ZXJ5LmJhLWhhc2hjaGFuZ2UubWluLmpzICgwLjhrYiBnemlwcGVkKQovLyAKLy8gQWJvdXQ6IExpY2Vuc2UKLy8gCi8vIENvcHlyaWdodCAoYykgMjAxMCAiQ293Ym95IiBCZW4gQWxtYW4sCi8vIER1YWwgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBhbmQgR1BMIGxpY2Vuc2VzLgovLyBodHRwOi8vYmVuYWxtYW4uY29tL2Fib3V0L2xpY2Vuc2UvCi8vIAovLyBBYm91dDogRXhhbXBsZXMKLy8gCi8vIFRoZXNlIHdvcmtpbmcgZXhhbXBsZXMsIGNvbXBsZXRlIHdpdGggZnVsbHkgY29tbWVudGVkIGNvZGUsIGlsbHVzdHJhdGUgYSBmZXcKLy8gd2F5cyBpbiB3aGljaCB0aGlzIHBsdWdpbiBjYW4gYmUgdXNlZC4KLy8gCi8vIGhhc2hjaGFuZ2UgZXZlbnQgLSBodHRwOi8vYmVuYWxtYW4uY29tL2NvZGUvcHJvamVjdHMvanF1ZXJ5LWhhc2hjaGFuZ2UvZXhhbXBsZXMvaGFzaGNoYW5nZS8KLy8gZG9jdW1lbnQuZG9tYWluIC0gaHR0cDovL2JlbmFsbWFuLmNvbS9jb2RlL3Byb2plY3RzL2pxdWVyeS1oYXNoY2hhbmdlL2V4YW1wbGVzL2RvY3VtZW50X2RvbWFpbi8KLy8gCi8vIEFib3V0OiBTdXBwb3J0IGFuZCBUZXN0aW5nCi8vIAovLyBJbmZvcm1hdGlvbiBhYm91dCB3aGF0IHZlcnNpb24gb3IgdmVyc2lvbnMgb2YgalF1ZXJ5IHRoaXMgcGx1Z2luIGhhcyBiZWVuCi8vIHRlc3RlZCB3aXRoLCB3aGF0IGJyb3dzZXJzIGl0IGhhcyBiZWVuIHRlc3RlZCBpbiwgYW5kIHdoZXJlIHRoZSB1bml0IHRlc3RzCi8vIHJlc2lkZSAoc28geW91IGNhbiB0ZXN0IGl0IHlvdXJzZWxmKS4KLy8gCi8vIGpRdWVyeSBWZXJzaW9ucyAtIDEuMi42LCAxLjMuMiwgMS40LjEsIDEuNC4yCi8vIEJyb3dzZXJzIFRlc3RlZCAtIEludGVybmV0IEV4cGxvcmVyIDYtOCwgRmlyZWZveCAyLTQsIENocm9tZSA1LTYsIFNhZmFyaSAzLjItNSwKLy8gICAgICAgICAgICAgICAgICAgT3BlcmEgOS42LTEwLjYwLCBpUGhvbmUgMy4xLCBBbmRyb2lkIDEuNi0yLjIsIEJsYWNrQmVycnkgNC42LTUuCi8vIFVuaXQgVGVzdHMgICAgICAtIGh0dHA6Ly9iZW5hbG1hbi5jb20vY29kZS9wcm9qZWN0cy9qcXVlcnktaGFzaGNoYW5nZS91bml0LwovLyAKLy8gQWJvdXQ6IEtub3duIGlzc3VlcwovLyAKLy8gV2hpbGUgdGhpcyBqUXVlcnkgaGFzaGNoYW5nZSBldmVudCBpbXBsZW1lbnRhdGlvbiBpcyBxdWl0ZSBzdGFibGUgYW5kCi8vIHJvYnVzdCwgdGhlcmUgYXJlIGEgZmV3IHVuZm9ydHVuYXRlIGJyb3dzZXIgYnVncyBzdXJyb3VuZGluZyBleHBlY3RlZAovLyBoYXNoY2hhbmdlIGV2ZW50LWJhc2VkIGJlaGF2aW9ycywgaW5kZXBlbmRlbnQgb2YgYW55IEphdmFTY3JpcHQKLy8gd2luZG93Lm9uaGFzaGNoYW5nZSBhYnN0cmFjdGlvbi4gU2VlIHRoZSBmb2xsb3dpbmcgZXhhbXBsZXMgZm9yIG1vcmUKLy8gaW5mb3JtYXRpb246Ci8vIAovLyBDaHJvbWU6IEJhY2sgQnV0dG9uIC0gaHR0cDovL2JlbmFsbWFuLmNvbS9jb2RlL3Byb2plY3RzL2pxdWVyeS1oYXNoY2hhbmdlL2V4YW1wbGVzL2J1Zy1jaHJvbWUtYmFjay1idXR0b24vCi8vIEZpcmVmb3g6IFJlbW90ZSBYTUxIdHRwUmVxdWVzdCAtIGh0dHA6Ly9iZW5hbG1hbi5jb20vY29kZS9wcm9qZWN0cy9qcXVlcnktaGFzaGNoYW5nZS9leGFtcGxlcy9idWctZmlyZWZveC1yZW1vdGUteGhyLwovLyBXZWJLaXQ6IEJhY2sgQnV0dG9uIGluIGFuIElmcmFtZSAtIGh0dHA6Ly9iZW5hbG1hbi5jb20vY29kZS9wcm9qZWN0cy9qcXVlcnktaGFzaGNoYW5nZS9leGFtcGxlcy9idWctd2Via2l0LWhhc2gtaWZyYW1lLwovLyBTYWZhcmk6IEJhY2sgQnV0dG9uIGZyb20gYSBkaWZmZXJlbnQgZG9tYWluIC0gaHR0cDovL2JlbmFsbWFuLmNvbS9jb2RlL3Byb2plY3RzL2pxdWVyeS1oYXNoY2hhbmdlL2V4YW1wbGVzL2J1Zy1zYWZhcmktYmFjay1mcm9tLWRpZmYtZG9tYWluLwovLyAKLy8gQWxzbyBub3RlIHRoYXQgc2hvdWxkIGEgYnJvd3NlciBuYXRpdmVseSBzdXBwb3J0IHRoZSB3aW5kb3cub25oYXNoY2hhbmdlIAovLyBldmVudCwgYnV0IG5vdCByZXBvcnQgdGhhdCBpdCBkb2VzLCB0aGUgZmFsbGJhY2sgcG9sbGluZyBsb29wIHdpbGwgYmUgdXNlZC4KLy8gCi8vIEFib3V0OiBSZWxlYXNlIEhpc3RvcnkKLy8gCi8vIDEuMyAgIC0gKDcvMjEvMjAxMCkgUmVvcmdhbml6ZWQgSUU2LzcgSWZyYW1lIGNvZGUgdG8gbWFrZSBpdCBtb3JlCi8vICAgICAgICAgInJlbW92YWJsZSIgZm9yIG1vYmlsZS1vbmx5IGRldmVsb3BtZW50LiBBZGRlZCBJRTYvNyBkb2N1bWVudC50aXRsZQovLyAgICAgICAgIHN1cHBvcnQuIEF0dGVtcHRlZCB0byBtYWtlIElmcmFtZSBhcyBoaWRkZW4gYXMgcG9zc2libGUgYnkgdXNpbmcKLy8gICAgICAgICB0ZWNobmlxdWVzIGZyb20gaHR0cDovL3d3dy5wYWNpZWxsb2dyb3VwLmNvbS9ibG9nLz9wPTYwNC4gQWRkZWQgCi8vICAgICAgICAgc3VwcG9ydCBmb3IgdGhlICJzaG9ydGN1dCIgZm9ybWF0ICQod2luZG93KS5oYXNoY2hhbmdlKCBmbiApIGFuZAovLyAgICAgICAgICQod2luZG93KS5oYXNoY2hhbmdlKCkgbGlrZSBqUXVlcnkgcHJvdmlkZXMgZm9yIGJ1aWx0LWluIGV2ZW50cy4KLy8gICAgICAgICBSZW5hbWVkIGpRdWVyeS5oYXNoY2hhbmdlRGVsYXkgdG8gPGpRdWVyeS5mbi5oYXNoY2hhbmdlLmRlbGF5PiBhbmQKLy8gICAgICAgICBsb3dlcmVkIGl0cyBkZWZhdWx0IHZhbHVlIHRvIDUwLiBBZGRlZCA8alF1ZXJ5LmZuLmhhc2hjaGFuZ2UuZG9tYWluPgovLyAgICAgICAgIGFuZCA8alF1ZXJ5LmZuLmhhc2hjaGFuZ2Uuc3JjPiBwcm9wZXJ0aWVzIHBsdXMgZG9jdW1lbnQtZG9tYWluLmh0bWwKLy8gICAgICAgICBmaWxlIHRvIGFkZHJlc3MgYWNjZXNzIGRlbmllZCBpc3N1ZXMgd2hlbiBzZXR0aW5nIGRvY3VtZW50LmRvbWFpbiBpbgovLyAgICAgICAgIElFNi83LgovLyAxLjIgICAtICgyLzExLzIwMTApIEZpeGVkIGEgYnVnIHdoZXJlIGNvbWluZyBiYWNrIHRvIGEgcGFnZSB1c2luZyB0aGlzIHBsdWdpbgovLyAgICAgICAgIGZyb20gYSBwYWdlIG9uIGFub3RoZXIgZG9tYWluIHdvdWxkIGNhdXNlIGFuIGVycm9yIGluIFNhZmFyaSA0LiBBbHNvLAovLyAgICAgICAgIElFNi83IElmcmFtZSBpcyBub3cgaW5zZXJ0ZWQgYWZ0ZXIgdGhlIGJvZHkgKHRoaXMgYWN0dWFsbHkgd29ya3MpLAovLyAgICAgICAgIHdoaWNoIHByZXZlbnRzIHRoZSBwYWdlIGZyb20gc2Nyb2xsaW5nIHdoZW4gdGhlIGV2ZW50IGlzIGZpcnN0IGJvdW5kLgovLyAgICAgICAgIEV2ZW50IGNhbiBhbHNvIG5vdyBiZSBib3VuZCBiZWZvcmUgRE9NIHJlYWR5LCBidXQgaXQgd29uJ3QgYmUgdXNhYmxlCi8vICAgICAgICAgYmVmb3JlIHRoZW4gaW4gSUU2LzcuCi8vIDEuMSAgIC0gKDEvMjEvMjAxMCkgSW5jb3Jwb3JhdGVkIGRvY3VtZW50LmRvY3VtZW50TW9kZSB0ZXN0IHRvIGZpeCBJRTggYnVnCi8vICAgICAgICAgd2hlcmUgYnJvd3NlciB2ZXJzaW9uIGlzIGluY29ycmVjdGx5IHJlcG9ydGVkIGFzIDguMCwgZGVzcGl0ZQovLyAgICAgICAgIGluY2x1c2lvbiBvZiB0aGUgWC1VQS1Db21wYXRpYmxlIElFPUVtdWxhdGVJRTcgbWV0YSB0YWcuCi8vIDEuMCAgIC0gKDEvOS8yMDEwKSBJbml0aWFsIFJlbGVhc2UuIEJyb2tlIG91dCB0aGUgalF1ZXJ5IEJCUSBldmVudC5zcGVjaWFsCi8vICAgICAgICAgd2luZG93Lm9uaGFzaGNoYW5nZSBmdW5jdGlvbmFsaXR5IGludG8gYSBzZXBhcmF0ZSBwbHVnaW4gZm9yIHVzZXJzCi8vICAgICAgICAgd2hvIHdhbnQganVzdCB0aGUgYmFzaWMgZXZlbnQgJiBiYWNrIGJ1dHRvbiBzdXBwb3J0LCB3aXRob3V0IGFsbCB0aGUKLy8gICAgICAgICBleHRyYSBhd2Vzb21lbmVzcyB0aGF0IEJCUSBwcm92aWRlcy4gVGhpcyBwbHVnaW4gd2lsbCBiZSBpbmNsdWRlZCBhcwovLyAgICAgICAgIHBhcnQgb2YgalF1ZXJ5IEJCUSwgYnV0IGFsc28gYmUgYXZhaWxhYmxlIHNlcGFyYXRlbHkuCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewogIC8vIFJldXNlZCBzdHJpbmcuCiAgdmFyIHN0cl9oYXNoY2hhbmdlID0gJ2hhc2hjaGFuZ2UnLAogICAgCiAgICAvLyBNZXRob2QgLyBvYmplY3QgcmVmZXJlbmNlcy4KICAgIGRvYyA9IGRvY3VtZW50LAogICAgZmFrZV9vbmhhc2hjaGFuZ2UsCiAgICBzcGVjaWFsID0gJC5ldmVudC5zcGVjaWFsLAogICAgCiAgICAvLyBEb2VzIHRoZSBicm93c2VyIHN1cHBvcnQgd2luZG93Lm9uaGFzaGNoYW5nZT8gTm90ZSB0aGF0IElFOCBydW5uaW5nIGluCiAgICAvLyBJRTcgY29tcGF0aWJpbGl0eSBtb2RlIHJlcG9ydHMgdHJ1ZSBmb3IgJ29uaGFzaGNoYW5nZScgaW4gd2luZG93LCBldmVuCiAgICAvLyB0aG91Z2ggdGhlIGV2ZW50IGlzbid0IHN1cHBvcnRlZCwgc28gYWxzbyB0ZXN0IGRvY3VtZW50LmRvY3VtZW50TW9kZS4KICAgIGRvY19tb2RlID0gZG9jLmRvY3VtZW50TW9kZSwKICAgIHN1cHBvcnRzX29uaGFzaGNoYW5nZSA9ICdvbicgKyBzdHJfaGFzaGNoYW5nZSBpbiB3aW5kb3cgJiYgKCBkb2NfbW9kZSA9PT0gdW5kZWZpbmVkIHx8IGRvY19tb2RlID4gNyApOwogIAogIC8vIEdldCBsb2NhdGlvbi5oYXNoIChvciB3aGF0IHlvdSdkIGV4cGVjdCBsb2NhdGlvbi5oYXNoIHRvIGJlKSBzYW5zIGFueQogIC8vIGxlYWRpbmcgIy4gVGhhbmtzIGZvciBtYWtpbmcgdGhpcyBuZWNlc3NhcnksIEZpcmVmb3ghCiAgZnVuY3Rpb24gZ2V0X2ZyYWdtZW50KCB1cmwgKSB7CiAgICB1cmwgPSB1cmwgfHwgbG9jYXRpb24uaHJlZjsKICAgIHJldHVybiAnIycgKyB1cmwucmVwbGFjZSggL15bXiNdKiM/KC4qKSQvLCAnJDEnICk7CiAgfTsKICAKICAvLyBNZXRob2Q6IGpRdWVyeS5mbi5oYXNoY2hhbmdlCiAgLy8gCiAgLy8gQmluZCBhIGhhbmRsZXIgdG8gdGhlIHdpbmRvdy5vbmhhc2hjaGFuZ2UgZXZlbnQgb3IgdHJpZ2dlciBhbGwgYm91bmQKICAvLyB3aW5kb3cub25oYXNoY2hhbmdlIGV2ZW50IGhhbmRsZXJzLiBUaGlzIGJlaGF2aW9yIGlzIGNvbnNpc3RlbnQgd2l0aAogIC8vIGpRdWVyeSdzIGJ1aWx0LWluIGV2ZW50IGhhbmRsZXJzLgogIC8vIAogIC8vIFVzYWdlOgogIC8vIAogIC8vID4galF1ZXJ5KHdpbmRvdykuaGFzaGNoYW5nZSggWyBoYW5kbGVyIF0gKTsKICAvLyAKICAvLyBBcmd1bWVudHM6CiAgLy8gCiAgLy8gIGhhbmRsZXIgLSAoRnVuY3Rpb24pIE9wdGlvbmFsIGhhbmRsZXIgdG8gYmUgYm91bmQgdG8gdGhlIGhhc2hjaGFuZ2UKICAvLyAgICBldmVudC4gVGhpcyBpcyBhICJzaG9ydGN1dCIgZm9yIHRoZSBtb3JlIHZlcmJvc2UgZm9ybToKICAvLyAgICBqUXVlcnkod2luZG93KS5iaW5kKCAnaGFzaGNoYW5nZScsIGhhbmRsZXIgKS4gSWYgaGFuZGxlciBpcyBvbWl0dGVkLAogIC8vICAgIGFsbCBib3VuZCB3aW5kb3cub25oYXNoY2hhbmdlIGV2ZW50IGhhbmRsZXJzIHdpbGwgYmUgdHJpZ2dlcmVkLiBUaGlzCiAgLy8gICAgaXMgYSBzaG9ydGN1dCBmb3IgdGhlIG1vcmUgdmVyYm9zZQogIC8vICAgIGpRdWVyeSh3aW5kb3cpLnRyaWdnZXIoICdoYXNoY2hhbmdlJyApLiBUaGVzZSBmb3JtcyBhcmUgZGVzY3JpYmVkIGluCiAgLy8gICAgdGhlIDxoYXNoY2hhbmdlIGV2ZW50PiBzZWN0aW9uLgogIC8vIAogIC8vIFJldHVybnM6CiAgLy8gCiAgLy8gIChqUXVlcnkpIFRoZSBpbml0aWFsIGpRdWVyeSBjb2xsZWN0aW9uIG9mIGVsZW1lbnRzLgogIAogIC8vIEFsbG93IHRoZSAic2hvcnRjdXQiIGZvcm1hdCAkKGVsZW0pLmhhc2hjaGFuZ2UoIGZuICkgZm9yIGJpbmRpbmcgYW5kCiAgLy8gJChlbGVtKS5oYXNoY2hhbmdlKCkgZm9yIHRyaWdnZXJpbmcsIGxpa2UgalF1ZXJ5IGRvZXMgZm9yIGJ1aWx0LWluIGV2ZW50cy4KICAkLmZuWyBzdHJfaGFzaGNoYW5nZSBdID0gZnVuY3Rpb24oIGZuICkgewogICAgcmV0dXJuIGZuID8gdGhpcy5iaW5kKCBzdHJfaGFzaGNoYW5nZSwgZm4gKSA6IHRoaXMudHJpZ2dlciggc3RyX2hhc2hjaGFuZ2UgKTsKICB9OwogIAogIC8vIFByb3BlcnR5OiBqUXVlcnkuZm4uaGFzaGNoYW5nZS5kZWxheQogIC8vIAogIC8vIFRoZSBudW1lcmljIGludGVydmFsIChpbiBtaWxsaXNlY29uZHMpIGF0IHdoaWNoIHRoZSA8aGFzaGNoYW5nZSBldmVudD4KICAvLyBwb2xsaW5nIGxvb3AgZXhlY3V0ZXMuIERlZmF1bHRzIHRvIDUwLgogIAogIC8vIFByb3BlcnR5OiBqUXVlcnkuZm4uaGFzaGNoYW5nZS5kb21haW4KICAvLyAKICAvLyBJZiB5b3UncmUgc2V0dGluZyBkb2N1bWVudC5kb21haW4gaW4geW91ciBKYXZhU2NyaXB0LCBhbmQgeW91IHdhbnQgaGFzaAogIC8vIGhpc3RvcnkgdG8gd29yayBpbiBJRTYvNywgbm90IG9ubHkgbXVzdCB0aGlzIHByb3BlcnR5IGJlIHNldCwgYnV0IHlvdSBtdXN0CiAgLy8gYWxzbyBzZXQgZG9jdW1lbnQuZG9tYWluIEJFRk9SRSBqUXVlcnkgaXMgbG9hZGVkIGludG8gdGhlIHBhZ2UuIFRoaXMKICAvLyBwcm9wZXJ0eSBpcyBvbmx5IGFwcGxpY2FibGUgaWYgeW91IGFyZSBzdXBwb3J0aW5nIElFNi83IChvciBJRTggb3BlcmF0aW5nCiAgLy8gaW4gIklFNyBjb21wYXRpYmlsaXR5IiBtb2RlKS4KICAvLyAKICAvLyBJbiBhZGRpdGlvbiwgdGhlIDxqUXVlcnkuZm4uaGFzaGNoYW5nZS5zcmM+IHByb3BlcnR5IG11c3QgYmUgc2V0IHRvIHRoZQogIC8vIHBhdGggb2YgdGhlIGluY2x1ZGVkICJkb2N1bWVudC1kb21haW4uaHRtbCIgZmlsZSwgd2hpY2ggY2FuIGJlIHJlbmFtZWQgb3IKICAvLyBtb2RpZmllZCBpZiBuZWNlc3NhcnkgKG5vdGUgdGhhdCB0aGUgZG9jdW1lbnQuZG9tYWluIHNwZWNpZmllZCBtdXN0IGJlIHRoZQogIC8vIHNhbWUgaW4gYm90aCB5b3VyIG1haW4gSmF2YVNjcmlwdCBhcyB3ZWxsIGFzIGluIHRoaXMgZmlsZSkuCiAgLy8gCiAgLy8gVXNhZ2U6CiAgLy8gCiAgLy8galF1ZXJ5LmZuLmhhc2hjaGFuZ2UuZG9tYWluID0gZG9jdW1lbnQuZG9tYWluOwogIAogIC8vIFByb3BlcnR5OiBqUXVlcnkuZm4uaGFzaGNoYW5nZS5zcmMKICAvLyAKICAvLyBJZiwgZm9yIHNvbWUgcmVhc29uLCB5b3UgbmVlZCB0byBzcGVjaWZ5IGFuIElmcmFtZSBzcmMgZmlsZSAoZm9yIGV4YW1wbGUsCiAgLy8gd2hlbiBzZXR0aW5nIGRvY3VtZW50LmRvbWFpbiBhcyBpbiA8alF1ZXJ5LmZuLmhhc2hjaGFuZ2UuZG9tYWluPiksIHlvdSBjYW4KICAvLyBkbyBzbyB1c2luZyB0aGlzIHByb3BlcnR5LiBOb3RlIHRoYXQgd2hlbiB1c2luZyB0aGlzIHByb3BlcnR5LCBoaXN0b3J5CiAgLy8gd29uJ3QgYmUgcmVjb3JkZWQgaW4gSUU2LzcgdW50aWwgdGhlIElmcmFtZSBzcmMgZmlsZSBsb2Fkcy4gVGhpcyBwcm9wZXJ0eQogIC8vIGlzIG9ubHkgYXBwbGljYWJsZSBpZiB5b3UgYXJlIHN1cHBvcnRpbmcgSUU2LzcgKG9yIElFOCBvcGVyYXRpbmcgaW4gIklFNwogIC8vIGNvbXBhdGliaWxpdHkiIG1vZGUpLgogIC8vIAogIC8vIFVzYWdlOgogIC8vIAogIC8vIGpRdWVyeS5mbi5oYXNoY2hhbmdlLnNyYyA9ICdwYXRoL3RvL2ZpbGUuaHRtbCc7CiAgCiAgJC5mblsgc3RyX2hhc2hjaGFuZ2UgXS5kZWxheSA9IDUwOwogIC8qCiAgJC5mblsgc3RyX2hhc2hjaGFuZ2UgXS5kb21haW4gPSBudWxsOwogICQuZm5bIHN0cl9oYXNoY2hhbmdlIF0uc3JjID0gbnVsbDsKICAqLwogIAogIC8vIEV2ZW50OiBoYXNoY2hhbmdlIGV2ZW50CiAgLy8gCiAgLy8gRmlyZWQgd2hlbiBsb2NhdGlvbi5oYXNoIGNoYW5nZXMuIEluIGJyb3dzZXJzIHRoYXQgc3VwcG9ydCBpdCwgdGhlIG5hdGl2ZQogIC8vIEhUTUw1IHdpbmRvdy5vbmhhc2hjaGFuZ2UgZXZlbnQgaXMgdXNlZCwgb3RoZXJ3aXNlIGEgcG9sbGluZyBsb29wIGlzCiAgLy8gaW5pdGlhbGl6ZWQsIHJ1bm5pbmcgZXZlcnkgPGpRdWVyeS5mbi5oYXNoY2hhbmdlLmRlbGF5PiBtaWxsaXNlY29uZHMgdG8KICAvLyBzZWUgaWYgdGhlIGhhc2ggaGFzIGNoYW5nZWQuIEluIElFNi83IChhbmQgSUU4IG9wZXJhdGluZyBpbiAiSUU3CiAgLy8gY29tcGF0aWJpbGl0eSIgbW9kZSksIGEgaGlkZGVuIElmcmFtZSBpcyBjcmVhdGVkIHRvIGFsbG93IHRoZSBiYWNrIGJ1dHRvbgogIC8vIGFuZCBoYXNoLWJhc2VkIGhpc3RvcnkgdG8gd29yay4KICAvLyAKICAvLyBVc2FnZSBhcyBkZXNjcmliZWQgaW4gPGpRdWVyeS5mbi5oYXNoY2hhbmdlPjoKICAvLyAKICAvLyA+IC8vIEJpbmQgYW4gZXZlbnQgaGFuZGxlci4KICAvLyA+IGpRdWVyeSh3aW5kb3cpLmhhc2hjaGFuZ2UoIGZ1bmN0aW9uKGUpIHsKICAvLyA+ICAgdmFyIGhhc2ggPSBsb2NhdGlvbi5oYXNoOwogIC8vID4gICAuLi4KICAvLyA+IH0pOwogIC8vID4gCiAgLy8gPiAvLyBNYW51YWxseSB0cmlnZ2VyIHRoZSBldmVudCBoYW5kbGVyLgogIC8vID4galF1ZXJ5KHdpbmRvdykuaGFzaGNoYW5nZSgpOwogIC8vIAogIC8vIEEgbW9yZSB2ZXJib3NlIHVzYWdlIHRoYXQgYWxsb3dzIGZvciBldmVudCBuYW1lc3BhY2luZzoKICAvLyAKICAvLyA+IC8vIEJpbmQgYW4gZXZlbnQgaGFuZGxlci4KICAvLyA+IGpRdWVyeSh3aW5kb3cpLmJpbmQoICdoYXNoY2hhbmdlJywgZnVuY3Rpb24oZSkgewogIC8vID4gICB2YXIgaGFzaCA9IGxvY2F0aW9uLmhhc2g7CiAgLy8gPiAgIC4uLgogIC8vID4gfSk7CiAgLy8gPiAKICAvLyA+IC8vIE1hbnVhbGx5IHRyaWdnZXIgdGhlIGV2ZW50IGhhbmRsZXIuCiAgLy8gPiBqUXVlcnkod2luZG93KS50cmlnZ2VyKCAnaGFzaGNoYW5nZScgKTsKICAvLyAKICAvLyBBZGRpdGlvbmFsIE5vdGVzOgogIC8vIAogIC8vICogVGhlIHBvbGxpbmcgbG9vcCBhbmQgSWZyYW1lIGFyZSBub3QgY3JlYXRlZCB1bnRpbCBhdCBsZWFzdCBvbmUgaGFuZGxlcgogIC8vICAgaXMgYWN0dWFsbHkgYm91bmQgdG8gdGhlICdoYXNoY2hhbmdlJyBldmVudC4KICAvLyAqIElmIHlvdSBuZWVkIHRoZSBib3VuZCBoYW5kbGVyKHMpIHRvIGV4ZWN1dGUgaW1tZWRpYXRlbHksIGluIGNhc2VzIHdoZXJlCiAgLy8gICBhIGxvY2F0aW9uLmhhc2ggZXhpc3RzIG9uIHBhZ2UgbG9hZCwgdmlhIGJvb2ttYXJrIG9yIHBhZ2UgcmVmcmVzaCBmb3IKICAvLyAgIGV4YW1wbGUsIHVzZSBqUXVlcnkod2luZG93KS5oYXNoY2hhbmdlKCkgb3IgdGhlIG1vcmUgdmVyYm9zZSAKICAvLyAgIGpRdWVyeSh3aW5kb3cpLnRyaWdnZXIoICdoYXNoY2hhbmdlJyApLgogIC8vICogVGhlIGV2ZW50IGNhbiBiZSBib3VuZCBiZWZvcmUgRE9NIHJlYWR5LCBidXQgc2luY2UgaXQgd29uJ3QgYmUgdXNhYmxlCiAgLy8gICBiZWZvcmUgdGhlbiBpbiBJRTYvNyAoZHVlIHRvIHRoZSBuZWNlc3NhcnkgSWZyYW1lKSwgcmVjb21tZW5kZWQgdXNhZ2UgaXMKICAvLyAgIHRvIGJpbmQgaXQgaW5zaWRlIGEgRE9NIHJlYWR5IGhhbmRsZXIuCiAgCiAgLy8gT3ZlcnJpZGUgZXhpc3RpbmcgJC5ldmVudC5zcGVjaWFsLmhhc2hjaGFuZ2UgbWV0aG9kcyAoYWxsb3dpbmcgdGhpcyBwbHVnaW4KICAvLyB0byBiZSBkZWZpbmVkIGFmdGVyIGpRdWVyeSBCQlEgaW4gQkJRJ3Mgc291cmNlIGNvZGUpLgogIHNwZWNpYWxbIHN0cl9oYXNoY2hhbmdlIF0gPSAkLmV4dGVuZCggc3BlY2lhbFsgc3RyX2hhc2hjaGFuZ2UgXSwgewogICAgCiAgICAvLyBDYWxsZWQgb25seSB3aGVuIHRoZSBmaXJzdCAnaGFzaGNoYW5nZScgZXZlbnQgaXMgYm91bmQgdG8gd2luZG93LgogICAgc2V0dXA6IGZ1bmN0aW9uKCkgewogICAgICAvLyBJZiB3aW5kb3cub25oYXNoY2hhbmdlIGlzIHN1cHBvcnRlZCBuYXRpdmVseSwgdGhlcmUncyBub3RoaW5nIHRvIGRvLi4KICAgICAgaWYgKCBzdXBwb3J0c19vbmhhc2hjaGFuZ2UgKSB7IHJldHVybiBmYWxzZTsgfQogICAgICAKICAgICAgLy8gT3RoZXJ3aXNlLCB3ZSBuZWVkIHRvIGNyZWF0ZSBvdXIgb3duLiBBbmQgd2UgZG9uJ3Qgd2FudCB0byBjYWxsIHRoaXMKICAgICAgLy8gdW50aWwgdGhlIHVzZXIgYmluZHMgdG8gdGhlIGV2ZW50LCBqdXN0IGluIGNhc2UgdGhleSBuZXZlciBkbywgc2luY2UgaXQKICAgICAgLy8gd2lsbCBjcmVhdGUgYSBwb2xsaW5nIGxvb3AgYW5kIHBvc3NpYmx5IGV2ZW4gYSBoaWRkZW4gSWZyYW1lLgogICAgICAkKCBmYWtlX29uaGFzaGNoYW5nZS5zdGFydCApOwogICAgfSwKICAgIAogICAgLy8gQ2FsbGVkIG9ubHkgd2hlbiB0aGUgbGFzdCAnaGFzaGNoYW5nZScgZXZlbnQgaXMgdW5ib3VuZCBmcm9tIHdpbmRvdy4KICAgIHRlYXJkb3duOiBmdW5jdGlvbigpIHsKICAgICAgLy8gSWYgd2luZG93Lm9uaGFzaGNoYW5nZSBpcyBzdXBwb3J0ZWQgbmF0aXZlbHksIHRoZXJlJ3Mgbm90aGluZyB0byBkby4uCiAgICAgIGlmICggc3VwcG9ydHNfb25oYXNoY2hhbmdlICkgeyByZXR1cm4gZmFsc2U7IH0KICAgICAgCiAgICAgIC8vIE90aGVyd2lzZSwgd2UgbmVlZCB0byBzdG9wIG91cnMgKGlmIHBvc3NpYmxlKS4KICAgICAgJCggZmFrZV9vbmhhc2hjaGFuZ2Uuc3RvcCApOwogICAgfQogICAgCiAgfSk7CiAgCiAgLy8gZmFrZV9vbmhhc2hjaGFuZ2UgZG9lcyBhbGwgdGhlIHdvcmsgb2YgdHJpZ2dlcmluZyB0aGUgd2luZG93Lm9uaGFzaGNoYW5nZQogIC8vIGV2ZW50IGZvciBicm93c2VycyB0aGF0IGRvbid0IG5hdGl2ZWx5IHN1cHBvcnQgaXQsIGluY2x1ZGluZyBjcmVhdGluZyBhCiAgLy8gcG9sbGluZyBsb29wIHRvIHdhdGNoIGZvciBoYXNoIGNoYW5nZXMgYW5kIGluIElFIDYvNyBjcmVhdGluZyBhIGhpZGRlbgogIC8vIElmcmFtZSB0byBlbmFibGUgYmFjayBhbmQgZm9yd2FyZC4KICBmYWtlX29uaGFzaGNoYW5nZSA9IChmdW5jdGlvbigpIHsKICAgIHZhciBzZWxmID0ge30sCiAgICAgIHRpbWVvdXRfaWQsCiAgICAgIAogICAgICAvLyBSZW1lbWJlciB0aGUgaW5pdGlhbCBoYXNoIHNvIGl0IGRvZXNuJ3QgZ2V0IHRyaWdnZXJlZCBpbW1lZGlhdGVseS4KICAgICAgbGFzdF9oYXNoID0gZ2V0X2ZyYWdtZW50KCksCiAgICAgIAogICAgICBmbl9yZXR2YWwgPSBmdW5jdGlvbiggdmFsICkgeyByZXR1cm4gdmFsOyB9LAogICAgICBoaXN0b3J5X3NldCA9IGZuX3JldHZhbCwKICAgICAgaGlzdG9yeV9nZXQgPSBmbl9yZXR2YWw7CiAgICAKICAgIC8vIFN0YXJ0IHRoZSBwb2xsaW5nIGxvb3AuCiAgICBzZWxmLnN0YXJ0ID0gZnVuY3Rpb24oKSB7CiAgICAgIHRpbWVvdXRfaWQgfHwgcG9sbCgpOwogICAgfTsKICAgIAogICAgLy8gU3RvcCB0aGUgcG9sbGluZyBsb29wLgogICAgc2VsZi5zdG9wID0gZnVuY3Rpb24oKSB7CiAgICAgIHRpbWVvdXRfaWQgJiYgY2xlYXJUaW1lb3V0KCB0aW1lb3V0X2lkICk7CiAgICAgIHRpbWVvdXRfaWQgPSB1bmRlZmluZWQ7CiAgICB9OwogICAgCiAgICAvLyBUaGlzIHBvbGxpbmcgbG9vcCBjaGVja3MgZXZlcnkgJC5mbi5oYXNoY2hhbmdlLmRlbGF5IG1pbGxpc2Vjb25kcyB0byBzZWUKICAgIC8vIGlmIGxvY2F0aW9uLmhhc2ggaGFzIGNoYW5nZWQsIGFuZCB0cmlnZ2VycyB0aGUgJ2hhc2hjaGFuZ2UnIGV2ZW50IG9uCiAgICAvLyB3aW5kb3cgd2hlbiBuZWNlc3NhcnkuCiAgICBmdW5jdGlvbiBwb2xsKCkgewogICAgICB2YXIgaGFzaCA9IGdldF9mcmFnbWVudCgpLAogICAgICAgIGhpc3RvcnlfaGFzaCA9IGhpc3RvcnlfZ2V0KCBsYXN0X2hhc2ggKTsKICAgICAgCiAgICAgIGlmICggaGFzaCAhPT0gbGFzdF9oYXNoICkgewogICAgICAgIGhpc3Rvcnlfc2V0KCBsYXN0X2hhc2ggPSBoYXNoLCBoaXN0b3J5X2hhc2ggKTsKICAgICAgICAKICAgICAgICAkKHdpbmRvdykudHJpZ2dlciggc3RyX2hhc2hjaGFuZ2UgKTsKICAgICAgICAKICAgICAgfSBlbHNlIGlmICggaGlzdG9yeV9oYXNoICE9PSBsYXN0X2hhc2ggKSB7CiAgICAgICAgbG9jYXRpb24uaHJlZiA9IGxvY2F0aW9uLmhyZWYucmVwbGFjZSggLyMuKi8sICcnICkgKyBoaXN0b3J5X2hhc2g7CiAgICAgIH0KICAgICAgCiAgICAgIHRpbWVvdXRfaWQgPSBzZXRUaW1lb3V0KCBwb2xsLCAkLmZuWyBzdHJfaGFzaGNoYW5nZSBdLmRlbGF5ICk7CiAgICB9OwogICAgCiAgICAvLyB2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnYKICAgIC8vIHZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnYgUkVNT1ZFIElGIE5PVCBTVVBQT1JUSU5HIElFNi83LzggdnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dgogICAgLy8gdnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2CiAgICAkLmJyb3dzZXIubXNpZSAmJiAhc3VwcG9ydHNfb25oYXNoY2hhbmdlICYmIChmdW5jdGlvbigpIHsKICAgICAgLy8gTm90IG9ubHkgZG8gSUU2LzcgbmVlZCB0aGUgIm1hZ2ljYWwiIElmcmFtZSB0cmVhdG1lbnQsIGJ1dCBzbyBkb2VzIElFOAogICAgICAvLyB3aGVuIHJ1bm5pbmcgaW4gIklFNyBjb21wYXRpYmlsaXR5IiBtb2RlLgogICAgICAKICAgICAgdmFyIGlmcmFtZSwKICAgICAgICBpZnJhbWVfc3JjOwogICAgICAKICAgICAgLy8gV2hlbiB0aGUgZXZlbnQgaXMgYm91bmQgYW5kIHBvbGxpbmcgc3RhcnRzIGluIElFIDYvNywgY3JlYXRlIGEgaGlkZGVuCiAgICAgIC8vIElmcmFtZSBmb3IgaGlzdG9yeSBoYW5kbGluZy4KICAgICAgc2VsZi5zdGFydCA9IGZ1bmN0aW9uKCkgewogICAgICAgIGlmICggIWlmcmFtZSApIHsKICAgICAgICAgIGlmcmFtZV9zcmMgPSAkLmZuWyBzdHJfaGFzaGNoYW5nZSBdLnNyYzsKICAgICAgICAgIGlmcmFtZV9zcmMgPSBpZnJhbWVfc3JjICYmIGlmcmFtZV9zcmMgKyBnZXRfZnJhZ21lbnQoKTsKICAgICAgICAgIAogICAgICAgICAgLy8gQ3JlYXRlIGhpZGRlbiBJZnJhbWUuIEF0dGVtcHQgdG8gbWFrZSBJZnJhbWUgYXMgaGlkZGVuIGFzIHBvc3NpYmxlCiAgICAgICAgICAvLyBieSB1c2luZyB0ZWNobmlxdWVzIGZyb20gaHR0cDovL3d3dy5wYWNpZWxsb2dyb3VwLmNvbS9ibG9nLz9wPTYwNC4KICAgICAgICAgIGlmcmFtZSA9ICQoJzxpZnJhbWUgdGFiaW5kZXg9Ii0xIiB0aXRsZT0iZW1wdHkiLz4nKS5oaWRlKCkKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFdoZW4gSWZyYW1lIGhhcyBjb21wbGV0ZWx5IGxvYWRlZCwgaW5pdGlhbGl6ZSB0aGUgaGlzdG9yeSBhbmQKICAgICAgICAgICAgLy8gc3RhcnQgcG9sbGluZy4KICAgICAgICAgICAgLm9uZSggJ2xvYWQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBpZnJhbWVfc3JjIHx8IGhpc3Rvcnlfc2V0KCBnZXRfZnJhZ21lbnQoKSApOwogICAgICAgICAgICAgIHBvbGwoKTsKICAgICAgICAgICAgfSkKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIExvYWQgSWZyYW1lIHNyYyBpZiBzcGVjaWZpZWQsIG90aGVyd2lzZSBub3RoaW5nLgogICAgICAgICAgICAuYXR0ciggJ3NyYycsIGlmcmFtZV9zcmMgfHwgJ2phdmFzY3JpcHQ6MCcgKQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQXBwZW5kIElmcmFtZSBhZnRlciB0aGUgZW5kIG9mIHRoZSBib2R5IHRvIHByZXZlbnQgdW5uZWNlc3NhcnkKICAgICAgICAgICAgLy8gaW5pdGlhbCBwYWdlIHNjcm9sbGluZyAoeWVzLCB0aGlzIHdvcmtzKS4KICAgICAgICAgICAgLmluc2VydEFmdGVyKCAnYm9keScgKVswXS5jb250ZW50V2luZG93OwogICAgICAgICAgCiAgICAgICAgICAvLyBXaGVuZXZlciBgZG9jdW1lbnQudGl0bGVgIGNoYW5nZXMsIHVwZGF0ZSB0aGUgSWZyYW1lJ3MgdGl0bGUgdG8KICAgICAgICAgIC8vIHByZXR0aWZ5IHRoZSBiYWNrL25leHQgaGlzdG9yeSBtZW51IGVudHJpZXMuIFNpbmNlIElFIHNvbWV0aW1lcwogICAgICAgICAgLy8gZXJyb3JzIHdpdGggIlVuc3BlY2lmaWVkIGVycm9yIiB0aGUgdmVyeSBmaXJzdCB0aW1lIHRoaXMgaXMgc2V0CiAgICAgICAgICAvLyAoeWVzLCB2ZXJ5IHVzZWZ1bCkgd3JhcCB0aGlzIHdpdGggYSB0cnkvY2F0Y2ggYmxvY2suCiAgICAgICAgICBkb2Mub25wcm9wZXJ0eWNoYW5nZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIGlmICggZXZlbnQucHJvcGVydHlOYW1lID09PSAndGl0bGUnICkgewogICAgICAgICAgICAgICAgaWZyYW1lLmRvY3VtZW50LnRpdGxlID0gZG9jLnRpdGxlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBjYXRjaChlKSB7fQogICAgICAgICAgfTsKICAgICAgICAgIAogICAgICAgIH0KICAgICAgfTsKICAgICAgCiAgICAgIC8vIE92ZXJyaWRlIHRoZSAic3RvcCIgbWV0aG9kIHNpbmNlIGFuIElFNi83IElmcmFtZSB3YXMgY3JlYXRlZC4gRXZlbgogICAgICAvLyBpZiB0aGVyZSBhcmUgbm8gbG9uZ2VyIGFueSBib3VuZCBldmVudCBoYW5kbGVycywgdGhlIHBvbGxpbmcgbG9vcAogICAgICAvLyBpcyBzdGlsbCBuZWNlc3NhcnkgZm9yIGJhY2svbmV4dCB0byB3b3JrIGF0IGFsbCEKICAgICAgc2VsZi5zdG9wID0gZm5fcmV0dmFsOwogICAgICAKICAgICAgLy8gR2V0IGhpc3RvcnkgYnkgbG9va2luZyBhdCB0aGUgaGlkZGVuIElmcmFtZSdzIGxvY2F0aW9uLmhhc2guCiAgICAgIGhpc3RvcnlfZ2V0ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIGdldF9mcmFnbWVudCggaWZyYW1lLmxvY2F0aW9uLmhyZWYgKTsKICAgICAgfTsKICAgICAgCiAgICAgIC8vIFNldCBhIG5ldyBoaXN0b3J5IGl0ZW0gYnkgb3BlbmluZyBhbmQgdGhlbiBjbG9zaW5nIHRoZSBJZnJhbWUKICAgICAgLy8gZG9jdW1lbnQsICp0aGVuKiBzZXR0aW5nIGl0cyBsb2NhdGlvbi5oYXNoLiBJZiBkb2N1bWVudC5kb21haW4gaGFzCiAgICAgIC8vIGJlZW4gc2V0LCB1cGRhdGUgdGhhdCBhcyB3ZWxsLgogICAgICBoaXN0b3J5X3NldCA9IGZ1bmN0aW9uKCBoYXNoLCBoaXN0b3J5X2hhc2ggKSB7CiAgICAgICAgdmFyIGlmcmFtZV9kb2MgPSBpZnJhbWUuZG9jdW1lbnQsCiAgICAgICAgICBkb21haW4gPSAkLmZuWyBzdHJfaGFzaGNoYW5nZSBdLmRvbWFpbjsKICAgICAgICAKICAgICAgICBpZiAoIGhhc2ggIT09IGhpc3RvcnlfaGFzaCApIHsKICAgICAgICAgIC8vIFVwZGF0ZSBJZnJhbWUgd2l0aCBhbnkgaW5pdGlhbCBgZG9jdW1lbnQudGl0bGVgIHRoYXQgbWlnaHQgYmUgc2V0LgogICAgICAgICAgaWZyYW1lX2RvYy50aXRsZSA9IGRvYy50aXRsZTsKICAgICAgICAgIAogICAgICAgICAgLy8gT3BlbmluZyB0aGUgSWZyYW1lJ3MgZG9jdW1lbnQgYWZ0ZXIgaXQgaGFzIGJlZW4gY2xvc2VkIGlzIHdoYXQKICAgICAgICAgIC8vIGFjdHVhbGx5IGFkZHMgYSBoaXN0b3J5IGVudHJ5LgogICAgICAgICAgaWZyYW1lX2RvYy5vcGVuKCk7CiAgICAgICAgICAKICAgICAgICAgIC8vIFNldCBkb2N1bWVudC5kb21haW4gZm9yIHRoZSBJZnJhbWUgZG9jdW1lbnQgYXMgd2VsbCwgaWYgbmVjZXNzYXJ5LgogICAgICAgICAgZG9tYWluICYmIGlmcmFtZV9kb2Mud3JpdGUoICc8c2NyaXB0PmRvY3VtZW50LmRvbWFpbj0iJyArIGRvbWFpbiArICciPC9zY3JpcHQ+JyApOwogICAgICAgICAgCiAgICAgICAgICBpZnJhbWVfZG9jLmNsb3NlKCk7CiAgICAgICAgICAKICAgICAgICAgIC8vIFVwZGF0ZSB0aGUgSWZyYW1lJ3MgaGFzaCwgZm9yIGdyZWF0IGp1c3RpY2UuCiAgICAgICAgICBpZnJhbWUubG9jYXRpb24uaGFzaCA9IGhhc2g7CiAgICAgICAgfQogICAgICB9OwogICAgICAKICAgIH0pKCk7CiAgICAvLyBeXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl4KICAgIC8vIF5eXl5eXl5eXl5eXl5eXl5eXl4gUkVNT1ZFIElGIE5PVCBTVVBQT1JUSU5HIElFNi83LzggXl5eXl5eXl5eXl5eXl5eXl5eXgogICAgLy8gXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eCiAgICAKICAgIHJldHVybiBzZWxmOwogIH0pKCk7CiAgCn0pKGpRdWVyeSx0aGlzKTsKCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKdmFyIGNyZWF0ZUhhbmRsZXIgPSBmdW5jdGlvbiggc2VxdWVudGlhbCApIHsKCgkvLyBEZWZhdWx0IHRvIHNlcXVlbnRpYWwKCWlmICggc2VxdWVudGlhbCA9PT0gdW5kZWZpbmVkICkgewoJCXNlcXVlbnRpYWwgPSB0cnVlOwoJfQoKCXJldHVybiBmdW5jdGlvbiggbmFtZSwgcmV2ZXJzZSwgJHRvLCAkZnJvbSApIHsKCgkJdmFyIGRlZmVycmVkID0gbmV3ICQuRGVmZXJyZWQoKSwKCQkJcmV2ZXJzZUNsYXNzID0gcmV2ZXJzZSA/ICIgcmV2ZXJzZSIgOiAiIiwKCQkJYWN0aXZlCT0gJC5tb2JpbGUudXJsSGlzdG9yeS5nZXRBY3RpdmUoKSwKCQkJdG9TY3JvbGwgPSBhY3RpdmUubGFzdFNjcm9sbCB8fCAkLm1vYmlsZS5kZWZhdWx0SG9tZVNjcm9sbCwKCQkJc2NyZWVuSGVpZ2h0ID0gJC5tb2JpbGUuZ2V0U2NyZWVuSGVpZ2h0KCksCgkJCW1heFRyYW5zaXRpb25PdmVycmlkZSA9ICQubW9iaWxlLm1heFRyYW5zaXRpb25XaWR0aCAhPT0gZmFsc2UgJiYgJCggd2luZG93ICkud2lkdGgoKSA+ICQubW9iaWxlLm1heFRyYW5zaXRpb25XaWR0aCwKCQkJbm9uZSA9ICEkLnN1cHBvcnQuY3NzVHJhbnNpdGlvbnMgfHwgbWF4VHJhbnNpdGlvbk92ZXJyaWRlIHx8ICFuYW1lIHx8IG5hbWUgPT09ICJub25lIiB8fCBNYXRoLm1heCggJCggd2luZG93ICkuc2Nyb2xsVG9wKCksIHRvU2Nyb2xsICkgPiAkLm1vYmlsZS5nZXRNYXhTY3JvbGxGb3JUcmFuc2l0aW9uKCksCgkJCXRvUHJlQ2xhc3MgPSAiIHVpLXBhZ2UtcHJlLWluIiwKCQkJdG9nZ2xlVmlld3BvcnRDbGFzcyA9IGZ1bmN0aW9uKCkgewoJCQkJJC5tb2JpbGUucGFnZUNvbnRhaW5lci50b2dnbGVDbGFzcyggInVpLW1vYmlsZS12aWV3cG9ydC10cmFuc2l0aW9uaW5nIHZpZXdwb3J0LSIgKyBuYW1lICk7CgkJCX0sCgkJCXNjcm9sbFBhZ2UgPSBmdW5jdGlvbigpIHsKCQkJCS8vIEJ5IHVzaW5nIHNjcm9sbFRvIGluc3RlYWQgb2Ygc2lsZW50U2Nyb2xsLCB3ZSBjYW4ga2VlcCB0aGluZ3MgYmV0dGVyIGluIG9yZGVyCgkJCQkvLyBKdXN0IHRvIGJlIHByZWNhdXRpb3MsIGRpc2FibGUgc2Nyb2xsc3RhcnQgbGlzdGVuaW5nIGxpa2Ugc2lsZW50U2Nyb2xsIHdvdWxkCgkJCQkkLmV2ZW50LnNwZWNpYWwuc2Nyb2xsc3RhcnQuZW5hYmxlZCA9IGZhbHNlOwoKCQkJCXdpbmRvdy5zY3JvbGxUbyggMCwgdG9TY3JvbGwgKTsKCgkJCQkvLyByZWVuYWJsZSBzY3JvbGxzdGFydCBsaXN0ZW5pbmcgbGlrZSBzaWxlbnRTY3JvbGwgd291bGQKCQkJCXNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCQkJCSQuZXZlbnQuc3BlY2lhbC5zY3JvbGxzdGFydC5lbmFibGVkID0gdHJ1ZTsKCQkJCX0sIDE1MCApOwoJCQl9LAoJCQljbGVhbkZyb20gPSBmdW5jdGlvbigpIHsKCQkJCSRmcm9tCgkJCQkJLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVQYWdlQ2xhc3MgKyAiIG91dCBpbiByZXZlcnNlICIgKyBuYW1lICkKCQkJCQkuaGVpZ2h0KCAiIiApOwoJCQl9LAoJCQlzdGFydE91dCA9IGZ1bmN0aW9uKCkgewoJCQkJLy8gaWYgaXQncyBub3Qgc2VxdWVudGlhbCwgY2FsbCB0aGUgZG9uZU91dCB0cmFuc2l0aW9uIHRvIHN0YXJ0IHRoZSBUTyBwYWdlIGFuaW1hdGluZyBpbiBzaW11bHRhbmVvdXNseQoJCQkJaWYgKCAhc2VxdWVudGlhbCApIHsKCQkJCQlkb25lT3V0KCk7CgkJCQl9CgkJCQllbHNlIHsKCQkJCQkkZnJvbS5hbmltYXRpb25Db21wbGV0ZSggZG9uZU91dCApOwoJCQkJfQoKCQkJCS8vIFNldCB0aGUgZnJvbSBwYWdlJ3MgaGVpZ2h0IGFuZCBzdGFydCBpdCB0cmFuc2l0aW9uaW5nIG91dAoJCQkJLy8gTm90ZTogc2V0dGluZyBhbiBleHBsaWNpdCBoZWlnaHQgaGVscHMgZWxpbWluYXRlIHRpbGluZyBpbiB0aGUgdHJhbnNpdGlvbnMKCQkJCSRmcm9tCgkJCQkJLmhlaWdodCggc2NyZWVuSGVpZ2h0ICsgJCggd2luZG93ICkuc2Nyb2xsVG9wKCkgKQoJCQkJCS5hZGRDbGFzcyggbmFtZSArICIgb3V0IiArIHJldmVyc2VDbGFzcyApOwoJCQl9LAoKCQkJZG9uZU91dCA9IGZ1bmN0aW9uKCkgewoKCQkJCWlmICggJGZyb20gJiYgc2VxdWVudGlhbCApIHsKCQkJCQljbGVhbkZyb20oKTsKCQkJCX0KCgkJCQlzdGFydEluKCk7CgkJCX0sCgoJCQlzdGFydEluID0gZnVuY3Rpb24oKSB7CgoJCQkJLy8gUHJldmVudCBmbGlja2VyaW5nIGluIHBob25lZ2FwIGNvbnRhaW5lcjogc2VlIGNvbW1lbnRzIGF0ICM0MDI0IHJlZ2FyZGluZyBpT1MKCQkJCSR0by5jc3MoICJ6LWluZGV4IiwgLTEwICk7CgoJCQkJJHRvLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVQYWdlQ2xhc3MgKyB0b1ByZUNsYXNzICk7CgoJCQkJLy8gU2VuZCBmb2N1cyB0byBwYWdlIGFzIGl0IGlzIG5vdyBkaXNwbGF5OiBibG9jawoJCQkJJC5tb2JpbGUuZm9jdXNQYWdlKCAkdG8gKTsKCgkJCQkvLyBTZXQgdG8gcGFnZSBoZWlnaHQKCQkJCSR0by5oZWlnaHQoIHNjcmVlbkhlaWdodCArIHRvU2Nyb2xsICk7CgoJCQkJc2Nyb2xsUGFnZSgpOwoKCQkJCS8vIFJlc3RvcmVzIHZpc2liaWxpdHkgb2YgdGhlIG5ldyBwYWdlOiBhZGRlZCB0b2dldGhlciB3aXRoICR0by5jc3MoICJ6LWluZGV4IiwgLTEwICk7CgkJCQkkdG8uY3NzKCAiei1pbmRleCIsICIiICk7CgoJCQkJaWYgKCAhbm9uZSApIHsKCQkJCQkkdG8uYW5pbWF0aW9uQ29tcGxldGUoIGRvbmVJbiApOwoJCQkJfQoKCQkJCSR0bwoJCQkJCS5yZW1vdmVDbGFzcyggdG9QcmVDbGFzcyApCgkJCQkJLmFkZENsYXNzKCBuYW1lICsgIiBpbiIgKyByZXZlcnNlQ2xhc3MgKTsKCgkJCQlpZiAoIG5vbmUgKSB7CgkJCQkJZG9uZUluKCk7CgkJCQl9CgoJCQl9LAoKCQkJZG9uZUluID0gZnVuY3Rpb24oKSB7CgoJCQkJaWYgKCAhc2VxdWVudGlhbCApIHsKCgkJCQkJaWYgKCAkZnJvbSApIHsKCQkJCQkJY2xlYW5Gcm9tKCk7CgkJCQkJfQoJCQkJfQoKCQkJCSR0bwoJCQkJCS5yZW1vdmVDbGFzcyggIm91dCBpbiByZXZlcnNlICIgKyBuYW1lICkKCQkJCQkuaGVpZ2h0KCAiIiApOwoKCQkJCXRvZ2dsZVZpZXdwb3J0Q2xhc3MoKTsKCgkJCQkvLyBJbiBzb21lIGJyb3dzZXJzIChpT1M1KSwgM0QgdHJhbnNpdGlvbnMgYmxvY2sgdGhlIGFiaWxpdHkgdG8gc2Nyb2xsIHRvIHRoZSBkZXNpcmVkIGxvY2F0aW9uIGR1cmluZyB0cmFuc2l0aW9uCgkJCQkvLyBUaGlzIGVuc3VyZXMgd2UganVtcCB0byB0aGF0IHNwb3QgYWZ0ZXIgdGhlIGZhY3QsIGlmIHdlIGFyZW4ndCB0aGVyZSBhbHJlYWR5LgoJCQkJaWYgKCAkKCB3aW5kb3cgKS5zY3JvbGxUb3AoKSAhPT0gdG9TY3JvbGwgKSB7CgkJCQkJc2Nyb2xsUGFnZSgpOwoJCQkJfQoKCQkJCWRlZmVycmVkLnJlc29sdmUoIG5hbWUsIHJldmVyc2UsICR0bywgJGZyb20sIHRydWUgKTsKCQkJfTsKCgkJdG9nZ2xlVmlld3BvcnRDbGFzcygpOwoKCQlpZiAoICRmcm9tICYmICFub25lICkgewoJCQlzdGFydE91dCgpOwoJCX0KCQllbHNlIHsKCQkJZG9uZU91dCgpOwoJCX0KCgkJcmV0dXJuIGRlZmVycmVkLnByb21pc2UoKTsKCX07Cn07CgovLyBnZW5lcmF0ZSB0aGUgaGFuZGxlcnMgZnJvbSB0aGUgYWJvdmUKdmFyIHNlcXVlbnRpYWxIYW5kbGVyID0gY3JlYXRlSGFuZGxlcigpLAoJc2ltdWx0YW5lb3VzSGFuZGxlciA9IGNyZWF0ZUhhbmRsZXIoIGZhbHNlICksCglkZWZhdWx0R2V0TWF4U2Nyb2xsRm9yVHJhbnNpdGlvbiA9IGZ1bmN0aW9uKCkgewoJCXJldHVybiAkLm1vYmlsZS5nZXRTY3JlZW5IZWlnaHQoKSAqIDM7Cgl9OwoKLy8gTWFrZSBvdXIgdHJhbnNpdGlvbiBoYW5kbGVyIHRoZSBwdWJsaWMgZGVmYXVsdC4KJC5tb2JpbGUuZGVmYXVsdFRyYW5zaXRpb25IYW5kbGVyID0gc2VxdWVudGlhbEhhbmRsZXI7CgovL3RyYW5zaXRpb24gaGFuZGxlciBkaWN0aW9uYXJ5IGZvciAzcmQgcGFydHkgdHJhbnNpdGlvbnMKJC5tb2JpbGUudHJhbnNpdGlvbkhhbmRsZXJzID0gewoJImRlZmF1bHQiOiAkLm1vYmlsZS5kZWZhdWx0VHJhbnNpdGlvbkhhbmRsZXIsCgkic2VxdWVudGlhbCI6IHNlcXVlbnRpYWxIYW5kbGVyLAoJInNpbXVsdGFuZW91cyI6IHNpbXVsdGFuZW91c0hhbmRsZXIKfTsKCiQubW9iaWxlLnRyYW5zaXRpb25GYWxsYmFja3MgPSB7fTsKCi8vIElmIHRyYW5zaXRpb24gaXMgZGVmaW5lZCwgY2hlY2sgaWYgY3NzIDNEIHRyYW5zZm9ybXMgYXJlIHN1cHBvcnRlZCwgYW5kIGlmIG5vdCwgaWYgYSBmYWxsYmFjayBpcyBzcGVjaWZpZWQKJC5tb2JpbGUuX21heWJlRGVncmFkZVRyYW5zaXRpb24gPSBmdW5jdGlvbiggdHJhbnNpdGlvbiApIHsKCQlpZiAoIHRyYW5zaXRpb24gJiYgISQuc3VwcG9ydC5jc3NUcmFuc2Zvcm0zZCAmJiAkLm1vYmlsZS50cmFuc2l0aW9uRmFsbGJhY2tzWyB0cmFuc2l0aW9uIF0gKSB7CgkJCXRyYW5zaXRpb24gPSAkLm1vYmlsZS50cmFuc2l0aW9uRmFsbGJhY2tzWyB0cmFuc2l0aW9uIF07CgkJfQoKCQlyZXR1cm4gdHJhbnNpdGlvbjsKfTsKCi8vIFNldCB0aGUgZ2V0TWF4U2Nyb2xsRm9yVHJhbnNpdGlvbiB0byBkZWZhdWx0IGlmIG5vIGltcGxlbWVudGF0aW9uIHdhcyBzZXQgYnkgdXNlcgokLm1vYmlsZS5nZXRNYXhTY3JvbGxGb3JUcmFuc2l0aW9uID0gJC5tb2JpbGUuZ2V0TWF4U2Nyb2xsRm9yVHJhbnNpdGlvbiB8fCBkZWZhdWx0R2V0TWF4U2Nyb2xsRm9yVHJhbnNpdGlvbjsKfSkoIGpRdWVyeSwgdGhpcyApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgoJLy9kZWZpbmUgdmFycyBmb3IgaW50ZXJhbCB1c2UKCXZhciAkd2luZG93ID0gJCggd2luZG93ICksCgkJJGh0bWwgPSAkKCAnaHRtbCcgKSwKCQkkaGVhZCA9ICQoICdoZWFkJyApLAoKCQkvL3VybCBwYXRoIGhlbHBlcnMgZm9yIHVzZSBpbiByZWxhdGl2ZSB1cmwgbWFuYWdlbWVudAoJCXBhdGggPSB7CgoJCQkvLyBUaGlzIHNjYXJ5IGxvb2tpbmcgcmVndWxhciBleHByZXNzaW9uIHBhcnNlcyBhbiBhYnNvbHV0ZSBVUkwgb3IgaXRzIHJlbGF0aXZlCgkJCS8vIHZhcmlhbnRzIChwcm90b2NvbCwgc2l0ZSwgZG9jdW1lbnQsIHF1ZXJ5LCBhbmQgaGFzaCksIGludG8gdGhlIHZhcmlvdXMKCQkJLy8gY29tcG9uZW50cyAocHJvdG9jb2wsIGhvc3QsIHBhdGgsIHF1ZXJ5LCBmcmFnbWVudCwgZXRjIHRoYXQgbWFrZSB1cCB0aGUKCQkJLy8gVVJMIGFzIHdlbGwgYXMgc29tZSBvdGhlciBjb21tb25seSB1c2VkIHN1Yi1wYXJ0cy4gV2hlbiB1c2VkIHdpdGggUmVnRXhwLmV4ZWMoKQoJCQkvLyBvciBTdHJpbmcubWF0Y2gsIGl0IHBhcnNlcyB0aGUgVVJMIGludG8gYSByZXN1bHRzIGFycmF5IHRoYXQgbG9va3MgbGlrZSB0aGlzOgoJCQkvLwoJCQkvLyAgICAgWzBdOiBodHRwOi8vamJsYXM6cGFzc3dvcmRAbXljb21wYW55LmNvbTo4MDgwL21haWwvaW5ib3g/bXNnPTEyMzQmdHlwZT11bnJlYWQjbXNnLWNvbnRlbnQKCQkJLy8gICAgIFsxXTogaHR0cDovL2pibGFzOnBhc3N3b3JkQG15Y29tcGFueS5jb206ODA4MC9tYWlsL2luYm94P21zZz0xMjM0JnR5cGU9dW5yZWFkCgkJCS8vICAgICBbMl06IGh0dHA6Ly9qYmxhczpwYXNzd29yZEBteWNvbXBhbnkuY29tOjgwODAvbWFpbC9pbmJveAoJCQkvLyAgICAgWzNdOiBodHRwOi8vamJsYXM6cGFzc3dvcmRAbXljb21wYW55LmNvbTo4MDgwCgkJCS8vICAgICBbNF06IGh0dHA6CgkJCS8vICAgICBbNV06IC8vCgkJCS8vICAgICBbNl06IGpibGFzOnBhc3N3b3JkQG15Y29tcGFueS5jb206ODA4MAoJCQkvLyAgICAgWzddOiBqYmxhczpwYXNzd29yZAoJCQkvLyAgICAgWzhdOiBqYmxhcwoJCQkvLyAgICAgWzldOiBwYXNzd29yZAoJCQkvLyAgICBbMTBdOiBteWNvbXBhbnkuY29tOjgwODAKCQkJLy8gICAgWzExXTogbXljb21wYW55LmNvbQoJCQkvLyAgICBbMTJdOiA4MDgwCgkJCS8vICAgIFsxM106IC9tYWlsL2luYm94CgkJCS8vICAgIFsxNF06IC9tYWlsLwoJCQkvLyAgICBbMTVdOiBpbmJveAoJCQkvLyAgICBbMTZdOiA/bXNnPTEyMzQmdHlwZT11bnJlYWQKCQkJLy8gICAgWzE3XTogI21zZy1jb250ZW50CgkJCS8vCgkJCXVybFBhcnNlUkU6IC9eKCgoKFteOlwvI1w/XSs6KT8oPzooXC9cLykoKD86KChbXjpAXC8jXD9dKykoPzpcOihbXjpAXC8jXD9dKykpPylAKT8oKFteOlwvI1w/XF1cW10rfFxbW15cL1xdQCM/XStcXSkoPzpcOihbMC05XSspKT8pKT8pPyk/KChcLz8oPzpbXlwvXD8jXStcLyspKikoW15cPyNdKikpKT8oXD9bXiNdKyk/KSgjLiopPy8sCgoJCQkvLyBBYnN0cmFjdGlvbiB0byBhZGRyZXNzIHhzcyAoSXNzdWUgIzQ3ODcpIGJ5IHJlbW92aW5nIHRoZSBhdXRob3JpdHkgaW4KCQkJLy8gYnJvd3NlcnMgdGhhdCBhdXRvCWRlY29kZSBpdC4gQWxsIHJlZmVyZW5jZXMgdG8gbG9jYXRpb24uaHJlZiBzaG91bGQgYmUKCQkJLy8gcmVwbGFjZWQgd2l0aCBhIGNhbGwgdG8gdGhpcyBtZXRob2Qgc28gdGhhdCBpdCBjYW4gYmUgZGVhbHQgd2l0aCBwcm9wZXJseSBoZXJlCgkJCWdldExvY2F0aW9uOiBmdW5jdGlvbiggdXJsICkgewoJCQkJdmFyIHVyaSA9IHVybCA/IHRoaXMucGFyc2VVcmwoIHVybCApIDogbG9jYXRpb24sCgkJCQkJaGFzaCA9IHRoaXMucGFyc2VVcmwoIHVybCB8fCBsb2NhdGlvbi5ocmVmICkuaGFzaDsKCgkJCQkvLyBtaW1pYyB0aGUgYnJvd3NlciB3aXRoIGFuIGVtcHR5IHN0cmluZyB3aGVuIHRoZSBoYXNoIGlzIGVtcHR5CgkJCQloYXNoID0gaGFzaCA9PT0gIiMiID8gIiIgOiBoYXNoOwoKCQkJCS8vIE1ha2Ugc3VyZSB0byBwYXJzZSB0aGUgdXJsIG9yIHRoZSBsb2NhdGlvbiBvYmplY3QgZm9yIHRoZSBoYXNoIGJlY2F1c2UgdXNpbmcgbG9jYXRpb24uaGFzaAoJCQkJLy8gaXMgYXV0b2RlY29kZWQgaW4gZmlyZWZveCwgdGhlIHJlc3Qgb2YgdGhlIHVybCBzaG91bGQgYmUgZnJvbSB0aGUgb2JqZWN0IChsb2NhdGlvbiB1bmxlc3MKCQkJCS8vIHdlJ3JlIHRlc3RpbmcpIHRvIGF2b2lkIHRoZSBpbmNsdXNpb24gb2YgdGhlIGF1dGhvcml0eQoJCQkJcmV0dXJuIHVyaS5wcm90b2NvbCArICIvLyIgKyB1cmkuaG9zdCArIHVyaS5wYXRobmFtZSArIHVyaS5zZWFyY2ggKyBoYXNoOwoJCQl9LAoKCQkJcGFyc2VMb2NhdGlvbjogZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gdGhpcy5wYXJzZVVybCggdGhpcy5nZXRMb2NhdGlvbigpICk7CgkJCX0sCgoJCQkvL1BhcnNlIGEgVVJMIGludG8gYSBzdHJ1Y3R1cmUgdGhhdCBhbGxvd3MgZWFzeSBhY2Nlc3MgdG8KCQkJLy9hbGwgb2YgdGhlIFVSTCBjb21wb25lbnRzIGJ5IG5hbWUuCgkJCXBhcnNlVXJsOiBmdW5jdGlvbiggdXJsICkgewoJCQkJLy8gSWYgd2UncmUgcGFzc2VkIGFuIG9iamVjdCwgd2UnbGwgYXNzdW1lIHRoYXQgaXQgaXMKCQkJCS8vIGEgcGFyc2VkIHVybCBvYmplY3QgYW5kIGp1c3QgcmV0dXJuIGl0IGJhY2sgdG8gdGhlIGNhbGxlci4KCQkJCWlmICggJC50eXBlKCB1cmwgKSA9PT0gIm9iamVjdCIgKSB7CgkJCQkJcmV0dXJuIHVybDsKCQkJCX0KCgkJCQl2YXIgbWF0Y2hlcyA9IHBhdGgudXJsUGFyc2VSRS5leGVjKCB1cmwgfHwgIiIgKSB8fCBbXTsKCgkJCQkJLy8gQ3JlYXRlIGFuIG9iamVjdCB0aGF0IGFsbG93cyB0aGUgY2FsbGVyIHRvIGFjY2VzcyB0aGUgc3ViLW1hdGNoZXMKCQkJCQkvLyBieSBuYW1lLiBOb3RlIHRoYXQgSUUgcmV0dXJucyBhbiBlbXB0eSBzdHJpbmcgaW5zdGVhZCBvZiB1bmRlZmluZWQsCgkJCQkJLy8gbGlrZSBhbGwgb3RoZXIgYnJvd3NlcnMgZG8sIHNvIHdlIG5vcm1hbGl6ZSBldmVyeXRoaW5nIHNvIGl0cyBjb25zaXN0ZW50CgkJCQkJLy8gbm8gbWF0dGVyIHdoYXQgYnJvd3NlciB3ZSdyZSBydW5uaW5nIG9uLgoJCQkJCXJldHVybiB7CgkJCQkJCWhyZWY6ICAgICAgICAgbWF0Y2hlc1sgIDAgXSB8fCAiIiwKCQkJCQkJaHJlZk5vSGFzaDogICBtYXRjaGVzWyAgMSBdIHx8ICIiLAoJCQkJCQlocmVmTm9TZWFyY2g6IG1hdGNoZXNbICAyIF0gfHwgIiIsCgkJCQkJCWRvbWFpbjogICAgICAgbWF0Y2hlc1sgIDMgXSB8fCAiIiwKCQkJCQkJcHJvdG9jb2w6ICAgICBtYXRjaGVzWyAgNCBdIHx8ICIiLAoJCQkJCQlkb3VibGVTbGFzaDogIG1hdGNoZXNbICA1IF0gfHwgIiIsCgkJCQkJCWF1dGhvcml0eTogICAgbWF0Y2hlc1sgIDYgXSB8fCAiIiwKCQkJCQkJdXNlcm5hbWU6ICAgICBtYXRjaGVzWyAgOCBdIHx8ICIiLAoJCQkJCQlwYXNzd29yZDogICAgIG1hdGNoZXNbICA5IF0gfHwgIiIsCgkJCQkJCWhvc3Q6ICAgICAgICAgbWF0Y2hlc1sgMTAgXSB8fCAiIiwKCQkJCQkJaG9zdG5hbWU6ICAgICBtYXRjaGVzWyAxMSBdIHx8ICIiLAoJCQkJCQlwb3J0OiAgICAgICAgIG1hdGNoZXNbIDEyIF0gfHwgIiIsCgkJCQkJCXBhdGhuYW1lOiAgICAgbWF0Y2hlc1sgMTMgXSB8fCAiIiwKCQkJCQkJZGlyZWN0b3J5OiAgICBtYXRjaGVzWyAxNCBdIHx8ICIiLAoJCQkJCQlmaWxlbmFtZTogICAgIG1hdGNoZXNbIDE1IF0gfHwgIiIsCgkJCQkJCXNlYXJjaDogICAgICAgbWF0Y2hlc1sgMTYgXSB8fCAiIiwKCQkJCQkJaGFzaDogICAgICAgICBtYXRjaGVzWyAxNyBdIHx8ICIiCgkJCQkJfTsKCQkJfSwKCgkJCS8vVHVybiByZWxQYXRoIGludG8gYW4gYXNib2x1dGUgcGF0aC4gYWJzUGF0aCBpcwoJCQkvL2FuIG9wdGlvbmFsIGFic29sdXRlIHBhdGggd2hpY2ggZGVzY3JpYmVzIHdoYXQKCQkJLy9yZWxQYXRoIGlzIHJlbGF0aXZlIHRvLgoJCQltYWtlUGF0aEFic29sdXRlOiBmdW5jdGlvbiggcmVsUGF0aCwgYWJzUGF0aCApIHsKCQkJCWlmICggcmVsUGF0aCAmJiByZWxQYXRoLmNoYXJBdCggMCApID09PSAiLyIgKSB7CgkJCQkJcmV0dXJuIHJlbFBhdGg7CgkJCQl9CgoJCQkJcmVsUGF0aCA9IHJlbFBhdGggfHwgIiI7CgkJCQlhYnNQYXRoID0gYWJzUGF0aCA/IGFic1BhdGgucmVwbGFjZSggL15cL3woXC9bXlwvXSp8W15cL10rKSQvZywgIiIgKSA6ICIiOwoKCQkJCXZhciBhYnNTdGFjayA9IGFic1BhdGggPyBhYnNQYXRoLnNwbGl0KCAiLyIgKSA6IFtdLAoJCQkJCXJlbFN0YWNrID0gcmVsUGF0aC5zcGxpdCggIi8iICk7CgkJCQlmb3IgKCB2YXIgaSA9IDA7IGkgPCByZWxTdGFjay5sZW5ndGg7IGkrKyApIHsKCQkJCQl2YXIgZCA9IHJlbFN0YWNrWyBpIF07CgkJCQkJc3dpdGNoICggZCApIHsKCQkJCQkJY2FzZSAiLiI6CgkJCQkJCQlicmVhazsKCQkJCQkJY2FzZSAiLi4iOgoJCQkJCQkJaWYgKCBhYnNTdGFjay5sZW5ndGggKSB7CgkJCQkJCQkJYWJzU3RhY2sucG9wKCk7CgkJCQkJCQl9CgkJCQkJCQlicmVhazsKCQkJCQkJZGVmYXVsdDoKCQkJCQkJCWFic1N0YWNrLnB1c2goIGQgKTsKCQkJCQkJCWJyZWFrOwoJCQkJCX0KCQkJCX0KCQkJCXJldHVybiAiLyIgKyBhYnNTdGFjay5qb2luKCAiLyIgKTsKCQkJfSwKCgkJCS8vUmV0dXJucyB0cnVlIGlmIGJvdGggdXJscyBoYXZlIHRoZSBzYW1lIGRvbWFpbi4KCQkJaXNTYW1lRG9tYWluOiBmdW5jdGlvbiggYWJzVXJsMSwgYWJzVXJsMiApIHsKCQkJCXJldHVybiBwYXRoLnBhcnNlVXJsKCBhYnNVcmwxICkuZG9tYWluID09PSBwYXRoLnBhcnNlVXJsKCBhYnNVcmwyICkuZG9tYWluOwoJCQl9LAoKCQkJLy9SZXR1cm5zIHRydWUgZm9yIGFueSByZWxhdGl2ZSB2YXJpYW50LgoJCQlpc1JlbGF0aXZlVXJsOiBmdW5jdGlvbiggdXJsICkgewoJCQkJLy8gQWxsIHJlbGF0aXZlIFVybCB2YXJpYW50cyBoYXZlIG9uZSB0aGluZyBpbiBjb21tb24sIG5vIHByb3RvY29sLgoJCQkJcmV0dXJuIHBhdGgucGFyc2VVcmwoIHVybCApLnByb3RvY29sID09PSAiIjsKCQkJfSwKCgkJCS8vUmV0dXJucyB0cnVlIGZvciBhbiBhYnNvbHV0ZSB1cmwuCgkJCWlzQWJzb2x1dGVVcmw6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQlyZXR1cm4gcGF0aC5wYXJzZVVybCggdXJsICkucHJvdG9jb2wgIT09ICIiOwoJCQl9LAoKCQkJLy9UdXJuIHRoZSBzcGVjaWZpZWQgcmVhbHRpdmUgVVJMIGludG8gYW4gYWJzb2x1dGUgb25lLiBUaGlzIGZ1bmN0aW9uCgkJCS8vY2FuIGhhbmRsZSBhbGwgcmVsYXRpdmUgdmFyaWFudHMgKHByb3RvY29sLCBzaXRlLCBkb2N1bWVudCwgcXVlcnksIGZyYWdtZW50KS4KCQkJbWFrZVVybEFic29sdXRlOiBmdW5jdGlvbiggcmVsVXJsLCBhYnNVcmwgKSB7CgkJCQlpZiAoICFwYXRoLmlzUmVsYXRpdmVVcmwoIHJlbFVybCApICkgewoJCQkJCXJldHVybiByZWxVcmw7CgkJCQl9CgoJCQkJaWYgKCBhYnNVcmwgPT09IHVuZGVmaW5lZCApIHsKCQkJCQlhYnNVcmwgPSBkb2N1bWVudEJhc2U7CgkJCQl9CgoJCQkJdmFyIHJlbE9iaiA9IHBhdGgucGFyc2VVcmwoIHJlbFVybCApLAoJCQkJCWFic09iaiA9IHBhdGgucGFyc2VVcmwoIGFic1VybCApLAoJCQkJCXByb3RvY29sID0gcmVsT2JqLnByb3RvY29sIHx8IGFic09iai5wcm90b2NvbCwKCQkJCQlkb3VibGVTbGFzaCA9IHJlbE9iai5wcm90b2NvbCA/IHJlbE9iai5kb3VibGVTbGFzaCA6ICggcmVsT2JqLmRvdWJsZVNsYXNoIHx8IGFic09iai5kb3VibGVTbGFzaCApLAoJCQkJCWF1dGhvcml0eSA9IHJlbE9iai5hdXRob3JpdHkgfHwgYWJzT2JqLmF1dGhvcml0eSwKCQkJCQloYXNQYXRoID0gcmVsT2JqLnBhdGhuYW1lICE9PSAiIiwKCQkJCQlwYXRobmFtZSA9IHBhdGgubWFrZVBhdGhBYnNvbHV0ZSggcmVsT2JqLnBhdGhuYW1lIHx8IGFic09iai5maWxlbmFtZSwgYWJzT2JqLnBhdGhuYW1lICksCgkJCQkJc2VhcmNoID0gcmVsT2JqLnNlYXJjaCB8fCAoICFoYXNQYXRoICYmIGFic09iai5zZWFyY2ggKSB8fCAiIiwKCQkJCQloYXNoID0gcmVsT2JqLmhhc2g7CgoJCQkJcmV0dXJuIHByb3RvY29sICsgZG91YmxlU2xhc2ggKyBhdXRob3JpdHkgKyBwYXRobmFtZSArIHNlYXJjaCArIGhhc2g7CgkJCX0sCgoJCQkvL0FkZCBzZWFyY2ggKGFrYSBxdWVyeSkgcGFyYW1zIHRvIHRoZSBzcGVjaWZpZWQgdXJsLgoJCQlhZGRTZWFyY2hQYXJhbXM6IGZ1bmN0aW9uKCB1cmwsIHBhcmFtcyApIHsKCQkJCXZhciB1ID0gcGF0aC5wYXJzZVVybCggdXJsICksCgkJCQkJcCA9ICggdHlwZW9mIHBhcmFtcyA9PT0gIm9iamVjdCIgKSA/ICQucGFyYW0oIHBhcmFtcyApIDogcGFyYW1zLAoJCQkJCXMgPSB1LnNlYXJjaCB8fCAiPyI7CgkJCQlyZXR1cm4gdS5ocmVmTm9TZWFyY2ggKyBzICsgKCBzLmNoYXJBdCggcy5sZW5ndGggLSAxICkgIT09ICI/IiA/ICImIiA6ICIiICkgKyBwICsgKCB1Lmhhc2ggfHwgIiIgKTsKCQkJfSwKCgkJCWNvbnZlcnRVcmxUb0RhdGFVcmw6IGZ1bmN0aW9uKCBhYnNVcmwgKSB7CgkJCQl2YXIgdSA9IHBhdGgucGFyc2VVcmwoIGFic1VybCApOwoJCQkJaWYgKCBwYXRoLmlzRW1iZWRkZWRQYWdlKCB1ICkgKSB7CgkJCQkJLy8gRm9yIGVtYmVkZGVkIHBhZ2VzLCByZW1vdmUgdGhlIGRpYWxvZyBoYXNoIGtleSBhcyBpbiBnZXRGaWxlUGF0aCgpLAoJCQkJCS8vIG90aGVyd2lzZSB0aGUgRGF0YSBVcmwgd29uJ3QgbWF0Y2ggdGhlIGlkIG9mIHRoZSBlbWJlZGRlZCBQYWdlLgoJCQkJCXJldHVybiB1Lmhhc2guc3BsaXQoIGRpYWxvZ0hhc2hLZXkgKVswXS5yZXBsYWNlKCAvXiMvLCAiIiApOwoJCQkJfSBlbHNlIGlmICggcGF0aC5pc1NhbWVEb21haW4oIHUsIGRvY3VtZW50QmFzZSApICkgewoJCQkJCXJldHVybiB1LmhyZWZOb0hhc2gucmVwbGFjZSggZG9jdW1lbnRCYXNlLmRvbWFpbiwgIiIgKS5zcGxpdCggZGlhbG9nSGFzaEtleSApWzBdOwoJCQkJfQoKCQkJCXJldHVybiB3aW5kb3cuZGVjb2RlVVJJQ29tcG9uZW50KGFic1VybCk7CgkJCX0sCgoJCQkvL2dldCBwYXRoIGZyb20gY3VycmVudCBoYXNoLCBvciBmcm9tIGEgZmlsZSBwYXRoCgkJCWdldDogZnVuY3Rpb24oIG5ld1BhdGggKSB7CgkJCQlpZiAoIG5ld1BhdGggPT09IHVuZGVmaW5lZCApIHsKCQkJCQluZXdQYXRoID0gcGF0aC5wYXJzZUxvY2F0aW9uKCkuaGFzaDsKCQkJCX0KCQkJCXJldHVybiBwYXRoLnN0cmlwSGFzaCggbmV3UGF0aCApLnJlcGxhY2UoIC9bXlwvXSpcLlteXC8qXSskLywgJycgKTsKCQkJfSwKCgkJCS8vcmV0dXJuIHRoZSBzdWJzdHJpbmcgb2YgYSBmaWxlcGF0aCBiZWZvcmUgdGhlIHN1Yi1wYWdlIGtleSwgZm9yIG1ha2luZyBhIHNlcnZlciByZXF1ZXN0CgkJCWdldEZpbGVQYXRoOiBmdW5jdGlvbiggcGF0aCApIHsKCQkJCXZhciBzcGxpdGtleSA9ICcmJyArICQubW9iaWxlLnN1YlBhZ2VVcmxLZXk7CgkJCQlyZXR1cm4gcGF0aCAmJiBwYXRoLnNwbGl0KCBzcGxpdGtleSApWzBdLnNwbGl0KCBkaWFsb2dIYXNoS2V5IClbMF07CgkJCX0sCgoJCQkvL3NldCBsb2NhdGlvbiBoYXNoIHRvIHBhdGgKCQkJc2V0OiBmdW5jdGlvbiggcGF0aCApIHsKCQkJCWxvY2F0aW9uLmhhc2ggPSBwYXRoOwoJCQl9LAoKCQkJLy90ZXN0IGlmIGEgZ2l2ZW4gdXJsIChzdHJpbmcpIGlzIGEgcGF0aAoJCQkvL05PVEUgbWlnaHQgYmUgZXhjZXB0aW9uYWxseSBuYWl2ZQoJCQlpc1BhdGg6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQlyZXR1cm4gKCAvXC8vICkudGVzdCggdXJsICk7CgkJCX0sCgoJCQkvL3JldHVybiBhIHVybCBwYXRoIHdpdGggdGhlIHdpbmRvdydzIGxvY2F0aW9uIHByb3RvY29sL2hvc3RuYW1lL3BhdGhuYW1lIHJlbW92ZWQKCQkJY2xlYW46IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQlyZXR1cm4gdXJsLnJlcGxhY2UoIGRvY3VtZW50QmFzZS5kb21haW4sICIiICk7CgkJCX0sCgoJCQkvL2p1c3QgcmV0dXJuIHRoZSB1cmwgd2l0aG91dCBhbiBpbml0aWFsICMKCQkJc3RyaXBIYXNoOiBmdW5jdGlvbiggdXJsICkgewoJCQkJcmV0dXJuIHVybC5yZXBsYWNlKCAvXiMvLCAiIiApOwoJCQl9LAoKCQkJLy9yZW1vdmUgdGhlIHByZWNlZGluZyBoYXNoLCBhbnkgcXVlcnkgcGFyYW1zLCBhbmQgZGlhbG9nIG5vdGF0aW9ucwoJCQljbGVhbkhhc2g6IGZ1bmN0aW9uKCBoYXNoICkgewoJCQkJcmV0dXJuIHBhdGguc3RyaXBIYXNoKCBoYXNoLnJlcGxhY2UoIC9cPy4qJC8sICIiICkucmVwbGFjZSggZGlhbG9nSGFzaEtleSwgIiIgKSApOwoJCQl9LAoKCQkJaXNIYXNoVmFsaWQ6IGZ1bmN0aW9uKCBoYXNoICkgewoJCQkJcmV0dXJuICggL14jW14jXSskLyApLnRlc3QoIGhhc2ggKTsKCQkJfSwKCgkJCS8vY2hlY2sgd2hldGhlciBhIHVybCBpcyByZWZlcmVuY2luZyB0aGUgc2FtZSBkb21haW4sIG9yIGFuIGV4dGVybmFsIGRvbWFpbiBvciBkaWZmZXJlbnQgcHJvdG9jb2wKCQkJLy9jb3VsZCBiZSBtYWlsdG8sIGV0YwoJCQlpc0V4dGVybmFsOiBmdW5jdGlvbiggdXJsICkgewoJCQkJdmFyIHUgPSBwYXRoLnBhcnNlVXJsKCB1cmwgKTsKCQkJCXJldHVybiB1LnByb3RvY29sICYmIHUuZG9tYWluICE9PSBkb2N1bWVudFVybC5kb21haW4gPyB0cnVlIDogZmFsc2U7CgkJCX0sCgoJCQloYXNQcm90b2NvbDogZnVuY3Rpb24oIHVybCApIHsKCQkJCXJldHVybiAoIC9eKDo/XHcrOikvICkudGVzdCggdXJsICk7CgkJCX0sCgoJCQkvL2NoZWNrIGlmIHRoZSBzcGVjaWZpZWQgdXJsIHJlZmVycyB0byB0aGUgZmlyc3QgcGFnZSBpbiB0aGUgbWFpbiBhcHBsaWNhdGlvbiBkb2N1bWVudC4KCQkJaXNGaXJzdFBhZ2VVcmw6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQkvLyBXZSBvbmx5IGRlYWwgd2l0aCBhYnNvbHV0ZSBwYXRocy4KCQkJCXZhciB1ID0gcGF0aC5wYXJzZVVybCggcGF0aC5tYWtlVXJsQWJzb2x1dGUoIHVybCwgZG9jdW1lbnRCYXNlICkgKSwKCgkJCQkJLy8gRG9lcyB0aGUgdXJsIGhhdmUgdGhlIHNhbWUgcGF0aCBhcyB0aGUgZG9jdW1lbnQ/CgkJCQkJc2FtZVBhdGggPSB1LmhyZWZOb0hhc2ggPT09IGRvY3VtZW50VXJsLmhyZWZOb0hhc2ggfHwgKCBkb2N1bWVudEJhc2VEaWZmZXJzICYmIHUuaHJlZk5vSGFzaCA9PT0gZG9jdW1lbnRCYXNlLmhyZWZOb0hhc2ggKSwKCgkJCQkJLy8gR2V0IHRoZSBmaXJzdCBwYWdlIGVsZW1lbnQuCgkJCQkJZnAgPSAkLm1vYmlsZS5maXJzdFBhZ2UsCgoJCQkJCS8vIEdldCB0aGUgaWQgb2YgdGhlIGZpcnN0IHBhZ2UgZWxlbWVudCBpZiBpdCBoYXMgb25lLgoJCQkJCWZwSWQgPSBmcCAmJiBmcFswXSA/IGZwWzBdLmlkIDogdW5kZWZpbmVkOwoKCQkJCQkvLyBUaGUgdXJsIHJlZmVycyB0byB0aGUgZmlyc3QgcGFnZSBpZiB0aGUgcGF0aCBtYXRjaGVzIHRoZSBkb2N1bWVudCBhbmQKCQkJCQkvLyBpdCBlaXRoZXIgaGFzIG5vIGhhc2ggdmFsdWUsIG9yIHRoZSBoYXNoIGlzIGV4YWN0bHkgZXF1YWwgdG8gdGhlIGlkIG9mIHRoZQoJCQkJCS8vIGZpcnN0IHBhZ2UgZWxlbWVudC4KCQkJCQlyZXR1cm4gc2FtZVBhdGggJiYgKCAhdS5oYXNoIHx8IHUuaGFzaCA9PT0gIiMiIHx8ICggZnBJZCAmJiB1Lmhhc2gucmVwbGFjZSggL14jLywgIiIgKSA9PT0gZnBJZCApICk7CgkJCX0sCgoJCQlpc0VtYmVkZGVkUGFnZTogZnVuY3Rpb24oIHVybCApIHsKCQkJCXZhciB1ID0gcGF0aC5wYXJzZVVybCggdXJsICk7CgoJCQkJLy9pZiB0aGUgcGF0aCBpcyBhYnNvbHV0ZSwgdGhlbiB3ZSBuZWVkIHRvIGNvbXBhcmUgdGhlIHVybCBhZ2FpbnN0CgkJCQkvL2JvdGggdGhlIGRvY3VtZW50VXJsIGFuZCB0aGUgZG9jdW1lbnRCYXNlLiBUaGUgbWFpbiByZWFzb24gZm9yIHRoaXMKCQkJCS8vaXMgdGhhdCBsaW5rcyBlbWJlZGRlZCB3aXRoaW4gZXh0ZXJuYWwgZG9jdW1lbnRzIHdpbGwgcmVmZXIgdG8gdGhlCgkJCQkvL2FwcGxpY2F0aW9uIGRvY3VtZW50LCB3aGVyZWFzIGxpbmtzIGVtYmVkZGVkIHdpdGhpbiB0aGUgYXBwbGljYXRpb24KCQkJCS8vZG9jdW1lbnQgd2lsbCBiZSByZXNvbHZlZCBhZ2FpbnN0IHRoZSBkb2N1bWVudCBiYXNlLgoJCQkJaWYgKCB1LnByb3RvY29sICE9PSAiIiApIHsKCQkJCQlyZXR1cm4gKCB1Lmhhc2ggJiYgKCB1LmhyZWZOb0hhc2ggPT09IGRvY3VtZW50VXJsLmhyZWZOb0hhc2ggfHwgKCBkb2N1bWVudEJhc2VEaWZmZXJzICYmIHUuaHJlZk5vSGFzaCA9PT0gZG9jdW1lbnRCYXNlLmhyZWZOb0hhc2ggKSApICk7CgkJCQl9CgkJCQlyZXR1cm4gKCAvXiMvICkudGVzdCggdS5ocmVmICk7CgkJCX0sCgoKCQkJLy8gU29tZSBlbWJlZGRlZCBicm93c2VycywgbGlrZSB0aGUgd2ViIHZpZXcgaW4gUGhvbmUgR2FwLCBhbGxvdyBjcm9zcy1kb21haW4gWEhSCgkJCS8vIHJlcXVlc3RzIGlmIHRoZSBkb2N1bWVudCBkb2luZyB0aGUgcmVxdWVzdCB3YXMgbG9hZGVkIHZpYSB0aGUgZmlsZTovLyBwcm90b2NvbC4KCQkJLy8gVGhpcyBpcyB1c3VhbGx5IHRvIGFsbG93IHRoZSBhcHBsaWNhdGlvbiB0byAicGhvbmUgaG9tZSIgYW5kIGZldGNoIGFwcCBzcGVjaWZpYwoJCQkvLyBkYXRhLiBXZSBub3JtYWxseSBsZXQgdGhlIGJyb3dzZXIgaGFuZGxlIGV4dGVybmFsL2Nyb3NzLWRvbWFpbiB1cmxzLCBidXQgaWYgdGhlCgkJCS8vIGFsbG93Q3Jvc3NEb21haW5QYWdlcyBvcHRpb24gaXMgdHJ1ZSwgd2Ugd2lsbCBhbGxvdyBjcm9zcy1kb21haW4gaHR0cC9odHRwcwoJCQkvLyByZXF1ZXN0cyB0byBnbyB0aHJvdWdoIG91ciBwYWdlIGxvYWRpbmcgbG9naWMuCgkJCWlzUGVybWl0dGVkQ3Jvc3NEb21haW5SZXF1ZXN0OiBmdW5jdGlvbiggZG9jVXJsLCByZXFVcmwgKSB7CgkJCQlyZXR1cm4gJC5tb2JpbGUuYWxsb3dDcm9zc0RvbWFpblBhZ2VzICYmCgkJCQkJZG9jVXJsLnByb3RvY29sID09PSAiZmlsZToiICYmCgkJCQkJcmVxVXJsLnNlYXJjaCggL15odHRwcz86LyApICE9PSAtMTsKCQkJfQoJCX0sCgoJCS8vd2lsbCBiZSBkZWZpbmVkIHdoZW4gYSBsaW5rIGlzIGNsaWNrZWQgYW5kIGdpdmVuIGFuIGFjdGl2ZSBjbGFzcwoJCSRhY3RpdmVDbGlja2VkTGluayA9IG51bGwsCgoJCS8vdXJsSGlzdG9yeSBpcyBwdXJlbHkgaGVyZSB0byBtYWtlIGd1ZXNzZXMgYXQgd2hldGhlciB0aGUgYmFjayBvciBmb3J3YXJkIGJ1dHRvbiB3YXMgY2xpY2tlZAoJCS8vYW5kIHByb3ZpZGUgYW4gYXBwcm9wcmlhdGUgdHJhbnNpdGlvbgoJCXVybEhpc3RvcnkgPSB7CgkJCS8vIEFycmF5IG9mIHBhZ2VzIHRoYXQgYXJlIHZpc2l0ZWQgZHVyaW5nIGEgc2luZ2xlIHBhZ2UgbG9hZC4KCQkJLy8gRWFjaCBoYXMgYSB1cmwgYW5kIG9wdGlvbmFsIHRyYW5zaXRpb24sIHRpdGxlLCBhbmQgcGFnZVVybCAod2hpY2ggcmVwcmVzZW50cyB0aGUgZmlsZSBwYXRoLCBpbiBjYXNlcyB3aGVyZSBVUkwgaXMgb2JzY3VyZWQsIHN1Y2ggYXMgZGlhbG9ncykKCQkJc3RhY2s6IFtdLAoKCQkJLy9tYWludGFpbiBhbiBpbmRleCBudW1iZXIgZm9yIHRoZSBhY3RpdmUgcGFnZSBpbiB0aGUgc3RhY2sKCQkJYWN0aXZlSW5kZXg6IDAsCgoJCQkvL2dldCBhY3RpdmUKCQkJZ2V0QWN0aXZlOiBmdW5jdGlvbigpIHsKCQkJCXJldHVybiB1cmxIaXN0b3J5LnN0YWNrWyB1cmxIaXN0b3J5LmFjdGl2ZUluZGV4IF07CgkJCX0sCgoJCQlnZXRQcmV2OiBmdW5jdGlvbigpIHsKCQkJCXJldHVybiB1cmxIaXN0b3J5LnN0YWNrWyB1cmxIaXN0b3J5LmFjdGl2ZUluZGV4IC0gMSBdOwoJCQl9LAoKCQkJZ2V0TmV4dDogZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gdXJsSGlzdG9yeS5zdGFja1sgdXJsSGlzdG9yeS5hY3RpdmVJbmRleCArIDEgXTsKCQkJfSwKCgkJCS8vIGFkZE5ldyBpcyB1c2VkIHdoZW5ldmVyIGEgbmV3IHBhZ2UgaXMgYWRkZWQKCQkJYWRkTmV3OiBmdW5jdGlvbiggdXJsLCB0cmFuc2l0aW9uLCB0aXRsZSwgcGFnZVVybCwgcm9sZSApIHsKCQkJCS8vaWYgdGhlcmUncyBmb3J3YXJkIGhpc3RvcnksIHdpcGUgaXQKCQkJCWlmICggdXJsSGlzdG9yeS5nZXROZXh0KCkgKSB7CgkJCQkJdXJsSGlzdG9yeS5jbGVhckZvcndhcmQoKTsKCQkJCX0KCgkJCQl1cmxIaXN0b3J5LnN0YWNrLnB1c2goIHt1cmwgOiB1cmwsIHRyYW5zaXRpb246IHRyYW5zaXRpb24sIHRpdGxlOiB0aXRsZSwgcGFnZVVybDogcGFnZVVybCwgcm9sZTogcm9sZSB9ICk7CgoJCQkJdXJsSGlzdG9yeS5hY3RpdmVJbmRleCA9IHVybEhpc3Rvcnkuc3RhY2subGVuZ3RoIC0gMTsKCQkJfSwKCgkJCS8vd2lwZSB1cmxzIGFoZWFkIG9mIGFjdGl2ZSBpbmRleAoJCQljbGVhckZvcndhcmQ6IGZ1bmN0aW9uKCkgewoJCQkJdXJsSGlzdG9yeS5zdGFjayA9IHVybEhpc3Rvcnkuc3RhY2suc2xpY2UoIDAsIHVybEhpc3RvcnkuYWN0aXZlSW5kZXggKyAxICk7CgkJCX0sCgoJCQlkaXJlY3RIYXNoQ2hhbmdlOiBmdW5jdGlvbiggb3B0cyApIHsKCQkJCXZhciBiYWNrICwgZm9yd2FyZCwgbmV3QWN0aXZlSW5kZXgsIHByZXYgPSB0aGlzLmdldEFjdGl2ZSgpOwoKCQkJCS8vIGNoZWNrIGlmIHVybCBpcyBpbiBoaXN0b3J5IGFuZCBpZiBpdCdzIGFoZWFkIG9yIGJlaGluZCBjdXJyZW50IHBhZ2UKCQkJCSQuZWFjaCggdXJsSGlzdG9yeS5zdGFjaywgZnVuY3Rpb24oIGksIGhpc3RvcnlFbnRyeSApIHsKCgkJCQkJLy9pZiB0aGUgdXJsIGlzIGluIHRoZSBzdGFjaywgaXQncyBhIGZvcndhcmQgb3IgYSBiYWNrCgkJCQkJaWYgKCBkZWNvZGVVUklDb21wb25lbnQoIG9wdHMuY3VycmVudFVybCApID09PSBkZWNvZGVVUklDb21wb25lbnQoIGhpc3RvcnlFbnRyeS51cmwgKSApIHsKCQkJCQkJLy9kZWZpbmUgYmFjayBhbmQgZm9yd2FyZCBieSB3aGV0aGVyIHVybCBpcyBvbGRlciBvciBuZXdlciB0aGFuIGN1cnJlbnQgcGFnZQoJCQkJCQliYWNrID0gaSA8IHVybEhpc3RvcnkuYWN0aXZlSW5kZXg7CgkJCQkJCWZvcndhcmQgPSAhYmFjazsKCQkJCQkJbmV3QWN0aXZlSW5kZXggPSBpOwoJCQkJCX0KCQkJCX0pOwoKCQkJCS8vIHNhdmUgbmV3IHBhZ2UgaW5kZXgsIG51bGwgY2hlY2sgdG8gcHJldmVudCBmYWxzZXkgMCByZXN1bHQKCQkJCXRoaXMuYWN0aXZlSW5kZXggPSBuZXdBY3RpdmVJbmRleCAhPT0gdW5kZWZpbmVkID8gbmV3QWN0aXZlSW5kZXggOiB0aGlzLmFjdGl2ZUluZGV4OwoKCQkJCWlmICggYmFjayApIHsKCQkJCQkoIG9wdHMuZWl0aGVyIHx8IG9wdHMuaXNCYWNrICkoIHRydWUgKTsKCQkJCX0gZWxzZSBpZiAoIGZvcndhcmQgKSB7CgkJCQkJKCBvcHRzLmVpdGhlciB8fCBvcHRzLmlzRm9yd2FyZCApKCBmYWxzZSApOwoJCQkJfQoJCQl9LAoKCQkJLy9kaXNhYmxlIGhhc2hjaGFuZ2UgZXZlbnQgbGlzdGVuZXIgaW50ZXJuYWxseSB0byBpZ25vcmUgb25lIGNoYW5nZQoJCQkvL3RvZ2dsZWQgaW50ZXJuYWxseSB3aGVuIGxvY2F0aW9uLmhhc2ggaXMgdXBkYXRlZCB0byBtYXRjaCB0aGUgdXJsIG9mIGEgc3VjY2Vzc2Z1bCBwYWdlIGxvYWQKCQkJaWdub3JlTmV4dEhhc2hDaGFuZ2U6IGZhbHNlCgkJfSwKCgkJLy9kZWZpbmUgZmlyc3Qgc2VsZWN0b3IgdG8gcmVjZWl2ZSBmb2N1cyB3aGVuIGEgcGFnZSBpcyBzaG93bgoJCWZvY3VzYWJsZSA9ICJbdGFiaW5kZXhdLGEsYnV0dG9uOnZpc2libGUsc2VsZWN0OnZpc2libGUsaW5wdXQiLAoKCQkvL3F1ZXVlIHRvIGhvbGQgc2ltdWx0YW5pb3VzIHBhZ2UgdHJhbnNpdGlvbnMKCQlwYWdlVHJhbnNpdGlvblF1ZXVlID0gW10sCgoJCS8vaW5kaWNhdGVzIHdoZXRoZXIgb3Igbm90IHBhZ2UgaXMgaW4gcHJvY2VzcyBvZiB0cmFuc2l0aW9uaW5nCgkJaXNQYWdlVHJhbnNpdGlvbmluZyA9IGZhbHNlLAoKCQkvL25vbnNlbnNlIGhhc2ggY2hhbmdlIGtleSBmb3IgZGlhbG9ncywgc28gdGhleSBjcmVhdGUgYSBoaXN0b3J5IGVudHJ5CgkJZGlhbG9nSGFzaEtleSA9ICImdWktc3RhdGU9ZGlhbG9nIiwKCgkJLy9leGlzdGluZyBiYXNlIHRhZz8KCQkkYmFzZSA9ICRoZWFkLmNoaWxkcmVuKCAiYmFzZSIgKSwKCgkJLy90dWNrIGF3YXkgdGhlIG9yaWdpbmFsIGRvY3VtZW50IFVSTCBtaW51cyBhbnkgZnJhZ21lbnQuCgkJZG9jdW1lbnRVcmwgPSBwYXRoLnBhcnNlTG9jYXRpb24oKSwKCgkJLy9pZiB0aGUgZG9jdW1lbnQgaGFzIGFuIGVtYmVkZGVkIGJhc2UgdGFnLCBkb2N1bWVudEJhc2UgaXMgc2V0IHRvIGl0cwoJCS8vaW5pdGlhbCB2YWx1ZS4gSWYgYSBiYXNlIHRhZyBkb2VzIG5vdCBleGlzdCwgdGhlbiB3ZSBkZWZhdWx0IHRvIHRoZSBkb2N1bWVudFVybC4KCQlkb2N1bWVudEJhc2UgPSAkYmFzZS5sZW5ndGggPyBwYXRoLnBhcnNlVXJsKCBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggJGJhc2UuYXR0ciggImhyZWYiICksIGRvY3VtZW50VXJsLmhyZWYgKSApIDogZG9jdW1lbnRVcmwsCgoJCS8vY2FjaGUgdGhlIGNvbXBhcmlzb24gb25jZS4KCQlkb2N1bWVudEJhc2VEaWZmZXJzID0gKCBkb2N1bWVudFVybC5ocmVmTm9IYXNoICE9PSBkb2N1bWVudEJhc2UuaHJlZk5vSGFzaCApLAoKCQlnZXRTY3JlZW5IZWlnaHQgPSAkLm1vYmlsZS5nZXRTY3JlZW5IZWlnaHQ7CgoJCS8vYmFzZSBlbGVtZW50IG1hbmFnZW1lbnQsIGRlZmluZWQgZGVwZW5kaW5nIG9uIGR5bmFtaWMgYmFzZSB0YWcgc3VwcG9ydAoJCXZhciBiYXNlID0gJC5zdXBwb3J0LmR5bmFtaWNCYXNlVGFnID8gewoKCQkJLy9kZWZpbmUgYmFzZSBlbGVtZW50LCBmb3IgdXNlIGluIHJvdXRpbmcgYXNzZXQgdXJscyB0aGF0IGFyZSByZWZlcmVuY2VkIGluIEFqYXgtcmVxdWVzdGVkIG1hcmt1cAoJCQllbGVtZW50OiAoICRiYXNlLmxlbmd0aCA/ICRiYXNlIDogJCggIjxiYXNlPiIsIHsgaHJlZjogZG9jdW1lbnRCYXNlLmhyZWZOb0hhc2ggfSApLnByZXBlbmRUbyggJGhlYWQgKSApLAoKCQkJLy9zZXQgdGhlIGdlbmVyYXRlZCBCQVNFIGVsZW1lbnQncyBocmVmIGF0dHJpYnV0ZSB0byBhIG5ldyBwYWdlJ3MgYmFzZSBwYXRoCgkJCXNldDogZnVuY3Rpb24oIGhyZWYgKSB7CgkJCQliYXNlLmVsZW1lbnQuYXR0ciggImhyZWYiLCBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggaHJlZiwgZG9jdW1lbnRCYXNlICkgKTsKCQkJfSwKCgkJCS8vc2V0IHRoZSBnZW5lcmF0ZWQgQkFTRSBlbGVtZW50J3MgaHJlZiBhdHRyaWJ1dGUgdG8gYSBuZXcgcGFnZSdzIGJhc2UgcGF0aAoJCQlyZXNldDogZnVuY3Rpb24oKSB7CgkJCQliYXNlLmVsZW1lbnQuYXR0ciggImhyZWYiLCBkb2N1bWVudEJhc2UuaHJlZk5vSGFzaCApOwoJCQl9CgoJCX0gOiB1bmRlZmluZWQ7CgoJLyogaW50ZXJuYWwgdXRpbGl0eSBmdW5jdGlvbnMgKi8KCgkvLyBOT1RFIElzc3VlICM0OTUwIEFuZHJvaWQgcGhvbmVnYXAgZG9lc24ndCBuYXZpZ2F0ZSBiYWNrIHByb3Blcmx5CgkvLyAgICAgIHdoZW4gYSBmdWxsIHBhZ2UgcmVmcmVzaCBoYXMgdGFrZW4gcGxhY2UuIEl0IGFwcGVhcnMgdGhhdCBoYXNoY2hhbmdlCgkvLyAgICAgIGFuZCByZXBsYWNlc3RhdGUgaGlzdG9yeSBhbHRlcmF0aW9ucyB3b3JrIGZpbmUgYnV0IHdlIG5lZWQgdG8gc3VwcG9ydAoJLy8gICAgICBib3RoIGZvcm1zIG9mIGhpc3RvcnkgdHJhdmVyc2FsIGluIG91ciBjb2RlIHRoYXQgdXNlcyBiYWNrd2FyZCBoaXN0b3J5CgkvLyAgICAgIG1vdmVtZW50CgkkLm1vYmlsZS5iYWNrID0gZnVuY3Rpb24oKSB7CgkJdmFyIG5hdiA9IHdpbmRvdy5uYXZpZ2F0b3I7CgoJCS8vIGlmIHRoZSBzZXR0aW5nIGlzIG9uIGFuZCB0aGUgbmF2aWdhdG9yIG9iamVjdCBpcwoJCS8vIGF2YWlsYWJsZSB1c2UgdGhlIHBob25lZ2FwIG5hdmlnYXRpb24gY2FwYWJpbGl0eQoJCWlmKCB0aGlzLnBob25lZ2FwTmF2aWdhdGlvbkVuYWJsZWQgJiYKCQkJbmF2ICYmCgkJCW5hdi5hcHAgJiYKCQkJbmF2LmFwcC5iYWNrSGlzdG9yeSApewoJCQluYXYuYXBwLmJhY2tIaXN0b3J5KCk7CgkJfSBlbHNlIHsKCQkJd2luZG93Lmhpc3RvcnkuYmFjaygpOwoJCX0KCX07CgoJLy9kaXJlY3QgZm9jdXMgdG8gdGhlIHBhZ2UgdGl0bGUsIG9yIG90aGVyd2lzZSBmaXJzdCBmb2N1c2FibGUgZWxlbWVudAoJJC5tb2JpbGUuZm9jdXNQYWdlID0gZnVuY3Rpb24gKCBwYWdlICkgewoJCXZhciBhdXRvZm9jdXMgPSBwYWdlLmZpbmQoICJbYXV0b2ZvY3VzXSIgKSwKCQkJcGFnZVRpdGxlID0gcGFnZS5maW5kKCAiLnVpLXRpdGxlOmVxKDApIiApOwoKCQlpZiAoIGF1dG9mb2N1cy5sZW5ndGggKSB7CgkJCWF1dG9mb2N1cy5mb2N1cygpOwoJCQlyZXR1cm47CgkJfQoKCQlpZiAoIHBhZ2VUaXRsZS5sZW5ndGggKSB7CgkJCXBhZ2VUaXRsZS5mb2N1cygpOwoJCX0gZWxzZXsKCQkJcGFnZS5mb2N1cygpOwoJCX0KCX07CgoJLy9yZW1vdmUgYWN0aXZlIGNsYXNzZXMgYWZ0ZXIgcGFnZSB0cmFuc2l0aW9uIG9yIGVycm9yCglmdW5jdGlvbiByZW1vdmVBY3RpdmVMaW5rQ2xhc3MoIGZvcmNlUmVtb3ZhbCApIHsKCQlpZiAoICEhJGFjdGl2ZUNsaWNrZWRMaW5rICYmICggISRhY3RpdmVDbGlja2VkTGluay5jbG9zZXN0KCAiLiIgKyAkLm1vYmlsZS5hY3RpdmVQYWdlQ2xhc3MgKS5sZW5ndGggfHwgZm9yY2VSZW1vdmFsICkgKSB7CgkJCSRhY3RpdmVDbGlja2VkTGluay5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQl9CgkJJGFjdGl2ZUNsaWNrZWRMaW5rID0gbnVsbDsKCX0KCglmdW5jdGlvbiByZWxlYXNlUGFnZVRyYW5zaXRpb25Mb2NrKCkgewoJCWlzUGFnZVRyYW5zaXRpb25pbmcgPSBmYWxzZTsKCQlpZiAoIHBhZ2VUcmFuc2l0aW9uUXVldWUubGVuZ3RoID4gMCApIHsKCQkJJC5tb2JpbGUuY2hhbmdlUGFnZS5hcHBseSggbnVsbCwgcGFnZVRyYW5zaXRpb25RdWV1ZS5wb3AoKSApOwoJCX0KCX0KCgkvLyBTYXZlIHRoZSBsYXN0IHNjcm9sbCBkaXN0YW5jZSBwZXIgcGFnZSwgYmVmb3JlIGl0IGlzIGhpZGRlbgoJdmFyIHNldExhc3RTY3JvbGxFbmFibGVkID0gdHJ1ZSwKCQlzZXRMYXN0U2Nyb2xsLCBkZWxheWVkU2V0TGFzdFNjcm9sbDsKCglzZXRMYXN0U2Nyb2xsID0gZnVuY3Rpb24oKSB7CgkJLy8gdGhpcyBiYXJyaWVyIHByZXZlbnRzIHNldHRpbmcgdGhlIHNjcm9sbCB2YWx1ZSBiYXNlZCBvbiB0aGUgYnJvd3NlcgoJCS8vIHNjcm9sbGluZyB0aGUgd2luZG93IGJhc2VkIG9uIGEgaGFzaGNoYW5nZQoJCWlmICggIXNldExhc3RTY3JvbGxFbmFibGVkICkgewoJCQlyZXR1cm47CgkJfQoKCQl2YXIgYWN0aXZlID0gJC5tb2JpbGUudXJsSGlzdG9yeS5nZXRBY3RpdmUoKTsKCgkJaWYgKCBhY3RpdmUgKSB7CgkJCXZhciBsYXN0U2Nyb2xsID0gJHdpbmRvdy5zY3JvbGxUb3AoKTsKCgkJCS8vIFNldCBhY3RpdmUgcGFnZSdzIGxhc3RTY3JvbGwgcHJvcC4KCQkJLy8gSWYgdGhlIGxvY2F0aW9uIHdlJ3JlIHNjcm9sbGluZyB0byBpcyBsZXNzIHRoYW4gbWluU2Nyb2xsQmFjaywgbGV0IGl0IGdvLgoJCQlhY3RpdmUubGFzdFNjcm9sbCA9IGxhc3RTY3JvbGwgPCAkLm1vYmlsZS5taW5TY3JvbGxCYWNrID8gJC5tb2JpbGUuZGVmYXVsdEhvbWVTY3JvbGwgOiBsYXN0U2Nyb2xsOwoJCX0KCX07CgoJLy8gYmluZCB0byBzY3JvbGxzdG9wIHRvIGdhdGhlciBzY3JvbGwgcG9zaXRpb24uIFRoZSBkZWxheSBhbGxvd3MgZm9yIHRoZSBoYXNoY2hhbmdlCgkvLyBldmVudCB0byBmaXJlIGFuZCBkaXNhYmxlIHNjcm9sbCByZWNvcmRpbmcgaW4gdGhlIGNhc2Ugd2hlcmUgdGhlIGJyb3dzZXIgc2Nyb2xscwoJLy8gdG8gdGhlIGhhc2ggdGFyZ2V0cyBsb2NhdGlvbiAoc29tZXRpbWVzIHRoZSB0b3Agb2YgdGhlIHBhZ2UpLiBvbmNlIHBhZ2VjaGFuZ2UgZmlyZXMKCS8vIGdldExhc3RTY3JvbGwgaXMgYWdhaW4gcGVybWl0dGVkIHRvIG9wZXJhdGUKCWRlbGF5ZWRTZXRMYXN0U2Nyb2xsID0gZnVuY3Rpb24oKSB7CgkJc2V0VGltZW91dCggc2V0TGFzdFNjcm9sbCwgMTAwICk7Cgl9OwoKCS8vIGRpc2FibGUgYW4gc2Nyb2xsIHNldHRpbmcgd2hlbiBhIGhhc2hjaGFuZ2UgaGFzIGJlZW4gZmlyZWQsIHRoaXMgb25seSB3b3JrcwoJLy8gYmVjYXVzZSB0aGUgcmVjb3JkaW5nIG9mIHRoZSBzY3JvbGwgcG9zaXRpb24gaXMgZGVsYXllZCBmb3IgMTAwbXMgYWZ0ZXIKCS8vIHRoZSBicm93c2VyIG1pZ2h0IGhhdmUgY2hhbmdlZCB0aGUgcG9zaXRpb24gYmVjYXVzZSBvZiB0aGUgaGFzaGNoYW5nZQoJJHdpbmRvdy5iaW5kKCAkLnN1cHBvcnQucHVzaFN0YXRlID8gInBvcHN0YXRlIiA6ICJoYXNoY2hhbmdlIiwgZnVuY3Rpb24oKSB7CgkJc2V0TGFzdFNjcm9sbEVuYWJsZWQgPSBmYWxzZTsKCX0pOwoKCS8vIGhhbmRsZSBpbml0aWFsIGhhc2hjaGFuZ2UgZnJvbSBjaHJvbWUgOigKCSR3aW5kb3cub25lKCAkLnN1cHBvcnQucHVzaFN0YXRlID8gInBvcHN0YXRlIiA6ICJoYXNoY2hhbmdlIiwgZnVuY3Rpb24oKSB7CgkJc2V0TGFzdFNjcm9sbEVuYWJsZWQgPSB0cnVlOwoJfSk7CgoJLy8gd2FpdCB1bnRpbCB0aGUgbW9iaWxlIHBhZ2UgY29udGFpbmVyIGhhcyBiZWVuIGRldGVybWluZWQgdG8gYmluZCB0byBwYWdlY2hhbmdlCgkkd2luZG93Lm9uZSggInBhZ2Vjb250YWluZXJjcmVhdGUiLCBmdW5jdGlvbigpIHsKCQkvLyBvbmNlIHRoZSBwYWdlIGhhcyBjaGFuZ2VkLCByZS1lbmFibGUgdGhlIHNjcm9sbCByZWNvcmRpbmcKCQkkLm1vYmlsZS5wYWdlQ29udGFpbmVyLmJpbmQoICJwYWdlY2hhbmdlIiwgZnVuY3Rpb24oKSB7CgoJCQlzZXRMYXN0U2Nyb2xsRW5hYmxlZCA9IHRydWU7CgoJCQkvLyByZW1vdmUgYW55IGJpbmRpbmcgdGhhdCBwcmV2aW91c2x5IGV4aXN0ZWQgb24gdGhlIGdldCBzY3JvbGwKCQkJLy8gd2hpY2ggbWF5IG9yIG1heSBub3QgYmUgZGlmZmVyZW50IHRoYW4gdGhlIHNjcm9sbCBlbGVtZW50IGRldGVybWluZWQgZm9yCgkJCS8vIHRoaXMgcGFnZSBwcmV2aW91c2x5CgkJCSR3aW5kb3cudW5iaW5kKCAic2Nyb2xsc3RvcCIsIGRlbGF5ZWRTZXRMYXN0U2Nyb2xsICk7CgoJCQkvLyBkZXRlcm1pbmUgYW5kIGJpbmQgdG8gdGhlIGN1cnJlbnQgc2NvbGwgZWxlbWVudCB3aGljaCBtYXkgYmUgdGhlIHdpbmRvdwoJCQkvLyBvciBpbiB0aGUgY2FzZSBvZiB0b3VjaCBvdmVyZmxvdyB0aGUgZWxlbWVudCB3aXRoIHRvdWNoIG92ZXJmbG93CgkJCSR3aW5kb3cuYmluZCggInNjcm9sbHN0b3AiLCBkZWxheWVkU2V0TGFzdFNjcm9sbCApOwoJCX0pOwoJfSk7CgoJLy8gYmluZCB0byBzY3JvbGxzdG9wIGZvciB0aGUgZmlyc3QgcGFnZSBhcyAicGFnZWNoYW5nZSIgd29uJ3QgYmUgZmlyZWQgaW4gdGhhdCBjYXNlCgkkd2luZG93LmJpbmQoICJzY3JvbGxzdG9wIiwgZGVsYXllZFNldExhc3RTY3JvbGwgKTsKCgkvLyBOby1vcCBpbXBsZW1lbnRhdGlvbiBvZiB0cmFuc2l0aW9uIGRlZ3JhZGF0aW9uCgkkLm1vYmlsZS5fbWF5YmVEZWdyYWRlVHJhbnNpdGlvbiA9ICQubW9iaWxlLl9tYXliZURlZ3JhZGVUcmFuc2l0aW9uIHx8IGZ1bmN0aW9uKCB0cmFuc2l0aW9uICkgewoJCXJldHVybiB0cmFuc2l0aW9uOwoJfTsKCgkvL2Z1bmN0aW9uIGZvciB0cmFuc2l0aW9uaW5nIGJldHdlZW4gdHdvIGV4aXN0aW5nIHBhZ2VzCglmdW5jdGlvbiB0cmFuc2l0aW9uUGFnZXMoIHRvUGFnZSwgZnJvbVBhZ2UsIHRyYW5zaXRpb24sIHJldmVyc2UgKSB7CgoJCWlmICggZnJvbVBhZ2UgKSB7CgkJCS8vdHJpZ2dlciBiZWZvcmUgc2hvdy9oaWRlIGV2ZW50cwoJCQlmcm9tUGFnZS5kYXRhKCAicGFnZSIgKS5fdHJpZ2dlciggImJlZm9yZWhpZGUiLCBudWxsLCB7IG5leHRQYWdlOiB0b1BhZ2UgfSApOwoJCX0KCgkJdG9QYWdlLmRhdGEoICJwYWdlIiApLl90cmlnZ2VyKCAiYmVmb3Jlc2hvdyIsIG51bGwsIHsgcHJldlBhZ2U6IGZyb21QYWdlIHx8ICQoICIiICkgfSApOwoKCQkvL2NsZWFyIHBhZ2UgbG9hZGVyCgkJJC5tb2JpbGUuaGlkZVBhZ2VMb2FkaW5nTXNnKCk7CgoJCXRyYW5zaXRpb24gPSAkLm1vYmlsZS5fbWF5YmVEZWdyYWRlVHJhbnNpdGlvbiggdHJhbnNpdGlvbiApOwoKCQkvL2ZpbmQgdGhlIHRyYW5zaXRpb24gaGFuZGxlciBmb3IgdGhlIHNwZWNpZmllZCB0cmFuc2l0aW9uLiBJZiB0aGVyZQoJCS8vaXNuJ3Qgb25lIGluIG91ciB0cmFuc2l0aW9uSGFuZGxlcnMgZGljdGlvbmFyeSwgdXNlIHRoZSBkZWZhdWx0IG9uZS4KCQkvL2NhbGwgdGhlIGhhbmRsZXIgaW1tZWRpYXRlbHkgdG8ga2ljay1vZmYgdGhlIHRyYW5zaXRpb24uCgkJdmFyIHRoID0gJC5tb2JpbGUudHJhbnNpdGlvbkhhbmRsZXJzWyB0cmFuc2l0aW9uIHx8ICJkZWZhdWx0IiBdIHx8ICQubW9iaWxlLmRlZmF1bHRUcmFuc2l0aW9uSGFuZGxlciwKCQkJcHJvbWlzZSA9IHRoKCB0cmFuc2l0aW9uLCByZXZlcnNlLCB0b1BhZ2UsIGZyb21QYWdlICk7CgoJCXByb21pc2UuZG9uZShmdW5jdGlvbigpIHsKCgkJCS8vdHJpZ2dlciBzaG93L2hpZGUgZXZlbnRzCgkJCWlmICggZnJvbVBhZ2UgKSB7CgkJCQlmcm9tUGFnZS5kYXRhKCAicGFnZSIgKS5fdHJpZ2dlciggImhpZGUiLCBudWxsLCB7IG5leHRQYWdlOiB0b1BhZ2UgfSApOwoJCQl9CgoJCQkvL3RyaWdnZXIgcGFnZXNob3csIGRlZmluZSBwcmV2UGFnZSBhcyBlaXRoZXIgZnJvbVBhZ2Ugb3IgZW1wdHkgalF1ZXJ5IG9iagoJCQl0b1BhZ2UuZGF0YSggInBhZ2UiICkuX3RyaWdnZXIoICJzaG93IiwgbnVsbCwgeyBwcmV2UGFnZTogZnJvbVBhZ2UgfHwgJCggIiIgKSB9ICk7CgkJfSk7CgoJCXJldHVybiBwcm9taXNlOwoJfQoKCS8vc2ltcGx5IHNldCB0aGUgYWN0aXZlIHBhZ2UncyBtaW5pbXVtIGhlaWdodCB0byBzY3JlZW4gaGVpZ2h0LCBkZXBlbmRpbmcgb24gb3JpZW50YXRpb24KCWZ1bmN0aW9uIHJlc2V0QWN0aXZlUGFnZUhlaWdodCgpIHsKCQl2YXIgYVBhZ2UgPSAkKCAiLiIgKyAkLm1vYmlsZS5hY3RpdmVQYWdlQ2xhc3MgKSwKCQkJYVBhZ2VQYWRUID0gcGFyc2VGbG9hdCggYVBhZ2UuY3NzKCAicGFkZGluZy10b3AiICkgKSwKCQkJYVBhZ2VQYWRCID0gcGFyc2VGbG9hdCggYVBhZ2UuY3NzKCAicGFkZGluZy1ib3R0b20iICkgKSwKCQkJYVBhZ2VCb3JkZXJUID0gcGFyc2VGbG9hdCggYVBhZ2UuY3NzKCAiYm9yZGVyLXRvcC13aWR0aCIgKSApLAoJCQlhUGFnZUJvcmRlckIgPSBwYXJzZUZsb2F0KCBhUGFnZS5jc3MoICJib3JkZXItYm90dG9tLXdpZHRoIiApICk7CgoJCWFQYWdlLmNzcyggIm1pbi1oZWlnaHQiLCBnZXRTY3JlZW5IZWlnaHQoKSAtIGFQYWdlUGFkVCAtIGFQYWdlUGFkQiAtIGFQYWdlQm9yZGVyVCAtIGFQYWdlQm9yZGVyQiApOwoJfQoKCS8vc2hhcmVkIHBhZ2UgZW5oYW5jZW1lbnRzCglmdW5jdGlvbiBlbmhhbmNlUGFnZSggJHBhZ2UsIHJvbGUgKSB7CgkJLy8gSWYgYSByb2xlIHdhcyBzcGVjaWZpZWQsIG1ha2Ugc3VyZSB0aGUgZGF0YS1yb2xlIGF0dHJpYnV0ZQoJCS8vIG9uIHRoZSBwYWdlIGVsZW1lbnQgaXMgaW4gc3luYy4KCQlpZiAoIHJvbGUgKSB7CgkJCSRwYWdlLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyb2xlIiwgcm9sZSApOwoJCX0KCgkJLy9ydW4gcGFnZSBwbHVnaW4KCQkkcGFnZS5wYWdlKCk7Cgl9CgoJLyogZXhwb3NlZCAkLm1vYmlsZSBtZXRob2RzICovCgoJLy9hbmltYXRpb24gY29tcGxldGUgY2FsbGJhY2sKCSQuZm4uYW5pbWF0aW9uQ29tcGxldGUgPSBmdW5jdGlvbiggY2FsbGJhY2sgKSB7CgkJaWYgKCAkLnN1cHBvcnQuY3NzVHJhbnNpdGlvbnMgKSB7CgkJCXJldHVybiAkKCB0aGlzICkub25lKCAnd2Via2l0QW5pbWF0aW9uRW5kIGFuaW1hdGlvbmVuZCcsIGNhbGxiYWNrICk7CgkJfQoJCWVsc2V7CgkJCS8vIGRlZmVyIGV4ZWN1dGlvbiBmb3IgY29uc2lzdGVuY3kgYmV0d2VlbiB3ZWJraXQvbm9uIHdlYmtpdAoJCQlzZXRUaW1lb3V0KCBjYWxsYmFjaywgMCApOwoJCQlyZXR1cm4gJCggdGhpcyApOwoJCX0KCX07CgoJLy9leHBvc2UgcGF0aCBvYmplY3Qgb24gJC5tb2JpbGUKCSQubW9iaWxlLnBhdGggPSBwYXRoOwoKCS8vZXhwb3NlIGJhc2Ugb2JqZWN0IG9uICQubW9iaWxlCgkkLm1vYmlsZS5iYXNlID0gYmFzZTsKCgkvL2hpc3Rvcnkgc3RhY2sKCSQubW9iaWxlLnVybEhpc3RvcnkgPSB1cmxIaXN0b3J5OwoKCSQubW9iaWxlLmRpYWxvZ0hhc2hLZXkgPSBkaWFsb2dIYXNoS2V5OwoKCgoJLy9lbmFibGUgY3Jvc3MtZG9tYWluIHBhZ2Ugc3VwcG9ydAoJJC5tb2JpbGUuYWxsb3dDcm9zc0RvbWFpblBhZ2VzID0gZmFsc2U7CgoJLy9yZXR1cm4gdGhlIG9yaWdpbmFsIGRvY3VtZW50IHVybAoJJC5tb2JpbGUuZ2V0RG9jdW1lbnRVcmwgPSBmdW5jdGlvbiggYXNQYXJzZWRPYmplY3QgKSB7CgkJcmV0dXJuIGFzUGFyc2VkT2JqZWN0ID8gJC5leHRlbmQoIHt9LCBkb2N1bWVudFVybCApIDogZG9jdW1lbnRVcmwuaHJlZjsKCX07CgoJLy9yZXR1cm4gdGhlIG9yaWdpbmFsIGRvY3VtZW50IGJhc2UgdXJsCgkkLm1vYmlsZS5nZXREb2N1bWVudEJhc2UgPSBmdW5jdGlvbiggYXNQYXJzZWRPYmplY3QgKSB7CgkJcmV0dXJuIGFzUGFyc2VkT2JqZWN0ID8gJC5leHRlbmQoIHt9LCBkb2N1bWVudEJhc2UgKSA6IGRvY3VtZW50QmFzZS5ocmVmOwoJfTsKCgkkLm1vYmlsZS5fYmluZFBhZ2VSZW1vdmUgPSBmdW5jdGlvbigpIHsKCQl2YXIgcGFnZSA9ICQoIHRoaXMgKTsKCgkJLy8gd2hlbiBkb20gY2FjaGluZyBpcyBub3QgZW5hYmxlZCBvciB0aGUgcGFnZSBpcyBlbWJlZGRlZCBiaW5kIHRvIHJlbW92ZSB0aGUgcGFnZSBvbiBoaWRlCgkJaWYgKCAhcGFnZS5kYXRhKCAicGFnZSIgKS5vcHRpb25zLmRvbUNhY2hlICYmCgkJCQlwYWdlLmlzKCAiOmpxbURhdGEoZXh0ZXJuYWwtcGFnZT0ndHJ1ZScpIiApICkgewoKCQkJcGFnZS5iaW5kKCAncGFnZWhpZGUucmVtb3ZlJywgZnVuY3Rpb24oKSB7CgkJCQl2YXIgJHRoaXMgPSAkKCB0aGlzICksCgkJCQkJcHJFdmVudCA9IG5ldyAkLkV2ZW50KCAicGFnZXJlbW92ZSIgKTsKCgkJCQkkdGhpcy50cmlnZ2VyKCBwckV2ZW50ICk7CgoJCQkJaWYgKCAhcHJFdmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJCQkkdGhpcy5yZW1vdmVXaXRoRGVwZW5kZW50cygpOwoJCQkJfQoJCQl9KTsKCQl9Cgl9OwoKCS8vIExvYWQgYSBwYWdlIGludG8gdGhlIERPTS4KCSQubW9iaWxlLmxvYWRQYWdlID0gZnVuY3Rpb24oIHVybCwgb3B0aW9ucyApIHsKCQkvLyBUaGlzIGZ1bmN0aW9uIHVzZXMgZGVmZXJyZWQgbm90aWZpY2F0aW9ucyB0byBsZXQgY2FsbGVycwoJCS8vIGtub3cgd2hlbiB0aGUgcGFnZSBpcyBkb25lIGxvYWRpbmcsIG9yIGlmIGFuIGVycm9yIGhhcyBvY2N1cnJlZC4KCQl2YXIgZGVmZXJyZWQgPSAkLkRlZmVycmVkKCksCgoJCQkvLyBUaGUgZGVmYXVsdCBsb2FkUGFnZSBvcHRpb25zIHdpdGggb3ZlcnJpZGVzIHNwZWNpZmllZCBieQoJCQkvLyB0aGUgY2FsbGVyLgoJCQlzZXR0aW5ncyA9ICQuZXh0ZW5kKCB7fSwgJC5tb2JpbGUubG9hZFBhZ2UuZGVmYXVsdHMsIG9wdGlvbnMgKSwKCgkJCS8vIFRoZSBET00gZWxlbWVudCBmb3IgdGhlIHBhZ2UgYWZ0ZXIgaXQgaGFzIGJlZW4gbG9hZGVkLgoJCQlwYWdlID0gbnVsbCwKCgkJCS8vIElmIHRoZSByZWxvYWRQYWdlIG9wdGlvbiBpcyB0cnVlLCBhbmQgdGhlIHBhZ2UgaXMgYWxyZWFkeQoJCQkvLyBpbiB0aGUgRE9NLCBkdXBDYWNoZWRQYWdlIHdpbGwgYmUgc2V0IHRvIHRoZSBwYWdlIGVsZW1lbnQKCQkJLy8gc28gdGhhdCBpdCBjYW4gYmUgcmVtb3ZlZCBhZnRlciB0aGUgbmV3IHZlcnNpb24gb2YgdGhlCgkJCS8vIHBhZ2UgaXMgbG9hZGVkIG9mZiB0aGUgbmV0d29yay4KCQkJZHVwQ2FjaGVkUGFnZSA9IG51bGwsCgoJCQkvLyBkZXRlcm1pbmUgdGhlIGN1cnJlbnQgYmFzZSB1cmwKCQkJZmluZEJhc2VXaXRoRGVmYXVsdCA9IGZ1bmN0aW9uKCkgewoJCQkJdmFyIGNsb3Nlc3RCYXNlID0gKCAkLm1vYmlsZS5hY3RpdmVQYWdlICYmIGdldENsb3Nlc3RCYXNlVXJsKCAkLm1vYmlsZS5hY3RpdmVQYWdlICkgKTsKCQkJCXJldHVybiBjbG9zZXN0QmFzZSB8fCBkb2N1bWVudEJhc2UuaHJlZk5vSGFzaDsKCQkJfSwKCgkJCS8vIFRoZSBhYnNvbHV0ZSB2ZXJzaW9uIG9mIHRoZSBVUkwgcGFzc2VkIGludG8gdGhlIGZ1bmN0aW9uLiBUaGlzCgkJCS8vIHZlcnNpb24gb2YgdGhlIFVSTCBtYXkgY29udGFpbiBkaWFsb2cvc3VicGFnZSBwYXJhbXMgaW4gaXQuCgkJCWFic1VybCA9IHBhdGgubWFrZVVybEFic29sdXRlKCB1cmwsIGZpbmRCYXNlV2l0aERlZmF1bHQoKSApOwoKCgkJLy8gSWYgdGhlIGNhbGxlciBwcm92aWRlZCBkYXRhLCBhbmQgd2UncmUgdXNpbmcgImdldCIgcmVxdWVzdCwKCQkvLyBhcHBlbmQgdGhlIGRhdGEgdG8gdGhlIFVSTC4KCQlpZiAoIHNldHRpbmdzLmRhdGEgJiYgc2V0dGluZ3MudHlwZSA9PT0gImdldCIgKSB7CgkJCWFic1VybCA9IHBhdGguYWRkU2VhcmNoUGFyYW1zKCBhYnNVcmwsIHNldHRpbmdzLmRhdGEgKTsKCQkJc2V0dGluZ3MuZGF0YSA9IHVuZGVmaW5lZDsKCQl9CgoJCS8vIElmIHRoZSBjYWxsZXIgaXMgdXNpbmcgYSAicG9zdCIgcmVxdWVzdCwgcmVsb2FkUGFnZSBtdXN0IGJlIHRydWUKCQlpZiAoIHNldHRpbmdzLmRhdGEgJiYgc2V0dGluZ3MudHlwZSA9PT0gInBvc3QiICkgewoJCQlzZXR0aW5ncy5yZWxvYWRQYWdlID0gdHJ1ZTsKCQl9CgoJCS8vIFRoZSBhYnNvbHV0ZSB2ZXJzaW9uIG9mIHRoZSBVUkwgbWludXMgYW55IGRpYWxvZy9zdWJwYWdlIHBhcmFtcy4KCQkvLyBJbiBvdGhlcndvcmRzIHRoZSByZWFsIFVSTCBvZiB0aGUgcGFnZSB0byBiZSBsb2FkZWQuCgkJdmFyIGZpbGVVcmwgPSBwYXRoLmdldEZpbGVQYXRoKCBhYnNVcmwgKSwKCgkJCS8vIFRoZSB2ZXJzaW9uIG9mIHRoZSBVcmwgYWN0dWFsbHkgc3RvcmVkIGluIHRoZSBkYXRhLXVybCBhdHRyaWJ1dGUgb2YKCQkJLy8gdGhlIHBhZ2UuIEZvciBlbWJlZGRlZCBwYWdlcywgaXQgaXMganVzdCB0aGUgaWQgb2YgdGhlIHBhZ2UuIEZvciBwYWdlcwoJCQkvLyB3aXRoaW4gdGhlIHNhbWUgZG9tYWluIGFzIHRoZSBkb2N1bWVudCBiYXNlLCBpdCBpcyB0aGUgc2l0ZSByZWxhdGl2ZQoJCQkvLyBwYXRoLiBGb3IgY3Jvc3MtZG9tYWluIHBhZ2VzIChQaG9uZSBHYXAgb25seSkgdGhlIGVudGlyZSBhYnNvbHV0ZSBVcmwKCQkJLy8gdXNlZCB0byBsb2FkIHRoZSBwYWdlLgoJCQlkYXRhVXJsID0gcGF0aC5jb252ZXJ0VXJsVG9EYXRhVXJsKCBhYnNVcmwgKTsKCgkJLy8gTWFrZSBzdXJlIHdlIGhhdmUgYSBwYWdlQ29udGFpbmVyIHRvIHdvcmsgd2l0aC4KCQlzZXR0aW5ncy5wYWdlQ29udGFpbmVyID0gc2V0dGluZ3MucGFnZUNvbnRhaW5lciB8fCAkLm1vYmlsZS5wYWdlQ29udGFpbmVyOwoKCQkvLyBDaGVjayB0byBzZWUgaWYgdGhlIHBhZ2UgYWxyZWFkeSBleGlzdHMgaW4gdGhlIERPTS4KCQkvLyBOT1RFIGRvIF9ub3RfIHVzZSB0aGUgOmpxbURhdGEgcHN1ZWRvIHNlbGVjdG9yIGJlY2F1c2UgcGFyZW50aGVzaXMKCQkvLyAgICAgIGFyZSBhIHZhbGlkIHVybCBjaGFyIGFuZCBpdCBicmVha3Mgb24gdGhlIGZpcnN0IG9jY3VyZW5jZQoJCXBhZ2UgPSBzZXR0aW5ncy5wYWdlQ29udGFpbmVyLmNoaWxkcmVuKCAiW2RhdGEtIiArICQubW9iaWxlLm5zICsidXJsPSciICsgZGF0YVVybCArICInXSIgKTsKCgkJLy8gSWYgd2UgZmFpbGVkIHRvIGZpbmQgdGhlIHBhZ2UsIGNoZWNrIHRvIHNlZSBpZiB0aGUgdXJsIGlzIGEKCQkvLyByZWZlcmVuY2UgdG8gYW4gZW1iZWRkZWQgcGFnZS4gSWYgc28sIGl0IG1heSBoYXZlIGJlZW4gZHluYW1pY2FsbHkKCQkvLyBpbmplY3RlZCBieSBhIGRldmVsb3BlciwgaW4gd2hpY2ggY2FzZSBpdCB3b3VsZCBiZSBsYWNraW5nIGEgZGF0YS11cmwKCQkvLyBhdHRyaWJ1dGUgYW5kIGluIG5lZWQgb2YgZW5oYW5jZW1lbnQuCgkJaWYgKCBwYWdlLmxlbmd0aCA9PT0gMCAmJiBkYXRhVXJsICYmICFwYXRoLmlzUGF0aCggZGF0YVVybCApICkgewoJCQlwYWdlID0gc2V0dGluZ3MucGFnZUNvbnRhaW5lci5jaGlsZHJlbiggIiMiICsgZGF0YVVybCApCgkJCQkuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgInVybCIsIGRhdGFVcmwgKQoJCQkJLmpxbURhdGEoICJ1cmwiLCBkYXRhVXJsICk7CgkJfQoKCQkvLyBJZiB3ZSBmYWlsZWQgdG8gZmluZCBhIHBhZ2UgaW4gdGhlIERPTSwgY2hlY2sgdGhlIFVSTCB0byBzZWUgaWYgaXQKCQkvLyByZWZlcnMgdG8gdGhlIGZpcnN0IHBhZ2UgaW4gdGhlIGFwcGxpY2F0aW9uLiBJZiBpdCBpc24ndCBhIHJlZmVyZW5jZQoJCS8vIHRvIHRoZSBmaXJzdCBwYWdlIGFuZCByZWZlcnMgdG8gbm9uLWV4aXN0ZW50IGVtYmVkZGVkIHBhZ2UsIGVycm9yIG91dC4KCQlpZiAoIHBhZ2UubGVuZ3RoID09PSAwICkgewoJCQlpZiAoICQubW9iaWxlLmZpcnN0UGFnZSAmJiBwYXRoLmlzRmlyc3RQYWdlVXJsKCBmaWxlVXJsICkgKSB7CgkJCQkvLyBDaGVjayB0byBtYWtlIHN1cmUgb3VyIGNhY2hlZC1maXJzdC1wYWdlIGlzIGFjdHVhbGx5CgkJCQkvLyBpbiB0aGUgRE9NLiBTb21lIHVzZXIgZGVwbG95ZWQgYXBwcyBhcmUgcHJ1bmluZyB0aGUgZmlyc3QKCQkJCS8vIHBhZ2UgZnJvbSB0aGUgRE9NIGZvciB2YXJpb3VzIHJlYXNvbnMsIHdlIGNoZWNrIGZvciB0aGlzCgkJCQkvLyBjYXNlIGhlcmUgYmVjYXVzZSB3ZSBkb24ndCB3YW50IGEgZmlyc3QtcGFnZSB3aXRoIGFuIGlkCgkJCQkvLyBmYWxsaW5nIHRocm91Z2ggdG8gdGhlIG5vbi1leGlzdGVudCBlbWJlZGRlZCBwYWdlIGVycm9yCgkJCQkvLyBjYXNlLiBJZiB0aGUgZmlyc3QtcGFnZSBpcyBub3QgaW4gdGhlIERPTSwgdGhlbiB3ZSBsZXQKCQkJCS8vIHRoaW5ncyBmYWxsIHRocm91Z2ggdG8gdGhlIGFqYXggbG9hZGluZyBjb2RlIGJlbG93IHNvCgkJCQkvLyB0aGF0IGl0IGdldHMgcmVsb2FkZWQuCgkJCQlpZiAoICQubW9iaWxlLmZpcnN0UGFnZS5wYXJlbnQoKS5sZW5ndGggKSB7CgkJCQkJcGFnZSA9ICQoICQubW9iaWxlLmZpcnN0UGFnZSApOwoJCQkJfQoJCQl9IGVsc2UgaWYgKCBwYXRoLmlzRW1iZWRkZWRQYWdlKCBmaWxlVXJsICkgICkgewoJCQkJZGVmZXJyZWQucmVqZWN0KCBhYnNVcmwsIG9wdGlvbnMgKTsKCQkJCXJldHVybiBkZWZlcnJlZC5wcm9taXNlKCk7CgkJCX0KCQl9CgoJCS8vIElmIHRoZSBwYWdlIHdlIGFyZSBpbnRlcmVzdGVkIGluIGlzIGFscmVhZHkgaW4gdGhlIERPTSwKCQkvLyBhbmQgdGhlIGNhbGxlciBkaWQgbm90IGluZGljYXRlIHRoYXQgd2Ugc2hvdWxkIGZvcmNlIGEKCQkvLyByZWxvYWQgb2YgdGhlIGZpbGUsIHdlIGFyZSBkb25lLiBPdGhlcndpc2UsIHRyYWNrIHRoZQoJCS8vIGV4aXN0aW5nIHBhZ2UgYXMgYSBkdXBsaWNhdGVkLgoJCWlmICggcGFnZS5sZW5ndGggKSB7CgkJCWlmICggIXNldHRpbmdzLnJlbG9hZFBhZ2UgKSB7CgkJCQllbmhhbmNlUGFnZSggcGFnZSwgc2V0dGluZ3Mucm9sZSApOwoJCQkJZGVmZXJyZWQucmVzb2x2ZSggYWJzVXJsLCBvcHRpb25zLCBwYWdlICk7CgkJCQlyZXR1cm4gZGVmZXJyZWQucHJvbWlzZSgpOwoJCQl9CgkJCWR1cENhY2hlZFBhZ2UgPSBwYWdlOwoJCX0KCgkJdmFyIG1wYyA9IHNldHRpbmdzLnBhZ2VDb250YWluZXIsCgkJCXBibEV2ZW50ID0gbmV3ICQuRXZlbnQoICJwYWdlYmVmb3JlbG9hZCIgKSwKCQkJdHJpZ2dlckRhdGEgPSB7IHVybDogdXJsLCBhYnNVcmw6IGFic1VybCwgZGF0YVVybDogZGF0YVVybCwgZGVmZXJyZWQ6IGRlZmVycmVkLCBvcHRpb25zOiBzZXR0aW5ncyB9OwoKCQkvLyBMZXQgbGlzdGVuZXJzIGtub3cgd2UncmUgYWJvdXQgdG8gbG9hZCBhIHBhZ2UuCgkJbXBjLnRyaWdnZXIoIHBibEV2ZW50LCB0cmlnZ2VyRGF0YSApOwoKCQkvLyBJZiB0aGUgZGVmYXVsdCBiZWhhdmlvciBpcyBwcmV2ZW50ZWQsIHN0b3AgaGVyZSEKCQlpZiAoIHBibEV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoJCQlyZXR1cm4gZGVmZXJyZWQucHJvbWlzZSgpOwoJCX0KCgkJaWYgKCBzZXR0aW5ncy5zaG93TG9hZE1zZyApIHsKCgkJCS8vIFRoaXMgY29uZmlndXJhYmxlIHRpbWVvdXQgYWxsb3dzIGNhY2hlZCBwYWdlcyBhIGJyaWVmIGRlbGF5IHRvIGxvYWQgd2l0aG91dCBzaG93aW5nIGEgbWVzc2FnZQoJCQl2YXIgbG9hZE1zZ0RlbGF5ID0gc2V0VGltZW91dChmdW5jdGlvbigpIHsKCQkJCQkkLm1vYmlsZS5zaG93UGFnZUxvYWRpbmdNc2coKTsKCQkJCX0sIHNldHRpbmdzLmxvYWRNc2dEZWxheSApLAoKCQkJCS8vIFNoYXJlZCBsb2dpYyBmb3IgY2xlYXJpbmcgdGltZW91dCBhbmQgcmVtb3ZpbmcgbWVzc2FnZS4KCQkJCWhpZGVNc2cgPSBmdW5jdGlvbigpIHsKCgkJCQkJLy8gU3RvcCBtZXNzYWdlIHNob3cgdGltZXIKCQkJCQljbGVhclRpbWVvdXQoIGxvYWRNc2dEZWxheSApOwoKCQkJCQkvLyBIaWRlIGxvYWRpbmcgbWVzc2FnZQoJCQkJCSQubW9iaWxlLmhpZGVQYWdlTG9hZGluZ01zZygpOwoJCQkJfTsKCQl9CgoJCS8vIFJlc2V0IGJhc2UgdG8gdGhlIGRlZmF1bHQgZG9jdW1lbnQgYmFzZS4KCQlpZiAoIGJhc2UgKSB7CgkJCWJhc2UucmVzZXQoKTsKCQl9CgoJCWlmICggISggJC5tb2JpbGUuYWxsb3dDcm9zc0RvbWFpblBhZ2VzIHx8IHBhdGguaXNTYW1lRG9tYWluKCBkb2N1bWVudFVybCwgYWJzVXJsICkgKSApIHsKCQkJZGVmZXJyZWQucmVqZWN0KCBhYnNVcmwsIG9wdGlvbnMgKTsKCQl9IGVsc2UgewoJCQkvLyBMb2FkIHRoZSBuZXcgcGFnZS4KCQkJJC5hamF4KHsKCQkJCXVybDogZmlsZVVybCwKCQkJCXR5cGU6IHNldHRpbmdzLnR5cGUsCgkJCQlkYXRhOiBzZXR0aW5ncy5kYXRhLAoJCQkJZGF0YVR5cGU6ICJodG1sIiwKCQkJCXN1Y2Nlc3M6IGZ1bmN0aW9uKCBodG1sLCB0ZXh0U3RhdHVzLCB4aHIgKSB7CgkJCQkJLy9wcmUtcGFyc2UgaHRtbCB0byBjaGVjayBmb3IgYSBkYXRhLXVybCwKCQkJCQkvL3VzZSBpdCBhcyB0aGUgbmV3IGZpbGVVcmwsIGJhc2UgcGF0aCwgZXRjCgkJCQkJdmFyIGFsbCA9ICQoICI8ZGl2PjwvZGl2PiIgKSwKCgkJCQkJCS8vcGFnZSB0aXRsZSByZWdleHAKCQkJCQkJbmV3UGFnZVRpdGxlID0gaHRtbC5tYXRjaCggLzx0aXRsZVtePl0qPihbXjxdKikvICkgJiYgUmVnRXhwLiQxLAoKCQkJCQkJLy8gVE9ETyBoYW5kbGUgZGlhbG9ncyBhZ2FpbgoJCQkJCQlwYWdlRWxlbVJlZ2V4ID0gbmV3IFJlZ0V4cCggIig8W14+XStcXGJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyb2xlPVtcIiddP3BhZ2VbXCInXT9bXj5dKj4pIiApLAoJCQkJCQlkYXRhVXJsUmVnZXggPSBuZXcgUmVnRXhwKCAiXFxiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidXJsPVtcIiddPyhbXlwiJz5dKilbXCInXT8iICk7CgoKCQkJCQkvLyBkYXRhLXVybCBtdXN0IGJlIHByb3ZpZGVkIGZvciB0aGUgYmFzZSB0YWcgc28gcmVzb3VyY2UgcmVxdWVzdHMgY2FuIGJlIGRpcmVjdGVkIHRvIHRoZQoJCQkJCS8vIGNvcnJlY3QgdXJsLiBsb2FkaW5nIGludG8gYSB0ZW1wcm9yYXJ5IGVsZW1lbnQgbWFrZXMgdGhlc2UgcmVxdWVzdHMgaW1tZWRpYXRlbHkKCQkJCQlpZiAoIHBhZ2VFbGVtUmVnZXgudGVzdCggaHRtbCApICYmCgkJCQkJCQlSZWdFeHAuJDEgJiYKCQkJCQkJCWRhdGFVcmxSZWdleC50ZXN0KCBSZWdFeHAuJDEgKSAmJgoJCQkJCQkJUmVnRXhwLiQxICkgewoJCQkJCQl1cmwgPSBmaWxlVXJsID0gcGF0aC5nZXRGaWxlUGF0aCggJCggIjxkaXY+IiArIFJlZ0V4cC4kMSArICI8L2Rpdj4iICkudGV4dCgpICk7CgkJCQkJfQoKCQkJCQlpZiAoIGJhc2UgKSB7CgkJCQkJCWJhc2Uuc2V0KCBmaWxlVXJsICk7CgkJCQkJfQoKCQkJCQkvL3dvcmthcm91bmQgdG8gYWxsb3cgc2NyaXB0cyB0byBleGVjdXRlIHdoZW4gaW5jbHVkZWQgaW4gcGFnZSBkaXZzCgkJCQkJYWxsLmdldCggMCApLmlubmVySFRNTCA9IGh0bWw7CgkJCQkJcGFnZSA9IGFsbC5maW5kKCAiOmpxbURhdGEocm9sZT0ncGFnZScpLCA6anFtRGF0YShyb2xlPSdkaWFsb2cnKSIgKS5maXJzdCgpOwoKCQkJCQkvL2lmIHBhZ2UgZWxlbSBjb3VsZG4ndCBiZSBmb3VuZCwgY3JlYXRlIG9uZSBhbmQgaW5zZXJ0IHRoZSBib2R5IGVsZW1lbnQncyBjb250ZW50cwoJCQkJCWlmICggIXBhZ2UubGVuZ3RoICkgewoJCQkJCQlwYWdlID0gJCggIjxkaXYgZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicm9sZT0ncGFnZSc+IiArIGh0bWwuc3BsaXQoIC88XC8/Ym9keVtePl0qPi9nbWkgKVsxXSArICI8L2Rpdj4iICk7CgkJCQkJfQoKCQkJCQlpZiAoIG5ld1BhZ2VUaXRsZSAmJiAhcGFnZS5qcW1EYXRhKCAidGl0bGUiICkgKSB7CgkJCQkJCWlmICggfm5ld1BhZ2VUaXRsZS5pbmRleE9mKCAiJiIgKSApIHsKCQkJCQkJCW5ld1BhZ2VUaXRsZSA9ICQoICI8ZGl2PiIgKyBuZXdQYWdlVGl0bGUgKyAiPC9kaXY+IiApLnRleHQoKTsKCQkJCQkJfQoJCQkJCQlwYWdlLmpxbURhdGEoICJ0aXRsZSIsIG5ld1BhZ2VUaXRsZSApOwoJCQkJCX0KCgkJCQkJLy9yZXdyaXRlIHNyYyBhbmQgaHJlZiBhdHRycyB0byB1c2UgYSBiYXNlIHVybAoJCQkJCWlmICggISQuc3VwcG9ydC5keW5hbWljQmFzZVRhZyApIHsKCQkJCQkJdmFyIG5ld1BhdGggPSBwYXRoLmdldCggZmlsZVVybCApOwoJCQkJCQlwYWdlLmZpbmQoICJbc3JjXSwgbGlua1tocmVmXSwgYVtyZWw9J2V4dGVybmFsJ10sIDpqcW1EYXRhKGFqYXg9J2ZhbHNlJyksIGFbdGFyZ2V0XSIgKS5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJCQkJdmFyIHRoaXNBdHRyID0gJCggdGhpcyApLmlzKCAnW2hyZWZdJyApID8gJ2hyZWYnIDoKCQkJCQkJCQkJJCggdGhpcyApLmlzKCAnW3NyY10nICkgPyAnc3JjJyA6ICdhY3Rpb24nLAoJCQkJCQkJCXRoaXNVcmwgPSAkKCB0aGlzICkuYXR0ciggdGhpc0F0dHIgKTsKCgkJCQkJCQkvLyBYWFhfamJsYXM6IFdlIG5lZWQgdG8gZml4IHRoaXMgc28gdGhhdCBpdCByZW1vdmVzIHRoZSBkb2N1bWVudAoJCQkJCQkJLy8gICAgICAgICAgICBiYXNlIFVSTCwgYW5kIHRoZW4gcHJlcGVuZHMgd2l0aCB0aGUgbmV3IHBhZ2UgVVJMLgoJCQkJCQkJLy9pZiBmdWxsIHBhdGggZXhpc3RzIGFuZCBpcyBzYW1lLCBjaG9wIGl0IC0gaGVscHMgSUUgb3V0CgkJCQkJCQl0aGlzVXJsID0gdGhpc1VybC5yZXBsYWNlKCBsb2NhdGlvbi5wcm90b2NvbCArICcvLycgKyBsb2NhdGlvbi5ob3N0ICsgbG9jYXRpb24ucGF0aG5hbWUsICcnICk7CgoJCQkJCQkJaWYgKCAhL14oXHcrOnwjfFwvKS8udGVzdCggdGhpc1VybCApICkgewoJCQkJCQkJCSQoIHRoaXMgKS5hdHRyKCB0aGlzQXR0ciwgbmV3UGF0aCArIHRoaXNVcmwgKTsKCQkJCQkJCX0KCQkJCQkJfSk7CgkJCQkJfQoKCQkJCQkvL2FwcGVuZCB0byBwYWdlIGFuZCBlbmhhbmNlCgkJCQkJLy8gVE9ETyB0YWdpbmcgYSBwYWdlIHdpdGggZXh0ZXJuYWwgdG8gbWFrZSBzdXJlIHRoYXQgZW1iZWRkZWQgcGFnZXMgYXJlbid0IHJlbW92ZWQKCQkJCQkvLyAgICAgIGJ5IHRoZSB2YXJpb3VzIHBhZ2UgaGFuZGxpbmcgY29kZSBpcyBiYWQuIEhhdmluZyBwYWdlIGhhbmRsaW5nIGNvZGUgaW4gbWFueQoJCQkJCS8vICAgICAgcGxhY2VzIGlzIGJhZC4gU29sdXRpb25zIHBvc3QgMS4wCgkJCQkJcGFnZQoJCQkJCQkuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgInVybCIsIHBhdGguY29udmVydFVybFRvRGF0YVVybCggZmlsZVVybCApICkKCQkJCQkJLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJleHRlcm5hbC1wYWdlIiwgdHJ1ZSApCgkJCQkJCS5hcHBlbmRUbyggc2V0dGluZ3MucGFnZUNvbnRhaW5lciApOwoKCQkJCQkvLyB3YWl0IGZvciBwYWdlIGNyZWF0aW9uIHRvIGxldmVyYWdlIG9wdGlvbnMgZGVmaW5lZCBvbiB3aWRnZXQKCQkJCQlwYWdlLm9uZSggJ3BhZ2VjcmVhdGUnLCAkLm1vYmlsZS5fYmluZFBhZ2VSZW1vdmUgKTsKCgkJCQkJZW5oYW5jZVBhZ2UoIHBhZ2UsIHNldHRpbmdzLnJvbGUgKTsKCgkJCQkJLy8gRW5oYW5jaW5nIHRoZSBwYWdlIG1heSByZXN1bHQgaW4gbmV3IGRpYWxvZ3Mvc3ViIHBhZ2VzIGJlaW5nIGluc2VydGVkCgkJCQkJLy8gaW50byB0aGUgRE9NLiBJZiB0aGUgb3JpZ2luYWwgYWJzVXJsIHJlZmVycyB0byBhIHN1Yi1wYWdlLCB0aGF0IGlzIHRoZQoJCQkJCS8vIHJlYWwgcGFnZSB3ZSBhcmUgaW50ZXJlc3RlZCBpbi4KCQkJCQlpZiAoIGFic1VybC5pbmRleE9mKCAiJiIgKyAkLm1vYmlsZS5zdWJQYWdlVXJsS2V5ICkgPiAtMSApIHsKCQkJCQkJcGFnZSA9IHNldHRpbmdzLnBhZ2VDb250YWluZXIuY2hpbGRyZW4oICJbZGF0YS0iICsgJC5tb2JpbGUubnMgKyJ1cmw9JyIgKyBkYXRhVXJsICsgIiddIiApOwoJCQkJCX0KCgkJCQkJLy9iaW5kIHBhZ2VIaWRlIHRvIHJlbW92ZVBhZ2UgYWZ0ZXIgaXQncyBoaWRkZW4sIGlmIHRoZSBwYWdlIG9wdGlvbnMgc3BlY2lmeSB0byBkbyBzbwoKCQkJCQkvLyBSZW1vdmUgbG9hZGluZyBtZXNzYWdlLgoJCQkJCWlmICggc2V0dGluZ3Muc2hvd0xvYWRNc2cgKSB7CgkJCQkJCWhpZGVNc2coKTsKCQkJCQl9CgoJCQkJCS8vIEFkZCB0aGUgcGFnZSByZWZlcmVuY2UgYW5kIHhociB0byBvdXIgdHJpZ2dlckRhdGEuCgkJCQkJdHJpZ2dlckRhdGEueGhyID0geGhyOwoJCQkJCXRyaWdnZXJEYXRhLnRleHRTdGF0dXMgPSB0ZXh0U3RhdHVzOwoJCQkJCXRyaWdnZXJEYXRhLnBhZ2UgPSBwYWdlOwoKCQkJCQkvLyBMZXQgbGlzdGVuZXJzIGtub3cgdGhlIHBhZ2UgbG9hZGVkIHN1Y2Nlc3NmdWxseS4KCQkJCQlzZXR0aW5ncy5wYWdlQ29udGFpbmVyLnRyaWdnZXIoICJwYWdlbG9hZCIsIHRyaWdnZXJEYXRhICk7CgoJCQkJCWRlZmVycmVkLnJlc29sdmUoIGFic1VybCwgb3B0aW9ucywgcGFnZSwgZHVwQ2FjaGVkUGFnZSApOwoJCQkJfSwKCQkJCWVycm9yOiBmdW5jdGlvbiggeGhyLCB0ZXh0U3RhdHVzLCBlcnJvclRocm93biApIHsKCQkJCQkvL3NldCBiYXNlIGJhY2sgdG8gY3VycmVudCBwYXRoCgkJCQkJaWYgKCBiYXNlICkgewoJCQkJCQliYXNlLnNldCggcGF0aC5nZXQoKSApOwoJCQkJCX0KCgkJCQkJLy8gQWRkIGVycm9yIGluZm8gdG8gb3VyIHRyaWdnZXJEYXRhLgoJCQkJCXRyaWdnZXJEYXRhLnhociA9IHhocjsKCQkJCQl0cmlnZ2VyRGF0YS50ZXh0U3RhdHVzID0gdGV4dFN0YXR1czsKCQkJCQl0cmlnZ2VyRGF0YS5lcnJvclRocm93biA9IGVycm9yVGhyb3duOwoKCQkJCQl2YXIgcGxmRXZlbnQgPSBuZXcgJC5FdmVudCggInBhZ2Vsb2FkZmFpbGVkIiApOwoKCQkJCQkvLyBMZXQgbGlzdGVuZXJzIGtub3cgdGhlIHBhZ2UgbG9hZCBmYWlsZWQuCgkJCQkJc2V0dGluZ3MucGFnZUNvbnRhaW5lci50cmlnZ2VyKCBwbGZFdmVudCwgdHJpZ2dlckRhdGEgKTsKCgkJCQkJLy8gSWYgdGhlIGRlZmF1bHQgYmVoYXZpb3IgaXMgcHJldmVudGVkLCBzdG9wIGhlcmUhCgkJCQkJLy8gTm90ZSB0aGF0IGl0IGlzIHRoZSByZXNwb25zaWJpbGl0eSBvZiB0aGUgbGlzdGVuZXIvaGFuZGxlcgoJCQkJCS8vIHRoYXQgY2FsbGVkIHByZXZlbnREZWZhdWx0KCksIHRvIHJlc29sdmUvcmVqZWN0IHRoZQoJCQkJCS8vIGRlZmVycmVkIG9iamVjdCB3aXRoaW4gdGhlIHRyaWdnZXJEYXRhLgoJCQkJCWlmICggcGxmRXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKSB7CgkJCQkJCXJldHVybjsKCQkJCQl9CgoJCQkJCS8vIFJlbW92ZSBsb2FkaW5nIG1lc3NhZ2UuCgkJCQkJaWYgKCBzZXR0aW5ncy5zaG93TG9hZE1zZyApIHsKCgkJCQkJCS8vIFJlbW92ZSBsb2FkaW5nIG1lc3NhZ2UuCgkJCQkJCWhpZGVNc2coKTsKCgkJCQkJCS8vIHNob3cgZXJyb3IgbWVzc2FnZQoJCQkJCQkkLm1vYmlsZS5zaG93UGFnZUxvYWRpbmdNc2coICQubW9iaWxlLnBhZ2VMb2FkRXJyb3JNZXNzYWdlVGhlbWUsICQubW9iaWxlLnBhZ2VMb2FkRXJyb3JNZXNzYWdlLCB0cnVlICk7CgoJCQkJCQkvLyBoaWRlIGFmdGVyIGRlbGF5CgkJCQkJCXNldFRpbWVvdXQoICQubW9iaWxlLmhpZGVQYWdlTG9hZGluZ01zZywgMTUwMCApOwoJCQkJCX0KCgkJCQkJZGVmZXJyZWQucmVqZWN0KCBhYnNVcmwsIG9wdGlvbnMgKTsKCQkJCX0KCQkJfSk7CgkJfQoKCQlyZXR1cm4gZGVmZXJyZWQucHJvbWlzZSgpOwoJfTsKCgkkLm1vYmlsZS5sb2FkUGFnZS5kZWZhdWx0cyA9IHsKCQl0eXBlOiAiZ2V0IiwKCQlkYXRhOiB1bmRlZmluZWQsCgkJcmVsb2FkUGFnZTogZmFsc2UsCgkJcm9sZTogdW5kZWZpbmVkLCAvLyBCeSBkZWZhdWx0IHdlIHJlbHkgb24gdGhlIHJvbGUgZGVmaW5lZCBieSB0aGUgQGRhdGEtcm9sZSBhdHRyaWJ1dGUuCgkJc2hvd0xvYWRNc2c6IGZhbHNlLAoJCXBhZ2VDb250YWluZXI6IHVuZGVmaW5lZCwKCQlsb2FkTXNnRGVsYXk6IDUwIC8vIFRoaXMgZGVsYXkgYWxsb3dzIGxvYWRzIHRoYXQgcHVsbCBmcm9tIGJyb3dzZXIgY2FjaGUgdG8gb2NjdXIgd2l0aG91dCBzaG93aW5nIHRoZSBsb2FkaW5nIG1lc3NhZ2UuCgl9OwoKCS8vIFNob3cgYSBzcGVjaWZpYyBwYWdlIGluIHRoZSBwYWdlIGNvbnRhaW5lci4KCSQubW9iaWxlLmNoYW5nZVBhZ2UgPSBmdW5jdGlvbiggdG9QYWdlLCBvcHRpb25zICkgewoJCS8vIElmIHdlIGFyZSBpbiB0aGUgbWlkc3Qgb2YgYSB0cmFuc2l0aW9uLCBxdWV1ZSB0aGUgY3VycmVudCByZXF1ZXN0LgoJCS8vIFdlJ2xsIGNhbGwgY2hhbmdlUGFnZSgpIG9uY2Ugd2UncmUgZG9uZSB3aXRoIHRoZSBjdXJyZW50IHRyYW5zaXRpb24gdG8KCQkvLyBzZXJ2aWNlIHRoZSByZXF1ZXN0LgoJCWlmICggaXNQYWdlVHJhbnNpdGlvbmluZyApIHsKCQkJcGFnZVRyYW5zaXRpb25RdWV1ZS51bnNoaWZ0KCBhcmd1bWVudHMgKTsKCQkJcmV0dXJuOwoJCX0KCgkJdmFyIHNldHRpbmdzID0gJC5leHRlbmQoIHt9LCAkLm1vYmlsZS5jaGFuZ2VQYWdlLmRlZmF1bHRzLCBvcHRpb25zICk7CgoJCS8vIE1ha2Ugc3VyZSB3ZSBoYXZlIGEgcGFnZUNvbnRhaW5lciB0byB3b3JrIHdpdGguCgkJc2V0dGluZ3MucGFnZUNvbnRhaW5lciA9IHNldHRpbmdzLnBhZ2VDb250YWluZXIgfHwgJC5tb2JpbGUucGFnZUNvbnRhaW5lcjsKCgkJLy8gTWFrZSBzdXJlIHdlIGhhdmUgYSBmcm9tUGFnZS4KCQlzZXR0aW5ncy5mcm9tUGFnZSA9IHNldHRpbmdzLmZyb21QYWdlIHx8ICQubW9iaWxlLmFjdGl2ZVBhZ2U7CgoJCXZhciBtcGMgPSBzZXR0aW5ncy5wYWdlQ29udGFpbmVyLAoJCQlwYmNFdmVudCA9IG5ldyAkLkV2ZW50KCAicGFnZWJlZm9yZWNoYW5nZSIgKSwKCQkJdHJpZ2dlckRhdGEgPSB7IHRvUGFnZTogdG9QYWdlLCBvcHRpb25zOiBzZXR0aW5ncyB9OwoKCQkvLyBMZXQgbGlzdGVuZXJzIGtub3cgd2UncmUgYWJvdXQgdG8gY2hhbmdlIHRoZSBjdXJyZW50IHBhZ2UuCgkJbXBjLnRyaWdnZXIoIHBiY0V2ZW50LCB0cmlnZ2VyRGF0YSApOwoKCQkvLyBJZiB0aGUgZGVmYXVsdCBiZWhhdmlvciBpcyBwcmV2ZW50ZWQsIHN0b3AgaGVyZSEKCQlpZiAoIHBiY0V2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoJCQlyZXR1cm47CgkJfQoKCQkvLyBXZSBhbGxvdyAicGFnZWJlZm9yZWNoYW5nZSIgb2JzZXJ2ZXJzIHRvIG1vZGlmeSB0aGUgdG9QYWdlIGluIHRoZSB0cmlnZ2VyCgkJLy8gZGF0YSB0byBhbGxvdyBmb3IgcmVkaXJlY3RzLiBNYWtlIHN1cmUgb3VyIHRvUGFnZSBpcyB1cGRhdGVkLgoKCQl0b1BhZ2UgPSB0cmlnZ2VyRGF0YS50b1BhZ2U7CgoJCS8vIFNldCB0aGUgaXNQYWdlVHJhbnNpdGlvbmluZyBmbGFnIHRvIHByZXZlbnQgYW55IHJlcXVlc3RzIGZyb20KCQkvLyBlbnRlcmluZyB0aGlzIG1ldGhvZCB3aGlsZSB3ZSBhcmUgaW4gdGhlIG1pZHN0IG9mIGxvYWRpbmcgYSBwYWdlCgkJLy8gb3IgdHJhbnNpdGlvbmluZy4KCgkJaXNQYWdlVHJhbnNpdGlvbmluZyA9IHRydWU7CgoJCS8vIElmIHRoZSBjYWxsZXIgcGFzc2VkIHVzIGEgdXJsLCBjYWxsIGxvYWRQYWdlKCkKCQkvLyB0byBtYWtlIHN1cmUgaXQgaXMgbG9hZGVkIGludG8gdGhlIERPTS4gV2UnbGwgbGlzdGVuCgkJLy8gdG8gdGhlIHByb21pc2Ugb2JqZWN0IGl0IHJldHVybnMgc28gd2Uga25vdyB3aGVuCgkJLy8gaXQgaXMgZG9uZSBsb2FkaW5nIG9yIGlmIGFuIGVycm9yIG9jdXJyZWQuCgkJaWYgKCB0eXBlb2YgdG9QYWdlID09PSAic3RyaW5nIiApIHsKCQkJJC5tb2JpbGUubG9hZFBhZ2UoIHRvUGFnZSwgc2V0dGluZ3MgKQoJCQkJLmRvbmUoZnVuY3Rpb24oIHVybCwgb3B0aW9ucywgbmV3UGFnZSwgZHVwQ2FjaGVkUGFnZSApIHsKCQkJCQlpc1BhZ2VUcmFuc2l0aW9uaW5nID0gZmFsc2U7CgkJCQkJb3B0aW9ucy5kdXBsaWNhdGVDYWNoZWRQYWdlID0gZHVwQ2FjaGVkUGFnZTsKCQkJCQkkLm1vYmlsZS5jaGFuZ2VQYWdlKCBuZXdQYWdlLCBvcHRpb25zICk7CgkJCQl9KQoJCQkJLmZhaWwoZnVuY3Rpb24oIHVybCwgb3B0aW9ucyApIHsKCQkJCQlpc1BhZ2VUcmFuc2l0aW9uaW5nID0gZmFsc2U7CgoJCQkJCS8vY2xlYXIgb3V0IHRoZSBhY3RpdmUgYnV0dG9uIHN0YXRlCgkJCQkJcmVtb3ZlQWN0aXZlTGlua0NsYXNzKCB0cnVlICk7CgoJCQkJCS8vcmVsZWFzZSB0cmFuc2l0aW9uIGxvY2sgc28gbmF2aWdhdGlvbiBpcyBmcmVlIGFnYWluCgkJCQkJcmVsZWFzZVBhZ2VUcmFuc2l0aW9uTG9jaygpOwoJCQkJCXNldHRpbmdzLnBhZ2VDb250YWluZXIudHJpZ2dlciggInBhZ2VjaGFuZ2VmYWlsZWQiLCB0cmlnZ2VyRGF0YSApOwoJCQkJfSk7CgkJCXJldHVybjsKCQl9CgoJCS8vIElmIHdlIGFyZSBnb2luZyB0byB0aGUgZmlyc3QtcGFnZSBvZiB0aGUgYXBwbGljYXRpb24sIHdlIG5lZWQgdG8gbWFrZQoJCS8vIHN1cmUgc2V0dGluZ3MuZGF0YVVybCBpcyBzZXQgdG8gdGhlIGFwcGxpY2F0aW9uIGRvY3VtZW50IHVybC4gVGhpcyBhbGxvd3MKCQkvLyB1cyB0byBhdm9pZCBnZW5lcmF0aW5nIGEgZG9jdW1lbnQgdXJsIHdpdGggYW4gaWQgaGFzaCBpbiB0aGUgY2FzZSB3aGVyZSB0aGUKCQkvLyBmaXJzdC1wYWdlIG9mIHRoZSBkb2N1bWVudCBoYXMgYW4gaWQgYXR0cmlidXRlIHNwZWNpZmllZC4KCQlpZiAoIHRvUGFnZVsgMCBdID09PSAkLm1vYmlsZS5maXJzdFBhZ2VbIDAgXSAmJiAhc2V0dGluZ3MuZGF0YVVybCApIHsKCQkJc2V0dGluZ3MuZGF0YVVybCA9IGRvY3VtZW50VXJsLmhyZWZOb0hhc2g7CgkJfQoKCQkvLyBUaGUgY2FsbGVyIHBhc3NlZCB1cyBhIHJlYWwgcGFnZSBET00gZWxlbWVudC4gVXBkYXRlIG91cgoJCS8vIGludGVybmFsIHN0YXRlIGFuZCB0aGVuIHRyaWdnZXIgYSB0cmFuc2l0aW9uIHRvIHRoZSBwYWdlLgoJCXZhciBmcm9tUGFnZSA9IHNldHRpbmdzLmZyb21QYWdlLAoJCQl1cmwgPSAoIHNldHRpbmdzLmRhdGFVcmwgJiYgcGF0aC5jb252ZXJ0VXJsVG9EYXRhVXJsKCBzZXR0aW5ncy5kYXRhVXJsICkgKSB8fCB0b1BhZ2UuanFtRGF0YSggInVybCIgKSwKCQkJLy8gVGhlIHBhZ2VVcmwgdmFyIGlzIHVzdWFsbHkgdGhlIHNhbWUgYXMgdXJsLCBleGNlcHQgd2hlbiB1cmwgaXMgb2JzY3VyZWQgYXMgYSBkaWFsb2cgdXJsLiBwYWdlVXJsIGFsd2F5cyBjb250YWlucyB0aGUgZmlsZSBwYXRoCgkJCXBhZ2VVcmwgPSB1cmwsCgkJCWZpbGVVcmwgPSBwYXRoLmdldEZpbGVQYXRoKCB1cmwgKSwKCQkJYWN0aXZlID0gdXJsSGlzdG9yeS5nZXRBY3RpdmUoKSwKCQkJYWN0aXZlSXNJbml0aWFsUGFnZSA9IHVybEhpc3RvcnkuYWN0aXZlSW5kZXggPT09IDAsCgkJCWhpc3RvcnlEaXIgPSAwLAoJCQlwYWdlVGl0bGUgPSBkb2N1bWVudC50aXRsZSwKCQkJaXNEaWFsb2cgPSBzZXR0aW5ncy5yb2xlID09PSAiZGlhbG9nIiB8fCB0b1BhZ2UuanFtRGF0YSggInJvbGUiICkgPT09ICJkaWFsb2ciOwoKCQkvLyBCeSBkZWZhdWx0LCB3ZSBwcmV2ZW50IGNoYW5nZVBhZ2UgcmVxdWVzdHMgd2hlbiB0aGUgZnJvbVBhZ2UgYW5kIHRvUGFnZQoJCS8vIGFyZSB0aGUgc2FtZSBlbGVtZW50LCBidXQgZm9sa3MgdGhhdCBnZW5lcmF0ZSBjb250ZW50IG1hbnVhbGx5L2R5bmFtaWNhbGx5CgkJLy8gYW5kIHJldXNlIHBhZ2VzIHdhbnQgdG8gYmUgYWJsZSB0byB0cmFuc2l0aW9uIHRvIHRoZSBzYW1lIHBhZ2UuIFRvIGFsbG93CgkJLy8gdGhpcywgdGhleSB3aWxsIG5lZWQgdG8gY2hhbmdlIHRoZSBkZWZhdWx0IHZhbHVlIG9mIGFsbG93U2FtZVBhZ2VUcmFuc2l0aW9uCgkJLy8gdG8gdHJ1ZSwgKk9SKiwgcGFzcyBpdCBpbiBhcyBhbiBvcHRpb24gd2hlbiB0aGV5IG1hbnVhbGx5IGNhbGwgY2hhbmdlUGFnZSgpLgoJCS8vIEl0IHNob3VsZCBiZSBub3RlZCB0aGF0IG91ciBkZWZhdWx0IHRyYW5zaXRpb24gYW5pbWF0aW9ucyBhc3N1bWUgdGhhdCB0aGUKCQkvLyBmb3JtUGFnZSBhbmQgdG9QYWdlIGFyZSBkaWZmZXJlbnQgZWxlbWVudHMsIHNvIHRoZXkgbWF5IGJlaGF2ZSB1bmV4cGVjdGVkbHkuCgkJLy8gSXQgaXMgdXAgdG8gdGhlIGRldmVsb3BlciB0aGF0IHR1cm5zIG9uIHRoZSBhbGxvd1NhbWVQYWdlVHJhbnNpdGlvbmEgb3B0aW9uCgkJLy8gdG8gZWl0aGVyIHR1cm4gb2ZmIHRyYW5zaXRpb24gYW5pbWF0aW9ucywgb3IgbWFrZSBzdXJlIHRoYXQgYW4gYXBwcm9wcmlhdGUKCQkvLyBhbmltYXRpb24gdHJhbnNpdGlvbiBpcyB1c2VkLgoJCWlmICggZnJvbVBhZ2UgJiYgZnJvbVBhZ2VbMF0gPT09IHRvUGFnZVswXSAmJiAhc2V0dGluZ3MuYWxsb3dTYW1lUGFnZVRyYW5zaXRpb24gKSB7CgkJCWlzUGFnZVRyYW5zaXRpb25pbmcgPSBmYWxzZTsKCQkJbXBjLnRyaWdnZXIoICJwYWdlY2hhbmdlIiwgdHJpZ2dlckRhdGEgKTsKCgkJCS8vIEV2ZW4gaWYgdGhlcmUgaXMgbm8gcGFnZSBjaGFuZ2UgdG8gYmUgZG9uZSwgd2Ugc2hvdWxkIGtlZXAgdGhlIHVybEhpc3RvcnkgaW4gc3luYyB3aXRoIHRoZSBoYXNoIGNoYW5nZXMKCQkJaWYgKCBzZXR0aW5ncy5mcm9tSGFzaENoYW5nZSApIHsKCQkJCXVybEhpc3RvcnkuZGlyZWN0SGFzaENoYW5nZSh7CgkJCQkJY3VycmVudFVybDoJdXJsLAoJCQkJCWlzQmFjazoJCWZ1bmN0aW9uKCkge30sCgkJCQkJaXNGb3J3YXJkOglmdW5jdGlvbigpIHt9CgkJCQl9KTsKCQkJfQoKCQkJcmV0dXJuOwoJCX0KCgkJLy8gV2UgbmVlZCB0byBtYWtlIHN1cmUgdGhlIHBhZ2Ugd2UgYXJlIGdpdmVuIGhhcyBhbHJlYWR5IGJlZW4gZW5oYW5jZWQuCgkJZW5oYW5jZVBhZ2UoIHRvUGFnZSwgc2V0dGluZ3Mucm9sZSApOwoKCQkvLyBJZiB0aGUgY2hhbmdlUGFnZSByZXF1ZXN0IHdhcyBzZW50IGZyb20gYSBoYXNoQ2hhbmdlIGV2ZW50LCBjaGVjayB0byBzZWUgaWYgdGhlCgkJLy8gcGFnZSBpcyBhbHJlYWR5IHdpdGhpbiB0aGUgdXJsSGlzdG9yeSBzdGFjay4gSWYgc28sIHdlJ2xsIGFzc3VtZSB0aGUgdXNlciBoaXQKCQkvLyB0aGUgZm9yd2FyZC9iYWNrIGJ1dHRvbiBhbmQgd2lsbCB0cnkgdG8gbWF0Y2ggdGhlIHRyYW5zaXRpb24gYWNjb3JkaW5nbHkuCgkJaWYgKCBzZXR0aW5ncy5mcm9tSGFzaENoYW5nZSApIHsKCQkJdXJsSGlzdG9yeS5kaXJlY3RIYXNoQ2hhbmdlKHsKCQkJCWN1cnJlbnRVcmw6CXVybCwKCQkJCWlzQmFjazoJCWZ1bmN0aW9uKCkgeyBoaXN0b3J5RGlyID0gLTE7IH0sCgkJCQlpc0ZvcndhcmQ6CWZ1bmN0aW9uKCkgeyBoaXN0b3J5RGlyID0gMTsgfQoJCQl9KTsKCQl9CgoJCS8vIEtpbGwgdGhlIGtleWJvYXJkLgoJCS8vIFhYWF9qYmxhczogV2UgbmVlZCB0byBzdG9wIGNyYXdsaW5nIHRoZSBlbnRpcmUgZG9jdW1lbnQgdG8ga2lsbCBmb2N1cy4gSW5zdGVhZCwKCQkvLyAgICAgICAgICAgIHdlIHNob3VsZCBiZSB0cmFja2luZyBmb2N1cyB3aXRoIGEgZGVsZWdhdGUoKSBoYW5kbGVyIHNvIHdlIGFscmVhZHkgaGF2ZQoJCS8vICAgICAgICAgICAgdGhlIGVsZW1lbnQgaW4gaGFuZCBhdCB0aGlzIHBvaW50LgoJCS8vIFdyYXAgdGhpcyBpbiBhIHRyeS9jYXRjaCBibG9jayBzaW5jZSBJRTkgdGhyb3cgIlVuc3BlY2lmaWVkIGVycm9yIiBpZiBkb2N1bWVudC5hY3RpdmVFbGVtZW50CgkJLy8gaXMgdW5kZWZpbmVkIHdoZW4gd2UgYXJlIGluIGFuIElGcmFtZS4KCQl0cnkgewoJCQlpZiAoIGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQgJiYgZG9jdW1lbnQuYWN0aXZlRWxlbWVudC5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpICE9PSAnYm9keScgKSB7CgkJCQkkKCBkb2N1bWVudC5hY3RpdmVFbGVtZW50ICkuYmx1cigpOwoJCQl9IGVsc2UgewoJCQkJJCggImlucHV0OmZvY3VzLCB0ZXh0YXJlYTpmb2N1cywgc2VsZWN0OmZvY3VzIiApLmJsdXIoKTsKCQkJfQoJCX0gY2F0Y2goIGUgKSB7fQoKCQkvLyBSZWNvcmQgd2hldGhlciB3ZSBhcmUgYXQgYSBwbGFjZSBpbiBoaXN0b3J5IHdoZXJlIGEgZGlhbG9nIHVzZWQgdG8gYmUgLSBpZiBzbywgZG8gbm90IGFkZCBhIG5ldyBoaXN0b3J5IGVudHJ5IGFuZCBkbyBub3QgY2hhbmdlIHRoZSBoYXNoIGVpdGhlcgoJCXZhciBhbHJlYWR5VGhlcmUgPSBmYWxzZTsKCgkJLy8gSWYgd2UncmUgZGlzcGxheWluZyB0aGUgcGFnZSBhcyBhIGRpYWxvZywgd2UgZG9uJ3Qgd2FudCB0aGUgdXJsCgkJLy8gZm9yIHRoZSBkaWFsb2cgY29udGVudCB0byBiZSB1c2VkIGluIHRoZSBoYXNoLiBJbnN0ZWFkLCB3ZSB3YW50CgkJLy8gdG8gYXBwZW5kIHRoZSBkaWFsb2dIYXNoS2V5IHRvIHRoZSB1cmwgb2YgdGhlIGN1cnJlbnQgcGFnZS4KCQlpZiAoIGlzRGlhbG9nICYmIGFjdGl2ZSApIHsKCQkJLy8gb24gdGhlIGluaXRpYWwgcGFnZSBsb2FkIGFjdGl2ZS51cmwgaXMgdW5kZWZpbmVkIGFuZCBpbiB0aGF0IGNhc2Ugc2hvdWxkCgkJCS8vIGJlIGFuIGVtcHR5IHN0cmluZy4gTW92aW5nIHRoZSB1bmRlZmluZWQgLT4gZW1wdHkgc3RyaW5nIGJhY2sgaW50bwoJCQkvLyB1cmxIaXN0b3J5LmFkZE5ldyBzZWVtZWQgaW1wcnVkZW50IGdpdmVuIHVuZGVmaW5lZCBiZXR0ZXIgcmVwcmVzZW50cwoJCQkvLyB0aGUgdXJsIHN0YXRlCgoJCQkvLyBJZiB3ZSBhcmUgYXQgYSBwbGFjZSBpbiBoaXN0b3J5IHRoYXQgb25jZSBiZWxvbmdlZCB0byBhIGRpYWxvZywgcmV1c2UKCQkJLy8gdGhpcyBzdGF0ZSB3aXRob3V0IGFkZGluZyB0byB1cmxIaXN0b3J5IGFuZCB3aXRob3V0IG1vZGlmeWluZyB0aGUgaGFzaC4KCQkJLy8gSG93ZXZlciwgaWYgYSBkaWFsb2cgaXMgYWxyZWFkeSBkaXNwbGF5ZWQgYXQgdGhpcyBwb2ludCwgYW5kIHdlJ3JlCgkJCS8vIGFib3V0IHRvIGRpc3BsYXkgYW5vdGhlciBkaWFsb2csIHRoZW4gd2UgbXVzdCBhZGQgYW5vdGhlciBoYXNoIGFuZAoJCQkvLyBoaXN0b3J5IGVudHJ5IG9uIHRvcCBzbyB0aGF0IG9uZSBtYXkgbmF2aWdhdGUgYmFjayB0byB0aGUgb3JpZ2luYWwgZGlhbG9nCgkJCWlmICggYWN0aXZlLnVybC5pbmRleE9mKCBkaWFsb2dIYXNoS2V5ICkgPiAtMSAmJiAhJC5tb2JpbGUuYWN0aXZlUGFnZS5pcyggIi51aS1kaWFsb2ciICkgKSB7CgkJCQlzZXR0aW5ncy5jaGFuZ2VIYXNoID0gZmFsc2U7CgkJCQlhbHJlYWR5VGhlcmUgPSB0cnVlOwoJCQl9CgoJCQkvLyBOb3JtYWxseSwgd2UgdGFjayBvbiBhIGRpYWxvZyBoYXNoIGtleSwgYnV0IGlmIHRoaXMgaXMgdGhlIGxvY2F0aW9uIG9mIGEgc3RhbGUgZGlhbG9nLAoJCQkvLyB3ZSByZXVzZSB0aGUgVVJMIGZyb20gdGhlIGVudHJ5CgkJCXVybCA9ICggYWN0aXZlLnVybCB8fCAiIiApICsgKCBhbHJlYWR5VGhlcmUgPyAiIiA6IGRpYWxvZ0hhc2hLZXkgKTsKCgkJCS8vIHRhY2sgb24gYW5vdGhlciBkaWFsb2dIYXNoS2V5IGlmIHRoaXMgaXMgdGhlIHNhbWUgYXMgdGhlIGluaXRpYWwgaGFzaAoJCQkvLyB0aGlzIG1ha2VzIHN1cmUgdGhhdCBhIGhpc3RvcnkgZW50cnkgaXMgY3JlYXRlZCBmb3IgdGhpcyBkaWFsb2cKCQkJaWYgKCB1cmxIaXN0b3J5LmFjdGl2ZUluZGV4ID09PSAwICYmIHVybCA9PT0gdXJsSGlzdG9yeS5pbml0aWFsRHN0ICkgewoJCQkJdXJsICs9IGRpYWxvZ0hhc2hLZXk7CgkJCX0KCQl9CgoJCS8vIFNldCB0aGUgbG9jYXRpb24gaGFzaC4KCQlpZiAoIHNldHRpbmdzLmNoYW5nZUhhc2ggIT09IGZhbHNlICYmIHVybCApIHsKCQkJLy9kaXNhYmxlIGhhc2ggbGlzdGVuaW5nIHRlbXBvcmFyaWx5CgkJCXVybEhpc3RvcnkuaWdub3JlTmV4dEhhc2hDaGFuZ2UgPSB0cnVlOwoJCQkvL3VwZGF0ZSBoYXNoIGFuZCBoaXN0b3J5CgkJCXBhdGguc2V0KCB1cmwgKTsKCQl9CgoJCS8vIGlmIHRpdGxlIGVsZW1lbnQgd2Fzbid0IGZvdW5kLCB0cnkgdGhlIHBhZ2UgZGl2IGRhdGEgYXR0ciB0b28KCQkvLyBJZiB0aGlzIGlzIGEgZGVlcC1saW5rIG9yIGEgcmVsb2FkICggYWN0aXZlID09PSB1bmRlZmluZWQgKSB0aGVuIGp1c3QgdXNlIHBhZ2VUaXRsZQoJCXZhciBuZXdQYWdlVGl0bGUgPSAoICFhY3RpdmUgKT8gcGFnZVRpdGxlIDogdG9QYWdlLmpxbURhdGEoICJ0aXRsZSIgKSB8fCB0b1BhZ2UuY2hpbGRyZW4oICI6anFtRGF0YShyb2xlPSdoZWFkZXInKSIgKS5maW5kKCAiLnVpLXRpdGxlIiApLmdldEVuY29kZWRUZXh0KCk7CgkJaWYgKCAhIW5ld1BhZ2VUaXRsZSAmJiBwYWdlVGl0bGUgPT09IGRvY3VtZW50LnRpdGxlICkgewoJCQlwYWdlVGl0bGUgPSBuZXdQYWdlVGl0bGU7CgkJfQoJCWlmICggIXRvUGFnZS5qcW1EYXRhKCAidGl0bGUiICkgKSB7CgkJCXRvUGFnZS5qcW1EYXRhKCAidGl0bGUiLCBwYWdlVGl0bGUgKTsKCQl9CgoJCS8vIE1ha2Ugc3VyZSB3ZSBoYXZlIGEgdHJhbnNpdGlvbiBkZWZpbmVkLgoJCXNldHRpbmdzLnRyYW5zaXRpb24gPSBzZXR0aW5ncy50cmFuc2l0aW9uIHx8CgkJCSggKCBoaXN0b3J5RGlyICYmICFhY3RpdmVJc0luaXRpYWxQYWdlICkgPyBhY3RpdmUudHJhbnNpdGlvbiA6IHVuZGVmaW5lZCApIHx8CgkJCSggaXNEaWFsb2cgPyAkLm1vYmlsZS5kZWZhdWx0RGlhbG9nVHJhbnNpdGlvbiA6ICQubW9iaWxlLmRlZmF1bHRQYWdlVHJhbnNpdGlvbiApOwoKCQkvL2FkZCBwYWdlIHRvIGhpc3Rvcnkgc3RhY2sgaWYgaXQncyBub3QgYmFjayBvciBmb3J3YXJkCgkJaWYgKCAhaGlzdG9yeURpciApIHsKCQkJLy8gT3ZlcndyaXRlIHRoZSBjdXJyZW50IGVudHJ5IGlmIGl0J3MgYSBsZWZ0b3ZlciBmcm9tIGEgZGlhbG9nCgkJCWlmICggYWxyZWFkeVRoZXJlICkgewoJCQkJdXJsSGlzdG9yeS5hY3RpdmVJbmRleCA9IE1hdGgubWF4KCAwLCB1cmxIaXN0b3J5LmFjdGl2ZUluZGV4IC0gMSApOwoJCQl9CgkJCXVybEhpc3RvcnkuYWRkTmV3KCB1cmwsIHNldHRpbmdzLnRyYW5zaXRpb24sIHBhZ2VUaXRsZSwgcGFnZVVybCwgc2V0dGluZ3Mucm9sZSApOwoJCX0KCgkJLy9zZXQgcGFnZSB0aXRsZQoJCWRvY3VtZW50LnRpdGxlID0gdXJsSGlzdG9yeS5nZXRBY3RpdmUoKS50aXRsZTsKCgkJLy9zZXQgInRvUGFnZSIgYXMgYWN0aXZlUGFnZQoJCSQubW9iaWxlLmFjdGl2ZVBhZ2UgPSB0b1BhZ2U7CgoJCS8vIElmIHdlJ3JlIG5hdmlnYXRpbmcgYmFjayBpbiB0aGUgVVJMIGhpc3RvcnksIHNldCByZXZlcnNlIGFjY29yZGluZ2x5LgoJCXNldHRpbmdzLnJldmVyc2UgPSBzZXR0aW5ncy5yZXZlcnNlIHx8IGhpc3RvcnlEaXIgPCAwOwoKCQl0cmFuc2l0aW9uUGFnZXMoIHRvUGFnZSwgZnJvbVBhZ2UsIHNldHRpbmdzLnRyYW5zaXRpb24sIHNldHRpbmdzLnJldmVyc2UgKQoJCQkuZG9uZShmdW5jdGlvbiggbmFtZSwgcmV2ZXJzZSwgJHRvLCAkZnJvbSwgYWxyZWFkeUZvY3VzZWQgKSB7CgkJCQlyZW1vdmVBY3RpdmVMaW5rQ2xhc3MoKTsKCgkJCQkvL2lmIHRoZXJlJ3MgYSBkdXBsaWNhdGVDYWNoZWRQYWdlLCByZW1vdmUgaXQgZnJvbSB0aGUgRE9NIG5vdyB0aGF0IGl0J3MgaGlkZGVuCgkJCQlpZiAoIHNldHRpbmdzLmR1cGxpY2F0ZUNhY2hlZFBhZ2UgKSB7CgkJCQkJc2V0dGluZ3MuZHVwbGljYXRlQ2FjaGVkUGFnZS5yZW1vdmUoKTsKCQkJCX0KCgkJCQkvLyBTZW5kIGZvY3VzIHRvIHRoZSBuZXdseSBzaG93biBwYWdlLiBNb3ZlZCBmcm9tIHByb21pc2UgLmRvbmUgYmluZGluZyBpbiB0cmFuc2l0aW9uUGFnZXMKCQkJCS8vIGl0c2VsZiB0byBhdm9pZCBpZSBidWcgdGhhdCByZXBvcnRzIG9mZnNldFdpZHRoIGFzID4gMCAoY29yZSBjaGVjayBmb3IgdmlzaWJpbGl0eSkKCQkJCS8vIGRlc3BpdGUgdmlzaWJpbGl0eTogaGlkZGVuIGFkZHJlc3NlcyBpc3N1ZSAjMjk2NQoJCQkJLy8gaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnktbW9iaWxlL2lzc3Vlcy8yOTY1CgkJCQlpZiAoICFhbHJlYWR5Rm9jdXNlZCApIHsKCQkJCQkkLm1vYmlsZS5mb2N1c1BhZ2UoIHRvUGFnZSApOwoJCQkJfQoKCQkJCXJlbGVhc2VQYWdlVHJhbnNpdGlvbkxvY2soKTsKCgkJCQkvLyBMZXQgbGlzdGVuZXJzIGtub3cgd2UncmUgYWxsIGRvbmUgY2hhbmdpbmcgdGhlIGN1cnJlbnQgcGFnZS4KCQkJCW1wYy50cmlnZ2VyKCAicGFnZWNoYW5nZSIsIHRyaWdnZXJEYXRhICk7CgkJCX0pOwoJfTsKCgkkLm1vYmlsZS5jaGFuZ2VQYWdlLmRlZmF1bHRzID0gewoJCXRyYW5zaXRpb246IHVuZGVmaW5lZCwKCQlyZXZlcnNlOiBmYWxzZSwKCQljaGFuZ2VIYXNoOiB0cnVlLAoJCWZyb21IYXNoQ2hhbmdlOiBmYWxzZSwKCQlyb2xlOiB1bmRlZmluZWQsIC8vIEJ5IGRlZmF1bHQgd2UgcmVseSBvbiB0aGUgcm9sZSBkZWZpbmVkIGJ5IHRoZSBAZGF0YS1yb2xlIGF0dHJpYnV0ZS4KCQlkdXBsaWNhdGVDYWNoZWRQYWdlOiB1bmRlZmluZWQsCgkJcGFnZUNvbnRhaW5lcjogdW5kZWZpbmVkLAoJCXNob3dMb2FkTXNnOiB0cnVlLCAvL2xvYWRpbmcgbWVzc2FnZSBzaG93cyBieSBkZWZhdWx0IHdoZW4gcGFnZXMgYXJlIGJlaW5nIGZldGNoZWQgZHVyaW5nIGNoYW5nZVBhZ2UKCQlkYXRhVXJsOiB1bmRlZmluZWQsCgkJZnJvbVBhZ2U6IHVuZGVmaW5lZCwKCQlhbGxvd1NhbWVQYWdlVHJhbnNpdGlvbjogZmFsc2UKCX07CgovKiBFdmVudCBCaW5kaW5ncyAtIGhhc2hjaGFuZ2UsIHN1Ym1pdCwgYW5kIGNsaWNrICovCglmdW5jdGlvbiBmaW5kQ2xvc2VzdExpbmsoIGVsZSApCgl7CgkJd2hpbGUgKCBlbGUgKSB7CgkJCS8vIExvb2sgZm9yIHRoZSBjbG9zZXN0IGVsZW1lbnQgd2l0aCBhIG5vZGVOYW1lIG9mICJhIi4KCQkJLy8gTm90ZSB0aGF0IHdlIGFyZSBjaGVja2luZyBpZiB3ZSBoYXZlIGEgdmFsaWQgbm9kZU5hbWUKCQkJLy8gYmVmb3JlIGF0dGVtcHRpbmcgdG8gYWNjZXNzIGl0LiBUaGlzIGlzIGJlY2F1c2UgdGhlCgkJCS8vIG5vZGUgd2UgZ2V0IGNhbGxlZCB3aXRoIGNvdWxkIGhhdmUgb3JpZ2luYXRlZCBmcm9tIHdpdGhpbgoJCQkvLyBhbiBlbWJlZGRlZCBTVkcgZG9jdW1lbnQgd2hlcmUgc29tZSBzeW1ib2wgaW5zdGFuY2UgZWxlbWVudHMKCQkJLy8gZG9uJ3QgaGF2ZSBub2RlTmFtZSBkZWZpbmVkIG9uIHRoZW0sIG9yIHN0cmluZ3MgYXJlIG9mIHR5cGUKCQkJLy8gU1ZHQW5pbWF0ZWRTdHJpbmcuCgkJCWlmICggKCB0eXBlb2YgZWxlLm5vZGVOYW1lID09PSAic3RyaW5nIiApICYmIGVsZS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpID09PSAiYSIgKSB7CgkJCQlicmVhazsKCQkJfQoJCQllbGUgPSBlbGUucGFyZW50Tm9kZTsKCQl9CgkJcmV0dXJuIGVsZTsKCX0KCgkvLyBUaGUgYmFzZSBVUkwgZm9yIGFueSBnaXZlbiBlbGVtZW50IGRlcGVuZHMgb24gdGhlIHBhZ2UgaXQgcmVzaWRlcyBpbi4KCWZ1bmN0aW9uIGdldENsb3Nlc3RCYXNlVXJsKCBlbGUgKQoJewoJCS8vIEZpbmQgdGhlIGNsb3Nlc3QgcGFnZSBhbmQgZXh0cmFjdCBvdXQgaXRzIHVybC4KCQl2YXIgdXJsID0gJCggZWxlICkuY2xvc2VzdCggIi51aS1wYWdlIiApLmpxbURhdGEoICJ1cmwiICksCgkJCWJhc2UgPSBkb2N1bWVudEJhc2UuaHJlZk5vSGFzaDsKCgkJaWYgKCAhdXJsIHx8ICFwYXRoLmlzUGF0aCggdXJsICkgKSB7CgkJCXVybCA9IGJhc2U7CgkJfQoKCQlyZXR1cm4gcGF0aC5tYWtlVXJsQWJzb2x1dGUoIHVybCwgYmFzZSk7Cgl9CgoJLy9UaGUgZm9sbG93aW5nIGV2ZW50IGJpbmRpbmdzIHNob3VsZCBiZSBib3VuZCBhZnRlciBtb2JpbGVpbml0IGhhcyBiZWVuIHRyaWdnZXJlZAoJLy90aGUgZm9sbG93aW5nIGRlZmVycmVkIGlzIHJlc29sdmVkIGluIHRoZSBpbml0IGZpbGUKCSQubW9iaWxlLm5hdnJlYWR5RGVmZXJyZWQgPSAkLkRlZmVycmVkKCk7CgkkLm1vYmlsZS5uYXZyZWFkeURlZmVycmVkLmRvbmUoZnVuY3Rpb24oKSB7CgkJLy9iaW5kIHRvIGZvcm0gc3VibWl0IGV2ZW50cywgaGFuZGxlIHdpdGggQWpheAoJCSQoIGRvY3VtZW50ICkuZGVsZWdhdGUoICJmb3JtIiwgInN1Ym1pdCIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdmFyICR0aGlzID0gJCggdGhpcyApOwoKCQkJaWYgKCAhJC5tb2JpbGUuYWpheEVuYWJsZWQgfHwKCQkJCQkvLyB0ZXN0IHRoYXQgdGhlIGZvcm0gaXMsIGl0c2VsZiwgYWpheCBmYWxzZQoJCQkJCSR0aGlzLmlzKCAiOmpxbURhdGEoYWpheD0nZmFsc2UnKSIgKSB8fAoJCQkJCS8vIHRlc3QgdGhhdCAkLm1vYmlsZS5pZ25vcmVDb250ZW50RW5hYmxlZCBpcyBzZXQgYW5kCgkJCQkJLy8gdGhlIGZvcm0gb3Igb25lIG9mIGl0J3MgcGFyZW50cyBpcyBhamF4PWZhbHNlCgkJCQkJISR0aGlzLmpxbUhpamFja2FibGUoKS5sZW5ndGggKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCXZhciB0eXBlID0gJHRoaXMuYXR0ciggIm1ldGhvZCIgKSwKCQkJCXRhcmdldCA9ICR0aGlzLmF0dHIoICJ0YXJnZXQiICksCgkJCQl1cmwgPSAkdGhpcy5hdHRyKCAiYWN0aW9uIiApOwoKCQkJLy8gSWYgbm8gYWN0aW9uIGlzIHNwZWNpZmllZCwgYnJvd3NlcnMgZGVmYXVsdCB0byB1c2luZyB0aGUKCQkJLy8gVVJMIG9mIHRoZSBkb2N1bWVudCBjb250YWluaW5nIHRoZSBmb3JtLiBTaW5jZSB3ZSBkeW5hbWljYWxseQoJCQkvLyBwdWxsIGluIHBhZ2VzIGZyb20gZXh0ZXJuYWwgZG9jdW1lbnRzLCB0aGUgZm9ybSBzaG91bGQgc3VibWl0CgkJCS8vIHRvIHRoZSBVUkwgZm9yIHRoZSBzb3VyY2UgZG9jdW1lbnQgb2YgdGhlIHBhZ2UgY29udGFpbmluZwoJCQkvLyB0aGUgZm9ybS4KCQkJaWYgKCAhdXJsICkgewoJCQkJLy8gR2V0IHRoZSBAZGF0YS11cmwgZm9yIHRoZSBwYWdlIGNvbnRhaW5pbmcgdGhlIGZvcm0uCgkJCQl1cmwgPSBnZXRDbG9zZXN0QmFzZVVybCggJHRoaXMgKTsKCQkJCWlmICggdXJsID09PSBkb2N1bWVudEJhc2UuaHJlZk5vSGFzaCApIHsKCQkJCQkvLyBUaGUgdXJsIHdlIGdvdCBiYWNrIG1hdGNoZXMgdGhlIGRvY3VtZW50IGJhc2UsCgkJCQkJLy8gd2hpY2ggbWVhbnMgdGhlIHBhZ2UgbXVzdCBiZSBhbiBpbnRlcm5hbC9lbWJlZGRlZCBwYWdlLAoJCQkJCS8vIHNvIGRlZmF1bHQgdG8gdXNpbmcgdGhlIGFjdHVhbCBkb2N1bWVudCB1cmwgYXMgYSBicm93c2VyCgkJCQkJLy8gd291bGQuCgkJCQkJdXJsID0gZG9jdW1lbnRVcmwuaHJlZk5vU2VhcmNoOwoJCQkJfQoJCQl9CgoJCQl1cmwgPSBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggIHVybCwgZ2V0Q2xvc2VzdEJhc2VVcmwoICR0aGlzICkgKTsKCgkJCWlmICggKCBwYXRoLmlzRXh0ZXJuYWwoIHVybCApICYmICFwYXRoLmlzUGVybWl0dGVkQ3Jvc3NEb21haW5SZXF1ZXN0KCBkb2N1bWVudFVybCwgdXJsICkgKSB8fCB0YXJnZXQgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCSQubW9iaWxlLmNoYW5nZVBhZ2UoCgkJCQl1cmwsCgkJCQl7CgkJCQkJdHlwZToJCXR5cGUgJiYgdHlwZS5sZW5ndGggJiYgdHlwZS50b0xvd2VyQ2FzZSgpIHx8ICJnZXQiLAoJCQkJCWRhdGE6CQkkdGhpcy5zZXJpYWxpemUoKSwKCQkJCQl0cmFuc2l0aW9uOgkkdGhpcy5qcW1EYXRhKCAidHJhbnNpdGlvbiIgKSwKCQkJCQlyZXZlcnNlOgkkdGhpcy5qcW1EYXRhKCAiZGlyZWN0aW9uIiApID09PSAicmV2ZXJzZSIsCgkJCQkJcmVsb2FkUGFnZToJdHJ1ZQoJCQkJfQoJCQkpOwoJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCX0pOwoKCQkvL2FkZCBhY3RpdmUgc3RhdGUgb24gdmNsaWNrCgkJJCggZG9jdW1lbnQgKS5iaW5kKCAidmNsaWNrIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkvLyBpZiB0aGlzIGlzbid0IGEgbGVmdCBjbGljayB3ZSBkb24ndCBjYXJlLiBJdHMgaW1wb3J0YW50IHRvIG5vdGUKCQkJLy8gdGhhdCB3aGVuIHRoZSB2aXJ0dWFsIGV2ZW50IGlzIGdlbmVyYXRlZCBpdCB3aWxsIGNyZWF0ZSB0aGUgd2hpY2ggYXR0cgoJCQlpZiAoIGV2ZW50LndoaWNoID4gMSB8fCAhJC5tb2JpbGUubGlua0JpbmRpbmdFbmFibGVkICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQl2YXIgbGluayA9IGZpbmRDbG9zZXN0TGluayggZXZlbnQudGFyZ2V0ICk7CgoJCQkvLyBzcGxpdCBmcm9tIHRoZSBwcmV2aW91cyByZXR1cm4gbG9naWMgdG8gYXZvaWQgZmluZCBjbG9zZXN0IHdoZXJlIHBvc3NpYmxlCgkJCS8vIFRPRE8gdGVhY2ggJC5tb2JpbGUuaGlqYWNrYWJsZSB0byBvcGVyYXRlIG9uIHJhdyBkb20gZWxlbWVudHMgc28gdGhlIGxpbmsgd3JhcHBpbmcKCQkJLy8gY2FuIGJlIGF2b2lkZWQKCQkJaWYgKCAhJCggbGluayApLmpxbUhpamFja2FibGUoKS5sZW5ndGggKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCWlmICggbGluayApIHsKCQkJCWlmICggcGF0aC5wYXJzZVVybCggbGluay5nZXRBdHRyaWJ1dGUoICJocmVmIiApIHx8ICIjIiApLmhhc2ggIT09ICIjIiApIHsKCQkJCQlyZW1vdmVBY3RpdmVMaW5rQ2xhc3MoIHRydWUgKTsKCQkJCQkkYWN0aXZlQ2xpY2tlZExpbmsgPSAkKCBsaW5rICkuY2xvc2VzdCggIi51aS1idG4iICkubm90KCAiLnVpLWRpc2FibGVkIiApOwoJCQkJCSRhY3RpdmVDbGlja2VkTGluay5hZGRDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJCX0KCQkJfQoJCX0pOwoKCQkvLyBjbGljayByb3V0aW5nIC0gZGlyZWN0IHRvIEhUVFAgb3IgQWpheCwgYWNjb3JkaW5nbHkKCQkkKCBkb2N1bWVudCApLmJpbmQoICJjbGljayIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJaWYgKCAhJC5tb2JpbGUubGlua0JpbmRpbmdFbmFibGVkICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQl2YXIgbGluayA9IGZpbmRDbG9zZXN0TGluayggZXZlbnQudGFyZ2V0ICksICRsaW5rID0gJCggbGluayApLCBodHRwQ2xlYW51cDsKCgkJCS8vIElmIHRoZXJlIGlzIG5vIGxpbmsgYXNzb2NpYXRlZCB3aXRoIHRoZSBjbGljayBvciBpdHMgbm90IGEgbGVmdAoJCQkvLyBjbGljayB3ZSB3YW50IHRvIGlnbm9yZSB0aGUgY2xpY2sKCQkJLy8gVE9ETyB0ZWFjaCAkLm1vYmlsZS5oaWphY2thYmxlIHRvIG9wZXJhdGUgb24gcmF3IGRvbSBlbGVtZW50cyBzbyB0aGUgbGluayB3cmFwcGluZwoJCQkvLyBjYW4gYmUgYXZvaWRlZAoJCQlpZiAoICFsaW5rIHx8IGV2ZW50LndoaWNoID4gMSB8fCAhJGxpbmsuanFtSGlqYWNrYWJsZSgpLmxlbmd0aCApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJLy9yZW1vdmUgYWN0aXZlIGxpbmsgY2xhc3MgaWYgZXh0ZXJuYWwgKHRoZW4gaXQgd29uJ3QgYmUgdGhlcmUgaWYgeW91IGNvbWUgYmFjaykKCQkJaHR0cENsZWFudXAgPSBmdW5jdGlvbigpIHsKCQkJCXdpbmRvdy5zZXRUaW1lb3V0KGZ1bmN0aW9uKCkgeyByZW1vdmVBY3RpdmVMaW5rQ2xhc3MoIHRydWUgKTsgfSwgMjAwICk7CgkJCX07CgoJCQkvL2lmIHRoZXJlJ3MgYSBkYXRhLXJlbD1iYWNrIGF0dHIsIGdvIGJhY2sgaW4gaGlzdG9yeQoJCQlpZiAoICRsaW5rLmlzKCAiOmpxbURhdGEocmVsPSdiYWNrJykiICkgKSB7CgkJCQkkLm1vYmlsZS5iYWNrKCk7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCgkJCXZhciBiYXNlVXJsID0gZ2V0Q2xvc2VzdEJhc2VVcmwoICRsaW5rICksCgoJCQkJLy9nZXQgaHJlZiwgaWYgZGVmaW5lZCwgb3RoZXJ3aXNlIGRlZmF1bHQgdG8gZW1wdHkgaGFzaAoJCQkJaHJlZiA9IHBhdGgubWFrZVVybEFic29sdXRlKCAkbGluay5hdHRyKCAiaHJlZiIgKSB8fCAiIyIsIGJhc2VVcmwgKTsKCgkJCS8vaWYgYWpheCBpcyBkaXNhYmxlZCwgZXhpdCBlYXJseQoJCQlpZiAoICEkLm1vYmlsZS5hamF4RW5hYmxlZCAmJiAhcGF0aC5pc0VtYmVkZGVkUGFnZSggaHJlZiApICkgewoJCQkJaHR0cENsZWFudXAoKTsKCQkJCS8vdXNlIGRlZmF1bHQgY2xpY2sgaGFuZGxpbmcKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gWFhYX2pibGFzOiBJZGVhbGx5IGxpbmtzIHRvIGFwcGxpY2F0aW9uIHBhZ2VzIHNob3VsZCBiZSBzcGVjaWZpZWQgYXMKCQkJLy8gICAgICAgICAgICBhbiB1cmwgdG8gdGhlIGFwcGxpY2F0aW9uIGRvY3VtZW50IHdpdGggYSBoYXNoIHRoYXQgaXMgZWl0aGVyCgkJCS8vICAgICAgICAgICAgdGhlIHNpdGUgcmVsYXRpdmUgcGF0aCBvciBpZCB0byB0aGUgcGFnZS4gQnV0IHNvbWUgb2YgdGhlCgkJCS8vICAgICAgICAgICAgaW50ZXJuYWwgY29kZSB0aGF0IGR5bmFtaWNhbGx5IGdlbmVyYXRlcyBzdWItcGFnZXMgZm9yIG5lc3RlZAoJCQkvLyAgICAgICAgICAgIGxpc3RzIGFuZCBzZWxlY3QgZGlhbG9ncywganVzdCB3cml0ZSBhIGhhc2ggaW4gdGhlIGxpbmsgdGhleQoJCQkvLyAgICAgICAgICAgIGNyZWF0ZS4gVGhpcyBtZWFucyB0aGUgYWN0dWFsIFVSTCBwYXRoIGlzIGJhc2VkIG9uIHdoYXRldmVyCgkJCS8vICAgICAgICAgICAgdGhlIGN1cnJlbnQgdmFsdWUgb2YgdGhlIGJhc2UgdGFnIGlzIGF0IHRoZSB0aW1lIHRoaXMgY29kZQoJCQkvLyAgICAgICAgICAgIGlzIGNhbGxlZC4gRm9yIG5vdyB3ZSBhcmUganVzdCBhc3N1bWluZyB0aGF0IGFueSB1cmwgd2l0aCBhCgkJCS8vICAgICAgICAgICAgaGFzaCBpbiBpdCBpcyBhbiBhcHBsaWNhdGlvbiBwYWdlIHJlZmVyZW5jZS4KCQkJaWYgKCBocmVmLnNlYXJjaCggIiMiICkgIT09IC0xICkgewoJCQkJaHJlZiA9IGhyZWYucmVwbGFjZSggL1teI10qIy8sICIiICk7CgkJCQlpZiAoICFocmVmICkgewoJCQkJCS8vbGluayB3YXMgYW4gZW1wdHkgaGFzaCBtZWFudCBwdXJlbHkKCQkJCQkvL2ZvciBpbnRlcmFjdGlvbiwgc28gd2UgaWdub3JlIGl0LgoJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQkJcmV0dXJuOwoJCQkJfSBlbHNlIGlmICggcGF0aC5pc1BhdGgoIGhyZWYgKSApIHsKCQkJCQkvL3dlIGhhdmUgYXBhdGggc28gbWFrZSBpdCB0aGUgaHJlZiB3ZSB3YW50IHRvIGxvYWQuCgkJCQkJaHJlZiA9IHBhdGgubWFrZVVybEFic29sdXRlKCBocmVmLCBiYXNlVXJsICk7CgkJCQl9IGVsc2UgewoJCQkJCS8vd2UgaGF2ZSBhIHNpbXBsZSBpZCBzbyB1c2UgdGhlIGRvY3VtZW50VXJsIGFzIGl0cyBiYXNlLgoJCQkJCWhyZWYgPSBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggIiMiICsgaHJlZiwgZG9jdW1lbnRVcmwuaHJlZk5vSGFzaCApOwoJCQkJfQoJCQl9CgoJCQkJLy8gU2hvdWxkIHdlIGhhbmRsZSB0aGlzIGxpbmssIG9yIGxldCB0aGUgYnJvd3NlciBkZWFsIHdpdGggaXQ/CgkJCXZhciB1c2VEZWZhdWx0VXJsSGFuZGxpbmcgPSAkbGluay5pcyggIltyZWw9J2V4dGVybmFsJ10iICkgfHwgJGxpbmsuaXMoICI6anFtRGF0YShhamF4PSdmYWxzZScpIiApIHx8ICRsaW5rLmlzKCAiW3RhcmdldF0iICksCgoJCQkJLy8gU29tZSBlbWJlZGRlZCBicm93c2VycywgbGlrZSB0aGUgd2ViIHZpZXcgaW4gUGhvbmUgR2FwLCBhbGxvdyBjcm9zcy1kb21haW4gWEhSCgkJCQkvLyByZXF1ZXN0cyBpZiB0aGUgZG9jdW1lbnQgZG9pbmcgdGhlIHJlcXVlc3Qgd2FzIGxvYWRlZCB2aWEgdGhlIGZpbGU6Ly8gcHJvdG9jb2wuCgkJCQkvLyBUaGlzIGlzIHVzdWFsbHkgdG8gYWxsb3cgdGhlIGFwcGxpY2F0aW9uIHRvICJwaG9uZSBob21lIiBhbmQgZmV0Y2ggYXBwIHNwZWNpZmljCgkJCQkvLyBkYXRhLiBXZSBub3JtYWxseSBsZXQgdGhlIGJyb3dzZXIgaGFuZGxlIGV4dGVybmFsL2Nyb3NzLWRvbWFpbiB1cmxzLCBidXQgaWYgdGhlCgkJCQkvLyBhbGxvd0Nyb3NzRG9tYWluUGFnZXMgb3B0aW9uIGlzIHRydWUsIHdlIHdpbGwgYWxsb3cgY3Jvc3MtZG9tYWluIGh0dHAvaHR0cHMKCQkJCS8vIHJlcXVlc3RzIHRvIGdvIHRocm91Z2ggb3VyIHBhZ2UgbG9hZGluZyBsb2dpYy4KCgkJCQkvL2NoZWNrIGZvciBwcm90b2NvbCBvciByZWwgYW5kIGl0cyBub3QgYW4gZW1iZWRkZWQgcGFnZQoJCQkJLy9UT0RPIG92ZXJsYXAgaW4gbG9naWMgZnJvbSBpc0V4dGVybmFsLCByZWw9ZXh0ZXJuYWwgY2hlY2sgc2hvdWxkIGJlCgkJCQkvLyAgICAgbW92ZWQgaW50byBtb3JlIGNvbXByZWhlbnNpdmUgaXNFeHRlcm5hbExpbmsKCQkJCWlzRXh0ZXJuYWwgPSB1c2VEZWZhdWx0VXJsSGFuZGxpbmcgfHwgKCBwYXRoLmlzRXh0ZXJuYWwoIGhyZWYgKSAmJiAhcGF0aC5pc1Blcm1pdHRlZENyb3NzRG9tYWluUmVxdWVzdCggZG9jdW1lbnRVcmwsIGhyZWYgKSApOwoKCQkJaWYgKCBpc0V4dGVybmFsICkgewoJCQkJaHR0cENsZWFudXAoKTsKCQkJCS8vdXNlIGRlZmF1bHQgY2xpY2sgaGFuZGxpbmcKCQkJCXJldHVybjsKCQkJfQoKCQkJLy91c2UgYWpheAoJCQl2YXIgdHJhbnNpdGlvbiA9ICRsaW5rLmpxbURhdGEoICJ0cmFuc2l0aW9uIiApLAoJCQkJcmV2ZXJzZSA9ICRsaW5rLmpxbURhdGEoICJkaXJlY3Rpb24iICkgPT09ICJyZXZlcnNlIiB8fAoJCQkJCQkJLy8gZGVwcmVjYXRlZCAtIHJlbW92ZSBieSAxLjAKCQkJCQkJCSRsaW5rLmpxbURhdGEoICJiYWNrIiApLAoKCQkJCS8vdGhpcyBtYXkgbmVlZCB0byBiZSBtb3JlIHNwZWNpZmljIGFzIHdlIHVzZSBkYXRhLXJlbCBtb3JlCgkJCQlyb2xlID0gJGxpbmsuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgInJlbCIgKSB8fCB1bmRlZmluZWQ7CgoJCQkkLm1vYmlsZS5jaGFuZ2VQYWdlKCBocmVmLCB7IHRyYW5zaXRpb246IHRyYW5zaXRpb24sIHJldmVyc2U6IHJldmVyc2UsIHJvbGU6IHJvbGUsIGxpbms6ICRsaW5rIH0gKTsKCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQl9KTsKCgkJLy9wcmVmZXRjaCBwYWdlcyB3aGVuIGFuY2hvcnMgd2l0aCBkYXRhLXByZWZldGNoIGFyZSBlbmNvdW50ZXJlZAoJCSQoIGRvY3VtZW50ICkuZGVsZWdhdGUoICIudWktcGFnZSIsICJwYWdlc2hvdy5wcmVmZXRjaCIsIGZ1bmN0aW9uKCkgewoJCQl2YXIgdXJscyA9IFtdOwoJCQkkKCB0aGlzICkuZmluZCggImE6anFtRGF0YShwcmVmZXRjaCkiICkuZWFjaChmdW5jdGlvbigpIHsKCQkJCXZhciAkbGluayA9ICQoIHRoaXMgKSwKCQkJCQl1cmwgPSAkbGluay5hdHRyKCAiaHJlZiIgKTsKCgkJCQlpZiAoIHVybCAmJiAkLmluQXJyYXkoIHVybCwgdXJscyApID09PSAtMSApIHsKCQkJCQl1cmxzLnB1c2goIHVybCApOwoKCQkJCQkkLm1vYmlsZS5sb2FkUGFnZSggdXJsLCB7IHJvbGU6ICRsaW5rLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyZWwiICkgfSApOwoJCQkJfQoJCQl9KTsKCQl9KTsKCgkJJC5tb2JpbGUuX2hhbmRsZUhhc2hDaGFuZ2UgPSBmdW5jdGlvbiggaGFzaCApIHsKCQkJLy9maW5kIGZpcnN0IHBhZ2UgdmlhIGhhc2gKCQkJdmFyIHRvID0gcGF0aC5zdHJpcEhhc2goIGhhc2ggKSwKCQkJCS8vdHJhbnNpdGlvbiBpcyBmYWxzZSBpZiBpdCdzIHRoZSBmaXJzdCBwYWdlLCB1bmRlZmluZWQgb3RoZXJ3aXNlIChhbmQgbWF5IGJlIG92ZXJyaWRkZW4gYnkgZGVmYXVsdCkKCQkJCXRyYW5zaXRpb24gPSAkLm1vYmlsZS51cmxIaXN0b3J5LnN0YWNrLmxlbmd0aCA9PT0gMCA/ICJub25lIiA6IHVuZGVmaW5lZCwKCgkJCQkvLyAibmF2aWdhdGUiIGV2ZW50IGZpcmVkIHRvIGFsbG93IG90aGVycyB0byB0YWtlIGFkdmFudGFnZSBvZiB0aGUgbW9yZSByb2J1c3QgaGFzaGNoYW5nZSBoYW5kbGluZwoJCQkJbmF2RXZlbnQgPSBuZXcgJC5FdmVudCggIm5hdmlnYXRlIiApLAoKCQkJCS8vIGRlZmF1bHQgb3B0aW9ucyBmb3IgdGhlIGNoYW5nUGFnZSBjYWxscyBtYWRlIGFmdGVyIGV4YW1pbmluZyB0aGUgY3VycmVudCBzdGF0ZQoJCQkJLy8gb2YgdGhlIHBhZ2UgYW5kIHRoZSBoYXNoCgkJCQljaGFuZ2VQYWdlT3B0aW9ucyA9IHsKCQkJCQl0cmFuc2l0aW9uOiB0cmFuc2l0aW9uLAoJCQkJCWNoYW5nZUhhc2g6IGZhbHNlLAoJCQkJCWZyb21IYXNoQ2hhbmdlOiB0cnVlCgkJCQl9OwoKCQkJaWYgKCAwID09PSB1cmxIaXN0b3J5LnN0YWNrLmxlbmd0aCApIHsKCQkJCXVybEhpc3RvcnkuaW5pdGlhbERzdCA9IHRvOwoJCQl9CgoJCQkvLyBXZSBzaG91bGQgcHJvYmFibHkgZmlyZSB0aGUgIm5hdmlnYXRlIiBldmVudCBmcm9tIHRob3NlIHBsYWNlcyB0aGF0IG1ha2UgY2FsbHMgdG8gX2hhbmRsZUhhc2hDaGFuZ2UsCgkJCS8vIGFuZCBoYXZlIF9oYW5kbGVIYXNoQ2hhbmdlIGhvb2sgaW50byB0aGUgIm5hdmlnYXRlIiBldmVudCBpbnN0ZWFkIG9mIHRyaWdnZXJpbmcgaXQgaGVyZQoJCQkkLm1vYmlsZS5wYWdlQ29udGFpbmVyLnRyaWdnZXIoIG5hdkV2ZW50ICk7CgkJCWlmICggbmF2RXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vaWYgbGlzdGVuaW5nIGlzIGRpc2FibGVkIChlaXRoZXIgZ2xvYmFsbHkgb3IgdGVtcG9yYXJpbHkpLCBvciBpdCdzIGEgZGlhbG9nIGhhc2gKCQkJaWYgKCAhJC5tb2JpbGUuaGFzaExpc3RlbmluZ0VuYWJsZWQgfHwgdXJsSGlzdG9yeS5pZ25vcmVOZXh0SGFzaENoYW5nZSApIHsKCQkJCXVybEhpc3RvcnkuaWdub3JlTmV4dEhhc2hDaGFuZ2UgPSBmYWxzZTsKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gc3BlY2lhbCBjYXNlIGZvciBkaWFsb2dzCgkJCWlmICggdXJsSGlzdG9yeS5zdGFjay5sZW5ndGggPiAxICYmIHRvLmluZGV4T2YoIGRpYWxvZ0hhc2hLZXkgKSA+IC0xICYmIHVybEhpc3RvcnkuaW5pdGlhbERzdCAhPT0gdG8gKSB7CgoJCQkJLy8gSWYgY3VycmVudCBhY3RpdmUgcGFnZSBpcyBub3QgYSBkaWFsb2cgc2tpcCB0aGUgZGlhbG9nIGFuZCBjb250aW51ZQoJCQkJLy8gaW4gdGhlIHNhbWUgZGlyZWN0aW9uCgkJCQlpZiAoICEkLm1vYmlsZS5hY3RpdmVQYWdlLmlzKCAiLnVpLWRpYWxvZyIgKSApIHsKCQkJCQkvL2RldGVybWluZSBpZiB3ZSdyZSBoZWFkaW5nIGZvcndhcmQgb3IgYmFja3dhcmQgYW5kIGNvbnRpbnVlIGFjY29yZGluZ2x5IHBhc3QKCQkJCQkvL3RoZSBjdXJyZW50IGRpYWxvZwoJCQkJCXVybEhpc3RvcnkuZGlyZWN0SGFzaENoYW5nZSh7CgkJCQkJCWN1cnJlbnRVcmw6IHRvLAoJCQkJCQlpc0JhY2s6IGZ1bmN0aW9uKCkgeyAkLm1vYmlsZS5iYWNrKCk7IH0sCgkJCQkJCWlzRm9yd2FyZDogZnVuY3Rpb24oKSB7IHdpbmRvdy5oaXN0b3J5LmZvcndhcmQoKTsgfQoJCQkJCX0pOwoKCQkJCQkvLyBwcmV2ZW50IGNoYW5nZVBhZ2UoKQoJCQkJCXJldHVybjsKCQkJCX0gZWxzZSB7CgkJCQkJLy8gaWYgdGhlIGN1cnJlbnQgYWN0aXZlIHBhZ2UgaXMgYSBkaWFsb2cgYW5kIHdlJ3JlIG5hdmlnYXRpbmcKCQkJCQkvLyB0byBhIGRpYWxvZyB1c2UgdGhlIGRpYWxvZyBvYmplY3RlZCBzYXZlZCBpbiB0aGUgc3RhY2sKCQkJCQl1cmxIaXN0b3J5LmRpcmVjdEhhc2hDaGFuZ2UoewoJCQkJCQljdXJyZW50VXJsOiB0bywKCgkJCQkJCS8vIHJlZ2FyZGxlc3Mgb2YgdGhlIGRpcmVjdGlvbiBvZiB0aGUgaGlzdG9yeSBjaGFuZ2UKCQkJCQkJLy8gZG8gdGhlIGZvbGxvd2luZwoJCQkJCQllaXRoZXI6IGZ1bmN0aW9uKCBpc0JhY2sgKSB7CgkJCQkJCQl2YXIgYWN0aXZlID0gJC5tb2JpbGUudXJsSGlzdG9yeS5nZXRBY3RpdmUoKTsKCgkJCQkJCQl0byA9IGFjdGl2ZS5wYWdlVXJsOwoKCQkJCQkJCS8vIG1ha2Ugc3VyZSB0byBzZXQgdGhlIHJvbGUsIHRyYW5zaXRpb24gYW5kIHJldmVyc2FsCgkJCQkJCQkvLyBhcyBtb3N0IG9mIHRoaXMgaXMgbG9zdCBieSB0aGUgZG9tQ2FjaGUgY2xlYW5pbmcKCQkJCQkJCSQuZXh0ZW5kKCBjaGFuZ2VQYWdlT3B0aW9ucywgewoJCQkJCQkJCXJvbGU6IGFjdGl2ZS5yb2xlLAoJCQkJCQkJCXRyYW5zaXRpb246IGFjdGl2ZS50cmFuc2l0aW9uLAoJCQkJCQkJCXJldmVyc2U6IGlzQmFjawoJCQkJCQkJfSk7CgkJCQkJCX0KCQkJCQl9KTsKCQkJCX0KCQkJfQoKCQkJLy9pZiB0byBpcyBkZWZpbmVkLCBsb2FkIGl0CgkJCWlmICggdG8gKSB7CgkJCQkvLyBBdCB0aGlzIHBvaW50LCAndG8nIGNhbiBiZSBvbmUgb2YgMyB0aGluZ3MsIGEgY2FjaGVkIHBhZ2UgZWxlbWVudCBmcm9tCgkJCQkvLyBhIGhpc3Rvcnkgc3RhY2sgZW50cnksIGFuIGlkLCBvciBzaXRlLXJlbGF0aXZlL2Fic29sdXRlIFVSTC4gSWYgJ3RvJyBpcwoJCQkJLy8gYW4gaWQsIHdlIG5lZWQgdG8gcmVzb2x2ZSBpdCBhZ2FpbnN0IHRoZSBkb2N1bWVudEJhc2UsIG5vdCB0aGUgbG9jYXRpb24uaHJlZiwKCQkJCS8vIHNpbmNlIHRoZSBoYXNoY2hhbmdlIGNvdWxkJ3ZlIGJlZW4gdGhlIHJlc3VsdCBvZiBhIGZvcndhcmQvYmFja3dhcmQgbmF2aWdhdGlvbgoJCQkJLy8gdGhhdCBjcm9zc2VzIGZyb20gYW4gZXh0ZXJuYWwgcGFnZS9kaWFsb2cgdG8gYW4gaW50ZXJuYWwgcGFnZS9kaWFsb2cuCgkJCQl0byA9ICggdHlwZW9mIHRvID09PSAic3RyaW5nIiAmJiAhcGF0aC5pc1BhdGgoIHRvICkgKSA/ICggcGF0aC5tYWtlVXJsQWJzb2x1dGUoICcjJyArIHRvLCBkb2N1bWVudEJhc2UgKSApIDogdG87CgoJCQkJLy8gSWYgd2UncmUgYWJvdXQgdG8gZ28gdG8gYW4gaW5pdGlhbCBVUkwgdGhhdCBjb250YWlucyBhIHJlZmVyZW5jZSB0byBhIG5vbi1leGlzdGVudAoJCQkJLy8gaW50ZXJuYWwgcGFnZSwgZ28gdG8gdGhlIGZpcnN0IHBhZ2UgaW5zdGVhZC4gV2Uga25vdyB0aGF0IHRoZSBpbml0aWFsIGhhc2ggcmVmZXJzIHRvIGEKCQkJCS8vIG5vbi1leGlzdGVudCBwYWdlLCBiZWNhdXNlIHRoZSBpbml0aWFsIGhhc2ggZGlkIG5vdCBlbmQgdXAgaW4gdGhlIGluaXRpYWwgdXJsSGlzdG9yeSBlbnRyeQoJCQkJaWYgKCB0byA9PT0gcGF0aC5tYWtlVXJsQWJzb2x1dGUoICcjJyArIHVybEhpc3RvcnkuaW5pdGlhbERzdCwgZG9jdW1lbnRCYXNlICkgJiYKCQkJCQl1cmxIaXN0b3J5LnN0YWNrLmxlbmd0aCAmJiB1cmxIaXN0b3J5LnN0YWNrWzBdLnVybCAhPT0gdXJsSGlzdG9yeS5pbml0aWFsRHN0LnJlcGxhY2UoIGRpYWxvZ0hhc2hLZXksICIiICkgKSB7CgkJCQkJdG8gPSAkLm1vYmlsZS5maXJzdFBhZ2U7CgkJCQl9CgkJCQkkLm1vYmlsZS5jaGFuZ2VQYWdlKCB0bywgY2hhbmdlUGFnZU9wdGlvbnMgKTsKCQkJfQllbHNlIHsKCQkJCS8vdGhlcmUncyBubyBoYXNoLCBnbyB0byB0aGUgZmlyc3QgcGFnZSBpbiB0aGUgZG9tCgkJCQkkLm1vYmlsZS5jaGFuZ2VQYWdlKCAkLm1vYmlsZS5maXJzdFBhZ2UsIGNoYW5nZVBhZ2VPcHRpb25zICk7CgkJCX0KCQl9OwoKCQkvL2hhc2hjaGFuZ2UgZXZlbnQgaGFuZGxlcgoJCSR3aW5kb3cuYmluZCggImhhc2hjaGFuZ2UiLCBmdW5jdGlvbiggZSwgdHJpZ2dlcmVkICkgewoJCQkvLyBGaXJlZm94IGF1dG8tZXNjYXBlcyB0aGUgbG9jYXRpb24uaGFzaCBhcyBmb3IgdjEzIGJ1dAoJCQkvLyBsZWF2ZXMgdGhlIGhyZWYgdW50b3VjaGVkCgkJCSQubW9iaWxlLl9oYW5kbGVIYXNoQ2hhbmdlKCBwYXRoLnBhcnNlTG9jYXRpb24oKS5oYXNoICk7CgkJfSk7CgoJCS8vc2V0IHBhZ2UgbWluLWhlaWdodHMgdG8gYmUgZGV2aWNlIHNwZWNpZmljCgkJJCggZG9jdW1lbnQgKS5iaW5kKCAicGFnZXNob3ciLCByZXNldEFjdGl2ZVBhZ2VIZWlnaHQgKTsKCQkkKCB3aW5kb3cgKS5iaW5kKCAidGhyb3R0bGVkcmVzaXplIiwgcmVzZXRBY3RpdmVQYWdlSGVpZ2h0ICk7CgoJfSk7Ly9uYXZyZWFkeURlZmVycmVkIGRvbmUgY2FsbGJhY2sKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgd2luZG93ICkgewoJLy8gRm9yIG5vdywgbGV0J3MgTW9ua2V5cGF0Y2ggdGhpcyBvbnRvIHRoZSBlbmQgb2YgJC5tb2JpbGUuX3JlZ2lzdGVySW50ZXJuYWxFdmVudHMKCS8vIFNjb3BlIHNlbGYgdG8gcHVzaFN0YXRlSGFuZGxlciBzbyB3ZSBjYW4gcmVmZXJlbmNlIGl0IHNhbmVseSB3aXRoaW4gdGhlCgkvLyBtZXRob2RzIGhhbmRlZCBvZmYgYXMgZXZlbnQgaGFuZGxlcnMKCXZhcglwdXNoU3RhdGVIYW5kbGVyID0ge30sCgkJc2VsZiA9IHB1c2hTdGF0ZUhhbmRsZXIsCgkJJHdpbiA9ICQoIHdpbmRvdyApLAoJCXVybCA9ICQubW9iaWxlLnBhdGgucGFyc2VMb2NhdGlvbigpLAoJCW1vYmlsZWluaXREZWZlcnJlZCA9ICQuRGVmZXJyZWQoKSwKCQlkb21yZWFkeURlZmVycmVkID0gJC5EZWZlcnJlZCgpOwoKCSQoIGRvY3VtZW50ICkucmVhZHkoICQucHJveHkoIGRvbXJlYWR5RGVmZXJyZWQsICJyZXNvbHZlIiApICk7CgoJJCggZG9jdW1lbnQgKS5vbmUoICJtb2JpbGVpbml0IiwgJC5wcm94eSggbW9iaWxlaW5pdERlZmVycmVkLCAicmVzb2x2ZSIgKSApOwoKCSQuZXh0ZW5kKCBwdXNoU3RhdGVIYW5kbGVyLCB7CgkJLy8gVE9ETyBtb3ZlIHRvIGEgcGF0aCBoZWxwZXIsIHRoaXMgaXMgcmF0aGVyIGNvbW1vbiBmdW5jdGlvbmFsaXR5CgkJaW5pdGlhbEZpbGVQYXRoOiAoZnVuY3Rpb24oKSB7CgkJCXJldHVybiB1cmwucGF0aG5hbWUgKyB1cmwuc2VhcmNoOwoJCX0pKCksCgoJCWhhc2hDaGFuZ2VUaW1lb3V0OiAyMDAsCgoJCWhhc2hDaGFuZ2VFbmFibGVUaW1lcjogdW5kZWZpbmVkLAoKCQlpbml0aWFsSHJlZjogdXJsLmhyZWZOb0hhc2gsCgoJCXN0YXRlOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHsKCQkJCS8vIGZpcmVmb3ggYXV0byBkZWNvZGVzIHRoZSB1cmwgd2hlbiB1c2luZyBsb2NhdGlvbi5oYXNoIGJ1dCBub3QgaHJlZgoJCQkJaGFzaDogJC5tb2JpbGUucGF0aC5wYXJzZUxvY2F0aW9uKCkuaGFzaCB8fCAiIyIgKyBzZWxmLmluaXRpYWxGaWxlUGF0aCwKCQkJCXRpdGxlOiBkb2N1bWVudC50aXRsZSwKCgkJCQkvLyBwZXJzaXN0IGFjcm9zcyByZWZyZXNoCgkJCQlpbml0aWFsSHJlZjogc2VsZi5pbml0aWFsSHJlZgoJCQl9OwoJCX0sCgoJCXJlc2V0VUlLZXlzOiBmdW5jdGlvbiggdXJsICkgewoJCQl2YXIgZGlhbG9nID0gJC5tb2JpbGUuZGlhbG9nSGFzaEtleSwKCQkJCXN1YmtleSA9ICImIiArICQubW9iaWxlLnN1YlBhZ2VVcmxLZXksCgkJCQlkaWFsb2dJbmRleCA9IHVybC5pbmRleE9mKCBkaWFsb2cgKTsKCgkJCWlmICggZGlhbG9nSW5kZXggPiAtMSApIHsKCQkJCXVybCA9IHVybC5zbGljZSggMCwgZGlhbG9nSW5kZXggKSArICIjIiArIHVybC5zbGljZSggZGlhbG9nSW5kZXggKTsKCQkJfSBlbHNlIGlmICggdXJsLmluZGV4T2YoIHN1YmtleSApID4gLTEgKSB7CgkJCQl1cmwgPSB1cmwuc3BsaXQoIHN1YmtleSApLmpvaW4oICIjIiArIHN1YmtleSApOwoJCQl9CgoJCQlyZXR1cm4gdXJsOwoJCX0sCgoJCS8vIFRPRE8gc29ydCBvdXQgYSBzaW5nbGUgYmFycmllciB0byBoYXNoY2hhbmdlIGZ1bmN0aW9uYWxpdHkKCQluZXh0SGFzaENoYW5nZVByZXZlbnRlZDogZnVuY3Rpb24oIHZhbHVlICkgewoJCQkkLm1vYmlsZS51cmxIaXN0b3J5Lmlnbm9yZU5leHRIYXNoQ2hhbmdlID0gdmFsdWU7CgkJCXNlbGYub25IYXNoQ2hhbmdlRGlzYWJsZWQgPSB2YWx1ZTsKCQl9LAoKCQkvLyBvbiBoYXNoIGNoYW5nZSB3ZSB3YW50IHRvIGNsZWFuIHVwIHRoZSB1cmwKCQkvLyBOT1RFIHRoaXMgdGFrZXMgcGxhY2UgKmFmdGVyKiB0aGUgdmFuaWxsYSBuYXZpZ2F0aW9uIGhhc2ggY2hhbmdlCgkJLy8gaGFuZGxpbmcgaGFzIHRha2VuIHBsYWNlIGFuZCBzZXQgdGhlIHN0YXRlIG9mIHRoZSBET00KCQlvbkhhc2hDaGFuZ2U6IGZ1bmN0aW9uKCBlICkgewoJCQkvLyBkaXNhYmxlIHRoaXMgaGFzaCBjaGFuZ2UKCQkJaWYgKCBzZWxmLm9uSGFzaENoYW5nZURpc2FibGVkICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQl2YXIgaHJlZiwgc3RhdGUsCgkJCQkvLyBmaXJlZm94IGF1dG8gZGVjb2RlcyB0aGUgdXJsIHdoZW4gdXNpbmcgbG9jYXRpb24uaGFzaCBidXQgbm90IGhyZWYKCQkJCWhhc2ggPSAkLm1vYmlsZS5wYXRoLnBhcnNlTG9jYXRpb24oKS5oYXNoLAoJCQkJaXNQYXRoID0gJC5tb2JpbGUucGF0aC5pc1BhdGgoIGhhc2ggKSwKCQkJCXJlc29sdXRpb25VcmwgPSBpc1BhdGggPyAkLm1vYmlsZS5wYXRoLmdldExvY2F0aW9uKCkgOiAkLm1vYmlsZS5nZXREb2N1bWVudFVybCgpOwoKCQkJaGFzaCA9IGlzUGF0aCA/IGhhc2gucmVwbGFjZSggIiMiLCAiIiApIDogaGFzaDsKCgoJCQkvLyBwcm9wdWxhdGUgdGhlIGhhc2ggd2hlbiBpdHMgbm90IGF2YWlsYWJsZQoJCQlzdGF0ZSA9IHNlbGYuc3RhdGUoKTsKCgkJCS8vIG1ha2UgdGhlIGhhc2ggYWJvbHV0ZSB3aXRoIHRoZSBjdXJyZW50IGhyZWYKCQkJaHJlZiA9ICQubW9iaWxlLnBhdGgubWFrZVVybEFic29sdXRlKCBoYXNoLCByZXNvbHV0aW9uVXJsICk7CgoJCQlpZiAoIGlzUGF0aCApIHsKCQkJCWhyZWYgPSBzZWxmLnJlc2V0VUlLZXlzKCBocmVmICk7CgkJCX0KCgkJCS8vIHJlcGxhY2UgdGhlIGN1cnJlbnQgdXJsIHdpdGggdGhlIG5ldyBocmVmIGFuZCBzdG9yZSB0aGUgc3RhdGUKCQkJLy8gTm90ZSB0aGF0IGluIHNvbWUgY2FzZXMgd2UgbWlnaHQgYmUgcmVwbGFjaW5nIGFuIHVybCB3aXRoIHRoZQoJCQkvLyBzYW1lIHVybC4gV2UgZG8gdGhpcyBhbnl3YXlzIGJlY2F1c2Ugd2UgbmVlZCB0byBtYWtlIHN1cmUgdGhhdAoJCQkvLyBhbGwgb2Ygb3VyIGhpc3RvcnkgZW50cmllcyBoYXZlIGEgc3RhdGUgb2JqZWN0IGFzc29jaWF0ZWQgd2l0aAoJCQkvLyB0aGVtLiBUaGlzIGFsbG93cyB1cyB0byB3b3JrIGFyb3VuZCB0aGUgY2FzZSB3aGVyZSAkLm1vYmlsZS5iYWNrKCkKCQkJLy8gaXMgY2FsbGVkIHRvIHRyYW5zaXRpb24gZnJvbSBhbiBleHRlcm5hbCBwYWdlIHRvIGFuIGVtYmVkZGVkIHBhZ2UuCgkJCS8vIEluIHRoYXQgcGFydGljdWxhciBjYXNlLCBhIGhhc2hjaGFuZ2UgZXZlbnQgaXMgKk5PVCogZ2VuZXJhdGVkIGJ5IHRoZSBicm93c2VyLgoJCQkvLyBFbnN1cmluZyBlYWNoIGhpc3RvcnkgZW50cnkgaGFzIGEgc3RhdGUgb2JqZWN0IG1lYW5zIHRoYXQgb25Qb3BTdGF0ZSgpCgkJCS8vIHdpbGwgYWx3YXlzIHRyaWdnZXIgb3VyIGhhc2hjaGFuZ2UgY2FsbGJhY2sgZXZlbiB3aGVuIGEgaGFzaGNoYW5nZSBldmVudAoJCQkvLyBpcyBub3QgZmlyZWQuCgkJCWhpc3RvcnkucmVwbGFjZVN0YXRlKCBzdGF0ZSwgZG9jdW1lbnQudGl0bGUsIGhyZWYgKTsKCQl9LAoKCQkvLyBvbiBwb3BzdGF0ZSAoaWUgYmFjayBvciBmb3J3YXJkKSB3ZSBuZWVkIHRvIHJlcGxhY2UgdGhlIGhhc2ggdGhhdCB3YXMgdGhlcmUgcHJldmlvdXNseQoJCS8vIGNsZWFuZWQgdXAgYnkgdGhlIGFkZGl0aW9uYWwgaGFzaCBoYW5kbGluZwoJCW9uUG9wU3RhdGU6IGZ1bmN0aW9uKCBlICkgewoJCQl2YXIgcG9wcGVkU3RhdGUgPSBlLm9yaWdpbmFsRXZlbnQuc3RhdGUsCgkJCQlmcm9tSGFzaCwgdG9IYXNoLCBoYXNoQ2hhbmdlZDsKCgkJCS8vIGlmIHRoZXJlJ3Mgbm8gc3RhdGUgaXRzIG5vdCBhIHBvcHN0YXRlIHdlIGNhcmUgYWJvdXQsIGVnIGNocm9tZSdzIGluaXRpYWwgcG9wc3RhdGUKCQkJaWYgKCBwb3BwZWRTdGF0ZSApIHsKCQkJCS8vIGlmIHdlIGdldCB0d28gcG9wIHN0YXRlcyBpbiB1bmRlciB0aGlzLmhhc2hDaGFuZ2VUaW1lb3V0CgkJCQkvLyBtYWtlIHN1cmUgdG8gY2xlYXIgYW55IHRpbWVyIHNldCBmb3IgdGhlIHByZXZpb3VzIGNoYW5nZQoJCQkJY2xlYXJUaW1lb3V0KCBzZWxmLmhhc2hDaGFuZ2VFbmFibGVUaW1lciApOwoKCQkJCS8vIG1ha2Ugc3VyZSB0byBlbmFibGUgaGFzaCBoYW5kbGluZyBmb3IgdGhlIHRoZSBfaGFuZGxlSGFzaENoYW5nZSBjYWxsCgkJCQlzZWxmLm5leHRIYXNoQ2hhbmdlUHJldmVudGVkKCBmYWxzZSApOwoKCQkJCS8vIGNoYW5nZSB0aGUgcGFnZSBiYXNlZCBvbiB0aGUgaGFzaCBpbiB0aGUgcG9wcGVkIHN0YXRlCgkJCQkkLm1vYmlsZS5faGFuZGxlSGFzaENoYW5nZSggcG9wcGVkU3RhdGUuaGFzaCApOwoKCQkJCS8vIHByZXZlbnQgYW55IGhhc2hjaGFuZ2UgaW4gdGhlIG5leHQgc2VsZi5oYXNoQ2hhbmdlVGltZW91dAoJCQkJc2VsZi5uZXh0SGFzaENoYW5nZVByZXZlbnRlZCggdHJ1ZSApOwoKCQkJCS8vIHJlLWVuYWJsZSBoYXNoIGNoYW5nZSBoYW5kbGluZyBhZnRlciBzd2FsbG93aW5nIGEgcG9zc2libGUgaGFzaAoJCQkJLy8gY2hhbmdlIGV2ZW50IHRoYXQgY29tZXMgb24gYWxsIHBvcHN0YXRlcyBjb3VydGVzeSBvZiBicm93c2VycyBsaWtlIEFuZHJvaWQKCQkJCXNlbGYuaGFzaENoYW5nZUVuYWJsZVRpbWVyID0gc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQkJc2VsZi5uZXh0SGFzaENoYW5nZVByZXZlbnRlZCggZmFsc2UgKTsKCQkJCX0sIHNlbGYuaGFzaENoYW5nZVRpbWVvdXQgKTsKCQkJfQoJCX0sCgoJCWluaXQ6IGZ1bmN0aW9uKCkgewoJCQkkd2luLmJpbmQoICJoYXNoY2hhbmdlIiwgc2VsZi5vbkhhc2hDaGFuZ2UgKTsKCgkJCS8vIEhhbmRsZSBwb3BzdGF0ZSBldmVudHMgdGhlIG9jY3VyIHRocm91Z2ggaGlzdG9yeSBjaGFuZ2VzCgkJCSR3aW4uYmluZCggInBvcHN0YXRlIiwgc2VsZi5vblBvcFN0YXRlICk7CgoJCQkvLyBpZiB0aGVyZSdzIG5vIGhhc2gsIHdlIG5lZWQgdG8gcmVwbGFjZXN0YXRlIGZvciByZXR1cm5pbmcgdG8gaG9tZQoJCQlpZiAoIGxvY2F0aW9uLmhhc2ggPT09ICIiICkgewoJCQkJaGlzdG9yeS5yZXBsYWNlU3RhdGUoIHNlbGYuc3RhdGUoKSwgZG9jdW1lbnQudGl0bGUsICQubW9iaWxlLnBhdGguZ2V0TG9jYXRpb24oKSApOwoJCQl9CgkJfQoJfSk7CgoJLy8gV2UgbmVlZCB0byBpbml0IHdoZW4gIm1vYmlsZWluaXQiLCAiZG9tcmVhZHkiLCBhbmQgIm5hdnJlYWR5IiBoYXZlIGFsbCBoYXBwZW5lZAoJJC53aGVuKCBkb21yZWFkeURlZmVycmVkLCBtb2JpbGVpbml0RGVmZXJyZWQsICQubW9iaWxlLm5hdnJlYWR5RGVmZXJyZWQgKS5kb25lKGZ1bmN0aW9uKCkgewoJCWlmICggJC5tb2JpbGUucHVzaFN0YXRlRW5hYmxlZCAmJiAkLnN1cHBvcnQucHVzaFN0YXRlICkgewoJCQlwdXNoU3RhdGVIYW5kbGVyLmluaXQoKTsKCQl9Cgl9KTsKfSkoIGpRdWVyeSwgdGhpcyApOwoKLyoKKiBmYWxsYmFjayB0cmFuc2l0aW9uIGZvciBmbGlwIGluIG5vbi0zRCBzdXBwb3J0aW5nIGJyb3dzZXJzICh3aGljaCB0ZW5kIHRvIGhhbmRsZSBjb21wbGV4IHRyYW5zaXRpb25zIHBvb3JseSBpbiBnZW5lcmFsCiovCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrcy5mbGlwID0gImZhZGUiOwoKfSkoIGpRdWVyeSwgdGhpcyApOwovKgoqIGZhbGxiYWNrIHRyYW5zaXRpb24gZm9yIGZsb3cgaW4gbm9uLTNEIHN1cHBvcnRpbmcgYnJvd3NlcnMgKHdoaWNoIHRlbmQgdG8gaGFuZGxlIGNvbXBsZXggdHJhbnNpdGlvbnMgcG9vcmx5IGluIGdlbmVyYWwKKi8KCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS50cmFuc2l0aW9uRmFsbGJhY2tzLmZsb3cgPSAiZmFkZSI7Cgp9KSggalF1ZXJ5LCB0aGlzICk7Ci8qCiogZmFsbGJhY2sgdHJhbnNpdGlvbiBmb3IgcG9wIGluIG5vbi0zRCBzdXBwb3J0aW5nIGJyb3dzZXJzICh3aGljaCB0ZW5kIHRvIGhhbmRsZSBjb21wbGV4IHRyYW5zaXRpb25zIHBvb3JseSBpbiBnZW5lcmFsCiovCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrcy5wb3AgPSAiZmFkZSI7Cgp9KSggalF1ZXJ5LCB0aGlzICk7Ci8qCiogZmFsbGJhY2sgdHJhbnNpdGlvbiBmb3Igc2xpZGUgaW4gbm9uLTNEIHN1cHBvcnRpbmcgYnJvd3NlcnMgKHdoaWNoIHRlbmQgdG8gaGFuZGxlIGNvbXBsZXggdHJhbnNpdGlvbnMgcG9vcmx5IGluIGdlbmVyYWwKKi8KCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgovLyBVc2UgdGhlIHNpbXVsdGFuZW91cyB0cmFuc2l0aW9ucyBoYW5kbGVyIGZvciBzbGlkZSB0cmFuc2l0aW9ucwokLm1vYmlsZS50cmFuc2l0aW9uSGFuZGxlcnMuc2xpZGUgPSAkLm1vYmlsZS50cmFuc2l0aW9uSGFuZGxlcnMuc2ltdWx0YW5lb3VzOwoKLy8gU2V0IHRoZSBzbGlkZSB0cmFuc2l0aW9ucydzIGZhbGxiYWNrIHRvICJmYWRlIgokLm1vYmlsZS50cmFuc2l0aW9uRmFsbGJhY2tzLnNsaWRlID0gImZhZGUiOwoKfSkoIGpRdWVyeSwgdGhpcyApOwovKgoqIGZhbGxiYWNrIHRyYW5zaXRpb24gZm9yIHNsaWRlZG93biBpbiBub24tM0Qgc3VwcG9ydGluZyBicm93c2VycyAod2hpY2ggdGVuZCB0byBoYW5kbGUgY29tcGxleCB0cmFuc2l0aW9ucyBwb29ybHkgaW4gZ2VuZXJhbAoqLwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLnRyYW5zaXRpb25GYWxsYmFja3Muc2xpZGVkb3duID0gImZhZGUiOwoKfSkoIGpRdWVyeSwgdGhpcyApOwovKgoqIGZhbGxiYWNrIHRyYW5zaXRpb24gZm9yIHNsaWRlZmFkZSBpbiBub24tM0Qgc3VwcG9ydGluZyBicm93c2VycyAod2hpY2ggdGVuZCB0byBoYW5kbGUgY29tcGxleCB0cmFuc2l0aW9ucyBwb29ybHkgaW4gZ2VuZXJhbAoqLwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCi8vIFNldCB0aGUgc2xpZGUgdHJhbnNpdGlvbnMncyBmYWxsYmFjayB0byAiZmFkZSIKJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrcy5zbGlkZWZhZGUgPSAiZmFkZSI7Cgp9KSggalF1ZXJ5LCB0aGlzICk7Ci8qCiogZmFsbGJhY2sgdHJhbnNpdGlvbiBmb3Igc2xpZGV1cCBpbiBub24tM0Qgc3VwcG9ydGluZyBicm93c2VycyAod2hpY2ggdGVuZCB0byBoYW5kbGUgY29tcGxleCB0cmFuc2l0aW9ucyBwb29ybHkgaW4gZ2VuZXJhbAoqLwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLnRyYW5zaXRpb25GYWxsYmFja3Muc2xpZGV1cCA9ICJmYWRlIjsKCn0pKCBqUXVlcnksIHRoaXMgKTsKLyoKKiBmYWxsYmFjayB0cmFuc2l0aW9uIGZvciB0dXJuIGluIG5vbi0zRCBzdXBwb3J0aW5nIGJyb3dzZXJzICh3aGljaCB0ZW5kIHRvIGhhbmRsZSBjb21wbGV4IHRyYW5zaXRpb25zIHBvb3JseSBpbiBnZW5lcmFsCiovCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrcy50dXJuID0gImZhZGUiOwoKfSkoIGpRdWVyeSwgdGhpcyApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS5wYWdlLnByb3RvdHlwZS5vcHRpb25zLmRlZ3JhZGVJbnB1dHMgPSB7Cgljb2xvcjogZmFsc2UsCglkYXRlOiBmYWxzZSwKCWRhdGV0aW1lOiBmYWxzZSwKCSJkYXRldGltZS1sb2NhbCI6IGZhbHNlLAoJZW1haWw6IGZhbHNlLAoJbW9udGg6IGZhbHNlLAoJbnVtYmVyOiBmYWxzZSwKCXJhbmdlOiAibnVtYmVyIiwKCXNlYXJjaDogInRleHQiLAoJdGVsOiBmYWxzZSwKCXRpbWU6IGZhbHNlLAoJdXJsOiBmYWxzZSwKCXdlZWs6IGZhbHNlCn07CgoKLy9hdXRvIHNlbGYtaW5pdCB3aWRnZXRzCiQoIGRvY3VtZW50ICkuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKSB7CgoJdmFyIHBhZ2UgPSAkLm1vYmlsZS5jbG9zZXN0UGFnZURhdGEoICQoIGUudGFyZ2V0ICkgKSwgb3B0aW9uczsKCglpZiAoICFwYWdlICkgewoJCXJldHVybjsKCX0KCglvcHRpb25zID0gcGFnZS5vcHRpb25zOwoKCS8vIGRlZ3JhZGUgaW5wdXRzIHRvIGF2b2lkIHBvb3JseSBpbXBsZW1lbnRlZCBuYXRpdmUgZnVuY3Rpb25hbGl0eQoJJCggZS50YXJnZXQgKS5maW5kKCAiaW5wdXQiICkubm90KCBwYWdlLmtlZXBOYXRpdmVTZWxlY3RvcigpICkuZWFjaChmdW5jdGlvbigpIHsKCQl2YXIgJHRoaXMgPSAkKCB0aGlzICksCgkJCXR5cGUgPSB0aGlzLmdldEF0dHJpYnV0ZSggInR5cGUiICksCgkJCW9wdFR5cGUgPSBvcHRpb25zLmRlZ3JhZGVJbnB1dHNbIHR5cGUgXSB8fCAidGV4dCI7CgoJCWlmICggb3B0aW9ucy5kZWdyYWRlSW5wdXRzWyB0eXBlIF0gKSB7CgkJCXZhciBodG1sID0gJCggIjxkaXY+IiApLmh0bWwoICR0aGlzLmNsb25lKCkgKS5odG1sKCksCgkJCQkvLyBJbiBJRSBicm93c2VycywgdGhlIHR5cGUgc29tZXRpbWVzIGRvZXNuJ3QgZXhpc3QgaW4gdGhlIGNsb25lZCBtYXJrdXAsIHNvIHdlIHJlcGxhY2UgdGhlIGNsb3NpbmcgdGFnIGluc3RlYWQKCQkJCWhhc1R5cGUgPSBodG1sLmluZGV4T2YoICIgdHlwZT0iICkgPiAtMSwKCQkJCWZpbmRzdHIgPSBoYXNUeXBlID8gL1xzK3R5cGU9WyInXT9cdytbJyJdPy8gOiAvXC8/Pi8sCgkJCQlyZXBzdHIgPSAiIHR5cGU9XCIiICsgb3B0VHlwZSArICJcIiBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJ0eXBlPVwiIiArIHR5cGUgKyAiXCIiICsgKCBoYXNUeXBlID8gIiIgOiAiPiIgKTsKCgkJCSR0aGlzLnJlcGxhY2VXaXRoKCBodG1sLnJlcGxhY2UoIGZpbmRzdHIsIHJlcHN0ciApICk7CgkJfQoJfSk7Cgp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS5kaWFsb2ciLCAkLm1vYmlsZS53aWRnZXQsIHsKCW9wdGlvbnM6IHsKCQljbG9zZUJ0blRleHQ6ICJDbG9zZSIsCgkJb3ZlcmxheVRoZW1lOiAiYSIsCgkJaW5pdFNlbGVjdG9yOiAiOmpxbURhdGEocm9sZT0nZGlhbG9nJykiCgl9LAoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzLAoJCQkkZWwgPSB0aGlzLmVsZW1lbnQsCgkJCWhlYWRlckNsb3NlQnV0dG9uID0gJCggIjxhIGhyZWY9JyMnIGRhdGEtIiArICQubW9iaWxlLm5zICsgImljb249J2RlbGV0ZScgZGF0YS0iICsgJC5tb2JpbGUubnMgKyAiaWNvbnBvcz0nbm90ZXh0Jz4iKyB0aGlzLm9wdGlvbnMuY2xvc2VCdG5UZXh0ICsgIjwvYT4iICksCgkJCWRpYWxvZ1dyYXAgPSAkKCAiPGRpdi8+IiwgewoJCQkJCSJyb2xlIiA6ICJkaWFsb2ciLAoJCQkJCSJjbGFzcyIgOiAidWktZGlhbG9nLWNvbnRhaW4gdWktY29ybmVyLWFsbCB1aS1vdmVybGF5LXNoYWRvdyIKCQkJCX0pOwoKCQkkZWwuYWRkQ2xhc3MoICJ1aS1kaWFsb2cgdWktb3ZlcmxheS0iICsgdGhpcy5vcHRpb25zLm92ZXJsYXlUaGVtZSApOwoKCQkvLyBDbGFzcyB0aGUgbWFya3VwIGZvciBkaWFsb2cgc3R5bGluZwoJCS8vIFNldCBhcmlhIHJvbGUKCQkkZWwKCQkJLndyYXBJbm5lciggZGlhbG9nV3JhcCApCgkJCS5jaGlsZHJlbigpCgkJCQkuZmluZCggIjpqcW1EYXRhKHJvbGU9J2hlYWRlcicpIiApCgkJCQkJLnByZXBlbmQoIGhlYWRlckNsb3NlQnV0dG9uICkKCQkJCS5lbmQoKQoJCQkJLmNoaWxkcmVuKCAnOmZpcnN0LWNoaWxkJykKCQkJCQkuYWRkQ2xhc3MoICJ1aS1jb3JuZXItdG9wIiApCgkJCQkuZW5kKCkKCQkJCS5jaGlsZHJlbiggIjpsYXN0LWNoaWxkIiApCgkJCQkJLmFkZENsYXNzKCAidWktY29ybmVyLWJvdHRvbSIgKTsKCgkJLy8gdGhpcyBtdXN0IGJlIGFuIGFub255bW91cyBmdW5jdGlvbiBzbyB0aGF0IHNlbGVjdCBtZW51IGRpYWxvZ3MgY2FuIHJlcGxhY2UKCQkvLyB0aGUgY2xvc2UgbWV0aG9kLiBUaGlzIGlzIGEgY2hhbmdlIGZyb20gcHJldmlvdXNseSBqdXN0IGRlZmluaW5nIGRhdGEtcmVsPWJhY2sKCQkvLyBvbiB0aGUgYnV0dG9uIGFuZCBsZXR0aW5nIG5hdiBoYW5kbGUgaXQKCQkvLwoJCS8vIFVzZSBjbGljayByYXRoZXIgdGhhbiB2Y2xpY2sgaW4gb3JkZXIgdG8gcHJldmVudCB0aGUgcG9zc2liaWxpdHkgb2YgdW5pbnRlbnRpb25hbGx5CgkJLy8gcmVvcGVuaW5nIHRoZSBkaWFsb2cgaWYgdGhlIGRpYWxvZyBvcGVuaW5nIGl0ZW0gd2FzIGRpcmVjdGx5IHVuZGVyIHRoZSBjbG9zZSBidXR0b24uCgkJaGVhZGVyQ2xvc2VCdXR0b24uYmluZCggImNsaWNrIiwgZnVuY3Rpb24oKSB7CgkJCXNlbGYuY2xvc2UoKTsKCQl9KTsKCgkJLyogYmluZCBldmVudHMKCQkJLSBjbGlja3MgYW5kIHN1Ym1pdHMgc2hvdWxkIHVzZSB0aGUgY2xvc2luZyB0cmFuc2l0aW9uIHRoYXQgdGhlIGRpYWxvZyBvcGVuZWQgd2l0aAoJCQkJdW5sZXNzIGEgZGF0YS10cmFuc2l0aW9uIGlzIHNwZWNpZmllZCBvbiB0aGUgbGluay9mb3JtCgkJCS0gaWYgdGhlIGNsaWNrIHdhcyBvbiB0aGUgY2xvc2UgYnV0dG9uLCBvciB0aGUgbGluayBoYXMgYSBkYXRhLXJlbD0iYmFjayIgaXQnbGwgZ28gYmFjayBpbiBoaXN0b3J5IG5hdHVyYWxseQoJCSovCgkJJGVsLmJpbmQoICJ2Y2xpY2sgc3VibWl0IiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQl2YXIgJHRhcmdldCA9ICQoIGV2ZW50LnRhcmdldCApLmNsb3Nlc3QoIGV2ZW50LnR5cGUgPT09ICJ2Y2xpY2siID8gImEiIDogImZvcm0iICksCgkJCQlhY3RpdmU7CgoJCQlpZiAoICR0YXJnZXQubGVuZ3RoICYmICEkdGFyZ2V0LmpxbURhdGEoICJ0cmFuc2l0aW9uIiApICkgewoKCQkJCWFjdGl2ZSA9ICQubW9iaWxlLnVybEhpc3RvcnkuZ2V0QWN0aXZlKCkgfHwge307CgoJCQkJJHRhcmdldC5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidHJhbnNpdGlvbiIsICggYWN0aXZlLnRyYW5zaXRpb24gfHwgJC5tb2JpbGUuZGVmYXVsdERpYWxvZ1RyYW5zaXRpb24gKSApCgkJCQkJLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJkaXJlY3Rpb24iLCAicmV2ZXJzZSIgKTsKCQkJfQoJCX0pCgkJLmJpbmQoICJwYWdlaGlkZSIsIGZ1bmN0aW9uKCBlLCB1aSApIHsKCQkJJCggdGhpcyApLmZpbmQoICIuIiArICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICkubm90KCAiLnVpLXNsaWRlci1iZyIgKS5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQl9KQoJCS8vIE92ZXJyaWRlIHRoZSB0aGVtZSBzZXQgYnkgdGhlIHBhZ2UgcGx1Z2luIG9uIHBhZ2VzaG93CgkJLmJpbmQoICJwYWdlYmVmb3Jlc2hvdyIsIGZ1bmN0aW9uKCkgewoJCQlzZWxmLl9pc0Nsb3NlYWJsZSA9IHRydWU7CgkJCWlmICggc2VsZi5vcHRpb25zLm92ZXJsYXlUaGVtZSApIHsKCQkJCXNlbGYuZWxlbWVudAoJCQkJCS5wYWdlKCAicmVtb3ZlQ29udGFpbmVyQmFja2dyb3VuZCIgKQoJCQkJCS5wYWdlKCAic2V0Q29udGFpbmVyQmFja2dyb3VuZCIsIHNlbGYub3B0aW9ucy5vdmVybGF5VGhlbWUgKTsKCQkJfQoJCX0pOwoJfSwKCgkvLyBDbG9zZSBtZXRob2QgZ29lcyBiYWNrIGluIGhpc3RvcnkKCWNsb3NlOiBmdW5jdGlvbigpIHsKCQl2YXIgZHN0OwoKCQlpZiAoIHRoaXMuX2lzQ2xvc2VhYmxlICkgewoJCQl0aGlzLl9pc0Nsb3NlYWJsZSA9IGZhbHNlOwoJCQlpZiAoICQubW9iaWxlLmhhc2hMaXN0ZW5pbmdFbmFibGVkICkgewoJCQkJJC5tb2JpbGUuYmFjaygpOwoJCQl9IGVsc2UgewoJCQkJZHN0ID0gJC5tb2JpbGUudXJsSGlzdG9yeS5nZXRQcmV2KCkudXJsOwoJCQkJaWYgKCAhJC5tb2JpbGUucGF0aC5pc1BhdGgoIGRzdCApICkgewoJCQkJCWRzdCA9ICQubW9iaWxlLnBhdGgubWFrZVVybEFic29sdXRlKCAiIyIgKyBkc3QgKTsKCQkJCX0KCgkJCQkkLm1vYmlsZS5jaGFuZ2VQYWdlKCBkc3QsIHsgY2hhbmdlSGFzaDogZmFsc2UsIGZyb21IYXNoQ2hhbmdlOiB0cnVlIH0gKTsKCQkJfQoJCX0KCX0KfSk7CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJCggZG9jdW1lbnQgKS5kZWxlZ2F0ZSggJC5tb2JpbGUuZGlhbG9nLnByb3RvdHlwZS5vcHRpb25zLmluaXRTZWxlY3RvciwgInBhZ2VjcmVhdGUiLCBmdW5jdGlvbigpIHsKCSQubW9iaWxlLmRpYWxvZy5wcm90b3R5cGUuZW5oYW5jZSggdGhpcyApOwp9KTsKCn0pKCBqUXVlcnksIHRoaXMgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUucGFnZS5wcm90b3R5cGUub3B0aW9ucy5iYWNrQnRuVGV4dCAgPSAiQmFjayI7CiQubW9iaWxlLnBhZ2UucHJvdG90eXBlLm9wdGlvbnMuYWRkQmFja0J0biAgID0gZmFsc2U7CiQubW9iaWxlLnBhZ2UucHJvdG90eXBlLm9wdGlvbnMuYmFja0J0blRoZW1lID0gbnVsbDsKJC5tb2JpbGUucGFnZS5wcm90b3R5cGUub3B0aW9ucy5oZWFkZXJUaGVtZSAgPSAiYSI7CiQubW9iaWxlLnBhZ2UucHJvdG90eXBlLm9wdGlvbnMuZm9vdGVyVGhlbWUgID0gImEiOwokLm1vYmlsZS5wYWdlLnByb3RvdHlwZS5vcHRpb25zLmNvbnRlbnRUaGVtZSA9IG51bGw7CgovLyBOT1RFIGJpbmQgdXNlZCB0byBmb3JjZSB0aGlzIGJpbmRpbmcgdG8gcnVuIGJlZm9yZSB0aGUgYnV0dG9uTWFya3VwIGJpbmRpbmcKLy8gICAgICB3aGljaCBleHBlY3RzIC51aS1mb290ZXIgdG9wIGJlIGFwcGxpZWQgaW4gaXRzIGdpZ2FudGljIHNlbGVjdG9yCi8vIFRPRE8gcmVtb3ZlIHRoZSBidXR0b25NYXJrdXAgZ2lhbnQgc2VsZWN0b3IgYW5kIG1vdmUgaXQgdG8gdGhlIHZhcmlvdXMgbW9kdWxlcwovLyAgICAgIG9uIHdoaWNoIGl0IGRlcGVuZHMKJCggZG9jdW1lbnQgKS5iaW5kKCAicGFnZWNyZWF0ZSIsIGZ1bmN0aW9uKCBlICkgewoJdmFyICRwYWdlID0gJCggZS50YXJnZXQgKSwKCQlvID0gJHBhZ2UuZGF0YSggInBhZ2UiICkub3B0aW9ucywKCQlwYWdlUm9sZSA9ICRwYWdlLmpxbURhdGEoICJyb2xlIiApLAoJCXBhZ2VUaGVtZSA9IG8udGhlbWU7CgoJJCggIjpqcW1EYXRhKHJvbGU9J2hlYWRlcicpLCA6anFtRGF0YShyb2xlPSdmb290ZXInKSwgOmpxbURhdGEocm9sZT0nY29udGVudCcpIiwgJHBhZ2UgKQoJCS5qcW1FbmhhbmNlYWJsZSgpCgkJLmVhY2goZnVuY3Rpb24oKSB7CgoJCXZhciAkdGhpcyA9ICQoIHRoaXMgKSwKCQkJcm9sZSA9ICR0aGlzLmpxbURhdGEoICJyb2xlIiApLAoJCQl0aGVtZSA9ICR0aGlzLmpxbURhdGEoICJ0aGVtZSIgKSwKCQkJY29udGVudFRoZW1lID0gdGhlbWUgfHwgby5jb250ZW50VGhlbWUgfHwgKCBwYWdlUm9sZSA9PT0gImRpYWxvZyIgJiYgcGFnZVRoZW1lICksCgkJCSRoZWFkZXJhbmNob3JzLAoJCQlsZWZ0YnRuLAoJCQlyaWdodGJ0biwKCQkJYmFja0J0bjsKCgkJJHRoaXMuYWRkQ2xhc3MoICJ1aS0iICsgcm9sZSApOwoKCQkvL2FwcGx5IHRoZW1pbmcgYW5kIG1hcmt1cCBtb2RpZmljYXRpb25zIHRvIHBhZ2UsaGVhZGVyLGNvbnRlbnQsZm9vdGVyCgkJaWYgKCByb2xlID09PSAiaGVhZGVyIiB8fCByb2xlID09PSAiZm9vdGVyIiApIHsKCgkJCXZhciB0aGlzVGhlbWUgPSB0aGVtZSB8fCAoIHJvbGUgPT09ICJoZWFkZXIiID8gby5oZWFkZXJUaGVtZSA6IG8uZm9vdGVyVGhlbWUgKSB8fCBwYWdlVGhlbWU7CgoJCQkkdGhpcwoJCQkJLy9hZGQgdGhlbWUgY2xhc3MKCQkJCS5hZGRDbGFzcyggInVpLWJhci0iICsgdGhpc1RoZW1lICkKCQkJCS8vIEFkZCBBUklBIHJvbGUKCQkJCS5hdHRyKCAicm9sZSIsIHJvbGUgPT09ICJoZWFkZXIiID8gImJhbm5lciIgOiAiY29udGVudGluZm8iICk7CgoJCQlpZiAoIHJvbGUgPT09ICJoZWFkZXIiKSB7CgkJCQkvLyBSaWdodCxsZWZ0IGJ1dHRvbnMKCQkJCSRoZWFkZXJhbmNob3JzCT0gJHRoaXMuY2hpbGRyZW4oICJhLCBidXR0b24iICk7CgkJCQlsZWZ0YnRuCT0gJGhlYWRlcmFuY2hvcnMuaGFzQ2xhc3MoICJ1aS1idG4tbGVmdCIgKTsKCQkJCXJpZ2h0YnRuID0gJGhlYWRlcmFuY2hvcnMuaGFzQ2xhc3MoICJ1aS1idG4tcmlnaHQiICk7CgoJCQkJbGVmdGJ0biA9IGxlZnRidG4gfHwgJGhlYWRlcmFuY2hvcnMuZXEoIDAgKS5ub3QoICIudWktYnRuLXJpZ2h0IiApLmFkZENsYXNzKCAidWktYnRuLWxlZnQiICkubGVuZ3RoOwoKCQkJCXJpZ2h0YnRuID0gcmlnaHRidG4gfHwgJGhlYWRlcmFuY2hvcnMuZXEoIDEgKS5hZGRDbGFzcyggInVpLWJ0bi1yaWdodCIgKS5sZW5ndGg7CgkJCX0KCgkJCS8vIEF1dG8tYWRkIGJhY2sgYnRuIG9uIHBhZ2VzIGJleW9uZCBmaXJzdCB2aWV3CgkJCWlmICggby5hZGRCYWNrQnRuICYmCgkJCQlyb2xlID09PSAiaGVhZGVyIiAmJgoJCQkJJCggIi51aS1wYWdlIiApLmxlbmd0aCA+IDEgJiYKCQkJCSRwYWdlLmpxbURhdGEoICJ1cmwiICkgIT09ICQubW9iaWxlLnBhdGguc3RyaXBIYXNoKCBsb2NhdGlvbi5oYXNoICkgJiYKCQkJCSFsZWZ0YnRuICkgewoKCQkJCWJhY2tCdG4gPSAkKCAiPGEgaHJlZj0namF2YXNjcmlwdDp2b2lkKDApOycgY2xhc3M9J3VpLWJ0bi1sZWZ0JyBkYXRhLSIrICQubW9iaWxlLm5zICsicmVsPSdiYWNrJyBkYXRhLSIrICQubW9iaWxlLm5zICsiaWNvbj0nYXJyb3ctbCc+Iisgby5iYWNrQnRuVGV4dCArIjwvYT4iICkKCQkJCQkvLyBJZiB0aGVtZSBpcyBwcm92aWRlZCwgb3ZlcnJpZGUgZGVmYXVsdCBpbmhlcml0YW5jZQoJCQkJCS5hdHRyKCAiZGF0YS0iKyAkLm1vYmlsZS5ucyArInRoZW1lIiwgby5iYWNrQnRuVGhlbWUgfHwgdGhpc1RoZW1lICkKCQkJCQkucHJlcGVuZFRvKCAkdGhpcyApOwoJCQl9CgoJCQkvLyBQYWdlIHRpdGxlCgkJCSR0aGlzLmNoaWxkcmVuKCAiaDEsIGgyLCBoMywgaDQsIGg1LCBoNiIgKQoJCQkJLmFkZENsYXNzKCAidWktdGl0bGUiICkKCQkJCS8vIFJlZ2FyZGxlc3Mgb2YgaCBlbGVtZW50IG51bWJlciBpbiBzcmMsIGl0IGJlY29tZXMgaDEgZm9yIHRoZSBlbmhhbmNlZCBwYWdlCgkJCQkuYXR0cih7CgkJCQkJInJvbGUiOiAiaGVhZGluZyIsCgkJCQkJImFyaWEtbGV2ZWwiOiAiMSIKCQkJCX0pOwoKCQl9IGVsc2UgaWYgKCByb2xlID09PSAiY29udGVudCIgKSB7CgkJCWlmICggY29udGVudFRoZW1lICkgewoJCQkJJHRoaXMuYWRkQ2xhc3MoICJ1aS1ib2R5LSIgKyAoIGNvbnRlbnRUaGVtZSApICk7CgkJCX0KCgkJCS8vIEFkZCBBUklBIHJvbGUKCQkJJHRoaXMuYXR0ciggInJvbGUiLCAibWFpbiIgKTsKCQl9Cgl9KTsKfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCi8vIGZpbHRlciBmdW5jdGlvbiByZW1vdmVzIHdoaXRlc3BhY2UgYmV0d2VlbiBsYWJlbCBhbmQgZm9ybSBlbGVtZW50IHNvIHdlIGNhbiB1c2UgaW5saW5lLWJsb2NrIChub2RlVHlwZSAzID0gdGV4dCkKJC5mbi5maWVsZGNvbnRhaW4gPSBmdW5jdGlvbiggb3B0aW9ucyApIHsKCXJldHVybiB0aGlzCgkJLmFkZENsYXNzKCAidWktZmllbGQtY29udGFpbiB1aS1ib2R5IHVpLWJyIiApCgkJLmNvbnRlbnRzKCkuZmlsdGVyKCBmdW5jdGlvbigpIHsKCQkJcmV0dXJuICggdGhpcy5ub2RlVHlwZSA9PT0gMyAmJiAhL1xTLy50ZXN0KCB0aGlzLm5vZGVWYWx1ZSApICk7CgkJfSkucmVtb3ZlKCk7Cn07CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJCggZG9jdW1lbnQgKS5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApIHsKCSQoICI6anFtRGF0YShyb2xlPSdmaWVsZGNvbnRhaW4nKSIsIGUudGFyZ2V0ICkuanFtRW5oYW5jZWFibGUoKS5maWVsZGNvbnRhaW4oKTsKfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQuZm4uZ3JpZCA9IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKCgkJdmFyICR0aGlzID0gJCggdGhpcyApLAoJCQlvID0gJC5leHRlbmQoewoJCQkJZ3JpZDogbnVsbAoJCQl9LCBvcHRpb25zICksCgkJCSRraWRzID0gJHRoaXMuY2hpbGRyZW4oKSwKCQkJZ3JpZENvbHMgPSB7IHNvbG86MSwgYToyLCBiOjMsIGM6NCwgZDo1IH0sCgkJCWdyaWQgPSBvLmdyaWQsCgkJCWl0ZXJhdG9yOwoKCQkJaWYgKCAhZ3JpZCApIHsKCQkJCWlmICggJGtpZHMubGVuZ3RoIDw9IDUgKSB7CgkJCQkJZm9yICggdmFyIGxldHRlciBpbiBncmlkQ29scyApIHsKCQkJCQkJaWYgKCBncmlkQ29sc1sgbGV0dGVyIF0gPT09ICRraWRzLmxlbmd0aCApIHsKCQkJCQkJCWdyaWQgPSBsZXR0ZXI7CgkJCQkJCX0KCQkJCQl9CgkJCQl9IGVsc2UgewoJCQkJCWdyaWQgPSAiYSI7CgkJCQkJJHRoaXMuYWRkQ2xhc3MoICJ1aS1ncmlkLWR1byIgKTsKCQkJCX0KCQkJfQoJCQlpdGVyYXRvciA9IGdyaWRDb2xzW2dyaWRdOwoKCQkkdGhpcy5hZGRDbGFzcyggInVpLWdyaWQtIiArIGdyaWQgKTsKCgkJJGtpZHMuZmlsdGVyKCAiOm50aC1jaGlsZCgiICsgaXRlcmF0b3IgKyAibisxKSIgKS5hZGRDbGFzcyggInVpLWJsb2NrLWEiICk7CgoJCWlmICggaXRlcmF0b3IgPiAxICkgewoJCQkka2lkcy5maWx0ZXIoICI6bnRoLWNoaWxkKCIgKyBpdGVyYXRvciArICJuKzIpIiApLmFkZENsYXNzKCAidWktYmxvY2stYiIgKTsKCQl9CgkJaWYgKCBpdGVyYXRvciA+IDIgKSB7CgkJCSRraWRzLmZpbHRlciggIjpudGgtY2hpbGQoIiArIGl0ZXJhdG9yICsgIm4rMykiICkuYWRkQ2xhc3MoICJ1aS1ibG9jay1jIiApOwoJCX0KCQlpZiAoIGl0ZXJhdG9yID4gMyApIHsKCQkJJGtpZHMuZmlsdGVyKCAiOm50aC1jaGlsZCgiICsgaXRlcmF0b3IgKyAibis0KSIgKS5hZGRDbGFzcyggInVpLWJsb2NrLWQiICk7CgkJfQoJCWlmICggaXRlcmF0b3IgPiA0ICkgewoJCQkka2lkcy5maWx0ZXIoICI6bnRoLWNoaWxkKCIgKyBpdGVyYXRvciArICJuKzUpIiApLmFkZENsYXNzKCAidWktYmxvY2stZSIgKTsKCQl9Cgl9KTsKfTsKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokKCBkb2N1bWVudCApLmJpbmQoICJwYWdlY3JlYXRlIGNyZWF0ZSIsIGZ1bmN0aW9uKCBlICkgewoJJCggIjpqcW1EYXRhKHJvbGU9J25vanMnKSIsIGUudGFyZ2V0ICkuYWRkQ2xhc3MoICJ1aS1ub2pzIiApOwoJCn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLmZuLmJ1dHRvbk1hcmt1cCA9IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJdmFyICR3b3JraW5nU2V0ID0gdGhpcywKCQltYXBUb0RhdGFBdHRyID0gZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CgkJCWUuc2V0QXR0cmlidXRlKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyBrZXksIHZhbHVlICk7CgkJCWVsLmpxbURhdGEoIGtleSwgdmFsdWUgKTsKCQl9OwoKCS8vIEVuZm9yY2Ugb3B0aW9ucyB0byBiZSBvZiB0eXBlIHN0cmluZwoJb3B0aW9ucyA9ICggb3B0aW9ucyAmJiAoICQudHlwZSggb3B0aW9ucyApID09PSAib2JqZWN0IiApICk/IG9wdGlvbnMgOiB7fTsKCWZvciAoIHZhciBpID0gMDsgaSA8ICR3b3JraW5nU2V0Lmxlbmd0aDsgaSsrICkgewoJCXZhciBlbCA9ICR3b3JraW5nU2V0LmVxKCBpICksCgkJCWUgPSBlbFsgMCBdLAoJCQlvID0gJC5leHRlbmQoIHt9LCAkLmZuLmJ1dHRvbk1hcmt1cC5kZWZhdWx0cywgewoJCQkJaWNvbjogICAgICAgb3B0aW9ucy5pY29uICAgICAgICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLmljb24gICAgICAgOiBlbC5qcW1EYXRhKCAiaWNvbiIgKSwKCQkJCWljb25wb3M6ICAgIG9wdGlvbnMuaWNvbnBvcyAgICAhPT0gdW5kZWZpbmVkID8gb3B0aW9ucy5pY29ucG9zICAgIDogZWwuanFtRGF0YSggImljb25wb3MiICksCgkJCQl0aGVtZTogICAgICBvcHRpb25zLnRoZW1lICAgICAgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMudGhlbWUgICAgICA6IGVsLmpxbURhdGEoICJ0aGVtZSIgKSB8fCAkLm1vYmlsZS5nZXRJbmhlcml0ZWRUaGVtZSggZWwsICJjIiApLAoJCQkJaW5saW5lOiAgICAgb3B0aW9ucy5pbmxpbmUgICAgICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLmlubGluZSAgICAgOiBlbC5qcW1EYXRhKCAiaW5saW5lIiApLAoJCQkJc2hhZG93OiAgICAgb3B0aW9ucy5zaGFkb3cgICAgICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLnNoYWRvdyAgICAgOiBlbC5qcW1EYXRhKCAic2hhZG93IiApLAoJCQkJY29ybmVyczogICAgb3B0aW9ucy5jb3JuZXJzICAgICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLmNvcm5lcnMgICAgOiBlbC5qcW1EYXRhKCAiY29ybmVycyIgKSwKCQkJCWljb25zaGFkb3c6IG9wdGlvbnMuaWNvbnNoYWRvdyAhPT0gdW5kZWZpbmVkID8gb3B0aW9ucy5pY29uc2hhZG93IDogZWwuanFtRGF0YSggImljb25zaGFkb3ciICksCgkJCQltaW5pOiAgICAgICBvcHRpb25zLm1pbmkgICAgICAgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMubWluaSAgICAgICA6IGVsLmpxbURhdGEoICJtaW5pIiApCgkJCX0sIG9wdGlvbnMgKSwKCgkJCS8vIENsYXNzZXMgRGVmaW5lZAoJCQlpbm5lckNsYXNzID0gInVpLWJ0bi1pbm5lciIsCgkJCXRleHRDbGFzcyA9ICJ1aS1idG4tdGV4dCIsCgkJCWJ1dHRvbkNsYXNzLCBpY29uQ2xhc3MsCgkJCS8vIEJ1dHRvbiBpbm5lciBtYXJrdXAKCQkJYnV0dG9uSW5uZXIsCgkJCWJ1dHRvblRleHQsCgkJCWJ1dHRvbkljb24sCgkJCWJ1dHRvbkVsZW1lbnRzOwoKCQkkLmVhY2goIG8sIG1hcFRvRGF0YUF0dHIgKTsKCgkJaWYgKCBlbC5qcW1EYXRhKCAicmVsIiApID09PSAicG9wdXAiICYmIGVsLmF0dHIoICJocmVmIiApICkgewoJCQllLnNldEF0dHJpYnV0ZSggImFyaWEtaGFzcG9wdXAiLCB0cnVlICk7CgkJCWUuc2V0QXR0cmlidXRlKCAiYXJpYS1vd25zIiwgZS5nZXRBdHRyaWJ1dGUoICJocmVmIiApICk7CgkJfQoKCQkvLyBDaGVjayBpZiB0aGlzIGVsZW1lbnQgaXMgYWxyZWFkeSBlbmhhbmNlZAoJCWJ1dHRvbkVsZW1lbnRzID0gJC5kYXRhKCAoICggZS50YWdOYW1lID09PSAiSU5QVVQiIHx8IGUudGFnTmFtZSA9PT0gIkJVVFRPTiIgKSA/IGUucGFyZW50Tm9kZSA6IGUgKSwgImJ1dHRvbkVsZW1lbnRzIiApOwoKCQlpZiAoIGJ1dHRvbkVsZW1lbnRzICkgewoJCQllID0gYnV0dG9uRWxlbWVudHMub3V0ZXI7CgkJCWVsID0gJCggZSApOwoJCQlidXR0b25Jbm5lciA9IGJ1dHRvbkVsZW1lbnRzLmlubmVyOwoJCQlidXR0b25UZXh0ID0gYnV0dG9uRWxlbWVudHMudGV4dDsKCQkJLy8gV2Ugd2lsbCByZWNyZWF0ZSB0aGlzIGljb24gYmVsb3cKCQkJJCggYnV0dG9uRWxlbWVudHMuaWNvbiApLnJlbW92ZSgpOwoJCQlidXR0b25FbGVtZW50cy5pY29uID0gbnVsbDsKCQl9CgkJZWxzZSB7CgkJCWJ1dHRvbklubmVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggby53cmFwcGVyRWxzICk7CgkJCWJ1dHRvblRleHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCBvLndyYXBwZXJFbHMgKTsKCQl9CgkJYnV0dG9uSWNvbiA9IG8uaWNvbiA/IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJzcGFuIiApIDogbnVsbDsKCgkJaWYgKCBhdHRhY2hFdmVudHMgJiYgIWJ1dHRvbkVsZW1lbnRzICkgewoJCQlhdHRhY2hFdmVudHMoKTsKCQl9CgoJCS8vIGlmIG5vdCwgdHJ5IHRvIGZpbmQgY2xvc2VzdCB0aGVtZSBjb250YWluZXIKCQlpZiAoICFvLnRoZW1lICkgewoJCQlvLnRoZW1lID0gJC5tb2JpbGUuZ2V0SW5oZXJpdGVkVGhlbWUoIGVsLCAiYyIgKTsKCQl9CgoJCWJ1dHRvbkNsYXNzID0gInVpLWJ0biB1aS1idG4tdXAtIiArIG8udGhlbWU7CgkJYnV0dG9uQ2xhc3MgKz0gby5zaGFkb3cgPyAiIHVpLXNoYWRvdyIgOiAiIjsKCQlidXR0b25DbGFzcyArPSBvLmNvcm5lcnMgPyAiIHVpLWJ0bi1jb3JuZXItYWxsIiA6ICIiOwoKCQlpZiAoIG8ubWluaSAhPT0gdW5kZWZpbmVkICkgewoJCQkvLyBVc2VkIHRvIGNvbnRyb2wgc3R5bGluZyBpbiBoZWFkZXJzL2Zvb3RlcnMsIHdoZXJlIGJ1dHRvbnMgZGVmYXVsdCB0byBgbWluaWAgc3R5bGUuCgkJCWJ1dHRvbkNsYXNzICs9IG8ubWluaSA9PT0gdHJ1ZSA/ICIgdWktbWluaSIgOiAiIHVpLWZ1bGxzaXplIjsKCQl9CgoJCWlmICggby5pbmxpbmUgIT09IHVuZGVmaW5lZCApIHsKCQkJLy8gVXNlZCB0byBjb250cm9sIHN0eWxpbmcgaW4gaGVhZGVycy9mb290ZXJzLCB3aGVyZSBidXR0b25zIGRlZmF1bHQgdG8gYGlubGluZWAgc3R5bGUuCgkJCWJ1dHRvbkNsYXNzICs9IG8uaW5saW5lID09PSB0cnVlID8gIiB1aS1idG4taW5saW5lIiA6ICIgdWktYnRuLWJsb2NrIjsKCQl9CgoJCWlmICggby5pY29uICkgewoJCQlvLmljb24gPSAidWktaWNvbi0iICsgby5pY29uOwoJCQlvLmljb25wb3MgPSBvLmljb25wb3MgfHwgImxlZnQiOwoKCQkJaWNvbkNsYXNzID0gInVpLWljb24gIiArIG8uaWNvbjsKCgkJCWlmICggby5pY29uc2hhZG93ICkgewoJCQkJaWNvbkNsYXNzICs9ICIgdWktaWNvbi1zaGFkb3ciOwoJCQl9CgkJfQoKCQlpZiAoIG8uaWNvbnBvcyApIHsKCQkJYnV0dG9uQ2xhc3MgKz0gIiB1aS1idG4taWNvbi0iICsgby5pY29ucG9zOwoKCQkJaWYgKCBvLmljb25wb3MgPT09ICJub3RleHQiICYmICFlbC5hdHRyKCAidGl0bGUiICkgKSB7CgkJCQllbC5hdHRyKCAidGl0bGUiLCBlbC5nZXRFbmNvZGVkVGV4dCgpICk7CgkJCX0KCQl9CgoJCWlubmVyQ2xhc3MgKz0gby5jb3JuZXJzID8gIiB1aS1idG4tY29ybmVyLWFsbCIgOiAiIjsKCgkJaWYgKCBvLmljb25wb3MgJiYgby5pY29ucG9zID09PSAibm90ZXh0IiAmJiAhZWwuYXR0ciggInRpdGxlIiApICkgewoJCQllbC5hdHRyKCAidGl0bGUiLCBlbC5nZXRFbmNvZGVkVGV4dCgpICk7CgkJfQoKCQlpZiAoIGJ1dHRvbkVsZW1lbnRzICkgewoJCQllbC5yZW1vdmVDbGFzcyggYnV0dG9uRWxlbWVudHMuYmNscyB8fCAiIiApOwoJCX0KCQllbC5yZW1vdmVDbGFzcyggInVpLWxpbmsiICkuYWRkQ2xhc3MoIGJ1dHRvbkNsYXNzICk7CgoJCWJ1dHRvbklubmVyLmNsYXNzTmFtZSA9IGlubmVyQ2xhc3M7CgoJCWJ1dHRvblRleHQuY2xhc3NOYW1lID0gdGV4dENsYXNzOwoJCWlmICggIWJ1dHRvbkVsZW1lbnRzICkgewoJCQlidXR0b25Jbm5lci5hcHBlbmRDaGlsZCggYnV0dG9uVGV4dCApOwoJCX0KCQlpZiAoIGJ1dHRvbkljb24gKSB7CgkJCWJ1dHRvbkljb24uY2xhc3NOYW1lID0gaWNvbkNsYXNzOwoJCQlpZiAoICEoIGJ1dHRvbkVsZW1lbnRzICYmIGJ1dHRvbkVsZW1lbnRzLmljb24gKSApIHsKCQkJCWJ1dHRvbkljb24uaW5uZXJIVE1MID0gIiYjMTYwOyI7CgkJCQlidXR0b25Jbm5lci5hcHBlbmRDaGlsZCggYnV0dG9uSWNvbiApOwoJCQl9CgkJfQoKCQl3aGlsZSAoIGUuZmlyc3RDaGlsZCAmJiAhYnV0dG9uRWxlbWVudHMgKSB7CgkJCWJ1dHRvblRleHQuYXBwZW5kQ2hpbGQoIGUuZmlyc3RDaGlsZCApOwoJCX0KCgkJaWYgKCAhYnV0dG9uRWxlbWVudHMgKSB7CgkJCWUuYXBwZW5kQ2hpbGQoIGJ1dHRvbklubmVyICk7CgkJfQoKCQkvLyBBc3NpZ24gYSBzdHJ1Y3R1cmUgY29udGFpbmluZyB0aGUgZWxlbWVudHMgb2YgdGhpcyBidXR0b24gdG8gdGhlIGVsZW1lbnRzIG9mIHRoaXMgYnV0dG9uLiBUaGlzCgkJLy8gd2lsbCBhbGxvdyB1cyB0byByZWNvZ25pemUgdGhpcyBhcyBhbiBhbHJlYWR5LWVuaGFuY2VkIGJ1dHRvbiBpbiBmdXR1cmUgY2FsbHMgdG8gYnV0dG9uTWFya3VwKCkuCgkJYnV0dG9uRWxlbWVudHMgPSB7CgkJCWJjbHMgIDogYnV0dG9uQ2xhc3MsCgkJCW91dGVyIDogZSwKCQkJaW5uZXIgOiBidXR0b25Jbm5lciwKCQkJdGV4dCAgOiBidXR0b25UZXh0LAoJCQlpY29uICA6IGJ1dHRvbkljb24KCQl9OwoKCQkkLmRhdGEoIGUsICAgICAgICAgICAnYnV0dG9uRWxlbWVudHMnLCBidXR0b25FbGVtZW50cyApOwoJCSQuZGF0YSggYnV0dG9uSW5uZXIsICdidXR0b25FbGVtZW50cycsIGJ1dHRvbkVsZW1lbnRzICk7CgkJJC5kYXRhKCBidXR0b25UZXh0LCAgJ2J1dHRvbkVsZW1lbnRzJywgYnV0dG9uRWxlbWVudHMgKTsKCQlpZiAoIGJ1dHRvbkljb24gKSB7CgkJCSQuZGF0YSggYnV0dG9uSWNvbiwgJ2J1dHRvbkVsZW1lbnRzJywgYnV0dG9uRWxlbWVudHMgKTsKCQl9Cgl9CgoJcmV0dXJuIHRoaXM7Cn07CgokLmZuLmJ1dHRvbk1hcmt1cC5kZWZhdWx0cyA9IHsKCWNvcm5lcnM6IHRydWUsCglzaGFkb3c6IHRydWUsCglpY29uc2hhZG93OiB0cnVlLAoJd3JhcHBlckVsczogInNwYW4iCn07CgpmdW5jdGlvbiBjbG9zZXN0RW5hYmxlZEJ1dHRvbiggZWxlbWVudCApIHsKICAgIHZhciBjbmFtZTsKCiAgICB3aGlsZSAoIGVsZW1lbnQgKSB7CgkJLy8gTm90ZSB0aGF0IHdlIGNoZWNrIGZvciB0eXBlb2YgY2xhc3NOYW1lIGJlbG93IGJlY2F1c2UgdGhlIGVsZW1lbnQgd2UKCQkvLyBoYW5kZWQgY291bGQgYmUgaW4gYW4gU1ZHIERPTSB3aGVyZSBjbGFzc05hbWUgb24gU1ZHIGVsZW1lbnRzIGlzIGRlZmluZWQgdG8KCQkvLyBiZSBvZiBhIGRpZmZlcmVudCB0eXBlIChTVkdBbmltYXRlZFN0cmluZykuIFdlIG9ubHkgb3BlcmF0ZSBvbiBIVE1MIERPTQoJCS8vIGVsZW1lbnRzLCBzbyB3ZSBsb29rIGZvciBwbGFpbiAic3RyaW5nIi4KICAgICAgICBjbmFtZSA9ICggdHlwZW9mIGVsZW1lbnQuY2xhc3NOYW1lID09PSAnc3RyaW5nJyApICYmICggZWxlbWVudC5jbGFzc05hbWUgKyAnICcgKTsKICAgICAgICBpZiAoIGNuYW1lICYmIGNuYW1lLmluZGV4T2YoICJ1aS1idG4gIiApID4gLTEgJiYgY25hbWUuaW5kZXhPZiggInVpLWRpc2FibGVkICIgKSA8IDAgKSB7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KCiAgICAgICAgZWxlbWVudCA9IGVsZW1lbnQucGFyZW50Tm9kZTsKICAgIH0KCiAgICByZXR1cm4gZWxlbWVudDsKfQoKdmFyIGF0dGFjaEV2ZW50cyA9IGZ1bmN0aW9uKCkgewoJdmFyIGhvdmVyRGVsYXkgPSAkLm1vYmlsZS5idXR0b25NYXJrdXAuaG92ZXJEZWxheSwgaG92LCBmb2M7CgoJJCggZG9jdW1lbnQgKS5iaW5kKCB7CgkJInZtb3VzZWRvd24gdm1vdXNlY2FuY2VsIHZtb3VzZXVwIHZtb3VzZW92ZXIgdm1vdXNlb3V0IGZvY3VzIGJsdXIgc2Nyb2xsc3RhcnQiOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciB0aGVtZSwKCQkJCSRidG4gPSAkKCBjbG9zZXN0RW5hYmxlZEJ1dHRvbiggZXZlbnQudGFyZ2V0ICkgKSwKCQkJCWlzVG91Y2hFdmVudCA9IGV2ZW50Lm9yaWdpbmFsRXZlbnQgJiYgL150b3VjaC8udGVzdCggZXZlbnQub3JpZ2luYWxFdmVudC50eXBlICksCgkJCQlldnQgPSBldmVudC50eXBlOwoKCQkJaWYgKCAkYnRuLmxlbmd0aCApIHsKCQkJCXRoZW1lID0gJGJ0bi5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidGhlbWUiICk7CgoJCQkJaWYgKCBldnQgPT09ICJ2bW91c2Vkb3duIiApIHsKCQkJCQlpZiAoIGlzVG91Y2hFdmVudCApIHsKCQkJCQkJLy8gVXNlIGEgc2hvcnQgZGVsYXkgdG8gZGV0ZXJtaW5lIGlmIHRoZSB1c2VyIGlzIHNjcm9sbGluZyBiZWZvcmUgaGlnaGxpZ2h0aW5nCgkJCQkJCWhvdiA9IHNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCQkJCQkJJGJ0bi5yZW1vdmVDbGFzcyggInVpLWJ0bi11cC0iICsgdGhlbWUgKS5hZGRDbGFzcyggInVpLWJ0bi1kb3duLSIgKyB0aGVtZSApOwoJCQkJCQl9LCBob3ZlckRlbGF5ICk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJJGJ0bi5yZW1vdmVDbGFzcyggInVpLWJ0bi11cC0iICsgdGhlbWUgKS5hZGRDbGFzcyggInVpLWJ0bi1kb3duLSIgKyB0aGVtZSApOwoJCQkJCX0KCQkJCX0gZWxzZSBpZiAoIGV2dCA9PT0gInZtb3VzZWNhbmNlbCIgfHwgZXZ0ID09PSAidm1vdXNldXAiICkgewoJCQkJCSRidG4ucmVtb3ZlQ2xhc3MoICJ1aS1idG4tZG93bi0iICsgdGhlbWUgKS5hZGRDbGFzcyggInVpLWJ0bi11cC0iICsgdGhlbWUgKTsKCQkJCX0gZWxzZSBpZiAoIGV2dCA9PT0gInZtb3VzZW92ZXIiIHx8IGV2dCA9PT0gImZvY3VzIiApIHsKCQkJCQlpZiAoIGlzVG91Y2hFdmVudCApIHsKCQkJCQkJLy8gVXNlIGEgc2hvcnQgZGVsYXkgdG8gZGV0ZXJtaW5lIGlmIHRoZSB1c2VyIGlzIHNjcm9sbGluZyBiZWZvcmUgaGlnaGxpZ2h0aW5nCgkJCQkJCWZvYyA9IHNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCQkJCQkJJGJ0bi5yZW1vdmVDbGFzcyggInVpLWJ0bi11cC0iICsgdGhlbWUgKS5hZGRDbGFzcyggInVpLWJ0bi1ob3Zlci0iICsgdGhlbWUgKTsKCQkJCQkJfSwgaG92ZXJEZWxheSApOwoJCQkJCX0gZWxzZSB7CgkJCQkJCSRidG4ucmVtb3ZlQ2xhc3MoICJ1aS1idG4tdXAtIiArIHRoZW1lICkuYWRkQ2xhc3MoICJ1aS1idG4taG92ZXItIiArIHRoZW1lICk7CgkJCQkJfQoJCQkJfSBlbHNlIGlmICggZXZ0ID09PSAidm1vdXNlb3V0IiB8fCBldnQgPT09ICJibHVyIiB8fCBldnQgPT09ICJzY3JvbGxzdGFydCIgKSB7CgkJCQkJJGJ0bi5yZW1vdmVDbGFzcyggInVpLWJ0bi1ob3Zlci0iICsgdGhlbWUgICsgIiB1aS1idG4tZG93bi0iICsgdGhlbWUgKS5hZGRDbGFzcyggInVpLWJ0bi11cC0iICsgdGhlbWUgKTsKCQkJCQlpZiAoIGhvdiApIHsKCQkJCQkJY2xlYXJUaW1lb3V0KCBob3YgKTsKCQkJCQl9CgkJCQkJaWYgKCBmb2MgKSB7CgkJCQkJCWNsZWFyVGltZW91dCggZm9jICk7CgkJCQkJfQoJCQkJfQoJCQl9CgkJfSwKCQkiZm9jdXNpbiBmb2N1cyI6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJJCggY2xvc2VzdEVuYWJsZWRCdXR0b24oIGV2ZW50LnRhcmdldCApICkuYWRkQ2xhc3MoICQubW9iaWxlLmZvY3VzQ2xhc3MgKTsKCQl9LAoJCSJmb2N1c291dCBibHVyIjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkkKCBjbG9zZXN0RW5hYmxlZEJ1dHRvbiggZXZlbnQudGFyZ2V0ICkgKS5yZW1vdmVDbGFzcyggJC5tb2JpbGUuZm9jdXNDbGFzcyApOwoJCX0KCX0pOwoKCWF0dGFjaEV2ZW50cyA9IG51bGw7Cn07CgovL2xpbmtzIGluIGJhcnMsIG9yIHRob3NlIHdpdGggIGRhdGEtcm9sZSBiZWNvbWUgYnV0dG9ucwovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJCggZG9jdW1lbnQgKS5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApIHsKCgkkKCAiOmpxbURhdGEocm9sZT0nYnV0dG9uJyksIC51aS1iYXIgPiBhLCAudWktaGVhZGVyID4gYSwgLnVpLWZvb3RlciA+IGEsIC51aS1iYXIgPiA6anFtRGF0YShyb2xlPSdjb250cm9sZ3JvdXAnKSA+IGEiLCBlLnRhcmdldCApCgkJLmpxbUVuaGFuY2VhYmxlKCkKCQkubm90KCAiYnV0dG9uLCBpbnB1dCwgLnVpLWJ0biwgOmpxbURhdGEocm9sZT0nbm9uZScpLCA6anFtRGF0YShyb2xlPSdub2pzJykiICkKCQkuYnV0dG9uTWFya3VwKCk7Cn0pOwoKfSkoIGpRdWVyeSApOwoKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUuY29sbGFwc2libGUiLCAkLm1vYmlsZS53aWRnZXQsIHsKCW9wdGlvbnM6IHsKCQlleHBhbmRDdWVUZXh0OiAiIGNsaWNrIHRvIGV4cGFuZCBjb250ZW50cyIsCgkJY29sbGFwc2VDdWVUZXh0OiAiIGNsaWNrIHRvIGNvbGxhcHNlIGNvbnRlbnRzIiwKCQljb2xsYXBzZWQ6IHRydWUsCgkJaGVhZGluZzogImgxLGgyLGgzLGg0LGg1LGg2LGxlZ2VuZCIsCgkJdGhlbWU6IG51bGwsCgkJY29udGVudFRoZW1lOiBudWxsLAoJCWluc2V0OiB0cnVlLAoJCW1pbmk6IGZhbHNlLAoJCWluaXRTZWxlY3RvcjogIjpqcW1EYXRhKHJvbGU9J2NvbGxhcHNpYmxlJykiCgl9LAoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgoJCXZhciAkZWwgPSB0aGlzLmVsZW1lbnQsCgkJCW8gPSB0aGlzLm9wdGlvbnMsCgkJCWNvbGxhcHNpYmxlID0gJGVsLmFkZENsYXNzKCAidWktY29sbGFwc2libGUiICksCgkJCWNvbGxhcHNpYmxlSGVhZGluZyA9ICRlbC5jaGlsZHJlbiggby5oZWFkaW5nICkuZmlyc3QoKSwKCQkJY29sbGFwc2VkSWNvbiA9ICRlbC5qcW1EYXRhKCAiY29sbGFwc2VkLWljb24iICkgfHwgby5jb2xsYXBzZWRJY29uLAoJCQlleHBhbmRlZEljb24gPSAkZWwuanFtRGF0YSggImV4cGFuZGVkLWljb24iICkgfHwgby5leHBhbmRlZEljb24sCgkJCWNvbGxhcHNpYmxlQ29udGVudCA9IGNvbGxhcHNpYmxlLndyYXBJbm5lciggIjxkaXYgY2xhc3M9J3VpLWNvbGxhcHNpYmxlLWNvbnRlbnQnPjwvZGl2PiIgKS5jaGlsZHJlbiggIi51aS1jb2xsYXBzaWJsZS1jb250ZW50IiApLAoJCQljb2xsYXBzaWJsZVNldCA9ICRlbC5jbG9zZXN0KCAiOmpxbURhdGEocm9sZT0nY29sbGFwc2libGUtc2V0JykiICkuYWRkQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZS1zZXQiICk7CgoJCS8vIFJlcGxhY2UgY29sbGFwc2libGVIZWFkaW5nIGlmIGl0J3MgYSBsZWdlbmQKCQlpZiAoIGNvbGxhcHNpYmxlSGVhZGluZy5pcyggImxlZ2VuZCIgKSApIHsKCQkJY29sbGFwc2libGVIZWFkaW5nID0gJCggIjxkaXYgcm9sZT0naGVhZGluZyc+IisgY29sbGFwc2libGVIZWFkaW5nLmh0bWwoKSArIjwvZGl2PiIgKS5pbnNlcnRCZWZvcmUoIGNvbGxhcHNpYmxlSGVhZGluZyApOwoJCQljb2xsYXBzaWJsZUhlYWRpbmcubmV4dCgpLnJlbW92ZSgpOwoJCX0KCgkJLy8gSWYgd2UgYXJlIGluIGEgY29sbGFwc2libGUgc2V0CgkJaWYgKCBjb2xsYXBzaWJsZVNldC5sZW5ndGggKSB7CgkJCS8vIEluaGVyaXQgdGhlIHRoZW1lIGZyb20gY29sbGFwc2libGUtc2V0CgkJCWlmICggIW8udGhlbWUgKSB7CgkJCQlvLnRoZW1lID0gY29sbGFwc2libGVTZXQuanFtRGF0YSggInRoZW1lIiApIHx8ICQubW9iaWxlLmdldEluaGVyaXRlZFRoZW1lKCBjb2xsYXBzaWJsZVNldCwgImMiICk7CgkJCX0KCQkJLy8gSW5oZXJpdCB0aGUgY29udGVudC10aGVtZSBmcm9tIGNvbGxhcHNpYmxlLXNldAoJCQlpZiAoICFvLmNvbnRlbnRUaGVtZSApIHsKCQkJCW8uY29udGVudFRoZW1lID0gY29sbGFwc2libGVTZXQuanFtRGF0YSggImNvbnRlbnQtdGhlbWUiICk7CgkJCX0KCgkJCS8vIEdldCB0aGUgcHJlZmVyZW5jZSBmb3IgY29sbGFwc2VkIGljb24gaW4gdGhlIHNldAoJCQlpZiAoICFvLmNvbGxhcHNlZEljb24gKSB7CgkJCQlvLmNvbGxhcHNlZEljb24gPSBjb2xsYXBzaWJsZVNldC5qcW1EYXRhKCAiY29sbGFwc2VkLWljb24iICk7CgkJCX0KCQkJLy8gR2V0IHRoZSBwcmVmZXJlbmNlIGZvciBleHBhbmRlZCBpY29uIGluIHRoZSBzZXQKCQkJaWYgKCAhby5leHBhbmRlZEljb24gKSB7CgkJCQlvLmV4cGFuZGVkSWNvbiA9IGNvbGxhcHNpYmxlU2V0LmpxbURhdGEoICJleHBhbmRlZC1pY29uIiApOwoJCQl9CgkJCS8vIEdldHMgdGhlIHByZWZlcmVuY2UgaWNvbiBwb3NpdGlvbiBpbiB0aGUgc2V0CgkJCWlmICggIW8uaWNvblBvcyApIHsKCQkJCW8uaWNvblBvcyA9IGNvbGxhcHNpYmxlU2V0LmpxbURhdGEoICJpY29ucG9zIiApOwoJCQl9CgkJCS8vIEluaGVyaXQgdGhlIHByZWZlcmVuY2UgZm9yIGluc2V0IGZyb20gY29sbGFwc2libGUtc2V0IG9yIHNldCB0aGUgZGVmYXVsdCB2YWx1ZSB0byBlbnN1cmUgZXF1YWx0eSB3aXRoaW4gYSBzZXQKCQkJaWYgKCBjb2xsYXBzaWJsZVNldC5qcW1EYXRhKCAiaW5zZXQiICkgIT09IHVuZGVmaW5lZCApIHsKCQkJCW8uaW5zZXQgPSBjb2xsYXBzaWJsZVNldC5qcW1EYXRhKCAiaW5zZXQiICk7CgkJCX0gZWxzZSB7CgkJCQlvLmluc2V0ID0gdHJ1ZTsKCQkJfQoJCQkvLyBHZXRzIHRoZSBwcmVmZXJlbmNlIGZvciBtaW5pIGluIHRoZSBzZXQKCQkJaWYgKCAhby5taW5pICkgewoJCQkJby5taW5pID0gY29sbGFwc2libGVTZXQuanFtRGF0YSggIm1pbmkiICk7CgkJCX0KCQl9IGVsc2UgewoJCQkvLyBnZXQgaW5oZXJpdGVkIHRoZW1lIGlmIG5vdCBhIHNldCBhbmQgbm8gdGhlbWUgaGFzIGJlZW4gc2V0CgkJCWlmICggIW8udGhlbWUgKSB7CgkJCQlvLnRoZW1lID0gJC5tb2JpbGUuZ2V0SW5oZXJpdGVkVGhlbWUoICRlbCwgImMiICk7CgkJCX0KCQl9CgkJCgkJaWYgKCAhIW8uaW5zZXQgKSB7CgkJCWNvbGxhcHNpYmxlLmFkZENsYXNzKCAidWktY29sbGFwc2libGUtaW5zZXQiICk7CgkJfQoJCQoJCWNvbGxhcHNpYmxlQ29udGVudC5hZGRDbGFzcyggKCBvLmNvbnRlbnRUaGVtZSApID8gKCAidWktYm9keS0iICsgby5jb250ZW50VGhlbWUgKSA6ICIiKTsKCgkJY29sbGFwc2VkSWNvbiA9ICRlbC5qcW1EYXRhKCAiY29sbGFwc2VkLWljb24iICkgfHwgby5jb2xsYXBzZWRJY29uIHx8ICJwbHVzIjsKCQlleHBhbmRlZEljb24gPSAkZWwuanFtRGF0YSggImV4cGFuZGVkLWljb24iICkgfHwgby5leHBhbmRlZEljb24gfHwgIm1pbnVzIjsKCgkJY29sbGFwc2libGVIZWFkaW5nCgkJCS8vZHJvcCBoZWFkaW5nIGluIGJlZm9yZSBjb250ZW50CgkJCS5pbnNlcnRCZWZvcmUoIGNvbGxhcHNpYmxlQ29udGVudCApCgkJCS8vbW9kaWZ5IG1hcmt1cCAmIGF0dHJpYnV0ZXMKCQkJLmFkZENsYXNzKCAidWktY29sbGFwc2libGUtaGVhZGluZyIgKQoJCQkuYXBwZW5kKCAiPHNwYW4gY2xhc3M9J3VpLWNvbGxhcHNpYmxlLWhlYWRpbmctc3RhdHVzJz48L3NwYW4+IiApCgkJCS53cmFwSW5uZXIoICI8YSBocmVmPScjJyBjbGFzcz0ndWktY29sbGFwc2libGUtaGVhZGluZy10b2dnbGUnPjwvYT4iICkKCQkJLmZpbmQoICJhIiApCgkJCQkuZmlyc3QoKQoJCQkJLmJ1dHRvbk1hcmt1cCh7CgkJCQkJc2hhZG93OiBmYWxzZSwKCQkJCQljb3JuZXJzOiBmYWxzZSwKCQkJCQlpY29ucG9zOiAkZWwuanFtRGF0YSggImljb25wb3MiICkgfHwgby5pY29uUG9zIHx8ICJsZWZ0IiwKCQkJCQlpY29uOiBjb2xsYXBzZWRJY29uLAoJCQkJCW1pbmk6IG8ubWluaSwKCQkJCQl0aGVtZTogby50aGVtZQoJCQkJfSk7CgoJCWlmICggISFvLmluc2V0ICkgewkJCQkKCQkJY29sbGFwc2libGVIZWFkaW5nCgkJCQkuZmluZCggImEiICkuZmlyc3QoKS5hZGQoICIudWktYnRuLWlubmVyIiwgJGVsICkKCQkJCQkuYWRkQ2xhc3MoICJ1aS1jb3JuZXItdG9wIHVpLWNvcm5lci1ib3R0b20iICk7CgkJfQoKCQkvL2V2ZW50cwoJCWNvbGxhcHNpYmxlCgkJCS5iaW5kKCAiZXhwYW5kIGNvbGxhcHNlIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJaWYgKCAhZXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKSB7CgkJCQkJdmFyICR0aGlzID0gJCggdGhpcyApLAoJCQkJCQlpc0NvbGxhcHNlID0gKCBldmVudC50eXBlID09PSAiY29sbGFwc2UiICksCgkJCQkJCWNvbnRlbnRUaGVtZSA9IG8uY29udGVudFRoZW1lOwoKCQkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoKCQkJCQljb2xsYXBzaWJsZUhlYWRpbmcKCQkJCQkJLnRvZ2dsZUNsYXNzKCAidWktY29sbGFwc2libGUtaGVhZGluZy1jb2xsYXBzZWQiLCBpc0NvbGxhcHNlICkKCQkJCQkJLmZpbmQoICIudWktY29sbGFwc2libGUtaGVhZGluZy1zdGF0dXMiICkKCQkJCQkJCS50ZXh0KCBpc0NvbGxhcHNlID8gby5leHBhbmRDdWVUZXh0IDogby5jb2xsYXBzZUN1ZVRleHQgKQoJCQkJCQkuZW5kKCkKCQkJCQkJLmZpbmQoICIudWktaWNvbiIgKQoJCQkJCQkJLnRvZ2dsZUNsYXNzKCAidWktaWNvbi0iICsgZXhwYW5kZWRJY29uLCAhaXNDb2xsYXBzZSApCgkJCQkJCQkvLyBsb2dpYyBvciBjYXVzZSBzYW1lIGljb24gZm9yIGV4cGFuZGVkL2NvbGxhcHNlZCBzdGF0ZSB3b3VsZCByZW1vdmUgdGhlIHVpLWljb24tY2xhc3MKCQkJCQkJCS50b2dnbGVDbGFzcyggInVpLWljb24tIiArIGNvbGxhcHNlZEljb24sICggaXNDb2xsYXBzZSB8fCBleHBhbmRlZEljb24gPT09IGNvbGxhcHNlZEljb24gKSApCgkJCQkJCS5lbmQoKQoJCQkJCQkuZmluZCggImEiICkuZmlyc3QoKS5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCgkJCQkJJHRoaXMudG9nZ2xlQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZS1jb2xsYXBzZWQiLCBpc0NvbGxhcHNlICk7CgkJCQkJY29sbGFwc2libGVDb250ZW50LnRvZ2dsZUNsYXNzKCAidWktY29sbGFwc2libGUtY29udGVudC1jb2xsYXBzZWQiLCBpc0NvbGxhcHNlICkuYXR0ciggImFyaWEtaGlkZGVuIiwgaXNDb2xsYXBzZSApOwoKCQkJCQlpZiAoIGNvbnRlbnRUaGVtZSAmJiAhIW8uaW5zZXQgJiYgKCAhY29sbGFwc2libGVTZXQubGVuZ3RoIHx8IGNvbGxhcHNpYmxlLmpxbURhdGEoICJjb2xsYXBzaWJsZS1sYXN0IiApICkgKSB7CgkJCQkJCWNvbGxhcHNpYmxlSGVhZGluZwoJCQkJCQkJLmZpbmQoICJhIiApLmZpcnN0KCkuYWRkKCBjb2xsYXBzaWJsZUhlYWRpbmcuZmluZCggIi51aS1idG4taW5uZXIiICkgKQoJCQkJCQkJLnRvZ2dsZUNsYXNzKCAidWktY29ybmVyLWJvdHRvbSIsIGlzQ29sbGFwc2UgKTsKCQkJCQkJY29sbGFwc2libGVDb250ZW50LnRvZ2dsZUNsYXNzKCAidWktY29ybmVyLWJvdHRvbSIsICFpc0NvbGxhcHNlICk7CgkJCQkJfQoJCQkJCWNvbGxhcHNpYmxlQ29udGVudC50cmlnZ2VyKCAidXBkYXRlbGF5b3V0IiApOwoJCQkJfQoJCQl9KQoJCQkudHJpZ2dlciggby5jb2xsYXBzZWQgPyAiY29sbGFwc2UiIDogImV4cGFuZCIgKTsKCgkJY29sbGFwc2libGVIZWFkaW5nCgkJCS5iaW5kKCAidGFwIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJY29sbGFwc2libGVIZWFkaW5nLmZpbmQoICJhIiApLmZpcnN0KCkuYWRkQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCX0pCgkJCS5iaW5kKCAiY2xpY2siLCBmdW5jdGlvbiggZXZlbnQgKSB7CgoJCQkJdmFyIHR5cGUgPSBjb2xsYXBzaWJsZUhlYWRpbmcuaXMoICIudWktY29sbGFwc2libGUtaGVhZGluZy1jb2xsYXBzZWQiICkgPyAiZXhwYW5kIiA6ICJjb2xsYXBzZSI7CgoJCQkJY29sbGFwc2libGUudHJpZ2dlciggdHlwZSApOwoKCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQlldmVudC5zdG9wUHJvcGFnYXRpb24oKTsKCQkJfSk7Cgl9Cn0pOwoKLy9hdXRvIHNlbGYtaW5pdCB3aWRnZXRzCiQoIGRvY3VtZW50ICkuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKSB7CgkkLm1vYmlsZS5jb2xsYXBzaWJsZS5wcm90b3R5cGUuZW5oYW5jZVdpdGhpbiggZS50YXJnZXQgKTsKfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLmNvbGxhcHNpYmxlc2V0IiwgJC5tb2JpbGUud2lkZ2V0LCB7CglvcHRpb25zOiB7CgkJaW5pdFNlbGVjdG9yOiAiOmpxbURhdGEocm9sZT0nY29sbGFwc2libGUtc2V0JykiCgl9LAoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdmFyICRlbCA9IHRoaXMuZWxlbWVudC5hZGRDbGFzcyggInVpLWNvbGxhcHNpYmxlLXNldCIgKSwKCQkJbyA9IHRoaXMub3B0aW9uczsKCgkJLy8gSW5oZXJpdCB0aGUgdGhlbWUgZnJvbSBjb2xsYXBzaWJsZS1zZXQKCQlpZiAoICFvLnRoZW1lICkgewoJCQlvLnRoZW1lID0gJC5tb2JpbGUuZ2V0SW5oZXJpdGVkVGhlbWUoICRlbCwgImMiICk7CgkJfQoJCS8vIEluaGVyaXQgdGhlIGNvbnRlbnQtdGhlbWUgZnJvbSBjb2xsYXBzaWJsZS1zZXQKCQlpZiAoICFvLmNvbnRlbnRUaGVtZSApIHsKCQkJby5jb250ZW50VGhlbWUgPSAkZWwuanFtRGF0YSggImNvbnRlbnQtdGhlbWUiICk7CgkJfQoKCQlpZiAoICRlbC5qcW1EYXRhKCAiaW5zZXQiICkgIT09IHVuZGVmaW5lZCApIHsKCQkJby5pbnNldCA9ICRlbC5qcW1EYXRhKCAiaW5zZXQiICk7CgkJfQoJCW8uaW5zZXQgPSBvLmluc2V0ICE9PSB1bmRlZmluZWQgPyBvLmluc2V0IDogdHJ1ZTsKCgkJLy8gSW5pdGlhbGl6ZSB0aGUgY29sbGFwc2libGUgc2V0IGlmIGl0J3Mgbm90IGFscmVhZHkgaW5pdGlhbGl6ZWQKCQlpZiAoICEkZWwuanFtRGF0YSggImNvbGxhcHNpYmxlYm91bmQiICkgKSB7CgkJCSRlbAoJCQkJLmpxbURhdGEoICJjb2xsYXBzaWJsZWJvdW5kIiwgdHJ1ZSApCgkJCQkuYmluZCggImV4cGFuZCBjb2xsYXBzZSIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCQl2YXIgaXNDb2xsYXBzZSA9ICggZXZlbnQudHlwZSA9PT0gImNvbGxhcHNlIiApLAoJCQkJCQljb2xsYXBzaWJsZSA9ICQoIGV2ZW50LnRhcmdldCApLmNsb3Nlc3QoICIudWktY29sbGFwc2libGUiICksCgkJCQkJCXdpZGdldCA9IGNvbGxhcHNpYmxlLmRhdGEoICJjb2xsYXBzaWJsZSIgKTsKCQkJCQlpZiAoIGNvbGxhcHNpYmxlLmpxbURhdGEoICJjb2xsYXBzaWJsZS1sYXN0IiApICYmICEhby5pbnNldCApIHsKCQkJCQkJY29sbGFwc2libGUuZmluZCggIi51aS1jb2xsYXBzaWJsZS1oZWFkaW5nIiApLmZpcnN0KCkKCQkJCQkJCS5maW5kKCAiYSIgKS5maXJzdCgpCgkJCQkJCQkudG9nZ2xlQ2xhc3MoICJ1aS1jb3JuZXItYm90dG9tIiwgaXNDb2xsYXBzZSApCgkJCQkJCQkuZmluZCggIi51aS1idG4taW5uZXIiICkKCQkJCQkJCS50b2dnbGVDbGFzcyggInVpLWNvcm5lci1ib3R0b20iLCBpc0NvbGxhcHNlICk7CgkJCQkJCWNvbGxhcHNpYmxlLmZpbmQoICIudWktY29sbGFwc2libGUtY29udGVudCIgKS50b2dnbGVDbGFzcyggInVpLWNvcm5lci1ib3R0b20iLCAhaXNDb2xsYXBzZSApOwoJCQkJCX0KCQkJCX0pCgkJCQkuYmluZCggImV4cGFuZCIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCQl2YXIgY2xvc2VzdENvbGxhcHNpYmxlID0gJCggZXZlbnQudGFyZ2V0ICkKCQkJCQkJLmNsb3Nlc3QoICIudWktY29sbGFwc2libGUiICk7CgkJCQkJaWYgKCBjbG9zZXN0Q29sbGFwc2libGUucGFyZW50KCkuaXMoICI6anFtRGF0YShyb2xlPSdjb2xsYXBzaWJsZS1zZXQnKSIgKSApIHsKCQkJCQkJY2xvc2VzdENvbGxhcHNpYmxlCgkJCQkJCQkuc2libGluZ3MoICIudWktY29sbGFwc2libGUiICkKCQkJCQkJCS50cmlnZ2VyKCAiY29sbGFwc2UiICk7CgkJCQkJfQoJCQkJfSk7CgkJfQoJfSwKCglfaW5pdDogZnVuY3Rpb24oKSB7CgkJdmFyICRlbCA9IHRoaXMuZWxlbWVudCwKCQkJY29sbGFwc2libGVzSW5TZXQgPSAkZWwuY2hpbGRyZW4oICI6anFtRGF0YShyb2xlPSdjb2xsYXBzaWJsZScpIiApLAoJCQlleHBhbmRlZCA9IGNvbGxhcHNpYmxlc0luU2V0LmZpbHRlciggIjpqcW1EYXRhKGNvbGxhcHNlZD0nZmFsc2UnKSIgKTsKCQl0aGlzLnJlZnJlc2goKTsKCgkJLy8gQmVjYXVzZSB0aGUgY29ybmVycyBhcmUgaGFuZGxlZCBieSB0aGUgY29sbGFwc2libGUgaXRzZWxmIGFuZCB0aGUgZGVmYXVsdCBzdGF0ZSBpcyBjb2xsYXBzZWQKCQkvLyBUaGF0IHdhcyBjYXVzaW5nIGh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5LW1vYmlsZS9pc3N1ZXMvNDExNgoJCWV4cGFuZGVkLnRyaWdnZXIoICJleHBhbmQiICk7Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCXZhciAkZWwgPSB0aGlzLmVsZW1lbnQsCgkJCW8gPSB0aGlzLm9wdGlvbnMsCgkJCWNvbGxhcHNpYmxlc0luU2V0ID0gJGVsLmNoaWxkcmVuKCAiOmpxbURhdGEocm9sZT0nY29sbGFwc2libGUnKSIgKTsKCgkJJC5tb2JpbGUuY29sbGFwc2libGUucHJvdG90eXBlLmVuaGFuY2UoIGNvbGxhcHNpYmxlc0luU2V0Lm5vdCggIi51aS1jb2xsYXBzaWJsZSIgKSApOwoKCQkvLyBjbGVhbiB1cCBib3JkZXJzCgkJaWYgKCAhIW8uaW5zZXQgKSB7CgkJCWNvbGxhcHNpYmxlc0luU2V0LmVhY2goZnVuY3Rpb24oKSB7CgkJCQkkKCB0aGlzICkuanFtUmVtb3ZlRGF0YSggImNvbGxhcHNpYmxlLWxhc3QiICkKCQkJCQkuZmluZCggIi51aS1jb2xsYXBzaWJsZS1oZWFkaW5nIiApCgkJCQkJLmZpbmQoICJhIiApLmZpcnN0KCkKCQkJCQkucmVtb3ZlQ2xhc3MoICJ1aS1jb3JuZXItdG9wIHVpLWNvcm5lci1ib3R0b20iICkKCQkJCQkuZmluZCggIi51aS1idG4taW5uZXIiICkKCQkJCQkucmVtb3ZlQ2xhc3MoICJ1aS1jb3JuZXItdG9wIHVpLWNvcm5lci1ib3R0b20iICk7CgkJCX0pOwoKCQkJY29sbGFwc2libGVzSW5TZXQuZmlyc3QoKQoJCQkJLmZpbmQoICJhIiApCgkJCQkJLmZpcnN0KCkKCQkJCQkuYWRkQ2xhc3MoICJ1aS1jb3JuZXItdG9wIiApCgkJCQkJLmZpbmQoICIudWktYnRuLWlubmVyIiApCgkJCQkJCS5hZGRDbGFzcyggInVpLWNvcm5lci10b3AiICk7CgkKCQkJY29sbGFwc2libGVzSW5TZXQubGFzdCgpCgkJCQkuanFtRGF0YSggImNvbGxhcHNpYmxlLWxhc3QiLCB0cnVlICkKCQkJCS5maW5kKCAiYSIgKQoJCQkJCS5maXJzdCgpCgkJCQkJLmFkZENsYXNzKCAidWktY29ybmVyLWJvdHRvbSIgKQoJCQkJCS5maW5kKCAiLnVpLWJ0bi1pbm5lciIgKQoJCQkJCQkuYWRkQ2xhc3MoICJ1aS1jb3JuZXItYm90dG9tIiApOwoJCX0KCX0KfSk7CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJCggZG9jdW1lbnQgKS5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApIHsKCSQubW9iaWxlLmNvbGxhcHNpYmxlc2V0LnByb3RvdHlwZS5lbmhhbmNlV2l0aGluKCBlLnRhcmdldCApOwp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUubmF2YmFyIiwgJC5tb2JpbGUud2lkZ2V0LCB7CglvcHRpb25zOiB7CgkJaWNvbnBvczogInRvcCIsCgkJZ3JpZDogbnVsbCwKCQlpbml0U2VsZWN0b3I6ICI6anFtRGF0YShyb2xlPSduYXZiYXInKSIKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgoJCXZhciAkbmF2YmFyID0gdGhpcy5lbGVtZW50LAoJCQkkbmF2YnRucyA9ICRuYXZiYXIuZmluZCggImEiICksCgkJCWljb25wb3MgPSAkbmF2YnRucy5maWx0ZXIoICI6anFtRGF0YShpY29uKSIgKS5sZW5ndGggPwoJCQkJCQkJCQl0aGlzLm9wdGlvbnMuaWNvbnBvcyA6IHVuZGVmaW5lZDsKCgkJJG5hdmJhci5hZGRDbGFzcyggInVpLW5hdmJhciB1aS1taW5pIiApCgkJCS5hdHRyKCAicm9sZSIsICJuYXZpZ2F0aW9uIiApCgkJCS5maW5kKCAidWwiICkKCQkJLmpxbUVuaGFuY2VhYmxlKCkKCQkJLmdyaWQoeyBncmlkOiB0aGlzLm9wdGlvbnMuZ3JpZCB9KTsKCgkJJG5hdmJ0bnMuYnV0dG9uTWFya3VwKHsKCQkJY29ybmVyczoJZmFsc2UsCgkJCXNoYWRvdzoJCWZhbHNlLAoJCQlpbmxpbmU6ICAgICB0cnVlLAoJCQlpY29ucG9zOglpY29ucG9zCgkJfSk7CgoJCSRuYXZiYXIuZGVsZWdhdGUoICJhIiwgInZjbGljayIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJaWYgKCAhJChldmVudC50YXJnZXQpLmhhc0NsYXNzKCAidWktZGlzYWJsZWQiICkgKSB7CgkJCQkkbmF2YnRucy5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJCSQoIHRoaXMgKS5hZGRDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJfQoJCX0pOwoKCQkvLyBCdXR0b25zIGluIHRoZSBuYXZiYXIgd2l0aCB1aS1zdGF0ZS1wZXJzaXN0IGNsYXNzIHNob3VsZCByZWdhaW4gdGhlaXIgYWN0aXZlIHN0YXRlIGJlZm9yZSBwYWdlIHNob3cKCQkkbmF2YmFyLmNsb3Nlc3QoICIudWktcGFnZSIgKS5iaW5kKCAicGFnZWJlZm9yZXNob3ciLCBmdW5jdGlvbigpIHsKCQkJJG5hdmJ0bnMuZmlsdGVyKCAiLnVpLXN0YXRlLXBlcnNpc3QiICkuYWRkQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJfSk7Cgl9Cn0pOwoKLy9hdXRvIHNlbGYtaW5pdCB3aWRnZXRzCiQoIGRvY3VtZW50ICkuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKSB7CgkkLm1vYmlsZS5uYXZiYXIucHJvdG90eXBlLmVuaGFuY2VXaXRoaW4oIGUudGFyZ2V0ICk7Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgovL0tlZXBzIHRyYWNrIG9mIHRoZSBudW1iZXIgb2YgbGlzdHMgcGVyIHBhZ2UgVUlECi8vVGhpcyBhbGxvd3Mgc3VwcG9ydCBmb3IgbXVsdGlwbGUgbmVzdGVkIGxpc3QgaW4gdGhlIHNhbWUgcGFnZQovL2h0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5LW1vYmlsZS9pc3N1ZXMvMTYxNwp2YXIgbGlzdENvdW50UGVyUGFnZSA9IHt9OwoKJC53aWRnZXQoICJtb2JpbGUubGlzdHZpZXciLCAkLm1vYmlsZS53aWRnZXQsIHsKCglvcHRpb25zOiB7CgkJdGhlbWU6IG51bGwsCgkJY291bnRUaGVtZTogImMiLAoJCWhlYWRlclRoZW1lOiAiYiIsCgkJZGl2aWRlclRoZW1lOiAiYiIsCgkJc3BsaXRJY29uOiAiYXJyb3ctciIsCgkJc3BsaXRUaGVtZTogImIiLAoJCWluc2V0OiBmYWxzZSwKCQlpbml0U2VsZWN0b3I6ICI6anFtRGF0YShyb2xlPSdsaXN0dmlldycpIgoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl2YXIgdCA9IHRoaXMsCgkJCWxpc3R2aWV3Q2xhc3NlcyA9ICIiOwoKCQlsaXN0dmlld0NsYXNzZXMgKz0gdC5vcHRpb25zLmluc2V0ID8gIiB1aS1saXN0dmlldy1pbnNldCB1aS1jb3JuZXItYWxsIHVpLXNoYWRvdyAiIDogIiI7CgoJCS8vIGNyZWF0ZSBsaXN0dmlldyBtYXJrdXAKCQl0LmVsZW1lbnQuYWRkQ2xhc3MoZnVuY3Rpb24oIGksIG9yaWcgKSB7CgkJCXJldHVybiBvcmlnICsgIiB1aS1saXN0dmlldyAiICsgbGlzdHZpZXdDbGFzc2VzOwoJCX0pOwoKCQl0LnJlZnJlc2goIHRydWUgKTsKCX0sCgoJX3JlbW92ZUNvcm5lcnM6IGZ1bmN0aW9uKCBsaSwgd2hpY2ggKSB7CgkJdmFyIHRvcCA9ICJ1aS1jb3JuZXItdG9wIHVpLWNvcm5lci10ciB1aS1jb3JuZXItdGwiLAoJCQlib3QgPSAidWktY29ybmVyLWJvdHRvbSB1aS1jb3JuZXItYnIgdWktY29ybmVyLWJsIjsKCgkJbGkgPSBsaS5hZGQoIGxpLmZpbmQoICIudWktYnRuLWlubmVyLCAudWktbGktbGluay1hbHQsIC51aS1saS10aHVtYiIgKSApOwoKCQlpZiAoIHdoaWNoID09PSAidG9wIiApIHsKCQkJbGkucmVtb3ZlQ2xhc3MoIHRvcCApOwoJCX0gZWxzZSBpZiAoIHdoaWNoID09PSAiYm90dG9tIiApIHsKCQkJbGkucmVtb3ZlQ2xhc3MoIGJvdCApOwoJCX0gZWxzZSB7CgkJCWxpLnJlbW92ZUNsYXNzKCB0b3AgKyAiICIgKyBib3QgKTsKCQl9Cgl9LAoKCV9yZWZyZXNoQ29ybmVyczogZnVuY3Rpb24oIGNyZWF0ZSApIHsKCQl2YXIgJGxpLAoJCQkkdmlzaWJsZWxpLAoJCQkkdG9wbGksCgkJCSRib3R0b21saTsKCgkJJGxpID0gdGhpcy5lbGVtZW50LmNoaWxkcmVuKCAibGkiICk7CgkJLy8gQXQgY3JlYXRlIHRpbWUgYW5kIHdoZW4gYXV0b2RpdmlkZXJzIGNhbGxzIHJlZnJlc2ggdGhlIGxpIGFyZSBub3QgdmlzaWJsZSB5ZXQgc28gd2UgbmVlZCB0byByZWx5IG9uIC51aS1zY3JlZW4taGlkZGVuCgkJJHZpc2libGVsaSA9IGNyZWF0ZSB8fCAkbGkuZmlsdGVyKCAiOnZpc2libGUiICkubGVuZ3RoID09PSAwID8gJGxpLm5vdCggIi51aS1zY3JlZW4taGlkZGVuIiApIDogJGxpLmZpbHRlciggIjp2aXNpYmxlIiApOwoKCQkvLyB1aS1saS1sYXN0IGlzIHVzZWQgZm9yIHNldHRpbmcgYm9yZGVyLWJvdHRvbSBvbiB0aGUgbGFzdCBsaQkJCgkJJGxpLmZpbHRlciggIi51aS1saS1sYXN0IiApLnJlbW92ZUNsYXNzKCAidWktbGktbGFzdCIgKTsKCQkJCQkKCQlpZiAoIHRoaXMub3B0aW9ucy5pbnNldCApIHsKCQkJdGhpcy5fcmVtb3ZlQ29ybmVycyggJGxpICk7CgoJCQkvLyBTZWxlY3QgdGhlIGZpcnN0IHZpc2libGUgbGkgZWxlbWVudAoJCQkkdG9wbGkgPSAkdmlzaWJsZWxpLmZpcnN0KCkKCQkJCS5hZGRDbGFzcyggInVpLWNvcm5lci10b3AiICk7CgoJCQkkdG9wbGkuYWRkKCAkdG9wbGkuZmluZCggIi51aS1idG4taW5uZXIiICkKCQkJCS5ub3QoICIudWktbGktbGluay1hbHQgc3BhbjpmaXJzdC1jaGlsZCIgKSApCgkJCQkJLmFkZENsYXNzKCAidWktY29ybmVyLXRvcCIgKQoJCQkJLmVuZCgpCgkJCQkuZmluZCggIi51aS1saS1saW5rLWFsdCwgLnVpLWxpLWxpbmstYWx0IHNwYW46Zmlyc3QtY2hpbGQiICkKCQkJCQkuYWRkQ2xhc3MoICJ1aS1jb3JuZXItdHIiICkKCQkJCS5lbmQoKQoJCQkJLmZpbmQoICIudWktbGktdGh1bWIiICkKCQkJCQkubm90KCAiLnVpLWxpLWljb24iICkKCQkJCQkuYWRkQ2xhc3MoICJ1aS1jb3JuZXItdGwiICk7CgoJCQkvLyBTZWxlY3QgdGhlIGxhc3QgdmlzaWJsZSBsaSBlbGVtZW50CgkJCSRib3R0b21saSA9ICR2aXNpYmxlbGkubGFzdCgpCgkJCQkuYWRkQ2xhc3MoICJ1aS1jb3JuZXItYm90dG9tIHVpLWxpLWxhc3QiICk7CgoJCQkkYm90dG9tbGkuYWRkKCAkYm90dG9tbGkuZmluZCggIi51aS1idG4taW5uZXIiICkgKQoJCQkJLmZpbmQoICIudWktbGktbGluay1hbHQiICkKCQkJCQkuYWRkQ2xhc3MoICJ1aS1jb3JuZXItYnIiICkKCQkJCS5lbmQoKQoJCQkJLmZpbmQoICIudWktbGktdGh1bWIiICkKCQkJCQkubm90KCAiLnVpLWxpLWljb24iICkKCQkJCQkuYWRkQ2xhc3MoICJ1aS1jb3JuZXItYmwiICk7CgkJfSBlbHNlIHsKCQkJJHZpc2libGVsaS5sYXN0KCkuYWRkQ2xhc3MoICJ1aS1saS1sYXN0IiApOwoJCX0KCQlpZiAoICFjcmVhdGUgKSB7CgkJCXRoaXMuZWxlbWVudC50cmlnZ2VyKCAidXBkYXRlbGF5b3V0IiApOwoJCX0KCX0sCgoJLy8gVGhpcyBpcyBhIGdlbmVyaWMgdXRpbGl0eSBtZXRob2QgZm9yIGZpbmRpbmcgdGhlIGZpcnN0CgkvLyBub2RlIHdpdGggYSBnaXZlbiBub2RlTmFtZS4gSXQgdXNlcyBiYXNpYyBET00gdHJhdmVyc2FsCgkvLyB0byBiZSBmYXN0IGFuZCBpcyBtZWFudCB0byBiZSBhIHN1YnN0aXR1dGUgZm9yIHNpbXBsZQoJLy8gJC5mbi5jbG9zZXN0KCkgYW5kICQuZm4uY2hpbGRyZW4oKSBjYWxscyBvbiBhIHNpbmdsZQoJLy8gZWxlbWVudC4gTm90ZSB0aGF0IGNhbGxlcnMgbXVzdCBwYXNzIGJvdGggdGhlIGxvd2VyQ2FzZQoJLy8gYW5kIHVwcGVyQ2FzZSB2ZXJzaW9uIG9mIHRoZSBub2RlTmFtZSB0aGV5IGFyZSBsb29raW5nIGZvci4KCS8vIFRoZSBtYWluIHJlYXNvbiBmb3IgdGhpcyBpcyB0aGF0IHRoaXMgZnVuY3Rpb24gd2lsbCBiZQoJLy8gY2FsbGVkIG1hbnkgdGltZXMgYW5kIHdlIHdhbnQgdG8gYXZvaWQgaGF2aW5nIHRvIGxvd2VyY2FzZQoJLy8gdGhlIG5vZGVOYW1lIGZyb20gdGhlIGVsZW1lbnQgZXZlcnkgdGltZSB0byBlbnN1cmUgd2UgaGF2ZQoJLy8gYSBtYXRjaC4gTm90ZSB0aGF0IHRoaXMgZnVuY3Rpb24gbGl2ZXMgaGVyZSBmb3Igbm93LCBidXQgbWF5CgkvLyBiZSBtb3ZlZCBpbnRvICQubW9iaWxlIGlmIG90aGVyIGNvbXBvbmVudHMgbmVlZCBhIHNpbWlsYXIgbWV0aG9kLgoJX2ZpbmRGaXJzdEVsZW1lbnRCeVRhZ05hbWU6IGZ1bmN0aW9uKCBlbGUsIG5leHRQcm9wLCBsY05hbWUsIHVjTmFtZSApIHsKCQl2YXIgZGljdCA9IHt9OwoJCWRpY3RbIGxjTmFtZSBdID0gZGljdFsgdWNOYW1lIF0gPSB0cnVlOwoJCXdoaWxlICggZWxlICkgewoJCQlpZiAoIGRpY3RbIGVsZS5ub2RlTmFtZSBdICkgewoJCQkJcmV0dXJuIGVsZTsKCQkJfQoJCQllbGUgPSBlbGVbIG5leHRQcm9wIF07CgkJfQoJCXJldHVybiBudWxsOwoJfSwKCV9nZXRDaGlsZHJlbkJ5VGFnTmFtZTogZnVuY3Rpb24oIGVsZSwgbGNOYW1lLCB1Y05hbWUgKSB7CgkJdmFyIHJlc3VsdHMgPSBbXSwKCQkJZGljdCA9IHt9OwoJCWRpY3RbIGxjTmFtZSBdID0gZGljdFsgdWNOYW1lIF0gPSB0cnVlOwoJCWVsZSA9IGVsZS5maXJzdENoaWxkOwoJCXdoaWxlICggZWxlICkgewoJCQlpZiAoIGRpY3RbIGVsZS5ub2RlTmFtZSBdICkgewoJCQkJcmVzdWx0cy5wdXNoKCBlbGUgKTsKCQkJfQoJCQllbGUgPSBlbGUubmV4dFNpYmxpbmc7CgkJfQoJCXJldHVybiAkKCByZXN1bHRzICk7Cgl9LAoKCV9hZGRUaHVtYkNsYXNzZXM6IGZ1bmN0aW9uKCBjb250YWluZXJzICkgewoJCXZhciBpLCBpbWcsIGxlbiA9IGNvbnRhaW5lcnMubGVuZ3RoOwoJCWZvciAoIGkgPSAwOyBpIDwgbGVuOyBpKysgKSB7CgkJCWltZyA9ICQoIHRoaXMuX2ZpbmRGaXJzdEVsZW1lbnRCeVRhZ05hbWUoIGNvbnRhaW5lcnNbIGkgXS5maXJzdENoaWxkLCAibmV4dFNpYmxpbmciLCAiaW1nIiwgIklNRyIgKSApOwoJCQlpZiAoIGltZy5sZW5ndGggKSB7CgkJCQlpbWcuYWRkQ2xhc3MoICJ1aS1saS10aHVtYiIgKTsKCQkJCSQoIHRoaXMuX2ZpbmRGaXJzdEVsZW1lbnRCeVRhZ05hbWUoIGltZ1sgMCBdLnBhcmVudE5vZGUsICJwYXJlbnROb2RlIiwgImxpIiwgIkxJIiApICkuYWRkQ2xhc3MoIGltZy5pcyggIi51aS1saS1pY29uIiApID8gInVpLWxpLWhhcy1pY29uIiA6ICJ1aS1saS1oYXMtdGh1bWIiICk7CgkJCX0KCQl9Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCBjcmVhdGUgKSB7CgkJdGhpcy5wYXJlbnRQYWdlID0gdGhpcy5lbGVtZW50LmNsb3Nlc3QoICIudWktcGFnZSIgKTsKCQl0aGlzLl9jcmVhdGVTdWJQYWdlcygpOwoKCQl2YXIgbyA9IHRoaXMub3B0aW9ucywKCQkJJGxpc3QgPSB0aGlzLmVsZW1lbnQsCgkJCXNlbGYgPSB0aGlzLAoJCQlkaXZpZGVydGhlbWUgPSAkbGlzdC5qcW1EYXRhKCAiZGl2aWRlcnRoZW1lIiApIHx8IG8uZGl2aWRlclRoZW1lLAoJCQlsaXN0c3BsaXR0aGVtZSA9ICRsaXN0LmpxbURhdGEoICJzcGxpdHRoZW1lIiApLAoJCQlsaXN0c3BsaXRpY29uID0gJGxpc3QuanFtRGF0YSggInNwbGl0aWNvbiIgKSwKCQkJbGkgPSB0aGlzLl9nZXRDaGlsZHJlbkJ5VGFnTmFtZSggJGxpc3RbIDAgXSwgImxpIiwgIkxJIiApLAoJCQlvbCA9ICEhJC5ub2RlTmFtZSggJGxpc3RbIDAgXSwgIm9sIiApLAoJCQlqc0NvdW50ID0gISQuc3VwcG9ydC5jc3NQc2V1ZG9FbGVtZW50LAoJCQlzdGFydCA9ICRsaXN0LmF0dHIoICJzdGFydCIgKSwKCQkJaXRlbUNsYXNzRGljdCA9IHt9LAoJCQlpdGVtLCBpdGVtQ2xhc3MsIGl0ZW1UaGVtZSwKCQkJYSwgbGFzdCwgc3BsaXR0aGVtZSwgY291bnRlciwgc3RhcnRDb3VudCwgbmV3U3RhcnRDb3VudCwgY291bnRQYXJlbnQsIGljb24sIGltZ1BhcmVudHMsIGltZywgbGlua0ljb247CgoJCWlmICggb2wgJiYganNDb3VudCApIHsKCQkJJGxpc3QuZmluZCggIi51aS1saS1kZWMiICkucmVtb3ZlKCk7CgkJfQoKCQlpZiAoIG9sICkgewkKCQkJLy8gQ2hlY2sgaWYgYSBzdGFydCBhdHRyaWJ1dGUgaGFzIGJlZW4gc2V0IHdoaWxlIHRha2luZyBhIHZhbHVlIG9mIDAgaW50byBhY2NvdW50CgkJCWlmICggc3RhcnQgfHwgc3RhcnQgPT09IDAgKSB7CgkJCQlpZiAoICFqc0NvdW50ICkgewoJCQkJCXN0YXJ0Q291bnQgPSBwYXJzZUZsb2F0KCBzdGFydCApIC0gMTsKCQkJCQkkbGlzdC5jc3MoICJjb3VudGVyLXJlc2V0IiwgImxpc3RudW1iZXJpbmcgIiArIHN0YXJ0Q291bnQgKTsKCQkJCX0gZWxzZSB7CgkJCQkJY291bnRlciA9IHBhcnNlRmxvYXQoIHN0YXJ0ICk7CgkJCQl9CgkJCX0gZWxzZSBpZiAoIGpzQ291bnQgKSB7CgkJCQkJY291bnRlciA9IDE7CgkJCX0JCgkJfQoKCQlpZiAoICFvLnRoZW1lICkgewoJCQlvLnRoZW1lID0gJC5tb2JpbGUuZ2V0SW5oZXJpdGVkVGhlbWUoIHRoaXMuZWxlbWVudCwgImMiICk7CgkJfQoKCQlmb3IgKCB2YXIgcG9zID0gMCwgbnVtbGkgPSBsaS5sZW5ndGg7IHBvcyA8IG51bWxpOyBwb3MrKyApIHsKCQkJaXRlbSA9IGxpLmVxKCBwb3MgKTsKCQkJaXRlbUNsYXNzID0gInVpLWxpIjsKCgkJCS8vIElmIHdlJ3JlIGNyZWF0aW5nIHRoZSBlbGVtZW50LCB3ZSB1cGRhdGUgaXQgcmVnYXJkbGVzcwoJCQlpZiAoIGNyZWF0ZSB8fCAhaXRlbS5oYXNDbGFzcyggInVpLWxpIiApICkgewoJCQkJaXRlbVRoZW1lID0gaXRlbS5qcW1EYXRhKCAidGhlbWUiICkgfHwgby50aGVtZTsKCQkJCWEgPSB0aGlzLl9nZXRDaGlsZHJlbkJ5VGFnTmFtZSggaXRlbVsgMCBdLCAiYSIsICJBIiApOwoJCQkJdmFyIGlzRGl2aWRlciA9ICggaXRlbS5qcW1EYXRhKCAicm9sZSIgKSA9PT0gImxpc3QtZGl2aWRlciIgKTsKCgkJCQlpZiAoIGEubGVuZ3RoICYmICFpc0RpdmlkZXIgKSB7CgkJCQkJaWNvbiA9IGl0ZW0uanFtRGF0YSggImljb24iICk7CgoJCQkJCWl0ZW0uYnV0dG9uTWFya3VwKHsKCQkJCQkJd3JhcHBlckVsczogImRpdiIsCgkJCQkJCXNoYWRvdzogZmFsc2UsCgkJCQkJCWNvcm5lcnM6IGZhbHNlLAoJCQkJCQlpY29ucG9zOiAicmlnaHQiLAoJCQkJCQlpY29uOiBhLmxlbmd0aCA+IDEgfHwgaWNvbiA9PT0gZmFsc2UgPyBmYWxzZSA6IGljb24gfHwgImFycm93LXIiLAoJCQkJCQl0aGVtZTogaXRlbVRoZW1lCgkJCQkJfSk7CgoJCQkJCWlmICggKCBpY29uICE9PSBmYWxzZSApICYmICggYS5sZW5ndGggPT09IDEgKSApIHsKCQkJCQkJaXRlbS5hZGRDbGFzcyggInVpLWxpLWhhcy1hcnJvdyIgKTsKCQkJCQl9CgoJCQkJCWEuZmlyc3QoKS5yZW1vdmVDbGFzcyggInVpLWxpbmsiICkuYWRkQ2xhc3MoICJ1aS1saW5rLWluaGVyaXQiICk7CgoJCQkJCWlmICggYS5sZW5ndGggPiAxICkgewoJCQkJCQlpdGVtQ2xhc3MgKz0gIiB1aS1saS1oYXMtYWx0IjsKCgkJCQkJCWxhc3QgPSBhLmxhc3QoKTsKCQkJCQkJc3BsaXR0aGVtZSA9IGxpc3RzcGxpdHRoZW1lIHx8IGxhc3QuanFtRGF0YSggInRoZW1lIiApIHx8IG8uc3BsaXRUaGVtZTsKCQkJCQkJbGlua0ljb24gPSBsYXN0LmpxbURhdGEoICJpY29uIiApOwoKCQkJCQkJbGFzdC5hcHBlbmRUbyggaXRlbSApCgkJCQkJCQkuYXR0ciggInRpdGxlIiwgbGFzdC5nZXRFbmNvZGVkVGV4dCgpICkKCQkJCQkJCS5hZGRDbGFzcyggInVpLWxpLWxpbmstYWx0IiApCgkJCQkJCQkuZW1wdHkoKQoJCQkJCQkJLmJ1dHRvbk1hcmt1cCh7CgkJCQkJCQkJc2hhZG93OiBmYWxzZSwKCQkJCQkJCQljb3JuZXJzOiBmYWxzZSwKCQkJCQkJCQl0aGVtZTogaXRlbVRoZW1lLAoJCQkJCQkJCWljb246IGZhbHNlLAoJCQkJCQkJCWljb25wb3M6ICJub3RleHQiCgkJCQkJCQl9KQoJCQkJCQkJLmZpbmQoICIudWktYnRuLWlubmVyIiApCgkJCQkJCQkJLmFwcGVuZCgKCQkJCQkJCQkJJCggZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggInNwYW4iICkgKS5idXR0b25NYXJrdXAoewoJCQkJCQkJCQkJc2hhZG93OiB0cnVlLAoJCQkJCQkJCQkJY29ybmVyczogdHJ1ZSwKCQkJCQkJCQkJCXRoZW1lOiBzcGxpdHRoZW1lLAoJCQkJCQkJCQkJaWNvbnBvczogIm5vdGV4dCIsCgkJCQkJCQkJCQkvLyBsaW5rIGljb24gb3ZlcnJpZGVzIGxpc3QgaXRlbSBpY29uIG92ZXJyaWRlcyB1bCBlbGVtZW50IG92ZXJyaWRlcyBvcHRpb25zCgkJCQkJCQkJCQlpY29uOiBsaW5rSWNvbiB8fCBpY29uIHx8IGxpc3RzcGxpdGljb24gfHwgby5zcGxpdEljb24KCQkJCQkJCQkJfSkKCQkJCQkJCQkpOwoJCQkJCX0KCQkJCX0gZWxzZSBpZiAoIGlzRGl2aWRlciApIHsKCgkJCQkJaXRlbUNsYXNzICs9ICIgdWktbGktZGl2aWRlciB1aS1iYXItIiArIGRpdmlkZXJ0aGVtZTsKCQkJCQlpdGVtLmF0dHIoICJyb2xlIiwgImhlYWRpbmciICk7CgoJCQkJCWlmICggb2wgKSB7CQoJCQkJCQkvL3Jlc2V0IGNvdW50ZXIgd2hlbiBhIGRpdmlkZXIgaGVhZGluZyBpcyBlbmNvdW50ZXJlZAoJCQkJCQlpZiAoIHN0YXJ0IHx8IHN0YXJ0ID09PSAwICkgewoJCQkJCQkJaWYgKCAhanNDb3VudCApIHsKCQkJCQkJCQluZXdTdGFydENvdW50ID0gcGFyc2VGbG9hdCggc3RhcnQgKSAtIDE7CgkJCQkJCQkJaXRlbS5jc3MoICJjb3VudGVyLXJlc2V0IiwgImxpc3RudW1iZXJpbmcgIiArIG5ld1N0YXJ0Q291bnQgKTsKCQkJCQkJCX0gZWxzZSB7CgkJCQkJCQkJY291bnRlciA9IHBhcnNlRmxvYXQoIHN0YXJ0ICk7CgkJCQkJCQl9CgkJCQkJCX0gZWxzZSBpZiAoIGpzQ291bnQgKSB7CgkJCQkJCQkJY291bnRlciA9IDE7CgkJCQkJCX0JCgkJCQkJfQoJCQkJCgkJCQl9IGVsc2UgewoJCQkJCWl0ZW1DbGFzcyArPSAiIHVpLWxpLXN0YXRpYyB1aS1idG4tdXAtIiArIGl0ZW1UaGVtZTsKCQkJCX0KCQkJfQoKCQkJaWYgKCBvbCAmJiBqc0NvdW50ICYmIGl0ZW1DbGFzcy5pbmRleE9mKCAidWktbGktZGl2aWRlciIgKSA8IDAgKSB7CgkJCQljb3VudFBhcmVudCA9IGl0ZW1DbGFzcy5pbmRleE9mKCAidWktbGktc3RhdGljIiApID4gMCA/IGl0ZW0gOiBpdGVtLmZpbmQoICIudWktbGluay1pbmhlcml0IiApOwoKCQkJCWNvdW50UGFyZW50LmFkZENsYXNzKCAidWktbGktanNudW1iZXJpbmciICkKCQkJCQkucHJlcGVuZCggIjxzcGFuIGNsYXNzPSd1aS1saS1kZWMnPiIgKyAoIGNvdW50ZXIrKyApICsgIi4gPC9zcGFuPiIgKTsKCQkJfQoKCQkJLy8gSW5zdGVhZCBvZiBzZXR0aW5nIGl0ZW0gY2xhc3MgZGlyZWN0bHkgb24gdGhlIGxpc3QgaXRlbSBhbmQgaXRzCgkJCS8vIGJ0bi1pbm5lciBhdCB0aGlzIHBvaW50IGluIHRpbWUsIHB1c2ggdGhlIGl0ZW0gaW50byBhIGRpY3Rpb25hcnkKCQkJLy8gdGhhdCB0ZWxscyB1cyB3aGF0IGNsYXNzIHRvIHNldCBvbiBpdCBzbyB3ZSBjYW4gZG8gdGhpcyBhZnRlciB0aGlzCgkJCS8vIHByb2Nlc3NpbmcgbG9vcCBpcyBmaW5pc2hlZC4KCgkJCWlmICggIWl0ZW1DbGFzc0RpY3RbIGl0ZW1DbGFzcyBdICkgewoJCQkJaXRlbUNsYXNzRGljdFsgaXRlbUNsYXNzIF0gPSBbXTsKCQkJfQoKCQkJaXRlbUNsYXNzRGljdFsgaXRlbUNsYXNzIF0ucHVzaCggaXRlbVsgMCBdICk7CgkJfQoKCQkvLyBTZXQgdGhlIGFwcHJvcHJpYXRlIGxpc3R2aWV3IGl0ZW0gY2xhc3NlcyBvbiBlYWNoIGxpc3QgaXRlbQoJCS8vIGFuZCB0aGVpciBidG4taW5uZXIgZWxlbWVudHMuIFRoZSBtYWluIHJlYXNvbiB3ZSBkaWRuJ3QgZG8gdGhpcwoJCS8vIGluIHRoZSBmb3ItbG9vcCBhYm92ZSBpcyBiZWNhdXNlIHdlIGNhbiBlbGltaW5hdGUgcGVyLWl0ZW0gZnVuY3Rpb24gb3ZlcmhlYWQKCQkvLyBieSBjYWxsaW5nIGFkZENsYXNzKCkgYW5kIGNoaWxkcmVuKCkgb25jZSBvciB0d2ljZSBhZnRlcndhcmRzLiBUaGlzCgkJLy8gY2FuIGdpdmUgdXMgYSBzaWduaWZpY2FudCBib29zdCBvbiBwbGF0Zm9ybXMgbGlrZSBXUDcuNS4KCgkJZm9yICggaXRlbUNsYXNzIGluIGl0ZW1DbGFzc0RpY3QgKSB7CgkJCSQoIGl0ZW1DbGFzc0RpY3RbIGl0ZW1DbGFzcyBdICkuYWRkQ2xhc3MoIGl0ZW1DbGFzcyApLmNoaWxkcmVuKCAiLnVpLWJ0bi1pbm5lciIgKS5hZGRDbGFzcyggaXRlbUNsYXNzICk7CgkJfQoKCQkkbGlzdC5maW5kKCAiaDEsIGgyLCBoMywgaDQsIGg1LCBoNiIgKS5hZGRDbGFzcyggInVpLWxpLWhlYWRpbmciICkKCQkJLmVuZCgpCgoJCQkuZmluZCggInAsIGRsIiApLmFkZENsYXNzKCAidWktbGktZGVzYyIgKQoJCQkuZW5kKCkKCgkJCS5maW5kKCAiLnVpLWxpLWFzaWRlIiApLmVhY2goZnVuY3Rpb24oKSB7CgkJCQkJdmFyICR0aGlzID0gJCggdGhpcyApOwoJCQkJCSR0aGlzLnByZXBlbmRUbyggJHRoaXMucGFyZW50KCkgKTsgLy9zaGlmdCBhc2lkZSB0byBmcm9udCBmb3IgY3NzIGZsb2F0CgkJCQl9KQoJCQkuZW5kKCkKCgkJCS5maW5kKCAiLnVpLWxpLWNvdW50IiApLmVhY2goZnVuY3Rpb24oKSB7CgkJCQkJJCggdGhpcyApLmNsb3Nlc3QoICJsaSIgKS5hZGRDbGFzcyggInVpLWxpLWhhcy1jb3VudCIgKTsKCQkJCX0pLmFkZENsYXNzKCAidWktYnRuLXVwLSIgKyAoICRsaXN0LmpxbURhdGEoICJjb3VudHRoZW1lIiApIHx8IHRoaXMub3B0aW9ucy5jb3VudFRoZW1lKSArICIgdWktYnRuLWNvcm5lci1hbGwiICk7CgoJCS8vIFRoZSBpZGVhIGhlcmUgaXMgdG8gbG9vayBhdCB0aGUgZmlyc3QgaW1hZ2UgaW4gdGhlIGxpc3QgaXRlbQoJCS8vIGl0c2VsZiwgYW5kIGFueSAudWktbGluay1pbmhlcml0IGVsZW1lbnQgaXQgbWF5IGNvbnRhaW4sIHNvIHdlCgkJLy8gY2FuIHBsYWNlIHRoZSBhcHByb3ByaWF0ZSBjbGFzc2VzIG9uIHRoZSBpbWFnZSBhbmQgbGlzdCBpdGVtLgoJCS8vIE5vdGUgdGhhdCB3ZSB1c2VkIHRvIHVzZSBzb21ldGhpbmcgbGlrZToKCQkvLwoJCS8vICAgIGxpLmZpbmQoIj5pbWc6ZXEoMCksIC51aS1saW5rLWluaGVyaXQ+aW1nOmVxKDApIikuZWFjaCggLi4uICk7CgkJLy8KCQkvLyBCdXQgZXhlY3V0aW5nIGEgZmluZCgpIGxpa2UgdGhhdCBvbiBXaW5kb3dzIFBob25lIDcuNSB0b29rIGEKCQkvLyByZWFsbHkgbG9uZyB0aW1lLiBXYWxraW5nIHRoaW5ncyBtYW51YWxseSB3aXRoIHRoZSBjb2RlIGJlbG93CgkJLy8gYWxsb3dzIHRoZSA0MDAgbGlzdHZpZXcgaXRlbSBwYWdlIHRvIGxvYWQgaW4gYWJvdXQgMyBzZWNvbmRzIGFzCgkJLy8gb3Bwb3NlZCB0byAzMCBzZWNvbmRzLgoKCQl0aGlzLl9hZGRUaHVtYkNsYXNzZXMoIGxpICk7CgkJdGhpcy5fYWRkVGh1bWJDbGFzc2VzKCAkbGlzdC5maW5kKCAiLnVpLWxpbmstaW5oZXJpdCIgKSApOwoKCQl0aGlzLl9yZWZyZXNoQ29ybmVycyggY3JlYXRlICk7CgogICAgLy8gYXV0b2RpdmlkZXJzIGJpbmRzIHRvIHRoaXMgdG8gcmVkcmF3IGRpdmlkZXJzIGFmdGVyIHRoZSBsaXN0dmlldyByZWZyZXNoCgkJdGhpcy5fdHJpZ2dlciggImFmdGVycmVmcmVzaCIgKTsKCX0sCgoJLy9jcmVhdGUgYSBzdHJpbmcgZm9yIElEL3N1YnBhZ2UgdXJsIGNyZWF0aW9uCglfaWRTdHJpbmdFc2NhcGU6IGZ1bmN0aW9uKCBzdHIgKSB7CgkJcmV0dXJuIHN0ci5yZXBsYWNlKC9bXmEtekEtWjAtOV0vZywgJy0nKTsKCX0sCgoJX2NyZWF0ZVN1YlBhZ2VzOiBmdW5jdGlvbigpIHsKCQl2YXIgcGFyZW50TGlzdCA9IHRoaXMuZWxlbWVudCwKCQkJcGFyZW50UGFnZSA9IHBhcmVudExpc3QuY2xvc2VzdCggIi51aS1wYWdlIiApLAoJCQlwYXJlbnRVcmwgPSBwYXJlbnRQYWdlLmpxbURhdGEoICJ1cmwiICksCgkJCXBhcmVudElkID0gcGFyZW50VXJsIHx8IHBhcmVudFBhZ2VbIDAgXVsgJC5leHBhbmRvIF0sCgkJCXBhcmVudExpc3RJZCA9IHBhcmVudExpc3QuYXR0ciggImlkIiApLAoJCQlvID0gdGhpcy5vcHRpb25zLAoJCQlkbnMgPSAiZGF0YS0iICsgJC5tb2JpbGUubnMsCgkJCXNlbGYgPSB0aGlzLAoJCQlwZXJzaXN0ZW50Rm9vdGVySUQgPSBwYXJlbnRQYWdlLmZpbmQoICI6anFtRGF0YShyb2xlPSdmb290ZXInKSIgKS5qcW1EYXRhKCAiaWQiICksCgkJCWhhc1N1YlBhZ2VzOwoKCQlpZiAoIHR5cGVvZiBsaXN0Q291bnRQZXJQYWdlWyBwYXJlbnRJZCBdID09PSAidW5kZWZpbmVkIiApIHsKCQkJbGlzdENvdW50UGVyUGFnZVsgcGFyZW50SWQgXSA9IC0xOwoJCX0KCgkJcGFyZW50TGlzdElkID0gcGFyZW50TGlzdElkIHx8ICsrbGlzdENvdW50UGVyUGFnZVsgcGFyZW50SWQgXTsKCgkJJCggcGFyZW50TGlzdC5maW5kKCAibGk+dWwsIGxpPm9sIiApLnRvQXJyYXkoKS5yZXZlcnNlKCkgKS5lYWNoKGZ1bmN0aW9uKCBpICkgewoJCQl2YXIgc2VsZiA9IHRoaXMsCgkJCQlsaXN0ID0gJCggdGhpcyApLAoJCQkJbGlzdElkID0gbGlzdC5hdHRyKCAiaWQiICkgfHwgcGFyZW50TGlzdElkICsgIi0iICsgaSwKCQkJCXBhcmVudCA9IGxpc3QucGFyZW50KCksCgkJCQlub2RlRWxzRnVsbCA9ICQoIGxpc3QucHJldkFsbCgpLnRvQXJyYXkoKS5yZXZlcnNlKCkgKSwKCQkJCW5vZGVFbHMgPSBub2RlRWxzRnVsbC5sZW5ndGggPyBub2RlRWxzRnVsbCA6ICQoICI8c3Bhbj4iICsgJC50cmltKHBhcmVudC5jb250ZW50cygpWyAwIF0ubm9kZVZhbHVlKSArICI8L3NwYW4+IiApLAoJCQkJdGl0bGUgPSBub2RlRWxzLmZpcnN0KCkuZ2V0RW5jb2RlZFRleHQoKSwvL3VybCBsaW1pdHMgdG8gZmlyc3QgMzAgY2hhcnMgb2YgdGV4dAoJCQkJaWQgPSAoIHBhcmVudFVybCB8fCAiIiApICsgIiYiICsgJC5tb2JpbGUuc3ViUGFnZVVybEtleSArICI9IiArIGxpc3RJZCwKCQkJCXRoZW1lID0gbGlzdC5qcW1EYXRhKCAidGhlbWUiICkgfHwgby50aGVtZSwKCQkJCWNvdW50VGhlbWUgPSBsaXN0LmpxbURhdGEoICJjb3VudHRoZW1lIiApIHx8IHBhcmVudExpc3QuanFtRGF0YSggImNvdW50dGhlbWUiICkgfHwgby5jb3VudFRoZW1lLAoJCQkJbmV3UGFnZSwgYW5jaG9yOwoKCQkJLy9kZWZpbmUgaGFzU3ViUGFnZXMgZm9yIHVzZSBpbiBsYXRlciByZW1vdmFsCgkJCWhhc1N1YlBhZ2VzID0gdHJ1ZTsKCgkJCW5ld1BhZ2UgPSBsaXN0LmRldGFjaCgpCgkJCQkJCS53cmFwKCAiPGRpdiAiICsgZG5zICsgInJvbGU9J3BhZ2UnICIgKyBkbnMgKyAidXJsPSciICsgaWQgKyAiJyAiICsgZG5zICsgInRoZW1lPSciICsgdGhlbWUgKyAiJyAiICsgZG5zICsgImNvdW50LXRoZW1lPSciICsgY291bnRUaGVtZSArICInPjxkaXYgIiArIGRucyArICJyb2xlPSdjb250ZW50Jz48L2Rpdj48L2Rpdj4iICkKCQkJCQkJLnBhcmVudCgpCgkJCQkJCQkuYmVmb3JlKCAiPGRpdiAiICsgZG5zICsgInJvbGU9J2hlYWRlcicgIiArIGRucyArICJ0aGVtZT0nIiArIG8uaGVhZGVyVGhlbWUgKyAiJz48ZGl2IGNsYXNzPSd1aS10aXRsZSc+IiArIHRpdGxlICsgIjwvZGl2PjwvZGl2PiIgKQoJCQkJCQkJLmFmdGVyKCBwZXJzaXN0ZW50Rm9vdGVySUQgPyAkKCAiPGRpdiAiICsgZG5zICsgInJvbGU9J2Zvb3RlcicgIiArIGRucyArICJpZD0nIisgcGVyc2lzdGVudEZvb3RlcklEICsiJz4iICkgOiAiIiApCgkJCQkJCQkucGFyZW50KCkKCQkJCQkJCQkuYXBwZW5kVG8oICQubW9iaWxlLnBhZ2VDb250YWluZXIgKTsKCgkJCW5ld1BhZ2UucGFnZSgpOwoKCQkJYW5jaG9yID0gcGFyZW50LmZpbmQoICdhOmZpcnN0JyApOwoKCQkJaWYgKCAhYW5jaG9yLmxlbmd0aCApIHsKCQkJCWFuY2hvciA9ICQoICI8YS8+IiApLmh0bWwoIG5vZGVFbHMgfHwgdGl0bGUgKS5wcmVwZW5kVG8oIHBhcmVudC5lbXB0eSgpICk7CgkJCX0KCgkJCWFuY2hvci5hdHRyKCAiaHJlZiIsICIjIiArIGlkICk7CgoJCX0pLmxpc3R2aWV3KCk7CgoJCS8vIG9uIHBhZ2VoaWRlLCByZW1vdmUgYW55IG5lc3RlZCBwYWdlcyBhbG9uZyB3aXRoIHRoZSBwYXJlbnQgcGFnZSwgYXMgbG9uZyBhcyB0aGV5IGFyZW4ndCBhY3RpdmUKCQkvLyBhbmQgYXJlbid0IGVtYmVkZGVkCgkJaWYgKCBoYXNTdWJQYWdlcyAmJgoJCQlwYXJlbnRQYWdlLmlzKCAiOmpxbURhdGEoZXh0ZXJuYWwtcGFnZT0ndHJ1ZScpIiApICYmCgkJCXBhcmVudFBhZ2UuZGF0YSggInBhZ2UiICkub3B0aW9ucy5kb21DYWNoZSA9PT0gZmFsc2UgKSB7CgoJCQl2YXIgbmV3UmVtb3ZlID0gZnVuY3Rpb24oIGUsIHVpICkgewoJCQkJdmFyIG5leHRQYWdlID0gdWkubmV4dFBhZ2UsIG5wVVJMLAoJCQkJCXByRXZlbnQgPSBuZXcgJC5FdmVudCggInBhZ2VyZW1vdmUiICk7CgoJCQkJaWYgKCB1aS5uZXh0UGFnZSApIHsKCQkJCQlucFVSTCA9IG5leHRQYWdlLmpxbURhdGEoICJ1cmwiICk7CgkJCQkJaWYgKCBucFVSTC5pbmRleE9mKCBwYXJlbnRVcmwgKyAiJiIgKyAkLm1vYmlsZS5zdWJQYWdlVXJsS2V5ICkgIT09IDAgKSB7CgkJCQkJCXNlbGYuY2hpbGRQYWdlcygpLnJlbW92ZSgpOwoJCQkJCQlwYXJlbnRQYWdlLnRyaWdnZXIoIHByRXZlbnQgKTsKCQkJCQkJaWYgKCAhcHJFdmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJCQkJCXBhcmVudFBhZ2UucmVtb3ZlV2l0aERlcGVuZGVudHMoKTsKCQkJCQkJfQoJCQkJCX0KCQkJCX0KCQkJfTsKCgkJCS8vIHVuYmluZCB0aGUgb3JpZ2luYWwgcGFnZSByZW1vdmUgYW5kIHJlcGxhY2Ugd2l0aCBvdXIgc3BlY2lhbGl6ZWQgdmVyc2lvbgoJCQlwYXJlbnRQYWdlCgkJCQkudW5iaW5kKCAicGFnZWhpZGUucmVtb3ZlIiApCgkJCQkuYmluZCggInBhZ2VoaWRlLnJlbW92ZSIsIG5ld1JlbW92ZSk7CgkJfQoJfSwKCgkvLyBUT0RPIHNvcnQgb3V0IGEgYmV0dGVyIHdheSB0byB0cmFjayBzdWIgcGFnZXMgb2YgdGhlIGxpc3R2aWV3IHRoaXMgaXMgYnJpdHRsZQoJY2hpbGRQYWdlczogZnVuY3Rpb24oKSB7CgkJdmFyIHBhcmVudFVybCA9IHRoaXMucGFyZW50UGFnZS5qcW1EYXRhKCAidXJsIiApOwoKCQlyZXR1cm4gJCggIjpqcW1EYXRhKHVybF49JyIrICBwYXJlbnRVcmwgKyAiJiIgKyAkLm1vYmlsZS5zdWJQYWdlVXJsS2V5ICsgIicpIiApOwoJfQp9KTsKCi8vYXV0byBzZWxmLWluaXQgd2lkZ2V0cwokKCBkb2N1bWVudCApLmJpbmQoICJwYWdlY3JlYXRlIGNyZWF0ZSIsIGZ1bmN0aW9uKCBlICkgewoJJC5tb2JpbGUubGlzdHZpZXcucHJvdG90eXBlLmVuaGFuY2VXaXRoaW4oIGUudGFyZ2V0ICk7Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS5saXN0dmlldy5wcm90b3R5cGUub3B0aW9ucy5hdXRvZGl2aWRlcnMgPSBmYWxzZTsKJC5tb2JpbGUubGlzdHZpZXcucHJvdG90eXBlLm9wdGlvbnMuYXV0b2RpdmlkZXJzU2VsZWN0b3IgPSBmdW5jdGlvbiggZWx0ICkgewoJLy8gbG9vayBmb3IgdGhlIHRleHQgaW4gdGhlIGdpdmVuIGVsZW1lbnQKCXZhciB0ZXh0ID0gZWx0LnRleHQoKSB8fCBudWxsOwoKCWlmICggIXRleHQgKSB7CgkJcmV0dXJuIG51bGw7Cgl9CgoJLy8gY3JlYXRlIHRoZSB0ZXh0IGZvciB0aGUgZGl2aWRlciAoZmlyc3QgdXBwZXJjYXNlZCBsZXR0ZXIpCgl0ZXh0ID0gdGV4dC5zbGljZSggMCwgMSApLnRvVXBwZXJDYXNlKCk7CgoJcmV0dXJuIHRleHQ7Cn07CgokKCBkb2N1bWVudCApLmRlbGVnYXRlKCAidWwsb2wiLCAibGlzdHZpZXdjcmVhdGUiLCBmdW5jdGlvbigpIHsKCgl2YXIgbGlzdCA9ICQoIHRoaXMgKSwKCQkJbGlzdHZpZXcgPSBsaXN0LmRhdGEoICJsaXN0dmlldyIgKTsKCglpZiAoICFsaXN0dmlldyB8fCAhbGlzdHZpZXcub3B0aW9ucy5hdXRvZGl2aWRlcnMgKSB7CgkJcmV0dXJuOwoJfQoKCXZhciByZXBsYWNlRGl2aWRlcnMgPSBmdW5jdGlvbiAoKSB7CgkJbGlzdC5maW5kKCAibGk6anFtRGF0YShyb2xlPSdsaXN0LWRpdmlkZXInKSIgKS5yZW1vdmUoKTsKCgkJdmFyIGxpcyA9IGxpc3QuZmluZCggJ2xpJyApLAoJCQlsYXN0RGl2aWRlclRleHQgPSBudWxsLCBsaSwgZGl2aWRlclRleHQ7CgoJCWZvciAoIHZhciBpID0gMDsgaSA8IGxpcy5sZW5ndGggOyBpKysgKSB7CgkJCWxpID0gbGlzW2ldOwoJCQlkaXZpZGVyVGV4dCA9IGxpc3R2aWV3Lm9wdGlvbnMuYXV0b2RpdmlkZXJzU2VsZWN0b3IoICQoIGxpICkgKTsKCgkJCWlmICggZGl2aWRlclRleHQgJiYgbGFzdERpdmlkZXJUZXh0ICE9PSBkaXZpZGVyVGV4dCApIHsKCQkJCXZhciBkaXZpZGVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggJ2xpJyApOwoJCQkJZGl2aWRlci5hcHBlbmRDaGlsZCggZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoIGRpdmlkZXJUZXh0ICkgKTsKCQkJCWRpdmlkZXIuc2V0QXR0cmlidXRlKCAnZGF0YS0nICsgJC5tb2JpbGUubnMgKyAncm9sZScsICdsaXN0LWRpdmlkZXInICk7CgkJCQlsaS5wYXJlbnROb2RlLmluc2VydEJlZm9yZSggZGl2aWRlciwgbGkgKTsKCQkJfQoKCQkJbGFzdERpdmlkZXJUZXh0ID0gZGl2aWRlclRleHQ7CgkJfQoJfTsKCgl2YXIgYWZ0ZXJMaXN0dmlld1JlZnJlc2ggPSBmdW5jdGlvbiAoKSB7CgkJbGlzdC51bmJpbmQoICdsaXN0dmlld2FmdGVycmVmcmVzaCcsIGFmdGVyTGlzdHZpZXdSZWZyZXNoICk7CgkJcmVwbGFjZURpdmlkZXJzKCk7CgkJbGlzdHZpZXcucmVmcmVzaCgpOwoJCWxpc3QuYmluZCggJ2xpc3R2aWV3YWZ0ZXJyZWZyZXNoJywgYWZ0ZXJMaXN0dmlld1JlZnJlc2ggKTsKCX07CgoJYWZ0ZXJMaXN0dmlld1JlZnJlc2goKTsKfSk7Cgp9KSggalF1ZXJ5ICk7CgovKgoqICJjaGVja2JveHJhZGlvIiBwbHVnaW4KKi8KCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUuY2hlY2tib3hyYWRpbyIsICQubW9iaWxlLndpZGdldCwgewoJb3B0aW9uczogewoJCXRoZW1lOiBudWxsLAoJCWluaXRTZWxlY3RvcjogImlucHV0W3R5cGU9J2NoZWNrYm94J10saW5wdXRbdHlwZT0ncmFkaW8nXSIKCX0sCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXMsCgkJCWlucHV0ID0gdGhpcy5lbGVtZW50LAoJCQlpbmhlcml0QXR0ciA9IGZ1bmN0aW9uKCBpbnB1dCwgZGF0YUF0dHIgKSB7CgkJCQlyZXR1cm4gaW5wdXQuanFtRGF0YSggZGF0YUF0dHIgKSB8fCBpbnB1dC5jbG9zZXN0KCAiZm9ybSwgZmllbGRzZXQiICkuanFtRGF0YSggZGF0YUF0dHIgKTsKCQkJfSwKCQkJLy8gTk9URTogV2luZG93cyBQaG9uZSBjb3VsZCBub3QgZmluZCB0aGUgbGFiZWwgdGhyb3VnaCBhIHNlbGVjdG9yCgkJCS8vIGZpbHRlciB3b3JrcyB0aG91Z2guCgkJCXBhcmVudExhYmVsID0gJCggaW5wdXQgKS5jbG9zZXN0KCAibGFiZWwiICksCgkJCWxhYmVsID0gcGFyZW50TGFiZWwubGVuZ3RoID8gcGFyZW50TGFiZWwgOiAkKCBpbnB1dCApLmNsb3Nlc3QoICJmb3JtLCBmaWVsZHNldCwgOmpxbURhdGEocm9sZT0ncGFnZScpLCA6anFtRGF0YShyb2xlPSdkaWFsb2cnKSIgKS5maW5kKCAibGFiZWwiICkuZmlsdGVyKCAiW2Zvcj0nIiArIGlucHV0WzBdLmlkICsgIiddIiApLmZpcnN0KCksCgkJCWlucHV0dHlwZSA9IGlucHV0WzBdLnR5cGUsCgkJCW1pbmkgPSBpbmhlcml0QXR0ciggaW5wdXQsICJtaW5pIiApLAoJCQljaGVja2VkU3RhdGUgPSBpbnB1dHR5cGUgKyAiLW9uIiwKCQkJdW5jaGVja2VkU3RhdGUgPSBpbnB1dHR5cGUgKyAiLW9mZiIsCgkJCWljb24gPSBpbnB1dC5wYXJlbnRzKCAiOmpxbURhdGEodHlwZT0naG9yaXpvbnRhbCcpIiApLmxlbmd0aCA/IHVuZGVmaW5lZCA6IHVuY2hlY2tlZFN0YXRlLAoJCQlpY29ucG9zID0gaW5oZXJpdEF0dHIoIGlucHV0LCAiaWNvbnBvcyIgKSwKCQkJYWN0aXZlQnRuID0gaWNvbiA/ICIiIDogIiAiICsgJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MsCgkJCWNoZWNrZWRDbGFzcyA9ICJ1aS0iICsgY2hlY2tlZFN0YXRlICsgYWN0aXZlQnRuLAoJCQl1bmNoZWNrZWRDbGFzcyA9ICJ1aS0iICsgdW5jaGVja2VkU3RhdGUsCgkJCWNoZWNrZWRpY29uID0gInVpLWljb24tIiArIGNoZWNrZWRTdGF0ZSwKCQkJdW5jaGVja2VkaWNvbiA9ICJ1aS1pY29uLSIgKyB1bmNoZWNrZWRTdGF0ZTsKCgkJaWYgKCBpbnB1dHR5cGUgIT09ICJjaGVja2JveCIgJiYgaW5wdXR0eXBlICE9PSAicmFkaW8iICkgewoJCQlyZXR1cm47CgkJfQoKCQkvLyBFeHBvc2UgZm9yIG90aGVyIG1ldGhvZHMKCQkkLmV4dGVuZCggdGhpcywgewoJCQlsYWJlbDogbGFiZWwsCgkJCWlucHV0dHlwZTogaW5wdXR0eXBlLAoJCQljaGVja2VkQ2xhc3M6IGNoZWNrZWRDbGFzcywKCQkJdW5jaGVja2VkQ2xhc3M6IHVuY2hlY2tlZENsYXNzLAoJCQljaGVja2VkaWNvbjogY2hlY2tlZGljb24sCgkJCXVuY2hlY2tlZGljb246IHVuY2hlY2tlZGljb24KCQl9KTsKCgkJLy8gSWYgdGhlcmUncyBubyBzZWxlY3RlZCB0aGVtZSBjaGVjayB0aGUgZGF0YSBhdHRyCgkJaWYgKCAhdGhpcy5vcHRpb25zLnRoZW1lICkgewoJCQl0aGlzLm9wdGlvbnMudGhlbWUgPSAkLm1vYmlsZS5nZXRJbmhlcml0ZWRUaGVtZSggdGhpcy5lbGVtZW50LCAiYyIgKTsKCQl9CgoJCWxhYmVsLmJ1dHRvbk1hcmt1cCh7CgkJCXRoZW1lOiB0aGlzLm9wdGlvbnMudGhlbWUsCgkJCWljb246IGljb24sCgkJCXNoYWRvdzogZmFsc2UsCgkJCW1pbmk6IG1pbmksCgkJCWljb25wb3M6IGljb25wb3MKCQl9KTsKCgkJLy8gV3JhcCB0aGUgaW5wdXQgKyBsYWJlbCBpbiBhIGRpdgoJCXZhciB3cmFwcGVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CgkJd3JhcHBlci5jbGFzc05hbWUgPSAndWktJyArIGlucHV0dHlwZTsKCgkJaW5wdXQuYWRkKCBsYWJlbCApLndyYXBBbGwoIHdyYXBwZXIgKTsKCgkJbGFiZWwuYmluZCh7CgkJCXZtb3VzZW92ZXI6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCWlmICggJCggdGhpcyApLnBhcmVudCgpLmlzKCAiLnVpLWRpc2FibGVkIiApICkgewoJCQkJCWV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOwoJCQkJfQoJCQl9LAoKCQkJdmNsaWNrOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQlpZiAoIGlucHV0LmlzKCAiOmRpc2FibGVkIiApICkgewoJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCXNlbGYuX2NhY2hlVmFscygpOwoKCQkJCWlucHV0LnByb3AoICJjaGVja2VkIiwgaW5wdXR0eXBlID09PSAicmFkaW8iICYmIHRydWUgfHwgIWlucHV0LnByb3AoICJjaGVja2VkIiApICk7CgoJCQkJLy8gdHJpZ2dlciBjbGljayBoYW5kbGVyJ3MgYm91bmQgZGlyZWN0bHkgdG8gdGhlIGlucHV0IGFzIGEgc3Vic3RpdHV0ZSBmb3IKCQkJCS8vIGhvdyBsYWJlbCBjbGlja3MgYmVoYXZlIG5vcm1hbGx5IGluIHRoZSBicm93c2VycwoJCQkJLy8gVE9ETzogaXQgd291bGQgYmUgbmljZSB0byBsZXQgdGhlIGJyb3dzZXIncyBoYW5kbGUgdGhlIGNsaWNrcyBhbmQgcGFzcyB0aGVtCgkJCQkvLyAgICAgICB0aHJvdWdoIHRvIHRoZSBhc3NvY2lhdGUgaW5wdXQuIHdlIGNhbiBzd2FsbG93IHRoYXQgY2xpY2sgYXQgdGhlIHBhcmVudAoJCQkJLy8gICAgICAgd3JhcHBlciBlbGVtZW50IGxldmVsCgkJCQlpbnB1dC50cmlnZ2VySGFuZGxlciggJ2NsaWNrJyApOwoKCQkJCS8vIElucHV0IHNldCBmb3IgY29tbW9uIHJhZGlvIGJ1dHRvbnMgd2lsbCBjb250YWluIGFsbCB0aGUgcmFkaW8KCQkJCS8vIGJ1dHRvbnMsIGJ1dCB3aWxsIG5vdCBmb3IgY2hlY2tib3hlcy4gY2xlYXJpbmcgdGhlIGNoZWNrZWQgc3RhdHVzCgkJCQkvLyBvZiBvdGhlciByYWRpb3MgZW5zdXJlcyB0aGUgYWN0aXZlIGJ1dHRvbiBzdGF0ZSBpcyBhcHBsaWVkIHByb3Blcmx5CgkJCQlzZWxmLl9nZXRJbnB1dFNldCgpLm5vdCggaW5wdXQgKS5wcm9wKCAiY2hlY2tlZCIsIGZhbHNlICk7CgoJCQkJc2VsZi5fdXBkYXRlQWxsKCk7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCQl9KTsKCgkJaW5wdXQKCQkJLmJpbmQoewoJCQkJdm1vdXNlZG93bjogZnVuY3Rpb24oKSB7CgkJCQkJc2VsZi5fY2FjaGVWYWxzKCk7CgkJCQl9LAoKCQkJCXZjbGljazogZnVuY3Rpb24oKSB7CgkJCQkJdmFyICR0aGlzID0gJCggdGhpcyApOwoKCQkJCQkvLyBBZGRzIGNoZWNrZWQgYXR0cmlidXRlIHRvIGNoZWNrZWQgaW5wdXQgd2hlbiBrZXlib2FyZCBpcyB1c2VkCgkJCQkJaWYgKCAkdGhpcy5pcyggIjpjaGVja2VkIiApICkgewoKCQkJCQkJJHRoaXMucHJvcCggImNoZWNrZWQiLCB0cnVlKTsKCQkJCQkJc2VsZi5fZ2V0SW5wdXRTZXQoKS5ub3QoICR0aGlzICkucHJvcCggImNoZWNrZWQiLCBmYWxzZSApOwoJCQkJCX0gZWxzZSB7CgoJCQkJCQkkdGhpcy5wcm9wKCAiY2hlY2tlZCIsIGZhbHNlICk7CgkJCQkJfQoKCQkJCQlzZWxmLl91cGRhdGVBbGwoKTsKCQkJCX0sCgoJCQkJZm9jdXM6IGZ1bmN0aW9uKCkgewoJCQkJCWxhYmVsLmFkZENsYXNzKCAkLm1vYmlsZS5mb2N1c0NsYXNzICk7CgkJCQl9LAoKCQkJCWJsdXI6IGZ1bmN0aW9uKCkgewoJCQkJCWxhYmVsLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5mb2N1c0NsYXNzICk7CgkJCQl9CgkJCX0pOwoKCQl0aGlzLnJlZnJlc2goKTsKCX0sCgoJX2NhY2hlVmFsczogZnVuY3Rpb24oKSB7CgkJdGhpcy5fZ2V0SW5wdXRTZXQoKS5lYWNoKGZ1bmN0aW9uKCkgewoJCQkkKCB0aGlzICkuanFtRGF0YSggImNhY2hlVmFsIiwgdGhpcy5jaGVja2VkICk7CgkJfSk7Cgl9LAoKCS8vcmV0dXJucyBlaXRoZXIgYSBzZXQgb2YgcmFkaW9zIHdpdGggdGhlIHNhbWUgbmFtZSBhdHRyaWJ1dGUsIG9yIGEgc2luZ2xlIGNoZWNrYm94CglfZ2V0SW5wdXRTZXQ6IGZ1bmN0aW9uKCkgewoJCWlmICggdGhpcy5pbnB1dHR5cGUgPT09ICJjaGVja2JveCIgKSB7CgkJCXJldHVybiB0aGlzLmVsZW1lbnQ7CgkJfQoKCQlyZXR1cm4gdGhpcy5lbGVtZW50LmNsb3Nlc3QoICJmb3JtLCBmaWVsZHNldCwgOmpxbURhdGEocm9sZT0ncGFnZScpLCA6anFtRGF0YShyb2xlPSdkaWFsb2cnKSIgKQoJCQkuZmluZCggImlucHV0W25hbWU9JyIgKyB0aGlzLmVsZW1lbnRbMF0ubmFtZSArICInXVt0eXBlPSciICsgdGhpcy5pbnB1dHR5cGUgKyAiJ10iICk7Cgl9LAoKCV91cGRhdGVBbGw6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpczsKCgkJdGhpcy5fZ2V0SW5wdXRTZXQoKS5lYWNoKGZ1bmN0aW9uKCkgewoJCQl2YXIgJHRoaXMgPSAkKCB0aGlzICk7CgoJCQlpZiAoIHRoaXMuY2hlY2tlZCB8fCBzZWxmLmlucHV0dHlwZSA9PT0gImNoZWNrYm94IiApIHsKCQkJCSR0aGlzLnRyaWdnZXIoICJjaGFuZ2UiICk7CgkJCX0KCQl9KQoJCS5jaGVja2JveHJhZGlvKCAicmVmcmVzaCIgKTsKCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJdmFyIGlucHV0ID0gdGhpcy5lbGVtZW50WzBdLAoJCQlsYWJlbCA9IHRoaXMubGFiZWwsCgkJCWljb24gPSBsYWJlbC5maW5kKCAiLnVpLWljb24iICk7CgoJCWlmICggaW5wdXQuY2hlY2tlZCApIHsKCQkJbGFiZWwuYWRkQ2xhc3MoIHRoaXMuY2hlY2tlZENsYXNzICkucmVtb3ZlQ2xhc3MoIHRoaXMudW5jaGVja2VkQ2xhc3MgKTsKCQkJaWNvbi5hZGRDbGFzcyggdGhpcy5jaGVja2VkaWNvbiApLnJlbW92ZUNsYXNzKCB0aGlzLnVuY2hlY2tlZGljb24gKTsKCQl9IGVsc2UgewoJCQlsYWJlbC5yZW1vdmVDbGFzcyggdGhpcy5jaGVja2VkQ2xhc3MgKS5hZGRDbGFzcyggdGhpcy51bmNoZWNrZWRDbGFzcyApOwoJCQlpY29uLnJlbW92ZUNsYXNzKCB0aGlzLmNoZWNrZWRpY29uICkuYWRkQ2xhc3MoIHRoaXMudW5jaGVja2VkaWNvbiApOwoJCX0KCgkJaWYgKCBpbnB1dC5kaXNhYmxlZCApIHsKCQkJdGhpcy5kaXNhYmxlKCk7CgkJfSBlbHNlIHsKCQkJdGhpcy5lbmFibGUoKTsKCQl9Cgl9LAoKCWRpc2FibGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuZWxlbWVudC5wcm9wKCAiZGlzYWJsZWQiLCB0cnVlICkucGFyZW50KCkuYWRkQ2xhc3MoICJ1aS1kaXNhYmxlZCIgKTsKCX0sCgoJZW5hYmxlOiBmdW5jdGlvbigpIHsKCQl0aGlzLmVsZW1lbnQucHJvcCggImRpc2FibGVkIiwgZmFsc2UgKS5wYXJlbnQoKS5yZW1vdmVDbGFzcyggInVpLWRpc2FibGVkIiApOwoJfQp9KTsKCi8vYXV0byBzZWxmLWluaXQgd2lkZ2V0cwokKCBkb2N1bWVudCApLmJpbmQoICJwYWdlY3JlYXRlIGNyZWF0ZSIsIGZ1bmN0aW9uKCBlICkgewoJJC5tb2JpbGUuY2hlY2tib3hyYWRpby5wcm90b3R5cGUuZW5oYW5jZVdpdGhpbiggZS50YXJnZXQsIHRydWUgKTsKfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLmJ1dHRvbiIsICQubW9iaWxlLndpZGdldCwgewoJb3B0aW9uczogewoJCXRoZW1lOiBudWxsLAoJCWljb246IG51bGwsCgkJaWNvbnBvczogbnVsbCwKCQljb3JuZXJzOiB0cnVlLAoJCXNoYWRvdzogdHJ1ZSwKCQlpY29uc2hhZG93OiB0cnVlLAoJCWluaXRTZWxlY3RvcjogImJ1dHRvbiwgW3R5cGU9J2J1dHRvbiddLCBbdHlwZT0nc3VibWl0J10sIFt0eXBlPSdyZXNldCddIgoJfSwKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXZhciAkZWwgPSB0aGlzLmVsZW1lbnQsCgkJCSRidXR0b24sCgkJCW8gPSB0aGlzLm9wdGlvbnMsCgkJCXR5cGUsCgkJCW5hbWUsCgkJCWlubGluZSA9IG8uaW5saW5lIHx8ICRlbC5qcW1EYXRhKCAiaW5saW5lIiApLAoJCQltaW5pID0gby5taW5pIHx8ICRlbC5qcW1EYXRhKCAibWluaSIgKSwKCQkJY2xhc3NlcyA9ICIiLAoJCQkkYnV0dG9uUGxhY2Vob2xkZXI7CgoJCS8vIGlmIHRoaXMgaXMgYSBsaW5rLCBjaGVjayBpZiBpdCdzIGJlZW4gZW5oYW5jZWQgYW5kLCBpZiBub3QsIHVzZSB0aGUgcmlnaHQgZnVuY3Rpb24KCQlpZiAoICRlbFsgMCBdLnRhZ05hbWUgPT09ICJBIiApIHsKCQkJaWYgKCAhJGVsLmhhc0NsYXNzKCAidWktYnRuIiApICkgewoJCQkJJGVsLmJ1dHRvbk1hcmt1cCgpOwoJCQl9CgoJCQlyZXR1cm47CgkJfQoKCQkvLyBnZXQgdGhlIGluaGVyaXRlZCB0aGVtZQoJCS8vIFRPRE8gY2VudHJhbGl6ZSBmb3IgYWxsIHdpZGdldHMKCQlpZiAoICF0aGlzLm9wdGlvbnMudGhlbWUgKSB7CgkJCXRoaXMub3B0aW9ucy50aGVtZSA9ICQubW9iaWxlLmdldEluaGVyaXRlZFRoZW1lKCB0aGlzLmVsZW1lbnQsICJjIiApOwoJCX0KCgkJLy8gVE9ETzogUG9zdCAxLjEtLW9uY2Ugd2UgaGF2ZSB0aW1lIHRvIHRlc3QgdGhvcm91Z2hseS0tYW55IGNsYXNzZXMgbWFudWFsbHkgYXBwbGllZCB0byB0aGUgb3JpZ2luYWwgZWxlbWVudCBzaG91bGQgYmUgY2FycmllZCBvdmVyIHRvIHRoZSBlbmhhbmNlZCBlbGVtZW50LCB3aXRoIGFuIGAtZW5oYW5jZWRgIHN1ZmZpeC4gU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5LW1vYmlsZS9pc3N1ZXMvMzU3NwoJCS8qIGlmICggJGVsWzBdLmNsYXNzTmFtZS5sZW5ndGggKSB7CgkJCWNsYXNzZXMgPSAkZWxbMF0uY2xhc3NOYW1lOwoJCX0gKi8KCQlpZiAoICEhfiRlbFswXS5jbGFzc05hbWUuaW5kZXhPZiggInVpLWJ0bi1sZWZ0IiApICkgewoJCQljbGFzc2VzID0gInVpLWJ0bi1sZWZ0IjsKCQl9CgoJCWlmICggICEhfiRlbFswXS5jbGFzc05hbWUuaW5kZXhPZiggInVpLWJ0bi1yaWdodCIgKSApIHsKCQkJY2xhc3NlcyA9ICJ1aS1idG4tcmlnaHQiOwoJCX0KCgkJaWYgKCAgJGVsLmF0dHIoICJ0eXBlIiApID09PSAic3VibWl0IiB8fCAkZWwuYXR0ciggInR5cGUiICkgPT09ICJyZXNldCIgKSB7CgkJCWNsYXNzZXMgPyBjbGFzc2VzICs9ICIgdWktc3VibWl0IiA6ICBjbGFzc2VzID0gInVpLXN1Ym1pdCI7CgkJfQoJCSQoICJsYWJlbFtmb3I9JyIgKyAkZWwuYXR0ciggImlkIiApICsgIiddIiApLmFkZENsYXNzKCAidWktc3VibWl0IiApOwoKCQkvLyBBZGQgQVJJQSByb2xlCgkJdGhpcy5idXR0b24gPSAkKCAiPGRpdj48L2Rpdj4iICkKCQkJWyAkZWwuaHRtbCgpID8gImh0bWwiIDogInRleHQiIF0oICRlbC5odG1sKCkgfHwgJGVsLnZhbCgpICkKCQkJLmluc2VydEJlZm9yZSggJGVsICkKCQkJLmJ1dHRvbk1hcmt1cCh7CgkJCQl0aGVtZTogby50aGVtZSwKCQkJCWljb246IG8uaWNvbiwKCQkJCWljb25wb3M6IG8uaWNvbnBvcywKCQkJCWlubGluZTogaW5saW5lLAoJCQkJY29ybmVyczogby5jb3JuZXJzLAoJCQkJc2hhZG93OiBvLnNoYWRvdywKCQkJCWljb25zaGFkb3c6IG8uaWNvbnNoYWRvdywKCQkJCW1pbmk6IG1pbmkKCQkJfSkKCQkJLmFkZENsYXNzKCBjbGFzc2VzICkKCQkJLmFwcGVuZCggJGVsLmFkZENsYXNzKCAidWktYnRuLWhpZGRlbiIgKSApOwoKICAgICAgICAkYnV0dG9uID0gdGhpcy5idXR0b247CgkJdHlwZSA9ICRlbC5hdHRyKCAidHlwZSIgKTsKCQluYW1lID0gJGVsLmF0dHIoICJuYW1lIiApOwoKCQkvLyBBZGQgaGlkZGVuIGlucHV0IGR1cmluZyBzdWJtaXQgaWYgaW5wdXQgdHlwZT0ic3VibWl0IiBoYXMgYSBuYW1lLgoJCWlmICggdHlwZSAhPT0gImJ1dHRvbiIgJiYgdHlwZSAhPT0gInJlc2V0IiAmJiBuYW1lICkgewoJCQkJJGVsLmJpbmQoICJ2Y2xpY2siLCBmdW5jdGlvbigpIHsKCQkJCQkvLyBBZGQgaGlkZGVuIGlucHV0IGlmIGl0IGRvZXNuJ3QgYWxyZWFkeSBleGlzdC4KCQkJCQlpZiAoICRidXR0b25QbGFjZWhvbGRlciA9PT0gdW5kZWZpbmVkICkgewoJCQkJCQkkYnV0dG9uUGxhY2Vob2xkZXIgPSAkKCAiPGlucHV0PiIsIHsKCQkJCQkJCXR5cGU6ICJoaWRkZW4iLAoJCQkJCQkJbmFtZTogJGVsLmF0dHIoICJuYW1lIiApLAoJCQkJCQkJdmFsdWU6ICRlbC5hdHRyKCAidmFsdWUiICkKCQkJCQkJfSkuaW5zZXJ0QmVmb3JlKCAkZWwgKTsKCgkJCQkJCS8vIEJpbmQgdG8gZG9jIHRvIHJlbW92ZSBhZnRlciBzdWJtaXQgaGFuZGxpbmcKCQkJCQkJJCggZG9jdW1lbnQgKS5vbmUoICJzdWJtaXQiLCBmdW5jdGlvbigpIHsKCQkJCQkJCSRidXR0b25QbGFjZWhvbGRlci5yZW1vdmUoKTsKCgkJCQkJCQkvLyByZXNldCB0aGUgbG9jYWwgdmFyIHNvIHRoYXQgdGhlIGhpZGRlbiBpbnB1dAoJCQkJCQkJLy8gd2lsbCBiZSByZS1hZGRlZCBvbiBzdWJzZXF1ZW50IGNsaWNrcwoJCQkJCQkJJGJ1dHRvblBsYWNlaG9sZGVyID0gdW5kZWZpbmVkOwoJCQkJCQl9KTsKCQkJCQl9CgkJCQl9KTsKCQl9CgoJCSRlbC5iaW5kKHsKCQkJZm9jdXM6IGZ1bmN0aW9uKCkgewoJCQkJJGJ1dHRvbi5hZGRDbGFzcyggJC5tb2JpbGUuZm9jdXNDbGFzcyApOwoJCQl9LAoKCQkJYmx1cjogZnVuY3Rpb24oKSB7CgkJCQkkYnV0dG9uLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5mb2N1c0NsYXNzICk7CgkJCX0KCQl9KTsKCgkJdGhpcy5yZWZyZXNoKCk7Cgl9LAoKCWVuYWJsZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5lbGVtZW50LmF0dHIoICJkaXNhYmxlZCIsIGZhbHNlICk7CgkJdGhpcy5idXR0b24ucmVtb3ZlQ2xhc3MoICJ1aS1kaXNhYmxlZCIgKS5hdHRyKCAiYXJpYS1kaXNhYmxlZCIsIGZhbHNlICk7CgkJcmV0dXJuIHRoaXMuX3NldE9wdGlvbiggImRpc2FibGVkIiwgZmFsc2UgKTsKCX0sCgoJZGlzYWJsZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5lbGVtZW50LmF0dHIoICJkaXNhYmxlZCIsIHRydWUgKTsKCQl0aGlzLmJ1dHRvbi5hZGRDbGFzcyggInVpLWRpc2FibGVkIiApLmF0dHIoICJhcmlhLWRpc2FibGVkIiwgdHJ1ZSApOwoJCXJldHVybiB0aGlzLl9zZXRPcHRpb24oICJkaXNhYmxlZCIsIHRydWUgKTsKCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJdmFyICRlbCA9IHRoaXMuZWxlbWVudDsKCgkJaWYgKCAkZWwucHJvcCgiZGlzYWJsZWQiKSApIHsKCQkJdGhpcy5kaXNhYmxlKCk7CgkJfSBlbHNlIHsKCQkJdGhpcy5lbmFibGUoKTsKCQl9CgoJCS8vIEdyYWIgdGhlIGJ1dHRvbidzIHRleHQgZWxlbWVudCBmcm9tIGl0cyBpbXBsZW1lbnRhdGlvbi1pbmRlcGVuZGVudCBkYXRhIGl0ZW0KCQkkKCB0aGlzLmJ1dHRvbi5kYXRhKCAnYnV0dG9uRWxlbWVudHMnICkudGV4dCApWyAkZWwuaHRtbCgpID8gImh0bWwiIDogInRleHQiIF0oICRlbC5odG1sKCkgfHwgJGVsLnZhbCgpICk7Cgl9Cn0pOwoKLy9hdXRvIHNlbGYtaW5pdCB3aWRnZXRzCiQoIGRvY3VtZW50ICkuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKSB7CgkkLm1vYmlsZS5idXR0b24ucHJvdG90eXBlLmVuaGFuY2VXaXRoaW4oIGUudGFyZ2V0LCB0cnVlICk7Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLmZuLmNvbnRyb2xncm91cCA9IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJZnVuY3Rpb24gZmxpcENsYXNzZXMoIGVscywgZmxDb3JuZXJzICApIHsKCQllbHMucmVtb3ZlQ2xhc3MoICJ1aS1idG4tY29ybmVyLWFsbCB1aS1jb3JuZXItdG9wIHVpLWNvcm5lci1ib3R0b20gdWktY29ybmVyLWxlZnQgdWktY29ybmVyLXJpZ2h0IHVpLWNvbnRyb2xncm91cC1sYXN0IHVpLXNoYWRvdyIgKQoJCQkuZXEoIDAgKS5hZGRDbGFzcyggZmxDb3JuZXJzWyAwIF0gKQoJCQkuZW5kKCkKCQkJLmxhc3QoKS5hZGRDbGFzcyggZmxDb3JuZXJzWyAxIF0gKS5hZGRDbGFzcyggInVpLWNvbnRyb2xncm91cC1sYXN0IiApOwoJfQoKCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgkJdmFyICRlbCA9ICQoIHRoaXMgKSwKCQkJbyA9ICQuZXh0ZW5kKHsKCQkJCQkJZGlyZWN0aW9uOiAkZWwuanFtRGF0YSggInR5cGUiICkgfHwgInZlcnRpY2FsIiwKCQkJCQkJc2hhZG93OiBmYWxzZSwKCQkJCQkJZXhjbHVkZUludmlzaWJsZTogdHJ1ZSwKCQkJCQkJbWluaTogJGVsLmpxbURhdGEoICJtaW5pIiApCgkJCQkJfSwgb3B0aW9ucyApLAoJCQlncm91cGxlZ2VuZCA9ICRlbC5jaGlsZHJlbiggImxlZ2VuZCIgKSwKCQkJZ3JvdXBoZWFkaW5nID0gJGVsLmNoaWxkcmVuKCAiLnVpLWNvbnRyb2xncm91cC1sYWJlbCIgKSwKCQkJZ3JvdXBjb250cm9scyA9ICRlbC5jaGlsZHJlbiggIi51aS1jb250cm9sZ3JvdXAtY29udHJvbHMiICksCgkJCWZsQ29ybmVycyA9IG8uZGlyZWN0aW9uID09PSAiaG9yaXpvbnRhbCIgPyBbICJ1aS1jb3JuZXItbGVmdCIsICJ1aS1jb3JuZXItcmlnaHQiIF0gOiBbICJ1aS1jb3JuZXItdG9wIiwgInVpLWNvcm5lci1ib3R0b20iIF0sCgkJCXR5cGUgPSAkZWwuZmluZCggImlucHV0IiApLmZpcnN0KCkuYXR0ciggInR5cGUiICk7CgoJCS8vIEZpcnN0IHVud3JhcCB0aGUgY29udHJvbHMgaWYgdGhlIGNvbnRyb2xncm91cCB3YXMgYWxyZWFkeSBlbmhhbmNlZAoJCWlmICggZ3JvdXBjb250cm9scy5sZW5ndGggKSB7CgkJCWdyb3VwY29udHJvbHMuY29udGVudHMoKS51bndyYXAoKTsKCQl9CgkJJGVsLndyYXBJbm5lciggIjxkaXYgY2xhc3M9J3VpLWNvbnRyb2xncm91cC1jb250cm9scyc+PC9kaXY+IiApOwoKCQlpZiAoIGdyb3VwbGVnZW5kLmxlbmd0aCApIHsKCQkJLy8gUmVwbGFjZSBsZWdlbmQgd2l0aCBtb3JlIHN0eWxhYmxlIHJlcGxhY2VtZW50IGRpdgoJCQkkKCAiPGRpdiByb2xlPSdoZWFkaW5nJyBjbGFzcz0ndWktY29udHJvbGdyb3VwLWxhYmVsJz4iICsgZ3JvdXBsZWdlbmQuaHRtbCgpICsgIjwvZGl2PiIgKS5pbnNlcnRCZWZvcmUoICRlbC5jaGlsZHJlbiggMCApICk7CgkJCWdyb3VwbGVnZW5kLnJlbW92ZSgpOwoJCX0gZWxzZSBpZiAoIGdyb3VwaGVhZGluZy5sZW5ndGggKSB7CgkJCS8vIEp1c3QgbW92ZSB0aGUgaGVhZGluZyBpZiB0aGUgY29udHJvbGdyb3VwIHdhcyBhbHJlYWR5IGVuaGFuY2VkCgkJCSRlbC5wcmVwZW5kKCBncm91cGhlYWRpbmcgKTsKCQl9CgoJCSRlbC5hZGRDbGFzcyggInVpLWNvcm5lci1hbGwgdWktY29udHJvbGdyb3VwIHVpLWNvbnRyb2xncm91cC0iICsgby5kaXJlY3Rpb24gKTsKCgkJZmxpcENsYXNzZXMoICRlbC5maW5kKCAiLnVpLWJ0biIgKyAoIG8uZXhjbHVkZUludmlzaWJsZSA/ICI6dmlzaWJsZSIgOiAiIiApICkubm90KCAnLnVpLXNsaWRlci1oYW5kbGUnICksIGZsQ29ybmVycyApOwoJCWZsaXBDbGFzc2VzKCAkZWwuZmluZCggIi51aS1idG4taW5uZXIiICksIGZsQ29ybmVycyApOwoKCQlpZiAoIG8uc2hhZG93ICkgewoJCQkkZWwuYWRkQ2xhc3MoICJ1aS1zaGFkb3ciICk7CgkJfQoKCQlpZiAoIG8ubWluaSApIHsKCQkJJGVsLmFkZENsYXNzKCAidWktbWluaSIgKTsKCQl9CgoJfSk7Cn07CgovLyBUaGUgcGFnZWNyZWF0ZSBoYW5kbGVyIGZvciBjb250cm9sZ3JvdXAgaXMgaW4ganF1ZXJ5Lm1vYmlsZS5pbml0IGJlY2F1c2Ugb2YgdGhlIHNvZnQtZGVwZW5kZW5jeSBvbiB0aGUgd3JhcHBlZCB3aWRnZXRzCgp9KShqUXVlcnkpOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokKCBkb2N1bWVudCApLmJpbmQoICJwYWdlY3JlYXRlIGNyZWF0ZSIsIGZ1bmN0aW9uKCBlICkgewoKCS8vbGlua3Mgd2l0aGluIGNvbnRlbnQgYXJlYXMsIHRlc3RzIGluY2x1ZGVkIHdpdGggcGFnZQoJJCggZS50YXJnZXQgKQoJCS5maW5kKCAiYSIgKQoJCS5qcW1FbmhhbmNlYWJsZSgpCgkJLm5vdCggIi51aS1idG4sIC51aS1saW5rLWluaGVyaXQsIDpqcW1EYXRhKHJvbGU9J25vbmUnKSwgOmpxbURhdGEocm9sZT0nbm9qcycpIiApCgkJLmFkZENsYXNzKCAidWktbGluayIgKTsKCn0pOwoKfSkoIGpRdWVyeSApOwoKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKCWZ1bmN0aW9uIGZpdFNlZ21lbnRJbnNpZGVTZWdtZW50KCB3aW5TaXplLCBzZWdTaXplLCBvZmZzZXQsIGRlc2lyZWQgKSB7CgkJdmFyIHJldCA9IGRlc2lyZWQ7CgoJCWlmICggd2luU2l6ZSA8IHNlZ1NpemUgKSB7CgkJCS8vIENlbnRlciBzZWdtZW50IGlmIGl0J3MgYmlnZ2VyIHRoYW4gdGhlIHdpbmRvdwoJCQlyZXQgPSBvZmZzZXQgKyAoIHdpblNpemUgLSBzZWdTaXplICkgLyAyOwoJCX0gZWxzZSB7CgkJCS8vIE90aGVyd2lzZSBjZW50ZXIgaXQgYXQgdGhlIGRlc2lyZWQgY29vcmRpbmF0ZSB3aGlsZSBrZWVwaW5nIGl0IGNvbXBsZXRlbHkgaW5zaWRlIHRoZSB3aW5kb3cKCQkJcmV0ID0gTWF0aC5taW4oIE1hdGgubWF4KCBvZmZzZXQsIGRlc2lyZWQgLSBzZWdTaXplIC8gMiApLCBvZmZzZXQgKyB3aW5TaXplIC0gc2VnU2l6ZSApOwoJCX0KCgkJcmV0dXJuIHJldDsKCX0KCglmdW5jdGlvbiB3aW5kb3dDb29yZHMoKSB7CgkJdmFyICR3aW4gPSAkKCB3aW5kb3cgKTsKCgkJcmV0dXJuIHsKCQkJeDogJHdpbi5zY3JvbGxMZWZ0KCksCgkJCXk6ICR3aW4uc2Nyb2xsVG9wKCksCgkJCWN4OiAoIHdpbmRvdy5pbm5lcldpZHRoIHx8ICR3aW4ud2lkdGgoKSApLAoJCQljeTogKCB3aW5kb3cuaW5uZXJIZWlnaHQgfHwgJHdpbi5oZWlnaHQoKSApCgkJfTsKCX0KCgkkLndpZGdldCggIm1vYmlsZS5wb3B1cCIsICQubW9iaWxlLndpZGdldCwgewoJCW9wdGlvbnM6IHsKCQkJdGhlbWU6IG51bGwsCgkJCW92ZXJsYXlUaGVtZTogbnVsbCwKCQkJc2hhZG93OiB0cnVlLAoJCQljb3JuZXJzOiB0cnVlLAoJCQl0cmFuc2l0aW9uOiAibm9uZSIsCgkJCXBvc2l0aW9uVG86ICJvcmlnaW4iLAoJCQl0b2xlcmFuY2U6IG51bGwsCgkJCWluaXRTZWxlY3RvcjogIjpqcW1EYXRhKHJvbGU9J3BvcHVwJykiLAoJCQljbG9zZUxpbmtTZWxlY3RvcjogImE6anFtRGF0YShyZWw9J2JhY2snKSIsCgkJCWNsb3NlTGlua0V2ZW50czogImNsaWNrLnBvcHVwIiwKCQkJbmF2aWdhdGVFdmVudHM6ICJuYXZpZ2F0ZS5wb3B1cCIsCgkJCWNsb3NlRXZlbnRzOiAibmF2aWdhdGUucG9wdXAgcGFnZWJlZm9yZWNoYW5nZS5wb3B1cCIsCgoJCQkvLyBOT1RFIFdpbmRvd3MgUGhvbmUgNyBoYXMgYSBzY3JvbGwgcG9zaXRpb24gY2FjaGluZyBpc3N1ZSB0aGF0CgkJCS8vICAgICAgcmVxdWlyZXMgdXMgdG8gZGlzYWJsZSBwb3B1cCBoaXN0b3J5IG1hbmFnZW1lbnQgYnkgZGVmYXVsdAoJCQkvLyAgICAgIGh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5LW1vYmlsZS9pc3N1ZXMvNDc4NAoJCQkvLwoJCQkvLyBOT1RFIHRoaXMgb3B0aW9uIGlzIG1vZGlmaWVkIGluIF9jcmVhdGUhCgkJCWhpc3Rvcnk6ICEkLm1vYmlsZS5icm93c2VyLmllCgkJfSwKCgkJX2VhdEV2ZW50QW5kQ2xvc2U6IGZ1bmN0aW9uKCBlICkgewoJCQllLnByZXZlbnREZWZhdWx0KCk7CgkJCWUuc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uKCk7CgkJCXRoaXMuY2xvc2UoKTsKCQkJcmV0dXJuIGZhbHNlOwoJCX0sCgoJCS8vIE1ha2Ugc3VyZSB0aGUgc2NyZWVuIHNpemUgaXMgaW5jcmVhc2VkIGJleW9uZCB0aGUgcGFnZSBoZWlnaHQgaWYgdGhlIHBvcHVwJ3MgY2F1c2VzIHRoZSBkb2N1bWVudCB0byBpbmNyZWFzZSBpbiBoZWlnaHQKCQlfcmVzaXplU2NyZWVuOiBmdW5jdGlvbigpIHsKCQkJdmFyIHBvcHVwSGVpZ2h0ID0gdGhpcy5fdWkuY29udGFpbmVyLm91dGVySGVpZ2h0KCB0cnVlICk7CgoJCQl0aGlzLl91aS5zY3JlZW4ucmVtb3ZlQXR0ciggInN0eWxlIiApOwoJCQlpZiAoIHBvcHVwSGVpZ2h0ID4gdGhpcy5fdWkuc2NyZWVuLmhlaWdodCgpICkgewoJCQkJdGhpcy5fdWkuc2NyZWVuLmhlaWdodCggcG9wdXBIZWlnaHQgKTsKCQkJfQoJCX0sCgoJCV9oYW5kbGVXaW5kb3dLZXlVcDogZnVuY3Rpb24oIGUgKSB7CgkJCWlmICggdGhpcy5faXNPcGVuICYmIGUua2V5Q29kZSA9PT0gJC5tb2JpbGUua2V5Q29kZS5FU0NBUEUgKSB7CgkJCQlyZXR1cm4gdGhpcy5fZWF0RXZlbnRBbmRDbG9zZSggZSApOwoJCQl9CgkJfSwKCgkJX21heWJlUmVmcmVzaFRpbWVvdXQ6IGZ1bmN0aW9uKCkgewoJCQl2YXIgd2luQ29vcmRzID0gd2luZG93Q29vcmRzKCk7CgoJCQlpZiAoIHRoaXMuX3Jlc2l6ZURhdGEgKSB7CgkJCQlpZiAoIHdpbkNvb3Jkcy54ID09PSB0aGlzLl9yZXNpemVEYXRhLndpbkNvb3Jkcy54ICYmCgkJCQkJd2luQ29vcmRzLnkgPT09IHRoaXMuX3Jlc2l6ZURhdGEud2luQ29vcmRzLnkgJiYKCQkJCQl3aW5Db29yZHMuY3ggPT09IHRoaXMuX3Jlc2l6ZURhdGEud2luQ29vcmRzLmN4ICYmCgkJCQkJd2luQ29vcmRzLmN5ID09PSB0aGlzLl9yZXNpemVEYXRhLndpbkNvb3Jkcy5jeSApIHsKCQkJCQkvLyB0aW1lb3V0IG5vdCByZWZyZXNoZWQKCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQl9IGVsc2UgewoJCQkJCS8vIGNsZWFyIGV4aXN0aW5nIHRpbWVvdXQgLSBpdCB3aWxsIGJlIHJlZnJlc2hlZCBiZWxvdwoJCQkJCWNsZWFyVGltZW91dCggdGhpcy5fcmVzaXplRGF0YS50aW1lb3V0SWQgKTsKCQkJCX0KCQkJfQoKCQkJdGhpcy5fcmVzaXplRGF0YSA9IHsKCQkJCXRpbWVvdXRJZDogc2V0VGltZW91dCggJC5wcm94eSggdGhpcywgIl9yZXNpemVUaW1lb3V0IiApLCAyMDAgKSwKCQkJCXdpbkNvb3Jkczogd2luQ29vcmRzCgkJCX07CgoJCQlyZXR1cm4gdHJ1ZTsKCQl9LAoKCQlfcmVzaXplVGltZW91dDogZnVuY3Rpb24oKSB7CgkJCWlmICggIXRoaXMuX21heWJlUmVmcmVzaFRpbWVvdXQoKSApIHsKCQkJCS8vIGVmZmVjdGl2ZWx5IHJhcGlkLW9wZW4gdGhlIHBvcHVwIHdoaWxlIGxlYXZpbmcgdGhlIHNjcmVlbiBpbnRhY3QKCQkJCXRoaXMuX3RyaWdnZXIoICJiZWZvcmVwb3NpdGlvbiIgKTsKCQkJCXRoaXMuX3VpLmNvbnRhaW5lcgoJCQkJCS5yZW1vdmVDbGFzcyggInVpLXNlbGVjdG1lbnUtaGlkZGVuIiApCgkJCQkJLm9mZnNldCggdGhpcy5fcGxhY2VtZW50Q29vcmRzKCB0aGlzLl9kZXNpcmVkQ29vcmRzKCB1bmRlZmluZWQsIHVuZGVmaW5lZCwgIndpbmRvdyIgKSApICk7CgoJCQkJdGhpcy5fcmVzaXplU2NyZWVuKCk7CgkJCQl0aGlzLl9yZXNpemVEYXRhID0gbnVsbDsKCQkJCXRoaXMuX29yaWVudGF0aW9uY2hhbmdlSW5Qcm9ncmVzcyA9IGZhbHNlOwoJCQl9CgkJfSwKCgkJX2hhbmRsZVdpbmRvd1Jlc2l6ZTogZnVuY3Rpb24oIGUgKSB7CgkJCWlmICggdGhpcy5faXNPcGVuICkgewoJCQkJdGhpcy5fbWF5YmVSZWZyZXNoVGltZW91dCgpOwoJCQl9CgkJfSwKCgkJX2hhbmRsZVdpbmRvd09yaWVudGF0aW9uY2hhbmdlOiBmdW5jdGlvbiggZSApIHsKCgkJCWlmICggIXRoaXMuX29yaWVudGF0aW9uY2hhbmdlSW5Qcm9ncmVzcyApIHsKCQkJCS8vIGVmZmVjdGl2ZWx5IHJhcGlkLWNsb3NlIHRoZSBwb3B1cCB3aGlsZSBsZWF2aW5nIHRoZSBzY3JlZW4gaW50YWN0CgkJCQl0aGlzLl91aS5jb250YWluZXIKCQkJCQkuYWRkQ2xhc3MoICJ1aS1zZWxlY3RtZW51LWhpZGRlbiIgKQoJCQkJCS5yZW1vdmVBdHRyKCAic3R5bGUiICk7CgoJCQkJdGhpcy5fb3JpZW50YXRpb25jaGFuZ2VJblByb2dyZXNzID0gdHJ1ZTsKCQkJfQoJCX0sCgoJCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCQl2YXIgdWkgPSB7CgkJCQkJc2NyZWVuOiAkKCAiPGRpdiBjbGFzcz0ndWktc2NyZWVuLWhpZGRlbiB1aS1wb3B1cC1zY3JlZW4nPjwvZGl2PiIgKSwKCQkJCQlwbGFjZWhvbGRlcjogJCggIjxkaXYgc3R5bGU9J2Rpc3BsYXk6IG5vbmU7Jz48IS0tIHBsYWNlaG9sZGVyIC0tPjwvZGl2PiIgKSwKCQkJCQljb250YWluZXI6ICQoICI8ZGl2IGNsYXNzPSd1aS1wb3B1cC1jb250YWluZXIgdWktc2VsZWN0bWVudS1oaWRkZW4nPjwvZGl2PiIgKQoJCQkJfSwKCQkJCXRoaXNQYWdlID0gdGhpcy5lbGVtZW50LmNsb3Nlc3QoICIudWktcGFnZSIgKSwKCQkJCW15SWQgPSB0aGlzLmVsZW1lbnQuYXR0ciggImlkIiApLAoJCQkJc2VsZiA9IHRoaXM7CgoJCQkvLyBXZSBuZWVkIHRvIGFkanVzdCB0aGUgaGlzdG9yeSBvcHRpb24gdG8gYmUgZmFsc2UgaWYgdGhlcmUncyBubyBBSkFYIG5hdi4KCQkJLy8gV2UgY2FuJ3QgZG8gaXQgaW4gdGhlIG9wdGlvbiBkZWNsYXJhdGlvbnMgYmVjYXVzZSB0aG9zZSBhcmUgcnVuIGJlZm9yZQoJCQkvLyBpdCBpcyBkZXRlcm1pbmVkIHdoZXRoZXIgdGhlcmUgc2hhbGwgYmUgQUpBWCBuYXYuCgkJCXRoaXMub3B0aW9ucy5oaXN0b3J5ID0gdGhpcy5vcHRpb25zLmhpc3RvcnkgJiYgJC5tb2JpbGUuYWpheEVuYWJsZWQgJiYgJC5tb2JpbGUuaGFzaExpc3RlbmluZ0VuYWJsZWQ7CgoJCQlpZiAoIHRoaXNQYWdlLmxlbmd0aCA9PT0gMCApIHsKCQkJCXRoaXNQYWdlID0gJCggImJvZHkiICk7CgkJCX0KCgkJCS8vIGRlZmluZSB0aGUgY29udGFpbmVyIGZvciBuYXZpZ2F0aW9uIGV2ZW50IGJpbmRpbmdzCgkJCS8vIFRPRE8gdGhpcyB3b3VsZCBiZSBuaWNlIGF0IHRoZSB0aGUgbW9iaWxlIHdpZGdldCBsZXZlbAoJCQl0aGlzLm9wdGlvbnMuY29udGFpbmVyID0gdGhpcy5vcHRpb25zLmNvbnRhaW5lciB8fCAkLm1vYmlsZS5wYWdlQ29udGFpbmVyOwoKCQkJLy8gQXBwbHkgdGhlIHByb3RvCgkJCXRoaXNQYWdlLmFwcGVuZCggdWkuc2NyZWVuICk7CgkJCXVpLmNvbnRhaW5lci5pbnNlcnRBZnRlciggdWkuc2NyZWVuICk7CgkJCS8vIExlYXZlIGEgcGxhY2Vob2xkZXIgd2hlcmUgdGhlIGVsZW1lbnQgdXNlZCB0byBiZQoJCQl1aS5wbGFjZWhvbGRlci5pbnNlcnRBZnRlciggdGhpcy5lbGVtZW50ICk7CgkJCWlmICggbXlJZCApIHsKCQkJCXVpLnNjcmVlbi5hdHRyKCAiaWQiLCBteUlkICsgIi1zY3JlZW4iICk7CgkJCQl1aS5jb250YWluZXIuYXR0ciggImlkIiwgbXlJZCArICItcG9wdXAiICk7CgkJCQl1aS5wbGFjZWhvbGRlci5odG1sKCAiPCEtLSBwbGFjZWhvbGRlciBmb3IgIiArIG15SWQgKyAiIC0tPiIgKTsKCQkJfQoJCQl1aS5jb250YWluZXIuYXBwZW5kKCB0aGlzLmVsZW1lbnQgKTsKCgkJCS8vIEFkZCBjbGFzcyB0byBwb3B1cCBlbGVtZW50CgkJCXRoaXMuZWxlbWVudC5hZGRDbGFzcyggInVpLXBvcHVwIiApOwoKCQkJLy8gRGVmaW5lIGluc3RhbmNlIHZhcmlhYmxlcwoJCQkkLmV4dGVuZCggdGhpcywgewoJCQkJX3BhZ2U6IHRoaXNQYWdlLAoJCQkJX3VpOiB1aSwKCQkJCV9mYWxsYmFja1RyYW5zaXRpb246ICIiLAoJCQkJX2N1cnJlbnRUcmFuc2l0aW9uOiBmYWxzZSwKCQkJCV9wcmVyZXFzOiBudWxsLAoJCQkJX2lzT3BlbjogZmFsc2UsCgkJCQlfdG9sZXJhbmNlOiBudWxsLAoJCQkJX3Jlc2l6ZURhdGE6IG51bGwsCgkJCQlfb3JpZW50YXRpb25jaGFuZ2VJblByb2dyZXNzOiBmYWxzZSwKCQkJCV9nbG9iYWxIYW5kbGVyczogWwoJCQkJCXsKCQkJCQkJc3JjOiAkKCB3aW5kb3cgKSwKCQkJCQkJaGFuZGxlcjogewoJCQkJCQkJb3JpZW50YXRpb25jaGFuZ2U6ICQucHJveHkoIHRoaXMsICJfaGFuZGxlV2luZG93T3JpZW50YXRpb25jaGFuZ2UiICksCgkJCQkJCQlyZXNpemU6ICQucHJveHkoIHRoaXMsICJfaGFuZGxlV2luZG93UmVzaXplIiApLAoJCQkJCQkJa2V5dXA6ICQucHJveHkoIHRoaXMsICJfaGFuZGxlV2luZG93S2V5VXAiICkKCQkJCQkJfQoJCQkJCX0KCQkJCV0KCQkJfSk7CgoJCQkkLmVhY2goIHRoaXMub3B0aW9ucywgZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CgkJCQkvLyBDYXVzZSBpbml0aWFsIG9wdGlvbnMgdG8gYmUgYXBwbGllZCBieSB0aGVpciBoYW5kbGVyIGJ5IHRlbXBvcmFyaWx5IHNldHRpbmcgdGhlIG9wdGlvbiB0byB1bmRlZmluZWQKCQkJCS8vIC0gdGhlIGhhbmRsZXIgdGhlbiBzZXRzIGl0IHRvIHRoZSBpbml0aWFsIHZhbHVlCgkJCQlzZWxmLm9wdGlvbnNbIGtleSBdID0gdW5kZWZpbmVkOwoJCQkJc2VsZi5fc2V0T3B0aW9uKCBrZXksIHZhbHVlLCB0cnVlICk7CgkJCX0pOwoKCQkJdWkuc2NyZWVuLmJpbmQoICJ2Y2xpY2siLCAkLnByb3h5KCB0aGlzLCAiX2VhdEV2ZW50QW5kQ2xvc2UiICkgKTsKCgkJCSQuZWFjaCggdGhpcy5fZ2xvYmFsSGFuZGxlcnMsIGZ1bmN0aW9uKCBpZHgsIHZhbHVlICkgewoJCQkJdmFsdWUuc3JjLmJpbmQoIHZhbHVlLmhhbmRsZXIgKTsKCQkJfSk7CgkJfSwKCgkJX2FwcGx5VGhlbWU6IGZ1bmN0aW9uKCBkc3QsIHRoZW1lLCBwcmVmaXggKSB7CgkJCXZhciBjbGFzc2VzID0gKCBkc3QuYXR0ciggImNsYXNzIiApIHx8ICIiKS5zcGxpdCggIiAiICksCgkJCQlhbHJlYWR5QWRkZWQgPSB0cnVlLAoJCQkJY3VycmVudFRoZW1lID0gbnVsbCwKCQkJCW1hdGNoZXMsCgkJCQl0aGVtZVN0ciA9IFN0cmluZyggdGhlbWUgKTsKCgkJCXdoaWxlICggY2xhc3Nlcy5sZW5ndGggPiAwICkgewoJCQkJY3VycmVudFRoZW1lID0gY2xhc3Nlcy5wb3AoKTsKCQkJCW1hdGNoZXMgPSAoIG5ldyBSZWdFeHAoICJedWktIiArIHByZWZpeCArICItKFthLXpdKSQiICkgKS5leGVjKCBjdXJyZW50VGhlbWUgKTsKCQkJCWlmICggbWF0Y2hlcyAmJiBtYXRjaGVzLmxlbmd0aCA+IDEgKSB7CgkJCQkJY3VycmVudFRoZW1lID0gbWF0Y2hlc1sgMSBdOwoJCQkJCWJyZWFrOwoJCQkJfSBlbHNlIHsKCQkJCQljdXJyZW50VGhlbWUgPSBudWxsOwoJCQkJfQoJCQl9CgoJCQlpZiAoIHRoZW1lICE9PSBjdXJyZW50VGhlbWUgKSB7CgkJCQlkc3QucmVtb3ZlQ2xhc3MoICJ1aS0iICsgcHJlZml4ICsgIi0iICsgY3VycmVudFRoZW1lICk7CgkJCQlpZiAoICEgKCB0aGVtZSA9PT0gbnVsbCB8fCB0aGVtZSA9PT0gIm5vbmUiICkgKSB7CgkJCQkJZHN0LmFkZENsYXNzKCAidWktIiArIHByZWZpeCArICItIiArIHRoZW1lU3RyICk7CgkJCQl9CgkJCX0KCQl9LAoKCQlfc2V0VGhlbWU6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQkJdGhpcy5fYXBwbHlUaGVtZSggdGhpcy5lbGVtZW50LCB2YWx1ZSwgImJvZHkiICk7CgkJfSwKCgkJX3NldE92ZXJsYXlUaGVtZTogZnVuY3Rpb24oIHZhbHVlICkgewoJCQl0aGlzLl9hcHBseVRoZW1lKCB0aGlzLl91aS5zY3JlZW4sIHZhbHVlLCAib3ZlcmxheSIgKTsKCgkJCWlmICggdGhpcy5faXNPcGVuICkgewoJCQkJdGhpcy5fdWkuc2NyZWVuLmFkZENsYXNzKCAiaW4iICk7CgkJCX0KCQl9LAoKCQlfc2V0U2hhZG93OiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJCXRoaXMuZWxlbWVudC50b2dnbGVDbGFzcyggInVpLW92ZXJsYXktc2hhZG93IiwgdmFsdWUgKTsKCQl9LAoKCQlfc2V0Q29ybmVyczogZnVuY3Rpb24oIHZhbHVlICkgewoJCQl0aGlzLmVsZW1lbnQudG9nZ2xlQ2xhc3MoICJ1aS1jb3JuZXItYWxsIiwgdmFsdWUgKTsKCQl9LAoKCQlfYXBwbHlUcmFuc2l0aW9uOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJCXRoaXMuX3VpLmNvbnRhaW5lci5yZW1vdmVDbGFzcyggdGhpcy5fZmFsbGJhY2tUcmFuc2l0aW9uICk7CgkJCWlmICggdmFsdWUgJiYgdmFsdWUgIT09ICJub25lIiApIHsKCQkJCXRoaXMuX2ZhbGxiYWNrVHJhbnNpdGlvbiA9ICQubW9iaWxlLl9tYXliZURlZ3JhZGVUcmFuc2l0aW9uKCB2YWx1ZSApOwoJCQkJdGhpcy5fdWkuY29udGFpbmVyLmFkZENsYXNzKCB0aGlzLl9mYWxsYmFja1RyYW5zaXRpb24gKTsKCQkJfQoJCX0sCgoJCV9zZXRUcmFuc2l0aW9uOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJCWlmICggIXRoaXMuX2N1cnJlbnRUcmFuc2l0aW9uICkgewoJCQkJdGhpcy5fYXBwbHlUcmFuc2l0aW9uKCB2YWx1ZSApOwoJCQl9CgkJfSwKCgkJX3NldFRvbGVyYW5jZTogZnVuY3Rpb24oIHZhbHVlICkgewoJCQl2YXIgdG9sID0geyB0OiAzMCwgcjogMTUsIGI6IDMwLCBsOiAxNSB9OwoKCQkJaWYgKCB2YWx1ZSApIHsKCQkJCXZhciBhciA9IFN0cmluZyggdmFsdWUgKS5zcGxpdCggIiwiICk7CgoJCQkJJC5lYWNoKCBhciwgZnVuY3Rpb24oIGlkeCwgdmFsICkgeyBhclsgaWR4IF0gPSBwYXJzZUludCggdmFsLCAxMCApOyB9ICk7CgoJCQkJc3dpdGNoKCBhci5sZW5ndGggKSB7CgkJCQkJLy8gQWxsIHZhbHVlcyBhcmUgdG8gYmUgdGhlIHNhbWUKCQkJCQljYXNlIDE6CgkJCQkJCWlmICggIWlzTmFOKCBhclsgMCBdICkgKSB7CgkJCQkJCQl0b2wudCA9IHRvbC5yID0gdG9sLmIgPSB0b2wubCA9IGFyWyAwIF07CgkJCQkJCX0KCQkJCQkJYnJlYWs7CgoJCQkJCS8vIFRoZSBmaXJzdCB2YWx1ZSBkZW5vdGVzIHRvcC9ib3R0b20gdG9sZXJhbmNlLCBhbmQgdGhlIHNlY29uZCB2YWx1ZSBkZW5vdGVzIGxlZnQvcmlnaHQgdG9sZXJhbmNlCgkJCQkJY2FzZSAyOgoJCQkJCQlpZiAoICFpc05hTiggYXJbIDAgXSApICkgewoJCQkJCQkJdG9sLnQgPSB0b2wuYiA9IGFyWyAwIF07CgkJCQkJCX0KCQkJCQkJaWYgKCAhaXNOYU4oIGFyWyAxIF0gKSApIHsKCQkJCQkJCXRvbC5sID0gdG9sLnIgPSBhclsgMSBdOwoJCQkJCQl9CgkJCQkJCWJyZWFrOwoKCQkJCQkvLyBUaGUgYXJyYXkgY29udGFpbnMgdmFsdWVzIGluIHRoZSBvcmRlciB0b3AsIHJpZ2h0LCBib3R0b20sIGxlZnQKCQkJCQljYXNlIDQ6CgkJCQkJCWlmICggIWlzTmFOKCBhclsgMCBdICkgKSB7CgkJCQkJCQl0b2wudCA9IGFyWyAwIF07CgkJCQkJCX0KCQkJCQkJaWYgKCAhaXNOYU4oIGFyWyAxIF0gKSApIHsKCQkJCQkJCXRvbC5yID0gYXJbIDEgXTsKCQkJCQkJfQoJCQkJCQlpZiAoICFpc05hTiggYXJbIDIgXSApICkgewoJCQkJCQkJdG9sLmIgPSBhclsgMiBdOwoJCQkJCQl9CgkJCQkJCWlmICggIWlzTmFOKCBhclsgMyBdICkgKSB7CgkJCQkJCQl0b2wubCA9IGFyWyAzIF07CgkJCQkJCX0KCQkJCQkJYnJlYWs7CgoJCQkJCWRlZmF1bHQ6CgkJCQkJCWJyZWFrOwoJCQkJfQoJCQl9CgoJCQl0aGlzLl90b2xlcmFuY2UgPSB0b2w7CgkJfSwKCgkJX3NldE9wdGlvbjogZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CgkJCXZhciBleGNsdXNpb25zLCBzZXR0ZXIgPSAiX3NldCIgKyBrZXkuY2hhckF0KCAwICkudG9VcHBlckNhc2UoKSArIGtleS5zbGljZSggMSApOwoKCQkJaWYgKCB0aGlzWyBzZXR0ZXIgXSAhPT0gdW5kZWZpbmVkICkgewoJCQkJdGhpc1sgc2V0dGVyIF0oIHZhbHVlICk7CgkJCX0KCgkJCS8vIFRPRE8gUkVNT1ZFIEZPUiAxLjIuMSBieSBtb3ZpbmcgdGhlbSBvdXQgdG8gYSBkZWZhdWx0IG9wdGlvbnMgb2JqZWN0CgkJCWV4Y2x1c2lvbnMgPSBbCgkJCQkiaW5pdFNlbGVjdG9yIiwKCQkJCSJjbG9zZUxpbmtTZWxlY3RvciIsCgkJCQkiY2xvc2VMaW5rRXZlbnRzIiwKCQkJCSJuYXZpZ2F0ZUV2ZW50cyIsCgkJCQkiY2xvc2VFdmVudHMiLAoJCQkJImhpc3RvcnkiLAoJCQkJImNvbnRhaW5lciIKCQkJXTsKCgkJCSQubW9iaWxlLndpZGdldC5wcm90b3R5cGUuX3NldE9wdGlvbi5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgkJCWlmICggJC5pbkFycmF5KCBrZXksIGV4Y2x1c2lvbnMgKSA9PT0gLTEgKSB7CgkJCQkvLyBSZWNvcmQgdGhlIG9wdGlvbiBjaGFuZ2UgaW4gdGhlIG9wdGlvbnMgYW5kIGluIHRoZSBET00gZGF0YS0qIGF0dHJpYnV0ZXMKCQkJCXRoaXMuZWxlbWVudC5hdHRyKCAiZGF0YS0iICsgKCAkLm1vYmlsZS5ucyB8fCAiIiApICsgKCBrZXkucmVwbGFjZSggLyhbQS1aXSkvLCAiLSQxIiApLnRvTG93ZXJDYXNlKCkgKSwgdmFsdWUgKTsKCQkJfQoJCX0sCgoJCS8vIFRyeSBhbmQgY2VudGVyIHRoZSBvdmVybGF5IG92ZXIgdGhlIGdpdmVuIGNvb3JkaW5hdGVzCgkJX3BsYWNlbWVudENvb3JkczogZnVuY3Rpb24oIGRlc2lyZWQgKSB7CgkJCS8vIHJlY3RhbmdsZSB3aXRoaW4gd2hpY2ggdGhlIHBvcHVwIG11c3QgZml0CgkJCXZhcgoJCQkJd2luQ29vcmRzID0gd2luZG93Q29vcmRzKCksCgkJCQlyYyA9IHsKCQkJCQl4OiB0aGlzLl90b2xlcmFuY2UubCwKCQkJCQl5OiB3aW5Db29yZHMueSArIHRoaXMuX3RvbGVyYW5jZS50LAoJCQkJCWN4OiB3aW5Db29yZHMuY3ggLSB0aGlzLl90b2xlcmFuY2UubCAtIHRoaXMuX3RvbGVyYW5jZS5yLAoJCQkJCWN5OiB3aW5Db29yZHMuY3kgLSB0aGlzLl90b2xlcmFuY2UudCAtIHRoaXMuX3RvbGVyYW5jZS5iCgkJCQl9LAoJCQkJbWVudVNpemUsIHJldDsKCgkJCS8vIENsYW1wIHRoZSB3aWR0aCBvZiB0aGUgbWVudSBiZWZvcmUgZ3JhYmJpbmcgaXRzIHNpemUKCQkJdGhpcy5fdWkuY29udGFpbmVyLmNzcyggIm1heC13aWR0aCIsIHJjLmN4ICk7CgkJCW1lbnVTaXplID0gewoJCQkJY3g6IHRoaXMuX3VpLmNvbnRhaW5lci5vdXRlcldpZHRoKCB0cnVlICksCgkJCQljeTogdGhpcy5fdWkuY29udGFpbmVyLm91dGVySGVpZ2h0KCB0cnVlICkKCQkJfTsKCgkJCS8vIENlbnRlciB0aGUgbWVudSBvdmVyIHRoZSBkZXNpcmVkIGNvb3JkaW5hdGVzLCB3aGlsZSBub3QgZ29pbmcgb3V0c2lkZQoJCQkvLyB0aGUgd2luZG93IHRvbGVyYW5jZXMuIFRoaXMgd2lsbCBjZW50ZXIgd3J0LiB0aGUgd2luZG93IGlmIHRoZSBwb3B1cCBpcyB0b28gbGFyZ2UuCgkJCXJldCA9IHsKCQkJCXg6IGZpdFNlZ21lbnRJbnNpZGVTZWdtZW50KCByYy5jeCwgbWVudVNpemUuY3gsIHJjLngsIGRlc2lyZWQueCApLAoJCQkJeTogZml0U2VnbWVudEluc2lkZVNlZ21lbnQoIHJjLmN5LCBtZW51U2l6ZS5jeSwgcmMueSwgZGVzaXJlZC55ICkKCQkJfTsKCgkJCS8vIE1ha2Ugc3VyZSB0aGUgdG9wIG9mIHRoZSBtZW51IGlzIHZpc2libGUKCQkJcmV0LnkgPSBNYXRoLm1heCggMCwgcmV0LnkgKTsKCgkJCS8vIElmIHRoZSBoZWlnaHQgb2YgdGhlIG1lbnUgaXMgc21hbGxlciB0aGFuIHRoZSBoZWlnaHQgb2YgdGhlIGRvY3VtZW50CgkJCS8vIGFsaWduIHRoZSBib3R0b20gd2l0aCB0aGUgYm90dG9tIG9mIHRoZSBkb2N1bWVudAoKCQkJLy8gZml4IGZvciAkKCBkb2N1bWVudCApLmhlaWdodCgpIGJ1ZyBpbiBjb3JlIDEuNy4yLgoJCQl2YXIgZG9jRWwgPSBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQsIGRvY0JvZHkgPSBkb2N1bWVudC5ib2R5LAoJCQkJZG9jSGVpZ2h0ID0gTWF0aC5tYXgoIGRvY0VsLmNsaWVudEhlaWdodCwgZG9jQm9keS5zY3JvbGxIZWlnaHQsIGRvY0JvZHkub2Zmc2V0SGVpZ2h0LCBkb2NFbC5zY3JvbGxIZWlnaHQsIGRvY0VsLm9mZnNldEhlaWdodCApOwoKCQkJcmV0LnkgLT0gTWF0aC5taW4oIHJldC55LCBNYXRoLm1heCggMCwgcmV0LnkgKyBtZW51U2l6ZS5jeSAtIGRvY0hlaWdodCApICk7CgoJCQlyZXR1cm4geyBsZWZ0OiByZXQueCwgdG9wOiByZXQueSB9OwoJCX0sCgoJCV9jcmVhdGVQcmVyZXFzOiBmdW5jdGlvbiggc2NyZWVuUHJlcmVxLCBjb250YWluZXJQcmVyZXEsIHdoZW5Eb25lICkgewoJCQl2YXIgc2VsZiA9IHRoaXMsIHByZXJlcXM7CgoJCQkvLyBJdCBpcyBpbXBvcnRhbnQgdG8gbWFpbnRhaW4gYm90aCB0aGUgbG9jYWwgdmFyaWFibGUgcHJlcmVxcyBhbmQgc2VsZi5fcHJlcmVxcy4gVGhlIGxvY2FsIHZhcmlhYmxlIHJlbWFpbnMgaW4KCQkJLy8gdGhlIGNsb3N1cmUgb2YgdGhlIGZ1bmN0aW9ucyB3aGljaCBjYWxsIHRoZSBjYWxsYmFja3MgcGFzc2VkIGluLiBUaGUgY29tcGFyaXNvbiBiZXR3ZWVuIHRoZSBsb2NhbCB2YXJpYWJsZSBhbmQKCQkJLy8gc2VsZi5fcHJlcmVxcyBpcyBuZWNlc3NhcnksIGJlY2F1c2Ugb25jZSBhIGZ1bmN0aW9uIGhhcyBiZWVuIHBhc3NlZCB0byAuYW5pbWF0aW9uQ29tcGxldGUoKSBpdCB3aWxsIGJlIGNhbGxlZAoJCQkvLyBuZXh0IHRpbWUgYW4gYW5pbWF0aW9uIGNvbXBsZXRlcywgZXZlbiBpZiB0aGF0J3Mgbm90IHRoZSBhbmltYXRpb24gd2hvc2UgZW5kIHRoZSBmdW5jdGlvbiB3YXMgc3VwcG9zZWQgdG8gY2F0Y2gKCQkJLy8gKGZvciBleGFtcGxlLCBpZiBhbiBhYm9ydCBoYXBwZW5zIGR1cmluZyB0aGUgb3BlbmluZyBhbmltYXRpb24sIHRoZSAuYW5pbWF0aW9uQ29tcGxldGUgaGFuZGxlciBpcyBub3QgY2FsbGVkIGZvcgoJCQkvLyB0aGF0IGFuaW1hdGlvbiBhbnltb3JlLCBidXQgdGhlIGhhbmRsZXIgcmVtYWlucyBhdHRhY2hlZCwgc28gaXQgaXMgY2FsbGVkIHRoZSBuZXh0IHRpbWUgdGhlIHBvcHVwIGlzIG9wZW5lZAoJCQkvLyAtIG1ha2luZyBpdCBzdGFsZS4gQ29tcGFyaW5nIHRoZSBsb2NhbCB2YXJpYWJsZSBwcmVyZXFzIHRvIHRoZSB3aWRnZXQtbGV2ZWwgdmFyaWFibGUgc2VsZi5fcHJlcmVxcyBlbnN1cmVzIHRoYXQKCQkJLy8gY2FsbGJhY2tzIHRyaWdnZXJlZCBieSBhIHN0YWxlIC5hbmltYXRpb25Db21wbGV0ZSB3aWxsIGJlIGlnbm9yZWQuCgoJCQlwcmVyZXFzID0gewoJCQkJc2NyZWVuOiAkLkRlZmVycmVkKCksCgkJCQljb250YWluZXI6ICQuRGVmZXJyZWQoKQoJCQl9OwoKCQkJcHJlcmVxcy5zY3JlZW4udGhlbiggZnVuY3Rpb24oKSB7CgkJCQlpZiAoIHByZXJlcXMgPT09IHNlbGYuX3ByZXJlcXMgKSB7CgkJCQkJc2NyZWVuUHJlcmVxKCk7CgkJCQl9CgkJCX0pOwoKCQkJcHJlcmVxcy5jb250YWluZXIudGhlbiggZnVuY3Rpb24oKSB7CgkJCQlpZiAoIHByZXJlcXMgPT09IHNlbGYuX3ByZXJlcXMgKSB7CgkJCQkJY29udGFpbmVyUHJlcmVxKCk7CgkJCQl9CgkJCX0pOwoKCQkJJC53aGVuKCBwcmVyZXFzLnNjcmVlbiwgcHJlcmVxcy5jb250YWluZXIgKS5kb25lKCBmdW5jdGlvbigpIHsKCQkJCWlmICggcHJlcmVxcyA9PT0gc2VsZi5fcHJlcmVxcyApIHsKCQkJCQlzZWxmLl9wcmVyZXFzID0gbnVsbDsKCQkJCQl3aGVuRG9uZSgpOwoJCQkJfQoJCQl9KTsKCgkJCXNlbGYuX3ByZXJlcXMgPSBwcmVyZXFzOwoJCX0sCgoJCV9hbmltYXRlOiBmdW5jdGlvbiggYXJncyApIHsKCQkJLy8gTk9URSBiZWZvcmUgcmVtb3ZpbmcgdGhlIGRlZmF1bHQgYW5pbWF0aW9uIG9mIHRoZSBzY3JlZW4KCQkJLy8gICAgICB0aGlzIGhhZCBhbiBhbmltYXRlIGNhbGxiYWNrIHRoYXQgd291bGQgcmVsb3ZlIHRoZSBkZWZlcnJlZAoJCQkvLyAgICAgIG5vdyB0aGUgZGVmZXJyZWQgaXMgcmVzb2x2ZWQgaW1tZWRpYXRlbHkKCQkJLy8gVE9ETyByZW1vdmUgdGhlIGRlcGVuZGVuY3kgb24gdGhlIHNjcmVlbiBkZWZlcnJlZAoJCQl0aGlzLl91aS5zY3JlZW4KCQkJCS5yZW1vdmVDbGFzcyggYXJncy5jbGFzc1RvUmVtb3ZlICkKCQkJCS5hZGRDbGFzcyggYXJncy5zY3JlZW5DbGFzc1RvQWRkICk7CgoJCQlhcmdzLnByZXJlcXMuc2NyZWVuLnJlc29sdmUoKTsKCgkJCWlmICggYXJncy50cmFuc2l0aW9uICYmIGFyZ3MudHJhbnNpdGlvbiAhPT0gIm5vbmUiICkgewoJCQkJaWYgKCBhcmdzLmFwcGx5VHJhbnNpdGlvbiApIHsKCQkJCQl0aGlzLl9hcHBseVRyYW5zaXRpb24oIGFyZ3MudHJhbnNpdGlvbiApOwoJCQkJfQoJCQkJdGhpcy5fdWkuY29udGFpbmVyCgkJCQkJLmFuaW1hdGlvbkNvbXBsZXRlKCAkLnByb3h5KCBhcmdzLnByZXJlcXMuY29udGFpbmVyLCAicmVzb2x2ZSIgKSApCgkJCQkJLmFkZENsYXNzKCBhcmdzLmNvbnRhaW5lckNsYXNzVG9BZGQgKQoJCQkJCS5yZW1vdmVDbGFzcyggYXJncy5jbGFzc1RvUmVtb3ZlICk7CgkJCX0gZWxzZSB7CgkJCQlhcmdzLnByZXJlcXMuY29udGFpbmVyLnJlc29sdmUoKTsKCQkJfQoJCX0sCgoJCS8vIFRoZSBkZXNpcmVkIGNvb3JkaW5hdGVzIHBhc3NlZCBpbiB3aWxsIGJlIHJldHVybmVkIHVudG91Y2hlZCBpZiBubyByZWZlcmVuY2UgZWxlbWVudCBjYW4gYmUgaWRlbnRpZmllZCB2aWEKCQkvLyBkZXNpcmVkUG9zaXRpb24ucG9zaXRpb25Uby4gTmV2ZXJ0aGVsZXNzLCB0aGlzIGZ1bmN0aW9uIGVuc3VyZXMgdGhhdCBpdHMgcmV0dXJuIHZhbHVlIGFsd2F5cyBjb250YWlucyB2YWxpZAoJCS8vIHggYW5kIHkgY29vcmRpbmF0ZXMgYnkgc3BlY2lmeWluZyB0aGUgY2VudGVyIG1pZGRsZSBvZiB0aGUgd2luZG93IGlmIHRoZSBjb29yZGluYXRlcyBhcmUgYWJzZW50LgoJCV9kZXNpcmVkQ29vcmRzOiBmdW5jdGlvbiggeCwgeSwgcG9zaXRpb25UbyApIHsKCQkJdmFyIGRzdCA9IG51bGwsIG9mZnNldCwgd2luQ29vcmRzID0gd2luZG93Q29vcmRzKCk7CgoJCQkvLyBFc3RhYmxpc2ggd2hpY2ggZWxlbWVudCB3aWxsIHNlcnZlIGFzIHRoZSByZWZlcmVuY2UKCQkJaWYgKCBwb3NpdGlvblRvICYmIHBvc2l0aW9uVG8gIT09ICJvcmlnaW4iICkgewoJCQkJaWYgKCBwb3NpdGlvblRvID09PSAid2luZG93IiApIHsKCQkJCQl4ID0gd2luQ29vcmRzLmN4IC8gMiArIHdpbkNvb3Jkcy54OwoJCQkJCXkgPSB3aW5Db29yZHMuY3kgLyAyICsgd2luQ29vcmRzLnk7CgkJCQl9IGVsc2UgewoJCQkJCXRyeSB7CgkJCQkJCWRzdCA9ICQoIHBvc2l0aW9uVG8gKTsKCQkJCQl9IGNhdGNoKCBlICkgewoJCQkJCQlkc3QgPSBudWxsOwoJCQkJCX0KCQkJCQlpZiAoIGRzdCApIHsKCQkJCQkJZHN0LmZpbHRlciggIjp2aXNpYmxlIiApOwoJCQkJCQlpZiAoIGRzdC5sZW5ndGggPT09IDAgKSB7CgkJCQkJCQlkc3QgPSBudWxsOwoJCQkJCQl9CgkJCQkJfQoJCQkJfQoJCQl9CgoJCQkvLyBJZiBhbiBlbGVtZW50IHdhcyBmb3VuZCwgY2VudGVyIG92ZXIgaXQKCQkJaWYgKCBkc3QgKSB7CgkJCQlvZmZzZXQgPSBkc3Qub2Zmc2V0KCk7CgkJCQl4ID0gb2Zmc2V0LmxlZnQgKyBkc3Qub3V0ZXJXaWR0aCgpIC8gMjsKCQkJCXkgPSBvZmZzZXQudG9wICsgZHN0Lm91dGVySGVpZ2h0KCkgLyAyOwoJCQl9CgoJCQkvLyBNYWtlIHN1cmUgeCBhbmQgeSBhcmUgdmFsaWQgbnVtYmVycyAtIGNlbnRlciBvdmVyIHRoZSB3aW5kb3cKCQkJaWYgKCAkLnR5cGUoIHggKSAhPT0gIm51bWJlciIgfHwgaXNOYU4oIHggKSApIHsKCQkJCXggPSB3aW5Db29yZHMuY3ggLyAyICsgd2luQ29vcmRzLng7CgkJCX0KCQkJaWYgKCAkLnR5cGUoIHkgKSAhPT0gIm51bWJlciIgfHwgaXNOYU4oIHkgKSApIHsKCQkJCXkgPSB3aW5Db29yZHMuY3kgLyAyICsgd2luQ29vcmRzLnk7CgkJCX0KCgkJCXJldHVybiB7IHg6IHgsIHk6IHkgfTsKCQl9LAoKCQlfb3BlblByZXJlcXNDb21wbGV0ZTogZnVuY3Rpb24oKSB7CgkJCXZhciBzZWxmID0gdGhpczsKCgkJCXNlbGYuX3VpLmNvbnRhaW5lci5hZGRDbGFzcyggInVpLXBvcHVwLWFjdGl2ZSIgKTsKCQkJc2VsZi5faXNPcGVuID0gdHJ1ZTsKCQkJc2VsZi5fcmVzaXplU2NyZWVuKCk7CgoJCQkvLyBBbmRyb2lkIGFwcGVhcnMgdG8gdHJpZ2dlciB0aGUgYW5pbWF0aW9uIGNvbXBsZXRlIGJlZm9yZSB0aGUgcG9wdXAKCQkJLy8gaXMgdmlzaWJsZS4gQWxsb3dpbmcgdGhlIHN0YWNrIHRvIHVud2luZCBiZWZvcmUgYXBwbHlpbmcgZm9jdXMgcHJldmVudHMKCQkJLy8gdGhlICJibHVlIGZsYXNoIiBvZiBlbGVtZW50IGZvY3VzIGluIGFuZHJvaWQgNC4wCgkJCXNldFRpbWVvdXQoZnVuY3Rpb24oKXsKCQkJCXNlbGYuX3VpLmNvbnRhaW5lci5hdHRyKCAidGFiaW5kZXgiLCAiMCIgKS5mb2N1cygpOwoJCQkJc2VsZi5fdHJpZ2dlciggImFmdGVyb3BlbiIgKTsKCQkJfSk7CgkJfSwKCgkJX29wZW46IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCQl2YXIgY29vcmRzLCB0cmFuc2l0aW9uLAoJCQkJYW5kcm9pZEJsYWNrbGlzdCA9ICggZnVuY3Rpb24oKSB7CgkJCQkJdmFyIHcgPSB3aW5kb3csCgkJCQkJCXVhID0gbmF2aWdhdG9yLnVzZXJBZ2VudCwKCQkJCQkJLy8gUmVuZGVyaW5nIGVuZ2luZSBpcyBXZWJraXQsIGFuZCBjYXB0dXJlIG1ham9yIHZlcnNpb24KCQkJCQkJd2ttYXRjaCA9IHVhLm1hdGNoKCAvQXBwbGVXZWJLaXRcLyhbMC05XC5dKykvICksCgkJCQkJCXdrdmVyc2lvbiA9ICEhd2ttYXRjaCAmJiB3a21hdGNoWyAxIF0sCgkJCQkJCWFuZHJvaWRtYXRjaCA9IHVhLm1hdGNoKCAvQW5kcm9pZCAoXGQrKD86XC5cZCspKS8gKSwKCQkJCQkJYW5kdmVyc2lvbiA9ICEhYW5kcm9pZG1hdGNoICYmIGFuZHJvaWRtYXRjaFsgMSBdLAoJCQkJCQljaHJvbWVtYXRjaCA9IHVhLmluZGV4T2YoICJDaHJvbWUiICkgPiAtMTsKCgkJCQkJLy8gUGxhdGZvcm0gaXMgQW5kcm9pZCwgV2ViS2l0IHZlcnNpb24gaXMgZ3JlYXRlciB0aGFuIDUzNC4xMyAoIEFuZHJvaWQgMy4yLjEgKSBhbmQgbm90IENocm9tZS4KCQkJCQlpZiggYW5kcm9pZG1hdGNoICE9PSBudWxsICYmIGFuZHZlcnNpb24gPT09ICI0LjAiICYmIHdrdmVyc2lvbiAmJiB3a3ZlcnNpb24gPiA1MzQuMTMgJiYgIWNocm9tZW1hdGNoICkgewoJCQkJCQlyZXR1cm4gdHJ1ZTsKCQkJCQl9CgkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJfSgpKTsKCgkJCS8vIE1ha2Ugc3VyZSBvcHRpb25zIGlzIGRlZmluZWQKCQkJb3B0aW9ucyA9ICggb3B0aW9ucyB8fCB7fSApOwoKCQkJLy8gQ29weSBvdXQgdGhlIHRyYW5zaXRpb24sIGJlY2F1c2Ugd2UgbWF5IGJlIG92ZXJ3cml0aW5nIGl0IGxhdGVyIGFuZCB3ZSBkb24ndCB3YW50IHRvIHBhc3MgdGhhdCBjaGFuZ2UgYmFjayB0byB0aGUgY2FsbGVyCgkJCXRyYW5zaXRpb24gPSBvcHRpb25zLnRyYW5zaXRpb24gfHwgdGhpcy5vcHRpb25zLnRyYW5zaXRpb247CgoJCQkvLyBHaXZlIGFwcGxpY2F0aW9ucyBhIGNoYW5jZSB0byBtb2RpZnkgdGhlIGNvbnRlbnRzIG9mIHRoZSBjb250YWluZXIgYmVmb3JlIGl0IGFwcGVhcnMKCQkJdGhpcy5fdHJpZ2dlciggImJlZm9yZXBvc2l0aW9uIiApOwoKCQkJY29vcmRzID0gdGhpcy5fcGxhY2VtZW50Q29vcmRzKCB0aGlzLl9kZXNpcmVkQ29vcmRzKCBvcHRpb25zLngsIG9wdGlvbnMueSwgb3B0aW9ucy5wb3NpdGlvblRvIHx8IHRoaXMub3B0aW9ucy5wb3NpdGlvblRvIHx8ICJvcmlnaW4iICkgKTsKCgkJCS8vIENvdW50IGRvd24gdG8gdHJpZ2dlcmluZyAicG9wdXBhZnRlcm9wZW4iIC0gd2UgaGF2ZSB0d28gcHJlcmVxdWlzaXRlczoKCQkJLy8gMS4gVGhlIHBvcHVwIHdpbmRvdyBhbmltYXRpb24gY29tcGxldGVzIChjb250YWluZXIoKSkKCQkJLy8gMi4gVGhlIHNjcmVlbiBvcGFjaXR5IGFuaW1hdGlvbiBjb21wbGV0ZXMgKHNjcmVlbigpKQoJCQl0aGlzLl9jcmVhdGVQcmVyZXFzKAoJCQkJJC5ub29wLAoJCQkJJC5ub29wLAoJCQkJJC5wcm94eSggdGhpcywgIl9vcGVuUHJlcmVxc0NvbXBsZXRlIiApICk7CgoJCQlpZiAoIHRyYW5zaXRpb24gKSB7CgkJCQl0aGlzLl9jdXJyZW50VHJhbnNpdGlvbiA9IHRyYW5zaXRpb247CgkJCQl0aGlzLl9hcHBseVRyYW5zaXRpb24oIHRyYW5zaXRpb24gKTsKCQkJfSBlbHNlIHsKCQkJCXRyYW5zaXRpb24gPSB0aGlzLm9wdGlvbnMudHJhbnNpdGlvbjsKCQkJfQoKCQkJaWYgKCAhdGhpcy5vcHRpb25zLnRoZW1lICkgewoJCQkJdGhpcy5fc2V0VGhlbWUoIHRoaXMuX3BhZ2UuanFtRGF0YSggInRoZW1lIiApIHx8ICQubW9iaWxlLmdldEluaGVyaXRlZFRoZW1lKCB0aGlzLl9wYWdlLCAiYyIgKSApOwoJCQl9CgoJCQl0aGlzLl91aS5zY3JlZW4ucmVtb3ZlQ2xhc3MoICJ1aS1zY3JlZW4taGlkZGVuIiApOwoKCQkJdGhpcy5fdWkuY29udGFpbmVyCgkJCQkucmVtb3ZlQ2xhc3MoICJ1aS1zZWxlY3RtZW51LWhpZGRlbiIgKQoJCQkJLm9mZnNldCggY29vcmRzICk7CgoJCQlpZiAoIHRoaXMub3B0aW9ucy5vdmVybGF5VGhlbWUgJiYgYW5kcm9pZEJsYWNrbGlzdCApIHsKCQkJCS8qIFRPRE86CgkJCQlUaGUgbmF0aXZlIGJyb3dzZXIgb24gQW5kcm9pZCA0LjAuWCAoIkljZSBDcmVhbSBTYW5kd2ljaCIpIHN1ZmZlcnMgZnJvbSBhbiBpc3N1ZSB3aGVyZSB0aGUgcG9wdXAgb3ZlcmxheSBhcHBlYXJzIHRvIGJlIHotaW5kZXhlZAoJCQkJYWJvdmUgdGhlIHBvcHVwIGl0c2VsZiB3aGVuIGNlcnRhaW4gb3RoZXIgc3R5bGVzIGV4aXN0IG9uIHRoZSBzYW1lIHBhZ2UgLS0gbmFtZWx5LCBhbnkgZWxlbWVudCBzZXQgdG8gYHBvc2l0aW9uOiBmaXhlZGAgYW5kIGNlcnRhaW4KCQkJCXR5cGVzIG9mIGlucHV0LiBUaGVzZSBpc3N1ZXMgYXJlIHJlbWluaXNjZW50IG9mIHByZXZpb3VzbHkgdW5jb3ZlcmVkIGJ1Z3MgaW4gb2xkZXIgdmVyc2lvbnMgb2YgQW5kcm9pZCdzIG5hdGl2ZSBicm93c2VyOgoJCQkJaHR0cHM6Ly9naXRodWIuY29tL3Njb3R0amVobC9EZXZpY2UtQnVncy9pc3N1ZXMvMwoKCQkJCVRoaXMgZml4IGNsb3NlcyB0aGUgZm9sbG93aW5nIGJ1Z3MgKCBJIHVzZSAiY2xvc2VzIiB3aXRoIHJlbHVjdGFuY2UsIGFuZCBzdHJlc3MgdGhhdCB0aGlzIGlzc3VlIHNob3VsZCBiZSByZXZpc2l0ZWQgYXMgc29vbiBhcyBwb3NzaWJsZSApOgoKCQkJCWh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5LW1vYmlsZS9pc3N1ZXMvNDgxNgoJCQkJaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnktbW9iaWxlL2lzc3Vlcy80ODQ0CgkJCQlodHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L2pxdWVyeS1tb2JpbGUvaXNzdWVzLzQ4NzQKCQkJCSovCgoJCQkJLy8gVE9ETyBzb3J0IG91dCB3aHkgdGhpcy5fcGFnZSBpc24ndCB3b3JraW5nCgkJCQl0aGlzLmVsZW1lbnQuY2xvc2VzdCggIi51aS1wYWdlIiApLmFkZENsYXNzKCAidWktcG9wdXAtb3BlbiIgKTsKCQkJfQoJCQl0aGlzLl9hbmltYXRlKHsKCQkJCWFkZGl0aW9uYWxDb25kaXRpb246IHRydWUsCgkJCQl0cmFuc2l0aW9uOiB0cmFuc2l0aW9uLAoJCQkJY2xhc3NUb1JlbW92ZTogIiIsCgkJCQlzY3JlZW5DbGFzc1RvQWRkOiAiaW4iLAoJCQkJY29udGFpbmVyQ2xhc3NUb0FkZDogImluIiwKCQkJCWFwcGx5VHJhbnNpdGlvbjogZmFsc2UsCgkJCQlwcmVyZXFzOiB0aGlzLl9wcmVyZXFzCgkJCX0pOwoJCX0sCgoJCV9jbG9zZVByZXJlcVNjcmVlbjogZnVuY3Rpb24oKSB7CgkJCXRoaXMuX3VpLnNjcmVlbgoJCQkJLnJlbW92ZUNsYXNzKCAib3V0IiApCgkJCQkuYWRkQ2xhc3MoICJ1aS1zY3JlZW4taGlkZGVuIiApOwoJCX0sCgoJCV9jbG9zZVByZXJlcUNvbnRhaW5lcjogZnVuY3Rpb24oKSB7CgkJCXRoaXMuX3VpLmNvbnRhaW5lcgoJCQkJLnJlbW92ZUNsYXNzKCAicmV2ZXJzZSBvdXQiICkKCQkJCS5hZGRDbGFzcyggInVpLXNlbGVjdG1lbnUtaGlkZGVuIiApCgkJCQkucmVtb3ZlQXR0ciggInN0eWxlIiApOwoJCX0sCgoJCV9jbG9zZVByZXJlcXNEb25lOiBmdW5jdGlvbigpIHsKCQkJdmFyIHNlbGYgPSB0aGlzLCBvcHRzID0gc2VsZi5vcHRpb25zOwoKCQkJc2VsZi5fdWkuY29udGFpbmVyLnJlbW92ZUF0dHIoICJ0YWJpbmRleCIgKTsKCgkJCS8vIHJlbW92ZSBuYXYgYmluZGluZ3MgaWYgdGhleSBhcmUgc3RpbGwgcHJlc2VudAoJCQlvcHRzLmNvbnRhaW5lci51bmJpbmQoIG9wdHMuY2xvc2VFdmVudHMgKTsKCgkJCS8vIHVuYmluZCBjbGljayBoYW5kbGVycyBhZGRlZCB3aGVuIGhpc3RvcnkgaXMgZGlzYWJsZWQKCQkJc2VsZi5lbGVtZW50LnVuZGVsZWdhdGUoIG9wdHMuY2xvc2VMaW5rU2VsZWN0b3IsIG9wdHMuY2xvc2VMaW5rRXZlbnRzICk7CgoJCQkvLyByZW1vdmUgdGhlIGdsb2JhbCBtdXRleCBmb3IgcG9wdXBzCgkJCSQubW9iaWxlLnBvcHVwLmFjdGl2ZSA9IHVuZGVmaW5lZDsKCgkJCS8vIGFsZXJ0IHVzZXJzIHRoYXQgdGhlIHBvcHVwIGlzIGNsb3NlZAoJCQlzZWxmLl90cmlnZ2VyKCAiYWZ0ZXJjbG9zZSIgKTsKCQl9LAoKCQlfY2xvc2U6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLl91aS5jb250YWluZXIucmVtb3ZlQ2xhc3MoICJ1aS1wb3B1cC1hY3RpdmUiICk7CgkJCXRoaXMuX3BhZ2UucmVtb3ZlQ2xhc3MoICJ1aS1wb3B1cC1vcGVuIiApOwoKCQkJdGhpcy5faXNPcGVuID0gZmFsc2U7CgoJCQkvLyBDb3VudCBkb3duIHRvIHRyaWdnZXJpbmcgInBvcHVwYWZ0ZXJjbG9zZSIgLSB3ZSBoYXZlIHR3byBwcmVyZXF1aXNpdGVzOgoJCQkvLyAxLiBUaGUgcG9wdXAgd2luZG93IHJldmVyc2UgYW5pbWF0aW9uIGNvbXBsZXRlcyAoY29udGFpbmVyKCkpCgkJCS8vIDIuIFRoZSBzY3JlZW4gb3BhY2l0eSBhbmltYXRpb24gY29tcGxldGVzIChzY3JlZW4oKSkKCQkJdGhpcy5fY3JlYXRlUHJlcmVxcygKCQkJCSQucHJveHkoIHRoaXMsICJfY2xvc2VQcmVyZXFTY3JlZW4iICksCgkJCQkkLnByb3h5KCB0aGlzLCAiX2Nsb3NlUHJlcmVxQ29udGFpbmVyIiApLAoJCQkJJC5wcm94eSggdGhpcywgIl9jbG9zZVByZXJlcXNEb25lIiApICk7CgoJCQl0aGlzLl9hbmltYXRlKCB7CgkJCQlhZGRpdGlvbmFsQ29uZGl0aW9uOiB0aGlzLl91aS5zY3JlZW4uaGFzQ2xhc3MoICJpbiIgKSwKCQkJCXRyYW5zaXRpb246ICggdGhpcy5fY3VycmVudFRyYW5zaXRpb24gfHwgdGhpcy5vcHRpb25zLnRyYW5zaXRpb24gKSwKCQkJCWNsYXNzVG9SZW1vdmU6ICJpbiIsCgkJCQlzY3JlZW5DbGFzc1RvQWRkOiAib3V0IiwKCQkJCWNvbnRhaW5lckNsYXNzVG9BZGQ6ICJyZXZlcnNlIG91dCIsCgkJCQlhcHBseVRyYW5zaXRpb246IHRydWUsCgkJCQlwcmVyZXFzOiB0aGlzLl9wcmVyZXFzCgkJCX0pOwoJCX0sCgoJCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCQkJdmFyIHNlbGYgPSB0aGlzOwoKCQkJLy8gaGlkZSBhbmQgcmVtb3ZlIGJpbmRpbmdzCgkJCXNlbGYuX2Nsb3NlKCk7CgoJCQkvLyBQdXQgdGhlIGVsZW1lbnQgYmFjayB0byB3aGVyZSB0aGUgcGxhY2Vob2xkZXIgd2FzIGFuZCByZW1vdmUgdGhlICJ1aS1wb3B1cCIgY2xhc3MKCQkJc2VsZi5fc2V0VGhlbWUoICJub25lIiApOwoJCQlzZWxmLmVsZW1lbnQKCQkJCS5pbnNlcnRBZnRlciggc2VsZi5fdWkucGxhY2Vob2xkZXIgKQoJCQkJLnJlbW92ZUNsYXNzKCAidWktcG9wdXAgdWktb3ZlcmxheS1zaGFkb3cgdWktY29ybmVyLWFsbCIgKTsKCQkJc2VsZi5fdWkuc2NyZWVuLnJlbW92ZSgpOwoJCQlzZWxmLl91aS5jb250YWluZXIucmVtb3ZlKCk7CgkJCXNlbGYuX3VpLnBsYWNlaG9sZGVyLnJlbW92ZSgpOwoKCQkJLy8gVW5iaW5kIGhhbmRsZXJzIHRoYXQgd2VyZSBib3VuZCB0byBlbGVtZW50cyBvdXRzaWRlIHNlbGYuZWxlbWVudCAodGhlIHdpbmRvdywgaW4gc2VsZiBjYXNlKQoJCQkkLmVhY2goIHNlbGYuX2dsb2JhbEhhbmRsZXJzLCBmdW5jdGlvbiggaWR4LCBvbmVTcmMgKSB7CgkJCQkkLmVhY2goIG9uZVNyYy5oYW5kbGVyLCBmdW5jdGlvbiggZXZlbnRUeXBlLCBoYW5kbGVyICkgewoJCQkJCW9uZVNyYy5zcmMudW5iaW5kKCBldmVudFR5cGUsIGhhbmRsZXIgKTsKCQkJCX0pOwoJCQl9KTsKCQl9LAoKCQkvLyBhbnkgbmF2aWdhdGlvbiBldmVudCBhZnRlciBhIHBvcHVwIGlzIG9wZW5lZCBzaG91bGQgY2xvc2UgdGhlIHBvcHVwCgkJLy8gTk9URSB0aGUgcGFnZWJlZm9yZWNoYW5nZSBpcyBib3VuZCB0byBjYXRjaCBuYXZpZ2F0aW9uIGV2ZW50cyB0aGF0IGRvbid0CgkJLy8gICAgICBhbHRlciB0aGUgdXJsIChlZywgZGlhbG9ncyBmcm9tIHBvcHVwcykKCQlfYmluZENvbnRhaW5lckNsb3NlOiBmdW5jdGlvbigpIHsKCQkJdmFyIHNlbGYgPSB0aGlzOwoKCQkJc2VsZi5vcHRpb25zLmNvbnRhaW5lcgoJCQkJLm9uZSggc2VsZi5vcHRpb25zLmNsb3NlRXZlbnRzLCAkLnByb3h5KCBzZWxmLl9jbG9zZSwgc2VsZiApKTsKCQl9LAoKCQkvLyBUT0RPIG5vIGNsZWFyIGRlbGluaWF0aW9uIG9mIHdoYXQgc2hvdWxkIGJlIGhlcmUgYW5kCgkJLy8gd2hhdCBzaG91bGQgYmUgaW4gX29wZW4uIFNlZW1zIHRvIGJlICJ2aXN1YWwiIHZzICJoaXN0b3J5IiBmb3Igbm93CgkJb3BlbjogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJCXZhciBzZWxmID0gdGhpcywgb3B0cyA9IHRoaXMub3B0aW9ucywgdXJsLCBoYXNoa2V5LCBhY3RpdmVQYWdlLCBjdXJyZW50SXNEaWFsb2csIGhhc0hhc2gsIHVybEhpc3Rvcnk7CgoJCQkvLyBtYWtlIHN1cmUgb3BlbiBpcyBpZGVtcG90ZW50CgkJCWlmKCAkLm1vYmlsZS5wb3B1cC5hY3RpdmUgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIHNldCB0aGUgZ2xvYmFsIHBvcHVwIG11dGV4CgkJCSQubW9iaWxlLnBvcHVwLmFjdGl2ZSA9IHRoaXM7CgoJCQkvLyBpZiBoaXN0b3J5IGFsdGVyYXRpb24gaXMgZGlzYWJsZWQgY2xvc2Ugb24gbmF2aWdhdGUgZXZlbnRzCgkJCS8vIGFuZCBsZWF2ZSB0aGUgdXJsIGFzIGlzCgkJCWlmKCAhKCBvcHRzLmhpc3RvcnkgKSApIHsKCQkJCXNlbGYuX29wZW4oIG9wdGlvbnMgKTsKCQkJCXNlbGYuX2JpbmRDb250YWluZXJDbG9zZSgpOwoKCQkJCS8vIFdoZW4gaGlzdG95IGlzIGRpc2FibGVkIHdlIGhhdmUgdG8gZ3JhYiB0aGUgZGF0YS1yZWwKCQkJCS8vIGJhY2sgbGluayBjbGlja3Mgc28gd2UgY2FuIGNsb3NlIHRoZSBwb3B1cCBpbnN0ZWFkIG9mCgkJCQkvLyByZWx5aW5nIG9uIGhpc3RvcnkgdG8gZG8gaXQgZm9yIHVzCgkJCQlzZWxmLmVsZW1lbnQKCQkJCQkuZGVsZWdhdGUoIG9wdHMuY2xvc2VMaW5rU2VsZWN0b3IsIG9wdHMuY2xvc2VMaW5rRXZlbnRzLCBmdW5jdGlvbiggZSApIHsKCQkJCQkJc2VsZi5fY2xvc2UoKTsKCgkJCQkJCS8vIE5PVEUgcHJldmVudCB0aGUgYnJvd3NlciBhbmQgbmF2aWdhdGlvbiBoYW5kbGVycyBmcm9tCgkJCQkJCS8vIHdvcmtpbmcgd2l0aCB0aGUgbGluaydzIHJlbD1iYWNrLiBUaGlzIG1heSBjYXVzZQoJCQkJCQkvLyBpc3N1ZXMgZm9yIGRldmVsb3BlcnMgZXhwZWN0aW5nIHRoZSBldmVudCB0byBidWJibGUKCQkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJCX0pOwoKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gY2FjaGUgc29tZSB2YWx1ZXMgZm9yIG1pbi9yZWFkYWJpbGl0eQoJCQloYXNoa2V5ID0gJC5tb2JpbGUuZGlhbG9nSGFzaEtleTsKCQkJYWN0aXZlUGFnZSA9ICQubW9iaWxlLmFjdGl2ZVBhZ2U7CgkJCWN1cnJlbnRJc0RpYWxvZyA9IGFjdGl2ZVBhZ2UuaXMoICIudWktZGlhbG9nIiApOwoJCQl1cmwgPSAkLm1vYmlsZS51cmxIaXN0b3J5LmdldEFjdGl2ZSgpLnVybDsKCQkJaGFzSGFzaCA9ICggdXJsLmluZGV4T2YoIGhhc2hrZXkgKSA+IC0xICkgJiYgIWN1cnJlbnRJc0RpYWxvZzsKCQkJdXJsSGlzdG9yeSA9ICQubW9iaWxlLnVybEhpc3Rvcnk7CgoJCQlpZiAoIGhhc0hhc2ggKSB7CgkJCQlzZWxmLl9vcGVuKCBvcHRpb25zICk7CgkJCQlzZWxmLl9iaW5kQ29udGFpbmVyQ2xvc2UoKTsKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gaWYgdGhlIGN1cnJlbnQgdXJsIGhhcyBubyBkaWFsb2cgaGFzaCBrZXkgcHJvY2VlZCBhcyBub3JtYWwKCQkJLy8gb3RoZXJ3aXNlLCBpZiB0aGUgcGFnZSBpcyBhIGRpYWxvZyBzaW1wbHkgdGFjayBvbiB0aGUgaGFzaCBrZXkKCQkJaWYgKCB1cmwuaW5kZXhPZiggaGFzaGtleSApID09PSAtMSAmJiAhY3VycmVudElzRGlhbG9nICl7CgkJCQl1cmwgPSB1cmwgKyBoYXNoa2V5OwoJCQl9IGVsc2UgewoJCQkJdXJsID0gJC5tb2JpbGUucGF0aC5wYXJzZUxvY2F0aW9uKCkuaGFzaCArIGhhc2hrZXk7CgkJCX0KCgkJCS8vIFRhY2sgb24gYW4gZXh0cmEgaGFzaGtleSBpZiB0aGlzIGlzIHRoZSBmaXJzdCBwYWdlIGFuZCB3ZSd2ZSBqdXN0IHJlY29uc3RydWN0ZWQgdGhlIGluaXRpYWwgaGFzaAoJCQlpZiAoIHVybEhpc3RvcnkuYWN0aXZlSW5kZXggPT09IDAgJiYgdXJsID09PSB1cmxIaXN0b3J5LmluaXRpYWxEc3QgKSB7CgkJCQl1cmwgKz0gaGFzaGtleTsKCQkJfQoKCQkJLy8gc3dhbGxvdyB0aGUgdGhlIGluaXRpYWwgbmF2aWdhdGlvbiBldmVudCwgYW5kIGJpbmQgZm9yIHRoZSBuZXh0CgkJCW9wdHMuY29udGFpbmVyLm9uZSggb3B0cy5uYXZpZ2F0ZUV2ZW50cywgZnVuY3Rpb24oIGUgKSB7CgkJCQllLnByZXZlbnREZWZhdWx0KCk7CgkJCQlzZWxmLl9vcGVuKCBvcHRpb25zICk7CgkJCQlzZWxmLl9iaW5kQ29udGFpbmVyQ2xvc2UoKTsKCQkJfSk7CgoJCQl1cmxIaXN0b3J5Lmlnbm9yZU5leHRIYXNoQ2hhbmdlID0gY3VycmVudElzRGlhbG9nOwoKCQkJLy8gR290dGEgbG92ZSBtZXRob2RzIHdpdGggMW1tIGFyZ3MgOigKCQkJdXJsSGlzdG9yeS5hZGROZXcoIHVybCwgdW5kZWZpbmVkLCB1bmRlZmluZWQsIHVuZGVmaW5lZCwgImRpYWxvZyIgKTsKCgkJCS8vIHNldCB0aGUgbmV3IHVybCB3aXRoIChvciB3aXRob3V0KSB0aGUgbmV3IGRpYWxvZyBoYXNoIGtleQoJCQkkLm1vYmlsZS5wYXRoLnNldCggdXJsICk7CgkJfSwKCgkJY2xvc2U6IGZ1bmN0aW9uKCkgewoJCQkvLyBtYWtlIHN1cmUgY2xvc2UgaXMgaWRlbXBvdGVudAoJCQlpZiggISQubW9iaWxlLnBvcHVwLmFjdGl2ZSApewoJCQkJcmV0dXJuOwoJCQl9CgoJCQlpZiggdGhpcy5vcHRpb25zLmhpc3RvcnkgKSB7CgkJCQkkLm1vYmlsZS5iYWNrKCk7CgkJCX0gZWxzZSB7CgkJCQl0aGlzLl9jbG9zZSgpOwoJCQl9CgkJfQoJfSk7CgoKCS8vIFRPRE8gdGhpcyBjYW4gYmUgbW92ZWQgaW5zaWRlIHRoZSB3aWRnZXQKCSQubW9iaWxlLnBvcHVwLmhhbmRsZUxpbmsgPSBmdW5jdGlvbiggJGxpbmsgKSB7CgkJdmFyIGNsb3Nlc3RQYWdlID0gJGxpbmsuY2xvc2VzdCggIjpqcW1EYXRhKHJvbGU9J3BhZ2UnKSIgKSwKCQkJc2NvcGUgPSAoICggY2xvc2VzdFBhZ2UubGVuZ3RoID09PSAwICkgPyAkKCAiYm9keSIgKSA6IGNsb3Nlc3RQYWdlICksCgkJCS8vIE5PVEUgbWFrZSBzdXJlIHRvIGdldCBvbmx5IHRoZSBoYXNoLCBpZTcgKHdwNykgcmV0dXJuIHRoZSBhYnNvbHV0ZSBocmVmCgkJCS8vICAgICAgaW4gdGhpcyBjYXNlIHJ1aW5pbmcgdGhlIGVsZW1lbnQgc2VsZWN0aW9uCgkJCXBvcHVwID0gJCggJC5tb2JpbGUucGF0aC5wYXJzZVVybCgkbGluay5hdHRyKCAiaHJlZiIgKSkuaGFzaCwgc2NvcGVbMF0gKSwKCQkJb2Zmc2V0OwoKCQlpZiAoIHBvcHVwLmRhdGEoICJwb3B1cCIgKSApIHsKCQkJb2Zmc2V0ID0gJGxpbmsub2Zmc2V0KCk7CgkJCXBvcHVwLnBvcHVwKCAib3BlbiIsIHsKCQkJCXg6IG9mZnNldC5sZWZ0ICsgJGxpbmsub3V0ZXJXaWR0aCgpIC8gMiwKCQkJCXk6IG9mZnNldC50b3AgKyAkbGluay5vdXRlckhlaWdodCgpIC8gMiwKCQkJCXRyYW5zaXRpb246ICRsaW5rLmpxbURhdGEoICJ0cmFuc2l0aW9uIiApLAoJCQkJcG9zaXRpb25UbzogJGxpbmsuanFtRGF0YSggInBvc2l0aW9uLXRvIiApLAoJCQkJbGluazogJGxpbmsKCQkJfSk7CgkJfQoKCQkvL3JlbW92ZSBhZnRlciBkZWxheQoJCXNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCQkkbGluay5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQl9LCAzMDAgKTsKCX07CgoJLy8gVE9ETyBtb3ZlIGluc2lkZSBfY3JlYXRlCgkkKCBkb2N1bWVudCApLmJpbmQoICJwYWdlYmVmb3JlY2hhbmdlIiwgZnVuY3Rpb24oIGUsIGRhdGEgKSB7CgkJaWYgKCBkYXRhLm9wdGlvbnMucm9sZSA9PT0gInBvcHVwIiApIHsKCQkJJC5tb2JpbGUucG9wdXAuaGFuZGxlTGluayggZGF0YS5vcHRpb25zLmxpbmsgKTsKCQkJZS5wcmV2ZW50RGVmYXVsdCgpOwoJCX0KCX0pOwoKCSQoIGRvY3VtZW50ICkuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKSAgewoJCSQubW9iaWxlLnBvcHVwLnByb3RvdHlwZS5lbmhhbmNlV2l0aGluKCBlLnRhcmdldCwgdHJ1ZSApOwoJfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQgKSB7Cgl2YXIJbWV0YSA9ICQoICJtZXRhW25hbWU9dmlld3BvcnRdIiApLAoJCWluaXRpYWxDb250ZW50ID0gbWV0YS5hdHRyKCAiY29udGVudCIgKSwKCQlkaXNhYmxlZFpvb20gPSBpbml0aWFsQ29udGVudCArICIsbWF4aW11bS1zY2FsZT0xLCB1c2VyLXNjYWxhYmxlPW5vIiwKCQllbmFibGVkWm9vbSA9IGluaXRpYWxDb250ZW50ICsgIixtYXhpbXVtLXNjYWxlPTEwLCB1c2VyLXNjYWxhYmxlPXllcyIsCgkJZGlzYWJsZWRJbml0aWFsbHkgPSAvKHVzZXItc2NhbGFibGVbXHNdKj1bXHNdKm5vKXwobWF4aW11bS1zY2FsZVtcc10qPVtcc10qMSlbJCxcc10vLnRlc3QoIGluaXRpYWxDb250ZW50ICk7CgoJJC5tb2JpbGUuem9vbSA9ICQuZXh0ZW5kKCB7fSwgewoJCWVuYWJsZWQ6ICFkaXNhYmxlZEluaXRpYWxseSwKCQlsb2NrZWQ6IGZhbHNlLAoJCWRpc2FibGU6IGZ1bmN0aW9uKCBsb2NrICkgewoJCQlpZiAoICFkaXNhYmxlZEluaXRpYWxseSAmJiAhJC5tb2JpbGUuem9vbS5sb2NrZWQgKSB7CgkJCQltZXRhLmF0dHIoICJjb250ZW50IiwgZGlzYWJsZWRab29tICk7CgkJCQkkLm1vYmlsZS56b29tLmVuYWJsZWQgPSBmYWxzZTsKCQkJCSQubW9iaWxlLnpvb20ubG9ja2VkID0gbG9jayB8fCBmYWxzZTsKCQkJfQoJCX0sCgkJZW5hYmxlOiBmdW5jdGlvbiggdW5sb2NrICkgewoJCQlpZiAoICFkaXNhYmxlZEluaXRpYWxseSAmJiAoICEkLm1vYmlsZS56b29tLmxvY2tlZCB8fCB1bmxvY2sgPT09IHRydWUgKSApIHsKCQkJCW1ldGEuYXR0ciggImNvbnRlbnQiLCBlbmFibGVkWm9vbSApOwoJCQkJJC5tb2JpbGUuem9vbS5lbmFibGVkID0gdHJ1ZTsKCQkJCSQubW9iaWxlLnpvb20ubG9ja2VkID0gZmFsc2U7CgkJCX0KCQl9LAoJCXJlc3RvcmU6IGZ1bmN0aW9uKCkgewoJCQlpZiAoICFkaXNhYmxlZEluaXRpYWxseSApIHsKCQkJCW1ldGEuYXR0ciggImNvbnRlbnQiLCBpbml0aWFsQ29udGVudCApOwoJCQkJJC5tb2JpbGUuem9vbS5lbmFibGVkID0gdHJ1ZTsKCQkJfQoJCX0KCX0pOwoKfSggalF1ZXJ5ICkpOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS50ZXh0aW5wdXQiLCAkLm1vYmlsZS53aWRnZXQsIHsKCW9wdGlvbnM6IHsKCQl0aGVtZTogbnVsbCwKCQkvLyBUaGlzIG9wdGlvbiBkZWZhdWx0cyB0byB0cnVlIG9uIGlPUyBkZXZpY2VzLgoJCXByZXZlbnRGb2N1c1pvb206IC9pUGhvbmV8aVBhZHxpUG9kLy50ZXN0KCBuYXZpZ2F0b3IucGxhdGZvcm0gKSAmJiBuYXZpZ2F0b3IudXNlckFnZW50LmluZGV4T2YoICJBcHBsZVdlYktpdCIgKSA+IC0xLAoJCWluaXRTZWxlY3RvcjogImlucHV0W3R5cGU9J3RleHQnXSwgaW5wdXRbdHlwZT0nc2VhcmNoJ10sIDpqcW1EYXRhKHR5cGU9J3NlYXJjaCcpLCBpbnB1dFt0eXBlPSdudW1iZXInXSwgOmpxbURhdGEodHlwZT0nbnVtYmVyJyksIGlucHV0W3R5cGU9J3Bhc3N3b3JkJ10sIGlucHV0W3R5cGU9J2VtYWlsJ10sIGlucHV0W3R5cGU9J3VybCddLCBpbnB1dFt0eXBlPSd0ZWwnXSwgdGV4dGFyZWEsIGlucHV0W3R5cGU9J3RpbWUnXSwgaW5wdXRbdHlwZT0nZGF0ZSddLCBpbnB1dFt0eXBlPSdtb250aCddLCBpbnB1dFt0eXBlPSd3ZWVrJ10sIGlucHV0W3R5cGU9J2RhdGV0aW1lJ10sIGlucHV0W3R5cGU9J2RhdGV0aW1lLWxvY2FsJ10sIGlucHV0W3R5cGU9J2NvbG9yJ10sIGlucHV0Om5vdChbdHlwZV0pIiwKCQljbGVhclNlYXJjaEJ1dHRvblRleHQ6ICJjbGVhciB0ZXh0IiwKCQlkaXNhYmxlZDogZmFsc2UKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgoJCXZhciBzZWxmID0gdGhpcywKCQkJaW5wdXQgPSB0aGlzLmVsZW1lbnQsCgkJCW8gPSB0aGlzLm9wdGlvbnMsCgkJCXRoZW1lID0gby50aGVtZSB8fCAkLm1vYmlsZS5nZXRJbmhlcml0ZWRUaGVtZSggdGhpcy5lbGVtZW50LCAiYyIgKSwKCQkJdGhlbWVjbGFzcyAgPSAiIHVpLWJvZHktIiArIHRoZW1lLAoJCQltaW5pID0gaW5wdXQuanFtRGF0YSggIm1pbmkiICkgPT09IHRydWUsCgkJCW1pbmljbGFzcyA9IG1pbmkgPyAiIHVpLW1pbmkiIDogIiIsCgkJCWZvY3VzZWRFbCwgY2xlYXJidG47CgoJCWZ1bmN0aW9uIHRvZ2dsZUNsZWFyKCkgewoJCQlzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJCWNsZWFyYnRuLnRvZ2dsZUNsYXNzKCAidWktaW5wdXQtY2xlYXItaGlkZGVuIiwgIWlucHV0LnZhbCgpICk7CgkJCX0sIDAgKTsKCQl9CgoJCSQoICJsYWJlbFtmb3I9JyIgKyBpbnB1dC5hdHRyKCAiaWQiICkgKyAiJ10iICkuYWRkQ2xhc3MoICJ1aS1pbnB1dC10ZXh0IiApOwoKCQlmb2N1c2VkRWwgPSBpbnB1dC5hZGRDbGFzcygidWktaW5wdXQtdGV4dCB1aS1ib2R5LSIrIHRoZW1lICk7CgoJCS8vIFhYWDogVGVtcG9yYXJ5IHdvcmthcm91bmQgZm9yIGlzc3VlIDc4NSAoQXBwbGUgYnVnIDg5MTA1ODkpLgoJCS8vICAgICAgVHVybiBvZmYgYXV0b2NvcnJlY3QgYW5kIGF1dG9jb21wbGV0ZSBvbiBub24taU9TIDUgZGV2aWNlcwoJCS8vICAgICAgc2luY2UgdGhlIHBvcHVwIHRoZXkgdXNlIGNhbid0IGJlIGRpc21pc3NlZCBieSB0aGUgdXNlci4gTm90ZQoJCS8vICAgICAgdGhhdCB3ZSB0ZXN0IGZvciB0aGUgcHJlc2VuY2Ugb2YgdGhlIGZlYXR1cmUgYnkgbG9va2luZyBmb3IKCQkvLyAgICAgIHRoZSBhdXRvY29ycmVjdCBwcm9wZXJ0eSBvbiB0aGUgaW5wdXQgZWxlbWVudC4gV2UgY3VycmVudGx5CgkJLy8gICAgICBoYXZlIG5vIHRlc3QgZm9yIGlPUyA1IG9yIG5ld2VyIHNvIHdlJ3JlIHRlbXBvcmFyaWx5IHVzaW5nCgkJLy8gICAgICB0aGUgdG91Y2hPdmVyZmxvdyBzdXBwb3J0IGZsYWcgZm9yIGpRTSAxLjAuIFllcywgSSBmZWVsIGRpcnR5LiAtIGpibGFzCgkJaWYgKCB0eXBlb2YgaW5wdXRbMF0uYXV0b2NvcnJlY3QgIT09ICJ1bmRlZmluZWQiICYmICEkLnN1cHBvcnQudG91Y2hPdmVyZmxvdyApIHsKCQkJLy8gU2V0IHRoZSBhdHRyaWJ1dGUgaW5zdGVhZCBvZiB0aGUgcHJvcGVydHkganVzdCBpbiBjYXNlIHRoZXJlCgkJCS8vIGlzIGNvZGUgdGhhdCBhdHRlbXB0cyB0byBtYWtlIG1vZGlmaWNhdGlvbnMgdmlhIEhUTUwuCgkJCWlucHV0WzBdLnNldEF0dHJpYnV0ZSggImF1dG9jb3JyZWN0IiwgIm9mZiIgKTsKCQkJaW5wdXRbMF0uc2V0QXR0cmlidXRlKCAiYXV0b2NvbXBsZXRlIiwgIm9mZiIgKTsKCQl9CgoKCQkvLyJzZWFyY2giIGlucHV0IHdpZGdldAoJCWlmICggaW5wdXQuaXMoICJbdHlwZT0nc2VhcmNoJ10sOmpxbURhdGEodHlwZT0nc2VhcmNoJykiICkgKSB7CgoJCQlmb2N1c2VkRWwgPSBpbnB1dC53cmFwKCAiPGRpdiBjbGFzcz0ndWktaW5wdXQtc2VhcmNoIHVpLXNoYWRvdy1pbnNldCB1aS1idG4tY29ybmVyLWFsbCB1aS1idG4tc2hhZG93IHVpLWljb24tc2VhcmNoZmllbGQiICsgdGhlbWVjbGFzcyArIG1pbmljbGFzcyArICInPjwvZGl2PiIgKS5wYXJlbnQoKTsKCQkJY2xlYXJidG4gPSAkKCAiPGEgaHJlZj0nIycgY2xhc3M9J3VpLWlucHV0LWNsZWFyJyB0aXRsZT0nIiArIG8uY2xlYXJTZWFyY2hCdXR0b25UZXh0ICsgIic+IiArIG8uY2xlYXJTZWFyY2hCdXR0b25UZXh0ICsgIjwvYT4iICkKCQkJCS5iaW5kKCdjbGljaycsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCQlpbnB1dAoJCQkJCQkudmFsKCAiIiApCgkJCQkJCS5mb2N1cygpCgkJCQkJCS50cmlnZ2VyKCAiY2hhbmdlIiApOwoJCQkJCWNsZWFyYnRuLmFkZENsYXNzKCAidWktaW5wdXQtY2xlYXItaGlkZGVuIiApOwoJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQl9KQoJCQkJLmFwcGVuZFRvKCBmb2N1c2VkRWwgKQoJCQkJLmJ1dHRvbk1hcmt1cCh7CgkJCQkJaWNvbjogImRlbGV0ZSIsCgkJCQkJaWNvbnBvczogIm5vdGV4dCIsCgkJCQkJY29ybmVyczogdHJ1ZSwKCQkJCQlzaGFkb3c6IHRydWUsCgkJCQkJbWluaTogbWluaQoJCQkJfSk7CgoJCQl0b2dnbGVDbGVhcigpOwoKCQkJaW5wdXQuYmluZCggJ3Bhc3RlIGN1dCBrZXl1cCBmb2N1cyBjaGFuZ2UgYmx1cicsIHRvZ2dsZUNsZWFyICk7CgoJCX0gZWxzZSB7CgkJCWlucHV0LmFkZENsYXNzKCAidWktY29ybmVyLWFsbCB1aS1zaGFkb3ctaW5zZXQiICsgdGhlbWVjbGFzcyArIG1pbmljbGFzcyApOwoJCX0KCgkJaW5wdXQuZm9jdXMoZnVuY3Rpb24oKSB7CgkJCQlmb2N1c2VkRWwuYWRkQ2xhc3MoICQubW9iaWxlLmZvY3VzQ2xhc3MgKTsKCQkJfSkKCQkJLmJsdXIoZnVuY3Rpb24oKSB7CgkJCQlmb2N1c2VkRWwucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmZvY3VzQ2xhc3MgKTsKCQkJfSkKCQkJLy8gSW4gbWFueSBzaXR1YXRpb25zLCBpT1Mgd2lsbCB6b29tIGludG8gdGhlIHNlbGVjdCB1cG9uIHRhcCwgdGhpcyBwcmV2ZW50cyB0aGF0IGZyb20gaGFwcGVuaW5nCgkJCS5iaW5kKCAiZm9jdXMiLCBmdW5jdGlvbigpIHsKCQkJCWlmICggby5wcmV2ZW50Rm9jdXNab29tICkgewoJCQkJCSQubW9iaWxlLnpvb20uZGlzYWJsZSggdHJ1ZSApOwoJCQkJfQoJCQl9KQoJCQkuYmluZCggImJsdXIiLCBmdW5jdGlvbigpIHsKCQkJCWlmICggby5wcmV2ZW50Rm9jdXNab29tICkgewoJCQkJCSQubW9iaWxlLnpvb20uZW5hYmxlKCB0cnVlICk7CgkJCQl9CgkJCX0pOwoKCQkvLyBBdXRvZ3JvdwoJCWlmICggaW5wdXQuaXMoICJ0ZXh0YXJlYSIgKSApIHsKCQkJdmFyIGV4dHJhTGluZUhlaWdodCA9IDE1LAoJCQkJa2V5dXBUaW1lb3V0QnVmZmVyID0gMTAwLAoJCQkJa2V5dXBUaW1lb3V0OwoKCQkJdGhpcy5fa2V5dXAgPSBmdW5jdGlvbigpIHsKCQkJCXZhciBzY3JvbGxIZWlnaHQgPSBpbnB1dFsgMCBdLnNjcm9sbEhlaWdodCwKCQkJCQljbGllbnRIZWlnaHQgPSBpbnB1dFsgMCBdLmNsaWVudEhlaWdodDsKCgkJCQlpZiAoIGNsaWVudEhlaWdodCA8IHNjcm9sbEhlaWdodCApIHsKCQkJCQlpbnB1dC5oZWlnaHQoc2Nyb2xsSGVpZ2h0ICsgZXh0cmFMaW5lSGVpZ2h0KTsKCQkJCX0KCQkJfTsKCgkJCWlucHV0LmtleXVwKGZ1bmN0aW9uKCkgewoJCQkJY2xlYXJUaW1lb3V0KCBrZXl1cFRpbWVvdXQgKTsKCQkJCWtleXVwVGltZW91dCA9IHNldFRpbWVvdXQoIHNlbGYuX2tleXVwLCBrZXl1cFRpbWVvdXRCdWZmZXIgKTsKCQkJfSk7CgoJCQkvLyBiaW5kaW5nIHRvIHBhZ2VjaGFuZ2UgaGVyZSBlbnN1cmVzIHRoYXQgZm9yIHBhZ2VzIGxvYWRlZCB2aWEKCQkJLy8gYWpheCB0aGUgaGVpZ2h0IGlzIHJlY2FsY3VsYXRlZCB3aXRob3V0IHVzZXIgaW5wdXQKCQkJdGhpcy5fb24oICQoZG9jdW1lbnQpLCB7InBhZ2VjaGFuZ2UiOiAiX2tleXVwIiB9KTsKCgkJCS8vIElzc3VlIDUwOTogdGhlIGJyb3dzZXIgaXMgbm90IHByb3ZpZGluZyBzY3JvbGxIZWlnaHQgcHJvcGVybHkgdW50aWwgdGhlIHN0eWxlcyBsb2FkCgkJCWlmICggJC50cmltKCBpbnB1dC52YWwoKSApICkgewoJCQkJLy8gYmluZCB0byB0aGUgd2luZG93IGxvYWQgdG8gbWFrZSBzdXJlIHRoZSBoZWlnaHQgaXMgY2FsY3VsYXRlZCBiYXNlZCBvbiBCT1RICgkJCQkvLyB0aGUgRE9NIGFuZCBDU1MKCQkJCXRoaXMuX29uKCAkKHdpbmRvdyksIHsibG9hZCI6ICJfa2V5dXAifSk7CgkJCX0KCQl9CgkJaWYgKCBpbnB1dC5hdHRyKCAiZGlzYWJsZWQiICkgKSB7CgkJCXRoaXMuZGlzYWJsZSgpOwoJCX0KCX0sCgoJZGlzYWJsZTogZnVuY3Rpb24oKSB7CgkJdmFyICRlbDsKCQlpZiAoIHRoaXMuZWxlbWVudC5hdHRyKCAiZGlzYWJsZWQiLCB0cnVlICkuaXMoICJbdHlwZT0nc2VhcmNoJ10sIDpqcW1EYXRhKHR5cGU9J3NlYXJjaCcpIiApICkgewoJCQkkZWwgPSB0aGlzLmVsZW1lbnQucGFyZW50KCk7CgkJfSBlbHNlIHsKCQkJJGVsID0gdGhpcy5lbGVtZW50OwoJCX0KCQkkZWwuYWRkQ2xhc3MoICJ1aS1kaXNhYmxlZCIgKTsKCQlyZXR1cm4gdGhpcy5fc2V0T3B0aW9uKCAiZGlzYWJsZWQiLCB0cnVlICk7Cgl9LAoKCWVuYWJsZTogZnVuY3Rpb24oKSB7CgkJdmFyICRlbDsKCgkJLy8gVE9ETyB1c2luZyBtb3JlIHRoYW4gb25lIGxpbmUgb2YgY29kZSBpcyBhY2NlcHRhYmxlIDspCgkJaWYgKCB0aGlzLmVsZW1lbnQuYXR0ciggImRpc2FibGVkIiwgZmFsc2UgKS5pcyggIlt0eXBlPSdzZWFyY2gnXSwgOmpxbURhdGEodHlwZT0nc2VhcmNoJykiICkgKSB7CgkJCSRlbCA9IHRoaXMuZWxlbWVudC5wYXJlbnQoKTsKCQl9IGVsc2UgewoJCQkkZWwgPSB0aGlzLmVsZW1lbnQ7CgkJfQoJCSRlbC5yZW1vdmVDbGFzcyggInVpLWRpc2FibGVkIiApOwoJCXJldHVybiB0aGlzLl9zZXRPcHRpb24oICJkaXNhYmxlZCIsIGZhbHNlICk7Cgl9Cn0pOwoKLy9hdXRvIHNlbGYtaW5pdCB3aWRnZXRzCiQoIGRvY3VtZW50ICkuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKSB7CgkkLm1vYmlsZS50ZXh0aW5wdXQucHJvdG90eXBlLmVuaGFuY2VXaXRoaW4oIGUudGFyZ2V0LCB0cnVlICk7Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS5saXN0dmlldy5wcm90b3R5cGUub3B0aW9ucy5maWx0ZXIgPSBmYWxzZTsKJC5tb2JpbGUubGlzdHZpZXcucHJvdG90eXBlLm9wdGlvbnMuZmlsdGVyUGxhY2Vob2xkZXIgPSAiRmlsdGVyIGl0ZW1zLi4uIjsKJC5tb2JpbGUubGlzdHZpZXcucHJvdG90eXBlLm9wdGlvbnMuZmlsdGVyVGhlbWUgPSAiYyI7Ci8vIFRPRE8gcmVuYW1lIGNhbGxiYWNrL2RlcHJlY2F0ZSBhbmQgZGVmYXVsdCB0byB0aGUgaXRlbSBpdHNlbGYgYXMgdGhlIGZpcnN0IGFyZ3VtZW50CnZhciBkZWZhdWx0RmlsdGVyQ2FsbGJhY2sgPSBmdW5jdGlvbiggdGV4dCwgc2VhcmNoVmFsdWUsIGl0ZW0gKSB7CgkJcmV0dXJuIHRleHQudG9TdHJpbmcoKS50b0xvd2VyQ2FzZSgpLmluZGV4T2YoIHNlYXJjaFZhbHVlICkgPT09IC0xOwoJfTsKCiQubW9iaWxlLmxpc3R2aWV3LnByb3RvdHlwZS5vcHRpb25zLmZpbHRlckNhbGxiYWNrID0gZGVmYXVsdEZpbHRlckNhbGxiYWNrOwoKJCggZG9jdW1lbnQgKS5kZWxlZ2F0ZSggIjpqcW1EYXRhKHJvbGU9J2xpc3R2aWV3JykiLCAibGlzdHZpZXdjcmVhdGUiLCBmdW5jdGlvbigpIHsKCgl2YXIgbGlzdCA9ICQoIHRoaXMgKSwKCQlsaXN0dmlldyA9IGxpc3QuZGF0YSggImxpc3R2aWV3IiApOwoKCWlmICggIWxpc3R2aWV3Lm9wdGlvbnMuZmlsdGVyICkgewoJCXJldHVybjsKCX0KCgl2YXIgd3JhcHBlciA9ICQoICI8Zm9ybT4iLCB7CgkJCSJjbGFzcyI6ICJ1aS1saXN0dmlldy1maWx0ZXIgdWktYmFyLSIgKyBsaXN0dmlldy5vcHRpb25zLmZpbHRlclRoZW1lLAoJCQkicm9sZSI6ICJzZWFyY2giCgkJfSksCgkJc2VhcmNoID0gJCggIjxpbnB1dD4iLCB7CgkJCXBsYWNlaG9sZGVyOiBsaXN0dmlldy5vcHRpb25zLmZpbHRlclBsYWNlaG9sZGVyCgkJfSkKCQkuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgInR5cGUiLCAic2VhcmNoIiApCgkJLmpxbURhdGEoICJsYXN0dmFsIiwgIiIgKQoJCS5iaW5kKCAia2V5dXAgY2hhbmdlIiwgZnVuY3Rpb24oKSB7CgoJCQl2YXIgJHRoaXMgPSAkKCB0aGlzICksCgkJCQl2YWwgPSB0aGlzLnZhbHVlLnRvTG93ZXJDYXNlKCksCgkJCQlsaXN0SXRlbXMgPSBudWxsLAoJCQkJbGFzdHZhbCA9ICR0aGlzLmpxbURhdGEoICJsYXN0dmFsIiApICsgIiIsCgkJCQljaGlsZEl0ZW1zID0gZmFsc2UsCgkJCQlpdGVtdGV4dCA9ICIiLAoJCQkJaXRlbSwKCQkJCS8vIENoZWNrIGlmIGEgY3VzdG9tIGZpbHRlciBjYWxsYmFjayBhcHBsaWVzCgkJCQlpc0N1c3RvbUZpbHRlckNhbGxiYWNrID0gbGlzdHZpZXcub3B0aW9ucy5maWx0ZXJDYWxsYmFjayAhPT0gZGVmYXVsdEZpbHRlckNhbGxiYWNrOwoKCQkJbGlzdHZpZXcuX3RyaWdnZXIoICJiZWZvcmVmaWx0ZXIiLCAiYmVmb3JlZmlsdGVyIiwgeyBpbnB1dDogdGhpcyB9ICk7CgoJCQkvLyBDaGFuZ2UgdmFsIGFzIGxhc3R2YWwgZm9yIG5leHQgZXhlY3V0aW9uCgkJCSR0aGlzLmpxbURhdGEoICJsYXN0dmFsIiAsIHZhbCApOwoJCQlpZiAoIGlzQ3VzdG9tRmlsdGVyQ2FsbGJhY2sgfHwgdmFsLmxlbmd0aCA8IGxhc3R2YWwubGVuZ3RoIHx8IHZhbC5pbmRleE9mKCBsYXN0dmFsICkgIT09IDAgKSB7CgoJCQkJLy8gQ3VzdG9tIGZpbHRlciBjYWxsYmFjayBhcHBsaWVzIG9yIHJlbW92ZWQgY2hhcnMgb3IgcGFzdGVkIHNvbWV0aGluZyB0b3RhbGx5IGRpZmZlcmVudCwgY2hlY2sgYWxsIGl0ZW1zCgkJCQlsaXN0SXRlbXMgPSBsaXN0LmNoaWxkcmVuKCk7CgkJCX0gZWxzZSB7CgoJCQkJLy8gT25seSBjaGFycyBhZGRlZCwgbm90IHJlbW92ZWQsIG9ubHkgdXNlIHZpc2libGUgc3Vic2V0CgkJCQlsaXN0SXRlbXMgPSBsaXN0LmNoaWxkcmVuKCAiOm5vdCgudWktc2NyZWVuLWhpZGRlbikiICk7CgkJCX0KCgkJCWlmICggdmFsICkgewoKCQkJCS8vIFRoaXMgaGFuZGxlcyBoaWRpbmcgcmVndWxhciByb3dzIHdpdGhvdXQgdGhlIHRleHQgd2Ugc2VhcmNoIGZvcgoJCQkJLy8gYW5kIGFueSBsaXN0IGRpdmlkZXJzIHdpdGhvdXQgcmVndWxhciByb3dzIHNob3duIHVuZGVyIGl0CgoJCQkJZm9yICggdmFyIGkgPSBsaXN0SXRlbXMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0gKSB7CgkJCQkJaXRlbSA9ICQoIGxpc3RJdGVtc1sgaSBdICk7CgkJCQkJaXRlbXRleHQgPSBpdGVtLmpxbURhdGEoICJmaWx0ZXJ0ZXh0IiApIHx8IGl0ZW0udGV4dCgpOwoKCQkJCQlpZiAoIGl0ZW0uaXMoICJsaTpqcW1EYXRhKHJvbGU9bGlzdC1kaXZpZGVyKSIgKSApIHsKCgkJCQkJCWl0ZW0udG9nZ2xlQ2xhc3MoICJ1aS1maWx0ZXItaGlkZXF1ZXVlIiAsICFjaGlsZEl0ZW1zICk7CgoJCQkJCQkvLyBOZXcgYnVja2V0IQoJCQkJCQljaGlsZEl0ZW1zID0gZmFsc2U7CgoJCQkJCX0gZWxzZSBpZiAoIGxpc3R2aWV3Lm9wdGlvbnMuZmlsdGVyQ2FsbGJhY2soIGl0ZW10ZXh0LCB2YWwsIGl0ZW0gKSApIHsKCgkJCQkJCS8vbWFyayB0byBiZSBoaWRkZW4KCQkJCQkJaXRlbS50b2dnbGVDbGFzcyggInVpLWZpbHRlci1oaWRlcXVldWUiICwgdHJ1ZSApOwoJCQkJCX0gZWxzZSB7CgoJCQkJCQkvLyBUaGVyZSdzIGEgc2hvd24gaXRlbSBpbiB0aGUgYnVja2V0CgkJCQkJCWNoaWxkSXRlbXMgPSB0cnVlOwoJCQkJCX0KCQkJCX0KCgkJCQkvLyBTaG93IGl0ZW1zLCBub3QgbWFya2VkIHRvIGJlIGhpZGRlbgoJCQkJbGlzdEl0ZW1zCgkJCQkJLmZpbHRlciggIjpub3QoLnVpLWZpbHRlci1oaWRlcXVldWUpIiApCgkJCQkJLnRvZ2dsZUNsYXNzKCAidWktc2NyZWVuLWhpZGRlbiIsIGZhbHNlICk7CgoJCQkJLy8gSGlkZSBpdGVtcywgbWFya2VkIHRvIGJlIGhpZGRlbgoJCQkJbGlzdEl0ZW1zCgkJCQkJLmZpbHRlciggIi51aS1maWx0ZXItaGlkZXF1ZXVlIiApCgkJCQkJLnRvZ2dsZUNsYXNzKCAidWktc2NyZWVuLWhpZGRlbiIsIHRydWUgKQoJCQkJCS50b2dnbGVDbGFzcyggInVpLWZpbHRlci1oaWRlcXVldWUiLCBmYWxzZSApOwoKCQkJfSBlbHNlIHsKCgkJCQkvL2ZpbHRlcnZhbHVlIGlzIGVtcHR5ID0+IHNob3cgYWxsCgkJCQlsaXN0SXRlbXMudG9nZ2xlQ2xhc3MoICJ1aS1zY3JlZW4taGlkZGVuIiwgZmFsc2UgKTsKCQkJfQoJCQlsaXN0dmlldy5fcmVmcmVzaENvcm5lcnMoKTsKCQl9KQoJCS5hcHBlbmRUbyggd3JhcHBlciApCgkJLnRleHRpbnB1dCgpOwoKCWlmICggbGlzdHZpZXcub3B0aW9ucy5pbnNldCApIHsKCQl3cmFwcGVyLmFkZENsYXNzKCAidWktbGlzdHZpZXctZmlsdGVyLWluc2V0IiApOwoJfQoKCXdyYXBwZXIuYmluZCggInN1Ym1pdCIsIGZ1bmN0aW9uKCkgewoJCXJldHVybiBmYWxzZTsKCX0pCgkuaW5zZXJ0QmVmb3JlKCBsaXN0ICk7Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS5zbGlkZXIiLCAkLm1vYmlsZS53aWRnZXQsIHsKCXdpZGdldEV2ZW50UHJlZml4OiAic2xpZGUiLAoKCW9wdGlvbnM6IHsKCQl0aGVtZTogbnVsbCwKCQl0cmFja1RoZW1lOiBudWxsLAoJCWRpc2FibGVkOiBmYWxzZSwKCQlpbml0U2VsZWN0b3I6ICJpbnB1dFt0eXBlPSdyYW5nZSddLCA6anFtRGF0YSh0eXBlPSdyYW5nZScpLCA6anFtRGF0YShyb2xlPSdzbGlkZXInKSIsCgkJbWluaTogZmFsc2UKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgoJCS8vIFRPRE86IEVhY2ggb2YgdGhlc2Ugc2hvdWxkIGhhdmUgY29tbWVudHMgZXhwbGFpbiB3aGF0IHRoZXkncmUgZm9yCgkJdmFyIHNlbGYgPSB0aGlzLAoKCQkJY29udHJvbCA9IHRoaXMuZWxlbWVudCwKCgkJCXBhcmVudFRoZW1lID0gJC5tb2JpbGUuZ2V0SW5oZXJpdGVkVGhlbWUoIGNvbnRyb2wsICJjIiApLAoKCQkJdGhlbWUgPSB0aGlzLm9wdGlvbnMudGhlbWUgfHwgcGFyZW50VGhlbWUsCgoJCQl0cmFja1RoZW1lID0gdGhpcy5vcHRpb25zLnRyYWNrVGhlbWUgfHwgcGFyZW50VGhlbWUsCgoJCQljVHlwZSA9IGNvbnRyb2xbIDAgXS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpLAoKCQkJc2VsZWN0Q2xhc3MgPSAoIGNUeXBlID09PSAic2VsZWN0IiApID8gInVpLXNsaWRlci1zd2l0Y2giIDogIiIsCgoJCQljb250cm9sSUQgPSBjb250cm9sLmF0dHIoICJpZCIgKSwKCgkJCSRsYWJlbCA9ICQoICJbZm9yPSciICsgY29udHJvbElEICsgIiddIiApLAoKCQkJbGFiZWxJRCA9ICRsYWJlbC5hdHRyKCAiaWQiICkgfHwgY29udHJvbElEICsgIi1sYWJlbCIsCgoJCQlsYWJlbCA9ICRsYWJlbC5hdHRyKCAiaWQiLCBsYWJlbElEICksCgoJCQl2YWwgPSBmdW5jdGlvbigpIHsKCQkJCXJldHVybiAgY1R5cGUgPT09ICJpbnB1dCIgID8gcGFyc2VGbG9hdCggY29udHJvbC52YWwoKSApIDogY29udHJvbFswXS5zZWxlY3RlZEluZGV4OwoJCQl9LAoKCQkJbWluID0gIGNUeXBlID09PSAiaW5wdXQiID8gcGFyc2VGbG9hdCggY29udHJvbC5hdHRyKCAibWluIiApICkgOiAwLAoKCQkJbWF4ID0gIGNUeXBlID09PSAiaW5wdXQiID8gcGFyc2VGbG9hdCggY29udHJvbC5hdHRyKCAibWF4IiApICkgOiBjb250cm9sLmZpbmQoICJvcHRpb24iICkubGVuZ3RoLTEsCgoJCQlzdGVwID0gd2luZG93LnBhcnNlRmxvYXQoIGNvbnRyb2wuYXR0ciggInN0ZXAiICkgfHwgMSApLAoKCQkJaW5saW5lQ2xhc3MgPSAoIHRoaXMub3B0aW9ucy5pbmxpbmUgfHwgY29udHJvbC5qcW1EYXRhKCAiaW5saW5lIiApID09PSB0cnVlICkgPyAiIHVpLXNsaWRlci1pbmxpbmUiIDogIiIsCgoJCQltaW5pQ2xhc3MgPSAoIHRoaXMub3B0aW9ucy5taW5pIHx8IGNvbnRyb2wuanFtRGF0YSggIm1pbmkiICkgKSA/ICIgdWktc2xpZGVyLW1pbmkiIDogIiIsCgoKCQkJZG9tSGFuZGxlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggJ2EnICksCgkJCWhhbmRsZSA9ICQoIGRvbUhhbmRsZSApLAoJCQlkb21TbGlkZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAnZGl2JyApLAoJCQlzbGlkZXIgPSAkKCBkb21TbGlkZXIgKSwKCgkJCXZhbHVlYmcgPSBjb250cm9sLmpxbURhdGEoICJoaWdobGlnaHQiICkgJiYgY1R5cGUgIT09ICJzZWxlY3QiID8gKGZ1bmN0aW9uKCkgewoJCQkJdmFyIGJnID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CgkJCQliZy5jbGFzc05hbWUgPSAndWktc2xpZGVyLWJnICcgKyAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyArICcgdWktYnRuLWNvcm5lci1hbGwnOwoJCQkJcmV0dXJuICQoIGJnICkucHJlcGVuZFRvKCBzbGlkZXIgKTsKCQkJfSkoKSA6IGZhbHNlLAoKCQkJb3B0aW9uczsKCgkJdGhpcy5fdHlwZSA9IGNUeXBlOwoKCQlkb21IYW5kbGUuc2V0QXR0cmlidXRlKCAnaHJlZicsICIjIiApOwoJCWRvbVNsaWRlci5zZXRBdHRyaWJ1dGUoJ3JvbGUnLCdhcHBsaWNhdGlvbicpOwoJCWRvbVNsaWRlci5jbGFzc05hbWUgPSBbJ3VpLXNsaWRlciAnLHNlbGVjdENsYXNzLCIgdWktYnRuLWRvd24tIix0cmFja1RoZW1lLCcgdWktYnRuLWNvcm5lci1hbGwnLCBpbmxpbmVDbGFzcywgbWluaUNsYXNzXS5qb2luKCAiIiApOwoJCWRvbUhhbmRsZS5jbGFzc05hbWUgPSAndWktc2xpZGVyLWhhbmRsZSc7CgkJZG9tU2xpZGVyLmFwcGVuZENoaWxkKCBkb21IYW5kbGUgKTsKCgkJaGFuZGxlLmJ1dHRvbk1hcmt1cCh7IGNvcm5lcnM6IHRydWUsIHRoZW1lOiB0aGVtZSwgc2hhZG93OiB0cnVlIH0pCgkJCQkuYXR0cih7CgkJCQkJInJvbGUiOiAic2xpZGVyIiwKCQkJCQkiYXJpYS12YWx1ZW1pbiI6IG1pbiwKCQkJCQkiYXJpYS12YWx1ZW1heCI6IG1heCwKCQkJCQkiYXJpYS12YWx1ZW5vdyI6IHZhbCgpLAoJCQkJCSJhcmlhLXZhbHVldGV4dCI6IHZhbCgpLAoJCQkJCSJ0aXRsZSI6IHZhbCgpLAoJCQkJCSJhcmlhLWxhYmVsbGVkYnkiOiBsYWJlbElECgkJCQl9KTsKCgkJJC5leHRlbmQoIHRoaXMsIHsKCQkJc2xpZGVyOiBzbGlkZXIsCgkJCWhhbmRsZTogaGFuZGxlLAoJCQl2YWx1ZWJnOiB2YWx1ZWJnLAoJCQlkcmFnZ2luZzogZmFsc2UsCgkJCWJlZm9yZVN0YXJ0OiBudWxsLAoJCQl1c2VyTW9kaWZpZWQ6IGZhbHNlLAoJCQltb3VzZU1vdmVkOiBmYWxzZQoJCX0pOwoKCQlpZiAoIGNUeXBlID09PSAic2VsZWN0IiApIHsKCQkJdmFyIHdyYXBwZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKCQkJd3JhcHBlci5jbGFzc05hbWUgPSAndWktc2xpZGVyLWlubmVyb2Zmc2V0JzsKCgkJCWZvciAoIHZhciBqID0gMCxsZW5ndGggPSBkb21TbGlkZXIuY2hpbGROb2Rlcy5sZW5ndGg7aiA8IGxlbmd0aDtqKysgKSB7CgkJCQl3cmFwcGVyLmFwcGVuZENoaWxkKCBkb21TbGlkZXIuY2hpbGROb2Rlc1tqXSApOwoJCQl9CgoJCQlkb21TbGlkZXIuYXBwZW5kQ2hpbGQoIHdyYXBwZXIgKTsKCgkJCS8vIHNsaWRlci53cmFwSW5uZXIoICI8ZGl2IGNsYXNzPSd1aS1zbGlkZXItaW5uZXJvZmZzZXQnPjwvZGl2PiIgKTsKCgkJCS8vIG1ha2UgdGhlIGhhbmRsZSBtb3ZlIHdpdGggYSBzbW9vdGggdHJhbnNpdGlvbgoJCQloYW5kbGUuYWRkQ2xhc3MoICJ1aS1zbGlkZXItaGFuZGxlLXNuYXBwaW5nIiApOwoKCQkJb3B0aW9ucyA9IGNvbnRyb2wuZmluZCggIm9wdGlvbiIgKTsKCgkJCWZvciAoIHZhciBpID0gMCwgb3B0aW9uc0NvdW50ID0gb3B0aW9ucy5sZW5ndGg7IGkgPCBvcHRpb25zQ291bnQ7IGkrKyApIHsKCQkJCXZhciBzaWRlID0gIWkgPyAiYiIgOiAiYSIsCgkJCQkJc2xpZGVyVGhlbWUgPSAhaSA/ICIgdWktYnRuLWRvd24tIiArIHRyYWNrVGhlbWUgOiAoICIgIiArICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICksCgkJCQkJc2xpZGVyTGFiZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAnZGl2JyApLAoJCQkJCXNsaWRlckltZyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICdzcGFuJyApOwoKCQkJCXNsaWRlckltZy5jbGFzc05hbWUgPSBbJ3VpLXNsaWRlci1sYWJlbCB1aS1zbGlkZXItbGFiZWwtJyxzaWRlLHNsaWRlclRoZW1lLCIgdWktYnRuLWNvcm5lci1hbGwiXS5qb2luKCAiIiApOwoJCQkJc2xpZGVySW1nLnNldEF0dHJpYnV0ZSgncm9sZScsJ2ltZycpOwoJCQkJc2xpZGVySW1nLmFwcGVuZENoaWxkKCBkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSggb3B0aW9uc1tpXS5pbm5lckhUTUwgKSApOwoJCQkJJChzbGlkZXJJbWcpLnByZXBlbmRUbyggc2xpZGVyICk7CgkJCX0KCgkJCXNlbGYuX2xhYmVscyA9ICQoICIudWktc2xpZGVyLWxhYmVsIiwgc2xpZGVyICk7CgoJCX0KCgkJbGFiZWwuYWRkQ2xhc3MoICJ1aS1zbGlkZXIiICk7CgoJCS8vIG1vbml0b3IgdGhlIGlucHV0IGZvciB1cGRhdGVkIHZhbHVlcwoJCWNvbnRyb2wuYWRkQ2xhc3MoIGNUeXBlID09PSAiaW5wdXQiID8gInVpLXNsaWRlci1pbnB1dCIgOiAidWktc2xpZGVyLXN3aXRjaCIgKQoJCQkuY2hhbmdlKGZ1bmN0aW9uKCkgewoJCQkJLy8gaWYgdGhlIHVzZXIgZHJhZ2dlZCB0aGUgaGFuZGxlLCB0aGUgImNoYW5nZSIgZXZlbnQgd2FzIHRyaWdnZXJlZCBmcm9tIGluc2lkZSByZWZyZXNoKCk7IGRvbid0IGNhbGwgcmVmcmVzaCgpIGFnYWluCgkJCQlpZiAoICFzZWxmLm1vdXNlTW92ZWQgKSB7CgkJCQkJc2VsZi5yZWZyZXNoKCB2YWwoKSwgdHJ1ZSApOwoJCQkJfQoJCQl9KQoJCQkua2V5dXAoZnVuY3Rpb24oKSB7IC8vIG5lY2Vzc2FyeT8KCQkJCXNlbGYucmVmcmVzaCggdmFsKCksIHRydWUsIHRydWUgKTsKCQkJfSkKCQkJLmJsdXIoZnVuY3Rpb24oKSB7CgkJCQlzZWxmLnJlZnJlc2goIHZhbCgpLCB0cnVlICk7CgkJCX0pOwoKCQl0aGlzLl9wcmV2ZW50RG9jdW1lbnREcmFnID0gZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkvLyBOT1RFOiB3ZSBkb24ndCBkbyB0aGlzIGluIHJlZnJlc2ggYmVjYXVzZSB3ZSBzdGlsbCB3YW50IHRvCgkJCS8vICAgICAgIHN1cHBvcnQgcHJvZ3JhbW1hdGljIGFsdGVyYXRpb24gb2YgZGlzYWJsZWQgaW5wdXRzCgkJCWlmICggc2VsZi5kcmFnZ2luZyAmJiAhc2VsZi5vcHRpb25zLmRpc2FibGVkICkgewoKCQkJCS8vIHNlbGYubW91c2VNb3ZlZCBtdXN0IGJlIHVwZGF0ZWQgYmVmb3JlIHJlZnJlc2goKSBiZWNhdXNlIGl0IHdpbGwgYmUgdXNlZCBpbiB0aGUgY29udHJvbCAiY2hhbmdlIiBldmVudAoJCQkJc2VsZi5tb3VzZU1vdmVkID0gdHJ1ZTsKCgkJCQlpZiAoIGNUeXBlID09PSAic2VsZWN0IiApIHsKCQkJCQkvLyBtYWtlIHRoZSBoYW5kbGUgbW92ZSBpbiBzeW5jIHdpdGggdGhlIG1vdXNlCgkJCQkJaGFuZGxlLnJlbW92ZUNsYXNzKCAidWktc2xpZGVyLWhhbmRsZS1zbmFwcGluZyIgKTsKCQkJCX0KCgkJCQlzZWxmLnJlZnJlc2goIGV2ZW50ICk7CgoJCQkJLy8gb25seSBhZnRlciByZWZyZXNoKCkgeW91IGNhbiBjYWxjdWxhdGUgc2VsZi51c2VyTW9kaWZpZWQKCQkJCXNlbGYudXNlck1vZGlmaWVkID0gc2VsZi5iZWZvcmVTdGFydCAhPT0gY29udHJvbFswXS5zZWxlY3RlZEluZGV4OwoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgkJfQoKCQl0aGlzLl9vbiggJCggZG9jdW1lbnQgKSwgeyAidm1vdXNlbW92ZSI6IHRoaXMuX3ByZXZlbnREb2N1bWVudERyYWcgfSk7CgoJCS8vIGl0IGFwcGVhcnMgdGhlIGNsaWNraW5nIHRoZSB1cCBhbmQgZG93biBidXR0b25zIGluIGNocm9tZSBvbgoJCS8vIHJhbmdlL251bWJlciBpbnB1dHMgZG9lc24ndCB0cmlnZ2VyIGEgY2hhbmdlIHVudGlsIHRoZSBmaWVsZCBpcwoJCS8vIGJsdXJyZWQuIEhlcmUgd2UgY2hlY2sgdGhpZiB0aGUgdmFsdWUgaGFzIGNoYW5nZWQgYW5kIHJlZnJlc2gKCQljb250cm9sLmJpbmQoICJ2bW91c2V1cCIsICQucHJveHkoIHNlbGYuX2NoZWNrZWRSZWZyZXNoLCBzZWxmKSk7CgoJCXNsaWRlci5iaW5kKCAidm1vdXNlZG93biIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJLy8gTk9URTogd2UgZG9uJ3QgZG8gdGhpcyBpbiByZWZyZXNoIGJlY2F1c2Ugd2Ugc3RpbGwgd2FudCB0bwoJCQkvLyAgICAgICBzdXBwb3J0IHByb2dyYW1tYXRpYyBhbHRlcmF0aW9uIG9mIGRpc2FibGVkIGlucHV0cwoJCQlpZiAoIHNlbGYub3B0aW9ucy5kaXNhYmxlZCApIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoKCQkJc2VsZi5kcmFnZ2luZyA9IHRydWU7CgkJCXNlbGYudXNlck1vZGlmaWVkID0gZmFsc2U7CgkJCXNlbGYubW91c2VNb3ZlZCA9IGZhbHNlOwoKCQkJaWYgKCBjVHlwZSA9PT0gInNlbGVjdCIgKSB7CgkJCQlzZWxmLmJlZm9yZVN0YXJ0ID0gY29udHJvbFswXS5zZWxlY3RlZEluZGV4OwoJCQl9CgoJCQlzZWxmLnJlZnJlc2goIGV2ZW50ICk7CgkJCXNlbGYuX3RyaWdnZXIoICJzdGFydCIgKTsKCQkJcmV0dXJuIGZhbHNlOwoJCX0pCgkJLmJpbmQoICJ2Y2xpY2siLCBmYWxzZSApOwoKCQl0aGlzLl9zbGlkZXJNb3VzZVVwID0gZnVuY3Rpb24oKSB7CgkJCWlmICggc2VsZi5kcmFnZ2luZyApIHsKCQkJCXNlbGYuZHJhZ2dpbmcgPSBmYWxzZTsKCgkJCQlpZiAoIGNUeXBlID09PSAic2VsZWN0IikgewoJCQkJCS8vIG1ha2UgdGhlIGhhbmRsZSBtb3ZlIHdpdGggYSBzbW9vdGggdHJhbnNpdGlvbgoJCQkJCWhhbmRsZS5hZGRDbGFzcyggInVpLXNsaWRlci1oYW5kbGUtc25hcHBpbmciICk7CgoJCQkJCWlmICggc2VsZi5tb3VzZU1vdmVkICkgewoJCQkJCQkvLyB0aGlzIGlzIGEgZHJhZywgY2hhbmdlIHRoZSB2YWx1ZSBvbmx5IGlmIHVzZXIgZHJhZ2dlZCBlbm91Z2gKCQkJCQkJaWYgKCBzZWxmLnVzZXJNb2RpZmllZCApIHsKCQkJCQkJICAgIHNlbGYucmVmcmVzaCggc2VsZi5iZWZvcmVTdGFydCA9PT0gMCA/IDEgOiAwICk7CgkJCQkJCX0KCQkJCQkJZWxzZSB7CgkJCQkJCSAgICBzZWxmLnJlZnJlc2goIHNlbGYuYmVmb3JlU3RhcnQgKTsKCQkJCQkJfQoJCQkJCX0KCQkJCQllbHNlIHsKCQkJCQkJLy8gdGhpcyBpcyBqdXN0IGEgY2xpY2ssIGNoYW5nZSB0aGUgdmFsdWUKCQkJCQkJc2VsZi5yZWZyZXNoKCBzZWxmLmJlZm9yZVN0YXJ0ID09PSAwID8gMSA6IDAgKTsKCQkJCQl9CgkJCQl9CgoJCQkJc2VsZi5tb3VzZU1vdmVkID0gZmFsc2U7CgkJCQlzZWxmLl90cmlnZ2VyKCAic3RvcCIgKTsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoJCX07CgoJCXRoaXMuX29uKCBzbGlkZXIuYWRkKCBkb2N1bWVudCApLCB7ICJ2bW91c2V1cCI6IHRoaXMuX3NsaWRlck1vdXNlVXAgfSk7CgkJc2xpZGVyLmluc2VydEFmdGVyKCBjb250cm9sICk7CgoJCS8vIE9ubHkgYWRkIGZvY3VzIGNsYXNzIHRvIHRvZ2dsZSBzd2l0Y2gsIHNsaWRlcnMgZ2V0IGl0IGF1dG9tYXRpY2FsbHkgZnJvbSB1aS1idG4KCQlpZiAoIGNUeXBlID09PSAnc2VsZWN0JyApIHsKCQkJdGhpcy5oYW5kbGUuYmluZCh7CgkJCQlmb2N1czogZnVuY3Rpb24oKSB7CgkJCQkJc2xpZGVyLmFkZENsYXNzKCAkLm1vYmlsZS5mb2N1c0NsYXNzICk7CgkJCQl9LAoKCQkJCWJsdXI6IGZ1bmN0aW9uKCkgewoJCQkJCXNsaWRlci5yZW1vdmVDbGFzcyggJC5tb2JpbGUuZm9jdXNDbGFzcyApOwoJCQkJfQoJCQl9KTsKCQl9CgoJCXRoaXMuaGFuZGxlLmJpbmQoewoJCQkvLyBOT1RFIGZvcmNlIGZvY3VzIG9uIGhhbmRsZQoJCQl2bW91c2Vkb3duOiBmdW5jdGlvbigpIHsKCQkJCSQoIHRoaXMgKS5mb2N1cygpOwoJCQl9LAoKCQkJdmNsaWNrOiBmYWxzZSwKCgkJCWtleWRvd246IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCXZhciBpbmRleCA9IHZhbCgpOwoKCQkJCWlmICggc2VsZi5vcHRpb25zLmRpc2FibGVkICkgewoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQkvLyBJbiBhbGwgY2FzZXMgcHJldmVudCB0aGUgZGVmYXVsdCBhbmQgbWFyayB0aGUgaGFuZGxlIGFzIGFjdGl2ZQoJCQkJc3dpdGNoICggZXZlbnQua2V5Q29kZSApIHsKCQkJCQljYXNlICQubW9iaWxlLmtleUNvZGUuSE9NRToKCQkJCQljYXNlICQubW9iaWxlLmtleUNvZGUuRU5EOgoJCQkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5QQUdFX1VQOgoJCQkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5QQUdFX0RPV046CgkJCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLlVQOgoJCQkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5SSUdIVDoKCQkJCQljYXNlICQubW9iaWxlLmtleUNvZGUuRE9XTjoKCQkJCQljYXNlICQubW9iaWxlLmtleUNvZGUuTEVGVDoKCQkJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCgkJCQkJCWlmICggIXNlbGYuX2tleVNsaWRpbmcgKSB7CgkJCQkJCQlzZWxmLl9rZXlTbGlkaW5nID0gdHJ1ZTsKCQkJCQkJCSQoIHRoaXMgKS5hZGRDbGFzcyggInVpLXN0YXRlLWFjdGl2ZSIgKTsKCQkJCQkJfQoJCQkJCQlicmVhazsKCQkJCX0KCgkJCQkvLyBtb3ZlIHRoZSBzbGlkZXIgYWNjb3JkaW5nIHRvIHRoZSBrZXlwcmVzcwoJCQkJc3dpdGNoICggZXZlbnQua2V5Q29kZSApIHsKCQkJCQljYXNlICQubW9iaWxlLmtleUNvZGUuSE9NRToKCQkJCQkJc2VsZi5yZWZyZXNoKCBtaW4gKTsKCQkJCQkJYnJlYWs7CgkJCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLkVORDoKCQkJCQkJc2VsZi5yZWZyZXNoKCBtYXggKTsKCQkJCQkJYnJlYWs7CgkJCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLlBBR0VfVVA6CgkJCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLlVQOgoJCQkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5SSUdIVDoKCQkJCQkJc2VsZi5yZWZyZXNoKCBpbmRleCArIHN0ZXAgKTsKCQkJCQkJYnJlYWs7CgkJCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLlBBR0VfRE9XTjoKCQkJCQljYXNlICQubW9iaWxlLmtleUNvZGUuRE9XTjoKCQkJCQljYXNlICQubW9iaWxlLmtleUNvZGUuTEVGVDoKCQkJCQkJc2VsZi5yZWZyZXNoKCBpbmRleCAtIHN0ZXAgKTsKCQkJCQkJYnJlYWs7CgkJCQl9CgkJCX0sIC8vIHJlbW92ZSBhY3RpdmUgbWFyawoKCQkJa2V5dXA6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCWlmICggc2VsZi5fa2V5U2xpZGluZyApIHsKCQkJCQlzZWxmLl9rZXlTbGlkaW5nID0gZmFsc2U7CgkJCQkJJCggdGhpcyApLnJlbW92ZUNsYXNzKCAidWktc3RhdGUtYWN0aXZlIiApOwoJCQkJfQoJCQl9CgkJCX0pOwoKCQl0aGlzLnJlZnJlc2goIHVuZGVmaW5lZCwgdW5kZWZpbmVkLCB0cnVlICk7Cgl9LAoKCV9jaGVja2VkUmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJaWYoIHRoaXMudmFsdWUgIT0gdGhpcy5fdmFsdWUoKSApewoJCQl0aGlzLnJlZnJlc2goIHRoaXMuX3ZhbHVlKCkgKTsKCQl9Cgl9LAoKCV92YWx1ZTogZnVuY3Rpb24oKSB7CgkJcmV0dXJuICB0aGlzLl90eXBlID09PSAiaW5wdXQiID8KCQkJcGFyc2VGbG9hdCggdGhpcy5lbGVtZW50LnZhbCgpICkgOiB0aGlzLmVsZW1lbnRbMF0uc2VsZWN0ZWRJbmRleDsKCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oIHZhbCwgaXNmcm9tQ29udHJvbCwgcHJldmVudElucHV0VXBkYXRlICkgewoKCQkvLyBOT1RFOiB3ZSBkb24ndCByZXR1cm4gaGVyZSBiZWNhdXNlIHdlIHdhbnQgdG8gc3VwcG9ydCBwcm9ncmFtbWF0aWMKCQkvLyAgICAgICBhbHRlcmF0aW9uIG9mIHRoZSBpbnB1dCB2YWx1ZSwgd2hpY2ggc2hvdWxkIHN0aWxsIHVwZGF0ZSB0aGUgc2xpZGVyCgkJaWYgKCB0aGlzLm9wdGlvbnMuZGlzYWJsZWQgfHwgdGhpcy5lbGVtZW50LmF0dHIoJ2Rpc2FibGVkJykpIHsKCQkJdGhpcy5kaXNhYmxlKCk7CgkJfQoKCQkvLyBzZXQgdGhlIHN0b3JlZCB2YWx1ZSBmb3IgY29tcGFyaXNvbiBsYXRlcgoJCXRoaXMudmFsdWUgPSB0aGlzLl92YWx1ZSgpOwoKCQl2YXIgY29udHJvbCA9IHRoaXMuZWxlbWVudCwgcGVyY2VudCwKCQkJY1R5cGUgPSBjb250cm9sWzBdLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCksCgkJCW1pbiA9IGNUeXBlID09PSAiaW5wdXQiID8gcGFyc2VGbG9hdCggY29udHJvbC5hdHRyKCAibWluIiApICkgOiAwLAoJCQltYXggPSBjVHlwZSA9PT0gImlucHV0IiA/IHBhcnNlRmxvYXQoIGNvbnRyb2wuYXR0ciggIm1heCIgKSApIDogY29udHJvbC5maW5kKCAib3B0aW9uIiApLmxlbmd0aCAtIDEsCgkJCXN0ZXAgPSAoIGNUeXBlID09PSAiaW5wdXQiICYmIHBhcnNlRmxvYXQoIGNvbnRyb2wuYXR0ciggInN0ZXAiICkgKSA+IDAgKSA/IHBhcnNlRmxvYXQoIGNvbnRyb2wuYXR0ciggInN0ZXAiICkgKSA6IDE7CgoJCWlmICggdHlwZW9mIHZhbCA9PT0gIm9iamVjdCIgKSB7CgkJCXZhciBkYXRhID0gdmFsLAoJCQkJLy8gYSBzbGlnaHQgdG9sZXJhbmNlIGhlbHBlZCBnZXQgdG8gdGhlIGVuZHMgb2YgdGhlIHNsaWRlcgoJCQkJdG9sID0gODsKCQkJaWYgKCAhdGhpcy5kcmFnZ2luZyB8fAoJCQkJCWRhdGEucGFnZVggPCB0aGlzLnNsaWRlci5vZmZzZXQoKS5sZWZ0IC0gdG9sIHx8CgkJCQkJZGF0YS5wYWdlWCA+IHRoaXMuc2xpZGVyLm9mZnNldCgpLmxlZnQgKyB0aGlzLnNsaWRlci53aWR0aCgpICsgdG9sICkgewoJCQkJcmV0dXJuOwoJCQl9CgkJCXBlcmNlbnQgPSBNYXRoLnJvdW5kKCAoICggZGF0YS5wYWdlWCAtIHRoaXMuc2xpZGVyLm9mZnNldCgpLmxlZnQgKSAvIHRoaXMuc2xpZGVyLndpZHRoKCkgKSAqIDEwMCApOwoJCX0gZWxzZSB7CgkJCWlmICggdmFsID09IG51bGwgKSB7CgkJCQl2YWwgPSBjVHlwZSA9PT0gImlucHV0IiA/IHBhcnNlRmxvYXQoIGNvbnRyb2wudmFsKCkgfHwgMCApIDogY29udHJvbFswXS5zZWxlY3RlZEluZGV4OwoJCQl9CgkJCXBlcmNlbnQgPSAoIHBhcnNlRmxvYXQoIHZhbCApIC0gbWluICkgLyAoIG1heCAtIG1pbiApICogMTAwOwoJCX0KCgkJaWYgKCBpc05hTiggcGVyY2VudCApICkgewoJCQlyZXR1cm47CgkJfQoKCQlpZiAoIHBlcmNlbnQgPCAwICkgewoJCQlwZXJjZW50ID0gMDsKCQl9CgoJCWlmICggcGVyY2VudCA+IDEwMCApIHsKCQkJcGVyY2VudCA9IDEwMDsKCQl9CgoJCXZhciBuZXd2YWwgPSAoIHBlcmNlbnQgLyAxMDAgKSAqICggbWF4IC0gbWluICkgKyBtaW47CgoJCS8vZnJvbSBqUXVlcnkgVUkgc2xpZGVyLCB0aGUgZm9sbG93aW5nIHNvdXJjZSB3aWxsIHJvdW5kIHRvIHRoZSBuZWFyZXN0IHN0ZXAKCQl2YXIgdmFsTW9kU3RlcCA9ICggbmV3dmFsIC0gbWluICkgJSBzdGVwOwoJCXZhciBhbGlnblZhbHVlID0gbmV3dmFsIC0gdmFsTW9kU3RlcDsKCgkJaWYgKCBNYXRoLmFicyggdmFsTW9kU3RlcCApICogMiA+PSBzdGVwICkgewoJCQlhbGlnblZhbHVlICs9ICggdmFsTW9kU3RlcCA+IDAgKSA/IHN0ZXAgOiAoIC1zdGVwICk7CgkJfQoJCS8vIFNpbmNlIEphdmFTY3JpcHQgaGFzIHByb2JsZW1zIHdpdGggbGFyZ2UgZmxvYXRzLCByb3VuZAoJCS8vIHRoZSBmaW5hbCB2YWx1ZSB0byA1IGRpZ2l0cyBhZnRlciB0aGUgZGVjaW1hbCBwb2ludCAoc2VlIGpRdWVyeVVJOiAjNDEyNCkKCQluZXd2YWwgPSBwYXJzZUZsb2F0KCBhbGlnblZhbHVlLnRvRml4ZWQoNSkgKTsKCgkJaWYgKCBuZXd2YWwgPCBtaW4gKSB7CgkJCW5ld3ZhbCA9IG1pbjsKCQl9CgoJCWlmICggbmV3dmFsID4gbWF4ICkgewoJCQluZXd2YWwgPSBtYXg7CgkJfQoKCQl0aGlzLmhhbmRsZS5jc3MoICJsZWZ0IiwgcGVyY2VudCArICIlIiApOwoJCXRoaXMuaGFuZGxlLmF0dHIoIHsKCQkJCSJhcmlhLXZhbHVlbm93IjogY1R5cGUgPT09ICJpbnB1dCIgPyBuZXd2YWwgOiBjb250cm9sLmZpbmQoICJvcHRpb24iICkuZXEoIG5ld3ZhbCApLmF0dHIoICJ2YWx1ZSIgKSwKCQkJCSJhcmlhLXZhbHVldGV4dCI6IGNUeXBlID09PSAiaW5wdXQiID8gbmV3dmFsIDogY29udHJvbC5maW5kKCAib3B0aW9uIiApLmVxKCBuZXd2YWwgKS5nZXRFbmNvZGVkVGV4dCgpLAoJCQkJdGl0bGU6IGNUeXBlID09PSAiaW5wdXQiID8gbmV3dmFsIDogY29udHJvbC5maW5kKCAib3B0aW9uIiApLmVxKCBuZXd2YWwgKS5nZXRFbmNvZGVkVGV4dCgpCgkJCX0pOwoKCQlpZiAoIHRoaXMudmFsdWViZyApIHsKCQkJdGhpcy52YWx1ZWJnLmNzcyggIndpZHRoIiwgcGVyY2VudCArICIlIiApOwoJCX0KCgkJLy8gZHJhZyB0aGUgbGFiZWwgd2lkdGhzCgkJaWYgKCB0aGlzLl9sYWJlbHMgKSB7CgkJCXZhciBoYW5kbGVQZXJjZW50ID0gdGhpcy5oYW5kbGUud2lkdGgoKSAvIHRoaXMuc2xpZGVyLndpZHRoKCkgKiAxMDAsCgkJCQlhUGVyY2VudCA9IHBlcmNlbnQgJiYgaGFuZGxlUGVyY2VudCArICggMTAwIC0gaGFuZGxlUGVyY2VudCApICogcGVyY2VudCAvIDEwMCwKCQkJCWJQZXJjZW50ID0gcGVyY2VudCA9PT0gMTAwID8gMCA6IE1hdGgubWluKCBoYW5kbGVQZXJjZW50ICsgMTAwIC0gYVBlcmNlbnQsIDEwMCApOwoKCQkJdGhpcy5fbGFiZWxzLmVhY2goZnVuY3Rpb24oKSB7CgkJCQl2YXIgYWIgPSAkKCB0aGlzICkuaXMoICIudWktc2xpZGVyLWxhYmVsLWEiICk7CgkJCQkkKCB0aGlzICkud2lkdGgoICggYWIgPyBhUGVyY2VudCA6IGJQZXJjZW50ICApICsgIiUiICk7CgkJCX0pOwoJCX0KCgkJaWYgKCAhcHJldmVudElucHV0VXBkYXRlICkgewoJCQl2YXIgdmFsdWVDaGFuZ2VkID0gZmFsc2U7CgoJCQkvLyB1cGRhdGUgY29udHJvbCJzIHZhbHVlCgkJCWlmICggY1R5cGUgPT09ICJpbnB1dCIgKSB7CgkJCQl2YWx1ZUNoYW5nZWQgPSBjb250cm9sLnZhbCgpICE9PSBuZXd2YWw7CgkJCQljb250cm9sLnZhbCggbmV3dmFsICk7CgkJCX0gZWxzZSB7CgkJCQl2YWx1ZUNoYW5nZWQgPSBjb250cm9sWyAwIF0uc2VsZWN0ZWRJbmRleCAhPT0gbmV3dmFsOwoJCQkJY29udHJvbFsgMCBdLnNlbGVjdGVkSW5kZXggPSBuZXd2YWw7CgkJCX0KCQkJaWYgKCAhaXNmcm9tQ29udHJvbCAmJiB2YWx1ZUNoYW5nZWQgKSB7CgkJCQljb250cm9sLnRyaWdnZXIoICJjaGFuZ2UiICk7CgkJCX0KCQl9Cgl9LAoKCWVuYWJsZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5lbGVtZW50LmF0dHIoICJkaXNhYmxlZCIsIGZhbHNlICk7CgkJdGhpcy5zbGlkZXIucmVtb3ZlQ2xhc3MoICJ1aS1kaXNhYmxlZCIgKS5hdHRyKCAiYXJpYS1kaXNhYmxlZCIsIGZhbHNlICk7CgkJcmV0dXJuIHRoaXMuX3NldE9wdGlvbiggImRpc2FibGVkIiwgZmFsc2UgKTsKCX0sCgoJZGlzYWJsZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5lbGVtZW50LmF0dHIoICJkaXNhYmxlZCIsIHRydWUgKTsKCQl0aGlzLnNsaWRlci5hZGRDbGFzcyggInVpLWRpc2FibGVkIiApLmF0dHIoICJhcmlhLWRpc2FibGVkIiwgdHJ1ZSApOwoJCXJldHVybiB0aGlzLl9zZXRPcHRpb24oICJkaXNhYmxlZCIsIHRydWUgKTsKCX0KCn0pOwoKLy9hdXRvIHNlbGYtaW5pdCB3aWRnZXRzCiQoIGRvY3VtZW50ICkuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKSB7CgkkLm1vYmlsZS5zbGlkZXIucHJvdG90eXBlLmVuaGFuY2VXaXRoaW4oIGUudGFyZ2V0LCB0cnVlICk7Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS5zZWxlY3RtZW51IiwgJC5tb2JpbGUud2lkZ2V0LCB7CglvcHRpb25zOiB7CgkJdGhlbWU6IG51bGwsCgkJZGlzYWJsZWQ6IGZhbHNlLAoJCWljb246ICJhcnJvdy1kIiwKCQlpY29ucG9zOiAicmlnaHQiLAoJCWlubGluZTogZmFsc2UsCgkJY29ybmVyczogdHJ1ZSwKCQlzaGFkb3c6IHRydWUsCgkJaWNvbnNoYWRvdzogdHJ1ZSwKCQlvdmVybGF5VGhlbWU6ICJhIiwKCQloaWRlUGxhY2Vob2xkZXJNZW51SXRlbXM6IHRydWUsCgkJY2xvc2VUZXh0OiAiQ2xvc2UiLAoJCW5hdGl2ZU1lbnU6IHRydWUsCgkJLy8gVGhpcyBvcHRpb24gZGVmYXVsdHMgdG8gdHJ1ZSBvbiBpT1MgZGV2aWNlcy4KCQlwcmV2ZW50Rm9jdXNab29tOiAvaVBob25lfGlQYWR8aVBvZC8udGVzdCggbmF2aWdhdG9yLnBsYXRmb3JtICkgJiYgbmF2aWdhdG9yLnVzZXJBZ2VudC5pbmRleE9mKCAiQXBwbGVXZWJLaXQiICkgPiAtMSwKCQlpbml0U2VsZWN0b3I6ICJzZWxlY3Q6bm90KCA6anFtRGF0YShyb2xlPSdzbGlkZXInKSApIiwKCQltaW5pOiBmYWxzZQoJfSwKCglfYnV0dG9uOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gJCggIjxkaXYvPiIgKTsKCX0sCgoJX3NldERpc2FibGVkOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJdGhpcy5lbGVtZW50LmF0dHIoICJkaXNhYmxlZCIsIHZhbHVlICk7CgkJdGhpcy5idXR0b24uYXR0ciggImFyaWEtZGlzYWJsZWQiLCB2YWx1ZSApOwoJCXJldHVybiB0aGlzLl9zZXRPcHRpb24oICJkaXNhYmxlZCIsIHZhbHVlICk7Cgl9LAoKCV9mb2N1c0J1dHRvbiA6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpczsKCgkJc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCXNlbGYuYnV0dG9uLmZvY3VzKCk7CgkJfSwgNDApOwoJfSwKCglfc2VsZWN0T3B0aW9uczogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuc2VsZWN0LmZpbmQoICJvcHRpb24iICk7Cgl9LAoKCS8vIHNldHVwIGl0ZW1zIHRoYXQgYXJlIGdlbmVyYWxseSBuZWNlc3NhcnkgZm9yIHNlbGVjdCBtZW51IGV4dGVuc2lvbgoJX3ByZUV4dGVuc2lvbjogZnVuY3Rpb24oKSB7CgkJdmFyIGNsYXNzZXMgPSAiIjsKCQkvLyBUT0RPOiBQb3N0IDEuMS0tb25jZSB3ZSBoYXZlIHRpbWUgdG8gdGVzdCB0aG9yb3VnaGx5LS1hbnkgY2xhc3NlcyBtYW51YWxseSBhcHBsaWVkIHRvIHRoZSBvcmlnaW5hbCBlbGVtZW50IHNob3VsZCBiZSBjYXJyaWVkIG92ZXIgdG8gdGhlIGVuaGFuY2VkIGVsZW1lbnQsIHdpdGggYW4gYC1lbmhhbmNlZGAgc3VmZml4LiBTZWUgaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnktbW9iaWxlL2lzc3Vlcy8zNTc3CgkJLyogaWYgKCAkZWxbMF0uY2xhc3NOYW1lLmxlbmd0aCApIHsKCQkJY2xhc3NlcyA9ICRlbFswXS5jbGFzc05hbWU7CgkJfSAqLwoJCWlmICggISF+dGhpcy5lbGVtZW50WzBdLmNsYXNzTmFtZS5pbmRleE9mKCAidWktYnRuLWxlZnQiICkgKSB7CgkJCWNsYXNzZXMgPSAgIiB1aS1idG4tbGVmdCI7CgkJfQoKCQlpZiAoICAhIX50aGlzLmVsZW1lbnRbMF0uY2xhc3NOYW1lLmluZGV4T2YoICJ1aS1idG4tcmlnaHQiICkgKSB7CgkJCWNsYXNzZXMgPSAiIHVpLWJ0bi1yaWdodCI7CgkJfQoKCQl0aGlzLnNlbGVjdCA9IHRoaXMuZWxlbWVudC53cmFwKCAiPGRpdiBjbGFzcz0ndWktc2VsZWN0IiArIGNsYXNzZXMgKyAiJz4iICk7CgkJdGhpcy5zZWxlY3RJRCAgPSB0aGlzLnNlbGVjdC5hdHRyKCAiaWQiICk7CgkJdGhpcy5sYWJlbCA9ICQoICJsYWJlbFtmb3I9JyIrIHRoaXMuc2VsZWN0SUQgKyInXSIgKS5hZGRDbGFzcyggInVpLXNlbGVjdCIgKTsKCQl0aGlzLmlzTXVsdGlwbGUgPSB0aGlzLnNlbGVjdFsgMCBdLm11bHRpcGxlOwoJCWlmICggIXRoaXMub3B0aW9ucy50aGVtZSApIHsKCQkJdGhpcy5vcHRpb25zLnRoZW1lID0gJC5tb2JpbGUuZ2V0SW5oZXJpdGVkVGhlbWUoIHRoaXMuc2VsZWN0LCAiYyIgKTsKCQl9Cgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3ByZUV4dGVuc2lvbigpOwoKCQkvLyBBbGxvd3MgZm9yIGV4dGVuc2lvbiBvZiB0aGUgbmF0aXZlIHNlbGVjdCBmb3IgY3VzdG9tIHNlbGVjdHMgYW5kIG90aGVyIHBsdWdpbnMKCQkvLyBzZWUgc2VsZWN0LmN1c3RvbSBmb3IgZXhhbXBsZSBleHRlbnNpb24KCQkvLyBUT0RPIGV4cGxvcmUgcGx1Z2luIHJlZ2lzdHJhdGlvbgoJCXRoaXMuX3RyaWdnZXIoICJiZWZvcmVDcmVhdGUiICk7CgoJCXRoaXMuYnV0dG9uID0gdGhpcy5fYnV0dG9uKCk7CgoJCXZhciBzZWxmID0gdGhpcywKCgkJCW9wdGlvbnMgPSB0aGlzLm9wdGlvbnMsCgoJCQlpbmxpbmUgPSBvcHRpb25zLmlubGluZSB8fCB0aGlzLnNlbGVjdC5qcW1EYXRhKCAiaW5saW5lIiApLAoJCQltaW5pID0gb3B0aW9ucy5taW5pIHx8IHRoaXMuc2VsZWN0LmpxbURhdGEoICJtaW5pIiApLAoJCQlpY29ucG9zID0gb3B0aW9ucy5pY29uID8gKCBvcHRpb25zLmljb25wb3MgfHwgdGhpcy5zZWxlY3QuanFtRGF0YSggImljb25wb3MiICkgKSA6IGZhbHNlLAoKCQkJLy8gSUUgdGhyb3dzIGFuIGV4Y2VwdGlvbiBhdCBvcHRpb25zLml0ZW0oKSBmdW5jdGlvbiB3aGVuCgkJCS8vIHRoZXJlIGlzIG5vIHNlbGVjdGVkIGl0ZW0KCQkJLy8gc2VsZWN0IGZpcnN0IGluIHRoaXMgY2FzZQoJCQlzZWxlY3RlZEluZGV4ID0gdGhpcy5zZWxlY3RbIDAgXS5zZWxlY3RlZEluZGV4ID09PSAtMSA/IDAgOiB0aGlzLnNlbGVjdFsgMCBdLnNlbGVjdGVkSW5kZXgsCgoJCQkvLyBUT0RPIHZhbHVlcyBidXR0b25JZCBhbmQgbWVudUlkIGFyZSB1bmRlZmluZWQgaGVyZQoJCQlidXR0b24gPSB0aGlzLmJ1dHRvbgoJCQkJLmluc2VydEJlZm9yZSggdGhpcy5zZWxlY3QgKQoJCQkJLmJ1dHRvbk1hcmt1cCggewoJCQkJCXRoZW1lOiBvcHRpb25zLnRoZW1lLAoJCQkJCWljb246IG9wdGlvbnMuaWNvbiwKCQkJCQlpY29ucG9zOiBpY29ucG9zLAoJCQkJCWlubGluZTogaW5saW5lLAoJCQkJCWNvcm5lcnM6IG9wdGlvbnMuY29ybmVycywKCQkJCQlzaGFkb3c6IG9wdGlvbnMuc2hhZG93LAoJCQkJCWljb25zaGFkb3c6IG9wdGlvbnMuaWNvbnNoYWRvdywKCQkJCQltaW5pOiBtaW5pCgkJCQl9KTsKCgkJdGhpcy5zZXRCdXR0b25UZXh0KCk7CgoJCS8vIE9wZXJhIGRvZXMgbm90IHByb3Blcmx5IHN1cHBvcnQgb3BhY2l0eSBvbiBzZWxlY3QgZWxlbWVudHMKCQkvLyBJbiBNaW5pLCBpdCBoaWRlcyB0aGUgZWxlbWVudCwgYnV0IG5vdCBpdHMgdGV4dAoJCS8vIE9uIHRoZSBkZXNrdG9wLGl0IHNlZW1zIHRvIGRvIHRoZSBvcHBvc2l0ZQoJCS8vIGZvciB0aGVzZSByZWFzb25zLCB1c2luZyB0aGUgbmF0aXZlTWVudSBvcHRpb24gcmVzdWx0cyBpbiBhIGZ1bGwgbmF0aXZlIHNlbGVjdCBpbiBPcGVyYQoJCWlmICggb3B0aW9ucy5uYXRpdmVNZW51ICYmIHdpbmRvdy5vcGVyYSAmJiB3aW5kb3cub3BlcmEudmVyc2lvbiApIHsKCQkJYnV0dG9uLmFkZENsYXNzKCAidWktc2VsZWN0LW5hdGl2ZW9ubHkiICk7CgkJfQoKCQkvLyBBZGQgY291bnRlciBmb3IgbXVsdGkgc2VsZWN0cwoJCWlmICggdGhpcy5pc011bHRpcGxlICkgewoJCQl0aGlzLmJ1dHRvbkNvdW50ID0gJCggIjxzcGFuPiIgKQoJCQkJLmFkZENsYXNzKCAidWktbGktY291bnQgdWktYnRuLXVwLWMgdWktYnRuLWNvcm5lci1hbGwiICkKCQkJCS5oaWRlKCkKCQkJCS5hcHBlbmRUbyggYnV0dG9uLmFkZENsYXNzKCd1aS1saS1oYXMtY291bnQnKSApOwoJCX0KCgkJLy8gRGlzYWJsZSBpZiBzcGVjaWZpZWQKCQlpZiAoIG9wdGlvbnMuZGlzYWJsZWQgfHwgdGhpcy5lbGVtZW50LmF0dHIoJ2Rpc2FibGVkJykpIHsKCQkJdGhpcy5kaXNhYmxlKCk7CgkJfQoKCQkvLyBFdmVudHMgb24gbmF0aXZlIHNlbGVjdAoJCXRoaXMuc2VsZWN0LmNoYW5nZShmdW5jdGlvbigpIHsKCQkJc2VsZi5yZWZyZXNoKCk7CgkJfSk7CgoJCXRoaXMuYnVpbGQoKTsKCX0sCgoJYnVpbGQ6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpczsKCgkJdGhpcy5zZWxlY3QKCQkJLmFwcGVuZFRvKCBzZWxmLmJ1dHRvbiApCgkJCS5iaW5kKCAidm1vdXNlZG93biIsIGZ1bmN0aW9uKCkgewoJCQkJLy8gQWRkIGFjdGl2ZSBjbGFzcyB0byBidXR0b24KCQkJCXNlbGYuYnV0dG9uLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQl9KQoJCQkuYmluZCggImZvY3VzIiwgZnVuY3Rpb24oKSB7CgkJCQlzZWxmLmJ1dHRvbi5hZGRDbGFzcyggJC5tb2JpbGUuZm9jdXNDbGFzcyApOwoJCQl9KQoJCQkuYmluZCggImJsdXIiLCBmdW5jdGlvbigpIHsKCQkJCXNlbGYuYnV0dG9uLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5mb2N1c0NsYXNzICk7CgkJCX0pCgkJCS5iaW5kKCAiZm9jdXMgdm1vdXNlb3ZlciIsIGZ1bmN0aW9uKCkgewoJCQkJc2VsZi5idXR0b24udHJpZ2dlciggInZtb3VzZW92ZXIiICk7CgkJCX0pCgkJCS5iaW5kKCAidm1vdXNlbW92ZSIsIGZ1bmN0aW9uKCkgewoJCQkJLy8gUmVtb3ZlIGFjdGl2ZSBjbGFzcyBvbiBzY3JvbGwvdG91Y2htb3ZlCgkJCQlzZWxmLmJ1dHRvbi5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJfSkKCQkJLmJpbmQoICJjaGFuZ2UgYmx1ciB2bW91c2VvdXQiLCBmdW5jdGlvbigpIHsKCQkJCXNlbGYuYnV0dG9uLnRyaWdnZXIoICJ2bW91c2VvdXQiICkKCQkJCQkucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCX0pCgkJCS5iaW5kKCAiY2hhbmdlIGJsdXIiLCBmdW5jdGlvbigpIHsKCQkJCXNlbGYuYnV0dG9uLnJlbW92ZUNsYXNzKCAidWktYnRuLWRvd24tIiArIHNlbGYub3B0aW9ucy50aGVtZSApOwoJCQl9KTsKCgkJLy8gSW4gbWFueSBzaXR1YXRpb25zLCBpT1Mgd2lsbCB6b29tIGludG8gdGhlIHNlbGVjdCB1cG9uIHRhcCwgdGhpcyBwcmV2ZW50cyB0aGF0IGZyb20gaGFwcGVuaW5nCgkJc2VsZi5idXR0b24uYmluZCggInZtb3VzZWRvd24iLCBmdW5jdGlvbigpIHsKCQkJaWYgKCBzZWxmLm9wdGlvbnMucHJldmVudEZvY3VzWm9vbSApIHsKCQkJCSQubW9iaWxlLnpvb20uZGlzYWJsZSggdHJ1ZSApOwoJCQl9CgkJfSkuYmluZCggIm1vdXNldXAiLCBmdW5jdGlvbigpIHsKCQkJaWYgKCBzZWxmLm9wdGlvbnMucHJldmVudEZvY3VzWm9vbSApIHsKCQkJCXNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CgkJCQkJJC5tb2JpbGUuem9vbS5lbmFibGUoIHRydWUgKTsKCQkJCX0sIDApOwoJCQl9CgkJfSk7Cgl9LAoKCXNlbGVjdGVkOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5fc2VsZWN0T3B0aW9ucygpLmZpbHRlciggIjpzZWxlY3RlZCIgKTsKCX0sCgoJc2VsZWN0ZWRJbmRpY2VzOiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXM7CgoJCXJldHVybiB0aGlzLnNlbGVjdGVkKCkubWFwKGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gc2VsZi5fc2VsZWN0T3B0aW9ucygpLmluZGV4KCB0aGlzICk7CgkJfSkuZ2V0KCk7Cgl9LAoKCXNldEJ1dHRvblRleHQ6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpcywKCQkJc2VsZWN0ZWQgPSB0aGlzLnNlbGVjdGVkKCksCgkJCXRleHQgPSB0aGlzLnBsYWNlaG9sZGVyLAoJCQlzcGFuID0gJCggZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggInNwYW4iICkgKTsKCgkJdGhpcy5idXR0b24uZmluZCggIi51aS1idG4tdGV4dCIgKS5odG1sKGZ1bmN0aW9uKCkgewoJCQlpZiAoIHNlbGVjdGVkLmxlbmd0aCApIHsKCQkJCXRleHQgPSBzZWxlY3RlZC5tYXAoZnVuY3Rpb24oKSB7CgkJCQkJcmV0dXJuICQoIHRoaXMgKS50ZXh0KCk7CgkJCQl9KS5nZXQoKS5qb2luKCAiLCAiICk7CgkJCX0gZWxzZSB7CgkJCQl0ZXh0ID0gc2VsZi5wbGFjZWhvbGRlcjsKCQkJfQoKCQkJLy8gVE9ETyBwb3NzaWJseSBhZ2dyZWdhdGUgbXVsdGlwbGUgc2VsZWN0IG9wdGlvbiBjbGFzc2VzCgkJCXJldHVybiBzcGFuLnRleHQoIHRleHQgKQoJCQkJLmFkZENsYXNzKCBzZWxmLnNlbGVjdC5hdHRyKCAiY2xhc3MiICkgKQoJCQkJLmFkZENsYXNzKCBzZWxlY3RlZC5hdHRyKCAiY2xhc3MiICkgKTsKCQl9KTsKCX0sCgoJc2V0QnV0dG9uQ291bnQ6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxlY3RlZCA9IHRoaXMuc2VsZWN0ZWQoKTsKCgkJLy8gbXVsdGlwbGUgY291bnQgaW5zaWRlIGJ1dHRvbgoJCWlmICggdGhpcy5pc011bHRpcGxlICkgewoJCQl0aGlzLmJ1dHRvbkNvdW50WyBzZWxlY3RlZC5sZW5ndGggPiAxID8gInNob3ciIDogImhpZGUiIF0oKS50ZXh0KCBzZWxlY3RlZC5sZW5ndGggKTsKCQl9Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCXRoaXMuc2V0QnV0dG9uVGV4dCgpOwoJCXRoaXMuc2V0QnV0dG9uQ291bnQoKTsKCX0sCgoJLy8gb3BlbiBhbmQgY2xvc2UgcHJlc2VydmVkIGluIG5hdGl2ZSBzZWxlY3RzCgkvLyB0byBzaW1wbGlmeSB1c2VycyBjb2RlIHdoZW4gbG9vcGluZyBvdmVyIHNlbGVjdHMKCW9wZW46ICQubm9vcCwKCWNsb3NlOiAkLm5vb3AsCgoJZGlzYWJsZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5fc2V0RGlzYWJsZWQoIHRydWUgKTsKCQl0aGlzLmJ1dHRvbi5hZGRDbGFzcyggInVpLWRpc2FibGVkIiApOwoJfSwKCgllbmFibGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3NldERpc2FibGVkKCBmYWxzZSApOwoJCXRoaXMuYnV0dG9uLnJlbW92ZUNsYXNzKCAidWktZGlzYWJsZWQiICk7Cgl9Cn0pOwoKLy9hdXRvIHNlbGYtaW5pdCB3aWRnZXRzCiQoIGRvY3VtZW50ICkuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKSB7CgkkLm1vYmlsZS5zZWxlY3RtZW51LnByb3RvdHlwZS5lbmhhbmNlV2l0aGluKCBlLnRhcmdldCwgdHJ1ZSApOwp9KTsKfSkoIGpRdWVyeSApOwoKLyoKKiBjdXN0b20gInNlbGVjdG1lbnUiIHBsdWdpbgoqLwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7Cgl2YXIgZXh0ZW5kU2VsZWN0ID0gZnVuY3Rpb24oIHdpZGdldCApIHsKCgkJdmFyIHNlbGVjdCA9IHdpZGdldC5zZWxlY3QsCgkJCXNlbGVjdElEICA9IHdpZGdldC5zZWxlY3RJRCwKCQkJbGFiZWwgPSB3aWRnZXQubGFiZWwsCgkJCXRoaXNQYWdlID0gd2lkZ2V0LnNlbGVjdC5jbG9zZXN0KCAiLnVpLXBhZ2UiICksCgkJCXNlbGVjdE9wdGlvbnMgPSB3aWRnZXQuX3NlbGVjdE9wdGlvbnMoKSwKCQkJaXNNdWx0aXBsZSA9IHdpZGdldC5pc011bHRpcGxlID0gd2lkZ2V0LnNlbGVjdFsgMCBdLm11bHRpcGxlLAoJCQlidXR0b25JZCA9IHNlbGVjdElEICsgIi1idXR0b24iLAoJCQltZW51SWQgPSBzZWxlY3RJRCArICItbWVudSIsCgkJCW1lbnVQYWdlID0gJCggIjxkaXYgZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicm9sZT0nZGlhbG9nJyBkYXRhLSIgKyQubW9iaWxlLm5zICsgInRoZW1lPSciKyB3aWRnZXQub3B0aW9ucy50aGVtZSArIicgZGF0YS0iICskLm1vYmlsZS5ucyArICJvdmVybGF5LXRoZW1lPSciKyB3aWRnZXQub3B0aW9ucy5vdmVybGF5VGhlbWUgKyInPiIgKwoJCQkJIjxkaXYgZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicm9sZT0naGVhZGVyJz4iICsKCQkJCSI8ZGl2IGNsYXNzPSd1aS10aXRsZSc+IiArIGxhYmVsLmdldEVuY29kZWRUZXh0KCkgKyAiPC9kaXY+IisKCQkJCSI8L2Rpdj4iKwoJCQkJIjxkaXYgZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicm9sZT0nY29udGVudCc+PC9kaXY+IisKCQkJCSI8L2Rpdj4iICksCgoJCQlsaXN0Ym94ID0gICQoICI8ZGl2PiIsIHsgImNsYXNzIjogInVpLXNlbGVjdG1lbnUiIH0gKS5pbnNlcnRBZnRlciggd2lkZ2V0LnNlbGVjdCApLnBvcHVwKCB7IHRoZW1lOiAiYSIgfSApLAoKCQkJbGlzdCA9ICQoICI8dWw+IiwgewoJCQkJImNsYXNzIjogInVpLXNlbGVjdG1lbnUtbGlzdCIsCgkJCQkiaWQiOiBtZW51SWQsCgkJCQkicm9sZSI6ICJsaXN0Ym94IiwKCQkJCSJhcmlhLWxhYmVsbGVkYnkiOiBidXR0b25JZAoJCQl9KS5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidGhlbWUiLCB3aWRnZXQub3B0aW9ucy50aGVtZSApLmFwcGVuZFRvKCBsaXN0Ym94ICksCgoJCQloZWFkZXIgPSAkKCAiPGRpdj4iLCB7CgkJCQkiY2xhc3MiOiAidWktaGVhZGVyIHVpLWJhci0iICsgd2lkZ2V0Lm9wdGlvbnMudGhlbWUKCQkJfSkucHJlcGVuZFRvKCBsaXN0Ym94ICksCgoJCQloZWFkZXJUaXRsZSA9ICQoICI8aDE+IiwgewoJCQkJImNsYXNzIjogInVpLXRpdGxlIgoJCQl9KS5hcHBlbmRUbyggaGVhZGVyICksCgoJCQltZW51UGFnZUNvbnRlbnQsCgkJCW1lbnVQYWdlQ2xvc2UsCgkJCWhlYWRlckNsb3NlOwoKCQlpZiAoIHdpZGdldC5pc011bHRpcGxlICkgewoJCQloZWFkZXJDbG9zZSA9ICQoICI8YT4iLCB7CgkJCQkidGV4dCI6IHdpZGdldC5vcHRpb25zLmNsb3NlVGV4dCwKCQkJCSJocmVmIjogIiMiLAoJCQkJImNsYXNzIjogInVpLWJ0bi1sZWZ0IgoJCQl9KS5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAiaWNvbnBvcyIsICJub3RleHQiICkuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgImljb24iLCAiZGVsZXRlIiApLmFwcGVuZFRvKCBoZWFkZXIgKS5idXR0b25NYXJrdXAoKTsKCQl9CgoJCSQuZXh0ZW5kKCB3aWRnZXQsIHsKCQkJc2VsZWN0OiB3aWRnZXQuc2VsZWN0LAoJCQlzZWxlY3RJRDogc2VsZWN0SUQsCgkJCWJ1dHRvbklkOiBidXR0b25JZCwKCQkJbWVudUlkOiBtZW51SWQsCgkJCXRoaXNQYWdlOiB0aGlzUGFnZSwKCQkJbWVudVBhZ2U6IG1lbnVQYWdlLAoJCQlsYWJlbDogbGFiZWwsCgkJCXNlbGVjdE9wdGlvbnM6IHNlbGVjdE9wdGlvbnMsCgkJCWlzTXVsdGlwbGU6IGlzTXVsdGlwbGUsCgkJCXRoZW1lOiB3aWRnZXQub3B0aW9ucy50aGVtZSwKCQkJbGlzdGJveDogbGlzdGJveCwKCQkJbGlzdDogbGlzdCwKCQkJaGVhZGVyOiBoZWFkZXIsCgkJCWhlYWRlclRpdGxlOiBoZWFkZXJUaXRsZSwKCQkJaGVhZGVyQ2xvc2U6IGhlYWRlckNsb3NlLAoJCQltZW51UGFnZUNvbnRlbnQ6IG1lbnVQYWdlQ29udGVudCwKCQkJbWVudVBhZ2VDbG9zZTogbWVudVBhZ2VDbG9zZSwKCQkJcGxhY2Vob2xkZXI6ICIiLAoKCQkJYnVpbGQ6IGZ1bmN0aW9uKCkgewoJCQkJdmFyIHNlbGYgPSB0aGlzOwoKCQkJCS8vIENyZWF0ZSBsaXN0IGZyb20gc2VsZWN0LCB1cGRhdGUgc3RhdGUKCQkJCXNlbGYucmVmcmVzaCgpOwoKCQkJCXNlbGYuc2VsZWN0LmF0dHIoICJ0YWJpbmRleCIsICItMSIgKS5mb2N1cyhmdW5jdGlvbigpIHsKCQkJCQkkKCB0aGlzICkuYmx1cigpOwoJCQkJCXNlbGYuYnV0dG9uLmZvY3VzKCk7CgkJCQl9KTsKCgkJCQkvLyBCdXR0b24gZXZlbnRzCgkJCQlzZWxmLmJ1dHRvbi5iaW5kKCAidmNsaWNrIGtleWRvd24iICwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJCWlmIChldmVudC50eXBlID09PSAidmNsaWNrIiB8fAoJCQkJCQkJZXZlbnQua2V5Q29kZSAmJiAoZXZlbnQua2V5Q29kZSA9PT0gJC5tb2JpbGUua2V5Q29kZS5FTlRFUiB8fAoJCQkJCQkJCQkJCQkJCQkJZXZlbnQua2V5Q29kZSA9PT0gJC5tb2JpbGUua2V5Q29kZS5TUEFDRSkpIHsKCgkJCQkJCXNlbGYub3BlbigpOwoJCQkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJCX0KCQkJCX0pOwoKCQkJCS8vIEV2ZW50cyBmb3IgbGlzdCBpdGVtcwoJCQkJc2VsZi5saXN0LmF0dHIoICJyb2xlIiwgImxpc3Rib3giICkKCQkJCQkuYmluZCggImZvY3VzaW4iLCBmdW5jdGlvbiggZSApIHsKCQkJCQkJJCggZS50YXJnZXQgKQoJCQkJCQkJLmF0dHIoICJ0YWJpbmRleCIsICIwIiApCgkJCQkJCQkudHJpZ2dlciggInZtb3VzZW92ZXIiICk7CgoJCQkJCX0pCgkJCQkJLmJpbmQoICJmb2N1c291dCIsIGZ1bmN0aW9uKCBlICkgewoJCQkJCQkkKCBlLnRhcmdldCApCgkJCQkJCQkuYXR0ciggInRhYmluZGV4IiwgIi0xIiApCgkJCQkJCQkudHJpZ2dlciggInZtb3VzZW91dCIgKTsKCQkJCQl9KQoJCQkJCS5kZWxlZ2F0ZSggImxpOm5vdCgudWktZGlzYWJsZWQsIC51aS1saS1kaXZpZGVyKSIsICJjbGljayIsIGZ1bmN0aW9uKCBldmVudCApIHsKCgkJCQkJCS8vIGluZGV4IG9mIG9wdGlvbiB0YWcgdG8gYmUgc2VsZWN0ZWQKCQkJCQkJdmFyIG9sZEluZGV4ID0gc2VsZi5zZWxlY3RbIDAgXS5zZWxlY3RlZEluZGV4LAoJCQkJCQkJbmV3SW5kZXggPSBzZWxmLmxpc3QuZmluZCggImxpOm5vdCgudWktbGktZGl2aWRlcikiICkuaW5kZXgoIHRoaXMgKSwKCQkJCQkJCW9wdGlvbiA9IHNlbGYuX3NlbGVjdE9wdGlvbnMoKS5lcSggbmV3SW5kZXggKVsgMCBdOwoKCQkJCQkJLy8gdG9nZ2xlIHNlbGVjdGVkIHN0YXR1cyBvbiB0aGUgdGFnIGZvciBtdWx0aSBzZWxlY3RzCgkJCQkJCW9wdGlvbi5zZWxlY3RlZCA9IHNlbGYuaXNNdWx0aXBsZSA/ICFvcHRpb24uc2VsZWN0ZWQgOiB0cnVlOwoKCQkJCQkJLy8gdG9nZ2xlIGNoZWNrYm94IGNsYXNzIGZvciBtdWx0aXBsZSBzZWxlY3RzCgkJCQkJCWlmICggc2VsZi5pc011bHRpcGxlICkgewoJCQkJCQkJJCggdGhpcyApLmZpbmQoICIudWktaWNvbiIgKQoJCQkJCQkJCS50b2dnbGVDbGFzcyggInVpLWljb24tY2hlY2tib3gtb24iLCBvcHRpb24uc2VsZWN0ZWQgKQoJCQkJCQkJCS50b2dnbGVDbGFzcyggInVpLWljb24tY2hlY2tib3gtb2ZmIiwgIW9wdGlvbi5zZWxlY3RlZCApOwoJCQkJCQl9CgoJCQkJCQkvLyB0cmlnZ2VyIGNoYW5nZSBpZiB2YWx1ZSBjaGFuZ2VkCgkJCQkJCWlmICggc2VsZi5pc011bHRpcGxlIHx8IG9sZEluZGV4ICE9PSBuZXdJbmRleCApIHsKCQkJCQkJCXNlbGYuc2VsZWN0LnRyaWdnZXIoICJjaGFuZ2UiICk7CgkJCQkJCX0KCgkJCQkJCS8vIGhpZGUgY3VzdG9tIHNlbGVjdCBmb3Igc2luZ2xlIHNlbGVjdHMgb25seSAtIG90aGVyd2lzZSBmb2N1cyBjbGlja2VkIGl0ZW0KCQkJCQkJLy8gV2UgbmVlZCB0byBncmFiIHRoZSBjbGlja2VkIGl0ZW0gdGhlIGhhcmQgd2F5LCBiZWNhdXNlIHRoZSBsaXN0IG1heSBoYXZlIGJlZW4gcmVidWlsdAoJCQkJCQlpZiAoIHNlbGYuaXNNdWx0aXBsZSApIHsKCQkJCQkJCXNlbGYubGlzdC5maW5kKCAibGk6bm90KC51aS1saS1kaXZpZGVyKSIgKS5lcSggbmV3SW5kZXggKQoJCQkJCQkJCS5hZGRDbGFzcyggInVpLWJ0bi1kb3duLSIgKyB3aWRnZXQub3B0aW9ucy50aGVtZSApLmZpbmQoICJhIiApLmZpcnN0KCkuZm9jdXMoKTsKCQkJCQkJfQoJCQkJCQllbHNlIHsKCQkJCQkJCXNlbGYuY2xvc2UoKTsKCQkJCQkJfQoKCQkJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCQl9KQoJCQkJCS5rZXlkb3duKGZ1bmN0aW9uKCBldmVudCApIHsgIC8va2V5Ym9hcmQgZXZlbnRzIGZvciBtZW51IGl0ZW1zCgkJCQkJCXZhciB0YXJnZXQgPSAkKCBldmVudC50YXJnZXQgKSwKCQkJCQkJCWxpID0gdGFyZ2V0LmNsb3Nlc3QoICJsaSIgKSwKCQkJCQkJCXByZXYsIG5leHQ7CgoJCQkJCQkvLyBzd2l0Y2ggbG9naWMgYmFzZWQgb24gd2hpY2gga2V5IHdhcyBwcmVzc2VkCgkJCQkJCXN3aXRjaCAoIGV2ZW50LmtleUNvZGUgKSB7CgkJCQkJCQkvLyB1cCBvciBsZWZ0IGFycm93IGtleXMKCQkJCQkJY2FzZSAzODoKCQkJCQkJCXByZXYgPSBsaS5wcmV2KCkubm90KCAiLnVpLXNlbGVjdG1lbnUtcGxhY2Vob2xkZXIiICk7CgoJCQkJCQkJaWYgKCBwcmV2LmlzKCAiLnVpLWxpLWRpdmlkZXIiICkgKSB7CgkJCQkJCQkJcHJldiA9IHByZXYucHJldigpOwoJCQkJCQkJfQoKCQkJCQkJCS8vIGlmIHRoZXJlJ3MgYSBwcmV2aW91cyBvcHRpb24sIGZvY3VzIGl0CgkJCQkJCQlpZiAoIHByZXYubGVuZ3RoICkgewoJCQkJCQkJCXRhcmdldAoJCQkJCQkJCQkuYmx1cigpCgkJCQkJCQkJCS5hdHRyKCAidGFiaW5kZXgiLCAiLTEiICk7CgoJCQkJCQkJCXByZXYuYWRkQ2xhc3MoICJ1aS1idG4tZG93bi0iICsgd2lkZ2V0Lm9wdGlvbnMudGhlbWUgKS5maW5kKCAiYSIgKS5maXJzdCgpLmZvY3VzKCk7CgkJCQkJCQl9CgoJCQkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJCQkJLy8gZG93biBvciByaWdodCBhcnJvdyBrZXlzCgkJCQkJCWNhc2UgNDA6CgkJCQkJCQluZXh0ID0gbGkubmV4dCgpOwoKCQkJCQkJCWlmICggbmV4dC5pcyggIi51aS1saS1kaXZpZGVyIiApICkgewoJCQkJCQkJCW5leHQgPSBuZXh0Lm5leHQoKTsKCQkJCQkJCX0KCgkJCQkJCQkvLyBpZiB0aGVyZSdzIGEgbmV4dCBvcHRpb24sIGZvY3VzIGl0CgkJCQkJCQlpZiAoIG5leHQubGVuZ3RoICkgewoJCQkJCQkJCXRhcmdldAoJCQkJCQkJCQkuYmx1cigpCgkJCQkJCQkJCS5hdHRyKCAidGFiaW5kZXgiLCAiLTEiICk7CgoJCQkJCQkJCW5leHQuYWRkQ2xhc3MoICJ1aS1idG4tZG93bi0iICsgd2lkZ2V0Lm9wdGlvbnMudGhlbWUgKS5maW5kKCAiYSIgKS5maXJzdCgpLmZvY3VzKCk7CgkJCQkJCQl9CgoJCQkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJCQkJLy8gSWYgZW50ZXIgb3Igc3BhY2UgaXMgcHJlc3NlZCwgdHJpZ2dlciBjbGljawoJCQkJCQljYXNlIDEzOgoJCQkJCQljYXNlIDMyOgoJCQkJCQkJdGFyZ2V0LnRyaWdnZXIoICJjbGljayIgKTsKCgkJCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQkJCX0KCQkJCQl9KTsKCgkJCQkvLyBidXR0b24gcmVmb2N1cyBlbnN1cmVzIHByb3BlciBoZWlnaHQgY2FsY3VsYXRpb24KCQkJCS8vIGJ5IHJlbW92aW5nIHRoZSBpbmxpbmUgc3R5bGUgYW5kIGVuc3VyaW5nIHBhZ2UgaW5jbHVzaW9uCgkJCQlzZWxmLm1lbnVQYWdlLmJpbmQoICJwYWdlaGlkZSIsIGZ1bmN0aW9uKCkgewoJCQkJCXNlbGYubGlzdC5hcHBlbmRUbyggc2VsZi5saXN0Ym94ICk7CgkJCQkJc2VsZi5fZm9jdXNCdXR0b24oKTsKCgkJCQkJLy8gVE9ETyBjZW50cmFsaXplIHBhZ2UgcmVtb3ZhbCBiaW5kaW5nIC8gaGFuZGxpbmcgaW4gdGhlIHBhZ2UgcGx1Z2luLgoJCQkJCS8vIFN1Z2dlc3Rpb24gZnJvbSBAamJsYXMgdG8gZG8gcmVmY291bnRpbmcKCQkJCQkvLwoJCQkJCS8vIFRPRE8gZXh0cmVtZWx5IGNvbmZ1c2luZyBkZXBlbmRlbmN5IG9uIHRoZSBvcGVuIG1ldGhvZCB3aGVyZSB0aGUgcGFnZWhpZGUucmVtb3ZlCgkJCQkJLy8gYmluZGluZ3MgYXJlIHN0cmlwcGVkIHRvIHByZXZlbnQgdGhlIHBhcmVudCBwYWdlIGZyb20gZGlzYXBwZWFyaW5nLiBUaGUgd2F5CgkJCQkJLy8gd2UncmUga2VlcGluZyBwYWdlcyBpbiB0aGUgRE9NIHJpZ2h0IG5vdyBzdWNrcwoJCQkJCS8vCgkJCQkJLy8gcmViaW5kIHRoZSBwYWdlIHJlbW92ZSB0aGF0IHdhcyB1bmJvdW5kIGluIHRoZSBvcGVuIGZ1bmN0aW9uCgkJCQkJLy8gdG8gYWxsb3cgZm9yIHRoZSBwYXJlbnQgcGFnZSByZW1vdmFsIGZyb20gYWN0aW9ucyBvdGhlciB0aGFuIHRoZSB1c2UKCQkJCQkvLyBvZiBhIGRpYWxvZyBzaXplZCBjdXN0b20gc2VsZWN0CgkJCQkJLy8KCQkJCQkvLyBkb2luZyB0aGlzIGhlcmUgcHJvdmlkZXMgZm9yIHRoZSBiYWNrIGJ1dHRvbiBvbiB0aGUgY3VzdG9tIHNlbGVjdCBkaWFsb2cKCQkJCQkkLm1vYmlsZS5fYmluZFBhZ2VSZW1vdmUuY2FsbCggc2VsZi50aGlzUGFnZSApOwoJCQkJfSk7CgoJCQkJLy8gRXZlbnRzIG9uIHRoZSBwb3B1cAoJCQkJc2VsZi5saXN0Ym94LmJpbmQoICJwb3B1cGFmdGVyY2xvc2UiLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkJc2VsZi5jbG9zZSgpOwoJCQkJfSk7CgoJCQkJLy8gQ2xvc2UgYnV0dG9uIG9uIHNtYWxsIG92ZXJsYXlzCgkJCQlpZiAoIHNlbGYuaXNNdWx0aXBsZSApIHsKCQkJCQlzZWxmLmhlYWRlckNsb3NlLmNsaWNrKGZ1bmN0aW9uKCkgewoJCQkJCQlpZiAoIHNlbGYubWVudVR5cGUgPT09ICJvdmVybGF5IiApIHsKCQkJCQkJCXNlbGYuY2xvc2UoKTsKCQkJCQkJCXJldHVybiBmYWxzZTsKCQkJCQkJfQoJCQkJCX0pOwoJCQkJfQoKCQkJCS8vIHRyYWNrIHRoaXMgZGVwZW5kZW5jeSBzbyB0aGF0IHdoZW4gdGhlIHBhcmVudCBwYWdlCgkJCQkvLyBpcyByZW1vdmVkIG9uIHBhZ2VoaWRlIGl0IHdpbGwgYWxzbyByZW1vdmUgdGhlIG1lbnVwYWdlCgkJCQlzZWxmLnRoaXNQYWdlLmFkZERlcGVuZGVudHMoIHRoaXMubWVudVBhZ2UgKTsKCQkJfSwKCgkJCV9pc1JlYnVpbGRSZXF1aXJlZDogZnVuY3Rpb24oKSB7CgkJCQl2YXIgbGlzdCA9IHRoaXMubGlzdC5maW5kKCAibGkiICksCgkJCQkJb3B0aW9ucyA9IHRoaXMuX3NlbGVjdE9wdGlvbnMoKTsKCgkJCQkvLyBUT0RPIGV4Y2VlZGluZ2x5IG5haXZlIG1ldGhvZCB0byBkZXRlcm1pbmUgZGlmZmVyZW5jZQoJCQkJLy8gaWdub3JlcyB2YWx1ZSBjaGFuZ2VzIGV0YyBpbiBmYXZvciBvZiBhIGZvcmNlZFJlYnVpbGQKCQkJCS8vIGZyb20gdGhlIHVzZXIgaW4gdGhlIHJlZnJlc2ggbWV0aG9kCgkJCQlyZXR1cm4gb3B0aW9ucy50ZXh0KCkgIT09IGxpc3QudGV4dCgpOwoJCQl9LAoKCQkJc2VsZWN0ZWQ6IGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuIHRoaXMuX3NlbGVjdE9wdGlvbnMoKS5maWx0ZXIoICI6c2VsZWN0ZWQ6bm90KCA6anFtRGF0YShwbGFjZWhvbGRlcj0ndHJ1ZScpICkiICk7CgkJCX0sCgoJCQlyZWZyZXNoOiBmdW5jdGlvbiggZm9yY2VSZWJ1aWxkICwgZm9vICkgewoJCQkJdmFyIHNlbGYgPSB0aGlzLAoJCQkJc2VsZWN0ID0gdGhpcy5lbGVtZW50LAoJCQkJaXNNdWx0aXBsZSA9IHRoaXMuaXNNdWx0aXBsZSwKCQkJCWluZGljaWVzOwoKCQkJCWlmICggIGZvcmNlUmVidWlsZCB8fCB0aGlzLl9pc1JlYnVpbGRSZXF1aXJlZCgpICkgewoJCQkJCXNlbGYuX2J1aWxkTGlzdCgpOwoJCQkJfQoKCQkJCWluZGljaWVzID0gdGhpcy5zZWxlY3RlZEluZGljZXMoKTsKCgkJCQlzZWxmLnNldEJ1dHRvblRleHQoKTsKCQkJCXNlbGYuc2V0QnV0dG9uQ291bnQoKTsKCgkJCQlzZWxmLmxpc3QuZmluZCggImxpOm5vdCgudWktbGktZGl2aWRlcikiICkKCQkJCQkucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICkKCQkJCQkuYXR0ciggImFyaWEtc2VsZWN0ZWQiLCBmYWxzZSApCgkJCQkJLmVhY2goZnVuY3Rpb24oIGkgKSB7CgoJCQkJCQlpZiAoICQuaW5BcnJheSggaSwgaW5kaWNpZXMgKSA+IC0xICkgewoJCQkJCQkJdmFyIGl0ZW0gPSAkKCB0aGlzICk7CgoJCQkJCQkJLy8gQXJpYSBzZWxlY3RlZCBhdHRyCgkJCQkJCQlpdGVtLmF0dHIoICJhcmlhLXNlbGVjdGVkIiwgdHJ1ZSApOwoKCQkJCQkJCS8vIE11bHRpcGxlIHNlbGVjdHM6IGFkZCB0aGUgIm9uIiBjaGVja2JveCBzdGF0ZSB0byB0aGUgaWNvbgoJCQkJCQkJaWYgKCBzZWxmLmlzTXVsdGlwbGUgKSB7CgkJCQkJCQkJaXRlbS5maW5kKCAiLnVpLWljb24iICkucmVtb3ZlQ2xhc3MoICJ1aS1pY29uLWNoZWNrYm94LW9mZiIgKS5hZGRDbGFzcyggInVpLWljb24tY2hlY2tib3gtb24iICk7CgkJCQkJCQl9IGVsc2UgewoJCQkJCQkJCWlmICggaXRlbS5pcyggIi51aS1zZWxlY3RtZW51LXBsYWNlaG9sZGVyIiApICkgewoJCQkJCQkJCQlpdGVtLm5leHQoKS5hZGRDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJCQkJCQl9IGVsc2UgewoJCQkJCQkJCQlpdGVtLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQkJCQkJCX0KCQkJCQkJCX0KCQkJCQkJfQoJCQkJCX0pOwoJCQl9LAoKCQkJY2xvc2U6IGZ1bmN0aW9uKCkgewoJCQkJaWYgKCB0aGlzLm9wdGlvbnMuZGlzYWJsZWQgfHwgIXRoaXMuaXNPcGVuICkgewoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQl2YXIgc2VsZiA9IHRoaXM7CgoJCQkJaWYgKCBzZWxmLm1lbnVUeXBlID09PSAicGFnZSIgKSB7CgkJCQkJLy8gZG9lc24ndCBzb2x2ZSB0aGUgcG9zc2libGUgaXNzdWUgd2l0aCBjYWxsaW5nIGNoYW5nZSBwYWdlCgkJCQkJLy8gd2hlcmUgdGhlIG9iamVjdHMgZG9uJ3QgZGVmaW5lIGRhdGEgdXJscyB3aGljaCBwcmV2ZW50cyBkaWFsb2cga2V5CgkJCQkJLy8gc3RyaXBwaW5nIC0gY2hhbmdlUGFnZSBoYXMgaW5jb21pbmcgcmVmYWN0b3IKCQkJCQkkLm1vYmlsZS5iYWNrKCk7CgkJCQl9IGVsc2UgewoJCQkJCXNlbGYubGlzdGJveC5wb3B1cCggImNsb3NlIiApOwoJCQkJCXNlbGYubGlzdC5hcHBlbmRUbyggc2VsZi5saXN0Ym94ICk7CgkJCQkJc2VsZi5fZm9jdXNCdXR0b24oKTsKCQkJCX0KCgkJCQkvLyBhbGxvdyB0aGUgZGlhbG9nIHRvIGJlIGNsb3NlZCBhZ2FpbgoJCQkJc2VsZi5pc09wZW4gPSBmYWxzZTsKCQkJfSwKCgkJCW9wZW46IGZ1bmN0aW9uKCkgewoJCQkJaWYgKCB0aGlzLm9wdGlvbnMuZGlzYWJsZWQgKSB7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCXZhciBzZWxmID0gdGhpcywKCQkJCQkkd2luZG93ID0gJCggd2luZG93ICksCgkJCQkJc2VsZkxpc3RQYXJlbnQgPSBzZWxmLmxpc3QucGFyZW50KCksCgkJCQkJbWVudUhlaWdodCA9IHNlbGZMaXN0UGFyZW50Lm91dGVySGVpZ2h0KCksCgkJCQkJbWVudVdpZHRoID0gc2VsZkxpc3RQYXJlbnQub3V0ZXJXaWR0aCgpLAoJCQkJCWFjdGl2ZVBhZ2UgPSAkKCAiLiIgKyAkLm1vYmlsZS5hY3RpdmVQYWdlQ2xhc3MgKSwKCQkJCQlzY3JvbGxUb3AgPSAkd2luZG93LnNjcm9sbFRvcCgpLAoJCQkJCWJ0bk9mZnNldCA9IHNlbGYuYnV0dG9uLm9mZnNldCgpLnRvcCwKCQkJCQlzY3JlZW5IZWlnaHQgPSAkd2luZG93LmhlaWdodCgpLAoJCQkJCXNjcmVlbldpZHRoID0gJHdpbmRvdy53aWR0aCgpOwoKCQkJCS8vYWRkIGFjdGl2ZSBjbGFzcyB0byBidXR0b24KCQkJCXNlbGYuYnV0dG9uLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoKCQkJCS8vcmVtb3ZlIGFmdGVyIGRlbGF5CgkJCQlzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJCQlzZWxmLmJ1dHRvbi5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJCX0sIDMwMCk7CgoJCQkJZnVuY3Rpb24gZm9jdXNNZW51SXRlbSgpIHsKCQkJCQl2YXIgc2VsZWN0b3IgPSBzZWxmLmxpc3QuZmluZCggIi4iICsgJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKyAiIGEiICk7CgkJCQkJaWYgKCBzZWxlY3Rvci5sZW5ndGggPT09IDAgKSB7CgkJCQkJCXNlbGVjdG9yID0gc2VsZi5saXN0LmZpbmQoICJsaS51aS1idG46bm90KCA6anFtRGF0YShwbGFjZWhvbGRlcj0ndHJ1ZScpICkgYSIgKTsKCQkJCQl9CgkJCQkJc2VsZWN0b3IuZmlyc3QoKS5mb2N1cygpLmNsb3Nlc3QoICJsaSIgKS5hZGRDbGFzcyggInVpLWJ0bi1kb3duLSIgKyB3aWRnZXQub3B0aW9ucy50aGVtZSApOwoJCQkJfQoKCQkJCWlmICggbWVudUhlaWdodCA+IHNjcmVlbkhlaWdodCAtIDgwIHx8ICEkLnN1cHBvcnQuc2Nyb2xsVG9wICkgewoKCQkJCQlzZWxmLm1lbnVQYWdlLmFwcGVuZFRvKCAkLm1vYmlsZS5wYWdlQ29udGFpbmVyICkucGFnZSgpOwoJCQkJCXNlbGYubWVudVBhZ2VDb250ZW50ID0gbWVudVBhZ2UuZmluZCggIi51aS1jb250ZW50IiApOwoJCQkJCXNlbGYubWVudVBhZ2VDbG9zZSA9IG1lbnVQYWdlLmZpbmQoICIudWktaGVhZGVyIGEiICk7CgoJCQkJCS8vIHByZXZlbnQgdGhlIHBhcmVudCBwYWdlIGZyb20gYmVpbmcgcmVtb3ZlZCBmcm9tIHRoZSBET00sCgkJCQkJLy8gb3RoZXJ3aXNlIHRoZSByZXN1bHRzIG9mIHNlbGVjdGluZyBhIGxpc3QgaXRlbSBpbiB0aGUgZGlhbG9nCgkJCQkJLy8gZmFsbCBpbnRvIGEgYmxhY2sgaG9sZQoJCQkJCXNlbGYudGhpc1BhZ2UudW5iaW5kKCAicGFnZWhpZGUucmVtb3ZlIiApOwoKCQkJCQkvL2ZvciBXZWJPUy9PcGVyYSBNaW5pIChzZXQgbGFzdHNjcm9sbCB1c2luZyBidXR0b24gb2Zmc2V0KQoJCQkJCWlmICggc2Nyb2xsVG9wID09PSAwICYmIGJ0bk9mZnNldCA+IHNjcmVlbkhlaWdodCApIHsKCQkJCQkJc2VsZi50aGlzUGFnZS5vbmUoICJwYWdlaGlkZSIsIGZ1bmN0aW9uKCkgewoJCQkJCQkJJCggdGhpcyApLmpxbURhdGEoICJsYXN0U2Nyb2xsIiwgYnRuT2Zmc2V0ICk7CgkJCQkJCX0pOwoJCQkJCX0KCgkJCQkJc2VsZi5tZW51UGFnZS5vbmUoICJwYWdlc2hvdyIsIGZ1bmN0aW9uKCkgewoJCQkJCQlmb2N1c01lbnVJdGVtKCk7CgkJCQkJCXNlbGYuaXNPcGVuID0gdHJ1ZTsKCQkJCQl9KTsKCgkJCQkJc2VsZi5tZW51VHlwZSA9ICJwYWdlIjsKCQkJCQlzZWxmLm1lbnVQYWdlQ29udGVudC5hcHBlbmQoIHNlbGYubGlzdCApOwoJCQkJCXNlbGYubWVudVBhZ2UuZmluZCgiZGl2IC51aS10aXRsZSIpLnRleHQoc2VsZi5sYWJlbC50ZXh0KCkpOwoJCQkJCSQubW9iaWxlLmNoYW5nZVBhZ2UoIHNlbGYubWVudVBhZ2UsIHsKCQkJCQkJdHJhbnNpdGlvbjogJC5tb2JpbGUuZGVmYXVsdERpYWxvZ1RyYW5zaXRpb24KCQkJCQl9KTsKCQkJCX0gZWxzZSB7CgkJCQkJc2VsZi5tZW51VHlwZSA9ICJvdmVybGF5IjsKCgkJCQkJc2VsZi5saXN0Ym94CgkJCQkJCS5vbmUoICJwb3B1cGFmdGVyb3BlbiIsIGZvY3VzTWVudUl0ZW0gKQoJCQkJCQkucG9wdXAoICJvcGVuIiwgewoJCQkJCQkJeDogc2VsZi5idXR0b24ub2Zmc2V0KCkubGVmdCArIHNlbGYuYnV0dG9uLm91dGVyV2lkdGgoKSAvIDIsCgkJCQkJCQl5OiBzZWxmLmJ1dHRvbi5vZmZzZXQoKS50b3AgKyBzZWxmLmJ1dHRvbi5vdXRlckhlaWdodCgpIC8gMgoJCQkJCQl9KTsKCgkJCQkJLy8gZHVwbGljYXRlIHdpdGggdmFsdWUgc2V0IGluIHBhZ2Ugc2hvdyBmb3IgZGlhbG9nIHNpemVkIHNlbGVjdHMKCQkJCQlzZWxmLmlzT3BlbiA9IHRydWU7CgkJCQl9CgkJCX0sCgoJCQlfYnVpbGRMaXN0OiBmdW5jdGlvbigpIHsKCQkJCXZhciBzZWxmID0gdGhpcywKCQkJCQlvID0gdGhpcy5vcHRpb25zLAoJCQkJCXBsYWNlaG9sZGVyID0gdGhpcy5wbGFjZWhvbGRlciwKCQkJCQluZWVkUGxhY2Vob2xkZXIgPSB0cnVlLAoJCQkJCW9wdGdyb3VwcyA9IFtdLAoJCQkJCWxpcyA9IFtdLAoJCQkJCWRhdGFJY29uID0gc2VsZi5pc011bHRpcGxlID8gImNoZWNrYm94LW9mZiIgOiAiZmFsc2UiOwoKCQkJCXNlbGYubGlzdC5lbXB0eSgpLmZpbHRlciggIi51aS1saXN0dmlldyIgKS5saXN0dmlldyggImRlc3Ryb3kiICk7CgoJCQkJdmFyICRvcHRpb25zID0gc2VsZi5zZWxlY3QuZmluZCggIm9wdGlvbiIgKSwKCQkJCQludW1PcHRpb25zID0gJG9wdGlvbnMubGVuZ3RoLAoJCQkJCXNlbGVjdCA9IHRoaXMuc2VsZWN0WyAwIF0sCgkJCQkJZGF0YVByZWZpeCA9ICdkYXRhLScgKyAkLm1vYmlsZS5ucywKCQkJCQlkYXRhSW5kZXhBdHRyID0gZGF0YVByZWZpeCArICdvcHRpb24taW5kZXgnLAoJCQkJCWRhdGFJY29uQXR0ciA9IGRhdGFQcmVmaXggKyAnaWNvbicsCgkJCQkJZGF0YVJvbGVBdHRyID0gZGF0YVByZWZpeCArICdyb2xlJywKCQkJCQlkYXRhUGxhY2Vob2xkZXJBdHRyID0gZGF0YVByZWZpeCArICdwbGFjZWhvbGRlcicsCgkJCQkJZnJhZ21lbnQgPSBkb2N1bWVudC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCksCgkJCQkJaXNQbGFjZWhvbGRlckl0ZW0gPSBmYWxzZSwKCQkJCQlvcHRHcm91cDsKCgkJCQlmb3IgKHZhciBpID0gMDsgaSA8IG51bU9wdGlvbnM7aSsrLCBpc1BsYWNlaG9sZGVySXRlbSA9IGZhbHNlKSB7CgkJCQkJdmFyIG9wdGlvbiA9ICRvcHRpb25zW2ldLAoJCQkJCQkkb3B0aW9uID0gJCggb3B0aW9uICksCgkJCQkJCXBhcmVudCA9IG9wdGlvbi5wYXJlbnROb2RlLAoJCQkJCQl0ZXh0ID0gJG9wdGlvbi50ZXh0KCksCgkJCQkJCWFuY2hvciAgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAnYScgKSwKCQkJCQkJY2xhc3NlcyA9IFtdOwoKCQkJCQlhbmNob3Iuc2V0QXR0cmlidXRlKCAnaHJlZicsICcjJyApOwoJCQkJCWFuY2hvci5hcHBlbmRDaGlsZCggZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoIHRleHQgKSApOwoKCQkJCQkvLyBBcmUgd2UgaW5zaWRlIGFuIG9wdGdyb3VwPwoJCQkJCWlmICggcGFyZW50ICE9PSBzZWxlY3QgJiYgcGFyZW50Lm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09ICJvcHRncm91cCIgKSB7CgkJCQkJCXZhciBvcHRMYWJlbCA9IHBhcmVudC5nZXRBdHRyaWJ1dGUoICdsYWJlbCcgKTsKCQkJCQkJaWYgKCBvcHRMYWJlbCAhPT0gb3B0R3JvdXAgKSB7CgkJCQkJCQl2YXIgZGl2aWRlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICdsaScgKTsKCQkJCQkJCWRpdmlkZXIuc2V0QXR0cmlidXRlKCBkYXRhUm9sZUF0dHIsICdsaXN0LWRpdmlkZXInICk7CgkJCQkJCQlkaXZpZGVyLnNldEF0dHJpYnV0ZSggJ3JvbGUnLCAnb3B0aW9uJyApOwoJCQkJCQkJZGl2aWRlci5zZXRBdHRyaWJ1dGUoICd0YWJpbmRleCcsICctMScgKTsKCQkJCQkJCWRpdmlkZXIuYXBwZW5kQ2hpbGQoIGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKCBvcHRMYWJlbCApICk7CgkJCQkJCQlmcmFnbWVudC5hcHBlbmRDaGlsZCggZGl2aWRlciApOwoJCQkJCQkJb3B0R3JvdXAgPSBvcHRMYWJlbDsKCQkJCQkJfQoJCQkJCX0KCgkJCQkJaWYgKCBuZWVkUGxhY2Vob2xkZXIgJiYgKCAhb3B0aW9uLmdldEF0dHJpYnV0ZSggInZhbHVlIiApIHx8IHRleHQubGVuZ3RoID09PSAwIHx8ICRvcHRpb24uanFtRGF0YSggInBsYWNlaG9sZGVyIiApICkgKSB7CgkJCQkJCW5lZWRQbGFjZWhvbGRlciA9IGZhbHNlOwoJCQkJCQlpc1BsYWNlaG9sZGVySXRlbSA9IHRydWU7CgoJCQkJCQkvLyBJZiB3ZSBoYXZlIGlkZW50aWZpZWQgYSBwbGFjZWhvbGRlciwgbWFyayBpdCByZXRyb2FjdGl2ZWx5IGluIHRoZSBzZWxlY3QgYXMgd2VsbAoJCQkJCQlvcHRpb24uc2V0QXR0cmlidXRlKCBkYXRhUGxhY2Vob2xkZXJBdHRyLCB0cnVlICk7CgkJCQkJCWlmICggby5oaWRlUGxhY2Vob2xkZXJNZW51SXRlbXMgKSB7CgkJCQkJCQljbGFzc2VzLnB1c2goICJ1aS1zZWxlY3RtZW51LXBsYWNlaG9sZGVyIiApOwoJCQkJCQl9CgkJCQkJCWlmICghcGxhY2Vob2xkZXIpIHsKCQkJCQkJCXBsYWNlaG9sZGVyID0gc2VsZi5wbGFjZWhvbGRlciA9IHRleHQ7CgkJCQkJCX0KCQkJCQl9CgoJCQkJCXZhciBpdGVtID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnbGknKTsKCQkJCQlpZiAoIG9wdGlvbi5kaXNhYmxlZCApIHsKCQkJCQkJY2xhc3Nlcy5wdXNoKCAidWktZGlzYWJsZWQiICk7CgkJCQkJCWl0ZW0uc2V0QXR0cmlidXRlKCdhcmlhLWRpc2FibGVkJyx0cnVlKTsKCQkJCQl9CgkJCQkJaXRlbS5zZXRBdHRyaWJ1dGUoIGRhdGFJbmRleEF0dHIsaSApOwoJCQkJCWl0ZW0uc2V0QXR0cmlidXRlKCBkYXRhSWNvbkF0dHIsIGRhdGFJY29uICk7CgkJCQkJaWYgKCBpc1BsYWNlaG9sZGVySXRlbSApIHsKCQkJCQkJaXRlbS5zZXRBdHRyaWJ1dGUoIGRhdGFQbGFjZWhvbGRlckF0dHIsIHRydWUgKTsKCQkJCQl9CgkJCQkJaXRlbS5jbGFzc05hbWUgPSBjbGFzc2VzLmpvaW4oICIgIiApOwoJCQkJCWl0ZW0uc2V0QXR0cmlidXRlKCAncm9sZScsICdvcHRpb24nICk7CgkJCQkJYW5jaG9yLnNldEF0dHJpYnV0ZSggJ3RhYmluZGV4JywgJy0xJyApOwoJCQkJCWl0ZW0uYXBwZW5kQ2hpbGQoIGFuY2hvciApOwoJCQkJCWZyYWdtZW50LmFwcGVuZENoaWxkKCBpdGVtICk7CgkJCQl9CgoJCQkJc2VsZi5saXN0WzBdLmFwcGVuZENoaWxkKCBmcmFnbWVudCApOwoKCQkJCS8vIEhpZGUgaGVhZGVyIGlmIGl0J3Mgbm90IGEgbXVsdGlzZWxlY3QgYW5kIHRoZXJlJ3Mgbm8gcGxhY2Vob2xkZXIKCQkJCWlmICggIXRoaXMuaXNNdWx0aXBsZSAmJiAhcGxhY2Vob2xkZXIubGVuZ3RoICkgewoJCQkJCXRoaXMuaGVhZGVyLmhpZGUoKTsKCQkJCX0gZWxzZSB7CgkJCQkJdGhpcy5oZWFkZXJUaXRsZS50ZXh0KCB0aGlzLnBsYWNlaG9sZGVyICk7CgkJCQl9CgoJCQkJLy8gTm93IHBvcHVsYXRlZCwgY3JlYXRlIGxpc3R2aWV3CgkJCQlzZWxmLmxpc3QubGlzdHZpZXcoKTsKCQkJfSwKCgkJCV9idXR0b246IGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuICQoICI8YT4iLCB7CgkJCQkJImhyZWYiOiAiIyIsCgkJCQkJInJvbGUiOiAiYnV0dG9uIiwKCQkJCQkvLyBUT0RPIHZhbHVlIGlzIHVuZGVmaW5lZCBhdCBjcmVhdGlvbgoJCQkJCSJpZCI6IHRoaXMuYnV0dG9uSWQsCgkJCQkJImFyaWEtaGFzcG9wdXAiOiAidHJ1ZSIsCgoJCQkJCS8vIFRPRE8gdmFsdWUgaXMgdW5kZWZpbmVkIGF0IGNyZWF0aW9uCgkJCQkJImFyaWEtb3ducyI6IHRoaXMubWVudUlkCgkJCQl9KTsKCQkJfQoJCX0pOwoJfTsKCgkvLyBpc3N1ZSAjMzg5NCAtIGNvcmUgZG9lc24ndCB0cmlnZ2VyIGV2ZW50cyBvbiBkaXNhYmxlZCBkZWxlZ2F0ZXMKCSQoIGRvY3VtZW50ICkuYmluZCggInNlbGVjdG1lbnViZWZvcmVjcmVhdGUiLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJdmFyIHNlbGVjdG1lbnVXaWRnZXQgPSAkKCBldmVudC50YXJnZXQgKS5kYXRhKCAic2VsZWN0bWVudSIgKTsKCgkJaWYgKCAhc2VsZWN0bWVudVdpZGdldC5vcHRpb25zLm5hdGl2ZU1lbnUgJiYKCQkJCXNlbGVjdG1lbnVXaWRnZXQuZWxlbWVudC5wYXJlbnRzKCAiOmpxbURhdGEocm9sZT0ncG9wdXAnKSIgKS5sZW5ndGggPT09IDAgKSB7CgkJCWV4dGVuZFNlbGVjdCggc2VsZWN0bWVudVdpZGdldCApOwoJCX0KCX0pOwp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCgoJJC53aWRnZXQoICJtb2JpbGUuZml4ZWR0b29sYmFyIiwgJC5tb2JpbGUud2lkZ2V0LCB7CgkJb3B0aW9uczogewoJCQl2aXNpYmxlT25QYWdlU2hvdzogdHJ1ZSwKCQkJZGlzYWJsZVBhZ2Vab29tOiB0cnVlLAoJCQl0cmFuc2l0aW9uOiAic2xpZGUiLCAvL2NhbiBiZSBub25lLCBmYWRlLCBzbGlkZSAoc2xpZGUgbWFwcyB0byBzbGlkZXVwIG9yIHNsaWRlZG93bikKCQkJZnVsbHNjcmVlbjogZmFsc2UsCgkJCXRhcFRvZ2dsZTogdHJ1ZSwKCQkJdGFwVG9nZ2xlQmxhY2tsaXN0OiAiYSwgYnV0dG9uLCBpbnB1dCwgc2VsZWN0LCB0ZXh0YXJlYSwgLnVpLWhlYWRlci1maXhlZCwgLnVpLWZvb3Rlci1maXhlZCwgLnVpLXBvcHVwIiwKCQkJaGlkZUR1cmluZ0ZvY3VzOiAiaW5wdXQsIHRleHRhcmVhLCBzZWxlY3QiLAoJCQl1cGRhdGVQYWdlUGFkZGluZzogdHJ1ZSwKCQkJdHJhY2tQZXJzaXN0ZW50VG9vbGJhcnM6IHRydWUsCgoJCQkvLyBCcm93c2VyIGRldGVjdGlvbiEgV2VlZWUsIGhlcmUgd2UgZ28uLi4KCQkJLy8gVW5mb3J0dW5hdGVseSwgcG9zaXRpb246Zml4ZWQgaXMgY29zdGx5LCBub3QgdG8gbWVudGlvbiBwcm9iYWJseSBpbXBvc3NpYmxlLCB0byBmZWF0dXJlLWRldGVjdCBhY2N1cmF0ZWx5LgoJCQkvLyBTb21lIHRlc3RzIGV4aXN0LCBidXQgdGhleSBjdXJyZW50bHkgcmV0dXJuIGZhbHNlIHJlc3VsdHMgaW4gY3JpdGljYWwgZGV2aWNlcyBhbmQgYnJvd3NlcnMsIHdoaWNoIGNvdWxkIGxlYWQgdG8gYSBicm9rZW4gZXhwZXJpZW5jZS4KCQkJLy8gVGVzdGluZyBmaXhlZCBwb3NpdGlvbmluZyBpcyBhbHNvIHByZXR0eSBvYnRydXNpdmUgdG8gcGFnZSBsb2FkLCByZXF1aXJpbmcgaW5qZWN0ZWQgZWxlbWVudHMgYW5kIHNjcm9sbGluZyB0aGUgd2luZG93CgkJCS8vIFRoZSBmb2xsb3dpbmcgZnVuY3Rpb24gc2VydmVzIHRvIHJ1bGUgb3V0IHNvbWUgcG9wdWxhciBicm93c2VycyB3aXRoIGtub3duIGZpeGVkLXBvc2l0aW9uaW5nIGlzc3VlcwoJCQkvLyBUaGlzIGlzIGEgcGx1Z2luIG9wdGlvbiBsaWtlIGFueSBvdGhlciwgc28gZmVlbCBmcmVlIHRvIGltcHJvdmUgb3Igb3ZlcndyaXRlIGl0CgkJCXN1cHBvcnRCbGFja2xpc3Q6IGZ1bmN0aW9uKCkgewoJCQkJdmFyIHcgPSB3aW5kb3csCgkJCQkJdWEgPSBuYXZpZ2F0b3IudXNlckFnZW50LAoJCQkJCXBsYXRmb3JtID0gbmF2aWdhdG9yLnBsYXRmb3JtLAoJCQkJCS8vIFJlbmRlcmluZyBlbmdpbmUgaXMgV2Via2l0LCBhbmQgY2FwdHVyZSBtYWpvciB2ZXJzaW9uCgkJCQkJd2ttYXRjaCA9IHVhLm1hdGNoKCAvQXBwbGVXZWJLaXRcLyhbMC05XSspLyApLAoJCQkJCXdrdmVyc2lvbiA9ICEhd2ttYXRjaCAmJiB3a21hdGNoWyAxIF0sCgkJCQkJZmZtYXRjaCA9IHVhLm1hdGNoKCAvRmVubmVjXC8oWzAtOV0rKS8gKSwKCQkJCQlmZnZlcnNpb24gPSAhIWZmbWF0Y2ggJiYgZmZtYXRjaFsgMSBdLAoJCQkJCW9wZXJhbW1vYmlsZW1hdGNoID0gdWEubWF0Y2goIC9PcGVyYSBNb2JpXC8oWzAtOV0rKS8gKSwKCQkJCQlvbXZlcnNpb24gPSAhIW9wZXJhbW1vYmlsZW1hdGNoICYmIG9wZXJhbW1vYmlsZW1hdGNoWyAxIF07CgoJCQkJaWYoCgkJCQkJLy8gaU9TIDQuMyBhbmQgb2xkZXIgOiBQbGF0Zm9ybSBpcyBpUGhvbmUvUGFkL1RvdWNoIGFuZCBXZWJraXQgdmVyc2lvbiBpcyBsZXNzIHRoYW4gNTM0IChpb3M1KQoJCQkJCSggKCBwbGF0Zm9ybS5pbmRleE9mKCAiaVBob25lIiApID4gLTEgfHwgcGxhdGZvcm0uaW5kZXhPZiggImlQYWQiICkgPiAtMSAgfHwgcGxhdGZvcm0uaW5kZXhPZiggImlQb2QiICkgPiAtMSApICYmIHdrdmVyc2lvbiAmJiB3a3ZlcnNpb24gPCA1MzQgKSB8fAoJCQkJCS8vIE9wZXJhIE1pbmkKCQkJCQkoIHcub3BlcmFtaW5pICYmICh7fSkudG9TdHJpbmcuY2FsbCggdy5vcGVyYW1pbmkgKSA9PT0gIltvYmplY3QgT3BlcmFNaW5pXSIgKSB8fAoJCQkJCSggb3BlcmFtbW9iaWxlbWF0Y2ggJiYgb212ZXJzaW9uIDwgNzQ1OCApCXx8CgkJCQkJLy9BbmRyb2lkIGx0ZSAyLjE6IFBsYXRmb3JtIGlzIEFuZHJvaWQgYW5kIFdlYmtpdCB2ZXJzaW9uIGlzIGxlc3MgdGhhbiA1MzMgKEFuZHJvaWQgMi4yKQoJCQkJCSggdWEuaW5kZXhPZiggIkFuZHJvaWQiICkgPiAtMSAmJiB3a3ZlcnNpb24gJiYgd2t2ZXJzaW9uIDwgNTMzICkgfHwKCQkJCQkvLyBGaXJlZm94IE1vYmlsZSBiZWZvcmUgNi4wIC0KCQkJCQkoIGZmdmVyc2lvbiAmJiBmZnZlcnNpb24gPCA2ICkgfHwKCQkJCQkvLyBXZWJPUyBsZXNzIHRoYW4gMwoJCQkJCSggInBhbG1HZXRSZXNvdXJjZSIgaW4gd2luZG93ICYmIHdrdmVyc2lvbiAmJiB3a3ZlcnNpb24gPCA1MzQgKQl8fAoJCQkJCS8vIE1lZUdvCgkJCQkJKCB1YS5pbmRleE9mKCAiTWVlR28iICkgPiAtMSAmJiB1YS5pbmRleE9mKCAiTm9raWFCcm93c2VyLzguNS4wIiApID4gLTEgKSApIHsKCQkJCQlyZXR1cm4gdHJ1ZTsKCQkJCX0KCgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0sCgkJCWluaXRTZWxlY3RvcjogIjpqcW1EYXRhKHBvc2l0aW9uPSdmaXhlZCcpIgoJCX0sCgoJCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoKCQkJdmFyIHNlbGYgPSB0aGlzLAoJCQkJbyA9IHNlbGYub3B0aW9ucywKCQkJCSRlbCA9IHNlbGYuZWxlbWVudCwKCQkJCXRidHlwZSA9ICRlbC5pcyggIjpqcW1EYXRhKHJvbGU9J2hlYWRlcicpIiApID8gImhlYWRlciIgOiAiZm9vdGVyIiwKCQkJCSRwYWdlID0gJGVsLmNsb3Nlc3QoICIudWktcGFnZSIgKTsKCgkJCS8vIEZlYXR1cmUgZGV0ZWN0aW5nIHN1cHBvcnQgZm9yCgkJCWlmICggby5zdXBwb3J0QmxhY2tsaXN0KCkgKSB7CgkJCQlzZWxmLmRlc3Ryb3koKTsKCQkJCXJldHVybjsKCQkJfQoKCQkJJGVsLmFkZENsYXNzKCAidWktIisgdGJ0eXBlICsiLWZpeGVkIiApOwoKCQkJLy8gImZ1bGxzY3JlZW4iIG92ZXJsYXkgcG9zaXRpb25pbmcKCQkJaWYgKCBvLmZ1bGxzY3JlZW4gKSB7CgkJCQkkZWwuYWRkQ2xhc3MoICJ1aS0iKyB0YnR5cGUgKyItZnVsbHNjcmVlbiIgKTsKCQkJCSRwYWdlLmFkZENsYXNzKCAidWktcGFnZS0iICsgdGJ0eXBlICsgIi1mdWxsc2NyZWVuIiApOwoJCQl9CgkJCS8vIElmIG5vdCBmdWxsc2NyZWVuLCBhZGQgY2xhc3MgdG8gcGFnZSB0byBzZXQgdG9wIG9yIGJvdHRvbSBwYWRkaW5nCgkJCWVsc2V7CgkJCQkkcGFnZS5hZGRDbGFzcyggInVpLXBhZ2UtIiArIHRidHlwZSArICItZml4ZWQiICk7CgkJCX0KCgkJCXNlbGYuX2FkZFRyYW5zaXRpb25DbGFzcygpOwoJCQlzZWxmLl9iaW5kUGFnZUV2ZW50cygpOwoJCQlzZWxmLl9iaW5kVG9nZ2xlSGFuZGxlcnMoKTsKCQl9LAoKCQlfYWRkVHJhbnNpdGlvbkNsYXNzOiBmdW5jdGlvbigpIHsKCQkJdmFyIHRjbGFzcyA9IHRoaXMub3B0aW9ucy50cmFuc2l0aW9uOwoKCQkJaWYgKCB0Y2xhc3MgJiYgdGNsYXNzICE9PSAibm9uZSIgKSB7CgkJCQkvLyB1c2UgYXBwcm9wcmlhdGUgc2xpZGUgZm9yIGhlYWRlciBvciBmb290ZXIKCQkJCWlmICggdGNsYXNzID09PSAic2xpZGUiICkgewoJCQkJCXRjbGFzcyA9IHRoaXMuZWxlbWVudC5pcyggIi51aS1oZWFkZXIiICkgPyAic2xpZGVkb3duIiA6ICJzbGlkZXVwIjsKCQkJCX0KCgkJCQl0aGlzLmVsZW1lbnQuYWRkQ2xhc3MoIHRjbGFzcyApOwoJCQl9CgkJfSwKCgkJX2JpbmRQYWdlRXZlbnRzOiBmdW5jdGlvbigpIHsKCQkJdmFyIHNlbGYgPSB0aGlzLAoJCQkJbyA9IHNlbGYub3B0aW9ucywKCQkJCSRlbCA9IHNlbGYuZWxlbWVudDsKCgkJCS8vcGFnZSBldmVudCBiaW5kaW5ncwoJCQkvLyBGaXhlZCB0b29sYmFycyByZXF1aXJlIHBhZ2Ugem9vbSB0byBiZSBkaXNhYmxlZCwgb3RoZXJ3aXNlIHVzYWJpbGl0eSBpc3N1ZXMgY3JvcCB1cAoJCQkvLyBUaGlzIG1ldGhvZCBpcyBtZWFudCB0byBkaXNhYmxlIHpvb20gd2hpbGUgYSBmaXhlZC1wb3NpdGlvbmVkIHRvb2xiYXIgcGFnZSBpcyB2aXNpYmxlCgkJCSRlbC5jbG9zZXN0KCAiLnVpLXBhZ2UiICkKCQkJCS5iaW5kKCAicGFnZWJlZm9yZXNob3ciLCBmdW5jdGlvbigpIHsKCQkJCQlpZiAoIG8uZGlzYWJsZVBhZ2Vab29tICkgewoJCQkJCQkkLm1vYmlsZS56b29tLmRpc2FibGUoIHRydWUgKTsKCQkJCQl9CgkJCQkJaWYgKCAhby52aXNpYmxlT25QYWdlU2hvdyApIHsKCQkJCQkJc2VsZi5oaWRlKCB0cnVlICk7CgkJCQkJfQoJCQkJfSApCgkJCQkuYmluZCggIndlYmtpdEFuaW1hdGlvblN0YXJ0IGFuaW1hdGlvbnN0YXJ0IHVwZGF0ZWxheW91dCIsIGZ1bmN0aW9uKCkgewoJCQkJCXZhciB0aGlzUGFnZSA9IHRoaXM7CgkJCQkJaWYgKCBvLnVwZGF0ZVBhZ2VQYWRkaW5nICkgewoJCQkJCQlzZWxmLnVwZGF0ZVBhZ2VQYWRkaW5nKCB0aGlzUGFnZSApOwoJCQkJCX0KCQkJCX0pCgkJCQkuYmluZCggInBhZ2VzaG93IiwgZnVuY3Rpb24oKSB7CgkJCQkJdmFyIHRoaXNQYWdlID0gdGhpczsKCQkJCQlzZWxmLnVwZGF0ZVBhZ2VQYWRkaW5nKCB0aGlzUGFnZSApOwoJCQkJCWlmICggby51cGRhdGVQYWdlUGFkZGluZyApIHsKCQkJCQkJJCggd2luZG93ICkuYmluZCggInRocm90dGxlZHJlc2l6ZS4iICsgc2VsZi53aWRnZXROYW1lLCBmdW5jdGlvbigpIHsKCQkJCQkJCXNlbGYudXBkYXRlUGFnZVBhZGRpbmcoIHRoaXNQYWdlICk7CgkJCQkJCX0pOwoJCQkJCX0KCQkJCX0pCgkJCQkuYmluZCggInBhZ2ViZWZvcmVoaWRlIiwgZnVuY3Rpb24oIGUsIHVpICkgewoJCQkJCWlmICggby5kaXNhYmxlUGFnZVpvb20gKSB7CgkJCQkJCSQubW9iaWxlLnpvb20uZW5hYmxlKCB0cnVlICk7CgkJCQkJfQoJCQkJCWlmICggby51cGRhdGVQYWdlUGFkZGluZyApIHsKCQkJCQkJJCggd2luZG93ICkudW5iaW5kKCAidGhyb3R0bGVkcmVzaXplLiIgKyBzZWxmLndpZGdldE5hbWUgKTsKCQkJCQl9CgoJCQkJCWlmICggby50cmFja1BlcnNpc3RlbnRUb29sYmFycyApIHsKCQkJCQkJdmFyIHRoaXNGb290ZXIgPSAkKCAiLnVpLWZvb3Rlci1maXhlZDpqcW1EYXRhKGlkKSIsIHRoaXMgKSwKCQkJCQkJCXRoaXNIZWFkZXIgPSAkKCAiLnVpLWhlYWRlci1maXhlZDpqcW1EYXRhKGlkKSIsIHRoaXMgKSwKCQkJCQkJCW5leHRGb290ZXIgPSB0aGlzRm9vdGVyLmxlbmd0aCAmJiB1aS5uZXh0UGFnZSAmJiAkKCAiLnVpLWZvb3Rlci1maXhlZDpqcW1EYXRhKGlkPSciICsgdGhpc0Zvb3Rlci5qcW1EYXRhKCAiaWQiICkgKyAiJykiLCB1aS5uZXh0UGFnZSApIHx8ICQoKSwKCQkJCQkJCW5leHRIZWFkZXIgPSB0aGlzSGVhZGVyLmxlbmd0aCAmJiB1aS5uZXh0UGFnZSAmJiAkKCAiLnVpLWhlYWRlci1maXhlZDpqcW1EYXRhKGlkPSciICsgdGhpc0hlYWRlci5qcW1EYXRhKCAiaWQiICkgKyAiJykiLCB1aS5uZXh0UGFnZSApIHx8ICQoKTsKCgkJCQkJCQlpZiAoIG5leHRGb290ZXIubGVuZ3RoIHx8IG5leHRIZWFkZXIubGVuZ3RoICkgewoKCQkJCQkJCQluZXh0Rm9vdGVyLmFkZCggbmV4dEhlYWRlciApLmFwcGVuZFRvKCAkLm1vYmlsZS5wYWdlQ29udGFpbmVyICk7CgoJCQkJCQkJCXVpLm5leHRQYWdlLm9uZSggInBhZ2VzaG93IiwgZnVuY3Rpb24oKSB7CgkJCQkJCQkJCW5leHRGb290ZXIuYWRkKCBuZXh0SGVhZGVyICkuYXBwZW5kVG8oIHRoaXMgKTsKCQkJCQkJCQl9KTsKCQkJCQkJCX0KCQkJCQl9CgkJCQl9KTsKCQl9LAoKCQlfdmlzaWJsZTogdHJ1ZSwKCgkJLy8gVGhpcyB3aWxsIHNldCB0aGUgY29udGVudCBlbGVtZW50J3MgdG9wIG9yIGJvdHRvbSBwYWRkaW5nIGVxdWFsIHRvIHRoZSB0b29sYmFyJ3MgaGVpZ2h0CgkJdXBkYXRlUGFnZVBhZGRpbmc6IGZ1bmN0aW9uKCB0YlBhZ2UgKSB7CgkJCXZhciAkZWwgPSB0aGlzLmVsZW1lbnQsCgkJCQloZWFkZXIgPSAkZWwuaXMoICIudWktaGVhZGVyIiApOwoKCQkJLy8gVGhpcyBiZWhhdmlvciBvbmx5IGFwcGxpZXMgdG8gImZpeGVkIiwgbm90ICJmdWxsc2NyZWVuIgoJCQlpZiAoIHRoaXMub3B0aW9ucy5mdWxsc2NyZWVuICkgeyByZXR1cm47IH0KCgkJCXRiUGFnZSA9IHRiUGFnZSB8fCAkZWwuY2xvc2VzdCggIi51aS1wYWdlIiApOwoJCQkkKCB0YlBhZ2UgKS5jc3MoICJwYWRkaW5nLSIgKyAoIGhlYWRlciA/ICJ0b3AiIDogImJvdHRvbSIgKSwgJGVsLm91dGVySGVpZ2h0KCkgKTsKCQl9LAoKCQlfdXNlVHJhbnNpdGlvbjogZnVuY3Rpb24oIG5vdHJhbnNpdGlvbiApIHsKCQkJdmFyICR3aW4gPSAkKCB3aW5kb3cgKSwKCQkJCSRlbCA9IHRoaXMuZWxlbWVudCwKCQkJCXNjcm9sbCA9ICR3aW4uc2Nyb2xsVG9wKCksCgkJCQllbEhlaWdodCA9ICRlbC5oZWlnaHQoKSwKCQkJCXBIZWlnaHQgPSAkZWwuY2xvc2VzdCggIi51aS1wYWdlIiApLmhlaWdodCgpLAoJCQkJdmlld3BvcnRIZWlnaHQgPSAkLm1vYmlsZS5nZXRTY3JlZW5IZWlnaHQoKSwKCQkJCXRidHlwZSA9ICRlbC5pcyggIjpqcW1EYXRhKHJvbGU9J2hlYWRlcicpIiApID8gImhlYWRlciIgOiAiZm9vdGVyIjsKCgkJCXJldHVybiAhbm90cmFuc2l0aW9uICYmCgkJCQkoIHRoaXMub3B0aW9ucy50cmFuc2l0aW9uICYmIHRoaXMub3B0aW9ucy50cmFuc2l0aW9uICE9PSAibm9uZSIgJiYKCQkJCSgKCQkJCQkoIHRidHlwZSA9PT0gImhlYWRlciIgJiYgIXRoaXMub3B0aW9ucy5mdWxsc2NyZWVuICYmIHNjcm9sbCA+IGVsSGVpZ2h0ICkgfHwKCQkJCQkoIHRidHlwZSA9PT0gImZvb3RlciIgJiYgIXRoaXMub3B0aW9ucy5mdWxsc2NyZWVuICYmIHNjcm9sbCArIHZpZXdwb3J0SGVpZ2h0IDwgcEhlaWdodCAtIGVsSGVpZ2h0ICkKCQkJCSkgfHwgdGhpcy5vcHRpb25zLmZ1bGxzY3JlZW4KCQkJCSk7CgkJfSwKCgkJc2hvdzogZnVuY3Rpb24oIG5vdHJhbnNpdGlvbiApIHsKCQkJdmFyIGhpZGVDbGFzcyA9ICJ1aS1maXhlZC1oaWRkZW4iLAoJCQkJJGVsID0gdGhpcy5lbGVtZW50OwoKCQkJaWYgKCB0aGlzLl91c2VUcmFuc2l0aW9uKCBub3RyYW5zaXRpb24gKSApIHsKCQkJCSRlbAoJCQkJCS5yZW1vdmVDbGFzcyggIm91dCAiICsgaGlkZUNsYXNzICkKCQkJCQkuYWRkQ2xhc3MoICJpbiIgKTsKCQkJfQoJCQllbHNlIHsKCQkJCSRlbC5yZW1vdmVDbGFzcyggaGlkZUNsYXNzICk7CgkJCX0KCQkJdGhpcy5fdmlzaWJsZSA9IHRydWU7CgkJfSwKCgkJaGlkZTogZnVuY3Rpb24oIG5vdHJhbnNpdGlvbiApIHsKCQkJdmFyIGhpZGVDbGFzcyA9ICJ1aS1maXhlZC1oaWRkZW4iLAoJCQkJJGVsID0gdGhpcy5lbGVtZW50LAoJCQkJLy8gaWYgaXQncyBhIHNsaWRlIHRyYW5zaXRpb24sIG91ciBuZXcgdHJhbnNpdGlvbnMgbmVlZCB0aGUgcmV2ZXJzZSBjbGFzcyBhcyB3ZWxsIHRvIHNsaWRlIG91dHdhcmQKCQkJCW91dGNsYXNzID0gIm91dCIgKyAoIHRoaXMub3B0aW9ucy50cmFuc2l0aW9uID09PSAic2xpZGUiID8gIiByZXZlcnNlIiA6ICIiICk7CgoJCQlpZiggdGhpcy5fdXNlVHJhbnNpdGlvbiggbm90cmFuc2l0aW9uICkgKSB7CgkJCQkkZWwKCQkJCQkuYWRkQ2xhc3MoIG91dGNsYXNzICkKCQkJCQkucmVtb3ZlQ2xhc3MoICJpbiIgKQoJCQkJCS5hbmltYXRpb25Db21wbGV0ZShmdW5jdGlvbigpIHsKCQkJCQkJJGVsLmFkZENsYXNzKCBoaWRlQ2xhc3MgKS5yZW1vdmVDbGFzcyggb3V0Y2xhc3MgKTsKCQkJCQl9KTsKCQkJfQoJCQllbHNlIHsKCQkJCSRlbC5hZGRDbGFzcyggaGlkZUNsYXNzICkucmVtb3ZlQ2xhc3MoIG91dGNsYXNzICk7CgkJCX0KCQkJdGhpcy5fdmlzaWJsZSA9IGZhbHNlOwoJCX0sCgoJCXRvZ2dsZTogZnVuY3Rpb24oKSB7CgkJCXRoaXNbIHRoaXMuX3Zpc2libGUgPyAiaGlkZSIgOiAic2hvdyIgXSgpOwoJCX0sCgoJCV9iaW5kVG9nZ2xlSGFuZGxlcnM6IGZ1bmN0aW9uKCkgewoJCQl2YXIgc2VsZiA9IHRoaXMsCgkJCQlvID0gc2VsZi5vcHRpb25zLAoJCQkJJGVsID0gc2VsZi5lbGVtZW50OwoKCQkJLy8gdGFwIHRvZ2dsZQoJCQkkZWwuY2xvc2VzdCggIi51aS1wYWdlIiApCgkJCQkuYmluZCggInZjbGljayIsIGZ1bmN0aW9uKCBlICkgewoJCQkJCWlmICggby50YXBUb2dnbGUgJiYgISQoIGUudGFyZ2V0ICkuY2xvc2VzdCggby50YXBUb2dnbGVCbGFja2xpc3QgKS5sZW5ndGggKSB7CgkJCQkJCXNlbGYudG9nZ2xlKCk7CgkJCQkJfQoJCQkJfSkKCQkJCS5iaW5kKCAiZm9jdXNpbiBmb2N1c291dCIsIGZ1bmN0aW9uKCBlICkgewoJCQkJCWlmICggc2NyZWVuLndpZHRoIDwgNTAwICYmICQoIGUudGFyZ2V0ICkuaXMoIG8uaGlkZUR1cmluZ0ZvY3VzICkgJiYgISQoIGUudGFyZ2V0ICkuY2xvc2VzdCggIi51aS1oZWFkZXItZml4ZWQsIC51aS1mb290ZXItZml4ZWQiICkubGVuZ3RoICkgewoJCQkJCQlzZWxmWyAoIGUudHlwZSA9PT0gImZvY3VzaW4iICYmIHNlbGYuX3Zpc2libGUgKSA/ICJoaWRlIiA6ICJzaG93IiBdKCk7CgkJCQkJfQoJCQkJfSk7CgkJfSwKCgkJZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJCXRoaXMuZWxlbWVudC5yZW1vdmVDbGFzcyggInVpLWhlYWRlci1maXhlZCB1aS1mb290ZXItZml4ZWQgdWktaGVhZGVyLWZ1bGxzY3JlZW4gdWktZm9vdGVyLWZ1bGxzY3JlZW4gaW4gb3V0IGZhZGUgc2xpZGVkb3duIHNsaWRldXAgdWktZml4ZWQtaGlkZGVuIiApOwoJCQl0aGlzLmVsZW1lbnQuY2xvc2VzdCggIi51aS1wYWdlIiApLnJlbW92ZUNsYXNzKCAidWktcGFnZS1oZWFkZXItZml4ZWQgdWktcGFnZS1mb290ZXItZml4ZWQgdWktcGFnZS1oZWFkZXItZnVsbHNjcmVlbiB1aS1wYWdlLWZvb3Rlci1mdWxsc2NyZWVuIiApOwoJCX0KCgl9KTsKCgkvL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKCSQoIGRvY3VtZW50ICkKCQkuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKSB7CgoJCQkvLyBERVBSRUNBVEVEIGluIDEuMTogc3VwcG9ydCBmb3IgZGF0YS1mdWxsc2NyZWVuPXRydWV8ZmFsc2Ugb24gdGhlIHBhZ2UgZWxlbWVudC4KCQkJLy8gVGhpcyBsaW5lIGVuc3VyZXMgaXQgc3RpbGwgd29ya3MsIGJ1dCB3ZSByZWNvbW1lbmQgbW92aW5nIHRoZSBhdHRyaWJ1dGUgdG8gdGhlIHRvb2xiYXJzIHRoZW1zZWx2ZXMuCgkJCWlmICggJCggZS50YXJnZXQgKS5qcW1EYXRhKCAiZnVsbHNjcmVlbiIgKSApIHsKCQkJCSQoICQubW9iaWxlLmZpeGVkdG9vbGJhci5wcm90b3R5cGUub3B0aW9ucy5pbml0U2VsZWN0b3IsIGUudGFyZ2V0ICkubm90KCAiOmpxbURhdGEoZnVsbHNjcmVlbikiICkuanFtRGF0YSggImZ1bGxzY3JlZW4iLCB0cnVlICk7CgkJCX0KCgkJCSQubW9iaWxlLmZpeGVkdG9vbGJhci5wcm90b3R5cGUuZW5oYW5jZVdpdGhpbiggZS50YXJnZXQgKTsKCQl9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgd2luZG93ICkgewoKCS8vIFRoaXMgZml4IGFkZHJlc3NlcyBhbiBpT1MgYnVnLCBzbyByZXR1cm4gZWFybHkgaWYgdGhlIFVBIGNsYWltcyBpdCdzIHNvbWV0aGluZyBlbHNlLgoJaWYgKCAhKC9pUGhvbmV8aVBhZHxpUG9kLy50ZXN0KCBuYXZpZ2F0b3IucGxhdGZvcm0gKSAmJiBuYXZpZ2F0b3IudXNlckFnZW50LmluZGV4T2YoICJBcHBsZVdlYktpdCIgKSA+IC0xICkgKSB7CgkJcmV0dXJuOwoJfQoKICB2YXIgem9vbSA9ICQubW9iaWxlLnpvb20sCgkJZXZ0LCB4LCB5LCB6LCBhaWc7CgogIGZ1bmN0aW9uIGNoZWNrVGlsdCggZSApIHsKCQlldnQgPSBlLm9yaWdpbmFsRXZlbnQ7CgkJYWlnID0gZXZ0LmFjY2VsZXJhdGlvbkluY2x1ZGluZ0dyYXZpdHk7CgoJCXggPSBNYXRoLmFicyggYWlnLnggKTsKCQl5ID0gTWF0aC5hYnMoIGFpZy55ICk7CgkJeiA9IE1hdGguYWJzKCBhaWcueiApOwoKCQkvLyBJZiBwb3J0cmFpdCBvcmllbnRhdGlvbiBhbmQgaW4gb25lIG9mIHRoZSBkYW5nZXIgem9uZXMKICAgIGlmICggIXdpbmRvdy5vcmllbnRhdGlvbiAmJiAoIHggPiA3IHx8ICggKCB6ID4gNiAmJiB5IDwgOCB8fCB6IDwgOCAmJiB5ID4gNiApICYmIHggPiA1ICkgKSApIHsKCQkJaWYgKCB6b29tLmVuYWJsZWQgKSB7CgkJCQl6b29tLmRpc2FibGUoKTsKCQkJfQogICAgfQllbHNlIGlmICggIXpvb20uZW5hYmxlZCApIHsKCQkJem9vbS5lbmFibGUoKTsKICAgIH0KICB9CgogICQoIHdpbmRvdyApCgkJLmJpbmQoICJvcmllbnRhdGlvbmNoYW5nZS5pb3NvcmllbnRhdGlvbmZpeCIsIHpvb20uZW5hYmxlICkKCQkuYmluZCggImRldmljZW1vdGlvbi5pb3NvcmllbnRhdGlvbmZpeCIsIGNoZWNrVGlsdCApOwoKfSggalF1ZXJ5LCB0aGlzICkpOwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCXZhcgkkaHRtbCA9ICQoICJodG1sIiApLAoJCQkkaGVhZCA9ICQoICJoZWFkIiApLAoJCQkkd2luZG93ID0gJCggd2luZG93ICk7CgoJLy9yZW1vdmUgaW5pdGlhbCBidWlsZCBjbGFzcyAob25seSBwcmVzZW50IG9uIGZpcnN0IHBhZ2VzaG93KQoJZnVuY3Rpb24gaGlkZVJlbmRlcmluZ0NsYXNzKCkgewoJCSRodG1sLnJlbW92ZUNsYXNzKCAidWktbW9iaWxlLXJlbmRlcmluZyIgKTsKCX0KCgkvLyB0cmlnZ2VyIG1vYmlsZWluaXQgZXZlbnQgLSB1c2VmdWwgaG9vayBmb3IgY29uZmlndXJpbmcgJC5tb2JpbGUgc2V0dGluZ3MgYmVmb3JlIHRoZXkncmUgdXNlZAoJJCggd2luZG93LmRvY3VtZW50ICkudHJpZ2dlciggIm1vYmlsZWluaXQiICk7CgoJLy8gc3VwcG9ydCBjb25kaXRpb25zCgkvLyBpZiBkZXZpY2Ugc3VwcG9ydCBjb25kaXRpb24ocykgYXJlbid0IG1ldCwgbGVhdmUgdGhpbmdzIGFzIHRoZXkgYXJlIC0+IGEgYmFzaWMsIHVzYWJsZSBleHBlcmllbmNlLAoJLy8gb3RoZXJ3aXNlLCBwcm9jZWVkIHdpdGggdGhlIGVuaGFuY2VtZW50cwoJaWYgKCAhJC5tb2JpbGUuZ3JhZGVBKCkgKSB7CgkJcmV0dXJuOwoJfQoKCS8vIG92ZXJyaWRlIGFqYXhFbmFibGVkIG9uIHBsYXRmb3JtcyB0aGF0IGhhdmUga25vd24gY29uZmxpY3RzIHdpdGggaGFzaCBoaXN0b3J5IHVwZGF0ZXMKCS8vIG9yIGdlbmVyYWxseSB3b3JrIGJldHRlciBicm93c2luZyBpbiByZWd1bGFyIGh0dHAgZm9yIGZ1bGwgcGFnZSByZWZyZXNoZXMgKEJCNSwgT3BlcmEgTWluaSkKCWlmICggJC5tb2JpbGUuYWpheEJsYWNrbGlzdCApIHsKCQkkLm1vYmlsZS5hamF4RW5hYmxlZCA9IGZhbHNlOwoJfQoKCS8vIEFkZCBtb2JpbGUsIGluaXRpYWwgbG9hZCAicmVuZGVyaW5nIiBjbGFzc2VzIHRvIGRvY0VsCgkkaHRtbC5hZGRDbGFzcyggInVpLW1vYmlsZSB1aS1tb2JpbGUtcmVuZGVyaW5nIiApOwoKCS8vIFRoaXMgaXMgYSBmYWxsYmFjay4gSWYgYW55dGhpbmcgZ29lcyB3cm9uZyAoSlMgZXJyb3JzLCBldGMpLCBvciBldmVudHMgZG9uJ3QgZmlyZSwKCS8vIHRoaXMgZW5zdXJlcyB0aGUgcmVuZGVyaW5nIGNsYXNzIGlzIHJlbW92ZWQgYWZ0ZXIgNSBzZWNvbmRzLCBzbyBjb250ZW50IGlzIHZpc2libGUgYW5kIGFjY2Vzc2libGUKCXNldFRpbWVvdXQoIGhpZGVSZW5kZXJpbmdDbGFzcywgNTAwMCApOwoKCSQuZXh0ZW5kKCAkLm1vYmlsZSwgewoJCS8vIGZpbmQgYW5kIGVuaGFuY2UgdGhlIHBhZ2VzIGluIHRoZSBkb20gYW5kIHRyYW5zaXRpb24gdG8gdGhlIGZpcnN0IHBhZ2UuCgkJaW5pdGlhbGl6ZVBhZ2U6IGZ1bmN0aW9uKCkgewoJCQkvLyBmaW5kIHByZXNlbnQgcGFnZXMKCQkJdmFyICRwYWdlcyA9ICQoICI6anFtRGF0YShyb2xlPSdwYWdlJyksIDpqcW1EYXRhKHJvbGU9J2RpYWxvZycpIiApLAoJCQkJaGFzaCA9ICQubW9iaWxlLnBhdGgucGFyc2VMb2NhdGlvbigpLmhhc2gucmVwbGFjZSgiIyIsICIiKSwKCQkJCWhhc2hQYWdlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoIGhhc2ggKTsKCgkJCS8vIGlmIG5vIHBhZ2VzIGFyZSBmb3VuZCwgY3JlYXRlIG9uZSB3aXRoIGJvZHkncyBpbm5lciBodG1sCgkJCWlmICggISRwYWdlcy5sZW5ndGggKSB7CgkJCQkkcGFnZXMgPSAkKCAiYm9keSIgKS53cmFwSW5uZXIoICI8ZGl2IGRhdGEtIiArICQubW9iaWxlLm5zICsgInJvbGU9J3BhZ2UnPjwvZGl2PiIgKS5jaGlsZHJlbiggMCApOwoJCQl9CgoJCQkvLyBhZGQgZGlhbG9ncywgc2V0IGRhdGEtdXJsIGF0dHJzCgkJCSRwYWdlcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJdmFyICR0aGlzID0gJCggdGhpcyApOwoKCQkJCS8vIHVubGVzcyB0aGUgZGF0YSB1cmwgaXMgYWxyZWFkeSBzZXQgc2V0IGl0IHRvIHRoZSBwYXRobmFtZQoJCQkJaWYgKCAhJHRoaXMuanFtRGF0YSggInVybCIgKSApIHsKCQkJCQkkdGhpcy5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidXJsIiwgJHRoaXMuYXR0ciggImlkIiApIHx8IGxvY2F0aW9uLnBhdGhuYW1lICsgbG9jYXRpb24uc2VhcmNoICk7CgkJCQl9CgkJCX0pOwoKCQkJLy8gZGVmaW5lIGZpcnN0IHBhZ2UgaW4gZG9tIGNhc2Ugb25lIGJhY2tzIG91dCB0byB0aGUgZGlyZWN0b3J5IHJvb3QgKG5vdCBhbHdheXMgdGhlIGZpcnN0IHBhZ2UgdmlzaXRlZCwgYnV0IGRlZmluZWQgYXMgZmFsbGJhY2spCgkJCSQubW9iaWxlLmZpcnN0UGFnZSA9ICRwYWdlcy5maXJzdCgpOwoKCQkJLy8gZGVmaW5lIHBhZ2UgY29udGFpbmVyCgkJCSQubW9iaWxlLnBhZ2VDb250YWluZXIgPSAkcGFnZXMuZmlyc3QoKS5wYXJlbnQoKS5hZGRDbGFzcyggInVpLW1vYmlsZS12aWV3cG9ydCIgKTsKCgkJCS8vIGFsZXJ0IGxpc3RlbmVycyB0aGF0IHRoZSBwYWdlY29udGFpbmVyIGhhcyBiZWVuIGRldGVybWluZWQgZm9yIGJpbmRpbmcKCQkJLy8gdG8gZXZlbnRzIHRyaWdnZXJlZCBvbiBpdAoJCQkkd2luZG93LnRyaWdnZXIoICJwYWdlY29udGFpbmVyY3JlYXRlIiApOwoKCQkJLy8gY3VlIHBhZ2UgbG9hZGluZyBtZXNzYWdlCgkJCSQubW9iaWxlLnNob3dQYWdlTG9hZGluZ01zZygpOwoKCQkJLy9yZW1vdmUgaW5pdGlhbCBidWlsZCBjbGFzcyAob25seSBwcmVzZW50IG9uIGZpcnN0IHBhZ2VzaG93KQoJCQloaWRlUmVuZGVyaW5nQ2xhc3MoKTsKCgkJCS8vIGlmIGhhc2hjaGFuZ2UgbGlzdGVuaW5nIGlzIGRpc2FibGVkLCB0aGVyZSdzIG5vIGhhc2ggZGVlcGxpbmssCgkJCS8vIHRoZSBoYXNoIGlzIG5vdCB2YWxpZCAoY29udGFpbnMgbW9yZSB0aGFuIG9uZSAjIG9yIGRvZXMgbm90IHN0YXJ0IHdpdGggIykKCQkJLy8gb3IgdGhlcmUgaXMgbm8gcGFnZSB3aXRoIHRoYXQgaGFzaCwgY2hhbmdlIHRvIHRoZSBmaXJzdCBwYWdlIGluIHRoZSBET00KCQkJLy8gUmVtZW1iZXIsIGhvd2V2ZXIsIHRoYXQgdGhlIGhhc2ggY2FuIGFsc28gYmUgYSBwYXRoIQoJCQlpZiAoICEgKCAkLm1vYmlsZS5oYXNoTGlzdGVuaW5nRW5hYmxlZCAmJgoJCQkJJC5tb2JpbGUucGF0aC5pc0hhc2hWYWxpZCggbG9jYXRpb24uaGFzaCApICYmCgkJCQkoICQoIGhhc2hQYWdlICkuaXMoICc6anFtRGF0YShyb2xlPSJwYWdlIiknICkgfHwKCQkJCQkkLm1vYmlsZS5wYXRoLmlzUGF0aCggaGFzaCApIHx8CgkJCQkJaGFzaCA9PT0gJC5tb2JpbGUuZGlhbG9nSGFzaEtleSApICkgKSB7CgoJCQkJLy8gU3RvcmUgdGhlIGluaXRpYWwgZGVzdGluYXRpb24KCQkJCWlmICggJC5tb2JpbGUucGF0aC5pc0hhc2hWYWxpZCggbG9jYXRpb24uaGFzaCApICkgewoJCQkJCSQubW9iaWxlLnVybEhpc3RvcnkuaW5pdGlhbERzdCA9IGhhc2gucmVwbGFjZSggIiMiLCAiIiApOwoJCQkJfQoJCQkJJC5tb2JpbGUuY2hhbmdlUGFnZSggJC5tb2JpbGUuZmlyc3RQYWdlLCB7IHRyYW5zaXRpb246ICJub25lIiwgcmV2ZXJzZTogdHJ1ZSwgY2hhbmdlSGFzaDogZmFsc2UsIGZyb21IYXNoQ2hhbmdlOiB0cnVlIH0gKTsKCQkJfQoJCQkvLyBvdGhlcndpc2UsIHRyaWdnZXIgYSBoYXNoY2hhbmdlIHRvIGxvYWQgYSBkZWVwbGluawoJCQllbHNlIHsKCQkJCSR3aW5kb3cudHJpZ2dlciggImhhc2hjaGFuZ2UiLCBbIHRydWUgXSApOwoJCQl9CgkJfQoJfSk7CgoJLy8gaW5pdGlhbGl6ZSBldmVudHMgbm93LCBhZnRlciBtb2JpbGVpbml0IGhhcyBvY2N1cnJlZAoJJC5tb2JpbGUubmF2cmVhZHlEZWZlcnJlZC5yZXNvbHZlKCk7CgoJLy8gY2hlY2sgd2hpY2ggc2Nyb2xsVG9wIHZhbHVlIHNob3VsZCBiZSB1c2VkIGJ5IHNjcm9sbGluZyB0byAxIGltbWVkaWF0ZWx5IGF0IGRvbXJlYWR5CgkvLyB0aGVuIGNoZWNrIHdoYXQgdGhlIHNjcm9sbCB0b3AgaXMuIEFuZHJvaWQgd2lsbCByZXBvcnQgMC4uLiBvdGhlcnMgMQoJLy8gbm90ZSB0aGF0IHRoaXMgaW5pdGlhbCBzY3JvbGwgd29uJ3QgaGlkZSB0aGUgYWRkcmVzcyBiYXIuIEl0J3MganVzdCBmb3IgdGhlIGNoZWNrLgoJJChmdW5jdGlvbigpIHsKCQl3aW5kb3cuc2Nyb2xsVG8oIDAsIDEgKTsKCgkJLy8gaWYgZGVmYXVsdEhvbWVTY3JvbGwgaGFzbid0IGJlZW4gc2V0IHlldCwgc2VlIGlmIHNjcm9sbFRvcCBpcyAxCgkJLy8gaXQgc2hvdWxkIGJlIDEgaW4gbW9zdCBicm93c2VycywgYnV0IGFuZHJvaWQgdHJlYXRzIDEgYXMgMCAoZm9yIGhpZGluZyBhZGRyIGJhcikKCQkvLyBzbyBpZiBpdCdzIDEsIHVzZSAwIGZyb20gbm93IG9uCgkJJC5tb2JpbGUuZGVmYXVsdEhvbWVTY3JvbGwgPSAoICEkLnN1cHBvcnQuc2Nyb2xsVG9wIHx8ICQoIHdpbmRvdyApLnNjcm9sbFRvcCgpID09PSAxICkgPyAwIDogMTsKCgoJCS8vIFRPRE86IEltcGxlbWVudCBhIHByb3BlciByZWdpc3RyYXRpb24gbWVjaGFuaXNtIHdpdGggZGVwZW5kZW5jeSBoYW5kbGluZyBpbiBvcmRlciB0byBub3QgaGF2ZSBleGNlcHRpb25zIGxpa2UgdGhlIG9uZSBiZWxvdwoJCS8vYXV0byBzZWxmLWluaXQgd2lkZ2V0cyBmb3IgdGhvc2Ugd2lkZ2V0cyB0aGF0IGhhdmUgYSBzb2Z0IGRlcGVuZGVuY3kgb24gb3RoZXJzCgkJaWYgKCAkLmZuLmNvbnRyb2xncm91cCApIHsKCQkJJCggZG9jdW1lbnQgKS5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApIHsKCQkJCSQoICI6anFtRGF0YShyb2xlPSdjb250cm9sZ3JvdXAnKSIsIGUudGFyZ2V0ICkKCQkJCQkuanFtRW5oYW5jZWFibGUoKQoJCQkJCS5jb250cm9sZ3JvdXAoeyBleGNsdWRlSW52aXNpYmxlOiBmYWxzZSB9KTsKCQkJfSk7CgkJfQoKCQkvL2RvbS1yZWFkeSBpbml0cwoJCWlmICggJC5tb2JpbGUuYXV0b0luaXRpYWxpemVQYWdlICkgewoJCQkkLm1vYmlsZS5pbml0aWFsaXplUGFnZSgpOwoJCX0KCgkJLy8gd2luZG93IGxvYWQgZXZlbnQKCQkvLyBoaWRlIGlPUyBicm93c2VyIGNocm9tZSBvbiBsb2FkCgkJJHdpbmRvdy5sb2FkKCAkLm1vYmlsZS5zaWxlbnRTY3JvbGwgKTsKCgkJaWYgKCAhJC5zdXBwb3J0LmNzc1BvaW50ZXJFdmVudHMgKSB7CgkJCS8vIElFIGFuZCBPcGVyYSBkb24ndCBzdXBwb3J0IENTUyBwb2ludGVyLWV2ZW50czogbm9uZSB0aGF0IHdlIHVzZSB0byBkaXNhYmxlIGxpbmstYmFzZWQgYnV0dG9ucwoJCQkvLyBieSBhZGRpbmcgdGhlICd1aS1kaXNhYmxlZCcgY2xhc3MgdG8gdGhlbS4gVXNpbmcgYSBKYXZhU2NyaXB0IHdvcmthcm91bmQgZm9yIHRob3NlIGJyb3dzZXIuCgkJCS8vIGh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5LW1vYmlsZS9pc3N1ZXMvMzU1OAoKCQkJJCggZG9jdW1lbnQgKS5kZWxlZ2F0ZSggIi51aS1kaXNhYmxlZCIsICJ2Y2xpY2siLAoJCQkJZnVuY3Rpb24oIGUgKSB7CgkJCQkJZS5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJCWUuc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uKCk7CgkJCQl9CgkJCSk7CgkJfQoJfSk7Cn0oIGpRdWVyeSwgdGhpcyApKTsKCn0pKTsK",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Fri, 07 Nov 2014 05:03:23 GMT",
                    "Content-Length": "293535",
                    "Date": "Fri, 07 Nov 2014 05:04:21 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}