{
    "url": "http://localhost:9999/piwik/piwik/tests/javascript/frameworks/mootools/mootools-1.1.2.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Open redirection (DOM-based)",
    "issueType": 5243152,
    "severity": "Low",
    "confidence": "Firm",
    "issueBackground": "DOM-based open redirection vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this data into the target of a redirection in an unsafe way. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will cause a redirection to an arbitrary external domain. This behavior can be leveraged to facilitate phishing attacks against users of the application. The ability to use an authentic application URL, targeting the correct domain with a valid SSL certificate (if SSL is used) lends credibility to the phishing attack because many users, even if they verify these features, will not notice the subsequent redirection to a different domain.<br><br><b>Note:</b> If an attacker is able to control the start of the string that is passed to the redirection API, then it may be possible to escalate this vulnerability into a JavaScript injection attack, by using a URL with the javascript: pseudo-protocol to execute arbitrary script code when the URL is processed by the browser.",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based open redirection vulnerabilities is not to dynamically set redirection targets using data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing an arbitrary URL as a redirection target. In general, this is best achieved by using a whitelist of URLs that are permitted redirection targets, and strictly validating the target against this list before performing the redirection.",
    "issueDetail": "The application may be vulnerable to DOM-based open redirection. Data is read from <b>window.location.href</b> and written to <b>location</b> via the following statement:<ul><li>var location = window.location.href.match(/^[^#]*/)[0] + '#';</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/piwik/piwik/tests/javascript/frameworks/mootools/mootools-1.1.2.js",
                "path": "/piwik/piwik/tests/javascript/frameworks/mootools/mootools-1.1.2.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9waXdpay9waXdpay90ZXN0cy9qYXZhc2NyaXB0L2ZyYW1ld29ya3MvbW9vdG9vbHMvbW9vdG9vbHMtMS4xLjIuanMgSFRUUC8xLjENCkhvc3Q6IGxvY2FsaG9zdDo5OTk5DQoNCg==",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogMTgzNjE4DQpBY2NlcHQtUmFuZ2VzOiBieXRlcw0KQ29udGVudC1UeXBlOiBhcHBsaWNhdGlvbi9qYXZhc2NyaXB0DQpEYXRlOiBGcmksIDA3IE5vdiAyMDE0IDIyOjA3OjMyIEdNVA0KTGFzdC1Nb2RpZmllZDogRnJpLCAwNyBOb3YgMjAxNCAyMjowNzoxNCBHTVQNCg0KLyoKU2NyaXB0OiBDb3JlLmpzCglNb290b29scyAtIE15IE9iamVjdCBPcmllbnRlZCBqYXZhc2NyaXB0LgoKTGljZW5zZToKCU1JVC1zdHlsZSBsaWNlbnNlLgoKTW9vVG9vbHMgQ29weXJpZ2h0OgoJY29weXJpZ2h0IChjKSAyMDA3IFZhbGVyaW8gUHJvaWV0dGksIDxodHRwOi8vbWFkNG1pbGsubmV0PgoKTW9vVG9vbHMgQ3JlZGl0czoKCS0gQ2xhc3MgaXMgc2xpZ2h0bHkgYmFzZWQgb24gQmFzZS5qcyA8aHR0cDovL2RlYW4uZWR3YXJkcy5uYW1lL3dlYmxvZy8yMDA2LzAzL2Jhc2UvPiAoYykgMjAwNiBEZWFuIEVkd2FyZHMsIExpY2Vuc2UgPGh0dHA6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL0xHUEwvMi4xLz4KCS0gU29tZSBmdW5jdGlvbnMgYXJlIGluc3BpcmVkIGJ5IHRob3NlIGZvdW5kIGluIHByb3RvdHlwZS5qcyA8aHR0cDovL3Byb3RvdHlwZS5jb25pby5uZXQvPiAoYykgMjAwNSBTYW0gU3RlcGhlbnNvbiBzYW0gW2F0XSBjb25pbyBbZG90XSBuZXQsIE1JVC1zdHlsZSBsaWNlbnNlCgktIERvY3VtZW50YXRpb24gYnkgQWFyb24gTmV3dG9uIChhYXJvbi5uZXd0b24gW2F0XSBjbmV0IFtkb3RdIGNvbSkgYW5kIFZhbGVyaW8gUHJvaWV0dGkuCiovCgp2YXIgTW9vVG9vbHMgPSB7Cgl2ZXJzaW9uOiAnMS4xMicKfTsKCi8qIFNlY3Rpb246IENvcmUgRnVuY3Rpb25zICovCgovKgpGdW5jdGlvbjogJGRlZmluZWQKCVJldHVybnMgdHJ1ZSBpZiB0aGUgcGFzc2VkIGluIHZhbHVlL29iamVjdCBpcyBkZWZpbmVkLCB0aGF0IG1lYW5zIGlzIG5vdCBudWxsIG9yIHVuZGVmaW5lZC4KCkFyZ3VtZW50czoKCW9iaiAtIG9iamVjdCB0byBpbnNwZWN0CiovCgpmdW5jdGlvbiAkZGVmaW5lZChvYmopewoJcmV0dXJuIChvYmogIT0gdW5kZWZpbmVkKTsKfTsKCi8qCkZ1bmN0aW9uOiAkdHlwZQoJUmV0dXJucyB0aGUgdHlwZSBvZiBvYmplY3QgdGhhdCBtYXRjaGVzIHRoZSBlbGVtZW50IHBhc3NlZCBpbi4KCkFyZ3VtZW50czoKCW9iaiAtIHRoZSBvYmplY3QgdG8gaW5zcGVjdC4KCkV4YW1wbGU6Cgk+dmFyIG15U3RyaW5nID0gJ2hlbGxvJzsKCT4kdHlwZShteVN0cmluZyk7IC8vcmV0dXJucyAic3RyaW5nIgoKUmV0dXJuczoKCSdlbGVtZW50JyAtIGlmIG9iaiBpcyBhIERPTSBlbGVtZW50IG5vZGUKCSd0ZXh0bm9kZScgLSBpZiBvYmogaXMgYSBET00gdGV4dCBub2RlCgknd2hpdGVzcGFjZScgLSBpZiBvYmogaXMgYSBET00gd2hpdGVzcGFjZSBub2RlCgknYXJndW1lbnRzJyAtIGlmIG9iaiBpcyBhbiBhcmd1bWVudHMgb2JqZWN0Cgknb2JqZWN0JyAtIGlmIG9iaiBpcyBhbiBvYmplY3QKCSdzdHJpbmcnIC0gaWYgb2JqIGlzIGEgc3RyaW5nCgknbnVtYmVyJyAtIGlmIG9iaiBpcyBhIG51bWJlcgoJJ2Jvb2xlYW4nIC0gaWYgb2JqIGlzIGEgYm9vbGVhbgoJJ2Z1bmN0aW9uJyAtIGlmIG9iaiBpcyBhIGZ1bmN0aW9uCgkncmVnZXhwJyAtIGlmIG9iaiBpcyBhIHJlZ3VsYXIgZXhwcmVzc2lvbgoJJ2NsYXNzJyAtIGlmIG9iaiBpcyBhIENsYXNzLiAoY3JlYXRlZCB3aXRoIG5ldyBDbGFzcywgb3IgdGhlIGV4dGVuZCBvZiBhbm90aGVyIGNsYXNzKS4KCSdjb2xsZWN0aW9uJyAtIGlmIG9iaiBpcyBhIG5hdGl2ZSBodG1sZWxlbWVudHMgY29sbGVjdGlvbiwgc3VjaCBhcyBjaGlsZE5vZGVzLCBnZXRFbGVtZW50c0J5VGFnTmFtZSAuLiBldGMuCglmYWxzZSAtIChib29sZWFuKSBpZiB0aGUgb2JqZWN0IGlzIG5vdCBkZWZpbmVkIG9yIG5vbmUgb2YgdGhlIGFib3ZlLgoqLwoKZnVuY3Rpb24gJHR5cGUob2JqKXsKCWlmICghJGRlZmluZWQob2JqKSkgcmV0dXJuIGZhbHNlOwoJaWYgKG9iai5odG1sRWxlbWVudCkgcmV0dXJuICdlbGVtZW50JzsKCXZhciB0eXBlID0gdHlwZW9mIG9iajsKCWlmICh0eXBlID09ICdvYmplY3QnICYmIG9iai5ub2RlTmFtZSl7CgkJc3dpdGNoKG9iai5ub2RlVHlwZSl7CgkJCWNhc2UgMTogcmV0dXJuICdlbGVtZW50JzsKCQkJY2FzZSAzOiByZXR1cm4gKC9cUy8pLnRlc3Qob2JqLm5vZGVWYWx1ZSkgPyAndGV4dG5vZGUnIDogJ3doaXRlc3BhY2UnOwoJCX0KCX0KCWlmICh0eXBlID09ICdvYmplY3QnIHx8IHR5cGUgPT0gJ2Z1bmN0aW9uJyl7CgkJc3dpdGNoKG9iai5jb25zdHJ1Y3Rvcil7CgkJCWNhc2UgQXJyYXk6IHJldHVybiAnYXJyYXknOwoJCQljYXNlIFJlZ0V4cDogcmV0dXJuICdyZWdleHAnOwoJCQljYXNlIENsYXNzOiByZXR1cm4gJ2NsYXNzJzsKCQl9CgkJaWYgKHR5cGVvZiBvYmoubGVuZ3RoID09ICdudW1iZXInKXsKCQkJaWYgKG9iai5pdGVtKSByZXR1cm4gJ2NvbGxlY3Rpb24nOwoJCQlpZiAob2JqLmNhbGxlZSkgcmV0dXJuICdhcmd1bWVudHMnOwoJCX0KCX0KCXJldHVybiB0eXBlOwp9OwoKLyoKRnVuY3Rpb246ICRtZXJnZQoJbWVyZ2VzIGEgbnVtYmVyIG9mIG9iamVjdHMgcmVjdXJzaXZlbHkgd2l0aG91dCByZWZlcmVuY2luZyB0aGVtIG9yIHRoZWlyIHN1Yi1vYmplY3RzLgoKQXJndW1lbnRzOgoJYW55IG51bWJlciBvZiBvYmplY3RzLgoKRXhhbXBsZToKCT52YXIgbWVyZ2VkT2JqID0gJG1lcmdlKG9iajEsIG9iajIsIG9iajMpOwoJPi8vb2JqMSwgb2JqMiwgYW5kIG9iajMgYXJlIHVuYWx0ZXJlZAoqLwoKZnVuY3Rpb24gJG1lcmdlKCl7Cgl2YXIgbWl4ID0ge307Cglmb3IgKHZhciBpID0gMDsgaSA8IGFyZ3VtZW50cy5sZW5ndGg7IGkrKyl7CgkJZm9yICh2YXIgcHJvcGVydHkgaW4gYXJndW1lbnRzW2ldKXsKCQkJdmFyIGFwID0gYXJndW1lbnRzW2ldW3Byb3BlcnR5XTsKCQkJdmFyIG1wID0gbWl4W3Byb3BlcnR5XTsKCQkJaWYgKG1wICYmICR0eXBlKGFwKSA9PSAnb2JqZWN0JyAmJiAkdHlwZShtcCkgPT0gJ29iamVjdCcpIG1peFtwcm9wZXJ0eV0gPSAkbWVyZ2UobXAsIGFwKTsKCQkJZWxzZSBtaXhbcHJvcGVydHldID0gYXA7CgkJfQoJfQoJcmV0dXJuIG1peDsKfTsKCi8qCkZ1bmN0aW9uOiAkZXh0ZW5kCglDb3BpZXMgYWxsIHRoZSBwcm9wZXJ0aWVzIGZyb20gdGhlIHNlY29uZCBwYXNzZWQgb2JqZWN0IHRvIHRoZSBmaXJzdCBwYXNzZWQgT2JqZWN0LgoJSWYgeW91IGRvIG15V2hhdGV2ZXIuZXh0ZW5kID0gJGV4dGVuZCB0aGUgZmlyc3QgcGFyYW1ldGVyIHdpbGwgYmVjb21lIG15V2hhdGV2ZXIsIGFuZCB5b3VyIGV4dGVuZCBmdW5jdGlvbiB3aWxsIG9ubHkgbmVlZCBvbmUgcGFyYW1ldGVyLgoKRXhhbXBsZToKCShzdGFydCBjb2RlKQoJdmFyIGZpcnN0T2IgPSB7CgkJJ25hbWUnOiAnSm9obicsCgkJJ2xhc3ROYW1lJzogJ0RvZScKCX07Cgl2YXIgc2Vjb25kT2IgPSB7CgkJJ2FnZSc6ICcyMCcsCgkJJ3NleCc6ICdtYWxlJywKCQknbGFzdE5hbWUnOiAnRG9yaWFuJwoJfTsKCSRleHRlbmQoZmlyc3RPYiwgc2Vjb25kT2IpOwoJLy9maXJzdE9iIHdpbGwgYmVjb21lOgoJewoJCSduYW1lJzogJ0pvaG4nLAoJCSdsYXN0TmFtZSc6ICdEb3JpYW4nLAoJCSdhZ2UnOiAnMjAnLAoJCSdzZXgnOiAnbWFsZScKCX07CgkoZW5kKQoKUmV0dXJuczoKCVRoZSBmaXJzdCBvYmplY3QsIGV4dGVuZGVkLgoqLwoKdmFyICRleHRlbmQgPSBmdW5jdGlvbigpewoJdmFyIGFyZ3MgPSBhcmd1bWVudHM7CglpZiAoIWFyZ3NbMV0pIGFyZ3MgPSBbdGhpcywgYXJnc1swXV07Cglmb3IgKHZhciBwcm9wZXJ0eSBpbiBhcmdzWzFdKSBhcmdzWzBdW3Byb3BlcnR5XSA9IGFyZ3NbMV1bcHJvcGVydHldOwoJcmV0dXJuIGFyZ3NbMF07Cn07CgovKgpGdW5jdGlvbjogJG5hdGl2ZQoJV2lsbCBhZGQgYSAuZXh0ZW5kIG1ldGhvZCB0byB0aGUgb2JqZWN0cyBwYXNzZWQgYXMgYSBwYXJhbWV0ZXIsIGJ1dCB0aGUgcHJvcGVydHkgcGFzc2VkIGluIHdpbGwgYmUgY29waWVkIHRvIHRoZSBvYmplY3QncyBwcm90b3R5cGUgb25seSBpZiBub24gcHJldmlvdXNseSBleGlzdGVudC4KCUl0cyBoYW5keSBpZiB5b3UgZG9udCB3YW50IHRoZSAuZXh0ZW5kIG1ldGhvZCBvZiBhbiBvYmplY3QgdG8gb3ZlcndyaXRlIGV4aXN0aW5nIG1ldGhvZHMuCglVc2VkIGF1dG9tYXRpY2FsbHkgaW4gTW9vVG9vbHMgdG8gaW1wbGVtZW50IEFycmF5L1N0cmluZy9GdW5jdGlvbi9OdW1iZXIgbWV0aG9kcyB0byBicm93c2VyIHRoYXQgZG9udCBzdXBwb3J0IHRoZW0gd2hpdG91dCBtYW51YWwgY2hlY2tpbmcuCgpBcmd1bWVudHM6CglhIG51bWJlciBvZiBjbGFzc2VzL25hdGl2ZSBqYXZhc2NyaXB0IG9iamVjdHMKCiovCgp2YXIgJG5hdGl2ZSA9IGZ1bmN0aW9uKCl7Cglmb3IgKHZhciBpID0gMCwgbCA9IGFyZ3VtZW50cy5sZW5ndGg7IGkgPCBsOyBpKyspewoJCWFyZ3VtZW50c1tpXS5leHRlbmQgPSBmdW5jdGlvbihwcm9wcyl7CgkJCWZvciAodmFyIHByb3AgaW4gcHJvcHMpewoJCQkJaWYgKCF0aGlzLnByb3RvdHlwZVtwcm9wXSkgdGhpcy5wcm90b3R5cGVbcHJvcF0gPSBwcm9wc1twcm9wXTsKCQkJCWlmICghdGhpc1twcm9wXSkgdGhpc1twcm9wXSA9ICRuYXRpdmUuZ2VuZXJpYyhwcm9wKTsKCQkJfQoJCX07Cgl9Cn07CgokbmF0aXZlLmdlbmVyaWMgPSBmdW5jdGlvbihwcm9wKXsKCXJldHVybiBmdW5jdGlvbihiaW5kKXsKCQlyZXR1cm4gdGhpcy5wcm90b3R5cGVbcHJvcF0uYXBwbHkoYmluZCwgQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSk7Cgl9Owp9OwoKJG5hdGl2ZShGdW5jdGlvbiwgQXJyYXksIFN0cmluZywgTnVtYmVyKTsKCi8qCkZ1bmN0aW9uOiAkY2hrCglSZXR1cm5zIHRydWUgaWYgdGhlIHBhc3NlZCBpbiB2YWx1ZS9vYmplY3QgZXhpc3RzIG9yIGlzIDAsIG90aGVyd2lzZSByZXR1cm5zIGZhbHNlLgoJVXNlZnVsIHRvIGFjY2VwdCB6ZXJvZXMuCgpBcmd1bWVudHM6CglvYmogLSBvYmplY3QgdG8gaW5zcGVjdAoqLwoKZnVuY3Rpb24gJGNoayhvYmopewoJcmV0dXJuICEhKG9iaiB8fCBvYmogPT09IDApOwp9OwoKLyoKRnVuY3Rpb246ICRwaWNrCglSZXR1cm5zIHRoZSBmaXJzdCBvYmplY3QgaWYgZGVmaW5lZCwgb3RoZXJ3aXNlIHJldHVybnMgdGhlIHNlY29uZC4KCkFyZ3VtZW50czoKCW9iaiAtIG9iamVjdCB0byB0ZXN0CglwaWNrZWQgLSB0aGUgZGVmYXVsdCB0byByZXR1cm4KCkV4YW1wbGU6Cgkoc3RhcnQgY29kZSkKCQlmdW5jdGlvbiBzYXkobXNnKXsKCQkJYWxlcnQoJHBpY2sobXNnLCAnbm8gbWVlc3NhZ2Ugc3VwcGxpZWQnKSk7CgkJfQoJKGVuZCkKKi8KCmZ1bmN0aW9uICRwaWNrKG9iaiwgcGlja2VkKXsKCXJldHVybiAkZGVmaW5lZChvYmopID8gb2JqIDogcGlja2VkOwp9OwoKLyoKRnVuY3Rpb246ICRyYW5kb20KCVJldHVybnMgYSByYW5kb20gaW50ZWdlciBudW1iZXIgYmV0d2VlbiB0aGUgdHdvIHBhc3NlZCBpbiB2YWx1ZXMuCgpBcmd1bWVudHM6CgltaW4gLSBpbnRlZ2VyLCB0aGUgbWluaW11bSB2YWx1ZSAoaW5jbHVzaXZlKS4KCW1heCAtIGludGVnZXIsIHRoZSBtYXhpbXVtIHZhbHVlIChpbmNsdXNpdmUpLgoKUmV0dXJuczoKCWEgcmFuZG9tIGludGVnZXIgYmV0d2VlbiBtaW4gYW5kIG1heC4KKi8KCmZ1bmN0aW9uICRyYW5kb20obWluLCBtYXgpewoJcmV0dXJuIE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIChtYXggLSBtaW4gKyAxKSArIG1pbik7Cn07CgovKgpGdW5jdGlvbjogJHRpbWUKCVJldHVybnMgdGhlIGN1cnJlbnQgdGltZXN0YW1wCgpSZXR1cm5zOgoJYSB0aW1lc3RhbXAgaW50ZWdlci4KKi8KCmZ1bmN0aW9uICR0aW1lKCl7CglyZXR1cm4gbmV3IERhdGUoKS5nZXRUaW1lKCk7Cn07CgovKgpGdW5jdGlvbjogJGNsZWFyCgljbGVhcnMgYSB0aW1lb3V0IG9yIGFuIEludGVydmFsLgoKUmV0dXJuczoKCW51bGwKCkFyZ3VtZW50czoKCXRpbWVyIC0gdGhlIHNldEludGVydmFsIG9yIHNldFRpbWVvdXQgdG8gY2xlYXIuCgpFeGFtcGxlOgoJPnZhciBteVRpbWVyID0gbXlGdW5jdGlvbi5kZWxheSg1MDAwKTsgLy93YWl0IDUgc2Vjb25kcyBhbmQgZXhlY3V0ZSBteSBmdW5jdGlvbi4KCT5teVRpbWVyID0gJGNsZWFyKG15VGltZXIpOyAvL25ldmVybWluZAoKU2VlIGFsc286Cgk8RnVuY3Rpb24uZGVsYXk+LCA8RnVuY3Rpb24ucGVyaW9kaWNhbD4KKi8KCmZ1bmN0aW9uICRjbGVhcih0aW1lcil7CgljbGVhclRpbWVvdXQodGltZXIpOwoJY2xlYXJJbnRlcnZhbCh0aW1lcik7CglyZXR1cm4gbnVsbDsKfTsKCi8qCkNsYXNzOiBBYnN0cmFjdAoJQWJzdHJhY3QgY2xhc3MsIHRvIGJlIHVzZWQgYXMgc2luZ2xldG9uLiBXaWxsIGFkZCAuZXh0ZW5kIHRvIGFueSBvYmplY3QKCkFyZ3VtZW50czoKCWFuIG9iamVjdAoKUmV0dXJuczoKCXRoZSBvYmplY3Qgd2l0aCBhbiAuZXh0ZW5kIHByb3BlcnR5LCBlcXVpdmFsZW50IHRvIDwkZXh0ZW5kPi4KKi8KCnZhciBBYnN0cmFjdCA9IGZ1bmN0aW9uKG9iail7CglvYmogPSBvYmogfHwge307CglvYmouZXh0ZW5kID0gJGV4dGVuZDsKCXJldHVybiBvYmo7Cn07CgovL3dpbmRvdywgZG9jdW1lbnQKCnZhciBXaW5kb3cgPSBuZXcgQWJzdHJhY3Qod2luZG93KTsKdmFyIERvY3VtZW50ID0gbmV3IEFic3RyYWN0KGRvY3VtZW50KTsKZG9jdW1lbnQuaGVhZCA9IGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCdoZWFkJylbMF07CgovKgpDbGFzczogd2luZG93CglTb21lIHByb3BlcnRpZXMgYXJlIGF0dGFjaGVkIHRvIHRoZSB3aW5kb3cgb2JqZWN0IGJ5IHRoZSBicm93c2VyIGRldGVjdGlvbi4KCk5vdGU6Cglicm93c2VyIGRldGVjdGlvbiBpcyBlbnRpcmVseSBvYmplY3QtYmFzZWQuIFdlIGRvbnQgc25pZmYuCgpQcm9wZXJ0aWVzOgoJd2luZG93LmllIC0gd2lsbCBiZSBzZXQgdG8gdHJ1ZSBpZiB0aGUgY3VycmVudCBicm93c2VyIGlzIGludGVybmV0IGV4cGxvcmVyIChhbnkpLgoJd2luZG93LmllNiAtIHdpbGwgYmUgc2V0IHRvIHRydWUgaWYgdGhlIGN1cnJlbnQgYnJvd3NlciBpcyBpbnRlcm5ldCBleHBsb3JlciA2LgoJd2luZG93LmllNyAtIHdpbGwgYmUgc2V0IHRvIHRydWUgaWYgdGhlIGN1cnJlbnQgYnJvd3NlciBpcyBpbnRlcm5ldCBleHBsb3JlciA3LgoJd2luZG93LmdlY2tvIC0gd2lsbCBiZSBzZXQgdG8gdHJ1ZSBpZiB0aGUgY3VycmVudCBicm93c2VyIGlzIE1vemlsbGEvR2Vja28uCgl3aW5kb3cud2Via2l0IC0gd2lsbCBiZSBzZXQgdG8gdHJ1ZSBpZiB0aGUgY3VycmVudCBicm93c2VyIGlzIFNhZmFyaS9Lb25xdWVyb3IuCgl3aW5kb3cud2Via2l0NDE5IC0gd2lsbCBiZSBzZXQgdG8gdHJ1ZSBpZiB0aGUgY3VycmVudCBicm93c2VyIGlzIFNhZmFyaTIgLyB3ZWJraXQgdGlsbCB2ZXJzaW9uIDQxOS4KCXdpbmRvdy53ZWJraXQ0MjAgLSB3aWxsIGJlIHNldCB0byB0cnVlIGlmIHRoZSBjdXJyZW50IGJyb3dzZXIgaXMgU2FmYXJpMyAoV2Via2l0IFNWTiBCdWlsZCkgLyB3ZWJraXQgb3ZlciB2ZXJzaW9uIDQxOS4KCXdpbmRvdy5vcGVyYSAtIGlzIHNldCB0byB0cnVlIGJ5IG9wZXJhIGl0c2VsZi4KKi8KCndpbmRvdy54cGF0aCA9ICEhKGRvY3VtZW50LmV2YWx1YXRlKTsKaWYgKHdpbmRvdy5BY3RpdmVYT2JqZWN0KSB3aW5kb3cuaWUgPSB3aW5kb3dbd2luZG93LlhNTEh0dHBSZXF1ZXN0ID8gJ2llNycgOiAnaWU2J10gPSB0cnVlOwplbHNlIGlmIChkb2N1bWVudC5jaGlsZE5vZGVzICYmICFkb2N1bWVudC5hbGwgJiYgIW5hdmlnYXRvci50YWludEVuYWJsZWQpIHdpbmRvdy53ZWJraXQgPSB3aW5kb3dbd2luZG93LnhwYXRoID8gJ3dlYmtpdDQyMCcgOiAnd2Via2l0NDE5J10gPSB0cnVlOwplbHNlIGlmIChkb2N1bWVudC5nZXRCb3hPYmplY3RGb3IgIT0gbnVsbCB8fCB3aW5kb3cubW96SW5uZXJTY3JlZW5YICE9IG51bGwpIHdpbmRvdy5nZWNrbyA9IHRydWU7CgovKmNvbXBhdGliaWxpdHkqLwoKd2luZG93LmtodG1sID0gd2luZG93LndlYmtpdDsKCk9iamVjdC5leHRlbmQgPSAkZXh0ZW5kOwoKLyplbmQgY29tcGF0aWJpbGl0eSovCgovL2h0bWxlbGVtZW50CgppZiAodHlwZW9mIEhUTUxFbGVtZW50ID09ICd1bmRlZmluZWQnKXsKCXZhciBIVE1MRWxlbWVudCA9IGZ1bmN0aW9uKCl7fTsKCWlmICh3aW5kb3cud2Via2l0KSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJpZnJhbWUiKTsgLy9maXhlcyBzYWZhcmkKCUhUTUxFbGVtZW50LnByb3RvdHlwZSA9ICh3aW5kb3cud2Via2l0KSA/IHdpbmRvd1siW1tET01FbGVtZW50LnByb3RvdHlwZV1dIl0gOiB7fTsKfQpIVE1MRWxlbWVudC5wcm90b3R5cGUuaHRtbEVsZW1lbnQgPSBmdW5jdGlvbigpe307CgovL2VuYWJsZXMgYmFja2dyb3VuZCBpbWFnZSBjYWNoZSBmb3IgaW50ZXJuZXQgZXhwbG9yZXIgNgoKaWYgKHdpbmRvdy5pZTYpIHRyeSB7ZG9jdW1lbnQuZXhlY0NvbW1hbmQoIkJhY2tncm91bmRJbWFnZUNhY2hlIiwgZmFsc2UsIHRydWUpO30gY2F0Y2goZSl7fTsKCi8qClNjcmlwdDogQ2xhc3MuanMKCUNvbnRhaW5zIHRoZSBDbGFzcyBGdW5jdGlvbiwgYWltcyB0byBlYXNlIHRoZSBjcmVhdGlvbiBvZiByZXVzYWJsZSBDbGFzc2VzLgoKTGljZW5zZToKCU1JVC1zdHlsZSBsaWNlbnNlLgoqLwoKLyoKQ2xhc3M6IENsYXNzCglUaGUgYmFzZSBjbGFzcyBvYmplY3Qgb2YgdGhlIDxodHRwOi8vbW9vdG9vbHMubmV0PiBmcmFtZXdvcmsuCglDcmVhdGVzIGEgbmV3IGNsYXNzLCBpdHMgaW5pdGlhbGl6ZSBtZXRob2Qgd2lsbCBmaXJlIHVwb24gY2xhc3MgaW5zdGFudGlhdGlvbi4KCUluaXRpYWxpemUgd29udCBmaXJlIG9uIGluc3RhbnRpYXRpb24gd2hlbiB5b3UgcGFzcyAqbnVsbCouCgpBcmd1bWVudHM6Cglwcm9wZXJ0aWVzIC0gdGhlIGNvbGxlY3Rpb24gb2YgcHJvcGVydGllcyB0aGF0IGFwcGx5IHRvIHRoZSBjbGFzcy4KCkV4YW1wbGU6Cgkoc3RhcnQgY29kZSkKCXZhciBDYXQgPSBuZXcgQ2xhc3MoewoJCWluaXRpYWxpemU6IGZ1bmN0aW9uKG5hbWUpewoJCQl0aGlzLm5hbWUgPSBuYW1lOwoJCX0KCX0pOwoJdmFyIG15Q2F0ID0gbmV3IENhdCgnTWljaWEnKTsKCWFsZXJ0KG15Q2F0Lm5hbWUpOyAvL2FsZXJ0cyAnTWljaWEnCgkoZW5kKQoqLwoKdmFyIENsYXNzID0gZnVuY3Rpb24ocHJvcGVydGllcyl7Cgl2YXIga2xhc3MgPSBmdW5jdGlvbigpewoJCXJldHVybiAoYXJndW1lbnRzWzBdICE9PSBudWxsICYmIHRoaXMuaW5pdGlhbGl6ZSAmJiAkdHlwZSh0aGlzLmluaXRpYWxpemUpID09ICdmdW5jdGlvbicpID8gdGhpcy5pbml0aWFsaXplLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykgOiB0aGlzOwoJfTsKCSRleHRlbmQoa2xhc3MsIHRoaXMpOwoJa2xhc3MucHJvdG90eXBlID0gcHJvcGVydGllczsKCWtsYXNzLmNvbnN0cnVjdG9yID0gQ2xhc3M7CglyZXR1cm4ga2xhc3M7Cn07CgovKgpQcm9wZXJ0eTogZW1wdHkKCVJldHVybnMgYW4gZW1wdHkgZnVuY3Rpb24KKi8KCkNsYXNzLmVtcHR5ID0gZnVuY3Rpb24oKXt9OwoKQ2xhc3MucHJvdG90eXBlID0gewoKCS8qCglQcm9wZXJ0eTogZXh0ZW5kCgkJUmV0dXJucyB0aGUgY29weSBvZiB0aGUgQ2xhc3MgZXh0ZW5kZWQgd2l0aCB0aGUgcGFzc2VkIGluIHByb3BlcnRpZXMuCgoJQXJndW1lbnRzOgoJCXByb3BlcnRpZXMgLSB0aGUgcHJvcGVydGllcyB0byBhZGQgdG8gdGhlIGJhc2UgY2xhc3MgaW4gdGhpcyBuZXcgQ2xhc3MuCgoJRXhhbXBsZToKCQkoc3RhcnQgY29kZSkKCQl2YXIgQW5pbWFsID0gbmV3IENsYXNzKHsKCQkJaW5pdGlhbGl6ZTogZnVuY3Rpb24oYWdlKXsKCQkJCXRoaXMuYWdlID0gYWdlOwoJCQl9CgkJfSk7CgkJdmFyIENhdCA9IEFuaW1hbC5leHRlbmQoewoJCQlpbml0aWFsaXplOiBmdW5jdGlvbihuYW1lLCBhZ2UpewoJCQkJdGhpcy5wYXJlbnQoYWdlKTsgLy93aWxsIGNhbGwgdGhlIHByZXZpb3VzIGluaXRpYWxpemU7CgkJCQl0aGlzLm5hbWUgPSBuYW1lOwoJCQl9CgkJfSk7CgkJdmFyIG15Q2F0ID0gbmV3IENhdCgnTWljaWEnLCAyMCk7CgkJYWxlcnQobXlDYXQubmFtZSk7IC8vYWxlcnRzICdNaWNpYScKCQlhbGVydChteUNhdC5hZ2UpOyAvL2FsZXJ0cyAyMAoJCShlbmQpCgkqLwoKCWV4dGVuZDogZnVuY3Rpb24ocHJvcGVydGllcyl7CgkJdmFyIHByb3RvID0gbmV3IHRoaXMobnVsbCk7CgkJZm9yICh2YXIgcHJvcGVydHkgaW4gcHJvcGVydGllcyl7CgkJCXZhciBwcCA9IHByb3RvW3Byb3BlcnR5XTsKCQkJcHJvdG9bcHJvcGVydHldID0gQ2xhc3MuTWVyZ2UocHAsIHByb3BlcnRpZXNbcHJvcGVydHldKTsKCQl9CgkJcmV0dXJuIG5ldyBDbGFzcyhwcm90byk7Cgl9LAoKCS8qCglQcm9wZXJ0eTogaW1wbGVtZW50CgkJSW1wbGVtZW50cyB0aGUgcGFzc2VkIGluIHByb3BlcnRpZXMgdG8gdGhlIGJhc2UgQ2xhc3MgcHJvdG90eXBlcywgYWx0ZXJpbmcgdGhlIGJhc2UgY2xhc3MsIHVubGlrZSA8Q2xhc3MuZXh0ZW5kPi4KCglBcmd1bWVudHM6CgkJcHJvcGVydGllcyAtIHRoZSBwcm9wZXJ0aWVzIHRvIGFkZCB0byB0aGUgYmFzZSBjbGFzcy4KCglFeGFtcGxlOgoJCShzdGFydCBjb2RlKQoJCXZhciBBbmltYWwgPSBuZXcgQ2xhc3MoewoJCQlpbml0aWFsaXplOiBmdW5jdGlvbihhZ2UpewoJCQkJdGhpcy5hZ2UgPSBhZ2U7CgkJCX0KCQl9KTsKCQlBbmltYWwuaW1wbGVtZW50KHsKCQkJc2V0TmFtZTogZnVuY3Rpb24obmFtZSl7CgkJCQl0aGlzLm5hbWUgPSBuYW1lCgkJCX0KCQl9KTsKCQl2YXIgbXlBbmltYWwgPSBuZXcgQW5pbWFsKDIwKTsKCQlteUFuaW1hbC5zZXROYW1lKCdNaWNpYScpOwoJCWFsZXJ0KG15QW5pbWFsLm5hbWUpOyAvL2FsZXJ0cyAnTWljaWEnCgkJKGVuZCkKCSovCgoJaW1wbGVtZW50OiBmdW5jdGlvbigpewoJCWZvciAodmFyIGkgPSAwLCBsID0gYXJndW1lbnRzLmxlbmd0aDsgaSA8IGw7IGkrKykgJGV4dGVuZCh0aGlzLnByb3RvdHlwZSwgYXJndW1lbnRzW2ldKTsKCX0KCn07CgovL2ludGVybmFsCgpDbGFzcy5NZXJnZSA9IGZ1bmN0aW9uKHByZXZpb3VzLCBjdXJyZW50KXsKCWlmIChwcmV2aW91cyAmJiBwcmV2aW91cyAhPSBjdXJyZW50KXsKCQl2YXIgdHlwZSA9ICR0eXBlKGN1cnJlbnQpOwoJCWlmICh0eXBlICE9ICR0eXBlKHByZXZpb3VzKSkgcmV0dXJuIGN1cnJlbnQ7CgkJc3dpdGNoKHR5cGUpewoJCQljYXNlICdmdW5jdGlvbic6CgkJCQl2YXIgbWVyZ2VkID0gZnVuY3Rpb24oKXsKCQkJCQl0aGlzLnBhcmVudCA9IGFyZ3VtZW50cy5jYWxsZWUucGFyZW50OwoJCQkJCXJldHVybiBjdXJyZW50LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CgkJCQl9OwoJCQkJbWVyZ2VkLnBhcmVudCA9IHByZXZpb3VzOwoJCQkJcmV0dXJuIG1lcmdlZDsKCQkJY2FzZSAnb2JqZWN0JzogcmV0dXJuICRtZXJnZShwcmV2aW91cywgY3VycmVudCk7CgkJfQoJfQoJcmV0dXJuIGN1cnJlbnQ7Cn07CgovKgpTY3JpcHQ6IENsYXNzLkV4dHJhcy5qcwoJQ29udGFpbnMgY29tbW9uIGltcGxlbWVudGF0aW9ucyBmb3IgY3VzdG9tIGNsYXNzZXMuIEluIE1vb3Rvb2xzIGlzIGltcGxlbWVudGVkIGluIDxBamF4PiwgPFhIUj4gYW5kIDxGeC5CYXNlPiBhbmQgbWFueSBtb3JlLgoKTGljZW5zZToKCU1JVC1zdHlsZSBsaWNlbnNlLgoqLwoKLyoKQ2xhc3M6IENoYWluCglBbiAiVXRpbGl0eSIgQ2xhc3MuIEl0cyBtZXRob2RzIGNhbiBiZSBpbXBsZW1lbnRlZCB3aXRoIDxDbGFzcy5pbXBsZW1lbnQ+IGludG8gYW55IDxDbGFzcz4uCglDdXJyZW50bHkgaW1wbGVtZW50ZWQgaW4gPEZ4LkJhc2U+LCA8WEhSPiBhbmQgPEFqYXg+LiBJbiA8RnguQmFzZT4gZm9yIGV4YW1wbGUsIGlzIHVzZWQgdG8gZXhlY3V0ZSBhIGxpc3Qgb2YgZnVuY3Rpb24sIG9uZSBhZnRlciBhbm90aGVyLCBvbmNlIHRoZSBlZmZlY3QgaXMgY29tcGxldGVkLgoJVGhlIGZ1bmN0aW9ucyB3aWxsIG5vdCBiZSBmaXJlZCBhbGwgdG9naGV0ZXIsIGJ1dCBvbmUgZXZlcnkgY29tcGxldGlvbiwgdG8gY3JlYXRlIGN1c3RvbSBjb21wbGV4IGFuaW1hdGlvbnMuCgpFeGFtcGxlOgoJKHN0YXJ0IGNvZGUpCgl2YXIgbXlGeCA9IG5ldyBGeC5TdHlsZSgnZWxlbWVudCcsICdvcGFjaXR5Jyk7CgoJbXlGeC5zdGFydCgxLDApLmNoYWluKGZ1bmN0aW9uKCl7CgkJbXlGeC5zdGFydCgwLDEpOwoJfSkuY2hhaW4oZnVuY3Rpb24oKXsKCQlteUZ4LnN0YXJ0KDEsMCk7Cgl9KS5jaGFpbihmdW5jdGlvbigpewoJCW15Rnguc3RhcnQoMCwxKTsKCX0pOwoJLy90aGUgZWxlbWVudCB3aWxsIGFwcGVhciBhbmQgZGlzYXBwZWFyIHRocmVlIHRpbWVzCgkoZW5kKQoqLwoKdmFyIENoYWluID0gbmV3IENsYXNzKHsKCgkvKgoJUHJvcGVydHk6IGNoYWluCgkJYWRkcyBhIGZ1bmN0aW9uIHRvIHRoZSBDaGFpbiBpbnN0YW5jZSBzdGFjay4KCglBcmd1bWVudHM6CgkJZm4gLSB0aGUgZnVuY3Rpb24gdG8gYXBwZW5kLgoJKi8KCgljaGFpbjogZnVuY3Rpb24oZm4pewoJCXRoaXMuY2hhaW5zID0gdGhpcy5jaGFpbnMgfHwgW107CgkJdGhpcy5jaGFpbnMucHVzaChmbik7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCS8qCglQcm9wZXJ0eTogY2FsbENoYWluCgkJRXhlY3V0ZXMgdGhlIGZpcnN0IGZ1bmN0aW9uIG9mIHRoZSBDaGFpbiBpbnN0YW5jZSBzdGFjaywgdGhlbiByZW1vdmVzIGl0LiBUaGUgZmlyc3QgZnVuY3Rpb24gd2lsbCB0aGVuIGJlY29tZSB0aGUgc2Vjb25kLgoJKi8KCgljYWxsQ2hhaW46IGZ1bmN0aW9uKCl7CgkJaWYgKHRoaXMuY2hhaW5zICYmIHRoaXMuY2hhaW5zLmxlbmd0aCkgdGhpcy5jaGFpbnMuc2hpZnQoKS5kZWxheSgxMCwgdGhpcyk7Cgl9LAoKCS8qCglQcm9wZXJ0eTogY2xlYXJDaGFpbgoJCUNsZWFycyB0aGUgc3RhY2sgb2YgYSBDaGFpbiBpbnN0YW5jZS4KCSovCgoJY2xlYXJDaGFpbjogZnVuY3Rpb24oKXsKCQl0aGlzLmNoYWlucyA9IFtdOwoJfQoKfSk7CgovKgpDbGFzczogRXZlbnRzCglBbiAiVXRpbGl0eSIgQ2xhc3MuIEl0cyBtZXRob2RzIGNhbiBiZSBpbXBsZW1lbnRlZCB3aXRoIDxDbGFzcy5pbXBsZW1lbnQ+IGludG8gYW55IDxDbGFzcz4uCglJbiA8RnguQmFzZT4gQ2xhc3MsIGZvciBleGFtcGxlLCBpcyB1c2VkIHRvIGdpdmUgdGhlIHBvc3NpYmlsaXR5IGFkZCBhbnkgbnVtYmVyIG9mIGZ1bmN0aW9ucyB0byB0aGUgRWZmZWN0cyBldmVudHMsIGxpa2Ugb25Db21wbGV0ZSwgb25TdGFydCwgb25DYW5jZWwuCglFdmVudHMgaW4gYSBDbGFzcyB0aGF0IGltcGxlbWVudHMgPEV2ZW50cz4gY2FuIGJlIGVpdGhlciBhZGRlZCBhcyBhbiBvcHRpb24sIG9yIHdpdGggYWRkRXZlbnQuIE5ldmVyIHdpdGggLm9wdGlvbnMub25FdmVudE5hbWUuCgpFeGFtcGxlOgoJKHN0YXJ0IGNvZGUpCgl2YXIgbXlGeCA9IG5ldyBGeC5TdHlsZSgnZWxlbWVudCcsICdvcGFjaXR5JykuYWRkRXZlbnQoJ29uQ29tcGxldGUnLCBmdW5jdGlvbigpewoJCWFsZXJ0KCd0aGUgZWZmZWN0IGlzIGNvbXBsZXRlZCcpOwoJfSkuYWRkRXZlbnQoJ29uQ29tcGxldGUnLCBmdW5jdGlvbigpewoJCWFsZXJ0KCdJIHRvbGQgeW91IHRoZSBlZmZlY3QgaXMgY29tcGxldGVkJyk7Cgl9KTsKCglteUZ4LnN0YXJ0KDAsMSk7CgkvL3Vwb24gY29tcGxldGlvbiBpdCB3aWxsIGRpc3BsYXkgdGhlIDIgYWxlcnRzLCBpbiBvcmRlci4KCShlbmQpCgpJbXBsZW1lbnRpbmc6CglUaGlzIGNsYXNzIGNhbiBiZSBpbXBsZW1lbnRlZCBpbnRvIG90aGVyIGNsYXNzZXMgdG8gYWRkIHRoZSBmdW5jdGlvbmFsaXR5IHRvIHRoZW0uCglHb2VzIHdlbGwgd2l0aCB0aGUgPE9wdGlvbnM+IGNsYXNzLgoKRXhhbXBsZToKCShzdGFydCBjb2RlKQoJdmFyIFdpZGdldCA9IG5ldyBDbGFzcyh7CgkJaW5pdGlhbGl6ZTogZnVuY3Rpb24oKXt9LAoJCWZpbmlzaDogZnVuY3Rpb24oKXsKCQkJdGhpcy5maXJlRXZlbnQoJ29uQ29tcGxldGUnKTsKCQl9Cgl9KTsKCVdpZGdldC5pbXBsZW1lbnQobmV3IEV2ZW50cyk7CgkvL2xhdGVyLi4uCgl2YXIgbXlXaWRnZXQgPSBuZXcgV2lkZ2V0KCk7CglteVdpZGdldC5hZGRFdmVudCgnb25Db21wbGV0ZScsIG15ZnVuY3Rpb24pOwoJKGVuZCkKKi8KCnZhciBFdmVudHMgPSBuZXcgQ2xhc3MoewoKCS8qCglQcm9wZXJ0eTogYWRkRXZlbnQKCQlhZGRzIGFuIGV2ZW50IHRvIHRoZSBzdGFjayBvZiBldmVudHMgb2YgdGhlIENsYXNzIGluc3RhbmNlLgoKCUFyZ3VtZW50czoKCQl0eXBlIC0gc3RyaW5nOyB0aGUgZXZlbnQgbmFtZSAoZS5nLiAnb25Db21wbGV0ZScpCgkJZm4gLSBmdW5jdGlvbiB0byBleGVjdXRlCgkqLwoKCWFkZEV2ZW50OiBmdW5jdGlvbih0eXBlLCBmbil7CgkJaWYgKGZuICE9IENsYXNzLmVtcHR5KXsKCQkJdGhpcy4kZXZlbnRzID0gdGhpcy4kZXZlbnRzIHx8IHt9OwoJCQl0aGlzLiRldmVudHNbdHlwZV0gPSB0aGlzLiRldmVudHNbdHlwZV0gfHwgW107CgkJCXRoaXMuJGV2ZW50c1t0eXBlXS5pbmNsdWRlKGZuKTsKCQl9CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCS8qCglQcm9wZXJ0eTogZmlyZUV2ZW50CgkJZmlyZXMgYWxsIGV2ZW50cyBvZiB0aGUgc3BlY2lmaWVkIHR5cGUgaW4gdGhlIENsYXNzIGluc3RhbmNlLgoKCUFyZ3VtZW50czoKCQl0eXBlIC0gc3RyaW5nOyB0aGUgZXZlbnQgbmFtZSAoZS5nLiAnb25Db21wbGV0ZScpCgkJYXJncyAtIGFycmF5IG9yIHNpbmdsZSBvYmplY3Q7IGFyZ3VtZW50cyB0byBwYXNzIHRvIHRoZSBmdW5jdGlvbjsgaWYgbW9yZSB0aGFuIG9uZSBhcmd1bWVudCwgbXVzdCBiZSBhbiBhcnJheQoJCWRlbGF5IC0gKGludGVnZXIpIGRlbGF5IChpbiBtcykgdG8gd2FpdCB0byBleGVjdXRlIHRoZSBldmVudAoKCUV4YW1wbGU6Cgkoc3RhcnQgY29kZSkKCXZhciBXaWRnZXQgPSBuZXcgQ2xhc3MoewoJCWluaXRpYWxpemU6IGZ1bmN0aW9uKGFyZzEsIGFyZzIpewoJCQkuLi4KCQkJdGhpcy5maXJlRXZlbnQoIm9uSW5pdGlhbGl6ZSIsIFthcmcxLCBhcmcyXSwgNTApOwoJCX0KCX0pOwoJV2lkZ2V0LmltcGxlbWVudChuZXcgRXZlbnRzKTsKCShlbmQpCgkqLwoKCWZpcmVFdmVudDogZnVuY3Rpb24odHlwZSwgYXJncywgZGVsYXkpewoJCWlmICh0aGlzLiRldmVudHMgJiYgdGhpcy4kZXZlbnRzW3R5cGVdKXsKCQkJdGhpcy4kZXZlbnRzW3R5cGVdLmVhY2goZnVuY3Rpb24oZm4pewoJCQkJZm4uY3JlYXRlKHsnYmluZCc6IHRoaXMsICdkZWxheSc6IGRlbGF5LCAnYXJndW1lbnRzJzogYXJnc30pKCk7CgkJCX0sIHRoaXMpOwoJCX0KCQlyZXR1cm4gdGhpczsKCX0sCgoJLyoKCVByb3BlcnR5OiByZW1vdmVFdmVudAoJCXJlbW92ZXMgYW4gZXZlbnQgZnJvbSB0aGUgc3RhY2sgb2YgZXZlbnRzIG9mIHRoZSBDbGFzcyBpbnN0YW5jZS4KCglBcmd1bWVudHM6CgkJdHlwZSAtIHN0cmluZzsgdGhlIGV2ZW50IG5hbWUgKGUuZy4gJ29uQ29tcGxldGUnKQoJCWZuIC0gZnVuY3Rpb24gdGhhdCB3YXMgYWRkZWQKCSovCgoJcmVtb3ZlRXZlbnQ6IGZ1bmN0aW9uKHR5cGUsIGZuKXsKCQlpZiAodGhpcy4kZXZlbnRzICYmIHRoaXMuJGV2ZW50c1t0eXBlXSkgdGhpcy4kZXZlbnRzW3R5cGVdLnJlbW92ZShmbik7CgkJcmV0dXJuIHRoaXM7Cgl9Cgp9KTsKCi8qCkNsYXNzOiBPcHRpb25zCglBbiAiVXRpbGl0eSIgQ2xhc3MuIEl0cyBtZXRob2RzIGNhbiBiZSBpbXBsZW1lbnRlZCB3aXRoIDxDbGFzcy5pbXBsZW1lbnQ+IGludG8gYW55IDxDbGFzcz4uCglVc2VkIHRvIGF1dG9tYXRlIHRoZSBvcHRpb25zIHNldHRpbmdzLCBhbHNvIGFkZGluZyBDbGFzcyA8RXZlbnRzPiB3aGVuIHRoZSBvcHRpb24gYmVnaW5zIHdpdGggb24uCgoJRXhhbXBsZToKCQkoc3RhcnQgY29kZSkKCQl2YXIgV2lkZ2V0ID0gbmV3IENsYXNzKHsKCQkJb3B0aW9uczogewoJCQkJY29sb3I6ICcjZmZmJywKCQkJCXNpemU6IHsKCQkJCQl3aWR0aDogMTAwCgkJCQkJaGVpZ2h0OiAxMDAKCQkJCX0KCQkJfSwKCQkJaW5pdGlhbGl6ZTogZnVuY3Rpb24ob3B0aW9ucyl7CgkJCQl0aGlzLnNldE9wdGlvbnMob3B0aW9ucyk7CgkJCX0KCQl9KTsKCQlXaWRnZXQuaW1wbGVtZW50KG5ldyBPcHRpb25zKTsKCQkvL2xhdGVyLi4uCgkJdmFyIG15V2lkZ2V0ID0gbmV3IFdpZGdldCh7CgkJCWNvbG9yOiAnI2YwMCcsCgkJCXNpemU6IHsKCQkJCXdpZHRoOiAyMDAKCQkJfQoJCX0pOwoJCS8vbXlXaWRnZXQub3B0aW9ucyA9IHtjb2xvcjogI2YwMCwgc2l6ZToge3dpZHRoOiAyMDAsIGhlaWdodDogMTAwfX0KCQkoZW5kKQoqLwoKdmFyIE9wdGlvbnMgPSBuZXcgQ2xhc3MoewoKCS8qCglQcm9wZXJ0eTogc2V0T3B0aW9ucwoJCXNldHMgdGhpcy5vcHRpb25zCgoJQXJndW1lbnRzOgoJCWRlZmF1bHRzIC0gb2JqZWN0OyB0aGUgZGVmYXVsdCBzZXQgb2Ygb3B0aW9ucwoJCW9wdGlvbnMgLSBvYmplY3Q7IHRoZSB1c2VyIGVudGVyZWQgb3B0aW9ucy4gY2FuIGJlIGVtcHR5IHRvby4KCglOb3RlOgoJCWlmIHlvdXIgQ2xhc3MgaGFzIDxFdmVudHM+IGltcGxlbWVudGVkLCBldmVyeSBvcHRpb24gYmVnaW5uaW5nIHdpdGggb24sIGZvbGxvd2VkIGJ5IGEgY2FwaXRhbCBsZXR0ZXIgKG9uQ29tcGxldGUpIGJlY29tZXMgYW4gQ2xhc3MgaW5zdGFuY2UgZXZlbnQuCgkqLwoKCXNldE9wdGlvbnM6IGZ1bmN0aW9uKCl7CgkJdGhpcy5vcHRpb25zID0gJG1lcmdlLmFwcGx5KG51bGwsIFt0aGlzLm9wdGlvbnNdLmV4dGVuZChhcmd1bWVudHMpKTsKCQlpZiAodGhpcy5hZGRFdmVudCl7CgkJCWZvciAodmFyIG9wdGlvbiBpbiB0aGlzLm9wdGlvbnMpewoJCQkJaWYgKCR0eXBlKHRoaXMub3B0aW9uc1tvcHRpb25dID09ICdmdW5jdGlvbicpICYmICgvXm9uW0EtWl0vKS50ZXN0KG9wdGlvbikpIHRoaXMuYWRkRXZlbnQob3B0aW9uLCB0aGlzLm9wdGlvbnNbb3B0aW9uXSk7CgkJCX0KCQl9CgkJcmV0dXJuIHRoaXM7Cgl9Cgp9KTsKCi8qClNjcmlwdDogQXJyYXkuanMKCUNvbnRhaW5zIEFycmF5IHByb3RvdHlwZXMsIDwkQT4sIDwkZWFjaD4KCkxpY2Vuc2U6CglNSVQtc3R5bGUgbGljZW5zZS4KKi8KCi8qCkNsYXNzOiBBcnJheQoJQSBjb2xsZWN0aW9uIG9mIFRoZSBBcnJheSBPYmplY3QgcHJvdG90eXBlIG1ldGhvZHMuCiovCgovL2N1c3RvbSBtZXRob2RzCgpBcnJheS5leHRlbmQoewoKCS8qCglQcm9wZXJ0eTogZm9yRWFjaAoJCUl0ZXJhdGVzIHRocm91Z2ggYW4gYXJyYXk7IFRoaXMgbWV0aG9kIGlzIG9ubHkgYXZhaWxhYmxlIGZvciBicm93c2VycyB3aXRob3V0IG5hdGl2ZSAqZm9yRWFjaCogc3VwcG9ydC4KCQlGb3IgbW9yZSBpbmZvIHNlZSA8aHR0cDovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi9kb2NzL0NvcmVfSmF2YVNjcmlwdF8xLjVfUmVmZXJlbmNlOkdsb2JhbF9PYmplY3RzOkFycmF5OmZvckVhY2g+CgoJCSpmb3JFYWNoKiBleGVjdXRlcyB0aGUgcHJvdmlkZWQgZnVuY3Rpb24gKGNhbGxiYWNrKSBvbmNlIGZvciBlYWNoIGVsZW1lbnQgcHJlc2VudCBpbiB0aGUgYXJyYXkuIGNhbGxiYWNrIGlzIGludm9rZWQgb25seSBmb3IgaW5kZXhlcyBvZiB0aGUgYXJyYXkgd2hpY2ggaGF2ZSBhc3NpZ25lZCB2YWx1ZXM7IGl0IGlzIG5vdCBpbnZva2VkIGZvciBpbmRleGVzIHdoaWNoIGhhdmUgYmVlbiBkZWxldGVkIG9yIHdoaWNoIGhhdmUgbmV2ZXIgYmVlbiBhc3NpZ25lZCB2YWx1ZXMuCgoJQXJndW1lbnRzOgoJCWZuIC0gZnVuY3Rpb24gdG8gZXhlY3V0ZSB3aXRoIGVhY2ggaXRlbSBpbiB0aGUgYXJyYXk7IHBhc3NlZCB0aGUgaXRlbSBhbmQgdGhlIGluZGV4IG9mIHRoYXQgaXRlbSBpbiB0aGUgYXJyYXkKCQliaW5kIC0gdGhlIG9iamVjdCB0byBiaW5kICJ0aGlzIiB0byAoc2VlIDxGdW5jdGlvbi5iaW5kPikKCglFeGFtcGxlOgoJCT5bJ2FwcGxlJywnYmFuYW5hJywnbGVtb24nXS5lYWNoKGZ1bmN0aW9uKGl0ZW0sIGluZGV4KXsKCQk+CWFsZXJ0KGluZGV4ICsgIiA9ICIgKyBpdGVtKTsgLy9hbGVydHMgIjAgPSBhcHBsZSIgZXRjLgoJCT59LCBiaW5kT2JqKTsgLy9vcHRpb25hbCBzZWNvbmQgYXJnIGZvciBiaW5kaW5nLCBub3QgdXNlZCBoZXJlCgkqLwoKCWZvckVhY2g6IGZ1bmN0aW9uKGZuLCBiaW5kKXsKCQlmb3IgKHZhciBpID0gMCwgaiA9IHRoaXMubGVuZ3RoOyBpIDwgajsgaSsrKSBmbi5jYWxsKGJpbmQsIHRoaXNbaV0sIGksIHRoaXMpOwoJfSwKCgkvKgoJUHJvcGVydHk6IGZpbHRlcgoJCVRoaXMgbWV0aG9kIGlzIHByb3ZpZGVkIG9ubHkgZm9yIGJyb3dzZXJzIHdpdGhvdXQgbmF0aXZlICpmaWx0ZXIqIHN1cHBvcnQuCgkJRm9yIG1vcmUgaW5mbyBzZWUgPGh0dHA6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4vZG9jcy9Db3JlX0phdmFTY3JpcHRfMS41X1JlZmVyZW5jZTpPYmplY3RzOkFycmF5OmZpbHRlcj4KCgkJKmZpbHRlciogY2FsbHMgYSBwcm92aWRlZCBjYWxsYmFjayBmdW5jdGlvbiBvbmNlIGZvciBlYWNoIGVsZW1lbnQgaW4gYW4gYXJyYXksIGFuZCBjb25zdHJ1Y3RzIGEgbmV3IGFycmF5IG9mIGFsbCB0aGUgdmFsdWVzIGZvciB3aGljaCBjYWxsYmFjayByZXR1cm5zIGEgdHJ1ZSB2YWx1ZS4gY2FsbGJhY2sgaXMgaW52b2tlZCBvbmx5IGZvciBpbmRleGVzIG9mIHRoZSBhcnJheSB3aGljaCBoYXZlIGFzc2lnbmVkIHZhbHVlczsgaXQgaXMgbm90IGludm9rZWQgZm9yIGluZGV4ZXMgd2hpY2ggaGF2ZSBiZWVuIGRlbGV0ZWQgb3Igd2hpY2ggaGF2ZSBuZXZlciBiZWVuIGFzc2lnbmVkIHZhbHVlcy4gQXJyYXkgZWxlbWVudHMgd2hpY2ggZG8gbm90IHBhc3MgdGhlIGNhbGxiYWNrIHRlc3QgYXJlIHNpbXBseSBza2lwcGVkLCBhbmQgYXJlIG5vdCBpbmNsdWRlZCBpbiB0aGUgbmV3IGFycmF5LgoKCUFyZ3VtZW50czoKCQlmbiAtIGZ1bmN0aW9uIHRvIGV4ZWN1dGUgd2l0aCBlYWNoIGl0ZW0gaW4gdGhlIGFycmF5OyBwYXNzZWQgdGhlIGl0ZW0gYW5kIHRoZSBpbmRleCBvZiB0aGF0IGl0ZW0gaW4gdGhlIGFycmF5CgkJYmluZCAtIHRoZSBvYmplY3QgdG8gYmluZCAidGhpcyIgdG8gKHNlZSA8RnVuY3Rpb24uYmluZD4pCgoJRXhhbXBsZToKCQk+dmFyIGJpZ2dlclRoYW5Ud2VudHkgPSBbMTAsMywyNSwxMDBdLmZpbHRlcihmdW5jdGlvbihpdGVtLCBpbmRleCl7CgkJPiByZXR1cm4gaXRlbSA+IDIwOwoJCT59KTsKCQk+Ly9iaWdnZXJUaGFuVHdlbnR5ID0gWzI1LDEwMF0KCSovCgoJZmlsdGVyOiBmdW5jdGlvbihmbiwgYmluZCl7CgkJdmFyIHJlc3VsdHMgPSBbXTsKCQlmb3IgKHZhciBpID0gMCwgaiA9IHRoaXMubGVuZ3RoOyBpIDwgajsgaSsrKXsKCQkJaWYgKGZuLmNhbGwoYmluZCwgdGhpc1tpXSwgaSwgdGhpcykpIHJlc3VsdHMucHVzaCh0aGlzW2ldKTsKCQl9CgkJcmV0dXJuIHJlc3VsdHM7Cgl9LAoKCS8qCglQcm9wZXJ0eTogbWFwCgkJVGhpcyBtZXRob2QgaXMgcHJvdmlkZWQgb25seSBmb3IgYnJvd3NlcnMgd2l0aG91dCBuYXRpdmUgKm1hcCogc3VwcG9ydC4KCQlGb3IgbW9yZSBpbmZvIHNlZSA8aHR0cDovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi9kb2NzL0NvcmVfSmF2YVNjcmlwdF8xLjVfUmVmZXJlbmNlOkdsb2JhbF9PYmplY3RzOkFycmF5Om1hcD4KCgkJKm1hcCogY2FsbHMgYSBwcm92aWRlZCBjYWxsYmFjayBmdW5jdGlvbiBvbmNlIGZvciBlYWNoIGVsZW1lbnQgaW4gYW4gYXJyYXksIGluIG9yZGVyLCBhbmQgY29uc3RydWN0cyBhIG5ldyBhcnJheSBmcm9tIHRoZSByZXN1bHRzLiBjYWxsYmFjayBpcyBpbnZva2VkIG9ubHkgZm9yIGluZGV4ZXMgb2YgdGhlIGFycmF5IHdoaWNoIGhhdmUgYXNzaWduZWQgdmFsdWVzOyBpdCBpcyBub3QgaW52b2tlZCBmb3IgaW5kZXhlcyB3aGljaCBoYXZlIGJlZW4gZGVsZXRlZCBvciB3aGljaCBoYXZlIG5ldmVyIGJlZW4gYXNzaWduZWQgdmFsdWVzLgoKCUFyZ3VtZW50czoKCQlmbiAtIGZ1bmN0aW9uIHRvIGV4ZWN1dGUgd2l0aCBlYWNoIGl0ZW0gaW4gdGhlIGFycmF5OyBwYXNzZWQgdGhlIGl0ZW0gYW5kIHRoZSBpbmRleCBvZiB0aGF0IGl0ZW0gaW4gdGhlIGFycmF5CgkJYmluZCAtIHRoZSBvYmplY3QgdG8gYmluZCAidGhpcyIgdG8gKHNlZSA8RnVuY3Rpb24uYmluZD4pCgoJRXhhbXBsZToKCQk+dmFyIHRpbWVzVHdvID0gWzEsMiwzXS5tYXAoZnVuY3Rpb24oaXRlbSwgaW5kZXgpewoJCT4gcmV0dXJuIGl0ZW0qMjsKCQk+fSk7CgkJPi8vdGltZXNUd28gPSBbMiw0LDZdOwoJKi8KCgltYXA6IGZ1bmN0aW9uKGZuLCBiaW5kKXsKCQl2YXIgcmVzdWx0cyA9IFtdOwoJCWZvciAodmFyIGkgPSAwLCBqID0gdGhpcy5sZW5ndGg7IGkgPCBqOyBpKyspIHJlc3VsdHNbaV0gPSBmbi5jYWxsKGJpbmQsIHRoaXNbaV0sIGksIHRoaXMpOwoJCXJldHVybiByZXN1bHRzOwoJfSwKCgkvKgoJUHJvcGVydHk6IGV2ZXJ5CgkJVGhpcyBtZXRob2QgaXMgcHJvdmlkZWQgb25seSBmb3IgYnJvd3NlcnMgd2l0aG91dCBuYXRpdmUgKmV2ZXJ5KiBzdXBwb3J0LgoJCUZvciBtb3JlIGluZm8gc2VlIDxodHRwOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuL2RvY3MvQ29yZV9KYXZhU2NyaXB0XzEuNV9SZWZlcmVuY2U6R2xvYmFsX09iamVjdHM6QXJyYXk6ZXZlcnk+CgoJCSpldmVyeSogZXhlY3V0ZXMgdGhlIHByb3ZpZGVkIGNhbGxiYWNrIGZ1bmN0aW9uIG9uY2UgZm9yIGVhY2ggZWxlbWVudCBwcmVzZW50IGluIHRoZSBhcnJheSB1bnRpbCBpdCBmaW5kcyBvbmUgd2hlcmUgY2FsbGJhY2sgcmV0dXJucyBhIGZhbHNlIHZhbHVlLiBJZiBzdWNoIGFuIGVsZW1lbnQgaXMgZm91bmQsIHRoZSBldmVyeSBtZXRob2QgaW1tZWRpYXRlbHkgcmV0dXJucyBmYWxzZS4gT3RoZXJ3aXNlLCBpZiBjYWxsYmFjayByZXR1cm5lZCBhIHRydWUgdmFsdWUgZm9yIGFsbCBlbGVtZW50cywgZXZlcnkgd2lsbCByZXR1cm4gdHJ1ZS4gY2FsbGJhY2sgaXMgaW52b2tlZCBvbmx5IGZvciBpbmRleGVzIG9mIHRoZSBhcnJheSB3aGljaCBoYXZlIGFzc2lnbmVkIHZhbHVlczsgaXQgaXMgbm90IGludm9rZWQgZm9yIGluZGV4ZXMgd2hpY2ggaGF2ZSBiZWVuIGRlbGV0ZWQgb3Igd2hpY2ggaGF2ZSBuZXZlciBiZWVuIGFzc2lnbmVkIHZhbHVlcy4KCglBcmd1bWVudHM6CgkJZm4gLSBmdW5jdGlvbiB0byBleGVjdXRlIHdpdGggZWFjaCBpdGVtIGluIHRoZSBhcnJheTsgcGFzc2VkIHRoZSBpdGVtIGFuZCB0aGUgaW5kZXggb2YgdGhhdCBpdGVtIGluIHRoZSBhcnJheQoJCWJpbmQgLSB0aGUgb2JqZWN0IHRvIGJpbmQgInRoaXMiIHRvIChzZWUgPEZ1bmN0aW9uLmJpbmQ+KQoKCUV4YW1wbGU6CgkJPnZhciBhcmVBbGxCaWdFbm91Z2ggPSBbMTAsNCwyNSwxMDBdLmV2ZXJ5KGZ1bmN0aW9uKGl0ZW0sIGluZGV4KXsKCQk+IHJldHVybiBpdGVtID4gMjA7CgkJPn0pOwoJCT4vL2FyZUFsbEJpZ0Vub3VnaCA9IGZhbHNlCgkqLwoKCWV2ZXJ5OiBmdW5jdGlvbihmbiwgYmluZCl7CgkJZm9yICh2YXIgaSA9IDAsIGogPSB0aGlzLmxlbmd0aDsgaSA8IGo7IGkrKyl7CgkJCWlmICghZm4uY2FsbChiaW5kLCB0aGlzW2ldLCBpLCB0aGlzKSkgcmV0dXJuIGZhbHNlOwoJCX0KCQlyZXR1cm4gdHJ1ZTsKCX0sCgoJLyoKCVByb3BlcnR5OiBzb21lCgkJVGhpcyBtZXRob2QgaXMgcHJvdmlkZWQgb25seSBmb3IgYnJvd3NlcnMgd2l0aG91dCBuYXRpdmUgKnNvbWUqIHN1cHBvcnQuCgkJRm9yIG1vcmUgaW5mbyBzZWUgPGh0dHA6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4vZG9jcy9Db3JlX0phdmFTY3JpcHRfMS41X1JlZmVyZW5jZTpHbG9iYWxfT2JqZWN0czpBcnJheTpzb21lPgoKCQkqc29tZSogZXhlY3V0ZXMgdGhlIGNhbGxiYWNrIGZ1bmN0aW9uIG9uY2UgZm9yIGVhY2ggZWxlbWVudCBwcmVzZW50IGluIHRoZSBhcnJheSB1bnRpbCBpdCBmaW5kcyBvbmUgd2hlcmUgY2FsbGJhY2sgcmV0dXJucyBhIHRydWUgdmFsdWUuIElmIHN1Y2ggYW4gZWxlbWVudCBpcyBmb3VuZCwgc29tZSBpbW1lZGlhdGVseSByZXR1cm5zIHRydWUuIE90aGVyd2lzZSwgc29tZSByZXR1cm5zIGZhbHNlLiBjYWxsYmFjayBpcyBpbnZva2VkIG9ubHkgZm9yIGluZGV4ZXMgb2YgdGhlIGFycmF5IHdoaWNoIGhhdmUgYXNzaWduZWQgdmFsdWVzOyBpdCBpcyBub3QgaW52b2tlZCBmb3IgaW5kZXhlcyB3aGljaCBoYXZlIGJlZW4gZGVsZXRlZCBvciB3aGljaCBoYXZlIG5ldmVyIGJlZW4gYXNzaWduZWQgdmFsdWVzLgoKCUFyZ3VtZW50czoKCQlmbiAtIGZ1bmN0aW9uIHRvIGV4ZWN1dGUgd2l0aCBlYWNoIGl0ZW0gaW4gdGhlIGFycmF5OyBwYXNzZWQgdGhlIGl0ZW0gYW5kIHRoZSBpbmRleCBvZiB0aGF0IGl0ZW0gaW4gdGhlIGFycmF5CgkJYmluZCAtIHRoZSBvYmplY3QgdG8gYmluZCAidGhpcyIgdG8gKHNlZSA8RnVuY3Rpb24uYmluZD4pCgoJRXhhbXBsZToKCQk+dmFyIGlzQW55QmlnRW5vdWdoID0gWzEwLDQsMjUsMTAwXS5zb21lKGZ1bmN0aW9uKGl0ZW0sIGluZGV4KXsKCQk+IHJldHVybiBpdGVtID4gMjA7CgkJPn0pOwoJCT4vL2lzQW55QmlnRW5vdWdoID0gdHJ1ZQoJKi8KCglzb21lOiBmdW5jdGlvbihmbiwgYmluZCl7CgkJZm9yICh2YXIgaSA9IDAsIGogPSB0aGlzLmxlbmd0aDsgaSA8IGo7IGkrKyl7CgkJCWlmIChmbi5jYWxsKGJpbmQsIHRoaXNbaV0sIGksIHRoaXMpKSByZXR1cm4gdHJ1ZTsKCQl9CgkJcmV0dXJuIGZhbHNlOwoJfSwKCgkvKgoJUHJvcGVydHk6IGluZGV4T2YKCQlUaGlzIG1ldGhvZCBpcyBwcm92aWRlZCBvbmx5IGZvciBicm93c2VycyB3aXRob3V0IG5hdGl2ZSAqaW5kZXhPZiogc3VwcG9ydC4KCQlGb3IgbW9yZSBpbmZvIHNlZSA8aHR0cDovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi9kb2NzL0NvcmVfSmF2YVNjcmlwdF8xLjVfUmVmZXJlbmNlOkdsb2JhbF9PYmplY3RzOkFycmF5OmluZGV4T2Y+CgoJCSppbmRleE9mKiBjb21wYXJlcyBhIHNlYXJjaCBlbGVtZW50IHRvIGVsZW1lbnRzIG9mIHRoZSBBcnJheSB1c2luZyBzdHJpY3QgZXF1YWxpdHkgKHRoZSBzYW1lIG1ldGhvZCB1c2VkIGJ5IHRoZSA9PT0sIG9yIHRyaXBsZS1lcXVhbHMsIG9wZXJhdG9yKS4KCglBcmd1bWVudHM6CgkJaXRlbSAtIGFueSB0eXBlIG9mIG9iamVjdDsgZWxlbWVudCB0byBsb2NhdGUgaW4gdGhlIGFycmF5CgkJZnJvbSAtIGludGVnZXI7IG9wdGlvbmFsOyB0aGUgaW5kZXggb2YgdGhlIGFycmF5IGF0IHdoaWNoIHRvIGJlZ2luIHRoZSBzZWFyY2ggKGRlZmF1bHRzIHRvIDApCgoJRXhhbXBsZToKCQk+WydhcHBsZScsJ2xlbW9uJywnYmFuYW5hJ10uaW5kZXhPZignbGVtb24nKTsgLy9yZXR1cm5zIDEKCQk+WydhcHBsZScsJ2xlbW9uJ10uaW5kZXhPZignYmFuYW5hJyk7IC8vcmV0dXJucyAtMQoJKi8KCglpbmRleE9mOiBmdW5jdGlvbihpdGVtLCBmcm9tKXsKCQl2YXIgbGVuID0gdGhpcy5sZW5ndGg7CgkJZm9yICh2YXIgaSA9IChmcm9tIDwgMCkgPyBNYXRoLm1heCgwLCBsZW4gKyBmcm9tKSA6IGZyb20gfHwgMDsgaSA8IGxlbjsgaSsrKXsKCQkJaWYgKHRoaXNbaV0gPT09IGl0ZW0pIHJldHVybiBpOwoJCX0KCQlyZXR1cm4gLTE7Cgl9LAoKCS8qCglQcm9wZXJ0eTogZWFjaAoJCVNhbWUgYXMgPEFycmF5LmZvckVhY2g+LgoKCUFyZ3VtZW50czoKCQlmbiAtIGZ1bmN0aW9uIHRvIGV4ZWN1dGUgd2l0aCBlYWNoIGl0ZW0gaW4gdGhlIGFycmF5OyBwYXNzZWQgdGhlIGl0ZW0gYW5kIHRoZSBpbmRleCBvZiB0aGF0IGl0ZW0gaW4gdGhlIGFycmF5CgkJYmluZCAtIG9wdGlvbmFsLCB0aGUgb2JqZWN0IHRoYXQgdGhlICJ0aGlzIiBvZiB0aGUgZnVuY3Rpb24gd2lsbCByZWZlciB0by4KCglFeGFtcGxlOgoJCT52YXIgQW5pbWFscyA9IFsnQ2F0JywgJ0RvZycsICdDb2FsYSddOwoJCT5BbmltYWxzLmVhY2goZnVuY3Rpb24oYW5pbWFsKXsKCQk+CWRvY3VtZW50LndyaXRlKGFuaW1hbCkKCQk+fSk7CgkqLwoKCS8qCglQcm9wZXJ0eTogY29weQoJCXJldHVybnMgYSBjb3B5IG9mIHRoZSBhcnJheS4KCglSZXR1cm5zOgoJCWEgbmV3IGFycmF5IHdoaWNoIGlzIGEgY29weSBvZiB0aGUgY3VycmVudCBvbmUuCgoJQXJndW1lbnRzOgoJCXN0YXJ0IC0gaW50ZWdlcjsgb3B0aW9uYWw7IHRoZSBpbmRleCB3aGVyZSB0byBzdGFydCB0aGUgY29weSwgZGVmYXVsdCBpcyAwLiBJZiBuZWdhdGl2ZSwgaXQgaXMgdGFrZW4gYXMgdGhlIG9mZnNldCBmcm9tIHRoZSBlbmQgb2YgdGhlIGFycmF5LgoJCWxlbmd0aCAtIGludGVnZXI7IG9wdGlvbmFsOyB0aGUgbnVtYmVyIG9mIGVsZW1lbnRzIHRvIGNvcHkuIEJ5IGRlZmF1bHQsIGNvcGllcyBhbGwgZWxlbWVudHMgZnJvbSBzdGFydCB0byB0aGUgZW5kIG9mIHRoZSBhcnJheS4KCglFeGFtcGxlOgoJCT52YXIgbGV0dGVycyA9IFsiYSIsImIiLCJjIl07CgkJPnZhciBjb3B5ID0gbGV0dGVycy5jb3B5KCk7CQkvLyBbImEiLCJiIiwiYyJdIChuZXcgaW5zdGFuY2UpCgkqLwoKCWNvcHk6IGZ1bmN0aW9uKHN0YXJ0LCBsZW5ndGgpewoJCXN0YXJ0ID0gc3RhcnQgfHwgMDsKCQlpZiAoc3RhcnQgPCAwKSBzdGFydCA9IHRoaXMubGVuZ3RoICsgc3RhcnQ7CgkJbGVuZ3RoID0gbGVuZ3RoIHx8ICh0aGlzLmxlbmd0aCAtIHN0YXJ0KTsKCQl2YXIgbmV3QXJyYXkgPSBbXTsKCQlmb3IgKHZhciBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSBuZXdBcnJheVtpXSA9IHRoaXNbc3RhcnQrK107CgkJcmV0dXJuIG5ld0FycmF5OwoJfSwKCgkvKgoJUHJvcGVydHk6IHJlbW92ZQoJCVJlbW92ZXMgYWxsIG9jY3VycmVuY2VzIG9mIGFuIGl0ZW0gZnJvbSB0aGUgYXJyYXkuCgoJQXJndW1lbnRzOgoJCWl0ZW0gLSB0aGUgaXRlbSB0byByZW1vdmUKCglSZXR1cm5zOgoJCXRoZSBBcnJheSB3aXRoIGFsbCBvY2N1cnJlbmNlcyBvZiB0aGUgaXRlbSByZW1vdmVkLgoKCUV4YW1wbGU6CgkJPlsiMSIsIjIiLCIzIiwiMiJdLnJlbW92ZSgiMiIpIC8vIFsiMSIsIjMiXTsKCSovCgoJcmVtb3ZlOiBmdW5jdGlvbihpdGVtKXsKCQl2YXIgaSA9IDA7CgkJdmFyIGxlbiA9IHRoaXMubGVuZ3RoOwoJCXdoaWxlIChpIDwgbGVuKXsKCQkJaWYgKHRoaXNbaV0gPT09IGl0ZW0pewoJCQkJdGhpcy5zcGxpY2UoaSwgMSk7CgkJCQlsZW4tLTsKCQkJfSBlbHNlIHsKCQkJCWkrKzsKCQkJfQoJCX0KCQlyZXR1cm4gdGhpczsKCX0sCgoJLyoKCVByb3BlcnR5OiBjb250YWlucwoJCVRlc3RzIGFuIGFycmF5IGZvciB0aGUgcHJlc2VuY2Ugb2YgYW4gaXRlbS4KCglBcmd1bWVudHM6CgkJaXRlbSAtIHRoZSBpdGVtIHRvIHNlYXJjaCBmb3IgaW4gdGhlIGFycmF5LgoJCWZyb20gLSBpbnRlZ2VyOyBvcHRpb25hbDsgdGhlIGluZGV4IGF0IHdoaWNoIHRvIGJlZ2luIHRoZSBzZWFyY2gsIGRlZmF1bHQgaXMgMC4gSWYgbmVnYXRpdmUsIGl0IGlzIHRha2VuIGFzIHRoZSBvZmZzZXQgZnJvbSB0aGUgZW5kIG9mIHRoZSBhcnJheS4KCglSZXR1cm5zOgoJCXRydWUgLSB0aGUgaXRlbSB3YXMgZm91bmQKCQlmYWxzZSAtIGl0IHdhc24ndAoKCUV4YW1wbGU6CgkJPlsiYSIsImIiLCJjIl0uY29udGFpbnMoImEiKTsgLy8gdHJ1ZQoJCT5bImEiLCJiIiwiYyJdLmNvbnRhaW5zKCJkIik7IC8vIGZhbHNlCgkqLwoKCWNvbnRhaW5zOiBmdW5jdGlvbihpdGVtLCBmcm9tKXsKCQlyZXR1cm4gdGhpcy5pbmRleE9mKGl0ZW0sIGZyb20pICE9IC0xOwoJfSwKCgkvKgoJUHJvcGVydHk6IGFzc29jaWF0ZQoJCUNyZWF0ZXMgYW4gb2JqZWN0IHdpdGgga2V5LXZhbHVlIHBhaXJzIGJhc2VkIG9uIHRoZSBhcnJheSBvZiBrZXl3b3JkcyBwYXNzZWQgaW4KCQlhbmQgdGhlIGN1cnJlbnQgY29udGVudCBvZiB0aGUgYXJyYXkuCgoJQXJndW1lbnRzOgoJCWtleXMgLSB0aGUgYXJyYXkgb2Yga2V5d29yZHMuCgoJRXhhbXBsZToKCQkoc3RhcnQgY29kZSkKCQl2YXIgQW5pbWFscyA9IFsnQ2F0JywgJ0RvZycsICdDb2FsYScsICdMaXphcmQnXTsKCQl2YXIgU3BlZWNoID0gWydNaWFvJywgJ0JhdScsICdGcnV1dScsICdNdXRlJ107CgkJdmFyIFNwZWVjaGVzID0gQW5pbWFscy5hc3NvY2lhdGUoU3BlZWNoKTsKCQkvL1NwZWVjaGVzWydNaWFvJ10gaXMgbm93IENhdC4KCQkvL1NwZWVjaGVzWydCYXUnXSBpcyBub3cgRG9nLgoJCS8vLi4uCgkJKGVuZCkKCSovCgoJYXNzb2NpYXRlOiBmdW5jdGlvbihrZXlzKXsKCQl2YXIgb2JqID0ge30sIGxlbmd0aCA9IE1hdGgubWluKHRoaXMubGVuZ3RoLCBrZXlzLmxlbmd0aCk7CgkJZm9yICh2YXIgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgb2JqW2tleXNbaV1dID0gdGhpc1tpXTsKCQlyZXR1cm4gb2JqOwoJfSwKCgkvKgoJUHJvcGVydHk6IGV4dGVuZAoJCUV4dGVuZHMgYW4gYXJyYXkgd2l0aCBhbm90aGVyIG9uZS4KCglBcmd1bWVudHM6CgkJYXJyYXkgLSB0aGUgYXJyYXkgdG8gZXh0ZW5kIG91cnMgd2l0aAoKCUV4YW1wbGU6CgkJPnZhciBBbmltYWxzID0gWydDYXQnLCAnRG9nJywgJ0NvYWxhJ107CgkJPkFuaW1hbHMuZXh0ZW5kKFsnTGl6YXJkJ10pOwoJCT4vL0FuaW1hbHMgaXMgbm93OiBbJ0NhdCcsICdEb2cnLCAnQ29hbGEnLCAnTGl6YXJkJ107CgkqLwoKCWV4dGVuZDogZnVuY3Rpb24oYXJyYXkpewoJCWZvciAodmFyIGkgPSAwLCBqID0gYXJyYXkubGVuZ3RoOyBpIDwgajsgaSsrKSB0aGlzLnB1c2goYXJyYXlbaV0pOwoJCXJldHVybiB0aGlzOwoJfSwKCgkvKgoJUHJvcGVydHk6IG1lcmdlCgkJbWVyZ2VzIGFuIGFycmF5IGluIGFub3RoZXIgYXJyYXksIHdpdGhvdXQgZHVwbGljYXRlcy4gKGNhc2UtIGFuZCB0eXBlLXNlbnNpdGl2ZSkKCglBcmd1bWVudHM6CgkJYXJyYXkgLSB0aGUgYXJyYXkgdG8gbWVyZ2UgZnJvbS4KCglFeGFtcGxlOgoJCT5bJ0NhdCcsJ0RvZyddLm1lcmdlKFsnRG9nJywnQ29hbGEnXSk7IC8vcmV0dXJucyBbJ0NhdCcsJ0RvZycsJ0NvYWxhJ10KCSovCgoJbWVyZ2U6IGZ1bmN0aW9uKGFycmF5KXsKCQlmb3IgKHZhciBpID0gMCwgbCA9IGFycmF5Lmxlbmd0aDsgaSA8IGw7IGkrKykgdGhpcy5pbmNsdWRlKGFycmF5W2ldKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJLyoKCVByb3BlcnR5OiBpbmNsdWRlCgkJaW5jbHVkZXMgdGhlIHBhc3NlZCBpbiBlbGVtZW50IGluIHRoZSBhcnJheSwgb25seSBpZiBpdHMgbm90IGFscmVhZHkgcHJlc2VudC4gKGNhc2UtIGFuZCB0eXBlLXNlbnNpdGl2ZSkKCglBcmd1bWVudHM6CgkJaXRlbSAtIGl0ZW0gdG8gYWRkIHRvIHRoZSBhcnJheSAoaWYgbm90IHByZXNlbnQpCgoJRXhhbXBsZToKCQk+WydDYXQnLCdEb2cnXS5pbmNsdWRlKCdEb2cnKTsgLy9yZXR1cm5zIFsnQ2F0JywnRG9nJ10KCQk+WydDYXQnLCdEb2cnXS5pbmNsdWRlKCdDb2FsYScpOyAvL3JldHVybnMgWydDYXQnLCdEb2cnLCdDb2FsYSddCgkqLwoKCWluY2x1ZGU6IGZ1bmN0aW9uKGl0ZW0pewoJCWlmICghdGhpcy5jb250YWlucyhpdGVtKSkgdGhpcy5wdXNoKGl0ZW0pOwoJCXJldHVybiB0aGlzOwoJfSwKCgkvKgoJUHJvcGVydHk6IGdldFJhbmRvbQoJCXJldHVybnMgYSByYW5kb20gaXRlbSBpbiB0aGUgQXJyYXkKCSovCgoJZ2V0UmFuZG9tOiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzWyRyYW5kb20oMCwgdGhpcy5sZW5ndGggLSAxKV0gfHwgbnVsbDsKCX0sCgoJLyoKCVByb3BlcnR5OiBnZXRMYXN0CgkJcmV0dXJucyB0aGUgbGFzdCBpdGVtIGluIHRoZSBBcnJheQoJKi8KCglnZXRMYXN0OiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzW3RoaXMubGVuZ3RoIC0gMV0gfHwgbnVsbDsKCX0KCn0pOwoKLy9jb3BpZXMKCkFycmF5LnByb3RvdHlwZS5lYWNoID0gQXJyYXkucHJvdG90eXBlLmZvckVhY2g7CkFycmF5LmVhY2ggPSBBcnJheS5mb3JFYWNoOwoKLyogU2VjdGlvbjogVXRpbGl0eSBGdW5jdGlvbnMgKi8KCi8qCkZ1bmN0aW9uOiAkQSgpCglTYW1lIGFzIDxBcnJheS5jb3B5PiwgYnV0IGFzIGZ1bmN0aW9uLgoJVXNlZnVsIHRvIGFwcGx5IEFycmF5IHByb3RvdHlwZXMgdG8gaXRlcmFibGUgb2JqZWN0cywgYXMgYSBjb2xsZWN0aW9uIG9mIERPTSBlbGVtZW50cyBvciB0aGUgYXJndW1lbnRzIG9iamVjdC4KCkV4YW1wbGU6Cgkoc3RhcnQgY29kZSkKCWZ1bmN0aW9uIG15RnVuY3Rpb24oKXsKCQkkQShhcmd1bWVudHMpLmVhY2goYXJndW1lbnQsIGZ1bmN0aW9uKCl7CgkJCWFsZXJ0KGFyZ3VtZW50KTsKCQl9KTsKCX07CgkvL3RoZSBhYm92ZSB3aWxsIGFsZXJ0IGFsbCB0aGUgYXJndW1lbnRzIHBhc3NlZCB0byB0aGUgZnVuY3Rpb24gbXlGdW5jdGlvbi4KCShlbmQpCiovCgpmdW5jdGlvbiAkQShhcnJheSl7CglyZXR1cm4gQXJyYXkuY29weShhcnJheSk7Cn07CgovKgpGdW5jdGlvbjogJGVhY2gKCVVzZSB0byBpdGVyYXRlIHRocm91Z2ggaXRlcmFibGVzIHRoYXQgYXJlIG5vdCByZWd1bGFyIGFycmF5cywgc3VjaCBhcyBidWlsdGluIGdldEVsZW1lbnRzQnlUYWdOYW1lIGNhbGxzLCBhcmd1bWVudHMgb2YgYSBmdW5jdGlvbiwgb3IgYW4gb2JqZWN0LgoKQXJndW1lbnRzOgoJaXRlcmFibGUgLSBhbiBpdGVyYWJsZSBlbGVtZW50IG9yIGFuIG9iamN0LgoJZnVuY3Rpb24gLSBmdW5jdGlvbiB0byBhcHBseSB0byB0aGUgaXRlcmFibGUuCgliaW5kIC0gb3B0aW9uYWwsIHRoZSAndGhpcycgb2YgdGhlIGZ1bmN0aW9uIHdpbGwgcmVmZXIgdG8gdGhpcyBvYmplY3QuCgpGdW5jdGlvbiBhcmd1bWVudDoKCVRoZSBmdW5jdGlvbiBhcmd1bWVudCB3aWxsIGJlIHBhc3NlZCB0aGUgZm9sbG93aW5nIGFyZ3VtZW50cy4KCglpdGVtIC0gdGhlIGN1cnJlbnQgaXRlbSBpbiB0aGUgaXRlcmF0b3IgYmVpbmcgcHJvY2VzZWQKCWluZGV4IC0gaW50ZWdlcjsgdGhlIGluZGV4IG9mIHRoZSBpdGVtLCBvciBrZXkgaW4gY2FzZSBvZiBhbiBvYmplY3QuCgpFeGFtcGxlczoKCShzdGFydCBjb2RlKQoJJGVhY2goWydTdW4nLCdNb24nLCdUdWUnXSwgZnVuY3Rpb24oZGF5LCBpbmRleCl7CgkJYWxlcnQoJ25hbWU6JyArIGRheSArICcsIGluZGV4OiAnICsgaW5kZXgpOwoJfSk7CgkvL2FsZXJ0cyAibmFtZTogU3VuLCBpbmRleDogMCIsICJuYW1lOiBNb24sIGluZGV4OiAxIiwgZXRjLgoJLy9vdmVyIGFuIG9iamVjdAoJJGVhY2goe2ZpcnN0OiAiU3VuZGF5Iiwgc2Vjb25kOiAiTW9uZGF5IiwgdGhpcmQ6ICJUdWVzZGF5In0sIGZ1bmN0aW9uKHZhbHVlLCBrZXkpewoJCWFsZXJ0KCJ0aGUgIiArIGtleSArICIgZGF5IG9mIHRoZSB3ZWVrIGlzICIgKyB2YWx1ZSk7Cgl9KTsKCS8vYWxlcnRzICJ0aGUgZmlyc3QgZGF5IG9mIHRoZSB3ZWVrIGlzIFN1bmRheSIsCgkvLyJ0aGUgc2Vjb25kIGRheSBvZiB0aGUgd2VlayBpcyBNb25kYXkiLCBldGMuCgkoZW5kKQoqLwoKZnVuY3Rpb24gJGVhY2goaXRlcmFibGUsIGZuLCBiaW5kKXsKCWlmIChpdGVyYWJsZSAmJiB0eXBlb2YgaXRlcmFibGUubGVuZ3RoID09ICdudW1iZXInICYmICR0eXBlKGl0ZXJhYmxlKSAhPSAnb2JqZWN0Jyl7CgkJQXJyYXkuZm9yRWFjaChpdGVyYWJsZSwgZm4sIGJpbmQpOwoJfSBlbHNlIHsKCQkgZm9yICh2YXIgbmFtZSBpbiBpdGVyYWJsZSkgZm4uY2FsbChiaW5kIHx8IGl0ZXJhYmxlLCBpdGVyYWJsZVtuYW1lXSwgbmFtZSk7Cgl9Cn07CgovKmNvbXBhdGliaWxpdHkqLwoKQXJyYXkucHJvdG90eXBlLnRlc3QgPSBBcnJheS5wcm90b3R5cGUuY29udGFpbnM7CgovKmVuZCBjb21wYXRpYmlsaXR5Ki8KCi8qClNjcmlwdDogU3RyaW5nLmpzCglDb250YWlucyBTdHJpbmcgcHJvdG90eXBlcy4KCkxpY2Vuc2U6CglNSVQtc3R5bGUgbGljZW5zZS4KKi8KCi8qCkNsYXNzOiBTdHJpbmcKCUEgY29sbGVjdGlvbiBvZiBUaGUgU3RyaW5nIE9iamVjdCBwcm90b3R5cGUgbWV0aG9kcy4KKi8KClN0cmluZy5leHRlbmQoewoKCS8qCglQcm9wZXJ0eTogdGVzdAoJCVRlc3RzIGEgc3RyaW5nIHdpdGggYSByZWd1bGFyIGV4cHJlc3Npb24uCgoJQXJndW1lbnRzOgoJCXJlZ2V4IC0gYSBzdHJpbmcgb3IgcmVndWxhciBleHByZXNzaW9uIG9iamVjdCwgdGhlIHJlZ3VsYXIgZXhwcmVzc2lvbiB5b3Ugd2FudCB0byBtYXRjaCB0aGUgc3RyaW5nIHdpdGgKCQlwYXJhbXMgLSBvcHRpb25hbCwgaWYgZmlyc3QgcGFyYW1ldGVyIGlzIGEgc3RyaW5nLCBhbnkgcGFyYW1ldGVycyB5b3Ugd2FudCB0byBwYXNzIHRvIHRoZSByZWdleCAoJ2cnIGhhcyBubyBlZmZlY3QpCgoJUmV0dXJuczoKCQl0cnVlIGlmIGEgbWF0Y2ggZm9yIHRoZSByZWd1bGFyIGV4cHJlc3Npb24gaXMgZm91bmQgaW4gdGhlIHN0cmluZywgZmFsc2UgaWYgbm90LgoJCVNlZSA8aHR0cDovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi9kb2NzL0NvcmVfSmF2YVNjcmlwdF8xLjVfUmVmZXJlbmNlOk9iamVjdHM6UmVnRXhwOnRlc3Q+CgoJRXhhbXBsZToKCQk+IkkgbGlrZSBjb29raWVzIi50ZXN0KCJjb29raWUiKTsgLy8gcmV0dXJucyB0cnVlCgkJPiJJIGxpa2UgY29va2llcyIudGVzdCgiQ09PS0lFIiwgImkiKSAvLyBpZ25vcmUgY2FzZSwgcmV0dXJucyB0cnVlCgkJPiJJIGxpa2UgY29va2llcyIudGVzdCgiY2FrZSIpOyAvLyByZXR1cm5zIGZhbHNlCgkqLwoKCXRlc3Q6IGZ1bmN0aW9uKHJlZ2V4LCBwYXJhbXMpewoJCXJldHVybiAoKCR0eXBlKHJlZ2V4KSA9PSAnc3RyaW5nJykgPyBuZXcgUmVnRXhwKHJlZ2V4LCBwYXJhbXMpIDogcmVnZXgpLnRlc3QodGhpcyk7Cgl9LAoKCS8qCglQcm9wZXJ0eTogdG9JbnQKCQlwYXJzZXMgYSBzdHJpbmcgdG8gYW4gaW50ZWdlci4KCglSZXR1cm5zOgoJCWVpdGhlciBhbiBpbnQgb3IgIk5hTiIgaWYgdGhlIHN0cmluZyBpcyBub3QgYSBudW1iZXIuCgoJRXhhbXBsZToKCQk+dmFyIHZhbHVlID0gIjEwcHgiLnRvSW50KCk7IC8vIHZhbHVlIGlzIDEwCgkqLwoKCXRvSW50OiBmdW5jdGlvbigpewoJCXJldHVybiBwYXJzZUludCh0aGlzLCAxMCk7Cgl9LAoKCS8qCglQcm9wZXJ0eTogdG9GbG9hdAoJCXBhcnNlcyBhIHN0cmluZyB0byBhbiBmbG9hdC4KCglSZXR1cm5zOgoJCWVpdGhlciBhIGZsb2F0IG9yICJOYU4iIGlmIHRoZSBzdHJpbmcgaXMgbm90IGEgbnVtYmVyLgoKCUV4YW1wbGU6CgkJPnZhciB2YWx1ZSA9ICIxMC44NDgiLnRvRmxvYXQoKTsgLy8gdmFsdWUgaXMgMTAuODQ4CgkqLwoKCXRvRmxvYXQ6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHBhcnNlRmxvYXQodGhpcyk7Cgl9LAoKCS8qCglQcm9wZXJ0eTogY2FtZWxDYXNlCgkJQ29udmVydHMgYSBoaXBoZW5hdGVkIHN0cmluZyB0byBhIGNhbWVsY2FzZSBzdHJpbmcuCgoJRXhhbXBsZToKCQk+IkktbGlrZS1jb29raWVzIi5jYW1lbENhc2UoKTsgLy8iSUxpa2VDb29raWVzIgoKCVJldHVybnM6CgkJdGhlIGNhbWVsIGNhc2VkIHN0cmluZwoJKi8KCgljYW1lbENhc2U6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMucmVwbGFjZSgvLVxEL2csIGZ1bmN0aW9uKG1hdGNoKXsKCQkJcmV0dXJuIG1hdGNoLmNoYXJBdCgxKS50b1VwcGVyQ2FzZSgpOwoJCX0pOwoJfSwKCgkvKgoJUHJvcGVydHk6IGh5cGhlbmF0ZQoJCUNvbnZlcnRzIGEgY2FtZWxDYXNlZCBzdHJpbmcgdG8gYSBoeXBoZW4tYXRlZCBzdHJpbmcuCgoJRXhhbXBsZToKCQk+IklMaWtlQ29va2llcyIuaHlwaGVuYXRlKCk7IC8vIkktbGlrZS1jb29raWVzIgoJKi8KCgloeXBoZW5hdGU6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMucmVwbGFjZSgvXHdbQS1aXS9nLCBmdW5jdGlvbihtYXRjaCl7CgkJCXJldHVybiAobWF0Y2guY2hhckF0KDApICsgJy0nICsgbWF0Y2guY2hhckF0KDEpLnRvTG93ZXJDYXNlKCkpOwoJCX0pOwoJfSwKCgkvKgoJUHJvcGVydHk6IGNhcGl0YWxpemUKCQlDb252ZXJ0cyB0aGUgZmlyc3QgbGV0dGVyIGluIGVhY2ggd29yZCBvZiBhIHN0cmluZyB0byBVcHBlcmNhc2UuCgoJRXhhbXBsZToKCQk+ImkgbGlrZSBjb29raWVzIi5jYXBpdGFsaXplKCk7IC8vIkkgTGlrZSBDb29raWVzIgoKCVJldHVybnM6CgkJdGhlIGNhcGl0YWxpemVkIHN0cmluZwoJKi8KCgljYXBpdGFsaXplOiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLnJlcGxhY2UoL1xiW2Etel0vZywgZnVuY3Rpb24obWF0Y2gpewoJCQlyZXR1cm4gbWF0Y2gudG9VcHBlckNhc2UoKTsKCQl9KTsKCX0sCgoJLyoKCVByb3BlcnR5OiB0cmltCgkJVHJpbXMgdGhlIGxlYWRpbmcgYW5kIHRyYWlsaW5nIHNwYWNlcyBvZmYgYSBzdHJpbmcuCgoJRXhhbXBsZToKCQk+IiAgICBpIGxpa2UgY29va2llcyAgICAgIi50cmltKCkgLy8iaSBsaWtlIGNvb2tpZXMiCgoJUmV0dXJuczoKCQl0aGUgdHJpbW1lZCBzdHJpbmcKCSovCgoJdHJpbTogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5yZXBsYWNlKC9eXHMrfFxzKyQvZywgJycpOwoJfSwKCgkvKgoJUHJvcGVydHk6IGNsZWFuCgkJdHJpbXMgKDxTdHJpbmcudHJpbT4pIGEgc3RyaW5nIEFORCByZW1vdmVzIGFsbCB0aGUgZG91YmxlIHNwYWNlcyBpbiBhIHN0cmluZy4KCglSZXR1cm5zOgoJCXRoZSBjbGVhbmVkIHN0cmluZwoKCUV4YW1wbGU6CgkJPiIgaSAgICAgIGxpa2UgICAgIGNvb2tpZXMgICAgICBcblxuIi5jbGVhbigpIC8vImkgbGlrZSBjb29raWVzIgoJKi8KCgljbGVhbjogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5yZXBsYWNlKC9cc3syLH0vZywgJyAnKS50cmltKCk7Cgl9LAoKCS8qCglQcm9wZXJ0eTogcmdiVG9IZXgKCQlDb252ZXJ0cyBhbiBSR0IgdmFsdWUgdG8gaGV4aWRlY2ltYWwuIFRoZSBzdHJpbmcgbXVzdCBiZSBpbiB0aGUgZm9ybWF0IG9mICJyZ2IoMjU1LDI1NSwyNTUpIiBvciAicmdiYSgyNTUsMjU1LDI1NSwxKSI7CgoJQXJndW1lbnRzOgoJCWFycmF5IC0gYm9vbGVhbiB2YWx1ZSwgZGVmYXVsdHMgdG8gZmFsc2UuIFVzZSB0cnVlIGlmIHlvdSB3YW50IHRoZSBhcnJheSBbJ0ZGJywnMzMnLCcwMCddIGFzIG91dHB1dCBpbnN0ZWFkIG9mICIjRkYzMzAwIgoKCVJldHVybnM6CgkJaGV4IHN0cmluZyBvciBhcnJheS4gcmV0dXJucyAidHJhbnNwYXJlbnQiIGlmIHRoZSBvdXRwdXQgaXMgc2V0IGFzIHN0cmluZyBhbmQgdGhlIGZvdXJ0aCB2YWx1ZSBvZiByZ2JhIGluIGlucHV0IHN0cmluZyBpcyAwLgoKCUV4YW1wbGU6CgkJPiJyZ2IoMTcsMzQsNTEpIi5yZ2JUb0hleCgpOyAvLyIjMTEyMjMzIgoJCT4icmdiYSgxNywzNCw1MSwwKSIucmdiVG9IZXgoKTsgLy8idHJhbnNwYXJlbnQiCgkJPiJyZ2IoMTcsMzQsNTEpIi5yZ2JUb0hleCh0cnVlKTsgLy9bJzExJywnMjInLCczMyddCgkqLwoKCXJnYlRvSGV4OiBmdW5jdGlvbihhcnJheSl7CgkJdmFyIHJnYiA9IHRoaXMubWF0Y2goL1xkezEsM30vZyk7CgkJcmV0dXJuIChyZ2IpID8gcmdiLnJnYlRvSGV4KGFycmF5KSA6IGZhbHNlOwoJfSwKCgkvKgoJUHJvcGVydHk6IGhleFRvUmdiCgkJQ29udmVydHMgYSBoZXhpZGVjaW1hbCBjb2xvciB2YWx1ZSB0byBSR0IuIElucHV0IHN0cmluZyBtdXN0IGJlIHRoZSBoZXggY29sb3IgdmFsdWUgKHdpdGggb3Igd2l0aG91dCB0aGUgaGFzaCkuIEFsc28gYWNjZXB0cyB0cmlwbGV0cyAoJzMzMycpOwoKCUFyZ3VtZW50czoKCQlhcnJheSAtIGJvb2xlYW4gdmFsdWUsIGRlZmF1bHRzIHRvIGZhbHNlLiBVc2UgdHJ1ZSBpZiB5b3Ugd2FudCB0aGUgYXJyYXkgWzI1NSwyNTUsMjU1XSBhcyBvdXRwdXQgaW5zdGVhZCBvZiAicmdiKDI1NSwyNTUsMjU1KSI7CgoJUmV0dXJuczoKCQlyZ2Igc3RyaW5nIG9yIGFycmF5LgoKCUV4YW1wbGU6CgkJPiIjMTEyMjMzIi5oZXhUb1JnYigpOyAvLyJyZ2IoMTcsMzQsNTEpIgoJCT4iIzExMjIzMyIuaGV4VG9SZ2IodHJ1ZSk7IC8vWzE3LDM0LDUxXQoJKi8KCgloZXhUb1JnYjogZnVuY3Rpb24oYXJyYXkpewoJCXZhciBoZXggPSB0aGlzLm1hdGNoKC9eIz8oXHd7MSwyfSkoXHd7MSwyfSkoXHd7MSwyfSkkLyk7CgkJcmV0dXJuIChoZXgpID8gaGV4LnNsaWNlKDEpLmhleFRvUmdiKGFycmF5KSA6IGZhbHNlOwoJfSwKCgkvKgoJUHJvcGVydHk6IGNvbnRhaW5zCgkJY2hlY2tzIGlmIHRoZSBwYXNzZWQgaW4gc3RyaW5nIGlzIGNvbnRhaW5lZCBpbiB0aGUgU3RyaW5nLiBhbHNvIGFjY2VwdHMgYW4gb3B0aW9uYWwgc2Vjb25kIHBhcmFtZXRlciwgdG8gY2hlY2sgaWYgdGhlIHN0cmluZyBpcyBjb250YWluZWQgaW4gYSBsaXN0IG9mIHNlcGFyYXRlZCB2YWx1ZXMuCgoJRXhhbXBsZToKCQk+J2EgYiBjJy5jb250YWlucygnYycsICcgJyk7IC8vdHJ1ZQoJCT4nYSBiYycuY29udGFpbnMoJ2JjJyk7IC8vdHJ1ZQoJCT4nYSBiYycuY29udGFpbnMoJ2InLCAnICcpOyAvL2ZhbHNlCgkqLwoKCWNvbnRhaW5zOiBmdW5jdGlvbihzdHJpbmcsIHMpewoJCXJldHVybiAocykgPyAocyArIHRoaXMgKyBzKS5pbmRleE9mKHMgKyBzdHJpbmcgKyBzKSA+IC0xIDogdGhpcy5pbmRleE9mKHN0cmluZykgPiAtMTsKCX0sCgoJLyoKCVByb3BlcnR5OiBlc2NhcGVSZWdFeHAKCQlSZXR1cm5zIHN0cmluZyB3aXRoIGVzY2FwZWQgcmVndWxhciBleHByZXNzaW9uIGNoYXJhY3RlcnMKCglFeGFtcGxlOgoJCT52YXIgc2VhcmNoID0gJ2FuaW1hbHMuc2hlZXBzWzFdJy5lc2NhcGVSZWdFeHAoKTsgLy8gc2VhcmNoIGlzIG5vdyAnYW5pbWFsc1wuc2hlZXBzXFsxXF0nCgoJUmV0dXJuczoKCQlFc2NhcGVkIHN0cmluZwoJKi8KCgllc2NhcGVSZWdFeHA6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMucmVwbGFjZSgvKFsuKis/XiR7fSgpfFtcXVwvXFxdKS9nLCAnXFwkMScpOwoJfQoKfSk7CgpBcnJheS5leHRlbmQoewoKCS8qCglQcm9wZXJ0eTogcmdiVG9IZXgKCQlzZWUgPFN0cmluZy5yZ2JUb0hleD4sIGJ1dCBhcyBhbiBhcnJheSBtZXRob2QuCgkqLwoKCXJnYlRvSGV4OiBmdW5jdGlvbihhcnJheSl7CgkJaWYgKHRoaXMubGVuZ3RoIDwgMykgcmV0dXJuIGZhbHNlOwoJCWlmICh0aGlzLmxlbmd0aCA9PSA0ICYmIHRoaXNbM10gPT0gMCAmJiAhYXJyYXkpIHJldHVybiAndHJhbnNwYXJlbnQnOwoJCXZhciBoZXggPSBbXTsKCQlmb3IgKHZhciBpID0gMDsgaSA8IDM7IGkrKyl7CgkJCXZhciBiaXQgPSAodGhpc1tpXSAtIDApLnRvU3RyaW5nKDE2KTsKCQkJaGV4LnB1c2goKGJpdC5sZW5ndGggPT0gMSkgPyAnMCcgKyBiaXQgOiBiaXQpOwoJCX0KCQlyZXR1cm4gYXJyYXkgPyBoZXggOiAnIycgKyBoZXguam9pbignJyk7Cgl9LAoKCS8qCglQcm9wZXJ0eTogaGV4VG9SZ2IKCQlzYW1lIGFzIDxTdHJpbmcuaGV4VG9SZ2I+LCBidXQgYXMgYW4gYXJyYXkgbWV0aG9kLgoJKi8KCgloZXhUb1JnYjogZnVuY3Rpb24oYXJyYXkpewoJCWlmICh0aGlzLmxlbmd0aCAhPSAzKSByZXR1cm4gZmFsc2U7CgkJdmFyIHJnYiA9IFtdOwoJCWZvciAodmFyIGkgPSAwOyBpIDwgMzsgaSsrKXsKCQkJcmdiLnB1c2gocGFyc2VJbnQoKHRoaXNbaV0ubGVuZ3RoID09IDEpID8gdGhpc1tpXSArIHRoaXNbaV0gOiB0aGlzW2ldLCAxNikpOwoJCX0KCQlyZXR1cm4gYXJyYXkgPyByZ2IgOiAncmdiKCcgKyByZ2Iuam9pbignLCcpICsgJyknOwoJfQoKfSk7CgovKgpTY3JpcHQ6IEZ1bmN0aW9uLmpzCglDb250YWlucyBGdW5jdGlvbiBwcm90b3R5cGVzIGFuZCB1dGlsaXR5IGZ1bmN0aW9ucyAuCgpMaWNlbnNlOgoJTUlULXN0eWxlIGxpY2Vuc2UuCgpDcmVkaXRzOgoJLSBTb21lIGZ1bmN0aW9ucyBhcmUgaW5zcGlyZWQgYnkgdGhvc2UgZm91bmQgaW4gcHJvdG90eXBlLmpzIDxodHRwOi8vcHJvdG90eXBlLmNvbmlvLm5ldC8+IChjKSAyMDA1IFNhbSBTdGVwaGVuc29uIHNhbSBbYXRdIGNvbmlvIFtkb3RdIG5ldCwgTUlULXN0eWxlIGxpY2Vuc2UKKi8KCi8qCkNsYXNzOiBGdW5jdGlvbgoJQSBjb2xsZWN0aW9uIG9mIFRoZSBGdW5jdGlvbiBPYmplY3QgcHJvdG90eXBlIG1ldGhvZHMuCiovCgpGdW5jdGlvbi5leHRlbmQoewoKCS8qCglQcm9wZXJ0eTogY3JlYXRlCgkJTWFpbiBmdW5jdGlvbiB0byBjcmVhdGUgY2xvc3VyZXMuCgoJUmV0dXJuczoKCQlhIGZ1bmN0aW9uLgoKCUFyZ3VtZW50czoKCQlvcHRpb25zIC0gQW4gT3B0aW9ucyBvYmplY3QuCgoJT3B0aW9uczoKCQliaW5kIC0gVGhlIG9iamVjdCB0aGF0IHRoZSAidGhpcyIgb2YgdGhlIGZ1bmN0aW9uIHdpbGwgcmVmZXIgdG8uIERlZmF1bHQgaXMgdGhlIGN1cnJlbnQgZnVuY3Rpb24uCgkJZXZlbnQgLSBJZiBzZXQgdG8gdHJ1ZSwgdGhlIGZ1bmN0aW9uIHdpbGwgYWN0IGFzIGFuIGV2ZW50IGxpc3RlbmVyIGFuZCByZWNlaXZlIGFuIGV2ZW50IGFzIGZpcnN0IGFyZ3VtZW50LgoJCQkJSWYgc2V0IHRvIGEgY2xhc3MgbmFtZSwgdGhlIGZ1bmN0aW9uIHdpbGwgcmVjZWl2ZSBhIG5ldyBpbnN0YW5jZSBvZiB0aGlzIGNsYXNzICh3aXRoIHRoZSBldmVudCBwYXNzZWQgYXMgYXJndW1lbnQncyBjb25zdHJ1Y3RvcikgYXMgZmlyc3QgYXJndW1lbnQuCgkJCQlEZWZhdWx0IGlzIGZhbHNlLgoJCWFyZ3VtZW50cyAtIEEgc2luZ2xlIGFyZ3VtZW50IG9yIGFycmF5IG9mIGFyZ3VtZW50cyB0aGF0IHdpbGwgYmUgcGFzc2VkIHRvIHRoZSBmdW5jdGlvbiB3aGVuIGNhbGxlZC4KCgkJCQkJSWYgYm90aCB0aGUgZXZlbnQgYW5kIGFyZ3VtZW50cyBvcHRpb25zIGFyZSBzZXQsIHRoZSBldmVudCBpcyBwYXNzZWQgYXMgZmlyc3QgYXJndW1lbnQgYW5kIHRoZSBhcmd1bWVudHMgYXJyYXkgd2lsbCBmb2xsb3cuCgoJCQkJCURlZmF1bHQgaXMgbm8gY3VzdG9tIGFyZ3VtZW50cywgdGhlIGZ1bmN0aW9uIHdpbGwgcmVjZWl2ZSB0aGUgc3RhbmRhcmQgYXJndW1lbnRzIHdoZW4gY2FsbGVkLgoKCQlkZWxheSAtIE51bWVyaWMgdmFsdWU6IGlmIHNldCwgdGhlIHJldHVybmVkIGZ1bmN0aW9uIHdpbGwgZGVsYXkgdGhlIGFjdHVhbCBleGVjdXRpb24gYnkgdGhpcyBhbW91bnQgb2YgbWlsbGlzZWNvbmRzIGFuZCByZXR1cm4gYSB0aW1lciBoYW5kbGUgd2hlbiBjYWxsZWQuCgkJCQlEZWZhdWx0IGlzIG5vIGRlbGF5LgoJCXBlcmlvZGljYWwgLSBOdW1lcmljIHZhbHVlOiBpZiBzZXQsIHRoZSByZXR1cm5lZCBmdW5jdGlvbiB3aWxsIHBlcmlvZGljYWxseSBwZXJmb3JtIHRoZSBhY3R1YWwgZXhlY3V0aW9uIHdpdGggdGhpcyBzcGVjaWZpZWQgaW50ZXJ2YWwgYW5kIHJldHVybiBhIHRpbWVyIGhhbmRsZSB3aGVuIGNhbGxlZC4KCQkJCURlZmF1bHQgaXMgbm8gcGVyaW9kaWNhbCBleGVjdXRpb24uCgkJYXR0ZW1wdCAtIElmIHNldCB0byB0cnVlLCB0aGUgcmV0dXJuZWQgZnVuY3Rpb24gd2lsbCB0cnkgdG8gZXhlY3V0ZSBhbmQgcmV0dXJuIGVpdGhlciB0aGUgcmVzdWx0cyBvciBmYWxzZSBvbiBlcnJvci4gRGVmYXVsdCBpcyBmYWxzZS4KCSovCgoJY3JlYXRlOiBmdW5jdGlvbihvcHRpb25zKXsKCQl2YXIgZm4gPSB0aGlzOwoJCW9wdGlvbnMgPSAkbWVyZ2UoewoJCQknYmluZCc6IGZuLAoJCQknZXZlbnQnOiBmYWxzZSwKCQkJJ2FyZ3VtZW50cyc6IG51bGwsCgkJCSdkZWxheSc6IGZhbHNlLAoJCQkncGVyaW9kaWNhbCc6IGZhbHNlLAoJCQknYXR0ZW1wdCc6IGZhbHNlCgkJfSwgb3B0aW9ucyk7CgkJaWYgKCRjaGsob3B0aW9ucy5hcmd1bWVudHMpICYmICR0eXBlKG9wdGlvbnMuYXJndW1lbnRzKSAhPSAnYXJyYXknKSBvcHRpb25zLmFyZ3VtZW50cyA9IFtvcHRpb25zLmFyZ3VtZW50c107CgkJcmV0dXJuIGZ1bmN0aW9uKGV2ZW50KXsKCQkJdmFyIGFyZ3M7CgkJCWlmIChvcHRpb25zLmV2ZW50KXsKCQkJCWV2ZW50ID0gZXZlbnQgfHwgd2luZG93LmV2ZW50OwoJCQkJYXJncyA9IFsob3B0aW9ucy5ldmVudCA9PT0gdHJ1ZSkgPyBldmVudCA6IG5ldyBvcHRpb25zLmV2ZW50KGV2ZW50KV07CgkJCQlpZiAob3B0aW9ucy5hcmd1bWVudHMpIGFyZ3MuZXh0ZW5kKG9wdGlvbnMuYXJndW1lbnRzKTsKCQkJfQoJCQllbHNlIGFyZ3MgPSBvcHRpb25zLmFyZ3VtZW50cyB8fCBhcmd1bWVudHM7CgkJCXZhciByZXR1cm5zID0gZnVuY3Rpb24oKXsKCQkJCXJldHVybiBmbi5hcHBseSgkcGljayhvcHRpb25zLmJpbmQsIGZuKSwgYXJncyk7CgkJCX07CgkJCWlmIChvcHRpb25zLmRlbGF5KSByZXR1cm4gc2V0VGltZW91dChyZXR1cm5zLCBvcHRpb25zLmRlbGF5KTsKCQkJaWYgKG9wdGlvbnMucGVyaW9kaWNhbCkgcmV0dXJuIHNldEludGVydmFsKHJldHVybnMsIG9wdGlvbnMucGVyaW9kaWNhbCk7CgkJCWlmIChvcHRpb25zLmF0dGVtcHQpIHRyeSB7cmV0dXJuIHJldHVybnMoKTt9IGNhdGNoKGVycil7cmV0dXJuIGZhbHNlO307CgkJCXJldHVybiByZXR1cm5zKCk7CgkJfTsKCX0sCgoJLyoKCVByb3BlcnR5OiBwYXNzCgkJU2hvcnRjdXQgdG8gY3JlYXRlIGNsb3N1cmVzIHdpdGggYXJndW1lbnRzIGFuZCBiaW5kLgoKCVJldHVybnM6CgkJYSBmdW5jdGlvbi4KCglBcmd1bWVudHM6CgkJYXJncyAtIHRoZSBhcmd1bWVudHMgcGFzc2VkLiBtdXN0IGJlIGFuIGFycmF5IGlmIGFyZ3VtZW50cyA+IDEKCQliaW5kIC0gb3B0aW9uYWwsIHRoZSBvYmplY3QgdGhhdCB0aGUgInRoaXMiIG9mIHRoZSBmdW5jdGlvbiB3aWxsIHJlZmVyIHRvLgoKCUV4YW1wbGU6CgkJPm15RnVuY3Rpb24ucGFzcyhbYXJnMSwgYXJnMl0sIG15RWxlbWVudCk7CgkqLwoKCXBhc3M6IGZ1bmN0aW9uKGFyZ3MsIGJpbmQpewoJCXJldHVybiB0aGlzLmNyZWF0ZSh7J2FyZ3VtZW50cyc6IGFyZ3MsICdiaW5kJzogYmluZH0pOwoJfSwKCgkvKgoJUHJvcGVydHk6IGF0dGVtcHQKCQlUcmllcyB0byBleGVjdXRlIHRoZSBmdW5jdGlvbiwgcmV0dXJucyBlaXRoZXIgdGhlIHJlc3VsdCBvZiB0aGUgZnVuY3Rpb24gb3IgZmFsc2Ugb24gZXJyb3IuCgoJQXJndW1lbnRzOgoJCWFyZ3MgLSB0aGUgYXJndW1lbnRzIHBhc3NlZC4gbXVzdCBiZSBhbiBhcnJheSBpZiBhcmd1bWVudHMgPiAxCgkJYmluZCAtIG9wdGlvbmFsLCB0aGUgb2JqZWN0IHRoYXQgdGhlICJ0aGlzIiBvZiB0aGUgZnVuY3Rpb24gd2lsbCByZWZlciB0by4KCglFeGFtcGxlOgoJCT5teUZ1bmN0aW9uLmF0dGVtcHQoW2FyZzEsIGFyZzJdLCBteUVsZW1lbnQpOwoJKi8KCglhdHRlbXB0OiBmdW5jdGlvbihhcmdzLCBiaW5kKXsKCQlyZXR1cm4gdGhpcy5jcmVhdGUoeydhcmd1bWVudHMnOiBhcmdzLCAnYmluZCc6IGJpbmQsICdhdHRlbXB0JzogdHJ1ZX0pKCk7Cgl9LAoKCS8qCglQcm9wZXJ0eTogYmluZAoJCW1ldGhvZCB0byBlYXNpbHkgY3JlYXRlIGNsb3N1cmVzIHdpdGggInRoaXMiIGFsdGVyZWQuCgoJQXJndW1lbnRzOgoJCWJpbmQgLSBvcHRpb25hbCwgdGhlIG9iamVjdCB0aGF0IHRoZSAidGhpcyIgb2YgdGhlIGZ1bmN0aW9uIHdpbGwgcmVmZXIgdG8uCgkJYXJncyAtIG9wdGlvbmFsLCB0aGUgYXJndW1lbnRzIHBhc3NlZC4gbXVzdCBiZSBhbiBhcnJheSBpZiBhcmd1bWVudHMgPiAxCgoJUmV0dXJuczoKCQlhIGZ1bmN0aW9uLgoKCUV4YW1wbGU6CgkJPmZ1bmN0aW9uIG15RnVuY3Rpb24oKXsKCQk+CXRoaXMuc2V0U3R5bGUoJ2NvbG9yJywgJ3JlZCcpOwoJCT4JLy8gbm90ZSB0aGF0ICd0aGlzJyBoZXJlIHJlZmVycyB0byBteUZ1bmN0aW9uLCBub3QgYW4gZWxlbWVudAoJCT4JLy8gd2UnbGwgbmVlZCB0byBiaW5kIHRoaXMgZnVuY3Rpb24gdG8gdGhlIGVsZW1lbnQgd2Ugd2FudCB0byBhbHRlcgoJCT59OwoJCT52YXIgbXlCb3VuZEZ1bmN0aW9uID0gbXlGdW5jdGlvbi5iaW5kKG15RWxlbWVudCk7CgkJPm15Qm91bmRGdW5jdGlvbigpOyAvLyB0aGlzIHdpbGwgbWFrZSB0aGUgZWxlbWVudCBteUVsZW1lbnQgcmVkLgoJKi8KCgliaW5kOiBmdW5jdGlvbihiaW5kLCBhcmdzKXsKCQlyZXR1cm4gdGhpcy5jcmVhdGUoeydiaW5kJzogYmluZCwgJ2FyZ3VtZW50cyc6IGFyZ3N9KTsKCX0sCgoJLyoKCVByb3BlcnR5OiBiaW5kQXNFdmVudExpc3RlbmVyCgkJY3Jvc3MgYnJvd3NlciBtZXRob2QgdG8gcGFzcyBldmVudCBmaXJlcgoKCUFyZ3VtZW50czoKCQliaW5kIC0gb3B0aW9uYWwsIHRoZSBvYmplY3QgdGhhdCB0aGUgInRoaXMiIG9mIHRoZSBmdW5jdGlvbiB3aWxsIHJlZmVyIHRvLgoJCWFyZ3MgLSBvcHRpb25hbCwgdGhlIGFyZ3VtZW50cyBwYXNzZWQuIG11c3QgYmUgYW4gYXJyYXkgaWYgYXJndW1lbnRzID4gMQoKCVJldHVybnM6CgkJYSBmdW5jdGlvbiB3aXRoIHRoZSBwYXJhbWV0ZXIgYmluZCBhcyBpdHMgInRoaXMiIGFuZCBhcyBhIHByZS1wYXNzZWQgYXJndW1lbnQgZXZlbnQgb3Igd2luZG93LmV2ZW50LCBkZXBlbmRpbmcgb24gdGhlIGJyb3dzZXIuCgoJRXhhbXBsZToKCQk+ZnVuY3Rpb24gbXlGdW5jdGlvbihldmVudCl7CgkJPglhbGVydChldmVudC5jbGllbnR4KSAvL3JldHVybnMgdGhlIGNvb3JkaW5hdGVzIG9mIHRoZSBtb3VzZS4uCgkJPn07CgkJPm15RWxlbWVudC5vbmNsaWNrID0gbXlGdW5jdGlvbi5iaW5kQXNFdmVudExpc3RlbmVyKG15RWxlbWVudCk7CgkqLwoKCWJpbmRBc0V2ZW50TGlzdGVuZXI6IGZ1bmN0aW9uKGJpbmQsIGFyZ3MpewoJCXJldHVybiB0aGlzLmNyZWF0ZSh7J2JpbmQnOiBiaW5kLCAnZXZlbnQnOiB0cnVlLCAnYXJndW1lbnRzJzogYXJnc30pOwoJfSwKCgkvKgoJUHJvcGVydHk6IGRlbGF5CgkJRGVsYXlzIHRoZSBleGVjdXRpb24gb2YgYSBmdW5jdGlvbiBieSBhIHNwZWNpZmllZCBkdXJhdGlvbi4KCglBcmd1bWVudHM6CgkJZGVsYXkgLSB0aGUgZHVyYXRpb24gdG8gd2FpdCBpbiBtaWxsaXNlY29uZHMuCgkJYmluZCAtIG9wdGlvbmFsLCB0aGUgb2JqZWN0IHRoYXQgdGhlICJ0aGlzIiBvZiB0aGUgZnVuY3Rpb24gd2lsbCByZWZlciB0by4KCQlhcmdzIC0gb3B0aW9uYWwsIHRoZSBhcmd1bWVudHMgcGFzc2VkLiBtdXN0IGJlIGFuIGFycmF5IGlmIGFyZ3VtZW50cyA+IDEKCglFeGFtcGxlOgoJCT5teUZ1bmN0aW9uLmRlbGF5KDUwLCBteUVsZW1lbnQpIC8vd2FpdCA1MCBtaWxsaXNlY29uZHMsIHRoZW4gY2FsbCBteUZ1bmN0aW9uIGFuZCBiaW5kIG15RWxlbWVudCB0byBpdAoJCT4oZnVuY3Rpb24oKXthbGVydCgnb25lIHNlY29uZCBsYXRlci4uLicpfSkuZGVsYXkoMTAwMCk7IC8vd2FpdCBhIHNlY29uZCBhbmQgYWxlcnQKCSovCgoJZGVsYXk6IGZ1bmN0aW9uKGRlbGF5LCBiaW5kLCBhcmdzKXsKCQlyZXR1cm4gdGhpcy5jcmVhdGUoeydkZWxheSc6IGRlbGF5LCAnYmluZCc6IGJpbmQsICdhcmd1bWVudHMnOiBhcmdzfSkoKTsKCX0sCgoJLyoKCVByb3BlcnR5OiBwZXJpb2RpY2FsCgkJRXhlY3V0ZXMgYSBmdW5jdGlvbiBpbiB0aGUgc3BlY2lmaWVkIGludGVydmFscyBvZiB0aW1lCgoJQXJndW1lbnRzOgoJCWludGVydmFsIC0gdGhlIGR1cmF0aW9uIG9mIHRoZSBpbnRlcnZhbHMgYmV0d2VlbiBleGVjdXRpb25zLgoJCWJpbmQgLSBvcHRpb25hbCwgdGhlIG9iamVjdCB0aGF0IHRoZSAidGhpcyIgb2YgdGhlIGZ1bmN0aW9uIHdpbGwgcmVmZXIgdG8uCgkJYXJncyAtIG9wdGlvbmFsLCB0aGUgYXJndW1lbnRzIHBhc3NlZC4gbXVzdCBiZSBhbiBhcnJheSBpZiBhcmd1bWVudHMgPiAxCgkqLwoKCXBlcmlvZGljYWw6IGZ1bmN0aW9uKGludGVydmFsLCBiaW5kLCBhcmdzKXsKCQlyZXR1cm4gdGhpcy5jcmVhdGUoeydwZXJpb2RpY2FsJzogaW50ZXJ2YWwsICdiaW5kJzogYmluZCwgJ2FyZ3VtZW50cyc6IGFyZ3N9KSgpOwoJfQoKfSk7CgovKgpTY3JpcHQ6IE51bWJlci5qcwoJQ29udGFpbnMgdGhlIE51bWJlciBwcm90b3R5cGVzLgoKTGljZW5zZToKCU1JVC1zdHlsZSBsaWNlbnNlLgoqLwoKLyoKQ2xhc3M6IE51bWJlcgoJQSBjb2xsZWN0aW9uIG9mIFRoZSBOdW1iZXIgT2JqZWN0IHByb3RvdHlwZSBtZXRob2RzLgoqLwoKTnVtYmVyLmV4dGVuZCh7CgoJLyoKCVByb3BlcnR5OiB0b0ludAoJCVJldHVybnMgdGhpcyBudW1iZXI7IHVzZWZ1bCBiZWNhdXNlIHRvSW50IG11c3Qgd29yayBvbiBib3RoIFN0cmluZ3MgYW5kIE51bWJlcnMuCgkqLwoKCXRvSW50OiBmdW5jdGlvbigpewoJCXJldHVybiBwYXJzZUludCh0aGlzKTsKCX0sCgoJLyoKCVByb3BlcnR5OiB0b0Zsb2F0CgkJUmV0dXJucyB0aGlzIG51bWJlciBhcyBhIGZsb2F0OyB1c2VmdWwgYmVjYXVzZSB0b0Zsb2F0IG11c3Qgd29yayBvbiBib3RoIFN0cmluZ3MgYW5kIE51bWJlcnMuCgkqLwoKCXRvRmxvYXQ6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHBhcnNlRmxvYXQodGhpcyk7Cgl9LAoKCS8qCglQcm9wZXJ0eTogbGltaXQKCQlMaW1pdHMgdGhlIG51bWJlci4KCglBcmd1bWVudHM6CgkJbWluIC0gbnVtYmVyLCBtaW5pbXVtIHZhbHVlCgkJbWF4IC0gbnVtYmVyLCBtYXhpbXVtIHZhbHVlCgoJUmV0dXJuczoKCQl0aGUgbnVtYmVyIGluIHRoZSBnaXZlbiBsaW1pdHMuCgoJRXhhbXBsZToKCQk+KDEyKS5saW1pdCgyLCA2LjUpICAvLyByZXR1cm5zIDYuNQoJCT4oLTQpLmxpbWl0KDIsIDYuNSkgIC8vIHJldHVybnMgMgoJCT4oNC4zKS5saW1pdCgyLCA2LjUpIC8vIHJldHVybnMgNC4zCgkqLwoKCWxpbWl0OiBmdW5jdGlvbihtaW4sIG1heCl7CgkJcmV0dXJuIE1hdGgubWluKG1heCwgTWF0aC5tYXgobWluLCB0aGlzKSk7Cgl9LAoKCS8qCglQcm9wZXJ0eTogcm91bmQKCQlSZXR1cm5zIHRoZSBudW1iZXIgcm91bmRlZCB0byBzcGVjaWZpZWQgcHJlY2lzaW9uLgoKCUFyZ3VtZW50czoKCQlwcmVjaXNpb24gLSBpbnRlZ2VyLCBudW1iZXIgb2YgZGlnaXRzIGFmdGVyIHRoZSBkZWNpbWFsIHBvaW50LiBDYW4gYWxzbyBiZSBuZWdhdGl2ZSBvciB6ZXJvIChkZWZhdWx0KS4KCglFeGFtcGxlOgoJCT4xMi40NS5yb3VuZCgpIC8vIHJldHVybnMgMTIKCQk+MTIuNDUucm91bmQoMSkgLy8gcmV0dXJucyAxMi41CgkJPjEyLjQ1LnJvdW5kKC0xKSAvLyByZXR1cm5zIDEwCgoJUmV0dXJuczoKCQlUaGUgcm91bmRlZCBudW1iZXIuCgkqLwoKCXJvdW5kOiBmdW5jdGlvbihwcmVjaXNpb24pewoJCXByZWNpc2lvbiA9IE1hdGgucG93KDEwLCBwcmVjaXNpb24gfHwgMCk7CgkJcmV0dXJuIE1hdGgucm91bmQodGhpcyAqIHByZWNpc2lvbikgLyBwcmVjaXNpb247Cgl9LAoKCS8qCglQcm9wZXJ0eTogdGltZXMKCQlFeGVjdXRlcyBhIHBhc3NlZCBpbiBmdW5jdGlvbiB0aGUgc3BlY2lmaWVkIG51bWJlciBvZiB0aW1lcwoKCUFyZ3VtZW50czoKCQlmdW5jdGlvbiAtIHRoZSBmdW5jdGlvbiB0byBiZSBleGVjdXRlZCBvbiBlYWNoIGl0ZXJhdGlvbiBvZiB0aGUgbG9vcAoKCUV4YW1wbGU6CgkJPig0KS50aW1lcyhhbGVydCk7CgkqLwoKCXRpbWVzOiBmdW5jdGlvbihmbil7CgkJZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzOyBpKyspIGZuKGkpOwoJfQoKfSk7CgovKgpTY3JpcHQ6IEVsZW1lbnQuanMKCUNvbnRhaW5zIHVzZWZ1bCBFbGVtZW50IHByb3RvdHlwZXMsIHRvIGJlIHVzZWQgd2l0aCB0aGUgZG9sbGFyIGZ1bmN0aW9uIDwkPi4KCkxpY2Vuc2U6CglNSVQtc3R5bGUgbGljZW5zZS4KCkNyZWRpdHM6CgktIFNvbWUgZnVuY3Rpb25zIGFyZSBpbnNwaXJlZCBieSB0aG9zZSBmb3VuZCBpbiBwcm90b3R5cGUuanMgPGh0dHA6Ly9wcm90b3R5cGUuY29uaW8ubmV0Lz4gKGMpIDIwMDUgU2FtIFN0ZXBoZW5zb24gc2FtIFthdF0gY29uaW8gW2RvdF0gbmV0LCBNSVQtc3R5bGUgbGljZW5zZQoqLwoKLyoKQ2xhc3M6IEVsZW1lbnQKCUN1c3RvbSBjbGFzcyB0byBhbGxvdyBhbGwgb2YgaXRzIG1ldGhvZHMgdG8gYmUgdXNlZCB3aXRoIGFueSBET00gZWxlbWVudCB2aWEgdGhlIGRvbGxhciBmdW5jdGlvbiA8JD4uCiovCgp2YXIgRWxlbWVudCA9IG5ldyBDbGFzcyh7CgoJLyoKCVByb3BlcnR5OiBpbml0aWFsaXplCgkJQ3JlYXRlcyBhIG5ldyBlbGVtZW50IG9mIHRoZSB0eXBlIHBhc3NlZCBpbi4KCglBcmd1bWVudHM6CgkJZWwgLSBzdHJpbmc7IHRoZSB0YWcgbmFtZSBmb3IgdGhlIGVsZW1lbnQgeW91IHdpc2ggdG8gY3JlYXRlLiB5b3UgY2FuIGFsc28gcGFzcyBpbiBhbiBlbGVtZW50IHJlZmVyZW5jZSwgaW4gd2hpY2ggY2FzZSBpdCB3aWxsIGJlIGV4dGVuZGVkLgoJCXByb3BzIC0gb2JqZWN0OyB0aGUgcHJvcGVydGllcyB5b3Ugd2FudCB0byBhZGQgdG8geW91ciBlbGVtZW50LgoJCUFjY2VwdHMgdGhlIHNhbWUga2V5cyBhcyA8RWxlbWVudC5zZXRQcm9wZXJ0aWVzPiwgYnV0IGFsc28gYWxsb3dzIGV2ZW50cyBhbmQgc3R5bGVzCgoJUHJvcHM6CgkJdGhlIGtleSBzdHlsZXMgd2lsbCBiZSB1c2VkIGFzIHNldFN0eWxlcywgdGhlIGtleSBldmVudHMgd2lsbCBiZSB1c2VkIGFzIGFkZEV2ZW50cy4gYW55IG90aGVyIGtleSBpcyB1c2VkIGFzIHNldFByb3BlcnR5LgoKCUV4YW1wbGU6CgkJKHN0YXJ0IGNvZGUpCgkJbmV3IEVsZW1lbnQoJ2EnLCB7CgkJCSdzdHlsZXMnOiB7CgkJCQknZGlzcGxheSc6ICdibG9jaycsCgkJCQknYm9yZGVyJzogJzFweCBzb2xpZCBibGFjaycKCQkJfSwKCQkJJ2V2ZW50cyc6IHsKCQkJCSdjbGljayc6IGZ1bmN0aW9uKCl7CgkJCQkJLy9hYWEKCQkJCX0sCgkJCQknbW91c2Vkb3duJzogZnVuY3Rpb24oKXsKCQkJCQkvL2FhYQoJCQkJfQoJCQl9LAoJCQknY2xhc3MnOiAnbXlDbGFzc1N1cGVyQ2xhc3MnLAoJCQknaHJlZic6ICdodHRwOi8vbWFkNG1pbGsubmV0JwoJCX0pOwoKCQkoZW5kKQoJKi8KCglpbml0aWFsaXplOiBmdW5jdGlvbihlbCwgcHJvcHMpewoJCWlmICgkdHlwZShlbCkgPT0gJ3N0cmluZycpewoJCQlpZiAod2luZG93LmllICYmIHByb3BzICYmIChwcm9wcy5uYW1lIHx8IHByb3BzLnR5cGUpKXsKCQkJCXZhciBuYW1lID0gKHByb3BzLm5hbWUpID8gJyBuYW1lPSInICsgcHJvcHMubmFtZSArICciJyA6ICcnOwoJCQkJdmFyIHR5cGUgPSAocHJvcHMudHlwZSkgPyAnIHR5cGU9IicgKyBwcm9wcy50eXBlICsgJyInIDogJyc7CgkJCQlkZWxldGUgcHJvcHMubmFtZTsKCQkJCWRlbGV0ZSBwcm9wcy50eXBlOwoJCQkJZWwgPSAnPCcgKyBlbCArIG5hbWUgKyB0eXBlICsgJz4nOwoJCQl9CgkJCWVsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChlbCk7CgkJfQoJCWVsID0gJChlbCk7CgkJcmV0dXJuICghcHJvcHMgfHwgIWVsKSA/IGVsIDogZWwuc2V0KHByb3BzKTsKCX0KCn0pOwoKLyoKQ2xhc3M6IEVsZW1lbnRzCgktIEV2ZXJ5IGRvbSBmdW5jdGlvbiBzdWNoIGFzIDwkJD4sIG9yIGluIGdlbmVyYWwgZXZlcnkgZnVuY3Rpb24gdGhhdCByZXR1cm5zIGEgY29sbGVjdGlvbiBvZiBub2RlcyBpbiBtb290b29scywgcmV0dXJucyB0aGVtIGFzIGFuIEVsZW1lbnRzIGNsYXNzLgoJLSBUaGUgcHVycG9zZSBvZiB0aGUgRWxlbWVudHMgY2xhc3MgaXMgdG8gYWxsb3cgPEVsZW1lbnQ+IG1ldGhvZHMgdG8gd29yayBhbHNvIG9uIDxFbGVtZW50cz4gYXJyYXkuCgktIEVsZW1lbnRzIGlzIGFsc28gYW4gQXJyYXksIHNvIGl0IGFjY2VwdHMgYWxsIHRoZSA8QXJyYXk+IG1ldGhvZHMuCgktIEV2ZXJ5IG5vZGUgb2YgdGhlIEVsZW1lbnRzIGluc3RhbmNlIGlzIGFscmVhZHkgZXh0ZW5kZWQgd2l0aCA8JD4uCgpFeGFtcGxlOgoJPiQkKCdteXNlbGVjdG9yJykuZWFjaChmdW5jdGlvbihlbCl7Cgk+IC8vLi4uCgk+fSk7CgoJc29tZSBpdGVyYXRpb25zIGhlcmUsICQkKCdteXNlbGVjdG9yJykgaXMgYWxzbyBhbiBhcnJheS4KCgk+JCQoJ215c2VsZWN0b3InKS5zZXRTdHlsZSgnY29sb3InLCAncmVkJyk7CglldmVyeSBlbGVtZW50IHJldHVybmVkIGJ5ICQkKCdteXNlbGVjdG9yJykgYWxzbyBhY2NlcHRzIDxFbGVtZW50PiBtZXRob2RzLCBpbiB0aGlzIGV4YW1wbGUgZXZlcnkgZWxlbWVudCB3aWxsIGJlIG1hZGUgcmVkLgoqLwoKdmFyIEVsZW1lbnRzID0gbmV3IENsYXNzKHsKCglpbml0aWFsaXplOiBmdW5jdGlvbihlbGVtZW50cyl7CgkJcmV0dXJuIChlbGVtZW50cykgPyAkZXh0ZW5kKGVsZW1lbnRzLCB0aGlzKSA6IHRoaXM7Cgl9Cgp9KTsKCkVsZW1lbnRzLmV4dGVuZCA9IGZ1bmN0aW9uKHByb3BzKXsKCWZvciAodmFyIHByb3AgaW4gcHJvcHMpewoJCXRoaXMucHJvdG90eXBlW3Byb3BdID0gcHJvcHNbcHJvcF07CgkJdGhpc1twcm9wXSA9ICRuYXRpdmUuZ2VuZXJpYyhwcm9wKTsKCX0KfTsKCi8qClNlY3Rpb246IFV0aWxpdHkgRnVuY3Rpb25zCgpGdW5jdGlvbjogJAoJcmV0dXJucyB0aGUgZWxlbWVudCBwYXNzZWQgaW4gd2l0aCBhbGwgdGhlIEVsZW1lbnQgcHJvdG90eXBlcyBhcHBsaWVkLgoKQXJndW1lbnRzOgoJZWwgLSBhIHJlZmVyZW5jZSB0byBhbiBhY3R1YWwgZWxlbWVudCBvciBhIHN0cmluZyByZXByZXNlbnRpbmcgdGhlIGlkIG9mIGFuIGVsZW1lbnQKCkV4YW1wbGU6Cgk+JCgnbXlFbGVtZW50JykgLy8gZ2V0cyBhIERPTSBlbGVtZW50IGJ5IGlkIHdpdGggYWxsIHRoZSBFbGVtZW50IHByb3RvdHlwZXMgYXBwbGllZC4KCT52YXIgZGl2ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ215RWxlbWVudCcpOwoJPiQoZGl2KSAvL3JldHVybnMgYW4gRWxlbWVudCBhbHNvIHdpdGggYWxsIHRoZSBtb290b29scyBleHRlbnRpb25zIGFwcGxpZWQuCgoJWW91J2xsIHVzZSB0aGlzIHdoZW4geW91IGFyZW4ndCBzdXJlIGlmIGEgdmFyaWFibGUgaXMgYW4gYWN0dWFsIGVsZW1lbnQgb3IgYW4gaWQsIGFzCgl3ZWxsIGFzIGp1c3Qgc2hvcnRoYW5kIGZvciBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgpLgoKUmV0dXJuczoKCWEgRE9NIGVsZW1lbnQgb3IgZmFsc2UgKGlmIG5vIGlkIHdhcyBmb3VuZCkuCgpOb3RlOgoJeW91IG5lZWQgdG8gY2FsbCAkIG9uIGFuIGVsZW1lbnQgb25seSBvbmNlIHRvIGdldCBhbGwgdGhlIHByb3RvdHlwZXMuCglCdXQgaXRzIG5vIGhhcm0gdG8gY2FsbCBpdCBtdWx0aXBsZSB0aW1lcywgYXMgaXQgd2lsbCBkZXRlY3QgaWYgaXQgaGFzIGJlZW4gYWxyZWFkeSBleHRlbmRlZC4KKi8KCmZ1bmN0aW9uICQoZWwpewoJaWYgKCFlbCkgcmV0dXJuIG51bGw7CglpZiAoZWwuaHRtbEVsZW1lbnQpIHJldHVybiBHYXJiYWdlLmNvbGxlY3QoZWwpOwoJaWYgKFt3aW5kb3csIGRvY3VtZW50XS5jb250YWlucyhlbCkpIHJldHVybiBlbDsKCXZhciB0eXBlID0gJHR5cGUoZWwpOwoJaWYgKHR5cGUgPT0gJ3N0cmluZycpewoJCWVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoZWwpOwoJCXR5cGUgPSAoZWwpID8gJ2VsZW1lbnQnIDogZmFsc2U7Cgl9CglpZiAodHlwZSAhPSAnZWxlbWVudCcpIHJldHVybiBudWxsOwoJaWYgKGVsLmh0bWxFbGVtZW50KSByZXR1cm4gR2FyYmFnZS5jb2xsZWN0KGVsKTsKCWlmIChbJ29iamVjdCcsICdlbWJlZCddLmNvbnRhaW5zKGVsLnRhZ05hbWUudG9Mb3dlckNhc2UoKSkpIHJldHVybiBlbDsKCSRleHRlbmQoZWwsIEVsZW1lbnQucHJvdG90eXBlKTsKCWVsLmh0bWxFbGVtZW50ID0gZnVuY3Rpb24oKXt9OwoJcmV0dXJuIEdhcmJhZ2UuY29sbGVjdChlbCk7Cn07CgovKgpGdW5jdGlvbjogJCQKCVNlbGVjdHMsIGFuZCBleHRlbmRzIERPTSBlbGVtZW50cy4gRWxlbWVudHMgYXJyYXlzIHJldHVybmVkIHdpdGggJCQgd2lsbCBhbHNvIGFjY2VwdCBhbGwgdGhlIDxFbGVtZW50PiBtZXRob2RzLgoJVGhlIHJldHVybiB0eXBlIG9mIGVsZW1lbnQgbWV0aG9kcyBydW4gdGhyb3VnaCAkJCBpcyBhbHdheXMgYW4gYXJyYXkuIElmIHRoZSByZXR1cm4gYXJyYXkgaXMgb25seSBtYWRlIGJ5IGVsZW1lbnRzLAoJJCQgd2lsbCBiZSBhcHBsaWVkIGF1dG9tYXRpY2FsbHkuCgpBcmd1bWVudHM6CglIVE1MIENvbGxlY3Rpb25zLCBhcnJheXMgb2YgZWxlbWVudHMsIGFycmF5cyBvZiBzdHJpbmdzIGFzIGVsZW1lbnQgaWRzLCBlbGVtZW50cywgc3RyaW5ncyBhcyBzZWxlY3RvcnMuCglBbnkgbnVtYmVyIG9mIHRoZSBhYm92ZSBhcyBhcmd1bWVudHMgYXJlIGFjY2VwdGVkLgoKTm90ZToKCWlmIHlvdSBsb2FkIDxFbGVtZW50LlNlbGVjdG9ycy5qcz4sICQkIHdpbGwgYWxzbyBhY2NlcHQgQ1NTIFNlbGVjdG9ycywgb3RoZXJ3aXNlIHRoZSBvbmx5IHNlbGVjdG9ycyBzdXBwb3J0ZWQgYXJlIHRhZyBuYW1lcy4KCkV4YW1wbGU6Cgk+JCQoJ2EnKSAvL2FuIGFycmF5IG9mIGFsbCBhbmNob3IgdGFncyBvbiB0aGUgcGFnZQoJPiQkKCdhJywgJ2InKSAvL2FuIGFycmF5IG9mIGFsbCBhbmNob3IgYW5kIGJvbGQgdGFncyBvbiB0aGUgcGFnZQoJPiQkKCcjbXlFbGVtZW50JykgLy9hcnJheSBjb250YWluaW5nIG9ubHkgdGhlIGVsZW1lbnQgd2l0aCBpZCA9IG15RWxlbWVudC4gKG9ubHkgd2l0aCA8RWxlbWVudC5TZWxlY3RvcnMuanM+KQoJPiQkKCcjbXlFbGVtZW50IGEubXlDbGFzcycpIC8vYW4gYXJyYXkgb2YgYWxsIGFuY2hvciB0YWdzIHdpdGggdGhlIGNsYXNzICJteUNsYXNzIgoJPi8vd2l0aGluIHRoZSBET00gZWxlbWVudCB3aXRoIGlkICJteUVsZW1lbnQiIChvbmx5IHdpdGggPEVsZW1lbnQuU2VsZWN0b3JzLmpzPikKCT4kJChteWVsZW1lbnQsIG15ZWxlbWVudDIsICdhJywgWydteWlkJywgbXlpZDIsICdteWlkMyddLCBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgnZGl2JykpIC8vYW4gYXJyYXkgY29udGFpbmluZzoKCT4vLyB0aGUgZWxlbWVudCByZWZlcmVuY2VkIGFzIG15ZWxlbWVudCBpZiBleGlzdGluZywKCT4vLyB0aGUgZWxlbWVudCByZWZlcmVuY2VkIGFzIG15ZWxlbWVudDIgaWYgZXhpc3RpbmcsCgk+Ly8gYWxsIHRoZSBlbGVtZW50cyB3aXRoIGEgYXMgdGFnIGluIHRoZSBwYWdlLAoJPi8vIHRoZSBlbGVtZW50IHdpdGggaWQgPSBteWlkIGlmIGV4aXN0aW5nCgk+Ly8gdGhlIGVsZW1lbnQgd2l0aCBpZCA9IG15aWQyIGlmIGV4aXN0aW5nCgk+Ly8gdGhlIGVsZW1lbnQgd2l0aCBpZCA9IG15aWQzIGlmIGV4aXN0aW5nCgk+Ly8gYWxsIHRoZSBlbGVtZW50cyB3aXRoIGRpdiBhcyB0YWcgaW4gdGhlIHBhZ2UKClJldHVybnM6CglhcnJheSAtIGFycmF5IG9mIGFsbCB0aGUgZG9tIGVsZW1lbnRzIG1hdGNoZWQsIGV4dGVuZGVkIHdpdGggPCQ+LiAgUmV0dXJucyBhcyA8RWxlbWVudHM+LgoqLwoKZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVNlbGVjdG9yID0gZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWU7CgpmdW5jdGlvbiAkJCgpewoJdmFyIGVsZW1lbnRzID0gW107Cglmb3IgKHZhciBpID0gMCwgaiA9IGFyZ3VtZW50cy5sZW5ndGg7IGkgPCBqOyBpKyspewoJCXZhciBzZWxlY3RvciA9IGFyZ3VtZW50c1tpXTsKCQlzd2l0Y2goJHR5cGUoc2VsZWN0b3IpKXsKCQkJY2FzZSAnZWxlbWVudCc6IGVsZW1lbnRzLnB1c2goc2VsZWN0b3IpOwoJCQljYXNlICdib29sZWFuJzogYnJlYWs7CgkJCWNhc2UgZmFsc2U6IGJyZWFrOwoJCQljYXNlICdzdHJpbmcnOiBzZWxlY3RvciA9IGRvY3VtZW50LmdldEVsZW1lbnRzQnlTZWxlY3RvcihzZWxlY3RvciwgdHJ1ZSk7CgkJCWRlZmF1bHQ6IGVsZW1lbnRzLmV4dGVuZChzZWxlY3Rvcik7CgkJfQoJfQoJcmV0dXJuICQkLnVuaXF1ZShlbGVtZW50cyk7Cn07CgokJC51bmlxdWUgPSBmdW5jdGlvbihhcnJheSl7Cgl2YXIgZWxlbWVudHMgPSBbXTsKCWZvciAodmFyIGkgPSAwLCBsID0gYXJyYXkubGVuZ3RoOyBpIDwgbDsgaSsrKXsKCQlpZiAoYXJyYXlbaV0uJGluY2x1ZGVkKSBjb250aW51ZTsKCQl2YXIgZWxlbWVudCA9ICQoYXJyYXlbaV0pOwoJCWlmIChlbGVtZW50ICYmICFlbGVtZW50LiRpbmNsdWRlZCl7CgkJCWVsZW1lbnQuJGluY2x1ZGVkID0gdHJ1ZTsKCQkJZWxlbWVudHMucHVzaChlbGVtZW50KTsKCQl9Cgl9Cglmb3IgKHZhciBuID0gMCwgZCA9IGVsZW1lbnRzLmxlbmd0aDsgbiA8IGQ7IG4rKykgZWxlbWVudHNbbl0uJGluY2x1ZGVkID0gbnVsbDsKCXJldHVybiBuZXcgRWxlbWVudHMoZWxlbWVudHMpOwp9OwoKRWxlbWVudHMuTXVsdGkgPSBmdW5jdGlvbihwcm9wZXJ0eSl7CglyZXR1cm4gZnVuY3Rpb24oKXsKCQl2YXIgYXJncyA9IGFyZ3VtZW50czsKCQl2YXIgaXRlbXMgPSBbXTsKCQl2YXIgZWxlbWVudHMgPSB0cnVlOwoJCWZvciAodmFyIGkgPSAwLCBqID0gdGhpcy5sZW5ndGgsIHJldHVybnM7IGkgPCBqOyBpKyspewoJCQlyZXR1cm5zID0gdGhpc1tpXVtwcm9wZXJ0eV0uYXBwbHkodGhpc1tpXSwgYXJncyk7CgkJCWlmICgkdHlwZShyZXR1cm5zKSAhPSAnZWxlbWVudCcpIGVsZW1lbnRzID0gZmFsc2U7CgkJCWl0ZW1zLnB1c2gocmV0dXJucyk7CgkJfTsKCQlyZXR1cm4gKGVsZW1lbnRzKSA/ICQkLnVuaXF1ZShpdGVtcykgOiBpdGVtczsKCX07Cn07CgpFbGVtZW50LmV4dGVuZCA9IGZ1bmN0aW9uKHByb3BlcnRpZXMpewoJZm9yICh2YXIgcHJvcGVydHkgaW4gcHJvcGVydGllcyl7CgkJSFRNTEVsZW1lbnQucHJvdG90eXBlW3Byb3BlcnR5XSA9IHByb3BlcnRpZXNbcHJvcGVydHldOwoJCUVsZW1lbnQucHJvdG90eXBlW3Byb3BlcnR5XSA9IHByb3BlcnRpZXNbcHJvcGVydHldOwoJCUVsZW1lbnRbcHJvcGVydHldID0gJG5hdGl2ZS5nZW5lcmljKHByb3BlcnR5KTsKCQl2YXIgZWxlbWVudHNQcm9wZXJ0eSA9IChBcnJheS5wcm90b3R5cGVbcHJvcGVydHldKSA/IHByb3BlcnR5ICsgJ0VsZW1lbnRzJyA6IHByb3BlcnR5OwoJCUVsZW1lbnRzLnByb3RvdHlwZVtlbGVtZW50c1Byb3BlcnR5XSA9IEVsZW1lbnRzLk11bHRpKHByb3BlcnR5KTsKCX0KfTsKCi8qCkNsYXNzOiBFbGVtZW50CglDdXN0b20gY2xhc3MgdG8gYWxsb3cgYWxsIG9mIGl0cyBtZXRob2RzIHRvIGJlIHVzZWQgd2l0aCBhbnkgRE9NIGVsZW1lbnQgdmlhIHRoZSBkb2xsYXIgZnVuY3Rpb24gPCQ+LgoqLwoKRWxlbWVudC5leHRlbmQoewoKCS8qCglQcm9wZXJ0eTogc2V0CgkJeW91IGNhbiBzZXQgZXZlbnRzLCBzdHlsZXMgYW5kIHByb3BlcnRpZXMgd2l0aCB0aGlzIHNob3J0Y3V0LiBzYW1lIGFzIGNhbGxpbmcgbmV3IEVsZW1lbnQuCgkqLwoKCXNldDogZnVuY3Rpb24ocHJvcHMpewoJCWZvciAodmFyIHByb3AgaW4gcHJvcHMpewoJCQl2YXIgdmFsID0gcHJvcHNbcHJvcF07CgkJCXN3aXRjaChwcm9wKXsKCQkJCWNhc2UgJ3N0eWxlcyc6IHRoaXMuc2V0U3R5bGVzKHZhbCk7IGJyZWFrOwoJCQkJY2FzZSAnZXZlbnRzJzogaWYgKHRoaXMuYWRkRXZlbnRzKSB0aGlzLmFkZEV2ZW50cyh2YWwpOyBicmVhazsKCQkJCWNhc2UgJ3Byb3BlcnRpZXMnOiB0aGlzLnNldFByb3BlcnRpZXModmFsKTsgYnJlYWs7CgkJCQlkZWZhdWx0OiB0aGlzLnNldFByb3BlcnR5KHByb3AsIHZhbCk7CgkJCX0KCQl9CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWluamVjdDogZnVuY3Rpb24oZWwsIHdoZXJlKXsKCQllbCA9ICQoZWwpOwoJCXN3aXRjaCh3aGVyZSl7CgkJCWNhc2UgJ2JlZm9yZSc6IGVsLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKHRoaXMsIGVsKTsgYnJlYWs7CgkJCWNhc2UgJ2FmdGVyJzoKCQkJCXZhciBuZXh0ID0gZWwuZ2V0TmV4dCgpOwoJCQkJaWYgKCFuZXh0KSBlbC5wYXJlbnROb2RlLmFwcGVuZENoaWxkKHRoaXMpOwoJCQkJZWxzZSBlbC5wYXJlbnROb2RlLmluc2VydEJlZm9yZSh0aGlzLCBuZXh0KTsKCQkJCWJyZWFrOwoJCQljYXNlICd0b3AnOgoJCQkJdmFyIGZpcnN0ID0gZWwuZmlyc3RDaGlsZDsKCQkJCWlmIChmaXJzdCl7CgkJCQkJZWwuaW5zZXJ0QmVmb3JlKHRoaXMsIGZpcnN0KTsKCQkJCQlicmVhazsKCQkJCX0KCQkJZGVmYXVsdDogZWwuYXBwZW5kQ2hpbGQodGhpcyk7CgkJfQoJCXJldHVybiB0aGlzOwoJfSwKCgkvKgoJUHJvcGVydHk6IGluamVjdEJlZm9yZQoJCUluc2VydHMgdGhlIEVsZW1lbnQgYmVmb3JlIHRoZSBwYXNzZWQgZWxlbWVudC4KCglBcmd1bWVudHM6CgkJZWwgLSBhbiBlbGVtZW50IHJlZmVyZW5jZSBvciB0aGUgaWQgb2YgdGhlIGVsZW1lbnQgdG8gYmUgaW5qZWN0ZWQgaW4uCgoJRXhhbXBsZToKCQk+aHRtbDoKCQk+PGRpdiBpZD0ibXlFbGVtZW50Ij48L2Rpdj4KCQk+PGRpdiBpZD0ibXlTZWNvbmRFbGVtZW50Ij48L2Rpdj4KCQk+anM6CgkJPiQoJ215U2Vjb25kRWxlbWVudCcpLmluamVjdEJlZm9yZSgnbXlFbGVtZW50Jyk7CgkJPnJlc3VsdGluZyBodG1sOgoJCT48ZGl2IGlkPSJteVNlY29uZEVsZW1lbnQiPjwvZGl2PgoJCT48ZGl2IGlkPSJteUVsZW1lbnQiPjwvZGl2PgoJKi8KCglpbmplY3RCZWZvcmU6IGZ1bmN0aW9uKGVsKXsKCQlyZXR1cm4gdGhpcy5pbmplY3QoZWwsICdiZWZvcmUnKTsKCX0sCgoJLyoKCVByb3BlcnR5OiBpbmplY3RBZnRlcgoJCVNhbWUgYXMgPEVsZW1lbnQuaW5qZWN0QmVmb3JlPiwgYnV0IGluc2VydHMgdGhlIGVsZW1lbnQgYWZ0ZXIuCgkqLwoKCWluamVjdEFmdGVyOiBmdW5jdGlvbihlbCl7CgkJcmV0dXJuIHRoaXMuaW5qZWN0KGVsLCAnYWZ0ZXInKTsKCX0sCgoJLyoKCVByb3BlcnR5OiBpbmplY3RJbnNpZGUKCQlTYW1lIGFzIDxFbGVtZW50LmluamVjdEJlZm9yZT4sIGJ1dCBpbnNlcnRzIHRoZSBlbGVtZW50IGluc2lkZS4KCSovCgoJaW5qZWN0SW5zaWRlOiBmdW5jdGlvbihlbCl7CgkJcmV0dXJuIHRoaXMuaW5qZWN0KGVsLCAnYm90dG9tJyk7Cgl9LAoKCS8qCglQcm9wZXJ0eTogaW5qZWN0VG9wCgkJU2FtZSBhcyA8RWxlbWVudC5pbmplY3RJbnNpZGU+LCBidXQgaW5zZXJ0cyB0aGUgZWxlbWVudCBpbnNpZGUsIGF0IHRoZSB0b3AuCgkqLwoKCWluamVjdFRvcDogZnVuY3Rpb24oZWwpewoJCXJldHVybiB0aGlzLmluamVjdChlbCwgJ3RvcCcpOwoJfSwKCgkvKgoJUHJvcGVydHk6IGFkb3B0CgkJSW5zZXJ0cyB0aGUgcGFzc2VkIGVsZW1lbnRzIGluc2lkZSB0aGUgRWxlbWVudC4KCglBcmd1bWVudHM6CgkJYWNjZXB0cyBlbGVtZW50cyByZWZlcmVuY2VzLCBlbGVtZW50IGlkcyBhcyBzdHJpbmcsIHNlbGVjdG9ycyAoJCQoJ3N0dWZmJykpIC8gYXJyYXkgb2YgZWxlbWVudHMsIGFycmF5IG9mIGlkcyBhcyBzdHJpbmdzIGFuZCBjb2xsZWN0aW9ucy4KCSovCgoJYWRvcHQ6IGZ1bmN0aW9uKCl7CgkJdmFyIGVsZW1lbnRzID0gW107CgkJJGVhY2goYXJndW1lbnRzLCBmdW5jdGlvbihhcmd1bWVudCl7CgkJCWVsZW1lbnRzID0gZWxlbWVudHMuY29uY2F0KGFyZ3VtZW50KTsKCQl9KTsKCQkkJChlbGVtZW50cykuaW5qZWN0KHRoaXMpOwoJCXJldHVybiB0aGlzOwoJfSwKCgkvKgoJUHJvcGVydHk6IHJlbW92ZQoJCVJlbW92ZXMgdGhlIEVsZW1lbnQgZnJvbSB0aGUgRE9NLgoKCUV4YW1wbGU6CgkJPiQoJ215RWxlbWVudCcpLnJlbW92ZSgpIC8vYnllIGJ5ZQoJKi8KCglyZW1vdmU6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMucGFyZW50Tm9kZS5yZW1vdmVDaGlsZCh0aGlzKTsKCX0sCgoJLyoKCVByb3BlcnR5OiBjbG9uZQoJCUNsb25lcyB0aGUgRWxlbWVudCBhbmQgcmV0dXJucyB0aGUgY2xvbmVkIG9uZS4KCglBcmd1bWVudHM6CgkJY29udGVudHMgLSBib29sZWFuLCB3aGVuIHRydWUgdGhlIEVsZW1lbnQgaXMgY2xvbmVkIHdpdGggY2hpbGROb2RlcywgZGVmYXVsdCB0cnVlCgoJUmV0dXJuczoKCQl0aGUgY2xvbmVkIGVsZW1lbnQKCglFeGFtcGxlOgoJCT52YXIgY2xvbmUgPSAkKCdteUVsZW1lbnQnKS5jbG9uZSgpLmluamVjdEFmdGVyKCdteUVsZW1lbnQnKTsKCQk+Ly9jbG9uZXMgdGhlIEVsZW1lbnQgYW5kIGFwcGVuZCB0aGUgY2xvbmUgYWZ0ZXIgdGhlIEVsZW1lbnQuCgkqLwoKCWNsb25lOiBmdW5jdGlvbihjb250ZW50cyl7CgkJdmFyIGVsID0gJCh0aGlzLmNsb25lTm9kZShjb250ZW50cyAhPT0gZmFsc2UpKTsKCQlpZiAoIWVsLiRldmVudHMpIHJldHVybiBlbDsKCQllbC4kZXZlbnRzID0ge307CgkJZm9yICh2YXIgdHlwZSBpbiB0aGlzLiRldmVudHMpIGVsLiRldmVudHNbdHlwZV0gPSB7CgkJCSdrZXlzJzogJEEodGhpcy4kZXZlbnRzW3R5cGVdLmtleXMpLAoJCQkndmFsdWVzJzogJEEodGhpcy4kZXZlbnRzW3R5cGVdLnZhbHVlcykKCQl9OwoJCXJldHVybiBlbC5yZW1vdmVFdmVudHMoKTsKCX0sCgoJLyoKCVByb3BlcnR5OiByZXBsYWNlV2l0aAoJCVJlcGxhY2VzIHRoZSBFbGVtZW50IHdpdGggYW4gZWxlbWVudCBwYXNzZWQuCgoJQXJndW1lbnRzOgoJCWVsIC0gYSBzdHJpbmcgcmVwcmVzZW50aW5nIHRoZSBlbGVtZW50IHRvIGJlIGluamVjdGVkIGluIChteUVsZW1lbnRJZCwgb3IgZGl2KSwgb3IgYW4gZWxlbWVudCByZWZlcmVuY2UuCgkJSWYgeW91IHBhc3MgZGl2IG9yIGFub3RoZXIgdGFnLCB0aGUgZWxlbWVudCB3aWxsIGJlIGNyZWF0ZWQuCgoJUmV0dXJuczoKCQl0aGUgcGFzc2VkIGluIGVsZW1lbnQKCglFeGFtcGxlOgoJCT4kKCdteU9sZEVsZW1lbnQnKS5yZXBsYWNlV2l0aCgkKCdteU5ld0VsZW1lbnQnKSk7IC8vJCgnbXlPbGRFbGVtZW50JykgaXMgZ29uZSwgYW5kICQoJ215TmV3RWxlbWVudCcpIGlzIGluIGl0cyBwbGFjZS4KCSovCgoJcmVwbGFjZVdpdGg6IGZ1bmN0aW9uKGVsKXsKCQllbCA9ICQoZWwpOwoJCXRoaXMucGFyZW50Tm9kZS5yZXBsYWNlQ2hpbGQoZWwsIHRoaXMpOwoJCXJldHVybiBlbDsKCX0sCgoJLyoKCVByb3BlcnR5OiBhcHBlbmRUZXh0CgkJQXBwZW5kcyB0ZXh0IG5vZGUgdG8gYSBET00gZWxlbWVudC4KCglBcmd1bWVudHM6CgkJdGV4dCAtIHRoZSB0ZXh0IHRvIGFwcGVuZC4KCglFeGFtcGxlOgoJCT48ZGl2IGlkPSJteUVsZW1lbnQiPmhleTwvZGl2PgoJCT4kKCdteUVsZW1lbnQnKS5hcHBlbmRUZXh0KCcgaG93ZHknKTsgLy9teUVsZW1lbnQgaW5uZXJIVE1MIGlzIG5vdyAiaGV5IGhvd2R5IgoJKi8KCglhcHBlbmRUZXh0OiBmdW5jdGlvbih0ZXh0KXsKCQl0aGlzLmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKHRleHQpKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJLyoKCVByb3BlcnR5OiBoYXNDbGFzcwoJCVRlc3RzIHRoZSBFbGVtZW50IHRvIHNlZSBpZiBpdCBoYXMgdGhlIHBhc3NlZCBpbiBjbGFzc05hbWUuCgoJUmV0dXJuczoKCQl0cnVlIC0gdGhlIEVsZW1lbnQgaGFzIHRoZSBjbGFzcwoJCWZhbHNlIC0gaXQgZG9lc24ndAoKCUFyZ3VtZW50czoKCQljbGFzc05hbWUgLSBzdHJpbmc7IHRoZSBjbGFzcyBuYW1lIHRvIHRlc3QuCgoJRXhhbXBsZToKCQk+PGRpdiBpZD0ibXlFbGVtZW50IiBjbGFzcz0idGVzdENsYXNzIj48L2Rpdj4KCQk+JCgnbXlFbGVtZW50JykuaGFzQ2xhc3MoJ3Rlc3RDbGFzcycpOyAvL3JldHVybnMgdHJ1ZQoJKi8KCgloYXNDbGFzczogZnVuY3Rpb24oY2xhc3NOYW1lKXsKCQlyZXR1cm4gdGhpcy5jbGFzc05hbWUuY29udGFpbnMoY2xhc3NOYW1lLCAnICcpOwoJfSwKCgkvKgoJUHJvcGVydHk6IGFkZENsYXNzCgkJQWRkcyB0aGUgcGFzc2VkIGluIGNsYXNzIHRvIHRoZSBFbGVtZW50LCBpZiB0aGUgZWxlbWVudCBkb2VzbnQgYWxyZWFkeSBoYXZlIGl0LgoKCUFyZ3VtZW50czoKCQljbGFzc05hbWUgLSBzdHJpbmc7IHRoZSBjbGFzcyBuYW1lIHRvIGFkZAoKCUV4YW1wbGU6CgkJPjxkaXYgaWQ9Im15RWxlbWVudCIgY2xhc3M9InRlc3RDbGFzcyI+PC9kaXY+CgkJPiQoJ215RWxlbWVudCcpLmFkZENsYXNzKCduZXdDbGFzcycpOyAvLzxkaXYgaWQ9Im15RWxlbWVudCIgY2xhc3M9InRlc3RDbGFzcyBuZXdDbGFzcyI+PC9kaXY+CgkqLwoKCWFkZENsYXNzOiBmdW5jdGlvbihjbGFzc05hbWUpewoJCWlmICghdGhpcy5oYXNDbGFzcyhjbGFzc05hbWUpKSB0aGlzLmNsYXNzTmFtZSA9ICh0aGlzLmNsYXNzTmFtZSArICcgJyArIGNsYXNzTmFtZSkuY2xlYW4oKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJLyoKCVByb3BlcnR5OiByZW1vdmVDbGFzcwoJCVdvcmtzIGxpa2UgPEVsZW1lbnQuYWRkQ2xhc3M+LCBidXQgcmVtb3ZlcyB0aGUgY2xhc3MgZnJvbSB0aGUgZWxlbWVudC4KCSovCgoJcmVtb3ZlQ2xhc3M6IGZ1bmN0aW9uKGNsYXNzTmFtZSl7CgkJdGhpcy5jbGFzc05hbWUgPSB0aGlzLmNsYXNzTmFtZS5yZXBsYWNlKG5ldyBSZWdFeHAoJyhefFxccyknICsgY2xhc3NOYW1lICsgJyg/Olxcc3wkKScpLCAnJDEnKS5jbGVhbigpOwoJCXJldHVybiB0aGlzOwoJfSwKCgkvKgoJUHJvcGVydHk6IHRvZ2dsZUNsYXNzCgkJQWRkcyBvciByZW1vdmVzIHRoZSBwYXNzZWQgaW4gY2xhc3MgbmFtZSB0byB0aGUgZWxlbWVudCwgZGVwZW5kaW5nIG9uIGlmIGl0J3MgcHJlc2VudCBvciBub3QuCgoJQXJndW1lbnRzOgoJCWNsYXNzTmFtZSAtIHRoZSBjbGFzcyB0byBhZGQgb3IgcmVtb3ZlCgoJRXhhbXBsZToKCQk+PGRpdiBpZD0ibXlFbGVtZW50IiBjbGFzcz0ibXlDbGFzcyI+PC9kaXY+CgkJPiQoJ215RWxlbWVudCcpLnRvZ2dsZUNsYXNzKCdteUNsYXNzJyk7CgkJPjxkaXYgaWQ9Im15RWxlbWVudCIgY2xhc3M9IiI+PC9kaXY+CgkJPiQoJ215RWxlbWVudCcpLnRvZ2dsZUNsYXNzKCdteUNsYXNzJyk7CgkJPjxkaXYgaWQ9Im15RWxlbWVudCIgY2xhc3M9Im15Q2xhc3MiPjwvZGl2PgoJKi8KCgl0b2dnbGVDbGFzczogZnVuY3Rpb24oY2xhc3NOYW1lKXsKCQlyZXR1cm4gdGhpcy5oYXNDbGFzcyhjbGFzc05hbWUpID8gdGhpcy5yZW1vdmVDbGFzcyhjbGFzc05hbWUpIDogdGhpcy5hZGRDbGFzcyhjbGFzc05hbWUpOwoJfSwKCgkvKgoJUHJvcGVydHk6IHNldFN0eWxlCgkJU2V0cyBhIGNzcyBwcm9wZXJ0eSB0byB0aGUgRWxlbWVudC4KCgkJQXJndW1lbnRzOgoJCQlwcm9wZXJ0eSAtIHRoZSBwcm9wZXJ0eSB0byBzZXQKCQkJdmFsdWUgLSB0aGUgdmFsdWUgdG8gd2hpY2ggdG8gc2V0IGl0OyBmb3IgbnVtZXJpYyB2YWx1ZXMgdGhhdCByZXF1aXJlICJweCIgeW91IGNhbiBwYXNzIGFuIGludGVnZXIKCgkJRXhhbXBsZToKCQkJPiQoJ215RWxlbWVudCcpLnNldFN0eWxlKCd3aWR0aCcsICczMDBweCcpOyAvL3RoZSB3aWR0aCBpcyBub3cgMzAwcHgKCQkJPiQoJ215RWxlbWVudCcpLnNldFN0eWxlKCd3aWR0aCcsIDMwMCk7IC8vdGhlIHdpZHRoIGlzIG5vdyAzMDBweAoJKi8KCglzZXRTdHlsZTogZnVuY3Rpb24ocHJvcGVydHksIHZhbHVlKXsKCQlzd2l0Y2gocHJvcGVydHkpewoJCQljYXNlICdvcGFjaXR5JzogcmV0dXJuIHRoaXMuc2V0T3BhY2l0eShwYXJzZUZsb2F0KHZhbHVlKSk7CgkJCWNhc2UgJ2Zsb2F0JzogcHJvcGVydHkgPSAod2luZG93LmllKSA/ICdzdHlsZUZsb2F0JyA6ICdjc3NGbG9hdCc7CgkJfQoJCXByb3BlcnR5ID0gcHJvcGVydHkuY2FtZWxDYXNlKCk7CgkJc3dpdGNoKCR0eXBlKHZhbHVlKSl7CgkJCWNhc2UgJ251bWJlcic6IGlmICghWyd6SW5kZXgnLCAnem9vbSddLmNvbnRhaW5zKHByb3BlcnR5KSkgdmFsdWUgKz0gJ3B4JzsgYnJlYWs7CgkJCWNhc2UgJ2FycmF5JzogdmFsdWUgPSAncmdiKCcgKyB2YWx1ZS5qb2luKCcsJykgKyAnKSc7CgkJfQoJCXRoaXMuc3R5bGVbcHJvcGVydHldID0gdmFsdWU7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCS8qCglQcm9wZXJ0eTogc2V0U3R5bGVzCgkJQXBwbGllcyBhIGNvbGxlY3Rpb24gb2Ygc3R5bGVzIHRvIHRoZSBFbGVtZW50LgoKCUFyZ3VtZW50czoKCQlzb3VyY2UgLSBhbiBvYmplY3Qgb3Igc3RyaW5nIGNvbnRhaW5pbmcgYWxsIHRoZSBzdHlsZXMgdG8gYXBwbHkuIFdoZW4gaXRzIGEgc3RyaW5nIGl0IG92ZXJyaWRlcyBvbGQgc3R5bGUuCgoJRXhhbXBsZXM6CgkJPiQoJ215RWxlbWVudCcpLnNldFN0eWxlcyh7CgkJPglib3JkZXI6ICcxcHggc29saWQgIzAwMCcsCgkJPgl3aWR0aDogMzAwLAoJCT4JaGVpZ2h0OiA0MDAKCQk+fSk7CgoJCU9SCgoJCT4kKCdteUVsZW1lbnQnKS5zZXRTdHlsZXMoJ2JvcmRlcjogMXB4IHNvbGlkICMwMDA7IHdpZHRoOiAzMDBweDsgaGVpZ2h0OiA0MDBweDsnKTsKCSovCgoJc2V0U3R5bGVzOiBmdW5jdGlvbihzb3VyY2UpewoJCXN3aXRjaCgkdHlwZShzb3VyY2UpKXsKCQkJY2FzZSAnb2JqZWN0JzogRWxlbWVudC5zZXRNYW55KHRoaXMsICdzZXRTdHlsZScsIHNvdXJjZSk7IGJyZWFrOwoJCQljYXNlICdzdHJpbmcnOiB0aGlzLnN0eWxlLmNzc1RleHQgPSBzb3VyY2U7CgkJfQoJCXJldHVybiB0aGlzOwoJfSwKCgkvKgoJUHJvcGVydHk6IHNldE9wYWNpdHkKCQlTZXRzIHRoZSBvcGFjaXR5IG9mIHRoZSBFbGVtZW50LCBhbmQgc2V0cyBhbHNvIHZpc2liaWxpdHkgPT0gImhpZGRlbiIgaWYgb3BhY2l0eSA9PSAwLCBhbmQgdmlzaWJpbGl0eSA9ICJ2aXNpYmxlIiBpZiBvcGFjaXR5ID4gMC4KCglBcmd1bWVudHM6CgkJb3BhY2l0eSAtIGZsb2F0OyBBY2NlcHRzIHZhbHVlcyBmcm9tIDAgdG8gMS4KCglFeGFtcGxlOgoJCT4kKCdteUVsZW1lbnQnKS5zZXRPcGFjaXR5KDAuNSkgLy9tYWtlIGl0IDUwJSB0cmFuc3BhcmVudAoJKi8KCglzZXRPcGFjaXR5OiBmdW5jdGlvbihvcGFjaXR5KXsKCQlpZiAob3BhY2l0eSA9PSAwKXsKCQkJaWYgKHRoaXMuc3R5bGUudmlzaWJpbGl0eSAhPSAiaGlkZGVuIikgdGhpcy5zdHlsZS52aXNpYmlsaXR5ID0gImhpZGRlbiI7CgkJfSBlbHNlIHsKCQkJaWYgKHRoaXMuc3R5bGUudmlzaWJpbGl0eSAhPSAidmlzaWJsZSIpIHRoaXMuc3R5bGUudmlzaWJpbGl0eSA9ICJ2aXNpYmxlIjsKCQl9CgkJaWYgKCF0aGlzLmN1cnJlbnRTdHlsZSB8fCAhdGhpcy5jdXJyZW50U3R5bGUuaGFzTGF5b3V0KSB0aGlzLnN0eWxlLnpvb20gPSAxOwoJCWlmICh3aW5kb3cuaWUpIHRoaXMuc3R5bGUuZmlsdGVyID0gKG9wYWNpdHkgPT0gMSkgPyAnJyA6ICJhbHBoYShvcGFjaXR5PSIgKyBvcGFjaXR5ICogMTAwICsgIikiOwoJCXRoaXMuc3R5bGUub3BhY2l0eSA9IHRoaXMuJHRtcC5vcGFjaXR5ID0gb3BhY2l0eTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJLyoKCVByb3BlcnR5OiBnZXRTdHlsZQoJCVJldHVybnMgdGhlIHN0eWxlIG9mIHRoZSBFbGVtZW50IGdpdmVuIHRoZSBwcm9wZXJ0eSBwYXNzZWQgaW4uCgoJQXJndW1lbnRzOgoJCXByb3BlcnR5IC0gdGhlIGNzcyBzdHlsZSBwcm9wZXJ0eSB5b3Ugd2FudCB0byByZXRyaWV2ZQoKCUV4YW1wbGU6CgkJPiQoJ215RWxlbWVudCcpLmdldFN0eWxlKCd3aWR0aCcpOyAvL3JldHVybnMgIjQwMHB4IgoJCT4vL2J1dCB5b3UgY2FuIGFsc28gdXNlCgkJPiQoJ215RWxlbWVudCcpLmdldFN0eWxlKCd3aWR0aCcpLnRvSW50KCk7IC8vcmV0dXJucyA0MDAKCglSZXR1cm5zOgoJCXRoZSBzdHlsZSBhcyBhIHN0cmluZwoJKi8KCglnZXRTdHlsZTogZnVuY3Rpb24ocHJvcGVydHkpewoJCXByb3BlcnR5ID0gcHJvcGVydHkuY2FtZWxDYXNlKCk7CgkJdmFyIHJlc3VsdCA9IHRoaXMuc3R5bGVbcHJvcGVydHldOwoJCWlmICghJGNoayhyZXN1bHQpKXsKCQkJaWYgKHByb3BlcnR5ID09ICdvcGFjaXR5JykgcmV0dXJuIHRoaXMuJHRtcC5vcGFjaXR5OwoJCQlyZXN1bHQgPSBbXTsKCQkJZm9yICh2YXIgc3R5bGUgaW4gRWxlbWVudC5TdHlsZXMpewoJCQkJaWYgKHByb3BlcnR5ID09IHN0eWxlKXsKCQkJCQlFbGVtZW50LlN0eWxlc1tzdHlsZV0uZWFjaChmdW5jdGlvbihzKXsKCQkJCQkJdmFyIHN0eWxlID0gdGhpcy5nZXRTdHlsZShzKTsKCQkJCQkJcmVzdWx0LnB1c2gocGFyc2VJbnQoc3R5bGUpID8gc3R5bGUgOiAnMHB4Jyk7CgkJCQkJfSwgdGhpcyk7CgkJCQkJaWYgKHByb3BlcnR5ID09ICdib3JkZXInKXsKCQkJCQkJdmFyIGV2ZXJ5ID0gcmVzdWx0LmV2ZXJ5KGZ1bmN0aW9uKGJpdCl7CgkJCQkJCQlyZXR1cm4gKGJpdCA9PSByZXN1bHRbMF0pOwoJCQkJCQl9KTsKCQkJCQkJcmV0dXJuIChldmVyeSkgPyByZXN1bHRbMF0gOiBmYWxzZTsKCQkJCQl9CgkJCQkJcmV0dXJuIHJlc3VsdC5qb2luKCcgJyk7CgkJCQl9CgkJCX0KCQkJaWYgKHByb3BlcnR5LmNvbnRhaW5zKCdib3JkZXInKSl7CgkJCQlpZiAoRWxlbWVudC5TdHlsZXMuYm9yZGVyLmNvbnRhaW5zKHByb3BlcnR5KSl7CgkJCQkJcmV0dXJuIFsnV2lkdGgnLCAnU3R5bGUnLCAnQ29sb3InXS5tYXAoZnVuY3Rpb24ocCl7CgkJCQkJCXJldHVybiB0aGlzLmdldFN0eWxlKHByb3BlcnR5ICsgcCk7CgkJCQkJfSwgdGhpcykuam9pbignICcpOwoJCQkJfSBlbHNlIGlmIChFbGVtZW50LmJvcmRlclNob3J0LmNvbnRhaW5zKHByb3BlcnR5KSl7CgkJCQkJcmV0dXJuIFsnVG9wJywgJ1JpZ2h0JywgJ0JvdHRvbScsICdMZWZ0J10ubWFwKGZ1bmN0aW9uKHApewoJCQkJCQlyZXR1cm4gdGhpcy5nZXRTdHlsZSgnYm9yZGVyJyArIHAgKyBwcm9wZXJ0eS5yZXBsYWNlKCdib3JkZXInLCAnJykpOwoJCQkJCX0sIHRoaXMpLmpvaW4oJyAnKTsKCQkJCX0KCQkJfQoJCQlpZiAoZG9jdW1lbnQuZGVmYXVsdFZpZXcpIHJlc3VsdCA9IGRvY3VtZW50LmRlZmF1bHRWaWV3LmdldENvbXB1dGVkU3R5bGUodGhpcywgbnVsbCkuZ2V0UHJvcGVydHlWYWx1ZShwcm9wZXJ0eS5oeXBoZW5hdGUoKSk7CgkJCWVsc2UgaWYgKHRoaXMuY3VycmVudFN0eWxlKSByZXN1bHQgPSB0aGlzLmN1cnJlbnRTdHlsZVtwcm9wZXJ0eV07CgkJfQoJCWlmICh3aW5kb3cuaWUpIHJlc3VsdCA9IEVsZW1lbnQuZml4U3R5bGUocHJvcGVydHksIHJlc3VsdCwgdGhpcyk7CgkJaWYgKHJlc3VsdCAmJiBwcm9wZXJ0eS50ZXN0KC9jb2xvci9pKSAmJiByZXN1bHQuY29udGFpbnMoJ3JnYicpKXsKCQkJcmV0dXJuIHJlc3VsdC5zcGxpdCgncmdiJykuc3BsaWNlKDEsNCkubWFwKGZ1bmN0aW9uKGNvbG9yKXsKCQkJCXJldHVybiBjb2xvci5yZ2JUb0hleCgpOwoJCQl9KS5qb2luKCcgJyk7CgkJfQoJCXJldHVybiByZXN1bHQ7Cgl9LAoKCS8qCglQcm9wZXJ0eTogZ2V0U3R5bGVzCgkJUmV0dXJucyBhbiBvYmplY3Qgb2Ygc3R5bGVzIG9mIHRoZSBFbGVtZW50IGZvciBlYWNoIGFyZ3VtZW50IHBhc3NlZCBpbi4KCQlBcmd1bWVudHM6CgkJcHJvcGVydGllcyAtIHN0cmluZ3M7IGFueSBudW1iZXIgb2Ygc3R5bGUgcHJvcGVydGllcwoJRXhhbXBsZToKCQk+JCgnbXlFbGVtZW50JykuZ2V0U3R5bGVzKCd3aWR0aCcsJ2hlaWdodCcsJ3BhZGRpbmcnKTsKCQk+Ly9yZXR1cm5zIGFuIG9iamVjdCBsaWtlOgoJCT57d2lkdGg6ICIxMHB4IiwgaGVpZ2h0OiAiMTBweCIsIHBhZGRpbmc6ICIxMHB4IDBweCAxMHB4IDBweCJ9CgkqLwoKCWdldFN0eWxlczogZnVuY3Rpb24oKXsKCQlyZXR1cm4gRWxlbWVudC5nZXRNYW55KHRoaXMsICdnZXRTdHlsZScsIGFyZ3VtZW50cyk7Cgl9LAoKCXdhbGs6IGZ1bmN0aW9uKGJyb3RoZXIsIHN0YXJ0KXsKCQlicm90aGVyICs9ICdTaWJsaW5nJzsKCQl2YXIgZWwgPSAoc3RhcnQpID8gdGhpc1tzdGFydF0gOiB0aGlzW2Jyb3RoZXJdOwoJCXdoaWxlIChlbCAmJiAkdHlwZShlbCkgIT0gJ2VsZW1lbnQnKSBlbCA9IGVsW2Jyb3RoZXJdOwoJCXJldHVybiAkKGVsKTsKCX0sCgoJLyoKCVByb3BlcnR5OiBnZXRQcmV2aW91cwoJCVJldHVybnMgdGhlIHByZXZpb3VzU2libGluZyBvZiB0aGUgRWxlbWVudCwgZXhjbHVkaW5nIHRleHQgbm9kZXMuCgoJRXhhbXBsZToKCQk+JCgnbXlFbGVtZW50JykuZ2V0UHJldmlvdXMoKTsgLy9nZXQgdGhlIHByZXZpb3VzIERPTSBlbGVtZW50IGZyb20gbXlFbGVtZW50CgoJUmV0dXJuczoKCQl0aGUgc2libGluZyBlbGVtZW50IG9yIHVuZGVmaW5lZCBpZiBub25lIGZvdW5kLgoJKi8KCglnZXRQcmV2aW91czogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy53YWxrKCdwcmV2aW91cycpOwoJfSwKCgkvKgoJUHJvcGVydHk6IGdldE5leHQKCQlXb3JrcyBhcyBFbGVtZW50LmdldFByZXZpb3VzLCBidXQgdHJpZXMgdG8gZmluZCB0aGUgbmV4dFNpYmxpbmcuCgkqLwoKCWdldE5leHQ6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMud2FsaygnbmV4dCcpOwoJfSwKCgkvKgoJUHJvcGVydHk6IGdldEZpcnN0CgkJV29ya3MgYXMgPEVsZW1lbnQuZ2V0UHJldmlvdXM+LCBidXQgdHJpZXMgdG8gZmluZCB0aGUgZmlyc3RDaGlsZC4KCSovCgoJZ2V0Rmlyc3Q6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMud2FsaygnbmV4dCcsICdmaXJzdENoaWxkJyk7Cgl9LAoKCS8qCglQcm9wZXJ0eTogZ2V0TGFzdAoJCVdvcmtzIGFzIDxFbGVtZW50LmdldFByZXZpb3VzPiwgYnV0IHRyaWVzIHRvIGZpbmQgdGhlIGxhc3RDaGlsZC4KCSovCgoJZ2V0TGFzdDogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy53YWxrKCdwcmV2aW91cycsICdsYXN0Q2hpbGQnKTsKCX0sCgoJLyoKCVByb3BlcnR5OiBnZXRQYXJlbnQKCQlyZXR1cm5zIHRoZSAkKGVsZW1lbnQucGFyZW50Tm9kZSkKCSovCgoJZ2V0UGFyZW50OiBmdW5jdGlvbigpewoJCXJldHVybiAkKHRoaXMucGFyZW50Tm9kZSk7Cgl9LAoKCS8qCglQcm9wZXJ0eTogZ2V0Q2hpbGRyZW4KCQlyZXR1cm5zIGFsbCB0aGUgJChlbGVtZW50LmNoaWxkTm9kZXMpLCBleGNsdWRpbmcgdGV4dCBub2Rlcy4gUmV0dXJucyBhcyA8RWxlbWVudHM+LgoJKi8KCglnZXRDaGlsZHJlbjogZnVuY3Rpb24oKXsKCQlyZXR1cm4gJCQodGhpcy5jaGlsZE5vZGVzKTsKCX0sCgoJLyoKCVByb3BlcnR5OiBoYXNDaGlsZAoJCXJldHVybnMgdHJ1ZSBpZiB0aGUgcGFzc2VkIGluIGVsZW1lbnQgaXMgYSBjaGlsZCBvZiB0aGUgJChlbGVtZW50KS4KCSovCgoJaGFzQ2hpbGQ6IGZ1bmN0aW9uKGVsKXsKCQlyZXR1cm4gISEkQSh0aGlzLmdldEVsZW1lbnRzQnlUYWdOYW1lKCcqJykpLmNvbnRhaW5zKGVsKTsKCX0sCgoJLyoKCVByb3BlcnR5OiBnZXRQcm9wZXJ0eQoJCUdldHMgdGhlIGFuIGF0dHJpYnV0ZSBvZiB0aGUgRWxlbWVudC4KCglBcmd1bWVudHM6CgkJcHJvcGVydHkgLSBzdHJpbmc7IHRoZSBhdHRyaWJ1dGUgdG8gcmV0cmlldmUKCglFeGFtcGxlOgoJCT4kKCdteUltYWdlJykuZ2V0UHJvcGVydHkoJ3NyYycpIC8vIHJldHVybnMgd2hhdGV2ZXIuZ2lmCgoJUmV0dXJuczoKCQl0aGUgdmFsdWUsIG9yIGFuIGVtcHR5IHN0cmluZwoJKi8KCglnZXRQcm9wZXJ0eTogZnVuY3Rpb24ocHJvcGVydHkpewoJCXZhciBpbmRleCA9IEVsZW1lbnQuUHJvcGVydGllc1twcm9wZXJ0eV07CgkJaWYgKGluZGV4KSByZXR1cm4gdGhpc1tpbmRleF07CgkJdmFyIGZsYWcgPSBFbGVtZW50LlByb3BlcnRpZXNJRmxhZ1twcm9wZXJ0eV0gfHwgMDsKCQlpZiAoIXdpbmRvdy5pZSB8fCBmbGFnKSByZXR1cm4gdGhpcy5nZXRBdHRyaWJ1dGUocHJvcGVydHksIGZsYWcpOwoJCXZhciBub2RlID0gdGhpcy5hdHRyaWJ1dGVzW3Byb3BlcnR5XTsKCQlyZXR1cm4gKG5vZGUpID8gbm9kZS5ub2RlVmFsdWUgOiBudWxsOwoJfSwKCgkvKgoJUHJvcGVydHk6IHJlbW92ZVByb3BlcnR5CgkJUmVtb3ZlcyBhbiBhdHRyaWJ1dGUgZnJvbSB0aGUgRWxlbWVudAoKCUFyZ3VtZW50czoKCQlwcm9wZXJ0eSAtIHN0cmluZzsgdGhlIGF0dHJpYnV0ZSB0byByZW1vdmUKCSovCgoJcmVtb3ZlUHJvcGVydHk6IGZ1bmN0aW9uKHByb3BlcnR5KXsKCQl2YXIgaW5kZXggPSBFbGVtZW50LlByb3BlcnRpZXNbcHJvcGVydHldOwoJCWlmIChpbmRleCkgdGhpc1tpbmRleF0gPSAnJzsKCQllbHNlIHRoaXMucmVtb3ZlQXR0cmlidXRlKHByb3BlcnR5KTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJLyoKCVByb3BlcnR5OiBnZXRQcm9wZXJ0aWVzCgkJc2FtZSBhcyA8RWxlbWVudC5nZXRTdHlsZXM+LCBidXQgZm9yIHByb3BlcnRpZXMKCSovCgoJZ2V0UHJvcGVydGllczogZnVuY3Rpb24oKXsKCQlyZXR1cm4gRWxlbWVudC5nZXRNYW55KHRoaXMsICdnZXRQcm9wZXJ0eScsIGFyZ3VtZW50cyk7Cgl9LAoKCS8qCglQcm9wZXJ0eTogc2V0UHJvcGVydHkKCQlTZXRzIGFuIGF0dHJpYnV0ZSBmb3IgdGhlIEVsZW1lbnQuCgoJQXJndW1lbnRzOgoJCXByb3BlcnR5IC0gc3RyaW5nOyB0aGUgcHJvcGVydHkgdG8gYXNzaWduIHRoZSB2YWx1ZSBwYXNzZWQgaW4KCQl2YWx1ZSAtIHRoZSB2YWx1ZSB0byBhc3NpZ24gdG8gdGhlIHByb3BlcnR5IHBhc3NlZCBpbgoKCUV4YW1wbGU6CgkJPiQoJ215SW1hZ2UnKS5zZXRQcm9wZXJ0eSgnc3JjJywgJ3doYXRldmVyLmdpZicpOyAvL215SW1hZ2Ugbm93IHBvaW50cyB0byB3aGF0ZXZlci5naWYgZm9yIGl0cyBzb3VyY2UKCSovCgoJc2V0UHJvcGVydHk6IGZ1bmN0aW9uKHByb3BlcnR5LCB2YWx1ZSl7CgkJdmFyIGluZGV4ID0gRWxlbWVudC5Qcm9wZXJ0aWVzW3Byb3BlcnR5XTsKCQlpZiAoaW5kZXgpIHRoaXNbaW5kZXhdID0gdmFsdWU7CgkJZWxzZSB0aGlzLnNldEF0dHJpYnV0ZShwcm9wZXJ0eSwgdmFsdWUpOwoJCXJldHVybiB0aGlzOwoJfSwKCgkvKgoJUHJvcGVydHk6IHNldFByb3BlcnRpZXMKCQlTZXRzIG51bWVyb3VzIGF0dHJpYnV0ZXMgZm9yIHRoZSBFbGVtZW50LgoKCUFyZ3VtZW50czoKCQlzb3VyY2UgLSBhbiBvYmplY3Qgd2l0aCBrZXkvdmFsdWUgcGFpcnMuCgoJRXhhbXBsZToKCQkoc3RhcnQgY29kZSkKCQkkKCdteUVsZW1lbnQnKS5zZXRQcm9wZXJ0aWVzKHsKCQkJc3JjOiAnd2hhdGV2ZXIuZ2lmJywKCQkJYWx0OiAnd2hhdGV2ZXIgZHVkZScKCQl9KTsKCQk8aW1nIHNyYz0id2hhdGV2ZXIuZ2lmIiBhbHQ9IndoYXRldmVyIGR1ZGUiPgoJCShlbmQpCgkqLwoKCXNldFByb3BlcnRpZXM6IGZ1bmN0aW9uKHNvdXJjZSl7CgkJcmV0dXJuIEVsZW1lbnQuc2V0TWFueSh0aGlzLCAnc2V0UHJvcGVydHknLCBzb3VyY2UpOwoJfSwKCgkvKgoJUHJvcGVydHk6IHNldEhUTUwKCQlTZXRzIHRoZSBpbm5lckhUTUwgb2YgdGhlIEVsZW1lbnQuCgoJQXJndW1lbnRzOgoJCWh0bWwgLSBzdHJpbmc7IHRoZSBuZXcgaW5uZXJIVE1MIGZvciB0aGUgZWxlbWVudC4KCglFeGFtcGxlOgoJCT4kKCdteUVsZW1lbnQnKS5zZXRIVE1MKG5ld0hUTUwpIC8vdGhlIGlubmVySFRNTCBvZiBteUVsZW1lbnQgaXMgbm93ID0gbmV3SFRNTAoJKi8KCglzZXRIVE1MOiBmdW5jdGlvbigpewoJCXRoaXMuaW5uZXJIVE1MID0gJEEoYXJndW1lbnRzKS5qb2luKCcnKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJLyoKCVByb3BlcnR5OiBzZXRUZXh0CgkJU2V0cyB0aGUgaW5uZXIgdGV4dCBvZiB0aGUgRWxlbWVudC4KCglBcmd1bWVudHM6CgkJdGV4dCAtIHN0cmluZzsgdGhlIG5ldyB0ZXh0IGNvbnRlbnQgZm9yIHRoZSBlbGVtZW50LgoKCUV4YW1wbGU6CgkJPiQoJ215RWxlbWVudCcpLnNldFRleHQoJ3NvbWUgdGV4dCcpIC8vdGhlIHRleHQgb2YgbXlFbGVtZW50IGlzIG5vdyA9ICdzb21lIHRleHQnCgkqLwoKCXNldFRleHQ6IGZ1bmN0aW9uKHRleHQpewoJCXZhciB0YWcgPSB0aGlzLmdldFRhZygpOwoJCWlmIChbJ3N0eWxlJywgJ3NjcmlwdCddLmNvbnRhaW5zKHRhZykpewoJCQlpZiAod2luZG93LmllKXsKCQkJCWlmICh0YWcgPT0gJ3N0eWxlJykgdGhpcy5zdHlsZVNoZWV0LmNzc1RleHQgPSB0ZXh0OwoJCQkJZWxzZSBpZiAodGFnID09ICAnc2NyaXB0JykgdGhpcy5zZXRQcm9wZXJ0eSgndGV4dCcsIHRleHQpOwoJCQkJcmV0dXJuIHRoaXM7CgkJCX0gZWxzZSB7CgkJCQl0aGlzLnJlbW92ZUNoaWxkKHRoaXMuZmlyc3RDaGlsZCk7CgkJCQlyZXR1cm4gdGhpcy5hcHBlbmRUZXh0KHRleHQpOwoJCQl9CgkJfQoJCXRoaXNbJGRlZmluZWQodGhpcy5pbm5lclRleHQpID8gJ2lubmVyVGV4dCcgOiAndGV4dENvbnRlbnQnXSA9IHRleHQ7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCS8qCglQcm9wZXJ0eTogZ2V0VGV4dAoJCUdldHMgdGhlIGlubmVyIHRleHQgb2YgdGhlIEVsZW1lbnQuCgkqLwoKCWdldFRleHQ6IGZ1bmN0aW9uKCl7CgkJdmFyIHRhZyA9IHRoaXMuZ2V0VGFnKCk7CgkJaWYgKFsnc3R5bGUnLCAnc2NyaXB0J10uY29udGFpbnModGFnKSl7CgkJCWlmICh3aW5kb3cuaWUpewoJCQkJaWYgKHRhZyA9PSAnc3R5bGUnKSByZXR1cm4gdGhpcy5zdHlsZVNoZWV0LmNzc1RleHQ7CgkJCQllbHNlIGlmICh0YWcgPT0gICdzY3JpcHQnKSByZXR1cm4gdGhpcy5nZXRQcm9wZXJ0eSgndGV4dCcpOwoJCQl9IGVsc2UgewoJCQkJcmV0dXJuIHRoaXMuaW5uZXJIVE1MOwoJCQl9CgkJfQoJCXJldHVybiAoJHBpY2sodGhpcy5pbm5lclRleHQsIHRoaXMudGV4dENvbnRlbnQpKTsKCX0sCgoJLyoKCVByb3BlcnR5OiBnZXRUYWcKCQlSZXR1cm5zIHRoZSB0YWdOYW1lIG9mIHRoZSBlbGVtZW50IGluIGxvd2VyIGNhc2UuCgoJRXhhbXBsZToKCQk+JCgnbXlJbWFnZScpLmdldFRhZygpIC8vIHJldHVybnMgJ2ltZycKCglSZXR1cm5zOgoJCVRoZSB0YWcgbmFtZSBpbiBsb3dlciBjYXNlCgkqLwoKCWdldFRhZzogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy50YWdOYW1lLnRvTG93ZXJDYXNlKCk7Cgl9LAoKCS8qCglQcm9wZXJ0eTogZW1wdHkKCQlFbXB0aWVzIGFuIGVsZW1lbnQgb2YgYWxsIGl0cyBjaGlsZHJlbi4KCglFeGFtcGxlOgoJCT4kKCdteURpdicpLmVtcHR5KCkgLy8gZW1wdGllcyB0aGUgRGl2IGFuZCByZXR1cm5zIGl0CgoJUmV0dXJuczoKCQlUaGUgZWxlbWVudC4KCSovCgoJZW1wdHk6IGZ1bmN0aW9uKCl7CgkJR2FyYmFnZS50cmFzaCh0aGlzLmdldEVsZW1lbnRzQnlUYWdOYW1lKCcqJykpOwoJCXJldHVybiB0aGlzLnNldEhUTUwoJycpOwoJfQoKfSk7CgpFbGVtZW50LmZpeFN0eWxlID0gZnVuY3Rpb24ocHJvcGVydHksIHJlc3VsdCwgZWxlbWVudCl7CglpZiAoJGNoayhwYXJzZUludChyZXN1bHQpKSkgcmV0dXJuIHJlc3VsdDsKCWlmIChbJ2hlaWdodCcsICd3aWR0aCddLmNvbnRhaW5zKHByb3BlcnR5KSl7CgkJdmFyIHZhbHVlcyA9IChwcm9wZXJ0eSA9PSAnd2lkdGgnKSA/IFsnbGVmdCcsICdyaWdodCddIDogWyd0b3AnLCAnYm90dG9tJ107CgkJdmFyIHNpemUgPSAwOwoJCXZhbHVlcy5lYWNoKGZ1bmN0aW9uKHZhbHVlKXsKCQkJc2l6ZSArPSBlbGVtZW50LmdldFN0eWxlKCdib3JkZXItJyArIHZhbHVlICsgJy13aWR0aCcpLnRvSW50KCkgKyBlbGVtZW50LmdldFN0eWxlKCdwYWRkaW5nLScgKyB2YWx1ZSkudG9JbnQoKTsKCQl9KTsKCQlyZXR1cm4gZWxlbWVudFsnb2Zmc2V0JyArIHByb3BlcnR5LmNhcGl0YWxpemUoKV0gLSBzaXplICsgJ3B4JzsKCX0gZWxzZSBpZiAocHJvcGVydHkudGVzdCgvYm9yZGVyKC4rKVdpZHRofG1hcmdpbnxwYWRkaW5nLykpewoJCXJldHVybiAnMHB4JzsKCX0KCXJldHVybiByZXN1bHQ7Cn07CgpFbGVtZW50LlN0eWxlcyA9IHsnYm9yZGVyJzogW10sICdwYWRkaW5nJzogW10sICdtYXJnaW4nOiBbXX07ClsnVG9wJywgJ1JpZ2h0JywgJ0JvdHRvbScsICdMZWZ0J10uZWFjaChmdW5jdGlvbihkaXJlY3Rpb24pewoJZm9yICh2YXIgc3R5bGUgaW4gRWxlbWVudC5TdHlsZXMpIEVsZW1lbnQuU3R5bGVzW3N0eWxlXS5wdXNoKHN0eWxlICsgZGlyZWN0aW9uKTsKfSk7CgpFbGVtZW50LmJvcmRlclNob3J0ID0gWydib3JkZXJXaWR0aCcsICdib3JkZXJTdHlsZScsICdib3JkZXJDb2xvciddOwoKRWxlbWVudC5nZXRNYW55ID0gZnVuY3Rpb24oZWwsIG1ldGhvZCwga2V5cyl7Cgl2YXIgcmVzdWx0ID0ge307CgkkZWFjaChrZXlzLCBmdW5jdGlvbihrZXkpewoJCXJlc3VsdFtrZXldID0gZWxbbWV0aG9kXShrZXkpOwoJfSk7CglyZXR1cm4gcmVzdWx0Owp9OwoKRWxlbWVudC5zZXRNYW55ID0gZnVuY3Rpb24oZWwsIG1ldGhvZCwgcGFpcnMpewoJZm9yICh2YXIga2V5IGluIHBhaXJzKSBlbFttZXRob2RdKGtleSwgcGFpcnNba2V5XSk7CglyZXR1cm4gZWw7Cn07CgpFbGVtZW50LlByb3BlcnRpZXMgPSBuZXcgQWJzdHJhY3QoewoJJ2NsYXNzJzogJ2NsYXNzTmFtZScsICdmb3InOiAnaHRtbEZvcicsICdjb2xzcGFuJzogJ2NvbFNwYW4nLCAncm93c3Bhbic6ICdyb3dTcGFuJywKCSdhY2Nlc3NrZXknOiAnYWNjZXNzS2V5JywgJ3RhYmluZGV4JzogJ3RhYkluZGV4JywgJ21heGxlbmd0aCc6ICdtYXhMZW5ndGgnLAoJJ3JlYWRvbmx5JzogJ3JlYWRPbmx5JywgJ2ZyYW1lYm9yZGVyJzogJ2ZyYW1lQm9yZGVyJywgJ3ZhbHVlJzogJ3ZhbHVlJywKCSdkaXNhYmxlZCc6ICdkaXNhYmxlZCcsICdjaGVja2VkJzogJ2NoZWNrZWQnLCAnbXVsdGlwbGUnOiAnbXVsdGlwbGUnLCAnc2VsZWN0ZWQnOiAnc2VsZWN0ZWQnCn0pOwpFbGVtZW50LlByb3BlcnRpZXNJRmxhZyA9IHsKCSdocmVmJzogMiwgJ3NyYyc6IDIKfTsKCkVsZW1lbnQuTWV0aG9kcyA9IHsKCUxpc3RlbmVyczogewoJCWFkZExpc3RlbmVyOiBmdW5jdGlvbih0eXBlLCBmbil7CgkJCWlmICh0aGlzLmFkZEV2ZW50TGlzdGVuZXIpIHRoaXMuYWRkRXZlbnRMaXN0ZW5lcih0eXBlLCBmbiwgZmFsc2UpOwoJCQllbHNlIHRoaXMuYXR0YWNoRXZlbnQoJ29uJyArIHR5cGUsIGZuKTsKCQkJcmV0dXJuIHRoaXM7CgkJfSwKCgkJcmVtb3ZlTGlzdGVuZXI6IGZ1bmN0aW9uKHR5cGUsIGZuKXsKCQkJaWYgKHRoaXMucmVtb3ZlRXZlbnRMaXN0ZW5lcikgdGhpcy5yZW1vdmVFdmVudExpc3RlbmVyKHR5cGUsIGZuLCBmYWxzZSk7CgkJCWVsc2UgdGhpcy5kZXRhY2hFdmVudCgnb24nICsgdHlwZSwgZm4pOwoJCQlyZXR1cm4gdGhpczsKCQl9Cgl9Cn07Cgp3aW5kb3cuZXh0ZW5kKEVsZW1lbnQuTWV0aG9kcy5MaXN0ZW5lcnMpOwpkb2N1bWVudC5leHRlbmQoRWxlbWVudC5NZXRob2RzLkxpc3RlbmVycyk7CkVsZW1lbnQuZXh0ZW5kKEVsZW1lbnQuTWV0aG9kcy5MaXN0ZW5lcnMpOwoKdmFyIEdhcmJhZ2UgPSB7CgoJZWxlbWVudHM6IFtdLAoKCWNvbGxlY3Q6IGZ1bmN0aW9uKGVsKXsKCQlpZiAoIWVsLiR0bXApewoJCQlHYXJiYWdlLmVsZW1lbnRzLnB1c2goZWwpOwoJCQllbC4kdG1wID0geydvcGFjaXR5JzogMX07CgkJfQoJCXJldHVybiBlbDsKCX0sCgoJdHJhc2g6IGZ1bmN0aW9uKGVsZW1lbnRzKXsKCQlmb3IgKHZhciBpID0gMCwgaiA9IGVsZW1lbnRzLmxlbmd0aCwgZWw7IGkgPCBqOyBpKyspewoJCQlpZiAoIShlbCA9IGVsZW1lbnRzW2ldKSB8fCAhZWwuJHRtcCkgY29udGludWU7CgkJCWlmIChlbC4kZXZlbnRzKSBlbC5maXJlRXZlbnQoJ3RyYXNoJykucmVtb3ZlRXZlbnRzKCk7CgkJCWZvciAodmFyIHAgaW4gZWwuJHRtcCkgZWwuJHRtcFtwXSA9IG51bGw7CgkJCWZvciAodmFyIGQgaW4gRWxlbWVudC5wcm90b3R5cGUpIGVsW2RdID0gbnVsbDsKCQkJR2FyYmFnZS5lbGVtZW50c1tHYXJiYWdlLmVsZW1lbnRzLmluZGV4T2YoZWwpXSA9IG51bGw7CgkJCWVsLmh0bWxFbGVtZW50ID0gZWwuJHRtcCA9IGVsID0gbnVsbDsKCQl9CgkJR2FyYmFnZS5lbGVtZW50cy5yZW1vdmUobnVsbCk7Cgl9LAoKCWVtcHR5OiBmdW5jdGlvbigpewoJCUdhcmJhZ2UuY29sbGVjdCh3aW5kb3cpOwoJCUdhcmJhZ2UuY29sbGVjdChkb2N1bWVudCk7CgkJR2FyYmFnZS50cmFzaChHYXJiYWdlLmVsZW1lbnRzKTsKCX0KCn07Cgp3aW5kb3cuYWRkTGlzdGVuZXIoJ2JlZm9yZXVubG9hZCcsIGZ1bmN0aW9uKCl7Cgl3aW5kb3cuYWRkTGlzdGVuZXIoJ3VubG9hZCcsIEdhcmJhZ2UuZW1wdHkpOwoJaWYgKHdpbmRvdy5pZSkgd2luZG93LmFkZExpc3RlbmVyKCd1bmxvYWQnLCBDb2xsZWN0R2FyYmFnZSk7Cn0pOwoKLyoKU2NyaXB0OiBFbGVtZW50LkV2ZW50LmpzCglDb250YWlucyB0aGUgRXZlbnQgQ2xhc3MsIEVsZW1lbnQgbWV0aG9kcyB0byBkZWFsIHdpdGggRWxlbWVudCBldmVudHMsIGN1c3RvbSBFdmVudHMsIGFuZCB0aGUgRnVuY3Rpb24gcHJvdG90eXBlIGJpbmRXaXRoRXZlbnQuCgpMaWNlbnNlOgoJTUlULXN0eWxlIGxpY2Vuc2UuCiovCgovKgpDbGFzczogRXZlbnQKCUNyb3NzIGJyb3dzZXIgbWV0aG9kcyB0byBtYW5hZ2UgZXZlbnRzLgoKQXJndW1lbnRzOgoJZXZlbnQgLSB0aGUgZXZlbnQKClByb3BlcnRpZXM6CglzaGlmdCAtIHRydWUgaWYgdGhlIHVzZXIgcHJlc3NlZCB0aGUgc2hpZnQKCWNvbnRyb2wgLSB0cnVlIGlmIHRoZSB1c2VyIHByZXNzZWQgdGhlIGNvbnRyb2wKCWFsdCAtIHRydWUgaWYgdGhlIHVzZXIgcHJlc3NlZCB0aGUgYWx0CgltZXRhIC0gdHJ1ZSBpZiB0aGUgdXNlciBwcmVzc2VkIHRoZSBtZXRhIGtleQoJd2hlZWwgLSB0aGUgYW1vdW50IG9mIHRoaXJkIGJ1dHRvbiBzY3JvbGxpbmcKCWNvZGUgLSB0aGUga2V5Y29kZSBvZiB0aGUga2V5IHByZXNzZWQKCXBhZ2UueCAtIHRoZSB4IHBvc2l0aW9uIG9mIHRoZSBtb3VzZSwgcmVsYXRpdmUgdG8gdGhlIGZ1bGwgd2luZG93CglwYWdlLnkgLSB0aGUgeSBwb3NpdGlvbiBvZiB0aGUgbW91c2UsIHJlbGF0aXZlIHRvIHRoZSBmdWxsIHdpbmRvdwoJY2xpZW50LnggLSB0aGUgeCBwb3NpdGlvbiBvZiB0aGUgbW91c2UsIHJlbGF0aXZlIHRvIHRoZSB2aWV3cG9ydAoJY2xpZW50LnkgLSB0aGUgeSBwb3NpdGlvbiBvZiB0aGUgbW91c2UsIHJlbGF0aXZlIHRvIHRoZSB2aWV3cG9ydAoJa2V5IC0gdGhlIGtleSBwcmVzc2VkIGFzIGEgbG93ZXJjYXNlIHN0cmluZy4ga2V5IGFsc28gcmV0dXJucyAnZW50ZXInLCAndXAnLCAnZG93bicsICdsZWZ0JywgJ3JpZ2h0JywgJ3NwYWNlJywgJ2JhY2tzcGFjZScsICdkZWxldGUnLCAnZXNjJy4gSGFuZHkgZm9yIHRoZXNlIHNwZWNpYWwga2V5cy4KCXRhcmdldCAtIHRoZSBldmVudCB0YXJnZXQKCXJlbGF0ZWRUYXJnZXQgLSB0aGUgZXZlbnQgcmVsYXRlZCB0YXJnZXQKCkV4YW1wbGU6Cgkoc3RhcnQgY29kZSkKCSQoJ215TGluaycpLm9ua2V5ZG93biA9IGZ1bmN0aW9uKGV2ZW50KXsKCQl2YXIgZXZlbnQgPSBuZXcgRXZlbnQoZXZlbnQpOwoJCS8vZXZlbnQgaXMgbm93IHRoZSBFdmVudCBjbGFzcy4KCQlhbGVydChldmVudC5rZXkpOyAvL3JldHVybnMgdGhlIGxvd2VyY2FzZSBsZXR0ZXIgcHJlc3NlZAoJCWFsZXJ0KGV2ZW50LnNoaWZ0KTsgLy9yZXR1cm5zIHRydWUgaWYgdGhlIGtleSBwcmVzc2VkIGlzIHNoaWZ0CgkJaWYgKGV2ZW50LmtleSA9PSAncycgJiYgZXZlbnQuY29udHJvbCkgYWxlcnQoJ2RvY3VtZW50IHNhdmVkJyk7Cgl9OwoJKGVuZCkKKi8KCnZhciBFdmVudCA9IG5ldyBDbGFzcyh7CgoJaW5pdGlhbGl6ZTogZnVuY3Rpb24oZXZlbnQpewoJCWlmIChldmVudCAmJiBldmVudC4kZXh0ZW5kZWQpIHJldHVybiBldmVudDsKCQl0aGlzLiRleHRlbmRlZCA9IHRydWU7CgkJZXZlbnQgPSBldmVudCB8fCB3aW5kb3cuZXZlbnQ7CgkJdGhpcy5ldmVudCA9IGV2ZW50OwoJCXRoaXMudHlwZSA9IGV2ZW50LnR5cGU7CgkJdGhpcy50YXJnZXQgPSBldmVudC50YXJnZXQgfHwgZXZlbnQuc3JjRWxlbWVudDsKCQlpZiAodGhpcy50YXJnZXQubm9kZVR5cGUgPT0gMykgdGhpcy50YXJnZXQgPSB0aGlzLnRhcmdldC5wYXJlbnROb2RlOwoJCXRoaXMuc2hpZnQgPSBldmVudC5zaGlmdEtleTsKCQl0aGlzLmNvbnRyb2wgPSBldmVudC5jdHJsS2V5OwoJCXRoaXMuYWx0ID0gZXZlbnQuYWx0S2V5OwoJCXRoaXMubWV0YSA9IGV2ZW50Lm1ldGFLZXk7CgkJaWYgKFsnRE9NTW91c2VTY3JvbGwnLCAnbW91c2V3aGVlbCddLmNvbnRhaW5zKHRoaXMudHlwZSkpewoJCQl0aGlzLndoZWVsID0gKGV2ZW50LndoZWVsRGVsdGEpID8gZXZlbnQud2hlZWxEZWx0YSAvIDEyMCA6IC0oZXZlbnQuZGV0YWlsIHx8IDApIC8gMzsKCQl9IGVsc2UgaWYgKHRoaXMudHlwZS5jb250YWlucygna2V5JykpewoJCQl0aGlzLmNvZGUgPSBldmVudC53aGljaCB8fCBldmVudC5rZXlDb2RlOwoJCQlmb3IgKHZhciBuYW1lIGluIEV2ZW50LmtleXMpewoJCQkJaWYgKEV2ZW50LmtleXNbbmFtZV0gPT0gdGhpcy5jb2RlKXsKCQkJCQl0aGlzLmtleSA9IG5hbWU7CgkJCQkJYnJlYWs7CgkJCQl9CgkJCX0KCQkJaWYgKHRoaXMudHlwZSA9PSAna2V5ZG93bicpewoJCQkJdmFyIGZLZXkgPSB0aGlzLmNvZGUgLSAxMTE7CgkJCQlpZiAoZktleSA+IDAgJiYgZktleSA8IDEzKSB0aGlzLmtleSA9ICdmJyArIGZLZXk7CgkJCX0KCQkJdGhpcy5rZXkgPSB0aGlzLmtleSB8fCBTdHJpbmcuZnJvbUNoYXJDb2RlKHRoaXMuY29kZSkudG9Mb3dlckNhc2UoKTsKCQl9IGVsc2UgaWYgKHRoaXMudHlwZS50ZXN0KC8oY2xpY2t8bW91c2V8bWVudSkvKSl7CgkJCXRoaXMucGFnZSA9IHsKCQkJCSd4JzogZXZlbnQucGFnZVggfHwgZXZlbnQuY2xpZW50WCArIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5zY3JvbGxMZWZ0LAoJCQkJJ3knOiBldmVudC5wYWdlWSB8fCBldmVudC5jbGllbnRZICsgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LnNjcm9sbFRvcAoJCQl9OwoJCQl0aGlzLmNsaWVudCA9IHsKCQkJCSd4JzogZXZlbnQucGFnZVggPyBldmVudC5wYWdlWCAtIHdpbmRvdy5wYWdlWE9mZnNldCA6IGV2ZW50LmNsaWVudFgsCgkJCQkneSc6IGV2ZW50LnBhZ2VZID8gZXZlbnQucGFnZVkgLSB3aW5kb3cucGFnZVlPZmZzZXQgOiBldmVudC5jbGllbnRZCgkJCX07CgkJCXRoaXMucmlnaHRDbGljayA9IChldmVudC53aGljaCA9PSAzKSB8fCAoZXZlbnQuYnV0dG9uID09IDIpOwoJCQlzd2l0Y2godGhpcy50eXBlKXsKCQkJCWNhc2UgJ21vdXNlb3Zlcic6IHRoaXMucmVsYXRlZFRhcmdldCA9IGV2ZW50LnJlbGF0ZWRUYXJnZXQgfHwgZXZlbnQuZnJvbUVsZW1lbnQ7IGJyZWFrOwoJCQkJY2FzZSAnbW91c2VvdXQnOiB0aGlzLnJlbGF0ZWRUYXJnZXQgPSBldmVudC5yZWxhdGVkVGFyZ2V0IHx8IGV2ZW50LnRvRWxlbWVudDsKCQkJfQoJCQl0aGlzLmZpeFJlbGF0ZWRUYXJnZXQoKTsKCQl9CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCS8qCglQcm9wZXJ0eTogc3RvcAoJCWNyb3NzIGJyb3dzZXIgbWV0aG9kIHRvIHN0b3AgYW4gZXZlbnQKCSovCgoJc3RvcDogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5zdG9wUHJvcGFnYXRpb24oKS5wcmV2ZW50RGVmYXVsdCgpOwoJfSwKCgkvKgoJUHJvcGVydHk6IHN0b3BQcm9wYWdhdGlvbgoJCWNyb3NzIGJyb3dzZXIgbWV0aG9kIHRvIHN0b3AgdGhlIHByb3BhZ2F0aW9uIG9mIGFuIGV2ZW50CgkqLwoKCXN0b3BQcm9wYWdhdGlvbjogZnVuY3Rpb24oKXsKCQlpZiAodGhpcy5ldmVudC5zdG9wUHJvcGFnYXRpb24pIHRoaXMuZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7CgkJZWxzZSB0aGlzLmV2ZW50LmNhbmNlbEJ1YmJsZSA9IHRydWU7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCS8qCglQcm9wZXJ0eTogcHJldmVudERlZmF1bHQKCQljcm9zcyBicm93c2VyIG1ldGhvZCB0byBwcmV2ZW50IHRoZSBkZWZhdWx0IGFjdGlvbiBvZiB0aGUgZXZlbnQKCSovCgoJcHJldmVudERlZmF1bHQ6IGZ1bmN0aW9uKCl7CgkJaWYgKHRoaXMuZXZlbnQucHJldmVudERlZmF1bHQpIHRoaXMuZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQllbHNlIHRoaXMuZXZlbnQucmV0dXJuVmFsdWUgPSBmYWxzZTsKCQlyZXR1cm4gdGhpczsKCX0KCn0pOwoKRXZlbnQuZml4ID0gewoKCXJlbGF0ZWRUYXJnZXQ6IGZ1bmN0aW9uKCl7CgkJaWYgKHRoaXMucmVsYXRlZFRhcmdldCAmJiB0aGlzLnJlbGF0ZWRUYXJnZXQubm9kZVR5cGUgPT0gMykgdGhpcy5yZWxhdGVkVGFyZ2V0ID0gdGhpcy5yZWxhdGVkVGFyZ2V0LnBhcmVudE5vZGU7Cgl9LAoKCXJlbGF0ZWRUYXJnZXRHZWNrbzogZnVuY3Rpb24oKXsKCQl0cnkge0V2ZW50LmZpeC5yZWxhdGVkVGFyZ2V0LmNhbGwodGhpcyk7fSBjYXRjaChlKXt0aGlzLnJlbGF0ZWRUYXJnZXQgPSB0aGlzLnRhcmdldDt9Cgl9Cgp9OwoKRXZlbnQucHJvdG90eXBlLmZpeFJlbGF0ZWRUYXJnZXQgPSAod2luZG93LmdlY2tvKSA/IEV2ZW50LmZpeC5yZWxhdGVkVGFyZ2V0R2Vja28gOiBFdmVudC5maXgucmVsYXRlZFRhcmdldDsKCi8qClByb3BlcnR5OiBrZXlzCgl5b3UgY2FuIGFkZCBhZGRpdGlvbmFsIEV2ZW50IGtleXMgY29kZXMgdGhpcyB3YXk6CgpFeGFtcGxlOgoJKHN0YXJ0IGNvZGUpCglFdmVudC5rZXlzLndoYXRldmVyID0gODA7CgkkKG15ZWxlbWVudCkuYWRkRXZlbnQoa2V5ZG93biwgZnVuY3Rpb24oZXZlbnQpewoJCWV2ZW50ID0gbmV3IEV2ZW50KGV2ZW50KTsKCQlpZiAoZXZlbnQua2V5ID09ICd3aGF0ZXZlcicpIGNvbnNvbGUubG9nKHdoYXRldmVyIGtleSBjbGlja2VkKS4KCX0pOwoJKGVuZCkKKi8KCkV2ZW50LmtleXMgPSBuZXcgQWJzdHJhY3QoewoJJ2VudGVyJzogMTMsCgkndXAnOiAzOCwKCSdkb3duJzogNDAsCgknbGVmdCc6IDM3LAoJJ3JpZ2h0JzogMzksCgknZXNjJzogMjcsCgknc3BhY2UnOiAzMiwKCSdiYWNrc3BhY2UnOiA4LAoJJ3RhYic6IDksCgknZGVsZXRlJzogNDYKfSk7CgovKgpDbGFzczogRWxlbWVudAoJQ3VzdG9tIGNsYXNzIHRvIGFsbG93IGFsbCBvZiBpdHMgbWV0aG9kcyB0byBiZSB1c2VkIHdpdGggYW55IERPTSBlbGVtZW50IHZpYSB0aGUgZG9sbGFyIGZ1bmN0aW9uIDwkPi4KKi8KCkVsZW1lbnQuTWV0aG9kcy5FdmVudHMgPSB7CgoJLyoKCVByb3BlcnR5OiBhZGRFdmVudAoJCUF0dGFjaGVzIGFuIGV2ZW50IGxpc3RlbmVyIHRvIGEgRE9NIGVsZW1lbnQuCgoJQXJndW1lbnRzOgoJCXR5cGUgLSB0aGUgZXZlbnQgdG8gbW9uaXRvciAoJ2NsaWNrJywgJ2xvYWQnLCBldGMpIHdpdGhvdXQgdGhlIHByZWZpeCAnb24nLgoJCWZuIC0gdGhlIGZ1bmN0aW9uIHRvIGV4ZWN1dGUKCglFeGFtcGxlOgoJCT4kKCdteUVsZW1lbnQnKS5hZGRFdmVudCgnY2xpY2snLCBmdW5jdGlvbigpe2FsZXJ0KCdjbGlja2VkIScpfSk7CgkqLwoKCWFkZEV2ZW50OiBmdW5jdGlvbih0eXBlLCBmbil7CgkJdGhpcy4kZXZlbnRzID0gdGhpcy4kZXZlbnRzIHx8IHt9OwoJCXRoaXMuJGV2ZW50c1t0eXBlXSA9IHRoaXMuJGV2ZW50c1t0eXBlXSB8fCB7J2tleXMnOiBbXSwgJ3ZhbHVlcyc6IFtdfTsKCQlpZiAodGhpcy4kZXZlbnRzW3R5cGVdLmtleXMuY29udGFpbnMoZm4pKSByZXR1cm4gdGhpczsKCQl0aGlzLiRldmVudHNbdHlwZV0ua2V5cy5wdXNoKGZuKTsKCQl2YXIgcmVhbFR5cGUgPSB0eXBlOwoJCXZhciBjdXN0b20gPSBFbGVtZW50LkV2ZW50c1t0eXBlXTsKCQlpZiAoY3VzdG9tKXsKCQkJaWYgKGN1c3RvbS5hZGQpIGN1c3RvbS5hZGQuY2FsbCh0aGlzLCBmbik7CgkJCWlmIChjdXN0b20ubWFwKSBmbiA9IGN1c3RvbS5tYXA7CgkJCWlmIChjdXN0b20udHlwZSkgcmVhbFR5cGUgPSBjdXN0b20udHlwZTsKCQl9CgkJaWYgKCF0aGlzLmFkZEV2ZW50TGlzdGVuZXIpIGZuID0gZm4uY3JlYXRlKHsnYmluZCc6IHRoaXMsICdldmVudCc6IHRydWV9KTsKCQl0aGlzLiRldmVudHNbdHlwZV0udmFsdWVzLnB1c2goZm4pOwoJCXJldHVybiAoRWxlbWVudC5OYXRpdmVFdmVudHMuY29udGFpbnMocmVhbFR5cGUpKSA/IHRoaXMuYWRkTGlzdGVuZXIocmVhbFR5cGUsIGZuKSA6IHRoaXM7Cgl9LAoKCS8qCglQcm9wZXJ0eTogcmVtb3ZlRXZlbnQKCQlXb3JrcyBhcyBFbGVtZW50LmFkZEV2ZW50LCBidXQgaW5zdGVhZCByZW1vdmVzIHRoZSBwcmV2aW91c2x5IGFkZGVkIGV2ZW50IGxpc3RlbmVyLgoJKi8KCglyZW1vdmVFdmVudDogZnVuY3Rpb24odHlwZSwgZm4pewoJCWlmICghdGhpcy4kZXZlbnRzIHx8ICF0aGlzLiRldmVudHNbdHlwZV0pIHJldHVybiB0aGlzOwoJCXZhciBwb3MgPSB0aGlzLiRldmVudHNbdHlwZV0ua2V5cy5pbmRleE9mKGZuKTsKCQlpZiAocG9zID09IC0xKSByZXR1cm4gdGhpczsKCQl2YXIga2V5ID0gdGhpcy4kZXZlbnRzW3R5cGVdLmtleXMuc3BsaWNlKHBvcywxKVswXTsKCQl2YXIgdmFsdWUgPSB0aGlzLiRldmVudHNbdHlwZV0udmFsdWVzLnNwbGljZShwb3MsMSlbMF07CgkJdmFyIGN1c3RvbSA9IEVsZW1lbnQuRXZlbnRzW3R5cGVdOwoJCWlmIChjdXN0b20pewoJCQlpZiAoY3VzdG9tLnJlbW92ZSkgY3VzdG9tLnJlbW92ZS5jYWxsKHRoaXMsIGZuKTsKCQkJaWYgKGN1c3RvbS50eXBlKSB0eXBlID0gY3VzdG9tLnR5cGU7CgkJfQoJCXJldHVybiAoRWxlbWVudC5OYXRpdmVFdmVudHMuY29udGFpbnModHlwZSkpID8gdGhpcy5yZW1vdmVMaXN0ZW5lcih0eXBlLCB2YWx1ZSkgOiB0aGlzOwoJfSwKCgkvKgoJUHJvcGVydHk6IGFkZEV2ZW50cwoJCUFzIDxhZGRFdmVudD4sIGJ1dCBhY2NlcHRzIGFuIG9iamVjdCBhbmQgYWRkIG11bHRpcGxlIGV2ZW50cyBhdCBvbmNlLgoJKi8KCglhZGRFdmVudHM6IGZ1bmN0aW9uKHNvdXJjZSl7CgkJcmV0dXJuIEVsZW1lbnQuc2V0TWFueSh0aGlzLCAnYWRkRXZlbnQnLCBzb3VyY2UpOwoJfSwKCgkvKgoJUHJvcGVydHk6IHJlbW92ZUV2ZW50cwoJCXJlbW92ZXMgYWxsIGV2ZW50cyBvZiBhIGNlcnRhaW4gdHlwZSBmcm9tIGFuIGVsZW1lbnQuIGlmIG5vIGFyZ3VtZW50IGlzIHBhc3NlZCBpbiwgcmVtb3ZlcyBhbGwgZXZlbnRzLgoKCUFyZ3VtZW50czoKCQl0eXBlIC0gc3RyaW5nOyB0aGUgZXZlbnQgbmFtZSAoZS5nLiAnY2xpY2snKQoJKi8KCglyZW1vdmVFdmVudHM6IGZ1bmN0aW9uKHR5cGUpewoJCWlmICghdGhpcy4kZXZlbnRzKSByZXR1cm4gdGhpczsKCQlpZiAoIXR5cGUpewoJCQlmb3IgKHZhciBldlR5cGUgaW4gdGhpcy4kZXZlbnRzKSB0aGlzLnJlbW92ZUV2ZW50cyhldlR5cGUpOwoJCQl0aGlzLiRldmVudHMgPSBudWxsOwoJCX0gZWxzZSBpZiAodGhpcy4kZXZlbnRzW3R5cGVdKXsKCQkJdGhpcy4kZXZlbnRzW3R5cGVdLmtleXMuZWFjaChmdW5jdGlvbihmbil7CgkJCQl0aGlzLnJlbW92ZUV2ZW50KHR5cGUsIGZuKTsKCQkJfSwgdGhpcyk7CgkJCXRoaXMuJGV2ZW50c1t0eXBlXSA9IG51bGw7CgkJfQoJCXJldHVybiB0aGlzOwoJfSwKCgkvKgoJUHJvcGVydHk6IGZpcmVFdmVudAoJCWV4ZWN1dGVzIGFsbCBldmVudHMgb2YgdGhlIHNwZWNpZmllZCB0eXBlIHByZXNlbnQgaW4gdGhlIGVsZW1lbnQuCgoJQXJndW1lbnRzOgoJCXR5cGUgLSBzdHJpbmc7IHRoZSBldmVudCBuYW1lIChlLmcuICdjbGljaycpCgkJYXJncyAtIGFycmF5IG9yIHNpbmdsZSBvYmplY3Q7IGFyZ3VtZW50cyB0byBwYXNzIHRvIHRoZSBmdW5jdGlvbjsgaWYgbW9yZSB0aGFuIG9uZSBhcmd1bWVudCwgbXVzdCBiZSBhbiBhcnJheQoJCWRlbGF5IC0gKGludGVnZXIpIGRlbGF5IChpbiBtcykgdG8gd2FpdCB0byBleGVjdXRlIHRoZSBldmVudAoJKi8KCglmaXJlRXZlbnQ6IGZ1bmN0aW9uKHR5cGUsIGFyZ3MsIGRlbGF5KXsKCQlpZiAodGhpcy4kZXZlbnRzICYmIHRoaXMuJGV2ZW50c1t0eXBlXSl7CgkJCXRoaXMuJGV2ZW50c1t0eXBlXS5rZXlzLmVhY2goZnVuY3Rpb24oZm4pewoJCQkJZm4uY3JlYXRlKHsnYmluZCc6IHRoaXMsICdkZWxheSc6IGRlbGF5LCAnYXJndW1lbnRzJzogYXJnc30pKCk7CgkJCX0sIHRoaXMpOwoJCX0KCQlyZXR1cm4gdGhpczsKCX0sCgoJLyoKCVByb3BlcnR5OiBjbG9uZUV2ZW50cwoJCUNsb25lcyBhbGwgZXZlbnRzIGZyb20gYW4gZWxlbWVudCB0byB0aGlzIGVsZW1lbnQuCgoJQXJndW1lbnRzOgoJCWZyb20gLSBlbGVtZW50LCBjb3B5IGFsbCBldmVudHMgZnJvbSB0aGlzIGVsZW1lbnQKCQl0eXBlIC0gb3B0aW9uYWwsIGNvcGllcyBvbmx5IGV2ZW50cyBvZiB0aGlzIHR5cGUKCSovCgoJY2xvbmVFdmVudHM6IGZ1bmN0aW9uKGZyb20sIHR5cGUpewoJCWlmICghZnJvbS4kZXZlbnRzKSByZXR1cm4gdGhpczsKCQlpZiAoIXR5cGUpewoJCQlmb3IgKHZhciBldlR5cGUgaW4gZnJvbS4kZXZlbnRzKSB0aGlzLmNsb25lRXZlbnRzKGZyb20sIGV2VHlwZSk7CgkJfSBlbHNlIGlmIChmcm9tLiRldmVudHNbdHlwZV0pewoJCQlmcm9tLiRldmVudHNbdHlwZV0ua2V5cy5lYWNoKGZ1bmN0aW9uKGZuKXsKCQkJCXRoaXMuYWRkRXZlbnQodHlwZSwgZm4pOwoJCQl9LCB0aGlzKTsKCQl9CgkJcmV0dXJuIHRoaXM7Cgl9Cgp9OwoKd2luZG93LmV4dGVuZChFbGVtZW50Lk1ldGhvZHMuRXZlbnRzKTsKZG9jdW1lbnQuZXh0ZW5kKEVsZW1lbnQuTWV0aG9kcy5FdmVudHMpOwpFbGVtZW50LmV4dGVuZChFbGVtZW50Lk1ldGhvZHMuRXZlbnRzKTsKCi8qIFNlY3Rpb246IEN1c3RvbSBFdmVudHMgKi8KCkVsZW1lbnQuRXZlbnRzID0gbmV3IEFic3RyYWN0KHsKCgkvKgoJRXZlbnQ6IG1vdXNlZW50ZXIKCQlJbiBhZGRpdGlvbiB0byB0aGUgc3RhbmRhcmQgamF2YXNjcmlwdCBldmVudHMgKGxvYWQsIG1vdXNlb3ZlciwgbW91c2VvdXQsIGNsaWNrLCBldGMuKSA8RXZlbnQuanM+IGNvbnRhaW5zIHR3byBjdXN0b20gZXZlbnRzCgkJdGhpcyBldmVudCBmaXJlcyB3aGVuIHRoZSBtb3VzZSBlbnRlcnMgdGhlIGFyZWEgb2YgdGhlIGRvbSBlbGVtZW50OyB3aWxsIG5vdCBiZSBmaXJlZCBhZ2FpbiBpZiB0aGUgbW91c2UgY3Jvc3NlcyBvdmVyIGNoaWxkcmVuIG9mIHRoZSBlbGVtZW50ICh1bmxpa2UgbW91c2VvdmVyKQoKCUV4YW1wbGU6CgkJPiQobXlFbGVtZW50KS5hZGRFdmVudCgnbW91c2VlbnRlcicsIG15RnVuY3Rpb24pOwoJKi8KCgknbW91c2VlbnRlcic6IHsKCQl0eXBlOiAnbW91c2VvdmVyJywKCQltYXA6IGZ1bmN0aW9uKGV2ZW50KXsKCQkJZXZlbnQgPSBuZXcgRXZlbnQoZXZlbnQpOwoJCQlpZiAoZXZlbnQucmVsYXRlZFRhcmdldCAhPSB0aGlzICYmICF0aGlzLmhhc0NoaWxkKGV2ZW50LnJlbGF0ZWRUYXJnZXQpKSB0aGlzLmZpcmVFdmVudCgnbW91c2VlbnRlcicsIGV2ZW50KTsKCQl9Cgl9LAoKCS8qCglFdmVudDogbW91c2VsZWF2ZQoJCXRoaXMgZXZlbnQgZmlyZXMgd2hlbiB0aGUgbW91c2UgZXhpdHMgdGhlIGFyZWEgb2YgdGhlIGRvbSBlbGVtZW50OyB3aWxsIG5vdCBiZSBmaXJlZCBhZ2FpbiBpZiB0aGUgbW91c2UgY3Jvc3NlcyBvdmVyIGNoaWxkcmVuIG9mIHRoZSBlbGVtZW50ICh1bmxpa2UgbW91c2VvdXQpCgoJRXhhbXBsZToKCQk+JChteUVsZW1lbnQpLmFkZEV2ZW50KCdtb3VzZWxlYXZlJywgbXlGdW5jdGlvbik7CgkqLwoKCSdtb3VzZWxlYXZlJzogewoJCXR5cGU6ICdtb3VzZW91dCcsCgkJbWFwOiBmdW5jdGlvbihldmVudCl7CgkJCWV2ZW50ID0gbmV3IEV2ZW50KGV2ZW50KTsKCQkJaWYgKGV2ZW50LnJlbGF0ZWRUYXJnZXQgIT0gdGhpcyAmJiAhdGhpcy5oYXNDaGlsZChldmVudC5yZWxhdGVkVGFyZ2V0KSkgdGhpcy5maXJlRXZlbnQoJ21vdXNlbGVhdmUnLCBldmVudCk7CgkJfQoJfSwKCgknbW91c2V3aGVlbCc6IHsKCQl0eXBlOiAod2luZG93LmdlY2tvKSA/ICdET01Nb3VzZVNjcm9sbCcgOiAnbW91c2V3aGVlbCcKCX0KCn0pOwoKRWxlbWVudC5OYXRpdmVFdmVudHMgPSBbCgknY2xpY2snLCAnZGJsY2xpY2snLCAnbW91c2V1cCcsICdtb3VzZWRvd24nLCAvL21vdXNlIGJ1dHRvbnMKCSdtb3VzZXdoZWVsJywgJ0RPTU1vdXNlU2Nyb2xsJywgLy9tb3VzZSB3aGVlbAoJJ21vdXNlb3ZlcicsICdtb3VzZW91dCcsICdtb3VzZW1vdmUnLCAvL21vdXNlIG1vdmVtZW50Cgkna2V5ZG93bicsICdrZXlwcmVzcycsICdrZXl1cCcsIC8va2V5cwoJJ2xvYWQnLCAndW5sb2FkJywgJ2JlZm9yZXVubG9hZCcsICdyZXNpemUnLCAnbW92ZScsIC8vd2luZG93CgknZm9jdXMnLCAnYmx1cicsICdjaGFuZ2UnLCAnc3VibWl0JywgJ3Jlc2V0JywgJ3NlbGVjdCcsIC8vZm9ybXMgZWxlbWVudHMKCSdlcnJvcicsICdhYm9ydCcsICdjb250ZXh0bWVudScsICdzY3JvbGwnIC8vbWlzYwpdOwoKLyoKQ2xhc3M6IEZ1bmN0aW9uCglBIGNvbGxlY3Rpb24gb2YgVGhlIEZ1bmN0aW9uIE9iamVjdCBwcm90b3R5cGUgbWV0aG9kcy4KKi8KCkZ1bmN0aW9uLmV4dGVuZCh7CgoJLyoKCVByb3BlcnR5OiBiaW5kV2l0aEV2ZW50CgkJYXV0b21hdGljYWxseSBwYXNzZXMgTW9vVG9vbHMgRXZlbnQgQ2xhc3MuCgoJQXJndW1lbnRzOgoJCWJpbmQgLSBvcHRpb25hbCwgdGhlIG9iamVjdCB0aGF0IHRoZSAidGhpcyIgb2YgdGhlIGZ1bmN0aW9uIHdpbGwgcmVmZXIgdG8uCgkJYXJncyAtIG9wdGlvbmFsLCBhbiBhcmd1bWVudCB0byBwYXNzIHRvIHRoZSBmdW5jdGlvbjsgaWYgbW9yZSB0aGFuIG9uZSBhcmd1bWVudCwgaXQgbXVzdCBiZSBhbiBhcnJheSBvZiBhcmd1bWVudHMuCgoJUmV0dXJuczoKCQlhIGZ1bmN0aW9uIHdpdGggdGhlIHBhcmFtZXRlciBiaW5kIGFzIGl0cyAidGhpcyIgYW5kIGFzIGEgcHJlLXBhc3NlZCBhcmd1bWVudCBldmVudCBvciB3aW5kb3cuZXZlbnQsIGRlcGVuZGluZyBvbiB0aGUgYnJvd3Nlci4KCglFeGFtcGxlOgoJCT5mdW5jdGlvbiBteUZ1bmN0aW9uKGV2ZW50KXsKCQk+CWFsZXJ0KGV2ZW50LmNsaWVudC54KSAvL3JldHVybnMgdGhlIGNvb3JkaW5hdGVzIG9mIHRoZSBtb3VzZS4uCgkJPn07CgkJPm15RWxlbWVudC5hZGRFdmVudCgnY2xpY2snLCBteUZ1bmN0aW9uLmJpbmRXaXRoRXZlbnQobXlFbGVtZW50KSk7CgkqLwoKCWJpbmRXaXRoRXZlbnQ6IGZ1bmN0aW9uKGJpbmQsIGFyZ3MpewoJCXJldHVybiB0aGlzLmNyZWF0ZSh7J2JpbmQnOiBiaW5kLCAnYXJndW1lbnRzJzogYXJncywgJ2V2ZW50JzogRXZlbnR9KTsKCX0KCn0pOwoKLyoKU2NyaXB0OiBFbGVtZW50LkZpbHRlcnMuanMKCWFkZCBGaWx0ZXJzIGNhcGFiaWxpdHkgdG8gPEVsZW1lbnRzPi4KCkxpY2Vuc2U6CglNSVQtc3R5bGUgbGljZW5zZS4KKi8KCi8qCkNsYXNzOiBFbGVtZW50cwoJQSBjb2xsZWN0aW9uIG9mIG1ldGhvZHMgdG8gYmUgdXNlZCB3aXRoIDwkJD4gZWxlbWVudHMgY29sbGVjdGlvbnMuCiovCgpFbGVtZW50cy5leHRlbmQoewoKCS8qCglQcm9wZXJ0eTogZmlsdGVyQnlUYWcKCQlGaWx0ZXJzIHRoZSBjb2xsZWN0aW9uIGJ5IGEgc3BlY2lmaWVkIHRhZyBuYW1lLgoJCVJldHVybnMgYSBuZXcgRWxlbWVudHMgY29sbGVjdGlvbiwgd2hpbGUgdGhlIG9yaWdpbmFsIHJlbWFpbnMgdW50b3VjaGVkLgoJKi8KCglmaWx0ZXJCeVRhZzogZnVuY3Rpb24odGFnKXsKCQlyZXR1cm4gbmV3IEVsZW1lbnRzKHRoaXMuZmlsdGVyKGZ1bmN0aW9uKGVsKXsKCQkJcmV0dXJuIChFbGVtZW50LmdldFRhZyhlbCkgPT0gdGFnKTsKCQl9KSk7Cgl9LAoKCS8qCglQcm9wZXJ0eTogZmlsdGVyQnlDbGFzcwoJCUZpbHRlcnMgdGhlIGNvbGxlY3Rpb24gYnkgYSBzcGVjaWZpZWQgY2xhc3MgbmFtZS4KCQlSZXR1cm5zIGEgbmV3IEVsZW1lbnRzIGNvbGxlY3Rpb24sIHdoaWxlIHRoZSBvcmlnaW5hbCByZW1haW5zIHVudG91Y2hlZC4KCSovCgoJZmlsdGVyQnlDbGFzczogZnVuY3Rpb24oY2xhc3NOYW1lLCBub2Nhc2gpewoJCXZhciBlbGVtZW50cyA9IHRoaXMuZmlsdGVyKGZ1bmN0aW9uKGVsKXsKCQkJcmV0dXJuIChlbC5jbGFzc05hbWUgJiYgZWwuY2xhc3NOYW1lLmNvbnRhaW5zKGNsYXNzTmFtZSwgJyAnKSk7CgkJfSk7CgkJcmV0dXJuIChub2Nhc2gpID8gZWxlbWVudHMgOiBuZXcgRWxlbWVudHMoZWxlbWVudHMpOwoJfSwKCgkvKgoJUHJvcGVydHk6IGZpbHRlckJ5SWQKCQlGaWx0ZXJzIHRoZSBjb2xsZWN0aW9uIGJ5IGEgc3BlY2lmaWVkIElELgoJCVJldHVybnMgYSBuZXcgRWxlbWVudHMgY29sbGVjdGlvbiwgd2hpbGUgdGhlIG9yaWdpbmFsIHJlbWFpbnMgdW50b3VjaGVkLgoJKi8KCglmaWx0ZXJCeUlkOiBmdW5jdGlvbihpZCwgbm9jYXNoKXsKCQl2YXIgZWxlbWVudHMgPSB0aGlzLmZpbHRlcihmdW5jdGlvbihlbCl7CgkJCXJldHVybiAoZWwuaWQgPT0gaWQpOwoJCX0pOwoJCXJldHVybiAobm9jYXNoKSA/IGVsZW1lbnRzIDogbmV3IEVsZW1lbnRzKGVsZW1lbnRzKTsKCX0sCgoJLyoKCVByb3BlcnR5OiBmaWx0ZXJCeUF0dHJpYnV0ZQoJCUZpbHRlcnMgdGhlIGNvbGxlY3Rpb24gYnkgYSBzcGVjaWZpZWQgYXR0cmlidXRlLgoJCVJldHVybnMgYSBuZXcgRWxlbWVudHMgY29sbGVjdGlvbiwgd2hpbGUgdGhlIG9yaWdpbmFsIHJlbWFpbnMgdW50b3VjaGVkLgoKCUFyZ3VtZW50czoKCQluYW1lIC0gdGhlIGF0dHJpYnV0ZSBuYW1lLgoJCW9wZXJhdG9yIC0gb3B0aW9uYWwsIHRoZSBhdHRyaWJ1dGUgb3BlcmF0b3IuCgkJdmFsdWUgLSBvcHRpb25hbCwgdGhlIGF0dHJpYnV0ZSB2YWx1ZSwgb25seSB2YWxpZCBpZiB0aGUgb3BlcmF0b3IgaXMgc3BlY2lmaWVkLgoJKi8KCglmaWx0ZXJCeUF0dHJpYnV0ZTogZnVuY3Rpb24obmFtZSwgb3BlcmF0b3IsIHZhbHVlLCBub2Nhc2gpewoJCXZhciBlbGVtZW50cyA9IHRoaXMuZmlsdGVyKGZ1bmN0aW9uKGVsKXsKCQkJdmFyIGN1cnJlbnQgPSBFbGVtZW50LmdldFByb3BlcnR5KGVsLCBuYW1lKTsKCQkJaWYgKCFjdXJyZW50KSByZXR1cm4gZmFsc2U7CgkJCWlmICghb3BlcmF0b3IpIHJldHVybiB0cnVlOwoJCQlzd2l0Y2gob3BlcmF0b3IpewoJCQkJY2FzZSAnPSc6IHJldHVybiAoY3VycmVudCA9PSB2YWx1ZSk7CgkJCQljYXNlICcqPSc6IHJldHVybiAoY3VycmVudC5jb250YWlucyh2YWx1ZSkpOwoJCQkJY2FzZSAnXj0nOiByZXR1cm4gKGN1cnJlbnQuc3Vic3RyKDAsIHZhbHVlLmxlbmd0aCkgPT0gdmFsdWUpOwoJCQkJY2FzZSAnJD0nOiByZXR1cm4gKGN1cnJlbnQuc3Vic3RyKGN1cnJlbnQubGVuZ3RoIC0gdmFsdWUubGVuZ3RoKSA9PSB2YWx1ZSk7CgkJCQljYXNlICchPSc6IHJldHVybiAoY3VycmVudCAhPSB2YWx1ZSk7CgkJCQljYXNlICd+PSc6IHJldHVybiBjdXJyZW50LmNvbnRhaW5zKHZhbHVlLCAnICcpOwoJCQl9CgkJCXJldHVybiBmYWxzZTsKCQl9KTsKCQlyZXR1cm4gKG5vY2FzaCkgPyBlbGVtZW50cyA6IG5ldyBFbGVtZW50cyhlbGVtZW50cyk7Cgl9Cgp9KTsKCi8qClNjcmlwdDogRWxlbWVudC5TZWxlY3RvcnMuanMKCUNzcyBRdWVyeSByZWxhdGVkIGZ1bmN0aW9ucyBhbmQgPEVsZW1lbnQ+IGV4dGVuc2lvbnMKCkxpY2Vuc2U6CglNSVQtc3R5bGUgbGljZW5zZS4KKi8KCi8qIFNlY3Rpb246IFV0aWxpdHkgRnVuY3Rpb25zICovCgovKgpGdW5jdGlvbjogJEUKCVNlbGVjdHMgYSBzaW5nbGUgKGkuZS4gdGhlIGZpcnN0IGZvdW5kKSBFbGVtZW50IGJhc2VkIG9uIHRoZSBzZWxlY3RvciBwYXNzZWQgaW4gYW5kIGFuIG9wdGlvbmFsIGZpbHRlciBlbGVtZW50LgoJUmV0dXJucyBhcyA8RWxlbWVudD4uCgpBcmd1bWVudHM6CglzZWxlY3RvciAtIHN0cmluZzsgdGhlIGNzcyBzZWxlY3RvciB0byBtYXRjaAoJZmlsdGVyIC0gb3B0aW9uYWw7IGEgRE9NIGVsZW1lbnQgdG8gbGltaXQgdGhlIHNjb3BlIG9mIHRoZSBzZWxlY3RvciBtYXRjaDsgZGVmYXVsdHMgdG8gZG9jdW1lbnQuCgpFeGFtcGxlOgoJPiRFKCdhJywgJ215RWxlbWVudCcpIC8vZmluZCB0aGUgZmlyc3QgYW5jaG9yIHRhZyBpbnNpZGUgdGhlIERPTSBlbGVtZW50IHdpdGggaWQgJ215RWxlbWVudCcKClJldHVybnM6CglhIERPTSBlbGVtZW50IC0gdGhlIGZpcnN0IGVsZW1lbnQgdGhhdCBtYXRjaGVzIHRoZSBzZWxlY3RvcgoqLwoKZnVuY3Rpb24gJEUoc2VsZWN0b3IsIGZpbHRlcil7CglyZXR1cm4gKCQoZmlsdGVyKSB8fCBkb2N1bWVudCkuZ2V0RWxlbWVudChzZWxlY3Rvcik7Cn07CgovKgpGdW5jdGlvbjogJEVTCglSZXR1cm5zIGEgY29sbGVjdGlvbiBvZiBFbGVtZW50cyB0aGF0IG1hdGNoIHRoZSBzZWxlY3RvciBwYXNzZWQgaW4gbGltaXRlZCB0byB0aGUgc2NvcGUgb2YgdGhlIG9wdGlvbmFsIGZpbHRlci4KCVNlZSBBbHNvOiA8RWxlbWVudC5nZXRFbGVtZW50cz4gZm9yIGFuIGFsdGVybmF0ZSBzeW50YXguCglSZXR1cm5zIGFzIDxFbGVtZW50cz4uCgpSZXR1cm5zOgoJYW4gYXJyYXkgb2YgZG9tIGVsZW1lbnRzIHRoYXQgbWF0Y2ggdGhlIHNlbGVjdG9yIHdpdGhpbiB0aGUgZmlsdGVyCgpBcmd1bWVudHM6CglzZWxlY3RvciAtIHN0cmluZzsgY3NzIHNlbGVjdG9yIHRvIG1hdGNoCglmaWx0ZXIgLSBvcHRpb25hbDsgYSBET00gZWxlbWVudCB0byBsaW1pdCB0aGUgc2NvcGUgb2YgdGhlIHNlbGVjdG9yIG1hdGNoOyBkZWZhdWx0cyB0byBkb2N1bWVudC4KCkV4YW1wbGVzOgoJPiRFUygiYSIpIC8vZ2V0cyBhbGwgdGhlIGFuY2hvciB0YWdzOyBzeW5vbnltb3VzIHdpdGggJCQoImEiKQoJPiRFUygnYScsJ215RWxlbWVudCcpIC8vZ2V0IGFsbCB0aGUgYW5jaG9yIHRhZ3Mgd2l0aGluICQoJ215RWxlbWVudCcpCiovCgpmdW5jdGlvbiAkRVMoc2VsZWN0b3IsIGZpbHRlcil7CglyZXR1cm4gKCQoZmlsdGVyKSB8fCBkb2N1bWVudCkuZ2V0RWxlbWVudHNCeVNlbGVjdG9yKHNlbGVjdG9yKTsKfTsKCiQkLnNoYXJlZCA9IHsKCgkncmVnZXhwJzogL14oXHcqfFwqKSg/OiMoW1x3LV0rKXxcLihbXHctXSspKT8oPzpcWyhcdyspKD86KFshKl4kXT89KVsiJ10/KFteIidcXV0qKVsiJ10/KT9dKT8kLywKCgkneHBhdGgnOiB7CgoJCWdldFBhcmFtOiBmdW5jdGlvbihpdGVtcywgY29udGV4dCwgcGFyYW0sIGkpewoJCQl2YXIgdGVtcCA9IFtjb250ZXh0Lm5hbWVzcGFjZVVSSSA/ICd4aHRtbDonIDogJycsIHBhcmFtWzFdXTsKCQkJaWYgKHBhcmFtWzJdKSB0ZW1wLnB1c2goJ1tAaWQ9IicsIHBhcmFtWzJdLCAnIl0nKTsKCQkJaWYgKHBhcmFtWzNdKSB0ZW1wLnB1c2goJ1tjb250YWlucyhjb25jYXQoIiAiLCBAY2xhc3MsICIgIiksICIgJywgcGFyYW1bM10sICcgIildJyk7CgkJCWlmIChwYXJhbVs0XSl7CgkJCQlpZiAocGFyYW1bNV0gJiYgcGFyYW1bNl0pewoJCQkJCXN3aXRjaChwYXJhbVs1XSl7CgkJCQkJCWNhc2UgJyo9JzogdGVtcC5wdXNoKCdbY29udGFpbnMoQCcsIHBhcmFtWzRdLCAnLCAiJywgcGFyYW1bNl0sICciKV0nKTsgYnJlYWs7CgkJCQkJCWNhc2UgJ149JzogdGVtcC5wdXNoKCdbc3RhcnRzLXdpdGgoQCcsIHBhcmFtWzRdLCAnLCAiJywgcGFyYW1bNl0sICciKV0nKTsgYnJlYWs7CgkJCQkJCWNhc2UgJyQ9JzogdGVtcC5wdXNoKCdbc3Vic3RyaW5nKEAnLCBwYXJhbVs0XSwgJywgc3RyaW5nLWxlbmd0aChAJywgcGFyYW1bNF0sICcpIC0gJywgcGFyYW1bNl0ubGVuZ3RoLCAnICsgMSkgPSAiJywgcGFyYW1bNl0sICciXScpOyBicmVhazsKCQkJCQkJY2FzZSAnPSc6IHRlbXAucHVzaCgnW0AnLCBwYXJhbVs0XSwgJz0iJywgcGFyYW1bNl0sICciXScpOyBicmVhazsKCQkJCQkJY2FzZSAnIT0nOiB0ZW1wLnB1c2goJ1tAJywgcGFyYW1bNF0sICchPSInLCBwYXJhbVs2XSwgJyJdJyk7CgkJCQkJfQoJCQkJfSBlbHNlIHsKCQkJCQl0ZW1wLnB1c2goJ1tAJywgcGFyYW1bNF0sICddJyk7CgkJCQl9CgkJCX0KCQkJaXRlbXMucHVzaCh0ZW1wLmpvaW4oJycpKTsKCQkJcmV0dXJuIGl0ZW1zOwoJCX0sCgoJCWdldEl0ZW1zOiBmdW5jdGlvbihpdGVtcywgY29udGV4dCwgbm9jYXNoKXsKCQkJdmFyIGVsZW1lbnRzID0gW107CgkJCXZhciB4cGF0aCA9IGRvY3VtZW50LmV2YWx1YXRlKCcuLy8nICsgaXRlbXMuam9pbignLy8nKSwgY29udGV4dCwgJCQuc2hhcmVkLnJlc29sdmVyLCBYUGF0aFJlc3VsdC5VTk9SREVSRURfTk9ERV9TTkFQU0hPVF9UWVBFLCBudWxsKTsKCQkJZm9yICh2YXIgaSA9IDAsIGogPSB4cGF0aC5zbmFwc2hvdExlbmd0aDsgaSA8IGo7IGkrKykgZWxlbWVudHMucHVzaCh4cGF0aC5zbmFwc2hvdEl0ZW0oaSkpOwoJCQlyZXR1cm4gKG5vY2FzaCkgPyBlbGVtZW50cyA6IG5ldyBFbGVtZW50cyhlbGVtZW50cy5tYXAoJCkpOwoJCX0KCgl9LAoKCSdub3JtYWwnOiB7CgoJCWdldFBhcmFtOiBmdW5jdGlvbihpdGVtcywgY29udGV4dCwgcGFyYW0sIGkpewoJCQlpZiAoaSA9PSAwKXsKCQkJCWlmIChwYXJhbVsyXSl7CgkJCQkJdmFyIGVsID0gY29udGV4dC5nZXRFbGVtZW50QnlJZChwYXJhbVsyXSk7CgkJCQkJaWYgKCFlbCB8fCAoKHBhcmFtWzFdICE9ICcqJykgJiYgKEVsZW1lbnQuZ2V0VGFnKGVsKSAhPSBwYXJhbVsxXSkpKSByZXR1cm4gZmFsc2U7CgkJCQkJaXRlbXMgPSBbZWxdOwoJCQkJfSBlbHNlIHsKCQkJCQlpdGVtcyA9ICRBKGNvbnRleHQuZ2V0RWxlbWVudHNCeVRhZ05hbWUocGFyYW1bMV0pKTsKCQkJCX0KCQkJfSBlbHNlIHsKCQkJCWl0ZW1zID0gJCQuc2hhcmVkLmdldEVsZW1lbnRzQnlUYWdOYW1lKGl0ZW1zLCBwYXJhbVsxXSk7CgkJCQlpZiAocGFyYW1bMl0pIGl0ZW1zID0gRWxlbWVudHMuZmlsdGVyQnlJZChpdGVtcywgcGFyYW1bMl0sIHRydWUpOwoJCQl9CgkJCWlmIChwYXJhbVszXSkgaXRlbXMgPSBFbGVtZW50cy5maWx0ZXJCeUNsYXNzKGl0ZW1zLCBwYXJhbVszXSwgdHJ1ZSk7CgkJCWlmIChwYXJhbVs0XSkgaXRlbXMgPSBFbGVtZW50cy5maWx0ZXJCeUF0dHJpYnV0ZShpdGVtcywgcGFyYW1bNF0sIHBhcmFtWzVdLCBwYXJhbVs2XSwgdHJ1ZSk7CgkJCXJldHVybiBpdGVtczsKCQl9LAoKCQlnZXRJdGVtczogZnVuY3Rpb24oaXRlbXMsIGNvbnRleHQsIG5vY2FzaCl7CgkJCXJldHVybiAobm9jYXNoKSA/IGl0ZW1zIDogJCQudW5pcXVlKGl0ZW1zKTsKCQl9CgoJfSwKCglyZXNvbHZlcjogZnVuY3Rpb24ocHJlZml4KXsKCQlyZXR1cm4gKHByZWZpeCA9PSAneGh0bWwnKSA/ICdodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hodG1sJyA6IGZhbHNlOwoJfSwKCglnZXRFbGVtZW50c0J5VGFnTmFtZTogZnVuY3Rpb24oY29udGV4dCwgdGFnTmFtZSl7CgkJdmFyIGZvdW5kID0gW107CgkJZm9yICh2YXIgaSA9IDAsIGogPSBjb250ZXh0Lmxlbmd0aDsgaSA8IGo7IGkrKykgZm91bmQuZXh0ZW5kKGNvbnRleHRbaV0uZ2V0RWxlbWVudHNCeVRhZ05hbWUodGFnTmFtZSkpOwoJCXJldHVybiBmb3VuZDsKCX0KCn07CgokJC5zaGFyZWQubWV0aG9kID0gKHdpbmRvdy54cGF0aCkgPyAneHBhdGgnIDogJ25vcm1hbCc7CgovKgpDbGFzczogRWxlbWVudAoJQ3VzdG9tIGNsYXNzIHRvIGFsbG93IGFsbCBvZiBpdHMgbWV0aG9kcyB0byBiZSB1c2VkIHdpdGggYW55IERPTSBlbGVtZW50IHZpYSB0aGUgZG9sbGFyIGZ1bmN0aW9uIDwkPi4KKi8KCkVsZW1lbnQuTWV0aG9kcy5Eb20gPSB7CgoJLyoKCVByb3BlcnR5OiBnZXRFbGVtZW50cwoJCUdldHMgYWxsIHRoZSBlbGVtZW50cyB3aXRoaW4gYW4gZWxlbWVudCB0aGF0IG1hdGNoIHRoZSBnaXZlbiAoc2luZ2xlKSBzZWxlY3Rvci4KCQlSZXR1cm5zIGFzIDxFbGVtZW50cz4uCgoJQXJndW1lbnRzOgoJCXNlbGVjdG9yIC0gc3RyaW5nOyB0aGUgY3NzIHNlbGVjdG9yIHRvIG1hdGNoCgoJRXhhbXBsZXM6CgkJPiQoJ215RWxlbWVudCcpLmdldEVsZW1lbnRzKCdhJyk7IC8vIGdldCBhbGwgYW5jaG9ycyB3aXRoaW4gbXlFbGVtZW50CgkJPiQoJ215RWxlbWVudCcpLmdldEVsZW1lbnRzKCdpbnB1dFtuYW1lPWRpYWxvZ10nKSAvL2dldCBhbGwgaW5wdXQgdGFncyB3aXRoIG5hbWUgJ2RpYWxvZycKCQk+JCgnbXlFbGVtZW50JykuZ2V0RWxlbWVudHMoJ2lucHV0W25hbWUkPWxvZ10nKSAvL2dldCBhbGwgaW5wdXQgdGFncyB3aXRoIG5hbWVzIGVuZGluZyB3aXRoICdsb2cnCgoJTm90ZXM6CgkJU3VwcG9ydHMgdGhlc2Ugb3BlcmF0b3JzIGluIGF0dHJpYnV0ZSBzZWxlY3RvcnM6CgoJCS0gPSA6IGlzIGVxdWFsIHRvCgkJLSBePSA6IHN0YXJ0cy13aXRoCgkJLSAkPSA6IGVuZHMtd2l0aAoJCS0gIT0gOiBpcyBub3QgZXF1YWwgdG8KCgkJWHBhdGggaXMgdXNlZCBhdXRvbWF0aWNhbGx5IGZvciBjb21wbGlhbnQgYnJvd3NlcnMuCgkqLwoKCWdldEVsZW1lbnRzOiBmdW5jdGlvbihzZWxlY3Rvciwgbm9jYXNoKXsKCQl2YXIgaXRlbXMgPSBbXTsKCQlzZWxlY3RvciA9IHNlbGVjdG9yLnRyaW0oKS5zcGxpdCgnICcpOwoJCWZvciAodmFyIGkgPSAwLCBqID0gc2VsZWN0b3IubGVuZ3RoOyBpIDwgajsgaSsrKXsKCQkJdmFyIHNlbCA9IHNlbGVjdG9yW2ldOwoJCQl2YXIgcGFyYW0gPSBzZWwubWF0Y2goJCQuc2hhcmVkLnJlZ2V4cCk7CgkJCWlmICghcGFyYW0pIGJyZWFrOwoJCQlwYXJhbVsxXSA9IHBhcmFtWzFdIHx8ICcqJzsKCQkJdmFyIHRlbXAgPSAkJC5zaGFyZWRbJCQuc2hhcmVkLm1ldGhvZF0uZ2V0UGFyYW0oaXRlbXMsIHRoaXMsIHBhcmFtLCBpKTsKCQkJaWYgKCF0ZW1wKSBicmVhazsKCQkJaXRlbXMgPSB0ZW1wOwoJCX0KCQlyZXR1cm4gJCQuc2hhcmVkWyQkLnNoYXJlZC5tZXRob2RdLmdldEl0ZW1zKGl0ZW1zLCB0aGlzLCBub2Nhc2gpOwoJfSwKCgkvKgoJUHJvcGVydHk6IGdldEVsZW1lbnQKCQlTYW1lIGFzIDxFbGVtZW50LmdldEVsZW1lbnRzPiwgYnV0IHJldHVybnMgb25seSB0aGUgZmlyc3QuIEFsdGVybmF0ZSBzeW50YXggZm9yIDwkRT4sIHdoZXJlIGZpbHRlciBpcyB0aGUgRWxlbWVudC4KCQlSZXR1cm5zIGFzIDxFbGVtZW50Pi4KCglBcmd1bWVudHM6CgkJc2VsZWN0b3IgLSBzdHJpbmc7IGNzcyBzZWxlY3RvcgoJKi8KCglnZXRFbGVtZW50OiBmdW5jdGlvbihzZWxlY3Rvcil7CgkJcmV0dXJuICQodGhpcy5nZXRFbGVtZW50cyhzZWxlY3RvciwgdHJ1ZSlbMF0gfHwgZmFsc2UpOwoJfSwKCgkvKgoJUHJvcGVydHk6IGdldEVsZW1lbnRzQnlTZWxlY3RvcgoJCVNhbWUgYXMgPEVsZW1lbnQuZ2V0RWxlbWVudHM+LCBidXQgYWxsb3dzIGZvciBjb21tYSBzZXBhcmF0ZWQgc2VsZWN0b3JzLCBhcyBpbiBjc3MuIEFsdGVybmF0ZSBzeW50YXggZm9yIDwkJD4sIHdoZXJlIGZpbHRlciBpcyB0aGUgRWxlbWVudC4KCQlSZXR1cm5zIGFzIDxFbGVtZW50cz4uCgoJQXJndW1lbnRzOgoJCXNlbGVjdG9yIC0gc3RyaW5nOyBjc3Mgc2VsZWN0b3IKCSovCgoJZ2V0RWxlbWVudHNCeVNlbGVjdG9yOiBmdW5jdGlvbihzZWxlY3Rvciwgbm9jYXNoKXsKCQl2YXIgZWxlbWVudHMgPSBbXTsKCQlzZWxlY3RvciA9IHNlbGVjdG9yLnNwbGl0KCcsJyk7CgkJZm9yICh2YXIgaSA9IDAsIGogPSBzZWxlY3Rvci5sZW5ndGg7IGkgPCBqOyBpKyspIGVsZW1lbnRzID0gZWxlbWVudHMuY29uY2F0KHRoaXMuZ2V0RWxlbWVudHMoc2VsZWN0b3JbaV0sIHRydWUpKTsKCQlyZXR1cm4gKG5vY2FzaCkgPyBlbGVtZW50cyA6ICQkLnVuaXF1ZShlbGVtZW50cyk7Cgl9Cgp9OwoKRWxlbWVudC5leHRlbmQoewoKCS8qCglQcm9wZXJ0eTogZ2V0RWxlbWVudEJ5SWQKCQlUYXJnZXRzIGFuIGVsZW1lbnQgd2l0aCB0aGUgc3BlY2lmaWVkIGlkIGZvdW5kIGluc2lkZSB0aGUgRWxlbWVudC4gRG9lcyBub3Qgb3ZlcndyaXRlIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkLgoKCUFyZ3VtZW50czoKCQlpZCAtIHN0cmluZzsgdGhlIGlkIG9mIHRoZSBlbGVtZW50IHRvIGZpbmQuCgkqLwoKCWdldEVsZW1lbnRCeUlkOiBmdW5jdGlvbihpZCl7CgkJdmFyIGVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoaWQpOwoJCWlmICghZWwpIHJldHVybiBmYWxzZTsKCQlmb3IgKHZhciBwYXJlbnQgPSBlbC5wYXJlbnROb2RlOyBwYXJlbnQgIT0gdGhpczsgcGFyZW50ID0gcGFyZW50LnBhcmVudE5vZGUpewoJCQlpZiAoIXBhcmVudCkgcmV0dXJuIGZhbHNlOwoJCX0KCQlyZXR1cm4gZWw7Cgl9Lypjb21wYXRpYmlsaXR5Ki8sCgoJZ2V0RWxlbWVudHNCeUNsYXNzTmFtZTogZnVuY3Rpb24oY2xhc3NOYW1lKXsKCQlyZXR1cm4gdGhpcy5nZXRFbGVtZW50cygnLicgKyBjbGFzc05hbWUpOwoJfQoKCS8qZW5kIGNvbXBhdGliaWxpdHkqLwoKfSk7Cgpkb2N1bWVudC5leHRlbmQoRWxlbWVudC5NZXRob2RzLkRvbSk7CkVsZW1lbnQuZXh0ZW5kKEVsZW1lbnQuTWV0aG9kcy5Eb20pOwoKLyoKU2NyaXB0OiBFbGVtZW50LkZvcm0uanMKCUNvbnRhaW5zIEVsZW1lbnQgcHJvdG90eXBlcyB0byBkZWFsIHdpdGggRm9ybXMgYW5kIHRoZWlyIGVsZW1lbnRzLgoKTGljZW5zZToKCU1JVC1zdHlsZSBsaWNlbnNlLgoqLwoKLyoKQ2xhc3M6IEVsZW1lbnQKCUN1c3RvbSBjbGFzcyB0byBhbGxvdyBhbGwgb2YgaXRzIG1ldGhvZHMgdG8gYmUgdXNlZCB3aXRoIGFueSBET00gZWxlbWVudCB2aWEgdGhlIGRvbGxhciBmdW5jdGlvbiA8JD4uCiovCgpFbGVtZW50LmV4dGVuZCh7CgoJLyoKCVByb3BlcnR5OiBnZXRWYWx1ZQoJCVJldHVybnMgdGhlIHZhbHVlIG9mIHRoZSBFbGVtZW50LCBpZiBpdHMgdGFnIGlzIHRleHRhcmVhLCBzZWxlY3Qgb3IgaW5wdXQuIGdldFZhbHVlIGNhbGxlZCBvbiBhIG11bHRpcGxlIHNlbGVjdCB3aWxsIHJldHVybiBhbiBhcnJheS4KCSovCgoJZ2V0VmFsdWU6IGZ1bmN0aW9uKCl7CgkJc3dpdGNoKHRoaXMuZ2V0VGFnKCkpewoJCQljYXNlICdzZWxlY3QnOgoJCQkJdmFyIHZhbHVlcyA9IFtdOwoJCQkJJGVhY2godGhpcy5vcHRpb25zLCBmdW5jdGlvbihvcHRpb24pewoJCQkJCWlmIChvcHRpb24uc2VsZWN0ZWQpIHZhbHVlcy5wdXNoKCRwaWNrKG9wdGlvbi52YWx1ZSwgb3B0aW9uLnRleHQpKTsKCQkJCX0pOwoJCQkJcmV0dXJuICh0aGlzLm11bHRpcGxlKSA/IHZhbHVlcyA6IHZhbHVlc1swXTsKCQkJY2FzZSAnaW5wdXQnOiBpZiAoISh0aGlzLmNoZWNrZWQgJiYgWydjaGVja2JveCcsICdyYWRpbyddLmNvbnRhaW5zKHRoaXMudHlwZSkpICYmICFbJ2hpZGRlbicsICd0ZXh0JywgJ3Bhc3N3b3JkJ10uY29udGFpbnModGhpcy50eXBlKSkgYnJlYWs7CgkJCWNhc2UgJ3RleHRhcmVhJzogcmV0dXJuIHRoaXMudmFsdWU7CgkJfQoJCXJldHVybiBmYWxzZTsKCX0sCgoJZ2V0Rm9ybUVsZW1lbnRzOiBmdW5jdGlvbigpewoJCXJldHVybiAkJCh0aGlzLmdldEVsZW1lbnRzQnlUYWdOYW1lKCdpbnB1dCcpLCB0aGlzLmdldEVsZW1lbnRzQnlUYWdOYW1lKCdzZWxlY3QnKSwgdGhpcy5nZXRFbGVtZW50c0J5VGFnTmFtZSgndGV4dGFyZWEnKSk7Cgl9LAoKCS8qCglQcm9wZXJ0eTogdG9RdWVyeVN0cmluZwoJCVJlYWRzIHRoZSBjaGlsZHJlbiBpbnB1dHMgb2YgdGhlIEVsZW1lbnQgYW5kIGdlbmVyYXRlcyBhIHF1ZXJ5IHN0cmluZywgYmFzZWQgb24gdGhlaXIgdmFsdWVzLiBVc2VkIGludGVybmFsbHkgaW4gPEFqYXg+CgoJRXhhbXBsZToKCQkoc3RhcnQgY29kZSkKCQk8Zm9ybSBpZD0ibXlGb3JtIiBhY3Rpb249InN1Ym1pdC5waHAiPgoJCTxpbnB1dCBuYW1lPSJlbWFpbCIgdmFsdWU9ImJvYkBib2IuY29tIj4KCQk8aW5wdXQgbmFtZT0iemlwQ29kZSIgdmFsdWU9IjkwMjEwIj4KCQk8L2Zvcm0+CgoJCTxzY3JpcHQ+CgkJICQoJ215Rm9ybScpLnRvUXVlcnlTdHJpbmcoKQoJCTwvc2NyaXB0PgoJCShlbmQpCgoJCVJldHVybnM6CgkJCWVtYWlsPWJvYkBib2IuY29tJnppcENvZGU9OTAyMTAKCSovCgoJdG9RdWVyeVN0cmluZzogZnVuY3Rpb24oKXsKCQl2YXIgcXVlcnlTdHJpbmcgPSBbXTsKCQl0aGlzLmdldEZvcm1FbGVtZW50cygpLmVhY2goZnVuY3Rpb24oZWwpewoJCQl2YXIgbmFtZSA9IGVsLm5hbWU7CgkJCXZhciB2YWx1ZSA9IGVsLmdldFZhbHVlKCk7CgkJCWlmICh2YWx1ZSA9PT0gZmFsc2UgfHwgIW5hbWUgfHwgZWwuZGlzYWJsZWQpIHJldHVybjsKCQkJdmFyIHFzID0gZnVuY3Rpb24odmFsKXsKCQkJCXF1ZXJ5U3RyaW5nLnB1c2gobmFtZSArICc9JyArIGVuY29kZVVSSUNvbXBvbmVudCh2YWwpKTsKCQkJfTsKCQkJaWYgKCR0eXBlKHZhbHVlKSA9PSAnYXJyYXknKSB2YWx1ZS5lYWNoKHFzKTsKCQkJZWxzZSBxcyh2YWx1ZSk7CgkJfSk7CgkJcmV0dXJuIHF1ZXJ5U3RyaW5nLmpvaW4oJyYnKTsKCX0KCn0pOwoKLyoKU2NyaXB0OiBFbGVtZW50LkRpbWVuc2lvbnMuanMKCUNvbnRhaW5zIEVsZW1lbnQgcHJvdG90eXBlcyB0byBkZWFsIHdpdGggRWxlbWVudCBzaXplIGFuZCBwb3NpdGlvbiBpbiBzcGFjZS4KCk5vdGU6CglUaGUgZnVuY3Rpb25zIGluIHRoaXMgc2NyaXB0IHJlcXVpcmUgbiBYSFRNTCBkb2N0eXBlLgoKTGljZW5zZToKCU1JVC1zdHlsZSBsaWNlbnNlLgoqLwoKLyoKQ2xhc3M6IEVsZW1lbnQKCUN1c3RvbSBjbGFzcyB0byBhbGxvdyBhbGwgb2YgaXRzIG1ldGhvZHMgdG8gYmUgdXNlZCB3aXRoIGFueSBET00gZWxlbWVudCB2aWEgdGhlIGRvbGxhciBmdW5jdGlvbiA8JD4uCiovCgpFbGVtZW50LmV4dGVuZCh7CgoJLyoKCVByb3BlcnR5OiBzY3JvbGxUbwoJCVNjcm9sbHMgdGhlIGVsZW1lbnQgdG8gdGhlIHNwZWNpZmllZCBjb29yZGluYXRlZCAoaWYgdGhlIGVsZW1lbnQgaGFzIGFuIG92ZXJmbG93KQoKCUFyZ3VtZW50czoKCQl4IC0gdGhlIHggY29vcmRpbmF0ZQoJCXkgLSB0aGUgeSBjb29yZGluYXRlCgoJRXhhbXBsZToKCQk+JCgnbXlFbGVtZW50Jykuc2Nyb2xsVG8oMCwgMTAwKQoJKi8KCglzY3JvbGxUbzogZnVuY3Rpb24oeCwgeSl7CgkJdGhpcy5zY3JvbGxMZWZ0ID0geDsKCQl0aGlzLnNjcm9sbFRvcCA9IHk7Cgl9LAoKCS8qCglQcm9wZXJ0eTogZ2V0U2l6ZQoJCVJldHVybiBhbiBPYmplY3QgcmVwcmVzZW50aW5nIHRoZSBzaXplL3Njcm9sbCB2YWx1ZXMgb2YgdGhlIGVsZW1lbnQuCgoJRXhhbXBsZToKCQkoc3RhcnQgY29kZSkKCQkkKCdteUVsZW1lbnQnKS5nZXRTaXplKCk7CgkJKGVuZCkKCglSZXR1cm5zOgoJCShzdGFydCBjb2RlKQoJCXsKCQkJJ3Njcm9sbCc6IHsneCc6IDEwMCwgJ3knOiAxMDB9LAoJCQknc2l6ZSc6IHsneCc6IDIwMCwgJ3knOiA0MDB9LAoJCQknc2Nyb2xsU2l6ZSc6IHsneCc6IDMwMCwgJ3knOiA1MDB9CgkJfQoJCShlbmQpCgkqLwoKCWdldFNpemU6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHsKCQkJJ3Njcm9sbCc6IHsneCc6IHRoaXMuc2Nyb2xsTGVmdCwgJ3knOiB0aGlzLnNjcm9sbFRvcH0sCgkJCSdzaXplJzogeyd4JzogdGhpcy5vZmZzZXRXaWR0aCwgJ3knOiB0aGlzLm9mZnNldEhlaWdodH0sCgkJCSdzY3JvbGxTaXplJzogeyd4JzogdGhpcy5zY3JvbGxXaWR0aCwgJ3knOiB0aGlzLnNjcm9sbEhlaWdodH0KCQl9OwoJfSwKCgkvKgoJUHJvcGVydHk6IGdldFBvc2l0aW9uCgkJUmV0dXJucyB0aGUgcmVhbCBvZmZzZXRzIG9mIHRoZSBlbGVtZW50LgoKCUFyZ3VtZW50czoKCQlvdmVyZmxvd24gLSBvcHRpb25hbCwgYW4gYXJyYXkgb2YgbmVzdGVkIHNjcm9sbGluZyBjb250YWluZXJzIGZvciBzY3JvbGwgb2Zmc2V0IGNhbGN1bGF0aW9uLCB1c2UgdGhpcyBpZiB5b3VyIGVsZW1lbnQgaXMgaW5zaWRlIGFueSBlbGVtZW50IGNvbnRhaW5pbmcgc2Nyb2xsYmFycwoKCUV4YW1wbGU6CgkJPiQoJ2VsZW1lbnQnKS5nZXRQb3NpdGlvbigpOwoKCVJldHVybnM6CgkJPnt4OiAxMDAsIHk6NTAwfTsKCSovCgoJZ2V0UG9zaXRpb246IGZ1bmN0aW9uKG92ZXJmbG93bil7CgkJb3ZlcmZsb3duID0gb3ZlcmZsb3duIHx8IFtdOwoJCXZhciBlbCA9IHRoaXMsIGxlZnQgPSAwLCB0b3AgPSAwOwoJCWRvIHsKCQkJbGVmdCArPSBlbC5vZmZzZXRMZWZ0IHx8IDA7CgkJCXRvcCArPSBlbC5vZmZzZXRUb3AgfHwgMDsKCQkJZWwgPSBlbC5vZmZzZXRQYXJlbnQ7CgkJfSB3aGlsZSAoZWwpOwoJCW92ZXJmbG93bi5lYWNoKGZ1bmN0aW9uKGVsZW1lbnQpewoJCQlsZWZ0IC09IGVsZW1lbnQuc2Nyb2xsTGVmdCB8fCAwOwoJCQl0b3AgLT0gZWxlbWVudC5zY3JvbGxUb3AgfHwgMDsKCQl9KTsKCQlyZXR1cm4geyd4JzogbGVmdCwgJ3knOiB0b3B9OwoJfSwKCgkvKgoJUHJvcGVydHk6IGdldFRvcAoJCVJldHVybnMgdGhlIGRpc3RhbmNlIGZyb20gdGhlIHRvcCBvZiB0aGUgd2luZG93IHRvIHRoZSBFbGVtZW50LgoKCUFyZ3VtZW50czoKCQlvdmVyZmxvd24gLSBvcHRpb25hbCwgYW4gYXJyYXkgb2YgbmVzdGVkIHNjcm9sbGluZyBjb250YWluZXJzLCBzZWUgRWxlbWVudDo6Z2V0UG9zaXRpb24KCSovCgoJZ2V0VG9wOiBmdW5jdGlvbihvdmVyZmxvd24pewoJCXJldHVybiB0aGlzLmdldFBvc2l0aW9uKG92ZXJmbG93bikueTsKCX0sCgoJLyoKCVByb3BlcnR5OiBnZXRMZWZ0CgkJUmV0dXJucyB0aGUgZGlzdGFuY2UgZnJvbSB0aGUgbGVmdCBvZiB0aGUgd2luZG93IHRvIHRoZSBFbGVtZW50LgoKCUFyZ3VtZW50czoKCQlvdmVyZmxvd24gLSBvcHRpb25hbCwgYW4gYXJyYXkgb2YgbmVzdGVkIHNjcm9sbGluZyBjb250YWluZXJzLCBzZWUgRWxlbWVudDo6Z2V0UG9zaXRpb24KCSovCgoJZ2V0TGVmdDogZnVuY3Rpb24ob3ZlcmZsb3duKXsKCQlyZXR1cm4gdGhpcy5nZXRQb3NpdGlvbihvdmVyZmxvd24pLng7Cgl9LAoKCS8qCglQcm9wZXJ0eTogZ2V0Q29vcmRpbmF0ZXMKCQlSZXR1cm5zIGFuIG9iamVjdCB3aXRoIHdpZHRoLCBoZWlnaHQsIGxlZnQsIHJpZ2h0LCB0b3AsIGFuZCBib3R0b20sIHJlcHJlc2VudGluZyB0aGUgdmFsdWVzIG9mIHRoZSBFbGVtZW50CgoJQXJndW1lbnRzOgoJCW92ZXJmbG93biAtIG9wdGlvbmFsLCBhbiBhcnJheSBvZiBuZXN0ZWQgc2Nyb2xsaW5nIGNvbnRhaW5lcnMsIHNlZSBFbGVtZW50OjpnZXRQb3NpdGlvbgoKCUV4YW1wbGU6CgkJKHN0YXJ0IGNvZGUpCgkJdmFyIG15VmFsdWVzID0gJCgnbXlFbGVtZW50JykuZ2V0Q29vcmRpbmF0ZXMoKTsKCQkoZW5kKQoKCVJldHVybnM6CgkJKHN0YXJ0IGNvZGUpCgkJewoJCQl3aWR0aDogMjAwLAoJCQloZWlnaHQ6IDMwMCwKCQkJbGVmdDogMTAwLAoJCQl0b3A6IDUwLAoJCQlyaWdodDogMzAwLAoJCQlib3R0b206IDM1MAoJCX0KCQkoZW5kKQoJKi8KCglnZXRDb29yZGluYXRlczogZnVuY3Rpb24ob3ZlcmZsb3duKXsKCQl2YXIgcG9zaXRpb24gPSB0aGlzLmdldFBvc2l0aW9uKG92ZXJmbG93bik7CgkJdmFyIG9iaiA9IHsKCQkJJ3dpZHRoJzogdGhpcy5vZmZzZXRXaWR0aCwKCQkJJ2hlaWdodCc6IHRoaXMub2Zmc2V0SGVpZ2h0LAoJCQknbGVmdCc6IHBvc2l0aW9uLngsCgkJCSd0b3AnOiBwb3NpdGlvbi55CgkJfTsKCQlvYmoucmlnaHQgPSBvYmoubGVmdCArIG9iai53aWR0aDsKCQlvYmouYm90dG9tID0gb2JqLnRvcCArIG9iai5oZWlnaHQ7CgkJcmV0dXJuIG9iajsKCX0KCn0pOwoKLyoKU2NyaXB0OiBXaW5kb3cuRG9tUmVhZHkuanMKCUNvbnRhaW5zIHRoZSBjdXN0b20gZXZlbnQgZG9tcmVhZHksIGZvciB3aW5kb3cuCgpMaWNlbnNlOgoJTUlULXN0eWxlIGxpY2Vuc2UuCiovCgovKiBTZWN0aW9uOiBDdXN0b20gRXZlbnRzICovCgovKgpFdmVudDogZG9tcmVhZHkKCWV4ZWN1dGVzIGEgZnVuY3Rpb24gd2hlbiB0aGUgZG9tIHRyZWUgaXMgbG9hZGVkLCB3aXRob3V0IHdhaXRpbmcgZm9yIGltYWdlcy4gT25seSB3b3JrcyB3aGVuIGNhbGxlZCBmcm9tIHdpbmRvdy4KCkNyZWRpdHM6CgkoYykgRGVhbiBFZHdhcmRzL01hdHRoaWFzIE1pbGxlci9Kb2huIFJlc2lnLCByZW1hc3RlcmVkIGZvciBNb29Ub29scy4KCkFyZ3VtZW50czoKCWZuIC0gdGhlIGZ1bmN0aW9uIHRvIGV4ZWN1dGUgd2hlbiB0aGUgRE9NIGlzIHJlYWR5CgpFeGFtcGxlOgoJPiB3aW5kb3cuYWRkRXZlbnQoJ2RvbXJlYWR5JywgZnVuY3Rpb24oKXsKCT4JYWxlcnQoJ3RoZSBkb20gaXMgcmVhZHknKTsKCT4gfSk7CiovCgpFbGVtZW50LkV2ZW50cy5kb21yZWFkeSA9IHsKCglhZGQ6IGZ1bmN0aW9uKGZuKXsKCQlpZiAod2luZG93LmxvYWRlZCl7CgkJCWZuLmNhbGwodGhpcyk7CgkJCXJldHVybjsKCQl9CgkJdmFyIGRvbVJlYWR5ID0gZnVuY3Rpb24oKXsKCQkJaWYgKHdpbmRvdy5sb2FkZWQpIHJldHVybjsKCQkJd2luZG93LmxvYWRlZCA9IHRydWU7CgkJCXdpbmRvdy50aW1lciA9ICRjbGVhcih3aW5kb3cudGltZXIpOwoJCQl0aGlzLmZpcmVFdmVudCgnZG9tcmVhZHknKTsKCQl9LmJpbmQodGhpcyk7CgkJaWYgKGRvY3VtZW50LnJlYWR5U3RhdGUgJiYgd2luZG93LndlYmtpdCl7CgkJCXdpbmRvdy50aW1lciA9IGZ1bmN0aW9uKCl7CgkJCQlpZiAoWydsb2FkZWQnLCdjb21wbGV0ZSddLmNvbnRhaW5zKGRvY3VtZW50LnJlYWR5U3RhdGUpKSBkb21SZWFkeSgpOwoJCQl9LnBlcmlvZGljYWwoNTApOwoJCX0gZWxzZSBpZiAoZG9jdW1lbnQucmVhZHlTdGF0ZSAmJiB3aW5kb3cuaWUpewoJCQlpZiAoISQoJ2llX3JlYWR5JykpewoJCQkJdmFyIHNyYyA9ICh3aW5kb3cubG9jYXRpb24ucHJvdG9jb2wgPT0gJ2h0dHBzOicpID8gJzovLzAnIDogJ2phdmFzY3JpcHQ6dm9pZCgwKSc7CgkJCQlkb2N1bWVudC53cml0ZSgnPHNjcmlwdCBpZD0iaWVfcmVhZHkiIGRlZmVyIHNyYz0iJyArIHNyYyArICciPjxcL3NjcmlwdD4nKTsKCQkJCSQoJ2llX3JlYWR5Jykub25yZWFkeXN0YXRlY2hhbmdlID0gZnVuY3Rpb24oKXsKCQkJCQlpZiAodGhpcy5yZWFkeVN0YXRlID09ICdjb21wbGV0ZScpIGRvbVJlYWR5KCk7CgkJCQl9OwoJCQl9CgkJfSBlbHNlIHsKCQkJd2luZG93LmFkZExpc3RlbmVyKCJsb2FkIiwgZG9tUmVhZHkpOwoJCQlkb2N1bWVudC5hZGRMaXN0ZW5lcigiRE9NQ29udGVudExvYWRlZCIsIGRvbVJlYWR5KTsKCQl9Cgl9Cgp9OwoKLypjb21wYXRpYmlsaXR5Ki8KCndpbmRvdy5vbkRvbVJlYWR5ID0gZnVuY3Rpb24oZm4pewoJcmV0dXJuIHRoaXMuYWRkRXZlbnQoJ2RvbXJlYWR5JywgZm4pOwp9OwoKLyplbmQgY29tcGF0aWJpbGl0eSovCgovKgpTY3JpcHQ6IFdpbmRvdy5TaXplLmpzCglXaW5kb3cgY3Jvc3MtYnJvd3NlciBkaW1lbnNpb25zIG1ldGhvZHMuCgpOb3RlOgoJVGhlIEZ1bmN0aW9ucyBpbiB0aGlzIHNjcmlwdCByZXF1aXJlIGFuIFhIVE1MIGRvY3R5cGUuCgpMaWNlbnNlOgoJTUlULXN0eWxlIGxpY2Vuc2UuCiovCgovKgpDbGFzczogd2luZG93CglDcm9zcyBicm93c2VyIG1ldGhvZHMgdG8gZ2V0IHZhcmlvdXMgd2luZG93IGRpbWVuc2lvbnMuCglXYXJuaW5nOiBBbGwgdGhlc2UgbWV0aG9kcyByZXF1aXJlIHRoYXQgdGhlIGJyb3dzZXIgb3BlcmF0ZXMgaW4gc3RyaWN0IG1vZGUsIG5vdCBxdWlya3MgbW9kZS4KKi8KCndpbmRvdy5leHRlbmQoewoKCS8qCglQcm9wZXJ0eTogZ2V0V2lkdGgKCQlSZXR1cm5zIGFuIGludGVnZXIgcmVwcmVzZW50aW5nIHRoZSB3aWR0aCBvZiB0aGUgYnJvd3NlciB3aW5kb3cgKHdpdGhvdXQgdGhlIHNjcm9sbGJhcikuCgkqLwoKCWdldFdpZHRoOiBmdW5jdGlvbigpewoJCWlmICh0aGlzLndlYmtpdDQxOSkgcmV0dXJuIHRoaXMuaW5uZXJXaWR0aDsKCQlpZiAodGhpcy5vcGVyYSkgcmV0dXJuIGRvY3VtZW50LmJvZHkuY2xpZW50V2lkdGg7CgkJcmV0dXJuIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5jbGllbnRXaWR0aDsKCX0sCgoJLyoKCVByb3BlcnR5OiBnZXRIZWlnaHQKCQlSZXR1cm5zIGFuIGludGVnZXIgcmVwcmVzZW50aW5nIHRoZSBoZWlnaHQgb2YgdGhlIGJyb3dzZXIgd2luZG93ICh3aXRob3V0IHRoZSBzY3JvbGxiYXIpLgoJKi8KCglnZXRIZWlnaHQ6IGZ1bmN0aW9uKCl7CgkJaWYgKHRoaXMud2Via2l0NDE5KSByZXR1cm4gdGhpcy5pbm5lckhlaWdodDsKCQlpZiAodGhpcy5vcGVyYSkgcmV0dXJuIGRvY3VtZW50LmJvZHkuY2xpZW50SGVpZ2h0OwoJCXJldHVybiBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuY2xpZW50SGVpZ2h0OwoJfSwKCgkvKgoJUHJvcGVydHk6IGdldFNjcm9sbFdpZHRoCgkJUmV0dXJucyBhbiBpbnRlZ2VyIHJlcHJlc2VudGluZyB0aGUgc2Nyb2xsV2lkdGggb2YgdGhlIHdpbmRvdy4KCQlUaGlzIHZhbHVlIGlzIGVxdWFsIHRvIG9yIGJpZ2dlciB0aGFuIDxnZXRXaWR0aD4uCgoJU2VlIEFsc286CgkJPGh0dHA6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4vZG9jcy9ET006ZWxlbWVudC5zY3JvbGxXaWR0aD4KCSovCgoJZ2V0U2Nyb2xsV2lkdGg6IGZ1bmN0aW9uKCl7CgkJaWYgKHRoaXMuaWUpIHJldHVybiBNYXRoLm1heChkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQub2Zmc2V0V2lkdGgsIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5zY3JvbGxXaWR0aCk7CgkJaWYgKHRoaXMud2Via2l0KSByZXR1cm4gZG9jdW1lbnQuYm9keS5zY3JvbGxXaWR0aDsKCQlyZXR1cm4gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LnNjcm9sbFdpZHRoOwoJfSwKCgkvKgoJUHJvcGVydHk6IGdldFNjcm9sbEhlaWdodAoJCVJldHVybnMgYW4gaW50ZWdlciByZXByZXNlbnRpbmcgdGhlIHNjcm9sbEhlaWdodCBvZiB0aGUgd2luZG93LgoJCVRoaXMgdmFsdWUgaXMgZXF1YWwgdG8gb3IgYmlnZ2VyIHRoYW4gPGdldEhlaWdodD4uCgoJU2VlIEFsc286CgkJPGh0dHA6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4vZG9jcy9ET006ZWxlbWVudC5zY3JvbGxIZWlnaHQ+CgkqLwoKCWdldFNjcm9sbEhlaWdodDogZnVuY3Rpb24oKXsKCQlpZiAodGhpcy5pZSkgcmV0dXJuIE1hdGgubWF4KGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5vZmZzZXRIZWlnaHQsIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5zY3JvbGxIZWlnaHQpOwoJCWlmICh0aGlzLndlYmtpdCkgcmV0dXJuIGRvY3VtZW50LmJvZHkuc2Nyb2xsSGVpZ2h0OwoJCXJldHVybiBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuc2Nyb2xsSGVpZ2h0OwoJfSwKCgkvKgoJUHJvcGVydHk6IGdldFNjcm9sbExlZnQKCQlSZXR1cm5zIGFuIGludGVnZXIgcmVwcmVzZW50aW5nIHRoZSBzY3JvbGxMZWZ0IG9mIHRoZSB3aW5kb3cgKHRoZSBudW1iZXIgb2YgcGl4ZWxzIHRoZSB3aW5kb3cgaGFzIHNjcm9sbGVkIGZyb20gdGhlIGxlZnQpLgoKCVNlZSBBbHNvOgoJCTxodHRwOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuL2RvY3MvRE9NOmVsZW1lbnQuc2Nyb2xsTGVmdD4KCSovCgoJZ2V0U2Nyb2xsTGVmdDogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5wYWdlWE9mZnNldCB8fCBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuc2Nyb2xsTGVmdDsKCX0sCgoJLyoKCVByb3BlcnR5OiBnZXRTY3JvbGxUb3AKCQlSZXR1cm5zIGFuIGludGVnZXIgcmVwcmVzZW50aW5nIHRoZSBzY3JvbGxUb3Agb2YgdGhlIHdpbmRvdyAodGhlIG51bWJlciBvZiBwaXhlbHMgdGhlIHdpbmRvdyBoYXMgc2Nyb2xsZWQgZnJvbSB0aGUgdG9wKS4KCglTZWUgQWxzbzoKCQk8aHR0cDovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi9kb2NzL0RPTTplbGVtZW50LnNjcm9sbFRvcD4KCSovCgoJZ2V0U2Nyb2xsVG9wOiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLnBhZ2VZT2Zmc2V0IHx8IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5zY3JvbGxUb3A7Cgl9LAoKCS8qCglQcm9wZXJ0eTogZ2V0U2l6ZQoJCVNhbWUgYXMgPEVsZW1lbnQuZ2V0U2l6ZT4KCSovCgoJZ2V0U2l6ZTogZnVuY3Rpb24oKXsKCQlyZXR1cm4gewoJCQknc2l6ZSc6IHsneCc6IHRoaXMuZ2V0V2lkdGgoKSwgJ3knOiB0aGlzLmdldEhlaWdodCgpfSwKCQkJJ3Njcm9sbFNpemUnOiB7J3gnOiB0aGlzLmdldFNjcm9sbFdpZHRoKCksICd5JzogdGhpcy5nZXRTY3JvbGxIZWlnaHQoKX0sCgkJCSdzY3JvbGwnOiB7J3gnOiB0aGlzLmdldFNjcm9sbExlZnQoKSwgJ3knOiB0aGlzLmdldFNjcm9sbFRvcCgpfQoJCX07Cgl9LAoKCS8vaWdub3JlCglnZXRQb3NpdGlvbjogZnVuY3Rpb24oKXtyZXR1cm4geyd4JzogMCwgJ3knOiAwfTt9Cgp9KTsKCi8qClNjcmlwdDogRnguQmFzZS5qcwoJQ29udGFpbnMgPEZ4LkJhc2U+LCB0aGUgZm91bmRhbWVudGFscyBvZiB0aGUgTW9vVG9vbHMgRWZmZWN0cy4KCkxpY2Vuc2U6CglNSVQtc3R5bGUgbGljZW5zZS4KKi8KCnZhciBGeCA9IHt9OwoKLyoKQ2xhc3M6IEZ4LkJhc2UKCUJhc2UgY2xhc3MgZm9yIHRoZSBFZmZlY3RzLgoKT3B0aW9uczoKCXRyYW5zaXRpb24gLSB0aGUgZXF1YXRpb24gdG8gdXNlIGZvciB0aGUgZWZmZWN0IHNlZSA8RnguVHJhbnNpdGlvbnM+OyBkZWZhdWx0IGlzIDxGeC5UcmFuc2l0aW9ucy5TaW5lLmVhc2VJbk91dD4KCWR1cmF0aW9uIC0gdGhlIGR1cmF0aW9uIG9mIHRoZSBlZmZlY3QgaW4gbXM7IDUwMCBpcyB0aGUgZGVmYXVsdC4KCXVuaXQgLSB0aGUgdW5pdCBpcyAncHgnIGJ5IGRlZmF1bHQgKG90aGVyIHZhbHVlcyBpbmNsdWRlIHRoaW5ncyBsaWtlICdlbScgZm9yIGZvbnRzIG9yICclJykuCgl3YWl0IC0gYm9vbGVhbjogdG8gd2FpdCBvciBub3QgdG8gd2FpdCBmb3IgYSBjdXJyZW50IHRyYW5zaXRpb24gdG8gZW5kIGJlZm9yZSBydW5uaW5nIGFub3RoZXIgb2YgdGhlIHNhbWUgaW5zdGFuY2UuIGRlZmF1bHRzIHRvIHRydWUuCglmcHMgLSB0aGUgZnJhbWVzIHBlciBzZWNvbmQgZm9yIHRoZSB0cmFuc2l0aW9uOyBkZWZhdWx0IGlzIDUwCgpFdmVudHM6CglvblN0YXJ0IC0gdGhlIGZ1bmN0aW9uIHRvIGV4ZWN1dGUgYXMgdGhlIGVmZmVjdCBiZWdpbnM7IG5vdGhpbmcgKDxDbGFzcy5lbXB0eT4pIGJ5IGRlZmF1bHQuCglvbkNvbXBsZXRlIC0gdGhlIGZ1bmN0aW9uIHRvIGV4ZWN1dGUgYWZ0ZXIgdGhlIGVmZmVjdCBoYXMgcHJvY2Vzc2VkOyBub3RoaW5nICg8Q2xhc3MuZW1wdHk+KSBieSBkZWZhdWx0LgoJb25DYW5jZWwgLSB0aGUgZnVuY3Rpb24gdG8gZXhlY3V0ZSB3aGVuIHlvdSBtYW51YWxseSBzdG9wIHRoZSBlZmZlY3QuCiovCgpGeC5CYXNlID0gbmV3IENsYXNzKHsKCglvcHRpb25zOiB7CgkJb25TdGFydDogQ2xhc3MuZW1wdHksCgkJb25Db21wbGV0ZTogQ2xhc3MuZW1wdHksCgkJb25DYW5jZWw6IENsYXNzLmVtcHR5LAoJCXRyYW5zaXRpb246IGZ1bmN0aW9uKHApewoJCQlyZXR1cm4gLShNYXRoLmNvcyhNYXRoLlBJICogcCkgLSAxKSAvIDI7CgkJfSwKCQlkdXJhdGlvbjogNTAwLAoJCXVuaXQ6ICdweCcsCgkJd2FpdDogdHJ1ZSwKCQlmcHM6IDUwCgl9LAoKCWluaXRpYWxpemU6IGZ1bmN0aW9uKG9wdGlvbnMpewoJCXRoaXMuZWxlbWVudCA9IHRoaXMuZWxlbWVudCB8fCBudWxsOwoJCXRoaXMuc2V0T3B0aW9ucyhvcHRpb25zKTsKCQlpZiAodGhpcy5vcHRpb25zLmluaXRpYWxpemUpIHRoaXMub3B0aW9ucy5pbml0aWFsaXplLmNhbGwodGhpcyk7Cgl9LAoKCXN0ZXA6IGZ1bmN0aW9uKCl7CgkJdmFyIHRpbWUgPSAkdGltZSgpOwoJCWlmICh0aW1lIDwgdGhpcy50aW1lICsgdGhpcy5vcHRpb25zLmR1cmF0aW9uKXsKCQkJdGhpcy5kZWx0YSA9IHRoaXMub3B0aW9ucy50cmFuc2l0aW9uKCh0aW1lIC0gdGhpcy50aW1lKSAvIHRoaXMub3B0aW9ucy5kdXJhdGlvbik7CgkJCXRoaXMuc2V0Tm93KCk7CgkJCXRoaXMuaW5jcmVhc2UoKTsKCQl9IGVsc2UgewoJCQl0aGlzLnN0b3AodHJ1ZSk7CgkJCXRoaXMuc2V0KHRoaXMudG8pOwoJCQl0aGlzLmZpcmVFdmVudCgnb25Db21wbGV0ZScsIHRoaXMuZWxlbWVudCwgMTApOwoJCQl0aGlzLmNhbGxDaGFpbigpOwoJCX0KCX0sCgoJLyoKCVByb3BlcnR5OiBzZXQKCQlJbW1lZGlhdGVseSBzZXRzIHRoZSB2YWx1ZSB3aXRoIG5vIHRyYW5zaXRpb24uCgoJQXJndW1lbnRzOgoJCXRvIC0gdGhlIHBvaW50IHRvIGp1bXAgdG8KCglFeGFtcGxlOgoJCT52YXIgbXlGeCA9IG5ldyBGeC5TdHlsZSgnbXlFbGVtZW50JywgJ29wYWNpdHknKS5zZXQoMCk7IC8vd2lsbCBtYWtlIGl0IGltbWVkaWF0ZWx5IHRyYW5zcGFyZW50CgkqLwoKCXNldDogZnVuY3Rpb24odG8pewoJCXRoaXMubm93ID0gdG87CgkJdGhpcy5pbmNyZWFzZSgpOwoJCXJldHVybiB0aGlzOwoJfSwKCglzZXROb3c6IGZ1bmN0aW9uKCl7CgkJdGhpcy5ub3cgPSB0aGlzLmNvbXB1dGUodGhpcy5mcm9tLCB0aGlzLnRvKTsKCX0sCgoJY29tcHV0ZTogZnVuY3Rpb24oZnJvbSwgdG8pewoJCXJldHVybiAodG8gLSBmcm9tKSAqIHRoaXMuZGVsdGEgKyBmcm9tOwoJfSwKCgkvKgoJUHJvcGVydHk6IHN0YXJ0CgkJRXhlY3V0ZXMgYW4gZWZmZWN0IGZyb20gb25lIHBvc2l0aW9uIHRvIHRoZSBvdGhlci4KCglBcmd1bWVudHM6CgkJZnJvbSAtIGludGVnZXI6IHN0YXJpbmcgdmFsdWUKCQl0byAtIGludGVnZXI6IHRoZSBlbmRpbmcgdmFsdWUKCglFeGFtcGxlczoKCQk+dmFyIG15RnggPSBuZXcgRnguU3R5bGUoJ215RWxlbWVudCcsICdvcGFjaXR5Jykuc3RhcnQoMCwxKTsgLy9kaXNwbGF5IGEgdHJhbnNpdGlvbiBmcm9tIHRyYW5zcGFyZW50IHRvIG9wYXF1ZS4KCSovCgoJc3RhcnQ6IGZ1bmN0aW9uKGZyb20sIHRvKXsKCQlpZiAoIXRoaXMub3B0aW9ucy53YWl0KSB0aGlzLnN0b3AoKTsKCQllbHNlIGlmICh0aGlzLnRpbWVyKSByZXR1cm4gdGhpczsKCQl0aGlzLmZyb20gPSBmcm9tOwoJCXRoaXMudG8gPSB0bzsKCQl0aGlzLmNoYW5nZSA9IHRoaXMudG8gLSB0aGlzLmZyb207CgkJdGhpcy50aW1lID0gJHRpbWUoKTsKCQl0aGlzLnRpbWVyID0gdGhpcy5zdGVwLnBlcmlvZGljYWwoTWF0aC5yb3VuZCgxMDAwIC8gdGhpcy5vcHRpb25zLmZwcyksIHRoaXMpOwoJCXRoaXMuZmlyZUV2ZW50KCdvblN0YXJ0JywgdGhpcy5lbGVtZW50KTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJLyoKCVByb3BlcnR5OiBzdG9wCgkJU3RvcHMgdGhlIHRyYW5zaXRpb24uCgkqLwoKCXN0b3A6IGZ1bmN0aW9uKGVuZCl7CgkJaWYgKCF0aGlzLnRpbWVyKSByZXR1cm4gdGhpczsKCQl0aGlzLnRpbWVyID0gJGNsZWFyKHRoaXMudGltZXIpOwoJCWlmICghZW5kKSB0aGlzLmZpcmVFdmVudCgnb25DYW5jZWwnLCB0aGlzLmVsZW1lbnQpOwoJCXJldHVybiB0aGlzOwoJfS8qY29tcGF0aWJpbGl0eSovLAoKCWN1c3RvbTogZnVuY3Rpb24oZnJvbSwgdG8pewoJCXJldHVybiB0aGlzLnN0YXJ0KGZyb20sIHRvKTsKCX0sCgoJY2xlYXJUaW1lcjogZnVuY3Rpb24oZW5kKXsKCQlyZXR1cm4gdGhpcy5zdG9wKGVuZCk7Cgl9CgoJLyplbmQgY29tcGF0aWJpbGl0eSovCgp9KTsKCkZ4LkJhc2UuaW1wbGVtZW50KG5ldyBDaGFpbiwgbmV3IEV2ZW50cywgbmV3IE9wdGlvbnMpOwoKLyoKU2NyaXB0OiBGeC5DU1MuanMKCUNzcyBwYXJzaW5nIGNsYXNzIGZvciBlZmZlY3RzLiBSZXF1aXJlZCBieSA8RnguU3R5bGU+LCA8RnguU3R5bGVzPiwgPEZ4LkVsZW1lbnRzPi4gTm8gZG9jdW1lbnRhdGlvbiBuZWVkZWQsIGFzIGl0cyB1c2VkIGludGVybmFsbHkuCgpMaWNlbnNlOgoJTUlULXN0eWxlIGxpY2Vuc2UuCiovCgpGeC5DU1MgPSB7CgoJc2VsZWN0OiBmdW5jdGlvbihwcm9wZXJ0eSwgdG8pewoJCWlmIChwcm9wZXJ0eS50ZXN0KC9jb2xvci9pKSkgcmV0dXJuIHRoaXMuQ29sb3I7CgkJdmFyIHR5cGUgPSAkdHlwZSh0byk7CgkJaWYgKCh0eXBlID09ICdhcnJheScpIHx8ICh0eXBlID09ICdzdHJpbmcnICYmIHRvLmNvbnRhaW5zKCcgJykpKSByZXR1cm4gdGhpcy5NdWx0aTsKCQlyZXR1cm4gdGhpcy5TaW5nbGU7Cgl9LAoKCXBhcnNlOiBmdW5jdGlvbihlbCwgcHJvcGVydHksIGZyb21Ubyl7CgkJaWYgKCFmcm9tVG8ucHVzaCkgZnJvbVRvID0gW2Zyb21Ub107CgkJdmFyIGZyb20gPSBmcm9tVG9bMF0sIHRvID0gZnJvbVRvWzFdOwoJCWlmICghJGNoayh0bykpewoJCQl0byA9IGZyb207CgkJCWZyb20gPSBlbC5nZXRTdHlsZShwcm9wZXJ0eSk7CgkJfQoJCXZhciBjc3MgPSB0aGlzLnNlbGVjdChwcm9wZXJ0eSwgdG8pOwoJCXJldHVybiB7J2Zyb20nOiBjc3MucGFyc2UoZnJvbSksICd0byc6IGNzcy5wYXJzZSh0byksICdjc3MnOiBjc3N9OwoJfQoKfTsKCkZ4LkNTUy5TaW5nbGUgPSB7CgoJcGFyc2U6IGZ1bmN0aW9uKHZhbHVlKXsKCQlyZXR1cm4gcGFyc2VGbG9hdCh2YWx1ZSk7Cgl9LAoKCWdldE5vdzogZnVuY3Rpb24oZnJvbSwgdG8sIGZ4KXsKCQlyZXR1cm4gZnguY29tcHV0ZShmcm9tLCB0byk7Cgl9LAoKCWdldFZhbHVlOiBmdW5jdGlvbih2YWx1ZSwgdW5pdCwgcHJvcGVydHkpewoJCWlmICh1bml0ID09ICdweCcgJiYgcHJvcGVydHkgIT0gJ29wYWNpdHknKSB2YWx1ZSA9IE1hdGgucm91bmQodmFsdWUpOwoJCXJldHVybiB2YWx1ZSArIHVuaXQ7Cgl9Cgp9OwoKRnguQ1NTLk11bHRpID0gewoKCXBhcnNlOiBmdW5jdGlvbih2YWx1ZSl7CgkJcmV0dXJuIHZhbHVlLnB1c2ggPyB2YWx1ZSA6IHZhbHVlLnNwbGl0KCcgJykubWFwKGZ1bmN0aW9uKHYpewoJCQlyZXR1cm4gcGFyc2VGbG9hdCh2KTsKCQl9KTsKCX0sCgoJZ2V0Tm93OiBmdW5jdGlvbihmcm9tLCB0bywgZngpewoJCXZhciBub3cgPSBbXTsKCQlmb3IgKHZhciBpID0gMDsgaSA8IGZyb20ubGVuZ3RoOyBpKyspIG5vd1tpXSA9IGZ4LmNvbXB1dGUoZnJvbVtpXSwgdG9baV0pOwoJCXJldHVybiBub3c7Cgl9LAoKCWdldFZhbHVlOiBmdW5jdGlvbih2YWx1ZSwgdW5pdCwgcHJvcGVydHkpewoJCWlmICh1bml0ID09ICdweCcgJiYgcHJvcGVydHkgIT0gJ29wYWNpdHknKSB2YWx1ZSA9IHZhbHVlLm1hcChNYXRoLnJvdW5kKTsKCQlyZXR1cm4gdmFsdWUuam9pbih1bml0ICsgJyAnKSArIHVuaXQ7Cgl9Cgp9OwoKRnguQ1NTLkNvbG9yID0gewoKCXBhcnNlOiBmdW5jdGlvbih2YWx1ZSl7CgkJcmV0dXJuIHZhbHVlLnB1c2ggPyB2YWx1ZSA6IHZhbHVlLmhleFRvUmdiKHRydWUpOwoJfSwKCglnZXROb3c6IGZ1bmN0aW9uKGZyb20sIHRvLCBmeCl7CgkJdmFyIG5vdyA9IFtdOwoJCWZvciAodmFyIGkgPSAwOyBpIDwgZnJvbS5sZW5ndGg7IGkrKykgbm93W2ldID0gTWF0aC5yb3VuZChmeC5jb21wdXRlKGZyb21baV0sIHRvW2ldKSk7CgkJcmV0dXJuIG5vdzsKCX0sCgoJZ2V0VmFsdWU6IGZ1bmN0aW9uKHZhbHVlKXsKCQlyZXR1cm4gJ3JnYignICsgdmFsdWUuam9pbignLCcpICsgJyknOwoJfQoKfTsKCi8qClNjcmlwdDogRnguU3R5bGUuanMKCUNvbnRhaW5zIDxGeC5TdHlsZT4KCkxpY2Vuc2U6CglNSVQtc3R5bGUgbGljZW5zZS4KKi8KCi8qCkNsYXNzOiBGeC5TdHlsZQoJVGhlIFN0eWxlIGVmZmVjdCwgdXNlZCB0byB0cmFuc2l0aW9uIGFueSBjc3MgcHJvcGVydHkgZnJvbSBvbmUgdmFsdWUgdG8gYW5vdGhlci4gSW5jbHVkZXMgY29sb3JzLgoJQ29sb3JzIG11c3QgYmUgaW4gaGV4IGZvcm1hdC4KCUluaGVyaXRzIG1ldGhvZHMsIHByb3BlcnRpZXMsIG9wdGlvbnMgYW5kIGV2ZW50cyBmcm9tIDxGeC5CYXNlPi4KCkFyZ3VtZW50czoKCWVsIC0gdGhlICQoZWxlbWVudCkgdG8gYXBwbHkgdGhlIHN0eWxlIHRyYW5zaXRpb24gdG8KCXByb3BlcnR5IC0gdGhlIHByb3BlcnR5IHRvIHRyYW5zaXRpb24KCW9wdGlvbnMgLSB0aGUgRnguQmFzZSBvcHRpb25zIChzZWU6IDxGeC5CYXNlPikKCkV4YW1wbGU6Cgk+dmFyIG1hcmdpbkNoYW5nZSA9IG5ldyBGeC5TdHlsZSgnbXlFbGVtZW50JywgJ21hcmdpbi10b3AnLCB7ZHVyYXRpb246NTAwfSk7Cgk+bWFyZ2luQ2hhbmdlLnN0YXJ0KDEwLCAxMDApOwoqLwoKRnguU3R5bGUgPSBGeC5CYXNlLmV4dGVuZCh7CgoJaW5pdGlhbGl6ZTogZnVuY3Rpb24oZWwsIHByb3BlcnR5LCBvcHRpb25zKXsKCQl0aGlzLmVsZW1lbnQgPSAkKGVsKTsKCQl0aGlzLnByb3BlcnR5ID0gcHJvcGVydHk7CgkJdGhpcy5wYXJlbnQob3B0aW9ucyk7Cgl9LAoKCS8qCglQcm9wZXJ0eTogaGlkZQoJCVNhbWUgYXMgPEZ4LkJhc2Uuc2V0PiAoMCk7IGhpZGVzIHRoZSBlbGVtZW50IGltbWVkaWF0ZWx5IHdpdGhvdXQgdHJhbnNpdGlvbi4KCSovCgoJaGlkZTogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5zZXQoMCk7Cgl9LAoKCXNldE5vdzogZnVuY3Rpb24oKXsKCQl0aGlzLm5vdyA9IHRoaXMuY3NzLmdldE5vdyh0aGlzLmZyb20sIHRoaXMudG8sIHRoaXMpOwoJfSwKCgkvKgoJUHJvcGVydHk6IHNldAoJCVNldHMgdGhlIGVsZW1lbnQncyBjc3MgcHJvcGVydHkgKHNwZWNpZmllZCBhdCBpbnN0YW50aWF0aW9uKSB0byB0aGUgc3BlY2lmaWVkIHZhbHVlIGltbWVkaWF0ZWx5LgoKCUV4YW1wbGU6CgkJKHN0YXJ0IGNvZGUpCgkJdmFyIG1hcmdpbkNoYW5nZSA9IG5ldyBGeC5TdHlsZSgnbXlFbGVtZW50JywgJ21hcmdpbi10b3AnLCB7ZHVyYXRpb246NTAwfSk7CgkJbWFyZ2luQ2hhbmdlLnNldCgxMCk7IC8vbWFyZ2luLXRvcCBpcyBzZXQgdG8gMTBweCBpbW1lZGlhdGVseQoJCShlbmQpCgkqLwoKCXNldDogZnVuY3Rpb24odG8pewoJCXRoaXMuY3NzID0gRnguQ1NTLnNlbGVjdCh0aGlzLnByb3BlcnR5LCB0byk7CgkJcmV0dXJuIHRoaXMucGFyZW50KHRoaXMuY3NzLnBhcnNlKHRvKSk7Cgl9LAoKCS8qCglQcm9wZXJ0eTogc3RhcnQKCQlEaXNwbGF5cyB0aGUgdHJhbnNpdGlvbiB0byB0aGUgdmFsdWUvdmFsdWVzIHBhc3NlZCBpbgoKCUFyZ3VtZW50czoKCQlmcm9tIC0gKGludGVnZXI7IG9wdGlvbmFsKSB0aGUgc3RhcnRpbmcgcG9zaXRpb24gZm9yIHRoZSB0cmFuc2l0aW9uCgkJdG8gLSAoaW50ZWdlcikgdGhlIGVuZGluZyBwb3NpdGlvbiBmb3IgdGhlIHRyYW5zaXRpb24KCglOb3RlOgoJCUlmIHlvdSBwcm92aWRlIG9ubHkgb25lIGFyZ3VtZW50LCB0aGUgdHJhbnNpdGlvbiB3aWxsIHVzZSB0aGUgY3VycmVudCBjc3MgdmFsdWUgZm9yIGl0cyBzdGFydGluZyB2YWx1ZS4KCglFeGFtcGxlOgoJCShzdGFydCBjb2RlKQoJCXZhciBtYXJnaW5DaGFuZ2UgPSBuZXcgRnguU3R5bGUoJ215RWxlbWVudCcsICdtYXJnaW4tdG9wJywge2R1cmF0aW9uOjUwMH0pOwoJCW1hcmdpbkNoYW5nZS5zdGFydCgxMCk7IC8vdHJpZXMgdG8gcmVhZCBjdXJyZW50IG1hcmdpbiB0b3AgdmFsdWUgYW5kIGdvZXMgZnJvbSBjdXJyZW50IHRvIDEwCgkJKGVuZCkKCSovCgoJc3RhcnQ6IGZ1bmN0aW9uKGZyb20sIHRvKXsKCQlpZiAodGhpcy50aW1lciAmJiB0aGlzLm9wdGlvbnMud2FpdCkgcmV0dXJuIHRoaXM7CgkJdmFyIHBhcnNlZCA9IEZ4LkNTUy5wYXJzZSh0aGlzLmVsZW1lbnQsIHRoaXMucHJvcGVydHksIFtmcm9tLCB0b10pOwoJCXRoaXMuY3NzID0gcGFyc2VkLmNzczsKCQlyZXR1cm4gdGhpcy5wYXJlbnQocGFyc2VkLmZyb20sIHBhcnNlZC50byk7Cgl9LAoKCWluY3JlYXNlOiBmdW5jdGlvbigpewoJCXRoaXMuZWxlbWVudC5zZXRTdHlsZSh0aGlzLnByb3BlcnR5LCB0aGlzLmNzcy5nZXRWYWx1ZSh0aGlzLm5vdywgdGhpcy5vcHRpb25zLnVuaXQsIHRoaXMucHJvcGVydHkpKTsKCX0KCn0pOwoKLyoKQ2xhc3M6IEVsZW1lbnQKCUN1c3RvbSBjbGFzcyB0byBhbGxvdyBhbGwgb2YgaXRzIG1ldGhvZHMgdG8gYmUgdXNlZCB3aXRoIGFueSBET00gZWxlbWVudCB2aWEgdGhlIGRvbGxhciBmdW5jdGlvbiA8JD4uCiovCgpFbGVtZW50LmV4dGVuZCh7CgoJLyoKCVByb3BlcnR5OiBlZmZlY3QKCQlBcHBsaWVzIGFuIDxGeC5TdHlsZT4gdG8gdGhlIEVsZW1lbnQ7IFRoaXMgYSBzaG9ydGN1dCBmb3IgPEZ4LlN0eWxlPi4KCglBcmd1bWVudHM6CgkJcHJvcGVydHkgLSAoc3RyaW5nKSB0aGUgY3NzIHByb3BlcnR5IHRvIGFsdGVyCgkJb3B0aW9ucyAtIChvYmplY3Q7IG9wdGlvbmFsKSBrZXkvdmFsdWUgc2V0IG9mIG9wdGlvbnMgKHNlZSA8RnguU3R5bGU+KQoKCUV4YW1wbGU6CgkJPnZhciBteUVmZmVjdCA9ICQoJ215RWxlbWVudCcpLmVmZmVjdCgnaGVpZ2h0Jywge2R1cmF0aW9uOiAxMDAwLCB0cmFuc2l0aW9uOiBGeC5UcmFuc2l0aW9ucy5saW5lYXJ9KTsKCQk+bXlFZmZlY3Quc3RhcnQoMTAsIDEwMCk7CgkJPi8vT1IKCQk+JCgnbXlFbGVtZW50JykuZWZmZWN0KCdoZWlnaHQnLCB7ZHVyYXRpb246IDEwMDAsIHRyYW5zaXRpb246IEZ4LlRyYW5zaXRpb25zLmxpbmVhcn0pLnN0YXJ0KDEwLDEwMCk7CgkqLwoKCWVmZmVjdDogZnVuY3Rpb24ocHJvcGVydHksIG9wdGlvbnMpewoJCXJldHVybiBuZXcgRnguU3R5bGUodGhpcywgcHJvcGVydHksIG9wdGlvbnMpOwoJfQoKfSk7CgovKgpTY3JpcHQ6IEZ4LlN0eWxlcy5qcwoJQ29udGFpbnMgPEZ4LlN0eWxlcz4KCkxpY2Vuc2U6CglNSVQtc3R5bGUgbGljZW5zZS4KKi8KCi8qCkNsYXNzOiBGeC5TdHlsZXMKCUFsbG93cyB5b3UgdG8gYW5pbWF0ZSBtdWx0aXBsZSBjc3MgcHJvcGVydGllcyBhdCBvbmNlOwoJQ29sb3JzIG11c3QgYmUgaW4gaGV4IGZvcm1hdC4KCUluaGVyaXRzIG1ldGhvZHMsIHByb3BlcnRpZXMsIG9wdGlvbnMgYW5kIGV2ZW50cyBmcm9tIDxGeC5CYXNlPi4KCkFyZ3VtZW50czoKCWVsIC0gdGhlICQoZWxlbWVudCkgdG8gYXBwbHkgdGhlIHN0eWxlcyB0cmFuc2l0aW9uIHRvCglvcHRpb25zIC0gdGhlIGZ4IG9wdGlvbnMgKHNlZTogPEZ4LkJhc2U+KQoKRXhhbXBsZToKCShzdGFydCBjb2RlKQoJdmFyIG15RWZmZWN0cyA9IG5ldyBGeC5TdHlsZXMoJ215RWxlbWVudCcsIHtkdXJhdGlvbjogMTAwMCwgdHJhbnNpdGlvbjogRnguVHJhbnNpdGlvbnMubGluZWFyfSk7CgoJLy9oZWlnaHQgZnJvbSAxMCB0byAxMDAgYW5kIHdpZHRoIGZyb20gOTAwIHRvIDMwMAoJbXlFZmZlY3RzLnN0YXJ0KHsKCQknaGVpZ2h0JzogWzEwLCAxMDBdLAoJCSd3aWR0aCc6IFs5MDAsIDMwMF0KCX0pOwoKCS8vb3IgaGVpZ2h0IGZyb20gY3VycmVudCBoZWlnaHQgdG8gMTAwIGFuZCB3aWR0aCBmcm9tIGN1cnJlbnQgd2lkdGggdG8gMzAwCglteUVmZmVjdHMuc3RhcnQoewoJCSdoZWlnaHQnOiAxMDAsCgkJJ3dpZHRoJzogMzAwCgl9KTsKCShlbmQpCiovCgpGeC5TdHlsZXMgPSBGeC5CYXNlLmV4dGVuZCh7CgoJaW5pdGlhbGl6ZTogZnVuY3Rpb24oZWwsIG9wdGlvbnMpewoJCXRoaXMuZWxlbWVudCA9ICQoZWwpOwoJCXRoaXMucGFyZW50KG9wdGlvbnMpOwoJfSwKCglzZXROb3c6IGZ1bmN0aW9uKCl7CgkJZm9yICh2YXIgcCBpbiB0aGlzLmZyb20pIHRoaXMubm93W3BdID0gdGhpcy5jc3NbcF0uZ2V0Tm93KHRoaXMuZnJvbVtwXSwgdGhpcy50b1twXSwgdGhpcyk7Cgl9LAoKCXNldDogZnVuY3Rpb24odG8pewoJCXZhciBwYXJzZWQgPSB7fTsKCQl0aGlzLmNzcyA9IHt9OwoJCWZvciAodmFyIHAgaW4gdG8pewoJCQl0aGlzLmNzc1twXSA9IEZ4LkNTUy5zZWxlY3QocCwgdG9bcF0pOwoJCQlwYXJzZWRbcF0gPSB0aGlzLmNzc1twXS5wYXJzZSh0b1twXSk7CgkJfQoJCXJldHVybiB0aGlzLnBhcmVudChwYXJzZWQpOwoJfSwKCgkvKgoJUHJvcGVydHk6IHN0YXJ0CgkJRXhlY3V0ZXMgYSB0cmFuc2l0aW9uIGZvciBhbnkgbnVtYmVyIG9mIGNzcyBwcm9wZXJ0aWVzIGluIHRhbmRlbS4KCglBcmd1bWVudHM6CgkJb2JqIC0gYW4gb2JqZWN0IGNvbnRhaW5pbmcga2V5cyB0aGF0IHNwZWNpZnkgY3NzIHByb3BlcnRpZXMgdG8gYWx0ZXIgYW5kIHZhbHVlcyB0aGF0IHNwZWNpZnkgZWl0aGVyIHRoZSBmcm9tL3RvIHZhbHVlcyAoYXMgYW4gYXJyYXkpIG9yIGp1c3QgdGhlIGVuZCB2YWx1ZSAoYW4gaW50ZWdlcikuCgoJRXhhbXBsZToKCQlzZWUgPEZ4LlN0eWxlcz4KCSovCgoJc3RhcnQ6IGZ1bmN0aW9uKG9iail7CgkJaWYgKHRoaXMudGltZXIgJiYgdGhpcy5vcHRpb25zLndhaXQpIHJldHVybiB0aGlzOwoJCXRoaXMubm93ID0ge307CgkJdGhpcy5jc3MgPSB7fTsKCQl2YXIgZnJvbSA9IHt9LCB0byA9IHt9OwoJCWZvciAodmFyIHAgaW4gb2JqKXsKCQkJdmFyIHBhcnNlZCA9IEZ4LkNTUy5wYXJzZSh0aGlzLmVsZW1lbnQsIHAsIG9ialtwXSk7CgkJCWZyb21bcF0gPSBwYXJzZWQuZnJvbTsKCQkJdG9bcF0gPSBwYXJzZWQudG87CgkJCXRoaXMuY3NzW3BdID0gcGFyc2VkLmNzczsKCQl9CgkJcmV0dXJuIHRoaXMucGFyZW50KGZyb20sIHRvKTsKCX0sCgoJaW5jcmVhc2U6IGZ1bmN0aW9uKCl7CgkJZm9yICh2YXIgcCBpbiB0aGlzLm5vdykgdGhpcy5lbGVtZW50LnNldFN0eWxlKHAsIHRoaXMuY3NzW3BdLmdldFZhbHVlKHRoaXMubm93W3BdLCB0aGlzLm9wdGlvbnMudW5pdCwgcCkpOwoJfQoKfSk7CgovKgpDbGFzczogRWxlbWVudAoJQ3VzdG9tIGNsYXNzIHRvIGFsbG93IGFsbCBvZiBpdHMgbWV0aG9kcyB0byBiZSB1c2VkIHdpdGggYW55IERPTSBlbGVtZW50IHZpYSB0aGUgZG9sbGFyIGZ1bmN0aW9uIDwkPi4KKi8KCkVsZW1lbnQuZXh0ZW5kKHsKCgkvKgoJUHJvcGVydHk6IGVmZmVjdHMKCQlBcHBsaWVzIGFuIDxGeC5TdHlsZXM+IHRvIHRoZSBFbGVtZW50OyBUaGlzIGEgc2hvcnRjdXQgZm9yIDxGeC5TdHlsZXM+LgoKCUV4YW1wbGU6CgkJPnZhciBteUVmZmVjdHMgPSAkKG15RWxlbWVudCkuZWZmZWN0cyh7ZHVyYXRpb246IDEwMDAsIHRyYW5zaXRpb246IEZ4LlRyYW5zaXRpb25zLlNpbmUuZWFzZUluT3V0fSk7CiAJCT5teUVmZmVjdHMuc3RhcnQoeydoZWlnaHQnOiBbMTAsIDEwMF0sICd3aWR0aCc6IFs5MDAsIDMwMF19KTsKCSovCgoJZWZmZWN0czogZnVuY3Rpb24ob3B0aW9ucyl7CgkJcmV0dXJuIG5ldyBGeC5TdHlsZXModGhpcywgb3B0aW9ucyk7Cgl9Cgp9KTsKCi8qClNjcmlwdDogRnguRWxlbWVudHMuanMKCUNvbnRhaW5zIDxGeC5FbGVtZW50cz4KCkxpY2Vuc2U6CglNSVQtc3R5bGUgbGljZW5zZS4KKi8KCi8qCkNsYXNzOiBGeC5FbGVtZW50cwoJRnguRWxlbWVudHMgYWxsb3dzIHlvdSB0byBhcHBseSBhbnkgbnVtYmVyIG9mIHN0eWxlcyB0cmFuc2l0aW9ucyB0byBhIHNlbGVjdGlvbiBvZiBlbGVtZW50cy4gSW5jbHVkZXMgY29sb3JzIChtdXN0IGJlIGluIGhleCBmb3JtYXQpLgoJSW5oZXJpdHMgbWV0aG9kcywgcHJvcGVydGllcywgb3B0aW9ucyBhbmQgZXZlbnRzIGZyb20gPEZ4LkJhc2U+LgoKQXJndW1lbnRzOgoJZWxlbWVudHMgLSBhIGNvbGxlY3Rpb24gb2YgZWxlbWVudHMgdGhlIGVmZmVjdHMgd2lsbCBiZSBhcHBsaWVkIHRvLgoJb3B0aW9ucyAtIHNhbWUgYXMgPEZ4LkJhc2U+IG9wdGlvbnMuCiovCgpGeC5FbGVtZW50cyA9IEZ4LkJhc2UuZXh0ZW5kKHsKCglpbml0aWFsaXplOiBmdW5jdGlvbihlbGVtZW50cywgb3B0aW9ucyl7CgkJdGhpcy5lbGVtZW50cyA9ICQkKGVsZW1lbnRzKTsKCQl0aGlzLnBhcmVudChvcHRpb25zKTsKCX0sCgoJc2V0Tm93OiBmdW5jdGlvbigpewoJCWZvciAodmFyIGkgaW4gdGhpcy5mcm9tKXsKCQkJdmFyIGlGcm9tID0gdGhpcy5mcm9tW2ldLCBpVG8gPSB0aGlzLnRvW2ldLCBpQ3NzID0gdGhpcy5jc3NbaV0sIGlOb3cgPSB0aGlzLm5vd1tpXSA9IHt9OwoJCQlmb3IgKHZhciBwIGluIGlGcm9tKSBpTm93W3BdID0gaUNzc1twXS5nZXROb3coaUZyb21bcF0sIGlUb1twXSwgdGhpcyk7CgkJfQoJfSwKCglzZXQ6IGZ1bmN0aW9uKHRvKXsKCQl2YXIgcGFyc2VkID0ge307CgkJdGhpcy5jc3MgPSB7fTsKCQlmb3IgKHZhciBpIGluIHRvKXsKCQkJdmFyIGlUbyA9IHRvW2ldLCBpQ3NzID0gdGhpcy5jc3NbaV0gPSB7fSwgaVBhcnNlZCA9IHBhcnNlZFtpXSA9IHt9OwoJCQlmb3IgKHZhciBwIGluIGlUbyl7CgkJCQlpQ3NzW3BdID0gRnguQ1NTLnNlbGVjdChwLCBpVG9bcF0pOwoJCQkJaVBhcnNlZFtwXSA9IGlDc3NbcF0ucGFyc2UoaVRvW3BdKTsKCQkJfQoJCX0KCQlyZXR1cm4gdGhpcy5wYXJlbnQocGFyc2VkKTsKCX0sCgoJLyoKCVByb3BlcnR5OiBzdGFydAoJCUFwcGxpZXMgdGhlIHBhc3NlZCBpbiBzdHlsZSB0cmFuc2l0aW9ucyB0byBlYWNoIG9iamVjdCBuYW1lZCAoc2VlIGV4YW1wbGUpLiBFYWNoIGl0ZW0gaW4gdGhlIGNvbGxlY3Rpb24gaXMgcmVmZXJlZCB0byBhcyBhIG51bWVyaWNhbCBzdHJpbmcgKCIxIiBmb3IgaW5zdGFuY2UpLiBUaGUgZmlyc3QgaXRlbSBpcyAiMCIsIHRoZSBzZWNvbmQgIjEiLCBldGMuCgoJRXhhbXBsZToKCQkoc3RhcnQgY29kZSkKCQl2YXIgbXlFbGVtZW50c0VmZmVjdHMgPSBuZXcgRnguRWxlbWVudHMoJCQoJ2EnKSk7CgkJbXlFbGVtZW50c0VmZmVjdHMuc3RhcnQoewoJCQknMCc6IHsgLy9sZXQncyBjaGFuZ2UgdGhlIGZpcnN0IGVsZW1lbnQncyBvcGFjaXR5IGFuZCB3aWR0aAoJCQkJJ29wYWNpdHknOiBbMCwxXSwKCQkJCSd3aWR0aCc6IFsxMDAsMjAwXQoJCQl9LAoJCQknNCc6IHsgLy9hbmQgdGhlIGZpZnRoIG9uZSdzIG9wYWNpdHkKCQkJCSdvcGFjaXR5JzogWzAuMiwgMC41XQoJCQl9CgkJfSk7CgkJKGVuZCkKCSovCgoJc3RhcnQ6IGZ1bmN0aW9uKG9iail7CgkJaWYgKHRoaXMudGltZXIgJiYgdGhpcy5vcHRpb25zLndhaXQpIHJldHVybiB0aGlzOwoJCXRoaXMubm93ID0ge307CgkJdGhpcy5jc3MgPSB7fTsKCQl2YXIgZnJvbSA9IHt9LCB0byA9IHt9OwoJCWZvciAodmFyIGkgaW4gb2JqKXsKCQkJdmFyIGlQcm9wcyA9IG9ialtpXSwgaUZyb20gPSBmcm9tW2ldID0ge30sIGlUbyA9IHRvW2ldID0ge30sIGlDc3MgPSB0aGlzLmNzc1tpXSA9IHt9OwoJCQlmb3IgKHZhciBwIGluIGlQcm9wcyl7CgkJCQl2YXIgcGFyc2VkID0gRnguQ1NTLnBhcnNlKHRoaXMuZWxlbWVudHNbaV0sIHAsIGlQcm9wc1twXSk7CgkJCQlpRnJvbVtwXSA9IHBhcnNlZC5mcm9tOwoJCQkJaVRvW3BdID0gcGFyc2VkLnRvOwoJCQkJaUNzc1twXSA9IHBhcnNlZC5jc3M7CgkJCX0KCQl9CgkJcmV0dXJuIHRoaXMucGFyZW50KGZyb20sIHRvKTsKCX0sCgoJaW5jcmVhc2U6IGZ1bmN0aW9uKCl7CgkJZm9yICh2YXIgaSBpbiB0aGlzLm5vdyl7CgkJCXZhciBpTm93ID0gdGhpcy5ub3dbaV0sIGlDc3MgPSB0aGlzLmNzc1tpXTsKCQkJZm9yICh2YXIgcCBpbiBpTm93KSB0aGlzLmVsZW1lbnRzW2ldLnNldFN0eWxlKHAsIGlDc3NbcF0uZ2V0VmFsdWUoaU5vd1twXSwgdGhpcy5vcHRpb25zLnVuaXQsIHApKTsKCQl9Cgl9Cgp9KTsKCi8qClNjcmlwdDogRnguU2Nyb2xsLmpzCglDb250YWlucyA8RnguU2Nyb2xsPgoKTGljZW5zZToKCU1JVC1zdHlsZSBsaWNlbnNlLgoqLwoKLyoKQ2xhc3M6IEZ4LlNjcm9sbAoJU2Nyb2xsIGFueSBlbGVtZW50IHdpdGggYW4gb3ZlcmZsb3csIGluY2x1ZGluZyB0aGUgd2luZG93IGVsZW1lbnQuCglJbmhlcml0cyBtZXRob2RzLCBwcm9wZXJ0aWVzLCBvcHRpb25zIGFuZCBldmVudHMgZnJvbSA8RnguQmFzZT4uCgpOb3RlOgoJRnguU2Nyb2xsIHJlcXVpcmVzIGFuIFhIVE1MIGRvY3R5cGUuCgpBcmd1bWVudHM6CgllbGVtZW50IC0gdGhlIGVsZW1lbnQgdG8gc2Nyb2xsCglvcHRpb25zIC0gb3B0aW9uYWwsIHNlZSBPcHRpb25zIGJlbG93LgoKT3B0aW9uczoKCWFsbCB0aGUgRnguQmFzZSBvcHRpb25zIGFuZCBldmVudHMsIHBsdXM6CglvZmZzZXQgLSB0aGUgZGlzdGFuY2UgZm9yIHRoZSBzY3JvbGxUbyBwb2ludC9lbGVtZW50LiBhbiBPYmplY3Qgd2l0aCB4L3kgcHJvcGVydGllcy4KCW92ZXJmbG93biAtIGFuIGFycmF5IG9mIG5lc3RlZCBzY3JvbGxpbmcgY29udGFpbmVycywgc2VlIDxFbGVtZW50LmdldFBvc2l0aW9uPgoqLwoKRnguU2Nyb2xsID0gRnguQmFzZS5leHRlbmQoewoKCW9wdGlvbnM6IHsKCQlvdmVyZmxvd246IFtdLAoJCW9mZnNldDogeyd4JzogMCwgJ3knOiAwfSwKCQl3aGVlbFN0b3BzOiB0cnVlCgl9LAoKCWluaXRpYWxpemU6IGZ1bmN0aW9uKGVsZW1lbnQsIG9wdGlvbnMpewoJCXRoaXMubm93ID0gW107CgkJdGhpcy5lbGVtZW50ID0gJChlbGVtZW50KTsKCQl0aGlzLmJvdW5kID0geydzdG9wJzogdGhpcy5zdG9wLmJpbmQodGhpcywgZmFsc2UpfTsKCQl0aGlzLnBhcmVudChvcHRpb25zKTsKCQlpZiAodGhpcy5vcHRpb25zLndoZWVsU3RvcHMpewoJCQl0aGlzLmFkZEV2ZW50KCdvblN0YXJ0JywgZnVuY3Rpb24oKXsKCQkJCWRvY3VtZW50LmFkZEV2ZW50KCdtb3VzZXdoZWVsJywgdGhpcy5ib3VuZC5zdG9wKTsKCQkJfS5iaW5kKHRoaXMpKTsKCQkJdGhpcy5hZGRFdmVudCgnb25Db21wbGV0ZScsIGZ1bmN0aW9uKCl7CgkJCQlkb2N1bWVudC5yZW1vdmVFdmVudCgnbW91c2V3aGVlbCcsIHRoaXMuYm91bmQuc3RvcCk7CgkJCX0uYmluZCh0aGlzKSk7CgkJfQoJfSwKCglzZXROb3c6IGZ1bmN0aW9uKCl7CgkJZm9yICh2YXIgaSA9IDA7IGkgPCAyOyBpKyspIHRoaXMubm93W2ldID0gdGhpcy5jb21wdXRlKHRoaXMuZnJvbVtpXSwgdGhpcy50b1tpXSk7Cgl9LAoKCS8qCglQcm9wZXJ0eTogc2Nyb2xsVG8KCQlTY3JvbGxzIHRoZSBjaG9zZW4gZWxlbWVudCB0byB0aGUgeC95IGNvb3JkaW5hdGVzLgoKCUFyZ3VtZW50czoKCQl4IC0gdGhlIHggY29vcmRpbmF0ZSB0byBzY3JvbGwgdGhlIGVsZW1lbnQgdG8KCQl5IC0gdGhlIHkgY29vcmRpbmF0ZSB0byBzY3JvbGwgdGhlIGVsZW1lbnQgdG8KCSovCgoJc2Nyb2xsVG86IGZ1bmN0aW9uKHgsIHkpewoJCWlmICh0aGlzLnRpbWVyICYmIHRoaXMub3B0aW9ucy53YWl0KSByZXR1cm4gdGhpczsKCQl2YXIgZWwgPSB0aGlzLmVsZW1lbnQuZ2V0U2l6ZSgpOwoJCXZhciB2YWx1ZXMgPSB7J3gnOiB4LCAneSc6IHl9OwoJCWZvciAodmFyIHogaW4gZWwuc2l6ZSl7CgkJCXZhciBtYXggPSBlbC5zY3JvbGxTaXplW3pdIC0gZWwuc2l6ZVt6XTsKCQkJaWYgKCRjaGsodmFsdWVzW3pdKSkgdmFsdWVzW3pdID0gKCR0eXBlKHZhbHVlc1t6XSkgPT0gJ251bWJlcicpID8gdmFsdWVzW3pdLmxpbWl0KDAsIG1heCkgOiBtYXg7CgkJCWVsc2UgdmFsdWVzW3pdID0gZWwuc2Nyb2xsW3pdOwoJCQl2YWx1ZXNbel0gKz0gdGhpcy5vcHRpb25zLm9mZnNldFt6XTsKCQl9CgkJcmV0dXJuIHRoaXMuc3RhcnQoW2VsLnNjcm9sbC54LCBlbC5zY3JvbGwueV0sIFt2YWx1ZXMueCwgdmFsdWVzLnldKTsKCX0sCgoJLyoKCVByb3BlcnR5OiB0b1RvcAoJCVNjcm9sbHMgdGhlIGNob3NlbiBlbGVtZW50IHRvIGl0cyBtYXhpbXVtIHRvcC4KCSovCgoJdG9Ub3A6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMuc2Nyb2xsVG8oZmFsc2UsIDApOwoJfSwKCgkvKgoJUHJvcGVydHk6IHRvQm90dG9tCgkJU2Nyb2xscyB0aGUgY2hvc2VuIGVsZW1lbnQgdG8gaXRzIG1heGltdW0gYm90dG9tLgoJKi8KCgl0b0JvdHRvbTogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5zY3JvbGxUbyhmYWxzZSwgJ2Z1bGwnKTsKCX0sCgoJLyoKCVByb3BlcnR5OiB0b0xlZnQKCQlTY3JvbGxzIHRoZSBjaG9zZW4gZWxlbWVudCB0byBpdHMgbWF4aW11bSBsZWZ0LgoJKi8KCgl0b0xlZnQ6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMuc2Nyb2xsVG8oMCwgZmFsc2UpOwoJfSwKCgkvKgoJUHJvcGVydHk6IHRvUmlnaHQKCQlTY3JvbGxzIHRoZSBjaG9zZW4gZWxlbWVudCB0byBpdHMgbWF4aW11bSByaWdodC4KCSovCgoJdG9SaWdodDogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5zY3JvbGxUbygnZnVsbCcsIGZhbHNlKTsKCX0sCgoJLyoKCVByb3BlcnR5OiB0b0VsZW1lbnQKCQlTY3JvbGxzIHRoZSBzcGVjaWZpZWQgZWxlbWVudCB0byB0aGUgcG9zaXRpb24gdGhlIHBhc3NlZCBpbiBlbGVtZW50IGlzIGZvdW5kLgoKCUFyZ3VtZW50czoKCQllbCAtIHRoZSAkKGVsZW1lbnQpIHRvIHNjcm9sbCB0aGUgd2luZG93IHRvCgkqLwoKCXRvRWxlbWVudDogZnVuY3Rpb24oZWwpewoJCXZhciBwYXJlbnQgPSB0aGlzLmVsZW1lbnQuZ2V0UG9zaXRpb24odGhpcy5vcHRpb25zLm92ZXJmbG93bik7CgkJdmFyIHRhcmdldCA9ICQoZWwpLmdldFBvc2l0aW9uKHRoaXMub3B0aW9ucy5vdmVyZmxvd24pOwoJCXJldHVybiB0aGlzLnNjcm9sbFRvKHRhcmdldC54IC0gcGFyZW50LngsIHRhcmdldC55IC0gcGFyZW50LnkpOwoJfSwKCglpbmNyZWFzZTogZnVuY3Rpb24oKXsKCQl0aGlzLmVsZW1lbnQuc2Nyb2xsVG8odGhpcy5ub3dbMF0sIHRoaXMubm93WzFdKTsKCX0KCn0pOwoKLyoKU2NyaXB0OiBGeC5TbGlkZS5qcwoJQ29udGFpbnMgPEZ4LlNsaWRlPgoKTGljZW5zZToKCU1JVC1zdHlsZSBsaWNlbnNlLgoqLwoKLyoKQ2xhc3M6IEZ4LlNsaWRlCglUaGUgc2xpZGUgZWZmZWN0OyBzbGlkZXMgYW4gZWxlbWVudCBpbiBob3Jpem9udGFsbHkgb3IgdmVydGljYWxseSwgdGhlIGNvbnRlbnRzIHdpbGwgZm9sZCBpbnNpZGUuCglJbmhlcml0cyBtZXRob2RzLCBwcm9wZXJ0aWVzLCBvcHRpb25zIGFuZCBldmVudHMgZnJvbSA8RnguQmFzZT4uCgpOb3RlOgoJRnguU2xpZGUgcmVxdWlyZXMgYW4gWEhUTUwgZG9jdHlwZS4KCk9wdGlvbnM6Cgltb2RlIC0gc2V0IGl0IHRvIHZlcnRpY2FsIG9yIGhvcml6b250YWwuIERlZmF1bHRzIHRvIHZlcnRpY2FsLgoJb3B0aW9ucyAtIGFsbCB0aGUgPEZ4LkJhc2U+IG9wdGlvbnMKCkV4YW1wbGU6Cgkoc3RhcnQgY29kZSkKCXZhciBteVNsaWRlciA9IG5ldyBGeC5TbGlkZSgnbXlFbGVtZW50Jywge2R1cmF0aW9uOiA1MDB9KTsKCW15U2xpZGVyLnRvZ2dsZSgpIC8vdG9nZ2xlIHRoZSBzbGlkZXIgdXAgYW5kIGRvd24uCgkoZW5kKQoqLwoKRnguU2xpZGUgPSBGeC5CYXNlLmV4dGVuZCh7CgoJb3B0aW9uczogewoJCW1vZGU6ICd2ZXJ0aWNhbCcKCX0sCgoJaW5pdGlhbGl6ZTogZnVuY3Rpb24oZWwsIG9wdGlvbnMpewoJCXRoaXMuZWxlbWVudCA9ICQoZWwpOwoJCXRoaXMud3JhcHBlciA9IG5ldyBFbGVtZW50KCdkaXYnLCB7J3N0eWxlcyc6ICRleHRlbmQodGhpcy5lbGVtZW50LmdldFN0eWxlcygnbWFyZ2luJyksIHsnb3ZlcmZsb3cnOiAnaGlkZGVuJ30pfSkuaW5qZWN0QWZ0ZXIodGhpcy5lbGVtZW50KS5hZG9wdCh0aGlzLmVsZW1lbnQpOwoJCXRoaXMuZWxlbWVudC5zZXRTdHlsZSgnbWFyZ2luJywgMCk7CgkJdGhpcy5zZXRPcHRpb25zKG9wdGlvbnMpOwoJCXRoaXMubm93ID0gW107CgkJdGhpcy5wYXJlbnQodGhpcy5vcHRpb25zKTsKCQl0aGlzLm9wZW4gPSB0cnVlOwoJCXRoaXMuYWRkRXZlbnQoJ29uQ29tcGxldGUnLCBmdW5jdGlvbigpewoJCQl0aGlzLm9wZW4gPSAodGhpcy5ub3dbMF0gPT09IDApOwoJCX0pOwoJCWlmICh3aW5kb3cud2Via2l0NDE5KSB0aGlzLmFkZEV2ZW50KCdvbkNvbXBsZXRlJywgZnVuY3Rpb24oKXsKCQkJaWYgKHRoaXMub3BlbikgdGhpcy5lbGVtZW50LnJlbW92ZSgpLmluamVjdCh0aGlzLndyYXBwZXIpOwoJCX0pOwoJfSwKCglzZXROb3c6IGZ1bmN0aW9uKCl7CgkJZm9yICh2YXIgaSA9IDA7IGkgPCAyOyBpKyspIHRoaXMubm93W2ldID0gdGhpcy5jb21wdXRlKHRoaXMuZnJvbVtpXSwgdGhpcy50b1tpXSk7Cgl9LAoKCXZlcnRpY2FsOiBmdW5jdGlvbigpewoJCXRoaXMubWFyZ2luID0gJ21hcmdpbi10b3AnOwoJCXRoaXMubGF5b3V0ID0gJ2hlaWdodCc7CgkJdGhpcy5vZmZzZXQgPSB0aGlzLmVsZW1lbnQub2Zmc2V0SGVpZ2h0OwoJfSwKCglob3Jpem9udGFsOiBmdW5jdGlvbigpewoJCXRoaXMubWFyZ2luID0gJ21hcmdpbi1sZWZ0JzsKCQl0aGlzLmxheW91dCA9ICd3aWR0aCc7CgkJdGhpcy5vZmZzZXQgPSB0aGlzLmVsZW1lbnQub2Zmc2V0V2lkdGg7Cgl9LAoKCS8qCglQcm9wZXJ0eTogc2xpZGVJbgoJCVNsaWRlcyB0aGUgZWxlbWVudHMgaW4gdmlldyBob3Jpem9udGFsbHkgb3IgdmVydGljYWxseS4KCglBcmd1bWVudHM6CgkJbW9kZSAtIChvcHRpb25hbCwgc3RyaW5nKSAnaG9yaXpvbnRhbCcgb3IgJ3ZlcnRpY2FsJzsgZGVmYXVsdHMgdG8gb3B0aW9ucy5tb2RlLgoJKi8KCglzbGlkZUluOiBmdW5jdGlvbihtb2RlKXsKCQl0aGlzW21vZGUgfHwgdGhpcy5vcHRpb25zLm1vZGVdKCk7CgkJcmV0dXJuIHRoaXMuc3RhcnQoW3RoaXMuZWxlbWVudC5nZXRTdHlsZSh0aGlzLm1hcmdpbikudG9JbnQoKSwgdGhpcy53cmFwcGVyLmdldFN0eWxlKHRoaXMubGF5b3V0KS50b0ludCgpXSwgWzAsIHRoaXMub2Zmc2V0XSk7Cgl9LAoKCS8qCglQcm9wZXJ0eTogc2xpZGVPdXQKCQlTaWRlcyB0aGUgZWxlbWVudHMgb3V0IG9mIHZpZXcgaG9yaXpvbnRhbGx5IG9yIHZlcnRpY2FsbHkuCgoJQXJndW1lbnRzOgoJCW1vZGUgLSAob3B0aW9uYWwsIHN0cmluZykgJ2hvcml6b250YWwnIG9yICd2ZXJ0aWNhbCc7IGRlZmF1bHRzIHRvIG9wdGlvbnMubW9kZS4KCSovCgoJc2xpZGVPdXQ6IGZ1bmN0aW9uKG1vZGUpewoJCXRoaXNbbW9kZSB8fCB0aGlzLm9wdGlvbnMubW9kZV0oKTsKCQlyZXR1cm4gdGhpcy5zdGFydChbdGhpcy5lbGVtZW50LmdldFN0eWxlKHRoaXMubWFyZ2luKS50b0ludCgpLCB0aGlzLndyYXBwZXIuZ2V0U3R5bGUodGhpcy5sYXlvdXQpLnRvSW50KCldLCBbLXRoaXMub2Zmc2V0LCAwXSk7Cgl9LAoKCS8qCglQcm9wZXJ0eTogaGlkZQoJCUhpZGVzIHRoZSBlbGVtZW50IHdpdGhvdXQgYSB0cmFuc2l0aW9uLgoKCUFyZ3VtZW50czoKCQltb2RlIC0gKG9wdGlvbmFsLCBzdHJpbmcpICdob3Jpem9udGFsJyBvciAndmVydGljYWwnOyBkZWZhdWx0cyB0byBvcHRpb25zLm1vZGUuCgkqLwoKCWhpZGU6IGZ1bmN0aW9uKG1vZGUpewoJCXRoaXNbbW9kZSB8fCB0aGlzLm9wdGlvbnMubW9kZV0oKTsKCQl0aGlzLm9wZW4gPSBmYWxzZTsKCQlyZXR1cm4gdGhpcy5zZXQoWy10aGlzLm9mZnNldCwgMF0pOwoJfSwKCgkvKgoJUHJvcGVydHk6IHNob3cKCQlTaG93cyB0aGUgZWxlbWVudCB3aXRob3V0IGEgdHJhbnNpdGlvbi4KCglBcmd1bWVudHM6CgkJbW9kZSAtIChvcHRpb25hbCwgc3RyaW5nKSAnaG9yaXpvbnRhbCcgb3IgJ3ZlcnRpY2FsJzsgZGVmYXVsdHMgdG8gb3B0aW9ucy5tb2RlLgoJKi8KCglzaG93OiBmdW5jdGlvbihtb2RlKXsKCQl0aGlzW21vZGUgfHwgdGhpcy5vcHRpb25zLm1vZGVdKCk7CgkJdGhpcy5vcGVuID0gdHJ1ZTsKCQlyZXR1cm4gdGhpcy5zZXQoWzAsIHRoaXMub2Zmc2V0XSk7Cgl9LAoKCS8qCglQcm9wZXJ0eTogdG9nZ2xlCgkJU2xpZGVzIGluIG9yIE91dCB0aGUgZWxlbWVudCwgZGVwZW5kaW5nIG9uIGl0cyBzdGF0ZQoKCUFyZ3VtZW50czoKCQltb2RlIC0gKG9wdGlvbmFsLCBzdHJpbmcpICdob3Jpem9udGFsJyBvciAndmVydGljYWwnOyBkZWZhdWx0cyB0byBvcHRpb25zLm1vZGUuCgoJKi8KCgl0b2dnbGU6IGZ1bmN0aW9uKG1vZGUpewoJCWlmICh0aGlzLndyYXBwZXIub2Zmc2V0SGVpZ2h0ID09IDAgfHwgdGhpcy53cmFwcGVyLm9mZnNldFdpZHRoID09IDApIHJldHVybiB0aGlzLnNsaWRlSW4obW9kZSk7CgkJcmV0dXJuIHRoaXMuc2xpZGVPdXQobW9kZSk7Cgl9LAoKCWluY3JlYXNlOiBmdW5jdGlvbigpewoJCXRoaXMuZWxlbWVudC5zZXRTdHlsZSh0aGlzLm1hcmdpbiwgdGhpcy5ub3dbMF0gKyB0aGlzLm9wdGlvbnMudW5pdCk7CgkJdGhpcy53cmFwcGVyLnNldFN0eWxlKHRoaXMubGF5b3V0LCB0aGlzLm5vd1sxXSArIHRoaXMub3B0aW9ucy51bml0KTsKCX0KCn0pOwoKLyoKU2NyaXB0OiBGeC5UcmFuc2l0aW9ucy5qcwoJRWZmZWN0cyB0cmFuc2l0aW9ucywgdG8gYmUgdXNlZCB3aXRoIGFsbCB0aGUgZWZmZWN0cy4KCkxpY2Vuc2U6CglNSVQtc3R5bGUgbGljZW5zZS4KCkNyZWRpdHM6CglFYXNpbmcgRXF1YXRpb25zIGJ5IFJvYmVydCBQZW5uZXIsIDxodHRwOi8vd3d3LnJvYmVydHBlbm5lci5jb20vZWFzaW5nLz4sIG1vZGlmaWVkICYgb3B0aW1pemVkIHRvIGJlIHVzZWQgd2l0aCBtb290b29scy4KKi8KCi8qCkNsYXNzOiBGeC5UcmFuc2l0aW9ucwoJQSBjb2xsZWN0aW9uIG9mIHR3ZWVuaW5nIHRyYW5zaXRpb25zIGZvciB1c2Ugd2l0aCB0aGUgPEZ4LkJhc2U+IGNsYXNzZXMuCgpFeGFtcGxlOgoJPi8vRWxhc3RpYy5lYXNlT3V0IHdpdGggZGVmYXVsdCB2YWx1ZXM6Cgk+bmV3IEZ4LlN0eWxlKCdtYXJnaW4nLCB7dHJhbnNpdGlvbjogRnguVHJhbnNpdGlvbnMuRWxhc3RpYy5lYXNlT3V0fSk7Cgk+Ly9FbGFzdGljLmVhc2VPdXQgd2l0aCB1c2VyLWRlZmluZWQgdmFsdWUgZm9yIGVsYXN0aWNpdHkuCgk+IHZhciBteVRyYW5zaXRpb24gPSBuZXcgRnguVHJhbnNpdGlvbihGeC5UcmFuc2l0aW9ucy5FbGFzdGljLCAzKTsKCT5uZXcgRnguU3R5bGUoJ21hcmdpbicsIHt0cmFuc2l0aW9uOiBteVRyYW5zaXRpb24uZWFzZU91dH0pOwoKU2VlIGFsc286CglodHRwOi8vd3d3LnJvYmVydHBlbm5lci5jb20vZWFzaW5nLwoqLwoKRnguVHJhbnNpdGlvbiA9IGZ1bmN0aW9uKHRyYW5zaXRpb24sIHBhcmFtcyl7CglwYXJhbXMgPSBwYXJhbXMgfHwgW107CglpZiAoJHR5cGUocGFyYW1zKSAhPSAnYXJyYXknKSBwYXJhbXMgPSBbcGFyYW1zXTsKCXJldHVybiAkZXh0ZW5kKHRyYW5zaXRpb24sIHsKCQllYXNlSW46IGZ1bmN0aW9uKHBvcyl7CgkJCXJldHVybiB0cmFuc2l0aW9uKHBvcywgcGFyYW1zKTsKCQl9LAoJCWVhc2VPdXQ6IGZ1bmN0aW9uKHBvcyl7CgkJCXJldHVybiAxIC0gdHJhbnNpdGlvbigxIC0gcG9zLCBwYXJhbXMpOwoJCX0sCgkJZWFzZUluT3V0OiBmdW5jdGlvbihwb3MpewoJCQlyZXR1cm4gKHBvcyA8PSAwLjUpID8gdHJhbnNpdGlvbigyICogcG9zLCBwYXJhbXMpIC8gMiA6ICgyIC0gdHJhbnNpdGlvbigyICogKDEgLSBwb3MpLCBwYXJhbXMpKSAvIDI7CgkJfQoJfSk7Cn07CgpGeC5UcmFuc2l0aW9ucyA9IG5ldyBBYnN0cmFjdCh7CgoJLyoKCVByb3BlcnR5OiBsaW5lYXIKCQlkaXNwbGF5cyBhIGxpbmVhciB0cmFuc2l0aW9uLgoKCUdyYXBoOgoJCShzZWUgTGluZWFyLnBuZykKCSovCgoJbGluZWFyOiBmdW5jdGlvbihwKXsKCQlyZXR1cm4gcDsKCX0KCn0pOwoKRnguVHJhbnNpdGlvbnMuZXh0ZW5kID0gZnVuY3Rpb24odHJhbnNpdGlvbnMpewoJZm9yICh2YXIgdHJhbnNpdGlvbiBpbiB0cmFuc2l0aW9ucyl7CgkJRnguVHJhbnNpdGlvbnNbdHJhbnNpdGlvbl0gPSBuZXcgRnguVHJhbnNpdGlvbih0cmFuc2l0aW9uc1t0cmFuc2l0aW9uXSk7CgkJLypjb21wYXRpYmlsaXR5Ki8KCQlGeC5UcmFuc2l0aW9ucy5jb21wYXQodHJhbnNpdGlvbik7CgkJLyplbmQgY29tcGF0aWJpbGl0eSovCgl9Cn07CgovKmNvbXBhdGliaWxpdHkqLwoKRnguVHJhbnNpdGlvbnMuY29tcGF0ID0gZnVuY3Rpb24odHJhbnNpdGlvbil7CglbJ0luJywgJ091dCcsICdJbk91dCddLmVhY2goZnVuY3Rpb24oZWFzZVR5cGUpewoJCUZ4LlRyYW5zaXRpb25zW3RyYW5zaXRpb24udG9Mb3dlckNhc2UoKSArIGVhc2VUeXBlXSA9IEZ4LlRyYW5zaXRpb25zW3RyYW5zaXRpb25dWydlYXNlJyArIGVhc2VUeXBlXTsKCX0pOwp9OwoKLyplbmQgY29tcGF0aWJpbGl0eSovCgpGeC5UcmFuc2l0aW9ucy5leHRlbmQoewoKCS8qCglQcm9wZXJ0eTogUXVhZAoJCWRpc3BsYXlzIGEgcXVhZHJhdGljIHRyYW5zaXRpb24uIE11c3QgYmUgdXNlZCBhcyBRdWFkLmVhc2VJbiBvciBRdWFkLmVhc2VPdXQgb3IgUXVhZC5lYXNlSW5PdXQKCglHcmFwaDoKCQkoc2VlIFF1YWQucG5nKQoJKi8KCgkvL2F1dG8gZ2VuZXJhdGVkCgoJLyoKCVByb3BlcnR5OiBDdWJpYwoJCWRpc3BsYXlzIGEgY3ViaWN1bGFyIHRyYW5zaXRpb24uIE11c3QgYmUgdXNlZCBhcyBDdWJpYy5lYXNlSW4gb3IgQ3ViaWMuZWFzZU91dCBvciBDdWJpYy5lYXNlSW5PdXQKCglHcmFwaDoKCQkoc2VlIEN1YmljLnBuZykKCSovCgoJLy9hdXRvIGdlbmVyYXRlZAoKCS8qCglQcm9wZXJ0eTogUXVhcnQKCQlkaXNwbGF5cyBhIHF1YXJ0ZXRpYyB0cmFuc2l0aW9uLiBNdXN0IGJlIHVzZWQgYXMgUXVhcnQuZWFzZUluIG9yIFF1YXJ0LmVhc2VPdXQgb3IgUXVhcnQuZWFzZUluT3V0CgoJR3JhcGg6CgkJKHNlZSBRdWFydC5wbmcpCgkqLwoKCS8vYXV0byBnZW5lcmF0ZWQKCgkvKgoJUHJvcGVydHk6IFF1aW50CgkJZGlzcGxheXMgYSBxdWludGljIHRyYW5zaXRpb24uIE11c3QgYmUgdXNlZCBhcyBRdWludC5lYXNlSW4gb3IgUXVpbnQuZWFzZU91dCBvciBRdWludC5lYXNlSW5PdXQKCglHcmFwaDoKCQkoc2VlIFF1aW50LnBuZykKCSovCgoJLy9hdXRvIGdlbmVyYXRlZAoKCS8qCglQcm9wZXJ0eTogUG93CgkJVXNlZCB0byBnZW5lcmF0ZSBRdWFkLCBDdWJpYywgUXVhcnQgYW5kIFF1aW50LgoJCUJ5IGRlZmF1bHQgaXMgcF42LgoKCUdyYXBoOgoJCShzZWUgUG93LnBuZykKCSovCgoJUG93OiBmdW5jdGlvbihwLCB4KXsKCQlyZXR1cm4gTWF0aC5wb3cocCwgeFswXSB8fCA2KTsKCX0sCgoJLyoKCVByb3BlcnR5OiBFeHBvCgkJZGlzcGxheXMgYSBleHBvbmVudGlhbCB0cmFuc2l0aW9uLiBNdXN0IGJlIHVzZWQgYXMgRXhwby5lYXNlSW4gb3IgRXhwby5lYXNlT3V0IG9yIEV4cG8uZWFzZUluT3V0CgoJR3JhcGg6CgkJKHNlZSBFeHBvLnBuZykKCSovCgoJRXhwbzogZnVuY3Rpb24ocCl7CgkJcmV0dXJuIE1hdGgucG93KDIsIDggKiAocCAtIDEpKTsKCX0sCgoJLyoKCVByb3BlcnR5OiBDaXJjCgkJZGlzcGxheXMgYSBjaXJjdWxhciB0cmFuc2l0aW9uLiBNdXN0IGJlIHVzZWQgYXMgQ2lyYy5lYXNlSW4gb3IgQ2lyYy5lYXNlT3V0IG9yIENpcmMuZWFzZUluT3V0CgoJR3JhcGg6CgkJKHNlZSBDaXJjLnBuZykKCSovCgoJQ2lyYzogZnVuY3Rpb24ocCl7CgkJcmV0dXJuIDEgLSBNYXRoLnNpbihNYXRoLmFjb3MocCkpOwoJfSwKCgkvKgoJUHJvcGVydHk6IFNpbmUKCQlkaXNwbGF5cyBhIHNpbmVvdXNpZGFsIHRyYW5zaXRpb24uIE11c3QgYmUgdXNlZCBhcyBTaW5lLmVhc2VJbiBvciBTaW5lLmVhc2VPdXQgb3IgU2luZS5lYXNlSW5PdXQKCglHcmFwaDoKCQkoc2VlIFNpbmUucG5nKQoJKi8KCglTaW5lOiBmdW5jdGlvbihwKXsKCQlyZXR1cm4gMSAtIE1hdGguc2luKCgxIC0gcCkgKiBNYXRoLlBJIC8gMik7Cgl9LAoKCS8qCglQcm9wZXJ0eTogQmFjawoJCW1ha2VzIHRoZSB0cmFuc2l0aW9uIGdvIGJhY2ssIHRoZW4gYWxsIGZvcnRoLiBNdXN0IGJlIHVzZWQgYXMgQmFjay5lYXNlSW4gb3IgQmFjay5lYXNlT3V0IG9yIEJhY2suZWFzZUluT3V0CgoJR3JhcGg6CgkJKHNlZSBCYWNrLnBuZykKCSovCgoJQmFjazogZnVuY3Rpb24ocCwgeCl7CgkJeCA9IHhbMF0gfHwgMS42MTg7CgkJcmV0dXJuIE1hdGgucG93KHAsIDIpICogKCh4ICsgMSkgKiBwIC0geCk7Cgl9LAoKCS8qCglQcm9wZXJ0eTogQm91bmNlCgkJbWFrZXMgdGhlIHRyYW5zaXRpb24gYm91bmN5LiBNdXN0IGJlIHVzZWQgYXMgQm91bmNlLmVhc2VJbiBvciBCb3VuY2UuZWFzZU91dCBvciBCb3VuY2UuZWFzZUluT3V0CgoJR3JhcGg6CgkJKHNlZSBCb3VuY2UucG5nKQoJKi8KCglCb3VuY2U6IGZ1bmN0aW9uKHApewoJCXZhciB2YWx1ZTsKCQlmb3IgKHZhciBhID0gMCwgYiA9IDE7IDE7IGEgKz0gYiwgYiAvPSAyKXsKCQkJaWYgKHAgPj0gKDcgLSA0ICogYSkgLyAxMSl7CgkJCQl2YWx1ZSA9IC0gTWF0aC5wb3coKDExIC0gNiAqIGEgLSAxMSAqIHApIC8gNCwgMikgKyBiICogYjsKCQkJCWJyZWFrOwoJCQl9CgkJfQoJCXJldHVybiB2YWx1ZTsKCX0sCgoJLyoKCVByb3BlcnR5OiBFbGFzdGljCgkJRWxhc3RpYyBjdXJ2ZS4gTXVzdCBiZSB1c2VkIGFzIEVsYXN0aWMuZWFzZUluIG9yIEVsYXN0aWMuZWFzZU91dCBvciBFbGFzdGljLmVhc2VJbk91dAoKCUdyYXBoOgoJCShzZWUgRWxhc3RpYy5wbmcpCgkqLwoKCUVsYXN0aWM6IGZ1bmN0aW9uKHAsIHgpewoJCXJldHVybiBNYXRoLnBvdygyLCAxMCAqIC0tcCkgKiBNYXRoLmNvcygyMCAqIHAgKiBNYXRoLlBJICogKHhbMF0gfHwgMSkgLyAzKTsKCX0KCn0pOwoKWydRdWFkJywgJ0N1YmljJywgJ1F1YXJ0JywgJ1F1aW50J10uZWFjaChmdW5jdGlvbih0cmFuc2l0aW9uLCBpKXsKCUZ4LlRyYW5zaXRpb25zW3RyYW5zaXRpb25dID0gbmV3IEZ4LlRyYW5zaXRpb24oZnVuY3Rpb24ocCl7CgkJcmV0dXJuIE1hdGgucG93KHAsIFtpICsgMl0pOwoJfSk7CgoJLypjb21wYXRpYmlsaXR5Ki8KCUZ4LlRyYW5zaXRpb25zLmNvbXBhdCh0cmFuc2l0aW9uKTsKCS8qZW5kIGNvbXBhdGliaWxpdHkqLwp9KTsKCi8qClNjcmlwdDogRHJhZy5CYXNlLmpzCglDb250YWlucyA8RHJhZy5CYXNlPiwgPEVsZW1lbnQubWFrZVJlc2l6YWJsZT4KCkxpY2Vuc2U6CglNSVQtc3R5bGUgbGljZW5zZS4KKi8KCnZhciBEcmFnID0ge307CgovKgpDbGFzczogRHJhZy5CYXNlCglNb2RpZnkgdHdvIGNzcyBwcm9wZXJ0aWVzIG9mIGFuIGVsZW1lbnQgYmFzZWQgb24gdGhlIHBvc2l0aW9uIG9mIHRoZSBtb3VzZS4KCk5vdGU6CglEcmFnLkJhc2UgcmVxdWlyZXMgYW4gWEhUTUwgZG9jdHlwZS4KCkFyZ3VtZW50czoKCWVsIC0gdGhlICQoZWxlbWVudCkgdG8gYXBwbHkgdGhlIHRyYW5zZm9ybWF0aW9ucyB0by4KCW9wdGlvbnMgLSBvcHRpb25hbC4gVGhlIG9wdGlvbnMgb2JqZWN0LgoKT3B0aW9uczoKCWhhbmRsZSAtIHRoZSAkKGVsZW1lbnQpIHRvIGFjdCBhcyB0aGUgaGFuZGxlIGZvciB0aGUgZHJhZ2dhYmxlIGVsZW1lbnQuIGRlZmF1bHRzIHRvIHRoZSAkKGVsZW1lbnQpIGl0c2VsZi4KCW1vZGlmaWVycyAtIGFuIG9iamVjdC4gc2VlIE1vZGlmaWVycyBCZWxvdy4KCWxpbWl0IC0gYW4gb2JqZWN0LCBzZWUgTGltaXQgYmVsb3cuCglncmlkIC0gb3B0aW9uYWwsIGRpc3RhbmNlIGluIHB4IGZvciBzbmFwLXRvLWdyaWQgZHJhZ2dpbmcKCXNuYXAgLSBvcHRpb25hbCwgdGhlIGRpc3RhbmNlIHlvdSBoYXZlIHRvIGRyYWcgYmVmb3JlIHRoZSBlbGVtZW50IHN0YXJ0cyB0byByZXNwb25kIHRvIHRoZSBkcmFnLiBkZWZhdWx0cyB0byBmYWxzZQoKCW1vZGlmaWVyczoKCQl4IC0gc3RyaW5nLCB0aGUgc3R5bGUgeW91IHdhbnQgdG8gbW9kaWZ5IHdoZW4gdGhlIG1vdXNlIG1vdmVzIGluIGFuIGhvcml6b250YWwgZGlyZWN0aW9uLiBkZWZhdWx0cyB0byAnbGVmdCcKCQl5IC0gc3RyaW5nLCB0aGUgc3R5bGUgeW91IHdhbnQgdG8gbW9kaWZ5IHdoZW4gdGhlIG1vdXNlIG1vdmVzIGluIGEgdmVydGljYWwgZGlyZWN0aW9uLiBkZWZhdWx0cyB0byAndG9wJwoKCWxpbWl0OgoJCXggLSBhcnJheSB3aXRoIHN0YXJ0IGFuZCBlbmQgbGltaXQgcmVsYXRpdmUgdG8gbW9kaWZpZXJzLngKCQl5IC0gYXJyYXkgd2l0aCBzdGFydCBhbmQgZW5kIGxpbWl0IHJlbGF0aXZlIHRvIG1vZGlmaWVycy55CgpFdmVudHM6CglvblN0YXJ0IC0gb3B0aW9uYWwsIGZ1bmN0aW9uIHRvIGV4ZWN1dGUgd2hlbiB0aGUgdXNlciBzdGFydHMgdG8gZHJhZyAob24gbW91c2Vkb3duKTsKCW9uQ29tcGxldGUgLSBvcHRpb25hbCwgZnVuY3Rpb24gdG8gZXhlY3V0ZSB3aGVuIHRoZSB1c2VyIGNvbXBsZXRlcyB0aGUgZHJhZy4KCW9uRHJhZyAtIG9wdGlvbmFsLCBmdW5jdGlvbiB0byBleGVjdXRlIGF0IGV2ZXJ5IHN0ZXAgb2YgdGhlIGRyYWcKKi8KCkRyYWcuQmFzZSA9IG5ldyBDbGFzcyh7CgoJb3B0aW9uczogewoJCWhhbmRsZTogZmFsc2UsCgkJdW5pdDogJ3B4JywKCQlvblN0YXJ0OiBDbGFzcy5lbXB0eSwKCQlvbkJlZm9yZVN0YXJ0OiBDbGFzcy5lbXB0eSwKCQlvbkNvbXBsZXRlOiBDbGFzcy5lbXB0eSwKCQlvblNuYXA6IENsYXNzLmVtcHR5LAoJCW9uRHJhZzogQ2xhc3MuZW1wdHksCgkJbGltaXQ6IGZhbHNlLAoJCW1vZGlmaWVyczoge3g6ICdsZWZ0JywgeTogJ3RvcCd9LAoJCWdyaWQ6IGZhbHNlLAoJCXNuYXA6IDYKCX0sCgoJaW5pdGlhbGl6ZTogZnVuY3Rpb24oZWwsIG9wdGlvbnMpewoJCXRoaXMuc2V0T3B0aW9ucyhvcHRpb25zKTsKCQl0aGlzLmVsZW1lbnQgPSAkKGVsKTsKCQl0aGlzLmhhbmRsZSA9ICQodGhpcy5vcHRpb25zLmhhbmRsZSkgfHwgdGhpcy5lbGVtZW50OwoJCXRoaXMubW91c2UgPSB7J25vdyc6IHt9LCAncG9zJzoge319OwoJCXRoaXMudmFsdWUgPSB7J3N0YXJ0Jzoge30sICdub3cnOiB7fX07CgkJdGhpcy5ib3VuZCA9IHsKCQkJJ3N0YXJ0JzogdGhpcy5zdGFydC5iaW5kV2l0aEV2ZW50KHRoaXMpLAoJCQknY2hlY2snOiB0aGlzLmNoZWNrLmJpbmRXaXRoRXZlbnQodGhpcyksCgkJCSdkcmFnJzogdGhpcy5kcmFnLmJpbmRXaXRoRXZlbnQodGhpcyksCgkJCSdzdG9wJzogdGhpcy5zdG9wLmJpbmQodGhpcykKCQl9OwoJCXRoaXMuYXR0YWNoKCk7CgkJaWYgKHRoaXMub3B0aW9ucy5pbml0aWFsaXplKSB0aGlzLm9wdGlvbnMuaW5pdGlhbGl6ZS5jYWxsKHRoaXMpOwoJfSwKCglhdHRhY2g6IGZ1bmN0aW9uKCl7CgkJdGhpcy5oYW5kbGUuYWRkRXZlbnQoJ21vdXNlZG93bicsIHRoaXMuYm91bmQuc3RhcnQpOwoJCXJldHVybiB0aGlzOwoJfSwKCglkZXRhY2g6IGZ1bmN0aW9uKCl7CgkJdGhpcy5oYW5kbGUucmVtb3ZlRXZlbnQoJ21vdXNlZG93bicsIHRoaXMuYm91bmQuc3RhcnQpOwoJCXJldHVybiB0aGlzOwoJfSwKCglzdGFydDogZnVuY3Rpb24oZXZlbnQpewoJCXRoaXMuZmlyZUV2ZW50KCdvbkJlZm9yZVN0YXJ0JywgdGhpcy5lbGVtZW50KTsKCQl0aGlzLm1vdXNlLnN0YXJ0ID0gZXZlbnQucGFnZTsKCQl2YXIgbGltaXQgPSB0aGlzLm9wdGlvbnMubGltaXQ7CgkJdGhpcy5saW1pdCA9IHsneCc6IFtdLCAneSc6IFtdfTsKCQlmb3IgKHZhciB6IGluIHRoaXMub3B0aW9ucy5tb2RpZmllcnMpewoJCQlpZiAoIXRoaXMub3B0aW9ucy5tb2RpZmllcnNbel0pIGNvbnRpbnVlOwoJCQl0aGlzLnZhbHVlLm5vd1t6XSA9IHRoaXMuZWxlbWVudC5nZXRTdHlsZSh0aGlzLm9wdGlvbnMubW9kaWZpZXJzW3pdKS50b0ludCgpOwoJCQl0aGlzLm1vdXNlLnBvc1t6XSA9IGV2ZW50LnBhZ2Vbel0gLSB0aGlzLnZhbHVlLm5vd1t6XTsKCQkJaWYgKGxpbWl0ICYmIGxpbWl0W3pdKXsKCQkJCWZvciAodmFyIGkgPSAwOyBpIDwgMjsgaSsrKXsKCQkJCQlpZiAoJGNoayhsaW1pdFt6XVtpXSkpIHRoaXMubGltaXRbel1baV0gPSAoJHR5cGUobGltaXRbel1baV0pID09ICdmdW5jdGlvbicpID8gbGltaXRbel1baV0oKSA6IGxpbWl0W3pdW2ldOwoJCQkJfQoJCQl9CgkJfQoJCWlmICgkdHlwZSh0aGlzLm9wdGlvbnMuZ3JpZCkgPT0gJ251bWJlcicpIHRoaXMub3B0aW9ucy5ncmlkID0geyd4JzogdGhpcy5vcHRpb25zLmdyaWQsICd5JzogdGhpcy5vcHRpb25zLmdyaWR9OwoJCWRvY3VtZW50LmFkZExpc3RlbmVyKCdtb3VzZW1vdmUnLCB0aGlzLmJvdW5kLmNoZWNrKTsKCQlkb2N1bWVudC5hZGRMaXN0ZW5lcignbW91c2V1cCcsIHRoaXMuYm91bmQuc3RvcCk7CgkJdGhpcy5maXJlRXZlbnQoJ29uU3RhcnQnLCB0aGlzLmVsZW1lbnQpOwoJCWV2ZW50LnN0b3AoKTsKCX0sCgoJY2hlY2s6IGZ1bmN0aW9uKGV2ZW50KXsKCQl2YXIgZGlzdGFuY2UgPSBNYXRoLnJvdW5kKE1hdGguc3FydChNYXRoLnBvdyhldmVudC5wYWdlLnggLSB0aGlzLm1vdXNlLnN0YXJ0LngsIDIpICsgTWF0aC5wb3coZXZlbnQucGFnZS55IC0gdGhpcy5tb3VzZS5zdGFydC55LCAyKSkpOwoJCWlmIChkaXN0YW5jZSA+IHRoaXMub3B0aW9ucy5zbmFwKXsKCQkJZG9jdW1lbnQucmVtb3ZlTGlzdGVuZXIoJ21vdXNlbW92ZScsIHRoaXMuYm91bmQuY2hlY2spOwoJCQlkb2N1bWVudC5hZGRMaXN0ZW5lcignbW91c2Vtb3ZlJywgdGhpcy5ib3VuZC5kcmFnKTsKCQkJdGhpcy5kcmFnKGV2ZW50KTsKCQkJdGhpcy5maXJlRXZlbnQoJ29uU25hcCcsIHRoaXMuZWxlbWVudCk7CgkJfQoJCWV2ZW50LnN0b3AoKTsKCX0sCgoJZHJhZzogZnVuY3Rpb24oZXZlbnQpewoJCXRoaXMub3V0ID0gZmFsc2U7CgkJdGhpcy5tb3VzZS5ub3cgPSBldmVudC5wYWdlOwoJCWZvciAodmFyIHogaW4gdGhpcy5vcHRpb25zLm1vZGlmaWVycyl7CgkJCWlmICghdGhpcy5vcHRpb25zLm1vZGlmaWVyc1t6XSkgY29udGludWU7CgkJCXRoaXMudmFsdWUubm93W3pdID0gdGhpcy5tb3VzZS5ub3dbel0gLSB0aGlzLm1vdXNlLnBvc1t6XTsKCQkJaWYgKHRoaXMubGltaXRbel0pewoJCQkJaWYgKCRjaGsodGhpcy5saW1pdFt6XVsxXSkgJiYgKHRoaXMudmFsdWUubm93W3pdID4gdGhpcy5saW1pdFt6XVsxXSkpewoJCQkJCXRoaXMudmFsdWUubm93W3pdID0gdGhpcy5saW1pdFt6XVsxXTsKCQkJCQl0aGlzLm91dCA9IHRydWU7CgkJCQl9IGVsc2UgaWYgKCRjaGsodGhpcy5saW1pdFt6XVswXSkgJiYgKHRoaXMudmFsdWUubm93W3pdIDwgdGhpcy5saW1pdFt6XVswXSkpewoJCQkJCXRoaXMudmFsdWUubm93W3pdID0gdGhpcy5saW1pdFt6XVswXTsKCQkJCQl0aGlzLm91dCA9IHRydWU7CgkJCQl9CgkJCX0KCQkJaWYgKHRoaXMub3B0aW9ucy5ncmlkW3pdKSB0aGlzLnZhbHVlLm5vd1t6XSAtPSAodGhpcy52YWx1ZS5ub3dbel0gJSB0aGlzLm9wdGlvbnMuZ3JpZFt6XSk7CgkJCXRoaXMuZWxlbWVudC5zZXRTdHlsZSh0aGlzLm9wdGlvbnMubW9kaWZpZXJzW3pdLCB0aGlzLnZhbHVlLm5vd1t6XSArIHRoaXMub3B0aW9ucy51bml0KTsKCQl9CgkJdGhpcy5maXJlRXZlbnQoJ29uRHJhZycsIHRoaXMuZWxlbWVudCk7CgkJZXZlbnQuc3RvcCgpOwoJfSwKCglzdG9wOiBmdW5jdGlvbigpewoJCWRvY3VtZW50LnJlbW92ZUxpc3RlbmVyKCdtb3VzZW1vdmUnLCB0aGlzLmJvdW5kLmNoZWNrKTsKCQlkb2N1bWVudC5yZW1vdmVMaXN0ZW5lcignbW91c2Vtb3ZlJywgdGhpcy5ib3VuZC5kcmFnKTsKCQlkb2N1bWVudC5yZW1vdmVMaXN0ZW5lcignbW91c2V1cCcsIHRoaXMuYm91bmQuc3RvcCk7CgkJdGhpcy5maXJlRXZlbnQoJ29uQ29tcGxldGUnLCB0aGlzLmVsZW1lbnQpOwoJfQoKfSk7CgpEcmFnLkJhc2UuaW1wbGVtZW50KG5ldyBFdmVudHMsIG5ldyBPcHRpb25zKTsKCi8qCkNsYXNzOiBFbGVtZW50CglDdXN0b20gY2xhc3MgdG8gYWxsb3cgYWxsIG9mIGl0cyBtZXRob2RzIHRvIGJlIHVzZWQgd2l0aCBhbnkgRE9NIGVsZW1lbnQgdmlhIHRoZSBkb2xsYXIgZnVuY3Rpb24gPCQ+LgoqLwoKRWxlbWVudC5leHRlbmQoewoKCS8qCglQcm9wZXJ0eTogbWFrZVJlc2l6YWJsZQoJCU1ha2VzIGFuIGVsZW1lbnQgcmVzaXphYmxlIChieSBkcmFnZ2luZykgd2l0aCB0aGUgc3VwcGxpZWQgb3B0aW9ucy4KCglBcmd1bWVudHM6CgkJb3B0aW9ucyAtIHNlZSA8RHJhZy5CYXNlPiBmb3IgYWNjZXB0YWJsZSBvcHRpb25zLgoJKi8KCgltYWtlUmVzaXphYmxlOiBmdW5jdGlvbihvcHRpb25zKXsKCQlyZXR1cm4gbmV3IERyYWcuQmFzZSh0aGlzLCAkbWVyZ2Uoe21vZGlmaWVyczoge3g6ICd3aWR0aCcsIHk6ICdoZWlnaHQnfX0sIG9wdGlvbnMpKTsKCX0KCn0pOwoKLyoKU2NyaXB0OiBEcmFnLk1vdmUuanMKCUNvbnRhaW5zIDxEcmFnLk1vdmU+LCA8RWxlbWVudC5tYWtlRHJhZ2dhYmxlPgoKTGljZW5zZToKCU1JVC1zdHlsZSBsaWNlbnNlLgoqLwoKLyoKQ2xhc3M6IERyYWcuTW92ZQoJRXh0ZW5kcyA8RHJhZy5CYXNlPiwgaGFzIGFkZGl0aW9uYWwgZnVuY3Rpb25hbGl0eSBmb3IgZHJhZ2dpbmcgYW4gZWxlbWVudCwgc3VwcG9ydCBzbmFwcGluZyBhbmQgZHJvcHBhYmxlcy4KCURyYWcubW92ZSBzdXBwb3J0cyBlaXRoZXIgcG9zaXRpb24gYWJzb2x1dGUgb3IgcmVsYXRpdmUuIElmIG5vIHBvc2l0aW9uIGlzIGZvdW5kLCBhYnNvbHV0ZSB3aWxsIGJlIHNldC4KCUluaGVyaXRzIG1ldGhvZHMsIHByb3BlcnRpZXMsIG9wdGlvbnMgYW5kIGV2ZW50cyBmcm9tIDxEcmFnLkJhc2U+LgoKTm90ZToKCURyYWcuTW92ZSByZXF1aXJlcyBhbiBYSFRNTCBkb2N0eXBlLgoKQXJndW1lbnRzOgoJZWwgLSB0aGUgJChlbGVtZW50KSB0byBhcHBseSB0aGUgZHJhZyB0by4KCW9wdGlvbnMgLSBvcHRpb25hbC4gc2VlIE9wdGlvbnMgYmVsb3cuCgpPcHRpb25zOgoJYWxsIHRoZSBkcmFnLkJhc2Ugb3B0aW9ucywgcGx1czoKCWNvbnRhaW5lciAtIGFuIGVsZW1lbnQsIHdpbGwgZmlsbCBhdXRvbWF0aWNhbGx5IGxpbWl0aW5nIG9wdGlvbnMgYmFzZWQgb24gdGhlICQoZWxlbWVudCkgc2l6ZSBhbmQgcG9zaXRpb24uIGRlZmF1bHRzIHRvIGZhbHNlIChubyBsaW1pdGluZykKCWRyb3BwYWJsZXMgLSBhbiBhcnJheSBvZiBlbGVtZW50cyB5b3UgY2FuIGRyb3AgeW91ciBkcmFnZ2FibGUgdG8uCglvdmVyZmxvd24gLSBhbiBhcnJheSBvZiBuZXN0ZWQgc2Nyb2xsaW5nIGNvbnRhaW5lcnMsIHNlZSBFbGVtZW50OjpnZXRQb3NpdGlvbgoqLwoKRHJhZy5Nb3ZlID0gRHJhZy5CYXNlLmV4dGVuZCh7CgoJb3B0aW9uczogewoJCWRyb3BwYWJsZXM6IFtdLAoJCWNvbnRhaW5lcjogZmFsc2UsCgkJb3ZlcmZsb3duOiBbXQoJfSwKCglpbml0aWFsaXplOiBmdW5jdGlvbihlbCwgb3B0aW9ucyl7CgkJdGhpcy5zZXRPcHRpb25zKG9wdGlvbnMpOwoJCXRoaXMuZWxlbWVudCA9ICQoZWwpOwoJCXRoaXMuZHJvcHBhYmxlcyA9ICQkKHRoaXMub3B0aW9ucy5kcm9wcGFibGVzKTsKCQl0aGlzLmNvbnRhaW5lciA9ICQodGhpcy5vcHRpb25zLmNvbnRhaW5lcik7CgkJdGhpcy5wb3NpdGlvbiA9IHsnZWxlbWVudCc6IHRoaXMuZWxlbWVudC5nZXRTdHlsZSgncG9zaXRpb24nKSwgJ2NvbnRhaW5lcic6IGZhbHNlfTsKCQlpZiAodGhpcy5jb250YWluZXIpIHRoaXMucG9zaXRpb24uY29udGFpbmVyID0gdGhpcy5jb250YWluZXIuZ2V0U3R5bGUoJ3Bvc2l0aW9uJyk7CgkJaWYgKCFbJ3JlbGF0aXZlJywgJ2Fic29sdXRlJywgJ2ZpeGVkJ10uY29udGFpbnModGhpcy5wb3NpdGlvbi5lbGVtZW50KSkgdGhpcy5wb3NpdGlvbi5lbGVtZW50ID0gJ2Fic29sdXRlJzsKCQl2YXIgdG9wID0gdGhpcy5lbGVtZW50LmdldFN0eWxlKCd0b3AnKS50b0ludCgpOwoJCXZhciBsZWZ0ID0gdGhpcy5lbGVtZW50LmdldFN0eWxlKCdsZWZ0JykudG9JbnQoKTsKCQlpZiAodGhpcy5wb3NpdGlvbi5lbGVtZW50ID09ICdhYnNvbHV0ZScgJiYgIVsncmVsYXRpdmUnLCAnYWJzb2x1dGUnLCAnZml4ZWQnXS5jb250YWlucyh0aGlzLnBvc2l0aW9uLmNvbnRhaW5lcikpewoJCQl0b3AgPSAkY2hrKHRvcCkgPyB0b3AgOiB0aGlzLmVsZW1lbnQuZ2V0VG9wKHRoaXMub3B0aW9ucy5vdmVyZmxvd24pOwoJCQlsZWZ0ID0gJGNoayhsZWZ0KSA/IGxlZnQgOiB0aGlzLmVsZW1lbnQuZ2V0TGVmdCh0aGlzLm9wdGlvbnMub3ZlcmZsb3duKTsKCQl9IGVsc2UgewoJCQl0b3AgPSAkY2hrKHRvcCkgPyB0b3AgOiAwOwoJCQlsZWZ0ID0gJGNoayhsZWZ0KSA/IGxlZnQgOiAwOwoJCX0KCQl0aGlzLmVsZW1lbnQuc2V0U3R5bGVzKHsndG9wJzogdG9wLCAnbGVmdCc6IGxlZnQsICdwb3NpdGlvbic6IHRoaXMucG9zaXRpb24uZWxlbWVudH0pOwoJCXRoaXMucGFyZW50KHRoaXMuZWxlbWVudCk7Cgl9LAoKCXN0YXJ0OiBmdW5jdGlvbihldmVudCl7CgkJdGhpcy5vdmVyZWQgPSBudWxsOwoJCWlmICh0aGlzLmNvbnRhaW5lcil7CgkJCXZhciBjb250ID0gdGhpcy5jb250YWluZXIuZ2V0Q29vcmRpbmF0ZXMoKTsKCQkJdmFyIGVsID0gdGhpcy5lbGVtZW50LmdldENvb3JkaW5hdGVzKCk7CgkJCWlmICh0aGlzLnBvc2l0aW9uLmVsZW1lbnQgPT0gJ2Fic29sdXRlJyAmJiAhWydyZWxhdGl2ZScsICdhYnNvbHV0ZScsICdmaXhlZCddLmNvbnRhaW5zKHRoaXMucG9zaXRpb24uY29udGFpbmVyKSl7CgkJCQl0aGlzLm9wdGlvbnMubGltaXQgPSB7CgkJCQkJJ3gnOiBbY29udC5sZWZ0LCBjb250LnJpZ2h0IC0gZWwud2lkdGhdLAoJCQkJCSd5JzogW2NvbnQudG9wLCBjb250LmJvdHRvbSAtIGVsLmhlaWdodF0KCQkJCX07CgkJCX0gZWxzZSB7CgkJCQl0aGlzLm9wdGlvbnMubGltaXQgPSB7CgkJCQkJJ3knOiBbMCwgY29udC5oZWlnaHQgLSBlbC5oZWlnaHRdLAoJCQkJCSd4JzogWzAsIGNvbnQud2lkdGggLSBlbC53aWR0aF0KCQkJCX07CgkJCX0KCQl9CgkJdGhpcy5wYXJlbnQoZXZlbnQpOwoJfSwKCglkcmFnOiBmdW5jdGlvbihldmVudCl7CgkJdGhpcy5wYXJlbnQoZXZlbnQpOwoJCXZhciBvdmVyZWQgPSB0aGlzLm91dCA/IGZhbHNlIDogdGhpcy5kcm9wcGFibGVzLmZpbHRlcih0aGlzLmNoZWNrQWdhaW5zdCwgdGhpcykuZ2V0TGFzdCgpOwoJCWlmICh0aGlzLm92ZXJlZCAhPSBvdmVyZWQpewoJCQlpZiAodGhpcy5vdmVyZWQpIHRoaXMub3ZlcmVkLmZpcmVFdmVudCgnbGVhdmUnLCBbdGhpcy5lbGVtZW50LCB0aGlzXSk7CgkJCXRoaXMub3ZlcmVkID0gb3ZlcmVkID8gb3ZlcmVkLmZpcmVFdmVudCgnb3ZlcicsIFt0aGlzLmVsZW1lbnQsIHRoaXNdKSA6IG51bGw7CgkJfQoJCXJldHVybiB0aGlzOwoJfSwKCgljaGVja0FnYWluc3Q6IGZ1bmN0aW9uKGVsKXsKCQllbCA9IGVsLmdldENvb3JkaW5hdGVzKHRoaXMub3B0aW9ucy5vdmVyZmxvd24pOwoJCXZhciBub3cgPSB0aGlzLm1vdXNlLm5vdzsKCQlyZXR1cm4gKG5vdy54ID4gZWwubGVmdCAmJiBub3cueCA8IGVsLnJpZ2h0ICYmIG5vdy55IDwgZWwuYm90dG9tICYmIG5vdy55ID4gZWwudG9wKTsKCX0sCgoJc3RvcDogZnVuY3Rpb24oKXsKCQlpZiAodGhpcy5vdmVyZWQgJiYgIXRoaXMub3V0KSB0aGlzLm92ZXJlZC5maXJlRXZlbnQoJ2Ryb3AnLCBbdGhpcy5lbGVtZW50LCB0aGlzXSk7CgkJZWxzZSB0aGlzLmVsZW1lbnQuZmlyZUV2ZW50KCdlbXB0eWRyb3AnLCB0aGlzKTsKCQl0aGlzLnBhcmVudCgpOwoJCXJldHVybiB0aGlzOwoJfQoKfSk7CgovKgpDbGFzczogRWxlbWVudAoJQ3VzdG9tIGNsYXNzIHRvIGFsbG93IGFsbCBvZiBpdHMgbWV0aG9kcyB0byBiZSB1c2VkIHdpdGggYW55IERPTSBlbGVtZW50IHZpYSB0aGUgZG9sbGFyIGZ1bmN0aW9uIDwkPi4KKi8KCkVsZW1lbnQuZXh0ZW5kKHsKCgkvKgoJUHJvcGVydHk6IG1ha2VEcmFnZ2FibGUKCQlNYWtlcyBhbiBlbGVtZW50IGRyYWdnYWJsZSB3aXRoIHRoZSBzdXBwbGllZCBvcHRpb25zLgoKCUFyZ3VtZW50czoKCQlvcHRpb25zIC0gc2VlIDxEcmFnLk1vdmU+IGFuZCA8RHJhZy5CYXNlPiBmb3IgYWNjZXB0YWJsZSBvcHRpb25zLgoJKi8KCgltYWtlRHJhZ2dhYmxlOiBmdW5jdGlvbihvcHRpb25zKXsKCQlyZXR1cm4gbmV3IERyYWcuTW92ZSh0aGlzLCBvcHRpb25zKTsKCX0KCn0pOwoKLyoKU2NyaXB0OiBYSFIuanMKCUNvbnRhaW5zIHRoZSBiYXNpYyBYTUxIdHRwUmVxdWVzdCBDbGFzcyBXcmFwcGVyLgoKTGljZW5zZToKCU1JVC1zdHlsZSBsaWNlbnNlLgoqLwoKLyoKQ2xhc3M6IFhIUgoJQmFzaWMgWE1MSHR0cFJlcXVlc3QgV3JhcHBlci4KCkFyZ3VtZW50czoKCW9wdGlvbnMgLSBhbiBvYmplY3Qgd2l0aCBvcHRpb25zIG5hbWVzIGFzIGtleXMuIFNlZSBvcHRpb25zIGJlbG93LgoKT3B0aW9uczoKCW1ldGhvZCAtICdwb3N0JyBvciAnZ2V0JyAtIHRoZSBwcm90b2NvbCBmb3IgdGhlIHJlcXVlc3Q7IG9wdGlvbmFsLCBkZWZhdWx0cyB0byAncG9zdCcuCglhc3luYyAtIGJvb2xlYW46IGFzeW5jaHJvbm91cyBvcHRpb247IHRydWUgdXNlcyBhc3luY2hyb25vdXMgcmVxdWVzdHMuIERlZmF1bHRzIHRvIHRydWUuCgllbmNvZGluZyAtIHRoZSBlbmNvZGluZywgZGVmYXVsdHMgdG8gdXRmLTguCglhdXRvQ2FuY2VsIC0gY2FuY2VscyB0aGUgYWxyZWFkeSBydW5uaW5nIHJlcXVlc3QgaWYgYW5vdGhlciBvbmUgaXMgc2VudC4gZGVmYXVsdHMgdG8gZmFsc2UuCgloZWFkZXJzIC0gYWNjZXB0cyBhbiBvYmplY3QsIHRoYXQgd2lsbCBiZSBzZXQgdG8gcmVxdWVzdCBoZWFkZXJzLgoKRXZlbnRzOgoJb25SZXF1ZXN0IC0gZnVuY3Rpb24gdG8gZXhlY3V0ZSB3aGVuIHRoZSBYSFIgcmVxdWVzdCBpcyBmaXJlZC4KCW9uU3VjY2VzcyAtIGZ1bmN0aW9uIHRvIGV4ZWN1dGUgd2hlbiB0aGUgWEhSIHJlcXVlc3QgY29tcGxldGVzLgoJb25TdGF0ZUNoYW5nZSAtIGZ1bmN0aW9uIHRvIGV4ZWN1dGUgd2hlbiB0aGUgc3RhdGUgb2YgdGhlIFhNTEh0dHBSZXF1ZXN0IGNoYW5nZXMuCglvbkZhaWx1cmUgLSBmdW5jdGlvbiB0byBleGVjdXRlIHdoZW4gdGhlIHN0YXRlIG9mIHRoZSBYTUxIdHRwUmVxdWVzdCBjaGFuZ2VzLgoKUHJvcGVydGllczoKCXJ1bm5pbmcgLSB0cnVlIGlmIHRoZSByZXF1ZXN0IGlzIHJ1bm5pbmcuCglyZXNwb25zZSAtIG9iamVjdCwgdGV4dCBhbmQgeG1sIGFzIGtleXMuIFlvdSBjYW4gYWNjZXNzIHRoaXMgcHJvcGVydHkgaW4gdGhlIG9uU3VjY2VzcyBldmVudC4KCkV4YW1wbGU6Cgk+dmFyIG15WEhSID0gbmV3IFhIUih7bWV0aG9kOiAnZ2V0J30pLnNlbmQoJ2h0dHA6Ly9zaXRlLmNvbS9yZXF1ZXN0SGFuZGxlci5waHAnLCAnbmFtZT1qb2huJmxhc3RuYW1lPWRvcmlhbicpOwoqLwoKdmFyIFhIUiA9IG5ldyBDbGFzcyh7CgoJb3B0aW9uczogewoJCW1ldGhvZDogJ3Bvc3QnLAoJCWFzeW5jOiB0cnVlLAoJCW9uUmVxdWVzdDogQ2xhc3MuZW1wdHksCgkJb25TdWNjZXNzOiBDbGFzcy5lbXB0eSwKCQlvbkZhaWx1cmU6IENsYXNzLmVtcHR5LAoJCXVybEVuY29kZWQ6IHRydWUsCgkJZW5jb2Rpbmc6ICd1dGYtOCcsCgkJYXV0b0NhbmNlbDogZmFsc2UsCgkJaGVhZGVyczoge30KCX0sCgoJc2V0VHJhbnNwb3J0OiBmdW5jdGlvbigpewoJCXRoaXMudHJhbnNwb3J0ID0gKHdpbmRvdy5YTUxIdHRwUmVxdWVzdCkgPyBuZXcgWE1MSHR0cFJlcXVlc3QoKSA6ICh3aW5kb3cuaWUgPyBuZXcgQWN0aXZlWE9iamVjdCgnTWljcm9zb2Z0LlhNTEhUVFAnKSA6IGZhbHNlKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJaW5pdGlhbGl6ZTogZnVuY3Rpb24ob3B0aW9ucyl7CgkJdGhpcy5zZXRUcmFuc3BvcnQoKS5zZXRPcHRpb25zKG9wdGlvbnMpOwoJCXRoaXMub3B0aW9ucy5pc1N1Y2Nlc3MgPSB0aGlzLm9wdGlvbnMuaXNTdWNjZXNzIHx8IHRoaXMuaXNTdWNjZXNzOwoJCXRoaXMuaGVhZGVycyA9IHt9OwoJCWlmICh0aGlzLm9wdGlvbnMudXJsRW5jb2RlZCAmJiB0aGlzLm9wdGlvbnMubWV0aG9kID09ICdwb3N0Jyl7CgkJCXZhciBlbmNvZGluZyA9ICh0aGlzLm9wdGlvbnMuZW5jb2RpbmcpID8gJzsgY2hhcnNldD0nICsgdGhpcy5vcHRpb25zLmVuY29kaW5nIDogJyc7CgkJCXRoaXMuc2V0SGVhZGVyKCdDb250ZW50LXR5cGUnLCAnYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkJyArIGVuY29kaW5nKTsKCQl9CgkJaWYgKHRoaXMub3B0aW9ucy5pbml0aWFsaXplKSB0aGlzLm9wdGlvbnMuaW5pdGlhbGl6ZS5jYWxsKHRoaXMpOwoJfSwKCglvblN0YXRlQ2hhbmdlOiBmdW5jdGlvbigpewoJCWlmICh0aGlzLnRyYW5zcG9ydC5yZWFkeVN0YXRlICE9IDQgfHwgIXRoaXMucnVubmluZykgcmV0dXJuOwoJCXRoaXMucnVubmluZyA9IGZhbHNlOwoJCXZhciBzdGF0dXMgPSAwOwoJCXRyeSB7c3RhdHVzID0gdGhpcy50cmFuc3BvcnQuc3RhdHVzO30gY2F0Y2goZSl7fTsKCQlpZiAodGhpcy5vcHRpb25zLmlzU3VjY2Vzcy5jYWxsKHRoaXMsIHN0YXR1cykpIHRoaXMub25TdWNjZXNzKCk7CgkJZWxzZSB0aGlzLm9uRmFpbHVyZSgpOwoJCXRoaXMudHJhbnNwb3J0Lm9ucmVhZHlzdGF0ZWNoYW5nZSA9IENsYXNzLmVtcHR5OwoJfSwKCglpc1N1Y2Nlc3M6IGZ1bmN0aW9uKHN0YXR1cyl7CgkJcmV0dXJuICgoc3RhdHVzID49IDIwMCkgJiYgKHN0YXR1cyA8IDMwMCkpOwoJfSwKCglvblN1Y2Nlc3M6IGZ1bmN0aW9uKCl7CgkJdGhpcy5yZXNwb25zZSA9IHsKCQkJJ3RleHQnOiB0aGlzLnRyYW5zcG9ydC5yZXNwb25zZVRleHQsCgkJCSd4bWwnOiB0aGlzLnRyYW5zcG9ydC5yZXNwb25zZVhNTAoJCX07CgkJdGhpcy5maXJlRXZlbnQoJ29uU3VjY2VzcycsIFt0aGlzLnJlc3BvbnNlLnRleHQsIHRoaXMucmVzcG9uc2UueG1sXSk7CgkJdGhpcy5jYWxsQ2hhaW4oKTsKCX0sCgoJb25GYWlsdXJlOiBmdW5jdGlvbigpewoJCXRoaXMuZmlyZUV2ZW50KCdvbkZhaWx1cmUnLCB0aGlzLnRyYW5zcG9ydCk7Cgl9LAoKCS8qCglQcm9wZXJ0eTogc2V0SGVhZGVyCgkJQWRkL21vZGlmeSBhbiBoZWFkZXIgZm9yIHRoZSByZXF1ZXN0LiBJdCB3aWxsIG5vdCBvdmVycmlkZSBoZWFkZXJzIGZyb20gdGhlIG9wdGlvbnMuCgoJRXhhbXBsZToKCQk+dmFyIG15WGhyID0gbmV3IFhIUih1cmwsIHttZXRob2Q6ICdnZXQnLCBoZWFkZXJzOiB7J1gtUmVxdWVzdCc6ICdKU09OJ319KTsKCQk+bXlYaHIuc2V0SGVhZGVyKCdMYXN0LU1vZGlmaWVkJywnU2F0LCAxIEphbiAyMDA1IDA1OjAwOjAwIEdNVCcpOwoJKi8KCglzZXRIZWFkZXI6IGZ1bmN0aW9uKG5hbWUsIHZhbHVlKXsKCQl0aGlzLmhlYWRlcnNbbmFtZV0gPSB2YWx1ZTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJLyoKCVByb3BlcnR5OiBzZW5kCgkJT3BlbnMgdGhlIFhIUiBjb25uZWN0aW9uIGFuZCBzZW5kcyB0aGUgZGF0YS4gRGF0YSBoYXMgdG8gYmUgbnVsbCBvciBhIHN0cmluZy4KCglFeGFtcGxlOgoJCT52YXIgbXlYaHIgPSBuZXcgWEhSKHttZXRob2Q6ICdwb3N0J30pOwoJCT5teVhoci5zZW5kKHVybCwgcXVlcnlzdHJpbmcpOwoJCT4KCQk+dmFyIHN5bmNYaHIgPSBuZXcgWEhSKHthc3luYzogZmFsc2UsIG1ldGhvZDogJ3Bvc3QnfSk7CgkJPnN5bmNYaHIuc2VuZCh1cmwsIG51bGwpOwoJCT4KCSovCgoJc2VuZDogZnVuY3Rpb24odXJsLCBkYXRhKXsKCQlpZiAodGhpcy5vcHRpb25zLmF1dG9DYW5jZWwpIHRoaXMuY2FuY2VsKCk7CgkJZWxzZSBpZiAodGhpcy5ydW5uaW5nKSByZXR1cm4gdGhpczsKCQl0aGlzLnJ1bm5pbmcgPSB0cnVlOwoJCWlmIChkYXRhICYmIHRoaXMub3B0aW9ucy5tZXRob2QgPT0gJ2dldCcpewoJCQl1cmwgPSB1cmwgKyAodXJsLmNvbnRhaW5zKCc/JykgPyAnJicgOiAnPycpICsgZGF0YTsKCQkJZGF0YSA9IG51bGw7CgkJfQoJCXRoaXMudHJhbnNwb3J0Lm9wZW4odGhpcy5vcHRpb25zLm1ldGhvZC50b1VwcGVyQ2FzZSgpLCB1cmwsIHRoaXMub3B0aW9ucy5hc3luYyk7CgkJdGhpcy50cmFuc3BvcnQub25yZWFkeXN0YXRlY2hhbmdlID0gdGhpcy5vblN0YXRlQ2hhbmdlLmJpbmQodGhpcyk7CgkJaWYgKCh0aGlzLm9wdGlvbnMubWV0aG9kID09ICdwb3N0JykgJiYgdGhpcy50cmFuc3BvcnQub3ZlcnJpZGVNaW1lVHlwZSkgdGhpcy5zZXRIZWFkZXIoJ0Nvbm5lY3Rpb24nLCAnY2xvc2UnKTsKCQkkZXh0ZW5kKHRoaXMuaGVhZGVycywgdGhpcy5vcHRpb25zLmhlYWRlcnMpOwoJCWZvciAodmFyIHR5cGUgaW4gdGhpcy5oZWFkZXJzKSB0cnkge3RoaXMudHJhbnNwb3J0LnNldFJlcXVlc3RIZWFkZXIodHlwZSwgdGhpcy5oZWFkZXJzW3R5cGVdKTt9IGNhdGNoKGUpe307CgkJdGhpcy5maXJlRXZlbnQoJ29uUmVxdWVzdCcpOwoJCXRoaXMudHJhbnNwb3J0LnNlbmQoJHBpY2soZGF0YSwgbnVsbCkpOwoJCXJldHVybiB0aGlzOwoJfSwKCgkvKgoJUHJvcGVydHk6IGNhbmNlbAoJCUNhbmNlbHMgdGhlIHJ1bm5pbmcgcmVxdWVzdC4gTm8gZWZmZWN0IGlmIHRoZSByZXF1ZXN0IGlzIG5vdCBydW5uaW5nLgoKCUV4YW1wbGU6CgkJPnZhciBteVhociA9IG5ldyBYSFIoe21ldGhvZDogJ2dldCd9KS5zZW5kKHVybCk7CgkJPm15WGhyLmNhbmNlbCgpOwoJKi8KCgljYW5jZWw6IGZ1bmN0aW9uKCl7CgkJaWYgKCF0aGlzLnJ1bm5pbmcpIHJldHVybiB0aGlzOwoJCXRoaXMucnVubmluZyA9IGZhbHNlOwoJCXRoaXMudHJhbnNwb3J0LmFib3J0KCk7CgkJdGhpcy50cmFuc3BvcnQub25yZWFkeXN0YXRlY2hhbmdlID0gQ2xhc3MuZW1wdHk7CgkJdGhpcy5zZXRUcmFuc3BvcnQoKTsKCQl0aGlzLmZpcmVFdmVudCgnb25DYW5jZWwnKTsKCQlyZXR1cm4gdGhpczsKCX0KCn0pOwoKWEhSLmltcGxlbWVudChuZXcgQ2hhaW4sIG5ldyBFdmVudHMsIG5ldyBPcHRpb25zKTsKCi8qClNjcmlwdDogQWpheC5qcwoJQ29udGFpbnMgdGhlIDxBamF4PiBjbGFzcy4gQWxzbyBjb250YWlucyBtZXRob2RzIHRvIGdlbmVyYXRlIHF1ZXJ5c3RpbmdzIGZyb20gZm9ybXMgYW5kIE9iamVjdHMuCgpDcmVkaXRzOgoJTG9vc2VseSBiYXNlZCBvbiB0aGUgdmVyc2lvbiBmcm9tIHByb3RvdHlwZS5qcyA8aHR0cDovL3Byb3RvdHlwZS5jb25pby5uZXQ+CgpMaWNlbnNlOgoJTUlULXN0eWxlIGxpY2Vuc2UuCiovCgovKgpDbGFzczogQWpheAoJQW4gQWpheCBjbGFzcywgRm9yIGFsbCB5b3VyIGFzeW5jaHJvbm91cyBuZWVkcy4KCUluaGVyaXRzIG1ldGhvZHMsIHByb3BlcnRpZXMsIG9wdGlvbnMgYW5kIGV2ZW50cyBmcm9tIDxYSFI+LgoKQXJndW1lbnRzOgoJdXJsIC0gdGhlIHVybCBwb2ludGluZyB0byB0aGUgc2VydmVyLXNpZGUgc2NyaXB0LgoJb3B0aW9ucyAtIG9wdGlvbmFsLCBhbiBvYmplY3QgY29udGFpbmluZyBvcHRpb25zLgoKT3B0aW9uczoKCWRhdGEgLSB5b3UgY2FuIHdyaXRlIHBhcmFtZXRlcnMgaGVyZS4gQ2FuIGJlIGEgcXVlcnlzdHJpbmcsIGFuIG9iamVjdCBvciBhIEZvcm0gZWxlbWVudC4KCXVwZGF0ZSAtICQoZWxlbWVudCkgdG8gaW5zZXJ0IHRoZSByZXNwb25zZSB0ZXh0IG9mIHRoZSBYSFIgaW50bywgdXBvbiBjb21wbGV0aW9uIG9mIHRoZSByZXF1ZXN0LgoJZXZhbFNjcmlwdHMgLSBib29sZWFuOyBkZWZhdWx0IGlzIGZhbHNlLiBFeGVjdXRlIHNjcmlwdHMgaW4gdGhlIHJlc3BvbnNlIHRleHQgb25Db21wbGV0ZS4gV2hlbiB0aGUgcmVzcG9uc2UgaXMgamF2YXNjcmlwdCB0aGUgd2hvbGUgcmVzcG9uc2UgaXMgZXZhbHVhdGVkLgoJZXZhbFJlc3BvbnNlIC0gYm9vbGVhbjsgZGVmYXVsdCBpcyBmYWxzZS4gRm9yY2UgZ2xvYmFsIGV2YWx1bGF0aW9uIG9mIHRoZSB3aG9sZSByZXNwb25zZSwgbm8gbWF0dGVyIHdoYXQgY29udGVudC10eXBlIGl0IGlzLgoKRXZlbnRzOgoJb25Db21wbGV0ZSAtIGZ1bmN0aW9uIHRvIGV4ZWN1dGUgd2hlbiB0aGUgYWpheCByZXF1ZXN0IGNvbXBsZXRlcy4KCkV4YW1wbGU6Cgk+dmFyIG15QWpheCA9IG5ldyBBamF4KHVybCwge21ldGhvZDogJ2dldCd9KS5yZXF1ZXN0KCk7CiovCgp2YXIgQWpheCA9IFhIUi5leHRlbmQoewoKCW9wdGlvbnM6IHsKCQlkYXRhOiBudWxsLAoJCXVwZGF0ZTogbnVsbCwKCQlvbkNvbXBsZXRlOiBDbGFzcy5lbXB0eSwKCQlldmFsU2NyaXB0czogZmFsc2UsCgkJZXZhbFJlc3BvbnNlOiBmYWxzZQoJfSwKCglpbml0aWFsaXplOiBmdW5jdGlvbih1cmwsIG9wdGlvbnMpewoJCXRoaXMuYWRkRXZlbnQoJ29uU3VjY2VzcycsIHRoaXMub25Db21wbGV0ZSk7CgkJdGhpcy5zZXRPcHRpb25zKG9wdGlvbnMpOwoJCS8qY29tcGF0aWJpbGl0eSovCgkJdGhpcy5vcHRpb25zLmRhdGEgPSB0aGlzLm9wdGlvbnMuZGF0YSB8fCB0aGlzLm9wdGlvbnMucG9zdEJvZHk7CgkJLyplbmQgY29tcGF0aWJpbGl0eSovCgkJaWYgKCFbJ3Bvc3QnLCAnZ2V0J10uY29udGFpbnModGhpcy5vcHRpb25zLm1ldGhvZCkpewoJCQl0aGlzLl9tZXRob2QgPSAnX21ldGhvZD0nICsgdGhpcy5vcHRpb25zLm1ldGhvZDsKCQkJdGhpcy5vcHRpb25zLm1ldGhvZCA9ICdwb3N0JzsKCQl9CgkJdGhpcy5wYXJlbnQoKTsKCQl0aGlzLnNldEhlYWRlcignWC1SZXF1ZXN0ZWQtV2l0aCcsICdYTUxIdHRwUmVxdWVzdCcpOwoJCXRoaXMuc2V0SGVhZGVyKCdBY2NlcHQnLCAndGV4dC9qYXZhc2NyaXB0LCB0ZXh0L2h0bWwsIGFwcGxpY2F0aW9uL3htbCwgdGV4dC94bWwsICovKicpOwoJCXRoaXMudXJsID0gdXJsOwoJfSwKCglvbkNvbXBsZXRlOiBmdW5jdGlvbigpewoJCWlmICh0aGlzLm9wdGlvbnMudXBkYXRlKSAkKHRoaXMub3B0aW9ucy51cGRhdGUpLmVtcHR5KCkuc2V0SFRNTCh0aGlzLnJlc3BvbnNlLnRleHQpOwoJCWlmICh0aGlzLm9wdGlvbnMuZXZhbFNjcmlwdHMgfHwgdGhpcy5vcHRpb25zLmV2YWxSZXNwb25zZSkgdGhpcy5ldmFsU2NyaXB0cygpOwoJCXRoaXMuZmlyZUV2ZW50KCdvbkNvbXBsZXRlJywgW3RoaXMucmVzcG9uc2UudGV4dCwgdGhpcy5yZXNwb25zZS54bWxdLCAyMCk7Cgl9LAoKCS8qCglQcm9wZXJ0eTogcmVxdWVzdAoJCUV4ZWN1dGVzIHRoZSBhamF4IHJlcXVlc3QuCgoJRXhhbXBsZToKCQk+dmFyIG15QWpheCA9IG5ldyBBamF4KHVybCwge21ldGhvZDogJ2dldCd9KTsKCQk+bXlBamF4LnJlcXVlc3QoKTsKCgkJT1IKCgkJPm5ldyBBamF4KHVybCwge21ldGhvZDogJ2dldCd9KS5yZXF1ZXN0KCk7CgkqLwoKCXJlcXVlc3Q6IGZ1bmN0aW9uKGRhdGEpewoJCWRhdGEgPSBkYXRhIHx8IHRoaXMub3B0aW9ucy5kYXRhOwoJCXN3aXRjaCgkdHlwZShkYXRhKSl7CgkJCWNhc2UgJ2VsZW1lbnQnOiBkYXRhID0gJChkYXRhKS50b1F1ZXJ5U3RyaW5nKCk7IGJyZWFrOwoJCQljYXNlICdvYmplY3QnOiBkYXRhID0gT2JqZWN0LnRvUXVlcnlTdHJpbmcoZGF0YSk7CgkJfQoJCWlmICh0aGlzLl9tZXRob2QpIGRhdGEgPSAoZGF0YSkgPyBbdGhpcy5fbWV0aG9kLCBkYXRhXS5qb2luKCcmJykgOiB0aGlzLl9tZXRob2Q7CgkJcmV0dXJuIHRoaXMuc2VuZCh0aGlzLnVybCwgZGF0YSk7Cgl9LAoKCS8qCglQcm9wZXJ0eTogZXZhbFNjcmlwdHMKCQlFeGVjdXRlcyBzY3JpcHRzIGluIHRoZSByZXNwb25zZSB0ZXh0CgkqLwoKCWV2YWxTY3JpcHRzOiBmdW5jdGlvbigpewoJCXZhciBzY3JpcHQsIHNjcmlwdHM7CgkJaWYgKHRoaXMub3B0aW9ucy5ldmFsUmVzcG9uc2UgfHwgKC8oZWNtYXxqYXZhKXNjcmlwdC8pLnRlc3QodGhpcy5nZXRIZWFkZXIoJ0NvbnRlbnQtdHlwZScpKSkgc2NyaXB0cyA9IHRoaXMucmVzcG9uc2UudGV4dDsKCQllbHNlIHsKCQkJc2NyaXB0cyA9IFtdOwoJCQl2YXIgcmVnZXhwID0gLzxzY3JpcHRbXj5dKj4oW1xzXFNdKj8pPFwvc2NyaXB0Pi9naTsKCQkJd2hpbGUgKChzY3JpcHQgPSByZWdleHAuZXhlYyh0aGlzLnJlc3BvbnNlLnRleHQpKSkgc2NyaXB0cy5wdXNoKHNjcmlwdFsxXSk7CgkJCXNjcmlwdHMgPSBzY3JpcHRzLmpvaW4oJ1xuJyk7CgkJfQoJCWlmIChzY3JpcHRzKSAod2luZG93LmV4ZWNTY3JpcHQpID8gd2luZG93LmV4ZWNTY3JpcHQoc2NyaXB0cykgOiB3aW5kb3cuc2V0VGltZW91dChzY3JpcHRzLCAwKTsKCX0sCgoJLyoKCVByb3BlcnR5OiBnZXRIZWFkZXIKCQlSZXR1cm5zIHRoZSBnaXZlbiByZXNwb25zZSBoZWFkZXIgb3IgbnVsbAoJKi8KCglnZXRIZWFkZXI6IGZ1bmN0aW9uKG5hbWUpewoJCXRyeSB7cmV0dXJuIHRoaXMudHJhbnNwb3J0LmdldFJlc3BvbnNlSGVhZGVyKG5hbWUpO30gY2F0Y2goZSl7fTsKCQlyZXR1cm4gbnVsbDsKCX0KCn0pOwoKLyogU2VjdGlvbjogT2JqZWN0IHJlbGF0ZWQgRnVuY3Rpb25zICovCgovKgpGdW5jdGlvbjogT2JqZWN0LnRvUXVlcnlTdHJpbmcKCUdlbmVyYXRlcyBhIHF1ZXJ5c3RyaW5nIGZyb20ga2V5L3BhaXIgdmFsdWVzIGluIGFuIG9iamVjdAoKQXJndW1lbnRzOgoJc291cmNlIC0gdGhlIG9iamVjdCB0byBnZW5lcmF0ZSB0aGUgcXVlcnlzdHJpbmcgZnJvbS4KClJldHVybnM6Cgl0aGUgcXVlcnkgc3RyaW5nLgoKRXhhbXBsZToKCT5PYmplY3QudG9RdWVyeVN0cmluZyh7YXBwbGU6ICJyZWQiLCBsZW1vbjogInllbGxvdyJ9KTsgLy9yZXR1cm5zICJhcHBsZT1yZWQmbGVtb249eWVsbG93IgoqLwoKT2JqZWN0LnRvUXVlcnlTdHJpbmcgPSBmdW5jdGlvbihzb3VyY2UpewoJdmFyIHF1ZXJ5U3RyaW5nID0gW107Cglmb3IgKHZhciBwcm9wZXJ0eSBpbiBzb3VyY2UpIHF1ZXJ5U3RyaW5nLnB1c2goZW5jb2RlVVJJQ29tcG9uZW50KHByb3BlcnR5KSArICc9JyArIGVuY29kZVVSSUNvbXBvbmVudChzb3VyY2VbcHJvcGVydHldKSk7CglyZXR1cm4gcXVlcnlTdHJpbmcuam9pbignJicpOwp9OwoKLyoKQ2xhc3M6IEVsZW1lbnQKCUN1c3RvbSBjbGFzcyB0byBhbGxvdyBhbGwgb2YgaXRzIG1ldGhvZHMgdG8gYmUgdXNlZCB3aXRoIGFueSBET00gZWxlbWVudCB2aWEgdGhlIGRvbGxhciBmdW5jdGlvbiA8JD4uCiovCgpFbGVtZW50LmV4dGVuZCh7CgoJLyoKCVByb3BlcnR5OiBzZW5kCgkJU2VuZHMgYSBmb3JtIHdpdGggYW4gYWpheCBwb3N0IHJlcXVlc3QKCglBcmd1bWVudHM6CgkJb3B0aW9ucyAtIG9wdGlvbiBjb2xsZWN0aW9uIGZvciBhamF4IHJlcXVlc3QuIFNlZSA8QWpheD4gZm9yIHRoZSBvcHRpb25zIGxpc3QuCgoJUmV0dXJuczoKCQlUaGUgQWpheCBDbGFzcyBJbnN0YW5jZQoKCUV4YW1wbGU6CgkJKHN0YXJ0IGNvZGUpCgkJPGZvcm0gaWQ9Im15Rm9ybSIgYWN0aW9uPSJzdWJtaXQucGhwIj4KCQk8aW5wdXQgbmFtZT0iZW1haWwiIHZhbHVlPSJib2JAYm9iLmNvbSI+CgkJPGlucHV0IG5hbWU9InppcENvZGUiIHZhbHVlPSI5MDIxMCI+CgkJPC9mb3JtPgoJCTxzY3JpcHQ+CgkJJCgnbXlGb3JtJykuc2VuZCgpCgkJPC9zY3JpcHQ+CgkJKGVuZCkKCSovCgoJc2VuZDogZnVuY3Rpb24ob3B0aW9ucyl7CgkJcmV0dXJuIG5ldyBBamF4KHRoaXMuZ2V0UHJvcGVydHkoJ2FjdGlvbicpLCAkbWVyZ2Uoe2RhdGE6IHRoaXMudG9RdWVyeVN0cmluZygpfSwgb3B0aW9ucywge21ldGhvZDogJ3Bvc3QnfSkpLnJlcXVlc3QoKTsKCX0KCn0pOwoKLyoKU2NyaXB0OiBDb29raWUuanMKCUEgY29va2llIHJlYWRlci9jcmVhdG9yCgpDcmVkaXRzOgoJYmFzZWQgb24gdGhlIGZ1bmN0aW9ucyBieSBQZXRlci1QYXVsIEtvY2ggKGh0dHA6Ly9xdWlya3Ntb2RlLm9yZykKKi8KCi8qCkNsYXNzOiBDb29raWUKCUNsYXNzIGZvciBjcmVhdGluZywgZ2V0dGluZywgYW5kIHJlbW92aW5nIGNvb2tpZXMuCiovCgp2YXIgQ29va2llID0gbmV3IEFic3RyYWN0KHsKCglvcHRpb25zOiB7CgkJZG9tYWluOiBmYWxzZSwKCQlwYXRoOiBmYWxzZSwKCQlkdXJhdGlvbjogZmFsc2UsCgkJc2VjdXJlOiBmYWxzZQoJfSwKCgkvKgoJUHJvcGVydHk6IHNldAoJCVNldHMgYSBjb29raWUgaW4gdGhlIGJyb3dzZXIuCgoJQXJndW1lbnRzOgoJCWtleSAtIHRoZSBrZXkgKG5hbWUpIGZvciB0aGUgY29va2llCgkJdmFsdWUgLSB0aGUgdmFsdWUgdG8gc2V0LCBjYW5ub3QgY29udGFpbiBzZW1pY29sb25zCgkJb3B0aW9ucyAtIGFuIG9iamVjdCByZXByZXNlbnRpbmcgdGhlIENvb2tpZSBvcHRpb25zLiBTZWUgT3B0aW9ucyBiZWxvdy4gRGVmYXVsdCB2YWx1ZXMgYXJlIHN0b3JlZCBpbiBDb29raWUub3B0aW9ucy4KCglPcHRpb25zOgoJCWRvbWFpbiAtIHRoZSBkb21haW4gdGhlIENvb2tpZSBiZWxvbmdzIHRvLiBJZiB5b3Ugd2FudCB0byBzaGFyZSB0aGUgY29va2llIHdpdGggcGFnZXMgbG9jYXRlZCBvbiBhIGRpZmZlcmVudCBkb21haW4sIHlvdSBoYXZlIHRvIHNldCB0aGlzIHZhbHVlLiBEZWZhdWx0cyB0byB0aGUgY3VycmVudCBkb21haW4uCgkJcGF0aCAtIHRoZSBwYXRoIHRoZSBDb29raWUgYmVsb25ncyB0by4gSWYgeW91IHdhbnQgdG8gc2hhcmUgdGhlIGNvb2tpZSB3aXRoIHBhZ2VzIGxvY2F0ZWQgaW4gYSBkaWZmZXJlbnQgcGF0aCwgeW91IGhhdmUgdG8gc2V0IHRoaXMgdmFsdWUsIGZvciBleGFtcGxlIHRvICIvIiB0byBzaGFyZSB0aGUgY29va2llIHdpdGggYWxsIHBhZ2VzIG9uIHRoZSBkb21haW4uIERlZmF1bHRzIHRvIHRoZSBjdXJyZW50IHBhdGguCgkJZHVyYXRpb24gLSB0aGUgZHVyYXRpb24gb2YgdGhlIENvb2tpZSBiZWZvcmUgaXQgZXhwaXJlcywgaW4gZGF5cy4KCQkJCQlJZiBzZXQgdG8gZmFsc2Ugb3IgMCwgdGhlIGNvb2tpZSB3aWxsIGJlIGEgc2Vzc2lvbiBjb29raWUgdGhhdCBleHBpcmVzIHdoZW4gdGhlIGJyb3dzZXIgaXMgY2xvc2VkLiBUaGlzIGlzIGRlZmF1bHQuCgkJc2VjdXJlIC0gU3RvcmVkIGNvb2tpZSBpbmZvcm1hdGlvbiBjYW4gYmUgYWNjZXNzZWQgb25seSBmcm9tIGEgc2VjdXJlIGVudmlyb25tZW50LgoKCVJldHVybnM6CgkJQW4gb2JqZWN0IHdpdGggdGhlIG9wdGlvbnMsIHRoZSBrZXkgYW5kIHRoZSB2YWx1ZS4gWW91IGNhbiBnaXZlIGl0IGFzIGZpcnN0IHBhcmFtZXRlciB0byBDb29raWUucmVtb3ZlLgoKCUV4YW1wbGU6CgkJPkNvb2tpZS5zZXQoJ3VzZXJuYW1lJywgJ0hhcmFsZCcpOyAvLyBzZXNzaW9uIGNvb2tpZSAoZHVyYXRpb24gaXMgZmFsc2UpLCBvciAuLi4KCQk+Q29va2llLnNldCgndXNlcm5hbWUnLCAnSmFja0JhdWVyJywge2R1cmF0aW9uOiAxfSk7IC8vIHNhdmUgdGhpcyBmb3IgMSBkYXkKCgkqLwoKCXNldDogZnVuY3Rpb24oa2V5LCB2YWx1ZSwgb3B0aW9ucyl7CgkJb3B0aW9ucyA9ICRtZXJnZSh0aGlzLm9wdGlvbnMsIG9wdGlvbnMpOwoJCXZhbHVlID0gZW5jb2RlVVJJQ29tcG9uZW50KHZhbHVlKTsKCQlpZiAob3B0aW9ucy5kb21haW4pIHZhbHVlICs9ICc7IGRvbWFpbj0nICsgb3B0aW9ucy5kb21haW47CgkJaWYgKG9wdGlvbnMucGF0aCkgdmFsdWUgKz0gJzsgcGF0aD0nICsgb3B0aW9ucy5wYXRoOwoJCWlmIChvcHRpb25zLmR1cmF0aW9uKXsKCQkJdmFyIGRhdGUgPSBuZXcgRGF0ZSgpOwoJCQlkYXRlLnNldFRpbWUoZGF0ZS5nZXRUaW1lKCkgKyBvcHRpb25zLmR1cmF0aW9uICogMjQgKiA2MCAqIDYwICogMTAwMCk7CgkJCXZhbHVlICs9ICc7IGV4cGlyZXM9JyArIGRhdGUudG9HTVRTdHJpbmcoKTsKCQl9CgkJaWYgKG9wdGlvbnMuc2VjdXJlKSB2YWx1ZSArPSAnOyBzZWN1cmUnOwoJCWRvY3VtZW50LmNvb2tpZSA9IGtleSArICc9JyArIHZhbHVlOwoJCXJldHVybiAkZXh0ZW5kKG9wdGlvbnMsIHsna2V5Jzoga2V5LCAndmFsdWUnOiB2YWx1ZX0pOwoJfSwKCgkvKgoJUHJvcGVydHk6IGdldAoJCUdldHMgdGhlIHZhbHVlIG9mIGEgY29va2llLgoKCUFyZ3VtZW50czoKCQlrZXkgLSB0aGUgbmFtZSBvZiB0aGUgY29va2llIHlvdSB3aXNoIHRvIHJldHJpZXZlLgoKCVJldHVybnM6CgkJVGhlIGNvb2tpZSBzdHJpbmcgdmFsdWUsIG9yIGZhbHNlIGlmIG5vdCBmb3VuZC4KCglFeGFtcGxlOgoJCT5Db29raWUuZ2V0KCJ1c2VybmFtZSIpIC8vcmV0dXJucyBKYWNrQmF1ZXIKCSovCgoJZ2V0OiBmdW5jdGlvbihrZXkpewoJCXZhciB2YWx1ZSA9IGRvY3VtZW50LmNvb2tpZS5tYXRjaCgnKD86Xnw7KVxccyonICsga2V5LmVzY2FwZVJlZ0V4cCgpICsgJz0oW147XSopJyk7CgkJcmV0dXJuIHZhbHVlID8gZGVjb2RlVVJJQ29tcG9uZW50KHZhbHVlWzFdKSA6IGZhbHNlOwoJfSwKCgkvKgoJUHJvcGVydHk6IHJlbW92ZQoJCVJlbW92ZXMgYSBjb29raWUgZnJvbSB0aGUgYnJvd3Nlci4KCglBcmd1bWVudHM6CgkJY29va2llIC0gdGhlIG5hbWUgb2YgdGhlIGNvb2tpZSB0byByZW1vdmUgb3IgYSBwcmV2aW91cyBjb29raWUgKGZvciBkb21haW5zKQoJCW9wdGlvbnMgLSBvcHRpb25hbC4geW91IGNhbiBhbHNvIHBhc3MgdGhlIGRvbWFpbiBhbmQgcGF0aCBoZXJlLiBTYW1lIGFzIG9wdGlvbnMgaW4gPENvb2tpZS5zZXQ+CgoJRXhhbXBsZXM6CgkJPkNvb2tpZS5yZW1vdmUoJ3VzZXJuYW1lJykgLy9ieWUtYnllIEphY2tCYXVlciwgY3lhIGluIDI0IGhvdXJzCgkJPgoJCT52YXIgbXlDb29raWUgPSBDb29raWUuc2V0KCd1c2VybmFtZScsICdBYXJvbicsIHtkb21haW46ICdtb290b29scy5uZXQnfSk7IC8vIENvb2tpZS5zZXQgcmV0dXJucyBhbiBvYmplY3Qgd2l0aCBhbGwgdmFsdWVzIG5lZWQgdG8gcmVtb3ZlIHRoZSBjb29raWUKCQk+Q29va2llLnJlbW92ZShteUNvb2tpZSk7CgkqLwoKCXJlbW92ZTogZnVuY3Rpb24oY29va2llLCBvcHRpb25zKXsKCQlpZiAoJHR5cGUoY29va2llKSA9PSAnb2JqZWN0JykgdGhpcy5zZXQoY29va2llLmtleSwgJycsICRtZXJnZShjb29raWUsIHtkdXJhdGlvbjogLTF9KSk7CgkJZWxzZSB0aGlzLnNldChjb29raWUsICcnLCAkbWVyZ2Uob3B0aW9ucywge2R1cmF0aW9uOiAtMX0pKTsKCX0KCn0pOwoKLyoKU2NyaXB0OiBKc29uLmpzCglTaW1wbGUgSnNvbiBwYXJzZXIgYW5kIFN0cmluZ3lmaWVyLCBTZWU6IDxodHRwOi8vd3d3Lmpzb24ub3JnLz4KCkxpY2Vuc2U6CglNSVQtc3R5bGUgbGljZW5zZS4KKi8KCi8qCkNsYXNzOiBKc29uCglTaW1wbGUgSnNvbiBwYXJzZXIgYW5kIFN0cmluZ3lmaWVyLCBTZWU6IDxodHRwOi8vd3d3Lmpzb24ub3JnLz4KKi8KCnZhciBKc29uID0gewoKCS8qCglQcm9wZXJ0eTogdG9TdHJpbmcKCQlDb252ZXJ0cyBhbiBvYmplY3QgdG8gYSBzdHJpbmcsIHRvIGJlIHBhc3NlZCBpbiBzZXJ2ZXItc2lkZSBzY3JpcHRzIGFzIGEgcGFyYW1ldGVyLiBBbHRob3VnaCBpdHMgbm90IG5vcm1hbCB1c2FnZSBmb3IgdGhpcyBjbGFzcywgdGhpcyBtZXRob2QgY2FuIGFsc28gYmUgdXNlZCB0byBjb252ZXJ0IGZ1bmN0aW9ucyBhbmQgYXJyYXlzIHRvIHN0cmluZ3MuCgoJQXJndW1lbnRzOgoJCW9iaiAtIHRoZSBvYmplY3QgdG8gY29udmVydCB0byBzdHJpbmcKCglSZXR1cm5zOgoJCUEganNvbiBzdHJpbmcKCglFeGFtcGxlOgoJCShzdGFydCBjb2RlKQoJCUpzb24udG9TdHJpbmcoe2FwcGxlOiAncmVkJywgbGVtb246ICd5ZWxsb3cnfSk7ICd7ImFwcGxlIjoicmVkIiwibGVtb24iOiJ5ZWxsb3cifScKCQkoZW5kKQoJKi8KCgl0b1N0cmluZzogZnVuY3Rpb24ob2JqKXsKCQlzd2l0Y2goJHR5cGUob2JqKSl7CgkJCWNhc2UgJ3N0cmluZyc6CgkJCQlyZXR1cm4gJyInICsgb2JqLnJlcGxhY2UoLyhbIlxcXSkvZywgJ1xcJDEnKSArICciJzsKCQkJY2FzZSAnYXJyYXknOgoJCQkJcmV0dXJuICdbJyArIG9iai5tYXAoSnNvbi50b1N0cmluZykuam9pbignLCcpICsgJ10nOwoJCQljYXNlICdvYmplY3QnOgoJCQkJdmFyIHN0cmluZyA9IFtdOwoJCQkJZm9yICh2YXIgcHJvcGVydHkgaW4gb2JqKSBzdHJpbmcucHVzaChKc29uLnRvU3RyaW5nKHByb3BlcnR5KSArICc6JyArIEpzb24udG9TdHJpbmcob2JqW3Byb3BlcnR5XSkpOwoJCQkJcmV0dXJuICd7JyArIHN0cmluZy5qb2luKCcsJykgKyAnfSc7CgkJCWNhc2UgJ251bWJlcic6CgkJCQlpZiAoaXNGaW5pdGUob2JqKSkgYnJlYWs7CgkJCWNhc2UgZmFsc2U6CgkJCQlyZXR1cm4gJ251bGwnOwoJCX0KCQlyZXR1cm4gU3RyaW5nKG9iaik7Cgl9LAoKCS8qCglQcm9wZXJ0eTogZXZhbHVhdGUKCQljb252ZXJ0cyBhIGpzb24gc3RyaW5nIHRvIGFuIGphdmFzY3JpcHQgT2JqZWN0LgoKCUFyZ3VtZW50czoKCQlzdHIgLSB0aGUgc3RyaW5nIHRvIGV2YWx1YXRlLiBpZiBpdHMgbm90IGEgc3RyaW5nLCBpdCByZXR1cm5zIGZhbHNlLgoJCXNlY3VyZSAtIG9wdGlvbmFsbHksIHBlcmZvcm1zIHN5bnRheCBjaGVjayBvbiBqc29uIHN0cmluZy4gRGVmYXVsdHMgdG8gZmFsc2UuCgoJQ3JlZGl0czoKCQlKc29uIHRlc3QgcmVnZXhwIGlzIGJ5IERvdWdsYXMgQ3JvY2tmb3JkIDxodHRwOi8vY3JvY2tmb3JkLm9yZz4uCgoJRXhhbXBsZToKCQk+dmFyIG15T2JqZWN0ID0gSnNvbi5ldmFsdWF0ZSgneyJhcHBsZSI6InJlZCIsImxlbW9uIjoieWVsbG93In0nKTsKCQk+Ly9teU9iamVjdCB3aWxsIGJlY29tZSB7YXBwbGU6ICdyZWQnLCBsZW1vbjogJ3llbGxvdyd9CgkqLwoKCWV2YWx1YXRlOiBmdW5jdGlvbihzdHIsIHNlY3VyZSl7CgkJcmV0dXJuICgoJHR5cGUoc3RyKSAhPSAnc3RyaW5nJykgfHwgKHNlY3VyZSAmJiAhc3RyLnRlc3QoL14oIihcXC58W14iXFxcblxyXSkqPyJ8Wyw6e31cW1xdMC05LlwtK0VhZWZsbnItdSBcblxyXHRdKSs/JC8pKSkgPyBudWxsIDogZXZhbCgnKCcgKyBzdHIgKyAnKScpOwoJfQoKfTsKCi8qClNjcmlwdDogSnNvbi5SZW1vdGUuanMKCUNvbnRhaW5zIDxKc29uLlJlbW90ZT4uCgpMaWNlbnNlOgoJTUlULXN0eWxlIGxpY2Vuc2UuCiovCgovKgpDbGFzczogSnNvbi5SZW1vdGUKCVdyYXBwZWQgWEhSIHdpdGggYXV0b21hdGVkIHNlbmRpbmcgYW5kIHJlY2VpdmluZyBvZiBKYXZhc2NyaXB0IE9iamVjdHMgaW4gSnNvbiBGb3JtYXQuCglJbmhlcml0cyBtZXRob2RzLCBwcm9wZXJ0aWVzLCBvcHRpb25zIGFuZCBldmVudHMgZnJvbSA8WEhSPi4KCkFyZ3VtZW50czoKCXVybCAtIHRoZSB1cmwgeW91IHdhbnQgdG8gc2VuZCB5b3VyIG9iamVjdCB0by4KCW9wdGlvbnMgLSBzZWUgPFhIUj4gb3B0aW9ucwoKRXhhbXBsZToKCXRoaXMgY29kZSB3aWxsIHNlbmQgdXNlciBpbmZvcm1hdGlvbiBiYXNlZCBvbiBuYW1lL2xhc3QgbmFtZQoJKHN0YXJ0IGNvZGUpCgl2YXIgalNvblJlcXVlc3QgPSBuZXcgSnNvbi5SZW1vdGUoImh0dHA6Ly9zaXRlLmNvbS90ZWxsTWVBZ2UucGhwIiwge29uQ29tcGxldGU6IGZ1bmN0aW9uKHBlcnNvbil7CgkJYWxlcnQocGVyc29uLmFnZSk7IC8vaXMgMjUgeWVhcnMKCQlhbGVydChwZXJzb24uaGVpZ2h0KTsgLy9pcyAxNzAgY20KCQlhbGVydChwZXJzb24ud2VpZ2h0KTsgLy9pcyAxMjAga2cKCX19KS5zZW5kKHsnbmFtZSc6ICdKb2huJywgJ2xhc3ROYW1lJzogJ0RvZSd9KTsKCShlbmQpCiovCgpKc29uLlJlbW90ZSA9IFhIUi5leHRlbmQoewoKCWluaXRpYWxpemU6IGZ1bmN0aW9uKHVybCwgb3B0aW9ucyl7CgkJdGhpcy51cmwgPSB1cmw7CgkJdGhpcy5hZGRFdmVudCgnb25TdWNjZXNzJywgdGhpcy5vbkNvbXBsZXRlKTsKCQl0aGlzLnBhcmVudChvcHRpb25zKTsKCQl0aGlzLnNldEhlYWRlcignWC1SZXF1ZXN0JywgJ0pTT04nKTsKCX0sCgoJc2VuZDogZnVuY3Rpb24ob2JqKXsKCQlyZXR1cm4gdGhpcy5wYXJlbnQodGhpcy51cmwsICdqc29uPScgKyBKc29uLnRvU3RyaW5nKG9iaikpOwoJfSwKCglvbkNvbXBsZXRlOiBmdW5jdGlvbigpewoJCXRoaXMuZmlyZUV2ZW50KCdvbkNvbXBsZXRlJywgW0pzb24uZXZhbHVhdGUodGhpcy5yZXNwb25zZS50ZXh0LCB0aGlzLm9wdGlvbnMuc2VjdXJlKV0pOwoJfQoKfSk7CgovKgpTY3JpcHQ6IEFzc2V0cy5qcwoJcHJvdmlkZXMgZHluYW1pYyBsb2FkaW5nIGZvciBpbWFnZXMsIGNzcyBhbmQgamF2YXNjcmlwdCBmaWxlcy4KCkxpY2Vuc2U6CglNSVQtc3R5bGUgbGljZW5zZS4KKi8KCnZhciBBc3NldCA9IG5ldyBBYnN0cmFjdCh7CgoJLyoKCVByb3BlcnR5OiBqYXZhc2NyaXB0CgkJSW5qZWN0cyBhIGphdmFzY3JpcHQgZmlsZSBpbiB0aGUgcGFnZS4KCglBcmd1bWVudHM6CgkJc291cmNlIC0gdGhlIHBhdGggb2YgdGhlIGphdmFzY3JpcHQgZmlsZQoJCXByb3BlcnRpZXMgLSBzb21lIGFkZGl0aW9uYWwgYXR0cmlidXRlcyB5b3UgbWlnaHQgd2FudCB0byBhZGQgdG8gdGhlIHNjcmlwdCBlbGVtZW50CgoJRXhhbXBsZToKCQk+IG5ldyBBc3NldC5qYXZhc2NyaXB0KCcvc2NyaXB0cy9teVNjcmlwdC5qcycsIHtpZDogJ215U2NyaXB0J30pOwoJKi8KCglqYXZhc2NyaXB0OiBmdW5jdGlvbihzb3VyY2UsIHByb3BlcnRpZXMpewoJCXByb3BlcnRpZXMgPSAkbWVyZ2UoewoJCQknb25sb2FkJzogQ2xhc3MuZW1wdHkKCQl9LCBwcm9wZXJ0aWVzKTsKCQl2YXIgc2NyaXB0ID0gbmV3IEVsZW1lbnQoJ3NjcmlwdCcsIHsnc3JjJzogc291cmNlfSkuYWRkRXZlbnRzKHsKCQkJJ2xvYWQnOiBwcm9wZXJ0aWVzLm9ubG9hZCwKCQkJJ3JlYWR5c3RhdGVjaGFuZ2UnOiBmdW5jdGlvbigpewoJCQkJaWYgKHRoaXMucmVhZHlTdGF0ZSA9PSAnY29tcGxldGUnKSB0aGlzLmZpcmVFdmVudCgnbG9hZCcpOwoJCQl9CgkJfSk7CgkJZGVsZXRlIHByb3BlcnRpZXMub25sb2FkOwoJCXJldHVybiBzY3JpcHQuc2V0UHJvcGVydGllcyhwcm9wZXJ0aWVzKS5pbmplY3QoZG9jdW1lbnQuaGVhZCk7Cgl9LAoKCS8qCglQcm9wZXJ0eTogY3NzCgkJSW5qZWN0cyBhIGNzcyBmaWxlIGluIHRoZSBwYWdlLgoKCUFyZ3VtZW50czoKCQlzb3VyY2UgLSB0aGUgcGF0aCBvZiB0aGUgY3NzIGZpbGUKCQlwcm9wZXJ0aWVzIC0gc29tZSBhZGRpdGlvbmFsIGF0dHJpYnV0ZXMgeW91IG1pZ2h0IHdhbnQgdG8gYWRkIHRvIHRoZSBsaW5rIGVsZW1lbnQKCglFeGFtcGxlOgoJCT4gbmV3IEFzc2V0LmNzcygnL2Nzcy9teVN0eWxlLmNzcycsIHtpZDogJ215U3R5bGUnLCB0aXRsZTogJ215U3R5bGUnfSk7CgkqLwoKCWNzczogZnVuY3Rpb24oc291cmNlLCBwcm9wZXJ0aWVzKXsKCQlyZXR1cm4gbmV3IEVsZW1lbnQoJ2xpbmsnLCAkbWVyZ2UoewoJCQkncmVsJzogJ3N0eWxlc2hlZXQnLCAnbWVkaWEnOiAnc2NyZWVuJywgJ3R5cGUnOiAndGV4dC9jc3MnLCAnaHJlZic6IHNvdXJjZQoJCX0sIHByb3BlcnRpZXMpKS5pbmplY3QoZG9jdW1lbnQuaGVhZCk7Cgl9LAoKCS8qCglQcm9wZXJ0eTogaW1hZ2UKCQlQcmVsb2FkcyBhbiBpbWFnZSBhbmQgcmV0dXJucyB0aGUgaW1nIGVsZW1lbnQuIGRvZXMgbm90IGluamVjdCBpdCB0byB0aGUgcGFnZS4KCglBcmd1bWVudHM6CgkJc291cmNlIC0gdGhlIHBhdGggb2YgdGhlIGltYWdlIGZpbGUKCQlwcm9wZXJ0aWVzIC0gc29tZSBhZGRpdGlvbmFsIGF0dHJpYnV0ZXMgeW91IG1pZ2h0IHdhbnQgdG8gYWRkIHRvIHRoZSBpbWcgZWxlbWVudAoKCUV4YW1wbGU6CgkJPiBuZXcgQXNzZXQuaW1hZ2UoJy9pbWFnZXMvbXlJbWFnZS5wbmcnLCB7aWQ6ICdteUltYWdlJywgdGl0bGU6ICdteUltYWdlJywgb25sb2FkOiBteUZ1bmN0aW9ufSk7CgoJUmV0dXJuczoKCQl0aGUgaW1nIGVsZW1lbnQuIHlvdSBjYW4gaW5qZWN0IGl0IGFueXdoZXJlIHlvdSB3YW50IHdpdGggPEVsZW1lbnQuaW5qZWN0SW5zaWRlPi88RWxlbWVudC5pbmplY3RBZnRlcj4vPEVsZW1lbnQuaW5qZWN0QmVmb3JlPgoJKi8KCglpbWFnZTogZnVuY3Rpb24oc291cmNlLCBwcm9wZXJ0aWVzKXsKCQlwcm9wZXJ0aWVzID0gJG1lcmdlKHsKCQkJJ29ubG9hZCc6IENsYXNzLmVtcHR5LAoJCQknb25hYm9ydCc6IENsYXNzLmVtcHR5LAoJCQknb25lcnJvcic6IENsYXNzLmVtcHR5CgkJfSwgcHJvcGVydGllcyk7CgkJdmFyIGltYWdlID0gbmV3IEltYWdlKCk7CgkJaW1hZ2Uuc3JjID0gc291cmNlOwoJCXZhciBlbGVtZW50ID0gbmV3IEVsZW1lbnQoJ2ltZycsIHsnc3JjJzogc291cmNlfSk7CgkJWydsb2FkJywgJ2Fib3J0JywgJ2Vycm9yJ10uZWFjaChmdW5jdGlvbih0eXBlKXsKCQkJdmFyIGV2ZW50ID0gcHJvcGVydGllc1snb24nICsgdHlwZV07CgkJCWRlbGV0ZSBwcm9wZXJ0aWVzWydvbicgKyB0eXBlXTsKCQkJZWxlbWVudC5hZGRFdmVudCh0eXBlLCBmdW5jdGlvbigpewoJCQkJdGhpcy5yZW1vdmVFdmVudCh0eXBlLCBhcmd1bWVudHMuY2FsbGVlKTsKCQkJCWV2ZW50LmNhbGwodGhpcyk7CgkJCX0pOwoJCX0pOwoJCWlmIChpbWFnZS53aWR0aCAmJiBpbWFnZS5oZWlnaHQpIGVsZW1lbnQuZmlyZUV2ZW50KCdsb2FkJywgZWxlbWVudCwgMSk7CgkJcmV0dXJuIGVsZW1lbnQuc2V0UHJvcGVydGllcyhwcm9wZXJ0aWVzKTsKCX0sCgoJLyoKCVByb3BlcnR5OiBpbWFnZXMKCQlQcmVsb2FkcyBhbiBhcnJheSBvZiBpbWFnZXMgKGFzIHN0cmluZ3MpIGFuZCByZXR1cm5zIGFuIGFycmF5IG9mIGltZyBlbGVtZW50cy4gZG9lcyBub3QgaW5qZWN0IHRoZW0gdG8gdGhlIHBhZ2UuCgoJQXJndW1lbnRzOgoJCXNvdXJjZXMgLSBhcnJheSwgdGhlIHBhdGhzIG9mIHRoZSBpbWFnZSBmaWxlcwoJCW9wdGlvbnMgLSBvYmplY3QsIHNlZSBiZWxvdwoKCU9wdGlvbnM6CgkJb25Db21wbGV0ZSAtIGEgZnVuY3Rpb24gdG8gZXhlY3V0ZSB3aGVuIGFsbCBpbWFnZSBmaWxlcyBhcmUgbG9hZGVkIGluIHRoZSBicm93c2VyJ3MgY2FjaGUKCQlvblByb2dyZXNzIC0gYSBmdW5jdGlvbiB0byBleGVjdXRlIHdoZW4gb25lIGltYWdlIGZpbGUgaXMgbG9hZGVkIGluIHRoZSBicm93c2VyJ3MgY2FjaGUKCglFeGFtcGxlOgoJCShzdGFydCBjb2RlKQoJCW5ldyBBc3NldC5pbWFnZXMoWycvaW1hZ2VzL215SW1hZ2UucG5nJywgJy9pbWFnZXMvbXlJbWFnZTIuZ2lmJ10sIHsKCQkJb25Db21wbGV0ZTogZnVuY3Rpb24oKXsKCQkJCWFsZXJ0KCdhbGwgaW1hZ2VzIGxvYWRlZCEnKTsKCQkJfQoJCX0pOwoJCShlbmQpCgoJUmV0dXJuczoKCQl0aGUgaW1nIGVsZW1lbnRzIGFzICQkLiB5b3UgY2FuIGluamVjdCB0aGVtIGFueXdoZXJlIHlvdSB3YW50IHdpdGggPEVsZW1lbnQuaW5qZWN0SW5zaWRlPi88RWxlbWVudC5pbmplY3RBZnRlcj4vPEVsZW1lbnQuaW5qZWN0QmVmb3JlPgoJKi8KCglpbWFnZXM6IGZ1bmN0aW9uKHNvdXJjZXMsIG9wdGlvbnMpewoJCW9wdGlvbnMgPSAkbWVyZ2UoewoJCQlvbkNvbXBsZXRlOiBDbGFzcy5lbXB0eSwKCQkJb25Qcm9ncmVzczogQ2xhc3MuZW1wdHkKCQl9LCBvcHRpb25zKTsKCQlpZiAoIXNvdXJjZXMucHVzaCkgc291cmNlcyA9IFtzb3VyY2VzXTsKCQl2YXIgaW1hZ2VzID0gW107CgkJdmFyIGNvdW50ZXIgPSAwOwoJCXNvdXJjZXMuZWFjaChmdW5jdGlvbihzb3VyY2UpewoJCQl2YXIgaW1nID0gbmV3IEFzc2V0LmltYWdlKHNvdXJjZSwgewoJCQkJJ29ubG9hZCc6IGZ1bmN0aW9uKCl7CgkJCQkJb3B0aW9ucy5vblByb2dyZXNzLmNhbGwodGhpcywgY291bnRlcik7CgkJCQkJY291bnRlcisrOwoJCQkJCWlmIChjb3VudGVyID09IHNvdXJjZXMubGVuZ3RoKSBvcHRpb25zLm9uQ29tcGxldGUoKTsKCQkJCX0KCQkJfSk7CgkJCWltYWdlcy5wdXNoKGltZyk7CgkJfSk7CgkJcmV0dXJuIG5ldyBFbGVtZW50cyhpbWFnZXMpOwoJfQoKfSk7CgovKgpTY3JpcHQ6IEhhc2guanMKCUNvbnRhaW5zIHRoZSBjbGFzcyBIYXNoLgoKTGljZW5zZToKCU1JVC1zdHlsZSBsaWNlbnNlLgoqLwoKLyoKQ2xhc3M6IEhhc2gKCUl0IHdyYXBzIGFuIG9iamVjdCB0aGF0IGl0IHVzZXMgaW50ZXJuYWxseSBhcyBhIG1hcC4gVGhlIHVzZXIgbXVzdCB1c2Ugc2V0KCksIGdldCgpLCBhbmQgcmVtb3ZlKCkgdG8gYWRkL2NoYW5nZSwgcmV0cmlldmUgYW5kIHJlbW92ZSB2YWx1ZXMsIGl0IG11c3Qgbm90IGFjY2VzcyB0aGUgaW50ZXJuYWwgb2JqZWN0IGRpcmVjdGx5LiBudWxsL3VuZGVmaW5lZCB2YWx1ZXMgYXJlIGFsbG93ZWQuCgpOb3RlOgoJRWFjaCBoYXNoIGluc3RhbmNlIGhhcyB0aGUgbGVuZ3RoIHByb3BlcnR5LgoKQXJndW1lbnRzOgoJb2JqIC0gYW4gb2JqZWN0IHRvIGNvbnZlcnQgaW50byBhIEhhc2ggaW5zdGFuY2UuCgpFeGFtcGxlOgoJKHN0YXJ0IGNvZGUpCgl2YXIgaGFzaCA9IG5ldyBIYXNoKHthOiAnaGknLCBiOiAnd29ybGQnLCBjOiAnaG93ZHknfSk7CgloYXNoLnJlbW92ZSgnYicpOyAvLyBiIGlzIHJlbW92ZWQuCgloYXNoLnNldCgnYycsICdoZWxsbycpOwoJaGFzaC5nZXQoJ2MnKTsgLy8gcmV0dXJucyAnaGVsbG8nCgloYXNoLmxlbmd0aCAvLyByZXR1cm5zIDIgKGEgYW5kIGMpCgkoZW5kKQoqLwoKdmFyIEhhc2ggPSBuZXcgQ2xhc3MoewoKCWxlbmd0aDogMCwKCglpbml0aWFsaXplOiBmdW5jdGlvbihvYmplY3QpewoJCXRoaXMub2JqID0gb2JqZWN0IHx8IHt9OwoJCXRoaXMuc2V0TGVuZ3RoKCk7Cgl9LAoKCS8qCglQcm9wZXJ0eTogZ2V0CgkJUmV0cmlldmVzIGEgdmFsdWUgZnJvbSB0aGUgaGFzaC4KCglBcmd1bWVudHM6CgkJa2V5IC0gVGhlIGtleQoKCVJldHVybnM6CgkJVGhlIHZhbHVlCgkqLwoKCWdldDogZnVuY3Rpb24oa2V5KXsKCQlyZXR1cm4gKHRoaXMuaGFzS2V5KGtleSkpID8gdGhpcy5vYmpba2V5XSA6IG51bGw7Cgl9LAoKCS8qCglQcm9wZXJ0eTogaGFzS2V5CgkJQ2hlY2sgdGhlIHByZXNlbmNlIG9mIGEgc3BlY2lmaWVkIGtleS12YWx1ZSBwYWlyIGluIHRoZSBoYXNoLgoKCUFyZ3VtZW50czoKCQlrZXkgLSBUaGUga2V5CgoJUmV0dXJuczoKCQlUcnVlIGlmIHRoZSBIYXNoIGNvbnRhaW5zIGEgdmFsdWUgZm9yIHRoZSBzcGVjaWZpZWQga2V5LCBvdGhlcndpc2UgZmFsc2UKCSovCgoJaGFzS2V5OiBmdW5jdGlvbihrZXkpewoJCXJldHVybiAoa2V5IGluIHRoaXMub2JqKTsKCX0sCgoJLyoKCVByb3BlcnR5OiBzZXQKCQlBZGRzIGEga2V5LXZhbHVlIHBhaXIgdG8gdGhlIGhhc2ggb3IgcmVwbGFjZXMgYSBwcmV2aW91cyB2YWx1ZSBhc3NvY2lhdGVkIHdpdGggdGhlIGtleS4KCglBcmd1bWVudHM6CgkJa2V5IC0gVGhlIGtleQoJCXZhbHVlIC0gVGhlIHZhbHVlCgkqLwoKCXNldDogZnVuY3Rpb24oa2V5LCB2YWx1ZSl7CgkJaWYgKCF0aGlzLmhhc0tleShrZXkpKSB0aGlzLmxlbmd0aCsrOwoJCXRoaXMub2JqW2tleV0gPSB2YWx1ZTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJc2V0TGVuZ3RoOiBmdW5jdGlvbigpewoJCXRoaXMubGVuZ3RoID0gMDsKCQlmb3IgKHZhciBwIGluIHRoaXMub2JqKSB0aGlzLmxlbmd0aCsrOwoJCXJldHVybiB0aGlzOwoJfSwKCgkvKgoJUHJvcGVydHk6IHJlbW92ZQoJCVJlbW92ZXMgYSBrZXktdmFsdWUgcGFpciBmcm9tIHRoZSBoYXNoLgoKCUFyZ3VtZW50czoKCQlrZXkgLSBUaGUga2V5CgkqLwoKCXJlbW92ZTogZnVuY3Rpb24oa2V5KXsKCQlpZiAodGhpcy5oYXNLZXkoa2V5KSl7CgkJCWRlbGV0ZSB0aGlzLm9ialtrZXldOwoJCQl0aGlzLmxlbmd0aC0tOwoJCX0KCQlyZXR1cm4gdGhpczsKCX0sCgoJLyoKCVByb3BlcnR5OiBlYWNoCgkJQ2FsbHMgYSBmdW5jdGlvbiBmb3IgZWFjaCBrZXktdmFsdWUgcGFpci4gVGhlIGZpcnN0IGFyZ3VtZW50IHBhc3NlZCB0byB0aGUgZnVuY3Rpb24gd2lsbCBiZSB0aGUgdmFsdWUsIHRoZSBzZWNvbmQgb25lIHdpbGwgYmUgdGhlIGtleSwgbGlrZSAkZWFjaC4KCglBcmd1bWVudHM6CgkJZm4gLSBUaGUgZnVuY3Rpb24gdG8gY2FsbCBmb3IgZWFjaCBrZXktdmFsdWUgcGFpcgoJCWJpbmQgLSBPcHRpb25hbCwgdGhlIG9iamVjdCB0aGF0IHdpbGwgYmUgcmVmZXJyZWQgdG8gYXMgInRoaXMiIGluIHRoZSBmdW5jdGlvbgoJKi8KCgllYWNoOiBmdW5jdGlvbihmbiwgYmluZCl7CgkJJGVhY2godGhpcy5vYmosIGZuLCBiaW5kKTsKCX0sCgoJLyoKCVByb3BlcnR5OiBleHRlbmQKCQlFeHRlbmRzIHRoZSBjdXJyZW50IGhhc2ggd2l0aCBhbiBvYmplY3QgY29udGFpbmluZyBrZXktdmFsdWUgcGFpcnMuIFZhbHVlcyBmb3IgZHVwbGljYXRlIGtleXMgd2lsbCBiZSByZXBsYWNlZCBieSB0aGUgbmV3IG9uZXMuCgoJQXJndW1lbnRzOgoJCW9iaiAtIEFuIG9iamVjdCBjb250YWluaW5nIGtleS12YWx1ZSBwYWlycwoJKi8KCglleHRlbmQ6IGZ1bmN0aW9uKG9iail7CgkJJGV4dGVuZCh0aGlzLm9iaiwgb2JqKTsKCQlyZXR1cm4gdGhpcy5zZXRMZW5ndGgoKTsKCX0sCgoJLyoKCVByb3BlcnR5OiBtZXJnZQoJCU1lcmdlcyB0aGUgY3VycmVudCBoYXNoIHdpdGggbXVsdGlwbGUgb2JqZWN0cy4KCSovCgoJbWVyZ2U6IGZ1bmN0aW9uKCl7CgkJdGhpcy5vYmogPSAkbWVyZ2UuYXBwbHkobnVsbCwgW3RoaXMub2JqXS5leHRlbmQoYXJndW1lbnRzKSk7CgkJcmV0dXJuIHRoaXMuc2V0TGVuZ3RoKCk7Cgl9LAoKCS8qCglQcm9wZXJ0eTogZW1wdHkKCQlFbXB0aWVzIGFsbCBoYXNoIHZhbHVlcyBwcm9wZXJ0aWVzIGFuZCB2YWx1ZXMuCgkqLwoKCWVtcHR5OiBmdW5jdGlvbigpewoJCXRoaXMub2JqID0ge307CgkJdGhpcy5sZW5ndGggPSAwOwoJCXJldHVybiB0aGlzOwoJfSwKCgkvKgoJUHJvcGVydHk6IGtleXMKCQlSZXR1cm5zIGFuIGFycmF5IGNvbnRhaW5pbmcgYWxsIHRoZSBrZXlzLCBpbiB0aGUgc2FtZSBvcmRlciBhcyB0aGUgdmFsdWVzIHJldHVybmVkIGJ5IDxIYXNoLnZhbHVlcz4uCgoJUmV0dXJuczoKCQlBbiBhcnJheSBjb250YWluaW5nIGFsbCB0aGUga2V5cyBvZiB0aGUgaGFzaAoJKi8KCglrZXlzOiBmdW5jdGlvbigpewoJCXZhciBrZXlzID0gW107CgkJZm9yICh2YXIgcHJvcGVydHkgaW4gdGhpcy5vYmopIGtleXMucHVzaChwcm9wZXJ0eSk7CgkJcmV0dXJuIGtleXM7Cgl9LAoKCS8qCglQcm9wZXJ0eTogdmFsdWVzCgkJUmV0dXJucyBhbiBhcnJheSBjb250YWluaW5nIGFsbCB0aGUgdmFsdWVzLCBpbiB0aGUgc2FtZSBvcmRlciBhcyB0aGUga2V5cyByZXR1cm5lZCBieSA8SGFzaC5rZXlzPi4KCglSZXR1cm5zOgoJCUFuIGFycmF5IGNvbnRhaW5pbmcgYWxsIHRoZSB2YWx1ZXMgb2YgdGhlIGhhc2gKCSovCgoJdmFsdWVzOiBmdW5jdGlvbigpewoJCXZhciB2YWx1ZXMgPSBbXTsKCQlmb3IgKHZhciBwcm9wZXJ0eSBpbiB0aGlzLm9iaikgdmFsdWVzLnB1c2godGhpcy5vYmpbcHJvcGVydHldKTsKCQlyZXR1cm4gdmFsdWVzOwoJfQoKfSk7CgovKiBTZWN0aW9uOiBVdGlsaXR5IEZ1bmN0aW9ucyAqLwoKLyoKRnVuY3Rpb246ICRICglTaG9ydGN1dCB0byBjcmVhdGUgYSBIYXNoIGZyb20gYW4gT2JqZWN0LgoqLwoKZnVuY3Rpb24gJEgob2JqKXsKCXJldHVybiBuZXcgSGFzaChvYmopOwp9OwoKLyoKU2NyaXB0OiBIYXNoLkNvb2tpZS5qcwoJU3RvcmVzIGFuZCBsb2FkcyBhbiBIYXNoIGFzIGEgY29va2llIHVzaW5nIEpzb24gZm9ybWF0LgoqLwoKLyoKQ2xhc3M6IEhhc2guQ29va2llCglJbmhlcml0cyBhbGwgdGhlIG1ldGhvZHMgZnJvbSA8SGFzaD4sIGFkZGl0aW9uYWwgbWV0aG9kcyBhcmUgc2F2ZSBhbmQgbG9hZC4KCUhhc2gganNvbiBzdHJpbmcgaGFzIGEgbGltaXQgb2YgNGtiICg0MDk2Ynl0ZSksIHNvIGJlIGNhcmVmdWwgd2l0aCB5b3VyIEhhc2ggc2l6ZS4KCUNyZWF0aW5nIGEgbmV3IGluc3RhbmNlIGF1dG9tYXRpY2FsbHkgbG9hZHMgdGhlIGRhdGEgZnJvbSB0aGUgQ29va2llIGludG8gdGhlIEhhc2guCglJZiB0aGUgSGFzaCBpcyBlbXB0aWVkLCB0aGUgY29va2llIGlzIGFsc28gcmVtb3ZlZC4KCkFyZ3VtZW50czoKCW5hbWUgLSB0aGUga2V5IChuYW1lKSBmb3IgdGhlIGNvb2tpZQoJb3B0aW9ucyAtIG9wdGlvbnMgYXJlIGlkZW50aWNhbCB0byA8Q29va2llPiBhbmQgYXJlIHNpbXBseSBwYXNzZWQgYWxvbmcgdG8gaXQuCgkJSW4gYWRkaXRpb24sIGl0IGhhcyB0aGUgYXV0b1NhdmUgb3B0aW9uLCB0byBzYXZlIHRoZSBjb29raWUgYXQgZXZlcnkgb3BlcmF0aW9uLiBkZWZhdWx0cyB0byB0cnVlLgoKRXhhbXBsZToKCShzdGFydCBjb2RlKQoJdmFyIGZydWl0cyA9IG5ldyBIYXNoLkNvb2tpZSgnbXlDb29raWVOYW1lJywge2R1cmF0aW9uOiAzNjAwfSk7CglmcnVpdHMuZXh0ZW5kKHsKCQknbGVtb24nOiAneWVsbG93JywKCQknYXBwbGUnOiAncmVkJwoJfSk7CglmcnVpdHMuc2V0KCdtZWxvbicsICdncmVlbicpOwoJZnJ1aXRzLmdldCgnbGVtb24nKTsgLy8geWVsbG93CgoJLy8gLi4uIG9uIGFub3RoZXIgcGFnZSAuLi4gdmFsdWVzIGxvYWQgYXV0b21hdGljYWxseQoKCXZhciBmcnVpdHMgPSBuZXcgSGFzaC5Db29raWUoJ215Q29va2llTmFtZScsIHtkdXJhdGlvbjogMzY1fSk7CglmcnVpdHMuZ2V0KCdtZWxvbicpOyAvLyBncmVlbgoKCWZydWl0cy5lcmFzZSgpOyAvLyBkZWxldGUgY29va2llCgkoZW5kKQoqLwoKSGFzaC5Db29raWUgPSBIYXNoLmV4dGVuZCh7CgoJaW5pdGlhbGl6ZTogZnVuY3Rpb24obmFtZSwgb3B0aW9ucyl7CgkJdGhpcy5uYW1lID0gbmFtZTsKCQl0aGlzLm9wdGlvbnMgPSAkZXh0ZW5kKHsnYXV0b1NhdmUnOiB0cnVlfSwgb3B0aW9ucyB8fCB7fSk7CgkJdGhpcy5sb2FkKCk7Cgl9LAoKCS8qCglQcm9wZXJ0eTogc2F2ZQoJCVNhdmVzIHRoZSBIYXNoIHRvIHRoZSBjb29raWUuIElmIHRoZSBoYXNoIGlzIGVtcHR5LCByZW1vdmVzIHRoZSBjb29raWUuCgoJUmV0dXJuczoKCQlSZXR1cm5zIGZhbHNlIHdoZW4gdGhlIEpTT04gc3RyaW5nIGNvb2tpZSBpcyB0b28gbG9uZyAoNGtiKSwgb3RoZXJ3aXNlIHRydWUuCgoJRXhhbXBsZToKCQkoc3RhcnQgY29kZSkKCQl2YXIgbG9naW4gPSBuZXcgSGFzaC5Db29raWUoJ3VzZXJzdGF0dXMnLCB7YXV0b1NhdmU6IGZhbHNlfSk7CgoJCWxvZ2luLmV4dGVuZCh7CgkJCSd1c2VybmFtZSc6ICdKb2huJywKCQkJJ2NyZWRlbnRpYWxzJzogWzQsIDcsIDldCgkJfSk7CgkJbG9naW4uc2V0KCdsYXN0X21lc3NhZ2UnLCAnVXNlciBsb2dnZWQgaW4hJyk7CgoJCWxvZ2luLnNhdmUoKTsgLy8gZmluYWxseSBzYXZlIHRoZSBIYXNoCgkJKGVuZCkKCSovCgoJc2F2ZTogZnVuY3Rpb24oKXsKCQlpZiAodGhpcy5sZW5ndGggPT0gMCl7CgkJCUNvb2tpZS5yZW1vdmUodGhpcy5uYW1lLCB0aGlzLm9wdGlvbnMpOwoJCQlyZXR1cm4gdHJ1ZTsKCQl9CgkJdmFyIHN0ciA9IEpzb24udG9TdHJpbmcodGhpcy5vYmopOwoJCWlmIChzdHIubGVuZ3RoID4gNDA5NikgcmV0dXJuIGZhbHNlOyAvL2Nvb2tpZSB3b3VsZCBiZSB0cnVuY2F0ZWQhCgkJQ29va2llLnNldCh0aGlzLm5hbWUsIHN0ciwgdGhpcy5vcHRpb25zKTsKCQlyZXR1cm4gdHJ1ZTsKCX0sCgoJLyoKCVByb3BlcnR5OiBsb2FkCgkJTG9hZHMgdGhlIGNvb2tpZSBhbmQgYXNzaWducyBpdCB0byB0aGUgSGFzaC4KCSovCgoJbG9hZDogZnVuY3Rpb24oKXsKCQl0aGlzLm9iaiA9IEpzb24uZXZhbHVhdGUoQ29va2llLmdldCh0aGlzLm5hbWUpLCB0cnVlKSB8fCB7fTsKCQl0aGlzLnNldExlbmd0aCgpOwoJfQoKfSk7CgpIYXNoLkNvb2tpZS5NZXRob2RzID0ge307ClsnZXh0ZW5kJywgJ3NldCcsICdtZXJnZScsICdlbXB0eScsICdyZW1vdmUnXS5lYWNoKGZ1bmN0aW9uKG1ldGhvZCl7CglIYXNoLkNvb2tpZS5NZXRob2RzW21ldGhvZF0gPSBmdW5jdGlvbigpewoJCUhhc2gucHJvdG90eXBlW21ldGhvZF0uYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCQlpZiAodGhpcy5vcHRpb25zLmF1dG9TYXZlKSB0aGlzLnNhdmUoKTsKCQlyZXR1cm4gdGhpczsKCX07Cn0pOwpIYXNoLkNvb2tpZS5pbXBsZW1lbnQoSGFzaC5Db29raWUuTWV0aG9kcyk7CgovKgpTY3JpcHQ6IENvbG9yLmpzCglDb250YWlucyB0aGUgQ29sb3IgY2xhc3MuCgpMaWNlbnNlOgoJTUlULXN0eWxlIGxpY2Vuc2UuCiovCgovKgpDbGFzczogQ29sb3IKCUNyZWF0ZXMgYSBuZXcgQ29sb3IgT2JqZWN0LCB3aGljaCBpcyBhbiBhcnJheSB3aXRoIHNvbWUgY29sb3Igc3BlY2lmaWMgbWV0aG9kcy4KQXJndW1lbnRzOgoJY29sb3IgLSB0aGUgaGV4LCB0aGUgUkdCIGFycmF5IG9yIHRoZSBIU0IgYXJyYXkgb2YgdGhlIGNvbG9yIHRvIGNyZWF0ZS4gRm9yIEhTQiBjb2xvcnMsIHlvdSBuZWVkIHRvIHNwZWNpZnkgdGhlIHNlY29uZCBhcmd1bWVudC4KCXR5cGUgLSBhIHN0cmluZyByZXByZXNlbnRpbmcgdGhlIHR5cGUgb2YgdGhlIGNvbG9yIHRvIGNyZWF0ZS4gbmVlZHMgdG8gYmUgc3BlY2lmaWVkIGlmIHlvdSBpbnRlbmQgdG8gY3JlYXRlIHRoZSBjb2xvciB3aXRoIEhTQiB2YWx1ZXMsIG9yIGFuIGFycmF5IG9mIEhFWCB2YWx1ZXMuIENhbiBiZSAncmdiJywgJ2hzYicgb3IgJ2hleCcuCgpFeGFtcGxlOgoJKHN0YXJ0IGNvZGUpCgl2YXIgYmxhY2sgPSBuZXcgQ29sb3IoJyMwMDAnKTsKCXZhciBwdXJwbGUgPSBuZXcgQ29sb3IoWzI1NSwwLDI1NV0pOwoJLy8gbWl4IGJsYWNrIHdpdGggd2hpdGUgYW5kIHB1cnBsZSwgZWFjaCB0aW1lIGF0IDEwJSBvZiB0aGUgbmV3IGNvbG9yCgl2YXIgZGFya3B1cnBsZSA9IGJsYWNrLm1peCgnI2ZmZicsIHB1cnBsZSwgMTApOwoJJCgnbXlEaXYnKS5zZXRTdHlsZSgnYmFja2dyb3VuZC1jb2xvcicsIGRhcmtwdXJwbGUpOwoJKGVuZCkKKi8KCnZhciBDb2xvciA9IG5ldyBDbGFzcyh7CgoJaW5pdGlhbGl6ZTogZnVuY3Rpb24oY29sb3IsIHR5cGUpewoJCXR5cGUgPSB0eXBlIHx8IChjb2xvci5wdXNoID8gJ3JnYicgOiAnaGV4Jyk7CgkJdmFyIHJnYiwgaHNiOwoJCXN3aXRjaCh0eXBlKXsKCQkJY2FzZSAncmdiJzoKCQkJCXJnYiA9IGNvbG9yOwoJCQkJaHNiID0gcmdiLnJnYlRvSHNiKCk7CgkJCQlicmVhazsKCQkJY2FzZSAnaHNiJzoKCQkJCXJnYiA9IGNvbG9yLmhzYlRvUmdiKCk7CgkJCQloc2IgPSBjb2xvcjsKCQkJCWJyZWFrOwoJCQlkZWZhdWx0OgoJCQkJcmdiID0gY29sb3IuaGV4VG9SZ2IodHJ1ZSk7CgkJCQloc2IgPSByZ2IucmdiVG9Ic2IoKTsKCQl9CgkJcmdiLmhzYiA9IGhzYjsKCQlyZ2IuaGV4ID0gcmdiLnJnYlRvSGV4KCk7CgkJcmV0dXJuICRleHRlbmQocmdiLCBDb2xvci5wcm90b3R5cGUpOwoJfSwKCgkvKgoJUHJvcGVydHk6IG1peAoJCU1peGVzIHR3byBvciBtb3JlIGNvbG9ycyB3aXRoIHRoZSBDb2xvci4KCglBcmd1bWVudHM6CgkJY29sb3IgLSBhIGNvbG9yIHRvIG1peC4geW91IGNhbiB1c2UgYXMgYXJndW1lbnRzIGhvdyBtYW55IGNvbG9ycyBhcyB5b3Ugd2FudCB0byBtaXggd2l0aCB0aGUgb3JpZ2luYWwgb25lLgoJCWFscGhhIC0gaWYgeW91IHVzZSBhIG51bWJlciBhcyB0aGUgbGFzdCBhcmd1bWVudCwgaXQgd2lsbCBiZSB0aHJlYXRlZCBhcyB0aGUgYW1vdW50IG9mIHRoZSBjb2xvciB0byBtaXguCgkqLwoKCW1peDogZnVuY3Rpb24oKXsKCQl2YXIgY29sb3JzID0gJEEoYXJndW1lbnRzKTsKCQl2YXIgYWxwaGEgPSAoJHR5cGUoY29sb3JzW2NvbG9ycy5sZW5ndGggLSAxXSkgPT0gJ251bWJlcicpID8gY29sb3JzLnBvcCgpIDogNTA7CgkJdmFyIHJnYiA9IHRoaXMuY29weSgpOwoJCWNvbG9ycy5lYWNoKGZ1bmN0aW9uKGNvbG9yKXsKCQkJY29sb3IgPSBuZXcgQ29sb3IoY29sb3IpOwoJCQlmb3IgKHZhciBpID0gMDsgaSA8IDM7IGkrKykgcmdiW2ldID0gTWF0aC5yb3VuZCgocmdiW2ldIC8gMTAwICogKDEwMCAtIGFscGhhKSkgKyAoY29sb3JbaV0gLyAxMDAgKiBhbHBoYSkpOwoJCX0pOwoJCXJldHVybiBuZXcgQ29sb3IocmdiLCAncmdiJyk7Cgl9LAoKCS8qCglQcm9wZXJ0eTogaW52ZXJ0CgkJSW52ZXJ0cyB0aGUgQ29sb3IuCgkqLwoKCWludmVydDogZnVuY3Rpb24oKXsKCQlyZXR1cm4gbmV3IENvbG9yKHRoaXMubWFwKGZ1bmN0aW9uKHZhbHVlKXsKCQkJcmV0dXJuIDI1NSAtIHZhbHVlOwoJCX0pKTsKCX0sCgoJLyoKCVByb3BlcnR5OiBzZXRIdWUKCQlNb2RpZmllcyB0aGUgaHVlIG9mIHRoZSBDb2xvciwgYW5kIHJldHVybnMgYSBuZXcgb25lLgoKCUFyZ3VtZW50czoKCQl2YWx1ZSAtIHRoZSBodWUgdG8gc2V0CgkqLwoKCXNldEh1ZTogZnVuY3Rpb24odmFsdWUpewoJCXJldHVybiBuZXcgQ29sb3IoW3ZhbHVlLCB0aGlzLmhzYlsxXSwgdGhpcy5oc2JbMl1dLCAnaHNiJyk7Cgl9LAoKCS8qCglQcm9wZXJ0eTogc2V0U2F0dXJhdGlvbgoJCUNoYW5nZXMgdGhlIHNhdHVyYXRpb24gb2YgdGhlIENvbG9yLCBhbmQgcmV0dXJucyBhIG5ldyBvbmUuCgoJQXJndW1lbnRzOgoJCXBlcmNlbnQgLSB0aGUgcGVyY2VudGFnZSBvZiB0aGUgc2F0dXJhdGlvbiB0byBzZXQKCSovCgoJc2V0U2F0dXJhdGlvbjogZnVuY3Rpb24ocGVyY2VudCl7CgkJcmV0dXJuIG5ldyBDb2xvcihbdGhpcy5oc2JbMF0sIHBlcmNlbnQsIHRoaXMuaHNiWzJdXSwgJ2hzYicpOwoJfSwKCgkvKgoJUHJvcGVydHk6IHNldEJyaWdodG5lc3MKCQlDaGFuZ2VzIHRoZSBicmlnaHRuZXNzIG9mIHRoZSBDb2xvciwgYW5kIHJldHVybnMgYSBuZXcgb25lLgoKCUFyZ3VtZW50czoKCQlwZXJjZW50IC0gdGhlIHBlcmNlbnRhZ2Ugb2YgdGhlIGJyaWdodG5lc3MgdG8gc2V0CgkqLwoKCXNldEJyaWdodG5lc3M6IGZ1bmN0aW9uKHBlcmNlbnQpewoJCXJldHVybiBuZXcgQ29sb3IoW3RoaXMuaHNiWzBdLCB0aGlzLmhzYlsxXSwgcGVyY2VudF0sICdoc2InKTsKCX0KCn0pOwoKLyogU2VjdGlvbjogVXRpbGl0eSBGdW5jdGlvbnMgKi8KCi8qCkZ1bmN0aW9uOiAkUkdCCglTaG9ydGN1dCB0byBjcmVhdGUgYSBuZXcgY29sb3IsIGJhc2VkIG9uIHJlZCwgZ3JlZW4sIGJsdWUgdmFsdWVzLgoKQXJndW1lbnRzOgoJciAtIChpbnRlZ2VyKSByZWQgdmFsdWUgKDAtMjU1KQoJZyAtIChpbnRlZ2VyKSBncmVlbiB2YWx1ZSAoMC0yNTUpCgliIC0gKGludGVnZXIpIGJsdWUgdmFsdWUgKDAtMjU1KQoKKi8KCmZ1bmN0aW9uICRSR0IociwgZywgYil7CglyZXR1cm4gbmV3IENvbG9yKFtyLCBnLCBiXSwgJ3JnYicpOwp9OwoKLyoKRnVuY3Rpb246ICRIU0IKCVNob3J0Y3V0IHRvIGNyZWF0ZSBhIG5ldyBjb2xvciwgYmFzZWQgb24gaHVlLCBzYXR1cmF0aW9uLCBicmlnaHRuZXNzIHZhbHVlcy4KCkFyZ3VtZW50czoKCWggLSAoaW50ZWdlcikgaHVlIHZhbHVlICgwLTEwMCkKCXMgLSAoaW50ZWdlcikgc2F0dXJhdGlvbiB2YWx1ZSAoMC0xMDApCgliIC0gKGludGVnZXIpIGJyaWdodG5lc3MgdmFsdWUgKDAtMTAwKQoqLwoKZnVuY3Rpb24gJEhTQihoLCBzLCBiKXsKCXJldHVybiBuZXcgQ29sb3IoW2gsIHMsIGJdLCAnaHNiJyk7Cn07CgovKgpDbGFzczogQXJyYXkKCUEgY29sbGVjdGlvbiBvZiBUaGUgQXJyYXkgT2JqZWN0IHByb3RvdHlwZSBtZXRob2RzLgoqLwoKQXJyYXkuZXh0ZW5kKHsKCgkvKgoJUHJvcGVydHk6IHJnYlRvSHNiCgkJQ29udmVydHMgYSBSR0IgYXJyYXkgdG8gYW4gSFNCIGFycmF5LgoKCVJldHVybnM6CgkJdGhlIEhTQiBhcnJheS4KCSovCgoJcmdiVG9Ic2I6IGZ1bmN0aW9uKCl7CgkJdmFyIHJlZCA9IHRoaXNbMF0sIGdyZWVuID0gdGhpc1sxXSwgYmx1ZSA9IHRoaXNbMl07CgkJdmFyIGh1ZSwgc2F0dXJhdGlvbiwgYnJpZ2h0bmVzczsKCQl2YXIgbWF4ID0gTWF0aC5tYXgocmVkLCBncmVlbiwgYmx1ZSksIG1pbiA9IE1hdGgubWluKHJlZCwgZ3JlZW4sIGJsdWUpOwoJCXZhciBkZWx0YSA9IG1heCAtIG1pbjsKCQlicmlnaHRuZXNzID0gbWF4IC8gMjU1OwoJCXNhdHVyYXRpb24gPSAobWF4ICE9IDApID8gZGVsdGEgLyBtYXggOiAwOwoJCWlmIChzYXR1cmF0aW9uID09IDApewoJCQlodWUgPSAwOwoJCX0gZWxzZSB7CgkJCXZhciByciA9IChtYXggLSByZWQpIC8gZGVsdGE7CgkJCXZhciBnciA9IChtYXggLSBncmVlbikgLyBkZWx0YTsKCQkJdmFyIGJyID0gKG1heCAtIGJsdWUpIC8gZGVsdGE7CgkJCWlmIChyZWQgPT0gbWF4KSBodWUgPSBiciAtIGdyOwoJCQllbHNlIGlmIChncmVlbiA9PSBtYXgpIGh1ZSA9IDIgKyByciAtIGJyOwoJCQllbHNlIGh1ZSA9IDQgKyBnciAtIHJyOwoJCQlodWUgLz0gNjsKCQkJaWYgKGh1ZSA8IDApIGh1ZSsrOwoJCX0KCQlyZXR1cm4gW01hdGgucm91bmQoaHVlICogMzYwKSwgTWF0aC5yb3VuZChzYXR1cmF0aW9uICogMTAwKSwgTWF0aC5yb3VuZChicmlnaHRuZXNzICogMTAwKV07Cgl9LAoKCS8qCglQcm9wZXJ0eTogaHNiVG9SZ2IKCQlDb252ZXJ0cyBhbiBIU0IgYXJyYXkgdG8gYW4gUkdCIGFycmF5LgoKCVJldHVybnM6CgkJdGhlIFJHQiBhcnJheS4KCSovCgoJaHNiVG9SZ2I6IGZ1bmN0aW9uKCl7CgkJdmFyIGJyID0gTWF0aC5yb3VuZCh0aGlzWzJdIC8gMTAwICogMjU1KTsKCQlpZiAodGhpc1sxXSA9PSAwKXsKCQkJcmV0dXJuIFticiwgYnIsIGJyXTsKCQl9IGVsc2UgewoJCQl2YXIgaHVlID0gdGhpc1swXSAlIDM2MDsKCQkJdmFyIGYgPSBodWUgJSA2MDsKCQkJdmFyIHAgPSBNYXRoLnJvdW5kKCh0aGlzWzJdICogKDEwMCAtIHRoaXNbMV0pKSAvIDEwMDAwICogMjU1KTsKCQkJdmFyIHEgPSBNYXRoLnJvdW5kKCh0aGlzWzJdICogKDYwMDAgLSB0aGlzWzFdICogZikpIC8gNjAwMDAwICogMjU1KTsKCQkJdmFyIHQgPSBNYXRoLnJvdW5kKCh0aGlzWzJdICogKDYwMDAgLSB0aGlzWzFdICogKDYwIC0gZikpKSAvIDYwMDAwMCAqIDI1NSk7CgkJCXN3aXRjaChNYXRoLmZsb29yKGh1ZSAvIDYwKSl7CgkJCQljYXNlIDA6IHJldHVybiBbYnIsIHQsIHBdOwoJCQkJY2FzZSAxOiByZXR1cm4gW3EsIGJyLCBwXTsKCQkJCWNhc2UgMjogcmV0dXJuIFtwLCBiciwgdF07CgkJCQljYXNlIDM6IHJldHVybiBbcCwgcSwgYnJdOwoJCQkJY2FzZSA0OiByZXR1cm4gW3QsIHAsIGJyXTsKCQkJCWNhc2UgNTogcmV0dXJuIFticiwgcCwgcV07CgkJCX0KCQl9CgkJcmV0dXJuIGZhbHNlOwoJfQoKfSk7CgovKgpTY3JpcHQ6IFNjcm9sbGVyLmpzCglDb250YWlucyB0aGUgPFNjcm9sbGVyPi4KCkxpY2Vuc2U6CglNSVQtc3R5bGUgbGljZW5zZS4KKi8KCi8qCkNsYXNzOiBTY3JvbGxlcgoJVGhlIFNjcm9sbGVyIGlzIGEgY2xhc3MgdG8gc2Nyb2xsIGFueSBlbGVtZW50IHdpdGggYW4gb3ZlcmZsb3cgKGluY2x1ZGluZyB0aGUgd2luZG93KSB3aGVuIHRoZSBtb3VzZSBjdXJzb3IgcmVhY2hlcyBjZXJ0YWluIGJ1b25kYXJpZXMgb2YgdGhhdCBlbGVtZW50LgoJWW91IG11c3QgY2FsbCBpdHMgc3RhcnQgbWV0aG9kIHRvIHN0YXJ0IGxpc3RlbmluZyB0byBtb3VzZSBtb3ZlbWVudHMuCgpOb3RlOgoJVGhlIFNjcm9sbGVyIHJlcXVpcmVzIGFuIFhIVE1MIGRvY3R5cGUuCgpBcmd1bWVudHM6CgllbGVtZW50IC0gcmVxdWlyZWQsIHRoZSBlbGVtZW50IHRvIHNjcm9sbC4KCW9wdGlvbnMgLSBvcHRpb25hbCwgc2VlIG9wdGlvbnMgYmVsb3csIGFuZCA8RnguQmFzZT4gb3B0aW9ucy4KCk9wdGlvbnM6CglhcmVhIC0gaW50ZWdlciwgdGhlIG5lY2Vzc2FyeSBib3VuZGFyaWVzIHRvIG1ha2UgdGhlIGVsZW1lbnQgc2Nyb2xsLgoJdmVsb2NpdHkgLSBpbnRlZ2VyLCB2ZWxvY2l0eSByYXRpbywgdGhlIG1vZGlmaWVyIGZvciB0aGUgd2luZG93IHNjcm9sbGluZyBzcGVlZC4KCkV2ZW50czoKCW9uQ2hhbmdlIC0gb3B0aW9uYWxseSwgd2hlbiB0aGUgbW91c2UgcmVhY2hlcyBzb21lIGJvdW5kYXJpZXMsIHlvdSBjYW4gY2hvb3NlIHRvIGFsdGVyIHNvbWUgb3RoZXIgdmFsdWVzLCBpbnN0ZWFkIG9mIHRoZSBzY3JvbGxpbmcgb2Zmc2V0cy4KCQlBdXRvbWF0aWNhbGx5IHBhc3NlcyBhcyBwYXJhbWV0ZXJzIHggYW5kIHkgdmFsdWVzLgoqLwoKdmFyIFNjcm9sbGVyID0gbmV3IENsYXNzKHsKCglvcHRpb25zOiB7CgkJYXJlYTogMjAsCgkJdmVsb2NpdHk6IDEsCgkJb25DaGFuZ2U6IGZ1bmN0aW9uKHgsIHkpewoJCQl0aGlzLmVsZW1lbnQuc2Nyb2xsVG8oeCwgeSk7CgkJfQoJfSwKCglpbml0aWFsaXplOiBmdW5jdGlvbihlbGVtZW50LCBvcHRpb25zKXsKCQl0aGlzLnNldE9wdGlvbnMob3B0aW9ucyk7CgkJdGhpcy5lbGVtZW50ID0gJChlbGVtZW50KTsKCQl0aGlzLm1vdXNlbW92ZXIgPSAoW3dpbmRvdywgZG9jdW1lbnRdLmNvbnRhaW5zKGVsZW1lbnQpKSA/ICQoZG9jdW1lbnQuYm9keSkgOiB0aGlzLmVsZW1lbnQ7Cgl9LAoKCS8qCglQcm9wZXJ0eTogc3RhcnQKCQlUaGUgc2Nyb2xsZXIgc3RhcnRzIGxpc3RlbmluZyB0byBtb3VzZSBtb3ZlbWVudHMuCgkqLwoKCXN0YXJ0OiBmdW5jdGlvbigpewoJCXRoaXMuY29vcmQgPSB0aGlzLmdldENvb3Jkcy5iaW5kV2l0aEV2ZW50KHRoaXMpOwoJCXRoaXMubW91c2Vtb3Zlci5hZGRMaXN0ZW5lcignbW91c2Vtb3ZlJywgdGhpcy5jb29yZCk7Cgl9LAoKCS8qCglQcm9wZXJ0eTogc3RvcAoJCVRoZSBzY3JvbGxlciBzdG9wcyBsaXN0ZW5pbmcgdG8gbW91c2UgbW92ZW1lbnRzLgoJKi8KCglzdG9wOiBmdW5jdGlvbigpewoJCXRoaXMubW91c2Vtb3Zlci5yZW1vdmVMaXN0ZW5lcignbW91c2Vtb3ZlJywgdGhpcy5jb29yZCk7CgkJdGhpcy50aW1lciA9ICRjbGVhcih0aGlzLnRpbWVyKTsKCX0sCgoJZ2V0Q29vcmRzOiBmdW5jdGlvbihldmVudCl7CgkJdGhpcy5wYWdlID0gKHRoaXMuZWxlbWVudCA9PSB3aW5kb3cpID8gZXZlbnQuY2xpZW50IDogZXZlbnQucGFnZTsKCQlpZiAoIXRoaXMudGltZXIpIHRoaXMudGltZXIgPSB0aGlzLnNjcm9sbC5wZXJpb2RpY2FsKDUwLCB0aGlzKTsKCX0sCgoJc2Nyb2xsOiBmdW5jdGlvbigpewoJCXZhciBlbCA9IHRoaXMuZWxlbWVudC5nZXRTaXplKCk7CgkJdmFyIHBvcyA9IHRoaXMuZWxlbWVudC5nZXRQb3NpdGlvbigpOwoKCQl2YXIgY2hhbmdlID0geyd4JzogMCwgJ3knOiAwfTsKCQlmb3IgKHZhciB6IGluIHRoaXMucGFnZSl7CgkJCWlmICh0aGlzLnBhZ2Vbel0gPCAodGhpcy5vcHRpb25zLmFyZWEgKyBwb3Nbel0pICYmIGVsLnNjcm9sbFt6XSAhPSAwKQoJCQkJY2hhbmdlW3pdID0gKHRoaXMucGFnZVt6XSAtIHRoaXMub3B0aW9ucy5hcmVhIC0gcG9zW3pdKSAqIHRoaXMub3B0aW9ucy52ZWxvY2l0eTsKCQkJZWxzZSBpZiAodGhpcy5wYWdlW3pdICsgdGhpcy5vcHRpb25zLmFyZWEgPiAoZWwuc2l6ZVt6XSArIHBvc1t6XSkgJiYgZWwuc2Nyb2xsW3pdICsgZWwuc2l6ZVt6XSAhPSBlbC5zY3JvbGxTaXplW3pdKQoJCQkJY2hhbmdlW3pdID0gKHRoaXMucGFnZVt6XSAtIGVsLnNpemVbel0gKyB0aGlzLm9wdGlvbnMuYXJlYSAtIHBvc1t6XSkgKiB0aGlzLm9wdGlvbnMudmVsb2NpdHk7CgkJfQoJCWlmIChjaGFuZ2UueSB8fCBjaGFuZ2UueCkgdGhpcy5maXJlRXZlbnQoJ29uQ2hhbmdlJywgW2VsLnNjcm9sbC54ICsgY2hhbmdlLngsIGVsLnNjcm9sbC55ICsgY2hhbmdlLnldKTsKCX0KCn0pOwoKU2Nyb2xsZXIuaW1wbGVtZW50KG5ldyBFdmVudHMsIG5ldyBPcHRpb25zKTsKCi8qClNjcmlwdDogU2xpZGVyLmpzCglDb250YWlucyA8U2xpZGVyPgoKTGljZW5zZToKCU1JVC1zdHlsZSBsaWNlbnNlLgoqLwoKLyoKQ2xhc3M6IFNsaWRlcgoJQ3JlYXRlcyBhIHNsaWRlciB3aXRoIHR3byBlbGVtZW50czogYSBrbm9iIGFuZCBhIGNvbnRhaW5lci4gUmV0dXJucyB0aGUgdmFsdWVzLgoKTm90ZToKCVRoZSBTbGlkZXIgcmVxdWlyZXMgYW4gWEhUTUwgZG9jdHlwZS4KCkFyZ3VtZW50czoKCWVsZW1lbnQgLSB0aGUga25vYiBjb250YWluZXIKCWtub2IgLSB0aGUgaGFuZGxlCglvcHRpb25zIC0gc2VlIE9wdGlvbnMgYmVsb3cKCk9wdGlvbnM6CglzdGVwcyAtIHRoZSBudW1iZXIgb2Ygc3RlcHMgZm9yIHlvdXIgc2xpZGVyLgoJbW9kZSAtIGVpdGhlciAnaG9yaXpvbnRhbCcgb3IgJ3ZlcnRpY2FsJy4gZGVmYXVsdHMgdG8gaG9yaXpvbnRhbC4KCW9mZnNldCAtIHJlbGF0aXZlIG9mZnNldCBmb3Iga25vYiBwb3NpdGlvbi4gZGVmYXVsdCB0byAwLgoKRXZlbnRzOgoJb25DaGFuZ2UgLSBhIGZ1bmN0aW9uIHRvIGZpcmUgd2hlbiB0aGUgdmFsdWUgY2hhbmdlcy4KCW9uQ29tcGxldGUgLSBhIGZ1bmN0aW9uIHRvIGZpcmUgd2hlbiB5b3UncmUgZG9uZSBkcmFnZ2luZy4KCW9uVGljayAtIG9wdGlvbmFsbHksIHlvdSBjYW4gYWx0ZXIgdGhlIG9uVGljayBiZWhhdmlvciwgZm9yIGV4YW1wbGUgZGlzcGxheWluZyBhbiBlZmZlY3Qgb2YgdGhlIGtub2IgbW92aW5nIHRvIHRoZSBkZXNpcmVkIHBvc2l0aW9uLgoJCVBhc3NlcyBhcyBwYXJhbWV0ZXIgdGhlIG5ldyBwb3NpdGlvbi4KKi8KCnZhciBTbGlkZXIgPSBuZXcgQ2xhc3MoewoKCW9wdGlvbnM6IHsKCQlvbkNoYW5nZTogQ2xhc3MuZW1wdHksCgkJb25Db21wbGV0ZTogQ2xhc3MuZW1wdHksCgkJb25UaWNrOiBmdW5jdGlvbihwb3MpewoJCQl0aGlzLmtub2Iuc2V0U3R5bGUodGhpcy5wLCBwb3MpOwoJCX0sCgkJbW9kZTogJ2hvcml6b250YWwnLAoJCXN0ZXBzOiAxMDAsCgkJb2Zmc2V0OiAwCgl9LAoKCWluaXRpYWxpemU6IGZ1bmN0aW9uKGVsLCBrbm9iLCBvcHRpb25zKXsKCQl0aGlzLmVsZW1lbnQgPSAkKGVsKTsKCQl0aGlzLmtub2IgPSAkKGtub2IpOwoJCXRoaXMuc2V0T3B0aW9ucyhvcHRpb25zKTsKCQl0aGlzLnByZXZpb3VzQ2hhbmdlID0gLTE7CgkJdGhpcy5wcmV2aW91c0VuZCA9IC0xOwoJCXRoaXMuc3RlcCA9IC0xOwoJCXRoaXMuZWxlbWVudC5hZGRFdmVudCgnbW91c2Vkb3duJywgdGhpcy5jbGlja2VkRWxlbWVudC5iaW5kV2l0aEV2ZW50KHRoaXMpKTsKCQl2YXIgbW9kLCBvZmZzZXQ7CgkJc3dpdGNoKHRoaXMub3B0aW9ucy5tb2RlKXsKCQkJY2FzZSAnaG9yaXpvbnRhbCc6CgkJCQl0aGlzLnogPSAneCc7CgkJCQl0aGlzLnAgPSAnbGVmdCc7CgkJCQltb2QgPSB7J3gnOiAnbGVmdCcsICd5JzogZmFsc2V9OwoJCQkJb2Zmc2V0ID0gJ29mZnNldFdpZHRoJzsKCQkJCWJyZWFrOwoJCQljYXNlICd2ZXJ0aWNhbCc6CgkJCQl0aGlzLnogPSAneSc7CgkJCQl0aGlzLnAgPSAndG9wJzsKCQkJCW1vZCA9IHsneCc6IGZhbHNlLCAneSc6ICd0b3AnfTsKCQkJCW9mZnNldCA9ICdvZmZzZXRIZWlnaHQnOwoJCX0KCQl0aGlzLm1heCA9IHRoaXMuZWxlbWVudFtvZmZzZXRdIC0gdGhpcy5rbm9iW29mZnNldF0gKyAodGhpcy5vcHRpb25zLm9mZnNldCAqIDIpOwoJCXRoaXMuaGFsZiA9IHRoaXMua25vYltvZmZzZXRdLzI7CgkJdGhpcy5nZXRQb3MgPSB0aGlzLmVsZW1lbnRbJ2dldCcgKyB0aGlzLnAuY2FwaXRhbGl6ZSgpXS5iaW5kKHRoaXMuZWxlbWVudCk7CgkJdGhpcy5rbm9iLnNldFN0eWxlKCdwb3NpdGlvbicsICdyZWxhdGl2ZScpLnNldFN0eWxlKHRoaXMucCwgLSB0aGlzLm9wdGlvbnMub2Zmc2V0KTsKCQl2YXIgbGltID0ge307CgkJbGltW3RoaXMuel0gPSBbLSB0aGlzLm9wdGlvbnMub2Zmc2V0LCB0aGlzLm1heCAtIHRoaXMub3B0aW9ucy5vZmZzZXRdOwoJCXRoaXMuZHJhZyA9IG5ldyBEcmFnLkJhc2UodGhpcy5rbm9iLCB7CgkJCWxpbWl0OiBsaW0sCgkJCW1vZGlmaWVyczogbW9kLAoJCQlzbmFwOiAwLAoJCQlvblN0YXJ0OiBmdW5jdGlvbigpewoJCQkJdGhpcy5kcmFnZ2VkS25vYigpOwoJCQl9LmJpbmQodGhpcyksCgkJCW9uRHJhZzogZnVuY3Rpb24oKXsKCQkJCXRoaXMuZHJhZ2dlZEtub2IoKTsKCQkJfS5iaW5kKHRoaXMpLAoJCQlvbkNvbXBsZXRlOiBmdW5jdGlvbigpewoJCQkJdGhpcy5kcmFnZ2VkS25vYigpOwoJCQkJdGhpcy5lbmQoKTsKCQkJfS5iaW5kKHRoaXMpCgkJfSk7CgkJaWYgKHRoaXMub3B0aW9ucy5pbml0aWFsaXplKSB0aGlzLm9wdGlvbnMuaW5pdGlhbGl6ZS5jYWxsKHRoaXMpOwoJfSwKCgkvKgoJUHJvcGVydHk6IHNldAoJCVRoZSBzbGlkZXIgd2lsbCBnZXQgdGhlIHN0ZXAgeW91IHBhc3MuCgoJQXJndW1lbnRzOgoJCXN0ZXAgLSBvbmUgaW50ZWdlcgoJKi8KCglzZXQ6IGZ1bmN0aW9uKHN0ZXApewoJCXRoaXMuc3RlcCA9IHN0ZXAubGltaXQoMCwgdGhpcy5vcHRpb25zLnN0ZXBzKTsKCQl0aGlzLmNoZWNrU3RlcCgpOwoJCXRoaXMuZW5kKCk7CgkJdGhpcy5maXJlRXZlbnQoJ29uVGljaycsIHRoaXMudG9Qb3NpdGlvbih0aGlzLnN0ZXApKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJY2xpY2tlZEVsZW1lbnQ6IGZ1bmN0aW9uKGV2ZW50KXsKCQl2YXIgcG9zaXRpb24gPSBldmVudC5wYWdlW3RoaXMuel0gLSB0aGlzLmdldFBvcygpIC0gdGhpcy5oYWxmOwoJCXBvc2l0aW9uID0gcG9zaXRpb24ubGltaXQoLXRoaXMub3B0aW9ucy5vZmZzZXQsIHRoaXMubWF4IC10aGlzLm9wdGlvbnMub2Zmc2V0KTsKCQl0aGlzLnN0ZXAgPSB0aGlzLnRvU3RlcChwb3NpdGlvbik7CgkJdGhpcy5jaGVja1N0ZXAoKTsKCQl0aGlzLmVuZCgpOwoJCXRoaXMuZmlyZUV2ZW50KCdvblRpY2snLCBwb3NpdGlvbik7Cgl9LAoKCWRyYWdnZWRLbm9iOiBmdW5jdGlvbigpewoJCXRoaXMuc3RlcCA9IHRoaXMudG9TdGVwKHRoaXMuZHJhZy52YWx1ZS5ub3dbdGhpcy56XSk7CgkJdGhpcy5jaGVja1N0ZXAoKTsKCX0sCgoJY2hlY2tTdGVwOiBmdW5jdGlvbigpewoJCWlmICh0aGlzLnByZXZpb3VzQ2hhbmdlICE9IHRoaXMuc3RlcCl7CgkJCXRoaXMucHJldmlvdXNDaGFuZ2UgPSB0aGlzLnN0ZXA7CgkJCXRoaXMuZmlyZUV2ZW50KCdvbkNoYW5nZScsIHRoaXMuc3RlcCk7CgkJfQoJfSwKCgllbmQ6IGZ1bmN0aW9uKCl7CgkJaWYgKHRoaXMucHJldmlvdXNFbmQgIT09IHRoaXMuc3RlcCl7CgkJCXRoaXMucHJldmlvdXNFbmQgPSB0aGlzLnN0ZXA7CgkJCXRoaXMuZmlyZUV2ZW50KCdvbkNvbXBsZXRlJywgdGhpcy5zdGVwICsgJycpOwoJCX0KCX0sCgoJdG9TdGVwOiBmdW5jdGlvbihwb3NpdGlvbil7CgkJcmV0dXJuIE1hdGgucm91bmQoKHBvc2l0aW9uICsgdGhpcy5vcHRpb25zLm9mZnNldCkgLyB0aGlzLm1heCAqIHRoaXMub3B0aW9ucy5zdGVwcyk7Cgl9LAoKCXRvUG9zaXRpb246IGZ1bmN0aW9uKHN0ZXApewoJCXJldHVybiB0aGlzLm1heCAqIHN0ZXAgLyB0aGlzLm9wdGlvbnMuc3RlcHM7Cgl9Cgp9KTsKClNsaWRlci5pbXBsZW1lbnQobmV3IEV2ZW50cyk7ClNsaWRlci5pbXBsZW1lbnQobmV3IE9wdGlvbnMpOwoKLyoKU2NyaXB0OiBTbW9vdGhTY3JvbGwuanMKCUNvbnRhaW5zIDxTbW9vdGhTY3JvbGw+CgpMaWNlbnNlOgoJTUlULXN0eWxlIGxpY2Vuc2UuCiovCgovKgpDbGFzczogU21vb3RoU2Nyb2xsCglBdXRvIHRhcmdldHMgYWxsIHRoZSBhbmNob3JzIGluIGEgcGFnZSBhbmQgZGlzcGxheSBhIHNtb290aCBzY3JvbGxpbmcgZWZmZWN0IHVwb24gY2xpY2tpbmcgdGhlbS4KCUluaGVyaXRzIG1ldGhvZHMsIHByb3BlcnRpZXMsIG9wdGlvbnMgYW5kIGV2ZW50cyBmcm9tIDxGeC5TY3JvbGw+LgoKTm90ZToKCVNtb290aFNjcm9sbCByZXF1aXJlcyBhbiBYSFRNTCBkb2N0eXBlLgoKQXJndW1lbnRzOgoJb3B0aW9ucyAtIHRoZSBGeC5TY3JvbGwgb3B0aW9ucyAoc2VlOiA8RnguU2Nyb2xsPikgcGx1cyBsaW5rcywgYSBjb2xsZWN0aW9uIG9mIGVsZW1lbnRzIHlvdSB3YW50IHlvdXIgc21vb3Roc2Nyb2xsIG9uLiBEZWZhdWx0cyB0byBkb2N1bWVudC5saW5rcy4KCkV4YW1wbGU6Cgk+bmV3IFNtb290aFNjcm9sbCgpOwoqLwoKdmFyIFNtb290aFNjcm9sbCA9IEZ4LlNjcm9sbC5leHRlbmQoewoKCWluaXRpYWxpemU6IGZ1bmN0aW9uKG9wdGlvbnMpewoJCXRoaXMucGFyZW50KHdpbmRvdywgb3B0aW9ucyk7CgkJdGhpcy5saW5rcyA9ICh0aGlzLm9wdGlvbnMubGlua3MpID8gJCQodGhpcy5vcHRpb25zLmxpbmtzKSA6ICQkKGRvY3VtZW50LmxpbmtzKTsKCQl2YXIgbG9jYXRpb24gPSB3aW5kb3cubG9jYXRpb24uaHJlZi5tYXRjaCgvXlteI10qLylbMF0gKyAnIyc7CgkJdGhpcy5saW5rcy5lYWNoKGZ1bmN0aW9uKGxpbmspewoJCQlpZiAobGluay5ocmVmLmluZGV4T2YobG9jYXRpb24pICE9IDApIHJldHVybjsKCQkJdmFyIGFuY2hvciA9IGxpbmsuaHJlZi5zdWJzdHIobG9jYXRpb24ubGVuZ3RoKTsKCQkJaWYgKGFuY2hvciAmJiAkKGFuY2hvcikpIHRoaXMudXNlTGluayhsaW5rLCBhbmNob3IpOwoJCX0sIHRoaXMpOwoJCWlmICghd2luZG93LndlYmtpdDQxOSkgdGhpcy5hZGRFdmVudCgnb25Db21wbGV0ZScsIGZ1bmN0aW9uKCl7CgkJCXdpbmRvdy5sb2NhdGlvbi5oYXNoID0gdGhpcy5hbmNob3I7CgkJfSk7Cgl9LAoKCXVzZUxpbms6IGZ1bmN0aW9uKGxpbmssIGFuY2hvcil7CgkJbGluay5hZGRFdmVudCgnY2xpY2snLCBmdW5jdGlvbihldmVudCl7CgkJCXRoaXMuYW5jaG9yID0gYW5jaG9yOwoJCQl0aGlzLnRvRWxlbWVudChhbmNob3IpOwoJCQlldmVudC5zdG9wKCk7CgkJfS5iaW5kV2l0aEV2ZW50KHRoaXMpKTsKCX0KCn0pOwoKLyoKU2NyaXB0OiBTb3J0YWJsZXMuanMKCUNvbnRhaW5zIDxTb3J0YWJsZXM+IENsYXNzLgoKTGljZW5zZToKCU1JVC1zdHlsZSBsaWNlbnNlLgoqLwoKLyoKQ2xhc3M6IFNvcnRhYmxlcwoJQ3JlYXRlcyBhbiBpbnRlcmZhY2UgZm9yIDxEcmFnLkJhc2U+IGFuZCBkcm9wLCByZXNvcnRpbmcgb2YgYSBsaXN0LgoKTm90ZToKCVRoZSBTb3J0YWJsZXMgcmVxdWlyZSBhbiBYSFRNTCBkb2N0eXBlLgoKQXJndW1lbnRzOgoJbGlzdCAtIHJlcXVpcmVkLCB0aGUgbGlzdCB0aGF0IHdpbGwgYmVjb21lIHNvcnRhYmxlLgoJb3B0aW9ucyAtIGFuIE9iamVjdCwgc2VlIG9wdGlvbnMgYmVsb3cuCgpPcHRpb25zOgoJaGFuZGxlcyAtIGEgY29sbGVjdGlvbiBvZiBlbGVtZW50cyB0byBiZSB1c2VkIGZvciBkcmFnIGhhbmRsZXMuIGRlZmF1bHRzIHRvIHRoZSBlbGVtZW50cy4KCkV2ZW50czoKCW9uU3RhcnQgLSBmdW5jdGlvbiBleGVjdXRlZCB3aGVuIHRoZSBpdGVtIHN0YXJ0cyBkcmFnZ2luZwoJb25Db21wbGV0ZSAtIGZ1bmN0aW9uIGV4ZWN1dGVkIHdoZW4gdGhlIGl0ZW0gZW5kcyBkcmFnZ2luZwoqLwoKdmFyIFNvcnRhYmxlcyA9IG5ldyBDbGFzcyh7CgoJb3B0aW9uczogewoJCWhhbmRsZXM6IGZhbHNlLAoJCW9uU3RhcnQ6IENsYXNzLmVtcHR5LAoJCW9uQ29tcGxldGU6IENsYXNzLmVtcHR5LAoJCWdob3N0OiB0cnVlLAoJCXNuYXA6IDMsCgkJb25EcmFnU3RhcnQ6IGZ1bmN0aW9uKGVsZW1lbnQsIGdob3N0KXsKCQkJZ2hvc3Quc2V0U3R5bGUoJ29wYWNpdHknLCAwLjcpOwoJCQllbGVtZW50LnNldFN0eWxlKCdvcGFjaXR5JywgMC43KTsKCQl9LAoJCW9uRHJhZ0NvbXBsZXRlOiBmdW5jdGlvbihlbGVtZW50LCBnaG9zdCl7CgkJCWVsZW1lbnQuc2V0U3R5bGUoJ29wYWNpdHknLCAxKTsKCQkJZ2hvc3QucmVtb3ZlKCk7CgkJCXRoaXMudHJhc2gucmVtb3ZlKCk7CgkJfQoJfSwKCglpbml0aWFsaXplOiBmdW5jdGlvbihsaXN0LCBvcHRpb25zKXsKCQl0aGlzLnNldE9wdGlvbnMob3B0aW9ucyk7CgkJdGhpcy5saXN0ID0gJChsaXN0KTsKCQl0aGlzLmVsZW1lbnRzID0gdGhpcy5saXN0LmdldENoaWxkcmVuKCk7CgkJdGhpcy5oYW5kbGVzID0gKHRoaXMub3B0aW9ucy5oYW5kbGVzKSA/ICQkKHRoaXMub3B0aW9ucy5oYW5kbGVzKSA6IHRoaXMuZWxlbWVudHM7CgkJdGhpcy5ib3VuZCA9IHsKCQkJJ3N0YXJ0JzogW10sCgkJCSdtb3ZlR2hvc3QnOiB0aGlzLm1vdmVHaG9zdC5iaW5kV2l0aEV2ZW50KHRoaXMpCgkJfTsKCQlmb3IgKHZhciBpID0gMCwgbCA9IHRoaXMuaGFuZGxlcy5sZW5ndGg7IGkgPCBsOyBpKyspewoJCQl0aGlzLmJvdW5kLnN0YXJ0W2ldID0gdGhpcy5zdGFydC5iaW5kV2l0aEV2ZW50KHRoaXMsIHRoaXMuZWxlbWVudHNbaV0pOwoJCX0KCQl0aGlzLmF0dGFjaCgpOwoJCWlmICh0aGlzLm9wdGlvbnMuaW5pdGlhbGl6ZSkgdGhpcy5vcHRpb25zLmluaXRpYWxpemUuY2FsbCh0aGlzKTsKCQl0aGlzLmJvdW5kLm1vdmUgPSB0aGlzLm1vdmUuYmluZFdpdGhFdmVudCh0aGlzKTsKCQl0aGlzLmJvdW5kLmVuZCA9IHRoaXMuZW5kLmJpbmQodGhpcyk7Cgl9LAoKCWF0dGFjaDogZnVuY3Rpb24oKXsKCQl0aGlzLmhhbmRsZXMuZWFjaChmdW5jdGlvbihoYW5kbGUsIGkpewoJCQloYW5kbGUuYWRkRXZlbnQoJ21vdXNlZG93bicsIHRoaXMuYm91bmQuc3RhcnRbaV0pOwoJCX0sIHRoaXMpOwoJfSwKCglkZXRhY2g6IGZ1bmN0aW9uKCl7CgkJdGhpcy5oYW5kbGVzLmVhY2goZnVuY3Rpb24oaGFuZGxlLCBpKXsKCQkJaGFuZGxlLnJlbW92ZUV2ZW50KCdtb3VzZWRvd24nLCB0aGlzLmJvdW5kLnN0YXJ0W2ldKTsKCQl9LCB0aGlzKTsKCX0sCgoJc3RhcnQ6IGZ1bmN0aW9uKGV2ZW50LCBlbCl7CgkJdGhpcy5hY3RpdmUgPSBlbDsKCQl0aGlzLmNvb3JkaW5hdGVzID0gdGhpcy5saXN0LmdldENvb3JkaW5hdGVzKCk7CgkJaWYgKHRoaXMub3B0aW9ucy5naG9zdCl7CgkJCXZhciBwb3NpdGlvbiA9IGVsLmdldFBvc2l0aW9uKCk7CgkJCXRoaXMub2Zmc2V0ID0gZXZlbnQucGFnZS55IC0gcG9zaXRpb24ueTsKCQkJdGhpcy50cmFzaCA9IG5ldyBFbGVtZW50KCdkaXYnKS5pbmplY3QoZG9jdW1lbnQuYm9keSk7CgkJCXRoaXMuZ2hvc3QgPSBlbC5jbG9uZSgpLmluamVjdCh0aGlzLnRyYXNoKS5zZXRTdHlsZXMoewoJCQkJJ3Bvc2l0aW9uJzogJ2Fic29sdXRlJywKCQkJCSdsZWZ0JzogcG9zaXRpb24ueCwKCQkJCSd0b3AnOiBldmVudC5wYWdlLnkgLSB0aGlzLm9mZnNldAoJCQl9KTsKCQkJZG9jdW1lbnQuYWRkTGlzdGVuZXIoJ21vdXNlbW92ZScsIHRoaXMuYm91bmQubW92ZUdob3N0KTsKCQkJdGhpcy5maXJlRXZlbnQoJ29uRHJhZ1N0YXJ0JywgW2VsLCB0aGlzLmdob3N0XSk7CgkJfQoJCWRvY3VtZW50LmFkZExpc3RlbmVyKCdtb3VzZW1vdmUnLCB0aGlzLmJvdW5kLm1vdmUpOwoJCWRvY3VtZW50LmFkZExpc3RlbmVyKCdtb3VzZXVwJywgdGhpcy5ib3VuZC5lbmQpOwoJCXRoaXMuZmlyZUV2ZW50KCdvblN0YXJ0JywgZWwpOwoJCWV2ZW50LnN0b3AoKTsKCX0sCgoJbW92ZUdob3N0OiBmdW5jdGlvbihldmVudCl7CgkJdmFyIHZhbHVlID0gZXZlbnQucGFnZS55IC0gdGhpcy5vZmZzZXQ7CgkJdmFsdWUgPSB2YWx1ZS5saW1pdCh0aGlzLmNvb3JkaW5hdGVzLnRvcCwgdGhpcy5jb29yZGluYXRlcy5ib3R0b20gLSB0aGlzLmdob3N0Lm9mZnNldEhlaWdodCk7CgkJdGhpcy5naG9zdC5zZXRTdHlsZSgndG9wJywgdmFsdWUpOwoJCWV2ZW50LnN0b3AoKTsKCX0sCgoJbW92ZTogZnVuY3Rpb24oZXZlbnQpewoJCXZhciBub3cgPSBldmVudC5wYWdlLnk7CgkJdGhpcy5wcmV2aW91cyA9IHRoaXMucHJldmlvdXMgfHwgbm93OwoJCXZhciB1cCA9ICgodGhpcy5wcmV2aW91cyAtIG5vdykgPiAwKTsKCQl2YXIgcHJldiA9IHRoaXMuYWN0aXZlLmdldFByZXZpb3VzKCk7CgkJdmFyIG5leHQgPSB0aGlzLmFjdGl2ZS5nZXROZXh0KCk7CgkJaWYgKHByZXYgJiYgdXAgJiYgbm93IDwgcHJldi5nZXRDb29yZGluYXRlcygpLmJvdHRvbSkgdGhpcy5hY3RpdmUuaW5qZWN0QmVmb3JlKHByZXYpOwoJCWlmIChuZXh0ICYmICF1cCAmJiBub3cgPiBuZXh0LmdldENvb3JkaW5hdGVzKCkudG9wKSB0aGlzLmFjdGl2ZS5pbmplY3RBZnRlcihuZXh0KTsKCQl0aGlzLnByZXZpb3VzID0gbm93OwoJfSwKCglzZXJpYWxpemU6IGZ1bmN0aW9uKGNvbnZlcnRlcil7CgkJcmV0dXJuIHRoaXMubGlzdC5nZXRDaGlsZHJlbigpLm1hcChjb252ZXJ0ZXIgfHwgZnVuY3Rpb24oZWwpewoJCQlyZXR1cm4gdGhpcy5lbGVtZW50cy5pbmRleE9mKGVsKTsKCQl9LCB0aGlzKTsKCX0sCgoJZW5kOiBmdW5jdGlvbigpewoJCXRoaXMucHJldmlvdXMgPSBudWxsOwoJCWRvY3VtZW50LnJlbW92ZUxpc3RlbmVyKCdtb3VzZW1vdmUnLCB0aGlzLmJvdW5kLm1vdmUpOwoJCWRvY3VtZW50LnJlbW92ZUxpc3RlbmVyKCdtb3VzZXVwJywgdGhpcy5ib3VuZC5lbmQpOwoJCWlmICh0aGlzLm9wdGlvbnMuZ2hvc3QpewoJCQlkb2N1bWVudC5yZW1vdmVMaXN0ZW5lcignbW91c2Vtb3ZlJywgdGhpcy5ib3VuZC5tb3ZlR2hvc3QpOwoJCQl0aGlzLmZpcmVFdmVudCgnb25EcmFnQ29tcGxldGUnLCBbdGhpcy5hY3RpdmUsIHRoaXMuZ2hvc3RdKTsKCQl9CgkJdGhpcy5maXJlRXZlbnQoJ29uQ29tcGxldGUnLCB0aGlzLmFjdGl2ZSk7Cgl9Cgp9KTsKClNvcnRhYmxlcy5pbXBsZW1lbnQobmV3IEV2ZW50cywgbmV3IE9wdGlvbnMpOwoKLyoKU2NyaXB0OiBUaXBzLmpzCglUb29sdGlwcywgQnViYmxlVGlwcywgd2hhdGV2ZXIgdGhleSBhcmUsIHRoZXkgd2lsbCBhcHBlYXIgb24gbW91c2VvdmVyCgpMaWNlbnNlOgoJTUlULXN0eWxlIGxpY2Vuc2UuCgpDcmVkaXRzOgoJVGhlIGlkZWEgYmVoaW5kIFRpcHMuanMgaXMgYmFzZWQgb24gQnViYmxlIFRvb2x0aXBzICg8aHR0cDovL3dlYi1ncmFwaGljcy5jb20vbXRhcmNoaXZlLzAwMTcxNy5waHA+KSBieSBBbGVzc2FuZHJvIEZ1bGNpdGluaXRpIDxodHRwOi8vd2ViLWdyYXBoaWNzLmNvbT4KKi8KCi8qCkNsYXNzOiBUaXBzCglEaXNwbGF5IGEgdGlwIG9uIGFueSBlbGVtZW50IHdpdGggYSB0aXRsZSBhbmQvb3IgaHJlZi4KCk5vdGU6CglUaXBzIHJlcXVpcmVzIGFuIFhIVE1MIGRvY3R5cGUuCgpBcmd1bWVudHM6CgllbGVtZW50cyAtIGEgY29sbGVjdGlvbiBvZiBlbGVtZW50cyB0byBhcHBseSB0aGUgdG9vbHRpcHMgdG8gb24gbW91c2VvdmVyLgoJb3B0aW9ucyAtIGFuIG9iamVjdC4gU2VlIG9wdGlvbnMgQmVsb3cuCgpPcHRpb25zOgoJbWF4VGl0bGVDaGFycyAtIHRoZSBtYXhpbXVtIG51bWJlciBvZiBjaGFyYWN0ZXJzIHRvIGRpc3BsYXkgaW4gdGhlIHRpdGxlIG9mIHRoZSB0aXAuIGRlZmF1bHRzIHRvIDMwLgoJc2hvd0RlbGF5IC0gdGhlIGRlbGF5IHRoZSBvblNob3cgbWV0aG9kIGlzIGNhbGxlZC4gKGRlZmF1bHRzIHRvIDEwMCBtcykKCWhpZGVEZWxheSAtIHRoZSBkZWxheSB0aGUgb25IaWRlIG1ldGhvZCBpcyBjYWxsZWQuIChkZWZhdWx0cyB0byAxMDAgbXMpCgoJY2xhc3NOYW1lIC0gdGhlIHByZWZpeCBmb3IgeW91ciB0b29sdGlwIGNsYXNzTmFtZXMuIGRlZmF1bHRzIHRvICd0b29sJy4KCgkJdGhlIHdob2xlIHRvb2x0aXAgd2lsbCBoYXZlIGFzIGNsYXNzbmFtZTogdG9vbC10aXAKCgkJdGhlIHRpdGxlIHdpbGwgaGF2ZSBhcyBjbGFzc25hbWU6IHRvb2wtdGl0bGUKCgkJdGhlIHRleHQgd2lsbCBoYXZlIGFzIGNsYXNzbmFtZTogdG9vbC10ZXh0CgoJb2Zmc2V0cyAtIHRoZSBkaXN0YW5jZSBvZiB5b3VyIHRvb2x0aXAgZnJvbSB0aGUgbW91c2UuIGFuIE9iamVjdCB3aXRoIHgveSBwcm9wZXJ0aWVzLgoJZml4ZWQgLSBpZiBzZXQgdG8gdHJ1ZSwgdGhlIHRvb2xUaXAgd2lsbCBub3QgZm9sbG93IHRoZSBtb3VzZS4KCkV2ZW50czoKCW9uU2hvdyAtIG9wdGlvbmFsbHkgeW91IGNhbiBhbHRlciB0aGUgZGVmYXVsdCBvblNob3cgYmVoYXZpb3VyIHdpdGggdGhpcyBvcHRpb24gKGxpa2UgZGlzcGxheWluZyBhIGZhZGUgaW4gZWZmZWN0KTsKCW9uSGlkZSAtIG9wdGlvbmFsbHkgeW91IGNhbiBhbHRlciB0aGUgZGVmYXVsdCBvbkhpZGUgYmVoYXZpb3VyIHdpdGggdGhpcyBvcHRpb24gKGxpa2UgZGlzcGxheWluZyBhIGZhZGUgb3V0IGVmZmVjdCk7CgpFeGFtcGxlOgoJKHN0YXJ0IGNvZGUpCgk8aW1nIHNyYz0iL2ltYWdlcy9pLnBuZyIgdGl0bGU9IlRoZSBib2R5IG9mIHRoZSB0b29sdGlwIGlzIHN0b3JlZCBpbiB0aGUgdGl0bGUiIGNsYXNzPSJ0b29sVGlwSW1nIi8+Cgk8c2NyaXB0PgoJCXZhciBteVRpcHMgPSBuZXcgVGlwcygkJCgnLnRvb2xUaXBJbWcnKSwgewoJCQltYXhUaXRsZUNoYXJzOiA1MAkvL0kgbGlrZSBteSBjYXB0aW9ucyBhIGxpdHRsZSBsb25nCgkJfSk7Cgk8L3NjcmlwdD4KCShlbmQpCgpOb3RlOgoJVGhlIHRpdGxlIG9mIHRoZSBlbGVtZW50IHdpbGwgYWx3YXlzIGJlIHVzZWQgYXMgdGhlIHRvb2x0aXAgYm9keS4gSWYgeW91IHB1dCA6OiBvbiB5b3VyIHRpdGxlLCB0aGUgdGV4dCBiZWZvcmUgOjogd2lsbCBiZWNvbWUgdGhlIHRvb2x0aXAgdGl0bGUuCiovCgp2YXIgVGlwcyA9IG5ldyBDbGFzcyh7CgoJb3B0aW9uczogewoJCW9uU2hvdzogZnVuY3Rpb24odGlwKXsKCQkJdGlwLnNldFN0eWxlKCd2aXNpYmlsaXR5JywgJ3Zpc2libGUnKTsKCQl9LAoJCW9uSGlkZTogZnVuY3Rpb24odGlwKXsKCQkJdGlwLnNldFN0eWxlKCd2aXNpYmlsaXR5JywgJ2hpZGRlbicpOwoJCX0sCgkJbWF4VGl0bGVDaGFyczogMzAsCgkJc2hvd0RlbGF5OiAxMDAsCgkJaGlkZURlbGF5OiAxMDAsCgkJY2xhc3NOYW1lOiAndG9vbCcsCgkJb2Zmc2V0czogeyd4JzogMTYsICd5JzogMTZ9LAoJCWZpeGVkOiBmYWxzZQoJfSwKCglpbml0aWFsaXplOiBmdW5jdGlvbihlbGVtZW50cywgb3B0aW9ucyl7CgkJdGhpcy5zZXRPcHRpb25zKG9wdGlvbnMpOwoJCXRoaXMudG9vbFRpcCA9IG5ldyBFbGVtZW50KCdkaXYnLCB7CgkJCSdjbGFzcyc6IHRoaXMub3B0aW9ucy5jbGFzc05hbWUgKyAnLXRpcCcsCgkJCSdzdHlsZXMnOiB7CgkJCQkncG9zaXRpb24nOiAnYWJzb2x1dGUnLAoJCQkJJ3RvcCc6ICcwJywKCQkJCSdsZWZ0JzogJzAnLAoJCQkJJ3Zpc2liaWxpdHknOiAnaGlkZGVuJwoJCQl9CgkJfSkuaW5qZWN0KGRvY3VtZW50LmJvZHkpOwoJCXRoaXMud3JhcHBlciA9IG5ldyBFbGVtZW50KCdkaXYnKS5pbmplY3QodGhpcy50b29sVGlwKTsKCQkkJChlbGVtZW50cykuZWFjaCh0aGlzLmJ1aWxkLCB0aGlzKTsKCQlpZiAodGhpcy5vcHRpb25zLmluaXRpYWxpemUpIHRoaXMub3B0aW9ucy5pbml0aWFsaXplLmNhbGwodGhpcyk7Cgl9LAoKCWJ1aWxkOiBmdW5jdGlvbihlbCl7CgkJZWwuJHRtcC5teVRpdGxlID0gKGVsLmhyZWYgJiYgZWwuZ2V0VGFnKCkgPT0gJ2EnKSA/IGVsLmhyZWYucmVwbGFjZSgnaHR0cDovLycsICcnKSA6IChlbC5yZWwgfHwgZmFsc2UpOwoJCWlmIChlbC50aXRsZSl7CgkJCXZhciBkdWFsID0gZWwudGl0bGUuc3BsaXQoJzo6Jyk7CgkJCWlmIChkdWFsLmxlbmd0aCA+IDEpewoJCQkJZWwuJHRtcC5teVRpdGxlID0gZHVhbFswXS50cmltKCk7CgkJCQllbC4kdG1wLm15VGV4dCA9IGR1YWxbMV0udHJpbSgpOwoJCQl9IGVsc2UgewoJCQkJZWwuJHRtcC5teVRleHQgPSBlbC50aXRsZTsKCQkJfQoJCQllbC5yZW1vdmVBdHRyaWJ1dGUoJ3RpdGxlJyk7CgkJfSBlbHNlIHsKCQkJZWwuJHRtcC5teVRleHQgPSBmYWxzZTsKCQl9CgkJaWYgKGVsLiR0bXAubXlUaXRsZSAmJiBlbC4kdG1wLm15VGl0bGUubGVuZ3RoID4gdGhpcy5vcHRpb25zLm1heFRpdGxlQ2hhcnMpIGVsLiR0bXAubXlUaXRsZSA9IGVsLiR0bXAubXlUaXRsZS5zdWJzdHIoMCwgdGhpcy5vcHRpb25zLm1heFRpdGxlQ2hhcnMgLSAxKSArICImaGVsbGlwOyI7CgkJZWwuYWRkRXZlbnQoJ21vdXNlZW50ZXInLCBmdW5jdGlvbihldmVudCl7CgkJCXRoaXMuc3RhcnQoZWwpOwoJCQlpZiAoIXRoaXMub3B0aW9ucy5maXhlZCkgdGhpcy5sb2NhdGUoZXZlbnQpOwoJCQllbHNlIHRoaXMucG9zaXRpb24oZWwpOwoJCX0uYmluZCh0aGlzKSk7CgkJaWYgKCF0aGlzLm9wdGlvbnMuZml4ZWQpIGVsLmFkZEV2ZW50KCdtb3VzZW1vdmUnLCB0aGlzLmxvY2F0ZS5iaW5kV2l0aEV2ZW50KHRoaXMpKTsKCQl2YXIgZW5kID0gdGhpcy5lbmQuYmluZCh0aGlzKTsKCQllbC5hZGRFdmVudCgnbW91c2VsZWF2ZScsIGVuZCk7CgkJZWwuYWRkRXZlbnQoJ3RyYXNoJywgZW5kKTsKCX0sCgoJc3RhcnQ6IGZ1bmN0aW9uKGVsKXsKCQl0aGlzLndyYXBwZXIuZW1wdHkoKTsKCQlpZiAoZWwuJHRtcC5teVRpdGxlKXsKCQkJdGhpcy50aXRsZSA9IG5ldyBFbGVtZW50KCdzcGFuJykuaW5qZWN0KG5ldyBFbGVtZW50KCdkaXYnLCB7J2NsYXNzJzogdGhpcy5vcHRpb25zLmNsYXNzTmFtZSArICctdGl0bGUnfSkuaW5qZWN0KHRoaXMud3JhcHBlcikpLnNldEhUTUwoZWwuJHRtcC5teVRpdGxlKTsKCQl9CgkJaWYgKGVsLiR0bXAubXlUZXh0KXsKCQkJdGhpcy50ZXh0ID0gbmV3IEVsZW1lbnQoJ3NwYW4nKS5pbmplY3QobmV3IEVsZW1lbnQoJ2RpdicsIHsnY2xhc3MnOiB0aGlzLm9wdGlvbnMuY2xhc3NOYW1lICsgJy10ZXh0J30pLmluamVjdCh0aGlzLndyYXBwZXIpKS5zZXRIVE1MKGVsLiR0bXAubXlUZXh0KTsKCQl9CgkJJGNsZWFyKHRoaXMudGltZXIpOwoJCXRoaXMudGltZXIgPSB0aGlzLnNob3cuZGVsYXkodGhpcy5vcHRpb25zLnNob3dEZWxheSwgdGhpcyk7Cgl9LAoKCWVuZDogZnVuY3Rpb24oZXZlbnQpewoJCSRjbGVhcih0aGlzLnRpbWVyKTsKCQl0aGlzLnRpbWVyID0gdGhpcy5oaWRlLmRlbGF5KHRoaXMub3B0aW9ucy5oaWRlRGVsYXksIHRoaXMpOwoJfSwKCglwb3NpdGlvbjogZnVuY3Rpb24oZWxlbWVudCl7CgkJdmFyIHBvcyA9IGVsZW1lbnQuZ2V0UG9zaXRpb24oKTsKCQl0aGlzLnRvb2xUaXAuc2V0U3R5bGVzKHsKCQkJJ2xlZnQnOiBwb3MueCArIHRoaXMub3B0aW9ucy5vZmZzZXRzLngsCgkJCSd0b3AnOiBwb3MueSArIHRoaXMub3B0aW9ucy5vZmZzZXRzLnkKCQl9KTsKCX0sCgoJbG9jYXRlOiBmdW5jdGlvbihldmVudCl7CgkJdmFyIHdpbiA9IHsneCc6IHdpbmRvdy5nZXRXaWR0aCgpLCAneSc6IHdpbmRvdy5nZXRIZWlnaHQoKX07CgkJdmFyIHNjcm9sbCA9IHsneCc6IHdpbmRvdy5nZXRTY3JvbGxMZWZ0KCksICd5Jzogd2luZG93LmdldFNjcm9sbFRvcCgpfTsKCQl2YXIgdGlwID0geyd4JzogdGhpcy50b29sVGlwLm9mZnNldFdpZHRoLCAneSc6IHRoaXMudG9vbFRpcC5vZmZzZXRIZWlnaHR9OwoJCXZhciBwcm9wID0geyd4JzogJ2xlZnQnLCAneSc6ICd0b3AnfTsKCQlmb3IgKHZhciB6IGluIHByb3ApewoJCQl2YXIgcG9zID0gZXZlbnQucGFnZVt6XSArIHRoaXMub3B0aW9ucy5vZmZzZXRzW3pdOwoJCQlpZiAoKHBvcyArIHRpcFt6XSAtIHNjcm9sbFt6XSkgPiB3aW5bel0pIHBvcyA9IGV2ZW50LnBhZ2Vbel0gLSB0aGlzLm9wdGlvbnMub2Zmc2V0c1t6XSAtIHRpcFt6XTsKCQkJdGhpcy50b29sVGlwLnNldFN0eWxlKHByb3Bbel0sIHBvcyk7CgkJfTsKCX0sCgoJc2hvdzogZnVuY3Rpb24oKXsKCQlpZiAodGhpcy5vcHRpb25zLnRpbWVvdXQpIHRoaXMudGltZXIgPSB0aGlzLmhpZGUuZGVsYXkodGhpcy5vcHRpb25zLnRpbWVvdXQsIHRoaXMpOwoJCXRoaXMuZmlyZUV2ZW50KCdvblNob3cnLCBbdGhpcy50b29sVGlwXSk7Cgl9LAoKCWhpZGU6IGZ1bmN0aW9uKCl7CgkJdGhpcy5maXJlRXZlbnQoJ29uSGlkZScsIFt0aGlzLnRvb2xUaXBdKTsKCX0KCn0pOwoKVGlwcy5pbXBsZW1lbnQobmV3IEV2ZW50cywgbmV3IE9wdGlvbnMpOwoKLyoKU2NyaXB0OiBHcm91cC5qcwoJRm9yIEdyb3VwaW5nIENsYXNzZXMgb3IgRWxlbWVudHMgRXZlbnRzLiBUaGUgRXZlbnQgYWRkZWQgdG8gdGhlIEdyb3VwIHdpbGwgZmlyZSB3aGVuIGFsbCBvZiB0aGUgZXZlbnRzIG9mIHRoZSBpdGVtcyBvZiB0aGUgZ3JvdXAgYXJlIGZpcmVkLgoKTGljZW5zZToKCU1JVC1zdHlsZSBsaWNlbnNlLgoqLwoKLyoKQ2xhc3M6IEdyb3VwCglBbiAiVXRpbGl0eSIgQ2xhc3MuCgpBcmd1bWVudHM6CglMaXN0IG9mIENsYXNzIGluc3RhbmNlcwoKRXhhbXBsZToKCShzdGFydCBjb2RlKQoJeGhyMSA9IG5ldyBBamF4KCdkYXRhLmpzJywge2V2YWxTY3JpcHQ6IHRydWV9KTsKCXhocjIgPSBuZXcgQWpheCgnYWJzdHJhY3Rpb24uanMnLCB7ZXZhbFNjcmlwdDogdHJ1ZX0pOwoJeGhyMyA9IG5ldyBBamF4KCd0ZW1wbGF0ZS5qcycsIHtldmFsU2NyaXB0OiB0cnVlfSk7CgoJdmFyIGdyb3VwID0gbmV3IEdyb3VwKHhocjEsIHhocjIsIHhocjMpOwoJZ3JvdXAuYWRkRXZlbnQoJ29uQ29tcGxldGUnLCBmdW5jdGlvbigpewoJCWFsZXJ0KCdBbGwgU2NyaXB0cyBsb2FkZWQnKTsKCX0pOwoKCXhocjEucmVxdWVzdCgpOwoJeGhyMi5yZXF1ZXN0KCk7Cgl4aHIzLnJlcXVlc3QoKTsKCShlbmQpCgoqLwoKdmFyIEdyb3VwID0gbmV3IENsYXNzKHsKCglpbml0aWFsaXplOiBmdW5jdGlvbigpewoJCXRoaXMuaW5zdGFuY2VzID0gJEEoYXJndW1lbnRzKTsKCQl0aGlzLmV2ZW50cyA9IHt9OwoJCXRoaXMuY2hlY2tlciA9IHt9OwoJfSwKCgkvKgoJUHJvcGVydHk6IGFkZEV2ZW50CgkJYWRkcyBhbiBldmVudCB0byB0aGUgc3RhY2sgb2YgZXZlbnRzIG9mIHRoZSBDbGFzcyBpbnN0YW5jZXMuCgoJQXJndW1lbnRzOgoJCXR5cGUgLSBzdHJpbmc7IHRoZSBldmVudCBuYW1lIChlLmcuICdvbkNvbXBsZXRlJykKCQlmbiAtIGZ1bmN0aW9uIHRvIGV4ZWN1dGUgd2hlbiBhbGwgaW5zdGFuY2VzIGZpcmVkIHRoaXMgZXZlbnQKCSovCgoJYWRkRXZlbnQ6IGZ1bmN0aW9uKHR5cGUsIGZuKXsKCQl0aGlzLmNoZWNrZXJbdHlwZV0gPSB0aGlzLmNoZWNrZXJbdHlwZV0gfHwge307CgkJdGhpcy5ldmVudHNbdHlwZV0gPSB0aGlzLmV2ZW50c1t0eXBlXSB8fCBbXTsKCQlpZiAodGhpcy5ldmVudHNbdHlwZV0uY29udGFpbnMoZm4pKSByZXR1cm4gZmFsc2U7CgkJZWxzZSB0aGlzLmV2ZW50c1t0eXBlXS5wdXNoKGZuKTsKCQl0aGlzLmluc3RhbmNlcy5lYWNoKGZ1bmN0aW9uKGluc3RhbmNlLCBpKXsKCQkJaW5zdGFuY2UuYWRkRXZlbnQodHlwZSwgdGhpcy5jaGVjay5iaW5kKHRoaXMsIFt0eXBlLCBpbnN0YW5jZSwgaV0pKTsKCQl9LCB0aGlzKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJY2hlY2s6IGZ1bmN0aW9uKHR5cGUsIGluc3RhbmNlLCBpKXsKCQl0aGlzLmNoZWNrZXJbdHlwZV1baV0gPSB0cnVlOwoJCXZhciBldmVyeSA9IHRoaXMuaW5zdGFuY2VzLmV2ZXJ5KGZ1bmN0aW9uKGN1cnJlbnQsIGopewoJCQlyZXR1cm4gdGhpcy5jaGVja2VyW3R5cGVdW2pdIHx8IGZhbHNlOwoJCX0sIHRoaXMpOwoJCWlmICghZXZlcnkpIHJldHVybjsKCQl0aGlzLmNoZWNrZXJbdHlwZV0gPSB7fTsKCQl0aGlzLmV2ZW50c1t0eXBlXS5lYWNoKGZ1bmN0aW9uKGV2ZW50KXsKCQkJZXZlbnQuY2FsbCh0aGlzLCB0aGlzLmluc3RhbmNlcywgaW5zdGFuY2UpOwoJCX0sIHRoaXMpOwoJfQoKfSk7CgovKgpTY3JpcHQ6IEFjY29yZGlvbi5qcwoJQ29udGFpbnMgPEFjY29yZGlvbj4KCkxpY2Vuc2U6CglNSVQtc3R5bGUgbGljZW5zZS4KKi8KCi8qCkNsYXNzOiBBY2NvcmRpb24KCVRoZSBBY2NvcmRpb24gY2xhc3MgY3JlYXRlcyBhIGdyb3VwIG9mIGVsZW1lbnRzIHRoYXQgYXJlIHRvZ2dsZWQgd2hlbiB0aGVpciBoYW5kbGVzIGFyZSBjbGlja2VkLiBXaGVuIG9uZSBlbGVtZW50cyB0b2dnbGVzIGluLCB0aGUgb3RoZXJzIHRvZ2dsZXMgYmFjay4KCUluaGVyaXRzIG1ldGhvZHMsIHByb3BlcnRpZXMsIG9wdGlvbnMgYW5kIGV2ZW50cyBmcm9tIDxGeC5FbGVtZW50cz4uCgpOb3RlOgoJVGhlIEFjY29yZGlvbiByZXF1aXJlcyBhbiBYSFRNTCBkb2N0eXBlLgoKQXJndW1lbnRzOgoJdG9nZ2xlcnMgLSByZXF1aXJlZCwgYSBjb2xsZWN0aW9uIG9mIGVsZW1lbnRzLCB0aGUgZWxlbWVudHMgaGFuZGxlcnMgdGhhdCB3aWxsIGJlIGNsaWNrYWJsZS4KCWVsZW1lbnRzIC0gcmVxdWlyZWQsIGEgY29sbGVjdGlvbiBvZiBlbGVtZW50cyB0aGUgdHJhbnNpdGlvbnMgd2lsbCBiZSBhcHBsaWVkIHRvLgoJb3B0aW9ucyAtIG9wdGlvbmFsLCBzZWUgb3B0aW9ucyBiZWxvdywgYW5kIDxGeC5CYXNlPiBvcHRpb25zIGFuZCBldmVudHMuCgpPcHRpb25zOgoJc2hvdyAtIGludGVnZXIsIHRoZSBJbmRleCBvZiB0aGUgZWxlbWVudCB0byBzaG93IGF0IHN0YXJ0LgoJZGlzcGxheSAtIGludGVnZXIsIHRoZSBJbmRleCBvZiB0aGUgZWxlbWVudCB0byBzaG93IGF0IHN0YXJ0ICh3aXRoIGEgdHJhbnNpdGlvbikuIGRlZmF1bHRzIHRvIDAuCglmaXhlZEhlaWdodCAtIGludGVnZXIsIGlmIHlvdSB3YW50IHRoZSBlbGVtZW50cyB0byBoYXZlIGEgZml4ZWQgaGVpZ2h0LiBkZWZhdWx0cyB0byBmYWxzZS4KCWZpeGVkV2lkdGggLSBpbnRlZ2VyLCBpZiB5b3Ugd2FudCB0aGUgZWxlbWVudHMgdG8gaGF2ZSBhIGZpeGVkIHdpZHRoLiBkZWZhdWx0cyB0byBmYWxzZS4KCWhlaWdodCAtIGJvb2xlYW4sIHdpbGwgYWRkIGEgaGVpZ2h0IHRyYW5zaXRpb24gdG8gdGhlIGFjY29yZGlvbiBpZiB0cnVlLiBkZWZhdWx0cyB0byB0cnVlLgoJb3BhY2l0eSAtIGJvb2xlYW4sIHdpbGwgYWRkIGFuIG9wYWNpdHkgdHJhbnNpdGlvbiB0byB0aGUgYWNjb3JkaW9uIGlmIHRydWUuIGRlZmF1bHRzIHRvIHRydWUuCgl3aWR0aCAtIGJvb2xlYW4sIHdpbGwgYWRkIGEgd2lkdGggdHJhbnNpdGlvbiB0byB0aGUgYWNjb3JkaW9uIGlmIHRydWUuIGRlZmF1bHRzIHRvIGZhbHNlLCBjc3MgbWFzdGVyeSBpcyByZXF1aXJlZCB0byBtYWtlIHRoaXMgd29yayEKCWFsd2F5c0hpZGUgLSBib29sZWFuLCB3aWxsIGFsbG93IHRvIGhpZGUgYWxsIGVsZW1lbnRzIGlmIHRydWUsIGluc3RlYWQgb2YgYWx3YXlzIGtlZXBpbmcgb25lIGVsZW1lbnQgc2hvd24uIGRlZmF1bHRzIHRvIGZhbHNlLgoKRXZlbnRzOgoJb25BY3RpdmUgLSBmdW5jdGlvbiB0byBleGVjdXRlIHdoZW4gYW4gZWxlbWVudCBzdGFydHMgdG8gc2hvdwoJb25CYWNrZ3JvdW5kIC0gZnVuY3Rpb24gdG8gZXhlY3V0ZSB3aGVuIGFuIGVsZW1lbnQgc3RhcnRzIHRvIGhpZGUKKi8KCnZhciBBY2NvcmRpb24gPSBGeC5FbGVtZW50cy5leHRlbmQoewoKCW9wdGlvbnM6IHsKCQlvbkFjdGl2ZTogQ2xhc3MuZW1wdHksCgkJb25CYWNrZ3JvdW5kOiBDbGFzcy5lbXB0eSwKCQlkaXNwbGF5OiAwLAoJCXNob3c6IGZhbHNlLAoJCWhlaWdodDogdHJ1ZSwKCQl3aWR0aDogZmFsc2UsCgkJb3BhY2l0eTogdHJ1ZSwKCQlmaXhlZEhlaWdodDogZmFsc2UsCgkJZml4ZWRXaWR0aDogZmFsc2UsCgkJd2FpdDogZmFsc2UsCgkJYWx3YXlzSGlkZTogZmFsc2UKCX0sCgoJaW5pdGlhbGl6ZTogZnVuY3Rpb24oKXsKCQl2YXIgb3B0aW9ucywgdG9nZ2xlcnMsIGVsZW1lbnRzLCBjb250YWluZXI7CgkJJGVhY2goYXJndW1lbnRzLCBmdW5jdGlvbihhcmd1bWVudCwgaSl7CgkJCXN3aXRjaCgkdHlwZShhcmd1bWVudCkpewoJCQkJY2FzZSAnb2JqZWN0Jzogb3B0aW9ucyA9IGFyZ3VtZW50OyBicmVhazsKCQkJCWNhc2UgJ2VsZW1lbnQnOiBjb250YWluZXIgPSAkKGFyZ3VtZW50KTsgYnJlYWs7CgkJCQlkZWZhdWx0OgoJCQkJCXZhciB0ZW1wID0gJCQoYXJndW1lbnQpOwoJCQkJCWlmICghdG9nZ2xlcnMpIHRvZ2dsZXJzID0gdGVtcDsKCQkJCQllbHNlIGVsZW1lbnRzID0gdGVtcDsKCQkJfQoJCX0pOwoJCXRoaXMudG9nZ2xlcnMgPSB0b2dnbGVycyB8fCBbXTsKCQl0aGlzLmVsZW1lbnRzID0gZWxlbWVudHMgfHwgW107CgkJdGhpcy5jb250YWluZXIgPSAkKGNvbnRhaW5lcik7CgkJdGhpcy5zZXRPcHRpb25zKG9wdGlvbnMpOwoJCXRoaXMucHJldmlvdXMgPSAtMTsKCQlpZiAodGhpcy5vcHRpb25zLmFsd2F5c0hpZGUpIHRoaXMub3B0aW9ucy53YWl0ID0gdHJ1ZTsKCQlpZiAoJGNoayh0aGlzLm9wdGlvbnMuc2hvdykpewoJCQl0aGlzLm9wdGlvbnMuZGlzcGxheSA9IGZhbHNlOwoJCQl0aGlzLnByZXZpb3VzID0gdGhpcy5vcHRpb25zLnNob3c7CgkJfQoJCWlmICh0aGlzLm9wdGlvbnMuc3RhcnQpewoJCQl0aGlzLm9wdGlvbnMuZGlzcGxheSA9IGZhbHNlOwoJCQl0aGlzLm9wdGlvbnMuc2hvdyA9IGZhbHNlOwoJCX0KCQl0aGlzLmVmZmVjdHMgPSB7fTsKCQlpZiAodGhpcy5vcHRpb25zLm9wYWNpdHkpIHRoaXMuZWZmZWN0cy5vcGFjaXR5ID0gJ2Z1bGxPcGFjaXR5JzsKCQlpZiAodGhpcy5vcHRpb25zLndpZHRoKSB0aGlzLmVmZmVjdHMud2lkdGggPSB0aGlzLm9wdGlvbnMuZml4ZWRXaWR0aCA/ICdmdWxsV2lkdGgnIDogJ29mZnNldFdpZHRoJzsKCQlpZiAodGhpcy5vcHRpb25zLmhlaWdodCkgdGhpcy5lZmZlY3RzLmhlaWdodCA9IHRoaXMub3B0aW9ucy5maXhlZEhlaWdodCA/ICdmdWxsSGVpZ2h0JyA6ICdzY3JvbGxIZWlnaHQnOwoJCWZvciAodmFyIGkgPSAwLCBsID0gdGhpcy50b2dnbGVycy5sZW5ndGg7IGkgPCBsOyBpKyspIHRoaXMuYWRkU2VjdGlvbih0aGlzLnRvZ2dsZXJzW2ldLCB0aGlzLmVsZW1lbnRzW2ldKTsKCQl0aGlzLmVsZW1lbnRzLmVhY2goZnVuY3Rpb24oZWwsIGkpewoJCQlpZiAodGhpcy5vcHRpb25zLnNob3cgPT09IGkpewoJCQkJdGhpcy5maXJlRXZlbnQoJ29uQWN0aXZlJywgW3RoaXMudG9nZ2xlcnNbaV0sIGVsXSk7CgkJCX0gZWxzZSB7CgkJCQlmb3IgKHZhciBmeCBpbiB0aGlzLmVmZmVjdHMpIGVsLnNldFN0eWxlKGZ4LCAwKTsKCQkJfQoJCX0sIHRoaXMpOwoJCXRoaXMucGFyZW50KHRoaXMuZWxlbWVudHMpOwoJCWlmICgkY2hrKHRoaXMub3B0aW9ucy5kaXNwbGF5KSkgdGhpcy5kaXNwbGF5KHRoaXMub3B0aW9ucy5kaXNwbGF5KTsKCX0sCgoJLyoKCVByb3BlcnR5OiBhZGRTZWN0aW9uCgkJRHluYW1pY2FsbHkgYWRkcyBhIG5ldyBzZWN0aW9uIGludG8gdGhlIGFjY29yZGlvbiBhdCB0aGUgc3BlY2lmaWVkIHBvc2l0aW9uLgoKCUFyZ3VtZW50czoKCQl0b2dnbGVyIC0gKGRvbSBlbGVtZW50KSB0aGUgZWxlbWVudCB0aGF0IHRvZ2dsZXMgdGhlIGFjY29yZGlvbiBzZWN0aW9uIG9wZW4uCgkJZWxlbWVudCAtIChkb20gZWxlbWVudCkgdGhlIGVsZW1lbnQgdGhhdCBzdHJldGNoZXMgb3BlbiB3aGVuIHRoZSB0b2dnbGVyIGlzIGNsaWNrZWQuCgkJcG9zIC0gKGludGVnZXIpIHRoZSBpbmRleCB3aGVyZSB0aGVzZSBvYmplY3RzIGFyZSB0byBiZSBpbnNlcnRlZCB3aXRoaW4gdGhlIGFjY29yZGlvbi4KCSovCgoJYWRkU2VjdGlvbjogZnVuY3Rpb24odG9nZ2xlciwgZWxlbWVudCwgcG9zKXsKCQl0b2dnbGVyID0gJCh0b2dnbGVyKTsKCQllbGVtZW50ID0gJChlbGVtZW50KTsKCQl2YXIgdGVzdCA9IHRoaXMudG9nZ2xlcnMuY29udGFpbnModG9nZ2xlcik7CgkJdmFyIGxlbiA9IHRoaXMudG9nZ2xlcnMubGVuZ3RoOwoJCXRoaXMudG9nZ2xlcnMuaW5jbHVkZSh0b2dnbGVyKTsKCQl0aGlzLmVsZW1lbnRzLmluY2x1ZGUoZWxlbWVudCk7CgkJaWYgKGxlbiAmJiAoIXRlc3QgfHwgcG9zKSl7CgkJCXBvcyA9ICRwaWNrKHBvcywgbGVuIC0gMSk7CgkJCXRvZ2dsZXIuaW5qZWN0QmVmb3JlKHRoaXMudG9nZ2xlcnNbcG9zXSk7CgkJCWVsZW1lbnQuaW5qZWN0QWZ0ZXIodG9nZ2xlcik7CgkJfSBlbHNlIGlmICh0aGlzLmNvbnRhaW5lciAmJiAhdGVzdCl7CgkJCXRvZ2dsZXIuaW5qZWN0KHRoaXMuY29udGFpbmVyKTsKCQkJZWxlbWVudC5pbmplY3QodGhpcy5jb250YWluZXIpOwoJCX0KCQl2YXIgaWR4ID0gdGhpcy50b2dnbGVycy5pbmRleE9mKHRvZ2dsZXIpOwoJCXRvZ2dsZXIuYWRkRXZlbnQoJ2NsaWNrJywgdGhpcy5kaXNwbGF5LmJpbmQodGhpcywgaWR4KSk7CgkJaWYgKHRoaXMub3B0aW9ucy5oZWlnaHQpIGVsZW1lbnQuc2V0U3R5bGVzKHsncGFkZGluZy10b3AnOiAwLCAnYm9yZGVyLXRvcCc6ICdub25lJywgJ3BhZGRpbmctYm90dG9tJzogMCwgJ2JvcmRlci1ib3R0b20nOiAnbm9uZSd9KTsKCQlpZiAodGhpcy5vcHRpb25zLndpZHRoKSBlbGVtZW50LnNldFN0eWxlcyh7J3BhZGRpbmctbGVmdCc6IDAsICdib3JkZXItbGVmdCc6ICdub25lJywgJ3BhZGRpbmctcmlnaHQnOiAwLCAnYm9yZGVyLXJpZ2h0JzogJ25vbmUnfSk7CgkJZWxlbWVudC5mdWxsT3BhY2l0eSA9IDE7CgkJaWYgKHRoaXMub3B0aW9ucy5maXhlZFdpZHRoKSBlbGVtZW50LmZ1bGxXaWR0aCA9IHRoaXMub3B0aW9ucy5maXhlZFdpZHRoOwoJCWlmICh0aGlzLm9wdGlvbnMuZml4ZWRIZWlnaHQpIGVsZW1lbnQuZnVsbEhlaWdodCA9IHRoaXMub3B0aW9ucy5maXhlZEhlaWdodDsKCQllbGVtZW50LnNldFN0eWxlKCdvdmVyZmxvdycsICdoaWRkZW4nKTsKCQlpZiAoIXRlc3QpewoJCQlmb3IgKHZhciBmeCBpbiB0aGlzLmVmZmVjdHMpIGVsZW1lbnQuc2V0U3R5bGUoZngsIDApOwoJCX0KCQlyZXR1cm4gdGhpczsKCX0sCgoJLyoKCVByb3BlcnR5OiBkaXNwbGF5CgkJU2hvd3MgYSBzcGVjaWZpYyBzZWN0aW9uIGFuZCBoaWRlcyBhbGwgb3RoZXJzLiBVc2VmdWwgd2hlbiB0cmlnZ2VyaW5nIGFuIGFjY29yZGlvbiBmcm9tIG91dHNpZGUuCgoJQXJndW1lbnRzOgoJCWluZGV4IC0gaW50ZWdlciwgdGhlIGluZGV4IG9mIHRoZSBpdGVtIHRvIHNob3csIG9yIHRoZSBhY3R1YWwgZWxlbWVudCB0byBzaG93LgoJKi8KCglkaXNwbGF5OiBmdW5jdGlvbihpbmRleCl7CgkJaW5kZXggPSAoJHR5cGUoaW5kZXgpID09ICdlbGVtZW50JykgPyB0aGlzLmVsZW1lbnRzLmluZGV4T2YoaW5kZXgpIDogaW5kZXg7CgkJaWYgKCh0aGlzLnRpbWVyICYmIHRoaXMub3B0aW9ucy53YWl0KSB8fCAoaW5kZXggPT09IHRoaXMucHJldmlvdXMgJiYgIXRoaXMub3B0aW9ucy5hbHdheXNIaWRlKSkgcmV0dXJuIHRoaXM7CgkJdGhpcy5wcmV2aW91cyA9IGluZGV4OwoJCXZhciBvYmogPSB7fTsKCQl0aGlzLmVsZW1lbnRzLmVhY2goZnVuY3Rpb24oZWwsIGkpewoJCQlvYmpbaV0gPSB7fTsKCQkJdmFyIGhpZGUgPSAoaSAhPSBpbmRleCkgfHwgKHRoaXMub3B0aW9ucy5hbHdheXNIaWRlICYmIChlbC5vZmZzZXRIZWlnaHQgPiAwKSk7CgkJCXRoaXMuZmlyZUV2ZW50KGhpZGUgPyAnb25CYWNrZ3JvdW5kJyA6ICdvbkFjdGl2ZScsIFt0aGlzLnRvZ2dsZXJzW2ldLCBlbF0pOwoJCQlmb3IgKHZhciBmeCBpbiB0aGlzLmVmZmVjdHMpIG9ialtpXVtmeF0gPSBoaWRlID8gMCA6IGVsW3RoaXMuZWZmZWN0c1tmeF1dOwoJCX0sIHRoaXMpOwoJCXJldHVybiB0aGlzLnN0YXJ0KG9iaik7Cgl9LAoKCXNob3dUaGlzSGlkZU9wZW46IGZ1bmN0aW9uKGluZGV4KXtyZXR1cm4gdGhpcy5kaXNwbGF5KGluZGV4KTt9Cgp9KTsKCkZ4LkFjY29yZGlvbiA9IEFjY29yZGlvbjsK",
                "body": "LyoKU2NyaXB0OiBDb3JlLmpzCglNb290b29scyAtIE15IE9iamVjdCBPcmllbnRlZCBqYXZhc2NyaXB0LgoKTGljZW5zZToKCU1JVC1zdHlsZSBsaWNlbnNlLgoKTW9vVG9vbHMgQ29weXJpZ2h0OgoJY29weXJpZ2h0IChjKSAyMDA3IFZhbGVyaW8gUHJvaWV0dGksIDxodHRwOi8vbWFkNG1pbGsubmV0PgoKTW9vVG9vbHMgQ3JlZGl0czoKCS0gQ2xhc3MgaXMgc2xpZ2h0bHkgYmFzZWQgb24gQmFzZS5qcyA8aHR0cDovL2RlYW4uZWR3YXJkcy5uYW1lL3dlYmxvZy8yMDA2LzAzL2Jhc2UvPiAoYykgMjAwNiBEZWFuIEVkd2FyZHMsIExpY2Vuc2UgPGh0dHA6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL0xHUEwvMi4xLz4KCS0gU29tZSBmdW5jdGlvbnMgYXJlIGluc3BpcmVkIGJ5IHRob3NlIGZvdW5kIGluIHByb3RvdHlwZS5qcyA8aHR0cDovL3Byb3RvdHlwZS5jb25pby5uZXQvPiAoYykgMjAwNSBTYW0gU3RlcGhlbnNvbiBzYW0gW2F0XSBjb25pbyBbZG90XSBuZXQsIE1JVC1zdHlsZSBsaWNlbnNlCgktIERvY3VtZW50YXRpb24gYnkgQWFyb24gTmV3dG9uIChhYXJvbi5uZXd0b24gW2F0XSBjbmV0IFtkb3RdIGNvbSkgYW5kIFZhbGVyaW8gUHJvaWV0dGkuCiovCgp2YXIgTW9vVG9vbHMgPSB7Cgl2ZXJzaW9uOiAnMS4xMicKfTsKCi8qIFNlY3Rpb246IENvcmUgRnVuY3Rpb25zICovCgovKgpGdW5jdGlvbjogJGRlZmluZWQKCVJldHVybnMgdHJ1ZSBpZiB0aGUgcGFzc2VkIGluIHZhbHVlL29iamVjdCBpcyBkZWZpbmVkLCB0aGF0IG1lYW5zIGlzIG5vdCBudWxsIG9yIHVuZGVmaW5lZC4KCkFyZ3VtZW50czoKCW9iaiAtIG9iamVjdCB0byBpbnNwZWN0CiovCgpmdW5jdGlvbiAkZGVmaW5lZChvYmopewoJcmV0dXJuIChvYmogIT0gdW5kZWZpbmVkKTsKfTsKCi8qCkZ1bmN0aW9uOiAkdHlwZQoJUmV0dXJucyB0aGUgdHlwZSBvZiBvYmplY3QgdGhhdCBtYXRjaGVzIHRoZSBlbGVtZW50IHBhc3NlZCBpbi4KCkFyZ3VtZW50czoKCW9iaiAtIHRoZSBvYmplY3QgdG8gaW5zcGVjdC4KCkV4YW1wbGU6Cgk+dmFyIG15U3RyaW5nID0gJ2hlbGxvJzsKCT4kdHlwZShteVN0cmluZyk7IC8vcmV0dXJucyAic3RyaW5nIgoKUmV0dXJuczoKCSdlbGVtZW50JyAtIGlmIG9iaiBpcyBhIERPTSBlbGVtZW50IG5vZGUKCSd0ZXh0bm9kZScgLSBpZiBvYmogaXMgYSBET00gdGV4dCBub2RlCgknd2hpdGVzcGFjZScgLSBpZiBvYmogaXMgYSBET00gd2hpdGVzcGFjZSBub2RlCgknYXJndW1lbnRzJyAtIGlmIG9iaiBpcyBhbiBhcmd1bWVudHMgb2JqZWN0Cgknb2JqZWN0JyAtIGlmIG9iaiBpcyBhbiBvYmplY3QKCSdzdHJpbmcnIC0gaWYgb2JqIGlzIGEgc3RyaW5nCgknbnVtYmVyJyAtIGlmIG9iaiBpcyBhIG51bWJlcgoJJ2Jvb2xlYW4nIC0gaWYgb2JqIGlzIGEgYm9vbGVhbgoJJ2Z1bmN0aW9uJyAtIGlmIG9iaiBpcyBhIGZ1bmN0aW9uCgkncmVnZXhwJyAtIGlmIG9iaiBpcyBhIHJlZ3VsYXIgZXhwcmVzc2lvbgoJJ2NsYXNzJyAtIGlmIG9iaiBpcyBhIENsYXNzLiAoY3JlYXRlZCB3aXRoIG5ldyBDbGFzcywgb3IgdGhlIGV4dGVuZCBvZiBhbm90aGVyIGNsYXNzKS4KCSdjb2xsZWN0aW9uJyAtIGlmIG9iaiBpcyBhIG5hdGl2ZSBodG1sZWxlbWVudHMgY29sbGVjdGlvbiwgc3VjaCBhcyBjaGlsZE5vZGVzLCBnZXRFbGVtZW50c0J5VGFnTmFtZSAuLiBldGMuCglmYWxzZSAtIChib29sZWFuKSBpZiB0aGUgb2JqZWN0IGlzIG5vdCBkZWZpbmVkIG9yIG5vbmUgb2YgdGhlIGFib3ZlLgoqLwoKZnVuY3Rpb24gJHR5cGUob2JqKXsKCWlmICghJGRlZmluZWQob2JqKSkgcmV0dXJuIGZhbHNlOwoJaWYgKG9iai5odG1sRWxlbWVudCkgcmV0dXJuICdlbGVtZW50JzsKCXZhciB0eXBlID0gdHlwZW9mIG9iajsKCWlmICh0eXBlID09ICdvYmplY3QnICYmIG9iai5ub2RlTmFtZSl7CgkJc3dpdGNoKG9iai5ub2RlVHlwZSl7CgkJCWNhc2UgMTogcmV0dXJuICdlbGVtZW50JzsKCQkJY2FzZSAzOiByZXR1cm4gKC9cUy8pLnRlc3Qob2JqLm5vZGVWYWx1ZSkgPyAndGV4dG5vZGUnIDogJ3doaXRlc3BhY2UnOwoJCX0KCX0KCWlmICh0eXBlID09ICdvYmplY3QnIHx8IHR5cGUgPT0gJ2Z1bmN0aW9uJyl7CgkJc3dpdGNoKG9iai5jb25zdHJ1Y3Rvcil7CgkJCWNhc2UgQXJyYXk6IHJldHVybiAnYXJyYXknOwoJCQljYXNlIFJlZ0V4cDogcmV0dXJuICdyZWdleHAnOwoJCQljYXNlIENsYXNzOiByZXR1cm4gJ2NsYXNzJzsKCQl9CgkJaWYgKHR5cGVvZiBvYmoubGVuZ3RoID09ICdudW1iZXInKXsKCQkJaWYgKG9iai5pdGVtKSByZXR1cm4gJ2NvbGxlY3Rpb24nOwoJCQlpZiAob2JqLmNhbGxlZSkgcmV0dXJuICdhcmd1bWVudHMnOwoJCX0KCX0KCXJldHVybiB0eXBlOwp9OwoKLyoKRnVuY3Rpb246ICRtZXJnZQoJbWVyZ2VzIGEgbnVtYmVyIG9mIG9iamVjdHMgcmVjdXJzaXZlbHkgd2l0aG91dCByZWZlcmVuY2luZyB0aGVtIG9yIHRoZWlyIHN1Yi1vYmplY3RzLgoKQXJndW1lbnRzOgoJYW55IG51bWJlciBvZiBvYmplY3RzLgoKRXhhbXBsZToKCT52YXIgbWVyZ2VkT2JqID0gJG1lcmdlKG9iajEsIG9iajIsIG9iajMpOwoJPi8vb2JqMSwgb2JqMiwgYW5kIG9iajMgYXJlIHVuYWx0ZXJlZAoqLwoKZnVuY3Rpb24gJG1lcmdlKCl7Cgl2YXIgbWl4ID0ge307Cglmb3IgKHZhciBpID0gMDsgaSA8IGFyZ3VtZW50cy5sZW5ndGg7IGkrKyl7CgkJZm9yICh2YXIgcHJvcGVydHkgaW4gYXJndW1lbnRzW2ldKXsKCQkJdmFyIGFwID0gYXJndW1lbnRzW2ldW3Byb3BlcnR5XTsKCQkJdmFyIG1wID0gbWl4W3Byb3BlcnR5XTsKCQkJaWYgKG1wICYmICR0eXBlKGFwKSA9PSAnb2JqZWN0JyAmJiAkdHlwZShtcCkgPT0gJ29iamVjdCcpIG1peFtwcm9wZXJ0eV0gPSAkbWVyZ2UobXAsIGFwKTsKCQkJZWxzZSBtaXhbcHJvcGVydHldID0gYXA7CgkJfQoJfQoJcmV0dXJuIG1peDsKfTsKCi8qCkZ1bmN0aW9uOiAkZXh0ZW5kCglDb3BpZXMgYWxsIHRoZSBwcm9wZXJ0aWVzIGZyb20gdGhlIHNlY29uZCBwYXNzZWQgb2JqZWN0IHRvIHRoZSBmaXJzdCBwYXNzZWQgT2JqZWN0LgoJSWYgeW91IGRvIG15V2hhdGV2ZXIuZXh0ZW5kID0gJGV4dGVuZCB0aGUgZmlyc3QgcGFyYW1ldGVyIHdpbGwgYmVjb21lIG15V2hhdGV2ZXIsIGFuZCB5b3VyIGV4dGVuZCBmdW5jdGlvbiB3aWxsIG9ubHkgbmVlZCBvbmUgcGFyYW1ldGVyLgoKRXhhbXBsZToKCShzdGFydCBjb2RlKQoJdmFyIGZpcnN0T2IgPSB7CgkJJ25hbWUnOiAnSm9obicsCgkJJ2xhc3ROYW1lJzogJ0RvZScKCX07Cgl2YXIgc2Vjb25kT2IgPSB7CgkJJ2FnZSc6ICcyMCcsCgkJJ3NleCc6ICdtYWxlJywKCQknbGFzdE5hbWUnOiAnRG9yaWFuJwoJfTsKCSRleHRlbmQoZmlyc3RPYiwgc2Vjb25kT2IpOwoJLy9maXJzdE9iIHdpbGwgYmVjb21lOgoJewoJCSduYW1lJzogJ0pvaG4nLAoJCSdsYXN0TmFtZSc6ICdEb3JpYW4nLAoJCSdhZ2UnOiAnMjAnLAoJCSdzZXgnOiAnbWFsZScKCX07CgkoZW5kKQoKUmV0dXJuczoKCVRoZSBmaXJzdCBvYmplY3QsIGV4dGVuZGVkLgoqLwoKdmFyICRleHRlbmQgPSBmdW5jdGlvbigpewoJdmFyIGFyZ3MgPSBhcmd1bWVudHM7CglpZiAoIWFyZ3NbMV0pIGFyZ3MgPSBbdGhpcywgYXJnc1swXV07Cglmb3IgKHZhciBwcm9wZXJ0eSBpbiBhcmdzWzFdKSBhcmdzWzBdW3Byb3BlcnR5XSA9IGFyZ3NbMV1bcHJvcGVydHldOwoJcmV0dXJuIGFyZ3NbMF07Cn07CgovKgpGdW5jdGlvbjogJG5hdGl2ZQoJV2lsbCBhZGQgYSAuZXh0ZW5kIG1ldGhvZCB0byB0aGUgb2JqZWN0cyBwYXNzZWQgYXMgYSBwYXJhbWV0ZXIsIGJ1dCB0aGUgcHJvcGVydHkgcGFzc2VkIGluIHdpbGwgYmUgY29waWVkIHRvIHRoZSBvYmplY3QncyBwcm90b3R5cGUgb25seSBpZiBub24gcHJldmlvdXNseSBleGlzdGVudC4KCUl0cyBoYW5keSBpZiB5b3UgZG9udCB3YW50IHRoZSAuZXh0ZW5kIG1ldGhvZCBvZiBhbiBvYmplY3QgdG8gb3ZlcndyaXRlIGV4aXN0aW5nIG1ldGhvZHMuCglVc2VkIGF1dG9tYXRpY2FsbHkgaW4gTW9vVG9vbHMgdG8gaW1wbGVtZW50IEFycmF5L1N0cmluZy9GdW5jdGlvbi9OdW1iZXIgbWV0aG9kcyB0byBicm93c2VyIHRoYXQgZG9udCBzdXBwb3J0IHRoZW0gd2hpdG91dCBtYW51YWwgY2hlY2tpbmcuCgpBcmd1bWVudHM6CglhIG51bWJlciBvZiBjbGFzc2VzL25hdGl2ZSBqYXZhc2NyaXB0IG9iamVjdHMKCiovCgp2YXIgJG5hdGl2ZSA9IGZ1bmN0aW9uKCl7Cglmb3IgKHZhciBpID0gMCwgbCA9IGFyZ3VtZW50cy5sZW5ndGg7IGkgPCBsOyBpKyspewoJCWFyZ3VtZW50c1tpXS5leHRlbmQgPSBmdW5jdGlvbihwcm9wcyl7CgkJCWZvciAodmFyIHByb3AgaW4gcHJvcHMpewoJCQkJaWYgKCF0aGlzLnByb3RvdHlwZVtwcm9wXSkgdGhpcy5wcm90b3R5cGVbcHJvcF0gPSBwcm9wc1twcm9wXTsKCQkJCWlmICghdGhpc1twcm9wXSkgdGhpc1twcm9wXSA9ICRuYXRpdmUuZ2VuZXJpYyhwcm9wKTsKCQkJfQoJCX07Cgl9Cn07CgokbmF0aXZlLmdlbmVyaWMgPSBmdW5jdGlvbihwcm9wKXsKCXJldHVybiBmdW5jdGlvbihiaW5kKXsKCQlyZXR1cm4gdGhpcy5wcm90b3R5cGVbcHJvcF0uYXBwbHkoYmluZCwgQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSk7Cgl9Owp9OwoKJG5hdGl2ZShGdW5jdGlvbiwgQXJyYXksIFN0cmluZywgTnVtYmVyKTsKCi8qCkZ1bmN0aW9uOiAkY2hrCglSZXR1cm5zIHRydWUgaWYgdGhlIHBhc3NlZCBpbiB2YWx1ZS9vYmplY3QgZXhpc3RzIG9yIGlzIDAsIG90aGVyd2lzZSByZXR1cm5zIGZhbHNlLgoJVXNlZnVsIHRvIGFjY2VwdCB6ZXJvZXMuCgpBcmd1bWVudHM6CglvYmogLSBvYmplY3QgdG8gaW5zcGVjdAoqLwoKZnVuY3Rpb24gJGNoayhvYmopewoJcmV0dXJuICEhKG9iaiB8fCBvYmogPT09IDApOwp9OwoKLyoKRnVuY3Rpb246ICRwaWNrCglSZXR1cm5zIHRoZSBmaXJzdCBvYmplY3QgaWYgZGVmaW5lZCwgb3RoZXJ3aXNlIHJldHVybnMgdGhlIHNlY29uZC4KCkFyZ3VtZW50czoKCW9iaiAtIG9iamVjdCB0byB0ZXN0CglwaWNrZWQgLSB0aGUgZGVmYXVsdCB0byByZXR1cm4KCkV4YW1wbGU6Cgkoc3RhcnQgY29kZSkKCQlmdW5jdGlvbiBzYXkobXNnKXsKCQkJYWxlcnQoJHBpY2sobXNnLCAnbm8gbWVlc3NhZ2Ugc3VwcGxpZWQnKSk7CgkJfQoJKGVuZCkKKi8KCmZ1bmN0aW9uICRwaWNrKG9iaiwgcGlja2VkKXsKCXJldHVybiAkZGVmaW5lZChvYmopID8gb2JqIDogcGlja2VkOwp9OwoKLyoKRnVuY3Rpb246ICRyYW5kb20KCVJldHVybnMgYSByYW5kb20gaW50ZWdlciBudW1iZXIgYmV0d2VlbiB0aGUgdHdvIHBhc3NlZCBpbiB2YWx1ZXMuCgpBcmd1bWVudHM6CgltaW4gLSBpbnRlZ2VyLCB0aGUgbWluaW11bSB2YWx1ZSAoaW5jbHVzaXZlKS4KCW1heCAtIGludGVnZXIsIHRoZSBtYXhpbXVtIHZhbHVlIChpbmNsdXNpdmUpLgoKUmV0dXJuczoKCWEgcmFuZG9tIGludGVnZXIgYmV0d2VlbiBtaW4gYW5kIG1heC4KKi8KCmZ1bmN0aW9uICRyYW5kb20obWluLCBtYXgpewoJcmV0dXJuIE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIChtYXggLSBtaW4gKyAxKSArIG1pbik7Cn07CgovKgpGdW5jdGlvbjogJHRpbWUKCVJldHVybnMgdGhlIGN1cnJlbnQgdGltZXN0YW1wCgpSZXR1cm5zOgoJYSB0aW1lc3RhbXAgaW50ZWdlci4KKi8KCmZ1bmN0aW9uICR0aW1lKCl7CglyZXR1cm4gbmV3IERhdGUoKS5nZXRUaW1lKCk7Cn07CgovKgpGdW5jdGlvbjogJGNsZWFyCgljbGVhcnMgYSB0aW1lb3V0IG9yIGFuIEludGVydmFsLgoKUmV0dXJuczoKCW51bGwKCkFyZ3VtZW50czoKCXRpbWVyIC0gdGhlIHNldEludGVydmFsIG9yIHNldFRpbWVvdXQgdG8gY2xlYXIuCgpFeGFtcGxlOgoJPnZhciBteVRpbWVyID0gbXlGdW5jdGlvbi5kZWxheSg1MDAwKTsgLy93YWl0IDUgc2Vjb25kcyBhbmQgZXhlY3V0ZSBteSBmdW5jdGlvbi4KCT5teVRpbWVyID0gJGNsZWFyKG15VGltZXIpOyAvL25ldmVybWluZAoKU2VlIGFsc286Cgk8RnVuY3Rpb24uZGVsYXk+LCA8RnVuY3Rpb24ucGVyaW9kaWNhbD4KKi8KCmZ1bmN0aW9uICRjbGVhcih0aW1lcil7CgljbGVhclRpbWVvdXQodGltZXIpOwoJY2xlYXJJbnRlcnZhbCh0aW1lcik7CglyZXR1cm4gbnVsbDsKfTsKCi8qCkNsYXNzOiBBYnN0cmFjdAoJQWJzdHJhY3QgY2xhc3MsIHRvIGJlIHVzZWQgYXMgc2luZ2xldG9uLiBXaWxsIGFkZCAuZXh0ZW5kIHRvIGFueSBvYmplY3QKCkFyZ3VtZW50czoKCWFuIG9iamVjdAoKUmV0dXJuczoKCXRoZSBvYmplY3Qgd2l0aCBhbiAuZXh0ZW5kIHByb3BlcnR5LCBlcXVpdmFsZW50IHRvIDwkZXh0ZW5kPi4KKi8KCnZhciBBYnN0cmFjdCA9IGZ1bmN0aW9uKG9iail7CglvYmogPSBvYmogfHwge307CglvYmouZXh0ZW5kID0gJGV4dGVuZDsKCXJldHVybiBvYmo7Cn07CgovL3dpbmRvdywgZG9jdW1lbnQKCnZhciBXaW5kb3cgPSBuZXcgQWJzdHJhY3Qod2luZG93KTsKdmFyIERvY3VtZW50ID0gbmV3IEFic3RyYWN0KGRvY3VtZW50KTsKZG9jdW1lbnQuaGVhZCA9IGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCdoZWFkJylbMF07CgovKgpDbGFzczogd2luZG93CglTb21lIHByb3BlcnRpZXMgYXJlIGF0dGFjaGVkIHRvIHRoZSB3aW5kb3cgb2JqZWN0IGJ5IHRoZSBicm93c2VyIGRldGVjdGlvbi4KCk5vdGU6Cglicm93c2VyIGRldGVjdGlvbiBpcyBlbnRpcmVseSBvYmplY3QtYmFzZWQuIFdlIGRvbnQgc25pZmYuCgpQcm9wZXJ0aWVzOgoJd2luZG93LmllIC0gd2lsbCBiZSBzZXQgdG8gdHJ1ZSBpZiB0aGUgY3VycmVudCBicm93c2VyIGlzIGludGVybmV0IGV4cGxvcmVyIChhbnkpLgoJd2luZG93LmllNiAtIHdpbGwgYmUgc2V0IHRvIHRydWUgaWYgdGhlIGN1cnJlbnQgYnJvd3NlciBpcyBpbnRlcm5ldCBleHBsb3JlciA2LgoJd2luZG93LmllNyAtIHdpbGwgYmUgc2V0IHRvIHRydWUgaWYgdGhlIGN1cnJlbnQgYnJvd3NlciBpcyBpbnRlcm5ldCBleHBsb3JlciA3LgoJd2luZG93LmdlY2tvIC0gd2lsbCBiZSBzZXQgdG8gdHJ1ZSBpZiB0aGUgY3VycmVudCBicm93c2VyIGlzIE1vemlsbGEvR2Vja28uCgl3aW5kb3cud2Via2l0IC0gd2lsbCBiZSBzZXQgdG8gdHJ1ZSBpZiB0aGUgY3VycmVudCBicm93c2VyIGlzIFNhZmFyaS9Lb25xdWVyb3IuCgl3aW5kb3cud2Via2l0NDE5IC0gd2lsbCBiZSBzZXQgdG8gdHJ1ZSBpZiB0aGUgY3VycmVudCBicm93c2VyIGlzIFNhZmFyaTIgLyB3ZWJraXQgdGlsbCB2ZXJzaW9uIDQxOS4KCXdpbmRvdy53ZWJraXQ0MjAgLSB3aWxsIGJlIHNldCB0byB0cnVlIGlmIHRoZSBjdXJyZW50IGJyb3dzZXIgaXMgU2FmYXJpMyAoV2Via2l0IFNWTiBCdWlsZCkgLyB3ZWJraXQgb3ZlciB2ZXJzaW9uIDQxOS4KCXdpbmRvdy5vcGVyYSAtIGlzIHNldCB0byB0cnVlIGJ5IG9wZXJhIGl0c2VsZi4KKi8KCndpbmRvdy54cGF0aCA9ICEhKGRvY3VtZW50LmV2YWx1YXRlKTsKaWYgKHdpbmRvdy5BY3RpdmVYT2JqZWN0KSB3aW5kb3cuaWUgPSB3aW5kb3dbd2luZG93LlhNTEh0dHBSZXF1ZXN0ID8gJ2llNycgOiAnaWU2J10gPSB0cnVlOwplbHNlIGlmIChkb2N1bWVudC5jaGlsZE5vZGVzICYmICFkb2N1bWVudC5hbGwgJiYgIW5hdmlnYXRvci50YWludEVuYWJsZWQpIHdpbmRvdy53ZWJraXQgPSB3aW5kb3dbd2luZG93LnhwYXRoID8gJ3dlYmtpdDQyMCcgOiAnd2Via2l0NDE5J10gPSB0cnVlOwplbHNlIGlmIChkb2N1bWVudC5nZXRCb3hPYmplY3RGb3IgIT0gbnVsbCB8fCB3aW5kb3cubW96SW5uZXJTY3JlZW5YICE9IG51bGwpIHdpbmRvdy5nZWNrbyA9IHRydWU7CgovKmNvbXBhdGliaWxpdHkqLwoKd2luZG93LmtodG1sID0gd2luZG93LndlYmtpdDsKCk9iamVjdC5leHRlbmQgPSAkZXh0ZW5kOwoKLyplbmQgY29tcGF0aWJpbGl0eSovCgovL2h0bWxlbGVtZW50CgppZiAodHlwZW9mIEhUTUxFbGVtZW50ID09ICd1bmRlZmluZWQnKXsKCXZhciBIVE1MRWxlbWVudCA9IGZ1bmN0aW9uKCl7fTsKCWlmICh3aW5kb3cud2Via2l0KSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJpZnJhbWUiKTsgLy9maXhlcyBzYWZhcmkKCUhUTUxFbGVtZW50LnByb3RvdHlwZSA9ICh3aW5kb3cud2Via2l0KSA/IHdpbmRvd1siW1tET01FbGVtZW50LnByb3RvdHlwZV1dIl0gOiB7fTsKfQpIVE1MRWxlbWVudC5wcm90b3R5cGUuaHRtbEVsZW1lbnQgPSBmdW5jdGlvbigpe307CgovL2VuYWJsZXMgYmFja2dyb3VuZCBpbWFnZSBjYWNoZSBmb3IgaW50ZXJuZXQgZXhwbG9yZXIgNgoKaWYgKHdpbmRvdy5pZTYpIHRyeSB7ZG9jdW1lbnQuZXhlY0NvbW1hbmQoIkJhY2tncm91bmRJbWFnZUNhY2hlIiwgZmFsc2UsIHRydWUpO30gY2F0Y2goZSl7fTsKCi8qClNjcmlwdDogQ2xhc3MuanMKCUNvbnRhaW5zIHRoZSBDbGFzcyBGdW5jdGlvbiwgYWltcyB0byBlYXNlIHRoZSBjcmVhdGlvbiBvZiByZXVzYWJsZSBDbGFzc2VzLgoKTGljZW5zZToKCU1JVC1zdHlsZSBsaWNlbnNlLgoqLwoKLyoKQ2xhc3M6IENsYXNzCglUaGUgYmFzZSBjbGFzcyBvYmplY3Qgb2YgdGhlIDxodHRwOi8vbW9vdG9vbHMubmV0PiBmcmFtZXdvcmsuCglDcmVhdGVzIGEgbmV3IGNsYXNzLCBpdHMgaW5pdGlhbGl6ZSBtZXRob2Qgd2lsbCBmaXJlIHVwb24gY2xhc3MgaW5zdGFudGlhdGlvbi4KCUluaXRpYWxpemUgd29udCBmaXJlIG9uIGluc3RhbnRpYXRpb24gd2hlbiB5b3UgcGFzcyAqbnVsbCouCgpBcmd1bWVudHM6Cglwcm9wZXJ0aWVzIC0gdGhlIGNvbGxlY3Rpb24gb2YgcHJvcGVydGllcyB0aGF0IGFwcGx5IHRvIHRoZSBjbGFzcy4KCkV4YW1wbGU6Cgkoc3RhcnQgY29kZSkKCXZhciBDYXQgPSBuZXcgQ2xhc3MoewoJCWluaXRpYWxpemU6IGZ1bmN0aW9uKG5hbWUpewoJCQl0aGlzLm5hbWUgPSBuYW1lOwoJCX0KCX0pOwoJdmFyIG15Q2F0ID0gbmV3IENhdCgnTWljaWEnKTsKCWFsZXJ0KG15Q2F0Lm5hbWUpOyAvL2FsZXJ0cyAnTWljaWEnCgkoZW5kKQoqLwoKdmFyIENsYXNzID0gZnVuY3Rpb24ocHJvcGVydGllcyl7Cgl2YXIga2xhc3MgPSBmdW5jdGlvbigpewoJCXJldHVybiAoYXJndW1lbnRzWzBdICE9PSBudWxsICYmIHRoaXMuaW5pdGlhbGl6ZSAmJiAkdHlwZSh0aGlzLmluaXRpYWxpemUpID09ICdmdW5jdGlvbicpID8gdGhpcy5pbml0aWFsaXplLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykgOiB0aGlzOwoJfTsKCSRleHRlbmQoa2xhc3MsIHRoaXMpOwoJa2xhc3MucHJvdG90eXBlID0gcHJvcGVydGllczsKCWtsYXNzLmNvbnN0cnVjdG9yID0gQ2xhc3M7CglyZXR1cm4ga2xhc3M7Cn07CgovKgpQcm9wZXJ0eTogZW1wdHkKCVJldHVybnMgYW4gZW1wdHkgZnVuY3Rpb24KKi8KCkNsYXNzLmVtcHR5ID0gZnVuY3Rpb24oKXt9OwoKQ2xhc3MucHJvdG90eXBlID0gewoKCS8qCglQcm9wZXJ0eTogZXh0ZW5kCgkJUmV0dXJucyB0aGUgY29weSBvZiB0aGUgQ2xhc3MgZXh0ZW5kZWQgd2l0aCB0aGUgcGFzc2VkIGluIHByb3BlcnRpZXMuCgoJQXJndW1lbnRzOgoJCXByb3BlcnRpZXMgLSB0aGUgcHJvcGVydGllcyB0byBhZGQgdG8gdGhlIGJhc2UgY2xhc3MgaW4gdGhpcyBuZXcgQ2xhc3MuCgoJRXhhbXBsZToKCQkoc3RhcnQgY29kZSkKCQl2YXIgQW5pbWFsID0gbmV3IENsYXNzKHsKCQkJaW5pdGlhbGl6ZTogZnVuY3Rpb24oYWdlKXsKCQkJCXRoaXMuYWdlID0gYWdlOwoJCQl9CgkJfSk7CgkJdmFyIENhdCA9IEFuaW1hbC5leHRlbmQoewoJCQlpbml0aWFsaXplOiBmdW5jdGlvbihuYW1lLCBhZ2UpewoJCQkJdGhpcy5wYXJlbnQoYWdlKTsgLy93aWxsIGNhbGwgdGhlIHByZXZpb3VzIGluaXRpYWxpemU7CgkJCQl0aGlzLm5hbWUgPSBuYW1lOwoJCQl9CgkJfSk7CgkJdmFyIG15Q2F0ID0gbmV3IENhdCgnTWljaWEnLCAyMCk7CgkJYWxlcnQobXlDYXQubmFtZSk7IC8vYWxlcnRzICdNaWNpYScKCQlhbGVydChteUNhdC5hZ2UpOyAvL2FsZXJ0cyAyMAoJCShlbmQpCgkqLwoKCWV4dGVuZDogZnVuY3Rpb24ocHJvcGVydGllcyl7CgkJdmFyIHByb3RvID0gbmV3IHRoaXMobnVsbCk7CgkJZm9yICh2YXIgcHJvcGVydHkgaW4gcHJvcGVydGllcyl7CgkJCXZhciBwcCA9IHByb3RvW3Byb3BlcnR5XTsKCQkJcHJvdG9bcHJvcGVydHldID0gQ2xhc3MuTWVyZ2UocHAsIHByb3BlcnRpZXNbcHJvcGVydHldKTsKCQl9CgkJcmV0dXJuIG5ldyBDbGFzcyhwcm90byk7Cgl9LAoKCS8qCglQcm9wZXJ0eTogaW1wbGVtZW50CgkJSW1wbGVtZW50cyB0aGUgcGFzc2VkIGluIHByb3BlcnRpZXMgdG8gdGhlIGJhc2UgQ2xhc3MgcHJvdG90eXBlcywgYWx0ZXJpbmcgdGhlIGJhc2UgY2xhc3MsIHVubGlrZSA8Q2xhc3MuZXh0ZW5kPi4KCglBcmd1bWVudHM6CgkJcHJvcGVydGllcyAtIHRoZSBwcm9wZXJ0aWVzIHRvIGFkZCB0byB0aGUgYmFzZSBjbGFzcy4KCglFeGFtcGxlOgoJCShzdGFydCBjb2RlKQoJCXZhciBBbmltYWwgPSBuZXcgQ2xhc3MoewoJCQlpbml0aWFsaXplOiBmdW5jdGlvbihhZ2UpewoJCQkJdGhpcy5hZ2UgPSBhZ2U7CgkJCX0KCQl9KTsKCQlBbmltYWwuaW1wbGVtZW50KHsKCQkJc2V0TmFtZTogZnVuY3Rpb24obmFtZSl7CgkJCQl0aGlzLm5hbWUgPSBuYW1lCgkJCX0KCQl9KTsKCQl2YXIgbXlBbmltYWwgPSBuZXcgQW5pbWFsKDIwKTsKCQlteUFuaW1hbC5zZXROYW1lKCdNaWNpYScpOwoJCWFsZXJ0KG15QW5pbWFsLm5hbWUpOyAvL2FsZXJ0cyAnTWljaWEnCgkJKGVuZCkKCSovCgoJaW1wbGVtZW50OiBmdW5jdGlvbigpewoJCWZvciAodmFyIGkgPSAwLCBsID0gYXJndW1lbnRzLmxlbmd0aDsgaSA8IGw7IGkrKykgJGV4dGVuZCh0aGlzLnByb3RvdHlwZSwgYXJndW1lbnRzW2ldKTsKCX0KCn07CgovL2ludGVybmFsCgpDbGFzcy5NZXJnZSA9IGZ1bmN0aW9uKHByZXZpb3VzLCBjdXJyZW50KXsKCWlmIChwcmV2aW91cyAmJiBwcmV2aW91cyAhPSBjdXJyZW50KXsKCQl2YXIgdHlwZSA9ICR0eXBlKGN1cnJlbnQpOwoJCWlmICh0eXBlICE9ICR0eXBlKHByZXZpb3VzKSkgcmV0dXJuIGN1cnJlbnQ7CgkJc3dpdGNoKHR5cGUpewoJCQljYXNlICdmdW5jdGlvbic6CgkJCQl2YXIgbWVyZ2VkID0gZnVuY3Rpb24oKXsKCQkJCQl0aGlzLnBhcmVudCA9IGFyZ3VtZW50cy5jYWxsZWUucGFyZW50OwoJCQkJCXJldHVybiBjdXJyZW50LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CgkJCQl9OwoJCQkJbWVyZ2VkLnBhcmVudCA9IHByZXZpb3VzOwoJCQkJcmV0dXJuIG1lcmdlZDsKCQkJY2FzZSAnb2JqZWN0JzogcmV0dXJuICRtZXJnZShwcmV2aW91cywgY3VycmVudCk7CgkJfQoJfQoJcmV0dXJuIGN1cnJlbnQ7Cn07CgovKgpTY3JpcHQ6IENsYXNzLkV4dHJhcy5qcwoJQ29udGFpbnMgY29tbW9uIGltcGxlbWVudGF0aW9ucyBmb3IgY3VzdG9tIGNsYXNzZXMuIEluIE1vb3Rvb2xzIGlzIGltcGxlbWVudGVkIGluIDxBamF4PiwgPFhIUj4gYW5kIDxGeC5CYXNlPiBhbmQgbWFueSBtb3JlLgoKTGljZW5zZToKCU1JVC1zdHlsZSBsaWNlbnNlLgoqLwoKLyoKQ2xhc3M6IENoYWluCglBbiAiVXRpbGl0eSIgQ2xhc3MuIEl0cyBtZXRob2RzIGNhbiBiZSBpbXBsZW1lbnRlZCB3aXRoIDxDbGFzcy5pbXBsZW1lbnQ+IGludG8gYW55IDxDbGFzcz4uCglDdXJyZW50bHkgaW1wbGVtZW50ZWQgaW4gPEZ4LkJhc2U+LCA8WEhSPiBhbmQgPEFqYXg+LiBJbiA8RnguQmFzZT4gZm9yIGV4YW1wbGUsIGlzIHVzZWQgdG8gZXhlY3V0ZSBhIGxpc3Qgb2YgZnVuY3Rpb24sIG9uZSBhZnRlciBhbm90aGVyLCBvbmNlIHRoZSBlZmZlY3QgaXMgY29tcGxldGVkLgoJVGhlIGZ1bmN0aW9ucyB3aWxsIG5vdCBiZSBmaXJlZCBhbGwgdG9naGV0ZXIsIGJ1dCBvbmUgZXZlcnkgY29tcGxldGlvbiwgdG8gY3JlYXRlIGN1c3RvbSBjb21wbGV4IGFuaW1hdGlvbnMuCgpFeGFtcGxlOgoJKHN0YXJ0IGNvZGUpCgl2YXIgbXlGeCA9IG5ldyBGeC5TdHlsZSgnZWxlbWVudCcsICdvcGFjaXR5Jyk7CgoJbXlGeC5zdGFydCgxLDApLmNoYWluKGZ1bmN0aW9uKCl7CgkJbXlGeC5zdGFydCgwLDEpOwoJfSkuY2hhaW4oZnVuY3Rpb24oKXsKCQlteUZ4LnN0YXJ0KDEsMCk7Cgl9KS5jaGFpbihmdW5jdGlvbigpewoJCW15Rnguc3RhcnQoMCwxKTsKCX0pOwoJLy90aGUgZWxlbWVudCB3aWxsIGFwcGVhciBhbmQgZGlzYXBwZWFyIHRocmVlIHRpbWVzCgkoZW5kKQoqLwoKdmFyIENoYWluID0gbmV3IENsYXNzKHsKCgkvKgoJUHJvcGVydHk6IGNoYWluCgkJYWRkcyBhIGZ1bmN0aW9uIHRvIHRoZSBDaGFpbiBpbnN0YW5jZSBzdGFjay4KCglBcmd1bWVudHM6CgkJZm4gLSB0aGUgZnVuY3Rpb24gdG8gYXBwZW5kLgoJKi8KCgljaGFpbjogZnVuY3Rpb24oZm4pewoJCXRoaXMuY2hhaW5zID0gdGhpcy5jaGFpbnMgfHwgW107CgkJdGhpcy5jaGFpbnMucHVzaChmbik7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCS8qCglQcm9wZXJ0eTogY2FsbENoYWluCgkJRXhlY3V0ZXMgdGhlIGZpcnN0IGZ1bmN0aW9uIG9mIHRoZSBDaGFpbiBpbnN0YW5jZSBzdGFjaywgdGhlbiByZW1vdmVzIGl0LiBUaGUgZmlyc3QgZnVuY3Rpb24gd2lsbCB0aGVuIGJlY29tZSB0aGUgc2Vjb25kLgoJKi8KCgljYWxsQ2hhaW46IGZ1bmN0aW9uKCl7CgkJaWYgKHRoaXMuY2hhaW5zICYmIHRoaXMuY2hhaW5zLmxlbmd0aCkgdGhpcy5jaGFpbnMuc2hpZnQoKS5kZWxheSgxMCwgdGhpcyk7Cgl9LAoKCS8qCglQcm9wZXJ0eTogY2xlYXJDaGFpbgoJCUNsZWFycyB0aGUgc3RhY2sgb2YgYSBDaGFpbiBpbnN0YW5jZS4KCSovCgoJY2xlYXJDaGFpbjogZnVuY3Rpb24oKXsKCQl0aGlzLmNoYWlucyA9IFtdOwoJfQoKfSk7CgovKgpDbGFzczogRXZlbnRzCglBbiAiVXRpbGl0eSIgQ2xhc3MuIEl0cyBtZXRob2RzIGNhbiBiZSBpbXBsZW1lbnRlZCB3aXRoIDxDbGFzcy5pbXBsZW1lbnQ+IGludG8gYW55IDxDbGFzcz4uCglJbiA8RnguQmFzZT4gQ2xhc3MsIGZvciBleGFtcGxlLCBpcyB1c2VkIHRvIGdpdmUgdGhlIHBvc3NpYmlsaXR5IGFkZCBhbnkgbnVtYmVyIG9mIGZ1bmN0aW9ucyB0byB0aGUgRWZmZWN0cyBldmVudHMsIGxpa2Ugb25Db21wbGV0ZSwgb25TdGFydCwgb25DYW5jZWwuCglFdmVudHMgaW4gYSBDbGFzcyB0aGF0IGltcGxlbWVudHMgPEV2ZW50cz4gY2FuIGJlIGVpdGhlciBhZGRlZCBhcyBhbiBvcHRpb24sIG9yIHdpdGggYWRkRXZlbnQuIE5ldmVyIHdpdGggLm9wdGlvbnMub25FdmVudE5hbWUuCgpFeGFtcGxlOgoJKHN0YXJ0IGNvZGUpCgl2YXIgbXlGeCA9IG5ldyBGeC5TdHlsZSgnZWxlbWVudCcsICdvcGFjaXR5JykuYWRkRXZlbnQoJ29uQ29tcGxldGUnLCBmdW5jdGlvbigpewoJCWFsZXJ0KCd0aGUgZWZmZWN0IGlzIGNvbXBsZXRlZCcpOwoJfSkuYWRkRXZlbnQoJ29uQ29tcGxldGUnLCBmdW5jdGlvbigpewoJCWFsZXJ0KCdJIHRvbGQgeW91IHRoZSBlZmZlY3QgaXMgY29tcGxldGVkJyk7Cgl9KTsKCglteUZ4LnN0YXJ0KDAsMSk7CgkvL3Vwb24gY29tcGxldGlvbiBpdCB3aWxsIGRpc3BsYXkgdGhlIDIgYWxlcnRzLCBpbiBvcmRlci4KCShlbmQpCgpJbXBsZW1lbnRpbmc6CglUaGlzIGNsYXNzIGNhbiBiZSBpbXBsZW1lbnRlZCBpbnRvIG90aGVyIGNsYXNzZXMgdG8gYWRkIHRoZSBmdW5jdGlvbmFsaXR5IHRvIHRoZW0uCglHb2VzIHdlbGwgd2l0aCB0aGUgPE9wdGlvbnM+IGNsYXNzLgoKRXhhbXBsZToKCShzdGFydCBjb2RlKQoJdmFyIFdpZGdldCA9IG5ldyBDbGFzcyh7CgkJaW5pdGlhbGl6ZTogZnVuY3Rpb24oKXt9LAoJCWZpbmlzaDogZnVuY3Rpb24oKXsKCQkJdGhpcy5maXJlRXZlbnQoJ29uQ29tcGxldGUnKTsKCQl9Cgl9KTsKCVdpZGdldC5pbXBsZW1lbnQobmV3IEV2ZW50cyk7CgkvL2xhdGVyLi4uCgl2YXIgbXlXaWRnZXQgPSBuZXcgV2lkZ2V0KCk7CglteVdpZGdldC5hZGRFdmVudCgnb25Db21wbGV0ZScsIG15ZnVuY3Rpb24pOwoJKGVuZCkKKi8KCnZhciBFdmVudHMgPSBuZXcgQ2xhc3MoewoKCS8qCglQcm9wZXJ0eTogYWRkRXZlbnQKCQlhZGRzIGFuIGV2ZW50IHRvIHRoZSBzdGFjayBvZiBldmVudHMgb2YgdGhlIENsYXNzIGluc3RhbmNlLgoKCUFyZ3VtZW50czoKCQl0eXBlIC0gc3RyaW5nOyB0aGUgZXZlbnQgbmFtZSAoZS5nLiAnb25Db21wbGV0ZScpCgkJZm4gLSBmdW5jdGlvbiB0byBleGVjdXRlCgkqLwoKCWFkZEV2ZW50OiBmdW5jdGlvbih0eXBlLCBmbil7CgkJaWYgKGZuICE9IENsYXNzLmVtcHR5KXsKCQkJdGhpcy4kZXZlbnRzID0gdGhpcy4kZXZlbnRzIHx8IHt9OwoJCQl0aGlzLiRldmVudHNbdHlwZV0gPSB0aGlzLiRldmVudHNbdHlwZV0gfHwgW107CgkJCXRoaXMuJGV2ZW50c1t0eXBlXS5pbmNsdWRlKGZuKTsKCQl9CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCS8qCglQcm9wZXJ0eTogZmlyZUV2ZW50CgkJZmlyZXMgYWxsIGV2ZW50cyBvZiB0aGUgc3BlY2lmaWVkIHR5cGUgaW4gdGhlIENsYXNzIGluc3RhbmNlLgoKCUFyZ3VtZW50czoKCQl0eXBlIC0gc3RyaW5nOyB0aGUgZXZlbnQgbmFtZSAoZS5nLiAnb25Db21wbGV0ZScpCgkJYXJncyAtIGFycmF5IG9yIHNpbmdsZSBvYmplY3Q7IGFyZ3VtZW50cyB0byBwYXNzIHRvIHRoZSBmdW5jdGlvbjsgaWYgbW9yZSB0aGFuIG9uZSBhcmd1bWVudCwgbXVzdCBiZSBhbiBhcnJheQoJCWRlbGF5IC0gKGludGVnZXIpIGRlbGF5IChpbiBtcykgdG8gd2FpdCB0byBleGVjdXRlIHRoZSBldmVudAoKCUV4YW1wbGU6Cgkoc3RhcnQgY29kZSkKCXZhciBXaWRnZXQgPSBuZXcgQ2xhc3MoewoJCWluaXRpYWxpemU6IGZ1bmN0aW9uKGFyZzEsIGFyZzIpewoJCQkuLi4KCQkJdGhpcy5maXJlRXZlbnQoIm9uSW5pdGlhbGl6ZSIsIFthcmcxLCBhcmcyXSwgNTApOwoJCX0KCX0pOwoJV2lkZ2V0LmltcGxlbWVudChuZXcgRXZlbnRzKTsKCShlbmQpCgkqLwoKCWZpcmVFdmVudDogZnVuY3Rpb24odHlwZSwgYXJncywgZGVsYXkpewoJCWlmICh0aGlzLiRldmVudHMgJiYgdGhpcy4kZXZlbnRzW3R5cGVdKXsKCQkJdGhpcy4kZXZlbnRzW3R5cGVdLmVhY2goZnVuY3Rpb24oZm4pewoJCQkJZm4uY3JlYXRlKHsnYmluZCc6IHRoaXMsICdkZWxheSc6IGRlbGF5LCAnYXJndW1lbnRzJzogYXJnc30pKCk7CgkJCX0sIHRoaXMpOwoJCX0KCQlyZXR1cm4gdGhpczsKCX0sCgoJLyoKCVByb3BlcnR5OiByZW1vdmVFdmVudAoJCXJlbW92ZXMgYW4gZXZlbnQgZnJvbSB0aGUgc3RhY2sgb2YgZXZlbnRzIG9mIHRoZSBDbGFzcyBpbnN0YW5jZS4KCglBcmd1bWVudHM6CgkJdHlwZSAtIHN0cmluZzsgdGhlIGV2ZW50IG5hbWUgKGUuZy4gJ29uQ29tcGxldGUnKQoJCWZuIC0gZnVuY3Rpb24gdGhhdCB3YXMgYWRkZWQKCSovCgoJcmVtb3ZlRXZlbnQ6IGZ1bmN0aW9uKHR5cGUsIGZuKXsKCQlpZiAodGhpcy4kZXZlbnRzICYmIHRoaXMuJGV2ZW50c1t0eXBlXSkgdGhpcy4kZXZlbnRzW3R5cGVdLnJlbW92ZShmbik7CgkJcmV0dXJuIHRoaXM7Cgl9Cgp9KTsKCi8qCkNsYXNzOiBPcHRpb25zCglBbiAiVXRpbGl0eSIgQ2xhc3MuIEl0cyBtZXRob2RzIGNhbiBiZSBpbXBsZW1lbnRlZCB3aXRoIDxDbGFzcy5pbXBsZW1lbnQ+IGludG8gYW55IDxDbGFzcz4uCglVc2VkIHRvIGF1dG9tYXRlIHRoZSBvcHRpb25zIHNldHRpbmdzLCBhbHNvIGFkZGluZyBDbGFzcyA8RXZlbnRzPiB3aGVuIHRoZSBvcHRpb24gYmVnaW5zIHdpdGggb24uCgoJRXhhbXBsZToKCQkoc3RhcnQgY29kZSkKCQl2YXIgV2lkZ2V0ID0gbmV3IENsYXNzKHsKCQkJb3B0aW9uczogewoJCQkJY29sb3I6ICcjZmZmJywKCQkJCXNpemU6IHsKCQkJCQl3aWR0aDogMTAwCgkJCQkJaGVpZ2h0OiAxMDAKCQkJCX0KCQkJfSwKCQkJaW5pdGlhbGl6ZTogZnVuY3Rpb24ob3B0aW9ucyl7CgkJCQl0aGlzLnNldE9wdGlvbnMob3B0aW9ucyk7CgkJCX0KCQl9KTsKCQlXaWRnZXQuaW1wbGVtZW50KG5ldyBPcHRpb25zKTsKCQkvL2xhdGVyLi4uCgkJdmFyIG15V2lkZ2V0ID0gbmV3IFdpZGdldCh7CgkJCWNvbG9yOiAnI2YwMCcsCgkJCXNpemU6IHsKCQkJCXdpZHRoOiAyMDAKCQkJfQoJCX0pOwoJCS8vbXlXaWRnZXQub3B0aW9ucyA9IHtjb2xvcjogI2YwMCwgc2l6ZToge3dpZHRoOiAyMDAsIGhlaWdodDogMTAwfX0KCQkoZW5kKQoqLwoKdmFyIE9wdGlvbnMgPSBuZXcgQ2xhc3MoewoKCS8qCglQcm9wZXJ0eTogc2V0T3B0aW9ucwoJCXNldHMgdGhpcy5vcHRpb25zCgoJQXJndW1lbnRzOgoJCWRlZmF1bHRzIC0gb2JqZWN0OyB0aGUgZGVmYXVsdCBzZXQgb2Ygb3B0aW9ucwoJCW9wdGlvbnMgLSBvYmplY3Q7IHRoZSB1c2VyIGVudGVyZWQgb3B0aW9ucy4gY2FuIGJlIGVtcHR5IHRvby4KCglOb3RlOgoJCWlmIHlvdXIgQ2xhc3MgaGFzIDxFdmVudHM+IGltcGxlbWVudGVkLCBldmVyeSBvcHRpb24gYmVnaW5uaW5nIHdpdGggb24sIGZvbGxvd2VkIGJ5IGEgY2FwaXRhbCBsZXR0ZXIgKG9uQ29tcGxldGUpIGJlY29tZXMgYW4gQ2xhc3MgaW5zdGFuY2UgZXZlbnQuCgkqLwoKCXNldE9wdGlvbnM6IGZ1bmN0aW9uKCl7CgkJdGhpcy5vcHRpb25zID0gJG1lcmdlLmFwcGx5KG51bGwsIFt0aGlzLm9wdGlvbnNdLmV4dGVuZChhcmd1bWVudHMpKTsKCQlpZiAodGhpcy5hZGRFdmVudCl7CgkJCWZvciAodmFyIG9wdGlvbiBpbiB0aGlzLm9wdGlvbnMpewoJCQkJaWYgKCR0eXBlKHRoaXMub3B0aW9uc1tvcHRpb25dID09ICdmdW5jdGlvbicpICYmICgvXm9uW0EtWl0vKS50ZXN0KG9wdGlvbikpIHRoaXMuYWRkRXZlbnQob3B0aW9uLCB0aGlzLm9wdGlvbnNbb3B0aW9uXSk7CgkJCX0KCQl9CgkJcmV0dXJuIHRoaXM7Cgl9Cgp9KTsKCi8qClNjcmlwdDogQXJyYXkuanMKCUNvbnRhaW5zIEFycmF5IHByb3RvdHlwZXMsIDwkQT4sIDwkZWFjaD4KCkxpY2Vuc2U6CglNSVQtc3R5bGUgbGljZW5zZS4KKi8KCi8qCkNsYXNzOiBBcnJheQoJQSBjb2xsZWN0aW9uIG9mIFRoZSBBcnJheSBPYmplY3QgcHJvdG90eXBlIG1ldGhvZHMuCiovCgovL2N1c3RvbSBtZXRob2RzCgpBcnJheS5leHRlbmQoewoKCS8qCglQcm9wZXJ0eTogZm9yRWFjaAoJCUl0ZXJhdGVzIHRocm91Z2ggYW4gYXJyYXk7IFRoaXMgbWV0aG9kIGlzIG9ubHkgYXZhaWxhYmxlIGZvciBicm93c2VycyB3aXRob3V0IG5hdGl2ZSAqZm9yRWFjaCogc3VwcG9ydC4KCQlGb3IgbW9yZSBpbmZvIHNlZSA8aHR0cDovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi9kb2NzL0NvcmVfSmF2YVNjcmlwdF8xLjVfUmVmZXJlbmNlOkdsb2JhbF9PYmplY3RzOkFycmF5OmZvckVhY2g+CgoJCSpmb3JFYWNoKiBleGVjdXRlcyB0aGUgcHJvdmlkZWQgZnVuY3Rpb24gKGNhbGxiYWNrKSBvbmNlIGZvciBlYWNoIGVsZW1lbnQgcHJlc2VudCBpbiB0aGUgYXJyYXkuIGNhbGxiYWNrIGlzIGludm9rZWQgb25seSBmb3IgaW5kZXhlcyBvZiB0aGUgYXJyYXkgd2hpY2ggaGF2ZSBhc3NpZ25lZCB2YWx1ZXM7IGl0IGlzIG5vdCBpbnZva2VkIGZvciBpbmRleGVzIHdoaWNoIGhhdmUgYmVlbiBkZWxldGVkIG9yIHdoaWNoIGhhdmUgbmV2ZXIgYmVlbiBhc3NpZ25lZCB2YWx1ZXMuCgoJQXJndW1lbnRzOgoJCWZuIC0gZnVuY3Rpb24gdG8gZXhlY3V0ZSB3aXRoIGVhY2ggaXRlbSBpbiB0aGUgYXJyYXk7IHBhc3NlZCB0aGUgaXRlbSBhbmQgdGhlIGluZGV4IG9mIHRoYXQgaXRlbSBpbiB0aGUgYXJyYXkKCQliaW5kIC0gdGhlIG9iamVjdCB0byBiaW5kICJ0aGlzIiB0byAoc2VlIDxGdW5jdGlvbi5iaW5kPikKCglFeGFtcGxlOgoJCT5bJ2FwcGxlJywnYmFuYW5hJywnbGVtb24nXS5lYWNoKGZ1bmN0aW9uKGl0ZW0sIGluZGV4KXsKCQk+CWFsZXJ0KGluZGV4ICsgIiA9ICIgKyBpdGVtKTsgLy9hbGVydHMgIjAgPSBhcHBsZSIgZXRjLgoJCT59LCBiaW5kT2JqKTsgLy9vcHRpb25hbCBzZWNvbmQgYXJnIGZvciBiaW5kaW5nLCBub3QgdXNlZCBoZXJlCgkqLwoKCWZvckVhY2g6IGZ1bmN0aW9uKGZuLCBiaW5kKXsKCQlmb3IgKHZhciBpID0gMCwgaiA9IHRoaXMubGVuZ3RoOyBpIDwgajsgaSsrKSBmbi5jYWxsKGJpbmQsIHRoaXNbaV0sIGksIHRoaXMpOwoJfSwKCgkvKgoJUHJvcGVydHk6IGZpbHRlcgoJCVRoaXMgbWV0aG9kIGlzIHByb3ZpZGVkIG9ubHkgZm9yIGJyb3dzZXJzIHdpdGhvdXQgbmF0aXZlICpmaWx0ZXIqIHN1cHBvcnQuCgkJRm9yIG1vcmUgaW5mbyBzZWUgPGh0dHA6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4vZG9jcy9Db3JlX0phdmFTY3JpcHRfMS41X1JlZmVyZW5jZTpPYmplY3RzOkFycmF5OmZpbHRlcj4KCgkJKmZpbHRlciogY2FsbHMgYSBwcm92aWRlZCBjYWxsYmFjayBmdW5jdGlvbiBvbmNlIGZvciBlYWNoIGVsZW1lbnQgaW4gYW4gYXJyYXksIGFuZCBjb25zdHJ1Y3RzIGEgbmV3IGFycmF5IG9mIGFsbCB0aGUgdmFsdWVzIGZvciB3aGljaCBjYWxsYmFjayByZXR1cm5zIGEgdHJ1ZSB2YWx1ZS4gY2FsbGJhY2sgaXMgaW52b2tlZCBvbmx5IGZvciBpbmRleGVzIG9mIHRoZSBhcnJheSB3aGljaCBoYXZlIGFzc2lnbmVkIHZhbHVlczsgaXQgaXMgbm90IGludm9rZWQgZm9yIGluZGV4ZXMgd2hpY2ggaGF2ZSBiZWVuIGRlbGV0ZWQgb3Igd2hpY2ggaGF2ZSBuZXZlciBiZWVuIGFzc2lnbmVkIHZhbHVlcy4gQXJyYXkgZWxlbWVudHMgd2hpY2ggZG8gbm90IHBhc3MgdGhlIGNhbGxiYWNrIHRlc3QgYXJlIHNpbXBseSBza2lwcGVkLCBhbmQgYXJlIG5vdCBpbmNsdWRlZCBpbiB0aGUgbmV3IGFycmF5LgoKCUFyZ3VtZW50czoKCQlmbiAtIGZ1bmN0aW9uIHRvIGV4ZWN1dGUgd2l0aCBlYWNoIGl0ZW0gaW4gdGhlIGFycmF5OyBwYXNzZWQgdGhlIGl0ZW0gYW5kIHRoZSBpbmRleCBvZiB0aGF0IGl0ZW0gaW4gdGhlIGFycmF5CgkJYmluZCAtIHRoZSBvYmplY3QgdG8gYmluZCAidGhpcyIgdG8gKHNlZSA8RnVuY3Rpb24uYmluZD4pCgoJRXhhbXBsZToKCQk+dmFyIGJpZ2dlclRoYW5Ud2VudHkgPSBbMTAsMywyNSwxMDBdLmZpbHRlcihmdW5jdGlvbihpdGVtLCBpbmRleCl7CgkJPiByZXR1cm4gaXRlbSA+IDIwOwoJCT59KTsKCQk+Ly9iaWdnZXJUaGFuVHdlbnR5ID0gWzI1LDEwMF0KCSovCgoJZmlsdGVyOiBmdW5jdGlvbihmbiwgYmluZCl7CgkJdmFyIHJlc3VsdHMgPSBbXTsKCQlmb3IgKHZhciBpID0gMCwgaiA9IHRoaXMubGVuZ3RoOyBpIDwgajsgaSsrKXsKCQkJaWYgKGZuLmNhbGwoYmluZCwgdGhpc1tpXSwgaSwgdGhpcykpIHJlc3VsdHMucHVzaCh0aGlzW2ldKTsKCQl9CgkJcmV0dXJuIHJlc3VsdHM7Cgl9LAoKCS8qCglQcm9wZXJ0eTogbWFwCgkJVGhpcyBtZXRob2QgaXMgcHJvdmlkZWQgb25seSBmb3IgYnJvd3NlcnMgd2l0aG91dCBuYXRpdmUgKm1hcCogc3VwcG9ydC4KCQlGb3IgbW9yZSBpbmZvIHNlZSA8aHR0cDovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi9kb2NzL0NvcmVfSmF2YVNjcmlwdF8xLjVfUmVmZXJlbmNlOkdsb2JhbF9PYmplY3RzOkFycmF5Om1hcD4KCgkJKm1hcCogY2FsbHMgYSBwcm92aWRlZCBjYWxsYmFjayBmdW5jdGlvbiBvbmNlIGZvciBlYWNoIGVsZW1lbnQgaW4gYW4gYXJyYXksIGluIG9yZGVyLCBhbmQgY29uc3RydWN0cyBhIG5ldyBhcnJheSBmcm9tIHRoZSByZXN1bHRzLiBjYWxsYmFjayBpcyBpbnZva2VkIG9ubHkgZm9yIGluZGV4ZXMgb2YgdGhlIGFycmF5IHdoaWNoIGhhdmUgYXNzaWduZWQgdmFsdWVzOyBpdCBpcyBub3QgaW52b2tlZCBmb3IgaW5kZXhlcyB3aGljaCBoYXZlIGJlZW4gZGVsZXRlZCBvciB3aGljaCBoYXZlIG5ldmVyIGJlZW4gYXNzaWduZWQgdmFsdWVzLgoKCUFyZ3VtZW50czoKCQlmbiAtIGZ1bmN0aW9uIHRvIGV4ZWN1dGUgd2l0aCBlYWNoIGl0ZW0gaW4gdGhlIGFycmF5OyBwYXNzZWQgdGhlIGl0ZW0gYW5kIHRoZSBpbmRleCBvZiB0aGF0IGl0ZW0gaW4gdGhlIGFycmF5CgkJYmluZCAtIHRoZSBvYmplY3QgdG8gYmluZCAidGhpcyIgdG8gKHNlZSA8RnVuY3Rpb24uYmluZD4pCgoJRXhhbXBsZToKCQk+dmFyIHRpbWVzVHdvID0gWzEsMiwzXS5tYXAoZnVuY3Rpb24oaXRlbSwgaW5kZXgpewoJCT4gcmV0dXJuIGl0ZW0qMjsKCQk+fSk7CgkJPi8vdGltZXNUd28gPSBbMiw0LDZdOwoJKi8KCgltYXA6IGZ1bmN0aW9uKGZuLCBiaW5kKXsKCQl2YXIgcmVzdWx0cyA9IFtdOwoJCWZvciAodmFyIGkgPSAwLCBqID0gdGhpcy5sZW5ndGg7IGkgPCBqOyBpKyspIHJlc3VsdHNbaV0gPSBmbi5jYWxsKGJpbmQsIHRoaXNbaV0sIGksIHRoaXMpOwoJCXJldHVybiByZXN1bHRzOwoJfSwKCgkvKgoJUHJvcGVydHk6IGV2ZXJ5CgkJVGhpcyBtZXRob2QgaXMgcHJvdmlkZWQgb25seSBmb3IgYnJvd3NlcnMgd2l0aG91dCBuYXRpdmUgKmV2ZXJ5KiBzdXBwb3J0LgoJCUZvciBtb3JlIGluZm8gc2VlIDxodHRwOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuL2RvY3MvQ29yZV9KYXZhU2NyaXB0XzEuNV9SZWZlcmVuY2U6R2xvYmFsX09iamVjdHM6QXJyYXk6ZXZlcnk+CgoJCSpldmVyeSogZXhlY3V0ZXMgdGhlIHByb3ZpZGVkIGNhbGxiYWNrIGZ1bmN0aW9uIG9uY2UgZm9yIGVhY2ggZWxlbWVudCBwcmVzZW50IGluIHRoZSBhcnJheSB1bnRpbCBpdCBmaW5kcyBvbmUgd2hlcmUgY2FsbGJhY2sgcmV0dXJucyBhIGZhbHNlIHZhbHVlLiBJZiBzdWNoIGFuIGVsZW1lbnQgaXMgZm91bmQsIHRoZSBldmVyeSBtZXRob2QgaW1tZWRpYXRlbHkgcmV0dXJucyBmYWxzZS4gT3RoZXJ3aXNlLCBpZiBjYWxsYmFjayByZXR1cm5lZCBhIHRydWUgdmFsdWUgZm9yIGFsbCBlbGVtZW50cywgZXZlcnkgd2lsbCByZXR1cm4gdHJ1ZS4gY2FsbGJhY2sgaXMgaW52b2tlZCBvbmx5IGZvciBpbmRleGVzIG9mIHRoZSBhcnJheSB3aGljaCBoYXZlIGFzc2lnbmVkIHZhbHVlczsgaXQgaXMgbm90IGludm9rZWQgZm9yIGluZGV4ZXMgd2hpY2ggaGF2ZSBiZWVuIGRlbGV0ZWQgb3Igd2hpY2ggaGF2ZSBuZXZlciBiZWVuIGFzc2lnbmVkIHZhbHVlcy4KCglBcmd1bWVudHM6CgkJZm4gLSBmdW5jdGlvbiB0byBleGVjdXRlIHdpdGggZWFjaCBpdGVtIGluIHRoZSBhcnJheTsgcGFzc2VkIHRoZSBpdGVtIGFuZCB0aGUgaW5kZXggb2YgdGhhdCBpdGVtIGluIHRoZSBhcnJheQoJCWJpbmQgLSB0aGUgb2JqZWN0IHRvIGJpbmQgInRoaXMiIHRvIChzZWUgPEZ1bmN0aW9uLmJpbmQ+KQoKCUV4YW1wbGU6CgkJPnZhciBhcmVBbGxCaWdFbm91Z2ggPSBbMTAsNCwyNSwxMDBdLmV2ZXJ5KGZ1bmN0aW9uKGl0ZW0sIGluZGV4KXsKCQk+IHJldHVybiBpdGVtID4gMjA7CgkJPn0pOwoJCT4vL2FyZUFsbEJpZ0Vub3VnaCA9IGZhbHNlCgkqLwoKCWV2ZXJ5OiBmdW5jdGlvbihmbiwgYmluZCl7CgkJZm9yICh2YXIgaSA9IDAsIGogPSB0aGlzLmxlbmd0aDsgaSA8IGo7IGkrKyl7CgkJCWlmICghZm4uY2FsbChiaW5kLCB0aGlzW2ldLCBpLCB0aGlzKSkgcmV0dXJuIGZhbHNlOwoJCX0KCQlyZXR1cm4gdHJ1ZTsKCX0sCgoJLyoKCVByb3BlcnR5OiBzb21lCgkJVGhpcyBtZXRob2QgaXMgcHJvdmlkZWQgb25seSBmb3IgYnJvd3NlcnMgd2l0aG91dCBuYXRpdmUgKnNvbWUqIHN1cHBvcnQuCgkJRm9yIG1vcmUgaW5mbyBzZWUgPGh0dHA6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4vZG9jcy9Db3JlX0phdmFTY3JpcHRfMS41X1JlZmVyZW5jZTpHbG9iYWxfT2JqZWN0czpBcnJheTpzb21lPgoKCQkqc29tZSogZXhlY3V0ZXMgdGhlIGNhbGxiYWNrIGZ1bmN0aW9uIG9uY2UgZm9yIGVhY2ggZWxlbWVudCBwcmVzZW50IGluIHRoZSBhcnJheSB1bnRpbCBpdCBmaW5kcyBvbmUgd2hlcmUgY2FsbGJhY2sgcmV0dXJucyBhIHRydWUgdmFsdWUuIElmIHN1Y2ggYW4gZWxlbWVudCBpcyBmb3VuZCwgc29tZSBpbW1lZGlhdGVseSByZXR1cm5zIHRydWUuIE90aGVyd2lzZSwgc29tZSByZXR1cm5zIGZhbHNlLiBjYWxsYmFjayBpcyBpbnZva2VkIG9ubHkgZm9yIGluZGV4ZXMgb2YgdGhlIGFycmF5IHdoaWNoIGhhdmUgYXNzaWduZWQgdmFsdWVzOyBpdCBpcyBub3QgaW52b2tlZCBmb3IgaW5kZXhlcyB3aGljaCBoYXZlIGJlZW4gZGVsZXRlZCBvciB3aGljaCBoYXZlIG5ldmVyIGJlZW4gYXNzaWduZWQgdmFsdWVzLgoKCUFyZ3VtZW50czoKCQlmbiAtIGZ1bmN0aW9uIHRvIGV4ZWN1dGUgd2l0aCBlYWNoIGl0ZW0gaW4gdGhlIGFycmF5OyBwYXNzZWQgdGhlIGl0ZW0gYW5kIHRoZSBpbmRleCBvZiB0aGF0IGl0ZW0gaW4gdGhlIGFycmF5CgkJYmluZCAtIHRoZSBvYmplY3QgdG8gYmluZCAidGhpcyIgdG8gKHNlZSA8RnVuY3Rpb24uYmluZD4pCgoJRXhhbXBsZToKCQk+dmFyIGlzQW55QmlnRW5vdWdoID0gWzEwLDQsMjUsMTAwXS5zb21lKGZ1bmN0aW9uKGl0ZW0sIGluZGV4KXsKCQk+IHJldHVybiBpdGVtID4gMjA7CgkJPn0pOwoJCT4vL2lzQW55QmlnRW5vdWdoID0gdHJ1ZQoJKi8KCglzb21lOiBmdW5jdGlvbihmbiwgYmluZCl7CgkJZm9yICh2YXIgaSA9IDAsIGogPSB0aGlzLmxlbmd0aDsgaSA8IGo7IGkrKyl7CgkJCWlmIChmbi5jYWxsKGJpbmQsIHRoaXNbaV0sIGksIHRoaXMpKSByZXR1cm4gdHJ1ZTsKCQl9CgkJcmV0dXJuIGZhbHNlOwoJfSwKCgkvKgoJUHJvcGVydHk6IGluZGV4T2YKCQlUaGlzIG1ldGhvZCBpcyBwcm92aWRlZCBvbmx5IGZvciBicm93c2VycyB3aXRob3V0IG5hdGl2ZSAqaW5kZXhPZiogc3VwcG9ydC4KCQlGb3IgbW9yZSBpbmZvIHNlZSA8aHR0cDovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi9kb2NzL0NvcmVfSmF2YVNjcmlwdF8xLjVfUmVmZXJlbmNlOkdsb2JhbF9PYmplY3RzOkFycmF5OmluZGV4T2Y+CgoJCSppbmRleE9mKiBjb21wYXJlcyBhIHNlYXJjaCBlbGVtZW50IHRvIGVsZW1lbnRzIG9mIHRoZSBBcnJheSB1c2luZyBzdHJpY3QgZXF1YWxpdHkgKHRoZSBzYW1lIG1ldGhvZCB1c2VkIGJ5IHRoZSA9PT0sIG9yIHRyaXBsZS1lcXVhbHMsIG9wZXJhdG9yKS4KCglBcmd1bWVudHM6CgkJaXRlbSAtIGFueSB0eXBlIG9mIG9iamVjdDsgZWxlbWVudCB0byBsb2NhdGUgaW4gdGhlIGFycmF5CgkJZnJvbSAtIGludGVnZXI7IG9wdGlvbmFsOyB0aGUgaW5kZXggb2YgdGhlIGFycmF5IGF0IHdoaWNoIHRvIGJlZ2luIHRoZSBzZWFyY2ggKGRlZmF1bHRzIHRvIDApCgoJRXhhbXBsZToKCQk+WydhcHBsZScsJ2xlbW9uJywnYmFuYW5hJ10uaW5kZXhPZignbGVtb24nKTsgLy9yZXR1cm5zIDEKCQk+WydhcHBsZScsJ2xlbW9uJ10uaW5kZXhPZignYmFuYW5hJyk7IC8vcmV0dXJucyAtMQoJKi8KCglpbmRleE9mOiBmdW5jdGlvbihpdGVtLCBmcm9tKXsKCQl2YXIgbGVuID0gdGhpcy5sZW5ndGg7CgkJZm9yICh2YXIgaSA9IChmcm9tIDwgMCkgPyBNYXRoLm1heCgwLCBsZW4gKyBmcm9tKSA6IGZyb20gfHwgMDsgaSA8IGxlbjsgaSsrKXsKCQkJaWYgKHRoaXNbaV0gPT09IGl0ZW0pIHJldHVybiBpOwoJCX0KCQlyZXR1cm4gLTE7Cgl9LAoKCS8qCglQcm9wZXJ0eTogZWFjaAoJCVNhbWUgYXMgPEFycmF5LmZvckVhY2g+LgoKCUFyZ3VtZW50czoKCQlmbiAtIGZ1bmN0aW9uIHRvIGV4ZWN1dGUgd2l0aCBlYWNoIGl0ZW0gaW4gdGhlIGFycmF5OyBwYXNzZWQgdGhlIGl0ZW0gYW5kIHRoZSBpbmRleCBvZiB0aGF0IGl0ZW0gaW4gdGhlIGFycmF5CgkJYmluZCAtIG9wdGlvbmFsLCB0aGUgb2JqZWN0IHRoYXQgdGhlICJ0aGlzIiBvZiB0aGUgZnVuY3Rpb24gd2lsbCByZWZlciB0by4KCglFeGFtcGxlOgoJCT52YXIgQW5pbWFscyA9IFsnQ2F0JywgJ0RvZycsICdDb2FsYSddOwoJCT5BbmltYWxzLmVhY2goZnVuY3Rpb24oYW5pbWFsKXsKCQk+CWRvY3VtZW50LndyaXRlKGFuaW1hbCkKCQk+fSk7CgkqLwoKCS8qCglQcm9wZXJ0eTogY29weQoJCXJldHVybnMgYSBjb3B5IG9mIHRoZSBhcnJheS4KCglSZXR1cm5zOgoJCWEgbmV3IGFycmF5IHdoaWNoIGlzIGEgY29weSBvZiB0aGUgY3VycmVudCBvbmUuCgoJQXJndW1lbnRzOgoJCXN0YXJ0IC0gaW50ZWdlcjsgb3B0aW9uYWw7IHRoZSBpbmRleCB3aGVyZSB0byBzdGFydCB0aGUgY29weSwgZGVmYXVsdCBpcyAwLiBJZiBuZWdhdGl2ZSwgaXQgaXMgdGFrZW4gYXMgdGhlIG9mZnNldCBmcm9tIHRoZSBlbmQgb2YgdGhlIGFycmF5LgoJCWxlbmd0aCAtIGludGVnZXI7IG9wdGlvbmFsOyB0aGUgbnVtYmVyIG9mIGVsZW1lbnRzIHRvIGNvcHkuIEJ5IGRlZmF1bHQsIGNvcGllcyBhbGwgZWxlbWVudHMgZnJvbSBzdGFydCB0byB0aGUgZW5kIG9mIHRoZSBhcnJheS4KCglFeGFtcGxlOgoJCT52YXIgbGV0dGVycyA9IFsiYSIsImIiLCJjIl07CgkJPnZhciBjb3B5ID0gbGV0dGVycy5jb3B5KCk7CQkvLyBbImEiLCJiIiwiYyJdIChuZXcgaW5zdGFuY2UpCgkqLwoKCWNvcHk6IGZ1bmN0aW9uKHN0YXJ0LCBsZW5ndGgpewoJCXN0YXJ0ID0gc3RhcnQgfHwgMDsKCQlpZiAoc3RhcnQgPCAwKSBzdGFydCA9IHRoaXMubGVuZ3RoICsgc3RhcnQ7CgkJbGVuZ3RoID0gbGVuZ3RoIHx8ICh0aGlzLmxlbmd0aCAtIHN0YXJ0KTsKCQl2YXIgbmV3QXJyYXkgPSBbXTsKCQlmb3IgKHZhciBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSBuZXdBcnJheVtpXSA9IHRoaXNbc3RhcnQrK107CgkJcmV0dXJuIG5ld0FycmF5OwoJfSwKCgkvKgoJUHJvcGVydHk6IHJlbW92ZQoJCVJlbW92ZXMgYWxsIG9jY3VycmVuY2VzIG9mIGFuIGl0ZW0gZnJvbSB0aGUgYXJyYXkuCgoJQXJndW1lbnRzOgoJCWl0ZW0gLSB0aGUgaXRlbSB0byByZW1vdmUKCglSZXR1cm5zOgoJCXRoZSBBcnJheSB3aXRoIGFsbCBvY2N1cnJlbmNlcyBvZiB0aGUgaXRlbSByZW1vdmVkLgoKCUV4YW1wbGU6CgkJPlsiMSIsIjIiLCIzIiwiMiJdLnJlbW92ZSgiMiIpIC8vIFsiMSIsIjMiXTsKCSovCgoJcmVtb3ZlOiBmdW5jdGlvbihpdGVtKXsKCQl2YXIgaSA9IDA7CgkJdmFyIGxlbiA9IHRoaXMubGVuZ3RoOwoJCXdoaWxlIChpIDwgbGVuKXsKCQkJaWYgKHRoaXNbaV0gPT09IGl0ZW0pewoJCQkJdGhpcy5zcGxpY2UoaSwgMSk7CgkJCQlsZW4tLTsKCQkJfSBlbHNlIHsKCQkJCWkrKzsKCQkJfQoJCX0KCQlyZXR1cm4gdGhpczsKCX0sCgoJLyoKCVByb3BlcnR5OiBjb250YWlucwoJCVRlc3RzIGFuIGFycmF5IGZvciB0aGUgcHJlc2VuY2Ugb2YgYW4gaXRlbS4KCglBcmd1bWVudHM6CgkJaXRlbSAtIHRoZSBpdGVtIHRvIHNlYXJjaCBmb3IgaW4gdGhlIGFycmF5LgoJCWZyb20gLSBpbnRlZ2VyOyBvcHRpb25hbDsgdGhlIGluZGV4IGF0IHdoaWNoIHRvIGJlZ2luIHRoZSBzZWFyY2gsIGRlZmF1bHQgaXMgMC4gSWYgbmVnYXRpdmUsIGl0IGlzIHRha2VuIGFzIHRoZSBvZmZzZXQgZnJvbSB0aGUgZW5kIG9mIHRoZSBhcnJheS4KCglSZXR1cm5zOgoJCXRydWUgLSB0aGUgaXRlbSB3YXMgZm91bmQKCQlmYWxzZSAtIGl0IHdhc24ndAoKCUV4YW1wbGU6CgkJPlsiYSIsImIiLCJjIl0uY29udGFpbnMoImEiKTsgLy8gdHJ1ZQoJCT5bImEiLCJiIiwiYyJdLmNvbnRhaW5zKCJkIik7IC8vIGZhbHNlCgkqLwoKCWNvbnRhaW5zOiBmdW5jdGlvbihpdGVtLCBmcm9tKXsKCQlyZXR1cm4gdGhpcy5pbmRleE9mKGl0ZW0sIGZyb20pICE9IC0xOwoJfSwKCgkvKgoJUHJvcGVydHk6IGFzc29jaWF0ZQoJCUNyZWF0ZXMgYW4gb2JqZWN0IHdpdGgga2V5LXZhbHVlIHBhaXJzIGJhc2VkIG9uIHRoZSBhcnJheSBvZiBrZXl3b3JkcyBwYXNzZWQgaW4KCQlhbmQgdGhlIGN1cnJlbnQgY29udGVudCBvZiB0aGUgYXJyYXkuCgoJQXJndW1lbnRzOgoJCWtleXMgLSB0aGUgYXJyYXkgb2Yga2V5d29yZHMuCgoJRXhhbXBsZToKCQkoc3RhcnQgY29kZSkKCQl2YXIgQW5pbWFscyA9IFsnQ2F0JywgJ0RvZycsICdDb2FsYScsICdMaXphcmQnXTsKCQl2YXIgU3BlZWNoID0gWydNaWFvJywgJ0JhdScsICdGcnV1dScsICdNdXRlJ107CgkJdmFyIFNwZWVjaGVzID0gQW5pbWFscy5hc3NvY2lhdGUoU3BlZWNoKTsKCQkvL1NwZWVjaGVzWydNaWFvJ10gaXMgbm93IENhdC4KCQkvL1NwZWVjaGVzWydCYXUnXSBpcyBub3cgRG9nLgoJCS8vLi4uCgkJKGVuZCkKCSovCgoJYXNzb2NpYXRlOiBmdW5jdGlvbihrZXlzKXsKCQl2YXIgb2JqID0ge30sIGxlbmd0aCA9IE1hdGgubWluKHRoaXMubGVuZ3RoLCBrZXlzLmxlbmd0aCk7CgkJZm9yICh2YXIgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgb2JqW2tleXNbaV1dID0gdGhpc1tpXTsKCQlyZXR1cm4gb2JqOwoJfSwKCgkvKgoJUHJvcGVydHk6IGV4dGVuZAoJCUV4dGVuZHMgYW4gYXJyYXkgd2l0aCBhbm90aGVyIG9uZS4KCglBcmd1bWVudHM6CgkJYXJyYXkgLSB0aGUgYXJyYXkgdG8gZXh0ZW5kIG91cnMgd2l0aAoKCUV4YW1wbGU6CgkJPnZhciBBbmltYWxzID0gWydDYXQnLCAnRG9nJywgJ0NvYWxhJ107CgkJPkFuaW1hbHMuZXh0ZW5kKFsnTGl6YXJkJ10pOwoJCT4vL0FuaW1hbHMgaXMgbm93OiBbJ0NhdCcsICdEb2cnLCAnQ29hbGEnLCAnTGl6YXJkJ107CgkqLwoKCWV4dGVuZDogZnVuY3Rpb24oYXJyYXkpewoJCWZvciAodmFyIGkgPSAwLCBqID0gYXJyYXkubGVuZ3RoOyBpIDwgajsgaSsrKSB0aGlzLnB1c2goYXJyYXlbaV0pOwoJCXJldHVybiB0aGlzOwoJfSwKCgkvKgoJUHJvcGVydHk6IG1lcmdlCgkJbWVyZ2VzIGFuIGFycmF5IGluIGFub3RoZXIgYXJyYXksIHdpdGhvdXQgZHVwbGljYXRlcy4gKGNhc2UtIGFuZCB0eXBlLXNlbnNpdGl2ZSkKCglBcmd1bWVudHM6CgkJYXJyYXkgLSB0aGUgYXJyYXkgdG8gbWVyZ2UgZnJvbS4KCglFeGFtcGxlOgoJCT5bJ0NhdCcsJ0RvZyddLm1lcmdlKFsnRG9nJywnQ29hbGEnXSk7IC8vcmV0dXJucyBbJ0NhdCcsJ0RvZycsJ0NvYWxhJ10KCSovCgoJbWVyZ2U6IGZ1bmN0aW9uKGFycmF5KXsKCQlmb3IgKHZhciBpID0gMCwgbCA9IGFycmF5Lmxlbmd0aDsgaSA8IGw7IGkrKykgdGhpcy5pbmNsdWRlKGFycmF5W2ldKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJLyoKCVByb3BlcnR5OiBpbmNsdWRlCgkJaW5jbHVkZXMgdGhlIHBhc3NlZCBpbiBlbGVtZW50IGluIHRoZSBhcnJheSwgb25seSBpZiBpdHMgbm90IGFscmVhZHkgcHJlc2VudC4gKGNhc2UtIGFuZCB0eXBlLXNlbnNpdGl2ZSkKCglBcmd1bWVudHM6CgkJaXRlbSAtIGl0ZW0gdG8gYWRkIHRvIHRoZSBhcnJheSAoaWYgbm90IHByZXNlbnQpCgoJRXhhbXBsZToKCQk+WydDYXQnLCdEb2cnXS5pbmNsdWRlKCdEb2cnKTsgLy9yZXR1cm5zIFsnQ2F0JywnRG9nJ10KCQk+WydDYXQnLCdEb2cnXS5pbmNsdWRlKCdDb2FsYScpOyAvL3JldHVybnMgWydDYXQnLCdEb2cnLCdDb2FsYSddCgkqLwoKCWluY2x1ZGU6IGZ1bmN0aW9uKGl0ZW0pewoJCWlmICghdGhpcy5jb250YWlucyhpdGVtKSkgdGhpcy5wdXNoKGl0ZW0pOwoJCXJldHVybiB0aGlzOwoJfSwKCgkvKgoJUHJvcGVydHk6IGdldFJhbmRvbQoJCXJldHVybnMgYSByYW5kb20gaXRlbSBpbiB0aGUgQXJyYXkKCSovCgoJZ2V0UmFuZG9tOiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzWyRyYW5kb20oMCwgdGhpcy5sZW5ndGggLSAxKV0gfHwgbnVsbDsKCX0sCgoJLyoKCVByb3BlcnR5OiBnZXRMYXN0CgkJcmV0dXJucyB0aGUgbGFzdCBpdGVtIGluIHRoZSBBcnJheQoJKi8KCglnZXRMYXN0OiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzW3RoaXMubGVuZ3RoIC0gMV0gfHwgbnVsbDsKCX0KCn0pOwoKLy9jb3BpZXMKCkFycmF5LnByb3RvdHlwZS5lYWNoID0gQXJyYXkucHJvdG90eXBlLmZvckVhY2g7CkFycmF5LmVhY2ggPSBBcnJheS5mb3JFYWNoOwoKLyogU2VjdGlvbjogVXRpbGl0eSBGdW5jdGlvbnMgKi8KCi8qCkZ1bmN0aW9uOiAkQSgpCglTYW1lIGFzIDxBcnJheS5jb3B5PiwgYnV0IGFzIGZ1bmN0aW9uLgoJVXNlZnVsIHRvIGFwcGx5IEFycmF5IHByb3RvdHlwZXMgdG8gaXRlcmFibGUgb2JqZWN0cywgYXMgYSBjb2xsZWN0aW9uIG9mIERPTSBlbGVtZW50cyBvciB0aGUgYXJndW1lbnRzIG9iamVjdC4KCkV4YW1wbGU6Cgkoc3RhcnQgY29kZSkKCWZ1bmN0aW9uIG15RnVuY3Rpb24oKXsKCQkkQShhcmd1bWVudHMpLmVhY2goYXJndW1lbnQsIGZ1bmN0aW9uKCl7CgkJCWFsZXJ0KGFyZ3VtZW50KTsKCQl9KTsKCX07CgkvL3RoZSBhYm92ZSB3aWxsIGFsZXJ0IGFsbCB0aGUgYXJndW1lbnRzIHBhc3NlZCB0byB0aGUgZnVuY3Rpb24gbXlGdW5jdGlvbi4KCShlbmQpCiovCgpmdW5jdGlvbiAkQShhcnJheSl7CglyZXR1cm4gQXJyYXkuY29weShhcnJheSk7Cn07CgovKgpGdW5jdGlvbjogJGVhY2gKCVVzZSB0byBpdGVyYXRlIHRocm91Z2ggaXRlcmFibGVzIHRoYXQgYXJlIG5vdCByZWd1bGFyIGFycmF5cywgc3VjaCBhcyBidWlsdGluIGdldEVsZW1lbnRzQnlUYWdOYW1lIGNhbGxzLCBhcmd1bWVudHMgb2YgYSBmdW5jdGlvbiwgb3IgYW4gb2JqZWN0LgoKQXJndW1lbnRzOgoJaXRlcmFibGUgLSBhbiBpdGVyYWJsZSBlbGVtZW50IG9yIGFuIG9iamN0LgoJZnVuY3Rpb24gLSBmdW5jdGlvbiB0byBhcHBseSB0byB0aGUgaXRlcmFibGUuCgliaW5kIC0gb3B0aW9uYWwsIHRoZSAndGhpcycgb2YgdGhlIGZ1bmN0aW9uIHdpbGwgcmVmZXIgdG8gdGhpcyBvYmplY3QuCgpGdW5jdGlvbiBhcmd1bWVudDoKCVRoZSBmdW5jdGlvbiBhcmd1bWVudCB3aWxsIGJlIHBhc3NlZCB0aGUgZm9sbG93aW5nIGFyZ3VtZW50cy4KCglpdGVtIC0gdGhlIGN1cnJlbnQgaXRlbSBpbiB0aGUgaXRlcmF0b3IgYmVpbmcgcHJvY2VzZWQKCWluZGV4IC0gaW50ZWdlcjsgdGhlIGluZGV4IG9mIHRoZSBpdGVtLCBvciBrZXkgaW4gY2FzZSBvZiBhbiBvYmplY3QuCgpFeGFtcGxlczoKCShzdGFydCBjb2RlKQoJJGVhY2goWydTdW4nLCdNb24nLCdUdWUnXSwgZnVuY3Rpb24oZGF5LCBpbmRleCl7CgkJYWxlcnQoJ25hbWU6JyArIGRheSArICcsIGluZGV4OiAnICsgaW5kZXgpOwoJfSk7CgkvL2FsZXJ0cyAibmFtZTogU3VuLCBpbmRleDogMCIsICJuYW1lOiBNb24sIGluZGV4OiAxIiwgZXRjLgoJLy9vdmVyIGFuIG9iamVjdAoJJGVhY2goe2ZpcnN0OiAiU3VuZGF5Iiwgc2Vjb25kOiAiTW9uZGF5IiwgdGhpcmQ6ICJUdWVzZGF5In0sIGZ1bmN0aW9uKHZhbHVlLCBrZXkpewoJCWFsZXJ0KCJ0aGUgIiArIGtleSArICIgZGF5IG9mIHRoZSB3ZWVrIGlzICIgKyB2YWx1ZSk7Cgl9KTsKCS8vYWxlcnRzICJ0aGUgZmlyc3QgZGF5IG9mIHRoZSB3ZWVrIGlzIFN1bmRheSIsCgkvLyJ0aGUgc2Vjb25kIGRheSBvZiB0aGUgd2VlayBpcyBNb25kYXkiLCBldGMuCgkoZW5kKQoqLwoKZnVuY3Rpb24gJGVhY2goaXRlcmFibGUsIGZuLCBiaW5kKXsKCWlmIChpdGVyYWJsZSAmJiB0eXBlb2YgaXRlcmFibGUubGVuZ3RoID09ICdudW1iZXInICYmICR0eXBlKGl0ZXJhYmxlKSAhPSAnb2JqZWN0Jyl7CgkJQXJyYXkuZm9yRWFjaChpdGVyYWJsZSwgZm4sIGJpbmQpOwoJfSBlbHNlIHsKCQkgZm9yICh2YXIgbmFtZSBpbiBpdGVyYWJsZSkgZm4uY2FsbChiaW5kIHx8IGl0ZXJhYmxlLCBpdGVyYWJsZVtuYW1lXSwgbmFtZSk7Cgl9Cn07CgovKmNvbXBhdGliaWxpdHkqLwoKQXJyYXkucHJvdG90eXBlLnRlc3QgPSBBcnJheS5wcm90b3R5cGUuY29udGFpbnM7CgovKmVuZCBjb21wYXRpYmlsaXR5Ki8KCi8qClNjcmlwdDogU3RyaW5nLmpzCglDb250YWlucyBTdHJpbmcgcHJvdG90eXBlcy4KCkxpY2Vuc2U6CglNSVQtc3R5bGUgbGljZW5zZS4KKi8KCi8qCkNsYXNzOiBTdHJpbmcKCUEgY29sbGVjdGlvbiBvZiBUaGUgU3RyaW5nIE9iamVjdCBwcm90b3R5cGUgbWV0aG9kcy4KKi8KClN0cmluZy5leHRlbmQoewoKCS8qCglQcm9wZXJ0eTogdGVzdAoJCVRlc3RzIGEgc3RyaW5nIHdpdGggYSByZWd1bGFyIGV4cHJlc3Npb24uCgoJQXJndW1lbnRzOgoJCXJlZ2V4IC0gYSBzdHJpbmcgb3IgcmVndWxhciBleHByZXNzaW9uIG9iamVjdCwgdGhlIHJlZ3VsYXIgZXhwcmVzc2lvbiB5b3Ugd2FudCB0byBtYXRjaCB0aGUgc3RyaW5nIHdpdGgKCQlwYXJhbXMgLSBvcHRpb25hbCwgaWYgZmlyc3QgcGFyYW1ldGVyIGlzIGEgc3RyaW5nLCBhbnkgcGFyYW1ldGVycyB5b3Ugd2FudCB0byBwYXNzIHRvIHRoZSByZWdleCAoJ2cnIGhhcyBubyBlZmZlY3QpCgoJUmV0dXJuczoKCQl0cnVlIGlmIGEgbWF0Y2ggZm9yIHRoZSByZWd1bGFyIGV4cHJlc3Npb24gaXMgZm91bmQgaW4gdGhlIHN0cmluZywgZmFsc2UgaWYgbm90LgoJCVNlZSA8aHR0cDovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi9kb2NzL0NvcmVfSmF2YVNjcmlwdF8xLjVfUmVmZXJlbmNlOk9iamVjdHM6UmVnRXhwOnRlc3Q+CgoJRXhhbXBsZToKCQk+IkkgbGlrZSBjb29raWVzIi50ZXN0KCJjb29raWUiKTsgLy8gcmV0dXJucyB0cnVlCgkJPiJJIGxpa2UgY29va2llcyIudGVzdCgiQ09PS0lFIiwgImkiKSAvLyBpZ25vcmUgY2FzZSwgcmV0dXJucyB0cnVlCgkJPiJJIGxpa2UgY29va2llcyIudGVzdCgiY2FrZSIpOyAvLyByZXR1cm5zIGZhbHNlCgkqLwoKCXRlc3Q6IGZ1bmN0aW9uKHJlZ2V4LCBwYXJhbXMpewoJCXJldHVybiAoKCR0eXBlKHJlZ2V4KSA9PSAnc3RyaW5nJykgPyBuZXcgUmVnRXhwKHJlZ2V4LCBwYXJhbXMpIDogcmVnZXgpLnRlc3QodGhpcyk7Cgl9LAoKCS8qCglQcm9wZXJ0eTogdG9JbnQKCQlwYXJzZXMgYSBzdHJpbmcgdG8gYW4gaW50ZWdlci4KCglSZXR1cm5zOgoJCWVpdGhlciBhbiBpbnQgb3IgIk5hTiIgaWYgdGhlIHN0cmluZyBpcyBub3QgYSBudW1iZXIuCgoJRXhhbXBsZToKCQk+dmFyIHZhbHVlID0gIjEwcHgiLnRvSW50KCk7IC8vIHZhbHVlIGlzIDEwCgkqLwoKCXRvSW50OiBmdW5jdGlvbigpewoJCXJldHVybiBwYXJzZUludCh0aGlzLCAxMCk7Cgl9LAoKCS8qCglQcm9wZXJ0eTogdG9GbG9hdAoJCXBhcnNlcyBhIHN0cmluZyB0byBhbiBmbG9hdC4KCglSZXR1cm5zOgoJCWVpdGhlciBhIGZsb2F0IG9yICJOYU4iIGlmIHRoZSBzdHJpbmcgaXMgbm90IGEgbnVtYmVyLgoKCUV4YW1wbGU6CgkJPnZhciB2YWx1ZSA9ICIxMC44NDgiLnRvRmxvYXQoKTsgLy8gdmFsdWUgaXMgMTAuODQ4CgkqLwoKCXRvRmxvYXQ6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHBhcnNlRmxvYXQodGhpcyk7Cgl9LAoKCS8qCglQcm9wZXJ0eTogY2FtZWxDYXNlCgkJQ29udmVydHMgYSBoaXBoZW5hdGVkIHN0cmluZyB0byBhIGNhbWVsY2FzZSBzdHJpbmcuCgoJRXhhbXBsZToKCQk+IkktbGlrZS1jb29raWVzIi5jYW1lbENhc2UoKTsgLy8iSUxpa2VDb29raWVzIgoKCVJldHVybnM6CgkJdGhlIGNhbWVsIGNhc2VkIHN0cmluZwoJKi8KCgljYW1lbENhc2U6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMucmVwbGFjZSgvLVxEL2csIGZ1bmN0aW9uKG1hdGNoKXsKCQkJcmV0dXJuIG1hdGNoLmNoYXJBdCgxKS50b1VwcGVyQ2FzZSgpOwoJCX0pOwoJfSwKCgkvKgoJUHJvcGVydHk6IGh5cGhlbmF0ZQoJCUNvbnZlcnRzIGEgY2FtZWxDYXNlZCBzdHJpbmcgdG8gYSBoeXBoZW4tYXRlZCBzdHJpbmcuCgoJRXhhbXBsZToKCQk+IklMaWtlQ29va2llcyIuaHlwaGVuYXRlKCk7IC8vIkktbGlrZS1jb29raWVzIgoJKi8KCgloeXBoZW5hdGU6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMucmVwbGFjZSgvXHdbQS1aXS9nLCBmdW5jdGlvbihtYXRjaCl7CgkJCXJldHVybiAobWF0Y2guY2hhckF0KDApICsgJy0nICsgbWF0Y2guY2hhckF0KDEpLnRvTG93ZXJDYXNlKCkpOwoJCX0pOwoJfSwKCgkvKgoJUHJvcGVydHk6IGNhcGl0YWxpemUKCQlDb252ZXJ0cyB0aGUgZmlyc3QgbGV0dGVyIGluIGVhY2ggd29yZCBvZiBhIHN0cmluZyB0byBVcHBlcmNhc2UuCgoJRXhhbXBsZToKCQk+ImkgbGlrZSBjb29raWVzIi5jYXBpdGFsaXplKCk7IC8vIkkgTGlrZSBDb29raWVzIgoKCVJldHVybnM6CgkJdGhlIGNhcGl0YWxpemVkIHN0cmluZwoJKi8KCgljYXBpdGFsaXplOiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLnJlcGxhY2UoL1xiW2Etel0vZywgZnVuY3Rpb24obWF0Y2gpewoJCQlyZXR1cm4gbWF0Y2gudG9VcHBlckNhc2UoKTsKCQl9KTsKCX0sCgoJLyoKCVByb3BlcnR5OiB0cmltCgkJVHJpbXMgdGhlIGxlYWRpbmcgYW5kIHRyYWlsaW5nIHNwYWNlcyBvZmYgYSBzdHJpbmcuCgoJRXhhbXBsZToKCQk+IiAgICBpIGxpa2UgY29va2llcyAgICAgIi50cmltKCkgLy8iaSBsaWtlIGNvb2tpZXMiCgoJUmV0dXJuczoKCQl0aGUgdHJpbW1lZCBzdHJpbmcKCSovCgoJdHJpbTogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5yZXBsYWNlKC9eXHMrfFxzKyQvZywgJycpOwoJfSwKCgkvKgoJUHJvcGVydHk6IGNsZWFuCgkJdHJpbXMgKDxTdHJpbmcudHJpbT4pIGEgc3RyaW5nIEFORCByZW1vdmVzIGFsbCB0aGUgZG91YmxlIHNwYWNlcyBpbiBhIHN0cmluZy4KCglSZXR1cm5zOgoJCXRoZSBjbGVhbmVkIHN0cmluZwoKCUV4YW1wbGU6CgkJPiIgaSAgICAgIGxpa2UgICAgIGNvb2tpZXMgICAgICBcblxuIi5jbGVhbigpIC8vImkgbGlrZSBjb29raWVzIgoJKi8KCgljbGVhbjogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5yZXBsYWNlKC9cc3syLH0vZywgJyAnKS50cmltKCk7Cgl9LAoKCS8qCglQcm9wZXJ0eTogcmdiVG9IZXgKCQlDb252ZXJ0cyBhbiBSR0IgdmFsdWUgdG8gaGV4aWRlY2ltYWwuIFRoZSBzdHJpbmcgbXVzdCBiZSBpbiB0aGUgZm9ybWF0IG9mICJyZ2IoMjU1LDI1NSwyNTUpIiBvciAicmdiYSgyNTUsMjU1LDI1NSwxKSI7CgoJQXJndW1lbnRzOgoJCWFycmF5IC0gYm9vbGVhbiB2YWx1ZSwgZGVmYXVsdHMgdG8gZmFsc2UuIFVzZSB0cnVlIGlmIHlvdSB3YW50IHRoZSBhcnJheSBbJ0ZGJywnMzMnLCcwMCddIGFzIG91dHB1dCBpbnN0ZWFkIG9mICIjRkYzMzAwIgoKCVJldHVybnM6CgkJaGV4IHN0cmluZyBvciBhcnJheS4gcmV0dXJucyAidHJhbnNwYXJlbnQiIGlmIHRoZSBvdXRwdXQgaXMgc2V0IGFzIHN0cmluZyBhbmQgdGhlIGZvdXJ0aCB2YWx1ZSBvZiByZ2JhIGluIGlucHV0IHN0cmluZyBpcyAwLgoKCUV4YW1wbGU6CgkJPiJyZ2IoMTcsMzQsNTEpIi5yZ2JUb0hleCgpOyAvLyIjMTEyMjMzIgoJCT4icmdiYSgxNywzNCw1MSwwKSIucmdiVG9IZXgoKTsgLy8idHJhbnNwYXJlbnQiCgkJPiJyZ2IoMTcsMzQsNTEpIi5yZ2JUb0hleCh0cnVlKTsgLy9bJzExJywnMjInLCczMyddCgkqLwoKCXJnYlRvSGV4OiBmdW5jdGlvbihhcnJheSl7CgkJdmFyIHJnYiA9IHRoaXMubWF0Y2goL1xkezEsM30vZyk7CgkJcmV0dXJuIChyZ2IpID8gcmdiLnJnYlRvSGV4KGFycmF5KSA6IGZhbHNlOwoJfSwKCgkvKgoJUHJvcGVydHk6IGhleFRvUmdiCgkJQ29udmVydHMgYSBoZXhpZGVjaW1hbCBjb2xvciB2YWx1ZSB0byBSR0IuIElucHV0IHN0cmluZyBtdXN0IGJlIHRoZSBoZXggY29sb3IgdmFsdWUgKHdpdGggb3Igd2l0aG91dCB0aGUgaGFzaCkuIEFsc28gYWNjZXB0cyB0cmlwbGV0cyAoJzMzMycpOwoKCUFyZ3VtZW50czoKCQlhcnJheSAtIGJvb2xlYW4gdmFsdWUsIGRlZmF1bHRzIHRvIGZhbHNlLiBVc2UgdHJ1ZSBpZiB5b3Ugd2FudCB0aGUgYXJyYXkgWzI1NSwyNTUsMjU1XSBhcyBvdXRwdXQgaW5zdGVhZCBvZiAicmdiKDI1NSwyNTUsMjU1KSI7CgoJUmV0dXJuczoKCQlyZ2Igc3RyaW5nIG9yIGFycmF5LgoKCUV4YW1wbGU6CgkJPiIjMTEyMjMzIi5oZXhUb1JnYigpOyAvLyJyZ2IoMTcsMzQsNTEpIgoJCT4iIzExMjIzMyIuaGV4VG9SZ2IodHJ1ZSk7IC8vWzE3LDM0LDUxXQoJKi8KCgloZXhUb1JnYjogZnVuY3Rpb24oYXJyYXkpewoJCXZhciBoZXggPSB0aGlzLm1hdGNoKC9eIz8oXHd7MSwyfSkoXHd7MSwyfSkoXHd7MSwyfSkkLyk7CgkJcmV0dXJuIChoZXgpID8gaGV4LnNsaWNlKDEpLmhleFRvUmdiKGFycmF5KSA6IGZhbHNlOwoJfSwKCgkvKgoJUHJvcGVydHk6IGNvbnRhaW5zCgkJY2hlY2tzIGlmIHRoZSBwYXNzZWQgaW4gc3RyaW5nIGlzIGNvbnRhaW5lZCBpbiB0aGUgU3RyaW5nLiBhbHNvIGFjY2VwdHMgYW4gb3B0aW9uYWwgc2Vjb25kIHBhcmFtZXRlciwgdG8gY2hlY2sgaWYgdGhlIHN0cmluZyBpcyBjb250YWluZWQgaW4gYSBsaXN0IG9mIHNlcGFyYXRlZCB2YWx1ZXMuCgoJRXhhbXBsZToKCQk+J2EgYiBjJy5jb250YWlucygnYycsICcgJyk7IC8vdHJ1ZQoJCT4nYSBiYycuY29udGFpbnMoJ2JjJyk7IC8vdHJ1ZQoJCT4nYSBiYycuY29udGFpbnMoJ2InLCAnICcpOyAvL2ZhbHNlCgkqLwoKCWNvbnRhaW5zOiBmdW5jdGlvbihzdHJpbmcsIHMpewoJCXJldHVybiAocykgPyAocyArIHRoaXMgKyBzKS5pbmRleE9mKHMgKyBzdHJpbmcgKyBzKSA+IC0xIDogdGhpcy5pbmRleE9mKHN0cmluZykgPiAtMTsKCX0sCgoJLyoKCVByb3BlcnR5OiBlc2NhcGVSZWdFeHAKCQlSZXR1cm5zIHN0cmluZyB3aXRoIGVzY2FwZWQgcmVndWxhciBleHByZXNzaW9uIGNoYXJhY3RlcnMKCglFeGFtcGxlOgoJCT52YXIgc2VhcmNoID0gJ2FuaW1hbHMuc2hlZXBzWzFdJy5lc2NhcGVSZWdFeHAoKTsgLy8gc2VhcmNoIGlzIG5vdyAnYW5pbWFsc1wuc2hlZXBzXFsxXF0nCgoJUmV0dXJuczoKCQlFc2NhcGVkIHN0cmluZwoJKi8KCgllc2NhcGVSZWdFeHA6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMucmVwbGFjZSgvKFsuKis/XiR7fSgpfFtcXVwvXFxdKS9nLCAnXFwkMScpOwoJfQoKfSk7CgpBcnJheS5leHRlbmQoewoKCS8qCglQcm9wZXJ0eTogcmdiVG9IZXgKCQlzZWUgPFN0cmluZy5yZ2JUb0hleD4sIGJ1dCBhcyBhbiBhcnJheSBtZXRob2QuCgkqLwoKCXJnYlRvSGV4OiBmdW5jdGlvbihhcnJheSl7CgkJaWYgKHRoaXMubGVuZ3RoIDwgMykgcmV0dXJuIGZhbHNlOwoJCWlmICh0aGlzLmxlbmd0aCA9PSA0ICYmIHRoaXNbM10gPT0gMCAmJiAhYXJyYXkpIHJldHVybiAndHJhbnNwYXJlbnQnOwoJCXZhciBoZXggPSBbXTsKCQlmb3IgKHZhciBpID0gMDsgaSA8IDM7IGkrKyl7CgkJCXZhciBiaXQgPSAodGhpc1tpXSAtIDApLnRvU3RyaW5nKDE2KTsKCQkJaGV4LnB1c2goKGJpdC5sZW5ndGggPT0gMSkgPyAnMCcgKyBiaXQgOiBiaXQpOwoJCX0KCQlyZXR1cm4gYXJyYXkgPyBoZXggOiAnIycgKyBoZXguam9pbignJyk7Cgl9LAoKCS8qCglQcm9wZXJ0eTogaGV4VG9SZ2IKCQlzYW1lIGFzIDxTdHJpbmcuaGV4VG9SZ2I+LCBidXQgYXMgYW4gYXJyYXkgbWV0aG9kLgoJKi8KCgloZXhUb1JnYjogZnVuY3Rpb24oYXJyYXkpewoJCWlmICh0aGlzLmxlbmd0aCAhPSAzKSByZXR1cm4gZmFsc2U7CgkJdmFyIHJnYiA9IFtdOwoJCWZvciAodmFyIGkgPSAwOyBpIDwgMzsgaSsrKXsKCQkJcmdiLnB1c2gocGFyc2VJbnQoKHRoaXNbaV0ubGVuZ3RoID09IDEpID8gdGhpc1tpXSArIHRoaXNbaV0gOiB0aGlzW2ldLCAxNikpOwoJCX0KCQlyZXR1cm4gYXJyYXkgPyByZ2IgOiAncmdiKCcgKyByZ2Iuam9pbignLCcpICsgJyknOwoJfQoKfSk7CgovKgpTY3JpcHQ6IEZ1bmN0aW9uLmpzCglDb250YWlucyBGdW5jdGlvbiBwcm90b3R5cGVzIGFuZCB1dGlsaXR5IGZ1bmN0aW9ucyAuCgpMaWNlbnNlOgoJTUlULXN0eWxlIGxpY2Vuc2UuCgpDcmVkaXRzOgoJLSBTb21lIGZ1bmN0aW9ucyBhcmUgaW5zcGlyZWQgYnkgdGhvc2UgZm91bmQgaW4gcHJvdG90eXBlLmpzIDxodHRwOi8vcHJvdG90eXBlLmNvbmlvLm5ldC8+IChjKSAyMDA1IFNhbSBTdGVwaGVuc29uIHNhbSBbYXRdIGNvbmlvIFtkb3RdIG5ldCwgTUlULXN0eWxlIGxpY2Vuc2UKKi8KCi8qCkNsYXNzOiBGdW5jdGlvbgoJQSBjb2xsZWN0aW9uIG9mIFRoZSBGdW5jdGlvbiBPYmplY3QgcHJvdG90eXBlIG1ldGhvZHMuCiovCgpGdW5jdGlvbi5leHRlbmQoewoKCS8qCglQcm9wZXJ0eTogY3JlYXRlCgkJTWFpbiBmdW5jdGlvbiB0byBjcmVhdGUgY2xvc3VyZXMuCgoJUmV0dXJuczoKCQlhIGZ1bmN0aW9uLgoKCUFyZ3VtZW50czoKCQlvcHRpb25zIC0gQW4gT3B0aW9ucyBvYmplY3QuCgoJT3B0aW9uczoKCQliaW5kIC0gVGhlIG9iamVjdCB0aGF0IHRoZSAidGhpcyIgb2YgdGhlIGZ1bmN0aW9uIHdpbGwgcmVmZXIgdG8uIERlZmF1bHQgaXMgdGhlIGN1cnJlbnQgZnVuY3Rpb24uCgkJZXZlbnQgLSBJZiBzZXQgdG8gdHJ1ZSwgdGhlIGZ1bmN0aW9uIHdpbGwgYWN0IGFzIGFuIGV2ZW50IGxpc3RlbmVyIGFuZCByZWNlaXZlIGFuIGV2ZW50IGFzIGZpcnN0IGFyZ3VtZW50LgoJCQkJSWYgc2V0IHRvIGEgY2xhc3MgbmFtZSwgdGhlIGZ1bmN0aW9uIHdpbGwgcmVjZWl2ZSBhIG5ldyBpbnN0YW5jZSBvZiB0aGlzIGNsYXNzICh3aXRoIHRoZSBldmVudCBwYXNzZWQgYXMgYXJndW1lbnQncyBjb25zdHJ1Y3RvcikgYXMgZmlyc3QgYXJndW1lbnQuCgkJCQlEZWZhdWx0IGlzIGZhbHNlLgoJCWFyZ3VtZW50cyAtIEEgc2luZ2xlIGFyZ3VtZW50IG9yIGFycmF5IG9mIGFyZ3VtZW50cyB0aGF0IHdpbGwgYmUgcGFzc2VkIHRvIHRoZSBmdW5jdGlvbiB3aGVuIGNhbGxlZC4KCgkJCQkJSWYgYm90aCB0aGUgZXZlbnQgYW5kIGFyZ3VtZW50cyBvcHRpb25zIGFyZSBzZXQsIHRoZSBldmVudCBpcyBwYXNzZWQgYXMgZmlyc3QgYXJndW1lbnQgYW5kIHRoZSBhcmd1bWVudHMgYXJyYXkgd2lsbCBmb2xsb3cuCgoJCQkJCURlZmF1bHQgaXMgbm8gY3VzdG9tIGFyZ3VtZW50cywgdGhlIGZ1bmN0aW9uIHdpbGwgcmVjZWl2ZSB0aGUgc3RhbmRhcmQgYXJndW1lbnRzIHdoZW4gY2FsbGVkLgoKCQlkZWxheSAtIE51bWVyaWMgdmFsdWU6IGlmIHNldCwgdGhlIHJldHVybmVkIGZ1bmN0aW9uIHdpbGwgZGVsYXkgdGhlIGFjdHVhbCBleGVjdXRpb24gYnkgdGhpcyBhbW91bnQgb2YgbWlsbGlzZWNvbmRzIGFuZCByZXR1cm4gYSB0aW1lciBoYW5kbGUgd2hlbiBjYWxsZWQuCgkJCQlEZWZhdWx0IGlzIG5vIGRlbGF5LgoJCXBlcmlvZGljYWwgLSBOdW1lcmljIHZhbHVlOiBpZiBzZXQsIHRoZSByZXR1cm5lZCBmdW5jdGlvbiB3aWxsIHBlcmlvZGljYWxseSBwZXJmb3JtIHRoZSBhY3R1YWwgZXhlY3V0aW9uIHdpdGggdGhpcyBzcGVjaWZpZWQgaW50ZXJ2YWwgYW5kIHJldHVybiBhIHRpbWVyIGhhbmRsZSB3aGVuIGNhbGxlZC4KCQkJCURlZmF1bHQgaXMgbm8gcGVyaW9kaWNhbCBleGVjdXRpb24uCgkJYXR0ZW1wdCAtIElmIHNldCB0byB0cnVlLCB0aGUgcmV0dXJuZWQgZnVuY3Rpb24gd2lsbCB0cnkgdG8gZXhlY3V0ZSBhbmQgcmV0dXJuIGVpdGhlciB0aGUgcmVzdWx0cyBvciBmYWxzZSBvbiBlcnJvci4gRGVmYXVsdCBpcyBmYWxzZS4KCSovCgoJY3JlYXRlOiBmdW5jdGlvbihvcHRpb25zKXsKCQl2YXIgZm4gPSB0aGlzOwoJCW9wdGlvbnMgPSAkbWVyZ2UoewoJCQknYmluZCc6IGZuLAoJCQknZXZlbnQnOiBmYWxzZSwKCQkJJ2FyZ3VtZW50cyc6IG51bGwsCgkJCSdkZWxheSc6IGZhbHNlLAoJCQkncGVyaW9kaWNhbCc6IGZhbHNlLAoJCQknYXR0ZW1wdCc6IGZhbHNlCgkJfSwgb3B0aW9ucyk7CgkJaWYgKCRjaGsob3B0aW9ucy5hcmd1bWVudHMpICYmICR0eXBlKG9wdGlvbnMuYXJndW1lbnRzKSAhPSAnYXJyYXknKSBvcHRpb25zLmFyZ3VtZW50cyA9IFtvcHRpb25zLmFyZ3VtZW50c107CgkJcmV0dXJuIGZ1bmN0aW9uKGV2ZW50KXsKCQkJdmFyIGFyZ3M7CgkJCWlmIChvcHRpb25zLmV2ZW50KXsKCQkJCWV2ZW50ID0gZXZlbnQgfHwgd2luZG93LmV2ZW50OwoJCQkJYXJncyA9IFsob3B0aW9ucy5ldmVudCA9PT0gdHJ1ZSkgPyBldmVudCA6IG5ldyBvcHRpb25zLmV2ZW50KGV2ZW50KV07CgkJCQlpZiAob3B0aW9ucy5hcmd1bWVudHMpIGFyZ3MuZXh0ZW5kKG9wdGlvbnMuYXJndW1lbnRzKTsKCQkJfQoJCQllbHNlIGFyZ3MgPSBvcHRpb25zLmFyZ3VtZW50cyB8fCBhcmd1bWVudHM7CgkJCXZhciByZXR1cm5zID0gZnVuY3Rpb24oKXsKCQkJCXJldHVybiBmbi5hcHBseSgkcGljayhvcHRpb25zLmJpbmQsIGZuKSwgYXJncyk7CgkJCX07CgkJCWlmIChvcHRpb25zLmRlbGF5KSByZXR1cm4gc2V0VGltZW91dChyZXR1cm5zLCBvcHRpb25zLmRlbGF5KTsKCQkJaWYgKG9wdGlvbnMucGVyaW9kaWNhbCkgcmV0dXJuIHNldEludGVydmFsKHJldHVybnMsIG9wdGlvbnMucGVyaW9kaWNhbCk7CgkJCWlmIChvcHRpb25zLmF0dGVtcHQpIHRyeSB7cmV0dXJuIHJldHVybnMoKTt9IGNhdGNoKGVycil7cmV0dXJuIGZhbHNlO307CgkJCXJldHVybiByZXR1cm5zKCk7CgkJfTsKCX0sCgoJLyoKCVByb3BlcnR5OiBwYXNzCgkJU2hvcnRjdXQgdG8gY3JlYXRlIGNsb3N1cmVzIHdpdGggYXJndW1lbnRzIGFuZCBiaW5kLgoKCVJldHVybnM6CgkJYSBmdW5jdGlvbi4KCglBcmd1bWVudHM6CgkJYXJncyAtIHRoZSBhcmd1bWVudHMgcGFzc2VkLiBtdXN0IGJlIGFuIGFycmF5IGlmIGFyZ3VtZW50cyA+IDEKCQliaW5kIC0gb3B0aW9uYWwsIHRoZSBvYmplY3QgdGhhdCB0aGUgInRoaXMiIG9mIHRoZSBmdW5jdGlvbiB3aWxsIHJlZmVyIHRvLgoKCUV4YW1wbGU6CgkJPm15RnVuY3Rpb24ucGFzcyhbYXJnMSwgYXJnMl0sIG15RWxlbWVudCk7CgkqLwoKCXBhc3M6IGZ1bmN0aW9uKGFyZ3MsIGJpbmQpewoJCXJldHVybiB0aGlzLmNyZWF0ZSh7J2FyZ3VtZW50cyc6IGFyZ3MsICdiaW5kJzogYmluZH0pOwoJfSwKCgkvKgoJUHJvcGVydHk6IGF0dGVtcHQKCQlUcmllcyB0byBleGVjdXRlIHRoZSBmdW5jdGlvbiwgcmV0dXJucyBlaXRoZXIgdGhlIHJlc3VsdCBvZiB0aGUgZnVuY3Rpb24gb3IgZmFsc2Ugb24gZXJyb3IuCgoJQXJndW1lbnRzOgoJCWFyZ3MgLSB0aGUgYXJndW1lbnRzIHBhc3NlZC4gbXVzdCBiZSBhbiBhcnJheSBpZiBhcmd1bWVudHMgPiAxCgkJYmluZCAtIG9wdGlvbmFsLCB0aGUgb2JqZWN0IHRoYXQgdGhlICJ0aGlzIiBvZiB0aGUgZnVuY3Rpb24gd2lsbCByZWZlciB0by4KCglFeGFtcGxlOgoJCT5teUZ1bmN0aW9uLmF0dGVtcHQoW2FyZzEsIGFyZzJdLCBteUVsZW1lbnQpOwoJKi8KCglhdHRlbXB0OiBmdW5jdGlvbihhcmdzLCBiaW5kKXsKCQlyZXR1cm4gdGhpcy5jcmVhdGUoeydhcmd1bWVudHMnOiBhcmdzLCAnYmluZCc6IGJpbmQsICdhdHRlbXB0JzogdHJ1ZX0pKCk7Cgl9LAoKCS8qCglQcm9wZXJ0eTogYmluZAoJCW1ldGhvZCB0byBlYXNpbHkgY3JlYXRlIGNsb3N1cmVzIHdpdGggInRoaXMiIGFsdGVyZWQuCgoJQXJndW1lbnRzOgoJCWJpbmQgLSBvcHRpb25hbCwgdGhlIG9iamVjdCB0aGF0IHRoZSAidGhpcyIgb2YgdGhlIGZ1bmN0aW9uIHdpbGwgcmVmZXIgdG8uCgkJYXJncyAtIG9wdGlvbmFsLCB0aGUgYXJndW1lbnRzIHBhc3NlZC4gbXVzdCBiZSBhbiBhcnJheSBpZiBhcmd1bWVudHMgPiAxCgoJUmV0dXJuczoKCQlhIGZ1bmN0aW9uLgoKCUV4YW1wbGU6CgkJPmZ1bmN0aW9uIG15RnVuY3Rpb24oKXsKCQk+CXRoaXMuc2V0U3R5bGUoJ2NvbG9yJywgJ3JlZCcpOwoJCT4JLy8gbm90ZSB0aGF0ICd0aGlzJyBoZXJlIHJlZmVycyB0byBteUZ1bmN0aW9uLCBub3QgYW4gZWxlbWVudAoJCT4JLy8gd2UnbGwgbmVlZCB0byBiaW5kIHRoaXMgZnVuY3Rpb24gdG8gdGhlIGVsZW1lbnQgd2Ugd2FudCB0byBhbHRlcgoJCT59OwoJCT52YXIgbXlCb3VuZEZ1bmN0aW9uID0gbXlGdW5jdGlvbi5iaW5kKG15RWxlbWVudCk7CgkJPm15Qm91bmRGdW5jdGlvbigpOyAvLyB0aGlzIHdpbGwgbWFrZSB0aGUgZWxlbWVudCBteUVsZW1lbnQgcmVkLgoJKi8KCgliaW5kOiBmdW5jdGlvbihiaW5kLCBhcmdzKXsKCQlyZXR1cm4gdGhpcy5jcmVhdGUoeydiaW5kJzogYmluZCwgJ2FyZ3VtZW50cyc6IGFyZ3N9KTsKCX0sCgoJLyoKCVByb3BlcnR5OiBiaW5kQXNFdmVudExpc3RlbmVyCgkJY3Jvc3MgYnJvd3NlciBtZXRob2QgdG8gcGFzcyBldmVudCBmaXJlcgoKCUFyZ3VtZW50czoKCQliaW5kIC0gb3B0aW9uYWwsIHRoZSBvYmplY3QgdGhhdCB0aGUgInRoaXMiIG9mIHRoZSBmdW5jdGlvbiB3aWxsIHJlZmVyIHRvLgoJCWFyZ3MgLSBvcHRpb25hbCwgdGhlIGFyZ3VtZW50cyBwYXNzZWQuIG11c3QgYmUgYW4gYXJyYXkgaWYgYXJndW1lbnRzID4gMQoKCVJldHVybnM6CgkJYSBmdW5jdGlvbiB3aXRoIHRoZSBwYXJhbWV0ZXIgYmluZCBhcyBpdHMgInRoaXMiIGFuZCBhcyBhIHByZS1wYXNzZWQgYXJndW1lbnQgZXZlbnQgb3Igd2luZG93LmV2ZW50LCBkZXBlbmRpbmcgb24gdGhlIGJyb3dzZXIuCgoJRXhhbXBsZToKCQk+ZnVuY3Rpb24gbXlGdW5jdGlvbihldmVudCl7CgkJPglhbGVydChldmVudC5jbGllbnR4KSAvL3JldHVybnMgdGhlIGNvb3JkaW5hdGVzIG9mIHRoZSBtb3VzZS4uCgkJPn07CgkJPm15RWxlbWVudC5vbmNsaWNrID0gbXlGdW5jdGlvbi5iaW5kQXNFdmVudExpc3RlbmVyKG15RWxlbWVudCk7CgkqLwoKCWJpbmRBc0V2ZW50TGlzdGVuZXI6IGZ1bmN0aW9uKGJpbmQsIGFyZ3MpewoJCXJldHVybiB0aGlzLmNyZWF0ZSh7J2JpbmQnOiBiaW5kLCAnZXZlbnQnOiB0cnVlLCAnYXJndW1lbnRzJzogYXJnc30pOwoJfSwKCgkvKgoJUHJvcGVydHk6IGRlbGF5CgkJRGVsYXlzIHRoZSBleGVjdXRpb24gb2YgYSBmdW5jdGlvbiBieSBhIHNwZWNpZmllZCBkdXJhdGlvbi4KCglBcmd1bWVudHM6CgkJZGVsYXkgLSB0aGUgZHVyYXRpb24gdG8gd2FpdCBpbiBtaWxsaXNlY29uZHMuCgkJYmluZCAtIG9wdGlvbmFsLCB0aGUgb2JqZWN0IHRoYXQgdGhlICJ0aGlzIiBvZiB0aGUgZnVuY3Rpb24gd2lsbCByZWZlciB0by4KCQlhcmdzIC0gb3B0aW9uYWwsIHRoZSBhcmd1bWVudHMgcGFzc2VkLiBtdXN0IGJlIGFuIGFycmF5IGlmIGFyZ3VtZW50cyA+IDEKCglFeGFtcGxlOgoJCT5teUZ1bmN0aW9uLmRlbGF5KDUwLCBteUVsZW1lbnQpIC8vd2FpdCA1MCBtaWxsaXNlY29uZHMsIHRoZW4gY2FsbCBteUZ1bmN0aW9uIGFuZCBiaW5kIG15RWxlbWVudCB0byBpdAoJCT4oZnVuY3Rpb24oKXthbGVydCgnb25lIHNlY29uZCBsYXRlci4uLicpfSkuZGVsYXkoMTAwMCk7IC8vd2FpdCBhIHNlY29uZCBhbmQgYWxlcnQKCSovCgoJZGVsYXk6IGZ1bmN0aW9uKGRlbGF5LCBiaW5kLCBhcmdzKXsKCQlyZXR1cm4gdGhpcy5jcmVhdGUoeydkZWxheSc6IGRlbGF5LCAnYmluZCc6IGJpbmQsICdhcmd1bWVudHMnOiBhcmdzfSkoKTsKCX0sCgoJLyoKCVByb3BlcnR5OiBwZXJpb2RpY2FsCgkJRXhlY3V0ZXMgYSBmdW5jdGlvbiBpbiB0aGUgc3BlY2lmaWVkIGludGVydmFscyBvZiB0aW1lCgoJQXJndW1lbnRzOgoJCWludGVydmFsIC0gdGhlIGR1cmF0aW9uIG9mIHRoZSBpbnRlcnZhbHMgYmV0d2VlbiBleGVjdXRpb25zLgoJCWJpbmQgLSBvcHRpb25hbCwgdGhlIG9iamVjdCB0aGF0IHRoZSAidGhpcyIgb2YgdGhlIGZ1bmN0aW9uIHdpbGwgcmVmZXIgdG8uCgkJYXJncyAtIG9wdGlvbmFsLCB0aGUgYXJndW1lbnRzIHBhc3NlZC4gbXVzdCBiZSBhbiBhcnJheSBpZiBhcmd1bWVudHMgPiAxCgkqLwoKCXBlcmlvZGljYWw6IGZ1bmN0aW9uKGludGVydmFsLCBiaW5kLCBhcmdzKXsKCQlyZXR1cm4gdGhpcy5jcmVhdGUoeydwZXJpb2RpY2FsJzogaW50ZXJ2YWwsICdiaW5kJzogYmluZCwgJ2FyZ3VtZW50cyc6IGFyZ3N9KSgpOwoJfQoKfSk7CgovKgpTY3JpcHQ6IE51bWJlci5qcwoJQ29udGFpbnMgdGhlIE51bWJlciBwcm90b3R5cGVzLgoKTGljZW5zZToKCU1JVC1zdHlsZSBsaWNlbnNlLgoqLwoKLyoKQ2xhc3M6IE51bWJlcgoJQSBjb2xsZWN0aW9uIG9mIFRoZSBOdW1iZXIgT2JqZWN0IHByb3RvdHlwZSBtZXRob2RzLgoqLwoKTnVtYmVyLmV4dGVuZCh7CgoJLyoKCVByb3BlcnR5OiB0b0ludAoJCVJldHVybnMgdGhpcyBudW1iZXI7IHVzZWZ1bCBiZWNhdXNlIHRvSW50IG11c3Qgd29yayBvbiBib3RoIFN0cmluZ3MgYW5kIE51bWJlcnMuCgkqLwoKCXRvSW50OiBmdW5jdGlvbigpewoJCXJldHVybiBwYXJzZUludCh0aGlzKTsKCX0sCgoJLyoKCVByb3BlcnR5OiB0b0Zsb2F0CgkJUmV0dXJucyB0aGlzIG51bWJlciBhcyBhIGZsb2F0OyB1c2VmdWwgYmVjYXVzZSB0b0Zsb2F0IG11c3Qgd29yayBvbiBib3RoIFN0cmluZ3MgYW5kIE51bWJlcnMuCgkqLwoKCXRvRmxvYXQ6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHBhcnNlRmxvYXQodGhpcyk7Cgl9LAoKCS8qCglQcm9wZXJ0eTogbGltaXQKCQlMaW1pdHMgdGhlIG51bWJlci4KCglBcmd1bWVudHM6CgkJbWluIC0gbnVtYmVyLCBtaW5pbXVtIHZhbHVlCgkJbWF4IC0gbnVtYmVyLCBtYXhpbXVtIHZhbHVlCgoJUmV0dXJuczoKCQl0aGUgbnVtYmVyIGluIHRoZSBnaXZlbiBsaW1pdHMuCgoJRXhhbXBsZToKCQk+KDEyKS5saW1pdCgyLCA2LjUpICAvLyByZXR1cm5zIDYuNQoJCT4oLTQpLmxpbWl0KDIsIDYuNSkgIC8vIHJldHVybnMgMgoJCT4oNC4zKS5saW1pdCgyLCA2LjUpIC8vIHJldHVybnMgNC4zCgkqLwoKCWxpbWl0OiBmdW5jdGlvbihtaW4sIG1heCl7CgkJcmV0dXJuIE1hdGgubWluKG1heCwgTWF0aC5tYXgobWluLCB0aGlzKSk7Cgl9LAoKCS8qCglQcm9wZXJ0eTogcm91bmQKCQlSZXR1cm5zIHRoZSBudW1iZXIgcm91bmRlZCB0byBzcGVjaWZpZWQgcHJlY2lzaW9uLgoKCUFyZ3VtZW50czoKCQlwcmVjaXNpb24gLSBpbnRlZ2VyLCBudW1iZXIgb2YgZGlnaXRzIGFmdGVyIHRoZSBkZWNpbWFsIHBvaW50LiBDYW4gYWxzbyBiZSBuZWdhdGl2ZSBvciB6ZXJvIChkZWZhdWx0KS4KCglFeGFtcGxlOgoJCT4xMi40NS5yb3VuZCgpIC8vIHJldHVybnMgMTIKCQk+MTIuNDUucm91bmQoMSkgLy8gcmV0dXJucyAxMi41CgkJPjEyLjQ1LnJvdW5kKC0xKSAvLyByZXR1cm5zIDEwCgoJUmV0dXJuczoKCQlUaGUgcm91bmRlZCBudW1iZXIuCgkqLwoKCXJvdW5kOiBmdW5jdGlvbihwcmVjaXNpb24pewoJCXByZWNpc2lvbiA9IE1hdGgucG93KDEwLCBwcmVjaXNpb24gfHwgMCk7CgkJcmV0dXJuIE1hdGgucm91bmQodGhpcyAqIHByZWNpc2lvbikgLyBwcmVjaXNpb247Cgl9LAoKCS8qCglQcm9wZXJ0eTogdGltZXMKCQlFeGVjdXRlcyBhIHBhc3NlZCBpbiBmdW5jdGlvbiB0aGUgc3BlY2lmaWVkIG51bWJlciBvZiB0aW1lcwoKCUFyZ3VtZW50czoKCQlmdW5jdGlvbiAtIHRoZSBmdW5jdGlvbiB0byBiZSBleGVjdXRlZCBvbiBlYWNoIGl0ZXJhdGlvbiBvZiB0aGUgbG9vcAoKCUV4YW1wbGU6CgkJPig0KS50aW1lcyhhbGVydCk7CgkqLwoKCXRpbWVzOiBmdW5jdGlvbihmbil7CgkJZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzOyBpKyspIGZuKGkpOwoJfQoKfSk7CgovKgpTY3JpcHQ6IEVsZW1lbnQuanMKCUNvbnRhaW5zIHVzZWZ1bCBFbGVtZW50IHByb3RvdHlwZXMsIHRvIGJlIHVzZWQgd2l0aCB0aGUgZG9sbGFyIGZ1bmN0aW9uIDwkPi4KCkxpY2Vuc2U6CglNSVQtc3R5bGUgbGljZW5zZS4KCkNyZWRpdHM6CgktIFNvbWUgZnVuY3Rpb25zIGFyZSBpbnNwaXJlZCBieSB0aG9zZSBmb3VuZCBpbiBwcm90b3R5cGUuanMgPGh0dHA6Ly9wcm90b3R5cGUuY29uaW8ubmV0Lz4gKGMpIDIwMDUgU2FtIFN0ZXBoZW5zb24gc2FtIFthdF0gY29uaW8gW2RvdF0gbmV0LCBNSVQtc3R5bGUgbGljZW5zZQoqLwoKLyoKQ2xhc3M6IEVsZW1lbnQKCUN1c3RvbSBjbGFzcyB0byBhbGxvdyBhbGwgb2YgaXRzIG1ldGhvZHMgdG8gYmUgdXNlZCB3aXRoIGFueSBET00gZWxlbWVudCB2aWEgdGhlIGRvbGxhciBmdW5jdGlvbiA8JD4uCiovCgp2YXIgRWxlbWVudCA9IG5ldyBDbGFzcyh7CgoJLyoKCVByb3BlcnR5OiBpbml0aWFsaXplCgkJQ3JlYXRlcyBhIG5ldyBlbGVtZW50IG9mIHRoZSB0eXBlIHBhc3NlZCBpbi4KCglBcmd1bWVudHM6CgkJZWwgLSBzdHJpbmc7IHRoZSB0YWcgbmFtZSBmb3IgdGhlIGVsZW1lbnQgeW91IHdpc2ggdG8gY3JlYXRlLiB5b3UgY2FuIGFsc28gcGFzcyBpbiBhbiBlbGVtZW50IHJlZmVyZW5jZSwgaW4gd2hpY2ggY2FzZSBpdCB3aWxsIGJlIGV4dGVuZGVkLgoJCXByb3BzIC0gb2JqZWN0OyB0aGUgcHJvcGVydGllcyB5b3Ugd2FudCB0byBhZGQgdG8geW91ciBlbGVtZW50LgoJCUFjY2VwdHMgdGhlIHNhbWUga2V5cyBhcyA8RWxlbWVudC5zZXRQcm9wZXJ0aWVzPiwgYnV0IGFsc28gYWxsb3dzIGV2ZW50cyBhbmQgc3R5bGVzCgoJUHJvcHM6CgkJdGhlIGtleSBzdHlsZXMgd2lsbCBiZSB1c2VkIGFzIHNldFN0eWxlcywgdGhlIGtleSBldmVudHMgd2lsbCBiZSB1c2VkIGFzIGFkZEV2ZW50cy4gYW55IG90aGVyIGtleSBpcyB1c2VkIGFzIHNldFByb3BlcnR5LgoKCUV4YW1wbGU6CgkJKHN0YXJ0IGNvZGUpCgkJbmV3IEVsZW1lbnQoJ2EnLCB7CgkJCSdzdHlsZXMnOiB7CgkJCQknZGlzcGxheSc6ICdibG9jaycsCgkJCQknYm9yZGVyJzogJzFweCBzb2xpZCBibGFjaycKCQkJfSwKCQkJJ2V2ZW50cyc6IHsKCQkJCSdjbGljayc6IGZ1bmN0aW9uKCl7CgkJCQkJLy9hYWEKCQkJCX0sCgkJCQknbW91c2Vkb3duJzogZnVuY3Rpb24oKXsKCQkJCQkvL2FhYQoJCQkJfQoJCQl9LAoJCQknY2xhc3MnOiAnbXlDbGFzc1N1cGVyQ2xhc3MnLAoJCQknaHJlZic6ICdodHRwOi8vbWFkNG1pbGsubmV0JwoJCX0pOwoKCQkoZW5kKQoJKi8KCglpbml0aWFsaXplOiBmdW5jdGlvbihlbCwgcHJvcHMpewoJCWlmICgkdHlwZShlbCkgPT0gJ3N0cmluZycpewoJCQlpZiAod2luZG93LmllICYmIHByb3BzICYmIChwcm9wcy5uYW1lIHx8IHByb3BzLnR5cGUpKXsKCQkJCXZhciBuYW1lID0gKHByb3BzLm5hbWUpID8gJyBuYW1lPSInICsgcHJvcHMubmFtZSArICciJyA6ICcnOwoJCQkJdmFyIHR5cGUgPSAocHJvcHMudHlwZSkgPyAnIHR5cGU9IicgKyBwcm9wcy50eXBlICsgJyInIDogJyc7CgkJCQlkZWxldGUgcHJvcHMubmFtZTsKCQkJCWRlbGV0ZSBwcm9wcy50eXBlOwoJCQkJZWwgPSAnPCcgKyBlbCArIG5hbWUgKyB0eXBlICsgJz4nOwoJCQl9CgkJCWVsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChlbCk7CgkJfQoJCWVsID0gJChlbCk7CgkJcmV0dXJuICghcHJvcHMgfHwgIWVsKSA/IGVsIDogZWwuc2V0KHByb3BzKTsKCX0KCn0pOwoKLyoKQ2xhc3M6IEVsZW1lbnRzCgktIEV2ZXJ5IGRvbSBmdW5jdGlvbiBzdWNoIGFzIDwkJD4sIG9yIGluIGdlbmVyYWwgZXZlcnkgZnVuY3Rpb24gdGhhdCByZXR1cm5zIGEgY29sbGVjdGlvbiBvZiBub2RlcyBpbiBtb290b29scywgcmV0dXJucyB0aGVtIGFzIGFuIEVsZW1lbnRzIGNsYXNzLgoJLSBUaGUgcHVycG9zZSBvZiB0aGUgRWxlbWVudHMgY2xhc3MgaXMgdG8gYWxsb3cgPEVsZW1lbnQ+IG1ldGhvZHMgdG8gd29yayBhbHNvIG9uIDxFbGVtZW50cz4gYXJyYXkuCgktIEVsZW1lbnRzIGlzIGFsc28gYW4gQXJyYXksIHNvIGl0IGFjY2VwdHMgYWxsIHRoZSA8QXJyYXk+IG1ldGhvZHMuCgktIEV2ZXJ5IG5vZGUgb2YgdGhlIEVsZW1lbnRzIGluc3RhbmNlIGlzIGFscmVhZHkgZXh0ZW5kZWQgd2l0aCA8JD4uCgpFeGFtcGxlOgoJPiQkKCdteXNlbGVjdG9yJykuZWFjaChmdW5jdGlvbihlbCl7Cgk+IC8vLi4uCgk+fSk7CgoJc29tZSBpdGVyYXRpb25zIGhlcmUsICQkKCdteXNlbGVjdG9yJykgaXMgYWxzbyBhbiBhcnJheS4KCgk+JCQoJ215c2VsZWN0b3InKS5zZXRTdHlsZSgnY29sb3InLCAncmVkJyk7CglldmVyeSBlbGVtZW50IHJldHVybmVkIGJ5ICQkKCdteXNlbGVjdG9yJykgYWxzbyBhY2NlcHRzIDxFbGVtZW50PiBtZXRob2RzLCBpbiB0aGlzIGV4YW1wbGUgZXZlcnkgZWxlbWVudCB3aWxsIGJlIG1hZGUgcmVkLgoqLwoKdmFyIEVsZW1lbnRzID0gbmV3IENsYXNzKHsKCglpbml0aWFsaXplOiBmdW5jdGlvbihlbGVtZW50cyl7CgkJcmV0dXJuIChlbGVtZW50cykgPyAkZXh0ZW5kKGVsZW1lbnRzLCB0aGlzKSA6IHRoaXM7Cgl9Cgp9KTsKCkVsZW1lbnRzLmV4dGVuZCA9IGZ1bmN0aW9uKHByb3BzKXsKCWZvciAodmFyIHByb3AgaW4gcHJvcHMpewoJCXRoaXMucHJvdG90eXBlW3Byb3BdID0gcHJvcHNbcHJvcF07CgkJdGhpc1twcm9wXSA9ICRuYXRpdmUuZ2VuZXJpYyhwcm9wKTsKCX0KfTsKCi8qClNlY3Rpb246IFV0aWxpdHkgRnVuY3Rpb25zCgpGdW5jdGlvbjogJAoJcmV0dXJucyB0aGUgZWxlbWVudCBwYXNzZWQgaW4gd2l0aCBhbGwgdGhlIEVsZW1lbnQgcHJvdG90eXBlcyBhcHBsaWVkLgoKQXJndW1lbnRzOgoJZWwgLSBhIHJlZmVyZW5jZSB0byBhbiBhY3R1YWwgZWxlbWVudCBvciBhIHN0cmluZyByZXByZXNlbnRpbmcgdGhlIGlkIG9mIGFuIGVsZW1lbnQKCkV4YW1wbGU6Cgk+JCgnbXlFbGVtZW50JykgLy8gZ2V0cyBhIERPTSBlbGVtZW50IGJ5IGlkIHdpdGggYWxsIHRoZSBFbGVtZW50IHByb3RvdHlwZXMgYXBwbGllZC4KCT52YXIgZGl2ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ215RWxlbWVudCcpOwoJPiQoZGl2KSAvL3JldHVybnMgYW4gRWxlbWVudCBhbHNvIHdpdGggYWxsIHRoZSBtb290b29scyBleHRlbnRpb25zIGFwcGxpZWQuCgoJWW91J2xsIHVzZSB0aGlzIHdoZW4geW91IGFyZW4ndCBzdXJlIGlmIGEgdmFyaWFibGUgaXMgYW4gYWN0dWFsIGVsZW1lbnQgb3IgYW4gaWQsIGFzCgl3ZWxsIGFzIGp1c3Qgc2hvcnRoYW5kIGZvciBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgpLgoKUmV0dXJuczoKCWEgRE9NIGVsZW1lbnQgb3IgZmFsc2UgKGlmIG5vIGlkIHdhcyBmb3VuZCkuCgpOb3RlOgoJeW91IG5lZWQgdG8gY2FsbCAkIG9uIGFuIGVsZW1lbnQgb25seSBvbmNlIHRvIGdldCBhbGwgdGhlIHByb3RvdHlwZXMuCglCdXQgaXRzIG5vIGhhcm0gdG8gY2FsbCBpdCBtdWx0aXBsZSB0aW1lcywgYXMgaXQgd2lsbCBkZXRlY3QgaWYgaXQgaGFzIGJlZW4gYWxyZWFkeSBleHRlbmRlZC4KKi8KCmZ1bmN0aW9uICQoZWwpewoJaWYgKCFlbCkgcmV0dXJuIG51bGw7CglpZiAoZWwuaHRtbEVsZW1lbnQpIHJldHVybiBHYXJiYWdlLmNvbGxlY3QoZWwpOwoJaWYgKFt3aW5kb3csIGRvY3VtZW50XS5jb250YWlucyhlbCkpIHJldHVybiBlbDsKCXZhciB0eXBlID0gJHR5cGUoZWwpOwoJaWYgKHR5cGUgPT0gJ3N0cmluZycpewoJCWVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoZWwpOwoJCXR5cGUgPSAoZWwpID8gJ2VsZW1lbnQnIDogZmFsc2U7Cgl9CglpZiAodHlwZSAhPSAnZWxlbWVudCcpIHJldHVybiBudWxsOwoJaWYgKGVsLmh0bWxFbGVtZW50KSByZXR1cm4gR2FyYmFnZS5jb2xsZWN0KGVsKTsKCWlmIChbJ29iamVjdCcsICdlbWJlZCddLmNvbnRhaW5zKGVsLnRhZ05hbWUudG9Mb3dlckNhc2UoKSkpIHJldHVybiBlbDsKCSRleHRlbmQoZWwsIEVsZW1lbnQucHJvdG90eXBlKTsKCWVsLmh0bWxFbGVtZW50ID0gZnVuY3Rpb24oKXt9OwoJcmV0dXJuIEdhcmJhZ2UuY29sbGVjdChlbCk7Cn07CgovKgpGdW5jdGlvbjogJCQKCVNlbGVjdHMsIGFuZCBleHRlbmRzIERPTSBlbGVtZW50cy4gRWxlbWVudHMgYXJyYXlzIHJldHVybmVkIHdpdGggJCQgd2lsbCBhbHNvIGFjY2VwdCBhbGwgdGhlIDxFbGVtZW50PiBtZXRob2RzLgoJVGhlIHJldHVybiB0eXBlIG9mIGVsZW1lbnQgbWV0aG9kcyBydW4gdGhyb3VnaCAkJCBpcyBhbHdheXMgYW4gYXJyYXkuIElmIHRoZSByZXR1cm4gYXJyYXkgaXMgb25seSBtYWRlIGJ5IGVsZW1lbnRzLAoJJCQgd2lsbCBiZSBhcHBsaWVkIGF1dG9tYXRpY2FsbHkuCgpBcmd1bWVudHM6CglIVE1MIENvbGxlY3Rpb25zLCBhcnJheXMgb2YgZWxlbWVudHMsIGFycmF5cyBvZiBzdHJpbmdzIGFzIGVsZW1lbnQgaWRzLCBlbGVtZW50cywgc3RyaW5ncyBhcyBzZWxlY3RvcnMuCglBbnkgbnVtYmVyIG9mIHRoZSBhYm92ZSBhcyBhcmd1bWVudHMgYXJlIGFjY2VwdGVkLgoKTm90ZToKCWlmIHlvdSBsb2FkIDxFbGVtZW50LlNlbGVjdG9ycy5qcz4sICQkIHdpbGwgYWxzbyBhY2NlcHQgQ1NTIFNlbGVjdG9ycywgb3RoZXJ3aXNlIHRoZSBvbmx5IHNlbGVjdG9ycyBzdXBwb3J0ZWQgYXJlIHRhZyBuYW1lcy4KCkV4YW1wbGU6Cgk+JCQoJ2EnKSAvL2FuIGFycmF5IG9mIGFsbCBhbmNob3IgdGFncyBvbiB0aGUgcGFnZQoJPiQkKCdhJywgJ2InKSAvL2FuIGFycmF5IG9mIGFsbCBhbmNob3IgYW5kIGJvbGQgdGFncyBvbiB0aGUgcGFnZQoJPiQkKCcjbXlFbGVtZW50JykgLy9hcnJheSBjb250YWluaW5nIG9ubHkgdGhlIGVsZW1lbnQgd2l0aCBpZCA9IG15RWxlbWVudC4gKG9ubHkgd2l0aCA8RWxlbWVudC5TZWxlY3RvcnMuanM+KQoJPiQkKCcjbXlFbGVtZW50IGEubXlDbGFzcycpIC8vYW4gYXJyYXkgb2YgYWxsIGFuY2hvciB0YWdzIHdpdGggdGhlIGNsYXNzICJteUNsYXNzIgoJPi8vd2l0aGluIHRoZSBET00gZWxlbWVudCB3aXRoIGlkICJteUVsZW1lbnQiIChvbmx5IHdpdGggPEVsZW1lbnQuU2VsZWN0b3JzLmpzPikKCT4kJChteWVsZW1lbnQsIG15ZWxlbWVudDIsICdhJywgWydteWlkJywgbXlpZDIsICdteWlkMyddLCBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgnZGl2JykpIC8vYW4gYXJyYXkgY29udGFpbmluZzoKCT4vLyB0aGUgZWxlbWVudCByZWZlcmVuY2VkIGFzIG15ZWxlbWVudCBpZiBleGlzdGluZywKCT4vLyB0aGUgZWxlbWVudCByZWZlcmVuY2VkIGFzIG15ZWxlbWVudDIgaWYgZXhpc3RpbmcsCgk+Ly8gYWxsIHRoZSBlbGVtZW50cyB3aXRoIGEgYXMgdGFnIGluIHRoZSBwYWdlLAoJPi8vIHRoZSBlbGVtZW50IHdpdGggaWQgPSBteWlkIGlmIGV4aXN0aW5nCgk+Ly8gdGhlIGVsZW1lbnQgd2l0aCBpZCA9IG15aWQyIGlmIGV4aXN0aW5nCgk+Ly8gdGhlIGVsZW1lbnQgd2l0aCBpZCA9IG15aWQzIGlmIGV4aXN0aW5nCgk+Ly8gYWxsIHRoZSBlbGVtZW50cyB3aXRoIGRpdiBhcyB0YWcgaW4gdGhlIHBhZ2UKClJldHVybnM6CglhcnJheSAtIGFycmF5IG9mIGFsbCB0aGUgZG9tIGVsZW1lbnRzIG1hdGNoZWQsIGV4dGVuZGVkIHdpdGggPCQ+LiAgUmV0dXJucyBhcyA8RWxlbWVudHM+LgoqLwoKZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVNlbGVjdG9yID0gZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWU7CgpmdW5jdGlvbiAkJCgpewoJdmFyIGVsZW1lbnRzID0gW107Cglmb3IgKHZhciBpID0gMCwgaiA9IGFyZ3VtZW50cy5sZW5ndGg7IGkgPCBqOyBpKyspewoJCXZhciBzZWxlY3RvciA9IGFyZ3VtZW50c1tpXTsKCQlzd2l0Y2goJHR5cGUoc2VsZWN0b3IpKXsKCQkJY2FzZSAnZWxlbWVudCc6IGVsZW1lbnRzLnB1c2goc2VsZWN0b3IpOwoJCQljYXNlICdib29sZWFuJzogYnJlYWs7CgkJCWNhc2UgZmFsc2U6IGJyZWFrOwoJCQljYXNlICdzdHJpbmcnOiBzZWxlY3RvciA9IGRvY3VtZW50LmdldEVsZW1lbnRzQnlTZWxlY3RvcihzZWxlY3RvciwgdHJ1ZSk7CgkJCWRlZmF1bHQ6IGVsZW1lbnRzLmV4dGVuZChzZWxlY3Rvcik7CgkJfQoJfQoJcmV0dXJuICQkLnVuaXF1ZShlbGVtZW50cyk7Cn07CgokJC51bmlxdWUgPSBmdW5jdGlvbihhcnJheSl7Cgl2YXIgZWxlbWVudHMgPSBbXTsKCWZvciAodmFyIGkgPSAwLCBsID0gYXJyYXkubGVuZ3RoOyBpIDwgbDsgaSsrKXsKCQlpZiAoYXJyYXlbaV0uJGluY2x1ZGVkKSBjb250aW51ZTsKCQl2YXIgZWxlbWVudCA9ICQoYXJyYXlbaV0pOwoJCWlmIChlbGVtZW50ICYmICFlbGVtZW50LiRpbmNsdWRlZCl7CgkJCWVsZW1lbnQuJGluY2x1ZGVkID0gdHJ1ZTsKCQkJZWxlbWVudHMucHVzaChlbGVtZW50KTsKCQl9Cgl9Cglmb3IgKHZhciBuID0gMCwgZCA9IGVsZW1lbnRzLmxlbmd0aDsgbiA8IGQ7IG4rKykgZWxlbWVudHNbbl0uJGluY2x1ZGVkID0gbnVsbDsKCXJldHVybiBuZXcgRWxlbWVudHMoZWxlbWVudHMpOwp9OwoKRWxlbWVudHMuTXVsdGkgPSBmdW5jdGlvbihwcm9wZXJ0eSl7CglyZXR1cm4gZnVuY3Rpb24oKXsKCQl2YXIgYXJncyA9IGFyZ3VtZW50czsKCQl2YXIgaXRlbXMgPSBbXTsKCQl2YXIgZWxlbWVudHMgPSB0cnVlOwoJCWZvciAodmFyIGkgPSAwLCBqID0gdGhpcy5sZW5ndGgsIHJldHVybnM7IGkgPCBqOyBpKyspewoJCQlyZXR1cm5zID0gdGhpc1tpXVtwcm9wZXJ0eV0uYXBwbHkodGhpc1tpXSwgYXJncyk7CgkJCWlmICgkdHlwZShyZXR1cm5zKSAhPSAnZWxlbWVudCcpIGVsZW1lbnRzID0gZmFsc2U7CgkJCWl0ZW1zLnB1c2gocmV0dXJucyk7CgkJfTsKCQlyZXR1cm4gKGVsZW1lbnRzKSA/ICQkLnVuaXF1ZShpdGVtcykgOiBpdGVtczsKCX07Cn07CgpFbGVtZW50LmV4dGVuZCA9IGZ1bmN0aW9uKHByb3BlcnRpZXMpewoJZm9yICh2YXIgcHJvcGVydHkgaW4gcHJvcGVydGllcyl7CgkJSFRNTEVsZW1lbnQucHJvdG90eXBlW3Byb3BlcnR5XSA9IHByb3BlcnRpZXNbcHJvcGVydHldOwoJCUVsZW1lbnQucHJvdG90eXBlW3Byb3BlcnR5XSA9IHByb3BlcnRpZXNbcHJvcGVydHldOwoJCUVsZW1lbnRbcHJvcGVydHldID0gJG5hdGl2ZS5nZW5lcmljKHByb3BlcnR5KTsKCQl2YXIgZWxlbWVudHNQcm9wZXJ0eSA9IChBcnJheS5wcm90b3R5cGVbcHJvcGVydHldKSA/IHByb3BlcnR5ICsgJ0VsZW1lbnRzJyA6IHByb3BlcnR5OwoJCUVsZW1lbnRzLnByb3RvdHlwZVtlbGVtZW50c1Byb3BlcnR5XSA9IEVsZW1lbnRzLk11bHRpKHByb3BlcnR5KTsKCX0KfTsKCi8qCkNsYXNzOiBFbGVtZW50CglDdXN0b20gY2xhc3MgdG8gYWxsb3cgYWxsIG9mIGl0cyBtZXRob2RzIHRvIGJlIHVzZWQgd2l0aCBhbnkgRE9NIGVsZW1lbnQgdmlhIHRoZSBkb2xsYXIgZnVuY3Rpb24gPCQ+LgoqLwoKRWxlbWVudC5leHRlbmQoewoKCS8qCglQcm9wZXJ0eTogc2V0CgkJeW91IGNhbiBzZXQgZXZlbnRzLCBzdHlsZXMgYW5kIHByb3BlcnRpZXMgd2l0aCB0aGlzIHNob3J0Y3V0LiBzYW1lIGFzIGNhbGxpbmcgbmV3IEVsZW1lbnQuCgkqLwoKCXNldDogZnVuY3Rpb24ocHJvcHMpewoJCWZvciAodmFyIHByb3AgaW4gcHJvcHMpewoJCQl2YXIgdmFsID0gcHJvcHNbcHJvcF07CgkJCXN3aXRjaChwcm9wKXsKCQkJCWNhc2UgJ3N0eWxlcyc6IHRoaXMuc2V0U3R5bGVzKHZhbCk7IGJyZWFrOwoJCQkJY2FzZSAnZXZlbnRzJzogaWYgKHRoaXMuYWRkRXZlbnRzKSB0aGlzLmFkZEV2ZW50cyh2YWwpOyBicmVhazsKCQkJCWNhc2UgJ3Byb3BlcnRpZXMnOiB0aGlzLnNldFByb3BlcnRpZXModmFsKTsgYnJlYWs7CgkJCQlkZWZhdWx0OiB0aGlzLnNldFByb3BlcnR5KHByb3AsIHZhbCk7CgkJCX0KCQl9CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWluamVjdDogZnVuY3Rpb24oZWwsIHdoZXJlKXsKCQllbCA9ICQoZWwpOwoJCXN3aXRjaCh3aGVyZSl7CgkJCWNhc2UgJ2JlZm9yZSc6IGVsLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKHRoaXMsIGVsKTsgYnJlYWs7CgkJCWNhc2UgJ2FmdGVyJzoKCQkJCXZhciBuZXh0ID0gZWwuZ2V0TmV4dCgpOwoJCQkJaWYgKCFuZXh0KSBlbC5wYXJlbnROb2RlLmFwcGVuZENoaWxkKHRoaXMpOwoJCQkJZWxzZSBlbC5wYXJlbnROb2RlLmluc2VydEJlZm9yZSh0aGlzLCBuZXh0KTsKCQkJCWJyZWFrOwoJCQljYXNlICd0b3AnOgoJCQkJdmFyIGZpcnN0ID0gZWwuZmlyc3RDaGlsZDsKCQkJCWlmIChmaXJzdCl7CgkJCQkJZWwuaW5zZXJ0QmVmb3JlKHRoaXMsIGZpcnN0KTsKCQkJCQlicmVhazsKCQkJCX0KCQkJZGVmYXVsdDogZWwuYXBwZW5kQ2hpbGQodGhpcyk7CgkJfQoJCXJldHVybiB0aGlzOwoJfSwKCgkvKgoJUHJvcGVydHk6IGluamVjdEJlZm9yZQoJCUluc2VydHMgdGhlIEVsZW1lbnQgYmVmb3JlIHRoZSBwYXNzZWQgZWxlbWVudC4KCglBcmd1bWVudHM6CgkJZWwgLSBhbiBlbGVtZW50IHJlZmVyZW5jZSBvciB0aGUgaWQgb2YgdGhlIGVsZW1lbnQgdG8gYmUgaW5qZWN0ZWQgaW4uCgoJRXhhbXBsZToKCQk+aHRtbDoKCQk+PGRpdiBpZD0ibXlFbGVtZW50Ij48L2Rpdj4KCQk+PGRpdiBpZD0ibXlTZWNvbmRFbGVtZW50Ij48L2Rpdj4KCQk+anM6CgkJPiQoJ215U2Vjb25kRWxlbWVudCcpLmluamVjdEJlZm9yZSgnbXlFbGVtZW50Jyk7CgkJPnJlc3VsdGluZyBodG1sOgoJCT48ZGl2IGlkPSJteVNlY29uZEVsZW1lbnQiPjwvZGl2PgoJCT48ZGl2IGlkPSJteUVsZW1lbnQiPjwvZGl2PgoJKi8KCglpbmplY3RCZWZvcmU6IGZ1bmN0aW9uKGVsKXsKCQlyZXR1cm4gdGhpcy5pbmplY3QoZWwsICdiZWZvcmUnKTsKCX0sCgoJLyoKCVByb3BlcnR5OiBpbmplY3RBZnRlcgoJCVNhbWUgYXMgPEVsZW1lbnQuaW5qZWN0QmVmb3JlPiwgYnV0IGluc2VydHMgdGhlIGVsZW1lbnQgYWZ0ZXIuCgkqLwoKCWluamVjdEFmdGVyOiBmdW5jdGlvbihlbCl7CgkJcmV0dXJuIHRoaXMuaW5qZWN0KGVsLCAnYWZ0ZXInKTsKCX0sCgoJLyoKCVByb3BlcnR5OiBpbmplY3RJbnNpZGUKCQlTYW1lIGFzIDxFbGVtZW50LmluamVjdEJlZm9yZT4sIGJ1dCBpbnNlcnRzIHRoZSBlbGVtZW50IGluc2lkZS4KCSovCgoJaW5qZWN0SW5zaWRlOiBmdW5jdGlvbihlbCl7CgkJcmV0dXJuIHRoaXMuaW5qZWN0KGVsLCAnYm90dG9tJyk7Cgl9LAoKCS8qCglQcm9wZXJ0eTogaW5qZWN0VG9wCgkJU2FtZSBhcyA8RWxlbWVudC5pbmplY3RJbnNpZGU+LCBidXQgaW5zZXJ0cyB0aGUgZWxlbWVudCBpbnNpZGUsIGF0IHRoZSB0b3AuCgkqLwoKCWluamVjdFRvcDogZnVuY3Rpb24oZWwpewoJCXJldHVybiB0aGlzLmluamVjdChlbCwgJ3RvcCcpOwoJfSwKCgkvKgoJUHJvcGVydHk6IGFkb3B0CgkJSW5zZXJ0cyB0aGUgcGFzc2VkIGVsZW1lbnRzIGluc2lkZSB0aGUgRWxlbWVudC4KCglBcmd1bWVudHM6CgkJYWNjZXB0cyBlbGVtZW50cyByZWZlcmVuY2VzLCBlbGVtZW50IGlkcyBhcyBzdHJpbmcsIHNlbGVjdG9ycyAoJCQoJ3N0dWZmJykpIC8gYXJyYXkgb2YgZWxlbWVudHMsIGFycmF5IG9mIGlkcyBhcyBzdHJpbmdzIGFuZCBjb2xsZWN0aW9ucy4KCSovCgoJYWRvcHQ6IGZ1bmN0aW9uKCl7CgkJdmFyIGVsZW1lbnRzID0gW107CgkJJGVhY2goYXJndW1lbnRzLCBmdW5jdGlvbihhcmd1bWVudCl7CgkJCWVsZW1lbnRzID0gZWxlbWVudHMuY29uY2F0KGFyZ3VtZW50KTsKCQl9KTsKCQkkJChlbGVtZW50cykuaW5qZWN0KHRoaXMpOwoJCXJldHVybiB0aGlzOwoJfSwKCgkvKgoJUHJvcGVydHk6IHJlbW92ZQoJCVJlbW92ZXMgdGhlIEVsZW1lbnQgZnJvbSB0aGUgRE9NLgoKCUV4YW1wbGU6CgkJPiQoJ215RWxlbWVudCcpLnJlbW92ZSgpIC8vYnllIGJ5ZQoJKi8KCglyZW1vdmU6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMucGFyZW50Tm9kZS5yZW1vdmVDaGlsZCh0aGlzKTsKCX0sCgoJLyoKCVByb3BlcnR5OiBjbG9uZQoJCUNsb25lcyB0aGUgRWxlbWVudCBhbmQgcmV0dXJucyB0aGUgY2xvbmVkIG9uZS4KCglBcmd1bWVudHM6CgkJY29udGVudHMgLSBib29sZWFuLCB3aGVuIHRydWUgdGhlIEVsZW1lbnQgaXMgY2xvbmVkIHdpdGggY2hpbGROb2RlcywgZGVmYXVsdCB0cnVlCgoJUmV0dXJuczoKCQl0aGUgY2xvbmVkIGVsZW1lbnQKCglFeGFtcGxlOgoJCT52YXIgY2xvbmUgPSAkKCdteUVsZW1lbnQnKS5jbG9uZSgpLmluamVjdEFmdGVyKCdteUVsZW1lbnQnKTsKCQk+Ly9jbG9uZXMgdGhlIEVsZW1lbnQgYW5kIGFwcGVuZCB0aGUgY2xvbmUgYWZ0ZXIgdGhlIEVsZW1lbnQuCgkqLwoKCWNsb25lOiBmdW5jdGlvbihjb250ZW50cyl7CgkJdmFyIGVsID0gJCh0aGlzLmNsb25lTm9kZShjb250ZW50cyAhPT0gZmFsc2UpKTsKCQlpZiAoIWVsLiRldmVudHMpIHJldHVybiBlbDsKCQllbC4kZXZlbnRzID0ge307CgkJZm9yICh2YXIgdHlwZSBpbiB0aGlzLiRldmVudHMpIGVsLiRldmVudHNbdHlwZV0gPSB7CgkJCSdrZXlzJzogJEEodGhpcy4kZXZlbnRzW3R5cGVdLmtleXMpLAoJCQkndmFsdWVzJzogJEEodGhpcy4kZXZlbnRzW3R5cGVdLnZhbHVlcykKCQl9OwoJCXJldHVybiBlbC5yZW1vdmVFdmVudHMoKTsKCX0sCgoJLyoKCVByb3BlcnR5OiByZXBsYWNlV2l0aAoJCVJlcGxhY2VzIHRoZSBFbGVtZW50IHdpdGggYW4gZWxlbWVudCBwYXNzZWQuCgoJQXJndW1lbnRzOgoJCWVsIC0gYSBzdHJpbmcgcmVwcmVzZW50aW5nIHRoZSBlbGVtZW50IHRvIGJlIGluamVjdGVkIGluIChteUVsZW1lbnRJZCwgb3IgZGl2KSwgb3IgYW4gZWxlbWVudCByZWZlcmVuY2UuCgkJSWYgeW91IHBhc3MgZGl2IG9yIGFub3RoZXIgdGFnLCB0aGUgZWxlbWVudCB3aWxsIGJlIGNyZWF0ZWQuCgoJUmV0dXJuczoKCQl0aGUgcGFzc2VkIGluIGVsZW1lbnQKCglFeGFtcGxlOgoJCT4kKCdteU9sZEVsZW1lbnQnKS5yZXBsYWNlV2l0aCgkKCdteU5ld0VsZW1lbnQnKSk7IC8vJCgnbXlPbGRFbGVtZW50JykgaXMgZ29uZSwgYW5kICQoJ215TmV3RWxlbWVudCcpIGlzIGluIGl0cyBwbGFjZS4KCSovCgoJcmVwbGFjZVdpdGg6IGZ1bmN0aW9uKGVsKXsKCQllbCA9ICQoZWwpOwoJCXRoaXMucGFyZW50Tm9kZS5yZXBsYWNlQ2hpbGQoZWwsIHRoaXMpOwoJCXJldHVybiBlbDsKCX0sCgoJLyoKCVByb3BlcnR5OiBhcHBlbmRUZXh0CgkJQXBwZW5kcyB0ZXh0IG5vZGUgdG8gYSBET00gZWxlbWVudC4KCglBcmd1bWVudHM6CgkJdGV4dCAtIHRoZSB0ZXh0IHRvIGFwcGVuZC4KCglFeGFtcGxlOgoJCT48ZGl2IGlkPSJteUVsZW1lbnQiPmhleTwvZGl2PgoJCT4kKCdteUVsZW1lbnQnKS5hcHBlbmRUZXh0KCcgaG93ZHknKTsgLy9teUVsZW1lbnQgaW5uZXJIVE1MIGlzIG5vdyAiaGV5IGhvd2R5IgoJKi8KCglhcHBlbmRUZXh0OiBmdW5jdGlvbih0ZXh0KXsKCQl0aGlzLmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKHRleHQpKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJLyoKCVByb3BlcnR5OiBoYXNDbGFzcwoJCVRlc3RzIHRoZSBFbGVtZW50IHRvIHNlZSBpZiBpdCBoYXMgdGhlIHBhc3NlZCBpbiBjbGFzc05hbWUuCgoJUmV0dXJuczoKCQl0cnVlIC0gdGhlIEVsZW1lbnQgaGFzIHRoZSBjbGFzcwoJCWZhbHNlIC0gaXQgZG9lc24ndAoKCUFyZ3VtZW50czoKCQljbGFzc05hbWUgLSBzdHJpbmc7IHRoZSBjbGFzcyBuYW1lIHRvIHRlc3QuCgoJRXhhbXBsZToKCQk+PGRpdiBpZD0ibXlFbGVtZW50IiBjbGFzcz0idGVzdENsYXNzIj48L2Rpdj4KCQk+JCgnbXlFbGVtZW50JykuaGFzQ2xhc3MoJ3Rlc3RDbGFzcycpOyAvL3JldHVybnMgdHJ1ZQoJKi8KCgloYXNDbGFzczogZnVuY3Rpb24oY2xhc3NOYW1lKXsKCQlyZXR1cm4gdGhpcy5jbGFzc05hbWUuY29udGFpbnMoY2xhc3NOYW1lLCAnICcpOwoJfSwKCgkvKgoJUHJvcGVydHk6IGFkZENsYXNzCgkJQWRkcyB0aGUgcGFzc2VkIGluIGNsYXNzIHRvIHRoZSBFbGVtZW50LCBpZiB0aGUgZWxlbWVudCBkb2VzbnQgYWxyZWFkeSBoYXZlIGl0LgoKCUFyZ3VtZW50czoKCQljbGFzc05hbWUgLSBzdHJpbmc7IHRoZSBjbGFzcyBuYW1lIHRvIGFkZAoKCUV4YW1wbGU6CgkJPjxkaXYgaWQ9Im15RWxlbWVudCIgY2xhc3M9InRlc3RDbGFzcyI+PC9kaXY+CgkJPiQoJ215RWxlbWVudCcpLmFkZENsYXNzKCduZXdDbGFzcycpOyAvLzxkaXYgaWQ9Im15RWxlbWVudCIgY2xhc3M9InRlc3RDbGFzcyBuZXdDbGFzcyI+PC9kaXY+CgkqLwoKCWFkZENsYXNzOiBmdW5jdGlvbihjbGFzc05hbWUpewoJCWlmICghdGhpcy5oYXNDbGFzcyhjbGFzc05hbWUpKSB0aGlzLmNsYXNzTmFtZSA9ICh0aGlzLmNsYXNzTmFtZSArICcgJyArIGNsYXNzTmFtZSkuY2xlYW4oKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJLyoKCVByb3BlcnR5OiByZW1vdmVDbGFzcwoJCVdvcmtzIGxpa2UgPEVsZW1lbnQuYWRkQ2xhc3M+LCBidXQgcmVtb3ZlcyB0aGUgY2xhc3MgZnJvbSB0aGUgZWxlbWVudC4KCSovCgoJcmVtb3ZlQ2xhc3M6IGZ1bmN0aW9uKGNsYXNzTmFtZSl7CgkJdGhpcy5jbGFzc05hbWUgPSB0aGlzLmNsYXNzTmFtZS5yZXBsYWNlKG5ldyBSZWdFeHAoJyhefFxccyknICsgY2xhc3NOYW1lICsgJyg/Olxcc3wkKScpLCAnJDEnKS5jbGVhbigpOwoJCXJldHVybiB0aGlzOwoJfSwKCgkvKgoJUHJvcGVydHk6IHRvZ2dsZUNsYXNzCgkJQWRkcyBvciByZW1vdmVzIHRoZSBwYXNzZWQgaW4gY2xhc3MgbmFtZSB0byB0aGUgZWxlbWVudCwgZGVwZW5kaW5nIG9uIGlmIGl0J3MgcHJlc2VudCBvciBub3QuCgoJQXJndW1lbnRzOgoJCWNsYXNzTmFtZSAtIHRoZSBjbGFzcyB0byBhZGQgb3IgcmVtb3ZlCgoJRXhhbXBsZToKCQk+PGRpdiBpZD0ibXlFbGVtZW50IiBjbGFzcz0ibXlDbGFzcyI+PC9kaXY+CgkJPiQoJ215RWxlbWVudCcpLnRvZ2dsZUNsYXNzKCdteUNsYXNzJyk7CgkJPjxkaXYgaWQ9Im15RWxlbWVudCIgY2xhc3M9IiI+PC9kaXY+CgkJPiQoJ215RWxlbWVudCcpLnRvZ2dsZUNsYXNzKCdteUNsYXNzJyk7CgkJPjxkaXYgaWQ9Im15RWxlbWVudCIgY2xhc3M9Im15Q2xhc3MiPjwvZGl2PgoJKi8KCgl0b2dnbGVDbGFzczogZnVuY3Rpb24oY2xhc3NOYW1lKXsKCQlyZXR1cm4gdGhpcy5oYXNDbGFzcyhjbGFzc05hbWUpID8gdGhpcy5yZW1vdmVDbGFzcyhjbGFzc05hbWUpIDogdGhpcy5hZGRDbGFzcyhjbGFzc05hbWUpOwoJfSwKCgkvKgoJUHJvcGVydHk6IHNldFN0eWxlCgkJU2V0cyBhIGNzcyBwcm9wZXJ0eSB0byB0aGUgRWxlbWVudC4KCgkJQXJndW1lbnRzOgoJCQlwcm9wZXJ0eSAtIHRoZSBwcm9wZXJ0eSB0byBzZXQKCQkJdmFsdWUgLSB0aGUgdmFsdWUgdG8gd2hpY2ggdG8gc2V0IGl0OyBmb3IgbnVtZXJpYyB2YWx1ZXMgdGhhdCByZXF1aXJlICJweCIgeW91IGNhbiBwYXNzIGFuIGludGVnZXIKCgkJRXhhbXBsZToKCQkJPiQoJ215RWxlbWVudCcpLnNldFN0eWxlKCd3aWR0aCcsICczMDBweCcpOyAvL3RoZSB3aWR0aCBpcyBub3cgMzAwcHgKCQkJPiQoJ215RWxlbWVudCcpLnNldFN0eWxlKCd3aWR0aCcsIDMwMCk7IC8vdGhlIHdpZHRoIGlzIG5vdyAzMDBweAoJKi8KCglzZXRTdHlsZTogZnVuY3Rpb24ocHJvcGVydHksIHZhbHVlKXsKCQlzd2l0Y2gocHJvcGVydHkpewoJCQljYXNlICdvcGFjaXR5JzogcmV0dXJuIHRoaXMuc2V0T3BhY2l0eShwYXJzZUZsb2F0KHZhbHVlKSk7CgkJCWNhc2UgJ2Zsb2F0JzogcHJvcGVydHkgPSAod2luZG93LmllKSA/ICdzdHlsZUZsb2F0JyA6ICdjc3NGbG9hdCc7CgkJfQoJCXByb3BlcnR5ID0gcHJvcGVydHkuY2FtZWxDYXNlKCk7CgkJc3dpdGNoKCR0eXBlKHZhbHVlKSl7CgkJCWNhc2UgJ251bWJlcic6IGlmICghWyd6SW5kZXgnLCAnem9vbSddLmNvbnRhaW5zKHByb3BlcnR5KSkgdmFsdWUgKz0gJ3B4JzsgYnJlYWs7CgkJCWNhc2UgJ2FycmF5JzogdmFsdWUgPSAncmdiKCcgKyB2YWx1ZS5qb2luKCcsJykgKyAnKSc7CgkJfQoJCXRoaXMuc3R5bGVbcHJvcGVydHldID0gdmFsdWU7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCS8qCglQcm9wZXJ0eTogc2V0U3R5bGVzCgkJQXBwbGllcyBhIGNvbGxlY3Rpb24gb2Ygc3R5bGVzIHRvIHRoZSBFbGVtZW50LgoKCUFyZ3VtZW50czoKCQlzb3VyY2UgLSBhbiBvYmplY3Qgb3Igc3RyaW5nIGNvbnRhaW5pbmcgYWxsIHRoZSBzdHlsZXMgdG8gYXBwbHkuIFdoZW4gaXRzIGEgc3RyaW5nIGl0IG92ZXJyaWRlcyBvbGQgc3R5bGUuCgoJRXhhbXBsZXM6CgkJPiQoJ215RWxlbWVudCcpLnNldFN0eWxlcyh7CgkJPglib3JkZXI6ICcxcHggc29saWQgIzAwMCcsCgkJPgl3aWR0aDogMzAwLAoJCT4JaGVpZ2h0OiA0MDAKCQk+fSk7CgoJCU9SCgoJCT4kKCdteUVsZW1lbnQnKS5zZXRTdHlsZXMoJ2JvcmRlcjogMXB4IHNvbGlkICMwMDA7IHdpZHRoOiAzMDBweDsgaGVpZ2h0OiA0MDBweDsnKTsKCSovCgoJc2V0U3R5bGVzOiBmdW5jdGlvbihzb3VyY2UpewoJCXN3aXRjaCgkdHlwZShzb3VyY2UpKXsKCQkJY2FzZSAnb2JqZWN0JzogRWxlbWVudC5zZXRNYW55KHRoaXMsICdzZXRTdHlsZScsIHNvdXJjZSk7IGJyZWFrOwoJCQljYXNlICdzdHJpbmcnOiB0aGlzLnN0eWxlLmNzc1RleHQgPSBzb3VyY2U7CgkJfQoJCXJldHVybiB0aGlzOwoJfSwKCgkvKgoJUHJvcGVydHk6IHNldE9wYWNpdHkKCQlTZXRzIHRoZSBvcGFjaXR5IG9mIHRoZSBFbGVtZW50LCBhbmQgc2V0cyBhbHNvIHZpc2liaWxpdHkgPT0gImhpZGRlbiIgaWYgb3BhY2l0eSA9PSAwLCBhbmQgdmlzaWJpbGl0eSA9ICJ2aXNpYmxlIiBpZiBvcGFjaXR5ID4gMC4KCglBcmd1bWVudHM6CgkJb3BhY2l0eSAtIGZsb2F0OyBBY2NlcHRzIHZhbHVlcyBmcm9tIDAgdG8gMS4KCglFeGFtcGxlOgoJCT4kKCdteUVsZW1lbnQnKS5zZXRPcGFjaXR5KDAuNSkgLy9tYWtlIGl0IDUwJSB0cmFuc3BhcmVudAoJKi8KCglzZXRPcGFjaXR5OiBmdW5jdGlvbihvcGFjaXR5KXsKCQlpZiAob3BhY2l0eSA9PSAwKXsKCQkJaWYgKHRoaXMuc3R5bGUudmlzaWJpbGl0eSAhPSAiaGlkZGVuIikgdGhpcy5zdHlsZS52aXNpYmlsaXR5ID0gImhpZGRlbiI7CgkJfSBlbHNlIHsKCQkJaWYgKHRoaXMuc3R5bGUudmlzaWJpbGl0eSAhPSAidmlzaWJsZSIpIHRoaXMuc3R5bGUudmlzaWJpbGl0eSA9ICJ2aXNpYmxlIjsKCQl9CgkJaWYgKCF0aGlzLmN1cnJlbnRTdHlsZSB8fCAhdGhpcy5jdXJyZW50U3R5bGUuaGFzTGF5b3V0KSB0aGlzLnN0eWxlLnpvb20gPSAxOwoJCWlmICh3aW5kb3cuaWUpIHRoaXMuc3R5bGUuZmlsdGVyID0gKG9wYWNpdHkgPT0gMSkgPyAnJyA6ICJhbHBoYShvcGFjaXR5PSIgKyBvcGFjaXR5ICogMTAwICsgIikiOwoJCXRoaXMuc3R5bGUub3BhY2l0eSA9IHRoaXMuJHRtcC5vcGFjaXR5ID0gb3BhY2l0eTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJLyoKCVByb3BlcnR5OiBnZXRTdHlsZQoJCVJldHVybnMgdGhlIHN0eWxlIG9mIHRoZSBFbGVtZW50IGdpdmVuIHRoZSBwcm9wZXJ0eSBwYXNzZWQgaW4uCgoJQXJndW1lbnRzOgoJCXByb3BlcnR5IC0gdGhlIGNzcyBzdHlsZSBwcm9wZXJ0eSB5b3Ugd2FudCB0byByZXRyaWV2ZQoKCUV4YW1wbGU6CgkJPiQoJ215RWxlbWVudCcpLmdldFN0eWxlKCd3aWR0aCcpOyAvL3JldHVybnMgIjQwMHB4IgoJCT4vL2J1dCB5b3UgY2FuIGFsc28gdXNlCgkJPiQoJ215RWxlbWVudCcpLmdldFN0eWxlKCd3aWR0aCcpLnRvSW50KCk7IC8vcmV0dXJucyA0MDAKCglSZXR1cm5zOgoJCXRoZSBzdHlsZSBhcyBhIHN0cmluZwoJKi8KCglnZXRTdHlsZTogZnVuY3Rpb24ocHJvcGVydHkpewoJCXByb3BlcnR5ID0gcHJvcGVydHkuY2FtZWxDYXNlKCk7CgkJdmFyIHJlc3VsdCA9IHRoaXMuc3R5bGVbcHJvcGVydHldOwoJCWlmICghJGNoayhyZXN1bHQpKXsKCQkJaWYgKHByb3BlcnR5ID09ICdvcGFjaXR5JykgcmV0dXJuIHRoaXMuJHRtcC5vcGFjaXR5OwoJCQlyZXN1bHQgPSBbXTsKCQkJZm9yICh2YXIgc3R5bGUgaW4gRWxlbWVudC5TdHlsZXMpewoJCQkJaWYgKHByb3BlcnR5ID09IHN0eWxlKXsKCQkJCQlFbGVtZW50LlN0eWxlc1tzdHlsZV0uZWFjaChmdW5jdGlvbihzKXsKCQkJCQkJdmFyIHN0eWxlID0gdGhpcy5nZXRTdHlsZShzKTsKCQkJCQkJcmVzdWx0LnB1c2gocGFyc2VJbnQoc3R5bGUpID8gc3R5bGUgOiAnMHB4Jyk7CgkJCQkJfSwgdGhpcyk7CgkJCQkJaWYgKHByb3BlcnR5ID09ICdib3JkZXInKXsKCQkJCQkJdmFyIGV2ZXJ5ID0gcmVzdWx0LmV2ZXJ5KGZ1bmN0aW9uKGJpdCl7CgkJCQkJCQlyZXR1cm4gKGJpdCA9PSByZXN1bHRbMF0pOwoJCQkJCQl9KTsKCQkJCQkJcmV0dXJuIChldmVyeSkgPyByZXN1bHRbMF0gOiBmYWxzZTsKCQkJCQl9CgkJCQkJcmV0dXJuIHJlc3VsdC5qb2luKCcgJyk7CgkJCQl9CgkJCX0KCQkJaWYgKHByb3BlcnR5LmNvbnRhaW5zKCdib3JkZXInKSl7CgkJCQlpZiAoRWxlbWVudC5TdHlsZXMuYm9yZGVyLmNvbnRhaW5zKHByb3BlcnR5KSl7CgkJCQkJcmV0dXJuIFsnV2lkdGgnLCAnU3R5bGUnLCAnQ29sb3InXS5tYXAoZnVuY3Rpb24ocCl7CgkJCQkJCXJldHVybiB0aGlzLmdldFN0eWxlKHByb3BlcnR5ICsgcCk7CgkJCQkJfSwgdGhpcykuam9pbignICcpOwoJCQkJfSBlbHNlIGlmIChFbGVtZW50LmJvcmRlclNob3J0LmNvbnRhaW5zKHByb3BlcnR5KSl7CgkJCQkJcmV0dXJuIFsnVG9wJywgJ1JpZ2h0JywgJ0JvdHRvbScsICdMZWZ0J10ubWFwKGZ1bmN0aW9uKHApewoJCQkJCQlyZXR1cm4gdGhpcy5nZXRTdHlsZSgnYm9yZGVyJyArIHAgKyBwcm9wZXJ0eS5yZXBsYWNlKCdib3JkZXInLCAnJykpOwoJCQkJCX0sIHRoaXMpLmpvaW4oJyAnKTsKCQkJCX0KCQkJfQoJCQlpZiAoZG9jdW1lbnQuZGVmYXVsdFZpZXcpIHJlc3VsdCA9IGRvY3VtZW50LmRlZmF1bHRWaWV3LmdldENvbXB1dGVkU3R5bGUodGhpcywgbnVsbCkuZ2V0UHJvcGVydHlWYWx1ZShwcm9wZXJ0eS5oeXBoZW5hdGUoKSk7CgkJCWVsc2UgaWYgKHRoaXMuY3VycmVudFN0eWxlKSByZXN1bHQgPSB0aGlzLmN1cnJlbnRTdHlsZVtwcm9wZXJ0eV07CgkJfQoJCWlmICh3aW5kb3cuaWUpIHJlc3VsdCA9IEVsZW1lbnQuZml4U3R5bGUocHJvcGVydHksIHJlc3VsdCwgdGhpcyk7CgkJaWYgKHJlc3VsdCAmJiBwcm9wZXJ0eS50ZXN0KC9jb2xvci9pKSAmJiByZXN1bHQuY29udGFpbnMoJ3JnYicpKXsKCQkJcmV0dXJuIHJlc3VsdC5zcGxpdCgncmdiJykuc3BsaWNlKDEsNCkubWFwKGZ1bmN0aW9uKGNvbG9yKXsKCQkJCXJldHVybiBjb2xvci5yZ2JUb0hleCgpOwoJCQl9KS5qb2luKCcgJyk7CgkJfQoJCXJldHVybiByZXN1bHQ7Cgl9LAoKCS8qCglQcm9wZXJ0eTogZ2V0U3R5bGVzCgkJUmV0dXJucyBhbiBvYmplY3Qgb2Ygc3R5bGVzIG9mIHRoZSBFbGVtZW50IGZvciBlYWNoIGFyZ3VtZW50IHBhc3NlZCBpbi4KCQlBcmd1bWVudHM6CgkJcHJvcGVydGllcyAtIHN0cmluZ3M7IGFueSBudW1iZXIgb2Ygc3R5bGUgcHJvcGVydGllcwoJRXhhbXBsZToKCQk+JCgnbXlFbGVtZW50JykuZ2V0U3R5bGVzKCd3aWR0aCcsJ2hlaWdodCcsJ3BhZGRpbmcnKTsKCQk+Ly9yZXR1cm5zIGFuIG9iamVjdCBsaWtlOgoJCT57d2lkdGg6ICIxMHB4IiwgaGVpZ2h0OiAiMTBweCIsIHBhZGRpbmc6ICIxMHB4IDBweCAxMHB4IDBweCJ9CgkqLwoKCWdldFN0eWxlczogZnVuY3Rpb24oKXsKCQlyZXR1cm4gRWxlbWVudC5nZXRNYW55KHRoaXMsICdnZXRTdHlsZScsIGFyZ3VtZW50cyk7Cgl9LAoKCXdhbGs6IGZ1bmN0aW9uKGJyb3RoZXIsIHN0YXJ0KXsKCQlicm90aGVyICs9ICdTaWJsaW5nJzsKCQl2YXIgZWwgPSAoc3RhcnQpID8gdGhpc1tzdGFydF0gOiB0aGlzW2Jyb3RoZXJdOwoJCXdoaWxlIChlbCAmJiAkdHlwZShlbCkgIT0gJ2VsZW1lbnQnKSBlbCA9IGVsW2Jyb3RoZXJdOwoJCXJldHVybiAkKGVsKTsKCX0sCgoJLyoKCVByb3BlcnR5OiBnZXRQcmV2aW91cwoJCVJldHVybnMgdGhlIHByZXZpb3VzU2libGluZyBvZiB0aGUgRWxlbWVudCwgZXhjbHVkaW5nIHRleHQgbm9kZXMuCgoJRXhhbXBsZToKCQk+JCgnbXlFbGVtZW50JykuZ2V0UHJldmlvdXMoKTsgLy9nZXQgdGhlIHByZXZpb3VzIERPTSBlbGVtZW50IGZyb20gbXlFbGVtZW50CgoJUmV0dXJuczoKCQl0aGUgc2libGluZyBlbGVtZW50IG9yIHVuZGVmaW5lZCBpZiBub25lIGZvdW5kLgoJKi8KCglnZXRQcmV2aW91czogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy53YWxrKCdwcmV2aW91cycpOwoJfSwKCgkvKgoJUHJvcGVydHk6IGdldE5leHQKCQlXb3JrcyBhcyBFbGVtZW50LmdldFByZXZpb3VzLCBidXQgdHJpZXMgdG8gZmluZCB0aGUgbmV4dFNpYmxpbmcuCgkqLwoKCWdldE5leHQ6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMud2FsaygnbmV4dCcpOwoJfSwKCgkvKgoJUHJvcGVydHk6IGdldEZpcnN0CgkJV29ya3MgYXMgPEVsZW1lbnQuZ2V0UHJldmlvdXM+LCBidXQgdHJpZXMgdG8gZmluZCB0aGUgZmlyc3RDaGlsZC4KCSovCgoJZ2V0Rmlyc3Q6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMud2FsaygnbmV4dCcsICdmaXJzdENoaWxkJyk7Cgl9LAoKCS8qCglQcm9wZXJ0eTogZ2V0TGFzdAoJCVdvcmtzIGFzIDxFbGVtZW50LmdldFByZXZpb3VzPiwgYnV0IHRyaWVzIHRvIGZpbmQgdGhlIGxhc3RDaGlsZC4KCSovCgoJZ2V0TGFzdDogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy53YWxrKCdwcmV2aW91cycsICdsYXN0Q2hpbGQnKTsKCX0sCgoJLyoKCVByb3BlcnR5OiBnZXRQYXJlbnQKCQlyZXR1cm5zIHRoZSAkKGVsZW1lbnQucGFyZW50Tm9kZSkKCSovCgoJZ2V0UGFyZW50OiBmdW5jdGlvbigpewoJCXJldHVybiAkKHRoaXMucGFyZW50Tm9kZSk7Cgl9LAoKCS8qCglQcm9wZXJ0eTogZ2V0Q2hpbGRyZW4KCQlyZXR1cm5zIGFsbCB0aGUgJChlbGVtZW50LmNoaWxkTm9kZXMpLCBleGNsdWRpbmcgdGV4dCBub2Rlcy4gUmV0dXJucyBhcyA8RWxlbWVudHM+LgoJKi8KCglnZXRDaGlsZHJlbjogZnVuY3Rpb24oKXsKCQlyZXR1cm4gJCQodGhpcy5jaGlsZE5vZGVzKTsKCX0sCgoJLyoKCVByb3BlcnR5OiBoYXNDaGlsZAoJCXJldHVybnMgdHJ1ZSBpZiB0aGUgcGFzc2VkIGluIGVsZW1lbnQgaXMgYSBjaGlsZCBvZiB0aGUgJChlbGVtZW50KS4KCSovCgoJaGFzQ2hpbGQ6IGZ1bmN0aW9uKGVsKXsKCQlyZXR1cm4gISEkQSh0aGlzLmdldEVsZW1lbnRzQnlUYWdOYW1lKCcqJykpLmNvbnRhaW5zKGVsKTsKCX0sCgoJLyoKCVByb3BlcnR5OiBnZXRQcm9wZXJ0eQoJCUdldHMgdGhlIGFuIGF0dHJpYnV0ZSBvZiB0aGUgRWxlbWVudC4KCglBcmd1bWVudHM6CgkJcHJvcGVydHkgLSBzdHJpbmc7IHRoZSBhdHRyaWJ1dGUgdG8gcmV0cmlldmUKCglFeGFtcGxlOgoJCT4kKCdteUltYWdlJykuZ2V0UHJvcGVydHkoJ3NyYycpIC8vIHJldHVybnMgd2hhdGV2ZXIuZ2lmCgoJUmV0dXJuczoKCQl0aGUgdmFsdWUsIG9yIGFuIGVtcHR5IHN0cmluZwoJKi8KCglnZXRQcm9wZXJ0eTogZnVuY3Rpb24ocHJvcGVydHkpewoJCXZhciBpbmRleCA9IEVsZW1lbnQuUHJvcGVydGllc1twcm9wZXJ0eV07CgkJaWYgKGluZGV4KSByZXR1cm4gdGhpc1tpbmRleF07CgkJdmFyIGZsYWcgPSBFbGVtZW50LlByb3BlcnRpZXNJRmxhZ1twcm9wZXJ0eV0gfHwgMDsKCQlpZiAoIXdpbmRvdy5pZSB8fCBmbGFnKSByZXR1cm4gdGhpcy5nZXRBdHRyaWJ1dGUocHJvcGVydHksIGZsYWcpOwoJCXZhciBub2RlID0gdGhpcy5hdHRyaWJ1dGVzW3Byb3BlcnR5XTsKCQlyZXR1cm4gKG5vZGUpID8gbm9kZS5ub2RlVmFsdWUgOiBudWxsOwoJfSwKCgkvKgoJUHJvcGVydHk6IHJlbW92ZVByb3BlcnR5CgkJUmVtb3ZlcyBhbiBhdHRyaWJ1dGUgZnJvbSB0aGUgRWxlbWVudAoKCUFyZ3VtZW50czoKCQlwcm9wZXJ0eSAtIHN0cmluZzsgdGhlIGF0dHJpYnV0ZSB0byByZW1vdmUKCSovCgoJcmVtb3ZlUHJvcGVydHk6IGZ1bmN0aW9uKHByb3BlcnR5KXsKCQl2YXIgaW5kZXggPSBFbGVtZW50LlByb3BlcnRpZXNbcHJvcGVydHldOwoJCWlmIChpbmRleCkgdGhpc1tpbmRleF0gPSAnJzsKCQllbHNlIHRoaXMucmVtb3ZlQXR0cmlidXRlKHByb3BlcnR5KTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJLyoKCVByb3BlcnR5OiBnZXRQcm9wZXJ0aWVzCgkJc2FtZSBhcyA8RWxlbWVudC5nZXRTdHlsZXM+LCBidXQgZm9yIHByb3BlcnRpZXMKCSovCgoJZ2V0UHJvcGVydGllczogZnVuY3Rpb24oKXsKCQlyZXR1cm4gRWxlbWVudC5nZXRNYW55KHRoaXMsICdnZXRQcm9wZXJ0eScsIGFyZ3VtZW50cyk7Cgl9LAoKCS8qCglQcm9wZXJ0eTogc2V0UHJvcGVydHkKCQlTZXRzIGFuIGF0dHJpYnV0ZSBmb3IgdGhlIEVsZW1lbnQuCgoJQXJndW1lbnRzOgoJCXByb3BlcnR5IC0gc3RyaW5nOyB0aGUgcHJvcGVydHkgdG8gYXNzaWduIHRoZSB2YWx1ZSBwYXNzZWQgaW4KCQl2YWx1ZSAtIHRoZSB2YWx1ZSB0byBhc3NpZ24gdG8gdGhlIHByb3BlcnR5IHBhc3NlZCBpbgoKCUV4YW1wbGU6CgkJPiQoJ215SW1hZ2UnKS5zZXRQcm9wZXJ0eSgnc3JjJywgJ3doYXRldmVyLmdpZicpOyAvL215SW1hZ2Ugbm93IHBvaW50cyB0byB3aGF0ZXZlci5naWYgZm9yIGl0cyBzb3VyY2UKCSovCgoJc2V0UHJvcGVydHk6IGZ1bmN0aW9uKHByb3BlcnR5LCB2YWx1ZSl7CgkJdmFyIGluZGV4ID0gRWxlbWVudC5Qcm9wZXJ0aWVzW3Byb3BlcnR5XTsKCQlpZiAoaW5kZXgpIHRoaXNbaW5kZXhdID0gdmFsdWU7CgkJZWxzZSB0aGlzLnNldEF0dHJpYnV0ZShwcm9wZXJ0eSwgdmFsdWUpOwoJCXJldHVybiB0aGlzOwoJfSwKCgkvKgoJUHJvcGVydHk6IHNldFByb3BlcnRpZXMKCQlTZXRzIG51bWVyb3VzIGF0dHJpYnV0ZXMgZm9yIHRoZSBFbGVtZW50LgoKCUFyZ3VtZW50czoKCQlzb3VyY2UgLSBhbiBvYmplY3Qgd2l0aCBrZXkvdmFsdWUgcGFpcnMuCgoJRXhhbXBsZToKCQkoc3RhcnQgY29kZSkKCQkkKCdteUVsZW1lbnQnKS5zZXRQcm9wZXJ0aWVzKHsKCQkJc3JjOiAnd2hhdGV2ZXIuZ2lmJywKCQkJYWx0OiAnd2hhdGV2ZXIgZHVkZScKCQl9KTsKCQk8aW1nIHNyYz0id2hhdGV2ZXIuZ2lmIiBhbHQ9IndoYXRldmVyIGR1ZGUiPgoJCShlbmQpCgkqLwoKCXNldFByb3BlcnRpZXM6IGZ1bmN0aW9uKHNvdXJjZSl7CgkJcmV0dXJuIEVsZW1lbnQuc2V0TWFueSh0aGlzLCAnc2V0UHJvcGVydHknLCBzb3VyY2UpOwoJfSwKCgkvKgoJUHJvcGVydHk6IHNldEhUTUwKCQlTZXRzIHRoZSBpbm5lckhUTUwgb2YgdGhlIEVsZW1lbnQuCgoJQXJndW1lbnRzOgoJCWh0bWwgLSBzdHJpbmc7IHRoZSBuZXcgaW5uZXJIVE1MIGZvciB0aGUgZWxlbWVudC4KCglFeGFtcGxlOgoJCT4kKCdteUVsZW1lbnQnKS5zZXRIVE1MKG5ld0hUTUwpIC8vdGhlIGlubmVySFRNTCBvZiBteUVsZW1lbnQgaXMgbm93ID0gbmV3SFRNTAoJKi8KCglzZXRIVE1MOiBmdW5jdGlvbigpewoJCXRoaXMuaW5uZXJIVE1MID0gJEEoYXJndW1lbnRzKS5qb2luKCcnKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJLyoKCVByb3BlcnR5OiBzZXRUZXh0CgkJU2V0cyB0aGUgaW5uZXIgdGV4dCBvZiB0aGUgRWxlbWVudC4KCglBcmd1bWVudHM6CgkJdGV4dCAtIHN0cmluZzsgdGhlIG5ldyB0ZXh0IGNvbnRlbnQgZm9yIHRoZSBlbGVtZW50LgoKCUV4YW1wbGU6CgkJPiQoJ215RWxlbWVudCcpLnNldFRleHQoJ3NvbWUgdGV4dCcpIC8vdGhlIHRleHQgb2YgbXlFbGVtZW50IGlzIG5vdyA9ICdzb21lIHRleHQnCgkqLwoKCXNldFRleHQ6IGZ1bmN0aW9uKHRleHQpewoJCXZhciB0YWcgPSB0aGlzLmdldFRhZygpOwoJCWlmIChbJ3N0eWxlJywgJ3NjcmlwdCddLmNvbnRhaW5zKHRhZykpewoJCQlpZiAod2luZG93LmllKXsKCQkJCWlmICh0YWcgPT0gJ3N0eWxlJykgdGhpcy5zdHlsZVNoZWV0LmNzc1RleHQgPSB0ZXh0OwoJCQkJZWxzZSBpZiAodGFnID09ICAnc2NyaXB0JykgdGhpcy5zZXRQcm9wZXJ0eSgndGV4dCcsIHRleHQpOwoJCQkJcmV0dXJuIHRoaXM7CgkJCX0gZWxzZSB7CgkJCQl0aGlzLnJlbW92ZUNoaWxkKHRoaXMuZmlyc3RDaGlsZCk7CgkJCQlyZXR1cm4gdGhpcy5hcHBlbmRUZXh0KHRleHQpOwoJCQl9CgkJfQoJCXRoaXNbJGRlZmluZWQodGhpcy5pbm5lclRleHQpID8gJ2lubmVyVGV4dCcgOiAndGV4dENvbnRlbnQnXSA9IHRleHQ7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCS8qCglQcm9wZXJ0eTogZ2V0VGV4dAoJCUdldHMgdGhlIGlubmVyIHRleHQgb2YgdGhlIEVsZW1lbnQuCgkqLwoKCWdldFRleHQ6IGZ1bmN0aW9uKCl7CgkJdmFyIHRhZyA9IHRoaXMuZ2V0VGFnKCk7CgkJaWYgKFsnc3R5bGUnLCAnc2NyaXB0J10uY29udGFpbnModGFnKSl7CgkJCWlmICh3aW5kb3cuaWUpewoJCQkJaWYgKHRhZyA9PSAnc3R5bGUnKSByZXR1cm4gdGhpcy5zdHlsZVNoZWV0LmNzc1RleHQ7CgkJCQllbHNlIGlmICh0YWcgPT0gICdzY3JpcHQnKSByZXR1cm4gdGhpcy5nZXRQcm9wZXJ0eSgndGV4dCcpOwoJCQl9IGVsc2UgewoJCQkJcmV0dXJuIHRoaXMuaW5uZXJIVE1MOwoJCQl9CgkJfQoJCXJldHVybiAoJHBpY2sodGhpcy5pbm5lclRleHQsIHRoaXMudGV4dENvbnRlbnQpKTsKCX0sCgoJLyoKCVByb3BlcnR5OiBnZXRUYWcKCQlSZXR1cm5zIHRoZSB0YWdOYW1lIG9mIHRoZSBlbGVtZW50IGluIGxvd2VyIGNhc2UuCgoJRXhhbXBsZToKCQk+JCgnbXlJbWFnZScpLmdldFRhZygpIC8vIHJldHVybnMgJ2ltZycKCglSZXR1cm5zOgoJCVRoZSB0YWcgbmFtZSBpbiBsb3dlciBjYXNlCgkqLwoKCWdldFRhZzogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy50YWdOYW1lLnRvTG93ZXJDYXNlKCk7Cgl9LAoKCS8qCglQcm9wZXJ0eTogZW1wdHkKCQlFbXB0aWVzIGFuIGVsZW1lbnQgb2YgYWxsIGl0cyBjaGlsZHJlbi4KCglFeGFtcGxlOgoJCT4kKCdteURpdicpLmVtcHR5KCkgLy8gZW1wdGllcyB0aGUgRGl2IGFuZCByZXR1cm5zIGl0CgoJUmV0dXJuczoKCQlUaGUgZWxlbWVudC4KCSovCgoJZW1wdHk6IGZ1bmN0aW9uKCl7CgkJR2FyYmFnZS50cmFzaCh0aGlzLmdldEVsZW1lbnRzQnlUYWdOYW1lKCcqJykpOwoJCXJldHVybiB0aGlzLnNldEhUTUwoJycpOwoJfQoKfSk7CgpFbGVtZW50LmZpeFN0eWxlID0gZnVuY3Rpb24ocHJvcGVydHksIHJlc3VsdCwgZWxlbWVudCl7CglpZiAoJGNoayhwYXJzZUludChyZXN1bHQpKSkgcmV0dXJuIHJlc3VsdDsKCWlmIChbJ2hlaWdodCcsICd3aWR0aCddLmNvbnRhaW5zKHByb3BlcnR5KSl7CgkJdmFyIHZhbHVlcyA9IChwcm9wZXJ0eSA9PSAnd2lkdGgnKSA/IFsnbGVmdCcsICdyaWdodCddIDogWyd0b3AnLCAnYm90dG9tJ107CgkJdmFyIHNpemUgPSAwOwoJCXZhbHVlcy5lYWNoKGZ1bmN0aW9uKHZhbHVlKXsKCQkJc2l6ZSArPSBlbGVtZW50LmdldFN0eWxlKCdib3JkZXItJyArIHZhbHVlICsgJy13aWR0aCcpLnRvSW50KCkgKyBlbGVtZW50LmdldFN0eWxlKCdwYWRkaW5nLScgKyB2YWx1ZSkudG9JbnQoKTsKCQl9KTsKCQlyZXR1cm4gZWxlbWVudFsnb2Zmc2V0JyArIHByb3BlcnR5LmNhcGl0YWxpemUoKV0gLSBzaXplICsgJ3B4JzsKCX0gZWxzZSBpZiAocHJvcGVydHkudGVzdCgvYm9yZGVyKC4rKVdpZHRofG1hcmdpbnxwYWRkaW5nLykpewoJCXJldHVybiAnMHB4JzsKCX0KCXJldHVybiByZXN1bHQ7Cn07CgpFbGVtZW50LlN0eWxlcyA9IHsnYm9yZGVyJzogW10sICdwYWRkaW5nJzogW10sICdtYXJnaW4nOiBbXX07ClsnVG9wJywgJ1JpZ2h0JywgJ0JvdHRvbScsICdMZWZ0J10uZWFjaChmdW5jdGlvbihkaXJlY3Rpb24pewoJZm9yICh2YXIgc3R5bGUgaW4gRWxlbWVudC5TdHlsZXMpIEVsZW1lbnQuU3R5bGVzW3N0eWxlXS5wdXNoKHN0eWxlICsgZGlyZWN0aW9uKTsKfSk7CgpFbGVtZW50LmJvcmRlclNob3J0ID0gWydib3JkZXJXaWR0aCcsICdib3JkZXJTdHlsZScsICdib3JkZXJDb2xvciddOwoKRWxlbWVudC5nZXRNYW55ID0gZnVuY3Rpb24oZWwsIG1ldGhvZCwga2V5cyl7Cgl2YXIgcmVzdWx0ID0ge307CgkkZWFjaChrZXlzLCBmdW5jdGlvbihrZXkpewoJCXJlc3VsdFtrZXldID0gZWxbbWV0aG9kXShrZXkpOwoJfSk7CglyZXR1cm4gcmVzdWx0Owp9OwoKRWxlbWVudC5zZXRNYW55ID0gZnVuY3Rpb24oZWwsIG1ldGhvZCwgcGFpcnMpewoJZm9yICh2YXIga2V5IGluIHBhaXJzKSBlbFttZXRob2RdKGtleSwgcGFpcnNba2V5XSk7CglyZXR1cm4gZWw7Cn07CgpFbGVtZW50LlByb3BlcnRpZXMgPSBuZXcgQWJzdHJhY3QoewoJJ2NsYXNzJzogJ2NsYXNzTmFtZScsICdmb3InOiAnaHRtbEZvcicsICdjb2xzcGFuJzogJ2NvbFNwYW4nLCAncm93c3Bhbic6ICdyb3dTcGFuJywKCSdhY2Nlc3NrZXknOiAnYWNjZXNzS2V5JywgJ3RhYmluZGV4JzogJ3RhYkluZGV4JywgJ21heGxlbmd0aCc6ICdtYXhMZW5ndGgnLAoJJ3JlYWRvbmx5JzogJ3JlYWRPbmx5JywgJ2ZyYW1lYm9yZGVyJzogJ2ZyYW1lQm9yZGVyJywgJ3ZhbHVlJzogJ3ZhbHVlJywKCSdkaXNhYmxlZCc6ICdkaXNhYmxlZCcsICdjaGVja2VkJzogJ2NoZWNrZWQnLCAnbXVsdGlwbGUnOiAnbXVsdGlwbGUnLCAnc2VsZWN0ZWQnOiAnc2VsZWN0ZWQnCn0pOwpFbGVtZW50LlByb3BlcnRpZXNJRmxhZyA9IHsKCSdocmVmJzogMiwgJ3NyYyc6IDIKfTsKCkVsZW1lbnQuTWV0aG9kcyA9IHsKCUxpc3RlbmVyczogewoJCWFkZExpc3RlbmVyOiBmdW5jdGlvbih0eXBlLCBmbil7CgkJCWlmICh0aGlzLmFkZEV2ZW50TGlzdGVuZXIpIHRoaXMuYWRkRXZlbnRMaXN0ZW5lcih0eXBlLCBmbiwgZmFsc2UpOwoJCQllbHNlIHRoaXMuYXR0YWNoRXZlbnQoJ29uJyArIHR5cGUsIGZuKTsKCQkJcmV0dXJuIHRoaXM7CgkJfSwKCgkJcmVtb3ZlTGlzdGVuZXI6IGZ1bmN0aW9uKHR5cGUsIGZuKXsKCQkJaWYgKHRoaXMucmVtb3ZlRXZlbnRMaXN0ZW5lcikgdGhpcy5yZW1vdmVFdmVudExpc3RlbmVyKHR5cGUsIGZuLCBmYWxzZSk7CgkJCWVsc2UgdGhpcy5kZXRhY2hFdmVudCgnb24nICsgdHlwZSwgZm4pOwoJCQlyZXR1cm4gdGhpczsKCQl9Cgl9Cn07Cgp3aW5kb3cuZXh0ZW5kKEVsZW1lbnQuTWV0aG9kcy5MaXN0ZW5lcnMpOwpkb2N1bWVudC5leHRlbmQoRWxlbWVudC5NZXRob2RzLkxpc3RlbmVycyk7CkVsZW1lbnQuZXh0ZW5kKEVsZW1lbnQuTWV0aG9kcy5MaXN0ZW5lcnMpOwoKdmFyIEdhcmJhZ2UgPSB7CgoJZWxlbWVudHM6IFtdLAoKCWNvbGxlY3Q6IGZ1bmN0aW9uKGVsKXsKCQlpZiAoIWVsLiR0bXApewoJCQlHYXJiYWdlLmVsZW1lbnRzLnB1c2goZWwpOwoJCQllbC4kdG1wID0geydvcGFjaXR5JzogMX07CgkJfQoJCXJldHVybiBlbDsKCX0sCgoJdHJhc2g6IGZ1bmN0aW9uKGVsZW1lbnRzKXsKCQlmb3IgKHZhciBpID0gMCwgaiA9IGVsZW1lbnRzLmxlbmd0aCwgZWw7IGkgPCBqOyBpKyspewoJCQlpZiAoIShlbCA9IGVsZW1lbnRzW2ldKSB8fCAhZWwuJHRtcCkgY29udGludWU7CgkJCWlmIChlbC4kZXZlbnRzKSBlbC5maXJlRXZlbnQoJ3RyYXNoJykucmVtb3ZlRXZlbnRzKCk7CgkJCWZvciAodmFyIHAgaW4gZWwuJHRtcCkgZWwuJHRtcFtwXSA9IG51bGw7CgkJCWZvciAodmFyIGQgaW4gRWxlbWVudC5wcm90b3R5cGUpIGVsW2RdID0gbnVsbDsKCQkJR2FyYmFnZS5lbGVtZW50c1tHYXJiYWdlLmVsZW1lbnRzLmluZGV4T2YoZWwpXSA9IG51bGw7CgkJCWVsLmh0bWxFbGVtZW50ID0gZWwuJHRtcCA9IGVsID0gbnVsbDsKCQl9CgkJR2FyYmFnZS5lbGVtZW50cy5yZW1vdmUobnVsbCk7Cgl9LAoKCWVtcHR5OiBmdW5jdGlvbigpewoJCUdhcmJhZ2UuY29sbGVjdCh3aW5kb3cpOwoJCUdhcmJhZ2UuY29sbGVjdChkb2N1bWVudCk7CgkJR2FyYmFnZS50cmFzaChHYXJiYWdlLmVsZW1lbnRzKTsKCX0KCn07Cgp3aW5kb3cuYWRkTGlzdGVuZXIoJ2JlZm9yZXVubG9hZCcsIGZ1bmN0aW9uKCl7Cgl3aW5kb3cuYWRkTGlzdGVuZXIoJ3VubG9hZCcsIEdhcmJhZ2UuZW1wdHkpOwoJaWYgKHdpbmRvdy5pZSkgd2luZG93LmFkZExpc3RlbmVyKCd1bmxvYWQnLCBDb2xsZWN0R2FyYmFnZSk7Cn0pOwoKLyoKU2NyaXB0OiBFbGVtZW50LkV2ZW50LmpzCglDb250YWlucyB0aGUgRXZlbnQgQ2xhc3MsIEVsZW1lbnQgbWV0aG9kcyB0byBkZWFsIHdpdGggRWxlbWVudCBldmVudHMsIGN1c3RvbSBFdmVudHMsIGFuZCB0aGUgRnVuY3Rpb24gcHJvdG90eXBlIGJpbmRXaXRoRXZlbnQuCgpMaWNlbnNlOgoJTUlULXN0eWxlIGxpY2Vuc2UuCiovCgovKgpDbGFzczogRXZlbnQKCUNyb3NzIGJyb3dzZXIgbWV0aG9kcyB0byBtYW5hZ2UgZXZlbnRzLgoKQXJndW1lbnRzOgoJZXZlbnQgLSB0aGUgZXZlbnQKClByb3BlcnRpZXM6CglzaGlmdCAtIHRydWUgaWYgdGhlIHVzZXIgcHJlc3NlZCB0aGUgc2hpZnQKCWNvbnRyb2wgLSB0cnVlIGlmIHRoZSB1c2VyIHByZXNzZWQgdGhlIGNvbnRyb2wKCWFsdCAtIHRydWUgaWYgdGhlIHVzZXIgcHJlc3NlZCB0aGUgYWx0CgltZXRhIC0gdHJ1ZSBpZiB0aGUgdXNlciBwcmVzc2VkIHRoZSBtZXRhIGtleQoJd2hlZWwgLSB0aGUgYW1vdW50IG9mIHRoaXJkIGJ1dHRvbiBzY3JvbGxpbmcKCWNvZGUgLSB0aGUga2V5Y29kZSBvZiB0aGUga2V5IHByZXNzZWQKCXBhZ2UueCAtIHRoZSB4IHBvc2l0aW9uIG9mIHRoZSBtb3VzZSwgcmVsYXRpdmUgdG8gdGhlIGZ1bGwgd2luZG93CglwYWdlLnkgLSB0aGUgeSBwb3NpdGlvbiBvZiB0aGUgbW91c2UsIHJlbGF0aXZlIHRvIHRoZSBmdWxsIHdpbmRvdwoJY2xpZW50LnggLSB0aGUgeCBwb3NpdGlvbiBvZiB0aGUgbW91c2UsIHJlbGF0aXZlIHRvIHRoZSB2aWV3cG9ydAoJY2xpZW50LnkgLSB0aGUgeSBwb3NpdGlvbiBvZiB0aGUgbW91c2UsIHJlbGF0aXZlIHRvIHRoZSB2aWV3cG9ydAoJa2V5IC0gdGhlIGtleSBwcmVzc2VkIGFzIGEgbG93ZXJjYXNlIHN0cmluZy4ga2V5IGFsc28gcmV0dXJucyAnZW50ZXInLCAndXAnLCAnZG93bicsICdsZWZ0JywgJ3JpZ2h0JywgJ3NwYWNlJywgJ2JhY2tzcGFjZScsICdkZWxldGUnLCAnZXNjJy4gSGFuZHkgZm9yIHRoZXNlIHNwZWNpYWwga2V5cy4KCXRhcmdldCAtIHRoZSBldmVudCB0YXJnZXQKCXJlbGF0ZWRUYXJnZXQgLSB0aGUgZXZlbnQgcmVsYXRlZCB0YXJnZXQKCkV4YW1wbGU6Cgkoc3RhcnQgY29kZSkKCSQoJ215TGluaycpLm9ua2V5ZG93biA9IGZ1bmN0aW9uKGV2ZW50KXsKCQl2YXIgZXZlbnQgPSBuZXcgRXZlbnQoZXZlbnQpOwoJCS8vZXZlbnQgaXMgbm93IHRoZSBFdmVudCBjbGFzcy4KCQlhbGVydChldmVudC5rZXkpOyAvL3JldHVybnMgdGhlIGxvd2VyY2FzZSBsZXR0ZXIgcHJlc3NlZAoJCWFsZXJ0KGV2ZW50LnNoaWZ0KTsgLy9yZXR1cm5zIHRydWUgaWYgdGhlIGtleSBwcmVzc2VkIGlzIHNoaWZ0CgkJaWYgKGV2ZW50LmtleSA9PSAncycgJiYgZXZlbnQuY29udHJvbCkgYWxlcnQoJ2RvY3VtZW50IHNhdmVkJyk7Cgl9OwoJKGVuZCkKKi8KCnZhciBFdmVudCA9IG5ldyBDbGFzcyh7CgoJaW5pdGlhbGl6ZTogZnVuY3Rpb24oZXZlbnQpewoJCWlmIChldmVudCAmJiBldmVudC4kZXh0ZW5kZWQpIHJldHVybiBldmVudDsKCQl0aGlzLiRleHRlbmRlZCA9IHRydWU7CgkJZXZlbnQgPSBldmVudCB8fCB3aW5kb3cuZXZlbnQ7CgkJdGhpcy5ldmVudCA9IGV2ZW50OwoJCXRoaXMudHlwZSA9IGV2ZW50LnR5cGU7CgkJdGhpcy50YXJnZXQgPSBldmVudC50YXJnZXQgfHwgZXZlbnQuc3JjRWxlbWVudDsKCQlpZiAodGhpcy50YXJnZXQubm9kZVR5cGUgPT0gMykgdGhpcy50YXJnZXQgPSB0aGlzLnRhcmdldC5wYXJlbnROb2RlOwoJCXRoaXMuc2hpZnQgPSBldmVudC5zaGlmdEtleTsKCQl0aGlzLmNvbnRyb2wgPSBldmVudC5jdHJsS2V5OwoJCXRoaXMuYWx0ID0gZXZlbnQuYWx0S2V5OwoJCXRoaXMubWV0YSA9IGV2ZW50Lm1ldGFLZXk7CgkJaWYgKFsnRE9NTW91c2VTY3JvbGwnLCAnbW91c2V3aGVlbCddLmNvbnRhaW5zKHRoaXMudHlwZSkpewoJCQl0aGlzLndoZWVsID0gKGV2ZW50LndoZWVsRGVsdGEpID8gZXZlbnQud2hlZWxEZWx0YSAvIDEyMCA6IC0oZXZlbnQuZGV0YWlsIHx8IDApIC8gMzsKCQl9IGVsc2UgaWYgKHRoaXMudHlwZS5jb250YWlucygna2V5JykpewoJCQl0aGlzLmNvZGUgPSBldmVudC53aGljaCB8fCBldmVudC5rZXlDb2RlOwoJCQlmb3IgKHZhciBuYW1lIGluIEV2ZW50LmtleXMpewoJCQkJaWYgKEV2ZW50LmtleXNbbmFtZV0gPT0gdGhpcy5jb2RlKXsKCQkJCQl0aGlzLmtleSA9IG5hbWU7CgkJCQkJYnJlYWs7CgkJCQl9CgkJCX0KCQkJaWYgKHRoaXMudHlwZSA9PSAna2V5ZG93bicpewoJCQkJdmFyIGZLZXkgPSB0aGlzLmNvZGUgLSAxMTE7CgkJCQlpZiAoZktleSA+IDAgJiYgZktleSA8IDEzKSB0aGlzLmtleSA9ICdmJyArIGZLZXk7CgkJCX0KCQkJdGhpcy5rZXkgPSB0aGlzLmtleSB8fCBTdHJpbmcuZnJvbUNoYXJDb2RlKHRoaXMuY29kZSkudG9Mb3dlckNhc2UoKTsKCQl9IGVsc2UgaWYgKHRoaXMudHlwZS50ZXN0KC8oY2xpY2t8bW91c2V8bWVudSkvKSl7CgkJCXRoaXMucGFnZSA9IHsKCQkJCSd4JzogZXZlbnQucGFnZVggfHwgZXZlbnQuY2xpZW50WCArIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5zY3JvbGxMZWZ0LAoJCQkJJ3knOiBldmVudC5wYWdlWSB8fCBldmVudC5jbGllbnRZICsgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LnNjcm9sbFRvcAoJCQl9OwoJCQl0aGlzLmNsaWVudCA9IHsKCQkJCSd4JzogZXZlbnQucGFnZVggPyBldmVudC5wYWdlWCAtIHdpbmRvdy5wYWdlWE9mZnNldCA6IGV2ZW50LmNsaWVudFgsCgkJCQkneSc6IGV2ZW50LnBhZ2VZID8gZXZlbnQucGFnZVkgLSB3aW5kb3cucGFnZVlPZmZzZXQgOiBldmVudC5jbGllbnRZCgkJCX07CgkJCXRoaXMucmlnaHRDbGljayA9IChldmVudC53aGljaCA9PSAzKSB8fCAoZXZlbnQuYnV0dG9uID09IDIpOwoJCQlzd2l0Y2godGhpcy50eXBlKXsKCQkJCWNhc2UgJ21vdXNlb3Zlcic6IHRoaXMucmVsYXRlZFRhcmdldCA9IGV2ZW50LnJlbGF0ZWRUYXJnZXQgfHwgZXZlbnQuZnJvbUVsZW1lbnQ7IGJyZWFrOwoJCQkJY2FzZSAnbW91c2VvdXQnOiB0aGlzLnJlbGF0ZWRUYXJnZXQgPSBldmVudC5yZWxhdGVkVGFyZ2V0IHx8IGV2ZW50LnRvRWxlbWVudDsKCQkJfQoJCQl0aGlzLmZpeFJlbGF0ZWRUYXJnZXQoKTsKCQl9CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCS8qCglQcm9wZXJ0eTogc3RvcAoJCWNyb3NzIGJyb3dzZXIgbWV0aG9kIHRvIHN0b3AgYW4gZXZlbnQKCSovCgoJc3RvcDogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5zdG9wUHJvcGFnYXRpb24oKS5wcmV2ZW50RGVmYXVsdCgpOwoJfSwKCgkvKgoJUHJvcGVydHk6IHN0b3BQcm9wYWdhdGlvbgoJCWNyb3NzIGJyb3dzZXIgbWV0aG9kIHRvIHN0b3AgdGhlIHByb3BhZ2F0aW9uIG9mIGFuIGV2ZW50CgkqLwoKCXN0b3BQcm9wYWdhdGlvbjogZnVuY3Rpb24oKXsKCQlpZiAodGhpcy5ldmVudC5zdG9wUHJvcGFnYXRpb24pIHRoaXMuZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7CgkJZWxzZSB0aGlzLmV2ZW50LmNhbmNlbEJ1YmJsZSA9IHRydWU7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCS8qCglQcm9wZXJ0eTogcHJldmVudERlZmF1bHQKCQljcm9zcyBicm93c2VyIG1ldGhvZCB0byBwcmV2ZW50IHRoZSBkZWZhdWx0IGFjdGlvbiBvZiB0aGUgZXZlbnQKCSovCgoJcHJldmVudERlZmF1bHQ6IGZ1bmN0aW9uKCl7CgkJaWYgKHRoaXMuZXZlbnQucHJldmVudERlZmF1bHQpIHRoaXMuZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQllbHNlIHRoaXMuZXZlbnQucmV0dXJuVmFsdWUgPSBmYWxzZTsKCQlyZXR1cm4gdGhpczsKCX0KCn0pOwoKRXZlbnQuZml4ID0gewoKCXJlbGF0ZWRUYXJnZXQ6IGZ1bmN0aW9uKCl7CgkJaWYgKHRoaXMucmVsYXRlZFRhcmdldCAmJiB0aGlzLnJlbGF0ZWRUYXJnZXQubm9kZVR5cGUgPT0gMykgdGhpcy5yZWxhdGVkVGFyZ2V0ID0gdGhpcy5yZWxhdGVkVGFyZ2V0LnBhcmVudE5vZGU7Cgl9LAoKCXJlbGF0ZWRUYXJnZXRHZWNrbzogZnVuY3Rpb24oKXsKCQl0cnkge0V2ZW50LmZpeC5yZWxhdGVkVGFyZ2V0LmNhbGwodGhpcyk7fSBjYXRjaChlKXt0aGlzLnJlbGF0ZWRUYXJnZXQgPSB0aGlzLnRhcmdldDt9Cgl9Cgp9OwoKRXZlbnQucHJvdG90eXBlLmZpeFJlbGF0ZWRUYXJnZXQgPSAod2luZG93LmdlY2tvKSA/IEV2ZW50LmZpeC5yZWxhdGVkVGFyZ2V0R2Vja28gOiBFdmVudC5maXgucmVsYXRlZFRhcmdldDsKCi8qClByb3BlcnR5OiBrZXlzCgl5b3UgY2FuIGFkZCBhZGRpdGlvbmFsIEV2ZW50IGtleXMgY29kZXMgdGhpcyB3YXk6CgpFeGFtcGxlOgoJKHN0YXJ0IGNvZGUpCglFdmVudC5rZXlzLndoYXRldmVyID0gODA7CgkkKG15ZWxlbWVudCkuYWRkRXZlbnQoa2V5ZG93biwgZnVuY3Rpb24oZXZlbnQpewoJCWV2ZW50ID0gbmV3IEV2ZW50KGV2ZW50KTsKCQlpZiAoZXZlbnQua2V5ID09ICd3aGF0ZXZlcicpIGNvbnNvbGUubG9nKHdoYXRldmVyIGtleSBjbGlja2VkKS4KCX0pOwoJKGVuZCkKKi8KCkV2ZW50LmtleXMgPSBuZXcgQWJzdHJhY3QoewoJJ2VudGVyJzogMTMsCgkndXAnOiAzOCwKCSdkb3duJzogNDAsCgknbGVmdCc6IDM3LAoJJ3JpZ2h0JzogMzksCgknZXNjJzogMjcsCgknc3BhY2UnOiAzMiwKCSdiYWNrc3BhY2UnOiA4LAoJJ3RhYic6IDksCgknZGVsZXRlJzogNDYKfSk7CgovKgpDbGFzczogRWxlbWVudAoJQ3VzdG9tIGNsYXNzIHRvIGFsbG93IGFsbCBvZiBpdHMgbWV0aG9kcyB0byBiZSB1c2VkIHdpdGggYW55IERPTSBlbGVtZW50IHZpYSB0aGUgZG9sbGFyIGZ1bmN0aW9uIDwkPi4KKi8KCkVsZW1lbnQuTWV0aG9kcy5FdmVudHMgPSB7CgoJLyoKCVByb3BlcnR5OiBhZGRFdmVudAoJCUF0dGFjaGVzIGFuIGV2ZW50IGxpc3RlbmVyIHRvIGEgRE9NIGVsZW1lbnQuCgoJQXJndW1lbnRzOgoJCXR5cGUgLSB0aGUgZXZlbnQgdG8gbW9uaXRvciAoJ2NsaWNrJywgJ2xvYWQnLCBldGMpIHdpdGhvdXQgdGhlIHByZWZpeCAnb24nLgoJCWZuIC0gdGhlIGZ1bmN0aW9uIHRvIGV4ZWN1dGUKCglFeGFtcGxlOgoJCT4kKCdteUVsZW1lbnQnKS5hZGRFdmVudCgnY2xpY2snLCBmdW5jdGlvbigpe2FsZXJ0KCdjbGlja2VkIScpfSk7CgkqLwoKCWFkZEV2ZW50OiBmdW5jdGlvbih0eXBlLCBmbil7CgkJdGhpcy4kZXZlbnRzID0gdGhpcy4kZXZlbnRzIHx8IHt9OwoJCXRoaXMuJGV2ZW50c1t0eXBlXSA9IHRoaXMuJGV2ZW50c1t0eXBlXSB8fCB7J2tleXMnOiBbXSwgJ3ZhbHVlcyc6IFtdfTsKCQlpZiAodGhpcy4kZXZlbnRzW3R5cGVdLmtleXMuY29udGFpbnMoZm4pKSByZXR1cm4gdGhpczsKCQl0aGlzLiRldmVudHNbdHlwZV0ua2V5cy5wdXNoKGZuKTsKCQl2YXIgcmVhbFR5cGUgPSB0eXBlOwoJCXZhciBjdXN0b20gPSBFbGVtZW50LkV2ZW50c1t0eXBlXTsKCQlpZiAoY3VzdG9tKXsKCQkJaWYgKGN1c3RvbS5hZGQpIGN1c3RvbS5hZGQuY2FsbCh0aGlzLCBmbik7CgkJCWlmIChjdXN0b20ubWFwKSBmbiA9IGN1c3RvbS5tYXA7CgkJCWlmIChjdXN0b20udHlwZSkgcmVhbFR5cGUgPSBjdXN0b20udHlwZTsKCQl9CgkJaWYgKCF0aGlzLmFkZEV2ZW50TGlzdGVuZXIpIGZuID0gZm4uY3JlYXRlKHsnYmluZCc6IHRoaXMsICdldmVudCc6IHRydWV9KTsKCQl0aGlzLiRldmVudHNbdHlwZV0udmFsdWVzLnB1c2goZm4pOwoJCXJldHVybiAoRWxlbWVudC5OYXRpdmVFdmVudHMuY29udGFpbnMocmVhbFR5cGUpKSA/IHRoaXMuYWRkTGlzdGVuZXIocmVhbFR5cGUsIGZuKSA6IHRoaXM7Cgl9LAoKCS8qCglQcm9wZXJ0eTogcmVtb3ZlRXZlbnQKCQlXb3JrcyBhcyBFbGVtZW50LmFkZEV2ZW50LCBidXQgaW5zdGVhZCByZW1vdmVzIHRoZSBwcmV2aW91c2x5IGFkZGVkIGV2ZW50IGxpc3RlbmVyLgoJKi8KCglyZW1vdmVFdmVudDogZnVuY3Rpb24odHlwZSwgZm4pewoJCWlmICghdGhpcy4kZXZlbnRzIHx8ICF0aGlzLiRldmVudHNbdHlwZV0pIHJldHVybiB0aGlzOwoJCXZhciBwb3MgPSB0aGlzLiRldmVudHNbdHlwZV0ua2V5cy5pbmRleE9mKGZuKTsKCQlpZiAocG9zID09IC0xKSByZXR1cm4gdGhpczsKCQl2YXIga2V5ID0gdGhpcy4kZXZlbnRzW3R5cGVdLmtleXMuc3BsaWNlKHBvcywxKVswXTsKCQl2YXIgdmFsdWUgPSB0aGlzLiRldmVudHNbdHlwZV0udmFsdWVzLnNwbGljZShwb3MsMSlbMF07CgkJdmFyIGN1c3RvbSA9IEVsZW1lbnQuRXZlbnRzW3R5cGVdOwoJCWlmIChjdXN0b20pewoJCQlpZiAoY3VzdG9tLnJlbW92ZSkgY3VzdG9tLnJlbW92ZS5jYWxsKHRoaXMsIGZuKTsKCQkJaWYgKGN1c3RvbS50eXBlKSB0eXBlID0gY3VzdG9tLnR5cGU7CgkJfQoJCXJldHVybiAoRWxlbWVudC5OYXRpdmVFdmVudHMuY29udGFpbnModHlwZSkpID8gdGhpcy5yZW1vdmVMaXN0ZW5lcih0eXBlLCB2YWx1ZSkgOiB0aGlzOwoJfSwKCgkvKgoJUHJvcGVydHk6IGFkZEV2ZW50cwoJCUFzIDxhZGRFdmVudD4sIGJ1dCBhY2NlcHRzIGFuIG9iamVjdCBhbmQgYWRkIG11bHRpcGxlIGV2ZW50cyBhdCBvbmNlLgoJKi8KCglhZGRFdmVudHM6IGZ1bmN0aW9uKHNvdXJjZSl7CgkJcmV0dXJuIEVsZW1lbnQuc2V0TWFueSh0aGlzLCAnYWRkRXZlbnQnLCBzb3VyY2UpOwoJfSwKCgkvKgoJUHJvcGVydHk6IHJlbW92ZUV2ZW50cwoJCXJlbW92ZXMgYWxsIGV2ZW50cyBvZiBhIGNlcnRhaW4gdHlwZSBmcm9tIGFuIGVsZW1lbnQuIGlmIG5vIGFyZ3VtZW50IGlzIHBhc3NlZCBpbiwgcmVtb3ZlcyBhbGwgZXZlbnRzLgoKCUFyZ3VtZW50czoKCQl0eXBlIC0gc3RyaW5nOyB0aGUgZXZlbnQgbmFtZSAoZS5nLiAnY2xpY2snKQoJKi8KCglyZW1vdmVFdmVudHM6IGZ1bmN0aW9uKHR5cGUpewoJCWlmICghdGhpcy4kZXZlbnRzKSByZXR1cm4gdGhpczsKCQlpZiAoIXR5cGUpewoJCQlmb3IgKHZhciBldlR5cGUgaW4gdGhpcy4kZXZlbnRzKSB0aGlzLnJlbW92ZUV2ZW50cyhldlR5cGUpOwoJCQl0aGlzLiRldmVudHMgPSBudWxsOwoJCX0gZWxzZSBpZiAodGhpcy4kZXZlbnRzW3R5cGVdKXsKCQkJdGhpcy4kZXZlbnRzW3R5cGVdLmtleXMuZWFjaChmdW5jdGlvbihmbil7CgkJCQl0aGlzLnJlbW92ZUV2ZW50KHR5cGUsIGZuKTsKCQkJfSwgdGhpcyk7CgkJCXRoaXMuJGV2ZW50c1t0eXBlXSA9IG51bGw7CgkJfQoJCXJldHVybiB0aGlzOwoJfSwKCgkvKgoJUHJvcGVydHk6IGZpcmVFdmVudAoJCWV4ZWN1dGVzIGFsbCBldmVudHMgb2YgdGhlIHNwZWNpZmllZCB0eXBlIHByZXNlbnQgaW4gdGhlIGVsZW1lbnQuCgoJQXJndW1lbnRzOgoJCXR5cGUgLSBzdHJpbmc7IHRoZSBldmVudCBuYW1lIChlLmcuICdjbGljaycpCgkJYXJncyAtIGFycmF5IG9yIHNpbmdsZSBvYmplY3Q7IGFyZ3VtZW50cyB0byBwYXNzIHRvIHRoZSBmdW5jdGlvbjsgaWYgbW9yZSB0aGFuIG9uZSBhcmd1bWVudCwgbXVzdCBiZSBhbiBhcnJheQoJCWRlbGF5IC0gKGludGVnZXIpIGRlbGF5IChpbiBtcykgdG8gd2FpdCB0byBleGVjdXRlIHRoZSBldmVudAoJKi8KCglmaXJlRXZlbnQ6IGZ1bmN0aW9uKHR5cGUsIGFyZ3MsIGRlbGF5KXsKCQlpZiAodGhpcy4kZXZlbnRzICYmIHRoaXMuJGV2ZW50c1t0eXBlXSl7CgkJCXRoaXMuJGV2ZW50c1t0eXBlXS5rZXlzLmVhY2goZnVuY3Rpb24oZm4pewoJCQkJZm4uY3JlYXRlKHsnYmluZCc6IHRoaXMsICdkZWxheSc6IGRlbGF5LCAnYXJndW1lbnRzJzogYXJnc30pKCk7CgkJCX0sIHRoaXMpOwoJCX0KCQlyZXR1cm4gdGhpczsKCX0sCgoJLyoKCVByb3BlcnR5OiBjbG9uZUV2ZW50cwoJCUNsb25lcyBhbGwgZXZlbnRzIGZyb20gYW4gZWxlbWVudCB0byB0aGlzIGVsZW1lbnQuCgoJQXJndW1lbnRzOgoJCWZyb20gLSBlbGVtZW50LCBjb3B5IGFsbCBldmVudHMgZnJvbSB0aGlzIGVsZW1lbnQKCQl0eXBlIC0gb3B0aW9uYWwsIGNvcGllcyBvbmx5IGV2ZW50cyBvZiB0aGlzIHR5cGUKCSovCgoJY2xvbmVFdmVudHM6IGZ1bmN0aW9uKGZyb20sIHR5cGUpewoJCWlmICghZnJvbS4kZXZlbnRzKSByZXR1cm4gdGhpczsKCQlpZiAoIXR5cGUpewoJCQlmb3IgKHZhciBldlR5cGUgaW4gZnJvbS4kZXZlbnRzKSB0aGlzLmNsb25lRXZlbnRzKGZyb20sIGV2VHlwZSk7CgkJfSBlbHNlIGlmIChmcm9tLiRldmVudHNbdHlwZV0pewoJCQlmcm9tLiRldmVudHNbdHlwZV0ua2V5cy5lYWNoKGZ1bmN0aW9uKGZuKXsKCQkJCXRoaXMuYWRkRXZlbnQodHlwZSwgZm4pOwoJCQl9LCB0aGlzKTsKCQl9CgkJcmV0dXJuIHRoaXM7Cgl9Cgp9OwoKd2luZG93LmV4dGVuZChFbGVtZW50Lk1ldGhvZHMuRXZlbnRzKTsKZG9jdW1lbnQuZXh0ZW5kKEVsZW1lbnQuTWV0aG9kcy5FdmVudHMpOwpFbGVtZW50LmV4dGVuZChFbGVtZW50Lk1ldGhvZHMuRXZlbnRzKTsKCi8qIFNlY3Rpb246IEN1c3RvbSBFdmVudHMgKi8KCkVsZW1lbnQuRXZlbnRzID0gbmV3IEFic3RyYWN0KHsKCgkvKgoJRXZlbnQ6IG1vdXNlZW50ZXIKCQlJbiBhZGRpdGlvbiB0byB0aGUgc3RhbmRhcmQgamF2YXNjcmlwdCBldmVudHMgKGxvYWQsIG1vdXNlb3ZlciwgbW91c2VvdXQsIGNsaWNrLCBldGMuKSA8RXZlbnQuanM+IGNvbnRhaW5zIHR3byBjdXN0b20gZXZlbnRzCgkJdGhpcyBldmVudCBmaXJlcyB3aGVuIHRoZSBtb3VzZSBlbnRlcnMgdGhlIGFyZWEgb2YgdGhlIGRvbSBlbGVtZW50OyB3aWxsIG5vdCBiZSBmaXJlZCBhZ2FpbiBpZiB0aGUgbW91c2UgY3Jvc3NlcyBvdmVyIGNoaWxkcmVuIG9mIHRoZSBlbGVtZW50ICh1bmxpa2UgbW91c2VvdmVyKQoKCUV4YW1wbGU6CgkJPiQobXlFbGVtZW50KS5hZGRFdmVudCgnbW91c2VlbnRlcicsIG15RnVuY3Rpb24pOwoJKi8KCgknbW91c2VlbnRlcic6IHsKCQl0eXBlOiAnbW91c2VvdmVyJywKCQltYXA6IGZ1bmN0aW9uKGV2ZW50KXsKCQkJZXZlbnQgPSBuZXcgRXZlbnQoZXZlbnQpOwoJCQlpZiAoZXZlbnQucmVsYXRlZFRhcmdldCAhPSB0aGlzICYmICF0aGlzLmhhc0NoaWxkKGV2ZW50LnJlbGF0ZWRUYXJnZXQpKSB0aGlzLmZpcmVFdmVudCgnbW91c2VlbnRlcicsIGV2ZW50KTsKCQl9Cgl9LAoKCS8qCglFdmVudDogbW91c2VsZWF2ZQoJCXRoaXMgZXZlbnQgZmlyZXMgd2hlbiB0aGUgbW91c2UgZXhpdHMgdGhlIGFyZWEgb2YgdGhlIGRvbSBlbGVtZW50OyB3aWxsIG5vdCBiZSBmaXJlZCBhZ2FpbiBpZiB0aGUgbW91c2UgY3Jvc3NlcyBvdmVyIGNoaWxkcmVuIG9mIHRoZSBlbGVtZW50ICh1bmxpa2UgbW91c2VvdXQpCgoJRXhhbXBsZToKCQk+JChteUVsZW1lbnQpLmFkZEV2ZW50KCdtb3VzZWxlYXZlJywgbXlGdW5jdGlvbik7CgkqLwoKCSdtb3VzZWxlYXZlJzogewoJCXR5cGU6ICdtb3VzZW91dCcsCgkJbWFwOiBmdW5jdGlvbihldmVudCl7CgkJCWV2ZW50ID0gbmV3IEV2ZW50KGV2ZW50KTsKCQkJaWYgKGV2ZW50LnJlbGF0ZWRUYXJnZXQgIT0gdGhpcyAmJiAhdGhpcy5oYXNDaGlsZChldmVudC5yZWxhdGVkVGFyZ2V0KSkgdGhpcy5maXJlRXZlbnQoJ21vdXNlbGVhdmUnLCBldmVudCk7CgkJfQoJfSwKCgknbW91c2V3aGVlbCc6IHsKCQl0eXBlOiAod2luZG93LmdlY2tvKSA/ICdET01Nb3VzZVNjcm9sbCcgOiAnbW91c2V3aGVlbCcKCX0KCn0pOwoKRWxlbWVudC5OYXRpdmVFdmVudHMgPSBbCgknY2xpY2snLCAnZGJsY2xpY2snLCAnbW91c2V1cCcsICdtb3VzZWRvd24nLCAvL21vdXNlIGJ1dHRvbnMKCSdtb3VzZXdoZWVsJywgJ0RPTU1vdXNlU2Nyb2xsJywgLy9tb3VzZSB3aGVlbAoJJ21vdXNlb3ZlcicsICdtb3VzZW91dCcsICdtb3VzZW1vdmUnLCAvL21vdXNlIG1vdmVtZW50Cgkna2V5ZG93bicsICdrZXlwcmVzcycsICdrZXl1cCcsIC8va2V5cwoJJ2xvYWQnLCAndW5sb2FkJywgJ2JlZm9yZXVubG9hZCcsICdyZXNpemUnLCAnbW92ZScsIC8vd2luZG93CgknZm9jdXMnLCAnYmx1cicsICdjaGFuZ2UnLCAnc3VibWl0JywgJ3Jlc2V0JywgJ3NlbGVjdCcsIC8vZm9ybXMgZWxlbWVudHMKCSdlcnJvcicsICdhYm9ydCcsICdjb250ZXh0bWVudScsICdzY3JvbGwnIC8vbWlzYwpdOwoKLyoKQ2xhc3M6IEZ1bmN0aW9uCglBIGNvbGxlY3Rpb24gb2YgVGhlIEZ1bmN0aW9uIE9iamVjdCBwcm90b3R5cGUgbWV0aG9kcy4KKi8KCkZ1bmN0aW9uLmV4dGVuZCh7CgoJLyoKCVByb3BlcnR5OiBiaW5kV2l0aEV2ZW50CgkJYXV0b21hdGljYWxseSBwYXNzZXMgTW9vVG9vbHMgRXZlbnQgQ2xhc3MuCgoJQXJndW1lbnRzOgoJCWJpbmQgLSBvcHRpb25hbCwgdGhlIG9iamVjdCB0aGF0IHRoZSAidGhpcyIgb2YgdGhlIGZ1bmN0aW9uIHdpbGwgcmVmZXIgdG8uCgkJYXJncyAtIG9wdGlvbmFsLCBhbiBhcmd1bWVudCB0byBwYXNzIHRvIHRoZSBmdW5jdGlvbjsgaWYgbW9yZSB0aGFuIG9uZSBhcmd1bWVudCwgaXQgbXVzdCBiZSBhbiBhcnJheSBvZiBhcmd1bWVudHMuCgoJUmV0dXJuczoKCQlhIGZ1bmN0aW9uIHdpdGggdGhlIHBhcmFtZXRlciBiaW5kIGFzIGl0cyAidGhpcyIgYW5kIGFzIGEgcHJlLXBhc3NlZCBhcmd1bWVudCBldmVudCBvciB3aW5kb3cuZXZlbnQsIGRlcGVuZGluZyBvbiB0aGUgYnJvd3Nlci4KCglFeGFtcGxlOgoJCT5mdW5jdGlvbiBteUZ1bmN0aW9uKGV2ZW50KXsKCQk+CWFsZXJ0KGV2ZW50LmNsaWVudC54KSAvL3JldHVybnMgdGhlIGNvb3JkaW5hdGVzIG9mIHRoZSBtb3VzZS4uCgkJPn07CgkJPm15RWxlbWVudC5hZGRFdmVudCgnY2xpY2snLCBteUZ1bmN0aW9uLmJpbmRXaXRoRXZlbnQobXlFbGVtZW50KSk7CgkqLwoKCWJpbmRXaXRoRXZlbnQ6IGZ1bmN0aW9uKGJpbmQsIGFyZ3MpewoJCXJldHVybiB0aGlzLmNyZWF0ZSh7J2JpbmQnOiBiaW5kLCAnYXJndW1lbnRzJzogYXJncywgJ2V2ZW50JzogRXZlbnR9KTsKCX0KCn0pOwoKLyoKU2NyaXB0OiBFbGVtZW50LkZpbHRlcnMuanMKCWFkZCBGaWx0ZXJzIGNhcGFiaWxpdHkgdG8gPEVsZW1lbnRzPi4KCkxpY2Vuc2U6CglNSVQtc3R5bGUgbGljZW5zZS4KKi8KCi8qCkNsYXNzOiBFbGVtZW50cwoJQSBjb2xsZWN0aW9uIG9mIG1ldGhvZHMgdG8gYmUgdXNlZCB3aXRoIDwkJD4gZWxlbWVudHMgY29sbGVjdGlvbnMuCiovCgpFbGVtZW50cy5leHRlbmQoewoKCS8qCglQcm9wZXJ0eTogZmlsdGVyQnlUYWcKCQlGaWx0ZXJzIHRoZSBjb2xsZWN0aW9uIGJ5IGEgc3BlY2lmaWVkIHRhZyBuYW1lLgoJCVJldHVybnMgYSBuZXcgRWxlbWVudHMgY29sbGVjdGlvbiwgd2hpbGUgdGhlIG9yaWdpbmFsIHJlbWFpbnMgdW50b3VjaGVkLgoJKi8KCglmaWx0ZXJCeVRhZzogZnVuY3Rpb24odGFnKXsKCQlyZXR1cm4gbmV3IEVsZW1lbnRzKHRoaXMuZmlsdGVyKGZ1bmN0aW9uKGVsKXsKCQkJcmV0dXJuIChFbGVtZW50LmdldFRhZyhlbCkgPT0gdGFnKTsKCQl9KSk7Cgl9LAoKCS8qCglQcm9wZXJ0eTogZmlsdGVyQnlDbGFzcwoJCUZpbHRlcnMgdGhlIGNvbGxlY3Rpb24gYnkgYSBzcGVjaWZpZWQgY2xhc3MgbmFtZS4KCQlSZXR1cm5zIGEgbmV3IEVsZW1lbnRzIGNvbGxlY3Rpb24sIHdoaWxlIHRoZSBvcmlnaW5hbCByZW1haW5zIHVudG91Y2hlZC4KCSovCgoJZmlsdGVyQnlDbGFzczogZnVuY3Rpb24oY2xhc3NOYW1lLCBub2Nhc2gpewoJCXZhciBlbGVtZW50cyA9IHRoaXMuZmlsdGVyKGZ1bmN0aW9uKGVsKXsKCQkJcmV0dXJuIChlbC5jbGFzc05hbWUgJiYgZWwuY2xhc3NOYW1lLmNvbnRhaW5zKGNsYXNzTmFtZSwgJyAnKSk7CgkJfSk7CgkJcmV0dXJuIChub2Nhc2gpID8gZWxlbWVudHMgOiBuZXcgRWxlbWVudHMoZWxlbWVudHMpOwoJfSwKCgkvKgoJUHJvcGVydHk6IGZpbHRlckJ5SWQKCQlGaWx0ZXJzIHRoZSBjb2xsZWN0aW9uIGJ5IGEgc3BlY2lmaWVkIElELgoJCVJldHVybnMgYSBuZXcgRWxlbWVudHMgY29sbGVjdGlvbiwgd2hpbGUgdGhlIG9yaWdpbmFsIHJlbWFpbnMgdW50b3VjaGVkLgoJKi8KCglmaWx0ZXJCeUlkOiBmdW5jdGlvbihpZCwgbm9jYXNoKXsKCQl2YXIgZWxlbWVudHMgPSB0aGlzLmZpbHRlcihmdW5jdGlvbihlbCl7CgkJCXJldHVybiAoZWwuaWQgPT0gaWQpOwoJCX0pOwoJCXJldHVybiAobm9jYXNoKSA/IGVsZW1lbnRzIDogbmV3IEVsZW1lbnRzKGVsZW1lbnRzKTsKCX0sCgoJLyoKCVByb3BlcnR5OiBmaWx0ZXJCeUF0dHJpYnV0ZQoJCUZpbHRlcnMgdGhlIGNvbGxlY3Rpb24gYnkgYSBzcGVjaWZpZWQgYXR0cmlidXRlLgoJCVJldHVybnMgYSBuZXcgRWxlbWVudHMgY29sbGVjdGlvbiwgd2hpbGUgdGhlIG9yaWdpbmFsIHJlbWFpbnMgdW50b3VjaGVkLgoKCUFyZ3VtZW50czoKCQluYW1lIC0gdGhlIGF0dHJpYnV0ZSBuYW1lLgoJCW9wZXJhdG9yIC0gb3B0aW9uYWwsIHRoZSBhdHRyaWJ1dGUgb3BlcmF0b3IuCgkJdmFsdWUgLSBvcHRpb25hbCwgdGhlIGF0dHJpYnV0ZSB2YWx1ZSwgb25seSB2YWxpZCBpZiB0aGUgb3BlcmF0b3IgaXMgc3BlY2lmaWVkLgoJKi8KCglmaWx0ZXJCeUF0dHJpYnV0ZTogZnVuY3Rpb24obmFtZSwgb3BlcmF0b3IsIHZhbHVlLCBub2Nhc2gpewoJCXZhciBlbGVtZW50cyA9IHRoaXMuZmlsdGVyKGZ1bmN0aW9uKGVsKXsKCQkJdmFyIGN1cnJlbnQgPSBFbGVtZW50LmdldFByb3BlcnR5KGVsLCBuYW1lKTsKCQkJaWYgKCFjdXJyZW50KSByZXR1cm4gZmFsc2U7CgkJCWlmICghb3BlcmF0b3IpIHJldHVybiB0cnVlOwoJCQlzd2l0Y2gob3BlcmF0b3IpewoJCQkJY2FzZSAnPSc6IHJldHVybiAoY3VycmVudCA9PSB2YWx1ZSk7CgkJCQljYXNlICcqPSc6IHJldHVybiAoY3VycmVudC5jb250YWlucyh2YWx1ZSkpOwoJCQkJY2FzZSAnXj0nOiByZXR1cm4gKGN1cnJlbnQuc3Vic3RyKDAsIHZhbHVlLmxlbmd0aCkgPT0gdmFsdWUpOwoJCQkJY2FzZSAnJD0nOiByZXR1cm4gKGN1cnJlbnQuc3Vic3RyKGN1cnJlbnQubGVuZ3RoIC0gdmFsdWUubGVuZ3RoKSA9PSB2YWx1ZSk7CgkJCQljYXNlICchPSc6IHJldHVybiAoY3VycmVudCAhPSB2YWx1ZSk7CgkJCQljYXNlICd+PSc6IHJldHVybiBjdXJyZW50LmNvbnRhaW5zKHZhbHVlLCAnICcpOwoJCQl9CgkJCXJldHVybiBmYWxzZTsKCQl9KTsKCQlyZXR1cm4gKG5vY2FzaCkgPyBlbGVtZW50cyA6IG5ldyBFbGVtZW50cyhlbGVtZW50cyk7Cgl9Cgp9KTsKCi8qClNjcmlwdDogRWxlbWVudC5TZWxlY3RvcnMuanMKCUNzcyBRdWVyeSByZWxhdGVkIGZ1bmN0aW9ucyBhbmQgPEVsZW1lbnQ+IGV4dGVuc2lvbnMKCkxpY2Vuc2U6CglNSVQtc3R5bGUgbGljZW5zZS4KKi8KCi8qIFNlY3Rpb246IFV0aWxpdHkgRnVuY3Rpb25zICovCgovKgpGdW5jdGlvbjogJEUKCVNlbGVjdHMgYSBzaW5nbGUgKGkuZS4gdGhlIGZpcnN0IGZvdW5kKSBFbGVtZW50IGJhc2VkIG9uIHRoZSBzZWxlY3RvciBwYXNzZWQgaW4gYW5kIGFuIG9wdGlvbmFsIGZpbHRlciBlbGVtZW50LgoJUmV0dXJucyBhcyA8RWxlbWVudD4uCgpBcmd1bWVudHM6CglzZWxlY3RvciAtIHN0cmluZzsgdGhlIGNzcyBzZWxlY3RvciB0byBtYXRjaAoJZmlsdGVyIC0gb3B0aW9uYWw7IGEgRE9NIGVsZW1lbnQgdG8gbGltaXQgdGhlIHNjb3BlIG9mIHRoZSBzZWxlY3RvciBtYXRjaDsgZGVmYXVsdHMgdG8gZG9jdW1lbnQuCgpFeGFtcGxlOgoJPiRFKCdhJywgJ215RWxlbWVudCcpIC8vZmluZCB0aGUgZmlyc3QgYW5jaG9yIHRhZyBpbnNpZGUgdGhlIERPTSBlbGVtZW50IHdpdGggaWQgJ215RWxlbWVudCcKClJldHVybnM6CglhIERPTSBlbGVtZW50IC0gdGhlIGZpcnN0IGVsZW1lbnQgdGhhdCBtYXRjaGVzIHRoZSBzZWxlY3RvcgoqLwoKZnVuY3Rpb24gJEUoc2VsZWN0b3IsIGZpbHRlcil7CglyZXR1cm4gKCQoZmlsdGVyKSB8fCBkb2N1bWVudCkuZ2V0RWxlbWVudChzZWxlY3Rvcik7Cn07CgovKgpGdW5jdGlvbjogJEVTCglSZXR1cm5zIGEgY29sbGVjdGlvbiBvZiBFbGVtZW50cyB0aGF0IG1hdGNoIHRoZSBzZWxlY3RvciBwYXNzZWQgaW4gbGltaXRlZCB0byB0aGUgc2NvcGUgb2YgdGhlIG9wdGlvbmFsIGZpbHRlci4KCVNlZSBBbHNvOiA8RWxlbWVudC5nZXRFbGVtZW50cz4gZm9yIGFuIGFsdGVybmF0ZSBzeW50YXguCglSZXR1cm5zIGFzIDxFbGVtZW50cz4uCgpSZXR1cm5zOgoJYW4gYXJyYXkgb2YgZG9tIGVsZW1lbnRzIHRoYXQgbWF0Y2ggdGhlIHNlbGVjdG9yIHdpdGhpbiB0aGUgZmlsdGVyCgpBcmd1bWVudHM6CglzZWxlY3RvciAtIHN0cmluZzsgY3NzIHNlbGVjdG9yIHRvIG1hdGNoCglmaWx0ZXIgLSBvcHRpb25hbDsgYSBET00gZWxlbWVudCB0byBsaW1pdCB0aGUgc2NvcGUgb2YgdGhlIHNlbGVjdG9yIG1hdGNoOyBkZWZhdWx0cyB0byBkb2N1bWVudC4KCkV4YW1wbGVzOgoJPiRFUygiYSIpIC8vZ2V0cyBhbGwgdGhlIGFuY2hvciB0YWdzOyBzeW5vbnltb3VzIHdpdGggJCQoImEiKQoJPiRFUygnYScsJ215RWxlbWVudCcpIC8vZ2V0IGFsbCB0aGUgYW5jaG9yIHRhZ3Mgd2l0aGluICQoJ215RWxlbWVudCcpCiovCgpmdW5jdGlvbiAkRVMoc2VsZWN0b3IsIGZpbHRlcil7CglyZXR1cm4gKCQoZmlsdGVyKSB8fCBkb2N1bWVudCkuZ2V0RWxlbWVudHNCeVNlbGVjdG9yKHNlbGVjdG9yKTsKfTsKCiQkLnNoYXJlZCA9IHsKCgkncmVnZXhwJzogL14oXHcqfFwqKSg/OiMoW1x3LV0rKXxcLihbXHctXSspKT8oPzpcWyhcdyspKD86KFshKl4kXT89KVsiJ10/KFteIidcXV0qKVsiJ10/KT9dKT8kLywKCgkneHBhdGgnOiB7CgoJCWdldFBhcmFtOiBmdW5jdGlvbihpdGVtcywgY29udGV4dCwgcGFyYW0sIGkpewoJCQl2YXIgdGVtcCA9IFtjb250ZXh0Lm5hbWVzcGFjZVVSSSA/ICd4aHRtbDonIDogJycsIHBhcmFtWzFdXTsKCQkJaWYgKHBhcmFtWzJdKSB0ZW1wLnB1c2goJ1tAaWQ9IicsIHBhcmFtWzJdLCAnIl0nKTsKCQkJaWYgKHBhcmFtWzNdKSB0ZW1wLnB1c2goJ1tjb250YWlucyhjb25jYXQoIiAiLCBAY2xhc3MsICIgIiksICIgJywgcGFyYW1bM10sICcgIildJyk7CgkJCWlmIChwYXJhbVs0XSl7CgkJCQlpZiAocGFyYW1bNV0gJiYgcGFyYW1bNl0pewoJCQkJCXN3aXRjaChwYXJhbVs1XSl7CgkJCQkJCWNhc2UgJyo9JzogdGVtcC5wdXNoKCdbY29udGFpbnMoQCcsIHBhcmFtWzRdLCAnLCAiJywgcGFyYW1bNl0sICciKV0nKTsgYnJlYWs7CgkJCQkJCWNhc2UgJ149JzogdGVtcC5wdXNoKCdbc3RhcnRzLXdpdGgoQCcsIHBhcmFtWzRdLCAnLCAiJywgcGFyYW1bNl0sICciKV0nKTsgYnJlYWs7CgkJCQkJCWNhc2UgJyQ9JzogdGVtcC5wdXNoKCdbc3Vic3RyaW5nKEAnLCBwYXJhbVs0XSwgJywgc3RyaW5nLWxlbmd0aChAJywgcGFyYW1bNF0sICcpIC0gJywgcGFyYW1bNl0ubGVuZ3RoLCAnICsgMSkgPSAiJywgcGFyYW1bNl0sICciXScpOyBicmVhazsKCQkJCQkJY2FzZSAnPSc6IHRlbXAucHVzaCgnW0AnLCBwYXJhbVs0XSwgJz0iJywgcGFyYW1bNl0sICciXScpOyBicmVhazsKCQkJCQkJY2FzZSAnIT0nOiB0ZW1wLnB1c2goJ1tAJywgcGFyYW1bNF0sICchPSInLCBwYXJhbVs2XSwgJyJdJyk7CgkJCQkJfQoJCQkJfSBlbHNlIHsKCQkJCQl0ZW1wLnB1c2goJ1tAJywgcGFyYW1bNF0sICddJyk7CgkJCQl9CgkJCX0KCQkJaXRlbXMucHVzaCh0ZW1wLmpvaW4oJycpKTsKCQkJcmV0dXJuIGl0ZW1zOwoJCX0sCgoJCWdldEl0ZW1zOiBmdW5jdGlvbihpdGVtcywgY29udGV4dCwgbm9jYXNoKXsKCQkJdmFyIGVsZW1lbnRzID0gW107CgkJCXZhciB4cGF0aCA9IGRvY3VtZW50LmV2YWx1YXRlKCcuLy8nICsgaXRlbXMuam9pbignLy8nKSwgY29udGV4dCwgJCQuc2hhcmVkLnJlc29sdmVyLCBYUGF0aFJlc3VsdC5VTk9SREVSRURfTk9ERV9TTkFQU0hPVF9UWVBFLCBudWxsKTsKCQkJZm9yICh2YXIgaSA9IDAsIGogPSB4cGF0aC5zbmFwc2hvdExlbmd0aDsgaSA8IGo7IGkrKykgZWxlbWVudHMucHVzaCh4cGF0aC5zbmFwc2hvdEl0ZW0oaSkpOwoJCQlyZXR1cm4gKG5vY2FzaCkgPyBlbGVtZW50cyA6IG5ldyBFbGVtZW50cyhlbGVtZW50cy5tYXAoJCkpOwoJCX0KCgl9LAoKCSdub3JtYWwnOiB7CgoJCWdldFBhcmFtOiBmdW5jdGlvbihpdGVtcywgY29udGV4dCwgcGFyYW0sIGkpewoJCQlpZiAoaSA9PSAwKXsKCQkJCWlmIChwYXJhbVsyXSl7CgkJCQkJdmFyIGVsID0gY29udGV4dC5nZXRFbGVtZW50QnlJZChwYXJhbVsyXSk7CgkJCQkJaWYgKCFlbCB8fCAoKHBhcmFtWzFdICE9ICcqJykgJiYgKEVsZW1lbnQuZ2V0VGFnKGVsKSAhPSBwYXJhbVsxXSkpKSByZXR1cm4gZmFsc2U7CgkJCQkJaXRlbXMgPSBbZWxdOwoJCQkJfSBlbHNlIHsKCQkJCQlpdGVtcyA9ICRBKGNvbnRleHQuZ2V0RWxlbWVudHNCeVRhZ05hbWUocGFyYW1bMV0pKTsKCQkJCX0KCQkJfSBlbHNlIHsKCQkJCWl0ZW1zID0gJCQuc2hhcmVkLmdldEVsZW1lbnRzQnlUYWdOYW1lKGl0ZW1zLCBwYXJhbVsxXSk7CgkJCQlpZiAocGFyYW1bMl0pIGl0ZW1zID0gRWxlbWVudHMuZmlsdGVyQnlJZChpdGVtcywgcGFyYW1bMl0sIHRydWUpOwoJCQl9CgkJCWlmIChwYXJhbVszXSkgaXRlbXMgPSBFbGVtZW50cy5maWx0ZXJCeUNsYXNzKGl0ZW1zLCBwYXJhbVszXSwgdHJ1ZSk7CgkJCWlmIChwYXJhbVs0XSkgaXRlbXMgPSBFbGVtZW50cy5maWx0ZXJCeUF0dHJpYnV0ZShpdGVtcywgcGFyYW1bNF0sIHBhcmFtWzVdLCBwYXJhbVs2XSwgdHJ1ZSk7CgkJCXJldHVybiBpdGVtczsKCQl9LAoKCQlnZXRJdGVtczogZnVuY3Rpb24oaXRlbXMsIGNvbnRleHQsIG5vY2FzaCl7CgkJCXJldHVybiAobm9jYXNoKSA/IGl0ZW1zIDogJCQudW5pcXVlKGl0ZW1zKTsKCQl9CgoJfSwKCglyZXNvbHZlcjogZnVuY3Rpb24ocHJlZml4KXsKCQlyZXR1cm4gKHByZWZpeCA9PSAneGh0bWwnKSA/ICdodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hodG1sJyA6IGZhbHNlOwoJfSwKCglnZXRFbGVtZW50c0J5VGFnTmFtZTogZnVuY3Rpb24oY29udGV4dCwgdGFnTmFtZSl7CgkJdmFyIGZvdW5kID0gW107CgkJZm9yICh2YXIgaSA9IDAsIGogPSBjb250ZXh0Lmxlbmd0aDsgaSA8IGo7IGkrKykgZm91bmQuZXh0ZW5kKGNvbnRleHRbaV0uZ2V0RWxlbWVudHNCeVRhZ05hbWUodGFnTmFtZSkpOwoJCXJldHVybiBmb3VuZDsKCX0KCn07CgokJC5zaGFyZWQubWV0aG9kID0gKHdpbmRvdy54cGF0aCkgPyAneHBhdGgnIDogJ25vcm1hbCc7CgovKgpDbGFzczogRWxlbWVudAoJQ3VzdG9tIGNsYXNzIHRvIGFsbG93IGFsbCBvZiBpdHMgbWV0aG9kcyB0byBiZSB1c2VkIHdpdGggYW55IERPTSBlbGVtZW50IHZpYSB0aGUgZG9sbGFyIGZ1bmN0aW9uIDwkPi4KKi8KCkVsZW1lbnQuTWV0aG9kcy5Eb20gPSB7CgoJLyoKCVByb3BlcnR5OiBnZXRFbGVtZW50cwoJCUdldHMgYWxsIHRoZSBlbGVtZW50cyB3aXRoaW4gYW4gZWxlbWVudCB0aGF0IG1hdGNoIHRoZSBnaXZlbiAoc2luZ2xlKSBzZWxlY3Rvci4KCQlSZXR1cm5zIGFzIDxFbGVtZW50cz4uCgoJQXJndW1lbnRzOgoJCXNlbGVjdG9yIC0gc3RyaW5nOyB0aGUgY3NzIHNlbGVjdG9yIHRvIG1hdGNoCgoJRXhhbXBsZXM6CgkJPiQoJ215RWxlbWVudCcpLmdldEVsZW1lbnRzKCdhJyk7IC8vIGdldCBhbGwgYW5jaG9ycyB3aXRoaW4gbXlFbGVtZW50CgkJPiQoJ215RWxlbWVudCcpLmdldEVsZW1lbnRzKCdpbnB1dFtuYW1lPWRpYWxvZ10nKSAvL2dldCBhbGwgaW5wdXQgdGFncyB3aXRoIG5hbWUgJ2RpYWxvZycKCQk+JCgnbXlFbGVtZW50JykuZ2V0RWxlbWVudHMoJ2lucHV0W25hbWUkPWxvZ10nKSAvL2dldCBhbGwgaW5wdXQgdGFncyB3aXRoIG5hbWVzIGVuZGluZyB3aXRoICdsb2cnCgoJTm90ZXM6CgkJU3VwcG9ydHMgdGhlc2Ugb3BlcmF0b3JzIGluIGF0dHJpYnV0ZSBzZWxlY3RvcnM6CgoJCS0gPSA6IGlzIGVxdWFsIHRvCgkJLSBePSA6IHN0YXJ0cy13aXRoCgkJLSAkPSA6IGVuZHMtd2l0aAoJCS0gIT0gOiBpcyBub3QgZXF1YWwgdG8KCgkJWHBhdGggaXMgdXNlZCBhdXRvbWF0aWNhbGx5IGZvciBjb21wbGlhbnQgYnJvd3NlcnMuCgkqLwoKCWdldEVsZW1lbnRzOiBmdW5jdGlvbihzZWxlY3Rvciwgbm9jYXNoKXsKCQl2YXIgaXRlbXMgPSBbXTsKCQlzZWxlY3RvciA9IHNlbGVjdG9yLnRyaW0oKS5zcGxpdCgnICcpOwoJCWZvciAodmFyIGkgPSAwLCBqID0gc2VsZWN0b3IubGVuZ3RoOyBpIDwgajsgaSsrKXsKCQkJdmFyIHNlbCA9IHNlbGVjdG9yW2ldOwoJCQl2YXIgcGFyYW0gPSBzZWwubWF0Y2goJCQuc2hhcmVkLnJlZ2V4cCk7CgkJCWlmICghcGFyYW0pIGJyZWFrOwoJCQlwYXJhbVsxXSA9IHBhcmFtWzFdIHx8ICcqJzsKCQkJdmFyIHRlbXAgPSAkJC5zaGFyZWRbJCQuc2hhcmVkLm1ldGhvZF0uZ2V0UGFyYW0oaXRlbXMsIHRoaXMsIHBhcmFtLCBpKTsKCQkJaWYgKCF0ZW1wKSBicmVhazsKCQkJaXRlbXMgPSB0ZW1wOwoJCX0KCQlyZXR1cm4gJCQuc2hhcmVkWyQkLnNoYXJlZC5tZXRob2RdLmdldEl0ZW1zKGl0ZW1zLCB0aGlzLCBub2Nhc2gpOwoJfSwKCgkvKgoJUHJvcGVydHk6IGdldEVsZW1lbnQKCQlTYW1lIGFzIDxFbGVtZW50LmdldEVsZW1lbnRzPiwgYnV0IHJldHVybnMgb25seSB0aGUgZmlyc3QuIEFsdGVybmF0ZSBzeW50YXggZm9yIDwkRT4sIHdoZXJlIGZpbHRlciBpcyB0aGUgRWxlbWVudC4KCQlSZXR1cm5zIGFzIDxFbGVtZW50Pi4KCglBcmd1bWVudHM6CgkJc2VsZWN0b3IgLSBzdHJpbmc7IGNzcyBzZWxlY3RvcgoJKi8KCglnZXRFbGVtZW50OiBmdW5jdGlvbihzZWxlY3Rvcil7CgkJcmV0dXJuICQodGhpcy5nZXRFbGVtZW50cyhzZWxlY3RvciwgdHJ1ZSlbMF0gfHwgZmFsc2UpOwoJfSwKCgkvKgoJUHJvcGVydHk6IGdldEVsZW1lbnRzQnlTZWxlY3RvcgoJCVNhbWUgYXMgPEVsZW1lbnQuZ2V0RWxlbWVudHM+LCBidXQgYWxsb3dzIGZvciBjb21tYSBzZXBhcmF0ZWQgc2VsZWN0b3JzLCBhcyBpbiBjc3MuIEFsdGVybmF0ZSBzeW50YXggZm9yIDwkJD4sIHdoZXJlIGZpbHRlciBpcyB0aGUgRWxlbWVudC4KCQlSZXR1cm5zIGFzIDxFbGVtZW50cz4uCgoJQXJndW1lbnRzOgoJCXNlbGVjdG9yIC0gc3RyaW5nOyBjc3Mgc2VsZWN0b3IKCSovCgoJZ2V0RWxlbWVudHNCeVNlbGVjdG9yOiBmdW5jdGlvbihzZWxlY3Rvciwgbm9jYXNoKXsKCQl2YXIgZWxlbWVudHMgPSBbXTsKCQlzZWxlY3RvciA9IHNlbGVjdG9yLnNwbGl0KCcsJyk7CgkJZm9yICh2YXIgaSA9IDAsIGogPSBzZWxlY3Rvci5sZW5ndGg7IGkgPCBqOyBpKyspIGVsZW1lbnRzID0gZWxlbWVudHMuY29uY2F0KHRoaXMuZ2V0RWxlbWVudHMoc2VsZWN0b3JbaV0sIHRydWUpKTsKCQlyZXR1cm4gKG5vY2FzaCkgPyBlbGVtZW50cyA6ICQkLnVuaXF1ZShlbGVtZW50cyk7Cgl9Cgp9OwoKRWxlbWVudC5leHRlbmQoewoKCS8qCglQcm9wZXJ0eTogZ2V0RWxlbWVudEJ5SWQKCQlUYXJnZXRzIGFuIGVsZW1lbnQgd2l0aCB0aGUgc3BlY2lmaWVkIGlkIGZvdW5kIGluc2lkZSB0aGUgRWxlbWVudC4gRG9lcyBub3Qgb3ZlcndyaXRlIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkLgoKCUFyZ3VtZW50czoKCQlpZCAtIHN0cmluZzsgdGhlIGlkIG9mIHRoZSBlbGVtZW50IHRvIGZpbmQuCgkqLwoKCWdldEVsZW1lbnRCeUlkOiBmdW5jdGlvbihpZCl7CgkJdmFyIGVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoaWQpOwoJCWlmICghZWwpIHJldHVybiBmYWxzZTsKCQlmb3IgKHZhciBwYXJlbnQgPSBlbC5wYXJlbnROb2RlOyBwYXJlbnQgIT0gdGhpczsgcGFyZW50ID0gcGFyZW50LnBhcmVudE5vZGUpewoJCQlpZiAoIXBhcmVudCkgcmV0dXJuIGZhbHNlOwoJCX0KCQlyZXR1cm4gZWw7Cgl9Lypjb21wYXRpYmlsaXR5Ki8sCgoJZ2V0RWxlbWVudHNCeUNsYXNzTmFtZTogZnVuY3Rpb24oY2xhc3NOYW1lKXsKCQlyZXR1cm4gdGhpcy5nZXRFbGVtZW50cygnLicgKyBjbGFzc05hbWUpOwoJfQoKCS8qZW5kIGNvbXBhdGliaWxpdHkqLwoKfSk7Cgpkb2N1bWVudC5leHRlbmQoRWxlbWVudC5NZXRob2RzLkRvbSk7CkVsZW1lbnQuZXh0ZW5kKEVsZW1lbnQuTWV0aG9kcy5Eb20pOwoKLyoKU2NyaXB0OiBFbGVtZW50LkZvcm0uanMKCUNvbnRhaW5zIEVsZW1lbnQgcHJvdG90eXBlcyB0byBkZWFsIHdpdGggRm9ybXMgYW5kIHRoZWlyIGVsZW1lbnRzLgoKTGljZW5zZToKCU1JVC1zdHlsZSBsaWNlbnNlLgoqLwoKLyoKQ2xhc3M6IEVsZW1lbnQKCUN1c3RvbSBjbGFzcyB0byBhbGxvdyBhbGwgb2YgaXRzIG1ldGhvZHMgdG8gYmUgdXNlZCB3aXRoIGFueSBET00gZWxlbWVudCB2aWEgdGhlIGRvbGxhciBmdW5jdGlvbiA8JD4uCiovCgpFbGVtZW50LmV4dGVuZCh7CgoJLyoKCVByb3BlcnR5OiBnZXRWYWx1ZQoJCVJldHVybnMgdGhlIHZhbHVlIG9mIHRoZSBFbGVtZW50LCBpZiBpdHMgdGFnIGlzIHRleHRhcmVhLCBzZWxlY3Qgb3IgaW5wdXQuIGdldFZhbHVlIGNhbGxlZCBvbiBhIG11bHRpcGxlIHNlbGVjdCB3aWxsIHJldHVybiBhbiBhcnJheS4KCSovCgoJZ2V0VmFsdWU6IGZ1bmN0aW9uKCl7CgkJc3dpdGNoKHRoaXMuZ2V0VGFnKCkpewoJCQljYXNlICdzZWxlY3QnOgoJCQkJdmFyIHZhbHVlcyA9IFtdOwoJCQkJJGVhY2godGhpcy5vcHRpb25zLCBmdW5jdGlvbihvcHRpb24pewoJCQkJCWlmIChvcHRpb24uc2VsZWN0ZWQpIHZhbHVlcy5wdXNoKCRwaWNrKG9wdGlvbi52YWx1ZSwgb3B0aW9uLnRleHQpKTsKCQkJCX0pOwoJCQkJcmV0dXJuICh0aGlzLm11bHRpcGxlKSA/IHZhbHVlcyA6IHZhbHVlc1swXTsKCQkJY2FzZSAnaW5wdXQnOiBpZiAoISh0aGlzLmNoZWNrZWQgJiYgWydjaGVja2JveCcsICdyYWRpbyddLmNvbnRhaW5zKHRoaXMudHlwZSkpICYmICFbJ2hpZGRlbicsICd0ZXh0JywgJ3Bhc3N3b3JkJ10uY29udGFpbnModGhpcy50eXBlKSkgYnJlYWs7CgkJCWNhc2UgJ3RleHRhcmVhJzogcmV0dXJuIHRoaXMudmFsdWU7CgkJfQoJCXJldHVybiBmYWxzZTsKCX0sCgoJZ2V0Rm9ybUVsZW1lbnRzOiBmdW5jdGlvbigpewoJCXJldHVybiAkJCh0aGlzLmdldEVsZW1lbnRzQnlUYWdOYW1lKCdpbnB1dCcpLCB0aGlzLmdldEVsZW1lbnRzQnlUYWdOYW1lKCdzZWxlY3QnKSwgdGhpcy5nZXRFbGVtZW50c0J5VGFnTmFtZSgndGV4dGFyZWEnKSk7Cgl9LAoKCS8qCglQcm9wZXJ0eTogdG9RdWVyeVN0cmluZwoJCVJlYWRzIHRoZSBjaGlsZHJlbiBpbnB1dHMgb2YgdGhlIEVsZW1lbnQgYW5kIGdlbmVyYXRlcyBhIHF1ZXJ5IHN0cmluZywgYmFzZWQgb24gdGhlaXIgdmFsdWVzLiBVc2VkIGludGVybmFsbHkgaW4gPEFqYXg+CgoJRXhhbXBsZToKCQkoc3RhcnQgY29kZSkKCQk8Zm9ybSBpZD0ibXlGb3JtIiBhY3Rpb249InN1Ym1pdC5waHAiPgoJCTxpbnB1dCBuYW1lPSJlbWFpbCIgdmFsdWU9ImJvYkBib2IuY29tIj4KCQk8aW5wdXQgbmFtZT0iemlwQ29kZSIgdmFsdWU9IjkwMjEwIj4KCQk8L2Zvcm0+CgoJCTxzY3JpcHQ+CgkJICQoJ215Rm9ybScpLnRvUXVlcnlTdHJpbmcoKQoJCTwvc2NyaXB0PgoJCShlbmQpCgoJCVJldHVybnM6CgkJCWVtYWlsPWJvYkBib2IuY29tJnppcENvZGU9OTAyMTAKCSovCgoJdG9RdWVyeVN0cmluZzogZnVuY3Rpb24oKXsKCQl2YXIgcXVlcnlTdHJpbmcgPSBbXTsKCQl0aGlzLmdldEZvcm1FbGVtZW50cygpLmVhY2goZnVuY3Rpb24oZWwpewoJCQl2YXIgbmFtZSA9IGVsLm5hbWU7CgkJCXZhciB2YWx1ZSA9IGVsLmdldFZhbHVlKCk7CgkJCWlmICh2YWx1ZSA9PT0gZmFsc2UgfHwgIW5hbWUgfHwgZWwuZGlzYWJsZWQpIHJldHVybjsKCQkJdmFyIHFzID0gZnVuY3Rpb24odmFsKXsKCQkJCXF1ZXJ5U3RyaW5nLnB1c2gobmFtZSArICc9JyArIGVuY29kZVVSSUNvbXBvbmVudCh2YWwpKTsKCQkJfTsKCQkJaWYgKCR0eXBlKHZhbHVlKSA9PSAnYXJyYXknKSB2YWx1ZS5lYWNoKHFzKTsKCQkJZWxzZSBxcyh2YWx1ZSk7CgkJfSk7CgkJcmV0dXJuIHF1ZXJ5U3RyaW5nLmpvaW4oJyYnKTsKCX0KCn0pOwoKLyoKU2NyaXB0OiBFbGVtZW50LkRpbWVuc2lvbnMuanMKCUNvbnRhaW5zIEVsZW1lbnQgcHJvdG90eXBlcyB0byBkZWFsIHdpdGggRWxlbWVudCBzaXplIGFuZCBwb3NpdGlvbiBpbiBzcGFjZS4KCk5vdGU6CglUaGUgZnVuY3Rpb25zIGluIHRoaXMgc2NyaXB0IHJlcXVpcmUgbiBYSFRNTCBkb2N0eXBlLgoKTGljZW5zZToKCU1JVC1zdHlsZSBsaWNlbnNlLgoqLwoKLyoKQ2xhc3M6IEVsZW1lbnQKCUN1c3RvbSBjbGFzcyB0byBhbGxvdyBhbGwgb2YgaXRzIG1ldGhvZHMgdG8gYmUgdXNlZCB3aXRoIGFueSBET00gZWxlbWVudCB2aWEgdGhlIGRvbGxhciBmdW5jdGlvbiA8JD4uCiovCgpFbGVtZW50LmV4dGVuZCh7CgoJLyoKCVByb3BlcnR5OiBzY3JvbGxUbwoJCVNjcm9sbHMgdGhlIGVsZW1lbnQgdG8gdGhlIHNwZWNpZmllZCBjb29yZGluYXRlZCAoaWYgdGhlIGVsZW1lbnQgaGFzIGFuIG92ZXJmbG93KQoKCUFyZ3VtZW50czoKCQl4IC0gdGhlIHggY29vcmRpbmF0ZQoJCXkgLSB0aGUgeSBjb29yZGluYXRlCgoJRXhhbXBsZToKCQk+JCgnbXlFbGVtZW50Jykuc2Nyb2xsVG8oMCwgMTAwKQoJKi8KCglzY3JvbGxUbzogZnVuY3Rpb24oeCwgeSl7CgkJdGhpcy5zY3JvbGxMZWZ0ID0geDsKCQl0aGlzLnNjcm9sbFRvcCA9IHk7Cgl9LAoKCS8qCglQcm9wZXJ0eTogZ2V0U2l6ZQoJCVJldHVybiBhbiBPYmplY3QgcmVwcmVzZW50aW5nIHRoZSBzaXplL3Njcm9sbCB2YWx1ZXMgb2YgdGhlIGVsZW1lbnQuCgoJRXhhbXBsZToKCQkoc3RhcnQgY29kZSkKCQkkKCdteUVsZW1lbnQnKS5nZXRTaXplKCk7CgkJKGVuZCkKCglSZXR1cm5zOgoJCShzdGFydCBjb2RlKQoJCXsKCQkJJ3Njcm9sbCc6IHsneCc6IDEwMCwgJ3knOiAxMDB9LAoJCQknc2l6ZSc6IHsneCc6IDIwMCwgJ3knOiA0MDB9LAoJCQknc2Nyb2xsU2l6ZSc6IHsneCc6IDMwMCwgJ3knOiA1MDB9CgkJfQoJCShlbmQpCgkqLwoKCWdldFNpemU6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHsKCQkJJ3Njcm9sbCc6IHsneCc6IHRoaXMuc2Nyb2xsTGVmdCwgJ3knOiB0aGlzLnNjcm9sbFRvcH0sCgkJCSdzaXplJzogeyd4JzogdGhpcy5vZmZzZXRXaWR0aCwgJ3knOiB0aGlzLm9mZnNldEhlaWdodH0sCgkJCSdzY3JvbGxTaXplJzogeyd4JzogdGhpcy5zY3JvbGxXaWR0aCwgJ3knOiB0aGlzLnNjcm9sbEhlaWdodH0KCQl9OwoJfSwKCgkvKgoJUHJvcGVydHk6IGdldFBvc2l0aW9uCgkJUmV0dXJucyB0aGUgcmVhbCBvZmZzZXRzIG9mIHRoZSBlbGVtZW50LgoKCUFyZ3VtZW50czoKCQlvdmVyZmxvd24gLSBvcHRpb25hbCwgYW4gYXJyYXkgb2YgbmVzdGVkIHNjcm9sbGluZyBjb250YWluZXJzIGZvciBzY3JvbGwgb2Zmc2V0IGNhbGN1bGF0aW9uLCB1c2UgdGhpcyBpZiB5b3VyIGVsZW1lbnQgaXMgaW5zaWRlIGFueSBlbGVtZW50IGNvbnRhaW5pbmcgc2Nyb2xsYmFycwoKCUV4YW1wbGU6CgkJPiQoJ2VsZW1lbnQnKS5nZXRQb3NpdGlvbigpOwoKCVJldHVybnM6CgkJPnt4OiAxMDAsIHk6NTAwfTsKCSovCgoJZ2V0UG9zaXRpb246IGZ1bmN0aW9uKG92ZXJmbG93bil7CgkJb3ZlcmZsb3duID0gb3ZlcmZsb3duIHx8IFtdOwoJCXZhciBlbCA9IHRoaXMsIGxlZnQgPSAwLCB0b3AgPSAwOwoJCWRvIHsKCQkJbGVmdCArPSBlbC5vZmZzZXRMZWZ0IHx8IDA7CgkJCXRvcCArPSBlbC5vZmZzZXRUb3AgfHwgMDsKCQkJZWwgPSBlbC5vZmZzZXRQYXJlbnQ7CgkJfSB3aGlsZSAoZWwpOwoJCW92ZXJmbG93bi5lYWNoKGZ1bmN0aW9uKGVsZW1lbnQpewoJCQlsZWZ0IC09IGVsZW1lbnQuc2Nyb2xsTGVmdCB8fCAwOwoJCQl0b3AgLT0gZWxlbWVudC5zY3JvbGxUb3AgfHwgMDsKCQl9KTsKCQlyZXR1cm4geyd4JzogbGVmdCwgJ3knOiB0b3B9OwoJfSwKCgkvKgoJUHJvcGVydHk6IGdldFRvcAoJCVJldHVybnMgdGhlIGRpc3RhbmNlIGZyb20gdGhlIHRvcCBvZiB0aGUgd2luZG93IHRvIHRoZSBFbGVtZW50LgoKCUFyZ3VtZW50czoKCQlvdmVyZmxvd24gLSBvcHRpb25hbCwgYW4gYXJyYXkgb2YgbmVzdGVkIHNjcm9sbGluZyBjb250YWluZXJzLCBzZWUgRWxlbWVudDo6Z2V0UG9zaXRpb24KCSovCgoJZ2V0VG9wOiBmdW5jdGlvbihvdmVyZmxvd24pewoJCXJldHVybiB0aGlzLmdldFBvc2l0aW9uKG92ZXJmbG93bikueTsKCX0sCgoJLyoKCVByb3BlcnR5OiBnZXRMZWZ0CgkJUmV0dXJucyB0aGUgZGlzdGFuY2UgZnJvbSB0aGUgbGVmdCBvZiB0aGUgd2luZG93IHRvIHRoZSBFbGVtZW50LgoKCUFyZ3VtZW50czoKCQlvdmVyZmxvd24gLSBvcHRpb25hbCwgYW4gYXJyYXkgb2YgbmVzdGVkIHNjcm9sbGluZyBjb250YWluZXJzLCBzZWUgRWxlbWVudDo6Z2V0UG9zaXRpb24KCSovCgoJZ2V0TGVmdDogZnVuY3Rpb24ob3ZlcmZsb3duKXsKCQlyZXR1cm4gdGhpcy5nZXRQb3NpdGlvbihvdmVyZmxvd24pLng7Cgl9LAoKCS8qCglQcm9wZXJ0eTogZ2V0Q29vcmRpbmF0ZXMKCQlSZXR1cm5zIGFuIG9iamVjdCB3aXRoIHdpZHRoLCBoZWlnaHQsIGxlZnQsIHJpZ2h0LCB0b3AsIGFuZCBib3R0b20sIHJlcHJlc2VudGluZyB0aGUgdmFsdWVzIG9mIHRoZSBFbGVtZW50CgoJQXJndW1lbnRzOgoJCW92ZXJmbG93biAtIG9wdGlvbmFsLCBhbiBhcnJheSBvZiBuZXN0ZWQgc2Nyb2xsaW5nIGNvbnRhaW5lcnMsIHNlZSBFbGVtZW50OjpnZXRQb3NpdGlvbgoKCUV4YW1wbGU6CgkJKHN0YXJ0IGNvZGUpCgkJdmFyIG15VmFsdWVzID0gJCgnbXlFbGVtZW50JykuZ2V0Q29vcmRpbmF0ZXMoKTsKCQkoZW5kKQoKCVJldHVybnM6CgkJKHN0YXJ0IGNvZGUpCgkJewoJCQl3aWR0aDogMjAwLAoJCQloZWlnaHQ6IDMwMCwKCQkJbGVmdDogMTAwLAoJCQl0b3A6IDUwLAoJCQlyaWdodDogMzAwLAoJCQlib3R0b206IDM1MAoJCX0KCQkoZW5kKQoJKi8KCglnZXRDb29yZGluYXRlczogZnVuY3Rpb24ob3ZlcmZsb3duKXsKCQl2YXIgcG9zaXRpb24gPSB0aGlzLmdldFBvc2l0aW9uKG92ZXJmbG93bik7CgkJdmFyIG9iaiA9IHsKCQkJJ3dpZHRoJzogdGhpcy5vZmZzZXRXaWR0aCwKCQkJJ2hlaWdodCc6IHRoaXMub2Zmc2V0SGVpZ2h0LAoJCQknbGVmdCc6IHBvc2l0aW9uLngsCgkJCSd0b3AnOiBwb3NpdGlvbi55CgkJfTsKCQlvYmoucmlnaHQgPSBvYmoubGVmdCArIG9iai53aWR0aDsKCQlvYmouYm90dG9tID0gb2JqLnRvcCArIG9iai5oZWlnaHQ7CgkJcmV0dXJuIG9iajsKCX0KCn0pOwoKLyoKU2NyaXB0OiBXaW5kb3cuRG9tUmVhZHkuanMKCUNvbnRhaW5zIHRoZSBjdXN0b20gZXZlbnQgZG9tcmVhZHksIGZvciB3aW5kb3cuCgpMaWNlbnNlOgoJTUlULXN0eWxlIGxpY2Vuc2UuCiovCgovKiBTZWN0aW9uOiBDdXN0b20gRXZlbnRzICovCgovKgpFdmVudDogZG9tcmVhZHkKCWV4ZWN1dGVzIGEgZnVuY3Rpb24gd2hlbiB0aGUgZG9tIHRyZWUgaXMgbG9hZGVkLCB3aXRob3V0IHdhaXRpbmcgZm9yIGltYWdlcy4gT25seSB3b3JrcyB3aGVuIGNhbGxlZCBmcm9tIHdpbmRvdy4KCkNyZWRpdHM6CgkoYykgRGVhbiBFZHdhcmRzL01hdHRoaWFzIE1pbGxlci9Kb2huIFJlc2lnLCByZW1hc3RlcmVkIGZvciBNb29Ub29scy4KCkFyZ3VtZW50czoKCWZuIC0gdGhlIGZ1bmN0aW9uIHRvIGV4ZWN1dGUgd2hlbiB0aGUgRE9NIGlzIHJlYWR5CgpFeGFtcGxlOgoJPiB3aW5kb3cuYWRkRXZlbnQoJ2RvbXJlYWR5JywgZnVuY3Rpb24oKXsKCT4JYWxlcnQoJ3RoZSBkb20gaXMgcmVhZHknKTsKCT4gfSk7CiovCgpFbGVtZW50LkV2ZW50cy5kb21yZWFkeSA9IHsKCglhZGQ6IGZ1bmN0aW9uKGZuKXsKCQlpZiAod2luZG93LmxvYWRlZCl7CgkJCWZuLmNhbGwodGhpcyk7CgkJCXJldHVybjsKCQl9CgkJdmFyIGRvbVJlYWR5ID0gZnVuY3Rpb24oKXsKCQkJaWYgKHdpbmRvdy5sb2FkZWQpIHJldHVybjsKCQkJd2luZG93LmxvYWRlZCA9IHRydWU7CgkJCXdpbmRvdy50aW1lciA9ICRjbGVhcih3aW5kb3cudGltZXIpOwoJCQl0aGlzLmZpcmVFdmVudCgnZG9tcmVhZHknKTsKCQl9LmJpbmQodGhpcyk7CgkJaWYgKGRvY3VtZW50LnJlYWR5U3RhdGUgJiYgd2luZG93LndlYmtpdCl7CgkJCXdpbmRvdy50aW1lciA9IGZ1bmN0aW9uKCl7CgkJCQlpZiAoWydsb2FkZWQnLCdjb21wbGV0ZSddLmNvbnRhaW5zKGRvY3VtZW50LnJlYWR5U3RhdGUpKSBkb21SZWFkeSgpOwoJCQl9LnBlcmlvZGljYWwoNTApOwoJCX0gZWxzZSBpZiAoZG9jdW1lbnQucmVhZHlTdGF0ZSAmJiB3aW5kb3cuaWUpewoJCQlpZiAoISQoJ2llX3JlYWR5JykpewoJCQkJdmFyIHNyYyA9ICh3aW5kb3cubG9jYXRpb24ucHJvdG9jb2wgPT0gJ2h0dHBzOicpID8gJzovLzAnIDogJ2phdmFzY3JpcHQ6dm9pZCgwKSc7CgkJCQlkb2N1bWVudC53cml0ZSgnPHNjcmlwdCBpZD0iaWVfcmVhZHkiIGRlZmVyIHNyYz0iJyArIHNyYyArICciPjxcL3NjcmlwdD4nKTsKCQkJCSQoJ2llX3JlYWR5Jykub25yZWFkeXN0YXRlY2hhbmdlID0gZnVuY3Rpb24oKXsKCQkJCQlpZiAodGhpcy5yZWFkeVN0YXRlID09ICdjb21wbGV0ZScpIGRvbVJlYWR5KCk7CgkJCQl9OwoJCQl9CgkJfSBlbHNlIHsKCQkJd2luZG93LmFkZExpc3RlbmVyKCJsb2FkIiwgZG9tUmVhZHkpOwoJCQlkb2N1bWVudC5hZGRMaXN0ZW5lcigiRE9NQ29udGVudExvYWRlZCIsIGRvbVJlYWR5KTsKCQl9Cgl9Cgp9OwoKLypjb21wYXRpYmlsaXR5Ki8KCndpbmRvdy5vbkRvbVJlYWR5ID0gZnVuY3Rpb24oZm4pewoJcmV0dXJuIHRoaXMuYWRkRXZlbnQoJ2RvbXJlYWR5JywgZm4pOwp9OwoKLyplbmQgY29tcGF0aWJpbGl0eSovCgovKgpTY3JpcHQ6IFdpbmRvdy5TaXplLmpzCglXaW5kb3cgY3Jvc3MtYnJvd3NlciBkaW1lbnNpb25zIG1ldGhvZHMuCgpOb3RlOgoJVGhlIEZ1bmN0aW9ucyBpbiB0aGlzIHNjcmlwdCByZXF1aXJlIGFuIFhIVE1MIGRvY3R5cGUuCgpMaWNlbnNlOgoJTUlULXN0eWxlIGxpY2Vuc2UuCiovCgovKgpDbGFzczogd2luZG93CglDcm9zcyBicm93c2VyIG1ldGhvZHMgdG8gZ2V0IHZhcmlvdXMgd2luZG93IGRpbWVuc2lvbnMuCglXYXJuaW5nOiBBbGwgdGhlc2UgbWV0aG9kcyByZXF1aXJlIHRoYXQgdGhlIGJyb3dzZXIgb3BlcmF0ZXMgaW4gc3RyaWN0IG1vZGUsIG5vdCBxdWlya3MgbW9kZS4KKi8KCndpbmRvdy5leHRlbmQoewoKCS8qCglQcm9wZXJ0eTogZ2V0V2lkdGgKCQlSZXR1cm5zIGFuIGludGVnZXIgcmVwcmVzZW50aW5nIHRoZSB3aWR0aCBvZiB0aGUgYnJvd3NlciB3aW5kb3cgKHdpdGhvdXQgdGhlIHNjcm9sbGJhcikuCgkqLwoKCWdldFdpZHRoOiBmdW5jdGlvbigpewoJCWlmICh0aGlzLndlYmtpdDQxOSkgcmV0dXJuIHRoaXMuaW5uZXJXaWR0aDsKCQlpZiAodGhpcy5vcGVyYSkgcmV0dXJuIGRvY3VtZW50LmJvZHkuY2xpZW50V2lkdGg7CgkJcmV0dXJuIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5jbGllbnRXaWR0aDsKCX0sCgoJLyoKCVByb3BlcnR5OiBnZXRIZWlnaHQKCQlSZXR1cm5zIGFuIGludGVnZXIgcmVwcmVzZW50aW5nIHRoZSBoZWlnaHQgb2YgdGhlIGJyb3dzZXIgd2luZG93ICh3aXRob3V0IHRoZSBzY3JvbGxiYXIpLgoJKi8KCglnZXRIZWlnaHQ6IGZ1bmN0aW9uKCl7CgkJaWYgKHRoaXMud2Via2l0NDE5KSByZXR1cm4gdGhpcy5pbm5lckhlaWdodDsKCQlpZiAodGhpcy5vcGVyYSkgcmV0dXJuIGRvY3VtZW50LmJvZHkuY2xpZW50SGVpZ2h0OwoJCXJldHVybiBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuY2xpZW50SGVpZ2h0OwoJfSwKCgkvKgoJUHJvcGVydHk6IGdldFNjcm9sbFdpZHRoCgkJUmV0dXJucyBhbiBpbnRlZ2VyIHJlcHJlc2VudGluZyB0aGUgc2Nyb2xsV2lkdGggb2YgdGhlIHdpbmRvdy4KCQlUaGlzIHZhbHVlIGlzIGVxdWFsIHRvIG9yIGJpZ2dlciB0aGFuIDxnZXRXaWR0aD4uCgoJU2VlIEFsc286CgkJPGh0dHA6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4vZG9jcy9ET006ZWxlbWVudC5zY3JvbGxXaWR0aD4KCSovCgoJZ2V0U2Nyb2xsV2lkdGg6IGZ1bmN0aW9uKCl7CgkJaWYgKHRoaXMuaWUpIHJldHVybiBNYXRoLm1heChkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQub2Zmc2V0V2lkdGgsIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5zY3JvbGxXaWR0aCk7CgkJaWYgKHRoaXMud2Via2l0KSByZXR1cm4gZG9jdW1lbnQuYm9keS5zY3JvbGxXaWR0aDsKCQlyZXR1cm4gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LnNjcm9sbFdpZHRoOwoJfSwKCgkvKgoJUHJvcGVydHk6IGdldFNjcm9sbEhlaWdodAoJCVJldHVybnMgYW4gaW50ZWdlciByZXByZXNlbnRpbmcgdGhlIHNjcm9sbEhlaWdodCBvZiB0aGUgd2luZG93LgoJCVRoaXMgdmFsdWUgaXMgZXF1YWwgdG8gb3IgYmlnZ2VyIHRoYW4gPGdldEhlaWdodD4uCgoJU2VlIEFsc286CgkJPGh0dHA6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4vZG9jcy9ET006ZWxlbWVudC5zY3JvbGxIZWlnaHQ+CgkqLwoKCWdldFNjcm9sbEhlaWdodDogZnVuY3Rpb24oKXsKCQlpZiAodGhpcy5pZSkgcmV0dXJuIE1hdGgubWF4KGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5vZmZzZXRIZWlnaHQsIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5zY3JvbGxIZWlnaHQpOwoJCWlmICh0aGlzLndlYmtpdCkgcmV0dXJuIGRvY3VtZW50LmJvZHkuc2Nyb2xsSGVpZ2h0OwoJCXJldHVybiBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuc2Nyb2xsSGVpZ2h0OwoJfSwKCgkvKgoJUHJvcGVydHk6IGdldFNjcm9sbExlZnQKCQlSZXR1cm5zIGFuIGludGVnZXIgcmVwcmVzZW50aW5nIHRoZSBzY3JvbGxMZWZ0IG9mIHRoZSB3aW5kb3cgKHRoZSBudW1iZXIgb2YgcGl4ZWxzIHRoZSB3aW5kb3cgaGFzIHNjcm9sbGVkIGZyb20gdGhlIGxlZnQpLgoKCVNlZSBBbHNvOgoJCTxodHRwOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuL2RvY3MvRE9NOmVsZW1lbnQuc2Nyb2xsTGVmdD4KCSovCgoJZ2V0U2Nyb2xsTGVmdDogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5wYWdlWE9mZnNldCB8fCBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuc2Nyb2xsTGVmdDsKCX0sCgoJLyoKCVByb3BlcnR5OiBnZXRTY3JvbGxUb3AKCQlSZXR1cm5zIGFuIGludGVnZXIgcmVwcmVzZW50aW5nIHRoZSBzY3JvbGxUb3Agb2YgdGhlIHdpbmRvdyAodGhlIG51bWJlciBvZiBwaXhlbHMgdGhlIHdpbmRvdyBoYXMgc2Nyb2xsZWQgZnJvbSB0aGUgdG9wKS4KCglTZWUgQWxzbzoKCQk8aHR0cDovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi9kb2NzL0RPTTplbGVtZW50LnNjcm9sbFRvcD4KCSovCgoJZ2V0U2Nyb2xsVG9wOiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLnBhZ2VZT2Zmc2V0IHx8IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5zY3JvbGxUb3A7Cgl9LAoKCS8qCglQcm9wZXJ0eTogZ2V0U2l6ZQoJCVNhbWUgYXMgPEVsZW1lbnQuZ2V0U2l6ZT4KCSovCgoJZ2V0U2l6ZTogZnVuY3Rpb24oKXsKCQlyZXR1cm4gewoJCQknc2l6ZSc6IHsneCc6IHRoaXMuZ2V0V2lkdGgoKSwgJ3knOiB0aGlzLmdldEhlaWdodCgpfSwKCQkJJ3Njcm9sbFNpemUnOiB7J3gnOiB0aGlzLmdldFNjcm9sbFdpZHRoKCksICd5JzogdGhpcy5nZXRTY3JvbGxIZWlnaHQoKX0sCgkJCSdzY3JvbGwnOiB7J3gnOiB0aGlzLmdldFNjcm9sbExlZnQoKSwgJ3knOiB0aGlzLmdldFNjcm9sbFRvcCgpfQoJCX07Cgl9LAoKCS8vaWdub3JlCglnZXRQb3NpdGlvbjogZnVuY3Rpb24oKXtyZXR1cm4geyd4JzogMCwgJ3knOiAwfTt9Cgp9KTsKCi8qClNjcmlwdDogRnguQmFzZS5qcwoJQ29udGFpbnMgPEZ4LkJhc2U+LCB0aGUgZm91bmRhbWVudGFscyBvZiB0aGUgTW9vVG9vbHMgRWZmZWN0cy4KCkxpY2Vuc2U6CglNSVQtc3R5bGUgbGljZW5zZS4KKi8KCnZhciBGeCA9IHt9OwoKLyoKQ2xhc3M6IEZ4LkJhc2UKCUJhc2UgY2xhc3MgZm9yIHRoZSBFZmZlY3RzLgoKT3B0aW9uczoKCXRyYW5zaXRpb24gLSB0aGUgZXF1YXRpb24gdG8gdXNlIGZvciB0aGUgZWZmZWN0IHNlZSA8RnguVHJhbnNpdGlvbnM+OyBkZWZhdWx0IGlzIDxGeC5UcmFuc2l0aW9ucy5TaW5lLmVhc2VJbk91dD4KCWR1cmF0aW9uIC0gdGhlIGR1cmF0aW9uIG9mIHRoZSBlZmZlY3QgaW4gbXM7IDUwMCBpcyB0aGUgZGVmYXVsdC4KCXVuaXQgLSB0aGUgdW5pdCBpcyAncHgnIGJ5IGRlZmF1bHQgKG90aGVyIHZhbHVlcyBpbmNsdWRlIHRoaW5ncyBsaWtlICdlbScgZm9yIGZvbnRzIG9yICclJykuCgl3YWl0IC0gYm9vbGVhbjogdG8gd2FpdCBvciBub3QgdG8gd2FpdCBmb3IgYSBjdXJyZW50IHRyYW5zaXRpb24gdG8gZW5kIGJlZm9yZSBydW5uaW5nIGFub3RoZXIgb2YgdGhlIHNhbWUgaW5zdGFuY2UuIGRlZmF1bHRzIHRvIHRydWUuCglmcHMgLSB0aGUgZnJhbWVzIHBlciBzZWNvbmQgZm9yIHRoZSB0cmFuc2l0aW9uOyBkZWZhdWx0IGlzIDUwCgpFdmVudHM6CglvblN0YXJ0IC0gdGhlIGZ1bmN0aW9uIHRvIGV4ZWN1dGUgYXMgdGhlIGVmZmVjdCBiZWdpbnM7IG5vdGhpbmcgKDxDbGFzcy5lbXB0eT4pIGJ5IGRlZmF1bHQuCglvbkNvbXBsZXRlIC0gdGhlIGZ1bmN0aW9uIHRvIGV4ZWN1dGUgYWZ0ZXIgdGhlIGVmZmVjdCBoYXMgcHJvY2Vzc2VkOyBub3RoaW5nICg8Q2xhc3MuZW1wdHk+KSBieSBkZWZhdWx0LgoJb25DYW5jZWwgLSB0aGUgZnVuY3Rpb24gdG8gZXhlY3V0ZSB3aGVuIHlvdSBtYW51YWxseSBzdG9wIHRoZSBlZmZlY3QuCiovCgpGeC5CYXNlID0gbmV3IENsYXNzKHsKCglvcHRpb25zOiB7CgkJb25TdGFydDogQ2xhc3MuZW1wdHksCgkJb25Db21wbGV0ZTogQ2xhc3MuZW1wdHksCgkJb25DYW5jZWw6IENsYXNzLmVtcHR5LAoJCXRyYW5zaXRpb246IGZ1bmN0aW9uKHApewoJCQlyZXR1cm4gLShNYXRoLmNvcyhNYXRoLlBJICogcCkgLSAxKSAvIDI7CgkJfSwKCQlkdXJhdGlvbjogNTAwLAoJCXVuaXQ6ICdweCcsCgkJd2FpdDogdHJ1ZSwKCQlmcHM6IDUwCgl9LAoKCWluaXRpYWxpemU6IGZ1bmN0aW9uKG9wdGlvbnMpewoJCXRoaXMuZWxlbWVudCA9IHRoaXMuZWxlbWVudCB8fCBudWxsOwoJCXRoaXMuc2V0T3B0aW9ucyhvcHRpb25zKTsKCQlpZiAodGhpcy5vcHRpb25zLmluaXRpYWxpemUpIHRoaXMub3B0aW9ucy5pbml0aWFsaXplLmNhbGwodGhpcyk7Cgl9LAoKCXN0ZXA6IGZ1bmN0aW9uKCl7CgkJdmFyIHRpbWUgPSAkdGltZSgpOwoJCWlmICh0aW1lIDwgdGhpcy50aW1lICsgdGhpcy5vcHRpb25zLmR1cmF0aW9uKXsKCQkJdGhpcy5kZWx0YSA9IHRoaXMub3B0aW9ucy50cmFuc2l0aW9uKCh0aW1lIC0gdGhpcy50aW1lKSAvIHRoaXMub3B0aW9ucy5kdXJhdGlvbik7CgkJCXRoaXMuc2V0Tm93KCk7CgkJCXRoaXMuaW5jcmVhc2UoKTsKCQl9IGVsc2UgewoJCQl0aGlzLnN0b3AodHJ1ZSk7CgkJCXRoaXMuc2V0KHRoaXMudG8pOwoJCQl0aGlzLmZpcmVFdmVudCgnb25Db21wbGV0ZScsIHRoaXMuZWxlbWVudCwgMTApOwoJCQl0aGlzLmNhbGxDaGFpbigpOwoJCX0KCX0sCgoJLyoKCVByb3BlcnR5OiBzZXQKCQlJbW1lZGlhdGVseSBzZXRzIHRoZSB2YWx1ZSB3aXRoIG5vIHRyYW5zaXRpb24uCgoJQXJndW1lbnRzOgoJCXRvIC0gdGhlIHBvaW50IHRvIGp1bXAgdG8KCglFeGFtcGxlOgoJCT52YXIgbXlGeCA9IG5ldyBGeC5TdHlsZSgnbXlFbGVtZW50JywgJ29wYWNpdHknKS5zZXQoMCk7IC8vd2lsbCBtYWtlIGl0IGltbWVkaWF0ZWx5IHRyYW5zcGFyZW50CgkqLwoKCXNldDogZnVuY3Rpb24odG8pewoJCXRoaXMubm93ID0gdG87CgkJdGhpcy5pbmNyZWFzZSgpOwoJCXJldHVybiB0aGlzOwoJfSwKCglzZXROb3c6IGZ1bmN0aW9uKCl7CgkJdGhpcy5ub3cgPSB0aGlzLmNvbXB1dGUodGhpcy5mcm9tLCB0aGlzLnRvKTsKCX0sCgoJY29tcHV0ZTogZnVuY3Rpb24oZnJvbSwgdG8pewoJCXJldHVybiAodG8gLSBmcm9tKSAqIHRoaXMuZGVsdGEgKyBmcm9tOwoJfSwKCgkvKgoJUHJvcGVydHk6IHN0YXJ0CgkJRXhlY3V0ZXMgYW4gZWZmZWN0IGZyb20gb25lIHBvc2l0aW9uIHRvIHRoZSBvdGhlci4KCglBcmd1bWVudHM6CgkJZnJvbSAtIGludGVnZXI6IHN0YXJpbmcgdmFsdWUKCQl0byAtIGludGVnZXI6IHRoZSBlbmRpbmcgdmFsdWUKCglFeGFtcGxlczoKCQk+dmFyIG15RnggPSBuZXcgRnguU3R5bGUoJ215RWxlbWVudCcsICdvcGFjaXR5Jykuc3RhcnQoMCwxKTsgLy9kaXNwbGF5IGEgdHJhbnNpdGlvbiBmcm9tIHRyYW5zcGFyZW50IHRvIG9wYXF1ZS4KCSovCgoJc3RhcnQ6IGZ1bmN0aW9uKGZyb20sIHRvKXsKCQlpZiAoIXRoaXMub3B0aW9ucy53YWl0KSB0aGlzLnN0b3AoKTsKCQllbHNlIGlmICh0aGlzLnRpbWVyKSByZXR1cm4gdGhpczsKCQl0aGlzLmZyb20gPSBmcm9tOwoJCXRoaXMudG8gPSB0bzsKCQl0aGlzLmNoYW5nZSA9IHRoaXMudG8gLSB0aGlzLmZyb207CgkJdGhpcy50aW1lID0gJHRpbWUoKTsKCQl0aGlzLnRpbWVyID0gdGhpcy5zdGVwLnBlcmlvZGljYWwoTWF0aC5yb3VuZCgxMDAwIC8gdGhpcy5vcHRpb25zLmZwcyksIHRoaXMpOwoJCXRoaXMuZmlyZUV2ZW50KCdvblN0YXJ0JywgdGhpcy5lbGVtZW50KTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJLyoKCVByb3BlcnR5OiBzdG9wCgkJU3RvcHMgdGhlIHRyYW5zaXRpb24uCgkqLwoKCXN0b3A6IGZ1bmN0aW9uKGVuZCl7CgkJaWYgKCF0aGlzLnRpbWVyKSByZXR1cm4gdGhpczsKCQl0aGlzLnRpbWVyID0gJGNsZWFyKHRoaXMudGltZXIpOwoJCWlmICghZW5kKSB0aGlzLmZpcmVFdmVudCgnb25DYW5jZWwnLCB0aGlzLmVsZW1lbnQpOwoJCXJldHVybiB0aGlzOwoJfS8qY29tcGF0aWJpbGl0eSovLAoKCWN1c3RvbTogZnVuY3Rpb24oZnJvbSwgdG8pewoJCXJldHVybiB0aGlzLnN0YXJ0KGZyb20sIHRvKTsKCX0sCgoJY2xlYXJUaW1lcjogZnVuY3Rpb24oZW5kKXsKCQlyZXR1cm4gdGhpcy5zdG9wKGVuZCk7Cgl9CgoJLyplbmQgY29tcGF0aWJpbGl0eSovCgp9KTsKCkZ4LkJhc2UuaW1wbGVtZW50KG5ldyBDaGFpbiwgbmV3IEV2ZW50cywgbmV3IE9wdGlvbnMpOwoKLyoKU2NyaXB0OiBGeC5DU1MuanMKCUNzcyBwYXJzaW5nIGNsYXNzIGZvciBlZmZlY3RzLiBSZXF1aXJlZCBieSA8RnguU3R5bGU+LCA8RnguU3R5bGVzPiwgPEZ4LkVsZW1lbnRzPi4gTm8gZG9jdW1lbnRhdGlvbiBuZWVkZWQsIGFzIGl0cyB1c2VkIGludGVybmFsbHkuCgpMaWNlbnNlOgoJTUlULXN0eWxlIGxpY2Vuc2UuCiovCgpGeC5DU1MgPSB7CgoJc2VsZWN0OiBmdW5jdGlvbihwcm9wZXJ0eSwgdG8pewoJCWlmIChwcm9wZXJ0eS50ZXN0KC9jb2xvci9pKSkgcmV0dXJuIHRoaXMuQ29sb3I7CgkJdmFyIHR5cGUgPSAkdHlwZSh0byk7CgkJaWYgKCh0eXBlID09ICdhcnJheScpIHx8ICh0eXBlID09ICdzdHJpbmcnICYmIHRvLmNvbnRhaW5zKCcgJykpKSByZXR1cm4gdGhpcy5NdWx0aTsKCQlyZXR1cm4gdGhpcy5TaW5nbGU7Cgl9LAoKCXBhcnNlOiBmdW5jdGlvbihlbCwgcHJvcGVydHksIGZyb21Ubyl7CgkJaWYgKCFmcm9tVG8ucHVzaCkgZnJvbVRvID0gW2Zyb21Ub107CgkJdmFyIGZyb20gPSBmcm9tVG9bMF0sIHRvID0gZnJvbVRvWzFdOwoJCWlmICghJGNoayh0bykpewoJCQl0byA9IGZyb207CgkJCWZyb20gPSBlbC5nZXRTdHlsZShwcm9wZXJ0eSk7CgkJfQoJCXZhciBjc3MgPSB0aGlzLnNlbGVjdChwcm9wZXJ0eSwgdG8pOwoJCXJldHVybiB7J2Zyb20nOiBjc3MucGFyc2UoZnJvbSksICd0byc6IGNzcy5wYXJzZSh0byksICdjc3MnOiBjc3N9OwoJfQoKfTsKCkZ4LkNTUy5TaW5nbGUgPSB7CgoJcGFyc2U6IGZ1bmN0aW9uKHZhbHVlKXsKCQlyZXR1cm4gcGFyc2VGbG9hdCh2YWx1ZSk7Cgl9LAoKCWdldE5vdzogZnVuY3Rpb24oZnJvbSwgdG8sIGZ4KXsKCQlyZXR1cm4gZnguY29tcHV0ZShmcm9tLCB0byk7Cgl9LAoKCWdldFZhbHVlOiBmdW5jdGlvbih2YWx1ZSwgdW5pdCwgcHJvcGVydHkpewoJCWlmICh1bml0ID09ICdweCcgJiYgcHJvcGVydHkgIT0gJ29wYWNpdHknKSB2YWx1ZSA9IE1hdGgucm91bmQodmFsdWUpOwoJCXJldHVybiB2YWx1ZSArIHVuaXQ7Cgl9Cgp9OwoKRnguQ1NTLk11bHRpID0gewoKCXBhcnNlOiBmdW5jdGlvbih2YWx1ZSl7CgkJcmV0dXJuIHZhbHVlLnB1c2ggPyB2YWx1ZSA6IHZhbHVlLnNwbGl0KCcgJykubWFwKGZ1bmN0aW9uKHYpewoJCQlyZXR1cm4gcGFyc2VGbG9hdCh2KTsKCQl9KTsKCX0sCgoJZ2V0Tm93OiBmdW5jdGlvbihmcm9tLCB0bywgZngpewoJCXZhciBub3cgPSBbXTsKCQlmb3IgKHZhciBpID0gMDsgaSA8IGZyb20ubGVuZ3RoOyBpKyspIG5vd1tpXSA9IGZ4LmNvbXB1dGUoZnJvbVtpXSwgdG9baV0pOwoJCXJldHVybiBub3c7Cgl9LAoKCWdldFZhbHVlOiBmdW5jdGlvbih2YWx1ZSwgdW5pdCwgcHJvcGVydHkpewoJCWlmICh1bml0ID09ICdweCcgJiYgcHJvcGVydHkgIT0gJ29wYWNpdHknKSB2YWx1ZSA9IHZhbHVlLm1hcChNYXRoLnJvdW5kKTsKCQlyZXR1cm4gdmFsdWUuam9pbih1bml0ICsgJyAnKSArIHVuaXQ7Cgl9Cgp9OwoKRnguQ1NTLkNvbG9yID0gewoKCXBhcnNlOiBmdW5jdGlvbih2YWx1ZSl7CgkJcmV0dXJuIHZhbHVlLnB1c2ggPyB2YWx1ZSA6IHZhbHVlLmhleFRvUmdiKHRydWUpOwoJfSwKCglnZXROb3c6IGZ1bmN0aW9uKGZyb20sIHRvLCBmeCl7CgkJdmFyIG5vdyA9IFtdOwoJCWZvciAodmFyIGkgPSAwOyBpIDwgZnJvbS5sZW5ndGg7IGkrKykgbm93W2ldID0gTWF0aC5yb3VuZChmeC5jb21wdXRlKGZyb21baV0sIHRvW2ldKSk7CgkJcmV0dXJuIG5vdzsKCX0sCgoJZ2V0VmFsdWU6IGZ1bmN0aW9uKHZhbHVlKXsKCQlyZXR1cm4gJ3JnYignICsgdmFsdWUuam9pbignLCcpICsgJyknOwoJfQoKfTsKCi8qClNjcmlwdDogRnguU3R5bGUuanMKCUNvbnRhaW5zIDxGeC5TdHlsZT4KCkxpY2Vuc2U6CglNSVQtc3R5bGUgbGljZW5zZS4KKi8KCi8qCkNsYXNzOiBGeC5TdHlsZQoJVGhlIFN0eWxlIGVmZmVjdCwgdXNlZCB0byB0cmFuc2l0aW9uIGFueSBjc3MgcHJvcGVydHkgZnJvbSBvbmUgdmFsdWUgdG8gYW5vdGhlci4gSW5jbHVkZXMgY29sb3JzLgoJQ29sb3JzIG11c3QgYmUgaW4gaGV4IGZvcm1hdC4KCUluaGVyaXRzIG1ldGhvZHMsIHByb3BlcnRpZXMsIG9wdGlvbnMgYW5kIGV2ZW50cyBmcm9tIDxGeC5CYXNlPi4KCkFyZ3VtZW50czoKCWVsIC0gdGhlICQoZWxlbWVudCkgdG8gYXBwbHkgdGhlIHN0eWxlIHRyYW5zaXRpb24gdG8KCXByb3BlcnR5IC0gdGhlIHByb3BlcnR5IHRvIHRyYW5zaXRpb24KCW9wdGlvbnMgLSB0aGUgRnguQmFzZSBvcHRpb25zIChzZWU6IDxGeC5CYXNlPikKCkV4YW1wbGU6Cgk+dmFyIG1hcmdpbkNoYW5nZSA9IG5ldyBGeC5TdHlsZSgnbXlFbGVtZW50JywgJ21hcmdpbi10b3AnLCB7ZHVyYXRpb246NTAwfSk7Cgk+bWFyZ2luQ2hhbmdlLnN0YXJ0KDEwLCAxMDApOwoqLwoKRnguU3R5bGUgPSBGeC5CYXNlLmV4dGVuZCh7CgoJaW5pdGlhbGl6ZTogZnVuY3Rpb24oZWwsIHByb3BlcnR5LCBvcHRpb25zKXsKCQl0aGlzLmVsZW1lbnQgPSAkKGVsKTsKCQl0aGlzLnByb3BlcnR5ID0gcHJvcGVydHk7CgkJdGhpcy5wYXJlbnQob3B0aW9ucyk7Cgl9LAoKCS8qCglQcm9wZXJ0eTogaGlkZQoJCVNhbWUgYXMgPEZ4LkJhc2Uuc2V0PiAoMCk7IGhpZGVzIHRoZSBlbGVtZW50IGltbWVkaWF0ZWx5IHdpdGhvdXQgdHJhbnNpdGlvbi4KCSovCgoJaGlkZTogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5zZXQoMCk7Cgl9LAoKCXNldE5vdzogZnVuY3Rpb24oKXsKCQl0aGlzLm5vdyA9IHRoaXMuY3NzLmdldE5vdyh0aGlzLmZyb20sIHRoaXMudG8sIHRoaXMpOwoJfSwKCgkvKgoJUHJvcGVydHk6IHNldAoJCVNldHMgdGhlIGVsZW1lbnQncyBjc3MgcHJvcGVydHkgKHNwZWNpZmllZCBhdCBpbnN0YW50aWF0aW9uKSB0byB0aGUgc3BlY2lmaWVkIHZhbHVlIGltbWVkaWF0ZWx5LgoKCUV4YW1wbGU6CgkJKHN0YXJ0IGNvZGUpCgkJdmFyIG1hcmdpbkNoYW5nZSA9IG5ldyBGeC5TdHlsZSgnbXlFbGVtZW50JywgJ21hcmdpbi10b3AnLCB7ZHVyYXRpb246NTAwfSk7CgkJbWFyZ2luQ2hhbmdlLnNldCgxMCk7IC8vbWFyZ2luLXRvcCBpcyBzZXQgdG8gMTBweCBpbW1lZGlhdGVseQoJCShlbmQpCgkqLwoKCXNldDogZnVuY3Rpb24odG8pewoJCXRoaXMuY3NzID0gRnguQ1NTLnNlbGVjdCh0aGlzLnByb3BlcnR5LCB0byk7CgkJcmV0dXJuIHRoaXMucGFyZW50KHRoaXMuY3NzLnBhcnNlKHRvKSk7Cgl9LAoKCS8qCglQcm9wZXJ0eTogc3RhcnQKCQlEaXNwbGF5cyB0aGUgdHJhbnNpdGlvbiB0byB0aGUgdmFsdWUvdmFsdWVzIHBhc3NlZCBpbgoKCUFyZ3VtZW50czoKCQlmcm9tIC0gKGludGVnZXI7IG9wdGlvbmFsKSB0aGUgc3RhcnRpbmcgcG9zaXRpb24gZm9yIHRoZSB0cmFuc2l0aW9uCgkJdG8gLSAoaW50ZWdlcikgdGhlIGVuZGluZyBwb3NpdGlvbiBmb3IgdGhlIHRyYW5zaXRpb24KCglOb3RlOgoJCUlmIHlvdSBwcm92aWRlIG9ubHkgb25lIGFyZ3VtZW50LCB0aGUgdHJhbnNpdGlvbiB3aWxsIHVzZSB0aGUgY3VycmVudCBjc3MgdmFsdWUgZm9yIGl0cyBzdGFydGluZyB2YWx1ZS4KCglFeGFtcGxlOgoJCShzdGFydCBjb2RlKQoJCXZhciBtYXJnaW5DaGFuZ2UgPSBuZXcgRnguU3R5bGUoJ215RWxlbWVudCcsICdtYXJnaW4tdG9wJywge2R1cmF0aW9uOjUwMH0pOwoJCW1hcmdpbkNoYW5nZS5zdGFydCgxMCk7IC8vdHJpZXMgdG8gcmVhZCBjdXJyZW50IG1hcmdpbiB0b3AgdmFsdWUgYW5kIGdvZXMgZnJvbSBjdXJyZW50IHRvIDEwCgkJKGVuZCkKCSovCgoJc3RhcnQ6IGZ1bmN0aW9uKGZyb20sIHRvKXsKCQlpZiAodGhpcy50aW1lciAmJiB0aGlzLm9wdGlvbnMud2FpdCkgcmV0dXJuIHRoaXM7CgkJdmFyIHBhcnNlZCA9IEZ4LkNTUy5wYXJzZSh0aGlzLmVsZW1lbnQsIHRoaXMucHJvcGVydHksIFtmcm9tLCB0b10pOwoJCXRoaXMuY3NzID0gcGFyc2VkLmNzczsKCQlyZXR1cm4gdGhpcy5wYXJlbnQocGFyc2VkLmZyb20sIHBhcnNlZC50byk7Cgl9LAoKCWluY3JlYXNlOiBmdW5jdGlvbigpewoJCXRoaXMuZWxlbWVudC5zZXRTdHlsZSh0aGlzLnByb3BlcnR5LCB0aGlzLmNzcy5nZXRWYWx1ZSh0aGlzLm5vdywgdGhpcy5vcHRpb25zLnVuaXQsIHRoaXMucHJvcGVydHkpKTsKCX0KCn0pOwoKLyoKQ2xhc3M6IEVsZW1lbnQKCUN1c3RvbSBjbGFzcyB0byBhbGxvdyBhbGwgb2YgaXRzIG1ldGhvZHMgdG8gYmUgdXNlZCB3aXRoIGFueSBET00gZWxlbWVudCB2aWEgdGhlIGRvbGxhciBmdW5jdGlvbiA8JD4uCiovCgpFbGVtZW50LmV4dGVuZCh7CgoJLyoKCVByb3BlcnR5OiBlZmZlY3QKCQlBcHBsaWVzIGFuIDxGeC5TdHlsZT4gdG8gdGhlIEVsZW1lbnQ7IFRoaXMgYSBzaG9ydGN1dCBmb3IgPEZ4LlN0eWxlPi4KCglBcmd1bWVudHM6CgkJcHJvcGVydHkgLSAoc3RyaW5nKSB0aGUgY3NzIHByb3BlcnR5IHRvIGFsdGVyCgkJb3B0aW9ucyAtIChvYmplY3Q7IG9wdGlvbmFsKSBrZXkvdmFsdWUgc2V0IG9mIG9wdGlvbnMgKHNlZSA8RnguU3R5bGU+KQoKCUV4YW1wbGU6CgkJPnZhciBteUVmZmVjdCA9ICQoJ215RWxlbWVudCcpLmVmZmVjdCgnaGVpZ2h0Jywge2R1cmF0aW9uOiAxMDAwLCB0cmFuc2l0aW9uOiBGeC5UcmFuc2l0aW9ucy5saW5lYXJ9KTsKCQk+bXlFZmZlY3Quc3RhcnQoMTAsIDEwMCk7CgkJPi8vT1IKCQk+JCgnbXlFbGVtZW50JykuZWZmZWN0KCdoZWlnaHQnLCB7ZHVyYXRpb246IDEwMDAsIHRyYW5zaXRpb246IEZ4LlRyYW5zaXRpb25zLmxpbmVhcn0pLnN0YXJ0KDEwLDEwMCk7CgkqLwoKCWVmZmVjdDogZnVuY3Rpb24ocHJvcGVydHksIG9wdGlvbnMpewoJCXJldHVybiBuZXcgRnguU3R5bGUodGhpcywgcHJvcGVydHksIG9wdGlvbnMpOwoJfQoKfSk7CgovKgpTY3JpcHQ6IEZ4LlN0eWxlcy5qcwoJQ29udGFpbnMgPEZ4LlN0eWxlcz4KCkxpY2Vuc2U6CglNSVQtc3R5bGUgbGljZW5zZS4KKi8KCi8qCkNsYXNzOiBGeC5TdHlsZXMKCUFsbG93cyB5b3UgdG8gYW5pbWF0ZSBtdWx0aXBsZSBjc3MgcHJvcGVydGllcyBhdCBvbmNlOwoJQ29sb3JzIG11c3QgYmUgaW4gaGV4IGZvcm1hdC4KCUluaGVyaXRzIG1ldGhvZHMsIHByb3BlcnRpZXMsIG9wdGlvbnMgYW5kIGV2ZW50cyBmcm9tIDxGeC5CYXNlPi4KCkFyZ3VtZW50czoKCWVsIC0gdGhlICQoZWxlbWVudCkgdG8gYXBwbHkgdGhlIHN0eWxlcyB0cmFuc2l0aW9uIHRvCglvcHRpb25zIC0gdGhlIGZ4IG9wdGlvbnMgKHNlZTogPEZ4LkJhc2U+KQoKRXhhbXBsZToKCShzdGFydCBjb2RlKQoJdmFyIG15RWZmZWN0cyA9IG5ldyBGeC5TdHlsZXMoJ215RWxlbWVudCcsIHtkdXJhdGlvbjogMTAwMCwgdHJhbnNpdGlvbjogRnguVHJhbnNpdGlvbnMubGluZWFyfSk7CgoJLy9oZWlnaHQgZnJvbSAxMCB0byAxMDAgYW5kIHdpZHRoIGZyb20gOTAwIHRvIDMwMAoJbXlFZmZlY3RzLnN0YXJ0KHsKCQknaGVpZ2h0JzogWzEwLCAxMDBdLAoJCSd3aWR0aCc6IFs5MDAsIDMwMF0KCX0pOwoKCS8vb3IgaGVpZ2h0IGZyb20gY3VycmVudCBoZWlnaHQgdG8gMTAwIGFuZCB3aWR0aCBmcm9tIGN1cnJlbnQgd2lkdGggdG8gMzAwCglteUVmZmVjdHMuc3RhcnQoewoJCSdoZWlnaHQnOiAxMDAsCgkJJ3dpZHRoJzogMzAwCgl9KTsKCShlbmQpCiovCgpGeC5TdHlsZXMgPSBGeC5CYXNlLmV4dGVuZCh7CgoJaW5pdGlhbGl6ZTogZnVuY3Rpb24oZWwsIG9wdGlvbnMpewoJCXRoaXMuZWxlbWVudCA9ICQoZWwpOwoJCXRoaXMucGFyZW50KG9wdGlvbnMpOwoJfSwKCglzZXROb3c6IGZ1bmN0aW9uKCl7CgkJZm9yICh2YXIgcCBpbiB0aGlzLmZyb20pIHRoaXMubm93W3BdID0gdGhpcy5jc3NbcF0uZ2V0Tm93KHRoaXMuZnJvbVtwXSwgdGhpcy50b1twXSwgdGhpcyk7Cgl9LAoKCXNldDogZnVuY3Rpb24odG8pewoJCXZhciBwYXJzZWQgPSB7fTsKCQl0aGlzLmNzcyA9IHt9OwoJCWZvciAodmFyIHAgaW4gdG8pewoJCQl0aGlzLmNzc1twXSA9IEZ4LkNTUy5zZWxlY3QocCwgdG9bcF0pOwoJCQlwYXJzZWRbcF0gPSB0aGlzLmNzc1twXS5wYXJzZSh0b1twXSk7CgkJfQoJCXJldHVybiB0aGlzLnBhcmVudChwYXJzZWQpOwoJfSwKCgkvKgoJUHJvcGVydHk6IHN0YXJ0CgkJRXhlY3V0ZXMgYSB0cmFuc2l0aW9uIGZvciBhbnkgbnVtYmVyIG9mIGNzcyBwcm9wZXJ0aWVzIGluIHRhbmRlbS4KCglBcmd1bWVudHM6CgkJb2JqIC0gYW4gb2JqZWN0IGNvbnRhaW5pbmcga2V5cyB0aGF0IHNwZWNpZnkgY3NzIHByb3BlcnRpZXMgdG8gYWx0ZXIgYW5kIHZhbHVlcyB0aGF0IHNwZWNpZnkgZWl0aGVyIHRoZSBmcm9tL3RvIHZhbHVlcyAoYXMgYW4gYXJyYXkpIG9yIGp1c3QgdGhlIGVuZCB2YWx1ZSAoYW4gaW50ZWdlcikuCgoJRXhhbXBsZToKCQlzZWUgPEZ4LlN0eWxlcz4KCSovCgoJc3RhcnQ6IGZ1bmN0aW9uKG9iail7CgkJaWYgKHRoaXMudGltZXIgJiYgdGhpcy5vcHRpb25zLndhaXQpIHJldHVybiB0aGlzOwoJCXRoaXMubm93ID0ge307CgkJdGhpcy5jc3MgPSB7fTsKCQl2YXIgZnJvbSA9IHt9LCB0byA9IHt9OwoJCWZvciAodmFyIHAgaW4gb2JqKXsKCQkJdmFyIHBhcnNlZCA9IEZ4LkNTUy5wYXJzZSh0aGlzLmVsZW1lbnQsIHAsIG9ialtwXSk7CgkJCWZyb21bcF0gPSBwYXJzZWQuZnJvbTsKCQkJdG9bcF0gPSBwYXJzZWQudG87CgkJCXRoaXMuY3NzW3BdID0gcGFyc2VkLmNzczsKCQl9CgkJcmV0dXJuIHRoaXMucGFyZW50KGZyb20sIHRvKTsKCX0sCgoJaW5jcmVhc2U6IGZ1bmN0aW9uKCl7CgkJZm9yICh2YXIgcCBpbiB0aGlzLm5vdykgdGhpcy5lbGVtZW50LnNldFN0eWxlKHAsIHRoaXMuY3NzW3BdLmdldFZhbHVlKHRoaXMubm93W3BdLCB0aGlzLm9wdGlvbnMudW5pdCwgcCkpOwoJfQoKfSk7CgovKgpDbGFzczogRWxlbWVudAoJQ3VzdG9tIGNsYXNzIHRvIGFsbG93IGFsbCBvZiBpdHMgbWV0aG9kcyB0byBiZSB1c2VkIHdpdGggYW55IERPTSBlbGVtZW50IHZpYSB0aGUgZG9sbGFyIGZ1bmN0aW9uIDwkPi4KKi8KCkVsZW1lbnQuZXh0ZW5kKHsKCgkvKgoJUHJvcGVydHk6IGVmZmVjdHMKCQlBcHBsaWVzIGFuIDxGeC5TdHlsZXM+IHRvIHRoZSBFbGVtZW50OyBUaGlzIGEgc2hvcnRjdXQgZm9yIDxGeC5TdHlsZXM+LgoKCUV4YW1wbGU6CgkJPnZhciBteUVmZmVjdHMgPSAkKG15RWxlbWVudCkuZWZmZWN0cyh7ZHVyYXRpb246IDEwMDAsIHRyYW5zaXRpb246IEZ4LlRyYW5zaXRpb25zLlNpbmUuZWFzZUluT3V0fSk7CiAJCT5teUVmZmVjdHMuc3RhcnQoeydoZWlnaHQnOiBbMTAsIDEwMF0sICd3aWR0aCc6IFs5MDAsIDMwMF19KTsKCSovCgoJZWZmZWN0czogZnVuY3Rpb24ob3B0aW9ucyl7CgkJcmV0dXJuIG5ldyBGeC5TdHlsZXModGhpcywgb3B0aW9ucyk7Cgl9Cgp9KTsKCi8qClNjcmlwdDogRnguRWxlbWVudHMuanMKCUNvbnRhaW5zIDxGeC5FbGVtZW50cz4KCkxpY2Vuc2U6CglNSVQtc3R5bGUgbGljZW5zZS4KKi8KCi8qCkNsYXNzOiBGeC5FbGVtZW50cwoJRnguRWxlbWVudHMgYWxsb3dzIHlvdSB0byBhcHBseSBhbnkgbnVtYmVyIG9mIHN0eWxlcyB0cmFuc2l0aW9ucyB0byBhIHNlbGVjdGlvbiBvZiBlbGVtZW50cy4gSW5jbHVkZXMgY29sb3JzIChtdXN0IGJlIGluIGhleCBmb3JtYXQpLgoJSW5oZXJpdHMgbWV0aG9kcywgcHJvcGVydGllcywgb3B0aW9ucyBhbmQgZXZlbnRzIGZyb20gPEZ4LkJhc2U+LgoKQXJndW1lbnRzOgoJZWxlbWVudHMgLSBhIGNvbGxlY3Rpb24gb2YgZWxlbWVudHMgdGhlIGVmZmVjdHMgd2lsbCBiZSBhcHBsaWVkIHRvLgoJb3B0aW9ucyAtIHNhbWUgYXMgPEZ4LkJhc2U+IG9wdGlvbnMuCiovCgpGeC5FbGVtZW50cyA9IEZ4LkJhc2UuZXh0ZW5kKHsKCglpbml0aWFsaXplOiBmdW5jdGlvbihlbGVtZW50cywgb3B0aW9ucyl7CgkJdGhpcy5lbGVtZW50cyA9ICQkKGVsZW1lbnRzKTsKCQl0aGlzLnBhcmVudChvcHRpb25zKTsKCX0sCgoJc2V0Tm93OiBmdW5jdGlvbigpewoJCWZvciAodmFyIGkgaW4gdGhpcy5mcm9tKXsKCQkJdmFyIGlGcm9tID0gdGhpcy5mcm9tW2ldLCBpVG8gPSB0aGlzLnRvW2ldLCBpQ3NzID0gdGhpcy5jc3NbaV0sIGlOb3cgPSB0aGlzLm5vd1tpXSA9IHt9OwoJCQlmb3IgKHZhciBwIGluIGlGcm9tKSBpTm93W3BdID0gaUNzc1twXS5nZXROb3coaUZyb21bcF0sIGlUb1twXSwgdGhpcyk7CgkJfQoJfSwKCglzZXQ6IGZ1bmN0aW9uKHRvKXsKCQl2YXIgcGFyc2VkID0ge307CgkJdGhpcy5jc3MgPSB7fTsKCQlmb3IgKHZhciBpIGluIHRvKXsKCQkJdmFyIGlUbyA9IHRvW2ldLCBpQ3NzID0gdGhpcy5jc3NbaV0gPSB7fSwgaVBhcnNlZCA9IHBhcnNlZFtpXSA9IHt9OwoJCQlmb3IgKHZhciBwIGluIGlUbyl7CgkJCQlpQ3NzW3BdID0gRnguQ1NTLnNlbGVjdChwLCBpVG9bcF0pOwoJCQkJaVBhcnNlZFtwXSA9IGlDc3NbcF0ucGFyc2UoaVRvW3BdKTsKCQkJfQoJCX0KCQlyZXR1cm4gdGhpcy5wYXJlbnQocGFyc2VkKTsKCX0sCgoJLyoKCVByb3BlcnR5OiBzdGFydAoJCUFwcGxpZXMgdGhlIHBhc3NlZCBpbiBzdHlsZSB0cmFuc2l0aW9ucyB0byBlYWNoIG9iamVjdCBuYW1lZCAoc2VlIGV4YW1wbGUpLiBFYWNoIGl0ZW0gaW4gdGhlIGNvbGxlY3Rpb24gaXMgcmVmZXJlZCB0byBhcyBhIG51bWVyaWNhbCBzdHJpbmcgKCIxIiBmb3IgaW5zdGFuY2UpLiBUaGUgZmlyc3QgaXRlbSBpcyAiMCIsIHRoZSBzZWNvbmQgIjEiLCBldGMuCgoJRXhhbXBsZToKCQkoc3RhcnQgY29kZSkKCQl2YXIgbXlFbGVtZW50c0VmZmVjdHMgPSBuZXcgRnguRWxlbWVudHMoJCQoJ2EnKSk7CgkJbXlFbGVtZW50c0VmZmVjdHMuc3RhcnQoewoJCQknMCc6IHsgLy9sZXQncyBjaGFuZ2UgdGhlIGZpcnN0IGVsZW1lbnQncyBvcGFjaXR5IGFuZCB3aWR0aAoJCQkJJ29wYWNpdHknOiBbMCwxXSwKCQkJCSd3aWR0aCc6IFsxMDAsMjAwXQoJCQl9LAoJCQknNCc6IHsgLy9hbmQgdGhlIGZpZnRoIG9uZSdzIG9wYWNpdHkKCQkJCSdvcGFjaXR5JzogWzAuMiwgMC41XQoJCQl9CgkJfSk7CgkJKGVuZCkKCSovCgoJc3RhcnQ6IGZ1bmN0aW9uKG9iail7CgkJaWYgKHRoaXMudGltZXIgJiYgdGhpcy5vcHRpb25zLndhaXQpIHJldHVybiB0aGlzOwoJCXRoaXMubm93ID0ge307CgkJdGhpcy5jc3MgPSB7fTsKCQl2YXIgZnJvbSA9IHt9LCB0byA9IHt9OwoJCWZvciAodmFyIGkgaW4gb2JqKXsKCQkJdmFyIGlQcm9wcyA9IG9ialtpXSwgaUZyb20gPSBmcm9tW2ldID0ge30sIGlUbyA9IHRvW2ldID0ge30sIGlDc3MgPSB0aGlzLmNzc1tpXSA9IHt9OwoJCQlmb3IgKHZhciBwIGluIGlQcm9wcyl7CgkJCQl2YXIgcGFyc2VkID0gRnguQ1NTLnBhcnNlKHRoaXMuZWxlbWVudHNbaV0sIHAsIGlQcm9wc1twXSk7CgkJCQlpRnJvbVtwXSA9IHBhcnNlZC5mcm9tOwoJCQkJaVRvW3BdID0gcGFyc2VkLnRvOwoJCQkJaUNzc1twXSA9IHBhcnNlZC5jc3M7CgkJCX0KCQl9CgkJcmV0dXJuIHRoaXMucGFyZW50KGZyb20sIHRvKTsKCX0sCgoJaW5jcmVhc2U6IGZ1bmN0aW9uKCl7CgkJZm9yICh2YXIgaSBpbiB0aGlzLm5vdyl7CgkJCXZhciBpTm93ID0gdGhpcy5ub3dbaV0sIGlDc3MgPSB0aGlzLmNzc1tpXTsKCQkJZm9yICh2YXIgcCBpbiBpTm93KSB0aGlzLmVsZW1lbnRzW2ldLnNldFN0eWxlKHAsIGlDc3NbcF0uZ2V0VmFsdWUoaU5vd1twXSwgdGhpcy5vcHRpb25zLnVuaXQsIHApKTsKCQl9Cgl9Cgp9KTsKCi8qClNjcmlwdDogRnguU2Nyb2xsLmpzCglDb250YWlucyA8RnguU2Nyb2xsPgoKTGljZW5zZToKCU1JVC1zdHlsZSBsaWNlbnNlLgoqLwoKLyoKQ2xhc3M6IEZ4LlNjcm9sbAoJU2Nyb2xsIGFueSBlbGVtZW50IHdpdGggYW4gb3ZlcmZsb3csIGluY2x1ZGluZyB0aGUgd2luZG93IGVsZW1lbnQuCglJbmhlcml0cyBtZXRob2RzLCBwcm9wZXJ0aWVzLCBvcHRpb25zIGFuZCBldmVudHMgZnJvbSA8RnguQmFzZT4uCgpOb3RlOgoJRnguU2Nyb2xsIHJlcXVpcmVzIGFuIFhIVE1MIGRvY3R5cGUuCgpBcmd1bWVudHM6CgllbGVtZW50IC0gdGhlIGVsZW1lbnQgdG8gc2Nyb2xsCglvcHRpb25zIC0gb3B0aW9uYWwsIHNlZSBPcHRpb25zIGJlbG93LgoKT3B0aW9uczoKCWFsbCB0aGUgRnguQmFzZSBvcHRpb25zIGFuZCBldmVudHMsIHBsdXM6CglvZmZzZXQgLSB0aGUgZGlzdGFuY2UgZm9yIHRoZSBzY3JvbGxUbyBwb2ludC9lbGVtZW50LiBhbiBPYmplY3Qgd2l0aCB4L3kgcHJvcGVydGllcy4KCW92ZXJmbG93biAtIGFuIGFycmF5IG9mIG5lc3RlZCBzY3JvbGxpbmcgY29udGFpbmVycywgc2VlIDxFbGVtZW50LmdldFBvc2l0aW9uPgoqLwoKRnguU2Nyb2xsID0gRnguQmFzZS5leHRlbmQoewoKCW9wdGlvbnM6IHsKCQlvdmVyZmxvd246IFtdLAoJCW9mZnNldDogeyd4JzogMCwgJ3knOiAwfSwKCQl3aGVlbFN0b3BzOiB0cnVlCgl9LAoKCWluaXRpYWxpemU6IGZ1bmN0aW9uKGVsZW1lbnQsIG9wdGlvbnMpewoJCXRoaXMubm93ID0gW107CgkJdGhpcy5lbGVtZW50ID0gJChlbGVtZW50KTsKCQl0aGlzLmJvdW5kID0geydzdG9wJzogdGhpcy5zdG9wLmJpbmQodGhpcywgZmFsc2UpfTsKCQl0aGlzLnBhcmVudChvcHRpb25zKTsKCQlpZiAodGhpcy5vcHRpb25zLndoZWVsU3RvcHMpewoJCQl0aGlzLmFkZEV2ZW50KCdvblN0YXJ0JywgZnVuY3Rpb24oKXsKCQkJCWRvY3VtZW50LmFkZEV2ZW50KCdtb3VzZXdoZWVsJywgdGhpcy5ib3VuZC5zdG9wKTsKCQkJfS5iaW5kKHRoaXMpKTsKCQkJdGhpcy5hZGRFdmVudCgnb25Db21wbGV0ZScsIGZ1bmN0aW9uKCl7CgkJCQlkb2N1bWVudC5yZW1vdmVFdmVudCgnbW91c2V3aGVlbCcsIHRoaXMuYm91bmQuc3RvcCk7CgkJCX0uYmluZCh0aGlzKSk7CgkJfQoJfSwKCglzZXROb3c6IGZ1bmN0aW9uKCl7CgkJZm9yICh2YXIgaSA9IDA7IGkgPCAyOyBpKyspIHRoaXMubm93W2ldID0gdGhpcy5jb21wdXRlKHRoaXMuZnJvbVtpXSwgdGhpcy50b1tpXSk7Cgl9LAoKCS8qCglQcm9wZXJ0eTogc2Nyb2xsVG8KCQlTY3JvbGxzIHRoZSBjaG9zZW4gZWxlbWVudCB0byB0aGUgeC95IGNvb3JkaW5hdGVzLgoKCUFyZ3VtZW50czoKCQl4IC0gdGhlIHggY29vcmRpbmF0ZSB0byBzY3JvbGwgdGhlIGVsZW1lbnQgdG8KCQl5IC0gdGhlIHkgY29vcmRpbmF0ZSB0byBzY3JvbGwgdGhlIGVsZW1lbnQgdG8KCSovCgoJc2Nyb2xsVG86IGZ1bmN0aW9uKHgsIHkpewoJCWlmICh0aGlzLnRpbWVyICYmIHRoaXMub3B0aW9ucy53YWl0KSByZXR1cm4gdGhpczsKCQl2YXIgZWwgPSB0aGlzLmVsZW1lbnQuZ2V0U2l6ZSgpOwoJCXZhciB2YWx1ZXMgPSB7J3gnOiB4LCAneSc6IHl9OwoJCWZvciAodmFyIHogaW4gZWwuc2l6ZSl7CgkJCXZhciBtYXggPSBlbC5zY3JvbGxTaXplW3pdIC0gZWwuc2l6ZVt6XTsKCQkJaWYgKCRjaGsodmFsdWVzW3pdKSkgdmFsdWVzW3pdID0gKCR0eXBlKHZhbHVlc1t6XSkgPT0gJ251bWJlcicpID8gdmFsdWVzW3pdLmxpbWl0KDAsIG1heCkgOiBtYXg7CgkJCWVsc2UgdmFsdWVzW3pdID0gZWwuc2Nyb2xsW3pdOwoJCQl2YWx1ZXNbel0gKz0gdGhpcy5vcHRpb25zLm9mZnNldFt6XTsKCQl9CgkJcmV0dXJuIHRoaXMuc3RhcnQoW2VsLnNjcm9sbC54LCBlbC5zY3JvbGwueV0sIFt2YWx1ZXMueCwgdmFsdWVzLnldKTsKCX0sCgoJLyoKCVByb3BlcnR5OiB0b1RvcAoJCVNjcm9sbHMgdGhlIGNob3NlbiBlbGVtZW50IHRvIGl0cyBtYXhpbXVtIHRvcC4KCSovCgoJdG9Ub3A6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMuc2Nyb2xsVG8oZmFsc2UsIDApOwoJfSwKCgkvKgoJUHJvcGVydHk6IHRvQm90dG9tCgkJU2Nyb2xscyB0aGUgY2hvc2VuIGVsZW1lbnQgdG8gaXRzIG1heGltdW0gYm90dG9tLgoJKi8KCgl0b0JvdHRvbTogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5zY3JvbGxUbyhmYWxzZSwgJ2Z1bGwnKTsKCX0sCgoJLyoKCVByb3BlcnR5OiB0b0xlZnQKCQlTY3JvbGxzIHRoZSBjaG9zZW4gZWxlbWVudCB0byBpdHMgbWF4aW11bSBsZWZ0LgoJKi8KCgl0b0xlZnQ6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMuc2Nyb2xsVG8oMCwgZmFsc2UpOwoJfSwKCgkvKgoJUHJvcGVydHk6IHRvUmlnaHQKCQlTY3JvbGxzIHRoZSBjaG9zZW4gZWxlbWVudCB0byBpdHMgbWF4aW11bSByaWdodC4KCSovCgoJdG9SaWdodDogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5zY3JvbGxUbygnZnVsbCcsIGZhbHNlKTsKCX0sCgoJLyoKCVByb3BlcnR5OiB0b0VsZW1lbnQKCQlTY3JvbGxzIHRoZSBzcGVjaWZpZWQgZWxlbWVudCB0byB0aGUgcG9zaXRpb24gdGhlIHBhc3NlZCBpbiBlbGVtZW50IGlzIGZvdW5kLgoKCUFyZ3VtZW50czoKCQllbCAtIHRoZSAkKGVsZW1lbnQpIHRvIHNjcm9sbCB0aGUgd2luZG93IHRvCgkqLwoKCXRvRWxlbWVudDogZnVuY3Rpb24oZWwpewoJCXZhciBwYXJlbnQgPSB0aGlzLmVsZW1lbnQuZ2V0UG9zaXRpb24odGhpcy5vcHRpb25zLm92ZXJmbG93bik7CgkJdmFyIHRhcmdldCA9ICQoZWwpLmdldFBvc2l0aW9uKHRoaXMub3B0aW9ucy5vdmVyZmxvd24pOwoJCXJldHVybiB0aGlzLnNjcm9sbFRvKHRhcmdldC54IC0gcGFyZW50LngsIHRhcmdldC55IC0gcGFyZW50LnkpOwoJfSwKCglpbmNyZWFzZTogZnVuY3Rpb24oKXsKCQl0aGlzLmVsZW1lbnQuc2Nyb2xsVG8odGhpcy5ub3dbMF0sIHRoaXMubm93WzFdKTsKCX0KCn0pOwoKLyoKU2NyaXB0OiBGeC5TbGlkZS5qcwoJQ29udGFpbnMgPEZ4LlNsaWRlPgoKTGljZW5zZToKCU1JVC1zdHlsZSBsaWNlbnNlLgoqLwoKLyoKQ2xhc3M6IEZ4LlNsaWRlCglUaGUgc2xpZGUgZWZmZWN0OyBzbGlkZXMgYW4gZWxlbWVudCBpbiBob3Jpem9udGFsbHkgb3IgdmVydGljYWxseSwgdGhlIGNvbnRlbnRzIHdpbGwgZm9sZCBpbnNpZGUuCglJbmhlcml0cyBtZXRob2RzLCBwcm9wZXJ0aWVzLCBvcHRpb25zIGFuZCBldmVudHMgZnJvbSA8RnguQmFzZT4uCgpOb3RlOgoJRnguU2xpZGUgcmVxdWlyZXMgYW4gWEhUTUwgZG9jdHlwZS4KCk9wdGlvbnM6Cgltb2RlIC0gc2V0IGl0IHRvIHZlcnRpY2FsIG9yIGhvcml6b250YWwuIERlZmF1bHRzIHRvIHZlcnRpY2FsLgoJb3B0aW9ucyAtIGFsbCB0aGUgPEZ4LkJhc2U+IG9wdGlvbnMKCkV4YW1wbGU6Cgkoc3RhcnQgY29kZSkKCXZhciBteVNsaWRlciA9IG5ldyBGeC5TbGlkZSgnbXlFbGVtZW50Jywge2R1cmF0aW9uOiA1MDB9KTsKCW15U2xpZGVyLnRvZ2dsZSgpIC8vdG9nZ2xlIHRoZSBzbGlkZXIgdXAgYW5kIGRvd24uCgkoZW5kKQoqLwoKRnguU2xpZGUgPSBGeC5CYXNlLmV4dGVuZCh7CgoJb3B0aW9uczogewoJCW1vZGU6ICd2ZXJ0aWNhbCcKCX0sCgoJaW5pdGlhbGl6ZTogZnVuY3Rpb24oZWwsIG9wdGlvbnMpewoJCXRoaXMuZWxlbWVudCA9ICQoZWwpOwoJCXRoaXMud3JhcHBlciA9IG5ldyBFbGVtZW50KCdkaXYnLCB7J3N0eWxlcyc6ICRleHRlbmQodGhpcy5lbGVtZW50LmdldFN0eWxlcygnbWFyZ2luJyksIHsnb3ZlcmZsb3cnOiAnaGlkZGVuJ30pfSkuaW5qZWN0QWZ0ZXIodGhpcy5lbGVtZW50KS5hZG9wdCh0aGlzLmVsZW1lbnQpOwoJCXRoaXMuZWxlbWVudC5zZXRTdHlsZSgnbWFyZ2luJywgMCk7CgkJdGhpcy5zZXRPcHRpb25zKG9wdGlvbnMpOwoJCXRoaXMubm93ID0gW107CgkJdGhpcy5wYXJlbnQodGhpcy5vcHRpb25zKTsKCQl0aGlzLm9wZW4gPSB0cnVlOwoJCXRoaXMuYWRkRXZlbnQoJ29uQ29tcGxldGUnLCBmdW5jdGlvbigpewoJCQl0aGlzLm9wZW4gPSAodGhpcy5ub3dbMF0gPT09IDApOwoJCX0pOwoJCWlmICh3aW5kb3cud2Via2l0NDE5KSB0aGlzLmFkZEV2ZW50KCdvbkNvbXBsZXRlJywgZnVuY3Rpb24oKXsKCQkJaWYgKHRoaXMub3BlbikgdGhpcy5lbGVtZW50LnJlbW92ZSgpLmluamVjdCh0aGlzLndyYXBwZXIpOwoJCX0pOwoJfSwKCglzZXROb3c6IGZ1bmN0aW9uKCl7CgkJZm9yICh2YXIgaSA9IDA7IGkgPCAyOyBpKyspIHRoaXMubm93W2ldID0gdGhpcy5jb21wdXRlKHRoaXMuZnJvbVtpXSwgdGhpcy50b1tpXSk7Cgl9LAoKCXZlcnRpY2FsOiBmdW5jdGlvbigpewoJCXRoaXMubWFyZ2luID0gJ21hcmdpbi10b3AnOwoJCXRoaXMubGF5b3V0ID0gJ2hlaWdodCc7CgkJdGhpcy5vZmZzZXQgPSB0aGlzLmVsZW1lbnQub2Zmc2V0SGVpZ2h0OwoJfSwKCglob3Jpem9udGFsOiBmdW5jdGlvbigpewoJCXRoaXMubWFyZ2luID0gJ21hcmdpbi1sZWZ0JzsKCQl0aGlzLmxheW91dCA9ICd3aWR0aCc7CgkJdGhpcy5vZmZzZXQgPSB0aGlzLmVsZW1lbnQub2Zmc2V0V2lkdGg7Cgl9LAoKCS8qCglQcm9wZXJ0eTogc2xpZGVJbgoJCVNsaWRlcyB0aGUgZWxlbWVudHMgaW4gdmlldyBob3Jpem9udGFsbHkgb3IgdmVydGljYWxseS4KCglBcmd1bWVudHM6CgkJbW9kZSAtIChvcHRpb25hbCwgc3RyaW5nKSAnaG9yaXpvbnRhbCcgb3IgJ3ZlcnRpY2FsJzsgZGVmYXVsdHMgdG8gb3B0aW9ucy5tb2RlLgoJKi8KCglzbGlkZUluOiBmdW5jdGlvbihtb2RlKXsKCQl0aGlzW21vZGUgfHwgdGhpcy5vcHRpb25zLm1vZGVdKCk7CgkJcmV0dXJuIHRoaXMuc3RhcnQoW3RoaXMuZWxlbWVudC5nZXRTdHlsZSh0aGlzLm1hcmdpbikudG9JbnQoKSwgdGhpcy53cmFwcGVyLmdldFN0eWxlKHRoaXMubGF5b3V0KS50b0ludCgpXSwgWzAsIHRoaXMub2Zmc2V0XSk7Cgl9LAoKCS8qCglQcm9wZXJ0eTogc2xpZGVPdXQKCQlTaWRlcyB0aGUgZWxlbWVudHMgb3V0IG9mIHZpZXcgaG9yaXpvbnRhbGx5IG9yIHZlcnRpY2FsbHkuCgoJQXJndW1lbnRzOgoJCW1vZGUgLSAob3B0aW9uYWwsIHN0cmluZykgJ2hvcml6b250YWwnIG9yICd2ZXJ0aWNhbCc7IGRlZmF1bHRzIHRvIG9wdGlvbnMubW9kZS4KCSovCgoJc2xpZGVPdXQ6IGZ1bmN0aW9uKG1vZGUpewoJCXRoaXNbbW9kZSB8fCB0aGlzLm9wdGlvbnMubW9kZV0oKTsKCQlyZXR1cm4gdGhpcy5zdGFydChbdGhpcy5lbGVtZW50LmdldFN0eWxlKHRoaXMubWFyZ2luKS50b0ludCgpLCB0aGlzLndyYXBwZXIuZ2V0U3R5bGUodGhpcy5sYXlvdXQpLnRvSW50KCldLCBbLXRoaXMub2Zmc2V0LCAwXSk7Cgl9LAoKCS8qCglQcm9wZXJ0eTogaGlkZQoJCUhpZGVzIHRoZSBlbGVtZW50IHdpdGhvdXQgYSB0cmFuc2l0aW9uLgoKCUFyZ3VtZW50czoKCQltb2RlIC0gKG9wdGlvbmFsLCBzdHJpbmcpICdob3Jpem9udGFsJyBvciAndmVydGljYWwnOyBkZWZhdWx0cyB0byBvcHRpb25zLm1vZGUuCgkqLwoKCWhpZGU6IGZ1bmN0aW9uKG1vZGUpewoJCXRoaXNbbW9kZSB8fCB0aGlzLm9wdGlvbnMubW9kZV0oKTsKCQl0aGlzLm9wZW4gPSBmYWxzZTsKCQlyZXR1cm4gdGhpcy5zZXQoWy10aGlzLm9mZnNldCwgMF0pOwoJfSwKCgkvKgoJUHJvcGVydHk6IHNob3cKCQlTaG93cyB0aGUgZWxlbWVudCB3aXRob3V0IGEgdHJhbnNpdGlvbi4KCglBcmd1bWVudHM6CgkJbW9kZSAtIChvcHRpb25hbCwgc3RyaW5nKSAnaG9yaXpvbnRhbCcgb3IgJ3ZlcnRpY2FsJzsgZGVmYXVsdHMgdG8gb3B0aW9ucy5tb2RlLgoJKi8KCglzaG93OiBmdW5jdGlvbihtb2RlKXsKCQl0aGlzW21vZGUgfHwgdGhpcy5vcHRpb25zLm1vZGVdKCk7CgkJdGhpcy5vcGVuID0gdHJ1ZTsKCQlyZXR1cm4gdGhpcy5zZXQoWzAsIHRoaXMub2Zmc2V0XSk7Cgl9LAoKCS8qCglQcm9wZXJ0eTogdG9nZ2xlCgkJU2xpZGVzIGluIG9yIE91dCB0aGUgZWxlbWVudCwgZGVwZW5kaW5nIG9uIGl0cyBzdGF0ZQoKCUFyZ3VtZW50czoKCQltb2RlIC0gKG9wdGlvbmFsLCBzdHJpbmcpICdob3Jpem9udGFsJyBvciAndmVydGljYWwnOyBkZWZhdWx0cyB0byBvcHRpb25zLm1vZGUuCgoJKi8KCgl0b2dnbGU6IGZ1bmN0aW9uKG1vZGUpewoJCWlmICh0aGlzLndyYXBwZXIub2Zmc2V0SGVpZ2h0ID09IDAgfHwgdGhpcy53cmFwcGVyLm9mZnNldFdpZHRoID09IDApIHJldHVybiB0aGlzLnNsaWRlSW4obW9kZSk7CgkJcmV0dXJuIHRoaXMuc2xpZGVPdXQobW9kZSk7Cgl9LAoKCWluY3JlYXNlOiBmdW5jdGlvbigpewoJCXRoaXMuZWxlbWVudC5zZXRTdHlsZSh0aGlzLm1hcmdpbiwgdGhpcy5ub3dbMF0gKyB0aGlzLm9wdGlvbnMudW5pdCk7CgkJdGhpcy53cmFwcGVyLnNldFN0eWxlKHRoaXMubGF5b3V0LCB0aGlzLm5vd1sxXSArIHRoaXMub3B0aW9ucy51bml0KTsKCX0KCn0pOwoKLyoKU2NyaXB0OiBGeC5UcmFuc2l0aW9ucy5qcwoJRWZmZWN0cyB0cmFuc2l0aW9ucywgdG8gYmUgdXNlZCB3aXRoIGFsbCB0aGUgZWZmZWN0cy4KCkxpY2Vuc2U6CglNSVQtc3R5bGUgbGljZW5zZS4KCkNyZWRpdHM6CglFYXNpbmcgRXF1YXRpb25zIGJ5IFJvYmVydCBQZW5uZXIsIDxodHRwOi8vd3d3LnJvYmVydHBlbm5lci5jb20vZWFzaW5nLz4sIG1vZGlmaWVkICYgb3B0aW1pemVkIHRvIGJlIHVzZWQgd2l0aCBtb290b29scy4KKi8KCi8qCkNsYXNzOiBGeC5UcmFuc2l0aW9ucwoJQSBjb2xsZWN0aW9uIG9mIHR3ZWVuaW5nIHRyYW5zaXRpb25zIGZvciB1c2Ugd2l0aCB0aGUgPEZ4LkJhc2U+IGNsYXNzZXMuCgpFeGFtcGxlOgoJPi8vRWxhc3RpYy5lYXNlT3V0IHdpdGggZGVmYXVsdCB2YWx1ZXM6Cgk+bmV3IEZ4LlN0eWxlKCdtYXJnaW4nLCB7dHJhbnNpdGlvbjogRnguVHJhbnNpdGlvbnMuRWxhc3RpYy5lYXNlT3V0fSk7Cgk+Ly9FbGFzdGljLmVhc2VPdXQgd2l0aCB1c2VyLWRlZmluZWQgdmFsdWUgZm9yIGVsYXN0aWNpdHkuCgk+IHZhciBteVRyYW5zaXRpb24gPSBuZXcgRnguVHJhbnNpdGlvbihGeC5UcmFuc2l0aW9ucy5FbGFzdGljLCAzKTsKCT5uZXcgRnguU3R5bGUoJ21hcmdpbicsIHt0cmFuc2l0aW9uOiBteVRyYW5zaXRpb24uZWFzZU91dH0pOwoKU2VlIGFsc286CglodHRwOi8vd3d3LnJvYmVydHBlbm5lci5jb20vZWFzaW5nLwoqLwoKRnguVHJhbnNpdGlvbiA9IGZ1bmN0aW9uKHRyYW5zaXRpb24sIHBhcmFtcyl7CglwYXJhbXMgPSBwYXJhbXMgfHwgW107CglpZiAoJHR5cGUocGFyYW1zKSAhPSAnYXJyYXknKSBwYXJhbXMgPSBbcGFyYW1zXTsKCXJldHVybiAkZXh0ZW5kKHRyYW5zaXRpb24sIHsKCQllYXNlSW46IGZ1bmN0aW9uKHBvcyl7CgkJCXJldHVybiB0cmFuc2l0aW9uKHBvcywgcGFyYW1zKTsKCQl9LAoJCWVhc2VPdXQ6IGZ1bmN0aW9uKHBvcyl7CgkJCXJldHVybiAxIC0gdHJhbnNpdGlvbigxIC0gcG9zLCBwYXJhbXMpOwoJCX0sCgkJZWFzZUluT3V0OiBmdW5jdGlvbihwb3MpewoJCQlyZXR1cm4gKHBvcyA8PSAwLjUpID8gdHJhbnNpdGlvbigyICogcG9zLCBwYXJhbXMpIC8gMiA6ICgyIC0gdHJhbnNpdGlvbigyICogKDEgLSBwb3MpLCBwYXJhbXMpKSAvIDI7CgkJfQoJfSk7Cn07CgpGeC5UcmFuc2l0aW9ucyA9IG5ldyBBYnN0cmFjdCh7CgoJLyoKCVByb3BlcnR5OiBsaW5lYXIKCQlkaXNwbGF5cyBhIGxpbmVhciB0cmFuc2l0aW9uLgoKCUdyYXBoOgoJCShzZWUgTGluZWFyLnBuZykKCSovCgoJbGluZWFyOiBmdW5jdGlvbihwKXsKCQlyZXR1cm4gcDsKCX0KCn0pOwoKRnguVHJhbnNpdGlvbnMuZXh0ZW5kID0gZnVuY3Rpb24odHJhbnNpdGlvbnMpewoJZm9yICh2YXIgdHJhbnNpdGlvbiBpbiB0cmFuc2l0aW9ucyl7CgkJRnguVHJhbnNpdGlvbnNbdHJhbnNpdGlvbl0gPSBuZXcgRnguVHJhbnNpdGlvbih0cmFuc2l0aW9uc1t0cmFuc2l0aW9uXSk7CgkJLypjb21wYXRpYmlsaXR5Ki8KCQlGeC5UcmFuc2l0aW9ucy5jb21wYXQodHJhbnNpdGlvbik7CgkJLyplbmQgY29tcGF0aWJpbGl0eSovCgl9Cn07CgovKmNvbXBhdGliaWxpdHkqLwoKRnguVHJhbnNpdGlvbnMuY29tcGF0ID0gZnVuY3Rpb24odHJhbnNpdGlvbil7CglbJ0luJywgJ091dCcsICdJbk91dCddLmVhY2goZnVuY3Rpb24oZWFzZVR5cGUpewoJCUZ4LlRyYW5zaXRpb25zW3RyYW5zaXRpb24udG9Mb3dlckNhc2UoKSArIGVhc2VUeXBlXSA9IEZ4LlRyYW5zaXRpb25zW3RyYW5zaXRpb25dWydlYXNlJyArIGVhc2VUeXBlXTsKCX0pOwp9OwoKLyplbmQgY29tcGF0aWJpbGl0eSovCgpGeC5UcmFuc2l0aW9ucy5leHRlbmQoewoKCS8qCglQcm9wZXJ0eTogUXVhZAoJCWRpc3BsYXlzIGEgcXVhZHJhdGljIHRyYW5zaXRpb24uIE11c3QgYmUgdXNlZCBhcyBRdWFkLmVhc2VJbiBvciBRdWFkLmVhc2VPdXQgb3IgUXVhZC5lYXNlSW5PdXQKCglHcmFwaDoKCQkoc2VlIFF1YWQucG5nKQoJKi8KCgkvL2F1dG8gZ2VuZXJhdGVkCgoJLyoKCVByb3BlcnR5OiBDdWJpYwoJCWRpc3BsYXlzIGEgY3ViaWN1bGFyIHRyYW5zaXRpb24uIE11c3QgYmUgdXNlZCBhcyBDdWJpYy5lYXNlSW4gb3IgQ3ViaWMuZWFzZU91dCBvciBDdWJpYy5lYXNlSW5PdXQKCglHcmFwaDoKCQkoc2VlIEN1YmljLnBuZykKCSovCgoJLy9hdXRvIGdlbmVyYXRlZAoKCS8qCglQcm9wZXJ0eTogUXVhcnQKCQlkaXNwbGF5cyBhIHF1YXJ0ZXRpYyB0cmFuc2l0aW9uLiBNdXN0IGJlIHVzZWQgYXMgUXVhcnQuZWFzZUluIG9yIFF1YXJ0LmVhc2VPdXQgb3IgUXVhcnQuZWFzZUluT3V0CgoJR3JhcGg6CgkJKHNlZSBRdWFydC5wbmcpCgkqLwoKCS8vYXV0byBnZW5lcmF0ZWQKCgkvKgoJUHJvcGVydHk6IFF1aW50CgkJZGlzcGxheXMgYSBxdWludGljIHRyYW5zaXRpb24uIE11c3QgYmUgdXNlZCBhcyBRdWludC5lYXNlSW4gb3IgUXVpbnQuZWFzZU91dCBvciBRdWludC5lYXNlSW5PdXQKCglHcmFwaDoKCQkoc2VlIFF1aW50LnBuZykKCSovCgoJLy9hdXRvIGdlbmVyYXRlZAoKCS8qCglQcm9wZXJ0eTogUG93CgkJVXNlZCB0byBnZW5lcmF0ZSBRdWFkLCBDdWJpYywgUXVhcnQgYW5kIFF1aW50LgoJCUJ5IGRlZmF1bHQgaXMgcF42LgoKCUdyYXBoOgoJCShzZWUgUG93LnBuZykKCSovCgoJUG93OiBmdW5jdGlvbihwLCB4KXsKCQlyZXR1cm4gTWF0aC5wb3cocCwgeFswXSB8fCA2KTsKCX0sCgoJLyoKCVByb3BlcnR5OiBFeHBvCgkJZGlzcGxheXMgYSBleHBvbmVudGlhbCB0cmFuc2l0aW9uLiBNdXN0IGJlIHVzZWQgYXMgRXhwby5lYXNlSW4gb3IgRXhwby5lYXNlT3V0IG9yIEV4cG8uZWFzZUluT3V0CgoJR3JhcGg6CgkJKHNlZSBFeHBvLnBuZykKCSovCgoJRXhwbzogZnVuY3Rpb24ocCl7CgkJcmV0dXJuIE1hdGgucG93KDIsIDggKiAocCAtIDEpKTsKCX0sCgoJLyoKCVByb3BlcnR5OiBDaXJjCgkJZGlzcGxheXMgYSBjaXJjdWxhciB0cmFuc2l0aW9uLiBNdXN0IGJlIHVzZWQgYXMgQ2lyYy5lYXNlSW4gb3IgQ2lyYy5lYXNlT3V0IG9yIENpcmMuZWFzZUluT3V0CgoJR3JhcGg6CgkJKHNlZSBDaXJjLnBuZykKCSovCgoJQ2lyYzogZnVuY3Rpb24ocCl7CgkJcmV0dXJuIDEgLSBNYXRoLnNpbihNYXRoLmFjb3MocCkpOwoJfSwKCgkvKgoJUHJvcGVydHk6IFNpbmUKCQlkaXNwbGF5cyBhIHNpbmVvdXNpZGFsIHRyYW5zaXRpb24uIE11c3QgYmUgdXNlZCBhcyBTaW5lLmVhc2VJbiBvciBTaW5lLmVhc2VPdXQgb3IgU2luZS5lYXNlSW5PdXQKCglHcmFwaDoKCQkoc2VlIFNpbmUucG5nKQoJKi8KCglTaW5lOiBmdW5jdGlvbihwKXsKCQlyZXR1cm4gMSAtIE1hdGguc2luKCgxIC0gcCkgKiBNYXRoLlBJIC8gMik7Cgl9LAoKCS8qCglQcm9wZXJ0eTogQmFjawoJCW1ha2VzIHRoZSB0cmFuc2l0aW9uIGdvIGJhY2ssIHRoZW4gYWxsIGZvcnRoLiBNdXN0IGJlIHVzZWQgYXMgQmFjay5lYXNlSW4gb3IgQmFjay5lYXNlT3V0IG9yIEJhY2suZWFzZUluT3V0CgoJR3JhcGg6CgkJKHNlZSBCYWNrLnBuZykKCSovCgoJQmFjazogZnVuY3Rpb24ocCwgeCl7CgkJeCA9IHhbMF0gfHwgMS42MTg7CgkJcmV0dXJuIE1hdGgucG93KHAsIDIpICogKCh4ICsgMSkgKiBwIC0geCk7Cgl9LAoKCS8qCglQcm9wZXJ0eTogQm91bmNlCgkJbWFrZXMgdGhlIHRyYW5zaXRpb24gYm91bmN5LiBNdXN0IGJlIHVzZWQgYXMgQm91bmNlLmVhc2VJbiBvciBCb3VuY2UuZWFzZU91dCBvciBCb3VuY2UuZWFzZUluT3V0CgoJR3JhcGg6CgkJKHNlZSBCb3VuY2UucG5nKQoJKi8KCglCb3VuY2U6IGZ1bmN0aW9uKHApewoJCXZhciB2YWx1ZTsKCQlmb3IgKHZhciBhID0gMCwgYiA9IDE7IDE7IGEgKz0gYiwgYiAvPSAyKXsKCQkJaWYgKHAgPj0gKDcgLSA0ICogYSkgLyAxMSl7CgkJCQl2YWx1ZSA9IC0gTWF0aC5wb3coKDExIC0gNiAqIGEgLSAxMSAqIHApIC8gNCwgMikgKyBiICogYjsKCQkJCWJyZWFrOwoJCQl9CgkJfQoJCXJldHVybiB2YWx1ZTsKCX0sCgoJLyoKCVByb3BlcnR5OiBFbGFzdGljCgkJRWxhc3RpYyBjdXJ2ZS4gTXVzdCBiZSB1c2VkIGFzIEVsYXN0aWMuZWFzZUluIG9yIEVsYXN0aWMuZWFzZU91dCBvciBFbGFzdGljLmVhc2VJbk91dAoKCUdyYXBoOgoJCShzZWUgRWxhc3RpYy5wbmcpCgkqLwoKCUVsYXN0aWM6IGZ1bmN0aW9uKHAsIHgpewoJCXJldHVybiBNYXRoLnBvdygyLCAxMCAqIC0tcCkgKiBNYXRoLmNvcygyMCAqIHAgKiBNYXRoLlBJICogKHhbMF0gfHwgMSkgLyAzKTsKCX0KCn0pOwoKWydRdWFkJywgJ0N1YmljJywgJ1F1YXJ0JywgJ1F1aW50J10uZWFjaChmdW5jdGlvbih0cmFuc2l0aW9uLCBpKXsKCUZ4LlRyYW5zaXRpb25zW3RyYW5zaXRpb25dID0gbmV3IEZ4LlRyYW5zaXRpb24oZnVuY3Rpb24ocCl7CgkJcmV0dXJuIE1hdGgucG93KHAsIFtpICsgMl0pOwoJfSk7CgoJLypjb21wYXRpYmlsaXR5Ki8KCUZ4LlRyYW5zaXRpb25zLmNvbXBhdCh0cmFuc2l0aW9uKTsKCS8qZW5kIGNvbXBhdGliaWxpdHkqLwp9KTsKCi8qClNjcmlwdDogRHJhZy5CYXNlLmpzCglDb250YWlucyA8RHJhZy5CYXNlPiwgPEVsZW1lbnQubWFrZVJlc2l6YWJsZT4KCkxpY2Vuc2U6CglNSVQtc3R5bGUgbGljZW5zZS4KKi8KCnZhciBEcmFnID0ge307CgovKgpDbGFzczogRHJhZy5CYXNlCglNb2RpZnkgdHdvIGNzcyBwcm9wZXJ0aWVzIG9mIGFuIGVsZW1lbnQgYmFzZWQgb24gdGhlIHBvc2l0aW9uIG9mIHRoZSBtb3VzZS4KCk5vdGU6CglEcmFnLkJhc2UgcmVxdWlyZXMgYW4gWEhUTUwgZG9jdHlwZS4KCkFyZ3VtZW50czoKCWVsIC0gdGhlICQoZWxlbWVudCkgdG8gYXBwbHkgdGhlIHRyYW5zZm9ybWF0aW9ucyB0by4KCW9wdGlvbnMgLSBvcHRpb25hbC4gVGhlIG9wdGlvbnMgb2JqZWN0LgoKT3B0aW9uczoKCWhhbmRsZSAtIHRoZSAkKGVsZW1lbnQpIHRvIGFjdCBhcyB0aGUgaGFuZGxlIGZvciB0aGUgZHJhZ2dhYmxlIGVsZW1lbnQuIGRlZmF1bHRzIHRvIHRoZSAkKGVsZW1lbnQpIGl0c2VsZi4KCW1vZGlmaWVycyAtIGFuIG9iamVjdC4gc2VlIE1vZGlmaWVycyBCZWxvdy4KCWxpbWl0IC0gYW4gb2JqZWN0LCBzZWUgTGltaXQgYmVsb3cuCglncmlkIC0gb3B0aW9uYWwsIGRpc3RhbmNlIGluIHB4IGZvciBzbmFwLXRvLWdyaWQgZHJhZ2dpbmcKCXNuYXAgLSBvcHRpb25hbCwgdGhlIGRpc3RhbmNlIHlvdSBoYXZlIHRvIGRyYWcgYmVmb3JlIHRoZSBlbGVtZW50IHN0YXJ0cyB0byByZXNwb25kIHRvIHRoZSBkcmFnLiBkZWZhdWx0cyB0byBmYWxzZQoKCW1vZGlmaWVyczoKCQl4IC0gc3RyaW5nLCB0aGUgc3R5bGUgeW91IHdhbnQgdG8gbW9kaWZ5IHdoZW4gdGhlIG1vdXNlIG1vdmVzIGluIGFuIGhvcml6b250YWwgZGlyZWN0aW9uLiBkZWZhdWx0cyB0byAnbGVmdCcKCQl5IC0gc3RyaW5nLCB0aGUgc3R5bGUgeW91IHdhbnQgdG8gbW9kaWZ5IHdoZW4gdGhlIG1vdXNlIG1vdmVzIGluIGEgdmVydGljYWwgZGlyZWN0aW9uLiBkZWZhdWx0cyB0byAndG9wJwoKCWxpbWl0OgoJCXggLSBhcnJheSB3aXRoIHN0YXJ0IGFuZCBlbmQgbGltaXQgcmVsYXRpdmUgdG8gbW9kaWZpZXJzLngKCQl5IC0gYXJyYXkgd2l0aCBzdGFydCBhbmQgZW5kIGxpbWl0IHJlbGF0aXZlIHRvIG1vZGlmaWVycy55CgpFdmVudHM6CglvblN0YXJ0IC0gb3B0aW9uYWwsIGZ1bmN0aW9uIHRvIGV4ZWN1dGUgd2hlbiB0aGUgdXNlciBzdGFydHMgdG8gZHJhZyAob24gbW91c2Vkb3duKTsKCW9uQ29tcGxldGUgLSBvcHRpb25hbCwgZnVuY3Rpb24gdG8gZXhlY3V0ZSB3aGVuIHRoZSB1c2VyIGNvbXBsZXRlcyB0aGUgZHJhZy4KCW9uRHJhZyAtIG9wdGlvbmFsLCBmdW5jdGlvbiB0byBleGVjdXRlIGF0IGV2ZXJ5IHN0ZXAgb2YgdGhlIGRyYWcKKi8KCkRyYWcuQmFzZSA9IG5ldyBDbGFzcyh7CgoJb3B0aW9uczogewoJCWhhbmRsZTogZmFsc2UsCgkJdW5pdDogJ3B4JywKCQlvblN0YXJ0OiBDbGFzcy5lbXB0eSwKCQlvbkJlZm9yZVN0YXJ0OiBDbGFzcy5lbXB0eSwKCQlvbkNvbXBsZXRlOiBDbGFzcy5lbXB0eSwKCQlvblNuYXA6IENsYXNzLmVtcHR5LAoJCW9uRHJhZzogQ2xhc3MuZW1wdHksCgkJbGltaXQ6IGZhbHNlLAoJCW1vZGlmaWVyczoge3g6ICdsZWZ0JywgeTogJ3RvcCd9LAoJCWdyaWQ6IGZhbHNlLAoJCXNuYXA6IDYKCX0sCgoJaW5pdGlhbGl6ZTogZnVuY3Rpb24oZWwsIG9wdGlvbnMpewoJCXRoaXMuc2V0T3B0aW9ucyhvcHRpb25zKTsKCQl0aGlzLmVsZW1lbnQgPSAkKGVsKTsKCQl0aGlzLmhhbmRsZSA9ICQodGhpcy5vcHRpb25zLmhhbmRsZSkgfHwgdGhpcy5lbGVtZW50OwoJCXRoaXMubW91c2UgPSB7J25vdyc6IHt9LCAncG9zJzoge319OwoJCXRoaXMudmFsdWUgPSB7J3N0YXJ0Jzoge30sICdub3cnOiB7fX07CgkJdGhpcy5ib3VuZCA9IHsKCQkJJ3N0YXJ0JzogdGhpcy5zdGFydC5iaW5kV2l0aEV2ZW50KHRoaXMpLAoJCQknY2hlY2snOiB0aGlzLmNoZWNrLmJpbmRXaXRoRXZlbnQodGhpcyksCgkJCSdkcmFnJzogdGhpcy5kcmFnLmJpbmRXaXRoRXZlbnQodGhpcyksCgkJCSdzdG9wJzogdGhpcy5zdG9wLmJpbmQodGhpcykKCQl9OwoJCXRoaXMuYXR0YWNoKCk7CgkJaWYgKHRoaXMub3B0aW9ucy5pbml0aWFsaXplKSB0aGlzLm9wdGlvbnMuaW5pdGlhbGl6ZS5jYWxsKHRoaXMpOwoJfSwKCglhdHRhY2g6IGZ1bmN0aW9uKCl7CgkJdGhpcy5oYW5kbGUuYWRkRXZlbnQoJ21vdXNlZG93bicsIHRoaXMuYm91bmQuc3RhcnQpOwoJCXJldHVybiB0aGlzOwoJfSwKCglkZXRhY2g6IGZ1bmN0aW9uKCl7CgkJdGhpcy5oYW5kbGUucmVtb3ZlRXZlbnQoJ21vdXNlZG93bicsIHRoaXMuYm91bmQuc3RhcnQpOwoJCXJldHVybiB0aGlzOwoJfSwKCglzdGFydDogZnVuY3Rpb24oZXZlbnQpewoJCXRoaXMuZmlyZUV2ZW50KCdvbkJlZm9yZVN0YXJ0JywgdGhpcy5lbGVtZW50KTsKCQl0aGlzLm1vdXNlLnN0YXJ0ID0gZXZlbnQucGFnZTsKCQl2YXIgbGltaXQgPSB0aGlzLm9wdGlvbnMubGltaXQ7CgkJdGhpcy5saW1pdCA9IHsneCc6IFtdLCAneSc6IFtdfTsKCQlmb3IgKHZhciB6IGluIHRoaXMub3B0aW9ucy5tb2RpZmllcnMpewoJCQlpZiAoIXRoaXMub3B0aW9ucy5tb2RpZmllcnNbel0pIGNvbnRpbnVlOwoJCQl0aGlzLnZhbHVlLm5vd1t6XSA9IHRoaXMuZWxlbWVudC5nZXRTdHlsZSh0aGlzLm9wdGlvbnMubW9kaWZpZXJzW3pdKS50b0ludCgpOwoJCQl0aGlzLm1vdXNlLnBvc1t6XSA9IGV2ZW50LnBhZ2Vbel0gLSB0aGlzLnZhbHVlLm5vd1t6XTsKCQkJaWYgKGxpbWl0ICYmIGxpbWl0W3pdKXsKCQkJCWZvciAodmFyIGkgPSAwOyBpIDwgMjsgaSsrKXsKCQkJCQlpZiAoJGNoayhsaW1pdFt6XVtpXSkpIHRoaXMubGltaXRbel1baV0gPSAoJHR5cGUobGltaXRbel1baV0pID09ICdmdW5jdGlvbicpID8gbGltaXRbel1baV0oKSA6IGxpbWl0W3pdW2ldOwoJCQkJfQoJCQl9CgkJfQoJCWlmICgkdHlwZSh0aGlzLm9wdGlvbnMuZ3JpZCkgPT0gJ251bWJlcicpIHRoaXMub3B0aW9ucy5ncmlkID0geyd4JzogdGhpcy5vcHRpb25zLmdyaWQsICd5JzogdGhpcy5vcHRpb25zLmdyaWR9OwoJCWRvY3VtZW50LmFkZExpc3RlbmVyKCdtb3VzZW1vdmUnLCB0aGlzLmJvdW5kLmNoZWNrKTsKCQlkb2N1bWVudC5hZGRMaXN0ZW5lcignbW91c2V1cCcsIHRoaXMuYm91bmQuc3RvcCk7CgkJdGhpcy5maXJlRXZlbnQoJ29uU3RhcnQnLCB0aGlzLmVsZW1lbnQpOwoJCWV2ZW50LnN0b3AoKTsKCX0sCgoJY2hlY2s6IGZ1bmN0aW9uKGV2ZW50KXsKCQl2YXIgZGlzdGFuY2UgPSBNYXRoLnJvdW5kKE1hdGguc3FydChNYXRoLnBvdyhldmVudC5wYWdlLnggLSB0aGlzLm1vdXNlLnN0YXJ0LngsIDIpICsgTWF0aC5wb3coZXZlbnQucGFnZS55IC0gdGhpcy5tb3VzZS5zdGFydC55LCAyKSkpOwoJCWlmIChkaXN0YW5jZSA+IHRoaXMub3B0aW9ucy5zbmFwKXsKCQkJZG9jdW1lbnQucmVtb3ZlTGlzdGVuZXIoJ21vdXNlbW92ZScsIHRoaXMuYm91bmQuY2hlY2spOwoJCQlkb2N1bWVudC5hZGRMaXN0ZW5lcignbW91c2Vtb3ZlJywgdGhpcy5ib3VuZC5kcmFnKTsKCQkJdGhpcy5kcmFnKGV2ZW50KTsKCQkJdGhpcy5maXJlRXZlbnQoJ29uU25hcCcsIHRoaXMuZWxlbWVudCk7CgkJfQoJCWV2ZW50LnN0b3AoKTsKCX0sCgoJZHJhZzogZnVuY3Rpb24oZXZlbnQpewoJCXRoaXMub3V0ID0gZmFsc2U7CgkJdGhpcy5tb3VzZS5ub3cgPSBldmVudC5wYWdlOwoJCWZvciAodmFyIHogaW4gdGhpcy5vcHRpb25zLm1vZGlmaWVycyl7CgkJCWlmICghdGhpcy5vcHRpb25zLm1vZGlmaWVyc1t6XSkgY29udGludWU7CgkJCXRoaXMudmFsdWUubm93W3pdID0gdGhpcy5tb3VzZS5ub3dbel0gLSB0aGlzLm1vdXNlLnBvc1t6XTsKCQkJaWYgKHRoaXMubGltaXRbel0pewoJCQkJaWYgKCRjaGsodGhpcy5saW1pdFt6XVsxXSkgJiYgKHRoaXMudmFsdWUubm93W3pdID4gdGhpcy5saW1pdFt6XVsxXSkpewoJCQkJCXRoaXMudmFsdWUubm93W3pdID0gdGhpcy5saW1pdFt6XVsxXTsKCQkJCQl0aGlzLm91dCA9IHRydWU7CgkJCQl9IGVsc2UgaWYgKCRjaGsodGhpcy5saW1pdFt6XVswXSkgJiYgKHRoaXMudmFsdWUubm93W3pdIDwgdGhpcy5saW1pdFt6XVswXSkpewoJCQkJCXRoaXMudmFsdWUubm93W3pdID0gdGhpcy5saW1pdFt6XVswXTsKCQkJCQl0aGlzLm91dCA9IHRydWU7CgkJCQl9CgkJCX0KCQkJaWYgKHRoaXMub3B0aW9ucy5ncmlkW3pdKSB0aGlzLnZhbHVlLm5vd1t6XSAtPSAodGhpcy52YWx1ZS5ub3dbel0gJSB0aGlzLm9wdGlvbnMuZ3JpZFt6XSk7CgkJCXRoaXMuZWxlbWVudC5zZXRTdHlsZSh0aGlzLm9wdGlvbnMubW9kaWZpZXJzW3pdLCB0aGlzLnZhbHVlLm5vd1t6XSArIHRoaXMub3B0aW9ucy51bml0KTsKCQl9CgkJdGhpcy5maXJlRXZlbnQoJ29uRHJhZycsIHRoaXMuZWxlbWVudCk7CgkJZXZlbnQuc3RvcCgpOwoJfSwKCglzdG9wOiBmdW5jdGlvbigpewoJCWRvY3VtZW50LnJlbW92ZUxpc3RlbmVyKCdtb3VzZW1vdmUnLCB0aGlzLmJvdW5kLmNoZWNrKTsKCQlkb2N1bWVudC5yZW1vdmVMaXN0ZW5lcignbW91c2Vtb3ZlJywgdGhpcy5ib3VuZC5kcmFnKTsKCQlkb2N1bWVudC5yZW1vdmVMaXN0ZW5lcignbW91c2V1cCcsIHRoaXMuYm91bmQuc3RvcCk7CgkJdGhpcy5maXJlRXZlbnQoJ29uQ29tcGxldGUnLCB0aGlzLmVsZW1lbnQpOwoJfQoKfSk7CgpEcmFnLkJhc2UuaW1wbGVtZW50KG5ldyBFdmVudHMsIG5ldyBPcHRpb25zKTsKCi8qCkNsYXNzOiBFbGVtZW50CglDdXN0b20gY2xhc3MgdG8gYWxsb3cgYWxsIG9mIGl0cyBtZXRob2RzIHRvIGJlIHVzZWQgd2l0aCBhbnkgRE9NIGVsZW1lbnQgdmlhIHRoZSBkb2xsYXIgZnVuY3Rpb24gPCQ+LgoqLwoKRWxlbWVudC5leHRlbmQoewoKCS8qCglQcm9wZXJ0eTogbWFrZVJlc2l6YWJsZQoJCU1ha2VzIGFuIGVsZW1lbnQgcmVzaXphYmxlIChieSBkcmFnZ2luZykgd2l0aCB0aGUgc3VwcGxpZWQgb3B0aW9ucy4KCglBcmd1bWVudHM6CgkJb3B0aW9ucyAtIHNlZSA8RHJhZy5CYXNlPiBmb3IgYWNjZXB0YWJsZSBvcHRpb25zLgoJKi8KCgltYWtlUmVzaXphYmxlOiBmdW5jdGlvbihvcHRpb25zKXsKCQlyZXR1cm4gbmV3IERyYWcuQmFzZSh0aGlzLCAkbWVyZ2Uoe21vZGlmaWVyczoge3g6ICd3aWR0aCcsIHk6ICdoZWlnaHQnfX0sIG9wdGlvbnMpKTsKCX0KCn0pOwoKLyoKU2NyaXB0OiBEcmFnLk1vdmUuanMKCUNvbnRhaW5zIDxEcmFnLk1vdmU+LCA8RWxlbWVudC5tYWtlRHJhZ2dhYmxlPgoKTGljZW5zZToKCU1JVC1zdHlsZSBsaWNlbnNlLgoqLwoKLyoKQ2xhc3M6IERyYWcuTW92ZQoJRXh0ZW5kcyA8RHJhZy5CYXNlPiwgaGFzIGFkZGl0aW9uYWwgZnVuY3Rpb25hbGl0eSBmb3IgZHJhZ2dpbmcgYW4gZWxlbWVudCwgc3VwcG9ydCBzbmFwcGluZyBhbmQgZHJvcHBhYmxlcy4KCURyYWcubW92ZSBzdXBwb3J0cyBlaXRoZXIgcG9zaXRpb24gYWJzb2x1dGUgb3IgcmVsYXRpdmUuIElmIG5vIHBvc2l0aW9uIGlzIGZvdW5kLCBhYnNvbHV0ZSB3aWxsIGJlIHNldC4KCUluaGVyaXRzIG1ldGhvZHMsIHByb3BlcnRpZXMsIG9wdGlvbnMgYW5kIGV2ZW50cyBmcm9tIDxEcmFnLkJhc2U+LgoKTm90ZToKCURyYWcuTW92ZSByZXF1aXJlcyBhbiBYSFRNTCBkb2N0eXBlLgoKQXJndW1lbnRzOgoJZWwgLSB0aGUgJChlbGVtZW50KSB0byBhcHBseSB0aGUgZHJhZyB0by4KCW9wdGlvbnMgLSBvcHRpb25hbC4gc2VlIE9wdGlvbnMgYmVsb3cuCgpPcHRpb25zOgoJYWxsIHRoZSBkcmFnLkJhc2Ugb3B0aW9ucywgcGx1czoKCWNvbnRhaW5lciAtIGFuIGVsZW1lbnQsIHdpbGwgZmlsbCBhdXRvbWF0aWNhbGx5IGxpbWl0aW5nIG9wdGlvbnMgYmFzZWQgb24gdGhlICQoZWxlbWVudCkgc2l6ZSBhbmQgcG9zaXRpb24uIGRlZmF1bHRzIHRvIGZhbHNlIChubyBsaW1pdGluZykKCWRyb3BwYWJsZXMgLSBhbiBhcnJheSBvZiBlbGVtZW50cyB5b3UgY2FuIGRyb3AgeW91ciBkcmFnZ2FibGUgdG8uCglvdmVyZmxvd24gLSBhbiBhcnJheSBvZiBuZXN0ZWQgc2Nyb2xsaW5nIGNvbnRhaW5lcnMsIHNlZSBFbGVtZW50OjpnZXRQb3NpdGlvbgoqLwoKRHJhZy5Nb3ZlID0gRHJhZy5CYXNlLmV4dGVuZCh7CgoJb3B0aW9uczogewoJCWRyb3BwYWJsZXM6IFtdLAoJCWNvbnRhaW5lcjogZmFsc2UsCgkJb3ZlcmZsb3duOiBbXQoJfSwKCglpbml0aWFsaXplOiBmdW5jdGlvbihlbCwgb3B0aW9ucyl7CgkJdGhpcy5zZXRPcHRpb25zKG9wdGlvbnMpOwoJCXRoaXMuZWxlbWVudCA9ICQoZWwpOwoJCXRoaXMuZHJvcHBhYmxlcyA9ICQkKHRoaXMub3B0aW9ucy5kcm9wcGFibGVzKTsKCQl0aGlzLmNvbnRhaW5lciA9ICQodGhpcy5vcHRpb25zLmNvbnRhaW5lcik7CgkJdGhpcy5wb3NpdGlvbiA9IHsnZWxlbWVudCc6IHRoaXMuZWxlbWVudC5nZXRTdHlsZSgncG9zaXRpb24nKSwgJ2NvbnRhaW5lcic6IGZhbHNlfTsKCQlpZiAodGhpcy5jb250YWluZXIpIHRoaXMucG9zaXRpb24uY29udGFpbmVyID0gdGhpcy5jb250YWluZXIuZ2V0U3R5bGUoJ3Bvc2l0aW9uJyk7CgkJaWYgKCFbJ3JlbGF0aXZlJywgJ2Fic29sdXRlJywgJ2ZpeGVkJ10uY29udGFpbnModGhpcy5wb3NpdGlvbi5lbGVtZW50KSkgdGhpcy5wb3NpdGlvbi5lbGVtZW50ID0gJ2Fic29sdXRlJzsKCQl2YXIgdG9wID0gdGhpcy5lbGVtZW50LmdldFN0eWxlKCd0b3AnKS50b0ludCgpOwoJCXZhciBsZWZ0ID0gdGhpcy5lbGVtZW50LmdldFN0eWxlKCdsZWZ0JykudG9JbnQoKTsKCQlpZiAodGhpcy5wb3NpdGlvbi5lbGVtZW50ID09ICdhYnNvbHV0ZScgJiYgIVsncmVsYXRpdmUnLCAnYWJzb2x1dGUnLCAnZml4ZWQnXS5jb250YWlucyh0aGlzLnBvc2l0aW9uLmNvbnRhaW5lcikpewoJCQl0b3AgPSAkY2hrKHRvcCkgPyB0b3AgOiB0aGlzLmVsZW1lbnQuZ2V0VG9wKHRoaXMub3B0aW9ucy5vdmVyZmxvd24pOwoJCQlsZWZ0ID0gJGNoayhsZWZ0KSA/IGxlZnQgOiB0aGlzLmVsZW1lbnQuZ2V0TGVmdCh0aGlzLm9wdGlvbnMub3ZlcmZsb3duKTsKCQl9IGVsc2UgewoJCQl0b3AgPSAkY2hrKHRvcCkgPyB0b3AgOiAwOwoJCQlsZWZ0ID0gJGNoayhsZWZ0KSA/IGxlZnQgOiAwOwoJCX0KCQl0aGlzLmVsZW1lbnQuc2V0U3R5bGVzKHsndG9wJzogdG9wLCAnbGVmdCc6IGxlZnQsICdwb3NpdGlvbic6IHRoaXMucG9zaXRpb24uZWxlbWVudH0pOwoJCXRoaXMucGFyZW50KHRoaXMuZWxlbWVudCk7Cgl9LAoKCXN0YXJ0OiBmdW5jdGlvbihldmVudCl7CgkJdGhpcy5vdmVyZWQgPSBudWxsOwoJCWlmICh0aGlzLmNvbnRhaW5lcil7CgkJCXZhciBjb250ID0gdGhpcy5jb250YWluZXIuZ2V0Q29vcmRpbmF0ZXMoKTsKCQkJdmFyIGVsID0gdGhpcy5lbGVtZW50LmdldENvb3JkaW5hdGVzKCk7CgkJCWlmICh0aGlzLnBvc2l0aW9uLmVsZW1lbnQgPT0gJ2Fic29sdXRlJyAmJiAhWydyZWxhdGl2ZScsICdhYnNvbHV0ZScsICdmaXhlZCddLmNvbnRhaW5zKHRoaXMucG9zaXRpb24uY29udGFpbmVyKSl7CgkJCQl0aGlzLm9wdGlvbnMubGltaXQgPSB7CgkJCQkJJ3gnOiBbY29udC5sZWZ0LCBjb250LnJpZ2h0IC0gZWwud2lkdGhdLAoJCQkJCSd5JzogW2NvbnQudG9wLCBjb250LmJvdHRvbSAtIGVsLmhlaWdodF0KCQkJCX07CgkJCX0gZWxzZSB7CgkJCQl0aGlzLm9wdGlvbnMubGltaXQgPSB7CgkJCQkJJ3knOiBbMCwgY29udC5oZWlnaHQgLSBlbC5oZWlnaHRdLAoJCQkJCSd4JzogWzAsIGNvbnQud2lkdGggLSBlbC53aWR0aF0KCQkJCX07CgkJCX0KCQl9CgkJdGhpcy5wYXJlbnQoZXZlbnQpOwoJfSwKCglkcmFnOiBmdW5jdGlvbihldmVudCl7CgkJdGhpcy5wYXJlbnQoZXZlbnQpOwoJCXZhciBvdmVyZWQgPSB0aGlzLm91dCA/IGZhbHNlIDogdGhpcy5kcm9wcGFibGVzLmZpbHRlcih0aGlzLmNoZWNrQWdhaW5zdCwgdGhpcykuZ2V0TGFzdCgpOwoJCWlmICh0aGlzLm92ZXJlZCAhPSBvdmVyZWQpewoJCQlpZiAodGhpcy5vdmVyZWQpIHRoaXMub3ZlcmVkLmZpcmVFdmVudCgnbGVhdmUnLCBbdGhpcy5lbGVtZW50LCB0aGlzXSk7CgkJCXRoaXMub3ZlcmVkID0gb3ZlcmVkID8gb3ZlcmVkLmZpcmVFdmVudCgnb3ZlcicsIFt0aGlzLmVsZW1lbnQsIHRoaXNdKSA6IG51bGw7CgkJfQoJCXJldHVybiB0aGlzOwoJfSwKCgljaGVja0FnYWluc3Q6IGZ1bmN0aW9uKGVsKXsKCQllbCA9IGVsLmdldENvb3JkaW5hdGVzKHRoaXMub3B0aW9ucy5vdmVyZmxvd24pOwoJCXZhciBub3cgPSB0aGlzLm1vdXNlLm5vdzsKCQlyZXR1cm4gKG5vdy54ID4gZWwubGVmdCAmJiBub3cueCA8IGVsLnJpZ2h0ICYmIG5vdy55IDwgZWwuYm90dG9tICYmIG5vdy55ID4gZWwudG9wKTsKCX0sCgoJc3RvcDogZnVuY3Rpb24oKXsKCQlpZiAodGhpcy5vdmVyZWQgJiYgIXRoaXMub3V0KSB0aGlzLm92ZXJlZC5maXJlRXZlbnQoJ2Ryb3AnLCBbdGhpcy5lbGVtZW50LCB0aGlzXSk7CgkJZWxzZSB0aGlzLmVsZW1lbnQuZmlyZUV2ZW50KCdlbXB0eWRyb3AnLCB0aGlzKTsKCQl0aGlzLnBhcmVudCgpOwoJCXJldHVybiB0aGlzOwoJfQoKfSk7CgovKgpDbGFzczogRWxlbWVudAoJQ3VzdG9tIGNsYXNzIHRvIGFsbG93IGFsbCBvZiBpdHMgbWV0aG9kcyB0byBiZSB1c2VkIHdpdGggYW55IERPTSBlbGVtZW50IHZpYSB0aGUgZG9sbGFyIGZ1bmN0aW9uIDwkPi4KKi8KCkVsZW1lbnQuZXh0ZW5kKHsKCgkvKgoJUHJvcGVydHk6IG1ha2VEcmFnZ2FibGUKCQlNYWtlcyBhbiBlbGVtZW50IGRyYWdnYWJsZSB3aXRoIHRoZSBzdXBwbGllZCBvcHRpb25zLgoKCUFyZ3VtZW50czoKCQlvcHRpb25zIC0gc2VlIDxEcmFnLk1vdmU+IGFuZCA8RHJhZy5CYXNlPiBmb3IgYWNjZXB0YWJsZSBvcHRpb25zLgoJKi8KCgltYWtlRHJhZ2dhYmxlOiBmdW5jdGlvbihvcHRpb25zKXsKCQlyZXR1cm4gbmV3IERyYWcuTW92ZSh0aGlzLCBvcHRpb25zKTsKCX0KCn0pOwoKLyoKU2NyaXB0OiBYSFIuanMKCUNvbnRhaW5zIHRoZSBiYXNpYyBYTUxIdHRwUmVxdWVzdCBDbGFzcyBXcmFwcGVyLgoKTGljZW5zZToKCU1JVC1zdHlsZSBsaWNlbnNlLgoqLwoKLyoKQ2xhc3M6IFhIUgoJQmFzaWMgWE1MSHR0cFJlcXVlc3QgV3JhcHBlci4KCkFyZ3VtZW50czoKCW9wdGlvbnMgLSBhbiBvYmplY3Qgd2l0aCBvcHRpb25zIG5hbWVzIGFzIGtleXMuIFNlZSBvcHRpb25zIGJlbG93LgoKT3B0aW9uczoKCW1ldGhvZCAtICdwb3N0JyBvciAnZ2V0JyAtIHRoZSBwcm90b2NvbCBmb3IgdGhlIHJlcXVlc3Q7IG9wdGlvbmFsLCBkZWZhdWx0cyB0byAncG9zdCcuCglhc3luYyAtIGJvb2xlYW46IGFzeW5jaHJvbm91cyBvcHRpb247IHRydWUgdXNlcyBhc3luY2hyb25vdXMgcmVxdWVzdHMuIERlZmF1bHRzIHRvIHRydWUuCgllbmNvZGluZyAtIHRoZSBlbmNvZGluZywgZGVmYXVsdHMgdG8gdXRmLTguCglhdXRvQ2FuY2VsIC0gY2FuY2VscyB0aGUgYWxyZWFkeSBydW5uaW5nIHJlcXVlc3QgaWYgYW5vdGhlciBvbmUgaXMgc2VudC4gZGVmYXVsdHMgdG8gZmFsc2UuCgloZWFkZXJzIC0gYWNjZXB0cyBhbiBvYmplY3QsIHRoYXQgd2lsbCBiZSBzZXQgdG8gcmVxdWVzdCBoZWFkZXJzLgoKRXZlbnRzOgoJb25SZXF1ZXN0IC0gZnVuY3Rpb24gdG8gZXhlY3V0ZSB3aGVuIHRoZSBYSFIgcmVxdWVzdCBpcyBmaXJlZC4KCW9uU3VjY2VzcyAtIGZ1bmN0aW9uIHRvIGV4ZWN1dGUgd2hlbiB0aGUgWEhSIHJlcXVlc3QgY29tcGxldGVzLgoJb25TdGF0ZUNoYW5nZSAtIGZ1bmN0aW9uIHRvIGV4ZWN1dGUgd2hlbiB0aGUgc3RhdGUgb2YgdGhlIFhNTEh0dHBSZXF1ZXN0IGNoYW5nZXMuCglvbkZhaWx1cmUgLSBmdW5jdGlvbiB0byBleGVjdXRlIHdoZW4gdGhlIHN0YXRlIG9mIHRoZSBYTUxIdHRwUmVxdWVzdCBjaGFuZ2VzLgoKUHJvcGVydGllczoKCXJ1bm5pbmcgLSB0cnVlIGlmIHRoZSByZXF1ZXN0IGlzIHJ1bm5pbmcuCglyZXNwb25zZSAtIG9iamVjdCwgdGV4dCBhbmQgeG1sIGFzIGtleXMuIFlvdSBjYW4gYWNjZXNzIHRoaXMgcHJvcGVydHkgaW4gdGhlIG9uU3VjY2VzcyBldmVudC4KCkV4YW1wbGU6Cgk+dmFyIG15WEhSID0gbmV3IFhIUih7bWV0aG9kOiAnZ2V0J30pLnNlbmQoJ2h0dHA6Ly9zaXRlLmNvbS9yZXF1ZXN0SGFuZGxlci5waHAnLCAnbmFtZT1qb2huJmxhc3RuYW1lPWRvcmlhbicpOwoqLwoKdmFyIFhIUiA9IG5ldyBDbGFzcyh7CgoJb3B0aW9uczogewoJCW1ldGhvZDogJ3Bvc3QnLAoJCWFzeW5jOiB0cnVlLAoJCW9uUmVxdWVzdDogQ2xhc3MuZW1wdHksCgkJb25TdWNjZXNzOiBDbGFzcy5lbXB0eSwKCQlvbkZhaWx1cmU6IENsYXNzLmVtcHR5LAoJCXVybEVuY29kZWQ6IHRydWUsCgkJZW5jb2Rpbmc6ICd1dGYtOCcsCgkJYXV0b0NhbmNlbDogZmFsc2UsCgkJaGVhZGVyczoge30KCX0sCgoJc2V0VHJhbnNwb3J0OiBmdW5jdGlvbigpewoJCXRoaXMudHJhbnNwb3J0ID0gKHdpbmRvdy5YTUxIdHRwUmVxdWVzdCkgPyBuZXcgWE1MSHR0cFJlcXVlc3QoKSA6ICh3aW5kb3cuaWUgPyBuZXcgQWN0aXZlWE9iamVjdCgnTWljcm9zb2Z0LlhNTEhUVFAnKSA6IGZhbHNlKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJaW5pdGlhbGl6ZTogZnVuY3Rpb24ob3B0aW9ucyl7CgkJdGhpcy5zZXRUcmFuc3BvcnQoKS5zZXRPcHRpb25zKG9wdGlvbnMpOwoJCXRoaXMub3B0aW9ucy5pc1N1Y2Nlc3MgPSB0aGlzLm9wdGlvbnMuaXNTdWNjZXNzIHx8IHRoaXMuaXNTdWNjZXNzOwoJCXRoaXMuaGVhZGVycyA9IHt9OwoJCWlmICh0aGlzLm9wdGlvbnMudXJsRW5jb2RlZCAmJiB0aGlzLm9wdGlvbnMubWV0aG9kID09ICdwb3N0Jyl7CgkJCXZhciBlbmNvZGluZyA9ICh0aGlzLm9wdGlvbnMuZW5jb2RpbmcpID8gJzsgY2hhcnNldD0nICsgdGhpcy5vcHRpb25zLmVuY29kaW5nIDogJyc7CgkJCXRoaXMuc2V0SGVhZGVyKCdDb250ZW50LXR5cGUnLCAnYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkJyArIGVuY29kaW5nKTsKCQl9CgkJaWYgKHRoaXMub3B0aW9ucy5pbml0aWFsaXplKSB0aGlzLm9wdGlvbnMuaW5pdGlhbGl6ZS5jYWxsKHRoaXMpOwoJfSwKCglvblN0YXRlQ2hhbmdlOiBmdW5jdGlvbigpewoJCWlmICh0aGlzLnRyYW5zcG9ydC5yZWFkeVN0YXRlICE9IDQgfHwgIXRoaXMucnVubmluZykgcmV0dXJuOwoJCXRoaXMucnVubmluZyA9IGZhbHNlOwoJCXZhciBzdGF0dXMgPSAwOwoJCXRyeSB7c3RhdHVzID0gdGhpcy50cmFuc3BvcnQuc3RhdHVzO30gY2F0Y2goZSl7fTsKCQlpZiAodGhpcy5vcHRpb25zLmlzU3VjY2Vzcy5jYWxsKHRoaXMsIHN0YXR1cykpIHRoaXMub25TdWNjZXNzKCk7CgkJZWxzZSB0aGlzLm9uRmFpbHVyZSgpOwoJCXRoaXMudHJhbnNwb3J0Lm9ucmVhZHlzdGF0ZWNoYW5nZSA9IENsYXNzLmVtcHR5OwoJfSwKCglpc1N1Y2Nlc3M6IGZ1bmN0aW9uKHN0YXR1cyl7CgkJcmV0dXJuICgoc3RhdHVzID49IDIwMCkgJiYgKHN0YXR1cyA8IDMwMCkpOwoJfSwKCglvblN1Y2Nlc3M6IGZ1bmN0aW9uKCl7CgkJdGhpcy5yZXNwb25zZSA9IHsKCQkJJ3RleHQnOiB0aGlzLnRyYW5zcG9ydC5yZXNwb25zZVRleHQsCgkJCSd4bWwnOiB0aGlzLnRyYW5zcG9ydC5yZXNwb25zZVhNTAoJCX07CgkJdGhpcy5maXJlRXZlbnQoJ29uU3VjY2VzcycsIFt0aGlzLnJlc3BvbnNlLnRleHQsIHRoaXMucmVzcG9uc2UueG1sXSk7CgkJdGhpcy5jYWxsQ2hhaW4oKTsKCX0sCgoJb25GYWlsdXJlOiBmdW5jdGlvbigpewoJCXRoaXMuZmlyZUV2ZW50KCdvbkZhaWx1cmUnLCB0aGlzLnRyYW5zcG9ydCk7Cgl9LAoKCS8qCglQcm9wZXJ0eTogc2V0SGVhZGVyCgkJQWRkL21vZGlmeSBhbiBoZWFkZXIgZm9yIHRoZSByZXF1ZXN0LiBJdCB3aWxsIG5vdCBvdmVycmlkZSBoZWFkZXJzIGZyb20gdGhlIG9wdGlvbnMuCgoJRXhhbXBsZToKCQk+dmFyIG15WGhyID0gbmV3IFhIUih1cmwsIHttZXRob2Q6ICdnZXQnLCBoZWFkZXJzOiB7J1gtUmVxdWVzdCc6ICdKU09OJ319KTsKCQk+bXlYaHIuc2V0SGVhZGVyKCdMYXN0LU1vZGlmaWVkJywnU2F0LCAxIEphbiAyMDA1IDA1OjAwOjAwIEdNVCcpOwoJKi8KCglzZXRIZWFkZXI6IGZ1bmN0aW9uKG5hbWUsIHZhbHVlKXsKCQl0aGlzLmhlYWRlcnNbbmFtZV0gPSB2YWx1ZTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJLyoKCVByb3BlcnR5OiBzZW5kCgkJT3BlbnMgdGhlIFhIUiBjb25uZWN0aW9uIGFuZCBzZW5kcyB0aGUgZGF0YS4gRGF0YSBoYXMgdG8gYmUgbnVsbCBvciBhIHN0cmluZy4KCglFeGFtcGxlOgoJCT52YXIgbXlYaHIgPSBuZXcgWEhSKHttZXRob2Q6ICdwb3N0J30pOwoJCT5teVhoci5zZW5kKHVybCwgcXVlcnlzdHJpbmcpOwoJCT4KCQk+dmFyIHN5bmNYaHIgPSBuZXcgWEhSKHthc3luYzogZmFsc2UsIG1ldGhvZDogJ3Bvc3QnfSk7CgkJPnN5bmNYaHIuc2VuZCh1cmwsIG51bGwpOwoJCT4KCSovCgoJc2VuZDogZnVuY3Rpb24odXJsLCBkYXRhKXsKCQlpZiAodGhpcy5vcHRpb25zLmF1dG9DYW5jZWwpIHRoaXMuY2FuY2VsKCk7CgkJZWxzZSBpZiAodGhpcy5ydW5uaW5nKSByZXR1cm4gdGhpczsKCQl0aGlzLnJ1bm5pbmcgPSB0cnVlOwoJCWlmIChkYXRhICYmIHRoaXMub3B0aW9ucy5tZXRob2QgPT0gJ2dldCcpewoJCQl1cmwgPSB1cmwgKyAodXJsLmNvbnRhaW5zKCc/JykgPyAnJicgOiAnPycpICsgZGF0YTsKCQkJZGF0YSA9IG51bGw7CgkJfQoJCXRoaXMudHJhbnNwb3J0Lm9wZW4odGhpcy5vcHRpb25zLm1ldGhvZC50b1VwcGVyQ2FzZSgpLCB1cmwsIHRoaXMub3B0aW9ucy5hc3luYyk7CgkJdGhpcy50cmFuc3BvcnQub25yZWFkeXN0YXRlY2hhbmdlID0gdGhpcy5vblN0YXRlQ2hhbmdlLmJpbmQodGhpcyk7CgkJaWYgKCh0aGlzLm9wdGlvbnMubWV0aG9kID09ICdwb3N0JykgJiYgdGhpcy50cmFuc3BvcnQub3ZlcnJpZGVNaW1lVHlwZSkgdGhpcy5zZXRIZWFkZXIoJ0Nvbm5lY3Rpb24nLCAnY2xvc2UnKTsKCQkkZXh0ZW5kKHRoaXMuaGVhZGVycywgdGhpcy5vcHRpb25zLmhlYWRlcnMpOwoJCWZvciAodmFyIHR5cGUgaW4gdGhpcy5oZWFkZXJzKSB0cnkge3RoaXMudHJhbnNwb3J0LnNldFJlcXVlc3RIZWFkZXIodHlwZSwgdGhpcy5oZWFkZXJzW3R5cGVdKTt9IGNhdGNoKGUpe307CgkJdGhpcy5maXJlRXZlbnQoJ29uUmVxdWVzdCcpOwoJCXRoaXMudHJhbnNwb3J0LnNlbmQoJHBpY2soZGF0YSwgbnVsbCkpOwoJCXJldHVybiB0aGlzOwoJfSwKCgkvKgoJUHJvcGVydHk6IGNhbmNlbAoJCUNhbmNlbHMgdGhlIHJ1bm5pbmcgcmVxdWVzdC4gTm8gZWZmZWN0IGlmIHRoZSByZXF1ZXN0IGlzIG5vdCBydW5uaW5nLgoKCUV4YW1wbGU6CgkJPnZhciBteVhociA9IG5ldyBYSFIoe21ldGhvZDogJ2dldCd9KS5zZW5kKHVybCk7CgkJPm15WGhyLmNhbmNlbCgpOwoJKi8KCgljYW5jZWw6IGZ1bmN0aW9uKCl7CgkJaWYgKCF0aGlzLnJ1bm5pbmcpIHJldHVybiB0aGlzOwoJCXRoaXMucnVubmluZyA9IGZhbHNlOwoJCXRoaXMudHJhbnNwb3J0LmFib3J0KCk7CgkJdGhpcy50cmFuc3BvcnQub25yZWFkeXN0YXRlY2hhbmdlID0gQ2xhc3MuZW1wdHk7CgkJdGhpcy5zZXRUcmFuc3BvcnQoKTsKCQl0aGlzLmZpcmVFdmVudCgnb25DYW5jZWwnKTsKCQlyZXR1cm4gdGhpczsKCX0KCn0pOwoKWEhSLmltcGxlbWVudChuZXcgQ2hhaW4sIG5ldyBFdmVudHMsIG5ldyBPcHRpb25zKTsKCi8qClNjcmlwdDogQWpheC5qcwoJQ29udGFpbnMgdGhlIDxBamF4PiBjbGFzcy4gQWxzbyBjb250YWlucyBtZXRob2RzIHRvIGdlbmVyYXRlIHF1ZXJ5c3RpbmdzIGZyb20gZm9ybXMgYW5kIE9iamVjdHMuCgpDcmVkaXRzOgoJTG9vc2VseSBiYXNlZCBvbiB0aGUgdmVyc2lvbiBmcm9tIHByb3RvdHlwZS5qcyA8aHR0cDovL3Byb3RvdHlwZS5jb25pby5uZXQ+CgpMaWNlbnNlOgoJTUlULXN0eWxlIGxpY2Vuc2UuCiovCgovKgpDbGFzczogQWpheAoJQW4gQWpheCBjbGFzcywgRm9yIGFsbCB5b3VyIGFzeW5jaHJvbm91cyBuZWVkcy4KCUluaGVyaXRzIG1ldGhvZHMsIHByb3BlcnRpZXMsIG9wdGlvbnMgYW5kIGV2ZW50cyBmcm9tIDxYSFI+LgoKQXJndW1lbnRzOgoJdXJsIC0gdGhlIHVybCBwb2ludGluZyB0byB0aGUgc2VydmVyLXNpZGUgc2NyaXB0LgoJb3B0aW9ucyAtIG9wdGlvbmFsLCBhbiBvYmplY3QgY29udGFpbmluZyBvcHRpb25zLgoKT3B0aW9uczoKCWRhdGEgLSB5b3UgY2FuIHdyaXRlIHBhcmFtZXRlcnMgaGVyZS4gQ2FuIGJlIGEgcXVlcnlzdHJpbmcsIGFuIG9iamVjdCBvciBhIEZvcm0gZWxlbWVudC4KCXVwZGF0ZSAtICQoZWxlbWVudCkgdG8gaW5zZXJ0IHRoZSByZXNwb25zZSB0ZXh0IG9mIHRoZSBYSFIgaW50bywgdXBvbiBjb21wbGV0aW9uIG9mIHRoZSByZXF1ZXN0LgoJZXZhbFNjcmlwdHMgLSBib29sZWFuOyBkZWZhdWx0IGlzIGZhbHNlLiBFeGVjdXRlIHNjcmlwdHMgaW4gdGhlIHJlc3BvbnNlIHRleHQgb25Db21wbGV0ZS4gV2hlbiB0aGUgcmVzcG9uc2UgaXMgamF2YXNjcmlwdCB0aGUgd2hvbGUgcmVzcG9uc2UgaXMgZXZhbHVhdGVkLgoJZXZhbFJlc3BvbnNlIC0gYm9vbGVhbjsgZGVmYXVsdCBpcyBmYWxzZS4gRm9yY2UgZ2xvYmFsIGV2YWx1bGF0aW9uIG9mIHRoZSB3aG9sZSByZXNwb25zZSwgbm8gbWF0dGVyIHdoYXQgY29udGVudC10eXBlIGl0IGlzLgoKRXZlbnRzOgoJb25Db21wbGV0ZSAtIGZ1bmN0aW9uIHRvIGV4ZWN1dGUgd2hlbiB0aGUgYWpheCByZXF1ZXN0IGNvbXBsZXRlcy4KCkV4YW1wbGU6Cgk+dmFyIG15QWpheCA9IG5ldyBBamF4KHVybCwge21ldGhvZDogJ2dldCd9KS5yZXF1ZXN0KCk7CiovCgp2YXIgQWpheCA9IFhIUi5leHRlbmQoewoKCW9wdGlvbnM6IHsKCQlkYXRhOiBudWxsLAoJCXVwZGF0ZTogbnVsbCwKCQlvbkNvbXBsZXRlOiBDbGFzcy5lbXB0eSwKCQlldmFsU2NyaXB0czogZmFsc2UsCgkJZXZhbFJlc3BvbnNlOiBmYWxzZQoJfSwKCglpbml0aWFsaXplOiBmdW5jdGlvbih1cmwsIG9wdGlvbnMpewoJCXRoaXMuYWRkRXZlbnQoJ29uU3VjY2VzcycsIHRoaXMub25Db21wbGV0ZSk7CgkJdGhpcy5zZXRPcHRpb25zKG9wdGlvbnMpOwoJCS8qY29tcGF0aWJpbGl0eSovCgkJdGhpcy5vcHRpb25zLmRhdGEgPSB0aGlzLm9wdGlvbnMuZGF0YSB8fCB0aGlzLm9wdGlvbnMucG9zdEJvZHk7CgkJLyplbmQgY29tcGF0aWJpbGl0eSovCgkJaWYgKCFbJ3Bvc3QnLCAnZ2V0J10uY29udGFpbnModGhpcy5vcHRpb25zLm1ldGhvZCkpewoJCQl0aGlzLl9tZXRob2QgPSAnX21ldGhvZD0nICsgdGhpcy5vcHRpb25zLm1ldGhvZDsKCQkJdGhpcy5vcHRpb25zLm1ldGhvZCA9ICdwb3N0JzsKCQl9CgkJdGhpcy5wYXJlbnQoKTsKCQl0aGlzLnNldEhlYWRlcignWC1SZXF1ZXN0ZWQtV2l0aCcsICdYTUxIdHRwUmVxdWVzdCcpOwoJCXRoaXMuc2V0SGVhZGVyKCdBY2NlcHQnLCAndGV4dC9qYXZhc2NyaXB0LCB0ZXh0L2h0bWwsIGFwcGxpY2F0aW9uL3htbCwgdGV4dC94bWwsICovKicpOwoJCXRoaXMudXJsID0gdXJsOwoJfSwKCglvbkNvbXBsZXRlOiBmdW5jdGlvbigpewoJCWlmICh0aGlzLm9wdGlvbnMudXBkYXRlKSAkKHRoaXMub3B0aW9ucy51cGRhdGUpLmVtcHR5KCkuc2V0SFRNTCh0aGlzLnJlc3BvbnNlLnRleHQpOwoJCWlmICh0aGlzLm9wdGlvbnMuZXZhbFNjcmlwdHMgfHwgdGhpcy5vcHRpb25zLmV2YWxSZXNwb25zZSkgdGhpcy5ldmFsU2NyaXB0cygpOwoJCXRoaXMuZmlyZUV2ZW50KCdvbkNvbXBsZXRlJywgW3RoaXMucmVzcG9uc2UudGV4dCwgdGhpcy5yZXNwb25zZS54bWxdLCAyMCk7Cgl9LAoKCS8qCglQcm9wZXJ0eTogcmVxdWVzdAoJCUV4ZWN1dGVzIHRoZSBhamF4IHJlcXVlc3QuCgoJRXhhbXBsZToKCQk+dmFyIG15QWpheCA9IG5ldyBBamF4KHVybCwge21ldGhvZDogJ2dldCd9KTsKCQk+bXlBamF4LnJlcXVlc3QoKTsKCgkJT1IKCgkJPm5ldyBBamF4KHVybCwge21ldGhvZDogJ2dldCd9KS5yZXF1ZXN0KCk7CgkqLwoKCXJlcXVlc3Q6IGZ1bmN0aW9uKGRhdGEpewoJCWRhdGEgPSBkYXRhIHx8IHRoaXMub3B0aW9ucy5kYXRhOwoJCXN3aXRjaCgkdHlwZShkYXRhKSl7CgkJCWNhc2UgJ2VsZW1lbnQnOiBkYXRhID0gJChkYXRhKS50b1F1ZXJ5U3RyaW5nKCk7IGJyZWFrOwoJCQljYXNlICdvYmplY3QnOiBkYXRhID0gT2JqZWN0LnRvUXVlcnlTdHJpbmcoZGF0YSk7CgkJfQoJCWlmICh0aGlzLl9tZXRob2QpIGRhdGEgPSAoZGF0YSkgPyBbdGhpcy5fbWV0aG9kLCBkYXRhXS5qb2luKCcmJykgOiB0aGlzLl9tZXRob2Q7CgkJcmV0dXJuIHRoaXMuc2VuZCh0aGlzLnVybCwgZGF0YSk7Cgl9LAoKCS8qCglQcm9wZXJ0eTogZXZhbFNjcmlwdHMKCQlFeGVjdXRlcyBzY3JpcHRzIGluIHRoZSByZXNwb25zZSB0ZXh0CgkqLwoKCWV2YWxTY3JpcHRzOiBmdW5jdGlvbigpewoJCXZhciBzY3JpcHQsIHNjcmlwdHM7CgkJaWYgKHRoaXMub3B0aW9ucy5ldmFsUmVzcG9uc2UgfHwgKC8oZWNtYXxqYXZhKXNjcmlwdC8pLnRlc3QodGhpcy5nZXRIZWFkZXIoJ0NvbnRlbnQtdHlwZScpKSkgc2NyaXB0cyA9IHRoaXMucmVzcG9uc2UudGV4dDsKCQllbHNlIHsKCQkJc2NyaXB0cyA9IFtdOwoJCQl2YXIgcmVnZXhwID0gLzxzY3JpcHRbXj5dKj4oW1xzXFNdKj8pPFwvc2NyaXB0Pi9naTsKCQkJd2hpbGUgKChzY3JpcHQgPSByZWdleHAuZXhlYyh0aGlzLnJlc3BvbnNlLnRleHQpKSkgc2NyaXB0cy5wdXNoKHNjcmlwdFsxXSk7CgkJCXNjcmlwdHMgPSBzY3JpcHRzLmpvaW4oJ1xuJyk7CgkJfQoJCWlmIChzY3JpcHRzKSAod2luZG93LmV4ZWNTY3JpcHQpID8gd2luZG93LmV4ZWNTY3JpcHQoc2NyaXB0cykgOiB3aW5kb3cuc2V0VGltZW91dChzY3JpcHRzLCAwKTsKCX0sCgoJLyoKCVByb3BlcnR5OiBnZXRIZWFkZXIKCQlSZXR1cm5zIHRoZSBnaXZlbiByZXNwb25zZSBoZWFkZXIgb3IgbnVsbAoJKi8KCglnZXRIZWFkZXI6IGZ1bmN0aW9uKG5hbWUpewoJCXRyeSB7cmV0dXJuIHRoaXMudHJhbnNwb3J0LmdldFJlc3BvbnNlSGVhZGVyKG5hbWUpO30gY2F0Y2goZSl7fTsKCQlyZXR1cm4gbnVsbDsKCX0KCn0pOwoKLyogU2VjdGlvbjogT2JqZWN0IHJlbGF0ZWQgRnVuY3Rpb25zICovCgovKgpGdW5jdGlvbjogT2JqZWN0LnRvUXVlcnlTdHJpbmcKCUdlbmVyYXRlcyBhIHF1ZXJ5c3RyaW5nIGZyb20ga2V5L3BhaXIgdmFsdWVzIGluIGFuIG9iamVjdAoKQXJndW1lbnRzOgoJc291cmNlIC0gdGhlIG9iamVjdCB0byBnZW5lcmF0ZSB0aGUgcXVlcnlzdHJpbmcgZnJvbS4KClJldHVybnM6Cgl0aGUgcXVlcnkgc3RyaW5nLgoKRXhhbXBsZToKCT5PYmplY3QudG9RdWVyeVN0cmluZyh7YXBwbGU6ICJyZWQiLCBsZW1vbjogInllbGxvdyJ9KTsgLy9yZXR1cm5zICJhcHBsZT1yZWQmbGVtb249eWVsbG93IgoqLwoKT2JqZWN0LnRvUXVlcnlTdHJpbmcgPSBmdW5jdGlvbihzb3VyY2UpewoJdmFyIHF1ZXJ5U3RyaW5nID0gW107Cglmb3IgKHZhciBwcm9wZXJ0eSBpbiBzb3VyY2UpIHF1ZXJ5U3RyaW5nLnB1c2goZW5jb2RlVVJJQ29tcG9uZW50KHByb3BlcnR5KSArICc9JyArIGVuY29kZVVSSUNvbXBvbmVudChzb3VyY2VbcHJvcGVydHldKSk7CglyZXR1cm4gcXVlcnlTdHJpbmcuam9pbignJicpOwp9OwoKLyoKQ2xhc3M6IEVsZW1lbnQKCUN1c3RvbSBjbGFzcyB0byBhbGxvdyBhbGwgb2YgaXRzIG1ldGhvZHMgdG8gYmUgdXNlZCB3aXRoIGFueSBET00gZWxlbWVudCB2aWEgdGhlIGRvbGxhciBmdW5jdGlvbiA8JD4uCiovCgpFbGVtZW50LmV4dGVuZCh7CgoJLyoKCVByb3BlcnR5OiBzZW5kCgkJU2VuZHMgYSBmb3JtIHdpdGggYW4gYWpheCBwb3N0IHJlcXVlc3QKCglBcmd1bWVudHM6CgkJb3B0aW9ucyAtIG9wdGlvbiBjb2xsZWN0aW9uIGZvciBhamF4IHJlcXVlc3QuIFNlZSA8QWpheD4gZm9yIHRoZSBvcHRpb25zIGxpc3QuCgoJUmV0dXJuczoKCQlUaGUgQWpheCBDbGFzcyBJbnN0YW5jZQoKCUV4YW1wbGU6CgkJKHN0YXJ0IGNvZGUpCgkJPGZvcm0gaWQ9Im15Rm9ybSIgYWN0aW9uPSJzdWJtaXQucGhwIj4KCQk8aW5wdXQgbmFtZT0iZW1haWwiIHZhbHVlPSJib2JAYm9iLmNvbSI+CgkJPGlucHV0IG5hbWU9InppcENvZGUiIHZhbHVlPSI5MDIxMCI+CgkJPC9mb3JtPgoJCTxzY3JpcHQ+CgkJJCgnbXlGb3JtJykuc2VuZCgpCgkJPC9zY3JpcHQ+CgkJKGVuZCkKCSovCgoJc2VuZDogZnVuY3Rpb24ob3B0aW9ucyl7CgkJcmV0dXJuIG5ldyBBamF4KHRoaXMuZ2V0UHJvcGVydHkoJ2FjdGlvbicpLCAkbWVyZ2Uoe2RhdGE6IHRoaXMudG9RdWVyeVN0cmluZygpfSwgb3B0aW9ucywge21ldGhvZDogJ3Bvc3QnfSkpLnJlcXVlc3QoKTsKCX0KCn0pOwoKLyoKU2NyaXB0OiBDb29raWUuanMKCUEgY29va2llIHJlYWRlci9jcmVhdG9yCgpDcmVkaXRzOgoJYmFzZWQgb24gdGhlIGZ1bmN0aW9ucyBieSBQZXRlci1QYXVsIEtvY2ggKGh0dHA6Ly9xdWlya3Ntb2RlLm9yZykKKi8KCi8qCkNsYXNzOiBDb29raWUKCUNsYXNzIGZvciBjcmVhdGluZywgZ2V0dGluZywgYW5kIHJlbW92aW5nIGNvb2tpZXMuCiovCgp2YXIgQ29va2llID0gbmV3IEFic3RyYWN0KHsKCglvcHRpb25zOiB7CgkJZG9tYWluOiBmYWxzZSwKCQlwYXRoOiBmYWxzZSwKCQlkdXJhdGlvbjogZmFsc2UsCgkJc2VjdXJlOiBmYWxzZQoJfSwKCgkvKgoJUHJvcGVydHk6IHNldAoJCVNldHMgYSBjb29raWUgaW4gdGhlIGJyb3dzZXIuCgoJQXJndW1lbnRzOgoJCWtleSAtIHRoZSBrZXkgKG5hbWUpIGZvciB0aGUgY29va2llCgkJdmFsdWUgLSB0aGUgdmFsdWUgdG8gc2V0LCBjYW5ub3QgY29udGFpbiBzZW1pY29sb25zCgkJb3B0aW9ucyAtIGFuIG9iamVjdCByZXByZXNlbnRpbmcgdGhlIENvb2tpZSBvcHRpb25zLiBTZWUgT3B0aW9ucyBiZWxvdy4gRGVmYXVsdCB2YWx1ZXMgYXJlIHN0b3JlZCBpbiBDb29raWUub3B0aW9ucy4KCglPcHRpb25zOgoJCWRvbWFpbiAtIHRoZSBkb21haW4gdGhlIENvb2tpZSBiZWxvbmdzIHRvLiBJZiB5b3Ugd2FudCB0byBzaGFyZSB0aGUgY29va2llIHdpdGggcGFnZXMgbG9jYXRlZCBvbiBhIGRpZmZlcmVudCBkb21haW4sIHlvdSBoYXZlIHRvIHNldCB0aGlzIHZhbHVlLiBEZWZhdWx0cyB0byB0aGUgY3VycmVudCBkb21haW4uCgkJcGF0aCAtIHRoZSBwYXRoIHRoZSBDb29raWUgYmVsb25ncyB0by4gSWYgeW91IHdhbnQgdG8gc2hhcmUgdGhlIGNvb2tpZSB3aXRoIHBhZ2VzIGxvY2F0ZWQgaW4gYSBkaWZmZXJlbnQgcGF0aCwgeW91IGhhdmUgdG8gc2V0IHRoaXMgdmFsdWUsIGZvciBleGFtcGxlIHRvICIvIiB0byBzaGFyZSB0aGUgY29va2llIHdpdGggYWxsIHBhZ2VzIG9uIHRoZSBkb21haW4uIERlZmF1bHRzIHRvIHRoZSBjdXJyZW50IHBhdGguCgkJZHVyYXRpb24gLSB0aGUgZHVyYXRpb24gb2YgdGhlIENvb2tpZSBiZWZvcmUgaXQgZXhwaXJlcywgaW4gZGF5cy4KCQkJCQlJZiBzZXQgdG8gZmFsc2Ugb3IgMCwgdGhlIGNvb2tpZSB3aWxsIGJlIGEgc2Vzc2lvbiBjb29raWUgdGhhdCBleHBpcmVzIHdoZW4gdGhlIGJyb3dzZXIgaXMgY2xvc2VkLiBUaGlzIGlzIGRlZmF1bHQuCgkJc2VjdXJlIC0gU3RvcmVkIGNvb2tpZSBpbmZvcm1hdGlvbiBjYW4gYmUgYWNjZXNzZWQgb25seSBmcm9tIGEgc2VjdXJlIGVudmlyb25tZW50LgoKCVJldHVybnM6CgkJQW4gb2JqZWN0IHdpdGggdGhlIG9wdGlvbnMsIHRoZSBrZXkgYW5kIHRoZSB2YWx1ZS4gWW91IGNhbiBnaXZlIGl0IGFzIGZpcnN0IHBhcmFtZXRlciB0byBDb29raWUucmVtb3ZlLgoKCUV4YW1wbGU6CgkJPkNvb2tpZS5zZXQoJ3VzZXJuYW1lJywgJ0hhcmFsZCcpOyAvLyBzZXNzaW9uIGNvb2tpZSAoZHVyYXRpb24gaXMgZmFsc2UpLCBvciAuLi4KCQk+Q29va2llLnNldCgndXNlcm5hbWUnLCAnSmFja0JhdWVyJywge2R1cmF0aW9uOiAxfSk7IC8vIHNhdmUgdGhpcyBmb3IgMSBkYXkKCgkqLwoKCXNldDogZnVuY3Rpb24oa2V5LCB2YWx1ZSwgb3B0aW9ucyl7CgkJb3B0aW9ucyA9ICRtZXJnZSh0aGlzLm9wdGlvbnMsIG9wdGlvbnMpOwoJCXZhbHVlID0gZW5jb2RlVVJJQ29tcG9uZW50KHZhbHVlKTsKCQlpZiAob3B0aW9ucy5kb21haW4pIHZhbHVlICs9ICc7IGRvbWFpbj0nICsgb3B0aW9ucy5kb21haW47CgkJaWYgKG9wdGlvbnMucGF0aCkgdmFsdWUgKz0gJzsgcGF0aD0nICsgb3B0aW9ucy5wYXRoOwoJCWlmIChvcHRpb25zLmR1cmF0aW9uKXsKCQkJdmFyIGRhdGUgPSBuZXcgRGF0ZSgpOwoJCQlkYXRlLnNldFRpbWUoZGF0ZS5nZXRUaW1lKCkgKyBvcHRpb25zLmR1cmF0aW9uICogMjQgKiA2MCAqIDYwICogMTAwMCk7CgkJCXZhbHVlICs9ICc7IGV4cGlyZXM9JyArIGRhdGUudG9HTVRTdHJpbmcoKTsKCQl9CgkJaWYgKG9wdGlvbnMuc2VjdXJlKSB2YWx1ZSArPSAnOyBzZWN1cmUnOwoJCWRvY3VtZW50LmNvb2tpZSA9IGtleSArICc9JyArIHZhbHVlOwoJCXJldHVybiAkZXh0ZW5kKG9wdGlvbnMsIHsna2V5Jzoga2V5LCAndmFsdWUnOiB2YWx1ZX0pOwoJfSwKCgkvKgoJUHJvcGVydHk6IGdldAoJCUdldHMgdGhlIHZhbHVlIG9mIGEgY29va2llLgoKCUFyZ3VtZW50czoKCQlrZXkgLSB0aGUgbmFtZSBvZiB0aGUgY29va2llIHlvdSB3aXNoIHRvIHJldHJpZXZlLgoKCVJldHVybnM6CgkJVGhlIGNvb2tpZSBzdHJpbmcgdmFsdWUsIG9yIGZhbHNlIGlmIG5vdCBmb3VuZC4KCglFeGFtcGxlOgoJCT5Db29raWUuZ2V0KCJ1c2VybmFtZSIpIC8vcmV0dXJucyBKYWNrQmF1ZXIKCSovCgoJZ2V0OiBmdW5jdGlvbihrZXkpewoJCXZhciB2YWx1ZSA9IGRvY3VtZW50LmNvb2tpZS5tYXRjaCgnKD86Xnw7KVxccyonICsga2V5LmVzY2FwZVJlZ0V4cCgpICsgJz0oW147XSopJyk7CgkJcmV0dXJuIHZhbHVlID8gZGVjb2RlVVJJQ29tcG9uZW50KHZhbHVlWzFdKSA6IGZhbHNlOwoJfSwKCgkvKgoJUHJvcGVydHk6IHJlbW92ZQoJCVJlbW92ZXMgYSBjb29raWUgZnJvbSB0aGUgYnJvd3Nlci4KCglBcmd1bWVudHM6CgkJY29va2llIC0gdGhlIG5hbWUgb2YgdGhlIGNvb2tpZSB0byByZW1vdmUgb3IgYSBwcmV2aW91cyBjb29raWUgKGZvciBkb21haW5zKQoJCW9wdGlvbnMgLSBvcHRpb25hbC4geW91IGNhbiBhbHNvIHBhc3MgdGhlIGRvbWFpbiBhbmQgcGF0aCBoZXJlLiBTYW1lIGFzIG9wdGlvbnMgaW4gPENvb2tpZS5zZXQ+CgoJRXhhbXBsZXM6CgkJPkNvb2tpZS5yZW1vdmUoJ3VzZXJuYW1lJykgLy9ieWUtYnllIEphY2tCYXVlciwgY3lhIGluIDI0IGhvdXJzCgkJPgoJCT52YXIgbXlDb29raWUgPSBDb29raWUuc2V0KCd1c2VybmFtZScsICdBYXJvbicsIHtkb21haW46ICdtb290b29scy5uZXQnfSk7IC8vIENvb2tpZS5zZXQgcmV0dXJucyBhbiBvYmplY3Qgd2l0aCBhbGwgdmFsdWVzIG5lZWQgdG8gcmVtb3ZlIHRoZSBjb29raWUKCQk+Q29va2llLnJlbW92ZShteUNvb2tpZSk7CgkqLwoKCXJlbW92ZTogZnVuY3Rpb24oY29va2llLCBvcHRpb25zKXsKCQlpZiAoJHR5cGUoY29va2llKSA9PSAnb2JqZWN0JykgdGhpcy5zZXQoY29va2llLmtleSwgJycsICRtZXJnZShjb29raWUsIHtkdXJhdGlvbjogLTF9KSk7CgkJZWxzZSB0aGlzLnNldChjb29raWUsICcnLCAkbWVyZ2Uob3B0aW9ucywge2R1cmF0aW9uOiAtMX0pKTsKCX0KCn0pOwoKLyoKU2NyaXB0OiBKc29uLmpzCglTaW1wbGUgSnNvbiBwYXJzZXIgYW5kIFN0cmluZ3lmaWVyLCBTZWU6IDxodHRwOi8vd3d3Lmpzb24ub3JnLz4KCkxpY2Vuc2U6CglNSVQtc3R5bGUgbGljZW5zZS4KKi8KCi8qCkNsYXNzOiBKc29uCglTaW1wbGUgSnNvbiBwYXJzZXIgYW5kIFN0cmluZ3lmaWVyLCBTZWU6IDxodHRwOi8vd3d3Lmpzb24ub3JnLz4KKi8KCnZhciBKc29uID0gewoKCS8qCglQcm9wZXJ0eTogdG9TdHJpbmcKCQlDb252ZXJ0cyBhbiBvYmplY3QgdG8gYSBzdHJpbmcsIHRvIGJlIHBhc3NlZCBpbiBzZXJ2ZXItc2lkZSBzY3JpcHRzIGFzIGEgcGFyYW1ldGVyLiBBbHRob3VnaCBpdHMgbm90IG5vcm1hbCB1c2FnZSBmb3IgdGhpcyBjbGFzcywgdGhpcyBtZXRob2QgY2FuIGFsc28gYmUgdXNlZCB0byBjb252ZXJ0IGZ1bmN0aW9ucyBhbmQgYXJyYXlzIHRvIHN0cmluZ3MuCgoJQXJndW1lbnRzOgoJCW9iaiAtIHRoZSBvYmplY3QgdG8gY29udmVydCB0byBzdHJpbmcKCglSZXR1cm5zOgoJCUEganNvbiBzdHJpbmcKCglFeGFtcGxlOgoJCShzdGFydCBjb2RlKQoJCUpzb24udG9TdHJpbmcoe2FwcGxlOiAncmVkJywgbGVtb246ICd5ZWxsb3cnfSk7ICd7ImFwcGxlIjoicmVkIiwibGVtb24iOiJ5ZWxsb3cifScKCQkoZW5kKQoJKi8KCgl0b1N0cmluZzogZnVuY3Rpb24ob2JqKXsKCQlzd2l0Y2goJHR5cGUob2JqKSl7CgkJCWNhc2UgJ3N0cmluZyc6CgkJCQlyZXR1cm4gJyInICsgb2JqLnJlcGxhY2UoLyhbIlxcXSkvZywgJ1xcJDEnKSArICciJzsKCQkJY2FzZSAnYXJyYXknOgoJCQkJcmV0dXJuICdbJyArIG9iai5tYXAoSnNvbi50b1N0cmluZykuam9pbignLCcpICsgJ10nOwoJCQljYXNlICdvYmplY3QnOgoJCQkJdmFyIHN0cmluZyA9IFtdOwoJCQkJZm9yICh2YXIgcHJvcGVydHkgaW4gb2JqKSBzdHJpbmcucHVzaChKc29uLnRvU3RyaW5nKHByb3BlcnR5KSArICc6JyArIEpzb24udG9TdHJpbmcob2JqW3Byb3BlcnR5XSkpOwoJCQkJcmV0dXJuICd7JyArIHN0cmluZy5qb2luKCcsJykgKyAnfSc7CgkJCWNhc2UgJ251bWJlcic6CgkJCQlpZiAoaXNGaW5pdGUob2JqKSkgYnJlYWs7CgkJCWNhc2UgZmFsc2U6CgkJCQlyZXR1cm4gJ251bGwnOwoJCX0KCQlyZXR1cm4gU3RyaW5nKG9iaik7Cgl9LAoKCS8qCglQcm9wZXJ0eTogZXZhbHVhdGUKCQljb252ZXJ0cyBhIGpzb24gc3RyaW5nIHRvIGFuIGphdmFzY3JpcHQgT2JqZWN0LgoKCUFyZ3VtZW50czoKCQlzdHIgLSB0aGUgc3RyaW5nIHRvIGV2YWx1YXRlLiBpZiBpdHMgbm90IGEgc3RyaW5nLCBpdCByZXR1cm5zIGZhbHNlLgoJCXNlY3VyZSAtIG9wdGlvbmFsbHksIHBlcmZvcm1zIHN5bnRheCBjaGVjayBvbiBqc29uIHN0cmluZy4gRGVmYXVsdHMgdG8gZmFsc2UuCgoJQ3JlZGl0czoKCQlKc29uIHRlc3QgcmVnZXhwIGlzIGJ5IERvdWdsYXMgQ3JvY2tmb3JkIDxodHRwOi8vY3JvY2tmb3JkLm9yZz4uCgoJRXhhbXBsZToKCQk+dmFyIG15T2JqZWN0ID0gSnNvbi5ldmFsdWF0ZSgneyJhcHBsZSI6InJlZCIsImxlbW9uIjoieWVsbG93In0nKTsKCQk+Ly9teU9iamVjdCB3aWxsIGJlY29tZSB7YXBwbGU6ICdyZWQnLCBsZW1vbjogJ3llbGxvdyd9CgkqLwoKCWV2YWx1YXRlOiBmdW5jdGlvbihzdHIsIHNlY3VyZSl7CgkJcmV0dXJuICgoJHR5cGUoc3RyKSAhPSAnc3RyaW5nJykgfHwgKHNlY3VyZSAmJiAhc3RyLnRlc3QoL14oIihcXC58W14iXFxcblxyXSkqPyJ8Wyw6e31cW1xdMC05LlwtK0VhZWZsbnItdSBcblxyXHRdKSs/JC8pKSkgPyBudWxsIDogZXZhbCgnKCcgKyBzdHIgKyAnKScpOwoJfQoKfTsKCi8qClNjcmlwdDogSnNvbi5SZW1vdGUuanMKCUNvbnRhaW5zIDxKc29uLlJlbW90ZT4uCgpMaWNlbnNlOgoJTUlULXN0eWxlIGxpY2Vuc2UuCiovCgovKgpDbGFzczogSnNvbi5SZW1vdGUKCVdyYXBwZWQgWEhSIHdpdGggYXV0b21hdGVkIHNlbmRpbmcgYW5kIHJlY2VpdmluZyBvZiBKYXZhc2NyaXB0IE9iamVjdHMgaW4gSnNvbiBGb3JtYXQuCglJbmhlcml0cyBtZXRob2RzLCBwcm9wZXJ0aWVzLCBvcHRpb25zIGFuZCBldmVudHMgZnJvbSA8WEhSPi4KCkFyZ3VtZW50czoKCXVybCAtIHRoZSB1cmwgeW91IHdhbnQgdG8gc2VuZCB5b3VyIG9iamVjdCB0by4KCW9wdGlvbnMgLSBzZWUgPFhIUj4gb3B0aW9ucwoKRXhhbXBsZToKCXRoaXMgY29kZSB3aWxsIHNlbmQgdXNlciBpbmZvcm1hdGlvbiBiYXNlZCBvbiBuYW1lL2xhc3QgbmFtZQoJKHN0YXJ0IGNvZGUpCgl2YXIgalNvblJlcXVlc3QgPSBuZXcgSnNvbi5SZW1vdGUoImh0dHA6Ly9zaXRlLmNvbS90ZWxsTWVBZ2UucGhwIiwge29uQ29tcGxldGU6IGZ1bmN0aW9uKHBlcnNvbil7CgkJYWxlcnQocGVyc29uLmFnZSk7IC8vaXMgMjUgeWVhcnMKCQlhbGVydChwZXJzb24uaGVpZ2h0KTsgLy9pcyAxNzAgY20KCQlhbGVydChwZXJzb24ud2VpZ2h0KTsgLy9pcyAxMjAga2cKCX19KS5zZW5kKHsnbmFtZSc6ICdKb2huJywgJ2xhc3ROYW1lJzogJ0RvZSd9KTsKCShlbmQpCiovCgpKc29uLlJlbW90ZSA9IFhIUi5leHRlbmQoewoKCWluaXRpYWxpemU6IGZ1bmN0aW9uKHVybCwgb3B0aW9ucyl7CgkJdGhpcy51cmwgPSB1cmw7CgkJdGhpcy5hZGRFdmVudCgnb25TdWNjZXNzJywgdGhpcy5vbkNvbXBsZXRlKTsKCQl0aGlzLnBhcmVudChvcHRpb25zKTsKCQl0aGlzLnNldEhlYWRlcignWC1SZXF1ZXN0JywgJ0pTT04nKTsKCX0sCgoJc2VuZDogZnVuY3Rpb24ob2JqKXsKCQlyZXR1cm4gdGhpcy5wYXJlbnQodGhpcy51cmwsICdqc29uPScgKyBKc29uLnRvU3RyaW5nKG9iaikpOwoJfSwKCglvbkNvbXBsZXRlOiBmdW5jdGlvbigpewoJCXRoaXMuZmlyZUV2ZW50KCdvbkNvbXBsZXRlJywgW0pzb24uZXZhbHVhdGUodGhpcy5yZXNwb25zZS50ZXh0LCB0aGlzLm9wdGlvbnMuc2VjdXJlKV0pOwoJfQoKfSk7CgovKgpTY3JpcHQ6IEFzc2V0cy5qcwoJcHJvdmlkZXMgZHluYW1pYyBsb2FkaW5nIGZvciBpbWFnZXMsIGNzcyBhbmQgamF2YXNjcmlwdCBmaWxlcy4KCkxpY2Vuc2U6CglNSVQtc3R5bGUgbGljZW5zZS4KKi8KCnZhciBBc3NldCA9IG5ldyBBYnN0cmFjdCh7CgoJLyoKCVByb3BlcnR5OiBqYXZhc2NyaXB0CgkJSW5qZWN0cyBhIGphdmFzY3JpcHQgZmlsZSBpbiB0aGUgcGFnZS4KCglBcmd1bWVudHM6CgkJc291cmNlIC0gdGhlIHBhdGggb2YgdGhlIGphdmFzY3JpcHQgZmlsZQoJCXByb3BlcnRpZXMgLSBzb21lIGFkZGl0aW9uYWwgYXR0cmlidXRlcyB5b3UgbWlnaHQgd2FudCB0byBhZGQgdG8gdGhlIHNjcmlwdCBlbGVtZW50CgoJRXhhbXBsZToKCQk+IG5ldyBBc3NldC5qYXZhc2NyaXB0KCcvc2NyaXB0cy9teVNjcmlwdC5qcycsIHtpZDogJ215U2NyaXB0J30pOwoJKi8KCglqYXZhc2NyaXB0OiBmdW5jdGlvbihzb3VyY2UsIHByb3BlcnRpZXMpewoJCXByb3BlcnRpZXMgPSAkbWVyZ2UoewoJCQknb25sb2FkJzogQ2xhc3MuZW1wdHkKCQl9LCBwcm9wZXJ0aWVzKTsKCQl2YXIgc2NyaXB0ID0gbmV3IEVsZW1lbnQoJ3NjcmlwdCcsIHsnc3JjJzogc291cmNlfSkuYWRkRXZlbnRzKHsKCQkJJ2xvYWQnOiBwcm9wZXJ0aWVzLm9ubG9hZCwKCQkJJ3JlYWR5c3RhdGVjaGFuZ2UnOiBmdW5jdGlvbigpewoJCQkJaWYgKHRoaXMucmVhZHlTdGF0ZSA9PSAnY29tcGxldGUnKSB0aGlzLmZpcmVFdmVudCgnbG9hZCcpOwoJCQl9CgkJfSk7CgkJZGVsZXRlIHByb3BlcnRpZXMub25sb2FkOwoJCXJldHVybiBzY3JpcHQuc2V0UHJvcGVydGllcyhwcm9wZXJ0aWVzKS5pbmplY3QoZG9jdW1lbnQuaGVhZCk7Cgl9LAoKCS8qCglQcm9wZXJ0eTogY3NzCgkJSW5qZWN0cyBhIGNzcyBmaWxlIGluIHRoZSBwYWdlLgoKCUFyZ3VtZW50czoKCQlzb3VyY2UgLSB0aGUgcGF0aCBvZiB0aGUgY3NzIGZpbGUKCQlwcm9wZXJ0aWVzIC0gc29tZSBhZGRpdGlvbmFsIGF0dHJpYnV0ZXMgeW91IG1pZ2h0IHdhbnQgdG8gYWRkIHRvIHRoZSBsaW5rIGVsZW1lbnQKCglFeGFtcGxlOgoJCT4gbmV3IEFzc2V0LmNzcygnL2Nzcy9teVN0eWxlLmNzcycsIHtpZDogJ215U3R5bGUnLCB0aXRsZTogJ215U3R5bGUnfSk7CgkqLwoKCWNzczogZnVuY3Rpb24oc291cmNlLCBwcm9wZXJ0aWVzKXsKCQlyZXR1cm4gbmV3IEVsZW1lbnQoJ2xpbmsnLCAkbWVyZ2UoewoJCQkncmVsJzogJ3N0eWxlc2hlZXQnLCAnbWVkaWEnOiAnc2NyZWVuJywgJ3R5cGUnOiAndGV4dC9jc3MnLCAnaHJlZic6IHNvdXJjZQoJCX0sIHByb3BlcnRpZXMpKS5pbmplY3QoZG9jdW1lbnQuaGVhZCk7Cgl9LAoKCS8qCglQcm9wZXJ0eTogaW1hZ2UKCQlQcmVsb2FkcyBhbiBpbWFnZSBhbmQgcmV0dXJucyB0aGUgaW1nIGVsZW1lbnQuIGRvZXMgbm90IGluamVjdCBpdCB0byB0aGUgcGFnZS4KCglBcmd1bWVudHM6CgkJc291cmNlIC0gdGhlIHBhdGggb2YgdGhlIGltYWdlIGZpbGUKCQlwcm9wZXJ0aWVzIC0gc29tZSBhZGRpdGlvbmFsIGF0dHJpYnV0ZXMgeW91IG1pZ2h0IHdhbnQgdG8gYWRkIHRvIHRoZSBpbWcgZWxlbWVudAoKCUV4YW1wbGU6CgkJPiBuZXcgQXNzZXQuaW1hZ2UoJy9pbWFnZXMvbXlJbWFnZS5wbmcnLCB7aWQ6ICdteUltYWdlJywgdGl0bGU6ICdteUltYWdlJywgb25sb2FkOiBteUZ1bmN0aW9ufSk7CgoJUmV0dXJuczoKCQl0aGUgaW1nIGVsZW1lbnQuIHlvdSBjYW4gaW5qZWN0IGl0IGFueXdoZXJlIHlvdSB3YW50IHdpdGggPEVsZW1lbnQuaW5qZWN0SW5zaWRlPi88RWxlbWVudC5pbmplY3RBZnRlcj4vPEVsZW1lbnQuaW5qZWN0QmVmb3JlPgoJKi8KCglpbWFnZTogZnVuY3Rpb24oc291cmNlLCBwcm9wZXJ0aWVzKXsKCQlwcm9wZXJ0aWVzID0gJG1lcmdlKHsKCQkJJ29ubG9hZCc6IENsYXNzLmVtcHR5LAoJCQknb25hYm9ydCc6IENsYXNzLmVtcHR5LAoJCQknb25lcnJvcic6IENsYXNzLmVtcHR5CgkJfSwgcHJvcGVydGllcyk7CgkJdmFyIGltYWdlID0gbmV3IEltYWdlKCk7CgkJaW1hZ2Uuc3JjID0gc291cmNlOwoJCXZhciBlbGVtZW50ID0gbmV3IEVsZW1lbnQoJ2ltZycsIHsnc3JjJzogc291cmNlfSk7CgkJWydsb2FkJywgJ2Fib3J0JywgJ2Vycm9yJ10uZWFjaChmdW5jdGlvbih0eXBlKXsKCQkJdmFyIGV2ZW50ID0gcHJvcGVydGllc1snb24nICsgdHlwZV07CgkJCWRlbGV0ZSBwcm9wZXJ0aWVzWydvbicgKyB0eXBlXTsKCQkJZWxlbWVudC5hZGRFdmVudCh0eXBlLCBmdW5jdGlvbigpewoJCQkJdGhpcy5yZW1vdmVFdmVudCh0eXBlLCBhcmd1bWVudHMuY2FsbGVlKTsKCQkJCWV2ZW50LmNhbGwodGhpcyk7CgkJCX0pOwoJCX0pOwoJCWlmIChpbWFnZS53aWR0aCAmJiBpbWFnZS5oZWlnaHQpIGVsZW1lbnQuZmlyZUV2ZW50KCdsb2FkJywgZWxlbWVudCwgMSk7CgkJcmV0dXJuIGVsZW1lbnQuc2V0UHJvcGVydGllcyhwcm9wZXJ0aWVzKTsKCX0sCgoJLyoKCVByb3BlcnR5OiBpbWFnZXMKCQlQcmVsb2FkcyBhbiBhcnJheSBvZiBpbWFnZXMgKGFzIHN0cmluZ3MpIGFuZCByZXR1cm5zIGFuIGFycmF5IG9mIGltZyBlbGVtZW50cy4gZG9lcyBub3QgaW5qZWN0IHRoZW0gdG8gdGhlIHBhZ2UuCgoJQXJndW1lbnRzOgoJCXNvdXJjZXMgLSBhcnJheSwgdGhlIHBhdGhzIG9mIHRoZSBpbWFnZSBmaWxlcwoJCW9wdGlvbnMgLSBvYmplY3QsIHNlZSBiZWxvdwoKCU9wdGlvbnM6CgkJb25Db21wbGV0ZSAtIGEgZnVuY3Rpb24gdG8gZXhlY3V0ZSB3aGVuIGFsbCBpbWFnZSBmaWxlcyBhcmUgbG9hZGVkIGluIHRoZSBicm93c2VyJ3MgY2FjaGUKCQlvblByb2dyZXNzIC0gYSBmdW5jdGlvbiB0byBleGVjdXRlIHdoZW4gb25lIGltYWdlIGZpbGUgaXMgbG9hZGVkIGluIHRoZSBicm93c2VyJ3MgY2FjaGUKCglFeGFtcGxlOgoJCShzdGFydCBjb2RlKQoJCW5ldyBBc3NldC5pbWFnZXMoWycvaW1hZ2VzL215SW1hZ2UucG5nJywgJy9pbWFnZXMvbXlJbWFnZTIuZ2lmJ10sIHsKCQkJb25Db21wbGV0ZTogZnVuY3Rpb24oKXsKCQkJCWFsZXJ0KCdhbGwgaW1hZ2VzIGxvYWRlZCEnKTsKCQkJfQoJCX0pOwoJCShlbmQpCgoJUmV0dXJuczoKCQl0aGUgaW1nIGVsZW1lbnRzIGFzICQkLiB5b3UgY2FuIGluamVjdCB0aGVtIGFueXdoZXJlIHlvdSB3YW50IHdpdGggPEVsZW1lbnQuaW5qZWN0SW5zaWRlPi88RWxlbWVudC5pbmplY3RBZnRlcj4vPEVsZW1lbnQuaW5qZWN0QmVmb3JlPgoJKi8KCglpbWFnZXM6IGZ1bmN0aW9uKHNvdXJjZXMsIG9wdGlvbnMpewoJCW9wdGlvbnMgPSAkbWVyZ2UoewoJCQlvbkNvbXBsZXRlOiBDbGFzcy5lbXB0eSwKCQkJb25Qcm9ncmVzczogQ2xhc3MuZW1wdHkKCQl9LCBvcHRpb25zKTsKCQlpZiAoIXNvdXJjZXMucHVzaCkgc291cmNlcyA9IFtzb3VyY2VzXTsKCQl2YXIgaW1hZ2VzID0gW107CgkJdmFyIGNvdW50ZXIgPSAwOwoJCXNvdXJjZXMuZWFjaChmdW5jdGlvbihzb3VyY2UpewoJCQl2YXIgaW1nID0gbmV3IEFzc2V0LmltYWdlKHNvdXJjZSwgewoJCQkJJ29ubG9hZCc6IGZ1bmN0aW9uKCl7CgkJCQkJb3B0aW9ucy5vblByb2dyZXNzLmNhbGwodGhpcywgY291bnRlcik7CgkJCQkJY291bnRlcisrOwoJCQkJCWlmIChjb3VudGVyID09IHNvdXJjZXMubGVuZ3RoKSBvcHRpb25zLm9uQ29tcGxldGUoKTsKCQkJCX0KCQkJfSk7CgkJCWltYWdlcy5wdXNoKGltZyk7CgkJfSk7CgkJcmV0dXJuIG5ldyBFbGVtZW50cyhpbWFnZXMpOwoJfQoKfSk7CgovKgpTY3JpcHQ6IEhhc2guanMKCUNvbnRhaW5zIHRoZSBjbGFzcyBIYXNoLgoKTGljZW5zZToKCU1JVC1zdHlsZSBsaWNlbnNlLgoqLwoKLyoKQ2xhc3M6IEhhc2gKCUl0IHdyYXBzIGFuIG9iamVjdCB0aGF0IGl0IHVzZXMgaW50ZXJuYWxseSBhcyBhIG1hcC4gVGhlIHVzZXIgbXVzdCB1c2Ugc2V0KCksIGdldCgpLCBhbmQgcmVtb3ZlKCkgdG8gYWRkL2NoYW5nZSwgcmV0cmlldmUgYW5kIHJlbW92ZSB2YWx1ZXMsIGl0IG11c3Qgbm90IGFjY2VzcyB0aGUgaW50ZXJuYWwgb2JqZWN0IGRpcmVjdGx5LiBudWxsL3VuZGVmaW5lZCB2YWx1ZXMgYXJlIGFsbG93ZWQuCgpOb3RlOgoJRWFjaCBoYXNoIGluc3RhbmNlIGhhcyB0aGUgbGVuZ3RoIHByb3BlcnR5LgoKQXJndW1lbnRzOgoJb2JqIC0gYW4gb2JqZWN0IHRvIGNvbnZlcnQgaW50byBhIEhhc2ggaW5zdGFuY2UuCgpFeGFtcGxlOgoJKHN0YXJ0IGNvZGUpCgl2YXIgaGFzaCA9IG5ldyBIYXNoKHthOiAnaGknLCBiOiAnd29ybGQnLCBjOiAnaG93ZHknfSk7CgloYXNoLnJlbW92ZSgnYicpOyAvLyBiIGlzIHJlbW92ZWQuCgloYXNoLnNldCgnYycsICdoZWxsbycpOwoJaGFzaC5nZXQoJ2MnKTsgLy8gcmV0dXJucyAnaGVsbG8nCgloYXNoLmxlbmd0aCAvLyByZXR1cm5zIDIgKGEgYW5kIGMpCgkoZW5kKQoqLwoKdmFyIEhhc2ggPSBuZXcgQ2xhc3MoewoKCWxlbmd0aDogMCwKCglpbml0aWFsaXplOiBmdW5jdGlvbihvYmplY3QpewoJCXRoaXMub2JqID0gb2JqZWN0IHx8IHt9OwoJCXRoaXMuc2V0TGVuZ3RoKCk7Cgl9LAoKCS8qCglQcm9wZXJ0eTogZ2V0CgkJUmV0cmlldmVzIGEgdmFsdWUgZnJvbSB0aGUgaGFzaC4KCglBcmd1bWVudHM6CgkJa2V5IC0gVGhlIGtleQoKCVJldHVybnM6CgkJVGhlIHZhbHVlCgkqLwoKCWdldDogZnVuY3Rpb24oa2V5KXsKCQlyZXR1cm4gKHRoaXMuaGFzS2V5KGtleSkpID8gdGhpcy5vYmpba2V5XSA6IG51bGw7Cgl9LAoKCS8qCglQcm9wZXJ0eTogaGFzS2V5CgkJQ2hlY2sgdGhlIHByZXNlbmNlIG9mIGEgc3BlY2lmaWVkIGtleS12YWx1ZSBwYWlyIGluIHRoZSBoYXNoLgoKCUFyZ3VtZW50czoKCQlrZXkgLSBUaGUga2V5CgoJUmV0dXJuczoKCQlUcnVlIGlmIHRoZSBIYXNoIGNvbnRhaW5zIGEgdmFsdWUgZm9yIHRoZSBzcGVjaWZpZWQga2V5LCBvdGhlcndpc2UgZmFsc2UKCSovCgoJaGFzS2V5OiBmdW5jdGlvbihrZXkpewoJCXJldHVybiAoa2V5IGluIHRoaXMub2JqKTsKCX0sCgoJLyoKCVByb3BlcnR5OiBzZXQKCQlBZGRzIGEga2V5LXZhbHVlIHBhaXIgdG8gdGhlIGhhc2ggb3IgcmVwbGFjZXMgYSBwcmV2aW91cyB2YWx1ZSBhc3NvY2lhdGVkIHdpdGggdGhlIGtleS4KCglBcmd1bWVudHM6CgkJa2V5IC0gVGhlIGtleQoJCXZhbHVlIC0gVGhlIHZhbHVlCgkqLwoKCXNldDogZnVuY3Rpb24oa2V5LCB2YWx1ZSl7CgkJaWYgKCF0aGlzLmhhc0tleShrZXkpKSB0aGlzLmxlbmd0aCsrOwoJCXRoaXMub2JqW2tleV0gPSB2YWx1ZTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJc2V0TGVuZ3RoOiBmdW5jdGlvbigpewoJCXRoaXMubGVuZ3RoID0gMDsKCQlmb3IgKHZhciBwIGluIHRoaXMub2JqKSB0aGlzLmxlbmd0aCsrOwoJCXJldHVybiB0aGlzOwoJfSwKCgkvKgoJUHJvcGVydHk6IHJlbW92ZQoJCVJlbW92ZXMgYSBrZXktdmFsdWUgcGFpciBmcm9tIHRoZSBoYXNoLgoKCUFyZ3VtZW50czoKCQlrZXkgLSBUaGUga2V5CgkqLwoKCXJlbW92ZTogZnVuY3Rpb24oa2V5KXsKCQlpZiAodGhpcy5oYXNLZXkoa2V5KSl7CgkJCWRlbGV0ZSB0aGlzLm9ialtrZXldOwoJCQl0aGlzLmxlbmd0aC0tOwoJCX0KCQlyZXR1cm4gdGhpczsKCX0sCgoJLyoKCVByb3BlcnR5OiBlYWNoCgkJQ2FsbHMgYSBmdW5jdGlvbiBmb3IgZWFjaCBrZXktdmFsdWUgcGFpci4gVGhlIGZpcnN0IGFyZ3VtZW50IHBhc3NlZCB0byB0aGUgZnVuY3Rpb24gd2lsbCBiZSB0aGUgdmFsdWUsIHRoZSBzZWNvbmQgb25lIHdpbGwgYmUgdGhlIGtleSwgbGlrZSAkZWFjaC4KCglBcmd1bWVudHM6CgkJZm4gLSBUaGUgZnVuY3Rpb24gdG8gY2FsbCBmb3IgZWFjaCBrZXktdmFsdWUgcGFpcgoJCWJpbmQgLSBPcHRpb25hbCwgdGhlIG9iamVjdCB0aGF0IHdpbGwgYmUgcmVmZXJyZWQgdG8gYXMgInRoaXMiIGluIHRoZSBmdW5jdGlvbgoJKi8KCgllYWNoOiBmdW5jdGlvbihmbiwgYmluZCl7CgkJJGVhY2godGhpcy5vYmosIGZuLCBiaW5kKTsKCX0sCgoJLyoKCVByb3BlcnR5OiBleHRlbmQKCQlFeHRlbmRzIHRoZSBjdXJyZW50IGhhc2ggd2l0aCBhbiBvYmplY3QgY29udGFpbmluZyBrZXktdmFsdWUgcGFpcnMuIFZhbHVlcyBmb3IgZHVwbGljYXRlIGtleXMgd2lsbCBiZSByZXBsYWNlZCBieSB0aGUgbmV3IG9uZXMuCgoJQXJndW1lbnRzOgoJCW9iaiAtIEFuIG9iamVjdCBjb250YWluaW5nIGtleS12YWx1ZSBwYWlycwoJKi8KCglleHRlbmQ6IGZ1bmN0aW9uKG9iail7CgkJJGV4dGVuZCh0aGlzLm9iaiwgb2JqKTsKCQlyZXR1cm4gdGhpcy5zZXRMZW5ndGgoKTsKCX0sCgoJLyoKCVByb3BlcnR5OiBtZXJnZQoJCU1lcmdlcyB0aGUgY3VycmVudCBoYXNoIHdpdGggbXVsdGlwbGUgb2JqZWN0cy4KCSovCgoJbWVyZ2U6IGZ1bmN0aW9uKCl7CgkJdGhpcy5vYmogPSAkbWVyZ2UuYXBwbHkobnVsbCwgW3RoaXMub2JqXS5leHRlbmQoYXJndW1lbnRzKSk7CgkJcmV0dXJuIHRoaXMuc2V0TGVuZ3RoKCk7Cgl9LAoKCS8qCglQcm9wZXJ0eTogZW1wdHkKCQlFbXB0aWVzIGFsbCBoYXNoIHZhbHVlcyBwcm9wZXJ0aWVzIGFuZCB2YWx1ZXMuCgkqLwoKCWVtcHR5OiBmdW5jdGlvbigpewoJCXRoaXMub2JqID0ge307CgkJdGhpcy5sZW5ndGggPSAwOwoJCXJldHVybiB0aGlzOwoJfSwKCgkvKgoJUHJvcGVydHk6IGtleXMKCQlSZXR1cm5zIGFuIGFycmF5IGNvbnRhaW5pbmcgYWxsIHRoZSBrZXlzLCBpbiB0aGUgc2FtZSBvcmRlciBhcyB0aGUgdmFsdWVzIHJldHVybmVkIGJ5IDxIYXNoLnZhbHVlcz4uCgoJUmV0dXJuczoKCQlBbiBhcnJheSBjb250YWluaW5nIGFsbCB0aGUga2V5cyBvZiB0aGUgaGFzaAoJKi8KCglrZXlzOiBmdW5jdGlvbigpewoJCXZhciBrZXlzID0gW107CgkJZm9yICh2YXIgcHJvcGVydHkgaW4gdGhpcy5vYmopIGtleXMucHVzaChwcm9wZXJ0eSk7CgkJcmV0dXJuIGtleXM7Cgl9LAoKCS8qCglQcm9wZXJ0eTogdmFsdWVzCgkJUmV0dXJucyBhbiBhcnJheSBjb250YWluaW5nIGFsbCB0aGUgdmFsdWVzLCBpbiB0aGUgc2FtZSBvcmRlciBhcyB0aGUga2V5cyByZXR1cm5lZCBieSA8SGFzaC5rZXlzPi4KCglSZXR1cm5zOgoJCUFuIGFycmF5IGNvbnRhaW5pbmcgYWxsIHRoZSB2YWx1ZXMgb2YgdGhlIGhhc2gKCSovCgoJdmFsdWVzOiBmdW5jdGlvbigpewoJCXZhciB2YWx1ZXMgPSBbXTsKCQlmb3IgKHZhciBwcm9wZXJ0eSBpbiB0aGlzLm9iaikgdmFsdWVzLnB1c2godGhpcy5vYmpbcHJvcGVydHldKTsKCQlyZXR1cm4gdmFsdWVzOwoJfQoKfSk7CgovKiBTZWN0aW9uOiBVdGlsaXR5IEZ1bmN0aW9ucyAqLwoKLyoKRnVuY3Rpb246ICRICglTaG9ydGN1dCB0byBjcmVhdGUgYSBIYXNoIGZyb20gYW4gT2JqZWN0LgoqLwoKZnVuY3Rpb24gJEgob2JqKXsKCXJldHVybiBuZXcgSGFzaChvYmopOwp9OwoKLyoKU2NyaXB0OiBIYXNoLkNvb2tpZS5qcwoJU3RvcmVzIGFuZCBsb2FkcyBhbiBIYXNoIGFzIGEgY29va2llIHVzaW5nIEpzb24gZm9ybWF0LgoqLwoKLyoKQ2xhc3M6IEhhc2guQ29va2llCglJbmhlcml0cyBhbGwgdGhlIG1ldGhvZHMgZnJvbSA8SGFzaD4sIGFkZGl0aW9uYWwgbWV0aG9kcyBhcmUgc2F2ZSBhbmQgbG9hZC4KCUhhc2gganNvbiBzdHJpbmcgaGFzIGEgbGltaXQgb2YgNGtiICg0MDk2Ynl0ZSksIHNvIGJlIGNhcmVmdWwgd2l0aCB5b3VyIEhhc2ggc2l6ZS4KCUNyZWF0aW5nIGEgbmV3IGluc3RhbmNlIGF1dG9tYXRpY2FsbHkgbG9hZHMgdGhlIGRhdGEgZnJvbSB0aGUgQ29va2llIGludG8gdGhlIEhhc2guCglJZiB0aGUgSGFzaCBpcyBlbXB0aWVkLCB0aGUgY29va2llIGlzIGFsc28gcmVtb3ZlZC4KCkFyZ3VtZW50czoKCW5hbWUgLSB0aGUga2V5IChuYW1lKSBmb3IgdGhlIGNvb2tpZQoJb3B0aW9ucyAtIG9wdGlvbnMgYXJlIGlkZW50aWNhbCB0byA8Q29va2llPiBhbmQgYXJlIHNpbXBseSBwYXNzZWQgYWxvbmcgdG8gaXQuCgkJSW4gYWRkaXRpb24sIGl0IGhhcyB0aGUgYXV0b1NhdmUgb3B0aW9uLCB0byBzYXZlIHRoZSBjb29raWUgYXQgZXZlcnkgb3BlcmF0aW9uLiBkZWZhdWx0cyB0byB0cnVlLgoKRXhhbXBsZToKCShzdGFydCBjb2RlKQoJdmFyIGZydWl0cyA9IG5ldyBIYXNoLkNvb2tpZSgnbXlDb29raWVOYW1lJywge2R1cmF0aW9uOiAzNjAwfSk7CglmcnVpdHMuZXh0ZW5kKHsKCQknbGVtb24nOiAneWVsbG93JywKCQknYXBwbGUnOiAncmVkJwoJfSk7CglmcnVpdHMuc2V0KCdtZWxvbicsICdncmVlbicpOwoJZnJ1aXRzLmdldCgnbGVtb24nKTsgLy8geWVsbG93CgoJLy8gLi4uIG9uIGFub3RoZXIgcGFnZSAuLi4gdmFsdWVzIGxvYWQgYXV0b21hdGljYWxseQoKCXZhciBmcnVpdHMgPSBuZXcgSGFzaC5Db29raWUoJ215Q29va2llTmFtZScsIHtkdXJhdGlvbjogMzY1fSk7CglmcnVpdHMuZ2V0KCdtZWxvbicpOyAvLyBncmVlbgoKCWZydWl0cy5lcmFzZSgpOyAvLyBkZWxldGUgY29va2llCgkoZW5kKQoqLwoKSGFzaC5Db29raWUgPSBIYXNoLmV4dGVuZCh7CgoJaW5pdGlhbGl6ZTogZnVuY3Rpb24obmFtZSwgb3B0aW9ucyl7CgkJdGhpcy5uYW1lID0gbmFtZTsKCQl0aGlzLm9wdGlvbnMgPSAkZXh0ZW5kKHsnYXV0b1NhdmUnOiB0cnVlfSwgb3B0aW9ucyB8fCB7fSk7CgkJdGhpcy5sb2FkKCk7Cgl9LAoKCS8qCglQcm9wZXJ0eTogc2F2ZQoJCVNhdmVzIHRoZSBIYXNoIHRvIHRoZSBjb29raWUuIElmIHRoZSBoYXNoIGlzIGVtcHR5LCByZW1vdmVzIHRoZSBjb29raWUuCgoJUmV0dXJuczoKCQlSZXR1cm5zIGZhbHNlIHdoZW4gdGhlIEpTT04gc3RyaW5nIGNvb2tpZSBpcyB0b28gbG9uZyAoNGtiKSwgb3RoZXJ3aXNlIHRydWUuCgoJRXhhbXBsZToKCQkoc3RhcnQgY29kZSkKCQl2YXIgbG9naW4gPSBuZXcgSGFzaC5Db29raWUoJ3VzZXJzdGF0dXMnLCB7YXV0b1NhdmU6IGZhbHNlfSk7CgoJCWxvZ2luLmV4dGVuZCh7CgkJCSd1c2VybmFtZSc6ICdKb2huJywKCQkJJ2NyZWRlbnRpYWxzJzogWzQsIDcsIDldCgkJfSk7CgkJbG9naW4uc2V0KCdsYXN0X21lc3NhZ2UnLCAnVXNlciBsb2dnZWQgaW4hJyk7CgoJCWxvZ2luLnNhdmUoKTsgLy8gZmluYWxseSBzYXZlIHRoZSBIYXNoCgkJKGVuZCkKCSovCgoJc2F2ZTogZnVuY3Rpb24oKXsKCQlpZiAodGhpcy5sZW5ndGggPT0gMCl7CgkJCUNvb2tpZS5yZW1vdmUodGhpcy5uYW1lLCB0aGlzLm9wdGlvbnMpOwoJCQlyZXR1cm4gdHJ1ZTsKCQl9CgkJdmFyIHN0ciA9IEpzb24udG9TdHJpbmcodGhpcy5vYmopOwoJCWlmIChzdHIubGVuZ3RoID4gNDA5NikgcmV0dXJuIGZhbHNlOyAvL2Nvb2tpZSB3b3VsZCBiZSB0cnVuY2F0ZWQhCgkJQ29va2llLnNldCh0aGlzLm5hbWUsIHN0ciwgdGhpcy5vcHRpb25zKTsKCQlyZXR1cm4gdHJ1ZTsKCX0sCgoJLyoKCVByb3BlcnR5OiBsb2FkCgkJTG9hZHMgdGhlIGNvb2tpZSBhbmQgYXNzaWducyBpdCB0byB0aGUgSGFzaC4KCSovCgoJbG9hZDogZnVuY3Rpb24oKXsKCQl0aGlzLm9iaiA9IEpzb24uZXZhbHVhdGUoQ29va2llLmdldCh0aGlzLm5hbWUpLCB0cnVlKSB8fCB7fTsKCQl0aGlzLnNldExlbmd0aCgpOwoJfQoKfSk7CgpIYXNoLkNvb2tpZS5NZXRob2RzID0ge307ClsnZXh0ZW5kJywgJ3NldCcsICdtZXJnZScsICdlbXB0eScsICdyZW1vdmUnXS5lYWNoKGZ1bmN0aW9uKG1ldGhvZCl7CglIYXNoLkNvb2tpZS5NZXRob2RzW21ldGhvZF0gPSBmdW5jdGlvbigpewoJCUhhc2gucHJvdG90eXBlW21ldGhvZF0uYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCQlpZiAodGhpcy5vcHRpb25zLmF1dG9TYXZlKSB0aGlzLnNhdmUoKTsKCQlyZXR1cm4gdGhpczsKCX07Cn0pOwpIYXNoLkNvb2tpZS5pbXBsZW1lbnQoSGFzaC5Db29raWUuTWV0aG9kcyk7CgovKgpTY3JpcHQ6IENvbG9yLmpzCglDb250YWlucyB0aGUgQ29sb3IgY2xhc3MuCgpMaWNlbnNlOgoJTUlULXN0eWxlIGxpY2Vuc2UuCiovCgovKgpDbGFzczogQ29sb3IKCUNyZWF0ZXMgYSBuZXcgQ29sb3IgT2JqZWN0LCB3aGljaCBpcyBhbiBhcnJheSB3aXRoIHNvbWUgY29sb3Igc3BlY2lmaWMgbWV0aG9kcy4KQXJndW1lbnRzOgoJY29sb3IgLSB0aGUgaGV4LCB0aGUgUkdCIGFycmF5IG9yIHRoZSBIU0IgYXJyYXkgb2YgdGhlIGNvbG9yIHRvIGNyZWF0ZS4gRm9yIEhTQiBjb2xvcnMsIHlvdSBuZWVkIHRvIHNwZWNpZnkgdGhlIHNlY29uZCBhcmd1bWVudC4KCXR5cGUgLSBhIHN0cmluZyByZXByZXNlbnRpbmcgdGhlIHR5cGUgb2YgdGhlIGNvbG9yIHRvIGNyZWF0ZS4gbmVlZHMgdG8gYmUgc3BlY2lmaWVkIGlmIHlvdSBpbnRlbmQgdG8gY3JlYXRlIHRoZSBjb2xvciB3aXRoIEhTQiB2YWx1ZXMsIG9yIGFuIGFycmF5IG9mIEhFWCB2YWx1ZXMuIENhbiBiZSAncmdiJywgJ2hzYicgb3IgJ2hleCcuCgpFeGFtcGxlOgoJKHN0YXJ0IGNvZGUpCgl2YXIgYmxhY2sgPSBuZXcgQ29sb3IoJyMwMDAnKTsKCXZhciBwdXJwbGUgPSBuZXcgQ29sb3IoWzI1NSwwLDI1NV0pOwoJLy8gbWl4IGJsYWNrIHdpdGggd2hpdGUgYW5kIHB1cnBsZSwgZWFjaCB0aW1lIGF0IDEwJSBvZiB0aGUgbmV3IGNvbG9yCgl2YXIgZGFya3B1cnBsZSA9IGJsYWNrLm1peCgnI2ZmZicsIHB1cnBsZSwgMTApOwoJJCgnbXlEaXYnKS5zZXRTdHlsZSgnYmFja2dyb3VuZC1jb2xvcicsIGRhcmtwdXJwbGUpOwoJKGVuZCkKKi8KCnZhciBDb2xvciA9IG5ldyBDbGFzcyh7CgoJaW5pdGlhbGl6ZTogZnVuY3Rpb24oY29sb3IsIHR5cGUpewoJCXR5cGUgPSB0eXBlIHx8IChjb2xvci5wdXNoID8gJ3JnYicgOiAnaGV4Jyk7CgkJdmFyIHJnYiwgaHNiOwoJCXN3aXRjaCh0eXBlKXsKCQkJY2FzZSAncmdiJzoKCQkJCXJnYiA9IGNvbG9yOwoJCQkJaHNiID0gcmdiLnJnYlRvSHNiKCk7CgkJCQlicmVhazsKCQkJY2FzZSAnaHNiJzoKCQkJCXJnYiA9IGNvbG9yLmhzYlRvUmdiKCk7CgkJCQloc2IgPSBjb2xvcjsKCQkJCWJyZWFrOwoJCQlkZWZhdWx0OgoJCQkJcmdiID0gY29sb3IuaGV4VG9SZ2IodHJ1ZSk7CgkJCQloc2IgPSByZ2IucmdiVG9Ic2IoKTsKCQl9CgkJcmdiLmhzYiA9IGhzYjsKCQlyZ2IuaGV4ID0gcmdiLnJnYlRvSGV4KCk7CgkJcmV0dXJuICRleHRlbmQocmdiLCBDb2xvci5wcm90b3R5cGUpOwoJfSwKCgkvKgoJUHJvcGVydHk6IG1peAoJCU1peGVzIHR3byBvciBtb3JlIGNvbG9ycyB3aXRoIHRoZSBDb2xvci4KCglBcmd1bWVudHM6CgkJY29sb3IgLSBhIGNvbG9yIHRvIG1peC4geW91IGNhbiB1c2UgYXMgYXJndW1lbnRzIGhvdyBtYW55IGNvbG9ycyBhcyB5b3Ugd2FudCB0byBtaXggd2l0aCB0aGUgb3JpZ2luYWwgb25lLgoJCWFscGhhIC0gaWYgeW91IHVzZSBhIG51bWJlciBhcyB0aGUgbGFzdCBhcmd1bWVudCwgaXQgd2lsbCBiZSB0aHJlYXRlZCBhcyB0aGUgYW1vdW50IG9mIHRoZSBjb2xvciB0byBtaXguCgkqLwoKCW1peDogZnVuY3Rpb24oKXsKCQl2YXIgY29sb3JzID0gJEEoYXJndW1lbnRzKTsKCQl2YXIgYWxwaGEgPSAoJHR5cGUoY29sb3JzW2NvbG9ycy5sZW5ndGggLSAxXSkgPT0gJ251bWJlcicpID8gY29sb3JzLnBvcCgpIDogNTA7CgkJdmFyIHJnYiA9IHRoaXMuY29weSgpOwoJCWNvbG9ycy5lYWNoKGZ1bmN0aW9uKGNvbG9yKXsKCQkJY29sb3IgPSBuZXcgQ29sb3IoY29sb3IpOwoJCQlmb3IgKHZhciBpID0gMDsgaSA8IDM7IGkrKykgcmdiW2ldID0gTWF0aC5yb3VuZCgocmdiW2ldIC8gMTAwICogKDEwMCAtIGFscGhhKSkgKyAoY29sb3JbaV0gLyAxMDAgKiBhbHBoYSkpOwoJCX0pOwoJCXJldHVybiBuZXcgQ29sb3IocmdiLCAncmdiJyk7Cgl9LAoKCS8qCglQcm9wZXJ0eTogaW52ZXJ0CgkJSW52ZXJ0cyB0aGUgQ29sb3IuCgkqLwoKCWludmVydDogZnVuY3Rpb24oKXsKCQlyZXR1cm4gbmV3IENvbG9yKHRoaXMubWFwKGZ1bmN0aW9uKHZhbHVlKXsKCQkJcmV0dXJuIDI1NSAtIHZhbHVlOwoJCX0pKTsKCX0sCgoJLyoKCVByb3BlcnR5OiBzZXRIdWUKCQlNb2RpZmllcyB0aGUgaHVlIG9mIHRoZSBDb2xvciwgYW5kIHJldHVybnMgYSBuZXcgb25lLgoKCUFyZ3VtZW50czoKCQl2YWx1ZSAtIHRoZSBodWUgdG8gc2V0CgkqLwoKCXNldEh1ZTogZnVuY3Rpb24odmFsdWUpewoJCXJldHVybiBuZXcgQ29sb3IoW3ZhbHVlLCB0aGlzLmhzYlsxXSwgdGhpcy5oc2JbMl1dLCAnaHNiJyk7Cgl9LAoKCS8qCglQcm9wZXJ0eTogc2V0U2F0dXJhdGlvbgoJCUNoYW5nZXMgdGhlIHNhdHVyYXRpb24gb2YgdGhlIENvbG9yLCBhbmQgcmV0dXJucyBhIG5ldyBvbmUuCgoJQXJndW1lbnRzOgoJCXBlcmNlbnQgLSB0aGUgcGVyY2VudGFnZSBvZiB0aGUgc2F0dXJhdGlvbiB0byBzZXQKCSovCgoJc2V0U2F0dXJhdGlvbjogZnVuY3Rpb24ocGVyY2VudCl7CgkJcmV0dXJuIG5ldyBDb2xvcihbdGhpcy5oc2JbMF0sIHBlcmNlbnQsIHRoaXMuaHNiWzJdXSwgJ2hzYicpOwoJfSwKCgkvKgoJUHJvcGVydHk6IHNldEJyaWdodG5lc3MKCQlDaGFuZ2VzIHRoZSBicmlnaHRuZXNzIG9mIHRoZSBDb2xvciwgYW5kIHJldHVybnMgYSBuZXcgb25lLgoKCUFyZ3VtZW50czoKCQlwZXJjZW50IC0gdGhlIHBlcmNlbnRhZ2Ugb2YgdGhlIGJyaWdodG5lc3MgdG8gc2V0CgkqLwoKCXNldEJyaWdodG5lc3M6IGZ1bmN0aW9uKHBlcmNlbnQpewoJCXJldHVybiBuZXcgQ29sb3IoW3RoaXMuaHNiWzBdLCB0aGlzLmhzYlsxXSwgcGVyY2VudF0sICdoc2InKTsKCX0KCn0pOwoKLyogU2VjdGlvbjogVXRpbGl0eSBGdW5jdGlvbnMgKi8KCi8qCkZ1bmN0aW9uOiAkUkdCCglTaG9ydGN1dCB0byBjcmVhdGUgYSBuZXcgY29sb3IsIGJhc2VkIG9uIHJlZCwgZ3JlZW4sIGJsdWUgdmFsdWVzLgoKQXJndW1lbnRzOgoJciAtIChpbnRlZ2VyKSByZWQgdmFsdWUgKDAtMjU1KQoJZyAtIChpbnRlZ2VyKSBncmVlbiB2YWx1ZSAoMC0yNTUpCgliIC0gKGludGVnZXIpIGJsdWUgdmFsdWUgKDAtMjU1KQoKKi8KCmZ1bmN0aW9uICRSR0IociwgZywgYil7CglyZXR1cm4gbmV3IENvbG9yKFtyLCBnLCBiXSwgJ3JnYicpOwp9OwoKLyoKRnVuY3Rpb246ICRIU0IKCVNob3J0Y3V0IHRvIGNyZWF0ZSBhIG5ldyBjb2xvciwgYmFzZWQgb24gaHVlLCBzYXR1cmF0aW9uLCBicmlnaHRuZXNzIHZhbHVlcy4KCkFyZ3VtZW50czoKCWggLSAoaW50ZWdlcikgaHVlIHZhbHVlICgwLTEwMCkKCXMgLSAoaW50ZWdlcikgc2F0dXJhdGlvbiB2YWx1ZSAoMC0xMDApCgliIC0gKGludGVnZXIpIGJyaWdodG5lc3MgdmFsdWUgKDAtMTAwKQoqLwoKZnVuY3Rpb24gJEhTQihoLCBzLCBiKXsKCXJldHVybiBuZXcgQ29sb3IoW2gsIHMsIGJdLCAnaHNiJyk7Cn07CgovKgpDbGFzczogQXJyYXkKCUEgY29sbGVjdGlvbiBvZiBUaGUgQXJyYXkgT2JqZWN0IHByb3RvdHlwZSBtZXRob2RzLgoqLwoKQXJyYXkuZXh0ZW5kKHsKCgkvKgoJUHJvcGVydHk6IHJnYlRvSHNiCgkJQ29udmVydHMgYSBSR0IgYXJyYXkgdG8gYW4gSFNCIGFycmF5LgoKCVJldHVybnM6CgkJdGhlIEhTQiBhcnJheS4KCSovCgoJcmdiVG9Ic2I6IGZ1bmN0aW9uKCl7CgkJdmFyIHJlZCA9IHRoaXNbMF0sIGdyZWVuID0gdGhpc1sxXSwgYmx1ZSA9IHRoaXNbMl07CgkJdmFyIGh1ZSwgc2F0dXJhdGlvbiwgYnJpZ2h0bmVzczsKCQl2YXIgbWF4ID0gTWF0aC5tYXgocmVkLCBncmVlbiwgYmx1ZSksIG1pbiA9IE1hdGgubWluKHJlZCwgZ3JlZW4sIGJsdWUpOwoJCXZhciBkZWx0YSA9IG1heCAtIG1pbjsKCQlicmlnaHRuZXNzID0gbWF4IC8gMjU1OwoJCXNhdHVyYXRpb24gPSAobWF4ICE9IDApID8gZGVsdGEgLyBtYXggOiAwOwoJCWlmIChzYXR1cmF0aW9uID09IDApewoJCQlodWUgPSAwOwoJCX0gZWxzZSB7CgkJCXZhciByciA9IChtYXggLSByZWQpIC8gZGVsdGE7CgkJCXZhciBnciA9IChtYXggLSBncmVlbikgLyBkZWx0YTsKCQkJdmFyIGJyID0gKG1heCAtIGJsdWUpIC8gZGVsdGE7CgkJCWlmIChyZWQgPT0gbWF4KSBodWUgPSBiciAtIGdyOwoJCQllbHNlIGlmIChncmVlbiA9PSBtYXgpIGh1ZSA9IDIgKyByciAtIGJyOwoJCQllbHNlIGh1ZSA9IDQgKyBnciAtIHJyOwoJCQlodWUgLz0gNjsKCQkJaWYgKGh1ZSA8IDApIGh1ZSsrOwoJCX0KCQlyZXR1cm4gW01hdGgucm91bmQoaHVlICogMzYwKSwgTWF0aC5yb3VuZChzYXR1cmF0aW9uICogMTAwKSwgTWF0aC5yb3VuZChicmlnaHRuZXNzICogMTAwKV07Cgl9LAoKCS8qCglQcm9wZXJ0eTogaHNiVG9SZ2IKCQlDb252ZXJ0cyBhbiBIU0IgYXJyYXkgdG8gYW4gUkdCIGFycmF5LgoKCVJldHVybnM6CgkJdGhlIFJHQiBhcnJheS4KCSovCgoJaHNiVG9SZ2I6IGZ1bmN0aW9uKCl7CgkJdmFyIGJyID0gTWF0aC5yb3VuZCh0aGlzWzJdIC8gMTAwICogMjU1KTsKCQlpZiAodGhpc1sxXSA9PSAwKXsKCQkJcmV0dXJuIFticiwgYnIsIGJyXTsKCQl9IGVsc2UgewoJCQl2YXIgaHVlID0gdGhpc1swXSAlIDM2MDsKCQkJdmFyIGYgPSBodWUgJSA2MDsKCQkJdmFyIHAgPSBNYXRoLnJvdW5kKCh0aGlzWzJdICogKDEwMCAtIHRoaXNbMV0pKSAvIDEwMDAwICogMjU1KTsKCQkJdmFyIHEgPSBNYXRoLnJvdW5kKCh0aGlzWzJdICogKDYwMDAgLSB0aGlzWzFdICogZikpIC8gNjAwMDAwICogMjU1KTsKCQkJdmFyIHQgPSBNYXRoLnJvdW5kKCh0aGlzWzJdICogKDYwMDAgLSB0aGlzWzFdICogKDYwIC0gZikpKSAvIDYwMDAwMCAqIDI1NSk7CgkJCXN3aXRjaChNYXRoLmZsb29yKGh1ZSAvIDYwKSl7CgkJCQljYXNlIDA6IHJldHVybiBbYnIsIHQsIHBdOwoJCQkJY2FzZSAxOiByZXR1cm4gW3EsIGJyLCBwXTsKCQkJCWNhc2UgMjogcmV0dXJuIFtwLCBiciwgdF07CgkJCQljYXNlIDM6IHJldHVybiBbcCwgcSwgYnJdOwoJCQkJY2FzZSA0OiByZXR1cm4gW3QsIHAsIGJyXTsKCQkJCWNhc2UgNTogcmV0dXJuIFticiwgcCwgcV07CgkJCX0KCQl9CgkJcmV0dXJuIGZhbHNlOwoJfQoKfSk7CgovKgpTY3JpcHQ6IFNjcm9sbGVyLmpzCglDb250YWlucyB0aGUgPFNjcm9sbGVyPi4KCkxpY2Vuc2U6CglNSVQtc3R5bGUgbGljZW5zZS4KKi8KCi8qCkNsYXNzOiBTY3JvbGxlcgoJVGhlIFNjcm9sbGVyIGlzIGEgY2xhc3MgdG8gc2Nyb2xsIGFueSBlbGVtZW50IHdpdGggYW4gb3ZlcmZsb3cgKGluY2x1ZGluZyB0aGUgd2luZG93KSB3aGVuIHRoZSBtb3VzZSBjdXJzb3IgcmVhY2hlcyBjZXJ0YWluIGJ1b25kYXJpZXMgb2YgdGhhdCBlbGVtZW50LgoJWW91IG11c3QgY2FsbCBpdHMgc3RhcnQgbWV0aG9kIHRvIHN0YXJ0IGxpc3RlbmluZyB0byBtb3VzZSBtb3ZlbWVudHMuCgpOb3RlOgoJVGhlIFNjcm9sbGVyIHJlcXVpcmVzIGFuIFhIVE1MIGRvY3R5cGUuCgpBcmd1bWVudHM6CgllbGVtZW50IC0gcmVxdWlyZWQsIHRoZSBlbGVtZW50IHRvIHNjcm9sbC4KCW9wdGlvbnMgLSBvcHRpb25hbCwgc2VlIG9wdGlvbnMgYmVsb3csIGFuZCA8RnguQmFzZT4gb3B0aW9ucy4KCk9wdGlvbnM6CglhcmVhIC0gaW50ZWdlciwgdGhlIG5lY2Vzc2FyeSBib3VuZGFyaWVzIHRvIG1ha2UgdGhlIGVsZW1lbnQgc2Nyb2xsLgoJdmVsb2NpdHkgLSBpbnRlZ2VyLCB2ZWxvY2l0eSByYXRpbywgdGhlIG1vZGlmaWVyIGZvciB0aGUgd2luZG93IHNjcm9sbGluZyBzcGVlZC4KCkV2ZW50czoKCW9uQ2hhbmdlIC0gb3B0aW9uYWxseSwgd2hlbiB0aGUgbW91c2UgcmVhY2hlcyBzb21lIGJvdW5kYXJpZXMsIHlvdSBjYW4gY2hvb3NlIHRvIGFsdGVyIHNvbWUgb3RoZXIgdmFsdWVzLCBpbnN0ZWFkIG9mIHRoZSBzY3JvbGxpbmcgb2Zmc2V0cy4KCQlBdXRvbWF0aWNhbGx5IHBhc3NlcyBhcyBwYXJhbWV0ZXJzIHggYW5kIHkgdmFsdWVzLgoqLwoKdmFyIFNjcm9sbGVyID0gbmV3IENsYXNzKHsKCglvcHRpb25zOiB7CgkJYXJlYTogMjAsCgkJdmVsb2NpdHk6IDEsCgkJb25DaGFuZ2U6IGZ1bmN0aW9uKHgsIHkpewoJCQl0aGlzLmVsZW1lbnQuc2Nyb2xsVG8oeCwgeSk7CgkJfQoJfSwKCglpbml0aWFsaXplOiBmdW5jdGlvbihlbGVtZW50LCBvcHRpb25zKXsKCQl0aGlzLnNldE9wdGlvbnMob3B0aW9ucyk7CgkJdGhpcy5lbGVtZW50ID0gJChlbGVtZW50KTsKCQl0aGlzLm1vdXNlbW92ZXIgPSAoW3dpbmRvdywgZG9jdW1lbnRdLmNvbnRhaW5zKGVsZW1lbnQpKSA/ICQoZG9jdW1lbnQuYm9keSkgOiB0aGlzLmVsZW1lbnQ7Cgl9LAoKCS8qCglQcm9wZXJ0eTogc3RhcnQKCQlUaGUgc2Nyb2xsZXIgc3RhcnRzIGxpc3RlbmluZyB0byBtb3VzZSBtb3ZlbWVudHMuCgkqLwoKCXN0YXJ0OiBmdW5jdGlvbigpewoJCXRoaXMuY29vcmQgPSB0aGlzLmdldENvb3Jkcy5iaW5kV2l0aEV2ZW50KHRoaXMpOwoJCXRoaXMubW91c2Vtb3Zlci5hZGRMaXN0ZW5lcignbW91c2Vtb3ZlJywgdGhpcy5jb29yZCk7Cgl9LAoKCS8qCglQcm9wZXJ0eTogc3RvcAoJCVRoZSBzY3JvbGxlciBzdG9wcyBsaXN0ZW5pbmcgdG8gbW91c2UgbW92ZW1lbnRzLgoJKi8KCglzdG9wOiBmdW5jdGlvbigpewoJCXRoaXMubW91c2Vtb3Zlci5yZW1vdmVMaXN0ZW5lcignbW91c2Vtb3ZlJywgdGhpcy5jb29yZCk7CgkJdGhpcy50aW1lciA9ICRjbGVhcih0aGlzLnRpbWVyKTsKCX0sCgoJZ2V0Q29vcmRzOiBmdW5jdGlvbihldmVudCl7CgkJdGhpcy5wYWdlID0gKHRoaXMuZWxlbWVudCA9PSB3aW5kb3cpID8gZXZlbnQuY2xpZW50IDogZXZlbnQucGFnZTsKCQlpZiAoIXRoaXMudGltZXIpIHRoaXMudGltZXIgPSB0aGlzLnNjcm9sbC5wZXJpb2RpY2FsKDUwLCB0aGlzKTsKCX0sCgoJc2Nyb2xsOiBmdW5jdGlvbigpewoJCXZhciBlbCA9IHRoaXMuZWxlbWVudC5nZXRTaXplKCk7CgkJdmFyIHBvcyA9IHRoaXMuZWxlbWVudC5nZXRQb3NpdGlvbigpOwoKCQl2YXIgY2hhbmdlID0geyd4JzogMCwgJ3knOiAwfTsKCQlmb3IgKHZhciB6IGluIHRoaXMucGFnZSl7CgkJCWlmICh0aGlzLnBhZ2Vbel0gPCAodGhpcy5vcHRpb25zLmFyZWEgKyBwb3Nbel0pICYmIGVsLnNjcm9sbFt6XSAhPSAwKQoJCQkJY2hhbmdlW3pdID0gKHRoaXMucGFnZVt6XSAtIHRoaXMub3B0aW9ucy5hcmVhIC0gcG9zW3pdKSAqIHRoaXMub3B0aW9ucy52ZWxvY2l0eTsKCQkJZWxzZSBpZiAodGhpcy5wYWdlW3pdICsgdGhpcy5vcHRpb25zLmFyZWEgPiAoZWwuc2l6ZVt6XSArIHBvc1t6XSkgJiYgZWwuc2Nyb2xsW3pdICsgZWwuc2l6ZVt6XSAhPSBlbC5zY3JvbGxTaXplW3pdKQoJCQkJY2hhbmdlW3pdID0gKHRoaXMucGFnZVt6XSAtIGVsLnNpemVbel0gKyB0aGlzLm9wdGlvbnMuYXJlYSAtIHBvc1t6XSkgKiB0aGlzLm9wdGlvbnMudmVsb2NpdHk7CgkJfQoJCWlmIChjaGFuZ2UueSB8fCBjaGFuZ2UueCkgdGhpcy5maXJlRXZlbnQoJ29uQ2hhbmdlJywgW2VsLnNjcm9sbC54ICsgY2hhbmdlLngsIGVsLnNjcm9sbC55ICsgY2hhbmdlLnldKTsKCX0KCn0pOwoKU2Nyb2xsZXIuaW1wbGVtZW50KG5ldyBFdmVudHMsIG5ldyBPcHRpb25zKTsKCi8qClNjcmlwdDogU2xpZGVyLmpzCglDb250YWlucyA8U2xpZGVyPgoKTGljZW5zZToKCU1JVC1zdHlsZSBsaWNlbnNlLgoqLwoKLyoKQ2xhc3M6IFNsaWRlcgoJQ3JlYXRlcyBhIHNsaWRlciB3aXRoIHR3byBlbGVtZW50czogYSBrbm9iIGFuZCBhIGNvbnRhaW5lci4gUmV0dXJucyB0aGUgdmFsdWVzLgoKTm90ZToKCVRoZSBTbGlkZXIgcmVxdWlyZXMgYW4gWEhUTUwgZG9jdHlwZS4KCkFyZ3VtZW50czoKCWVsZW1lbnQgLSB0aGUga25vYiBjb250YWluZXIKCWtub2IgLSB0aGUgaGFuZGxlCglvcHRpb25zIC0gc2VlIE9wdGlvbnMgYmVsb3cKCk9wdGlvbnM6CglzdGVwcyAtIHRoZSBudW1iZXIgb2Ygc3RlcHMgZm9yIHlvdXIgc2xpZGVyLgoJbW9kZSAtIGVpdGhlciAnaG9yaXpvbnRhbCcgb3IgJ3ZlcnRpY2FsJy4gZGVmYXVsdHMgdG8gaG9yaXpvbnRhbC4KCW9mZnNldCAtIHJlbGF0aXZlIG9mZnNldCBmb3Iga25vYiBwb3NpdGlvbi4gZGVmYXVsdCB0byAwLgoKRXZlbnRzOgoJb25DaGFuZ2UgLSBhIGZ1bmN0aW9uIHRvIGZpcmUgd2hlbiB0aGUgdmFsdWUgY2hhbmdlcy4KCW9uQ29tcGxldGUgLSBhIGZ1bmN0aW9uIHRvIGZpcmUgd2hlbiB5b3UncmUgZG9uZSBkcmFnZ2luZy4KCW9uVGljayAtIG9wdGlvbmFsbHksIHlvdSBjYW4gYWx0ZXIgdGhlIG9uVGljayBiZWhhdmlvciwgZm9yIGV4YW1wbGUgZGlzcGxheWluZyBhbiBlZmZlY3Qgb2YgdGhlIGtub2IgbW92aW5nIHRvIHRoZSBkZXNpcmVkIHBvc2l0aW9uLgoJCVBhc3NlcyBhcyBwYXJhbWV0ZXIgdGhlIG5ldyBwb3NpdGlvbi4KKi8KCnZhciBTbGlkZXIgPSBuZXcgQ2xhc3MoewoKCW9wdGlvbnM6IHsKCQlvbkNoYW5nZTogQ2xhc3MuZW1wdHksCgkJb25Db21wbGV0ZTogQ2xhc3MuZW1wdHksCgkJb25UaWNrOiBmdW5jdGlvbihwb3MpewoJCQl0aGlzLmtub2Iuc2V0U3R5bGUodGhpcy5wLCBwb3MpOwoJCX0sCgkJbW9kZTogJ2hvcml6b250YWwnLAoJCXN0ZXBzOiAxMDAsCgkJb2Zmc2V0OiAwCgl9LAoKCWluaXRpYWxpemU6IGZ1bmN0aW9uKGVsLCBrbm9iLCBvcHRpb25zKXsKCQl0aGlzLmVsZW1lbnQgPSAkKGVsKTsKCQl0aGlzLmtub2IgPSAkKGtub2IpOwoJCXRoaXMuc2V0T3B0aW9ucyhvcHRpb25zKTsKCQl0aGlzLnByZXZpb3VzQ2hhbmdlID0gLTE7CgkJdGhpcy5wcmV2aW91c0VuZCA9IC0xOwoJCXRoaXMuc3RlcCA9IC0xOwoJCXRoaXMuZWxlbWVudC5hZGRFdmVudCgnbW91c2Vkb3duJywgdGhpcy5jbGlja2VkRWxlbWVudC5iaW5kV2l0aEV2ZW50KHRoaXMpKTsKCQl2YXIgbW9kLCBvZmZzZXQ7CgkJc3dpdGNoKHRoaXMub3B0aW9ucy5tb2RlKXsKCQkJY2FzZSAnaG9yaXpvbnRhbCc6CgkJCQl0aGlzLnogPSAneCc7CgkJCQl0aGlzLnAgPSAnbGVmdCc7CgkJCQltb2QgPSB7J3gnOiAnbGVmdCcsICd5JzogZmFsc2V9OwoJCQkJb2Zmc2V0ID0gJ29mZnNldFdpZHRoJzsKCQkJCWJyZWFrOwoJCQljYXNlICd2ZXJ0aWNhbCc6CgkJCQl0aGlzLnogPSAneSc7CgkJCQl0aGlzLnAgPSAndG9wJzsKCQkJCW1vZCA9IHsneCc6IGZhbHNlLCAneSc6ICd0b3AnfTsKCQkJCW9mZnNldCA9ICdvZmZzZXRIZWlnaHQnOwoJCX0KCQl0aGlzLm1heCA9IHRoaXMuZWxlbWVudFtvZmZzZXRdIC0gdGhpcy5rbm9iW29mZnNldF0gKyAodGhpcy5vcHRpb25zLm9mZnNldCAqIDIpOwoJCXRoaXMuaGFsZiA9IHRoaXMua25vYltvZmZzZXRdLzI7CgkJdGhpcy5nZXRQb3MgPSB0aGlzLmVsZW1lbnRbJ2dldCcgKyB0aGlzLnAuY2FwaXRhbGl6ZSgpXS5iaW5kKHRoaXMuZWxlbWVudCk7CgkJdGhpcy5rbm9iLnNldFN0eWxlKCdwb3NpdGlvbicsICdyZWxhdGl2ZScpLnNldFN0eWxlKHRoaXMucCwgLSB0aGlzLm9wdGlvbnMub2Zmc2V0KTsKCQl2YXIgbGltID0ge307CgkJbGltW3RoaXMuel0gPSBbLSB0aGlzLm9wdGlvbnMub2Zmc2V0LCB0aGlzLm1heCAtIHRoaXMub3B0aW9ucy5vZmZzZXRdOwoJCXRoaXMuZHJhZyA9IG5ldyBEcmFnLkJhc2UodGhpcy5rbm9iLCB7CgkJCWxpbWl0OiBsaW0sCgkJCW1vZGlmaWVyczogbW9kLAoJCQlzbmFwOiAwLAoJCQlvblN0YXJ0OiBmdW5jdGlvbigpewoJCQkJdGhpcy5kcmFnZ2VkS25vYigpOwoJCQl9LmJpbmQodGhpcyksCgkJCW9uRHJhZzogZnVuY3Rpb24oKXsKCQkJCXRoaXMuZHJhZ2dlZEtub2IoKTsKCQkJfS5iaW5kKHRoaXMpLAoJCQlvbkNvbXBsZXRlOiBmdW5jdGlvbigpewoJCQkJdGhpcy5kcmFnZ2VkS25vYigpOwoJCQkJdGhpcy5lbmQoKTsKCQkJfS5iaW5kKHRoaXMpCgkJfSk7CgkJaWYgKHRoaXMub3B0aW9ucy5pbml0aWFsaXplKSB0aGlzLm9wdGlvbnMuaW5pdGlhbGl6ZS5jYWxsKHRoaXMpOwoJfSwKCgkvKgoJUHJvcGVydHk6IHNldAoJCVRoZSBzbGlkZXIgd2lsbCBnZXQgdGhlIHN0ZXAgeW91IHBhc3MuCgoJQXJndW1lbnRzOgoJCXN0ZXAgLSBvbmUgaW50ZWdlcgoJKi8KCglzZXQ6IGZ1bmN0aW9uKHN0ZXApewoJCXRoaXMuc3RlcCA9IHN0ZXAubGltaXQoMCwgdGhpcy5vcHRpb25zLnN0ZXBzKTsKCQl0aGlzLmNoZWNrU3RlcCgpOwoJCXRoaXMuZW5kKCk7CgkJdGhpcy5maXJlRXZlbnQoJ29uVGljaycsIHRoaXMudG9Qb3NpdGlvbih0aGlzLnN0ZXApKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJY2xpY2tlZEVsZW1lbnQ6IGZ1bmN0aW9uKGV2ZW50KXsKCQl2YXIgcG9zaXRpb24gPSBldmVudC5wYWdlW3RoaXMuel0gLSB0aGlzLmdldFBvcygpIC0gdGhpcy5oYWxmOwoJCXBvc2l0aW9uID0gcG9zaXRpb24ubGltaXQoLXRoaXMub3B0aW9ucy5vZmZzZXQsIHRoaXMubWF4IC10aGlzLm9wdGlvbnMub2Zmc2V0KTsKCQl0aGlzLnN0ZXAgPSB0aGlzLnRvU3RlcChwb3NpdGlvbik7CgkJdGhpcy5jaGVja1N0ZXAoKTsKCQl0aGlzLmVuZCgpOwoJCXRoaXMuZmlyZUV2ZW50KCdvblRpY2snLCBwb3NpdGlvbik7Cgl9LAoKCWRyYWdnZWRLbm9iOiBmdW5jdGlvbigpewoJCXRoaXMuc3RlcCA9IHRoaXMudG9TdGVwKHRoaXMuZHJhZy52YWx1ZS5ub3dbdGhpcy56XSk7CgkJdGhpcy5jaGVja1N0ZXAoKTsKCX0sCgoJY2hlY2tTdGVwOiBmdW5jdGlvbigpewoJCWlmICh0aGlzLnByZXZpb3VzQ2hhbmdlICE9IHRoaXMuc3RlcCl7CgkJCXRoaXMucHJldmlvdXNDaGFuZ2UgPSB0aGlzLnN0ZXA7CgkJCXRoaXMuZmlyZUV2ZW50KCdvbkNoYW5nZScsIHRoaXMuc3RlcCk7CgkJfQoJfSwKCgllbmQ6IGZ1bmN0aW9uKCl7CgkJaWYgKHRoaXMucHJldmlvdXNFbmQgIT09IHRoaXMuc3RlcCl7CgkJCXRoaXMucHJldmlvdXNFbmQgPSB0aGlzLnN0ZXA7CgkJCXRoaXMuZmlyZUV2ZW50KCdvbkNvbXBsZXRlJywgdGhpcy5zdGVwICsgJycpOwoJCX0KCX0sCgoJdG9TdGVwOiBmdW5jdGlvbihwb3NpdGlvbil7CgkJcmV0dXJuIE1hdGgucm91bmQoKHBvc2l0aW9uICsgdGhpcy5vcHRpb25zLm9mZnNldCkgLyB0aGlzLm1heCAqIHRoaXMub3B0aW9ucy5zdGVwcyk7Cgl9LAoKCXRvUG9zaXRpb246IGZ1bmN0aW9uKHN0ZXApewoJCXJldHVybiB0aGlzLm1heCAqIHN0ZXAgLyB0aGlzLm9wdGlvbnMuc3RlcHM7Cgl9Cgp9KTsKClNsaWRlci5pbXBsZW1lbnQobmV3IEV2ZW50cyk7ClNsaWRlci5pbXBsZW1lbnQobmV3IE9wdGlvbnMpOwoKLyoKU2NyaXB0OiBTbW9vdGhTY3JvbGwuanMKCUNvbnRhaW5zIDxTbW9vdGhTY3JvbGw+CgpMaWNlbnNlOgoJTUlULXN0eWxlIGxpY2Vuc2UuCiovCgovKgpDbGFzczogU21vb3RoU2Nyb2xsCglBdXRvIHRhcmdldHMgYWxsIHRoZSBhbmNob3JzIGluIGEgcGFnZSBhbmQgZGlzcGxheSBhIHNtb290aCBzY3JvbGxpbmcgZWZmZWN0IHVwb24gY2xpY2tpbmcgdGhlbS4KCUluaGVyaXRzIG1ldGhvZHMsIHByb3BlcnRpZXMsIG9wdGlvbnMgYW5kIGV2ZW50cyBmcm9tIDxGeC5TY3JvbGw+LgoKTm90ZToKCVNtb290aFNjcm9sbCByZXF1aXJlcyBhbiBYSFRNTCBkb2N0eXBlLgoKQXJndW1lbnRzOgoJb3B0aW9ucyAtIHRoZSBGeC5TY3JvbGwgb3B0aW9ucyAoc2VlOiA8RnguU2Nyb2xsPikgcGx1cyBsaW5rcywgYSBjb2xsZWN0aW9uIG9mIGVsZW1lbnRzIHlvdSB3YW50IHlvdXIgc21vb3Roc2Nyb2xsIG9uLiBEZWZhdWx0cyB0byBkb2N1bWVudC5saW5rcy4KCkV4YW1wbGU6Cgk+bmV3IFNtb290aFNjcm9sbCgpOwoqLwoKdmFyIFNtb290aFNjcm9sbCA9IEZ4LlNjcm9sbC5leHRlbmQoewoKCWluaXRpYWxpemU6IGZ1bmN0aW9uKG9wdGlvbnMpewoJCXRoaXMucGFyZW50KHdpbmRvdywgb3B0aW9ucyk7CgkJdGhpcy5saW5rcyA9ICh0aGlzLm9wdGlvbnMubGlua3MpID8gJCQodGhpcy5vcHRpb25zLmxpbmtzKSA6ICQkKGRvY3VtZW50LmxpbmtzKTsKCQl2YXIgbG9jYXRpb24gPSB3aW5kb3cubG9jYXRpb24uaHJlZi5tYXRjaCgvXlteI10qLylbMF0gKyAnIyc7CgkJdGhpcy5saW5rcy5lYWNoKGZ1bmN0aW9uKGxpbmspewoJCQlpZiAobGluay5ocmVmLmluZGV4T2YobG9jYXRpb24pICE9IDApIHJldHVybjsKCQkJdmFyIGFuY2hvciA9IGxpbmsuaHJlZi5zdWJzdHIobG9jYXRpb24ubGVuZ3RoKTsKCQkJaWYgKGFuY2hvciAmJiAkKGFuY2hvcikpIHRoaXMudXNlTGluayhsaW5rLCBhbmNob3IpOwoJCX0sIHRoaXMpOwoJCWlmICghd2luZG93LndlYmtpdDQxOSkgdGhpcy5hZGRFdmVudCgnb25Db21wbGV0ZScsIGZ1bmN0aW9uKCl7CgkJCXdpbmRvdy5sb2NhdGlvbi5oYXNoID0gdGhpcy5hbmNob3I7CgkJfSk7Cgl9LAoKCXVzZUxpbms6IGZ1bmN0aW9uKGxpbmssIGFuY2hvcil7CgkJbGluay5hZGRFdmVudCgnY2xpY2snLCBmdW5jdGlvbihldmVudCl7CgkJCXRoaXMuYW5jaG9yID0gYW5jaG9yOwoJCQl0aGlzLnRvRWxlbWVudChhbmNob3IpOwoJCQlldmVudC5zdG9wKCk7CgkJfS5iaW5kV2l0aEV2ZW50KHRoaXMpKTsKCX0KCn0pOwoKLyoKU2NyaXB0OiBTb3J0YWJsZXMuanMKCUNvbnRhaW5zIDxTb3J0YWJsZXM+IENsYXNzLgoKTGljZW5zZToKCU1JVC1zdHlsZSBsaWNlbnNlLgoqLwoKLyoKQ2xhc3M6IFNvcnRhYmxlcwoJQ3JlYXRlcyBhbiBpbnRlcmZhY2UgZm9yIDxEcmFnLkJhc2U+IGFuZCBkcm9wLCByZXNvcnRpbmcgb2YgYSBsaXN0LgoKTm90ZToKCVRoZSBTb3J0YWJsZXMgcmVxdWlyZSBhbiBYSFRNTCBkb2N0eXBlLgoKQXJndW1lbnRzOgoJbGlzdCAtIHJlcXVpcmVkLCB0aGUgbGlzdCB0aGF0IHdpbGwgYmVjb21lIHNvcnRhYmxlLgoJb3B0aW9ucyAtIGFuIE9iamVjdCwgc2VlIG9wdGlvbnMgYmVsb3cuCgpPcHRpb25zOgoJaGFuZGxlcyAtIGEgY29sbGVjdGlvbiBvZiBlbGVtZW50cyB0byBiZSB1c2VkIGZvciBkcmFnIGhhbmRsZXMuIGRlZmF1bHRzIHRvIHRoZSBlbGVtZW50cy4KCkV2ZW50czoKCW9uU3RhcnQgLSBmdW5jdGlvbiBleGVjdXRlZCB3aGVuIHRoZSBpdGVtIHN0YXJ0cyBkcmFnZ2luZwoJb25Db21wbGV0ZSAtIGZ1bmN0aW9uIGV4ZWN1dGVkIHdoZW4gdGhlIGl0ZW0gZW5kcyBkcmFnZ2luZwoqLwoKdmFyIFNvcnRhYmxlcyA9IG5ldyBDbGFzcyh7CgoJb3B0aW9uczogewoJCWhhbmRsZXM6IGZhbHNlLAoJCW9uU3RhcnQ6IENsYXNzLmVtcHR5LAoJCW9uQ29tcGxldGU6IENsYXNzLmVtcHR5LAoJCWdob3N0OiB0cnVlLAoJCXNuYXA6IDMsCgkJb25EcmFnU3RhcnQ6IGZ1bmN0aW9uKGVsZW1lbnQsIGdob3N0KXsKCQkJZ2hvc3Quc2V0U3R5bGUoJ29wYWNpdHknLCAwLjcpOwoJCQllbGVtZW50LnNldFN0eWxlKCdvcGFjaXR5JywgMC43KTsKCQl9LAoJCW9uRHJhZ0NvbXBsZXRlOiBmdW5jdGlvbihlbGVtZW50LCBnaG9zdCl7CgkJCWVsZW1lbnQuc2V0U3R5bGUoJ29wYWNpdHknLCAxKTsKCQkJZ2hvc3QucmVtb3ZlKCk7CgkJCXRoaXMudHJhc2gucmVtb3ZlKCk7CgkJfQoJfSwKCglpbml0aWFsaXplOiBmdW5jdGlvbihsaXN0LCBvcHRpb25zKXsKCQl0aGlzLnNldE9wdGlvbnMob3B0aW9ucyk7CgkJdGhpcy5saXN0ID0gJChsaXN0KTsKCQl0aGlzLmVsZW1lbnRzID0gdGhpcy5saXN0LmdldENoaWxkcmVuKCk7CgkJdGhpcy5oYW5kbGVzID0gKHRoaXMub3B0aW9ucy5oYW5kbGVzKSA/ICQkKHRoaXMub3B0aW9ucy5oYW5kbGVzKSA6IHRoaXMuZWxlbWVudHM7CgkJdGhpcy5ib3VuZCA9IHsKCQkJJ3N0YXJ0JzogW10sCgkJCSdtb3ZlR2hvc3QnOiB0aGlzLm1vdmVHaG9zdC5iaW5kV2l0aEV2ZW50KHRoaXMpCgkJfTsKCQlmb3IgKHZhciBpID0gMCwgbCA9IHRoaXMuaGFuZGxlcy5sZW5ndGg7IGkgPCBsOyBpKyspewoJCQl0aGlzLmJvdW5kLnN0YXJ0W2ldID0gdGhpcy5zdGFydC5iaW5kV2l0aEV2ZW50KHRoaXMsIHRoaXMuZWxlbWVudHNbaV0pOwoJCX0KCQl0aGlzLmF0dGFjaCgpOwoJCWlmICh0aGlzLm9wdGlvbnMuaW5pdGlhbGl6ZSkgdGhpcy5vcHRpb25zLmluaXRpYWxpemUuY2FsbCh0aGlzKTsKCQl0aGlzLmJvdW5kLm1vdmUgPSB0aGlzLm1vdmUuYmluZFdpdGhFdmVudCh0aGlzKTsKCQl0aGlzLmJvdW5kLmVuZCA9IHRoaXMuZW5kLmJpbmQodGhpcyk7Cgl9LAoKCWF0dGFjaDogZnVuY3Rpb24oKXsKCQl0aGlzLmhhbmRsZXMuZWFjaChmdW5jdGlvbihoYW5kbGUsIGkpewoJCQloYW5kbGUuYWRkRXZlbnQoJ21vdXNlZG93bicsIHRoaXMuYm91bmQuc3RhcnRbaV0pOwoJCX0sIHRoaXMpOwoJfSwKCglkZXRhY2g6IGZ1bmN0aW9uKCl7CgkJdGhpcy5oYW5kbGVzLmVhY2goZnVuY3Rpb24oaGFuZGxlLCBpKXsKCQkJaGFuZGxlLnJlbW92ZUV2ZW50KCdtb3VzZWRvd24nLCB0aGlzLmJvdW5kLnN0YXJ0W2ldKTsKCQl9LCB0aGlzKTsKCX0sCgoJc3RhcnQ6IGZ1bmN0aW9uKGV2ZW50LCBlbCl7CgkJdGhpcy5hY3RpdmUgPSBlbDsKCQl0aGlzLmNvb3JkaW5hdGVzID0gdGhpcy5saXN0LmdldENvb3JkaW5hdGVzKCk7CgkJaWYgKHRoaXMub3B0aW9ucy5naG9zdCl7CgkJCXZhciBwb3NpdGlvbiA9IGVsLmdldFBvc2l0aW9uKCk7CgkJCXRoaXMub2Zmc2V0ID0gZXZlbnQucGFnZS55IC0gcG9zaXRpb24ueTsKCQkJdGhpcy50cmFzaCA9IG5ldyBFbGVtZW50KCdkaXYnKS5pbmplY3QoZG9jdW1lbnQuYm9keSk7CgkJCXRoaXMuZ2hvc3QgPSBlbC5jbG9uZSgpLmluamVjdCh0aGlzLnRyYXNoKS5zZXRTdHlsZXMoewoJCQkJJ3Bvc2l0aW9uJzogJ2Fic29sdXRlJywKCQkJCSdsZWZ0JzogcG9zaXRpb24ueCwKCQkJCSd0b3AnOiBldmVudC5wYWdlLnkgLSB0aGlzLm9mZnNldAoJCQl9KTsKCQkJZG9jdW1lbnQuYWRkTGlzdGVuZXIoJ21vdXNlbW92ZScsIHRoaXMuYm91bmQubW92ZUdob3N0KTsKCQkJdGhpcy5maXJlRXZlbnQoJ29uRHJhZ1N0YXJ0JywgW2VsLCB0aGlzLmdob3N0XSk7CgkJfQoJCWRvY3VtZW50LmFkZExpc3RlbmVyKCdtb3VzZW1vdmUnLCB0aGlzLmJvdW5kLm1vdmUpOwoJCWRvY3VtZW50LmFkZExpc3RlbmVyKCdtb3VzZXVwJywgdGhpcy5ib3VuZC5lbmQpOwoJCXRoaXMuZmlyZUV2ZW50KCdvblN0YXJ0JywgZWwpOwoJCWV2ZW50LnN0b3AoKTsKCX0sCgoJbW92ZUdob3N0OiBmdW5jdGlvbihldmVudCl7CgkJdmFyIHZhbHVlID0gZXZlbnQucGFnZS55IC0gdGhpcy5vZmZzZXQ7CgkJdmFsdWUgPSB2YWx1ZS5saW1pdCh0aGlzLmNvb3JkaW5hdGVzLnRvcCwgdGhpcy5jb29yZGluYXRlcy5ib3R0b20gLSB0aGlzLmdob3N0Lm9mZnNldEhlaWdodCk7CgkJdGhpcy5naG9zdC5zZXRTdHlsZSgndG9wJywgdmFsdWUpOwoJCWV2ZW50LnN0b3AoKTsKCX0sCgoJbW92ZTogZnVuY3Rpb24oZXZlbnQpewoJCXZhciBub3cgPSBldmVudC5wYWdlLnk7CgkJdGhpcy5wcmV2aW91cyA9IHRoaXMucHJldmlvdXMgfHwgbm93OwoJCXZhciB1cCA9ICgodGhpcy5wcmV2aW91cyAtIG5vdykgPiAwKTsKCQl2YXIgcHJldiA9IHRoaXMuYWN0aXZlLmdldFByZXZpb3VzKCk7CgkJdmFyIG5leHQgPSB0aGlzLmFjdGl2ZS5nZXROZXh0KCk7CgkJaWYgKHByZXYgJiYgdXAgJiYgbm93IDwgcHJldi5nZXRDb29yZGluYXRlcygpLmJvdHRvbSkgdGhpcy5hY3RpdmUuaW5qZWN0QmVmb3JlKHByZXYpOwoJCWlmIChuZXh0ICYmICF1cCAmJiBub3cgPiBuZXh0LmdldENvb3JkaW5hdGVzKCkudG9wKSB0aGlzLmFjdGl2ZS5pbmplY3RBZnRlcihuZXh0KTsKCQl0aGlzLnByZXZpb3VzID0gbm93OwoJfSwKCglzZXJpYWxpemU6IGZ1bmN0aW9uKGNvbnZlcnRlcil7CgkJcmV0dXJuIHRoaXMubGlzdC5nZXRDaGlsZHJlbigpLm1hcChjb252ZXJ0ZXIgfHwgZnVuY3Rpb24oZWwpewoJCQlyZXR1cm4gdGhpcy5lbGVtZW50cy5pbmRleE9mKGVsKTsKCQl9LCB0aGlzKTsKCX0sCgoJZW5kOiBmdW5jdGlvbigpewoJCXRoaXMucHJldmlvdXMgPSBudWxsOwoJCWRvY3VtZW50LnJlbW92ZUxpc3RlbmVyKCdtb3VzZW1vdmUnLCB0aGlzLmJvdW5kLm1vdmUpOwoJCWRvY3VtZW50LnJlbW92ZUxpc3RlbmVyKCdtb3VzZXVwJywgdGhpcy5ib3VuZC5lbmQpOwoJCWlmICh0aGlzLm9wdGlvbnMuZ2hvc3QpewoJCQlkb2N1bWVudC5yZW1vdmVMaXN0ZW5lcignbW91c2Vtb3ZlJywgdGhpcy5ib3VuZC5tb3ZlR2hvc3QpOwoJCQl0aGlzLmZpcmVFdmVudCgnb25EcmFnQ29tcGxldGUnLCBbdGhpcy5hY3RpdmUsIHRoaXMuZ2hvc3RdKTsKCQl9CgkJdGhpcy5maXJlRXZlbnQoJ29uQ29tcGxldGUnLCB0aGlzLmFjdGl2ZSk7Cgl9Cgp9KTsKClNvcnRhYmxlcy5pbXBsZW1lbnQobmV3IEV2ZW50cywgbmV3IE9wdGlvbnMpOwoKLyoKU2NyaXB0OiBUaXBzLmpzCglUb29sdGlwcywgQnViYmxlVGlwcywgd2hhdGV2ZXIgdGhleSBhcmUsIHRoZXkgd2lsbCBhcHBlYXIgb24gbW91c2VvdmVyCgpMaWNlbnNlOgoJTUlULXN0eWxlIGxpY2Vuc2UuCgpDcmVkaXRzOgoJVGhlIGlkZWEgYmVoaW5kIFRpcHMuanMgaXMgYmFzZWQgb24gQnViYmxlIFRvb2x0aXBzICg8aHR0cDovL3dlYi1ncmFwaGljcy5jb20vbXRhcmNoaXZlLzAwMTcxNy5waHA+KSBieSBBbGVzc2FuZHJvIEZ1bGNpdGluaXRpIDxodHRwOi8vd2ViLWdyYXBoaWNzLmNvbT4KKi8KCi8qCkNsYXNzOiBUaXBzCglEaXNwbGF5IGEgdGlwIG9uIGFueSBlbGVtZW50IHdpdGggYSB0aXRsZSBhbmQvb3IgaHJlZi4KCk5vdGU6CglUaXBzIHJlcXVpcmVzIGFuIFhIVE1MIGRvY3R5cGUuCgpBcmd1bWVudHM6CgllbGVtZW50cyAtIGEgY29sbGVjdGlvbiBvZiBlbGVtZW50cyB0byBhcHBseSB0aGUgdG9vbHRpcHMgdG8gb24gbW91c2VvdmVyLgoJb3B0aW9ucyAtIGFuIG9iamVjdC4gU2VlIG9wdGlvbnMgQmVsb3cuCgpPcHRpb25zOgoJbWF4VGl0bGVDaGFycyAtIHRoZSBtYXhpbXVtIG51bWJlciBvZiBjaGFyYWN0ZXJzIHRvIGRpc3BsYXkgaW4gdGhlIHRpdGxlIG9mIHRoZSB0aXAuIGRlZmF1bHRzIHRvIDMwLgoJc2hvd0RlbGF5IC0gdGhlIGRlbGF5IHRoZSBvblNob3cgbWV0aG9kIGlzIGNhbGxlZC4gKGRlZmF1bHRzIHRvIDEwMCBtcykKCWhpZGVEZWxheSAtIHRoZSBkZWxheSB0aGUgb25IaWRlIG1ldGhvZCBpcyBjYWxsZWQuIChkZWZhdWx0cyB0byAxMDAgbXMpCgoJY2xhc3NOYW1lIC0gdGhlIHByZWZpeCBmb3IgeW91ciB0b29sdGlwIGNsYXNzTmFtZXMuIGRlZmF1bHRzIHRvICd0b29sJy4KCgkJdGhlIHdob2xlIHRvb2x0aXAgd2lsbCBoYXZlIGFzIGNsYXNzbmFtZTogdG9vbC10aXAKCgkJdGhlIHRpdGxlIHdpbGwgaGF2ZSBhcyBjbGFzc25hbWU6IHRvb2wtdGl0bGUKCgkJdGhlIHRleHQgd2lsbCBoYXZlIGFzIGNsYXNzbmFtZTogdG9vbC10ZXh0CgoJb2Zmc2V0cyAtIHRoZSBkaXN0YW5jZSBvZiB5b3VyIHRvb2x0aXAgZnJvbSB0aGUgbW91c2UuIGFuIE9iamVjdCB3aXRoIHgveSBwcm9wZXJ0aWVzLgoJZml4ZWQgLSBpZiBzZXQgdG8gdHJ1ZSwgdGhlIHRvb2xUaXAgd2lsbCBub3QgZm9sbG93IHRoZSBtb3VzZS4KCkV2ZW50czoKCW9uU2hvdyAtIG9wdGlvbmFsbHkgeW91IGNhbiBhbHRlciB0aGUgZGVmYXVsdCBvblNob3cgYmVoYXZpb3VyIHdpdGggdGhpcyBvcHRpb24gKGxpa2UgZGlzcGxheWluZyBhIGZhZGUgaW4gZWZmZWN0KTsKCW9uSGlkZSAtIG9wdGlvbmFsbHkgeW91IGNhbiBhbHRlciB0aGUgZGVmYXVsdCBvbkhpZGUgYmVoYXZpb3VyIHdpdGggdGhpcyBvcHRpb24gKGxpa2UgZGlzcGxheWluZyBhIGZhZGUgb3V0IGVmZmVjdCk7CgpFeGFtcGxlOgoJKHN0YXJ0IGNvZGUpCgk8aW1nIHNyYz0iL2ltYWdlcy9pLnBuZyIgdGl0bGU9IlRoZSBib2R5IG9mIHRoZSB0b29sdGlwIGlzIHN0b3JlZCBpbiB0aGUgdGl0bGUiIGNsYXNzPSJ0b29sVGlwSW1nIi8+Cgk8c2NyaXB0PgoJCXZhciBteVRpcHMgPSBuZXcgVGlwcygkJCgnLnRvb2xUaXBJbWcnKSwgewoJCQltYXhUaXRsZUNoYXJzOiA1MAkvL0kgbGlrZSBteSBjYXB0aW9ucyBhIGxpdHRsZSBsb25nCgkJfSk7Cgk8L3NjcmlwdD4KCShlbmQpCgpOb3RlOgoJVGhlIHRpdGxlIG9mIHRoZSBlbGVtZW50IHdpbGwgYWx3YXlzIGJlIHVzZWQgYXMgdGhlIHRvb2x0aXAgYm9keS4gSWYgeW91IHB1dCA6OiBvbiB5b3VyIHRpdGxlLCB0aGUgdGV4dCBiZWZvcmUgOjogd2lsbCBiZWNvbWUgdGhlIHRvb2x0aXAgdGl0bGUuCiovCgp2YXIgVGlwcyA9IG5ldyBDbGFzcyh7CgoJb3B0aW9uczogewoJCW9uU2hvdzogZnVuY3Rpb24odGlwKXsKCQkJdGlwLnNldFN0eWxlKCd2aXNpYmlsaXR5JywgJ3Zpc2libGUnKTsKCQl9LAoJCW9uSGlkZTogZnVuY3Rpb24odGlwKXsKCQkJdGlwLnNldFN0eWxlKCd2aXNpYmlsaXR5JywgJ2hpZGRlbicpOwoJCX0sCgkJbWF4VGl0bGVDaGFyczogMzAsCgkJc2hvd0RlbGF5OiAxMDAsCgkJaGlkZURlbGF5OiAxMDAsCgkJY2xhc3NOYW1lOiAndG9vbCcsCgkJb2Zmc2V0czogeyd4JzogMTYsICd5JzogMTZ9LAoJCWZpeGVkOiBmYWxzZQoJfSwKCglpbml0aWFsaXplOiBmdW5jdGlvbihlbGVtZW50cywgb3B0aW9ucyl7CgkJdGhpcy5zZXRPcHRpb25zKG9wdGlvbnMpOwoJCXRoaXMudG9vbFRpcCA9IG5ldyBFbGVtZW50KCdkaXYnLCB7CgkJCSdjbGFzcyc6IHRoaXMub3B0aW9ucy5jbGFzc05hbWUgKyAnLXRpcCcsCgkJCSdzdHlsZXMnOiB7CgkJCQkncG9zaXRpb24nOiAnYWJzb2x1dGUnLAoJCQkJJ3RvcCc6ICcwJywKCQkJCSdsZWZ0JzogJzAnLAoJCQkJJ3Zpc2liaWxpdHknOiAnaGlkZGVuJwoJCQl9CgkJfSkuaW5qZWN0KGRvY3VtZW50LmJvZHkpOwoJCXRoaXMud3JhcHBlciA9IG5ldyBFbGVtZW50KCdkaXYnKS5pbmplY3QodGhpcy50b29sVGlwKTsKCQkkJChlbGVtZW50cykuZWFjaCh0aGlzLmJ1aWxkLCB0aGlzKTsKCQlpZiAodGhpcy5vcHRpb25zLmluaXRpYWxpemUpIHRoaXMub3B0aW9ucy5pbml0aWFsaXplLmNhbGwodGhpcyk7Cgl9LAoKCWJ1aWxkOiBmdW5jdGlvbihlbCl7CgkJZWwuJHRtcC5teVRpdGxlID0gKGVsLmhyZWYgJiYgZWwuZ2V0VGFnKCkgPT0gJ2EnKSA/IGVsLmhyZWYucmVwbGFjZSgnaHR0cDovLycsICcnKSA6IChlbC5yZWwgfHwgZmFsc2UpOwoJCWlmIChlbC50aXRsZSl7CgkJCXZhciBkdWFsID0gZWwudGl0bGUuc3BsaXQoJzo6Jyk7CgkJCWlmIChkdWFsLmxlbmd0aCA+IDEpewoJCQkJZWwuJHRtcC5teVRpdGxlID0gZHVhbFswXS50cmltKCk7CgkJCQllbC4kdG1wLm15VGV4dCA9IGR1YWxbMV0udHJpbSgpOwoJCQl9IGVsc2UgewoJCQkJZWwuJHRtcC5teVRleHQgPSBlbC50aXRsZTsKCQkJfQoJCQllbC5yZW1vdmVBdHRyaWJ1dGUoJ3RpdGxlJyk7CgkJfSBlbHNlIHsKCQkJZWwuJHRtcC5teVRleHQgPSBmYWxzZTsKCQl9CgkJaWYgKGVsLiR0bXAubXlUaXRsZSAmJiBlbC4kdG1wLm15VGl0bGUubGVuZ3RoID4gdGhpcy5vcHRpb25zLm1heFRpdGxlQ2hhcnMpIGVsLiR0bXAubXlUaXRsZSA9IGVsLiR0bXAubXlUaXRsZS5zdWJzdHIoMCwgdGhpcy5vcHRpb25zLm1heFRpdGxlQ2hhcnMgLSAxKSArICImaGVsbGlwOyI7CgkJZWwuYWRkRXZlbnQoJ21vdXNlZW50ZXInLCBmdW5jdGlvbihldmVudCl7CgkJCXRoaXMuc3RhcnQoZWwpOwoJCQlpZiAoIXRoaXMub3B0aW9ucy5maXhlZCkgdGhpcy5sb2NhdGUoZXZlbnQpOwoJCQllbHNlIHRoaXMucG9zaXRpb24oZWwpOwoJCX0uYmluZCh0aGlzKSk7CgkJaWYgKCF0aGlzLm9wdGlvbnMuZml4ZWQpIGVsLmFkZEV2ZW50KCdtb3VzZW1vdmUnLCB0aGlzLmxvY2F0ZS5iaW5kV2l0aEV2ZW50KHRoaXMpKTsKCQl2YXIgZW5kID0gdGhpcy5lbmQuYmluZCh0aGlzKTsKCQllbC5hZGRFdmVudCgnbW91c2VsZWF2ZScsIGVuZCk7CgkJZWwuYWRkRXZlbnQoJ3RyYXNoJywgZW5kKTsKCX0sCgoJc3RhcnQ6IGZ1bmN0aW9uKGVsKXsKCQl0aGlzLndyYXBwZXIuZW1wdHkoKTsKCQlpZiAoZWwuJHRtcC5teVRpdGxlKXsKCQkJdGhpcy50aXRsZSA9IG5ldyBFbGVtZW50KCdzcGFuJykuaW5qZWN0KG5ldyBFbGVtZW50KCdkaXYnLCB7J2NsYXNzJzogdGhpcy5vcHRpb25zLmNsYXNzTmFtZSArICctdGl0bGUnfSkuaW5qZWN0KHRoaXMud3JhcHBlcikpLnNldEhUTUwoZWwuJHRtcC5teVRpdGxlKTsKCQl9CgkJaWYgKGVsLiR0bXAubXlUZXh0KXsKCQkJdGhpcy50ZXh0ID0gbmV3IEVsZW1lbnQoJ3NwYW4nKS5pbmplY3QobmV3IEVsZW1lbnQoJ2RpdicsIHsnY2xhc3MnOiB0aGlzLm9wdGlvbnMuY2xhc3NOYW1lICsgJy10ZXh0J30pLmluamVjdCh0aGlzLndyYXBwZXIpKS5zZXRIVE1MKGVsLiR0bXAubXlUZXh0KTsKCQl9CgkJJGNsZWFyKHRoaXMudGltZXIpOwoJCXRoaXMudGltZXIgPSB0aGlzLnNob3cuZGVsYXkodGhpcy5vcHRpb25zLnNob3dEZWxheSwgdGhpcyk7Cgl9LAoKCWVuZDogZnVuY3Rpb24oZXZlbnQpewoJCSRjbGVhcih0aGlzLnRpbWVyKTsKCQl0aGlzLnRpbWVyID0gdGhpcy5oaWRlLmRlbGF5KHRoaXMub3B0aW9ucy5oaWRlRGVsYXksIHRoaXMpOwoJfSwKCglwb3NpdGlvbjogZnVuY3Rpb24oZWxlbWVudCl7CgkJdmFyIHBvcyA9IGVsZW1lbnQuZ2V0UG9zaXRpb24oKTsKCQl0aGlzLnRvb2xUaXAuc2V0U3R5bGVzKHsKCQkJJ2xlZnQnOiBwb3MueCArIHRoaXMub3B0aW9ucy5vZmZzZXRzLngsCgkJCSd0b3AnOiBwb3MueSArIHRoaXMub3B0aW9ucy5vZmZzZXRzLnkKCQl9KTsKCX0sCgoJbG9jYXRlOiBmdW5jdGlvbihldmVudCl7CgkJdmFyIHdpbiA9IHsneCc6IHdpbmRvdy5nZXRXaWR0aCgpLCAneSc6IHdpbmRvdy5nZXRIZWlnaHQoKX07CgkJdmFyIHNjcm9sbCA9IHsneCc6IHdpbmRvdy5nZXRTY3JvbGxMZWZ0KCksICd5Jzogd2luZG93LmdldFNjcm9sbFRvcCgpfTsKCQl2YXIgdGlwID0geyd4JzogdGhpcy50b29sVGlwLm9mZnNldFdpZHRoLCAneSc6IHRoaXMudG9vbFRpcC5vZmZzZXRIZWlnaHR9OwoJCXZhciBwcm9wID0geyd4JzogJ2xlZnQnLCAneSc6ICd0b3AnfTsKCQlmb3IgKHZhciB6IGluIHByb3ApewoJCQl2YXIgcG9zID0gZXZlbnQucGFnZVt6XSArIHRoaXMub3B0aW9ucy5vZmZzZXRzW3pdOwoJCQlpZiAoKHBvcyArIHRpcFt6XSAtIHNjcm9sbFt6XSkgPiB3aW5bel0pIHBvcyA9IGV2ZW50LnBhZ2Vbel0gLSB0aGlzLm9wdGlvbnMub2Zmc2V0c1t6XSAtIHRpcFt6XTsKCQkJdGhpcy50b29sVGlwLnNldFN0eWxlKHByb3Bbel0sIHBvcyk7CgkJfTsKCX0sCgoJc2hvdzogZnVuY3Rpb24oKXsKCQlpZiAodGhpcy5vcHRpb25zLnRpbWVvdXQpIHRoaXMudGltZXIgPSB0aGlzLmhpZGUuZGVsYXkodGhpcy5vcHRpb25zLnRpbWVvdXQsIHRoaXMpOwoJCXRoaXMuZmlyZUV2ZW50KCdvblNob3cnLCBbdGhpcy50b29sVGlwXSk7Cgl9LAoKCWhpZGU6IGZ1bmN0aW9uKCl7CgkJdGhpcy5maXJlRXZlbnQoJ29uSGlkZScsIFt0aGlzLnRvb2xUaXBdKTsKCX0KCn0pOwoKVGlwcy5pbXBsZW1lbnQobmV3IEV2ZW50cywgbmV3IE9wdGlvbnMpOwoKLyoKU2NyaXB0OiBHcm91cC5qcwoJRm9yIEdyb3VwaW5nIENsYXNzZXMgb3IgRWxlbWVudHMgRXZlbnRzLiBUaGUgRXZlbnQgYWRkZWQgdG8gdGhlIEdyb3VwIHdpbGwgZmlyZSB3aGVuIGFsbCBvZiB0aGUgZXZlbnRzIG9mIHRoZSBpdGVtcyBvZiB0aGUgZ3JvdXAgYXJlIGZpcmVkLgoKTGljZW5zZToKCU1JVC1zdHlsZSBsaWNlbnNlLgoqLwoKLyoKQ2xhc3M6IEdyb3VwCglBbiAiVXRpbGl0eSIgQ2xhc3MuCgpBcmd1bWVudHM6CglMaXN0IG9mIENsYXNzIGluc3RhbmNlcwoKRXhhbXBsZToKCShzdGFydCBjb2RlKQoJeGhyMSA9IG5ldyBBamF4KCdkYXRhLmpzJywge2V2YWxTY3JpcHQ6IHRydWV9KTsKCXhocjIgPSBuZXcgQWpheCgnYWJzdHJhY3Rpb24uanMnLCB7ZXZhbFNjcmlwdDogdHJ1ZX0pOwoJeGhyMyA9IG5ldyBBamF4KCd0ZW1wbGF0ZS5qcycsIHtldmFsU2NyaXB0OiB0cnVlfSk7CgoJdmFyIGdyb3VwID0gbmV3IEdyb3VwKHhocjEsIHhocjIsIHhocjMpOwoJZ3JvdXAuYWRkRXZlbnQoJ29uQ29tcGxldGUnLCBmdW5jdGlvbigpewoJCWFsZXJ0KCdBbGwgU2NyaXB0cyBsb2FkZWQnKTsKCX0pOwoKCXhocjEucmVxdWVzdCgpOwoJeGhyMi5yZXF1ZXN0KCk7Cgl4aHIzLnJlcXVlc3QoKTsKCShlbmQpCgoqLwoKdmFyIEdyb3VwID0gbmV3IENsYXNzKHsKCglpbml0aWFsaXplOiBmdW5jdGlvbigpewoJCXRoaXMuaW5zdGFuY2VzID0gJEEoYXJndW1lbnRzKTsKCQl0aGlzLmV2ZW50cyA9IHt9OwoJCXRoaXMuY2hlY2tlciA9IHt9OwoJfSwKCgkvKgoJUHJvcGVydHk6IGFkZEV2ZW50CgkJYWRkcyBhbiBldmVudCB0byB0aGUgc3RhY2sgb2YgZXZlbnRzIG9mIHRoZSBDbGFzcyBpbnN0YW5jZXMuCgoJQXJndW1lbnRzOgoJCXR5cGUgLSBzdHJpbmc7IHRoZSBldmVudCBuYW1lIChlLmcuICdvbkNvbXBsZXRlJykKCQlmbiAtIGZ1bmN0aW9uIHRvIGV4ZWN1dGUgd2hlbiBhbGwgaW5zdGFuY2VzIGZpcmVkIHRoaXMgZXZlbnQKCSovCgoJYWRkRXZlbnQ6IGZ1bmN0aW9uKHR5cGUsIGZuKXsKCQl0aGlzLmNoZWNrZXJbdHlwZV0gPSB0aGlzLmNoZWNrZXJbdHlwZV0gfHwge307CgkJdGhpcy5ldmVudHNbdHlwZV0gPSB0aGlzLmV2ZW50c1t0eXBlXSB8fCBbXTsKCQlpZiAodGhpcy5ldmVudHNbdHlwZV0uY29udGFpbnMoZm4pKSByZXR1cm4gZmFsc2U7CgkJZWxzZSB0aGlzLmV2ZW50c1t0eXBlXS5wdXNoKGZuKTsKCQl0aGlzLmluc3RhbmNlcy5lYWNoKGZ1bmN0aW9uKGluc3RhbmNlLCBpKXsKCQkJaW5zdGFuY2UuYWRkRXZlbnQodHlwZSwgdGhpcy5jaGVjay5iaW5kKHRoaXMsIFt0eXBlLCBpbnN0YW5jZSwgaV0pKTsKCQl9LCB0aGlzKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJY2hlY2s6IGZ1bmN0aW9uKHR5cGUsIGluc3RhbmNlLCBpKXsKCQl0aGlzLmNoZWNrZXJbdHlwZV1baV0gPSB0cnVlOwoJCXZhciBldmVyeSA9IHRoaXMuaW5zdGFuY2VzLmV2ZXJ5KGZ1bmN0aW9uKGN1cnJlbnQsIGopewoJCQlyZXR1cm4gdGhpcy5jaGVja2VyW3R5cGVdW2pdIHx8IGZhbHNlOwoJCX0sIHRoaXMpOwoJCWlmICghZXZlcnkpIHJldHVybjsKCQl0aGlzLmNoZWNrZXJbdHlwZV0gPSB7fTsKCQl0aGlzLmV2ZW50c1t0eXBlXS5lYWNoKGZ1bmN0aW9uKGV2ZW50KXsKCQkJZXZlbnQuY2FsbCh0aGlzLCB0aGlzLmluc3RhbmNlcywgaW5zdGFuY2UpOwoJCX0sIHRoaXMpOwoJfQoKfSk7CgovKgpTY3JpcHQ6IEFjY29yZGlvbi5qcwoJQ29udGFpbnMgPEFjY29yZGlvbj4KCkxpY2Vuc2U6CglNSVQtc3R5bGUgbGljZW5zZS4KKi8KCi8qCkNsYXNzOiBBY2NvcmRpb24KCVRoZSBBY2NvcmRpb24gY2xhc3MgY3JlYXRlcyBhIGdyb3VwIG9mIGVsZW1lbnRzIHRoYXQgYXJlIHRvZ2dsZWQgd2hlbiB0aGVpciBoYW5kbGVzIGFyZSBjbGlja2VkLiBXaGVuIG9uZSBlbGVtZW50cyB0b2dnbGVzIGluLCB0aGUgb3RoZXJzIHRvZ2dsZXMgYmFjay4KCUluaGVyaXRzIG1ldGhvZHMsIHByb3BlcnRpZXMsIG9wdGlvbnMgYW5kIGV2ZW50cyBmcm9tIDxGeC5FbGVtZW50cz4uCgpOb3RlOgoJVGhlIEFjY29yZGlvbiByZXF1aXJlcyBhbiBYSFRNTCBkb2N0eXBlLgoKQXJndW1lbnRzOgoJdG9nZ2xlcnMgLSByZXF1aXJlZCwgYSBjb2xsZWN0aW9uIG9mIGVsZW1lbnRzLCB0aGUgZWxlbWVudHMgaGFuZGxlcnMgdGhhdCB3aWxsIGJlIGNsaWNrYWJsZS4KCWVsZW1lbnRzIC0gcmVxdWlyZWQsIGEgY29sbGVjdGlvbiBvZiBlbGVtZW50cyB0aGUgdHJhbnNpdGlvbnMgd2lsbCBiZSBhcHBsaWVkIHRvLgoJb3B0aW9ucyAtIG9wdGlvbmFsLCBzZWUgb3B0aW9ucyBiZWxvdywgYW5kIDxGeC5CYXNlPiBvcHRpb25zIGFuZCBldmVudHMuCgpPcHRpb25zOgoJc2hvdyAtIGludGVnZXIsIHRoZSBJbmRleCBvZiB0aGUgZWxlbWVudCB0byBzaG93IGF0IHN0YXJ0LgoJZGlzcGxheSAtIGludGVnZXIsIHRoZSBJbmRleCBvZiB0aGUgZWxlbWVudCB0byBzaG93IGF0IHN0YXJ0ICh3aXRoIGEgdHJhbnNpdGlvbikuIGRlZmF1bHRzIHRvIDAuCglmaXhlZEhlaWdodCAtIGludGVnZXIsIGlmIHlvdSB3YW50IHRoZSBlbGVtZW50cyB0byBoYXZlIGEgZml4ZWQgaGVpZ2h0LiBkZWZhdWx0cyB0byBmYWxzZS4KCWZpeGVkV2lkdGggLSBpbnRlZ2VyLCBpZiB5b3Ugd2FudCB0aGUgZWxlbWVudHMgdG8gaGF2ZSBhIGZpeGVkIHdpZHRoLiBkZWZhdWx0cyB0byBmYWxzZS4KCWhlaWdodCAtIGJvb2xlYW4sIHdpbGwgYWRkIGEgaGVpZ2h0IHRyYW5zaXRpb24gdG8gdGhlIGFjY29yZGlvbiBpZiB0cnVlLiBkZWZhdWx0cyB0byB0cnVlLgoJb3BhY2l0eSAtIGJvb2xlYW4sIHdpbGwgYWRkIGFuIG9wYWNpdHkgdHJhbnNpdGlvbiB0byB0aGUgYWNjb3JkaW9uIGlmIHRydWUuIGRlZmF1bHRzIHRvIHRydWUuCgl3aWR0aCAtIGJvb2xlYW4sIHdpbGwgYWRkIGEgd2lkdGggdHJhbnNpdGlvbiB0byB0aGUgYWNjb3JkaW9uIGlmIHRydWUuIGRlZmF1bHRzIHRvIGZhbHNlLCBjc3MgbWFzdGVyeSBpcyByZXF1aXJlZCB0byBtYWtlIHRoaXMgd29yayEKCWFsd2F5c0hpZGUgLSBib29sZWFuLCB3aWxsIGFsbG93IHRvIGhpZGUgYWxsIGVsZW1lbnRzIGlmIHRydWUsIGluc3RlYWQgb2YgYWx3YXlzIGtlZXBpbmcgb25lIGVsZW1lbnQgc2hvd24uIGRlZmF1bHRzIHRvIGZhbHNlLgoKRXZlbnRzOgoJb25BY3RpdmUgLSBmdW5jdGlvbiB0byBleGVjdXRlIHdoZW4gYW4gZWxlbWVudCBzdGFydHMgdG8gc2hvdwoJb25CYWNrZ3JvdW5kIC0gZnVuY3Rpb24gdG8gZXhlY3V0ZSB3aGVuIGFuIGVsZW1lbnQgc3RhcnRzIHRvIGhpZGUKKi8KCnZhciBBY2NvcmRpb24gPSBGeC5FbGVtZW50cy5leHRlbmQoewoKCW9wdGlvbnM6IHsKCQlvbkFjdGl2ZTogQ2xhc3MuZW1wdHksCgkJb25CYWNrZ3JvdW5kOiBDbGFzcy5lbXB0eSwKCQlkaXNwbGF5OiAwLAoJCXNob3c6IGZhbHNlLAoJCWhlaWdodDogdHJ1ZSwKCQl3aWR0aDogZmFsc2UsCgkJb3BhY2l0eTogdHJ1ZSwKCQlmaXhlZEhlaWdodDogZmFsc2UsCgkJZml4ZWRXaWR0aDogZmFsc2UsCgkJd2FpdDogZmFsc2UsCgkJYWx3YXlzSGlkZTogZmFsc2UKCX0sCgoJaW5pdGlhbGl6ZTogZnVuY3Rpb24oKXsKCQl2YXIgb3B0aW9ucywgdG9nZ2xlcnMsIGVsZW1lbnRzLCBjb250YWluZXI7CgkJJGVhY2goYXJndW1lbnRzLCBmdW5jdGlvbihhcmd1bWVudCwgaSl7CgkJCXN3aXRjaCgkdHlwZShhcmd1bWVudCkpewoJCQkJY2FzZSAnb2JqZWN0Jzogb3B0aW9ucyA9IGFyZ3VtZW50OyBicmVhazsKCQkJCWNhc2UgJ2VsZW1lbnQnOiBjb250YWluZXIgPSAkKGFyZ3VtZW50KTsgYnJlYWs7CgkJCQlkZWZhdWx0OgoJCQkJCXZhciB0ZW1wID0gJCQoYXJndW1lbnQpOwoJCQkJCWlmICghdG9nZ2xlcnMpIHRvZ2dsZXJzID0gdGVtcDsKCQkJCQllbHNlIGVsZW1lbnRzID0gdGVtcDsKCQkJfQoJCX0pOwoJCXRoaXMudG9nZ2xlcnMgPSB0b2dnbGVycyB8fCBbXTsKCQl0aGlzLmVsZW1lbnRzID0gZWxlbWVudHMgfHwgW107CgkJdGhpcy5jb250YWluZXIgPSAkKGNvbnRhaW5lcik7CgkJdGhpcy5zZXRPcHRpb25zKG9wdGlvbnMpOwoJCXRoaXMucHJldmlvdXMgPSAtMTsKCQlpZiAodGhpcy5vcHRpb25zLmFsd2F5c0hpZGUpIHRoaXMub3B0aW9ucy53YWl0ID0gdHJ1ZTsKCQlpZiAoJGNoayh0aGlzLm9wdGlvbnMuc2hvdykpewoJCQl0aGlzLm9wdGlvbnMuZGlzcGxheSA9IGZhbHNlOwoJCQl0aGlzLnByZXZpb3VzID0gdGhpcy5vcHRpb25zLnNob3c7CgkJfQoJCWlmICh0aGlzLm9wdGlvbnMuc3RhcnQpewoJCQl0aGlzLm9wdGlvbnMuZGlzcGxheSA9IGZhbHNlOwoJCQl0aGlzLm9wdGlvbnMuc2hvdyA9IGZhbHNlOwoJCX0KCQl0aGlzLmVmZmVjdHMgPSB7fTsKCQlpZiAodGhpcy5vcHRpb25zLm9wYWNpdHkpIHRoaXMuZWZmZWN0cy5vcGFjaXR5ID0gJ2Z1bGxPcGFjaXR5JzsKCQlpZiAodGhpcy5vcHRpb25zLndpZHRoKSB0aGlzLmVmZmVjdHMud2lkdGggPSB0aGlzLm9wdGlvbnMuZml4ZWRXaWR0aCA/ICdmdWxsV2lkdGgnIDogJ29mZnNldFdpZHRoJzsKCQlpZiAodGhpcy5vcHRpb25zLmhlaWdodCkgdGhpcy5lZmZlY3RzLmhlaWdodCA9IHRoaXMub3B0aW9ucy5maXhlZEhlaWdodCA/ICdmdWxsSGVpZ2h0JyA6ICdzY3JvbGxIZWlnaHQnOwoJCWZvciAodmFyIGkgPSAwLCBsID0gdGhpcy50b2dnbGVycy5sZW5ndGg7IGkgPCBsOyBpKyspIHRoaXMuYWRkU2VjdGlvbih0aGlzLnRvZ2dsZXJzW2ldLCB0aGlzLmVsZW1lbnRzW2ldKTsKCQl0aGlzLmVsZW1lbnRzLmVhY2goZnVuY3Rpb24oZWwsIGkpewoJCQlpZiAodGhpcy5vcHRpb25zLnNob3cgPT09IGkpewoJCQkJdGhpcy5maXJlRXZlbnQoJ29uQWN0aXZlJywgW3RoaXMudG9nZ2xlcnNbaV0sIGVsXSk7CgkJCX0gZWxzZSB7CgkJCQlmb3IgKHZhciBmeCBpbiB0aGlzLmVmZmVjdHMpIGVsLnNldFN0eWxlKGZ4LCAwKTsKCQkJfQoJCX0sIHRoaXMpOwoJCXRoaXMucGFyZW50KHRoaXMuZWxlbWVudHMpOwoJCWlmICgkY2hrKHRoaXMub3B0aW9ucy5kaXNwbGF5KSkgdGhpcy5kaXNwbGF5KHRoaXMub3B0aW9ucy5kaXNwbGF5KTsKCX0sCgoJLyoKCVByb3BlcnR5OiBhZGRTZWN0aW9uCgkJRHluYW1pY2FsbHkgYWRkcyBhIG5ldyBzZWN0aW9uIGludG8gdGhlIGFjY29yZGlvbiBhdCB0aGUgc3BlY2lmaWVkIHBvc2l0aW9uLgoKCUFyZ3VtZW50czoKCQl0b2dnbGVyIC0gKGRvbSBlbGVtZW50KSB0aGUgZWxlbWVudCB0aGF0IHRvZ2dsZXMgdGhlIGFjY29yZGlvbiBzZWN0aW9uIG9wZW4uCgkJZWxlbWVudCAtIChkb20gZWxlbWVudCkgdGhlIGVsZW1lbnQgdGhhdCBzdHJldGNoZXMgb3BlbiB3aGVuIHRoZSB0b2dnbGVyIGlzIGNsaWNrZWQuCgkJcG9zIC0gKGludGVnZXIpIHRoZSBpbmRleCB3aGVyZSB0aGVzZSBvYmplY3RzIGFyZSB0byBiZSBpbnNlcnRlZCB3aXRoaW4gdGhlIGFjY29yZGlvbi4KCSovCgoJYWRkU2VjdGlvbjogZnVuY3Rpb24odG9nZ2xlciwgZWxlbWVudCwgcG9zKXsKCQl0b2dnbGVyID0gJCh0b2dnbGVyKTsKCQllbGVtZW50ID0gJChlbGVtZW50KTsKCQl2YXIgdGVzdCA9IHRoaXMudG9nZ2xlcnMuY29udGFpbnModG9nZ2xlcik7CgkJdmFyIGxlbiA9IHRoaXMudG9nZ2xlcnMubGVuZ3RoOwoJCXRoaXMudG9nZ2xlcnMuaW5jbHVkZSh0b2dnbGVyKTsKCQl0aGlzLmVsZW1lbnRzLmluY2x1ZGUoZWxlbWVudCk7CgkJaWYgKGxlbiAmJiAoIXRlc3QgfHwgcG9zKSl7CgkJCXBvcyA9ICRwaWNrKHBvcywgbGVuIC0gMSk7CgkJCXRvZ2dsZXIuaW5qZWN0QmVmb3JlKHRoaXMudG9nZ2xlcnNbcG9zXSk7CgkJCWVsZW1lbnQuaW5qZWN0QWZ0ZXIodG9nZ2xlcik7CgkJfSBlbHNlIGlmICh0aGlzLmNvbnRhaW5lciAmJiAhdGVzdCl7CgkJCXRvZ2dsZXIuaW5qZWN0KHRoaXMuY29udGFpbmVyKTsKCQkJZWxlbWVudC5pbmplY3QodGhpcy5jb250YWluZXIpOwoJCX0KCQl2YXIgaWR4ID0gdGhpcy50b2dnbGVycy5pbmRleE9mKHRvZ2dsZXIpOwoJCXRvZ2dsZXIuYWRkRXZlbnQoJ2NsaWNrJywgdGhpcy5kaXNwbGF5LmJpbmQodGhpcywgaWR4KSk7CgkJaWYgKHRoaXMub3B0aW9ucy5oZWlnaHQpIGVsZW1lbnQuc2V0U3R5bGVzKHsncGFkZGluZy10b3AnOiAwLCAnYm9yZGVyLXRvcCc6ICdub25lJywgJ3BhZGRpbmctYm90dG9tJzogMCwgJ2JvcmRlci1ib3R0b20nOiAnbm9uZSd9KTsKCQlpZiAodGhpcy5vcHRpb25zLndpZHRoKSBlbGVtZW50LnNldFN0eWxlcyh7J3BhZGRpbmctbGVmdCc6IDAsICdib3JkZXItbGVmdCc6ICdub25lJywgJ3BhZGRpbmctcmlnaHQnOiAwLCAnYm9yZGVyLXJpZ2h0JzogJ25vbmUnfSk7CgkJZWxlbWVudC5mdWxsT3BhY2l0eSA9IDE7CgkJaWYgKHRoaXMub3B0aW9ucy5maXhlZFdpZHRoKSBlbGVtZW50LmZ1bGxXaWR0aCA9IHRoaXMub3B0aW9ucy5maXhlZFdpZHRoOwoJCWlmICh0aGlzLm9wdGlvbnMuZml4ZWRIZWlnaHQpIGVsZW1lbnQuZnVsbEhlaWdodCA9IHRoaXMub3B0aW9ucy5maXhlZEhlaWdodDsKCQllbGVtZW50LnNldFN0eWxlKCdvdmVyZmxvdycsICdoaWRkZW4nKTsKCQlpZiAoIXRlc3QpewoJCQlmb3IgKHZhciBmeCBpbiB0aGlzLmVmZmVjdHMpIGVsZW1lbnQuc2V0U3R5bGUoZngsIDApOwoJCX0KCQlyZXR1cm4gdGhpczsKCX0sCgoJLyoKCVByb3BlcnR5OiBkaXNwbGF5CgkJU2hvd3MgYSBzcGVjaWZpYyBzZWN0aW9uIGFuZCBoaWRlcyBhbGwgb3RoZXJzLiBVc2VmdWwgd2hlbiB0cmlnZ2VyaW5nIGFuIGFjY29yZGlvbiBmcm9tIG91dHNpZGUuCgoJQXJndW1lbnRzOgoJCWluZGV4IC0gaW50ZWdlciwgdGhlIGluZGV4IG9mIHRoZSBpdGVtIHRvIHNob3csIG9yIHRoZSBhY3R1YWwgZWxlbWVudCB0byBzaG93LgoJKi8KCglkaXNwbGF5OiBmdW5jdGlvbihpbmRleCl7CgkJaW5kZXggPSAoJHR5cGUoaW5kZXgpID09ICdlbGVtZW50JykgPyB0aGlzLmVsZW1lbnRzLmluZGV4T2YoaW5kZXgpIDogaW5kZXg7CgkJaWYgKCh0aGlzLnRpbWVyICYmIHRoaXMub3B0aW9ucy53YWl0KSB8fCAoaW5kZXggPT09IHRoaXMucHJldmlvdXMgJiYgIXRoaXMub3B0aW9ucy5hbHdheXNIaWRlKSkgcmV0dXJuIHRoaXM7CgkJdGhpcy5wcmV2aW91cyA9IGluZGV4OwoJCXZhciBvYmogPSB7fTsKCQl0aGlzLmVsZW1lbnRzLmVhY2goZnVuY3Rpb24oZWwsIGkpewoJCQlvYmpbaV0gPSB7fTsKCQkJdmFyIGhpZGUgPSAoaSAhPSBpbmRleCkgfHwgKHRoaXMub3B0aW9ucy5hbHdheXNIaWRlICYmIChlbC5vZmZzZXRIZWlnaHQgPiAwKSk7CgkJCXRoaXMuZmlyZUV2ZW50KGhpZGUgPyAnb25CYWNrZ3JvdW5kJyA6ICdvbkFjdGl2ZScsIFt0aGlzLnRvZ2dsZXJzW2ldLCBlbF0pOwoJCQlmb3IgKHZhciBmeCBpbiB0aGlzLmVmZmVjdHMpIG9ialtpXVtmeF0gPSBoaWRlID8gMCA6IGVsW3RoaXMuZWZmZWN0c1tmeF1dOwoJCX0sIHRoaXMpOwoJCXJldHVybiB0aGlzLnN0YXJ0KG9iaik7Cgl9LAoKCXNob3dUaGlzSGlkZU9wZW46IGZ1bmN0aW9uKGluZGV4KXtyZXR1cm4gdGhpcy5kaXNwbGF5KGluZGV4KTt9Cgp9KTsKCkZ4LkFjY29yZGlvbiA9IEFjY29yZGlvbjsK",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Fri, 07 Nov 2014 22:07:14 GMT",
                    "Content-Length": "183618",
                    "Date": "Fri, 07 Nov 2014 22:07:32 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}