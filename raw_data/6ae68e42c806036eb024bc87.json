{
    "url": "http://localhost:9999/fredyang/bower-hm.js/hm.debug.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "DOM data manipulation (DOM-based)",
    "issueType": 5247488,
    "severity": "Information",
    "confidence": "Firm",
    "issueBackground": "DOM-based DOM data manipulation vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this to a data field within the DOM that is used within the visible UI or client-side application logic. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will modify the appearance or behavior of the client-side UI. An attacker may be able to leverage this to perform virtual defacement of the application, or possibly to induce the user to perform unintended actions.",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based DOM data manipulation vulnerabilities is not to dynamically write to DOM data fields any data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from being stored. In general, this is best achieved by using a whitelist of permitted values.",
    "issueDetail": "The application may be vulnerable to DOM-based DOM data manipulation. Data is read from <b>location.href</b> and written to <b>history.replaceState()</b> via the following statements:<ul><li>var currentHas...= l ...Path+ \"#\" + newHash;</li><li>history.replaceState(null, null, newUrl);</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/fredyang/bower-hm.js/hm.debug.js",
                "path": "/fredyang/bower-hm.js/hm.debug.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9mcmVkeWFuZy9ib3dlci1obS5qcy9obS5kZWJ1Zy5qcyBIVFRQLzEuMQ0KSG9zdDogbG9jYWxob3N0Ojk5OTkNCg0K",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogMjQzOTk3DQpBY2NlcHQtUmFuZ2VzOiBieXRlcw0KQ29udGVudC1UeXBlOiBhcHBsaWNhdGlvbi9qYXZhc2NyaXB0DQpEYXRlOiBGcmksIDA3IE5vdiAyMDE0IDAzOjE2OjM5IEdNVA0KTGFzdC1Nb2RpZmllZDogRnJpLCAwNyBOb3YgMjAxNCAwMzoxNjozOSBHTVQNCg0KIC8qIQogICogSG0uanMgSmF2YVNjcmlwdCBMaWJyYXJ5IHYxLjAuMAogICogwqkgRnJlZCBZYW5nIC0gaHR0cDovL3NlbWFudGljc3dvcmtzLmNvbQogICogTGljZW5zZTogTUlUIChodHRwOi8vd3d3Lm9wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL21pdC1saWNlbnNlLnBocCkKICAqIERhdGU6IFR1ZSBBcHIgMSAxOToxNTo1MCAyMDE0IC0wNzAwCiAgKi8KKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCSJ1c2Ugc3RyaWN0IjsKCgkvKmpzaGludCBzbWFydHRhYnM6dHJ1ZSwgZXZpbDp0cnVlLCBleHByOnRydWUsIG5ld2NhcDogZmFsc2UsIHZhbGlkdGhpczogdHJ1ZSAqLwoJLyoqCgkgKiBhIHdyYXBwZXIgb3ZlciBhIE5vZGUgY29uc3RydWN0b3IsCgkgKiBbdmFsdWVdIGlzIG9wdGlvbmFsCgkgKi8KCXZhciBobSA9IHdpbmRvdy5obSA9IGZ1bmN0aW9uKCBwYXRoLCB2YWx1ZSApIHsKCQkJcmV0dXJuIG5ldyBOb2RlKCBwYXRoLCB2YWx1ZSApOwoJCX0sCgkJTm9kZSA9IGZ1bmN0aW9uKCBwYXRoLCB2YWx1ZSApIHsKCQkJcGF0aCA9IHBhdGggfHwgIiI7CgkJCXRoaXMucGF0aCA9IHRvUGh5c2ljYWxQYXRoKCBwYXRoLCB0cnVlIC8qIGNyZWF0ZSBzaGFkb3cgaWYgbmVjZXNzYXJ5ICovICk7CgkJCWlmICghaXNVbmRlZmluZWQoIHZhbHVlICkpIHsKCQkJCXRoaXMuc2V0KCB2YWx1ZSApOwoJCQl9CgkJfSwKCQlkb2N1bWVudCA9IHdpbmRvdy5kb2N1bWVudCwKCQlsb2NhbFN0b3JhZ2UgPSB3aW5kb3cubG9jYWxTdG9yYWdlLAoJCXNldFRpbWVvdXQgPSB3aW5kb3cuc2V0VGltZW91dCwKCQloaXN0b3J5ID0gd2luZG93Lmhpc3RvcnksCgkJbG9jYXRpb24gPSB3aW5kb3cubG9jYXRpb24sCgkJYWxlcnQgPSB3aW5kb3cuYWxlcnQsCgkJY29uZmlybSA9IHdpbmRvdy5jb25maXJtLAoJCWhtRm4sCgkJZXh0ZW5kID0gJC5leHRlbmQsCgkJcmVwb3NpdG9yeSA9IHt9LAoJCWlzQXJyYXkgPSAkLmlzQXJyYXksCgkJaXNGdW5jdGlvbiA9ICQuaXNGdW5jdGlvbiwKCQlwcmltaXRpdmVUeXBlcyA9IHsgJ3VuZGVmaW5lZCc6IHVuZGVmaW5lZCwgJ2Jvb2xlYW4nOiB1bmRlZmluZWQsICdudW1iZXInOiB1bmRlZmluZWQsICdzdHJpbmcnOiB1bmRlZmluZWQgfSwKCQlzaGFkb3dOYW1lc3BhY2UgPSAiX19obSIsCgkJclNoYWRvd0tleSA9IC9eX19obVwuKFteXC5dKz8pKD86XC58JCkvLAoJLy90cnkgdG8gbWF0Y2ggeHh4IGluIHN0cmluZyB0aGlzLmdldCgieHh4IikKCQlyV2F0Y2hlZFBhdGggPSAvdGhpc1wuKD86Z2V0KVxzKlwoXHMqKFsnIl0pKFtcKlwuXHdcL10rKVwxXHMqXCkvZywKCgkvL2tleSBpcyB3YXRjaGVkUGF0aHMKCS8vdmFsdWUgaXMgYXJyYXkgb2Ygd2F0Y2hpbmdQYXRocwoJCXdhdGNoVGFibGUgPSB7fSwKCQlkZWZhdWx0T3B0aW9ucyA9IHt9LAoJCXJvb3ROb2RlLAoJCXNoYWRvd1Jvb3QgPSByZXBvc2l0b3J5W3NoYWRvd05hbWVzcGFjZV0gPSB7fSwKCQloYXNPd24gPSByZXBvc2l0b3J5Lmhhc093blByb3BlcnR5LAoJCUFycmF5ID0gd2luZG93LkFycmF5LAoJCWFycmF5UHJvdG90eXBlID0gQXJyYXkucHJvdG90eXBlLAoJCXN0cmluZ1Byb3RvdHlwZSA9IFN0cmluZy5wcm90b3R5cGUsCgkJc2xpY2UgPSBhcnJheVByb3RvdHlwZS5zbGljZSwKCQl0cmlnZ2VyLAoJCWJlZm9yZVVwZGF0ZSA9ICJiZWZvcmVVcGRhdGUiLAoJCWFmdGVyVXBkYXRlID0gImFmdGVyVXBkYXRlIiwKCQliZWZvcmVDcmVhdGUgPSAiYmVmb3JlQ3JlYXRlIiwKCQlhZnRlckNyZWF0ZSA9ICJhZnRlckNyZWF0ZSIsCgkJckpTT04gPSAvXig/Olx7LipcfXxcWy4qXF0pJC8sCgkJclVzZVBhcnNlQ29udGV4dEFzQ29udGV4dCA9IC9eXC4oXC4qKShbXC5cKl0pLywKCQlyTWFpblBhdGggPSAvXlwuPCguKikvLAoJCXJCZWdpbkRvdE9yU3RhciA9IC9eW1wuXCpdLywKCQlyRG90U3RhciA9IC9bXC5cKl0vLAoJCXJIYXNoT3JEb3QgPSAvIyt8XC4vZywKCQlySGFzaCA9IC8jKy9nLAoJCVJlZ0V4cCA9IHdpbmRvdy5SZWdFeHAsCgkJclBhcmVudEtleSA9IC9eKC4rKVtcLlwqXVx3KyQvLAoJCW1lcmdlUGF0aCwKCQlySW5kZXggPSAvXi4rXC4oXHcrKSR8XHcrLywKCQl1dGlsLAoJCWlzVW5kZWZpbmVkLAoJCWlzUHJpbWl0aXZlLAoJCWlzU3RyaW5nLAoJCWlzT2JqZWN0LAoJCWlzQm9vbGVhbiwKCQlpc051bWVyaWMgPSAkLmlzTnVtZXJpYywKCQlpc1Byb21pc2UsCgkJdG9UeXBlZFZhbHVlLAoJCXRvUGh5c2ljYWxQYXRoLAoJCXRvTG9naWNhbFBhdGgsCgkJY2xlYXJPYmosCgkJJGZuID0gJC5mbiwKCQljbG9uZSwKCQlyU3VwcGxhbnQgPSAvXHsoW15ce1x9XSopXH0vZzsKCgkvLyNkZWJ1ZwoJLy9pZiB5b3UgYXJlIHVzaW5nIGRlYnVnIHZlcnNpb24gb2YgdGhlIGxpYnJhcnkKCS8veW91IGNhbiB1c2UgZGVidWdnaW5nIGZhY2lsaXRpZXMgcHJvdmlkZWQgaGVyZQoJLy90aGV5IGFyZSBhbHNvIHVzZWQgaW4gdW5pdCB0ZXN0IHRvIHRlc3Qgc29tZSBpbnRlcm5hbCB2YXJpYWJsZSB3aGljaCBpcwoJLy9ub3QgZXhwb3NlZCBpbiBwcm9kdWN0aW9uIHZlcnNpb24KCS8vSW4gZGVidWcgdmVyc2lvbiwgeW91IGNhbiB0dXJuIG9uIGxvZ2dpbmcgYnkgc2V0dGluZyBobS5kZWJ1Zy5lbmFibGVMb2cgPSB0cnVlCgkvL2FuZCB0dXJuIG9uIGRlYnVnZ2VyIGJ5IHNldHRpbmcgaG0uZGVidWcuZW5hYmxlRGVidWdnZXIgPSB0cnVlCgkvLwoJLy9JbiBwcm9kdWN0aW9uIHZlcnNpb24sIHRoZXJlIGlzIG5vIGxvZ2dpbmcgb3IgZGVidWdnZXIgZmFjaWxpdGllcwoJaG0uZGVidWcgPSB7fTsKCWhtLmRlYnVnLmVuYWJsZUxvZyA9IHRydWU7CglobS5kZWJ1Zy5lbmFibGVEZWJ1Z2dlciA9IGZhbHNlOwoKCXdpbmRvdy5sb2cgPSB3aW5kb3cubG9nIHx8IGZ1bmN0aW9uKCkgewoJCWlmIChobS5kZWJ1Zy5lbmFibGVMb2cgJiYgd2luZG93LmNvbnNvbGUpIHsKCQkJY29uc29sZS5sb2coIEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKCBhcmd1bWVudHMgKSApOwoJCX0KCX07CgkvLyNlbmRfZGVidWcKCgoJZnVuY3Rpb24gYXVnbWVudCggcHJvdG90eXBlLCBleHRlbnNpb24gKSB7CgkJZm9yICh2YXIga2V5IGluIGV4dGVuc2lvbikgewoJCQlpZiAoIXByb3RvdHlwZVtrZXldKSB7CgkJCQlwcm90b3R5cGVba2V5XSA9IGV4dGVuc2lvbltrZXldOwoJCQl9CgkJfQoJfQoKCWF1Z21lbnQoIGFycmF5UHJvdG90eXBlLCB7CgkJaW5kZXhPZjogZnVuY3Rpb24oIG9iaiwgc3RhcnQgKSB7CgkJCWZvciAodmFyIGkgPSAoc3RhcnQgfHwgMCk7IGkgPCB0aGlzLmxlbmd0aDsgaSsrKSB7CgkJCQlpZiAodGhpc1tpXSA9PSBvYmopIHsKCQkJCQlyZXR1cm4gaTsKCQkJCX0KCQkJfQoJCQlyZXR1cm4gLTE7CgkJfSwKCgkJY29udGFpbnM6IGZ1bmN0aW9uKCBpdGVtICkgewoJCQlyZXR1cm4gKHRoaXMuaW5kZXhPZiggaXRlbSApICE9PSAtMSk7CgkJfSwKCgkJcmVtb3ZlOiBmdW5jdGlvbiggaXRlbSApIHsKCQkJdmFyIHBvc2l0aW9uID0gdGhpcy5pbmRleE9mKCBpdGVtICk7CgkJCWlmIChwb3NpdGlvbiAhPSAtMSkgewoJCQkJdGhpcy5zcGxpY2UoIHBvc2l0aW9uLCAxICk7CgkJCX0KCQkJcmV0dXJuIHRoaXM7CgkJfSwKCgkJcmVtb3ZlQXQ6IGZ1bmN0aW9uKCBpbmRleCApIHsKCQkJdGhpcy5zcGxpY2UoIGluZGV4LCAxICk7CgkJCXJldHVybiB0aGlzOwoJCX0sCgoJCXB1c2hVbmlxdWU6IGZ1bmN0aW9uKCBpdGVtICkgewoJCQlpZiAoIXRoaXMuY29udGFpbnMoIGl0ZW0gKSkgewoJCQkJdGhpcy5wdXNoKCBpdGVtICk7CgkJCX0KCQkJcmV0dXJuIHRoaXM7CgkJfSwKCgkJbWVyZ2U6IGZ1bmN0aW9uKCBpdGVtcyApIHsKCQkJaWYgKGl0ZW1zICYmIGl0ZW1zLmxlbmd0aCkgewoJCQkJZm9yICh2YXIgaSA9IDA7IGkgPCBpdGVtcy5sZW5ndGg7IGkrKykgewoJCQkJCXRoaXMucHVzaFVuaXF1ZSggaXRlbXNbaV0gKTsKCQkJCX0KCQkJfQoJCQlyZXR1cm4gdGhpczsKCQl9LAoJCS8vaXQgY2FuIGJlIHNvcnRPYmplY3QoKQoJCS8vc29ydE9iamVjdChieSkKCQlzb3J0T2JqZWN0OiBmdW5jdGlvbiggYnksIGFzYyApIHsKCQkJaWYgKGlzVW5kZWZpbmVkKCBhc2MgKSkgewoJCQkJaWYgKGlzVW5kZWZpbmVkKCBieSApKSB7CgkJCQkJYXNjID0gdHJ1ZTsKCQkJCQlieSA9IHVuZGVmaW5lZDsKCQkJCX0gZWxzZSB7CgkJCQkJaWYgKGlzU3RyaW5nKCBieSApKSB7CgkJCQkJCWFzYyA9IHRydWU7CgkJCQkJfSBlbHNlIHsKCQkJCQkJYXNjID0gYnk7CgkJCQkJCWJ5ID0gdW5kZWZpbmVkOwoJCQkJCX0KCQkJCX0KCQkJfQoKCQkJaWYgKGJ5KSB7CgkJCQl0aGlzLnNvcnQoIGZ1bmN0aW9uKCBhLCBiICkgewoJCQkJCXZhciBhdiA9IGFbYnldOwoJCQkJCXZhciBidiA9IGJbYnldOwoJCQkJCWlmIChhdiA9PSBidikgewoJCQkJCQlyZXR1cm4gMDsKCQkJCQl9CgkJCQkJcmV0dXJuICBhc2MgPyAoYXYgPiBidikgPyAxIDogLTEgOgoJCQkJCQkoYXYgPiBidikgPyAtMSA6IDE7CgkJCQl9ICk7CgkJCX0gZWxzZSB7CgkJCQlhc2MgPyB0aGlzLnNvcnQoKSA6IHRoaXMuc29ydCgpLnJldmVyc2UoKTsKCQkJfQoJCQlyZXR1cm4gdGhpczsKCQl9Cgl9ICk7CgoJYXVnbWVudCggc3RyaW5nUHJvdG90eXBlLCB7CgkJc3RhcnRzV2l0aDogZnVuY3Rpb24oIHRleHQgKSB7CgkJCXJldHVybiB0aGlzLmluZGV4T2YoIHRleHQgKSA9PT0gMDsKCQl9LAoJCWNvbnRhaW5zOiBmdW5jdGlvbiggdGV4dCApIHsKCQkJcmV0dXJuIHRoaXMuaW5kZXhPZiggdGV4dCApICE9PSAtMTsKCQl9LAoJCWVuZHNXaXRoOiBmdW5jdGlvbiggc3VmZml4ICkgewoJCQlyZXR1cm4gdGhpcy5pbmRleE9mKCBzdWZmaXgsIHRoaXMubGVuZ3RoIC0gc3VmZml4Lmxlbmd0aCApICE9PSAtMTsKCQl9LAoJCXN1cHBsYW50OiBmdW5jdGlvbiggb2JqICkgewoJCQlyZXR1cm4gdGhpcy5yZXBsYWNlKCByU3VwcGxhbnQsCgkJCQlmdW5jdGlvbiggYSwgYiApIHsKCQkJCQl2YXIgciA9IG9ialtiXTsKCQkJCQlyZXR1cm4gdHlwZW9mIHIgPyByIDogYTsKCQkJCX0gKTsKCQl9LAoJCWZvcm1hdDogZnVuY3Rpb24oKSB7CgkJCXZhciBzb3VyY2UgPSB0aGlzOwoJCQkkLmVhY2goIGFyZ3VtZW50cywgZnVuY3Rpb24oIGluZGV4LCB2YWx1ZSApIHsKCQkJCXNvdXJjZSA9IHNvdXJjZS5yZXBsYWNlKCBuZXcgUmVnRXhwKCAiXFx7IiArIGluZGV4ICsgIlxcfSIsICJnIiApLCB2YWx1ZSApOwoJCQl9ICk7CgkJCXJldHVybiBzb3VyY2U7CgkJfQoJfSApOwoKCWhtRm4gPSBOb2RlLnByb3RvdHlwZSA9IGhtLmZuID0gaG0ucHJvdG90eXBlID0gewoKCQljb25zdHJ1Y3RvcjogTm9kZSwKCgkJdG9TdHJpbmc6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gdGhpcy5wYXRoOwoJCX0sCgoJCS8vZ2V0KCkKCQkvL2dldCh0cnVlKQoJCS8vCgkJLy9zdWJQYXRoIGNhbiBiZSBudWxsLCB1bmRlZmluZWQsICIiLCBvciAiYW55IHN0cmluZyIKCQkvL2dldChzdWJQYXRoKQoJCS8vZ2V0KHN1YlBhdGgsIHAxLCBwMikKCQkvLwoJCS8vZG9lcyBub3Qgc3VwcG9ydCB0aGUgZm9sbG93aW5nLCBhcyB3aWxsIGJlIGltcGxlbWVudGVkIGFzIGdldCgoc3ViUGF0aCA9IHAxKSwgcDIpCgkJLy9nZXQocDEsIHAyKQoJCWdldDogZnVuY3Rpb24oIHN1YlBhdGggLyosIHAxLCBwMiwgLi4gZm9yIHBhcmFtZXRlcnMgb2YgbW9kZWwgZnVuY3Rpb25zKi8gKSB7CgoJCQl2YXIgY3VycmVudFZhbHVlLCBhY2Nlc3NvciA9IHRoaXMuYWNjZXNzb3IoIHN1YlBhdGgsIHRydWUgKTsKCgkJCWlmIChhY2Nlc3NvcikgewoKCQkJCWlmIChpc0Z1bmN0aW9uKCBhY2Nlc3Nvci5ob3N0T2JqICkpIHsKCgkJCQkJcmV0dXJuIGFjY2Vzc29yLmhvc3RPYmouYXBwbHkoIHRoaXMuY2QoICIuLiIgKSwgc2xpY2UuY2FsbCggYXJndW1lbnRzICkgKTsKCgkJCQl9CgkJCQllbHNlIHsKCgkJCQkJY3VycmVudFZhbHVlID0gIWFjY2Vzc29yLmluZGV4ID8KCQkJCQkJYWNjZXNzb3IuaG9zdE9iaiA6CgkJCQkJCWFjY2Vzc29yLmhvc3RPYmpbYWNjZXNzb3IuaW5kZXhdOwoKCQkJCQlpZiAoaXNGdW5jdGlvbiggY3VycmVudFZhbHVlICkpIHsKCgkJCQkJCS8vaW5zaWRlIHRoZSBmdW5jdGlvbiwgInRoaXMiIHJlZmVyIHRoZSBwYXJlbnQgbW9kZWwgb2YgYWNjZXNzb3IucGh5c2ljYWxQYXRoCgkJCQkJCXJldHVybiBjdXJyZW50VmFsdWUuYXBwbHkoIHRoaXMuY2QoIHN1YlBhdGggKS5jZCggIi4uIiApLCBzbGljZS5jYWxsKCBhcmd1bWVudHMsIDEgKSApOwoKCQkJCQl9IGVsc2UgewoKCQkJCQkJcmV0dXJuIGN1cnJlbnRWYWx1ZTsKCQkJCQl9CgkJCQl9CgkJCX0KCQkJLy9lbHNlIHJldHVybiB1bmRlZmluZWQKCQl9LAoKCQlnZXRKc29uOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIEpTT04uc3RyaW5naWZ5KCB0aGlzLmdldC5hcHBseSggdGhpcywgc2xpY2UuY2FsbCggYXJndW1lbnRzICkgKSApOwoJCX0sCgoJCXJhdzogZnVuY3Rpb24oIHN1YlBhdGgsIHZhbHVlICkgewoJCQl2YXIgYWNjZXNzb3I7CgkJCWlmIChpc0Z1bmN0aW9uKCBzdWJQYXRoICkpIHsKCQkJCXZhbHVlID0gc3ViUGF0aDsKCQkJCXN1YlBhdGggPSAiIjsKCQkJfQoJCQlpZiAoIXZhbHVlKSB7CgkJCQlhY2Nlc3NvciA9IHRoaXMuYWNjZXNzb3IoIHN1YlBhdGgsIHRydWUgKTsKCQkJCWlmIChhY2Nlc3NvcikgewoJCQkJCXJldHVybiAhYWNjZXNzb3IuaW5kZXggPwoJCQkJCQlhY2Nlc3Nvci5ob3N0T2JqIDoKCQkJCQkJYWNjZXNzb3IuaG9zdE9ialthY2Nlc3Nvci5pbmRleF07CgkJCQl9CgkJCX0gZWxzZSB7CgkJCQlhY2Nlc3NvciA9IHRoaXMuYWNjZXNzb3IoIHN1YlBhdGggKTsKCQkJCXJldHVybiAoIGFjY2Vzc29yLmluZGV4IGluIGFjY2Vzc29yLmhvc3RPYmogKSA/CgkJCQkJdGhpcy51cGRhdGUoIHN1YlBhdGgsIHZhbHVlLCBhY2Nlc3NvciApIDoKCQkJCQl0aGlzLmNyZWF0ZSggc3ViUGF0aCwgdmFsdWUsIGFjY2Vzc29yICk7CgkJCX0KCgkJfSwKCgkJLy9yZXR1cm4gbm9kZQoJCS8veW91IGNhbiB1c2Ugbm9kZS5zZXQgdG8gY2FsbCB0aGUgZnVuY3Rpb24gYXQgdGhlIHBhdGgKCQkvL3RoZSBmdW5jdGlvbiBjb250ZXh0IGlzIGJvdW5kIHRvIGN1cnJlbnQgcHJveHkncyBwYXJlbnQKCQkvL3doYXQgaXMgZGlmZmVyZW50IGZvciBnZXQgZnVuY3Rpb24gaXMgdGhhdCwgc2V0IHdpbGwgcmV0dXJuIGEgcHJveHkKCQkvL2FuZCBnZXQgd2lsbCByZXR1cm4gdGhlIHJlc3VsdCBvZiB0aGUgZnVuY3Rpb24KCQlzZXQ6IGZ1bmN0aW9uKCBmb3JjZSwgc3ViUGF0aCwgdmFsdWUgKSB7CgkJCS8vYWxsb3cgc2V0KHBhdGgsIHVuZGVmaW5lZCkKCQkJaWYgKGFyZ3VtZW50cy5sZW5ndGggPT0gMSkgewoJCQkJaWYgKHRoaXMucGF0aCA9PT0gIiIpIHsKCQkJCQl0aHJvdyAicm9vdCBvYmplY3QgY2FuIG5vdCBjaGFuZ2VkIjsKCQkJCX0gZWxzZSB7CgkJCQkJcm9vdE5vZGUuc2V0KCB0aGlzLnBhdGgsIGZvcmNlLCBzdWJQYXRoICk7CgkJCQkJcmV0dXJuIHRoaXM7CgkJCQl9CgkJCX0KCgkJCXZhciBhcmdzID0gc2xpY2UuY2FsbCggYXJndW1lbnRzICk7CgoJCQlpZiAoIWlzQm9vbGVhbiggZm9yY2UgKSkgewoJCQkJdmFsdWUgPSBzdWJQYXRoOwoJCQkJc3ViUGF0aCA9IGZvcmNlOwoJCQkJZm9yY2UgPSBmYWxzZTsKCQkJfSBlbHNlIGlmIChhcmd1bWVudHMubGVuZ3RoID09IDIpIHsKCQkJCXJvb3ROb2RlLnNldCggZm9yY2UsIHRoaXMucGF0aCwgc3ViUGF0aCApOwoJCQkJcmV0dXJuIHRoaXM7CgkJCX0KCgkJCXZhciBhY2Nlc3NvciA9IHRoaXMuYWNjZXNzb3IoIHN1YlBhdGggKTsKCQkJdmFyIGN1cnJlbnRWYWx1ZSA9IGFjY2Vzc29yLmhvc3RPYmpbYWNjZXNzb3IuaW5kZXhdOwoKCQkJaWYgKGlzRnVuY3Rpb24oIGN1cnJlbnRWYWx1ZSApKSB7CgoJCQkJLy9pbnNpZGUgdGhlIGZ1bmN0aW9uLCAidGhpcyIgcmVmZXIgdGhlIHBhcmVudCBtb2RlbCBvZiBhY2Nlc3Nvci5waHlzaWNhbFBhdGgKCQkJCWN1cnJlbnRWYWx1ZS5hcHBseSggdGhpcy5jZCggc3ViUGF0aCApLmNkKCAiLi4iICksIHNsaWNlLmNhbGwoIGFyZ3MsIDEgKSApOwoJCQkJcmV0dXJuIHRoaXM7CgoJCQl9IGVsc2UgewoKCQkJCXJldHVybiAoIGFjY2Vzc29yLmluZGV4IGluIGFjY2Vzc29yLmhvc3RPYmogKSA/CgkJCQkJdGhpcy51cGRhdGUoIGZvcmNlLCBzdWJQYXRoLCB2YWx1ZSwgYWNjZXNzb3IgKSA6CgkJCQkJdGhpcy5jcmVhdGUoIGZvcmNlLCBzdWJQYXRoLCB2YWx1ZSwgYWNjZXNzb3IgKTsKCgkJCX0KCQl9LAoKCQlhY2Nlc3NvcjogZnVuY3Rpb24oIHN1YlBhdGgsIHJlYWRPbmx5IC8qaW50ZXJuYWwgdXNlIG9ubHkqLyApIHsKCQkJLy9pZiBpdCBpcyBub3QgcmVhZE9ubHksIGFuZCBhY2Nlc3Mgb3V0IG9mIGJvdW5kYXJ5LCBpdCB3aWxsIHRocm93IGV4Y2VwdGlvbgoJCQlpZiAoc3ViUGF0aCA9PT0gMCkgewoJCQkJc3ViUGF0aCA9ICIwIjsKCQkJfQoKCQkJdmFyIGksCgkJCQlpbmRleCwKCQkJLy90aGUgaG9zdE9iaiBzdGFydCBmcm9tIHJvb3QKCQkJCWhvc3RPYmogPSByZXBvc2l0b3J5LAoJCQkvL3RoZSBmdWxsUGF0aCBjYW4gYmUgbG9naWNhbFBhdGggLCBmb3IgZXhhbXBsZSBobSgicGVyc29uIikuZ2V0UGF0aCgiKiIpOwoJCQkvL2l0IGNhbiBhbHNvIGJlIGEgcGh5c2ljYWxQYXRoIGxpa2UgaG0oInBlcnNvbioiKS5nZXRQYXRoKCk7CgkJCQlmdWxsUGF0aCA9IHRoaXMuZ2V0UGF0aCggc3ViUGF0aCApLAoJCQkvL21ha2Ugc3VyZSB3ZSBhcmUgd29ya2luZyBvbiBhIHBoeXNpY2FsUGF0aAoJCQkJcGh5c2ljYWxQYXRoID0gdG9QaHlzaWNhbFBhdGgoIGZ1bGxQYXRoLCB0cnVlIC8qY3JlYXRlIHNoYWRvdyBpZiBuZWNlc3NhcnkqLyApLAoJCQkJcGFydHMgPSBwaHlzaWNhbFBhdGguc3BsaXQoICIuIiApOwoKCQkJaWYgKHBhcnRzLmxlbmd0aCA9PT0gMSkgewoKCQkJCWluZGV4ID0gcGh5c2ljYWxQYXRoOwoKCQkJfSBlbHNlIHsKCgkJCQkvL2luZGV4IGlzIHRoZSBsYXN0IHBhcnQKCQkJCWluZGV4ID0gcGFydHNbcGFydHMubGVuZ3RoIC0gMV07CgoJCQkJLy90cmF2ZXJzZSB0byB0aGUgc2Vjb25kIGxhc3Qgbm9kZSBpbiB0aGUgcGFydHMgaGllcmFyY2h5CgkJCQlmb3IgKGkgPSAwOyBpIDwgcGFydHMubGVuZ3RoIC0gMTsgaSsrKSB7CgkJCQkJaG9zdE9iaiA9IGhvc3RPYmpbcGFydHNbaV1dOwoJCQkJCWlmIChob3N0T2JqID09PSB1bmRlZmluZWQpIHsKCQkJCQkJYnJlYWs7CgkJCQkJfQoJCQkJfQoJCQl9CgoJCQlpZiAoaXNQcmltaXRpdmUoIGhvc3RPYmogKSkgewoJCQkJaWYgKHJlYWRPbmx5KSB7CgkJCQkJcmV0dXJuOwoJCQkJfQoJCQkJZWxzZSB7CgkJCQkJdGhyb3cgImludmFsaWQgdXBkYXRlIG9uIHVucmVhY2hhYmxlIG5vZGUgJyIgKyB0b0xvZ2ljYWxQYXRoKCBmdWxsUGF0aCApICsgIiciOwoJCQkJfQoJCQl9CgoJCQlyZXR1cm4gewoJCQkJcGh5c2ljYWxQYXRoOiBwaHlzaWNhbFBhdGgsCgkJCQlob3N0T2JqOiBob3N0T2JqLAoJCQkJaW5kZXg6IGluZGV4CgkJCX07CgkJfSwKCgkJY3JlYXRlOiBmdW5jdGlvbiggZm9yY2UsIHN1YlBhdGgsIHZhbHVlLCBhY2Nlc3NvciAvKiBhY2Nlc3NvciBpcyB1c2VkIGludGVybmFsbHkgKi8gKSB7CgoJCQlpZiAoIWlzQm9vbGVhbiggZm9yY2UgKSkgewoJCQkJYWNjZXNzb3IgPSB2YWx1ZTsKCQkJCXZhbHVlID0gc3ViUGF0aDsKCQkJCXN1YlBhdGggPSBmb3JjZTsKCQkJCWZvcmNlID0gZmFsc2U7CgkJCX0KCgkJCWFjY2Vzc29yID0gYWNjZXNzb3IgfHwgdGhpcy5hY2Nlc3Nvciggc3ViUGF0aCApOwoKCQkJdmFyIHBoeXNpY2FsUGF0aCA9IGFjY2Vzc29yLnBoeXNpY2FsUGF0aDsKCgkJCXZhciBob3N0T2JqID0gYWNjZXNzb3IuaG9zdE9iaiwKCQkJCWluZGV4ID0gYWNjZXNzb3IuaW5kZXgsCgkJCQlpc0hvc3RPYmpBcnJheSA9IGlzQXJyYXkoIGhvc3RPYmogKTsKCgkJCWlmIChpc0hvc3RPYmpBcnJheSAmJiBpc051bWVyaWMoIGluZGV4ICkpIHsKCQkJCWlmIChpbmRleCA+IGhvc3RPYmoubGVuZ3RoKSB7CgkJCQkJdGhyb3cgInlvdSBjYW4gbm90IGFkZCBpdGVtIHdpdGggaG9sZSBpbiBhcnJheSI7CgkJCQl9CgkJCX0gZWxzZSB7CgkJCQlpZiAoaW5kZXggaW4gaG9zdE9iaikgewoJCQkJCXRocm93ICJ2YWx1ZSBhdCBwYXRoOiAnIiArIHRvTG9naWNhbFBhdGgoIGFjY2Vzc29yLnBoeXNpY2FsUGF0aCApICsgIicgaGFzIGJlZW4gZGVmaW5lZCwgIiArCgkJCQkJICAgICAgInRyeSB1c2UgdXBkYXRlIG1ldGhvZCBpbnN0ZWFkIjsKCQkJCX0KCQkJfQoKCQkJaWYgKCFmb3JjZSAmJiB0cmlnZ2VyKCBwaHlzaWNhbFBhdGgsIHBoeXNpY2FsUGF0aCwgYmVmb3JlQ3JlYXRlLCB2YWx1ZSApLmhhc0Vycm9yKCkpIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoKCQkJaWYgKGlzSG9zdE9iakFycmF5ICYmIGlzTnVtZXJpYyggaW5kZXggKSkgewoJCQkJaWYgKGluZGV4ID09IGhvc3RPYmoubGVuZ3RoKSB7CgkJCQkJaG9zdE9ialtpbmRleF0gPSB2YWx1ZTsKCgkJCQl9IGVsc2UgaWYgKGluZGV4IDwgaG9zdE9iai5sZW5ndGgpIHsKCQkJCQkvL2luc2VydCBhbiBpdGVtIHggaW50byBhcnJheSBbIDEsIDIsIDNdIGF0IHBvc2l0aW9uIDIsCgkJCQkJLy8gYW5kIGl0IGJlY29tZXMgWzEsIHgsIDIsIDNdCgkJCQkJaG9zdE9iai5zcGxpY2UoIGFjY2Vzc29yLmluZGV4LCAwLCB2YWx1ZSApOwoJCQkJfQoKCQkJfSBlbHNlIHsKCQkJCWhvc3RPYmpbYWNjZXNzb3IuaW5kZXhdID0gdmFsdWU7CgkJCX0KCgkJCXRyYXZlcnNlTW9kZWwoIHBoeXNpY2FsUGF0aCwgdmFsdWUgKTsKCQkJdHJpZ2dlciggcGh5c2ljYWxQYXRoLCBwaHlzaWNhbFBhdGgsIGFmdGVyQ3JlYXRlLCB2YWx1ZSApOwoJCQlyZXR1cm4gdGhpczsKCQl9LAoKCQlleHRlbmQ6IGZ1bmN0aW9uKCBzdWJQYXRoLCBvYmplY3QgKSB7CgkJCXZhciBuZXdNb2RlbDsKCQkJaWYgKCFvYmplY3QpIHsKCQkJCW9iamVjdCA9IHN1YlBhdGg7CgkJCQluZXdNb2RlbCA9IHRoaXM7CgkJCX0gZWxzZSB7CgkJCQluZXdNb2RlbCA9IHRoaXMuY2QoIHN1YlBhdGggKTsKCQkJfQoJCQlmb3IgKHZhciBrZXkgaW4gb2JqZWN0KSB7CgkJCQluZXdNb2RlbC5zZXQoIGtleSwgb2JqZWN0W2tleV0gKTsKCQkJfQoJCQlyZXR1cm4gdGhpczsKCQl9LAoKCQkvKiBhY2Nlc3NvciBpcyB1c2VkIGludGVybmFsbHkgKi8KCQkvL3VwZGF0ZSh2YWx1ZSkKCQkvL3VwZGF0ZShzdWJQYXRoLCB2YWx1ZSkKCQkvL21vc3Qgb2YgdGhlIHRpbWUgZm9yY2UgaXMgbm90IHVzZWQsIGJ5IGRlZmF1bHQgaXMgaXQgaXMgZmFsc2UKCQkvL2J5IGluIGNhc2UgeW91IHdhbnQgdG8gYnlwYXNzIHZhbGlkYXRpb24geW91IGNhbiBleHBsaWNpdGx5IHNldCB0byB0cnVlCgkJdXBkYXRlOiBmdW5jdGlvbiggZm9yY2UsIHN1YlBhdGgsIHZhbHVlLCBhY2Nlc3NvciApIHsKCgkJCWlmIChhcmd1bWVudHMubGVuZ3RoID09IDEpIHsKCQkJCWlmICh0aGlzLnBhdGggPT09ICIiKSB7CgkJCQkJdGhyb3cgInJvb3Qgb2JqZWN0IGNhbiBub3QgdXBkYXRlZCI7CgkJCQl9IGVsc2UgewoJCQkJCXJvb3ROb2RlLnVwZGF0ZSggdGhpcy5wYXRoLCBmb3JjZSApOwoJCQkJCXJldHVybiB0aGlzOwoJCQkJfQoJCQl9CgoJCQlpZiAoIWlzQm9vbGVhbiggZm9yY2UgKSkgewoJCQkJYWNjZXNzb3IgPSB2YWx1ZTsKCQkJCXZhbHVlID0gc3ViUGF0aDsKCQkJCXN1YlBhdGggPSBmb3JjZTsKCQkJCWZvcmNlID0gZmFsc2U7CgkJCX0gZWxzZSBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PSAyKSB7CgkJCQlyb290Tm9kZS51cGRhdGUoIGZvcmNlLCB0aGlzLnBhdGgsIHN1YlBhdGggKTsKCQkJCXJldHVybiB0aGlzOwoJCQl9CgoJCQlhY2Nlc3NvciA9IGFjY2Vzc29yIHx8IHRoaXMuYWNjZXNzb3IoIHN1YlBhdGggKTsKCgkJCWlmICghKCBhY2Nlc3Nvci5pbmRleCBpbiBhY2Nlc3Nvci5ob3N0T2JqICkpIHsKCQkJCXRocm93ICJ2YWx1ZSBhdCBwYXRoOiAnIiArIHRvTG9naWNhbFBhdGgoIGFjY2Vzc29yLnBoeXNpY2FsUGF0aCApICsgIicgaGFzIGJlZW4gbm90IGRlZmluZWQsICIgKwoJCQkJICAgICAgInRyeSB1c2UgY3JlYXRlIG1ldGhvZCBpbnN0ZWFkIjsKCQkJfQoKCQkJdmFyIHBoeXNpY2FsUGF0aCA9IGFjY2Vzc29yLnBoeXNpY2FsUGF0aDsKCgkJCXZhciBvcmlnaW5hbFZhbHVlID0gYWNjZXNzb3IuaG9zdE9ialthY2Nlc3Nvci5pbmRleF07CgkJCS8vdXNlICI9PSIgaXMgcHVycG9zZWZ1bCwgd2Ugd2FudCBpdCB0byBiZSBmbGV4aWJsZS4KCQkJLy8gSWYgbW9kZWwgdmFsdWUgaXMgbnVsbCwgYW5kIHRleHRCb3ggdmFsdWUgaXMgIiIsIGJlY2F1c2UgbnVsbCA9PSAiIiwKCQkJLy8gc28gdGhhdCAiIiBjYW4gbm90IGJlIHNldCwgc2FtZSBmb3IgIjkiIGFuZCA5CgkJCWlmIChvcmlnaW5hbFZhbHVlID09IHZhbHVlKSB7CgkJCQlyZXR1cm4gdGhpczsKCQkJfQoKCQkJaWYgKCFmb3JjZSAmJiB0cmlnZ2VyKCBwaHlzaWNhbFBhdGgsIHBoeXNpY2FsUGF0aCwgYmVmb3JlVXBkYXRlLCB2YWx1ZSwgb3JpZ2luYWxWYWx1ZSApLmhhc0Vycm9yKCkpIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoKCQkJYWNjZXNzb3IuaG9zdE9ialthY2Nlc3Nvci5pbmRleF0gPSB2YWx1ZTsKCgkJCXRyYXZlcnNlTW9kZWwoIHBoeXNpY2FsUGF0aCwgdmFsdWUgKTsKCgkJCWlmICghZm9yY2UpIHsKCQkJCXRyaWdnZXIoIHBoeXNpY2FsUGF0aCwgcGh5c2ljYWxQYXRoLCBhZnRlclVwZGF0ZSwgdmFsdWUsIG9yaWdpbmFsVmFsdWUgKTsKCQkJfQoKCQkJcmV0dXJuIHRoaXM7CgkJfSwKCgkJZGVsOiBmdW5jdGlvbiggc3ViUGF0aCApIHsKCQkJaWYgKGlzVW5kZWZpbmVkKCBzdWJQYXRoICkpIHsKCQkJCWlmICh0aGlzLnBhdGgpIHsKCQkJCQlyZXR1cm4gcm9vdE5vZGUuZGVsKCB0aGlzLnBhdGggKTsKCQkJCX0KCQkJCXRocm93ICJyb290IGNhbiBub3QgYmUgZGVsZXRlZCI7CgkJCX0KCgkJCXZhciBhY2Nlc3NvciA9IHRoaXMuYWNjZXNzb3IoIHN1YlBhdGggKSwKCQkJCWhvc3RPYmogPSBhY2Nlc3Nvci5ob3N0T2JqLAoJCQkJcGh5c2ljYWxQYXRoID0gYWNjZXNzb3IucGh5c2ljYWxQYXRoLAoJCQkJcmVtb3ZlZFZhbHVlID0gaG9zdE9ialthY2Nlc3Nvci5pbmRleF0sCgkJCQlpc0hvc3RPYmplY3RBcnJheSA9IGlzQXJyYXkoIGhvc3RPYmogKTsKCgkJCWlmICh0cmlnZ2VyKCBwaHlzaWNhbFBhdGgsIHBoeXNpY2FsUGF0aCwgImJlZm9yZURlbCIsIHVuZGVmaW5lZCwgcmVtb3ZlZFZhbHVlICkuaGFzRXJyb3IoKSkgewoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgoJCQl0cmlnZ2VyKCBwaHlzaWNhbFBhdGgsIHBoeXNpY2FsUGF0aCwgImR1cmluZ0RlbCIsIHVuZGVmaW5lZCwgcmVtb3ZlZFZhbHVlICk7CgoJCQlpZiAoaXNIb3N0T2JqZWN0QXJyYXkpIHsKCgkJCQlob3N0T2JqLnNwbGljZSggYWNjZXNzb3IuaW5kZXgsIDEgKTsKCgkJCX0gZWxzZSB7CgoJCQkJZGVsZXRlIGhvc3RPYmpbYWNjZXNzb3IuaW5kZXhdOwoKCQkJfQoKCQkJZm9yICh2YXIgaSA9IDA7IGkgPCBvbkRlbGV0ZUhhbmRsZXJzLmxlbmd0aDsgaSsrKSB7CgkJCQlvbkRlbGV0ZUhhbmRsZXJzW2ldKCBwaHlzaWNhbFBhdGgsIHJlbW92ZWRWYWx1ZSApOwoJCQl9CgoJCQl0cmlnZ2VyKCBwaHlzaWNhbFBhdGgsIHBoeXNpY2FsUGF0aCwgImFmdGVyRGVsIiwgdW5kZWZpbmVkLCByZW1vdmVkVmFsdWUgKTsKCQkJcmV0dXJuIHJlbW92ZWRWYWx1ZTsKCQl9LAoKCQljcmVhdGVJZlVuZGVmaW5lZDogZnVuY3Rpb24oIHN1YlBhdGgsIHZhbHVlICkgewoJCQlpZiAoaXNVbmRlZmluZWQoIHZhbHVlICkpIHsKCQkJCXRocm93ICJtaXNzaW5nIHZhbHVlIGFyZ3VtZW50IjsKCQkJfQoJCQl2YXIgYWNjZXNzb3IgPSB0aGlzLmFjY2Vzc29yKCBzdWJQYXRoICk7CgkJCXJldHVybiAoIGFjY2Vzc29yLmluZGV4IGluIGFjY2Vzc29yLmhvc3RPYmogKSA/CgkJCQl0aGlzIDoKCQkJCXRoaXMuY3JlYXRlKCBzdWJQYXRoLCB2YWx1ZSwgYWNjZXNzb3IgKTsKCQl9LAoKCQl0b2dnbGU6IGZ1bmN0aW9uKCBzdWJQYXRoICkgewoKCQkJdmFyIGFjY2Vzc29yID0gdGhpcy5hY2Nlc3Nvciggc3ViUGF0aCApOwoJCQlpZiAoYWNjZXNzb3IuaW5kZXggaW4gYWNjZXNzb3IuaG9zdE9iaikgewoJCQkJdGhpcy51cGRhdGUoIHN1YlBhdGgsICFhY2Nlc3Nvci5ob3N0T2JqW2FjY2Vzc29yLmluZGV4XSwgYWNjZXNzb3IgKTsKCQkJfQoJCQlyZXR1cm4gdGhpczsKCQl9LAoKCQkvL25hdmlnYXRpb24gbWV0aG9kcwoJCXB1c2hTdGFjazogZnVuY3Rpb24oIG5ld05vZGUgKSB7CgkJCW5ld05vZGUucHJldmlvdXMgPSB0aGlzOwoJCQlyZXR1cm4gbmV3Tm9kZTsKCQl9LAoKCQljZDogZnVuY3Rpb24oIHJlbGF0aXZlUGF0aCApIHsKCQkJcmV0dXJuIHRoaXMucHVzaFN0YWNrKCBobSggdGhpcy5nZXRQYXRoKCByZWxhdGl2ZVBhdGggKSApICk7CgkJfSwKCgkJcGFyZW50OiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHRoaXMuY2QoICIuLiIgKTsKCQl9LAoKCQlzaGFkb3c6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gdGhpcy5jZCggIioiICk7CgkJfSwKCgkJc2libGluZzogZnVuY3Rpb24oIHBhdGggKSB7CgkJCXJldHVybiB0aGlzLmNkKCAiLi4iICsgcGF0aCApOwoJCX0sCgoJCW1haW46IGZ1bmN0aW9uKCkgewoKCQkJcmV0dXJuIHRoaXMucHVzaFN0YWNrKCBobSggZ2V0TWFpblBhdGgoIHRoaXMucGF0aCApICkgKTsKCQl9LAoKCQkvLy0tLS0tLS0tLS0tLS0tcGF0aCBtZXRob2RzLS0tLS0tLS0tLS0tLS0tCgkJZ2V0UGF0aDogZnVuY3Rpb24oIHN1YlBhdGggKSB7CgkJCS8vam9pbiB0aGUgY29udGV4dCBhbmQgc3ViUGF0aCB0b2dldGhlciwgYnV0IGl0IGlzIHN0aWxsIGEgbG9naWNhbCBwYXRoCgkJCXJldHVybiBtZXJnZVBhdGgoIHRoaXMucGF0aCwgc3ViUGF0aCApOwoJCX0sCgoJCS8vdG8gZ2V0IHRoZSBsb2dpY2FsUGF0aCBvZiBjdXJyZW50IG1vZGVsLCBsZWF2ZSBzdWJQYXRoIGVtcHR5CgkJbG9naWNhbFBhdGg6IGZ1bmN0aW9uKCBzdWJQYXRoICkgewoJCQlyZXR1cm4gdG9Mb2dpY2FsUGF0aCggdGhpcy5nZXRQYXRoKCBzdWJQYXRoICkgKTsKCQl9LAoKCQkvL3RvIGdldCB0aGUgcGh5c2ljYWxQYXRoIG9mIGN1cnJlbnQgbW9kZWwsIGxlYXZlIHN1YlBhdGggZW1wdHkKCQlwaHlzaWNhbFBhdGg6IGZ1bmN0aW9uKCBzdWJQYXRoICkgewoJCQlyZXR1cm4gdG9QaHlzaWNhbFBhdGgoIHRoaXMuZ2V0UGF0aCggc3ViUGF0aCApICk7CgkJfSwKCgkJcGF0aENvbnRleHQ6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gY29udGV4dE9mUGF0aCggdGhpcy5wYXRoICk7CgkJfSwKCgkJcGF0aEluZGV4OiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIGluZGV4T2ZQYXRoKCB0aGlzLnBhdGggKTsKCQl9LAoKCQkvL2NhbGwgdGhlIG5hdGl2ZSBtZXRob2Qgb2YgdGhlIHdyYXBwZWQgdmFsdWUKCQlpbnZva2VVbndyYXBwZWQ6IGZ1bmN0aW9uKCBtZXRob2ROYW1lIC8qLCBwMSwgcDIsIC4uLiovICkgewoJCQlpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMCkgewoJCQkJdGhyb3cgIm1ldGhvZE5hbWUgaXMgbWlzc2luZyI7CgkJCX0KCgkJCXZhciBjb250ZXh0ID0gdGhpcy5nZXQoKTsKCQkJcmV0dXJuIGNvbnRleHRbbWV0aG9kTmFtZV0uYXBwbHkoIGNvbnRleHQsIHNsaWNlLmNhbGwoIGFyZ3VtZW50cywgMSApICk7CgkJfSwKCgkJLy9yZWdpb24gYXJyYXkgbWV0aG9kcwoJCWluZGV4T2Y6IGZ1bmN0aW9uKCBpdGVtICkgewoJCQlyZXR1cm4gdGhpcy5nZXQoKS5pbmRleE9mKCBpdGVtICk7CgkJfSwKCgkJY29udGFpbnM6IGZ1bmN0aW9uKCBpdGVtICkgewoJCQlyZXR1cm4gKHRoaXMuaW5kZXhPZiggaXRlbSApICE9PSAtMSk7CgkJfSwKCgkJZmlyc3Q6IGZ1bmN0aW9uKCBmbiApIHsKCQkJcmV0dXJuIGZuID8gdGhpcy5maWx0ZXIoIGZuIClbMF0gOiB0aGlzLmdldCggIjAiICk7CgkJfSwKCgkJbGFzdDogZnVuY3Rpb24oKSB7CgkJCXZhciB2YWx1ZSA9IHRoaXMuZ2V0KCk7CgkJCXJldHVybiB2YWx1ZVt2YWx1ZS5sZW5ndGggLSAxXTsKCQl9LAoKCQlwdXNoOiBmdW5jdGlvbiggaXRlbSApIHsKCQkJZm9yICh2YXIgaSA9IDA7IGkgPCBhcmd1bWVudHMubGVuZ3RoOyBpKyspIHsKCQkJCXRoaXMuY3JlYXRlKCB0aGlzLmdldCgpLmxlbmd0aCwgYXJndW1lbnRzW2ldICk7CgkJCX0KCQkJcmV0dXJuIHRoaXM7CgkJfSwKCgkJcHVzaFVuaXF1ZTogZnVuY3Rpb24oIGl0ZW0gKSB7CgkJCXJldHVybiAhdGhpcy5jb250YWlucyggaXRlbSApID8KCQkJCXRoaXMucHVzaCggaXRlbSApIDoKCQkJCXRoaXM7CgkJfSwKCgkJcG9wOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHRoaXMucmVtb3ZlQXQoIHRoaXMuZ2V0KCkubGVuZ3RoIC0gMSApOwoJCX0sCgoJCXNoaWZ0OiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHRoaXMuZGVsKCAwICk7CgkJfSwKCgkJdW5zaGlmdDogZnVuY3Rpb24oIGl0ZW0gKSB7CgkJCXJldHVybiB0aGlzLmNyZWF0ZSggMCwgaXRlbSApOwoJCX0sCgoJCWluc2VydEF0OiBmdW5jdGlvbiggaW5kZXgsIGl0ZW0gKSB7CgkJCXJldHVybiB0aGlzLmNyZWF0ZSggaW5kZXgsIGl0ZW0gKTsKCQl9LAoKCQl1cGRhdGVBdDogZnVuY3Rpb24oIGluZGV4LCBpdGVtICkgewoJCQlyZXR1cm4gdGhpcy51cGRhdGUoIGluZGV4LCBpdGVtICk7CgkJfSwKCgkJcmVtb3ZlQXQ6IGZ1bmN0aW9uKCBpbmRleCApIHsKCQkJcmV0dXJuIHRoaXMuZGVsKCBpbmRleCApOwoJCX0sCgoJCW1vdmU6IGZ1bmN0aW9uKCBmcm9tSW5kZXgsIHRvSW5kZXggKSB7CgkJCXZhciBjb3VudCA9IHRoaXMuY291bnQoKTsKCgkJCWlmIChmcm9tSW5kZXggIT09IHRvSW5kZXggJiYKCQkJICAgIGZyb21JbmRleCA+PSAwICYmIGZyb21JbmRleCA8IGNvdW50ICYmCgkJCSAgICB0b0luZGV4ID49IDAgJiYgdG9JbmRleCA8IGNvdW50KSB7CgoJCQkJdmFyIGl0ZW0gPSB0aGlzLmRlbCggZnJvbUluZGV4ICk7CgkJCQl0aGlzLmluc2VydEF0KCB0b0luZGV4LCBpdGVtICk7CgkJCQl0cmlnZ2VyKCB0aGlzLnBhdGgsIHRoaXMucGF0aCwgIm1vdmUiLCB0b0luZGV4LCBmcm9tSW5kZXggKTsKCQkJfQoJCQlyZXR1cm4gdGhpczsKCQl9LAoKCQlyZXBsYWNlSXRlbTogZnVuY3Rpb24oIG9sZEl0ZW0sIG5ld0l0ZW0gKSB7CgkJCWlmIChvbGRJdGVtID09IG5ld0l0ZW0pIHsKCQkJCXJldHVybiB0aGlzOwoJCQl9CgoJCQl2YXIgaW5kZXggPSB0aGlzLmluZGV4T2YoIG9sZEl0ZW0gKTsKCgkJCWlmIChpbmRleCAhPSAtMSkgewoJCQkJcmV0dXJuIHRoaXMudXBkYXRlQXQoIGluZGV4LCBuZXdJdGVtICk7CgkJCX0KCQkJcmV0dXJuIHRoaXM7CgkJfSwKCgkJcmVtb3ZlSXRlbTogZnVuY3Rpb24oIGl0ZW0gKSB7CgkJCXZhciBpbmRleCA9IHRoaXMuaW5kZXhPZiggaXRlbSApOwoJCQlyZXR1cm4gaW5kZXggIT09IC0xID8gdGhpcy5yZW1vdmVBdCggaW5kZXggKSA6IHRoaXM7CgkJfSwKCgkJcmVtb3ZlSXRlbXM6IGZ1bmN0aW9uKCBpdGVtcyApIHsKCQkJZm9yICh2YXIgaSA9IDA7IGkgPCBpdGVtcy5sZW5ndGg7IGkrKykgewoJCQkJdGhpcy5yZW1vdmVJdGVtKCBpdGVtc1tpXSApOwoJCQl9CgkJCXJldHVybiB0aGlzOwoJCX0sCgoJCWNsZWFyOiBmdW5jdGlvbigpIHsKCQkJdmFyIGl0ZW1zID0gdGhpcy5nZXQoKSwKCQkJCW9sZEl0ZW1zID0gaXRlbXMuc3BsaWNlKCAwLCBpdGVtcy5sZW5ndGggKTsKCgkJCXRyaWdnZXIoIHRoaXMucGF0aCwgdGhpcy5wYXRoLCAiYWZ0ZXJDcmVhdGUiLCBpdGVtcywgb2xkSXRlbXMgKTsKCQkJcmV0dXJuIHRoaXM7CgkJfSwKCgkJY291bnQ6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gdGhpcy5nZXQoKS5sZW5ndGg7CgkJfSwKCgkJLy9mbiBpcyBsaWtlIGZ1bmN0aW9uIChpbmRleCwgaXRlbSkgeyByZXR1cm4gaXRlbSA9PSAxOyB9OwoJCWZpbHRlcjogZnVuY3Rpb24oIGZuICkgewoJCQlyZXR1cm4gJCggdGhpcy5nZXQoKSApLmZpbHRlciggZm4gKS5nZXQoKTsKCQl9LAoKCQkvL2ZuOiBmdW5jdGlvbiAoaW5kZXgsIGl0ZW0sIGl0ZW1zKSB7fQoJCWVhY2g6IGZ1bmN0aW9uKCBkaXJlY3RBY2Nlc3MsIGZuICkgewoJCQlpZiAoIWlzQm9vbGVhbiggZGlyZWN0QWNjZXNzICkpIHsKCQkJCWZuID0gZGlyZWN0QWNjZXNzOwoJCQkJZGlyZWN0QWNjZXNzID0gZmFsc2U7CgkJCX0KCgkJCXZhciBoYXNDaGFuZ2UsIGksIHN0YXR1cywgaXRlbXMsIGl0ZW1Nb2RlbDsKCgkJCWlmIChkaXJlY3RBY2Nlc3MpIHsKCgkJCQlpdGVtcyA9IHRoaXMuZ2V0KCk7CgoJCQkJZm9yIChpID0gaXRlbXMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKCQkJCQkvL3RoaXMgaW4gdGhlIGZuIHJlZmVyIHRvIHRoZSBwYXJlbnQgYXJyYXkKCQkJCQlzdGF0dXMgPSBmbi5jYWxsKCBpdGVtc1tpXSwgaSwgaXRlbXNbaV0sIGl0ZW1zICk7CgkJCQkJaWYgKHN0YXR1cyA9PT0gdHJ1ZSkgewoJCQkJCQloYXNDaGFuZ2UgPSB0cnVlOwoJCQkJCX0gZWxzZSBpZiAoc3RhdHVzID09PSBmYWxzZSkgewoJCQkJCQlicmVhazsKCQkJCQl9CgkJCQl9CgoJCQkJaWYgKGhhc0NoYW5nZSkgewoJCQkJCXRoaXMuY2hhbmdlKCk7CgkJCQl9CgoJCQl9IGVsc2UgewoJCQkJZm9yIChpID0gdGhpcy5jb3VudCgpIC0gMTsgaSA+PSAwOyBpLS0pIHsKCQkJCQkvL3RoaXMgaW4gdGhlIGZuLCByZWZlciB0byB0aGUgcGFyZW50IG1vZGVsCgkJCQkJaXRlbU1vZGVsID0gdGhpcy5jZCggaSApOwoJCQkJCWlmIChmbi5jYWxsKCBpdGVtTW9kZWwsIGksIGl0ZW1Nb2RlbCwgdGhpcyApID09PSBmYWxzZSkgewoJCQkJCQlicmVhazsKCQkJCQl9CgkJCQl9CgkJCX0KCQkJcmV0dXJuIHRoaXM7CgkJfSwKCgkJbWFwOiBmdW5jdGlvbiggZm4gKSB7CgkJCXJldHVybiAkLm1hcCggdGhpcy5nZXQoKSwgZm4gKTsKCQl9LAoKCQlzb3J0OiBmdW5jdGlvbiggYnksIGFzYyApIHsKCQkJcmV0dXJuIHRyaWdnZXIoIHRoaXMucGF0aCwgdGhpcy5wYXRoLCAiYWZ0ZXJVcGRhdGUiLCB0aGlzLmdldCgpLnNvcnRPYmplY3QoIGJ5LCBhc2MgKSApOwoJCX0sCgkJLy8jZW5kcmVnaW9uCgoJCS8vLS0tLS0tLW1vZGVsIHdhdGNoIG1ldGhvZCAtLS0tLS0tLS0tLQoJCXdhdGNoOiBmdW5jdGlvbiggLyp0YXJnZXRQYXRoMSwgdGFyZ2V0UGF0aDIsIC4uKi8gKSB7CgkJCWZvciAodmFyIGkgPSAwOyBpIDwgYXJndW1lbnRzLmxlbmd0aDsgaSsrKSB7CgkJCQl3YXRjaCggdGhpcy5wYXRoLCBhcmd1bWVudHNbaV0gKTsKCQkJfQoJCQlyZXR1cm4gdGhpczsKCQl9LAoKCQl1bndhdGNoOiBmdW5jdGlvbiggLyp0YXJnZXRQYXRoMSwgdGFyZ2V0UGF0aDIsIC4uKi8gKSB7CgkJCWZvciAodmFyIGkgPSAwOyBpIDwgYXJndW1lbnRzLmxlbmd0aDsgaSsrKSB7CgkJCQl1bndhdGNoKCB0aGlzLnBhdGgsIGFyZ3VtZW50c1tpXSApOwoJCQl9CgkJCXJldHVybiB0aGlzOwoJCX0sCgoJCS8vZW5kcmVnaW9uCgoJCS8vLS0tLS0tLW90aGVyIG1ldGhvZHMtLS0tLS0tLS0KCQlpc0VtcHR5OiBmdW5jdGlvbiggc3ViUGF0aCApIHsKCQkJdmFyIHZhbHVlID0gdGhpcy5nZXQoIHN1YlBhdGggKTsKCQkJcmV0dXJuICF2YWx1ZSA/IHRydWUgOgoJCQkJIWlzQXJyYXkoIHZhbHVlICkgPyBmYWxzZSA6CgkJCQkJKHZhbHVlLmxlbmd0aCA9PT0gMCk7CgkJfSwKCgkJaXNTaGFkb3c6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gdGhpcy5wYXRoLnN0YXJ0c1dpdGgoIHNoYWRvd05hbWVzcGFjZSApOwoJCX0sCgoJCXRvSlNPTjogZnVuY3Rpb24oIHN1YlBhdGggKSB7CgkJCXJldHVybiBKU09OLnN0cmluZ2lmeSggdGhpcy5nZXQoIHN1YlBhdGggKSApOwoJCX0sCgoJCWNvbXBhcmU6IGZ1bmN0aW9uKCBleHByZXNzaW9uICkgewoJCQlpZiAoZXhwcmVzc2lvbikgewoJCQkJZXhwcmVzc2lvbiA9IHRvVHlwZWRWYWx1ZSggZXhwcmVzc2lvbiApOwoJCQkJaWYgKGlzU3RyaW5nKCBleHByZXNzaW9uICkpIHsKCQkJCQlpZiAodGhpcy5nZXQoKSA9PSBleHByZXNzaW9uKSB7CgkJCQkJCXJldHVybiB0cnVlOwoJCQkJCX0gZWxzZSB7CgkJCQkJCXRyeSB7CgkJCQkJCQlyZXR1cm4gZXZhbCggInRoaXMuZ2V0KCkiICsgZXhwcmVzc2lvbiApOwoJCQkJCQl9IGNhdGNoIChlKSB7CgkJCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQkJCX0KCQkJCQl9CgkJCQl9IGVsc2UgewoJCQkJCXJldHVybiB0aGlzLmdldCgpID09IGV4cHJlc3Npb247CgkJCQl9CgkJCX0gZWxzZSB7CgkJCQlyZXR1cm4gdGhpcy5pc0VtcHR5KCk7CgkJCX0KCQl9LAoKCQlzYXZlTG9jYWw6IGZ1bmN0aW9uKCBzdWJQYXRoICkgewoJCQl1dGlsLmxvY2FsKCB0aGlzLmdldFBhdGgoIHN1YlBhdGggKSwgdGhpcy5nZXQoIHN1YlBhdGggKSApOwoJCQlyZXR1cm4gdGhpczsKCQl9LAoKCQlnZXRMb2NhbDogZnVuY3Rpb24oIHN1YlBhdGggKSB7CgkJCXJldHVybiB1dGlsLmxvY2FsKCB0aGlzLmdldFBhdGgoIHN1YlBhdGggKSApOwoJCX0sCgoJCXJlc3RvcmVMb2NhbDogZnVuY3Rpb24oIHN1YlBhdGggKSB7CgkJCXJvb3ROb2RlLnNldCggdGhpcy5nZXRQYXRoKCBzdWJQYXRoICksIHRoaXMuZ2V0TG9jYWwoIHN1YlBhdGggKSApOwoJCQlyZXR1cm4gdGhpczsKCQl9LAoKCQljbGVhckxvY2FsOiBmdW5jdGlvbiggc3ViUGF0aCApIHsKCQkJdXRpbC5sb2NhbCggdGhpcy5nZXRQYXRoKCBzdWJQYXRoICksIHVuZGVmaW5lZCApOwoJCQlyZXR1cm4gdGhpczsKCQl9CgoJfTsKCglmdW5jdGlvbiBleHBhbmRUb0hhc2hlcyggJDAgKSB7CgkJcmV0dXJuICQwID09PSAiLiIgPyAiIyIgOiAvL2lmIGl0IGlzICIuIiBjb252ZXJ0IHRvICIjIgoJCQluZXcgQXJyYXkoICQwLmxlbmd0aCArIDIgKS5qb2luKCAiIyIgKTsgLy8vL2lmIGl0IGlzICIjIiBjb252ZXJ0IHRvICIjIyIKCX0KCgl2YXIgb25BZGRPclVwZGF0ZUhhbmRsZXJzID0gW2Z1bmN0aW9uIC8qaW5mZXJOb2RlRGVwZW5kZW5jaWVzKi8gKCBjb250ZXh0LCBpbmRleCwgdmFsdWUgKSB7CgoJCS8vb25seSB0cnkgdG8gcGFyc2UgZnVuY3Rpb24gYm9keQoJCS8vaWYgaXQgaXMgYSBwYXJhbWV0ZXItbGVzcyBmdW5jdGlvbgoJCS8vb3IgaXQgaGFzIGEgbWFnaWMgZnVuY3Rpb24gbmFtZSAiXyIKCQlpZiAoIWlzRnVuY3Rpb24oIHZhbHVlICkgfHwgKHZhbHVlLm5hbWUgJiYgdmFsdWUubmFtZS5zdGFydHNXaXRoKCAiXyIgKSkpIHsKCQkJcmV0dXJuOwoJCX0KCgkJdmFyIGZ1bmN0aW9uQm9keSA9IHZhbHVlLnRvU3RyaW5nKCksCgkJCXBhdGggPSBjb250ZXh0ID8gY29udGV4dCArICIuIiArIGluZGV4IDogaW5kZXgsCgkJCXdhdGNoZWRQYXRocyA9IGV4dHJhY3RXYXRjaGVkUGF0aHMoIGZ1bmN0aW9uQm9keSApOwoKCQlmb3IgKHZhciBpID0gMDsgaSA8IHdhdGNoZWRQYXRocy5sZW5ndGg7IGkrKykgewoJCQl3YXRjaCggcGF0aCwgY29udGV4dCA/IG1lcmdlUGF0aCggY29udGV4dCwgd2F0Y2hlZFBhdGhzW2ldICkgOiB3YXRjaGVkUGF0aHNbaV0gKTsKCQl9Cgl9XTsKCglmdW5jdGlvbiBwcm9jZXNzTmV3Tm9kZSggY29udGV4dFBhdGgsIGluZGV4UGF0aCwgbW9kZWxWYWx1ZSApIHsKCQlmb3IgKHZhciBpID0gMDsgaSA8IG9uQWRkT3JVcGRhdGVIYW5kbGVycy5sZW5ndGg7IGkrKykgewoJCQlvbkFkZE9yVXBkYXRlSGFuZGxlcnNbaV0oIGNvbnRleHRQYXRoLCBpbmRleFBhdGgsIG1vZGVsVmFsdWUgKTsKCQl9Cgl9CgoJZnVuY3Rpb24gZ2V0TWFpblBhdGgoIHNoYWRvd1BhdGggKSB7CgkJaWYgKHNoYWRvd1BhdGggPT09IHNoYWRvd05hbWVzcGFjZSkgewoJCQlyZXR1cm4gIiI7CgkJfQoJCXZhciBtYXRjaCA9IHJTaGFkb3dLZXkuZXhlYyggc2hhZG93UGF0aCApOwoJCXJldHVybiBtYXRjaCA/IGNvbnZlcnRTaGFkb3dLZXlUb01haW5QYXRoKCBtYXRjaFsxXSApIDogc2hhZG93UGF0aDsKCX0KCglmdW5jdGlvbiBjb252ZXJ0U2hhZG93S2V5VG9NYWluUGF0aCgga2V5ICkgewoJCXJldHVybiBrZXkucmVwbGFjZSggckhhc2gsIHJlZHVjZVRvRG90ICk7Cgl9CgoJZnVuY3Rpb24gcmVkdWNlVG9Eb3QoIGhhc2hlcyApIHsKCQlyZXR1cm4gaGFzaGVzID09ICIjIiA/ICIuIiA6IC8vIGlmIGlzICMgcmV0dXJuIC4KCQkJbmV3IEFycmF5KCBoYXNoZXMubGVuZ3RoICkuam9pbiggIiMiICk7IC8vIGlmIGl0IGlzICMjIHJldHVybiAjCgl9CgoJLyogcHJvY2Vzc0N1cnJlbnQgaXMgdXNlZCBpbnRlcm5hbGx5LCBkb24ndCB1c2UgaXQgKi8KCWZ1bmN0aW9uIHRyYXZlcnNlTW9kZWwoIG1vZGVsUGF0aCwgbW9kZWxWYWx1ZSwgcHJvY2Vzc0N1cnJlbnQgKSB7CgkJdmFyIGNvbnRleHRQYXRoLAoJCQlpbmRleFBhdGgsCgkJCWluZGV4T2ZMYXN0RG90ID0gbW9kZWxQYXRoLmxhc3RJbmRleE9mKCAiLiIgKTsKCgkJaWYgKGlzVW5kZWZpbmVkKCBwcm9jZXNzQ3VycmVudCApKSB7CgkJCXByb2Nlc3NDdXJyZW50ID0gdHJ1ZTsKCQl9CgoJCWlmIChwcm9jZXNzQ3VycmVudCkgewoKCQkJaWYgKGluZGV4T2ZMYXN0RG90ID09PSAtMSkgewoJCQkJY29udGV4dFBhdGggPSAiIjsKCQkJCWluZGV4UGF0aCA9IG1vZGVsUGF0aDsKCQkJfSBlbHNlIHsKCQkJCWNvbnRleHRQYXRoID0gbW9kZWxQYXRoLnN1YnN0cmluZyggMCwgaW5kZXhPZkxhc3REb3QgKTsKCQkJCWluZGV4UGF0aCA9IG1vZGVsUGF0aC5zdWJzdHJpbmcoIGluZGV4T2ZMYXN0RG90ICsgMSApOwoJCQl9CgoJCQlwcm9jZXNzTmV3Tm9kZSggY29udGV4dFBhdGgsIGluZGV4UGF0aCwgbW9kZWxWYWx1ZSApOwoJCX0KCgkJaWYgKCFpc1ByaW1pdGl2ZSggbW9kZWxWYWx1ZSApKSB7CgoJCQlmb3IgKGluZGV4UGF0aCBpbiBtb2RlbFZhbHVlKSB7CgoJCQkJLy9kbyBub3QgcmVtb3ZlIHRoZSBoYXNPd25Qcm9wZXJ0eSBjaGVjayEhCgkJCQkvL2lmIChoYXNPd24uY2FsbCggbW9kZWxWYWx1ZSwgaW5kZXggKSkgewoJCQkJcHJvY2Vzc05ld05vZGUoIG1vZGVsUGF0aCwgaW5kZXhQYXRoLCBtb2RlbFZhbHVlW2luZGV4UGF0aF0gKTsKCQkJCXRyYXZlcnNlTW9kZWwoIG1vZGVsUGF0aCArICIuIiArIGluZGV4UGF0aCwgbW9kZWxWYWx1ZVtpbmRleFBhdGhdLCBmYWxzZSApOwoJCQkJLy99CgkJCX0KCQl9Cgl9CgoJZnVuY3Rpb24gd2F0Y2goIHdhdGNoaW5nUGF0aCwgd2F0Y2hlZFBhdGggKSB7CgkJd2F0Y2hlZFBhdGggPSB0b1BoeXNpY2FsUGF0aCggd2F0Y2hlZFBhdGggKTsKCQl2YXIgcmVmZXJlbmNpbmdQYXRocyA9IHdhdGNoVGFibGVbd2F0Y2hlZFBhdGhdOwoJCWlmICghcmVmZXJlbmNpbmdQYXRocykgewoJCQl3YXRjaFRhYmxlW3dhdGNoZWRQYXRoXSA9IHJlZmVyZW5jaW5nUGF0aHMgPSBbXTsKCQl9CgkJcmVmZXJlbmNpbmdQYXRocy5wdXNoVW5pcXVlKCB3YXRjaGluZ1BhdGggKTsKCX0KCglmdW5jdGlvbiB1bndhdGNoKCB3YXRjaGluZ1BhdGgsIHdhdGNoZWRQYXRoICkgewoJCXdhdGNoZWRQYXRoID0gdG9QaHlzaWNhbFBhdGgoIHdhdGNoZWRQYXRoICk7CgkJdmFyIHdhdGNoaW5nUGF0aHMgPSB3YXRjaFRhYmxlW3dhdGNoZWRQYXRoXTsKCQl3YXRjaGluZ1BhdGhzLnJlbW92ZSggd2F0Y2hpbmdQYXRoICk7CgkJaWYgKCF3YXRjaGluZ1BhdGhzLmxlbmd0aCkgewoJCQlkZWxldGUgd2F0Y2hUYWJsZVt3YXRjaGVkUGF0aF07CgkJfQoJfQoKCWZ1bmN0aW9uIGV4dHJhY3RXYXRjaGVkUGF0aHMoIGZ1bmN0aW9uQm9keSApIHsKCQl2YXIgbWVtYmVyTWF0Y2gsCgkJCXJ0biA9IFtdOwoKCQl3aGlsZSAoKG1lbWJlck1hdGNoID0gcldhdGNoZWRQYXRoLmV4ZWMoIGZ1bmN0aW9uQm9keSApICkpIHsKCQkJcnRuLnB1c2hVbmlxdWUoIG1lbWJlck1hdGNoWzJdICk7CgkJfQoJCXJldHVybiBydG47Cgl9CgoJZnVuY3Rpb24gY29udGV4dE9mUGF0aCggcGF0aCApIHsKCQl2YXIgbWF0Y2ggPSByUGFyZW50S2V5LmV4ZWMoIHBhdGggKTsKCQlyZXR1cm4gbWF0Y2ggJiYgbWF0Y2hbMV0gfHwgIiI7Cgl9CgoJZnVuY3Rpb24gaW5kZXhPZlBhdGgoIHBhdGggKSB7CgkJdmFyIG1hdGNoID0gckluZGV4LmV4ZWMoIHBhdGggKTsKCQlyZXR1cm4gbWF0Y2hbMV0gfHwgbWF0Y2hbMF07Cgl9CgoJdmFyIGR1bW15ID0ge307CgoJdmFyIENsYXNzID0gZnVuY3Rpb24gXyggc2VlZCApIHsKCQl2YXIgdGVtcDsKCgkJaWYgKCEodGhpcyBpbnN0YW5jZW9mIF8pKSB7CgkJCXRlbXAgPSBuZXcgXyggZHVtbXkgKTsKCQkJcmV0dXJuIF8uYXBwbHkoIHRlbXAsIGFyZ3VtZW50cyApOwoJCX0KCgkJaWYgKGFyZ3VtZW50c1swXSA9PT0gZHVtbXkpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQl0aGlzLmluaXRpYWxpemUuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwoJCXJldHVybiB0aGlzOwoJfTsKCgl2YXIgc3VwZXJQcm90b3R5cGU7CglleHRlbmQoIENsYXNzLnByb3RvdHlwZSwgewoKCQljYWxsUHJvdG86IGZ1bmN0aW9uKCBtZXRob2ROYW1lICkgewoJCQl2YXIgbWV0aG9kID0gdGhpcy5jb25zdHJ1Y3Rvci5wcm90b3R5cGVbbWV0aG9kTmFtZV07CgkJCXJldHVybiBtZXRob2QuYXBwbHkoIHRoaXMsIHNsaWNlLmNhbGwoIGFyZ3VtZW50cywgMSApICk7CgkJfSwKCgkJLy9pbnN0YW5jZS5jYWxsQmFzZSgibWV0aG9kMSIsIHAxLCBwMiwuLi4pOwoJCWNhbGxCYXNlOiBmdW5jdGlvbiggbWV0aG9kTmFtZSApIHsKCQkJLy9zdXBlclByb3RvdHlwZSBpcyBnbG9iYWwgb2JqZWN0LCB3ZSB1c2UgdGhpcwoJCQkvLyBiZWNhdXNlIGFzc3VtZSBqcyBpbiBicm93c2VyIGlzIGEgc2luZ2xlIHRocmVhZGVkCgoJCQkvL3N0YXJ0aW5nIGZyb20gInRoaXMiIGluc3RhbmNlCgkJCXN1cGVyUHJvdG90eXBlID0gc3VwZXJQcm90b3R5cGUgfHwgdGhpczsKCQkJc3VwZXJQcm90b3R5cGUgPSBzdXBlclByb3RvdHlwZS5jb25zdHJ1Y3Rvci5fX3N1cGVyX187CgoJCQlpZiAoIXN1cGVyUHJvdG90eXBlKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCXZhciBtZXRob2QgPSBzdXBlclByb3RvdHlwZVttZXRob2ROYW1lXTsKCQkJdmFyIHJ0biA9IG1ldGhvZC5hcHBseSggdGhpcywgc2xpY2UuY2FsbCggYXJndW1lbnRzLCAxICkgKTsKCgkJCS8vd2hlbiBpdCBkb25lLCBzZXQgaXQgYmFjayB0byBudWxsCgkJCXN1cGVyUHJvdG90eXBlID0gbnVsbDsKCQkJcmV0dXJuIHJ0bjsKCQl9LAoKCQkvKiB0aGUgc3ViVHlwZSdzIGluaXRpYWxpemUgc2hvdWxkIGJlIGxpa2UKCQkgKgoJCSBpbml0aWFsaXplOiBmdW5jdGlvbiggc2VlZCApIHsKCQkgLy9kbyB0aGluZ3MKCQkgdGhpcy5jYWxsQmFzZSggImluaXRpYWxpemUiLCBzZWVkICk7CgkJIH0sCgkJICovCgkJLy90aGUgZGVmYXVsdCBpbml0aWFsaXplIGlzIHRvIGV4dGVuZCB0aGUgaW5zdGFuY2Ugd2l0aCBzZWVkIGRhdGEKCQlpbml0aWFsaXplOiBmdW5jdGlvbiggc2VlZCApIHsKCQkJZXh0ZW5kKCB0aGlzLCBzZWVkICk7CgkJfSwKCgkJLy90aGlzIGZ1bmN0aW9uIHdpbGwgYmUgY2FsbGVkIHdoZW4gSlNPTi5zdHJpbmdpZnkoKSBpcyBjYWxsZWQKCQl0b0pTT046IGZ1bmN0aW9uKCkgewoJCQl2YXIgcnRuID0gZXh0ZW5kKCB0cnVlLCB7fSwgdGhpcyApOwoKCQkJZm9yICh2YXIga2V5IGluIHJ0bikgewoJCQkJaWYgKGtleS5zdGFydHNXaXRoKCAiX18iICkpIHsKCQkJCQlkZWxldGUgcnRuW2tleV07CgkJCQl9CgkJCX0KCQkJcmV0dXJuIHJ0bjsKCQl9CgoJfSApOwoKCWV4dGVuZCggQ2xhc3MsIHsKCgkJLy9jcmVhdGUgYW4gYXJyYXkgb2YgaXRlbXMgb2YgdGhlIHNhbWUgdHlwZQoJCS8vaWYgWW91IGhhdmUgYSBzdWJUeXBlIGNhbGxlZCBQZXJzb24KCQkvL3lvdSBjYW4gUGVyc29uLmxpc3QoWyBzZWVkMSwgc2VlZDIgXSk7CgkJLy90byBjcmVhdGUgYW4gYXJyYXkgb2YgdHlwZWQgaXRlbXMKCQlsaXN0OiBmdW5jdGlvbiggc2VlZHMgKSB7CgoJCQl2YXIgaSwKCQkJCXNlZWQsCgkJCQlydG4gPSBbXSwKCQkJCWl0ZW1Jc09iamVjdDsKCgkJCWlmIChpc1VuZGVmaW5lZCggc2VlZHMgKSkgewoKCQkJCXJldHVybiBydG47CgoJCQl9IGVsc2UgewoKCQkJCWlmICghaXNBcnJheSggc2VlZHMgKSkgewoKCQkJCQlzZWVkcyA9IHNsaWNlLmNhbGwoIGFyZ3VtZW50cyApOwoKCQkJCX0KCgkJCQlpdGVtSXNPYmplY3QgPSBzZWVkcy5pdGVtSXNPYmplY3Q7CgoJCQkJZm9yIChpID0gMDsgaSA8IHNlZWRzLmxlbmd0aDsgaSsrKSB7CgkJCQkJc2VlZCA9IHNlZWRzW2ldOwoKCQkJCQlydG4ucHVzaCgKCQkJCQkJaXRlbUlzT2JqZWN0IHx8ICFpc0FycmF5KCBzZWVkICkgPwoJCQkJCQkJc2VlZHMgaW5zdGFuY2VvZiB0aGlzID8gdGhpcyA6IG5ldyB0aGlzKCBzZWVkICkgOgoJCQkJCQkJdGhpcy5hcHBseSggbnVsbCwgc2VlZCApCgkJCQkJKTsKCQkJCX0KCgkJCX0KCgkJCXJldHVybiBydG47CgkJfSwKCgkJLy90byBjcmVhdGUgYSBuZXcgVHlwZSBjYWxsCgoJCWV4dGVuZDogZnVuY3Rpb24oIGluc3RhbmNlTWVtYmVycywgc3RhdGljTWVtYmVycyApIHsKCQkJdmFyIENoaWxkLAoJCQkJUGFyZW50ID0gdGhpczsKCgkJCS8vIFRoZSBjb25zdHJ1Y3RvciBmdW5jdGlvbiBmb3IgdGhlIG5ldyBzdWJjbGFzcyBpcyBlaXRoZXIgZGVmaW5lZCBieSB5b3UKCQkJLy8gKHRoZSAiY29uc3RydWN0b3IiIHByb3BlcnR5IGluIHlvdXIgYGV4dGVuZGAgZGVmaW5pdGlvbiksIG9yIGRlZmF1bHRlZAoJCQkvLyBieSB1cyB0byBzaW1wbHkgY2FsbCB0aGUgcGFyZW50J3MgY29uc3RydWN0b3IuCgkJCWlmIChpbnN0YW5jZU1lbWJlcnMgJiYgaW5zdGFuY2VNZW1iZXJzLmhhc093blByb3BlcnR5KCAiY29uc3RydWN0b3IiICkpIHsKCQkJCUNoaWxkID0gaW5zdGFuY2VNZW1iZXJzLmNvbnN0cnVjdG9yOwoJCQl9IGVsc2UgewoJCQkJQ2hpbGQgPSBmdW5jdGlvbiBfKCkgewoJCQkJCXZhciB0ZW1wOwoKCQkJCQlpZiAoISh0aGlzIGluc3RhbmNlb2YgXykpIHsKCQkJCQkJdGVtcCA9IG5ldyBfKCBkdW1teSApOwoJCQkJCQlyZXR1cm4gXy5hcHBseSggdGVtcCwgYXJndW1lbnRzICk7CgkJCQkJfQoKCQkJCQlpZiAoYXJndW1lbnRzWzBdID09PSBkdW1teSkgewoJCQkJCQlyZXR1cm4gdGhpczsKCQkJCQl9CgkJCQkJLy90aGlzIGlzIHNpbWlsYXIgbGlrZSA6IGJhc2UoYXJndW1lbnRzKQoJCQkJCVBhcmVudC5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgkJCQkJcmV0dXJuIHRoaXM7CgkJCQl9OwoJCQl9CgoJCQkvLyBBZGQgc3RhdGljIHByb3BlcnRpZXMgdG8gdGhlIGNvbnN0cnVjdG9yIGZ1bmN0aW9uLCBpZiBzdXBwbGllZC4KCQkJZXh0ZW5kKCBDaGlsZCwgUGFyZW50LCBzdGF0aWNNZW1iZXJzICk7CgoJCQkvLyBTZXQgdGhlIHByb3RvdHlwZSBjaGFpbiB0byBpbmhlcml0IGZyb20gYHBhcmVudGAsIHdpdGhvdXQgY2FsbGluZwoJCQkvLyBgcGFyZW50YCdzIGNvbnN0cnVjdG9yIGZ1bmN0aW9uLgoJCQl2YXIgU3Vycm9nYXRlID0gZnVuY3Rpb24oKSB7IHRoaXMuY29uc3RydWN0b3IgPSBDaGlsZDsgfTsKCQkJU3Vycm9nYXRlLnByb3RvdHlwZSA9IFBhcmVudC5wcm90b3R5cGU7CgkJCUNoaWxkLnByb3RvdHlwZSA9IG5ldyBTdXJyb2dhdGUoKTsKCgkJCS8vIEFkZCBwcm90b3R5cGUgcHJvcGVydGllcyAoaW5zdGFuY2UgcHJvcGVydGllcykgdG8gdGhlIHN1YmNsYXNzLAoJCQkvLyBpZiBzdXBwbGllZC4KCQkJaWYgKGluc3RhbmNlTWVtYmVycykgewoJCQkJZXh0ZW5kKCBDaGlsZC5wcm90b3R5cGUsIGluc3RhbmNlTWVtYmVycyApOwoJCQl9CgoJCQkvLyBTZXQgYSBjb252ZW5pZW5jZSBwcm9wZXJ0eSBpbiBjYXNlIHRoZSBwYXJlbnQncyBwcm90b3R5cGUgaXMgbmVlZGVkCgkJCS8vIGxhdGVyLgoJCQlDaGlsZC5fX3N1cGVyX18gPSBQYXJlbnQucHJvdG90eXBlOwoKCQkJcmV0dXJuIENoaWxkOwoJCX0KCgl9ICk7CgoJLy9oZWxwZXJzCglleHRlbmQoIGhtLCB7CgoJCUNsYXNzOiBDbGFzcywKCgkJdXRpbDogdXRpbCA9IHsKCgkJCS8vdXNlciBkbyBub3QgbmVlZCB0byB1c2UgY3JlYXRlU2hhZG93SWZOZWNlc3NhcnkgcGFyYW1ldGVyCgkJCS8vaXQgaXMgZm9yIGludGVybmFsIHVzZQoJCQkvL2l0IGlzIG9ubHkgdXNlZCBpbiB0d28gcGxhY2VzLiBJdCBpcywgd2hlbiBhIG1vZGVsIGlzIGNyZWF0ZWQKCQkJLy8gYW5kIHdoZW4gYWNjZXNzb3IgaXMgYnVpbGQsCgkJCS8vIGV2ZW4gaW4gdGhlc2UgdHdvIGNhc2Ugd2hlbiB0aGUgcGFyYW1ldGVyIGlzIHRydWUsCgkJCS8vIHNoYWRvdyBpcyBub3QgbmVjZXNzYXJ5IGNyZWF0ZWQKCQkJLy8gaXQgaXMgb25seSBjcmVhdGVkIHdoZW4KCQkJLy8gdGhlIHRoZSBwaHlzaWNhbCBwYXRoIGlzIHBvaW50aW5nIHRvIGEgc2hhZG93CgkJCS8vIGFuZCB0aGUgbWFpbiBtb2RlbCBoYXMgYmVlbiBjcmVhdGVkCgkJCS8vIGFuZCB0aGUgc2hhZG93J3MgcGFyZW50IGlzIGFuIG9iamVjdAoJCQl0b1BoeXNpY2FsUGF0aDogdG9QaHlzaWNhbFBhdGggPSBmdW5jdGlvbiggbG9naWNhbFBhdGgsIGNyZWF0ZVNoYWRvd0lmTmVjZXNzYXJ5IC8qIGludGVybmFsIHVzZSovICkgewoKCQkJCXZhciBtYXRjaCwgcnRuID0gIiIsIGxlZnRDb250ZXh0ID0gIiIsIG1haW5WYWx1ZSwgc2hhZG93S2V5LCBtYWluUGF0aDsKCgkJCQl3aGlsZSAoKG1hdGNoID0gckRvdFN0YXIuZXhlYyggbG9naWNhbFBhdGggKSkpIHsKCQkJCQkvL3Jlc2V0IGxvZ2ljYWwgUGF0aCB0byB0aGUgcmVtYWluaW5nIG9mIHRoZSBzZWFyY2ggdGV4dAoJCQkJCWxvZ2ljYWxQYXRoID0gUmVnRXhwLnJpZ2h0Q29udGV4dDsKCQkJCQlsZWZ0Q29udGV4dCA9IFJlZ0V4cC5sZWZ0Q29udGV4dDsKCgkJCQkJaWYgKG1hdGNoWzBdID09ICIuIikgewoKCQkJCQkJaWYgKHJ0bikgewoJCQkJCQkJLy9tYWluUGF0aCA9IHJ0biArICIuIiArIGxlZnRDb250ZXh0CgkJCQkJCQlpZiAocnRuID09IHNoYWRvd05hbWVzcGFjZSAmJiBjcmVhdGVTaGFkb3dJZk5lY2Vzc2FyeSAmJiAhc2hhZG93Um9vdFtsZWZ0Q29udGV4dF0pIHsKCQkJCQkJCQltYWluUGF0aCA9IGNvbnZlcnRTaGFkb3dLZXlUb01haW5QYXRoKCBsZWZ0Q29udGV4dCApOwoJCQkJCQkJCWlmICghaXNVbmRlZmluZWQoIHJvb3ROb2RlLmdldCggbWFpblBhdGggKSApKSB7CgkJCQkJCQkJCXNoYWRvd1Jvb3RbbGVmdENvbnRleHRdID0ge307CgkJCQkJCQkJfQoJCQkJCQkJCS8vIWlzVW5kZWZpbmVkKCByb290Tm9kZS5nZXQoIG1haW5QYXRoICkgKQoJCQkJCQkJCS8qCWlmIChjcmVhdGVTaGFkb3dJZk5lY2Vzc2FyeSAmJgoJCQkJCQkJCSAhc2hhZG93Um9vdFtzaGFkb3dLZXldICYmCgkJCQkJCQkJIHJ0biAhPSBzaGFkb3dOYW1lc3BhY2UgJiYKCQkJCQkJCQkgIWlzVW5kZWZpbmVkKCBtYWluVmFsdWUgPSByb290Tm9kZS5nZXQoIG1haW5QYXRoICkgKSkgewoJCQkJCQkJCSAqLwoJCQkJCQkJfQoJCQkJCQkJcnRuID0gcnRuICsgIi4iICsgbGVmdENvbnRleHQ7CgkJCQkJCQkvL3NoYWRvd1Jvb3Rbc2hhZG93S2V5XQoJCQkJCQkJLy9pZiAocnRuID09KQoJCQkJCQl9IGVsc2UgewoJCQkJCQkJcnRuID0gbGVmdENvbnRleHQ7CgkJCQkJCX0KCgkJCQkJfSBlbHNlIHsKCgkJCQkJCS8vaWYgbWF0Y2ggaXMgIioiLCB0aGVuIGl0IGlzIHNoYWRvdwoJCQkJCQkvL2lmIHJ0biBpcyBub3QgZW1wdHkgc28gZmFyCgkJCQkJCWlmIChydG4pIHsKCQkJCQkJCS8vc2hhZG93S2V5IHdpbGwgYmUKCQkJCQkJCS8vY29udmVydE1haW5QYXRoVG9TaGFkb3dLZXkKCQkJCQkJCXNoYWRvd0tleSA9ICggcnRuID8gcnRuLnJlcGxhY2UoIHJIYXNoT3JEb3QsIGV4cGFuZFRvSGFzaGVzICkgOiBydG4pICsgIiMiICsgbGVmdENvbnRleHQ7CgkJCQkJCQltYWluUGF0aCA9IHJ0biArICIuIiArIGxlZnRDb250ZXh0OwoJCQkJCQl9IGVsc2UgewoJCQkJCQkJaWYgKGxlZnRDb250ZXh0KSB7CgkJCQkJCQkJc2hhZG93S2V5ID0gbGVmdENvbnRleHQ7CgkJCQkJCQkJbWFpblBhdGggPSBsZWZ0Q29udGV4dDsKCgkJCQkJCQl9IGVsc2UgewoKCQkJCQkJCQlzaGFkb3dLZXkgPSAiIjsKCQkJCQkJCQltYWluUGF0aCA9ICIiOwoJCQkJCQkJfQoJCQkJCQl9CgoJCQkJCQlydG4gPSBzaGFkb3dOYW1lc3BhY2UgKyAoc2hhZG93S2V5ID8gIi4iICsgc2hhZG93S2V5IDogIiIpOwoKCQkJCQkJLy9vbmx5IHdoZW4gbWFpbiBtb2RlbCBleGlzdHMgLCBhbmQgaG9zdCBvZiB0aGUgb2JqZWN0IGV4aXN0cwoJCQkJCQkvL3RoZW4gY3JlYXRlIHNoYWRvdwoJCQkJCQlpZiAoY3JlYXRlU2hhZG93SWZOZWNlc3NhcnkgJiYgIXNoYWRvd1Jvb3Rbc2hhZG93S2V5XSAmJgoJCQkJCQkgICAgcnRuICE9IHNoYWRvd05hbWVzcGFjZSAmJiAhaXNVbmRlZmluZWQoIG1haW5WYWx1ZSA9IHJvb3ROb2RlLmdldCggbWFpblBhdGggKSApKSB7CgoJCQkJCQkJc2hhZG93Um9vdFtzaGFkb3dLZXldID0ge307CgkJCQkJCX0KCQkJCQl9CgkJCQl9CgoJCQkJcmV0dXJuICFsb2dpY2FsUGF0aCA/IHJ0biA6CgkJCQkJcnRuID8gcnRuICsgIi4iICsgbG9naWNhbFBhdGggOgoJCQkJCQlsb2dpY2FsUGF0aDsKCQkJfSwKCQkJdG9Mb2dpY2FsUGF0aDogdG9Mb2dpY2FsUGF0aCA9IGZ1bmN0aW9uKCBwaHlzaWNhbFBhdGggKSB7CgoJCQkJdmFyIGluZGV4LCBsb2dpY2FsUGF0aCwgbWFpblBhdGgsIG1hdGNoOwoKCQkJCWlmIChwaHlzaWNhbFBhdGggPT09IHNoYWRvd05hbWVzcGFjZSkgewoJCQkJCXJldHVybiAiKiI7CgkJCQl9CgoJCQkJbWF0Y2ggPSByU2hhZG93S2V5LmV4ZWMoIHBoeXNpY2FsUGF0aCApOwoJCQkJaWYgKG1hdGNoKSB7CgkJCQkJLy8gaWYgcGh5c2ljYWwgcGF0aCBpcyBsaWtlIF9faG0ua2V5LngKCQkJCQkvLyBjb252ZXJ0IHRoZSBrZXkgcGF0aCBpbnRvIG1haW5QYXRoCgkJCQkJaW5kZXggPSBSZWdFeHAucmlnaHRDb250ZXh0OwoJCQkJCW1haW5QYXRoID0gY29udmVydFNoYWRvd0tleVRvTWFpblBhdGgoIG1hdGNoWzFdICk7CgkJCQkJbG9naWNhbFBhdGggPSBtYWluUGF0aCArICIqIiArIGluZGV4OwoJCQkJCXJldHVybiB0b0xvZ2ljYWxQYXRoKCBsb2dpY2FsUGF0aCApOwoKCQkJCX0gZWxzZSB7CgoJCQkJCXJldHVybiBwaHlzaWNhbFBhdGg7CgkJCQl9CgoJCQl9LAoKCQkJLypqb2luIHRoZSBjb250ZXh0IGFuZCBzdWJQYXRoIHRvZ2V0aGVyLCBpZiBwYXRoIGlzIG5vdCBuZWNlc3NhcnkgdGhlIHNhbWUgYXMgbG9naWNhbCBwYXRoCgkJCSAqY29udmVydFN1YlBhdGhUb1JlbGF0aXZlUGF0aCBieSBkZWZhdWx0IGlzIHRydWUsIHNvIHRoYXQgaWYgeW91IHNwZWNpZnkgc3ViUGF0aCBhcyAiYiIKCQkJICogYW5kICBjb250ZXh0IGlzICJhIiwgaXQgd2lsbCBiZSBtZXJnZWQgdG8gImEuYiIgLiBJZiBleHBsaWNpdGx5IHNwZWNpZnkKCQkJICogY29udmVydFN1YlBhdGhUb1JlbGF0aXZlUGF0aCB0byBmYWxzZSwgdGhleSB3aWxsIG5vdCBiZSBtZXJnZWQsIHNvIHRoZSAiYiIgd2lsbCBiZQoJCQkgKiByZXR1cm5lZCBhcyBtZXJnZSBwYXRoKi8KCQkJbWVyZ2VQYXRoOiBtZXJnZVBhdGggPSBmdW5jdGlvbiggY29udGV4dFBhdGgsIHN1YlBhdGgsIGNvbnZlcnRTdWJQYXRoVG9SZWxhdGl2ZVBhdGgKCQkJICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLyp1c2VkIGludGVybmFsbHkqLyApIHsKCQkJCWlmIChzdWJQYXRoID09ICJfIikgewoKCQkJCQlyZXR1cm4gIl8iOwoKCQkJCX0gZWxzZSBpZiAoY29udGV4dFBhdGggPT0gIl8iKSB7CgoJCQkJCWlmIChzdWJQYXRoICYmIHN1YlBhdGguc3RhcnRzV2l0aCggIi8iICkpIHsKCgkJCQkJCWNvbnRleHRQYXRoID0gIiI7CgoJCQkJCX0gZWxzZSB7CgoJCQkJCQlyZXR1cm4gIl8iOwoJCQkJCX0KCQkJCX0KCgkJCQljb250ZXh0UGF0aCA9IHRvUGh5c2ljYWxQYXRoKCBjb250ZXh0UGF0aCApOwoKCQkJCXZhciBtYXRjaDsKCQkJCWlmICghaXNVbmRlZmluZWQoIHN1YlBhdGggKSAmJiBzdWJQYXRoICE9PSBudWxsKSB7CgkJCQkJc3ViUGF0aCA9IHN1YlBhdGggKyAiIjsKCQkJCQlpZiAoc3ViUGF0aC5zdGFydHNXaXRoKCAiLyIgKSkgewoJCQkJCQlyZXR1cm4gc3ViUGF0aC5zdWJzdHIoIDEgKTsKCQkJCQl9CgkJCQl9CgkJCQlpZiAoaXNVbmRlZmluZWQoIGNvbnZlcnRTdWJQYXRoVG9SZWxhdGl2ZVBhdGggKSkgewoJCQkJCWNvbnZlcnRTdWJQYXRoVG9SZWxhdGl2ZVBhdGggPSB0cnVlOwoJCQkJfQoKCQkJCWlmIChjb252ZXJ0U3ViUGF0aFRvUmVsYXRpdmVQYXRoICYmIHN1YlBhdGggJiYgY29udGV4dFBhdGggJiYgIXJCZWdpbkRvdE9yU3Rhci50ZXN0KCBzdWJQYXRoICkpIHsKCQkJCQlzdWJQYXRoID0gIi4iICsgc3ViUGF0aDsKCQkJCX0KCgkJCQlpZiAoIXN1YlBhdGggfHwgc3ViUGF0aCA9PSAiLiIpIHsKCgkJCQkJcmV0dXJuIGNvbnRleHRQYXRoOwoKCQkJCX0gZWxzZSBpZiAoIXJCZWdpbkRvdE9yU3Rhci50ZXN0KCBzdWJQYXRoICkpIHsKCgkJCQkJcmV0dXJuIHN1YlBhdGg7CgoJCQkJfSBlbHNlIGlmICgobWF0Y2ggPSByVXNlUGFyc2VDb250ZXh0QXNDb250ZXh0LmV4ZWMoIHN1YlBhdGggKSkpIHsKCQkJCQkvL2lmIHN1YlBhdGggaXMgbGlrZSAuLnh5eiBvciAuKnh5egoJCQkJCXZhciBzdGVwc1RvR29VcCA9IDEgKyAobWF0Y2hbMV0gPyBtYXRjaFsxXS5sZW5ndGggOiAwKSwKCQkJCQkJcmVtYWluaW5nID0gUmVnRXhwLnJpZ2h0Q29udGV4dCwKCQkJCQkJbWVyZ2VkQ29udGV4dCA9IGNvbnRleHRQYXRoOwoKCQkJCQl3aGlsZSAoc3RlcHNUb0dvVXApIHsKCQkJCQkJbWVyZ2VkQ29udGV4dCA9IGNvbnRleHRPZlBhdGgoIG1lcmdlZENvbnRleHQgKTsKCQkJCQkJc3RlcHNUb0dvVXAtLTsKCQkJCQl9CgoJCQkJCS8vdXNlIHJ1bGUncyBjb250ZXh0IGFzIGNvbnRleHQKCQkJCQkvLy4uIG9yIC4qCgkJCQkJLy8kMiBpcyBlaXRoZXIgIi4iIG9yICIqIgoJCQkJCXJldHVybiByZW1haW5pbmcgPwoJCQkJCQkobWVyZ2VkQ29udGV4dCA/IG1lcmdlZENvbnRleHQgKyBtYXRjaFsyXSArIHJlbWFpbmluZyA6IHJlbWFpbmluZykgOgoJCQkJCQkobWF0Y2hbMl0gPT09ICIqIiA/IG1lcmdlZENvbnRleHQgKyAiKiIgOiBtZXJnZWRDb250ZXh0KTsKCgkJCQkJLy9pZiBzdWJQYXRoIGlzIGxpa2UgLmFiIG9yICphYgoJCQkJfSBlbHNlIGlmICgobWF0Y2ggPSByTWFpblBhdGguZXhlYyggc3ViUGF0aCApKSkgewoKCQkJCQlyZXR1cm4gbWVyZ2VQYXRoKCBnZXRNYWluUGF0aCggY29udGV4dFBhdGggKSwgbWF0Y2hbMV0gKTsKCgkJCQl9CgkJCQlyZXR1cm4gY29udGV4dFBhdGggKyBzdWJQYXRoOwoJCQl9LAoKCQkJaXNVbmRlZmluZWQ6IGlzVW5kZWZpbmVkID0gZnVuY3Rpb24oIG9iaiApIHsKCQkJCXJldHVybiAob2JqID09PSB1bmRlZmluZWQpOwoJCQl9LAoJCQlpc1ByaW1pdGl2ZTogaXNQcmltaXRpdmUgPSBmdW5jdGlvbiggb2JqICkgewoJCQkJcmV0dXJuIChvYmogPT09IG51bGwgKSB8fCAodHlwZW9mKG9iaikgaW4gcHJpbWl0aXZlVHlwZXMpOwoJCQl9LAoJCQlpc1N0cmluZzogaXNTdHJpbmcgPSBmdW5jdGlvbiggdmFsICkgewoJCQkJcmV0dXJuIHR5cGVvZiB2YWwgPT09ICJzdHJpbmciOwoJCQl9LAoJCQlpc09iamVjdDogaXNPYmplY3QgPSBmdW5jdGlvbiggdmFsICkgewoJCQkJcmV0dXJuICQudHlwZSggdmFsICkgPT09ICJvYmplY3QiOwoJCQl9LAoJCQlpc0Jvb2xlYW46IGlzQm9vbGVhbiA9IGZ1bmN0aW9uKCBvYmplY3QgKSB7CgkJCQlyZXR1cm4gdHlwZW9mIG9iamVjdCA9PT0gImJvb2xlYW4iOwoJCQl9LAoJCQl0b1R5cGVkVmFsdWU6IHRvVHlwZWRWYWx1ZSA9IGZ1bmN0aW9uKCBzdHJpbmdWYWx1ZSApIHsKCQkJCWlmIChpc1N0cmluZyggc3RyaW5nVmFsdWUgKSkgewoJCQkJCXN0cmluZ1ZhbHVlID0gJC50cmltKCBzdHJpbmdWYWx1ZSApOwoJCQkJCXRyeSB7CgkJCQkJCXN0cmluZ1ZhbHVlID0gc3RyaW5nVmFsdWUgPT09ICJ0cnVlIiA/IHRydWUgOgoJCQkJCQkJc3RyaW5nVmFsdWUgPT09ICJmYWxzZSIgPyBmYWxzZSA6CgkJCQkJCQkJc3RyaW5nVmFsdWUgPT09ICJudWxsIiA/IG51bGwgOgoJCQkJCQkJCQlzdHJpbmdWYWx1ZSA9PT0gInVuZGVmaW5lZCIgPyB1bmRlZmluZWQgOgoJCQkJCQkJCQkJaXNOdW1lcmljKCBzdHJpbmdWYWx1ZSApID8gcGFyc2VGbG9hdCggc3RyaW5nVmFsdWUgKSA6CgkJCQkJCQkJCQkJLy9EYXRlLnBhcnNlKCBzdHJpbmdWYWx1ZSApID8gbmV3IERhdGUoIHN0cmluZ1ZhbHVlICkgOgoJCQkJCQkJCQkJCXJKU09OLnRlc3QoIHN0cmluZ1ZhbHVlICkgPyAkLnBhcnNlSlNPTiggc3RyaW5nVmFsdWUgKSA6CgkJCQkJCQkJCQkJCXN0cmluZ1ZhbHVlOwoJCQkJCX0gY2F0Y2ggKGUpIHt9CgkJCQl9CgkJCQlyZXR1cm4gc3RyaW5nVmFsdWU7CgkJCX0sCgkJCWlzUHJvbWlzZTogaXNQcm9taXNlID0gZnVuY3Rpb24oIG9iamVjdCApIHsKCQkJCXJldHVybiAhIShvYmplY3QgJiYgb2JqZWN0LnByb21pc2UgJiYgb2JqZWN0LmRvbmUgJiYgb2JqZWN0LmZhaWwpOwoJCQl9LAoJCQljbGVhck9iajogY2xlYXJPYmogPSBmdW5jdGlvbiggb2JqICkgewoJCQkJaWYgKGlzUHJpbWl0aXZlKCBvYmogKSkgewoJCQkJCXJldHVybiBudWxsOwoJCQkJfQoJCQkJZm9yICh2YXIga2V5IGluIG9iaikgewoJCQkJCWlmIChoYXNPd24uY2FsbCggb2JqLCBrZXkgKSkgewoJCQkJCQlvYmpba2V5XSA9IGNsZWFyT2JqKCBvYmpba2V5XSApOwoJCQkJCX0KCQkJCX0KCQkJCXJldHVybiBvYmo7CgkJCX0sCgkJCWNsb25lOiBjbG9uZSA9IGZ1bmN0aW9uKCBvcmlnaW5hbCwgZGVlcENsb25lICkgewoJCQkJcmV0dXJuIGlzUHJpbWl0aXZlKCBvcmlnaW5hbCApID8gb3JpZ2luYWwgOgoJCQkJCWlzQXJyYXkoIG9yaWdpbmFsICkgPyBvcmlnaW5hbC5zbGljZSggMCApIDoKCQkJCQkJaXNGdW5jdGlvbiggb3JpZ2luYWwgKSA/IG9yaWdpbmFsIDoKCQkJCQkJCWV4dGVuZCggISFkZWVwQ2xvbmUsIHt9LCBvcmlnaW5hbCApOwoJCQl9LAoKCQkJbG9jYWw6IGZ1bmN0aW9uKCBrZXksIHZhbHVlICkgewoJCQkJaWYgKGFyZ3VtZW50cy5sZW5ndGggPT0gMSkgewoJCQkJCXJldHVybiBKU09OLnBhcnNlKCBsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgga2V5ICkgKTsKCQkJCX0gZWxzZSB7CgkJCQkJaWYgKGlzVW5kZWZpbmVkKCB2YWx1ZSApKSB7CgkJCQkJCWxvY2FsU3RvcmFnZS5yZW1vdmVJdGVtKCBrZXkgKTsKCQkJCQl9IGVsc2UgewoJCQkJCQlsb2NhbFN0b3JhZ2Uuc2V0SXRlbSgga2V5LCBKU09OLnN0cmluZ2lmeSggdmFsdWUgKSApOwoJCQkJCX0KCQkJCX0KCQkJfSwKCgkJCXRvU3RyaW5nOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJCQlyZXR1cm4gKHZhbHVlID09PSBudWxsIHx8IHZhbHVlID09PSB1bmRlZmluZWQpID8gIiIgOiAiIiArIHZhbHVlOwoJCQl9LAoKCQkJLy8jZGVidWcKCQkJX3JlZmVyZW5jZVRhYmxlOiB3YXRjaFRhYmxlLAoJCQkvLyNlbmRfZGVidWcKCgkJCWVuY29kZUh0bWw6IGZ1bmN0aW9uKCBzdHIgKSB7CgkJCQl2YXIgZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggJ2RpdicgKTsKCQkJCWRpdi5hcHBlbmRDaGlsZCggZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoIHN0ciApICk7CgkJCQlyZXR1cm4gZGl2LmlubmVySFRNTDsKCQkJfQoKCQl9LAoKCQkvL3RoaXMgaXMgdXNlZCB0byBwcm9jZXNzIHRoZSBuZXcgbm9kZSBhZGRlZCB0byByZXBvc2l0b3J5CgkJb25BZGRPclVwZGF0ZU5vZGU6IGZ1bmN0aW9uKCBmbiApIHsKCQkJaWYgKGZuKSB7CgkJCQlvbkFkZE9yVXBkYXRlSGFuZGxlcnMucHVzaCggZm4gKTsKCQkJCXJldHVybiB0aGlzOwoJCQl9IGVsc2UgewoJCQkJcmV0dXJuIG9uQWRkT3JVcGRhdGVIYW5kbGVyczsKCQkJfQoJCX0sCgoJCW9uRGVsZXRlTm9kZTogZnVuY3Rpb24oIGZuICkgewoJCQlpZiAoZm4pIHsKCQkJCW9uRGVsZXRlSGFuZGxlcnMucHVzaCggZm4gKTsKCQkJCXJldHVybiB0aGlzOwoJCQl9IGVsc2UgewoJCQkJcmV0dXJuIG9uRGVsZXRlSGFuZGxlcnM7CgkJCX0KCQl9LAoKCQkvL3VzZSB0aGlzIGZvciBjb25maWd1cmUgb3B0aW9ucwoJCW9wdGlvbnM6IGRlZmF1bHRPcHRpb25zCgl9ICk7CgoJdmFyIG9uRGVsZXRlSGFuZGxlcnMgPSBbCgkJZnVuY3Rpb24gLypyZW1vdmVNb2RlbExpbmtzQW5kU2hhZG93cyovICggcGh5c2ljYWxQYXRoLCByZW1vdmVkVmFsdWUgKSB7CgoJCQl2YXIgd2F0Y2hlZFBhdGgsCgkJCQltYWluUGF0aCwKCQkJCXBoeXNpY2FsUGF0aE9mU2hhZG93LAoJCQkJbG9naWNhbFNoYWRvd1BhdGgsCgkJCQlsb2dpY2FsUGF0aCA9IHRvTG9naWNhbFBhdGgoIHBoeXNpY2FsUGF0aCApOwoKCQkJLy9yZW1vdmUgbW9kZWxMaW5rcyB3aG9zZSBwdWJsaXNoZXJQYXRoID09IHBoeXNpY2FsUGF0aAoJCQlmb3IgKHdhdGNoZWRQYXRoIGluIHdhdGNoVGFibGUpIHsKCQkJCXVud2F0Y2goIHBoeXNpY2FsUGF0aCwgd2F0Y2hlZFBhdGggKTsKCQkJfQoKCQkJLy9yZW1vdmUgbW9kZWxMaW5rcyB3aG9zZSBzdWJzY3JpYmVyID09IHBoeXNpY2FsUGF0aAoJCQlmb3IgKHdhdGNoZWRQYXRoIGluIHdhdGNoVGFibGUpIHsKCQkJCWlmICh3YXRjaGVkUGF0aC5zdGFydHNXaXRoKCBwaHlzaWNhbFBhdGggKSkgewoJCQkJCWRlbGV0ZSB3YXRjaFRhYmxlW3dhdGNoZWRQYXRoXTsKCQkJCX0KCQkJfQoKCQkJLy9kZWxldGUgc2hhZG93IG9iamVjdHMsCgkJCS8vIHdoaWNoIGFyZSB1bmRlciB0aGUgZGlyZWN0IHNoYWRvdyBvZiBtYWluIHBhdGgKCQkJZm9yIChtYWluUGF0aCBpbiBzaGFkb3dSb290KSB7CgoJCQkJcGh5c2ljYWxQYXRoT2ZTaGFkb3cgPSBzaGFkb3dOYW1lc3BhY2UgKyAiLiIgKyBtYWluUGF0aDsKCQkJCWxvZ2ljYWxTaGFkb3dQYXRoID0gdG9Mb2dpY2FsUGF0aCggcGh5c2ljYWxQYXRoT2ZTaGFkb3cgKTsKCgkJCQlpZiAobG9naWNhbFNoYWRvd1BhdGggPT0gbG9naWNhbFBhdGggfHwKCQkJCSAgICBsb2dpY2FsU2hhZG93UGF0aC5zdGFydHNXaXRoKCBsb2dpY2FsUGF0aCArICIqIiApIHx8CgkJCQkgICAgbG9naWNhbFNoYWRvd1BhdGguc3RhcnRzV2l0aCggbG9naWNhbFBhdGggKyAiLiIgKSkgewoJCQkJCXJvb3ROb2RlLmRlbCggcGh5c2ljYWxQYXRoT2ZTaGFkb3cgKTsKCQkJCX0KCQkJfQoJCX0KCV07CgoJJCggImdldCxzZXQsZGVsLGV4dGVuZCIuc3BsaXQoICIsIiApICkuZWFjaCggZnVuY3Rpb24oIGluZGV4LCB2YWx1ZSApIHsKCQlobVt2YWx1ZV0gPSBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHJvb3ROb2RlW3ZhbHVlXS5hcHBseSggcm9vdE5vZGUsIHNsaWNlLmNhbGwoIGFyZ3VtZW50cyApICk7CgkJfTsKCX0gKTsKCglyb290Tm9kZSA9IGhtKCk7CgoJJGZuLmhtRGF0YSA9IGZ1bmN0aW9uKCBuYW1lLCB2YWx1ZSApIHsKCgkJdmFyIGRhdGEgPSB0aGlzLmRhdGEoICJobURhdGEiICk7CgoJCWlmIChhcmd1bWVudHMubGVuZ3RoID09PSAwKSB7CgoJCQlyZXR1cm4gZGF0YTsKCgkJfSBlbHNlIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAxKSB7CgoJCQlyZXR1cm4gZGF0YSAmJiBkYXRhW25hbWVdOwoKCQl9IGVsc2UgewoJCQkvL2FyZ3VtZW50cy5sZW5ndGggPT0gMgoJCQlpZiAoaXNVbmRlZmluZWQoIGRhdGEgKSkgewoJCQkJdGhpcy5kYXRhKCAiaG1EYXRhIiwgZGF0YSA9IHt9ICk7CgkJCX0KCQkJZGF0YVtuYW1lXSA9IHZhbHVlOwoJCX0KCX07CgoJLyoJcGF0aHNXYXRjaGluZzogZnVuY3Rpb24oKSB7CgkgdmFyIGtleSwgbGlua3MsIHJ0biA9IFtdLCBwYXRoID0gdGhpcy5wYXRoOwoJIGZvciAoa2V5IGluIG1vZGVsTGlua3MpIHsKCSBsaW5rcyA9IG1vZGVsTGlua3Nba2V5XTsKCSBpZiAobGlua3MuY29udGFpbnMoIHBhdGggKSkgewoJIHJ0bi5wdXNoKCBrZXkgKTsKCSB9CgkgfQoJIHJldHVybiBydG47CgkgfSwKCgkgLCovCgoJLy8jZGVidWcKCglobS5kZWJ1Zy53YXRjaGluZ1BhdGhzID0gZnVuY3Rpb24gbWUoIHdhdGNoZWRQYXRoLCBkZWVwICkgewoJCXZhciBydG4gPSB3YXRjaFRhYmxlW3dhdGNoZWRQYXRoXSB8fCBbXTsKCQlpZiAoZGVlcCkgewoJCQlmb3IgKHZhciBpID0gMDsgaSA8IHJ0bi5sZW5ndGg7IGkrKykgewoJCQkJcnRuLm1lcmdlKCBtZSggcnRuW2ldLCBkZWVwICkgKTsKCQkJfQoJCX0KCQlyZXR1cm4gcnRuOwoJfTsKCglobS5kZWJ1Zy53YXRjaGVkUGF0aHMgPSBmdW5jdGlvbiggd2F0Y2hpbmdQYXRoICkgewoJCXZhciBrZXksIGxpbmtzLCBydG4gPSBbXTsKCQlmb3IgKGtleSBpbiB3YXRjaFRhYmxlKSB7CgkJCWxpbmtzID0gd2F0Y2hUYWJsZVtrZXldOwoJCQlpZiAobGlua3MuY29udGFpbnMoIHdhdGNoaW5nUGF0aCApKSB7CgkJCQlydG4ucHVzaCgga2V5ICk7CgkJCX0KCQl9CgkJcmV0dXJuIHJ0bjsKCX07CgoJaG0uZGVidWcuc2hhZG93TmFtZXNwYWNlID0gc2hhZG93TmFtZXNwYWNlOwoJaG0uZGVidWcuZXh0cmFjdFdhdGNoZWRQYXRocyA9IGV4dHJhY3RXYXRjaGVkUGF0aHM7CglobS5kZWJ1Zy5yZW1vdmVBbGwgPSBmdW5jdGlvbigpIHsKCQlmb3IgKHZhciBrZXkgaW4gcmVwb3NpdG9yeSkgewoJCQlpZiAoa2V5ICE9PSBzaGFkb3dOYW1lc3BhY2UpIHsKCQkJCXJvb3ROb2RlLmRlbCgga2V5LCB0cnVlICk7CgkJCX0KCQl9Cgl9OwoJLy8jZW5kX2RlYnVnCgoKLy88QGRlcGVuZHM+bW9kZWwuanM8L0BkZXBlbmRzPgoKCgoJdmFyIHdvcmtmbG93U3RvcmUsCgkJclNwYWNlcyA9IC9bIF0rLywKCQlyRW5kV2l0aFN0YXJEb3QgPSAvXCpcLiQvLAoJCXJEb3RPclN0YXIgPSAvXC58XCovZywKCS8vck9yaWdpbmFsRXZlbnQgPSAvXiguKz8pKFwuXGQrKT8kLywKCQlzdWJzY3JpcHRpb25NYW5hZ2VyLAoJCXZpZXdJZCA9IDAsCgkJckluaXQgPSAvaW5pdChcZCopLywKCQl3b3JrZmxvdywKCS8vdGhlIGhhbmRsZXIgc3RyaW5nIHNob3VsZCBiZSBsaWtlCgkvLyAiZ2V0IHNldCBjb252ZXJ0IGZpbmFsaXplIGluaXRpYWxpemUiCgkJYWN0aXZpdHlUeXBlcyA9ICJnZXQsc2V0LGNvbnZlcnQsZmluYWxpemUsaW5pdGlhbGl6ZSIuc3BsaXQoICIsIiApOwoKCWZ1bmN0aW9uIHJldHVybkZhbHNlKCkgewoJCXJldHVybiBmYWxzZTsKCX0KCglmdW5jdGlvbiByZXR1cm5UcnVlKCkgewoJCXJldHVybiB0cnVlOwoJfQoKCWZ1bmN0aW9uIEV2ZW50KCBwdWJsaXNoZXIsIG9yaWdpbmFsUHVibGlzaGVyLCBldmVudFR5cGUsIHByb3Bvc2VkLCByZW1vdmVkICkgewoJCXRoaXMucHVibGlzaGVyID0gdHJ5V3JhcFB1Ymxpc2hlclN1YnNjcmliZXIoIHB1Ymxpc2hlciApOwoJCXRoaXMub3JpZ2luYWxQdWJsaXNoZXIgPSB0cnlXcmFwUHVibGlzaGVyU3Vic2NyaWJlciggb3JpZ2luYWxQdWJsaXNoZXIgKTsKCQl0aGlzLnR5cGUgPSBldmVudFR5cGU7CgkJdGhpcy5vcmlnaW5hbFR5cGUgPSBldmVudFR5cGU7CgkJdGhpcy5wcm9wb3NlZCA9IHByb3Bvc2VkOwoJCXRoaXMucmVtb3ZlZCA9IHJlbW92ZWQ7Cgl9CgoJRXZlbnQucHJvdG90eXBlID0gewoJCWNvbnN0cnVjdG9yOiBFdmVudCwKCgkJLyoJaXNPcmlnaW5hbDogZnVuY3Rpb24oKSB7CgkJIHJldHVybiB0aGlzLnB1Ymxpc2hlci5wYXRoID09IHRoaXMub3JpZ2luYWxQdWJsaXNoZXIucGF0aDsKCQkgfSwKCgkJIGlzQnViYmxlVXA6IGZ1bmN0aW9uKCkgewoJCSByZXR1cm4gKHRoaXMucHVibGlzaGVyLnBhdGggIT0gdGhpcy5vcmlnaW5hbFB1Ymxpc2hlci5wYXRoKSAmJgoJCSAodGhpcy5wdWJsaXNoZXIucGF0aC5zdGFydHNXaXRoKCB0aGlzLm9yaWdpbmFsUHVibGlzaGVyLnBhdGggKSk7CgkJIH0sKi8KCQlpc0RlcGVuZGVudDogZnVuY3Rpb24oKSB7CgkJCXJldHVybiAoIXRoaXMucHVibGlzaGVyLnBhdGguc3RhcnRzV2l0aCggdGhpcy5vcmlnaW5hbFB1Ymxpc2hlci5wYXRoICkpOwoJCX0sCgoJCXN0b3BQcm9wYWdhdGlvbjogZnVuY3Rpb24oKSB7CgkJCXRoaXMuaXNQcm9wYWdhdGlvblN0b3BwZWQgPSByZXR1cm5UcnVlOwoJCX0sCgoJCXN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbjogZnVuY3Rpb24oKSB7CgkJCXRoaXMuaXNJbW1lZGlhdGVQcm9wYWdhdGlvblN0b3BwZWQgPSByZXR1cm5UcnVlOwoJCQl0aGlzLmlzUHJvcGFnYXRpb25TdG9wcGVkID0gcmV0dXJuVHJ1ZTsKCQkJdGhpcy5pc0Nhc2NhZGVTdG9wcGVkID0gcmV0dXJuVHJ1ZTsKCQl9LAoKCQlzdG9wQ2FzY2FkZTogZnVuY3Rpb24oKSB7CgkJCXRoaXMuaXNDYXNjYWRlU3RvcHBlZCA9IHJldHVyblRydWU7CgkJfSwKCgkJZXJyb3I6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLmhhc0Vycm9yID0gcmV0dXJuVHJ1ZTsKCQl9LAoKCQlhYm9ydDogYWJvcnQsCgkJaXNDYXNjYWRlU3RvcHBlZDogcmV0dXJuRmFsc2UsCgkJaXNQcm9wYWdhdGlvblN0b3BwZWQ6IHJldHVybkZhbHNlLAoJCWlzSW1tZWRpYXRlUHJvcGFnYXRpb25TdG9wcGVkOiByZXR1cm5GYWxzZSwKCQlpc0Fib3J0ZWQ6IHJldHVybkZhbHNlLAoJCWhhc0Vycm9yOiByZXR1cm5GYWxzZSwKCQlsZXZlbDogMAoJfTsKCgkvLyByYWlzZSBtb2RlbCBldmVudCwKCXRyaWdnZXIgPSBmdW5jdGlvbiggcGF0aCwgb3JpZ2luYWxQYXRoLCBldmVudFR5cGUsIHByb3Bvc2VkLCByZW1vdmVkICkgewoKCQl2YXIgZSA9IG5ldyBFdmVudCggcGF0aCwgb3JpZ2luYWxQYXRoLCBldmVudFR5cGUsIHByb3Bvc2VkLCByZW1vdmVkICk7CgoJCS8vZXZlbnQgY2FuIGJlIGNoYW5nZWQgaW5zaWRlIHRoZSBmdW5jdGlvbgoJCWNhbGxiYWNrTW9kZWxTdWJzY3JpcHRpb25IYW5kbGVyKCBlICk7CgoJCWlmICghZS5pc1Byb3BhZ2F0aW9uU3RvcHBlZCgpICYmIGUucHVibGlzaGVyLnBhdGgpIHsKCgkJCWlmIChlLmlzRGVwZW5kZW50KCkpIHsKCQkJCS8vaWYgaXMgZGVwZW5kZW50IGV2ZW50LCB0aGUgb3JpZ2luYWwgZXZlbnQgaGFzIGJlZW4KCQkJCS8vIGJ1YmJsZWQgdXAgaW4gaXRzIGRpcmVjdCBoaWVyYXJjaHkKCQkJCS8vd2UgbmVlZCB0byBjaGFuZ2UgdGhlIGhpZXJhcmNoeSBieSBzZXR0aW5nIHRoZSB0YXJnZXQKCQkJCWUub3JpZ2luYWxQdWJsaXNoZXIucGF0aCA9IGUucHVibGlzaGVyLnBhdGg7CgkJCX0KCgkJCS8vY29udGludWUgdG8gdGhlIHNhbWUgaW5zdGFuY2Ugb2YgZXZlbnQgb2JqZWN0CgkJCWRvIHsKCgkJCQllLnB1Ymxpc2hlci5wYXRoID0gZS5wdWJsaXNoZXIucGF0aENvbnRleHQoKTsKCQkJCWUubGV2ZWwrKzsKCQkJCWUudHlwZSA9IGUub3JpZ2luYWxUeXBlICsgIi4iICsgZS5sZXZlbDsKCQkJCWNhbGxiYWNrTW9kZWxTdWJzY3JpcHRpb25IYW5kbGVyKCBlICk7CgoJCQl9IHdoaWxlICghZS5pc1Byb3BhZ2F0aW9uU3RvcHBlZCgpICYmIGUucHVibGlzaGVyLnBhdGgpOwoJCX0KCgkJLy9yZXN0b3JlIHByZXZpb3VzIHZhbHVlcwoJCWUudHlwZSA9IGV2ZW50VHlwZTsKCQllLm9yaWdpbmFsUHVibGlzaGVyLnBhdGggPSBvcmlnaW5hbFBhdGg7CgkJZS5wdWJsaXNoZXIucGF0aCA9IHBhdGg7CgkJcmV0dXJuIGU7Cgl9OwoKCglzdWJzY3JpcHRpb25NYW5hZ2VyID0gKGZ1bmN0aW9uKCkgewoKCQl2YXIgc3Vic2NyaXB0aW9uU3RvcmUgPSBbIF07CgoJCS8vdGFyZ2V0IGlzIGVpdGhlciBwdWJsaXNoZXIgb3Igc3Vic2NyaWJlcgoJCWZ1bmN0aW9uIGNhblJlbW92ZVN1YnNjcmlwdGlvbkRhdGEoIHRhcmdldCwgcHVibGlzaGVyLCBzdWJzY3JpYmVyICkgewoJCQlpZiAodGFyZ2V0ID09PSBwdWJsaXNoZXIgfHwgdGFyZ2V0ID09PSBzdWJzY3JpYmVyKSB7CgkJCQlyZXR1cm4gdHJ1ZTsKCQkJfSBlbHNlIHsKCQkJCS8vaWYgdGFyZ2V0IGlzIG1vZGVsIHBhdGgKCQkJCWlmIChpc1N0cmluZyggdGFyZ2V0ICkpIHsKCQkJCQlyZXR1cm4gKCBpc1N0cmluZyggcHVibGlzaGVyICkgJiYgcHVibGlzaGVyLnN0YXJ0c1dpdGgoIHRhcmdldCArICIuIiApKSB8fAoJCQkJCSAgICAgICAoIGlzU3RyaW5nKCBzdWJzY3JpYmVyICkgJiYgc3Vic2NyaWJlci5zdGFydHNXaXRoKCB0YXJnZXQgKyAiLiIgKSk7CgkJCQl9IGVsc2UgewoJCQkJCXJldHVybiBmYWxzZTsKCQkJCX0KCQkJfQoKCQl9CgoJCWZ1bmN0aW9uIGdldFN1YnNjcmlwdGlvbnNCeSggdGFyZ2V0LCBtYXRjaCApIHsKCQkJaWYgKGlzU3RyaW5nKCB0YXJnZXQgKSkgewoJCQkJdGFyZ2V0ID0gdG9QaHlzaWNhbFBhdGgoIHRhcmdldCApOwoJCQl9CgoJCQl2YXIgcnRuID0gW107CgkJCWZvciAodmFyIGkgPSAwLCBpdGVtOyBpIDwgc3Vic2NyaXB0aW9uU3RvcmUubGVuZ3RoOyBpKyspIHsKCQkJCWl0ZW0gPSBzdWJzY3JpcHRpb25TdG9yZVtpXTsKCQkJCWlmIChtYXRjaCggaXRlbSwgdGFyZ2V0ICkpIHsKCQkJCQlydG4ucHVzaCggaXRlbSApOwoJCQkJfQoJCQl9CgkJCXJldHVybiBydG47CgkJfQoKCQlyZXR1cm4gewoKCQkJLy9zdWJzY3JpcHRpb25zIHdob3NlIHB1Ymxpc2hlciBpcyB0aGUgcGFyYW1ldGVyCgkJCS8vcHVibGlzaGVyIGNhbiBiZSBhIG1vZGVsIHBhdGggb3IgZG9tIGVsZW1lbnQsIG9yIG9iamVjdAoJCQlnZXRCeVB1Ymxpc2hlcjogZnVuY3Rpb24oIHB1Ymxpc2hlciApIHsKCQkJCXJldHVybiBnZXRTdWJzY3JpcHRpb25zQnkoIHB1Ymxpc2hlciwgZnVuY3Rpb24oIGl0ZW0sIHRhcmdldCApIHsKCQkJCQlyZXR1cm4gaXRlbS5wdWJsaXNoZXIgPT0gdGFyZ2V0OwoJCQkJfSApOwoJCQl9LAoKCQkJLy9zdWJzY3JpcHRpb25zIHdob3NlIHN1YnNjcmliZXIgaXMgdGhlIHBhcmFtZXRlcgoJCQkvL3N1YnNjcmliZXIgY2FuIGJlIGEgbW9kZWwgcGF0aCBvciBkb20gZWxlbWVudCwgb3Igb2JqZWN0CgkJCWdldEJ5U3Vic2NyaWJlcjogZnVuY3Rpb24oIHN1YnNjcmliZXIgKSB7CgkJCQlyZXR1cm4gZ2V0U3Vic2NyaXB0aW9uc0J5KCBzdWJzY3JpYmVyLCBmdW5jdGlvbiggaXRlbSwgdGFyZ2V0ICkgewoJCQkJCXJldHVybiBpdGVtLnN1YnNjcmliZXIgPT0gdGFyZ2V0OwoJCQkJfSApOwoJCQl9LAoKCQkJLy9vYmplY3QgY2FuIGJlIGEgbW9kZWwgcGF0aCBvciBkb20gZWxlbWVudCwgb3Igb2JqZWN0CgkJCWdldEJ5OiBmdW5jdGlvbiggc3Vic2NyaWJlck9yUHVibGlzaGVyICkgewoJCQkJcmV0dXJuIGdldFN1YnNjcmlwdGlvbnNCeSggc3Vic2NyaWJlck9yUHVibGlzaGVyLCBmdW5jdGlvbiBtYXRjaCggaXRlbSwgdGFyZ2V0ICkgewoJCQkJCXJldHVybiBpdGVtLnN1YnNjcmliZXIgPT0gdGFyZ2V0IHx8IGl0ZW0ucHVibGlzaGVyID09IHRhcmdldDsKCQkJCX0gKTsKCQkJfSwKCgkJCWdldEFsbDogZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gc3Vic2NyaXB0aW9uU3RvcmU7CgkJCX0sCgoJCQlhZGQ6IGZ1bmN0aW9uKCBzdWJzY3JpYmVyLCBwdWJsaXNoZXIsIGV2ZW50VHlwZXMsIGhhbmRsZXIgKSB7CgkJCQlpZiAoaXNTdHJpbmcoIHB1Ymxpc2hlciApKSB7CgoJCQkJCXZhciBldmVudHMgPSBldmVudFR5cGVzLnNwbGl0KCByU3BhY2VzICk7CgkJCQkJZm9yICh2YXIgaSA9IDA7IGkgPCBldmVudHMubGVuZ3RoOyBpKyspIHsKCQkJCQkJdmFyIHNwZWNpYWwgPSB0aGlzLnNwZWNpYWxbZXZlbnRzW2ldXTsKCQkJCQkJc3BlY2lhbCAmJiBzcGVjaWFsLnNldHVwICYmIHNwZWNpYWwuc2V0dXAoIHN1YnNjcmliZXIsIHB1Ymxpc2hlciApOwoJCQkJCX0KCQkJCX0KCgkJCQlzdWJzY3JpcHRpb25TdG9yZS5wdXNoKCB7CgkJCQkJcHVibGlzaGVyOiBwdWJsaXNoZXIsCgkJCQkJc3Vic2NyaWJlcjogc3Vic2NyaWJlciwKCQkJCQlldmVudFR5cGVzOiBldmVudFR5cGVzLAoJCQkJCWhhbmRsZXI6IGhhbmRsZXIKCQkJCX0gKTsKCQkJfSwKCgkJCXJlbW92ZUJ5OiBmdW5jdGlvbiggc3Vic2NyaWJlck9yUHVibGlzaGVyICkgewoKCQkJCXZhciBpLAoJCQkJCWosCgkJCQkJc3BlY2lhbCwKCQkJCQlzdWJzY3JpcHRpb24sCgkJCQkJaGFuZGxlciwKCQkJCQlzdWJzY3JpcHRpb25zUmVtb3ZlZCA9IFtdOwoKCQkJCWZvciAoaSA9IHN1YnNjcmlwdGlvblN0b3JlLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CgkJCQkJc3Vic2NyaXB0aW9uID0gc3Vic2NyaXB0aW9uU3RvcmVbaV07CgkJCQkJaGFuZGxlciA9IHN1YnNjcmlwdGlvbi5oYW5kbGVyOwoKCQkJCQlpZiAoY2FuUmVtb3ZlU3Vic2NyaXB0aW9uRGF0YSggc3Vic2NyaWJlck9yUHVibGlzaGVyLCBzdWJzY3JpcHRpb24ucHVibGlzaGVyLCBzdWJzY3JpcHRpb24uc3Vic2NyaWJlciApKSB7CgoJCQkJCQkvL2lmIHB1Ymxpc2hlciBpcyBhbiB2aWV3IG9iamVjdCwgbmVlZCB0byB1bmJpbmQgb3IgdW5kZWxlZ2F0ZQoJCQkJCQkvL3RoZSBqUXVlcnkgZXZlbnQgaGFuZGxlcgoJCQkJCQlpZiAoIWlzU3RyaW5nKCBzdWJzY3JpcHRpb24ucHVibGlzaGVyICkpIHsKCQkJCQkJCWlmIChoYW5kbGVyLmRlbGVnYXRlU2VsZWN0b3IpIHsKCQkJCQkJCQkkKCBzdWJzY3JpcHRpb24ucHVibGlzaGVyICkudW5kZWxlZ2F0ZSggaGFuZGxlci5kZWxlZ2F0ZVNlbGVjdG9yLCBzdWJzY3JpcHRpb24uZXZlbnRUeXBlcywgdmlld0hhbmRsZXJHYXRld2F5ICk7CgoJCQkJCQkJfSBlbHNlIHsKCQkJCQkJCQkkKCBzdWJzY3JpcHRpb24ucHVibGlzaGVyICkudW5iaW5kKCBzdWJzY3JpcHRpb24uZXZlbnRUeXBlcywgdmlld0hhbmRsZXJHYXRld2F5ICk7CgkJCQkJCQl9CgkJCQkJCX0KCgkJCQkJCXN1YnNjcmlwdGlvbnNSZW1vdmVkLnB1c2goIHN1YnNjcmlwdGlvblN0b3JlLnNwbGljZSggaSwgMSApWzBdICk7CgkJCQkJfQoJCQkJfQoKCQkJCWZvciAoaSA9IHN1YnNjcmlwdGlvbnNSZW1vdmVkLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CgkJCQkJc3Vic2NyaXB0aW9uID0gc3Vic2NyaXB0aW9uc1JlbW92ZWRbaV07CgkJCQkJaWYgKGlzU3RyaW5nKCBzdWJzY3JpcHRpb24ucHVibGlzaGVyICkpIHsKCQkJCQkJdmFyIGV2ZW50cyA9IHN1YnNjcmlwdGlvbi5ldmVudFR5cGVzLnNwbGl0KCByU3BhY2VzICk7CgkJCQkJCWZvciAoaiA9IDA7IGogPCBldmVudHMubGVuZ3RoOyBqKyspIHsKCQkJCQkJCXNwZWNpYWwgPSB0aGlzLnNwZWNpYWxbZXZlbnRzW2pdXTsKCQkJCQkJCXNwZWNpYWwgJiYgc3BlY2lhbC50ZWFyZG93biAmJiBzcGVjaWFsLnRlYXJkb3duKCBzdWJzY3JpcHRpb24uc3Vic2NyaWJlciwgc3Vic2NyaXB0aW9uLnB1Ymxpc2hlciApOwoJCQkJCQl9CgkJCQkJfQoJCQkJfQoJCQl9LAoKCQkJc3BlY2lhbDogewoJCQkJLyp2YWxpZGl0eUNoYW5nZWQ6IHsKCQkJCSBzZXR1cDogZnVuY3Rpb24gKHB1Ymxpc2hlciwgc3Vic2NyaWJlcikge30sCgkJCQkgdGVhcmRvd246IGZ1bmN0aW9uIChwdWJsaXNoZXIsIHN1YnNjcmliZXIpIHt9CgkJCQkgfQoJCQkJICovCgkJCX0KCgkJfTsKCX0pKCk7CgoJZnVuY3Rpb24gZ2V0TWVtYmVyKCBlICkgewoKCQl2YXIgaGFuZGxlciA9IGUuaGFuZGxlciwKCQkJcHJvcGVydHlOYW1lID0gaGFuZGxlci5nZXROYW1lLAoJCS8vZ2V0U3ViUHJvcGVydHkgaXMgdXNlZCBmb3IgcHJvcGVydGllcyBsaWtlIGNzcywgYXR0ciwgcHJvcAoJCQlzdWJQcm9wZXJ0eU5hbWUgPSBoYW5kbGVyLmdldFBhcmFzLAoJCQlwdWJsaXNoZXIgPSBlLnB1Ymxpc2hlcjsKCgkJcmV0dXJuIHN1YlByb3BlcnR5TmFtZSA/IHB1Ymxpc2hlcltwcm9wZXJ0eU5hbWVdKCBzdWJQcm9wZXJ0eU5hbWUgKSA6CgkJCWlzRnVuY3Rpb24oIHB1Ymxpc2hlcltwcm9wZXJ0eU5hbWVdICkgPyBwdWJsaXNoZXJbcHJvcGVydHlOYW1lXSgpIDoKCQkJCXB1Ymxpc2hlcltwcm9wZXJ0eU5hbWVdOwoJfQoKCWZ1bmN0aW9uIHNldE1lbWJlciggdmFsdWUsIGUgKSB7CgkJdmFyIGhhbmRsZXIgPSBlLmhhbmRsZXIsCgkJCXByb3BlcnR5TmFtZSA9IGhhbmRsZXIuc2V0TmFtZSwKCQkvL3NldFN1YlByb3BlcnR5IGlzIHVzZWQgZm9yIHByb3BlcnRpZXMgbGlrZSBjc3MsIGF0dHIsIHByb3AKCQkJc3ViUHJvcGVydHlOYW1lID0gaGFuZGxlci5zZXRQYXJhcywKCQkJc3Vic2NyaWJlciA9IHRoaXM7CgoJCXN1YlByb3BlcnR5TmFtZSA/IHN1YnNjcmliZXJbcHJvcGVydHlOYW1lXSggc3ViUHJvcGVydHlOYW1lLCB2YWx1ZSApIDoKCQkJaXNGdW5jdGlvbiggc3Vic2NyaWJlcltwcm9wZXJ0eU5hbWVdICkgPyBzdWJzY3JpYmVyW3Byb3BlcnR5TmFtZV0oIHZhbHVlICkgOgoJCQkJc3Vic2NyaWJlcltwcm9wZXJ0eU5hbWVdID0gdmFsdWU7Cgl9CgoJZXh0ZW5kKCBobSwgewoKCQkvL0V2ZW50OiBFdmVudCwKCgkJdHJpZ2dlcjogdHJpZ2dlciwKCgkJc3Vic2NyaXB0aW9uOiBzdWJzY3JpcHRpb25NYW5hZ2VyLAoKCQkvL2hhbmRsZXIgY2FuIGJlIGEgZnVuY3Rpb24gKGUpIHt9CgkJLy8gYSBzdHJpbmcgbGlrZSAiZ2V0IHNldCBjb252ZXJ0IGludCIKCQkvL29yICIqZ2V0ICpzZXQgKmNvbnZlcnQgKmludCIKCQkvL29yIGl0IGNhbiBiZSAiKmNvbW1vbkhhbmRsZXIiCgkJLy9vciBpdCBjYW4gYmUgeyBnZXQ6eHgsIHNldDp4eCwgY29udmVydDp4eCwgaW5pdGlhbGl6ZTogeHh9CgkJLy9pdCBjYW4gYmUgYSBqYXZhc2NyaXB0IG9iamVjdCwgZG9tIGVsZW1lbnQsIGJ1dCBpdCBjYW4gbm90IGJlIGEgalF1ZXJ5IG9iamVjdAoJCS8vc3Vic2NyaWJlciBjYW4gYmUgbnVsbCwgIl8iLCAibnVsbCIsIHVuZGVmaW5lZCB0byByZXByZXNlbnQgYSBjYXNlIHdoZXJlIHRoZXJlIGlzIG5vdCBzdWJzY3JpYmVyCgkJLy9pZiBzdWJzY3JpYmVyIGlzICIiLCBpdCBtZWFucyB0aGUgdGhlIHJvb3QgbW9kZWwsIHRoZSByZXBvc2l0b3J5IG9iamVjdAoJCXN1YjogZnVuY3Rpb24oIHN1YnNjcmliZXIsIHB1Ymxpc2hlciwgZXZlbnRUeXBlcywgd29ya2Zsb3csIHdvcmtmbG93T3B0aW9ucywgZGVsZWdhdGVTZWxlY3RvciApIHsKCgkJCWlmIChzdWJzY3JpYmVyIGluc3RhbmNlb2YgaG0pIHsKCQkJCXN1YnNjcmliZXIgPSBzdWJzY3JpYmVyLnBhdGg7CgkJCX0KCgkJCWlmIChwdWJsaXNoZXIgaW5zdGFuY2VvZiBobSkgewoJCQkJcHVibGlzaGVyID0gcHVibGlzaGVyLnBhdGg7CgkJCX0KCgkJCWlmIChpc1N0cmluZyggc3Vic2NyaWJlciApICYmIHN1YnNjcmliZXIuc3RhcnRzV2l0aCggIiQiICkpIHsKCQkJCXN1YnNjcmliZXIgPSAkKCBzdWJzY3JpYmVyLnN1YnN0ciggMSApICk7CgkJCX0KCgkJCWlmIChzdWJzY3JpYmVyICYmIHN1YnNjcmliZXIuanF1ZXJ5KSB7CgkJCQkvL3N1YnNjcmliZXIgaXMgbGlrZSAkKCkKCQkJCS8vbmVlZCB0byBjb252ZXJ0IGpRdWVyeSBvYmplY3QgaW50byBkb20gb3IgcmF3IGVsZW1lbnQKCQkJCWlmICghc3Vic2NyaWJlci5sZW5ndGggJiYgIXN1YnNjcmliZXIuc2VsZWN0b3IpIHsKCQkJCQlzdWJzY3JpYmVyID0gbnVsbDsKCQkJCX0gZWxzZSB7CgkJCQkJc3Vic2NyaWJlci5lYWNoKCBmdW5jdGlvbiggaW5kZXgsIGVsZW1lbnQgKSB7CgkJCQkJCS8vdW53cmFwIGpRdWVyeSBlbGVtZW50CgkJCQkJCWhtLnN1YiggZWxlbWVudCwgcHVibGlzaGVyLCBldmVudFR5cGVzLCB3b3JrZmxvdywgd29ya2Zsb3dPcHRpb25zLCBkZWxlZ2F0ZVNlbGVjdG9yICk7CgkJCQkJfSApOwoJCQkJCXJldHVybjsKCQkJCX0KCQkJfQoKCQkJaWYgKGlzU3RyaW5nKCBwdWJsaXNoZXIgKSAmJiBwdWJsaXNoZXIuc3RhcnRzV2l0aCggIiQiICkpIHsKCQkJCXB1Ymxpc2hlciA9ICQoIHB1Ymxpc2hlci5zdWJzdHIoIDEgKSApOwoJCQl9CgoJCQlpZiAocHVibGlzaGVyICYmIHB1Ymxpc2hlci5qcXVlcnkpIHsKCQkJCXB1Ymxpc2hlci5lYWNoKCBmdW5jdGlvbiggaW5kZXgsIGVsZW1lbnQgKSB7CgkJCQkJaG0uc3ViKCBzdWJzY3JpYmVyLCBlbGVtZW50LCBldmVudFR5cGVzLCB3b3JrZmxvdywgd29ya2Zsb3dPcHRpb25zLCBkZWxlZ2F0ZVNlbGVjdG9yICk7CgkJCQl9ICk7CgkJCQlyZXR1cm47CgkJCX0KCgkJCWlmICghcHVibGlzaGVyICYmIHB1Ymxpc2hlciAhPT0gIiIpIHsKCQkJCXRocm93ICJwdWJsaXNoZXIgY2FuIG5vdCBiZSBudWxsIjsKCQkJfQoKCQkJaWYgKCFldmVudFR5cGVzKSB7CgkJCQl0aHJvdyAiZXZlbnRUeXBlcyBjYW4gbm90IGJlIG51bGwiOwoJCQl9CgoJCQkvL2FsbG93IHN1YnNjcmliZXIgIiIsIGJlY2F1c2UgdGhpcyBpcyB0aGUgcGF0aCBvZiByb290IG1vZGVsCgkJCWlmIChzdWJzY3JpYmVyID09PSAiXyIgfHwgc3Vic2NyaWJlciA9PSAibnVsbCIgfHwgc3Vic2NyaWJlciA9PT0gbnVsbCkgewoJCQkJc3Vic2NyaWJlciA9IHVuZGVmaW5lZDsKCQkJfQoKCQkJaWYgKHdvcmtmbG93T3B0aW9ucyA9PT0gIl8iKSB7CgkJCQl3b3JrZmxvd09wdGlvbnMgPSB1bmRlZmluZWQ7CgkJCX0KCgkJCXZhciBpc1B1Ymxpc2hlck1vZGVsID0gaXNTdHJpbmcoIHB1Ymxpc2hlciApLAoJCQkJaXNTdWJzY3JpYmVyTW9kZWwgPSBpc1N0cmluZyggc3Vic2NyaWJlciApOwoKCQkJdmlld0lkTWFuYWdlci5tYXJrKCBwdWJsaXNoZXIgKTsKCQkJdmlld0lkTWFuYWdlci5tYXJrKCBzdWJzY3JpYmVyICk7CgoJCQlpZiAoaXNQdWJsaXNoZXJNb2RlbCkgewoJCQkJLy9zdWJzY3JpYmVyIGlzIGEgbW9kZWwKCQkJCXB1Ymxpc2hlciA9IHRvUGh5c2ljYWxQYXRoKCBwdWJsaXNoZXIgKTsKCQkJfQoKCQkJaWYgKGlzU3Vic2NyaWJlck1vZGVsKSB7CgkJCQkvL3N1YnNjcmliZXIgaXMgYSBtb2RlbAoJCQkJc3Vic2NyaWJlciA9IHRvUGh5c2ljYWxQYXRoKCBzdWJzY3JpYmVyICk7CgoJCQl9CgoJCQlpZiAoaXNQdWJsaXNoZXJNb2RlbCkgewoKCQkJCXN1YnNjcmliZU1vZGVsRXZlbnQoIHB1Ymxpc2hlciwgZXZlbnRUeXBlcywgc3Vic2NyaWJlciwgd29ya2Zsb3csIHdvcmtmbG93T3B0aW9ucyApOwoKCQkJfSBlbHNlIHsKCgkJCQlzdWJzY3JpYmVWaWV3RXZlbnQoIHB1Ymxpc2hlciwgZXZlbnRUeXBlcywgc3Vic2NyaWJlciwgd29ya2Zsb3csIHdvcmtmbG93T3B0aW9ucywgZGVsZWdhdGVTZWxlY3RvciApOwoJCQl9CgkJfSwKCgkJaGFuZGxlOiBmdW5jdGlvbiggLyogcHVibGlzaGVyLCBldmVudFR5cGVzLCB3b3JrZmxvdywgd29ya2Zsb3dPcHRpb25zLCBkZWxlZ2F0ZVNlbGVjdG9yICovICkgewoJCQlyZXR1cm4gdGhpcy5zdWIuYXBwbHkoIHRoaXMsIFtudWxsXS5jb25jYXQoIHNsaWNlLmNhbGwoIGFyZ3VtZW50cyApICkgKTsKCQl9LAoKCQkvL2Egd29ya2Zsb3dQcm90b3R5cGUgY2FuIGJlIGEgc3RyaW5nIGxpa2UgImdldCBzZXQgY29udmVydCBpbml0aWFsaXplIGZpbmFsaXplIgoJCS8vIG9yIGl0IGNhbiBiZSBhbiBvYmplY3QKCQkvKgoJCSB7CgkJIGdldDogInh4IiBvciBmdW5jdGlvbiAoKSB7fSwKCQkgc2V0OiAieHgiIG9yIGZ1bmN0aW9uICgpIHt9LAoJCSBjb252ZXJ0OiAieHgiIG9yIGZ1bmN0aW9uICgpIHt9LAoJCSBpbml0aWFsaXplOiAieHgiIG9yIGZ1bmN0aW9uICgpIHt9LAoJCSBmaW5hbGl6ZTogInh4IiBvciBmdW5jdGlvbiAoKSB7fQoJCSB9CgkJICovCgkJd29ya2Zsb3c6IHdvcmtmbG93ID0gZnVuY3Rpb24oIG5hbWUsIHdvcmtmbG93UHJvdG90eXBlICkgewoKCQkJaWYgKGlzT2JqZWN0KCBuYW1lICkpIHsKCQkJCWZvciAodmFyIGtleSBpbiBuYW1lKSB7CgkJCQkJd29ya2Zsb3dTdG9yZVtrZXldID0gYnVpbGRXb3JrZmxvdyggbmFtZVtrZXldICk7CgkJCQl9CgkJCQlyZXR1cm47CgkJCX0KCgkJCWlmIChpc1VuZGVmaW5lZCggbmFtZSApKSB7CgkJCQlyZXR1cm4gd29ya2Zsb3dTdG9yZTsKCQkJfQoKCQkJaWYgKGlzVW5kZWZpbmVkKCB3b3JrZmxvd1Byb3RvdHlwZSApKSB7CgkJCQlyZXR1cm4gd29ya2Zsb3dTdG9yZVtuYW1lXTsKCQkJfQoKCQkJd29ya2Zsb3dTdG9yZVtuYW1lXSA9IGJ1aWxkV29ya2Zsb3coIHdvcmtmbG93UHJvdG90eXBlICk7CgkJCXJldHVybiB3b3JrZmxvd1N0b3JlW25hbWVdOwoKCQl9LAoJCS8vY29tbW9uIGdldHRlciBhbmQgc2V0dGVyIGFyZSBzcGVjaWFsIGFjdGl2aXR5IGluIHRoZXkgd2F5IHRoZXkgYXJlIHVzZWQKCQkvL290aGVyIGFjdGl2aXRpZXMgdXNlIHRoZSBrZXkgZGlyZWN0bHkgdG8gcmVmZXJlbmNlIHRoZSBhY3Rpdml0aWVzCgkJLy8gYnV0IGdldHRlcnMgYW5kIHNldHRlcnMgbmVlZCB0byB1c2UgIiprZXkiIHRvIHJlZmVyZW5jZSBnZXR0ZXJzIGFuZCBzZXR0ZXJzCgkJLy8gaWYgeW91ciBnZXR0ZXIvc2V0dGVyIGtleSBkb2VzIG5vdCBiZWdpbiB3aXRoICIqIiwgdGhlbiBpdCB3aWxsIHVzZSB0aGUgZGVmYXVsdEdldAoJCS8vb3IgZGVmYXVsdFNldCwgYW5kIHRoZXkga2V5IHdpbGwgYmVjb21lIHRoZSBnZXRQcm9wZXJ0eSwgYW5kIG9wdGlvbmFsbHksCgkJLy8gdXNlIG9wdGlvbnMgdG8gcGFzcyB0aGUgZ2V0UHJvcCB2YWx1ZSwgdGhlIGRlZmF1bHRHZXQvZGVmYXVsdFNldAoJCS8vIGFyZSBub3QgbWVhbnQgdG8gYmUgdXNlZCBkaXJlY3RseSBsaWtlIG90aGVyIGNvbW1vbiBnZXR0ZXJzIG9yIHNldHRlcnMKCQlhY3Rpdml0eTogewoKCQkJLy9pbml0aWFsaXplKCBwdWJsaXNoZXIsIHN1YnNjcmliZXIsIGhhbmRsZXIsIHdvcmtmbG93T3B0aW9ucyApOwoJCQkvL2luc2lkZSBpbml0aWFsaXplIGZ1bmN0aW9uLCAndGhpcycgcmVmZXIgdG8gdGhlIHdpbmRvdwoJCQlpbml0aWFsaXplOiB7fSwKCgkJCS8vdmFsdWUgPSBoYW5kbGVyLmdldC5hcHBseSggc3Vic2NyaWJlciwgW2VdLmNvbmNhdCggdHJpZ2dlckRhdGEgKSApOwoJCQkvL2luc2lkZSB0aGUgZ2V0dGVyIGZ1bmN0aW9uLCAndGhpcycgcmVmZXIgdG8gdGhlIHN1YnNjcmliZXIKCQkJLy9nZXQoZSkKCQkJZ2V0OiB7CgkJCQlnZXRNZW1iZXI6IGdldE1lbWJlciwKCgkJCQkvL3RoZSBvcmlnaW5hbCBnZXQgaXMgImdldCIgY3VycmVudAoJCQkJLy9iZWNhdXNlIG9mIGV2ZW50IGJ1YmJsaW5nLCB0aGUgZGVmYXVsdCBnZXQgbWV0aG9kIGZvciBtb2RlbAoJCQkJLy93aWxsIG5vdCByZXR1cm4gdGhlIHZhbHVlIHlvdSB3YW50LCBzbyBuZWVkIHRvIGdldE9yaWdpbmFsCgkJCQlnZXRPcmlnaW5hbDogZnVuY3Rpb24oIGUgKSB7CgkJCQkJcmV0dXJuIGUub3JpZ2luYWxQdWJsaXNoZXIuZ2V0KCk7CgkJCQl9LAoKCQkJCS8vaWYgd2Ugd2FudCB0byBjYWxsIGEgbWVtYmVyICJmb28iIG9mIHB1Ymxpc2hlciBtb2RlbAoJCQkJLy9idXQgd2UgZG9uJ3Qgd2FudCB0byBkbyBhbnl0aGluZyB0byB0aGUgc3Vic2NyaWJlciwgd2UgbWF5IHdhbnQgdG8gdXNlIGV4cHJlc3Npb24KCQkJCS8vIipmYWtlR2V0IGZvbyIKCgkJCQkvLyRjbGljazppdGVtc3wqZWRpdFNoYWRvd0l0ZW0KCQkJCS8vJGNsaWNrOml0ZW1zKnF1ZXJ5UmVzdWx0fCplZGl0U2hhZG93SXRlbQoJCQkJLy93b3JrZmxvdyhoYW5kbGVyKSAtLT5uZXdTaGFkb3dJdGVtOiAiKmZha2VHZXQgbmV3U2hhZG93SXRlbSIsCgkJCQlmYWtlR2V0OiBmdW5jdGlvbigpIHsKCQkJCQlyZXR1cm4gZHVtbXk7CgkJCQl9CgkJCX0sCgoJCQkvL2hhbmRsZXIuc2V0LmNhbGwoIHN1YnNjcmliZXIsIHZhbHVlLCBlICk7CgkJCS8vaW5zaWRlIHNldHRlciBmdW5jdGlvbiAndGhpcycgcmVmZXIgdG8gdGhlIHN1YnNjcmliZXIKCQkJLy9zZXQodmFsdWUsIGUpCgkJCXNldDogewoJCQkJc2V0TWVtYmVyOiBzZXRNZW1iZXIsCgoJCQkJLy9iZWNhdXNlIGhtLmpzIHdhbnQgdG8gc3VwcG9ydCBzaW1wbGlmaWVkIGFjdGl2aXR5IGV4cHJlc3Npb24KCQkJCS8vcnVsZSAxCgkJCQkvLyAidmFsIiwgd2hlbiBwdWJsaXNoZXIgaXMgdmlldywgc3Vic2NyaWJlciBpcyBtb2RlbCwgd2hpY2ggbWVhbnMgInZhbCIgdmlldywKCQkJCS8vInNldCIgbW9kZWwKCQkJCS8vcnVsZSAyCgkJCQkvL29yICJodG1sIiwgd2hlbiBwdWJsaXNoZXIgaXMgbW9kZWwsIHN1YnNjcmliZXIgaXMgdmlldywgd2hpY2ggbWVhbnMgImdldCIgbW9kZWwKCQkJCS8vImh0bWwiIHZpZXcuCgoJCQkJLy9zbyBpZiBwdWJsaXNoZXIgaXMgbW9kZWwsIHN1YnNjcmliZXIgaXMgdmlldy4gV2UganVzdCB3YW50IHRvIGNhbGwgYSBtZXRob2QgImdldCIKCQkJCS8vb24gbW9kZWwgd2hpY2ggbW9kaWZ5IG1vZGVsLCBidXQgd2UgZG9uJ3Qgd2FudCB0byBjYWxsIGFueSBtZXRob2Qgb24gdmlldy4KCQkJCS8vd2UgYXJlIGluIGRpbGVtbWEgYmVjYXVzZSBvZiBydWxlIDIsIHdlIGRvbid0IGhhdmUgYSBkZWZhdWx0IG1ldGhvZCBmb3IgYSB2aWV3LgoJCQkJLy9hIGNhc2UgaW4gdXNlIGlzIHRoYXQKCQkJCS8vc2hhZG93RWRpdDogIiFpbml0Oi58aW5pdFNoYWRvd0VkaXQgKmZha2VTZXQ7IiArCgkJCQlmYWtlU2V0OiAkLm5vb3AKCgkJCX0sCgoJCQkvL2hhbmRsZXIuY29udmVydC5jYWxsKCBzdWJzY3JpYmVyLCB2YWx1ZSwgZSApOwoJCQkvL2luc2lkZSBjb252ZXJ0ZXIgZnVuY3Rpb24gJ3RoaXMnIHJlZmVyIHRvIHN1YnNjcmliZXIKCQkJY29udmVydDogewoKCQkJCXRvU3RyaW5nOiB1dGlsLnRvU3RyaW5nLAoKCQkJCXRvVHlwZWRWYWx1ZTogdXRpbC50b1R5cGVkVmFsdWUsCgoJCQkJdG9OdW1iZXI6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQkJCQlyZXR1cm4gK3ZhbHVlOwoJCQkJfSwKCgkJCQl0b0RhdGU6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQkJCQlyZXR1cm4gbmV3IERhdGUoIHZhbHVlICk7CgkJCQl9CgkJCX0sCgoJCQkvL2hhbmRsZXIuZmluYWxpemUuY2FsbCggc3Vic2NyaWJlciwgdmFsdWUsIGUgKTsKCQkJLy9pbnNpZGUgdGhlIGFmdGVyU2V0IGZ1bmN0aW9uLCAndGhpcycgcmVmZXIgdG8gdGhlIHN1YnNjcmliZXIKCQkJZmluYWxpemU6IHsKCQkJCS8vCQkJCXNhdmVMb2NhbDogZnVuY3Rpb24oIHZhbHVlLCBlICkgewoJCQkJLy8JCQkJCXV0aWwubG9jYWwoIGUucHVibGlzaGVyLnBhdGgsIHZhbHVlICk7CgkJCQkvLwkJCQl9CgkJCX0KCQl9Cgl9ICk7CgoJd29ya2Zsb3dTdG9yZSA9IHsKCgkJY2hhbmdlOiB7CgkJCWdldDogZnVuY3Rpb24oIGUgKSB7CgkJCQlyb290Tm9kZS5jaGFuZ2UoIGUuaGFuZGxlci5vcHRpb25zICk7CgkJCX0KCQl9LAoJCXNhdmVMb2NhbDogewoJCQlnZXQ6IGZ1bmN0aW9uKCBlICkgewoJCQkJdmFyIHBhdGggPSBlLnB1Ymxpc2hlci5wYXRoOwoJCQkJc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQkJaG0oIHBhdGggKS5zYXZlTG9jYWwoKTsKCQkJCX0sIDEgKTsKCQkJfQoJCX0KCX07CgoJdmFyIHZpZXdJZE1hbmFnZXIgPSB7CgoJCWdldElkOiBmdW5jdGlvbiggZWxlbSApIHsKCQkJcmV0dXJuICQoIGVsZW0gKS5obURhdGEoICJ2aWV3SWQiICk7CgkJfSwKCgkJdW5NYXJrOiBmdW5jdGlvbiggZWxlbSApIHsKCQkJJCggZWxlbSApLmhtRGF0YSggInZpZXdJZCIsIHVuZGVmaW5lZCApOwoJCX0sCgoJCW1hcms6IGZ1bmN0aW9uKCBlbGVtICkgewoJCQlpZiAoaXNPYmplY3QoIGVsZW0gKSAmJiAhJCggZWxlbSApLmhtRGF0YSggInZpZXdJZCIgKSkgewoJCQkJJCggZWxlbSApLmhtRGF0YSggInZpZXdJZCIsICsrdmlld0lkICk7CgkJCX0KCQl9Cgl9OwoKCS8vIC0tLS0tLS0tIHByaXZhdGUgLS0tLS0tLS0tLS0tLSAvLwoJLy90aGUgcmVhc29uIHRoYXQgd2Ugd2FudCB0byBidWlsZFVuaXF1ZVZpZXdFdmVudFR5cGVzIGlzIHRoYXQKCS8vd2hlbiB1bmJpbmQgb3IgdW5kZWxlZ2F0ZSB0aGUgdmlld0V2ZW50VHlwZXMsIHdlIHdhbnQgdG8gdGhlIHZpZXdFdmVudFR5cGVzCgkvL2FzIHVuaXF1ZSBhcyBwb3NzaWJsZSwgY2hlY2sgdGhlIHVuc3Vic2NyaWJlIG1ldGhvZAoJLy8KCS8vaW5wdXQ6IGdldFVuaXF1ZVZpZXdFdmVudFR5cGVzKCJjbGljayBkYmxDbGljayIsIHZpZXdXaXRoVmlld0lkMywgImN1c3RvbWVyIikKCS8vb3V0cHV0OiAiY2xpY2suX19obS4zLmN1c3RvbWVyIGRibENsaWNrLl9faG0uMy5jdXN0b21lciIKCS8vaW5wdXQ6IGdldFVuaXF1ZVZpZXdFdmVudFR5cGVzKCJjbGljayBkYmxDbGljayIsIHZpZXdXaXRoVmlld0lkMywgdmlld1dpdGhWaWV3SWQ0KQoJLy9vdXRwdXQ6ICJjbGljay5fX2htLjMuNCBkYmxDbGljay5fX2htLjMuNCIKCS8vaXQgdHJ5IHRvIGFwcGVuZCBhbiBldmVudCBuYW1lIHdpdGggYW5kICIuX19obS52aWV3SWQuc3Vic2NyaWJlcklkIgoJZnVuY3Rpb24gYnVpbGRVbmlxdWVWaWV3RXZlbnRUeXBlcyggb3JpZ2luYWxFdmVudFR5cGVzLCBwdWJsaXNoZXJWaWV3LCBzdWJzY3JpYmVyICkgewoKCQl2YXIgcHVibGlzaGVyVmlld0lkID0gdmlld0lkTWFuYWdlci5nZXRJZCggcHVibGlzaGVyVmlldyApOwoKCQkvKglpZiBvcmlnaW5hbCB2aWV3RXZlbnRzIGlzICJjbGljayBkYmxDbGljayIsCgkJIGFuZCBpdCBiaW5kIHRvIHBhdGggImZpcnN0TmFtZSIsIGl0IHdpbGwgY29udmVydCB0bwoJCSBjbGljay5fX2htLmZpcnN0TmFtZSBkYmxDbGljay5fX2htLmZpcnN0TmFtZSwgdGhlIHJlYXNvbiBpcyB0aGF0CgkJIHdoZW4gcGF0aCBpcyBkZWxldGVkLCB0aGUgbWV0aG9kIHVuYmluZChvYmplY3QpIG5lZWQgdG8gdW5iaW5kCgkJIGV2ZW50IGJ5IGEgbmFtZXNwYWNlLCBpZiBmaXJzdE5hbWUgaXMgZGVsZXRlZCwgd2UgY2FuIHVuYmluZCAiLl9faG0uZmlyc3ROYW1lIiovCgkJcmV0dXJuICQubWFwKAoJCQlvcmlnaW5hbEV2ZW50VHlwZXMuc3BsaXQoIHJTcGFjZXMgKSwKCQkJZnVuY3Rpb24oIG9yaWdpbmFsRXZlbnROYW1lICkgewoJCQkJcmV0dXJuIGlzU3RyaW5nKCBzdWJzY3JpYmVyICkgPwoJCQkJCW9yaWdpbmFsRXZlbnROYW1lICsgIi4iICsgc2hhZG93TmFtZXNwYWNlICsgIi4iICsgcHVibGlzaGVyVmlld0lkICsgIi4iICsgc3Vic2NyaWJlciA6CgkJCQkJb3JpZ2luYWxFdmVudE5hbWUgKyAiLiIgKyBzaGFkb3dOYW1lc3BhY2UgKyAiLiIgKyBwdWJsaXNoZXJWaWV3SWQgKyAiLiIgKyB2aWV3SWRNYW5hZ2VyLmdldElkKCBzdWJzY3JpYmVyICk7CgkJCX0KCQkpLmpvaW4oICIgIiApOwoJfQoKCS8vaWYgb2JqZWN0IGlzIGRvbSBlbGVtZW50IG9yIGpRdWVyeSBzZWxlY3RvciB0aGVuIHdyYXAgaW50byBqUXVlcnkKCS8vaWYgb2JqZWN0IGlzIG1vZGVsIHBhdGgsIHdyYXAgaXQgaW50byBtb2RlbAoJLy9pZiBpdCBpcyBwdXJlIG9iamVjdCwgcmV0dXJuIGFzIGl0IGlzCgkvL2lmIGl0IGlzIF8sIHJldHVybiBudWxsCglmdW5jdGlvbiB0cnlXcmFwUHVibGlzaGVyU3Vic2NyaWJlciggcHVibGlzaGVyT3JTdWJzY3JpYmVyICkgewoJCWlmIChpc1N0cmluZyggcHVibGlzaGVyT3JTdWJzY3JpYmVyICkpIHsKCQkJcmV0dXJuIGhtKCBwdWJsaXNoZXJPclN1YnNjcmliZXIgKTsKCgkJfSBlbHNlIGlmIChpc09iamVjdCggcHVibGlzaGVyT3JTdWJzY3JpYmVyICkgJiYgIXB1Ymxpc2hlck9yU3Vic2NyaWJlci5ub2RlVHlwZSkgewoJCQkvL25vdCBhIERPTSBlbGVtZW50CgkJCXJldHVybiBwdWJsaXNoZXJPclN1YnNjcmliZXI7CgoJCX0gZWxzZSBpZiAoIWlzVW5kZWZpbmVkKCBwdWJsaXNoZXJPclN1YnNjcmliZXIgKSkgewoKCQkJcmV0dXJuICQoIHB1Ymxpc2hlck9yU3Vic2NyaWJlciApOwoJCX0KCX0KCglmdW5jdGlvbiByZXBsYWNlRG90T3JTdGFyKCBtYXRjaCApIHsKCQkvL2lmIG1hdGNoIGlzICIuIiwgbm9ybWFsaXplIGl0IHRvICJcXC4iCgkJLy9pZiBtYXRjaCBpcyAiKiIsIG5vcm1hbGl6ZSBpdCB0byAiLioiCgkJcmV0dXJuIG1hdGNoID09ICIuIiA/ICJcXC4iIDogIi4qIjsKCX0KCgkvL2lmIG9uZSBvZiB0aGUgc3Vic2NyaWJlZCBldmVudHMgaXMgbWF0Y2hlZCB3aXRoIHRyaWdnZXJpbmcgZXZlbnQKCS8vcmV0dXJuIHRoYXQgc3Vic2NyaWJlZCBldmVudAoJZnVuY3Rpb24gZ2V0TWF0Y2hlZFN1YnNjcmliZWRFdmVudCggc3Vic2NyaWJlZEV2ZW50cywgdHJpZ2dlcmluZ0V2ZW50ICkgewoKCQl2YXIgbWF0Y2gsCgkJCXNvdXJjZSwKCQkJck1hdGNoV2l0aFRyaWdnZXJpbmdFdmVudCwKCQkJZXZlbnRTdWJzY3JpYmVkLAoJCQlpc0VuZFdpdGhTdGFyRG90LAoJCQlpOwoKCQlpZiAoc3Vic2NyaWJlZEV2ZW50cyA9PT0gIioiKSB7CgkJCXJldHVybiAiKiI7CgkJfQoKCQlzdWJzY3JpYmVkRXZlbnRzID0gc3Vic2NyaWJlZEV2ZW50cy5zcGxpdCggclNwYWNlcyApOwoKCQlmb3IgKGkgPSAwOyBpIDwgc3Vic2NyaWJlZEV2ZW50cy5sZW5ndGg7IGkrKykgewoKCQkJZXZlbnRTdWJzY3JpYmVkID0gc3Vic2NyaWJlZEV2ZW50c1tpXTsKCgkJCWlzRW5kV2l0aFN0YXJEb3QgPSByRW5kV2l0aFN0YXJEb3QudGVzdCggZXZlbnRTdWJzY3JpYmVkICk7CgoJCQlzb3VyY2UgPSBpc0VuZFdpdGhTdGFyRG90ID8KCQkJCS8vaWYgZXZlbnRTdWJzY3JpYmVkIGlzIGxpa2UgIiouIiBvciAiYmVmb3JlKi4iOwoJCQkJZXZlbnRTdWJzY3JpYmVkLnJlcGxhY2UoIHJFbmRXaXRoU3RhckRvdCwgIiIgKSA6CgkJCQlldmVudFN1YnNjcmliZWQ7CgoJCQlzb3VyY2UgPSBzb3VyY2UucmVwbGFjZSggckRvdE9yU3RhciwgcmVwbGFjZURvdE9yU3RhciApOwoKCQkJc291cmNlID0gaXNFbmRXaXRoU3RhckRvdCA/ICJeIiArIHNvdXJjZSA6ICJeIiArIHNvdXJjZSArICIkIjsKCgkJCXJNYXRjaFdpdGhUcmlnZ2VyaW5nRXZlbnQgPSBuZXcgUmVnRXhwKCBzb3VyY2UsICJpIiApOwoKCQkJbWF0Y2ggPSByTWF0Y2hXaXRoVHJpZ2dlcmluZ0V2ZW50LnRlc3QoIHRyaWdnZXJpbmdFdmVudCApOwoKCQkJaWYgKG1hdGNoKSB7CgkJCQlpZiAoaXNFbmRXaXRoU3RhckRvdCkgewoJCQkJCS8vaW4gb3RoZXIgYnJvd3NlciwgaW4gdGhlIGZvbGxvd2luZyBpcyBlbm91Z2gKCQkJCQkvL3ZhciByZW1haW5pbmcgPSBSZWdFeHAucmlnaHRDb250ZXh0OwoJCQkJCS8vCgkJCQkJLy9ob3dldmVyIGluIElFIGhhcyBhIGJ1ZyB0aGF0LCBpZiByVGVtcCBpcyAvXi8sIFJlZ0V4cC5yaWdodENvbnRleHQgcmV0dXJuICIiCgkJCQkJLy93aGlsZSBvdGhlciBicm93c2VyIFJlZ0V4cC5yaWdodENvbnRleHQgcmV0dXJuIHRoZSByZW1haW5pbmcKCQkJCQkvL3NlZSBodHRwOi8vanNiaW4uY29tL2lrYWt1dy8yL2VkaXQKCQkJCQl2YXIgcmVtYWluaW5nID0gc291cmNlID09ICJeIiA/IHRyaWdnZXJpbmdFdmVudCA6IFJlZ0V4cC5yaWdodENvbnRleHQ7CgoJCQkJCS8vaWYgcmVtYWluaW5nIGlzIGVtcHR5IG9yIHJlbWFpbmluZyBkb2VzIG5vdCBjb250YWlucyAiLiIKCQkJCQlpZiAoIXJlbWFpbmluZyB8fCAhcmVtYWluaW5nLmNvbnRhaW5zKCAiLiIgKSkgewoJCQkJCQlyZXR1cm4gc3Vic2NyaWJlZEV2ZW50c1tpXTsKCQkJCQl9CgkJCQl9IGVsc2UgewoJCQkJCXJldHVybiBzdWJzY3JpYmVkRXZlbnRzW2ldOwoJCQkJfQoJCQl9CgkJfQoJfQoKCS8vY2hlY2sgaWYgc3Vic2NyaXB0aW9uIG1hdGNoZWQgd2l0aCB0aGUgdHJpZ2dlcmluZyBldmVudCwKCS8vIGFuZCBpbnZva2UgaXRzIHdvcmtmbG93LCBhbmQgYWxzbyBjYXNjYWRlIHRoZSBldmVudHMgdG8KCS8vaG9yaXpvbnRhbGx5LCBlIGlzIG11dGFibGUKCWZ1bmN0aW9uIGNhbGxiYWNrTW9kZWxTdWJzY3JpcHRpb25IYW5kbGVyKCBlICkgewoKCQl2YXIgc3Vic2NyaXB0aW9uLAoJCQl3YXRjaGluZ1BhdGhzLAoJCQljYXNjYWRlRXZlbnQsCgkJCWksCgkJCWosCgkJCXN1YnNjcmlwdGlvbnNCeVB1Ymxpc2hlciA9IGUucHVibGlzaGVyLnN1YnNUb01lKCk7CgoJCWZvciAoaSA9IDA7IGkgPCBzdWJzY3JpcHRpb25zQnlQdWJsaXNoZXIubGVuZ3RoOyBpKyspIHsKCgkJCXN1YnNjcmlwdGlvbiA9IHN1YnNjcmlwdGlvbnNCeVB1Ymxpc2hlcltpXTsKCgkJCWUubWF0Y2hlZFR5cGUgPSBnZXRNYXRjaGVkU3Vic2NyaWJlZEV2ZW50KCBzdWJzY3JpcHRpb24uZXZlbnRUeXBlcywgZS50eXBlICk7CgoJCQlpZiAoZS5tYXRjaGVkVHlwZSkgewoJCQkJZXhlY3V0ZUhhbmRsZXIoIHRyeVdyYXBQdWJsaXNoZXJTdWJzY3JpYmVyKCBzdWJzY3JpcHRpb24uc3Vic2NyaWJlciApLCBzdWJzY3JpcHRpb24uaGFuZGxlciwgZSApOwoJCQl9CgoJCQlpZiAoZS5pc0ltbWVkaWF0ZVByb3BhZ2F0aW9uU3RvcHBlZCgpKSB7CgkJCQlyZXR1cm47CgkJCX0KCQl9CgoJCWlmICghZS5pc0Nhc2NhZGVTdG9wcGVkKCkpIHsKCgkJCXdhdGNoaW5nUGF0aHMgPSB3YXRjaFRhYmxlW2UucHVibGlzaGVyLnBhdGhdOwoKCQkJaWYgKHdhdGNoaW5nUGF0aHMpIHsKCQkJCWZvciAoaiA9IDA7IGogPCB3YXRjaGluZ1BhdGhzLmxlbmd0aDsgaisrKSB7CgoJCQkJCWNhc2NhZGVFdmVudCA9IHRyaWdnZXIoCgkJCQkJCXdhdGNoaW5nUGF0aHNbal0sCgkJCQkJCWUub3JpZ2luYWxQdWJsaXNoZXIucGF0aCwKCQkJCQkJZS50eXBlCgkJCQkJKTsKCgkJCQkJaWYgKGNhc2NhZGVFdmVudC5pc0ltbWVkaWF0ZVByb3BhZ2F0aW9uU3RvcHBlZCgpIHx8IGNhc2NhZGVFdmVudC5pc0ltbWVkaWF0ZVByb3BhZ2F0aW9uU3RvcHBlZCgpKSB7CgkJCQkJCXJldHVybjsKCQkJCQl9CgoJCQkJCWlmIChjYXNjYWRlRXZlbnQuaGFzRXJyb3IoKSkgewoJCQkJCQllLmVycm9yKCk7CgkJCQkJfQoJCQkJfQoJCQl9CgkJfQoJfQoKCS8vI2RlYnVnCgoJaWYgKGxvY2F0aW9uLnNlYXJjaC5jb250YWlucyggImRlYnVnIiApKSB7CgkJZGVmYXVsdE9wdGlvbnMuZGVidWcgPSB0cnVlOwoJfQoKCWZ1bmN0aW9uIHVud3JhcE9iamVjdCggb2JqZWN0ICkgewoJCWlmIChvYmplY3QpIHsKCQkJaWYgKCFpc1VuZGVmaW5lZCggb2JqZWN0LnBhdGggKSkgewoJCQkJcmV0dXJuIGhtLnV0aWwudG9Mb2dpY2FsUGF0aCggb2JqZWN0LnBhdGggKTsKCQkJfSBlbHNlIHsKCQkJCXJldHVybiBvYmplY3RbMF07CgkJCX0KCQl9IGVsc2UgewoJCQlyZXR1cm4gIm51bGwiOwoJCX0KCX0KCgkvLyNlbmRfZGVidWcKCglmdW5jdGlvbiBleGVjdXRlSGFuZGxlciggc3Vic2NyaWJlciwgaGFuZGxlciwgZSwgdHJpZ2dlckRhdGEgKSB7CgoJCS8vI2RlYnVnCgkJaWYgKGRlZmF1bHRPcHRpb25zLmRlYnVnKSB7CgkJCWxvZyggdW53cmFwT2JqZWN0KCBlLnB1Ymxpc2hlciApLAoJCQkJZS50eXBlLAoJCQkJdW53cmFwT2JqZWN0KCBzdWJzY3JpYmVyICksCgkJCQloYW5kbGVyLAoJCQkJdW53cmFwT2JqZWN0KCBlLm9yaWdpbmFsUHVibGlzaGVyICkKCQkJKTsKCQl9CgkJLy8jZW5kX2RlYnVnCgoJCXZhciB2YWx1ZSwKCQkJY2xvbmVkRXZlbnRBcmc7CgoJCWUuaGFuZGxlciA9IGhhbmRsZXI7CgkJZS5zdWJzY3JpYmVyID0gc3Vic2NyaWJlcjsKCgkJaWYgKCFpc1VuZGVmaW5lZCggdHJpZ2dlckRhdGEgKSkgewoJCQkvL2luIHRoZSBnZXQgbWV0aG9kICJ0aGlzIiByZWZlciB0byB0aGUgaGFuZGxlcgoJCQl2YWx1ZSA9IGhhbmRsZXIuZ2V0LmFwcGx5KCBzdWJzY3JpYmVyLCBbZV0uY29uY2F0KCB0cmlnZ2VyRGF0YSApICk7CgkJfSBlbHNlIHsKCQkJLy9pbiB0aGUgZ2V0IG1ldGhvZCAidGhpcyIgcmVmZXIgdG8gdGhlIGhhbmRsZXIKCQkJdmFsdWUgPSBoYW5kbGVyLmdldC5jYWxsKCBzdWJzY3JpYmVyLCBlICk7CgkJfQoKCQlpZiAoZS5pc0Fib3J0ZWQoKSkgewoJCQlyZXR1cm47CgkJfQoKCQlpZiAoaXNQcm9taXNlKCB2YWx1ZSApKSB7CgkJCWNsb25lZEV2ZW50QXJnID0gZXh0ZW5kKCB0cnVlLCB7fSwgZSApOwoJCQl2YWx1ZS5kb25lKCBmdW5jdGlvbiggdmFsdWUgKSB7CgkJCQlpZiAoaGFuZGxlci5jb252ZXJ0KSB7CgkJCQkJLy9pbiB0aGUgY29udmVydCBtZXRob2QgInRoaXMiIHJlZmVyIHRvIHRoZSBoYW5kbGVyCgkJCQkJdmFsdWUgPSBoYW5kbGVyLmNvbnZlcnQuY2FsbCggc3Vic2NyaWJlciwgdmFsdWUsIGUgKTsKCQkJCX0KCgkJCQlpZiAoaGFuZGxlci5zZXQgfHwgaGFuZGxlci5maW5hbGl6ZSkgewoJCQkJCS8vbWFrZSBzdXJlIGl0IGlzIGEgcmVhbCBwcm9taXNlIG9iamVjdAoJCQkJCWlmIChpc1Byb21pc2UoIHZhbHVlICkpIHsKCQkJCQkJdmFsdWUuZG9uZSggZnVuY3Rpb24oIHZhbHVlICkgewoJCQkJCQkJc2V0QW5kRmluYWxpemUoIHN1YnNjcmliZXIsIGhhbmRsZXIsIHZhbHVlLCBjbG9uZWRFdmVudEFyZyApOwoJCQkJCQl9ICk7CgoJCQkJCX0gZWxzZSB7CgkJCQkJCXJldHVybiBzZXRBbmRGaW5hbGl6ZSggc3Vic2NyaWJlciwgaGFuZGxlciwgdmFsdWUsIGUgKTsKCQkJCQl9CgkJCQl9CgkJCX0gKTsKCQl9IGVsc2UgewoJCQlpZiAoaGFuZGxlci5jb252ZXJ0KSB7CgkJCQkvL2luIHRoZSBjb252ZXJ0IG1ldGhvZCAidGhpcyIgcmVmZXIgdG8gdGhlIGhhbmRsZXIKCQkJCXZhbHVlID0gaGFuZGxlci5jb252ZXJ0LmNhbGwoIHN1YnNjcmliZXIsIHZhbHVlLCBlICk7CgkJCX0KCgkJCWlmIChoYW5kbGVyLnNldCB8fCBoYW5kbGVyLmZpbmFsaXplKSB7CgkJCQkvL21ha2Ugc3VyZSBpdCBpcyBhIHJlYWwgcHJvbWlzZSBvYmplY3QKCQkJCWlmIChpc1Byb21pc2UoIHZhbHVlICkpIHsKCQkJCQljbG9uZWRFdmVudEFyZyA9IGV4dGVuZCggdHJ1ZSwge30sIGUgKTsKCQkJCQl2YWx1ZS5kb25lKCBmdW5jdGlvbiggdmFsdWUgKSB7CgkJCQkJCXNldEFuZEZpbmFsaXplKCBzdWJzY3JpYmVyLCBoYW5kbGVyLCB2YWx1ZSwgY2xvbmVkRXZlbnRBcmcgKTsKCQkJCQl9ICk7CgoJCQkJfSBlbHNlIHsKCQkJCQlzZXRBbmRGaW5hbGl6ZSggc3Vic2NyaWJlciwgaGFuZGxlciwgdmFsdWUsIGUgKTsKCQkJCX0KCQkJfQoJCX0KCgl9CgoJZnVuY3Rpb24gc2V0QW5kRmluYWxpemUoIHN1YnNjcmliZXIsIGhhbmRsZXIsIHZhbHVlLCBlICkgewoJCWlmICh2YWx1ZSA9PT0gZHVtbXkpIHsKCQkJdmFsdWUgPSB1bmRlZmluZWQ7CgkJfQoJCWhhbmRsZXIuc2V0ICYmIGhhbmRsZXIuc2V0LmNhbGwoIHN1YnNjcmliZXIsIHZhbHVlLCBlICk7CgkJaGFuZGxlci5maW5hbGl6ZSAmJiBoYW5kbGVyLmZpbmFsaXplLmNhbGwoIHN1YnNjcmliZXIsIHZhbHVlLCBlICk7Cgl9CgoJZnVuY3Rpb24gc3Vic2NyaWJlTW9kZWxFdmVudCggcHVibGlzaGVyUGF0aCwgZXZlbnRUeXBlcywgc3Vic2NyaWJlciwgaGFuZGxlciwgb3B0aW9ucyApIHsKCgkJdmFyIG1hdGNoLAoJCQlkZWxheU1pbmlTZWNvbmQsCgkJCWluaXRFdmVudCwKCQkJZXZlbnRzOwoKCQlldmVudHMgPSBldmVudFR5cGVzLnNwbGl0KCAiICIgKTsKCgkJZm9yICh2YXIgaSA9IDA7IGkgPCBldmVudHMubGVuZ3RoOyBpKyspIHsKCQkJbWF0Y2ggPSBySW5pdC5leGVjKCBldmVudHNbaV0gKTsKCQkJaWYgKG1hdGNoKSB7CgkJCQlpbml0RXZlbnQgPSBldmVudHNbaV07CgkJCQlkZWxheU1pbmlTZWNvbmQgPSArbWF0Y2hbMV07CgkJCQlldmVudHMuc3BsaWNlKCBpLCAxICk7CgkJCQlldmVudFR5cGVzID0gZXZlbnRzLmpvaW4oICIgIiApOwoJCQkJYnJlYWs7CgkJCX0KCQl9CgoJCWhhbmRsZXIgPSBidWlsZEhhbmRsZXIoIGhhbmRsZXIsIHB1Ymxpc2hlclBhdGgsIHN1YnNjcmliZXIsIG9wdGlvbnMgKTsKCgkJaWYgKGV2ZW50VHlwZXMpIHsKCQkJc3Vic2NyaXB0aW9uTWFuYWdlci5hZGQoIHN1YnNjcmliZXIsIHB1Ymxpc2hlclBhdGgsIGV2ZW50VHlwZXMsIGhhbmRsZXIgKTsKCQl9CgoJCWlmIChpbml0RXZlbnQpIHsKCQkJdmFyIGluaXQgPSBmdW5jdGlvbigpIHsKCQkJCXZhciBlID0gbmV3IEV2ZW50KCBwdWJsaXNoZXJQYXRoLCBwdWJsaXNoZXJQYXRoLCBpbml0RXZlbnQgKTsKCQkJCWV4ZWN1dGVIYW5kbGVyKCB0cnlXcmFwUHVibGlzaGVyU3Vic2NyaWJlciggc3Vic2NyaWJlciApLCBoYW5kbGVyLCBlICk7CgkJCX07CgoJCQlpZiAoZGVsYXlNaW5pU2Vjb25kKSB7CgkJCQlzZXRUaW1lb3V0KCBpbml0LCBkZWxheU1pbmlTZWNvbmQgKTsKCQkJfSBlbHNlIHsKCQkJCWluaXQoKTsKCQkJfQoJCX0KCX0KCgkvL3N1YnNjcmliZSBqUXVlcnkgZXZlbnQKCWZ1bmN0aW9uIHN1YnNjcmliZVZpZXdFdmVudCggdmlld1B1Ymxpc2hlciwgZXZlbnRUeXBlcywgc3Vic2NyaWJlciwgaGFuZGxlciwgb3B0aW9ucywgZGVsZWdhdGVTZWxlY3RvciApIHsKCgkJLy9nZXQvc2V0L2NvbnZlcnQvW2luaXRdL1tvcHRpb25zXQoJCXZhciBuZWVkSW5pdCwKCQkJZXZlbnRTZWVkRGF0YSwKCQkJdGVtcDsKCgkJdGVtcCA9IGV2ZW50VHlwZXMuc3BsaXQoICIgIiApOwoKCQlpZiAodGVtcC5jb250YWlucyggImluaXQiICkpIHsKCQkJbmVlZEluaXQgPSB0cnVlOwoJCQlldmVudFR5cGVzID0gdGVtcC5yZW1vdmUoICJpbml0IiApLmpvaW4oICIgIiApOwoJCX0KCgkJaGFuZGxlciA9IGJ1aWxkSGFuZGxlciggaGFuZGxlciwgdmlld1B1Ymxpc2hlciwgc3Vic2NyaWJlciwgb3B0aW9ucyApOwoKCQlldmVudFNlZWREYXRhID0gewoJCQloYW5kbGVyOiBoYW5kbGVyLAoJCQlzdWJzY3JpYmVyOiBzdWJzY3JpYmVyCgkJfTsKCgkJaWYgKGV2ZW50VHlwZXMpIHsKCQkJZXZlbnRUeXBlcyA9IGJ1aWxkVW5pcXVlVmlld0V2ZW50VHlwZXMoIGV2ZW50VHlwZXMsIHZpZXdQdWJsaXNoZXIsIHN1YnNjcmliZXIgKTsKCgkJCWlmIChkZWxlZ2F0ZVNlbGVjdG9yKSB7CgkJCQloYW5kbGVyLmRlbGVnYXRlU2VsZWN0b3IgPSBkZWxlZ2F0ZVNlbGVjdG9yOwoJCQkJJCggdmlld1B1Ymxpc2hlciApLmRlbGVnYXRlKCBkZWxlZ2F0ZVNlbGVjdG9yLCBldmVudFR5cGVzLCBldmVudFNlZWREYXRhLCB2aWV3SGFuZGxlckdhdGV3YXkgKTsKCgkJCX0gZWxzZSB7CgkJCQkkKCB2aWV3UHVibGlzaGVyICkuYmluZCggZXZlbnRUeXBlcywgZXZlbnRTZWVkRGF0YSwgdmlld0hhbmRsZXJHYXRld2F5ICk7CgoJCQl9CgoJCQkvL3dlIGhhdmUgcGFzc2VkIGhhbmRsZXIsIHN1YnNjcmliZXIsIG9wdGlvbnMgYXMgalF1ZXJ5IGV2ZW50U2VlZERhdGEsCgkJCS8vd2Ugc3RpbGwgbmVlZCB0byBhZGQgdGhlbSB0byBzdWJzY3JpcHRpb25zIHNvIHRoYXQKCQkJLy90aGUgdmlldyBldmVudCBoYW5kbGVyIGNhbiBiZSB1bmJpbmQgb3IgdW5kZWxlZ2F0ZQoJCQlzdWJzY3JpcHRpb25NYW5hZ2VyLmFkZCggc3Vic2NyaWJlciwgdmlld1B1Ymxpc2hlciwgZXZlbnRUeXBlcywgaGFuZGxlciApOwoKCQkJaWYgKG5lZWRJbml0KSB7CgkJCQlpZiAoZGVsZWdhdGVTZWxlY3RvcikgewoJCQkJCSQoIHZpZXdQdWJsaXNoZXIgKS5maW5kKCBkZWxlZ2F0ZVNlbGVjdG9yICkudHJpZ2dlciggZXZlbnRUeXBlcyApOwoJCQkJfSBlbHNlIHsKCQkJCQkkKCB2aWV3UHVibGlzaGVyICkudHJpZ2dlciggZXZlbnRUeXBlcyApOwoJCQkJfQoJCQl9CgoJCX0gZWxzZSBpZiAobmVlZEluaXQpIHsKCgkJCSQoIHZpZXdQdWJsaXNoZXIgKS5vbmUoICJpbml0IiwgZXZlbnRTZWVkRGF0YSwgdmlld0hhbmRsZXJHYXRld2F5ICk7CgkJCSQoIHZpZXdQdWJsaXNoZXIgKS50cmlnZ2VyKCAiaW5pdCIgKTsKCgkJfQoJfQoKCWZ1bmN0aW9uIGFib3J0KCkgewoJCXRoaXMuaXNBYm9ydGVkID0gcmV0dXJuVHJ1ZTsKCX0KCgkvL3RoZSBnZW5lcmFsIGpRdWVyeSBldmVudCBoYW5kbGVyCglmdW5jdGlvbiB2aWV3SGFuZGxlckdhdGV3YXkoIGUgKSB7CgkJZS5wdWJsaXNoZXIgPSB0cnlXcmFwUHVibGlzaGVyU3Vic2NyaWJlciggZS5jdXJyZW50VGFyZ2V0ICk7CgkJZS5vcmlnaW5hbFB1Ymxpc2hlciA9IHRyeVdyYXBQdWJsaXNoZXJTdWJzY3JpYmVyKCBlLnRhcmdldCApOwoJCWUuaXNBYm9ydGVkID0gcmV0dXJuRmFsc2U7CgkJZS5hYm9ydCA9IGFib3J0OwoJCXZhciBzdWJzY3JpYmVyID0gdHJ5V3JhcFB1Ymxpc2hlclN1YnNjcmliZXIoIGUuZGF0YS5zdWJzY3JpYmVyICk7CgoJCXZhciBoYW5kbGVyID0gZS5kYXRhLmhhbmRsZXI7CgkJZGVsZXRlIGUuZGF0YTsKCgkJaWYgKGFyZ3VtZW50cy5sZW5ndGggPiAxKSB7CgkJCWV4ZWN1dGVIYW5kbGVyKCBzdWJzY3JpYmVyLCBoYW5kbGVyLCBlLCBzbGljZS5jYWxsKCBhcmd1bWVudHMsIDEgKSApOwoKCQl9IGVsc2UgewoJCQlleGVjdXRlSGFuZGxlciggc3Vic2NyaWJlciwgaGFuZGxlciwgZSApOwoJCX0KCX0KCglmdW5jdGlvbiBidWlsZEhhbmRsZXIoIHdvcmtmbG93UHJvdG90eXBlLCBwdWJsaXNoZXIsIHN1YnNjcmliZXIsIGluaXRpYWxpemVPcHRpb25zICkgewoKCQl2YXIgaGFuZGxlcjsKCgkJd29ya2Zsb3dQcm90b3R5cGUgPSB3b3JrZmxvd1Byb3RvdHlwZSB8fCAiIjsKCgkJaWYgKGlzU3RyaW5nKCB3b3JrZmxvd1Byb3RvdHlwZSApKSB7CgoJCQloYW5kbGVyID0gYnVpbGRIYW5kbGVyRnJvbVN0cmluZyggd29ya2Zsb3dQcm90b3R5cGUsIHB1Ymxpc2hlciwgc3Vic2NyaWJlciwgaW5pdGlhbGl6ZU9wdGlvbnMgKTsKCgkJfSBlbHNlIGlmIChpc0Z1bmN0aW9uKCB3b3JrZmxvd1Byb3RvdHlwZSApKSB7CgoJCQloYW5kbGVyID0gZXh0ZW5kKCB7CgkJCQkJZ2V0OiB3b3JrZmxvd1Byb3RvdHlwZSwKCQkJCQlvcHRpb25zOiBpbml0aWFsaXplT3B0aW9ucwoJCQkJfSwKCQkJCXdvcmtmbG93UHJvdG90eXBlCgkJCSk7CgoJCX0gZWxzZSBpZiAoaXNPYmplY3QoIHdvcmtmbG93UHJvdG90eXBlICkgJiYgd29ya2Zsb3dQcm90b3R5cGUuZ2V0KSB7CgoJCQloYW5kbGVyID0gZXh0ZW5kKCB7CgkJCQlvcHRpb25zOiBpbml0aWFsaXplT3B0aW9ucwoJCQl9LCB3b3JrZmxvd1Byb3RvdHlwZSApOwoKCQl9IGVsc2UgewoJCQl0aHJvdyAiaW52YWxpZCB3b3JrZmxvdyBleHByZXNzaW9uIjsKCQl9CgoJCWluaXRpYWxpemVIYW5kbGVyKCBoYW5kbGVyLCBwdWJsaXNoZXIsIHN1YnNjcmliZXIsIGluaXRpYWxpemVPcHRpb25zICk7CgoJCWNvbnZlcnRTdHJpbmdBY2Nlc3NvclRvRnVuY3Rpb24oICJnZXQiLCBoYW5kbGVyLCBwdWJsaXNoZXIsIHN1YnNjcmliZXIgKTsKCQljb252ZXJ0U3RyaW5nQWNjZXNzb3JUb0Z1bmN0aW9uKCAic2V0IiwgaGFuZGxlciwgcHVibGlzaGVyLCBzdWJzY3JpYmVyICk7CgkJLy8KCQljb252ZXJ0U3RyaW5nQWN0aXZpdHlUb0Z1bmN0aW9uKCAiY29udmVydCIsIGhhbmRsZXIsIHB1Ymxpc2hlciwgc3Vic2NyaWJlciApOwoJCWNvbnZlcnRTdHJpbmdBY3Rpdml0eVRvRnVuY3Rpb24oICJmaW5hbGl6ZSIsIGhhbmRsZXIsIHB1Ymxpc2hlciwgc3Vic2NyaWJlciApOwoKCQlyZXR1cm4gaGFuZGxlcjsKCX0KCgkvLyBleGFtcGxlIG9mIHdvcmtmbG93U3RyaW5nCgkvLyB6ZXJvIHRva2VuLCB0aGUgc3Vic2NyaWJlciBtdXN0IGJlIGZ1bmN0aW9uIGluIHJlcG9zaXRvcnkKCS8vCgkvLyBzaW5nbGUgdG9rZW4gbGlrZSAiKndvcmtmbG93IiwgInZhbCIsICJodG1sIiwgIiNwYXRoIiwKCS8vICJ2YWwiIHdpbGwgZXhwYW5kIHRvICJ2YWwgc2V0IiBvciAiZ2V0IHZhbCIgZGVwZW5kaW5nIHRoZSB0eXBlIG9mIHB1Ymxpc2hlcgoJLy8KCS8vIG11bHRpcGxlIHRva2VucywgYWxsIHRva2VuIGNhbiBzdGFydHMgd2l0aCAiKiIsICIjIiwKCS8vIGJ1dCBvbmx5ICJnZXQiIGFuZCAic2V0IiB0b2tlbiBjYW4gc3RhcnQgbm9ybWFsIGNoYXJhY3RlcnMsCgkvLyBzdWNoIGFzICJ2YWwiLCAiaHRtbCIKCWZ1bmN0aW9uIGJ1aWxkSGFuZGxlckZyb21TdHJpbmcoIHdvcmtmbG93U3RyaW5nLCBwdWJsaXNoZXIsIHN1YnNjcmliZXIsIGluaXRpYWxpemVPcHRpb25zICkgewoKCQkvL2dldCBzZXQgY29udmVydCBpbml0aWFsaXplIGZpbmFsaXplCgkJdmFyIGhhbmRsZXIsCgkJCWVtYmVkZGVkSGFuZGxlciwKCQkJYWN0aXZpdHlOYW1lLAoJCQlhY3Rpdml0eU5hbWVzID0gd29ya2Zsb3dTdHJpbmcuc3BsaXQoIHJTcGFjZXMgKSwKCQkJYWN0aXZpdHlUeXBlOwoKCQlpZiAoYWN0aXZpdHlOYW1lcy5sZW5ndGggPT0gMSkgewoKCQkJaWYgKHdvcmtmbG93U3RyaW5nLnN0YXJ0c1dpdGgoICIqIiApKSB7CgoJCQkJaGFuZGxlciA9IHdvcmtmbG93U3RvcmVbd29ya2Zsb3dTdHJpbmcuc3Vic3RyKCAxICldOwoJCQkJaWYgKCFoYW5kbGVyKSB7CgkJCQkJdGhyb3cgImNvbW1vbiB3b3JrZmxvdyAiICsgd29ya2Zsb3dTdHJpbmcgKyAiIGRvZXMgbm90IGV4aXN0IjsKCQkJCX0KCgkJCQloYW5kbGVyID0gZXh0ZW5kKCB7fSwgaGFuZGxlciApOwoKCQkJfSBlbHNlIGlmICh3b3JrZmxvd1N0cmluZy5zdGFydHNXaXRoKCAiIyIgKSkgewoKCQkJCWVtYmVkZGVkSGFuZGxlciA9IGdldEVtYmVkZGVkQWN0aXZpdHkoIHdvcmtmbG93U3RyaW5nLCBwdWJsaXNoZXIsIHN1YnNjcmliZXIgKTsKCgkJCQlpZiAoaXNGdW5jdGlvbiggZW1iZWRkZWRIYW5kbGVyICkpIHsKCQkJCQloYW5kbGVyID0gZXh0ZW5kKCB7CgkJCQkJCWdldDogZW1iZWRkZWRIYW5kbGVyLAoJCQkJCQlvcHRpb25zOiBpbml0aWFsaXplT3B0aW9ucwoJCQkJCX0sIGVtYmVkZGVkSGFuZGxlciApOwoJCQkJfSBlbHNlIGlmIChpc09iamVjdCggZW1iZWRkZWRIYW5kbGVyICkgJiYgZW1iZWRkZWRIYW5kbGVyLmdldCkgewoJCQkJCWhhbmRsZXIgPSBleHRlbmQoIHsKCQkJCQkJb3B0aW9uczogaW5pdGlhbGl6ZU9wdGlvbnMKCQkJCQl9LCBlbWJlZGRlZEhhbmRsZXIgKTsKCQkJCX0gZWxzZSB7CgkJCQkJdGhyb3cgIm1pc3NpbmcgaGFuZGxlciI7CgkJCQl9CgoJCQl9IGVsc2UgaWYgKCFpc1VuZGVmaW5lZCggcHVibGlzaGVyICkgJiYgIWlzVW5kZWZpbmVkKCBzdWJzY3JpYmVyICkpIHsKCgkJCQloYW5kbGVyID0gaW5mZXJIYW5kbGVyRnJvbVB1Ymxpc2hlclN1YnNjcmliZXJXaXRoU2luZ2xlQWN0aXZpdHkoCgkJCQkJcHVibGlzaGVyLAoJCQkJCXN1YnNjcmliZXIsCgkJCQkJd29ya2Zsb3dTdHJpbmcgKTsKCgkJCX0gZWxzZSB7CgkJCQkvL2VpdGhlciBtb2RlbCBpcyBlbXB0eSBvciB2aWV3IGlzIGVtcHR5LAoJCQkJLy8gYW5kIHRoZSB3b3JrZmxvdyBzdHJpbmcgaXMgYSBzaW5nbGUKCQkJCS8va2V5LCBhbmQgdGhlIGtleSBpcyBub3Qgd29ya2Zsb3cgdHlwZQoJCQkJdGhyb3cgImludmFsaWQgaGFuZGxlciI7CgkJCX0KCgkJfSBlbHNlIHsKCQkJLy90aGlzIGlzIHRoZSBjYXNlCgkJCS8vYWN0aXZpdHlOYW1lcy5sZW5ndGggPiAxCgoJCQloYW5kbGVyID0geyB9OwoKCQkJLy9hY3Rpdml0eVR5cGVzIGlzIFtnZXQsc2V0LGNvbnZlcnQsZmluYWxpemUsaW5pdGlhbGl6ZV0KCQkJZm9yICh2YXIgaSA9IDA7IGkgPCBhY3Rpdml0eVR5cGVzLmxlbmd0aDsgaSsrKSB7CgkJCQlhY3Rpdml0eU5hbWUgPSBhY3Rpdml0eU5hbWVzW2ldOyAvL2FjdGl2aXR5TmFtZSBpcyB0aGUgdG9rZW4gaW4gd29ya2Zsb3cgc3RyaW5nCgkJCQlhY3Rpdml0eVR5cGUgPSBhY3Rpdml0eVR5cGVzW2ldOyAvL2FjdGl2aXR5VHlwZSBpcyBvbmUgb2YgZ2V0LHNldCxjb252ZXJ0LGZpbmFsaXplLGluaXRpYWxpemUKCgkJCQlpZiAoYWN0aXZpdHlOYW1lICYmIChhY3Rpdml0eU5hbWUgIT09ICJfIiAmJiBhY3Rpdml0eU5hbWUgIT0gIm51bGwiKSkgewoJCQkJCWhhbmRsZXJbYWN0aXZpdHlUeXBlXSA9IGFjdGl2aXR5TmFtZTsKCQkJCX0KCQkJfQoJCX0KCQlyZXR1cm4gaGFuZGxlcjsKCX0KCgkvL2dldCBlbWJlZGRlZCBoYW5kbGVyIGhlbHBlciBieSBwYXRoCgkvL3RoZSBwYXRoIHNob3VsZCBiZSBhIHBhdGggcHJlZml4IHdpdGggIiMiCgkvL3RoYXQgcGF0aCBjYW4gYmUgYWJzb2x1dGUgcGF0aCBsaWtlICIjL2EuYiIKCS8vb3IgaXQgY2FuIGJlIHJlbGF0aXZlIHBhdGggcmVsYXRpdmUgdG8gc3Vic2NyaWJlciBtb2RlbCBvciBwdWJsaXNoZXIgbW9kZWwKCWZ1bmN0aW9uIGdldEVtYmVkZGVkQWN0aXZpdHkoIGFjdGl2aXR5TmFtZVByZWZpeFdpdGhTaGFycENoYXJhY3RlciwgcHVibGlzaGVyLCBzdWJzY3JpYmVyICkgewoKCQl2YXIgbW9kZWxQYXRoID0gYWN0aXZpdHlOYW1lUHJlZml4V2l0aFNoYXJwQ2hhcmFjdGVyLnN1YnN0ciggMSApOwoKCQltb2RlbFBhdGggPSBpc1N0cmluZyggc3Vic2NyaWJlciApID8gbWVyZ2VQYXRoKCBzdWJzY3JpYmVyLCBtb2RlbFBhdGggKSA6CgkJCWlzU3RyaW5nKCBwdWJsaXNoZXIgKSA/IG1lcmdlUGF0aCggcHVibGlzaGVyLCBtb2RlbFBhdGggKSA6CgkJCQltb2RlbFBhdGg7CgoJCXJldHVybiByb290Tm9kZS5yYXcoIG1vZGVsUGF0aCApOwoJfQoKCWZ1bmN0aW9uIGluaXRpYWxpemVIYW5kbGVyKCBoYW5kbGVyLCBwdWJsaXNoZXIsIHN1YnNjcmliZXIsIHdvcmtmbG93T3B0aW9ucyApIHsKCgkJdmFyIGluaXRpYWxpemUgPSBoYW5kbGVyLmluaXRpYWxpemU7CgoJCWlmIChpc1N0cmluZyggaW5pdGlhbGl6ZSApKSB7CgkJCWlmIChpbml0aWFsaXplLnN0YXJ0c1dpdGgoICIqIiApKSB7CgkJCQlpbml0aWFsaXplID0gaG0uYWN0aXZpdHkuaW5pdGlhbGl6ZVtpbml0aWFsaXplLnN1YnN0cmluZyggMSApXTsKCQkJCWlmICghaW5pdGlhbGl6ZSkgewoJCQkJCXRocm93ICJpbml0aWFsaXplIGFjdGl2aXR5IGRvZXMgbm90IGV4aXN0ISI7CgkJCQl9CgkJCX0gZWxzZSB7CgkJCQl2YXIgcGF0aCA9IGluaXRpYWxpemU7CgkJCQlpZiAoIXJvb3ROb2RlLnJhdyggcGF0aCApKSB7CgkJCQkJdGhyb3cgImluaXRpYWxpemUgYWN0aXZpdHkgZG9lcyBub3QgZXhpc3QgYXQgcGF0aCAiICsgcGF0aDsKCQkJCX0KCQkJCWluaXRpYWxpemUgPSBmdW5jdGlvbiggcHVibGlzaGVyLCBzdWJzY3JpYmVyLCBoYW5kbGVyLCBvcHRpb25zICkgewoJCQkJCXJvb3ROb2RlLnNldCggcGF0aCwgcHVibGlzaGVyLCBzdWJzY3JpYmVyLCBoYW5kbGVyLCBvcHRpb25zICk7CgkJCQl9OwoJCQl9CgkJfQoKCQlpZiAoaW5pdGlhbGl6ZSkgewoJCQlpbml0aWFsaXplKCB0cnlXcmFwUHVibGlzaGVyU3Vic2NyaWJlciggcHVibGlzaGVyICksIHRyeVdyYXBQdWJsaXNoZXJTdWJzY3JpYmVyKCBzdWJzY3JpYmVyICksIGhhbmRsZXIsIHdvcmtmbG93T3B0aW9ucyApOwoJCX0gZWxzZSBpZiAoIWlzVW5kZWZpbmVkKCB3b3JrZmxvd09wdGlvbnMgKSkgewoJCQloYW5kbGVyLm9wdGlvbnMgPSB3b3JrZmxvd09wdGlvbnM7CgkJfQoJfQoKCWZ1bmN0aW9uIGluZmVySGFuZGxlckZyb21QdWJsaXNoZXJTdWJzY3JpYmVyV2l0aFNpbmdsZUFjdGl2aXR5KCBwdWJsaXNoZXIsIHN1YnNjcmliZXIsIGFjdGl2aXR5TmFtZSApIHsKCQkvL25vdyB3b3JrZmxvd1N0cmluZyBkb2VzIG5vdCBzdGFydHNXaXRoICosIGl0IGlzIG5vdCBhIHdvcmtmbG93IHR5cGUKCQkvL2luZmVyIGhhbmRsZXIgZnJvbSBwdWJsaXNoZXIgYW5kIHN1YnNjcmliZXIKCQkvLwoJCXZhciBoYW5kbGVyLAoJCQlpc1B1Ymxpc2hlck1vZGVsID0gaXNTdHJpbmcoIHB1Ymxpc2hlciApLAoJCQlpc1N1YnNjcmliZXJNb2RlbCA9IGlzU3RyaW5nKCBzdWJzY3JpYmVyICk7CgoJCWlmIChpc1B1Ymxpc2hlck1vZGVsKSB7CgkJCS8vaWYgcHVibGlzaGVyIGlzIG1vZGVsLCB0aGVuIHRoZSBsb2dpYyBpcwoJCQkvL3dpbGwgZ2V0IG1vZGVsJ3MgdmFsdWUgdXNpbmcgZGVmYXVsdCBnZXQgYWN0aXZpdHksCgkJCS8vYW5kIHVwZGF0ZSB0aGUgdmlldyB1c2luZyB3b3JrZmxvdyBvciAgZGVmYXVsdCAic2V0IiBhY3Rpdml0eQoJCQkvLwoJCQloYW5kbGVyID0gewoKCQkJCWdldDogImdldCIsCgoJCQkJLy9pZiB3b3JrZmxvd1N0cmluZyBpcyBub3QgZW1wdHksIGl0IGlzIHRoZSBzZXQgbWV0aG9kLCBmb3IgZXhhbXBsZQoJCQkJLy8kKCIjbGFibGUiKS5zdWIoaG0oIm1lc3NhZ2UiKSwgInRleHQiKTsKCQkJCS8vCgkJCQkvL2lmIHdvcmtmbG93U3RyaW5nIGlzIGVtcHR5LAoJCQkJLy8gdGhlbiBpdCBzaG91bGQgYmUgdGhlIGNhc2Ugd2hlbiBtb2RlbCBzdWJzY3JpYmUgbW9kZWwKCQkJCS8vY29weSB2YWx1ZSBvZiBvbmUgbm9kZSB0byBhbiBvdGhlciBub2RlCgkJCQkvL2htKCJtZXNzYWdlIikuc3ViKGhtKCJuYW1lIiksICJhZnRlclVwZGF0ZSIpOwoJCQkJc2V0OiBhY3Rpdml0eU5hbWUgfHwgInNldCIKCgoJCQl9OwoKCQl9IGVsc2UgaWYgKGlzU3Vic2NyaWJlck1vZGVsKSB7CgoJCQkvLyBtb2RlbCBzdWJzY3JpYmUgdmlldyBldmVudAoKCQkJaWYgKGFjdGl2aXR5TmFtZSkgewoJCQkJLy9obSgibmFtZSIpLnN1YigkKCIjdGV4dEJveCIsICJjaGFuZ2UiKTsKCQkJCWhhbmRsZXIgPSB7CgkJCQkJZ2V0OiBhY3Rpdml0eU5hbWUsCgkJCQkJc2V0OiAic2V0IgoJCQkJfTsKCQkJfSBlbHNlIHsKCgkJCQkvL2lmIHdvcmtmbG93U3RyaW5nIGlzIGVtcHR5CgkJCQkvL3doZW4gbW9kZWwgc3Vic2NyaWJlIHZpZXcgd2l0aG91dCBoYW5kbGVyCgkJCQkvL3RoZSBtb2RlbCBpcyB0aGUgaGFuZGxlciBieSBpdHNlbGYKCQkJCS8vZS5nCgkJCQkvL2htKCJmdW5jdGlvbk5vZGUiKS5zdWJzY3JpYmUoJCgiYnV0dG9uIiksICJjbGljayIpOwoJCQkJdmFyIHRlbXAgPSByb290Tm9kZS5yYXcoIHN1YnNjcmliZXIgKTsKCQkJCWlmIChpc0Z1bmN0aW9uKCB0ZW1wICkpIHsKCgkJCQkJaGFuZGxlciA9IHsKCQkJCQkJZ2V0OiByb290Tm9kZS5yYXcoIHN1YnNjcmliZXIgKQoJCQkJCX07CgoJCQkJfSBlbHNlIGlmIChpc09iamVjdCggdGVtcCApICYmIHRlbXAuZ2V0KSB7CgoJCQkJCWhhbmRsZXIgPSB0ZW1wOwoKCQkJCX0gZWxzZSB7CgkJCQkJdGhyb3cgIm1pc3NpbmcgaGFuZGxlciI7CgkJCQl9CgkJCX0KCgkJfSBlbHNlIHsKCQkJLy92aWV3IHN1YnNjcmliZSB2aWV3J3MgZXZlbnQKCQkJLy90aGlzIGlzIHJhcmVseSB0aGUgY2FzZSwgYnV0IGl0IGlzIHN0aWxsIHN1cHBvcnRlZAoJCQkvL2ZvciBleGFtcGxlLCBhIGxhYmVsIHN1YnNjcmliZSB0aGUgY2hhbmdlIG9mIGFub3RoZXIgbGFiZWwKCQkJLy8kKCIjbGFibGUyIikuc3ViKCIjbGFibGUxIiwgInRleHQiKTsKCQkJaGFuZGxlciA9IHsKCQkJCWdldDogYWN0aXZpdHlOYW1lLAoJCQkJc2V0OiBhY3Rpdml0eU5hbWUKCQkJfTsKCQl9CgoJCXJldHVybiBoYW5kbGVyOwoJfQoKCWZ1bmN0aW9uIGJ1aWxkV29ya2Zsb3coIHdvcmtmbG93UHJvdG90eXBlICkgewoKCQl2YXIgd29ya2Zsb3c7CgoJCWlmIChpc1N0cmluZyggd29ya2Zsb3dQcm90b3R5cGUgKSkgewoKCQkJd29ya2Zsb3cgPSBidWlsZFdvcmtmbG93RnJvbVN0cmluZyggd29ya2Zsb3dQcm90b3R5cGUgKTsKCgkJfSBlbHNlIGlmIChpc0Z1bmN0aW9uKCB3b3JrZmxvd1Byb3RvdHlwZSApIHx8IChpc09iamVjdCggd29ya2Zsb3dQcm90b3R5cGUgKSAmJiB3b3JrZmxvd1Byb3RvdHlwZS5nZXQpKSB7CgoJCQl3b3JrZmxvdyA9IHdvcmtmbG93UHJvdG90eXBlOwoJCQlpZiAoaXNGdW5jdGlvbiggd29ya2Zsb3dQcm90b3R5cGUgKSkgewoKCQkJCXdvcmtmbG93ID0gZXh0ZW5kKAoJCQkJCXsKCQkJCQkJZ2V0OiB3b3JrZmxvd1Byb3RvdHlwZQoJCQkJCX0sCgkJCQkJd29ya2Zsb3cgKTsKCQkJfQoKCQl9IGVsc2UgewoJCQl0aHJvdyAiaW52YWxpZCB3b3JrZmxvdyBleHByZXNzaW9uIjsKCQl9CgoJCWNvbnZlcnRTdHJpbmdBY3Rpdml0eVRvRnVuY3Rpb24oICJpbml0aWFsaXplIiwgd29ya2Zsb3cgKTsKCQkvLwoJCWNvbnZlcnRTdHJpbmdBY2Nlc3NvclRvRnVuY3Rpb24oICJnZXQiLCB3b3JrZmxvdyApOwoJCWNvbnZlcnRTdHJpbmdBY2Nlc3NvclRvRnVuY3Rpb24oICJzZXQiLCB3b3JrZmxvdyApOwoJCS8vCgkJY29udmVydFN0cmluZ0FjdGl2aXR5VG9GdW5jdGlvbiggImNvbnZlcnQiLCB3b3JrZmxvdyApOwoJCWNvbnZlcnRTdHJpbmdBY3Rpdml0eVRvRnVuY3Rpb24oICJmaW5hbGl6ZSIsIHdvcmtmbG93ICk7CgoJCXJldHVybiB3b3JrZmxvdzsKCX0KCglmdW5jdGlvbiBidWlsZFdvcmtmbG93RnJvbVN0cmluZyggd29ya2Zsb3dTdHJpbmcgKSB7CgoJCXZhciB3b3JrZmxvdywKCQkJYWN0aXZpdHlOYW1lLAoJCQlhY3Rpdml0eU5hbWVzID0gd29ya2Zsb3dTdHJpbmcuc3BsaXQoIHJTcGFjZXMgKSwKCQkJYWN0aXZpdHlUeXBlOwoKCQlpZiAoYWN0aXZpdHlOYW1lcy5sZW5ndGggPiAxKSB7CgoJCQl3b3JrZmxvdyA9IHsgfTsKCgkJCWZvciAodmFyIGkgPSAwOyBpIDwgYWN0aXZpdHlUeXBlcy5sZW5ndGg7IGkrKykgewoJCQkJYWN0aXZpdHlOYW1lID0gYWN0aXZpdHlOYW1lc1tpXTsKCQkJCWFjdGl2aXR5VHlwZSA9IGFjdGl2aXR5VHlwZXNbaV07CgoJCQkJaWYgKGFjdGl2aXR5TmFtZSAmJiAoYWN0aXZpdHlOYW1lICE9PSAiXyIgJiYgYWN0aXZpdHlOYW1lICE9ICJudWxsIikpIHsKCQkJCQl3b3JrZmxvd1thY3Rpdml0eVR5cGVdID0gYWN0aXZpdHlOYW1lOwoJCQkJfQoJCQl9CgkJfSBlbHNlIHsKCQkJdGhyb3cgImludmFsaWQgd29ya2Zsb3cgdHlwZSI7CgkJfQoKCQlyZXR1cm4gd29ya2Zsb3c7Cgl9CgoJZnVuY3Rpb24gZ2V0QWN0aXZpdHlTZXQoIGFjdGl2aXR5VHlwZSApIHsKCQlyZXR1cm4gaG0uYWN0aXZpdHlbYWN0aXZpdHlUeXBlXTsKCX0KCgkvLyBwdWJsaXNoZXIsIHN1YnNjcmliZXIgaXMgb3B0aW9uYWwKCS8vYWNjZXNzb3IgZWl0aGVyICJnZXQiIG9yICJzZXQiCglmdW5jdGlvbiBjb252ZXJ0U3RyaW5nQWNjZXNzb3JUb0Z1bmN0aW9uKCBhY2Nlc3NvclR5cGUsIGhhbmRsZXIsIHB1Ymxpc2hlciwgc3Vic2NyaWJlciApIHsKCgkJLy9ieSBkZWZhdWx0IHdvcmtmbG93LmdldCA9PSAiZ2V0Iiwgd29ya2Zsb3cuc2V0ID0gInNldCIKCQl2YXIgYWNjZXNzb3JLZXkgPSBoYW5kbGVyW2FjY2Vzc29yVHlwZV07CgoJCWlmIChhY2Nlc3NvcktleSAmJiBpc1N0cmluZyggYWNjZXNzb3JLZXkgKSkgewoKCQkJdmFyIGFjY2Vzc29ycyA9IGdldEFjdGl2aXR5U2V0KCBhY2Nlc3NvclR5cGUgKTsKCgkJCWlmIChhY2Nlc3NvcktleS5zdGFydHNXaXRoKCAiKiIgKSkgewoKCQkJCWFjY2Vzc29yS2V5ID0gYWNjZXNzb3JLZXkuc3Vic3RyKCAxICk7CgkJCQloYW5kbGVyW2FjY2Vzc29yVHlwZV0gPSBhY2Nlc3NvcnNbYWNjZXNzb3JLZXldOwoKCQkJCWlmICghaGFuZGxlclthY2Nlc3NvclR5cGVdKSB7CgkJCQkJdGhyb3cgYWNjZXNzb3JLZXkgKyAiIGRvZXMgbm90IGV4aXN0cyAiICsgYWNjZXNzb3JUeXBlICsgIiBBY3Rpdml0eSI7CgkJCQl9CgoJCQl9IGVsc2UgaWYgKGFjY2Vzc29yS2V5LnN0YXJ0c1dpdGgoICIjIiApKSB7CgoJCQkJaGFuZGxlclthY2Nlc3NvclR5cGVdID0gZ2V0RW1iZWRkZWRBY3Rpdml0eSggYWNjZXNzb3JLZXksIHB1Ymxpc2hlciwgc3Vic2NyaWJlciApOwoKCQkJfSBlbHNlIHsKCgkJCQl2YXIga2V5cyA9IGFjY2Vzc29yS2V5LnNwbGl0KCAiKiIgKTsKCgkJCQkvL3VzZSBkZWZhdWx0R2V0IG9yIGRlZmF1bHRTZXQgYW5kIHBhcnNlU3VicywgaWYgYWNjZXNzb3JLZXkgZG9lcyBub3QgYmVnaW4gd2l0aCAiKiIKCQkJCS8vIGhhbmRsZXIuc2V0UHJvcGVydHkgPSBhY2Nlc3NvcktleSBvcgoJCQkJLy8gaGFuZGxlci5nZXRQcm9wZXJ0eSA9IGFjY2Vzc29yS2V5CgkJCQloYW5kbGVyW2FjY2Vzc29yVHlwZV0gPSBhY2Nlc3NvclR5cGUgPT0gImdldCIgPyBnZXRNZW1iZXIgOiBzZXRNZW1iZXI7CgkJCQloYW5kbGVyW2FjY2Vzc29yVHlwZSArICJOYW1lIl0gPSBrZXlzWzBdOwoKCQkJCWlmIChrZXlzWzFdKSB7CgkJCQkJLy9hY2Nlc3NvcktleSA9ICJjc3MqY29sb3IiCgkJCQkJaGFuZGxlclthY2Nlc3NvclR5cGUgKyAiUGFyYXMiXSA9IGtleXNbMV07CgkJCQl9CgoJCQkJaWYgKCFpc1VuZGVmaW5lZCggcHVibGlzaGVyICkgJiYgIWlzVW5kZWZpbmVkKCBzdWJzY3JpYmVyICkpIHsKCQkJCQl2YXIgcHVibGlzaGVyT3JTdWJzY3JpYmVyID0gYWNjZXNzb3JUeXBlID09ICJnZXQiID8gcHVibGlzaGVyIDogc3Vic2NyaWJlcjsKCQkJCQllbnN1cmVUYXJnZXRIYXNBY2Nlc3NvciggYWNjZXNzb3JUeXBlLCBrZXlzWzBdLCBwdWJsaXNoZXJPclN1YnNjcmliZXIgKTsKCQkJCX0KCQkJfQoJCX0KCX0KCglmdW5jdGlvbiBlbnN1cmVUYXJnZXRIYXNBY2Nlc3NvciggYWNjZXNzb3JUeXBlLCBhY3Rpdml0eU5hbWUsIHRhcmdldCApIHsKCQl2YXIgbWlzc2luZ01lbWJlcjsKCQlpZiAoaXNTdHJpbmcoIHRhcmdldCApKSB7CgoJCQlpZiAoIWhtRm5bYWN0aXZpdHlOYW1lXSkgewoKCQkJCW1pc3NpbmdNZW1iZXIgPSB0cnVlOwoJCQl9CgoJCX0gZWxzZSB7CgkJCWlmICh0YXJnZXQubm9kZVR5cGUpIHsKCQkJCWlmICghJGZuW2FjdGl2aXR5TmFtZV0pIHsKCQkJCQltaXNzaW5nTWVtYmVyID0gdHJ1ZTsKCQkJCX0KCQkJfSBlbHNlIGlmICghKGFjdGl2aXR5TmFtZSBpbiB0YXJnZXQpKSB7CgkJCQltaXNzaW5nTWVtYmVyID0gdHJ1ZTsKCQkJfQoJCX0KCgkJaWYgKG1pc3NpbmdNZW1iZXIpIHsKCQkJdGhyb3cgKGFjY2Vzc29yVHlwZSA9PSAiZ2V0IiA/ICJwdWJsaXNoZXIiIDogInN1YnNjcmliZXIiKSArCgkJCSAgICAgICIgZG9lcyBub3QgaGF2ZSBhIG1lbWJlciAiICsgYWN0aXZpdHlOYW1lOwoJCX0KCX0KCgkvL2FjdGl2aXR5VHlwZSBpcyBsaWtlIGluaXRpYWxpemUsIGNvbnZlcnQsIGZpbmFsaXplCgkvL2FjdGl2aXR5VHlwZSBmb3IgImdldCIsICJzZXQiIGlzIHRha2VuIGNhcmUgYnkgY29udmVydFN0cmluZ0FjY2Vzc29yVG9GdW5jdGlvbgoJZnVuY3Rpb24gY29udmVydFN0cmluZ0FjdGl2aXR5VG9GdW5jdGlvbiggYWN0aXZpdHlUeXBlLCBoYW5kbGVyLCBwdWJsaXNoZXIsIHN1YnNjcmliZXIgKSB7CgkJLy9iZWNhdXNlIGl0IGlzIG9wdGlvbmFsLCB3ZSBuZWVkIG1ha2Ugc3VyZSBoYW5kbGVyIHdhbnQgdG8gaGF2ZSB0aGlzIG1ldGhvZAoJCXZhciBhY3Rpdml0eU5hbWUgPSBoYW5kbGVyW2FjdGl2aXR5VHlwZV07CgkJaWYgKGlzU3RyaW5nKCBhY3Rpdml0eU5hbWUgKSkgewoKCQkJaWYgKGFjdGl2aXR5TmFtZS5zdGFydHNXaXRoKCAiKiIgKSkgewoJCQkJaGFuZGxlclthY3Rpdml0eVR5cGVdID0gZ2V0QWN0aXZpdHlTZXQoIGFjdGl2aXR5VHlwZSApW2FjdGl2aXR5TmFtZS5zdWJzdHIoIDEgKV07CgkJCQlpZiAoIWhhbmRsZXJbYWN0aXZpdHlUeXBlXSkgewoJCQkJCXRocm93ICBhY3Rpdml0eU5hbWUgKyAiQWN0aXZpdHkgZG9lcyBub3QgZXhpc3RzIjsKCQkJCX0KCgkJCX0gZWxzZSBpZiAoYWN0aXZpdHlOYW1lLnN0YXJ0c1dpdGgoICIjIiApKSB7CgoJCQkJaGFuZGxlclthY3Rpdml0eVR5cGVdID0gZ2V0RW1iZWRkZWRBY3Rpdml0eSggYWN0aXZpdHlOYW1lLCBwdWJsaXNoZXIsIHN1YnNjcmliZXIgKTsKCgkJCX0gZWxzZSB7CgkJCQl0aHJvdyAnYWN0aXZpdHkgb3RoZXIgdGhhbiAiZ2V0IiBhbmQgInNldCIgIG11c3QgYmVnaW4gd2l0aCAiKiIgb3IgIiMiICc7CgoJCQl9CgkJfQoJfQoKCWZ1bmN0aW9uIHVuc3Vic2NyaWJlKCB0YXJnZXQgKSB7CgkJaWYgKGlzT2JqZWN0KCB0YXJnZXQgKSkgewoJCQlpZiAoIXZpZXdJZE1hbmFnZXIuZ2V0SWQoIHRhcmdldCApKSB7CgkJCQlyZXR1cm47CgkJCX0KCQkJdmlld0lkTWFuYWdlci51bk1hcmsoIHRhcmdldCApOwoJCX0KCQlzdWJzY3JpcHRpb25NYW5hZ2VyLnJlbW92ZUJ5KCB0YXJnZXQgKTsKCX0KCglobS5vbkRlbGV0ZU5vZGUoIHVuc3Vic2NyaWJlICk7CgoJLy9zdWJzY3JpcHRpb24gc2hvcnRjdXQgbWV0aG9kIGZvciBtb2RlbAoJZXh0ZW5kKCBobUZuLCB7CgoJCXRyaWdnZXI6IGZ1bmN0aW9uKCBzdWJQYXRoLCBldmVudE5hbWUsIHByb3Bvc2VkLCByZW1vdmVkICkgewoKCQkJaWYgKCFhcmd1bWVudHMubGVuZ3RoKSB7CgkJCQl0aHJvdyAibWlzc2luZyBhcmd1bWVudHMiOwoJCQl9CgoJCQlpZiAoYXJndW1lbnRzLmxlbmd0aCA8PSAzKSB7CgkJCQlyZW1vdmVkID0gcHJvcG9zZWQ7CgkJCQlwcm9wb3NlZCA9IGV2ZW50TmFtZTsKCQkJCWV2ZW50TmFtZSA9IHN1YlBhdGg7CgkJCQlzdWJQYXRoID0gIiI7CgkJCX0KCgkJCXZhciBwaHlzaWNhbFBhdGggPSB0aGlzLnBoeXNpY2FsUGF0aCggc3ViUGF0aCApOwoJCQl0cmlnZ2VyKCBwaHlzaWNhbFBhdGgsIHBoeXNpY2FsUGF0aCwgZXZlbnROYW1lLCBwcm9wb3NlZCwgcmVtb3ZlZCApOwoJCQlyZXR1cm4gdGhpczsKCQl9LAoKCQljaGFuZ2U6IGZ1bmN0aW9uKCBzdWJQYXRoICkgewoJCQl2YXIgcGh5c2ljYWxQYXRoID0gdGhpcy5waHlzaWNhbFBhdGgoIHN1YlBhdGggKSwKCQkJCXZhbHVlID0gdGhpcy5nZXQoIHN1YlBhdGggKTsKCQkJdHJpZ2dlciggcGh5c2ljYWxQYXRoLCBwaHlzaWNhbFBhdGgsICJhZnRlclVwZGF0ZSIsIHZhbHVlLCB2YWx1ZSApOwoJCQlyZXR1cm4gdGhpczsKCQl9LAoKCQlzdWI6IGZ1bmN0aW9uKCBwdWJsaXNoZXIsIGV2ZW50cywgaGFuZGxlciwgb3B0aW9ucywgZGVsZWdhdGVTZWxlY3RvciApIHsKCQkJaG0uc3ViKCB0aGlzLnBhdGgsIHB1Ymxpc2hlciwgZXZlbnRzLCBoYW5kbGVyLCBvcHRpb25zLCBkZWxlZ2F0ZVNlbGVjdG9yICk7CgkJCXJldHVybiB0aGlzOwoJCX0sCgoJCWhhbmRsZTogZnVuY3Rpb24oIGV2ZW50VHlwZXMsIHdvcmtmbG93LCB3b3JrZmxvd09wdGlvbnMsIGRlbGVnYXRlICkgewoJCQlobS5zdWIoIG51bGwsIHRoaXMsIGV2ZW50VHlwZXMsIHdvcmtmbG93LCB3b3JrZmxvd09wdGlvbnMsIGRlbGVnYXRlICk7CgkJCXJldHVybiB0aGlzOwoJCX0sCgoJCXN1YkJ5OiBmdW5jdGlvbiggc3Vic2NyaWJlciwgZXZlbnRzLCBoYW5kbGVyLCBvcHRpb25zLCBkZWxlZ2F0ZVNlbGVjdG9yICkgewoJCQlobS5zdWIoIHN1YnNjcmliZXIsIHRoaXMucGF0aCwgZXZlbnRzLCBoYW5kbGVyLCBvcHRpb25zLCBkZWxlZ2F0ZVNlbGVjdG9yICk7CgkJCXJldHVybiB0aGlzOwoJCX0sCgoJCXN1YnNUb01lOiBmdW5jdGlvbiggcHJpbnQgKSB7CgkJCXZhciBydG4gPSBzdWJzY3JpcHRpb25NYW5hZ2VyLmdldEJ5UHVibGlzaGVyKCB0aGlzLnBhdGggKTsKCQkJLy8jZGVidWcKCQkJaWYgKHByaW50ICYmIGhtLnByaW50U3Vic2NyaXB0aW9ucykgewoJCQkJaG0ucHJpbnRTdWJzY3JpcHRpb25zKCB0aGlzLnBhdGgsIHJ0biwgInRvTWUiICk7CgkJCX0KCQkJLy8jZW5kX2RlYnVnCgoJCQlyZXR1cm4gcnRuOwoJCX0sCgoJCXN1YnNGcm9tTWU6IGZ1bmN0aW9uKCBwcmludCApIHsKCQkJdmFyIHJ0biA9IHN1YnNjcmlwdGlvbk1hbmFnZXIuZ2V0QnlTdWJzY3JpYmVyKCB0aGlzLnBhdGggKTsKCQkJLy8jZGVidWcKCQkJaWYgKHByaW50ICYmIGhtLnByaW50U3Vic2NyaXB0aW9ucykgewoJCQkJaG0ucHJpbnRTdWJzY3JpcHRpb25zKCB0aGlzLnBhdGgsIHJ0biwgImZyb21NZSIgKTsKCQkJfQoJCQkvLyNlbmRfZGVidWcKCgkJCXJldHVybiBydG47CgkJfSwKCgkJc3ViczogZnVuY3Rpb24oIHByaW50ICkgewoJCQl2YXIgcnRuID0gc3Vic2NyaXB0aW9uTWFuYWdlci5nZXRCeSggdGhpcy5wYXRoICk7CgoJCQkvLyNkZWJ1ZwoJCQlpZiAocHJpbnQgJiYgaG0ucHJpbnRTdWJzY3JpcHRpb25zKSB7CgkJCQlobS5wcmludFN1YnNjcmlwdGlvbnMoIHRoaXMucGF0aCwgcnRuICk7CgkJCX0KCQkJLy8jZW5kX2RlYnVnCgoJCQlyZXR1cm4gcnRuOwoJCX0sCgoJCS8qCgkJIG1hcCBhbiBtb2RlbCBldmVudCB0byBhIG5ldyBtb2RlbCBldmVudCBiYXNlZCBvbiBhIGNvbmRpdGlvbiwgbGlrZSB0aGUgZm9sbG93aW5nCgoJCSBobSgiaW52ZW50b3J5IikubWFwRXZlbnQoCgkJICJhZnRlclVwZGF0ZSIsCgkJICJpbnZlbnRvcnlMb3ciLAoJCSBmdW5jdGlvbiAodmFsdWUpIHsKCQkgcmV0dXJuIHZhbHVlIDw9IDEwMDsKCQkgfQoJCSApOwoKCQkgY29uZGl0aW9uIGlzIG9wdGlvbmFsLCBpZiBpdCBpcyBtaXNzaW5nLCB0aGUgdGFyZ2V0IGV2ZW50IHdpbGwgYWx3YXlzIGJlIHRyaWdnZXJlZAoJCSB3aGVuIHRoZSBzb3VyY2UgZXZlbnQgaXMgdHJpZ2dlcmVkCgkJICovCgkJbWFwRXZlbnQ6IGZ1bmN0aW9uKCBzb3VyY2VFdmVudCwgdGFyZ2V0RXZlbnQsIGNvbmRpdGlvbiApIHsKCQkJY29uZGl0aW9uID0gY29uZGl0aW9uIHx8IHJldHVyblRydWU7CgkJCWhtLmhhbmRsZSggdGhpcy5wYXRoLCBzb3VyY2VFdmVudCwgZnVuY3Rpb24oIGUgKSB7CgkJCQlpZiAoY29uZGl0aW9uLmNhbGwoIHRoaXMsIGUgKSkgewoJCQkJCWUucHVibGlzaGVyLnRyaWdnZXIoIHRhcmdldEV2ZW50LCBlLnByb3Bvc2VkLCBlLnJlbW92ZWQgKTsKCQkJCX0KCQkJfSApOwoJCQlyZXR1cm4gdGhpczsKCQl9LAoKCQljYWNoZWFibGU6IGZ1bmN0aW9uKCBzdWJQYXRoICkgewoJCQlobS5oYW5kbGUoIHRoaXMuZ2V0UGF0aCggc3ViUGF0aCApLCAiaW5pdCBhZnRlcioiLCAiKnNhdmVMb2NhbCIgKTsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCX0gKTsKCgkvL3N1YnNjcmlwdGlvbiBzaG9ydGN1dCBtZXRob2QgZm9yIGpRdWVyeSBvYmplY3QKCWV4dGVuZCggJGZuLCB7CgoJCXN1YjogZnVuY3Rpb24oIHB1Ymxpc2hlciwgZXZlbnRzLCBoYW5kbGVyLCBvcHRpb25zLCBkZWxlZ2F0ZSApIHsKCQkJaWYgKHRoaXMubGVuZ3RoKSB7CgkJCQlobS5zdWIoIHRoaXMsIHB1Ymxpc2hlciwgZXZlbnRzLCBoYW5kbGVyLCBvcHRpb25zLCBkZWxlZ2F0ZSApOwoJCQl9CgkJCXJldHVybiB0aGlzOwoJCX0sCgoJCWhhbmRsZTogZnVuY3Rpb24oIGV2ZW50VHlwZXMsIHdvcmtmbG93LCB3b3JrZmxvd09wdGlvbnMsIGRlbGVnYXRlICkgewoJCQlpZiAodGhpcy5sZW5ndGgpIHsKCQkJCWhtLnN1YiggbnVsbCwgdGhpcywgZXZlbnRUeXBlcywgd29ya2Zsb3csIHdvcmtmbG93T3B0aW9ucywgZGVsZWdhdGUgKTsKCQkJfQoJCQlyZXR1cm4gdGhpczsKCQl9LAoKCQlzdWJCeTogZnVuY3Rpb24oIHN1YnNjcmliZXIsIGV2ZW50cywgaGFuZGxlciwgb3B0aW9ucywgZGVsZWdhdGUgKSB7CgkJCWlmICh0aGlzLmxlbmd0aCkgewoJCQkJaG0uc3ViKCBzdWJzY3JpYmVyLCB0aGlzLCBldmVudHMsIGhhbmRsZXIsIG9wdGlvbnMsIGRlbGVnYXRlICk7CgkJCX0KCQkJcmV0dXJuIHRoaXM7CgkJfSwKCgkJc3Vic1RvTWU6IGZ1bmN0aW9uKCBwcmludCApIHsKCQkJdmFyIHJ0biA9IHN1YnNjcmlwdGlvbk1hbmFnZXIuZ2V0QnlQdWJsaXNoZXIoIHRoaXNbMF0gKTsKCgkJCS8vI2RlYnVnCgkJCWlmIChwcmludCAmJiBobS5wcmludFN1YnNjcmlwdGlvbnMpIHsKCQkJCWhtLnByaW50U3Vic2NyaXB0aW9ucyggdGhpc1swXSwgcnRuLCAidG9NZSIgKTsKCQkJfQoJCQkvLyNlbmRfZGVidWcKCgkJCXJldHVybiBydG47CgkJfSwKCgkJc3Vic0Zyb21NZTogZnVuY3Rpb24oIHByaW50ICkgewoJCQl2YXIgcnRuID0gc3Vic2NyaXB0aW9uTWFuYWdlci5nZXRCeVN1YnNjcmliZXIoIHRoaXNbMF0gKTsKCgkJCS8vI2RlYnVnCgkJCWlmIChwcmludCAmJiBobS5wcmludFN1YnNjcmlwdGlvbnMpIHsKCQkJCWhtLnByaW50U3Vic2NyaXB0aW9ucyggdGhpc1swXSwgcnRuLCAiZnJvbU1lIiApOwoJCQl9CgkJCS8vI2VuZF9kZWJ1ZwoKCQkJcmV0dXJuIHJ0bjsKCQl9LAoKCQlzdWJzOiBmdW5jdGlvbiggcHJpbnQgKSB7CgkJCXZhciBydG4gPSBzdWJzY3JpcHRpb25NYW5hZ2VyLmdldEJ5KCB0aGlzWzBdICk7CgoJCQkvLyNkZWJ1ZwoJCQlpZiAocHJpbnQgJiYgaG0ucHJpbnRTdWJzY3JpcHRpb25zKSB7CgkJCQlobS5wcmludFN1YnNjcmlwdGlvbnMoIHRoaXNbMF0sIHJ0biApOwoJCQl9CgkJCS8vI2VuZF9kZWJ1ZwoKCQkJcmV0dXJuIHJ0bjsKCQl9LAoKCQlyZW5kZXJWaWV3OiBmdW5jdGlvbiggcGF0aCwgd29ya2Zsb3csIG9wdGlvbnMgKSB7CgkJCWhtLnN1YiggdGhpcywgcGF0aCwgImluaXQiLCB3b3JrZmxvdywgb3B0aW9ucyApOwoJCQlyZXR1cm4gdGhpczsKCQl9LAoKCQkvKgoJCSBtYXAgYSB2aWV3IGV2ZW50IHRvIGEgbmV3IHZpZXcgZXZlbnQgYmFzZWQgb24gYSBjb25kaXRpb24sIGNvbmRpdGlvbiBpcyBvcHRpb25hbCwKCQkgaWYgaXQgaXMgbWlzc2luZywgdGhlIHRhcmdldCBldmVudCB3aWxsIGFsd2F5cyBiZSB0cmlnZ2VyZWQgd2hlbiB0aGUgc291cmNlCgkJIGV2ZW50IGlzIHRyaWdnZXJlZAoKCQkgdXNhZ2UKCQkgJCgiYnV0dG9uIikubWFwRXZlbnQoImNsaWNrIiwgInVwZGF0ZSIpOwoJCSAqLwoJCW1hcEV2ZW50OiBmdW5jdGlvbiggc291cmNlRXZlbnQsIHRhcmdldEV2ZW50LCBjb25kaXRpb24sIGV2ZW50RGF0YSApIHsKCQkJaWYgKGNvbmRpdGlvbikgewoJCQkJaWYgKCFpc0Z1bmN0aW9uKCBjb25kaXRpb24gKSkgewoJCQkJCWV2ZW50RGF0YSA9IGNvbmRpdGlvbjsKCQkJCQljb25kaXRpb24gPSByZXR1cm5UcnVlOwoJCQkJfQoJCQl9IGVsc2UgewoJCQkJY29uZGl0aW9uID0gcmV0dXJuVHJ1ZTsKCQkJfQoKCQkJcmV0dXJuIHRoaXMuaGFuZGxlKCBzb3VyY2VFdmVudCwgZnVuY3Rpb24oIGUgKSB7CgkJCQlpZiAoY29uZGl0aW9uLmNhbGwoIHRoaXMsIGUgKSkgewoJCQkJCWUudHlwZSA9IHRhcmdldEV2ZW50OwoJCQkJCWUuZXZlbnREYXRhID0gZXZlbnREYXRhOwoJCQkJCWUucHVibGlzaGVyLnRyaWdnZXIoIGUgKTsKCQkJCX0KCQkJfSApOwoJCX0KCX0gKTsKCgkvLyBjcmVhdGUgYSBzcGVjaWFsIGpRdWVyeSBldmVudCAoeSkgYmFzZWQgb24gYW4gZXhpc3RpbmcgalF1ZXJ5IGV2ZW50ICh4KQoJLy8gd2hlbiBldmVudCB4IGlzIHJhaXNlZCwgYW5kIGNvbmRpdGlvbiByZXR1cm5zIHRydWUsIGV2ZW50IHkgd2lsbCBiZSByYWlzZWQKCS8vCgkvLyB5b3UgY2FuIHN1YnNjcmliZSBldmVudCB5LCBqdXN0IGxpa2UgYW55IG90aGVyIGpRdWVyeSBldmVudCB1c2luZwoJLy8kKCJidXR0b24iKS5iaW5kKCJ5IiwgZm4pOwoJLy8KCS8vdW5saWtlICQoKS5tYXBFdmVudCgiY2xpY2siLCAieSIpLCB0aGlzIG1ldGhvZCBjcmVhdGUgYSBuZXcgZXZlbnQgdHlwZSBmb3IgYWxsCgkvL2pRdWVyeSBvYmplY3QKCWhtLm5ld0pxRXZlbnQgPSBmdW5jdGlvbiggZXZlbnQsIGJhc2VFdmVudCwgY29uZGl0aW9uICkgewoJCWlmIChpc09iamVjdCggZXZlbnQgKSkgewoJCQlmb3IgKHZhciBrZXkgaW4gZXZlbnQpIHsKCQkJCWhtLm5ld0pxRXZlbnQoIGtleSwgZXZlbnRba2V5XVswXSwgZXZlbnRba2V5XVsxXSApOwoJCQl9CgkJCXJldHVybiB0aGlzOwoJCX0KCQl2YXIgaGFuZGxlciA9IGZ1bmN0aW9uKCBlICkgewoJCQlpZiAoY29uZGl0aW9uID09PSB0cnVlIHx8IGNvbmRpdGlvbi5jYWxsKCB0aGlzLCBlICkpIHsKCQkJCSQoIGUudGFyZ2V0ICkudHJpZ2dlciggZXh0ZW5kKCB7fSwgZSwgewoJCQkJCXR5cGU6IGV2ZW50LAoJCQkJCWN1cnJlbnRUYXJnZXQ6IGUudGFyZ2V0CgkJCQl9ICkgKTsKCQkJfQoJCX07CgoJCWlmICgkLmV2ZW50LnNwZWNpYWxbZXZlbnRdKSB7CgkJCXRocm93ICJldmVudCAnIiArIGV2ZW50ICsgIicgaGFzIGJlZW4gZGVmaW5lZCI7CgkJfQoKCQkkLmV2ZW50LnNwZWNpYWxbZXZlbnRdID0gewoJCQlzZXR1cDogZnVuY3Rpb24oKSB7CgkJCQkkKCB0aGlzICkuYmluZCggYmFzZUV2ZW50LCBoYW5kbGVyICk7CgkJCX0sCgkJCXRlYXJkb3duOiBmdW5jdGlvbigpIHsKCQkJCSQoIHRoaXMgKS51bmJpbmQoIGJhc2VFdmVudCwgaGFuZGxlciApOwoJCQl9CgkJfTsKCQlyZXR1cm4gdGhpczsKCX07CgoJdmFyIF9jbGVhbkRhdGFGb3JVbnN1YnNjcmliZSA9ICQuY2xlYW5EYXRhOwoJLy93aGVuIGFuIGRvbSBlbGVtZW50IGlzIHJlbW92ZSB1bnN1YnNjcmliZSBpdCBmaXJzdAoJJC5jbGVhbkRhdGEgPSBmdW5jdGlvbiggZWxlbXMgKSB7CgkJJCggZWxlbXMgKS5lYWNoKCBmdW5jdGlvbigpIHsKCQkJdW5zdWJzY3JpYmUoIHRoaXMgKTsKCQl9ICk7CgkJX2NsZWFuRGF0YUZvclVuc3Vic2NyaWJlKCBlbGVtcyApOwoJfTsKCgl1dGlsLmdldFVuaXF1ZVZpZXdFdmVudFR5cGVzID0gYnVpbGRVbmlxdWVWaWV3RXZlbnRUeXBlczsKCXV0aWwuX3ZpZXdIYW5kbGVyR2F0ZXdheSA9IHZpZXdIYW5kbGVyR2F0ZXdheTsKCgkvLyNkZWJ1ZwoJaG0uZGVidWcuZ2V0TWF0Y2hlZFN1YnNjcmliZWRFdmVudCA9IGdldE1hdGNoZWRTdWJzY3JpYmVkRXZlbnQ7CglobS5kZWJ1Zy5idWlsZFdvcmtmbG93VHlwZSA9IGJ1aWxkV29ya2Zsb3c7CglobS5kZWJ1Zy5nZXRNZW1iZXIgPSBnZXRNZW1iZXI7CglobS5kZWJ1Zy5zZXRNZW1iZXIgPSBzZXRNZW1iZXI7CglobS5kZWJ1Zy51bnN1YiA9IGZ1bmN0aW9uKCBvYmplY3QgKSB7CgkJdW5zdWJzY3JpYmUoIG9iamVjdCApOwoJfTsKCS8vI2VuZF9kZWJ1ZwoKCi8vCi8vPEBkZXBlbmRzPnN1YnNjcmlwdGlvbi5qcywgbW9kZWwuanM8L0BkZXBlbmRzPgoKCgl2YXIgclN1YnNjcmlwdGlvblByb3BlcnR5ID0gLyhbISRdPykoW1x3IFwrXC1cKlwuXSs/KTooW1x3XFddKz8pXHMqKD86WztdXHMqfCQpL2csCgkJckJpbmRpbmdUZXh0ID0gL14oW158XSspKFx8KC4qKSk/JC8sCgkJclN1YnNjcmlwdGlvblZhbHVlU2VwYXJhdG9yID0gL1xzKlx8XHMqL2c7CgoJZGVmYXVsdE9wdGlvbnMuc3Vic0F0dHIgPSAiZGF0YS1zdWIiOwoJZGVmYXVsdE9wdGlvbnMuYXV0b1BhcnNlID0gdHJ1ZTsKCglmdW5jdGlvbiBtZXJnZU9wdGlvbnMoIHBhcmVudE9wdGlvbnMsIGxvY2FsT3B0aW9ucyApIHsKCQlpZiAobG9jYWxPcHRpb25zICE9PSAiXyIpIHsKCQkJcmV0dXJuICAobG9jYWxPcHRpb25zICYmIGxvY2FsT3B0aW9ucy5zdGFydHNXaXRoKCAiXyIgKSkgPwoJCQkJbG9jYWxPcHRpb25zLnN1YnN0ciggMSApIDoKCQkJCXBhcmVudE9wdGlvbnMgfHwgbG9jYWxPcHRpb25zOwoJCX0KCX0KCglmdW5jdGlvbiBnZXRJbmhlcml0ZWROYW1lc3BhY2UoIGVsZW0gKSB7CgoJCXZhciAkcGFyZW50ID0gJCggZWxlbSApOwoKCQl3aGlsZSAoKCRwYXJlbnQgPSAkcGFyZW50LnBhcmVudCgpKSAmJiAkcGFyZW50Lmxlbmd0aCkgewoKCQkJdmFyIG5zID0gJHBhcmVudC5obURhdGEoICJucyIgKTsKCgkJCWlmICghaXNVbmRlZmluZWQoIG5zICkpIHsKCQkJCXJldHVybiBuczsKCQkJfQoJCX0KCQlyZXR1cm4gIiI7Cgl9CgoJdmFyIHJlVW5kZXJzY29yZSA9IC9fL2c7Cgl2YXIgcmVBdHRyRGFzaCA9IC8tKFx3KS9nOwoJdmFyIHJEYXRhQXR0clByZWZpeCA9IC9eZGF0YS0vOwoKCXZhciByZXBsYWNlQXR0ckRhc2hXaXRoQ2FwaXRhbENoYXJhY3RlciA9IGZ1bmN0aW9uKCBtYXRjaCwgJDEgKSB7CgkJcmV0dXJuICQxLnRvVXBwZXJDYXNlKCk7Cgl9OwoKCS8vY29udmVydCBhZGQtY2xhc3MgdG8gYWRkQ2xhc3MKCS8vY29udmVydCAkZW50ZXJfYmx1ciB0byAkZW50ZXIgYmx1cgoJZnVuY3Rpb24gbm9ybWFsaXplQXR0cmlidXRlTmFtZSggYXR0cmlidXRlTmFtZSApIHsKCQlhdHRyaWJ1dGVOYW1lID0gYXR0cmlidXRlTmFtZS5yZXBsYWNlKCByRGF0YUF0dHJQcmVmaXgsICIiICk7CgoJCS8vaWYgc3Vic2NyaXB0aW9uIGludm9sdmUgd2l0aCBtb3JlIHRoYW4gb25lIGV2ZW50cywgeW91IGNhbgoJCS8vY29uY2F0ZW5hdGUgdGhlbSB3aXRoICJfIiwgaGVyZSB3ZSBuZWVkIHRvIHJldmVydCB0aGVtIGJhY2sKCQkvL3N1Y2ggYXMgIiRjbGlja19tb3VzZW92ZXIiIG5lZWQgdG8gYmUgY2hhbmdlZCB0byAiJGNsaWNrIG1vdXNlb3ZlciIKCQlpZiAoYXR0cmlidXRlTmFtZS5zdGFydHNXaXRoKCAiISIgKSB8fCBhdHRyaWJ1dGVOYW1lLnN0YXJ0c1dpdGgoICIkIiApKSB7CgoJCQlhdHRyaWJ1dGVOYW1lID0gYXR0cmlidXRlTmFtZS5yZXBsYWNlKCByZVVuZGVyc2NvcmUsICIgIiApOwoKCQl9CgkJcmV0dXJuIGF0dHJpYnV0ZU5hbWUucmVwbGFjZSggcmVBdHRyRGFzaCwgcmVwbGFjZUF0dHJEYXNoV2l0aENhcGl0YWxDaGFyYWN0ZXIgKTsKCX0KCglmdW5jdGlvbiBleHRyYWN0U3Vic2NyaXB0aW9uVGV4dCggZWxlbSApIHsKCQlpZiAoZWxlbS5ub2RlVHlwZSAhPT0gMSkgewoJCQlyZXR1cm47CgkJfQoJCXZhciBpLAoJCQlhdHRyLAoJCQlhdHRyaWJ1dGVOYW1lLAoJCQlhdHRyaWJ1dGVzID0gZWxlbS5hdHRyaWJ1dGVzLAoJCQlzdWJzY3JpcHRpb25UZXh0ID0gYXR0cmlidXRlc1tkZWZhdWx0T3B0aW9ucy5zdWJzQXR0cl0gJiYgYXR0cmlidXRlc1tkZWZhdWx0T3B0aW9ucy5zdWJzQXR0cl0ubm9kZVZhbHVlIHx8ICIiOwoKCQlmb3IgKGkgPSAwOyBpIDwgYXR0cmlidXRlcy5sZW5ndGg7IGkrKykgewoJCQlhdHRyID0gYXR0cmlidXRlc1tpXTsKCQkJaWYgKGF0dHIubmFtZSAhPT0gZGVmYXVsdE9wdGlvbnMuc3Vic0F0dHIpIHsKCQkJCWF0dHJpYnV0ZU5hbWUgPSBub3JtYWxpemVBdHRyaWJ1dGVOYW1lKCBhdHRyLm5hbWUgKTsKCQkJCS8vaWYgYXR0cmlidXRlTmFtZSBpcyByZWNvZ25pemVkIGJ5IHRoZSBIbS5qcywKCQkJCS8vIHN1Y2ggYXMgbnM9Inh4eCIsIGJpbmRpbmdOYW1lPSJ4eHgiLCAhZXZlbnQ9Inh4eCIgLCAkZXZlbnQ9Inh4eCIKCQkJCS8vZXh0cmFjdCB0aGVtIGFuZCBhcHBlbmQgdG8gdGhlIHN1YnNjcmlwdGlvbiB0ZXh0CgkJCQlpZiAoYXR0cmlidXRlTmFtZSA9PSAibnMiIHx8IF9iaW5kaW5nc1thdHRyaWJ1dGVOYW1lXSkgewoJCQkJCS8vaWYgdGhlIGF0dHJpYnV0ZSBkb2VzIG5vdCBoYXZlIGEgdmFsdWUgbGlrZSA8ZGl2IGRlYnVnPgoJCQkJCS8vaXQgaXMgdGhlIHNhbWUgYXMgPGRpdiBkZWJ1Zz0iLyI+CgkJCQkJc3Vic2NyaXB0aW9uVGV4dCA9IHN1YnNjcmlwdGlvblRleHQgKyAiOyIgKyBhdHRyaWJ1dGVOYW1lICsgIjoiICsgKGF0dHIubm9kZVZhbHVlIHx8ICIvIik7CgoJCQkJfSBlbHNlIGlmIChhdHRyaWJ1dGVOYW1lLnN0YXJ0c1dpdGgoICIhIiApIHx8IGF0dHJpYnV0ZU5hbWUuc3RhcnRzV2l0aCggIiQiICkpIHsKCQkJCQl2YXIgbm9kZVZhbHVlcyA9IGF0dHIubm9kZVZhbHVlLnNwbGl0KCAiOyIgKTsKCQkJCQlmb3IgKHZhciBqID0gMDsgaiA8IG5vZGVWYWx1ZXMubGVuZ3RoOyBqKyspIHsKCQkJCQkJdmFyIG5vZGVWYWx1ZSA9IG5vZGVWYWx1ZXNbal07CgkJCQkJCXN1YnNjcmlwdGlvblRleHQgPSBzdWJzY3JpcHRpb25UZXh0ICsgIjsiICsgYXR0cmlidXRlTmFtZSArICI6IiArIG5vZGVWYWx1ZTsKCQkJCQl9CgkJCQl9CgkJCX0KCQl9CgoJCXZhciB0YWdCaW5kaW5nTmFtZSA9ICJ0YWdfIiArIGVsZW0udGFnTmFtZTsKCQlpZiAoX2JpbmRpbmdzW3RhZ0JpbmRpbmdOYW1lXSkgewoJCQlzdWJzY3JpcHRpb25UZXh0ID0gc3Vic2NyaXB0aW9uVGV4dCArICI7IiArIHRhZ0JpbmRpbmdOYW1lICsgIjouIjsKCQl9CgkJcmV0dXJuIHN1YnNjcmlwdGlvblRleHQucmVwbGFjZSggL147LywgIiIgKTsKCX0KCgkvL3N1cHBvcnQKCS8vbmV3IEJpbmRpbmcoKQoJLy9uZXcgQmluZGluZyhzdWJzY3JpcHRpb25UZXh0LCBwYXJlbnRCaW5kaW5nKQoJLy9uZXcgQmluZGluZygiJGNsaWNrfCphbGVydDt2YWw6cGF0aCIsIHBhcmVudEJpbmRpbmcpOwoJZnVuY3Rpb24gQmluZGluZyggc3Vic2NyaXB0aW9uVGV4dCwgcGFyZW50QmluZGluZywgYmluZGluZ05zLCBiaW5kaW5nT3B0aW9ucyApIHsKCgkJdmFyIG5zUHJvcGVydHksIG1hdGNoLCBlbXB0eUJpbmRpbmc7CgoJCS8vaGFuZGxlIHRoZSBjYXNlOiBuZXcgQmluZGluZygpCgkJaWYgKCFzdWJzY3JpcHRpb25UZXh0KSB7CgkJCS8vCgkJCS8vc2hhcmVkIHByb3BlcnR5CgkJCXRoaXMuc3Vic2NyaXB0aW9ucyA9IFtdOwoJCQlyZXR1cm47CgkJfQoKCQkvL2hhbmRsZSB0aGUgY2FzZSA6IG5ldyBCaW5kaW5nIChlbGVtKTsKCQlpZiAoc3Vic2NyaXB0aW9uVGV4dC5ub2RlVHlwZSkgewoJCQl2YXIgZWxlbSA9IHN1YnNjcmlwdGlvblRleHQ7CgkJCXN1YnNjcmlwdGlvblRleHQgPSBwYXJlbnRCaW5kaW5nIHx8IGV4dHJhY3RTdWJzY3JpcHRpb25UZXh0KCBlbGVtICk7CgkJCWlmIChzdWJzY3JpcHRpb25UZXh0KSB7CgkJCQllbXB0eUJpbmRpbmcgPSBuZXcgQmluZGluZygpOwoJCQkJZW1wdHlCaW5kaW5nLmVsZW0gPSBlbGVtOwoJCQkJZW1wdHlCaW5kaW5nLm5zID0gZ2V0SW5oZXJpdGVkTmFtZXNwYWNlKCBlbGVtICk7CgkJCQlyZXR1cm4gbmV3IEJpbmRpbmcoIHN1YnNjcmlwdGlvblRleHQsIGVtcHR5QmluZGluZyApOwoJCQl9CgkJCXJldHVybjsKCQl9CgoJCWlmICghcGFyZW50QmluZGluZykgewoJCQllbXB0eUJpbmRpbmcgPSBuZXcgQmluZGluZygpOwoJCQkvL2Zha2UgYW4gZWxlbQoJCQllbXB0eUJpbmRpbmcuZWxlbSA9IHt9OwoJCQlyZXR1cm4gbmV3IEJpbmRpbmcoIHN1YnNjcmlwdGlvblRleHQsIGVtcHR5QmluZGluZyApOwoJCX0KCgkJLy9oYW5kbGUgdGhlIGNhc2U6IG5ldyBCaW5kaW5nKHN1YnNjcmlwdGlvblRleHQsIHBhcmVudEJpbmRpbmcpOwoJCS8vCgkJLy9wcml2YXRlIGRhdGEKCQl0aGlzLnN1YiA9IFtdOwoJCXRoaXMucHViID0gW107CgkJdGhpcy5iaW5kaW5ncyA9IFtdOwoKCQl3aGlsZSAoKG1hdGNoID0gclN1YnNjcmlwdGlvblByb3BlcnR5LmV4ZWMoIHN1YnNjcmlwdGlvblRleHQgKSkpIHsKCgkJCXZhciBwcmVmaXggPSBtYXRjaFsxXSwKCQkJCXByb3AgPSAkLnRyaW0oIG1hdGNoWzJdICksCgkJCQl2YWx1ZSA9ICQudHJpbSggbWF0Y2hbM10gKTsKCgkJCWlmIChwcmVmaXgpIHsKCgkJCQl0aGlzW3ByZWZpeCA9PSAiJCIgPyAicHViIiA6ICJzdWIiXS5wdXNoKCB7IGV2ZW50VHlwZXM6IHByb3AsIHZhbHVlOiB2YWx1ZSB9ICk7CgoJCQl9IGVsc2UgewoKCQkJCWlmIChwcm9wID09ICJucyIpIHsKCQkJCQluc1Byb3BlcnR5ID0gdmFsdWU7CgoJCQkJfSBlbHNlIHsKCQkJCQl0aGlzLmJpbmRpbmdzLnB1c2goIHsgYmluZGluZ05hbWU6IHByb3AsIHZhbHVlOiB2YWx1ZX0gKTsKCQkJCX0KCQkJfQoJCX0KCgkJdGhpcy5ucyA9IG1lcmdlUGF0aCggbWVyZ2VQYXRoKCBwYXJlbnRCaW5kaW5nLm5zLCBiaW5kaW5nTnMgKSwgbnNQcm9wZXJ0eSApOwoJCS8vc2hhcmVkIGRhdGEKCQl0aGlzLnRleHQgPSBzdWJzY3JpcHRpb25UZXh0OwoJCXRoaXMuZWxlbSA9IHBhcmVudEJpbmRpbmcuZWxlbTsKCQkvL3RoaXMgaXMgYSBzaW5nbGV0b24KCQkvL3RoaXMuc3Vic2NyaXB0aW9ucyA9IHBhcmVudEJpbmRpbmcuc3Vic2NyaXB0aW9uczsKCgkJaWYgKHBhcmVudEJpbmRpbmcuY29udGV4dCkgewoKCQkJdGhpcy5jb250ZXh0ID0gcGFyZW50QmluZGluZy5jb250ZXh0OwoKCQl9IGVsc2UgewoKCQkJdGhpcy5jb250ZXh0ID0gdGhpczsKCQkJdGhpcy5keW5hbWljQmluZGluZ3MgPSBbXTsKCQkJdGhpcy5zdWJzY3JpcHRpb25zID0gW107CgkJCSQoIHRoaXMuZWxlbSApLmhtRGF0YSggIm5zIiwgdGhpcy5ucyApOwoJCX0KCgkJdGhpcy5vcHRpb25zID0gbWVyZ2VPcHRpb25zKCBwYXJlbnRCaW5kaW5nLm9wdGlvbnMsIGJpbmRpbmdPcHRpb25zICk7CgoJCXRoaXMuX2ltcG9ydEJpbmRpbmdzKCk7CgkJdGhpcy5faW1wb3J0U3Vic2NyaXB0aW9ucyggInN1YiIgKTsKCQl0aGlzLl9pbXBvcnRTdWJzY3JpcHRpb25zKCAicHViIiApOwoKCX0KCglCaW5kaW5nLnByb3RvdHlwZSA9IHsKCgkJX2ltcG9ydEJpbmRpbmdzOiBmdW5jdGlvbigpIHsKCgkJCXZhciBpLAoJCQkJYmluZGluZ05hbWUsCgkJCQl3ZWxsa25vd25CaW5kaW5nLAoJCQkJYmluZGluZywKCQkJCXN1YlRleHRQYXJ0cywKCQkJCWJpbmRpbmdOcywKCQkJCWJpbmRpbmdPcHRpb25zLAoJCQkJYmluZGluZ3MgPSB0aGlzLmJpbmRpbmdzOwoKCQkJZm9yIChpID0gMDsgaSA8IGJpbmRpbmdzLmxlbmd0aDsgaSsrKSB7CgoJCQkJYmluZGluZyA9IGJpbmRpbmdzW2ldOwoJCQkJYmluZGluZ05hbWUgPSBiaW5kaW5nLmJpbmRpbmdOYW1lOwoKCQkJCS8vaWYgdmFsdWUgaXMgInBhdGh8b3B0aW9uMXxvcHRpb24yIgoJCQkJLy8KCQkJCXN1YlRleHRQYXJ0cyA9IHJCaW5kaW5nVGV4dC5leGVjKCBiaW5kaW5nLnZhbHVlICk7CgkJCQliaW5kaW5nTnMgPSBzdWJUZXh0UGFydHNbMV07IC8vICJwYXRoIgoJCQkJYmluZGluZ09wdGlvbnMgPSBzdWJUZXh0UGFydHNbM107IC8vIm9wdGlvbjF8b3B0aW9uMiIKCgkJCQl3ZWxsa25vd25CaW5kaW5nID0gX2JpbmRpbmdzW2JpbmRpbmdOYW1lXTsKCgkJCQlpZiAoaXNGdW5jdGlvbiggd2VsbGtub3duQmluZGluZyApKSB7CgoJCQkJCXZhciB0ZW1wID0gWwoJCQkJCQl3ZWxsa25vd25CaW5kaW5nLAoJCQkJCQl0aGlzLmVsZW0sCgkJCQkJCW1lcmdlUGF0aCggdGhpcy5ucywgYmluZGluZ05zICksCgkJCQkJCXRoaXMsCgkJCQkJCW1lcmdlT3B0aW9ucyggdGhpcy5vcHRpb25zLCBiaW5kaW5nT3B0aW9ucyApCgkJCQkJXTsKCgkJCQkJaWYgKGJpbmRpbmdOYW1lID09ICJydW5GaXJzdCIpIHsKCgkJCQkJCXRoaXMuY29udGV4dC5ydW5GaXJzdCA9IHRlbXA7CgoJCQkJCX0gZWxzZSBpZiAoYmluZGluZ05hbWUgPT0gInJ1bkxhc3QiKSB7CgoJCQkJCQl0aGlzLmNvbnRleHQucnVuTGFzdCA9IHRlbXA7CgoJCQkJCX0gZWxzZSB7CgoJCQkJCQl0aGlzLmNvbnRleHQuZHluYW1pY0JpbmRpbmdzLnB1c2goIHRlbXAgKTsKCQkJCQl9CgoJCQkJfSBlbHNlIGlmIChpc1N0cmluZyggd2VsbGtub3duQmluZGluZyApKSB7CgoJCQkJCS8vcmVjdXJzaXZlbHkgaW1wb3J0IHJlZmVyZW5jZWRCaW5kaW5nCgkJCQkJbmV3IEJpbmRpbmcoIHdlbGxrbm93bkJpbmRpbmcsIHRoaXMsIGJpbmRpbmdOcywgYmluZGluZ09wdGlvbnMgKTsKCgkJCQl9CgkJCX0KCQl9LAoKCQkvL3N1YnNjcmlwdGlvblR5cGUgaXMgZWl0aGVyICJwdWIiIG9yICJzdWIiCgkJX2ltcG9ydFN1YnNjcmlwdGlvbnM6IGZ1bmN0aW9uKCBzdWJzY3JpcHRpb25UeXBlICkgewoKCQkJdmFyIGksCgkJCQlzdWJzY3JpcHRpb25FbnRyeSwKCQkJCXN1YnNjcmlwdGlvblBhcnRzLAoJCQkJcHVibGlzaGVyLAoJCQkJZXZlbnRUeXBlcywKCQkJCXN1YnNjcmliZXIsCgkJCQlzdWJzY3JpcHRpb25FbnRyaWVzID0gdGhpc1tzdWJzY3JpcHRpb25UeXBlXTsKCgkJCWZvciAoaSA9IDA7IGkgPCBzdWJzY3JpcHRpb25FbnRyaWVzLmxlbmd0aDsgaSsrKSB7CgoJCQkJc3Vic2NyaXB0aW9uRW50cnkgPSBzdWJzY3JpcHRpb25FbnRyaWVzW2ldOwoJCQkJZXZlbnRUeXBlcyA9IHN1YnNjcmlwdGlvbkVudHJ5LmV2ZW50VHlwZXM7CgoJCQkJc3Vic2NyaXB0aW9uUGFydHMgPSBzdWJzY3JpcHRpb25FbnRyeS52YWx1ZS5zcGxpdCggclN1YnNjcmlwdGlvblZhbHVlU2VwYXJhdG9yICk7CgoJCQkJaWYgKHN1YnNjcmlwdGlvblR5cGUgPT0gInN1YiIpIHsKCgkJCQkJLy9wYXRofGhhbmRsZXJ8b3B0aW9uc3xkZWxlZ2F0ZQoJCQkJCXB1Ymxpc2hlciA9IHN1YnNjcmlwdGlvblBhcnRzWzBdOwoKCQkJCQlwdWJsaXNoZXIgPSBwdWJsaXNoZXIuc3RhcnRzV2l0aCggIiQiICkgPwoJCQkJCQlwdWJsaXNoZXIgOiAvL3B1Ymxpc2hlciBpcyBhIHZpZXcKCQkJCQkJbWVyZ2VQYXRoKCB0aGlzLm5zLCBwdWJsaXNoZXIgKTsKCgkJCQkJc3Vic2NyaWJlciA9IHRoaXMuZWxlbTsKCgkJCQl9IGVsc2UgewoJCQkJCS8vcGF0aHxoYW5kbGVyfG9wdGlvbnN8ZGVsZWdhdGUKCQkJCQlwdWJsaXNoZXIgPSB0aGlzLmVsZW07CgoJCQkJCXN1YnNjcmliZXIgPSBzdWJzY3JpcHRpb25QYXJ0c1swXTsKCQkJCQlzdWJzY3JpYmVyID0gc3Vic2NyaWJlci5zdGFydHNXaXRoKCAiJCIgKSA/CgkJCQkJCXN1YnNjcmliZXIgOiAvL3N1YnNjcmliZXIgaXMgYSB2aWV3CgkJCQkJCW1lcmdlUGF0aCggdGhpcy5ucywgc3Vic2NyaWJlciApOwoJCQkJfQoKCQkJCXRoaXMuYXBwZW5kU3ViKAoJCQkJCXN1YnNjcmliZXIsCgkJCQkJcHVibGlzaGVyLAoJCQkJCWV2ZW50VHlwZXMsCgkJCQkJc3Vic2NyaXB0aW9uUGFydHNbMV0sIC8vaGFuZGxlcgoJCQkJCXRvVHlwZWRWYWx1ZSggbWVyZ2VPcHRpb25zKCB0aGlzLm9wdGlvbnMsIHN1YnNjcmlwdGlvblBhcnRzWzJdICkgKSwgLy9vcHRpb25zCgkJCQkJc3Vic2NyaXB0aW9uUGFydHNbM10gLy9kZWxlZ2F0ZQoJCQkJKTsKCQkJfQoKCQl9LAoKCQlhcHBlbmRTdWI6IGZ1bmN0aW9uKCBzdWJzY3JpYmVyLCBwdWJsaXNoZXIsIGV2ZW50VHlwZXMsIGhhbmRsZXIsIG9wdGlvbnMsIGRlbGVnYXRlICkgewoJCQl0aGlzLmNvbnRleHQuc3Vic2NyaXB0aW9ucy5wdXNoKCB7CgkJCQlwdWJsaXNoZXI6IHB1Ymxpc2hlciwKCQkJCWV2ZW50VHlwZXM6IGV2ZW50VHlwZXMsCgkJCQlzdWJzY3JpYmVyOiBzdWJzY3JpYmVyLAoJCQkJaGFuZGxlcjogaGFuZGxlciwKCQkJCW9wdGlvbnM6IG9wdGlvbnMsCgkJCQlkZWxlZ2F0ZTogZGVsZWdhdGUKCQkJfSApOwoJCX0sCgoJCXByZXBlbmRTdWI6IGZ1bmN0aW9uIHByZXBlbmRTdWIoIHN1YnNjcmliZXIsIHB1Ymxpc2hlciwgZXZlbnRUeXBlcywgaGFuZGxlciwgb3B0aW9ucywgZGVsZWdhdGUgKSB7CgkJCXRoaXMuY29udGV4dC5zdWJzY3JpcHRpb25zLnVuc2hpZnQoIHsKCQkJCXB1Ymxpc2hlcjogcHVibGlzaGVyLAoJCQkJZXZlbnRUeXBlczogZXZlbnRUeXBlcywKCQkJCXN1YnNjcmliZXI6IHN1YnNjcmliZXIsCgkJCQloYW5kbGVyOiBoYW5kbGVyLAoJCQkJb3B0aW9uczogb3B0aW9ucywKCQkJCWRlbGVnYXRlOiBkZWxlZ2F0ZQoJCQl9ICk7CgkJfSwKCgkJY2xlYXJTdWJzOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5jb250ZXh0LnN1YnNjcmlwdGlvbnMuc3BsaWNlKCAwLCB0aGlzLnN1YnNjcmlwdGlvbnMubGVuZ3RoICk7CgkJfQoJfTsKCglmdW5jdGlvbiBwYXJzZVN1YnMoIGVsZW0gKSB7CgoJCXZhciBzdWJzY3JpcHRpb25UZXh0LAoJCQljb250ZXh0LAoJCQlzdWJzY3JpcHRpb25zLAoJCQlpLAoJCQlzdWJzY3JpcHRpb24sCgkJCSRlbGVtID0gJCggZWxlbSApOwoKCQlpZiAoISRlbGVtLmhtRGF0YSggInBhcnNlZCIgKSAmJiAoc3Vic2NyaXB0aW9uVGV4dCA9IGV4dHJhY3RTdWJzY3JpcHRpb25UZXh0KCBlbGVtICkpKSB7CgoJCQljb250ZXh0ID0gbmV3IEJpbmRpbmcoIGVsZW0sIHN1YnNjcmlwdGlvblRleHQgKTsKCQkJc3Vic2NyaXB0aW9ucyA9IGNvbnRleHQuc3Vic2NyaXB0aW9uczsKCgkJCXZhciBydW5GaXJzdCA9IGNvbnRleHQucnVuRmlyc3Q7CgkJCWlmIChydW5GaXJzdCkgewoJCQkJcnVuRmlyc3RbMF0oIHJ1bkZpcnN0WzFdLCBydW5GaXJzdFsyXSwgcnVuRmlyc3RbM10sIHJ1bkZpcnN0WzRdICk7CgkJCX0KCgkJCXZhciBkeW5hbWljQmluZGluZ3MgPSBjb250ZXh0LmR5bmFtaWNCaW5kaW5nczsKCQkJZm9yIChpID0gMDsgaSA8IGR5bmFtaWNCaW5kaW5ncy5sZW5ndGg7IGkrKykgewoJCQkJdmFyIGR5bmFtaWNCaW5kaW5nID0gZHluYW1pY0JpbmRpbmdzW2ldOwoJCQkJZHluYW1pY0JpbmRpbmdbMF0oIGR5bmFtaWNCaW5kaW5nWzFdLCBkeW5hbWljQmluZGluZ1syXSwgZHluYW1pY0JpbmRpbmdbM10sIGR5bmFtaWNCaW5kaW5nWzRdICk7CgkJCX0KCgkJCXZhciBydW5MYXN0ID0gY29udGV4dC5ydW5MYXN0OwoJCQlpZiAocnVuTGFzdCkgewoJCQkJcnVuTGFzdFswXSggcnVuTGFzdFsxXSwgcnVuTGFzdFsyXSwgcnVuTGFzdFszXSwgcnVuTGFzdFs0XSApOwoJCQl9CgoJCQlmb3IgKGkgPSAwOyBpIDwgc3Vic2NyaXB0aW9ucy5sZW5ndGg7IGkrKykgewoKCQkJCXN1YnNjcmlwdGlvbiA9IHN1YnNjcmlwdGlvbnNbaV07CgkJCQlobS5zdWIoCgkJCQkJc3Vic2NyaXB0aW9uLnN1YnNjcmliZXIsCgkJCQkJc3Vic2NyaXB0aW9uLnB1Ymxpc2hlciwKCQkJCQlzdWJzY3JpcHRpb24uZXZlbnRUeXBlcywKCQkJCQlzdWJzY3JpcHRpb24uaGFuZGxlciwKCQkJCQlzdWJzY3JpcHRpb24ub3B0aW9ucywKCQkJCQlzdWJzY3JpcHRpb24uZGVsZWdhdGUKCQkJCSk7CgkJCX0KCgkJCS8vI2RlYnVnCgkJCWNvbnRleHQuZGVidWcgJiYgY29udGV4dC5wcmludCgpOwoJCQkvLyNlbmRfZGVidWcKCgkJCS8vCgkJCSRlbGVtLmhtRGF0YSggInBhcnNlZCIsIHRydWUgKTsKCQl9CgoJCSRlbGVtLmNoaWxkcmVuKCkuZWFjaCggZnVuY3Rpb24oKSB7CgkJCXBhcnNlU3VicyggdGhpcyApOwoJCX0gKTsKCX0KCgkvL2RlbGF5IGF1dG8gcGFyc2UgdG8gd2F5IGZvciBzb21lIGRlcGVuZGVuY2llcyB0byByZXNvbHZlIGFzeW5jaHJvbm91c2x5CglzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkkKCBmdW5jdGlvbigpIHsKCQkJaWYgKGRlZmF1bHRPcHRpb25zLmF1dG9QYXJzZSkgewoJCQkJcGFyc2VTdWJzKCBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQgKTsKCQkJfQoJCX0gKTsKCX0sIDEgKTsKCgkkZm4ucGFyc2VTdWJzID0gZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuZWFjaCggZnVuY3Rpb24oKSB7CgkJCXBhcnNlU3VicyggdGhpcyApOwoJCX0gKTsKCX07CgoJdmFyIGxvZ01vZGVsID0gaG0oICIqbG9nIiwgW10gKTsKCgl2YXIgX2JpbmRpbmdzID0ge307CgoJZnVuY3Rpb24gYmluZGluZ3MoIG5hbWUsIGRlZmluaXRpb24sIGlzVGFnICkgewoJCWlmICghbmFtZSkgewoJCQlyZXR1cm4gX2JpbmRpbmdzOwoJCX0KCgkJaWYgKCFkZWZpbml0aW9uKSB7CgoJCQlpZiAoaXNPYmplY3QoIG5hbWUgKSkgewoJCQkJZm9yICh2YXIga2V5IGluIG5hbWUpIHsKCQkJCQliaW5kaW5ncygga2V5LCBuYW1lW2tleV0gKTsKCQkJCX0KCQkJCXJldHVybiB0aGlzOwoKCQkJfSBlbHNlIHsKCQkJCXJldHVybiBfYmluZGluZ3NbbmFtZV07CgkJCX0KCQl9CgoJCWlmIChpc0FycmF5KCBkZWZpbml0aW9uICkpIHsKCQkJZGVmaW5pdGlvbiA9IGRlZmluaXRpb24uY29uY2F0KCAiOyIgKTsKCQl9CgoJCV9iaW5kaW5nc1tpc1RhZyA/ICJ0YWdfIiArIG5hbWUudG9VcHBlckNhc2UoKSA6IG5hbWVdID0gZGVmaW5pdGlvbjsKCQlyZXR1cm4gdGhpczsKCX0KCglleHRlbmQoIGhtLCB7CgoJCWJpbmRpbmc6IGJpbmRpbmdzLAoKCQkvLyNkZWJ1ZwoJCUJpbmRpbmc6IEJpbmRpbmcsCgkJLy8jZW5kX2RlYnVnCgoJCWxvZzogZnVuY3Rpb24oIG1lc3NhZ2UsIGNvbG9yICkgewoJCQltZXNzYWdlID0gbWVzc2FnZSArICIiOwoJCQltZXNzYWdlID0gY29sb3IgPyAiPGRpdiBzdHlsZT0nY29sb3I6IiArIGNvbG9yICsgIic+IiArIG1lc3NhZ2UgKyAiPC9kaXY+ICIgOiBtZXNzYWdlOwoJCQlsb2dNb2RlbC5wdXNoKCBtZXNzYWdlICk7CgkJfSwKCgkJY2xlYXJsb2c6IGZ1bmN0aW9uKCkgewoJCQlsb2dNb2RlbC5jbGVhcigpOwoJCX0KCX0gKTsKCglmdW5jdGlvbiBhZGhvY0JpbmRpbmcoIGVsZW0sIHBhdGgsIGNvbnRleHQsIG9wdGlvbnMgKSB7CgkJcm9vdE5vZGUuZ2V0KCBwYXRoLCBlbGVtLCBwYXRoLCBjb250ZXh0LCBvcHRpb25zICk7Cgl9CgoJYmluZGluZ3MoICJydW5GaXJzdCIsIGFkaG9jQmluZGluZyApOwoJYmluZGluZ3MoICJydW5MYXN0IiwgYWRob2NCaW5kaW5nICk7CgovLyNkZWJ1ZwovLwovLzxAZGVwZW5kcz5zdWJzY3JpcHRpb24uanMsIG1vZGVsLmpzLCBkZWNsYXJhdGl2ZS5qczwvQGRlcGVuZHM+CgoKCUJpbmRpbmcucHJvdG90eXBlLnByaW50ID0gZnVuY3Rpb24oKSB7CgkJdmFyIHN1YnNjcmlwdGlvbnMgPSB0aGlzLnN1YnNjcmlwdGlvbnMsCgkJCWVsZW0gPSB0aGlzLmVsZW07CgoJCXZhciBodG1sID0gIjx0YWJsZSBib3JkZXI9JzEnIGNlbGxwYWRkaW5nPSc2JyBzdHlsZT0nYm9yZGVyLWNvbGxhcHNlOiBjb2xsYXBzZTsgd2lkdGg6MTAwJTsnPiIgKwoJCSAgICAgICAgICAgIjx0cj48dGQ+ZWxlbWVudDwvdGQ+PHRkIGNvbHNwYW49JzYnPiIgKyBmb3JtYXRQYXJ0eSggZWxlbSApICsgIjwvdGQ+IDwvdHI+IiArCgkJICAgICAgICAgICAiPHRyPjx0ZD5tb2RlbCBwYXRoPC90ZD48dGQgY29sc3Bhbj0nNic+IiArIGZvcm1hdFBhcnR5KCB0aGlzLm5zICkgKyAiPC90ZD48L3RyPiIgKwoJCSAgICAgICAgICAgIjx0cj48dGQ+dGV4dDwvdGQ+PHRkIGNvbHNwYW49JzYnPiIgKyBmb3JtYXRQcmludCggdGhpcy50ZXh0ICkgKyAiPC90ZD48L3RyPiI7CgoJCWlmICh0aGlzLnN1Yi5sZW5ndGgpIHsKCQkJaHRtbCArPSAiPHRyPjx0ZD5zdWI8L3RkPjx0ZCBjb2xzcGFuPSc2Jz4iICsgZm9ybWF0UHJpbnQoIHRoaXMuc3ViICkgKyAiPC90ZD48L3RyPiI7CgkJfQoKCQlpZiAodGhpcy5wdWIubGVuZ3RoKSB7CgkJCWh0bWwgKz0gIjx0cj48dGQ+cHViPC90ZD48dGQgY29sc3Bhbj0nNic+IiArIGZvcm1hdFByaW50KCB0aGlzLnB1YiApICsgIjwvdGQ+PC90cj4iOwoJCX0KCgkJaWYgKHRoaXMuYmluZGluZ3MubGVuZ3RoKSB7CgkJCWh0bWwgKz0gIjx0cj48dGQ+YmluZGluZzwvdGQ+PHRkIGNvbHNwYW49JzYnPiIgKyBmb3JtYXRQcmludCggdGhpcy5iaW5kaW5ncyApICsgIjwvdGQ+PC90cj4iOwoJCX0KCgkJaWYgKHN1YnNjcmlwdGlvbnMubGVuZ3RoKSB7CgoJCQlodG1sICs9ICI8dHI+IiArCgkJCSAgICAgICAgIjx0aD48L3RoPiIgKwoJCQkgICAgICAgICI8dGg+c3Vic2NyaWJlcjwvdGg+IiArCgkJCSAgICAgICAgIjx0aD5wdWJsaXNoZXI8L3RoPiIgKwoJCQkgICAgICAgICI8dGg+ZXZlbnRUeXBlczwvdGg+IiArCgkJCSAgICAgICAgIjx0aD5oYW5kbGVyPC90aD4iICsKCQkJICAgICAgICAiPHRoPm9wdGlvbnM8L3RoPiIgKwoJCQkgICAgICAgICI8dGg+ZGVsZWdhdGU8L3RoPiIgKwoJCQkgICAgICAgICI8L3RyPiI7CgoJCQlmb3IgKHZhciBpID0gMDsgaSA8IHN1YnNjcmlwdGlvbnMubGVuZ3RoOyBpKyspIHsKCQkJCXZhciBzdWJzY3JpcHRpb24gPSBzdWJzY3JpcHRpb25zW2ldOwoJCQkJaHRtbCArPSAiPHRyPiIgKwoJCQkJICAgICAgICAiPHRkPiIgKyAoaSArIDEpICsgIjwvdGQ+IiArCgkJCQkgICAgICAgICI8dGQ+IiArIGZvcm1hdFBhcnR5KCBzdWJzY3JpcHRpb24uc3Vic2NyaWJlciwgZWxlbSApICsgIjwvdGQ+IiArCgkJCQkgICAgICAgICI8dGQ+IiArIGZvcm1hdFBhcnR5KCBzdWJzY3JpcHRpb24ucHVibGlzaGVyLCBlbGVtICkgKyAiPC90ZD4iICsKCQkJCSAgICAgICAgIjx0ZD4iICsgZm9ybWF0UHJpbnQoIHN1YnNjcmlwdGlvbi5ldmVudFR5cGVzICkgKyAiPC90ZD4iICsKCQkJCSAgICAgICAgIjx0ZD4iICsgZm9ybWF0UHJpbnQoIHN1YnNjcmlwdGlvbi5oYW5kbGVyICkgKyAiPC90ZD4iICsKCQkJCSAgICAgICAgIjx0ZD4iICsgZm9ybWF0UHJpbnQoIHN1YnNjcmlwdGlvbi5vcHRpb25zICkgKyAiPC90ZD4iICsKCQkJCSAgICAgICAgIjx0ZD4iICsgZm9ybWF0UHJpbnQoIHN1YnNjcmlwdGlvbi5kZWxlZ2F0ZSApICsgIjwvdGQ+IiArCgkJCQkgICAgICAgICI8L3RyPiI7CgkJCX0KCQl9CgoJCWh0bWwgKz0gIjwvdGFibGU+IjsKCQlobS5sb2coIGh0bWwgKTsKCgl9OwoKCWZ1bmN0aW9uIGZvcm1hdFBhcnR5KCBvYmosIGVsZW0gKSB7CgoJCWlmIChvYmogPT09IGVsZW0pIHsKCQkJcmV0dXJuICJlbGVtZW50IjsKCQl9CgoJCWlmIChvYmoubm9kZVR5cGUpIHsKCQkJcmV0dXJuIHV0aWwuZW5jb2RlSHRtbCggb2JqLm91dGVySFRNTCApLnN1YnN0ciggMCwgMTAwICkgKyAiLi4uIjsKCQl9CgoJCWlmIChpc1N0cmluZyggb2JqICkpIHsKCQkJaWYgKG9iai5zdGFydHNXaXRoKCAiJCIgKSkgewoJCQkJcmV0dXJuICIkKCciICsgb2JqLnN1YnN0ciggMSApICsgIicpIjsKCQkJfSBlbHNlIHsKCQkJCWlmIChlbGVtKSB7CgkJCQkJcmV0dXJuICJobSgnIiArIHV0aWwudG9Mb2dpY2FsUGF0aCggb2JqICkgKyAiJykiOwoJCQkJfSBlbHNlIHsKCQkJCQlyZXR1cm4gIiciICsgdXRpbC50b0xvZ2ljYWxQYXRoKCBvYmogKSArICInIjsKCQkJCX0KCQkJfQoJCX0KCgl9CgoJZnVuY3Rpb24gZm9ybWF0UHJpbnQoIG9iaiApIHsKCgkJaWYgKGlzVW5kZWZpbmVkKCBvYmogKSkgewoJCQlyZXR1cm4gIiI7CgkJfSBlbHNlIGlmIChpc0Z1bmN0aW9uKCBvYmogKSkgewoKCQkJcmV0dXJuIHV0aWwuZW5jb2RlSHRtbCggb2JqICsgIiIgKS5zdWJzdHIoIDAsIDEwMCApICsgIi4uLiI7CgoJCX0gZWxzZSBpZiAoaXNPYmplY3QoIG9iaiApKSB7CgoJCQl2YXIgcnRuID0gIjxwcmU+eyI7CgkJCXZhciB0ZW1wID0gIiI7CgkJCWZvciAodmFyIGtleSBpbiBvYmopIHsKCQkJCXZhciB2YWx1ZSA9IG9ialtrZXldOwoJCQkJaWYgKCFpc1VuZGVmaW5lZCggdmFsdWUgKSkgewoJCQkJCXRlbXAgKz0gIlxuICIgKyBrZXkgKyAiOiI7CgkJCQkJaWYgKGlzU3RyaW5nKCB2YWx1ZSApKSB7CgkJCQkJCXRlbXAgKz0gIiciICsgdXRpbC5lbmNvZGVIdG1sKCB2YWx1ZSApICsgIicsIgoJCQkJCX0gZWxzZSB7CgkJCQkJCXRlbXAgKz0gdXRpbC5lbmNvZGVIdG1sKCB2YWx1ZSApICsgIiwiCgkJCQkJfQoJCQkJfQoKCQkJfQoKCQkJaWYgKHRlbXAubGVuZ3RoICE9IDApIHsKCQkJCXRlbXAgPSB0ZW1wLnN1YnN0ciggMCwgdGVtcC5sZW5ndGggLSAxICk7CgkJCX0KCQkJcnRuICs9IHRlbXA7CgoJCQlydG4gKz0gIlxufTwvcHJlPiI7CgkJCXJ0biA9IHJ0bi5yZXBsYWNlKCAvXHQvZywgIiAiICk7CgkJCXJldHVybiBydG47CgkJfSBlbHNlIHsKCQkJcmV0dXJuIEpTT04uc3RyaW5naWZ5KCBvYmogKTsKCQl9Cgl9CgoJaG0uYmluZGluZyggImRlYnVnIiwgZnVuY3Rpb24oIGVsZW0sIHBhdGgsIGNvbnRleHQsIG9wdGlvbnMgKSB7CgkJY29udGV4dC5kZWJ1ZyA9IHRydWU7Cgl9ICk7CgoJaG0ucHJpbnRCaW5kaW5nID0gZnVuY3Rpb24oIGVsZW0gKSB7CgkJaWYgKGlzU3RyaW5nKCBlbGVtICkpIHsKCQkJZWxlbSA9ICQoICI8ZGl2PjwvZGl2PiIgKS5hdHRyKCBobS5vcHRpb25zLnN1YnNBdHRyLCBlbGVtIClbMF07CgkJfSBlbHNlIGlmIChlbGVtLmpxdWVyeSkgewoJCQllbGVtID0gZWxlbVswXTsKCQl9CgoJCShuZXcgaG0uQmluZGluZyggZWxlbSApKS5wcmludCgpOwoJfTsKCgkvL21lIGNhbiBiZSBhIERPTSBlbGVtZW50LCBvciBpdCBjYW4gYSBzdHJpbmcgcGF0aAoJaG0ucHJpbnRTdWJzY3JpcHRpb25zID0gZnVuY3Rpb24oIG1lLCBzdWJzY3JpcHRpb25zLCB0eXBlICkgewoJCWlmICghc3Vic2NyaXB0aW9ucy5sZW5ndGgpIHsKCQkJaG0ubG9nKCAibm8gc3Vic2NyaXB0aW9uIiApOwoJCQlyZXR1cm47CgkJfQoKCQl2YXIgc3Vic0Zyb21NZSwgc3Vic1RvTWUsIGksIHN1YnNjcmlwdGlvbjsKCQlpZiAodHlwZSA9PSAiZnJvbU1lIikgewoJCQlzdWJzRnJvbU1lID0gc3Vic2NyaXB0aW9uczsKCQl9IGVsc2UgaWYgKHR5cGUgPT0gInRvTWUiKSB7CgoJCQlzdWJzVG9NZSA9IHN1YnNjcmlwdGlvbnM7CgoJCX0gZWxzZSB7CgoJCQlzdWJzRnJvbU1lID0gJCggc3Vic2NyaXB0aW9ucyApLmZpbHRlcihmdW5jdGlvbiggaW5kZXgsIGl0ZW0gKSB7CgkJCQlyZXR1cm4gaXRlbS5zdWJzY3JpYmVyID09IG1lOwoJCQl9ICkuZ2V0KCk7CgoJCQlzdWJzVG9NZSA9ICQoIHN1YnNjcmlwdGlvbnMgKS5maWx0ZXIoZnVuY3Rpb24oIGluZGV4LCBpdGVtICkgewoJCQkJcmV0dXJuIGl0ZW0ucHVibGlzaGVyID09IG1lOwoJCQl9ICkuZ2V0KCk7CgoJCX0KCgkJLypyZXR1cm4gZ2V0U3Vic2NyaXB0aW9uc0J5KCBzdWJzY3JpYmVyT3JQdWJsaXNoZXIsIGZ1bmN0aW9uIG1hdGNoKCBpdGVtLCB0YXJnZXQgKSB7CgkJIHJldHVybiBpdGVtLnN1YnNjcmliZXIgPT0gdGFyZ2V0IHx8IGl0ZW0ucHVibGlzaGVyID09IHRhcmdldDsKCQkgfSApOyovCgoJCXZhciBteURlc2NyaXB0aW9uOwoKCQlpZiAoaXNTdHJpbmcoIG1lICkgfHwgKG1lIGluc3RhbmNlb2YgIGhtKSkgewoKCQkJbXlEZXNjcmlwdGlvbiA9ICJobSgnIiArIHV0aWwudG9Mb2dpY2FsUGF0aCggbWUgKSArICInKSI7CgoJCX0gZWxzZSB7CgoJCQlteURlc2NyaXB0aW9uID0gZm9ybWF0UGFydHkoIG1lICk7CgoJCX0KCgkJdmFyIGh0bWwgPSAiPHRhYmxlIGJvcmRlcj0nMScgY2VsbHBhZGRpbmc9JzYnIHN0eWxlPSdib3JkZXItY29sbGFwc2U6IGNvbGxhcHNlOyB3aWR0aDoxMDAlOyc+IjsKCgkJaWYgKHN1YnNGcm9tTWUgJiYgc3Vic0Zyb21NZS5sZW5ndGgpIHsKCQkJaHRtbCArPSAiPHRyPjx0aCBjb2xzcGFuPSc2Jz48Yj5TdWJzY3JpYmVyOiA8L2I+ICIgKyBteURlc2NyaXB0aW9uICsgIjwvdGg+PC90cj4iOwoJCQlodG1sICs9ICI8dHI+PHRoPjwvdGg+PHRoPlB1Ymxpc2hlcjo8L3RoPjx0aD5ldmVudHM8L3RoPjx0aD53b3JrZmxvdzwvdGg+PHRoPm9wdGlvbnM8L3RoPjx0aD5kZWxlZ2F0ZTwvdGg+PC90aD4iOwoKCQkJZm9yIChpID0gMDsgaSA8IHN1YnNGcm9tTWUubGVuZ3RoOyBpKyspIHsKCQkJCXN1YnNjcmlwdGlvbiA9IHN1YnNGcm9tTWVbaV07CgkJCQlodG1sICs9ICI8dHI+IiArCgkJCQkgICAgICAgICI8dGQ+IiArIChpICsgMSkgKyAiPC90ZD4iICsKCQkJCSAgICAgICAgIjx0ZD4iICsgZm9ybWF0UGFydHkoIHN1YnNjcmlwdGlvbi5wdWJsaXNoZXIgKSArICI8L3RkPiIgKwoJCQkJICAgICAgICAiPHRkPiIgKyBmb3JtYXRQcmludCggc3Vic2NyaXB0aW9uLmV2ZW50VHlwZXMgKSArICI8L3RkPiIgKwoJCQkJICAgICAgICAiPHRkPiIgKyBmb3JtYXRQcmludCggc3Vic2NyaXB0aW9uLndvcmtmbG93ICkgKyAiPC90ZD4iICsKCQkJCSAgICAgICAgIjx0ZD4iICsgZm9ybWF0UHJpbnQoIHN1YnNjcmlwdGlvbi5vcHRpb25zICkgKyAiPC90ZD4iICsKCQkJCSAgICAgICAgIjx0ZD4iICsgZm9ybWF0UHJpbnQoIHN1YnNjcmlwdGlvbi5kZWxlZ2F0ZSApICsgIjwvdGQ+IiArCgkJCQkgICAgICAgICI8L3RyPiI7CgkJCX0KCQl9CgoJCWlmIChzdWJzVG9NZSAmJiBzdWJzVG9NZS5sZW5ndGgpIHsKCQkJaHRtbCArPSAiPHRyPjx0aCBjb2xzcGFuPSc2Jz5QdWJsaXNoZXI6ICIgKyBteURlc2NyaXB0aW9uICsgIjwvdGg+PC90cj4iOwoJCQlodG1sICs9ICI8dHI+PHRoPjwvdGg+PHRoPlN1YnNjcmliZXI6PC90aD48dGg+ZXZlbnRzPC90aD48dGg+d29ya2Zsb3c8L3RoPjx0aD5vcHRpb25zPC90aD48dGg+ZGVsZWdhdGU8L3RoPjwvdHI+IjsKCgkJCWZvciAoaSA9IDA7IGkgPCBzdWJzVG9NZS5sZW5ndGg7IGkrKykgewoJCQkJc3Vic2NyaXB0aW9uID0gc3Vic1RvTWVbaV07CgkJCQlodG1sICs9ICI8dHI+IiArCgkJCQkgICAgICAgICI8dGQ+IiArIChpICsgMSkgKyAiPC90ZD4iICsKCQkJCSAgICAgICAgIjx0ZD4iICsgZm9ybWF0UGFydHkoIHN1YnNjcmlwdGlvbi5zdWJzY3JpYmVyICkgKyAiPC90ZD4iICsKCQkJCSAgICAgICAgIjx0ZD4iICsgZm9ybWF0UHJpbnQoIHN1YnNjcmlwdGlvbi5ldmVudFR5cGVzICkgKyAiPC90ZD4iICsKCQkJCSAgICAgICAgIjx0ZD4iICsgZm9ybWF0UHJpbnQoIHN1YnNjcmlwdGlvbi53b3JrZmxvdyApICsgIjwvdGQ+IiArCgkJCQkgICAgICAgICI8dGQ+IiArIGZvcm1hdFByaW50KCBzdWJzY3JpcHRpb24ub3B0aW9ucyApICsgIjwvdGQ+IiArCgkJCQkgICAgICAgICI8dGQ+IiArIGZvcm1hdFByaW50KCBzdWJzY3JpcHRpb24uZGVsZWdhdGUgKSArICI8L3RkPiIgKwoJCQkJICAgICAgICAiPC90cj4iOwoJCQl9CgkJfQoKCQlodG1sICs9ICI8L3RhYmxlPiI7CgkJaG0ubG9nKCBodG1sICk7CgoJfTsKCi8vI2VuZF9kZWJ1Zy8vCgoJLy9zdGFydCBvZiBsb2FkZXIgY29yZS5qcwoJdmFyIHVybFN0b3JlID0ge30sCgkJcHJvbWlzZVN0b3JlID0ge30sCgkJZGVwZW5kZW5jeVN0b3JlID0ge30sCgkJbG9hZGVyRGVmaW5pdGlvblN0b3JlID0ge30sCgkJbG9hZGVyU3RvcmUgPSB7fSwKCQlkdW1teUxpbmsgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiYSIgKSwKCQlyQ29tbWEgPSAvLC8sCgkJclNwYWNlID0gL1xzKy9nLAoJCXJRdWVyeSA9IC9cPy8sCgkJckZpbGVFeHQgPSAvXC4oXHcrKSQvLAoJCXJGaWxlTmFtZSA9IC8oLispXC5cdyskLywKCQlmaWxlRXh0ZW5zaW9uLAoJCWZpbGVOYW1lLAoJCWNvbW1vbkxvYWRlck1ldGhvZHMsCgkJY29tbW9uTG9hZEZpbHRlcnMsCgkJZGVwZW5kLAoJLy9tYXRjaCAiaHR0cDovL2RvbWFpbi5jb20iICwgIi9qa2oiCgkJckFic29sdXRlVXJsID0gL15odHRwW3NdPzpcL1wvfF5cLy8sCgkJclVybFBhcnRzID0gL14oW1x3XCtcLlwtXSs6KSg/OlwvXC8oW15cLz8jOl0qKSg/OjooXGQrKSk/KT8vLAoJCWFqYXhMb2NQYXJ0cyA9IHJVcmxQYXJ0cy5leGVjKCBsb2NhdGlvbi5ocmVmLnRvTG93ZXJDYXNlKCkgKSB8fCBbXSwKCQloYXNoVmFsdWUgPSAiIiwKCQloYXNoS2V5ID0gInYiLAoJCXJWZXJzaW9uSGFzaCwKCQlsb2FkQ2FsbGJhY2tzID0gW10sCgkJZmFpbENhbGxiYWNrcyA9IFtdLAoJCXVubG9hZENhbGxiYWNrcyA9IFtdLAoKCQlsb2FkZXJGaW5kZXJzLAoJCWZpbGVFeHRUb0xvYWRlck1hcHBlciA9IHt9LAoJCWJhc2VVcmwgPSAiIiwKCgkvL3N1cHBvcnQgdGhlIGZvbGxvd2luZyBvdmVybG9hZGluZwoJLy9obS5sb2FkZXIoImFwcCIpOyAvL3JldHJpZXZlIGxvYWRlcgoJLy9obS5sb2FkZXIoImFwcCIsIGRlZmluaXRpb24pOyAvL2NyZWF0ZSBhIGxvYWRlciBmcm9tIHNjcmF0Y2gKCS8vaG0ubG9hZGVyKCJhcHAiLCAianMiLCBkZWZpbml0aW9uKTsgLy9jcmVhdGUgYSBsb2FkZXIgYnkgZXh0ZW5kaW5nIGEgbmV3IGxvYWRlcgoJCV9sb2FkZXIgPSBobS5sb2FkZXIgPSBmdW5jdGlvbiggbG9hZGVyTmFtZSwgYmFzZUxvYWRlck5hbWUsIGxvYWRlckRlZmluaXRpb24gKSB7CgoKCQkJLy9yZXRyaWV2ZSB0aGUgbG9hZGVyIGJ5IG5hbWUKCQkJaWYgKGlzVW5kZWZpbmVkKCBiYXNlTG9hZGVyTmFtZSApKSB7CgoJCQkJcmV0dXJuIGxvYWRlck5hbWUgPyBsb2FkZXJTdG9yZVtsb2FkZXJOYW1lXSA6IGxvYWRlclN0b3JlOwoKCQkJfQoKCQkJLy9jcmVhdGUgYSBuZXcgbG9hZGVyCgkJCWlmICghaXNTdHJpbmcoIGJhc2VMb2FkZXJOYW1lICkpIHsKCQkJCWxvYWRlckRlZmluaXRpb24gPSBiYXNlTG9hZGVyTmFtZTsKCQkJCWJhc2VMb2FkZXJOYW1lID0gbnVsbDsKCQkJfQoKCQkJbG9hZGVyRGVmaW5pdGlvbiA9IGxvYWRlckRlZmluaXRpb25TdG9yZVtsb2FkZXJOYW1lXSA9ICQuZXh0ZW5kKAoJCQkJdHJ1ZSwKCQkJCXt9LAoJCQkJbG9hZGVyRGVmaW5pdGlvblN0b3JlW2Jhc2VMb2FkZXJOYW1lXSwKCQkJCWxvYWRlckRlZmluaXRpb24gKTsKCgkJCXZhciBsb2FkZXIgPSAkLmV4dGVuZCggdHJ1ZSwge30sIGxvYWRlckRlZmluaXRpb24gKTsKCgkJCSQuZWFjaCggImxvYWQsdW5sb2FkLHVybCxkZXBlbmQiLnNwbGl0KCAiLCIgKSwgZnVuY3Rpb24oIGluZGV4LCBtZXRob2ROYW1lICkgewoJCQkJdmFyIGNvbW1vbk1ldGhvZE5hbWUgPSBsb2FkZXJbbWV0aG9kTmFtZV07CgkJCQlpZiAoaXNTdHJpbmcoIGNvbW1vbk1ldGhvZE5hbWUgKSkgewoJCQkJCXZhciBsb2FkZXJNZXRob2QgPSBjb21tb25Mb2FkZXJNZXRob2RzW21ldGhvZE5hbWVdW2NvbW1vbk1ldGhvZE5hbWVdOwoJCQkJCWlmIChsb2FkZXJNZXRob2QpIHsKCQkJCQkJbG9hZGVyW21ldGhvZE5hbWVdID0gbG9hZGVyTWV0aG9kOwoJCQkJCX0KCQkJCX0KCQkJfSApOwoKCQkJaWYgKCQuaXNQbGFpbk9iamVjdCggbG9hZGVyLmxvYWQgKSkgewoJCQkJLy9pdCBpcyBhIHBpcGVsaW5lLCBidXQgbm90IGEgZnVuY3Rpb24KCQkJCWxvYWRlci5sb2FkID0gY29udmVydExvYWRGaWx0ZXJzVG9Mb2FkTWV0aG9kKCBsb2FkZXIubG9hZCApOwoKCQkJfQoKCQkJaWYgKCEkLmlzRnVuY3Rpb24oIGxvYWRlci5sb2FkICkpIHsKCQkJCXRocm93ICJtaXNzaW5nIGxvYWQgZnVuY3Rpb24gZnJvbSBsb2FkZXIiOwoJCQl9CgoJCQlsb2FkZXJTdG9yZVtsb2FkZXJOYW1lXSA9ICQuZXh0ZW5kKCB7fSwgbG9hZGVyU3RvcmVbYmFzZUxvYWRlck5hbWVdLCBsb2FkZXIgKTsKCQl9OwoKCWZ1bmN0aW9uIGludm9rZUNhbGxiYWNrcyggY2FsbGJhY2tzICkgewoJCXJldHVybiBmdW5jdGlvbigpIHsKCQkJZm9yICh2YXIgaSA9IDA7IGkgPCBjYWxsYmFja3MubGVuZ3RoOyBpKyspIHsKCQkJCWNhbGxiYWNrc1tpXS5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgkJCX0KCQl9OwoJfQoKCXZhciBpbnZva2VGYWlsQ2FsbGJhY2tzID0gaW52b2tlQ2FsbGJhY2tzKCBmYWlsQ2FsbGJhY2tzICksCgkJaW52b2tlTG9hZENhbGxiYWNrcyA9IGludm9rZUNhbGxiYWNrcyggbG9hZENhbGxiYWNrcyApLAoJCWludm9rZVVubG9hZENhbGxiYWNrcyA9IGludm9rZUNhbGxiYWNrcyggdW5sb2FkQ2FsbGJhY2tzICk7CgoJZnVuY3Rpb24gbG9hZEFzc2V0cyggYXNzZXRJZHMsIGluZmVyRGVwZW5kZW5jaWVzRnJvbUlkT3JkZXIgKSB7CgoJCWlmIChpc1N0cmluZyggYXNzZXRJZHMgKSkgewoKCQkJaWYgKGluZmVyRGVwZW5kZW5jaWVzRnJvbUlkT3JkZXIpIHsKCQkJCXZhciBpID0gMSwKCQkJCQlrZXlzID0gc3BsaXRCeUNvbW1hKCBhc3NldElkcyApOwoKCQkJCS8vY3JlYXRlIGRlcGVuZGVuY3kgaW4gb3JkZXIKCQkJCXdoaWxlIChpIDwga2V5cy5sZW5ndGgpIHsKCQkJCQlkZXBlbmQoIGtleXNbaV0sIGtleXNbaSAtIDFdICk7CgkJCQkJaSsrOwoJCQkJfQoJCQkJYXNzZXRJZHMgPSBrZXlzW2tleXMubGVuZ3RoIC0gMV07CgkJCX0KCgkJCXJldHVybiBsb2FkQXNzZXRzSW5QYXJhbGxlbCggYXNzZXRJZHMgKTsKCgkJfSBlbHNlIGlmIChpc0FycmF5KCBhc3NldElkcyApKSB7CgoJCQkvL2lmIGl0IGlzIGFzc2V0SWRBcnJheSwgbG9hZCBvbmUgYWZ0ZXIgcHJldmlvdXMgaXMgZnVsbHkgbG9hZGVkCgkJCXJldHVybiBsb2FkQXNzZXRzSW5TZXJpYWwoIGFzc2V0SWRzICk7CgoJCX0KCQl0aHJvdyAicmVzb3VyY2UgcGFyYW1ldGVyIHNob3VsZCBiZSBhbiBhcnJheSBvciBzdHJpbmciOwoJfQoKCS8vcmVzb3VyY2VTdHJpbmcgaXMgbGlrZSAiYS5qcywgYi5jc3MsIGMudG1wbCIKCWZ1bmN0aW9uIGxvYWRBc3NldHNJblBhcmFsbGVsKCBhc3NldElkU3RyaW5nICkgewoJCXZhciBwcm9taXNlcyA9IFtdLAoJCQlydG5Qcm9taXNlLAoJCQlyZXNvdXJjZUFycmF5ID0gc3BsaXRCeUNvbW1hKCBhc3NldElkU3RyaW5nICk7CgoJCWlmIChyZXNvdXJjZUFycmF5Lmxlbmd0aCA9PT0gMSkgewoJCQlydG5Qcm9taXNlID0gbG9hZFN0YW5kYWxvbmVBc3NldCggcmVzb3VyY2VBcnJheVswXSApOwoJCX0KCQllbHNlIHsKCQkJZm9yICh2YXIgaSA9IDA7IGkgPCByZXNvdXJjZUFycmF5Lmxlbmd0aDsgaSsrKSB7CgkJCQlwcm9taXNlcy5wdXNoKCBsb2FkU3RhbmRhbG9uZUFzc2V0KCByZXNvdXJjZUFycmF5W2ldICkgKTsKCQkJfQoJCQlydG5Qcm9taXNlID0gJC53aGVuLmFwcGx5KCAkLCBwcm9taXNlcyApOwoJCX0KCgkJcmV0dXJuIGF1Z21lbnRQcm9taXNlKCBydG5Qcm9taXNlICkuZmFpbCggZnVuY3Rpb24oKSB7CgkJCV9sb2FkZXIudW5sb2FkKCBhc3NldElkU3RyaW5nICk7CgkJfSApOwoJfQoKCS8vcmVzb3VyY2VzIGNhbiBiZSAiYS5qcywgYi5jc3MsIGMudG1wbCIKCS8vaXQgY2FuIGJlIFsiYS5qcyIsICJiLmNzcyIsICJjLnRtcGwiXQoJLy9vciBbImEuanMsYi5jc3MiLCBbImMudG1wbCIsICJkLnRtcGwiXSwgImUuY3NzIl0gYW5kIHNvIG9uCgkvL2l0IHNlcmlhbCBsb2FkIHRoZSB0b3AgbGV2ZWwgcmVzb3VyY2UgdW5pdCwgd2l0aGluIGVhY2ggcmVzb3VyY2UgdW5pdCwgdXNlIHNtYXJ0CgkvL2xvYWRlcgoJZnVuY3Rpb24gbG9hZEFzc2V0c0luU2VyaWFsKCBhc3NldElkQXJyYXkgKSB7CgkJdmFyIHJ0blByb21pc2UsCgkJCWksCgkJCXRvUmVsZWFzZVJlc291cmNlID0gW10sCgkJCWN1cnJlbnRSZXNvdXJjZVN0cmluZ09yQXJyYXksCgkJCXNoYXJlZFN0YXRlID0gewoJCQkJb2s6IHRydWUKCQkJfTsKCgkJZm9yIChpID0gMDsgaSA8IGFzc2V0SWRBcnJheS5sZW5ndGg7IGkrKykgewoJCQljdXJyZW50UmVzb3VyY2VTdHJpbmdPckFycmF5ID0gYXNzZXRJZEFycmF5W2ldOwoJCQl0b1JlbGVhc2VSZXNvdXJjZS5wdXNoKCBjdXJyZW50UmVzb3VyY2VTdHJpbmdPckFycmF5ICk7CgoJCQlpZiAoaSA9PT0gMCkgewoKCQkJCXJ0blByb21pc2UgPSBsb2FkQXNzZXRzKCBjdXJyZW50UmVzb3VyY2VTdHJpbmdPckFycmF5ICkKCQkJCQkuZmFpbCggbWFrZVJlbGVhc2VGbiggY3VycmVudFJlc291cmNlU3RyaW5nT3JBcnJheSwgc2hhcmVkU3RhdGUgKSApOwoKCQkJfSBlbHNlIHsKCgkJCQlydG5Qcm9taXNlID0gcnRuUHJvbWlzZS5uZXh0TG9hZCggY3VycmVudFJlc291cmNlU3RyaW5nT3JBcnJheSApCgkJCQkJLmZhaWwoIG1ha2VSZWxlYXNlRm4oIHRvUmVsZWFzZVJlc291cmNlLnNsaWNlKCksIHNoYXJlZFN0YXRlICkgKTsKCQkJfQoJCX0KCgkJcmV0dXJuIGF1Z21lbnRQcm9taXNlKCBydG5Qcm9taXNlICk7Cgl9CgoJZnVuY3Rpb24gbWFrZVJlbGVhc2VGbiggcmVzb3VyY2VTdHJpbmdPckFycmF5LCBzaGFyZWRTdGF0ZSApIHsKCQlyZXR1cm4gZnVuY3Rpb24oKSB7CgkJCWlmIChzaGFyZWRTdGF0ZS5vaykgewoJCQkJX2xvYWRlci51bmxvYWQoIHJlc291cmNlU3RyaW5nT3JBcnJheSApOwoJCQkJc2hhcmVkU3RhdGUub2sgPSBmYWxzZTsKCQkJfQoJCX07Cgl9CgoJZnVuY3Rpb24gbG9hZFN0YW5kYWxvbmVBc3NldCggYXNzZXRJZCApIHsKCQl2YXIgbG9hZGVyID0gZmluZExvYWRlciggYXNzZXRJZCApOwoJCWlmIChsb2FkZXIpIHsKCgkJCXJldHVybiBsb2FkU3RhbmRhbG9uZUFzc2V0V2l0aExvYWRlciggYXNzZXRJZCwgbG9hZGVyICk7CgoJCX0gZWxzZSB7CgoJCQkvLyNkZWJ1ZwoJCQlfbG9hZGVyLmRlYnVnLmxvZyggInRyeSB0byBsb2FkIG1pc3NpbmcgbG9hZGVyICIgKyBmaWxlRXh0ZW5zaW9uKCBhc3NldElkICkgKyAiLmxvYWRlciIgKTsKCQkJLy8jZW5kX2RlYnVnCgoJCQlyZXR1cm4gX2xvYWRlci5sb2FkKCBmaWxlRXh0ZW5zaW9uKCBhc3NldElkICkgKyAiLmxvYWRlciIgKS5uZXh0TG9hZCggYXNzZXRJZCApOwoJCX0KCX0KCglmdW5jdGlvbiBsb2FkU3RhbmRhbG9uZUFzc2V0V2l0aExvYWRlciggYXNzZXRJZCwgbG9hZGVyICkgewoKCQkvLyNkZWJ1ZwoJCV9sb2FkZXIuZGVidWcubG9nKCAidHJ5IHRvIGxvYWQgIiArIGFzc2V0SWQgKyAiIEAgIiArIF9sb2FkZXIudXJsKCBhc3NldElkICkgKTsKCQkvLyNlbmRfZGVidWcKCgkJdmFyIHByb21pc2UgPSBhY2Nlc3NQcm9taXNlKCBhc3NldElkICk7CgoJCWlmICghcHJvbWlzZSkgewoKCQkJLy8jZGVidWcKCQkJX2xvYWRlci5kZWJ1Zy5sb2coICIgIGxvYWRpbmcgIiArIGFzc2V0SWQgKyAiIEAgIiArIF9sb2FkZXIudXJsKCBhc3NldElkICkgKTsKCQkJLy8jZW5kX2RlYnVnCgoJCQlwcm9taXNlID0gbG9hZGVyLmxvYWQoIGFzc2V0SWQgKTsKCgkJCWlmICghbG9hZGVyLm5vUmVmQ291bnQpIHsKCQkJCS8vYWRkIHRoZSBwcm9taXNlIHRvIGNhY2hlLAoJCQkJLy9pbiB0aGUgZnV0dXJlLCBpdCBjYW4gYmUgcmV0cmlldmVkIGJ5IGFjY2Vzc1Byb21pc2UoYXNzZXRJZCkKCQkJCWFjY2Vzc1Byb21pc2UoIGFzc2V0SWQsIHByb21pc2UgKTsKCQkJfQoJCX0KCQkvLyNkZWJ1ZwoJCWVsc2UgewoJCQlfbG9hZGVyLmRlYnVnLmxvZyggIiAgZm91bmQgbG9hZGVkIGFzc2V0ICIgKyBhc3NldElkICsgIiBAICIgKyBfbG9hZGVyLnVybCggYXNzZXRJZCApICk7CgkJfQoJCS8vI2VuZF9kZWJ1ZwoKCQkvL3ByZWxvYWQgYXNzZXQgd2lsbCBuZXZlciBiZSBjb3VudGVkIGZvciByZWZlcmVuY2UKCQkvL2FzIHdlIGRvbid0IHdhbnQgdGhhdCB0byBiZSB1bmxvYWRlZAoJCWlmIChwcm9taXNlLnJlZkNvdW50ICE9PSAic3RhdGljTG9hZGVkIikgewoJCQlwcm9taXNlLnJlZkNvdW50ID0gcHJvbWlzZS5yZWZDb3VudCA/IHByb21pc2UucmVmQ291bnQgKyAxIDogMTsKCQl9CgkJcmV0dXJuIHByb21pc2U7Cgl9CgoJLy9yZXRyaWV2ZSBwcm9taXNlIGJ5IGFzc2V0SWQgb3IKCS8vc2V0IHByb21pc2UgYnkgYXNzZXRJZAoJZnVuY3Rpb24gYWNjZXNzUHJvbWlzZSggYXNzZXRJZCwgcHJvbWlzZSApIHsKCQlpZiAoYXNzZXRJZCA9PT0gdW5kZWZpbmVkKSB7CgkJCXJldHVybiBwcm9taXNlU3RvcmU7CgkJfSBlbHNlIHsKCQkJaWYgKHByb21pc2UgPT09IHVuZGVmaW5lZCkgewoJCQkJaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDEpIHsKCQkJCQlyZXR1cm4gcHJvbWlzZVN0b3JlW2Fzc2V0SWRdOwoJCQkJfSBlbHNlIHsKCQkJCQlkZWxldGUgcHJvbWlzZVN0b3JlW2Fzc2V0SWRdOwoJCQkJfQoJCQl9IGVsc2UgewoJCQkJcHJvbWlzZVN0b3JlW2Fzc2V0SWRdID0gcHJvbWlzZTsKCQkJCXJldHVybiBwcm9taXNlOwoJCQl9CgkJfQoJfQoKCS8vYWRkIGEgcHJvbWlzZS5uZXh0TG9hZCBtZXRob2QgZHluYW1pY2FsbHksIHNvIHRoYXQgaXQgY2FuCgkvL2JlIHVzZWQgbG9hZCBvdGhlciBhc3NldCB3aGVuIGN1cnJlbnQgcHJvbWlzZSBmaW5pc2hlZAoJLy90aGUgbmV4dExvYWQgbWV0aG9kIGlzIGEgc21hcnRMb2FkIG1ldGhvZCwgdXNlIHRoZSBzYW1lIHdheSBpbiB3aGljaAoJLy95b3UgY2FsbCBsb2FkZXIKCWZ1bmN0aW9uIGF1Z21lbnRQcm9taXNlKCBwcm9taXNlICkgewoJCXZhciBuZXh0RGVmZXIgPSAkLkRlZmVycmVkKCk7CgoJCS8vbmV4dExvYWQgbWV0aG9kIGxvYWQgYWZ0ZXIgdGhlIGN1cnJlbnQgY3VycmVudFByb21pc2UgaXMgZG9uZQoJCXByb21pc2UubmV4dExvYWQgPSBmdW5jdGlvbiggYXNzZXRJZCApIHsKCQkJdmFyIG5leHRMb2FkQXJndW1lbnRzID0gc2xpY2UuY2FsbCggYXJndW1lbnRzICk7CgkJCXByb21pc2UudGhlbigKCQkJCWZ1bmN0aW9uKCkgewoJCQkJCV9sb2FkZXIubG9hZC5hcHBseSggbnVsbCwgbmV4dExvYWRBcmd1bWVudHMgKS50aGVuKAoJCQkJCQlmdW5jdGlvbigpIHsKCQkJCQkJCW5leHREZWZlci5yZXNvbHZlLmFwcGx5KCBuZXh0RGVmZXIsIHNsaWNlLmNhbGwoIGFyZ3VtZW50cyApICk7CgkJCQkJCX0sCgkJCQkJCWZ1bmN0aW9uKCkgewoJCQkJCQkJbmV4dERlZmVyLnJlamVjdCggYXNzZXRJZCApOwoJCQkJCQl9ICk7CgkJCQl9LAoJCQkJZnVuY3Rpb24oKSB7CgkJCQkJbmV4dERlZmVyLnJlamVjdCggYXNzZXRJZCApOwoJCQkJfSApOwoKCQkJcmV0dXJuIGF1Z21lbnRQcm9taXNlKCBuZXh0RGVmZXIucHJvbWlzZSgpICk7CgkJfTsKCgkJcHJvbWlzZS5hbmRMb2FkID0gZnVuY3Rpb24oKSB7CgkJCXZhciBjdXJyZW50UHJvbWlzZSA9IF9sb2FkZXIuYXBwbHkoIG51bGwsIGFyZ3VtZW50cyApOwoJCQlyZXR1cm4gYXVnbWVudFByb21pc2UoICQud2hlbiggY3VycmVudFByb21pc2UsIHByb21pc2UgKSApOwoJCX07CgoJCXJldHVybiBwcm9taXNlOwoJfQoKCWZ1bmN0aW9uIHNwbGl0QnlDb21tYSggdGV4dCApIHsKCQlyZXR1cm4gdGV4dC5yZXBsYWNlKCByU3BhY2UsICIiICkuc3BsaXQoIHJDb21tYSApOwoJfQoKCWZ1bmN0aW9uIGlzQ3Jvc3NEb21haW4oIHVybCApIHsKCQl2YXIgcGFydHMgPSByVXJsUGFydHMuZXhlYyggdXJsLnRvTG93ZXJDYXNlKCkgKTsKCQlyZXR1cm4gISEoIHBhcnRzICYmCgkJICAgICAgICAgICAoIHBhcnRzWyAxIF0gIT0gYWpheExvY1BhcnRzWyAxIF0gfHwgcGFydHNbIDIgXSAhPSBhamF4TG9jUGFydHNbIDIgXSB8fAoJCSAgICAgICAgICAgICAoIHBhcnRzWyAzIF0gfHwgKCBwYXJ0c1sgMSBdID09PSAiaHR0cDoiID8gODAgOiA0NDMgKSApICE9CgkJICAgICAgICAgICAgICggYWpheExvY1BhcnRzWyAzIF0gfHwgKCBhamF4TG9jUGFydHNbIDEgXSA9PT0gImh0dHA6IiA/IDgwIDogNDQzICkgKSApCgkJCSk7Cgl9CgoJZnVuY3Rpb24gZnVsbFVybCggdXJsUmVsYXRpdmVUb0Jhc2VVcmwgKSB7CgoJCWR1bW15TGluay5ocmVmID0gckFic29sdXRlVXJsLnRlc3QoIHVybFJlbGF0aXZlVG9CYXNlVXJsICkgPyB1cmxSZWxhdGl2ZVRvQmFzZVVybCA6CgkJCWJhc2VVcmwgKyB1cmxSZWxhdGl2ZVRvQmFzZVVybDsKCgkJcmV0dXJuIGlzQ3Jvc3NEb21haW4oIHVybFJlbGF0aXZlVG9CYXNlVXJsICkgPyBkdW1teUxpbmsuaHJlZiA6IGFkZEhhc2goIGR1bW15TGluay5ocmVmICk7Cgl9CgoJZnVuY3Rpb24gY29udmVydExvYWRGaWx0ZXJzVG9Mb2FkTWV0aG9kKCBsb2FkRmlsdGVycyApIHsKCgkJZm9yICh2YXIga2V5IGluIGxvYWRGaWx0ZXJzKSB7CgkJCWF0dGFjaEZpbHRlciggbG9hZEZpbHRlcnMsIGtleSApOwoJCX0KCgkJdmFyIHN0YXRpY0xvYWRlZCA9IGxvYWRGaWx0ZXJzLnN0YXRpY0xvYWRlZCB8fCBjb21tb25Mb2FkRmlsdGVycy5zdGF0aWNMb2FkZWQucmV0dXJuRmFsc2UsCgkJCWdldFNvdXJjZSA9IGxvYWRGaWx0ZXJzLmdldFNvdXJjZSB8fCBjb21tb25Mb2FkRmlsdGVycy5nZXRTb3VyY2UuZ2V0VGV4dEJ5QWpheCwKCQkJY29tcGlsZSA9IGxvYWRGaWx0ZXJzLmNvbXBpbGUgPT09IHVuZGVmaW5lZCA/IGNvbW1vbkxvYWRGaWx0ZXJzLmNvbXBpbGUuZ2xvYmFsRXZhbCA6IGxvYWRGaWx0ZXJzLmNvbXBpbGUsCgkJCWNyb3NzU2l0ZUxvYWQgPSBsb2FkRmlsdGVycy5jcm9zc1NpdGVMb2FkIHx8IGNvbW1vbkxvYWRGaWx0ZXJzLmNyb3NzU2l0ZUxvYWQuZ2V0U2NyaXB0LAoJCQlidWlsZERlcGVuZGVuY2llcyA9IGxvYWRGaWx0ZXJzLmJ1aWxkRGVwZW5kZW5jaWVzIHx8IGNvbW1vbkxvYWRGaWx0ZXJzLmJ1aWxkRGVwZW5kZW5jaWVzLnBhcnNlRGVwZW5kVGFnLAoJCQlidWlsZFVubG9hZCA9IGxvYWRGaWx0ZXJzLmJ1aWxkVW5sb2FkIHx8IGNvbW1vbkxvYWRGaWx0ZXJzLmJ1aWxkVW5sb2FkLnBhcnNlVW5sb2FkVGFnOwoKCQlpZiAoIWNvbXBpbGUgJiYgIWNyb3NzU2l0ZUxvYWQpIHsKCQkJdGhyb3cgImxvYWRlciBtdXN0IGltcGxlbWVudCBhdCBsZWFzdCBvbmUgb2YgY29tcGlsZSwgY3Jvc3NTaXRlTG9hZCI7CgkJfQoKCQlyZXR1cm4gZnVuY3Rpb24oIGFzc2V0SWQgKSB7CgkJCXZhciBkZWZlciA9ICQuRGVmZXJyZWQoKSwKCQkJCXByb21pc2UgPSBkZWZlci5wcm9taXNlKCksCgkJCQl1cmw7CgoJCQlpZiAoc3RhdGljTG9hZGVkKCBhc3NldElkICkpIHsKCgkJCQkvLyNkZWJ1ZwoJCQkJX2xvYWRlci5kZWJ1Zy5sb2coICIgICAgYnlwYXNzIHN0YXRpY0xvYWRlZGVkIGFzc2V0ICIgKyBhc3NldElkICsgIiBAICIgKyBfbG9hZGVyLnVybCggYXNzZXRJZCApICk7CgkJCQkvLyNlbmRfZGVidWcKCQkJCXByb21pc2UucmVmQ291bnQgPSAic3RhdGljTG9hZGVkIjsKCQkJCWRlZmVyLnJlc29sdmUoKTsKCgkJCX0gZWxzZSB7CgkJCQl1cmwgPSBfbG9hZGVyLnVybCggYXNzZXRJZCApOwoJCQkJaWYgKCFjb21waWxlIHx8IGxvYWRGaWx0ZXJzLmJ5UGFzc0dldFNvdXJjZSB8fCBpc0Nyb3NzRG9tYWluKCB1cmwgKSkgewoKCQkJCQlpZiAoIWNyb3NzU2l0ZUxvYWQpIHsKCQkJCQkJdGhyb3cgImxvYWRlciBkb2VzIG5vdCBzdXBwb3J0IGNyb3NzIGRvbWFpbiBsb2FkaW5nIjsKCQkJCQl9CgkJCQkJLy8jZGVidWcKCQkJCQlfbG9hZGVyLmRlYnVnLmxvZyggIiAgICBjcm9zcy1zaXRlIGZldGNoICIgKyBhc3NldElkICsgIiBAICIgKyB1cmwgKTsKCQkJCQkvLyNlbmRfZGVidWcKCgkJCQkJcmV0dXJuIGNyb3NzU2l0ZUxvYWQoIGFzc2V0SWQgKTsKCgkJCQl9IGVsc2UgewoKCQkJCQkvLyNkZWJ1ZwoJCQkJCV9sb2FkZXIuZGVidWcubG9nKCAiICAgIGxvY2FsIGZldGNoICIgKyBhc3NldElkICsgIiBAICIgKyB1cmwgKTsKCQkJCQkvLyNlbmRfZGVidWcKCgkJCQkJZ2V0U291cmNlKCBhc3NldElkICkudGhlbigKCQkJCQkJZnVuY3Rpb24oIHNvdXJjZUNvZGUgKSB7CgoJCQkJCQkJLy8jZGVidWcKCQkJCQkJCV9sb2FkZXIuZGVidWcubG9nKCAiICAgICAgcGFyc2luZyBjb250ZW50IG9mICIgKyBhc3NldElkICk7CgkJCQkJCQkvLyNlbmRfZGVidWcKCgkJCQkJCQlpZiAoYnVpbGRVbmxvYWQpIHsKCgkJCQkJCQkJLy8jZGVidWcKCQkJCQkJCQlfbG9hZGVyLmRlYnVnLmxvZyggIiAgICAgICAgYnVpbGRVbmxvYWQgZm9yICIgKyBhc3NldElkICk7CgkJCQkJCQkJLy8jZW5kX2RlYnVnCgoJCQkJCQkJCXZhciB1bmxvYWQgPSBidWlsZFVubG9hZCggc291cmNlQ29kZSwgYXNzZXRJZCApOwoKCQkJCQkJCQlpZiAodW5sb2FkKSB7CgkJCQkJCQkJCS8vI2RlYnVnCgkJCQkJCQkJCV9sb2FkZXIuZGVidWcubG9nKCAiICAgICAgICAgIHVubG9hZCBjcmVhdGVkIGZvciAiICsgYXNzZXRJZCApOwoJCQkJCQkJCQkvLyNlbmRfZGVidWcKCgkJCQkJCQkJCWFjY2Vzc1Byb21pc2UoIGFzc2V0SWQgKS51bmxvYWQgPSB1bmxvYWQ7CgkJCQkJCQkJfQoKCQkJCQkJCX0KCgkJCQkJCQlpZiAoYnVpbGREZXBlbmRlbmNpZXMpIHsKCgkJCQkJCQkJLy8jZGVidWcKCQkJCQkJCQlfbG9hZGVyLmRlYnVnLmxvZyggIiAgICAgICAgYnVpbGREZXBlbmRlbmNpZXMgZm9yICIgKyBhc3NldElkICk7CgkJCQkJCQkJLy8jZW5kX2RlYnVnCgoJCQkJCQkJCXZhciBlbWJlZGRlZERlcGVuZGVuY2llcyA9IGJ1aWxkRGVwZW5kZW5jaWVzKCBhc3NldElkLCBzb3VyY2VDb2RlICk7CgkJCQkJCQkJaWYgKGVtYmVkZGVkRGVwZW5kZW5jaWVzKSB7CgkJCQkJCQkJCS8vI2RlYnVnCgkJCQkJCQkJCV9sb2FkZXIuZGVidWcubG9nKCAiICAgICAgICAgIGRlcGVuZGVuY2llcyBmb3VuZCBmb3IgIiArIGFzc2V0SWQgKyAiOiIgKyBlbWJlZGRlZERlcGVuZGVuY2llcyApOwoJCQkJCQkJCQkvLyNlbmRfZGVidWcKCQkJCQkJCQkJZGVwZW5kKCBhc3NldElkLCBlbWJlZGRlZERlcGVuZGVuY2llcyApOwoJCQkJCQkJCX0KCQkJCQkJCX0KCgkJCQkJCQl2YXIgcnVuY29tcGlsZSA9IGZ1bmN0aW9uKCkgewoKCQkJCQkJCQkvLyNkZWJ1ZwoJCQkJCQkJCV9sb2FkZXIuZGVidWcubG9nKCAiICAgICAgY29tcGlsaW5nICIgKyBhc3NldElkICsgIiBAICIgKyB1cmwgKTsKCQkJCQkJCQkvLyNlbmRfZGVidWcKCgkJCQkJCQkJdmFyIHJlc3VsdCA9IGNvbXBpbGUgJiYgY29tcGlsZSggYXNzZXRJZCwgc291cmNlQ29kZSApOwoJCQkJCQkJCS8vZGVsYXkgZGVmZXIucmVzb2x2ZSBhIGZvciB3aGlsZSB0byB3YWl0IGZvciB0aGUgY29tcGlsZSByZXN1bHQKCQkJCQkJCQkvL3RvIHRha2UgZWZmZWN0LCBpZiBjb21waWxlIGlzICQuZ2xvYmFsRXZhbAoJCQkJCQkJCXNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCQkJCQkJCQlpZiAoIWRlZmVyLmRvbnRSZXNvbHZlKSB7CgkJCQkJCQkJCQlkZWZlci5yZXNvbHZlKCByZXN1bHQgKTsKCQkJCQkJCQkJCWRlbGV0ZSBwcm9taXNlLmRlZmVyOwoJCQkJCQkJCQl9CgkJCQkJCQkJfSwgNSApOwoJCQkJCQkJfTsKCgkJCQkJCQl2YXIgZGVwZW5kZW5jaWVzID0gZGVwZW5kKCBhc3NldElkICk7CgoJCQkJCQkJLy9sb2FkIGRlcGVuZGVuY2llcyBiZWNhdXNlIGl0IGNvbWJpbmVzIHN0YXRpYyBkZXBlbmRlbnRNb2R1bGVTdHJpbmcKCQkJCQkJCS8vYW5kIGR5bmFtaWMgZGVwZW5kZW50TW9kdWxlU3RyaW5nCgkJCQkJCQlpZiAoZGVwZW5kZW5jaWVzKSB7CgkJCQkJCQkJX2xvYWRlci5sb2FkKCBkZXBlbmRlbmNpZXMgKS50aGVuKCBydW5jb21waWxlLCBmdW5jdGlvbigpIHsKCQkJCQkJCQkJZGVmZXIucmVqZWN0KCBhc3NldElkICk7CgkJCQkJCQkJCWRlbGV0ZSBwcm9taXNlLmRlZmVyOwoJCQkJCQkJCX0gKTsKCQkJCQkJCX0gZWxzZSB7CgkJCQkJCQkJcnVuY29tcGlsZSgpOwoJCQkJCQkJfQoKCQkJCQkJfSwKCQkJCQkJZnVuY3Rpb24oKSB7CgkJCQkJCQlkZWZlci5yZWplY3QoIGFzc2V0SWQgKTsKCQkJCQkJCWRlbGV0ZSBwcm9taXNlLmRlZmVyOwoJCQkJCQl9CgkJCQkJKTsKCQkJCX0KCQkJCWlmICghaXNSZXNvbHZlZCggZGVmZXIgKSkgewoJCQkJCXByb21pc2UuZGVmZXIgPSBkZWZlcjsKCQkJCX0KCQkJfQoJCQlyZXR1cm4gcHJvbWlzZTsKCQl9OwoJfQoKCXZhciBpc1Jlc29sdmVkID0gJC5EZWZlcnJlZCgpLmlzUmVzb2x2ZWQgPyBmdW5jdGlvbiggcHJvbWlzZSApIHsKCQlyZXR1cm4gcHJvbWlzZS5pc1Jlc29sdmVkKCk7Cgl9IDogZnVuY3Rpb24oIHByb21pc2UgKSB7CgkJcmV0dXJuIHByb21pc2Uuc3RhdGUoKSA9PSAicmVzb2x2ZWQiOwoJfTsKCglmdW5jdGlvbiBhZGRIYXNoKCB1cmwgKSB7CgkJdXJsID0gcmVtb3ZlSGFzaCggdXJsICk7CgkJcmV0dXJuIGhhc2hWYWx1ZSA/CgkJCXVybCArICggclF1ZXJ5LnRlc3QoIHVybCApID8gIiYiIDogIj8iICkgKyBoYXNoS2V5ICsgIj0iICsgaGFzaFZhbHVlIDoKCQkJdXJsOwoJfQoKCWZ1bmN0aW9uIHJlbW92ZUhhc2goIHVybCApIHsKCQlpZiAoaGFzaFZhbHVlID09PSAiIikgewoJCQlyZXR1cm4gdXJsOwoJCX0gZWxzZSB7CgkJCXJldHVybiB1cmwucmVwbGFjZSggclZlcnNpb25IYXNoLCAiIiApOwoJCX0KCX0KCgkkLmV4dGVuZCggX2xvYWRlciwgewoKCQkvL2ZvciBwYXJhbGxlbCBsb2FkaW5nCgkJLy8KCQkvLyBsb2FkZXIubG9hZChhc3NldElkU3RyaW5nKQoJCS8vIGxvYWRlci5sb2FkKGFzc2V0SWRTdHJpbmcsIHVzZUltcGxpY2l0RGVwZW5kZW5jaWVzKQoJCS8vIGxvYWRlci5sb2FkKGhvbGRSZWFkeSwgYXNzZXRJZFN0cmluZykKCQkvLyBsb2FkZXIubG9hZChob2xkUmVhZHksIGFzc2V0SWRTdHJpbmcsIHVzZUltcGxpY2l0RGVwZW5kZW5jaWVzKQoJCS8vCgkJLy9mb3Igc2VyaWFsIGxvYWRpbmcgYW5kIG1peGVkIHNlcmlhbC9wYXJhbGxlbCBsb2FkaW5nIGxvYWRlcgoJCS8vCgkJLy8gbG9hZGVyLmxvYWQoYXNzZXRJZEFycmF5KQoJCS8vIGxvYWRlci5sb2FkKGhvbGRSZWFkeSBhc3NldElkQXJyYXkpCgkJLy8KCQlsb2FkOiBmdW5jdGlvbiggaG9sZFJlYWR5LCBhc3NldElkcywgaW5mZXJEZXBlbmRlbmNpZXNGcm9tSWRPcmRlciApIHsKCQkJdmFyIHJ0blByb21pc2U7CgkJCWlmICghaXNCb29sZWFuKCBob2xkUmVhZHkgKSkgewoJCQkJLy9ieSBkZWZhdWx0IGl0IGlzIGZhbHNlCgkJCQlpbmZlckRlcGVuZGVuY2llc0Zyb21JZE9yZGVyID0gYXNzZXRJZHM7CgkJCQlhc3NldElkcyA9IGhvbGRSZWFkeTsKCQkJCWhvbGRSZWFkeSA9IGZhbHNlOwoJCQl9CgkJCWlmICghYXNzZXRJZHMpIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJaG9sZFJlYWR5ID0gaG9sZFJlYWR5ICYmICEkLmlzUmVhZHk7CgoJCQlydG5Qcm9taXNlID0gbG9hZEFzc2V0cyggYXNzZXRJZHMsIGluZmVyRGVwZW5kZW5jaWVzRnJvbUlkT3JkZXIgKTsKCgkJCWlmIChob2xkUmVhZHkpIHsKCgkJCQkkLmhvbGRSZWFkeSggdHJ1ZSApOwoKCQkJCXJ0blByb21pc2UuZG9uZSggZnVuY3Rpb24oKSB7CgkJCQkJJC5ob2xkUmVhZHkoKTsKCQkJCQkvL3NhbWUgYXMgdGhlIGZvbGxvd2luZwoJCQkJCS8vJC5ob2xkUmVhZHkoIGZhbHNlICk7CgkJCQkJLy8kLnJlYWR5KCB0cnVlICk7CgkJCQl9ICk7CgkJCX0KCgkJCXJldHVybiBydG5Qcm9taXNlLmRvbmUoIGludm9rZUxvYWRDYWxsYmFja3MgKS5mYWlsKCBpbnZva2VGYWlsQ2FsbGJhY2tzICk7CgkJfSwKCQkvL3VubG9hZChsb2FkQ2FsbGJhY2spIG9yIHVubG9hZCh1bmxvYWRDYWxsYmFjaywgcmVtb3ZlPXRydWUpCgkJLy91bmxvYWQoYXNzZXRJZFN0cmluZykKCQkvL3VubG9hZChhc3NldElkQXJyYXkpCgkJdW5sb2FkOiBmdW5jdGlvbiggYXNzZXRJZHMsIHJlbW92ZSApIHsKCQkJdmFyIGksCgkJCQlhc3NldElkLAoJCQkJZGVwZW5kZW5jaWVzLAoJCQkJcHJvbWlzZTsKCgkJCWlmICgkLmlzRnVuY3Rpb24oIGFzc2V0SWRzICkpIHsKCQkJCWlmIChyZW1vdmUpIHsKCQkJCQl1bmxvYWRDYWxsYmFja3MucmVtb3ZlKCBhc3NldElkcyApOwoJCQkJfSBlbHNlIHsKCQkJCQl1bmxvYWRDYWxsYmFja3MucHVzaCggYXNzZXRJZHMgKTsKCQkJCX0KCgkJCX0gZWxzZSB7CgoJCQkJaWYgKGlzU3RyaW5nKCBhc3NldElkcyApKSB7CgkJCQkJYXNzZXRJZHMgPSBzcGxpdEJ5Q29tbWEoIGFzc2V0SWRzICk7CgkJCQl9CgoJCQkJLy9pZiB0aGVyZSBpcyBvbmx5IG9uZSBtb2R1bGUKCQkJCWlmIChhc3NldElkcy5sZW5ndGggIT0gMSkgewoKCQkJCQlmb3IgKGkgPSAwOyBpIDwgYXNzZXRJZHMubGVuZ3RoOyBpKyspIHsKCQkJCQkJX2xvYWRlci51bmxvYWQoIGFzc2V0SWRzW2ldICk7CgkJCQkJfQoKCQkJCX0gZWxzZSB7CgoJCQkJCS8vdW5sb2FkIHNlcnZlcmFsIG1vZHVsZXMKCQkJCQlhc3NldElkID0gYXNzZXRJZHNbMF07CgkJCQkJcHJvbWlzZSA9IGFjY2Vzc1Byb21pc2UoIGFzc2V0SWQgKTsKCgkJCQkJLy9tYWtlIHN1cmUgaXQgd2lsbCBub3QgdGhyb3cgZXhjZXB0aW9uIHdoZW4KCQkJCQkvLyB1bmxvYWRpbmcgc29tZSBtb2R1bGUgd2hpY2ggaXMgbm90IGluIHBhZ2UKCQkJCQlpZiAocHJvbWlzZSAmJiBwcm9taXNlLnJlZkNvdW50ICE9ICJzdGF0aWNMb2FkZWQiKSB7CgoJCQkJCQlpZiAoLS1wcm9taXNlLnJlZkNvdW50ID09PSAwIHx8IHJlbW92ZSkgewoJCQkJCQkJdmFyIHVubG9hZCA9IHByb21pc2UudW5sb2FkIHx8IGZpbmRMb2FkZXIoIGFzc2V0SWQgKS51bmxvYWQ7CgoJCQkJCQkJaWYgKHVubG9hZCkgewoJCQkJCQkJCS8vI2RlYnVnCgkJCQkJCQkJX2xvYWRlci5kZWJ1Zy5sb2coICJ1bmxvYWRpbmcgIiArIGFzc2V0SWQgKyAiIEAgIiArIF9sb2FkZXIudXJsKCBhc3NldElkICkgKTsKCQkJCQkJCQkvLyNlbmRfZGVidWcKCQkJCQkJCQl1bmxvYWQoIGFzc2V0SWQgKTsKCQkJCQkJCX0KCgkJCQkJCQkvL2RlbGV0ZSB0aGUgcHJvbWlzZXMgYXNzb2NpYXRlZCB3aXRoIHRoZSBtb2R1bGUKCQkJCQkJCWFjY2Vzc1Byb21pc2UoIGFzc2V0SWQsIHVuZGVmaW5lZCApOwoJCQkJCQkJZGVwZW5kZW5jaWVzID0gZGVwZW5kKCBhc3NldElkICk7CgkJCQkJCQlpZiAoZGVwZW5kZW5jaWVzKSB7CgkJCQkJCQkJX2xvYWRlci51bmxvYWQoIGRlcGVuZGVuY2llcywgcmVtb3ZlICk7CgkJCQkJCQkJZGVwZW5kKCBhc3NldElkLCB1bmRlZmluZWQgKTsKCQkJCQkJCX0KCgkJCQkJCX0KCQkJCQkJaW52b2tlVW5sb2FkQ2FsbGJhY2tzKCk7CgkJCQkJfQoJCQkJfQoJCQl9CgkJfSwKCgkJLy9yZWdpc3RlciBhIHVybCBmb3IgbW9kdWxlIGtleQoJCS8vb3IgZ2V0IHRoZSB1cmwgb2YgbW9kdWxlIGtleQoJCXVybDogZnVuY3Rpb24oIGFzc2V0SWQsIHVybCApIHsKCQkJaWYgKGlzT2JqZWN0KCBhc3NldElkICkpIHsKCQkJCWZvciAodmFyIGsgaW4gYXNzZXRJZCkgewoJCQkJCV9sb2FkZXIudXJsKCBrLCBhc3NldElkW2tdICk7CgkJCQl9CgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vaWYgcmVzb3VyY2UncyB1cmwgaXMgbm90IGluIGNhY2hlCgkJCS8vYW5kIHVzZXIgaXMgdHJ5aW5nIHRvIGdldCBpdAoJCQlpZiAodXJsID09PSB1bmRlZmluZWQpIHsKCgkJCQlpZiAoYXJndW1lbnRzLmxlbmd0aCA9PSAxKSB7CgoJCQkJCWlmICh1cmxTdG9yZVthc3NldElkXSkgewoJCQkJCQlyZXR1cm4gdXJsU3RvcmVbYXNzZXRJZF07CgkJCQkJfQoKCQkJCQl2YXIgbG9hZGVyID0gZmluZExvYWRlciggYXNzZXRJZCApOwoKCQkJCQlyZXR1cm4gZnVsbFVybCgKCQkJCQkJbG9hZGVyICYmIGxvYWRlci51cmwgPyBsb2FkZXIudXJsKCBhc3NldElkICkgOgoJCQkJCQkJbG9hZGVyICYmIGxvYWRlci5maWxlRXh0ID8gZmlsZU5hbWUoIGFzc2V0SWQgKSArICIuIiArIGxvYWRlci5maWxlRXh0IDoKCQkJCQkJCQlhc3NldElkCgkJCQkJKTsKCgkJCQl9IGVsc2UgewoKCQkJCQkvL2FsbG93IGFjY2VzcyhrZXksIHVuZGVmaW5lZCkKCQkJCQkvL3RvIGRlbGV0ZSB0aGUga2V5IGZyb20gc3RvcmFnZQoJCQkJCWRlbGV0ZSB1cmxTdG9yZVthc3NldElkXTsKCQkJCX0KCgkJCX0gZWxzZSB7CgkJCQkvL3VzZXIgZXhwbGljaXQgcmVnaXN0ZXIgYW4gdXJsCgkJCQl2YXIgb2xkVXJsID0gX2xvYWRlci51cmwoIGFzc2V0SWQgKTsKCQkJCXZhciBuZXdVcmwgPSBmdWxsVXJsKCB1cmwgKTsKCgkJCQlpZiAob2xkVXJsICE9IG5ld1VybCkgewoJCQkJCXZhciBvbGRQcm9taXNlID0gYWNjZXNzUHJvbWlzZSggYXNzZXRJZCApOwoJCQkJCWlmIChvbGRQcm9taXNlICYmIGlzUmVzb2x2ZWQoIG9sZFByb21pc2UgKSkgewoJCQkJCQlyZWxvYWQoIGFzc2V0SWQsIGZ1bmN0aW9uKCkgewoJCQkJCQkJdXJsU3RvcmVbYXNzZXRJZF0gPSBuZXdVcmw7CgkJCQkJCX0gKTsKCQkJCQl9IGVsc2UgewoJCQkJCQl1cmxTdG9yZVthc3NldElkXSA9IG5ld1VybDsKCQkJCQl9CgkJCQl9CgkJCX0KCQl9LAoKCQkvLyBtZW1iZXJzIHRvIGNvbmZpZ3VyZSBsb2FkZXIKCgkJLy9hZGQgZGVwZW5kZW5jeSB0byBhIHJlc291cmNlIGtleQoJCS8vb3IgZ2V0IHRoZSBkZXBlbmRlbmN5IG9mIGEgcmVzb3VyY2Uga2V5CgkJLy91c2VyIGNhbiBzZXQgZGVwZW5kZW50UmVzb3VyY2VTdHJpbmcgbWFudWFsbHkgLCB3aGljaCBpcyBjYWxsZWQgc3RhdGljCgkJLy9kZXBlbmRlbnRSZXNvdXJjZVN0cmluZwoJCS8vIG9yIGNhbiB1c2UgbG9hZGVyLmRlcGVuZCBtZXRob2QgdG8gcmV0dXJuIGRlcGVuZGVudFJlc291cmNlU3RyaW5nIHdoaWNoIGlzIGNhbGxlZAoJCS8vZHluYW1pYyBkZXBlbmRlbnRSZXNvdXJjZVN0cmluZywKCQkvL29yIHdlIGNhbiBjb21iaW5lIHRoZW0gdG9nZXRoZXIKCQlkZXBlbmQ6IGRlcGVuZCA9IGZ1bmN0aW9uKCBhc3NldElkLCBkZXBlbmRlbmNpZXMgKSB7CgoJCQlpZiAoaXNPYmplY3QoIGFzc2V0SWQgKSkgewoJCQkJZm9yICh2YXIga2V5IGluIGFzc2V0SWQpIHsKCQkJCQlkZXBlbmQoIGtleSwgYXNzZXRJZFtrZXldICk7CgkJCQl9CgkJCQlyZXR1cm47CgkJCX0KCgkJCWlmIChkZXBlbmRlbmNpZXMgPT09IHVuZGVmaW5lZCkgewoJCQkJLy9nZXQgZGVwZW5kZW5jaWVzCgkJCQlpZiAoYXJndW1lbnRzLmxlbmd0aCA9PSAxKSB7CgkJCQkJdmFyIHN0YXRpY0RlcGVuZGVuY2llcyA9IGRlcGVuZGVuY3lTdG9yZVthc3NldElkXTsKCQkJCQl2YXIgbG9hZGVyID0gZmluZExvYWRlciggYXNzZXRJZCApOwoKCQkJCQlpZiAobG9hZGVyICYmIGxvYWRlci5kZXBlbmQpIHsKCQkJCQkJdmFyIGR5bmFtaWNEZXBlbmRlbmNpZXMgPSBsb2FkZXIuZGVwZW5kKCBhc3NldElkICk7CgkJCQkJCWlmIChkeW5hbWljRGVwZW5kZW5jaWVzICYmIHN0YXRpY0RlcGVuZGVuY2llcykgewoJCQkJCQkJcmV0dXJuIGR5bmFtaWNEZXBlbmRlbmNpZXMgKyAiLCIgKyBzdGF0aWNEZXBlbmRlbmNpZXM7CgkJCQkJCX0gZWxzZSBpZiAoZHluYW1pY0RlcGVuZGVuY2llcykgewoJCQkJCQkJcmV0dXJuIGR5bmFtaWNEZXBlbmRlbmNpZXM7CgkJCQkJCX0gZWxzZSB7CgkJCQkJCQlyZXR1cm4gc3RhdGljRGVwZW5kZW5jaWVzOwoJCQkJCQl9CgkJCQkJfSBlbHNlIHsKCQkJCQkJcmV0dXJuIHN0YXRpY0RlcGVuZGVuY2llczsKCQkJCQl9CgoJCQkJfSBlbHNlIHsKCQkJCQkvL2RlbGV0ZSBkZXBlbmRlbmNpZXMKCQkJCQlkZWxldGUgZGVwZW5kZW5jeVN0b3JlW2Fzc2V0SWRdOwoJCQkJfQoKCQkJfSBlbHNlIGlmIChkZXBlbmRlbmNpZXMgPT09IHRydWUpIHsKCQkJCS8vZm9yIGRlYnVnZ2luZyBwdXJwdXNlIGxvYWRlci5kZXBlbmQoYXNzZXRJZCwgdHJ1ZSkKCQkJCXZhciBhc3NldElkcyA9IGRlcGVuZCggYXNzZXRJZCApOwoJCQkJYXNzZXRJZHMgPSBhc3NldElkcyAmJiBzcGxpdEJ5Q29tbWEoIGFzc2V0SWRzICk7CgkJCQlpZiAoYXNzZXRJZHMpIHsKCQkJCQl2YXIgcnRuID0gW107CgkJCQkJZm9yICh2YXIgaSA9IDA7IGkgPCBhc3NldElkcy5sZW5ndGg7IGkrKykgewoJCQkJCQlpZiAoX2xvYWRlci5maWxlRXh0KCBhc3NldElkc1tpXSApICE9PSAibW9kdWxlIikgewoJCQkJCQkJcnRuLnB1c2hVbmlxdWUoIF9sb2FkZXIudXJsKCBhc3NldElkc1tpXSApICk7CgkJCQkJCX0KCQkJCQkJcnRuLm1lcmdlKCBkZXBlbmQoIGFzc2V0SWRzW2ldLCB0cnVlICkgKTsKCQkJCQl9CgkJCQkJcmV0dXJuIHJ0bjsKCQkJCX0KCgkJCX0gZWxzZSB7CgkJCQl2YXIgbmV3U3RhdGljRGVwZW5kZW5jaWVzID0gZ2V0TmV3U3RhdGljRGVwZW5kZW5jaWVzKCBhc3NldElkLCBkZXBlbmRlbmNpZXMgKTsKCQkJCXZhciBvbGRTdGF0aWNEZXBlbmRlbmNpZXMgPSBkZXBlbmRlbmN5U3RvcmVbYXNzZXRJZF07CgoJCQkJaWYgKGlzRGVwZW5kZW5jaWVzRGlmZmVyZW50KCBuZXdTdGF0aWNEZXBlbmRlbmNpZXMsIG9sZFN0YXRpY0RlcGVuZGVuY2llcyApKSB7CgoJCQkJCXZhciBvbGRQcm9taXNlID0gYWNjZXNzUHJvbWlzZSggYXNzZXRJZCApOwoJCQkJCWlmIChvbGRTdGF0aWNEZXBlbmRlbmNpZXMgJiYgb2xkUHJvbWlzZSAmJiBpc1Jlc29sdmVkKCBvbGRQcm9taXNlICkpIHsKCQkJCQkJcmVsb2FkKCBhc3NldElkLCBmdW5jdGlvbigpIHsKCQkJCQkJCWRlcGVuZGVuY3lTdG9yZVthc3NldElkXSA9IG5ld1N0YXRpY0RlcGVuZGVuY2llczsKCQkJCQkJfSApOwoJCQkJCX0gZWxzZSB7CgkJCQkJCWRlcGVuZGVuY3lTdG9yZVthc3NldElkXSA9IG5ld1N0YXRpY0RlcGVuZGVuY2llczsKCQkJCQl9CgkJCQl9CgkJCX0KCQl9LAoKCQkvL3RoZSB1cmwgcmVsYXRpdmUgdG8gdGhlIGN1cnJlbnQgd2luZG93IGxvY2F0aW9uLCBmb3IgZXhhbXBsZSAianMvIgoJCS8vdGhlIHN1ZmZpeCAiLyIgaXMgaW1wb3J0YW50CgkJLy9pdCBpcyB1c2VkIHRvIGNhbGN1bGF0ZSB0aGUgcmVhbCByZWxhdGl2ZSB1cmwgb2YgcmVzb3VyY2Uga2V5CgkJYmFzZVVybDogZnVuY3Rpb24oIHVybFJlbGF0aXZlVG9QYWdlICkgewoJCQlpZiAoaXNVbmRlZmluZWQoIHVybFJlbGF0aXZlVG9QYWdlICkpIHsKCQkJCXJldHVybiBiYXNlVXJsOwoJCQl9CgkJCWJhc2VVcmwgPSB1cmxSZWxhdGl2ZVRvUGFnZS5lbmRzV2l0aCggIi8iICkgPyB1cmxSZWxhdGl2ZVRvUGFnZSA6IHVybFJlbGF0aXZlVG9QYWdlICsgIi8iOwoJCX0sCgoJCS8vbG9hZGVyLmhhc2godHJ1ZSkgLS0+IHNldCBhIHRpbWVzdGFtcCBhcyBoYXNoID92PTIzNDc0ODM3NDgKCQkvL2xvYWRlci5oYXNoKDEseCkgLS0+ID94PTEKCQkvL2xvYWRlci5oYXNoKDEpIC0tPiA/dj0xCgkJaGFzaDogZnVuY3Rpb24oIHZhbHVlLCBrZXkgKSB7CgkJCWlmIChhcmd1bWVudHMubGVuZ3RoKSB7CgkJCQloYXNoVmFsdWUgPSB2YWx1ZSA9PT0gdHJ1ZSA/ICQubm93KCkgOiB2YWx1ZTsKCQkJCWhhc2hLZXkgPSBrZXkgIT09IHVuZGVmaW5lZCA/IGtleSA6IChoYXNoS2V5IHx8ICJ2Iik7CgkJCQlyVmVyc2lvbkhhc2ggPSBuZXcgUmVnRXhwKCAiWz8mXSIgKyBoYXNoS2V5ICsgIj1bXiZdKiIgKTsKCQkJfQoJCQlyZXR1cm4gaGFzaFZhbHVlID09PSAiIiA/ICIiIDogaGFzaEtleSArICI9IiArIGhhc2hWYWx1ZTsKCQl9LAoKCQkvL3N1cHBvcnQgbWV0aG9kIGxvYWQsIHVubG9hZCwgdXJsLCBkZXBlbmQKCQltZXRob2RzOiBjb21tb25Mb2FkZXJNZXRob2RzID0gewoKCQkJbG9hZDogewoJCQkJY2FjaGVJbWFnZTogZnVuY3Rpb24oIGFzc2V0SWQgKSB7CgkJCQkJdmFyIGRlZmVyID0gJC5EZWZlcnJlZCgpLAoJCQkJCQlwcm9taXNlID0gZGVmZXIucHJvbWlzZSgpLAoJCQkJCQl1cmwgPSBfbG9hZGVyLnVybCggYXNzZXRJZCApOwoKCQkJCQl2YXIgaW1nID0gbmV3IEltYWdlKCk7CgkJCQkJaW1nID0gbmV3IEltYWdlKCk7CgkJCQkJaW1nLm9ubG9hZCA9IGZ1bmN0aW9uKCkgewoJCQkJCQlkZWZlci5yZXNvbHZlKCB1cmwgKTsKCQkJCQl9OwoJCQkJCWltZy5vbmVycm9yID0gZnVuY3Rpb24oKSB7CgkJCQkJCWRlZmVyLnJlamVjdCggdXJsICk7CgkJCQkJfTsKCQkJCQlpbWcuc3JjID0gdXJsOwoJCQkJCXJldHVybiBwcm9taXNlOwoJCQkJfQoKCQkJfSwKCQkJdW5sb2FkOiB7CgkJCQlyZW1vdmVDc3NMaW5rVGFnOiBmdW5jdGlvbiggYXNzZXRJZCApIHsKCQkJCQl2YXIgdXJsID0gZnVsbFVybCggX2xvYWRlci51cmwoIGFzc2V0SWQgKSApOwoJCQkJCSQoICJsaW5rIiApLmZpbHRlcigKCQkJCQkJZnVuY3Rpb24oKSB7CgkJCQkJCQlyZXR1cm4gdGhpcy5ocmVmID09PSB1cmwgJiYgJCggdGhpcyApLmF0dHIoICdsb2FkZWRCeWxvYWRlcicgKTsKCQkJCQkJfSApLnJlbW92ZSgpOwoJCQkJfQoJCQl9LAoJCQl1cmw6IHsKCQkJCWFzc2V0SWQ6IGZ1bmN0aW9uKCBhc3NldElkICkgewoJCQkJCXJldHVybiBhc3NldElkOwoJCQkJfSwKCQkJCS8vdGhpcyB1cmwgZXhwZWN0IG1vZHVsZSBpcyBwdXQgaW50byBpdHMgZm9sZGVyIHVuZGVyIGJhc2VVcmwKCQkJCS8vaWYgdGhlIGxvYWRlciBuYW1lIGlzICJhcHAiLCB3ZSBzaG91bGQgcHV0IHRoZSByZXNvdXJjZSBmaWxlIGludG8KCQkJCS8vYmFzZVVybC9hcHAgZm9sZGVyCgkJCQlmb2xkZXI6IGZ1bmN0aW9uKCBhc3NldElkICkgewoKCQkJCQl2YXIgZmlsZUV4dCA9IGZpbmRMb2FkZXIoIGFzc2V0SWQgKS5maWxlRXh0LAoJCQkJCQlmaWxlTmFtZSA9IGZpbGVFeHQgPyBfbG9hZGVyLmZpbGVOYW1lKCBhc3NldElkICkgKyAiLiIgKyBmaWxlRXh0IDoKCQkJCQkJCWFzc2V0SWQsCgkJCQkJCWxvYWRlck5hbWUgPSBfbG9hZGVyLmZpbGVFeHQoIGFzc2V0SWQgKTsKCgkJCQkJcmV0dXJuIGxvYWRlck5hbWUgKyAiLyIgKyBmaWxlTmFtZTsKCQkJCX0KCQkJfSwKCgkJCWRlcGVuZDogewoJCQkJLy9uYW1lOiBmdW5jdGlvbiAoYXNzZXRJZCkgewoJCQkJLy8gcmV0dXJuIGEgYXNzZXRJZFN0cmluZyBvciBhc3NldElkQXJyYXkKCQkJCS8vIHJldHVybiAiYS5odG1sLCBiLmpzIgoJCQkJLy8gfQoJCQl9CgkJfSwKCgkJbG9hZEZpbHRlcnM6IGNvbW1vbkxvYWRGaWx0ZXJzID0gewoKCQkJc3RhdGljTG9hZGVkOiB7CgkJCQkvL2RlZmF1bHQgc3RhdGljTG9hZGVkIGZpbHRlcgoJCQkJcmV0dXJuRmFsc2U6IGZ1bmN0aW9uKCkgewoJCQkJCXJldHVybiBmYWxzZTsKCQkJCX0sCgoJCQkJaGFzU2NyaXB0VGFnOiBmdW5jdGlvbiggYXNzZXRJZCApIHsKCQkJCQlyZXR1cm4gISEoJCggInNjcmlwdCIgKS5maWx0ZXIoCgkJCQkJCWZ1bmN0aW9uKCkgewoJCQkJCQkJcmV0dXJuIHJlbW92ZUhhc2goIHRoaXMuc3JjICkgPT09IHJlbW92ZUhhc2goIF9sb2FkZXIudXJsKCBhc3NldElkICkgKTsKCQkJCQkJfSApLmxlbmd0aCk7CgkJCQl9CgoJCQl9LAoKCQkJZ2V0U291cmNlOiB7CgkJCQkvL3RoaXMgaXMgZGVmYXVsdCBnZXRTb3VyY2UgZmlsdGVyCgkJCQlnZXRUZXh0QnlBamF4OiBmdW5jdGlvbiggYXNzZXRJZCApIHsKCQkJCQlyZXR1cm4gJC5hamF4KCB7CgkJCQkJCXVybDogX2xvYWRlci51cmwoIGFzc2V0SWQgKSwKCQkJCQkJZGF0YVR5cGU6ICJ0ZXh0IiwKCQkJCQkJY2FjaGU6IHRydWUKCQkJCQl9ICk7CgkJCQl9CgkJCX0sCgoJCQljb21waWxlOiB7CgkJCQlnbG9iYWxFdmFsOiBmdW5jdGlvbiggYXNzZXRJZCwgc291cmNlQ29kZSApIHsKCQkJCQlyZXR1cm4gJC5nbG9iYWxFdmFsKCBzb3VyY2VDb2RlICk7CgkJCQl9LAoJCQkJbG9jYWxFdmFsOiBmdW5jdGlvbiggYXNzZXRJZCwgc291cmNlQ29kZSApIHsKCQkJCQlyZXR1cm4gZXZhbCggc291cmNlQ29kZSApOwoJCQkJfQoJCQl9LAoKCQkJY3Jvc3NTaXRlTG9hZDogewoJCQkJLy9jYW4gbm90IHVzZSAkLmdldFNjcmlwdCBkaXJlY3RseSwgYXMgbG9hZGVyLnJlc29sdmUKCQkJCWdldFNjcmlwdDogZnVuY3Rpb24oIGFzc2V0SWQgKSB7CgkJCQkJdmFyIGRlZmVyID0gJC5EZWZlcnJlZCgpLAoJCQkJCQlwcm9taXNlID0gZGVmZXIucHJvbWlzZSgpOwoKCQkJCQlwcm9taXNlLmRlZmVyID0gZGVmZXI7CgoJCQkJCSQuZ2V0U2NyaXB0KCBfbG9hZGVyLnVybCggYXNzZXRJZCApICkudGhlbigKCQkJCQkJZnVuY3Rpb24oKSB7CgkJCQkJCQlzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJCQkJCQlpZiAoIWRlZmVyLmRvbnRSZXNvbHZlKSB7CgkJCQkJCQkJCWRlZmVyLnJlc29sdmUoKTsKCQkJCQkJCQkJZGVsZXRlIHByb21pc2UuZGVmZXI7CgkJCQkJCQkJfQoJCQkJCQkJfSwgNSApOwoJCQkJCQl9LAoJCQkJCQlmdW5jdGlvbigpIHsKCQkJCQkJCWRlZmVyLnJlamVjdCgpOwoJCQkJCQkJZGVsZXRlIHByb21pc2UuZGVmZXI7CgkJCQkJCX0gKTsKCgkJCQkJcmV0dXJuIHByb21pc2U7CgkJCQl9CgoKCQkJfSwKCgkJCWJ1aWxkVW5sb2FkOiB7CgkJCQlwYXJzZVVubG9hZFRhZzogZnVuY3Rpb24oIHNvdXJjZUNvZGUgKSB7CgkJCQkJdmFyIHVubG9hZFN0YXRlbWVudHMgPSBydW5sb2FkU3RhdGVtZW50LmV4ZWMoIHNvdXJjZUNvZGUgKTsKCQkJCQlyZXR1cm4gdW5sb2FkU3RhdGVtZW50cyAmJgoJCQkJCSAgICAgICB1bmxvYWRTdGF0ZW1lbnRzWzFdICYmCgkJCQkJICAgICAgIG5ldyBGdW5jdGlvbiggdW5sb2FkU3RhdGVtZW50c1sxXSApOwoJCQkJfQoJCQl9LAoKCQkJYnVpbGREZXBlbmRlbmNpZXM6IHsKCQkJCXBhcnNlRGVwZW5kVGFnOiBmdW5jdGlvbiggYXNzZXRJZCwgc291cmNlQ29kZSApIHsKCQkJCQl2YXIgZGVwZW5kZW5jaWVzID0gckRlcGVuZEhlYWRlci5leGVjKCBzb3VyY2VDb2RlICk7CgkJCQkJcmV0dXJuIChkZXBlbmRlbmNpZXMgJiYgZGVwZW5kZW5jaWVzWzFdICkgfHwgbnVsbDsKCQkJCX0KCQkJfQoJCX0sCgoJCS8vZmluZCB0aGUgbmFtZSBvZiB0aGUgbG9hZGVyIGJhc2VkIG9uIGFzc2V0SWQKCQkvL3RoZSBmaXJzdCBsb2FkZXIgaXMgdXNlIHRoZSBleHRlbnNpb24gYXMgdGhlIGxvYWRlciBuYW1lCgkJLy9ob3dldmVyIHlvdSBjYW4gYWRkIHlvdXIgb3duIGxvYWRlcgoJCWZpbmRlcnM6IGxvYWRlckZpbmRlcnMgPSBbCgkJCS8vZmluZCBsb2FkZXIgYnkgYnkgZmlsZSBleHRlbnNpb25zIGRpcmVjdGx5CgkJCWZ1bmN0aW9uKCBhc3NldElkICkgewoJCQkJcmV0dXJuIGZpbGVFeHRlbnNpb24oIGFzc2V0SWQgKTsKCQkJfSwKCQkJLy9maW5kIGxvYWRlciBieSBieSBmaWxlIGV4dGVuc2lvbnMgdXNpbmcgbWFwcGVyCgkJCWZ1bmN0aW9uKCBhc3NldElkICkgewoJCQkJdmFyIGV4dGVuc2lvbiA9IGZpbGVFeHRlbnNpb24oIGFzc2V0SWQgKTsKCQkJCXZhciBtYXBwZWRUeXBlID0gZmlsZUV4dFRvTG9hZGVyTWFwcGVyW2V4dGVuc2lvbl07CgkJCQlpZiAobWFwcGVkVHlwZSkgewoJCQkJCXJldHVybiBtYXBwZWRUeXBlOwoJCQkJfQoJCQl9CgkJXSwKCgkJLy9pZiB5b3Ugd2FudCB0byBsb2FkIGEgZmlsZSAiKi5qcGciLCB3aGljaCBzaG91bGQgYmUgbG9hZGVkCgkJLy93aXRoICIqLmltZyIgbG9hZGVyIHlvdSBzaG91bGQgc3BlY2lmeSBsb2FkZXIubG9hZGVyLm1hcEZpbGVzKCJpbWciLCAianBnIik7CgkJbWFwRmlsZUV4dFRvTG9hZGVyOiBmdW5jdGlvbiggZmlsZUV4dGVuc2lvbnMsIGxvYWRlck5hbWUgKSB7CgkJCWZpbGVFeHRlbnNpb25zID0gc3BsaXRCeUNvbW1hKCBmaWxlRXh0ZW5zaW9ucyApOwoJCQlmb3IgKHZhciBpID0gMDsgaSA8IGZpbGVFeHRlbnNpb25zLmxlbmd0aDsgaSsrKSB7CgkJCQlmaWxlRXh0VG9Mb2FkZXJNYXBwZXJbZmlsZUV4dGVuc2lvbnNbaV1dID0gbG9hZGVyTmFtZTsKCQkJfQoJCX0sCgoJCS8vaWYgYXNzZXRJZCBpcyB4eXouanMKCQkvL3RoZW4gZmlsZUV4dCBpcyAianMiCgkJZmlsZUV4dDogZmlsZUV4dGVuc2lvbiA9IGZ1bmN0aW9uKCBhc3NldElkICkgewoJCQlyZXR1cm4gckZpbGVFeHQuZXhlYyggYXNzZXRJZCApWzFdOwoJCX0sCgoJCS8vaWYgYXNzZXRJZCBpcyAiYS5iLmMiLCB0aGVuIGZpbGUgbmFtZSBpcyAiYS5iIgoJCWZpbGVOYW1lOiBmaWxlTmFtZSA9IGZ1bmN0aW9uKCBhc3NldElkICkgewoJCQlyZXR1cm4gckZpbGVOYW1lLmV4ZWMoIGFzc2V0SWQgKVsxXTsKCQl9LAoKCQkvL2RlZmluZSBhIG1vZHVsZSB3aXRoIGFuIGFzc2V0IGlkCgkJLy9kZXBlbmRlbmNpZXMgaXMgYW4gYXNzZXQgZXhwcmVzc2lvbiwgaXQgaXMgb3B0aW9uYWwKCQkvL2RlZmluZSB0aGUgbW9kdWxlIGluIHRoZSBsb2FkIG1ldGhvZAoJCWRlZmluZTogZnVuY3Rpb24oIGFzc2V0SWQsIGRlcGVuZGVuY2llcywgZGVmaW5lTW9kdWxlLCB1bmxvYWQgKSB7CgoJCQlpZiAoJC5pc0Z1bmN0aW9uKCBkZXBlbmRlbmNpZXMgKSkgewoJCQkJdW5sb2FkID0gZGVmaW5lTW9kdWxlOwoJCQkJZGVmaW5lTW9kdWxlID0gZGVwZW5kZW5jaWVzOwoJCQkJZGVwZW5kZW5jaWVzID0gbnVsbDsKCQkJfQoKCQkJdmFyIGRlZmVyLCBwcm9taXNlID0gYWNjZXNzUHJvbWlzZSggYXNzZXRJZCApOwoKCQkJaWYgKCFwcm9taXNlKSB7CgkJCQkvL3RoaXMgaXMgdGhlIGNhc2Ugd2hlbiBsb2FkZXIuZGVmaW5lIGlzIGNhbGwgaW4gYSBzdGF0aWMgbG9hZGVkIGpzCgkJCQlkZWZlciA9ICQuRGVmZXJyZWQoKTsKCQkJCXByb21pc2UgPSBkZWZlci5wcm9taXNlKCk7CgkJCQlwcm9taXNlLmRlZmVyID0gZGVmZXI7CgkJCQlhY2Nlc3NQcm9taXNlKCBhc3NldElkLCBwcm9taXNlICk7CgkJCX0gZWxzZSB7CgkJCQlkZWZlciA9IHByb21pc2UuZGVmZXI7CgkJCX0KCgkJCS8vdXNlIGRvbnRSZW9zbHZlIGZsYWcgdGVsbGluZyB0aGUgY29uc3VtZXIgZG9uJ3QgcmVzb2x2ZSBpdAoJCQkvL2FzIGl0IHdpbGwgYmUgdGFrZW4gY2FyZSBpbnNpZGUgaW1wb3J0Q29kZSwKCQkJcHJvbWlzZS5kZWZlci5kb250UmVzb2x2ZSA9IHRydWU7CgoJCQl2YXIgcnVuTW9kdWxlQ29kZSA9IGZ1bmN0aW9uKCByZXN1bHQgKSB7CgkJCQlkZWxldGUgcHJvbWlzZS5kZWZlcjsKCQkJCXByb21pc2UudW5sb2FkID0gdW5sb2FkOwoJCQkJZGVmZXIgJiYgZGVmZXIucmVzb2x2ZSggZGVmaW5lTW9kdWxlKCByZXN1bHQgKSApOwoJCQl9OwoKCQkJaWYgKGRlcGVuZGVuY2llcykgewoJCQkJZGVwZW5kKCBhc3NldElkLCBkZXBlbmRlbmNpZXMgKTsKCQkJCS8vbG9hZCB0aGUgZGVwZW5kZW5jaWVzIGZpcnN0CgkJCQlfbG9hZGVyLmxvYWQoIGRlcGVuZGVuY2llcyApLmRvbmUoIHJ1bk1vZHVsZUNvZGUgKTsKCgkJCX0gZWxzZSB7CgoJCQkJcnVuTW9kdWxlQ29kZSgpOwoJCQl9CgoJCQlyZXR1cm4gcHJvbWlzZTsKCQl9LAoKCQlkb25lOiBmdW5jdGlvbiggZm4sIHJlbW92ZSApIHsKCQkJaWYgKHJlbW92ZSkgewoJCQkJbG9hZENhbGxiYWNrcy5yZW1vdmUoIGZuICk7CgkJCX0gZWxzZSB7CgkJCQlsb2FkQ2FsbGJhY2tzLnB1c2goIGZuICk7CgkJCX0KCQl9LAoKCQlmYWlsOiBmdW5jdGlvbiggZm4sIHJlbW92ZSApIHsKCQkJaWYgKHJlbW92ZSkgewoJCQkJZmFpbENhbGxiYWNrcy5yZW1vdmUoIGZuICk7CgkJCX0gZWxzZSB7CgkJCQlmYWlsQ2FsbGJhY2tzLnB1c2goIGZuICk7CgkJCX0KCQl9LAoKCQlkZWZhdWx0TG9hZGVyOiAianMiCgoJfSApOwoKCWZ1bmN0aW9uIHJlbG9hZCggYXNzZXRJZCwgY2hhbmdlICkgewoKCQl2YXIgb2xkUHJvbWlzZUNhY2hlID0gJC5leHRlbmQoIHRydWUsIHt9LCBwcm9taXNlU3RvcmUgKTsKCQlfbG9hZGVyLnVubG9hZCggYXNzZXRJZCwgdHJ1ZSApOwoJCWNoYW5nZSAmJiBjaGFuZ2UoKTsKCQlyZXR1cm4gX2xvYWRlci5sb2FkKCBhc3NldElkICkuZG9uZSggZnVuY3Rpb24oKSB7CgkJCWZvciAodmFyIGtleSBpbiBvbGRQcm9taXNlQ2FjaGUpIHsKCQkJCWlmIChwcm9taXNlU3RvcmVba2V5XSAmJiBvbGRQcm9taXNlQ2FjaGVba2V5XSkgewoJCQkJCXByb21pc2VTdG9yZVtrZXldLnJlZkNvdW50ID0gb2xkUHJvbWlzZUNhY2hlW2tleV0ucmVmQ291bnQ7CgkJCQkJcHJvbWlzZVN0b3JlW2tleV0udXJsID0gb2xkUHJvbWlzZUNhY2hlW2tleV0udXJsOwoJCQkJCXByb21pc2VTdG9yZVtrZXldLmFzc2V0SWQgPSBvbGRQcm9taXNlQ2FjaGVba2V5XS5hc3NldElkOwoJCQkJfQoJCQl9CgkJfSApOwoJfQoKCWZ1bmN0aW9uIGdldE5ld1N0YXRpY0RlcGVuZGVuY2llcyggYXNzZXRJZCwgZGVwZW5kZW5jaWVzVG9TZXQgKSB7CgkJdmFyIHJ0biwKCQkJbG9hZGVyID0gZmluZExvYWRlciggYXNzZXRJZCApLAoJCQlkeW5hbWljRGVwZW5kZW5jaWVzID0gbG9hZGVyICYmIGxvYWRlci5kZXBlbmQgJiYgbG9hZGVyLmRlcGVuZCggYXNzZXRJZCApOwoKCQlpZiAoZHluYW1pY0RlcGVuZGVuY2llcykgewoJCQlydG4gPSBbXTsKCQkJZHluYW1pY0RlcGVuZGVuY2llcyA9IHNwbGl0QnlDb21tYSggZHluYW1pY0RlcGVuZGVuY2llcyApOwoJCQlkZXBlbmRlbmNpZXNUb1NldCA9IHNwbGl0QnlDb21tYSggZGVwZW5kZW5jaWVzVG9TZXQgKTsKCQkJZm9yICh2YXIgaSA9IDA7IGkgPCBkZXBlbmRlbmNpZXNUb1NldC5sZW5ndGg7IGkrKykgewoJCQkJaWYgKCFkeW5hbWljRGVwZW5kZW5jaWVzLmNvbnRhaW5zKCBkZXBlbmRlbmNpZXNUb1NldFtpXSApKSB7CgkJCQkJcnRuLnB1c2goIGRlcGVuZGVuY2llc1RvU2V0W2ldICk7CgkJCQl9CgkJCX0KCQkJcmV0dXJuIHJ0bi5sZW5ndGggPyBydG4uam9pbigpIDogbnVsbDsKCQl9IGVsc2UgewoJCQlyZXR1cm4gZGVwZW5kZW5jaWVzVG9TZXQ7CgkJfQoJfQoKCWZ1bmN0aW9uIGlzRGVwZW5kZW5jaWVzRGlmZmVyZW50KCBkZXBlbmRlbmNpZXMxLCBkZXBlbmRlbmNpZXMyICkgewoJCWlmICgoZGVwZW5kZW5jaWVzMSAmJiAhZGVwZW5kZW5jaWVzMikgfHwKCQkgICAgZGVwZW5kZW5jaWVzMiAmJiAhZGVwZW5kZW5jaWVzMSkgewoJCQlyZXR1cm4gdHJ1ZTsKCQl9IGVsc2UgaWYgKCFkZXBlbmRlbmNpZXMxICYmICFkZXBlbmRlbmNpZXMyKSB7CgkJCXJldHVybiBmYWxzZTsKCQl9CgoJCWRlcGVuZGVuY2llczEgPSBzcGxpdEJ5Q29tbWEoIGRlcGVuZGVuY2llczEgKS5zb3J0KCk7CgkJZGVwZW5kZW5jaWVzMiA9IHNwbGl0QnlDb21tYSggZGVwZW5kZW5jaWVzMiApLnNvcnQoKTsKCQlpZiAoZGVwZW5kZW5jaWVzMS5sZW5ndGggIT0gZGVwZW5kZW5jaWVzMi5sZW5ndGgpIHsKCQkJcmV0dXJuIHRydWU7CgkJfQoKCQlmb3IgKHZhciBpID0gMDsgaSA8IGRlcGVuZGVuY2llczEubGVuZ3RoOyBpKyspIHsKCQkJaWYgKGRlcGVuZGVuY2llczFbaV0gIT0gZGVwZW5kZW5jaWVzMltpXSkgewoJCQkJcmV0dXJuIHRydWU7CgkJCX0KCQl9CgoJCXJldHVybiBmYWxzZTsKCX0KCglmdW5jdGlvbiBmaW5kTG9hZGVyKCBhc3NldElkICkgewoJCXZhciBsb2FkZXJOYW1lLCBpOwoJCWZvciAoaSA9IGxvYWRlckZpbmRlcnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKCQkJbG9hZGVyTmFtZSA9IGxvYWRlckZpbmRlcnNbaV0oIGFzc2V0SWQgKTsKCQkJaWYgKGxvYWRlck5hbWUpIHsKCQkJCWJyZWFrOwoJCQl9CgkJfQoJCWxvYWRlck5hbWUgPSBsb2FkZXJOYW1lIHx8IF9sb2FkZXIuZGVmYXVsdExvYWRlcjsKCQlyZXR1cm4gbG9hZGVyU3RvcmVbbG9hZGVyTmFtZV07Cgl9CgoJZnVuY3Rpb24gYXR0YWNoRmlsdGVyKCBmaWx0ZXJzLCBmaWx0ZXJOYW1lICkgewoJCWlmIChpc1N0cmluZyggZmlsdGVyc1tmaWx0ZXJOYW1lXSApKSB7CgkJCWZpbHRlcnNbZmlsdGVyTmFtZV0gPSBjb21tb25Mb2FkRmlsdGVyc1tmaWx0ZXJOYW1lXVtmaWx0ZXJzW2ZpbHRlck5hbWVdXTsKCQl9Cgl9CgoJLy8jZGVidWcKCV9sb2FkZXIuZGVidWcgPSB7CgkJZnVsbFVybDogZnVsbFVybCwKCQl1cmxTdG9yZTogdXJsU3RvcmUsCgkJcHJvbWlzZVN0b3JlOiBwcm9taXNlU3RvcmUsCgkJbG9hZGVyU3RvcmU6IGxvYWRlclN0b3JlLAoJCWZpbmRMb2FkZXI6IGZpbmRMb2FkZXIsCgkJYWRkSGFzaDogYWRkSGFzaCwKCQlyZW1vdmVIYXNoOiByZW1vdmVIYXNoLAoJCWxvZzogZnVuY3Rpb24oIG1zZyApIHsKCQkJdmFyIGNvbnNvbGUgPSB3aW5kb3cuY29uc29sZTsKCQkJY29uc29sZSAmJiBjb25zb2xlLmxvZyAmJiBjb25zb2xlLmxvZyggbXNnICk7CgkJfSwKCgkJLy90aGlzIGlzIGZvciBkZWJ1Z2dpbmcgcHVycG9zZSBvbmx5CgkJbW9kdWxlQ291bnRlcnM6IGFjY2Vzc1Byb21pc2UsCgoJCWdldExvYWRlckJ5TmFtZTogZnVuY3Rpb24oIGxvYWRlck5hbWUgKSB7CgkJCXJldHVybiBsb2FkZXJOYW1lID8gbG9hZGVyU3RvcmVbbG9hZGVyTmFtZV0gOiBsb2FkZXJTdG9yZTsKCQl9Cgl9OwoJLy8jZW5kX2RlYnVnCgoJdmFyCgoJLy9pZiB5byBoYXZlIGNvZGUgbGlrZSB0aGUgZm9sbG93aW5nIGluIGphdmFzY3JpcHQsCgkvL3RoZSBwYXJ0IGRlbGV0ZSB3aW5kb3cuZGVwZW5kMiB3aWxsIGJlIGV4dHJhY3RlZAoJLy8gPEB1bmxvYWQ+CgkvL2RlbGV0ZSB3aW5kb3cuZGVwZW5kMjsKCS8vPC9AdW5sb2FkPgoKCQlydW5sb2FkU3RhdGVtZW50ID0gLzxAdW5sb2FkPihbXHdcV10rPyk8XC9AdW5sb2FkPi9pLAoKCS8vbWF0Y2ggc3RyaW5nICJyZWYyLCByZWYxIiBpbgoJLy8gPEBkZXBlbmQ+CgkvL3JlZjIsIHJlZjEKCS8vPEBkZXBlbmQ+CgkJckRlcGVuZEhlYWRlciA9IC88QGRlcGVuZD4oW1x3XFddKz8pPFwvQGRlcGVuZD4vaTsKCgkvL2NyZWF0ZSBhIGxvYWQgZnVuY3Rpb24KCWZ1bmN0aW9uIHJlc29sdmVEZXBlbmRlbmNpZXMoIGFjdGlvbkFmdGVyRGVwZW5kZW5jaWVzUmVzb2x2ZWQgKSB7CgkJcmV0dXJuIGZ1bmN0aW9uKCBhc3NldElkICkgewoJCQl2YXIgZGVmZXIgPSAkLkRlZmVycmVkKCksCgkJCQlkZXBlbmRlbnRSZXNvdXJjZVN0cmluZyA9IF9sb2FkZXIuZGVwZW5kKCBhc3NldElkICk7CgoJCQlpZiAoZGVwZW5kZW50UmVzb3VyY2VTdHJpbmcpIHsKCQkJCV9sb2FkZXIubG9hZCggZGVwZW5kZW50UmVzb3VyY2VTdHJpbmcgKS5kb25lKCBmdW5jdGlvbigpIHsKCQkJCQlkZWZlci5yZXNvbHZlKCBhc3NldElkLCBhY3Rpb25BZnRlckRlcGVuZGVuY2llc1Jlc29sdmVkKCBhc3NldElkICkgKTsKCQkJCX0gKTsKCQkJfSBlbHNlIHsKCQkJCWRlZmVyLnJlc29sdmUoIGFzc2V0SWQsIGFjdGlvbkFmdGVyRGVwZW5kZW5jaWVzUmVzb2x2ZWQoIGFzc2V0SWQgKSApOwoJCQl9CgkJCXJldHVybiBkZWZlci5wcm9taXNlKCk7CgkJfTsKCX0KCgkvL2Egc3BlY2lhbCBtb2R1bGUgd2hpY2ggaXMgYSBwYWNrYWdlIG9mIG1vZHVsZXMsIGxpa2UgYSBjb250YWluZXIKCV9sb2FkZXIoICJwYWNrIiwgewoJCWxvYWQ6IHJlc29sdmVEZXBlbmRlbmNpZXMoICQubm9vcCApLAoJCXVybDogImFzc2V0SWQiCgl9ICk7CgoJLy9qcyBhZGFwdGVyIHRyeSB0byBwYXJzZSB0aGUgY29udGVudCBvZiBqcyBmaWxlCglfbG9hZGVyKCAianMiLCB7CgkJbG9hZDogewoJCQlzdGF0aWNMb2FkZWQ6ICJoYXNTY3JpcHRUYWciCgkJCS8vdGhlIGZvbGxvd2luZyBhcmUgY29tbWVudGVkIG91dCwgYmVjYXVzZSBpdCBpcyBkZWZhdWx0IHZhbHVlIGRlZmluZWQgaW4gY29udmVydExvYWRGaWx0ZXJzVG9Mb2FkTWV0aG9kCgkJCS8vY3Jvc3NTaXRlTG9hZDogImdldFNjcmlwdCIsCgkJCS8vZ2V0U291cmNlOiAiZ2V0VGV4dEJ5QWpheCIsCgkJCS8vY29tcGlsZTogImdsb2JhbEV2YWwiLAoJCQkvL2J1aWxkRGVwZW5kZW5jaWVzOiAicGFyc2VEZXBlbmRUYWciLAoJCQkvL2J1aWxkVW5sb2FkOiAicGFyc2VVbmxvYWRUYWciCgkJfSwKCQkvL3RoaXMgaXMgbmVjZXNzYXJ5IGJlY2F1c2UgaWYgeW91IGhhdmUgYSBzdWIgbG9hZGVyIGluaGVyaXRzIGZyb20KCQkvL2Zyb20gdGhpcywgYW5kIHlvdSBkb24ndCB3YW50IHRvIGluaGVyaXRlZCBzdWIgbG9hZGVyIHRvIHNwZWNpZnkgdGhpcyBhZ2FpbgoJCWZpbGVFeHQ6ICJqcyIKCX0gKTsKCglfbG9hZGVyKCAianNsIiwgImpzIiwgewoJCWxvYWQ6IHsKCQkJY29tcGlsZTogImxvY2FsRXZhbCIKCQl9Cgl9ICk7CgkvL2xvYWRlciBpcyBqYXZhc2NyaXB0IGZpbGUsIGl0IGRlZmluZXMgYSBsb2FkZXIKCV9sb2FkZXIoICJsb2FkZXIiLCAianMiLCB7CgkJdXJsOiAiZm9sZGVyIgoJfSApOwoKCS8vY3NzIGFkYXB0ZXIgdHJpZXMgdG8gcGFyc2UgdGhlIGNvbnRlbnQgb2YgY3NzIGZpbGUKCV9sb2FkZXIoICJjc3MiLCB7CgkJbG9hZDogewoJCQlzdGF0aWNMb2FkZWQ6IGZ1bmN0aW9uKCBhc3NldElkICkgewoJCQkJcmV0dXJuICEhKCQoICJsaW5rIiApLmZpbHRlcigKCQkJCQlmdW5jdGlvbigpIHsKCQkJCQkJcmV0dXJuIHJlbW92ZUhhc2goIHRoaXMuaHJlZiApID09PSByZW1vdmVIYXNoKCBfbG9hZGVyLnVybCggYXNzZXRJZCApICkgJiYgISQoIHRoaXMgKS5hdHRyKCAnbG9hZGVkQnlsb2FkZXInICk7CgkJCQkJfSApLmxlbmd0aCk7CgkJCX0sCgkJCWNyb3NzU2l0ZUxvYWQ6IGZ1bmN0aW9uKCBhc3NldElkICkgewoJCQkJdmFyIGRlZmVyID0gJC5EZWZlcnJlZCgpOwoKCQkJCSQoICI8bGluayBocmVmPSciICsgX2xvYWRlci51cmwoIGFzc2V0SWQgKSArICInICIgKyAicmVsPSdzdHlsZXNoZWV0JyB0eXBlPSd0ZXh0L2NzcycgbG9hZGVkQnlsb2FkZXI9JzEnIC8+IiApCgkJCQkJLmxvYWQoIGZ1bmN0aW9uKCkgewoJCQkJCQlkZWZlci5yZXNvbHZlKCBhc3NldElkICk7CgkJCQkJfSApCgkJCQkJLmFwcGVuZFRvKCAiaGVhZCIgKTsKCgkJCQlyZXR1cm4gZGVmZXIucHJvbWlzZSgpOwoJCQl9LAoJCQkvL2V4cGxpY2l0bHkgc3BlY2lmeSB0aGF0IGxvYWRlciBkb2VzIG5vdCBuZWVkIGEgY29tcGlsZSBmaWx0ZXIKCQkJY29tcGlsZTogbnVsbAoJCX0sCgoJCXVubG9hZDogZnVuY3Rpb24oIGFzc2V0SWQgKSB7CgkJCXZhciB1cmwgPSBmdWxsVXJsKCBfbG9hZGVyLnVybCggYXNzZXRJZCApICk7CgkJCSQoICJsaW5rIiApLmZpbHRlcigKCQkJCWZ1bmN0aW9uKCkgewoJCQkJCXJldHVybiB0aGlzLmhyZWYgPT09IHVybCAmJiAkKCB0aGlzICkuYXR0ciggJ2xvYWRlZEJ5bG9hZGVyJyApOwoJCQkJfSApLnJlbW92ZSgpOwoJCX0sCgkJZmlsZUV4dDogImNzcyIKCX0gKTsKCglfbG9hZGVyKCAiaW1hZ2UiLCB7CgkJbG9hZDogImNhY2hlSW1hZ2UiLAoJCW5vUmVmQ291bnQ6IHRydWUKCX0gKTsKCgkvL21ha2UgaW1nIGxpbmtlciBjYW4gaGFuZGxlIG1vZHVsZSB3aXRoIHRoZXNlIGZpbGUgZXh0ZW5zaW9uCglfbG9hZGVyLm1hcEZpbGVFeHRUb0xvYWRlciggImpwZyxwbmcsYm1wLGdpZiIsICJpbWFnZSIgKTsKCS8vZnJlZCB0ZXN0CgovLwovLzxAZGVwZW5kcz5zdWJzY3JpcHRpb24uanMsIG1vZGVsLmpzLCBkZWNsYXJhdGl2ZS5qczwvQGRlcGVuZHM+CgoKCXZhciB0ZW1wbGF0ZSwKCQlyQmVnaW5XaXRoQXBrID0gL15hcGtcLihbXi5dKykoXC4/KSguKikkLywKCQlyQmVnaW5XaXRoU3RhciA9IC9eXCovLAoJCXRlbXBsYXRlRW5naW5lQWRhcHRlcnMgPSB7fSwKCQl0bXBsID0gewoJCQlpbml0aWFsaXplOiAiKnRlbXBsYXRlT3B0aW9ucyIsCgkJCWdldDogImdldCIsIC8vZXh0ZW5zaWJsZQoJCQljb252ZXJ0OiAiKnRlbXBsYXRlIiwKCQkJc2V0OiAiaHRtbCIsIC8vZXh0ZW5zaWJsZQoJCQlmaW5hbGl6ZTogIipwYXJzZVN1YnMiCgkJfTsKCglmdW5jdGlvbiBuZXdUZW1wbGF0ZUhhbmRsZXIoIGdldHRlciwgc2V0dGVyLCBmaW5hbGl6ZXIgKSB7CgkJcmV0dXJuIGV4dGVuZCgge30sIHRtcGwsCgkJCWlzT2JqZWN0KCBnZXR0ZXIgKSA/IGdldHRlciA6IHsKCQkJCWdldDogZ2V0dGVyLAoJCQkJc2V0OiBzZXR0ZXIsCgkJCQlmaW5hbGl6ZTogZmluYWxpemVyCgkJCX0gKTsKCX0KCgkvL29wdGlvbnMgY2FuIGJlIDogdGVtcGxhdGVJZCx3cmFwSXRlbSxlbmdpbmVOYW1lCgkvLwoJLy9vciBpdCBjYW4gYmUKCS8vIHsKCS8vICB0ZW1wbGF0ZUlkOiAieHh4IiwKCS8vICB3cmFwSXRlbTogdHJ1ZSwKCS8vICBlbmdpbmVOYW1lOiAieHh4IgoJLy99CglobS5hY3Rpdml0eS5pbml0aWFsaXplLnRlbXBsYXRlT3B0aW9ucyA9IGZ1bmN0aW9uKCBwdWJsaXNoZXIsIHN1YnNjcmliZXIsIGhhbmRsZXIsIG9wdGlvbnMgKSB7CgkJaWYgKGlzU3RyaW5nKCBvcHRpb25zICkpIHsKCgkJCW9wdGlvbnMgPSBvcHRpb25zLnNwbGl0KCAiLCIgKTsKCQkJaGFuZGxlci50ZW1wbGF0ZUlkID0gJC50cmltKCBvcHRpb25zWzBdICk7CgkJCWhhbmRsZXIud3JhcERhdGFJbkFycmF5ID0gJC50cmltKCBvcHRpb25zWzFdICkgPT0gInRydWUiOwoJCQloYW5kbGVyLmVuZ2luZU5hbWUgPSBvcHRpb25zWzJdOwoKCQl9IGVsc2UgaWYgKGlzT2JqZWN0KCBvcHRpb25zICkgJiYgb3B0aW9ucy50ZW1wbGF0ZUlkKSB7CgoJCQlleHRlbmQoIGhhbmRsZXIsIG9wdGlvbnMgKTsKCgkJfSBlbHNlIHsKCgkJCWlmICghKGhhbmRsZXIudGVtcGxhdGVJZCA9IHN1YnNjcmliZXIuaG1EYXRhKCAiZW1iZWRkZWRUZW1wbGF0ZSIgKSkpIHsKCgkJCQl2YXIgdGVtcGxhdGVTb3VyY2UgPSAkLnRyaW0oIHN1YnNjcmliZXIuaHRtbCgpICk7CgkJCQlpZiAodGVtcGxhdGVTb3VyY2UpIHsKCQkJCQl0ZW1wbGF0ZVNvdXJjZSA9IHRlbXBsYXRlU291cmNlLnJlcGxhY2UoIHJVbmVzY2FwZVRva2VucywgdW5lc2NhcGVUb2tlbnMgKTsKCQkJCQloYW5kbGVyLnRlbXBsYXRlSWQgPSAiX18iICsgJC51dWlkKys7CgkJCQkJdGVtcGxhdGUuY29tcGlsZSggaGFuZGxlci50ZW1wbGF0ZUlkLCB0ZW1wbGF0ZVNvdXJjZSApOwoJCQkJCXN1YnNjcmliZXIuaG1EYXRhKCAiZW1iZWRkZWRUZW1wbGF0ZSIsIGhhbmRsZXIudGVtcGxhdGVJZCApOwoJCQkJCXN1YnNjcmliZXIuZW1wdHkoKTsKCQkJCX0gZWxzZSB7CgkJCQkJdGhyb3cgIm1pc3NpbmcgdGVtcGxhdGUiOwoJCQkJfQoJCQl9CgkJfQoJfTsKCgl2YXIgclVuZXNjYXBlVG9rZW5zID0gLyZsdDt8Jmd0Oy9nOwoJdmFyIHVuZXNjYXBlTWFwID0gewoJCSImbHQ7IjogIjwiLAoJCSImZ3Q7IjogIj4iCgl9OwoKCXZhciB1bmVzY2FwZVRva2VucyA9IGZ1bmN0aW9uKCB0b2tlbiApIHsKCQlyZXR1cm4gdW5lc2NhcGVNYXBbdG9rZW5dIHx8ICIiOwoJfTsKCglmdW5jdGlvbiBSZW5kZXJDb250ZXh0KCBlICkgewoJCXRoaXMubW9kZWxQYXRoID0gZS5wdWJsaXNoZXIucGF0aDsKCQl0aGlzLmUgPSBlOwoJfQoKCS8vc2hvcnRjdXQgdG8gdGhpcy5lLnB1Ymxpc2hlci5nZXQoeHh4KTsKCVJlbmRlckNvbnRleHQucHJvdG90eXBlLmdldCA9IGZ1bmN0aW9uKCkgewoJCXZhciBwdWJsaXNoZXIgPSB0aGlzLmUucHVibGlzaGVyOwoJCXJldHVybiBwdWJsaXNoZXIuZ2V0LmFwcGx5KCBwdWJsaXNoZXIsIGFyZ3VtZW50cyApOwoJfTsKCgkvL3RoaXMgY29udmVydGVyIGlzIHVzZWQgaW4gaGFuZGxlcnMgd2hpY2ggY2FuIHdhbnQgdG8gY29udmVydCBkYXRhCgkvLyB0byBtYXJrdXAsIHRoZXNlIGhhbmRsZXIgaW5jbHVkZXMgZm9yZWFjaCwgYW5kIG5ld1RlbXBsYXRlSGFuZGxlcgoJLy93aGljaCBpcyB0aGUgY29yZSBvZiBhbGwgdGVtcGxhdGVIYW5kbGVyCglobS5hY3Rpdml0eS5jb252ZXJ0LnRlbXBsYXRlID0gZnVuY3Rpb24oIGRhdGEsIGUgKSB7CgoJCS8vaWYgZGF0YVNvdXJjZSBpcyBhbiBhcnJheSwgaXQgaGFzIGl0ZW0ocykKCQkvL29yIGRhdGFTb3VyY2UgaXMgbm9uLWFycmF5CgkJaWYgKGRhdGEgJiYKCQkgICAgKAoJCQkgICAgKGlzQXJyYXkoIGRhdGEgKSAmJiBkYXRhLmxlbmd0aCkgfHwgIWlzQXJyYXkoIGRhdGEgKQoJCQkgICAgKQoJCQkpIHsKCgkJCS8vaWYgd3JhcERhdGFJbkFycmF5IGlzIHRydWUsIHdyYXAgZGF0YSB3aXRoIFtdLCBzbyB0aGF0IGl0IGlzIGFuIGl0ZW0gb2YgYW4gYXJyYXksIGV4cGxpY2l0bHkKCQkJLy9zb21lIHRlbXBsYXRlIGVuZ2luZSBjYW4gYXV0b21hdGljYWxseSB3cmFwIHlvdXIgZGF0YSBpZiBpdCBpcyBub3QgYW4gYXJyYXkuCgkJCS8vaWYgeW91IGRhdGEgaXMgYWxyZWFkeSBpbiBhcnJheSwgaXQgdHJlYXQgaXQgYXMgYW4gYXJyYXkgb2YgaXRlbXMuCgkJCS8vaG93ZXZlciwgaWYgeW91IHdhbnQgdG8gd2FudCB0byB0cmVhdCB5b3VyIGFycmF5IGFzIGl0ZW0sIHlvdSBuZWVkIHRvIHdyYXAgaXQgYnkgeW91cgoJCQkvL3NlbGYsIHdyYXBEYXRhSW5BcnJheSBpcyBmb3IgdGhpcyBwdXJwb3NlCgoJCQl2YXIgdGVtcGxhdGVJZCwgdGVtcGxhdGVEYXRhLCB3b3JrZmxvdyA9IGUuaGFuZGxlcjsKCgkJCWlmICh3b3JrZmxvdy50ZW1wbGF0ZUlkKSB7CgkJCQl0ZW1wbGF0ZUlkID0gd29ya2Zsb3cudGVtcGxhdGVJZDsKCQkJCXRlbXBsYXRlRGF0YSA9IHdvcmtmbG93LndyYXBEYXRhSW5BcnJheSA/IFtkYXRhXSA6IGRhdGE7CgkJCX0gZWxzZSB7CgkJCQl0ZW1wbGF0ZUlkID0gZGF0YTsKCQkJCXRlbXBsYXRlRGF0YSA9IHt9OwoJCQl9CgoJCQlpZiAoIXRlbXBsYXRlSWQpIHsKCQkJCXJldHVybiAiIjsKCQkJfQoKCQkJLy9oYW5kbGVyLnRlbXBsYXRlSWQsIGhhbmRsZXIud3JhcERhdGFJbkFycmF5LCBoYW5kbGVyLmVuZ2luZU5hbWUgaXMKCQkJLy9idWlsdCBpbiBkdXJpbmcgaW5pdGlhbGl6YXRpb24gLCBzZWUgaW5pdGlhbGl6ZXJzLnRlbXBsYXRlT3B0aW9ucwoJCQl2YXIgY29udGVudCA9IHJlbmRlclRlbXBsYXRlKAoKCQkJCXRlbXBsYXRlSWQsCgoJCQkJdGVtcGxhdGVEYXRhLAoKCQkJCS8vdGhpcyBjb250ZXh0IGNhbiBiZSB1c2VkIHRvIGFjY2VzcyBtb2RlbCB3aXRoaW4gdGhlIHRlbXBsYXRlCgkJCQluZXcgUmVuZGVyQ29udGV4dCggZSApLAoKCQkJCXdvcmtmbG93LmVuZ2luZU5hbWUgKTsKCgkJCWlmIChpc1Byb21pc2UoIGNvbnRlbnQgKSkgewoJCQkJcmV0dXJuIGNvbnRlbnQ7CgkJCX0KCQkJaWYgKGlzU3RyaW5nKCBjb250ZW50ICkpIHsKCgkJCQljb250ZW50ID0gJC50cmltKCBjb250ZW50ICk7CgkJCX0KCgkJCS8vdG8gd29yayBhcm91bmQgYSBidWcgaW4galF1ZXJ5CgkJCS8vIGh0dHA6Ly9qc2ZpZGRsZS5uZXQvamdTcm4vMS8KCQkJcmV0dXJuICQoICQoICI8ZGl2IC8+IiApLmh0bWwoIGNvbnRlbnQgKVswXS5jaGlsZE5vZGVzICk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuICIiOwoJCX0KCX07CgoJLy93aGVuIHRoZSB0ZW1wbGF0ZSBpcyByZW5kZXIsIG5lZWQgdG8gcmVjdXJzaXZlbHkgaW1wb3J0IGRlY2xhcmF0aXZlIHN1YnNjcmlwdGlvbnMKCWhtLmFjdGl2aXR5LmZpbmFsaXplLnBhcnNlU3VicyA9IGZ1bmN0aW9uKCB2YWx1ZSwgZSApIHsKCQkkKCB2YWx1ZSApLnBhcnNlU3VicygpOwoKCX07CgoJLy9hZGQgcmV1c2FibGUgZXZlbnQgaGFuZGxlcgoJaG0ud29ya2Zsb3coIHsKCQl0bXBsOiB0bXBsLAoJCWluY2x1ZGU6IG5ld1RlbXBsYXRlSGFuZGxlciggImdldCIsICJyZXBsYWNlV2l0aCIgKQoJfSApOwoKCWJpbmRpbmdzKCB7CgoJCXRtcGw6ICIhaW5pdDoufCp0bXBsIiwKCgkJdG1wbE9uQ2hhbmdlOiAiIWluaXQgYWZ0ZXIqLjoufCp0bXBsIiwKCgkJdG1wbE9uQ2hpbGRDaGFuZ2U6ICIhaW5pdCBhZnRlciouIGFmdGVyKi4xOi58KnRtcGwiLAoKCQl0bXBsT25BbnlDaGFuZ2U6ICIhaW5pdCBhZnRlcio6LnwqdG1wbCIsCgoJCWluY2x1ZGU6ICIhaW5pdDoufCppbmNsdWRlIgoJfSApOwoKCS8vdGVtcGxhdGVPcHRpb25zIGlzIHRlbXBsYXRlSWQsd3JhcERhdGFJbkFycmF5LHRlbXBsYXRlRW5naW5lTmFtZQoJLy8kKCJkaXYiKS50bXBsKHRlbXBsYXRlSWQsIHBhdGgpCgkvLyQoImRpdiIpLnRtcGwodGVtcGxhdGVJZCwgcGF0aCwgZm4pCgkvL2lmIHRlbXBsYXRlV29ya2Zsb3dFeHRlbnNpb24gaXMgYSBmdW5jdGlvbiwgdGhlIGZ1bmN0aW9uIGlzIHRyZWF0ZWQKCS8vYXMgZmluYWxpemVyCgkkZm4udG1wbCA9IGZ1bmN0aW9uKCB0ZW1wbGF0ZU9wdGlvbnMsIG1vZGVsUGF0aCwgdGVtcGxhdGVXb3JrZmxvd0V4dGVuc2lvbiApIHsKCgkJbW9kZWxQYXRoID0gbW9kZWxQYXRoIHx8ICIiOwoKCQlpZiAoaXNGdW5jdGlvbiggdGVtcGxhdGVXb3JrZmxvd0V4dGVuc2lvbiApKSB7CgkJCXRlbXBsYXRlV29ya2Zsb3dFeHRlbnNpb24gPSB7CgkJCQlmaW5hbGl6ZTogdGVtcGxhdGVXb3JrZmxvd0V4dGVuc2lvbgoJCQl9OwoJCX0KCgkJcmV0dXJuIHRoaXMucmVuZGVyVmlldygKCgkJCW1vZGVsUGF0aCwKCgkJCXRlbXBsYXRlV29ya2Zsb3dFeHRlbnNpb24gPwoJCQkJZXh0ZW5kKCB7fSwgdG1wbCwgdGVtcGxhdGVXb3JrZmxvd0V4dGVuc2lvbiApIDoKCQkJCSIqdG1wbCIsCgoJCQl0ZW1wbGF0ZU9wdGlvbnMKCQkpOwoJfTsKCgkvL3RlbXBsYXRlT3B0aW9ucyBpcyB0ZW1wbGF0ZUlkLHdyYXBEYXRhSW5BcnJheSx0ZW1wbGF0ZUVuZ2luZU5hbWUKCS8vJCgiZGl2IikuaW5jbHVkZShwYXRoLCB0ZW1wbGF0ZUlkKQoJJGZuLmluY2x1ZGUgPSBmdW5jdGlvbiggdGVtcGxhdGVPcHRpb25zLCBtb2RlbFBhdGgsIHRlbXBsYXRlSGFuZGxlckV4dGVuc2lvbiApIHsKCgkJaWYgKGlzRnVuY3Rpb24oIHRlbXBsYXRlSGFuZGxlckV4dGVuc2lvbiApKSB7CgkJCXRlbXBsYXRlSGFuZGxlckV4dGVuc2lvbiA9IHsKCQkJCWZpbmFsaXplOiB0ZW1wbGF0ZUhhbmRsZXJFeHRlbnNpb24KCQkJfTsKCQl9CgoJCXJldHVybiB0aGlzLnJlbmRlclZpZXcoCgkJCW1vZGVsUGF0aCwKCQkJdGVtcGxhdGVIYW5kbGVyRXh0ZW5zaW9uID8gZXh0ZW5kKCB7fSwgaG0ud29ya2Zsb3coICJyZXBsYWNlIiApLCB0ZW1wbGF0ZUhhbmRsZXJFeHRlbnNpb24gKSA6ICIqcmVwbGFjZSIsCgkJCXRlbXBsYXRlT3B0aW9ucwoJCSk7Cgl9OwoKCWZ1bmN0aW9uIGdldFRlbXBsYXRlRW5naW5lKCBlbmdpbmVOYW1lICkgewoJCWVuZ2luZU5hbWUgPSBlbmdpbmVOYW1lIHx8IHRlbXBsYXRlLmRlZmF1bHRFbmdpbmU7CgkJaWYgKCFlbmdpbmVOYW1lKSB7CgkJCXRocm93ICJlbmdpbmUgbmFtZSBpcyBub3Qgc3BlY2lmaWVkIG9yIGRlZmF1bHQgZW5naW5lIG5hbWUgaXMgbnVsbCI7CgkJfQoJCXZhciBlbmdpbmVBZGFwdGVyID0gdGVtcGxhdGVFbmdpbmVBZGFwdGVyc1tlbmdpbmVOYW1lXTsKCQlpZiAoIWVuZ2luZUFkYXB0ZXIpIHsKCQkJdGhyb3cgImVuZ2luZSAnIiArIGVuZ2luZUFkYXB0ZXIgKyAiJyBjYW4gbm90IGJlIGZvdW5kLiI7CgkJfQoJCXJldHVybiBlbmdpbmVBZGFwdGVyOwoKCX0KCglmdW5jdGlvbiByZW5kZXJUZW1wbGF0ZSggdGVtcGxhdGVJZCwgZGF0YSwgcmVuZGVyQ29udGV4dCwgZW5naW5lTmFtZSApIHsKCgkJdmFyIGVuZ2luZUFkYXB0ZXIgPSBnZXRUZW1wbGF0ZUVuZ2luZSggZW5naW5lTmFtZSwgdGVtcGxhdGVJZCApOwoKCQl0ZW1wbGF0ZUlkID0gJC50cmltKCB0ZW1wbGF0ZUlkICk7CgoJCS8vcmVtb3ZlIHRoZSBzdGFydGluZyAiKiIgZnJvbSB0aGUgdGVtcGxhdGUgaWQgdG8gYmVjb21lIHRoZSByZWFsVGVtcGxhdGVJZAoJCXZhciByZWFsVGVtcGxhdGVJZCA9IHRlbXBsYXRlSWQucmVwbGFjZSggckJlZ2luV2l0aFN0YXIsICIiICk7CgoJCWlmIChlbmdpbmVBZGFwdGVyLmlzVGVtcGxhdGVMb2FkZWQoIHJlYWxUZW1wbGF0ZUlkICkpIHsKCgkJCXJldHVybiBlbmdpbmVBZGFwdGVyLnJlbmRlciggcmVhbFRlbXBsYXRlSWQsIGRhdGEsIHJlbmRlckNvbnRleHQgKTsKCgkJfSBlbHNlIGlmIChlbmdpbmVBZGFwdGVyLnJlbmRlckFzeW5jKSB7CgoJCQlyZXR1cm4gZW5naW5lQWRhcHRlci5yZW5kZXJBc3luYyggcmVhbFRlbXBsYXRlSWQsIGRhdGEsIHJlbmRlckNvbnRleHQgKTsKCgkJfSBlbHNlIHsKCgkJCXZhciBkZWZlciA9ICQuRGVmZXJyZWQoKSwKCQkJCWNsb25lRXZlbnQgPSBleHRlbmQoIHRydWUsIHt9LCByZW5kZXJDb250ZXh0LmUgKSwKCQkJCXB1Ymxpc2hlciA9IGV4dGVuZCggdHJ1ZSwge30sIGNsb25lRXZlbnQucHVibGlzaGVyICksCgkJCQljbG9uZWRDb250ZXh0ID0gZXh0ZW5kKCB0cnVlLCB7fSwgcmVuZGVyQ29udGV4dCApOwoKCQkJY2xvbmVFdmVudC5wdWJsaXNoZXIgPSBwdWJsaXNoZXI7CgkJCWNsb25lZENvbnRleHQuZSA9IGNsb25lRXZlbnQ7CgoJCQkvL3RlbXBsYXRlLmxvYWQgaXMgaW1wbGVtZW50ZWQgaW4gZXh0ZXJuYWwtdGVtcGxhdGUuanMKCQkJdGVtcGxhdGUubG9hZCggdGVtcGxhdGVJZCApLmRvbmUoIGZ1bmN0aW9uKCkgewoKCQkJCXZhciBjb250ZW50ID0gZW5naW5lQWRhcHRlci5yZW5kZXIoIHJlYWxUZW1wbGF0ZUlkLCBkYXRhLCBjbG9uZWRDb250ZXh0ICksCgkJCQkJcnRuID0gJCggY29udGVudCApOwoKCQkJCWRlZmVyLnJlc29sdmUoIHJ0bi5zZWxlY3RvciB8fCAhcnRuLmxlbmd0aCA/IGNvbnRlbnQgOiBydG4gKTsKCgkJCX0gKTsKCgkJCXJldHVybiBkZWZlci5wcm9taXNlKCk7CgoJCX0KCX0KCglobS50ZW1wbGF0ZSA9IHRlbXBsYXRlID0gewoKCQlkZWZhdWx0RW5naW5lOiAiIiwKCgkJLyoKCQkgaG0udGVtcGxhdGUubXlFbmdpbmUgPSB7CgkJIHJlbmRlcjogZnVuY3Rpb24oIHRlbXBsYXRlSWQsIGRhdGEsIGNvbnRleHQgKSB7fSwKCQkgY29tcGlsZTogZnVuY3Rpb24oIHRlbXBsYXRlSWQsIHNvdXJjZSApIHt9LAoJCSBpc1RlbXBsYXRlTG9hZGVkOiBmdW5jdGlvbiggdGVtcGxhdGVJZCApIHt9CgkJIH07CgkJICovCgkJZW5naW5lQWRhcHRlcjogZnVuY3Rpb24oIG5hbWUsIGVuZ2luZUFkYXB0ZXIgKSB7CgkJCWlmICghbmFtZSkgewoJCQkJcmV0dXJuIHRlbXBsYXRlRW5naW5lQWRhcHRlcnM7CgkJCX0KCQkJaWYgKCFlbmdpbmVBZGFwdGVyKSB7CgkJCQlyZXR1cm4gdGVtcGxhdGVFbmdpbmVBZGFwdGVyc1tuYW1lXTsKCQkJfQoJCQllbmdpbmVBZGFwdGVyLmlzVGVtcGxhdGVMb2FkZWQgPSBlbmdpbmVBZGFwdGVyLmlzVGVtcGxhdGVMb2FkZWQgfHwgcmV0dXJuVHJ1ZTsKCQkJdGVtcGxhdGVFbmdpbmVBZGFwdGVyc1tuYW1lXSA9IGVuZ2luZUFkYXB0ZXI7CgkJCXRlbXBsYXRlLmRlZmF1bHRFbmdpbmUgPSBuYW1lOwoJCX0sCgoJCS8vZHluYW1pY2FsbHkgbG9hZCBhIHRlbXBsYXRlIGJ5IHRlbXBsYXRlSWQsCgkJLy9pdCBpcyBjYWxsZWQgYnkgdGVtcGxhdGUucmVuZGVyCgkJLy9UaGUgZGVmYXVsdCBpbXBsZW1lbnRhdGlvbiByZXF1aXJlZCBsb2FkZXIuanMKCQkvL2J1dCB5b3UgY2FuIG92ZXJyaWRlIHRoaXMsIGFsbCB5b3UgbmVlZAoJCS8vIGlzIHRvIHJldHVybiBpcyB0aGF0IGEgcHJvbWlzZSwgd2hlbiB0aGUgcHJvbWlzZSBpcwoJCS8vIGRvbmUsIHRoZSB0ZW1wbGF0ZSBzaG91bGQgYmUgcmVhZHkgdG8gdXNlZAoJCWxvYWQ6IGZ1bmN0aW9uKCB0ZW1wbGF0ZUlkICkgewoJCQkvL3dlIG5lZWQgdG8gbW9kaWZ5IHRoZSBpZCBieSBhZGRpbmcgYW4gZXh0ZW5zaW9uIHRvIHRoZSBpZAoJCQkvLyBobS5sb2FkZXIgdXNlIGV4dGVuc2lvbiB0byBkZXRlcm1pbmUgd2hhdCBsb2FkZXIgaXMgdXNlZAoJCQkvLyBoYW5kbGUgdGhlIGFjdHVhbCBsb2FkaW5nIHdvcmsKCQkJcmV0dXJuIF9sb2FkZXIubG9hZCggdGVtcGxhdGVJZC5lbmRzV2l0aCggIi5odG1sIiApID8gdGVtcGxhdGVJZCA6IHRlbXBsYXRlSWQgKyAiLnRlbXBsYXRlIiApOwoJCX0sCgoJCS8vdGhpcyBzaG91bGQgYmUgY2FsbGVkIGJ5IGhtLnRlbXBsYXRlLmxvYWQgYWZ0ZXIgdGhlIG1ldGhvZAoJCS8vZ2V0IHRoZSBzb3VyY2Ugb2YgdGhlIHRlbXBsYXRlCgkJY29tcGlsZTogZnVuY3Rpb24oIHRlbXBsYXRlSWQsIHNvdXJjZSwgZW5naW5lTmFtZSApIHsKCQkJcmV0dXJuIGdldFRlbXBsYXRlRW5naW5lKCBlbmdpbmVOYW1lICkuY29tcGlsZSgKCQkJCXRlbXBsYXRlSWQuZW5kc1dpdGgoICIudGVtcGxhdGUiICkgPyBfbG9hZGVyLmZpbGVOYW1lKCB0ZW1wbGF0ZUlkICkgOiB0ZW1wbGF0ZUlkLAoJCQkJc291cmNlICk7CgkJfSwKCgkJLy9idWlsZCBhIGN1c3RvbWl6ZWQgaGFuZGxlciB3aGljaCBoYW5kbGUgdGhlIGNoYW5nZSBvZiBtb2RlbAoJCS8vYnkgZGVmYXVsdAoJCS8vZ2V0RmlsdGVyIGlzICJnZXQiIHdoaWNoIGlzIHRvIGdldCBtb2RlbCB2YWx1ZSwKCQkvLyBpdCBjYW4gYmUgYSBzdHJpbmcgb3IgZnVuY3Rpb24gKGUpIHt9CgkJLy8KCQkvL3NldEZpbHRlciBpcyAiaHRtbCIgd2hpY2ggaXMgdG8gY2hhbmdlIHRoZSBjb250ZW50IG9mIHRoZSB2aWV3CgkJLy9pdCBjYW4gYmUgYSBzdHJpbmcgb3IgZnVuY3Rpb24gKGUsIHZhbHVlKQoJCW5ld1RlbXBsYXRlSGFuZGxlcjogbmV3VGVtcGxhdGVIYW5kbGVyLAoKCQl0ZW1wbGF0ZUlkVG9Vcmw6IGZ1bmN0aW9uKCB0ZW1wbGF0ZUlkICkgewoKCQkJdmFyIG1hdGNoID0gckJlZ2luV2l0aEFway5leGVjKCB0ZW1wbGF0ZUlkICk7CgoJCQlyZXR1cm4gbWF0Y2ggPwoJCQkJLy9hcGsuaGVsbG8gLS0+IGFwcGxldC9oZWxsby9tYWluLmh0bWwKCQkJCS8vYXBrLmhlbGxvLmJ5ZSAtLT4gYXBwbGV0L2hlbGxvL2J5ZS5odG1sCgkJCQkiYXBrLyIgKyBtYXRjaFsxXSArICIvIiArIChtYXRjaFszXSB8fCAibWFpbiIgKSArICIuaHRtbCIgOgoKCQkJCS8veHh4Lmh0bWwgLS0+IHh4eC5odG1sCgkJCQkvL3h4eC55eXkuaHRtbCAtLT4geHh4Lnl5eS5odG1sCgkJCQl0ZW1wbGF0ZUlkLmVuZHNXaXRoKCAiLmh0bWwiICkgPyB0ZW1wbGF0ZUlkIDoKCgkJCQkJLy94eHggLS0+IHh4eC5odG1sCgkJCQkJLy94eHgueXl5IC0tPiB4eHguaHRtbAoJCQkJCXRlbXBsYXRlSWQuc3BsaXQoICIuIiApWzBdICsgIi5odG1sIjsKCgkJfQoKCX07CgoJX2xvYWRlciggInRlbXBsYXRlIiwgewoKCQlsb2FkOiB7CgkJCWNvbXBpbGU6IGZ1bmN0aW9uKCBtb2R1bGVJZCwgc291cmNlQ29kZSApIHsKCgkJCQl2YXIgJHNjcmlwdExpc3QgPSAkKCBzb3VyY2VDb2RlICk7CgoJCQkJdmFyIGhhc1NjcmlwdFRhZyA9IGZhbHNlOwoJCQkJJHNjcmlwdExpc3QuZWFjaCggZnVuY3Rpb24oKSB7CgoJCQkJCWlmICh0aGlzLnRhZ05hbWUgPT0gIlNDUklQVCIpIHsKCQkJCQkJaGFzU2NyaXB0VGFnID0gdHJ1ZTsKCQkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJCX0KCQkJCX0gKTsKCgkJCQlpZiAoaGFzU2NyaXB0VGFnKSB7CgoJCQkJCSRzY3JpcHRMaXN0LmVhY2goIGZ1bmN0aW9uKCkgewoKCQkJCQkJaWYgKHRoaXMudGFnTmFtZSA9PSAiU0NSSVBUIikgewoKCQkJCQkJCXZhciAkc291cmNlQ29kZUNvbnRhaW5lciA9ICQoIHRoaXMgKTsKCgkJCQkJCQl0ZW1wbGF0ZS5jb21waWxlKAoJCQkJCQkJCXRoaXMuaWQsCgkJCQkJCQkJJHNvdXJjZUNvZGVDb250YWluZXIuaHRtbCgpLAoJCQkJCQkJCSRzb3VyY2VDb2RlQ29udGFpbmVyLmF0dHIoICJ0eXBlIiApIHx8IHRlbXBsYXRlLmRlZmF1bHRFbmdpbmUgKTsKCQkJCQkJfQoKCQkJCQl9ICk7CgkJCQl9IGVsc2UgewoJCQkJCXRlbXBsYXRlLmNvbXBpbGUoIG1vZHVsZUlkLCBzb3VyY2VDb2RlLCB0ZW1wbGF0ZS5kZWZhdWx0RW5naW5lICk7CgkJCQl9CgoJCQl9LAoJCQlidWlsZERlcGVuZGVuY2llczogInBhcnNlRGVwZW5kc1RhZyIKCQl9LAoKCQl1cmw6IGZ1bmN0aW9uKCB0ZW1wbGF0ZUlkICkgewoJCQkvL2ZpcnN0IHRydW5jYXRlIHRoZSAiLnRlbXBsYXRlIiBpbiB0aGUgdGVtcGxhdGVJZCwgYW5kIGdldCB0aGUgcmVhbCB0ZW1wbGF0ZUlkCgkJCXJldHVybiB0ZW1wbGF0ZS50ZW1wbGF0ZUlkVG9VcmwoIF9sb2FkZXIuZmlsZU5hbWUoIHRlbXBsYXRlSWQgKSApOwoJCX0KCX0gKTsKCglfbG9hZGVyKCAiaHRtbCIsICJ0ZW1wbGF0ZSIsIHsKCQkvLwkJbG9hZDogewoJCS8vCQkJY29tcGlsZTogZnVuY3Rpb24oIG1vZHVsZUlkLCBzb3VyY2VDb2RlICkgewoJCS8vCQkJCXJldHVybiB0ZW1wbGF0ZS5jb21waWxlKCBtb2R1bGVJZCwgc291cmNlQ29kZSwgdGVtcGxhdGUuZGVmYXVsdEVuZ2luZSApOwoJCS8vCQkJfQoJCS8vCQl9CgoJCXVybDogZnVuY3Rpb24oIHRlbXBsYXRlSWQgKSB7CgkJCXJldHVybiB0ZW1wbGF0ZUlkOwoJCX0KCX0gKTsKCgoJaWYgKCQucmVuZGVyICYmICQudGVtcGxhdGVzKSB7CgoJCXZhciBlbmdpbmU7CgoKCQl0ZW1wbGF0ZS5lbmdpbmVBZGFwdGVyKCAianNyZW5kZXIiLCBlbmdpbmUgPSB7CgoJCQlyZW5kZXI6IGZ1bmN0aW9uKCB0ZW1wbGF0ZUlkLCBkYXRhLCBjb250ZXh0ICkgewoJCQkJaWYgKCEkLnJlbmRlclt0ZW1wbGF0ZUlkXSkgewoJCQkJCXRoaXMuY29tcGlsZSggdGVtcGxhdGVJZCwgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoIHRlbXBsYXRlSWQgKS5pbm5lckhUTUwgKTsKCQkJCX0KCQkJCXJldHVybiAkLnJlbmRlclt0ZW1wbGF0ZUlkXSggZGF0YSwgY29udGV4dCApOwoJCQl9LAoKCQkJY29tcGlsZTogZnVuY3Rpb24oIHRlbXBsYXRlSWQsIHNvdXJjZSApIHsKCQkJCSQudGVtcGxhdGVzKCB0ZW1wbGF0ZUlkLCB7CgkJCQkJbWFya3VwOiBzb3VyY2UsCgkJCQkJZGVidWc6IGVuZ2luZS50ZW1wbGF0ZURlYnVnTW9kZSwKCQkJCQlhbGxvd0NvZGU6IGVuZ2luZS5hbGxvd0NvZGVJblRlbXBsYXRlCgkJCQl9ICk7CgkJCX0sCgoJCQlpc1RlbXBsYXRlTG9hZGVkOiBmdW5jdGlvbiggdGVtcGxhdGVJZCApIHsKCQkJCXJldHVybiAhISQucmVuZGVyW3RlbXBsYXRlSWRdIHx8ICEhZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoIHRlbXBsYXRlSWQgKTsKCQkJfSwKCgkJCS8vdGVtcGxhdGVEZWJ1Z01vZGUgaXMganNSZW5kZXIgc3BlY2lmaWMgc2V0dGluZwoJCQl0ZW1wbGF0ZURlYnVnTW9kZTogZmFsc2UsCgoJCQkvL2FsbG93Q29kZUluVGVtcGxhdGUgaXMganNSZW5kZXIgc3BlY2lmaWMgc2V0dGluZwoJCQlhbGxvd0NvZGVJblRlbXBsYXRlOiB0cnVlCgkJfSApOwoKCQl2YXIgdGFncyA9ICQudmlld3MudGFnczsKCgkJLy90aGUgZm9sbG93aW5nIHRhZ3MgYSBqc3JlbmRlciBzcGVjaWZpYyBoZWxwZXIKCQl0YWdzKCB7CgkJCS8vI2RlYnVnCgkJCS8ve3tkZWJ1Z2dlciAvfX0gc28gdGhhdCBpdCBjYW4gc3RvcCBpbiB0ZW1wbGF0ZSBmdW5jdGlvbgoJCQkiZGVidWdnZXIiOiBmdW5jdGlvbiB4KCBlICkgewoJCQkJaWYgKHguZW5hYmxlZCkgewoJCQkJCWRlYnVnZ2VyOwoJCQkJfQoJCQkJcmV0dXJuICIiOwoJCQl9LAoJCQkvLyNlbmRfZGVidWcKCgkJCS8ve3t0cyAvfX0gc28gdGhhdCBpdCBjYW4gZW1pdCBhIHRpbWVzdGFtcAoJCQl0czogZnVuY3Rpb24geCgpIHsKCQkJCXJldHVybiB4LmVuYWJsZWQgPwoJCQkJCSI8c3BhbiBzdHlsZT0nY29sb3I6cmVkJyBkYXRhLXN1Yj0nc2hvdzovKnRzJz51cGRhdGVkIG9uOiIgKyAoK25ldyBEYXRlKCkgKyAiIikuc3Vic3RyaW5nKCA3LCAxMCApICsgIjwvc3Bhbj4iIDoKCQkJCQkiIjsKCQkJfSwKCgkJCWdldDogZnVuY3Rpb24oKSB7CgkJCQl2YXIgcHVibGlzaGVyID0gdGhpcy5jdHguZS5wdWJsaXNoZXI7CgkJCQlyZXR1cm4gcHVibGlzaGVyLmdldC5hcHBseSggcHVibGlzaGVyLCBhcmd1bWVudHMgKTsKCQkJfSwKCgkJCXByb3A6IGZ1bmN0aW9uKCkgewoJCQkJdmFyIGluZGV4ID0gdGhpcy50YWdDdHgudmlldy5pbmRleDsKCgkJCQlpZiAoaXNVbmRlZmluZWQoIGluZGV4ICkpIHsKCQkJCQkvL3RoaXMgaXMgdGhlIGNhc2Ugd2hlbiB0ZW1wbGF0ZSBpcyByZW5kZXIgd2l0aAoJCQkJCS8vIGEgc2luZ2xlIGRhdGEgaXRlbSBpbnN0ZWFkIG9mIGFycmF5CgkJCQkJaW5kZXggPSAodGhpcy5jdHguZS5wdWJsaXNoZXIuY291bnQoKSAtIDEpOwoJCQkJfQoKCQkJCXZhciBpdGVtTm9kZSA9IHRoaXMuY3R4LmUucHVibGlzaGVyLmNkKCBpbmRleCApOwoJCQkJcmV0dXJuIGl0ZW1Ob2RlLmdldC5hcHBseSggaXRlbU5vZGUsIGFyZ3VtZW50cyApOwoJCQl9LAoKCQkJLy97e2ZpeGVkUm93SWQgL319CgkJCWZpeGVkUm93SWQ6IGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuICIvIiArIHRoaXMuY3R4Lm1vZGVsUGF0aCArICIudGFibGUuIiArIHRoaXMuY3R4LmUucHVibGlzaGVyLml0ZW1LZXkoIHRoaXMudGFnQ3R4LnZpZXcuZGF0YSApOwoJCQl9LAoKCQkJLy97e3Jvd0lkIC99fQoJCQlyb3dJZDogZnVuY3Rpb24oKSB7CgkJCQl2YXIgaW5kZXggPSB0aGlzLnRhZ0N0eC52aWV3LmluZGV4LAoJCQkJCXBhdGggPSB0aGlzLmN0eC5tb2RlbFBhdGg7CgoJCQkJaWYgKGlzVW5kZWZpbmVkKCBpbmRleCApKSB7CgkJCQkJLy90aGlzIGlzIHRoZSBjYXNlIHdoZW4gdGVtcGxhdGUgaXMgcmVuZGVyIHdpdGgKCQkJCQkvLyBhIHNpbmdsZSBkYXRhIGl0ZW0gaW5zdGVhZCBvZiBhcnJheQoJCQkJCWluZGV4ID0gKHRoaXMuY3R4LmUucHVibGlzaGVyLmNvdW50KCkgLSAxKTsKCQkJCX0KCgkJCQlyZXR1cm4gIi8iICsgcGF0aCArICIuIiArIGluZGV4OwoJCQl9LAoKCQkJLy97e21vZGVsUGF0aCAvfX0KCQkJLy9pdCB1c2VmdWwgd2hlbiAgaW4gaHR0cDovL2pzYmluLmNvbS9ldGFjb2IvNi9lZGl0CgkJCW1vZGVsUGF0aDogZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gIi8iICsgdGhpcy5jdHgubW9kZWxQYXRoOwoJCQl9CgoJCX0gKTsKCgkJdGFncy50cy5yZW5kZXIuZW5hYmxlZCA9IHRydWU7CgkJLy8jZGVidWcKCQl0YWdzWyJkZWJ1Z2dlciJdLnJlbmRlci5lbmFibGVkID0gdHJ1ZTsKCQkvLyNlbmRfZGVidWcKCgkJaG0oICIqdHMiLCBmYWxzZSApOwoKCX0KCgoKLy8KCgoJdmFyIEhhbmRsZWJhcnMgPSB3aW5kb3cuSGFuZGxlYmFyczsKCglpZiAoIWlzVW5kZWZpbmVkKCBIYW5kbGViYXJzICkpIHsKCgkJaG0udGVtcGxhdGUuZW5naW5lQWRhcHRlciggImhhbmRsZWJhcnMiLCB7CgoJCQlyZW5kZXI6IGZ1bmN0aW9uKCB0ZW1wbGF0ZUlkLCBkYXRhLCBjb250ZXh0ICkgewoKCQkJCXJldHVybiBIYW5kbGViYXJzLnBhcnRpYWxzW3RlbXBsYXRlSWRdKCBkYXRhLCB7CgkJCQkJZGF0YToge3JlbmRlckNvbnRleHQ6IGNvbnRleHR9CgkJCQl9ICk7CgkJCX0sCgoJCQljb21waWxlOiBmdW5jdGlvbiggdGVtcGxhdGVJZCwgc291cmNlICkgewoJCQkJSGFuZGxlYmFycy5yZWdpc3RlclBhcnRpYWwoIHRlbXBsYXRlSWQsIEhhbmRsZWJhcnMuY29tcGlsZSggc291cmNlICkgKTsKCQkJfSwKCgkJCWlzVGVtcGxhdGVMb2FkZWQ6IGZ1bmN0aW9uKCB0ZW1wbGF0ZUlkICkgewoJCQkJcmV0dXJuICEhSGFuZGxlYmFycy5wYXJ0aWFsc1t0ZW1wbGF0ZUlkXTsKCQkJfQoKCQl9ICk7CgoJCS8ve3ttb2RlbFBhdGh9fQoJCUhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoICJtb2RlbFBhdGgiLCBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQkJcmV0dXJuIG9wdGlvbnMuZGF0YS5yZW5kZXJDb250ZXh0Lm1vZGVsUGF0aDsKCQl9ICk7CgoJCS8ve3tyb3dJZH19CgkJSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlciggInJvd0lkIiwgZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJCXJldHVybiAiLyIgKyBvcHRpb25zLmRhdGEucmVuZGVyQ29udGV4dC5tb2RlbFBhdGggKyAiLiIgKyBvcHRpb25zLmRhdGEuaW5kZXggKyAiOyI7CgkJfSApOwoKCQkvL3t7Zml4ZWRSb3dJZH19CgkJSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlciggImZpeGVkUm93SWQiLCBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQkJdmFyIHJlbmRlckNvbnRleHQgPSBvcHRpb25zLmRhdGEucmVuZGVyQ29udGV4dDsKCQkJcmV0dXJuICIvIiArIHJlbmRlckNvbnRleHQubW9kZWxQYXRoICsgIi50YWJsZS4iICsgcmVuZGVyQ29udGV4dC5lLnB1Ymxpc2hlci5pdGVtS2V5KCB0aGlzICk7CgkJfSApOwoKCQkvL3t7Z2V0ICIuLnNldFRvIiBuYW1lfX0KCQlIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCAiZ2V0IiwgZnVuY3Rpb24oKSB7CgkJCXZhciBhcmdzID0gYXJndW1lbnRzLAoJCQkJbGFzdCA9IGFyZ3MubGVuZ3RoIC0gMSwKCQkJLy9hcmdzW2xhc3RdLmRhdGEgaXMgb3B0aW9ucy5kYXRhCgkJCQlyZW5kZXJDb250ZXh0ID0gYXJnc1tsYXN0XS5kYXRhLnJlbmRlckNvbnRleHQ7CgoJCQlyZXR1cm4gcmVuZGVyQ29udGV4dC5nZXQuYXBwbHkoIHJlbmRlckNvbnRleHQsIHNsaWNlLmNhbGwoIGFyZ3MsIDAsIGxhc3QgKSApOwoJCX0gKTsKCgkJLy97e3twcm9wICJsaW5rIn19fQoJCUhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoICJwcm9wIiwgZnVuY3Rpb24oKSB7CgkJCXZhciBzbGljZSA9IFtdLnNsaWNlLAoJCQkJYXJncyA9IGFyZ3VtZW50cywKCQkJCWxhc3QgPSBhcmdzLmxlbmd0aCAtIDEsCgkJCQlvcHRpb25zID0gYXJnc1tsYXN0XSwKCQkJCWRhdGEgPSBvcHRpb25zLmRhdGEsCgkJCQlyZW5kZXJDb250ZXh0ID0gZGF0YS5yZW5kZXJDb250ZXh0LAoJCQkJaXRlbU5vZGUgPSByZW5kZXJDb250ZXh0LmUucHVibGlzaGVyLmNkKCBkYXRhLmluZGV4ICk7CgoJCQlyZXR1cm4gaXRlbU5vZGUuZ2V0LmFwcGx5KCBpdGVtTm9kZSwgc2xpY2UuY2FsbCggYXJncywgMCwgbGFzdCApICk7CgkJfSApOwoKCQkkKCBmdW5jdGlvbigpIHsKCQkJJCggInNjcmlwdFt0eXBlPWhhbmRsZWJhcnNdIiApLmVhY2goIGZ1bmN0aW9uKCkgewoJCQkJSGFuZGxlYmFycy5yZWdpc3RlclBhcnRpYWwoIHRoaXMuaWQsIEhhbmRsZWJhcnMuY29tcGlsZSggJCggdGhpcyApWzBdLmlubmVySFRNTCApICk7CgkJCX0gKTsKCQl9ICk7CgoJfQoKCgovLwovLzxAZGVwZW5kcz5zdWJzY3JpcHRpb24uanMsIG1vZGVsLmpzLCBkZWNsYXJhdGl2ZS5qcywgdGVtcGxhdGUuanM8L0BkZXBlbmRzPgoKCgkvL2Rvbid0IGNoYW5nZSBpdCB0byBiZWNhdXNlIHdlIHdhbnQgdG8gY29udHJvbCB0aGUgc2VhcmNoIG9yZGVyCgkvL2NoZWNrIGZpbmRWYWx1ZUFkYXB0ZXIoJGVsZW0sIGFkYXB0ZXJOYW1lKQoJLy97CgkvLyAgIG5hbWUxOiBhZGFwdGVyMSwKCS8vICAgbmFtZTI6IGFkYXB0ZXIyCgkvL30KCXZhciB2YWx1ZUFkYXB0ZXJzID0gWwoJCXsKCQkJLy90aGUgZGVmYXVsdCB2aWV3IGFkYXB0ZXIKCQkJbmFtZTogInRleHRCb3hPckRyb3BEb3duIiwKCQkJaW5pdGlhbGl6ZTogZnVuY3Rpb24oICRlbGVtLCBtb2RlbFZhbHVlICkgewoJCQkJaWYgKG1vZGVsVmFsdWUpIHsKCQkJCQlpZiAoJGVsZW1bMF0udGFnTmFtZSA9PSAiU0VMRUNUIikgewoJCQkJCQkkZWxlbS5jaGlsZHJlbigpLmVhY2goIGZ1bmN0aW9uKCkgewoJCQkJCQkJaWYgKHRoaXMudmFsdWUgPT0gbW9kZWxWYWx1ZSkgewoJCQkJCQkJCSQoIHRoaXMgKS5hdHRyKCAic2VsZWN0ZWQiLCAic2VsZWN0ZWQiICk7CgkJCQkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJCQkJfQoJCQkJCQl9ICk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJJGVsZW0uYXR0ciggInZhbHVlIiwgbW9kZWxWYWx1ZSApOwoJCQkJCX0KCQkJCX0KCQkJfSwKCQkJZ2V0OiBmdW5jdGlvbiggJGVsZW0gKSB7CgkJCQlyZXR1cm4gJGVsZW0udmFsKCk7CgkJCX0sCgkJCXNldDogZnVuY3Rpb24oICRlbGVtLCB2YWx1ZSApIHsKCQkJCWlmICgkZWxlbS52YWwoKSAhPT0gdmFsdWUpIHsKCQkJCQkkZWxlbS52YWwoIHZhbHVlICk7CgkJCQl9CgkJCX0sCgkJCW1hdGNoOiByZXR1cm5UcnVlCgkJfSwKCQl7CgkJCW5hbWU6ICJjaGVja2JveCIsCgkJCWluaXRpYWxpemU6IGZ1bmN0aW9uKCAkZWxlbSwgbW9kZWxWYWx1ZSApIHsKCQkJCWlmIChtb2RlbFZhbHVlKSB7CgkJCQkJJGVsZW0uYXR0ciggImNoZWNrZWQiLCAiY2hlY2tlZCIgKTsKCQkJCX0KCQkJfSwKCQkJZ2V0OiBmdW5jdGlvbiggJGVsZW0sIGUgKSB7CgkJCQl2YXIgZWxlbSA9ICRlbGVtWzBdOwoJCQkJdmFyIHZhbHVlID0gZWxlbS52YWx1ZTsKCgkJCQlpZiAodmFsdWUgPT0gInRydWUiKSB7CgkJCQkJcmV0dXJuIHRydWU7CgkJCQl9IGVsc2UgaWYgKHZhbHVlID09ICJmYWxzZSIpIHsKCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQl9IGVsc2UgaWYgKHZhbHVlICE9PSAib24iKSB7CgkJCQkJcmV0dXJuIHZhbHVlOwoJCQkJfSBlbHNlIHsKCQkJCQlyZXR1cm4gZWxlbS5jaGVja2VkOwoJCQkJfQoJCQl9LAoJCQlzZXQ6IGZ1bmN0aW9uIHNldENoZWNrYm94KCAkZWxlbSwgdmFsdWUgKSB7CgkJCQl2YXIgZWxlbSA9ICRlbGVtWzBdOwoJCQkJaWYgKGlzQm9vbGVhbiggdmFsdWUgKSkgewoJCQkJCWVsZW0uY2hlY2tlZCA9IHZhbHVlOwoJCQkJfSBlbHNlIHsKCQkJCQllbGVtLmNoZWNrZWQgPSAodmFsdWUgPT0gZWxlbS52YWx1ZSk7CgkJCQl9CgkJCX0sCgkJCW1hdGNoOiBmdW5jdGlvbiggJGVsZW0gKSB7CgkJCQlyZXR1cm4gJGVsZW0uaXMoICI6Y2hlY2tib3giICk7CgkJCX0KCQl9LAoJCXsKCQkJbmFtZTogInJhZGlvIiwKCQkJaW5pdGlhbGl6ZTogZnVuY3Rpb24oICRlbGVtLCBtb2RlbFZhbHVlICkgewoKCQkJCWlmIChtb2RlbFZhbHVlID09ICRlbGVtWzBdLnZhbHVlKSB7CgkJCQkJJGVsZW0uYXR0ciggImNoZWNrZWQiLCAiY2hlY2tlZCIgKTsKCQkJCX0KCQkJfSwKCQkJZ2V0OiBmdW5jdGlvbiggJGVsZW0sIGUgKSB7CgkJCQlpZiAoZS50eXBlID09ICJyZXNldFZhbCIgJiYgIWUucHVibGlzaGVyLmF0dHIoICJjaGVja2VkIiApKSB7CgkJCQkJZS5hYm9ydCgpOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQl2YXIgZWxlbSA9ICRlbGVtWzBdOwoJCQkJdmFyIHZhbHVlID0gZWxlbS52YWx1ZTsKCQkJCWlmICh2YWx1ZSA9PSAidHJ1ZSIpIHsKCQkJCQlyZXR1cm4gdHJ1ZTsKCQkJCX0gZWxzZSBpZiAodmFsdWUgPT0gImZhbHNlIikgewoJCQkJCXJldHVybiBmYWxzZTsKCQkJCX0gZWxzZSBpZiAodmFsdWUgIT09ICJvbiIpIHsKCQkJCQlyZXR1cm4gdmFsdWU7CgkJCQl9IGVsc2UgewoJCQkJCXJldHVybiBlbGVtLmNoZWNrZWQ7CgkJCQl9CgkJCX0sCgkJCXNldDogZnVuY3Rpb24oICRlbGVtLCB2YWx1ZSwgZSApIHsKCQkJCXZhciBlbGVtID0gJGVsZW1bMF07CgkJCQlpZiAoIWVsZW0ubmFtZSkgewoJCQkJCWVsZW0ubmFtZSA9IGUucHVibGlzaGVyLnBhdGg7CgkJCQl9CgkJCQllbGVtLmNoZWNrZWQgPSAoIHV0aWwudG9TdHJpbmcoIHZhbHVlICkgPT0gZWxlbS52YWx1ZSApOwoJCQl9LAoJCQltYXRjaDogZnVuY3Rpb24oICRlbGVtICkgewoJCQkJcmV0dXJuICRlbGVtLmlzKCAiOnJhZGlvIiApOwoJCQl9CgkJfSwKCQl7CgkJCW5hbWU6ICJsaXN0Qm94IiwKCQkJaW5pdGlhbGl6ZTogZnVuY3Rpb24oICRlbGVtLCBtb2RlbFZhbHVlICkgewoJCQkJJGVsZW0uY2hpbGRyZW4oKS5lYWNoKCBmdW5jdGlvbigpIHsKCQkJCQlpZiAobW9kZWxWYWx1ZS5jb250YWlucyggdGhpcy52YWx1ZSApKSB7CgkJCQkJCSQoIHRoaXMgKS5hdHRyKCAic2VsZWN0ZWQiLCAic2VsZWN0ZWQiICk7CgkJCQkJfQoJCQkJfSApOwoJCQl9LAoKCQkJZ2V0OiBmdW5jdGlvbiggJGVsZW0gKSB7CgkJCQl2YXIgb3B0aW9ucyA9IFtdOwoJCQkJJGVsZW0uY2hpbGRyZW4oICJvcHRpb246c2VsZWN0ZWQiICkuZWFjaCggZnVuY3Rpb24oKSB7CgkJCQkJb3B0aW9ucy5wdXNoKCB0aGlzLnZhbHVlICk7CgkJCQl9ICk7CgkJCQlyZXR1cm4gb3B0aW9ucy5sZW5ndGggPyBvcHRpb25zIDogbnVsbDsKCQkJfSwKCQkJc2V0OiBmdW5jdGlvbiggJGVsZW0sIHZhbHVlICkgewoJCQkJJGVsZW0uY2hpbGRyZW4oKS5lYWNoKCBmdW5jdGlvbigpIHsKCQkJCQl0aGlzLnNlbGVjdGVkID0gISEodmFsdWUgJiYgdmFsdWUuY29udGFpbnMoIHRoaXMudmFsdWUgKSk7CgkJCQl9ICk7CgkJCX0sCgkJCW1hdGNoOiBmdW5jdGlvbiggJGVsZW0gKSB7CgkJCQlyZXR1cm4gJGVsZW0uaXMoICJzZWxlY3RbbXVsdGlwbGVdIiApOwoJCQl9CgkJfQoJXTsKCglmdW5jdGlvbiBmaW5kVmFsdWVBZGFwdGVyKCAkZWxlbSwgYWRhcHRlck5hbWUgKSB7CgkJdmFyIGksIGFkYXB0ZXI7CgoJCWlmIChhZGFwdGVyTmFtZSkgewoJCQlmb3IgKGkgPSB2YWx1ZUFkYXB0ZXJzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CgkJCQlhZGFwdGVyID0gdmFsdWVBZGFwdGVyc1tpXTsKCQkJCWlmIChhZGFwdGVyLm5hbWUgPT0gYWRhcHRlck5hbWUpIHsKCQkJCQlyZXR1cm4gYWRhcHRlcjsKCQkJCX0KCQkJfQoJCX0gZWxzZSB7CgkJCS8vc2VhcmNoIGZyb20gdGFpbCB0byBoZWFkCgkJCWZvciAoaSA9IHZhbHVlQWRhcHRlcnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKCQkJCWFkYXB0ZXIgPSB2YWx1ZUFkYXB0ZXJzW2ldOwoJCQkJaWYgKGFkYXB0ZXIubWF0Y2ggJiYgYWRhcHRlci5tYXRjaCggJGVsZW0gKSkgewoJCQkJCXJldHVybiBhZGFwdGVyOwoJCQkJfQoJCQl9CgkJfQoJfQoKCWhtLmFjdGl2aXR5LmdldC5nZXRWaWV3VmFsdWUgPSBmdW5jdGlvbiggZSApIHsKCQkvL2UuaGFuZGxlci5nZXRWaWV3VmFsdWUgaXMgaW5pdGlhbGl6ZWQgd2hlbiBvbiBzdWJzY3JpcHRpb24KCQlyZXR1cm4gZS5oYW5kbGVyLmdldFZpZXdWYWx1ZSggZS5wdWJsaXNoZXIsIGUgKTsKCX07CgoJaG0uYWN0aXZpdHkuc2V0LnNldFZpZXdWYWx1ZSA9IGZ1bmN0aW9uKCB2YWx1ZSwgZSApIHsKCQkvL2UuaGFuZGxlci5zZXRWaWV3VmFsdWUgaXMgaW5pdGlhbGl6ZWQgd2hlbiBvbiBzdWJzY3JpcHRpb24KCQlyZXR1cm4gZS5oYW5kbGVyLnNldFZpZXdWYWx1ZSggdGhpcywgdmFsdWUsIGUgKTsKCX07CgoJZnVuY3Rpb24gaW5pdEFkYXB0ZXJNZXRob2RGb3JWaWV3KCBtb2RlbCwgdmlldywgaGFuZGxlciwgYWRhcHRlck5hbWUsIG1ldGhvZE5hbWUgKSB7CgoJCXZhciBhZGFwdGVyID0gZmluZFZhbHVlQWRhcHRlciggdmlldywgYWRhcHRlck5hbWUgKTsKCgkJaWYgKCFhZGFwdGVyIHx8ICFhZGFwdGVyW21ldGhvZE5hbWVdKSB7CgoJCQl0aHJvdyAiY2FuIG5vdCBmaW5kICIgKyBtZXRob2ROYW1lICsgIiBtZXRob2QgZm9yIHZpZXciOwoJCX0KCgkJLy9jcmVhdGUgaGFuZGxlci5nZXRWaWV3VmFsdWUgb3IgaGFuZGxlci5zZXRWaWV3VmFsdWUKCQloYW5kbGVyW21ldGhvZE5hbWUgKyAiVmlld1ZhbHVlIl0gPSBhZGFwdGVyW21ldGhvZE5hbWVdOwoKCQlpZiAoYWRhcHRlci5jb252ZXJ0KSB7CgkJCWhhbmRsZXIuY29udmVydCA9IGFkYXB0ZXIuY29udmVydDsKCQl9CgoJCS8vd2Ugd2FudCB0byBydW4gdGhlIGluaXRpYWxpemUgbWV0aG9kIG9ubHkgb25jZQoJCWlmICghdmlldy5obURhdGEoICJ2YWx1ZUJvdW5kIiApKSB7CgoJCQlhZGFwdGVyLmluaXRpYWxpemUgJiYgYWRhcHRlci5pbml0aWFsaXplKCB2aWV3LCBtb2RlbC5nZXQoKSApOwoKCQkJLy93aGVuICJyZXNldCIgZXZlbnQgaXMgdHJpZ2dlciB0byBwYXJlbnQgZm9ybSwgdGhlIGNoaWxkcmVuIGRvZXMKCQkJLy9ub3QgdHJpZ2dlciB0aGUgZXZlbnQsIHNvIHRoYXQgd2UgbmVlZCB0byB0cmlnZ2VyICJyZXNldFZhbCIgdG8gdXBkYXRlCgkJCS8vYmFjayB0aGUgb3JpZ2luYWwgdmFsdWUgdG8gbW9kYWwKCQkJdmlldy5wYXJlbnRzKCAiZm9ybSIgKS5iaW5kKCAicmVzZXQiLCBmdW5jdGlvbigpIHsKCgkJCQlzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJCQl2aWV3LnRyaWdnZXJIYW5kbGVyKCAicmVzZXRWYWwiICk7CgkJCQl9LCAxMCApOwoJCQl9ICk7CgoJCQl2aWV3LmhtRGF0YSggInZhbHVlQm91bmQiLCB0cnVlICk7CgoJCX0KCX0KCglobS53b3JrZmxvdyggewoKCQkvL3NldCB2aWV3IHZhbHVlIHdpdGggbW9kZWwgdmFsdWUKCQl1cGRhdGVWaWV3VmFsdWU6IHsKCQkJaW5pdGlhbGl6ZTogZnVuY3Rpb24oIHB1Ymxpc2hlciwgc3Vic2NyaWJlciwgd29ya2Zsb3csIGFkYXB0ZXJOYW1lICkgewoJCQkJLy9zdWJzY3JpYmVyIGlzIHZpZXcsIHRyeWluZyB0byBnZXRNb2RlbCBzZXRWaWV3CgkJCQlpbml0QWRhcHRlck1ldGhvZEZvclZpZXcoIHB1Ymxpc2hlciwgc3Vic2NyaWJlciwgd29ya2Zsb3csIGFkYXB0ZXJOYW1lLCAic2V0IiApOwoKCQkJfSwKCQkJZ2V0OiAiZ2V0IiwKCQkJc2V0OiAiKnNldFZpZXdWYWx1ZSIKCQl9LAoKCQkvL3NldCBtb2RlbCB2YWx1ZSB3aXRoIHZpZXcgdmFsdWUKCQl1cGRhdGVNb2RlbFZhbHVlOiB7CgoJCQlpbml0aWFsaXplOiBmdW5jdGlvbiggcHVibGlzaGVyLCBzdWJzY3JpYmVyLCB3b3JrZmxvdywgYWRhcHRlck5hbWUgKSB7CgkJCQkvL3B1Ymxpc2hlciBpcyB2aWV3LCB0cnlpbmcgdG8gZ2V0VmlldyBzZXRNb2RlbAoJCQkJaW5pdEFkYXB0ZXJNZXRob2RGb3JWaWV3KCBzdWJzY3JpYmVyLCBwdWJsaXNoZXIsIHdvcmtmbG93LCBhZGFwdGVyTmFtZSwgImdldCIgKTsKCgkJCX0sCgkJCWdldDogIipnZXRWaWV3VmFsdWUiLAoJCQlzZXQ6ICJzZXQiCgkJfQoJfSApOwoKCS8vYWRkIHZhbHVlIGFkYXB0ZXIKCS8vdGhlIGxhc3QgYWRkZWQgdXNpbmcgdGhlIG1ldGhvZCwgd2lsbCBiZSBldmFsdWF0ZWQgZmlyc3QKCS8qCgkgLy9hIHZpZXcgYWRhcHRlciBpcyBpcyBsaWtlCgkgewoJIC8vb3B0aW9uYWwgaWYgbWF0Y2ggZnVuY3Rpb24gaXMgcHJlc2VudAoJIG5hbWU6ICJhZGFwdGVyTmFtZSIsCgkgLy8KCSAvL29wdGlvbmFsIGlmIG5hbWUgaXMgcHJlc2VudAoJIG1hdGNoOiBmdW5jdGlvbiAoJGVsZW0pIHsgcmV0dXJuIHRydWU7IH0sCgkgLy8KCSAvL3ByZXBhcmUgJGVsZW1lbnQKCSBpbml0aWFsaXplOiBmdW5jdGlvbiAoJGVsZW0pIHt9CgkgLy8KCSAvL2dldCBhIHZhbHVlIGZyb20gZWxlbWVudAoJIGdldDogZnVuY3Rpb24gKCRlbGVtKSB7fSwKCSAvLwoJIC8vc2V0IGEgdmFsdWUgdG8gJGVsZW1lbnQKCSBzZXQ6IGZ1bmN0aW9uKCAkZWxlbSwgdmFsdWUgKSB7fSwKCSAvLwoJIC8vb3B0aW9uYWwsIGlmIGdldCBmdW5jdGlvbiBhbHJlYWR5IGNvbnZlcnQsIHlvdSBkb24ndCBuZWVkIHRoaXMKCSBjb252ZXJ0OiAiKmNvbW1vbkNvbnZlcnRBY3Rpdml0eU5hbWUiIG9yIGZ1bmN0aW9uICh2YWx1ZSkge30KCgkgfQoJICogKi8KCWhtLnZhbHVlQWRhcHRlciA9IGZ1bmN0aW9uKCBhZGFwdGVyICkgewoJCWlmIChhZGFwdGVyKSB7CgkJCXZhbHVlQWRhcHRlcnMucHVzaCggYWRhcHRlciApOwoJCX0gZWxzZSB7CgkJCXJldHVybiB2YWx1ZUFkYXB0ZXJzOwoJCX0KCX07CgoJLy9keW5hbWljIGdyb3VwCgkvL3N1cHBvcnQgdGhlIGZvbGxvd2luZwoJLy8KCS8vdmFsOnBhdGgKCS8vdmFsOnBhdGh8a2V5cHJlc3MKCS8vdmFsOnBhdGh8LHVwZGF0ZU1vZGVsCgkvL3ZhbDpwYXRofCx1cGRhdGVWaWV3CgkvL3ZhbDpwYXRofCwsZGF0ZQoJLy92YWw6cGF0aHx1cGRhdGVFdmVudCx1cGRhdGVEaXJlY3Rpb24sYWRhcHRlck5hbWUKCWJpbmRpbmdzKCB7CgkJdmFsOiBmdW5jdGlvbiggZWxlbSwgcGF0aCwgY29udGV4dCwgb3B0aW9ucyApIHsKCgkJCXZhciB1cGRhdGVUYXJnZXQsCgkJCQl1cGRhdGVFdmVudCwKCQkJCWFkYXB0ZXJOYW1lOwoKCQkJb3B0aW9ucyA9IG9wdGlvbnMgfHwgIiI7CgoJCQlpZiAoIW9wdGlvbnMpIHsKCQkJCXVwZGF0ZUV2ZW50ID0gImNoYW5nZSI7CgkJCX0gZWxzZSB7CgkJCQlvcHRpb25zID0gb3B0aW9ucy5zcGxpdCggIiwiICk7CgkJCQl1cGRhdGVFdmVudCA9IG9wdGlvbnNbMF0gfHwgImNoYW5nZSI7IC8vYnkgZGVmYXVsdCBpdCBpcyAiY2hhbmdlIgoJCQkJdXBkYXRlVGFyZ2V0ID0gb3B0aW9uc1sxXTsgLy91bmRlZmluZWQsIHVwZGF0ZVZpZXcgb3IgdXBkYXRlTW9kZWwKCQkJCWFkYXB0ZXJOYW1lID0gb3B0aW9uc1syXTsKCQkJfQoKCQkJaWYgKCF1cGRhdGVUYXJnZXQgfHwgdXBkYXRlVGFyZ2V0ID09ICJ2aWV3IikgewoJCQkJY29udGV4dC5hcHBlbmRTdWIoIGVsZW0sIHBhdGgsICJpbml0MSBhZnRlcioiLCAiKnVwZGF0ZVZpZXdWYWx1ZSIsIGFkYXB0ZXJOYW1lICk7CgkJCX0KCgkJCWlmICghdXBkYXRlVGFyZ2V0IHx8IHVwZGF0ZVRhcmdldCA9PSAibW9kZWwiKSB7CgoJCQkJLy93aGVuIGZvcm0gaXMgcmVzZXQsIHRoZSBkZWZhdWx0IGJlaGF2aW9yIG9mIHRoZSBodG1sIGZvcm0gdmFsdWUgaXMgcmVzZXQKCQkJCS8vIHRvIHZhbHVlIHNwZWNpZnkgInZhbHVlIiBhdHRyaWJ1dGUsIGhvd2V2ZXIgdGhlIGNoYW5nZSBldmVudCBkb2VzIG5vdCB0cmlnZ2VyLAoJCQkJLy8KCQkJCS8vc28gd2UgbmVlZCB0byB1c2UgYSBzcGVjaWFsIGV2ZW50ICJyZXNldFZhbCIgd2hpY2ggaXMgdHJpZ2dlcmVkCgkJCQkvLyB3aGVuIHRoZSBwYXJlbnQgZm9ybSBlbGVtZW50IGlzIHRyaWdnZXJlZAoJCQkJLy8gYnkgdXNpbmcgdGhpcyBldmVudCwgd2Ugd2FudCB0byB1cGRhdGUgbW9kZWwgZnJvbSB0aGUgdmlldyB2YWx1ZQoJCQkJY29udGV4dC5wcmVwZW5kU3ViKCBwYXRoLCBlbGVtLCB1cGRhdGVFdmVudCArICIgcmVzZXRWYWwiLCAiKnVwZGF0ZU1vZGVsVmFsdWUiLCBhZGFwdGVyTmFtZSApOwoKCQkJfQoJCX0KCX0gKTsKCgoKLy8KLy88QGRlcGVuZHM+c3Vic2NyaXB0aW9uLmpzLCBtb2RlbC5qcywgZGVjbGFyYXRpdmUuanMsIHRlbXBsYXRlLmpzPC9AZGVwZW5kcz4KCgoJZGVmYXVsdE9wdGlvbnMuY29uZmlybU1lc3NhZ2UgPSAiQXJlIHlvdSBzdXJlPyI7CgoJZnVuY3Rpb24gYWRkQmluZGluZ0FuZFdvcmtmbG93VHlwZSggZmVhdHVyZXMgKSB7CgkJZm9yICh2YXIgbmFtZSBpbiBmZWF0dXJlcykgewoJCQl2YXIgaXRlbSA9IGZlYXR1cmVzW25hbWVdOwoJCQliaW5kaW5ncyggbmFtZSwgaXRlbVswXSApOwoJCQlobS53b3JrZmxvdyggbmFtZSwgaXRlbVsxXSApOwoJCX0KCX0KCglobS5hY3Rpdml0eS5nZXQuY29tcGFyZVRydXRoeSA9IGZ1bmN0aW9uKCBlICkgewoJCXZhciBleHByZXNzaW9uID0gZS5oYW5kbGVyLm9wdGlvbnMsCgkJCXB1Ymxpc2hlciA9IGUucHVibGlzaGVyOwoJCXJldHVybiBpc1VuZGVmaW5lZCggZXhwcmVzc2lvbiApID8KCQkJIXB1Ymxpc2hlci5pc0VtcHR5KCkgOgoJCQlwdWJsaXNoZXIuY29tcGFyZSggZXhwcmVzc2lvbiApOwoJfTsKCglobS5hY3Rpdml0eS5pbml0aWFsaXplLmV4dHJhY3RDbGFzcyA9IGZ1bmN0aW9uKCBwdWJsaXNoZXIsIHN1YnNjcmliZXIsIHdvcmtmbG93LCBvcHRpb25zICkgewoJCXZhciBwYXJ0cyA9IG9wdGlvbnMuc3BsaXQoICIsIiApOwoJCXdvcmtmbG93LmNsYXNzTmFtZSA9IHBhcnRzWzBdOwoJCXdvcmtmbG93Lm9wdGlvbnMgPSBwYXJ0c1sxXTsKCX07CgoJYWRkQmluZGluZ0FuZFdvcmtmbG93VHlwZSggewoKCQkvLy0tLS0tLS0tY2hhbmdpbmcgdmlldy0tLS0tLS0tLS0KCQlvcHRpb25zOiBbCgkJCSIhaW5pdCBhZnRlcio6Lnwqb3B0aW9ucyIsCgkJCS8vYWRkIG1vZGVsIHdvcmtmbG93cwoJCQkvL3JlbmRlciA8c2VsZWN0PiBvcHRpb25zCgkJCS8vPHNlbGVjdCBvcHRpb25zPSJtb2RlbFBhdGgiPgoJCQkvLzxzZWxlY3Qgb3B0aW9ucz0ibW9kZWxQYXRofHByb3BlcnR5TmFtZSI+CgkJCS8vPHNlbGVjdCBvcHRpb25zPSJtb2RlbFBhdGh8dGV4dENvbHVtbix2YWxDb2x1bW4iPgoJCQl7CgkJCQkvL3RoaXMgaXMgYWN0dWFsbHkgdGhlIGV4ZWN1dGUgZnVuY3Rpb24sIGluIHRoaXMgd29ya2Zsb3cKCQkJCS8vdGhlcmUgaXMgbm8gc2V0LCB0aGUgY29udGVudCBvZiB0aGUgdmlldyBpcyByZW5kZXIKCQkJCS8vaW4gdGhlIGdldCBmdW5jdGlvbi4KCQkJCWdldDogZnVuY3Rpb24oIGUgKSB7CgkJCQkJdmFyIG9wdGlvbnMgPSBlLmhhbmRsZXIub3B0aW9ucywKCQkJCQkJc3Vic2NyaWJlciA9IHRoaXMsCgkJCQkJCXZhbHVlID0gc3Vic2NyaWJlci52YWwoKTsKCgkJCQkJc3Vic2NyaWJlci5jaGlsZHJlbiggIm9wdGlvbltsaXN0SXRlbV0iICkKCQkJCQkJLnJlbW92ZSgpLmVuZCgpLmFwcGVuZCgKCQkJCQkJZnVuY3Rpb24oKSB7CgkJCQkJCQl2YXIgaHRtbCA9ICIiOwoJCQkJCQkJJCggZS5wdWJsaXNoZXIuZ2V0KCkgKS5lYWNoKCBmdW5jdGlvbigpIHsKCQkJCQkJCQlodG1sICs9ICI8b3B0aW9uIGxpc3RJdGVtPScxJyB2YWx1ZT0nIiArIG9wdGlvbnMudmFsdWUoIHRoaXMgKSArICInPiIgKyBvcHRpb25zLm5hbWUoIHRoaXMgKSArICI8L29wdGlvbj4iOwoJCQkJCQkJfSApOwoJCQkJCQkJcmV0dXJuIGh0bWw7CgkJCQkJCX0gKS52YWwoIHZhbHVlICk7CgoJCQkJCWlmIChzdWJzY3JpYmVyLnZhbCgpICE9PSB2YWx1ZSkgewoJCQkJCQkkKCBzdWJzY3JpYmVyLnRyaWdnZXIoICJjaGFuZ2UiICkgKTsKCQkJCQl9CgkJCQl9LAoKCQkJCWluaXRpYWxpemU6IGZ1bmN0aW9uKCBwdWJsaXNoZXIsIHN1YnNjcmliZXIsIHdvcmtmbG93LCBvcHRpb25zICkgewoJCQkJCWlmIChvcHRpb25zKSB7CgoJCQkJCQl2YXIgcGFydHMgPSBvcHRpb25zLnNwbGl0KCAiLCIgKSwKCQkJCQkJCXRleHRDb2x1bW4gPSBwYXJ0c1swXSwKCQkJCQkJCXZhbHVlQ29sdW1uID0gcGFydHNbMV0gfHwgcGFydHNbMF07CgoJCQkJCQl3b3JrZmxvdy5vcHRpb25zID0gewoJCQkJCQkJbmFtZTogZnVuY3Rpb24oIGl0ZW0gKSB7CgkJCQkJCQkJcmV0dXJuIGl0ZW1bdGV4dENvbHVtbl07CgkJCQkJCQl9LAoJCQkJCQkJdmFsdWU6IGZ1bmN0aW9uKCBpdGVtICkgewoJCQkJCQkJCXJldHVybiBpdGVtW3ZhbHVlQ29sdW1uXTsKCQkJCQkJCX0KCQkJCQkJfTsKCgkJCQkJfSBlbHNlIHsKCgkJCQkJCXdvcmtmbG93Lm9wdGlvbnMgPSB7CgkJCQkJCQluYW1lOiBmdW5jdGlvbiggaXRlbSApIHsKCQkJCQkJCQlyZXR1cm4gaXRlbS50b1N0cmluZygpOwoJCQkJCQkJfSwKCQkJCQkJCXZhbHVlOiBmdW5jdGlvbiggaXRlbSApIHsKCQkJCQkJCQlyZXR1cm4gaXRlbS50b1N0cmluZygpOwoJCQkJCQkJfQoJCQkJCQl9OwoJCQkJCX0KCQkJCX0KCQkJfQoJCV0sCgoJCXNob3c6IFsKCgkJCS8vZGF0YS1zdWI9ImBzaG93OnBhdGgiCgkJCSIhaW5pdCBhZnRlcio6Lnwqc2hvdyIsCgoJCQl7CgoJCQkJZ2V0OiAiKmNvbXBhcmVUcnV0aHkiLAoKCQkJCXNldDogZnVuY3Rpb24oIHRydXRoeSApIHsKCgkJCQkJdGhpc1t0cnV0aHkgPyAic2hvdyIgOiAiaGlkZSJdKCk7CgoJCQkJfQoJCQl9CgoJCV0sCgoJCWhpZGU6IFsKCgkJCSIhaW5pdCBhZnRlcio6LnwqaGlkZSIsCgoJCQl7CgkJCQlnZXQ6ICIqY29tcGFyZVRydXRoeSIsCgoJCQkJLy91c2Ugc3Vic2NyaXB0aW9uIGdyb3VwIGluc3RlYWQKCQkJCXNldDogZnVuY3Rpb24oIHRydXRoeSApIHsKCgkJCQkJdGhpc1sgdHJ1dGh5ID8gImhpZGUiIDogInNob3ciXSgpOwoJCQkJfQoJCQl9CgkJXSwKCgkJZW5hYmxlOiBbCgoJCQkiIWluaXQgYWZ0ZXIqOi58KmVuYWJsZSIsCgoJCQl7CgkJCQlnZXQ6ICIqY29tcGFyZVRydXRoeSIsCgoJCQkJc2V0OiBmdW5jdGlvbiggdHJ1dGh5ICkgewoKCQkJCQl0aGlzLmF0dHIoICJkaXNhYmxlZCIsICF0cnV0aHkgKTsKCQkJCX0KCQkJfQoJCV0sCgoJCWRpc2FibGU6IFsKCgkJCSIhaW5pdCBhZnRlcio6LnwqZGlzYWJsZSIsCgkJCXsKCQkJCWdldDogIipjb21wYXJlVHJ1dGh5IiwKCgkJCQlzZXQ6IGZ1bmN0aW9uKCB0cnV0aHkgKSB7CgkJCQkJdGhpcy5hdHRyKCAiZGlzYWJsZWQiLCB0cnV0aHkgKTsKCQkJCX0KCQkJfQoJCV0sCgoJCWFkZENsYXNzOiBbCgoJCQkiIWluaXQgYWZ0ZXIqOi58KmFkZENsYXNzIiwKCQkJewoKCQkJCWluaXRpYWxpemU6ICIqZXh0cmFjdENsYXNzIiwKCgkJCQlnZXQ6ICIqY29tcGFyZVRydXRoeSIsCgoJCQkJc2V0OiBmdW5jdGlvbiggdHJ1dGh5LCBlICkgewoKCQkJCQl0aGlzW3RydXRoeSA/ICJhZGRDbGFzcyIgOiAicmVtb3ZlQ2xhc3MiXSggZS5oYW5kbGVyLmNsYXNzTmFtZSApOwoJCQkJfQoJCQl9CgkJXSwKCgkJcmVtb3ZlQ2xhc3M6IFsKCgkJCSIhaW5pdCBhZnRlcio6LnwqcmVtb3ZlQ2xhc3MiLCB7CgoJCQkJaW5pdGlhbGl6ZTogIipleHRyYWN0Q2xhc3MiLAoKCQkJCWdldDogIipjb21wYXJlVHJ1dGh5IiwKCgkJCQlzZXQ6IGZ1bmN0aW9uKCB0cnV0aHksIGUgKSB7CgoJCQkJCXRoaXNbdHJ1dGh5ID8gInJlbW92ZUNsYXNzIiA6ICJhZGRDbGFzcyJdKCBlLmhhbmRsZXIuY2xhc3NOYW1lICk7CgoJCQkJfQoJCQl9CgkJXSwKCiAgICAgICAgLy90aGUgY2xhc3MgbmFtZSBjYW4gYmUgcGFzc2VkIGFzIG9wdGlvbnMgcGFyYW1ldGVyCiAgICAgICAgLy9vciB0aGUgY2xhc3MgbmFtZSBpcyB0aGUgdmFsdWUgb2YgdGhlIG1vZGVsCiAgICAgICAgLy8KICAgICAgICAvL3RvZ2dsZS1jbGFzcz0ibW9kZWwiCiAgICAgICAgLy9vcgogICAgICAgIC8vPHAgIWFmdGVyVXBkYXRlPSJpc0hhcHB5fCpmYWtlR2V0IHRvZ2dsZUNsYXNzKmhhcHB5IiA+PC9wPgoJCXRvZ2dsZUNsYXNzOiBbCgoJCQkiIWluaXQgYWZ0ZXIqOi58KnRvZ2dsZUNsYXNzIiwgewoKCQkJCWdldDogZnVuY3Rpb24oIGUgKSB7CgkJCQkJdmFyIG1ldGhvZCwKCQkJCQkJcmV2ZXJzZSwKCQkJCQkJdmFsdWUgPSBlLnB1Ymxpc2hlci5nZXQoKSwKCQkJCQkJY2xhc3NOYW1lID0gZS5oYW5kbGVyLm9wdGlvbnM7CgoJCQkJCWlmIChjbGFzc05hbWUpIHsKCQkJCQkJaWYgKGNsYXNzTmFtZS5zdGFydHNXaXRoKCAiISIgKSkgewoJCQkJCQkJcmV2ZXJzZSA9IHRydWU7CgkJCQkJCQljbGFzc05hbWUgPSBjbGFzc05hbWUuc3Vic3RyKCAxICk7CgkJCQkJCX0KCgkJCQkJCW1ldGhvZCA9IHZhbHVlIF4gcmV2ZXJzZSA/ICJhZGRDbGFzcyIgOiAicmVtb3ZlQ2xhc3MiOwoJCQkJCX0KCgkJCQkJaWYgKGUudHlwZSA9PSAiaW5pdCIpIHsKCgkJCQkJCWlmIChjbGFzc05hbWUpIHsKCgkJCQkJCQl0aGlzW21ldGhvZF0oIGNsYXNzTmFtZSApOwoKCQkJCQkJfSBlbHNlIHsKCgkJCQkJCQl0aGlzLmFkZENsYXNzKCB2YWx1ZSApOwoJCQkJCQl9CgoJCQkJCX0gZWxzZSB7CgkJCQkJCWlmIChjbGFzc05hbWUpIHsKCgkJCQkJCQl0aGlzW21ldGhvZF0oIGNsYXNzTmFtZSApOwoKCQkJCQkJfSBlbHNlIHsKCgkJCQkJCQl0aGlzLnJlbW92ZUNsYXNzKCBlLnJlbW92ZWQgKS5hZGRDbGFzcyggdmFsdWUgKTsKCgkJCQkJCX0KCQkJCQl9CgkJCQl9CgkJCX0KCQldLAoKCQkvL2ZvY3VzOippc0VkaXRNb2RlCgkJLy9mb2N1cyBvbiBhIHZpZXcgaWYgbW9kZWwgaXMgbm90IGVtcHR5CgkJZm9jdXM6IFsKCQkJIiFpbml0IGFmdGVyKjoufCpmb2N1cyIsCgkJCXsKCQkJCWdldDogIipjb21wYXJlVHJ1dGh5IiwKCgkJCQlzZXQ6IGZ1bmN0aW9uKCB0cnV0aHksIGUgKSB7CgoJCQkJCWlmICh0cnV0aHkpIHsKCQkJCQkJdmFyIHN1YnNjcmliZXIgPSB0aGlzOwoJCQkJCQlzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJCQkJCXN1YnNjcmliZXIuZm9jdXMoKS5zZWxlY3QoKTsKCQkJCQkJfSwgMSApOwoJCQkJCX0KCQkJCX0KCQkJfQoJCV0sCgoJCWNvdW50OiBbCgoJCQkiIWluaXQgYWZ0ZXIqOi58KmNvdW50IiwKCgkJCWZ1bmN0aW9uKCBlICkgewoJCQkJdmFyIHZhbHVlID0gZS5wdWJsaXNoZXIuZ2V0KCksCgkJCQkJY291bnQgPSAoICJsZW5ndGgiIGluIHZhbHVlKSA/IHZhbHVlLmxlbmd0aCA6IHZhbHVlOwoKCQkJCXRoaXMudGV4dCggY291bnQgKTsKCQkJfQoJCV0sCgoJCWR1bXA6IFsKCgkJCSIhaW5pdCAqOi58KmR1bXAiLAoKCQkJZnVuY3Rpb24oIGUgKSB7CgkJCQlpZiAoIWUudHlwZS5zdGFydHNXaXRoKCAiYmVmb3JlIiApKSB7CgkJCQkJdGhpcy5odG1sKCAiPHNwYW4gc3R5bGU9J2NvbG9yOnJlZCc+IiArIGUucHVibGlzaGVyLnBhdGggKyAiIDogIiArIGUucHVibGlzaGVyLnRvSlNPTigpICsgIjwvc3Bhbj4iICk7CgkJCQl9CgkJCX0KCQldLAoKCQkvL2FsZXJ0OnBhdGggLy90aGlzIHdpbGwgYWxlcnQgdGhlIGRhdGEgaW4gbW9kZWwKCQkvL2FsZXJ0Ol98aGVsbG8gd29ybGQgLy90aGlzIHdpbGwgYWxlcnQgImhlbGxvIHdvcmxkIgoJCWFsZXJ0OiBbCgoJCQkiJGNsaWNrOi58KmFsZXJ0IiwKCgkJCWZ1bmN0aW9uKCBlICkgewoJCQkJYWxlcnQoIGlzVW5kZWZpbmVkKCBlLmhhbmRsZXIub3B0aW9ucyApID8gdGhpcy5nZXQoKSA6IGUuaGFuZGxlci5vcHRpb25zICk7CgkJCX0KCgkJXSwKCgkJbG9nOiBbCgoJCQkiJGNsaWNrOi58KmxvZyIsCgoJCQlmdW5jdGlvbiAoZSkgewoJCQkJaG0ubG9nKCBpc1VuZGVmaW5lZCggZS5oYW5kbGVyLm9wdGlvbnMgKSA/IHRoaXMuZ2V0KCkgOiBlLmhhbmRsZXIub3B0aW9ucyApOwoJCQl9CgkJXSwKCQlwcmV2ZW50RGVmYXVsdDogWwoKCQkJIiRjbGljazpffCpwcmV2ZW50RGVmYXVsdCIsCgoJCQlmdW5jdGlvbiggZSApIHsKCQkJCWUucHJldmVudERlZmF1bHQoKTsKCQkJfQoJCV0sCgoJCXN0b3BQcm9wYWdhdGlvbjogWwoKCQkJIiRjbGljazpffCpzdG9wUHJvcGFnYXRpb24iLAoKCQkJZnVuY3Rpb24oIGUgKSB7CgkJCQllLnN0b3BQcm9wYWdhdGlvbigpOwoJCQl9CgkJXSwKCgkJLy9jb25maXJtOl8KCQkvL2NvbmZpcm06cGF0aAoJCS8vY29uZmlybTpffHlvdXIgbWVzc2FnZQoJCWNvbmZpcm06IFsKCgkJCS8vcmVwbGFjaW5nICIkY2xpY2s6LnwqY29uZmlybSIsIHdpdGggZHluYW1pYyBiaW5kaW5nLAoJCQkvL3NvIHRoYXQgaXQgY2FuIGJlIGZpeCB0aGUgcHJvYmxlbSBjYXVzZWQgYnkgbWFwRXZlbnQKCQkJLy9hcyBsb25nIGFzIGl0IGlzIHBsYWNlZCBiZWZvcmUgbWFwRXZlbnQgZHluYW1pYyBiaW5kaW5nCgkJCWZ1bmN0aW9uKCBlbGVtLCBwYXRoLCBiaW5kaW5nLCBvcHRpb25zICkgewoJCQkJaG0uc3ViKCBwYXRoLCBlbGVtLCAiY2xpY2siLCAiKmNvbmZpcm0iLCBvcHRpb25zICk7CgkJCX0sCgoJCQlmdW5jdGlvbiggZSApIHsKCgkJCQl2YXIgbWVzc2FnZSA9IGlzVW5kZWZpbmVkKCBlLmhhbmRsZXIub3B0aW9ucyApID8KCQkJCQl0aGlzICYmIHRoaXMucGF0aCAmJiB0aGlzLmdldCAmJiB0aGlzLmdldCgpIHx8IGRlZmF1bHRPcHRpb25zLmNvbmZpcm1NZXNzYWdlIDoKCQkJCQllLmhhbmRsZXIub3B0aW9uczsKCgkJCQlpZiAoIWNvbmZpcm0oIG1lc3NhZ2UgKSkgewoJCQkJCWUuc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uKCk7CgkJCQkJZS5wcmV2ZW50RGVmYXVsdCAmJiBlLnByZXZlbnREZWZhdWx0KCk7CgkJCQl9CgkJCX0KCQldLAoKCQkvLy8tLS0tLS1jaGFuZ2luZyBtb2RlbC0tLS0tLS0tLS0tLQoJCXNldFRvOiBbCgkJCSIkY2xpY2s6Lnwqc2V0VG8iLAoJCQl7CgkJCQlpbml0aWFsaXplOiBmdW5jdGlvbiggcHVibGlzaGVyLCBzdWJzY3JpYmVyLCB3b3JrZmxvd0luc3RhbmNlLCBvcHRpb25zICkgewoJCQkJCXdvcmtmbG93SW5zdGFuY2Uuc2V0VG8gPSB0b1R5cGVkVmFsdWUoIG9wdGlvbnMgKTsKCQkJCX0sCgkJCQlnZXQ6IGZ1bmN0aW9uKCBlICkgewoJCQkJCXRoaXMuc2V0KCBlLmhhbmRsZXIuc2V0VG8gKTsKCQkJCX0KCQkJfQoJCV0sCgoJCSIwIjogWwoJCQkiJGNsaWNrOi58KjAiLAoJCQlmdW5jdGlvbiggLyplKi8gKSB7CgkJCQl0aGlzLnNldCggMCApOwoJCQl9CgkJXSwKCgkJZW1wdHlTdHJpbmc6IFsKCQkJIiRjbGljazoufCplbXB0eSIsCgkJCWZ1bmN0aW9uKCAvKmUqLyApIHsKCQkJCXRoaXMuc2V0KCAiIiApOwoJCQl9CgkJXSwKCgkJIm51bGwiOiBbCgkJCSIkY2xpY2s6LnwqbnVsbCIsCgoJCQlmdW5jdGlvbiggLyplKi8gKSB7CgkJCQl0aGlzLnNldCggbnVsbCApOwoJCQl9CgkJXSwKCgkJInRydWUiOiBbCgoJCQkiJGNsaWNrOi58KnRydWUiLAoKCQkJZnVuY3Rpb24oIC8qZSovICkgewoJCQkJdGhpcy5zZXQoIHRydWUgKTsKCQkJfQoJCV0sCgoJCSIrKyI6IFsKCQkJIiRjbGljazoufCorKyIsCgoJCQlmdW5jdGlvbiggLyplKi8gKSB7CgkJCQl0aGlzLnNldCggdGhpcy5nZXQoKSArIDEgKTsKCQkJfQoJCV0sCgoJCSItLSI6IFsKCQkJIiRjbGljazoufCotLSIsCgkJCWZ1bmN0aW9uKCAvKmUqLyApIHsKCQkJCXRoaXMuc2V0KCB0aGlzLmdldCgpIC0gMSApOwoJCQl9CgkJXSwKCgkJImZhbHNlIjogWwoJCQkiJGNsaWNrOi58KmZhbHNlIiwKCQkJZnVuY3Rpb24oIC8qZSovICkgewoJCQkJdGhpcy5zZXQoIGZhbHNlICk7CgkJCX0KCQldLAoKCQl0b2dnbGU6IFsKCgkJCSIkY2xpY2s6LnwqdG9nZ2xlIiwKCQkJZnVuY3Rpb24oIC8qZSovICkgewoJCQkJdmFyIHN1YnNjcmliZXIgPSB0aGlzOwoJCQkJc3Vic2NyaWJlci5zZXQoICFzdWJzY3JpYmVyLmdldCgpICk7CgkJCX0KCQldLAoKCQlzb3J0SXRlbXM6IFsKCQkJIiRjbGljazoufCpzb3J0SXRlbXMiLAoJCQl7CgkJCQlpbml0aWFsaXplOiBmdW5jdGlvbiggcHVibGlzaGVyLCBzdWJzY3JpYmVyLCB3b3JrZmxvdywgb3B0aW9ucyApIHsKCQkJCQlvcHRpb25zID0gKG9wdGlvbnMgfHwgIiIpICYmIG9wdGlvbnMuc3BsaXQoICIsIiApOwoJCQkJCXdvcmtmbG93LmJ5ID0gb3B0aW9uc1swXTsKCQkJCQkvL2JlY2F1c2Ugb3B0aW9uc1sxXSBkZWZhdWx0IGlzIHVuZGVmaW5lZAoJCQkJCS8vc28gYXNjIGlzIGJ5IGRlZmF1bHQKCQkJCQl3b3JrZmxvdy5hc2MgPSAhIW9wdGlvbnNbMV07CgkJCQl9LAoJCQkJZ2V0OiBmdW5jdGlvbiggZSApIHsKCQkJCQl2YXIgd29ya2Zsb3cgPSBlLmhhbmRsZXI7CgkJCQkJdGhpcy5zb3J0KCB3b3JrZmxvdy5ieSwgd29ya2Zsb3cuYXNjICk7CgkJCQkJd29ya2Zsb3cuYXNjID0gIXdvcmtmbG93LmFzYzsKCQkJCX0KCQkJfQoJCV0sCgoJCWNsZWFyOiBbCgoJCQkiJGNsaWNrOi58KmNsZWFyIiwKCgkJCWZ1bmN0aW9uKCAvKmUqLyApIHsKCQkJCXRoaXMuY2xlYXIoKTsKCQkJfQoJCV0sCgoJCWRlbDogWwoJCQkiJGNsaWNrOi58KmRlbDtjb25maXJtOl98X0RvIHlvdSB3YW50IHRvIGRlbGV0ZSB0aGlzIGl0ZW0/IiwKCgkJCWZ1bmN0aW9uKCAvKmUqLyApIHsKCQkJCXRoaXMuZGVsKCk7CgkJCX0KCQldCgl9ICk7CgoJYmluZGluZ3MoIHsKCgkJY2FwdGlvbjogZnVuY3Rpb24oIGVsZW0sIHBhdGgsIGNvbnRleHQsIG9wdGlvbnMgKSB7CgoJCQkkKCBlbGVtICkucHJlcGVuZCggIjxvcHRpb24gdmFsdWU9Jyc+IiArIChvcHRpb25zIHx8IGhtLmdldCggcGF0aCApIHx8ICIiKSArICI8L29wdGlvbj4iICk7CgkJfSwKCgkJYXV0b2ZvY3VzOiBmdW5jdGlvbiggZWxlbSApIHsKCQkJc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQkkKCBlbGVtICkuZm9jdXMoKTsKCQkJfSwgMSApOwoJCX0sCgoJCW1hcEV2ZW50OiBmdW5jdGlvbiggZWxlbSwgcGF0aCwgY29udGV4dCwgb3B0aW9ucyApIHsKCQkJb3B0aW9ucyA9IG9wdGlvbnMuc3BsaXQoICIsIiApOwoJCQkkKCBlbGVtICkubWFwRXZlbnQoIG9wdGlvbnNbMF0sIG9wdGlvbnNbMV0sIG9wdGlvbnNbMl0gKTsKCgkJfSwKCgkJbWFwQ2xpY2s6IGZ1bmN0aW9uKCBlbGVtLCBwYXRoLCBjb250ZXh0LCBvcHRpb25zICkgewoJCQlvcHRpb25zID0gb3B0aW9ucy5zcGxpdCggIiwiICk7CgkJCSQoIGVsZW0gKS5tYXBFdmVudCggImNsaWNrIiwgb3B0aW9uc1swXSwgb3B0aW9uc1sxXSApOwoJCX0sCgoJCWxvZ1BhbmVsOiBmdW5jdGlvbiggZWxlbSwgcGF0aCwgY29udGV4dCwgb3B0aW9ucyApIHsKCgkJCSQoIGVsZW0gKS5jc3MoICJsaXN0LXN0eWxlLXR5cGUiLCAiZGVjaW1hbCIgKS5jc3MoICJmb250LWZhbWlseSIsICJtb25vc3BhY2UsIHNlcmlmIiApOwoKCQkJY29udGV4dC5hcHBlbmRTdWIoIGVsZW0sICIqbG9nIiwgImluaXQiLCBmdW5jdGlvbiggZSApIHsKCQkJCXZhciBhbGxMb2dzID0gZS5wdWJsaXNoZXIuZ2V0KCk7CgkJCQlmb3IgKHZhciBpID0gMDsgaSA8IGFsbExvZ3MubGVuZ3RoOyBpKyspIHsKCQkJCQl0aGlzLmFwcGVuZCggIjxsaT4iICsgYWxsTG9nc1tpXSArICI8L2xpPiIgKTsKCQkJCX0KCQkJfSApOwoKCQkJY29udGV4dC5hcHBlbmRTdWIoIGVsZW0sICIqbG9nIiwgImFmdGVyQ3JlYXRlLjEiLCBmdW5jdGlvbiggZSApIHsKCQkJCXRoaXMuYXBwZW5kKCAiPGxpPiIgKyBlLm9yaWdpbmFsUHVibGlzaGVyLnJhdygpICsgIjwvbGk+IiApOwoJCQl9ICk7CgoJCQljb250ZXh0LmFwcGVuZFN1YiggZWxlbSwgIipsb2ciLCAiYWZ0ZXJDcmVhdGUiLCBmdW5jdGlvbiggZSApIHsKCQkJCXRoaXMuZW1wdHkoKTsKCQkJfSApOwoJCX0sCgoJCWNsZWFybG9nOiAiY2xlYXI6Lypsb2ciLAoKCQkvL2RhdGEtc3ViPSJlbmFibGVMYXRlcjpwYXRoIgoJCWVuYWJsZUxhdGVyOiAiIWFmdGVyKjoufCplbmFibGUiLAoKCQkvL2RhdGEtc3ViPSJkaXNhYmxlTGF0ZXI6cGF0aCIKCQlkaXNhYmxlTGF0ZXI6ICIhYWZ0ZXIqOi58KmRpc2FibGUiLAoKCQkvL2RhdGEtc3ViPSJodG1sOnBhdGgiCgkJaHRtbDogIiFpbml0IGFmdGVyKjoufGdldCBodG1sICp0b1N0cmluZyIsCgoJCS8vZGF0YS1zdWI9InRleHQ6cGF0aCIKCQl0ZXh0OiAiIWluaXQgYWZ0ZXIqOi58Z2V0IHRleHQgKnRvU3RyaW5nIiwKCgkJcmVtb3ZlSWZEZWw6ICIhZHVyaW5nRGVsOi58KmZha2VHZXQgcmVtb3ZlIiwKCgkJZW1wdHlJZkRlbDogIiFkdXJpbmdEZWw6LnwqZmFrZUdldCBlbXB0eSIKCgl9ICk7CgoJaG0ubmV3SnFFdmVudCggewoKCQllbnRlcjogWyJrZXl1cCIsIGZ1bmN0aW9uKCBlICkgewoJCQlyZXR1cm4gKGUua2V5Q29kZSA9PT0gMTMpOwoJCX1dLAoKCQllc2M6IFsia2V5dXAiLCBmdW5jdGlvbiggZSApIHsKCQkJcmV0dXJuIChlLmtleUNvZGUgPT09IDI3KTsKCQl9XSwKCgkJY3RybGNsaWNrOiBbImNsaWNrIiwgZnVuY3Rpb24oIGUgKSB7CgkJCXJldHVybiBlLmN0cmxLZXk7CgkJfV0KCX0gKTsKCgoKLy8KLyoKIDxAZGVwZW5kcz4KIHN1YnNjcmlwdGlvbi5qcywKIG1vZGVsLmpzCiA8L0BkZXBlbmRzPgogKi8KCgoJdmFyIG1ldGhvZE1hcCA9IHsKCQkiY3JlYXRlIjogIlBPU1QiLAoJCSJ1cGRhdGUiOiAiUFVUIiwKCQkiZGVzdHJveSI6ICJERUxFVEUiLAoJCSJmZXRjaCI6ICJHRVQiCgl9OwoKCXZhciBlbnRpdHlTdGF0ZSA9IHsKCQlkZXRhY2hlZDogMCwKCQl1bmNoYW5nZWQ6IDEsCgkJYWRkZWQ6IDMsCgkJZGVsZXRlZDogNCwKCQltb2RpZmllZDogNQoJfTsKCglmdW5jdGlvbiBtYXJrTW9kaWZpZWQgKCBlICkgewoKCQl2YXIgYmFzZVBhdGggPSB0aGlzLnBhdGg7IC8vaXRlbXMKCQl2YXIgb3JpZ2luYWxQYXRoID0gZS5vcmlnaW5hbFB1Ymxpc2hlci5wYXRoOyAvL2l0ZW1zLjEuZmlyc3ROYW1lCgkJdmFyIGRpZmZQYXRoID0gb3JpZ2luYWxQYXRoLnN1YnN0ciggYmFzZVBhdGgubGVuZ3RoICsgMSApOyAvLzEuZmlyc3ROYW1lCgkJdmFyIGRvdEluZGV4ID0gZGlmZlBhdGguaW5kZXhPZiggIi4iICk7CgkJdmFyIGVudGl0eVBhdGggPSBiYXNlUGF0aCArICIuIiArIGRpZmZQYXRoLnN1YnN0ciggMCwgZG90SW5kZXggKTsgLy9pdGVtcy4xCgkJdmFyIHN0YXRlUGF0aCA9IGVudGl0eVBhdGggKyAiLl9fc3RhdGUiOyAvL2l0ZW1zLjEuX19zdGF0ZQoKCQlpZiAob3JpZ2luYWxQYXRoICE9PSBzdGF0ZVBhdGggJiYKCQkgICAgaG0uZ2V0KCBzdGF0ZVBhdGggKSA9PSBlbnRpdHlTdGF0ZS51bmNoYW5nZWQpIHsKCQkJLy91c2Ugc2V0IG1ldGhvZCBpcyBkZWxpYmVyYXRlLCBiZWNhdXNlIHdlIHdhbnQKCQkJLy90byByYWlzZSBldmVudAoJCQlobS5zZXQoIHN0YXRlUGF0aCwgZW50aXR5U3RhdGUubW9kaWZpZWQgKTsKCQl9Cgl9CgoJaG0ub25BZGRPclVwZGF0ZU5vZGUoIGZ1bmN0aW9uKCBjb250ZXh0LCBpbmRleCwgdmFsdWUgKSB7CgkJaWYgKHZhbHVlIGluc3RhbmNlb2YgaG0uRW50aXR5KSB7CgoJCQlpZiAodmFsdWUuX19zdGF0ZSA9PT0gZW50aXR5U3RhdGUuZGV0YWNoZWQpIHsKCQkJCXZhbHVlLl9fc3RhdGUgPSBlbnRpdHlTdGF0ZS5hZGRlZDsKCQkJfQoKCQkJaWYgKGlzVW5kZWZpbmVkKCBobSggY29udGV4dCApLmdldCggIl9fZW50aXR5Q29udGFpbmVyIiApICkpIHsKCQkJCWhtLnN1YiggY29udGV4dCwgY29udGV4dCwgImFmdGVyVXBkYXRlLioiLCBtYXJrTW9kaWZpZWQgKTsKCQkJCWhtKCBjb250ZXh0ICkuc2V0KCAiX19lbnRpdHlDb250YWluZXIiLCB0cnVlICk7CgkJCX0KCQl9Cgl9ICk7CgoJZnVuY3Rpb24gY2FsbFN0YXRpY0FqYXhNZXRob2QgKCBub2RlLCBtZXRob2ROYW1lICkgewoJCXZhciBlbnRpdHkgPSBub2RlLmdldCgpOwoKCQlyZXR1cm4gZW50aXR5LmNvbnN0cnVjdG9yW21ldGhvZE5hbWVdKCBlbnRpdHkgKS5kb25lKCBmdW5jdGlvbiggZGF0YSApIHsKCgkJCW5vZGUuc2V0KAoKCQkJCSJfX3N0YXRlIiwKCgkJCQltZXRob2ROYW1lID09ICJkZXN0cm95IiA/CgkJCQkJZW50aXR5U3RhdGUuZGV0YWNoZWQgOgoJCQkJCWVudGl0eVN0YXRlLnVuY2hhbmdlZAoJCQkpOwoKCQkJbm9kZS50cmlnZ2VyKCAiYWZ0ZXJTeW5jLiIgKyBtZXRob2ROYW1lICk7CgkJfSApOwoJfQoKCS8vdGhlIHJlYXNvbiB0aGF0IHdlIGRvbid0IGltcGxlbWVudCBhamF4IGluIHRoZSBpbnN0YW5jZSBtZXRob2QgaXMgdGhhdCwgd2Ugd2FudCB0bwoJLy9zdXBwb3J0IHRoZSBjYWxsIGZyb20gcmVwb3NpdG9yeSBub2RlLCBzdWNoIG5vZGUuc2V0KCJjcmVhdGUiKSwgbm9kZS5zZXQoInVwZGF0ZSIpLi4KCS8vd2Ugd2FudCB0byBkZWxlZ2F0ZSB0aGlzIGNhbGwgdGhlIHN0YXRpYyBtZXRob2QKCWhtLkVudGl0eSA9IGhtLkNsYXNzLmV4dGVuZCgKCQkvL2luc3RhbmNlIG1ldGhvZCwgd2hpY2ggaXMgaW52b2tlZCBieSBub2RlLmdldCBtZXRob2QKCQkvL29yIGl0IGNhbiBiZSBpbnZva2VkIHRoZSBvYmplY3QgZGlyZWN0bHkKCQl7CgkJCS8vdGhpcyBzdGF0ZSBpcyBtZWFuaW5nZnVsIG9ubHkgd2hlbiBpdCBlbnRpdHkgaXMgaW5zaWRlIG9mIHJlcG9zaXRvcnkKCQkJX19zdGF0ZTogZW50aXR5U3RhdGUuZGV0YWNoZWQsCgoJCQljcmVhdGU6IGZ1bmN0aW9uIF9fICgpIHsKCQkJCWlmICh0aGlzIGluc3RhbmNlb2YgaG0pIHsKCQkJCQlpZiAodGhpcy5nZXQoICJfX3N0YXRlIiApID09IGVudGl0eVN0YXRlLmFkZGVkKSB7CgkJCQkJCXJldHVybiBjYWxsU3RhdGljQWpheE1ldGhvZCggdGhpcywgImNyZWF0ZSIgKTsKCQkJCQl9CgkJCQkJdGhyb3cgImVudGl0eSBpcyBub3QgYSBuZXcgaXRlbSI7CgoJCQkJfSBlbHNlIHsKCQkJCQkvLyBkb24ndCB1c2UgRW50aXR5LmNyZWF0ZSh0aGlzKSwgYmVjYXVzZQoJCQkJCS8vIHRoaXMuY29uc3RydWN0b3IgaXMgbm90IG5lY2Vzc2FyeSBFbnRpdHkKCQkJCQlyZXR1cm4gdGhpcy5jb25zdHJ1Y3Rvci5jcmVhdGUoIHRoaXMgKTsKCgkJCQl9CgkJCX0sCgoJCQlmZXRjaDogZnVuY3Rpb24gX18gKCkgewoJCQkJcmV0dXJuIHRoaXMgaW5zdGFuY2VvZiBobSA/IGNhbGxTdGF0aWNBamF4TWV0aG9kKCB0aGlzLCAiZmV0Y2giICkgOgoJCQkJCXRoaXMuY29uc3RydWN0b3IuZmV0Y2goIHRoaXMgKTsKCQkJfSwKCgkJCXVwZGF0ZTogZnVuY3Rpb24gX18gKCkgewoKCQkJCWlmICh0aGlzIGluc3RhbmNlb2YgaG0pIHsKCQkJCQlpZiAodGhpcy5nZXQoICJfX3N0YXRlIiApID09IGVudGl0eVN0YXRlLm1vZGlmaWVkKSB7CgkJCQkJCXJldHVybiBjYWxsU3RhdGljQWpheE1ldGhvZCggdGhpcywgInVwZGF0ZSIgKTsKCQkJCQl9CgkJCQl9IGVsc2UgewoJCQkJCXJldHVybiB0aGlzLmNvbnN0cnVjdG9yLnVwZGF0ZSggdGhpcyApOwoJCQkJfQoJCQl9LAoKCQkJZGVzdHJveTogZnVuY3Rpb24gX18gKCkgewoJCQkJaWYgKHRoaXMgaW5zdGFuY2VvZiBobSkgewoJCQkJCXZhciBub2RlID0gdGhpczsKCQkJCQlyZXR1cm4gY2FsbFN0YXRpY0FqYXhNZXRob2QoIHRoaXMsICJkZXN0cm95IiApLmRvbmUoIGZ1bmN0aW9uKCkgewoJCQkJCQlub2RlLmRlbCgpOwoJCQkJCX0gKTsKCQkJCX0gZWxzZSB7CgkJCQkJcmV0dXJuIHRoaXMuY29uc3RydWN0b3IuZGVzdHJveSggdGhpcyApOwoJCQkJfQoJCQl9LAoKCQkJc2F2ZTogZnVuY3Rpb24gX18gKCkgewoJCQkJaWYgKHRoaXMgaW5zdGFuY2VvZiBobSkgewoKCQkJCQl2YXIgc3RhdGUgPSB0aGlzLmdldCggIl9fc3RhdGUiICk7CgkJCQkJaWYgKHN0YXRlID09IGVudGl0eVN0YXRlLmFkZGVkKSB7CgoJCQkJCQlyZXR1cm4gdGhpcy5nZXQoICJjcmVhdGUiICk7CgoJCQkJCX0gZWxzZSBpZiAoc3RhdGUgPT0gZW50aXR5U3RhdGUubW9kaWZpZWQpIHsKCgkJCQkJCXJldHVybiB0aGlzLmdldCggInVwZGF0ZSIgKTsKCQkJCQl9CgoJCQkJfSBlbHNlIHsKCgkJCQkJdGhyb3cgIm5vdCBzdXBwb3J0ZWQiOwoJCQkJfQoKCQkJfQoKCQl9LAoKCQkvL3N0YXRpYyBtZXRob2QsIHdoaWNoIGtub3dzIG5vdGhpbmcgYWJvdXQgcmVwb3NpdG9yeQoJCXsKCQkJc3RhdGU6IGVudGl0eVN0YXRlLAoKCQkJY3JlYXRlOiBmdW5jdGlvbiggaW5zdGFuY2UgKSB7CgkJCQlyZXR1cm4gdGhpcy5hamF4KCAiY3JlYXRlIiwgaW5zdGFuY2UgKTsKCQkJfSwKCgkJCXVwZGF0ZTogZnVuY3Rpb24oIGluc3RhbmNlICkgewoJCQkJcmV0dXJuIHRoaXMuYWpheCggInVwZGF0ZSIsIGluc3RhbmNlICk7CgkJCX0sCgkJCWRlc3Ryb3k6IGZ1bmN0aW9uKCBpbnN0YW5jZSApIHsKCQkJCXJldHVybiB0aGlzLmFqYXgoICJkZXN0cm95IiwgaW5zdGFuY2UgKTsKCQkJfSwKCgkJCWZldGNoOiBmdW5jdGlvbiggaW5zdGFuY2UgKSB7CgkJCQlpZiAoaW5zdGFuY2UpIHsKCQkJCQlyZXR1cm4gdGhpcy5hamF4KCAiZmV0Y2giLCBpbnN0YW5jZSApOwoJCQkJfSBlbHNlIHsKCQkJCQl2YXIgQ29uc3RydWN0b3IgPSB0aGlzOwoJCQkJCS8vdGhlIHBpcGUgbWV0aG9kIGlzIHVzZWQgdG8gY29udmVydCBhbiBhcnJheSBvZgoJCQkJCS8vIGdlbmVyaWMgb2JqZWN0IGludG8gYW4gYXJyYXkgb2Ygb2JqZWN0IG9mIHRoZSBzYW1lICJDbGFzcyIKCQkJCQlyZXR1cm4gdGhpcy5hamF4KCAiZmV0Y2giICkucGlwZSggZnVuY3Rpb24oIGRhdGEgKSB7CgkJCQkJCXJldHVybiAkKCBDb25zdHJ1Y3Rvci5saXN0KCBkYXRhICkgKS5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJCQkJdGhpcy5fX3N0YXRlID0gZW50aXR5U3RhdGUudW5jaGFuZ2VkOwoJCQkJCQl9ICkuZ2V0KCk7CgkJCQkJfSApOwoKCQkJCX0KCQkJfSwKCgkJCWdldFVybDogZnVuY3Rpb24oIG1ldGhvZE5hbWUsIGluc3RhbmNlICkgewoJCQkJdmFyIGJhc2VVcmwgPSB0aGlzLnVybCB8fCBpbnN0YW5jZS51cmwsCgkJCQkJaWQgPSBpbnN0YW5jZSAmJiBpbnN0YW5jZS5pZDsKCgkJCQlyZXR1cm4gaWQgPyBiYXNlVXJsICsgKGJhc2VVcmwuY2hhckF0KCBiYXNlVXJsLmxlbmd0aCAtIDEgKSA9PT0gJy8nID8gJycgOiAnLycpICsgZW5jb2RlVVJJQ29tcG9uZW50KCBpZCApIDoKCQkJCQliYXNlVXJsOwoJCQl9LAoKCQkJYWpheDogZnVuY3Rpb24oIG1ldGhvZE5hbWUsIGluc3RhbmNlICkgewoJCQkJdmFyIG1ldGhvZCA9IG1ldGhvZE1hcFttZXRob2ROYW1lXTsKCgkJCQl2YXIgYWpheE9wdGlvbnMgPSB7CgkJCQkJdHlwZTogbWV0aG9kLAoJCQkJCWRhdGFUeXBlOiAnanNvbicsCgkJCQkJdXJsOiB0aGlzLmdldFVybCggbWV0aG9kTmFtZSwgaW5zdGFuY2UgKSwKCQkJCQljb250ZW50VHlwZTogbWV0aG9kID09ICJHRVQiID8gbnVsbCA6ICJhcHBsaWNhdGlvbi9qc29uIiwKCQkJCQlwcm9jZXNzRGF0YTogZmFsc2UsCgkJCQkJZGF0YTogbWV0aG9kID09ICJHRVQiID8gbnVsbCA6IEpTT04uc3RyaW5naWZ5KCBpbnN0YW5jZSApCgkJCQl9OwoKCQkJCXJldHVybiAkLmFqYXgoIGFqYXhPcHRpb25zICkuZG9uZSggZnVuY3Rpb24oIHJlc3BvbnNlICkgewoJCQkJCWluc3RhbmNlICYmIGV4dGVuZCggaW5zdGFuY2UsIHJlc3BvbnNlICk7CgkJCQl9ICk7CgkJCX0KCQl9ICk7CgoJZXh0ZW5kKCBobUZuLCB7CgoJCS8vbm9kZSBmdW5jdGlvbiB3aGljaCBicmlkZ2V0IHRoZSBobSBtZXRob2QgdG8gdGhlIHN0YXRpYyBtZXRob2Qgb2YgbW9kZWwKCQkvL3N1YlBhdGggaXMgb3B0aW9uYWwKCQkvL21ldGhvZCBpcyByZXF1aXJlZCBjcmVhdGUvcmVhZC91cGRhdGUvZGVsCgkJLy9lLmcgbm9kZS5zeW5jKCJjcmVhdGUiKTsKCQlzYXZlOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHRoaXMuZ2V0KCAic2F2ZSIgKTsKCQl9LAoKCQlkZXN0cm95OiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHRoaXMuZ2V0KCAiZGVzdHJveSIgKTsKCQl9LAoKCQlmZXRjaDogZnVuY3Rpb24oKSB7CgkJCXJldHVybiB0aGlzLmdldCggImZldGNoIiApOwoJCX0KCX0gKTsKCi8vCi8vPEBkZXBlbmRzPnN1YnNjcmlwdGlvbi5qcywgbW9kZWwuanMsIGRlY2xhcmF0aXZlLmpzLCB0ZW1wbGF0ZS5qczwvQGRlcGVuZHM+CgoKCWRlZmF1bHRPcHRpb25zLmVycm9ycyA9IHsKCQlkZWZhdWx0RXJyb3I6ICJQbGVhc2UgZW50ZXIgYSB2YWxpZCB2YWx1ZSIKCX07CgoJdmFyIGFmdGVyVXBkYXRlQW5kQ2hlY2tWYWxpZGl0eSA9ICJhZnRlclVwZGF0ZSogY2hlY2tWYWxpZGl0eSIsCgkJaW52YWxpZFBhdGhzID0gc2hhZG93Um9vdC5pbnZhbGlkUGF0aHMgPSBbXSwKCQlpbnZhbGlkUGF0aHNNb2RlbCA9IGhtKCAiKmludmFsaWRQYXRocyIgKSwKCQlyRW1wdHkgPSAvXlxzKiQvLAoJCXJFbWFpbCA9IC9eKCgoW2Etel18XGR8WyEjXCQlJidcKlwrXC1cLz1cP1xeX2B7XHx9fl18W1x1MDBBMC1cdUQ3RkZcdUY5MDAtXHVGRENGXHVGREYwLVx1RkZFRl0pKyhcLihbYS16XXxcZHxbISNcJCUmJ1wqXCtcLVwvPVw/XF5fYHtcfH1+XXxbXHUwMEEwLVx1RDdGRlx1RjkwMC1cdUZEQ0ZcdUZERjAtXHVGRkVGXSkrKSopfCgoXHgyMikoKCgoXHgyMHxceDA5KSooXHgwZFx4MGEpKT8oXHgyMHxceDA5KSspPygoW1x4MDEtXHgwOFx4MGJceDBjXHgwZS1ceDFmXHg3Zl18XHgyMXxbXHgyMy1ceDViXXxbXHg1ZC1ceDdlXXxbXHUwMEEwLVx1RDdGRlx1RjkwMC1cdUZEQ0ZcdUZERjAtXHVGRkVGXSl8KFxcKFtceDAxLVx4MDlceDBiXHgwY1x4MGQtXHg3Zl18W1x1MDBBMC1cdUQ3RkZcdUY5MDAtXHVGRENGXHVGREYwLVx1RkZFRl0pKSkpKigoKFx4MjB8XHgwOSkqKFx4MGRceDBhKSk/KFx4MjB8XHgwOSkrKT8oXHgyMikpKUAoKChbYS16XXxcZHxbXHUwMEEwLVx1RDdGRlx1RjkwMC1cdUZEQ0ZcdUZERjAtXHVGRkVGXSl8KChbYS16XXxcZHxbXHUwMEEwLVx1RDdGRlx1RjkwMC1cdUZEQ0ZcdUZERjAtXHVGRkVGXSkoW2Etel18XGR8LXxcLnxffH58W1x1MDBBMC1cdUQ3RkZcdUY5MDAtXHVGRENGXHVGREYwLVx1RkZFRl0pKihbYS16XXxcZHxbXHUwMEEwLVx1RDdGRlx1RjkwMC1cdUZEQ0ZcdUZERjAtXHVGRkVGXSkpKVwuKSsoKFthLXpdfFtcdTAwQTAtXHVEN0ZGXHVGOTAwLVx1RkRDRlx1RkRGMC1cdUZGRUZdKXwoKFthLXpdfFtcdTAwQTAtXHVEN0ZGXHVGOTAwLVx1RkRDRlx1RkRGMC1cdUZGRUZdKShbYS16XXxcZHwtfFwufF98fnxbXHUwMEEwLVx1RDdGRlx1RjkwMC1cdUZEQ0ZcdUZERjAtXHVGRkVGXSkqKFthLXpdfFtcdTAwQTAtXHVEN0ZGXHVGOTAwLVx1RkRDRlx1RkRGMC1cdUZGRUZdKSkpXC4/JC9pLAoJCXJVcmwgPSAvXihodHRwcz98ZnRwKTpcL1wvKCgoKFthLXpdfFxkfC18XC58X3x+fFtcdTAwQTAtXHVEN0ZGXHVGOTAwLVx1RkRDRlx1RkRGMC1cdUZGRUZdKXwoJVtcZGEtZl17Mn0pfFshXCQmJ1woXClcKlwrLDs9XXw6KSpAKT8oKChcZHxbMS05XVxkfDFcZFxkfDJbMC00XVxkfDI1WzAtNV0pXC4oXGR8WzEtOV1cZHwxXGRcZHwyWzAtNF1cZHwyNVswLTVdKVwuKFxkfFsxLTldXGR8MVxkXGR8MlswLTRdXGR8MjVbMC01XSlcLihcZHxbMS05XVxkfDFcZFxkfDJbMC00XVxkfDI1WzAtNV0pKXwoKChbYS16XXxcZHxbXHUwMEEwLVx1RDdGRlx1RjkwMC1cdUZEQ0ZcdUZERjAtXHVGRkVGXSl8KChbYS16XXxcZHxbXHUwMEEwLVx1RDdGRlx1RjkwMC1cdUZEQ0ZcdUZERjAtXHVGRkVGXSkoW2Etel18XGR8LXxcLnxffH58W1x1MDBBMC1cdUQ3RkZcdUY5MDAtXHVGRENGXHVGREYwLVx1RkZFRl0pKihbYS16XXxcZHxbXHUwMEEwLVx1RDdGRlx1RjkwMC1cdUZEQ0ZcdUZERjAtXHVGRkVGXSkpKVwuKSsoKFthLXpdfFtcdTAwQTAtXHVEN0ZGXHVGOTAwLVx1RkRDRlx1RkRGMC1cdUZGRUZdKXwoKFthLXpdfFtcdTAwQTAtXHVEN0ZGXHVGOTAwLVx1RkRDRlx1RkRGMC1cdUZGRUZdKShbYS16XXxcZHwtfFwufF98fnxbXHUwMEEwLVx1RDdGRlx1RjkwMC1cdUZEQ0ZcdUZERjAtXHVGRkVGXSkqKFthLXpdfFtcdTAwQTAtXHVEN0ZGXHVGOTAwLVx1RkRDRlx1RkRGMC1cdUZGRUZdKSkpXC4/KSg6XGQqKT8pKFwvKCgoW2Etel18XGR8LXxcLnxffH58W1x1MDBBMC1cdUQ3RkZcdUY5MDAtXHVGRENGXHVGREYwLVx1RkZFRl0pfCglW1xkYS1mXXsyfSl8WyFcJCYnXChcKVwqXCssOz1dfDp8QCkrKFwvKChbYS16XXxcZHwtfFwufF98fnxbXHUwMEEwLVx1RDdGRlx1RjkwMC1cdUZEQ0ZcdUZERjAtXHVGRkVGXSl8KCVbXGRhLWZdezJ9KXxbIVwkJidcKFwpXCpcKyw7PV18OnxAKSopKik/KT8oXD8oKChbYS16XXxcZHwtfFwufF98fnxbXHUwMEEwLVx1RDdGRlx1RjkwMC1cdUZEQ0ZcdUZERjAtXHVGRkVGXSl8KCVbXGRhLWZdezJ9KXxbIVwkJidcKFwpXCpcKyw7PV18OnxAKXxbXHVFMDAwLVx1RjhGRl18XC98XD8pKik/KFwjKCgoW2Etel18XGR8LXxcLnxffH58W1x1MDBBMC1cdUQ3RkZcdUY5MDAtXHVGRENGXHVGREYwLVx1RkZFRl0pfCglW1xkYS1mXXsyfSl8WyFcJCYnXChcKVwqXCssOz1dfDp8QCl8XC98XD8pKik/JC9pLAoJCXJEYXRlSVNPID0gL15cZHs0fVtcL1wtXVxkezEsMn1bXC9cLV1cZHsxLDJ9JC8sCgkJck51bWJlciA9IC9eLT8oPzpcZCt8XGR7MSwzfSg/OixcZHszfSkrKSg/OlwuXGQrKT8kLywKCQlyRGlnaXQgPSAvXlxkKyQvLAoJCXJJbnZhbGlkRGF0ZSA9IC9JbnZhbGlkfE5hTi8sCgkJclJlZ0V4ID0gL14oXC8oXFxbXlx4MDAtXHgxZl18XFsoXFxbXlx4MDAtXHgxZl18W15ceDAwLVx4MWZcXFwvXSkqXF18W15ceDAwLVx4MWZcXFwvXFtdKStcL1tnaW1dKikoLCguKikpKiQvLAoJCXJGaXJzdFRva2VuID0gLyhbXixdKykoLCguKikpPy8sCgkJckZpcnN0VHdvVG9rZW4gPSAvKFx3KyksKFx3KykoLCguKikpPy87CgoJLyoJdGhpcyBtZXRob2QgaXMgdG8gY3JlYXRlIGEgc3Vic2NyaXB0aW9uIGdyb3VwIGFuZAoJIHdvcmtmbG93IHR5cGUgdXNpbmcgdGhlIG5hbWUgb2YgdmFsaWRhdG9yCgkgYW5kIGFsc28gYWRkIGEgY2xhc3MgcnVsZSB1c2luZyB0aGUgbmFtZSBvZiB2YWxpZGF0b3IKCSBzbyBtYWtlIHN1cmUgdGhlIG5hbWUgb2YgdmFsaWRhdG9yIGRvIG5vdCBjb2xsaWRlIHdpdGggb3RoZXIgdmFsaWRhdG9yCgoJIGEgdmFsaWRhdG9yIGlzIG9iamVjdCBsaWtlCgkgewoJIG5hbWU6ICJ2YWxpZGF0b3JOYW1lIiwKCSBlcnJvcjogImVycm9yIG1lc3NhZ2UiCgkgaXNWYWxpZDogZnVuY3Rpb24oIHZhbHVlLCBvcHRpb25zICk7IC8vIG9wdGlvbnMgbGV0IHVzZXIgdG8gaGVscCB0aGUgaXNWYWxpZCB0byB3b3JrIGJldHRlcgoJIGluaXRpYWxpemU6IGZ1bmN0aW9uKG9wdGlvbnMpOyAvL2FsbG93IHVzZXIgY29udmVydCBzdHJpbmcgdmFsdWUgb2YgbW9kZWxFdmVudC5vcHRpb25zIHRvIHRoZSBvcHRpb25zIHBhc3NlZCBpbiBpc1ZhbGlkIGZ1bmN0aW9uCgkgYnVpbGRFcnJvcjogZnVuY3Rpb24oZGVmYXVsdE1lc3NhZ2UsIG9wdGlvbnMgKQoJIH0KCSAqLwoJaG0udmFsaWRhdG9yID0gZnVuY3Rpb24oIHZhbGlkYXRvciApIHsKCgkJaWYgKGlzQXJyYXkoIHZhbGlkYXRvciApKSB7CgkJCWZvciAodmFyIGkgPSAwOyBpIDwgdmFsaWRhdG9yLmxlbmd0aDsgaSsrKSB7CgkJCQlobS52YWxpZGF0b3IoIHZhbGlkYXRvcltpXSApOwoJCQl9CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJdmFyIHZhbGlkYXRvck5hbWUgPSB2YWxpZGF0b3IubmFtZTsKCgkJaWYgKGhtLndvcmtmbG93KCB2YWxpZGF0b3JOYW1lICkpIHsKCQkJdGhyb3cgInZhbGlkYXRvciBuYW1lICciICsgdmFsaWRhdG9yTmFtZSArICInIGNvbGxpZGUgd2l0aCBuYW1lIGluIGhtLndvcmtmbG93VHlwZXMiOwoJCX0KCgkJLy9hZGQgZGVmYXVsdCBlcnJvciBpZiBhcHBsaWNhYmxlCgkJLy91c2VyIGNhbiBsb2NhbGl6ZSBlcnJvcnMgbWVzc2FnZQoJCWlmICh2YWxpZGF0b3IuZXJyb3IpIHsKCQkJZGVmYXVsdE9wdGlvbnMuZXJyb3JzW3ZhbGlkYXRvck5hbWVdID0gdmFsaWRhdG9yLmVycm9yOwoJCX0KCgkJaWYgKHZhbGlkYXRvci5pc1ZhbGlkIGluc3RhbmNlb2YgUmVnRXhwKSB7CgkJCXZhbGlkYXRvci5pc1ZhbGlkID0gYnVpbGRSZWdleEZuKCB2YWxpZGF0b3IuaXNWYWxpZCApOwoJCX0KCgkJdmFyIHdvcmtmbG93VHlwZU5hbWUgPSAidl8iICsgdmFsaWRhdG9yTmFtZTsKCQlobS53b3JrZmxvdyggd29ya2Zsb3dUeXBlTmFtZSwgYnVpbGRWYWxpZGF0aW9uV29ya2Zsb3dUeXBlKCB2YWxpZGF0b3IgKSApOwoKCQkvL2RhdGEtc3ViPSJyZXF1aXJlZDpwYXRoIiBvciBkYXRhLXN1Yj0icmVxdWlyZWQ6cGF0aHxvcHRpb25zIgoJCWJpbmRpbmdzKCB2YWxpZGF0b3JOYW1lLCAiIWFmdGVyVXBkYXRlIGNoZWNrVmFsaWRpdHk6LnwqIiArIHdvcmtmbG93VHlwZU5hbWUgKTsKCgl9OwoKCWhtLndvcmtmbG93KCB7CgkJY2hlY2tWYWxpZGl0eTogZnVuY3Rpb24oIGUgKSB7CgkJCWlmICghaG0uY2hlY2tWYWxpZGl0eSggdGhpcy5wYXRoICkpIHsKCQkJCS8vYmVjYXVzZSBpdCBpcyB0aGUgZmlyc3QgaGFuZGxlciwgZS5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24gd2lsbAoJCQkJLy9zdG9wIHByb2Nlc3MgYWxsIG90aGVyIGhhbmRsZXIKCQkJCWUuc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uKCk7CgkJCX0KCQl9LAoKCQkvLyB1c2UgYnkgZ3JvdXAKCQkvLyB3YXJuOiAiIWFmdGVyKjoqZXJyb3JzfCp3YXJuIiwKCQl3YXJuOiBmdW5jdGlvbiggZSApIHsKCQkJLy9lLnB1Ymxpc2hlciBwb2ludHMgdG8gIm1vZGVsKmVycm9ycyIKCQkJaWYgKGUucHVibGlzaGVyLmlzRW1wdHkoKSkgewoKCQkJCXRoaXMKCQkJCQkucmVtb3ZlQ2xhc3MoICJlcnJvciIgKQoJCQkJCS5uZXh0KCAic3Bhbi5lcnJvciIgKQoJCQkJCS5yZW1vdmUoKTsKCgkJCX0gZWxzZSB7CgoJCQkJdGhpcwoJCQkJCS5hZGRDbGFzcyggImVycm9yIiApCgkJCQkJLm5leHQoICJzcGFuLmVycm9yIiApCgkJCQkJLnJlbW92ZSgpCgkJCQkJLmVuZCgpCgkJCQkJLmFmdGVyKCAiPHNwYW4gY2xhc3M9J2Vycm9yJz4iICsgZS5wdWJsaXNoZXIuZ2V0KCkgKyAiPC9zcGFuPiIgKTsKCQkJfQoJCX0sCgoJCWhpZ2hsaWdodEVycm9yOiBmdW5jdGlvbiggZSApIHsKCQkJdGhpc1tlLnB1Ymxpc2hlci5pc0VtcHR5KCkgPyAicmVtb3ZlQ2xhc3MiIDogImFkZENsYXNzIl0oICJlcnJvciIgKTsKCgkJfSwKCgkJcmVuZGVyRXJyb3JTdW1tYXJ5OiBobS50ZW1wbGF0ZS5uZXdUZW1wbGF0ZUhhbmRsZXIoCgkJCWZ1bmN0aW9uKCBlICkgewoJCQkJcmV0dXJuIFtlLnB1Ymxpc2hlci5nZXRFcnJvcnMoKV07CgkJCX0KCQkpCgl9ICk7CgoJYmluZGluZ3MoIHsKCgkJdmFsaWRhdG9yOiBmdW5jdGlvbiggZWxlbSwgcGF0aCwgY29udGV4dCwgb3B0aW9ucyApIHsKCQkJaWYgKCFvcHRpb25zKSB7CgkJCQl0aHJvdyAibWlzc2luZyB2YWxpZGF0b3IgcGF0aCI7CgkJCX0KCQkJaWYgKCFvcHRpb25zLnN0YXJ0c1dpdGgoICIjIiApKSB7CgkJCQlvcHRpb25zID0gIiMiICsgb3B0aW9uczsKCQkJfQoJCQlobSggcGF0aCApLnZhbGlkYXRvciggb3B0aW9ucyApOwoJCX0sCgoJCS8vYWRkIGEgY2xpY2sgaGFuZGxlciB0byBlbGVtZW50IHRvIGNoZWNrVmFsaWRpdHkKCQljaGVja1ZhbGlkaXR5OiBmdW5jdGlvbiggZWxlbSwgcGF0aCwgY29udGV4dCwgb3B0aW9ucyApIHsKCQkJLy9wcmVwZW5kIHRvIHRvIHN1YnNjcmlwdGlvbnMgYXJyYXkKCQkJLy9zbyB0aGF0IGl0IGlzIHRoZSBmaXJzdCBzdWJzY3JpcHRpb25zLCBhbmQgaXQgd2lsbCBiZSBldmFsdWF0ZWQgZmlyc3QKCQkJY29udGV4dC5wcmVwZW5kU3ViKCBwYXRoLCBlbGVtLCAiY2xpY2siLCAiKmNoZWNrVmFsaWRpdHkiICk7CgkJfSwKCgkJcmVzZXRWYWxpZGl0eTogIiRjbGljazoufCpmYWtlR2V0IHJlc2V0VmFsaWRpdHkiLAoKCQl3YXJuOiAiIWFmdGVyKjoqZXJyb3JzfCp3YXJuIiwKCgkJImhpZ2hsaWdodEVycm9yIjogIiFhZnRlcio6KmVycm9yc3wqaGlnaGxpZ2h0RXJyb3IiLAoKCQl3YXJuU3VtbWFyeTogIiFhZnRlclVwZGF0ZSogdmFsaWRpdHlDaGVja2VkOi58KnJlbmRlckVycm9yU3VtbWFyeTshdmFsaWRpdHlSZXNldDoufGVtcHR5IgoKCX0gKTsKCgliaW5kaW5ncyggImZvcm0iLCBmdW5jdGlvbiggZWxlbSwgcGF0aCwgY29udGV4dCwgb3B0aW9ucyApIHsKCQljb250ZXh0LmFwcGVuZFN1YiggcGF0aCwgZWxlbSwgInJlc2V0IiwgIipmYWtlR2V0IHJlc2V0VmFsaWRpdHkiICk7Cgl9LCB0cnVlICk7CgoJZnVuY3Rpb24gaXNQYXRoVmFsaWQoIHBhdGggKSB7CgoJCWlmIChwYXRoID09PSAiIikgewoJCQlyZXR1cm4gIWludmFsaWRQYXRocy5sZW5ndGg7CgkJfQoKCQl2YXIgcHJlZml4ID0gcGF0aCArICIuIjsKCgkJZm9yICh2YXIgaSA9IDAsIGludmFsaWRQYXRoLCBsZW5ndGggPSBpbnZhbGlkUGF0aHMubGVuZ3RoOyBpIDwgbGVuZ3RoOyBpKyspIHsKCQkJaW52YWxpZFBhdGggPSBpbnZhbGlkUGF0aHNbaV07CgkJCWlmIChpbnZhbGlkUGF0aCA9PSBwYXRoIHx8IGludmFsaWRQYXRoLnN0YXJ0c1dpdGgoIHByZWZpeCApKSB7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCQl9CgkJcmV0dXJuIHRydWU7Cgl9CgoJLy8kKCJ4Iikuc3Vic2NyaWJlKCJwZXJzb24iLCAiY2hlY2tWYWxpZGl0eWQiLCBmdW5jdGlvbiAoZSkgewoJLy8gYWxlcnQoZS5wcm9wb3NlZCk7CgkvL30KCWhtLnN1YnNjcmlwdGlvbi5zcGVjaWFsLnZhbGlkaXR5Q2hhbmdlZCA9IHsKCQlzZXR1cDogZnVuY3Rpb24oIHN1YnNjcmliZXIsIHB1Ymxpc2hlciApIHsKCQkJdmFyIGlzVmFsaWRQYXRoID0gcHVibGlzaGVyICsgIippc1ZhbGlkIjsKCgkJCWlmIChpc1VuZGVmaW5lZCggaG0uZ2V0KCBpc1ZhbGlkUGF0aCApICkpIHsKCQkJCWhtLnN1YiggcHVibGlzaGVyLCAiKmludmFsaWRQYXRocyIsICIhYWZ0ZXIqLiBhZnRlciouMSIsIGZ1bmN0aW9uKCkgewoJCQkJCXZhciBpc1ZhbGlkID0gaXNQYXRoVmFsaWQoIHB1Ymxpc2hlciApOwoJCQkJCWlmIChobS5nZXQoIGlzVmFsaWRQYXRoICkgIT09IGlzVmFsaWQpIHsKCQkJCQkJaG0udHJpZ2dlciggcHVibGlzaGVyLCBwdWJsaXNoZXIsICJ2YWxpZGl0eUNoYW5nZWQiLCBpc1ZhbGlkLCAhaXNWYWxpZCApOwoJCQkJCQlobS5zZXQoIGlzVmFsaWRQYXRoLCBpc1ZhbGlkICk7CgkJCQkJfQoJCQkJfSApOwoJCQl9CgkJfQoJfTsKCglleHRlbmQoIGhtRm4sIHsKCgkJLyoKCQkgKiAxLiB0aGUgb2JqZWN0cyBpbiBwYXRoICIqaW52YWxpZFBhdGhzIiwgaXQgaG9sZHMgYWxsIHRoZSBwYXRoIG9mIG1vZGVsIHdoaWNoIGlzIGluIGVycm9yCgkJICogMi4gdGhlIG9iamVjdCBpbiBwYXRoICJtb2RlbCplcnJvcnMiLCBpdCBob2xkcyBhbGwgZXJyb3IgbWVzc2FnZSB0aGF0IGlzCgkJICogKi8KCQljaGVja1ZhbGlkaXR5OiBmdW5jdGlvbiggc3ViUGF0aCApIHsKCgkJCXZhciBmdWxsUGF0aCA9IHRoaXMuZ2V0UGF0aCggc3ViUGF0aCApOyAvLyB0aGlzLmNkKCBzdWJQYXRoICkucGF0aDsKCgkJCXRyYXZlcnNlTW9kZWxOZWVkVmFsaWRhdGlvbiggZnVsbFBhdGgsIGZ1bmN0aW9uKCBwYXRoICkgewoJCQkJdHJpZ2dlciggcGF0aCwgcGF0aCwgImNoZWNrVmFsaWRpdHkiLCByb290Tm9kZS5nZXQoIHBhdGggKSApOwoJCQl9ICk7CgoJCQkvL2FmdGVyIGNoZWNrVmFsaWRpdHkgZmlyZWQsIHdlIGNhbiBjaGVjayB0aGUgaW52YWxpZCBwYXRocyBjb3VudCBmb3IgdGhlIG1vZGVsLAoJCQl2YXIgaXNWYWxpZCA9IGlzUGF0aFZhbGlkKCBmdWxsUGF0aCApOwoJCQkvLwoJCQlobS50cmlnZ2VyKCBmdWxsUGF0aCwgZnVsbFBhdGgsICJ2YWxpZGl0eUNoZWNrZWQiLCBpc1ZhbGlkICk7CgoJCQlyZXR1cm4gaXNWYWxpZDsKCQl9LAoKCQkvL2htKCJ4IikuY2hlY2sodmFsaWRhdG9yTmFtZSwgZXJyb3IpCgkJLy9leGFtcGxlCgkJLy9obSgieCIpLmNoZWNrKCJudW1iZXIiLCAibXkgZXJyb3IgbWVzc2FnZSIpCgkJLy8KCQkvL2htKCJ4IikuY2hlY2soZm5Jc1ZhbGlkLCBlcnJvcikKCQkvL2V4YW1wbGUKCQkvL2htKCJ4IikuY2hlY2soZnVuY3Rpb24oIHZhbHVlICkgeyByZXR1cm4gZmFsc2U7IH0sICJteSBlcnJvciBtZXNzYWdlIik7CgkJdmFsaWRhdG9yOiBmdW5jdGlvbiggdmFsaWRhdG9yLCBvcHRpb25zICkgewoJCQl2YXIgc3ViUGF0aCwKCQkJCWksCgkJCQljdXJyZW50VmFsaWRhdG9yOwoKCQkJaWYgKGlzT2JqZWN0KCB2YWxpZGF0b3IgKSkgewoKCQkJCWZvciAoc3ViUGF0aCBpbiB2YWxpZGF0b3IpIHsKCgkJCQkJdGhpcy5jZCggc3ViUGF0aCApLnZhbGlkYXRvciggdmFsaWRhdG9yW3N1YlBhdGhdICk7CgoJCQkJfQoJCQl9IGVsc2UgewoKCQkJCWlmIChpc0Z1bmN0aW9uKCB2YWxpZGF0b3IgKSB8fCAoaXNTdHJpbmcoIHZhbGlkYXRvciApICYmIHZhbGlkYXRvci5zdGFydHNXaXRoKCAiIyIgKSkpIHsKCgkJCQkJaWYgKGlzU3RyaW5nKCB2YWxpZGF0b3IgKSkgewoJCQkJCQl2YWxpZGF0b3IgPSB0aGlzLnJhdyggdmFsaWRhdG9yLnN1YnN0ciggMSApICk7CgkJCQkJfQoKCQkJCQlobS5oYW5kbGUoIHRoaXMucGF0aCwgYWZ0ZXJVcGRhdGVBbmRDaGVja1ZhbGlkaXR5LCBmdW5jdGlvbiggZSApIHsKCQkJCQkJdmFyIHB1Ymxpc2hlciA9IGUucHVibGlzaGVyLAoJCQkJCQkJcHJldmlvdXNFcnJvciA9IHZhbGlkYXRvci5wcmV2aW91c0Vycm9yOwoKCQkJCQkJLy9kb24ndCBjaGVjayB3aGVuIGl0IGlzIGVtcHR5CgkJCQkJCWlmICghaXNFbXB0eVN0cmluZyggZS5wcm9wb3NlZCApKSB7CgoJCQkJCQkJdmFyIGVycm9yTWVzc2FnZSA9IHZhbGlkYXRvciggcHVibGlzaGVyLmdldCgpICk7CgoJCQkJCQkJaWYgKGVycm9yTWVzc2FnZSA9PT0gZmFsc2UpIHsKCQkJCQkJCQllcnJvck1lc3NhZ2UgPSBkZWZhdWx0T3B0aW9ucy5lcnJvcnMuZGVmYXVsdEVycm9yOwoJCQkJCQkJfQoKCQkJCQkJCWlmIChpc1N0cmluZyggZXJyb3JNZXNzYWdlICkpIHsKCQkJCQkJCQkvLyB0aGUgIiE9IiBpcyBkZWxpYmVyYXRlLCBkb24ndCBjaGFuZ2UgdG8gIiE9PSIKCQkJCQkJCQlpZiAoZXJyb3JNZXNzYWdlICE9IHByZXZpb3VzRXJyb3IpIHsKCgkJCQkJCQkJCXB1Ymxpc2hlci5hZGRFcnJvciggZXJyb3JNZXNzYWdlICk7CgoJCQkJCQkJCQlpZiAoIXByZXZpb3VzRXJyb3IpIHsKCQkJCQkJCQkJCXB1Ymxpc2hlci5yZW1vdmVFcnJvciggcHJldmlvdXNFcnJvciApOwoJCQkJCQkJCQl9CgoJCQkJCQkJCQl2YWxpZGF0b3IucHJldmlvdXNFcnJvciA9IGVycm9yTWVzc2FnZTsKCQkJCQkJCQl9CgoJCQkJCQkJfSBlbHNlIHsKCQkJCQkJCQlpZiAocHJldmlvdXNFcnJvcikgewoJCQkJCQkJCQlwdWJsaXNoZXIucmVtb3ZlRXJyb3IoIHByZXZpb3VzRXJyb3IgKTsKCQkJCQkJCQkJdmFsaWRhdG9yLnByZXZpb3VzRXJyb3IgPSAiIjsKCQkJCQkJCQl9CgkJCQkJCQl9CgkJCQkJCX0gZWxzZSB7CgkJCQkJCQlpZiAocHJldmlvdXNFcnJvcikgewoJCQkJCQkJCXB1Ymxpc2hlci5yZW1vdmVFcnJvciggcHJldmlvdXNFcnJvciApOwoJCQkJCQkJCXZhbGlkYXRvci5wcmV2aW91c0Vycm9yID0gIiI7CgkJCQkJCQl9CgkJCQkJCX0KCgkJCQkJfSApOwoKCQkJCX0gZWxzZSBpZiAoaXNTdHJpbmcoIHZhbGlkYXRvciApKSB7CgoJCQkJCWhtLmhhbmRsZSggdGhpcy5wYXRoLCBhZnRlclVwZGF0ZUFuZENoZWNrVmFsaWRpdHksICIqdl8iICsgdmFsaWRhdG9yLCBvcHRpb25zICk7CgoJCQkJfSBlbHNlIGlmIChpc0FycmF5KCB2YWxpZGF0b3IgKSkgewoKCQkJCQlmb3IgKGkgPSAwOyBpIDwgdmFsaWRhdG9yLmxlbmd0aDsgaSsrKSB7CgoJCQkJCQljdXJyZW50VmFsaWRhdG9yID0gdmFsaWRhdG9yW2ldOwoKCQkJCQkJaWYgKGlzQXJyYXkoIGN1cnJlbnRWYWxpZGF0b3IgKSkgewoJCQkJCQkJdGhpcy52YWxpZGF0b3IoIGN1cnJlbnRWYWxpZGF0b3JbMF0sIGN1cnJlbnRWYWxpZGF0b3JbMV0gKTsKCgkJCQkJCX0gZWxzZSB7CgkJCQkJCQl0aGlzLnZhbGlkYXRvciggY3VycmVudFZhbGlkYXRvciApOwoJCQkJCQl9CgkJCQkJfQoJCQkJfQoKCQkJfQoJCQlyZXR1cm4gdGhpczsKCQl9LAoKCQlyZXNldFZhbGlkaXR5OiBmdW5jdGlvbigpIHsKCQkJcmVzZXRWYWxpZGl0eSggdGhpcy5wYXRoICk7CgoJCQlpZiAoIWlzUHJpbWl0aXZlKCB0aGlzLmdldCgpICkpIHsKCQkJCXRyYXZlcnNlTW9kZWxOZWVkVmFsaWRhdGlvbiggdGhpcy5wYXRoLCByZXNldFZhbGlkaXR5ICk7CgkJCX0KCQkJaG0udHJpZ2dlciggdGhpcy5wYXRoLCB0aGlzLnBhdGgsICJ2YWxpZGl0eVJlc2V0IiApOwoJCX0sCgoJCWFkZEVycm9yOiBmdW5jdGlvbiggZXJyb3IgKSB7CgkJCXRoaXMuY3JlYXRlSWZVbmRlZmluZWQoICIqZXJyb3JzIiwgW10gKQoJCQkJLmNkKCAiKmVycm9ycyIgKQoJCQkJLnB1c2hVbmlxdWUoIGVycm9yICk7CgoJCQlpbnZhbGlkUGF0aHNNb2RlbC5wdXNoVW5pcXVlKCB0aGlzLnBhdGggKTsKCQkJcmV0dXJuIHRoaXM7CgoJCX0sCgoJCXJlbW92ZUVycm9yOiBmdW5jdGlvbiggZXJyb3IgKSB7CgoJCQl2YXIgZXJyb3JzID0gdGhpcy5jcmVhdGVJZlVuZGVmaW5lZCggIiplcnJvcnMiLCBbXSApLmNkKCAiKmVycm9ycyIgKTsKCQkJZXJyb3JzLnJlbW92ZUl0ZW0oIGVycm9yICk7CgkJCWlmIChlcnJvcnMuaXNFbXB0eSgpKSB7CgkJCQlpbnZhbGlkUGF0aHNNb2RlbC5yZW1vdmVJdGVtKCB0aGlzLnBhdGggKTsKCQkJfQoJCQlyZXR1cm4gdGhpczsKCQl9LAoKCQlnZXRFcnJvcnM6IGZ1bmN0aW9uKCkgewoKCQkJdmFyIGksCgkJCQlwYXRoID0gdGhpcy5wYXRoLAoJCQkJaW52YWxpZFBhdGgsCgkJCQlydG4gPSBbXTsKCgkJCWZvciAoaSA9IDA7IGkgPCBpbnZhbGlkUGF0aHMubGVuZ3RoOyBpKyspIHsKCQkJCWludmFsaWRQYXRoID0gaW52YWxpZFBhdGhzW2ldOwoJCQkJaWYgKGludmFsaWRQYXRoID09IHBhdGggfHwgaW52YWxpZFBhdGguc3RhcnRzV2l0aCggcGF0aCApKSB7CgkJCQkJcnRuID0gcnRuLmNvbmNhdCggaG0uZ2V0KCBpbnZhbGlkUGF0aCArICIqZXJyb3JzIiApICk7CgkJCQl9CgkJCX0KCQkJcmV0dXJuIHJ0bjsKCQl9CgoJfSApOwoKCWhtLmNoZWNrVmFsaWRpdHkgPSBmdW5jdGlvbiggcGF0aCApIHsKCQlyZXR1cm4gcm9vdE5vZGUuY2hlY2tWYWxpZGl0eSggcGF0aCApOwoJfTsKCgkvL3doZW4gcGF0aCBpcyBkZWxldGVkLCByZW1vdmUgaXQgZnJvbSBpbnZhbGlkUGF0aHNNb2RlbAoJaG0ub25EZWxldGVOb2RlKCBmdW5jdGlvbiggcGF0aCApIHsKCQlpbnZhbGlkUGF0aHNNb2RlbC5yZW1vdmVJdGVtKCBwYXRoICk7Cgl9ICk7CgoJZnVuY3Rpb24gYnVpbGRSZWdleEZuKCBleCwgcmV2ZXJzZSApIHsKCQlyZXR1cm4gcmV2ZXJzZSA/IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQkJcmV0dXJuICFleC50ZXN0KCB2YWx1ZSApOwoJCX0gOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJCXJldHVybiBleC50ZXN0KCB2YWx1ZSApOwoJCX07Cgl9CgoJZnVuY3Rpb24gZGVmYXVsdEVycm9yQnVpbGRlciggZm9ybWF0LCBvcHRpb25zICkgewoJCXJldHVybiBvcHRpb25zLmVycm9yIHx8IGZvcm1hdC5zdXBwbGFudCggb3B0aW9ucyApOwoJfQoKCWhtLnZhbGlkYXRvci5kZWZhdWx0RXJyb3JCdWlsZGVyID0gZGVmYXVsdEVycm9yQnVpbGRlcjsKCWhtLnZhbGlkYXRvci5idWlsZFJlZ2V4Rm4gPSBidWlsZFJlZ2V4Rm47CgoJaG0udmFsaWRhdG9yKCBbCgkJewoJCQluYW1lOiAicmVxdWlyZWQiLAoJCQllcnJvcjogIlRoaXMgZmllbGQgaXMgcmVxdWlyZWQuIiwKCQkJLy93aGVuIGl0IGlzIGNoZWNrZWQgaXQgaXMgYWx3YXlzIHRydWUKCQkJaXNWYWxpZDogcmV0dXJuVHJ1ZQoJCX0sCgkJewoJCQluYW1lOiAiZW1haWwiLAoJCQllcnJvcjogIlBsZWFzZSBlbnRlciBhIHZhbGlkIGVtYWlsIGFkZHJlc3MuIiwKCQkJaXNWYWxpZDogckVtYWlsCgkJfSwKCQl7CgkJCW5hbWU6ICJ1cmwiLAoJCQllcnJvcjogIlBsZWFzZSBlbnRlciBhIHZhbGlkIFVSTC4iLAoJCQlpc1ZhbGlkOiByVXJsCgkJfSwKCQl7CgkJCW5hbWU6ICJkYXRlIiwKCQkJZXJyb3I6ICJQbGVhc2UgZW50ZXIgYSB2YWxpZCBkYXRlLiIsCgkJCWlzVmFsaWQ6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQkJCXJldHVybiAhckludmFsaWREYXRlLnRlc3QoIG5ldyBEYXRlKCB2YWx1ZSApLnRvU3RyaW5nKCkgKTsKCQkJfQoJCX0sCgkJewoJCQluYW1lOiAiZGF0ZUlTTyIsCgkJCWVycm9yOiAiUGxlYXNlIGVudGVyIGEgdmFsaWQgZGF0ZSAoSVNPKS4iLAoJCQlpc1ZhbGlkOiByRGF0ZUlTTwoJCX0sCgkJewoJCQluYW1lOiAibnVtYmVyIiwKCQkJZXJyb3I6ICJQbGVhc2UgZW50ZXIgYSB2YWxpZCBudW1iZXIuIiwKCQkJaXNWYWxpZDogck51bWJlcgoJCX0sCgkJewoJCQluYW1lOiAiZGlnaXRzIiwKCQkJZXJyb3I6ICJQbGVhc2UgZW50ZXIgb25seSBkaWdpdHMuIiwKCQkJaXNWYWxpZDogckRpZ2l0CgoJCX0sCgkJewoJCQluYW1lOiAiY3JlZGl0Y2FyZCIsCgkJCWVycm9yOiAiUGxlYXNlIGVudGVyIGEgdmFsaWQgY3JlZGl0IGNhcmQgbnVtYmVyLiIsCgkJCWlzVmFsaWQ6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQkJCWlmICgvW14wLTlcLV0rLy50ZXN0KCB2YWx1ZSApKSB7CgkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJfQoKCQkJCXZhciBuQ2hlY2sgPSAwLAoJCQkJCW5EaWdpdCA9IDAsCgkJCQkJYkV2ZW4gPSBmYWxzZSwKCQkJCQljRGlnaXQ7CgoJCQkJdmFsdWUgPSB2YWx1ZS5yZXBsYWNlKCAvXEQvZywgIiIgKTsKCgkJCQlmb3IgKHZhciBuID0gdmFsdWUubGVuZ3RoIC0gMTsgbiA+PSAwOyBuLS0pIHsKCQkJCQljRGlnaXQgPSB2YWx1ZS5jaGFyQXQoIG4gKTsKCQkJCQluRGlnaXQgPSBwYXJzZUludCggY0RpZ2l0LCAxMCApOwoJCQkJCWlmIChiRXZlbikgewoJCQkJCQlpZiAoKG5EaWdpdCAqPSAyKSA+IDkpIHsKCQkJCQkJCW5EaWdpdCAtPSA5OwoJCQkJCQl9CgkJCQkJfQoJCQkJCW5DaGVjayArPSBuRGlnaXQ7CgkJCQkJYkV2ZW4gPSAhYkV2ZW47CgkJCQl9CgoJCQkJcmV0dXJuIChuQ2hlY2sgJSAxMCkgPT09IDA7CgkJCX0KCgkJfSwKCQl7CgkJCW5hbWU6ICJtaW5sZW5ndGgiLAoJCQllcnJvcjogIlBsZWFzZSBlbnRlciBhdCBsZWFzdCB7bWlubGVuZ3RofSBjaGFyYWN0ZXJzLiIsCgkJCWlzVmFsaWQ6IGZ1bmN0aW9uKCB2YWx1ZSwgb3B0aW9ucyApIHsKCgkJCQlyZXR1cm4gdmFsdWUubGVuZ3RoID49IG9wdGlvbnMubWlubGVuZ3RoOwoKCQkJfSwKCQkJaW5pdGlhbGl6ZTogZnVuY3Rpb24oIHB1Ymxpc2hlciwgc3Vic2NyaWJlciwgaGFuZGxlciwgb3B0aW9ucyApIHsKCQkJCXZhciBtYXRjaDsKCQkJCWlmIChvcHRpb25zICYmIChtYXRjaCA9IHJGaXJzdFRva2VuLmV4ZWMoIG9wdGlvbnMgKSkpIHsKCgkJCQkJaGFuZGxlci5vcHRpb25zID0gewoJCQkJCQltaW5sZW5ndGg6ICttYXRjaFsxXSwKCQkJCQkJZXJyb3I6IG1hdGNoWzNdCgkJCQkJfTsKCQkJCX0gZWxzZSB7CgkJCQkJdGhyb3cgImludmFsaWQgb3B0aW9ucyBmb3IgbWlubGVuZ3RoIHZhbGlkYXRvciI7CgkJCQl9CgkJCX0sCgoJCQlidWlsZEVycm9yOiBkZWZhdWx0RXJyb3JCdWlsZGVyCgkJfSwKCQl7CgkJCW5hbWU6ICJtYXhsZW5ndGgiLAoJCQllcnJvcjogIlBsZWFzZSBlbnRlciBubyBtb3JlIHRoYW4ge21heGxlbmd0aH0gY2hhcmFjdGVycy4iLAoJCQlpc1ZhbGlkOiBmdW5jdGlvbiggdmFsdWUsIG9wdGlvbnMgKSB7CgoJCQkJcmV0dXJuIHZhbHVlLmxlbmd0aCA8PSBvcHRpb25zLm1heGxlbmd0aDsKCgkJCX0sCgkJCWluaXRpYWxpemU6IGZ1bmN0aW9uKCBwdWJsaXNoZXIsIHN1YnNjcmliZXIsIGhhbmRsZXIsIG9wdGlvbnMgKSB7CgkJCQl2YXIgbWF0Y2g7CgkJCQlpZiAob3B0aW9ucyAmJiAobWF0Y2ggPSByRmlyc3RUb2tlbi5leGVjKCBvcHRpb25zICkpKSB7CgkJCQkJaGFuZGxlci5vcHRpb25zID0gewoJCQkJCQltYXhsZW5ndGg6ICttYXRjaFsxXSwKCQkJCQkJZXJyb3I6IG1hdGNoWzNdCgkJCQkJfTsKCQkJCX0gZWxzZSB7CgkJCQkJdGhyb3cgImludmFsaWQgb3B0aW9ucyBmb3IgbWF4bGVuZ3RoIHZhbGlkYXRvciI7CgkJCQl9CgkJCX0sCgkJCWJ1aWxkRXJyb3I6IGRlZmF1bHRFcnJvckJ1aWxkZXIKCQl9LAoJCXsKCQkJbmFtZTogInJhbmdlbGVuZ3RoIiwKCQkJZXJyb3I6ICJQbGVhc2UgZW50ZXIgYSB2YWx1ZSBiZXR3ZWVuIHttaW5sZW5ndGh9IGFuZCB7bWF4bGVuZ3RofSBjaGFyYWN0ZXJzIGxvbmcuIiwKCQkJaXNWYWxpZDogZnVuY3Rpb24oIHZhbHVlLCBvcHRpb25zICkgewoKCQkJCXJldHVybiB2YWx1ZS5sZW5ndGggPj0gb3B0aW9ucy5taW5sZW5ndGggJiYKCQkJCSAgICAgICB2YWx1ZS5sZW5ndGggPD0gb3B0aW9ucy5tYXhsZW5ndGg7CgoJCQl9LAoJCQlpbml0aWFsaXplOiBmdW5jdGlvbiggcHVibGlzaGVyLCBzdWJzY3JpYmVyLCBoYW5kbGVyLCBvcHRpb25zICkgewoJCQkJdmFyIG1hdGNoOwoJCQkJaWYgKG9wdGlvbnMgJiYgKG1hdGNoID0gckZpcnN0VHdvVG9rZW4uZXhlYyggb3B0aW9ucyApKSkgewoJCQkJCWhhbmRsZXIub3B0aW9ucyA9IHsKCQkJCQkJbWlubGVuZ3RoOiArbWF0Y2hbMV0sCgkJCQkJCW1heGxlbmd0aDogK21hdGNoWzJdLAoJCQkJCQllcnJvcjogbWF0Y2hbNF0KCQkJCQl9OwoJCQkJfSBlbHNlIHsKCQkJCQl0aHJvdyAiaW52YWxpZCBvcHRpb25zIGZvciByYW5nZWxlbmd0aCB2YWxpZGF0b3IiOwoJCQkJfQoJCQl9LAoJCQlidWlsZEVycm9yOiBkZWZhdWx0RXJyb3JCdWlsZGVyCgoJCX0sCgkJewoJCQluYW1lOiAibWluIiwKCQkJZXJyb3I6ICJQbGVhc2UgZW50ZXIgYSB2YWx1ZSBncmVhdGVyIHRoYW4gb3IgZXF1YWwgdG8ge21pbn0uIiwKCQkJaXNWYWxpZDogZnVuY3Rpb24oIHZhbHVlLCBvcHRpb25zICkgewoKCQkJCXJldHVybiB2YWx1ZSA+PSBvcHRpb25zLm1pbjsKCgkJCX0sCgkJCWluaXRpYWxpemU6IGZ1bmN0aW9uKCBwdWJsaXNoZXIsIHN1YnNjcmliZXIsIGhhbmRsZXIsIG9wdGlvbnMgKSB7CgkJCQl2YXIgbWF0Y2g7CgkJCQlpZiAob3B0aW9ucyAmJiAobWF0Y2ggPSByRmlyc3RUb2tlbi5leGVjKCBvcHRpb25zICkpKSB7CgkJCQkJaGFuZGxlci5vcHRpb25zID0gewoJCQkJCQltaW46ICttYXRjaFsxXSwKCQkJCQkJZXJyb3I6IG1hdGNoWzNdCgkJCQkJfTsKCQkJCX0gZWxzZSB7CgkJCQkJdGhyb3cgImludmFsaWQgb3B0aW9ucyBmb3IgbWluIHZhbGlkYXRvciI7CgkJCQl9CgoJCQl9LAoJCQlidWlsZEVycm9yOiBkZWZhdWx0RXJyb3JCdWlsZGVyCgkJfSwKCQl7CgkJCW5hbWU6ICJtYXgiLAoJCQllcnJvcjogIlBsZWFzZSBlbnRlciBhIHZhbHVlIGxlc3MgdGhhbiBvciBlcXVhbCB0byB7bWF4fS4iLAoJCQlpc1ZhbGlkOiBmdW5jdGlvbiggdmFsdWUsIG9wdGlvbnMgKSB7CgoJCQkJcmV0dXJuIHZhbHVlIDw9IG9wdGlvbnMubWF4OwoKCQkJfSwKCQkJaW5pdGlhbGl6ZTogZnVuY3Rpb24oIHB1Ymxpc2hlciwgc3Vic2NyaWJlciwgaGFuZGxlciwgb3B0aW9ucyApIHsKCQkJCXZhciBtYXRjaDsKCQkJCWlmIChvcHRpb25zICYmIChtYXRjaCA9IHJGaXJzdFRva2VuLmV4ZWMoIG9wdGlvbnMgKSkpIHsKCQkJCQloYW5kbGVyLm9wdGlvbnMgPSB7CgkJCQkJCW1heDogK21hdGNoWzFdLAoJCQkJCQllcnJvcjogbWF0Y2hbM10KCQkJCQl9OwoJCQkJfSBlbHNlIHsKCQkJCQl0aHJvdyAiaW52YWxpZCBvcHRpb25zIGZvciBtYXggdmFsaWRhdG9yIjsKCQkJCX0KCQkJfSwKCQkJYnVpbGRFcnJvcjogZGVmYXVsdEVycm9yQnVpbGRlcgoJCX0sCgkJewoJCQluYW1lOiAicmFuZ2UiLAoJCQllcnJvcjogIlBsZWFzZSBlbnRlciBhIHZhbHVlIGJldHdlZW4ge21pbn0gYW5kIHttYXh9LiIsCgkJCWlzVmFsaWQ6IGZ1bmN0aW9uKCB2YWx1ZSwgb3B0aW9ucyApIHsKCgkJCQlyZXR1cm4gdmFsdWUgPj0gb3B0aW9ucy5taW4gJiYgdmFsdWUgPD0gb3B0aW9ucy5tYXg7CgoJCQl9LAoJCQlpbml0aWFsaXplOiBmdW5jdGlvbiggcHVibGlzaGVyLCBzdWJzY3JpYmVyLCBoYW5kbGVyLCBvcHRpb25zICkgewoJCQkJdmFyIG1hdGNoOwoJCQkJaWYgKG9wdGlvbnMgJiYgKG1hdGNoID0gckZpcnN0VHdvVG9rZW4uZXhlYyggb3B0aW9ucyApKSkgewoJCQkJCWhhbmRsZXIub3B0aW9ucyA9IHsKCQkJCQkJbWluOiArbWF0Y2hbMV0sCgkJCQkJCW1heDogK21hdGNoWzJdLAoJCQkJCQllcnJvcjogbWF0Y2hbNF0KCQkJCQl9OwoJCQkJfSBlbHNlIHsKCQkJCQl0aHJvdyAiaW52YWxpZCBvcHRpb25zIGZvciByYW5nZSB2YWxpZGF0b3IiOwoJCQkJfQoJCQl9LAoJCQlidWlsZEVycm9yOiBkZWZhdWx0RXJyb3JCdWlsZGVyCgkJfSwKCQl7CgkJCW5hbWU6ICJlcXVhbCIsCgkJCWVycm9yOiAiUGxlYXNlIGVudGVyIHRoZSBzYW1lIHZhbHVlIGFnYWluLiIsCgkJCWlzVmFsaWQ6IGZ1bmN0aW9uKCB2YWx1ZSwgb3B0aW9ucyApIHsKCQkJCXJldHVybiByb290Tm9kZS5nZXQoIG9wdGlvbnMuY29tcGFyZVBhdGggKSA9PT0gdmFsdWU7CgkJCX0sCgkJCWluaXRpYWxpemU6IGZ1bmN0aW9uKCBwdWJsaXNoZXIsIHN1YnNjcmliZXIsIGhhbmRsZXIsIG9wdGlvbnMgKSB7CgkJCQl2YXIgbWF0Y2g7CgkJCQlpZiAob3B0aW9ucyAmJiAobWF0Y2ggPSByRmlyc3RUb2tlbi5leGVjKCBvcHRpb25zICkpKSB7CgoJCQkJCXZhciBjb21wYXJlUGF0aCA9IHB1Ymxpc2hlci5jZCggbWF0Y2hbMV0gKS5wYXRoOwoJCQkJCWhhbmRsZXIub3B0aW9ucyA9IHsKCQkJCQkJY29tcGFyZVBhdGg6IGNvbXBhcmVQYXRoLAoJCQkJCQllcnJvcjogbWF0Y2hbM10KCQkJCQl9OwoKCQkJCQlwdWJsaXNoZXIuc3ViKCBjb21wYXJlUGF0aCwgImFmdGVyVXBkYXRlIiwgZnVuY3Rpb24oIGUgKSB7CgkJCQkJCWlmICghdGhpcy5pc0VtcHR5KCkpIHsKCQkJCQkJCXRyaWdnZXIoCgkJCQkJCQkJdGhpcy5wYXRoLAoJCQkJCQkJCXRoaXMucGF0aCwKCQkJCQkJCQkiY2hlY2tWYWxpZGl0eSIsCgkJCQkJCQkJdGhpcy5nZXQoKSAvL3Byb3Bvc2VkIHZhbHVlCgkJCQkJCQkpOwoJCQkJCQl9CgkJCQkJfSApOwoKCQkJCX0gZWxzZSB7CgkJCQkJdGhyb3cgImludmFsaWQgb3B0aW9ucyBmb3IgZXF1YWwgdmFsaWRhdG9yIjsKCQkJCX0KCQkJfQoJCX0sCgkJewoJCQluYW1lOiAicmVnZXgiLAoJCQllcnJvcjogIlBsZWFzZSBlbnRlciBhIHZhbHVlIG1hdGNoIHdpdGggcmVxdWlyZWQgcGF0dGVybi4iLAoJCQlpc1ZhbGlkOiBmdW5jdGlvbiggdmFsdWUsIG9wdGlvbnMgKSB7CgkJCQlyZXR1cm4gb3B0aW9ucy5yZWdleC50ZXN0KCB2YWx1ZSApOwoJCQl9LAoJCQlpbml0aWFsaXplOiBmdW5jdGlvbiggcHVibGlzaGVyLCBzdWJzY3JpYmVyLCBoYW5kbGVyLCBvcHRpb25zICkgewoJCQkJdmFyIG1hdGNoOwoKCQkJCWlmIChvcHRpb25zICYmIChtYXRjaCA9IHJSZWdFeC5leGVjKCBvcHRpb25zICkpKSB7CgkJCQkJaGFuZGxlci5vcHRpb25zID0gewoJCQkJCQlyZWdleDogZXZhbCggbWF0Y2hbMV0gKSwKCQkJCQkJZXJyb3I6IG1hdGNoWzVdCgkJCQkJfTsKCQkJCX0gZWxzZSB7CgkJCQkJdGhyb3cgImludmFsaWQgb3B0aW9ucyBmb3IgcmVnZXggdmFsaWRhdG9yIjsKCQkJCX0KCQkJfQoJCX0sCgkJewoJCQluYW1lOiAiZml4ZWRWYWx1ZSIsCgkJCWVycm9yOiAnUGxlYXNlIGVudGVyIHZhbHVlICJ7Zml4ZWRWYWx1ZX0iJywKCQkJaXNWYWxpZDogZnVuY3Rpb24oIHZhbHVlLCBvcHRpb25zICkgewoJCQkJcmV0dXJuIHZhbHVlID09IG9wdGlvbnMuZml4ZWRWYWx1ZTsKCQkJfSwKCQkJaW5pdGlhbGl6ZTogZnVuY3Rpb24oIHB1Ymxpc2hlciwgc3Vic2NyaWJlciwgaGFuZGxlciwgb3B0aW9ucyApIHsKCQkJCXZhciBtYXRjaDsKCQkJCWlmIChpc1N0cmluZyggb3B0aW9ucyApKSB7CgkJCQkJbWF0Y2ggPSAvXihcdyspKCwoLiopKSokLy5leGVjKCBvcHRpb25zICk7CgkJCQkJaWYgKG1hdGNoKSB7CgkJCQkJCWhhbmRsZXIub3B0aW9ucyA9IHsKCQkJCQkJCWZpeGVkVmFsdWU6IHRvVHlwZWRWYWx1ZSggbWF0Y2hbMV0gKSwKCQkJCQkJCWVycm9yOiBtYXRjaFszXQoJCQkJCQl9OwoJCQkJCX0KCQkJCX0gZWxzZSBpZiAoaXNPYmplY3QoIG9wdGlvbnMgKSkgewoKCQkJCQloYW5kbGVyLm9wdGlvbnMgPSBvcHRpb25zOwoKCQkJCX0gZWxzZSBpZiAoIWlzVW5kZWZpbmVkKCBvcHRpb25zICkpIHsKCgkJCQkJaGFuZGxlci5vcHRpb25zID0gewoJCQkJCQlmaXhlZFZhbHVlOiBvcHRpb25zCgkJCQkJfTsKCgkJCQl9IGVsc2UgewoJCQkJCXRocm93ICJtaXNzaW5nIG9wdGlvbnMgaW4gZml4ZWRWYWx1ZSB2YWxpZGF0b3IiOwoJCQkJfQoJCQl9LAoJCQlidWlsZEVycm9yOiBkZWZhdWx0RXJyb3JCdWlsZGVyCgkJfQoJXSApOwoKCWZ1bmN0aW9uIHJlc2V0VmFsaWRpdHkoIHBhdGggKSB7CgkJdmFyIGVycm9yc01vZGVsID0gaG0oIHBhdGggKyAiKmVycm9ycyIgKTsKCQlpZiAoIWVycm9yc01vZGVsLmlzRW1wdHkoKSkgewoJCQllcnJvcnNNb2RlbC5jbGVhcigpOwoJCQlpbnZhbGlkUGF0aHNNb2RlbC5yZW1vdmVJdGVtKCBwYXRoICk7CgkJfQoJfQoKCXZhciBpc1JlcXVpcmVkID0gaG0ud29ya2Zsb3coICJ2X3JlcXVpcmVkIiApLmdldDsKCglmdW5jdGlvbiBpc01vZGVsUmVxdWlyZWQoIHBhdGggKSB7CgkJdmFyIHN1YnNjcmlwdGlvbkJ5TW9kZWwgPSBobSggcGF0aCApLnN1YnNUb01lKCk7Ly8gc3Vic2NyaXB0aW9ucy5nZXRCeVB1Ymxpc2hlciggcGF0aCApOwoJCWZvciAodmFyIGkgPSAwOyBpIDwgc3Vic2NyaXB0aW9uQnlNb2RlbC5sZW5ndGg7IGkrKykgewoJCQl2YXIgc3Vic2NyaXB0aW9uID0gc3Vic2NyaXB0aW9uQnlNb2RlbFtpXTsKCQkJaWYgKHN1YnNjcmlwdGlvbi5oYW5kbGVyLmdldCA9PT0gaXNSZXF1aXJlZCkgewoJCQkJcmV0dXJuIHRydWU7CgkJCX0KCQl9CgkJcmV0dXJuIGZhbHNlOwoJfQoKCWZ1bmN0aW9uIGJ1aWxkRXJyb3JNZXNzYWdlKCB2YWxpZGF0b3IsIG9wdGlvbnMgKSB7CgoJCS8vbmFtZWQgdmFsaWRhdG9yIG5vcm1hbGx5IGhhcyBhIGRlZmF1bHRFcnJvcgoJCXZhciBkZWZhdWx0RXJyb3IgPSB2YWxpZGF0b3IubmFtZSAmJiBkZWZhdWx0T3B0aW9ucy5lcnJvcnNbdmFsaWRhdG9yLm5hbWVdOwoKCQkvL2lmIHZhbGlkYXRvciBoYXMgYnVpbGRFcnJvciBmdW5jdGlvbiwgdGhpcyB0YWtlIHRoZSBoaWdoZXN0IHByaW9yaXR5CgkJaWYgKHZhbGlkYXRvci5idWlsZEVycm9yKSB7CgoJCQkvL3JldHVybiB1c2VyRXJyb3IgfHwgZm9ybWF0LmFwcGx5KCBudWxsLCBbZGVmYXVsdEVycm9yXS5jb25jYXQoIG9wdGlvbnMubWlubGVuZ3RoICkgKTsKCQkJcmV0dXJuIHZhbGlkYXRvci5idWlsZEVycm9yKCBkZWZhdWx0RXJyb3IsIG9wdGlvbnMgKTsKCgkJCS8vaWYgZGVmYXVsdEVycm9yIGlzIGZvcm1hdCBzdHJpbmcsCgkJfSBlbHNlIHsKCgkJCS8vdXNlckVycm9yIGlzIG5vcm1hbGx5IHBhc3NlZCBpbiBvcHRpb25zIG9mIGVhY2ggaW5zdGFuY2UKCQkJdmFyIHVzZXJFcnJvciA9IGlzT2JqZWN0KCBvcHRpb25zICkgPyBvcHRpb25zLmVycm9yIDogb3B0aW9uczsKCgkJCWlmIChkZWZhdWx0RXJyb3IgJiYgZGVmYXVsdEVycm9yLmNvbnRhaW5zKCAiezB9IiApKSB7CgoJCQkJcmV0dXJuIGRlZmF1bHRFcnJvci5mb3JtYXQuYXBwbHkoIGRlZmF1bHRFcnJvciwgdXNlckVycm9yLnNwbGl0KCAiLCIgKSApOwoKCQkJfSBlbHNlIHsKCgkJCQlyZXR1cm4gdXNlckVycm9yIHx8IGRlZmF1bHRFcnJvciB8fCB2YWxpZGF0b3IuZXJyb3I7CgkJCX0KCQl9Cgl9CgoJZnVuY3Rpb24gYnVpbGRWYWxpZGF0aW9uV29ya2Zsb3dUeXBlKCB2YWxpZGF0b3IgKSB7CgoJCXJldHVybiB7CgoJCQlpbml0aWFsaXplOiB2YWxpZGF0b3IuaW5pdGlhbGl6ZSwKCgkJCWdldDogZnVuY3Rpb24oIGUgKSB7CgoJCQkJLy9pZiBpdCB2aW9sYXRlIHJlcXVpcmVkIHJ1bGUsIGRvbid0IGRvIGZ1cnRoZXIgdmFsaWRhdGlvbiwKCQkJCS8vYXMgd2UgZXhwZWN0IHRoZSByZXF1aXJlZCBydWxlIHdpbGwgY2FwdHVyZSBpdCBmaXJzdC4KCQkJCXZhciBpc1ZhbGlkLAoJCQkJCXZpb2xhdGVSZXF1aXJlZFJ1bGUsCgkJCQkJcHVibGlzaGVyID0gZS5wdWJsaXNoZXIsCgkJCQkJb3B0aW9ucyA9IGUuaGFuZGxlci5vcHRpb25zLAoJCQkJCXByb3Bvc2VkID0gZS5wcm9wb3NlZCwKCQkJCQllcnJvck1lc3NhZ2UgPSBidWlsZEVycm9yTWVzc2FnZSggdmFsaWRhdG9yLCBvcHRpb25zICk7CgoJCQkJLy9pZiBtb2RlbCBpcyBlbXB0eSwgb25seSBjaGVjayB0aGUgInJlcXVpcmUiIHZhbGlkYXRvcgoJCQkJLy9JZiBpdCBpcyByZXF1aXJlZCwgdGhlbiBpdCBpcyBpbnZhbGlkLCBubyBmdXJ0aGVyIHZhbGlkYXRpb24gaXMgY2hlY2tlZAoJCQkJLy9pZiBpdCBpcyBub3QgcmVxdWlyZWQsIGl0IGlzIHZhbGlkLCBubyBmdXJ0aGVyIHZhbGlkYXRpb24gaXMgY2hlY2tlZAoJCQkJaWYgKGlzRW1wdHlTdHJpbmcoIHByb3Bvc2VkICkpIHsKCgkJCQkJaWYgKGlzTW9kZWxSZXF1aXJlZCggcHVibGlzaGVyLnBhdGggKSkgewoJCQkJCQlpc1ZhbGlkID0gZmFsc2U7CgkJCQkJCXZpb2xhdGVSZXF1aXJlZFJ1bGUgPSB0cnVlOwoJCQkJCX0gZWxzZSB7CgkJCQkJCWlzVmFsaWQgPSB0cnVlOwoJCQkJCX0KCgkJCQl9IGVsc2UgewoKCQkJCQlpc1ZhbGlkID0gdmFsaWRhdG9yLmlzVmFsaWQoIHByb3Bvc2VkLCBvcHRpb25zICk7CgkJCQl9CgoJCQkJaWYgKCFpc1ZhbGlkKSB7CgoJCQkJCS8vYWRkIGVycm9yIHdoZW4gdGhlIGN1cnJlbnQgcnVsZSBpcyB0aGUgInJlcXVpcmVkIHJ1bGUiCgkJCQkJLy9vciB3aGVuICJyZXF1aXJlZCIgcnVsZSBpcyBub3QgdmlvbGF0ZWQKCQkJCQlpZiAoIXZpb2xhdGVSZXF1aXJlZFJ1bGUgfHwgdmFsaWRhdG9yLm5hbWUgPT09ICJyZXF1aXJlZCIpIHsKCQkJCQkJcHVibGlzaGVyLmFkZEVycm9yKCBlcnJvck1lc3NhZ2UgKTsKCQkJCQl9IGVsc2UgewoJCQkJCQlwdWJsaXNoZXIucmVtb3ZlRXJyb3IoIGVycm9yTWVzc2FnZSApOwoJCQkJCX0KCQkJCX0gZWxzZSB7CgkJCQkJcHVibGlzaGVyLnJlbW92ZUVycm9yKCBlcnJvck1lc3NhZ2UgKTsKCQkJCX0KCQkJfQoJCX07Cgl9CgoJZnVuY3Rpb24gdHJhdmVyc2VNb2RlbE5lZWRWYWxpZGF0aW9uKCBwYXRoLCBjYWxsYmFjayApIHsKCgkJLy90aGUgZm9sbG93aW5nIGNvZGUgdHJ5IHRvIHRyaWdnZXIgdGhlICJjaGVja1ZhbGlkaXR5IiBldmVudCwgc28gdGhhdCB0aGUgdmFsaWRhdG9yIHdpbGwKCQkvLyBiZSBjYWxsZWQgdG8gY2hlY2sgY3VycmVudCB2YWx1ZSBvZiB0aGUgbW9kZWwKCQkvL3lvdSBjYW4gbm90IGNhbGwgYWZ0ZXJVcGRhdGUsIGJlY2F1c2UgdGhlcmUgbWlnaHQgdHJpZ2dlciBvdGhlciBub24tdmFsaWRhdG9yIGhhbmRsZXIKCQkvL3RoYXQgYXJlIGF0dGFjaGVkIHRvIGFmdGVyVXBkYXRlCgkJdmFyIGFsbFN1YnNjcmlwdGlvbnMgPSBobS5zdWJzY3JpcHRpb24uZ2V0QWxsKCk7CgkJdmFyIGNoZWNrVmFsaWRpdHlkUGF0aHMgPSB7fTsKCgkJZm9yICh2YXIgaSA9IGFsbFN1YnNjcmlwdGlvbnMubGVuZ3RoIC0gMSwgc3Vic2NyaXB0aW9uLCBwdWJsaXNoZXJQYXRoOyBpID49IDA7IGktLSkgewoKCQkJc3Vic2NyaXB0aW9uID0gYWxsU3Vic2NyaXB0aW9uc1tpXTsKCQkJcHVibGlzaGVyUGF0aCA9IHN1YnNjcmlwdGlvbi5wdWJsaXNoZXI7CgoJCQl2YXIgaXNWYWxpZGF0aW9uUmVxdWlyZWQgPQoJCQkJaXNTdHJpbmcoIHB1Ymxpc2hlclBhdGggKSAmJiAhY2hlY2tWYWxpZGl0eWRQYXRoc1twdWJsaXNoZXJQYXRoXSAmJgoJCQkJcHVibGlzaGVyUGF0aC5zdGFydHNXaXRoKCBwYXRoICkgJiYKCQkJCXN1YnNjcmlwdGlvbi5ldmVudFR5cGVzLmNvbnRhaW5zKCAiY2hlY2tWYWxpZGl0eSIgKTsKCgkJCWlmIChpc1ZhbGlkYXRpb25SZXF1aXJlZCkgewoKCQkJCWNoZWNrVmFsaWRpdHlkUGF0aHNbcHVibGlzaGVyUGF0aF0gPSB0cnVlOwoJCQkJY2FsbGJhY2soIHB1Ymxpc2hlclBhdGggKTsKCgkJCX0KCQl9Cgl9CgoJZnVuY3Rpb24gaXNFbXB0eVN0cmluZyggdmFsdWUgKSB7CgkJcmV0dXJuIHZhbHVlID09PSBudWxsIHx8IHZhbHVlID09PSB1bmRlZmluZWQgfHwgckVtcHR5LnRlc3QoIHZhbHVlICk7Cgl9CgovLwovLzxAZGVwZW5kcz5zdWJzY3JpcHRpb24uanMsIG1vZGVsLmpzLCBkZWNsYXJhdGl2ZS5qcywgdGVtcGxhdGUuanM8L0BkZXBlbmRzPgoKCgkvL3RoZSBjb252ZW50aW9uIGhlcmUgaXMgdGhhdCAsCgkvLyB1c2Ugcm93VmlldyBmb3IgdGhlIHJvdyBpbiB2aWV3CgkvL3VzZSBpdGVtIGZvciB0aGUgaXRlbSBpbiBtb2RlbCBhcnJheQoKCWhtLndvcmtmbG93KCB7CgoJCS8vLS0tLS0tLS0tLXdvcmtmbG93IHR5cGUgd2hpY2ggbW9kaWZ5IHJvdyBpbiBsaXN0IHZpZXctLS0tLS0tLS0tLQoKCQkvLyFhZnRlckNyZWF0ZS4xOmFycmF5fCphZGRSb3dWaWV3OwoJCWFkZFJvd1ZpZXc6IG5ld1RlbXBsYXRlSGFuZGxlcigKCgkJCS8vdGhlIHJlYXNvbiB0byB1c2UgZ2V0T3JpZ2luYWwgaXMgdGhhdAoJCQkvL3RoZSBzdWJzY3JpcHRpb24gaXMgdGhlIGl0ZW1zIGFycmF5CgkJCS8vYnV0IGhlcmUgd2Ugd2FudCB0byB0aGUgZWxlbQoJCQkiKmdldE9yaWdpbmFsIiwKCgkJCWZ1bmN0aW9uKCByb3dWaWV3LCBlICkgewoKCQkJCXZhciByb3dDb250YWluZXIgPSB0aGlzLAoJCQkJCXJvd3MgPSByb3dDb250YWluZXIuY2hpbGRyZW4oKTsKCgkJCQlpZiAocm93cy5sZW5ndGggPT09IDApIHsKCgkJCQkJcm93Q29udGFpbmVyLmFwcGVuZCggcm93VmlldyApOwoKCQkJCX0gZWxzZSB7CgoJCQkJCS8vdGhlIGluc2VydCBtYXkgbm90IGhhcHBlbiBhdCB0aGUgZW5kIG9mIHRoZSBhcnJheQoJCQkJCS8vYXQgY2FuIGJlIGluc2VydCBpbiB0aGUgbWlkZGxlLCBzbwoJCQkJCS8vd2UgY2FuIG5vdCBzaW1wbHkgZG8gc3Vic2NyaWJlci5hcHBlbmQoKQoJCQkJCS8vd2UgbmVlZCB0byBhcHBlbmQgdGhlIHJvdyB2aWV3IGF0IHRoZSBpbmRleAoJCQkJCXZhciBpbmRleCA9ICtlLm9yaWdpbmFsUHVibGlzaGVyLnBhdGhJbmRleCgpOwoKCQkJCQkvL3JvdyB6ZXJvIGlzIHNwZWNpYWwsIG5lZWQgdG8gdXNlIGJlZm9yZSBtZXRob2QKCQkJCQlpZiAoaW5kZXggPT09IDApIHsKCgkJCQkJCXJvd3MuZXEoIDAgKS5iZWZvcmUoIHJvd1ZpZXcgKTsKCQkJCQl9IGVsc2UgewoJCQkJCQlyb3dzLmVxKCBpbmRleCAtIDEgKS5hZnRlciggcm93VmlldyApOwoJCQkJCX0KCQkJCX0KCQkJfQoJCSksCgoJCS8vIWFmdGVyVXBkYXRlLjE6YXJyYXl8KnVwZGF0ZVJvd1ZpZXcKCQl1cGRhdGVSb3dWaWV3OiBuZXdUZW1wbGF0ZUhhbmRsZXIoCgoJCQkiKmdldE9yaWdpbmFsIiwKCgkJCWZ1bmN0aW9uKCB2YWx1ZSwgZSApIHsKCQkJCXRoaXMuY2hpbGRyZW4oKS5lcSggK2Uub3JpZ2luYWxQdWJsaXNoZXIucGF0aEluZGV4KCkgKS5yZXBsYWNlV2l0aCggdmFsdWUgKTsKCQkJfSApLAoKCQkvLyFhZnRlckRlbC4xOmFycmF5fCpyZW1vdmVSb3dWaWV3OwoJCXJlbW92ZVJvd1ZpZXc6IGZ1bmN0aW9uKCBlICkgewoJCQl0aGlzLmNoaWxkcmVuKCkuZXEoICtlLm9yaWdpbmFsUHVibGlzaGVyLnBhdGhJbmRleCgpICkucmVtb3ZlKCk7CgkJfQoKCgl9ICk7CgoJLy9hdXRvUXVlcnkgbWVhbnMgdXNlciBkb24ndCBuZWVkIHRvIHRyaWdnZXIgc2VhcmNoIGJ1dHRvbgoJLy9xdWVyeSByZXN1bHQgd2lsbCBhdXRvbWF0aWNhbGx5IHVwZGF0ZWQgd2hlbgoJLy9xdWVyeSBjaGFuZ2UsIGJ5IGRlZmF1bHQgaXQgaXMgZmFsc2UKCS8vd2hpY2ggbWVhbnMgdXNlciBoYXMgcmVmcmVzaFF1ZXJ5IG1hbnVhbGx5CglobUZuLmVuYWJsZVF1ZXJ5ID0gZnVuY3Rpb24oIGF1dG9RdWVyeSApIHsKCgkJaWYgKHRoaXMuZ2V0KCAiKnF1ZXJ5IiApKSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJdmFyIHF1ZXJ5YWJsZSwKCQkJcXVlcnksCgkJCXNvcnQsCgkJCXBhZ2VyLAoJCQlmaWx0ZXJGbiwKCQkJZmlsdGVyLAoJCQlpdGVtcyA9IHRoaXMuZ2V0KCksCgkJCXF1ZXJ5Tm9kZSA9IHRoaXMuY2QoICIqcXVlcnkiICksCgkJCXF1ZXJ5UmVzdWx0Tm9kZSA9IHRoaXMuY2QoICIqcXVlcnlSZXN1bHQiICksCgkJCWhhc1F1ZXJ5UmVzdWx0Tm9kZSA9IHRoaXMuY2QoICIqaGFzUXVlcnlSZXN1bHQiICksCgkJCXBhZ2VyTm9kZSA9IHF1ZXJ5Tm9kZS5jZCggInBhZ2VyIiApLAoJCQlmaWx0ZXJOb2RlID0gcXVlcnlOb2RlLmNkKCAiZmlsdGVyIiApLAoJCQlmaWx0ZXJFbmFibGVkTm9kZSA9IGZpbHRlck5vZGUuY2QoICJlbmFibGVkIiApLAoJCQlzb3J0Tm9kZSA9IHF1ZXJ5Tm9kZS5jZCggInNvcnQiICk7CgoJCWF1dG9RdWVyeSA9ICEhYXV0b1F1ZXJ5OwoKCQlpZiAoYXV0b1F1ZXJ5KSB7CgkJCS8vaXRlbXMqcXVlcnlSZXN1bHQgLS0tcmVmZXJlbmNpbmctLT4gaXRlbXMqcXVlcnkKCQkJcXVlcnlSZXN1bHROb2RlLndhdGNoKCBxdWVyeU5vZGUucGF0aCApOwoJCX0KCgkJLy9pdGVtcypxdWVyeVJlc3VsdCAtLT4gaXRlbXMKCQlxdWVyeVJlc3VsdE5vZGUud2F0Y2goIHRoaXMucGF0aCApOwoKCQl0aGlzLmV4dGVuZCgKCQkJIioiLAoJCQlxdWVyeWFibGUgPSB7CgoJCQkJLy9pZiBpdCBpcyB0cnVlLCByZWZyZXNoUXVlcnkgaXMgYnlwYXNzZWQKCQkJCWF1dG9RdWVyeTogYXV0b1F1ZXJ5LAoKCQkJCWhhc1F1ZXJ5UmVzdWx0OiBmYWxzZSwKCgkJCQkvL3RoZSBvYmplY3QgaG9sZGluZyB0aGUgZGF0YSBhYm91dCBwYWdpbmcsIHNvcnRpbmcsIGFuZCBmaWx0ZXJpbmcKCQkJCXF1ZXJ5OiBxdWVyeSA9IHsKCQkJCQlwYWdlcjogcGFnZXIgPSB7CgkJCQkJCWVuYWJsZWQ6IGZhbHNlLAoJCQkJCQlpbmRleDogMCwgLy9udGggcGFnZQoJCQkJCQljb3VudDogMSwKCQkJCQkJc2l6ZTogMAoJCQkJCX0sCgkJCQkJc29ydDogc29ydCA9IHsKCQkJCQkJYnk6IG51bGwsIC8vY3VycmVudGx5IHdlIG9ubHkgc3VwcG9ydCBzb3J0IGJ5IG9uZSBjb2x1bW4gc29ydAoJCQkJCQlhc2M6IG51bGwKCQkJCQl9LAoJCQkJCWZpbHRlcjogZmlsdGVyID0gewoJCQkJCQlieTogIiIsCgkJCQkJCXZhbHVlOiAiIiwKCQkJCQkJb3BzOiAiIiwKCQkJCQkJZW5hYmxlZDogZmFsc2UKCQkJCQl9LAoJCQkJCS8vaXMgcXVlcnkgZW5hYmxlZAoJCQkJCWVuYWJsZWQ6IGZ1bmN0aW9uKCkgewoJCQkJCQlyZXR1cm4gdGhpcy5nZXQoICJwYWdlci5lbmFibGVkIiApIHx8IHRoaXMuZ2V0KCAic29ydC5ieSIgKSB8fCB0aGlzLmdldCggImZpbHRlci5lbmFibGVkIiApOwoJCQkJCX0KCQkJCX0sCgoJCQkJcXVlcnlSZXN1bHQ6IGZ1bmN0aW9uKCBkaXNhYmxlUGFnaW5nICkgewoKCQkJCQkvLyJ0aGlzIiByZWZlcnMgdG8gdGhlIHF1ZXJ5YWJsZSBub2RlIGJ1dCBub3QgdGhlIHF1ZXJ5YWJsZSBvYmplY3QKCQkJCQl2YXIgJGl0ZW1zID0gJCggaXRlbXMgKSwKCgkJCQkJLy9ydW4gZmlsdGVyCgkJCQkJCXJ0biA9IGZpbHRlckZuID8gJGl0ZW1zLmZpbHRlciggZmlsdGVyRm4gKS5nZXQoKSA6ICRpdGVtcy5nZXQoKTsKCgkJCQkJaGFzUXVlcnlSZXN1bHROb2RlLnVwZGF0ZSggcnRuLmxlbmd0aCA+IDAgKTsKCgkJCQkJLy9ydW4gc29ydAoJCQkJCWlmIChzb3J0LmJ5KSB7CgoJCQkJCQlydG4uc29ydE9iamVjdCggc29ydC5ieSwgc29ydC5hc2MgKTsKCQkJCQl9CgoJCQkJCS8vcnVuIHBhZ2luZwoJCQkJCWlmICghZGlzYWJsZVBhZ2luZyAmJiBwYWdlci5lbmFibGVkKSB7CgkJCQkJCXZhciBjb3VudCA9IE1hdGguY2VpbCggcnRuLmxlbmd0aCAvIHBhZ2VyLnNpemUgKSB8fCAxOwoJCQkJCQlpZiAoY291bnQgIT0gcGFnZXIuY291bnQpIHsKCQkJCQkJCXBhZ2VyLmNvdW50ID0gY291bnQ7CgkJCQkJCQlpZiAocGFnZXIuaW5kZXggPiBwYWdlci5jb3VudCAtIDEpIHsKCQkJCQkJCQlwYWdlci5pbmRleCA9IDA7CgkJCQkJCQl9CgkJCQkJCQkvLwoJCQkJCQkJcXVlcnlOb2RlLmNoYW5nZSggInBhZ2VyIiApOwoJCQkJCQl9CgkJCQkJCXJ0biA9IHJ0bi5zbGljZSggcGFnZXIuaW5kZXggKiBwYWdlci5zaXplLCAocGFnZXIuaW5kZXggKyAxKSAqIHBhZ2VyLnNpemUgKTsKCQkJCQl9CgoJCQkJCXJldHVybiBydG47CgkJCQl9LAoKCQkJCS8vIHJlZnJlc2hRdWVyeSBjYW4gYmUgY2FsbGVkIHZpYSBxdWVyeWFibGUucmVmcmVzaFF1ZXJ5KCkKCQkJCS8vb3IgaXQgY2FuIGJlIGNhbGxlZCB2aWEgbm9kZSBsaWtlIGl0ZW1zKnJlZnJlc2hRdWVyeQoJCQkJLy8KCQkJCS8vIHJlZnJlc2hRdWVyeSBjYW4gYmUgY2FsbGVkIHJlZ2FyZGxlc3Mgd2hldGhlciBhdXRvUXVlcnkgaXMgZW5hYmxlZCwKCQkJCS8vIGJlY2F1c2UgaW50ZXJuYWxseSBpdCBjaGVjayB0aGUgZmxhZyB0byBkZXRlcm1pbmUgaWYKCQkJCS8vIGl0IGlzIG5lY2Vzc2FyeSB0byB0cmlnZ2VyIHRoZSBjaGFuZ2UgZXZlbnQKCQkJCXJlZnJlc2hRdWVyeTogZnVuY3Rpb24oKSB7CgkJCQkJLy9pZiBhdXRvUXVlcnkgaXMgdHJ1ZSwgdGhlbiBkb24ndCBuZWVkIHRvIHRyaWdnZXIgY2hhbmdlIGFnYWluCgkJCQkJaWYgKCFxdWVyeWFibGUuYXV0b1F1ZXJ5KSB7CgkJCQkJCXNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCQkJCQkJcXVlcnlSZXN1bHROb2RlLnRyaWdnZXIoICJhZnRlclVwZGF0ZSIgKTsKCQkJCQkJfSwgMCApOwoJCQkJCX0KCQkJCX0sCgoJCQkJcGFnaW5nOiBmdW5jdGlvbiggZSApIHsKCgkJCQkJdmFyIGluZGV4ID0gZS5ldmVudERhdGE7CgoJCQkJCWlmIChyRGlnaXQudGVzdCggaW5kZXggKSkgewoKCQkJCQkJaW5kZXggPSAraW5kZXg7CgoJCQkJCX0gZWxzZSB7CgoJCQkJCQlpZiAoaW5kZXggPT0gIm5leHQiKSB7CgoJCQkJCQkJaW5kZXggPSBwYWdlci5pbmRleCArIDE7CgoJCQkJCQl9IGVsc2UgaWYgKGluZGV4ID09ICJwcmV2aW91cyIpIHsKCgkJCQkJCQlpbmRleCA9IHBhZ2VyLmluZGV4IC0gMTsKCgkJCQkJCX0gZWxzZSBpZiAoaW5kZXggPT0gImZpcnN0IikgewoKCQkJCQkJCWluZGV4ID0gMDsKCgkJCQkJCX0gZWxzZSBpZiAoaW5kZXggPT0gImxhc3QiKSB7CgoJCQkJCQkJaW5kZXggPSBwYWdlci5jb3VudCAtIDE7CgoJCQkJCQl9IGVsc2UgaWYgKGluZGV4ID09ICJkaXNhYmxlZCIpIHsKCQkJCQkJCWluZGV4ID0gMDsKCQkJCQkJCXF1ZXJ5YWJsZS5yZXNldFBhZ2luZygpOwoJCQkJCQl9CgkJCQkJfQoKCQkJCQlpZiAodHlwZW9mIGluZGV4ICE9PSAibnVtYmVyIiB8fCBpbmRleCA8IDAgfHwgaW5kZXggPiBwYWdlci5jb3VudCAtIDEpIHsKCQkJCQkJaW5kZXggPSAwOwoJCQkJCX0KCgkJCQkJcGFnZXJOb2RlLnVwZGF0ZSggImluZGV4IiwgaW5kZXggKTsKCQkJCQlxdWVyeWFibGUucmVmcmVzaFF1ZXJ5KCk7CgkJCQl9LAoKCQkJCXJlc2V0U29ydDogZnVuY3Rpb24oIHRyaWdnZXJCeU1hc3RlclJlc2V0ICkgewoJCQkJCXNvcnROb2RlLnNldCggImJ5IiwgbnVsbCApCgkJCQkJCS5zZXQoICJhc2MiLCBudWxsICk7CgoJCQkJCWlmICh0cmlnZ2VyQnlNYXN0ZXJSZXNldCAhPT0gdHJ1ZSkgewoJCQkJCQlxdWVyeWFibGUucmVmcmVzaFF1ZXJ5KCk7CgkJCQkJfQoJCQkJfSwKCgkJCQlyZXNldFNlYXJjaDogZnVuY3Rpb24oIHRyaWdnZXJCeU1hc3RlclJlc2V0ICkgewoJCQkJCWZpbHRlck5vZGUudXBkYXRlKCAiYnkiLCAiIiApCgkJCQkJCS51cGRhdGUoICJ2YWx1ZSIsICIiICkKCQkJCQkJLnVwZGF0ZSggIm9wcyIsICIiICk7CgoJCQkJCWlmICh0cmlnZ2VyQnlNYXN0ZXJSZXNldCAhPT0gdHJ1ZSkgewoJCQkJCQlxdWVyeWFibGUucmVmcmVzaFF1ZXJ5KCk7CgkJCQkJfQoKCQkJCX0sCgoJCQkJcmVzZXRQYWdpbmc6IGZ1bmN0aW9uKCB0cmlnZ2VyQnlNYXN0ZXJSZXNldCApIHsKCQkJCQlwYWdlck5vZGUudXBkYXRlKCAiZW5hYmxlZCIsIGZhbHNlICkKCQkJCQkJLnVwZGF0ZSggInNpemUiLCAwICkKCQkJCQkJLnVwZGF0ZSggImNvdW50IiwgMSApCgkJCQkJCS51cGRhdGUoICJpbmRleCIsIDAgKTsKCgkJCQkJaWYgKHRyaWdnZXJCeU1hc3RlclJlc2V0ICE9PSB0cnVlKSB7CgkJCQkJCXF1ZXJ5YWJsZS5yZWZyZXNoUXVlcnkoKTsKCQkJCQl9CgoJCQkJfSwKCgkJCQlyZXNldFF1ZXJ5OiBmdW5jdGlvbigpIHsKCQkJCQlxdWVyeWFibGUucmVzZXRTb3J0KCB0cnVlICk7CgkJCQkJcXVlcnlhYmxlLnJlc2V0U2VhcmNoKCB0cnVlICk7CgkJCQkJcXVlcnlhYmxlLnJlc2V0UGFnaW5nKCB0cnVlICk7CgkJCQkJcXVlcnlhYmxlLnJlZnJlc2hRdWVyeSgpOwoJCQkJfQoJCQl9CgkJKTsKCgkJZnVuY3Rpb24gYnVpbGRGaWx0ZXJGbiggZSApIHsKCQkJdmFyIG9wcyA9IGZpbHRlci5vcHMsCgkJCQlieSA9IGZpbHRlci5ieSwKCQkJCXZhbHVlID0gZmlsdGVyLnZhbHVlLAoJCQkJcmVnZXg7CgoJCQlpZiAodmFsdWUpIHsKCgkJCQlpZiAoIW9wcykgewoJCQkJCS8vYnkgZGVmYXVsdCBpdCBzIGNvbnRhaW5zCgkJCQkJcmVnZXggPSBSZWdFeHAoIHZhbHVlLCAiaSIgKTsKCgkJCQl9IGVsc2UgaWYgKG9wcyA9PSAiZXF1YWxzIikgewoKCQkJCQlyZWdleCA9IFJlZ0V4cCggIl4iICsgdmFsdWUgKyAiJCIsICJpIiApOwoKCQkJCX0gZWxzZSB7CgoJCQkJCXRocm93ICJvcGVyYXRvciBkb2VzIG5vdCBzdXBwb3J0ZWQiOwoJCQkJfQoKCQkJCWZpbHRlckZuID0gKGJ5KSA/CgkJCQkJZnVuY3Rpb24oKSB7CgkJCQkJCXJldHVybiByZWdleC50ZXN0KCB0aGlzW2J5XSApOwoJCQkJCX0gOgoJCQkJCWZ1bmN0aW9uKCkgewoJCQkJCQlpZiAoaXNPYmplY3QoIHRoaXMgKSkgewoJCQkJCQkJZm9yICh2YXIga2V5IGluIHRoaXMpIHsKCQkJCQkJCQlpZiAocmVnZXgudGVzdCggdGhpc1trZXldICkpIHsKCQkJCQkJCQkJcmV0dXJuIHRydWU7CgkJCQkJCQkJfQoJCQkJCQkJfQoJCQkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJCQl9IGVsc2UgewoJCQkJCQkJcmV0dXJuIHJlZ2V4LnRlc3QoIHRoaXMgKTsKCQkJCQkJfQoJCQkJCX07CgoJCQkJZmlsdGVyRW5hYmxlZE5vZGUuc2V0KCB0cnVlICk7CgkJCQlxdWVyeWFibGUucmVmcmVzaFF1ZXJ5KCk7CgkJCX0gZWxzZSB7CgkJCQlpZiAoZmlsdGVyRm4pIHsKCQkJCQlmaWx0ZXJGbiA9IG51bGw7CgkJCQkJZmlsdGVyRW5hYmxlZE5vZGUuc2V0KCBmYWxzZSApOwoJCQkJCXF1ZXJ5YWJsZS5yZWZyZXNoUXVlcnkoKTsKCQkJCX0KCQkJfQoJCX0KCgkJZmlsdGVyTm9kZS5jZCggImJ5IiApLmhhbmRsZSggImFmdGVyVXBkYXRlIiwgYnVpbGRGaWx0ZXJGbiApOwoJCWZpbHRlck5vZGUuY2QoICJ2YWx1ZSIgKS5oYW5kbGUoICJhZnRlclVwZGF0ZSIsIGJ1aWxkRmlsdGVyRm4gKTsKCQlmaWx0ZXJOb2RlLmNkKCAib3BzIiApLmhhbmRsZSggImFmdGVyVXBkYXRlIiwgYnVpbGRGaWx0ZXJGbiApOwoJCXJldHVybiB0aGlzOwoJfTsKCgliaW5kaW5ncyggewoKCQkvL2xpc3RWaWV3OmFycmF5UGF0aHxyb3dUZW1wbGF0ZUlkCgkJLy8KCQlsaXN0VmlldzogLy8KCgkJLy9zdWJzY3JpcHRpb24gZnJvbSB2aWV3CgkJCSJ0bXBsT25DaGFuZ2U6LjsiICsKCQkJCS8vcmVuZGVyIG5ld2x5IGFwcGVuZGVkIGRhdGEgaXRlbSBieSBhcHBlbmRpbmcgaXQgdG8gZW5kIG9mIHRoZSB2aWV3CgkJCSIhYWZ0ZXJDcmVhdGUuMToufCphZGRSb3dWaWV3OyIgKwoJCQkJLy9yZW5kZXIgdGhlIHVwZGF0ZWQgZGF0YSBpdGVtIGluIHRoZSB2aWV3CgkJCSIhYWZ0ZXJVcGRhdGUuMToufCp1cGRhdGVSb3dWaWV3OyIgKwoJCQkJLy9kZWxldGUgdGhlIGRlbGV0ZWQgZGF0YSBpdGVtIGluIHRoZSB2aWV3CgkJCSIhYWZ0ZXJEZWwuMToufCpyZW1vdmVSb3dWaWV3IiwKCgkJZW5hYmxlUXVlcnk6IGZ1bmN0aW9uKCBlbGVtLCBwYXRoLCBjb250ZXh0LCBvcHRpb25zICkgewoJCQlobSggcGF0aCApLmVuYWJsZVF1ZXJ5KCAhIW9wdGlvbnMgKTsKCQl9LAoKCQkvL3JlbmRlciB0aGUgd2hvbGUgbGlzdCBvZiBpdGVtcwoJCS8vcXVlcnlWaWV3Oml0ZW1zCgkJcXVlcnlWaWV3OiAidG1wbE9uQW55Q2hhbmdlOipxdWVyeVJlc3VsdCIsCgoJCS8vc29ydDppdGVtc3xmaXJzdE5hbWUKCQlzb3J0UXVlcnk6ICIkY2xpY2s6KnF1ZXJ5LnNvcnQuYnl8KnNldFRvOyIgKwoJCSAgICAgICAgICAgICAgICAgIiRjbGljazoqcXVlcnkuc29ydC5hc2N8KnRvZ2dsZTsiICsKCQkgICAgICAgICAgICAgICAgICIkY2xpY2s6KnJlZnJlc2hRdWVyeSIsCgoJCS8vcmVzZXRTb3J0Oml0ZW1zCgkJcmVzZXRTb3J0OiAiJGNsaWNrOipyZXNldFNvcnQ7IiArCgkJICAgICAgICAgICAgICAgICAic2hvdzoqcXVlcnkuc29ydC5ieSIsCgoJCS8vc2VhcmNoOml0ZW1zCgkJc2VhcmNoOiAiJGNsaWNrOipyZWZyZXNoUXVlcnk7IiArCgkJICAgICAgICAgICAgICAiZW5hYmxlOipxdWVyeS5maWx0ZXIuZW5hYmxlZCIsCgoJCXJlc2V0U2VhcmNoOiAiJGNsaWNrOipyZXNldFNlYXJjaDsiICsKCQkgICAgICAgICAgICAgICAgICAgInNob3c6KnF1ZXJ5LmZpbHRlci5lbmFibGVkIiwKCgkJcmVzZXRRdWVyeTogIiRjbGljazoqcmVzZXRRdWVyeTsiICsKCQkgICAgICAgICAgICAgICAgICAic2hvdzoqcXVlcnkuZW5hYmxlZCIsCgoJCXNlYXJjaEJveDogIm5zOipxdWVyeS5maWx0ZXIudmFsdWU7IiArCgkJICAgICAgICAgICAidmFsOi58ZW50ZXI7IiArCgkJICAgICAgICAgICAiJGVzYzoufCpudWxsIiwKCgkJLy9wYWdlcjppdGVtc3wjcGFnZXJUZW1wbGF0ZQoJCXBhZ2VyOiAidG1wbE9uQW55Q2hhbmdlOipxdWVyeS5wYWdlcjsiICsgLy9yZW5kZXIgcGFnZXIgdXNpbmcgdGhlIGRhdGEgdW5kZXIgaXRlbXMqcXVlcnkucGFnZXIKCQkgICAgICAgInNob3c6Kmhhc1F1ZXJ5UmVzdWx0fF87IiArCgkJICAgICAgICIkcGFnaW5nOipwYWdpbmc7IiArCgkJICAgICAgICJwcmV2ZW50RGVmYXVsdDouIiwKCgkJc2V0UGFnZTogInRydWU6KnF1ZXJ5LnBhZ2VyLmVuYWJsZWQ7IiArCgkJICAgICAgICAgICAgICAgImVuYWJsZToqcXVlcnkucGFnZXIuc2l6ZTsiICsKCQkgICAgICAgICAgICAgICAiJGNsaWNrOipyZWZyZXNoUXVlcnkiLAoKCQkvL3BhdGggaXMgaWdub3JlLCBkb2VzIG5vdCBjcmVhdGUgYW55IHN1YnNjcmlwdGlvbgoJCXBhZ2U6IGZ1bmN0aW9uKCBlbGVtLCBwYXRoLCBiaW5kaW5nLCBwYWdlSW5kZXggKSB7CgkJCWlmICghcGFnZUluZGV4KSB7CgkJCQl0aHJvdyAicGFnZUluZGV4IGlzIG1pc3NpbmciOwoJCQl9CgkJCSQoIGVsZW0gKS5tYXBFdmVudCggImNsaWNrIiwgInBhZ2luZyIsIHBhZ2VJbmRleCApOwoJCX0sCgoJCXNob3dGb3VuZDogInNob3c6Kmhhc1F1ZXJ5UmVzdWx0IiwKCgkJaGlkZUZvdW5kOiAiaGlkZToqaGFzUXVlcnlSZXN1bHQiCgl9ICk7CgoKCi8vCi8qCiA8QGRlcGVuZHM+CiBzdWJzY3JpcHRpb24uanMsCiBtb2RlbC5qcwogPC9AZGVwZW5kcz4KICovCgoKCS8vY3JlYXRlIGEgdGFibGUgd2l0aCBzb21lIHNlZWRzCglmdW5jdGlvbiBjcmVhdGVUYWJsZSggc2VlZHMgKSB7CgkJaWYgKGlzVW5kZWZpbmVkKCBzZWVkcyApKSB7CgkJCXNlZWRzID0gW107CgkJfSBlbHNlIGlmICghaXNBcnJheSggc2VlZHMgKSkgewoJCQlzZWVkcyA9IFtzZWVkc107CgkJfQoKCQlpZiAoc2VlZHMudGFibGUgJiYgc2VlZHMuZ3VpZCkgewoJCQlyZXR1cm4gc2VlZHM7CgkJfQoKCQlzZWVkcy50YWJsZSA9IHt9OwoJCXNlZWRzLmd1aWQgPSAwOwoJCXJldHVybiBzZWVkczsKCX0KCglmdW5jdGlvbiBoYW5kbGVBcnJheU5vZGVVcGRhdGVEZXNjZW5kYW50KCBlICkgewoKCQl2YXIgdGFibGUsCgkJCXB1Ymxpc2hlciA9IGUucHVibGlzaGVyOwoKCQlpZiAoZS5sZXZlbCA9PT0gMSkgewoJCQl0YWJsZSA9IHB1Ymxpc2hlci5nZXQoKS50YWJsZTsKCgkJCS8vdGhlIGV2ZW50IGlzIGNhdXNlZCBieSB1cGRhdGluZyB0byB0aGUgYW4gaXRlbSBpZiB0aGUgYXJyYXkKCQkJZm9yICh2YXIga2V5IGluIHRhYmxlKSB7CgkJCQlpZiAodGFibGVba2V5XSA9PSBlLnJlbW92ZWQpIHsKCQkJCQl0aGlzLnNldCgga2V5LCBlLnByb3Bvc2VkICk7CgkJCQkJYnJlYWs7CgkJCQl9CgkJCX0KCgkJfSBlbHNlIGlmIChlLmxldmVsID49IDIpIHsKCgkJCXZhciBvcmlnaW5hbFBhdGggPSBlLm9yaWdpbmFsUHVibGlzaGVyLnBhdGgsCgkJCQlwYXRoID0gcHVibGlzaGVyLnBhdGgsCgkJCQlyZW1haW5pbmcgPSBvcmlnaW5hbFBhdGguc3Vic3RyKCBwYXRoLmxlbmd0aCArIDEgKSwKCQkJCWluZGV4ID0gcmVtYWluaW5nLnN1YnN0ciggMCwgcmVtYWluaW5nLmluZGV4T2YoICIuIiApICk7CgoJCQlpZiAoJC5pc051bWVyaWMoIGluZGV4ICkpIHsKCgoJCQkJLy9lLmcgY29udGFjdHMuMS5maXJzdE5hbWUgaXMgdXBkYXRlZAoJCQkJLy9pbmRleCA9PSAxCgkJCQkvL2l0ZW1LZXkgPSBjMQoKCQkJCXZhciBpdGVtS2V5ID0gcHVibGlzaGVyLmtleUF0KCBpbmRleCApLAoJCQkJCWZ1bGxQYXRoT2ZLZXlJdGVtID0gInRhYmxlLiIgKyBpdGVtS2V5ICsgcmVtYWluaW5nLnN1YnN0ciggcmVtYWluaW5nLmluZGV4T2YoICIuIiApICk7CgoJCQkJLy9zdWJQYXRoID09IHRhYmxlLmMxLmZpcnN0TmFtZQoJCQkJcHVibGlzaGVyLnRyaWdnZXIoIGZ1bGxQYXRoT2ZLZXlJdGVtLCAiYWZ0ZXJVcGRhdGUiLCBlLnByb3Bvc2VkLCBlLnJlbW92ZWQgKTsKCQkJfQoJCX0KCX0KCglmdW5jdGlvbiBoYW5kbGVBcnJheU5vZGVDcmVhdGVDaGlsZCggZSApIHsKCQl0aGlzLnNldCggZS5wdWJsaXNoZXIuZ2V0KCkuZ3VpZCsrLCBlLnByb3Bvc2VkICk7Cgl9CgoJZnVuY3Rpb24gaGFuZGxlQXJyYXlOb2RlRGVsZXRlQ2hpbGQoIGUgKSB7CgkJdmFyIHRhYmxlID0gdGhpcy5nZXQoKSwKCQkJcmVtb3ZlZCA9IGUucmVtb3ZlZDsKCgkJZm9yICh2YXIga2V5IGluIHRhYmxlKSB7CgkJCWlmICh0YWJsZVtrZXldID09PSByZW1vdmVkKSB7CgkJCQl0aGlzLmRlbCgga2V5ICk7CgkJCQlicmVhazsKCQkJfQoJCX0KCX0KCglmdW5jdGlvbiBoYW5kbGVUYWJsZU5vZGVEZWxldGVDaGlsZCggZSApIHsKCQl0aGlzLnJlbW92ZUl0ZW0oIGUucmVtb3ZlZCApOwoJfQoKCWZ1bmN0aW9uIGhhbmRsZVRhYmxlTm9kZVVwZGF0ZUNoaWxkKCBlICkgewoJCXRoaXMucmVwbGFjZUl0ZW0oIGUucmVtb3ZlZCwgZS5wcm9wb3NlZCApOwoJfQoKCS8vCQkJb25BZGRPclVwZGF0ZUhhbmRsZXJzW2ldKCBjb250ZXh0UGF0aCwgaW5kZXhQYXRoLCBtb2RlbFZhbHVlICk7CglobS5vbkFkZE9yVXBkYXRlTm9kZSggZnVuY3Rpb24oIGNvbnRleHQsIGluZGV4LCBhcnJheSApIHsKCgkJaWYgKCFpc0FycmF5KCBhcnJheSApKSB7CgkJCXJldHVybjsKCQl9CgoJCXZhciB0YWJsZSA9IGNyZWF0ZVRhYmxlKCBhcnJheSApLnRhYmxlOwoKCQlmb3IgKHZhciBpID0gMDsgaSA8IGFycmF5Lmxlbmd0aDsgaSsrKSB7CgkJCXRhYmxlW2FycmF5Lmd1aWQrK10gPSBhcnJheVtpXTsKCQl9CgoJCXZhciBhcnJheU5vZGUgPSBobSggY29udGV4dCApLmNkKCBpbmRleCApLAoJCQl0YWJsZU5vZGUgPSBhcnJheU5vZGUuY2QoICJ0YWJsZSIgKTsKCgkJLy93aGVuIGl0ZW0gaXMgaW5zZXJ0ZWQgaW4gYXJyYXksIGluc2VydCB0aGUgaXRlbSBpbiB0YWJsZQoJCXRhYmxlTm9kZS5zdWIoIGFycmF5Tm9kZSwgImFmdGVyQ3JlYXRlLjEiLCBoYW5kbGVBcnJheU5vZGVDcmVhdGVDaGlsZCApOwoKCQkvL3doZW4gaXRlbSBpcyB1cGRhdGVkIGluIGl0ZW1zTm9kZSwgdXBkYXRlIHRoZSBpdGVtIGluIHRhYmxlCgkJdGFibGVOb2RlLnN1YiggYXJyYXlOb2RlLCAiYWZ0ZXJVcGRhdGUuKiIsIGhhbmRsZUFycmF5Tm9kZVVwZGF0ZURlc2NlbmRhbnQgKTsKCgkJLy93aGVuIGl0ZW0gZGVsZXRlZCBpbiBhcnJheSwgZGVsZXRlIHRoZSBpdGVtIGluIGhhc2ggdGFibGUKCQl0YWJsZU5vZGUuc3ViKCBhcnJheU5vZGUsICJhZnRlckRlbC4xIiwgaGFuZGxlQXJyYXlOb2RlRGVsZXRlQ2hpbGQgKTsKCgkJLy93aGVuIGl0ZW0gaXMgZGVsZXRlZCBpbiB0YWJsZSwgZGVsZXRlIHRoZSBpdGVtIGluIGFycmF5CgkJYXJyYXlOb2RlLnN1YiggdGFibGVOb2RlLCAiYWZ0ZXJEZWwuMSIsIGhhbmRsZVRhYmxlTm9kZURlbGV0ZUNoaWxkICk7CgoJCS8vd2hlbiBpdGVtIGlzIHVwZGF0ZWQgaW4gdGFibGUsIHVwZGF0ZSB0aGUgaXRlbSBpbiBhcnJheQoJCWFycmF5Tm9kZS5zdWIoIHRhYmxlTm9kZSwgImFmdGVyVXBkYXRlLjEiLCBoYW5kbGVUYWJsZU5vZGVVcGRhdGVDaGlsZCApOwoKCX0gKTsKCglobUZuLml0ZW1LZXkgPSBmdW5jdGlvbiggaXRlbSApIHsKCQl2YXIga2V5LAoJCQl0YWJsZSwKCQkJYXJyYXkgPSB0aGlzLnJhdygpOwoKCQlpZiAoaXNGdW5jdGlvbiggYXJyYXkgKSkgewoJCQlhcnJheSA9IHRoaXMubWFpbigpLmdldCgpOwoJCX0KCQl0YWJsZSA9IGFycmF5LnRhYmxlOwoKCQlpZiAodGFibGUpIHsKCQkJZm9yIChrZXkgaW4gdGFibGUpIHsKCQkJCWlmIChpdGVtID09PSB0YWJsZVtrZXldKSB7CgkJCQkJcmV0dXJuIGtleTsKCQkJCX0KCQkJfQoJCX0KCX07CgoJaG1Gbi5rZXlBdCA9IGZ1bmN0aW9uKCBpbmRleCApIHsKCQlyZXR1cm4gdGhpcy5pdGVtS2V5KCB0aGlzLmdldCggaW5kZXggKSApOwoJfTsKCgovLwovLzxAZGVwZW5kcz5zdWJzY3JpcHRpb24uanMsIG1vZGVsLmpzLCBkZWNsYXJhdGl2ZS5qcywgdGVtcGxhdGUuanM8L0BkZXBlbmRzPgoKCgkvL2F1Z21lbnQgalF1ZXJ5IEV2ZW50IHR5cGUKCS8vd2hlbiB5b3UgYXR0YWNoIGEgd29ya2Zsb3cgdG8gcGFyZW50IGVsZW1lbnQgdG8gaGFuZGxlIHRoZSBldmVudCBmcm9tIGNoaWxkcmVuCgkvL3dlIHdhbnQgdG8ga25vdyB0aGUgY2hpbGRyZW4gZWxlbWVudCdzIHJvdyBpbmRleCBvZiBhbGwgdGhlIHJvd3MKCSQuRXZlbnQucHJvdG90eXBlLnNlbGVjdGVkUm93SW5kZXggPSBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5wdWJsaXNoZXIuY2hpbGRyZW4oKS5maWx0ZXIoIHRoaXMub3JpZ2luYWxQdWJsaXNoZXIucGFyZW50cygpICkuaW5kZXgoKTsKCX07CgoJZnVuY3Rpb24gRWRpdE9iamVjdCggaW5kZXggKSB7CgkJdGhpcy5zZWxlY3RlZEluZGV4ID0gaW5kZXg7Cgl9CgoJRWRpdE9iamVjdC5wcm90b3R5cGUgPSB7CgkJaXRlbTogbnVsbCwKCQkvL2xvZ2ljYWxseSBtb2RlIGRlcGVuZHMgb24gIml0ZW0iIGFuZCAiaW5kZXgiCgkJLy9idXQgaGVyZSB3ZSBkaXNhYmxlIHRoZXNlIGRlcGVuZGVuY2llcywgYmVjYXVzZSB3ZSB3YW50IHRvCgkJLy9tYW51YWxseSB0cmlnZ2VyIHRoZSBldmVudHMKCQkvL2lmIGl0IHJlYWxseSBkZXBlbmRzIHRoZW0sIHRoZSBldmVudHMgd2lsbCBiZSBoYXJkIHRvIGNvbnRyb2xsZWQKCQltb2RlOiBmdW5jdGlvbiBfXygpIHsKCQkJdmFyIGVkaXQgPSB0aGlzLmdldCgpLAoJCQkJaXRlbSA9IGVkaXQuaXRlbSwKCQkJCXNlbGVjdGVkSW5kZXggPSBlZGl0LnNlbGVjdGVkSW5kZXg7CgoJCQlyZXR1cm4gaXRlbSA9PT0gbnVsbCA/ICJyZWFkIiA6CgkJCQlpc1VuZGVmaW5lZCggc2VsZWN0ZWRJbmRleCApID8gInVwZGF0ZSIgOgoJCQkJCShzZWxlY3RlZEluZGV4ID09IC0xKSA/ICJuZXciIDoKCQkJCQkJInVwZGF0ZSI7CgoJCX0KCX07CgoJLy90aGUgZm9sbG93IG1ldGhvZHMgYXJlIGRlc2lnbmVkIHRvIGJlIHVzZWQgd2l0aCBhcnJheSBtb2RlbAoJLy8gdGhleSBhcmUgdXNlZCB0byBtYW5pcHVsYXRlIHRoZSBzaGFkb3cgZWRpdCBvYmplY3Qgb2YgYXJyYXkgbW9kZWwKCWV4dGVuZCggaG1GbiwgewoKCQkvL2luaXRTaGFkb3dFZGl0IGlzIHJlcXVpcmVkIGZvciBhcnJheSBtb2RlbCBvciBmb3IgYXJyYXkgcXVlcnkgZnVuY3Rpb25zCgkJLy9pdCBpcyBub3QgbmVjZXNzYXJ5IGZvciBtb2RlbCBvZiBvdGhlciB0eXBlCgkJaW5pdFNoYWRvd0VkaXQ6IGZ1bmN0aW9uKCBpdGVtVGVtcGxhdGUgKSB7CgkJCS8vaXQgaXMgYSBjb252ZW50aW9uIHRoYXQsIGlmIHRoZSBwYXRoIG9mIGxpc3QgZGF0YSBpcyBpdGVtcwoJCQkvL3dlIHRha2UgaXRlbXNfaXRlbVRlbXBsYXRlIGFzIHRlbXBsYXRlIGZyb20gbmV3IGl0ZW0gZm9yIHRoZSBsaXN0IGRhdGEKCgkJCXZhciBtb2RlbCA9IHRoaXM7CgoJCQlpZiAobW9kZWwuZ2V0KCAiKmVkaXQiICkpIHsKCQkJCXJldHVybjsKCQkJfQoJCQl2YXIgaXRlbXNQYXRoID0gbW9kZWwucGF0aCwKCQkJCXJDaGlsZFNoYWRvd0l0ZW0gPSBSZWdFeHAoICJeIiArIGl0ZW1zUGF0aC5yZXBsYWNlKCAiLiIsICJcXC4iICkgKyAiXFwqZWRpdFxcLml0ZW1bXipdK1xcKiQiICksCgkJCQlyRGVlcFNoYWRvd0l0ZW0gPSBSZWdFeHAoICJeIiArIGl0ZW1zUGF0aC5yZXBsYWNlKCAiLiIsICJcXC4iICkgKyAiXFwqZWRpdFxcLml0ZW1bXFx3Ll0rXFwqZWRpdFxcLml0ZW0iICk7CgoJCQlpZiAoaXNVbmRlZmluZWQoIGl0ZW1UZW1wbGF0ZSApKSB7CgoJCQkJaWYgKG1vZGVsLmlzU2hhZG93KCkgJiYgIWlzRnVuY3Rpb24oIG1vZGVsLnJhdygpICkpIHsKCQkJCQkvL2lmIHRoZSBhcnJheSBvYmplY3QgaXRlbXMgaXMgYWxyZWFkeSBpbiBzaGFkb3cKCQkJCQkvL3RoZSBpdGVtVGVtcGxhdGUgaXMgYWxyZWFkeSBkZWZpbmVkIGluIG1haW4gaXRlbXMnIGl0ZW1UZW1wbGF0ZQoJCQkJCS8vZm9yIGV4YW1wbGUKCQkJCQkvL3RoZSBpdGVtc1BhdGggaXMgImRvYy5lbnRyaWVzKmVkaXQuaXRlbS5wZXJzb25hbC5zaWduYXR1cmVzIgoJCQkJCS8vdGhlIGl0ZW1UZW1wbGF0ZSBpcyBkZWZpbmVkIGluICJkb2MuZW50cmllcyplZGl0Lml0ZW0ucGVyc29uYWwuc2lnbmF0dXJlcy4wIgoJCQkJCS8vdGhlIGZvbGxvd2luZyBpcyB0cnkgdG8gZ2V0IHRoZSBpdGVtVGVtcGxhdGUKCQkJCQkvLwoJCQkJCS8vdGhlIG1haW5Nb2RlbCBpcyBkb2MuZW50cmllcwoJCQkJCXZhciBtYWluTW9kZWwgPSBtb2RlbC5tYWluKCk7CgoJCQkJCS8vdGhlIGVkaXRpbmdNb2RlbFBhdGggb2YgbWFpbk1vZGVsIGlzIGRvYy5lbnRyaWVzKmVkaXQuaXRlbQoJCQkJCXZhciBlZGl0aW5nTW9kZWxQYXRoID0gbWFpbk1vZGVsLmxvZ2ljYWxQYXRoKCkgKyAiKmVkaXQuaXRlbSI7CgoJCQkJCS8vdGhlIHBvc2l0aW9uIG9mIGxhc3QgIi4iIGluICJkb2MuZW50cmllcyplZGl0Lml0ZW0uIgoJCQkJCXZhciBzdGFydEluZGV4ID0gZWRpdGluZ01vZGVsUGF0aC5sZW5ndGggKyAxOwoKCQkJCQkvL3RoZSBwb3J0aW9uIG9mICJwZXJzb25hbC5zaWduYXR1cmVzIiBpbiAiZG9jLmVudHJpZXMqZWRpdC5pdGVtLnBlcnNvbmFsLnNpZ25hdHVyZXMiCgkJCQkJdmFyIHN1YlBhdGggPSB0b0xvZ2ljYWxQYXRoKCBpdGVtc1BhdGggKS5zdWJzdHIoIHN0YXJ0SW5kZXggKTsKCgkJCQkJLy9nZXQgImRvYy5lbnRyaWVzKmVkaXQuaXRlbVRlbXBsYXRlLnBlcnNvbmFsLnNpZ25hdHVyZXMuMCIKCQkJCQlpdGVtVGVtcGxhdGUgPSBjbG9uZSggbWFpbk1vZGVsLmdldCggIiplZGl0Lml0ZW1UZW1wbGF0ZS4iICsgc3ViUGF0aCArICIuMCIgKSwgdHJ1ZSApOwoKCQkJCX0gZWxzZSB7CgoJCQkJCS8vdGhlIGNvbnZlbnRpb24gaXMgdGhhdCBpZiB3ZSBoYXZlIG1vZGVsIGF0IHBhdGggImNvbnRhY3RzIiwKCQkJCQkvL3RoZSB0ZW1wbGF0ZSBpdGVtIGlzIGV4cGVjdGVkIGF0ICJjb250YWN0c19pdGVtVGVtcGxhdGUiCgkJCQkJaWYgKGlzRnVuY3Rpb24oIG1vZGVsLnJhdygpICkpIHsKCQkJCQkJaXRlbVRlbXBsYXRlID0gcm9vdE5vZGUucmF3KCBtb2RlbC5tYWluKCkucGF0aCArICJfaXRlbVRlbXBsYXRlIiApOwoJCQkJCX0gZWxzZSB7CgkJCQkJCWl0ZW1UZW1wbGF0ZSA9IHJvb3ROb2RlLnJhdyggaXRlbXNQYXRoICsgIl9pdGVtVGVtcGxhdGUiICk7CgkJCQkJfQoKCQkJCQkvL2lmIGNvbnZlbnRpb24gaXMgbm90IGZvbGxvd2VkLCB1c2UgdGhlIGV4aXN0aW5nIGFzIHRlbXBsYXRlCgkJCQkJaWYgKGlzVW5kZWZpbmVkKCBpdGVtVGVtcGxhdGUgKSkgewoJCQkJCQlpdGVtVGVtcGxhdGUgPSBjbGVhck9iaiggY2xvbmUoIG1vZGVsLmdldCgpWzBdLCB0cnVlICkgKTsKCQkJCQl9CgkJCQl9CgkJCX0KCgkJCXZhciBlZGl0T2JqZWN0ID0gbmV3IEVkaXRPYmplY3QoIC0xICk7CgkJCWVkaXRPYmplY3QuaXRlbVRlbXBsYXRlID0gaXRlbVRlbXBsYXRlOwoJCQllZGl0T2JqZWN0Lml0ZW0gPSBudWxsOwoKCQkJbW9kZWwuc2V0KCAiKmVkaXQiLCBlZGl0T2JqZWN0ICk7CgoJCQkvL3dlIHdhbnQgdG8gdHJpZ2dlciBiZWdpbkluUm93VXBkYXRlL2NhbmNlbEluUm93VXBkYXRlIGFmdGVyIHNlbGVjdGVkSW5kZXggaGFzIGNoYW5nZWQKCQkJLy9iZWNhdXNlIHRoZSBoYW5kbGVycyBkZXBlbmRzIG9uIHRoZSBhdmFpbGFiaWxpdHkgb2Ygc2VsZWN0ZWRJbmRleAoJCQltb2RlbC5jZCggIiplZGl0LnNlbGVjdGVkSW5kZXgiICkuaGFuZGxlKCAiYWZ0ZXJVcGRhdGUiLCBmdW5jdGlvbiggZSApIHsKCgkJCQl2YXIgbmV3SW5kZXggPSBlLnByb3Bvc2VkLAoJCQkJCW9sZEluZGV4ID0gZS5yZW1vdmVkOwoKCQkJCWlmIChuZXdJbmRleCA+PSAwKSB7CgoJCQkJCW1vZGVsLnRyaWdnZXIoICJiZWdpbkluUm93VXBkYXRlIiwgbmV3SW5kZXggKTsKCgkJCQl9IGVsc2UgaWYgKG5ld0luZGV4ID09IC0xKSB7CgoJCQkJCW1vZGVsLnRyaWdnZXIoICJjYW5jZWxJblJvd1VwZGF0ZSIsIG9sZEluZGV4ICk7CgkJCQl9CgkJCX0gKTsKCgkJCW1vZGVsLmNkKCAiKmVkaXQuaXRlbSIgKS5oYW5kbGUoICJhZnRlclVwZGF0ZSIsIGZ1bmN0aW9uKCBlICkgewoJCQkJdmFyIGtleSwgbG9naWNhbFBhdGgsIGVkaXRPYmplY3Q7CgoJCQkJZm9yIChrZXkgaW4gc2hhZG93Um9vdCkgewoKCQkJCQlsb2dpY2FsUGF0aCA9IHV0aWwudG9Mb2dpY2FsUGF0aCggIl9faG0uIiArIGtleSApOwoKCQkJCQlpZiAockRlZXBTaGFkb3dJdGVtLnRlc3QoIGxvZ2ljYWxQYXRoICkpIHsKCgkJCQkJCWRlbGV0ZSBzaGFkb3dSb290W2tleV07CgoJCQkJCX0gZWxzZSBpZiAockNoaWxkU2hhZG93SXRlbS50ZXN0KCBsb2dpY2FsUGF0aCApKSB7CgoJCQkJCQllZGl0T2JqZWN0ID0gc2hhZG93Um9vdFtrZXldLmVkaXQ7CgoJCQkJCQlpZiAoZWRpdE9iamVjdCkgewoJCQkJCQkJZWRpdE9iamVjdC5pdGVtID0gbnVsbDsKCQkJCQkJCWVkaXRPYmplY3Quc2VsZWN0ZWRJbmRleCA9IC0xOwoJCQkJCQl9CgkJCQkJfQoJCQkJfQoJCQl9ICk7CgkJCXJldHVybiB0aGlzOwoJCX0sCgoJCS8vY3JlYXRlIGEgbmV3IGl0ZW0gaW4gc2hhZG93IGVkaXQgb2JqZWN0IGZvciBpdGVtcyBtb2RlbAoJCS8vbm90IG5lY2Vzc2FyeSBmb3IgbW9kZWwgb2YgcHJpbWl0aXZlIHR5cGUgYW5kIG9iamVjdHMKCQluZXdTaGFkb3dJdGVtOiBmdW5jdGlvbigpIHsKCQkJaWYgKHRoaXMuZ2V0KCAiKmVkaXQubW9kZSIgKSAhPT0gInJlYWQiKSB7CgkJCQl0aGlzLnJlc2V0U2hhZG93SXRlbSgpOwoJCQl9CgoJCQl2YXIgZWRpdFNoYWRvd01vZGVsID0gdGhpcy5jZCggIiplZGl0IiApLAoJCQkJaXRlbVRlbXBsYXRlID0gZWRpdFNoYWRvd01vZGVsLnJhdyggIml0ZW1UZW1wbGF0ZSIgKSwKCQkJCWl0ZW0gPSAoaXNGdW5jdGlvbiggaXRlbVRlbXBsYXRlICkpID8KCQkJCQlpdGVtVGVtcGxhdGUoKSA6CgkJCQkJY2xvbmUoIGl0ZW1UZW1wbGF0ZSwgdHJ1ZSApOwoKCQkJZWRpdFNoYWRvd01vZGVsLnVwZGF0ZSggIml0ZW0iLCBpdGVtICk7CgkJCWVkaXRTaGFkb3dNb2RlbC5jaGFuZ2UoICJtb2RlIiApOwoJCX0sCgoJCWVkaXRTaGFkb3dJdGVtOiBmdW5jdGlvbiggaXRlbSwgaXRlbUluZGV4ICkgewoKCQkJdmFyIGl0ZW1WYWx1ZSA9IHRoaXMucmF3KCk7CgkJCWlmIChpc1ByaW1pdGl2ZSggaXRlbVZhbHVlICkgfHwgaXNPYmplY3QoIGl0ZW1WYWx1ZSApKSB7CgoJCQkJdmFyIGVkaXQgPSB0aGlzLmdldCggIiplZGl0IiApOwoJCQkJaWYgKGlzVW5kZWZpbmVkKCBlZGl0ICkpIHsKCQkJCQllZGl0ID0gbmV3IEVkaXRPYmplY3QoKTsKCQkJCQl0aGlzLnNldCggIiplZGl0IiwgZWRpdCApOwoJCQkJfQoKCQkJCWlmIChlZGl0Lml0ZW0gIT09IG51bGwpIHsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJdGhpcy5zZXQoICIqZWRpdC5pdGVtIiwgY2xvbmUoIGl0ZW1WYWx1ZSwgdHJ1ZSApICk7CgkJCQl0aGlzLmNoYW5nZSggIiplZGl0Lm1vZGUiICk7CgoJCQl9IGVsc2UgewoKCQkJCWlmICh0aGlzLmdldCggIiplZGl0Lm1vZGUiICkgIT09ICJyZWFkIikgewoJCQkJCXRoaXMucmVzZXRTaGFkb3dJdGVtKCk7CgkJCQl9CgoJCQkJaWYgKGlzVW5kZWZpbmVkKCBpdGVtSW5kZXggKSkgewoJCQkJCWl0ZW1JbmRleCA9IHRoaXMuaW5kZXhPZiggaXRlbSApOwoJCQkJfSBlbHNlIHsKCQkJCQlpdGVtID0gdGhpcy5nZXQoKVtpdGVtSW5kZXhdOwoJCQkJfQoKCQkJCXZhciBlZGl0U2hhZG93TW9kZWwgPSB0aGlzLmNkKCAiKmVkaXQiICksCgkJCQkJaXRlbVRlbXBsYXRlID0gZWRpdFNoYWRvd01vZGVsLnJhdyggIml0ZW1UZW1wbGF0ZSIgKSwKCQkJCQljb3B5ID0gKGlzRnVuY3Rpb24oIGl0ZW1UZW1wbGF0ZSApKSA/CgkJCQkJCWl0ZW1UZW1wbGF0ZSggaXRlbSApIDoKCQkJCQkJY2xvbmUoIGl0ZW0sIHRydWUgKTsKCgkJCQllZGl0U2hhZG93TW9kZWwudXBkYXRlKCAiaXRlbSIsIGNvcHkgKQoJCQkJCS51cGRhdGUoICJzZWxlY3RlZEluZGV4IiwgaXRlbUluZGV4ICk7CgoJCQkJZWRpdFNoYWRvd01vZGVsLmNoYW5nZSggIm1vZGUiICk7CgkJCX0KCgkJfSwKCgkJcmVzZXRTaGFkb3dJdGVtOiBmdW5jdGlvbiggc2F2ZSApIHsKCQkJaWYgKHRoaXMucGF0aC5lbmRzV2l0aCggIi5lZGl0Lml0ZW0iICkpIHsKCQkJCXJldHVybiB0aGlzLm1haW4oKS5yZXNldFNoYWRvd0l0ZW0oKTsKCQkJfQoKCQkJdmFyIGl0ZW1zID0gdGhpcy5yYXcoKTsKCQkJaWYgKGlzUHJpbWl0aXZlKCBpdGVtcyApIHx8IGlzT2JqZWN0KCBpdGVtcyApKSB7CgoJCQkJdGhpcy5zZXQoICIqZWRpdC5pdGVtIiwgbnVsbCApOwoJCQkJdGhpcy5jaGFuZ2UoICIqZWRpdC5tb2RlIiApOwoKCQkJfSBlbHNlIHsKCgkJCQl2YXIgZWRpdCA9IHRoaXMuY2QoICIqZWRpdCIgKTsKCQkJCWlmICghaXNVbmRlZmluZWQoIGVkaXQuZ2V0KCkgKSkgewoKCQkJCQllZGl0LnVwZGF0ZSggIml0ZW0iLCBudWxsICk7CgoJCQkJCWlmIChzYXZlKSB7CgkJCQkJCS8vaWYgaXQgdHJpZ2dlcmVkIGJ5IHNhdmVTaGFkb3dJdGVtCgkJCQkJCS8vdXBkYXRlIHNlbGVjdGVkSW5kZXggZGlyZWN0bHkgdG8gYXZvaWQgZXZlbnRzCgkJCQkJCWVkaXQuZ2V0KCkuc2VsZWN0ZWRJbmRleCA9IC0xOwoJCQkJCX0gZWxzZSB7CgkJCQkJCWVkaXQudXBkYXRlKCAic2VsZWN0ZWRJbmRleCIsIC0xICk7CgkJCQkJfQoKCQkJCQllZGl0LmNoYW5nZSggIm1vZGUiICk7CgkJCQl9CgkJCX0KCgkJfSwKCgkJc2F2ZVNoYWRvd0l0ZW06IGZ1bmN0aW9uKCkgewoKCQkJaWYgKHRoaXMucGF0aC5lbmRzV2l0aCggIi5lZGl0Lml0ZW0iICkpIHsKCQkJCXJldHVybiB0aGlzLm1haW4oKS5zYXZlU2hhZG93SXRlbSgpOwoJCQl9CgoJCQl2YXIgaXRlbXMgPSB0aGlzLnJhdygpOwoKCQkJaWYgKGlzUHJpbWl0aXZlKCBpdGVtcyApIHx8IGlzT2JqZWN0KCBpdGVtcyApKSB7CgoJCQkJdGhpcy5zZXQoIHRoaXMuZ2V0KCAiKmVkaXQuaXRlbSIgKSApCgkJCQkJLnNldCggIiplZGl0Lml0ZW0iLCBudWxsICk7CgoJCQkJdGhpcy5jaGFuZ2UoICIqZWRpdC5tb2RlIiApOwoKCQkJfSBlbHNlIHsKCgkJCQl2YXIgY3VycmVudEVkaXRNb2RlID0gdGhpcy5nZXQoICIqZWRpdC5tb2RlIiApLAoJCQkJCXBlbmRpbmdJdGVtID0gdGhpcy5nZXQoICIqZWRpdC5pdGVtIiApOwoKCQkJCWlmIChjdXJyZW50RWRpdE1vZGUgPT0gInJlYWQiKSB7CgoJCQkJCXRocm93ICJpbnZhbGlkIG9wZXJhdGlvbnMiOwoKCQkJCX0gZWxzZSBpZiAoY3VycmVudEVkaXRNb2RlID09ICJuZXciKSB7CgoJCQkJCWlmIChpc0Z1bmN0aW9uKCBpdGVtcyApKSB7CgkJCQkJCS8vdGhpcyBpcyBjYXNlIHdoZW4gaXRlbXMgaXMgbW9kZWwqcXVlcnlSZXN1bHQKCQkJCQkJdGhpcy5tYWluKCkucHVzaCggcGVuZGluZ0l0ZW0gKTsKCgkJCQkJfSBlbHNlIHsKCQkJCQkJdGhpcy5wdXNoKCBwZW5kaW5nSXRlbSApOwoJCQkJCX0KCgkJCQkJdGhpcy5yZXNldFNoYWRvd0l0ZW0oKTsKCgkJCQl9IGVsc2UgLyppZiAoY3VycmVudEVkaXRNb2RlID09ICJ1cGRhdGUiKSovIHsKCgkJCQkJdmFyIHNlbGVjdGVkSW5kZXggPSB0aGlzLmdldCggIiplZGl0LnNlbGVjdGVkSW5kZXgiICk7CgoJCQkJCWlmIChpc0Z1bmN0aW9uKCBpdGVtcyApKSB7CgkJCQkJCS8vdGhpcyBpcyBjYXNlIHdoZW4gaXRlbXMgaXMgbW9kZWwqcXVlcnlSZXN1bHQKCQkJCQkJaXRlbXMgPSB0aGlzLmdldCgpOwoJCQkJCQl0aGlzLm1haW4oKS5yZXBsYWNlSXRlbSgKCQkJCQkJCWl0ZW1zW3NlbGVjdGVkSW5kZXhdLAoJCQkJCQkJcGVuZGluZ0l0ZW0KCQkJCQkJKTsKCQkJCQl9IGVsc2UgewoJCQkJCQl0aGlzLnJlcGxhY2VJdGVtKAoJCQkJCQkJaXRlbXNbc2VsZWN0ZWRJbmRleF0sCgkJCQkJCQlwZW5kaW5nSXRlbQoJCQkJCQkpOwoJCQkJCX0KCQkJCQl0aGlzLnJlc2V0U2hhZG93SXRlbSggdHJ1ZSApOwoJCQkJfQoKCQkJfQoJCX0KCX0gKTsKCglobS53b3JrZmxvdyggewoKCQkvLy0tLS0tLXdvcmtmbG93cyB0aGF0IG1vZGlmeSBtb2RlbC0tLS0tLQoKCQkvLyRjbGljazppdGVtc3wqZWRpdFNoYWRvd0l0ZW0KCQkvLyRjbGljazppdGVtcypxdWVyeVJlc3VsdHwqZWRpdFNoYWRvd0l0ZW0KCQluZXdTaGFkb3dJdGVtOiAiKmZha2VHZXQgbmV3U2hhZG93SXRlbSIsCgoJCS8vJGNsaWNrOml0ZW18KmVkaXRTaGFkb3dJdGVtCgkJLy8kZWRpdFJvdzppdGVtc3wqZWRpdFNoYWRvd0l0ZW0KCQkvLyRlZGl0Um93Oml0ZW1zKnF1ZXJ5UmVzdWx0fCplZGl0U2hhZG93SXRlbQoJCWVkaXRTaGFkb3dJdGVtOiBmdW5jdGlvbiggZSApIHsKCQkJaWYgKGUudHlwZSA9PSAiZWRpdFJvdyIpIHsKCQkJCS8vdGhpcyB0cmlnZ2VyIGJ5IGVkaXQgYnV0dG9uCgkJCQl0aGlzLmVkaXRTaGFkb3dJdGVtKCBudWxsLCBlLnNlbGVjdGVkUm93SW5kZXgoKSApOwoJCQl9IGVsc2UgewoJCQkJaWYgKHRoaXMucGF0aC5lbmRzV2l0aCggIi5lZGl0Lml0ZW0iICkpIHsKCQkJCQl0aGlzLm1haW4oKS5lZGl0U2hhZG93SXRlbSggdGhpcy5nZXQoKSApOwoJCQkJfSBlbHNlIHsKCQkJCQl0aGlzLmVkaXRTaGFkb3dJdGVtKCk7CgkJCQl9CgkJCX0KCQkJZS5zdG9wUHJvcGFnYXRpb24oKTsKCQl9LAoKCQkvLyIkZGVsZXRlOml0ZW1zfCpyZW1vdmVJdGVtOyIKCQkvLyIkZGVsZXRlOml0ZW1zKnF1ZXJ5UmVzdWx0fCpyZW1vdmVJdGVtOyIKCQlyZW1vdmVJdGVtOiBmdW5jdGlvbiggZSApIHsKCQkJaWYgKHRoaXMuZ2V0KCAiKmVkaXQubW9kZSIgKSAhPSAicmVhZCIpIHsKCQkJCXRoaXMucmVzZXRTaGFkb3dJdGVtKCk7CgkJCX0KCQkJdmFyIGluZGV4ID0gZS5zZWxlY3RlZFJvd0luZGV4KCk7CgkJCXZhciBpdGVtcyA9IHRoaXMucmF3KCk7CgkJCWlmIChpc0Z1bmN0aW9uKCBpdGVtcyApKSB7CgkJCQkvL3RoaXMgaXMgY2FzZSB3aGVuIGl0ZW1zIGlzIG1vZGVsKnF1ZXJ5UmVzdWx0CgkJCQlpdGVtcyA9IHRoaXMuZ2V0KCk7CgkJCQl0aGlzLm1haW4oKS5yZW1vdmVJdGVtKCBpdGVtc1tpbmRleF0gKTsKCQkJfSBlbHNlIHsKCQkJCXRoaXMucmVtb3ZlQXQoIGluZGV4ICk7CgkJCX0KCQkJZS5zdG9wUHJvcGFnYXRpb24oKTsKCQl9LAoKCQkvLyRtb3ZlVXA6aXRlbXN8Km1vdmVVcEl0ZW07CgkJbW92ZVVwSXRlbTogZnVuY3Rpb24oIGUgKSB7CgkJCXZhciBzZWxlY3RlZEluZGV4ID0gZS5zZWxlY3RlZFJvd0luZGV4KCk7CgkJCXRoaXMubW92ZSggc2VsZWN0ZWRJbmRleCwgc2VsZWN0ZWRJbmRleCAtIDEgKTsKCQkJZS5zdG9wUHJvcGFnYXRpb24oKTsKCQl9LAoKCQkvLyRtb3ZlVXA6aXRlbXN8Km1vdmVVcEl0ZW07CgkJbW92ZURvd25JdGVtOiBmdW5jdGlvbiggZSApIHsKCQkJdmFyIHNlbGVjdGVkSW5kZXggPSBlLnNlbGVjdGVkUm93SW5kZXgoKTsKCQkJdGhpcy5tb3ZlKCBzZWxlY3RlZEluZGV4LCBzZWxlY3RlZEluZGV4ICsgMSApOwoJCQllLnN0b3BQcm9wYWdhdGlvbigpOwoJCX0sCgoJCS8vLS0tLS0td29ya2Zsb3dzIHRoYXQgbW9kaWZ5IHZpZXdzLS0tLS0tCgoJCS8vIWFmdGVyVXBkYXRlOml0ZW1zKmVkaXQubW9kZXwqcmVuZGVyTmV3VmlldzsKCQkvLyFhZnRlclVwZGF0ZTppdGVtcypxdWVyeVJlc3VsdCplZGl0Lm1vZGV8KnJlbmRlck5ld1ZpZXc7CgkJcmVuZGVyTmV3VmlldzogbmV3VGVtcGxhdGVIYW5kbGVyKAoJCQlmdW5jdGlvbiggZSApIHsKCQkJCWlmIChlLnB1Ymxpc2hlci5nZXQoKSA9PSAibmV3IikgewoJCQkJCXJldHVybiBlLnB1Ymxpc2hlci5tYWluKCkuZ2V0KCAiKmVkaXQuaXRlbSIgKTsKCQkJCX0KCQkJfQoJCQkvKnNldCBhY3Rpdml0eSBpcyBieSBkZWZhdWx0IGh0bWwqLwoKCQkpLAoKCQkvLyIhYmVnaW5JblJvd1VwZGF0ZTppdGVtc3wqcmVuZGVyVXBkYXRlUm93VmlldzsiCgkJLy8iIWJlZ2luSW5Sb3dVcGRhdGU6aXRlbXMqcXVlcnlSZXN1bHR8KnJlbmRlclVwZGF0ZVJvd1ZpZXc7IgoJCXJlbmRlclVwZGF0ZVJvd1ZpZXc6IG5ld1RlbXBsYXRlSGFuZGxlcigKCQkJLy9nZXQgYWN0aXZpdHkKCQkJZnVuY3Rpb24oIGUgKSB7CgkJCQlyZXR1cm4gZS5wdWJsaXNoZXIuZ2V0KCAiKmVkaXQuaXRlbSIgKTsKCQkJfSwKCQkJLy9zZXQgYWN0aXZpdHkKCQkJZnVuY3Rpb24oIHZhbHVlLCBlICkgewoJCQkJLy9lLnByb3Bvc2VkIGlzIHRoZSBpbmRleCBvZiB0aGUgZWRpdCBpdGVtCgkJCQl0aGlzLmNoaWxkcmVuKCkuZXEoIGUucHJvcG9zZWQgKS5yZXBsYWNlV2l0aCggdmFsdWUgKTsKCQkJfSApLAoKCQkvLyIhYmVnaW5JblJvd1VwZGF0ZTppdGVtc3wqcmVuZGVyVXBkYXRlUm93VmlldzsiCgkJLy8iIWJlZ2luSW5Sb3dVcGRhdGU6aXRlbXMqcXVlcnlSZXN1bHR8KnJlbmRlclVwZGF0ZVJvd1ZpZXc7IgoJCWRlc3Ryb3lVcGRhdGVSb3dWaWV3OiBmdW5jdGlvbiggZSApIHsKCQkJZS5wdWJsaXNoZXIuY2hhbmdlKCBlLnByb3Bvc2VkICk7CgkJfSwKCgkJLy8kY2xpY2s6aXRlbXMqZWRpdC5pdGVtfCpzYXZlU2hhZG93SXRlbTsKCQkvLyRjbGljazppdGVtcypxdWVyeVJlc3VsdCplZGl0Lml0ZW18KnNhdmVTaGFkb3dJdGVtOwoJCXNhdmVTaGFkb3dJdGVtOiBmdW5jdGlvbiggZSApIHsKCQkJdGhpcy5zYXZlU2hhZG93SXRlbSgpOwoJCQllLnN0b3BQcm9wYWdhdGlvbigpOwoJCX0sCgoJCS8vJGNsaWNrOml0ZW1zKmVkaXQuaXRlbXwqcmVzZXRTaGFkb3dJdGVtOwoJCS8vJGNsaWNrOml0ZW1zKnF1ZXJ5UmVzdWx0KmVkaXQuaXRlbXwqcmVzZXRTaGFkb3dJdGVtOwoJCXJlc2V0U2hhZG93SXRlbTogZnVuY3Rpb24oIGUgKSB7CgkJCXRoaXMucmVzZXRTaGFkb3dJdGVtKCk7CgkJCWUuc3RvcFByb3BhZ2F0aW9uKCk7CgkJfQoJfSApOwoKCWJpbmRpbmdzKCB7CgoKCQkvLyBzaGFkb3dFZGl0Oml0ZW1zfHJvd1RlbXBsYXRlSWQgb3IKCQkvLyBzaGFkb3dFZGl0Oml0ZW1zKnF1ZXJ5UmVzdWx0fHJvd1RlbXBsYXRlSWQKCQlzaGFkb3dFZGl0OiAiIWluaXQ6Lnxpbml0U2hhZG93RWRpdCAqZmFrZVNldDsiICsKCQkgICAgICAgICAgICAiZGVsZXRlUm93Oi47IiArCgkJICAgICAgICAgICAgIiRlZGl0Um93Oi58KmVkaXRTaGFkb3dJdGVtIiwKCgkJLy8gc2hhZG93RWRpdEluUm93Oml0ZW1zfHVwZGF0ZVJvd1RlbXBsYXRlSWQgb3IKCQkvLyBzaGFkb3dFZGl0SW5Sb3c6aXRlbXMqcXVlcnlSZXN1bHR8dXBkYXRlUm93VGVtcGxhdGVJZAoJCXNoYWRvd0VkaXRJblJvdzogInNoYWRvd0VkaXQ6LjsiICsKCQkgICAgICAgICAgICAgICAgICIhYmVnaW5JblJvd1VwZGF0ZToufCpyZW5kZXJVcGRhdGVSb3dWaWV3OyIgKwoJCSAgICAgICAgICAgICAgICAgIiFjYW5jZWxJblJvd1VwZGF0ZToufCpkZXN0cm95VXBkYXRlUm93VmlldyIsCgoJCWRlbGV0ZVJvdzogIiRkZWxldGVSb3c6LnwqY29uZmlybXxfRG8geW91IHdhbnQgdG8gZGVsZXRlIHRoaXMgaXRlbT87IiArCgkJICAgICAgICAgICAiJGRlbGV0ZVJvdzoufCpyZW1vdmVJdGVtOyIsCgkJLy9tb3ZhYmxlUm93Oml0ZW1zCgkJbW92YWJsZVJvdzogIiRtb3ZlVXA6LnwqbW92ZVVwSXRlbTsiICsKCQkgICAgICAgICAgICAiJG1vdmVEb3duOi58Km1vdmVEb3duSXRlbTsiLAoKCQkvL25ld0l0ZW1WaWV3Oml0ZW1zCgkJLy9uZXdJdGVtVmlldzppdGVtcypxdWVyeVJlc3VsdAoJCW5ld0l0ZW1WaWV3OiAiIWFmdGVyVXBkYXRlOiplZGl0Lm1vZGV8KnJlbmRlck5ld1ZpZXc7IiArCgkJICAgICAgICAgICAgICJzaG93T25OZXc6LiIsCgoJCS8vc2hvd09uTmV3Oml0ZW1zCgkJLy9zaG93T25OZXc6aXRlbXMqcXVlcnlSZXN1bHQKCQlzaG93T25OZXc6ICJzaG93OiplZGl0Lm1vZGV8X25ldyIsCgoJCS8vaGlkZU9uTmV3Oml0ZW1zCgkJLy9oaWRlT25OZXc6aXRlbXMqcXVlcnlSZXN1bHQKCQloaWRlT25OZXc6ICJoaWRlOiplZGl0Lm1vZGV8X25ldyIsCgoJCS8vZWRpdEl0ZW1WaWV3Oml0ZW1zCgkJLy9lZGl0SXRlbVZpZXc6aXRlbXMqcXVlcnlSZXN1bHQKCQllZGl0SXRlbVZpZXc6ICJ0bXBsT25DaGFuZ2U6KmVkaXQuaXRlbTsiICsKCQkgICAgICAgICAgICAgICJzaG93T25FZGl0Oi4iLAoKCQlkaXNwbGF5SXRlbVZpZXc6ICJ0bXBsT25DaGFuZ2U6LjtoaWRlT25FZGl0Oi4iLAoKCQkvL3Nob3dPbkVkaXQ6aXRlbXMKCQkvL3Nob3dPbkVkaXQ6aXRlbXMqcXVlcnlSZXN1bHQKCQkvL3Nob3dPbkVkaXQ6ICJoaWRlOiplZGl0Lm1vZGV8X3JlYWQiLAoJCXNob3dPbkVkaXQ6IGZ1bmN0aW9uKCBlbGVtLCBwYXRoLCBjb250ZXh0LCBvcHRpb25zICkgewoJCQljb250ZXh0LmFwcGVuZFN1YiggZWxlbSwgcGF0aCArICIqZWRpdC5tb2RlIiwgImluaXQgYWZ0ZXJVcGRhdGUiLCBmdW5jdGlvbiggZSApIHsKCQkJCXZhciBtb2RlID0gZS5wdWJsaXNoZXIuZ2V0KCk7CgkJCQl0aGlzWyhpc1VuZGVmaW5lZCggbW9kZSApIHx8IG1vZGUgPT0gInJlYWQiKSA/ICJoaWRlIiA6ICJzaG93Il0oKTsKCQkJfSApOwoJCX0sCgoJCS8vaGlkZU9uRWRpdDppdGVtcwoJCS8vaGlkZU9uRWRpdDppdGVtcypxdWVyeVJlc3VsdAoJCS8vaGlkZU9uRWRpdDogInNob3c6KmVkaXQubW9kZXxfcmVhZCIsCgkJaGlkZU9uRWRpdDogZnVuY3Rpb24oIGVsZW0sIHBhdGgsIGNvbnRleHQsIG9wdGlvbnMgKSB7CgkJCWNvbnRleHQuYXBwZW5kU3ViKCBlbGVtLCBwYXRoICsgIiplZGl0Lm1vZGUiLCAiaW5pdCBhZnRlclVwZGF0ZSIsIGZ1bmN0aW9uKCBlICkgewoJCQkJdmFyIG1vZGUgPSBlLnB1Ymxpc2hlci5nZXQoKTsKCQkJCXRoaXNbKGlzVW5kZWZpbmVkKCBtb2RlICkgfHwgbW9kZSA9PSAicmVhZCIpID8gInNob3ciIDogImhpZGUiXSgpOwoJCQl9ICk7CgkJfSwKCgkJLy9uZXdJdGVtOml0ZW1zCgkJLy9uZXdJdGVtOml0ZW1zKnF1ZXJ5UmVzdWx0CgkJbmV3SXRlbTogIiRjbGljazoufCpuZXdTaGFkb3dJdGVtOyIgKwoJCSAgICAgICAgICJoaWRlT25OZXc6LiIsCgoJCS8vZWRpdEJ1dHRvbjppdGVtCgkJLy90aGlzIGlzIG9ubHkgdXNlZCBub24tYXJyYXkgaXRlbSBlZGl0CgkJZWRpdE9iamVjdDogIiRjbGljazoufCplZGl0U2hhZG93SXRlbTtoaWRlT25FZGl0Oi4iLAoKCQkvL3NhdmVFZGl0Oml0ZW1zKmVkaXQuaXRlbQoJCS8vc2F2ZUVkaXQ6aXRlbXMqcXVlcnlSZXN1bHQqZWRpdC5pdGVtCgkJc2F2ZUVkaXQ6ICIkY2xpY2s6Lnwqc2F2ZVNoYWRvd0l0ZW0iLAoKCQkvL2NhbmNlbEVkaXQ6aXRlbXMqZWRpdC5pdGVtCgkJLy9jYW5jZWxFZGl0Oml0ZW1zKnF1ZXJ5UmVzdWx0KmVkaXQuaXRlbQoJCWNhbmNlbEVkaXQ6ICIkY2xpY2s6LnwqcmVzZXRTaGFkb3dJdGVtIgoKCX0gKTsKCglobS5uZXdKcUV2ZW50KCB7CgoJCWVkaXRSb3c6IFsiY2xpY2siLCBmdW5jdGlvbiggZSApIHsKCQkJcmV0dXJuICQoIGUudGFyZ2V0ICkuaGFzQ2xhc3MoICJlZGl0Um93IiApOwoJCX1dLAoKCQlkZWxldGVSb3c6IFsiY2xpY2siLCBmdW5jdGlvbiggZSApIHsKCQkJcmV0dXJuICQoIGUudGFyZ2V0ICkuaGFzQ2xhc3MoICJkZWxldGVSb3ciICk7CgoJCX1dLAoKCQltb3ZlVXA6IFsiY2xpY2siLCBmdW5jdGlvbiggZSApIHsKCQkJcmV0dXJuICQoIGUudGFyZ2V0ICkuaGFzQ2xhc3MoICJtb3ZlVXAiICk7CgkJfV0sCgoJCW1vdmVEb3duOiBbImNsaWNrIiwgZnVuY3Rpb24oIGUgKSB7CgkJCXJldHVybiAkKCBlLnRhcmdldCApLmhhc0NsYXNzKCAibW92ZURvd24iICk7CgkJfV0KCX0gKTsKCi8vCgoKICAgIGRlZmF1bHRPcHRpb25zLmhhc2hQcmVmaXggPSAiISI7CiAgICBkZWZhdWx0T3B0aW9ucy5yb3V0ZVByZWZpeCA9ICIvIjsKCiAgICB2YXIgbGlzdE9mUm91dGVTZWdtZW50cyA9IFtdLAoKICAgICAgICBkZWZhdWx0Um91dGVTZWdtZW50cywKCiAgICAgICAgaW5pdGlhbFJvdXRlTWF0Y2hlZEJ5UGF0dGVybnMsCgogICAgICAgIHJQbHVzID0gL1wrL2csCgogICAgICAgIHJMZWZ0U3F1YXJlQnJhY2tldCA9IC9cWy8sCgogICAgICAgIHJSaWdodFNxdWFyZUJyYWNrZXQgPSAvXF0kLywKCiAgICAgICAgclJpZ2h0U3F1YXJlQnJhY2tldEVuZCA9IC9cXSQvLAoKICAgICAgICByU2VnbWVudFN0cmluZyA9IC9eKFteP10qKShcPy4qKT8kLywKCiAgICAgICAgclF1ZXJ5U3RyaW5nID0gL15bXj9dKlw/KC4qKSQvLAoKICAgICAgICByU3RhcnRIYXNoLAogICAgLy90aGUgcGF0aCBvZiBtb2RlbCB3aGljaCBpcyB0cmFja2VkIGluIHF1ZXJ5IHN0cmluZwogICAgICAgIHBhcmFtUGF0aHMgPSBbXTsKCiAgICAvL2NvbnZlcnQgYSBwYXJhbSBzdHJpbmcgaW50byBhbiBvYmplY3QKICAgIGZ1bmN0aW9uIGRlcGFyYW0ocGFyYW1TdHJpbmcsIGNvZXJjZSkgewoKICAgICAgICB2YXIgb2JqID0ge30sCiAgICAgICAgICAgIGNvZXJjZV90eXBlcyA9IHsgJ3RydWUnOiB0cnVlLCAnZmFsc2UnOiB0cnVlLCAnbnVsbCc6IG51bGwgfTsKCiAgICAgICAgLy8gSXRlcmF0ZSBvdmVyIGFsbCBuYW1lPXZhbHVlIHBhaXJzLgogICAgICAgICQuZWFjaChwYXJhbVN0cmluZy5yZXBsYWNlKHJQbHVzLCAnICcpLnNwbGl0KCcmJyksIGZ1bmN0aW9uIChpbmRleCwgdmFsdWUpIHsKICAgICAgICAgICAgdmFyIHBhcmFtID0gdmFsdWUuc3BsaXQoJz0nKSwKICAgICAgICAgICAgICAgIGtleSA9IGRlY29kZVVSSUNvbXBvbmVudChwYXJhbVswXSksCiAgICAgICAgICAgICAgICB2YWwsCiAgICAgICAgICAgICAgICBjdXIgPSBvYmosCiAgICAgICAgICAgICAgICBpID0gMCwKCiAgICAgICAgICAgIC8vIElmIGtleSBpcyBtb3JlIGNvbXBsZXggdGhhbiAnZm9vJywgbGlrZSAnYVtdJyBvciAnYVtiXVtjXScsIHNwbGl0IGl0CiAgICAgICAgICAgIC8vIGludG8gaXRzIGNvbXBvbmVudCBwYXJ0cy4KICAgICAgICAgICAgICAgIGtleXMgPSBrZXkuc3BsaXQoJ11bJyksCiAgICAgICAgICAgICAgICBrZXlzX2xhc3QgPSBrZXlzLmxlbmd0aCAtIDE7CgogICAgICAgICAgICAvLyBJZiB0aGUgZmlyc3Qga2V5cyBwYXJ0IGNvbnRhaW5zIFsgYW5kIHRoZSBsYXN0IGVuZHMgd2l0aCBdLCB0aGVuIFtdCiAgICAgICAgICAgIC8vIGFyZSBjb3JyZWN0bHkgYmFsYW5jZWQuCiAgICAgICAgICAgIGlmIChyTGVmdFNxdWFyZUJyYWNrZXQudGVzdChrZXlzWzBdKSAmJiByUmlnaHRTcXVhcmVCcmFja2V0LnRlc3Qoa2V5c1sga2V5c19sYXN0IF0pKSB7CgogICAgICAgICAgICAgICAgLy8gUmVtb3ZlIHRoZSB0cmFpbGluZyBdIGZyb20gdGhlIGxhc3Qga2V5cyBwYXJ0LgogICAgICAgICAgICAgICAga2V5c1sga2V5c19sYXN0IF0gPSBrZXlzWyBrZXlzX2xhc3QgXS5yZXBsYWNlKHJSaWdodFNxdWFyZUJyYWNrZXRFbmQsICcnKTsKCiAgICAgICAgICAgICAgICAvLyBTcGxpdCBmaXJzdCBrZXlzIHBhcnQgaW50byB0d28gcGFydHMgb24gdGhlIFsgYW5kIGFkZCB0aGVtIGJhY2sgb250bwogICAgICAgICAgICAgICAgLy8gdGhlIGJlZ2lubmluZyBvZiB0aGUga2V5cyBhcnJheS4KICAgICAgICAgICAgICAgIGtleXMgPSBrZXlzLnNoaWZ0KCkuc3BsaXQoJ1snKS5jb25jYXQoa2V5cyk7CgogICAgICAgICAgICAgICAga2V5c19sYXN0ID0ga2V5cy5sZW5ndGggLSAxOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gQmFzaWMgJ2Zvbycgc3R5bGUga2V5LgogICAgICAgICAgICAgICAga2V5c19sYXN0ID0gMDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQXJlIHdlIGRlYWxpbmcgd2l0aCBhIG5hbWU9dmFsdWUgcGFpciwgb3IganVzdCBhIG5hbWU/CiAgICAgICAgICAgIGlmIChwYXJhbS5sZW5ndGggPT09IDIpIHsKICAgICAgICAgICAgICAgIHZhbCA9IGRlY29kZVVSSUNvbXBvbmVudChwYXJhbVsxXSk7CgogICAgICAgICAgICAgICAgLy8gQ29lcmNlIHZhbHVlcy4KICAgICAgICAgICAgICAgIGlmIChjb2VyY2UpIHsKICAgICAgICAgICAgICAgICAgICB2YWwgPSB2YWwgJiYgIWlzTmFOKHZhbCkgPyArdmFsICAgICAgICAgICAgICAvLyBudW1iZXIKICAgICAgICAgICAgICAgICAgICAgICAgOiB2YWwgPT09ICd1bmRlZmluZWQnID8gdW5kZWZpbmVkICAgICAgICAgLy8gdW5kZWZpbmVkCiAgICAgICAgICAgICAgICAgICAgICAgIDogY29lcmNlX3R5cGVzW3ZhbF0gIT09IHVuZGVmaW5lZCA/IGNvZXJjZV90eXBlc1t2YWxdIC8vIHRydWUsIGZhbHNlLCBudWxsCiAgICAgICAgICAgICAgICAgICAgICAgIDogdmFsOyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHN0cmluZwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmIChrZXlzX2xhc3QpIHsKICAgICAgICAgICAgICAgICAgICAvLyBDb21wbGV4IGtleSwgYnVpbGQgZGVlcCBvYmplY3Qgc3RydWN0dXJlIGJhc2VkIG9uIGEgZmV3IHJ1bGVzOgogICAgICAgICAgICAgICAgICAgIC8vICogVGhlICdjdXInIHBvaW50ZXIgc3RhcnRzIGF0IHRoZSBvYmplY3QgdG9wLWxldmVsLgogICAgICAgICAgICAgICAgICAgIC8vICogW10gPSBhcnJheSBwdXNoIChuIGlzIHNldCB0byBhcnJheSBsZW5ndGgpLCBbbl0gPSBhcnJheSBpZiBuIGlzCiAgICAgICAgICAgICAgICAgICAgLy8gICBudW1lcmljLCBvdGhlcndpc2Ugb2JqZWN0LgogICAgICAgICAgICAgICAgICAgIC8vICogSWYgYXQgdGhlIGxhc3Qga2V5cyBwYXJ0LCBzZXQgdGhlIHZhbHVlLgogICAgICAgICAgICAgICAgICAgIC8vICogRm9yIGVhY2gga2V5cyBwYXJ0LCBpZiB0aGUgY3VycmVudCBsZXZlbCBpcyB1bmRlZmluZWQgY3JlYXRlIGFuCiAgICAgICAgICAgICAgICAgICAgLy8gICBvYmplY3Qgb3IgYXJyYXkgYmFzZWQgb24gdGhlIHR5cGUgb2YgdGhlIG5leHQga2V5cyBwYXJ0LgogICAgICAgICAgICAgICAgICAgIC8vICogTW92ZSB0aGUgJ2N1cicgcG9pbnRlciB0byB0aGUgbmV4dCBsZXZlbC4KICAgICAgICAgICAgICAgICAgICAvLyAqIFJpbnNlICYgcmVwZWF0LgogICAgICAgICAgICAgICAgICAgIGZvciAoOyBpIDw9IGtleXNfbGFzdDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGtleSA9IGtleXNbaV0gPT09ICcnID8gY3VyLmxlbmd0aCA6IGtleXNbaV07CiAgICAgICAgICAgICAgICAgICAgICAgIGN1ciA9IGN1cltrZXldID0gaSA8IGtleXNfbGFzdCA/CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJba2V5XSB8fCAoIGtleXNbaSArIDFdICYmIGlzTmFOKGtleXNbaSArIDFdKSA/IHt9IDogW10gKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgOiB2YWw7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgLy8gU2ltcGxlIGtleSwgZXZlbiBzaW1wbGVyIHJ1bGVzLCBzaW5jZSBvbmx5IHNjYWxhcnMgYW5kIHNoYWxsb3cKICAgICAgICAgICAgICAgICAgICAvLyBhcnJheXMgYXJlIGFsbG93ZWQuCgogICAgICAgICAgICAgICAgICAgIGlmIChpc0FycmF5KG9ialtrZXldKSkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyB2YWwgaXMgYWxyZWFkeSBhbiBhcnJheSwgc28gcHVzaCBvbiB0aGUgbmV4dCB2YWx1ZS4KICAgICAgICAgICAgICAgICAgICAgICAgb2JqW2tleV0ucHVzaCh2YWwpOwoKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKG9ialtrZXldICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gdmFsIGlzbid0IGFuIGFycmF5LCBidXQgc2luY2UgYSBzZWNvbmQgdmFsdWUgaGFzIGJlZW4gc3BlY2lmaWVkLAogICAgICAgICAgICAgICAgICAgICAgICAvLyBjb252ZXJ0IHZhbCBpbnRvIGFuIGFycmF5LgogICAgICAgICAgICAgICAgICAgICAgICBvYmpba2V5XSA9IFsgb2JqW2tleV0sIHZhbCBdOwoKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAvLyB2YWwgaXMgYSBzY2FsYXIuCiAgICAgICAgICAgICAgICAgICAgICAgIG9ialtrZXldID0gdmFsOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgIH0gZWxzZSBpZiAoa2V5KSB7CiAgICAgICAgICAgICAgICAvLyBObyB2YWx1ZSB3YXMgZGVmaW5lZCwgc28gc2V0IHNvbWV0aGluZyBtZWFuaW5nZnVsLgogICAgICAgICAgICAgICAgb2JqW2tleV0gPSBjb2VyY2UgPyB1bmRlZmluZWQgOiAnJzsKICAgICAgICAgICAgfQogICAgICAgIH0pOwoKICAgICAgICByZXR1cm4gb2JqOwogICAgfQoKICAgIGZ1bmN0aW9uIGdldEhhc2goKSB7CiAgICAgICAgclN0YXJ0SGFzaCA9IHJTdGFydEhhc2ggfHwgbmV3IFJlZ0V4cCgiXiMiICsgZGVmYXVsdE9wdGlvbnMuaGFzaFByZWZpeCArIGRlZmF1bHRPcHRpb25zLnJvdXRlUHJlZml4KTsKICAgICAgICByZXR1cm4gbG9jYXRpb24uaGFzaC5yZXBsYWNlKHJTdGFydEhhc2gsICIiKTsKICAgIH0KCiAgICBmdW5jdGlvbiBnZXRDdXJyZW50UGF0aCgpIHsKICAgICAgICB2YXIgaGFzaCA9IGdldEhhc2goKTsKICAgICAgICB2YXIgbWF0Y2ggPSByU2VnbWVudFN0cmluZy5leGVjKGhhc2gpOwogICAgICAgIHJldHVybiBtYXRjaCAmJiBtYXRjaFsxXSB8fCAiIjsKICAgIH0KCiAgICBmdW5jdGlvbiBnZXRRdWVyeVN0cmluZygpIHsKICAgICAgICB2YXIgaGFzaCA9IGdldEhhc2goKTsKICAgICAgICB2YXIgbWF0Y2ggPSByUXVlcnlTdHJpbmcuZXhlYyhoYXNoKTsKICAgICAgICByZXR1cm4gbWF0Y2ggJiYgbWF0Y2hbMV0gfHwgIiI7CiAgICB9CgogICAgLy9nZXQgc3RhdGUgZnJvbSBxdWVyeSBzdHJpbmcKICAgIGZ1bmN0aW9uIGdldFN0YXRlRnJvbVF1ZXJ5U3RyaW5nKCkgewogICAgICAgIHJldHVybiBkZXBhcmFtKGdldFF1ZXJ5U3RyaW5nKCkpOwogICAgfQoKICAgIC8vaGFuZGxlciBmb3IgbW9kZWwgY2hhbmdlCiAgICAvL3RoaXMgbW9kZWwgaXMgdHJhY2tlZCBpbiB0aGUgcXVlcnkgc3RyaW5nCiAgICAvL3doZW4gbW9kZWwgY2hhbmdlIHdlIHdhbnQgdG8gdXBkYXRlIHRoZSBxdWVyeSBzdHJpbmcKICAgIGZ1bmN0aW9uIHVwZGF0ZVF1ZXJ5U3RyaW5nT25Nb2RlbENoYW5nZShlKSB7CgogICAgICAgIHZhciBxdWVyaWVkUGF0aCA9IHRvTG9naWNhbFBhdGgoZS5wdWJsaXNoZXIucGF0aCksCiAgICAgICAgICAgIG1vZGVsID0ge307CgogICAgICAgIG1vZGVsW3F1ZXJpZWRQYXRoXSA9IHJvb3ROb2RlLmdldChxdWVyaWVkUGF0aCk7CgogICAgICAgIC8vYnVpbGQgdGhlIGhhc2ggc3RyaW5nCiAgICAgICAgLy8xLmNhbGwgZ2V0U3RhZ2VGcm9tUXVlcnlTdHJpbmcKICAgICAgICAvLzIubWVyZ2UgdGhlIHN0YXRlIGluIHF1ZXJ5IHN0cmluZyB3aXRoIHRoZSBzdGF0ZQogICAgICAgIC8vMy5jb252ZXJ0IHRoZSBtZXJnZWQgb2JqZWN0IGludG8gcXVlcnkgc3RyaW5nCiAgICAgICAgLy80LiByZXBsYWNlIGhhc2gncyBxdWVyeSBzdHJpbmcgd2l0aCB0aGUgbmV3IHF1ZXJ5IHN0cmluZwogICAgICAgIHZhciBxdWVyeVN0cmluZyA9IGdldFF1ZXJ5U3RyaW5nKCk7CiAgICAgICAgdmFyIGV4aXN0aW5nU3RhdGUgPSBkZXBhcmFtKHF1ZXJ5U3RyaW5nKTsKICAgICAgICB2YXIgbmV3U3RhdGUgPSAkLmV4dGVuZCh7fSwgZXhpc3RpbmdTdGF0ZSwgbW9kZWwpOwogICAgICAgIHZhciBuZXdIYXNoID0gZ2V0Q3VycmVudFBhdGgoKSArICI/IiArICQucGFyYW0obmV3U3RhdGUpOwoKICAgICAgICBsb2NhdGlvbi5oYXNoID0gZGVmYXVsdE9wdGlvbnMuaGFzaFByZWZpeCArIGRlZmF1bHRPcHRpb25zLnJvdXRlUHJlZml4ICsgbmV3SGFzaDsKCiAgICB9CgogICAgLy93aGVuIG1vZGVsIGNoYW5nZSB0cnkgdG8gdXBkYXRlIHRoZSByb3V0ZSBieQogICAgLy9lbnVtZXJhdGluZyB0aGUgdGhlIGxpc3Qgb2Ygc2VnbWVudCBwYXR0ZXJucyBhcnJheQogICAgLy9pZiBvbmUgc2VnbWVudCBwYXR0ZXJucyBhcnJheSBtYXRjaCB0aGUgY3VycmVudCByb3V0ZSwgdGhlbgogICAgLy9lbnVtZXJhdGUgdGhlIHNlZ21lbnQgcGF0dGVybnMgYXJyYXkgdG8gZmluZCBvdXQgaWYKICAgIC8vYSBwYXR0ZXJuJ3MgbW9kZWwgcGF0aCBpcyBlcXVhbCB0byB0aGUgcGF0aCBvZiB0aGUgY2hhbmdlZCBtb2RlbAogICAgLy90aGVuIHVwZGF0ZSB0aGUgcGF0aCB3aXRoIHRoZSB1cGRhdGVkIG1vZGVsJ3MgdmFsdWUKICAgIGZ1bmN0aW9uIHVwZGF0ZVBhdGhPbk1vZGVsQ2hhbmdlKGUpIHsKCiAgICAgICAgdmFyIHJvdXRlU2VnbWVudCwKICAgICAgICAgICAgcGF0aFNlZ21lbnRzLAogICAgICAgICAgICBuZXdQYXRoLAogICAgICAgICAgICBxdWVyeVN0cmluZywKICAgICAgICAgICAgbW9kZWxQYXRoT2ZQdWJsaXNoZXIgPSBlLnB1Ymxpc2hlci5wYXRoLAogICAgICAgICAgICByb3V0ZVNlZ21lbnRzID0gZS5oYW5kbGVyLm9wdGlvbnMsCiAgICAgICAgICAgIHBhdGggPSBnZXRDdXJyZW50UGF0aCgpOwoKICAgICAgICBpZiAoaXNQYXRoTWF0Y2hlZEJ5Um91dGVTZWdtZW50cyhwYXRoLCByb3V0ZVNlZ21lbnRzKSkgewoKICAgICAgICAgICAgcGF0aFNlZ21lbnRzID0gcGF0aC5zcGxpdCgiLyIpOwoKICAgICAgICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCBwYXRoU2VnbWVudHMubGVuZ3RoOyBqKyspIHsKCiAgICAgICAgICAgICAgICByb3V0ZVNlZ21lbnQgPSByb3V0ZVNlZ21lbnRzW2pdOwoKICAgICAgICAgICAgICAgIGlmIChyb3V0ZVNlZ21lbnQuc3RhcnRzV2l0aCgiOiIpKSB7CgogICAgICAgICAgICAgICAgICAgIHZhciBtb2RlbFBhdGhJblJvdXRlU2VnbWVudCA9IHJvdXRlU2VnbWVudC5zdWJzdHIoMSk7CgogICAgICAgICAgICAgICAgICAgIGlmIChtb2RlbFBhdGhJblJvdXRlU2VnbWVudCA9PSBtb2RlbFBhdGhPZlB1Ymxpc2hlcikgewoKICAgICAgICAgICAgICAgICAgICAgICAgcGF0aFNlZ21lbnRzW2pdID0gcm9vdE5vZGUuZ2V0KG1vZGVsUGF0aE9mUHVibGlzaGVyKTsKICAgICAgICAgICAgICAgICAgICAgICAgbmV3UGF0aCA9IHBhdGhTZWdtZW50cy5qb2luKCIvIik7CiAgICAgICAgICAgICAgICAgICAgICAgIHF1ZXJ5U3RyaW5nID0gZ2V0UXVlcnlTdHJpbmcoKTsKICAgICAgICAgICAgICAgICAgICAgICAgLy9jb25zb2xlLmxvZyggcXVlcnlTdHJpbmcgPyBuZXdQYXRoICsgIj8iICsgcXVlcnlTdHJpbmcgOiBuZXdQYXRoICk7CiAgICAgICAgICAgICAgICAgICAgICAgIGxvY2F0aW9uLmhhc2ggPSBkZWZhdWx0T3B0aW9ucy5oYXNoUHJlZml4ICsgZGVmYXVsdE9wdGlvbnMucm91dGVQcmVmaXggKyAocXVlcnlTdHJpbmcgPyBuZXdQYXRoICsgIj8iICsgcXVlcnlTdHJpbmcgOiBuZXdQYXRoKTsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBpc1BhdGhNYXRjaGVkQnlSb3V0ZVNlZ21lbnRzKHBhdGgsIHJvdXRlU2VnbWVudHMpIHsKCiAgICAgICAgdmFyIHJvdXRlU2VnbWVudCwKICAgICAgICAgICAgcGF0aFNlZ21lbnRzOwoKICAgICAgICBpZiAoIXBhdGgpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgcGF0aFNlZ21lbnRzID0gcGF0aC5zcGxpdCgiLyIpOwoKICAgICAgICBpZiAocGF0aFNlZ21lbnRzLmxlbmd0aCAhPT0gcm91dGVTZWdtZW50cy5sZW5ndGgpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICB2YXIgaXNNYXRjaGVkID0gdHJ1ZTsKCiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwYXRoU2VnbWVudHMubGVuZ3RoOyBpKyspIHsKCiAgICAgICAgICAgIHJvdXRlU2VnbWVudCA9IHJvdXRlU2VnbWVudHNbaV07CgogICAgICAgICAgICAvL2lmIHJvdXRlU2VnbWVudCBpcyBtb2RlbCBwYXRoCiAgICAgICAgICAgIC8vZG9uJ3QgbmVlZCB0byBtYXRjaAogICAgICAgICAgICBpZiAocm91dGVTZWdtZW50LnN0YXJ0c1dpdGgoIjoiKSkgewogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChyb3V0ZVNlZ21lbnQgIT0gcGF0aFNlZ21lbnRzW2ldKSB7CiAgICAgICAgICAgICAgICBpc01hdGNoZWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gaXNNYXRjaGVkOwogICAgfQoKICAgIC8vY2hlY2sgaWYgY3VycmVudCBzZWdtZW50IHN0cmluZyBpcyBtYXRjaGVkIHdpdGggc2VnbWVudCBwYXR0ZXJucywgYW5kIHJldHVybiBtYXRjaGVkIHN0YXR1cwogICAgLy9pZiBtYXRjaGVkIGFsc28gdXBkYXRlIHRoZSBtb2RlbCB2YWx1ZSB3aXRoIHRoZSBzZWdtZW50IHZhbHVlCiAgICAvL2lmIHRoaXMgbWV0aG9kIGlzIGNhbGxlZCBpbiByZWdpc3RyYXRpb24gcHJvY2VzcywgYWxzbyByZWdpc3RyYXRpb24gaGFuZGxlciB0byBzdWJzY3JpYmUKICAgIC8vdGhlIGNoYW5nZSBvZiBtb2RlbCwgd2hlbiBtb2RlbCBjaGFuZ2UgdXBkYXRlIHRoZSBzZWdtZW50IHN0cmluZwogICAgZnVuY3Rpb24gcHJvY2Vzc1BhdGhXaXRoUm91dGVTZWdtZW50cyhwYXRoLCByb3V0ZVNlZ21lbnRzLCBpc1JlZ2lzdHJhdGlvbikgewoKICAgICAgICB2YXIgcm91dGVTZWdtZW50LAogICAgICAgICAgICBwYXRoU2VnbWVudHMsCiAgICAgICAgICAgIG1vZGVsUGF0aEluUm91dGVTZWdtZW50LAogICAgICAgICAgICBpc1BhdGhNYXRjaGVkID0gaXNQYXRoTWF0Y2hlZEJ5Um91dGVTZWdtZW50cyhwYXRoLCByb3V0ZVNlZ21lbnRzKTsKCiAgICAgICAgcGF0aFNlZ21lbnRzID0gcGF0aC5zcGxpdCgiLyIpOwoKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJvdXRlU2VnbWVudHMubGVuZ3RoOyBpKyspIHsKCiAgICAgICAgICAgIHJvdXRlU2VnbWVudCA9IHJvdXRlU2VnbWVudHNbaV07CgogICAgICAgICAgICBpZiAocm91dGVTZWdtZW50LnN0YXJ0c1dpdGgoIjoiKSkgewogICAgICAgICAgICAgICAgbW9kZWxQYXRoSW5Sb3V0ZVNlZ21lbnQgPSByb3V0ZVNlZ21lbnQuc3Vic3RyKDEpOwoKICAgICAgICAgICAgICAgIGlmIChpc1BhdGhNYXRjaGVkKSB7CiAgICAgICAgICAgICAgICAgICAgcm9vdE5vZGUuc2V0KG1vZGVsUGF0aEluUm91dGVTZWdtZW50LCBwYXRoU2VnbWVudHNbaV0pOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmIChpc1JlZ2lzdHJhdGlvbikgewogICAgICAgICAgICAgICAgICAgIGhtLnN1YihudWxsLyogbnVsbCBzdWJzY3JpYmVyKi8sIG1vZGVsUGF0aEluUm91dGVTZWdtZW50LCAiYWZ0ZXJVcGRhdGUiLCB1cGRhdGVQYXRoT25Nb2RlbENoYW5nZSwgcm91dGVTZWdtZW50cyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiBpc1BhdGhNYXRjaGVkOwogICAgfQoKICAgIGZ1bmN0aW9uIHJlcGxhY2VVcmxXaXRoTW9kZWxTdGF0ZShzZWdtZW50U3RyaW5nLCBzdGF0ZUluUXVlcnlTdHJpbmcpIHsKCiAgICAgICAgdmFyIGlzRW1wdHlRdWVyeSA9ICQuaXNFbXB0eU9iamVjdChzdGF0ZUluUXVlcnlTdHJpbmcpOwogICAgICAgIGlmICghc2VnbWVudFN0cmluZyAmJiBpc0VtcHR5UXVlcnkpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgdmFyIGN1cnJlbnRIYXNoID0gbG9jYXRpb24uaGFzaCwKICAgICAgICAgICAgdXJsUGF0aCA9IGxvY2F0aW9uLmhyZWYucmVwbGFjZShjdXJyZW50SGFzaCwgIiIpLAogICAgICAgICAgICBuZXdIYXNoID0gZGVmYXVsdE9wdGlvbnMuaGFzaFByZWZpeCArIGRlZmF1bHRPcHRpb25zLnJvdXRlUHJlZml4ICsgc2VnbWVudFN0cmluZyArIChpc0VtcHR5UXVlcnkgPyAiIiA6ICI/IiArICQucGFyYW0oc3RhdGVJblF1ZXJ5U3RyaW5nKSksCiAgICAgICAgICAgIG5ld1VybCA9IHVybFBhdGggKyAiIyIgKyBuZXdIYXNoOwoKICAgICAgICBpZiAoaGlzdG9yeS5yZXBsYWNlU3RhdGUpIHsKICAgICAgICAgICAgaGlzdG9yeS5yZXBsYWNlU3RhdGUobnVsbCwgbnVsbCwgbmV3VXJsKTsKCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbG9jYXRpb24uaHJlZiA9IG5ld1VybDsKCiAgICAgICAgfQogICAgfQoKICAgIC8vcmVnaXN0ZXIgdGhlIG1vZGVsIHBhdGggd2hpY2ggd2lsbCBiZSB0cmFja2VkIHRocm91Z2ggdGhlIHF1ZXJ5IHN0cmluZwogICAgLy9yb3V0ZVBhcmFtcyBzaG91bGQgYmUgY2FsbGVkIGFmdGVyIG1vZGVsIGluaXRpYWxpemF0aW9uCiAgICAvL2J1dCBiZWZvcmUgc3Vic2NyaXB0aW9uIHJlZ2lzdHJhdGlvbiwKICAgIC8vIHNvIHRoYXQgdGhlIHN0YXRlIGluIHF1ZXJ5IHN0cmluZyBjYW4gYmUgcmVzdG9yZWQKICAgIGhtLnJvdXRlUGFyYW1zID0gZnVuY3Rpb24gKC8qIHBhdGgxLCBwYXRoMiwgLi4gKi8pIHsKCiAgICAgICAgdmFyIGksCiAgICAgICAgICAgIG1vZGVsUGF0aCwKICAgICAgICAgICAgYXJncyA9IGFyZ3VtZW50cywKICAgICAgICAgICAgc3RhdGVJblF1ZXJ5U3RyaW5nID0gZ2V0U3RhdGVGcm9tUXVlcnlTdHJpbmcoKTsKCiAgICAgICAgLy91cGRhdGUgdGhlIG1vZGVsIGlmIG1vZGVsIHBhdGggaXMgaW4gcXVlcnkgc3RyaW5nCiAgICAgICAgZm9yIChpID0gMDsgaSA8IGFyZ3MubGVuZ3RoOyBpKyspIHsKCiAgICAgICAgICAgIG1vZGVsUGF0aCA9IGFyZ3NbaV07CgogICAgICAgICAgICAvL2lmIG1vZGVsUGF0aCBpcyBpbiB0aGUgcXVlcnkgc3RyaW5nCiAgICAgICAgICAgIC8vdXBkYXRlIHRoZSBtb2RlbCB3aXRoIHRoZSB2YWx1ZSBpbiBxdWVyeSBzdHJpbmcKICAgICAgICAgICAgaWYgKG1vZGVsUGF0aCBpbiBzdGF0ZUluUXVlcnlTdHJpbmcpIHsKCiAgICAgICAgICAgICAgICByb290Tm9kZS5zZXQobW9kZWxQYXRoLCBzdGF0ZUluUXVlcnlTdHJpbmdbbW9kZWxQYXRoXSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vdXBkYXRlIHF1ZXJ5IHN0cmluZyB3aGVuIG1vZGVsIGNoYW5nZQogICAgICAgICAgICBobS5zdWIobnVsbCwgbW9kZWxQYXRoLCAiYWZ0ZXJVcGRhdGUiLCB1cGRhdGVRdWVyeVN0cmluZ09uTW9kZWxDaGFuZ2UpOwogICAgICAgICAgICBwYXJhbVBhdGhzLnB1c2goYXJnc1tpXSk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gdGhpczsKICAgIH07CgogICAgaG1Gbi5yb3V0ZVBhcmFtcyA9IGZ1bmN0aW9uIChzdWJQYXRoKSB7CgogICAgICAgIHZhciBtb2RlbCA9IHRoaXM7CgogICAgICAgIGhtLnJvdXRlUGFyYW1zLmFwcGx5KAoKICAgICAgICAgICAgaG0sCgogICAgICAgICAgICAkLm1hcChzdWJQYXRoID8gYXJndW1lbnRzIDogWyIiXSwKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIChzdWJQYXRoKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG1vZGVsLmdldFBhdGgoc3ViUGF0aCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICkKICAgICAgICApOwoKICAgICAgICByZXR1cm4gbW9kZWw7CgogICAgfTsKCiAgICAvL3JlZ2lzdGVyIHRoZSBzZWdtZW50IHBhdHRlcm5zIHdoaWNoIHdpbGwgYmUgdXNlZCB0byBtYXRjaCBhIHBhdGgKICAgIC8vYSBwYXRoIGlzIGNvbnNpc3RzIG9mIG11bHRpcGxlIHNlZ21lbnQKICAgIC8vIEEgcGF0aCBsaWtlICIvcHVibGljL2NvbmZpZy9wZXJzb25hbCIsIGNvbnNpc3Qgb2Ygc2VnbWVudHMgWyJwdWJsaWMiLCAiY29uZmlnIiwgInBlcnNvbmFsIl0KICAgIC8vdGhpcyBtZXRob2QgdHJ5IHRvIHVzZSBhIG1hdGNoZXIgdG8gdGVzdCBlYWNoIHNlZ21lbnRzCiAgICAvL2htLnJvdXRlKHNlZ21lbnRNYXRjaGVyMSwgc2VnbWVudE1hdGNoZXIyLCAuLi4pCiAgICAvL2VhY2ggc2VnbWVudCBtYXRjaGVyIGlzIGxpa2UgW3BhdGgsIG1hdGNoZXJdCiAgICAvL3NvIGl0IGlzIGxpa2UKICAgIC8vaG0ucm91dGUoW3BhdGgxLCBtYXRjaGVyMV0sIFtwYXRoMiwgbWF0Y2hlcjJdLCAuLi4pOwogICAgLy9leGFtcGxlIG9mIHNlZ21lbnQgcGF0dGVybiBhcmUgYXMgZm9sbG93aW5nCiAgICAvL3N0cmluZyBlZzogICJwdWJsaWMiLCB3aGljaCBpcyBhIGZpeGVkIHZhbHVlLCB3aGljaCBkb2VzIG5vdCBtYXBwZWQgdG8gYSBtb2RlbAogICAgLy90aGUgZm9sbG93aW5nIG1hcHBlZCB0byBhIG1vZGVsCiAgICAvL2FycmF5IGVnOiBbICJtb2RlbFBhdGgiLCBudWxsXSBvciBbICJtb2RlbFBhdGgiXSwgY29uc3RyYWludCBpcyBudWxsCiAgICAvL2FycmF5IGVnOiBbICJtb2RlbFBhdGgiLCAiZml4ZWRWYWx1ZSIgXSwgY29uc3RyYWludCBpcyAiZml4ZWRWYWx1ZSIKICAgIC8vYXJyYXkgZWc6IFsgIm1vZGVsUGF0aCIsIC9yZWdleC8gXSwgY29uc3RyYWludCBpcyByZWd1bGFyIGV4cHJlc3Npb24KICAgIC8vYXJyYXkgZWc6IFsgIm1vZGVsUGF0aCIsIGZ1bmN0aW9uIChzZWdtZW50KSB7IHJldHVybiBib29sZWFuOyB9IF0sIGNvbnN0cmFpbnQgaXMgYSBmdW5jdGlvbgogICAgaG0ucm91dGVQYXRoID0gZnVuY3Rpb24gKHJvdXRlLCBpc0RlZmF1bHQpIHsKCiAgICAgICAgdmFyIHJvdXRlU2VnbWVudHMgPSByb3V0ZS5zcGxpdCgiLyIpOwoKICAgICAgICBsaXN0T2ZSb3V0ZVNlZ21lbnRzLnB1c2gocm91dGVTZWdtZW50cyk7CgogICAgICAgIGlmIChpc0RlZmF1bHQpIHsKICAgICAgICAgICAgZGVmYXVsdFJvdXRlU2VnbWVudHMgPSByb3V0ZVNlZ21lbnRzOwogICAgICAgIH0KCiAgICAgICAgdmFyIGN1cnJlbnRQYXRoID0gZ2V0Q3VycmVudFBhdGgoKTsKCiAgICAgICAgaWYgKHByb2Nlc3NQYXRoV2l0aFJvdXRlU2VnbWVudHMoY3VycmVudFBhdGgsIHJvdXRlU2VnbWVudHMsIHRydWUpKSB7CiAgICAgICAgICAgIGluaXRpYWxSb3V0ZU1hdGNoZWRCeVBhdHRlcm5zID0gdHJ1ZTsKICAgICAgICB9CiAgICB9OwoKICAgIGhtLnVwZGF0ZVJvdXRlID0gZnVuY3Rpb24gLyp1cGRhdGVNb2RlbFdoZW5IYXNoQ2hhbmdlZCovKCkgewoKCiAgICAgICAgLy91cGRhdGUgbW9kZWwgd2hlbiBzZWdtZW50IHN0cmluZyBjaGFuZ2UKICAgICAgICB2YXIgaSwgbW9kZWxQYXRoLAogICAgICAgICAgICBzZWdtZW50U3RyaW5nID0gZ2V0Q3VycmVudFBhdGgoKSwKICAgICAgICAgICAgc3RhdGVJblF1ZXJ5U3RyaW5nID0gZ2V0U3RhdGVGcm9tUXVlcnlTdHJpbmcoKTsKCiAgICAgICAgaWYgKHNlZ21lbnRTdHJpbmcpIHsKICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGxpc3RPZlJvdXRlU2VnbWVudHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIGlmIChwcm9jZXNzUGF0aFdpdGhSb3V0ZVNlZ21lbnRzKHNlZ21lbnRTdHJpbmcsIGxpc3RPZlJvdXRlU2VnbWVudHNbaV0pKSB7CiAgICAgICAgICAgICAgICAgICAgLy9zaG9ydGN1dCB3aGVuIHRoZSBmaXJzdCBzZWdtZW50IHBhdHRlcm5zIG1hdGNoCiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vaWYgc2VnbWVudFN0cmluZyBpcyBlbXB0eSBhbmQgaXQgaGFzIGRlZmF1bHRTZWdtZW50UGF0dGVybgogICAgICAgICAgICAvL3RyeSB0byBidWlsZCBhIHNlZ21lbnQgc3RyaW5nIGZyb20gdGhlIGRlZmF1bHQgc2VnbWVudCBwYXR0ZXJucwogICAgICAgIH0gZWxzZSBpZiAoZGVmYXVsdFJvdXRlU2VnbWVudHMpIHsKCiAgICAgICAgICAgIHZhciBzZWdtZW50cyA9IFtdOwogICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgZGVmYXVsdFJvdXRlU2VnbWVudHMubGVuZ3RoOyBpKyspIHsKCiAgICAgICAgICAgICAgICB2YXIgc2VnbWVudFBhdHRlcm4gPSBkZWZhdWx0Um91dGVTZWdtZW50c1tpXTsKCiAgICAgICAgICAgICAgICBpZiAoaXNTdHJpbmcoc2VnbWVudFBhdHRlcm4pKSB7CiAgICAgICAgICAgICAgICAgICAgc2VnbWVudHMucHVzaChzZWdtZW50UGF0dGVybik7CgogICAgICAgICAgICAgICAgfSBlbHNlIHsKCiAgICAgICAgICAgICAgICAgICAgdmFyIG1vZGVsVmFsdWUgPSByb290Tm9kZS5nZXQoc2VnbWVudFBhdHRlcm5bMF0pICsgIiI7CiAgICAgICAgICAgICAgICAgICAgc2VnbWVudHMucHVzaChtb2RlbFZhbHVlIHx8IHNlZ21lbnRQYXR0ZXJuLmRlZmF1bHRWYWx1ZSB8fCAiIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHNlZ21lbnRTdHJpbmcgPSBzZWdtZW50cy5qb2luKCIvIik7CiAgICAgICAgfQoKICAgICAgICAvL3VwZGF0ZSBtb2RlbCB3aGVuIHF1ZXJ5IHN0cmluZyBjaGFuZ2UKICAgICAgICBmb3IgKG1vZGVsUGF0aCBpbiBzdGF0ZUluUXVlcnlTdHJpbmcpIHsKICAgICAgICAgICAgaWYgKHBhcmFtUGF0aHMuY29udGFpbnMobW9kZWxQYXRoKSkgewogICAgICAgICAgICAgICAgcm9vdE5vZGUuc2V0KG1vZGVsUGF0aCwgc3RhdGVJblF1ZXJ5U3RyaW5nW21vZGVsUGF0aF0pOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvL3VwZGF0ZSBzdGF0ZSBpbiBxdWVyeSBzdHJpbmcKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgcGFyYW1QYXRocy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBtb2RlbFBhdGggPSBwYXJhbVBhdGhzW2ldOwogICAgICAgICAgICBzdGF0ZUluUXVlcnlTdHJpbmdbbW9kZWxQYXRoXSA9IHJvb3ROb2RlLmdldChtb2RlbFBhdGgpOwogICAgICAgIH0KICAgICAgICAvLwogICAgICAgIHJlcGxhY2VVcmxXaXRoTW9kZWxTdGF0ZShzZWdtZW50U3RyaW5nLCBzdGF0ZUluUXVlcnlTdHJpbmcpOwogICAgfTsKCiAgICAvL3VwZGF0ZSBtb2RlbCB3aGVuIGhhc2ggY2hhbmdlCiAgICAkKHdpbmRvdykuYmluZCgiaGFzaGNoYW5nZSIsIGhtLnVwZGF0ZVJvdXRlKTsKCiAgICAkKGZ1bmN0aW9uICgpIHsKCiAgICAgICAgLy90cnkgdG8gYnVpbGQgdGhlIGluaXRpYWwgaGFzaCBmcm9tIHRoZSBtb2RlbAoKICAgICAgICB2YXIgaSwgcm91dGUgPSAiIjsKCiAgICAgICAgLy9pZiB0aGVyZSBpcyBkZWZhdWx0IHNlZ21lbnQgcGF0dGVybiBhbmQgdGhlIGluaXRpYWwgc2VnbWVudCBzdHJpbmcKICAgICAgICAvL2lzIG5vdCBtYXRjaGVkIGJ5IGFueSBwYXR0ZXJucywgdGhlbiB1c2UgdGhlIGRlZmF1bHQgc2VnbWVudCBwYXR0ZXJuCiAgICAgICAgLy90byBidWlsZCB0aGUgc2VnbWVudCBzdHJpbmcKICAgICAgICBpZiAoZGVmYXVsdFJvdXRlU2VnbWVudHMgJiYgIWluaXRpYWxSb3V0ZU1hdGNoZWRCeVBhdHRlcm5zKSB7CgogICAgICAgICAgICB2YXIgcGF0aFNlZ21lbnRzID0gW107CiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBkZWZhdWx0Um91dGVTZWdtZW50cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgdmFyIHJvdXRlU2VnbWVudCA9IGRlZmF1bHRSb3V0ZVNlZ21lbnRzW2ldOwoKICAgICAgICAgICAgICAgIGlmIChyb3V0ZVNlZ21lbnQuc3RhcnRzV2l0aCgiOiIpKSB7CgogICAgICAgICAgICAgICAgICAgIHBhdGhTZWdtZW50cy5wdXNoKHJvb3ROb2RlLmdldChyb3V0ZVNlZ21lbnQuc3Vic3RyKDEpKSArICIiKTsKCiAgICAgICAgICAgICAgICB9IGVsc2UgewoKICAgICAgICAgICAgICAgICAgICBwYXRoU2VnbWVudHMucHVzaChyb3V0ZVNlZ21lbnQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICByb3V0ZSA9IHBhdGhTZWdtZW50cy5qb2luKCIvIik7CgogICAgICAgIH0gZWxzZSB7CgogICAgICAgICAgICByb3V0ZSA9IGdldEN1cnJlbnRQYXRoKCk7CiAgICAgICAgfQoKICAgICAgICB2YXIgc3RhdGVJblF1ZXJ5U3RyaW5nID0gZ2V0U3RhdGVGcm9tUXVlcnlTdHJpbmcoKTsKCiAgICAgICAgLy91cGRhdGUgc3RhdGUgaW4gcXVlcnkgc3RyaW5nCiAgICAgICAgZm9yIChpID0gMDsgaSA8IHBhcmFtUGF0aHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgdmFyIG1vZGVsUGF0aCA9IHBhcmFtUGF0aHNbaV07CiAgICAgICAgICAgIHN0YXRlSW5RdWVyeVN0cmluZ1ttb2RlbFBhdGhdID0gcm9vdE5vZGUuZ2V0KG1vZGVsUGF0aCk7CiAgICAgICAgfQogICAgICAgIHJlcGxhY2VVcmxXaXRoTW9kZWxTdGF0ZShyb3V0ZSwgc3RhdGVJblF1ZXJ5U3RyaW5nKTsKICAgIH0pOwoKICAgIC8vI2RlYnVnCgogICAgLy8jZW5kX2RlYnVnCgovLwovLzxAZGVwZW5kcz5zdWJzY3JpcHRpb24uanMsIG1vZGVsLmpzLCBkZWNsYXJhdGl2ZS5qcywgdGVtcGxhdGUuanM8L0BkZXBlbmRzPgovLwoKCgoJZGVmYXVsdE9wdGlvbnMuc2VsZWN0ZWRDbGFzcyA9ICJzZWxlY3RlZCI7CglkZWZhdWx0T3B0aW9ucy50YWJWaWV3QXR0ciA9ICJ0YWItdmlldyI7CglkZWZhdWx0T3B0aW9ucy50YWJMaW5rQXR0ciA9ICJ0YWItbGluayI7CglkZWZhdWx0T3B0aW9ucy50YWJDb250YWluZXJOYW1lQXR0ciA9ICJ0YWItY29udGFpbmVyLW5hbWUiOwoKCWhtLndvcmtmbG93KCB7CgoJCS8vYSB0YWIgY2FuIGJlIHRhYlZpZXcgb3IgdGFiTGluawoJCXNlbGVjdFRhYjogZnVuY3Rpb24oIGUgKSB7CgkJCXZhciB0YWJJZCA9IHRoaXMuYXR0ciggZGVmYXVsdE9wdGlvbnMudGFiVmlld0F0dHIgKSB8fCB0aGlzLmF0dHIoIGRlZmF1bHRPcHRpb25zLnRhYkxpbmtBdHRyICksCgkJCQlzZWxlY3RlZENsYXNzID0gZS5oYW5kbGVyLm9wdGlvbnM7CgoJCQlpZiAoZS5wdWJsaXNoZXIuZ2V0KCkgPT0gdGFiSWQpIHsKCQkJCXRoaXMuYWRkQ2xhc3MoIHNlbGVjdGVkQ2xhc3MgKTsKCQkJfSBlbHNlIHsKCQkJCXRoaXMucmVtb3ZlQ2xhc3MoIHNlbGVjdGVkQ2xhc3MgKTsKCQkJfQoJCX0sCgoJCS8vYSB0YWIgY2FuIGJlIHRhYlZpZXcgb3IgdGFiTGluawoJCXNlbGVjdFRhYkluQ29udGFpbmVyOiBmdW5jdGlvbiggZSApIHsKCQkJdmFyIHNlbGVjdGVkVGFiSWQgPSBlLnB1Ymxpc2hlci5nZXQoKSwKCQkJCXRhYlZpZXdBdHRyID0gZGVmYXVsdE9wdGlvbnMudGFiVmlld0F0dHIsCgkJCQl0YWJMaW5rQXR0ciA9IGRlZmF1bHRPcHRpb25zLnRhYkxpbmtBdHRyLAoJCQkJb3B0aW9ucyA9IGUuaGFuZGxlci5vcHRpb25zLAoJCQkJdGFiTGlua0FuZFRhYlZpZXdTZWxlY3RvciA9IG9wdGlvbnMuc2VsZWN0b3IsCgkJCQlzZWxlY3RlZENsYXNzID0gb3B0aW9ucy5zZWxlY3RlZENsYXNzOwoKCQkJdGhpcy5maW5kKCB0YWJMaW5rQW5kVGFiVmlld1NlbGVjdG9yICkuYW5kU2VsZigpLmVhY2goIGZ1bmN0aW9uKCBpbmRleCwgZWxlbSApIHsKCQkJCXZhciAkZWxlbSA9ICQoIGVsZW0gKSwKCQkJCQl0YWJJZCA9ICRlbGVtLmF0dHIoIHRhYlZpZXdBdHRyICkgfHwgJGVsZW0uYXR0ciggdGFiTGlua0F0dHIgKTsKCgkJCQlpZiAodGFiSWQgPT0gc2VsZWN0ZWRUYWJJZCkgewoJCQkJCSRlbGVtLmFkZENsYXNzKCBzZWxlY3RlZENsYXNzICk7CgkJCQl9IGVsc2UgewoJCQkJCSRlbGVtLnJlbW92ZUNsYXNzKCBzZWxlY3RlZENsYXNzICk7CgkJCQl9CgkJCX0gKTsKCQl9Cgl9ICk7CgoJZnVuY3Rpb24gaGFuZGxlVGFiTGlua0NsaWNrKCBlICkgewoJCS8vdGhpcyBpcyB0aGUgc3Vic2NyaWJlciwgd2hpY2ggaXMgdGhlIG1vZGVsCgkJLy9lLmhhbmRsZXIub3B0aW9ucyBpcyB0aGUgdGFiIGlkCgkJdGhpcy5zZXQoIGUucHVibGlzaGVyLmF0dHIoIGUuaGFuZGxlci5vcHRpb25zICkgKTsKCQllLnByZXZlbnREZWZhdWx0KCk7CgkJZS5zdG9wUHJvcGFnYXRpb24oKTsKCgl9CgoJLy9hIHRhYiBjYW4gYmUgdGFiVmlldyBvciB0YWJMaW5rCgkvL2ZvciB0YWJMaW5rIHVzZSA8bGkgdGFiLWxpbms9Im5ld3MiIHRhYj0iY2F0ZWdvcnkiPk5ld3M8L2xpPgoJLy9pZiB5b3VyIHNlbGVjdGVkIGNsYXNzIGlzIG5vdCAic2VsZWN0ZWQiIGJ1dCAiYWN0aXZlIiB1c2UKCS8vIDxsaSB0YWItbGluaz0ibmV3cyIgdGFiPSJjYXRlZ29yeXxhY3RpdmUiPk5ld3M8L2xpPgoJLy8KCS8vZm9yIHRhYlZpZXcgdXNlIDxkaXYgdGFiLXZpZXc9Im5ld3MiIHRhYj0iY2F0ZWdvcnkiPmNvbnRlbnRzPC9kaXY+CgkvL29yIDxkaXYgdGFiLXZpZXc9Im5ld3MiIHRhYj0iY2F0ZWdvcnl8YWN0aXZlIj5jb250ZW50czwvZGl2PgoJYmluZGluZ3MoIHsKCgkJdGFiOiBmdW5jdGlvbiggZWxlbSwgcGF0aCwgYmluZGluZywgc2VsZWN0ZWRDbGFzcyApIHsKCgkJCXNlbGVjdGVkQ2xhc3MgPSBzZWxlY3RlZENsYXNzIHx8IGRlZmF1bHRPcHRpb25zLnNlbGVjdGVkQ2xhc3M7CgoJCQliaW5kaW5nLmFwcGVuZFN1YiggZWxlbSwgcGF0aCwgImluaXQgYWZ0ZXJVcGRhdGUiLCAiKnNlbGVjdFRhYiIsIHNlbGVjdGVkQ2xhc3MgKTsKCgkJCWlmICgkKCBlbGVtICkuYXR0ciggZGVmYXVsdE9wdGlvbnMudGFiTGlua0F0dHIgKSkgewoJCQkJYmluZGluZy5hcHBlbmRTdWIoIHBhdGgsIGVsZW0sICJjbGljayIsIGhhbmRsZVRhYkxpbmtDbGljaywgZGVmYXVsdE9wdGlvbnMudGFiTGlua0F0dHIgKTsKCQkJfQoKCQl9LAoKCQkvL2EgdGFiQ29udGFpbmVyIGNhbiBob2xkIHRhYkxpbmsgb3IgdGFiVmlldwoJCS8vaXQgY2FuIGJlCgkJLy8KCQkvLzx1bCB0YWItY29udGFpbmVyPSJjYXRlZ29yeSI+CgkJLy8JPGxpIHRhYi1saW5rPSJuZXdzIj5OZXdzPC9saT4KCQkvLwk8bGkgdGFiLWxpbms9Im9waW5pb24iPk9waW5pb248L2xpPgoJCS8vCTxsaSB0YWItbGluaz0ic3BvcnRzIj5TcG9ydHM8L2xpPgoJCS8vPC91bD4KCQkvLwoJCS8vPGRpdiBjbGFzcz0idGFicyIgdGFiLWNvbnRhaW5lcj0iY2F0ZWdvcnkiPgoJCS8vCTxkaXYgdGFiLXZpZXc9Im5ld3MiPmNvbnRlbnQ8L2Rpdj4KCQkvLwk8ZGl2IHRhYi12aWV3PSJvcGluaW9uIj5jb250ZW50PC9kaXY+CgkJLy88L2Rpdj4KCQkvL29wdGlvbnMgdXNhZ2UKCQkvL3RhYi1jb250YWluZXI9ImNhdGVnb3J5fGNvbnRhaW5lck5hbWUsc2VsZWN0ZWRDbGFzcyIKCQkvL2lmIHlvdSBoYXZlIHRhYiBjb250YWluZXIgbmVzdGVkIHdpdGhpbiBhbm90aGVyIHRhYiBjb250YWluZXIKCQkvL3lvdSBjYW4gdXNlIGNvbnRhaW5lciBuYW1lIHRvIHNwZWNpZnkgd2hpY2ggY29udGFpbmVyIGl0IGlzIGluCgkJdGFiQ29udGFpbmVyOiBmdW5jdGlvbiggZWxlbSwgcGF0aCwgY29udGV4dCwgb3B0aW9ucyApIHsKCgkJCW9wdGlvbnMgPSBvcHRpb25zIHx8ICIiOwoJCQlvcHRpb25zID0gb3B0aW9ucy5zcGxpdCggIiwiICk7CgoJCQl2YXIgdGFiVmlld0F0dHIgPSBkZWZhdWx0T3B0aW9ucy50YWJWaWV3QXR0ciwKCQkJCXRhYkxpbmtBdHRyID0gZGVmYXVsdE9wdGlvbnMudGFiTGlua0F0dHIsCgkJCQl0YWJDb250YWluZXJOYW1lQXR0ciA9IGRlZmF1bHRPcHRpb25zLnRhYkNvbnRhaW5lck5hbWVBdHRyLAoJCQkJY29udGFpbmVyTmFtZSA9IG9wdGlvbnNbMF0sCgkJCQlzZWxlY3RlZENsYXNzID0gb3B0aW9uc1sxXSwKCgkJCQl0YWJDb250YWluZXJTZWxlY3RvciA9IGNvbnRhaW5lck5hbWUgPwoJCQkJCSJbIiArIHRhYkNvbnRhaW5lck5hbWVBdHRyICsgIj0nIiArIGNvbnRhaW5lck5hbWUgKyAiJ10iIC8vd2l0aCBleHBsaWNpdCB0YWIgY29udGFpbmVyIG5hbWUKCQkJCQk6ICIiLCAvL25vIHRhYiBjb250YWluZXIgbmFtZQoKCQkJCXRhYkxpbmtTZWxlY3RvciA9ICJbIiArIHRhYkxpbmtBdHRyICsgIl0iICsgdGFiQ29udGFpbmVyU2VsZWN0b3IsCgoJCQkJdGFiTGlua0FuZFRhYlZpZXdTZWxlY3RvciA9IHRhYkxpbmtTZWxlY3RvciArICIsWyIgKyB0YWJWaWV3QXR0ciArICJdIiArIHRhYkNvbnRhaW5lclNlbGVjdG9yOwoKCQkJLy91cGRhdGUgdGhlIHRhYiBtb2RlbCB3aXRoIHRoZSB0YWJMaW5rIHdoZW4gY2xpY2sKCQkJY29udGV4dC5hcHBlbmRTdWIoIHBhdGgsIGVsZW0sICJjbGljayIsIGhhbmRsZVRhYkxpbmtDbGljaywgdGFiTGlua0F0dHIsIHRhYkxpbmtTZWxlY3RvciAvKmRlbGVnYXRlU2VsZWN0b3IqLyApOwoKCQkJLy8KCQkJLy9oaWdobGlnaHQgdGhlIHRhYiB3aGVuIHRoZSBtb2RlbCBjaGFuZ2UKCQkJY29udGV4dC5hcHBlbmRTdWIoIGVsZW0sIHBhdGgsICJpbml0MTAwIGFmdGVyVXBkYXRlIiwgIipzZWxlY3RUYWJJbkNvbnRhaW5lciIsIHsKCQkJCXNlbGVjdG9yOiB0YWJMaW5rQW5kVGFiVmlld1NlbGVjdG9yLAoJCQkJc2VsZWN0ZWRDbGFzczogc2VsZWN0ZWRDbGFzcyB8fCBkZWZhdWx0T3B0aW9ucy5zZWxlY3RlZENsYXNzCgkJCX0gKTsKCQl9Cgl9ICk7CgovL2RhdGEtc3ViPSJAYXBwOmFwcE5hbWUsb3B0aW9ucyIKCgoJdmFyIHJEb3QgPSAvXC4vZywKCQlhcHBTdG9yZSA9IHt9LAoJLy91c2VkIHRvIG1hdGNoICJhcHBOYW1lLG9wdGlvbnMiCgkJckFwcE9wdGlvbnMgPSAvXihbXixdKykoLCguKykpPyQvLAoJCXJMb2FkQXBwT3B0aW9ucyA9IC9eKFteLF0rKSgsKFteLF0rKSk/KCwoLispKT8kLzsKCgkvL3lvdSBhcHAgc2hvdWxkIGltcGxlbWVudCBsb2FkKGVsZW0sIG9wdGlvbnMpIGFuZCB1bmxvYWQoZWxlbSkgbWV0aG9kCgoJaG0uQXBwID0gaG0uQ2xhc3MuZXh0ZW5kKAoKCQkvL2luc3RhbmNlIG1lbWJlcnMKCQl7CgkJCS8vZXhpc3RzIHNpbXBseSBmb3IgZW5zdXJlIGFwcCBtdXN0IGhhdmUgYSBuYW1lCgkJCWluaXRpYWxpemU6IGZ1bmN0aW9uKCBhcHAgKSB7CgoJCQkJaWYgKCFhcHAubmFtZSkgewoJCQkJCXRocm93ICJBbiBhcHAgbXVzdCBoYXZlIGEgbmFtZS4iOwoJCQkJfQoJCQkJdGhpcy5jYWxsQmFzZSggImluaXRpYWxpemUiLCBhcHAgKTsKCgkJCX0sCgoJCQkvL2l0IGFkZCBhZGRpdGlvbmFsIGxvZ2ljIGJlc2lkZSB0aGUgb3JpZ2luYWwgbG9hZCBtZXRob2QKCQkJLy9zdWNoIGFzIGluc3RhbmNlIGNvdW50aW5nLCBpbnN0YW5jZSBhc3NvY2lhdGlvbiB3aXRoIHRoZSBjb250YWluZXIKCQkJLy9wcmVwYXJlIHRvIHVubG9hZCBmcm9tIHRoZSBjb250YWluZXIKCQkJbG9hZDogZnVuY3Rpb24oICR2aWV3Q29udGFpbmVyLCBobU1vZGVsQ29udGFpbmVyLCBvcHRpb25zICkgewoJCQkJaWYgKCEkdmlld0NvbnRhaW5lciB8fCAhdGhpcy5sb2FkYWJsZSgpKSB7CgkJCQkJcmV0dXJuOwoJCQkJfQoJCQkJdmFyIGFwcCA9IHRoaXMsCgkJCQkJYnVpbGRNb2RlbFJlc3VsdCwKCQkJCQlhcHBOYW1lID0gYXBwLm5hbWUsCgkJCQkJYXBwSW5zdGFuY2UgPSBpbnN0YW5jZU1hbmFnZXIuZ2V0KCAkdmlld0NvbnRhaW5lclswXSwgYXBwTmFtZSApOwoKCQkJCS8vZW5zdXJlIHRoYXQgYW4gYXBwbGljYXRpb24gY2FuIGJlIGxvYWRlZCBpbnRvIGEgY29udGFpbmVyIG9ubHkgb25jZQoJCQkJaWYgKGFwcEluc3RhbmNlKSB7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmIChhcHAubG9hZE1vZGVsKSB7CgkJCQkJYnVpbGRNb2RlbFJlc3VsdCA9IGFwcC5sb2FkTW9kZWwoIGhtTW9kZWxDb250YWluZXIsIG9wdGlvbnMgKTsKCgkJCQl9CgoJCQkJdmFyIGNvbnRpbnVhdGlvbiA9IGZ1bmN0aW9uKCkgewoKCQkJCQlhcHAubG9hZFZpZXcoICR2aWV3Q29udGFpbmVyLCBobU1vZGVsQ29udGFpbmVyICk7CgkJCQkJaW5zdGFuY2VNYW5hZ2VyLmFkZCggJHZpZXdDb250YWluZXJbMF0sIGhtTW9kZWxDb250YWluZXIucGF0aCwgYXBwTmFtZSwgYXBwICk7CgkJCQkJJHZpZXdDb250YWluZXIuYmluZCggImV4aXRBcHAuIiArIGFwcE5hbWUsIGZ1bmN0aW9uKCBlICkgewoJCQkJCQlhcHAudW5sb2FkKCAkKCB0aGlzICkgKTsKCQkJCQkJZS5zdG9wUHJvcGFnYXRpb24oKTsKCQkJCQl9ICk7CgoJCQkJCWFwcC5pbnN0YW5jZUNvdW50Kys7CgkJCQkJYXBwLnVpZCsrOwoJCQkJfTsKCgkJCQlpZiAoaXNQcm9taXNlKCBidWlsZE1vZGVsUmVzdWx0ICkpIHsKCgkJCQkJYnVpbGRNb2RlbFJlc3VsdC5kb25lKCBjb250aW51YXRpb24gKTsKCgkJCQl9IGVsc2UgewoJCQkJCWNvbnRpbnVhdGlvbigpOwoKCQkJCX0KCgkJCX0sCgoJCQl1bmxvYWQ6IGZ1bmN0aW9uKCAkdmlld0NvbnRhaW5lciApIHsKCgkJCQl2YXIgYXBwTmFtZSA9IHRoaXMubmFtZTsKCQkJCXZhciBhcHBJbnN0YW5jZSA9IGluc3RhbmNlTWFuYWdlci5nZXQoICR2aWV3Q29udGFpbmVyWzBdLCBhcHBOYW1lICk7CgoJCQkJdGhpcy51bmxvYWRWaWV3KCAkdmlld0NvbnRhaW5lciApOwoKCQkJCXRoaXMudW5sb2FkTW9kZWwoIGFwcEluc3RhbmNlLm1vZGVsTm9kZSApOwoKCQkJCWluc3RhbmNlTWFuYWdlci5yZW1vdmUoICR2aWV3Q29udGFpbmVyWzBdLCBhcHBOYW1lICk7CgoJCQkJJHZpZXdDb250YWluZXIudW5iaW5kKCAiZXhpdEFwcC4iICsgYXBwTmFtZSApOwoKCQkJCXRoaXMuaW5zdGFuY2VDb3VudC0tOwoJCQl9LAoKCQkJLy9mdW5jdGlvbiggbW9kZWxDb250YWluZXIsIG9wdGlvbnMgKSB7fQoJCQlnZXRJbml0aWFsRGF0YTogbnVsbCwKCgkJCS8vZGVmYXVsdCBpbXBsZW1lbnRhdGlvbiBvZiBsb2FkTW9kZWwgaXMgdG8gY2FsbAoJCQkvL2FwcC5nZXRJbml0aWFsRGF0YSgpIGFuZCBwdXQgdGhlIHJlc3VsdCBpbnRvIG1vZGVsCgkJCS8vCgkJCS8vWW91IGNhbiBzZXQgbG9hZE1vZGVsIHRvIG51bGwgdG8gc3BlY2lmeSB0aGF0CgkJCS8vIHRoZXJlIGlzIG5vIG5lZWQgdG8gYnVpbGQgbW9kZWwKCQkJbG9hZE1vZGVsOiBmdW5jdGlvbiggaG1Nb2RlbENvbnRhaW5lciwgb3B0aW9ucyApIHsKCQkJCXZhciBhcHAgPSB0aGlzOwoJCQkJaWYgKCFhcHAuZ2V0SW5pdGlhbERhdGEpIHsKCQkJCQl0aHJvdyAiYXBwLmdldEluaXRpYWxEYXRhIGlzIG5vdCBpbXBsZW1lbnRlZCI7CgkJCQl9CgoJCQkJdmFyIGRhdGEgPSBhcHAuZ2V0SW5pdGlhbERhdGEoIGhtTW9kZWxDb250YWluZXIsIG9wdGlvbnMgKTsKCgkJCQlpZiAoaXNQcm9taXNlKCBkYXRhICkpIHsKCQkJCQlyZXR1cm4gZGF0YS5kb25lKCBmdW5jdGlvbiggZGF0YSApIHsKCQkJCQkJYXBwLmdldE1vZGVsTm9kZSggaG1Nb2RlbENvbnRhaW5lciApLnNldCggZGF0YSApOwoJCQkJCX0gKTsKCQkJCX0gZWxzZSB7CgkJCQkJYXBwLmdldE1vZGVsTm9kZSggaG1Nb2RlbENvbnRhaW5lciApLnNldCggZGF0YSApOwoJCQkJfQoKCQkJfSwKCgkJCXVubG9hZE1vZGVsOiBmdW5jdGlvbiggbW9kZWxOYW1lc3BhY2UgKSB7CgkJCQlpZiAodGhpcy5sb2FkTW9kZWwpIHsKCQkJCQlobS5kZWwoIG1vZGVsTmFtZXNwYWNlICk7CgkJCQl9CgkJCX0sCgoJCQkvL3RoZSBkZWZhdWx0IGxvYWRWaWV3IHdpbGwgY3JlYXRlIGEgY29udGFpbmVyCgkJCS8vPGRpdiBhcHBuYW1lPSJ4eHgiIG5zPSJ4eHgiPjwvZGl2PgoJCQlsb2FkVmlldzogZnVuY3Rpb24oICR2aWV3Q29udGFpbmVyLCBobU1vZGVsQ29udGFpbmVyICkgewoKCQkJCXZhciBuYW1lc3BhY2UgPSB0aGlzLmdldE1vZGVsTm9kZSggaG1Nb2RlbENvbnRhaW5lciApLnBhdGgsCgkJCQkJdmlld1dyYXBwZXIgPSAkKCAiPGRpdj48L2Rpdj4iICkKCQkJCQkJLmF0dHIoICJhcHBuYW1lIiwgdGhpcy5uYW1lICkKCQkJCQkJLmF0dHIoICJucyIsIG5hbWVzcGFjZSApOwoKCQkJCXZpZXdXcmFwcGVyLmhtRGF0YSggIm5zIiwgbmFtZXNwYWNlICk7CgoJCQkJdmlld1dyYXBwZXIuYXBwZW5kVG8oICR2aWV3Q29udGFpbmVyICkudG1wbCgKCQkJCQl0aGlzLmdldFRlbXBsYXRlT3B0aW9ucygpLAoJCQkJCW5hbWVzcGFjZSApOwoKCQkJfSwKCgkJCXVubG9hZFZpZXc6IGZ1bmN0aW9uKCAkdmlld0NvbnRhaW5lciApIHsKCQkJCSR2aWV3Q29udGFpbmVyLmZpbmQoICI+IFthcHBuYW1lPSciICsgdGhpcy5uYW1lICsgIiddIiApLnJlbW92ZSgpOwoJCQl9LAoKCQkJLy90ZW1wbGF0ZU9wdGlvbnMgaXMgYWJvdXQgdGVtcGxhdGUgaWQKCQkJLy9ieSBkZWZhdWx0IHlvdSBjYW4gZ2V0IHRlbXBsYXRlT3B0aW9ucyBwcm9wZXJ0eSBvcgoJCQkvL3RoZSBhcHBsaWNhdGlvbiBuYW1lIGFzIHRlbXBsYXRlT3B0aW9ucwoJCQlnZXRUZW1wbGF0ZU9wdGlvbnM6IGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuIHRoaXMudGVtcGxhdGVPcHRpb25zIHx8IHRoaXMubmFtZTsKCgkJCX0sCgoJCQlnZXRNb2RlbE5vZGU6IGZ1bmN0aW9uKCBobU1vZGVsQ29udGFpbmVyICkgewoJCQkJdmFyIHN1YlBhdGggPSB0aGlzLnN1YlBhdGggfHwgdGhpcy5uYW1lLnJlcGxhY2UoIHJEb3QsICJfIiApOwoJCQkJLy9pZiB3ZSBoYXZlIG1vcmUgdGhhbiBvbmUgaW5zdGFuY2UsIHRoZSBzdWJQYXRoIG5lZWQgdG8gYmUKCQkJCS8vYmUgc3VmZml4IHdpdGggYW4gdWlkIHRvIG1ha2UgdGhpcyBuYW1lc3BhY2UgdW5pcXVlCgkJCQlpZiAodGhpcy51aWQpIHsKCQkJCQlzdWJQYXRoID0gc3ViUGF0aCArIHRoaXMudWlkOwoJCQkJfQoJCQkJcmV0dXJuIGhtTW9kZWxDb250YWluZXIuY2QoIHN1YlBhdGggKTsKCgkJCX0sCgoJCQlpbnN0YW5jZUNvdW50OiAwLAoKCQkJdWlkOiAwLAoKCQkJLy9pZiB3ZSB3YW50IHRvIHVzZSBzaW5nbGV0b24gdXNlIHRoZSBmb2xsb3dpbmcKCQkJLy8JCWxvYWRhYmxlOiBmdW5jdGlvbigpIHsKCQkJLy8JCQlyZXR1cm4gIXRoaXMuaW5zdGFuY2VDb3VudDsKCQkJLy8JCX0sCgkJCWxvYWRhYmxlOiByZXR1cm5UcnVlLAoKCQkJdGVtcGxhdGVPcHRpb25zOiBudWxsLAoKCQkJLy9wYXRoIHRoYXQgd3JhcCB0aGlzIG1vZGVsLAoJCQkvL2J1dCB0aGlzIHNob3VsZCBub3QgYmUgdXNlZCBieSBjb25zdW1lcgoJCQlzdWJQYXRoOiBudWxsCgoKCQl9LAoKCQkvL3N0YXRpYyBtZW1iZXJzCgkJewoKCQkJLy9obS5BcHAuYWRkKHsKCQkJLy8gIG5hbWU6ICJnbWFpbCIsIC8veW91IG11c3QgaGF2ZSBhIG5hbWUKCQkJLy8gIGxvYWQ6IGZ1bmN0aW9uICh2aWV3Q29udGFpbmVyLCBtb2RlbENvbnRhaW5lciwgb3B0aW9ucykge30sCgkJCS8vICB1bmFwcDogZnVuY3Rpb24gKHZpZXdDb250YWluZXIsIG1vZGVsQ29udGFpbmVyKSB7fSwgLy9vcHRpb25hbAoJCQkvLyAgLy9vcHRpb25hbCwgYnkgZGVmYXVsdCBpdCBpcyBub3QgbG9hZGFibGUgaWYgaXQgaGFzIGJlZW4gbG9hZGVkIG9uY2UKCQkJLy8gIC8vaWYgaXQgaXMgbG9hZGFibGU6IHRydWUgLCBpdCBtZWFucyBpdCBpcyBhbHdheXMgbG9hZGFibGUKCQkJLy8gIGxvYWRhYmxlOiBmdW5jdGlvbiAoKSB7fSwKCQkJLy8gfSk7CgkJCWFkZDogZnVuY3Rpb24oIGFwcCApIHsKCQkJCWlmICghKGFwcCBpbnN0YW5jZW9mIHRoaXMpKSB7CgkJCQkJYXBwID0gdGhpcyggYXBwICk7CgkJCQl9CgkJCQlhcHBTdG9yZVthcHAubmFtZV0gPSBhcHA7CgkJCX0sCgoJCQlyZW1vdmU6IGZ1bmN0aW9uKCBhcHBOYW1lICkgewoJCQkJaWYgKGFwcFN0b3JlW2FwcE5hbWVdICYmICFhcHBTdG9yZVthcHBOYW1lXS5pbnN0YW5jZUNvdW50KSB7CgkJCQkJZGVsZXRlIGFwcFN0b3JlW2FwcE5hbWVdOwoJCQkJfQoJCQl9LAoKCQkJZ2V0OiBmdW5jdGlvbiggYXBwTmFtZSApIHsKCQkJCXJldHVybiBhcHBTdG9yZVthcHBOYW1lXTsKCQkJfSwKCgkJCS8vZmV0Y2ggdGhlIGRlZmluaXRpb24gb2YgdGhlIGFwcGxpY2F0aW9uCgkJCWxvYWREZWZpbml0aW9uOiBmdW5jdGlvbiggYXBwTmFtZSApIHsKCQkJCXJldHVybiBfbG9hZGVyLmxvYWQoIGFwcE5hbWUgKyAiLmFwcCIgKTsKCQkJfSwKCgkJCS8vc3VwcG9ydCB0aGUgZm9sbG93aW5nIGZlYXR1cmUKCQkJLy9ieSBkZWZhdWx0IGNvbnRhaW5lciBpcyBib2R5LCBpZiBjb250YWluZXIgaXMgbWlzc2luZwoJCQkvL2htLkFwcC5sb2FkQXBwKGFwcE5hbWUpOwoJCQkvLwoJCQkvL2htLkFwcC5sb2FkQXBwKGFwcE5hbWUsIHZpZXdDb250YWluZXIpOyAvL3ZpZXdDb250YWluZXIgaXMgalF1ZXJ5CgkJCS8vaG0uQXBwLmxvYWRBcHAoYXBwTmFtZSwgbW9kZWxDb250YWluZXIpOyAvL21vZGVsQ29udGFpbmVyIGlzIHN0cmluZwoJCQkvLwoJCQkvL2NvbnRhaW5lciBpcyBqUXVlcnkgb2JqZWN0LCBvciBET00gZWxlbWVudAoJCQkvL2FwcE5hbWUgaXMgc3RyaW5nLAoJCQkvL29wdGlvbnMgaXMgb3B0aW9uYWwKCQkJbG9hZEFwcDogZnVuY3Rpb24oIGFwcE5hbWUsICR2aWV3Q29udGFpbmVyLCBobU1vZGVsQ29udGFpbmVyLCBvcHRpb25zICkgewoKCQkJCWlmIChhcmd1bWVudHMubGVuZ3RoID09IDEpIHsKCgkJCQkJJHZpZXdDb250YWluZXIgPSAkKCBkb2N1bWVudC5ib2R5ICk7CgkJCQkJaG1Nb2RlbENvbnRhaW5lciA9IHJvb3ROb2RlOwoKCQkJCX0gZWxzZSBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PSAyKSB7CgoJCQkJCWhtTW9kZWxDb250YWluZXIgPSByb290Tm9kZTsKCgkJCQl9CgoJCQkJdmFyIGFwcCA9IGFwcFN0b3JlW2FwcE5hbWVdOwoKCQkJCWlmIChhcHApIHsKCgkJCQkJYXBwLmxvYWQoICR2aWV3Q29udGFpbmVyLCBobU1vZGVsQ29udGFpbmVyLCBvcHRpb25zICk7CgoJCQkJfSBlbHNlIHsKCgkJCQkJdGhpcy5sb2FkRGVmaW5pdGlvbiggYXBwTmFtZSApLmRvbmUoIGZ1bmN0aW9uKCkgewoJCQkJCQlhcHBTdG9yZVthcHBOYW1lXS5sb2FkKCAkdmlld0NvbnRhaW5lciwgaG1Nb2RlbENvbnRhaW5lciwgb3B0aW9ucyApOwoJCQkJCX0gKTsKCQkJCX0KCQkJfSwKCgkJCS8vY29udGFpbmVyIGJ5IGRlZmF1bHQgaXMgZG9jdW1lbnQuYm9keQoJCQkvL2htLkFwcC51bmxvYWRBcHAoYXBwTmFtZSkKCQkJLy9obS5BcHAudW5sb2FkQXBwKGNvbnRhaW5lciwgYXBwTmFtZSk7CgkJCXVubG9hZEFwcDogZnVuY3Rpb24oIGFwcE5hbWUsICR2aWV3Q29udGFpbmVyICkgewoJCQkJaWYgKGlzVW5kZWZpbmVkKCBhcHBOYW1lICkpIHsKCQkJCQlhcHBOYW1lID0gJHZpZXdDb250YWluZXI7CgkJCQkJJHZpZXdDb250YWluZXIgPSAkKCAiYm9keSIgKTsKCQkJCX0KCgkJCQl2YXIgYXBwSW5zdGFuY2UgPSBpbnN0YW5jZU1hbmFnZXIuZ2V0KCAkdmlld0NvbnRhaW5lciwgYXBwTmFtZSApOwoJCQkJaWYgKGFwcEluc3RhbmNlKSB7CgkJCQkJYXBwSW5zdGFuY2UuYXBwLnVubG9hZCggJHZpZXdDb250YWluZXIgKTsKCQkJCX0KCQkJfQoKCQl9ICk7CgoJdmFyIGluc3RhbmNlTWFuYWdlciA9IHsKCgkJZ2V0OiBmdW5jdGlvbiggdmlld0NvbnRhaW5lckVsZW0sIGFwcE5hbWUgKSB7CgkJCXJldHVybiB0aGlzLmFwcERhdGEoIHZpZXdDb250YWluZXJFbGVtIClbYXBwTmFtZV07CgkJfSwKCgkJYWRkOiBmdW5jdGlvbiggdmlld0NvbnRhaW5lckVsZW0sIG1vZGVsQ29udGFpbmVyUGF0aCwgYXBwTmFtZSwgYXBwICkgewoJCQl0aGlzLmFwcERhdGEoIHZpZXdDb250YWluZXJFbGVtIClbYXBwTmFtZV0gPSB7CgkJCQlhcHA6IGFwcCwKCQkJCW1vZGVsTm9kZTogYXBwLmdldE1vZGVsTm9kZSggaG0oIG1vZGVsQ29udGFpbmVyUGF0aCApICksCgkJCQltb2RlbENvbnRhaW5lcjogbW9kZWxDb250YWluZXJQYXRoCgkJCX07CgkJfSwKCgkJcmVtb3ZlOiBmdW5jdGlvbiggdmlld0NvbnRhaW5lckVsZW0sIGFwcE5hbWUgKSB7CgkJCWRlbGV0ZSB0aGlzLmFwcERhdGEoIHZpZXdDb250YWluZXJFbGVtIClbYXBwTmFtZV07CgkJfSwKCgkJYXBwRGF0YTogZnVuY3Rpb24oIHZpZXdDb250YWluZXJFbGVtLCByZWFkT25seSApIHsKCQkJdmFyIGFwcERhdGEgPSAkKCB2aWV3Q29udGFpbmVyRWxlbSApLmhtRGF0YSggImFwcCIgKTsKCQkJaWYgKCFyZWFkT25seSAmJiAhYXBwRGF0YSkgewoJCQkJYXBwRGF0YSA9IHsgfTsKCQkJCSQoIHZpZXdDb250YWluZXJFbGVtICkuaG1EYXRhKCAiYXBwIiwgYXBwRGF0YSApOwoJCQl9CgkJCXJldHVybiBhcHBEYXRhOwoJCX0KCX07CgoJYmluZGluZ3MoIHsKCQkvL2FwcD0iL3xnbWFpbCxvcHRpb25zIgoJCS8vZGF0YS1zdWI9ImFwcDovfGdtYWlsLG9wdGlvbnMiCgkJYXBwOiBmdW5jdGlvbiggZWxlbSwgcGF0aCwgY29udGV4dCwgb3B0aW9ucyApIHsKCgkJCXZhciBtYXRjaCA9IHJBcHBPcHRpb25zLmV4ZWMoICQudHJpbSggb3B0aW9ucyApICksCgkJCQlhcHBOYW1lID0gbWF0Y2hbMV0sCgkJCQlhcHBPcHRpb25zID0gbWF0Y2hbM107CgoJCQlobS5BcHAubG9hZEFwcCggYXBwTmFtZSwgJCggZWxlbSApLCBobSggcGF0aCApLCBhcHBPcHRpb25zICk7CgkJfSwKCgkJLy9leGl0LWFwcD0iX3xnbWFpbCIKCQkvL3VubG9hZCBhcHAgZnJvbSBwYXJlbnQgY29udGFpbmVyCgkJLy9kYXRhLXN1Yj0iZXhpdEFwcDpffGdtYWlsIgoJCWV4aXRBcHA6IGZ1bmN0aW9uKCBlbGVtLCBwYXJzZUNvbnRleHQsIGJpbmRpbmcsIG9wdGlvbnMgKSB7CgkJCSQoIGVsZW0gKS5tYXBFdmVudCggImNsaWNrIiwgImV4aXRBcHAuIiArIG9wdGlvbnMgKTsKCQl9LAoKCQkvL2xvYWQgYW4gYXBwIHdoZW4gY2xpY2sKCQkvL2xvYWQtYXBwPSIvfGdtYWlsLCNjb250YWluZXJJZCxvcHRpb25zIgoJCS8vZGF0YS1zdWI9ImxvYWRBcHA6L3xnbWFpbCwjY29udGFpbmVySWQsb3B0aW9ucyIKCQlsb2FkQXBwOiBmdW5jdGlvbiggZWxlbSwgcGF0aCwgY29udGV4dCwgb3B0aW9ucyApIHsKCgkJCXZhciBvcHRpb25QYXJ0cyA9IHJMb2FkQXBwT3B0aW9ucy5leGVjKCAkLnRyaW0oIG9wdGlvbnMgKSApLAoJCQkJYXBwTmFtZSA9IG9wdGlvblBhcnRzWzFdLAoJCQkJJHZpZXdDb250YWluZXIgPSAkKCBvcHRpb25QYXJ0c1szXSApLAoJCQkJb3RoZXJPcHRpb25zID0gb3B0aW9uUGFydHNbNV07CgoJCQkkKCBlbGVtICkuY2xpY2soIGZ1bmN0aW9uKCkgewoJCQkJaG0uQXBwLmxvYWRBcHAoIGFwcE5hbWUsICR2aWV3Q29udGFpbmVyLCBobSggcGF0aCApLCBvdGhlck9wdGlvbnMgKTsKCQkJfSApOwoJCX0sCgoJCS8vdW5sb2FkQXBwCgkJLy91bmxvYWQgYW4gYXBwIHdoZW4gY2xpY2sKCQkvL3VubG9hZC1hcHA9IjpffGdtYWlsLCNjb250YWluZXIiCgkJLy9kYXRhLXN1Yj0idW5sb2FkQXBwOl98Z21haWwsI2NvbnRhaW5lciIKCQl1bmxvYWRBcHA6IGZ1bmN0aW9uKCBlbGVtLCBwYXRoLCBjb250ZXh0LCBvcHRpb25zICkgewoKCQkJdmFyIG9wdGlvblBhcnRzID0gckxvYWRBcHBPcHRpb25zLmV4ZWMoICQudHJpbSggb3B0aW9ucyApICksCgkJCQlhcHBOYW1lID0gb3B0aW9uUGFydHNbMV0sCgkJCQkkdmlld0NvbnRhaW5lciA9ICQoIG9wdGlvblBhcnRzWzNdICk7CgoJCQkkKCBlbGVtICkuY2xpY2soIGZ1bmN0aW9uKCkgewoJCQkJaG0uQXBwLnVubG9hZEFwcCggYXBwTmFtZSwgJHZpZXdDb250YWluZXIgKTsKCQkJfSApOwoJCX0KCX0gKTsKCgl2YXIgX2NsZWFuRGF0YUZvckFwcCA9ICQuY2xlYW5EYXRhOwoKCSQuY2xlYW5EYXRhID0gZnVuY3Rpb24oIGVsZW1zICkgewoJCSQoIGVsZW1zICkuZWFjaCggZnVuY3Rpb24oKSB7CgkJCXZhciBhcHBEYXRhID0gaW5zdGFuY2VNYW5hZ2VyLmFwcERhdGEoIHRoaXMsIHRydWUgKTsKCQkJaWYgKGFwcERhdGEpIHsKCQkJCWZvciAodmFyIGtleSBpbiBhcHBEYXRhKSB7CgkJCQkJdmFyIGFwcCA9IGFwcERhdGFba2V5XTsKCQkJCQlkZWxldGUgYXBwRGF0YVtrZXldOwoJCQkJCWFwcC51bmxvYWQoIHRoaXMsIHRydWUgKTsKCQkJCX0KCQkJfQoJCX0gKTsKCQlfY2xlYW5EYXRhRm9yQXBwKCBlbGVtcyApOwoJfTsKCglfbG9hZGVyKCAiYXBwIiwgImpzIiwgewoJCXVybDogZnVuY3Rpb24oIG1vZHVsZUlkICkgewoJCQkvL2lmIG1vZHVsZSBpZCBpcyBsaWtlICpoZWxsbywgdGhlbiBpdCBpcyB3aWRnZXQKCQkJdmFyIGZpbGVOYW1lID0gX2xvYWRlci5maWxlTmFtZSggbW9kdWxlSWQgKTsKCQkJcmV0dXJuIGZpbGVOYW1lLnN0YXJ0c1dpdGgoICJhcGsuIiApID8KCQkJCS8vaWYgYXBwIGlzIHBhY2thZ2UgaXMgYXBrLCB0aGVuIGxvYWQgaXQKCQkJCS8vaW4gYXBrIGZvbGRlcgoJCQkJImFway8iICsgZmlsZU5hbWUuc3Vic3RyKCA0ICkgKyAiL21haW4uanMiIDoKCgkJCQkvL290aGVyd2lzZSBsb2FkIGluIGFwcCBmb2xkZXIKCQkJCSJhcHAvIiArIGZpbGVOYW1lICsgIi5qcyI7CgkJfQoJfSApOwoKCgp9KSggalF1ZXJ5LCB3aW5kb3cgKTsKCg==",
                "body": "IC8qIQogICogSG0uanMgSmF2YVNjcmlwdCBMaWJyYXJ5IHYxLjAuMAogICogwqkgRnJlZCBZYW5nIC0gaHR0cDovL3NlbWFudGljc3dvcmtzLmNvbQogICogTGljZW5zZTogTUlUIChodHRwOi8vd3d3Lm9wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL21pdC1saWNlbnNlLnBocCkKICAqIERhdGU6IFR1ZSBBcHIgMSAxOToxNTo1MCAyMDE0IC0wNzAwCiAgKi8KKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCSJ1c2Ugc3RyaWN0IjsKCgkvKmpzaGludCBzbWFydHRhYnM6dHJ1ZSwgZXZpbDp0cnVlLCBleHByOnRydWUsIG5ld2NhcDogZmFsc2UsIHZhbGlkdGhpczogdHJ1ZSAqLwoJLyoqCgkgKiBhIHdyYXBwZXIgb3ZlciBhIE5vZGUgY29uc3RydWN0b3IsCgkgKiBbdmFsdWVdIGlzIG9wdGlvbmFsCgkgKi8KCXZhciBobSA9IHdpbmRvdy5obSA9IGZ1bmN0aW9uKCBwYXRoLCB2YWx1ZSApIHsKCQkJcmV0dXJuIG5ldyBOb2RlKCBwYXRoLCB2YWx1ZSApOwoJCX0sCgkJTm9kZSA9IGZ1bmN0aW9uKCBwYXRoLCB2YWx1ZSApIHsKCQkJcGF0aCA9IHBhdGggfHwgIiI7CgkJCXRoaXMucGF0aCA9IHRvUGh5c2ljYWxQYXRoKCBwYXRoLCB0cnVlIC8qIGNyZWF0ZSBzaGFkb3cgaWYgbmVjZXNzYXJ5ICovICk7CgkJCWlmICghaXNVbmRlZmluZWQoIHZhbHVlICkpIHsKCQkJCXRoaXMuc2V0KCB2YWx1ZSApOwoJCQl9CgkJfSwKCQlkb2N1bWVudCA9IHdpbmRvdy5kb2N1bWVudCwKCQlsb2NhbFN0b3JhZ2UgPSB3aW5kb3cubG9jYWxTdG9yYWdlLAoJCXNldFRpbWVvdXQgPSB3aW5kb3cuc2V0VGltZW91dCwKCQloaXN0b3J5ID0gd2luZG93Lmhpc3RvcnksCgkJbG9jYXRpb24gPSB3aW5kb3cubG9jYXRpb24sCgkJYWxlcnQgPSB3aW5kb3cuYWxlcnQsCgkJY29uZmlybSA9IHdpbmRvdy5jb25maXJtLAoJCWhtRm4sCgkJZXh0ZW5kID0gJC5leHRlbmQsCgkJcmVwb3NpdG9yeSA9IHt9LAoJCWlzQXJyYXkgPSAkLmlzQXJyYXksCgkJaXNGdW5jdGlvbiA9ICQuaXNGdW5jdGlvbiwKCQlwcmltaXRpdmVUeXBlcyA9IHsgJ3VuZGVmaW5lZCc6IHVuZGVmaW5lZCwgJ2Jvb2xlYW4nOiB1bmRlZmluZWQsICdudW1iZXInOiB1bmRlZmluZWQsICdzdHJpbmcnOiB1bmRlZmluZWQgfSwKCQlzaGFkb3dOYW1lc3BhY2UgPSAiX19obSIsCgkJclNoYWRvd0tleSA9IC9eX19obVwuKFteXC5dKz8pKD86XC58JCkvLAoJLy90cnkgdG8gbWF0Y2ggeHh4IGluIHN0cmluZyB0aGlzLmdldCgieHh4IikKCQlyV2F0Y2hlZFBhdGggPSAvdGhpc1wuKD86Z2V0KVxzKlwoXHMqKFsnIl0pKFtcKlwuXHdcL10rKVwxXHMqXCkvZywKCgkvL2tleSBpcyB3YXRjaGVkUGF0aHMKCS8vdmFsdWUgaXMgYXJyYXkgb2Ygd2F0Y2hpbmdQYXRocwoJCXdhdGNoVGFibGUgPSB7fSwKCQlkZWZhdWx0T3B0aW9ucyA9IHt9LAoJCXJvb3ROb2RlLAoJCXNoYWRvd1Jvb3QgPSByZXBvc2l0b3J5W3NoYWRvd05hbWVzcGFjZV0gPSB7fSwKCQloYXNPd24gPSByZXBvc2l0b3J5Lmhhc093blByb3BlcnR5LAoJCUFycmF5ID0gd2luZG93LkFycmF5LAoJCWFycmF5UHJvdG90eXBlID0gQXJyYXkucHJvdG90eXBlLAoJCXN0cmluZ1Byb3RvdHlwZSA9IFN0cmluZy5wcm90b3R5cGUsCgkJc2xpY2UgPSBhcnJheVByb3RvdHlwZS5zbGljZSwKCQl0cmlnZ2VyLAoJCWJlZm9yZVVwZGF0ZSA9ICJiZWZvcmVVcGRhdGUiLAoJCWFmdGVyVXBkYXRlID0gImFmdGVyVXBkYXRlIiwKCQliZWZvcmVDcmVhdGUgPSAiYmVmb3JlQ3JlYXRlIiwKCQlhZnRlckNyZWF0ZSA9ICJhZnRlckNyZWF0ZSIsCgkJckpTT04gPSAvXig/Olx7LipcfXxcWy4qXF0pJC8sCgkJclVzZVBhcnNlQ29udGV4dEFzQ29udGV4dCA9IC9eXC4oXC4qKShbXC5cKl0pLywKCQlyTWFpblBhdGggPSAvXlwuPCguKikvLAoJCXJCZWdpbkRvdE9yU3RhciA9IC9eW1wuXCpdLywKCQlyRG90U3RhciA9IC9bXC5cKl0vLAoJCXJIYXNoT3JEb3QgPSAvIyt8XC4vZywKCQlySGFzaCA9IC8jKy9nLAoJCVJlZ0V4cCA9IHdpbmRvdy5SZWdFeHAsCgkJclBhcmVudEtleSA9IC9eKC4rKVtcLlwqXVx3KyQvLAoJCW1lcmdlUGF0aCwKCQlySW5kZXggPSAvXi4rXC4oXHcrKSR8XHcrLywKCQl1dGlsLAoJCWlzVW5kZWZpbmVkLAoJCWlzUHJpbWl0aXZlLAoJCWlzU3RyaW5nLAoJCWlzT2JqZWN0LAoJCWlzQm9vbGVhbiwKCQlpc051bWVyaWMgPSAkLmlzTnVtZXJpYywKCQlpc1Byb21pc2UsCgkJdG9UeXBlZFZhbHVlLAoJCXRvUGh5c2ljYWxQYXRoLAoJCXRvTG9naWNhbFBhdGgsCgkJY2xlYXJPYmosCgkJJGZuID0gJC5mbiwKCQljbG9uZSwKCQlyU3VwcGxhbnQgPSAvXHsoW15ce1x9XSopXH0vZzsKCgkvLyNkZWJ1ZwoJLy9pZiB5b3UgYXJlIHVzaW5nIGRlYnVnIHZlcnNpb24gb2YgdGhlIGxpYnJhcnkKCS8veW91IGNhbiB1c2UgZGVidWdnaW5nIGZhY2lsaXRpZXMgcHJvdmlkZWQgaGVyZQoJLy90aGV5IGFyZSBhbHNvIHVzZWQgaW4gdW5pdCB0ZXN0IHRvIHRlc3Qgc29tZSBpbnRlcm5hbCB2YXJpYWJsZSB3aGljaCBpcwoJLy9ub3QgZXhwb3NlZCBpbiBwcm9kdWN0aW9uIHZlcnNpb24KCS8vSW4gZGVidWcgdmVyc2lvbiwgeW91IGNhbiB0dXJuIG9uIGxvZ2dpbmcgYnkgc2V0dGluZyBobS5kZWJ1Zy5lbmFibGVMb2cgPSB0cnVlCgkvL2FuZCB0dXJuIG9uIGRlYnVnZ2VyIGJ5IHNldHRpbmcgaG0uZGVidWcuZW5hYmxlRGVidWdnZXIgPSB0cnVlCgkvLwoJLy9JbiBwcm9kdWN0aW9uIHZlcnNpb24sIHRoZXJlIGlzIG5vIGxvZ2dpbmcgb3IgZGVidWdnZXIgZmFjaWxpdGllcwoJaG0uZGVidWcgPSB7fTsKCWhtLmRlYnVnLmVuYWJsZUxvZyA9IHRydWU7CglobS5kZWJ1Zy5lbmFibGVEZWJ1Z2dlciA9IGZhbHNlOwoKCXdpbmRvdy5sb2cgPSB3aW5kb3cubG9nIHx8IGZ1bmN0aW9uKCkgewoJCWlmIChobS5kZWJ1Zy5lbmFibGVMb2cgJiYgd2luZG93LmNvbnNvbGUpIHsKCQkJY29uc29sZS5sb2coIEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKCBhcmd1bWVudHMgKSApOwoJCX0KCX07CgkvLyNlbmRfZGVidWcKCgoJZnVuY3Rpb24gYXVnbWVudCggcHJvdG90eXBlLCBleHRlbnNpb24gKSB7CgkJZm9yICh2YXIga2V5IGluIGV4dGVuc2lvbikgewoJCQlpZiAoIXByb3RvdHlwZVtrZXldKSB7CgkJCQlwcm90b3R5cGVba2V5XSA9IGV4dGVuc2lvbltrZXldOwoJCQl9CgkJfQoJfQoKCWF1Z21lbnQoIGFycmF5UHJvdG90eXBlLCB7CgkJaW5kZXhPZjogZnVuY3Rpb24oIG9iaiwgc3RhcnQgKSB7CgkJCWZvciAodmFyIGkgPSAoc3RhcnQgfHwgMCk7IGkgPCB0aGlzLmxlbmd0aDsgaSsrKSB7CgkJCQlpZiAodGhpc1tpXSA9PSBvYmopIHsKCQkJCQlyZXR1cm4gaTsKCQkJCX0KCQkJfQoJCQlyZXR1cm4gLTE7CgkJfSwKCgkJY29udGFpbnM6IGZ1bmN0aW9uKCBpdGVtICkgewoJCQlyZXR1cm4gKHRoaXMuaW5kZXhPZiggaXRlbSApICE9PSAtMSk7CgkJfSwKCgkJcmVtb3ZlOiBmdW5jdGlvbiggaXRlbSApIHsKCQkJdmFyIHBvc2l0aW9uID0gdGhpcy5pbmRleE9mKCBpdGVtICk7CgkJCWlmIChwb3NpdGlvbiAhPSAtMSkgewoJCQkJdGhpcy5zcGxpY2UoIHBvc2l0aW9uLCAxICk7CgkJCX0KCQkJcmV0dXJuIHRoaXM7CgkJfSwKCgkJcmVtb3ZlQXQ6IGZ1bmN0aW9uKCBpbmRleCApIHsKCQkJdGhpcy5zcGxpY2UoIGluZGV4LCAxICk7CgkJCXJldHVybiB0aGlzOwoJCX0sCgoJCXB1c2hVbmlxdWU6IGZ1bmN0aW9uKCBpdGVtICkgewoJCQlpZiAoIXRoaXMuY29udGFpbnMoIGl0ZW0gKSkgewoJCQkJdGhpcy5wdXNoKCBpdGVtICk7CgkJCX0KCQkJcmV0dXJuIHRoaXM7CgkJfSwKCgkJbWVyZ2U6IGZ1bmN0aW9uKCBpdGVtcyApIHsKCQkJaWYgKGl0ZW1zICYmIGl0ZW1zLmxlbmd0aCkgewoJCQkJZm9yICh2YXIgaSA9IDA7IGkgPCBpdGVtcy5sZW5ndGg7IGkrKykgewoJCQkJCXRoaXMucHVzaFVuaXF1ZSggaXRlbXNbaV0gKTsKCQkJCX0KCQkJfQoJCQlyZXR1cm4gdGhpczsKCQl9LAoJCS8vaXQgY2FuIGJlIHNvcnRPYmplY3QoKQoJCS8vc29ydE9iamVjdChieSkKCQlzb3J0T2JqZWN0OiBmdW5jdGlvbiggYnksIGFzYyApIHsKCQkJaWYgKGlzVW5kZWZpbmVkKCBhc2MgKSkgewoJCQkJaWYgKGlzVW5kZWZpbmVkKCBieSApKSB7CgkJCQkJYXNjID0gdHJ1ZTsKCQkJCQlieSA9IHVuZGVmaW5lZDsKCQkJCX0gZWxzZSB7CgkJCQkJaWYgKGlzU3RyaW5nKCBieSApKSB7CgkJCQkJCWFzYyA9IHRydWU7CgkJCQkJfSBlbHNlIHsKCQkJCQkJYXNjID0gYnk7CgkJCQkJCWJ5ID0gdW5kZWZpbmVkOwoJCQkJCX0KCQkJCX0KCQkJfQoKCQkJaWYgKGJ5KSB7CgkJCQl0aGlzLnNvcnQoIGZ1bmN0aW9uKCBhLCBiICkgewoJCQkJCXZhciBhdiA9IGFbYnldOwoJCQkJCXZhciBidiA9IGJbYnldOwoJCQkJCWlmIChhdiA9PSBidikgewoJCQkJCQlyZXR1cm4gMDsKCQkJCQl9CgkJCQkJcmV0dXJuICBhc2MgPyAoYXYgPiBidikgPyAxIDogLTEgOgoJCQkJCQkoYXYgPiBidikgPyAtMSA6IDE7CgkJCQl9ICk7CgkJCX0gZWxzZSB7CgkJCQlhc2MgPyB0aGlzLnNvcnQoKSA6IHRoaXMuc29ydCgpLnJldmVyc2UoKTsKCQkJfQoJCQlyZXR1cm4gdGhpczsKCQl9Cgl9ICk7CgoJYXVnbWVudCggc3RyaW5nUHJvdG90eXBlLCB7CgkJc3RhcnRzV2l0aDogZnVuY3Rpb24oIHRleHQgKSB7CgkJCXJldHVybiB0aGlzLmluZGV4T2YoIHRleHQgKSA9PT0gMDsKCQl9LAoJCWNvbnRhaW5zOiBmdW5jdGlvbiggdGV4dCApIHsKCQkJcmV0dXJuIHRoaXMuaW5kZXhPZiggdGV4dCApICE9PSAtMTsKCQl9LAoJCWVuZHNXaXRoOiBmdW5jdGlvbiggc3VmZml4ICkgewoJCQlyZXR1cm4gdGhpcy5pbmRleE9mKCBzdWZmaXgsIHRoaXMubGVuZ3RoIC0gc3VmZml4Lmxlbmd0aCApICE9PSAtMTsKCQl9LAoJCXN1cHBsYW50OiBmdW5jdGlvbiggb2JqICkgewoJCQlyZXR1cm4gdGhpcy5yZXBsYWNlKCByU3VwcGxhbnQsCgkJCQlmdW5jdGlvbiggYSwgYiApIHsKCQkJCQl2YXIgciA9IG9ialtiXTsKCQkJCQlyZXR1cm4gdHlwZW9mIHIgPyByIDogYTsKCQkJCX0gKTsKCQl9LAoJCWZvcm1hdDogZnVuY3Rpb24oKSB7CgkJCXZhciBzb3VyY2UgPSB0aGlzOwoJCQkkLmVhY2goIGFyZ3VtZW50cywgZnVuY3Rpb24oIGluZGV4LCB2YWx1ZSApIHsKCQkJCXNvdXJjZSA9IHNvdXJjZS5yZXBsYWNlKCBuZXcgUmVnRXhwKCAiXFx7IiArIGluZGV4ICsgIlxcfSIsICJnIiApLCB2YWx1ZSApOwoJCQl9ICk7CgkJCXJldHVybiBzb3VyY2U7CgkJfQoJfSApOwoKCWhtRm4gPSBOb2RlLnByb3RvdHlwZSA9IGhtLmZuID0gaG0ucHJvdG90eXBlID0gewoKCQljb25zdHJ1Y3RvcjogTm9kZSwKCgkJdG9TdHJpbmc6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gdGhpcy5wYXRoOwoJCX0sCgoJCS8vZ2V0KCkKCQkvL2dldCh0cnVlKQoJCS8vCgkJLy9zdWJQYXRoIGNhbiBiZSBudWxsLCB1bmRlZmluZWQsICIiLCBvciAiYW55IHN0cmluZyIKCQkvL2dldChzdWJQYXRoKQoJCS8vZ2V0KHN1YlBhdGgsIHAxLCBwMikKCQkvLwoJCS8vZG9lcyBub3Qgc3VwcG9ydCB0aGUgZm9sbG93aW5nLCBhcyB3aWxsIGJlIGltcGxlbWVudGVkIGFzIGdldCgoc3ViUGF0aCA9IHAxKSwgcDIpCgkJLy9nZXQocDEsIHAyKQoJCWdldDogZnVuY3Rpb24oIHN1YlBhdGggLyosIHAxLCBwMiwgLi4gZm9yIHBhcmFtZXRlcnMgb2YgbW9kZWwgZnVuY3Rpb25zKi8gKSB7CgoJCQl2YXIgY3VycmVudFZhbHVlLCBhY2Nlc3NvciA9IHRoaXMuYWNjZXNzb3IoIHN1YlBhdGgsIHRydWUgKTsKCgkJCWlmIChhY2Nlc3NvcikgewoKCQkJCWlmIChpc0Z1bmN0aW9uKCBhY2Nlc3Nvci5ob3N0T2JqICkpIHsKCgkJCQkJcmV0dXJuIGFjY2Vzc29yLmhvc3RPYmouYXBwbHkoIHRoaXMuY2QoICIuLiIgKSwgc2xpY2UuY2FsbCggYXJndW1lbnRzICkgKTsKCgkJCQl9CgkJCQllbHNlIHsKCgkJCQkJY3VycmVudFZhbHVlID0gIWFjY2Vzc29yLmluZGV4ID8KCQkJCQkJYWNjZXNzb3IuaG9zdE9iaiA6CgkJCQkJCWFjY2Vzc29yLmhvc3RPYmpbYWNjZXNzb3IuaW5kZXhdOwoKCQkJCQlpZiAoaXNGdW5jdGlvbiggY3VycmVudFZhbHVlICkpIHsKCgkJCQkJCS8vaW5zaWRlIHRoZSBmdW5jdGlvbiwgInRoaXMiIHJlZmVyIHRoZSBwYXJlbnQgbW9kZWwgb2YgYWNjZXNzb3IucGh5c2ljYWxQYXRoCgkJCQkJCXJldHVybiBjdXJyZW50VmFsdWUuYXBwbHkoIHRoaXMuY2QoIHN1YlBhdGggKS5jZCggIi4uIiApLCBzbGljZS5jYWxsKCBhcmd1bWVudHMsIDEgKSApOwoKCQkJCQl9IGVsc2UgewoKCQkJCQkJcmV0dXJuIGN1cnJlbnRWYWx1ZTsKCQkJCQl9CgkJCQl9CgkJCX0KCQkJLy9lbHNlIHJldHVybiB1bmRlZmluZWQKCQl9LAoKCQlnZXRKc29uOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIEpTT04uc3RyaW5naWZ5KCB0aGlzLmdldC5hcHBseSggdGhpcywgc2xpY2UuY2FsbCggYXJndW1lbnRzICkgKSApOwoJCX0sCgoJCXJhdzogZnVuY3Rpb24oIHN1YlBhdGgsIHZhbHVlICkgewoJCQl2YXIgYWNjZXNzb3I7CgkJCWlmIChpc0Z1bmN0aW9uKCBzdWJQYXRoICkpIHsKCQkJCXZhbHVlID0gc3ViUGF0aDsKCQkJCXN1YlBhdGggPSAiIjsKCQkJfQoJCQlpZiAoIXZhbHVlKSB7CgkJCQlhY2Nlc3NvciA9IHRoaXMuYWNjZXNzb3IoIHN1YlBhdGgsIHRydWUgKTsKCQkJCWlmIChhY2Nlc3NvcikgewoJCQkJCXJldHVybiAhYWNjZXNzb3IuaW5kZXggPwoJCQkJCQlhY2Nlc3Nvci5ob3N0T2JqIDoKCQkJCQkJYWNjZXNzb3IuaG9zdE9ialthY2Nlc3Nvci5pbmRleF07CgkJCQl9CgkJCX0gZWxzZSB7CgkJCQlhY2Nlc3NvciA9IHRoaXMuYWNjZXNzb3IoIHN1YlBhdGggKTsKCQkJCXJldHVybiAoIGFjY2Vzc29yLmluZGV4IGluIGFjY2Vzc29yLmhvc3RPYmogKSA/CgkJCQkJdGhpcy51cGRhdGUoIHN1YlBhdGgsIHZhbHVlLCBhY2Nlc3NvciApIDoKCQkJCQl0aGlzLmNyZWF0ZSggc3ViUGF0aCwgdmFsdWUsIGFjY2Vzc29yICk7CgkJCX0KCgkJfSwKCgkJLy9yZXR1cm4gbm9kZQoJCS8veW91IGNhbiB1c2Ugbm9kZS5zZXQgdG8gY2FsbCB0aGUgZnVuY3Rpb24gYXQgdGhlIHBhdGgKCQkvL3RoZSBmdW5jdGlvbiBjb250ZXh0IGlzIGJvdW5kIHRvIGN1cnJlbnQgcHJveHkncyBwYXJlbnQKCQkvL3doYXQgaXMgZGlmZmVyZW50IGZvciBnZXQgZnVuY3Rpb24gaXMgdGhhdCwgc2V0IHdpbGwgcmV0dXJuIGEgcHJveHkKCQkvL2FuZCBnZXQgd2lsbCByZXR1cm4gdGhlIHJlc3VsdCBvZiB0aGUgZnVuY3Rpb24KCQlzZXQ6IGZ1bmN0aW9uKCBmb3JjZSwgc3ViUGF0aCwgdmFsdWUgKSB7CgkJCS8vYWxsb3cgc2V0KHBhdGgsIHVuZGVmaW5lZCkKCQkJaWYgKGFyZ3VtZW50cy5sZW5ndGggPT0gMSkgewoJCQkJaWYgKHRoaXMucGF0aCA9PT0gIiIpIHsKCQkJCQl0aHJvdyAicm9vdCBvYmplY3QgY2FuIG5vdCBjaGFuZ2VkIjsKCQkJCX0gZWxzZSB7CgkJCQkJcm9vdE5vZGUuc2V0KCB0aGlzLnBhdGgsIGZvcmNlLCBzdWJQYXRoICk7CgkJCQkJcmV0dXJuIHRoaXM7CgkJCQl9CgkJCX0KCgkJCXZhciBhcmdzID0gc2xpY2UuY2FsbCggYXJndW1lbnRzICk7CgoJCQlpZiAoIWlzQm9vbGVhbiggZm9yY2UgKSkgewoJCQkJdmFsdWUgPSBzdWJQYXRoOwoJCQkJc3ViUGF0aCA9IGZvcmNlOwoJCQkJZm9yY2UgPSBmYWxzZTsKCQkJfSBlbHNlIGlmIChhcmd1bWVudHMubGVuZ3RoID09IDIpIHsKCQkJCXJvb3ROb2RlLnNldCggZm9yY2UsIHRoaXMucGF0aCwgc3ViUGF0aCApOwoJCQkJcmV0dXJuIHRoaXM7CgkJCX0KCgkJCXZhciBhY2Nlc3NvciA9IHRoaXMuYWNjZXNzb3IoIHN1YlBhdGggKTsKCQkJdmFyIGN1cnJlbnRWYWx1ZSA9IGFjY2Vzc29yLmhvc3RPYmpbYWNjZXNzb3IuaW5kZXhdOwoKCQkJaWYgKGlzRnVuY3Rpb24oIGN1cnJlbnRWYWx1ZSApKSB7CgoJCQkJLy9pbnNpZGUgdGhlIGZ1bmN0aW9uLCAidGhpcyIgcmVmZXIgdGhlIHBhcmVudCBtb2RlbCBvZiBhY2Nlc3Nvci5waHlzaWNhbFBhdGgKCQkJCWN1cnJlbnRWYWx1ZS5hcHBseSggdGhpcy5jZCggc3ViUGF0aCApLmNkKCAiLi4iICksIHNsaWNlLmNhbGwoIGFyZ3MsIDEgKSApOwoJCQkJcmV0dXJuIHRoaXM7CgoJCQl9IGVsc2UgewoKCQkJCXJldHVybiAoIGFjY2Vzc29yLmluZGV4IGluIGFjY2Vzc29yLmhvc3RPYmogKSA/CgkJCQkJdGhpcy51cGRhdGUoIGZvcmNlLCBzdWJQYXRoLCB2YWx1ZSwgYWNjZXNzb3IgKSA6CgkJCQkJdGhpcy5jcmVhdGUoIGZvcmNlLCBzdWJQYXRoLCB2YWx1ZSwgYWNjZXNzb3IgKTsKCgkJCX0KCQl9LAoKCQlhY2Nlc3NvcjogZnVuY3Rpb24oIHN1YlBhdGgsIHJlYWRPbmx5IC8qaW50ZXJuYWwgdXNlIG9ubHkqLyApIHsKCQkJLy9pZiBpdCBpcyBub3QgcmVhZE9ubHksIGFuZCBhY2Nlc3Mgb3V0IG9mIGJvdW5kYXJ5LCBpdCB3aWxsIHRocm93IGV4Y2VwdGlvbgoJCQlpZiAoc3ViUGF0aCA9PT0gMCkgewoJCQkJc3ViUGF0aCA9ICIwIjsKCQkJfQoKCQkJdmFyIGksCgkJCQlpbmRleCwKCQkJLy90aGUgaG9zdE9iaiBzdGFydCBmcm9tIHJvb3QKCQkJCWhvc3RPYmogPSByZXBvc2l0b3J5LAoJCQkvL3RoZSBmdWxsUGF0aCBjYW4gYmUgbG9naWNhbFBhdGggLCBmb3IgZXhhbXBsZSBobSgicGVyc29uIikuZ2V0UGF0aCgiKiIpOwoJCQkvL2l0IGNhbiBhbHNvIGJlIGEgcGh5c2ljYWxQYXRoIGxpa2UgaG0oInBlcnNvbioiKS5nZXRQYXRoKCk7CgkJCQlmdWxsUGF0aCA9IHRoaXMuZ2V0UGF0aCggc3ViUGF0aCApLAoJCQkvL21ha2Ugc3VyZSB3ZSBhcmUgd29ya2luZyBvbiBhIHBoeXNpY2FsUGF0aAoJCQkJcGh5c2ljYWxQYXRoID0gdG9QaHlzaWNhbFBhdGgoIGZ1bGxQYXRoLCB0cnVlIC8qY3JlYXRlIHNoYWRvdyBpZiBuZWNlc3NhcnkqLyApLAoJCQkJcGFydHMgPSBwaHlzaWNhbFBhdGguc3BsaXQoICIuIiApOwoKCQkJaWYgKHBhcnRzLmxlbmd0aCA9PT0gMSkgewoKCQkJCWluZGV4ID0gcGh5c2ljYWxQYXRoOwoKCQkJfSBlbHNlIHsKCgkJCQkvL2luZGV4IGlzIHRoZSBsYXN0IHBhcnQKCQkJCWluZGV4ID0gcGFydHNbcGFydHMubGVuZ3RoIC0gMV07CgoJCQkJLy90cmF2ZXJzZSB0byB0aGUgc2Vjb25kIGxhc3Qgbm9kZSBpbiB0aGUgcGFydHMgaGllcmFyY2h5CgkJCQlmb3IgKGkgPSAwOyBpIDwgcGFydHMubGVuZ3RoIC0gMTsgaSsrKSB7CgkJCQkJaG9zdE9iaiA9IGhvc3RPYmpbcGFydHNbaV1dOwoJCQkJCWlmIChob3N0T2JqID09PSB1bmRlZmluZWQpIHsKCQkJCQkJYnJlYWs7CgkJCQkJfQoJCQkJfQoJCQl9CgoJCQlpZiAoaXNQcmltaXRpdmUoIGhvc3RPYmogKSkgewoJCQkJaWYgKHJlYWRPbmx5KSB7CgkJCQkJcmV0dXJuOwoJCQkJfQoJCQkJZWxzZSB7CgkJCQkJdGhyb3cgImludmFsaWQgdXBkYXRlIG9uIHVucmVhY2hhYmxlIG5vZGUgJyIgKyB0b0xvZ2ljYWxQYXRoKCBmdWxsUGF0aCApICsgIiciOwoJCQkJfQoJCQl9CgoJCQlyZXR1cm4gewoJCQkJcGh5c2ljYWxQYXRoOiBwaHlzaWNhbFBhdGgsCgkJCQlob3N0T2JqOiBob3N0T2JqLAoJCQkJaW5kZXg6IGluZGV4CgkJCX07CgkJfSwKCgkJY3JlYXRlOiBmdW5jdGlvbiggZm9yY2UsIHN1YlBhdGgsIHZhbHVlLCBhY2Nlc3NvciAvKiBhY2Nlc3NvciBpcyB1c2VkIGludGVybmFsbHkgKi8gKSB7CgoJCQlpZiAoIWlzQm9vbGVhbiggZm9yY2UgKSkgewoJCQkJYWNjZXNzb3IgPSB2YWx1ZTsKCQkJCXZhbHVlID0gc3ViUGF0aDsKCQkJCXN1YlBhdGggPSBmb3JjZTsKCQkJCWZvcmNlID0gZmFsc2U7CgkJCX0KCgkJCWFjY2Vzc29yID0gYWNjZXNzb3IgfHwgdGhpcy5hY2Nlc3Nvciggc3ViUGF0aCApOwoKCQkJdmFyIHBoeXNpY2FsUGF0aCA9IGFjY2Vzc29yLnBoeXNpY2FsUGF0aDsKCgkJCXZhciBob3N0T2JqID0gYWNjZXNzb3IuaG9zdE9iaiwKCQkJCWluZGV4ID0gYWNjZXNzb3IuaW5kZXgsCgkJCQlpc0hvc3RPYmpBcnJheSA9IGlzQXJyYXkoIGhvc3RPYmogKTsKCgkJCWlmIChpc0hvc3RPYmpBcnJheSAmJiBpc051bWVyaWMoIGluZGV4ICkpIHsKCQkJCWlmIChpbmRleCA+IGhvc3RPYmoubGVuZ3RoKSB7CgkJCQkJdGhyb3cgInlvdSBjYW4gbm90IGFkZCBpdGVtIHdpdGggaG9sZSBpbiBhcnJheSI7CgkJCQl9CgkJCX0gZWxzZSB7CgkJCQlpZiAoaW5kZXggaW4gaG9zdE9iaikgewoJCQkJCXRocm93ICJ2YWx1ZSBhdCBwYXRoOiAnIiArIHRvTG9naWNhbFBhdGgoIGFjY2Vzc29yLnBoeXNpY2FsUGF0aCApICsgIicgaGFzIGJlZW4gZGVmaW5lZCwgIiArCgkJCQkJICAgICAgInRyeSB1c2UgdXBkYXRlIG1ldGhvZCBpbnN0ZWFkIjsKCQkJCX0KCQkJfQoKCQkJaWYgKCFmb3JjZSAmJiB0cmlnZ2VyKCBwaHlzaWNhbFBhdGgsIHBoeXNpY2FsUGF0aCwgYmVmb3JlQ3JlYXRlLCB2YWx1ZSApLmhhc0Vycm9yKCkpIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoKCQkJaWYgKGlzSG9zdE9iakFycmF5ICYmIGlzTnVtZXJpYyggaW5kZXggKSkgewoJCQkJaWYgKGluZGV4ID09IGhvc3RPYmoubGVuZ3RoKSB7CgkJCQkJaG9zdE9ialtpbmRleF0gPSB2YWx1ZTsKCgkJCQl9IGVsc2UgaWYgKGluZGV4IDwgaG9zdE9iai5sZW5ndGgpIHsKCQkJCQkvL2luc2VydCBhbiBpdGVtIHggaW50byBhcnJheSBbIDEsIDIsIDNdIGF0IHBvc2l0aW9uIDIsCgkJCQkJLy8gYW5kIGl0IGJlY29tZXMgWzEsIHgsIDIsIDNdCgkJCQkJaG9zdE9iai5zcGxpY2UoIGFjY2Vzc29yLmluZGV4LCAwLCB2YWx1ZSApOwoJCQkJfQoKCQkJfSBlbHNlIHsKCQkJCWhvc3RPYmpbYWNjZXNzb3IuaW5kZXhdID0gdmFsdWU7CgkJCX0KCgkJCXRyYXZlcnNlTW9kZWwoIHBoeXNpY2FsUGF0aCwgdmFsdWUgKTsKCQkJdHJpZ2dlciggcGh5c2ljYWxQYXRoLCBwaHlzaWNhbFBhdGgsIGFmdGVyQ3JlYXRlLCB2YWx1ZSApOwoJCQlyZXR1cm4gdGhpczsKCQl9LAoKCQlleHRlbmQ6IGZ1bmN0aW9uKCBzdWJQYXRoLCBvYmplY3QgKSB7CgkJCXZhciBuZXdNb2RlbDsKCQkJaWYgKCFvYmplY3QpIHsKCQkJCW9iamVjdCA9IHN1YlBhdGg7CgkJCQluZXdNb2RlbCA9IHRoaXM7CgkJCX0gZWxzZSB7CgkJCQluZXdNb2RlbCA9IHRoaXMuY2QoIHN1YlBhdGggKTsKCQkJfQoJCQlmb3IgKHZhciBrZXkgaW4gb2JqZWN0KSB7CgkJCQluZXdNb2RlbC5zZXQoIGtleSwgb2JqZWN0W2tleV0gKTsKCQkJfQoJCQlyZXR1cm4gdGhpczsKCQl9LAoKCQkvKiBhY2Nlc3NvciBpcyB1c2VkIGludGVybmFsbHkgKi8KCQkvL3VwZGF0ZSh2YWx1ZSkKCQkvL3VwZGF0ZShzdWJQYXRoLCB2YWx1ZSkKCQkvL21vc3Qgb2YgdGhlIHRpbWUgZm9yY2UgaXMgbm90IHVzZWQsIGJ5IGRlZmF1bHQgaXMgaXQgaXMgZmFsc2UKCQkvL2J5IGluIGNhc2UgeW91IHdhbnQgdG8gYnlwYXNzIHZhbGlkYXRpb24geW91IGNhbiBleHBsaWNpdGx5IHNldCB0byB0cnVlCgkJdXBkYXRlOiBmdW5jdGlvbiggZm9yY2UsIHN1YlBhdGgsIHZhbHVlLCBhY2Nlc3NvciApIHsKCgkJCWlmIChhcmd1bWVudHMubGVuZ3RoID09IDEpIHsKCQkJCWlmICh0aGlzLnBhdGggPT09ICIiKSB7CgkJCQkJdGhyb3cgInJvb3Qgb2JqZWN0IGNhbiBub3QgdXBkYXRlZCI7CgkJCQl9IGVsc2UgewoJCQkJCXJvb3ROb2RlLnVwZGF0ZSggdGhpcy5wYXRoLCBmb3JjZSApOwoJCQkJCXJldHVybiB0aGlzOwoJCQkJfQoJCQl9CgoJCQlpZiAoIWlzQm9vbGVhbiggZm9yY2UgKSkgewoJCQkJYWNjZXNzb3IgPSB2YWx1ZTsKCQkJCXZhbHVlID0gc3ViUGF0aDsKCQkJCXN1YlBhdGggPSBmb3JjZTsKCQkJCWZvcmNlID0gZmFsc2U7CgkJCX0gZWxzZSBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PSAyKSB7CgkJCQlyb290Tm9kZS51cGRhdGUoIGZvcmNlLCB0aGlzLnBhdGgsIHN1YlBhdGggKTsKCQkJCXJldHVybiB0aGlzOwoJCQl9CgoJCQlhY2Nlc3NvciA9IGFjY2Vzc29yIHx8IHRoaXMuYWNjZXNzb3IoIHN1YlBhdGggKTsKCgkJCWlmICghKCBhY2Nlc3Nvci5pbmRleCBpbiBhY2Nlc3Nvci5ob3N0T2JqICkpIHsKCQkJCXRocm93ICJ2YWx1ZSBhdCBwYXRoOiAnIiArIHRvTG9naWNhbFBhdGgoIGFjY2Vzc29yLnBoeXNpY2FsUGF0aCApICsgIicgaGFzIGJlZW4gbm90IGRlZmluZWQsICIgKwoJCQkJICAgICAgInRyeSB1c2UgY3JlYXRlIG1ldGhvZCBpbnN0ZWFkIjsKCQkJfQoKCQkJdmFyIHBoeXNpY2FsUGF0aCA9IGFjY2Vzc29yLnBoeXNpY2FsUGF0aDsKCgkJCXZhciBvcmlnaW5hbFZhbHVlID0gYWNjZXNzb3IuaG9zdE9ialthY2Nlc3Nvci5pbmRleF07CgkJCS8vdXNlICI9PSIgaXMgcHVycG9zZWZ1bCwgd2Ugd2FudCBpdCB0byBiZSBmbGV4aWJsZS4KCQkJLy8gSWYgbW9kZWwgdmFsdWUgaXMgbnVsbCwgYW5kIHRleHRCb3ggdmFsdWUgaXMgIiIsIGJlY2F1c2UgbnVsbCA9PSAiIiwKCQkJLy8gc28gdGhhdCAiIiBjYW4gbm90IGJlIHNldCwgc2FtZSBmb3IgIjkiIGFuZCA5CgkJCWlmIChvcmlnaW5hbFZhbHVlID09IHZhbHVlKSB7CgkJCQlyZXR1cm4gdGhpczsKCQkJfQoKCQkJaWYgKCFmb3JjZSAmJiB0cmlnZ2VyKCBwaHlzaWNhbFBhdGgsIHBoeXNpY2FsUGF0aCwgYmVmb3JlVXBkYXRlLCB2YWx1ZSwgb3JpZ2luYWxWYWx1ZSApLmhhc0Vycm9yKCkpIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoKCQkJYWNjZXNzb3IuaG9zdE9ialthY2Nlc3Nvci5pbmRleF0gPSB2YWx1ZTsKCgkJCXRyYXZlcnNlTW9kZWwoIHBoeXNpY2FsUGF0aCwgdmFsdWUgKTsKCgkJCWlmICghZm9yY2UpIHsKCQkJCXRyaWdnZXIoIHBoeXNpY2FsUGF0aCwgcGh5c2ljYWxQYXRoLCBhZnRlclVwZGF0ZSwgdmFsdWUsIG9yaWdpbmFsVmFsdWUgKTsKCQkJfQoKCQkJcmV0dXJuIHRoaXM7CgkJfSwKCgkJZGVsOiBmdW5jdGlvbiggc3ViUGF0aCApIHsKCQkJaWYgKGlzVW5kZWZpbmVkKCBzdWJQYXRoICkpIHsKCQkJCWlmICh0aGlzLnBhdGgpIHsKCQkJCQlyZXR1cm4gcm9vdE5vZGUuZGVsKCB0aGlzLnBhdGggKTsKCQkJCX0KCQkJCXRocm93ICJyb290IGNhbiBub3QgYmUgZGVsZXRlZCI7CgkJCX0KCgkJCXZhciBhY2Nlc3NvciA9IHRoaXMuYWNjZXNzb3IoIHN1YlBhdGggKSwKCQkJCWhvc3RPYmogPSBhY2Nlc3Nvci5ob3N0T2JqLAoJCQkJcGh5c2ljYWxQYXRoID0gYWNjZXNzb3IucGh5c2ljYWxQYXRoLAoJCQkJcmVtb3ZlZFZhbHVlID0gaG9zdE9ialthY2Nlc3Nvci5pbmRleF0sCgkJCQlpc0hvc3RPYmplY3RBcnJheSA9IGlzQXJyYXkoIGhvc3RPYmogKTsKCgkJCWlmICh0cmlnZ2VyKCBwaHlzaWNhbFBhdGgsIHBoeXNpY2FsUGF0aCwgImJlZm9yZURlbCIsIHVuZGVmaW5lZCwgcmVtb3ZlZFZhbHVlICkuaGFzRXJyb3IoKSkgewoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgoJCQl0cmlnZ2VyKCBwaHlzaWNhbFBhdGgsIHBoeXNpY2FsUGF0aCwgImR1cmluZ0RlbCIsIHVuZGVmaW5lZCwgcmVtb3ZlZFZhbHVlICk7CgoJCQlpZiAoaXNIb3N0T2JqZWN0QXJyYXkpIHsKCgkJCQlob3N0T2JqLnNwbGljZSggYWNjZXNzb3IuaW5kZXgsIDEgKTsKCgkJCX0gZWxzZSB7CgoJCQkJZGVsZXRlIGhvc3RPYmpbYWNjZXNzb3IuaW5kZXhdOwoKCQkJfQoKCQkJZm9yICh2YXIgaSA9IDA7IGkgPCBvbkRlbGV0ZUhhbmRsZXJzLmxlbmd0aDsgaSsrKSB7CgkJCQlvbkRlbGV0ZUhhbmRsZXJzW2ldKCBwaHlzaWNhbFBhdGgsIHJlbW92ZWRWYWx1ZSApOwoJCQl9CgoJCQl0cmlnZ2VyKCBwaHlzaWNhbFBhdGgsIHBoeXNpY2FsUGF0aCwgImFmdGVyRGVsIiwgdW5kZWZpbmVkLCByZW1vdmVkVmFsdWUgKTsKCQkJcmV0dXJuIHJlbW92ZWRWYWx1ZTsKCQl9LAoKCQljcmVhdGVJZlVuZGVmaW5lZDogZnVuY3Rpb24oIHN1YlBhdGgsIHZhbHVlICkgewoJCQlpZiAoaXNVbmRlZmluZWQoIHZhbHVlICkpIHsKCQkJCXRocm93ICJtaXNzaW5nIHZhbHVlIGFyZ3VtZW50IjsKCQkJfQoJCQl2YXIgYWNjZXNzb3IgPSB0aGlzLmFjY2Vzc29yKCBzdWJQYXRoICk7CgkJCXJldHVybiAoIGFjY2Vzc29yLmluZGV4IGluIGFjY2Vzc29yLmhvc3RPYmogKSA/CgkJCQl0aGlzIDoKCQkJCXRoaXMuY3JlYXRlKCBzdWJQYXRoLCB2YWx1ZSwgYWNjZXNzb3IgKTsKCQl9LAoKCQl0b2dnbGU6IGZ1bmN0aW9uKCBzdWJQYXRoICkgewoKCQkJdmFyIGFjY2Vzc29yID0gdGhpcy5hY2Nlc3Nvciggc3ViUGF0aCApOwoJCQlpZiAoYWNjZXNzb3IuaW5kZXggaW4gYWNjZXNzb3IuaG9zdE9iaikgewoJCQkJdGhpcy51cGRhdGUoIHN1YlBhdGgsICFhY2Nlc3Nvci5ob3N0T2JqW2FjY2Vzc29yLmluZGV4XSwgYWNjZXNzb3IgKTsKCQkJfQoJCQlyZXR1cm4gdGhpczsKCQl9LAoKCQkvL25hdmlnYXRpb24gbWV0aG9kcwoJCXB1c2hTdGFjazogZnVuY3Rpb24oIG5ld05vZGUgKSB7CgkJCW5ld05vZGUucHJldmlvdXMgPSB0aGlzOwoJCQlyZXR1cm4gbmV3Tm9kZTsKCQl9LAoKCQljZDogZnVuY3Rpb24oIHJlbGF0aXZlUGF0aCApIHsKCQkJcmV0dXJuIHRoaXMucHVzaFN0YWNrKCBobSggdGhpcy5nZXRQYXRoKCByZWxhdGl2ZVBhdGggKSApICk7CgkJfSwKCgkJcGFyZW50OiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHRoaXMuY2QoICIuLiIgKTsKCQl9LAoKCQlzaGFkb3c6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gdGhpcy5jZCggIioiICk7CgkJfSwKCgkJc2libGluZzogZnVuY3Rpb24oIHBhdGggKSB7CgkJCXJldHVybiB0aGlzLmNkKCAiLi4iICsgcGF0aCApOwoJCX0sCgoJCW1haW46IGZ1bmN0aW9uKCkgewoKCQkJcmV0dXJuIHRoaXMucHVzaFN0YWNrKCBobSggZ2V0TWFpblBhdGgoIHRoaXMucGF0aCApICkgKTsKCQl9LAoKCQkvLy0tLS0tLS0tLS0tLS0tcGF0aCBtZXRob2RzLS0tLS0tLS0tLS0tLS0tCgkJZ2V0UGF0aDogZnVuY3Rpb24oIHN1YlBhdGggKSB7CgkJCS8vam9pbiB0aGUgY29udGV4dCBhbmQgc3ViUGF0aCB0b2dldGhlciwgYnV0IGl0IGlzIHN0aWxsIGEgbG9naWNhbCBwYXRoCgkJCXJldHVybiBtZXJnZVBhdGgoIHRoaXMucGF0aCwgc3ViUGF0aCApOwoJCX0sCgoJCS8vdG8gZ2V0IHRoZSBsb2dpY2FsUGF0aCBvZiBjdXJyZW50IG1vZGVsLCBsZWF2ZSBzdWJQYXRoIGVtcHR5CgkJbG9naWNhbFBhdGg6IGZ1bmN0aW9uKCBzdWJQYXRoICkgewoJCQlyZXR1cm4gdG9Mb2dpY2FsUGF0aCggdGhpcy5nZXRQYXRoKCBzdWJQYXRoICkgKTsKCQl9LAoKCQkvL3RvIGdldCB0aGUgcGh5c2ljYWxQYXRoIG9mIGN1cnJlbnQgbW9kZWwsIGxlYXZlIHN1YlBhdGggZW1wdHkKCQlwaHlzaWNhbFBhdGg6IGZ1bmN0aW9uKCBzdWJQYXRoICkgewoJCQlyZXR1cm4gdG9QaHlzaWNhbFBhdGgoIHRoaXMuZ2V0UGF0aCggc3ViUGF0aCApICk7CgkJfSwKCgkJcGF0aENvbnRleHQ6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gY29udGV4dE9mUGF0aCggdGhpcy5wYXRoICk7CgkJfSwKCgkJcGF0aEluZGV4OiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIGluZGV4T2ZQYXRoKCB0aGlzLnBhdGggKTsKCQl9LAoKCQkvL2NhbGwgdGhlIG5hdGl2ZSBtZXRob2Qgb2YgdGhlIHdyYXBwZWQgdmFsdWUKCQlpbnZva2VVbndyYXBwZWQ6IGZ1bmN0aW9uKCBtZXRob2ROYW1lIC8qLCBwMSwgcDIsIC4uLiovICkgewoJCQlpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMCkgewoJCQkJdGhyb3cgIm1ldGhvZE5hbWUgaXMgbWlzc2luZyI7CgkJCX0KCgkJCXZhciBjb250ZXh0ID0gdGhpcy5nZXQoKTsKCQkJcmV0dXJuIGNvbnRleHRbbWV0aG9kTmFtZV0uYXBwbHkoIGNvbnRleHQsIHNsaWNlLmNhbGwoIGFyZ3VtZW50cywgMSApICk7CgkJfSwKCgkJLy9yZWdpb24gYXJyYXkgbWV0aG9kcwoJCWluZGV4T2Y6IGZ1bmN0aW9uKCBpdGVtICkgewoJCQlyZXR1cm4gdGhpcy5nZXQoKS5pbmRleE9mKCBpdGVtICk7CgkJfSwKCgkJY29udGFpbnM6IGZ1bmN0aW9uKCBpdGVtICkgewoJCQlyZXR1cm4gKHRoaXMuaW5kZXhPZiggaXRlbSApICE9PSAtMSk7CgkJfSwKCgkJZmlyc3Q6IGZ1bmN0aW9uKCBmbiApIHsKCQkJcmV0dXJuIGZuID8gdGhpcy5maWx0ZXIoIGZuIClbMF0gOiB0aGlzLmdldCggIjAiICk7CgkJfSwKCgkJbGFzdDogZnVuY3Rpb24oKSB7CgkJCXZhciB2YWx1ZSA9IHRoaXMuZ2V0KCk7CgkJCXJldHVybiB2YWx1ZVt2YWx1ZS5sZW5ndGggLSAxXTsKCQl9LAoKCQlwdXNoOiBmdW5jdGlvbiggaXRlbSApIHsKCQkJZm9yICh2YXIgaSA9IDA7IGkgPCBhcmd1bWVudHMubGVuZ3RoOyBpKyspIHsKCQkJCXRoaXMuY3JlYXRlKCB0aGlzLmdldCgpLmxlbmd0aCwgYXJndW1lbnRzW2ldICk7CgkJCX0KCQkJcmV0dXJuIHRoaXM7CgkJfSwKCgkJcHVzaFVuaXF1ZTogZnVuY3Rpb24oIGl0ZW0gKSB7CgkJCXJldHVybiAhdGhpcy5jb250YWlucyggaXRlbSApID8KCQkJCXRoaXMucHVzaCggaXRlbSApIDoKCQkJCXRoaXM7CgkJfSwKCgkJcG9wOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHRoaXMucmVtb3ZlQXQoIHRoaXMuZ2V0KCkubGVuZ3RoIC0gMSApOwoJCX0sCgoJCXNoaWZ0OiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHRoaXMuZGVsKCAwICk7CgkJfSwKCgkJdW5zaGlmdDogZnVuY3Rpb24oIGl0ZW0gKSB7CgkJCXJldHVybiB0aGlzLmNyZWF0ZSggMCwgaXRlbSApOwoJCX0sCgoJCWluc2VydEF0OiBmdW5jdGlvbiggaW5kZXgsIGl0ZW0gKSB7CgkJCXJldHVybiB0aGlzLmNyZWF0ZSggaW5kZXgsIGl0ZW0gKTsKCQl9LAoKCQl1cGRhdGVBdDogZnVuY3Rpb24oIGluZGV4LCBpdGVtICkgewoJCQlyZXR1cm4gdGhpcy51cGRhdGUoIGluZGV4LCBpdGVtICk7CgkJfSwKCgkJcmVtb3ZlQXQ6IGZ1bmN0aW9uKCBpbmRleCApIHsKCQkJcmV0dXJuIHRoaXMuZGVsKCBpbmRleCApOwoJCX0sCgoJCW1vdmU6IGZ1bmN0aW9uKCBmcm9tSW5kZXgsIHRvSW5kZXggKSB7CgkJCXZhciBjb3VudCA9IHRoaXMuY291bnQoKTsKCgkJCWlmIChmcm9tSW5kZXggIT09IHRvSW5kZXggJiYKCQkJICAgIGZyb21JbmRleCA+PSAwICYmIGZyb21JbmRleCA8IGNvdW50ICYmCgkJCSAgICB0b0luZGV4ID49IDAgJiYgdG9JbmRleCA8IGNvdW50KSB7CgoJCQkJdmFyIGl0ZW0gPSB0aGlzLmRlbCggZnJvbUluZGV4ICk7CgkJCQl0aGlzLmluc2VydEF0KCB0b0luZGV4LCBpdGVtICk7CgkJCQl0cmlnZ2VyKCB0aGlzLnBhdGgsIHRoaXMucGF0aCwgIm1vdmUiLCB0b0luZGV4LCBmcm9tSW5kZXggKTsKCQkJfQoJCQlyZXR1cm4gdGhpczsKCQl9LAoKCQlyZXBsYWNlSXRlbTogZnVuY3Rpb24oIG9sZEl0ZW0sIG5ld0l0ZW0gKSB7CgkJCWlmIChvbGRJdGVtID09IG5ld0l0ZW0pIHsKCQkJCXJldHVybiB0aGlzOwoJCQl9CgoJCQl2YXIgaW5kZXggPSB0aGlzLmluZGV4T2YoIG9sZEl0ZW0gKTsKCgkJCWlmIChpbmRleCAhPSAtMSkgewoJCQkJcmV0dXJuIHRoaXMudXBkYXRlQXQoIGluZGV4LCBuZXdJdGVtICk7CgkJCX0KCQkJcmV0dXJuIHRoaXM7CgkJfSwKCgkJcmVtb3ZlSXRlbTogZnVuY3Rpb24oIGl0ZW0gKSB7CgkJCXZhciBpbmRleCA9IHRoaXMuaW5kZXhPZiggaXRlbSApOwoJCQlyZXR1cm4gaW5kZXggIT09IC0xID8gdGhpcy5yZW1vdmVBdCggaW5kZXggKSA6IHRoaXM7CgkJfSwKCgkJcmVtb3ZlSXRlbXM6IGZ1bmN0aW9uKCBpdGVtcyApIHsKCQkJZm9yICh2YXIgaSA9IDA7IGkgPCBpdGVtcy5sZW5ndGg7IGkrKykgewoJCQkJdGhpcy5yZW1vdmVJdGVtKCBpdGVtc1tpXSApOwoJCQl9CgkJCXJldHVybiB0aGlzOwoJCX0sCgoJCWNsZWFyOiBmdW5jdGlvbigpIHsKCQkJdmFyIGl0ZW1zID0gdGhpcy5nZXQoKSwKCQkJCW9sZEl0ZW1zID0gaXRlbXMuc3BsaWNlKCAwLCBpdGVtcy5sZW5ndGggKTsKCgkJCXRyaWdnZXIoIHRoaXMucGF0aCwgdGhpcy5wYXRoLCAiYWZ0ZXJDcmVhdGUiLCBpdGVtcywgb2xkSXRlbXMgKTsKCQkJcmV0dXJuIHRoaXM7CgkJfSwKCgkJY291bnQ6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gdGhpcy5nZXQoKS5sZW5ndGg7CgkJfSwKCgkJLy9mbiBpcyBsaWtlIGZ1bmN0aW9uIChpbmRleCwgaXRlbSkgeyByZXR1cm4gaXRlbSA9PSAxOyB9OwoJCWZpbHRlcjogZnVuY3Rpb24oIGZuICkgewoJCQlyZXR1cm4gJCggdGhpcy5nZXQoKSApLmZpbHRlciggZm4gKS5nZXQoKTsKCQl9LAoKCQkvL2ZuOiBmdW5jdGlvbiAoaW5kZXgsIGl0ZW0sIGl0ZW1zKSB7fQoJCWVhY2g6IGZ1bmN0aW9uKCBkaXJlY3RBY2Nlc3MsIGZuICkgewoJCQlpZiAoIWlzQm9vbGVhbiggZGlyZWN0QWNjZXNzICkpIHsKCQkJCWZuID0gZGlyZWN0QWNjZXNzOwoJCQkJZGlyZWN0QWNjZXNzID0gZmFsc2U7CgkJCX0KCgkJCXZhciBoYXNDaGFuZ2UsIGksIHN0YXR1cywgaXRlbXMsIGl0ZW1Nb2RlbDsKCgkJCWlmIChkaXJlY3RBY2Nlc3MpIHsKCgkJCQlpdGVtcyA9IHRoaXMuZ2V0KCk7CgoJCQkJZm9yIChpID0gaXRlbXMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKCQkJCQkvL3RoaXMgaW4gdGhlIGZuIHJlZmVyIHRvIHRoZSBwYXJlbnQgYXJyYXkKCQkJCQlzdGF0dXMgPSBmbi5jYWxsKCBpdGVtc1tpXSwgaSwgaXRlbXNbaV0sIGl0ZW1zICk7CgkJCQkJaWYgKHN0YXR1cyA9PT0gdHJ1ZSkgewoJCQkJCQloYXNDaGFuZ2UgPSB0cnVlOwoJCQkJCX0gZWxzZSBpZiAoc3RhdHVzID09PSBmYWxzZSkgewoJCQkJCQlicmVhazsKCQkJCQl9CgkJCQl9CgoJCQkJaWYgKGhhc0NoYW5nZSkgewoJCQkJCXRoaXMuY2hhbmdlKCk7CgkJCQl9CgoJCQl9IGVsc2UgewoJCQkJZm9yIChpID0gdGhpcy5jb3VudCgpIC0gMTsgaSA+PSAwOyBpLS0pIHsKCQkJCQkvL3RoaXMgaW4gdGhlIGZuLCByZWZlciB0byB0aGUgcGFyZW50IG1vZGVsCgkJCQkJaXRlbU1vZGVsID0gdGhpcy5jZCggaSApOwoJCQkJCWlmIChmbi5jYWxsKCBpdGVtTW9kZWwsIGksIGl0ZW1Nb2RlbCwgdGhpcyApID09PSBmYWxzZSkgewoJCQkJCQlicmVhazsKCQkJCQl9CgkJCQl9CgkJCX0KCQkJcmV0dXJuIHRoaXM7CgkJfSwKCgkJbWFwOiBmdW5jdGlvbiggZm4gKSB7CgkJCXJldHVybiAkLm1hcCggdGhpcy5nZXQoKSwgZm4gKTsKCQl9LAoKCQlzb3J0OiBmdW5jdGlvbiggYnksIGFzYyApIHsKCQkJcmV0dXJuIHRyaWdnZXIoIHRoaXMucGF0aCwgdGhpcy5wYXRoLCAiYWZ0ZXJVcGRhdGUiLCB0aGlzLmdldCgpLnNvcnRPYmplY3QoIGJ5LCBhc2MgKSApOwoJCX0sCgkJLy8jZW5kcmVnaW9uCgoJCS8vLS0tLS0tLW1vZGVsIHdhdGNoIG1ldGhvZCAtLS0tLS0tLS0tLQoJCXdhdGNoOiBmdW5jdGlvbiggLyp0YXJnZXRQYXRoMSwgdGFyZ2V0UGF0aDIsIC4uKi8gKSB7CgkJCWZvciAodmFyIGkgPSAwOyBpIDwgYXJndW1lbnRzLmxlbmd0aDsgaSsrKSB7CgkJCQl3YXRjaCggdGhpcy5wYXRoLCBhcmd1bWVudHNbaV0gKTsKCQkJfQoJCQlyZXR1cm4gdGhpczsKCQl9LAoKCQl1bndhdGNoOiBmdW5jdGlvbiggLyp0YXJnZXRQYXRoMSwgdGFyZ2V0UGF0aDIsIC4uKi8gKSB7CgkJCWZvciAodmFyIGkgPSAwOyBpIDwgYXJndW1lbnRzLmxlbmd0aDsgaSsrKSB7CgkJCQl1bndhdGNoKCB0aGlzLnBhdGgsIGFyZ3VtZW50c1tpXSApOwoJCQl9CgkJCXJldHVybiB0aGlzOwoJCX0sCgoJCS8vZW5kcmVnaW9uCgoJCS8vLS0tLS0tLW90aGVyIG1ldGhvZHMtLS0tLS0tLS0KCQlpc0VtcHR5OiBmdW5jdGlvbiggc3ViUGF0aCApIHsKCQkJdmFyIHZhbHVlID0gdGhpcy5nZXQoIHN1YlBhdGggKTsKCQkJcmV0dXJuICF2YWx1ZSA/IHRydWUgOgoJCQkJIWlzQXJyYXkoIHZhbHVlICkgPyBmYWxzZSA6CgkJCQkJKHZhbHVlLmxlbmd0aCA9PT0gMCk7CgkJfSwKCgkJaXNTaGFkb3c6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gdGhpcy5wYXRoLnN0YXJ0c1dpdGgoIHNoYWRvd05hbWVzcGFjZSApOwoJCX0sCgoJCXRvSlNPTjogZnVuY3Rpb24oIHN1YlBhdGggKSB7CgkJCXJldHVybiBKU09OLnN0cmluZ2lmeSggdGhpcy5nZXQoIHN1YlBhdGggKSApOwoJCX0sCgoJCWNvbXBhcmU6IGZ1bmN0aW9uKCBleHByZXNzaW9uICkgewoJCQlpZiAoZXhwcmVzc2lvbikgewoJCQkJZXhwcmVzc2lvbiA9IHRvVHlwZWRWYWx1ZSggZXhwcmVzc2lvbiApOwoJCQkJaWYgKGlzU3RyaW5nKCBleHByZXNzaW9uICkpIHsKCQkJCQlpZiAodGhpcy5nZXQoKSA9PSBleHByZXNzaW9uKSB7CgkJCQkJCXJldHVybiB0cnVlOwoJCQkJCX0gZWxzZSB7CgkJCQkJCXRyeSB7CgkJCQkJCQlyZXR1cm4gZXZhbCggInRoaXMuZ2V0KCkiICsgZXhwcmVzc2lvbiApOwoJCQkJCQl9IGNhdGNoIChlKSB7CgkJCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQkJCX0KCQkJCQl9CgkJCQl9IGVsc2UgewoJCQkJCXJldHVybiB0aGlzLmdldCgpID09IGV4cHJlc3Npb247CgkJCQl9CgkJCX0gZWxzZSB7CgkJCQlyZXR1cm4gdGhpcy5pc0VtcHR5KCk7CgkJCX0KCQl9LAoKCQlzYXZlTG9jYWw6IGZ1bmN0aW9uKCBzdWJQYXRoICkgewoJCQl1dGlsLmxvY2FsKCB0aGlzLmdldFBhdGgoIHN1YlBhdGggKSwgdGhpcy5nZXQoIHN1YlBhdGggKSApOwoJCQlyZXR1cm4gdGhpczsKCQl9LAoKCQlnZXRMb2NhbDogZnVuY3Rpb24oIHN1YlBhdGggKSB7CgkJCXJldHVybiB1dGlsLmxvY2FsKCB0aGlzLmdldFBhdGgoIHN1YlBhdGggKSApOwoJCX0sCgoJCXJlc3RvcmVMb2NhbDogZnVuY3Rpb24oIHN1YlBhdGggKSB7CgkJCXJvb3ROb2RlLnNldCggdGhpcy5nZXRQYXRoKCBzdWJQYXRoICksIHRoaXMuZ2V0TG9jYWwoIHN1YlBhdGggKSApOwoJCQlyZXR1cm4gdGhpczsKCQl9LAoKCQljbGVhckxvY2FsOiBmdW5jdGlvbiggc3ViUGF0aCApIHsKCQkJdXRpbC5sb2NhbCggdGhpcy5nZXRQYXRoKCBzdWJQYXRoICksIHVuZGVmaW5lZCApOwoJCQlyZXR1cm4gdGhpczsKCQl9CgoJfTsKCglmdW5jdGlvbiBleHBhbmRUb0hhc2hlcyggJDAgKSB7CgkJcmV0dXJuICQwID09PSAiLiIgPyAiIyIgOiAvL2lmIGl0IGlzICIuIiBjb252ZXJ0IHRvICIjIgoJCQluZXcgQXJyYXkoICQwLmxlbmd0aCArIDIgKS5qb2luKCAiIyIgKTsgLy8vL2lmIGl0IGlzICIjIiBjb252ZXJ0IHRvICIjIyIKCX0KCgl2YXIgb25BZGRPclVwZGF0ZUhhbmRsZXJzID0gW2Z1bmN0aW9uIC8qaW5mZXJOb2RlRGVwZW5kZW5jaWVzKi8gKCBjb250ZXh0LCBpbmRleCwgdmFsdWUgKSB7CgoJCS8vb25seSB0cnkgdG8gcGFyc2UgZnVuY3Rpb24gYm9keQoJCS8vaWYgaXQgaXMgYSBwYXJhbWV0ZXItbGVzcyBmdW5jdGlvbgoJCS8vb3IgaXQgaGFzIGEgbWFnaWMgZnVuY3Rpb24gbmFtZSAiXyIKCQlpZiAoIWlzRnVuY3Rpb24oIHZhbHVlICkgfHwgKHZhbHVlLm5hbWUgJiYgdmFsdWUubmFtZS5zdGFydHNXaXRoKCAiXyIgKSkpIHsKCQkJcmV0dXJuOwoJCX0KCgkJdmFyIGZ1bmN0aW9uQm9keSA9IHZhbHVlLnRvU3RyaW5nKCksCgkJCXBhdGggPSBjb250ZXh0ID8gY29udGV4dCArICIuIiArIGluZGV4IDogaW5kZXgsCgkJCXdhdGNoZWRQYXRocyA9IGV4dHJhY3RXYXRjaGVkUGF0aHMoIGZ1bmN0aW9uQm9keSApOwoKCQlmb3IgKHZhciBpID0gMDsgaSA8IHdhdGNoZWRQYXRocy5sZW5ndGg7IGkrKykgewoJCQl3YXRjaCggcGF0aCwgY29udGV4dCA/IG1lcmdlUGF0aCggY29udGV4dCwgd2F0Y2hlZFBhdGhzW2ldICkgOiB3YXRjaGVkUGF0aHNbaV0gKTsKCQl9Cgl9XTsKCglmdW5jdGlvbiBwcm9jZXNzTmV3Tm9kZSggY29udGV4dFBhdGgsIGluZGV4UGF0aCwgbW9kZWxWYWx1ZSApIHsKCQlmb3IgKHZhciBpID0gMDsgaSA8IG9uQWRkT3JVcGRhdGVIYW5kbGVycy5sZW5ndGg7IGkrKykgewoJCQlvbkFkZE9yVXBkYXRlSGFuZGxlcnNbaV0oIGNvbnRleHRQYXRoLCBpbmRleFBhdGgsIG1vZGVsVmFsdWUgKTsKCQl9Cgl9CgoJZnVuY3Rpb24gZ2V0TWFpblBhdGgoIHNoYWRvd1BhdGggKSB7CgkJaWYgKHNoYWRvd1BhdGggPT09IHNoYWRvd05hbWVzcGFjZSkgewoJCQlyZXR1cm4gIiI7CgkJfQoJCXZhciBtYXRjaCA9IHJTaGFkb3dLZXkuZXhlYyggc2hhZG93UGF0aCApOwoJCXJldHVybiBtYXRjaCA/IGNvbnZlcnRTaGFkb3dLZXlUb01haW5QYXRoKCBtYXRjaFsxXSApIDogc2hhZG93UGF0aDsKCX0KCglmdW5jdGlvbiBjb252ZXJ0U2hhZG93S2V5VG9NYWluUGF0aCgga2V5ICkgewoJCXJldHVybiBrZXkucmVwbGFjZSggckhhc2gsIHJlZHVjZVRvRG90ICk7Cgl9CgoJZnVuY3Rpb24gcmVkdWNlVG9Eb3QoIGhhc2hlcyApIHsKCQlyZXR1cm4gaGFzaGVzID09ICIjIiA/ICIuIiA6IC8vIGlmIGlzICMgcmV0dXJuIC4KCQkJbmV3IEFycmF5KCBoYXNoZXMubGVuZ3RoICkuam9pbiggIiMiICk7IC8vIGlmIGl0IGlzICMjIHJldHVybiAjCgl9CgoJLyogcHJvY2Vzc0N1cnJlbnQgaXMgdXNlZCBpbnRlcm5hbGx5LCBkb24ndCB1c2UgaXQgKi8KCWZ1bmN0aW9uIHRyYXZlcnNlTW9kZWwoIG1vZGVsUGF0aCwgbW9kZWxWYWx1ZSwgcHJvY2Vzc0N1cnJlbnQgKSB7CgkJdmFyIGNvbnRleHRQYXRoLAoJCQlpbmRleFBhdGgsCgkJCWluZGV4T2ZMYXN0RG90ID0gbW9kZWxQYXRoLmxhc3RJbmRleE9mKCAiLiIgKTsKCgkJaWYgKGlzVW5kZWZpbmVkKCBwcm9jZXNzQ3VycmVudCApKSB7CgkJCXByb2Nlc3NDdXJyZW50ID0gdHJ1ZTsKCQl9CgoJCWlmIChwcm9jZXNzQ3VycmVudCkgewoKCQkJaWYgKGluZGV4T2ZMYXN0RG90ID09PSAtMSkgewoJCQkJY29udGV4dFBhdGggPSAiIjsKCQkJCWluZGV4UGF0aCA9IG1vZGVsUGF0aDsKCQkJfSBlbHNlIHsKCQkJCWNvbnRleHRQYXRoID0gbW9kZWxQYXRoLnN1YnN0cmluZyggMCwgaW5kZXhPZkxhc3REb3QgKTsKCQkJCWluZGV4UGF0aCA9IG1vZGVsUGF0aC5zdWJzdHJpbmcoIGluZGV4T2ZMYXN0RG90ICsgMSApOwoJCQl9CgoJCQlwcm9jZXNzTmV3Tm9kZSggY29udGV4dFBhdGgsIGluZGV4UGF0aCwgbW9kZWxWYWx1ZSApOwoJCX0KCgkJaWYgKCFpc1ByaW1pdGl2ZSggbW9kZWxWYWx1ZSApKSB7CgoJCQlmb3IgKGluZGV4UGF0aCBpbiBtb2RlbFZhbHVlKSB7CgoJCQkJLy9kbyBub3QgcmVtb3ZlIHRoZSBoYXNPd25Qcm9wZXJ0eSBjaGVjayEhCgkJCQkvL2lmIChoYXNPd24uY2FsbCggbW9kZWxWYWx1ZSwgaW5kZXggKSkgewoJCQkJcHJvY2Vzc05ld05vZGUoIG1vZGVsUGF0aCwgaW5kZXhQYXRoLCBtb2RlbFZhbHVlW2luZGV4UGF0aF0gKTsKCQkJCXRyYXZlcnNlTW9kZWwoIG1vZGVsUGF0aCArICIuIiArIGluZGV4UGF0aCwgbW9kZWxWYWx1ZVtpbmRleFBhdGhdLCBmYWxzZSApOwoJCQkJLy99CgkJCX0KCQl9Cgl9CgoJZnVuY3Rpb24gd2F0Y2goIHdhdGNoaW5nUGF0aCwgd2F0Y2hlZFBhdGggKSB7CgkJd2F0Y2hlZFBhdGggPSB0b1BoeXNpY2FsUGF0aCggd2F0Y2hlZFBhdGggKTsKCQl2YXIgcmVmZXJlbmNpbmdQYXRocyA9IHdhdGNoVGFibGVbd2F0Y2hlZFBhdGhdOwoJCWlmICghcmVmZXJlbmNpbmdQYXRocykgewoJCQl3YXRjaFRhYmxlW3dhdGNoZWRQYXRoXSA9IHJlZmVyZW5jaW5nUGF0aHMgPSBbXTsKCQl9CgkJcmVmZXJlbmNpbmdQYXRocy5wdXNoVW5pcXVlKCB3YXRjaGluZ1BhdGggKTsKCX0KCglmdW5jdGlvbiB1bndhdGNoKCB3YXRjaGluZ1BhdGgsIHdhdGNoZWRQYXRoICkgewoJCXdhdGNoZWRQYXRoID0gdG9QaHlzaWNhbFBhdGgoIHdhdGNoZWRQYXRoICk7CgkJdmFyIHdhdGNoaW5nUGF0aHMgPSB3YXRjaFRhYmxlW3dhdGNoZWRQYXRoXTsKCQl3YXRjaGluZ1BhdGhzLnJlbW92ZSggd2F0Y2hpbmdQYXRoICk7CgkJaWYgKCF3YXRjaGluZ1BhdGhzLmxlbmd0aCkgewoJCQlkZWxldGUgd2F0Y2hUYWJsZVt3YXRjaGVkUGF0aF07CgkJfQoJfQoKCWZ1bmN0aW9uIGV4dHJhY3RXYXRjaGVkUGF0aHMoIGZ1bmN0aW9uQm9keSApIHsKCQl2YXIgbWVtYmVyTWF0Y2gsCgkJCXJ0biA9IFtdOwoKCQl3aGlsZSAoKG1lbWJlck1hdGNoID0gcldhdGNoZWRQYXRoLmV4ZWMoIGZ1bmN0aW9uQm9keSApICkpIHsKCQkJcnRuLnB1c2hVbmlxdWUoIG1lbWJlck1hdGNoWzJdICk7CgkJfQoJCXJldHVybiBydG47Cgl9CgoJZnVuY3Rpb24gY29udGV4dE9mUGF0aCggcGF0aCApIHsKCQl2YXIgbWF0Y2ggPSByUGFyZW50S2V5LmV4ZWMoIHBhdGggKTsKCQlyZXR1cm4gbWF0Y2ggJiYgbWF0Y2hbMV0gfHwgIiI7Cgl9CgoJZnVuY3Rpb24gaW5kZXhPZlBhdGgoIHBhdGggKSB7CgkJdmFyIG1hdGNoID0gckluZGV4LmV4ZWMoIHBhdGggKTsKCQlyZXR1cm4gbWF0Y2hbMV0gfHwgbWF0Y2hbMF07Cgl9CgoJdmFyIGR1bW15ID0ge307CgoJdmFyIENsYXNzID0gZnVuY3Rpb24gXyggc2VlZCApIHsKCQl2YXIgdGVtcDsKCgkJaWYgKCEodGhpcyBpbnN0YW5jZW9mIF8pKSB7CgkJCXRlbXAgPSBuZXcgXyggZHVtbXkgKTsKCQkJcmV0dXJuIF8uYXBwbHkoIHRlbXAsIGFyZ3VtZW50cyApOwoJCX0KCgkJaWYgKGFyZ3VtZW50c1swXSA9PT0gZHVtbXkpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQl0aGlzLmluaXRpYWxpemUuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwoJCXJldHVybiB0aGlzOwoJfTsKCgl2YXIgc3VwZXJQcm90b3R5cGU7CglleHRlbmQoIENsYXNzLnByb3RvdHlwZSwgewoKCQljYWxsUHJvdG86IGZ1bmN0aW9uKCBtZXRob2ROYW1lICkgewoJCQl2YXIgbWV0aG9kID0gdGhpcy5jb25zdHJ1Y3Rvci5wcm90b3R5cGVbbWV0aG9kTmFtZV07CgkJCXJldHVybiBtZXRob2QuYXBwbHkoIHRoaXMsIHNsaWNlLmNhbGwoIGFyZ3VtZW50cywgMSApICk7CgkJfSwKCgkJLy9pbnN0YW5jZS5jYWxsQmFzZSgibWV0aG9kMSIsIHAxLCBwMiwuLi4pOwoJCWNhbGxCYXNlOiBmdW5jdGlvbiggbWV0aG9kTmFtZSApIHsKCQkJLy9zdXBlclByb3RvdHlwZSBpcyBnbG9iYWwgb2JqZWN0LCB3ZSB1c2UgdGhpcwoJCQkvLyBiZWNhdXNlIGFzc3VtZSBqcyBpbiBicm93c2VyIGlzIGEgc2luZ2xlIHRocmVhZGVkCgoJCQkvL3N0YXJ0aW5nIGZyb20gInRoaXMiIGluc3RhbmNlCgkJCXN1cGVyUHJvdG90eXBlID0gc3VwZXJQcm90b3R5cGUgfHwgdGhpczsKCQkJc3VwZXJQcm90b3R5cGUgPSBzdXBlclByb3RvdHlwZS5jb25zdHJ1Y3Rvci5fX3N1cGVyX187CgoJCQlpZiAoIXN1cGVyUHJvdG90eXBlKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCXZhciBtZXRob2QgPSBzdXBlclByb3RvdHlwZVttZXRob2ROYW1lXTsKCQkJdmFyIHJ0biA9IG1ldGhvZC5hcHBseSggdGhpcywgc2xpY2UuY2FsbCggYXJndW1lbnRzLCAxICkgKTsKCgkJCS8vd2hlbiBpdCBkb25lLCBzZXQgaXQgYmFjayB0byBudWxsCgkJCXN1cGVyUHJvdG90eXBlID0gbnVsbDsKCQkJcmV0dXJuIHJ0bjsKCQl9LAoKCQkvKiB0aGUgc3ViVHlwZSdzIGluaXRpYWxpemUgc2hvdWxkIGJlIGxpa2UKCQkgKgoJCSBpbml0aWFsaXplOiBmdW5jdGlvbiggc2VlZCApIHsKCQkgLy9kbyB0aGluZ3MKCQkgdGhpcy5jYWxsQmFzZSggImluaXRpYWxpemUiLCBzZWVkICk7CgkJIH0sCgkJICovCgkJLy90aGUgZGVmYXVsdCBpbml0aWFsaXplIGlzIHRvIGV4dGVuZCB0aGUgaW5zdGFuY2Ugd2l0aCBzZWVkIGRhdGEKCQlpbml0aWFsaXplOiBmdW5jdGlvbiggc2VlZCApIHsKCQkJZXh0ZW5kKCB0aGlzLCBzZWVkICk7CgkJfSwKCgkJLy90aGlzIGZ1bmN0aW9uIHdpbGwgYmUgY2FsbGVkIHdoZW4gSlNPTi5zdHJpbmdpZnkoKSBpcyBjYWxsZWQKCQl0b0pTT046IGZ1bmN0aW9uKCkgewoJCQl2YXIgcnRuID0gZXh0ZW5kKCB0cnVlLCB7fSwgdGhpcyApOwoKCQkJZm9yICh2YXIga2V5IGluIHJ0bikgewoJCQkJaWYgKGtleS5zdGFydHNXaXRoKCAiX18iICkpIHsKCQkJCQlkZWxldGUgcnRuW2tleV07CgkJCQl9CgkJCX0KCQkJcmV0dXJuIHJ0bjsKCQl9CgoJfSApOwoKCWV4dGVuZCggQ2xhc3MsIHsKCgkJLy9jcmVhdGUgYW4gYXJyYXkgb2YgaXRlbXMgb2YgdGhlIHNhbWUgdHlwZQoJCS8vaWYgWW91IGhhdmUgYSBzdWJUeXBlIGNhbGxlZCBQZXJzb24KCQkvL3lvdSBjYW4gUGVyc29uLmxpc3QoWyBzZWVkMSwgc2VlZDIgXSk7CgkJLy90byBjcmVhdGUgYW4gYXJyYXkgb2YgdHlwZWQgaXRlbXMKCQlsaXN0OiBmdW5jdGlvbiggc2VlZHMgKSB7CgoJCQl2YXIgaSwKCQkJCXNlZWQsCgkJCQlydG4gPSBbXSwKCQkJCWl0ZW1Jc09iamVjdDsKCgkJCWlmIChpc1VuZGVmaW5lZCggc2VlZHMgKSkgewoKCQkJCXJldHVybiBydG47CgoJCQl9IGVsc2UgewoKCQkJCWlmICghaXNBcnJheSggc2VlZHMgKSkgewoKCQkJCQlzZWVkcyA9IHNsaWNlLmNhbGwoIGFyZ3VtZW50cyApOwoKCQkJCX0KCgkJCQlpdGVtSXNPYmplY3QgPSBzZWVkcy5pdGVtSXNPYmplY3Q7CgoJCQkJZm9yIChpID0gMDsgaSA8IHNlZWRzLmxlbmd0aDsgaSsrKSB7CgkJCQkJc2VlZCA9IHNlZWRzW2ldOwoKCQkJCQlydG4ucHVzaCgKCQkJCQkJaXRlbUlzT2JqZWN0IHx8ICFpc0FycmF5KCBzZWVkICkgPwoJCQkJCQkJc2VlZHMgaW5zdGFuY2VvZiB0aGlzID8gdGhpcyA6IG5ldyB0aGlzKCBzZWVkICkgOgoJCQkJCQkJdGhpcy5hcHBseSggbnVsbCwgc2VlZCApCgkJCQkJKTsKCQkJCX0KCgkJCX0KCgkJCXJldHVybiBydG47CgkJfSwKCgkJLy90byBjcmVhdGUgYSBuZXcgVHlwZSBjYWxsCgoJCWV4dGVuZDogZnVuY3Rpb24oIGluc3RhbmNlTWVtYmVycywgc3RhdGljTWVtYmVycyApIHsKCQkJdmFyIENoaWxkLAoJCQkJUGFyZW50ID0gdGhpczsKCgkJCS8vIFRoZSBjb25zdHJ1Y3RvciBmdW5jdGlvbiBmb3IgdGhlIG5ldyBzdWJjbGFzcyBpcyBlaXRoZXIgZGVmaW5lZCBieSB5b3UKCQkJLy8gKHRoZSAiY29uc3RydWN0b3IiIHByb3BlcnR5IGluIHlvdXIgYGV4dGVuZGAgZGVmaW5pdGlvbiksIG9yIGRlZmF1bHRlZAoJCQkvLyBieSB1cyB0byBzaW1wbHkgY2FsbCB0aGUgcGFyZW50J3MgY29uc3RydWN0b3IuCgkJCWlmIChpbnN0YW5jZU1lbWJlcnMgJiYgaW5zdGFuY2VNZW1iZXJzLmhhc093blByb3BlcnR5KCAiY29uc3RydWN0b3IiICkpIHsKCQkJCUNoaWxkID0gaW5zdGFuY2VNZW1iZXJzLmNvbnN0cnVjdG9yOwoJCQl9IGVsc2UgewoJCQkJQ2hpbGQgPSBmdW5jdGlvbiBfKCkgewoJCQkJCXZhciB0ZW1wOwoKCQkJCQlpZiAoISh0aGlzIGluc3RhbmNlb2YgXykpIHsKCQkJCQkJdGVtcCA9IG5ldyBfKCBkdW1teSApOwoJCQkJCQlyZXR1cm4gXy5hcHBseSggdGVtcCwgYXJndW1lbnRzICk7CgkJCQkJfQoKCQkJCQlpZiAoYXJndW1lbnRzWzBdID09PSBkdW1teSkgewoJCQkJCQlyZXR1cm4gdGhpczsKCQkJCQl9CgkJCQkJLy90aGlzIGlzIHNpbWlsYXIgbGlrZSA6IGJhc2UoYXJndW1lbnRzKQoJCQkJCVBhcmVudC5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgkJCQkJcmV0dXJuIHRoaXM7CgkJCQl9OwoJCQl9CgoJCQkvLyBBZGQgc3RhdGljIHByb3BlcnRpZXMgdG8gdGhlIGNvbnN0cnVjdG9yIGZ1bmN0aW9uLCBpZiBzdXBwbGllZC4KCQkJZXh0ZW5kKCBDaGlsZCwgUGFyZW50LCBzdGF0aWNNZW1iZXJzICk7CgoJCQkvLyBTZXQgdGhlIHByb3RvdHlwZSBjaGFpbiB0byBpbmhlcml0IGZyb20gYHBhcmVudGAsIHdpdGhvdXQgY2FsbGluZwoJCQkvLyBgcGFyZW50YCdzIGNvbnN0cnVjdG9yIGZ1bmN0aW9uLgoJCQl2YXIgU3Vycm9nYXRlID0gZnVuY3Rpb24oKSB7IHRoaXMuY29uc3RydWN0b3IgPSBDaGlsZDsgfTsKCQkJU3Vycm9nYXRlLnByb3RvdHlwZSA9IFBhcmVudC5wcm90b3R5cGU7CgkJCUNoaWxkLnByb3RvdHlwZSA9IG5ldyBTdXJyb2dhdGUoKTsKCgkJCS8vIEFkZCBwcm90b3R5cGUgcHJvcGVydGllcyAoaW5zdGFuY2UgcHJvcGVydGllcykgdG8gdGhlIHN1YmNsYXNzLAoJCQkvLyBpZiBzdXBwbGllZC4KCQkJaWYgKGluc3RhbmNlTWVtYmVycykgewoJCQkJZXh0ZW5kKCBDaGlsZC5wcm90b3R5cGUsIGluc3RhbmNlTWVtYmVycyApOwoJCQl9CgoJCQkvLyBTZXQgYSBjb252ZW5pZW5jZSBwcm9wZXJ0eSBpbiBjYXNlIHRoZSBwYXJlbnQncyBwcm90b3R5cGUgaXMgbmVlZGVkCgkJCS8vIGxhdGVyLgoJCQlDaGlsZC5fX3N1cGVyX18gPSBQYXJlbnQucHJvdG90eXBlOwoKCQkJcmV0dXJuIENoaWxkOwoJCX0KCgl9ICk7CgoJLy9oZWxwZXJzCglleHRlbmQoIGhtLCB7CgoJCUNsYXNzOiBDbGFzcywKCgkJdXRpbDogdXRpbCA9IHsKCgkJCS8vdXNlciBkbyBub3QgbmVlZCB0byB1c2UgY3JlYXRlU2hhZG93SWZOZWNlc3NhcnkgcGFyYW1ldGVyCgkJCS8vaXQgaXMgZm9yIGludGVybmFsIHVzZQoJCQkvL2l0IGlzIG9ubHkgdXNlZCBpbiB0d28gcGxhY2VzLiBJdCBpcywgd2hlbiBhIG1vZGVsIGlzIGNyZWF0ZWQKCQkJLy8gYW5kIHdoZW4gYWNjZXNzb3IgaXMgYnVpbGQsCgkJCS8vIGV2ZW4gaW4gdGhlc2UgdHdvIGNhc2Ugd2hlbiB0aGUgcGFyYW1ldGVyIGlzIHRydWUsCgkJCS8vIHNoYWRvdyBpcyBub3QgbmVjZXNzYXJ5IGNyZWF0ZWQKCQkJLy8gaXQgaXMgb25seSBjcmVhdGVkIHdoZW4KCQkJLy8gdGhlIHRoZSBwaHlzaWNhbCBwYXRoIGlzIHBvaW50aW5nIHRvIGEgc2hhZG93CgkJCS8vIGFuZCB0aGUgbWFpbiBtb2RlbCBoYXMgYmVlbiBjcmVhdGVkCgkJCS8vIGFuZCB0aGUgc2hhZG93J3MgcGFyZW50IGlzIGFuIG9iamVjdAoJCQl0b1BoeXNpY2FsUGF0aDogdG9QaHlzaWNhbFBhdGggPSBmdW5jdGlvbiggbG9naWNhbFBhdGgsIGNyZWF0ZVNoYWRvd0lmTmVjZXNzYXJ5IC8qIGludGVybmFsIHVzZSovICkgewoKCQkJCXZhciBtYXRjaCwgcnRuID0gIiIsIGxlZnRDb250ZXh0ID0gIiIsIG1haW5WYWx1ZSwgc2hhZG93S2V5LCBtYWluUGF0aDsKCgkJCQl3aGlsZSAoKG1hdGNoID0gckRvdFN0YXIuZXhlYyggbG9naWNhbFBhdGggKSkpIHsKCQkJCQkvL3Jlc2V0IGxvZ2ljYWwgUGF0aCB0byB0aGUgcmVtYWluaW5nIG9mIHRoZSBzZWFyY2ggdGV4dAoJCQkJCWxvZ2ljYWxQYXRoID0gUmVnRXhwLnJpZ2h0Q29udGV4dDsKCQkJCQlsZWZ0Q29udGV4dCA9IFJlZ0V4cC5sZWZ0Q29udGV4dDsKCgkJCQkJaWYgKG1hdGNoWzBdID09ICIuIikgewoKCQkJCQkJaWYgKHJ0bikgewoJCQkJCQkJLy9tYWluUGF0aCA9IHJ0biArICIuIiArIGxlZnRDb250ZXh0CgkJCQkJCQlpZiAocnRuID09IHNoYWRvd05hbWVzcGFjZSAmJiBjcmVhdGVTaGFkb3dJZk5lY2Vzc2FyeSAmJiAhc2hhZG93Um9vdFtsZWZ0Q29udGV4dF0pIHsKCQkJCQkJCQltYWluUGF0aCA9IGNvbnZlcnRTaGFkb3dLZXlUb01haW5QYXRoKCBsZWZ0Q29udGV4dCApOwoJCQkJCQkJCWlmICghaXNVbmRlZmluZWQoIHJvb3ROb2RlLmdldCggbWFpblBhdGggKSApKSB7CgkJCQkJCQkJCXNoYWRvd1Jvb3RbbGVmdENvbnRleHRdID0ge307CgkJCQkJCQkJfQoJCQkJCQkJCS8vIWlzVW5kZWZpbmVkKCByb290Tm9kZS5nZXQoIG1haW5QYXRoICkgKQoJCQkJCQkJCS8qCWlmIChjcmVhdGVTaGFkb3dJZk5lY2Vzc2FyeSAmJgoJCQkJCQkJCSAhc2hhZG93Um9vdFtzaGFkb3dLZXldICYmCgkJCQkJCQkJIHJ0biAhPSBzaGFkb3dOYW1lc3BhY2UgJiYKCQkJCQkJCQkgIWlzVW5kZWZpbmVkKCBtYWluVmFsdWUgPSByb290Tm9kZS5nZXQoIG1haW5QYXRoICkgKSkgewoJCQkJCQkJCSAqLwoJCQkJCQkJfQoJCQkJCQkJcnRuID0gcnRuICsgIi4iICsgbGVmdENvbnRleHQ7CgkJCQkJCQkvL3NoYWRvd1Jvb3Rbc2hhZG93S2V5XQoJCQkJCQkJLy9pZiAocnRuID09KQoJCQkJCQl9IGVsc2UgewoJCQkJCQkJcnRuID0gbGVmdENvbnRleHQ7CgkJCQkJCX0KCgkJCQkJfSBlbHNlIHsKCgkJCQkJCS8vaWYgbWF0Y2ggaXMgIioiLCB0aGVuIGl0IGlzIHNoYWRvdwoJCQkJCQkvL2lmIHJ0biBpcyBub3QgZW1wdHkgc28gZmFyCgkJCQkJCWlmIChydG4pIHsKCQkJCQkJCS8vc2hhZG93S2V5IHdpbGwgYmUKCQkJCQkJCS8vY29udmVydE1haW5QYXRoVG9TaGFkb3dLZXkKCQkJCQkJCXNoYWRvd0tleSA9ICggcnRuID8gcnRuLnJlcGxhY2UoIHJIYXNoT3JEb3QsIGV4cGFuZFRvSGFzaGVzICkgOiBydG4pICsgIiMiICsgbGVmdENvbnRleHQ7CgkJCQkJCQltYWluUGF0aCA9IHJ0biArICIuIiArIGxlZnRDb250ZXh0OwoJCQkJCQl9IGVsc2UgewoJCQkJCQkJaWYgKGxlZnRDb250ZXh0KSB7CgkJCQkJCQkJc2hhZG93S2V5ID0gbGVmdENvbnRleHQ7CgkJCQkJCQkJbWFpblBhdGggPSBsZWZ0Q29udGV4dDsKCgkJCQkJCQl9IGVsc2UgewoKCQkJCQkJCQlzaGFkb3dLZXkgPSAiIjsKCQkJCQkJCQltYWluUGF0aCA9ICIiOwoJCQkJCQkJfQoJCQkJCQl9CgoJCQkJCQlydG4gPSBzaGFkb3dOYW1lc3BhY2UgKyAoc2hhZG93S2V5ID8gIi4iICsgc2hhZG93S2V5IDogIiIpOwoKCQkJCQkJLy9vbmx5IHdoZW4gbWFpbiBtb2RlbCBleGlzdHMgLCBhbmQgaG9zdCBvZiB0aGUgb2JqZWN0IGV4aXN0cwoJCQkJCQkvL3RoZW4gY3JlYXRlIHNoYWRvdwoJCQkJCQlpZiAoY3JlYXRlU2hhZG93SWZOZWNlc3NhcnkgJiYgIXNoYWRvd1Jvb3Rbc2hhZG93S2V5XSAmJgoJCQkJCQkgICAgcnRuICE9IHNoYWRvd05hbWVzcGFjZSAmJiAhaXNVbmRlZmluZWQoIG1haW5WYWx1ZSA9IHJvb3ROb2RlLmdldCggbWFpblBhdGggKSApKSB7CgoJCQkJCQkJc2hhZG93Um9vdFtzaGFkb3dLZXldID0ge307CgkJCQkJCX0KCQkJCQl9CgkJCQl9CgoJCQkJcmV0dXJuICFsb2dpY2FsUGF0aCA/IHJ0biA6CgkJCQkJcnRuID8gcnRuICsgIi4iICsgbG9naWNhbFBhdGggOgoJCQkJCQlsb2dpY2FsUGF0aDsKCQkJfSwKCQkJdG9Mb2dpY2FsUGF0aDogdG9Mb2dpY2FsUGF0aCA9IGZ1bmN0aW9uKCBwaHlzaWNhbFBhdGggKSB7CgoJCQkJdmFyIGluZGV4LCBsb2dpY2FsUGF0aCwgbWFpblBhdGgsIG1hdGNoOwoKCQkJCWlmIChwaHlzaWNhbFBhdGggPT09IHNoYWRvd05hbWVzcGFjZSkgewoJCQkJCXJldHVybiAiKiI7CgkJCQl9CgoJCQkJbWF0Y2ggPSByU2hhZG93S2V5LmV4ZWMoIHBoeXNpY2FsUGF0aCApOwoJCQkJaWYgKG1hdGNoKSB7CgkJCQkJLy8gaWYgcGh5c2ljYWwgcGF0aCBpcyBsaWtlIF9faG0ua2V5LngKCQkJCQkvLyBjb252ZXJ0IHRoZSBrZXkgcGF0aCBpbnRvIG1haW5QYXRoCgkJCQkJaW5kZXggPSBSZWdFeHAucmlnaHRDb250ZXh0OwoJCQkJCW1haW5QYXRoID0gY29udmVydFNoYWRvd0tleVRvTWFpblBhdGgoIG1hdGNoWzFdICk7CgkJCQkJbG9naWNhbFBhdGggPSBtYWluUGF0aCArICIqIiArIGluZGV4OwoJCQkJCXJldHVybiB0b0xvZ2ljYWxQYXRoKCBsb2dpY2FsUGF0aCApOwoKCQkJCX0gZWxzZSB7CgoJCQkJCXJldHVybiBwaHlzaWNhbFBhdGg7CgkJCQl9CgoJCQl9LAoKCQkJLypqb2luIHRoZSBjb250ZXh0IGFuZCBzdWJQYXRoIHRvZ2V0aGVyLCBpZiBwYXRoIGlzIG5vdCBuZWNlc3NhcnkgdGhlIHNhbWUgYXMgbG9naWNhbCBwYXRoCgkJCSAqY29udmVydFN1YlBhdGhUb1JlbGF0aXZlUGF0aCBieSBkZWZhdWx0IGlzIHRydWUsIHNvIHRoYXQgaWYgeW91IHNwZWNpZnkgc3ViUGF0aCBhcyAiYiIKCQkJICogYW5kICBjb250ZXh0IGlzICJhIiwgaXQgd2lsbCBiZSBtZXJnZWQgdG8gImEuYiIgLiBJZiBleHBsaWNpdGx5IHNwZWNpZnkKCQkJICogY29udmVydFN1YlBhdGhUb1JlbGF0aXZlUGF0aCB0byBmYWxzZSwgdGhleSB3aWxsIG5vdCBiZSBtZXJnZWQsIHNvIHRoZSAiYiIgd2lsbCBiZQoJCQkgKiByZXR1cm5lZCBhcyBtZXJnZSBwYXRoKi8KCQkJbWVyZ2VQYXRoOiBtZXJnZVBhdGggPSBmdW5jdGlvbiggY29udGV4dFBhdGgsIHN1YlBhdGgsIGNvbnZlcnRTdWJQYXRoVG9SZWxhdGl2ZVBhdGgKCQkJICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLyp1c2VkIGludGVybmFsbHkqLyApIHsKCQkJCWlmIChzdWJQYXRoID09ICJfIikgewoKCQkJCQlyZXR1cm4gIl8iOwoKCQkJCX0gZWxzZSBpZiAoY29udGV4dFBhdGggPT0gIl8iKSB7CgoJCQkJCWlmIChzdWJQYXRoICYmIHN1YlBhdGguc3RhcnRzV2l0aCggIi8iICkpIHsKCgkJCQkJCWNvbnRleHRQYXRoID0gIiI7CgoJCQkJCX0gZWxzZSB7CgoJCQkJCQlyZXR1cm4gIl8iOwoJCQkJCX0KCQkJCX0KCgkJCQljb250ZXh0UGF0aCA9IHRvUGh5c2ljYWxQYXRoKCBjb250ZXh0UGF0aCApOwoKCQkJCXZhciBtYXRjaDsKCQkJCWlmICghaXNVbmRlZmluZWQoIHN1YlBhdGggKSAmJiBzdWJQYXRoICE9PSBudWxsKSB7CgkJCQkJc3ViUGF0aCA9IHN1YlBhdGggKyAiIjsKCQkJCQlpZiAoc3ViUGF0aC5zdGFydHNXaXRoKCAiLyIgKSkgewoJCQkJCQlyZXR1cm4gc3ViUGF0aC5zdWJzdHIoIDEgKTsKCQkJCQl9CgkJCQl9CgkJCQlpZiAoaXNVbmRlZmluZWQoIGNvbnZlcnRTdWJQYXRoVG9SZWxhdGl2ZVBhdGggKSkgewoJCQkJCWNvbnZlcnRTdWJQYXRoVG9SZWxhdGl2ZVBhdGggPSB0cnVlOwoJCQkJfQoKCQkJCWlmIChjb252ZXJ0U3ViUGF0aFRvUmVsYXRpdmVQYXRoICYmIHN1YlBhdGggJiYgY29udGV4dFBhdGggJiYgIXJCZWdpbkRvdE9yU3Rhci50ZXN0KCBzdWJQYXRoICkpIHsKCQkJCQlzdWJQYXRoID0gIi4iICsgc3ViUGF0aDsKCQkJCX0KCgkJCQlpZiAoIXN1YlBhdGggfHwgc3ViUGF0aCA9PSAiLiIpIHsKCgkJCQkJcmV0dXJuIGNvbnRleHRQYXRoOwoKCQkJCX0gZWxzZSBpZiAoIXJCZWdpbkRvdE9yU3Rhci50ZXN0KCBzdWJQYXRoICkpIHsKCgkJCQkJcmV0dXJuIHN1YlBhdGg7CgoJCQkJfSBlbHNlIGlmICgobWF0Y2ggPSByVXNlUGFyc2VDb250ZXh0QXNDb250ZXh0LmV4ZWMoIHN1YlBhdGggKSkpIHsKCQkJCQkvL2lmIHN1YlBhdGggaXMgbGlrZSAuLnh5eiBvciAuKnh5egoJCQkJCXZhciBzdGVwc1RvR29VcCA9IDEgKyAobWF0Y2hbMV0gPyBtYXRjaFsxXS5sZW5ndGggOiAwKSwKCQkJCQkJcmVtYWluaW5nID0gUmVnRXhwLnJpZ2h0Q29udGV4dCwKCQkJCQkJbWVyZ2VkQ29udGV4dCA9IGNvbnRleHRQYXRoOwoKCQkJCQl3aGlsZSAoc3RlcHNUb0dvVXApIHsKCQkJCQkJbWVyZ2VkQ29udGV4dCA9IGNvbnRleHRPZlBhdGgoIG1lcmdlZENvbnRleHQgKTsKCQkJCQkJc3RlcHNUb0dvVXAtLTsKCQkJCQl9CgoJCQkJCS8vdXNlIHJ1bGUncyBjb250ZXh0IGFzIGNvbnRleHQKCQkJCQkvLy4uIG9yIC4qCgkJCQkJLy8kMiBpcyBlaXRoZXIgIi4iIG9yICIqIgoJCQkJCXJldHVybiByZW1haW5pbmcgPwoJCQkJCQkobWVyZ2VkQ29udGV4dCA/IG1lcmdlZENvbnRleHQgKyBtYXRjaFsyXSArIHJlbWFpbmluZyA6IHJlbWFpbmluZykgOgoJCQkJCQkobWF0Y2hbMl0gPT09ICIqIiA/IG1lcmdlZENvbnRleHQgKyAiKiIgOiBtZXJnZWRDb250ZXh0KTsKCgkJCQkJLy9pZiBzdWJQYXRoIGlzIGxpa2UgLmFiIG9yICphYgoJCQkJfSBlbHNlIGlmICgobWF0Y2ggPSByTWFpblBhdGguZXhlYyggc3ViUGF0aCApKSkgewoKCQkJCQlyZXR1cm4gbWVyZ2VQYXRoKCBnZXRNYWluUGF0aCggY29udGV4dFBhdGggKSwgbWF0Y2hbMV0gKTsKCgkJCQl9CgkJCQlyZXR1cm4gY29udGV4dFBhdGggKyBzdWJQYXRoOwoJCQl9LAoKCQkJaXNVbmRlZmluZWQ6IGlzVW5kZWZpbmVkID0gZnVuY3Rpb24oIG9iaiApIHsKCQkJCXJldHVybiAob2JqID09PSB1bmRlZmluZWQpOwoJCQl9LAoJCQlpc1ByaW1pdGl2ZTogaXNQcmltaXRpdmUgPSBmdW5jdGlvbiggb2JqICkgewoJCQkJcmV0dXJuIChvYmogPT09IG51bGwgKSB8fCAodHlwZW9mKG9iaikgaW4gcHJpbWl0aXZlVHlwZXMpOwoJCQl9LAoJCQlpc1N0cmluZzogaXNTdHJpbmcgPSBmdW5jdGlvbiggdmFsICkgewoJCQkJcmV0dXJuIHR5cGVvZiB2YWwgPT09ICJzdHJpbmciOwoJCQl9LAoJCQlpc09iamVjdDogaXNPYmplY3QgPSBmdW5jdGlvbiggdmFsICkgewoJCQkJcmV0dXJuICQudHlwZSggdmFsICkgPT09ICJvYmplY3QiOwoJCQl9LAoJCQlpc0Jvb2xlYW46IGlzQm9vbGVhbiA9IGZ1bmN0aW9uKCBvYmplY3QgKSB7CgkJCQlyZXR1cm4gdHlwZW9mIG9iamVjdCA9PT0gImJvb2xlYW4iOwoJCQl9LAoJCQl0b1R5cGVkVmFsdWU6IHRvVHlwZWRWYWx1ZSA9IGZ1bmN0aW9uKCBzdHJpbmdWYWx1ZSApIHsKCQkJCWlmIChpc1N0cmluZyggc3RyaW5nVmFsdWUgKSkgewoJCQkJCXN0cmluZ1ZhbHVlID0gJC50cmltKCBzdHJpbmdWYWx1ZSApOwoJCQkJCXRyeSB7CgkJCQkJCXN0cmluZ1ZhbHVlID0gc3RyaW5nVmFsdWUgPT09ICJ0cnVlIiA/IHRydWUgOgoJCQkJCQkJc3RyaW5nVmFsdWUgPT09ICJmYWxzZSIgPyBmYWxzZSA6CgkJCQkJCQkJc3RyaW5nVmFsdWUgPT09ICJudWxsIiA/IG51bGwgOgoJCQkJCQkJCQlzdHJpbmdWYWx1ZSA9PT0gInVuZGVmaW5lZCIgPyB1bmRlZmluZWQgOgoJCQkJCQkJCQkJaXNOdW1lcmljKCBzdHJpbmdWYWx1ZSApID8gcGFyc2VGbG9hdCggc3RyaW5nVmFsdWUgKSA6CgkJCQkJCQkJCQkJLy9EYXRlLnBhcnNlKCBzdHJpbmdWYWx1ZSApID8gbmV3IERhdGUoIHN0cmluZ1ZhbHVlICkgOgoJCQkJCQkJCQkJCXJKU09OLnRlc3QoIHN0cmluZ1ZhbHVlICkgPyAkLnBhcnNlSlNPTiggc3RyaW5nVmFsdWUgKSA6CgkJCQkJCQkJCQkJCXN0cmluZ1ZhbHVlOwoJCQkJCX0gY2F0Y2ggKGUpIHt9CgkJCQl9CgkJCQlyZXR1cm4gc3RyaW5nVmFsdWU7CgkJCX0sCgkJCWlzUHJvbWlzZTogaXNQcm9taXNlID0gZnVuY3Rpb24oIG9iamVjdCApIHsKCQkJCXJldHVybiAhIShvYmplY3QgJiYgb2JqZWN0LnByb21pc2UgJiYgb2JqZWN0LmRvbmUgJiYgb2JqZWN0LmZhaWwpOwoJCQl9LAoJCQljbGVhck9iajogY2xlYXJPYmogPSBmdW5jdGlvbiggb2JqICkgewoJCQkJaWYgKGlzUHJpbWl0aXZlKCBvYmogKSkgewoJCQkJCXJldHVybiBudWxsOwoJCQkJfQoJCQkJZm9yICh2YXIga2V5IGluIG9iaikgewoJCQkJCWlmIChoYXNPd24uY2FsbCggb2JqLCBrZXkgKSkgewoJCQkJCQlvYmpba2V5XSA9IGNsZWFyT2JqKCBvYmpba2V5XSApOwoJCQkJCX0KCQkJCX0KCQkJCXJldHVybiBvYmo7CgkJCX0sCgkJCWNsb25lOiBjbG9uZSA9IGZ1bmN0aW9uKCBvcmlnaW5hbCwgZGVlcENsb25lICkgewoJCQkJcmV0dXJuIGlzUHJpbWl0aXZlKCBvcmlnaW5hbCApID8gb3JpZ2luYWwgOgoJCQkJCWlzQXJyYXkoIG9yaWdpbmFsICkgPyBvcmlnaW5hbC5zbGljZSggMCApIDoKCQkJCQkJaXNGdW5jdGlvbiggb3JpZ2luYWwgKSA/IG9yaWdpbmFsIDoKCQkJCQkJCWV4dGVuZCggISFkZWVwQ2xvbmUsIHt9LCBvcmlnaW5hbCApOwoJCQl9LAoKCQkJbG9jYWw6IGZ1bmN0aW9uKCBrZXksIHZhbHVlICkgewoJCQkJaWYgKGFyZ3VtZW50cy5sZW5ndGggPT0gMSkgewoJCQkJCXJldHVybiBKU09OLnBhcnNlKCBsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgga2V5ICkgKTsKCQkJCX0gZWxzZSB7CgkJCQkJaWYgKGlzVW5kZWZpbmVkKCB2YWx1ZSApKSB7CgkJCQkJCWxvY2FsU3RvcmFnZS5yZW1vdmVJdGVtKCBrZXkgKTsKCQkJCQl9IGVsc2UgewoJCQkJCQlsb2NhbFN0b3JhZ2Uuc2V0SXRlbSgga2V5LCBKU09OLnN0cmluZ2lmeSggdmFsdWUgKSApOwoJCQkJCX0KCQkJCX0KCQkJfSwKCgkJCXRvU3RyaW5nOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJCQlyZXR1cm4gKHZhbHVlID09PSBudWxsIHx8IHZhbHVlID09PSB1bmRlZmluZWQpID8gIiIgOiAiIiArIHZhbHVlOwoJCQl9LAoKCQkJLy8jZGVidWcKCQkJX3JlZmVyZW5jZVRhYmxlOiB3YXRjaFRhYmxlLAoJCQkvLyNlbmRfZGVidWcKCgkJCWVuY29kZUh0bWw6IGZ1bmN0aW9uKCBzdHIgKSB7CgkJCQl2YXIgZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggJ2RpdicgKTsKCQkJCWRpdi5hcHBlbmRDaGlsZCggZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoIHN0ciApICk7CgkJCQlyZXR1cm4gZGl2LmlubmVySFRNTDsKCQkJfQoKCQl9LAoKCQkvL3RoaXMgaXMgdXNlZCB0byBwcm9jZXNzIHRoZSBuZXcgbm9kZSBhZGRlZCB0byByZXBvc2l0b3J5CgkJb25BZGRPclVwZGF0ZU5vZGU6IGZ1bmN0aW9uKCBmbiApIHsKCQkJaWYgKGZuKSB7CgkJCQlvbkFkZE9yVXBkYXRlSGFuZGxlcnMucHVzaCggZm4gKTsKCQkJCXJldHVybiB0aGlzOwoJCQl9IGVsc2UgewoJCQkJcmV0dXJuIG9uQWRkT3JVcGRhdGVIYW5kbGVyczsKCQkJfQoJCX0sCgoJCW9uRGVsZXRlTm9kZTogZnVuY3Rpb24oIGZuICkgewoJCQlpZiAoZm4pIHsKCQkJCW9uRGVsZXRlSGFuZGxlcnMucHVzaCggZm4gKTsKCQkJCXJldHVybiB0aGlzOwoJCQl9IGVsc2UgewoJCQkJcmV0dXJuIG9uRGVsZXRlSGFuZGxlcnM7CgkJCX0KCQl9LAoKCQkvL3VzZSB0aGlzIGZvciBjb25maWd1cmUgb3B0aW9ucwoJCW9wdGlvbnM6IGRlZmF1bHRPcHRpb25zCgl9ICk7CgoJdmFyIG9uRGVsZXRlSGFuZGxlcnMgPSBbCgkJZnVuY3Rpb24gLypyZW1vdmVNb2RlbExpbmtzQW5kU2hhZG93cyovICggcGh5c2ljYWxQYXRoLCByZW1vdmVkVmFsdWUgKSB7CgoJCQl2YXIgd2F0Y2hlZFBhdGgsCgkJCQltYWluUGF0aCwKCQkJCXBoeXNpY2FsUGF0aE9mU2hhZG93LAoJCQkJbG9naWNhbFNoYWRvd1BhdGgsCgkJCQlsb2dpY2FsUGF0aCA9IHRvTG9naWNhbFBhdGgoIHBoeXNpY2FsUGF0aCApOwoKCQkJLy9yZW1vdmUgbW9kZWxMaW5rcyB3aG9zZSBwdWJsaXNoZXJQYXRoID09IHBoeXNpY2FsUGF0aAoJCQlmb3IgKHdhdGNoZWRQYXRoIGluIHdhdGNoVGFibGUpIHsKCQkJCXVud2F0Y2goIHBoeXNpY2FsUGF0aCwgd2F0Y2hlZFBhdGggKTsKCQkJfQoKCQkJLy9yZW1vdmUgbW9kZWxMaW5rcyB3aG9zZSBzdWJzY3JpYmVyID09IHBoeXNpY2FsUGF0aAoJCQlmb3IgKHdhdGNoZWRQYXRoIGluIHdhdGNoVGFibGUpIHsKCQkJCWlmICh3YXRjaGVkUGF0aC5zdGFydHNXaXRoKCBwaHlzaWNhbFBhdGggKSkgewoJCQkJCWRlbGV0ZSB3YXRjaFRhYmxlW3dhdGNoZWRQYXRoXTsKCQkJCX0KCQkJfQoKCQkJLy9kZWxldGUgc2hhZG93IG9iamVjdHMsCgkJCS8vIHdoaWNoIGFyZSB1bmRlciB0aGUgZGlyZWN0IHNoYWRvdyBvZiBtYWluIHBhdGgKCQkJZm9yIChtYWluUGF0aCBpbiBzaGFkb3dSb290KSB7CgoJCQkJcGh5c2ljYWxQYXRoT2ZTaGFkb3cgPSBzaGFkb3dOYW1lc3BhY2UgKyAiLiIgKyBtYWluUGF0aDsKCQkJCWxvZ2ljYWxTaGFkb3dQYXRoID0gdG9Mb2dpY2FsUGF0aCggcGh5c2ljYWxQYXRoT2ZTaGFkb3cgKTsKCgkJCQlpZiAobG9naWNhbFNoYWRvd1BhdGggPT0gbG9naWNhbFBhdGggfHwKCQkJCSAgICBsb2dpY2FsU2hhZG93UGF0aC5zdGFydHNXaXRoKCBsb2dpY2FsUGF0aCArICIqIiApIHx8CgkJCQkgICAgbG9naWNhbFNoYWRvd1BhdGguc3RhcnRzV2l0aCggbG9naWNhbFBhdGggKyAiLiIgKSkgewoJCQkJCXJvb3ROb2RlLmRlbCggcGh5c2ljYWxQYXRoT2ZTaGFkb3cgKTsKCQkJCX0KCQkJfQoJCX0KCV07CgoJJCggImdldCxzZXQsZGVsLGV4dGVuZCIuc3BsaXQoICIsIiApICkuZWFjaCggZnVuY3Rpb24oIGluZGV4LCB2YWx1ZSApIHsKCQlobVt2YWx1ZV0gPSBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHJvb3ROb2RlW3ZhbHVlXS5hcHBseSggcm9vdE5vZGUsIHNsaWNlLmNhbGwoIGFyZ3VtZW50cyApICk7CgkJfTsKCX0gKTsKCglyb290Tm9kZSA9IGhtKCk7CgoJJGZuLmhtRGF0YSA9IGZ1bmN0aW9uKCBuYW1lLCB2YWx1ZSApIHsKCgkJdmFyIGRhdGEgPSB0aGlzLmRhdGEoICJobURhdGEiICk7CgoJCWlmIChhcmd1bWVudHMubGVuZ3RoID09PSAwKSB7CgoJCQlyZXR1cm4gZGF0YTsKCgkJfSBlbHNlIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAxKSB7CgoJCQlyZXR1cm4gZGF0YSAmJiBkYXRhW25hbWVdOwoKCQl9IGVsc2UgewoJCQkvL2FyZ3VtZW50cy5sZW5ndGggPT0gMgoJCQlpZiAoaXNVbmRlZmluZWQoIGRhdGEgKSkgewoJCQkJdGhpcy5kYXRhKCAiaG1EYXRhIiwgZGF0YSA9IHt9ICk7CgkJCX0KCQkJZGF0YVtuYW1lXSA9IHZhbHVlOwoJCX0KCX07CgoJLyoJcGF0aHNXYXRjaGluZzogZnVuY3Rpb24oKSB7CgkgdmFyIGtleSwgbGlua3MsIHJ0biA9IFtdLCBwYXRoID0gdGhpcy5wYXRoOwoJIGZvciAoa2V5IGluIG1vZGVsTGlua3MpIHsKCSBsaW5rcyA9IG1vZGVsTGlua3Nba2V5XTsKCSBpZiAobGlua3MuY29udGFpbnMoIHBhdGggKSkgewoJIHJ0bi5wdXNoKCBrZXkgKTsKCSB9CgkgfQoJIHJldHVybiBydG47CgkgfSwKCgkgLCovCgoJLy8jZGVidWcKCglobS5kZWJ1Zy53YXRjaGluZ1BhdGhzID0gZnVuY3Rpb24gbWUoIHdhdGNoZWRQYXRoLCBkZWVwICkgewoJCXZhciBydG4gPSB3YXRjaFRhYmxlW3dhdGNoZWRQYXRoXSB8fCBbXTsKCQlpZiAoZGVlcCkgewoJCQlmb3IgKHZhciBpID0gMDsgaSA8IHJ0bi5sZW5ndGg7IGkrKykgewoJCQkJcnRuLm1lcmdlKCBtZSggcnRuW2ldLCBkZWVwICkgKTsKCQkJfQoJCX0KCQlyZXR1cm4gcnRuOwoJfTsKCglobS5kZWJ1Zy53YXRjaGVkUGF0aHMgPSBmdW5jdGlvbiggd2F0Y2hpbmdQYXRoICkgewoJCXZhciBrZXksIGxpbmtzLCBydG4gPSBbXTsKCQlmb3IgKGtleSBpbiB3YXRjaFRhYmxlKSB7CgkJCWxpbmtzID0gd2F0Y2hUYWJsZVtrZXldOwoJCQlpZiAobGlua3MuY29udGFpbnMoIHdhdGNoaW5nUGF0aCApKSB7CgkJCQlydG4ucHVzaCgga2V5ICk7CgkJCX0KCQl9CgkJcmV0dXJuIHJ0bjsKCX07CgoJaG0uZGVidWcuc2hhZG93TmFtZXNwYWNlID0gc2hhZG93TmFtZXNwYWNlOwoJaG0uZGVidWcuZXh0cmFjdFdhdGNoZWRQYXRocyA9IGV4dHJhY3RXYXRjaGVkUGF0aHM7CglobS5kZWJ1Zy5yZW1vdmVBbGwgPSBmdW5jdGlvbigpIHsKCQlmb3IgKHZhciBrZXkgaW4gcmVwb3NpdG9yeSkgewoJCQlpZiAoa2V5ICE9PSBzaGFkb3dOYW1lc3BhY2UpIHsKCQkJCXJvb3ROb2RlLmRlbCgga2V5LCB0cnVlICk7CgkJCX0KCQl9Cgl9OwoJLy8jZW5kX2RlYnVnCgoKLy88QGRlcGVuZHM+bW9kZWwuanM8L0BkZXBlbmRzPgoKCgoJdmFyIHdvcmtmbG93U3RvcmUsCgkJclNwYWNlcyA9IC9bIF0rLywKCQlyRW5kV2l0aFN0YXJEb3QgPSAvXCpcLiQvLAoJCXJEb3RPclN0YXIgPSAvXC58XCovZywKCS8vck9yaWdpbmFsRXZlbnQgPSAvXiguKz8pKFwuXGQrKT8kLywKCQlzdWJzY3JpcHRpb25NYW5hZ2VyLAoJCXZpZXdJZCA9IDAsCgkJckluaXQgPSAvaW5pdChcZCopLywKCQl3b3JrZmxvdywKCS8vdGhlIGhhbmRsZXIgc3RyaW5nIHNob3VsZCBiZSBsaWtlCgkvLyAiZ2V0IHNldCBjb252ZXJ0IGZpbmFsaXplIGluaXRpYWxpemUiCgkJYWN0aXZpdHlUeXBlcyA9ICJnZXQsc2V0LGNvbnZlcnQsZmluYWxpemUsaW5pdGlhbGl6ZSIuc3BsaXQoICIsIiApOwoKCWZ1bmN0aW9uIHJldHVybkZhbHNlKCkgewoJCXJldHVybiBmYWxzZTsKCX0KCglmdW5jdGlvbiByZXR1cm5UcnVlKCkgewoJCXJldHVybiB0cnVlOwoJfQoKCWZ1bmN0aW9uIEV2ZW50KCBwdWJsaXNoZXIsIG9yaWdpbmFsUHVibGlzaGVyLCBldmVudFR5cGUsIHByb3Bvc2VkLCByZW1vdmVkICkgewoJCXRoaXMucHVibGlzaGVyID0gdHJ5V3JhcFB1Ymxpc2hlclN1YnNjcmliZXIoIHB1Ymxpc2hlciApOwoJCXRoaXMub3JpZ2luYWxQdWJsaXNoZXIgPSB0cnlXcmFwUHVibGlzaGVyU3Vic2NyaWJlciggb3JpZ2luYWxQdWJsaXNoZXIgKTsKCQl0aGlzLnR5cGUgPSBldmVudFR5cGU7CgkJdGhpcy5vcmlnaW5hbFR5cGUgPSBldmVudFR5cGU7CgkJdGhpcy5wcm9wb3NlZCA9IHByb3Bvc2VkOwoJCXRoaXMucmVtb3ZlZCA9IHJlbW92ZWQ7Cgl9CgoJRXZlbnQucHJvdG90eXBlID0gewoJCWNvbnN0cnVjdG9yOiBFdmVudCwKCgkJLyoJaXNPcmlnaW5hbDogZnVuY3Rpb24oKSB7CgkJIHJldHVybiB0aGlzLnB1Ymxpc2hlci5wYXRoID09IHRoaXMub3JpZ2luYWxQdWJsaXNoZXIucGF0aDsKCQkgfSwKCgkJIGlzQnViYmxlVXA6IGZ1bmN0aW9uKCkgewoJCSByZXR1cm4gKHRoaXMucHVibGlzaGVyLnBhdGggIT0gdGhpcy5vcmlnaW5hbFB1Ymxpc2hlci5wYXRoKSAmJgoJCSAodGhpcy5wdWJsaXNoZXIucGF0aC5zdGFydHNXaXRoKCB0aGlzLm9yaWdpbmFsUHVibGlzaGVyLnBhdGggKSk7CgkJIH0sKi8KCQlpc0RlcGVuZGVudDogZnVuY3Rpb24oKSB7CgkJCXJldHVybiAoIXRoaXMucHVibGlzaGVyLnBhdGguc3RhcnRzV2l0aCggdGhpcy5vcmlnaW5hbFB1Ymxpc2hlci5wYXRoICkpOwoJCX0sCgoJCXN0b3BQcm9wYWdhdGlvbjogZnVuY3Rpb24oKSB7CgkJCXRoaXMuaXNQcm9wYWdhdGlvblN0b3BwZWQgPSByZXR1cm5UcnVlOwoJCX0sCgoJCXN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbjogZnVuY3Rpb24oKSB7CgkJCXRoaXMuaXNJbW1lZGlhdGVQcm9wYWdhdGlvblN0b3BwZWQgPSByZXR1cm5UcnVlOwoJCQl0aGlzLmlzUHJvcGFnYXRpb25TdG9wcGVkID0gcmV0dXJuVHJ1ZTsKCQkJdGhpcy5pc0Nhc2NhZGVTdG9wcGVkID0gcmV0dXJuVHJ1ZTsKCQl9LAoKCQlzdG9wQ2FzY2FkZTogZnVuY3Rpb24oKSB7CgkJCXRoaXMuaXNDYXNjYWRlU3RvcHBlZCA9IHJldHVyblRydWU7CgkJfSwKCgkJZXJyb3I6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLmhhc0Vycm9yID0gcmV0dXJuVHJ1ZTsKCQl9LAoKCQlhYm9ydDogYWJvcnQsCgkJaXNDYXNjYWRlU3RvcHBlZDogcmV0dXJuRmFsc2UsCgkJaXNQcm9wYWdhdGlvblN0b3BwZWQ6IHJldHVybkZhbHNlLAoJCWlzSW1tZWRpYXRlUHJvcGFnYXRpb25TdG9wcGVkOiByZXR1cm5GYWxzZSwKCQlpc0Fib3J0ZWQ6IHJldHVybkZhbHNlLAoJCWhhc0Vycm9yOiByZXR1cm5GYWxzZSwKCQlsZXZlbDogMAoJfTsKCgkvLyByYWlzZSBtb2RlbCBldmVudCwKCXRyaWdnZXIgPSBmdW5jdGlvbiggcGF0aCwgb3JpZ2luYWxQYXRoLCBldmVudFR5cGUsIHByb3Bvc2VkLCByZW1vdmVkICkgewoKCQl2YXIgZSA9IG5ldyBFdmVudCggcGF0aCwgb3JpZ2luYWxQYXRoLCBldmVudFR5cGUsIHByb3Bvc2VkLCByZW1vdmVkICk7CgoJCS8vZXZlbnQgY2FuIGJlIGNoYW5nZWQgaW5zaWRlIHRoZSBmdW5jdGlvbgoJCWNhbGxiYWNrTW9kZWxTdWJzY3JpcHRpb25IYW5kbGVyKCBlICk7CgoJCWlmICghZS5pc1Byb3BhZ2F0aW9uU3RvcHBlZCgpICYmIGUucHVibGlzaGVyLnBhdGgpIHsKCgkJCWlmIChlLmlzRGVwZW5kZW50KCkpIHsKCQkJCS8vaWYgaXMgZGVwZW5kZW50IGV2ZW50LCB0aGUgb3JpZ2luYWwgZXZlbnQgaGFzIGJlZW4KCQkJCS8vIGJ1YmJsZWQgdXAgaW4gaXRzIGRpcmVjdCBoaWVyYXJjaHkKCQkJCS8vd2UgbmVlZCB0byBjaGFuZ2UgdGhlIGhpZXJhcmNoeSBieSBzZXR0aW5nIHRoZSB0YXJnZXQKCQkJCWUub3JpZ2luYWxQdWJsaXNoZXIucGF0aCA9IGUucHVibGlzaGVyLnBhdGg7CgkJCX0KCgkJCS8vY29udGludWUgdG8gdGhlIHNhbWUgaW5zdGFuY2Ugb2YgZXZlbnQgb2JqZWN0CgkJCWRvIHsKCgkJCQllLnB1Ymxpc2hlci5wYXRoID0gZS5wdWJsaXNoZXIucGF0aENvbnRleHQoKTsKCQkJCWUubGV2ZWwrKzsKCQkJCWUudHlwZSA9IGUub3JpZ2luYWxUeXBlICsgIi4iICsgZS5sZXZlbDsKCQkJCWNhbGxiYWNrTW9kZWxTdWJzY3JpcHRpb25IYW5kbGVyKCBlICk7CgoJCQl9IHdoaWxlICghZS5pc1Byb3BhZ2F0aW9uU3RvcHBlZCgpICYmIGUucHVibGlzaGVyLnBhdGgpOwoJCX0KCgkJLy9yZXN0b3JlIHByZXZpb3VzIHZhbHVlcwoJCWUudHlwZSA9IGV2ZW50VHlwZTsKCQllLm9yaWdpbmFsUHVibGlzaGVyLnBhdGggPSBvcmlnaW5hbFBhdGg7CgkJZS5wdWJsaXNoZXIucGF0aCA9IHBhdGg7CgkJcmV0dXJuIGU7Cgl9OwoKCglzdWJzY3JpcHRpb25NYW5hZ2VyID0gKGZ1bmN0aW9uKCkgewoKCQl2YXIgc3Vic2NyaXB0aW9uU3RvcmUgPSBbIF07CgoJCS8vdGFyZ2V0IGlzIGVpdGhlciBwdWJsaXNoZXIgb3Igc3Vic2NyaWJlcgoJCWZ1bmN0aW9uIGNhblJlbW92ZVN1YnNjcmlwdGlvbkRhdGEoIHRhcmdldCwgcHVibGlzaGVyLCBzdWJzY3JpYmVyICkgewoJCQlpZiAodGFyZ2V0ID09PSBwdWJsaXNoZXIgfHwgdGFyZ2V0ID09PSBzdWJzY3JpYmVyKSB7CgkJCQlyZXR1cm4gdHJ1ZTsKCQkJfSBlbHNlIHsKCQkJCS8vaWYgdGFyZ2V0IGlzIG1vZGVsIHBhdGgKCQkJCWlmIChpc1N0cmluZyggdGFyZ2V0ICkpIHsKCQkJCQlyZXR1cm4gKCBpc1N0cmluZyggcHVibGlzaGVyICkgJiYgcHVibGlzaGVyLnN0YXJ0c1dpdGgoIHRhcmdldCArICIuIiApKSB8fAoJCQkJCSAgICAgICAoIGlzU3RyaW5nKCBzdWJzY3JpYmVyICkgJiYgc3Vic2NyaWJlci5zdGFydHNXaXRoKCB0YXJnZXQgKyAiLiIgKSk7CgkJCQl9IGVsc2UgewoJCQkJCXJldHVybiBmYWxzZTsKCQkJCX0KCQkJfQoKCQl9CgoJCWZ1bmN0aW9uIGdldFN1YnNjcmlwdGlvbnNCeSggdGFyZ2V0LCBtYXRjaCApIHsKCQkJaWYgKGlzU3RyaW5nKCB0YXJnZXQgKSkgewoJCQkJdGFyZ2V0ID0gdG9QaHlzaWNhbFBhdGgoIHRhcmdldCApOwoJCQl9CgoJCQl2YXIgcnRuID0gW107CgkJCWZvciAodmFyIGkgPSAwLCBpdGVtOyBpIDwgc3Vic2NyaXB0aW9uU3RvcmUubGVuZ3RoOyBpKyspIHsKCQkJCWl0ZW0gPSBzdWJzY3JpcHRpb25TdG9yZVtpXTsKCQkJCWlmIChtYXRjaCggaXRlbSwgdGFyZ2V0ICkpIHsKCQkJCQlydG4ucHVzaCggaXRlbSApOwoJCQkJfQoJCQl9CgkJCXJldHVybiBydG47CgkJfQoKCQlyZXR1cm4gewoKCQkJLy9zdWJzY3JpcHRpb25zIHdob3NlIHB1Ymxpc2hlciBpcyB0aGUgcGFyYW1ldGVyCgkJCS8vcHVibGlzaGVyIGNhbiBiZSBhIG1vZGVsIHBhdGggb3IgZG9tIGVsZW1lbnQsIG9yIG9iamVjdAoJCQlnZXRCeVB1Ymxpc2hlcjogZnVuY3Rpb24oIHB1Ymxpc2hlciApIHsKCQkJCXJldHVybiBnZXRTdWJzY3JpcHRpb25zQnkoIHB1Ymxpc2hlciwgZnVuY3Rpb24oIGl0ZW0sIHRhcmdldCApIHsKCQkJCQlyZXR1cm4gaXRlbS5wdWJsaXNoZXIgPT0gdGFyZ2V0OwoJCQkJfSApOwoJCQl9LAoKCQkJLy9zdWJzY3JpcHRpb25zIHdob3NlIHN1YnNjcmliZXIgaXMgdGhlIHBhcmFtZXRlcgoJCQkvL3N1YnNjcmliZXIgY2FuIGJlIGEgbW9kZWwgcGF0aCBvciBkb20gZWxlbWVudCwgb3Igb2JqZWN0CgkJCWdldEJ5U3Vic2NyaWJlcjogZnVuY3Rpb24oIHN1YnNjcmliZXIgKSB7CgkJCQlyZXR1cm4gZ2V0U3Vic2NyaXB0aW9uc0J5KCBzdWJzY3JpYmVyLCBmdW5jdGlvbiggaXRlbSwgdGFyZ2V0ICkgewoJCQkJCXJldHVybiBpdGVtLnN1YnNjcmliZXIgPT0gdGFyZ2V0OwoJCQkJfSApOwoJCQl9LAoKCQkJLy9vYmplY3QgY2FuIGJlIGEgbW9kZWwgcGF0aCBvciBkb20gZWxlbWVudCwgb3Igb2JqZWN0CgkJCWdldEJ5OiBmdW5jdGlvbiggc3Vic2NyaWJlck9yUHVibGlzaGVyICkgewoJCQkJcmV0dXJuIGdldFN1YnNjcmlwdGlvbnNCeSggc3Vic2NyaWJlck9yUHVibGlzaGVyLCBmdW5jdGlvbiBtYXRjaCggaXRlbSwgdGFyZ2V0ICkgewoJCQkJCXJldHVybiBpdGVtLnN1YnNjcmliZXIgPT0gdGFyZ2V0IHx8IGl0ZW0ucHVibGlzaGVyID09IHRhcmdldDsKCQkJCX0gKTsKCQkJfSwKCgkJCWdldEFsbDogZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gc3Vic2NyaXB0aW9uU3RvcmU7CgkJCX0sCgoJCQlhZGQ6IGZ1bmN0aW9uKCBzdWJzY3JpYmVyLCBwdWJsaXNoZXIsIGV2ZW50VHlwZXMsIGhhbmRsZXIgKSB7CgkJCQlpZiAoaXNTdHJpbmcoIHB1Ymxpc2hlciApKSB7CgoJCQkJCXZhciBldmVudHMgPSBldmVudFR5cGVzLnNwbGl0KCByU3BhY2VzICk7CgkJCQkJZm9yICh2YXIgaSA9IDA7IGkgPCBldmVudHMubGVuZ3RoOyBpKyspIHsKCQkJCQkJdmFyIHNwZWNpYWwgPSB0aGlzLnNwZWNpYWxbZXZlbnRzW2ldXTsKCQkJCQkJc3BlY2lhbCAmJiBzcGVjaWFsLnNldHVwICYmIHNwZWNpYWwuc2V0dXAoIHN1YnNjcmliZXIsIHB1Ymxpc2hlciApOwoJCQkJCX0KCQkJCX0KCgkJCQlzdWJzY3JpcHRpb25TdG9yZS5wdXNoKCB7CgkJCQkJcHVibGlzaGVyOiBwdWJsaXNoZXIsCgkJCQkJc3Vic2NyaWJlcjogc3Vic2NyaWJlciwKCQkJCQlldmVudFR5cGVzOiBldmVudFR5cGVzLAoJCQkJCWhhbmRsZXI6IGhhbmRsZXIKCQkJCX0gKTsKCQkJfSwKCgkJCXJlbW92ZUJ5OiBmdW5jdGlvbiggc3Vic2NyaWJlck9yUHVibGlzaGVyICkgewoKCQkJCXZhciBpLAoJCQkJCWosCgkJCQkJc3BlY2lhbCwKCQkJCQlzdWJzY3JpcHRpb24sCgkJCQkJaGFuZGxlciwKCQkJCQlzdWJzY3JpcHRpb25zUmVtb3ZlZCA9IFtdOwoKCQkJCWZvciAoaSA9IHN1YnNjcmlwdGlvblN0b3JlLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CgkJCQkJc3Vic2NyaXB0aW9uID0gc3Vic2NyaXB0aW9uU3RvcmVbaV07CgkJCQkJaGFuZGxlciA9IHN1YnNjcmlwdGlvbi5oYW5kbGVyOwoKCQkJCQlpZiAoY2FuUmVtb3ZlU3Vic2NyaXB0aW9uRGF0YSggc3Vic2NyaWJlck9yUHVibGlzaGVyLCBzdWJzY3JpcHRpb24ucHVibGlzaGVyLCBzdWJzY3JpcHRpb24uc3Vic2NyaWJlciApKSB7CgoJCQkJCQkvL2lmIHB1Ymxpc2hlciBpcyBhbiB2aWV3IG9iamVjdCwgbmVlZCB0byB1bmJpbmQgb3IgdW5kZWxlZ2F0ZQoJCQkJCQkvL3RoZSBqUXVlcnkgZXZlbnQgaGFuZGxlcgoJCQkJCQlpZiAoIWlzU3RyaW5nKCBzdWJzY3JpcHRpb24ucHVibGlzaGVyICkpIHsKCQkJCQkJCWlmIChoYW5kbGVyLmRlbGVnYXRlU2VsZWN0b3IpIHsKCQkJCQkJCQkkKCBzdWJzY3JpcHRpb24ucHVibGlzaGVyICkudW5kZWxlZ2F0ZSggaGFuZGxlci5kZWxlZ2F0ZVNlbGVjdG9yLCBzdWJzY3JpcHRpb24uZXZlbnRUeXBlcywgdmlld0hhbmRsZXJHYXRld2F5ICk7CgoJCQkJCQkJfSBlbHNlIHsKCQkJCQkJCQkkKCBzdWJzY3JpcHRpb24ucHVibGlzaGVyICkudW5iaW5kKCBzdWJzY3JpcHRpb24uZXZlbnRUeXBlcywgdmlld0hhbmRsZXJHYXRld2F5ICk7CgkJCQkJCQl9CgkJCQkJCX0KCgkJCQkJCXN1YnNjcmlwdGlvbnNSZW1vdmVkLnB1c2goIHN1YnNjcmlwdGlvblN0b3JlLnNwbGljZSggaSwgMSApWzBdICk7CgkJCQkJfQoJCQkJfQoKCQkJCWZvciAoaSA9IHN1YnNjcmlwdGlvbnNSZW1vdmVkLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CgkJCQkJc3Vic2NyaXB0aW9uID0gc3Vic2NyaXB0aW9uc1JlbW92ZWRbaV07CgkJCQkJaWYgKGlzU3RyaW5nKCBzdWJzY3JpcHRpb24ucHVibGlzaGVyICkpIHsKCQkJCQkJdmFyIGV2ZW50cyA9IHN1YnNjcmlwdGlvbi5ldmVudFR5cGVzLnNwbGl0KCByU3BhY2VzICk7CgkJCQkJCWZvciAoaiA9IDA7IGogPCBldmVudHMubGVuZ3RoOyBqKyspIHsKCQkJCQkJCXNwZWNpYWwgPSB0aGlzLnNwZWNpYWxbZXZlbnRzW2pdXTsKCQkJCQkJCXNwZWNpYWwgJiYgc3BlY2lhbC50ZWFyZG93biAmJiBzcGVjaWFsLnRlYXJkb3duKCBzdWJzY3JpcHRpb24uc3Vic2NyaWJlciwgc3Vic2NyaXB0aW9uLnB1Ymxpc2hlciApOwoJCQkJCQl9CgkJCQkJfQoJCQkJfQoJCQl9LAoKCQkJc3BlY2lhbDogewoJCQkJLyp2YWxpZGl0eUNoYW5nZWQ6IHsKCQkJCSBzZXR1cDogZnVuY3Rpb24gKHB1Ymxpc2hlciwgc3Vic2NyaWJlcikge30sCgkJCQkgdGVhcmRvd246IGZ1bmN0aW9uIChwdWJsaXNoZXIsIHN1YnNjcmliZXIpIHt9CgkJCQkgfQoJCQkJICovCgkJCX0KCgkJfTsKCX0pKCk7CgoJZnVuY3Rpb24gZ2V0TWVtYmVyKCBlICkgewoKCQl2YXIgaGFuZGxlciA9IGUuaGFuZGxlciwKCQkJcHJvcGVydHlOYW1lID0gaGFuZGxlci5nZXROYW1lLAoJCS8vZ2V0U3ViUHJvcGVydHkgaXMgdXNlZCBmb3IgcHJvcGVydGllcyBsaWtlIGNzcywgYXR0ciwgcHJvcAoJCQlzdWJQcm9wZXJ0eU5hbWUgPSBoYW5kbGVyLmdldFBhcmFzLAoJCQlwdWJsaXNoZXIgPSBlLnB1Ymxpc2hlcjsKCgkJcmV0dXJuIHN1YlByb3BlcnR5TmFtZSA/IHB1Ymxpc2hlcltwcm9wZXJ0eU5hbWVdKCBzdWJQcm9wZXJ0eU5hbWUgKSA6CgkJCWlzRnVuY3Rpb24oIHB1Ymxpc2hlcltwcm9wZXJ0eU5hbWVdICkgPyBwdWJsaXNoZXJbcHJvcGVydHlOYW1lXSgpIDoKCQkJCXB1Ymxpc2hlcltwcm9wZXJ0eU5hbWVdOwoJfQoKCWZ1bmN0aW9uIHNldE1lbWJlciggdmFsdWUsIGUgKSB7CgkJdmFyIGhhbmRsZXIgPSBlLmhhbmRsZXIsCgkJCXByb3BlcnR5TmFtZSA9IGhhbmRsZXIuc2V0TmFtZSwKCQkvL3NldFN1YlByb3BlcnR5IGlzIHVzZWQgZm9yIHByb3BlcnRpZXMgbGlrZSBjc3MsIGF0dHIsIHByb3AKCQkJc3ViUHJvcGVydHlOYW1lID0gaGFuZGxlci5zZXRQYXJhcywKCQkJc3Vic2NyaWJlciA9IHRoaXM7CgoJCXN1YlByb3BlcnR5TmFtZSA/IHN1YnNjcmliZXJbcHJvcGVydHlOYW1lXSggc3ViUHJvcGVydHlOYW1lLCB2YWx1ZSApIDoKCQkJaXNGdW5jdGlvbiggc3Vic2NyaWJlcltwcm9wZXJ0eU5hbWVdICkgPyBzdWJzY3JpYmVyW3Byb3BlcnR5TmFtZV0oIHZhbHVlICkgOgoJCQkJc3Vic2NyaWJlcltwcm9wZXJ0eU5hbWVdID0gdmFsdWU7Cgl9CgoJZXh0ZW5kKCBobSwgewoKCQkvL0V2ZW50OiBFdmVudCwKCgkJdHJpZ2dlcjogdHJpZ2dlciwKCgkJc3Vic2NyaXB0aW9uOiBzdWJzY3JpcHRpb25NYW5hZ2VyLAoKCQkvL2hhbmRsZXIgY2FuIGJlIGEgZnVuY3Rpb24gKGUpIHt9CgkJLy8gYSBzdHJpbmcgbGlrZSAiZ2V0IHNldCBjb252ZXJ0IGludCIKCQkvL29yICIqZ2V0ICpzZXQgKmNvbnZlcnQgKmludCIKCQkvL29yIGl0IGNhbiBiZSAiKmNvbW1vbkhhbmRsZXIiCgkJLy9vciBpdCBjYW4gYmUgeyBnZXQ6eHgsIHNldDp4eCwgY29udmVydDp4eCwgaW5pdGlhbGl6ZTogeHh9CgkJLy9pdCBjYW4gYmUgYSBqYXZhc2NyaXB0IG9iamVjdCwgZG9tIGVsZW1lbnQsIGJ1dCBpdCBjYW4gbm90IGJlIGEgalF1ZXJ5IG9iamVjdAoJCS8vc3Vic2NyaWJlciBjYW4gYmUgbnVsbCwgIl8iLCAibnVsbCIsIHVuZGVmaW5lZCB0byByZXByZXNlbnQgYSBjYXNlIHdoZXJlIHRoZXJlIGlzIG5vdCBzdWJzY3JpYmVyCgkJLy9pZiBzdWJzY3JpYmVyIGlzICIiLCBpdCBtZWFucyB0aGUgdGhlIHJvb3QgbW9kZWwsIHRoZSByZXBvc2l0b3J5IG9iamVjdAoJCXN1YjogZnVuY3Rpb24oIHN1YnNjcmliZXIsIHB1Ymxpc2hlciwgZXZlbnRUeXBlcywgd29ya2Zsb3csIHdvcmtmbG93T3B0aW9ucywgZGVsZWdhdGVTZWxlY3RvciApIHsKCgkJCWlmIChzdWJzY3JpYmVyIGluc3RhbmNlb2YgaG0pIHsKCQkJCXN1YnNjcmliZXIgPSBzdWJzY3JpYmVyLnBhdGg7CgkJCX0KCgkJCWlmIChwdWJsaXNoZXIgaW5zdGFuY2VvZiBobSkgewoJCQkJcHVibGlzaGVyID0gcHVibGlzaGVyLnBhdGg7CgkJCX0KCgkJCWlmIChpc1N0cmluZyggc3Vic2NyaWJlciApICYmIHN1YnNjcmliZXIuc3RhcnRzV2l0aCggIiQiICkpIHsKCQkJCXN1YnNjcmliZXIgPSAkKCBzdWJzY3JpYmVyLnN1YnN0ciggMSApICk7CgkJCX0KCgkJCWlmIChzdWJzY3JpYmVyICYmIHN1YnNjcmliZXIuanF1ZXJ5KSB7CgkJCQkvL3N1YnNjcmliZXIgaXMgbGlrZSAkKCkKCQkJCS8vbmVlZCB0byBjb252ZXJ0IGpRdWVyeSBvYmplY3QgaW50byBkb20gb3IgcmF3IGVsZW1lbnQKCQkJCWlmICghc3Vic2NyaWJlci5sZW5ndGggJiYgIXN1YnNjcmliZXIuc2VsZWN0b3IpIHsKCQkJCQlzdWJzY3JpYmVyID0gbnVsbDsKCQkJCX0gZWxzZSB7CgkJCQkJc3Vic2NyaWJlci5lYWNoKCBmdW5jdGlvbiggaW5kZXgsIGVsZW1lbnQgKSB7CgkJCQkJCS8vdW53cmFwIGpRdWVyeSBlbGVtZW50CgkJCQkJCWhtLnN1YiggZWxlbWVudCwgcHVibGlzaGVyLCBldmVudFR5cGVzLCB3b3JrZmxvdywgd29ya2Zsb3dPcHRpb25zLCBkZWxlZ2F0ZVNlbGVjdG9yICk7CgkJCQkJfSApOwoJCQkJCXJldHVybjsKCQkJCX0KCQkJfQoKCQkJaWYgKGlzU3RyaW5nKCBwdWJsaXNoZXIgKSAmJiBwdWJsaXNoZXIuc3RhcnRzV2l0aCggIiQiICkpIHsKCQkJCXB1Ymxpc2hlciA9ICQoIHB1Ymxpc2hlci5zdWJzdHIoIDEgKSApOwoJCQl9CgoJCQlpZiAocHVibGlzaGVyICYmIHB1Ymxpc2hlci5qcXVlcnkpIHsKCQkJCXB1Ymxpc2hlci5lYWNoKCBmdW5jdGlvbiggaW5kZXgsIGVsZW1lbnQgKSB7CgkJCQkJaG0uc3ViKCBzdWJzY3JpYmVyLCBlbGVtZW50LCBldmVudFR5cGVzLCB3b3JrZmxvdywgd29ya2Zsb3dPcHRpb25zLCBkZWxlZ2F0ZVNlbGVjdG9yICk7CgkJCQl9ICk7CgkJCQlyZXR1cm47CgkJCX0KCgkJCWlmICghcHVibGlzaGVyICYmIHB1Ymxpc2hlciAhPT0gIiIpIHsKCQkJCXRocm93ICJwdWJsaXNoZXIgY2FuIG5vdCBiZSBudWxsIjsKCQkJfQoKCQkJaWYgKCFldmVudFR5cGVzKSB7CgkJCQl0aHJvdyAiZXZlbnRUeXBlcyBjYW4gbm90IGJlIG51bGwiOwoJCQl9CgoJCQkvL2FsbG93IHN1YnNjcmliZXIgIiIsIGJlY2F1c2UgdGhpcyBpcyB0aGUgcGF0aCBvZiByb290IG1vZGVsCgkJCWlmIChzdWJzY3JpYmVyID09PSAiXyIgfHwgc3Vic2NyaWJlciA9PSAibnVsbCIgfHwgc3Vic2NyaWJlciA9PT0gbnVsbCkgewoJCQkJc3Vic2NyaWJlciA9IHVuZGVmaW5lZDsKCQkJfQoKCQkJaWYgKHdvcmtmbG93T3B0aW9ucyA9PT0gIl8iKSB7CgkJCQl3b3JrZmxvd09wdGlvbnMgPSB1bmRlZmluZWQ7CgkJCX0KCgkJCXZhciBpc1B1Ymxpc2hlck1vZGVsID0gaXNTdHJpbmcoIHB1Ymxpc2hlciApLAoJCQkJaXNTdWJzY3JpYmVyTW9kZWwgPSBpc1N0cmluZyggc3Vic2NyaWJlciApOwoKCQkJdmlld0lkTWFuYWdlci5tYXJrKCBwdWJsaXNoZXIgKTsKCQkJdmlld0lkTWFuYWdlci5tYXJrKCBzdWJzY3JpYmVyICk7CgoJCQlpZiAoaXNQdWJsaXNoZXJNb2RlbCkgewoJCQkJLy9zdWJzY3JpYmVyIGlzIGEgbW9kZWwKCQkJCXB1Ymxpc2hlciA9IHRvUGh5c2ljYWxQYXRoKCBwdWJsaXNoZXIgKTsKCQkJfQoKCQkJaWYgKGlzU3Vic2NyaWJlck1vZGVsKSB7CgkJCQkvL3N1YnNjcmliZXIgaXMgYSBtb2RlbAoJCQkJc3Vic2NyaWJlciA9IHRvUGh5c2ljYWxQYXRoKCBzdWJzY3JpYmVyICk7CgoJCQl9CgoJCQlpZiAoaXNQdWJsaXNoZXJNb2RlbCkgewoKCQkJCXN1YnNjcmliZU1vZGVsRXZlbnQoIHB1Ymxpc2hlciwgZXZlbnRUeXBlcywgc3Vic2NyaWJlciwgd29ya2Zsb3csIHdvcmtmbG93T3B0aW9ucyApOwoKCQkJfSBlbHNlIHsKCgkJCQlzdWJzY3JpYmVWaWV3RXZlbnQoIHB1Ymxpc2hlciwgZXZlbnRUeXBlcywgc3Vic2NyaWJlciwgd29ya2Zsb3csIHdvcmtmbG93T3B0aW9ucywgZGVsZWdhdGVTZWxlY3RvciApOwoJCQl9CgkJfSwKCgkJaGFuZGxlOiBmdW5jdGlvbiggLyogcHVibGlzaGVyLCBldmVudFR5cGVzLCB3b3JrZmxvdywgd29ya2Zsb3dPcHRpb25zLCBkZWxlZ2F0ZVNlbGVjdG9yICovICkgewoJCQlyZXR1cm4gdGhpcy5zdWIuYXBwbHkoIHRoaXMsIFtudWxsXS5jb25jYXQoIHNsaWNlLmNhbGwoIGFyZ3VtZW50cyApICkgKTsKCQl9LAoKCQkvL2Egd29ya2Zsb3dQcm90b3R5cGUgY2FuIGJlIGEgc3RyaW5nIGxpa2UgImdldCBzZXQgY29udmVydCBpbml0aWFsaXplIGZpbmFsaXplIgoJCS8vIG9yIGl0IGNhbiBiZSBhbiBvYmplY3QKCQkvKgoJCSB7CgkJIGdldDogInh4IiBvciBmdW5jdGlvbiAoKSB7fSwKCQkgc2V0OiAieHgiIG9yIGZ1bmN0aW9uICgpIHt9LAoJCSBjb252ZXJ0OiAieHgiIG9yIGZ1bmN0aW9uICgpIHt9LAoJCSBpbml0aWFsaXplOiAieHgiIG9yIGZ1bmN0aW9uICgpIHt9LAoJCSBmaW5hbGl6ZTogInh4IiBvciBmdW5jdGlvbiAoKSB7fQoJCSB9CgkJICovCgkJd29ya2Zsb3c6IHdvcmtmbG93ID0gZnVuY3Rpb24oIG5hbWUsIHdvcmtmbG93UHJvdG90eXBlICkgewoKCQkJaWYgKGlzT2JqZWN0KCBuYW1lICkpIHsKCQkJCWZvciAodmFyIGtleSBpbiBuYW1lKSB7CgkJCQkJd29ya2Zsb3dTdG9yZVtrZXldID0gYnVpbGRXb3JrZmxvdyggbmFtZVtrZXldICk7CgkJCQl9CgkJCQlyZXR1cm47CgkJCX0KCgkJCWlmIChpc1VuZGVmaW5lZCggbmFtZSApKSB7CgkJCQlyZXR1cm4gd29ya2Zsb3dTdG9yZTsKCQkJfQoKCQkJaWYgKGlzVW5kZWZpbmVkKCB3b3JrZmxvd1Byb3RvdHlwZSApKSB7CgkJCQlyZXR1cm4gd29ya2Zsb3dTdG9yZVtuYW1lXTsKCQkJfQoKCQkJd29ya2Zsb3dTdG9yZVtuYW1lXSA9IGJ1aWxkV29ya2Zsb3coIHdvcmtmbG93UHJvdG90eXBlICk7CgkJCXJldHVybiB3b3JrZmxvd1N0b3JlW25hbWVdOwoKCQl9LAoJCS8vY29tbW9uIGdldHRlciBhbmQgc2V0dGVyIGFyZSBzcGVjaWFsIGFjdGl2aXR5IGluIHRoZXkgd2F5IHRoZXkgYXJlIHVzZWQKCQkvL290aGVyIGFjdGl2aXRpZXMgdXNlIHRoZSBrZXkgZGlyZWN0bHkgdG8gcmVmZXJlbmNlIHRoZSBhY3Rpdml0aWVzCgkJLy8gYnV0IGdldHRlcnMgYW5kIHNldHRlcnMgbmVlZCB0byB1c2UgIiprZXkiIHRvIHJlZmVyZW5jZSBnZXR0ZXJzIGFuZCBzZXR0ZXJzCgkJLy8gaWYgeW91ciBnZXR0ZXIvc2V0dGVyIGtleSBkb2VzIG5vdCBiZWdpbiB3aXRoICIqIiwgdGhlbiBpdCB3aWxsIHVzZSB0aGUgZGVmYXVsdEdldAoJCS8vb3IgZGVmYXVsdFNldCwgYW5kIHRoZXkga2V5IHdpbGwgYmVjb21lIHRoZSBnZXRQcm9wZXJ0eSwgYW5kIG9wdGlvbmFsbHksCgkJLy8gdXNlIG9wdGlvbnMgdG8gcGFzcyB0aGUgZ2V0UHJvcCB2YWx1ZSwgdGhlIGRlZmF1bHRHZXQvZGVmYXVsdFNldAoJCS8vIGFyZSBub3QgbWVhbnQgdG8gYmUgdXNlZCBkaXJlY3RseSBsaWtlIG90aGVyIGNvbW1vbiBnZXR0ZXJzIG9yIHNldHRlcnMKCQlhY3Rpdml0eTogewoKCQkJLy9pbml0aWFsaXplKCBwdWJsaXNoZXIsIHN1YnNjcmliZXIsIGhhbmRsZXIsIHdvcmtmbG93T3B0aW9ucyApOwoJCQkvL2luc2lkZSBpbml0aWFsaXplIGZ1bmN0aW9uLCAndGhpcycgcmVmZXIgdG8gdGhlIHdpbmRvdwoJCQlpbml0aWFsaXplOiB7fSwKCgkJCS8vdmFsdWUgPSBoYW5kbGVyLmdldC5hcHBseSggc3Vic2NyaWJlciwgW2VdLmNvbmNhdCggdHJpZ2dlckRhdGEgKSApOwoJCQkvL2luc2lkZSB0aGUgZ2V0dGVyIGZ1bmN0aW9uLCAndGhpcycgcmVmZXIgdG8gdGhlIHN1YnNjcmliZXIKCQkJLy9nZXQoZSkKCQkJZ2V0OiB7CgkJCQlnZXRNZW1iZXI6IGdldE1lbWJlciwKCgkJCQkvL3RoZSBvcmlnaW5hbCBnZXQgaXMgImdldCIgY3VycmVudAoJCQkJLy9iZWNhdXNlIG9mIGV2ZW50IGJ1YmJsaW5nLCB0aGUgZGVmYXVsdCBnZXQgbWV0aG9kIGZvciBtb2RlbAoJCQkJLy93aWxsIG5vdCByZXR1cm4gdGhlIHZhbHVlIHlvdSB3YW50LCBzbyBuZWVkIHRvIGdldE9yaWdpbmFsCgkJCQlnZXRPcmlnaW5hbDogZnVuY3Rpb24oIGUgKSB7CgkJCQkJcmV0dXJuIGUub3JpZ2luYWxQdWJsaXNoZXIuZ2V0KCk7CgkJCQl9LAoKCQkJCS8vaWYgd2Ugd2FudCB0byBjYWxsIGEgbWVtYmVyICJmb28iIG9mIHB1Ymxpc2hlciBtb2RlbAoJCQkJLy9idXQgd2UgZG9uJ3Qgd2FudCB0byBkbyBhbnl0aGluZyB0byB0aGUgc3Vic2NyaWJlciwgd2UgbWF5IHdhbnQgdG8gdXNlIGV4cHJlc3Npb24KCQkJCS8vIipmYWtlR2V0IGZvbyIKCgkJCQkvLyRjbGljazppdGVtc3wqZWRpdFNoYWRvd0l0ZW0KCQkJCS8vJGNsaWNrOml0ZW1zKnF1ZXJ5UmVzdWx0fCplZGl0U2hhZG93SXRlbQoJCQkJLy93b3JrZmxvdyhoYW5kbGVyKSAtLT5uZXdTaGFkb3dJdGVtOiAiKmZha2VHZXQgbmV3U2hhZG93SXRlbSIsCgkJCQlmYWtlR2V0OiBmdW5jdGlvbigpIHsKCQkJCQlyZXR1cm4gZHVtbXk7CgkJCQl9CgkJCX0sCgoJCQkvL2hhbmRsZXIuc2V0LmNhbGwoIHN1YnNjcmliZXIsIHZhbHVlLCBlICk7CgkJCS8vaW5zaWRlIHNldHRlciBmdW5jdGlvbiAndGhpcycgcmVmZXIgdG8gdGhlIHN1YnNjcmliZXIKCQkJLy9zZXQodmFsdWUsIGUpCgkJCXNldDogewoJCQkJc2V0TWVtYmVyOiBzZXRNZW1iZXIsCgoJCQkJLy9iZWNhdXNlIGhtLmpzIHdhbnQgdG8gc3VwcG9ydCBzaW1wbGlmaWVkIGFjdGl2aXR5IGV4cHJlc3Npb24KCQkJCS8vcnVsZSAxCgkJCQkvLyAidmFsIiwgd2hlbiBwdWJsaXNoZXIgaXMgdmlldywgc3Vic2NyaWJlciBpcyBtb2RlbCwgd2hpY2ggbWVhbnMgInZhbCIgdmlldywKCQkJCS8vInNldCIgbW9kZWwKCQkJCS8vcnVsZSAyCgkJCQkvL29yICJodG1sIiwgd2hlbiBwdWJsaXNoZXIgaXMgbW9kZWwsIHN1YnNjcmliZXIgaXMgdmlldywgd2hpY2ggbWVhbnMgImdldCIgbW9kZWwKCQkJCS8vImh0bWwiIHZpZXcuCgoJCQkJLy9zbyBpZiBwdWJsaXNoZXIgaXMgbW9kZWwsIHN1YnNjcmliZXIgaXMgdmlldy4gV2UganVzdCB3YW50IHRvIGNhbGwgYSBtZXRob2QgImdldCIKCQkJCS8vb24gbW9kZWwgd2hpY2ggbW9kaWZ5IG1vZGVsLCBidXQgd2UgZG9uJ3Qgd2FudCB0byBjYWxsIGFueSBtZXRob2Qgb24gdmlldy4KCQkJCS8vd2UgYXJlIGluIGRpbGVtbWEgYmVjYXVzZSBvZiBydWxlIDIsIHdlIGRvbid0IGhhdmUgYSBkZWZhdWx0IG1ldGhvZCBmb3IgYSB2aWV3LgoJCQkJLy9hIGNhc2UgaW4gdXNlIGlzIHRoYXQKCQkJCS8vc2hhZG93RWRpdDogIiFpbml0Oi58aW5pdFNoYWRvd0VkaXQgKmZha2VTZXQ7IiArCgkJCQlmYWtlU2V0OiAkLm5vb3AKCgkJCX0sCgoJCQkvL2hhbmRsZXIuY29udmVydC5jYWxsKCBzdWJzY3JpYmVyLCB2YWx1ZSwgZSApOwoJCQkvL2luc2lkZSBjb252ZXJ0ZXIgZnVuY3Rpb24gJ3RoaXMnIHJlZmVyIHRvIHN1YnNjcmliZXIKCQkJY29udmVydDogewoKCQkJCXRvU3RyaW5nOiB1dGlsLnRvU3RyaW5nLAoKCQkJCXRvVHlwZWRWYWx1ZTogdXRpbC50b1R5cGVkVmFsdWUsCgoJCQkJdG9OdW1iZXI6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQkJCQlyZXR1cm4gK3ZhbHVlOwoJCQkJfSwKCgkJCQl0b0RhdGU6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQkJCQlyZXR1cm4gbmV3IERhdGUoIHZhbHVlICk7CgkJCQl9CgkJCX0sCgoJCQkvL2hhbmRsZXIuZmluYWxpemUuY2FsbCggc3Vic2NyaWJlciwgdmFsdWUsIGUgKTsKCQkJLy9pbnNpZGUgdGhlIGFmdGVyU2V0IGZ1bmN0aW9uLCAndGhpcycgcmVmZXIgdG8gdGhlIHN1YnNjcmliZXIKCQkJZmluYWxpemU6IHsKCQkJCS8vCQkJCXNhdmVMb2NhbDogZnVuY3Rpb24oIHZhbHVlLCBlICkgewoJCQkJLy8JCQkJCXV0aWwubG9jYWwoIGUucHVibGlzaGVyLnBhdGgsIHZhbHVlICk7CgkJCQkvLwkJCQl9CgkJCX0KCQl9Cgl9ICk7CgoJd29ya2Zsb3dTdG9yZSA9IHsKCgkJY2hhbmdlOiB7CgkJCWdldDogZnVuY3Rpb24oIGUgKSB7CgkJCQlyb290Tm9kZS5jaGFuZ2UoIGUuaGFuZGxlci5vcHRpb25zICk7CgkJCX0KCQl9LAoJCXNhdmVMb2NhbDogewoJCQlnZXQ6IGZ1bmN0aW9uKCBlICkgewoJCQkJdmFyIHBhdGggPSBlLnB1Ymxpc2hlci5wYXRoOwoJCQkJc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQkJaG0oIHBhdGggKS5zYXZlTG9jYWwoKTsKCQkJCX0sIDEgKTsKCQkJfQoJCX0KCX07CgoJdmFyIHZpZXdJZE1hbmFnZXIgPSB7CgoJCWdldElkOiBmdW5jdGlvbiggZWxlbSApIHsKCQkJcmV0dXJuICQoIGVsZW0gKS5obURhdGEoICJ2aWV3SWQiICk7CgkJfSwKCgkJdW5NYXJrOiBmdW5jdGlvbiggZWxlbSApIHsKCQkJJCggZWxlbSApLmhtRGF0YSggInZpZXdJZCIsIHVuZGVmaW5lZCApOwoJCX0sCgoJCW1hcms6IGZ1bmN0aW9uKCBlbGVtICkgewoJCQlpZiAoaXNPYmplY3QoIGVsZW0gKSAmJiAhJCggZWxlbSApLmhtRGF0YSggInZpZXdJZCIgKSkgewoJCQkJJCggZWxlbSApLmhtRGF0YSggInZpZXdJZCIsICsrdmlld0lkICk7CgkJCX0KCQl9Cgl9OwoKCS8vIC0tLS0tLS0tIHByaXZhdGUgLS0tLS0tLS0tLS0tLSAvLwoJLy90aGUgcmVhc29uIHRoYXQgd2Ugd2FudCB0byBidWlsZFVuaXF1ZVZpZXdFdmVudFR5cGVzIGlzIHRoYXQKCS8vd2hlbiB1bmJpbmQgb3IgdW5kZWxlZ2F0ZSB0aGUgdmlld0V2ZW50VHlwZXMsIHdlIHdhbnQgdG8gdGhlIHZpZXdFdmVudFR5cGVzCgkvL2FzIHVuaXF1ZSBhcyBwb3NzaWJsZSwgY2hlY2sgdGhlIHVuc3Vic2NyaWJlIG1ldGhvZAoJLy8KCS8vaW5wdXQ6IGdldFVuaXF1ZVZpZXdFdmVudFR5cGVzKCJjbGljayBkYmxDbGljayIsIHZpZXdXaXRoVmlld0lkMywgImN1c3RvbWVyIikKCS8vb3V0cHV0OiAiY2xpY2suX19obS4zLmN1c3RvbWVyIGRibENsaWNrLl9faG0uMy5jdXN0b21lciIKCS8vaW5wdXQ6IGdldFVuaXF1ZVZpZXdFdmVudFR5cGVzKCJjbGljayBkYmxDbGljayIsIHZpZXdXaXRoVmlld0lkMywgdmlld1dpdGhWaWV3SWQ0KQoJLy9vdXRwdXQ6ICJjbGljay5fX2htLjMuNCBkYmxDbGljay5fX2htLjMuNCIKCS8vaXQgdHJ5IHRvIGFwcGVuZCBhbiBldmVudCBuYW1lIHdpdGggYW5kICIuX19obS52aWV3SWQuc3Vic2NyaWJlcklkIgoJZnVuY3Rpb24gYnVpbGRVbmlxdWVWaWV3RXZlbnRUeXBlcyggb3JpZ2luYWxFdmVudFR5cGVzLCBwdWJsaXNoZXJWaWV3LCBzdWJzY3JpYmVyICkgewoKCQl2YXIgcHVibGlzaGVyVmlld0lkID0gdmlld0lkTWFuYWdlci5nZXRJZCggcHVibGlzaGVyVmlldyApOwoKCQkvKglpZiBvcmlnaW5hbCB2aWV3RXZlbnRzIGlzICJjbGljayBkYmxDbGljayIsCgkJIGFuZCBpdCBiaW5kIHRvIHBhdGggImZpcnN0TmFtZSIsIGl0IHdpbGwgY29udmVydCB0bwoJCSBjbGljay5fX2htLmZpcnN0TmFtZSBkYmxDbGljay5fX2htLmZpcnN0TmFtZSwgdGhlIHJlYXNvbiBpcyB0aGF0CgkJIHdoZW4gcGF0aCBpcyBkZWxldGVkLCB0aGUgbWV0aG9kIHVuYmluZChvYmplY3QpIG5lZWQgdG8gdW5iaW5kCgkJIGV2ZW50IGJ5IGEgbmFtZXNwYWNlLCBpZiBmaXJzdE5hbWUgaXMgZGVsZXRlZCwgd2UgY2FuIHVuYmluZCAiLl9faG0uZmlyc3ROYW1lIiovCgkJcmV0dXJuICQubWFwKAoJCQlvcmlnaW5hbEV2ZW50VHlwZXMuc3BsaXQoIHJTcGFjZXMgKSwKCQkJZnVuY3Rpb24oIG9yaWdpbmFsRXZlbnROYW1lICkgewoJCQkJcmV0dXJuIGlzU3RyaW5nKCBzdWJzY3JpYmVyICkgPwoJCQkJCW9yaWdpbmFsRXZlbnROYW1lICsgIi4iICsgc2hhZG93TmFtZXNwYWNlICsgIi4iICsgcHVibGlzaGVyVmlld0lkICsgIi4iICsgc3Vic2NyaWJlciA6CgkJCQkJb3JpZ2luYWxFdmVudE5hbWUgKyAiLiIgKyBzaGFkb3dOYW1lc3BhY2UgKyAiLiIgKyBwdWJsaXNoZXJWaWV3SWQgKyAiLiIgKyB2aWV3SWRNYW5hZ2VyLmdldElkKCBzdWJzY3JpYmVyICk7CgkJCX0KCQkpLmpvaW4oICIgIiApOwoJfQoKCS8vaWYgb2JqZWN0IGlzIGRvbSBlbGVtZW50IG9yIGpRdWVyeSBzZWxlY3RvciB0aGVuIHdyYXAgaW50byBqUXVlcnkKCS8vaWYgb2JqZWN0IGlzIG1vZGVsIHBhdGgsIHdyYXAgaXQgaW50byBtb2RlbAoJLy9pZiBpdCBpcyBwdXJlIG9iamVjdCwgcmV0dXJuIGFzIGl0IGlzCgkvL2lmIGl0IGlzIF8sIHJldHVybiBudWxsCglmdW5jdGlvbiB0cnlXcmFwUHVibGlzaGVyU3Vic2NyaWJlciggcHVibGlzaGVyT3JTdWJzY3JpYmVyICkgewoJCWlmIChpc1N0cmluZyggcHVibGlzaGVyT3JTdWJzY3JpYmVyICkpIHsKCQkJcmV0dXJuIGhtKCBwdWJsaXNoZXJPclN1YnNjcmliZXIgKTsKCgkJfSBlbHNlIGlmIChpc09iamVjdCggcHVibGlzaGVyT3JTdWJzY3JpYmVyICkgJiYgIXB1Ymxpc2hlck9yU3Vic2NyaWJlci5ub2RlVHlwZSkgewoJCQkvL25vdCBhIERPTSBlbGVtZW50CgkJCXJldHVybiBwdWJsaXNoZXJPclN1YnNjcmliZXI7CgoJCX0gZWxzZSBpZiAoIWlzVW5kZWZpbmVkKCBwdWJsaXNoZXJPclN1YnNjcmliZXIgKSkgewoKCQkJcmV0dXJuICQoIHB1Ymxpc2hlck9yU3Vic2NyaWJlciApOwoJCX0KCX0KCglmdW5jdGlvbiByZXBsYWNlRG90T3JTdGFyKCBtYXRjaCApIHsKCQkvL2lmIG1hdGNoIGlzICIuIiwgbm9ybWFsaXplIGl0IHRvICJcXC4iCgkJLy9pZiBtYXRjaCBpcyAiKiIsIG5vcm1hbGl6ZSBpdCB0byAiLioiCgkJcmV0dXJuIG1hdGNoID09ICIuIiA/ICJcXC4iIDogIi4qIjsKCX0KCgkvL2lmIG9uZSBvZiB0aGUgc3Vic2NyaWJlZCBldmVudHMgaXMgbWF0Y2hlZCB3aXRoIHRyaWdnZXJpbmcgZXZlbnQKCS8vcmV0dXJuIHRoYXQgc3Vic2NyaWJlZCBldmVudAoJZnVuY3Rpb24gZ2V0TWF0Y2hlZFN1YnNjcmliZWRFdmVudCggc3Vic2NyaWJlZEV2ZW50cywgdHJpZ2dlcmluZ0V2ZW50ICkgewoKCQl2YXIgbWF0Y2gsCgkJCXNvdXJjZSwKCQkJck1hdGNoV2l0aFRyaWdnZXJpbmdFdmVudCwKCQkJZXZlbnRTdWJzY3JpYmVkLAoJCQlpc0VuZFdpdGhTdGFyRG90LAoJCQlpOwoKCQlpZiAoc3Vic2NyaWJlZEV2ZW50cyA9PT0gIioiKSB7CgkJCXJldHVybiAiKiI7CgkJfQoKCQlzdWJzY3JpYmVkRXZlbnRzID0gc3Vic2NyaWJlZEV2ZW50cy5zcGxpdCggclNwYWNlcyApOwoKCQlmb3IgKGkgPSAwOyBpIDwgc3Vic2NyaWJlZEV2ZW50cy5sZW5ndGg7IGkrKykgewoKCQkJZXZlbnRTdWJzY3JpYmVkID0gc3Vic2NyaWJlZEV2ZW50c1tpXTsKCgkJCWlzRW5kV2l0aFN0YXJEb3QgPSByRW5kV2l0aFN0YXJEb3QudGVzdCggZXZlbnRTdWJzY3JpYmVkICk7CgoJCQlzb3VyY2UgPSBpc0VuZFdpdGhTdGFyRG90ID8KCQkJCS8vaWYgZXZlbnRTdWJzY3JpYmVkIGlzIGxpa2UgIiouIiBvciAiYmVmb3JlKi4iOwoJCQkJZXZlbnRTdWJzY3JpYmVkLnJlcGxhY2UoIHJFbmRXaXRoU3RhckRvdCwgIiIgKSA6CgkJCQlldmVudFN1YnNjcmliZWQ7CgoJCQlzb3VyY2UgPSBzb3VyY2UucmVwbGFjZSggckRvdE9yU3RhciwgcmVwbGFjZURvdE9yU3RhciApOwoKCQkJc291cmNlID0gaXNFbmRXaXRoU3RhckRvdCA/ICJeIiArIHNvdXJjZSA6ICJeIiArIHNvdXJjZSArICIkIjsKCgkJCXJNYXRjaFdpdGhUcmlnZ2VyaW5nRXZlbnQgPSBuZXcgUmVnRXhwKCBzb3VyY2UsICJpIiApOwoKCQkJbWF0Y2ggPSByTWF0Y2hXaXRoVHJpZ2dlcmluZ0V2ZW50LnRlc3QoIHRyaWdnZXJpbmdFdmVudCApOwoKCQkJaWYgKG1hdGNoKSB7CgkJCQlpZiAoaXNFbmRXaXRoU3RhckRvdCkgewoJCQkJCS8vaW4gb3RoZXIgYnJvd3NlciwgaW4gdGhlIGZvbGxvd2luZyBpcyBlbm91Z2gKCQkJCQkvL3ZhciByZW1haW5pbmcgPSBSZWdFeHAucmlnaHRDb250ZXh0OwoJCQkJCS8vCgkJCQkJLy9ob3dldmVyIGluIElFIGhhcyBhIGJ1ZyB0aGF0LCBpZiByVGVtcCBpcyAvXi8sIFJlZ0V4cC5yaWdodENvbnRleHQgcmV0dXJuICIiCgkJCQkJLy93aGlsZSBvdGhlciBicm93c2VyIFJlZ0V4cC5yaWdodENvbnRleHQgcmV0dXJuIHRoZSByZW1haW5pbmcKCQkJCQkvL3NlZSBodHRwOi8vanNiaW4uY29tL2lrYWt1dy8yL2VkaXQKCQkJCQl2YXIgcmVtYWluaW5nID0gc291cmNlID09ICJeIiA/IHRyaWdnZXJpbmdFdmVudCA6IFJlZ0V4cC5yaWdodENvbnRleHQ7CgoJCQkJCS8vaWYgcmVtYWluaW5nIGlzIGVtcHR5IG9yIHJlbWFpbmluZyBkb2VzIG5vdCBjb250YWlucyAiLiIKCQkJCQlpZiAoIXJlbWFpbmluZyB8fCAhcmVtYWluaW5nLmNvbnRhaW5zKCAiLiIgKSkgewoJCQkJCQlyZXR1cm4gc3Vic2NyaWJlZEV2ZW50c1tpXTsKCQkJCQl9CgkJCQl9IGVsc2UgewoJCQkJCXJldHVybiBzdWJzY3JpYmVkRXZlbnRzW2ldOwoJCQkJfQoJCQl9CgkJfQoJfQoKCS8vY2hlY2sgaWYgc3Vic2NyaXB0aW9uIG1hdGNoZWQgd2l0aCB0aGUgdHJpZ2dlcmluZyBldmVudCwKCS8vIGFuZCBpbnZva2UgaXRzIHdvcmtmbG93LCBhbmQgYWxzbyBjYXNjYWRlIHRoZSBldmVudHMgdG8KCS8vaG9yaXpvbnRhbGx5LCBlIGlzIG11dGFibGUKCWZ1bmN0aW9uIGNhbGxiYWNrTW9kZWxTdWJzY3JpcHRpb25IYW5kbGVyKCBlICkgewoKCQl2YXIgc3Vic2NyaXB0aW9uLAoJCQl3YXRjaGluZ1BhdGhzLAoJCQljYXNjYWRlRXZlbnQsCgkJCWksCgkJCWosCgkJCXN1YnNjcmlwdGlvbnNCeVB1Ymxpc2hlciA9IGUucHVibGlzaGVyLnN1YnNUb01lKCk7CgoJCWZvciAoaSA9IDA7IGkgPCBzdWJzY3JpcHRpb25zQnlQdWJsaXNoZXIubGVuZ3RoOyBpKyspIHsKCgkJCXN1YnNjcmlwdGlvbiA9IHN1YnNjcmlwdGlvbnNCeVB1Ymxpc2hlcltpXTsKCgkJCWUubWF0Y2hlZFR5cGUgPSBnZXRNYXRjaGVkU3Vic2NyaWJlZEV2ZW50KCBzdWJzY3JpcHRpb24uZXZlbnRUeXBlcywgZS50eXBlICk7CgoJCQlpZiAoZS5tYXRjaGVkVHlwZSkgewoJCQkJZXhlY3V0ZUhhbmRsZXIoIHRyeVdyYXBQdWJsaXNoZXJTdWJzY3JpYmVyKCBzdWJzY3JpcHRpb24uc3Vic2NyaWJlciApLCBzdWJzY3JpcHRpb24uaGFuZGxlciwgZSApOwoJCQl9CgoJCQlpZiAoZS5pc0ltbWVkaWF0ZVByb3BhZ2F0aW9uU3RvcHBlZCgpKSB7CgkJCQlyZXR1cm47CgkJCX0KCQl9CgoJCWlmICghZS5pc0Nhc2NhZGVTdG9wcGVkKCkpIHsKCgkJCXdhdGNoaW5nUGF0aHMgPSB3YXRjaFRhYmxlW2UucHVibGlzaGVyLnBhdGhdOwoKCQkJaWYgKHdhdGNoaW5nUGF0aHMpIHsKCQkJCWZvciAoaiA9IDA7IGogPCB3YXRjaGluZ1BhdGhzLmxlbmd0aDsgaisrKSB7CgoJCQkJCWNhc2NhZGVFdmVudCA9IHRyaWdnZXIoCgkJCQkJCXdhdGNoaW5nUGF0aHNbal0sCgkJCQkJCWUub3JpZ2luYWxQdWJsaXNoZXIucGF0aCwKCQkJCQkJZS50eXBlCgkJCQkJKTsKCgkJCQkJaWYgKGNhc2NhZGVFdmVudC5pc0ltbWVkaWF0ZVByb3BhZ2F0aW9uU3RvcHBlZCgpIHx8IGNhc2NhZGVFdmVudC5pc0ltbWVkaWF0ZVByb3BhZ2F0aW9uU3RvcHBlZCgpKSB7CgkJCQkJCXJldHVybjsKCQkJCQl9CgoJCQkJCWlmIChjYXNjYWRlRXZlbnQuaGFzRXJyb3IoKSkgewoJCQkJCQllLmVycm9yKCk7CgkJCQkJfQoJCQkJfQoJCQl9CgkJfQoJfQoKCS8vI2RlYnVnCgoJaWYgKGxvY2F0aW9uLnNlYXJjaC5jb250YWlucyggImRlYnVnIiApKSB7CgkJZGVmYXVsdE9wdGlvbnMuZGVidWcgPSB0cnVlOwoJfQoKCWZ1bmN0aW9uIHVud3JhcE9iamVjdCggb2JqZWN0ICkgewoJCWlmIChvYmplY3QpIHsKCQkJaWYgKCFpc1VuZGVmaW5lZCggb2JqZWN0LnBhdGggKSkgewoJCQkJcmV0dXJuIGhtLnV0aWwudG9Mb2dpY2FsUGF0aCggb2JqZWN0LnBhdGggKTsKCQkJfSBlbHNlIHsKCQkJCXJldHVybiBvYmplY3RbMF07CgkJCX0KCQl9IGVsc2UgewoJCQlyZXR1cm4gIm51bGwiOwoJCX0KCX0KCgkvLyNlbmRfZGVidWcKCglmdW5jdGlvbiBleGVjdXRlSGFuZGxlciggc3Vic2NyaWJlciwgaGFuZGxlciwgZSwgdHJpZ2dlckRhdGEgKSB7CgoJCS8vI2RlYnVnCgkJaWYgKGRlZmF1bHRPcHRpb25zLmRlYnVnKSB7CgkJCWxvZyggdW53cmFwT2JqZWN0KCBlLnB1Ymxpc2hlciApLAoJCQkJZS50eXBlLAoJCQkJdW53cmFwT2JqZWN0KCBzdWJzY3JpYmVyICksCgkJCQloYW5kbGVyLAoJCQkJdW53cmFwT2JqZWN0KCBlLm9yaWdpbmFsUHVibGlzaGVyICkKCQkJKTsKCQl9CgkJLy8jZW5kX2RlYnVnCgoJCXZhciB2YWx1ZSwKCQkJY2xvbmVkRXZlbnRBcmc7CgoJCWUuaGFuZGxlciA9IGhhbmRsZXI7CgkJZS5zdWJzY3JpYmVyID0gc3Vic2NyaWJlcjsKCgkJaWYgKCFpc1VuZGVmaW5lZCggdHJpZ2dlckRhdGEgKSkgewoJCQkvL2luIHRoZSBnZXQgbWV0aG9kICJ0aGlzIiByZWZlciB0byB0aGUgaGFuZGxlcgoJCQl2YWx1ZSA9IGhhbmRsZXIuZ2V0LmFwcGx5KCBzdWJzY3JpYmVyLCBbZV0uY29uY2F0KCB0cmlnZ2VyRGF0YSApICk7CgkJfSBlbHNlIHsKCQkJLy9pbiB0aGUgZ2V0IG1ldGhvZCAidGhpcyIgcmVmZXIgdG8gdGhlIGhhbmRsZXIKCQkJdmFsdWUgPSBoYW5kbGVyLmdldC5jYWxsKCBzdWJzY3JpYmVyLCBlICk7CgkJfQoKCQlpZiAoZS5pc0Fib3J0ZWQoKSkgewoJCQlyZXR1cm47CgkJfQoKCQlpZiAoaXNQcm9taXNlKCB2YWx1ZSApKSB7CgkJCWNsb25lZEV2ZW50QXJnID0gZXh0ZW5kKCB0cnVlLCB7fSwgZSApOwoJCQl2YWx1ZS5kb25lKCBmdW5jdGlvbiggdmFsdWUgKSB7CgkJCQlpZiAoaGFuZGxlci5jb252ZXJ0KSB7CgkJCQkJLy9pbiB0aGUgY29udmVydCBtZXRob2QgInRoaXMiIHJlZmVyIHRvIHRoZSBoYW5kbGVyCgkJCQkJdmFsdWUgPSBoYW5kbGVyLmNvbnZlcnQuY2FsbCggc3Vic2NyaWJlciwgdmFsdWUsIGUgKTsKCQkJCX0KCgkJCQlpZiAoaGFuZGxlci5zZXQgfHwgaGFuZGxlci5maW5hbGl6ZSkgewoJCQkJCS8vbWFrZSBzdXJlIGl0IGlzIGEgcmVhbCBwcm9taXNlIG9iamVjdAoJCQkJCWlmIChpc1Byb21pc2UoIHZhbHVlICkpIHsKCQkJCQkJdmFsdWUuZG9uZSggZnVuY3Rpb24oIHZhbHVlICkgewoJCQkJCQkJc2V0QW5kRmluYWxpemUoIHN1YnNjcmliZXIsIGhhbmRsZXIsIHZhbHVlLCBjbG9uZWRFdmVudEFyZyApOwoJCQkJCQl9ICk7CgoJCQkJCX0gZWxzZSB7CgkJCQkJCXJldHVybiBzZXRBbmRGaW5hbGl6ZSggc3Vic2NyaWJlciwgaGFuZGxlciwgdmFsdWUsIGUgKTsKCQkJCQl9CgkJCQl9CgkJCX0gKTsKCQl9IGVsc2UgewoJCQlpZiAoaGFuZGxlci5jb252ZXJ0KSB7CgkJCQkvL2luIHRoZSBjb252ZXJ0IG1ldGhvZCAidGhpcyIgcmVmZXIgdG8gdGhlIGhhbmRsZXIKCQkJCXZhbHVlID0gaGFuZGxlci5jb252ZXJ0LmNhbGwoIHN1YnNjcmliZXIsIHZhbHVlLCBlICk7CgkJCX0KCgkJCWlmIChoYW5kbGVyLnNldCB8fCBoYW5kbGVyLmZpbmFsaXplKSB7CgkJCQkvL21ha2Ugc3VyZSBpdCBpcyBhIHJlYWwgcHJvbWlzZSBvYmplY3QKCQkJCWlmIChpc1Byb21pc2UoIHZhbHVlICkpIHsKCQkJCQljbG9uZWRFdmVudEFyZyA9IGV4dGVuZCggdHJ1ZSwge30sIGUgKTsKCQkJCQl2YWx1ZS5kb25lKCBmdW5jdGlvbiggdmFsdWUgKSB7CgkJCQkJCXNldEFuZEZpbmFsaXplKCBzdWJzY3JpYmVyLCBoYW5kbGVyLCB2YWx1ZSwgY2xvbmVkRXZlbnRBcmcgKTsKCQkJCQl9ICk7CgoJCQkJfSBlbHNlIHsKCQkJCQlzZXRBbmRGaW5hbGl6ZSggc3Vic2NyaWJlciwgaGFuZGxlciwgdmFsdWUsIGUgKTsKCQkJCX0KCQkJfQoJCX0KCgl9CgoJZnVuY3Rpb24gc2V0QW5kRmluYWxpemUoIHN1YnNjcmliZXIsIGhhbmRsZXIsIHZhbHVlLCBlICkgewoJCWlmICh2YWx1ZSA9PT0gZHVtbXkpIHsKCQkJdmFsdWUgPSB1bmRlZmluZWQ7CgkJfQoJCWhhbmRsZXIuc2V0ICYmIGhhbmRsZXIuc2V0LmNhbGwoIHN1YnNjcmliZXIsIHZhbHVlLCBlICk7CgkJaGFuZGxlci5maW5hbGl6ZSAmJiBoYW5kbGVyLmZpbmFsaXplLmNhbGwoIHN1YnNjcmliZXIsIHZhbHVlLCBlICk7Cgl9CgoJZnVuY3Rpb24gc3Vic2NyaWJlTW9kZWxFdmVudCggcHVibGlzaGVyUGF0aCwgZXZlbnRUeXBlcywgc3Vic2NyaWJlciwgaGFuZGxlciwgb3B0aW9ucyApIHsKCgkJdmFyIG1hdGNoLAoJCQlkZWxheU1pbmlTZWNvbmQsCgkJCWluaXRFdmVudCwKCQkJZXZlbnRzOwoKCQlldmVudHMgPSBldmVudFR5cGVzLnNwbGl0KCAiICIgKTsKCgkJZm9yICh2YXIgaSA9IDA7IGkgPCBldmVudHMubGVuZ3RoOyBpKyspIHsKCQkJbWF0Y2ggPSBySW5pdC5leGVjKCBldmVudHNbaV0gKTsKCQkJaWYgKG1hdGNoKSB7CgkJCQlpbml0RXZlbnQgPSBldmVudHNbaV07CgkJCQlkZWxheU1pbmlTZWNvbmQgPSArbWF0Y2hbMV07CgkJCQlldmVudHMuc3BsaWNlKCBpLCAxICk7CgkJCQlldmVudFR5cGVzID0gZXZlbnRzLmpvaW4oICIgIiApOwoJCQkJYnJlYWs7CgkJCX0KCQl9CgoJCWhhbmRsZXIgPSBidWlsZEhhbmRsZXIoIGhhbmRsZXIsIHB1Ymxpc2hlclBhdGgsIHN1YnNjcmliZXIsIG9wdGlvbnMgKTsKCgkJaWYgKGV2ZW50VHlwZXMpIHsKCQkJc3Vic2NyaXB0aW9uTWFuYWdlci5hZGQoIHN1YnNjcmliZXIsIHB1Ymxpc2hlclBhdGgsIGV2ZW50VHlwZXMsIGhhbmRsZXIgKTsKCQl9CgoJCWlmIChpbml0RXZlbnQpIHsKCQkJdmFyIGluaXQgPSBmdW5jdGlvbigpIHsKCQkJCXZhciBlID0gbmV3IEV2ZW50KCBwdWJsaXNoZXJQYXRoLCBwdWJsaXNoZXJQYXRoLCBpbml0RXZlbnQgKTsKCQkJCWV4ZWN1dGVIYW5kbGVyKCB0cnlXcmFwUHVibGlzaGVyU3Vic2NyaWJlciggc3Vic2NyaWJlciApLCBoYW5kbGVyLCBlICk7CgkJCX07CgoJCQlpZiAoZGVsYXlNaW5pU2Vjb25kKSB7CgkJCQlzZXRUaW1lb3V0KCBpbml0LCBkZWxheU1pbmlTZWNvbmQgKTsKCQkJfSBlbHNlIHsKCQkJCWluaXQoKTsKCQkJfQoJCX0KCX0KCgkvL3N1YnNjcmliZSBqUXVlcnkgZXZlbnQKCWZ1bmN0aW9uIHN1YnNjcmliZVZpZXdFdmVudCggdmlld1B1Ymxpc2hlciwgZXZlbnRUeXBlcywgc3Vic2NyaWJlciwgaGFuZGxlciwgb3B0aW9ucywgZGVsZWdhdGVTZWxlY3RvciApIHsKCgkJLy9nZXQvc2V0L2NvbnZlcnQvW2luaXRdL1tvcHRpb25zXQoJCXZhciBuZWVkSW5pdCwKCQkJZXZlbnRTZWVkRGF0YSwKCQkJdGVtcDsKCgkJdGVtcCA9IGV2ZW50VHlwZXMuc3BsaXQoICIgIiApOwoKCQlpZiAodGVtcC5jb250YWlucyggImluaXQiICkpIHsKCQkJbmVlZEluaXQgPSB0cnVlOwoJCQlldmVudFR5cGVzID0gdGVtcC5yZW1vdmUoICJpbml0IiApLmpvaW4oICIgIiApOwoJCX0KCgkJaGFuZGxlciA9IGJ1aWxkSGFuZGxlciggaGFuZGxlciwgdmlld1B1Ymxpc2hlciwgc3Vic2NyaWJlciwgb3B0aW9ucyApOwoKCQlldmVudFNlZWREYXRhID0gewoJCQloYW5kbGVyOiBoYW5kbGVyLAoJCQlzdWJzY3JpYmVyOiBzdWJzY3JpYmVyCgkJfTsKCgkJaWYgKGV2ZW50VHlwZXMpIHsKCQkJZXZlbnRUeXBlcyA9IGJ1aWxkVW5pcXVlVmlld0V2ZW50VHlwZXMoIGV2ZW50VHlwZXMsIHZpZXdQdWJsaXNoZXIsIHN1YnNjcmliZXIgKTsKCgkJCWlmIChkZWxlZ2F0ZVNlbGVjdG9yKSB7CgkJCQloYW5kbGVyLmRlbGVnYXRlU2VsZWN0b3IgPSBkZWxlZ2F0ZVNlbGVjdG9yOwoJCQkJJCggdmlld1B1Ymxpc2hlciApLmRlbGVnYXRlKCBkZWxlZ2F0ZVNlbGVjdG9yLCBldmVudFR5cGVzLCBldmVudFNlZWREYXRhLCB2aWV3SGFuZGxlckdhdGV3YXkgKTsKCgkJCX0gZWxzZSB7CgkJCQkkKCB2aWV3UHVibGlzaGVyICkuYmluZCggZXZlbnRUeXBlcywgZXZlbnRTZWVkRGF0YSwgdmlld0hhbmRsZXJHYXRld2F5ICk7CgoJCQl9CgoJCQkvL3dlIGhhdmUgcGFzc2VkIGhhbmRsZXIsIHN1YnNjcmliZXIsIG9wdGlvbnMgYXMgalF1ZXJ5IGV2ZW50U2VlZERhdGEsCgkJCS8vd2Ugc3RpbGwgbmVlZCB0byBhZGQgdGhlbSB0byBzdWJzY3JpcHRpb25zIHNvIHRoYXQKCQkJLy90aGUgdmlldyBldmVudCBoYW5kbGVyIGNhbiBiZSB1bmJpbmQgb3IgdW5kZWxlZ2F0ZQoJCQlzdWJzY3JpcHRpb25NYW5hZ2VyLmFkZCggc3Vic2NyaWJlciwgdmlld1B1Ymxpc2hlciwgZXZlbnRUeXBlcywgaGFuZGxlciApOwoKCQkJaWYgKG5lZWRJbml0KSB7CgkJCQlpZiAoZGVsZWdhdGVTZWxlY3RvcikgewoJCQkJCSQoIHZpZXdQdWJsaXNoZXIgKS5maW5kKCBkZWxlZ2F0ZVNlbGVjdG9yICkudHJpZ2dlciggZXZlbnRUeXBlcyApOwoJCQkJfSBlbHNlIHsKCQkJCQkkKCB2aWV3UHVibGlzaGVyICkudHJpZ2dlciggZXZlbnRUeXBlcyApOwoJCQkJfQoJCQl9CgoJCX0gZWxzZSBpZiAobmVlZEluaXQpIHsKCgkJCSQoIHZpZXdQdWJsaXNoZXIgKS5vbmUoICJpbml0IiwgZXZlbnRTZWVkRGF0YSwgdmlld0hhbmRsZXJHYXRld2F5ICk7CgkJCSQoIHZpZXdQdWJsaXNoZXIgKS50cmlnZ2VyKCAiaW5pdCIgKTsKCgkJfQoJfQoKCWZ1bmN0aW9uIGFib3J0KCkgewoJCXRoaXMuaXNBYm9ydGVkID0gcmV0dXJuVHJ1ZTsKCX0KCgkvL3RoZSBnZW5lcmFsIGpRdWVyeSBldmVudCBoYW5kbGVyCglmdW5jdGlvbiB2aWV3SGFuZGxlckdhdGV3YXkoIGUgKSB7CgkJZS5wdWJsaXNoZXIgPSB0cnlXcmFwUHVibGlzaGVyU3Vic2NyaWJlciggZS5jdXJyZW50VGFyZ2V0ICk7CgkJZS5vcmlnaW5hbFB1Ymxpc2hlciA9IHRyeVdyYXBQdWJsaXNoZXJTdWJzY3JpYmVyKCBlLnRhcmdldCApOwoJCWUuaXNBYm9ydGVkID0gcmV0dXJuRmFsc2U7CgkJZS5hYm9ydCA9IGFib3J0OwoJCXZhciBzdWJzY3JpYmVyID0gdHJ5V3JhcFB1Ymxpc2hlclN1YnNjcmliZXIoIGUuZGF0YS5zdWJzY3JpYmVyICk7CgoJCXZhciBoYW5kbGVyID0gZS5kYXRhLmhhbmRsZXI7CgkJZGVsZXRlIGUuZGF0YTsKCgkJaWYgKGFyZ3VtZW50cy5sZW5ndGggPiAxKSB7CgkJCWV4ZWN1dGVIYW5kbGVyKCBzdWJzY3JpYmVyLCBoYW5kbGVyLCBlLCBzbGljZS5jYWxsKCBhcmd1bWVudHMsIDEgKSApOwoKCQl9IGVsc2UgewoJCQlleGVjdXRlSGFuZGxlciggc3Vic2NyaWJlciwgaGFuZGxlciwgZSApOwoJCX0KCX0KCglmdW5jdGlvbiBidWlsZEhhbmRsZXIoIHdvcmtmbG93UHJvdG90eXBlLCBwdWJsaXNoZXIsIHN1YnNjcmliZXIsIGluaXRpYWxpemVPcHRpb25zICkgewoKCQl2YXIgaGFuZGxlcjsKCgkJd29ya2Zsb3dQcm90b3R5cGUgPSB3b3JrZmxvd1Byb3RvdHlwZSB8fCAiIjsKCgkJaWYgKGlzU3RyaW5nKCB3b3JrZmxvd1Byb3RvdHlwZSApKSB7CgoJCQloYW5kbGVyID0gYnVpbGRIYW5kbGVyRnJvbVN0cmluZyggd29ya2Zsb3dQcm90b3R5cGUsIHB1Ymxpc2hlciwgc3Vic2NyaWJlciwgaW5pdGlhbGl6ZU9wdGlvbnMgKTsKCgkJfSBlbHNlIGlmIChpc0Z1bmN0aW9uKCB3b3JrZmxvd1Byb3RvdHlwZSApKSB7CgoJCQloYW5kbGVyID0gZXh0ZW5kKCB7CgkJCQkJZ2V0OiB3b3JrZmxvd1Byb3RvdHlwZSwKCQkJCQlvcHRpb25zOiBpbml0aWFsaXplT3B0aW9ucwoJCQkJfSwKCQkJCXdvcmtmbG93UHJvdG90eXBlCgkJCSk7CgoJCX0gZWxzZSBpZiAoaXNPYmplY3QoIHdvcmtmbG93UHJvdG90eXBlICkgJiYgd29ya2Zsb3dQcm90b3R5cGUuZ2V0KSB7CgoJCQloYW5kbGVyID0gZXh0ZW5kKCB7CgkJCQlvcHRpb25zOiBpbml0aWFsaXplT3B0aW9ucwoJCQl9LCB3b3JrZmxvd1Byb3RvdHlwZSApOwoKCQl9IGVsc2UgewoJCQl0aHJvdyAiaW52YWxpZCB3b3JrZmxvdyBleHByZXNzaW9uIjsKCQl9CgoJCWluaXRpYWxpemVIYW5kbGVyKCBoYW5kbGVyLCBwdWJsaXNoZXIsIHN1YnNjcmliZXIsIGluaXRpYWxpemVPcHRpb25zICk7CgoJCWNvbnZlcnRTdHJpbmdBY2Nlc3NvclRvRnVuY3Rpb24oICJnZXQiLCBoYW5kbGVyLCBwdWJsaXNoZXIsIHN1YnNjcmliZXIgKTsKCQljb252ZXJ0U3RyaW5nQWNjZXNzb3JUb0Z1bmN0aW9uKCAic2V0IiwgaGFuZGxlciwgcHVibGlzaGVyLCBzdWJzY3JpYmVyICk7CgkJLy8KCQljb252ZXJ0U3RyaW5nQWN0aXZpdHlUb0Z1bmN0aW9uKCAiY29udmVydCIsIGhhbmRsZXIsIHB1Ymxpc2hlciwgc3Vic2NyaWJlciApOwoJCWNvbnZlcnRTdHJpbmdBY3Rpdml0eVRvRnVuY3Rpb24oICJmaW5hbGl6ZSIsIGhhbmRsZXIsIHB1Ymxpc2hlciwgc3Vic2NyaWJlciApOwoKCQlyZXR1cm4gaGFuZGxlcjsKCX0KCgkvLyBleGFtcGxlIG9mIHdvcmtmbG93U3RyaW5nCgkvLyB6ZXJvIHRva2VuLCB0aGUgc3Vic2NyaWJlciBtdXN0IGJlIGZ1bmN0aW9uIGluIHJlcG9zaXRvcnkKCS8vCgkvLyBzaW5nbGUgdG9rZW4gbGlrZSAiKndvcmtmbG93IiwgInZhbCIsICJodG1sIiwgIiNwYXRoIiwKCS8vICJ2YWwiIHdpbGwgZXhwYW5kIHRvICJ2YWwgc2V0IiBvciAiZ2V0IHZhbCIgZGVwZW5kaW5nIHRoZSB0eXBlIG9mIHB1Ymxpc2hlcgoJLy8KCS8vIG11bHRpcGxlIHRva2VucywgYWxsIHRva2VuIGNhbiBzdGFydHMgd2l0aCAiKiIsICIjIiwKCS8vIGJ1dCBvbmx5ICJnZXQiIGFuZCAic2V0IiB0b2tlbiBjYW4gc3RhcnQgbm9ybWFsIGNoYXJhY3RlcnMsCgkvLyBzdWNoIGFzICJ2YWwiLCAiaHRtbCIKCWZ1bmN0aW9uIGJ1aWxkSGFuZGxlckZyb21TdHJpbmcoIHdvcmtmbG93U3RyaW5nLCBwdWJsaXNoZXIsIHN1YnNjcmliZXIsIGluaXRpYWxpemVPcHRpb25zICkgewoKCQkvL2dldCBzZXQgY29udmVydCBpbml0aWFsaXplIGZpbmFsaXplCgkJdmFyIGhhbmRsZXIsCgkJCWVtYmVkZGVkSGFuZGxlciwKCQkJYWN0aXZpdHlOYW1lLAoJCQlhY3Rpdml0eU5hbWVzID0gd29ya2Zsb3dTdHJpbmcuc3BsaXQoIHJTcGFjZXMgKSwKCQkJYWN0aXZpdHlUeXBlOwoKCQlpZiAoYWN0aXZpdHlOYW1lcy5sZW5ndGggPT0gMSkgewoKCQkJaWYgKHdvcmtmbG93U3RyaW5nLnN0YXJ0c1dpdGgoICIqIiApKSB7CgoJCQkJaGFuZGxlciA9IHdvcmtmbG93U3RvcmVbd29ya2Zsb3dTdHJpbmcuc3Vic3RyKCAxICldOwoJCQkJaWYgKCFoYW5kbGVyKSB7CgkJCQkJdGhyb3cgImNvbW1vbiB3b3JrZmxvdyAiICsgd29ya2Zsb3dTdHJpbmcgKyAiIGRvZXMgbm90IGV4aXN0IjsKCQkJCX0KCgkJCQloYW5kbGVyID0gZXh0ZW5kKCB7fSwgaGFuZGxlciApOwoKCQkJfSBlbHNlIGlmICh3b3JrZmxvd1N0cmluZy5zdGFydHNXaXRoKCAiIyIgKSkgewoKCQkJCWVtYmVkZGVkSGFuZGxlciA9IGdldEVtYmVkZGVkQWN0aXZpdHkoIHdvcmtmbG93U3RyaW5nLCBwdWJsaXNoZXIsIHN1YnNjcmliZXIgKTsKCgkJCQlpZiAoaXNGdW5jdGlvbiggZW1iZWRkZWRIYW5kbGVyICkpIHsKCQkJCQloYW5kbGVyID0gZXh0ZW5kKCB7CgkJCQkJCWdldDogZW1iZWRkZWRIYW5kbGVyLAoJCQkJCQlvcHRpb25zOiBpbml0aWFsaXplT3B0aW9ucwoJCQkJCX0sIGVtYmVkZGVkSGFuZGxlciApOwoJCQkJfSBlbHNlIGlmIChpc09iamVjdCggZW1iZWRkZWRIYW5kbGVyICkgJiYgZW1iZWRkZWRIYW5kbGVyLmdldCkgewoJCQkJCWhhbmRsZXIgPSBleHRlbmQoIHsKCQkJCQkJb3B0aW9uczogaW5pdGlhbGl6ZU9wdGlvbnMKCQkJCQl9LCBlbWJlZGRlZEhhbmRsZXIgKTsKCQkJCX0gZWxzZSB7CgkJCQkJdGhyb3cgIm1pc3NpbmcgaGFuZGxlciI7CgkJCQl9CgoJCQl9IGVsc2UgaWYgKCFpc1VuZGVmaW5lZCggcHVibGlzaGVyICkgJiYgIWlzVW5kZWZpbmVkKCBzdWJzY3JpYmVyICkpIHsKCgkJCQloYW5kbGVyID0gaW5mZXJIYW5kbGVyRnJvbVB1Ymxpc2hlclN1YnNjcmliZXJXaXRoU2luZ2xlQWN0aXZpdHkoCgkJCQkJcHVibGlzaGVyLAoJCQkJCXN1YnNjcmliZXIsCgkJCQkJd29ya2Zsb3dTdHJpbmcgKTsKCgkJCX0gZWxzZSB7CgkJCQkvL2VpdGhlciBtb2RlbCBpcyBlbXB0eSBvciB2aWV3IGlzIGVtcHR5LAoJCQkJLy8gYW5kIHRoZSB3b3JrZmxvdyBzdHJpbmcgaXMgYSBzaW5nbGUKCQkJCS8va2V5LCBhbmQgdGhlIGtleSBpcyBub3Qgd29ya2Zsb3cgdHlwZQoJCQkJdGhyb3cgImludmFsaWQgaGFuZGxlciI7CgkJCX0KCgkJfSBlbHNlIHsKCQkJLy90aGlzIGlzIHRoZSBjYXNlCgkJCS8vYWN0aXZpdHlOYW1lcy5sZW5ndGggPiAxCgoJCQloYW5kbGVyID0geyB9OwoKCQkJLy9hY3Rpdml0eVR5cGVzIGlzIFtnZXQsc2V0LGNvbnZlcnQsZmluYWxpemUsaW5pdGlhbGl6ZV0KCQkJZm9yICh2YXIgaSA9IDA7IGkgPCBhY3Rpdml0eVR5cGVzLmxlbmd0aDsgaSsrKSB7CgkJCQlhY3Rpdml0eU5hbWUgPSBhY3Rpdml0eU5hbWVzW2ldOyAvL2FjdGl2aXR5TmFtZSBpcyB0aGUgdG9rZW4gaW4gd29ya2Zsb3cgc3RyaW5nCgkJCQlhY3Rpdml0eVR5cGUgPSBhY3Rpdml0eVR5cGVzW2ldOyAvL2FjdGl2aXR5VHlwZSBpcyBvbmUgb2YgZ2V0LHNldCxjb252ZXJ0LGZpbmFsaXplLGluaXRpYWxpemUKCgkJCQlpZiAoYWN0aXZpdHlOYW1lICYmIChhY3Rpdml0eU5hbWUgIT09ICJfIiAmJiBhY3Rpdml0eU5hbWUgIT0gIm51bGwiKSkgewoJCQkJCWhhbmRsZXJbYWN0aXZpdHlUeXBlXSA9IGFjdGl2aXR5TmFtZTsKCQkJCX0KCQkJfQoJCX0KCQlyZXR1cm4gaGFuZGxlcjsKCX0KCgkvL2dldCBlbWJlZGRlZCBoYW5kbGVyIGhlbHBlciBieSBwYXRoCgkvL3RoZSBwYXRoIHNob3VsZCBiZSBhIHBhdGggcHJlZml4IHdpdGggIiMiCgkvL3RoYXQgcGF0aCBjYW4gYmUgYWJzb2x1dGUgcGF0aCBsaWtlICIjL2EuYiIKCS8vb3IgaXQgY2FuIGJlIHJlbGF0aXZlIHBhdGggcmVsYXRpdmUgdG8gc3Vic2NyaWJlciBtb2RlbCBvciBwdWJsaXNoZXIgbW9kZWwKCWZ1bmN0aW9uIGdldEVtYmVkZGVkQWN0aXZpdHkoIGFjdGl2aXR5TmFtZVByZWZpeFdpdGhTaGFycENoYXJhY3RlciwgcHVibGlzaGVyLCBzdWJzY3JpYmVyICkgewoKCQl2YXIgbW9kZWxQYXRoID0gYWN0aXZpdHlOYW1lUHJlZml4V2l0aFNoYXJwQ2hhcmFjdGVyLnN1YnN0ciggMSApOwoKCQltb2RlbFBhdGggPSBpc1N0cmluZyggc3Vic2NyaWJlciApID8gbWVyZ2VQYXRoKCBzdWJzY3JpYmVyLCBtb2RlbFBhdGggKSA6CgkJCWlzU3RyaW5nKCBwdWJsaXNoZXIgKSA/IG1lcmdlUGF0aCggcHVibGlzaGVyLCBtb2RlbFBhdGggKSA6CgkJCQltb2RlbFBhdGg7CgoJCXJldHVybiByb290Tm9kZS5yYXcoIG1vZGVsUGF0aCApOwoJfQoKCWZ1bmN0aW9uIGluaXRpYWxpemVIYW5kbGVyKCBoYW5kbGVyLCBwdWJsaXNoZXIsIHN1YnNjcmliZXIsIHdvcmtmbG93T3B0aW9ucyApIHsKCgkJdmFyIGluaXRpYWxpemUgPSBoYW5kbGVyLmluaXRpYWxpemU7CgoJCWlmIChpc1N0cmluZyggaW5pdGlhbGl6ZSApKSB7CgkJCWlmIChpbml0aWFsaXplLnN0YXJ0c1dpdGgoICIqIiApKSB7CgkJCQlpbml0aWFsaXplID0gaG0uYWN0aXZpdHkuaW5pdGlhbGl6ZVtpbml0aWFsaXplLnN1YnN0cmluZyggMSApXTsKCQkJCWlmICghaW5pdGlhbGl6ZSkgewoJCQkJCXRocm93ICJpbml0aWFsaXplIGFjdGl2aXR5IGRvZXMgbm90IGV4aXN0ISI7CgkJCQl9CgkJCX0gZWxzZSB7CgkJCQl2YXIgcGF0aCA9IGluaXRpYWxpemU7CgkJCQlpZiAoIXJvb3ROb2RlLnJhdyggcGF0aCApKSB7CgkJCQkJdGhyb3cgImluaXRpYWxpemUgYWN0aXZpdHkgZG9lcyBub3QgZXhpc3QgYXQgcGF0aCAiICsgcGF0aDsKCQkJCX0KCQkJCWluaXRpYWxpemUgPSBmdW5jdGlvbiggcHVibGlzaGVyLCBzdWJzY3JpYmVyLCBoYW5kbGVyLCBvcHRpb25zICkgewoJCQkJCXJvb3ROb2RlLnNldCggcGF0aCwgcHVibGlzaGVyLCBzdWJzY3JpYmVyLCBoYW5kbGVyLCBvcHRpb25zICk7CgkJCQl9OwoJCQl9CgkJfQoKCQlpZiAoaW5pdGlhbGl6ZSkgewoJCQlpbml0aWFsaXplKCB0cnlXcmFwUHVibGlzaGVyU3Vic2NyaWJlciggcHVibGlzaGVyICksIHRyeVdyYXBQdWJsaXNoZXJTdWJzY3JpYmVyKCBzdWJzY3JpYmVyICksIGhhbmRsZXIsIHdvcmtmbG93T3B0aW9ucyApOwoJCX0gZWxzZSBpZiAoIWlzVW5kZWZpbmVkKCB3b3JrZmxvd09wdGlvbnMgKSkgewoJCQloYW5kbGVyLm9wdGlvbnMgPSB3b3JrZmxvd09wdGlvbnM7CgkJfQoJfQoKCWZ1bmN0aW9uIGluZmVySGFuZGxlckZyb21QdWJsaXNoZXJTdWJzY3JpYmVyV2l0aFNpbmdsZUFjdGl2aXR5KCBwdWJsaXNoZXIsIHN1YnNjcmliZXIsIGFjdGl2aXR5TmFtZSApIHsKCQkvL25vdyB3b3JrZmxvd1N0cmluZyBkb2VzIG5vdCBzdGFydHNXaXRoICosIGl0IGlzIG5vdCBhIHdvcmtmbG93IHR5cGUKCQkvL2luZmVyIGhhbmRsZXIgZnJvbSBwdWJsaXNoZXIgYW5kIHN1YnNjcmliZXIKCQkvLwoJCXZhciBoYW5kbGVyLAoJCQlpc1B1Ymxpc2hlck1vZGVsID0gaXNTdHJpbmcoIHB1Ymxpc2hlciApLAoJCQlpc1N1YnNjcmliZXJNb2RlbCA9IGlzU3RyaW5nKCBzdWJzY3JpYmVyICk7CgoJCWlmIChpc1B1Ymxpc2hlck1vZGVsKSB7CgkJCS8vaWYgcHVibGlzaGVyIGlzIG1vZGVsLCB0aGVuIHRoZSBsb2dpYyBpcwoJCQkvL3dpbGwgZ2V0IG1vZGVsJ3MgdmFsdWUgdXNpbmcgZGVmYXVsdCBnZXQgYWN0aXZpdHksCgkJCS8vYW5kIHVwZGF0ZSB0aGUgdmlldyB1c2luZyB3b3JrZmxvdyBvciAgZGVmYXVsdCAic2V0IiBhY3Rpdml0eQoJCQkvLwoJCQloYW5kbGVyID0gewoKCQkJCWdldDogImdldCIsCgoJCQkJLy9pZiB3b3JrZmxvd1N0cmluZyBpcyBub3QgZW1wdHksIGl0IGlzIHRoZSBzZXQgbWV0aG9kLCBmb3IgZXhhbXBsZQoJCQkJLy8kKCIjbGFibGUiKS5zdWIoaG0oIm1lc3NhZ2UiKSwgInRleHQiKTsKCQkJCS8vCgkJCQkvL2lmIHdvcmtmbG93U3RyaW5nIGlzIGVtcHR5LAoJCQkJLy8gdGhlbiBpdCBzaG91bGQgYmUgdGhlIGNhc2Ugd2hlbiBtb2RlbCBzdWJzY3JpYmUgbW9kZWwKCQkJCS8vY29weSB2YWx1ZSBvZiBvbmUgbm9kZSB0byBhbiBvdGhlciBub2RlCgkJCQkvL2htKCJtZXNzYWdlIikuc3ViKGhtKCJuYW1lIiksICJhZnRlclVwZGF0ZSIpOwoJCQkJc2V0OiBhY3Rpdml0eU5hbWUgfHwgInNldCIKCgoJCQl9OwoKCQl9IGVsc2UgaWYgKGlzU3Vic2NyaWJlck1vZGVsKSB7CgoJCQkvLyBtb2RlbCBzdWJzY3JpYmUgdmlldyBldmVudAoKCQkJaWYgKGFjdGl2aXR5TmFtZSkgewoJCQkJLy9obSgibmFtZSIpLnN1YigkKCIjdGV4dEJveCIsICJjaGFuZ2UiKTsKCQkJCWhhbmRsZXIgPSB7CgkJCQkJZ2V0OiBhY3Rpdml0eU5hbWUsCgkJCQkJc2V0OiAic2V0IgoJCQkJfTsKCQkJfSBlbHNlIHsKCgkJCQkvL2lmIHdvcmtmbG93U3RyaW5nIGlzIGVtcHR5CgkJCQkvL3doZW4gbW9kZWwgc3Vic2NyaWJlIHZpZXcgd2l0aG91dCBoYW5kbGVyCgkJCQkvL3RoZSBtb2RlbCBpcyB0aGUgaGFuZGxlciBieSBpdHNlbGYKCQkJCS8vZS5nCgkJCQkvL2htKCJmdW5jdGlvbk5vZGUiKS5zdWJzY3JpYmUoJCgiYnV0dG9uIiksICJjbGljayIpOwoJCQkJdmFyIHRlbXAgPSByb290Tm9kZS5yYXcoIHN1YnNjcmliZXIgKTsKCQkJCWlmIChpc0Z1bmN0aW9uKCB0ZW1wICkpIHsKCgkJCQkJaGFuZGxlciA9IHsKCQkJCQkJZ2V0OiByb290Tm9kZS5yYXcoIHN1YnNjcmliZXIgKQoJCQkJCX07CgoJCQkJfSBlbHNlIGlmIChpc09iamVjdCggdGVtcCApICYmIHRlbXAuZ2V0KSB7CgoJCQkJCWhhbmRsZXIgPSB0ZW1wOwoKCQkJCX0gZWxzZSB7CgkJCQkJdGhyb3cgIm1pc3NpbmcgaGFuZGxlciI7CgkJCQl9CgkJCX0KCgkJfSBlbHNlIHsKCQkJLy92aWV3IHN1YnNjcmliZSB2aWV3J3MgZXZlbnQKCQkJLy90aGlzIGlzIHJhcmVseSB0aGUgY2FzZSwgYnV0IGl0IGlzIHN0aWxsIHN1cHBvcnRlZAoJCQkvL2ZvciBleGFtcGxlLCBhIGxhYmVsIHN1YnNjcmliZSB0aGUgY2hhbmdlIG9mIGFub3RoZXIgbGFiZWwKCQkJLy8kKCIjbGFibGUyIikuc3ViKCIjbGFibGUxIiwgInRleHQiKTsKCQkJaGFuZGxlciA9IHsKCQkJCWdldDogYWN0aXZpdHlOYW1lLAoJCQkJc2V0OiBhY3Rpdml0eU5hbWUKCQkJfTsKCQl9CgoJCXJldHVybiBoYW5kbGVyOwoJfQoKCWZ1bmN0aW9uIGJ1aWxkV29ya2Zsb3coIHdvcmtmbG93UHJvdG90eXBlICkgewoKCQl2YXIgd29ya2Zsb3c7CgoJCWlmIChpc1N0cmluZyggd29ya2Zsb3dQcm90b3R5cGUgKSkgewoKCQkJd29ya2Zsb3cgPSBidWlsZFdvcmtmbG93RnJvbVN0cmluZyggd29ya2Zsb3dQcm90b3R5cGUgKTsKCgkJfSBlbHNlIGlmIChpc0Z1bmN0aW9uKCB3b3JrZmxvd1Byb3RvdHlwZSApIHx8IChpc09iamVjdCggd29ya2Zsb3dQcm90b3R5cGUgKSAmJiB3b3JrZmxvd1Byb3RvdHlwZS5nZXQpKSB7CgoJCQl3b3JrZmxvdyA9IHdvcmtmbG93UHJvdG90eXBlOwoJCQlpZiAoaXNGdW5jdGlvbiggd29ya2Zsb3dQcm90b3R5cGUgKSkgewoKCQkJCXdvcmtmbG93ID0gZXh0ZW5kKAoJCQkJCXsKCQkJCQkJZ2V0OiB3b3JrZmxvd1Byb3RvdHlwZQoJCQkJCX0sCgkJCQkJd29ya2Zsb3cgKTsKCQkJfQoKCQl9IGVsc2UgewoJCQl0aHJvdyAiaW52YWxpZCB3b3JrZmxvdyBleHByZXNzaW9uIjsKCQl9CgoJCWNvbnZlcnRTdHJpbmdBY3Rpdml0eVRvRnVuY3Rpb24oICJpbml0aWFsaXplIiwgd29ya2Zsb3cgKTsKCQkvLwoJCWNvbnZlcnRTdHJpbmdBY2Nlc3NvclRvRnVuY3Rpb24oICJnZXQiLCB3b3JrZmxvdyApOwoJCWNvbnZlcnRTdHJpbmdBY2Nlc3NvclRvRnVuY3Rpb24oICJzZXQiLCB3b3JrZmxvdyApOwoJCS8vCgkJY29udmVydFN0cmluZ0FjdGl2aXR5VG9GdW5jdGlvbiggImNvbnZlcnQiLCB3b3JrZmxvdyApOwoJCWNvbnZlcnRTdHJpbmdBY3Rpdml0eVRvRnVuY3Rpb24oICJmaW5hbGl6ZSIsIHdvcmtmbG93ICk7CgoJCXJldHVybiB3b3JrZmxvdzsKCX0KCglmdW5jdGlvbiBidWlsZFdvcmtmbG93RnJvbVN0cmluZyggd29ya2Zsb3dTdHJpbmcgKSB7CgoJCXZhciB3b3JrZmxvdywKCQkJYWN0aXZpdHlOYW1lLAoJCQlhY3Rpdml0eU5hbWVzID0gd29ya2Zsb3dTdHJpbmcuc3BsaXQoIHJTcGFjZXMgKSwKCQkJYWN0aXZpdHlUeXBlOwoKCQlpZiAoYWN0aXZpdHlOYW1lcy5sZW5ndGggPiAxKSB7CgoJCQl3b3JrZmxvdyA9IHsgfTsKCgkJCWZvciAodmFyIGkgPSAwOyBpIDwgYWN0aXZpdHlUeXBlcy5sZW5ndGg7IGkrKykgewoJCQkJYWN0aXZpdHlOYW1lID0gYWN0aXZpdHlOYW1lc1tpXTsKCQkJCWFjdGl2aXR5VHlwZSA9IGFjdGl2aXR5VHlwZXNbaV07CgoJCQkJaWYgKGFjdGl2aXR5TmFtZSAmJiAoYWN0aXZpdHlOYW1lICE9PSAiXyIgJiYgYWN0aXZpdHlOYW1lICE9ICJudWxsIikpIHsKCQkJCQl3b3JrZmxvd1thY3Rpdml0eVR5cGVdID0gYWN0aXZpdHlOYW1lOwoJCQkJfQoJCQl9CgkJfSBlbHNlIHsKCQkJdGhyb3cgImludmFsaWQgd29ya2Zsb3cgdHlwZSI7CgkJfQoKCQlyZXR1cm4gd29ya2Zsb3c7Cgl9CgoJZnVuY3Rpb24gZ2V0QWN0aXZpdHlTZXQoIGFjdGl2aXR5VHlwZSApIHsKCQlyZXR1cm4gaG0uYWN0aXZpdHlbYWN0aXZpdHlUeXBlXTsKCX0KCgkvLyBwdWJsaXNoZXIsIHN1YnNjcmliZXIgaXMgb3B0aW9uYWwKCS8vYWNjZXNzb3IgZWl0aGVyICJnZXQiIG9yICJzZXQiCglmdW5jdGlvbiBjb252ZXJ0U3RyaW5nQWNjZXNzb3JUb0Z1bmN0aW9uKCBhY2Nlc3NvclR5cGUsIGhhbmRsZXIsIHB1Ymxpc2hlciwgc3Vic2NyaWJlciApIHsKCgkJLy9ieSBkZWZhdWx0IHdvcmtmbG93LmdldCA9PSAiZ2V0Iiwgd29ya2Zsb3cuc2V0ID0gInNldCIKCQl2YXIgYWNjZXNzb3JLZXkgPSBoYW5kbGVyW2FjY2Vzc29yVHlwZV07CgoJCWlmIChhY2Nlc3NvcktleSAmJiBpc1N0cmluZyggYWNjZXNzb3JLZXkgKSkgewoKCQkJdmFyIGFjY2Vzc29ycyA9IGdldEFjdGl2aXR5U2V0KCBhY2Nlc3NvclR5cGUgKTsKCgkJCWlmIChhY2Nlc3NvcktleS5zdGFydHNXaXRoKCAiKiIgKSkgewoKCQkJCWFjY2Vzc29yS2V5ID0gYWNjZXNzb3JLZXkuc3Vic3RyKCAxICk7CgkJCQloYW5kbGVyW2FjY2Vzc29yVHlwZV0gPSBhY2Nlc3NvcnNbYWNjZXNzb3JLZXldOwoKCQkJCWlmICghaGFuZGxlclthY2Nlc3NvclR5cGVdKSB7CgkJCQkJdGhyb3cgYWNjZXNzb3JLZXkgKyAiIGRvZXMgbm90IGV4aXN0cyAiICsgYWNjZXNzb3JUeXBlICsgIiBBY3Rpdml0eSI7CgkJCQl9CgoJCQl9IGVsc2UgaWYgKGFjY2Vzc29yS2V5LnN0YXJ0c1dpdGgoICIjIiApKSB7CgoJCQkJaGFuZGxlclthY2Nlc3NvclR5cGVdID0gZ2V0RW1iZWRkZWRBY3Rpdml0eSggYWNjZXNzb3JLZXksIHB1Ymxpc2hlciwgc3Vic2NyaWJlciApOwoKCQkJfSBlbHNlIHsKCgkJCQl2YXIga2V5cyA9IGFjY2Vzc29yS2V5LnNwbGl0KCAiKiIgKTsKCgkJCQkvL3VzZSBkZWZhdWx0R2V0IG9yIGRlZmF1bHRTZXQgYW5kIHBhcnNlU3VicywgaWYgYWNjZXNzb3JLZXkgZG9lcyBub3QgYmVnaW4gd2l0aCAiKiIKCQkJCS8vIGhhbmRsZXIuc2V0UHJvcGVydHkgPSBhY2Nlc3NvcktleSBvcgoJCQkJLy8gaGFuZGxlci5nZXRQcm9wZXJ0eSA9IGFjY2Vzc29yS2V5CgkJCQloYW5kbGVyW2FjY2Vzc29yVHlwZV0gPSBhY2Nlc3NvclR5cGUgPT0gImdldCIgPyBnZXRNZW1iZXIgOiBzZXRNZW1iZXI7CgkJCQloYW5kbGVyW2FjY2Vzc29yVHlwZSArICJOYW1lIl0gPSBrZXlzWzBdOwoKCQkJCWlmIChrZXlzWzFdKSB7CgkJCQkJLy9hY2Nlc3NvcktleSA9ICJjc3MqY29sb3IiCgkJCQkJaGFuZGxlclthY2Nlc3NvclR5cGUgKyAiUGFyYXMiXSA9IGtleXNbMV07CgkJCQl9CgoJCQkJaWYgKCFpc1VuZGVmaW5lZCggcHVibGlzaGVyICkgJiYgIWlzVW5kZWZpbmVkKCBzdWJzY3JpYmVyICkpIHsKCQkJCQl2YXIgcHVibGlzaGVyT3JTdWJzY3JpYmVyID0gYWNjZXNzb3JUeXBlID09ICJnZXQiID8gcHVibGlzaGVyIDogc3Vic2NyaWJlcjsKCQkJCQllbnN1cmVUYXJnZXRIYXNBY2Nlc3NvciggYWNjZXNzb3JUeXBlLCBrZXlzWzBdLCBwdWJsaXNoZXJPclN1YnNjcmliZXIgKTsKCQkJCX0KCQkJfQoJCX0KCX0KCglmdW5jdGlvbiBlbnN1cmVUYXJnZXRIYXNBY2Nlc3NvciggYWNjZXNzb3JUeXBlLCBhY3Rpdml0eU5hbWUsIHRhcmdldCApIHsKCQl2YXIgbWlzc2luZ01lbWJlcjsKCQlpZiAoaXNTdHJpbmcoIHRhcmdldCApKSB7CgoJCQlpZiAoIWhtRm5bYWN0aXZpdHlOYW1lXSkgewoKCQkJCW1pc3NpbmdNZW1iZXIgPSB0cnVlOwoJCQl9CgoJCX0gZWxzZSB7CgkJCWlmICh0YXJnZXQubm9kZVR5cGUpIHsKCQkJCWlmICghJGZuW2FjdGl2aXR5TmFtZV0pIHsKCQkJCQltaXNzaW5nTWVtYmVyID0gdHJ1ZTsKCQkJCX0KCQkJfSBlbHNlIGlmICghKGFjdGl2aXR5TmFtZSBpbiB0YXJnZXQpKSB7CgkJCQltaXNzaW5nTWVtYmVyID0gdHJ1ZTsKCQkJfQoJCX0KCgkJaWYgKG1pc3NpbmdNZW1iZXIpIHsKCQkJdGhyb3cgKGFjY2Vzc29yVHlwZSA9PSAiZ2V0IiA/ICJwdWJsaXNoZXIiIDogInN1YnNjcmliZXIiKSArCgkJCSAgICAgICIgZG9lcyBub3QgaGF2ZSBhIG1lbWJlciAiICsgYWN0aXZpdHlOYW1lOwoJCX0KCX0KCgkvL2FjdGl2aXR5VHlwZSBpcyBsaWtlIGluaXRpYWxpemUsIGNvbnZlcnQsIGZpbmFsaXplCgkvL2FjdGl2aXR5VHlwZSBmb3IgImdldCIsICJzZXQiIGlzIHRha2VuIGNhcmUgYnkgY29udmVydFN0cmluZ0FjY2Vzc29yVG9GdW5jdGlvbgoJZnVuY3Rpb24gY29udmVydFN0cmluZ0FjdGl2aXR5VG9GdW5jdGlvbiggYWN0aXZpdHlUeXBlLCBoYW5kbGVyLCBwdWJsaXNoZXIsIHN1YnNjcmliZXIgKSB7CgkJLy9iZWNhdXNlIGl0IGlzIG9wdGlvbmFsLCB3ZSBuZWVkIG1ha2Ugc3VyZSBoYW5kbGVyIHdhbnQgdG8gaGF2ZSB0aGlzIG1ldGhvZAoJCXZhciBhY3Rpdml0eU5hbWUgPSBoYW5kbGVyW2FjdGl2aXR5VHlwZV07CgkJaWYgKGlzU3RyaW5nKCBhY3Rpdml0eU5hbWUgKSkgewoKCQkJaWYgKGFjdGl2aXR5TmFtZS5zdGFydHNXaXRoKCAiKiIgKSkgewoJCQkJaGFuZGxlclthY3Rpdml0eVR5cGVdID0gZ2V0QWN0aXZpdHlTZXQoIGFjdGl2aXR5VHlwZSApW2FjdGl2aXR5TmFtZS5zdWJzdHIoIDEgKV07CgkJCQlpZiAoIWhhbmRsZXJbYWN0aXZpdHlUeXBlXSkgewoJCQkJCXRocm93ICBhY3Rpdml0eU5hbWUgKyAiQWN0aXZpdHkgZG9lcyBub3QgZXhpc3RzIjsKCQkJCX0KCgkJCX0gZWxzZSBpZiAoYWN0aXZpdHlOYW1lLnN0YXJ0c1dpdGgoICIjIiApKSB7CgoJCQkJaGFuZGxlclthY3Rpdml0eVR5cGVdID0gZ2V0RW1iZWRkZWRBY3Rpdml0eSggYWN0aXZpdHlOYW1lLCBwdWJsaXNoZXIsIHN1YnNjcmliZXIgKTsKCgkJCX0gZWxzZSB7CgkJCQl0aHJvdyAnYWN0aXZpdHkgb3RoZXIgdGhhbiAiZ2V0IiBhbmQgInNldCIgIG11c3QgYmVnaW4gd2l0aCAiKiIgb3IgIiMiICc7CgoJCQl9CgkJfQoJfQoKCWZ1bmN0aW9uIHVuc3Vic2NyaWJlKCB0YXJnZXQgKSB7CgkJaWYgKGlzT2JqZWN0KCB0YXJnZXQgKSkgewoJCQlpZiAoIXZpZXdJZE1hbmFnZXIuZ2V0SWQoIHRhcmdldCApKSB7CgkJCQlyZXR1cm47CgkJCX0KCQkJdmlld0lkTWFuYWdlci51bk1hcmsoIHRhcmdldCApOwoJCX0KCQlzdWJzY3JpcHRpb25NYW5hZ2VyLnJlbW92ZUJ5KCB0YXJnZXQgKTsKCX0KCglobS5vbkRlbGV0ZU5vZGUoIHVuc3Vic2NyaWJlICk7CgoJLy9zdWJzY3JpcHRpb24gc2hvcnRjdXQgbWV0aG9kIGZvciBtb2RlbAoJZXh0ZW5kKCBobUZuLCB7CgoJCXRyaWdnZXI6IGZ1bmN0aW9uKCBzdWJQYXRoLCBldmVudE5hbWUsIHByb3Bvc2VkLCByZW1vdmVkICkgewoKCQkJaWYgKCFhcmd1bWVudHMubGVuZ3RoKSB7CgkJCQl0aHJvdyAibWlzc2luZyBhcmd1bWVudHMiOwoJCQl9CgoJCQlpZiAoYXJndW1lbnRzLmxlbmd0aCA8PSAzKSB7CgkJCQlyZW1vdmVkID0gcHJvcG9zZWQ7CgkJCQlwcm9wb3NlZCA9IGV2ZW50TmFtZTsKCQkJCWV2ZW50TmFtZSA9IHN1YlBhdGg7CgkJCQlzdWJQYXRoID0gIiI7CgkJCX0KCgkJCXZhciBwaHlzaWNhbFBhdGggPSB0aGlzLnBoeXNpY2FsUGF0aCggc3ViUGF0aCApOwoJCQl0cmlnZ2VyKCBwaHlzaWNhbFBhdGgsIHBoeXNpY2FsUGF0aCwgZXZlbnROYW1lLCBwcm9wb3NlZCwgcmVtb3ZlZCApOwoJCQlyZXR1cm4gdGhpczsKCQl9LAoKCQljaGFuZ2U6IGZ1bmN0aW9uKCBzdWJQYXRoICkgewoJCQl2YXIgcGh5c2ljYWxQYXRoID0gdGhpcy5waHlzaWNhbFBhdGgoIHN1YlBhdGggKSwKCQkJCXZhbHVlID0gdGhpcy5nZXQoIHN1YlBhdGggKTsKCQkJdHJpZ2dlciggcGh5c2ljYWxQYXRoLCBwaHlzaWNhbFBhdGgsICJhZnRlclVwZGF0ZSIsIHZhbHVlLCB2YWx1ZSApOwoJCQlyZXR1cm4gdGhpczsKCQl9LAoKCQlzdWI6IGZ1bmN0aW9uKCBwdWJsaXNoZXIsIGV2ZW50cywgaGFuZGxlciwgb3B0aW9ucywgZGVsZWdhdGVTZWxlY3RvciApIHsKCQkJaG0uc3ViKCB0aGlzLnBhdGgsIHB1Ymxpc2hlciwgZXZlbnRzLCBoYW5kbGVyLCBvcHRpb25zLCBkZWxlZ2F0ZVNlbGVjdG9yICk7CgkJCXJldHVybiB0aGlzOwoJCX0sCgoJCWhhbmRsZTogZnVuY3Rpb24oIGV2ZW50VHlwZXMsIHdvcmtmbG93LCB3b3JrZmxvd09wdGlvbnMsIGRlbGVnYXRlICkgewoJCQlobS5zdWIoIG51bGwsIHRoaXMsIGV2ZW50VHlwZXMsIHdvcmtmbG93LCB3b3JrZmxvd09wdGlvbnMsIGRlbGVnYXRlICk7CgkJCXJldHVybiB0aGlzOwoJCX0sCgoJCXN1YkJ5OiBmdW5jdGlvbiggc3Vic2NyaWJlciwgZXZlbnRzLCBoYW5kbGVyLCBvcHRpb25zLCBkZWxlZ2F0ZVNlbGVjdG9yICkgewoJCQlobS5zdWIoIHN1YnNjcmliZXIsIHRoaXMucGF0aCwgZXZlbnRzLCBoYW5kbGVyLCBvcHRpb25zLCBkZWxlZ2F0ZVNlbGVjdG9yICk7CgkJCXJldHVybiB0aGlzOwoJCX0sCgoJCXN1YnNUb01lOiBmdW5jdGlvbiggcHJpbnQgKSB7CgkJCXZhciBydG4gPSBzdWJzY3JpcHRpb25NYW5hZ2VyLmdldEJ5UHVibGlzaGVyKCB0aGlzLnBhdGggKTsKCQkJLy8jZGVidWcKCQkJaWYgKHByaW50ICYmIGhtLnByaW50U3Vic2NyaXB0aW9ucykgewoJCQkJaG0ucHJpbnRTdWJzY3JpcHRpb25zKCB0aGlzLnBhdGgsIHJ0biwgInRvTWUiICk7CgkJCX0KCQkJLy8jZW5kX2RlYnVnCgoJCQlyZXR1cm4gcnRuOwoJCX0sCgoJCXN1YnNGcm9tTWU6IGZ1bmN0aW9uKCBwcmludCApIHsKCQkJdmFyIHJ0biA9IHN1YnNjcmlwdGlvbk1hbmFnZXIuZ2V0QnlTdWJzY3JpYmVyKCB0aGlzLnBhdGggKTsKCQkJLy8jZGVidWcKCQkJaWYgKHByaW50ICYmIGhtLnByaW50U3Vic2NyaXB0aW9ucykgewoJCQkJaG0ucHJpbnRTdWJzY3JpcHRpb25zKCB0aGlzLnBhdGgsIHJ0biwgImZyb21NZSIgKTsKCQkJfQoJCQkvLyNlbmRfZGVidWcKCgkJCXJldHVybiBydG47CgkJfSwKCgkJc3ViczogZnVuY3Rpb24oIHByaW50ICkgewoJCQl2YXIgcnRuID0gc3Vic2NyaXB0aW9uTWFuYWdlci5nZXRCeSggdGhpcy5wYXRoICk7CgoJCQkvLyNkZWJ1ZwoJCQlpZiAocHJpbnQgJiYgaG0ucHJpbnRTdWJzY3JpcHRpb25zKSB7CgkJCQlobS5wcmludFN1YnNjcmlwdGlvbnMoIHRoaXMucGF0aCwgcnRuICk7CgkJCX0KCQkJLy8jZW5kX2RlYnVnCgoJCQlyZXR1cm4gcnRuOwoJCX0sCgoJCS8qCgkJIG1hcCBhbiBtb2RlbCBldmVudCB0byBhIG5ldyBtb2RlbCBldmVudCBiYXNlZCBvbiBhIGNvbmRpdGlvbiwgbGlrZSB0aGUgZm9sbG93aW5nCgoJCSBobSgiaW52ZW50b3J5IikubWFwRXZlbnQoCgkJICJhZnRlclVwZGF0ZSIsCgkJICJpbnZlbnRvcnlMb3ciLAoJCSBmdW5jdGlvbiAodmFsdWUpIHsKCQkgcmV0dXJuIHZhbHVlIDw9IDEwMDsKCQkgfQoJCSApOwoKCQkgY29uZGl0aW9uIGlzIG9wdGlvbmFsLCBpZiBpdCBpcyBtaXNzaW5nLCB0aGUgdGFyZ2V0IGV2ZW50IHdpbGwgYWx3YXlzIGJlIHRyaWdnZXJlZAoJCSB3aGVuIHRoZSBzb3VyY2UgZXZlbnQgaXMgdHJpZ2dlcmVkCgkJICovCgkJbWFwRXZlbnQ6IGZ1bmN0aW9uKCBzb3VyY2VFdmVudCwgdGFyZ2V0RXZlbnQsIGNvbmRpdGlvbiApIHsKCQkJY29uZGl0aW9uID0gY29uZGl0aW9uIHx8IHJldHVyblRydWU7CgkJCWhtLmhhbmRsZSggdGhpcy5wYXRoLCBzb3VyY2VFdmVudCwgZnVuY3Rpb24oIGUgKSB7CgkJCQlpZiAoY29uZGl0aW9uLmNhbGwoIHRoaXMsIGUgKSkgewoJCQkJCWUucHVibGlzaGVyLnRyaWdnZXIoIHRhcmdldEV2ZW50LCBlLnByb3Bvc2VkLCBlLnJlbW92ZWQgKTsKCQkJCX0KCQkJfSApOwoJCQlyZXR1cm4gdGhpczsKCQl9LAoKCQljYWNoZWFibGU6IGZ1bmN0aW9uKCBzdWJQYXRoICkgewoJCQlobS5oYW5kbGUoIHRoaXMuZ2V0UGF0aCggc3ViUGF0aCApLCAiaW5pdCBhZnRlcioiLCAiKnNhdmVMb2NhbCIgKTsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCX0gKTsKCgkvL3N1YnNjcmlwdGlvbiBzaG9ydGN1dCBtZXRob2QgZm9yIGpRdWVyeSBvYmplY3QKCWV4dGVuZCggJGZuLCB7CgoJCXN1YjogZnVuY3Rpb24oIHB1Ymxpc2hlciwgZXZlbnRzLCBoYW5kbGVyLCBvcHRpb25zLCBkZWxlZ2F0ZSApIHsKCQkJaWYgKHRoaXMubGVuZ3RoKSB7CgkJCQlobS5zdWIoIHRoaXMsIHB1Ymxpc2hlciwgZXZlbnRzLCBoYW5kbGVyLCBvcHRpb25zLCBkZWxlZ2F0ZSApOwoJCQl9CgkJCXJldHVybiB0aGlzOwoJCX0sCgoJCWhhbmRsZTogZnVuY3Rpb24oIGV2ZW50VHlwZXMsIHdvcmtmbG93LCB3b3JrZmxvd09wdGlvbnMsIGRlbGVnYXRlICkgewoJCQlpZiAodGhpcy5sZW5ndGgpIHsKCQkJCWhtLnN1YiggbnVsbCwgdGhpcywgZXZlbnRUeXBlcywgd29ya2Zsb3csIHdvcmtmbG93T3B0aW9ucywgZGVsZWdhdGUgKTsKCQkJfQoJCQlyZXR1cm4gdGhpczsKCQl9LAoKCQlzdWJCeTogZnVuY3Rpb24oIHN1YnNjcmliZXIsIGV2ZW50cywgaGFuZGxlciwgb3B0aW9ucywgZGVsZWdhdGUgKSB7CgkJCWlmICh0aGlzLmxlbmd0aCkgewoJCQkJaG0uc3ViKCBzdWJzY3JpYmVyLCB0aGlzLCBldmVudHMsIGhhbmRsZXIsIG9wdGlvbnMsIGRlbGVnYXRlICk7CgkJCX0KCQkJcmV0dXJuIHRoaXM7CgkJfSwKCgkJc3Vic1RvTWU6IGZ1bmN0aW9uKCBwcmludCApIHsKCQkJdmFyIHJ0biA9IHN1YnNjcmlwdGlvbk1hbmFnZXIuZ2V0QnlQdWJsaXNoZXIoIHRoaXNbMF0gKTsKCgkJCS8vI2RlYnVnCgkJCWlmIChwcmludCAmJiBobS5wcmludFN1YnNjcmlwdGlvbnMpIHsKCQkJCWhtLnByaW50U3Vic2NyaXB0aW9ucyggdGhpc1swXSwgcnRuLCAidG9NZSIgKTsKCQkJfQoJCQkvLyNlbmRfZGVidWcKCgkJCXJldHVybiBydG47CgkJfSwKCgkJc3Vic0Zyb21NZTogZnVuY3Rpb24oIHByaW50ICkgewoJCQl2YXIgcnRuID0gc3Vic2NyaXB0aW9uTWFuYWdlci5nZXRCeVN1YnNjcmliZXIoIHRoaXNbMF0gKTsKCgkJCS8vI2RlYnVnCgkJCWlmIChwcmludCAmJiBobS5wcmludFN1YnNjcmlwdGlvbnMpIHsKCQkJCWhtLnByaW50U3Vic2NyaXB0aW9ucyggdGhpc1swXSwgcnRuLCAiZnJvbU1lIiApOwoJCQl9CgkJCS8vI2VuZF9kZWJ1ZwoKCQkJcmV0dXJuIHJ0bjsKCQl9LAoKCQlzdWJzOiBmdW5jdGlvbiggcHJpbnQgKSB7CgkJCXZhciBydG4gPSBzdWJzY3JpcHRpb25NYW5hZ2VyLmdldEJ5KCB0aGlzWzBdICk7CgoJCQkvLyNkZWJ1ZwoJCQlpZiAocHJpbnQgJiYgaG0ucHJpbnRTdWJzY3JpcHRpb25zKSB7CgkJCQlobS5wcmludFN1YnNjcmlwdGlvbnMoIHRoaXNbMF0sIHJ0biApOwoJCQl9CgkJCS8vI2VuZF9kZWJ1ZwoKCQkJcmV0dXJuIHJ0bjsKCQl9LAoKCQlyZW5kZXJWaWV3OiBmdW5jdGlvbiggcGF0aCwgd29ya2Zsb3csIG9wdGlvbnMgKSB7CgkJCWhtLnN1YiggdGhpcywgcGF0aCwgImluaXQiLCB3b3JrZmxvdywgb3B0aW9ucyApOwoJCQlyZXR1cm4gdGhpczsKCQl9LAoKCQkvKgoJCSBtYXAgYSB2aWV3IGV2ZW50IHRvIGEgbmV3IHZpZXcgZXZlbnQgYmFzZWQgb24gYSBjb25kaXRpb24sIGNvbmRpdGlvbiBpcyBvcHRpb25hbCwKCQkgaWYgaXQgaXMgbWlzc2luZywgdGhlIHRhcmdldCBldmVudCB3aWxsIGFsd2F5cyBiZSB0cmlnZ2VyZWQgd2hlbiB0aGUgc291cmNlCgkJIGV2ZW50IGlzIHRyaWdnZXJlZAoKCQkgdXNhZ2UKCQkgJCgiYnV0dG9uIikubWFwRXZlbnQoImNsaWNrIiwgInVwZGF0ZSIpOwoJCSAqLwoJCW1hcEV2ZW50OiBmdW5jdGlvbiggc291cmNlRXZlbnQsIHRhcmdldEV2ZW50LCBjb25kaXRpb24sIGV2ZW50RGF0YSApIHsKCQkJaWYgKGNvbmRpdGlvbikgewoJCQkJaWYgKCFpc0Z1bmN0aW9uKCBjb25kaXRpb24gKSkgewoJCQkJCWV2ZW50RGF0YSA9IGNvbmRpdGlvbjsKCQkJCQljb25kaXRpb24gPSByZXR1cm5UcnVlOwoJCQkJfQoJCQl9IGVsc2UgewoJCQkJY29uZGl0aW9uID0gcmV0dXJuVHJ1ZTsKCQkJfQoKCQkJcmV0dXJuIHRoaXMuaGFuZGxlKCBzb3VyY2VFdmVudCwgZnVuY3Rpb24oIGUgKSB7CgkJCQlpZiAoY29uZGl0aW9uLmNhbGwoIHRoaXMsIGUgKSkgewoJCQkJCWUudHlwZSA9IHRhcmdldEV2ZW50OwoJCQkJCWUuZXZlbnREYXRhID0gZXZlbnREYXRhOwoJCQkJCWUucHVibGlzaGVyLnRyaWdnZXIoIGUgKTsKCQkJCX0KCQkJfSApOwoJCX0KCX0gKTsKCgkvLyBjcmVhdGUgYSBzcGVjaWFsIGpRdWVyeSBldmVudCAoeSkgYmFzZWQgb24gYW4gZXhpc3RpbmcgalF1ZXJ5IGV2ZW50ICh4KQoJLy8gd2hlbiBldmVudCB4IGlzIHJhaXNlZCwgYW5kIGNvbmRpdGlvbiByZXR1cm5zIHRydWUsIGV2ZW50IHkgd2lsbCBiZSByYWlzZWQKCS8vCgkvLyB5b3UgY2FuIHN1YnNjcmliZSBldmVudCB5LCBqdXN0IGxpa2UgYW55IG90aGVyIGpRdWVyeSBldmVudCB1c2luZwoJLy8kKCJidXR0b24iKS5iaW5kKCJ5IiwgZm4pOwoJLy8KCS8vdW5saWtlICQoKS5tYXBFdmVudCgiY2xpY2siLCAieSIpLCB0aGlzIG1ldGhvZCBjcmVhdGUgYSBuZXcgZXZlbnQgdHlwZSBmb3IgYWxsCgkvL2pRdWVyeSBvYmplY3QKCWhtLm5ld0pxRXZlbnQgPSBmdW5jdGlvbiggZXZlbnQsIGJhc2VFdmVudCwgY29uZGl0aW9uICkgewoJCWlmIChpc09iamVjdCggZXZlbnQgKSkgewoJCQlmb3IgKHZhciBrZXkgaW4gZXZlbnQpIHsKCQkJCWhtLm5ld0pxRXZlbnQoIGtleSwgZXZlbnRba2V5XVswXSwgZXZlbnRba2V5XVsxXSApOwoJCQl9CgkJCXJldHVybiB0aGlzOwoJCX0KCQl2YXIgaGFuZGxlciA9IGZ1bmN0aW9uKCBlICkgewoJCQlpZiAoY29uZGl0aW9uID09PSB0cnVlIHx8IGNvbmRpdGlvbi5jYWxsKCB0aGlzLCBlICkpIHsKCQkJCSQoIGUudGFyZ2V0ICkudHJpZ2dlciggZXh0ZW5kKCB7fSwgZSwgewoJCQkJCXR5cGU6IGV2ZW50LAoJCQkJCWN1cnJlbnRUYXJnZXQ6IGUudGFyZ2V0CgkJCQl9ICkgKTsKCQkJfQoJCX07CgoJCWlmICgkLmV2ZW50LnNwZWNpYWxbZXZlbnRdKSB7CgkJCXRocm93ICJldmVudCAnIiArIGV2ZW50ICsgIicgaGFzIGJlZW4gZGVmaW5lZCI7CgkJfQoKCQkkLmV2ZW50LnNwZWNpYWxbZXZlbnRdID0gewoJCQlzZXR1cDogZnVuY3Rpb24oKSB7CgkJCQkkKCB0aGlzICkuYmluZCggYmFzZUV2ZW50LCBoYW5kbGVyICk7CgkJCX0sCgkJCXRlYXJkb3duOiBmdW5jdGlvbigpIHsKCQkJCSQoIHRoaXMgKS51bmJpbmQoIGJhc2VFdmVudCwgaGFuZGxlciApOwoJCQl9CgkJfTsKCQlyZXR1cm4gdGhpczsKCX07CgoJdmFyIF9jbGVhbkRhdGFGb3JVbnN1YnNjcmliZSA9ICQuY2xlYW5EYXRhOwoJLy93aGVuIGFuIGRvbSBlbGVtZW50IGlzIHJlbW92ZSB1bnN1YnNjcmliZSBpdCBmaXJzdAoJJC5jbGVhbkRhdGEgPSBmdW5jdGlvbiggZWxlbXMgKSB7CgkJJCggZWxlbXMgKS5lYWNoKCBmdW5jdGlvbigpIHsKCQkJdW5zdWJzY3JpYmUoIHRoaXMgKTsKCQl9ICk7CgkJX2NsZWFuRGF0YUZvclVuc3Vic2NyaWJlKCBlbGVtcyApOwoJfTsKCgl1dGlsLmdldFVuaXF1ZVZpZXdFdmVudFR5cGVzID0gYnVpbGRVbmlxdWVWaWV3RXZlbnRUeXBlczsKCXV0aWwuX3ZpZXdIYW5kbGVyR2F0ZXdheSA9IHZpZXdIYW5kbGVyR2F0ZXdheTsKCgkvLyNkZWJ1ZwoJaG0uZGVidWcuZ2V0TWF0Y2hlZFN1YnNjcmliZWRFdmVudCA9IGdldE1hdGNoZWRTdWJzY3JpYmVkRXZlbnQ7CglobS5kZWJ1Zy5idWlsZFdvcmtmbG93VHlwZSA9IGJ1aWxkV29ya2Zsb3c7CglobS5kZWJ1Zy5nZXRNZW1iZXIgPSBnZXRNZW1iZXI7CglobS5kZWJ1Zy5zZXRNZW1iZXIgPSBzZXRNZW1iZXI7CglobS5kZWJ1Zy51bnN1YiA9IGZ1bmN0aW9uKCBvYmplY3QgKSB7CgkJdW5zdWJzY3JpYmUoIG9iamVjdCApOwoJfTsKCS8vI2VuZF9kZWJ1ZwoKCi8vCi8vPEBkZXBlbmRzPnN1YnNjcmlwdGlvbi5qcywgbW9kZWwuanM8L0BkZXBlbmRzPgoKCgl2YXIgclN1YnNjcmlwdGlvblByb3BlcnR5ID0gLyhbISRdPykoW1x3IFwrXC1cKlwuXSs/KTooW1x3XFddKz8pXHMqKD86WztdXHMqfCQpL2csCgkJckJpbmRpbmdUZXh0ID0gL14oW158XSspKFx8KC4qKSk/JC8sCgkJclN1YnNjcmlwdGlvblZhbHVlU2VwYXJhdG9yID0gL1xzKlx8XHMqL2c7CgoJZGVmYXVsdE9wdGlvbnMuc3Vic0F0dHIgPSAiZGF0YS1zdWIiOwoJZGVmYXVsdE9wdGlvbnMuYXV0b1BhcnNlID0gdHJ1ZTsKCglmdW5jdGlvbiBtZXJnZU9wdGlvbnMoIHBhcmVudE9wdGlvbnMsIGxvY2FsT3B0aW9ucyApIHsKCQlpZiAobG9jYWxPcHRpb25zICE9PSAiXyIpIHsKCQkJcmV0dXJuICAobG9jYWxPcHRpb25zICYmIGxvY2FsT3B0aW9ucy5zdGFydHNXaXRoKCAiXyIgKSkgPwoJCQkJbG9jYWxPcHRpb25zLnN1YnN0ciggMSApIDoKCQkJCXBhcmVudE9wdGlvbnMgfHwgbG9jYWxPcHRpb25zOwoJCX0KCX0KCglmdW5jdGlvbiBnZXRJbmhlcml0ZWROYW1lc3BhY2UoIGVsZW0gKSB7CgoJCXZhciAkcGFyZW50ID0gJCggZWxlbSApOwoKCQl3aGlsZSAoKCRwYXJlbnQgPSAkcGFyZW50LnBhcmVudCgpKSAmJiAkcGFyZW50Lmxlbmd0aCkgewoKCQkJdmFyIG5zID0gJHBhcmVudC5obURhdGEoICJucyIgKTsKCgkJCWlmICghaXNVbmRlZmluZWQoIG5zICkpIHsKCQkJCXJldHVybiBuczsKCQkJfQoJCX0KCQlyZXR1cm4gIiI7Cgl9CgoJdmFyIHJlVW5kZXJzY29yZSA9IC9fL2c7Cgl2YXIgcmVBdHRyRGFzaCA9IC8tKFx3KS9nOwoJdmFyIHJEYXRhQXR0clByZWZpeCA9IC9eZGF0YS0vOwoKCXZhciByZXBsYWNlQXR0ckRhc2hXaXRoQ2FwaXRhbENoYXJhY3RlciA9IGZ1bmN0aW9uKCBtYXRjaCwgJDEgKSB7CgkJcmV0dXJuICQxLnRvVXBwZXJDYXNlKCk7Cgl9OwoKCS8vY29udmVydCBhZGQtY2xhc3MgdG8gYWRkQ2xhc3MKCS8vY29udmVydCAkZW50ZXJfYmx1ciB0byAkZW50ZXIgYmx1cgoJZnVuY3Rpb24gbm9ybWFsaXplQXR0cmlidXRlTmFtZSggYXR0cmlidXRlTmFtZSApIHsKCQlhdHRyaWJ1dGVOYW1lID0gYXR0cmlidXRlTmFtZS5yZXBsYWNlKCByRGF0YUF0dHJQcmVmaXgsICIiICk7CgoJCS8vaWYgc3Vic2NyaXB0aW9uIGludm9sdmUgd2l0aCBtb3JlIHRoYW4gb25lIGV2ZW50cywgeW91IGNhbgoJCS8vY29uY2F0ZW5hdGUgdGhlbSB3aXRoICJfIiwgaGVyZSB3ZSBuZWVkIHRvIHJldmVydCB0aGVtIGJhY2sKCQkvL3N1Y2ggYXMgIiRjbGlja19tb3VzZW92ZXIiIG5lZWQgdG8gYmUgY2hhbmdlZCB0byAiJGNsaWNrIG1vdXNlb3ZlciIKCQlpZiAoYXR0cmlidXRlTmFtZS5zdGFydHNXaXRoKCAiISIgKSB8fCBhdHRyaWJ1dGVOYW1lLnN0YXJ0c1dpdGgoICIkIiApKSB7CgoJCQlhdHRyaWJ1dGVOYW1lID0gYXR0cmlidXRlTmFtZS5yZXBsYWNlKCByZVVuZGVyc2NvcmUsICIgIiApOwoKCQl9CgkJcmV0dXJuIGF0dHJpYnV0ZU5hbWUucmVwbGFjZSggcmVBdHRyRGFzaCwgcmVwbGFjZUF0dHJEYXNoV2l0aENhcGl0YWxDaGFyYWN0ZXIgKTsKCX0KCglmdW5jdGlvbiBleHRyYWN0U3Vic2NyaXB0aW9uVGV4dCggZWxlbSApIHsKCQlpZiAoZWxlbS5ub2RlVHlwZSAhPT0gMSkgewoJCQlyZXR1cm47CgkJfQoJCXZhciBpLAoJCQlhdHRyLAoJCQlhdHRyaWJ1dGVOYW1lLAoJCQlhdHRyaWJ1dGVzID0gZWxlbS5hdHRyaWJ1dGVzLAoJCQlzdWJzY3JpcHRpb25UZXh0ID0gYXR0cmlidXRlc1tkZWZhdWx0T3B0aW9ucy5zdWJzQXR0cl0gJiYgYXR0cmlidXRlc1tkZWZhdWx0T3B0aW9ucy5zdWJzQXR0cl0ubm9kZVZhbHVlIHx8ICIiOwoKCQlmb3IgKGkgPSAwOyBpIDwgYXR0cmlidXRlcy5sZW5ndGg7IGkrKykgewoJCQlhdHRyID0gYXR0cmlidXRlc1tpXTsKCQkJaWYgKGF0dHIubmFtZSAhPT0gZGVmYXVsdE9wdGlvbnMuc3Vic0F0dHIpIHsKCQkJCWF0dHJpYnV0ZU5hbWUgPSBub3JtYWxpemVBdHRyaWJ1dGVOYW1lKCBhdHRyLm5hbWUgKTsKCQkJCS8vaWYgYXR0cmlidXRlTmFtZSBpcyByZWNvZ25pemVkIGJ5IHRoZSBIbS5qcywKCQkJCS8vIHN1Y2ggYXMgbnM9Inh4eCIsIGJpbmRpbmdOYW1lPSJ4eHgiLCAhZXZlbnQ9Inh4eCIgLCAkZXZlbnQ9Inh4eCIKCQkJCS8vZXh0cmFjdCB0aGVtIGFuZCBhcHBlbmQgdG8gdGhlIHN1YnNjcmlwdGlvbiB0ZXh0CgkJCQlpZiAoYXR0cmlidXRlTmFtZSA9PSAibnMiIHx8IF9iaW5kaW5nc1thdHRyaWJ1dGVOYW1lXSkgewoJCQkJCS8vaWYgdGhlIGF0dHJpYnV0ZSBkb2VzIG5vdCBoYXZlIGEgdmFsdWUgbGlrZSA8ZGl2IGRlYnVnPgoJCQkJCS8vaXQgaXMgdGhlIHNhbWUgYXMgPGRpdiBkZWJ1Zz0iLyI+CgkJCQkJc3Vic2NyaXB0aW9uVGV4dCA9IHN1YnNjcmlwdGlvblRleHQgKyAiOyIgKyBhdHRyaWJ1dGVOYW1lICsgIjoiICsgKGF0dHIubm9kZVZhbHVlIHx8ICIvIik7CgoJCQkJfSBlbHNlIGlmIChhdHRyaWJ1dGVOYW1lLnN0YXJ0c1dpdGgoICIhIiApIHx8IGF0dHJpYnV0ZU5hbWUuc3RhcnRzV2l0aCggIiQiICkpIHsKCQkJCQl2YXIgbm9kZVZhbHVlcyA9IGF0dHIubm9kZVZhbHVlLnNwbGl0KCAiOyIgKTsKCQkJCQlmb3IgKHZhciBqID0gMDsgaiA8IG5vZGVWYWx1ZXMubGVuZ3RoOyBqKyspIHsKCQkJCQkJdmFyIG5vZGVWYWx1ZSA9IG5vZGVWYWx1ZXNbal07CgkJCQkJCXN1YnNjcmlwdGlvblRleHQgPSBzdWJzY3JpcHRpb25UZXh0ICsgIjsiICsgYXR0cmlidXRlTmFtZSArICI6IiArIG5vZGVWYWx1ZTsKCQkJCQl9CgkJCQl9CgkJCX0KCQl9CgoJCXZhciB0YWdCaW5kaW5nTmFtZSA9ICJ0YWdfIiArIGVsZW0udGFnTmFtZTsKCQlpZiAoX2JpbmRpbmdzW3RhZ0JpbmRpbmdOYW1lXSkgewoJCQlzdWJzY3JpcHRpb25UZXh0ID0gc3Vic2NyaXB0aW9uVGV4dCArICI7IiArIHRhZ0JpbmRpbmdOYW1lICsgIjouIjsKCQl9CgkJcmV0dXJuIHN1YnNjcmlwdGlvblRleHQucmVwbGFjZSggL147LywgIiIgKTsKCX0KCgkvL3N1cHBvcnQKCS8vbmV3IEJpbmRpbmcoKQoJLy9uZXcgQmluZGluZyhzdWJzY3JpcHRpb25UZXh0LCBwYXJlbnRCaW5kaW5nKQoJLy9uZXcgQmluZGluZygiJGNsaWNrfCphbGVydDt2YWw6cGF0aCIsIHBhcmVudEJpbmRpbmcpOwoJZnVuY3Rpb24gQmluZGluZyggc3Vic2NyaXB0aW9uVGV4dCwgcGFyZW50QmluZGluZywgYmluZGluZ05zLCBiaW5kaW5nT3B0aW9ucyApIHsKCgkJdmFyIG5zUHJvcGVydHksIG1hdGNoLCBlbXB0eUJpbmRpbmc7CgoJCS8vaGFuZGxlIHRoZSBjYXNlOiBuZXcgQmluZGluZygpCgkJaWYgKCFzdWJzY3JpcHRpb25UZXh0KSB7CgkJCS8vCgkJCS8vc2hhcmVkIHByb3BlcnR5CgkJCXRoaXMuc3Vic2NyaXB0aW9ucyA9IFtdOwoJCQlyZXR1cm47CgkJfQoKCQkvL2hhbmRsZSB0aGUgY2FzZSA6IG5ldyBCaW5kaW5nIChlbGVtKTsKCQlpZiAoc3Vic2NyaXB0aW9uVGV4dC5ub2RlVHlwZSkgewoJCQl2YXIgZWxlbSA9IHN1YnNjcmlwdGlvblRleHQ7CgkJCXN1YnNjcmlwdGlvblRleHQgPSBwYXJlbnRCaW5kaW5nIHx8IGV4dHJhY3RTdWJzY3JpcHRpb25UZXh0KCBlbGVtICk7CgkJCWlmIChzdWJzY3JpcHRpb25UZXh0KSB7CgkJCQllbXB0eUJpbmRpbmcgPSBuZXcgQmluZGluZygpOwoJCQkJZW1wdHlCaW5kaW5nLmVsZW0gPSBlbGVtOwoJCQkJZW1wdHlCaW5kaW5nLm5zID0gZ2V0SW5oZXJpdGVkTmFtZXNwYWNlKCBlbGVtICk7CgkJCQlyZXR1cm4gbmV3IEJpbmRpbmcoIHN1YnNjcmlwdGlvblRleHQsIGVtcHR5QmluZGluZyApOwoJCQl9CgkJCXJldHVybjsKCQl9CgoJCWlmICghcGFyZW50QmluZGluZykgewoJCQllbXB0eUJpbmRpbmcgPSBuZXcgQmluZGluZygpOwoJCQkvL2Zha2UgYW4gZWxlbQoJCQllbXB0eUJpbmRpbmcuZWxlbSA9IHt9OwoJCQlyZXR1cm4gbmV3IEJpbmRpbmcoIHN1YnNjcmlwdGlvblRleHQsIGVtcHR5QmluZGluZyApOwoJCX0KCgkJLy9oYW5kbGUgdGhlIGNhc2U6IG5ldyBCaW5kaW5nKHN1YnNjcmlwdGlvblRleHQsIHBhcmVudEJpbmRpbmcpOwoJCS8vCgkJLy9wcml2YXRlIGRhdGEKCQl0aGlzLnN1YiA9IFtdOwoJCXRoaXMucHViID0gW107CgkJdGhpcy5iaW5kaW5ncyA9IFtdOwoKCQl3aGlsZSAoKG1hdGNoID0gclN1YnNjcmlwdGlvblByb3BlcnR5LmV4ZWMoIHN1YnNjcmlwdGlvblRleHQgKSkpIHsKCgkJCXZhciBwcmVmaXggPSBtYXRjaFsxXSwKCQkJCXByb3AgPSAkLnRyaW0oIG1hdGNoWzJdICksCgkJCQl2YWx1ZSA9ICQudHJpbSggbWF0Y2hbM10gKTsKCgkJCWlmIChwcmVmaXgpIHsKCgkJCQl0aGlzW3ByZWZpeCA9PSAiJCIgPyAicHViIiA6ICJzdWIiXS5wdXNoKCB7IGV2ZW50VHlwZXM6IHByb3AsIHZhbHVlOiB2YWx1ZSB9ICk7CgoJCQl9IGVsc2UgewoKCQkJCWlmIChwcm9wID09ICJucyIpIHsKCQkJCQluc1Byb3BlcnR5ID0gdmFsdWU7CgoJCQkJfSBlbHNlIHsKCQkJCQl0aGlzLmJpbmRpbmdzLnB1c2goIHsgYmluZGluZ05hbWU6IHByb3AsIHZhbHVlOiB2YWx1ZX0gKTsKCQkJCX0KCQkJfQoJCX0KCgkJdGhpcy5ucyA9IG1lcmdlUGF0aCggbWVyZ2VQYXRoKCBwYXJlbnRCaW5kaW5nLm5zLCBiaW5kaW5nTnMgKSwgbnNQcm9wZXJ0eSApOwoJCS8vc2hhcmVkIGRhdGEKCQl0aGlzLnRleHQgPSBzdWJzY3JpcHRpb25UZXh0OwoJCXRoaXMuZWxlbSA9IHBhcmVudEJpbmRpbmcuZWxlbTsKCQkvL3RoaXMgaXMgYSBzaW5nbGV0b24KCQkvL3RoaXMuc3Vic2NyaXB0aW9ucyA9IHBhcmVudEJpbmRpbmcuc3Vic2NyaXB0aW9uczsKCgkJaWYgKHBhcmVudEJpbmRpbmcuY29udGV4dCkgewoKCQkJdGhpcy5jb250ZXh0ID0gcGFyZW50QmluZGluZy5jb250ZXh0OwoKCQl9IGVsc2UgewoKCQkJdGhpcy5jb250ZXh0ID0gdGhpczsKCQkJdGhpcy5keW5hbWljQmluZGluZ3MgPSBbXTsKCQkJdGhpcy5zdWJzY3JpcHRpb25zID0gW107CgkJCSQoIHRoaXMuZWxlbSApLmhtRGF0YSggIm5zIiwgdGhpcy5ucyApOwoJCX0KCgkJdGhpcy5vcHRpb25zID0gbWVyZ2VPcHRpb25zKCBwYXJlbnRCaW5kaW5nLm9wdGlvbnMsIGJpbmRpbmdPcHRpb25zICk7CgoJCXRoaXMuX2ltcG9ydEJpbmRpbmdzKCk7CgkJdGhpcy5faW1wb3J0U3Vic2NyaXB0aW9ucyggInN1YiIgKTsKCQl0aGlzLl9pbXBvcnRTdWJzY3JpcHRpb25zKCAicHViIiApOwoKCX0KCglCaW5kaW5nLnByb3RvdHlwZSA9IHsKCgkJX2ltcG9ydEJpbmRpbmdzOiBmdW5jdGlvbigpIHsKCgkJCXZhciBpLAoJCQkJYmluZGluZ05hbWUsCgkJCQl3ZWxsa25vd25CaW5kaW5nLAoJCQkJYmluZGluZywKCQkJCXN1YlRleHRQYXJ0cywKCQkJCWJpbmRpbmdOcywKCQkJCWJpbmRpbmdPcHRpb25zLAoJCQkJYmluZGluZ3MgPSB0aGlzLmJpbmRpbmdzOwoKCQkJZm9yIChpID0gMDsgaSA8IGJpbmRpbmdzLmxlbmd0aDsgaSsrKSB7CgoJCQkJYmluZGluZyA9IGJpbmRpbmdzW2ldOwoJCQkJYmluZGluZ05hbWUgPSBiaW5kaW5nLmJpbmRpbmdOYW1lOwoKCQkJCS8vaWYgdmFsdWUgaXMgInBhdGh8b3B0aW9uMXxvcHRpb24yIgoJCQkJLy8KCQkJCXN1YlRleHRQYXJ0cyA9IHJCaW5kaW5nVGV4dC5leGVjKCBiaW5kaW5nLnZhbHVlICk7CgkJCQliaW5kaW5nTnMgPSBzdWJUZXh0UGFydHNbMV07IC8vICJwYXRoIgoJCQkJYmluZGluZ09wdGlvbnMgPSBzdWJUZXh0UGFydHNbM107IC8vIm9wdGlvbjF8b3B0aW9uMiIKCgkJCQl3ZWxsa25vd25CaW5kaW5nID0gX2JpbmRpbmdzW2JpbmRpbmdOYW1lXTsKCgkJCQlpZiAoaXNGdW5jdGlvbiggd2VsbGtub3duQmluZGluZyApKSB7CgoJCQkJCXZhciB0ZW1wID0gWwoJCQkJCQl3ZWxsa25vd25CaW5kaW5nLAoJCQkJCQl0aGlzLmVsZW0sCgkJCQkJCW1lcmdlUGF0aCggdGhpcy5ucywgYmluZGluZ05zICksCgkJCQkJCXRoaXMsCgkJCQkJCW1lcmdlT3B0aW9ucyggdGhpcy5vcHRpb25zLCBiaW5kaW5nT3B0aW9ucyApCgkJCQkJXTsKCgkJCQkJaWYgKGJpbmRpbmdOYW1lID09ICJydW5GaXJzdCIpIHsKCgkJCQkJCXRoaXMuY29udGV4dC5ydW5GaXJzdCA9IHRlbXA7CgoJCQkJCX0gZWxzZSBpZiAoYmluZGluZ05hbWUgPT0gInJ1bkxhc3QiKSB7CgoJCQkJCQl0aGlzLmNvbnRleHQucnVuTGFzdCA9IHRlbXA7CgoJCQkJCX0gZWxzZSB7CgoJCQkJCQl0aGlzLmNvbnRleHQuZHluYW1pY0JpbmRpbmdzLnB1c2goIHRlbXAgKTsKCQkJCQl9CgoJCQkJfSBlbHNlIGlmIChpc1N0cmluZyggd2VsbGtub3duQmluZGluZyApKSB7CgoJCQkJCS8vcmVjdXJzaXZlbHkgaW1wb3J0IHJlZmVyZW5jZWRCaW5kaW5nCgkJCQkJbmV3IEJpbmRpbmcoIHdlbGxrbm93bkJpbmRpbmcsIHRoaXMsIGJpbmRpbmdOcywgYmluZGluZ09wdGlvbnMgKTsKCgkJCQl9CgkJCX0KCQl9LAoKCQkvL3N1YnNjcmlwdGlvblR5cGUgaXMgZWl0aGVyICJwdWIiIG9yICJzdWIiCgkJX2ltcG9ydFN1YnNjcmlwdGlvbnM6IGZ1bmN0aW9uKCBzdWJzY3JpcHRpb25UeXBlICkgewoKCQkJdmFyIGksCgkJCQlzdWJzY3JpcHRpb25FbnRyeSwKCQkJCXN1YnNjcmlwdGlvblBhcnRzLAoJCQkJcHVibGlzaGVyLAoJCQkJZXZlbnRUeXBlcywKCQkJCXN1YnNjcmliZXIsCgkJCQlzdWJzY3JpcHRpb25FbnRyaWVzID0gdGhpc1tzdWJzY3JpcHRpb25UeXBlXTsKCgkJCWZvciAoaSA9IDA7IGkgPCBzdWJzY3JpcHRpb25FbnRyaWVzLmxlbmd0aDsgaSsrKSB7CgoJCQkJc3Vic2NyaXB0aW9uRW50cnkgPSBzdWJzY3JpcHRpb25FbnRyaWVzW2ldOwoJCQkJZXZlbnRUeXBlcyA9IHN1YnNjcmlwdGlvbkVudHJ5LmV2ZW50VHlwZXM7CgoJCQkJc3Vic2NyaXB0aW9uUGFydHMgPSBzdWJzY3JpcHRpb25FbnRyeS52YWx1ZS5zcGxpdCggclN1YnNjcmlwdGlvblZhbHVlU2VwYXJhdG9yICk7CgoJCQkJaWYgKHN1YnNjcmlwdGlvblR5cGUgPT0gInN1YiIpIHsKCgkJCQkJLy9wYXRofGhhbmRsZXJ8b3B0aW9uc3xkZWxlZ2F0ZQoJCQkJCXB1Ymxpc2hlciA9IHN1YnNjcmlwdGlvblBhcnRzWzBdOwoKCQkJCQlwdWJsaXNoZXIgPSBwdWJsaXNoZXIuc3RhcnRzV2l0aCggIiQiICkgPwoJCQkJCQlwdWJsaXNoZXIgOiAvL3B1Ymxpc2hlciBpcyBhIHZpZXcKCQkJCQkJbWVyZ2VQYXRoKCB0aGlzLm5zLCBwdWJsaXNoZXIgKTsKCgkJCQkJc3Vic2NyaWJlciA9IHRoaXMuZWxlbTsKCgkJCQl9IGVsc2UgewoJCQkJCS8vcGF0aHxoYW5kbGVyfG9wdGlvbnN8ZGVsZWdhdGUKCQkJCQlwdWJsaXNoZXIgPSB0aGlzLmVsZW07CgoJCQkJCXN1YnNjcmliZXIgPSBzdWJzY3JpcHRpb25QYXJ0c1swXTsKCQkJCQlzdWJzY3JpYmVyID0gc3Vic2NyaWJlci5zdGFydHNXaXRoKCAiJCIgKSA/CgkJCQkJCXN1YnNjcmliZXIgOiAvL3N1YnNjcmliZXIgaXMgYSB2aWV3CgkJCQkJCW1lcmdlUGF0aCggdGhpcy5ucywgc3Vic2NyaWJlciApOwoJCQkJfQoKCQkJCXRoaXMuYXBwZW5kU3ViKAoJCQkJCXN1YnNjcmliZXIsCgkJCQkJcHVibGlzaGVyLAoJCQkJCWV2ZW50VHlwZXMsCgkJCQkJc3Vic2NyaXB0aW9uUGFydHNbMV0sIC8vaGFuZGxlcgoJCQkJCXRvVHlwZWRWYWx1ZSggbWVyZ2VPcHRpb25zKCB0aGlzLm9wdGlvbnMsIHN1YnNjcmlwdGlvblBhcnRzWzJdICkgKSwgLy9vcHRpb25zCgkJCQkJc3Vic2NyaXB0aW9uUGFydHNbM10gLy9kZWxlZ2F0ZQoJCQkJKTsKCQkJfQoKCQl9LAoKCQlhcHBlbmRTdWI6IGZ1bmN0aW9uKCBzdWJzY3JpYmVyLCBwdWJsaXNoZXIsIGV2ZW50VHlwZXMsIGhhbmRsZXIsIG9wdGlvbnMsIGRlbGVnYXRlICkgewoJCQl0aGlzLmNvbnRleHQuc3Vic2NyaXB0aW9ucy5wdXNoKCB7CgkJCQlwdWJsaXNoZXI6IHB1Ymxpc2hlciwKCQkJCWV2ZW50VHlwZXM6IGV2ZW50VHlwZXMsCgkJCQlzdWJzY3JpYmVyOiBzdWJzY3JpYmVyLAoJCQkJaGFuZGxlcjogaGFuZGxlciwKCQkJCW9wdGlvbnM6IG9wdGlvbnMsCgkJCQlkZWxlZ2F0ZTogZGVsZWdhdGUKCQkJfSApOwoJCX0sCgoJCXByZXBlbmRTdWI6IGZ1bmN0aW9uIHByZXBlbmRTdWIoIHN1YnNjcmliZXIsIHB1Ymxpc2hlciwgZXZlbnRUeXBlcywgaGFuZGxlciwgb3B0aW9ucywgZGVsZWdhdGUgKSB7CgkJCXRoaXMuY29udGV4dC5zdWJzY3JpcHRpb25zLnVuc2hpZnQoIHsKCQkJCXB1Ymxpc2hlcjogcHVibGlzaGVyLAoJCQkJZXZlbnRUeXBlczogZXZlbnRUeXBlcywKCQkJCXN1YnNjcmliZXI6IHN1YnNjcmliZXIsCgkJCQloYW5kbGVyOiBoYW5kbGVyLAoJCQkJb3B0aW9uczogb3B0aW9ucywKCQkJCWRlbGVnYXRlOiBkZWxlZ2F0ZQoJCQl9ICk7CgkJfSwKCgkJY2xlYXJTdWJzOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5jb250ZXh0LnN1YnNjcmlwdGlvbnMuc3BsaWNlKCAwLCB0aGlzLnN1YnNjcmlwdGlvbnMubGVuZ3RoICk7CgkJfQoJfTsKCglmdW5jdGlvbiBwYXJzZVN1YnMoIGVsZW0gKSB7CgoJCXZhciBzdWJzY3JpcHRpb25UZXh0LAoJCQljb250ZXh0LAoJCQlzdWJzY3JpcHRpb25zLAoJCQlpLAoJCQlzdWJzY3JpcHRpb24sCgkJCSRlbGVtID0gJCggZWxlbSApOwoKCQlpZiAoISRlbGVtLmhtRGF0YSggInBhcnNlZCIgKSAmJiAoc3Vic2NyaXB0aW9uVGV4dCA9IGV4dHJhY3RTdWJzY3JpcHRpb25UZXh0KCBlbGVtICkpKSB7CgoJCQljb250ZXh0ID0gbmV3IEJpbmRpbmcoIGVsZW0sIHN1YnNjcmlwdGlvblRleHQgKTsKCQkJc3Vic2NyaXB0aW9ucyA9IGNvbnRleHQuc3Vic2NyaXB0aW9uczsKCgkJCXZhciBydW5GaXJzdCA9IGNvbnRleHQucnVuRmlyc3Q7CgkJCWlmIChydW5GaXJzdCkgewoJCQkJcnVuRmlyc3RbMF0oIHJ1bkZpcnN0WzFdLCBydW5GaXJzdFsyXSwgcnVuRmlyc3RbM10sIHJ1bkZpcnN0WzRdICk7CgkJCX0KCgkJCXZhciBkeW5hbWljQmluZGluZ3MgPSBjb250ZXh0LmR5bmFtaWNCaW5kaW5nczsKCQkJZm9yIChpID0gMDsgaSA8IGR5bmFtaWNCaW5kaW5ncy5sZW5ndGg7IGkrKykgewoJCQkJdmFyIGR5bmFtaWNCaW5kaW5nID0gZHluYW1pY0JpbmRpbmdzW2ldOwoJCQkJZHluYW1pY0JpbmRpbmdbMF0oIGR5bmFtaWNCaW5kaW5nWzFdLCBkeW5hbWljQmluZGluZ1syXSwgZHluYW1pY0JpbmRpbmdbM10sIGR5bmFtaWNCaW5kaW5nWzRdICk7CgkJCX0KCgkJCXZhciBydW5MYXN0ID0gY29udGV4dC5ydW5MYXN0OwoJCQlpZiAocnVuTGFzdCkgewoJCQkJcnVuTGFzdFswXSggcnVuTGFzdFsxXSwgcnVuTGFzdFsyXSwgcnVuTGFzdFszXSwgcnVuTGFzdFs0XSApOwoJCQl9CgoJCQlmb3IgKGkgPSAwOyBpIDwgc3Vic2NyaXB0aW9ucy5sZW5ndGg7IGkrKykgewoKCQkJCXN1YnNjcmlwdGlvbiA9IHN1YnNjcmlwdGlvbnNbaV07CgkJCQlobS5zdWIoCgkJCQkJc3Vic2NyaXB0aW9uLnN1YnNjcmliZXIsCgkJCQkJc3Vic2NyaXB0aW9uLnB1Ymxpc2hlciwKCQkJCQlzdWJzY3JpcHRpb24uZXZlbnRUeXBlcywKCQkJCQlzdWJzY3JpcHRpb24uaGFuZGxlciwKCQkJCQlzdWJzY3JpcHRpb24ub3B0aW9ucywKCQkJCQlzdWJzY3JpcHRpb24uZGVsZWdhdGUKCQkJCSk7CgkJCX0KCgkJCS8vI2RlYnVnCgkJCWNvbnRleHQuZGVidWcgJiYgY29udGV4dC5wcmludCgpOwoJCQkvLyNlbmRfZGVidWcKCgkJCS8vCgkJCSRlbGVtLmhtRGF0YSggInBhcnNlZCIsIHRydWUgKTsKCQl9CgoJCSRlbGVtLmNoaWxkcmVuKCkuZWFjaCggZnVuY3Rpb24oKSB7CgkJCXBhcnNlU3VicyggdGhpcyApOwoJCX0gKTsKCX0KCgkvL2RlbGF5IGF1dG8gcGFyc2UgdG8gd2F5IGZvciBzb21lIGRlcGVuZGVuY2llcyB0byByZXNvbHZlIGFzeW5jaHJvbm91c2x5CglzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkkKCBmdW5jdGlvbigpIHsKCQkJaWYgKGRlZmF1bHRPcHRpb25zLmF1dG9QYXJzZSkgewoJCQkJcGFyc2VTdWJzKCBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQgKTsKCQkJfQoJCX0gKTsKCX0sIDEgKTsKCgkkZm4ucGFyc2VTdWJzID0gZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuZWFjaCggZnVuY3Rpb24oKSB7CgkJCXBhcnNlU3VicyggdGhpcyApOwoJCX0gKTsKCX07CgoJdmFyIGxvZ01vZGVsID0gaG0oICIqbG9nIiwgW10gKTsKCgl2YXIgX2JpbmRpbmdzID0ge307CgoJZnVuY3Rpb24gYmluZGluZ3MoIG5hbWUsIGRlZmluaXRpb24sIGlzVGFnICkgewoJCWlmICghbmFtZSkgewoJCQlyZXR1cm4gX2JpbmRpbmdzOwoJCX0KCgkJaWYgKCFkZWZpbml0aW9uKSB7CgoJCQlpZiAoaXNPYmplY3QoIG5hbWUgKSkgewoJCQkJZm9yICh2YXIga2V5IGluIG5hbWUpIHsKCQkJCQliaW5kaW5ncygga2V5LCBuYW1lW2tleV0gKTsKCQkJCX0KCQkJCXJldHVybiB0aGlzOwoKCQkJfSBlbHNlIHsKCQkJCXJldHVybiBfYmluZGluZ3NbbmFtZV07CgkJCX0KCQl9CgoJCWlmIChpc0FycmF5KCBkZWZpbml0aW9uICkpIHsKCQkJZGVmaW5pdGlvbiA9IGRlZmluaXRpb24uY29uY2F0KCAiOyIgKTsKCQl9CgoJCV9iaW5kaW5nc1tpc1RhZyA/ICJ0YWdfIiArIG5hbWUudG9VcHBlckNhc2UoKSA6IG5hbWVdID0gZGVmaW5pdGlvbjsKCQlyZXR1cm4gdGhpczsKCX0KCglleHRlbmQoIGhtLCB7CgoJCWJpbmRpbmc6IGJpbmRpbmdzLAoKCQkvLyNkZWJ1ZwoJCUJpbmRpbmc6IEJpbmRpbmcsCgkJLy8jZW5kX2RlYnVnCgoJCWxvZzogZnVuY3Rpb24oIG1lc3NhZ2UsIGNvbG9yICkgewoJCQltZXNzYWdlID0gbWVzc2FnZSArICIiOwoJCQltZXNzYWdlID0gY29sb3IgPyAiPGRpdiBzdHlsZT0nY29sb3I6IiArIGNvbG9yICsgIic+IiArIG1lc3NhZ2UgKyAiPC9kaXY+ICIgOiBtZXNzYWdlOwoJCQlsb2dNb2RlbC5wdXNoKCBtZXNzYWdlICk7CgkJfSwKCgkJY2xlYXJsb2c6IGZ1bmN0aW9uKCkgewoJCQlsb2dNb2RlbC5jbGVhcigpOwoJCX0KCX0gKTsKCglmdW5jdGlvbiBhZGhvY0JpbmRpbmcoIGVsZW0sIHBhdGgsIGNvbnRleHQsIG9wdGlvbnMgKSB7CgkJcm9vdE5vZGUuZ2V0KCBwYXRoLCBlbGVtLCBwYXRoLCBjb250ZXh0LCBvcHRpb25zICk7Cgl9CgoJYmluZGluZ3MoICJydW5GaXJzdCIsIGFkaG9jQmluZGluZyApOwoJYmluZGluZ3MoICJydW5MYXN0IiwgYWRob2NCaW5kaW5nICk7CgovLyNkZWJ1ZwovLwovLzxAZGVwZW5kcz5zdWJzY3JpcHRpb24uanMsIG1vZGVsLmpzLCBkZWNsYXJhdGl2ZS5qczwvQGRlcGVuZHM+CgoKCUJpbmRpbmcucHJvdG90eXBlLnByaW50ID0gZnVuY3Rpb24oKSB7CgkJdmFyIHN1YnNjcmlwdGlvbnMgPSB0aGlzLnN1YnNjcmlwdGlvbnMsCgkJCWVsZW0gPSB0aGlzLmVsZW07CgoJCXZhciBodG1sID0gIjx0YWJsZSBib3JkZXI9JzEnIGNlbGxwYWRkaW5nPSc2JyBzdHlsZT0nYm9yZGVyLWNvbGxhcHNlOiBjb2xsYXBzZTsgd2lkdGg6MTAwJTsnPiIgKwoJCSAgICAgICAgICAgIjx0cj48dGQ+ZWxlbWVudDwvdGQ+PHRkIGNvbHNwYW49JzYnPiIgKyBmb3JtYXRQYXJ0eSggZWxlbSApICsgIjwvdGQ+IDwvdHI+IiArCgkJICAgICAgICAgICAiPHRyPjx0ZD5tb2RlbCBwYXRoPC90ZD48dGQgY29sc3Bhbj0nNic+IiArIGZvcm1hdFBhcnR5KCB0aGlzLm5zICkgKyAiPC90ZD48L3RyPiIgKwoJCSAgICAgICAgICAgIjx0cj48dGQ+dGV4dDwvdGQ+PHRkIGNvbHNwYW49JzYnPiIgKyBmb3JtYXRQcmludCggdGhpcy50ZXh0ICkgKyAiPC90ZD48L3RyPiI7CgoJCWlmICh0aGlzLnN1Yi5sZW5ndGgpIHsKCQkJaHRtbCArPSAiPHRyPjx0ZD5zdWI8L3RkPjx0ZCBjb2xzcGFuPSc2Jz4iICsgZm9ybWF0UHJpbnQoIHRoaXMuc3ViICkgKyAiPC90ZD48L3RyPiI7CgkJfQoKCQlpZiAodGhpcy5wdWIubGVuZ3RoKSB7CgkJCWh0bWwgKz0gIjx0cj48dGQ+cHViPC90ZD48dGQgY29sc3Bhbj0nNic+IiArIGZvcm1hdFByaW50KCB0aGlzLnB1YiApICsgIjwvdGQ+PC90cj4iOwoJCX0KCgkJaWYgKHRoaXMuYmluZGluZ3MubGVuZ3RoKSB7CgkJCWh0bWwgKz0gIjx0cj48dGQ+YmluZGluZzwvdGQ+PHRkIGNvbHNwYW49JzYnPiIgKyBmb3JtYXRQcmludCggdGhpcy5iaW5kaW5ncyApICsgIjwvdGQ+PC90cj4iOwoJCX0KCgkJaWYgKHN1YnNjcmlwdGlvbnMubGVuZ3RoKSB7CgoJCQlodG1sICs9ICI8dHI+IiArCgkJCSAgICAgICAgIjx0aD48L3RoPiIgKwoJCQkgICAgICAgICI8dGg+c3Vic2NyaWJlcjwvdGg+IiArCgkJCSAgICAgICAgIjx0aD5wdWJsaXNoZXI8L3RoPiIgKwoJCQkgICAgICAgICI8dGg+ZXZlbnRUeXBlczwvdGg+IiArCgkJCSAgICAgICAgIjx0aD5oYW5kbGVyPC90aD4iICsKCQkJICAgICAgICAiPHRoPm9wdGlvbnM8L3RoPiIgKwoJCQkgICAgICAgICI8dGg+ZGVsZWdhdGU8L3RoPiIgKwoJCQkgICAgICAgICI8L3RyPiI7CgoJCQlmb3IgKHZhciBpID0gMDsgaSA8IHN1YnNjcmlwdGlvbnMubGVuZ3RoOyBpKyspIHsKCQkJCXZhciBzdWJzY3JpcHRpb24gPSBzdWJzY3JpcHRpb25zW2ldOwoJCQkJaHRtbCArPSAiPHRyPiIgKwoJCQkJICAgICAgICAiPHRkPiIgKyAoaSArIDEpICsgIjwvdGQ+IiArCgkJCQkgICAgICAgICI8dGQ+IiArIGZvcm1hdFBhcnR5KCBzdWJzY3JpcHRpb24uc3Vic2NyaWJlciwgZWxlbSApICsgIjwvdGQ+IiArCgkJCQkgICAgICAgICI8dGQ+IiArIGZvcm1hdFBhcnR5KCBzdWJzY3JpcHRpb24ucHVibGlzaGVyLCBlbGVtICkgKyAiPC90ZD4iICsKCQkJCSAgICAgICAgIjx0ZD4iICsgZm9ybWF0UHJpbnQoIHN1YnNjcmlwdGlvbi5ldmVudFR5cGVzICkgKyAiPC90ZD4iICsKCQkJCSAgICAgICAgIjx0ZD4iICsgZm9ybWF0UHJpbnQoIHN1YnNjcmlwdGlvbi5oYW5kbGVyICkgKyAiPC90ZD4iICsKCQkJCSAgICAgICAgIjx0ZD4iICsgZm9ybWF0UHJpbnQoIHN1YnNjcmlwdGlvbi5vcHRpb25zICkgKyAiPC90ZD4iICsKCQkJCSAgICAgICAgIjx0ZD4iICsgZm9ybWF0UHJpbnQoIHN1YnNjcmlwdGlvbi5kZWxlZ2F0ZSApICsgIjwvdGQ+IiArCgkJCQkgICAgICAgICI8L3RyPiI7CgkJCX0KCQl9CgoJCWh0bWwgKz0gIjwvdGFibGU+IjsKCQlobS5sb2coIGh0bWwgKTsKCgl9OwoKCWZ1bmN0aW9uIGZvcm1hdFBhcnR5KCBvYmosIGVsZW0gKSB7CgoJCWlmIChvYmogPT09IGVsZW0pIHsKCQkJcmV0dXJuICJlbGVtZW50IjsKCQl9CgoJCWlmIChvYmoubm9kZVR5cGUpIHsKCQkJcmV0dXJuIHV0aWwuZW5jb2RlSHRtbCggb2JqLm91dGVySFRNTCApLnN1YnN0ciggMCwgMTAwICkgKyAiLi4uIjsKCQl9CgoJCWlmIChpc1N0cmluZyggb2JqICkpIHsKCQkJaWYgKG9iai5zdGFydHNXaXRoKCAiJCIgKSkgewoJCQkJcmV0dXJuICIkKCciICsgb2JqLnN1YnN0ciggMSApICsgIicpIjsKCQkJfSBlbHNlIHsKCQkJCWlmIChlbGVtKSB7CgkJCQkJcmV0dXJuICJobSgnIiArIHV0aWwudG9Mb2dpY2FsUGF0aCggb2JqICkgKyAiJykiOwoJCQkJfSBlbHNlIHsKCQkJCQlyZXR1cm4gIiciICsgdXRpbC50b0xvZ2ljYWxQYXRoKCBvYmogKSArICInIjsKCQkJCX0KCQkJfQoJCX0KCgl9CgoJZnVuY3Rpb24gZm9ybWF0UHJpbnQoIG9iaiApIHsKCgkJaWYgKGlzVW5kZWZpbmVkKCBvYmogKSkgewoJCQlyZXR1cm4gIiI7CgkJfSBlbHNlIGlmIChpc0Z1bmN0aW9uKCBvYmogKSkgewoKCQkJcmV0dXJuIHV0aWwuZW5jb2RlSHRtbCggb2JqICsgIiIgKS5zdWJzdHIoIDAsIDEwMCApICsgIi4uLiI7CgoJCX0gZWxzZSBpZiAoaXNPYmplY3QoIG9iaiApKSB7CgoJCQl2YXIgcnRuID0gIjxwcmU+eyI7CgkJCXZhciB0ZW1wID0gIiI7CgkJCWZvciAodmFyIGtleSBpbiBvYmopIHsKCQkJCXZhciB2YWx1ZSA9IG9ialtrZXldOwoJCQkJaWYgKCFpc1VuZGVmaW5lZCggdmFsdWUgKSkgewoJCQkJCXRlbXAgKz0gIlxuICIgKyBrZXkgKyAiOiI7CgkJCQkJaWYgKGlzU3RyaW5nKCB2YWx1ZSApKSB7CgkJCQkJCXRlbXAgKz0gIiciICsgdXRpbC5lbmNvZGVIdG1sKCB2YWx1ZSApICsgIicsIgoJCQkJCX0gZWxzZSB7CgkJCQkJCXRlbXAgKz0gdXRpbC5lbmNvZGVIdG1sKCB2YWx1ZSApICsgIiwiCgkJCQkJfQoJCQkJfQoKCQkJfQoKCQkJaWYgKHRlbXAubGVuZ3RoICE9IDApIHsKCQkJCXRlbXAgPSB0ZW1wLnN1YnN0ciggMCwgdGVtcC5sZW5ndGggLSAxICk7CgkJCX0KCQkJcnRuICs9IHRlbXA7CgoJCQlydG4gKz0gIlxufTwvcHJlPiI7CgkJCXJ0biA9IHJ0bi5yZXBsYWNlKCAvXHQvZywgIiAiICk7CgkJCXJldHVybiBydG47CgkJfSBlbHNlIHsKCQkJcmV0dXJuIEpTT04uc3RyaW5naWZ5KCBvYmogKTsKCQl9Cgl9CgoJaG0uYmluZGluZyggImRlYnVnIiwgZnVuY3Rpb24oIGVsZW0sIHBhdGgsIGNvbnRleHQsIG9wdGlvbnMgKSB7CgkJY29udGV4dC5kZWJ1ZyA9IHRydWU7Cgl9ICk7CgoJaG0ucHJpbnRCaW5kaW5nID0gZnVuY3Rpb24oIGVsZW0gKSB7CgkJaWYgKGlzU3RyaW5nKCBlbGVtICkpIHsKCQkJZWxlbSA9ICQoICI8ZGl2PjwvZGl2PiIgKS5hdHRyKCBobS5vcHRpb25zLnN1YnNBdHRyLCBlbGVtIClbMF07CgkJfSBlbHNlIGlmIChlbGVtLmpxdWVyeSkgewoJCQllbGVtID0gZWxlbVswXTsKCQl9CgoJCShuZXcgaG0uQmluZGluZyggZWxlbSApKS5wcmludCgpOwoJfTsKCgkvL21lIGNhbiBiZSBhIERPTSBlbGVtZW50LCBvciBpdCBjYW4gYSBzdHJpbmcgcGF0aAoJaG0ucHJpbnRTdWJzY3JpcHRpb25zID0gZnVuY3Rpb24oIG1lLCBzdWJzY3JpcHRpb25zLCB0eXBlICkgewoJCWlmICghc3Vic2NyaXB0aW9ucy5sZW5ndGgpIHsKCQkJaG0ubG9nKCAibm8gc3Vic2NyaXB0aW9uIiApOwoJCQlyZXR1cm47CgkJfQoKCQl2YXIgc3Vic0Zyb21NZSwgc3Vic1RvTWUsIGksIHN1YnNjcmlwdGlvbjsKCQlpZiAodHlwZSA9PSAiZnJvbU1lIikgewoJCQlzdWJzRnJvbU1lID0gc3Vic2NyaXB0aW9uczsKCQl9IGVsc2UgaWYgKHR5cGUgPT0gInRvTWUiKSB7CgoJCQlzdWJzVG9NZSA9IHN1YnNjcmlwdGlvbnM7CgoJCX0gZWxzZSB7CgoJCQlzdWJzRnJvbU1lID0gJCggc3Vic2NyaXB0aW9ucyApLmZpbHRlcihmdW5jdGlvbiggaW5kZXgsIGl0ZW0gKSB7CgkJCQlyZXR1cm4gaXRlbS5zdWJzY3JpYmVyID09IG1lOwoJCQl9ICkuZ2V0KCk7CgoJCQlzdWJzVG9NZSA9ICQoIHN1YnNjcmlwdGlvbnMgKS5maWx0ZXIoZnVuY3Rpb24oIGluZGV4LCBpdGVtICkgewoJCQkJcmV0dXJuIGl0ZW0ucHVibGlzaGVyID09IG1lOwoJCQl9ICkuZ2V0KCk7CgoJCX0KCgkJLypyZXR1cm4gZ2V0U3Vic2NyaXB0aW9uc0J5KCBzdWJzY3JpYmVyT3JQdWJsaXNoZXIsIGZ1bmN0aW9uIG1hdGNoKCBpdGVtLCB0YXJnZXQgKSB7CgkJIHJldHVybiBpdGVtLnN1YnNjcmliZXIgPT0gdGFyZ2V0IHx8IGl0ZW0ucHVibGlzaGVyID09IHRhcmdldDsKCQkgfSApOyovCgoJCXZhciBteURlc2NyaXB0aW9uOwoKCQlpZiAoaXNTdHJpbmcoIG1lICkgfHwgKG1lIGluc3RhbmNlb2YgIGhtKSkgewoKCQkJbXlEZXNjcmlwdGlvbiA9ICJobSgnIiArIHV0aWwudG9Mb2dpY2FsUGF0aCggbWUgKSArICInKSI7CgoJCX0gZWxzZSB7CgoJCQlteURlc2NyaXB0aW9uID0gZm9ybWF0UGFydHkoIG1lICk7CgoJCX0KCgkJdmFyIGh0bWwgPSAiPHRhYmxlIGJvcmRlcj0nMScgY2VsbHBhZGRpbmc9JzYnIHN0eWxlPSdib3JkZXItY29sbGFwc2U6IGNvbGxhcHNlOyB3aWR0aDoxMDAlOyc+IjsKCgkJaWYgKHN1YnNGcm9tTWUgJiYgc3Vic0Zyb21NZS5sZW5ndGgpIHsKCQkJaHRtbCArPSAiPHRyPjx0aCBjb2xzcGFuPSc2Jz48Yj5TdWJzY3JpYmVyOiA8L2I+ICIgKyBteURlc2NyaXB0aW9uICsgIjwvdGg+PC90cj4iOwoJCQlodG1sICs9ICI8dHI+PHRoPjwvdGg+PHRoPlB1Ymxpc2hlcjo8L3RoPjx0aD5ldmVudHM8L3RoPjx0aD53b3JrZmxvdzwvdGg+PHRoPm9wdGlvbnM8L3RoPjx0aD5kZWxlZ2F0ZTwvdGg+PC90aD4iOwoKCQkJZm9yIChpID0gMDsgaSA8IHN1YnNGcm9tTWUubGVuZ3RoOyBpKyspIHsKCQkJCXN1YnNjcmlwdGlvbiA9IHN1YnNGcm9tTWVbaV07CgkJCQlodG1sICs9ICI8dHI+IiArCgkJCQkgICAgICAgICI8dGQ+IiArIChpICsgMSkgKyAiPC90ZD4iICsKCQkJCSAgICAgICAgIjx0ZD4iICsgZm9ybWF0UGFydHkoIHN1YnNjcmlwdGlvbi5wdWJsaXNoZXIgKSArICI8L3RkPiIgKwoJCQkJICAgICAgICAiPHRkPiIgKyBmb3JtYXRQcmludCggc3Vic2NyaXB0aW9uLmV2ZW50VHlwZXMgKSArICI8L3RkPiIgKwoJCQkJICAgICAgICAiPHRkPiIgKyBmb3JtYXRQcmludCggc3Vic2NyaXB0aW9uLndvcmtmbG93ICkgKyAiPC90ZD4iICsKCQkJCSAgICAgICAgIjx0ZD4iICsgZm9ybWF0UHJpbnQoIHN1YnNjcmlwdGlvbi5vcHRpb25zICkgKyAiPC90ZD4iICsKCQkJCSAgICAgICAgIjx0ZD4iICsgZm9ybWF0UHJpbnQoIHN1YnNjcmlwdGlvbi5kZWxlZ2F0ZSApICsgIjwvdGQ+IiArCgkJCQkgICAgICAgICI8L3RyPiI7CgkJCX0KCQl9CgoJCWlmIChzdWJzVG9NZSAmJiBzdWJzVG9NZS5sZW5ndGgpIHsKCQkJaHRtbCArPSAiPHRyPjx0aCBjb2xzcGFuPSc2Jz5QdWJsaXNoZXI6ICIgKyBteURlc2NyaXB0aW9uICsgIjwvdGg+PC90cj4iOwoJCQlodG1sICs9ICI8dHI+PHRoPjwvdGg+PHRoPlN1YnNjcmliZXI6PC90aD48dGg+ZXZlbnRzPC90aD48dGg+d29ya2Zsb3c8L3RoPjx0aD5vcHRpb25zPC90aD48dGg+ZGVsZWdhdGU8L3RoPjwvdHI+IjsKCgkJCWZvciAoaSA9IDA7IGkgPCBzdWJzVG9NZS5sZW5ndGg7IGkrKykgewoJCQkJc3Vic2NyaXB0aW9uID0gc3Vic1RvTWVbaV07CgkJCQlodG1sICs9ICI8dHI+IiArCgkJCQkgICAgICAgICI8dGQ+IiArIChpICsgMSkgKyAiPC90ZD4iICsKCQkJCSAgICAgICAgIjx0ZD4iICsgZm9ybWF0UGFydHkoIHN1YnNjcmlwdGlvbi5zdWJzY3JpYmVyICkgKyAiPC90ZD4iICsKCQkJCSAgICAgICAgIjx0ZD4iICsgZm9ybWF0UHJpbnQoIHN1YnNjcmlwdGlvbi5ldmVudFR5cGVzICkgKyAiPC90ZD4iICsKCQkJCSAgICAgICAgIjx0ZD4iICsgZm9ybWF0UHJpbnQoIHN1YnNjcmlwdGlvbi53b3JrZmxvdyApICsgIjwvdGQ+IiArCgkJCQkgICAgICAgICI8dGQ+IiArIGZvcm1hdFByaW50KCBzdWJzY3JpcHRpb24ub3B0aW9ucyApICsgIjwvdGQ+IiArCgkJCQkgICAgICAgICI8dGQ+IiArIGZvcm1hdFByaW50KCBzdWJzY3JpcHRpb24uZGVsZWdhdGUgKSArICI8L3RkPiIgKwoJCQkJICAgICAgICAiPC90cj4iOwoJCQl9CgkJfQoKCQlodG1sICs9ICI8L3RhYmxlPiI7CgkJaG0ubG9nKCBodG1sICk7CgoJfTsKCi8vI2VuZF9kZWJ1Zy8vCgoJLy9zdGFydCBvZiBsb2FkZXIgY29yZS5qcwoJdmFyIHVybFN0b3JlID0ge30sCgkJcHJvbWlzZVN0b3JlID0ge30sCgkJZGVwZW5kZW5jeVN0b3JlID0ge30sCgkJbG9hZGVyRGVmaW5pdGlvblN0b3JlID0ge30sCgkJbG9hZGVyU3RvcmUgPSB7fSwKCQlkdW1teUxpbmsgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiYSIgKSwKCQlyQ29tbWEgPSAvLC8sCgkJclNwYWNlID0gL1xzKy9nLAoJCXJRdWVyeSA9IC9cPy8sCgkJckZpbGVFeHQgPSAvXC4oXHcrKSQvLAoJCXJGaWxlTmFtZSA9IC8oLispXC5cdyskLywKCQlmaWxlRXh0ZW5zaW9uLAoJCWZpbGVOYW1lLAoJCWNvbW1vbkxvYWRlck1ldGhvZHMsCgkJY29tbW9uTG9hZEZpbHRlcnMsCgkJZGVwZW5kLAoJLy9tYXRjaCAiaHR0cDovL2RvbWFpbi5jb20iICwgIi9qa2oiCgkJckFic29sdXRlVXJsID0gL15odHRwW3NdPzpcL1wvfF5cLy8sCgkJclVybFBhcnRzID0gL14oW1x3XCtcLlwtXSs6KSg/OlwvXC8oW15cLz8jOl0qKSg/OjooXGQrKSk/KT8vLAoJCWFqYXhMb2NQYXJ0cyA9IHJVcmxQYXJ0cy5leGVjKCBsb2NhdGlvbi5ocmVmLnRvTG93ZXJDYXNlKCkgKSB8fCBbXSwKCQloYXNoVmFsdWUgPSAiIiwKCQloYXNoS2V5ID0gInYiLAoJCXJWZXJzaW9uSGFzaCwKCQlsb2FkQ2FsbGJhY2tzID0gW10sCgkJZmFpbENhbGxiYWNrcyA9IFtdLAoJCXVubG9hZENhbGxiYWNrcyA9IFtdLAoKCQlsb2FkZXJGaW5kZXJzLAoJCWZpbGVFeHRUb0xvYWRlck1hcHBlciA9IHt9LAoJCWJhc2VVcmwgPSAiIiwKCgkvL3N1cHBvcnQgdGhlIGZvbGxvd2luZyBvdmVybG9hZGluZwoJLy9obS5sb2FkZXIoImFwcCIpOyAvL3JldHJpZXZlIGxvYWRlcgoJLy9obS5sb2FkZXIoImFwcCIsIGRlZmluaXRpb24pOyAvL2NyZWF0ZSBhIGxvYWRlciBmcm9tIHNjcmF0Y2gKCS8vaG0ubG9hZGVyKCJhcHAiLCAianMiLCBkZWZpbml0aW9uKTsgLy9jcmVhdGUgYSBsb2FkZXIgYnkgZXh0ZW5kaW5nIGEgbmV3IGxvYWRlcgoJCV9sb2FkZXIgPSBobS5sb2FkZXIgPSBmdW5jdGlvbiggbG9hZGVyTmFtZSwgYmFzZUxvYWRlck5hbWUsIGxvYWRlckRlZmluaXRpb24gKSB7CgoKCQkJLy9yZXRyaWV2ZSB0aGUgbG9hZGVyIGJ5IG5hbWUKCQkJaWYgKGlzVW5kZWZpbmVkKCBiYXNlTG9hZGVyTmFtZSApKSB7CgoJCQkJcmV0dXJuIGxvYWRlck5hbWUgPyBsb2FkZXJTdG9yZVtsb2FkZXJOYW1lXSA6IGxvYWRlclN0b3JlOwoKCQkJfQoKCQkJLy9jcmVhdGUgYSBuZXcgbG9hZGVyCgkJCWlmICghaXNTdHJpbmcoIGJhc2VMb2FkZXJOYW1lICkpIHsKCQkJCWxvYWRlckRlZmluaXRpb24gPSBiYXNlTG9hZGVyTmFtZTsKCQkJCWJhc2VMb2FkZXJOYW1lID0gbnVsbDsKCQkJfQoKCQkJbG9hZGVyRGVmaW5pdGlvbiA9IGxvYWRlckRlZmluaXRpb25TdG9yZVtsb2FkZXJOYW1lXSA9ICQuZXh0ZW5kKAoJCQkJdHJ1ZSwKCQkJCXt9LAoJCQkJbG9hZGVyRGVmaW5pdGlvblN0b3JlW2Jhc2VMb2FkZXJOYW1lXSwKCQkJCWxvYWRlckRlZmluaXRpb24gKTsKCgkJCXZhciBsb2FkZXIgPSAkLmV4dGVuZCggdHJ1ZSwge30sIGxvYWRlckRlZmluaXRpb24gKTsKCgkJCSQuZWFjaCggImxvYWQsdW5sb2FkLHVybCxkZXBlbmQiLnNwbGl0KCAiLCIgKSwgZnVuY3Rpb24oIGluZGV4LCBtZXRob2ROYW1lICkgewoJCQkJdmFyIGNvbW1vbk1ldGhvZE5hbWUgPSBsb2FkZXJbbWV0aG9kTmFtZV07CgkJCQlpZiAoaXNTdHJpbmcoIGNvbW1vbk1ldGhvZE5hbWUgKSkgewoJCQkJCXZhciBsb2FkZXJNZXRob2QgPSBjb21tb25Mb2FkZXJNZXRob2RzW21ldGhvZE5hbWVdW2NvbW1vbk1ldGhvZE5hbWVdOwoJCQkJCWlmIChsb2FkZXJNZXRob2QpIHsKCQkJCQkJbG9hZGVyW21ldGhvZE5hbWVdID0gbG9hZGVyTWV0aG9kOwoJCQkJCX0KCQkJCX0KCQkJfSApOwoKCQkJaWYgKCQuaXNQbGFpbk9iamVjdCggbG9hZGVyLmxvYWQgKSkgewoJCQkJLy9pdCBpcyBhIHBpcGVsaW5lLCBidXQgbm90IGEgZnVuY3Rpb24KCQkJCWxvYWRlci5sb2FkID0gY29udmVydExvYWRGaWx0ZXJzVG9Mb2FkTWV0aG9kKCBsb2FkZXIubG9hZCApOwoKCQkJfQoKCQkJaWYgKCEkLmlzRnVuY3Rpb24oIGxvYWRlci5sb2FkICkpIHsKCQkJCXRocm93ICJtaXNzaW5nIGxvYWQgZnVuY3Rpb24gZnJvbSBsb2FkZXIiOwoJCQl9CgoJCQlsb2FkZXJTdG9yZVtsb2FkZXJOYW1lXSA9ICQuZXh0ZW5kKCB7fSwgbG9hZGVyU3RvcmVbYmFzZUxvYWRlck5hbWVdLCBsb2FkZXIgKTsKCQl9OwoKCWZ1bmN0aW9uIGludm9rZUNhbGxiYWNrcyggY2FsbGJhY2tzICkgewoJCXJldHVybiBmdW5jdGlvbigpIHsKCQkJZm9yICh2YXIgaSA9IDA7IGkgPCBjYWxsYmFja3MubGVuZ3RoOyBpKyspIHsKCQkJCWNhbGxiYWNrc1tpXS5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgkJCX0KCQl9OwoJfQoKCXZhciBpbnZva2VGYWlsQ2FsbGJhY2tzID0gaW52b2tlQ2FsbGJhY2tzKCBmYWlsQ2FsbGJhY2tzICksCgkJaW52b2tlTG9hZENhbGxiYWNrcyA9IGludm9rZUNhbGxiYWNrcyggbG9hZENhbGxiYWNrcyApLAoJCWludm9rZVVubG9hZENhbGxiYWNrcyA9IGludm9rZUNhbGxiYWNrcyggdW5sb2FkQ2FsbGJhY2tzICk7CgoJZnVuY3Rpb24gbG9hZEFzc2V0cyggYXNzZXRJZHMsIGluZmVyRGVwZW5kZW5jaWVzRnJvbUlkT3JkZXIgKSB7CgoJCWlmIChpc1N0cmluZyggYXNzZXRJZHMgKSkgewoKCQkJaWYgKGluZmVyRGVwZW5kZW5jaWVzRnJvbUlkT3JkZXIpIHsKCQkJCXZhciBpID0gMSwKCQkJCQlrZXlzID0gc3BsaXRCeUNvbW1hKCBhc3NldElkcyApOwoKCQkJCS8vY3JlYXRlIGRlcGVuZGVuY3kgaW4gb3JkZXIKCQkJCXdoaWxlIChpIDwga2V5cy5sZW5ndGgpIHsKCQkJCQlkZXBlbmQoIGtleXNbaV0sIGtleXNbaSAtIDFdICk7CgkJCQkJaSsrOwoJCQkJfQoJCQkJYXNzZXRJZHMgPSBrZXlzW2tleXMubGVuZ3RoIC0gMV07CgkJCX0KCgkJCXJldHVybiBsb2FkQXNzZXRzSW5QYXJhbGxlbCggYXNzZXRJZHMgKTsKCgkJfSBlbHNlIGlmIChpc0FycmF5KCBhc3NldElkcyApKSB7CgoJCQkvL2lmIGl0IGlzIGFzc2V0SWRBcnJheSwgbG9hZCBvbmUgYWZ0ZXIgcHJldmlvdXMgaXMgZnVsbHkgbG9hZGVkCgkJCXJldHVybiBsb2FkQXNzZXRzSW5TZXJpYWwoIGFzc2V0SWRzICk7CgoJCX0KCQl0aHJvdyAicmVzb3VyY2UgcGFyYW1ldGVyIHNob3VsZCBiZSBhbiBhcnJheSBvciBzdHJpbmciOwoJfQoKCS8vcmVzb3VyY2VTdHJpbmcgaXMgbGlrZSAiYS5qcywgYi5jc3MsIGMudG1wbCIKCWZ1bmN0aW9uIGxvYWRBc3NldHNJblBhcmFsbGVsKCBhc3NldElkU3RyaW5nICkgewoJCXZhciBwcm9taXNlcyA9IFtdLAoJCQlydG5Qcm9taXNlLAoJCQlyZXNvdXJjZUFycmF5ID0gc3BsaXRCeUNvbW1hKCBhc3NldElkU3RyaW5nICk7CgoJCWlmIChyZXNvdXJjZUFycmF5Lmxlbmd0aCA9PT0gMSkgewoJCQlydG5Qcm9taXNlID0gbG9hZFN0YW5kYWxvbmVBc3NldCggcmVzb3VyY2VBcnJheVswXSApOwoJCX0KCQllbHNlIHsKCQkJZm9yICh2YXIgaSA9IDA7IGkgPCByZXNvdXJjZUFycmF5Lmxlbmd0aDsgaSsrKSB7CgkJCQlwcm9taXNlcy5wdXNoKCBsb2FkU3RhbmRhbG9uZUFzc2V0KCByZXNvdXJjZUFycmF5W2ldICkgKTsKCQkJfQoJCQlydG5Qcm9taXNlID0gJC53aGVuLmFwcGx5KCAkLCBwcm9taXNlcyApOwoJCX0KCgkJcmV0dXJuIGF1Z21lbnRQcm9taXNlKCBydG5Qcm9taXNlICkuZmFpbCggZnVuY3Rpb24oKSB7CgkJCV9sb2FkZXIudW5sb2FkKCBhc3NldElkU3RyaW5nICk7CgkJfSApOwoJfQoKCS8vcmVzb3VyY2VzIGNhbiBiZSAiYS5qcywgYi5jc3MsIGMudG1wbCIKCS8vaXQgY2FuIGJlIFsiYS5qcyIsICJiLmNzcyIsICJjLnRtcGwiXQoJLy9vciBbImEuanMsYi5jc3MiLCBbImMudG1wbCIsICJkLnRtcGwiXSwgImUuY3NzIl0gYW5kIHNvIG9uCgkvL2l0IHNlcmlhbCBsb2FkIHRoZSB0b3AgbGV2ZWwgcmVzb3VyY2UgdW5pdCwgd2l0aGluIGVhY2ggcmVzb3VyY2UgdW5pdCwgdXNlIHNtYXJ0CgkvL2xvYWRlcgoJZnVuY3Rpb24gbG9hZEFzc2V0c0luU2VyaWFsKCBhc3NldElkQXJyYXkgKSB7CgkJdmFyIHJ0blByb21pc2UsCgkJCWksCgkJCXRvUmVsZWFzZVJlc291cmNlID0gW10sCgkJCWN1cnJlbnRSZXNvdXJjZVN0cmluZ09yQXJyYXksCgkJCXNoYXJlZFN0YXRlID0gewoJCQkJb2s6IHRydWUKCQkJfTsKCgkJZm9yIChpID0gMDsgaSA8IGFzc2V0SWRBcnJheS5sZW5ndGg7IGkrKykgewoJCQljdXJyZW50UmVzb3VyY2VTdHJpbmdPckFycmF5ID0gYXNzZXRJZEFycmF5W2ldOwoJCQl0b1JlbGVhc2VSZXNvdXJjZS5wdXNoKCBjdXJyZW50UmVzb3VyY2VTdHJpbmdPckFycmF5ICk7CgoJCQlpZiAoaSA9PT0gMCkgewoKCQkJCXJ0blByb21pc2UgPSBsb2FkQXNzZXRzKCBjdXJyZW50UmVzb3VyY2VTdHJpbmdPckFycmF5ICkKCQkJCQkuZmFpbCggbWFrZVJlbGVhc2VGbiggY3VycmVudFJlc291cmNlU3RyaW5nT3JBcnJheSwgc2hhcmVkU3RhdGUgKSApOwoKCQkJfSBlbHNlIHsKCgkJCQlydG5Qcm9taXNlID0gcnRuUHJvbWlzZS5uZXh0TG9hZCggY3VycmVudFJlc291cmNlU3RyaW5nT3JBcnJheSApCgkJCQkJLmZhaWwoIG1ha2VSZWxlYXNlRm4oIHRvUmVsZWFzZVJlc291cmNlLnNsaWNlKCksIHNoYXJlZFN0YXRlICkgKTsKCQkJfQoJCX0KCgkJcmV0dXJuIGF1Z21lbnRQcm9taXNlKCBydG5Qcm9taXNlICk7Cgl9CgoJZnVuY3Rpb24gbWFrZVJlbGVhc2VGbiggcmVzb3VyY2VTdHJpbmdPckFycmF5LCBzaGFyZWRTdGF0ZSApIHsKCQlyZXR1cm4gZnVuY3Rpb24oKSB7CgkJCWlmIChzaGFyZWRTdGF0ZS5vaykgewoJCQkJX2xvYWRlci51bmxvYWQoIHJlc291cmNlU3RyaW5nT3JBcnJheSApOwoJCQkJc2hhcmVkU3RhdGUub2sgPSBmYWxzZTsKCQkJfQoJCX07Cgl9CgoJZnVuY3Rpb24gbG9hZFN0YW5kYWxvbmVBc3NldCggYXNzZXRJZCApIHsKCQl2YXIgbG9hZGVyID0gZmluZExvYWRlciggYXNzZXRJZCApOwoJCWlmIChsb2FkZXIpIHsKCgkJCXJldHVybiBsb2FkU3RhbmRhbG9uZUFzc2V0V2l0aExvYWRlciggYXNzZXRJZCwgbG9hZGVyICk7CgoJCX0gZWxzZSB7CgoJCQkvLyNkZWJ1ZwoJCQlfbG9hZGVyLmRlYnVnLmxvZyggInRyeSB0byBsb2FkIG1pc3NpbmcgbG9hZGVyICIgKyBmaWxlRXh0ZW5zaW9uKCBhc3NldElkICkgKyAiLmxvYWRlciIgKTsKCQkJLy8jZW5kX2RlYnVnCgoJCQlyZXR1cm4gX2xvYWRlci5sb2FkKCBmaWxlRXh0ZW5zaW9uKCBhc3NldElkICkgKyAiLmxvYWRlciIgKS5uZXh0TG9hZCggYXNzZXRJZCApOwoJCX0KCX0KCglmdW5jdGlvbiBsb2FkU3RhbmRhbG9uZUFzc2V0V2l0aExvYWRlciggYXNzZXRJZCwgbG9hZGVyICkgewoKCQkvLyNkZWJ1ZwoJCV9sb2FkZXIuZGVidWcubG9nKCAidHJ5IHRvIGxvYWQgIiArIGFzc2V0SWQgKyAiIEAgIiArIF9sb2FkZXIudXJsKCBhc3NldElkICkgKTsKCQkvLyNlbmRfZGVidWcKCgkJdmFyIHByb21pc2UgPSBhY2Nlc3NQcm9taXNlKCBhc3NldElkICk7CgoJCWlmICghcHJvbWlzZSkgewoKCQkJLy8jZGVidWcKCQkJX2xvYWRlci5kZWJ1Zy5sb2coICIgIGxvYWRpbmcgIiArIGFzc2V0SWQgKyAiIEAgIiArIF9sb2FkZXIudXJsKCBhc3NldElkICkgKTsKCQkJLy8jZW5kX2RlYnVnCgoJCQlwcm9taXNlID0gbG9hZGVyLmxvYWQoIGFzc2V0SWQgKTsKCgkJCWlmICghbG9hZGVyLm5vUmVmQ291bnQpIHsKCQkJCS8vYWRkIHRoZSBwcm9taXNlIHRvIGNhY2hlLAoJCQkJLy9pbiB0aGUgZnV0dXJlLCBpdCBjYW4gYmUgcmV0cmlldmVkIGJ5IGFjY2Vzc1Byb21pc2UoYXNzZXRJZCkKCQkJCWFjY2Vzc1Byb21pc2UoIGFzc2V0SWQsIHByb21pc2UgKTsKCQkJfQoJCX0KCQkvLyNkZWJ1ZwoJCWVsc2UgewoJCQlfbG9hZGVyLmRlYnVnLmxvZyggIiAgZm91bmQgbG9hZGVkIGFzc2V0ICIgKyBhc3NldElkICsgIiBAICIgKyBfbG9hZGVyLnVybCggYXNzZXRJZCApICk7CgkJfQoJCS8vI2VuZF9kZWJ1ZwoKCQkvL3ByZWxvYWQgYXNzZXQgd2lsbCBuZXZlciBiZSBjb3VudGVkIGZvciByZWZlcmVuY2UKCQkvL2FzIHdlIGRvbid0IHdhbnQgdGhhdCB0byBiZSB1bmxvYWRlZAoJCWlmIChwcm9taXNlLnJlZkNvdW50ICE9PSAic3RhdGljTG9hZGVkIikgewoJCQlwcm9taXNlLnJlZkNvdW50ID0gcHJvbWlzZS5yZWZDb3VudCA/IHByb21pc2UucmVmQ291bnQgKyAxIDogMTsKCQl9CgkJcmV0dXJuIHByb21pc2U7Cgl9CgoJLy9yZXRyaWV2ZSBwcm9taXNlIGJ5IGFzc2V0SWQgb3IKCS8vc2V0IHByb21pc2UgYnkgYXNzZXRJZAoJZnVuY3Rpb24gYWNjZXNzUHJvbWlzZSggYXNzZXRJZCwgcHJvbWlzZSApIHsKCQlpZiAoYXNzZXRJZCA9PT0gdW5kZWZpbmVkKSB7CgkJCXJldHVybiBwcm9taXNlU3RvcmU7CgkJfSBlbHNlIHsKCQkJaWYgKHByb21pc2UgPT09IHVuZGVmaW5lZCkgewoJCQkJaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDEpIHsKCQkJCQlyZXR1cm4gcHJvbWlzZVN0b3JlW2Fzc2V0SWRdOwoJCQkJfSBlbHNlIHsKCQkJCQlkZWxldGUgcHJvbWlzZVN0b3JlW2Fzc2V0SWRdOwoJCQkJfQoJCQl9IGVsc2UgewoJCQkJcHJvbWlzZVN0b3JlW2Fzc2V0SWRdID0gcHJvbWlzZTsKCQkJCXJldHVybiBwcm9taXNlOwoJCQl9CgkJfQoJfQoKCS8vYWRkIGEgcHJvbWlzZS5uZXh0TG9hZCBtZXRob2QgZHluYW1pY2FsbHksIHNvIHRoYXQgaXQgY2FuCgkvL2JlIHVzZWQgbG9hZCBvdGhlciBhc3NldCB3aGVuIGN1cnJlbnQgcHJvbWlzZSBmaW5pc2hlZAoJLy90aGUgbmV4dExvYWQgbWV0aG9kIGlzIGEgc21hcnRMb2FkIG1ldGhvZCwgdXNlIHRoZSBzYW1lIHdheSBpbiB3aGljaAoJLy95b3UgY2FsbCBsb2FkZXIKCWZ1bmN0aW9uIGF1Z21lbnRQcm9taXNlKCBwcm9taXNlICkgewoJCXZhciBuZXh0RGVmZXIgPSAkLkRlZmVycmVkKCk7CgoJCS8vbmV4dExvYWQgbWV0aG9kIGxvYWQgYWZ0ZXIgdGhlIGN1cnJlbnQgY3VycmVudFByb21pc2UgaXMgZG9uZQoJCXByb21pc2UubmV4dExvYWQgPSBmdW5jdGlvbiggYXNzZXRJZCApIHsKCQkJdmFyIG5leHRMb2FkQXJndW1lbnRzID0gc2xpY2UuY2FsbCggYXJndW1lbnRzICk7CgkJCXByb21pc2UudGhlbigKCQkJCWZ1bmN0aW9uKCkgewoJCQkJCV9sb2FkZXIubG9hZC5hcHBseSggbnVsbCwgbmV4dExvYWRBcmd1bWVudHMgKS50aGVuKAoJCQkJCQlmdW5jdGlvbigpIHsKCQkJCQkJCW5leHREZWZlci5yZXNvbHZlLmFwcGx5KCBuZXh0RGVmZXIsIHNsaWNlLmNhbGwoIGFyZ3VtZW50cyApICk7CgkJCQkJCX0sCgkJCQkJCWZ1bmN0aW9uKCkgewoJCQkJCQkJbmV4dERlZmVyLnJlamVjdCggYXNzZXRJZCApOwoJCQkJCQl9ICk7CgkJCQl9LAoJCQkJZnVuY3Rpb24oKSB7CgkJCQkJbmV4dERlZmVyLnJlamVjdCggYXNzZXRJZCApOwoJCQkJfSApOwoKCQkJcmV0dXJuIGF1Z21lbnRQcm9taXNlKCBuZXh0RGVmZXIucHJvbWlzZSgpICk7CgkJfTsKCgkJcHJvbWlzZS5hbmRMb2FkID0gZnVuY3Rpb24oKSB7CgkJCXZhciBjdXJyZW50UHJvbWlzZSA9IF9sb2FkZXIuYXBwbHkoIG51bGwsIGFyZ3VtZW50cyApOwoJCQlyZXR1cm4gYXVnbWVudFByb21pc2UoICQud2hlbiggY3VycmVudFByb21pc2UsIHByb21pc2UgKSApOwoJCX07CgoJCXJldHVybiBwcm9taXNlOwoJfQoKCWZ1bmN0aW9uIHNwbGl0QnlDb21tYSggdGV4dCApIHsKCQlyZXR1cm4gdGV4dC5yZXBsYWNlKCByU3BhY2UsICIiICkuc3BsaXQoIHJDb21tYSApOwoJfQoKCWZ1bmN0aW9uIGlzQ3Jvc3NEb21haW4oIHVybCApIHsKCQl2YXIgcGFydHMgPSByVXJsUGFydHMuZXhlYyggdXJsLnRvTG93ZXJDYXNlKCkgKTsKCQlyZXR1cm4gISEoIHBhcnRzICYmCgkJICAgICAgICAgICAoIHBhcnRzWyAxIF0gIT0gYWpheExvY1BhcnRzWyAxIF0gfHwgcGFydHNbIDIgXSAhPSBhamF4TG9jUGFydHNbIDIgXSB8fAoJCSAgICAgICAgICAgICAoIHBhcnRzWyAzIF0gfHwgKCBwYXJ0c1sgMSBdID09PSAiaHR0cDoiID8gODAgOiA0NDMgKSApICE9CgkJICAgICAgICAgICAgICggYWpheExvY1BhcnRzWyAzIF0gfHwgKCBhamF4TG9jUGFydHNbIDEgXSA9PT0gImh0dHA6IiA/IDgwIDogNDQzICkgKSApCgkJCSk7Cgl9CgoJZnVuY3Rpb24gZnVsbFVybCggdXJsUmVsYXRpdmVUb0Jhc2VVcmwgKSB7CgoJCWR1bW15TGluay5ocmVmID0gckFic29sdXRlVXJsLnRlc3QoIHVybFJlbGF0aXZlVG9CYXNlVXJsICkgPyB1cmxSZWxhdGl2ZVRvQmFzZVVybCA6CgkJCWJhc2VVcmwgKyB1cmxSZWxhdGl2ZVRvQmFzZVVybDsKCgkJcmV0dXJuIGlzQ3Jvc3NEb21haW4oIHVybFJlbGF0aXZlVG9CYXNlVXJsICkgPyBkdW1teUxpbmsuaHJlZiA6IGFkZEhhc2goIGR1bW15TGluay5ocmVmICk7Cgl9CgoJZnVuY3Rpb24gY29udmVydExvYWRGaWx0ZXJzVG9Mb2FkTWV0aG9kKCBsb2FkRmlsdGVycyApIHsKCgkJZm9yICh2YXIga2V5IGluIGxvYWRGaWx0ZXJzKSB7CgkJCWF0dGFjaEZpbHRlciggbG9hZEZpbHRlcnMsIGtleSApOwoJCX0KCgkJdmFyIHN0YXRpY0xvYWRlZCA9IGxvYWRGaWx0ZXJzLnN0YXRpY0xvYWRlZCB8fCBjb21tb25Mb2FkRmlsdGVycy5zdGF0aWNMb2FkZWQucmV0dXJuRmFsc2UsCgkJCWdldFNvdXJjZSA9IGxvYWRGaWx0ZXJzLmdldFNvdXJjZSB8fCBjb21tb25Mb2FkRmlsdGVycy5nZXRTb3VyY2UuZ2V0VGV4dEJ5QWpheCwKCQkJY29tcGlsZSA9IGxvYWRGaWx0ZXJzLmNvbXBpbGUgPT09IHVuZGVmaW5lZCA/IGNvbW1vbkxvYWRGaWx0ZXJzLmNvbXBpbGUuZ2xvYmFsRXZhbCA6IGxvYWRGaWx0ZXJzLmNvbXBpbGUsCgkJCWNyb3NzU2l0ZUxvYWQgPSBsb2FkRmlsdGVycy5jcm9zc1NpdGVMb2FkIHx8IGNvbW1vbkxvYWRGaWx0ZXJzLmNyb3NzU2l0ZUxvYWQuZ2V0U2NyaXB0LAoJCQlidWlsZERlcGVuZGVuY2llcyA9IGxvYWRGaWx0ZXJzLmJ1aWxkRGVwZW5kZW5jaWVzIHx8IGNvbW1vbkxvYWRGaWx0ZXJzLmJ1aWxkRGVwZW5kZW5jaWVzLnBhcnNlRGVwZW5kVGFnLAoJCQlidWlsZFVubG9hZCA9IGxvYWRGaWx0ZXJzLmJ1aWxkVW5sb2FkIHx8IGNvbW1vbkxvYWRGaWx0ZXJzLmJ1aWxkVW5sb2FkLnBhcnNlVW5sb2FkVGFnOwoKCQlpZiAoIWNvbXBpbGUgJiYgIWNyb3NzU2l0ZUxvYWQpIHsKCQkJdGhyb3cgImxvYWRlciBtdXN0IGltcGxlbWVudCBhdCBsZWFzdCBvbmUgb2YgY29tcGlsZSwgY3Jvc3NTaXRlTG9hZCI7CgkJfQoKCQlyZXR1cm4gZnVuY3Rpb24oIGFzc2V0SWQgKSB7CgkJCXZhciBkZWZlciA9ICQuRGVmZXJyZWQoKSwKCQkJCXByb21pc2UgPSBkZWZlci5wcm9taXNlKCksCgkJCQl1cmw7CgoJCQlpZiAoc3RhdGljTG9hZGVkKCBhc3NldElkICkpIHsKCgkJCQkvLyNkZWJ1ZwoJCQkJX2xvYWRlci5kZWJ1Zy5sb2coICIgICAgYnlwYXNzIHN0YXRpY0xvYWRlZGVkIGFzc2V0ICIgKyBhc3NldElkICsgIiBAICIgKyBfbG9hZGVyLnVybCggYXNzZXRJZCApICk7CgkJCQkvLyNlbmRfZGVidWcKCQkJCXByb21pc2UucmVmQ291bnQgPSAic3RhdGljTG9hZGVkIjsKCQkJCWRlZmVyLnJlc29sdmUoKTsKCgkJCX0gZWxzZSB7CgkJCQl1cmwgPSBfbG9hZGVyLnVybCggYXNzZXRJZCApOwoJCQkJaWYgKCFjb21waWxlIHx8IGxvYWRGaWx0ZXJzLmJ5UGFzc0dldFNvdXJjZSB8fCBpc0Nyb3NzRG9tYWluKCB1cmwgKSkgewoKCQkJCQlpZiAoIWNyb3NzU2l0ZUxvYWQpIHsKCQkJCQkJdGhyb3cgImxvYWRlciBkb2VzIG5vdCBzdXBwb3J0IGNyb3NzIGRvbWFpbiBsb2FkaW5nIjsKCQkJCQl9CgkJCQkJLy8jZGVidWcKCQkJCQlfbG9hZGVyLmRlYnVnLmxvZyggIiAgICBjcm9zcy1zaXRlIGZldGNoICIgKyBhc3NldElkICsgIiBAICIgKyB1cmwgKTsKCQkJCQkvLyNlbmRfZGVidWcKCgkJCQkJcmV0dXJuIGNyb3NzU2l0ZUxvYWQoIGFzc2V0SWQgKTsKCgkJCQl9IGVsc2UgewoKCQkJCQkvLyNkZWJ1ZwoJCQkJCV9sb2FkZXIuZGVidWcubG9nKCAiICAgIGxvY2FsIGZldGNoICIgKyBhc3NldElkICsgIiBAICIgKyB1cmwgKTsKCQkJCQkvLyNlbmRfZGVidWcKCgkJCQkJZ2V0U291cmNlKCBhc3NldElkICkudGhlbigKCQkJCQkJZnVuY3Rpb24oIHNvdXJjZUNvZGUgKSB7CgoJCQkJCQkJLy8jZGVidWcKCQkJCQkJCV9sb2FkZXIuZGVidWcubG9nKCAiICAgICAgcGFyc2luZyBjb250ZW50IG9mICIgKyBhc3NldElkICk7CgkJCQkJCQkvLyNlbmRfZGVidWcKCgkJCQkJCQlpZiAoYnVpbGRVbmxvYWQpIHsKCgkJCQkJCQkJLy8jZGVidWcKCQkJCQkJCQlfbG9hZGVyLmRlYnVnLmxvZyggIiAgICAgICAgYnVpbGRVbmxvYWQgZm9yICIgKyBhc3NldElkICk7CgkJCQkJCQkJLy8jZW5kX2RlYnVnCgoJCQkJCQkJCXZhciB1bmxvYWQgPSBidWlsZFVubG9hZCggc291cmNlQ29kZSwgYXNzZXRJZCApOwoKCQkJCQkJCQlpZiAodW5sb2FkKSB7CgkJCQkJCQkJCS8vI2RlYnVnCgkJCQkJCQkJCV9sb2FkZXIuZGVidWcubG9nKCAiICAgICAgICAgIHVubG9hZCBjcmVhdGVkIGZvciAiICsgYXNzZXRJZCApOwoJCQkJCQkJCQkvLyNlbmRfZGVidWcKCgkJCQkJCQkJCWFjY2Vzc1Byb21pc2UoIGFzc2V0SWQgKS51bmxvYWQgPSB1bmxvYWQ7CgkJCQkJCQkJfQoKCQkJCQkJCX0KCgkJCQkJCQlpZiAoYnVpbGREZXBlbmRlbmNpZXMpIHsKCgkJCQkJCQkJLy8jZGVidWcKCQkJCQkJCQlfbG9hZGVyLmRlYnVnLmxvZyggIiAgICAgICAgYnVpbGREZXBlbmRlbmNpZXMgZm9yICIgKyBhc3NldElkICk7CgkJCQkJCQkJLy8jZW5kX2RlYnVnCgoJCQkJCQkJCXZhciBlbWJlZGRlZERlcGVuZGVuY2llcyA9IGJ1aWxkRGVwZW5kZW5jaWVzKCBhc3NldElkLCBzb3VyY2VDb2RlICk7CgkJCQkJCQkJaWYgKGVtYmVkZGVkRGVwZW5kZW5jaWVzKSB7CgkJCQkJCQkJCS8vI2RlYnVnCgkJCQkJCQkJCV9sb2FkZXIuZGVidWcubG9nKCAiICAgICAgICAgIGRlcGVuZGVuY2llcyBmb3VuZCBmb3IgIiArIGFzc2V0SWQgKyAiOiIgKyBlbWJlZGRlZERlcGVuZGVuY2llcyApOwoJCQkJCQkJCQkvLyNlbmRfZGVidWcKCQkJCQkJCQkJZGVwZW5kKCBhc3NldElkLCBlbWJlZGRlZERlcGVuZGVuY2llcyApOwoJCQkJCQkJCX0KCQkJCQkJCX0KCgkJCQkJCQl2YXIgcnVuY29tcGlsZSA9IGZ1bmN0aW9uKCkgewoKCQkJCQkJCQkvLyNkZWJ1ZwoJCQkJCQkJCV9sb2FkZXIuZGVidWcubG9nKCAiICAgICAgY29tcGlsaW5nICIgKyBhc3NldElkICsgIiBAICIgKyB1cmwgKTsKCQkJCQkJCQkvLyNlbmRfZGVidWcKCgkJCQkJCQkJdmFyIHJlc3VsdCA9IGNvbXBpbGUgJiYgY29tcGlsZSggYXNzZXRJZCwgc291cmNlQ29kZSApOwoJCQkJCQkJCS8vZGVsYXkgZGVmZXIucmVzb2x2ZSBhIGZvciB3aGlsZSB0byB3YWl0IGZvciB0aGUgY29tcGlsZSByZXN1bHQKCQkJCQkJCQkvL3RvIHRha2UgZWZmZWN0LCBpZiBjb21waWxlIGlzICQuZ2xvYmFsRXZhbAoJCQkJCQkJCXNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCQkJCQkJCQlpZiAoIWRlZmVyLmRvbnRSZXNvbHZlKSB7CgkJCQkJCQkJCQlkZWZlci5yZXNvbHZlKCByZXN1bHQgKTsKCQkJCQkJCQkJCWRlbGV0ZSBwcm9taXNlLmRlZmVyOwoJCQkJCQkJCQl9CgkJCQkJCQkJfSwgNSApOwoJCQkJCQkJfTsKCgkJCQkJCQl2YXIgZGVwZW5kZW5jaWVzID0gZGVwZW5kKCBhc3NldElkICk7CgoJCQkJCQkJLy9sb2FkIGRlcGVuZGVuY2llcyBiZWNhdXNlIGl0IGNvbWJpbmVzIHN0YXRpYyBkZXBlbmRlbnRNb2R1bGVTdHJpbmcKCQkJCQkJCS8vYW5kIGR5bmFtaWMgZGVwZW5kZW50TW9kdWxlU3RyaW5nCgkJCQkJCQlpZiAoZGVwZW5kZW5jaWVzKSB7CgkJCQkJCQkJX2xvYWRlci5sb2FkKCBkZXBlbmRlbmNpZXMgKS50aGVuKCBydW5jb21waWxlLCBmdW5jdGlvbigpIHsKCQkJCQkJCQkJZGVmZXIucmVqZWN0KCBhc3NldElkICk7CgkJCQkJCQkJCWRlbGV0ZSBwcm9taXNlLmRlZmVyOwoJCQkJCQkJCX0gKTsKCQkJCQkJCX0gZWxzZSB7CgkJCQkJCQkJcnVuY29tcGlsZSgpOwoJCQkJCQkJfQoKCQkJCQkJfSwKCQkJCQkJZnVuY3Rpb24oKSB7CgkJCQkJCQlkZWZlci5yZWplY3QoIGFzc2V0SWQgKTsKCQkJCQkJCWRlbGV0ZSBwcm9taXNlLmRlZmVyOwoJCQkJCQl9CgkJCQkJKTsKCQkJCX0KCQkJCWlmICghaXNSZXNvbHZlZCggZGVmZXIgKSkgewoJCQkJCXByb21pc2UuZGVmZXIgPSBkZWZlcjsKCQkJCX0KCQkJfQoJCQlyZXR1cm4gcHJvbWlzZTsKCQl9OwoJfQoKCXZhciBpc1Jlc29sdmVkID0gJC5EZWZlcnJlZCgpLmlzUmVzb2x2ZWQgPyBmdW5jdGlvbiggcHJvbWlzZSApIHsKCQlyZXR1cm4gcHJvbWlzZS5pc1Jlc29sdmVkKCk7Cgl9IDogZnVuY3Rpb24oIHByb21pc2UgKSB7CgkJcmV0dXJuIHByb21pc2Uuc3RhdGUoKSA9PSAicmVzb2x2ZWQiOwoJfTsKCglmdW5jdGlvbiBhZGRIYXNoKCB1cmwgKSB7CgkJdXJsID0gcmVtb3ZlSGFzaCggdXJsICk7CgkJcmV0dXJuIGhhc2hWYWx1ZSA/CgkJCXVybCArICggclF1ZXJ5LnRlc3QoIHVybCApID8gIiYiIDogIj8iICkgKyBoYXNoS2V5ICsgIj0iICsgaGFzaFZhbHVlIDoKCQkJdXJsOwoJfQoKCWZ1bmN0aW9uIHJlbW92ZUhhc2goIHVybCApIHsKCQlpZiAoaGFzaFZhbHVlID09PSAiIikgewoJCQlyZXR1cm4gdXJsOwoJCX0gZWxzZSB7CgkJCXJldHVybiB1cmwucmVwbGFjZSggclZlcnNpb25IYXNoLCAiIiApOwoJCX0KCX0KCgkkLmV4dGVuZCggX2xvYWRlciwgewoKCQkvL2ZvciBwYXJhbGxlbCBsb2FkaW5nCgkJLy8KCQkvLyBsb2FkZXIubG9hZChhc3NldElkU3RyaW5nKQoJCS8vIGxvYWRlci5sb2FkKGFzc2V0SWRTdHJpbmcsIHVzZUltcGxpY2l0RGVwZW5kZW5jaWVzKQoJCS8vIGxvYWRlci5sb2FkKGhvbGRSZWFkeSwgYXNzZXRJZFN0cmluZykKCQkvLyBsb2FkZXIubG9hZChob2xkUmVhZHksIGFzc2V0SWRTdHJpbmcsIHVzZUltcGxpY2l0RGVwZW5kZW5jaWVzKQoJCS8vCgkJLy9mb3Igc2VyaWFsIGxvYWRpbmcgYW5kIG1peGVkIHNlcmlhbC9wYXJhbGxlbCBsb2FkaW5nIGxvYWRlcgoJCS8vCgkJLy8gbG9hZGVyLmxvYWQoYXNzZXRJZEFycmF5KQoJCS8vIGxvYWRlci5sb2FkKGhvbGRSZWFkeSBhc3NldElkQXJyYXkpCgkJLy8KCQlsb2FkOiBmdW5jdGlvbiggaG9sZFJlYWR5LCBhc3NldElkcywgaW5mZXJEZXBlbmRlbmNpZXNGcm9tSWRPcmRlciApIHsKCQkJdmFyIHJ0blByb21pc2U7CgkJCWlmICghaXNCb29sZWFuKCBob2xkUmVhZHkgKSkgewoJCQkJLy9ieSBkZWZhdWx0IGl0IGlzIGZhbHNlCgkJCQlpbmZlckRlcGVuZGVuY2llc0Zyb21JZE9yZGVyID0gYXNzZXRJZHM7CgkJCQlhc3NldElkcyA9IGhvbGRSZWFkeTsKCQkJCWhvbGRSZWFkeSA9IGZhbHNlOwoJCQl9CgkJCWlmICghYXNzZXRJZHMpIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJaG9sZFJlYWR5ID0gaG9sZFJlYWR5ICYmICEkLmlzUmVhZHk7CgoJCQlydG5Qcm9taXNlID0gbG9hZEFzc2V0cyggYXNzZXRJZHMsIGluZmVyRGVwZW5kZW5jaWVzRnJvbUlkT3JkZXIgKTsKCgkJCWlmIChob2xkUmVhZHkpIHsKCgkJCQkkLmhvbGRSZWFkeSggdHJ1ZSApOwoKCQkJCXJ0blByb21pc2UuZG9uZSggZnVuY3Rpb24oKSB7CgkJCQkJJC5ob2xkUmVhZHkoKTsKCQkJCQkvL3NhbWUgYXMgdGhlIGZvbGxvd2luZwoJCQkJCS8vJC5ob2xkUmVhZHkoIGZhbHNlICk7CgkJCQkJLy8kLnJlYWR5KCB0cnVlICk7CgkJCQl9ICk7CgkJCX0KCgkJCXJldHVybiBydG5Qcm9taXNlLmRvbmUoIGludm9rZUxvYWRDYWxsYmFja3MgKS5mYWlsKCBpbnZva2VGYWlsQ2FsbGJhY2tzICk7CgkJfSwKCQkvL3VubG9hZChsb2FkQ2FsbGJhY2spIG9yIHVubG9hZCh1bmxvYWRDYWxsYmFjaywgcmVtb3ZlPXRydWUpCgkJLy91bmxvYWQoYXNzZXRJZFN0cmluZykKCQkvL3VubG9hZChhc3NldElkQXJyYXkpCgkJdW5sb2FkOiBmdW5jdGlvbiggYXNzZXRJZHMsIHJlbW92ZSApIHsKCQkJdmFyIGksCgkJCQlhc3NldElkLAoJCQkJZGVwZW5kZW5jaWVzLAoJCQkJcHJvbWlzZTsKCgkJCWlmICgkLmlzRnVuY3Rpb24oIGFzc2V0SWRzICkpIHsKCQkJCWlmIChyZW1vdmUpIHsKCQkJCQl1bmxvYWRDYWxsYmFja3MucmVtb3ZlKCBhc3NldElkcyApOwoJCQkJfSBlbHNlIHsKCQkJCQl1bmxvYWRDYWxsYmFja3MucHVzaCggYXNzZXRJZHMgKTsKCQkJCX0KCgkJCX0gZWxzZSB7CgoJCQkJaWYgKGlzU3RyaW5nKCBhc3NldElkcyApKSB7CgkJCQkJYXNzZXRJZHMgPSBzcGxpdEJ5Q29tbWEoIGFzc2V0SWRzICk7CgkJCQl9CgoJCQkJLy9pZiB0aGVyZSBpcyBvbmx5IG9uZSBtb2R1bGUKCQkJCWlmIChhc3NldElkcy5sZW5ndGggIT0gMSkgewoKCQkJCQlmb3IgKGkgPSAwOyBpIDwgYXNzZXRJZHMubGVuZ3RoOyBpKyspIHsKCQkJCQkJX2xvYWRlci51bmxvYWQoIGFzc2V0SWRzW2ldICk7CgkJCQkJfQoKCQkJCX0gZWxzZSB7CgoJCQkJCS8vdW5sb2FkIHNlcnZlcmFsIG1vZHVsZXMKCQkJCQlhc3NldElkID0gYXNzZXRJZHNbMF07CgkJCQkJcHJvbWlzZSA9IGFjY2Vzc1Byb21pc2UoIGFzc2V0SWQgKTsKCgkJCQkJLy9tYWtlIHN1cmUgaXQgd2lsbCBub3QgdGhyb3cgZXhjZXB0aW9uIHdoZW4KCQkJCQkvLyB1bmxvYWRpbmcgc29tZSBtb2R1bGUgd2hpY2ggaXMgbm90IGluIHBhZ2UKCQkJCQlpZiAocHJvbWlzZSAmJiBwcm9taXNlLnJlZkNvdW50ICE9ICJzdGF0aWNMb2FkZWQiKSB7CgoJCQkJCQlpZiAoLS1wcm9taXNlLnJlZkNvdW50ID09PSAwIHx8IHJlbW92ZSkgewoJCQkJCQkJdmFyIHVubG9hZCA9IHByb21pc2UudW5sb2FkIHx8IGZpbmRMb2FkZXIoIGFzc2V0SWQgKS51bmxvYWQ7CgoJCQkJCQkJaWYgKHVubG9hZCkgewoJCQkJCQkJCS8vI2RlYnVnCgkJCQkJCQkJX2xvYWRlci5kZWJ1Zy5sb2coICJ1bmxvYWRpbmcgIiArIGFzc2V0SWQgKyAiIEAgIiArIF9sb2FkZXIudXJsKCBhc3NldElkICkgKTsKCQkJCQkJCQkvLyNlbmRfZGVidWcKCQkJCQkJCQl1bmxvYWQoIGFzc2V0SWQgKTsKCQkJCQkJCX0KCgkJCQkJCQkvL2RlbGV0ZSB0aGUgcHJvbWlzZXMgYXNzb2NpYXRlZCB3aXRoIHRoZSBtb2R1bGUKCQkJCQkJCWFjY2Vzc1Byb21pc2UoIGFzc2V0SWQsIHVuZGVmaW5lZCApOwoJCQkJCQkJZGVwZW5kZW5jaWVzID0gZGVwZW5kKCBhc3NldElkICk7CgkJCQkJCQlpZiAoZGVwZW5kZW5jaWVzKSB7CgkJCQkJCQkJX2xvYWRlci51bmxvYWQoIGRlcGVuZGVuY2llcywgcmVtb3ZlICk7CgkJCQkJCQkJZGVwZW5kKCBhc3NldElkLCB1bmRlZmluZWQgKTsKCQkJCQkJCX0KCgkJCQkJCX0KCQkJCQkJaW52b2tlVW5sb2FkQ2FsbGJhY2tzKCk7CgkJCQkJfQoJCQkJfQoJCQl9CgkJfSwKCgkJLy9yZWdpc3RlciBhIHVybCBmb3IgbW9kdWxlIGtleQoJCS8vb3IgZ2V0IHRoZSB1cmwgb2YgbW9kdWxlIGtleQoJCXVybDogZnVuY3Rpb24oIGFzc2V0SWQsIHVybCApIHsKCQkJaWYgKGlzT2JqZWN0KCBhc3NldElkICkpIHsKCQkJCWZvciAodmFyIGsgaW4gYXNzZXRJZCkgewoJCQkJCV9sb2FkZXIudXJsKCBrLCBhc3NldElkW2tdICk7CgkJCQl9CgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vaWYgcmVzb3VyY2UncyB1cmwgaXMgbm90IGluIGNhY2hlCgkJCS8vYW5kIHVzZXIgaXMgdHJ5aW5nIHRvIGdldCBpdAoJCQlpZiAodXJsID09PSB1bmRlZmluZWQpIHsKCgkJCQlpZiAoYXJndW1lbnRzLmxlbmd0aCA9PSAxKSB7CgoJCQkJCWlmICh1cmxTdG9yZVthc3NldElkXSkgewoJCQkJCQlyZXR1cm4gdXJsU3RvcmVbYXNzZXRJZF07CgkJCQkJfQoKCQkJCQl2YXIgbG9hZGVyID0gZmluZExvYWRlciggYXNzZXRJZCApOwoKCQkJCQlyZXR1cm4gZnVsbFVybCgKCQkJCQkJbG9hZGVyICYmIGxvYWRlci51cmwgPyBsb2FkZXIudXJsKCBhc3NldElkICkgOgoJCQkJCQkJbG9hZGVyICYmIGxvYWRlci5maWxlRXh0ID8gZmlsZU5hbWUoIGFzc2V0SWQgKSArICIuIiArIGxvYWRlci5maWxlRXh0IDoKCQkJCQkJCQlhc3NldElkCgkJCQkJKTsKCgkJCQl9IGVsc2UgewoKCQkJCQkvL2FsbG93IGFjY2VzcyhrZXksIHVuZGVmaW5lZCkKCQkJCQkvL3RvIGRlbGV0ZSB0aGUga2V5IGZyb20gc3RvcmFnZQoJCQkJCWRlbGV0ZSB1cmxTdG9yZVthc3NldElkXTsKCQkJCX0KCgkJCX0gZWxzZSB7CgkJCQkvL3VzZXIgZXhwbGljaXQgcmVnaXN0ZXIgYW4gdXJsCgkJCQl2YXIgb2xkVXJsID0gX2xvYWRlci51cmwoIGFzc2V0SWQgKTsKCQkJCXZhciBuZXdVcmwgPSBmdWxsVXJsKCB1cmwgKTsKCgkJCQlpZiAob2xkVXJsICE9IG5ld1VybCkgewoJCQkJCXZhciBvbGRQcm9taXNlID0gYWNjZXNzUHJvbWlzZSggYXNzZXRJZCApOwoJCQkJCWlmIChvbGRQcm9taXNlICYmIGlzUmVzb2x2ZWQoIG9sZFByb21pc2UgKSkgewoJCQkJCQlyZWxvYWQoIGFzc2V0SWQsIGZ1bmN0aW9uKCkgewoJCQkJCQkJdXJsU3RvcmVbYXNzZXRJZF0gPSBuZXdVcmw7CgkJCQkJCX0gKTsKCQkJCQl9IGVsc2UgewoJCQkJCQl1cmxTdG9yZVthc3NldElkXSA9IG5ld1VybDsKCQkJCQl9CgkJCQl9CgkJCX0KCQl9LAoKCQkvLyBtZW1iZXJzIHRvIGNvbmZpZ3VyZSBsb2FkZXIKCgkJLy9hZGQgZGVwZW5kZW5jeSB0byBhIHJlc291cmNlIGtleQoJCS8vb3IgZ2V0IHRoZSBkZXBlbmRlbmN5IG9mIGEgcmVzb3VyY2Uga2V5CgkJLy91c2VyIGNhbiBzZXQgZGVwZW5kZW50UmVzb3VyY2VTdHJpbmcgbWFudWFsbHkgLCB3aGljaCBpcyBjYWxsZWQgc3RhdGljCgkJLy9kZXBlbmRlbnRSZXNvdXJjZVN0cmluZwoJCS8vIG9yIGNhbiB1c2UgbG9hZGVyLmRlcGVuZCBtZXRob2QgdG8gcmV0dXJuIGRlcGVuZGVudFJlc291cmNlU3RyaW5nIHdoaWNoIGlzIGNhbGxlZAoJCS8vZHluYW1pYyBkZXBlbmRlbnRSZXNvdXJjZVN0cmluZywKCQkvL29yIHdlIGNhbiBjb21iaW5lIHRoZW0gdG9nZXRoZXIKCQlkZXBlbmQ6IGRlcGVuZCA9IGZ1bmN0aW9uKCBhc3NldElkLCBkZXBlbmRlbmNpZXMgKSB7CgoJCQlpZiAoaXNPYmplY3QoIGFzc2V0SWQgKSkgewoJCQkJZm9yICh2YXIga2V5IGluIGFzc2V0SWQpIHsKCQkJCQlkZXBlbmQoIGtleSwgYXNzZXRJZFtrZXldICk7CgkJCQl9CgkJCQlyZXR1cm47CgkJCX0KCgkJCWlmIChkZXBlbmRlbmNpZXMgPT09IHVuZGVmaW5lZCkgewoJCQkJLy9nZXQgZGVwZW5kZW5jaWVzCgkJCQlpZiAoYXJndW1lbnRzLmxlbmd0aCA9PSAxKSB7CgkJCQkJdmFyIHN0YXRpY0RlcGVuZGVuY2llcyA9IGRlcGVuZGVuY3lTdG9yZVthc3NldElkXTsKCQkJCQl2YXIgbG9hZGVyID0gZmluZExvYWRlciggYXNzZXRJZCApOwoKCQkJCQlpZiAobG9hZGVyICYmIGxvYWRlci5kZXBlbmQpIHsKCQkJCQkJdmFyIGR5bmFtaWNEZXBlbmRlbmNpZXMgPSBsb2FkZXIuZGVwZW5kKCBhc3NldElkICk7CgkJCQkJCWlmIChkeW5hbWljRGVwZW5kZW5jaWVzICYmIHN0YXRpY0RlcGVuZGVuY2llcykgewoJCQkJCQkJcmV0dXJuIGR5bmFtaWNEZXBlbmRlbmNpZXMgKyAiLCIgKyBzdGF0aWNEZXBlbmRlbmNpZXM7CgkJCQkJCX0gZWxzZSBpZiAoZHluYW1pY0RlcGVuZGVuY2llcykgewoJCQkJCQkJcmV0dXJuIGR5bmFtaWNEZXBlbmRlbmNpZXM7CgkJCQkJCX0gZWxzZSB7CgkJCQkJCQlyZXR1cm4gc3RhdGljRGVwZW5kZW5jaWVzOwoJCQkJCQl9CgkJCQkJfSBlbHNlIHsKCQkJCQkJcmV0dXJuIHN0YXRpY0RlcGVuZGVuY2llczsKCQkJCQl9CgoJCQkJfSBlbHNlIHsKCQkJCQkvL2RlbGV0ZSBkZXBlbmRlbmNpZXMKCQkJCQlkZWxldGUgZGVwZW5kZW5jeVN0b3JlW2Fzc2V0SWRdOwoJCQkJfQoKCQkJfSBlbHNlIGlmIChkZXBlbmRlbmNpZXMgPT09IHRydWUpIHsKCQkJCS8vZm9yIGRlYnVnZ2luZyBwdXJwdXNlIGxvYWRlci5kZXBlbmQoYXNzZXRJZCwgdHJ1ZSkKCQkJCXZhciBhc3NldElkcyA9IGRlcGVuZCggYXNzZXRJZCApOwoJCQkJYXNzZXRJZHMgPSBhc3NldElkcyAmJiBzcGxpdEJ5Q29tbWEoIGFzc2V0SWRzICk7CgkJCQlpZiAoYXNzZXRJZHMpIHsKCQkJCQl2YXIgcnRuID0gW107CgkJCQkJZm9yICh2YXIgaSA9IDA7IGkgPCBhc3NldElkcy5sZW5ndGg7IGkrKykgewoJCQkJCQlpZiAoX2xvYWRlci5maWxlRXh0KCBhc3NldElkc1tpXSApICE9PSAibW9kdWxlIikgewoJCQkJCQkJcnRuLnB1c2hVbmlxdWUoIF9sb2FkZXIudXJsKCBhc3NldElkc1tpXSApICk7CgkJCQkJCX0KCQkJCQkJcnRuLm1lcmdlKCBkZXBlbmQoIGFzc2V0SWRzW2ldLCB0cnVlICkgKTsKCQkJCQl9CgkJCQkJcmV0dXJuIHJ0bjsKCQkJCX0KCgkJCX0gZWxzZSB7CgkJCQl2YXIgbmV3U3RhdGljRGVwZW5kZW5jaWVzID0gZ2V0TmV3U3RhdGljRGVwZW5kZW5jaWVzKCBhc3NldElkLCBkZXBlbmRlbmNpZXMgKTsKCQkJCXZhciBvbGRTdGF0aWNEZXBlbmRlbmNpZXMgPSBkZXBlbmRlbmN5U3RvcmVbYXNzZXRJZF07CgoJCQkJaWYgKGlzRGVwZW5kZW5jaWVzRGlmZmVyZW50KCBuZXdTdGF0aWNEZXBlbmRlbmNpZXMsIG9sZFN0YXRpY0RlcGVuZGVuY2llcyApKSB7CgoJCQkJCXZhciBvbGRQcm9taXNlID0gYWNjZXNzUHJvbWlzZSggYXNzZXRJZCApOwoJCQkJCWlmIChvbGRTdGF0aWNEZXBlbmRlbmNpZXMgJiYgb2xkUHJvbWlzZSAmJiBpc1Jlc29sdmVkKCBvbGRQcm9taXNlICkpIHsKCQkJCQkJcmVsb2FkKCBhc3NldElkLCBmdW5jdGlvbigpIHsKCQkJCQkJCWRlcGVuZGVuY3lTdG9yZVthc3NldElkXSA9IG5ld1N0YXRpY0RlcGVuZGVuY2llczsKCQkJCQkJfSApOwoJCQkJCX0gZWxzZSB7CgkJCQkJCWRlcGVuZGVuY3lTdG9yZVthc3NldElkXSA9IG5ld1N0YXRpY0RlcGVuZGVuY2llczsKCQkJCQl9CgkJCQl9CgkJCX0KCQl9LAoKCQkvL3RoZSB1cmwgcmVsYXRpdmUgdG8gdGhlIGN1cnJlbnQgd2luZG93IGxvY2F0aW9uLCBmb3IgZXhhbXBsZSAianMvIgoJCS8vdGhlIHN1ZmZpeCAiLyIgaXMgaW1wb3J0YW50CgkJLy9pdCBpcyB1c2VkIHRvIGNhbGN1bGF0ZSB0aGUgcmVhbCByZWxhdGl2ZSB1cmwgb2YgcmVzb3VyY2Uga2V5CgkJYmFzZVVybDogZnVuY3Rpb24oIHVybFJlbGF0aXZlVG9QYWdlICkgewoJCQlpZiAoaXNVbmRlZmluZWQoIHVybFJlbGF0aXZlVG9QYWdlICkpIHsKCQkJCXJldHVybiBiYXNlVXJsOwoJCQl9CgkJCWJhc2VVcmwgPSB1cmxSZWxhdGl2ZVRvUGFnZS5lbmRzV2l0aCggIi8iICkgPyB1cmxSZWxhdGl2ZVRvUGFnZSA6IHVybFJlbGF0aXZlVG9QYWdlICsgIi8iOwoJCX0sCgoJCS8vbG9hZGVyLmhhc2godHJ1ZSkgLS0+IHNldCBhIHRpbWVzdGFtcCBhcyBoYXNoID92PTIzNDc0ODM3NDgKCQkvL2xvYWRlci5oYXNoKDEseCkgLS0+ID94PTEKCQkvL2xvYWRlci5oYXNoKDEpIC0tPiA/dj0xCgkJaGFzaDogZnVuY3Rpb24oIHZhbHVlLCBrZXkgKSB7CgkJCWlmIChhcmd1bWVudHMubGVuZ3RoKSB7CgkJCQloYXNoVmFsdWUgPSB2YWx1ZSA9PT0gdHJ1ZSA/ICQubm93KCkgOiB2YWx1ZTsKCQkJCWhhc2hLZXkgPSBrZXkgIT09IHVuZGVmaW5lZCA/IGtleSA6IChoYXNoS2V5IHx8ICJ2Iik7CgkJCQlyVmVyc2lvbkhhc2ggPSBuZXcgUmVnRXhwKCAiWz8mXSIgKyBoYXNoS2V5ICsgIj1bXiZdKiIgKTsKCQkJfQoJCQlyZXR1cm4gaGFzaFZhbHVlID09PSAiIiA/ICIiIDogaGFzaEtleSArICI9IiArIGhhc2hWYWx1ZTsKCQl9LAoKCQkvL3N1cHBvcnQgbWV0aG9kIGxvYWQsIHVubG9hZCwgdXJsLCBkZXBlbmQKCQltZXRob2RzOiBjb21tb25Mb2FkZXJNZXRob2RzID0gewoKCQkJbG9hZDogewoJCQkJY2FjaGVJbWFnZTogZnVuY3Rpb24oIGFzc2V0SWQgKSB7CgkJCQkJdmFyIGRlZmVyID0gJC5EZWZlcnJlZCgpLAoJCQkJCQlwcm9taXNlID0gZGVmZXIucHJvbWlzZSgpLAoJCQkJCQl1cmwgPSBfbG9hZGVyLnVybCggYXNzZXRJZCApOwoKCQkJCQl2YXIgaW1nID0gbmV3IEltYWdlKCk7CgkJCQkJaW1nID0gbmV3IEltYWdlKCk7CgkJCQkJaW1nLm9ubG9hZCA9IGZ1bmN0aW9uKCkgewoJCQkJCQlkZWZlci5yZXNvbHZlKCB1cmwgKTsKCQkJCQl9OwoJCQkJCWltZy5vbmVycm9yID0gZnVuY3Rpb24oKSB7CgkJCQkJCWRlZmVyLnJlamVjdCggdXJsICk7CgkJCQkJfTsKCQkJCQlpbWcuc3JjID0gdXJsOwoJCQkJCXJldHVybiBwcm9taXNlOwoJCQkJfQoKCQkJfSwKCQkJdW5sb2FkOiB7CgkJCQlyZW1vdmVDc3NMaW5rVGFnOiBmdW5jdGlvbiggYXNzZXRJZCApIHsKCQkJCQl2YXIgdXJsID0gZnVsbFVybCggX2xvYWRlci51cmwoIGFzc2V0SWQgKSApOwoJCQkJCSQoICJsaW5rIiApLmZpbHRlcigKCQkJCQkJZnVuY3Rpb24oKSB7CgkJCQkJCQlyZXR1cm4gdGhpcy5ocmVmID09PSB1cmwgJiYgJCggdGhpcyApLmF0dHIoICdsb2FkZWRCeWxvYWRlcicgKTsKCQkJCQkJfSApLnJlbW92ZSgpOwoJCQkJfQoJCQl9LAoJCQl1cmw6IHsKCQkJCWFzc2V0SWQ6IGZ1bmN0aW9uKCBhc3NldElkICkgewoJCQkJCXJldHVybiBhc3NldElkOwoJCQkJfSwKCQkJCS8vdGhpcyB1cmwgZXhwZWN0IG1vZHVsZSBpcyBwdXQgaW50byBpdHMgZm9sZGVyIHVuZGVyIGJhc2VVcmwKCQkJCS8vaWYgdGhlIGxvYWRlciBuYW1lIGlzICJhcHAiLCB3ZSBzaG91bGQgcHV0IHRoZSByZXNvdXJjZSBmaWxlIGludG8KCQkJCS8vYmFzZVVybC9hcHAgZm9sZGVyCgkJCQlmb2xkZXI6IGZ1bmN0aW9uKCBhc3NldElkICkgewoKCQkJCQl2YXIgZmlsZUV4dCA9IGZpbmRMb2FkZXIoIGFzc2V0SWQgKS5maWxlRXh0LAoJCQkJCQlmaWxlTmFtZSA9IGZpbGVFeHQgPyBfbG9hZGVyLmZpbGVOYW1lKCBhc3NldElkICkgKyAiLiIgKyBmaWxlRXh0IDoKCQkJCQkJCWFzc2V0SWQsCgkJCQkJCWxvYWRlck5hbWUgPSBfbG9hZGVyLmZpbGVFeHQoIGFzc2V0SWQgKTsKCgkJCQkJcmV0dXJuIGxvYWRlck5hbWUgKyAiLyIgKyBmaWxlTmFtZTsKCQkJCX0KCQkJfSwKCgkJCWRlcGVuZDogewoJCQkJLy9uYW1lOiBmdW5jdGlvbiAoYXNzZXRJZCkgewoJCQkJLy8gcmV0dXJuIGEgYXNzZXRJZFN0cmluZyBvciBhc3NldElkQXJyYXkKCQkJCS8vIHJldHVybiAiYS5odG1sLCBiLmpzIgoJCQkJLy8gfQoJCQl9CgkJfSwKCgkJbG9hZEZpbHRlcnM6IGNvbW1vbkxvYWRGaWx0ZXJzID0gewoKCQkJc3RhdGljTG9hZGVkOiB7CgkJCQkvL2RlZmF1bHQgc3RhdGljTG9hZGVkIGZpbHRlcgoJCQkJcmV0dXJuRmFsc2U6IGZ1bmN0aW9uKCkgewoJCQkJCXJldHVybiBmYWxzZTsKCQkJCX0sCgoJCQkJaGFzU2NyaXB0VGFnOiBmdW5jdGlvbiggYXNzZXRJZCApIHsKCQkJCQlyZXR1cm4gISEoJCggInNjcmlwdCIgKS5maWx0ZXIoCgkJCQkJCWZ1bmN0aW9uKCkgewoJCQkJCQkJcmV0dXJuIHJlbW92ZUhhc2goIHRoaXMuc3JjICkgPT09IHJlbW92ZUhhc2goIF9sb2FkZXIudXJsKCBhc3NldElkICkgKTsKCQkJCQkJfSApLmxlbmd0aCk7CgkJCQl9CgoJCQl9LAoKCQkJZ2V0U291cmNlOiB7CgkJCQkvL3RoaXMgaXMgZGVmYXVsdCBnZXRTb3VyY2UgZmlsdGVyCgkJCQlnZXRUZXh0QnlBamF4OiBmdW5jdGlvbiggYXNzZXRJZCApIHsKCQkJCQlyZXR1cm4gJC5hamF4KCB7CgkJCQkJCXVybDogX2xvYWRlci51cmwoIGFzc2V0SWQgKSwKCQkJCQkJZGF0YVR5cGU6ICJ0ZXh0IiwKCQkJCQkJY2FjaGU6IHRydWUKCQkJCQl9ICk7CgkJCQl9CgkJCX0sCgoJCQljb21waWxlOiB7CgkJCQlnbG9iYWxFdmFsOiBmdW5jdGlvbiggYXNzZXRJZCwgc291cmNlQ29kZSApIHsKCQkJCQlyZXR1cm4gJC5nbG9iYWxFdmFsKCBzb3VyY2VDb2RlICk7CgkJCQl9LAoJCQkJbG9jYWxFdmFsOiBmdW5jdGlvbiggYXNzZXRJZCwgc291cmNlQ29kZSApIHsKCQkJCQlyZXR1cm4gZXZhbCggc291cmNlQ29kZSApOwoJCQkJfQoJCQl9LAoKCQkJY3Jvc3NTaXRlTG9hZDogewoJCQkJLy9jYW4gbm90IHVzZSAkLmdldFNjcmlwdCBkaXJlY3RseSwgYXMgbG9hZGVyLnJlc29sdmUKCQkJCWdldFNjcmlwdDogZnVuY3Rpb24oIGFzc2V0SWQgKSB7CgkJCQkJdmFyIGRlZmVyID0gJC5EZWZlcnJlZCgpLAoJCQkJCQlwcm9taXNlID0gZGVmZXIucHJvbWlzZSgpOwoKCQkJCQlwcm9taXNlLmRlZmVyID0gZGVmZXI7CgoJCQkJCSQuZ2V0U2NyaXB0KCBfbG9hZGVyLnVybCggYXNzZXRJZCApICkudGhlbigKCQkJCQkJZnVuY3Rpb24oKSB7CgkJCQkJCQlzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJCQkJCQlpZiAoIWRlZmVyLmRvbnRSZXNvbHZlKSB7CgkJCQkJCQkJCWRlZmVyLnJlc29sdmUoKTsKCQkJCQkJCQkJZGVsZXRlIHByb21pc2UuZGVmZXI7CgkJCQkJCQkJfQoJCQkJCQkJfSwgNSApOwoJCQkJCQl9LAoJCQkJCQlmdW5jdGlvbigpIHsKCQkJCQkJCWRlZmVyLnJlamVjdCgpOwoJCQkJCQkJZGVsZXRlIHByb21pc2UuZGVmZXI7CgkJCQkJCX0gKTsKCgkJCQkJcmV0dXJuIHByb21pc2U7CgkJCQl9CgoKCQkJfSwKCgkJCWJ1aWxkVW5sb2FkOiB7CgkJCQlwYXJzZVVubG9hZFRhZzogZnVuY3Rpb24oIHNvdXJjZUNvZGUgKSB7CgkJCQkJdmFyIHVubG9hZFN0YXRlbWVudHMgPSBydW5sb2FkU3RhdGVtZW50LmV4ZWMoIHNvdXJjZUNvZGUgKTsKCQkJCQlyZXR1cm4gdW5sb2FkU3RhdGVtZW50cyAmJgoJCQkJCSAgICAgICB1bmxvYWRTdGF0ZW1lbnRzWzFdICYmCgkJCQkJICAgICAgIG5ldyBGdW5jdGlvbiggdW5sb2FkU3RhdGVtZW50c1sxXSApOwoJCQkJfQoJCQl9LAoKCQkJYnVpbGREZXBlbmRlbmNpZXM6IHsKCQkJCXBhcnNlRGVwZW5kVGFnOiBmdW5jdGlvbiggYXNzZXRJZCwgc291cmNlQ29kZSApIHsKCQkJCQl2YXIgZGVwZW5kZW5jaWVzID0gckRlcGVuZEhlYWRlci5leGVjKCBzb3VyY2VDb2RlICk7CgkJCQkJcmV0dXJuIChkZXBlbmRlbmNpZXMgJiYgZGVwZW5kZW5jaWVzWzFdICkgfHwgbnVsbDsKCQkJCX0KCQkJfQoJCX0sCgoJCS8vZmluZCB0aGUgbmFtZSBvZiB0aGUgbG9hZGVyIGJhc2VkIG9uIGFzc2V0SWQKCQkvL3RoZSBmaXJzdCBsb2FkZXIgaXMgdXNlIHRoZSBleHRlbnNpb24gYXMgdGhlIGxvYWRlciBuYW1lCgkJLy9ob3dldmVyIHlvdSBjYW4gYWRkIHlvdXIgb3duIGxvYWRlcgoJCWZpbmRlcnM6IGxvYWRlckZpbmRlcnMgPSBbCgkJCS8vZmluZCBsb2FkZXIgYnkgYnkgZmlsZSBleHRlbnNpb25zIGRpcmVjdGx5CgkJCWZ1bmN0aW9uKCBhc3NldElkICkgewoJCQkJcmV0dXJuIGZpbGVFeHRlbnNpb24oIGFzc2V0SWQgKTsKCQkJfSwKCQkJLy9maW5kIGxvYWRlciBieSBieSBmaWxlIGV4dGVuc2lvbnMgdXNpbmcgbWFwcGVyCgkJCWZ1bmN0aW9uKCBhc3NldElkICkgewoJCQkJdmFyIGV4dGVuc2lvbiA9IGZpbGVFeHRlbnNpb24oIGFzc2V0SWQgKTsKCQkJCXZhciBtYXBwZWRUeXBlID0gZmlsZUV4dFRvTG9hZGVyTWFwcGVyW2V4dGVuc2lvbl07CgkJCQlpZiAobWFwcGVkVHlwZSkgewoJCQkJCXJldHVybiBtYXBwZWRUeXBlOwoJCQkJfQoJCQl9CgkJXSwKCgkJLy9pZiB5b3Ugd2FudCB0byBsb2FkIGEgZmlsZSAiKi5qcGciLCB3aGljaCBzaG91bGQgYmUgbG9hZGVkCgkJLy93aXRoICIqLmltZyIgbG9hZGVyIHlvdSBzaG91bGQgc3BlY2lmeSBsb2FkZXIubG9hZGVyLm1hcEZpbGVzKCJpbWciLCAianBnIik7CgkJbWFwRmlsZUV4dFRvTG9hZGVyOiBmdW5jdGlvbiggZmlsZUV4dGVuc2lvbnMsIGxvYWRlck5hbWUgKSB7CgkJCWZpbGVFeHRlbnNpb25zID0gc3BsaXRCeUNvbW1hKCBmaWxlRXh0ZW5zaW9ucyApOwoJCQlmb3IgKHZhciBpID0gMDsgaSA8IGZpbGVFeHRlbnNpb25zLmxlbmd0aDsgaSsrKSB7CgkJCQlmaWxlRXh0VG9Mb2FkZXJNYXBwZXJbZmlsZUV4dGVuc2lvbnNbaV1dID0gbG9hZGVyTmFtZTsKCQkJfQoJCX0sCgoJCS8vaWYgYXNzZXRJZCBpcyB4eXouanMKCQkvL3RoZW4gZmlsZUV4dCBpcyAianMiCgkJZmlsZUV4dDogZmlsZUV4dGVuc2lvbiA9IGZ1bmN0aW9uKCBhc3NldElkICkgewoJCQlyZXR1cm4gckZpbGVFeHQuZXhlYyggYXNzZXRJZCApWzFdOwoJCX0sCgoJCS8vaWYgYXNzZXRJZCBpcyAiYS5iLmMiLCB0aGVuIGZpbGUgbmFtZSBpcyAiYS5iIgoJCWZpbGVOYW1lOiBmaWxlTmFtZSA9IGZ1bmN0aW9uKCBhc3NldElkICkgewoJCQlyZXR1cm4gckZpbGVOYW1lLmV4ZWMoIGFzc2V0SWQgKVsxXTsKCQl9LAoKCQkvL2RlZmluZSBhIG1vZHVsZSB3aXRoIGFuIGFzc2V0IGlkCgkJLy9kZXBlbmRlbmNpZXMgaXMgYW4gYXNzZXQgZXhwcmVzc2lvbiwgaXQgaXMgb3B0aW9uYWwKCQkvL2RlZmluZSB0aGUgbW9kdWxlIGluIHRoZSBsb2FkIG1ldGhvZAoJCWRlZmluZTogZnVuY3Rpb24oIGFzc2V0SWQsIGRlcGVuZGVuY2llcywgZGVmaW5lTW9kdWxlLCB1bmxvYWQgKSB7CgoJCQlpZiAoJC5pc0Z1bmN0aW9uKCBkZXBlbmRlbmNpZXMgKSkgewoJCQkJdW5sb2FkID0gZGVmaW5lTW9kdWxlOwoJCQkJZGVmaW5lTW9kdWxlID0gZGVwZW5kZW5jaWVzOwoJCQkJZGVwZW5kZW5jaWVzID0gbnVsbDsKCQkJfQoKCQkJdmFyIGRlZmVyLCBwcm9taXNlID0gYWNjZXNzUHJvbWlzZSggYXNzZXRJZCApOwoKCQkJaWYgKCFwcm9taXNlKSB7CgkJCQkvL3RoaXMgaXMgdGhlIGNhc2Ugd2hlbiBsb2FkZXIuZGVmaW5lIGlzIGNhbGwgaW4gYSBzdGF0aWMgbG9hZGVkIGpzCgkJCQlkZWZlciA9ICQuRGVmZXJyZWQoKTsKCQkJCXByb21pc2UgPSBkZWZlci5wcm9taXNlKCk7CgkJCQlwcm9taXNlLmRlZmVyID0gZGVmZXI7CgkJCQlhY2Nlc3NQcm9taXNlKCBhc3NldElkLCBwcm9taXNlICk7CgkJCX0gZWxzZSB7CgkJCQlkZWZlciA9IHByb21pc2UuZGVmZXI7CgkJCX0KCgkJCS8vdXNlIGRvbnRSZW9zbHZlIGZsYWcgdGVsbGluZyB0aGUgY29uc3VtZXIgZG9uJ3QgcmVzb2x2ZSBpdAoJCQkvL2FzIGl0IHdpbGwgYmUgdGFrZW4gY2FyZSBpbnNpZGUgaW1wb3J0Q29kZSwKCQkJcHJvbWlzZS5kZWZlci5kb250UmVzb2x2ZSA9IHRydWU7CgoJCQl2YXIgcnVuTW9kdWxlQ29kZSA9IGZ1bmN0aW9uKCByZXN1bHQgKSB7CgkJCQlkZWxldGUgcHJvbWlzZS5kZWZlcjsKCQkJCXByb21pc2UudW5sb2FkID0gdW5sb2FkOwoJCQkJZGVmZXIgJiYgZGVmZXIucmVzb2x2ZSggZGVmaW5lTW9kdWxlKCByZXN1bHQgKSApOwoJCQl9OwoKCQkJaWYgKGRlcGVuZGVuY2llcykgewoJCQkJZGVwZW5kKCBhc3NldElkLCBkZXBlbmRlbmNpZXMgKTsKCQkJCS8vbG9hZCB0aGUgZGVwZW5kZW5jaWVzIGZpcnN0CgkJCQlfbG9hZGVyLmxvYWQoIGRlcGVuZGVuY2llcyApLmRvbmUoIHJ1bk1vZHVsZUNvZGUgKTsKCgkJCX0gZWxzZSB7CgoJCQkJcnVuTW9kdWxlQ29kZSgpOwoJCQl9CgoJCQlyZXR1cm4gcHJvbWlzZTsKCQl9LAoKCQlkb25lOiBmdW5jdGlvbiggZm4sIHJlbW92ZSApIHsKCQkJaWYgKHJlbW92ZSkgewoJCQkJbG9hZENhbGxiYWNrcy5yZW1vdmUoIGZuICk7CgkJCX0gZWxzZSB7CgkJCQlsb2FkQ2FsbGJhY2tzLnB1c2goIGZuICk7CgkJCX0KCQl9LAoKCQlmYWlsOiBmdW5jdGlvbiggZm4sIHJlbW92ZSApIHsKCQkJaWYgKHJlbW92ZSkgewoJCQkJZmFpbENhbGxiYWNrcy5yZW1vdmUoIGZuICk7CgkJCX0gZWxzZSB7CgkJCQlmYWlsQ2FsbGJhY2tzLnB1c2goIGZuICk7CgkJCX0KCQl9LAoKCQlkZWZhdWx0TG9hZGVyOiAianMiCgoJfSApOwoKCWZ1bmN0aW9uIHJlbG9hZCggYXNzZXRJZCwgY2hhbmdlICkgewoKCQl2YXIgb2xkUHJvbWlzZUNhY2hlID0gJC5leHRlbmQoIHRydWUsIHt9LCBwcm9taXNlU3RvcmUgKTsKCQlfbG9hZGVyLnVubG9hZCggYXNzZXRJZCwgdHJ1ZSApOwoJCWNoYW5nZSAmJiBjaGFuZ2UoKTsKCQlyZXR1cm4gX2xvYWRlci5sb2FkKCBhc3NldElkICkuZG9uZSggZnVuY3Rpb24oKSB7CgkJCWZvciAodmFyIGtleSBpbiBvbGRQcm9taXNlQ2FjaGUpIHsKCQkJCWlmIChwcm9taXNlU3RvcmVba2V5XSAmJiBvbGRQcm9taXNlQ2FjaGVba2V5XSkgewoJCQkJCXByb21pc2VTdG9yZVtrZXldLnJlZkNvdW50ID0gb2xkUHJvbWlzZUNhY2hlW2tleV0ucmVmQ291bnQ7CgkJCQkJcHJvbWlzZVN0b3JlW2tleV0udXJsID0gb2xkUHJvbWlzZUNhY2hlW2tleV0udXJsOwoJCQkJCXByb21pc2VTdG9yZVtrZXldLmFzc2V0SWQgPSBvbGRQcm9taXNlQ2FjaGVba2V5XS5hc3NldElkOwoJCQkJfQoJCQl9CgkJfSApOwoJfQoKCWZ1bmN0aW9uIGdldE5ld1N0YXRpY0RlcGVuZGVuY2llcyggYXNzZXRJZCwgZGVwZW5kZW5jaWVzVG9TZXQgKSB7CgkJdmFyIHJ0biwKCQkJbG9hZGVyID0gZmluZExvYWRlciggYXNzZXRJZCApLAoJCQlkeW5hbWljRGVwZW5kZW5jaWVzID0gbG9hZGVyICYmIGxvYWRlci5kZXBlbmQgJiYgbG9hZGVyLmRlcGVuZCggYXNzZXRJZCApOwoKCQlpZiAoZHluYW1pY0RlcGVuZGVuY2llcykgewoJCQlydG4gPSBbXTsKCQkJZHluYW1pY0RlcGVuZGVuY2llcyA9IHNwbGl0QnlDb21tYSggZHluYW1pY0RlcGVuZGVuY2llcyApOwoJCQlkZXBlbmRlbmNpZXNUb1NldCA9IHNwbGl0QnlDb21tYSggZGVwZW5kZW5jaWVzVG9TZXQgKTsKCQkJZm9yICh2YXIgaSA9IDA7IGkgPCBkZXBlbmRlbmNpZXNUb1NldC5sZW5ndGg7IGkrKykgewoJCQkJaWYgKCFkeW5hbWljRGVwZW5kZW5jaWVzLmNvbnRhaW5zKCBkZXBlbmRlbmNpZXNUb1NldFtpXSApKSB7CgkJCQkJcnRuLnB1c2goIGRlcGVuZGVuY2llc1RvU2V0W2ldICk7CgkJCQl9CgkJCX0KCQkJcmV0dXJuIHJ0bi5sZW5ndGggPyBydG4uam9pbigpIDogbnVsbDsKCQl9IGVsc2UgewoJCQlyZXR1cm4gZGVwZW5kZW5jaWVzVG9TZXQ7CgkJfQoJfQoKCWZ1bmN0aW9uIGlzRGVwZW5kZW5jaWVzRGlmZmVyZW50KCBkZXBlbmRlbmNpZXMxLCBkZXBlbmRlbmNpZXMyICkgewoJCWlmICgoZGVwZW5kZW5jaWVzMSAmJiAhZGVwZW5kZW5jaWVzMikgfHwKCQkgICAgZGVwZW5kZW5jaWVzMiAmJiAhZGVwZW5kZW5jaWVzMSkgewoJCQlyZXR1cm4gdHJ1ZTsKCQl9IGVsc2UgaWYgKCFkZXBlbmRlbmNpZXMxICYmICFkZXBlbmRlbmNpZXMyKSB7CgkJCXJldHVybiBmYWxzZTsKCQl9CgoJCWRlcGVuZGVuY2llczEgPSBzcGxpdEJ5Q29tbWEoIGRlcGVuZGVuY2llczEgKS5zb3J0KCk7CgkJZGVwZW5kZW5jaWVzMiA9IHNwbGl0QnlDb21tYSggZGVwZW5kZW5jaWVzMiApLnNvcnQoKTsKCQlpZiAoZGVwZW5kZW5jaWVzMS5sZW5ndGggIT0gZGVwZW5kZW5jaWVzMi5sZW5ndGgpIHsKCQkJcmV0dXJuIHRydWU7CgkJfQoKCQlmb3IgKHZhciBpID0gMDsgaSA8IGRlcGVuZGVuY2llczEubGVuZ3RoOyBpKyspIHsKCQkJaWYgKGRlcGVuZGVuY2llczFbaV0gIT0gZGVwZW5kZW5jaWVzMltpXSkgewoJCQkJcmV0dXJuIHRydWU7CgkJCX0KCQl9CgoJCXJldHVybiBmYWxzZTsKCX0KCglmdW5jdGlvbiBmaW5kTG9hZGVyKCBhc3NldElkICkgewoJCXZhciBsb2FkZXJOYW1lLCBpOwoJCWZvciAoaSA9IGxvYWRlckZpbmRlcnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKCQkJbG9hZGVyTmFtZSA9IGxvYWRlckZpbmRlcnNbaV0oIGFzc2V0SWQgKTsKCQkJaWYgKGxvYWRlck5hbWUpIHsKCQkJCWJyZWFrOwoJCQl9CgkJfQoJCWxvYWRlck5hbWUgPSBsb2FkZXJOYW1lIHx8IF9sb2FkZXIuZGVmYXVsdExvYWRlcjsKCQlyZXR1cm4gbG9hZGVyU3RvcmVbbG9hZGVyTmFtZV07Cgl9CgoJZnVuY3Rpb24gYXR0YWNoRmlsdGVyKCBmaWx0ZXJzLCBmaWx0ZXJOYW1lICkgewoJCWlmIChpc1N0cmluZyggZmlsdGVyc1tmaWx0ZXJOYW1lXSApKSB7CgkJCWZpbHRlcnNbZmlsdGVyTmFtZV0gPSBjb21tb25Mb2FkRmlsdGVyc1tmaWx0ZXJOYW1lXVtmaWx0ZXJzW2ZpbHRlck5hbWVdXTsKCQl9Cgl9CgoJLy8jZGVidWcKCV9sb2FkZXIuZGVidWcgPSB7CgkJZnVsbFVybDogZnVsbFVybCwKCQl1cmxTdG9yZTogdXJsU3RvcmUsCgkJcHJvbWlzZVN0b3JlOiBwcm9taXNlU3RvcmUsCgkJbG9hZGVyU3RvcmU6IGxvYWRlclN0b3JlLAoJCWZpbmRMb2FkZXI6IGZpbmRMb2FkZXIsCgkJYWRkSGFzaDogYWRkSGFzaCwKCQlyZW1vdmVIYXNoOiByZW1vdmVIYXNoLAoJCWxvZzogZnVuY3Rpb24oIG1zZyApIHsKCQkJdmFyIGNvbnNvbGUgPSB3aW5kb3cuY29uc29sZTsKCQkJY29uc29sZSAmJiBjb25zb2xlLmxvZyAmJiBjb25zb2xlLmxvZyggbXNnICk7CgkJfSwKCgkJLy90aGlzIGlzIGZvciBkZWJ1Z2dpbmcgcHVycG9zZSBvbmx5CgkJbW9kdWxlQ291bnRlcnM6IGFjY2Vzc1Byb21pc2UsCgoJCWdldExvYWRlckJ5TmFtZTogZnVuY3Rpb24oIGxvYWRlck5hbWUgKSB7CgkJCXJldHVybiBsb2FkZXJOYW1lID8gbG9hZGVyU3RvcmVbbG9hZGVyTmFtZV0gOiBsb2FkZXJTdG9yZTsKCQl9Cgl9OwoJLy8jZW5kX2RlYnVnCgoJdmFyCgoJLy9pZiB5byBoYXZlIGNvZGUgbGlrZSB0aGUgZm9sbG93aW5nIGluIGphdmFzY3JpcHQsCgkvL3RoZSBwYXJ0IGRlbGV0ZSB3aW5kb3cuZGVwZW5kMiB3aWxsIGJlIGV4dHJhY3RlZAoJLy8gPEB1bmxvYWQ+CgkvL2RlbGV0ZSB3aW5kb3cuZGVwZW5kMjsKCS8vPC9AdW5sb2FkPgoKCQlydW5sb2FkU3RhdGVtZW50ID0gLzxAdW5sb2FkPihbXHdcV10rPyk8XC9AdW5sb2FkPi9pLAoKCS8vbWF0Y2ggc3RyaW5nICJyZWYyLCByZWYxIiBpbgoJLy8gPEBkZXBlbmQ+CgkvL3JlZjIsIHJlZjEKCS8vPEBkZXBlbmQ+CgkJckRlcGVuZEhlYWRlciA9IC88QGRlcGVuZD4oW1x3XFddKz8pPFwvQGRlcGVuZD4vaTsKCgkvL2NyZWF0ZSBhIGxvYWQgZnVuY3Rpb24KCWZ1bmN0aW9uIHJlc29sdmVEZXBlbmRlbmNpZXMoIGFjdGlvbkFmdGVyRGVwZW5kZW5jaWVzUmVzb2x2ZWQgKSB7CgkJcmV0dXJuIGZ1bmN0aW9uKCBhc3NldElkICkgewoJCQl2YXIgZGVmZXIgPSAkLkRlZmVycmVkKCksCgkJCQlkZXBlbmRlbnRSZXNvdXJjZVN0cmluZyA9IF9sb2FkZXIuZGVwZW5kKCBhc3NldElkICk7CgoJCQlpZiAoZGVwZW5kZW50UmVzb3VyY2VTdHJpbmcpIHsKCQkJCV9sb2FkZXIubG9hZCggZGVwZW5kZW50UmVzb3VyY2VTdHJpbmcgKS5kb25lKCBmdW5jdGlvbigpIHsKCQkJCQlkZWZlci5yZXNvbHZlKCBhc3NldElkLCBhY3Rpb25BZnRlckRlcGVuZGVuY2llc1Jlc29sdmVkKCBhc3NldElkICkgKTsKCQkJCX0gKTsKCQkJfSBlbHNlIHsKCQkJCWRlZmVyLnJlc29sdmUoIGFzc2V0SWQsIGFjdGlvbkFmdGVyRGVwZW5kZW5jaWVzUmVzb2x2ZWQoIGFzc2V0SWQgKSApOwoJCQl9CgkJCXJldHVybiBkZWZlci5wcm9taXNlKCk7CgkJfTsKCX0KCgkvL2Egc3BlY2lhbCBtb2R1bGUgd2hpY2ggaXMgYSBwYWNrYWdlIG9mIG1vZHVsZXMsIGxpa2UgYSBjb250YWluZXIKCV9sb2FkZXIoICJwYWNrIiwgewoJCWxvYWQ6IHJlc29sdmVEZXBlbmRlbmNpZXMoICQubm9vcCApLAoJCXVybDogImFzc2V0SWQiCgl9ICk7CgoJLy9qcyBhZGFwdGVyIHRyeSB0byBwYXJzZSB0aGUgY29udGVudCBvZiBqcyBmaWxlCglfbG9hZGVyKCAianMiLCB7CgkJbG9hZDogewoJCQlzdGF0aWNMb2FkZWQ6ICJoYXNTY3JpcHRUYWciCgkJCS8vdGhlIGZvbGxvd2luZyBhcmUgY29tbWVudGVkIG91dCwgYmVjYXVzZSBpdCBpcyBkZWZhdWx0IHZhbHVlIGRlZmluZWQgaW4gY29udmVydExvYWRGaWx0ZXJzVG9Mb2FkTWV0aG9kCgkJCS8vY3Jvc3NTaXRlTG9hZDogImdldFNjcmlwdCIsCgkJCS8vZ2V0U291cmNlOiAiZ2V0VGV4dEJ5QWpheCIsCgkJCS8vY29tcGlsZTogImdsb2JhbEV2YWwiLAoJCQkvL2J1aWxkRGVwZW5kZW5jaWVzOiAicGFyc2VEZXBlbmRUYWciLAoJCQkvL2J1aWxkVW5sb2FkOiAicGFyc2VVbmxvYWRUYWciCgkJfSwKCQkvL3RoaXMgaXMgbmVjZXNzYXJ5IGJlY2F1c2UgaWYgeW91IGhhdmUgYSBzdWIgbG9hZGVyIGluaGVyaXRzIGZyb20KCQkvL2Zyb20gdGhpcywgYW5kIHlvdSBkb24ndCB3YW50IHRvIGluaGVyaXRlZCBzdWIgbG9hZGVyIHRvIHNwZWNpZnkgdGhpcyBhZ2FpbgoJCWZpbGVFeHQ6ICJqcyIKCX0gKTsKCglfbG9hZGVyKCAianNsIiwgImpzIiwgewoJCWxvYWQ6IHsKCQkJY29tcGlsZTogImxvY2FsRXZhbCIKCQl9Cgl9ICk7CgkvL2xvYWRlciBpcyBqYXZhc2NyaXB0IGZpbGUsIGl0IGRlZmluZXMgYSBsb2FkZXIKCV9sb2FkZXIoICJsb2FkZXIiLCAianMiLCB7CgkJdXJsOiAiZm9sZGVyIgoJfSApOwoKCS8vY3NzIGFkYXB0ZXIgdHJpZXMgdG8gcGFyc2UgdGhlIGNvbnRlbnQgb2YgY3NzIGZpbGUKCV9sb2FkZXIoICJjc3MiLCB7CgkJbG9hZDogewoJCQlzdGF0aWNMb2FkZWQ6IGZ1bmN0aW9uKCBhc3NldElkICkgewoJCQkJcmV0dXJuICEhKCQoICJsaW5rIiApLmZpbHRlcigKCQkJCQlmdW5jdGlvbigpIHsKCQkJCQkJcmV0dXJuIHJlbW92ZUhhc2goIHRoaXMuaHJlZiApID09PSByZW1vdmVIYXNoKCBfbG9hZGVyLnVybCggYXNzZXRJZCApICkgJiYgISQoIHRoaXMgKS5hdHRyKCAnbG9hZGVkQnlsb2FkZXInICk7CgkJCQkJfSApLmxlbmd0aCk7CgkJCX0sCgkJCWNyb3NzU2l0ZUxvYWQ6IGZ1bmN0aW9uKCBhc3NldElkICkgewoJCQkJdmFyIGRlZmVyID0gJC5EZWZlcnJlZCgpOwoKCQkJCSQoICI8bGluayBocmVmPSciICsgX2xvYWRlci51cmwoIGFzc2V0SWQgKSArICInICIgKyAicmVsPSdzdHlsZXNoZWV0JyB0eXBlPSd0ZXh0L2NzcycgbG9hZGVkQnlsb2FkZXI9JzEnIC8+IiApCgkJCQkJLmxvYWQoIGZ1bmN0aW9uKCkgewoJCQkJCQlkZWZlci5yZXNvbHZlKCBhc3NldElkICk7CgkJCQkJfSApCgkJCQkJLmFwcGVuZFRvKCAiaGVhZCIgKTsKCgkJCQlyZXR1cm4gZGVmZXIucHJvbWlzZSgpOwoJCQl9LAoJCQkvL2V4cGxpY2l0bHkgc3BlY2lmeSB0aGF0IGxvYWRlciBkb2VzIG5vdCBuZWVkIGEgY29tcGlsZSBmaWx0ZXIKCQkJY29tcGlsZTogbnVsbAoJCX0sCgoJCXVubG9hZDogZnVuY3Rpb24oIGFzc2V0SWQgKSB7CgkJCXZhciB1cmwgPSBmdWxsVXJsKCBfbG9hZGVyLnVybCggYXNzZXRJZCApICk7CgkJCSQoICJsaW5rIiApLmZpbHRlcigKCQkJCWZ1bmN0aW9uKCkgewoJCQkJCXJldHVybiB0aGlzLmhyZWYgPT09IHVybCAmJiAkKCB0aGlzICkuYXR0ciggJ2xvYWRlZEJ5bG9hZGVyJyApOwoJCQkJfSApLnJlbW92ZSgpOwoJCX0sCgkJZmlsZUV4dDogImNzcyIKCX0gKTsKCglfbG9hZGVyKCAiaW1hZ2UiLCB7CgkJbG9hZDogImNhY2hlSW1hZ2UiLAoJCW5vUmVmQ291bnQ6IHRydWUKCX0gKTsKCgkvL21ha2UgaW1nIGxpbmtlciBjYW4gaGFuZGxlIG1vZHVsZSB3aXRoIHRoZXNlIGZpbGUgZXh0ZW5zaW9uCglfbG9hZGVyLm1hcEZpbGVFeHRUb0xvYWRlciggImpwZyxwbmcsYm1wLGdpZiIsICJpbWFnZSIgKTsKCS8vZnJlZCB0ZXN0CgovLwovLzxAZGVwZW5kcz5zdWJzY3JpcHRpb24uanMsIG1vZGVsLmpzLCBkZWNsYXJhdGl2ZS5qczwvQGRlcGVuZHM+CgoKCXZhciB0ZW1wbGF0ZSwKCQlyQmVnaW5XaXRoQXBrID0gL15hcGtcLihbXi5dKykoXC4/KSguKikkLywKCQlyQmVnaW5XaXRoU3RhciA9IC9eXCovLAoJCXRlbXBsYXRlRW5naW5lQWRhcHRlcnMgPSB7fSwKCQl0bXBsID0gewoJCQlpbml0aWFsaXplOiAiKnRlbXBsYXRlT3B0aW9ucyIsCgkJCWdldDogImdldCIsIC8vZXh0ZW5zaWJsZQoJCQljb252ZXJ0OiAiKnRlbXBsYXRlIiwKCQkJc2V0OiAiaHRtbCIsIC8vZXh0ZW5zaWJsZQoJCQlmaW5hbGl6ZTogIipwYXJzZVN1YnMiCgkJfTsKCglmdW5jdGlvbiBuZXdUZW1wbGF0ZUhhbmRsZXIoIGdldHRlciwgc2V0dGVyLCBmaW5hbGl6ZXIgKSB7CgkJcmV0dXJuIGV4dGVuZCgge30sIHRtcGwsCgkJCWlzT2JqZWN0KCBnZXR0ZXIgKSA/IGdldHRlciA6IHsKCQkJCWdldDogZ2V0dGVyLAoJCQkJc2V0OiBzZXR0ZXIsCgkJCQlmaW5hbGl6ZTogZmluYWxpemVyCgkJCX0gKTsKCX0KCgkvL29wdGlvbnMgY2FuIGJlIDogdGVtcGxhdGVJZCx3cmFwSXRlbSxlbmdpbmVOYW1lCgkvLwoJLy9vciBpdCBjYW4gYmUKCS8vIHsKCS8vICB0ZW1wbGF0ZUlkOiAieHh4IiwKCS8vICB3cmFwSXRlbTogdHJ1ZSwKCS8vICBlbmdpbmVOYW1lOiAieHh4IgoJLy99CglobS5hY3Rpdml0eS5pbml0aWFsaXplLnRlbXBsYXRlT3B0aW9ucyA9IGZ1bmN0aW9uKCBwdWJsaXNoZXIsIHN1YnNjcmliZXIsIGhhbmRsZXIsIG9wdGlvbnMgKSB7CgkJaWYgKGlzU3RyaW5nKCBvcHRpb25zICkpIHsKCgkJCW9wdGlvbnMgPSBvcHRpb25zLnNwbGl0KCAiLCIgKTsKCQkJaGFuZGxlci50ZW1wbGF0ZUlkID0gJC50cmltKCBvcHRpb25zWzBdICk7CgkJCWhhbmRsZXIud3JhcERhdGFJbkFycmF5ID0gJC50cmltKCBvcHRpb25zWzFdICkgPT0gInRydWUiOwoJCQloYW5kbGVyLmVuZ2luZU5hbWUgPSBvcHRpb25zWzJdOwoKCQl9IGVsc2UgaWYgKGlzT2JqZWN0KCBvcHRpb25zICkgJiYgb3B0aW9ucy50ZW1wbGF0ZUlkKSB7CgoJCQlleHRlbmQoIGhhbmRsZXIsIG9wdGlvbnMgKTsKCgkJfSBlbHNlIHsKCgkJCWlmICghKGhhbmRsZXIudGVtcGxhdGVJZCA9IHN1YnNjcmliZXIuaG1EYXRhKCAiZW1iZWRkZWRUZW1wbGF0ZSIgKSkpIHsKCgkJCQl2YXIgdGVtcGxhdGVTb3VyY2UgPSAkLnRyaW0oIHN1YnNjcmliZXIuaHRtbCgpICk7CgkJCQlpZiAodGVtcGxhdGVTb3VyY2UpIHsKCQkJCQl0ZW1wbGF0ZVNvdXJjZSA9IHRlbXBsYXRlU291cmNlLnJlcGxhY2UoIHJVbmVzY2FwZVRva2VucywgdW5lc2NhcGVUb2tlbnMgKTsKCQkJCQloYW5kbGVyLnRlbXBsYXRlSWQgPSAiX18iICsgJC51dWlkKys7CgkJCQkJdGVtcGxhdGUuY29tcGlsZSggaGFuZGxlci50ZW1wbGF0ZUlkLCB0ZW1wbGF0ZVNvdXJjZSApOwoJCQkJCXN1YnNjcmliZXIuaG1EYXRhKCAiZW1iZWRkZWRUZW1wbGF0ZSIsIGhhbmRsZXIudGVtcGxhdGVJZCApOwoJCQkJCXN1YnNjcmliZXIuZW1wdHkoKTsKCQkJCX0gZWxzZSB7CgkJCQkJdGhyb3cgIm1pc3NpbmcgdGVtcGxhdGUiOwoJCQkJfQoJCQl9CgkJfQoJfTsKCgl2YXIgclVuZXNjYXBlVG9rZW5zID0gLyZsdDt8Jmd0Oy9nOwoJdmFyIHVuZXNjYXBlTWFwID0gewoJCSImbHQ7IjogIjwiLAoJCSImZ3Q7IjogIj4iCgl9OwoKCXZhciB1bmVzY2FwZVRva2VucyA9IGZ1bmN0aW9uKCB0b2tlbiApIHsKCQlyZXR1cm4gdW5lc2NhcGVNYXBbdG9rZW5dIHx8ICIiOwoJfTsKCglmdW5jdGlvbiBSZW5kZXJDb250ZXh0KCBlICkgewoJCXRoaXMubW9kZWxQYXRoID0gZS5wdWJsaXNoZXIucGF0aDsKCQl0aGlzLmUgPSBlOwoJfQoKCS8vc2hvcnRjdXQgdG8gdGhpcy5lLnB1Ymxpc2hlci5nZXQoeHh4KTsKCVJlbmRlckNvbnRleHQucHJvdG90eXBlLmdldCA9IGZ1bmN0aW9uKCkgewoJCXZhciBwdWJsaXNoZXIgPSB0aGlzLmUucHVibGlzaGVyOwoJCXJldHVybiBwdWJsaXNoZXIuZ2V0LmFwcGx5KCBwdWJsaXNoZXIsIGFyZ3VtZW50cyApOwoJfTsKCgkvL3RoaXMgY29udmVydGVyIGlzIHVzZWQgaW4gaGFuZGxlcnMgd2hpY2ggY2FuIHdhbnQgdG8gY29udmVydCBkYXRhCgkvLyB0byBtYXJrdXAsIHRoZXNlIGhhbmRsZXIgaW5jbHVkZXMgZm9yZWFjaCwgYW5kIG5ld1RlbXBsYXRlSGFuZGxlcgoJLy93aGljaCBpcyB0aGUgY29yZSBvZiBhbGwgdGVtcGxhdGVIYW5kbGVyCglobS5hY3Rpdml0eS5jb252ZXJ0LnRlbXBsYXRlID0gZnVuY3Rpb24oIGRhdGEsIGUgKSB7CgoJCS8vaWYgZGF0YVNvdXJjZSBpcyBhbiBhcnJheSwgaXQgaGFzIGl0ZW0ocykKCQkvL29yIGRhdGFTb3VyY2UgaXMgbm9uLWFycmF5CgkJaWYgKGRhdGEgJiYKCQkgICAgKAoJCQkgICAgKGlzQXJyYXkoIGRhdGEgKSAmJiBkYXRhLmxlbmd0aCkgfHwgIWlzQXJyYXkoIGRhdGEgKQoJCQkgICAgKQoJCQkpIHsKCgkJCS8vaWYgd3JhcERhdGFJbkFycmF5IGlzIHRydWUsIHdyYXAgZGF0YSB3aXRoIFtdLCBzbyB0aGF0IGl0IGlzIGFuIGl0ZW0gb2YgYW4gYXJyYXksIGV4cGxpY2l0bHkKCQkJLy9zb21lIHRlbXBsYXRlIGVuZ2luZSBjYW4gYXV0b21hdGljYWxseSB3cmFwIHlvdXIgZGF0YSBpZiBpdCBpcyBub3QgYW4gYXJyYXkuCgkJCS8vaWYgeW91IGRhdGEgaXMgYWxyZWFkeSBpbiBhcnJheSwgaXQgdHJlYXQgaXQgYXMgYW4gYXJyYXkgb2YgaXRlbXMuCgkJCS8vaG93ZXZlciwgaWYgeW91IHdhbnQgdG8gd2FudCB0byB0cmVhdCB5b3VyIGFycmF5IGFzIGl0ZW0sIHlvdSBuZWVkIHRvIHdyYXAgaXQgYnkgeW91cgoJCQkvL3NlbGYsIHdyYXBEYXRhSW5BcnJheSBpcyBmb3IgdGhpcyBwdXJwb3NlCgoJCQl2YXIgdGVtcGxhdGVJZCwgdGVtcGxhdGVEYXRhLCB3b3JrZmxvdyA9IGUuaGFuZGxlcjsKCgkJCWlmICh3b3JrZmxvdy50ZW1wbGF0ZUlkKSB7CgkJCQl0ZW1wbGF0ZUlkID0gd29ya2Zsb3cudGVtcGxhdGVJZDsKCQkJCXRlbXBsYXRlRGF0YSA9IHdvcmtmbG93LndyYXBEYXRhSW5BcnJheSA/IFtkYXRhXSA6IGRhdGE7CgkJCX0gZWxzZSB7CgkJCQl0ZW1wbGF0ZUlkID0gZGF0YTsKCQkJCXRlbXBsYXRlRGF0YSA9IHt9OwoJCQl9CgoJCQlpZiAoIXRlbXBsYXRlSWQpIHsKCQkJCXJldHVybiAiIjsKCQkJfQoKCQkJLy9oYW5kbGVyLnRlbXBsYXRlSWQsIGhhbmRsZXIud3JhcERhdGFJbkFycmF5LCBoYW5kbGVyLmVuZ2luZU5hbWUgaXMKCQkJLy9idWlsdCBpbiBkdXJpbmcgaW5pdGlhbGl6YXRpb24gLCBzZWUgaW5pdGlhbGl6ZXJzLnRlbXBsYXRlT3B0aW9ucwoJCQl2YXIgY29udGVudCA9IHJlbmRlclRlbXBsYXRlKAoKCQkJCXRlbXBsYXRlSWQsCgoJCQkJdGVtcGxhdGVEYXRhLAoKCQkJCS8vdGhpcyBjb250ZXh0IGNhbiBiZSB1c2VkIHRvIGFjY2VzcyBtb2RlbCB3aXRoaW4gdGhlIHRlbXBsYXRlCgkJCQluZXcgUmVuZGVyQ29udGV4dCggZSApLAoKCQkJCXdvcmtmbG93LmVuZ2luZU5hbWUgKTsKCgkJCWlmIChpc1Byb21pc2UoIGNvbnRlbnQgKSkgewoJCQkJcmV0dXJuIGNvbnRlbnQ7CgkJCX0KCQkJaWYgKGlzU3RyaW5nKCBjb250ZW50ICkpIHsKCgkJCQljb250ZW50ID0gJC50cmltKCBjb250ZW50ICk7CgkJCX0KCgkJCS8vdG8gd29yayBhcm91bmQgYSBidWcgaW4galF1ZXJ5CgkJCS8vIGh0dHA6Ly9qc2ZpZGRsZS5uZXQvamdTcm4vMS8KCQkJcmV0dXJuICQoICQoICI8ZGl2IC8+IiApLmh0bWwoIGNvbnRlbnQgKVswXS5jaGlsZE5vZGVzICk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuICIiOwoJCX0KCX07CgoJLy93aGVuIHRoZSB0ZW1wbGF0ZSBpcyByZW5kZXIsIG5lZWQgdG8gcmVjdXJzaXZlbHkgaW1wb3J0IGRlY2xhcmF0aXZlIHN1YnNjcmlwdGlvbnMKCWhtLmFjdGl2aXR5LmZpbmFsaXplLnBhcnNlU3VicyA9IGZ1bmN0aW9uKCB2YWx1ZSwgZSApIHsKCQkkKCB2YWx1ZSApLnBhcnNlU3VicygpOwoKCX07CgoJLy9hZGQgcmV1c2FibGUgZXZlbnQgaGFuZGxlcgoJaG0ud29ya2Zsb3coIHsKCQl0bXBsOiB0bXBsLAoJCWluY2x1ZGU6IG5ld1RlbXBsYXRlSGFuZGxlciggImdldCIsICJyZXBsYWNlV2l0aCIgKQoJfSApOwoKCWJpbmRpbmdzKCB7CgoJCXRtcGw6ICIhaW5pdDoufCp0bXBsIiwKCgkJdG1wbE9uQ2hhbmdlOiAiIWluaXQgYWZ0ZXIqLjoufCp0bXBsIiwKCgkJdG1wbE9uQ2hpbGRDaGFuZ2U6ICIhaW5pdCBhZnRlciouIGFmdGVyKi4xOi58KnRtcGwiLAoKCQl0bXBsT25BbnlDaGFuZ2U6ICIhaW5pdCBhZnRlcio6LnwqdG1wbCIsCgoJCWluY2x1ZGU6ICIhaW5pdDoufCppbmNsdWRlIgoJfSApOwoKCS8vdGVtcGxhdGVPcHRpb25zIGlzIHRlbXBsYXRlSWQsd3JhcERhdGFJbkFycmF5LHRlbXBsYXRlRW5naW5lTmFtZQoJLy8kKCJkaXYiKS50bXBsKHRlbXBsYXRlSWQsIHBhdGgpCgkvLyQoImRpdiIpLnRtcGwodGVtcGxhdGVJZCwgcGF0aCwgZm4pCgkvL2lmIHRlbXBsYXRlV29ya2Zsb3dFeHRlbnNpb24gaXMgYSBmdW5jdGlvbiwgdGhlIGZ1bmN0aW9uIGlzIHRyZWF0ZWQKCS8vYXMgZmluYWxpemVyCgkkZm4udG1wbCA9IGZ1bmN0aW9uKCB0ZW1wbGF0ZU9wdGlvbnMsIG1vZGVsUGF0aCwgdGVtcGxhdGVXb3JrZmxvd0V4dGVuc2lvbiApIHsKCgkJbW9kZWxQYXRoID0gbW9kZWxQYXRoIHx8ICIiOwoKCQlpZiAoaXNGdW5jdGlvbiggdGVtcGxhdGVXb3JrZmxvd0V4dGVuc2lvbiApKSB7CgkJCXRlbXBsYXRlV29ya2Zsb3dFeHRlbnNpb24gPSB7CgkJCQlmaW5hbGl6ZTogdGVtcGxhdGVXb3JrZmxvd0V4dGVuc2lvbgoJCQl9OwoJCX0KCgkJcmV0dXJuIHRoaXMucmVuZGVyVmlldygKCgkJCW1vZGVsUGF0aCwKCgkJCXRlbXBsYXRlV29ya2Zsb3dFeHRlbnNpb24gPwoJCQkJZXh0ZW5kKCB7fSwgdG1wbCwgdGVtcGxhdGVXb3JrZmxvd0V4dGVuc2lvbiApIDoKCQkJCSIqdG1wbCIsCgoJCQl0ZW1wbGF0ZU9wdGlvbnMKCQkpOwoJfTsKCgkvL3RlbXBsYXRlT3B0aW9ucyBpcyB0ZW1wbGF0ZUlkLHdyYXBEYXRhSW5BcnJheSx0ZW1wbGF0ZUVuZ2luZU5hbWUKCS8vJCgiZGl2IikuaW5jbHVkZShwYXRoLCB0ZW1wbGF0ZUlkKQoJJGZuLmluY2x1ZGUgPSBmdW5jdGlvbiggdGVtcGxhdGVPcHRpb25zLCBtb2RlbFBhdGgsIHRlbXBsYXRlSGFuZGxlckV4dGVuc2lvbiApIHsKCgkJaWYgKGlzRnVuY3Rpb24oIHRlbXBsYXRlSGFuZGxlckV4dGVuc2lvbiApKSB7CgkJCXRlbXBsYXRlSGFuZGxlckV4dGVuc2lvbiA9IHsKCQkJCWZpbmFsaXplOiB0ZW1wbGF0ZUhhbmRsZXJFeHRlbnNpb24KCQkJfTsKCQl9CgoJCXJldHVybiB0aGlzLnJlbmRlclZpZXcoCgkJCW1vZGVsUGF0aCwKCQkJdGVtcGxhdGVIYW5kbGVyRXh0ZW5zaW9uID8gZXh0ZW5kKCB7fSwgaG0ud29ya2Zsb3coICJyZXBsYWNlIiApLCB0ZW1wbGF0ZUhhbmRsZXJFeHRlbnNpb24gKSA6ICIqcmVwbGFjZSIsCgkJCXRlbXBsYXRlT3B0aW9ucwoJCSk7Cgl9OwoKCWZ1bmN0aW9uIGdldFRlbXBsYXRlRW5naW5lKCBlbmdpbmVOYW1lICkgewoJCWVuZ2luZU5hbWUgPSBlbmdpbmVOYW1lIHx8IHRlbXBsYXRlLmRlZmF1bHRFbmdpbmU7CgkJaWYgKCFlbmdpbmVOYW1lKSB7CgkJCXRocm93ICJlbmdpbmUgbmFtZSBpcyBub3Qgc3BlY2lmaWVkIG9yIGRlZmF1bHQgZW5naW5lIG5hbWUgaXMgbnVsbCI7CgkJfQoJCXZhciBlbmdpbmVBZGFwdGVyID0gdGVtcGxhdGVFbmdpbmVBZGFwdGVyc1tlbmdpbmVOYW1lXTsKCQlpZiAoIWVuZ2luZUFkYXB0ZXIpIHsKCQkJdGhyb3cgImVuZ2luZSAnIiArIGVuZ2luZUFkYXB0ZXIgKyAiJyBjYW4gbm90IGJlIGZvdW5kLiI7CgkJfQoJCXJldHVybiBlbmdpbmVBZGFwdGVyOwoKCX0KCglmdW5jdGlvbiByZW5kZXJUZW1wbGF0ZSggdGVtcGxhdGVJZCwgZGF0YSwgcmVuZGVyQ29udGV4dCwgZW5naW5lTmFtZSApIHsKCgkJdmFyIGVuZ2luZUFkYXB0ZXIgPSBnZXRUZW1wbGF0ZUVuZ2luZSggZW5naW5lTmFtZSwgdGVtcGxhdGVJZCApOwoKCQl0ZW1wbGF0ZUlkID0gJC50cmltKCB0ZW1wbGF0ZUlkICk7CgoJCS8vcmVtb3ZlIHRoZSBzdGFydGluZyAiKiIgZnJvbSB0aGUgdGVtcGxhdGUgaWQgdG8gYmVjb21lIHRoZSByZWFsVGVtcGxhdGVJZAoJCXZhciByZWFsVGVtcGxhdGVJZCA9IHRlbXBsYXRlSWQucmVwbGFjZSggckJlZ2luV2l0aFN0YXIsICIiICk7CgoJCWlmIChlbmdpbmVBZGFwdGVyLmlzVGVtcGxhdGVMb2FkZWQoIHJlYWxUZW1wbGF0ZUlkICkpIHsKCgkJCXJldHVybiBlbmdpbmVBZGFwdGVyLnJlbmRlciggcmVhbFRlbXBsYXRlSWQsIGRhdGEsIHJlbmRlckNvbnRleHQgKTsKCgkJfSBlbHNlIGlmIChlbmdpbmVBZGFwdGVyLnJlbmRlckFzeW5jKSB7CgoJCQlyZXR1cm4gZW5naW5lQWRhcHRlci5yZW5kZXJBc3luYyggcmVhbFRlbXBsYXRlSWQsIGRhdGEsIHJlbmRlckNvbnRleHQgKTsKCgkJfSBlbHNlIHsKCgkJCXZhciBkZWZlciA9ICQuRGVmZXJyZWQoKSwKCQkJCWNsb25lRXZlbnQgPSBleHRlbmQoIHRydWUsIHt9LCByZW5kZXJDb250ZXh0LmUgKSwKCQkJCXB1Ymxpc2hlciA9IGV4dGVuZCggdHJ1ZSwge30sIGNsb25lRXZlbnQucHVibGlzaGVyICksCgkJCQljbG9uZWRDb250ZXh0ID0gZXh0ZW5kKCB0cnVlLCB7fSwgcmVuZGVyQ29udGV4dCApOwoKCQkJY2xvbmVFdmVudC5wdWJsaXNoZXIgPSBwdWJsaXNoZXI7CgkJCWNsb25lZENvbnRleHQuZSA9IGNsb25lRXZlbnQ7CgoJCQkvL3RlbXBsYXRlLmxvYWQgaXMgaW1wbGVtZW50ZWQgaW4gZXh0ZXJuYWwtdGVtcGxhdGUuanMKCQkJdGVtcGxhdGUubG9hZCggdGVtcGxhdGVJZCApLmRvbmUoIGZ1bmN0aW9uKCkgewoKCQkJCXZhciBjb250ZW50ID0gZW5naW5lQWRhcHRlci5yZW5kZXIoIHJlYWxUZW1wbGF0ZUlkLCBkYXRhLCBjbG9uZWRDb250ZXh0ICksCgkJCQkJcnRuID0gJCggY29udGVudCApOwoKCQkJCWRlZmVyLnJlc29sdmUoIHJ0bi5zZWxlY3RvciB8fCAhcnRuLmxlbmd0aCA/IGNvbnRlbnQgOiBydG4gKTsKCgkJCX0gKTsKCgkJCXJldHVybiBkZWZlci5wcm9taXNlKCk7CgoJCX0KCX0KCglobS50ZW1wbGF0ZSA9IHRlbXBsYXRlID0gewoKCQlkZWZhdWx0RW5naW5lOiAiIiwKCgkJLyoKCQkgaG0udGVtcGxhdGUubXlFbmdpbmUgPSB7CgkJIHJlbmRlcjogZnVuY3Rpb24oIHRlbXBsYXRlSWQsIGRhdGEsIGNvbnRleHQgKSB7fSwKCQkgY29tcGlsZTogZnVuY3Rpb24oIHRlbXBsYXRlSWQsIHNvdXJjZSApIHt9LAoJCSBpc1RlbXBsYXRlTG9hZGVkOiBmdW5jdGlvbiggdGVtcGxhdGVJZCApIHt9CgkJIH07CgkJICovCgkJZW5naW5lQWRhcHRlcjogZnVuY3Rpb24oIG5hbWUsIGVuZ2luZUFkYXB0ZXIgKSB7CgkJCWlmICghbmFtZSkgewoJCQkJcmV0dXJuIHRlbXBsYXRlRW5naW5lQWRhcHRlcnM7CgkJCX0KCQkJaWYgKCFlbmdpbmVBZGFwdGVyKSB7CgkJCQlyZXR1cm4gdGVtcGxhdGVFbmdpbmVBZGFwdGVyc1tuYW1lXTsKCQkJfQoJCQllbmdpbmVBZGFwdGVyLmlzVGVtcGxhdGVMb2FkZWQgPSBlbmdpbmVBZGFwdGVyLmlzVGVtcGxhdGVMb2FkZWQgfHwgcmV0dXJuVHJ1ZTsKCQkJdGVtcGxhdGVFbmdpbmVBZGFwdGVyc1tuYW1lXSA9IGVuZ2luZUFkYXB0ZXI7CgkJCXRlbXBsYXRlLmRlZmF1bHRFbmdpbmUgPSBuYW1lOwoJCX0sCgoJCS8vZHluYW1pY2FsbHkgbG9hZCBhIHRlbXBsYXRlIGJ5IHRlbXBsYXRlSWQsCgkJLy9pdCBpcyBjYWxsZWQgYnkgdGVtcGxhdGUucmVuZGVyCgkJLy9UaGUgZGVmYXVsdCBpbXBsZW1lbnRhdGlvbiByZXF1aXJlZCBsb2FkZXIuanMKCQkvL2J1dCB5b3UgY2FuIG92ZXJyaWRlIHRoaXMsIGFsbCB5b3UgbmVlZAoJCS8vIGlzIHRvIHJldHVybiBpcyB0aGF0IGEgcHJvbWlzZSwgd2hlbiB0aGUgcHJvbWlzZSBpcwoJCS8vIGRvbmUsIHRoZSB0ZW1wbGF0ZSBzaG91bGQgYmUgcmVhZHkgdG8gdXNlZAoJCWxvYWQ6IGZ1bmN0aW9uKCB0ZW1wbGF0ZUlkICkgewoJCQkvL3dlIG5lZWQgdG8gbW9kaWZ5IHRoZSBpZCBieSBhZGRpbmcgYW4gZXh0ZW5zaW9uIHRvIHRoZSBpZAoJCQkvLyBobS5sb2FkZXIgdXNlIGV4dGVuc2lvbiB0byBkZXRlcm1pbmUgd2hhdCBsb2FkZXIgaXMgdXNlZAoJCQkvLyBoYW5kbGUgdGhlIGFjdHVhbCBsb2FkaW5nIHdvcmsKCQkJcmV0dXJuIF9sb2FkZXIubG9hZCggdGVtcGxhdGVJZC5lbmRzV2l0aCggIi5odG1sIiApID8gdGVtcGxhdGVJZCA6IHRlbXBsYXRlSWQgKyAiLnRlbXBsYXRlIiApOwoJCX0sCgoJCS8vdGhpcyBzaG91bGQgYmUgY2FsbGVkIGJ5IGhtLnRlbXBsYXRlLmxvYWQgYWZ0ZXIgdGhlIG1ldGhvZAoJCS8vZ2V0IHRoZSBzb3VyY2Ugb2YgdGhlIHRlbXBsYXRlCgkJY29tcGlsZTogZnVuY3Rpb24oIHRlbXBsYXRlSWQsIHNvdXJjZSwgZW5naW5lTmFtZSApIHsKCQkJcmV0dXJuIGdldFRlbXBsYXRlRW5naW5lKCBlbmdpbmVOYW1lICkuY29tcGlsZSgKCQkJCXRlbXBsYXRlSWQuZW5kc1dpdGgoICIudGVtcGxhdGUiICkgPyBfbG9hZGVyLmZpbGVOYW1lKCB0ZW1wbGF0ZUlkICkgOiB0ZW1wbGF0ZUlkLAoJCQkJc291cmNlICk7CgkJfSwKCgkJLy9idWlsZCBhIGN1c3RvbWl6ZWQgaGFuZGxlciB3aGljaCBoYW5kbGUgdGhlIGNoYW5nZSBvZiBtb2RlbAoJCS8vYnkgZGVmYXVsdAoJCS8vZ2V0RmlsdGVyIGlzICJnZXQiIHdoaWNoIGlzIHRvIGdldCBtb2RlbCB2YWx1ZSwKCQkvLyBpdCBjYW4gYmUgYSBzdHJpbmcgb3IgZnVuY3Rpb24gKGUpIHt9CgkJLy8KCQkvL3NldEZpbHRlciBpcyAiaHRtbCIgd2hpY2ggaXMgdG8gY2hhbmdlIHRoZSBjb250ZW50IG9mIHRoZSB2aWV3CgkJLy9pdCBjYW4gYmUgYSBzdHJpbmcgb3IgZnVuY3Rpb24gKGUsIHZhbHVlKQoJCW5ld1RlbXBsYXRlSGFuZGxlcjogbmV3VGVtcGxhdGVIYW5kbGVyLAoKCQl0ZW1wbGF0ZUlkVG9Vcmw6IGZ1bmN0aW9uKCB0ZW1wbGF0ZUlkICkgewoKCQkJdmFyIG1hdGNoID0gckJlZ2luV2l0aEFway5leGVjKCB0ZW1wbGF0ZUlkICk7CgoJCQlyZXR1cm4gbWF0Y2ggPwoJCQkJLy9hcGsuaGVsbG8gLS0+IGFwcGxldC9oZWxsby9tYWluLmh0bWwKCQkJCS8vYXBrLmhlbGxvLmJ5ZSAtLT4gYXBwbGV0L2hlbGxvL2J5ZS5odG1sCgkJCQkiYXBrLyIgKyBtYXRjaFsxXSArICIvIiArIChtYXRjaFszXSB8fCAibWFpbiIgKSArICIuaHRtbCIgOgoKCQkJCS8veHh4Lmh0bWwgLS0+IHh4eC5odG1sCgkJCQkvL3h4eC55eXkuaHRtbCAtLT4geHh4Lnl5eS5odG1sCgkJCQl0ZW1wbGF0ZUlkLmVuZHNXaXRoKCAiLmh0bWwiICkgPyB0ZW1wbGF0ZUlkIDoKCgkJCQkJLy94eHggLS0+IHh4eC5odG1sCgkJCQkJLy94eHgueXl5IC0tPiB4eHguaHRtbAoJCQkJCXRlbXBsYXRlSWQuc3BsaXQoICIuIiApWzBdICsgIi5odG1sIjsKCgkJfQoKCX07CgoJX2xvYWRlciggInRlbXBsYXRlIiwgewoKCQlsb2FkOiB7CgkJCWNvbXBpbGU6IGZ1bmN0aW9uKCBtb2R1bGVJZCwgc291cmNlQ29kZSApIHsKCgkJCQl2YXIgJHNjcmlwdExpc3QgPSAkKCBzb3VyY2VDb2RlICk7CgoJCQkJdmFyIGhhc1NjcmlwdFRhZyA9IGZhbHNlOwoJCQkJJHNjcmlwdExpc3QuZWFjaCggZnVuY3Rpb24oKSB7CgoJCQkJCWlmICh0aGlzLnRhZ05hbWUgPT0gIlNDUklQVCIpIHsKCQkJCQkJaGFzU2NyaXB0VGFnID0gdHJ1ZTsKCQkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJCX0KCQkJCX0gKTsKCgkJCQlpZiAoaGFzU2NyaXB0VGFnKSB7CgoJCQkJCSRzY3JpcHRMaXN0LmVhY2goIGZ1bmN0aW9uKCkgewoKCQkJCQkJaWYgKHRoaXMudGFnTmFtZSA9PSAiU0NSSVBUIikgewoKCQkJCQkJCXZhciAkc291cmNlQ29kZUNvbnRhaW5lciA9ICQoIHRoaXMgKTsKCgkJCQkJCQl0ZW1wbGF0ZS5jb21waWxlKAoJCQkJCQkJCXRoaXMuaWQsCgkJCQkJCQkJJHNvdXJjZUNvZGVDb250YWluZXIuaHRtbCgpLAoJCQkJCQkJCSRzb3VyY2VDb2RlQ29udGFpbmVyLmF0dHIoICJ0eXBlIiApIHx8IHRlbXBsYXRlLmRlZmF1bHRFbmdpbmUgKTsKCQkJCQkJfQoKCQkJCQl9ICk7CgkJCQl9IGVsc2UgewoJCQkJCXRlbXBsYXRlLmNvbXBpbGUoIG1vZHVsZUlkLCBzb3VyY2VDb2RlLCB0ZW1wbGF0ZS5kZWZhdWx0RW5naW5lICk7CgkJCQl9CgoJCQl9LAoJCQlidWlsZERlcGVuZGVuY2llczogInBhcnNlRGVwZW5kc1RhZyIKCQl9LAoKCQl1cmw6IGZ1bmN0aW9uKCB0ZW1wbGF0ZUlkICkgewoJCQkvL2ZpcnN0IHRydW5jYXRlIHRoZSAiLnRlbXBsYXRlIiBpbiB0aGUgdGVtcGxhdGVJZCwgYW5kIGdldCB0aGUgcmVhbCB0ZW1wbGF0ZUlkCgkJCXJldHVybiB0ZW1wbGF0ZS50ZW1wbGF0ZUlkVG9VcmwoIF9sb2FkZXIuZmlsZU5hbWUoIHRlbXBsYXRlSWQgKSApOwoJCX0KCX0gKTsKCglfbG9hZGVyKCAiaHRtbCIsICJ0ZW1wbGF0ZSIsIHsKCQkvLwkJbG9hZDogewoJCS8vCQkJY29tcGlsZTogZnVuY3Rpb24oIG1vZHVsZUlkLCBzb3VyY2VDb2RlICkgewoJCS8vCQkJCXJldHVybiB0ZW1wbGF0ZS5jb21waWxlKCBtb2R1bGVJZCwgc291cmNlQ29kZSwgdGVtcGxhdGUuZGVmYXVsdEVuZ2luZSApOwoJCS8vCQkJfQoJCS8vCQl9CgoJCXVybDogZnVuY3Rpb24oIHRlbXBsYXRlSWQgKSB7CgkJCXJldHVybiB0ZW1wbGF0ZUlkOwoJCX0KCX0gKTsKCgoJaWYgKCQucmVuZGVyICYmICQudGVtcGxhdGVzKSB7CgoJCXZhciBlbmdpbmU7CgoKCQl0ZW1wbGF0ZS5lbmdpbmVBZGFwdGVyKCAianNyZW5kZXIiLCBlbmdpbmUgPSB7CgoJCQlyZW5kZXI6IGZ1bmN0aW9uKCB0ZW1wbGF0ZUlkLCBkYXRhLCBjb250ZXh0ICkgewoJCQkJaWYgKCEkLnJlbmRlclt0ZW1wbGF0ZUlkXSkgewoJCQkJCXRoaXMuY29tcGlsZSggdGVtcGxhdGVJZCwgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoIHRlbXBsYXRlSWQgKS5pbm5lckhUTUwgKTsKCQkJCX0KCQkJCXJldHVybiAkLnJlbmRlclt0ZW1wbGF0ZUlkXSggZGF0YSwgY29udGV4dCApOwoJCQl9LAoKCQkJY29tcGlsZTogZnVuY3Rpb24oIHRlbXBsYXRlSWQsIHNvdXJjZSApIHsKCQkJCSQudGVtcGxhdGVzKCB0ZW1wbGF0ZUlkLCB7CgkJCQkJbWFya3VwOiBzb3VyY2UsCgkJCQkJZGVidWc6IGVuZ2luZS50ZW1wbGF0ZURlYnVnTW9kZSwKCQkJCQlhbGxvd0NvZGU6IGVuZ2luZS5hbGxvd0NvZGVJblRlbXBsYXRlCgkJCQl9ICk7CgkJCX0sCgoJCQlpc1RlbXBsYXRlTG9hZGVkOiBmdW5jdGlvbiggdGVtcGxhdGVJZCApIHsKCQkJCXJldHVybiAhISQucmVuZGVyW3RlbXBsYXRlSWRdIHx8ICEhZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoIHRlbXBsYXRlSWQgKTsKCQkJfSwKCgkJCS8vdGVtcGxhdGVEZWJ1Z01vZGUgaXMganNSZW5kZXIgc3BlY2lmaWMgc2V0dGluZwoJCQl0ZW1wbGF0ZURlYnVnTW9kZTogZmFsc2UsCgoJCQkvL2FsbG93Q29kZUluVGVtcGxhdGUgaXMganNSZW5kZXIgc3BlY2lmaWMgc2V0dGluZwoJCQlhbGxvd0NvZGVJblRlbXBsYXRlOiB0cnVlCgkJfSApOwoKCQl2YXIgdGFncyA9ICQudmlld3MudGFnczsKCgkJLy90aGUgZm9sbG93aW5nIHRhZ3MgYSBqc3JlbmRlciBzcGVjaWZpYyBoZWxwZXIKCQl0YWdzKCB7CgkJCS8vI2RlYnVnCgkJCS8ve3tkZWJ1Z2dlciAvfX0gc28gdGhhdCBpdCBjYW4gc3RvcCBpbiB0ZW1wbGF0ZSBmdW5jdGlvbgoJCQkiZGVidWdnZXIiOiBmdW5jdGlvbiB4KCBlICkgewoJCQkJaWYgKHguZW5hYmxlZCkgewoJCQkJCWRlYnVnZ2VyOwoJCQkJfQoJCQkJcmV0dXJuICIiOwoJCQl9LAoJCQkvLyNlbmRfZGVidWcKCgkJCS8ve3t0cyAvfX0gc28gdGhhdCBpdCBjYW4gZW1pdCBhIHRpbWVzdGFtcAoJCQl0czogZnVuY3Rpb24geCgpIHsKCQkJCXJldHVybiB4LmVuYWJsZWQgPwoJCQkJCSI8c3BhbiBzdHlsZT0nY29sb3I6cmVkJyBkYXRhLXN1Yj0nc2hvdzovKnRzJz51cGRhdGVkIG9uOiIgKyAoK25ldyBEYXRlKCkgKyAiIikuc3Vic3RyaW5nKCA3LCAxMCApICsgIjwvc3Bhbj4iIDoKCQkJCQkiIjsKCQkJfSwKCgkJCWdldDogZnVuY3Rpb24oKSB7CgkJCQl2YXIgcHVibGlzaGVyID0gdGhpcy5jdHguZS5wdWJsaXNoZXI7CgkJCQlyZXR1cm4gcHVibGlzaGVyLmdldC5hcHBseSggcHVibGlzaGVyLCBhcmd1bWVudHMgKTsKCQkJfSwKCgkJCXByb3A6IGZ1bmN0aW9uKCkgewoJCQkJdmFyIGluZGV4ID0gdGhpcy50YWdDdHgudmlldy5pbmRleDsKCgkJCQlpZiAoaXNVbmRlZmluZWQoIGluZGV4ICkpIHsKCQkJCQkvL3RoaXMgaXMgdGhlIGNhc2Ugd2hlbiB0ZW1wbGF0ZSBpcyByZW5kZXIgd2l0aAoJCQkJCS8vIGEgc2luZ2xlIGRhdGEgaXRlbSBpbnN0ZWFkIG9mIGFycmF5CgkJCQkJaW5kZXggPSAodGhpcy5jdHguZS5wdWJsaXNoZXIuY291bnQoKSAtIDEpOwoJCQkJfQoKCQkJCXZhciBpdGVtTm9kZSA9IHRoaXMuY3R4LmUucHVibGlzaGVyLmNkKCBpbmRleCApOwoJCQkJcmV0dXJuIGl0ZW1Ob2RlLmdldC5hcHBseSggaXRlbU5vZGUsIGFyZ3VtZW50cyApOwoJCQl9LAoKCQkJLy97e2ZpeGVkUm93SWQgL319CgkJCWZpeGVkUm93SWQ6IGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuICIvIiArIHRoaXMuY3R4Lm1vZGVsUGF0aCArICIudGFibGUuIiArIHRoaXMuY3R4LmUucHVibGlzaGVyLml0ZW1LZXkoIHRoaXMudGFnQ3R4LnZpZXcuZGF0YSApOwoJCQl9LAoKCQkJLy97e3Jvd0lkIC99fQoJCQlyb3dJZDogZnVuY3Rpb24oKSB7CgkJCQl2YXIgaW5kZXggPSB0aGlzLnRhZ0N0eC52aWV3LmluZGV4LAoJCQkJCXBhdGggPSB0aGlzLmN0eC5tb2RlbFBhdGg7CgoJCQkJaWYgKGlzVW5kZWZpbmVkKCBpbmRleCApKSB7CgkJCQkJLy90aGlzIGlzIHRoZSBjYXNlIHdoZW4gdGVtcGxhdGUgaXMgcmVuZGVyIHdpdGgKCQkJCQkvLyBhIHNpbmdsZSBkYXRhIGl0ZW0gaW5zdGVhZCBvZiBhcnJheQoJCQkJCWluZGV4ID0gKHRoaXMuY3R4LmUucHVibGlzaGVyLmNvdW50KCkgLSAxKTsKCQkJCX0KCgkJCQlyZXR1cm4gIi8iICsgcGF0aCArICIuIiArIGluZGV4OwoJCQl9LAoKCQkJLy97e21vZGVsUGF0aCAvfX0KCQkJLy9pdCB1c2VmdWwgd2hlbiAgaW4gaHR0cDovL2pzYmluLmNvbS9ldGFjb2IvNi9lZGl0CgkJCW1vZGVsUGF0aDogZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gIi8iICsgdGhpcy5jdHgubW9kZWxQYXRoOwoJCQl9CgoJCX0gKTsKCgkJdGFncy50cy5yZW5kZXIuZW5hYmxlZCA9IHRydWU7CgkJLy8jZGVidWcKCQl0YWdzWyJkZWJ1Z2dlciJdLnJlbmRlci5lbmFibGVkID0gdHJ1ZTsKCQkvLyNlbmRfZGVidWcKCgkJaG0oICIqdHMiLCBmYWxzZSApOwoKCX0KCgoKLy8KCgoJdmFyIEhhbmRsZWJhcnMgPSB3aW5kb3cuSGFuZGxlYmFyczsKCglpZiAoIWlzVW5kZWZpbmVkKCBIYW5kbGViYXJzICkpIHsKCgkJaG0udGVtcGxhdGUuZW5naW5lQWRhcHRlciggImhhbmRsZWJhcnMiLCB7CgoJCQlyZW5kZXI6IGZ1bmN0aW9uKCB0ZW1wbGF0ZUlkLCBkYXRhLCBjb250ZXh0ICkgewoKCQkJCXJldHVybiBIYW5kbGViYXJzLnBhcnRpYWxzW3RlbXBsYXRlSWRdKCBkYXRhLCB7CgkJCQkJZGF0YToge3JlbmRlckNvbnRleHQ6IGNvbnRleHR9CgkJCQl9ICk7CgkJCX0sCgoJCQljb21waWxlOiBmdW5jdGlvbiggdGVtcGxhdGVJZCwgc291cmNlICkgewoJCQkJSGFuZGxlYmFycy5yZWdpc3RlclBhcnRpYWwoIHRlbXBsYXRlSWQsIEhhbmRsZWJhcnMuY29tcGlsZSggc291cmNlICkgKTsKCQkJfSwKCgkJCWlzVGVtcGxhdGVMb2FkZWQ6IGZ1bmN0aW9uKCB0ZW1wbGF0ZUlkICkgewoJCQkJcmV0dXJuICEhSGFuZGxlYmFycy5wYXJ0aWFsc1t0ZW1wbGF0ZUlkXTsKCQkJfQoKCQl9ICk7CgoJCS8ve3ttb2RlbFBhdGh9fQoJCUhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoICJtb2RlbFBhdGgiLCBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQkJcmV0dXJuIG9wdGlvbnMuZGF0YS5yZW5kZXJDb250ZXh0Lm1vZGVsUGF0aDsKCQl9ICk7CgoJCS8ve3tyb3dJZH19CgkJSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlciggInJvd0lkIiwgZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJCXJldHVybiAiLyIgKyBvcHRpb25zLmRhdGEucmVuZGVyQ29udGV4dC5tb2RlbFBhdGggKyAiLiIgKyBvcHRpb25zLmRhdGEuaW5kZXggKyAiOyI7CgkJfSApOwoKCQkvL3t7Zml4ZWRSb3dJZH19CgkJSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlciggImZpeGVkUm93SWQiLCBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQkJdmFyIHJlbmRlckNvbnRleHQgPSBvcHRpb25zLmRhdGEucmVuZGVyQ29udGV4dDsKCQkJcmV0dXJuICIvIiArIHJlbmRlckNvbnRleHQubW9kZWxQYXRoICsgIi50YWJsZS4iICsgcmVuZGVyQ29udGV4dC5lLnB1Ymxpc2hlci5pdGVtS2V5KCB0aGlzICk7CgkJfSApOwoKCQkvL3t7Z2V0ICIuLnNldFRvIiBuYW1lfX0KCQlIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCAiZ2V0IiwgZnVuY3Rpb24oKSB7CgkJCXZhciBhcmdzID0gYXJndW1lbnRzLAoJCQkJbGFzdCA9IGFyZ3MubGVuZ3RoIC0gMSwKCQkJLy9hcmdzW2xhc3RdLmRhdGEgaXMgb3B0aW9ucy5kYXRhCgkJCQlyZW5kZXJDb250ZXh0ID0gYXJnc1tsYXN0XS5kYXRhLnJlbmRlckNvbnRleHQ7CgoJCQlyZXR1cm4gcmVuZGVyQ29udGV4dC5nZXQuYXBwbHkoIHJlbmRlckNvbnRleHQsIHNsaWNlLmNhbGwoIGFyZ3MsIDAsIGxhc3QgKSApOwoJCX0gKTsKCgkJLy97e3twcm9wICJsaW5rIn19fQoJCUhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoICJwcm9wIiwgZnVuY3Rpb24oKSB7CgkJCXZhciBzbGljZSA9IFtdLnNsaWNlLAoJCQkJYXJncyA9IGFyZ3VtZW50cywKCQkJCWxhc3QgPSBhcmdzLmxlbmd0aCAtIDEsCgkJCQlvcHRpb25zID0gYXJnc1tsYXN0XSwKCQkJCWRhdGEgPSBvcHRpb25zLmRhdGEsCgkJCQlyZW5kZXJDb250ZXh0ID0gZGF0YS5yZW5kZXJDb250ZXh0LAoJCQkJaXRlbU5vZGUgPSByZW5kZXJDb250ZXh0LmUucHVibGlzaGVyLmNkKCBkYXRhLmluZGV4ICk7CgoJCQlyZXR1cm4gaXRlbU5vZGUuZ2V0LmFwcGx5KCBpdGVtTm9kZSwgc2xpY2UuY2FsbCggYXJncywgMCwgbGFzdCApICk7CgkJfSApOwoKCQkkKCBmdW5jdGlvbigpIHsKCQkJJCggInNjcmlwdFt0eXBlPWhhbmRsZWJhcnNdIiApLmVhY2goIGZ1bmN0aW9uKCkgewoJCQkJSGFuZGxlYmFycy5yZWdpc3RlclBhcnRpYWwoIHRoaXMuaWQsIEhhbmRsZWJhcnMuY29tcGlsZSggJCggdGhpcyApWzBdLmlubmVySFRNTCApICk7CgkJCX0gKTsKCQl9ICk7CgoJfQoKCgovLwovLzxAZGVwZW5kcz5zdWJzY3JpcHRpb24uanMsIG1vZGVsLmpzLCBkZWNsYXJhdGl2ZS5qcywgdGVtcGxhdGUuanM8L0BkZXBlbmRzPgoKCgkvL2Rvbid0IGNoYW5nZSBpdCB0byBiZWNhdXNlIHdlIHdhbnQgdG8gY29udHJvbCB0aGUgc2VhcmNoIG9yZGVyCgkvL2NoZWNrIGZpbmRWYWx1ZUFkYXB0ZXIoJGVsZW0sIGFkYXB0ZXJOYW1lKQoJLy97CgkvLyAgIG5hbWUxOiBhZGFwdGVyMSwKCS8vICAgbmFtZTI6IGFkYXB0ZXIyCgkvL30KCXZhciB2YWx1ZUFkYXB0ZXJzID0gWwoJCXsKCQkJLy90aGUgZGVmYXVsdCB2aWV3IGFkYXB0ZXIKCQkJbmFtZTogInRleHRCb3hPckRyb3BEb3duIiwKCQkJaW5pdGlhbGl6ZTogZnVuY3Rpb24oICRlbGVtLCBtb2RlbFZhbHVlICkgewoJCQkJaWYgKG1vZGVsVmFsdWUpIHsKCQkJCQlpZiAoJGVsZW1bMF0udGFnTmFtZSA9PSAiU0VMRUNUIikgewoJCQkJCQkkZWxlbS5jaGlsZHJlbigpLmVhY2goIGZ1bmN0aW9uKCkgewoJCQkJCQkJaWYgKHRoaXMudmFsdWUgPT0gbW9kZWxWYWx1ZSkgewoJCQkJCQkJCSQoIHRoaXMgKS5hdHRyKCAic2VsZWN0ZWQiLCAic2VsZWN0ZWQiICk7CgkJCQkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJCQkJfQoJCQkJCQl9ICk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJJGVsZW0uYXR0ciggInZhbHVlIiwgbW9kZWxWYWx1ZSApOwoJCQkJCX0KCQkJCX0KCQkJfSwKCQkJZ2V0OiBmdW5jdGlvbiggJGVsZW0gKSB7CgkJCQlyZXR1cm4gJGVsZW0udmFsKCk7CgkJCX0sCgkJCXNldDogZnVuY3Rpb24oICRlbGVtLCB2YWx1ZSApIHsKCQkJCWlmICgkZWxlbS52YWwoKSAhPT0gdmFsdWUpIHsKCQkJCQkkZWxlbS52YWwoIHZhbHVlICk7CgkJCQl9CgkJCX0sCgkJCW1hdGNoOiByZXR1cm5UcnVlCgkJfSwKCQl7CgkJCW5hbWU6ICJjaGVja2JveCIsCgkJCWluaXRpYWxpemU6IGZ1bmN0aW9uKCAkZWxlbSwgbW9kZWxWYWx1ZSApIHsKCQkJCWlmIChtb2RlbFZhbHVlKSB7CgkJCQkJJGVsZW0uYXR0ciggImNoZWNrZWQiLCAiY2hlY2tlZCIgKTsKCQkJCX0KCQkJfSwKCQkJZ2V0OiBmdW5jdGlvbiggJGVsZW0sIGUgKSB7CgkJCQl2YXIgZWxlbSA9ICRlbGVtWzBdOwoJCQkJdmFyIHZhbHVlID0gZWxlbS52YWx1ZTsKCgkJCQlpZiAodmFsdWUgPT0gInRydWUiKSB7CgkJCQkJcmV0dXJuIHRydWU7CgkJCQl9IGVsc2UgaWYgKHZhbHVlID09ICJmYWxzZSIpIHsKCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQl9IGVsc2UgaWYgKHZhbHVlICE9PSAib24iKSB7CgkJCQkJcmV0dXJuIHZhbHVlOwoJCQkJfSBlbHNlIHsKCQkJCQlyZXR1cm4gZWxlbS5jaGVja2VkOwoJCQkJfQoJCQl9LAoJCQlzZXQ6IGZ1bmN0aW9uIHNldENoZWNrYm94KCAkZWxlbSwgdmFsdWUgKSB7CgkJCQl2YXIgZWxlbSA9ICRlbGVtWzBdOwoJCQkJaWYgKGlzQm9vbGVhbiggdmFsdWUgKSkgewoJCQkJCWVsZW0uY2hlY2tlZCA9IHZhbHVlOwoJCQkJfSBlbHNlIHsKCQkJCQllbGVtLmNoZWNrZWQgPSAodmFsdWUgPT0gZWxlbS52YWx1ZSk7CgkJCQl9CgkJCX0sCgkJCW1hdGNoOiBmdW5jdGlvbiggJGVsZW0gKSB7CgkJCQlyZXR1cm4gJGVsZW0uaXMoICI6Y2hlY2tib3giICk7CgkJCX0KCQl9LAoJCXsKCQkJbmFtZTogInJhZGlvIiwKCQkJaW5pdGlhbGl6ZTogZnVuY3Rpb24oICRlbGVtLCBtb2RlbFZhbHVlICkgewoKCQkJCWlmIChtb2RlbFZhbHVlID09ICRlbGVtWzBdLnZhbHVlKSB7CgkJCQkJJGVsZW0uYXR0ciggImNoZWNrZWQiLCAiY2hlY2tlZCIgKTsKCQkJCX0KCQkJfSwKCQkJZ2V0OiBmdW5jdGlvbiggJGVsZW0sIGUgKSB7CgkJCQlpZiAoZS50eXBlID09ICJyZXNldFZhbCIgJiYgIWUucHVibGlzaGVyLmF0dHIoICJjaGVja2VkIiApKSB7CgkJCQkJZS5hYm9ydCgpOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQl2YXIgZWxlbSA9ICRlbGVtWzBdOwoJCQkJdmFyIHZhbHVlID0gZWxlbS52YWx1ZTsKCQkJCWlmICh2YWx1ZSA9PSAidHJ1ZSIpIHsKCQkJCQlyZXR1cm4gdHJ1ZTsKCQkJCX0gZWxzZSBpZiAodmFsdWUgPT0gImZhbHNlIikgewoJCQkJCXJldHVybiBmYWxzZTsKCQkJCX0gZWxzZSBpZiAodmFsdWUgIT09ICJvbiIpIHsKCQkJCQlyZXR1cm4gdmFsdWU7CgkJCQl9IGVsc2UgewoJCQkJCXJldHVybiBlbGVtLmNoZWNrZWQ7CgkJCQl9CgkJCX0sCgkJCXNldDogZnVuY3Rpb24oICRlbGVtLCB2YWx1ZSwgZSApIHsKCQkJCXZhciBlbGVtID0gJGVsZW1bMF07CgkJCQlpZiAoIWVsZW0ubmFtZSkgewoJCQkJCWVsZW0ubmFtZSA9IGUucHVibGlzaGVyLnBhdGg7CgkJCQl9CgkJCQllbGVtLmNoZWNrZWQgPSAoIHV0aWwudG9TdHJpbmcoIHZhbHVlICkgPT0gZWxlbS52YWx1ZSApOwoJCQl9LAoJCQltYXRjaDogZnVuY3Rpb24oICRlbGVtICkgewoJCQkJcmV0dXJuICRlbGVtLmlzKCAiOnJhZGlvIiApOwoJCQl9CgkJfSwKCQl7CgkJCW5hbWU6ICJsaXN0Qm94IiwKCQkJaW5pdGlhbGl6ZTogZnVuY3Rpb24oICRlbGVtLCBtb2RlbFZhbHVlICkgewoJCQkJJGVsZW0uY2hpbGRyZW4oKS5lYWNoKCBmdW5jdGlvbigpIHsKCQkJCQlpZiAobW9kZWxWYWx1ZS5jb250YWlucyggdGhpcy52YWx1ZSApKSB7CgkJCQkJCSQoIHRoaXMgKS5hdHRyKCAic2VsZWN0ZWQiLCAic2VsZWN0ZWQiICk7CgkJCQkJfQoJCQkJfSApOwoJCQl9LAoKCQkJZ2V0OiBmdW5jdGlvbiggJGVsZW0gKSB7CgkJCQl2YXIgb3B0aW9ucyA9IFtdOwoJCQkJJGVsZW0uY2hpbGRyZW4oICJvcHRpb246c2VsZWN0ZWQiICkuZWFjaCggZnVuY3Rpb24oKSB7CgkJCQkJb3B0aW9ucy5wdXNoKCB0aGlzLnZhbHVlICk7CgkJCQl9ICk7CgkJCQlyZXR1cm4gb3B0aW9ucy5sZW5ndGggPyBvcHRpb25zIDogbnVsbDsKCQkJfSwKCQkJc2V0OiBmdW5jdGlvbiggJGVsZW0sIHZhbHVlICkgewoJCQkJJGVsZW0uY2hpbGRyZW4oKS5lYWNoKCBmdW5jdGlvbigpIHsKCQkJCQl0aGlzLnNlbGVjdGVkID0gISEodmFsdWUgJiYgdmFsdWUuY29udGFpbnMoIHRoaXMudmFsdWUgKSk7CgkJCQl9ICk7CgkJCX0sCgkJCW1hdGNoOiBmdW5jdGlvbiggJGVsZW0gKSB7CgkJCQlyZXR1cm4gJGVsZW0uaXMoICJzZWxlY3RbbXVsdGlwbGVdIiApOwoJCQl9CgkJfQoJXTsKCglmdW5jdGlvbiBmaW5kVmFsdWVBZGFwdGVyKCAkZWxlbSwgYWRhcHRlck5hbWUgKSB7CgkJdmFyIGksIGFkYXB0ZXI7CgoJCWlmIChhZGFwdGVyTmFtZSkgewoJCQlmb3IgKGkgPSB2YWx1ZUFkYXB0ZXJzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CgkJCQlhZGFwdGVyID0gdmFsdWVBZGFwdGVyc1tpXTsKCQkJCWlmIChhZGFwdGVyLm5hbWUgPT0gYWRhcHRlck5hbWUpIHsKCQkJCQlyZXR1cm4gYWRhcHRlcjsKCQkJCX0KCQkJfQoJCX0gZWxzZSB7CgkJCS8vc2VhcmNoIGZyb20gdGFpbCB0byBoZWFkCgkJCWZvciAoaSA9IHZhbHVlQWRhcHRlcnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKCQkJCWFkYXB0ZXIgPSB2YWx1ZUFkYXB0ZXJzW2ldOwoJCQkJaWYgKGFkYXB0ZXIubWF0Y2ggJiYgYWRhcHRlci5tYXRjaCggJGVsZW0gKSkgewoJCQkJCXJldHVybiBhZGFwdGVyOwoJCQkJfQoJCQl9CgkJfQoJfQoKCWhtLmFjdGl2aXR5LmdldC5nZXRWaWV3VmFsdWUgPSBmdW5jdGlvbiggZSApIHsKCQkvL2UuaGFuZGxlci5nZXRWaWV3VmFsdWUgaXMgaW5pdGlhbGl6ZWQgd2hlbiBvbiBzdWJzY3JpcHRpb24KCQlyZXR1cm4gZS5oYW5kbGVyLmdldFZpZXdWYWx1ZSggZS5wdWJsaXNoZXIsIGUgKTsKCX07CgoJaG0uYWN0aXZpdHkuc2V0LnNldFZpZXdWYWx1ZSA9IGZ1bmN0aW9uKCB2YWx1ZSwgZSApIHsKCQkvL2UuaGFuZGxlci5zZXRWaWV3VmFsdWUgaXMgaW5pdGlhbGl6ZWQgd2hlbiBvbiBzdWJzY3JpcHRpb24KCQlyZXR1cm4gZS5oYW5kbGVyLnNldFZpZXdWYWx1ZSggdGhpcywgdmFsdWUsIGUgKTsKCX07CgoJZnVuY3Rpb24gaW5pdEFkYXB0ZXJNZXRob2RGb3JWaWV3KCBtb2RlbCwgdmlldywgaGFuZGxlciwgYWRhcHRlck5hbWUsIG1ldGhvZE5hbWUgKSB7CgoJCXZhciBhZGFwdGVyID0gZmluZFZhbHVlQWRhcHRlciggdmlldywgYWRhcHRlck5hbWUgKTsKCgkJaWYgKCFhZGFwdGVyIHx8ICFhZGFwdGVyW21ldGhvZE5hbWVdKSB7CgoJCQl0aHJvdyAiY2FuIG5vdCBmaW5kICIgKyBtZXRob2ROYW1lICsgIiBtZXRob2QgZm9yIHZpZXciOwoJCX0KCgkJLy9jcmVhdGUgaGFuZGxlci5nZXRWaWV3VmFsdWUgb3IgaGFuZGxlci5zZXRWaWV3VmFsdWUKCQloYW5kbGVyW21ldGhvZE5hbWUgKyAiVmlld1ZhbHVlIl0gPSBhZGFwdGVyW21ldGhvZE5hbWVdOwoKCQlpZiAoYWRhcHRlci5jb252ZXJ0KSB7CgkJCWhhbmRsZXIuY29udmVydCA9IGFkYXB0ZXIuY29udmVydDsKCQl9CgoJCS8vd2Ugd2FudCB0byBydW4gdGhlIGluaXRpYWxpemUgbWV0aG9kIG9ubHkgb25jZQoJCWlmICghdmlldy5obURhdGEoICJ2YWx1ZUJvdW5kIiApKSB7CgoJCQlhZGFwdGVyLmluaXRpYWxpemUgJiYgYWRhcHRlci5pbml0aWFsaXplKCB2aWV3LCBtb2RlbC5nZXQoKSApOwoKCQkJLy93aGVuICJyZXNldCIgZXZlbnQgaXMgdHJpZ2dlciB0byBwYXJlbnQgZm9ybSwgdGhlIGNoaWxkcmVuIGRvZXMKCQkJLy9ub3QgdHJpZ2dlciB0aGUgZXZlbnQsIHNvIHRoYXQgd2UgbmVlZCB0byB0cmlnZ2VyICJyZXNldFZhbCIgdG8gdXBkYXRlCgkJCS8vYmFjayB0aGUgb3JpZ2luYWwgdmFsdWUgdG8gbW9kYWwKCQkJdmlldy5wYXJlbnRzKCAiZm9ybSIgKS5iaW5kKCAicmVzZXQiLCBmdW5jdGlvbigpIHsKCgkJCQlzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJCQl2aWV3LnRyaWdnZXJIYW5kbGVyKCAicmVzZXRWYWwiICk7CgkJCQl9LCAxMCApOwoJCQl9ICk7CgoJCQl2aWV3LmhtRGF0YSggInZhbHVlQm91bmQiLCB0cnVlICk7CgoJCX0KCX0KCglobS53b3JrZmxvdyggewoKCQkvL3NldCB2aWV3IHZhbHVlIHdpdGggbW9kZWwgdmFsdWUKCQl1cGRhdGVWaWV3VmFsdWU6IHsKCQkJaW5pdGlhbGl6ZTogZnVuY3Rpb24oIHB1Ymxpc2hlciwgc3Vic2NyaWJlciwgd29ya2Zsb3csIGFkYXB0ZXJOYW1lICkgewoJCQkJLy9zdWJzY3JpYmVyIGlzIHZpZXcsIHRyeWluZyB0byBnZXRNb2RlbCBzZXRWaWV3CgkJCQlpbml0QWRhcHRlck1ldGhvZEZvclZpZXcoIHB1Ymxpc2hlciwgc3Vic2NyaWJlciwgd29ya2Zsb3csIGFkYXB0ZXJOYW1lLCAic2V0IiApOwoKCQkJfSwKCQkJZ2V0OiAiZ2V0IiwKCQkJc2V0OiAiKnNldFZpZXdWYWx1ZSIKCQl9LAoKCQkvL3NldCBtb2RlbCB2YWx1ZSB3aXRoIHZpZXcgdmFsdWUKCQl1cGRhdGVNb2RlbFZhbHVlOiB7CgoJCQlpbml0aWFsaXplOiBmdW5jdGlvbiggcHVibGlzaGVyLCBzdWJzY3JpYmVyLCB3b3JrZmxvdywgYWRhcHRlck5hbWUgKSB7CgkJCQkvL3B1Ymxpc2hlciBpcyB2aWV3LCB0cnlpbmcgdG8gZ2V0VmlldyBzZXRNb2RlbAoJCQkJaW5pdEFkYXB0ZXJNZXRob2RGb3JWaWV3KCBzdWJzY3JpYmVyLCBwdWJsaXNoZXIsIHdvcmtmbG93LCBhZGFwdGVyTmFtZSwgImdldCIgKTsKCgkJCX0sCgkJCWdldDogIipnZXRWaWV3VmFsdWUiLAoJCQlzZXQ6ICJzZXQiCgkJfQoJfSApOwoKCS8vYWRkIHZhbHVlIGFkYXB0ZXIKCS8vdGhlIGxhc3QgYWRkZWQgdXNpbmcgdGhlIG1ldGhvZCwgd2lsbCBiZSBldmFsdWF0ZWQgZmlyc3QKCS8qCgkgLy9hIHZpZXcgYWRhcHRlciBpcyBpcyBsaWtlCgkgewoJIC8vb3B0aW9uYWwgaWYgbWF0Y2ggZnVuY3Rpb24gaXMgcHJlc2VudAoJIG5hbWU6ICJhZGFwdGVyTmFtZSIsCgkgLy8KCSAvL29wdGlvbmFsIGlmIG5hbWUgaXMgcHJlc2VudAoJIG1hdGNoOiBmdW5jdGlvbiAoJGVsZW0pIHsgcmV0dXJuIHRydWU7IH0sCgkgLy8KCSAvL3ByZXBhcmUgJGVsZW1lbnQKCSBpbml0aWFsaXplOiBmdW5jdGlvbiAoJGVsZW0pIHt9CgkgLy8KCSAvL2dldCBhIHZhbHVlIGZyb20gZWxlbWVudAoJIGdldDogZnVuY3Rpb24gKCRlbGVtKSB7fSwKCSAvLwoJIC8vc2V0IGEgdmFsdWUgdG8gJGVsZW1lbnQKCSBzZXQ6IGZ1bmN0aW9uKCAkZWxlbSwgdmFsdWUgKSB7fSwKCSAvLwoJIC8vb3B0aW9uYWwsIGlmIGdldCBmdW5jdGlvbiBhbHJlYWR5IGNvbnZlcnQsIHlvdSBkb24ndCBuZWVkIHRoaXMKCSBjb252ZXJ0OiAiKmNvbW1vbkNvbnZlcnRBY3Rpdml0eU5hbWUiIG9yIGZ1bmN0aW9uICh2YWx1ZSkge30KCgkgfQoJICogKi8KCWhtLnZhbHVlQWRhcHRlciA9IGZ1bmN0aW9uKCBhZGFwdGVyICkgewoJCWlmIChhZGFwdGVyKSB7CgkJCXZhbHVlQWRhcHRlcnMucHVzaCggYWRhcHRlciApOwoJCX0gZWxzZSB7CgkJCXJldHVybiB2YWx1ZUFkYXB0ZXJzOwoJCX0KCX07CgoJLy9keW5hbWljIGdyb3VwCgkvL3N1cHBvcnQgdGhlIGZvbGxvd2luZwoJLy8KCS8vdmFsOnBhdGgKCS8vdmFsOnBhdGh8a2V5cHJlc3MKCS8vdmFsOnBhdGh8LHVwZGF0ZU1vZGVsCgkvL3ZhbDpwYXRofCx1cGRhdGVWaWV3CgkvL3ZhbDpwYXRofCwsZGF0ZQoJLy92YWw6cGF0aHx1cGRhdGVFdmVudCx1cGRhdGVEaXJlY3Rpb24sYWRhcHRlck5hbWUKCWJpbmRpbmdzKCB7CgkJdmFsOiBmdW5jdGlvbiggZWxlbSwgcGF0aCwgY29udGV4dCwgb3B0aW9ucyApIHsKCgkJCXZhciB1cGRhdGVUYXJnZXQsCgkJCQl1cGRhdGVFdmVudCwKCQkJCWFkYXB0ZXJOYW1lOwoKCQkJb3B0aW9ucyA9IG9wdGlvbnMgfHwgIiI7CgoJCQlpZiAoIW9wdGlvbnMpIHsKCQkJCXVwZGF0ZUV2ZW50ID0gImNoYW5nZSI7CgkJCX0gZWxzZSB7CgkJCQlvcHRpb25zID0gb3B0aW9ucy5zcGxpdCggIiwiICk7CgkJCQl1cGRhdGVFdmVudCA9IG9wdGlvbnNbMF0gfHwgImNoYW5nZSI7IC8vYnkgZGVmYXVsdCBpdCBpcyAiY2hhbmdlIgoJCQkJdXBkYXRlVGFyZ2V0ID0gb3B0aW9uc1sxXTsgLy91bmRlZmluZWQsIHVwZGF0ZVZpZXcgb3IgdXBkYXRlTW9kZWwKCQkJCWFkYXB0ZXJOYW1lID0gb3B0aW9uc1syXTsKCQkJfQoKCQkJaWYgKCF1cGRhdGVUYXJnZXQgfHwgdXBkYXRlVGFyZ2V0ID09ICJ2aWV3IikgewoJCQkJY29udGV4dC5hcHBlbmRTdWIoIGVsZW0sIHBhdGgsICJpbml0MSBhZnRlcioiLCAiKnVwZGF0ZVZpZXdWYWx1ZSIsIGFkYXB0ZXJOYW1lICk7CgkJCX0KCgkJCWlmICghdXBkYXRlVGFyZ2V0IHx8IHVwZGF0ZVRhcmdldCA9PSAibW9kZWwiKSB7CgoJCQkJLy93aGVuIGZvcm0gaXMgcmVzZXQsIHRoZSBkZWZhdWx0IGJlaGF2aW9yIG9mIHRoZSBodG1sIGZvcm0gdmFsdWUgaXMgcmVzZXQKCQkJCS8vIHRvIHZhbHVlIHNwZWNpZnkgInZhbHVlIiBhdHRyaWJ1dGUsIGhvd2V2ZXIgdGhlIGNoYW5nZSBldmVudCBkb2VzIG5vdCB0cmlnZ2VyLAoJCQkJLy8KCQkJCS8vc28gd2UgbmVlZCB0byB1c2UgYSBzcGVjaWFsIGV2ZW50ICJyZXNldFZhbCIgd2hpY2ggaXMgdHJpZ2dlcmVkCgkJCQkvLyB3aGVuIHRoZSBwYXJlbnQgZm9ybSBlbGVtZW50IGlzIHRyaWdnZXJlZAoJCQkJLy8gYnkgdXNpbmcgdGhpcyBldmVudCwgd2Ugd2FudCB0byB1cGRhdGUgbW9kZWwgZnJvbSB0aGUgdmlldyB2YWx1ZQoJCQkJY29udGV4dC5wcmVwZW5kU3ViKCBwYXRoLCBlbGVtLCB1cGRhdGVFdmVudCArICIgcmVzZXRWYWwiLCAiKnVwZGF0ZU1vZGVsVmFsdWUiLCBhZGFwdGVyTmFtZSApOwoKCQkJfQoJCX0KCX0gKTsKCgoKLy8KLy88QGRlcGVuZHM+c3Vic2NyaXB0aW9uLmpzLCBtb2RlbC5qcywgZGVjbGFyYXRpdmUuanMsIHRlbXBsYXRlLmpzPC9AZGVwZW5kcz4KCgoJZGVmYXVsdE9wdGlvbnMuY29uZmlybU1lc3NhZ2UgPSAiQXJlIHlvdSBzdXJlPyI7CgoJZnVuY3Rpb24gYWRkQmluZGluZ0FuZFdvcmtmbG93VHlwZSggZmVhdHVyZXMgKSB7CgkJZm9yICh2YXIgbmFtZSBpbiBmZWF0dXJlcykgewoJCQl2YXIgaXRlbSA9IGZlYXR1cmVzW25hbWVdOwoJCQliaW5kaW5ncyggbmFtZSwgaXRlbVswXSApOwoJCQlobS53b3JrZmxvdyggbmFtZSwgaXRlbVsxXSApOwoJCX0KCX0KCglobS5hY3Rpdml0eS5nZXQuY29tcGFyZVRydXRoeSA9IGZ1bmN0aW9uKCBlICkgewoJCXZhciBleHByZXNzaW9uID0gZS5oYW5kbGVyLm9wdGlvbnMsCgkJCXB1Ymxpc2hlciA9IGUucHVibGlzaGVyOwoJCXJldHVybiBpc1VuZGVmaW5lZCggZXhwcmVzc2lvbiApID8KCQkJIXB1Ymxpc2hlci5pc0VtcHR5KCkgOgoJCQlwdWJsaXNoZXIuY29tcGFyZSggZXhwcmVzc2lvbiApOwoJfTsKCglobS5hY3Rpdml0eS5pbml0aWFsaXplLmV4dHJhY3RDbGFzcyA9IGZ1bmN0aW9uKCBwdWJsaXNoZXIsIHN1YnNjcmliZXIsIHdvcmtmbG93LCBvcHRpb25zICkgewoJCXZhciBwYXJ0cyA9IG9wdGlvbnMuc3BsaXQoICIsIiApOwoJCXdvcmtmbG93LmNsYXNzTmFtZSA9IHBhcnRzWzBdOwoJCXdvcmtmbG93Lm9wdGlvbnMgPSBwYXJ0c1sxXTsKCX07CgoJYWRkQmluZGluZ0FuZFdvcmtmbG93VHlwZSggewoKCQkvLy0tLS0tLS0tY2hhbmdpbmcgdmlldy0tLS0tLS0tLS0KCQlvcHRpb25zOiBbCgkJCSIhaW5pdCBhZnRlcio6Lnwqb3B0aW9ucyIsCgkJCS8vYWRkIG1vZGVsIHdvcmtmbG93cwoJCQkvL3JlbmRlciA8c2VsZWN0PiBvcHRpb25zCgkJCS8vPHNlbGVjdCBvcHRpb25zPSJtb2RlbFBhdGgiPgoJCQkvLzxzZWxlY3Qgb3B0aW9ucz0ibW9kZWxQYXRofHByb3BlcnR5TmFtZSI+CgkJCS8vPHNlbGVjdCBvcHRpb25zPSJtb2RlbFBhdGh8dGV4dENvbHVtbix2YWxDb2x1bW4iPgoJCQl7CgkJCQkvL3RoaXMgaXMgYWN0dWFsbHkgdGhlIGV4ZWN1dGUgZnVuY3Rpb24sIGluIHRoaXMgd29ya2Zsb3cKCQkJCS8vdGhlcmUgaXMgbm8gc2V0LCB0aGUgY29udGVudCBvZiB0aGUgdmlldyBpcyByZW5kZXIKCQkJCS8vaW4gdGhlIGdldCBmdW5jdGlvbi4KCQkJCWdldDogZnVuY3Rpb24oIGUgKSB7CgkJCQkJdmFyIG9wdGlvbnMgPSBlLmhhbmRsZXIub3B0aW9ucywKCQkJCQkJc3Vic2NyaWJlciA9IHRoaXMsCgkJCQkJCXZhbHVlID0gc3Vic2NyaWJlci52YWwoKTsKCgkJCQkJc3Vic2NyaWJlci5jaGlsZHJlbiggIm9wdGlvbltsaXN0SXRlbV0iICkKCQkJCQkJLnJlbW92ZSgpLmVuZCgpLmFwcGVuZCgKCQkJCQkJZnVuY3Rpb24oKSB7CgkJCQkJCQl2YXIgaHRtbCA9ICIiOwoJCQkJCQkJJCggZS5wdWJsaXNoZXIuZ2V0KCkgKS5lYWNoKCBmdW5jdGlvbigpIHsKCQkJCQkJCQlodG1sICs9ICI8b3B0aW9uIGxpc3RJdGVtPScxJyB2YWx1ZT0nIiArIG9wdGlvbnMudmFsdWUoIHRoaXMgKSArICInPiIgKyBvcHRpb25zLm5hbWUoIHRoaXMgKSArICI8L29wdGlvbj4iOwoJCQkJCQkJfSApOwoJCQkJCQkJcmV0dXJuIGh0bWw7CgkJCQkJCX0gKS52YWwoIHZhbHVlICk7CgoJCQkJCWlmIChzdWJzY3JpYmVyLnZhbCgpICE9PSB2YWx1ZSkgewoJCQkJCQkkKCBzdWJzY3JpYmVyLnRyaWdnZXIoICJjaGFuZ2UiICkgKTsKCQkJCQl9CgkJCQl9LAoKCQkJCWluaXRpYWxpemU6IGZ1bmN0aW9uKCBwdWJsaXNoZXIsIHN1YnNjcmliZXIsIHdvcmtmbG93LCBvcHRpb25zICkgewoJCQkJCWlmIChvcHRpb25zKSB7CgoJCQkJCQl2YXIgcGFydHMgPSBvcHRpb25zLnNwbGl0KCAiLCIgKSwKCQkJCQkJCXRleHRDb2x1bW4gPSBwYXJ0c1swXSwKCQkJCQkJCXZhbHVlQ29sdW1uID0gcGFydHNbMV0gfHwgcGFydHNbMF07CgoJCQkJCQl3b3JrZmxvdy5vcHRpb25zID0gewoJCQkJCQkJbmFtZTogZnVuY3Rpb24oIGl0ZW0gKSB7CgkJCQkJCQkJcmV0dXJuIGl0ZW1bdGV4dENvbHVtbl07CgkJCQkJCQl9LAoJCQkJCQkJdmFsdWU6IGZ1bmN0aW9uKCBpdGVtICkgewoJCQkJCQkJCXJldHVybiBpdGVtW3ZhbHVlQ29sdW1uXTsKCQkJCQkJCX0KCQkJCQkJfTsKCgkJCQkJfSBlbHNlIHsKCgkJCQkJCXdvcmtmbG93Lm9wdGlvbnMgPSB7CgkJCQkJCQluYW1lOiBmdW5jdGlvbiggaXRlbSApIHsKCQkJCQkJCQlyZXR1cm4gaXRlbS50b1N0cmluZygpOwoJCQkJCQkJfSwKCQkJCQkJCXZhbHVlOiBmdW5jdGlvbiggaXRlbSApIHsKCQkJCQkJCQlyZXR1cm4gaXRlbS50b1N0cmluZygpOwoJCQkJCQkJfQoJCQkJCQl9OwoJCQkJCX0KCQkJCX0KCQkJfQoJCV0sCgoJCXNob3c6IFsKCgkJCS8vZGF0YS1zdWI9ImBzaG93OnBhdGgiCgkJCSIhaW5pdCBhZnRlcio6Lnwqc2hvdyIsCgoJCQl7CgoJCQkJZ2V0OiAiKmNvbXBhcmVUcnV0aHkiLAoKCQkJCXNldDogZnVuY3Rpb24oIHRydXRoeSApIHsKCgkJCQkJdGhpc1t0cnV0aHkgPyAic2hvdyIgOiAiaGlkZSJdKCk7CgoJCQkJfQoJCQl9CgoJCV0sCgoJCWhpZGU6IFsKCgkJCSIhaW5pdCBhZnRlcio6LnwqaGlkZSIsCgoJCQl7CgkJCQlnZXQ6ICIqY29tcGFyZVRydXRoeSIsCgoJCQkJLy91c2Ugc3Vic2NyaXB0aW9uIGdyb3VwIGluc3RlYWQKCQkJCXNldDogZnVuY3Rpb24oIHRydXRoeSApIHsKCgkJCQkJdGhpc1sgdHJ1dGh5ID8gImhpZGUiIDogInNob3ciXSgpOwoJCQkJfQoJCQl9CgkJXSwKCgkJZW5hYmxlOiBbCgoJCQkiIWluaXQgYWZ0ZXIqOi58KmVuYWJsZSIsCgoJCQl7CgkJCQlnZXQ6ICIqY29tcGFyZVRydXRoeSIsCgoJCQkJc2V0OiBmdW5jdGlvbiggdHJ1dGh5ICkgewoKCQkJCQl0aGlzLmF0dHIoICJkaXNhYmxlZCIsICF0cnV0aHkgKTsKCQkJCX0KCQkJfQoJCV0sCgoJCWRpc2FibGU6IFsKCgkJCSIhaW5pdCBhZnRlcio6LnwqZGlzYWJsZSIsCgkJCXsKCQkJCWdldDogIipjb21wYXJlVHJ1dGh5IiwKCgkJCQlzZXQ6IGZ1bmN0aW9uKCB0cnV0aHkgKSB7CgkJCQkJdGhpcy5hdHRyKCAiZGlzYWJsZWQiLCB0cnV0aHkgKTsKCQkJCX0KCQkJfQoJCV0sCgoJCWFkZENsYXNzOiBbCgoJCQkiIWluaXQgYWZ0ZXIqOi58KmFkZENsYXNzIiwKCQkJewoKCQkJCWluaXRpYWxpemU6ICIqZXh0cmFjdENsYXNzIiwKCgkJCQlnZXQ6ICIqY29tcGFyZVRydXRoeSIsCgoJCQkJc2V0OiBmdW5jdGlvbiggdHJ1dGh5LCBlICkgewoKCQkJCQl0aGlzW3RydXRoeSA/ICJhZGRDbGFzcyIgOiAicmVtb3ZlQ2xhc3MiXSggZS5oYW5kbGVyLmNsYXNzTmFtZSApOwoJCQkJfQoJCQl9CgkJXSwKCgkJcmVtb3ZlQ2xhc3M6IFsKCgkJCSIhaW5pdCBhZnRlcio6LnwqcmVtb3ZlQ2xhc3MiLCB7CgoJCQkJaW5pdGlhbGl6ZTogIipleHRyYWN0Q2xhc3MiLAoKCQkJCWdldDogIipjb21wYXJlVHJ1dGh5IiwKCgkJCQlzZXQ6IGZ1bmN0aW9uKCB0cnV0aHksIGUgKSB7CgoJCQkJCXRoaXNbdHJ1dGh5ID8gInJlbW92ZUNsYXNzIiA6ICJhZGRDbGFzcyJdKCBlLmhhbmRsZXIuY2xhc3NOYW1lICk7CgoJCQkJfQoJCQl9CgkJXSwKCiAgICAgICAgLy90aGUgY2xhc3MgbmFtZSBjYW4gYmUgcGFzc2VkIGFzIG9wdGlvbnMgcGFyYW1ldGVyCiAgICAgICAgLy9vciB0aGUgY2xhc3MgbmFtZSBpcyB0aGUgdmFsdWUgb2YgdGhlIG1vZGVsCiAgICAgICAgLy8KICAgICAgICAvL3RvZ2dsZS1jbGFzcz0ibW9kZWwiCiAgICAgICAgLy9vcgogICAgICAgIC8vPHAgIWFmdGVyVXBkYXRlPSJpc0hhcHB5fCpmYWtlR2V0IHRvZ2dsZUNsYXNzKmhhcHB5IiA+PC9wPgoJCXRvZ2dsZUNsYXNzOiBbCgoJCQkiIWluaXQgYWZ0ZXIqOi58KnRvZ2dsZUNsYXNzIiwgewoKCQkJCWdldDogZnVuY3Rpb24oIGUgKSB7CgkJCQkJdmFyIG1ldGhvZCwKCQkJCQkJcmV2ZXJzZSwKCQkJCQkJdmFsdWUgPSBlLnB1Ymxpc2hlci5nZXQoKSwKCQkJCQkJY2xhc3NOYW1lID0gZS5oYW5kbGVyLm9wdGlvbnM7CgoJCQkJCWlmIChjbGFzc05hbWUpIHsKCQkJCQkJaWYgKGNsYXNzTmFtZS5zdGFydHNXaXRoKCAiISIgKSkgewoJCQkJCQkJcmV2ZXJzZSA9IHRydWU7CgkJCQkJCQljbGFzc05hbWUgPSBjbGFzc05hbWUuc3Vic3RyKCAxICk7CgkJCQkJCX0KCgkJCQkJCW1ldGhvZCA9IHZhbHVlIF4gcmV2ZXJzZSA/ICJhZGRDbGFzcyIgOiAicmVtb3ZlQ2xhc3MiOwoJCQkJCX0KCgkJCQkJaWYgKGUudHlwZSA9PSAiaW5pdCIpIHsKCgkJCQkJCWlmIChjbGFzc05hbWUpIHsKCgkJCQkJCQl0aGlzW21ldGhvZF0oIGNsYXNzTmFtZSApOwoKCQkJCQkJfSBlbHNlIHsKCgkJCQkJCQl0aGlzLmFkZENsYXNzKCB2YWx1ZSApOwoJCQkJCQl9CgoJCQkJCX0gZWxzZSB7CgkJCQkJCWlmIChjbGFzc05hbWUpIHsKCgkJCQkJCQl0aGlzW21ldGhvZF0oIGNsYXNzTmFtZSApOwoKCQkJCQkJfSBlbHNlIHsKCgkJCQkJCQl0aGlzLnJlbW92ZUNsYXNzKCBlLnJlbW92ZWQgKS5hZGRDbGFzcyggdmFsdWUgKTsKCgkJCQkJCX0KCQkJCQl9CgkJCQl9CgkJCX0KCQldLAoKCQkvL2ZvY3VzOippc0VkaXRNb2RlCgkJLy9mb2N1cyBvbiBhIHZpZXcgaWYgbW9kZWwgaXMgbm90IGVtcHR5CgkJZm9jdXM6IFsKCQkJIiFpbml0IGFmdGVyKjoufCpmb2N1cyIsCgkJCXsKCQkJCWdldDogIipjb21wYXJlVHJ1dGh5IiwKCgkJCQlzZXQ6IGZ1bmN0aW9uKCB0cnV0aHksIGUgKSB7CgoJCQkJCWlmICh0cnV0aHkpIHsKCQkJCQkJdmFyIHN1YnNjcmliZXIgPSB0aGlzOwoJCQkJCQlzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJCQkJCXN1YnNjcmliZXIuZm9jdXMoKS5zZWxlY3QoKTsKCQkJCQkJfSwgMSApOwoJCQkJCX0KCQkJCX0KCQkJfQoJCV0sCgoJCWNvdW50OiBbCgoJCQkiIWluaXQgYWZ0ZXIqOi58KmNvdW50IiwKCgkJCWZ1bmN0aW9uKCBlICkgewoJCQkJdmFyIHZhbHVlID0gZS5wdWJsaXNoZXIuZ2V0KCksCgkJCQkJY291bnQgPSAoICJsZW5ndGgiIGluIHZhbHVlKSA/IHZhbHVlLmxlbmd0aCA6IHZhbHVlOwoKCQkJCXRoaXMudGV4dCggY291bnQgKTsKCQkJfQoJCV0sCgoJCWR1bXA6IFsKCgkJCSIhaW5pdCAqOi58KmR1bXAiLAoKCQkJZnVuY3Rpb24oIGUgKSB7CgkJCQlpZiAoIWUudHlwZS5zdGFydHNXaXRoKCAiYmVmb3JlIiApKSB7CgkJCQkJdGhpcy5odG1sKCAiPHNwYW4gc3R5bGU9J2NvbG9yOnJlZCc+IiArIGUucHVibGlzaGVyLnBhdGggKyAiIDogIiArIGUucHVibGlzaGVyLnRvSlNPTigpICsgIjwvc3Bhbj4iICk7CgkJCQl9CgkJCX0KCQldLAoKCQkvL2FsZXJ0OnBhdGggLy90aGlzIHdpbGwgYWxlcnQgdGhlIGRhdGEgaW4gbW9kZWwKCQkvL2FsZXJ0Ol98aGVsbG8gd29ybGQgLy90aGlzIHdpbGwgYWxlcnQgImhlbGxvIHdvcmxkIgoJCWFsZXJ0OiBbCgoJCQkiJGNsaWNrOi58KmFsZXJ0IiwKCgkJCWZ1bmN0aW9uKCBlICkgewoJCQkJYWxlcnQoIGlzVW5kZWZpbmVkKCBlLmhhbmRsZXIub3B0aW9ucyApID8gdGhpcy5nZXQoKSA6IGUuaGFuZGxlci5vcHRpb25zICk7CgkJCX0KCgkJXSwKCgkJbG9nOiBbCgoJCQkiJGNsaWNrOi58KmxvZyIsCgoJCQlmdW5jdGlvbiAoZSkgewoJCQkJaG0ubG9nKCBpc1VuZGVmaW5lZCggZS5oYW5kbGVyLm9wdGlvbnMgKSA/IHRoaXMuZ2V0KCkgOiBlLmhhbmRsZXIub3B0aW9ucyApOwoJCQl9CgkJXSwKCQlwcmV2ZW50RGVmYXVsdDogWwoKCQkJIiRjbGljazpffCpwcmV2ZW50RGVmYXVsdCIsCgoJCQlmdW5jdGlvbiggZSApIHsKCQkJCWUucHJldmVudERlZmF1bHQoKTsKCQkJfQoJCV0sCgoJCXN0b3BQcm9wYWdhdGlvbjogWwoKCQkJIiRjbGljazpffCpzdG9wUHJvcGFnYXRpb24iLAoKCQkJZnVuY3Rpb24oIGUgKSB7CgkJCQllLnN0b3BQcm9wYWdhdGlvbigpOwoJCQl9CgkJXSwKCgkJLy9jb25maXJtOl8KCQkvL2NvbmZpcm06cGF0aAoJCS8vY29uZmlybTpffHlvdXIgbWVzc2FnZQoJCWNvbmZpcm06IFsKCgkJCS8vcmVwbGFjaW5nICIkY2xpY2s6LnwqY29uZmlybSIsIHdpdGggZHluYW1pYyBiaW5kaW5nLAoJCQkvL3NvIHRoYXQgaXQgY2FuIGJlIGZpeCB0aGUgcHJvYmxlbSBjYXVzZWQgYnkgbWFwRXZlbnQKCQkJLy9hcyBsb25nIGFzIGl0IGlzIHBsYWNlZCBiZWZvcmUgbWFwRXZlbnQgZHluYW1pYyBiaW5kaW5nCgkJCWZ1bmN0aW9uKCBlbGVtLCBwYXRoLCBiaW5kaW5nLCBvcHRpb25zICkgewoJCQkJaG0uc3ViKCBwYXRoLCBlbGVtLCAiY2xpY2siLCAiKmNvbmZpcm0iLCBvcHRpb25zICk7CgkJCX0sCgoJCQlmdW5jdGlvbiggZSApIHsKCgkJCQl2YXIgbWVzc2FnZSA9IGlzVW5kZWZpbmVkKCBlLmhhbmRsZXIub3B0aW9ucyApID8KCQkJCQl0aGlzICYmIHRoaXMucGF0aCAmJiB0aGlzLmdldCAmJiB0aGlzLmdldCgpIHx8IGRlZmF1bHRPcHRpb25zLmNvbmZpcm1NZXNzYWdlIDoKCQkJCQllLmhhbmRsZXIub3B0aW9uczsKCgkJCQlpZiAoIWNvbmZpcm0oIG1lc3NhZ2UgKSkgewoJCQkJCWUuc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uKCk7CgkJCQkJZS5wcmV2ZW50RGVmYXVsdCAmJiBlLnByZXZlbnREZWZhdWx0KCk7CgkJCQl9CgkJCX0KCQldLAoKCQkvLy8tLS0tLS1jaGFuZ2luZyBtb2RlbC0tLS0tLS0tLS0tLQoJCXNldFRvOiBbCgkJCSIkY2xpY2s6Lnwqc2V0VG8iLAoJCQl7CgkJCQlpbml0aWFsaXplOiBmdW5jdGlvbiggcHVibGlzaGVyLCBzdWJzY3JpYmVyLCB3b3JrZmxvd0luc3RhbmNlLCBvcHRpb25zICkgewoJCQkJCXdvcmtmbG93SW5zdGFuY2Uuc2V0VG8gPSB0b1R5cGVkVmFsdWUoIG9wdGlvbnMgKTsKCQkJCX0sCgkJCQlnZXQ6IGZ1bmN0aW9uKCBlICkgewoJCQkJCXRoaXMuc2V0KCBlLmhhbmRsZXIuc2V0VG8gKTsKCQkJCX0KCQkJfQoJCV0sCgoJCSIwIjogWwoJCQkiJGNsaWNrOi58KjAiLAoJCQlmdW5jdGlvbiggLyplKi8gKSB7CgkJCQl0aGlzLnNldCggMCApOwoJCQl9CgkJXSwKCgkJZW1wdHlTdHJpbmc6IFsKCQkJIiRjbGljazoufCplbXB0eSIsCgkJCWZ1bmN0aW9uKCAvKmUqLyApIHsKCQkJCXRoaXMuc2V0KCAiIiApOwoJCQl9CgkJXSwKCgkJIm51bGwiOiBbCgkJCSIkY2xpY2s6LnwqbnVsbCIsCgoJCQlmdW5jdGlvbiggLyplKi8gKSB7CgkJCQl0aGlzLnNldCggbnVsbCApOwoJCQl9CgkJXSwKCgkJInRydWUiOiBbCgoJCQkiJGNsaWNrOi58KnRydWUiLAoKCQkJZnVuY3Rpb24oIC8qZSovICkgewoJCQkJdGhpcy5zZXQoIHRydWUgKTsKCQkJfQoJCV0sCgoJCSIrKyI6IFsKCQkJIiRjbGljazoufCorKyIsCgoJCQlmdW5jdGlvbiggLyplKi8gKSB7CgkJCQl0aGlzLnNldCggdGhpcy5nZXQoKSArIDEgKTsKCQkJfQoJCV0sCgoJCSItLSI6IFsKCQkJIiRjbGljazoufCotLSIsCgkJCWZ1bmN0aW9uKCAvKmUqLyApIHsKCQkJCXRoaXMuc2V0KCB0aGlzLmdldCgpIC0gMSApOwoJCQl9CgkJXSwKCgkJImZhbHNlIjogWwoJCQkiJGNsaWNrOi58KmZhbHNlIiwKCQkJZnVuY3Rpb24oIC8qZSovICkgewoJCQkJdGhpcy5zZXQoIGZhbHNlICk7CgkJCX0KCQldLAoKCQl0b2dnbGU6IFsKCgkJCSIkY2xpY2s6LnwqdG9nZ2xlIiwKCQkJZnVuY3Rpb24oIC8qZSovICkgewoJCQkJdmFyIHN1YnNjcmliZXIgPSB0aGlzOwoJCQkJc3Vic2NyaWJlci5zZXQoICFzdWJzY3JpYmVyLmdldCgpICk7CgkJCX0KCQldLAoKCQlzb3J0SXRlbXM6IFsKCQkJIiRjbGljazoufCpzb3J0SXRlbXMiLAoJCQl7CgkJCQlpbml0aWFsaXplOiBmdW5jdGlvbiggcHVibGlzaGVyLCBzdWJzY3JpYmVyLCB3b3JrZmxvdywgb3B0aW9ucyApIHsKCQkJCQlvcHRpb25zID0gKG9wdGlvbnMgfHwgIiIpICYmIG9wdGlvbnMuc3BsaXQoICIsIiApOwoJCQkJCXdvcmtmbG93LmJ5ID0gb3B0aW9uc1swXTsKCQkJCQkvL2JlY2F1c2Ugb3B0aW9uc1sxXSBkZWZhdWx0IGlzIHVuZGVmaW5lZAoJCQkJCS8vc28gYXNjIGlzIGJ5IGRlZmF1bHQKCQkJCQl3b3JrZmxvdy5hc2MgPSAhIW9wdGlvbnNbMV07CgkJCQl9LAoJCQkJZ2V0OiBmdW5jdGlvbiggZSApIHsKCQkJCQl2YXIgd29ya2Zsb3cgPSBlLmhhbmRsZXI7CgkJCQkJdGhpcy5zb3J0KCB3b3JrZmxvdy5ieSwgd29ya2Zsb3cuYXNjICk7CgkJCQkJd29ya2Zsb3cuYXNjID0gIXdvcmtmbG93LmFzYzsKCQkJCX0KCQkJfQoJCV0sCgoJCWNsZWFyOiBbCgoJCQkiJGNsaWNrOi58KmNsZWFyIiwKCgkJCWZ1bmN0aW9uKCAvKmUqLyApIHsKCQkJCXRoaXMuY2xlYXIoKTsKCQkJfQoJCV0sCgoJCWRlbDogWwoJCQkiJGNsaWNrOi58KmRlbDtjb25maXJtOl98X0RvIHlvdSB3YW50IHRvIGRlbGV0ZSB0aGlzIGl0ZW0/IiwKCgkJCWZ1bmN0aW9uKCAvKmUqLyApIHsKCQkJCXRoaXMuZGVsKCk7CgkJCX0KCQldCgl9ICk7CgoJYmluZGluZ3MoIHsKCgkJY2FwdGlvbjogZnVuY3Rpb24oIGVsZW0sIHBhdGgsIGNvbnRleHQsIG9wdGlvbnMgKSB7CgoJCQkkKCBlbGVtICkucHJlcGVuZCggIjxvcHRpb24gdmFsdWU9Jyc+IiArIChvcHRpb25zIHx8IGhtLmdldCggcGF0aCApIHx8ICIiKSArICI8L29wdGlvbj4iICk7CgkJfSwKCgkJYXV0b2ZvY3VzOiBmdW5jdGlvbiggZWxlbSApIHsKCQkJc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQkkKCBlbGVtICkuZm9jdXMoKTsKCQkJfSwgMSApOwoJCX0sCgoJCW1hcEV2ZW50OiBmdW5jdGlvbiggZWxlbSwgcGF0aCwgY29udGV4dCwgb3B0aW9ucyApIHsKCQkJb3B0aW9ucyA9IG9wdGlvbnMuc3BsaXQoICIsIiApOwoJCQkkKCBlbGVtICkubWFwRXZlbnQoIG9wdGlvbnNbMF0sIG9wdGlvbnNbMV0sIG9wdGlvbnNbMl0gKTsKCgkJfSwKCgkJbWFwQ2xpY2s6IGZ1bmN0aW9uKCBlbGVtLCBwYXRoLCBjb250ZXh0LCBvcHRpb25zICkgewoJCQlvcHRpb25zID0gb3B0aW9ucy5zcGxpdCggIiwiICk7CgkJCSQoIGVsZW0gKS5tYXBFdmVudCggImNsaWNrIiwgb3B0aW9uc1swXSwgb3B0aW9uc1sxXSApOwoJCX0sCgoJCWxvZ1BhbmVsOiBmdW5jdGlvbiggZWxlbSwgcGF0aCwgY29udGV4dCwgb3B0aW9ucyApIHsKCgkJCSQoIGVsZW0gKS5jc3MoICJsaXN0LXN0eWxlLXR5cGUiLCAiZGVjaW1hbCIgKS5jc3MoICJmb250LWZhbWlseSIsICJtb25vc3BhY2UsIHNlcmlmIiApOwoKCQkJY29udGV4dC5hcHBlbmRTdWIoIGVsZW0sICIqbG9nIiwgImluaXQiLCBmdW5jdGlvbiggZSApIHsKCQkJCXZhciBhbGxMb2dzID0gZS5wdWJsaXNoZXIuZ2V0KCk7CgkJCQlmb3IgKHZhciBpID0gMDsgaSA8IGFsbExvZ3MubGVuZ3RoOyBpKyspIHsKCQkJCQl0aGlzLmFwcGVuZCggIjxsaT4iICsgYWxsTG9nc1tpXSArICI8L2xpPiIgKTsKCQkJCX0KCQkJfSApOwoKCQkJY29udGV4dC5hcHBlbmRTdWIoIGVsZW0sICIqbG9nIiwgImFmdGVyQ3JlYXRlLjEiLCBmdW5jdGlvbiggZSApIHsKCQkJCXRoaXMuYXBwZW5kKCAiPGxpPiIgKyBlLm9yaWdpbmFsUHVibGlzaGVyLnJhdygpICsgIjwvbGk+IiApOwoJCQl9ICk7CgoJCQljb250ZXh0LmFwcGVuZFN1YiggZWxlbSwgIipsb2ciLCAiYWZ0ZXJDcmVhdGUiLCBmdW5jdGlvbiggZSApIHsKCQkJCXRoaXMuZW1wdHkoKTsKCQkJfSApOwoJCX0sCgoJCWNsZWFybG9nOiAiY2xlYXI6Lypsb2ciLAoKCQkvL2RhdGEtc3ViPSJlbmFibGVMYXRlcjpwYXRoIgoJCWVuYWJsZUxhdGVyOiAiIWFmdGVyKjoufCplbmFibGUiLAoKCQkvL2RhdGEtc3ViPSJkaXNhYmxlTGF0ZXI6cGF0aCIKCQlkaXNhYmxlTGF0ZXI6ICIhYWZ0ZXIqOi58KmRpc2FibGUiLAoKCQkvL2RhdGEtc3ViPSJodG1sOnBhdGgiCgkJaHRtbDogIiFpbml0IGFmdGVyKjoufGdldCBodG1sICp0b1N0cmluZyIsCgoJCS8vZGF0YS1zdWI9InRleHQ6cGF0aCIKCQl0ZXh0OiAiIWluaXQgYWZ0ZXIqOi58Z2V0IHRleHQgKnRvU3RyaW5nIiwKCgkJcmVtb3ZlSWZEZWw6ICIhZHVyaW5nRGVsOi58KmZha2VHZXQgcmVtb3ZlIiwKCgkJZW1wdHlJZkRlbDogIiFkdXJpbmdEZWw6LnwqZmFrZUdldCBlbXB0eSIKCgl9ICk7CgoJaG0ubmV3SnFFdmVudCggewoKCQllbnRlcjogWyJrZXl1cCIsIGZ1bmN0aW9uKCBlICkgewoJCQlyZXR1cm4gKGUua2V5Q29kZSA9PT0gMTMpOwoJCX1dLAoKCQllc2M6IFsia2V5dXAiLCBmdW5jdGlvbiggZSApIHsKCQkJcmV0dXJuIChlLmtleUNvZGUgPT09IDI3KTsKCQl9XSwKCgkJY3RybGNsaWNrOiBbImNsaWNrIiwgZnVuY3Rpb24oIGUgKSB7CgkJCXJldHVybiBlLmN0cmxLZXk7CgkJfV0KCX0gKTsKCgoKLy8KLyoKIDxAZGVwZW5kcz4KIHN1YnNjcmlwdGlvbi5qcywKIG1vZGVsLmpzCiA8L0BkZXBlbmRzPgogKi8KCgoJdmFyIG1ldGhvZE1hcCA9IHsKCQkiY3JlYXRlIjogIlBPU1QiLAoJCSJ1cGRhdGUiOiAiUFVUIiwKCQkiZGVzdHJveSI6ICJERUxFVEUiLAoJCSJmZXRjaCI6ICJHRVQiCgl9OwoKCXZhciBlbnRpdHlTdGF0ZSA9IHsKCQlkZXRhY2hlZDogMCwKCQl1bmNoYW5nZWQ6IDEsCgkJYWRkZWQ6IDMsCgkJZGVsZXRlZDogNCwKCQltb2RpZmllZDogNQoJfTsKCglmdW5jdGlvbiBtYXJrTW9kaWZpZWQgKCBlICkgewoKCQl2YXIgYmFzZVBhdGggPSB0aGlzLnBhdGg7IC8vaXRlbXMKCQl2YXIgb3JpZ2luYWxQYXRoID0gZS5vcmlnaW5hbFB1Ymxpc2hlci5wYXRoOyAvL2l0ZW1zLjEuZmlyc3ROYW1lCgkJdmFyIGRpZmZQYXRoID0gb3JpZ2luYWxQYXRoLnN1YnN0ciggYmFzZVBhdGgubGVuZ3RoICsgMSApOyAvLzEuZmlyc3ROYW1lCgkJdmFyIGRvdEluZGV4ID0gZGlmZlBhdGguaW5kZXhPZiggIi4iICk7CgkJdmFyIGVudGl0eVBhdGggPSBiYXNlUGF0aCArICIuIiArIGRpZmZQYXRoLnN1YnN0ciggMCwgZG90SW5kZXggKTsgLy9pdGVtcy4xCgkJdmFyIHN0YXRlUGF0aCA9IGVudGl0eVBhdGggKyAiLl9fc3RhdGUiOyAvL2l0ZW1zLjEuX19zdGF0ZQoKCQlpZiAob3JpZ2luYWxQYXRoICE9PSBzdGF0ZVBhdGggJiYKCQkgICAgaG0uZ2V0KCBzdGF0ZVBhdGggKSA9PSBlbnRpdHlTdGF0ZS51bmNoYW5nZWQpIHsKCQkJLy91c2Ugc2V0IG1ldGhvZCBpcyBkZWxpYmVyYXRlLCBiZWNhdXNlIHdlIHdhbnQKCQkJLy90byByYWlzZSBldmVudAoJCQlobS5zZXQoIHN0YXRlUGF0aCwgZW50aXR5U3RhdGUubW9kaWZpZWQgKTsKCQl9Cgl9CgoJaG0ub25BZGRPclVwZGF0ZU5vZGUoIGZ1bmN0aW9uKCBjb250ZXh0LCBpbmRleCwgdmFsdWUgKSB7CgkJaWYgKHZhbHVlIGluc3RhbmNlb2YgaG0uRW50aXR5KSB7CgoJCQlpZiAodmFsdWUuX19zdGF0ZSA9PT0gZW50aXR5U3RhdGUuZGV0YWNoZWQpIHsKCQkJCXZhbHVlLl9fc3RhdGUgPSBlbnRpdHlTdGF0ZS5hZGRlZDsKCQkJfQoKCQkJaWYgKGlzVW5kZWZpbmVkKCBobSggY29udGV4dCApLmdldCggIl9fZW50aXR5Q29udGFpbmVyIiApICkpIHsKCQkJCWhtLnN1YiggY29udGV4dCwgY29udGV4dCwgImFmdGVyVXBkYXRlLioiLCBtYXJrTW9kaWZpZWQgKTsKCQkJCWhtKCBjb250ZXh0ICkuc2V0KCAiX19lbnRpdHlDb250YWluZXIiLCB0cnVlICk7CgkJCX0KCQl9Cgl9ICk7CgoJZnVuY3Rpb24gY2FsbFN0YXRpY0FqYXhNZXRob2QgKCBub2RlLCBtZXRob2ROYW1lICkgewoJCXZhciBlbnRpdHkgPSBub2RlLmdldCgpOwoKCQlyZXR1cm4gZW50aXR5LmNvbnN0cnVjdG9yW21ldGhvZE5hbWVdKCBlbnRpdHkgKS5kb25lKCBmdW5jdGlvbiggZGF0YSApIHsKCgkJCW5vZGUuc2V0KAoKCQkJCSJfX3N0YXRlIiwKCgkJCQltZXRob2ROYW1lID09ICJkZXN0cm95IiA/CgkJCQkJZW50aXR5U3RhdGUuZGV0YWNoZWQgOgoJCQkJCWVudGl0eVN0YXRlLnVuY2hhbmdlZAoJCQkpOwoKCQkJbm9kZS50cmlnZ2VyKCAiYWZ0ZXJTeW5jLiIgKyBtZXRob2ROYW1lICk7CgkJfSApOwoJfQoKCS8vdGhlIHJlYXNvbiB0aGF0IHdlIGRvbid0IGltcGxlbWVudCBhamF4IGluIHRoZSBpbnN0YW5jZSBtZXRob2QgaXMgdGhhdCwgd2Ugd2FudCB0bwoJLy9zdXBwb3J0IHRoZSBjYWxsIGZyb20gcmVwb3NpdG9yeSBub2RlLCBzdWNoIG5vZGUuc2V0KCJjcmVhdGUiKSwgbm9kZS5zZXQoInVwZGF0ZSIpLi4KCS8vd2Ugd2FudCB0byBkZWxlZ2F0ZSB0aGlzIGNhbGwgdGhlIHN0YXRpYyBtZXRob2QKCWhtLkVudGl0eSA9IGhtLkNsYXNzLmV4dGVuZCgKCQkvL2luc3RhbmNlIG1ldGhvZCwgd2hpY2ggaXMgaW52b2tlZCBieSBub2RlLmdldCBtZXRob2QKCQkvL29yIGl0IGNhbiBiZSBpbnZva2VkIHRoZSBvYmplY3QgZGlyZWN0bHkKCQl7CgkJCS8vdGhpcyBzdGF0ZSBpcyBtZWFuaW5nZnVsIG9ubHkgd2hlbiBpdCBlbnRpdHkgaXMgaW5zaWRlIG9mIHJlcG9zaXRvcnkKCQkJX19zdGF0ZTogZW50aXR5U3RhdGUuZGV0YWNoZWQsCgoJCQljcmVhdGU6IGZ1bmN0aW9uIF9fICgpIHsKCQkJCWlmICh0aGlzIGluc3RhbmNlb2YgaG0pIHsKCQkJCQlpZiAodGhpcy5nZXQoICJfX3N0YXRlIiApID09IGVudGl0eVN0YXRlLmFkZGVkKSB7CgkJCQkJCXJldHVybiBjYWxsU3RhdGljQWpheE1ldGhvZCggdGhpcywgImNyZWF0ZSIgKTsKCQkJCQl9CgkJCQkJdGhyb3cgImVudGl0eSBpcyBub3QgYSBuZXcgaXRlbSI7CgoJCQkJfSBlbHNlIHsKCQkJCQkvLyBkb24ndCB1c2UgRW50aXR5LmNyZWF0ZSh0aGlzKSwgYmVjYXVzZQoJCQkJCS8vIHRoaXMuY29uc3RydWN0b3IgaXMgbm90IG5lY2Vzc2FyeSBFbnRpdHkKCQkJCQlyZXR1cm4gdGhpcy5jb25zdHJ1Y3Rvci5jcmVhdGUoIHRoaXMgKTsKCgkJCQl9CgkJCX0sCgoJCQlmZXRjaDogZnVuY3Rpb24gX18gKCkgewoJCQkJcmV0dXJuIHRoaXMgaW5zdGFuY2VvZiBobSA/IGNhbGxTdGF0aWNBamF4TWV0aG9kKCB0aGlzLCAiZmV0Y2giICkgOgoJCQkJCXRoaXMuY29uc3RydWN0b3IuZmV0Y2goIHRoaXMgKTsKCQkJfSwKCgkJCXVwZGF0ZTogZnVuY3Rpb24gX18gKCkgewoKCQkJCWlmICh0aGlzIGluc3RhbmNlb2YgaG0pIHsKCQkJCQlpZiAodGhpcy5nZXQoICJfX3N0YXRlIiApID09IGVudGl0eVN0YXRlLm1vZGlmaWVkKSB7CgkJCQkJCXJldHVybiBjYWxsU3RhdGljQWpheE1ldGhvZCggdGhpcywgInVwZGF0ZSIgKTsKCQkJCQl9CgkJCQl9IGVsc2UgewoJCQkJCXJldHVybiB0aGlzLmNvbnN0cnVjdG9yLnVwZGF0ZSggdGhpcyApOwoJCQkJfQoJCQl9LAoKCQkJZGVzdHJveTogZnVuY3Rpb24gX18gKCkgewoJCQkJaWYgKHRoaXMgaW5zdGFuY2VvZiBobSkgewoJCQkJCXZhciBub2RlID0gdGhpczsKCQkJCQlyZXR1cm4gY2FsbFN0YXRpY0FqYXhNZXRob2QoIHRoaXMsICJkZXN0cm95IiApLmRvbmUoIGZ1bmN0aW9uKCkgewoJCQkJCQlub2RlLmRlbCgpOwoJCQkJCX0gKTsKCQkJCX0gZWxzZSB7CgkJCQkJcmV0dXJuIHRoaXMuY29uc3RydWN0b3IuZGVzdHJveSggdGhpcyApOwoJCQkJfQoJCQl9LAoKCQkJc2F2ZTogZnVuY3Rpb24gX18gKCkgewoJCQkJaWYgKHRoaXMgaW5zdGFuY2VvZiBobSkgewoKCQkJCQl2YXIgc3RhdGUgPSB0aGlzLmdldCggIl9fc3RhdGUiICk7CgkJCQkJaWYgKHN0YXRlID09IGVudGl0eVN0YXRlLmFkZGVkKSB7CgoJCQkJCQlyZXR1cm4gdGhpcy5nZXQoICJjcmVhdGUiICk7CgoJCQkJCX0gZWxzZSBpZiAoc3RhdGUgPT0gZW50aXR5U3RhdGUubW9kaWZpZWQpIHsKCgkJCQkJCXJldHVybiB0aGlzLmdldCggInVwZGF0ZSIgKTsKCQkJCQl9CgoJCQkJfSBlbHNlIHsKCgkJCQkJdGhyb3cgIm5vdCBzdXBwb3J0ZWQiOwoJCQkJfQoKCQkJfQoKCQl9LAoKCQkvL3N0YXRpYyBtZXRob2QsIHdoaWNoIGtub3dzIG5vdGhpbmcgYWJvdXQgcmVwb3NpdG9yeQoJCXsKCQkJc3RhdGU6IGVudGl0eVN0YXRlLAoKCQkJY3JlYXRlOiBmdW5jdGlvbiggaW5zdGFuY2UgKSB7CgkJCQlyZXR1cm4gdGhpcy5hamF4KCAiY3JlYXRlIiwgaW5zdGFuY2UgKTsKCQkJfSwKCgkJCXVwZGF0ZTogZnVuY3Rpb24oIGluc3RhbmNlICkgewoJCQkJcmV0dXJuIHRoaXMuYWpheCggInVwZGF0ZSIsIGluc3RhbmNlICk7CgkJCX0sCgkJCWRlc3Ryb3k6IGZ1bmN0aW9uKCBpbnN0YW5jZSApIHsKCQkJCXJldHVybiB0aGlzLmFqYXgoICJkZXN0cm95IiwgaW5zdGFuY2UgKTsKCQkJfSwKCgkJCWZldGNoOiBmdW5jdGlvbiggaW5zdGFuY2UgKSB7CgkJCQlpZiAoaW5zdGFuY2UpIHsKCQkJCQlyZXR1cm4gdGhpcy5hamF4KCAiZmV0Y2giLCBpbnN0YW5jZSApOwoJCQkJfSBlbHNlIHsKCQkJCQl2YXIgQ29uc3RydWN0b3IgPSB0aGlzOwoJCQkJCS8vdGhlIHBpcGUgbWV0aG9kIGlzIHVzZWQgdG8gY29udmVydCBhbiBhcnJheSBvZgoJCQkJCS8vIGdlbmVyaWMgb2JqZWN0IGludG8gYW4gYXJyYXkgb2Ygb2JqZWN0IG9mIHRoZSBzYW1lICJDbGFzcyIKCQkJCQlyZXR1cm4gdGhpcy5hamF4KCAiZmV0Y2giICkucGlwZSggZnVuY3Rpb24oIGRhdGEgKSB7CgkJCQkJCXJldHVybiAkKCBDb25zdHJ1Y3Rvci5saXN0KCBkYXRhICkgKS5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJCQkJdGhpcy5fX3N0YXRlID0gZW50aXR5U3RhdGUudW5jaGFuZ2VkOwoJCQkJCQl9ICkuZ2V0KCk7CgkJCQkJfSApOwoKCQkJCX0KCQkJfSwKCgkJCWdldFVybDogZnVuY3Rpb24oIG1ldGhvZE5hbWUsIGluc3RhbmNlICkgewoJCQkJdmFyIGJhc2VVcmwgPSB0aGlzLnVybCB8fCBpbnN0YW5jZS51cmwsCgkJCQkJaWQgPSBpbnN0YW5jZSAmJiBpbnN0YW5jZS5pZDsKCgkJCQlyZXR1cm4gaWQgPyBiYXNlVXJsICsgKGJhc2VVcmwuY2hhckF0KCBiYXNlVXJsLmxlbmd0aCAtIDEgKSA9PT0gJy8nID8gJycgOiAnLycpICsgZW5jb2RlVVJJQ29tcG9uZW50KCBpZCApIDoKCQkJCQliYXNlVXJsOwoJCQl9LAoKCQkJYWpheDogZnVuY3Rpb24oIG1ldGhvZE5hbWUsIGluc3RhbmNlICkgewoJCQkJdmFyIG1ldGhvZCA9IG1ldGhvZE1hcFttZXRob2ROYW1lXTsKCgkJCQl2YXIgYWpheE9wdGlvbnMgPSB7CgkJCQkJdHlwZTogbWV0aG9kLAoJCQkJCWRhdGFUeXBlOiAnanNvbicsCgkJCQkJdXJsOiB0aGlzLmdldFVybCggbWV0aG9kTmFtZSwgaW5zdGFuY2UgKSwKCQkJCQljb250ZW50VHlwZTogbWV0aG9kID09ICJHRVQiID8gbnVsbCA6ICJhcHBsaWNhdGlvbi9qc29uIiwKCQkJCQlwcm9jZXNzRGF0YTogZmFsc2UsCgkJCQkJZGF0YTogbWV0aG9kID09ICJHRVQiID8gbnVsbCA6IEpTT04uc3RyaW5naWZ5KCBpbnN0YW5jZSApCgkJCQl9OwoKCQkJCXJldHVybiAkLmFqYXgoIGFqYXhPcHRpb25zICkuZG9uZSggZnVuY3Rpb24oIHJlc3BvbnNlICkgewoJCQkJCWluc3RhbmNlICYmIGV4dGVuZCggaW5zdGFuY2UsIHJlc3BvbnNlICk7CgkJCQl9ICk7CgkJCX0KCQl9ICk7CgoJZXh0ZW5kKCBobUZuLCB7CgoJCS8vbm9kZSBmdW5jdGlvbiB3aGljaCBicmlkZ2V0IHRoZSBobSBtZXRob2QgdG8gdGhlIHN0YXRpYyBtZXRob2Qgb2YgbW9kZWwKCQkvL3N1YlBhdGggaXMgb3B0aW9uYWwKCQkvL21ldGhvZCBpcyByZXF1aXJlZCBjcmVhdGUvcmVhZC91cGRhdGUvZGVsCgkJLy9lLmcgbm9kZS5zeW5jKCJjcmVhdGUiKTsKCQlzYXZlOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHRoaXMuZ2V0KCAic2F2ZSIgKTsKCQl9LAoKCQlkZXN0cm95OiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHRoaXMuZ2V0KCAiZGVzdHJveSIgKTsKCQl9LAoKCQlmZXRjaDogZnVuY3Rpb24oKSB7CgkJCXJldHVybiB0aGlzLmdldCggImZldGNoIiApOwoJCX0KCX0gKTsKCi8vCi8vPEBkZXBlbmRzPnN1YnNjcmlwdGlvbi5qcywgbW9kZWwuanMsIGRlY2xhcmF0aXZlLmpzLCB0ZW1wbGF0ZS5qczwvQGRlcGVuZHM+CgoKCWRlZmF1bHRPcHRpb25zLmVycm9ycyA9IHsKCQlkZWZhdWx0RXJyb3I6ICJQbGVhc2UgZW50ZXIgYSB2YWxpZCB2YWx1ZSIKCX07CgoJdmFyIGFmdGVyVXBkYXRlQW5kQ2hlY2tWYWxpZGl0eSA9ICJhZnRlclVwZGF0ZSogY2hlY2tWYWxpZGl0eSIsCgkJaW52YWxpZFBhdGhzID0gc2hhZG93Um9vdC5pbnZhbGlkUGF0aHMgPSBbXSwKCQlpbnZhbGlkUGF0aHNNb2RlbCA9IGhtKCAiKmludmFsaWRQYXRocyIgKSwKCQlyRW1wdHkgPSAvXlxzKiQvLAoJCXJFbWFpbCA9IC9eKCgoW2Etel18XGR8WyEjXCQlJidcKlwrXC1cLz1cP1xeX2B7XHx9fl18W1x1MDBBMC1cdUQ3RkZcdUY5MDAtXHVGRENGXHVGREYwLVx1RkZFRl0pKyhcLihbYS16XXxcZHxbISNcJCUmJ1wqXCtcLVwvPVw/XF5fYHtcfH1+XXxbXHUwMEEwLVx1RDdGRlx1RjkwMC1cdUZEQ0ZcdUZERjAtXHVGRkVGXSkrKSopfCgoXHgyMikoKCgoXHgyMHxceDA5KSooXHgwZFx4MGEpKT8oXHgyMHxceDA5KSspPygoW1x4MDEtXHgwOFx4MGJceDBjXHgwZS1ceDFmXHg3Zl18XHgyMXxbXHgyMy1ceDViXXxbXHg1ZC1ceDdlXXxbXHUwMEEwLVx1RDdGRlx1RjkwMC1cdUZEQ0ZcdUZERjAtXHVGRkVGXSl8KFxcKFtceDAxLVx4MDlceDBiXHgwY1x4MGQtXHg3Zl18W1x1MDBBMC1cdUQ3RkZcdUY5MDAtXHVGRENGXHVGREYwLVx1RkZFRl0pKSkpKigoKFx4MjB8XHgwOSkqKFx4MGRceDBhKSk/KFx4MjB8XHgwOSkrKT8oXHgyMikpKUAoKChbYS16XXxcZHxbXHUwMEEwLVx1RDdGRlx1RjkwMC1cdUZEQ0ZcdUZERjAtXHVGRkVGXSl8KChbYS16XXxcZHxbXHUwMEEwLVx1RDdGRlx1RjkwMC1cdUZEQ0ZcdUZERjAtXHVGRkVGXSkoW2Etel18XGR8LXxcLnxffH58W1x1MDBBMC1cdUQ3RkZcdUY5MDAtXHVGRENGXHVGREYwLVx1RkZFRl0pKihbYS16XXxcZHxbXHUwMEEwLVx1RDdGRlx1RjkwMC1cdUZEQ0ZcdUZERjAtXHVGRkVGXSkpKVwuKSsoKFthLXpdfFtcdTAwQTAtXHVEN0ZGXHVGOTAwLVx1RkRDRlx1RkRGMC1cdUZGRUZdKXwoKFthLXpdfFtcdTAwQTAtXHVEN0ZGXHVGOTAwLVx1RkRDRlx1RkRGMC1cdUZGRUZdKShbYS16XXxcZHwtfFwufF98fnxbXHUwMEEwLVx1RDdGRlx1RjkwMC1cdUZEQ0ZcdUZERjAtXHVGRkVGXSkqKFthLXpdfFtcdTAwQTAtXHVEN0ZGXHVGOTAwLVx1RkRDRlx1RkRGMC1cdUZGRUZdKSkpXC4/JC9pLAoJCXJVcmwgPSAvXihodHRwcz98ZnRwKTpcL1wvKCgoKFthLXpdfFxkfC18XC58X3x+fFtcdTAwQTAtXHVEN0ZGXHVGOTAwLVx1RkRDRlx1RkRGMC1cdUZGRUZdKXwoJVtcZGEtZl17Mn0pfFshXCQmJ1woXClcKlwrLDs9XXw6KSpAKT8oKChcZHxbMS05XVxkfDFcZFxkfDJbMC00XVxkfDI1WzAtNV0pXC4oXGR8WzEtOV1cZHwxXGRcZHwyWzAtNF1cZHwyNVswLTVdKVwuKFxkfFsxLTldXGR8MVxkXGR8MlswLTRdXGR8MjVbMC01XSlcLihcZHxbMS05XVxkfDFcZFxkfDJbMC00XVxkfDI1WzAtNV0pKXwoKChbYS16XXxcZHxbXHUwMEEwLVx1RDdGRlx1RjkwMC1cdUZEQ0ZcdUZERjAtXHVGRkVGXSl8KChbYS16XXxcZHxbXHUwMEEwLVx1RDdGRlx1RjkwMC1cdUZEQ0ZcdUZERjAtXHVGRkVGXSkoW2Etel18XGR8LXxcLnxffH58W1x1MDBBMC1cdUQ3RkZcdUY5MDAtXHVGRENGXHVGREYwLVx1RkZFRl0pKihbYS16XXxcZHxbXHUwMEEwLVx1RDdGRlx1RjkwMC1cdUZEQ0ZcdUZERjAtXHVGRkVGXSkpKVwuKSsoKFthLXpdfFtcdTAwQTAtXHVEN0ZGXHVGOTAwLVx1RkRDRlx1RkRGMC1cdUZGRUZdKXwoKFthLXpdfFtcdTAwQTAtXHVEN0ZGXHVGOTAwLVx1RkRDRlx1RkRGMC1cdUZGRUZdKShbYS16XXxcZHwtfFwufF98fnxbXHUwMEEwLVx1RDdGRlx1RjkwMC1cdUZEQ0ZcdUZERjAtXHVGRkVGXSkqKFthLXpdfFtcdTAwQTAtXHVEN0ZGXHVGOTAwLVx1RkRDRlx1RkRGMC1cdUZGRUZdKSkpXC4/KSg6XGQqKT8pKFwvKCgoW2Etel18XGR8LXxcLnxffH58W1x1MDBBMC1cdUQ3RkZcdUY5MDAtXHVGRENGXHVGREYwLVx1RkZFRl0pfCglW1xkYS1mXXsyfSl8WyFcJCYnXChcKVwqXCssOz1dfDp8QCkrKFwvKChbYS16XXxcZHwtfFwufF98fnxbXHUwMEEwLVx1RDdGRlx1RjkwMC1cdUZEQ0ZcdUZERjAtXHVGRkVGXSl8KCVbXGRhLWZdezJ9KXxbIVwkJidcKFwpXCpcKyw7PV18OnxAKSopKik/KT8oXD8oKChbYS16XXxcZHwtfFwufF98fnxbXHUwMEEwLVx1RDdGRlx1RjkwMC1cdUZEQ0ZcdUZERjAtXHVGRkVGXSl8KCVbXGRhLWZdezJ9KXxbIVwkJidcKFwpXCpcKyw7PV18OnxAKXxbXHVFMDAwLVx1RjhGRl18XC98XD8pKik/KFwjKCgoW2Etel18XGR8LXxcLnxffH58W1x1MDBBMC1cdUQ3RkZcdUY5MDAtXHVGRENGXHVGREYwLVx1RkZFRl0pfCglW1xkYS1mXXsyfSl8WyFcJCYnXChcKVwqXCssOz1dfDp8QCl8XC98XD8pKik/JC9pLAoJCXJEYXRlSVNPID0gL15cZHs0fVtcL1wtXVxkezEsMn1bXC9cLV1cZHsxLDJ9JC8sCgkJck51bWJlciA9IC9eLT8oPzpcZCt8XGR7MSwzfSg/OixcZHszfSkrKSg/OlwuXGQrKT8kLywKCQlyRGlnaXQgPSAvXlxkKyQvLAoJCXJJbnZhbGlkRGF0ZSA9IC9JbnZhbGlkfE5hTi8sCgkJclJlZ0V4ID0gL14oXC8oXFxbXlx4MDAtXHgxZl18XFsoXFxbXlx4MDAtXHgxZl18W15ceDAwLVx4MWZcXFwvXSkqXF18W15ceDAwLVx4MWZcXFwvXFtdKStcL1tnaW1dKikoLCguKikpKiQvLAoJCXJGaXJzdFRva2VuID0gLyhbXixdKykoLCguKikpPy8sCgkJckZpcnN0VHdvVG9rZW4gPSAvKFx3KyksKFx3KykoLCguKikpPy87CgoJLyoJdGhpcyBtZXRob2QgaXMgdG8gY3JlYXRlIGEgc3Vic2NyaXB0aW9uIGdyb3VwIGFuZAoJIHdvcmtmbG93IHR5cGUgdXNpbmcgdGhlIG5hbWUgb2YgdmFsaWRhdG9yCgkgYW5kIGFsc28gYWRkIGEgY2xhc3MgcnVsZSB1c2luZyB0aGUgbmFtZSBvZiB2YWxpZGF0b3IKCSBzbyBtYWtlIHN1cmUgdGhlIG5hbWUgb2YgdmFsaWRhdG9yIGRvIG5vdCBjb2xsaWRlIHdpdGggb3RoZXIgdmFsaWRhdG9yCgoJIGEgdmFsaWRhdG9yIGlzIG9iamVjdCBsaWtlCgkgewoJIG5hbWU6ICJ2YWxpZGF0b3JOYW1lIiwKCSBlcnJvcjogImVycm9yIG1lc3NhZ2UiCgkgaXNWYWxpZDogZnVuY3Rpb24oIHZhbHVlLCBvcHRpb25zICk7IC8vIG9wdGlvbnMgbGV0IHVzZXIgdG8gaGVscCB0aGUgaXNWYWxpZCB0byB3b3JrIGJldHRlcgoJIGluaXRpYWxpemU6IGZ1bmN0aW9uKG9wdGlvbnMpOyAvL2FsbG93IHVzZXIgY29udmVydCBzdHJpbmcgdmFsdWUgb2YgbW9kZWxFdmVudC5vcHRpb25zIHRvIHRoZSBvcHRpb25zIHBhc3NlZCBpbiBpc1ZhbGlkIGZ1bmN0aW9uCgkgYnVpbGRFcnJvcjogZnVuY3Rpb24oZGVmYXVsdE1lc3NhZ2UsIG9wdGlvbnMgKQoJIH0KCSAqLwoJaG0udmFsaWRhdG9yID0gZnVuY3Rpb24oIHZhbGlkYXRvciApIHsKCgkJaWYgKGlzQXJyYXkoIHZhbGlkYXRvciApKSB7CgkJCWZvciAodmFyIGkgPSAwOyBpIDwgdmFsaWRhdG9yLmxlbmd0aDsgaSsrKSB7CgkJCQlobS52YWxpZGF0b3IoIHZhbGlkYXRvcltpXSApOwoJCQl9CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJdmFyIHZhbGlkYXRvck5hbWUgPSB2YWxpZGF0b3IubmFtZTsKCgkJaWYgKGhtLndvcmtmbG93KCB2YWxpZGF0b3JOYW1lICkpIHsKCQkJdGhyb3cgInZhbGlkYXRvciBuYW1lICciICsgdmFsaWRhdG9yTmFtZSArICInIGNvbGxpZGUgd2l0aCBuYW1lIGluIGhtLndvcmtmbG93VHlwZXMiOwoJCX0KCgkJLy9hZGQgZGVmYXVsdCBlcnJvciBpZiBhcHBsaWNhYmxlCgkJLy91c2VyIGNhbiBsb2NhbGl6ZSBlcnJvcnMgbWVzc2FnZQoJCWlmICh2YWxpZGF0b3IuZXJyb3IpIHsKCQkJZGVmYXVsdE9wdGlvbnMuZXJyb3JzW3ZhbGlkYXRvck5hbWVdID0gdmFsaWRhdG9yLmVycm9yOwoJCX0KCgkJaWYgKHZhbGlkYXRvci5pc1ZhbGlkIGluc3RhbmNlb2YgUmVnRXhwKSB7CgkJCXZhbGlkYXRvci5pc1ZhbGlkID0gYnVpbGRSZWdleEZuKCB2YWxpZGF0b3IuaXNWYWxpZCApOwoJCX0KCgkJdmFyIHdvcmtmbG93VHlwZU5hbWUgPSAidl8iICsgdmFsaWRhdG9yTmFtZTsKCQlobS53b3JrZmxvdyggd29ya2Zsb3dUeXBlTmFtZSwgYnVpbGRWYWxpZGF0aW9uV29ya2Zsb3dUeXBlKCB2YWxpZGF0b3IgKSApOwoKCQkvL2RhdGEtc3ViPSJyZXF1aXJlZDpwYXRoIiBvciBkYXRhLXN1Yj0icmVxdWlyZWQ6cGF0aHxvcHRpb25zIgoJCWJpbmRpbmdzKCB2YWxpZGF0b3JOYW1lLCAiIWFmdGVyVXBkYXRlIGNoZWNrVmFsaWRpdHk6LnwqIiArIHdvcmtmbG93VHlwZU5hbWUgKTsKCgl9OwoKCWhtLndvcmtmbG93KCB7CgkJY2hlY2tWYWxpZGl0eTogZnVuY3Rpb24oIGUgKSB7CgkJCWlmICghaG0uY2hlY2tWYWxpZGl0eSggdGhpcy5wYXRoICkpIHsKCQkJCS8vYmVjYXVzZSBpdCBpcyB0aGUgZmlyc3QgaGFuZGxlciwgZS5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24gd2lsbAoJCQkJLy9zdG9wIHByb2Nlc3MgYWxsIG90aGVyIGhhbmRsZXIKCQkJCWUuc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uKCk7CgkJCX0KCQl9LAoKCQkvLyB1c2UgYnkgZ3JvdXAKCQkvLyB3YXJuOiAiIWFmdGVyKjoqZXJyb3JzfCp3YXJuIiwKCQl3YXJuOiBmdW5jdGlvbiggZSApIHsKCQkJLy9lLnB1Ymxpc2hlciBwb2ludHMgdG8gIm1vZGVsKmVycm9ycyIKCQkJaWYgKGUucHVibGlzaGVyLmlzRW1wdHkoKSkgewoKCQkJCXRoaXMKCQkJCQkucmVtb3ZlQ2xhc3MoICJlcnJvciIgKQoJCQkJCS5uZXh0KCAic3Bhbi5lcnJvciIgKQoJCQkJCS5yZW1vdmUoKTsKCgkJCX0gZWxzZSB7CgoJCQkJdGhpcwoJCQkJCS5hZGRDbGFzcyggImVycm9yIiApCgkJCQkJLm5leHQoICJzcGFuLmVycm9yIiApCgkJCQkJLnJlbW92ZSgpCgkJCQkJLmVuZCgpCgkJCQkJLmFmdGVyKCAiPHNwYW4gY2xhc3M9J2Vycm9yJz4iICsgZS5wdWJsaXNoZXIuZ2V0KCkgKyAiPC9zcGFuPiIgKTsKCQkJfQoJCX0sCgoJCWhpZ2hsaWdodEVycm9yOiBmdW5jdGlvbiggZSApIHsKCQkJdGhpc1tlLnB1Ymxpc2hlci5pc0VtcHR5KCkgPyAicmVtb3ZlQ2xhc3MiIDogImFkZENsYXNzIl0oICJlcnJvciIgKTsKCgkJfSwKCgkJcmVuZGVyRXJyb3JTdW1tYXJ5OiBobS50ZW1wbGF0ZS5uZXdUZW1wbGF0ZUhhbmRsZXIoCgkJCWZ1bmN0aW9uKCBlICkgewoJCQkJcmV0dXJuIFtlLnB1Ymxpc2hlci5nZXRFcnJvcnMoKV07CgkJCX0KCQkpCgl9ICk7CgoJYmluZGluZ3MoIHsKCgkJdmFsaWRhdG9yOiBmdW5jdGlvbiggZWxlbSwgcGF0aCwgY29udGV4dCwgb3B0aW9ucyApIHsKCQkJaWYgKCFvcHRpb25zKSB7CgkJCQl0aHJvdyAibWlzc2luZyB2YWxpZGF0b3IgcGF0aCI7CgkJCX0KCQkJaWYgKCFvcHRpb25zLnN0YXJ0c1dpdGgoICIjIiApKSB7CgkJCQlvcHRpb25zID0gIiMiICsgb3B0aW9uczsKCQkJfQoJCQlobSggcGF0aCApLnZhbGlkYXRvciggb3B0aW9ucyApOwoJCX0sCgoJCS8vYWRkIGEgY2xpY2sgaGFuZGxlciB0byBlbGVtZW50IHRvIGNoZWNrVmFsaWRpdHkKCQljaGVja1ZhbGlkaXR5OiBmdW5jdGlvbiggZWxlbSwgcGF0aCwgY29udGV4dCwgb3B0aW9ucyApIHsKCQkJLy9wcmVwZW5kIHRvIHRvIHN1YnNjcmlwdGlvbnMgYXJyYXkKCQkJLy9zbyB0aGF0IGl0IGlzIHRoZSBmaXJzdCBzdWJzY3JpcHRpb25zLCBhbmQgaXQgd2lsbCBiZSBldmFsdWF0ZWQgZmlyc3QKCQkJY29udGV4dC5wcmVwZW5kU3ViKCBwYXRoLCBlbGVtLCAiY2xpY2siLCAiKmNoZWNrVmFsaWRpdHkiICk7CgkJfSwKCgkJcmVzZXRWYWxpZGl0eTogIiRjbGljazoufCpmYWtlR2V0IHJlc2V0VmFsaWRpdHkiLAoKCQl3YXJuOiAiIWFmdGVyKjoqZXJyb3JzfCp3YXJuIiwKCgkJImhpZ2hsaWdodEVycm9yIjogIiFhZnRlcio6KmVycm9yc3wqaGlnaGxpZ2h0RXJyb3IiLAoKCQl3YXJuU3VtbWFyeTogIiFhZnRlclVwZGF0ZSogdmFsaWRpdHlDaGVja2VkOi58KnJlbmRlckVycm9yU3VtbWFyeTshdmFsaWRpdHlSZXNldDoufGVtcHR5IgoKCX0gKTsKCgliaW5kaW5ncyggImZvcm0iLCBmdW5jdGlvbiggZWxlbSwgcGF0aCwgY29udGV4dCwgb3B0aW9ucyApIHsKCQljb250ZXh0LmFwcGVuZFN1YiggcGF0aCwgZWxlbSwgInJlc2V0IiwgIipmYWtlR2V0IHJlc2V0VmFsaWRpdHkiICk7Cgl9LCB0cnVlICk7CgoJZnVuY3Rpb24gaXNQYXRoVmFsaWQoIHBhdGggKSB7CgoJCWlmIChwYXRoID09PSAiIikgewoJCQlyZXR1cm4gIWludmFsaWRQYXRocy5sZW5ndGg7CgkJfQoKCQl2YXIgcHJlZml4ID0gcGF0aCArICIuIjsKCgkJZm9yICh2YXIgaSA9IDAsIGludmFsaWRQYXRoLCBsZW5ndGggPSBpbnZhbGlkUGF0aHMubGVuZ3RoOyBpIDwgbGVuZ3RoOyBpKyspIHsKCQkJaW52YWxpZFBhdGggPSBpbnZhbGlkUGF0aHNbaV07CgkJCWlmIChpbnZhbGlkUGF0aCA9PSBwYXRoIHx8IGludmFsaWRQYXRoLnN0YXJ0c1dpdGgoIHByZWZpeCApKSB7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCQl9CgkJcmV0dXJuIHRydWU7Cgl9CgoJLy8kKCJ4Iikuc3Vic2NyaWJlKCJwZXJzb24iLCAiY2hlY2tWYWxpZGl0eWQiLCBmdW5jdGlvbiAoZSkgewoJLy8gYWxlcnQoZS5wcm9wb3NlZCk7CgkvL30KCWhtLnN1YnNjcmlwdGlvbi5zcGVjaWFsLnZhbGlkaXR5Q2hhbmdlZCA9IHsKCQlzZXR1cDogZnVuY3Rpb24oIHN1YnNjcmliZXIsIHB1Ymxpc2hlciApIHsKCQkJdmFyIGlzVmFsaWRQYXRoID0gcHVibGlzaGVyICsgIippc1ZhbGlkIjsKCgkJCWlmIChpc1VuZGVmaW5lZCggaG0uZ2V0KCBpc1ZhbGlkUGF0aCApICkpIHsKCQkJCWhtLnN1YiggcHVibGlzaGVyLCAiKmludmFsaWRQYXRocyIsICIhYWZ0ZXIqLiBhZnRlciouMSIsIGZ1bmN0aW9uKCkgewoJCQkJCXZhciBpc1ZhbGlkID0gaXNQYXRoVmFsaWQoIHB1Ymxpc2hlciApOwoJCQkJCWlmIChobS5nZXQoIGlzVmFsaWRQYXRoICkgIT09IGlzVmFsaWQpIHsKCQkJCQkJaG0udHJpZ2dlciggcHVibGlzaGVyLCBwdWJsaXNoZXIsICJ2YWxpZGl0eUNoYW5nZWQiLCBpc1ZhbGlkLCAhaXNWYWxpZCApOwoJCQkJCQlobS5zZXQoIGlzVmFsaWRQYXRoLCBpc1ZhbGlkICk7CgkJCQkJfQoJCQkJfSApOwoJCQl9CgkJfQoJfTsKCglleHRlbmQoIGhtRm4sIHsKCgkJLyoKCQkgKiAxLiB0aGUgb2JqZWN0cyBpbiBwYXRoICIqaW52YWxpZFBhdGhzIiwgaXQgaG9sZHMgYWxsIHRoZSBwYXRoIG9mIG1vZGVsIHdoaWNoIGlzIGluIGVycm9yCgkJICogMi4gdGhlIG9iamVjdCBpbiBwYXRoICJtb2RlbCplcnJvcnMiLCBpdCBob2xkcyBhbGwgZXJyb3IgbWVzc2FnZSB0aGF0IGlzCgkJICogKi8KCQljaGVja1ZhbGlkaXR5OiBmdW5jdGlvbiggc3ViUGF0aCApIHsKCgkJCXZhciBmdWxsUGF0aCA9IHRoaXMuZ2V0UGF0aCggc3ViUGF0aCApOyAvLyB0aGlzLmNkKCBzdWJQYXRoICkucGF0aDsKCgkJCXRyYXZlcnNlTW9kZWxOZWVkVmFsaWRhdGlvbiggZnVsbFBhdGgsIGZ1bmN0aW9uKCBwYXRoICkgewoJCQkJdHJpZ2dlciggcGF0aCwgcGF0aCwgImNoZWNrVmFsaWRpdHkiLCByb290Tm9kZS5nZXQoIHBhdGggKSApOwoJCQl9ICk7CgoJCQkvL2FmdGVyIGNoZWNrVmFsaWRpdHkgZmlyZWQsIHdlIGNhbiBjaGVjayB0aGUgaW52YWxpZCBwYXRocyBjb3VudCBmb3IgdGhlIG1vZGVsLAoJCQl2YXIgaXNWYWxpZCA9IGlzUGF0aFZhbGlkKCBmdWxsUGF0aCApOwoJCQkvLwoJCQlobS50cmlnZ2VyKCBmdWxsUGF0aCwgZnVsbFBhdGgsICJ2YWxpZGl0eUNoZWNrZWQiLCBpc1ZhbGlkICk7CgoJCQlyZXR1cm4gaXNWYWxpZDsKCQl9LAoKCQkvL2htKCJ4IikuY2hlY2sodmFsaWRhdG9yTmFtZSwgZXJyb3IpCgkJLy9leGFtcGxlCgkJLy9obSgieCIpLmNoZWNrKCJudW1iZXIiLCAibXkgZXJyb3IgbWVzc2FnZSIpCgkJLy8KCQkvL2htKCJ4IikuY2hlY2soZm5Jc1ZhbGlkLCBlcnJvcikKCQkvL2V4YW1wbGUKCQkvL2htKCJ4IikuY2hlY2soZnVuY3Rpb24oIHZhbHVlICkgeyByZXR1cm4gZmFsc2U7IH0sICJteSBlcnJvciBtZXNzYWdlIik7CgkJdmFsaWRhdG9yOiBmdW5jdGlvbiggdmFsaWRhdG9yLCBvcHRpb25zICkgewoJCQl2YXIgc3ViUGF0aCwKCQkJCWksCgkJCQljdXJyZW50VmFsaWRhdG9yOwoKCQkJaWYgKGlzT2JqZWN0KCB2YWxpZGF0b3IgKSkgewoKCQkJCWZvciAoc3ViUGF0aCBpbiB2YWxpZGF0b3IpIHsKCgkJCQkJdGhpcy5jZCggc3ViUGF0aCApLnZhbGlkYXRvciggdmFsaWRhdG9yW3N1YlBhdGhdICk7CgoJCQkJfQoJCQl9IGVsc2UgewoKCQkJCWlmIChpc0Z1bmN0aW9uKCB2YWxpZGF0b3IgKSB8fCAoaXNTdHJpbmcoIHZhbGlkYXRvciApICYmIHZhbGlkYXRvci5zdGFydHNXaXRoKCAiIyIgKSkpIHsKCgkJCQkJaWYgKGlzU3RyaW5nKCB2YWxpZGF0b3IgKSkgewoJCQkJCQl2YWxpZGF0b3IgPSB0aGlzLnJhdyggdmFsaWRhdG9yLnN1YnN0ciggMSApICk7CgkJCQkJfQoKCQkJCQlobS5oYW5kbGUoIHRoaXMucGF0aCwgYWZ0ZXJVcGRhdGVBbmRDaGVja1ZhbGlkaXR5LCBmdW5jdGlvbiggZSApIHsKCQkJCQkJdmFyIHB1Ymxpc2hlciA9IGUucHVibGlzaGVyLAoJCQkJCQkJcHJldmlvdXNFcnJvciA9IHZhbGlkYXRvci5wcmV2aW91c0Vycm9yOwoKCQkJCQkJLy9kb24ndCBjaGVjayB3aGVuIGl0IGlzIGVtcHR5CgkJCQkJCWlmICghaXNFbXB0eVN0cmluZyggZS5wcm9wb3NlZCApKSB7CgoJCQkJCQkJdmFyIGVycm9yTWVzc2FnZSA9IHZhbGlkYXRvciggcHVibGlzaGVyLmdldCgpICk7CgoJCQkJCQkJaWYgKGVycm9yTWVzc2FnZSA9PT0gZmFsc2UpIHsKCQkJCQkJCQllcnJvck1lc3NhZ2UgPSBkZWZhdWx0T3B0aW9ucy5lcnJvcnMuZGVmYXVsdEVycm9yOwoJCQkJCQkJfQoKCQkJCQkJCWlmIChpc1N0cmluZyggZXJyb3JNZXNzYWdlICkpIHsKCQkJCQkJCQkvLyB0aGUgIiE9IiBpcyBkZWxpYmVyYXRlLCBkb24ndCBjaGFuZ2UgdG8gIiE9PSIKCQkJCQkJCQlpZiAoZXJyb3JNZXNzYWdlICE9IHByZXZpb3VzRXJyb3IpIHsKCgkJCQkJCQkJCXB1Ymxpc2hlci5hZGRFcnJvciggZXJyb3JNZXNzYWdlICk7CgoJCQkJCQkJCQlpZiAoIXByZXZpb3VzRXJyb3IpIHsKCQkJCQkJCQkJCXB1Ymxpc2hlci5yZW1vdmVFcnJvciggcHJldmlvdXNFcnJvciApOwoJCQkJCQkJCQl9CgoJCQkJCQkJCQl2YWxpZGF0b3IucHJldmlvdXNFcnJvciA9IGVycm9yTWVzc2FnZTsKCQkJCQkJCQl9CgoJCQkJCQkJfSBlbHNlIHsKCQkJCQkJCQlpZiAocHJldmlvdXNFcnJvcikgewoJCQkJCQkJCQlwdWJsaXNoZXIucmVtb3ZlRXJyb3IoIHByZXZpb3VzRXJyb3IgKTsKCQkJCQkJCQkJdmFsaWRhdG9yLnByZXZpb3VzRXJyb3IgPSAiIjsKCQkJCQkJCQl9CgkJCQkJCQl9CgkJCQkJCX0gZWxzZSB7CgkJCQkJCQlpZiAocHJldmlvdXNFcnJvcikgewoJCQkJCQkJCXB1Ymxpc2hlci5yZW1vdmVFcnJvciggcHJldmlvdXNFcnJvciApOwoJCQkJCQkJCXZhbGlkYXRvci5wcmV2aW91c0Vycm9yID0gIiI7CgkJCQkJCQl9CgkJCQkJCX0KCgkJCQkJfSApOwoKCQkJCX0gZWxzZSBpZiAoaXNTdHJpbmcoIHZhbGlkYXRvciApKSB7CgoJCQkJCWhtLmhhbmRsZSggdGhpcy5wYXRoLCBhZnRlclVwZGF0ZUFuZENoZWNrVmFsaWRpdHksICIqdl8iICsgdmFsaWRhdG9yLCBvcHRpb25zICk7CgoJCQkJfSBlbHNlIGlmIChpc0FycmF5KCB2YWxpZGF0b3IgKSkgewoKCQkJCQlmb3IgKGkgPSAwOyBpIDwgdmFsaWRhdG9yLmxlbmd0aDsgaSsrKSB7CgoJCQkJCQljdXJyZW50VmFsaWRhdG9yID0gdmFsaWRhdG9yW2ldOwoKCQkJCQkJaWYgKGlzQXJyYXkoIGN1cnJlbnRWYWxpZGF0b3IgKSkgewoJCQkJCQkJdGhpcy52YWxpZGF0b3IoIGN1cnJlbnRWYWxpZGF0b3JbMF0sIGN1cnJlbnRWYWxpZGF0b3JbMV0gKTsKCgkJCQkJCX0gZWxzZSB7CgkJCQkJCQl0aGlzLnZhbGlkYXRvciggY3VycmVudFZhbGlkYXRvciApOwoJCQkJCQl9CgkJCQkJfQoJCQkJfQoKCQkJfQoJCQlyZXR1cm4gdGhpczsKCQl9LAoKCQlyZXNldFZhbGlkaXR5OiBmdW5jdGlvbigpIHsKCQkJcmVzZXRWYWxpZGl0eSggdGhpcy5wYXRoICk7CgoJCQlpZiAoIWlzUHJpbWl0aXZlKCB0aGlzLmdldCgpICkpIHsKCQkJCXRyYXZlcnNlTW9kZWxOZWVkVmFsaWRhdGlvbiggdGhpcy5wYXRoLCByZXNldFZhbGlkaXR5ICk7CgkJCX0KCQkJaG0udHJpZ2dlciggdGhpcy5wYXRoLCB0aGlzLnBhdGgsICJ2YWxpZGl0eVJlc2V0IiApOwoJCX0sCgoJCWFkZEVycm9yOiBmdW5jdGlvbiggZXJyb3IgKSB7CgkJCXRoaXMuY3JlYXRlSWZVbmRlZmluZWQoICIqZXJyb3JzIiwgW10gKQoJCQkJLmNkKCAiKmVycm9ycyIgKQoJCQkJLnB1c2hVbmlxdWUoIGVycm9yICk7CgoJCQlpbnZhbGlkUGF0aHNNb2RlbC5wdXNoVW5pcXVlKCB0aGlzLnBhdGggKTsKCQkJcmV0dXJuIHRoaXM7CgoJCX0sCgoJCXJlbW92ZUVycm9yOiBmdW5jdGlvbiggZXJyb3IgKSB7CgoJCQl2YXIgZXJyb3JzID0gdGhpcy5jcmVhdGVJZlVuZGVmaW5lZCggIiplcnJvcnMiLCBbXSApLmNkKCAiKmVycm9ycyIgKTsKCQkJZXJyb3JzLnJlbW92ZUl0ZW0oIGVycm9yICk7CgkJCWlmIChlcnJvcnMuaXNFbXB0eSgpKSB7CgkJCQlpbnZhbGlkUGF0aHNNb2RlbC5yZW1vdmVJdGVtKCB0aGlzLnBhdGggKTsKCQkJfQoJCQlyZXR1cm4gdGhpczsKCQl9LAoKCQlnZXRFcnJvcnM6IGZ1bmN0aW9uKCkgewoKCQkJdmFyIGksCgkJCQlwYXRoID0gdGhpcy5wYXRoLAoJCQkJaW52YWxpZFBhdGgsCgkJCQlydG4gPSBbXTsKCgkJCWZvciAoaSA9IDA7IGkgPCBpbnZhbGlkUGF0aHMubGVuZ3RoOyBpKyspIHsKCQkJCWludmFsaWRQYXRoID0gaW52YWxpZFBhdGhzW2ldOwoJCQkJaWYgKGludmFsaWRQYXRoID09IHBhdGggfHwgaW52YWxpZFBhdGguc3RhcnRzV2l0aCggcGF0aCApKSB7CgkJCQkJcnRuID0gcnRuLmNvbmNhdCggaG0uZ2V0KCBpbnZhbGlkUGF0aCArICIqZXJyb3JzIiApICk7CgkJCQl9CgkJCX0KCQkJcmV0dXJuIHJ0bjsKCQl9CgoJfSApOwoKCWhtLmNoZWNrVmFsaWRpdHkgPSBmdW5jdGlvbiggcGF0aCApIHsKCQlyZXR1cm4gcm9vdE5vZGUuY2hlY2tWYWxpZGl0eSggcGF0aCApOwoJfTsKCgkvL3doZW4gcGF0aCBpcyBkZWxldGVkLCByZW1vdmUgaXQgZnJvbSBpbnZhbGlkUGF0aHNNb2RlbAoJaG0ub25EZWxldGVOb2RlKCBmdW5jdGlvbiggcGF0aCApIHsKCQlpbnZhbGlkUGF0aHNNb2RlbC5yZW1vdmVJdGVtKCBwYXRoICk7Cgl9ICk7CgoJZnVuY3Rpb24gYnVpbGRSZWdleEZuKCBleCwgcmV2ZXJzZSApIHsKCQlyZXR1cm4gcmV2ZXJzZSA/IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQkJcmV0dXJuICFleC50ZXN0KCB2YWx1ZSApOwoJCX0gOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJCXJldHVybiBleC50ZXN0KCB2YWx1ZSApOwoJCX07Cgl9CgoJZnVuY3Rpb24gZGVmYXVsdEVycm9yQnVpbGRlciggZm9ybWF0LCBvcHRpb25zICkgewoJCXJldHVybiBvcHRpb25zLmVycm9yIHx8IGZvcm1hdC5zdXBwbGFudCggb3B0aW9ucyApOwoJfQoKCWhtLnZhbGlkYXRvci5kZWZhdWx0RXJyb3JCdWlsZGVyID0gZGVmYXVsdEVycm9yQnVpbGRlcjsKCWhtLnZhbGlkYXRvci5idWlsZFJlZ2V4Rm4gPSBidWlsZFJlZ2V4Rm47CgoJaG0udmFsaWRhdG9yKCBbCgkJewoJCQluYW1lOiAicmVxdWlyZWQiLAoJCQllcnJvcjogIlRoaXMgZmllbGQgaXMgcmVxdWlyZWQuIiwKCQkJLy93aGVuIGl0IGlzIGNoZWNrZWQgaXQgaXMgYWx3YXlzIHRydWUKCQkJaXNWYWxpZDogcmV0dXJuVHJ1ZQoJCX0sCgkJewoJCQluYW1lOiAiZW1haWwiLAoJCQllcnJvcjogIlBsZWFzZSBlbnRlciBhIHZhbGlkIGVtYWlsIGFkZHJlc3MuIiwKCQkJaXNWYWxpZDogckVtYWlsCgkJfSwKCQl7CgkJCW5hbWU6ICJ1cmwiLAoJCQllcnJvcjogIlBsZWFzZSBlbnRlciBhIHZhbGlkIFVSTC4iLAoJCQlpc1ZhbGlkOiByVXJsCgkJfSwKCQl7CgkJCW5hbWU6ICJkYXRlIiwKCQkJZXJyb3I6ICJQbGVhc2UgZW50ZXIgYSB2YWxpZCBkYXRlLiIsCgkJCWlzVmFsaWQ6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQkJCXJldHVybiAhckludmFsaWREYXRlLnRlc3QoIG5ldyBEYXRlKCB2YWx1ZSApLnRvU3RyaW5nKCkgKTsKCQkJfQoJCX0sCgkJewoJCQluYW1lOiAiZGF0ZUlTTyIsCgkJCWVycm9yOiAiUGxlYXNlIGVudGVyIGEgdmFsaWQgZGF0ZSAoSVNPKS4iLAoJCQlpc1ZhbGlkOiByRGF0ZUlTTwoJCX0sCgkJewoJCQluYW1lOiAibnVtYmVyIiwKCQkJZXJyb3I6ICJQbGVhc2UgZW50ZXIgYSB2YWxpZCBudW1iZXIuIiwKCQkJaXNWYWxpZDogck51bWJlcgoJCX0sCgkJewoJCQluYW1lOiAiZGlnaXRzIiwKCQkJZXJyb3I6ICJQbGVhc2UgZW50ZXIgb25seSBkaWdpdHMuIiwKCQkJaXNWYWxpZDogckRpZ2l0CgoJCX0sCgkJewoJCQluYW1lOiAiY3JlZGl0Y2FyZCIsCgkJCWVycm9yOiAiUGxlYXNlIGVudGVyIGEgdmFsaWQgY3JlZGl0IGNhcmQgbnVtYmVyLiIsCgkJCWlzVmFsaWQ6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQkJCWlmICgvW14wLTlcLV0rLy50ZXN0KCB2YWx1ZSApKSB7CgkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJfQoKCQkJCXZhciBuQ2hlY2sgPSAwLAoJCQkJCW5EaWdpdCA9IDAsCgkJCQkJYkV2ZW4gPSBmYWxzZSwKCQkJCQljRGlnaXQ7CgoJCQkJdmFsdWUgPSB2YWx1ZS5yZXBsYWNlKCAvXEQvZywgIiIgKTsKCgkJCQlmb3IgKHZhciBuID0gdmFsdWUubGVuZ3RoIC0gMTsgbiA+PSAwOyBuLS0pIHsKCQkJCQljRGlnaXQgPSB2YWx1ZS5jaGFyQXQoIG4gKTsKCQkJCQluRGlnaXQgPSBwYXJzZUludCggY0RpZ2l0LCAxMCApOwoJCQkJCWlmIChiRXZlbikgewoJCQkJCQlpZiAoKG5EaWdpdCAqPSAyKSA+IDkpIHsKCQkJCQkJCW5EaWdpdCAtPSA5OwoJCQkJCQl9CgkJCQkJfQoJCQkJCW5DaGVjayArPSBuRGlnaXQ7CgkJCQkJYkV2ZW4gPSAhYkV2ZW47CgkJCQl9CgoJCQkJcmV0dXJuIChuQ2hlY2sgJSAxMCkgPT09IDA7CgkJCX0KCgkJfSwKCQl7CgkJCW5hbWU6ICJtaW5sZW5ndGgiLAoJCQllcnJvcjogIlBsZWFzZSBlbnRlciBhdCBsZWFzdCB7bWlubGVuZ3RofSBjaGFyYWN0ZXJzLiIsCgkJCWlzVmFsaWQ6IGZ1bmN0aW9uKCB2YWx1ZSwgb3B0aW9ucyApIHsKCgkJCQlyZXR1cm4gdmFsdWUubGVuZ3RoID49IG9wdGlvbnMubWlubGVuZ3RoOwoKCQkJfSwKCQkJaW5pdGlhbGl6ZTogZnVuY3Rpb24oIHB1Ymxpc2hlciwgc3Vic2NyaWJlciwgaGFuZGxlciwgb3B0aW9ucyApIHsKCQkJCXZhciBtYXRjaDsKCQkJCWlmIChvcHRpb25zICYmIChtYXRjaCA9IHJGaXJzdFRva2VuLmV4ZWMoIG9wdGlvbnMgKSkpIHsKCgkJCQkJaGFuZGxlci5vcHRpb25zID0gewoJCQkJCQltaW5sZW5ndGg6ICttYXRjaFsxXSwKCQkJCQkJZXJyb3I6IG1hdGNoWzNdCgkJCQkJfTsKCQkJCX0gZWxzZSB7CgkJCQkJdGhyb3cgImludmFsaWQgb3B0aW9ucyBmb3IgbWlubGVuZ3RoIHZhbGlkYXRvciI7CgkJCQl9CgkJCX0sCgoJCQlidWlsZEVycm9yOiBkZWZhdWx0RXJyb3JCdWlsZGVyCgkJfSwKCQl7CgkJCW5hbWU6ICJtYXhsZW5ndGgiLAoJCQllcnJvcjogIlBsZWFzZSBlbnRlciBubyBtb3JlIHRoYW4ge21heGxlbmd0aH0gY2hhcmFjdGVycy4iLAoJCQlpc1ZhbGlkOiBmdW5jdGlvbiggdmFsdWUsIG9wdGlvbnMgKSB7CgoJCQkJcmV0dXJuIHZhbHVlLmxlbmd0aCA8PSBvcHRpb25zLm1heGxlbmd0aDsKCgkJCX0sCgkJCWluaXRpYWxpemU6IGZ1bmN0aW9uKCBwdWJsaXNoZXIsIHN1YnNjcmliZXIsIGhhbmRsZXIsIG9wdGlvbnMgKSB7CgkJCQl2YXIgbWF0Y2g7CgkJCQlpZiAob3B0aW9ucyAmJiAobWF0Y2ggPSByRmlyc3RUb2tlbi5leGVjKCBvcHRpb25zICkpKSB7CgkJCQkJaGFuZGxlci5vcHRpb25zID0gewoJCQkJCQltYXhsZW5ndGg6ICttYXRjaFsxXSwKCQkJCQkJZXJyb3I6IG1hdGNoWzNdCgkJCQkJfTsKCQkJCX0gZWxzZSB7CgkJCQkJdGhyb3cgImludmFsaWQgb3B0aW9ucyBmb3IgbWF4bGVuZ3RoIHZhbGlkYXRvciI7CgkJCQl9CgkJCX0sCgkJCWJ1aWxkRXJyb3I6IGRlZmF1bHRFcnJvckJ1aWxkZXIKCQl9LAoJCXsKCQkJbmFtZTogInJhbmdlbGVuZ3RoIiwKCQkJZXJyb3I6ICJQbGVhc2UgZW50ZXIgYSB2YWx1ZSBiZXR3ZWVuIHttaW5sZW5ndGh9IGFuZCB7bWF4bGVuZ3RofSBjaGFyYWN0ZXJzIGxvbmcuIiwKCQkJaXNWYWxpZDogZnVuY3Rpb24oIHZhbHVlLCBvcHRpb25zICkgewoKCQkJCXJldHVybiB2YWx1ZS5sZW5ndGggPj0gb3B0aW9ucy5taW5sZW5ndGggJiYKCQkJCSAgICAgICB2YWx1ZS5sZW5ndGggPD0gb3B0aW9ucy5tYXhsZW5ndGg7CgoJCQl9LAoJCQlpbml0aWFsaXplOiBmdW5jdGlvbiggcHVibGlzaGVyLCBzdWJzY3JpYmVyLCBoYW5kbGVyLCBvcHRpb25zICkgewoJCQkJdmFyIG1hdGNoOwoJCQkJaWYgKG9wdGlvbnMgJiYgKG1hdGNoID0gckZpcnN0VHdvVG9rZW4uZXhlYyggb3B0aW9ucyApKSkgewoJCQkJCWhhbmRsZXIub3B0aW9ucyA9IHsKCQkJCQkJbWlubGVuZ3RoOiArbWF0Y2hbMV0sCgkJCQkJCW1heGxlbmd0aDogK21hdGNoWzJdLAoJCQkJCQllcnJvcjogbWF0Y2hbNF0KCQkJCQl9OwoJCQkJfSBlbHNlIHsKCQkJCQl0aHJvdyAiaW52YWxpZCBvcHRpb25zIGZvciByYW5nZWxlbmd0aCB2YWxpZGF0b3IiOwoJCQkJfQoJCQl9LAoJCQlidWlsZEVycm9yOiBkZWZhdWx0RXJyb3JCdWlsZGVyCgoJCX0sCgkJewoJCQluYW1lOiAibWluIiwKCQkJZXJyb3I6ICJQbGVhc2UgZW50ZXIgYSB2YWx1ZSBncmVhdGVyIHRoYW4gb3IgZXF1YWwgdG8ge21pbn0uIiwKCQkJaXNWYWxpZDogZnVuY3Rpb24oIHZhbHVlLCBvcHRpb25zICkgewoKCQkJCXJldHVybiB2YWx1ZSA+PSBvcHRpb25zLm1pbjsKCgkJCX0sCgkJCWluaXRpYWxpemU6IGZ1bmN0aW9uKCBwdWJsaXNoZXIsIHN1YnNjcmliZXIsIGhhbmRsZXIsIG9wdGlvbnMgKSB7CgkJCQl2YXIgbWF0Y2g7CgkJCQlpZiAob3B0aW9ucyAmJiAobWF0Y2ggPSByRmlyc3RUb2tlbi5leGVjKCBvcHRpb25zICkpKSB7CgkJCQkJaGFuZGxlci5vcHRpb25zID0gewoJCQkJCQltaW46ICttYXRjaFsxXSwKCQkJCQkJZXJyb3I6IG1hdGNoWzNdCgkJCQkJfTsKCQkJCX0gZWxzZSB7CgkJCQkJdGhyb3cgImludmFsaWQgb3B0aW9ucyBmb3IgbWluIHZhbGlkYXRvciI7CgkJCQl9CgoJCQl9LAoJCQlidWlsZEVycm9yOiBkZWZhdWx0RXJyb3JCdWlsZGVyCgkJfSwKCQl7CgkJCW5hbWU6ICJtYXgiLAoJCQllcnJvcjogIlBsZWFzZSBlbnRlciBhIHZhbHVlIGxlc3MgdGhhbiBvciBlcXVhbCB0byB7bWF4fS4iLAoJCQlpc1ZhbGlkOiBmdW5jdGlvbiggdmFsdWUsIG9wdGlvbnMgKSB7CgoJCQkJcmV0dXJuIHZhbHVlIDw9IG9wdGlvbnMubWF4OwoKCQkJfSwKCQkJaW5pdGlhbGl6ZTogZnVuY3Rpb24oIHB1Ymxpc2hlciwgc3Vic2NyaWJlciwgaGFuZGxlciwgb3B0aW9ucyApIHsKCQkJCXZhciBtYXRjaDsKCQkJCWlmIChvcHRpb25zICYmIChtYXRjaCA9IHJGaXJzdFRva2VuLmV4ZWMoIG9wdGlvbnMgKSkpIHsKCQkJCQloYW5kbGVyLm9wdGlvbnMgPSB7CgkJCQkJCW1heDogK21hdGNoWzFdLAoJCQkJCQllcnJvcjogbWF0Y2hbM10KCQkJCQl9OwoJCQkJfSBlbHNlIHsKCQkJCQl0aHJvdyAiaW52YWxpZCBvcHRpb25zIGZvciBtYXggdmFsaWRhdG9yIjsKCQkJCX0KCQkJfSwKCQkJYnVpbGRFcnJvcjogZGVmYXVsdEVycm9yQnVpbGRlcgoJCX0sCgkJewoJCQluYW1lOiAicmFuZ2UiLAoJCQllcnJvcjogIlBsZWFzZSBlbnRlciBhIHZhbHVlIGJldHdlZW4ge21pbn0gYW5kIHttYXh9LiIsCgkJCWlzVmFsaWQ6IGZ1bmN0aW9uKCB2YWx1ZSwgb3B0aW9ucyApIHsKCgkJCQlyZXR1cm4gdmFsdWUgPj0gb3B0aW9ucy5taW4gJiYgdmFsdWUgPD0gb3B0aW9ucy5tYXg7CgoJCQl9LAoJCQlpbml0aWFsaXplOiBmdW5jdGlvbiggcHVibGlzaGVyLCBzdWJzY3JpYmVyLCBoYW5kbGVyLCBvcHRpb25zICkgewoJCQkJdmFyIG1hdGNoOwoJCQkJaWYgKG9wdGlvbnMgJiYgKG1hdGNoID0gckZpcnN0VHdvVG9rZW4uZXhlYyggb3B0aW9ucyApKSkgewoJCQkJCWhhbmRsZXIub3B0aW9ucyA9IHsKCQkJCQkJbWluOiArbWF0Y2hbMV0sCgkJCQkJCW1heDogK21hdGNoWzJdLAoJCQkJCQllcnJvcjogbWF0Y2hbNF0KCQkJCQl9OwoJCQkJfSBlbHNlIHsKCQkJCQl0aHJvdyAiaW52YWxpZCBvcHRpb25zIGZvciByYW5nZSB2YWxpZGF0b3IiOwoJCQkJfQoJCQl9LAoJCQlidWlsZEVycm9yOiBkZWZhdWx0RXJyb3JCdWlsZGVyCgkJfSwKCQl7CgkJCW5hbWU6ICJlcXVhbCIsCgkJCWVycm9yOiAiUGxlYXNlIGVudGVyIHRoZSBzYW1lIHZhbHVlIGFnYWluLiIsCgkJCWlzVmFsaWQ6IGZ1bmN0aW9uKCB2YWx1ZSwgb3B0aW9ucyApIHsKCQkJCXJldHVybiByb290Tm9kZS5nZXQoIG9wdGlvbnMuY29tcGFyZVBhdGggKSA9PT0gdmFsdWU7CgkJCX0sCgkJCWluaXRpYWxpemU6IGZ1bmN0aW9uKCBwdWJsaXNoZXIsIHN1YnNjcmliZXIsIGhhbmRsZXIsIG9wdGlvbnMgKSB7CgkJCQl2YXIgbWF0Y2g7CgkJCQlpZiAob3B0aW9ucyAmJiAobWF0Y2ggPSByRmlyc3RUb2tlbi5leGVjKCBvcHRpb25zICkpKSB7CgoJCQkJCXZhciBjb21wYXJlUGF0aCA9IHB1Ymxpc2hlci5jZCggbWF0Y2hbMV0gKS5wYXRoOwoJCQkJCWhhbmRsZXIub3B0aW9ucyA9IHsKCQkJCQkJY29tcGFyZVBhdGg6IGNvbXBhcmVQYXRoLAoJCQkJCQllcnJvcjogbWF0Y2hbM10KCQkJCQl9OwoKCQkJCQlwdWJsaXNoZXIuc3ViKCBjb21wYXJlUGF0aCwgImFmdGVyVXBkYXRlIiwgZnVuY3Rpb24oIGUgKSB7CgkJCQkJCWlmICghdGhpcy5pc0VtcHR5KCkpIHsKCQkJCQkJCXRyaWdnZXIoCgkJCQkJCQkJdGhpcy5wYXRoLAoJCQkJCQkJCXRoaXMucGF0aCwKCQkJCQkJCQkiY2hlY2tWYWxpZGl0eSIsCgkJCQkJCQkJdGhpcy5nZXQoKSAvL3Byb3Bvc2VkIHZhbHVlCgkJCQkJCQkpOwoJCQkJCQl9CgkJCQkJfSApOwoKCQkJCX0gZWxzZSB7CgkJCQkJdGhyb3cgImludmFsaWQgb3B0aW9ucyBmb3IgZXF1YWwgdmFsaWRhdG9yIjsKCQkJCX0KCQkJfQoJCX0sCgkJewoJCQluYW1lOiAicmVnZXgiLAoJCQllcnJvcjogIlBsZWFzZSBlbnRlciBhIHZhbHVlIG1hdGNoIHdpdGggcmVxdWlyZWQgcGF0dGVybi4iLAoJCQlpc1ZhbGlkOiBmdW5jdGlvbiggdmFsdWUsIG9wdGlvbnMgKSB7CgkJCQlyZXR1cm4gb3B0aW9ucy5yZWdleC50ZXN0KCB2YWx1ZSApOwoJCQl9LAoJCQlpbml0aWFsaXplOiBmdW5jdGlvbiggcHVibGlzaGVyLCBzdWJzY3JpYmVyLCBoYW5kbGVyLCBvcHRpb25zICkgewoJCQkJdmFyIG1hdGNoOwoKCQkJCWlmIChvcHRpb25zICYmIChtYXRjaCA9IHJSZWdFeC5leGVjKCBvcHRpb25zICkpKSB7CgkJCQkJaGFuZGxlci5vcHRpb25zID0gewoJCQkJCQlyZWdleDogZXZhbCggbWF0Y2hbMV0gKSwKCQkJCQkJZXJyb3I6IG1hdGNoWzVdCgkJCQkJfTsKCQkJCX0gZWxzZSB7CgkJCQkJdGhyb3cgImludmFsaWQgb3B0aW9ucyBmb3IgcmVnZXggdmFsaWRhdG9yIjsKCQkJCX0KCQkJfQoJCX0sCgkJewoJCQluYW1lOiAiZml4ZWRWYWx1ZSIsCgkJCWVycm9yOiAnUGxlYXNlIGVudGVyIHZhbHVlICJ7Zml4ZWRWYWx1ZX0iJywKCQkJaXNWYWxpZDogZnVuY3Rpb24oIHZhbHVlLCBvcHRpb25zICkgewoJCQkJcmV0dXJuIHZhbHVlID09IG9wdGlvbnMuZml4ZWRWYWx1ZTsKCQkJfSwKCQkJaW5pdGlhbGl6ZTogZnVuY3Rpb24oIHB1Ymxpc2hlciwgc3Vic2NyaWJlciwgaGFuZGxlciwgb3B0aW9ucyApIHsKCQkJCXZhciBtYXRjaDsKCQkJCWlmIChpc1N0cmluZyggb3B0aW9ucyApKSB7CgkJCQkJbWF0Y2ggPSAvXihcdyspKCwoLiopKSokLy5leGVjKCBvcHRpb25zICk7CgkJCQkJaWYgKG1hdGNoKSB7CgkJCQkJCWhhbmRsZXIub3B0aW9ucyA9IHsKCQkJCQkJCWZpeGVkVmFsdWU6IHRvVHlwZWRWYWx1ZSggbWF0Y2hbMV0gKSwKCQkJCQkJCWVycm9yOiBtYXRjaFszXQoJCQkJCQl9OwoJCQkJCX0KCQkJCX0gZWxzZSBpZiAoaXNPYmplY3QoIG9wdGlvbnMgKSkgewoKCQkJCQloYW5kbGVyLm9wdGlvbnMgPSBvcHRpb25zOwoKCQkJCX0gZWxzZSBpZiAoIWlzVW5kZWZpbmVkKCBvcHRpb25zICkpIHsKCgkJCQkJaGFuZGxlci5vcHRpb25zID0gewoJCQkJCQlmaXhlZFZhbHVlOiBvcHRpb25zCgkJCQkJfTsKCgkJCQl9IGVsc2UgewoJCQkJCXRocm93ICJtaXNzaW5nIG9wdGlvbnMgaW4gZml4ZWRWYWx1ZSB2YWxpZGF0b3IiOwoJCQkJfQoJCQl9LAoJCQlidWlsZEVycm9yOiBkZWZhdWx0RXJyb3JCdWlsZGVyCgkJfQoJXSApOwoKCWZ1bmN0aW9uIHJlc2V0VmFsaWRpdHkoIHBhdGggKSB7CgkJdmFyIGVycm9yc01vZGVsID0gaG0oIHBhdGggKyAiKmVycm9ycyIgKTsKCQlpZiAoIWVycm9yc01vZGVsLmlzRW1wdHkoKSkgewoJCQllcnJvcnNNb2RlbC5jbGVhcigpOwoJCQlpbnZhbGlkUGF0aHNNb2RlbC5yZW1vdmVJdGVtKCBwYXRoICk7CgkJfQoJfQoKCXZhciBpc1JlcXVpcmVkID0gaG0ud29ya2Zsb3coICJ2X3JlcXVpcmVkIiApLmdldDsKCglmdW5jdGlvbiBpc01vZGVsUmVxdWlyZWQoIHBhdGggKSB7CgkJdmFyIHN1YnNjcmlwdGlvbkJ5TW9kZWwgPSBobSggcGF0aCApLnN1YnNUb01lKCk7Ly8gc3Vic2NyaXB0aW9ucy5nZXRCeVB1Ymxpc2hlciggcGF0aCApOwoJCWZvciAodmFyIGkgPSAwOyBpIDwgc3Vic2NyaXB0aW9uQnlNb2RlbC5sZW5ndGg7IGkrKykgewoJCQl2YXIgc3Vic2NyaXB0aW9uID0gc3Vic2NyaXB0aW9uQnlNb2RlbFtpXTsKCQkJaWYgKHN1YnNjcmlwdGlvbi5oYW5kbGVyLmdldCA9PT0gaXNSZXF1aXJlZCkgewoJCQkJcmV0dXJuIHRydWU7CgkJCX0KCQl9CgkJcmV0dXJuIGZhbHNlOwoJfQoKCWZ1bmN0aW9uIGJ1aWxkRXJyb3JNZXNzYWdlKCB2YWxpZGF0b3IsIG9wdGlvbnMgKSB7CgoJCS8vbmFtZWQgdmFsaWRhdG9yIG5vcm1hbGx5IGhhcyBhIGRlZmF1bHRFcnJvcgoJCXZhciBkZWZhdWx0RXJyb3IgPSB2YWxpZGF0b3IubmFtZSAmJiBkZWZhdWx0T3B0aW9ucy5lcnJvcnNbdmFsaWRhdG9yLm5hbWVdOwoKCQkvL2lmIHZhbGlkYXRvciBoYXMgYnVpbGRFcnJvciBmdW5jdGlvbiwgdGhpcyB0YWtlIHRoZSBoaWdoZXN0IHByaW9yaXR5CgkJaWYgKHZhbGlkYXRvci5idWlsZEVycm9yKSB7CgoJCQkvL3JldHVybiB1c2VyRXJyb3IgfHwgZm9ybWF0LmFwcGx5KCBudWxsLCBbZGVmYXVsdEVycm9yXS5jb25jYXQoIG9wdGlvbnMubWlubGVuZ3RoICkgKTsKCQkJcmV0dXJuIHZhbGlkYXRvci5idWlsZEVycm9yKCBkZWZhdWx0RXJyb3IsIG9wdGlvbnMgKTsKCgkJCS8vaWYgZGVmYXVsdEVycm9yIGlzIGZvcm1hdCBzdHJpbmcsCgkJfSBlbHNlIHsKCgkJCS8vdXNlckVycm9yIGlzIG5vcm1hbGx5IHBhc3NlZCBpbiBvcHRpb25zIG9mIGVhY2ggaW5zdGFuY2UKCQkJdmFyIHVzZXJFcnJvciA9IGlzT2JqZWN0KCBvcHRpb25zICkgPyBvcHRpb25zLmVycm9yIDogb3B0aW9uczsKCgkJCWlmIChkZWZhdWx0RXJyb3IgJiYgZGVmYXVsdEVycm9yLmNvbnRhaW5zKCAiezB9IiApKSB7CgoJCQkJcmV0dXJuIGRlZmF1bHRFcnJvci5mb3JtYXQuYXBwbHkoIGRlZmF1bHRFcnJvciwgdXNlckVycm9yLnNwbGl0KCAiLCIgKSApOwoKCQkJfSBlbHNlIHsKCgkJCQlyZXR1cm4gdXNlckVycm9yIHx8IGRlZmF1bHRFcnJvciB8fCB2YWxpZGF0b3IuZXJyb3I7CgkJCX0KCQl9Cgl9CgoJZnVuY3Rpb24gYnVpbGRWYWxpZGF0aW9uV29ya2Zsb3dUeXBlKCB2YWxpZGF0b3IgKSB7CgoJCXJldHVybiB7CgoJCQlpbml0aWFsaXplOiB2YWxpZGF0b3IuaW5pdGlhbGl6ZSwKCgkJCWdldDogZnVuY3Rpb24oIGUgKSB7CgoJCQkJLy9pZiBpdCB2aW9sYXRlIHJlcXVpcmVkIHJ1bGUsIGRvbid0IGRvIGZ1cnRoZXIgdmFsaWRhdGlvbiwKCQkJCS8vYXMgd2UgZXhwZWN0IHRoZSByZXF1aXJlZCBydWxlIHdpbGwgY2FwdHVyZSBpdCBmaXJzdC4KCQkJCXZhciBpc1ZhbGlkLAoJCQkJCXZpb2xhdGVSZXF1aXJlZFJ1bGUsCgkJCQkJcHVibGlzaGVyID0gZS5wdWJsaXNoZXIsCgkJCQkJb3B0aW9ucyA9IGUuaGFuZGxlci5vcHRpb25zLAoJCQkJCXByb3Bvc2VkID0gZS5wcm9wb3NlZCwKCQkJCQllcnJvck1lc3NhZ2UgPSBidWlsZEVycm9yTWVzc2FnZSggdmFsaWRhdG9yLCBvcHRpb25zICk7CgoJCQkJLy9pZiBtb2RlbCBpcyBlbXB0eSwgb25seSBjaGVjayB0aGUgInJlcXVpcmUiIHZhbGlkYXRvcgoJCQkJLy9JZiBpdCBpcyByZXF1aXJlZCwgdGhlbiBpdCBpcyBpbnZhbGlkLCBubyBmdXJ0aGVyIHZhbGlkYXRpb24gaXMgY2hlY2tlZAoJCQkJLy9pZiBpdCBpcyBub3QgcmVxdWlyZWQsIGl0IGlzIHZhbGlkLCBubyBmdXJ0aGVyIHZhbGlkYXRpb24gaXMgY2hlY2tlZAoJCQkJaWYgKGlzRW1wdHlTdHJpbmcoIHByb3Bvc2VkICkpIHsKCgkJCQkJaWYgKGlzTW9kZWxSZXF1aXJlZCggcHVibGlzaGVyLnBhdGggKSkgewoJCQkJCQlpc1ZhbGlkID0gZmFsc2U7CgkJCQkJCXZpb2xhdGVSZXF1aXJlZFJ1bGUgPSB0cnVlOwoJCQkJCX0gZWxzZSB7CgkJCQkJCWlzVmFsaWQgPSB0cnVlOwoJCQkJCX0KCgkJCQl9IGVsc2UgewoKCQkJCQlpc1ZhbGlkID0gdmFsaWRhdG9yLmlzVmFsaWQoIHByb3Bvc2VkLCBvcHRpb25zICk7CgkJCQl9CgoJCQkJaWYgKCFpc1ZhbGlkKSB7CgoJCQkJCS8vYWRkIGVycm9yIHdoZW4gdGhlIGN1cnJlbnQgcnVsZSBpcyB0aGUgInJlcXVpcmVkIHJ1bGUiCgkJCQkJLy9vciB3aGVuICJyZXF1aXJlZCIgcnVsZSBpcyBub3QgdmlvbGF0ZWQKCQkJCQlpZiAoIXZpb2xhdGVSZXF1aXJlZFJ1bGUgfHwgdmFsaWRhdG9yLm5hbWUgPT09ICJyZXF1aXJlZCIpIHsKCQkJCQkJcHVibGlzaGVyLmFkZEVycm9yKCBlcnJvck1lc3NhZ2UgKTsKCQkJCQl9IGVsc2UgewoJCQkJCQlwdWJsaXNoZXIucmVtb3ZlRXJyb3IoIGVycm9yTWVzc2FnZSApOwoJCQkJCX0KCQkJCX0gZWxzZSB7CgkJCQkJcHVibGlzaGVyLnJlbW92ZUVycm9yKCBlcnJvck1lc3NhZ2UgKTsKCQkJCX0KCQkJfQoJCX07Cgl9CgoJZnVuY3Rpb24gdHJhdmVyc2VNb2RlbE5lZWRWYWxpZGF0aW9uKCBwYXRoLCBjYWxsYmFjayApIHsKCgkJLy90aGUgZm9sbG93aW5nIGNvZGUgdHJ5IHRvIHRyaWdnZXIgdGhlICJjaGVja1ZhbGlkaXR5IiBldmVudCwgc28gdGhhdCB0aGUgdmFsaWRhdG9yIHdpbGwKCQkvLyBiZSBjYWxsZWQgdG8gY2hlY2sgY3VycmVudCB2YWx1ZSBvZiB0aGUgbW9kZWwKCQkvL3lvdSBjYW4gbm90IGNhbGwgYWZ0ZXJVcGRhdGUsIGJlY2F1c2UgdGhlcmUgbWlnaHQgdHJpZ2dlciBvdGhlciBub24tdmFsaWRhdG9yIGhhbmRsZXIKCQkvL3RoYXQgYXJlIGF0dGFjaGVkIHRvIGFmdGVyVXBkYXRlCgkJdmFyIGFsbFN1YnNjcmlwdGlvbnMgPSBobS5zdWJzY3JpcHRpb24uZ2V0QWxsKCk7CgkJdmFyIGNoZWNrVmFsaWRpdHlkUGF0aHMgPSB7fTsKCgkJZm9yICh2YXIgaSA9IGFsbFN1YnNjcmlwdGlvbnMubGVuZ3RoIC0gMSwgc3Vic2NyaXB0aW9uLCBwdWJsaXNoZXJQYXRoOyBpID49IDA7IGktLSkgewoKCQkJc3Vic2NyaXB0aW9uID0gYWxsU3Vic2NyaXB0aW9uc1tpXTsKCQkJcHVibGlzaGVyUGF0aCA9IHN1YnNjcmlwdGlvbi5wdWJsaXNoZXI7CgoJCQl2YXIgaXNWYWxpZGF0aW9uUmVxdWlyZWQgPQoJCQkJaXNTdHJpbmcoIHB1Ymxpc2hlclBhdGggKSAmJiAhY2hlY2tWYWxpZGl0eWRQYXRoc1twdWJsaXNoZXJQYXRoXSAmJgoJCQkJcHVibGlzaGVyUGF0aC5zdGFydHNXaXRoKCBwYXRoICkgJiYKCQkJCXN1YnNjcmlwdGlvbi5ldmVudFR5cGVzLmNvbnRhaW5zKCAiY2hlY2tWYWxpZGl0eSIgKTsKCgkJCWlmIChpc1ZhbGlkYXRpb25SZXF1aXJlZCkgewoKCQkJCWNoZWNrVmFsaWRpdHlkUGF0aHNbcHVibGlzaGVyUGF0aF0gPSB0cnVlOwoJCQkJY2FsbGJhY2soIHB1Ymxpc2hlclBhdGggKTsKCgkJCX0KCQl9Cgl9CgoJZnVuY3Rpb24gaXNFbXB0eVN0cmluZyggdmFsdWUgKSB7CgkJcmV0dXJuIHZhbHVlID09PSBudWxsIHx8IHZhbHVlID09PSB1bmRlZmluZWQgfHwgckVtcHR5LnRlc3QoIHZhbHVlICk7Cgl9CgovLwovLzxAZGVwZW5kcz5zdWJzY3JpcHRpb24uanMsIG1vZGVsLmpzLCBkZWNsYXJhdGl2ZS5qcywgdGVtcGxhdGUuanM8L0BkZXBlbmRzPgoKCgkvL3RoZSBjb252ZW50aW9uIGhlcmUgaXMgdGhhdCAsCgkvLyB1c2Ugcm93VmlldyBmb3IgdGhlIHJvdyBpbiB2aWV3CgkvL3VzZSBpdGVtIGZvciB0aGUgaXRlbSBpbiBtb2RlbCBhcnJheQoKCWhtLndvcmtmbG93KCB7CgoJCS8vLS0tLS0tLS0tLXdvcmtmbG93IHR5cGUgd2hpY2ggbW9kaWZ5IHJvdyBpbiBsaXN0IHZpZXctLS0tLS0tLS0tLQoKCQkvLyFhZnRlckNyZWF0ZS4xOmFycmF5fCphZGRSb3dWaWV3OwoJCWFkZFJvd1ZpZXc6IG5ld1RlbXBsYXRlSGFuZGxlcigKCgkJCS8vdGhlIHJlYXNvbiB0byB1c2UgZ2V0T3JpZ2luYWwgaXMgdGhhdAoJCQkvL3RoZSBzdWJzY3JpcHRpb24gaXMgdGhlIGl0ZW1zIGFycmF5CgkJCS8vYnV0IGhlcmUgd2Ugd2FudCB0byB0aGUgZWxlbQoJCQkiKmdldE9yaWdpbmFsIiwKCgkJCWZ1bmN0aW9uKCByb3dWaWV3LCBlICkgewoKCQkJCXZhciByb3dDb250YWluZXIgPSB0aGlzLAoJCQkJCXJvd3MgPSByb3dDb250YWluZXIuY2hpbGRyZW4oKTsKCgkJCQlpZiAocm93cy5sZW5ndGggPT09IDApIHsKCgkJCQkJcm93Q29udGFpbmVyLmFwcGVuZCggcm93VmlldyApOwoKCQkJCX0gZWxzZSB7CgoJCQkJCS8vdGhlIGluc2VydCBtYXkgbm90IGhhcHBlbiBhdCB0aGUgZW5kIG9mIHRoZSBhcnJheQoJCQkJCS8vYXQgY2FuIGJlIGluc2VydCBpbiB0aGUgbWlkZGxlLCBzbwoJCQkJCS8vd2UgY2FuIG5vdCBzaW1wbHkgZG8gc3Vic2NyaWJlci5hcHBlbmQoKQoJCQkJCS8vd2UgbmVlZCB0byBhcHBlbmQgdGhlIHJvdyB2aWV3IGF0IHRoZSBpbmRleAoJCQkJCXZhciBpbmRleCA9ICtlLm9yaWdpbmFsUHVibGlzaGVyLnBhdGhJbmRleCgpOwoKCQkJCQkvL3JvdyB6ZXJvIGlzIHNwZWNpYWwsIG5lZWQgdG8gdXNlIGJlZm9yZSBtZXRob2QKCQkJCQlpZiAoaW5kZXggPT09IDApIHsKCgkJCQkJCXJvd3MuZXEoIDAgKS5iZWZvcmUoIHJvd1ZpZXcgKTsKCQkJCQl9IGVsc2UgewoJCQkJCQlyb3dzLmVxKCBpbmRleCAtIDEgKS5hZnRlciggcm93VmlldyApOwoJCQkJCX0KCQkJCX0KCQkJfQoJCSksCgoJCS8vIWFmdGVyVXBkYXRlLjE6YXJyYXl8KnVwZGF0ZVJvd1ZpZXcKCQl1cGRhdGVSb3dWaWV3OiBuZXdUZW1wbGF0ZUhhbmRsZXIoCgoJCQkiKmdldE9yaWdpbmFsIiwKCgkJCWZ1bmN0aW9uKCB2YWx1ZSwgZSApIHsKCQkJCXRoaXMuY2hpbGRyZW4oKS5lcSggK2Uub3JpZ2luYWxQdWJsaXNoZXIucGF0aEluZGV4KCkgKS5yZXBsYWNlV2l0aCggdmFsdWUgKTsKCQkJfSApLAoKCQkvLyFhZnRlckRlbC4xOmFycmF5fCpyZW1vdmVSb3dWaWV3OwoJCXJlbW92ZVJvd1ZpZXc6IGZ1bmN0aW9uKCBlICkgewoJCQl0aGlzLmNoaWxkcmVuKCkuZXEoICtlLm9yaWdpbmFsUHVibGlzaGVyLnBhdGhJbmRleCgpICkucmVtb3ZlKCk7CgkJfQoKCgl9ICk7CgoJLy9hdXRvUXVlcnkgbWVhbnMgdXNlciBkb24ndCBuZWVkIHRvIHRyaWdnZXIgc2VhcmNoIGJ1dHRvbgoJLy9xdWVyeSByZXN1bHQgd2lsbCBhdXRvbWF0aWNhbGx5IHVwZGF0ZWQgd2hlbgoJLy9xdWVyeSBjaGFuZ2UsIGJ5IGRlZmF1bHQgaXQgaXMgZmFsc2UKCS8vd2hpY2ggbWVhbnMgdXNlciBoYXMgcmVmcmVzaFF1ZXJ5IG1hbnVhbGx5CglobUZuLmVuYWJsZVF1ZXJ5ID0gZnVuY3Rpb24oIGF1dG9RdWVyeSApIHsKCgkJaWYgKHRoaXMuZ2V0KCAiKnF1ZXJ5IiApKSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJdmFyIHF1ZXJ5YWJsZSwKCQkJcXVlcnksCgkJCXNvcnQsCgkJCXBhZ2VyLAoJCQlmaWx0ZXJGbiwKCQkJZmlsdGVyLAoJCQlpdGVtcyA9IHRoaXMuZ2V0KCksCgkJCXF1ZXJ5Tm9kZSA9IHRoaXMuY2QoICIqcXVlcnkiICksCgkJCXF1ZXJ5UmVzdWx0Tm9kZSA9IHRoaXMuY2QoICIqcXVlcnlSZXN1bHQiICksCgkJCWhhc1F1ZXJ5UmVzdWx0Tm9kZSA9IHRoaXMuY2QoICIqaGFzUXVlcnlSZXN1bHQiICksCgkJCXBhZ2VyTm9kZSA9IHF1ZXJ5Tm9kZS5jZCggInBhZ2VyIiApLAoJCQlmaWx0ZXJOb2RlID0gcXVlcnlOb2RlLmNkKCAiZmlsdGVyIiApLAoJCQlmaWx0ZXJFbmFibGVkTm9kZSA9IGZpbHRlck5vZGUuY2QoICJlbmFibGVkIiApLAoJCQlzb3J0Tm9kZSA9IHF1ZXJ5Tm9kZS5jZCggInNvcnQiICk7CgoJCWF1dG9RdWVyeSA9ICEhYXV0b1F1ZXJ5OwoKCQlpZiAoYXV0b1F1ZXJ5KSB7CgkJCS8vaXRlbXMqcXVlcnlSZXN1bHQgLS0tcmVmZXJlbmNpbmctLT4gaXRlbXMqcXVlcnkKCQkJcXVlcnlSZXN1bHROb2RlLndhdGNoKCBxdWVyeU5vZGUucGF0aCApOwoJCX0KCgkJLy9pdGVtcypxdWVyeVJlc3VsdCAtLT4gaXRlbXMKCQlxdWVyeVJlc3VsdE5vZGUud2F0Y2goIHRoaXMucGF0aCApOwoKCQl0aGlzLmV4dGVuZCgKCQkJIioiLAoJCQlxdWVyeWFibGUgPSB7CgoJCQkJLy9pZiBpdCBpcyB0cnVlLCByZWZyZXNoUXVlcnkgaXMgYnlwYXNzZWQKCQkJCWF1dG9RdWVyeTogYXV0b1F1ZXJ5LAoKCQkJCWhhc1F1ZXJ5UmVzdWx0OiBmYWxzZSwKCgkJCQkvL3RoZSBvYmplY3QgaG9sZGluZyB0aGUgZGF0YSBhYm91dCBwYWdpbmcsIHNvcnRpbmcsIGFuZCBmaWx0ZXJpbmcKCQkJCXF1ZXJ5OiBxdWVyeSA9IHsKCQkJCQlwYWdlcjogcGFnZXIgPSB7CgkJCQkJCWVuYWJsZWQ6IGZhbHNlLAoJCQkJCQlpbmRleDogMCwgLy9udGggcGFnZQoJCQkJCQljb3VudDogMSwKCQkJCQkJc2l6ZTogMAoJCQkJCX0sCgkJCQkJc29ydDogc29ydCA9IHsKCQkJCQkJYnk6IG51bGwsIC8vY3VycmVudGx5IHdlIG9ubHkgc3VwcG9ydCBzb3J0IGJ5IG9uZSBjb2x1bW4gc29ydAoJCQkJCQlhc2M6IG51bGwKCQkJCQl9LAoJCQkJCWZpbHRlcjogZmlsdGVyID0gewoJCQkJCQlieTogIiIsCgkJCQkJCXZhbHVlOiAiIiwKCQkJCQkJb3BzOiAiIiwKCQkJCQkJZW5hYmxlZDogZmFsc2UKCQkJCQl9LAoJCQkJCS8vaXMgcXVlcnkgZW5hYmxlZAoJCQkJCWVuYWJsZWQ6IGZ1bmN0aW9uKCkgewoJCQkJCQlyZXR1cm4gdGhpcy5nZXQoICJwYWdlci5lbmFibGVkIiApIHx8IHRoaXMuZ2V0KCAic29ydC5ieSIgKSB8fCB0aGlzLmdldCggImZpbHRlci5lbmFibGVkIiApOwoJCQkJCX0KCQkJCX0sCgoJCQkJcXVlcnlSZXN1bHQ6IGZ1bmN0aW9uKCBkaXNhYmxlUGFnaW5nICkgewoKCQkJCQkvLyJ0aGlzIiByZWZlcnMgdG8gdGhlIHF1ZXJ5YWJsZSBub2RlIGJ1dCBub3QgdGhlIHF1ZXJ5YWJsZSBvYmplY3QKCQkJCQl2YXIgJGl0ZW1zID0gJCggaXRlbXMgKSwKCgkJCQkJLy9ydW4gZmlsdGVyCgkJCQkJCXJ0biA9IGZpbHRlckZuID8gJGl0ZW1zLmZpbHRlciggZmlsdGVyRm4gKS5nZXQoKSA6ICRpdGVtcy5nZXQoKTsKCgkJCQkJaGFzUXVlcnlSZXN1bHROb2RlLnVwZGF0ZSggcnRuLmxlbmd0aCA+IDAgKTsKCgkJCQkJLy9ydW4gc29ydAoJCQkJCWlmIChzb3J0LmJ5KSB7CgoJCQkJCQlydG4uc29ydE9iamVjdCggc29ydC5ieSwgc29ydC5hc2MgKTsKCQkJCQl9CgoJCQkJCS8vcnVuIHBhZ2luZwoJCQkJCWlmICghZGlzYWJsZVBhZ2luZyAmJiBwYWdlci5lbmFibGVkKSB7CgkJCQkJCXZhciBjb3VudCA9IE1hdGguY2VpbCggcnRuLmxlbmd0aCAvIHBhZ2VyLnNpemUgKSB8fCAxOwoJCQkJCQlpZiAoY291bnQgIT0gcGFnZXIuY291bnQpIHsKCQkJCQkJCXBhZ2VyLmNvdW50ID0gY291bnQ7CgkJCQkJCQlpZiAocGFnZXIuaW5kZXggPiBwYWdlci5jb3VudCAtIDEpIHsKCQkJCQkJCQlwYWdlci5pbmRleCA9IDA7CgkJCQkJCQl9CgkJCQkJCQkvLwoJCQkJCQkJcXVlcnlOb2RlLmNoYW5nZSggInBhZ2VyIiApOwoJCQkJCQl9CgkJCQkJCXJ0biA9IHJ0bi5zbGljZSggcGFnZXIuaW5kZXggKiBwYWdlci5zaXplLCAocGFnZXIuaW5kZXggKyAxKSAqIHBhZ2VyLnNpemUgKTsKCQkJCQl9CgoJCQkJCXJldHVybiBydG47CgkJCQl9LAoKCQkJCS8vIHJlZnJlc2hRdWVyeSBjYW4gYmUgY2FsbGVkIHZpYSBxdWVyeWFibGUucmVmcmVzaFF1ZXJ5KCkKCQkJCS8vb3IgaXQgY2FuIGJlIGNhbGxlZCB2aWEgbm9kZSBsaWtlIGl0ZW1zKnJlZnJlc2hRdWVyeQoJCQkJLy8KCQkJCS8vIHJlZnJlc2hRdWVyeSBjYW4gYmUgY2FsbGVkIHJlZ2FyZGxlc3Mgd2hldGhlciBhdXRvUXVlcnkgaXMgZW5hYmxlZCwKCQkJCS8vIGJlY2F1c2UgaW50ZXJuYWxseSBpdCBjaGVjayB0aGUgZmxhZyB0byBkZXRlcm1pbmUgaWYKCQkJCS8vIGl0IGlzIG5lY2Vzc2FyeSB0byB0cmlnZ2VyIHRoZSBjaGFuZ2UgZXZlbnQKCQkJCXJlZnJlc2hRdWVyeTogZnVuY3Rpb24oKSB7CgkJCQkJLy9pZiBhdXRvUXVlcnkgaXMgdHJ1ZSwgdGhlbiBkb24ndCBuZWVkIHRvIHRyaWdnZXIgY2hhbmdlIGFnYWluCgkJCQkJaWYgKCFxdWVyeWFibGUuYXV0b1F1ZXJ5KSB7CgkJCQkJCXNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCQkJCQkJcXVlcnlSZXN1bHROb2RlLnRyaWdnZXIoICJhZnRlclVwZGF0ZSIgKTsKCQkJCQkJfSwgMCApOwoJCQkJCX0KCQkJCX0sCgoJCQkJcGFnaW5nOiBmdW5jdGlvbiggZSApIHsKCgkJCQkJdmFyIGluZGV4ID0gZS5ldmVudERhdGE7CgoJCQkJCWlmIChyRGlnaXQudGVzdCggaW5kZXggKSkgewoKCQkJCQkJaW5kZXggPSAraW5kZXg7CgoJCQkJCX0gZWxzZSB7CgoJCQkJCQlpZiAoaW5kZXggPT0gIm5leHQiKSB7CgoJCQkJCQkJaW5kZXggPSBwYWdlci5pbmRleCArIDE7CgoJCQkJCQl9IGVsc2UgaWYgKGluZGV4ID09ICJwcmV2aW91cyIpIHsKCgkJCQkJCQlpbmRleCA9IHBhZ2VyLmluZGV4IC0gMTsKCgkJCQkJCX0gZWxzZSBpZiAoaW5kZXggPT0gImZpcnN0IikgewoKCQkJCQkJCWluZGV4ID0gMDsKCgkJCQkJCX0gZWxzZSBpZiAoaW5kZXggPT0gImxhc3QiKSB7CgoJCQkJCQkJaW5kZXggPSBwYWdlci5jb3VudCAtIDE7CgoJCQkJCQl9IGVsc2UgaWYgKGluZGV4ID09ICJkaXNhYmxlZCIpIHsKCQkJCQkJCWluZGV4ID0gMDsKCQkJCQkJCXF1ZXJ5YWJsZS5yZXNldFBhZ2luZygpOwoJCQkJCQl9CgkJCQkJfQoKCQkJCQlpZiAodHlwZW9mIGluZGV4ICE9PSAibnVtYmVyIiB8fCBpbmRleCA8IDAgfHwgaW5kZXggPiBwYWdlci5jb3VudCAtIDEpIHsKCQkJCQkJaW5kZXggPSAwOwoJCQkJCX0KCgkJCQkJcGFnZXJOb2RlLnVwZGF0ZSggImluZGV4IiwgaW5kZXggKTsKCQkJCQlxdWVyeWFibGUucmVmcmVzaFF1ZXJ5KCk7CgkJCQl9LAoKCQkJCXJlc2V0U29ydDogZnVuY3Rpb24oIHRyaWdnZXJCeU1hc3RlclJlc2V0ICkgewoJCQkJCXNvcnROb2RlLnNldCggImJ5IiwgbnVsbCApCgkJCQkJCS5zZXQoICJhc2MiLCBudWxsICk7CgoJCQkJCWlmICh0cmlnZ2VyQnlNYXN0ZXJSZXNldCAhPT0gdHJ1ZSkgewoJCQkJCQlxdWVyeWFibGUucmVmcmVzaFF1ZXJ5KCk7CgkJCQkJfQoJCQkJfSwKCgkJCQlyZXNldFNlYXJjaDogZnVuY3Rpb24oIHRyaWdnZXJCeU1hc3RlclJlc2V0ICkgewoJCQkJCWZpbHRlck5vZGUudXBkYXRlKCAiYnkiLCAiIiApCgkJCQkJCS51cGRhdGUoICJ2YWx1ZSIsICIiICkKCQkJCQkJLnVwZGF0ZSggIm9wcyIsICIiICk7CgoJCQkJCWlmICh0cmlnZ2VyQnlNYXN0ZXJSZXNldCAhPT0gdHJ1ZSkgewoJCQkJCQlxdWVyeWFibGUucmVmcmVzaFF1ZXJ5KCk7CgkJCQkJfQoKCQkJCX0sCgoJCQkJcmVzZXRQYWdpbmc6IGZ1bmN0aW9uKCB0cmlnZ2VyQnlNYXN0ZXJSZXNldCApIHsKCQkJCQlwYWdlck5vZGUudXBkYXRlKCAiZW5hYmxlZCIsIGZhbHNlICkKCQkJCQkJLnVwZGF0ZSggInNpemUiLCAwICkKCQkJCQkJLnVwZGF0ZSggImNvdW50IiwgMSApCgkJCQkJCS51cGRhdGUoICJpbmRleCIsIDAgKTsKCgkJCQkJaWYgKHRyaWdnZXJCeU1hc3RlclJlc2V0ICE9PSB0cnVlKSB7CgkJCQkJCXF1ZXJ5YWJsZS5yZWZyZXNoUXVlcnkoKTsKCQkJCQl9CgoJCQkJfSwKCgkJCQlyZXNldFF1ZXJ5OiBmdW5jdGlvbigpIHsKCQkJCQlxdWVyeWFibGUucmVzZXRTb3J0KCB0cnVlICk7CgkJCQkJcXVlcnlhYmxlLnJlc2V0U2VhcmNoKCB0cnVlICk7CgkJCQkJcXVlcnlhYmxlLnJlc2V0UGFnaW5nKCB0cnVlICk7CgkJCQkJcXVlcnlhYmxlLnJlZnJlc2hRdWVyeSgpOwoJCQkJfQoJCQl9CgkJKTsKCgkJZnVuY3Rpb24gYnVpbGRGaWx0ZXJGbiggZSApIHsKCQkJdmFyIG9wcyA9IGZpbHRlci5vcHMsCgkJCQlieSA9IGZpbHRlci5ieSwKCQkJCXZhbHVlID0gZmlsdGVyLnZhbHVlLAoJCQkJcmVnZXg7CgoJCQlpZiAodmFsdWUpIHsKCgkJCQlpZiAoIW9wcykgewoJCQkJCS8vYnkgZGVmYXVsdCBpdCBzIGNvbnRhaW5zCgkJCQkJcmVnZXggPSBSZWdFeHAoIHZhbHVlLCAiaSIgKTsKCgkJCQl9IGVsc2UgaWYgKG9wcyA9PSAiZXF1YWxzIikgewoKCQkJCQlyZWdleCA9IFJlZ0V4cCggIl4iICsgdmFsdWUgKyAiJCIsICJpIiApOwoKCQkJCX0gZWxzZSB7CgoJCQkJCXRocm93ICJvcGVyYXRvciBkb2VzIG5vdCBzdXBwb3J0ZWQiOwoJCQkJfQoKCQkJCWZpbHRlckZuID0gKGJ5KSA/CgkJCQkJZnVuY3Rpb24oKSB7CgkJCQkJCXJldHVybiByZWdleC50ZXN0KCB0aGlzW2J5XSApOwoJCQkJCX0gOgoJCQkJCWZ1bmN0aW9uKCkgewoJCQkJCQlpZiAoaXNPYmplY3QoIHRoaXMgKSkgewoJCQkJCQkJZm9yICh2YXIga2V5IGluIHRoaXMpIHsKCQkJCQkJCQlpZiAocmVnZXgudGVzdCggdGhpc1trZXldICkpIHsKCQkJCQkJCQkJcmV0dXJuIHRydWU7CgkJCQkJCQkJfQoJCQkJCQkJfQoJCQkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJCQl9IGVsc2UgewoJCQkJCQkJcmV0dXJuIHJlZ2V4LnRlc3QoIHRoaXMgKTsKCQkJCQkJfQoJCQkJCX07CgoJCQkJZmlsdGVyRW5hYmxlZE5vZGUuc2V0KCB0cnVlICk7CgkJCQlxdWVyeWFibGUucmVmcmVzaFF1ZXJ5KCk7CgkJCX0gZWxzZSB7CgkJCQlpZiAoZmlsdGVyRm4pIHsKCQkJCQlmaWx0ZXJGbiA9IG51bGw7CgkJCQkJZmlsdGVyRW5hYmxlZE5vZGUuc2V0KCBmYWxzZSApOwoJCQkJCXF1ZXJ5YWJsZS5yZWZyZXNoUXVlcnkoKTsKCQkJCX0KCQkJfQoJCX0KCgkJZmlsdGVyTm9kZS5jZCggImJ5IiApLmhhbmRsZSggImFmdGVyVXBkYXRlIiwgYnVpbGRGaWx0ZXJGbiApOwoJCWZpbHRlck5vZGUuY2QoICJ2YWx1ZSIgKS5oYW5kbGUoICJhZnRlclVwZGF0ZSIsIGJ1aWxkRmlsdGVyRm4gKTsKCQlmaWx0ZXJOb2RlLmNkKCAib3BzIiApLmhhbmRsZSggImFmdGVyVXBkYXRlIiwgYnVpbGRGaWx0ZXJGbiApOwoJCXJldHVybiB0aGlzOwoJfTsKCgliaW5kaW5ncyggewoKCQkvL2xpc3RWaWV3OmFycmF5UGF0aHxyb3dUZW1wbGF0ZUlkCgkJLy8KCQlsaXN0VmlldzogLy8KCgkJLy9zdWJzY3JpcHRpb24gZnJvbSB2aWV3CgkJCSJ0bXBsT25DaGFuZ2U6LjsiICsKCQkJCS8vcmVuZGVyIG5ld2x5IGFwcGVuZGVkIGRhdGEgaXRlbSBieSBhcHBlbmRpbmcgaXQgdG8gZW5kIG9mIHRoZSB2aWV3CgkJCSIhYWZ0ZXJDcmVhdGUuMToufCphZGRSb3dWaWV3OyIgKwoJCQkJLy9yZW5kZXIgdGhlIHVwZGF0ZWQgZGF0YSBpdGVtIGluIHRoZSB2aWV3CgkJCSIhYWZ0ZXJVcGRhdGUuMToufCp1cGRhdGVSb3dWaWV3OyIgKwoJCQkJLy9kZWxldGUgdGhlIGRlbGV0ZWQgZGF0YSBpdGVtIGluIHRoZSB2aWV3CgkJCSIhYWZ0ZXJEZWwuMToufCpyZW1vdmVSb3dWaWV3IiwKCgkJZW5hYmxlUXVlcnk6IGZ1bmN0aW9uKCBlbGVtLCBwYXRoLCBjb250ZXh0LCBvcHRpb25zICkgewoJCQlobSggcGF0aCApLmVuYWJsZVF1ZXJ5KCAhIW9wdGlvbnMgKTsKCQl9LAoKCQkvL3JlbmRlciB0aGUgd2hvbGUgbGlzdCBvZiBpdGVtcwoJCS8vcXVlcnlWaWV3Oml0ZW1zCgkJcXVlcnlWaWV3OiAidG1wbE9uQW55Q2hhbmdlOipxdWVyeVJlc3VsdCIsCgoJCS8vc29ydDppdGVtc3xmaXJzdE5hbWUKCQlzb3J0UXVlcnk6ICIkY2xpY2s6KnF1ZXJ5LnNvcnQuYnl8KnNldFRvOyIgKwoJCSAgICAgICAgICAgICAgICAgIiRjbGljazoqcXVlcnkuc29ydC5hc2N8KnRvZ2dsZTsiICsKCQkgICAgICAgICAgICAgICAgICIkY2xpY2s6KnJlZnJlc2hRdWVyeSIsCgoJCS8vcmVzZXRTb3J0Oml0ZW1zCgkJcmVzZXRTb3J0OiAiJGNsaWNrOipyZXNldFNvcnQ7IiArCgkJICAgICAgICAgICAgICAgICAic2hvdzoqcXVlcnkuc29ydC5ieSIsCgoJCS8vc2VhcmNoOml0ZW1zCgkJc2VhcmNoOiAiJGNsaWNrOipyZWZyZXNoUXVlcnk7IiArCgkJICAgICAgICAgICAgICAiZW5hYmxlOipxdWVyeS5maWx0ZXIuZW5hYmxlZCIsCgoJCXJlc2V0U2VhcmNoOiAiJGNsaWNrOipyZXNldFNlYXJjaDsiICsKCQkgICAgICAgICAgICAgICAgICAgInNob3c6KnF1ZXJ5LmZpbHRlci5lbmFibGVkIiwKCgkJcmVzZXRRdWVyeTogIiRjbGljazoqcmVzZXRRdWVyeTsiICsKCQkgICAgICAgICAgICAgICAgICAic2hvdzoqcXVlcnkuZW5hYmxlZCIsCgoJCXNlYXJjaEJveDogIm5zOipxdWVyeS5maWx0ZXIudmFsdWU7IiArCgkJICAgICAgICAgICAidmFsOi58ZW50ZXI7IiArCgkJICAgICAgICAgICAiJGVzYzoufCpudWxsIiwKCgkJLy9wYWdlcjppdGVtc3wjcGFnZXJUZW1wbGF0ZQoJCXBhZ2VyOiAidG1wbE9uQW55Q2hhbmdlOipxdWVyeS5wYWdlcjsiICsgLy9yZW5kZXIgcGFnZXIgdXNpbmcgdGhlIGRhdGEgdW5kZXIgaXRlbXMqcXVlcnkucGFnZXIKCQkgICAgICAgInNob3c6Kmhhc1F1ZXJ5UmVzdWx0fF87IiArCgkJICAgICAgICIkcGFnaW5nOipwYWdpbmc7IiArCgkJICAgICAgICJwcmV2ZW50RGVmYXVsdDouIiwKCgkJc2V0UGFnZTogInRydWU6KnF1ZXJ5LnBhZ2VyLmVuYWJsZWQ7IiArCgkJICAgICAgICAgICAgICAgImVuYWJsZToqcXVlcnkucGFnZXIuc2l6ZTsiICsKCQkgICAgICAgICAgICAgICAiJGNsaWNrOipyZWZyZXNoUXVlcnkiLAoKCQkvL3BhdGggaXMgaWdub3JlLCBkb2VzIG5vdCBjcmVhdGUgYW55IHN1YnNjcmlwdGlvbgoJCXBhZ2U6IGZ1bmN0aW9uKCBlbGVtLCBwYXRoLCBiaW5kaW5nLCBwYWdlSW5kZXggKSB7CgkJCWlmICghcGFnZUluZGV4KSB7CgkJCQl0aHJvdyAicGFnZUluZGV4IGlzIG1pc3NpbmciOwoJCQl9CgkJCSQoIGVsZW0gKS5tYXBFdmVudCggImNsaWNrIiwgInBhZ2luZyIsIHBhZ2VJbmRleCApOwoJCX0sCgoJCXNob3dGb3VuZDogInNob3c6Kmhhc1F1ZXJ5UmVzdWx0IiwKCgkJaGlkZUZvdW5kOiAiaGlkZToqaGFzUXVlcnlSZXN1bHQiCgl9ICk7CgoKCi8vCi8qCiA8QGRlcGVuZHM+CiBzdWJzY3JpcHRpb24uanMsCiBtb2RlbC5qcwogPC9AZGVwZW5kcz4KICovCgoKCS8vY3JlYXRlIGEgdGFibGUgd2l0aCBzb21lIHNlZWRzCglmdW5jdGlvbiBjcmVhdGVUYWJsZSggc2VlZHMgKSB7CgkJaWYgKGlzVW5kZWZpbmVkKCBzZWVkcyApKSB7CgkJCXNlZWRzID0gW107CgkJfSBlbHNlIGlmICghaXNBcnJheSggc2VlZHMgKSkgewoJCQlzZWVkcyA9IFtzZWVkc107CgkJfQoKCQlpZiAoc2VlZHMudGFibGUgJiYgc2VlZHMuZ3VpZCkgewoJCQlyZXR1cm4gc2VlZHM7CgkJfQoKCQlzZWVkcy50YWJsZSA9IHt9OwoJCXNlZWRzLmd1aWQgPSAwOwoJCXJldHVybiBzZWVkczsKCX0KCglmdW5jdGlvbiBoYW5kbGVBcnJheU5vZGVVcGRhdGVEZXNjZW5kYW50KCBlICkgewoKCQl2YXIgdGFibGUsCgkJCXB1Ymxpc2hlciA9IGUucHVibGlzaGVyOwoKCQlpZiAoZS5sZXZlbCA9PT0gMSkgewoJCQl0YWJsZSA9IHB1Ymxpc2hlci5nZXQoKS50YWJsZTsKCgkJCS8vdGhlIGV2ZW50IGlzIGNhdXNlZCBieSB1cGRhdGluZyB0byB0aGUgYW4gaXRlbSBpZiB0aGUgYXJyYXkKCQkJZm9yICh2YXIga2V5IGluIHRhYmxlKSB7CgkJCQlpZiAodGFibGVba2V5XSA9PSBlLnJlbW92ZWQpIHsKCQkJCQl0aGlzLnNldCgga2V5LCBlLnByb3Bvc2VkICk7CgkJCQkJYnJlYWs7CgkJCQl9CgkJCX0KCgkJfSBlbHNlIGlmIChlLmxldmVsID49IDIpIHsKCgkJCXZhciBvcmlnaW5hbFBhdGggPSBlLm9yaWdpbmFsUHVibGlzaGVyLnBhdGgsCgkJCQlwYXRoID0gcHVibGlzaGVyLnBhdGgsCgkJCQlyZW1haW5pbmcgPSBvcmlnaW5hbFBhdGguc3Vic3RyKCBwYXRoLmxlbmd0aCArIDEgKSwKCQkJCWluZGV4ID0gcmVtYWluaW5nLnN1YnN0ciggMCwgcmVtYWluaW5nLmluZGV4T2YoICIuIiApICk7CgoJCQlpZiAoJC5pc051bWVyaWMoIGluZGV4ICkpIHsKCgoJCQkJLy9lLmcgY29udGFjdHMuMS5maXJzdE5hbWUgaXMgdXBkYXRlZAoJCQkJLy9pbmRleCA9PSAxCgkJCQkvL2l0ZW1LZXkgPSBjMQoKCQkJCXZhciBpdGVtS2V5ID0gcHVibGlzaGVyLmtleUF0KCBpbmRleCApLAoJCQkJCWZ1bGxQYXRoT2ZLZXlJdGVtID0gInRhYmxlLiIgKyBpdGVtS2V5ICsgcmVtYWluaW5nLnN1YnN0ciggcmVtYWluaW5nLmluZGV4T2YoICIuIiApICk7CgoJCQkJLy9zdWJQYXRoID09IHRhYmxlLmMxLmZpcnN0TmFtZQoJCQkJcHVibGlzaGVyLnRyaWdnZXIoIGZ1bGxQYXRoT2ZLZXlJdGVtLCAiYWZ0ZXJVcGRhdGUiLCBlLnByb3Bvc2VkLCBlLnJlbW92ZWQgKTsKCQkJfQoJCX0KCX0KCglmdW5jdGlvbiBoYW5kbGVBcnJheU5vZGVDcmVhdGVDaGlsZCggZSApIHsKCQl0aGlzLnNldCggZS5wdWJsaXNoZXIuZ2V0KCkuZ3VpZCsrLCBlLnByb3Bvc2VkICk7Cgl9CgoJZnVuY3Rpb24gaGFuZGxlQXJyYXlOb2RlRGVsZXRlQ2hpbGQoIGUgKSB7CgkJdmFyIHRhYmxlID0gdGhpcy5nZXQoKSwKCQkJcmVtb3ZlZCA9IGUucmVtb3ZlZDsKCgkJZm9yICh2YXIga2V5IGluIHRhYmxlKSB7CgkJCWlmICh0YWJsZVtrZXldID09PSByZW1vdmVkKSB7CgkJCQl0aGlzLmRlbCgga2V5ICk7CgkJCQlicmVhazsKCQkJfQoJCX0KCX0KCglmdW5jdGlvbiBoYW5kbGVUYWJsZU5vZGVEZWxldGVDaGlsZCggZSApIHsKCQl0aGlzLnJlbW92ZUl0ZW0oIGUucmVtb3ZlZCApOwoJfQoKCWZ1bmN0aW9uIGhhbmRsZVRhYmxlTm9kZVVwZGF0ZUNoaWxkKCBlICkgewoJCXRoaXMucmVwbGFjZUl0ZW0oIGUucmVtb3ZlZCwgZS5wcm9wb3NlZCApOwoJfQoKCS8vCQkJb25BZGRPclVwZGF0ZUhhbmRsZXJzW2ldKCBjb250ZXh0UGF0aCwgaW5kZXhQYXRoLCBtb2RlbFZhbHVlICk7CglobS5vbkFkZE9yVXBkYXRlTm9kZSggZnVuY3Rpb24oIGNvbnRleHQsIGluZGV4LCBhcnJheSApIHsKCgkJaWYgKCFpc0FycmF5KCBhcnJheSApKSB7CgkJCXJldHVybjsKCQl9CgoJCXZhciB0YWJsZSA9IGNyZWF0ZVRhYmxlKCBhcnJheSApLnRhYmxlOwoKCQlmb3IgKHZhciBpID0gMDsgaSA8IGFycmF5Lmxlbmd0aDsgaSsrKSB7CgkJCXRhYmxlW2FycmF5Lmd1aWQrK10gPSBhcnJheVtpXTsKCQl9CgoJCXZhciBhcnJheU5vZGUgPSBobSggY29udGV4dCApLmNkKCBpbmRleCApLAoJCQl0YWJsZU5vZGUgPSBhcnJheU5vZGUuY2QoICJ0YWJsZSIgKTsKCgkJLy93aGVuIGl0ZW0gaXMgaW5zZXJ0ZWQgaW4gYXJyYXksIGluc2VydCB0aGUgaXRlbSBpbiB0YWJsZQoJCXRhYmxlTm9kZS5zdWIoIGFycmF5Tm9kZSwgImFmdGVyQ3JlYXRlLjEiLCBoYW5kbGVBcnJheU5vZGVDcmVhdGVDaGlsZCApOwoKCQkvL3doZW4gaXRlbSBpcyB1cGRhdGVkIGluIGl0ZW1zTm9kZSwgdXBkYXRlIHRoZSBpdGVtIGluIHRhYmxlCgkJdGFibGVOb2RlLnN1YiggYXJyYXlOb2RlLCAiYWZ0ZXJVcGRhdGUuKiIsIGhhbmRsZUFycmF5Tm9kZVVwZGF0ZURlc2NlbmRhbnQgKTsKCgkJLy93aGVuIGl0ZW0gZGVsZXRlZCBpbiBhcnJheSwgZGVsZXRlIHRoZSBpdGVtIGluIGhhc2ggdGFibGUKCQl0YWJsZU5vZGUuc3ViKCBhcnJheU5vZGUsICJhZnRlckRlbC4xIiwgaGFuZGxlQXJyYXlOb2RlRGVsZXRlQ2hpbGQgKTsKCgkJLy93aGVuIGl0ZW0gaXMgZGVsZXRlZCBpbiB0YWJsZSwgZGVsZXRlIHRoZSBpdGVtIGluIGFycmF5CgkJYXJyYXlOb2RlLnN1YiggdGFibGVOb2RlLCAiYWZ0ZXJEZWwuMSIsIGhhbmRsZVRhYmxlTm9kZURlbGV0ZUNoaWxkICk7CgoJCS8vd2hlbiBpdGVtIGlzIHVwZGF0ZWQgaW4gdGFibGUsIHVwZGF0ZSB0aGUgaXRlbSBpbiBhcnJheQoJCWFycmF5Tm9kZS5zdWIoIHRhYmxlTm9kZSwgImFmdGVyVXBkYXRlLjEiLCBoYW5kbGVUYWJsZU5vZGVVcGRhdGVDaGlsZCApOwoKCX0gKTsKCglobUZuLml0ZW1LZXkgPSBmdW5jdGlvbiggaXRlbSApIHsKCQl2YXIga2V5LAoJCQl0YWJsZSwKCQkJYXJyYXkgPSB0aGlzLnJhdygpOwoKCQlpZiAoaXNGdW5jdGlvbiggYXJyYXkgKSkgewoJCQlhcnJheSA9IHRoaXMubWFpbigpLmdldCgpOwoJCX0KCQl0YWJsZSA9IGFycmF5LnRhYmxlOwoKCQlpZiAodGFibGUpIHsKCQkJZm9yIChrZXkgaW4gdGFibGUpIHsKCQkJCWlmIChpdGVtID09PSB0YWJsZVtrZXldKSB7CgkJCQkJcmV0dXJuIGtleTsKCQkJCX0KCQkJfQoJCX0KCX07CgoJaG1Gbi5rZXlBdCA9IGZ1bmN0aW9uKCBpbmRleCApIHsKCQlyZXR1cm4gdGhpcy5pdGVtS2V5KCB0aGlzLmdldCggaW5kZXggKSApOwoJfTsKCgovLwovLzxAZGVwZW5kcz5zdWJzY3JpcHRpb24uanMsIG1vZGVsLmpzLCBkZWNsYXJhdGl2ZS5qcywgdGVtcGxhdGUuanM8L0BkZXBlbmRzPgoKCgkvL2F1Z21lbnQgalF1ZXJ5IEV2ZW50IHR5cGUKCS8vd2hlbiB5b3UgYXR0YWNoIGEgd29ya2Zsb3cgdG8gcGFyZW50IGVsZW1lbnQgdG8gaGFuZGxlIHRoZSBldmVudCBmcm9tIGNoaWxkcmVuCgkvL3dlIHdhbnQgdG8ga25vdyB0aGUgY2hpbGRyZW4gZWxlbWVudCdzIHJvdyBpbmRleCBvZiBhbGwgdGhlIHJvd3MKCSQuRXZlbnQucHJvdG90eXBlLnNlbGVjdGVkUm93SW5kZXggPSBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5wdWJsaXNoZXIuY2hpbGRyZW4oKS5maWx0ZXIoIHRoaXMub3JpZ2luYWxQdWJsaXNoZXIucGFyZW50cygpICkuaW5kZXgoKTsKCX07CgoJZnVuY3Rpb24gRWRpdE9iamVjdCggaW5kZXggKSB7CgkJdGhpcy5zZWxlY3RlZEluZGV4ID0gaW5kZXg7Cgl9CgoJRWRpdE9iamVjdC5wcm90b3R5cGUgPSB7CgkJaXRlbTogbnVsbCwKCQkvL2xvZ2ljYWxseSBtb2RlIGRlcGVuZHMgb24gIml0ZW0iIGFuZCAiaW5kZXgiCgkJLy9idXQgaGVyZSB3ZSBkaXNhYmxlIHRoZXNlIGRlcGVuZGVuY2llcywgYmVjYXVzZSB3ZSB3YW50IHRvCgkJLy9tYW51YWxseSB0cmlnZ2VyIHRoZSBldmVudHMKCQkvL2lmIGl0IHJlYWxseSBkZXBlbmRzIHRoZW0sIHRoZSBldmVudHMgd2lsbCBiZSBoYXJkIHRvIGNvbnRyb2xsZWQKCQltb2RlOiBmdW5jdGlvbiBfXygpIHsKCQkJdmFyIGVkaXQgPSB0aGlzLmdldCgpLAoJCQkJaXRlbSA9IGVkaXQuaXRlbSwKCQkJCXNlbGVjdGVkSW5kZXggPSBlZGl0LnNlbGVjdGVkSW5kZXg7CgoJCQlyZXR1cm4gaXRlbSA9PT0gbnVsbCA/ICJyZWFkIiA6CgkJCQlpc1VuZGVmaW5lZCggc2VsZWN0ZWRJbmRleCApID8gInVwZGF0ZSIgOgoJCQkJCShzZWxlY3RlZEluZGV4ID09IC0xKSA/ICJuZXciIDoKCQkJCQkJInVwZGF0ZSI7CgoJCX0KCX07CgoJLy90aGUgZm9sbG93IG1ldGhvZHMgYXJlIGRlc2lnbmVkIHRvIGJlIHVzZWQgd2l0aCBhcnJheSBtb2RlbAoJLy8gdGhleSBhcmUgdXNlZCB0byBtYW5pcHVsYXRlIHRoZSBzaGFkb3cgZWRpdCBvYmplY3Qgb2YgYXJyYXkgbW9kZWwKCWV4dGVuZCggaG1GbiwgewoKCQkvL2luaXRTaGFkb3dFZGl0IGlzIHJlcXVpcmVkIGZvciBhcnJheSBtb2RlbCBvciBmb3IgYXJyYXkgcXVlcnkgZnVuY3Rpb25zCgkJLy9pdCBpcyBub3QgbmVjZXNzYXJ5IGZvciBtb2RlbCBvZiBvdGhlciB0eXBlCgkJaW5pdFNoYWRvd0VkaXQ6IGZ1bmN0aW9uKCBpdGVtVGVtcGxhdGUgKSB7CgkJCS8vaXQgaXMgYSBjb252ZW50aW9uIHRoYXQsIGlmIHRoZSBwYXRoIG9mIGxpc3QgZGF0YSBpcyBpdGVtcwoJCQkvL3dlIHRha2UgaXRlbXNfaXRlbVRlbXBsYXRlIGFzIHRlbXBsYXRlIGZyb20gbmV3IGl0ZW0gZm9yIHRoZSBsaXN0IGRhdGEKCgkJCXZhciBtb2RlbCA9IHRoaXM7CgoJCQlpZiAobW9kZWwuZ2V0KCAiKmVkaXQiICkpIHsKCQkJCXJldHVybjsKCQkJfQoJCQl2YXIgaXRlbXNQYXRoID0gbW9kZWwucGF0aCwKCQkJCXJDaGlsZFNoYWRvd0l0ZW0gPSBSZWdFeHAoICJeIiArIGl0ZW1zUGF0aC5yZXBsYWNlKCAiLiIsICJcXC4iICkgKyAiXFwqZWRpdFxcLml0ZW1bXipdK1xcKiQiICksCgkJCQlyRGVlcFNoYWRvd0l0ZW0gPSBSZWdFeHAoICJeIiArIGl0ZW1zUGF0aC5yZXBsYWNlKCAiLiIsICJcXC4iICkgKyAiXFwqZWRpdFxcLml0ZW1bXFx3Ll0rXFwqZWRpdFxcLml0ZW0iICk7CgoJCQlpZiAoaXNVbmRlZmluZWQoIGl0ZW1UZW1wbGF0ZSApKSB7CgoJCQkJaWYgKG1vZGVsLmlzU2hhZG93KCkgJiYgIWlzRnVuY3Rpb24oIG1vZGVsLnJhdygpICkpIHsKCQkJCQkvL2lmIHRoZSBhcnJheSBvYmplY3QgaXRlbXMgaXMgYWxyZWFkeSBpbiBzaGFkb3cKCQkJCQkvL3RoZSBpdGVtVGVtcGxhdGUgaXMgYWxyZWFkeSBkZWZpbmVkIGluIG1haW4gaXRlbXMnIGl0ZW1UZW1wbGF0ZQoJCQkJCS8vZm9yIGV4YW1wbGUKCQkJCQkvL3RoZSBpdGVtc1BhdGggaXMgImRvYy5lbnRyaWVzKmVkaXQuaXRlbS5wZXJzb25hbC5zaWduYXR1cmVzIgoJCQkJCS8vdGhlIGl0ZW1UZW1wbGF0ZSBpcyBkZWZpbmVkIGluICJkb2MuZW50cmllcyplZGl0Lml0ZW0ucGVyc29uYWwuc2lnbmF0dXJlcy4wIgoJCQkJCS8vdGhlIGZvbGxvd2luZyBpcyB0cnkgdG8gZ2V0IHRoZSBpdGVtVGVtcGxhdGUKCQkJCQkvLwoJCQkJCS8vdGhlIG1haW5Nb2RlbCBpcyBkb2MuZW50cmllcwoJCQkJCXZhciBtYWluTW9kZWwgPSBtb2RlbC5tYWluKCk7CgoJCQkJCS8vdGhlIGVkaXRpbmdNb2RlbFBhdGggb2YgbWFpbk1vZGVsIGlzIGRvYy5lbnRyaWVzKmVkaXQuaXRlbQoJCQkJCXZhciBlZGl0aW5nTW9kZWxQYXRoID0gbWFpbk1vZGVsLmxvZ2ljYWxQYXRoKCkgKyAiKmVkaXQuaXRlbSI7CgoJCQkJCS8vdGhlIHBvc2l0aW9uIG9mIGxhc3QgIi4iIGluICJkb2MuZW50cmllcyplZGl0Lml0ZW0uIgoJCQkJCXZhciBzdGFydEluZGV4ID0gZWRpdGluZ01vZGVsUGF0aC5sZW5ndGggKyAxOwoKCQkJCQkvL3RoZSBwb3J0aW9uIG9mICJwZXJzb25hbC5zaWduYXR1cmVzIiBpbiAiZG9jLmVudHJpZXMqZWRpdC5pdGVtLnBlcnNvbmFsLnNpZ25hdHVyZXMiCgkJCQkJdmFyIHN1YlBhdGggPSB0b0xvZ2ljYWxQYXRoKCBpdGVtc1BhdGggKS5zdWJzdHIoIHN0YXJ0SW5kZXggKTsKCgkJCQkJLy9nZXQgImRvYy5lbnRyaWVzKmVkaXQuaXRlbVRlbXBsYXRlLnBlcnNvbmFsLnNpZ25hdHVyZXMuMCIKCQkJCQlpdGVtVGVtcGxhdGUgPSBjbG9uZSggbWFpbk1vZGVsLmdldCggIiplZGl0Lml0ZW1UZW1wbGF0ZS4iICsgc3ViUGF0aCArICIuMCIgKSwgdHJ1ZSApOwoKCQkJCX0gZWxzZSB7CgoJCQkJCS8vdGhlIGNvbnZlbnRpb24gaXMgdGhhdCBpZiB3ZSBoYXZlIG1vZGVsIGF0IHBhdGggImNvbnRhY3RzIiwKCQkJCQkvL3RoZSB0ZW1wbGF0ZSBpdGVtIGlzIGV4cGVjdGVkIGF0ICJjb250YWN0c19pdGVtVGVtcGxhdGUiCgkJCQkJaWYgKGlzRnVuY3Rpb24oIG1vZGVsLnJhdygpICkpIHsKCQkJCQkJaXRlbVRlbXBsYXRlID0gcm9vdE5vZGUucmF3KCBtb2RlbC5tYWluKCkucGF0aCArICJfaXRlbVRlbXBsYXRlIiApOwoJCQkJCX0gZWxzZSB7CgkJCQkJCWl0ZW1UZW1wbGF0ZSA9IHJvb3ROb2RlLnJhdyggaXRlbXNQYXRoICsgIl9pdGVtVGVtcGxhdGUiICk7CgkJCQkJfQoKCQkJCQkvL2lmIGNvbnZlbnRpb24gaXMgbm90IGZvbGxvd2VkLCB1c2UgdGhlIGV4aXN0aW5nIGFzIHRlbXBsYXRlCgkJCQkJaWYgKGlzVW5kZWZpbmVkKCBpdGVtVGVtcGxhdGUgKSkgewoJCQkJCQlpdGVtVGVtcGxhdGUgPSBjbGVhck9iaiggY2xvbmUoIG1vZGVsLmdldCgpWzBdLCB0cnVlICkgKTsKCQkJCQl9CgkJCQl9CgkJCX0KCgkJCXZhciBlZGl0T2JqZWN0ID0gbmV3IEVkaXRPYmplY3QoIC0xICk7CgkJCWVkaXRPYmplY3QuaXRlbVRlbXBsYXRlID0gaXRlbVRlbXBsYXRlOwoJCQllZGl0T2JqZWN0Lml0ZW0gPSBudWxsOwoKCQkJbW9kZWwuc2V0KCAiKmVkaXQiLCBlZGl0T2JqZWN0ICk7CgoJCQkvL3dlIHdhbnQgdG8gdHJpZ2dlciBiZWdpbkluUm93VXBkYXRlL2NhbmNlbEluUm93VXBkYXRlIGFmdGVyIHNlbGVjdGVkSW5kZXggaGFzIGNoYW5nZWQKCQkJLy9iZWNhdXNlIHRoZSBoYW5kbGVycyBkZXBlbmRzIG9uIHRoZSBhdmFpbGFiaWxpdHkgb2Ygc2VsZWN0ZWRJbmRleAoJCQltb2RlbC5jZCggIiplZGl0LnNlbGVjdGVkSW5kZXgiICkuaGFuZGxlKCAiYWZ0ZXJVcGRhdGUiLCBmdW5jdGlvbiggZSApIHsKCgkJCQl2YXIgbmV3SW5kZXggPSBlLnByb3Bvc2VkLAoJCQkJCW9sZEluZGV4ID0gZS5yZW1vdmVkOwoKCQkJCWlmIChuZXdJbmRleCA+PSAwKSB7CgoJCQkJCW1vZGVsLnRyaWdnZXIoICJiZWdpbkluUm93VXBkYXRlIiwgbmV3SW5kZXggKTsKCgkJCQl9IGVsc2UgaWYgKG5ld0luZGV4ID09IC0xKSB7CgoJCQkJCW1vZGVsLnRyaWdnZXIoICJjYW5jZWxJblJvd1VwZGF0ZSIsIG9sZEluZGV4ICk7CgkJCQl9CgkJCX0gKTsKCgkJCW1vZGVsLmNkKCAiKmVkaXQuaXRlbSIgKS5oYW5kbGUoICJhZnRlclVwZGF0ZSIsIGZ1bmN0aW9uKCBlICkgewoJCQkJdmFyIGtleSwgbG9naWNhbFBhdGgsIGVkaXRPYmplY3Q7CgoJCQkJZm9yIChrZXkgaW4gc2hhZG93Um9vdCkgewoKCQkJCQlsb2dpY2FsUGF0aCA9IHV0aWwudG9Mb2dpY2FsUGF0aCggIl9faG0uIiArIGtleSApOwoKCQkJCQlpZiAockRlZXBTaGFkb3dJdGVtLnRlc3QoIGxvZ2ljYWxQYXRoICkpIHsKCgkJCQkJCWRlbGV0ZSBzaGFkb3dSb290W2tleV07CgoJCQkJCX0gZWxzZSBpZiAockNoaWxkU2hhZG93SXRlbS50ZXN0KCBsb2dpY2FsUGF0aCApKSB7CgoJCQkJCQllZGl0T2JqZWN0ID0gc2hhZG93Um9vdFtrZXldLmVkaXQ7CgoJCQkJCQlpZiAoZWRpdE9iamVjdCkgewoJCQkJCQkJZWRpdE9iamVjdC5pdGVtID0gbnVsbDsKCQkJCQkJCWVkaXRPYmplY3Quc2VsZWN0ZWRJbmRleCA9IC0xOwoJCQkJCQl9CgkJCQkJfQoJCQkJfQoJCQl9ICk7CgkJCXJldHVybiB0aGlzOwoJCX0sCgoJCS8vY3JlYXRlIGEgbmV3IGl0ZW0gaW4gc2hhZG93IGVkaXQgb2JqZWN0IGZvciBpdGVtcyBtb2RlbAoJCS8vbm90IG5lY2Vzc2FyeSBmb3IgbW9kZWwgb2YgcHJpbWl0aXZlIHR5cGUgYW5kIG9iamVjdHMKCQluZXdTaGFkb3dJdGVtOiBmdW5jdGlvbigpIHsKCQkJaWYgKHRoaXMuZ2V0KCAiKmVkaXQubW9kZSIgKSAhPT0gInJlYWQiKSB7CgkJCQl0aGlzLnJlc2V0U2hhZG93SXRlbSgpOwoJCQl9CgoJCQl2YXIgZWRpdFNoYWRvd01vZGVsID0gdGhpcy5jZCggIiplZGl0IiApLAoJCQkJaXRlbVRlbXBsYXRlID0gZWRpdFNoYWRvd01vZGVsLnJhdyggIml0ZW1UZW1wbGF0ZSIgKSwKCQkJCWl0ZW0gPSAoaXNGdW5jdGlvbiggaXRlbVRlbXBsYXRlICkpID8KCQkJCQlpdGVtVGVtcGxhdGUoKSA6CgkJCQkJY2xvbmUoIGl0ZW1UZW1wbGF0ZSwgdHJ1ZSApOwoKCQkJZWRpdFNoYWRvd01vZGVsLnVwZGF0ZSggIml0ZW0iLCBpdGVtICk7CgkJCWVkaXRTaGFkb3dNb2RlbC5jaGFuZ2UoICJtb2RlIiApOwoJCX0sCgoJCWVkaXRTaGFkb3dJdGVtOiBmdW5jdGlvbiggaXRlbSwgaXRlbUluZGV4ICkgewoKCQkJdmFyIGl0ZW1WYWx1ZSA9IHRoaXMucmF3KCk7CgkJCWlmIChpc1ByaW1pdGl2ZSggaXRlbVZhbHVlICkgfHwgaXNPYmplY3QoIGl0ZW1WYWx1ZSApKSB7CgoJCQkJdmFyIGVkaXQgPSB0aGlzLmdldCggIiplZGl0IiApOwoJCQkJaWYgKGlzVW5kZWZpbmVkKCBlZGl0ICkpIHsKCQkJCQllZGl0ID0gbmV3IEVkaXRPYmplY3QoKTsKCQkJCQl0aGlzLnNldCggIiplZGl0IiwgZWRpdCApOwoJCQkJfQoKCQkJCWlmIChlZGl0Lml0ZW0gIT09IG51bGwpIHsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJdGhpcy5zZXQoICIqZWRpdC5pdGVtIiwgY2xvbmUoIGl0ZW1WYWx1ZSwgdHJ1ZSApICk7CgkJCQl0aGlzLmNoYW5nZSggIiplZGl0Lm1vZGUiICk7CgoJCQl9IGVsc2UgewoKCQkJCWlmICh0aGlzLmdldCggIiplZGl0Lm1vZGUiICkgIT09ICJyZWFkIikgewoJCQkJCXRoaXMucmVzZXRTaGFkb3dJdGVtKCk7CgkJCQl9CgoJCQkJaWYgKGlzVW5kZWZpbmVkKCBpdGVtSW5kZXggKSkgewoJCQkJCWl0ZW1JbmRleCA9IHRoaXMuaW5kZXhPZiggaXRlbSApOwoJCQkJfSBlbHNlIHsKCQkJCQlpdGVtID0gdGhpcy5nZXQoKVtpdGVtSW5kZXhdOwoJCQkJfQoKCQkJCXZhciBlZGl0U2hhZG93TW9kZWwgPSB0aGlzLmNkKCAiKmVkaXQiICksCgkJCQkJaXRlbVRlbXBsYXRlID0gZWRpdFNoYWRvd01vZGVsLnJhdyggIml0ZW1UZW1wbGF0ZSIgKSwKCQkJCQljb3B5ID0gKGlzRnVuY3Rpb24oIGl0ZW1UZW1wbGF0ZSApKSA/CgkJCQkJCWl0ZW1UZW1wbGF0ZSggaXRlbSApIDoKCQkJCQkJY2xvbmUoIGl0ZW0sIHRydWUgKTsKCgkJCQllZGl0U2hhZG93TW9kZWwudXBkYXRlKCAiaXRlbSIsIGNvcHkgKQoJCQkJCS51cGRhdGUoICJzZWxlY3RlZEluZGV4IiwgaXRlbUluZGV4ICk7CgoJCQkJZWRpdFNoYWRvd01vZGVsLmNoYW5nZSggIm1vZGUiICk7CgkJCX0KCgkJfSwKCgkJcmVzZXRTaGFkb3dJdGVtOiBmdW5jdGlvbiggc2F2ZSApIHsKCQkJaWYgKHRoaXMucGF0aC5lbmRzV2l0aCggIi5lZGl0Lml0ZW0iICkpIHsKCQkJCXJldHVybiB0aGlzLm1haW4oKS5yZXNldFNoYWRvd0l0ZW0oKTsKCQkJfQoKCQkJdmFyIGl0ZW1zID0gdGhpcy5yYXcoKTsKCQkJaWYgKGlzUHJpbWl0aXZlKCBpdGVtcyApIHx8IGlzT2JqZWN0KCBpdGVtcyApKSB7CgoJCQkJdGhpcy5zZXQoICIqZWRpdC5pdGVtIiwgbnVsbCApOwoJCQkJdGhpcy5jaGFuZ2UoICIqZWRpdC5tb2RlIiApOwoKCQkJfSBlbHNlIHsKCgkJCQl2YXIgZWRpdCA9IHRoaXMuY2QoICIqZWRpdCIgKTsKCQkJCWlmICghaXNVbmRlZmluZWQoIGVkaXQuZ2V0KCkgKSkgewoKCQkJCQllZGl0LnVwZGF0ZSggIml0ZW0iLCBudWxsICk7CgoJCQkJCWlmIChzYXZlKSB7CgkJCQkJCS8vaWYgaXQgdHJpZ2dlcmVkIGJ5IHNhdmVTaGFkb3dJdGVtCgkJCQkJCS8vdXBkYXRlIHNlbGVjdGVkSW5kZXggZGlyZWN0bHkgdG8gYXZvaWQgZXZlbnRzCgkJCQkJCWVkaXQuZ2V0KCkuc2VsZWN0ZWRJbmRleCA9IC0xOwoJCQkJCX0gZWxzZSB7CgkJCQkJCWVkaXQudXBkYXRlKCAic2VsZWN0ZWRJbmRleCIsIC0xICk7CgkJCQkJfQoKCQkJCQllZGl0LmNoYW5nZSggIm1vZGUiICk7CgkJCQl9CgkJCX0KCgkJfSwKCgkJc2F2ZVNoYWRvd0l0ZW06IGZ1bmN0aW9uKCkgewoKCQkJaWYgKHRoaXMucGF0aC5lbmRzV2l0aCggIi5lZGl0Lml0ZW0iICkpIHsKCQkJCXJldHVybiB0aGlzLm1haW4oKS5zYXZlU2hhZG93SXRlbSgpOwoJCQl9CgoJCQl2YXIgaXRlbXMgPSB0aGlzLnJhdygpOwoKCQkJaWYgKGlzUHJpbWl0aXZlKCBpdGVtcyApIHx8IGlzT2JqZWN0KCBpdGVtcyApKSB7CgoJCQkJdGhpcy5zZXQoIHRoaXMuZ2V0KCAiKmVkaXQuaXRlbSIgKSApCgkJCQkJLnNldCggIiplZGl0Lml0ZW0iLCBudWxsICk7CgoJCQkJdGhpcy5jaGFuZ2UoICIqZWRpdC5tb2RlIiApOwoKCQkJfSBlbHNlIHsKCgkJCQl2YXIgY3VycmVudEVkaXRNb2RlID0gdGhpcy5nZXQoICIqZWRpdC5tb2RlIiApLAoJCQkJCXBlbmRpbmdJdGVtID0gdGhpcy5nZXQoICIqZWRpdC5pdGVtIiApOwoKCQkJCWlmIChjdXJyZW50RWRpdE1vZGUgPT0gInJlYWQiKSB7CgoJCQkJCXRocm93ICJpbnZhbGlkIG9wZXJhdGlvbnMiOwoKCQkJCX0gZWxzZSBpZiAoY3VycmVudEVkaXRNb2RlID09ICJuZXciKSB7CgoJCQkJCWlmIChpc0Z1bmN0aW9uKCBpdGVtcyApKSB7CgkJCQkJCS8vdGhpcyBpcyBjYXNlIHdoZW4gaXRlbXMgaXMgbW9kZWwqcXVlcnlSZXN1bHQKCQkJCQkJdGhpcy5tYWluKCkucHVzaCggcGVuZGluZ0l0ZW0gKTsKCgkJCQkJfSBlbHNlIHsKCQkJCQkJdGhpcy5wdXNoKCBwZW5kaW5nSXRlbSApOwoJCQkJCX0KCgkJCQkJdGhpcy5yZXNldFNoYWRvd0l0ZW0oKTsKCgkJCQl9IGVsc2UgLyppZiAoY3VycmVudEVkaXRNb2RlID09ICJ1cGRhdGUiKSovIHsKCgkJCQkJdmFyIHNlbGVjdGVkSW5kZXggPSB0aGlzLmdldCggIiplZGl0LnNlbGVjdGVkSW5kZXgiICk7CgoJCQkJCWlmIChpc0Z1bmN0aW9uKCBpdGVtcyApKSB7CgkJCQkJCS8vdGhpcyBpcyBjYXNlIHdoZW4gaXRlbXMgaXMgbW9kZWwqcXVlcnlSZXN1bHQKCQkJCQkJaXRlbXMgPSB0aGlzLmdldCgpOwoJCQkJCQl0aGlzLm1haW4oKS5yZXBsYWNlSXRlbSgKCQkJCQkJCWl0ZW1zW3NlbGVjdGVkSW5kZXhdLAoJCQkJCQkJcGVuZGluZ0l0ZW0KCQkJCQkJKTsKCQkJCQl9IGVsc2UgewoJCQkJCQl0aGlzLnJlcGxhY2VJdGVtKAoJCQkJCQkJaXRlbXNbc2VsZWN0ZWRJbmRleF0sCgkJCQkJCQlwZW5kaW5nSXRlbQoJCQkJCQkpOwoJCQkJCX0KCQkJCQl0aGlzLnJlc2V0U2hhZG93SXRlbSggdHJ1ZSApOwoJCQkJfQoKCQkJfQoJCX0KCX0gKTsKCglobS53b3JrZmxvdyggewoKCQkvLy0tLS0tLXdvcmtmbG93cyB0aGF0IG1vZGlmeSBtb2RlbC0tLS0tLQoKCQkvLyRjbGljazppdGVtc3wqZWRpdFNoYWRvd0l0ZW0KCQkvLyRjbGljazppdGVtcypxdWVyeVJlc3VsdHwqZWRpdFNoYWRvd0l0ZW0KCQluZXdTaGFkb3dJdGVtOiAiKmZha2VHZXQgbmV3U2hhZG93SXRlbSIsCgoJCS8vJGNsaWNrOml0ZW18KmVkaXRTaGFkb3dJdGVtCgkJLy8kZWRpdFJvdzppdGVtc3wqZWRpdFNoYWRvd0l0ZW0KCQkvLyRlZGl0Um93Oml0ZW1zKnF1ZXJ5UmVzdWx0fCplZGl0U2hhZG93SXRlbQoJCWVkaXRTaGFkb3dJdGVtOiBmdW5jdGlvbiggZSApIHsKCQkJaWYgKGUudHlwZSA9PSAiZWRpdFJvdyIpIHsKCQkJCS8vdGhpcyB0cmlnZ2VyIGJ5IGVkaXQgYnV0dG9uCgkJCQl0aGlzLmVkaXRTaGFkb3dJdGVtKCBudWxsLCBlLnNlbGVjdGVkUm93SW5kZXgoKSApOwoJCQl9IGVsc2UgewoJCQkJaWYgKHRoaXMucGF0aC5lbmRzV2l0aCggIi5lZGl0Lml0ZW0iICkpIHsKCQkJCQl0aGlzLm1haW4oKS5lZGl0U2hhZG93SXRlbSggdGhpcy5nZXQoKSApOwoJCQkJfSBlbHNlIHsKCQkJCQl0aGlzLmVkaXRTaGFkb3dJdGVtKCk7CgkJCQl9CgkJCX0KCQkJZS5zdG9wUHJvcGFnYXRpb24oKTsKCQl9LAoKCQkvLyIkZGVsZXRlOml0ZW1zfCpyZW1vdmVJdGVtOyIKCQkvLyIkZGVsZXRlOml0ZW1zKnF1ZXJ5UmVzdWx0fCpyZW1vdmVJdGVtOyIKCQlyZW1vdmVJdGVtOiBmdW5jdGlvbiggZSApIHsKCQkJaWYgKHRoaXMuZ2V0KCAiKmVkaXQubW9kZSIgKSAhPSAicmVhZCIpIHsKCQkJCXRoaXMucmVzZXRTaGFkb3dJdGVtKCk7CgkJCX0KCQkJdmFyIGluZGV4ID0gZS5zZWxlY3RlZFJvd0luZGV4KCk7CgkJCXZhciBpdGVtcyA9IHRoaXMucmF3KCk7CgkJCWlmIChpc0Z1bmN0aW9uKCBpdGVtcyApKSB7CgkJCQkvL3RoaXMgaXMgY2FzZSB3aGVuIGl0ZW1zIGlzIG1vZGVsKnF1ZXJ5UmVzdWx0CgkJCQlpdGVtcyA9IHRoaXMuZ2V0KCk7CgkJCQl0aGlzLm1haW4oKS5yZW1vdmVJdGVtKCBpdGVtc1tpbmRleF0gKTsKCQkJfSBlbHNlIHsKCQkJCXRoaXMucmVtb3ZlQXQoIGluZGV4ICk7CgkJCX0KCQkJZS5zdG9wUHJvcGFnYXRpb24oKTsKCQl9LAoKCQkvLyRtb3ZlVXA6aXRlbXN8Km1vdmVVcEl0ZW07CgkJbW92ZVVwSXRlbTogZnVuY3Rpb24oIGUgKSB7CgkJCXZhciBzZWxlY3RlZEluZGV4ID0gZS5zZWxlY3RlZFJvd0luZGV4KCk7CgkJCXRoaXMubW92ZSggc2VsZWN0ZWRJbmRleCwgc2VsZWN0ZWRJbmRleCAtIDEgKTsKCQkJZS5zdG9wUHJvcGFnYXRpb24oKTsKCQl9LAoKCQkvLyRtb3ZlVXA6aXRlbXN8Km1vdmVVcEl0ZW07CgkJbW92ZURvd25JdGVtOiBmdW5jdGlvbiggZSApIHsKCQkJdmFyIHNlbGVjdGVkSW5kZXggPSBlLnNlbGVjdGVkUm93SW5kZXgoKTsKCQkJdGhpcy5tb3ZlKCBzZWxlY3RlZEluZGV4LCBzZWxlY3RlZEluZGV4ICsgMSApOwoJCQllLnN0b3BQcm9wYWdhdGlvbigpOwoJCX0sCgoJCS8vLS0tLS0td29ya2Zsb3dzIHRoYXQgbW9kaWZ5IHZpZXdzLS0tLS0tCgoJCS8vIWFmdGVyVXBkYXRlOml0ZW1zKmVkaXQubW9kZXwqcmVuZGVyTmV3VmlldzsKCQkvLyFhZnRlclVwZGF0ZTppdGVtcypxdWVyeVJlc3VsdCplZGl0Lm1vZGV8KnJlbmRlck5ld1ZpZXc7CgkJcmVuZGVyTmV3VmlldzogbmV3VGVtcGxhdGVIYW5kbGVyKAoJCQlmdW5jdGlvbiggZSApIHsKCQkJCWlmIChlLnB1Ymxpc2hlci5nZXQoKSA9PSAibmV3IikgewoJCQkJCXJldHVybiBlLnB1Ymxpc2hlci5tYWluKCkuZ2V0KCAiKmVkaXQuaXRlbSIgKTsKCQkJCX0KCQkJfQoJCQkvKnNldCBhY3Rpdml0eSBpcyBieSBkZWZhdWx0IGh0bWwqLwoKCQkpLAoKCQkvLyIhYmVnaW5JblJvd1VwZGF0ZTppdGVtc3wqcmVuZGVyVXBkYXRlUm93VmlldzsiCgkJLy8iIWJlZ2luSW5Sb3dVcGRhdGU6aXRlbXMqcXVlcnlSZXN1bHR8KnJlbmRlclVwZGF0ZVJvd1ZpZXc7IgoJCXJlbmRlclVwZGF0ZVJvd1ZpZXc6IG5ld1RlbXBsYXRlSGFuZGxlcigKCQkJLy9nZXQgYWN0aXZpdHkKCQkJZnVuY3Rpb24oIGUgKSB7CgkJCQlyZXR1cm4gZS5wdWJsaXNoZXIuZ2V0KCAiKmVkaXQuaXRlbSIgKTsKCQkJfSwKCQkJLy9zZXQgYWN0aXZpdHkKCQkJZnVuY3Rpb24oIHZhbHVlLCBlICkgewoJCQkJLy9lLnByb3Bvc2VkIGlzIHRoZSBpbmRleCBvZiB0aGUgZWRpdCBpdGVtCgkJCQl0aGlzLmNoaWxkcmVuKCkuZXEoIGUucHJvcG9zZWQgKS5yZXBsYWNlV2l0aCggdmFsdWUgKTsKCQkJfSApLAoKCQkvLyIhYmVnaW5JblJvd1VwZGF0ZTppdGVtc3wqcmVuZGVyVXBkYXRlUm93VmlldzsiCgkJLy8iIWJlZ2luSW5Sb3dVcGRhdGU6aXRlbXMqcXVlcnlSZXN1bHR8KnJlbmRlclVwZGF0ZVJvd1ZpZXc7IgoJCWRlc3Ryb3lVcGRhdGVSb3dWaWV3OiBmdW5jdGlvbiggZSApIHsKCQkJZS5wdWJsaXNoZXIuY2hhbmdlKCBlLnByb3Bvc2VkICk7CgkJfSwKCgkJLy8kY2xpY2s6aXRlbXMqZWRpdC5pdGVtfCpzYXZlU2hhZG93SXRlbTsKCQkvLyRjbGljazppdGVtcypxdWVyeVJlc3VsdCplZGl0Lml0ZW18KnNhdmVTaGFkb3dJdGVtOwoJCXNhdmVTaGFkb3dJdGVtOiBmdW5jdGlvbiggZSApIHsKCQkJdGhpcy5zYXZlU2hhZG93SXRlbSgpOwoJCQllLnN0b3BQcm9wYWdhdGlvbigpOwoJCX0sCgoJCS8vJGNsaWNrOml0ZW1zKmVkaXQuaXRlbXwqcmVzZXRTaGFkb3dJdGVtOwoJCS8vJGNsaWNrOml0ZW1zKnF1ZXJ5UmVzdWx0KmVkaXQuaXRlbXwqcmVzZXRTaGFkb3dJdGVtOwoJCXJlc2V0U2hhZG93SXRlbTogZnVuY3Rpb24oIGUgKSB7CgkJCXRoaXMucmVzZXRTaGFkb3dJdGVtKCk7CgkJCWUuc3RvcFByb3BhZ2F0aW9uKCk7CgkJfQoJfSApOwoKCWJpbmRpbmdzKCB7CgoKCQkvLyBzaGFkb3dFZGl0Oml0ZW1zfHJvd1RlbXBsYXRlSWQgb3IKCQkvLyBzaGFkb3dFZGl0Oml0ZW1zKnF1ZXJ5UmVzdWx0fHJvd1RlbXBsYXRlSWQKCQlzaGFkb3dFZGl0OiAiIWluaXQ6Lnxpbml0U2hhZG93RWRpdCAqZmFrZVNldDsiICsKCQkgICAgICAgICAgICAiZGVsZXRlUm93Oi47IiArCgkJICAgICAgICAgICAgIiRlZGl0Um93Oi58KmVkaXRTaGFkb3dJdGVtIiwKCgkJLy8gc2hhZG93RWRpdEluUm93Oml0ZW1zfHVwZGF0ZVJvd1RlbXBsYXRlSWQgb3IKCQkvLyBzaGFkb3dFZGl0SW5Sb3c6aXRlbXMqcXVlcnlSZXN1bHR8dXBkYXRlUm93VGVtcGxhdGVJZAoJCXNoYWRvd0VkaXRJblJvdzogInNoYWRvd0VkaXQ6LjsiICsKCQkgICAgICAgICAgICAgICAgICIhYmVnaW5JblJvd1VwZGF0ZToufCpyZW5kZXJVcGRhdGVSb3dWaWV3OyIgKwoJCSAgICAgICAgICAgICAgICAgIiFjYW5jZWxJblJvd1VwZGF0ZToufCpkZXN0cm95VXBkYXRlUm93VmlldyIsCgoJCWRlbGV0ZVJvdzogIiRkZWxldGVSb3c6LnwqY29uZmlybXxfRG8geW91IHdhbnQgdG8gZGVsZXRlIHRoaXMgaXRlbT87IiArCgkJICAgICAgICAgICAiJGRlbGV0ZVJvdzoufCpyZW1vdmVJdGVtOyIsCgkJLy9tb3ZhYmxlUm93Oml0ZW1zCgkJbW92YWJsZVJvdzogIiRtb3ZlVXA6LnwqbW92ZVVwSXRlbTsiICsKCQkgICAgICAgICAgICAiJG1vdmVEb3duOi58Km1vdmVEb3duSXRlbTsiLAoKCQkvL25ld0l0ZW1WaWV3Oml0ZW1zCgkJLy9uZXdJdGVtVmlldzppdGVtcypxdWVyeVJlc3VsdAoJCW5ld0l0ZW1WaWV3OiAiIWFmdGVyVXBkYXRlOiplZGl0Lm1vZGV8KnJlbmRlck5ld1ZpZXc7IiArCgkJICAgICAgICAgICAgICJzaG93T25OZXc6LiIsCgoJCS8vc2hvd09uTmV3Oml0ZW1zCgkJLy9zaG93T25OZXc6aXRlbXMqcXVlcnlSZXN1bHQKCQlzaG93T25OZXc6ICJzaG93OiplZGl0Lm1vZGV8X25ldyIsCgoJCS8vaGlkZU9uTmV3Oml0ZW1zCgkJLy9oaWRlT25OZXc6aXRlbXMqcXVlcnlSZXN1bHQKCQloaWRlT25OZXc6ICJoaWRlOiplZGl0Lm1vZGV8X25ldyIsCgoJCS8vZWRpdEl0ZW1WaWV3Oml0ZW1zCgkJLy9lZGl0SXRlbVZpZXc6aXRlbXMqcXVlcnlSZXN1bHQKCQllZGl0SXRlbVZpZXc6ICJ0bXBsT25DaGFuZ2U6KmVkaXQuaXRlbTsiICsKCQkgICAgICAgICAgICAgICJzaG93T25FZGl0Oi4iLAoKCQlkaXNwbGF5SXRlbVZpZXc6ICJ0bXBsT25DaGFuZ2U6LjtoaWRlT25FZGl0Oi4iLAoKCQkvL3Nob3dPbkVkaXQ6aXRlbXMKCQkvL3Nob3dPbkVkaXQ6aXRlbXMqcXVlcnlSZXN1bHQKCQkvL3Nob3dPbkVkaXQ6ICJoaWRlOiplZGl0Lm1vZGV8X3JlYWQiLAoJCXNob3dPbkVkaXQ6IGZ1bmN0aW9uKCBlbGVtLCBwYXRoLCBjb250ZXh0LCBvcHRpb25zICkgewoJCQljb250ZXh0LmFwcGVuZFN1YiggZWxlbSwgcGF0aCArICIqZWRpdC5tb2RlIiwgImluaXQgYWZ0ZXJVcGRhdGUiLCBmdW5jdGlvbiggZSApIHsKCQkJCXZhciBtb2RlID0gZS5wdWJsaXNoZXIuZ2V0KCk7CgkJCQl0aGlzWyhpc1VuZGVmaW5lZCggbW9kZSApIHx8IG1vZGUgPT0gInJlYWQiKSA/ICJoaWRlIiA6ICJzaG93Il0oKTsKCQkJfSApOwoJCX0sCgoJCS8vaGlkZU9uRWRpdDppdGVtcwoJCS8vaGlkZU9uRWRpdDppdGVtcypxdWVyeVJlc3VsdAoJCS8vaGlkZU9uRWRpdDogInNob3c6KmVkaXQubW9kZXxfcmVhZCIsCgkJaGlkZU9uRWRpdDogZnVuY3Rpb24oIGVsZW0sIHBhdGgsIGNvbnRleHQsIG9wdGlvbnMgKSB7CgkJCWNvbnRleHQuYXBwZW5kU3ViKCBlbGVtLCBwYXRoICsgIiplZGl0Lm1vZGUiLCAiaW5pdCBhZnRlclVwZGF0ZSIsIGZ1bmN0aW9uKCBlICkgewoJCQkJdmFyIG1vZGUgPSBlLnB1Ymxpc2hlci5nZXQoKTsKCQkJCXRoaXNbKGlzVW5kZWZpbmVkKCBtb2RlICkgfHwgbW9kZSA9PSAicmVhZCIpID8gInNob3ciIDogImhpZGUiXSgpOwoJCQl9ICk7CgkJfSwKCgkJLy9uZXdJdGVtOml0ZW1zCgkJLy9uZXdJdGVtOml0ZW1zKnF1ZXJ5UmVzdWx0CgkJbmV3SXRlbTogIiRjbGljazoufCpuZXdTaGFkb3dJdGVtOyIgKwoJCSAgICAgICAgICJoaWRlT25OZXc6LiIsCgoJCS8vZWRpdEJ1dHRvbjppdGVtCgkJLy90aGlzIGlzIG9ubHkgdXNlZCBub24tYXJyYXkgaXRlbSBlZGl0CgkJZWRpdE9iamVjdDogIiRjbGljazoufCplZGl0U2hhZG93SXRlbTtoaWRlT25FZGl0Oi4iLAoKCQkvL3NhdmVFZGl0Oml0ZW1zKmVkaXQuaXRlbQoJCS8vc2F2ZUVkaXQ6aXRlbXMqcXVlcnlSZXN1bHQqZWRpdC5pdGVtCgkJc2F2ZUVkaXQ6ICIkY2xpY2s6Lnwqc2F2ZVNoYWRvd0l0ZW0iLAoKCQkvL2NhbmNlbEVkaXQ6aXRlbXMqZWRpdC5pdGVtCgkJLy9jYW5jZWxFZGl0Oml0ZW1zKnF1ZXJ5UmVzdWx0KmVkaXQuaXRlbQoJCWNhbmNlbEVkaXQ6ICIkY2xpY2s6LnwqcmVzZXRTaGFkb3dJdGVtIgoKCX0gKTsKCglobS5uZXdKcUV2ZW50KCB7CgoJCWVkaXRSb3c6IFsiY2xpY2siLCBmdW5jdGlvbiggZSApIHsKCQkJcmV0dXJuICQoIGUudGFyZ2V0ICkuaGFzQ2xhc3MoICJlZGl0Um93IiApOwoJCX1dLAoKCQlkZWxldGVSb3c6IFsiY2xpY2siLCBmdW5jdGlvbiggZSApIHsKCQkJcmV0dXJuICQoIGUudGFyZ2V0ICkuaGFzQ2xhc3MoICJkZWxldGVSb3ciICk7CgoJCX1dLAoKCQltb3ZlVXA6IFsiY2xpY2siLCBmdW5jdGlvbiggZSApIHsKCQkJcmV0dXJuICQoIGUudGFyZ2V0ICkuaGFzQ2xhc3MoICJtb3ZlVXAiICk7CgkJfV0sCgoJCW1vdmVEb3duOiBbImNsaWNrIiwgZnVuY3Rpb24oIGUgKSB7CgkJCXJldHVybiAkKCBlLnRhcmdldCApLmhhc0NsYXNzKCAibW92ZURvd24iICk7CgkJfV0KCX0gKTsKCi8vCgoKICAgIGRlZmF1bHRPcHRpb25zLmhhc2hQcmVmaXggPSAiISI7CiAgICBkZWZhdWx0T3B0aW9ucy5yb3V0ZVByZWZpeCA9ICIvIjsKCiAgICB2YXIgbGlzdE9mUm91dGVTZWdtZW50cyA9IFtdLAoKICAgICAgICBkZWZhdWx0Um91dGVTZWdtZW50cywKCiAgICAgICAgaW5pdGlhbFJvdXRlTWF0Y2hlZEJ5UGF0dGVybnMsCgogICAgICAgIHJQbHVzID0gL1wrL2csCgogICAgICAgIHJMZWZ0U3F1YXJlQnJhY2tldCA9IC9cWy8sCgogICAgICAgIHJSaWdodFNxdWFyZUJyYWNrZXQgPSAvXF0kLywKCiAgICAgICAgclJpZ2h0U3F1YXJlQnJhY2tldEVuZCA9IC9cXSQvLAoKICAgICAgICByU2VnbWVudFN0cmluZyA9IC9eKFteP10qKShcPy4qKT8kLywKCiAgICAgICAgclF1ZXJ5U3RyaW5nID0gL15bXj9dKlw/KC4qKSQvLAoKICAgICAgICByU3RhcnRIYXNoLAogICAgLy90aGUgcGF0aCBvZiBtb2RlbCB3aGljaCBpcyB0cmFja2VkIGluIHF1ZXJ5IHN0cmluZwogICAgICAgIHBhcmFtUGF0aHMgPSBbXTsKCiAgICAvL2NvbnZlcnQgYSBwYXJhbSBzdHJpbmcgaW50byBhbiBvYmplY3QKICAgIGZ1bmN0aW9uIGRlcGFyYW0ocGFyYW1TdHJpbmcsIGNvZXJjZSkgewoKICAgICAgICB2YXIgb2JqID0ge30sCiAgICAgICAgICAgIGNvZXJjZV90eXBlcyA9IHsgJ3RydWUnOiB0cnVlLCAnZmFsc2UnOiB0cnVlLCAnbnVsbCc6IG51bGwgfTsKCiAgICAgICAgLy8gSXRlcmF0ZSBvdmVyIGFsbCBuYW1lPXZhbHVlIHBhaXJzLgogICAgICAgICQuZWFjaChwYXJhbVN0cmluZy5yZXBsYWNlKHJQbHVzLCAnICcpLnNwbGl0KCcmJyksIGZ1bmN0aW9uIChpbmRleCwgdmFsdWUpIHsKICAgICAgICAgICAgdmFyIHBhcmFtID0gdmFsdWUuc3BsaXQoJz0nKSwKICAgICAgICAgICAgICAgIGtleSA9IGRlY29kZVVSSUNvbXBvbmVudChwYXJhbVswXSksCiAgICAgICAgICAgICAgICB2YWwsCiAgICAgICAgICAgICAgICBjdXIgPSBvYmosCiAgICAgICAgICAgICAgICBpID0gMCwKCiAgICAgICAgICAgIC8vIElmIGtleSBpcyBtb3JlIGNvbXBsZXggdGhhbiAnZm9vJywgbGlrZSAnYVtdJyBvciAnYVtiXVtjXScsIHNwbGl0IGl0CiAgICAgICAgICAgIC8vIGludG8gaXRzIGNvbXBvbmVudCBwYXJ0cy4KICAgICAgICAgICAgICAgIGtleXMgPSBrZXkuc3BsaXQoJ11bJyksCiAgICAgICAgICAgICAgICBrZXlzX2xhc3QgPSBrZXlzLmxlbmd0aCAtIDE7CgogICAgICAgICAgICAvLyBJZiB0aGUgZmlyc3Qga2V5cyBwYXJ0IGNvbnRhaW5zIFsgYW5kIHRoZSBsYXN0IGVuZHMgd2l0aCBdLCB0aGVuIFtdCiAgICAgICAgICAgIC8vIGFyZSBjb3JyZWN0bHkgYmFsYW5jZWQuCiAgICAgICAgICAgIGlmIChyTGVmdFNxdWFyZUJyYWNrZXQudGVzdChrZXlzWzBdKSAmJiByUmlnaHRTcXVhcmVCcmFja2V0LnRlc3Qoa2V5c1sga2V5c19sYXN0IF0pKSB7CgogICAgICAgICAgICAgICAgLy8gUmVtb3ZlIHRoZSB0cmFpbGluZyBdIGZyb20gdGhlIGxhc3Qga2V5cyBwYXJ0LgogICAgICAgICAgICAgICAga2V5c1sga2V5c19sYXN0IF0gPSBrZXlzWyBrZXlzX2xhc3QgXS5yZXBsYWNlKHJSaWdodFNxdWFyZUJyYWNrZXRFbmQsICcnKTsKCiAgICAgICAgICAgICAgICAvLyBTcGxpdCBmaXJzdCBrZXlzIHBhcnQgaW50byB0d28gcGFydHMgb24gdGhlIFsgYW5kIGFkZCB0aGVtIGJhY2sgb250bwogICAgICAgICAgICAgICAgLy8gdGhlIGJlZ2lubmluZyBvZiB0aGUga2V5cyBhcnJheS4KICAgICAgICAgICAgICAgIGtleXMgPSBrZXlzLnNoaWZ0KCkuc3BsaXQoJ1snKS5jb25jYXQoa2V5cyk7CgogICAgICAgICAgICAgICAga2V5c19sYXN0ID0ga2V5cy5sZW5ndGggLSAxOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gQmFzaWMgJ2Zvbycgc3R5bGUga2V5LgogICAgICAgICAgICAgICAga2V5c19sYXN0ID0gMDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQXJlIHdlIGRlYWxpbmcgd2l0aCBhIG5hbWU9dmFsdWUgcGFpciwgb3IganVzdCBhIG5hbWU/CiAgICAgICAgICAgIGlmIChwYXJhbS5sZW5ndGggPT09IDIpIHsKICAgICAgICAgICAgICAgIHZhbCA9IGRlY29kZVVSSUNvbXBvbmVudChwYXJhbVsxXSk7CgogICAgICAgICAgICAgICAgLy8gQ29lcmNlIHZhbHVlcy4KICAgICAgICAgICAgICAgIGlmIChjb2VyY2UpIHsKICAgICAgICAgICAgICAgICAgICB2YWwgPSB2YWwgJiYgIWlzTmFOKHZhbCkgPyArdmFsICAgICAgICAgICAgICAvLyBudW1iZXIKICAgICAgICAgICAgICAgICAgICAgICAgOiB2YWwgPT09ICd1bmRlZmluZWQnID8gdW5kZWZpbmVkICAgICAgICAgLy8gdW5kZWZpbmVkCiAgICAgICAgICAgICAgICAgICAgICAgIDogY29lcmNlX3R5cGVzW3ZhbF0gIT09IHVuZGVmaW5lZCA/IGNvZXJjZV90eXBlc1t2YWxdIC8vIHRydWUsIGZhbHNlLCBudWxsCiAgICAgICAgICAgICAgICAgICAgICAgIDogdmFsOyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHN0cmluZwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmIChrZXlzX2xhc3QpIHsKICAgICAgICAgICAgICAgICAgICAvLyBDb21wbGV4IGtleSwgYnVpbGQgZGVlcCBvYmplY3Qgc3RydWN0dXJlIGJhc2VkIG9uIGEgZmV3IHJ1bGVzOgogICAgICAgICAgICAgICAgICAgIC8vICogVGhlICdjdXInIHBvaW50ZXIgc3RhcnRzIGF0IHRoZSBvYmplY3QgdG9wLWxldmVsLgogICAgICAgICAgICAgICAgICAgIC8vICogW10gPSBhcnJheSBwdXNoIChuIGlzIHNldCB0byBhcnJheSBsZW5ndGgpLCBbbl0gPSBhcnJheSBpZiBuIGlzCiAgICAgICAgICAgICAgICAgICAgLy8gICBudW1lcmljLCBvdGhlcndpc2Ugb2JqZWN0LgogICAgICAgICAgICAgICAgICAgIC8vICogSWYgYXQgdGhlIGxhc3Qga2V5cyBwYXJ0LCBzZXQgdGhlIHZhbHVlLgogICAgICAgICAgICAgICAgICAgIC8vICogRm9yIGVhY2gga2V5cyBwYXJ0LCBpZiB0aGUgY3VycmVudCBsZXZlbCBpcyB1bmRlZmluZWQgY3JlYXRlIGFuCiAgICAgICAgICAgICAgICAgICAgLy8gICBvYmplY3Qgb3IgYXJyYXkgYmFzZWQgb24gdGhlIHR5cGUgb2YgdGhlIG5leHQga2V5cyBwYXJ0LgogICAgICAgICAgICAgICAgICAgIC8vICogTW92ZSB0aGUgJ2N1cicgcG9pbnRlciB0byB0aGUgbmV4dCBsZXZlbC4KICAgICAgICAgICAgICAgICAgICAvLyAqIFJpbnNlICYgcmVwZWF0LgogICAgICAgICAgICAgICAgICAgIGZvciAoOyBpIDw9IGtleXNfbGFzdDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGtleSA9IGtleXNbaV0gPT09ICcnID8gY3VyLmxlbmd0aCA6IGtleXNbaV07CiAgICAgICAgICAgICAgICAgICAgICAgIGN1ciA9IGN1cltrZXldID0gaSA8IGtleXNfbGFzdCA/CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJba2V5XSB8fCAoIGtleXNbaSArIDFdICYmIGlzTmFOKGtleXNbaSArIDFdKSA/IHt9IDogW10gKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgOiB2YWw7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgLy8gU2ltcGxlIGtleSwgZXZlbiBzaW1wbGVyIHJ1bGVzLCBzaW5jZSBvbmx5IHNjYWxhcnMgYW5kIHNoYWxsb3cKICAgICAgICAgICAgICAgICAgICAvLyBhcnJheXMgYXJlIGFsbG93ZWQuCgogICAgICAgICAgICAgICAgICAgIGlmIChpc0FycmF5KG9ialtrZXldKSkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyB2YWwgaXMgYWxyZWFkeSBhbiBhcnJheSwgc28gcHVzaCBvbiB0aGUgbmV4dCB2YWx1ZS4KICAgICAgICAgICAgICAgICAgICAgICAgb2JqW2tleV0ucHVzaCh2YWwpOwoKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKG9ialtrZXldICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gdmFsIGlzbid0IGFuIGFycmF5LCBidXQgc2luY2UgYSBzZWNvbmQgdmFsdWUgaGFzIGJlZW4gc3BlY2lmaWVkLAogICAgICAgICAgICAgICAgICAgICAgICAvLyBjb252ZXJ0IHZhbCBpbnRvIGFuIGFycmF5LgogICAgICAgICAgICAgICAgICAgICAgICBvYmpba2V5XSA9IFsgb2JqW2tleV0sIHZhbCBdOwoKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAvLyB2YWwgaXMgYSBzY2FsYXIuCiAgICAgICAgICAgICAgICAgICAgICAgIG9ialtrZXldID0gdmFsOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgIH0gZWxzZSBpZiAoa2V5KSB7CiAgICAgICAgICAgICAgICAvLyBObyB2YWx1ZSB3YXMgZGVmaW5lZCwgc28gc2V0IHNvbWV0aGluZyBtZWFuaW5nZnVsLgogICAgICAgICAgICAgICAgb2JqW2tleV0gPSBjb2VyY2UgPyB1bmRlZmluZWQgOiAnJzsKICAgICAgICAgICAgfQogICAgICAgIH0pOwoKICAgICAgICByZXR1cm4gb2JqOwogICAgfQoKICAgIGZ1bmN0aW9uIGdldEhhc2goKSB7CiAgICAgICAgclN0YXJ0SGFzaCA9IHJTdGFydEhhc2ggfHwgbmV3IFJlZ0V4cCgiXiMiICsgZGVmYXVsdE9wdGlvbnMuaGFzaFByZWZpeCArIGRlZmF1bHRPcHRpb25zLnJvdXRlUHJlZml4KTsKICAgICAgICByZXR1cm4gbG9jYXRpb24uaGFzaC5yZXBsYWNlKHJTdGFydEhhc2gsICIiKTsKICAgIH0KCiAgICBmdW5jdGlvbiBnZXRDdXJyZW50UGF0aCgpIHsKICAgICAgICB2YXIgaGFzaCA9IGdldEhhc2goKTsKICAgICAgICB2YXIgbWF0Y2ggPSByU2VnbWVudFN0cmluZy5leGVjKGhhc2gpOwogICAgICAgIHJldHVybiBtYXRjaCAmJiBtYXRjaFsxXSB8fCAiIjsKICAgIH0KCiAgICBmdW5jdGlvbiBnZXRRdWVyeVN0cmluZygpIHsKICAgICAgICB2YXIgaGFzaCA9IGdldEhhc2goKTsKICAgICAgICB2YXIgbWF0Y2ggPSByUXVlcnlTdHJpbmcuZXhlYyhoYXNoKTsKICAgICAgICByZXR1cm4gbWF0Y2ggJiYgbWF0Y2hbMV0gfHwgIiI7CiAgICB9CgogICAgLy9nZXQgc3RhdGUgZnJvbSBxdWVyeSBzdHJpbmcKICAgIGZ1bmN0aW9uIGdldFN0YXRlRnJvbVF1ZXJ5U3RyaW5nKCkgewogICAgICAgIHJldHVybiBkZXBhcmFtKGdldFF1ZXJ5U3RyaW5nKCkpOwogICAgfQoKICAgIC8vaGFuZGxlciBmb3IgbW9kZWwgY2hhbmdlCiAgICAvL3RoaXMgbW9kZWwgaXMgdHJhY2tlZCBpbiB0aGUgcXVlcnkgc3RyaW5nCiAgICAvL3doZW4gbW9kZWwgY2hhbmdlIHdlIHdhbnQgdG8gdXBkYXRlIHRoZSBxdWVyeSBzdHJpbmcKICAgIGZ1bmN0aW9uIHVwZGF0ZVF1ZXJ5U3RyaW5nT25Nb2RlbENoYW5nZShlKSB7CgogICAgICAgIHZhciBxdWVyaWVkUGF0aCA9IHRvTG9naWNhbFBhdGgoZS5wdWJsaXNoZXIucGF0aCksCiAgICAgICAgICAgIG1vZGVsID0ge307CgogICAgICAgIG1vZGVsW3F1ZXJpZWRQYXRoXSA9IHJvb3ROb2RlLmdldChxdWVyaWVkUGF0aCk7CgogICAgICAgIC8vYnVpbGQgdGhlIGhhc2ggc3RyaW5nCiAgICAgICAgLy8xLmNhbGwgZ2V0U3RhZ2VGcm9tUXVlcnlTdHJpbmcKICAgICAgICAvLzIubWVyZ2UgdGhlIHN0YXRlIGluIHF1ZXJ5IHN0cmluZyB3aXRoIHRoZSBzdGF0ZQogICAgICAgIC8vMy5jb252ZXJ0IHRoZSBtZXJnZWQgb2JqZWN0IGludG8gcXVlcnkgc3RyaW5nCiAgICAgICAgLy80LiByZXBsYWNlIGhhc2gncyBxdWVyeSBzdHJpbmcgd2l0aCB0aGUgbmV3IHF1ZXJ5IHN0cmluZwogICAgICAgIHZhciBxdWVyeVN0cmluZyA9IGdldFF1ZXJ5U3RyaW5nKCk7CiAgICAgICAgdmFyIGV4aXN0aW5nU3RhdGUgPSBkZXBhcmFtKHF1ZXJ5U3RyaW5nKTsKICAgICAgICB2YXIgbmV3U3RhdGUgPSAkLmV4dGVuZCh7fSwgZXhpc3RpbmdTdGF0ZSwgbW9kZWwpOwogICAgICAgIHZhciBuZXdIYXNoID0gZ2V0Q3VycmVudFBhdGgoKSArICI/IiArICQucGFyYW0obmV3U3RhdGUpOwoKICAgICAgICBsb2NhdGlvbi5oYXNoID0gZGVmYXVsdE9wdGlvbnMuaGFzaFByZWZpeCArIGRlZmF1bHRPcHRpb25zLnJvdXRlUHJlZml4ICsgbmV3SGFzaDsKCiAgICB9CgogICAgLy93aGVuIG1vZGVsIGNoYW5nZSB0cnkgdG8gdXBkYXRlIHRoZSByb3V0ZSBieQogICAgLy9lbnVtZXJhdGluZyB0aGUgdGhlIGxpc3Qgb2Ygc2VnbWVudCBwYXR0ZXJucyBhcnJheQogICAgLy9pZiBvbmUgc2VnbWVudCBwYXR0ZXJucyBhcnJheSBtYXRjaCB0aGUgY3VycmVudCByb3V0ZSwgdGhlbgogICAgLy9lbnVtZXJhdGUgdGhlIHNlZ21lbnQgcGF0dGVybnMgYXJyYXkgdG8gZmluZCBvdXQgaWYKICAgIC8vYSBwYXR0ZXJuJ3MgbW9kZWwgcGF0aCBpcyBlcXVhbCB0byB0aGUgcGF0aCBvZiB0aGUgY2hhbmdlZCBtb2RlbAogICAgLy90aGVuIHVwZGF0ZSB0aGUgcGF0aCB3aXRoIHRoZSB1cGRhdGVkIG1vZGVsJ3MgdmFsdWUKICAgIGZ1bmN0aW9uIHVwZGF0ZVBhdGhPbk1vZGVsQ2hhbmdlKGUpIHsKCiAgICAgICAgdmFyIHJvdXRlU2VnbWVudCwKICAgICAgICAgICAgcGF0aFNlZ21lbnRzLAogICAgICAgICAgICBuZXdQYXRoLAogICAgICAgICAgICBxdWVyeVN0cmluZywKICAgICAgICAgICAgbW9kZWxQYXRoT2ZQdWJsaXNoZXIgPSBlLnB1Ymxpc2hlci5wYXRoLAogICAgICAgICAgICByb3V0ZVNlZ21lbnRzID0gZS5oYW5kbGVyLm9wdGlvbnMsCiAgICAgICAgICAgIHBhdGggPSBnZXRDdXJyZW50UGF0aCgpOwoKICAgICAgICBpZiAoaXNQYXRoTWF0Y2hlZEJ5Um91dGVTZWdtZW50cyhwYXRoLCByb3V0ZVNlZ21lbnRzKSkgewoKICAgICAgICAgICAgcGF0aFNlZ21lbnRzID0gcGF0aC5zcGxpdCgiLyIpOwoKICAgICAgICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCBwYXRoU2VnbWVudHMubGVuZ3RoOyBqKyspIHsKCiAgICAgICAgICAgICAgICByb3V0ZVNlZ21lbnQgPSByb3V0ZVNlZ21lbnRzW2pdOwoKICAgICAgICAgICAgICAgIGlmIChyb3V0ZVNlZ21lbnQuc3RhcnRzV2l0aCgiOiIpKSB7CgogICAgICAgICAgICAgICAgICAgIHZhciBtb2RlbFBhdGhJblJvdXRlU2VnbWVudCA9IHJvdXRlU2VnbWVudC5zdWJzdHIoMSk7CgogICAgICAgICAgICAgICAgICAgIGlmIChtb2RlbFBhdGhJblJvdXRlU2VnbWVudCA9PSBtb2RlbFBhdGhPZlB1Ymxpc2hlcikgewoKICAgICAgICAgICAgICAgICAgICAgICAgcGF0aFNlZ21lbnRzW2pdID0gcm9vdE5vZGUuZ2V0KG1vZGVsUGF0aE9mUHVibGlzaGVyKTsKICAgICAgICAgICAgICAgICAgICAgICAgbmV3UGF0aCA9IHBhdGhTZWdtZW50cy5qb2luKCIvIik7CiAgICAgICAgICAgICAgICAgICAgICAgIHF1ZXJ5U3RyaW5nID0gZ2V0UXVlcnlTdHJpbmcoKTsKICAgICAgICAgICAgICAgICAgICAgICAgLy9jb25zb2xlLmxvZyggcXVlcnlTdHJpbmcgPyBuZXdQYXRoICsgIj8iICsgcXVlcnlTdHJpbmcgOiBuZXdQYXRoICk7CiAgICAgICAgICAgICAgICAgICAgICAgIGxvY2F0aW9uLmhhc2ggPSBkZWZhdWx0T3B0aW9ucy5oYXNoUHJlZml4ICsgZGVmYXVsdE9wdGlvbnMucm91dGVQcmVmaXggKyAocXVlcnlTdHJpbmcgPyBuZXdQYXRoICsgIj8iICsgcXVlcnlTdHJpbmcgOiBuZXdQYXRoKTsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBpc1BhdGhNYXRjaGVkQnlSb3V0ZVNlZ21lbnRzKHBhdGgsIHJvdXRlU2VnbWVudHMpIHsKCiAgICAgICAgdmFyIHJvdXRlU2VnbWVudCwKICAgICAgICAgICAgcGF0aFNlZ21lbnRzOwoKICAgICAgICBpZiAoIXBhdGgpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgcGF0aFNlZ21lbnRzID0gcGF0aC5zcGxpdCgiLyIpOwoKICAgICAgICBpZiAocGF0aFNlZ21lbnRzLmxlbmd0aCAhPT0gcm91dGVTZWdtZW50cy5sZW5ndGgpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICB2YXIgaXNNYXRjaGVkID0gdHJ1ZTsKCiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwYXRoU2VnbWVudHMubGVuZ3RoOyBpKyspIHsKCiAgICAgICAgICAgIHJvdXRlU2VnbWVudCA9IHJvdXRlU2VnbWVudHNbaV07CgogICAgICAgICAgICAvL2lmIHJvdXRlU2VnbWVudCBpcyBtb2RlbCBwYXRoCiAgICAgICAgICAgIC8vZG9uJ3QgbmVlZCB0byBtYXRjaAogICAgICAgICAgICBpZiAocm91dGVTZWdtZW50LnN0YXJ0c1dpdGgoIjoiKSkgewogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChyb3V0ZVNlZ21lbnQgIT0gcGF0aFNlZ21lbnRzW2ldKSB7CiAgICAgICAgICAgICAgICBpc01hdGNoZWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gaXNNYXRjaGVkOwogICAgfQoKICAgIC8vY2hlY2sgaWYgY3VycmVudCBzZWdtZW50IHN0cmluZyBpcyBtYXRjaGVkIHdpdGggc2VnbWVudCBwYXR0ZXJucywgYW5kIHJldHVybiBtYXRjaGVkIHN0YXR1cwogICAgLy9pZiBtYXRjaGVkIGFsc28gdXBkYXRlIHRoZSBtb2RlbCB2YWx1ZSB3aXRoIHRoZSBzZWdtZW50IHZhbHVlCiAgICAvL2lmIHRoaXMgbWV0aG9kIGlzIGNhbGxlZCBpbiByZWdpc3RyYXRpb24gcHJvY2VzcywgYWxzbyByZWdpc3RyYXRpb24gaGFuZGxlciB0byBzdWJzY3JpYmUKICAgIC8vdGhlIGNoYW5nZSBvZiBtb2RlbCwgd2hlbiBtb2RlbCBjaGFuZ2UgdXBkYXRlIHRoZSBzZWdtZW50IHN0cmluZwogICAgZnVuY3Rpb24gcHJvY2Vzc1BhdGhXaXRoUm91dGVTZWdtZW50cyhwYXRoLCByb3V0ZVNlZ21lbnRzLCBpc1JlZ2lzdHJhdGlvbikgewoKICAgICAgICB2YXIgcm91dGVTZWdtZW50LAogICAgICAgICAgICBwYXRoU2VnbWVudHMsCiAgICAgICAgICAgIG1vZGVsUGF0aEluUm91dGVTZWdtZW50LAogICAgICAgICAgICBpc1BhdGhNYXRjaGVkID0gaXNQYXRoTWF0Y2hlZEJ5Um91dGVTZWdtZW50cyhwYXRoLCByb3V0ZVNlZ21lbnRzKTsKCiAgICAgICAgcGF0aFNlZ21lbnRzID0gcGF0aC5zcGxpdCgiLyIpOwoKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJvdXRlU2VnbWVudHMubGVuZ3RoOyBpKyspIHsKCiAgICAgICAgICAgIHJvdXRlU2VnbWVudCA9IHJvdXRlU2VnbWVudHNbaV07CgogICAgICAgICAgICBpZiAocm91dGVTZWdtZW50LnN0YXJ0c1dpdGgoIjoiKSkgewogICAgICAgICAgICAgICAgbW9kZWxQYXRoSW5Sb3V0ZVNlZ21lbnQgPSByb3V0ZVNlZ21lbnQuc3Vic3RyKDEpOwoKICAgICAgICAgICAgICAgIGlmIChpc1BhdGhNYXRjaGVkKSB7CiAgICAgICAgICAgICAgICAgICAgcm9vdE5vZGUuc2V0KG1vZGVsUGF0aEluUm91dGVTZWdtZW50LCBwYXRoU2VnbWVudHNbaV0pOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmIChpc1JlZ2lzdHJhdGlvbikgewogICAgICAgICAgICAgICAgICAgIGhtLnN1YihudWxsLyogbnVsbCBzdWJzY3JpYmVyKi8sIG1vZGVsUGF0aEluUm91dGVTZWdtZW50LCAiYWZ0ZXJVcGRhdGUiLCB1cGRhdGVQYXRoT25Nb2RlbENoYW5nZSwgcm91dGVTZWdtZW50cyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiBpc1BhdGhNYXRjaGVkOwogICAgfQoKICAgIGZ1bmN0aW9uIHJlcGxhY2VVcmxXaXRoTW9kZWxTdGF0ZShzZWdtZW50U3RyaW5nLCBzdGF0ZUluUXVlcnlTdHJpbmcpIHsKCiAgICAgICAgdmFyIGlzRW1wdHlRdWVyeSA9ICQuaXNFbXB0eU9iamVjdChzdGF0ZUluUXVlcnlTdHJpbmcpOwogICAgICAgIGlmICghc2VnbWVudFN0cmluZyAmJiBpc0VtcHR5UXVlcnkpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgdmFyIGN1cnJlbnRIYXNoID0gbG9jYXRpb24uaGFzaCwKICAgICAgICAgICAgdXJsUGF0aCA9IGxvY2F0aW9uLmhyZWYucmVwbGFjZShjdXJyZW50SGFzaCwgIiIpLAogICAgICAgICAgICBuZXdIYXNoID0gZGVmYXVsdE9wdGlvbnMuaGFzaFByZWZpeCArIGRlZmF1bHRPcHRpb25zLnJvdXRlUHJlZml4ICsgc2VnbWVudFN0cmluZyArIChpc0VtcHR5UXVlcnkgPyAiIiA6ICI/IiArICQucGFyYW0oc3RhdGVJblF1ZXJ5U3RyaW5nKSksCiAgICAgICAgICAgIG5ld1VybCA9IHVybFBhdGggKyAiIyIgKyBuZXdIYXNoOwoKICAgICAgICBpZiAoaGlzdG9yeS5yZXBsYWNlU3RhdGUpIHsKICAgICAgICAgICAgaGlzdG9yeS5yZXBsYWNlU3RhdGUobnVsbCwgbnVsbCwgbmV3VXJsKTsKCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbG9jYXRpb24uaHJlZiA9IG5ld1VybDsKCiAgICAgICAgfQogICAgfQoKICAgIC8vcmVnaXN0ZXIgdGhlIG1vZGVsIHBhdGggd2hpY2ggd2lsbCBiZSB0cmFja2VkIHRocm91Z2ggdGhlIHF1ZXJ5IHN0cmluZwogICAgLy9yb3V0ZVBhcmFtcyBzaG91bGQgYmUgY2FsbGVkIGFmdGVyIG1vZGVsIGluaXRpYWxpemF0aW9uCiAgICAvL2J1dCBiZWZvcmUgc3Vic2NyaXB0aW9uIHJlZ2lzdHJhdGlvbiwKICAgIC8vIHNvIHRoYXQgdGhlIHN0YXRlIGluIHF1ZXJ5IHN0cmluZyBjYW4gYmUgcmVzdG9yZWQKICAgIGhtLnJvdXRlUGFyYW1zID0gZnVuY3Rpb24gKC8qIHBhdGgxLCBwYXRoMiwgLi4gKi8pIHsKCiAgICAgICAgdmFyIGksCiAgICAgICAgICAgIG1vZGVsUGF0aCwKICAgICAgICAgICAgYXJncyA9IGFyZ3VtZW50cywKICAgICAgICAgICAgc3RhdGVJblF1ZXJ5U3RyaW5nID0gZ2V0U3RhdGVGcm9tUXVlcnlTdHJpbmcoKTsKCiAgICAgICAgLy91cGRhdGUgdGhlIG1vZGVsIGlmIG1vZGVsIHBhdGggaXMgaW4gcXVlcnkgc3RyaW5nCiAgICAgICAgZm9yIChpID0gMDsgaSA8IGFyZ3MubGVuZ3RoOyBpKyspIHsKCiAgICAgICAgICAgIG1vZGVsUGF0aCA9IGFyZ3NbaV07CgogICAgICAgICAgICAvL2lmIG1vZGVsUGF0aCBpcyBpbiB0aGUgcXVlcnkgc3RyaW5nCiAgICAgICAgICAgIC8vdXBkYXRlIHRoZSBtb2RlbCB3aXRoIHRoZSB2YWx1ZSBpbiBxdWVyeSBzdHJpbmcKICAgICAgICAgICAgaWYgKG1vZGVsUGF0aCBpbiBzdGF0ZUluUXVlcnlTdHJpbmcpIHsKCiAgICAgICAgICAgICAgICByb290Tm9kZS5zZXQobW9kZWxQYXRoLCBzdGF0ZUluUXVlcnlTdHJpbmdbbW9kZWxQYXRoXSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vdXBkYXRlIHF1ZXJ5IHN0cmluZyB3aGVuIG1vZGVsIGNoYW5nZQogICAgICAgICAgICBobS5zdWIobnVsbCwgbW9kZWxQYXRoLCAiYWZ0ZXJVcGRhdGUiLCB1cGRhdGVRdWVyeVN0cmluZ09uTW9kZWxDaGFuZ2UpOwogICAgICAgICAgICBwYXJhbVBhdGhzLnB1c2goYXJnc1tpXSk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gdGhpczsKICAgIH07CgogICAgaG1Gbi5yb3V0ZVBhcmFtcyA9IGZ1bmN0aW9uIChzdWJQYXRoKSB7CgogICAgICAgIHZhciBtb2RlbCA9IHRoaXM7CgogICAgICAgIGhtLnJvdXRlUGFyYW1zLmFwcGx5KAoKICAgICAgICAgICAgaG0sCgogICAgICAgICAgICAkLm1hcChzdWJQYXRoID8gYXJndW1lbnRzIDogWyIiXSwKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIChzdWJQYXRoKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG1vZGVsLmdldFBhdGgoc3ViUGF0aCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICkKICAgICAgICApOwoKICAgICAgICByZXR1cm4gbW9kZWw7CgogICAgfTsKCiAgICAvL3JlZ2lzdGVyIHRoZSBzZWdtZW50IHBhdHRlcm5zIHdoaWNoIHdpbGwgYmUgdXNlZCB0byBtYXRjaCBhIHBhdGgKICAgIC8vYSBwYXRoIGlzIGNvbnNpc3RzIG9mIG11bHRpcGxlIHNlZ21lbnQKICAgIC8vIEEgcGF0aCBsaWtlICIvcHVibGljL2NvbmZpZy9wZXJzb25hbCIsIGNvbnNpc3Qgb2Ygc2VnbWVudHMgWyJwdWJsaWMiLCAiY29uZmlnIiwgInBlcnNvbmFsIl0KICAgIC8vdGhpcyBtZXRob2QgdHJ5IHRvIHVzZSBhIG1hdGNoZXIgdG8gdGVzdCBlYWNoIHNlZ21lbnRzCiAgICAvL2htLnJvdXRlKHNlZ21lbnRNYXRjaGVyMSwgc2VnbWVudE1hdGNoZXIyLCAuLi4pCiAgICAvL2VhY2ggc2VnbWVudCBtYXRjaGVyIGlzIGxpa2UgW3BhdGgsIG1hdGNoZXJdCiAgICAvL3NvIGl0IGlzIGxpa2UKICAgIC8vaG0ucm91dGUoW3BhdGgxLCBtYXRjaGVyMV0sIFtwYXRoMiwgbWF0Y2hlcjJdLCAuLi4pOwogICAgLy9leGFtcGxlIG9mIHNlZ21lbnQgcGF0dGVybiBhcmUgYXMgZm9sbG93aW5nCiAgICAvL3N0cmluZyBlZzogICJwdWJsaWMiLCB3aGljaCBpcyBhIGZpeGVkIHZhbHVlLCB3aGljaCBkb2VzIG5vdCBtYXBwZWQgdG8gYSBtb2RlbAogICAgLy90aGUgZm9sbG93aW5nIG1hcHBlZCB0byBhIG1vZGVsCiAgICAvL2FycmF5IGVnOiBbICJtb2RlbFBhdGgiLCBudWxsXSBvciBbICJtb2RlbFBhdGgiXSwgY29uc3RyYWludCBpcyBudWxsCiAgICAvL2FycmF5IGVnOiBbICJtb2RlbFBhdGgiLCAiZml4ZWRWYWx1ZSIgXSwgY29uc3RyYWludCBpcyAiZml4ZWRWYWx1ZSIKICAgIC8vYXJyYXkgZWc6IFsgIm1vZGVsUGF0aCIsIC9yZWdleC8gXSwgY29uc3RyYWludCBpcyByZWd1bGFyIGV4cHJlc3Npb24KICAgIC8vYXJyYXkgZWc6IFsgIm1vZGVsUGF0aCIsIGZ1bmN0aW9uIChzZWdtZW50KSB7IHJldHVybiBib29sZWFuOyB9IF0sIGNvbnN0cmFpbnQgaXMgYSBmdW5jdGlvbgogICAgaG0ucm91dGVQYXRoID0gZnVuY3Rpb24gKHJvdXRlLCBpc0RlZmF1bHQpIHsKCiAgICAgICAgdmFyIHJvdXRlU2VnbWVudHMgPSByb3V0ZS5zcGxpdCgiLyIpOwoKICAgICAgICBsaXN0T2ZSb3V0ZVNlZ21lbnRzLnB1c2gocm91dGVTZWdtZW50cyk7CgogICAgICAgIGlmIChpc0RlZmF1bHQpIHsKICAgICAgICAgICAgZGVmYXVsdFJvdXRlU2VnbWVudHMgPSByb3V0ZVNlZ21lbnRzOwogICAgICAgIH0KCiAgICAgICAgdmFyIGN1cnJlbnRQYXRoID0gZ2V0Q3VycmVudFBhdGgoKTsKCiAgICAgICAgaWYgKHByb2Nlc3NQYXRoV2l0aFJvdXRlU2VnbWVudHMoY3VycmVudFBhdGgsIHJvdXRlU2VnbWVudHMsIHRydWUpKSB7CiAgICAgICAgICAgIGluaXRpYWxSb3V0ZU1hdGNoZWRCeVBhdHRlcm5zID0gdHJ1ZTsKICAgICAgICB9CiAgICB9OwoKICAgIGhtLnVwZGF0ZVJvdXRlID0gZnVuY3Rpb24gLyp1cGRhdGVNb2RlbFdoZW5IYXNoQ2hhbmdlZCovKCkgewoKCiAgICAgICAgLy91cGRhdGUgbW9kZWwgd2hlbiBzZWdtZW50IHN0cmluZyBjaGFuZ2UKICAgICAgICB2YXIgaSwgbW9kZWxQYXRoLAogICAgICAgICAgICBzZWdtZW50U3RyaW5nID0gZ2V0Q3VycmVudFBhdGgoKSwKICAgICAgICAgICAgc3RhdGVJblF1ZXJ5U3RyaW5nID0gZ2V0U3RhdGVGcm9tUXVlcnlTdHJpbmcoKTsKCiAgICAgICAgaWYgKHNlZ21lbnRTdHJpbmcpIHsKICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGxpc3RPZlJvdXRlU2VnbWVudHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIGlmIChwcm9jZXNzUGF0aFdpdGhSb3V0ZVNlZ21lbnRzKHNlZ21lbnRTdHJpbmcsIGxpc3RPZlJvdXRlU2VnbWVudHNbaV0pKSB7CiAgICAgICAgICAgICAgICAgICAgLy9zaG9ydGN1dCB3aGVuIHRoZSBmaXJzdCBzZWdtZW50IHBhdHRlcm5zIG1hdGNoCiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vaWYgc2VnbWVudFN0cmluZyBpcyBlbXB0eSBhbmQgaXQgaGFzIGRlZmF1bHRTZWdtZW50UGF0dGVybgogICAgICAgICAgICAvL3RyeSB0byBidWlsZCBhIHNlZ21lbnQgc3RyaW5nIGZyb20gdGhlIGRlZmF1bHQgc2VnbWVudCBwYXR0ZXJucwogICAgICAgIH0gZWxzZSBpZiAoZGVmYXVsdFJvdXRlU2VnbWVudHMpIHsKCiAgICAgICAgICAgIHZhciBzZWdtZW50cyA9IFtdOwogICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgZGVmYXVsdFJvdXRlU2VnbWVudHMubGVuZ3RoOyBpKyspIHsKCiAgICAgICAgICAgICAgICB2YXIgc2VnbWVudFBhdHRlcm4gPSBkZWZhdWx0Um91dGVTZWdtZW50c1tpXTsKCiAgICAgICAgICAgICAgICBpZiAoaXNTdHJpbmcoc2VnbWVudFBhdHRlcm4pKSB7CiAgICAgICAgICAgICAgICAgICAgc2VnbWVudHMucHVzaChzZWdtZW50UGF0dGVybik7CgogICAgICAgICAgICAgICAgfSBlbHNlIHsKCiAgICAgICAgICAgICAgICAgICAgdmFyIG1vZGVsVmFsdWUgPSByb290Tm9kZS5nZXQoc2VnbWVudFBhdHRlcm5bMF0pICsgIiI7CiAgICAgICAgICAgICAgICAgICAgc2VnbWVudHMucHVzaChtb2RlbFZhbHVlIHx8IHNlZ21lbnRQYXR0ZXJuLmRlZmF1bHRWYWx1ZSB8fCAiIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHNlZ21lbnRTdHJpbmcgPSBzZWdtZW50cy5qb2luKCIvIik7CiAgICAgICAgfQoKICAgICAgICAvL3VwZGF0ZSBtb2RlbCB3aGVuIHF1ZXJ5IHN0cmluZyBjaGFuZ2UKICAgICAgICBmb3IgKG1vZGVsUGF0aCBpbiBzdGF0ZUluUXVlcnlTdHJpbmcpIHsKICAgICAgICAgICAgaWYgKHBhcmFtUGF0aHMuY29udGFpbnMobW9kZWxQYXRoKSkgewogICAgICAgICAgICAgICAgcm9vdE5vZGUuc2V0KG1vZGVsUGF0aCwgc3RhdGVJblF1ZXJ5U3RyaW5nW21vZGVsUGF0aF0pOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvL3VwZGF0ZSBzdGF0ZSBpbiBxdWVyeSBzdHJpbmcKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgcGFyYW1QYXRocy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBtb2RlbFBhdGggPSBwYXJhbVBhdGhzW2ldOwogICAgICAgICAgICBzdGF0ZUluUXVlcnlTdHJpbmdbbW9kZWxQYXRoXSA9IHJvb3ROb2RlLmdldChtb2RlbFBhdGgpOwogICAgICAgIH0KICAgICAgICAvLwogICAgICAgIHJlcGxhY2VVcmxXaXRoTW9kZWxTdGF0ZShzZWdtZW50U3RyaW5nLCBzdGF0ZUluUXVlcnlTdHJpbmcpOwogICAgfTsKCiAgICAvL3VwZGF0ZSBtb2RlbCB3aGVuIGhhc2ggY2hhbmdlCiAgICAkKHdpbmRvdykuYmluZCgiaGFzaGNoYW5nZSIsIGhtLnVwZGF0ZVJvdXRlKTsKCiAgICAkKGZ1bmN0aW9uICgpIHsKCiAgICAgICAgLy90cnkgdG8gYnVpbGQgdGhlIGluaXRpYWwgaGFzaCBmcm9tIHRoZSBtb2RlbAoKICAgICAgICB2YXIgaSwgcm91dGUgPSAiIjsKCiAgICAgICAgLy9pZiB0aGVyZSBpcyBkZWZhdWx0IHNlZ21lbnQgcGF0dGVybiBhbmQgdGhlIGluaXRpYWwgc2VnbWVudCBzdHJpbmcKICAgICAgICAvL2lzIG5vdCBtYXRjaGVkIGJ5IGFueSBwYXR0ZXJucywgdGhlbiB1c2UgdGhlIGRlZmF1bHQgc2VnbWVudCBwYXR0ZXJuCiAgICAgICAgLy90byBidWlsZCB0aGUgc2VnbWVudCBzdHJpbmcKICAgICAgICBpZiAoZGVmYXVsdFJvdXRlU2VnbWVudHMgJiYgIWluaXRpYWxSb3V0ZU1hdGNoZWRCeVBhdHRlcm5zKSB7CgogICAgICAgICAgICB2YXIgcGF0aFNlZ21lbnRzID0gW107CiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBkZWZhdWx0Um91dGVTZWdtZW50cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgdmFyIHJvdXRlU2VnbWVudCA9IGRlZmF1bHRSb3V0ZVNlZ21lbnRzW2ldOwoKICAgICAgICAgICAgICAgIGlmIChyb3V0ZVNlZ21lbnQuc3RhcnRzV2l0aCgiOiIpKSB7CgogICAgICAgICAgICAgICAgICAgIHBhdGhTZWdtZW50cy5wdXNoKHJvb3ROb2RlLmdldChyb3V0ZVNlZ21lbnQuc3Vic3RyKDEpKSArICIiKTsKCiAgICAgICAgICAgICAgICB9IGVsc2UgewoKICAgICAgICAgICAgICAgICAgICBwYXRoU2VnbWVudHMucHVzaChyb3V0ZVNlZ21lbnQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICByb3V0ZSA9IHBhdGhTZWdtZW50cy5qb2luKCIvIik7CgogICAgICAgIH0gZWxzZSB7CgogICAgICAgICAgICByb3V0ZSA9IGdldEN1cnJlbnRQYXRoKCk7CiAgICAgICAgfQoKICAgICAgICB2YXIgc3RhdGVJblF1ZXJ5U3RyaW5nID0gZ2V0U3RhdGVGcm9tUXVlcnlTdHJpbmcoKTsKCiAgICAgICAgLy91cGRhdGUgc3RhdGUgaW4gcXVlcnkgc3RyaW5nCiAgICAgICAgZm9yIChpID0gMDsgaSA8IHBhcmFtUGF0aHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgdmFyIG1vZGVsUGF0aCA9IHBhcmFtUGF0aHNbaV07CiAgICAgICAgICAgIHN0YXRlSW5RdWVyeVN0cmluZ1ttb2RlbFBhdGhdID0gcm9vdE5vZGUuZ2V0KG1vZGVsUGF0aCk7CiAgICAgICAgfQogICAgICAgIHJlcGxhY2VVcmxXaXRoTW9kZWxTdGF0ZShyb3V0ZSwgc3RhdGVJblF1ZXJ5U3RyaW5nKTsKICAgIH0pOwoKICAgIC8vI2RlYnVnCgogICAgLy8jZW5kX2RlYnVnCgovLwovLzxAZGVwZW5kcz5zdWJzY3JpcHRpb24uanMsIG1vZGVsLmpzLCBkZWNsYXJhdGl2ZS5qcywgdGVtcGxhdGUuanM8L0BkZXBlbmRzPgovLwoKCgoJZGVmYXVsdE9wdGlvbnMuc2VsZWN0ZWRDbGFzcyA9ICJzZWxlY3RlZCI7CglkZWZhdWx0T3B0aW9ucy50YWJWaWV3QXR0ciA9ICJ0YWItdmlldyI7CglkZWZhdWx0T3B0aW9ucy50YWJMaW5rQXR0ciA9ICJ0YWItbGluayI7CglkZWZhdWx0T3B0aW9ucy50YWJDb250YWluZXJOYW1lQXR0ciA9ICJ0YWItY29udGFpbmVyLW5hbWUiOwoKCWhtLndvcmtmbG93KCB7CgoJCS8vYSB0YWIgY2FuIGJlIHRhYlZpZXcgb3IgdGFiTGluawoJCXNlbGVjdFRhYjogZnVuY3Rpb24oIGUgKSB7CgkJCXZhciB0YWJJZCA9IHRoaXMuYXR0ciggZGVmYXVsdE9wdGlvbnMudGFiVmlld0F0dHIgKSB8fCB0aGlzLmF0dHIoIGRlZmF1bHRPcHRpb25zLnRhYkxpbmtBdHRyICksCgkJCQlzZWxlY3RlZENsYXNzID0gZS5oYW5kbGVyLm9wdGlvbnM7CgoJCQlpZiAoZS5wdWJsaXNoZXIuZ2V0KCkgPT0gdGFiSWQpIHsKCQkJCXRoaXMuYWRkQ2xhc3MoIHNlbGVjdGVkQ2xhc3MgKTsKCQkJfSBlbHNlIHsKCQkJCXRoaXMucmVtb3ZlQ2xhc3MoIHNlbGVjdGVkQ2xhc3MgKTsKCQkJfQoJCX0sCgoJCS8vYSB0YWIgY2FuIGJlIHRhYlZpZXcgb3IgdGFiTGluawoJCXNlbGVjdFRhYkluQ29udGFpbmVyOiBmdW5jdGlvbiggZSApIHsKCQkJdmFyIHNlbGVjdGVkVGFiSWQgPSBlLnB1Ymxpc2hlci5nZXQoKSwKCQkJCXRhYlZpZXdBdHRyID0gZGVmYXVsdE9wdGlvbnMudGFiVmlld0F0dHIsCgkJCQl0YWJMaW5rQXR0ciA9IGRlZmF1bHRPcHRpb25zLnRhYkxpbmtBdHRyLAoJCQkJb3B0aW9ucyA9IGUuaGFuZGxlci5vcHRpb25zLAoJCQkJdGFiTGlua0FuZFRhYlZpZXdTZWxlY3RvciA9IG9wdGlvbnMuc2VsZWN0b3IsCgkJCQlzZWxlY3RlZENsYXNzID0gb3B0aW9ucy5zZWxlY3RlZENsYXNzOwoKCQkJdGhpcy5maW5kKCB0YWJMaW5rQW5kVGFiVmlld1NlbGVjdG9yICkuYW5kU2VsZigpLmVhY2goIGZ1bmN0aW9uKCBpbmRleCwgZWxlbSApIHsKCQkJCXZhciAkZWxlbSA9ICQoIGVsZW0gKSwKCQkJCQl0YWJJZCA9ICRlbGVtLmF0dHIoIHRhYlZpZXdBdHRyICkgfHwgJGVsZW0uYXR0ciggdGFiTGlua0F0dHIgKTsKCgkJCQlpZiAodGFiSWQgPT0gc2VsZWN0ZWRUYWJJZCkgewoJCQkJCSRlbGVtLmFkZENsYXNzKCBzZWxlY3RlZENsYXNzICk7CgkJCQl9IGVsc2UgewoJCQkJCSRlbGVtLnJlbW92ZUNsYXNzKCBzZWxlY3RlZENsYXNzICk7CgkJCQl9CgkJCX0gKTsKCQl9Cgl9ICk7CgoJZnVuY3Rpb24gaGFuZGxlVGFiTGlua0NsaWNrKCBlICkgewoJCS8vdGhpcyBpcyB0aGUgc3Vic2NyaWJlciwgd2hpY2ggaXMgdGhlIG1vZGVsCgkJLy9lLmhhbmRsZXIub3B0aW9ucyBpcyB0aGUgdGFiIGlkCgkJdGhpcy5zZXQoIGUucHVibGlzaGVyLmF0dHIoIGUuaGFuZGxlci5vcHRpb25zICkgKTsKCQllLnByZXZlbnREZWZhdWx0KCk7CgkJZS5zdG9wUHJvcGFnYXRpb24oKTsKCgl9CgoJLy9hIHRhYiBjYW4gYmUgdGFiVmlldyBvciB0YWJMaW5rCgkvL2ZvciB0YWJMaW5rIHVzZSA8bGkgdGFiLWxpbms9Im5ld3MiIHRhYj0iY2F0ZWdvcnkiPk5ld3M8L2xpPgoJLy9pZiB5b3VyIHNlbGVjdGVkIGNsYXNzIGlzIG5vdCAic2VsZWN0ZWQiIGJ1dCAiYWN0aXZlIiB1c2UKCS8vIDxsaSB0YWItbGluaz0ibmV3cyIgdGFiPSJjYXRlZ29yeXxhY3RpdmUiPk5ld3M8L2xpPgoJLy8KCS8vZm9yIHRhYlZpZXcgdXNlIDxkaXYgdGFiLXZpZXc9Im5ld3MiIHRhYj0iY2F0ZWdvcnkiPmNvbnRlbnRzPC9kaXY+CgkvL29yIDxkaXYgdGFiLXZpZXc9Im5ld3MiIHRhYj0iY2F0ZWdvcnl8YWN0aXZlIj5jb250ZW50czwvZGl2PgoJYmluZGluZ3MoIHsKCgkJdGFiOiBmdW5jdGlvbiggZWxlbSwgcGF0aCwgYmluZGluZywgc2VsZWN0ZWRDbGFzcyApIHsKCgkJCXNlbGVjdGVkQ2xhc3MgPSBzZWxlY3RlZENsYXNzIHx8IGRlZmF1bHRPcHRpb25zLnNlbGVjdGVkQ2xhc3M7CgoJCQliaW5kaW5nLmFwcGVuZFN1YiggZWxlbSwgcGF0aCwgImluaXQgYWZ0ZXJVcGRhdGUiLCAiKnNlbGVjdFRhYiIsIHNlbGVjdGVkQ2xhc3MgKTsKCgkJCWlmICgkKCBlbGVtICkuYXR0ciggZGVmYXVsdE9wdGlvbnMudGFiTGlua0F0dHIgKSkgewoJCQkJYmluZGluZy5hcHBlbmRTdWIoIHBhdGgsIGVsZW0sICJjbGljayIsIGhhbmRsZVRhYkxpbmtDbGljaywgZGVmYXVsdE9wdGlvbnMudGFiTGlua0F0dHIgKTsKCQkJfQoKCQl9LAoKCQkvL2EgdGFiQ29udGFpbmVyIGNhbiBob2xkIHRhYkxpbmsgb3IgdGFiVmlldwoJCS8vaXQgY2FuIGJlCgkJLy8KCQkvLzx1bCB0YWItY29udGFpbmVyPSJjYXRlZ29yeSI+CgkJLy8JPGxpIHRhYi1saW5rPSJuZXdzIj5OZXdzPC9saT4KCQkvLwk8bGkgdGFiLWxpbms9Im9waW5pb24iPk9waW5pb248L2xpPgoJCS8vCTxsaSB0YWItbGluaz0ic3BvcnRzIj5TcG9ydHM8L2xpPgoJCS8vPC91bD4KCQkvLwoJCS8vPGRpdiBjbGFzcz0idGFicyIgdGFiLWNvbnRhaW5lcj0iY2F0ZWdvcnkiPgoJCS8vCTxkaXYgdGFiLXZpZXc9Im5ld3MiPmNvbnRlbnQ8L2Rpdj4KCQkvLwk8ZGl2IHRhYi12aWV3PSJvcGluaW9uIj5jb250ZW50PC9kaXY+CgkJLy88L2Rpdj4KCQkvL29wdGlvbnMgdXNhZ2UKCQkvL3RhYi1jb250YWluZXI9ImNhdGVnb3J5fGNvbnRhaW5lck5hbWUsc2VsZWN0ZWRDbGFzcyIKCQkvL2lmIHlvdSBoYXZlIHRhYiBjb250YWluZXIgbmVzdGVkIHdpdGhpbiBhbm90aGVyIHRhYiBjb250YWluZXIKCQkvL3lvdSBjYW4gdXNlIGNvbnRhaW5lciBuYW1lIHRvIHNwZWNpZnkgd2hpY2ggY29udGFpbmVyIGl0IGlzIGluCgkJdGFiQ29udGFpbmVyOiBmdW5jdGlvbiggZWxlbSwgcGF0aCwgY29udGV4dCwgb3B0aW9ucyApIHsKCgkJCW9wdGlvbnMgPSBvcHRpb25zIHx8ICIiOwoJCQlvcHRpb25zID0gb3B0aW9ucy5zcGxpdCggIiwiICk7CgoJCQl2YXIgdGFiVmlld0F0dHIgPSBkZWZhdWx0T3B0aW9ucy50YWJWaWV3QXR0ciwKCQkJCXRhYkxpbmtBdHRyID0gZGVmYXVsdE9wdGlvbnMudGFiTGlua0F0dHIsCgkJCQl0YWJDb250YWluZXJOYW1lQXR0ciA9IGRlZmF1bHRPcHRpb25zLnRhYkNvbnRhaW5lck5hbWVBdHRyLAoJCQkJY29udGFpbmVyTmFtZSA9IG9wdGlvbnNbMF0sCgkJCQlzZWxlY3RlZENsYXNzID0gb3B0aW9uc1sxXSwKCgkJCQl0YWJDb250YWluZXJTZWxlY3RvciA9IGNvbnRhaW5lck5hbWUgPwoJCQkJCSJbIiArIHRhYkNvbnRhaW5lck5hbWVBdHRyICsgIj0nIiArIGNvbnRhaW5lck5hbWUgKyAiJ10iIC8vd2l0aCBleHBsaWNpdCB0YWIgY29udGFpbmVyIG5hbWUKCQkJCQk6ICIiLCAvL25vIHRhYiBjb250YWluZXIgbmFtZQoKCQkJCXRhYkxpbmtTZWxlY3RvciA9ICJbIiArIHRhYkxpbmtBdHRyICsgIl0iICsgdGFiQ29udGFpbmVyU2VsZWN0b3IsCgoJCQkJdGFiTGlua0FuZFRhYlZpZXdTZWxlY3RvciA9IHRhYkxpbmtTZWxlY3RvciArICIsWyIgKyB0YWJWaWV3QXR0ciArICJdIiArIHRhYkNvbnRhaW5lclNlbGVjdG9yOwoKCQkJLy91cGRhdGUgdGhlIHRhYiBtb2RlbCB3aXRoIHRoZSB0YWJMaW5rIHdoZW4gY2xpY2sKCQkJY29udGV4dC5hcHBlbmRTdWIoIHBhdGgsIGVsZW0sICJjbGljayIsIGhhbmRsZVRhYkxpbmtDbGljaywgdGFiTGlua0F0dHIsIHRhYkxpbmtTZWxlY3RvciAvKmRlbGVnYXRlU2VsZWN0b3IqLyApOwoKCQkJLy8KCQkJLy9oaWdobGlnaHQgdGhlIHRhYiB3aGVuIHRoZSBtb2RlbCBjaGFuZ2UKCQkJY29udGV4dC5hcHBlbmRTdWIoIGVsZW0sIHBhdGgsICJpbml0MTAwIGFmdGVyVXBkYXRlIiwgIipzZWxlY3RUYWJJbkNvbnRhaW5lciIsIHsKCQkJCXNlbGVjdG9yOiB0YWJMaW5rQW5kVGFiVmlld1NlbGVjdG9yLAoJCQkJc2VsZWN0ZWRDbGFzczogc2VsZWN0ZWRDbGFzcyB8fCBkZWZhdWx0T3B0aW9ucy5zZWxlY3RlZENsYXNzCgkJCX0gKTsKCQl9Cgl9ICk7CgovL2RhdGEtc3ViPSJAYXBwOmFwcE5hbWUsb3B0aW9ucyIKCgoJdmFyIHJEb3QgPSAvXC4vZywKCQlhcHBTdG9yZSA9IHt9LAoJLy91c2VkIHRvIG1hdGNoICJhcHBOYW1lLG9wdGlvbnMiCgkJckFwcE9wdGlvbnMgPSAvXihbXixdKykoLCguKykpPyQvLAoJCXJMb2FkQXBwT3B0aW9ucyA9IC9eKFteLF0rKSgsKFteLF0rKSk/KCwoLispKT8kLzsKCgkvL3lvdSBhcHAgc2hvdWxkIGltcGxlbWVudCBsb2FkKGVsZW0sIG9wdGlvbnMpIGFuZCB1bmxvYWQoZWxlbSkgbWV0aG9kCgoJaG0uQXBwID0gaG0uQ2xhc3MuZXh0ZW5kKAoKCQkvL2luc3RhbmNlIG1lbWJlcnMKCQl7CgkJCS8vZXhpc3RzIHNpbXBseSBmb3IgZW5zdXJlIGFwcCBtdXN0IGhhdmUgYSBuYW1lCgkJCWluaXRpYWxpemU6IGZ1bmN0aW9uKCBhcHAgKSB7CgoJCQkJaWYgKCFhcHAubmFtZSkgewoJCQkJCXRocm93ICJBbiBhcHAgbXVzdCBoYXZlIGEgbmFtZS4iOwoJCQkJfQoJCQkJdGhpcy5jYWxsQmFzZSggImluaXRpYWxpemUiLCBhcHAgKTsKCgkJCX0sCgoJCQkvL2l0IGFkZCBhZGRpdGlvbmFsIGxvZ2ljIGJlc2lkZSB0aGUgb3JpZ2luYWwgbG9hZCBtZXRob2QKCQkJLy9zdWNoIGFzIGluc3RhbmNlIGNvdW50aW5nLCBpbnN0YW5jZSBhc3NvY2lhdGlvbiB3aXRoIHRoZSBjb250YWluZXIKCQkJLy9wcmVwYXJlIHRvIHVubG9hZCBmcm9tIHRoZSBjb250YWluZXIKCQkJbG9hZDogZnVuY3Rpb24oICR2aWV3Q29udGFpbmVyLCBobU1vZGVsQ29udGFpbmVyLCBvcHRpb25zICkgewoJCQkJaWYgKCEkdmlld0NvbnRhaW5lciB8fCAhdGhpcy5sb2FkYWJsZSgpKSB7CgkJCQkJcmV0dXJuOwoJCQkJfQoJCQkJdmFyIGFwcCA9IHRoaXMsCgkJCQkJYnVpbGRNb2RlbFJlc3VsdCwKCQkJCQlhcHBOYW1lID0gYXBwLm5hbWUsCgkJCQkJYXBwSW5zdGFuY2UgPSBpbnN0YW5jZU1hbmFnZXIuZ2V0KCAkdmlld0NvbnRhaW5lclswXSwgYXBwTmFtZSApOwoKCQkJCS8vZW5zdXJlIHRoYXQgYW4gYXBwbGljYXRpb24gY2FuIGJlIGxvYWRlZCBpbnRvIGEgY29udGFpbmVyIG9ubHkgb25jZQoJCQkJaWYgKGFwcEluc3RhbmNlKSB7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmIChhcHAubG9hZE1vZGVsKSB7CgkJCQkJYnVpbGRNb2RlbFJlc3VsdCA9IGFwcC5sb2FkTW9kZWwoIGhtTW9kZWxDb250YWluZXIsIG9wdGlvbnMgKTsKCgkJCQl9CgoJCQkJdmFyIGNvbnRpbnVhdGlvbiA9IGZ1bmN0aW9uKCkgewoKCQkJCQlhcHAubG9hZFZpZXcoICR2aWV3Q29udGFpbmVyLCBobU1vZGVsQ29udGFpbmVyICk7CgkJCQkJaW5zdGFuY2VNYW5hZ2VyLmFkZCggJHZpZXdDb250YWluZXJbMF0sIGhtTW9kZWxDb250YWluZXIucGF0aCwgYXBwTmFtZSwgYXBwICk7CgkJCQkJJHZpZXdDb250YWluZXIuYmluZCggImV4aXRBcHAuIiArIGFwcE5hbWUsIGZ1bmN0aW9uKCBlICkgewoJCQkJCQlhcHAudW5sb2FkKCAkKCB0aGlzICkgKTsKCQkJCQkJZS5zdG9wUHJvcGFnYXRpb24oKTsKCQkJCQl9ICk7CgoJCQkJCWFwcC5pbnN0YW5jZUNvdW50Kys7CgkJCQkJYXBwLnVpZCsrOwoJCQkJfTsKCgkJCQlpZiAoaXNQcm9taXNlKCBidWlsZE1vZGVsUmVzdWx0ICkpIHsKCgkJCQkJYnVpbGRNb2RlbFJlc3VsdC5kb25lKCBjb250aW51YXRpb24gKTsKCgkJCQl9IGVsc2UgewoJCQkJCWNvbnRpbnVhdGlvbigpOwoKCQkJCX0KCgkJCX0sCgoJCQl1bmxvYWQ6IGZ1bmN0aW9uKCAkdmlld0NvbnRhaW5lciApIHsKCgkJCQl2YXIgYXBwTmFtZSA9IHRoaXMubmFtZTsKCQkJCXZhciBhcHBJbnN0YW5jZSA9IGluc3RhbmNlTWFuYWdlci5nZXQoICR2aWV3Q29udGFpbmVyWzBdLCBhcHBOYW1lICk7CgoJCQkJdGhpcy51bmxvYWRWaWV3KCAkdmlld0NvbnRhaW5lciApOwoKCQkJCXRoaXMudW5sb2FkTW9kZWwoIGFwcEluc3RhbmNlLm1vZGVsTm9kZSApOwoKCQkJCWluc3RhbmNlTWFuYWdlci5yZW1vdmUoICR2aWV3Q29udGFpbmVyWzBdLCBhcHBOYW1lICk7CgoJCQkJJHZpZXdDb250YWluZXIudW5iaW5kKCAiZXhpdEFwcC4iICsgYXBwTmFtZSApOwoKCQkJCXRoaXMuaW5zdGFuY2VDb3VudC0tOwoJCQl9LAoKCQkJLy9mdW5jdGlvbiggbW9kZWxDb250YWluZXIsIG9wdGlvbnMgKSB7fQoJCQlnZXRJbml0aWFsRGF0YTogbnVsbCwKCgkJCS8vZGVmYXVsdCBpbXBsZW1lbnRhdGlvbiBvZiBsb2FkTW9kZWwgaXMgdG8gY2FsbAoJCQkvL2FwcC5nZXRJbml0aWFsRGF0YSgpIGFuZCBwdXQgdGhlIHJlc3VsdCBpbnRvIG1vZGVsCgkJCS8vCgkJCS8vWW91IGNhbiBzZXQgbG9hZE1vZGVsIHRvIG51bGwgdG8gc3BlY2lmeSB0aGF0CgkJCS8vIHRoZXJlIGlzIG5vIG5lZWQgdG8gYnVpbGQgbW9kZWwKCQkJbG9hZE1vZGVsOiBmdW5jdGlvbiggaG1Nb2RlbENvbnRhaW5lciwgb3B0aW9ucyApIHsKCQkJCXZhciBhcHAgPSB0aGlzOwoJCQkJaWYgKCFhcHAuZ2V0SW5pdGlhbERhdGEpIHsKCQkJCQl0aHJvdyAiYXBwLmdldEluaXRpYWxEYXRhIGlzIG5vdCBpbXBsZW1lbnRlZCI7CgkJCQl9CgoJCQkJdmFyIGRhdGEgPSBhcHAuZ2V0SW5pdGlhbERhdGEoIGhtTW9kZWxDb250YWluZXIsIG9wdGlvbnMgKTsKCgkJCQlpZiAoaXNQcm9taXNlKCBkYXRhICkpIHsKCQkJCQlyZXR1cm4gZGF0YS5kb25lKCBmdW5jdGlvbiggZGF0YSApIHsKCQkJCQkJYXBwLmdldE1vZGVsTm9kZSggaG1Nb2RlbENvbnRhaW5lciApLnNldCggZGF0YSApOwoJCQkJCX0gKTsKCQkJCX0gZWxzZSB7CgkJCQkJYXBwLmdldE1vZGVsTm9kZSggaG1Nb2RlbENvbnRhaW5lciApLnNldCggZGF0YSApOwoJCQkJfQoKCQkJfSwKCgkJCXVubG9hZE1vZGVsOiBmdW5jdGlvbiggbW9kZWxOYW1lc3BhY2UgKSB7CgkJCQlpZiAodGhpcy5sb2FkTW9kZWwpIHsKCQkJCQlobS5kZWwoIG1vZGVsTmFtZXNwYWNlICk7CgkJCQl9CgkJCX0sCgoJCQkvL3RoZSBkZWZhdWx0IGxvYWRWaWV3IHdpbGwgY3JlYXRlIGEgY29udGFpbmVyCgkJCS8vPGRpdiBhcHBuYW1lPSJ4eHgiIG5zPSJ4eHgiPjwvZGl2PgoJCQlsb2FkVmlldzogZnVuY3Rpb24oICR2aWV3Q29udGFpbmVyLCBobU1vZGVsQ29udGFpbmVyICkgewoKCQkJCXZhciBuYW1lc3BhY2UgPSB0aGlzLmdldE1vZGVsTm9kZSggaG1Nb2RlbENvbnRhaW5lciApLnBhdGgsCgkJCQkJdmlld1dyYXBwZXIgPSAkKCAiPGRpdj48L2Rpdj4iICkKCQkJCQkJLmF0dHIoICJhcHBuYW1lIiwgdGhpcy5uYW1lICkKCQkJCQkJLmF0dHIoICJucyIsIG5hbWVzcGFjZSApOwoKCQkJCXZpZXdXcmFwcGVyLmhtRGF0YSggIm5zIiwgbmFtZXNwYWNlICk7CgoJCQkJdmlld1dyYXBwZXIuYXBwZW5kVG8oICR2aWV3Q29udGFpbmVyICkudG1wbCgKCQkJCQl0aGlzLmdldFRlbXBsYXRlT3B0aW9ucygpLAoJCQkJCW5hbWVzcGFjZSApOwoKCQkJfSwKCgkJCXVubG9hZFZpZXc6IGZ1bmN0aW9uKCAkdmlld0NvbnRhaW5lciApIHsKCQkJCSR2aWV3Q29udGFpbmVyLmZpbmQoICI+IFthcHBuYW1lPSciICsgdGhpcy5uYW1lICsgIiddIiApLnJlbW92ZSgpOwoJCQl9LAoKCQkJLy90ZW1wbGF0ZU9wdGlvbnMgaXMgYWJvdXQgdGVtcGxhdGUgaWQKCQkJLy9ieSBkZWZhdWx0IHlvdSBjYW4gZ2V0IHRlbXBsYXRlT3B0aW9ucyBwcm9wZXJ0eSBvcgoJCQkvL3RoZSBhcHBsaWNhdGlvbiBuYW1lIGFzIHRlbXBsYXRlT3B0aW9ucwoJCQlnZXRUZW1wbGF0ZU9wdGlvbnM6IGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuIHRoaXMudGVtcGxhdGVPcHRpb25zIHx8IHRoaXMubmFtZTsKCgkJCX0sCgoJCQlnZXRNb2RlbE5vZGU6IGZ1bmN0aW9uKCBobU1vZGVsQ29udGFpbmVyICkgewoJCQkJdmFyIHN1YlBhdGggPSB0aGlzLnN1YlBhdGggfHwgdGhpcy5uYW1lLnJlcGxhY2UoIHJEb3QsICJfIiApOwoJCQkJLy9pZiB3ZSBoYXZlIG1vcmUgdGhhbiBvbmUgaW5zdGFuY2UsIHRoZSBzdWJQYXRoIG5lZWQgdG8gYmUKCQkJCS8vYmUgc3VmZml4IHdpdGggYW4gdWlkIHRvIG1ha2UgdGhpcyBuYW1lc3BhY2UgdW5pcXVlCgkJCQlpZiAodGhpcy51aWQpIHsKCQkJCQlzdWJQYXRoID0gc3ViUGF0aCArIHRoaXMudWlkOwoJCQkJfQoJCQkJcmV0dXJuIGhtTW9kZWxDb250YWluZXIuY2QoIHN1YlBhdGggKTsKCgkJCX0sCgoJCQlpbnN0YW5jZUNvdW50OiAwLAoKCQkJdWlkOiAwLAoKCQkJLy9pZiB3ZSB3YW50IHRvIHVzZSBzaW5nbGV0b24gdXNlIHRoZSBmb2xsb3dpbmcKCQkJLy8JCWxvYWRhYmxlOiBmdW5jdGlvbigpIHsKCQkJLy8JCQlyZXR1cm4gIXRoaXMuaW5zdGFuY2VDb3VudDsKCQkJLy8JCX0sCgkJCWxvYWRhYmxlOiByZXR1cm5UcnVlLAoKCQkJdGVtcGxhdGVPcHRpb25zOiBudWxsLAoKCQkJLy9wYXRoIHRoYXQgd3JhcCB0aGlzIG1vZGVsLAoJCQkvL2J1dCB0aGlzIHNob3VsZCBub3QgYmUgdXNlZCBieSBjb25zdW1lcgoJCQlzdWJQYXRoOiBudWxsCgoKCQl9LAoKCQkvL3N0YXRpYyBtZW1iZXJzCgkJewoKCQkJLy9obS5BcHAuYWRkKHsKCQkJLy8gIG5hbWU6ICJnbWFpbCIsIC8veW91IG11c3QgaGF2ZSBhIG5hbWUKCQkJLy8gIGxvYWQ6IGZ1bmN0aW9uICh2aWV3Q29udGFpbmVyLCBtb2RlbENvbnRhaW5lciwgb3B0aW9ucykge30sCgkJCS8vICB1bmFwcDogZnVuY3Rpb24gKHZpZXdDb250YWluZXIsIG1vZGVsQ29udGFpbmVyKSB7fSwgLy9vcHRpb25hbAoJCQkvLyAgLy9vcHRpb25hbCwgYnkgZGVmYXVsdCBpdCBpcyBub3QgbG9hZGFibGUgaWYgaXQgaGFzIGJlZW4gbG9hZGVkIG9uY2UKCQkJLy8gIC8vaWYgaXQgaXMgbG9hZGFibGU6IHRydWUgLCBpdCBtZWFucyBpdCBpcyBhbHdheXMgbG9hZGFibGUKCQkJLy8gIGxvYWRhYmxlOiBmdW5jdGlvbiAoKSB7fSwKCQkJLy8gfSk7CgkJCWFkZDogZnVuY3Rpb24oIGFwcCApIHsKCQkJCWlmICghKGFwcCBpbnN0YW5jZW9mIHRoaXMpKSB7CgkJCQkJYXBwID0gdGhpcyggYXBwICk7CgkJCQl9CgkJCQlhcHBTdG9yZVthcHAubmFtZV0gPSBhcHA7CgkJCX0sCgoJCQlyZW1vdmU6IGZ1bmN0aW9uKCBhcHBOYW1lICkgewoJCQkJaWYgKGFwcFN0b3JlW2FwcE5hbWVdICYmICFhcHBTdG9yZVthcHBOYW1lXS5pbnN0YW5jZUNvdW50KSB7CgkJCQkJZGVsZXRlIGFwcFN0b3JlW2FwcE5hbWVdOwoJCQkJfQoJCQl9LAoKCQkJZ2V0OiBmdW5jdGlvbiggYXBwTmFtZSApIHsKCQkJCXJldHVybiBhcHBTdG9yZVthcHBOYW1lXTsKCQkJfSwKCgkJCS8vZmV0Y2ggdGhlIGRlZmluaXRpb24gb2YgdGhlIGFwcGxpY2F0aW9uCgkJCWxvYWREZWZpbml0aW9uOiBmdW5jdGlvbiggYXBwTmFtZSApIHsKCQkJCXJldHVybiBfbG9hZGVyLmxvYWQoIGFwcE5hbWUgKyAiLmFwcCIgKTsKCQkJfSwKCgkJCS8vc3VwcG9ydCB0aGUgZm9sbG93aW5nIGZlYXR1cmUKCQkJLy9ieSBkZWZhdWx0IGNvbnRhaW5lciBpcyBib2R5LCBpZiBjb250YWluZXIgaXMgbWlzc2luZwoJCQkvL2htLkFwcC5sb2FkQXBwKGFwcE5hbWUpOwoJCQkvLwoJCQkvL2htLkFwcC5sb2FkQXBwKGFwcE5hbWUsIHZpZXdDb250YWluZXIpOyAvL3ZpZXdDb250YWluZXIgaXMgalF1ZXJ5CgkJCS8vaG0uQXBwLmxvYWRBcHAoYXBwTmFtZSwgbW9kZWxDb250YWluZXIpOyAvL21vZGVsQ29udGFpbmVyIGlzIHN0cmluZwoJCQkvLwoJCQkvL2NvbnRhaW5lciBpcyBqUXVlcnkgb2JqZWN0LCBvciBET00gZWxlbWVudAoJCQkvL2FwcE5hbWUgaXMgc3RyaW5nLAoJCQkvL29wdGlvbnMgaXMgb3B0aW9uYWwKCQkJbG9hZEFwcDogZnVuY3Rpb24oIGFwcE5hbWUsICR2aWV3Q29udGFpbmVyLCBobU1vZGVsQ29udGFpbmVyLCBvcHRpb25zICkgewoKCQkJCWlmIChhcmd1bWVudHMubGVuZ3RoID09IDEpIHsKCgkJCQkJJHZpZXdDb250YWluZXIgPSAkKCBkb2N1bWVudC5ib2R5ICk7CgkJCQkJaG1Nb2RlbENvbnRhaW5lciA9IHJvb3ROb2RlOwoKCQkJCX0gZWxzZSBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PSAyKSB7CgoJCQkJCWhtTW9kZWxDb250YWluZXIgPSByb290Tm9kZTsKCgkJCQl9CgoJCQkJdmFyIGFwcCA9IGFwcFN0b3JlW2FwcE5hbWVdOwoKCQkJCWlmIChhcHApIHsKCgkJCQkJYXBwLmxvYWQoICR2aWV3Q29udGFpbmVyLCBobU1vZGVsQ29udGFpbmVyLCBvcHRpb25zICk7CgoJCQkJfSBlbHNlIHsKCgkJCQkJdGhpcy5sb2FkRGVmaW5pdGlvbiggYXBwTmFtZSApLmRvbmUoIGZ1bmN0aW9uKCkgewoJCQkJCQlhcHBTdG9yZVthcHBOYW1lXS5sb2FkKCAkdmlld0NvbnRhaW5lciwgaG1Nb2RlbENvbnRhaW5lciwgb3B0aW9ucyApOwoJCQkJCX0gKTsKCQkJCX0KCQkJfSwKCgkJCS8vY29udGFpbmVyIGJ5IGRlZmF1bHQgaXMgZG9jdW1lbnQuYm9keQoJCQkvL2htLkFwcC51bmxvYWRBcHAoYXBwTmFtZSkKCQkJLy9obS5BcHAudW5sb2FkQXBwKGNvbnRhaW5lciwgYXBwTmFtZSk7CgkJCXVubG9hZEFwcDogZnVuY3Rpb24oIGFwcE5hbWUsICR2aWV3Q29udGFpbmVyICkgewoJCQkJaWYgKGlzVW5kZWZpbmVkKCBhcHBOYW1lICkpIHsKCQkJCQlhcHBOYW1lID0gJHZpZXdDb250YWluZXI7CgkJCQkJJHZpZXdDb250YWluZXIgPSAkKCAiYm9keSIgKTsKCQkJCX0KCgkJCQl2YXIgYXBwSW5zdGFuY2UgPSBpbnN0YW5jZU1hbmFnZXIuZ2V0KCAkdmlld0NvbnRhaW5lciwgYXBwTmFtZSApOwoJCQkJaWYgKGFwcEluc3RhbmNlKSB7CgkJCQkJYXBwSW5zdGFuY2UuYXBwLnVubG9hZCggJHZpZXdDb250YWluZXIgKTsKCQkJCX0KCQkJfQoKCQl9ICk7CgoJdmFyIGluc3RhbmNlTWFuYWdlciA9IHsKCgkJZ2V0OiBmdW5jdGlvbiggdmlld0NvbnRhaW5lckVsZW0sIGFwcE5hbWUgKSB7CgkJCXJldHVybiB0aGlzLmFwcERhdGEoIHZpZXdDb250YWluZXJFbGVtIClbYXBwTmFtZV07CgkJfSwKCgkJYWRkOiBmdW5jdGlvbiggdmlld0NvbnRhaW5lckVsZW0sIG1vZGVsQ29udGFpbmVyUGF0aCwgYXBwTmFtZSwgYXBwICkgewoJCQl0aGlzLmFwcERhdGEoIHZpZXdDb250YWluZXJFbGVtIClbYXBwTmFtZV0gPSB7CgkJCQlhcHA6IGFwcCwKCQkJCW1vZGVsTm9kZTogYXBwLmdldE1vZGVsTm9kZSggaG0oIG1vZGVsQ29udGFpbmVyUGF0aCApICksCgkJCQltb2RlbENvbnRhaW5lcjogbW9kZWxDb250YWluZXJQYXRoCgkJCX07CgkJfSwKCgkJcmVtb3ZlOiBmdW5jdGlvbiggdmlld0NvbnRhaW5lckVsZW0sIGFwcE5hbWUgKSB7CgkJCWRlbGV0ZSB0aGlzLmFwcERhdGEoIHZpZXdDb250YWluZXJFbGVtIClbYXBwTmFtZV07CgkJfSwKCgkJYXBwRGF0YTogZnVuY3Rpb24oIHZpZXdDb250YWluZXJFbGVtLCByZWFkT25seSApIHsKCQkJdmFyIGFwcERhdGEgPSAkKCB2aWV3Q29udGFpbmVyRWxlbSApLmhtRGF0YSggImFwcCIgKTsKCQkJaWYgKCFyZWFkT25seSAmJiAhYXBwRGF0YSkgewoJCQkJYXBwRGF0YSA9IHsgfTsKCQkJCSQoIHZpZXdDb250YWluZXJFbGVtICkuaG1EYXRhKCAiYXBwIiwgYXBwRGF0YSApOwoJCQl9CgkJCXJldHVybiBhcHBEYXRhOwoJCX0KCX07CgoJYmluZGluZ3MoIHsKCQkvL2FwcD0iL3xnbWFpbCxvcHRpb25zIgoJCS8vZGF0YS1zdWI9ImFwcDovfGdtYWlsLG9wdGlvbnMiCgkJYXBwOiBmdW5jdGlvbiggZWxlbSwgcGF0aCwgY29udGV4dCwgb3B0aW9ucyApIHsKCgkJCXZhciBtYXRjaCA9IHJBcHBPcHRpb25zLmV4ZWMoICQudHJpbSggb3B0aW9ucyApICksCgkJCQlhcHBOYW1lID0gbWF0Y2hbMV0sCgkJCQlhcHBPcHRpb25zID0gbWF0Y2hbM107CgoJCQlobS5BcHAubG9hZEFwcCggYXBwTmFtZSwgJCggZWxlbSApLCBobSggcGF0aCApLCBhcHBPcHRpb25zICk7CgkJfSwKCgkJLy9leGl0LWFwcD0iX3xnbWFpbCIKCQkvL3VubG9hZCBhcHAgZnJvbSBwYXJlbnQgY29udGFpbmVyCgkJLy9kYXRhLXN1Yj0iZXhpdEFwcDpffGdtYWlsIgoJCWV4aXRBcHA6IGZ1bmN0aW9uKCBlbGVtLCBwYXJzZUNvbnRleHQsIGJpbmRpbmcsIG9wdGlvbnMgKSB7CgkJCSQoIGVsZW0gKS5tYXBFdmVudCggImNsaWNrIiwgImV4aXRBcHAuIiArIG9wdGlvbnMgKTsKCQl9LAoKCQkvL2xvYWQgYW4gYXBwIHdoZW4gY2xpY2sKCQkvL2xvYWQtYXBwPSIvfGdtYWlsLCNjb250YWluZXJJZCxvcHRpb25zIgoJCS8vZGF0YS1zdWI9ImxvYWRBcHA6L3xnbWFpbCwjY29udGFpbmVySWQsb3B0aW9ucyIKCQlsb2FkQXBwOiBmdW5jdGlvbiggZWxlbSwgcGF0aCwgY29udGV4dCwgb3B0aW9ucyApIHsKCgkJCXZhciBvcHRpb25QYXJ0cyA9IHJMb2FkQXBwT3B0aW9ucy5leGVjKCAkLnRyaW0oIG9wdGlvbnMgKSApLAoJCQkJYXBwTmFtZSA9IG9wdGlvblBhcnRzWzFdLAoJCQkJJHZpZXdDb250YWluZXIgPSAkKCBvcHRpb25QYXJ0c1szXSApLAoJCQkJb3RoZXJPcHRpb25zID0gb3B0aW9uUGFydHNbNV07CgoJCQkkKCBlbGVtICkuY2xpY2soIGZ1bmN0aW9uKCkgewoJCQkJaG0uQXBwLmxvYWRBcHAoIGFwcE5hbWUsICR2aWV3Q29udGFpbmVyLCBobSggcGF0aCApLCBvdGhlck9wdGlvbnMgKTsKCQkJfSApOwoJCX0sCgoJCS8vdW5sb2FkQXBwCgkJLy91bmxvYWQgYW4gYXBwIHdoZW4gY2xpY2sKCQkvL3VubG9hZC1hcHA9IjpffGdtYWlsLCNjb250YWluZXIiCgkJLy9kYXRhLXN1Yj0idW5sb2FkQXBwOl98Z21haWwsI2NvbnRhaW5lciIKCQl1bmxvYWRBcHA6IGZ1bmN0aW9uKCBlbGVtLCBwYXRoLCBjb250ZXh0LCBvcHRpb25zICkgewoKCQkJdmFyIG9wdGlvblBhcnRzID0gckxvYWRBcHBPcHRpb25zLmV4ZWMoICQudHJpbSggb3B0aW9ucyApICksCgkJCQlhcHBOYW1lID0gb3B0aW9uUGFydHNbMV0sCgkJCQkkdmlld0NvbnRhaW5lciA9ICQoIG9wdGlvblBhcnRzWzNdICk7CgoJCQkkKCBlbGVtICkuY2xpY2soIGZ1bmN0aW9uKCkgewoJCQkJaG0uQXBwLnVubG9hZEFwcCggYXBwTmFtZSwgJHZpZXdDb250YWluZXIgKTsKCQkJfSApOwoJCX0KCX0gKTsKCgl2YXIgX2NsZWFuRGF0YUZvckFwcCA9ICQuY2xlYW5EYXRhOwoKCSQuY2xlYW5EYXRhID0gZnVuY3Rpb24oIGVsZW1zICkgewoJCSQoIGVsZW1zICkuZWFjaCggZnVuY3Rpb24oKSB7CgkJCXZhciBhcHBEYXRhID0gaW5zdGFuY2VNYW5hZ2VyLmFwcERhdGEoIHRoaXMsIHRydWUgKTsKCQkJaWYgKGFwcERhdGEpIHsKCQkJCWZvciAodmFyIGtleSBpbiBhcHBEYXRhKSB7CgkJCQkJdmFyIGFwcCA9IGFwcERhdGFba2V5XTsKCQkJCQlkZWxldGUgYXBwRGF0YVtrZXldOwoJCQkJCWFwcC51bmxvYWQoIHRoaXMsIHRydWUgKTsKCQkJCX0KCQkJfQoJCX0gKTsKCQlfY2xlYW5EYXRhRm9yQXBwKCBlbGVtcyApOwoJfTsKCglfbG9hZGVyKCAiYXBwIiwgImpzIiwgewoJCXVybDogZnVuY3Rpb24oIG1vZHVsZUlkICkgewoJCQkvL2lmIG1vZHVsZSBpZCBpcyBsaWtlICpoZWxsbywgdGhlbiBpdCBpcyB3aWRnZXQKCQkJdmFyIGZpbGVOYW1lID0gX2xvYWRlci5maWxlTmFtZSggbW9kdWxlSWQgKTsKCQkJcmV0dXJuIGZpbGVOYW1lLnN0YXJ0c1dpdGgoICJhcGsuIiApID8KCQkJCS8vaWYgYXBwIGlzIHBhY2thZ2UgaXMgYXBrLCB0aGVuIGxvYWQgaXQKCQkJCS8vaW4gYXBrIGZvbGRlcgoJCQkJImFway8iICsgZmlsZU5hbWUuc3Vic3RyKCA0ICkgKyAiL21haW4uanMiIDoKCgkJCQkvL290aGVyd2lzZSBsb2FkIGluIGFwcCBmb2xkZXIKCQkJCSJhcHAvIiArIGZpbGVOYW1lICsgIi5qcyI7CgkJfQoJfSApOwoKCgp9KSggalF1ZXJ5LCB3aW5kb3cgKTsKCg==",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Fri, 07 Nov 2014 03:16:39 GMT",
                    "Content-Length": "243997",
                    "Date": "Fri, 07 Nov 2014 03:16:39 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}