{
    "url": "http://localhost:9999/rpflorence/snack/builds/snack-slick.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Open redirection (DOM-based)",
    "issueType": 5243152,
    "severity": "Low",
    "confidence": "Firm",
    "issueBackground": "DOM-based open redirection vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this data into the target of a redirection in an unsafe way. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will cause a redirection to an arbitrary external domain. This behavior can be leveraged to facilitate phishing attacks against users of the application. The ability to use an authentic application URL, targeting the correct domain with a valid SSL certificate (if SSL is used) lends credibility to the phishing attack because many users, even if they verify these features, will not notice the subsequent redirection to a different domain.<br><br><b>Note:</b> If an attacker is able to control the start of the string that is passed to the redirection API, then it may be possible to escalate this vulnerability into a JavaScript injection attack, by using a URL with the javascript: pseudo-protocol to execute arbitrary script code when the URL is processed by the browser.",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based open redirection vulnerabilities is not to dynamically set redirection targets using data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing an arbitrary URL as a redirection target. In general, this is best achieved by using a whitelist of URLs that are permitted redirection targets, and strictly validating the target against this list before performing the redirection.",
    "issueDetail": "The application may be vulnerable to DOM-based open redirection. Data is read from <b>document.location.pathname</b> and written to <b>the 'open()' function of an XMLHttpRequest object</b> via the following statements:<ul><li>url = document.location.pathname</li><li>url = url.substr(0, trimPosition)</li><li>xhr.open(method.toUpperCase(), url, open.async, options.user, options.password)</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/rpflorence/snack/builds/snack-slick.js",
                "path": "/rpflorence/snack/builds/snack-slick.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9ycGZsb3JlbmNlL3NuYWNrL2J1aWxkcy9zbmFjay1zbGljay5qcyBIVFRQLzEuMQ0KSG9zdDogbG9jYWxob3N0Ojk5OTkNCg0K",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogNTI4NzINCkFjY2VwdC1SYW5nZXM6IGJ5dGVzDQpDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2phdmFzY3JpcHQNCkRhdGU6IFNhdCwgMDggTm92IDIwMTQgMDQ6NTY6MzkgR01UDQpMYXN0LU1vZGlmaWVkOiBTYXQsIDA4IE5vdiAyMDE0IDA0OjU2OjM5IEdNVA0KDQovKiEKICAqIHNuYWNrLmpzIChjKSBSeWFuIEZsb3JlbmNlCiAgKiBodHRwczovL2dpdGh1Yi5jb20vcnBmbG9yZW5jZS9zbmFjawogICogTUlUIExpY2Vuc2UKICAqIEluc3BpcmF0aW9uIGFuZCBjb2RlIGFkYXB0ZWQgZnJvbQogICogIE1vb1Rvb2xzICAgICAgKGMpIFZhbGVyaW8gUHJvaWV0dGkgICBNSVQgbGljZW5zZQogICogIGpRdWVyeSAgICAgICAgKGMpIEpvaG4gUmVzaWcgICAgICAgICBEdWFsIGxpY2Vuc2UgTUlUIG9yIEdQTCBWZXJzaW9uIDIKICAqICBjb250ZW50TG9hZGVkIChjKSBEaWVnbyBQZXJpbmkgICAgICAgTUlUIExpY2Vuc2UKICAqICBaZXB0by5qcyAgICAgIChjKSBUaG9tYXMgRnVjaHMgICAgICAgTUlUIExpY2Vuc2UKKi8KCmlmICh0eXBlb2YgT2JqZWN0LmNyZWF0ZSAhPSAnZnVuY3Rpb24nKXsKICAvLyBFUzUgT2JlamVjdC5jcmVhdGUKICBPYmplY3QuY3JlYXRlID0gZnVuY3Rpb24gKG8pewogICAgZnVuY3Rpb24gRigpIHt9CiAgICBGLnByb3RvdHlwZSA9IG8KICAgIHJldHVybiBuZXcgRgogIH0KfQoKIWZ1bmN0aW9uKHdpbmRvdyl7CiAgdmFyIHNuYWNrID0gd2luZG93LnNuYWNrID0ge30KICAgICwgZ3VpZCA9IDAKICAgICwgdG9TdHJpbmcgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nCiAgICAsIGluZGV4T2YgPSBbXS5pbmRleE9mCiAgICAsIHB1c2ggPSBbXS5wdXNoCgogIHNuYWNrLmV4dGVuZCA9IGZ1bmN0aW9uICgpewogICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT0gMSkKICAgICAgcmV0dXJuIHNuYWNrLmV4dGVuZChzbmFjaywgYXJndW1lbnRzWzBdKQoKICAgIHZhciB0YXJnZXQgPSBhcmd1bWVudHNbMF0KCiAgICBmb3IgKHZhciBrZXksIGkgPSAxLCBsID0gYXJndW1lbnRzLmxlbmd0aDsgaSA8IGw7IGkrKykKICAgICAgZm9yIChrZXkgaW4gYXJndW1lbnRzW2ldKQogICAgICAgIHRhcmdldFtrZXldID0gYXJndW1lbnRzW2ldW2tleV0KCiAgICByZXR1cm4gdGFyZ2V0CiAgfQoKICBzbmFjay5leHRlbmQoewogICAgdjogJzEuMi4zJywKCiAgICBiaW5kOiBmdW5jdGlvbiAoZm4sIGNvbnRleHQsIGFyZ3MpIHsKICAgICAgYXJncyA9IGFyZ3MgfHwgW107CiAgICAgIHJldHVybiBmdW5jdGlvbiAoKXsKICAgICAgICBwdXNoLmFwcGx5KGFyZ3MsIGFyZ3VtZW50cyk7CiAgICAgICAgcmV0dXJuIGZuLmFwcGx5KGNvbnRleHQsIGFyZ3MpCiAgICAgIH0KICAgIH0sCgogICAgcHVuY2g6IGZ1bmN0aW9uIChvYmosIG1ldGhvZCwgZm4sIGF1dG8pewogICAgICB2YXIgb2xkID0gb2JqW21ldGhvZF0KICAgICAgb2JqW21ldGhvZF0gPSBhdXRvID8gZnVuY3Rpb24gKCl7CiAgICAgICAgb2xkLmFwcGx5KG9iaiwgYXJndW1lbnRzKQogICAgICAgIHJldHVybiBmbi5hcHBseShvYmosIGFyZ3VtZW50cykKICAgICAgfSA6IGZ1bmN0aW9uICgpewogICAgICAgIHZhciBhcmdzID0gW10uc2xpY2UuY2FsbChhcmd1bWVudHMsIDApCiAgICAgICAgYXJncy51bnNoaWZ0KHNuYWNrLmJpbmQob2xkLCBvYmopKQogICAgICAgIHJldHVybiBmbi5hcHBseShvYmosIGFyZ3MpCiAgICAgIH0KICAgIH0sCgogICAgY3JlYXRlOiBmdW5jdGlvbiAocHJvdG8sIGV4dCl7CiAgICAgIHZhciBvYmogPSBPYmplY3QuY3JlYXRlKHByb3RvKQogICAgICBpZiAoIWV4dCkKICAgICAgICByZXR1cm4gb2JqCgogICAgICBmb3IgKHZhciBpIGluIGV4dCkgewogICAgICAgIGlmICghZXh0Lmhhc093blByb3BlcnR5KGkpKQogICAgICAgICAgY29udGludWUKCiAgICAgICAgaWYgKCFwcm90b1tpXSB8fCB0eXBlb2YgZXh0W2ldICE9ICdmdW5jdGlvbicpewogICAgICAgICAgb2JqW2ldID0gZXh0W2ldCiAgICAgICAgICBjb250aW51ZQogICAgICAgIH0KCiAgICAgICAgc25hY2sucHVuY2gob2JqLCBpLCBleHRbaV0pCiAgICAgIH0KCiAgICAgIHJldHVybiBvYmoKICAgIH0sCgogICAgaWQ6IGZ1bmN0aW9uICgpewogICAgICByZXR1cm4gKytndWlkCiAgICB9LAoKICAgIGVhY2g6IGZ1bmN0aW9uIChvYmosIGZuLCBjb250ZXh0KXsKICAgICAgaWYgKG9iai5sZW5ndGggPT09IHZvaWQrMCl7IC8vIGxvb3NlIGNoZWNrIGZvciBvYmplY3QsIHdlIHdhbnQgYXJyYXktbGlrZSBvYmplY3RzIHRvIGJlIHRyZWF0ZWQgYXMgYXJyYXlzCiAgICAgICAgZm9yICh2YXIga2V5IGluIG9iaikKICAgICAgICAgIGlmIChvYmouaGFzT3duUHJvcGVydHkoa2V5KSkKICAgICAgICAgICAgZm4uY2FsbChjb250ZXh0LCBvYmpba2V5XSwga2V5LCBvYmopOwogICAgICAgIHJldHVybiBvYmoKICAgICAgfQoKICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSBvYmoubGVuZ3RoOyBpIDwgbDsgaSsrKQogICAgICAgIGZuLmNhbGwoY29udGV4dCwgb2JqW2ldLCBpLCBvYmopCiAgICAgIHJldHVybiBvYmoKICAgIH0sCgogICAgcGFyc2VKU09OOiBmdW5jdGlvbihqc29uKSB7CiAgICAgIC8vIGFkYXB0ZWQgZnJvbSBqUXVlcnkKICAgICAgaWYgKHR5cGVvZiBqc29uICE9ICdzdHJpbmcnKQogICAgICAgIHJldHVybgoKICAgICAganNvbiA9IGpzb24ucmVwbGFjZSgvXlxzK3xccyskL2csICcnKQoKICAgICAgdmFyIGlzVmFsaWQgPSAvXltcXSw6e31cc10qJC8udGVzdChqc29uLnJlcGxhY2UoL1xcKD86WyJcXFwvYmZucnRdfHVbMC05YS1mQS1GXXs0fSkvZywgIkAiKQogICAgICAgIC5yZXBsYWNlKC8iW14iXFxcblxyXSoifHRydWV8ZmFsc2V8bnVsbHwtP1xkKyg/OlwuXGQqKT8oPzpbZUVdWytcLV0/XGQrKT8vZywgIl0iKQogICAgICAgIC5yZXBsYWNlKC8oPzpefDp8LCkoPzpccypcWykrL2csICIiKSkKCiAgICAgIGlmICghaXNWYWxpZCkKICAgICAgICB0aHJvdyAiSW52YWxpZCBKU09OIgogICAgICAKICAgICAgdmFyIEpTT04gPSB3aW5kb3cuSlNPTiAvLyBzYXZlcyBhIGNvdXBsZSBieXRlcwogICAgICByZXR1cm4gSlNPTiAmJiBKU09OLnBhcnNlID8gSlNPTi5wYXJzZShqc29uKSA6IChuZXcgRnVuY3Rpb24oInJldHVybiAiICsganNvbikpKCkKICAgIH0sCgogICAgaXNBcnJheTogZnVuY3Rpb24gKG9iail7CiAgICAgIHJldHVybiBvYmogaW5zdGFuY2VvZiBBcnJheSB8fCB0b1N0cmluZy5jYWxsKG9iaikgPT0gIltvYmplY3QgQXJyYXldIgogICAgfSwKCiAgICBpbmRleE9mOiBpbmRleE9mID8gZnVuY3Rpb24oaXRlbSwgYXJyYXkpewogICAgICAgIHJldHVybiBpbmRleE9mLmNhbGwoYXJyYXksIGl0ZW0pCiAgICAgIH0gOiBmdW5jdGlvbiAoaXRlbSwgYXJyYXkpewogICAgICBmb3IgKHZhciBpID0gMCwgbCA9IGFycmF5Lmxlbmd0aDsgaSA8IGw7IGkrKykKICAgICAgICBpZiAoYXJyYXlbaV0gPT09IGl0ZW0pCiAgICAgICAgICByZXR1cm4gaQoKICAgICAgcmV0dXJuIC0xCiAgICB9CiAgfSkKfSh3aW5kb3cpOwohZnVuY3Rpb24gKHNuYWNrLCBkb2N1bWVudCl7CiAgdmFyIHByb3RvID0ge30KICAgICwgcXVlcnkKCiAgc25hY2sud3JhcCA9IGZ1bmN0aW9uIChub2RlcywgY29udGV4dCl7CiAgICAvLyBwYXNzZWQgaW4gYSBDU1Mgc2VsZWN0b3IKICAgIGlmICh0eXBlb2Ygbm9kZXMgPT0gJ3N0cmluZycpCiAgICAgIG5vZGVzID0gcXVlcnkobm9kZXMsIGNvbnRleHQpCgogICAgLy8gcGFzc2VkIGluIHNpbmdsZSBub2RlCiAgICBpZiAoIW5vZGVzLmxlbmd0aCkKICAgICAgbm9kZXMgPSBbbm9kZXNdCgogICAgdmFyIHdyYXBwZXIgPSBPYmplY3QuY3JlYXRlKHByb3RvKQogICAgICAsIGkgPSAwCiAgICAgICwgbCA9IG5vZGVzLmxlbmd0aAoKICAgIGZvciAoOyBpIDwgbDsgaSsrKQogICAgICB3cmFwcGVyW2ldID0gbm9kZXNbaV0KCiAgICB3cmFwcGVyLmxlbmd0aCA9IGwKICAgIHdyYXBwZXIuaWQgPSBzbmFjay5pZCgpCiAgICByZXR1cm4gd3JhcHBlcgogIH0KCiAgc25hY2suZXh0ZW5kKHNuYWNrLndyYXAsIHsKICAgIGRlZmluZTogZnVuY3Rpb24obmFtZSwgZm4pewogICAgICBpZiAodHlwZW9mIG5hbWUgIT0gJ3N0cmluZycpewogICAgICAgIGZvciAodmFyIGkgaW4gbmFtZSkKICAgICAgICAgIHNuYWNrLndyYXAuZGVmaW5lKGksIG5hbWVbaV0pCiAgICAgICAgcmV0dXJuCiAgICAgIH0KICAgICAgcHJvdG9bbmFtZV0gPSBmbgogICAgfSwKCiAgICBkZWZpbmVFbmdpbmU6IGZ1bmN0aW9uIChmbil7CiAgICAgIHF1ZXJ5ID0gZm4KICAgIH0KICB9KQoKICAvLyBRU0EgZGVmYXVsdCBzZWxlY3RvciBlbmdpbmUsIHN1cHBvcnRzIHJlYWwgYnJvd3NlcnMgYW5kIElFOCsKICBzbmFjay53cmFwLmRlZmluZUVuZ2luZShmdW5jdGlvbiAoc2VsZWN0b3IsIGNvbnRleHQpewogICAgaWYgKHR5cGVvZiBjb250ZXh0ID09ICdzdHJpbmcnKQogICAgICBjb250ZXh0ID0gZG9jdW1lbnQucXVlcnlTZWxlY3Rvcihjb250ZXh0KQoKICAgIHJldHVybiAoY29udGV4dCB8fCBkb2N1bWVudCkucXVlcnlTZWxlY3RvckFsbChzZWxlY3RvcikKICB9KQp9KHNuYWNrLCBkb2N1bWVudCkKIWZ1bmN0aW9uIChzbmFjaywgd2luZG93LCBkb2N1bWVudCl7CiAgdmFyIGFkZCAgICAgICAgICAgID0gZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lciA/ICdhZGRFdmVudExpc3RlbmVyJyA6ICdhdHRhY2hFdmVudCcKICAgICwgcmVtb3ZlICAgICAgICAgPSBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyID8gJ3JlbW92ZUV2ZW50TGlzdGVuZXInIDogJ2RldGFjaEV2ZW50JwogICAgLCBwcmVmaXggICAgICAgICA9IGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIgPyAnJyA6ICdvbicKICAgICwgcmVhZHkgICAgICAgICAgPSBmYWxzZQogICAgLCB0b3AgICAgICAgICAgICA9IHRydWUKICAgICwgcm9vdCAgICAgICAgICAgPSBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQKICAgICwgcmVhZHlIYW5kbGVycyAgPSBbXQoKICBzbmFjay5leHRlbmQoewogICAgc3RvcFByb3BhZ2F0aW9uOiBmdW5jdGlvbiAoZXZlbnQpewogICAgICBpZiAoZXZlbnQuc3RvcFByb3BhZ2F0aW9uKQogICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpCiAgICAgIGVsc2UKICAgICAgICBldmVudC5jYW5jZWxCdWJibGUgPSB0cnVlCiAgICB9LAoKICAgIHByZXZlbnREZWZhdWx0OiBmdW5jdGlvbiAoZXZlbnQpewogICAgICBpZiAoZXZlbnQucHJldmVudERlZmF1bHQpCiAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKQogICAgICBlbHNlCiAgICAgICAgZXZlbnQucmV0dXJuVmFsdWUgPSBmYWxzZQogICAgfQogIH0pCgogIHNuYWNrLmxpc3RlbmVyID0gZnVuY3Rpb24gKHBhcmFtcywgaGFuZGxlcil7CiAgICBpZiAocGFyYW1zLmRlbGVnYXRlKXsKICAgICAgcGFyYW1zLmNhcHR1cmUgPSB0cnVlCiAgICAgIF9oYW5kbGVyID0gaGFuZGxlcgogICAgICBoYW5kbGVyID0gZnVuY3Rpb24gKGV2ZW50KXsKICAgICAgICAvLyBhZGFwdGVkIGZyb20gWmVwdG8KICAgICAgICB2YXIgdGFyZ2V0ID0gZXZlbnQudGFyZ2V0IHx8IGV2ZW50LnNyY0VsZW1lbnQKICAgICAgICAgICwgbm9kZXMgPSB0eXBlb2YgcGFyYW1zLmRlbGVnYXRlID09ICdzdHJpbmcnCiAgICAgICAgICAgID8gc25hY2sud3JhcChwYXJhbXMuZGVsZWdhdGUsIHBhcmFtcy5ub2RlKQogICAgICAgICAgICA6IHBhcmFtcy5kZWxlZ2F0ZShwYXJhbXMubm9kZSkKCiAgICAgICAgd2hpbGUgKHRhcmdldCAmJiBzbmFjay5pbmRleE9mKHRhcmdldCwgbm9kZXMpID09IC0xICkKICAgICAgICAgIHRhcmdldCA9IHRhcmdldC5wYXJlbnROb2RlCgogICAgICAgIGlmICh0YXJnZXQgJiYgISh0YXJnZXQgPT09IHRoaXMpICYmICEodGFyZ2V0ID09PSBkb2N1bWVudCkpCiAgICAgICAgICBfaGFuZGxlci5jYWxsKHRhcmdldCwgZXZlbnQsIHRhcmdldCkKICAgICAgfQogICAgfQoKICAgIGlmIChwYXJhbXMuY29udGV4dCkKICAgICAgaGFuZGxlciA9IHNuYWNrLmJpbmQoaGFuZGxlciwgcGFyYW1zLmNvbnRleHQpCgogICAgdmFyIG1ldGhvZHMgPSB7CiAgICAgIGF0dGFjaDogZnVuY3Rpb24gKCl7CiAgICAgICAgcGFyYW1zLm5vZGVbYWRkXSgKICAgICAgICAgIHByZWZpeCArIHBhcmFtcy5ldmVudCwKICAgICAgICAgIGhhbmRsZXIsCiAgICAgICAgICBwYXJhbXMuY2FwdHVyZQogICAgICAgICkKICAgICAgfSwKCiAgICAgIGRldGFjaDogZnVuY3Rpb24gKCl7CiAgICAgICAgcGFyYW1zLm5vZGVbcmVtb3ZlXSgKICAgICAgICAgIHByZWZpeCArIHBhcmFtcy5ldmVudCwKICAgICAgICAgIGhhbmRsZXIsCiAgICAgICAgICBwYXJhbXMuY2FwdHVyZQogICAgICAgICkKICAgICAgfSwKCiAgICAgIGZpcmU6IGZ1bmN0aW9uICgpewogICAgICAgIGhhbmRsZXIuYXBwbHkocGFyYW1zLm5vZGUsIGFyZ3VtZW50cykKICAgICAgfQogICAgfQoKICAgIG1ldGhvZHMuYXR0YWNoKCkKCiAgICByZXR1cm4gbWV0aG9kcwogIH0KCgoKCiAgc25hY2sucmVhZHkgPSBmdW5jdGlvbiAoaGFuZGxlcil7CiAgICBpZiAocmVhZHkpewogICAgICBoYW5kbGVyLmFwcGx5KGRvY3VtZW50KQogICAgICByZXR1cm4KICAgIH0KICAgIHJlYWR5SGFuZGxlcnMucHVzaChoYW5kbGVyKQogIH0KCiAgLy8gYWRhcHRlZCBmcm9tIGNvbnRlbnRsb2FkZWQKICBmdW5jdGlvbiBpbml0KGUpIHsKICAgIGlmIChlLnR5cGUgPT0gJ3JlYWR5c3RhdGVjaGFuZ2UnICYmIGRvY3VtZW50LnJlYWR5U3RhdGUgIT0gJ2NvbXBsZXRlJykKICAgICAgcmV0dXJuCgogICAgKGUudHlwZSA9PSAnbG9hZCcgPyB3aW5kb3cgOiBkb2N1bWVudClbcmVtb3ZlXShwcmVmaXggKyBlLnR5cGUsIGluaXQsIGZhbHNlKQoKICAgIGlmICghcmVhZHkgJiYgKHJlYWR5ID0gdHJ1ZSkpCiAgICAgIHNuYWNrLmVhY2gocmVhZHlIYW5kbGVycywgZnVuY3Rpb24gKGhhbmRsZXIpewogICAgICAgIGhhbmRsZXIuYXBwbHkoZG9jdW1lbnQpCiAgICAgIH0pCiAgfQoKICBmdW5jdGlvbiBwb2xsKCkgewogICAgdHJ5IHsKICAgICAgcm9vdC5kb1Njcm9sbCgnbGVmdCcpCiAgICB9IGNhdGNoKGUpIHsgCiAgICAgIHNldFRpbWVvdXQocG9sbCwgNTApCiAgICAgIHJldHVybgogICAgfQogICAgaW5pdCgncG9sbCcpCiAgfQoKICBpZiAoZG9jdW1lbnQuY3JlYXRlRXZlbnRPYmplY3QgJiYgcm9vdC5kb1Njcm9sbCkgewogICAgdHJ5IHsKICAgICAgdG9wID0gIXdpbmRvdy5mcmFtZUVsZW1lbnQKICAgIH0gY2F0Y2goZSkge30KICAgIGlmICh0b3ApCiAgICAgIHBvbGwoKTsKICB9CgogIGRvY3VtZW50W2FkZF0ocHJlZml4ICsgJ0RPTUNvbnRlbnRMb2FkZWQnLCBpbml0LCBmYWxzZSkKICBkb2N1bWVudFthZGRdKHByZWZpeCArICdyZWFkeXN0YXRlY2hhbmdlJywgaW5pdCwgZmFsc2UpCiAgd2luZG93W2FkZF0ocHJlZml4ICsgJ2xvYWQnLCBpbml0LCBmYWxzZSkKfShzbmFjaywgd2luZG93LCBkb2N1bWVudCk7CiFmdW5jdGlvbiAoc25hY2spewogIHNuYWNrLnB1Ymxpc2hlciA9IGZ1bmN0aW9uIChvYmopewogICAgdmFyIGNoYW5uZWxzID0ge30KICAgIG9iaiA9IG9iaiB8fCB7fQoKICAgIHNuYWNrLmV4dGVuZChvYmosIHsKICAgICAgc3Vic2NyaWJlOiBmdW5jdGlvbiAoY2hhbm5lbCwgaGFuZGxlciwgY29udGV4dCl7CiAgICAgICAgdmFyIHN1YnNjcmlwdGlvbiA9IHsKICAgICAgICAgIGZuOiBoYW5kbGVyLAogICAgICAgICAgY3R4dDogKGNvbnRleHQgfHwge30pCiAgICAgICAgfQoKICAgICAgICBpZiAoIWNoYW5uZWxzW2NoYW5uZWxdKQogICAgICAgICAgY2hhbm5lbHNbY2hhbm5lbF0gPSBbXQoKICAgICAgICB2YXIgcHVibGlrID0gewogICAgICAgICAgYXR0YWNoOiBmdW5jdGlvbiAoKXsKICAgICAgICAgICAgY2hhbm5lbHNbY2hhbm5lbF0ucHVzaChzdWJzY3JpcHRpb24pCiAgICAgICAgICB9LAogICAgICAgICAgZGV0YWNoOiBmdW5jdGlvbiAoKXsKICAgICAgICAgICAgY2hhbm5lbHNbY2hhbm5lbF0uc3BsaWNlKHNuYWNrLmluZGV4T2YoaGFuZGxlciwgY2hhbm5lbHNbY2hhbm5lbF0pLCAxKQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBwdWJsaWsuYXR0YWNoKCkKICAgICAgICByZXR1cm4gcHVibGlrCiAgICAgIH0sCgogICAgICBwdWJsaXNoOiBmdW5jdGlvbiAoY2hhbm5lbCwgYXJnc0FycmF5KXsKICAgICAgICBpZiAoIWNoYW5uZWxzW2NoYW5uZWxdKQogICAgICAgICAgcmV0dXJuIGZhbHNlCgogICAgICAgIHNuYWNrLmVhY2goY2hhbm5lbHNbY2hhbm5lbF0sIGZ1bmN0aW9uIChzdWJzY3JpcHRpb24pewogICAgICAgICAgc3Vic2NyaXB0aW9uLmZuLmFwcGx5KHN1YnNjcmlwdGlvbi5jdHh0LCBhcmdzQXJyYXkgfHwgW10pCiAgICAgICAgfSkKCiAgICAgICAgcmV0dXJuIGNoYW5uZWxzW2NoYW5uZWxdLmxlbmd0aAogICAgICB9CiAgICB9KQoKICAgIHJldHVybiBvYmoKICB9CgogIHNuYWNrLnB1Ymxpc2hlcihzbmFjaykKfShzbmFjayk7CiFmdW5jdGlvbihzbmFjaywgd2luZG93LCBkb2N1bWVudCl7CiAgc25hY2suSlNPTlAgPSBmdW5jdGlvbihwYXJhbXMsIGNhbGxiYWNrKXsKICAgIC8vIGFkYXB0ZWQgZnJvbSBaZXB0bwogICAgdmFyIGpzb25wU3RyaW5nID0gJ2pzb25wJyArIHNuYWNrLmlkKCkKICAgICAgLCBzY3JpcHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzY3JpcHQnKQogICAgICAsIHJ1bm5pbmcgPSBmYWxzZQoKICAgICAgc25hY2suSlNPTlBbanNvbnBTdHJpbmddID0gZnVuY3Rpb24oZGF0YSl7CiAgICAgICAgcnVubmluZyA9IGZhbHNlCiAgICAgICAgZGVsZXRlIHNuYWNrLkpTT05QW2pzb25wU3RyaW5nXQogICAgICAgIGNhbGxiYWNrKGRhdGEpCiAgICAgIH0KCiAgICAgIGlmICh0eXBlb2YgcGFyYW1zLmRhdGEgPT0gJ29iamVjdCcpCiAgICAgICAgcGFyYW1zLmRhdGEgPSBzbmFjay50b1F1ZXJ5U3RyaW5nKHBhcmFtcy5kYXRhKQoKICAgIHZhciBwdWJsaWsgPSB7CiAgICAgIHNlbmQ6IGZ1bmN0aW9uICgpewogICAgICAgIHJ1bm5pbmcgPSB0cnVlCiAgICAgICAgc2NyaXB0LnNyYyA9IHBhcmFtcy51cmwgKyAnPycgKyBwYXJhbXMua2V5ICsgJz1zbmFjay5KU09OUC4nICsganNvbnBTdHJpbmcgKyAnJicgKyBwYXJhbXMuZGF0YQogICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCdoZWFkJylbMF0uYXBwZW5kQ2hpbGQoc2NyaXB0KQogICAgICB9LAoKICAgICAgY2FuY2VsOiBmdW5jdGlvbiAoKXsKICAgICAgICBydW5uaW5nICYmIHNjcmlwdC5wYXJlbnROb2RlICYmIHNjcmlwdC5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKHNjcmlwdCkKICAgICAgICBydW5uaW5nID0gZmFsc2UKICAgICAgICBzbmFjay5KU09OUFtqc29ucFN0cmluZ10gPSBmdW5jdGlvbiAoKXsKICAgICAgICAgIGRlbGV0ZSBzbmFjay5KU09OUFtqc29ucFN0cmluZ10KICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICBpZiAocGFyYW1zLm5vdyAhPT0gZmFsc2UpCiAgICAgIHB1Ymxpay5zZW5kKCkKCiAgICByZXR1cm4gcHVibGlrCiAgfQoKICBzbmFjay50b1F1ZXJ5U3RyaW5nID0gZnVuY3Rpb24ob2JqZWN0LCBiYXNlKXsKICAgIC8vIGFkYXB0ZWQgZnJvbSBNb29Ub29scwogICAgdmFyIHF1ZXJ5U3RyaW5nID0gW10KCiAgICBzbmFjay5lYWNoKG9iamVjdCwgZnVuY3Rpb24odmFsdWUsIGtleSl7CiAgICAgIGlmIChiYXNlKQogICAgICAgIGtleSA9IGJhc2UgKyAnWycgKyBrZXkgKyAnXScKCiAgICAgIHZhciByZXN1bHQKCiAgICAgIGlmIChzbmFjay5pc0FycmF5KHZhbHVlKSl7CiAgICAgICAgdmFyIHFzID0ge30KICAgICAgICBzbmFjay5lYWNoKHZhbHVlLCBmdW5jdGlvbih2YWwsIGkpewogICAgICAgICAgcXNbaV0gPSB2YWwKICAgICAgICB9KQogICAgICAgIHJlc3VsdCA9IHNuYWNrLnRvUXVlcnlTdHJpbmcocXMsIGtleSkKICAgICAgfQogICAgICBlbHNlIGlmICh0eXBlb2YgdmFsdWUgPT0gJ29iamVjdCcpCiAgICAgICAgcmVzdWx0ID0gc25hY2sudG9RdWVyeVN0cmluZyh2YWx1ZSwga2V5KQogICAgICBlbHNlCiAgICAgICAgcmVzdWx0ID0ga2V5ICsgJz0nICsgZW5jb2RlVVJJQ29tcG9uZW50KHZhbHVlKQoKICAgICAgaWYgKHZhbHVlICE9PSBudWxsKQogICAgICAgIHF1ZXJ5U3RyaW5nLnB1c2gocmVzdWx0KQogICAgfSkKCiAgICByZXR1cm4gcXVlcnlTdHJpbmcuam9pbignJicpCiAgfQoKICB2YXIgeGhyT2JqZWN0ID0gKGZ1bmN0aW9uKCl7CiAgICAvLyBhZGFwdGVkIGZyb20gTW9vVG9vbHMKICAgIHZhciBYTUxIVFRQID0gZnVuY3Rpb24oKXsKICAgICAgcmV0dXJuIG5ldyBYTUxIdHRwUmVxdWVzdCgpOwogICAgfQoKICAgIHZhciBNU1hNTDIgPSBmdW5jdGlvbigpewogICAgICByZXR1cm4gbmV3IEFjdGl2ZVhPYmplY3QoJ01TWE1MMi5YTUxIVFRQJyk7CiAgICB9CgogICAgdmFyIE1TWE1MID0gZnVuY3Rpb24oKXsKICAgICAgcmV0dXJuIG5ldyBBY3RpdmVYT2JqZWN0KCdNaWNyb3NvZnQuWE1MSFRUUCcpOwogICAgfQoKICAgIHRyeSB7CiAgICAgIFhNTEhUVFAoKQogICAgICByZXR1cm4gWE1MSFRUUAogICAgfSBjYXRjaCAoZSl7CiAgICAgIHRyeSB7CiAgICAgICAgTVNYTUwyKCkKICAgICAgICByZXR1cm4gTVNYTUwyCiAgICAgIH0gY2F0Y2ggKGUpewogICAgICAgIE1TWE1MKCkKICAgICAgICByZXR1cm4gTVNYTUwKICAgICAgfQogICAgfQogIH0pKCk7CgogIGZ1bmN0aW9uIGVtcHR5KCl7fQoKICBzbmFjay5yZXF1ZXN0ID0gZnVuY3Rpb24gKG9wdGlvbnMsIGNhbGxiYWNrKXsKICAgIC8vIGFkYXB0ZWQgZnJvbSBNb29Ub29scwogICAgaWYgKCEodGhpcyBpbnN0YW5jZW9mIHNuYWNrLnJlcXVlc3QpKQogICAgICByZXR1cm4gbmV3IHNuYWNrLnJlcXVlc3Qob3B0aW9ucywgY2FsbGJhY2spCgogICAgdmFyIHNlbGYgPSB0aGlzCiAgICBzZWxmLm9wdGlvbnMgPSBzbmFjay5leHRlbmQoe30sIHNlbGYub3B0aW9ucywgb3B0aW9ucykKICAgIHNlbGYuY2FsbGJhY2sgPSBjYWxsYmFjawogICAgc2VsZi54aHIgPSBuZXcgeGhyT2JqZWN0CiAgICBzZWxmLmhlYWRlcnMgPSBzZWxmLm9wdGlvbnMuaGVhZGVycwogICAgaWYgKHNlbGYub3B0aW9ucy5ub3cgIT09IGZhbHNlKQogICAgICBzZWxmLnNlbmQoKQogIH0KCiAgc25hY2sucmVxdWVzdC5wcm90b3R5cGUgPSB7CgogICAgb3B0aW9uczogey8qCiAgICAgIHVzZXI6ICcnLAogICAgICBwYXNzd29yZDogJycsKi8KICAgICAgZXhjZXB0aW9uOiBlbXB0eSwKICAgICAgdXJsOiAnJywKICAgICAgZGF0YTogJycsCiAgICAgIG1ldGhvZDogJ2dldCcsCiAgICAgIG5vdzogdHJ1ZSwKICAgICAgaGVhZGVyczogewogICAgICAgICdYLVJlcXVlc3RlZC1XaXRoJzogJ1hNTEh0dHBSZXF1ZXN0JywKICAgICAgICAnQWNjZXB0JzogJ3RleHQvamF2YXNjcmlwdCwgdGV4dC9odG1sLCBhcHBsaWNhdGlvbi94bWwsIHRleHQveG1sLCAqLyonCiAgICAgIH0sCiAgICAgIGFzeW5jOiB0cnVlLAogICAgICBlbXVsYXRpb246IHRydWUsCiAgICAgIHVybEVuY29kZWQ6IHRydWUsCiAgICAgIGVuY29kaW5nOiAndXRmLTgnCiAgICB9LAoKICAgIG9uU3RhdGVDaGFuZ2U6IGZ1bmN0aW9uKCl7CiAgICAgIHZhciBzZWxmID0gdGhpcwogICAgICAgICwgeGhyID0gc2VsZi54aHIKCiAgICAgIGlmICh4aHIucmVhZHlTdGF0ZSAhPSA0IHx8ICFzZWxmLnJ1bm5pbmcpIHJldHVybgogICAgICBzZWxmLnJ1bm5pbmcgPSBmYWxzZQogICAgICBzZWxmLnN0YXR1cyA9IDAKCiAgICAgIHRyeXsKICAgICAgICB2YXIgc3RhdHVzID0geGhyLnN0YXR1cwogICAgICAgIHNlbGYuc3RhdHVzID0gKHN0YXR1cyA9PSAxMjIzKSA/IDIwNCA6IHN0YXR1cwogICAgICB9IGNhdGNoKGUpIHt9CgogICAgICB4aHIub25yZWFkeXN0YXRlY2hhbmdlID0gZW1wdHk7CgogICAgICB2YXIgYXJncyA9IHNlbGYuc3RhdHVzID49IDIwMCAmJiBzZWxmLnN0YXR1cyA8IDMwMAogICAgICAgID8gW2ZhbHNlLCBzZWxmLnhoci5yZXNwb25zZVRleHQgfHwgJycsIHNlbGYueGhyLnJlc3BvbnNlWE1MXQogICAgICAgIDogW3NlbGYuc3RhdHVzXQoKICAgICAgc2VsZi5jYWxsYmFjay5hcHBseShzZWxmLCBhcmdzKQogICAgfSwKICAKICAgIHNldEhlYWRlcjogZnVuY3Rpb24obmFtZSwgdmFsdWUpewogICAgICB0aGlzLmhlYWRlcnNbbmFtZV0gPSB2YWx1ZTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIGdldEhlYWRlcjogZnVuY3Rpb24obmFtZSl7CiAgICAgIHRyeSB7CiAgICAgICAgcmV0dXJuIHRoaXMueGhyLmdldFJlc3BvbnNlSGVhZGVyKG5hbWUpCiAgICAgIH0gY2F0Y2goZSkgewogICAgICAgIHJldHVybiBudWxsCiAgICAgIH0KICAgIH0sCiAgCiAgICBzZW5kOiBmdW5jdGlvbigpewogICAgICB2YXIgc2VsZiA9IHRoaXMKICAgICAgICAsIG9wdGlvbnMgPSBzZWxmLm9wdGlvbnMKCiAgICAgIGlmIChzZWxmLnJ1bm5pbmcpIHJldHVybiBzZWxmOwoKICAgICAgc2VsZi5ydW5uaW5nID0gdHJ1ZTsKCiAgICAgIHZhciBkYXRhID0gb3B0aW9ucy5kYXRhIHx8ICcnCiAgICAgICAgLCB1cmwgPSBTdHJpbmcob3B0aW9ucy51cmwpCiAgICAgICAgLCBtZXRob2QgPSBvcHRpb25zLm1ldGhvZC50b0xvd2VyQ2FzZSgpCgogICAgICBpZiAodHlwZW9mIGRhdGEgIT0gJ3N0cmluZycpCiAgICAgICAgZGF0YSA9IHNuYWNrLnRvUXVlcnlTdHJpbmcoZGF0YSkKCiAgICAgIGlmIChvcHRpb25zLmVtdWxhdGlvbiAmJiBzbmFjay5pbmRleE9mKG1ldGhvZCwgWydnZXQnLCAncG9zdCddKSA8IDApewogICAgICAgIHZhciBfbWV0aG9kID0gJ19tZXRob2Q9JyArIG1ldGhvZAogICAgICAgIGRhdGEgPSAoZGF0YSkgPyBfbWV0aG9kICsgJyYnICsgZGF0YSA6IF9tZXRob2QKICAgICAgICBtZXRob2QgPSAncG9zdCcKICAgICAgfQoKICAgICAgaWYgKG9wdGlvbnMudXJsRW5jb2RlZCAmJiBzbmFjay5pbmRleE9mKG1ldGhvZCwgWydwb3N0JywgJ3B1dCddKSA+IC0xKXsKICAgICAgICB2YXIgZW5jb2RpbmcgPSAob3B0aW9ucy5lbmNvZGluZykgPyAnOyBjaGFyc2V0PScgKyBvcHRpb25zLmVuY29kaW5nIDogJycKICAgICAgICBzZWxmLmhlYWRlcnNbJ0NvbnRlbnQtdHlwZSddID0gJ2FwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZCcgKyBlbmNvZGluZwogICAgICB9CgogICAgICBpZiAoIXVybCkKICAgICAgICB1cmwgPSBkb2N1bWVudC5sb2NhdGlvbi5wYXRobmFtZQoKICAgICAgdmFyIHRyaW1Qb3NpdGlvbiA9IHVybC5sYXN0SW5kZXhPZignLycpCiAgICAgIGlmICh0cmltUG9zaXRpb24gPiAtMSAmJiAodHJpbVBvc2l0aW9uID0gdXJsLmluZGV4T2YoJyMnKSkgPiAtMSkKICAgICAgICB1cmwgPSB1cmwuc3Vic3RyKDAsIHRyaW1Qb3NpdGlvbikKCiAgICAgIGlmIChkYXRhICYmIG1ldGhvZCA9PSAnZ2V0Jyl7CiAgICAgICAgdXJsICs9ICh1cmwuaW5kZXhPZignPycpID4gLTEgPyAnJicgOiAnPycpICsgZGF0YQogICAgICAgIGRhdGEgPSBudWxsCiAgICAgIH0KCiAgICAgIHZhciB4aHIgPSBzZWxmLnhocgoKICAgICAgeGhyLm9wZW4obWV0aG9kLnRvVXBwZXJDYXNlKCksIHVybCwgb3Blbi5hc3luYywgb3B0aW9ucy51c2VyLCBvcHRpb25zLnBhc3N3b3JkKQogICAgICBpZiAob3B0aW9ucy51c2VyICYmICd3aXRoQ3JlZGVudGlhbHMnIGluIHhocikgeGhyLndpdGhDcmVkZW50aWFscyA9IHRydWUKICAgIAogICAgICB4aHIub25yZWFkeXN0YXRlY2hhbmdlID0gc25hY2suYmluZChzZWxmLm9uU3RhdGVDaGFuZ2UsIHNlbGYpCgogICAgICBmb3IgKHZhciBpIGluIHNlbGYuaGVhZGVycyl7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIHhoci5zZXRSZXF1ZXN0SGVhZGVyKGksIHNlbGYuaGVhZGVyc1tpXSkKICAgICAgICB9IGNhdGNoIChlKXsKICAgICAgICAgIG9wdGlvbnMuZXhjZXB0aW9uLmFwcGx5KHNlbGYsIFtpLCBzZWxmLmhlYWRlcnNbaV1dKQogICAgICAgIH0KICAgICAgfQoKICAgICAgeGhyLnNlbmQoZGF0YSkKICAgICAgaWYgKCFvcHRpb25zLmFzeW5jKSBzZWxmLm9uU3RhdGVDaGFuZ2UoKQogICAgCiAgICAgIHJldHVybiBzZWxmCiAgICB9LAoKICAgIGNhbmNlbDogZnVuY3Rpb24oKXsKICAgICAgdmFyIHNlbGYgPSB0aGlzCgogICAgICBpZiAoIXNlbGYucnVubmluZykKICAgICAgICByZXR1cm4gc2VsZgoKICAgICAgc2VsZi5ydW5uaW5nID0gZmFsc2UKCiAgICAgIHZhciB4aHIgPSBzZWxmLnhocgogICAgICB4aHIuYWJvcnQoKQoKICAgICAgeGhyLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGVtcHR5CgogICAgICBzZWxmLnhociA9IG5ldyB4aHJPYmplY3QoKQogICAgICByZXR1cm4gc2VsZgogICAgfQogIH0KfShzbmFjaywgd2luZG93LCBkb2N1bWVudCkKIWZ1bmN0aW9uKHNuYWNrLCBkb2N1bWVudCl7CiAgc25hY2sud3JhcC5kZWZpbmUoewogICAgZGF0YTogZnVuY3Rpb24gKCl7CiAgICAgIC8vIEFQSSBpbnNwaXJlZCBieSBqUXVlcnkKICAgICAgdmFyIHN0b3JhZ2UgPSB7fQoKICAgICAgcmV0dXJuIGZ1bmN0aW9uIChrZXksIHZhbHVlKXsKICAgICAgICB2YXIgZGF0YSA9IHN0b3JhZ2VbdGhpcy5pZF0KCiAgICAgICAgaWYgKCFkYXRhKQogICAgICAgICAgZGF0YSA9IHN0b3JhZ2VbdGhpcy5pZF0gPSB7fQoKICAgICAgICBpZiAodmFsdWUgPT09IHZvaWQrMSkKICAgICAgICAgIHJldHVybiBkYXRhW2tleV0KCiAgICAgICAgcmV0dXJuIGRhdGFba2V5XSA9IHZhbHVlCiAgICAgIH0gIAogICAgfSgpLAoKICAgIGVhY2g6IGZ1bmN0aW9uIChmbiwgY29udGV4dCl7CiAgICAgIHJldHVybiBzbmFjay5lYWNoKHRoaXMsIGZuLCBjb250ZXh0KQogICAgfSwKICAKICAgIGFkZENsYXNzOiBmdW5jdGlvbiAoY2xhc3NOYW1lKXsKICAgICAgLy8gYWRhcHRlZCBmcm9tIE1vb1Rvb2xzCiAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24gKGVsZW1lbnQpewogICAgICAgIGlmIChjbGVhbihlbGVtZW50LmNsYXNzTmFtZSkuaW5kZXhPZihjbGFzc05hbWUpID4gLTEpCiAgICAgICAgICByZXR1cm4KICAgICAgICBlbGVtZW50LmNsYXNzTmFtZSA9IGNsZWFuKGVsZW1lbnQuY2xhc3NOYW1lICsgJyAnICsgY2xhc3NOYW1lKQogICAgICB9KQogICAgfSwKCiAgICByZW1vdmVDbGFzczogZnVuY3Rpb24gKGNsYXNzTmFtZSl7CiAgICAgIC8vIGFkYXB0ZWQgZnJvbSBNb29Ub29scwogICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uIChlbGVtZW50KXsKICAgICAgICBlbGVtZW50LmNsYXNzTmFtZSA9IGVsZW1lbnQuY2xhc3NOYW1lLnJlcGxhY2UobmV3IFJlZ0V4cCgnKF58XFxzKScgKyBjbGFzc05hbWUgKyAnKD86XFxzfCQpJyksICckMScpCiAgICAgIH0pCiAgICB9LAoKICAgIGF0dGFjaDogZnVuY3Rpb24gKGV2ZW50LCBoYW5kbGVyLCAvKiBpbnRlcm5hbCAqLyBkZWxlZ2F0aW9uKXsKICAgICAgdmFyIHNwbGl0ID0gZXZlbnQuc3BsaXQoJy4nKQogICAgICAgICwgbGlzdGVuZXJzID0gW10KCiAgICAgIGlmIChzcGxpdFsxXSkKICAgICAgICBsaXN0ZW5lcnMgPSB0aGlzLmRhdGEoc3BsaXRbMV0pIHx8IFtdCgogICAgICB0aGlzLmVhY2goZnVuY3Rpb24obm9kZSl7CiAgICAgICAgdmFyIHBhcmFtcyA9IHsKICAgICAgICAgIG5vZGU6IG5vZGUsCiAgICAgICAgICBldmVudDogc3BsaXRbMF0KICAgICAgICB9CgogICAgICAgIGlmIChkZWxlZ2F0aW9uKQogICAgICAgICAgcGFyYW1zLmRlbGVnYXRlID0gZGVsZWdhdGlvbgoKICAgICAgICBsaXN0ZW5lcnMucHVzaChzbmFjay5saXN0ZW5lcihwYXJhbXMsIGhhbmRsZXIpKQogICAgICB9KQoKICAgICAgaWYgKHNwbGl0WzFdKQogICAgICAgIHRoaXMuZGF0YShzcGxpdFsxXSwgbGlzdGVuZXJzKQoKICAgICAgcmV0dXJuIHRoaXMKICAgIH0sCgogICAgZGV0YWNoOiBmdW5jdGlvbiAobmFtZXNwYWNlKXsKICAgICAgbGlzdGVuZXJNZXRob2QodGhpcywgJ2RldGFjaCcsIG5hbWVzcGFjZSwgbnVsbCwgdHJ1ZSkKICAgICAgdGhpcy5kYXRhKG5hbWVzcGFjZSwgbnVsbCkKICAgICAgcmV0dXJuIHRoaXMKICAgIH0sCgogICAgZmlyZTogZnVuY3Rpb24gKG5hbWVzcGFjZSwgYXJncyl7CiAgICAgIHJldHVybiBsaXN0ZW5lck1ldGhvZCh0aGlzLCAnZmlyZScsIG5hbWVzcGFjZSwgYXJncykKICAgIH0sCgogICAgZGVsZWdhdGU6IGZ1bmN0aW9uIChldmVudCwgZGVsZWdhdGlvbiwgaGFuZGxlcil7CiAgICAgIHJldHVybiB0aGlzLmF0dGFjaChldmVudCwgaGFuZGxlciwgZGVsZWdhdGlvbikKICAgIH0KICB9KQoKICBmdW5jdGlvbiBjbGVhbihzdHIpewogICAgcmV0dXJuIHN0ci5yZXBsYWNlKC9ccysvZywgJyAnKS5yZXBsYWNlKC9eXHMrfFxzKyQvZywgJycpCiAgfQoKICBmdW5jdGlvbiBsaXN0ZW5lck1ldGhvZCh3cmFwcGVyLCBtZXRob2QsIG5hbWVzcGFjZSwgYXJncyl7CiAgICB2YXIgZGF0YSA9IHdyYXBwZXIuZGF0YShuYW1lc3BhY2UpCgogICAgaWYgKGRhdGEpCiAgICAgIHNuYWNrLmVhY2goZGF0YSwgZnVuY3Rpb24gKGxpc3RlbmVyKXsKICAgICAgICBsaXN0ZW5lclttZXRob2RdLmFwcGx5KHdyYXBwZXIsIGFyZ3MpCiAgICAgIH0pCgogICAgcmV0dXJuIHdyYXBwZXIKICB9Cn0oc25hY2ssIGRvY3VtZW50KTsKLyoKLS0tCm5hbWU6IFNsaWNrLlBhcnNlcgpkZXNjcmlwdGlvbjogU3RhbmRhbG9uZSBDU1MzIFNlbGVjdG9yIHBhcnNlcgpwcm92aWRlczogU2xpY2suUGFyc2VyCi4uLgoqLwoKOyhmdW5jdGlvbigpewoKdmFyIHBhcnNlZCwKCXNlcGFyYXRvckluZGV4LAoJY29tYmluYXRvckluZGV4LAoJcmV2ZXJzZWQsCgljYWNoZSA9IHt9LAoJcmV2ZXJzZUNhY2hlID0ge30sCglyZVVuZXNjYXBlID0gL1xcL2c7Cgp2YXIgcGFyc2UgPSBmdW5jdGlvbihleHByZXNzaW9uLCBpc1JldmVyc2VkKXsKCWlmIChleHByZXNzaW9uID09IG51bGwpIHJldHVybiBudWxsOwoJaWYgKGV4cHJlc3Npb24uU2xpY2sgPT09IHRydWUpIHJldHVybiBleHByZXNzaW9uOwoJZXhwcmVzc2lvbiA9ICgnJyArIGV4cHJlc3Npb24pLnJlcGxhY2UoL15ccyt8XHMrJC9nLCAnJyk7CglyZXZlcnNlZCA9ICEhaXNSZXZlcnNlZDsKCXZhciBjdXJyZW50Q2FjaGUgPSAocmV2ZXJzZWQpID8gcmV2ZXJzZUNhY2hlIDogY2FjaGU7CglpZiAoY3VycmVudENhY2hlW2V4cHJlc3Npb25dKSByZXR1cm4gY3VycmVudENhY2hlW2V4cHJlc3Npb25dOwoJcGFyc2VkID0gewoJCVNsaWNrOiB0cnVlLAoJCWV4cHJlc3Npb25zOiBbXSwKCQlyYXc6IGV4cHJlc3Npb24sCgkJcmV2ZXJzZTogZnVuY3Rpb24oKXsKCQkJcmV0dXJuIHBhcnNlKHRoaXMucmF3LCB0cnVlKTsKCQl9Cgl9OwoJc2VwYXJhdG9ySW5kZXggPSAtMTsKCXdoaWxlIChleHByZXNzaW9uICE9IChleHByZXNzaW9uID0gZXhwcmVzc2lvbi5yZXBsYWNlKHJlZ2V4cCwgcGFyc2VyKSkpOwoJcGFyc2VkLmxlbmd0aCA9IHBhcnNlZC5leHByZXNzaW9ucy5sZW5ndGg7CglyZXR1cm4gY3VycmVudENhY2hlW3BhcnNlZC5yYXddID0gKHJldmVyc2VkKSA/IHJldmVyc2UocGFyc2VkKSA6IHBhcnNlZDsKfTsKCnZhciByZXZlcnNlQ29tYmluYXRvciA9IGZ1bmN0aW9uKGNvbWJpbmF0b3IpewoJaWYgKGNvbWJpbmF0b3IgPT09ICchJykgcmV0dXJuICcgJzsKCWVsc2UgaWYgKGNvbWJpbmF0b3IgPT09ICcgJykgcmV0dXJuICchJzsKCWVsc2UgaWYgKCgvXiEvKS50ZXN0KGNvbWJpbmF0b3IpKSByZXR1cm4gY29tYmluYXRvci5yZXBsYWNlKC9eIS8sICcnKTsKCWVsc2UgcmV0dXJuICchJyArIGNvbWJpbmF0b3I7Cn07Cgp2YXIgcmV2ZXJzZSA9IGZ1bmN0aW9uKGV4cHJlc3Npb24pewoJdmFyIGV4cHJlc3Npb25zID0gZXhwcmVzc2lvbi5leHByZXNzaW9uczsKCWZvciAodmFyIGkgPSAwOyBpIDwgZXhwcmVzc2lvbnMubGVuZ3RoOyBpKyspewoJCXZhciBleHAgPSBleHByZXNzaW9uc1tpXTsKCQl2YXIgbGFzdCA9IHtwYXJ0czogW10sIHRhZzogJyonLCBjb21iaW5hdG9yOiByZXZlcnNlQ29tYmluYXRvcihleHBbMF0uY29tYmluYXRvcil9OwoKCQlmb3IgKHZhciBqID0gMDsgaiA8IGV4cC5sZW5ndGg7IGorKyl7CgkJCXZhciBjZXhwID0gZXhwW2pdOwoJCQlpZiAoIWNleHAucmV2ZXJzZUNvbWJpbmF0b3IpIGNleHAucmV2ZXJzZUNvbWJpbmF0b3IgPSAnICc7CgkJCWNleHAuY29tYmluYXRvciA9IGNleHAucmV2ZXJzZUNvbWJpbmF0b3I7CgkJCWRlbGV0ZSBjZXhwLnJldmVyc2VDb21iaW5hdG9yOwoJCX0KCgkJZXhwLnJldmVyc2UoKS5wdXNoKGxhc3QpOwoJfQoJcmV0dXJuIGV4cHJlc3Npb247Cn07Cgp2YXIgZXNjYXBlUmVnRXhwID0gZnVuY3Rpb24oc3RyaW5nKXsvLyBDcmVkaXQ6IFhSZWdFeHAgMC42LjEgKGMpIDIwMDctMjAwOCBTdGV2ZW4gTGV2aXRoYW4gPGh0dHA6Ly9zdGV2ZW5sZXZpdGhhbi5jb20vcmVnZXgveHJlZ2V4cC8+IE1JVCBMaWNlbnNlCglyZXR1cm4gc3RyaW5nLnJlcGxhY2UoL1stW1xde30oKSorPy5cXF4kfCwjXHNdL2csIGZ1bmN0aW9uKG1hdGNoKXsKCQlyZXR1cm4gJ1xcJyArIG1hdGNoOwoJfSk7Cn07Cgp2YXIgcmVnZXhwID0gbmV3IFJlZ0V4cCgKLyoKIyEvdXNyL2Jpbi9lbnYgcnVieQpwdXRzICJcdFx0IiArIERBVEEucmVhZC5nc3ViKC9cKFw/eFwpfFxzKyMuKiR8XHMrfFxcJHxcXG4vLCcnKQpfX0VORF9fCgkiKD94KV4oPzpcCgkgIFxccyogKCAsICkgXFxzKiAgICAgICAgICAgICAgICMgU2VwYXJhdG9yICAgICAgICAgIFxuXAoJfCBcXHMqICggPGNvbWJpbmF0b3I+KyApIFxccyogICAjIENvbWJpbmF0b3IgICAgICAgICBcblwKCXwgICAgICAoIFxccysgKSAgICAgICAgICAgICAgICAgIyBDb21iaW5hdG9yQ2hpbGRyZW4gXG5cCgl8ICAgICAgKCA8dW5pY29kZT4rIHwgXFwqICkgICAgICMgVGFnICAgICAgICAgICAgICAgIFxuXAoJfCBcXCMgICggPHVuaWNvZGU+KyAgICAgICApICAgICAjIElEICAgICAgICAgICAgICAgICBcblwKCXwgXFwuICAoIDx1bmljb2RlPisgICAgICAgKSAgICAgIyBDbGFzc05hbWUgICAgICAgICAgXG5cCgl8ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICMgQXR0cmlidXRlICAgICAgICAgIFxuXAoJXFxbICBcCgkJXFxzKiAoPHVuaWNvZGUxPispICAoPzogIFwKCQkJXFxzKiAoWypeJCF+fF0/PSkgICg/OiAgXAoJCQkJXFxzKiAoPzpcCgkJCQkJKFtcIiddPykoLio/KVxcOSBcCgkJCQkpXAoJCQkpICBcCgkJKT8gIFxccyogIFwKCVxcXSg/IVxcXSkgXG5cCgl8ICAgOisgKCA8dW5pY29kZT4rICkoPzpcCglcXCggKD86XAoJCSg/OihbXCInXSkoW15cXDEyXSopXFwxMil8KCg/OlxcKFteKV0rXFwpfFteKCldKikrKVwKCSkgXFwpXAoJKT9cCgkpIgoqLwoJIl4oPzpcXHMqKCwpXFxzKnxcXHMqKDxjb21iaW5hdG9yPispXFxzKnwoXFxzKyl8KDx1bmljb2RlPit8XFwqKXxcXCMoPHVuaWNvZGU+Kyl8XFwuKDx1bmljb2RlPispfFxcW1xccyooPHVuaWNvZGUxPispKD86XFxzKihbKl4kIX58XT89KSg/OlxccyooPzooW1wiJ10/KSguKj8pXFw5KSkpP1xccypcXF0oPyFcXF0pfCg6KykoPHVuaWNvZGU+KykoPzpcXCgoPzooPzooW1wiJ10pKFteXFwxM10qKVxcMTMpfCgoPzpcXChbXildK1xcKXxbXigpXSopKykpXFwpKT8pIgoJLnJlcGxhY2UoLzxjb21iaW5hdG9yPi8sICdbJyArIGVzY2FwZVJlZ0V4cCgiPit+YCFAJCVeJj17fVxcOzwvIikgKyAnXScpCgkucmVwbGFjZSgvPHVuaWNvZGU+L2csICcoPzpbXFx3XFx1MDBhMS1cXHVGRkZGLV18XFxcXFteXFxzMC05YS1mXSknKQoJLnJlcGxhY2UoLzx1bmljb2RlMT4vZywgJyg/Ols6XFx3XFx1MDBhMS1cXHVGRkZGLV18XFxcXFteXFxzMC05YS1mXSknKQopOwoKZnVuY3Rpb24gcGFyc2VyKAoJcmF3TWF0Y2gsCgoJc2VwYXJhdG9yLAoJY29tYmluYXRvciwKCWNvbWJpbmF0b3JDaGlsZHJlbiwKCgl0YWdOYW1lLAoJaWQsCgljbGFzc05hbWUsCgoJYXR0cmlidXRlS2V5LAoJYXR0cmlidXRlT3BlcmF0b3IsCglhdHRyaWJ1dGVRdW90ZSwKCWF0dHJpYnV0ZVZhbHVlLAoKCXBzZXVkb01hcmtlciwKCXBzZXVkb0NsYXNzLAoJcHNldWRvUXVvdGUsCglwc2V1ZG9DbGFzc1F1b3RlZFZhbHVlLAoJcHNldWRvQ2xhc3NWYWx1ZQopewoJaWYgKHNlcGFyYXRvciB8fCBzZXBhcmF0b3JJbmRleCA9PT0gLTEpewoJCXBhcnNlZC5leHByZXNzaW9uc1srK3NlcGFyYXRvckluZGV4XSA9IFtdOwoJCWNvbWJpbmF0b3JJbmRleCA9IC0xOwoJCWlmIChzZXBhcmF0b3IpIHJldHVybiAnJzsKCX0KCglpZiAoY29tYmluYXRvciB8fCBjb21iaW5hdG9yQ2hpbGRyZW4gfHwgY29tYmluYXRvckluZGV4ID09PSAtMSl7CgkJY29tYmluYXRvciA9IGNvbWJpbmF0b3IgfHwgJyAnOwoJCXZhciBjdXJyZW50U2VwYXJhdG9yID0gcGFyc2VkLmV4cHJlc3Npb25zW3NlcGFyYXRvckluZGV4XTsKCQlpZiAocmV2ZXJzZWQgJiYgY3VycmVudFNlcGFyYXRvcltjb21iaW5hdG9ySW5kZXhdKQoJCQljdXJyZW50U2VwYXJhdG9yW2NvbWJpbmF0b3JJbmRleF0ucmV2ZXJzZUNvbWJpbmF0b3IgPSByZXZlcnNlQ29tYmluYXRvcihjb21iaW5hdG9yKTsKCQljdXJyZW50U2VwYXJhdG9yWysrY29tYmluYXRvckluZGV4XSA9IHtjb21iaW5hdG9yOiBjb21iaW5hdG9yLCB0YWc6ICcqJ307Cgl9CgoJdmFyIGN1cnJlbnRQYXJzZWQgPSBwYXJzZWQuZXhwcmVzc2lvbnNbc2VwYXJhdG9ySW5kZXhdW2NvbWJpbmF0b3JJbmRleF07CgoJaWYgKHRhZ05hbWUpewoJCWN1cnJlbnRQYXJzZWQudGFnID0gdGFnTmFtZS5yZXBsYWNlKHJlVW5lc2NhcGUsICcnKTsKCgl9IGVsc2UgaWYgKGlkKXsKCQljdXJyZW50UGFyc2VkLmlkID0gaWQucmVwbGFjZShyZVVuZXNjYXBlLCAnJyk7CgoJfSBlbHNlIGlmIChjbGFzc05hbWUpewoJCWNsYXNzTmFtZSA9IGNsYXNzTmFtZS5yZXBsYWNlKHJlVW5lc2NhcGUsICcnKTsKCgkJaWYgKCFjdXJyZW50UGFyc2VkLmNsYXNzTGlzdCkgY3VycmVudFBhcnNlZC5jbGFzc0xpc3QgPSBbXTsKCQlpZiAoIWN1cnJlbnRQYXJzZWQuY2xhc3NlcykgY3VycmVudFBhcnNlZC5jbGFzc2VzID0gW107CgkJY3VycmVudFBhcnNlZC5jbGFzc0xpc3QucHVzaChjbGFzc05hbWUpOwoJCWN1cnJlbnRQYXJzZWQuY2xhc3Nlcy5wdXNoKHsKCQkJdmFsdWU6IGNsYXNzTmFtZSwKCQkJcmVnZXhwOiBuZXcgUmVnRXhwKCcoXnxcXHMpJyArIGVzY2FwZVJlZ0V4cChjbGFzc05hbWUpICsgJyhcXHN8JCknKQoJCX0pOwoKCX0gZWxzZSBpZiAocHNldWRvQ2xhc3MpewoJCXBzZXVkb0NsYXNzVmFsdWUgPSBwc2V1ZG9DbGFzc1ZhbHVlIHx8IHBzZXVkb0NsYXNzUXVvdGVkVmFsdWU7CgkJcHNldWRvQ2xhc3NWYWx1ZSA9IHBzZXVkb0NsYXNzVmFsdWUgPyBwc2V1ZG9DbGFzc1ZhbHVlLnJlcGxhY2UocmVVbmVzY2FwZSwgJycpIDogbnVsbDsKCgkJaWYgKCFjdXJyZW50UGFyc2VkLnBzZXVkb3MpIGN1cnJlbnRQYXJzZWQucHNldWRvcyA9IFtdOwoJCWN1cnJlbnRQYXJzZWQucHNldWRvcy5wdXNoKHsKCQkJa2V5OiBwc2V1ZG9DbGFzcy5yZXBsYWNlKHJlVW5lc2NhcGUsICcnKSwKCQkJdmFsdWU6IHBzZXVkb0NsYXNzVmFsdWUsCgkJCXR5cGU6IHBzZXVkb01hcmtlci5sZW5ndGggPT0gMSA/ICdjbGFzcycgOiAnZWxlbWVudCcKCQl9KTsKCgl9IGVsc2UgaWYgKGF0dHJpYnV0ZUtleSl7CgkJYXR0cmlidXRlS2V5ID0gYXR0cmlidXRlS2V5LnJlcGxhY2UocmVVbmVzY2FwZSwgJycpOwoJCWF0dHJpYnV0ZVZhbHVlID0gKGF0dHJpYnV0ZVZhbHVlIHx8ICcnKS5yZXBsYWNlKHJlVW5lc2NhcGUsICcnKTsKCgkJdmFyIHRlc3QsIHJlZ2V4cDsKCgkJc3dpdGNoIChhdHRyaWJ1dGVPcGVyYXRvcil7CgkJCWNhc2UgJ149JyA6IHJlZ2V4cCA9IG5ldyBSZWdFeHAoICAgICAgICdeJysgZXNjYXBlUmVnRXhwKGF0dHJpYnV0ZVZhbHVlKSAgICAgICAgICAgICk7IGJyZWFrOwoJCQljYXNlICckPScgOiByZWdleHAgPSBuZXcgUmVnRXhwKCAgICAgICAgICAgIGVzY2FwZVJlZ0V4cChhdHRyaWJ1dGVWYWx1ZSkgKyckJyAgICAgICApOyBicmVhazsKCQkJY2FzZSAnfj0nIDogcmVnZXhwID0gbmV3IFJlZ0V4cCggJyhefFxccyknKyBlc2NhcGVSZWdFeHAoYXR0cmlidXRlVmFsdWUpICsnKFxcc3wkKScgKTsgYnJlYWs7CgkJCWNhc2UgJ3w9JyA6IHJlZ2V4cCA9IG5ldyBSZWdFeHAoICAgICAgICdeJysgZXNjYXBlUmVnRXhwKGF0dHJpYnV0ZVZhbHVlKSArJygtfCQpJyAgICk7IGJyZWFrOwoJCQljYXNlICAnPScgOiB0ZXN0ID0gZnVuY3Rpb24odmFsdWUpewoJCQkJcmV0dXJuIGF0dHJpYnV0ZVZhbHVlID09IHZhbHVlOwoJCQl9OyBicmVhazsKCQkJY2FzZSAnKj0nIDogdGVzdCA9IGZ1bmN0aW9uKHZhbHVlKXsKCQkJCXJldHVybiB2YWx1ZSAmJiB2YWx1ZS5pbmRleE9mKGF0dHJpYnV0ZVZhbHVlKSA+IC0xOwoJCQl9OyBicmVhazsKCQkJY2FzZSAnIT0nIDogdGVzdCA9IGZ1bmN0aW9uKHZhbHVlKXsKCQkJCXJldHVybiBhdHRyaWJ1dGVWYWx1ZSAhPSB2YWx1ZTsKCQkJfTsgYnJlYWs7CgkJCWRlZmF1bHQgICA6IHRlc3QgPSBmdW5jdGlvbih2YWx1ZSl7CgkJCQlyZXR1cm4gISF2YWx1ZTsKCQkJfTsKCQl9CgoJCWlmIChhdHRyaWJ1dGVWYWx1ZSA9PSAnJyAmJiAoL15bKiReXT0kLykudGVzdChhdHRyaWJ1dGVPcGVyYXRvcikpIHRlc3QgPSBmdW5jdGlvbigpewoJCQlyZXR1cm4gZmFsc2U7CgkJfTsKCgkJaWYgKCF0ZXN0KSB0ZXN0ID0gZnVuY3Rpb24odmFsdWUpewoJCQlyZXR1cm4gdmFsdWUgJiYgcmVnZXhwLnRlc3QodmFsdWUpOwoJCX07CgoJCWlmICghY3VycmVudFBhcnNlZC5hdHRyaWJ1dGVzKSBjdXJyZW50UGFyc2VkLmF0dHJpYnV0ZXMgPSBbXTsKCQljdXJyZW50UGFyc2VkLmF0dHJpYnV0ZXMucHVzaCh7CgkJCWtleTogYXR0cmlidXRlS2V5LAoJCQlvcGVyYXRvcjogYXR0cmlidXRlT3BlcmF0b3IsCgkJCXZhbHVlOiBhdHRyaWJ1dGVWYWx1ZSwKCQkJdGVzdDogdGVzdAoJCX0pOwoKCX0KCglyZXR1cm4gJyc7Cn07CgovLyBTbGljayBOUwoKdmFyIFNsaWNrID0gKHRoaXMuU2xpY2sgfHwge30pOwoKU2xpY2sucGFyc2UgPSBmdW5jdGlvbihleHByZXNzaW9uKXsKCXJldHVybiBwYXJzZShleHByZXNzaW9uKTsKfTsKClNsaWNrLmVzY2FwZVJlZ0V4cCA9IGVzY2FwZVJlZ0V4cDsKCmlmICghdGhpcy5TbGljaykgdGhpcy5TbGljayA9IFNsaWNrOwoKfSkuYXBwbHkoLyo8Q29tbW9uSlM+Ki8odHlwZW9mIGV4cG9ydHMgIT0gJ3VuZGVmaW5lZCcpID8gZXhwb3J0cyA6IC8qPC9Db21tb25KUz4qL3RoaXMpOwovKgotLS0KbmFtZTogU2xpY2suRmluZGVyCmRlc2NyaXB0aW9uOiBUaGUgbmV3LCBzdXBlcmZhc3QgY3NzIHNlbGVjdG9yIGVuZ2luZS4KcHJvdmlkZXM6IFNsaWNrLkZpbmRlcgpyZXF1aXJlczogU2xpY2suUGFyc2VyCi4uLgoqLwoKOyhmdW5jdGlvbigpewoKdmFyIGxvY2FsID0ge30sCglmZWF0dXJlc0NhY2hlID0ge30sCgl0b1N0cmluZyA9IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmc7CgovLyBGZWF0dXJlIC8gQnVnIGRldGVjdGlvbgoKbG9jYWwuaXNOYXRpdmVDb2RlID0gZnVuY3Rpb24oZm4pewoJcmV0dXJuICgvXHtccypcW25hdGl2ZSBjb2RlXF1ccypcfS8pLnRlc3QoJycgKyBmbik7Cn07Cgpsb2NhbC5pc1hNTCA9IGZ1bmN0aW9uKGRvY3VtZW50KXsKCXJldHVybiAoISFkb2N1bWVudC54bWxWZXJzaW9uKSB8fCAoISFkb2N1bWVudC54bWwpIHx8ICh0b1N0cmluZy5jYWxsKGRvY3VtZW50KSA9PSAnW29iamVjdCBYTUxEb2N1bWVudF0nKSB8fAoJKGRvY3VtZW50Lm5vZGVUeXBlID09IDkgJiYgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50Lm5vZGVOYW1lICE9ICdIVE1MJyk7Cn07Cgpsb2NhbC5zZXREb2N1bWVudCA9IGZ1bmN0aW9uKGRvY3VtZW50KXsKCgkvLyBjb252ZXJ0IGVsZW1lbnRzIC8gd2luZG93IGFyZ3VtZW50cyB0byBkb2N1bWVudC4gaWYgZG9jdW1lbnQgY2Fubm90IGJlIGV4dHJhcG9sYXRlZCwgdGhlIGZ1bmN0aW9uIHJldHVybnMuCgl2YXIgbm9kZVR5cGUgPSBkb2N1bWVudC5ub2RlVHlwZTsKCWlmIChub2RlVHlwZSA9PSA5KTsgLy8gZG9jdW1lbnQKCWVsc2UgaWYgKG5vZGVUeXBlKSBkb2N1bWVudCA9IGRvY3VtZW50Lm93bmVyRG9jdW1lbnQ7IC8vIG5vZGUKCWVsc2UgaWYgKGRvY3VtZW50Lm5hdmlnYXRvcikgZG9jdW1lbnQgPSBkb2N1bWVudC5kb2N1bWVudDsgLy8gd2luZG93CgllbHNlIHJldHVybjsKCgkvLyBjaGVjayBpZiBpdCdzIHRoZSBvbGQgZG9jdW1lbnQKCglpZiAodGhpcy5kb2N1bWVudCA9PT0gZG9jdW1lbnQpIHJldHVybjsKCXRoaXMuZG9jdW1lbnQgPSBkb2N1bWVudDsKCgkvLyBjaGVjayBpZiB3ZSBoYXZlIGRvbmUgZmVhdHVyZSBkZXRlY3Rpb24gb24gdGhpcyBkb2N1bWVudCBiZWZvcmUKCgl2YXIgcm9vdCA9IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudCwKCQlyb290VWlkID0gdGhpcy5nZXRVSURYTUwocm9vdCksCgkJZmVhdHVyZXMgPSBmZWF0dXJlc0NhY2hlW3Jvb3RVaWRdLAoJCWZlYXR1cmU7CgoJaWYgKGZlYXR1cmVzKXsKCQlmb3IgKGZlYXR1cmUgaW4gZmVhdHVyZXMpewoJCQl0aGlzW2ZlYXR1cmVdID0gZmVhdHVyZXNbZmVhdHVyZV07CgkJfQoJCXJldHVybjsKCX0KCglmZWF0dXJlcyA9IGZlYXR1cmVzQ2FjaGVbcm9vdFVpZF0gPSB7fTsKCglmZWF0dXJlcy5yb290ID0gcm9vdDsKCWZlYXR1cmVzLmlzWE1MRG9jdW1lbnQgPSB0aGlzLmlzWE1MKGRvY3VtZW50KTsKCglmZWF0dXJlcy5icm9rZW5TdGFyR0VCVE4KCT0gZmVhdHVyZXMuc3RhclNlbGVjdHNDbG9zZWRRU0EKCT0gZmVhdHVyZXMuaWRHZXRzTmFtZQoJPSBmZWF0dXJlcy5icm9rZW5NaXhlZENhc2VRU0EKCT0gZmVhdHVyZXMuYnJva2VuR0VCQ04KCT0gZmVhdHVyZXMuYnJva2VuQ2hlY2tlZFFTQQoJPSBmZWF0dXJlcy5icm9rZW5FbXB0eUF0dHJpYnV0ZVFTQQoJPSBmZWF0dXJlcy5pc0hUTUxEb2N1bWVudAoJPSBmZWF0dXJlcy5uYXRpdmVNYXRjaGVzU2VsZWN0b3IKCT0gZmFsc2U7CgoJdmFyIHN0YXJTZWxlY3RzQ2xvc2VkLCBzdGFyU2VsZWN0c0NvbW1lbnRzLAoJCWJyb2tlblNlY29uZENsYXNzTmFtZUdFQkNOLCBjYWNoZWRHZXRFbGVtZW50c0J5Q2xhc3NOYW1lLAoJCWJyb2tlbkZvcm1BdHRyaWJ1dGVHZXR0ZXI7CgoJdmFyIHNlbGVjdGVkLCBpZCA9ICdzbGlja191bmlxdWVpZCc7Cgl2YXIgdGVzdE5vZGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKCQoJdmFyIHRlc3RSb290ID0gZG9jdW1lbnQuYm9keSB8fCBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgnYm9keScpWzBdIHx8IHJvb3Q7Cgl0ZXN0Um9vdC5hcHBlbmRDaGlsZCh0ZXN0Tm9kZSk7CgoJLy8gb24gbm9uLUhUTUwgZG9jdW1lbnRzIGlubmVySFRNTCBhbmQgZ2V0RWxlbWVudHNCeUlkIGRvZXNudCB3b3JrIHByb3Blcmx5Cgl0cnkgewoJCXRlc3ROb2RlLmlubmVySFRNTCA9ICc8YSBpZD0iJytpZCsnIj48L2E+JzsKCQlmZWF0dXJlcy5pc0hUTUxEb2N1bWVudCA9ICEhZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoaWQpOwoJfSBjYXRjaChlKXt9OwoKCWlmIChmZWF0dXJlcy5pc0hUTUxEb2N1bWVudCl7CgoJCXRlc3ROb2RlLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CgoJCS8vIElFIHJldHVybnMgY29tbWVudCBub2RlcyBmb3IgZ2V0RWxlbWVudHNCeVRhZ05hbWUoJyonKSBmb3Igc29tZSBkb2N1bWVudHMKCQl0ZXN0Tm9kZS5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVDb21tZW50KCcnKSk7CgkJc3RhclNlbGVjdHNDb21tZW50cyA9ICh0ZXN0Tm9kZS5nZXRFbGVtZW50c0J5VGFnTmFtZSgnKicpLmxlbmd0aCA+IDEpOwoKCQkvLyBJRSByZXR1cm5zIGNsb3NlZCBub2RlcyAoRUc6IjwvZm9vPiIpIGZvciBnZXRFbGVtZW50c0J5VGFnTmFtZSgnKicpIGZvciBzb21lIGRvY3VtZW50cwoJCXRyeSB7CgkJCXRlc3ROb2RlLmlubmVySFRNTCA9ICdmb288L2Zvbz4nOwoJCQlzZWxlY3RlZCA9IHRlc3ROb2RlLmdldEVsZW1lbnRzQnlUYWdOYW1lKCcqJyk7CgkJCXN0YXJTZWxlY3RzQ2xvc2VkID0gKHNlbGVjdGVkICYmICEhc2VsZWN0ZWQubGVuZ3RoICYmIHNlbGVjdGVkWzBdLm5vZGVOYW1lLmNoYXJBdCgwKSA9PSAnLycpOwoJCX0gY2F0Y2goZSl7fTsKCgkJZmVhdHVyZXMuYnJva2VuU3RhckdFQlROID0gc3RhclNlbGVjdHNDb21tZW50cyB8fCBzdGFyU2VsZWN0c0Nsb3NlZDsKCgkJLy8gSUUgcmV0dXJucyBlbGVtZW50cyB3aXRoIHRoZSBuYW1lIGluc3RlYWQgb2YganVzdCBpZCBmb3IgZ2V0RWxlbWVudHNCeUlkIGZvciBzb21lIGRvY3VtZW50cwoJCXRyeSB7CgkJCXRlc3ROb2RlLmlubmVySFRNTCA9ICc8YSBuYW1lPSInKyBpZCArJyI+PC9hPjxiIGlkPSInKyBpZCArJyI+PC9iPic7CgkJCWZlYXR1cmVzLmlkR2V0c05hbWUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChpZCkgPT09IHRlc3ROb2RlLmZpcnN0Q2hpbGQ7CgkJfSBjYXRjaChlKXt9OwoKCQlpZiAodGVzdE5vZGUuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSl7CgoJCQkvLyBTYWZhcmkgMy4yIGdldEVsZW1lbnRzQnlDbGFzc05hbWUgY2FjaGVzIHJlc3VsdHMKCQkJdHJ5IHsKCQkJCXRlc3ROb2RlLmlubmVySFRNTCA9ICc8YSBjbGFzcz0iZiI+PC9hPjxhIGNsYXNzPSJiIj48L2E+JzsKCQkJCXRlc3ROb2RlLmdldEVsZW1lbnRzQnlDbGFzc05hbWUoJ2InKS5sZW5ndGg7CgkJCQl0ZXN0Tm9kZS5maXJzdENoaWxkLmNsYXNzTmFtZSA9ICdiJzsKCQkJCWNhY2hlZEdldEVsZW1lbnRzQnlDbGFzc05hbWUgPSAodGVzdE5vZGUuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSgnYicpLmxlbmd0aCAhPSAyKTsKCQkJfSBjYXRjaChlKXt9OwoKCQkJLy8gT3BlcmEgOS42IGdldEVsZW1lbnRzQnlDbGFzc05hbWUgZG9lc250IGRldGVjdHMgdGhlIGNsYXNzIGlmIGl0cyBub3QgdGhlIGZpcnN0IG9uZQoJCQl0cnkgewoJCQkJdGVzdE5vZGUuaW5uZXJIVE1MID0gJzxhIGNsYXNzPSJhIj48L2E+PGEgY2xhc3M9ImYgYiBhIj48L2E+JzsKCQkJCWJyb2tlblNlY29uZENsYXNzTmFtZUdFQkNOID0gKHRlc3ROb2RlLmdldEVsZW1lbnRzQnlDbGFzc05hbWUoJ2EnKS5sZW5ndGggIT0gMik7CgkJCX0gY2F0Y2goZSl7fTsKCgkJCWZlYXR1cmVzLmJyb2tlbkdFQkNOID0gY2FjaGVkR2V0RWxlbWVudHNCeUNsYXNzTmFtZSB8fCBicm9rZW5TZWNvbmRDbGFzc05hbWVHRUJDTjsKCQl9CgkJCgkJaWYgKHRlc3ROb2RlLnF1ZXJ5U2VsZWN0b3JBbGwpewoJCQkvLyBJRSA4IHJldHVybnMgY2xvc2VkIG5vZGVzIChFRzoiPC9mb28+IikgZm9yIHF1ZXJ5U2VsZWN0b3JBbGwoJyonKSBmb3Igc29tZSBkb2N1bWVudHMKCQkJdHJ5IHsKCQkJCXRlc3ROb2RlLmlubmVySFRNTCA9ICdmb288L2Zvbz4nOwoJCQkJc2VsZWN0ZWQgPSB0ZXN0Tm9kZS5xdWVyeVNlbGVjdG9yQWxsKCcqJyk7CgkJCQlmZWF0dXJlcy5zdGFyU2VsZWN0c0Nsb3NlZFFTQSA9IChzZWxlY3RlZCAmJiAhIXNlbGVjdGVkLmxlbmd0aCAmJiBzZWxlY3RlZFswXS5ub2RlTmFtZS5jaGFyQXQoMCkgPT0gJy8nKTsKCQkJfSBjYXRjaChlKXt9OwoKCQkJLy8gU2FmYXJpIDMuMiBxdWVyeVNlbGVjdG9yQWxsIGRvZXNudCB3b3JrIHdpdGggbWl4ZWRjYXNlIG9uIHF1aXJrc21vZGUKCQkJdHJ5IHsKCQkJCXRlc3ROb2RlLmlubmVySFRNTCA9ICc8YSBjbGFzcz0iTWlYIj48L2E+JzsKCQkJCWZlYXR1cmVzLmJyb2tlbk1peGVkQ2FzZVFTQSA9ICF0ZXN0Tm9kZS5xdWVyeVNlbGVjdG9yQWxsKCcuTWlYJykubGVuZ3RoOwoJCQl9IGNhdGNoKGUpe307CgoJCQkvLyBXZWJraXQgYW5kIE9wZXJhIGRvbnQgcmV0dXJuIHNlbGVjdGVkIG9wdGlvbnMgb24gcXVlcnlTZWxlY3RvckFsbAoJCQl0cnkgewoJCQkJdGVzdE5vZGUuaW5uZXJIVE1MID0gJzxzZWxlY3Q+PG9wdGlvbiBzZWxlY3RlZD0ic2VsZWN0ZWQiPmE8L29wdGlvbj48L3NlbGVjdD4nOwoJCQkJZmVhdHVyZXMuYnJva2VuQ2hlY2tlZFFTQSA9ICh0ZXN0Tm9kZS5xdWVyeVNlbGVjdG9yQWxsKCc6Y2hlY2tlZCcpLmxlbmd0aCA9PSAwKTsKCQkJfSBjYXRjaChlKXt9OwoKCQkJLy8gSUUgcmV0dXJucyBpbmNvcnJlY3QgcmVzdWx0cyBmb3IgYXR0clsqXiRdPSIiIHNlbGVjdG9ycyBvbiBxdWVyeVNlbGVjdG9yQWxsCgkJCXRyeSB7CgkJCQl0ZXN0Tm9kZS5pbm5lckhUTUwgPSAnPGEgY2xhc3M9IiI+PC9hPic7CgkJCQlmZWF0dXJlcy5icm9rZW5FbXB0eUF0dHJpYnV0ZVFTQSA9ICh0ZXN0Tm9kZS5xdWVyeVNlbGVjdG9yQWxsKCdbY2xhc3MqPSIiXScpLmxlbmd0aCAhPSAwKTsKCQkJfSBjYXRjaChlKXt9OwoKCQl9CgoJCS8vIElFNi03LCBpZiBhIGZvcm0gaGFzIGFuIGlucHV0IG9mIGlkIHgsIGZvcm0uZ2V0QXR0cmlidXRlKHgpIHJldHVybnMgYSByZWZlcmVuY2UgdG8gdGhlIGlucHV0CgkJdHJ5IHsKCQkJdGVzdE5vZGUuaW5uZXJIVE1MID0gJzxmb3JtIGFjdGlvbj0icyI+PGlucHV0IGlkPSJhY3Rpb24iLz48L2Zvcm0+JzsKCQkJYnJva2VuRm9ybUF0dHJpYnV0ZUdldHRlciA9ICh0ZXN0Tm9kZS5maXJzdENoaWxkLmdldEF0dHJpYnV0ZSgnYWN0aW9uJykgIT0gJ3MnKTsKCQl9IGNhdGNoKGUpe307CgoJCS8vIG5hdGl2ZSBtYXRjaGVzU2VsZWN0b3IgZnVuY3Rpb24KCgkJZmVhdHVyZXMubmF0aXZlTWF0Y2hlc1NlbGVjdG9yID0gcm9vdC5tYXRjaGVzU2VsZWN0b3IgfHwgLypyb290Lm1zTWF0Y2hlc1NlbGVjdG9yIHx8Ki8gcm9vdC5tb3pNYXRjaGVzU2VsZWN0b3IgfHwgcm9vdC53ZWJraXRNYXRjaGVzU2VsZWN0b3I7CgkJaWYgKGZlYXR1cmVzLm5hdGl2ZU1hdGNoZXNTZWxlY3RvcikgdHJ5IHsKCQkJLy8gaWYgbWF0Y2hlc1NlbGVjdG9yIHRyb3dzIGVycm9ycyBvbiBpbmNvcnJlY3Qgc2ludGF4ZXMgd2UgY2FuIHVzZSBpdAoJCQlmZWF0dXJlcy5uYXRpdmVNYXRjaGVzU2VsZWN0b3IuY2FsbChyb290LCAnOnNsaWNrJyk7CgkJCWZlYXR1cmVzLm5hdGl2ZU1hdGNoZXNTZWxlY3RvciA9IG51bGw7CgkJfSBjYXRjaChlKXt9OwoKCX0KCgl0cnkgewoJCXJvb3Quc2xpY2tfZXhwYW5kbyA9IDE7CgkJZGVsZXRlIHJvb3Quc2xpY2tfZXhwYW5kbzsKCQlmZWF0dXJlcy5nZXRVSUQgPSB0aGlzLmdldFVJREhUTUw7Cgl9IGNhdGNoKGUpIHsKCQlmZWF0dXJlcy5nZXRVSUQgPSB0aGlzLmdldFVJRFhNTDsKCX0KCgl0ZXN0Um9vdC5yZW1vdmVDaGlsZCh0ZXN0Tm9kZSk7Cgl0ZXN0Tm9kZSA9IHNlbGVjdGVkID0gdGVzdFJvb3QgPSBudWxsOwoKCS8vIGdldEF0dHJpYnV0ZQoKCWZlYXR1cmVzLmdldEF0dHJpYnV0ZSA9IChmZWF0dXJlcy5pc0hUTUxEb2N1bWVudCAmJiBicm9rZW5Gb3JtQXR0cmlidXRlR2V0dGVyKSA/IGZ1bmN0aW9uKG5vZGUsIG5hbWUpewoJCXZhciBtZXRob2QgPSB0aGlzLmF0dHJpYnV0ZUdldHRlcnNbbmFtZV07CgkJaWYgKG1ldGhvZCkgcmV0dXJuIG1ldGhvZC5jYWxsKG5vZGUpOwoJCXZhciBhdHRyaWJ1dGVOb2RlID0gbm9kZS5nZXRBdHRyaWJ1dGVOb2RlKG5hbWUpOwoJCXJldHVybiAoYXR0cmlidXRlTm9kZSkgPyBhdHRyaWJ1dGVOb2RlLm5vZGVWYWx1ZSA6IG51bGw7Cgl9IDogZnVuY3Rpb24obm9kZSwgbmFtZSl7CgkJdmFyIG1ldGhvZCA9IHRoaXMuYXR0cmlidXRlR2V0dGVyc1tuYW1lXTsKCQlyZXR1cm4gKG1ldGhvZCkgPyBtZXRob2QuY2FsbChub2RlKSA6IG5vZGUuZ2V0QXR0cmlidXRlKG5hbWUpOwoJfTsKCgkvLyBoYXNBdHRyaWJ1dGUKCglmZWF0dXJlcy5oYXNBdHRyaWJ1dGUgPSAocm9vdCAmJiB0aGlzLmlzTmF0aXZlQ29kZShyb290Lmhhc0F0dHJpYnV0ZSkpID8gZnVuY3Rpb24obm9kZSwgYXR0cmlidXRlKSB7CgkJcmV0dXJuIG5vZGUuaGFzQXR0cmlidXRlKGF0dHJpYnV0ZSk7Cgl9IDogZnVuY3Rpb24obm9kZSwgYXR0cmlidXRlKSB7CgkJbm9kZSA9IG5vZGUuZ2V0QXR0cmlidXRlTm9kZShhdHRyaWJ1dGUpOwoJCXJldHVybiAhIShub2RlICYmIChub2RlLnNwZWNpZmllZCB8fCBub2RlLm5vZGVWYWx1ZSkpOwoJfTsKCgkvLyBjb250YWlucwoJLy8gRklYTUU6IEFkZCBzcGVjczogbG9jYWwuY29udGFpbnMgc2hvdWxkIGJlIGRpZmZlcmVudCBmb3IgeG1sIGFuZCBodG1sIGRvY3VtZW50cz8KCWZlYXR1cmVzLmNvbnRhaW5zID0gKHJvb3QgJiYgdGhpcy5pc05hdGl2ZUNvZGUocm9vdC5jb250YWlucykpID8gZnVuY3Rpb24oY29udGV4dCwgbm9kZSl7CgkJcmV0dXJuIGNvbnRleHQuY29udGFpbnMobm9kZSk7Cgl9IDogKHJvb3QgJiYgcm9vdC5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbikgPyBmdW5jdGlvbihjb250ZXh0LCBub2RlKXsKCQlyZXR1cm4gY29udGV4dCA9PT0gbm9kZSB8fCAhIShjb250ZXh0LmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uKG5vZGUpICYgMTYpOwoJfSA6IGZ1bmN0aW9uKGNvbnRleHQsIG5vZGUpewoJCWlmIChub2RlKSBkbyB7CgkJCWlmIChub2RlID09PSBjb250ZXh0KSByZXR1cm4gdHJ1ZTsKCQl9IHdoaWxlICgobm9kZSA9IG5vZGUucGFyZW50Tm9kZSkpOwoJCXJldHVybiBmYWxzZTsKCX07CgoJLy8gZG9jdW1lbnQgb3JkZXIgc29ydGluZwoJLy8gY3JlZGl0cyB0byBTaXp6bGUgKGh0dHA6Ly9zaXp6bGVqcy5jb20vKQoKCWZlYXR1cmVzLmRvY3VtZW50U29ydGVyID0gKHJvb3QuY29tcGFyZURvY3VtZW50UG9zaXRpb24pID8gZnVuY3Rpb24oYSwgYil7CgkJaWYgKCFhLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uIHx8ICFiLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uKSByZXR1cm4gMDsKCQlyZXR1cm4gYS5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbihiKSAmIDQgPyAtMSA6IGEgPT09IGIgPyAwIDogMTsKCX0gOiAoJ3NvdXJjZUluZGV4JyBpbiByb290KSA/IGZ1bmN0aW9uKGEsIGIpewoJCWlmICghYS5zb3VyY2VJbmRleCB8fCAhYi5zb3VyY2VJbmRleCkgcmV0dXJuIDA7CgkJcmV0dXJuIGEuc291cmNlSW5kZXggLSBiLnNvdXJjZUluZGV4OwoJfSA6IChkb2N1bWVudC5jcmVhdGVSYW5nZSkgPyBmdW5jdGlvbihhLCBiKXsKCQlpZiAoIWEub3duZXJEb2N1bWVudCB8fCAhYi5vd25lckRvY3VtZW50KSByZXR1cm4gMDsKCQl2YXIgYVJhbmdlID0gYS5vd25lckRvY3VtZW50LmNyZWF0ZVJhbmdlKCksIGJSYW5nZSA9IGIub3duZXJEb2N1bWVudC5jcmVhdGVSYW5nZSgpOwoJCWFSYW5nZS5zZXRTdGFydChhLCAwKTsKCQlhUmFuZ2Uuc2V0RW5kKGEsIDApOwoJCWJSYW5nZS5zZXRTdGFydChiLCAwKTsKCQliUmFuZ2Uuc2V0RW5kKGIsIDApOwoJCXJldHVybiBhUmFuZ2UuY29tcGFyZUJvdW5kYXJ5UG9pbnRzKFJhbmdlLlNUQVJUX1RPX0VORCwgYlJhbmdlKTsKCX0gOiBudWxsIDsKCglyb290ID0gbnVsbDsKCglmb3IgKGZlYXR1cmUgaW4gZmVhdHVyZXMpewoJCXRoaXNbZmVhdHVyZV0gPSBmZWF0dXJlc1tmZWF0dXJlXTsKCX0KfTsKCi8vIE1haW4gTWV0aG9kCgp2YXIgcmVTaW1wbGVTZWxlY3RvciA9IC9eKFsjLl0/KSgoPzpbXHctXSt8XCopKSQvLAoJcmVFbXB0eUF0dHJpYnV0ZSA9IC9cWy4rWyokXl09KD86IiJ8JycpP1xdLywKCXFzYUZhaWxFeHBDYWNoZSA9IHt9OwoKbG9jYWwuc2VhcmNoID0gZnVuY3Rpb24oY29udGV4dCwgZXhwcmVzc2lvbiwgYXBwZW5kLCBmaXJzdCl7CgoJdmFyIGZvdW5kID0gdGhpcy5mb3VuZCA9IChmaXJzdCkgPyBudWxsIDogKGFwcGVuZCB8fCBbXSk7CgkKCWlmICghY29udGV4dCkgcmV0dXJuIGZvdW5kOwoJZWxzZSBpZiAoY29udGV4dC5uYXZpZ2F0b3IpIGNvbnRleHQgPSBjb250ZXh0LmRvY3VtZW50OyAvLyBDb252ZXJ0IHRoZSBub2RlIGZyb20gYSB3aW5kb3cgdG8gYSBkb2N1bWVudAoJZWxzZSBpZiAoIWNvbnRleHQubm9kZVR5cGUpIHJldHVybiBmb3VuZDsKCgkvLyBzZXR1cAoKCXZhciBwYXJzZWQsIGksCgkJdW5pcXVlcyA9IHRoaXMudW5pcXVlcyA9IHt9LAoJCWhhc090aGVycyA9ICEhKGFwcGVuZCAmJiBhcHBlbmQubGVuZ3RoKSwKCQljb250ZXh0SXNEb2N1bWVudCA9IChjb250ZXh0Lm5vZGVUeXBlID09IDkpOwoKCWlmICh0aGlzLmRvY3VtZW50ICE9PSAoY29udGV4dElzRG9jdW1lbnQgPyBjb250ZXh0IDogY29udGV4dC5vd25lckRvY3VtZW50KSkgdGhpcy5zZXREb2N1bWVudChjb250ZXh0KTsKCgkvLyBhdm9pZCBkdXBsaWNhdGluZyBpdGVtcyBhbHJlYWR5IGluIHRoZSBhcHBlbmQgYXJyYXkKCWlmIChoYXNPdGhlcnMpIGZvciAoaSA9IGZvdW5kLmxlbmd0aDsgaS0tOykgdW5pcXVlc1t0aGlzLmdldFVJRChmb3VuZFtpXSldID0gdHJ1ZTsKCgkvLyBleHByZXNzaW9uIGNoZWNrcwoKCWlmICh0eXBlb2YgZXhwcmVzc2lvbiA9PSAnc3RyaW5nJyl7IC8vIGV4cHJlc3Npb24gaXMgYSBzdHJpbmcKCgkJLyo8c2ltcGxlLXNlbGVjdG9ycy1vdmVycmlkZT4qLwoJCXZhciBzaW1wbGVTZWxlY3RvciA9IGV4cHJlc3Npb24ubWF0Y2gocmVTaW1wbGVTZWxlY3Rvcik7CgkJc2ltcGxlU2VsZWN0b3JzOiBpZiAoc2ltcGxlU2VsZWN0b3IpIHsKCgkJCXZhciBzeW1ib2wgPSBzaW1wbGVTZWxlY3RvclsxXSwKCQkJCW5hbWUgPSBzaW1wbGVTZWxlY3RvclsyXSwKCQkJCW5vZGUsIG5vZGVzOwoKCQkJaWYgKCFzeW1ib2wpewoKCQkJCWlmIChuYW1lID09ICcqJyAmJiB0aGlzLmJyb2tlblN0YXJHRUJUTikgYnJlYWsgc2ltcGxlU2VsZWN0b3JzOwoJCQkJbm9kZXMgPSBjb250ZXh0LmdldEVsZW1lbnRzQnlUYWdOYW1lKG5hbWUpOwoJCQkJaWYgKGZpcnN0KSByZXR1cm4gbm9kZXNbMF0gfHwgbnVsbDsKCQkJCWZvciAoaSA9IDA7IG5vZGUgPSBub2Rlc1tpKytdOyl7CgkJCQkJaWYgKCEoaGFzT3RoZXJzICYmIHVuaXF1ZXNbdGhpcy5nZXRVSUQobm9kZSldKSkgZm91bmQucHVzaChub2RlKTsKCQkJCX0KCgkJCX0gZWxzZSBpZiAoc3ltYm9sID09ICcjJyl7CgoJCQkJaWYgKCF0aGlzLmlzSFRNTERvY3VtZW50IHx8ICFjb250ZXh0SXNEb2N1bWVudCkgYnJlYWsgc2ltcGxlU2VsZWN0b3JzOwoJCQkJbm9kZSA9IGNvbnRleHQuZ2V0RWxlbWVudEJ5SWQobmFtZSk7CgkJCQlpZiAoIW5vZGUpIHJldHVybiBmb3VuZDsKCQkJCWlmICh0aGlzLmlkR2V0c05hbWUgJiYgbm9kZS5nZXRBdHRyaWJ1dGVOb2RlKCdpZCcpLm5vZGVWYWx1ZSAhPSBuYW1lKSBicmVhayBzaW1wbGVTZWxlY3RvcnM7CgkJCQlpZiAoZmlyc3QpIHJldHVybiBub2RlIHx8IG51bGw7CgkJCQlpZiAoIShoYXNPdGhlcnMgJiYgdW5pcXVlc1t0aGlzLmdldFVJRChub2RlKV0pKSBmb3VuZC5wdXNoKG5vZGUpOwoKCQkJfSBlbHNlIGlmIChzeW1ib2wgPT0gJy4nKXsKCgkJCQlpZiAoIXRoaXMuaXNIVE1MRG9jdW1lbnQgfHwgKCghY29udGV4dC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lIHx8IHRoaXMuYnJva2VuR0VCQ04pICYmIGNvbnRleHQucXVlcnlTZWxlY3RvckFsbCkpIGJyZWFrIHNpbXBsZVNlbGVjdG9yczsKCQkJCWlmIChjb250ZXh0LmdldEVsZW1lbnRzQnlDbGFzc05hbWUgJiYgIXRoaXMuYnJva2VuR0VCQ04pewoJCQkJCW5vZGVzID0gY29udGV4dC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKG5hbWUpOwoJCQkJCWlmIChmaXJzdCkgcmV0dXJuIG5vZGVzWzBdIHx8IG51bGw7CgkJCQkJZm9yIChpID0gMDsgbm9kZSA9IG5vZGVzW2krK107KXsKCQkJCQkJaWYgKCEoaGFzT3RoZXJzICYmIHVuaXF1ZXNbdGhpcy5nZXRVSUQobm9kZSldKSkgZm91bmQucHVzaChub2RlKTsKCQkJCQl9CgkJCQl9IGVsc2UgewoJCQkJCXZhciBtYXRjaENsYXNzID0gbmV3IFJlZ0V4cCgnKF58XFxzKScrIFNsaWNrLmVzY2FwZVJlZ0V4cChuYW1lKSArJyhcXHN8JCknKTsKCQkJCQlub2RlcyA9IGNvbnRleHQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJyonKTsKCQkJCQlmb3IgKGkgPSAwOyBub2RlID0gbm9kZXNbaSsrXTspewoJCQkJCQljbGFzc05hbWUgPSBub2RlLmNsYXNzTmFtZTsKCQkJCQkJaWYgKCEoY2xhc3NOYW1lICYmIG1hdGNoQ2xhc3MudGVzdChjbGFzc05hbWUpKSkgY29udGludWU7CgkJCQkJCWlmIChmaXJzdCkgcmV0dXJuIG5vZGU7CgkJCQkJCWlmICghKGhhc090aGVycyAmJiB1bmlxdWVzW3RoaXMuZ2V0VUlEKG5vZGUpXSkpIGZvdW5kLnB1c2gobm9kZSk7CgkJCQkJfQoJCQkJfQoKCQkJfQoKCQkJaWYgKGhhc090aGVycykgdGhpcy5zb3J0KGZvdW5kKTsKCQkJcmV0dXJuIChmaXJzdCkgPyBudWxsIDogZm91bmQ7CgoJCX0KCQkvKjwvc2ltcGxlLXNlbGVjdG9ycy1vdmVycmlkZT4qLwoKCQkvKjxxdWVyeS1zZWxlY3Rvci1vdmVycmlkZT4qLwoJCXF1ZXJ5U2VsZWN0b3I6IGlmIChjb250ZXh0LnF1ZXJ5U2VsZWN0b3JBbGwpIHsKCgkJCWlmICghdGhpcy5pc0hUTUxEb2N1bWVudAoJCQkJfHwgcXNhRmFpbEV4cENhY2hlW2V4cHJlc3Npb25dCgkJCQkvL1RPRE86IG9ubHkgc2tpcCB3aGVuIGV4cHJlc3Npb24gaXMgYWN0dWFsbHkgbWl4ZWQgY2FzZQoJCQkJfHwgdGhpcy5icm9rZW5NaXhlZENhc2VRU0EKCQkJCXx8ICh0aGlzLmJyb2tlbkNoZWNrZWRRU0EgJiYgZXhwcmVzc2lvbi5pbmRleE9mKCc6Y2hlY2tlZCcpID4gLTEpCgkJCQl8fCAodGhpcy5icm9rZW5FbXB0eUF0dHJpYnV0ZVFTQSAmJiByZUVtcHR5QXR0cmlidXRlLnRlc3QoZXhwcmVzc2lvbikpCgkJCQl8fCAoIWNvbnRleHRJc0RvY3VtZW50IC8vQWJvcnQgd2hlbiAhY29udGV4dElzRG9jdW1lbnQgYW5kLi4uCgkJCQkJLy8gIHRoZXJlIGFyZSBtdWx0aXBsZSBleHByZXNzaW9ucyBpbiB0aGUgc2VsZWN0b3IKCQkJCQkvLyAgc2luY2Ugd2UgY3VycmVudGx5IG9ubHkgZml4IG5vbi1kb2N1bWVudCByb290ZWQgUVNBIGZvciBzaW5nbGUgZXhwcmVzc2lvbiBzZWxlY3RvcnMKCQkJCQkmJiBleHByZXNzaW9uLmluZGV4T2YoJywnKSA+IC0xCgkJCQkpCgkJCQl8fCBTbGljay5kaXNhYmxlUVNBCgkJCSkgYnJlYWsgcXVlcnlTZWxlY3RvcjsKCgkJCXZhciBfZXhwcmVzc2lvbiA9IGV4cHJlc3Npb24sIF9jb250ZXh0ID0gY29udGV4dDsKCQkJaWYgKCFjb250ZXh0SXNEb2N1bWVudCl7CgkJCQkvLyBub24tZG9jdW1lbnQgcm9vdGVkIFFTQQoJCQkJLy8gY3JlZGl0cyB0byBBbmRyZXcgRHVwb250CgkJCQl2YXIgY3VycmVudElkID0gX2NvbnRleHQuZ2V0QXR0cmlidXRlKCdpZCcpLCBzbGlja2lkID0gJ3NsaWNraWRfXyc7CgkJCQlfY29udGV4dC5zZXRBdHRyaWJ1dGUoJ2lkJywgc2xpY2tpZCk7CgkJCQlfZXhwcmVzc2lvbiA9ICcjJyArIHNsaWNraWQgKyAnICcgKyBfZXhwcmVzc2lvbjsKCQkJCWNvbnRleHQgPSBfY29udGV4dC5wYXJlbnROb2RlOwoJCQl9CgoJCQl0cnkgewoJCQkJaWYgKGZpcnN0KSByZXR1cm4gY29udGV4dC5xdWVyeVNlbGVjdG9yKF9leHByZXNzaW9uKSB8fCBudWxsOwoJCQkJZWxzZSBub2RlcyA9IGNvbnRleHQucXVlcnlTZWxlY3RvckFsbChfZXhwcmVzc2lvbik7CgkJCX0gY2F0Y2goZSkgewoJCQkJcXNhRmFpbEV4cENhY2hlW2V4cHJlc3Npb25dID0gMTsKCQkJCWJyZWFrIHF1ZXJ5U2VsZWN0b3I7CgkJCX0gZmluYWxseSB7CgkJCQlpZiAoIWNvbnRleHRJc0RvY3VtZW50KXsKCQkJCQlpZiAoY3VycmVudElkKSBfY29udGV4dC5zZXRBdHRyaWJ1dGUoJ2lkJywgY3VycmVudElkKTsKCQkJCQllbHNlIF9jb250ZXh0LnJlbW92ZUF0dHJpYnV0ZSgnaWQnKTsKCQkJCQljb250ZXh0ID0gX2NvbnRleHQ7CgkJCQl9CgkJCX0KCgkJCWlmICh0aGlzLnN0YXJTZWxlY3RzQ2xvc2VkUVNBKSBmb3IgKGkgPSAwOyBub2RlID0gbm9kZXNbaSsrXTspewoJCQkJaWYgKG5vZGUubm9kZU5hbWUgPiAnQCcgJiYgIShoYXNPdGhlcnMgJiYgdW5pcXVlc1t0aGlzLmdldFVJRChub2RlKV0pKSBmb3VuZC5wdXNoKG5vZGUpOwoJCQl9IGVsc2UgZm9yIChpID0gMDsgbm9kZSA9IG5vZGVzW2krK107KXsKCQkJCWlmICghKGhhc090aGVycyAmJiB1bmlxdWVzW3RoaXMuZ2V0VUlEKG5vZGUpXSkpIGZvdW5kLnB1c2gobm9kZSk7CgkJCX0KCgkJCWlmIChoYXNPdGhlcnMpIHRoaXMuc29ydChmb3VuZCk7CgkJCXJldHVybiBmb3VuZDsKCgkJfQoJCS8qPC9xdWVyeS1zZWxlY3Rvci1vdmVycmlkZT4qLwoKCQlwYXJzZWQgPSB0aGlzLlNsaWNrLnBhcnNlKGV4cHJlc3Npb24pOwoJCWlmICghcGFyc2VkLmxlbmd0aCkgcmV0dXJuIGZvdW5kOwoJfSBlbHNlIGlmIChleHByZXNzaW9uID09IG51bGwpeyAvLyB0aGVyZSBpcyBubyBleHByZXNzaW9uCgkJcmV0dXJuIGZvdW5kOwoJfSBlbHNlIGlmIChleHByZXNzaW9uLlNsaWNrKXsgLy8gZXhwcmVzc2lvbiBpcyBhIHBhcnNlZCBTbGljayBvYmplY3QKCQlwYXJzZWQgPSBleHByZXNzaW9uOwoJfSBlbHNlIGlmICh0aGlzLmNvbnRhaW5zKGNvbnRleHQuZG9jdW1lbnRFbGVtZW50IHx8IGNvbnRleHQsIGV4cHJlc3Npb24pKXsgLy8gZXhwcmVzc2lvbiBpcyBhIG5vZGUKCQkoZm91bmQpID8gZm91bmQucHVzaChleHByZXNzaW9uKSA6IGZvdW5kID0gZXhwcmVzc2lvbjsKCQlyZXR1cm4gZm91bmQ7Cgl9IGVsc2UgeyAvLyBvdGhlciBqdW5rCgkJcmV0dXJuIGZvdW5kOwoJfQoKCS8qPHBzZXVkby1zZWxlY3RvcnM+Ki8vKjxudGgtcHNldWRvLXNlbGVjdG9ycz4qLwoKCS8vIGNhY2hlIGVsZW1lbnRzIGZvciB0aGUgbnRoIHNlbGVjdG9ycwoKCXRoaXMucG9zTlRIID0ge307Cgl0aGlzLnBvc05USExhc3QgPSB7fTsKCXRoaXMucG9zTlRIVHlwZSA9IHt9OwoJdGhpcy5wb3NOVEhUeXBlTGFzdCA9IHt9OwoKCS8qPC9udGgtcHNldWRvLXNlbGVjdG9ycz4qLy8qPC9wc2V1ZG8tc2VsZWN0b3JzPiovCgoJLy8gaWYgYXBwZW5kIGlzIG51bGwgYW5kIHRoZXJlIGlzIG9ubHkgYSBzaW5nbGUgc2VsZWN0b3Igd2l0aCBvbmUgZXhwcmVzc2lvbiB1c2UgcHVzaEFycmF5LCBlbHNlIHVzZSBwdXNoVUlECgl0aGlzLnB1c2ggPSAoIWhhc090aGVycyAmJiAoZmlyc3QgfHwgKHBhcnNlZC5sZW5ndGggPT0gMSAmJiBwYXJzZWQuZXhwcmVzc2lvbnNbMF0ubGVuZ3RoID09IDEpKSkgPyB0aGlzLnB1c2hBcnJheSA6IHRoaXMucHVzaFVJRDsKCglpZiAoZm91bmQgPT0gbnVsbCkgZm91bmQgPSBbXTsKCgkvLyBkZWZhdWx0IGVuZ2luZQoKCXZhciBqLCBtLCBuOwoJdmFyIGNvbWJpbmF0b3IsIHRhZywgaWQsIGNsYXNzTGlzdCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvczsKCXZhciBjdXJyZW50SXRlbXMsIGN1cnJlbnRFeHByZXNzaW9uLCBjdXJyZW50Qml0LCBsYXN0Qml0LCBleHByZXNzaW9ucyA9IHBhcnNlZC5leHByZXNzaW9uczsKCglzZWFyY2g6IGZvciAoaSA9IDA7IChjdXJyZW50RXhwcmVzc2lvbiA9IGV4cHJlc3Npb25zW2ldKTsgaSsrKSBmb3IgKGogPSAwOyAoY3VycmVudEJpdCA9IGN1cnJlbnRFeHByZXNzaW9uW2pdKTsgaisrKXsKCgkJY29tYmluYXRvciA9ICdjb21iaW5hdG9yOicgKyBjdXJyZW50Qml0LmNvbWJpbmF0b3I7CgkJaWYgKCF0aGlzW2NvbWJpbmF0b3JdKSBjb250aW51ZSBzZWFyY2g7CgoJCXRhZyAgICAgICAgPSAodGhpcy5pc1hNTERvY3VtZW50KSA/IGN1cnJlbnRCaXQudGFnIDogY3VycmVudEJpdC50YWcudG9VcHBlckNhc2UoKTsKCQlpZCAgICAgICAgID0gY3VycmVudEJpdC5pZDsKCQljbGFzc0xpc3QgID0gY3VycmVudEJpdC5jbGFzc0xpc3Q7CgkJY2xhc3NlcyAgICA9IGN1cnJlbnRCaXQuY2xhc3NlczsKCQlhdHRyaWJ1dGVzID0gY3VycmVudEJpdC5hdHRyaWJ1dGVzOwoJCXBzZXVkb3MgICAgPSBjdXJyZW50Qml0LnBzZXVkb3M7CgkJbGFzdEJpdCAgICA9IChqID09PSAoY3VycmVudEV4cHJlc3Npb24ubGVuZ3RoIC0gMSkpOwoKCQl0aGlzLmJpdFVuaXF1ZXMgPSB7fTsKCgkJaWYgKGxhc3RCaXQpewoJCQl0aGlzLnVuaXF1ZXMgPSB1bmlxdWVzOwoJCQl0aGlzLmZvdW5kID0gZm91bmQ7CgkJfSBlbHNlIHsKCQkJdGhpcy51bmlxdWVzID0ge307CgkJCXRoaXMuZm91bmQgPSBbXTsKCQl9CgoJCWlmIChqID09PSAwKXsKCQkJdGhpc1tjb21iaW5hdG9yXShjb250ZXh0LCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zLCBjbGFzc0xpc3QpOwoJCQlpZiAoZmlyc3QgJiYgbGFzdEJpdCAmJiBmb3VuZC5sZW5ndGgpIGJyZWFrIHNlYXJjaDsKCQl9IGVsc2UgewoJCQlpZiAoZmlyc3QgJiYgbGFzdEJpdCkgZm9yIChtID0gMCwgbiA9IGN1cnJlbnRJdGVtcy5sZW5ndGg7IG0gPCBuOyBtKyspewoJCQkJdGhpc1tjb21iaW5hdG9yXShjdXJyZW50SXRlbXNbbV0sIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MsIGNsYXNzTGlzdCk7CgkJCQlpZiAoZm91bmQubGVuZ3RoKSBicmVhayBzZWFyY2g7CgkJCX0gZWxzZSBmb3IgKG0gPSAwLCBuID0gY3VycmVudEl0ZW1zLmxlbmd0aDsgbSA8IG47IG0rKykgdGhpc1tjb21iaW5hdG9yXShjdXJyZW50SXRlbXNbbV0sIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MsIGNsYXNzTGlzdCk7CgkJfQoKCQljdXJyZW50SXRlbXMgPSB0aGlzLmZvdW5kOwoJfQoKCS8vIHNob3VsZCBzb3J0IGlmIHRoZXJlIGFyZSBub2RlcyBpbiBhcHBlbmQgYW5kIGlmIHlvdSBwYXNzIG11bHRpcGxlIGV4cHJlc3Npb25zLgoJaWYgKGhhc090aGVycyB8fCAocGFyc2VkLmV4cHJlc3Npb25zLmxlbmd0aCA+IDEpKSB0aGlzLnNvcnQoZm91bmQpOwoKCXJldHVybiAoZmlyc3QpID8gKGZvdW5kWzBdIHx8IG51bGwpIDogZm91bmQ7Cn07CgovLyBVdGlscwoKbG9jYWwudWlkeCA9IDE7CmxvY2FsLnVpZGsgPSAnc2xpY2stdW5pcXVlaWQnOwoKbG9jYWwuZ2V0VUlEWE1MID0gZnVuY3Rpb24obm9kZSl7Cgl2YXIgdWlkID0gbm9kZS5nZXRBdHRyaWJ1dGUodGhpcy51aWRrKTsKCWlmICghdWlkKXsKCQl1aWQgPSB0aGlzLnVpZHgrKzsKCQlub2RlLnNldEF0dHJpYnV0ZSh0aGlzLnVpZGssIHVpZCk7Cgl9CglyZXR1cm4gdWlkOwp9OwoKbG9jYWwuZ2V0VUlESFRNTCA9IGZ1bmN0aW9uKG5vZGUpewoJcmV0dXJuIG5vZGUudW5pcXVlTnVtYmVyIHx8IChub2RlLnVuaXF1ZU51bWJlciA9IHRoaXMudWlkeCsrKTsKfTsKCi8vIHNvcnQgYmFzZWQgb24gdGhlIHNldERvY3VtZW50IGRvY3VtZW50U29ydGVyIG1ldGhvZC4KCmxvY2FsLnNvcnQgPSBmdW5jdGlvbihyZXN1bHRzKXsKCWlmICghdGhpcy5kb2N1bWVudFNvcnRlcikgcmV0dXJuIHJlc3VsdHM7CglyZXN1bHRzLnNvcnQodGhpcy5kb2N1bWVudFNvcnRlcik7CglyZXR1cm4gcmVzdWx0czsKfTsKCi8qPHBzZXVkby1zZWxlY3RvcnM+Ki8vKjxudGgtcHNldWRvLXNlbGVjdG9ycz4qLwoKbG9jYWwuY2FjaGVOVEggPSB7fTsKCmxvY2FsLm1hdGNoTlRIID0gL14oWystXT9cZCopPyhbYS16XSspPyhbKy1dXGQrKT8kLzsKCmxvY2FsLnBhcnNlTlRIQXJndW1lbnQgPSBmdW5jdGlvbihhcmd1bWVudCl7Cgl2YXIgcGFyc2VkID0gYXJndW1lbnQubWF0Y2godGhpcy5tYXRjaE5USCk7CglpZiAoIXBhcnNlZCkgcmV0dXJuIGZhbHNlOwoJdmFyIHNwZWNpYWwgPSBwYXJzZWRbMl0gfHwgZmFsc2U7Cgl2YXIgYSA9IHBhcnNlZFsxXSB8fCAxOwoJaWYgKGEgPT0gJy0nKSBhID0gLTE7Cgl2YXIgYiA9ICtwYXJzZWRbM10gfHwgMDsKCXBhcnNlZCA9CgkJKHNwZWNpYWwgPT0gJ24nKQk/IHthOiBhLCBiOiBifSA6CgkJKHNwZWNpYWwgPT0gJ29kZCcpCT8ge2E6IDIsIGI6IDF9IDoKCQkoc3BlY2lhbCA9PSAnZXZlbicpCT8ge2E6IDIsIGI6IDB9IDoge2E6IDAsIGI6IGF9OwoKCXJldHVybiAodGhpcy5jYWNoZU5USFthcmd1bWVudF0gPSBwYXJzZWQpOwp9OwoKbG9jYWwuY3JlYXRlTlRIUHNldWRvID0gZnVuY3Rpb24oY2hpbGQsIHNpYmxpbmcsIHBvc2l0aW9ucywgb2ZUeXBlKXsKCXJldHVybiBmdW5jdGlvbihub2RlLCBhcmd1bWVudCl7CgkJdmFyIHVpZCA9IHRoaXMuZ2V0VUlEKG5vZGUpOwoJCWlmICghdGhpc1twb3NpdGlvbnNdW3VpZF0pewoJCQl2YXIgcGFyZW50ID0gbm9kZS5wYXJlbnROb2RlOwoJCQlpZiAoIXBhcmVudCkgcmV0dXJuIGZhbHNlOwoJCQl2YXIgZWwgPSBwYXJlbnRbY2hpbGRdLCBjb3VudCA9IDE7CgkJCWlmIChvZlR5cGUpewoJCQkJdmFyIG5vZGVOYW1lID0gbm9kZS5ub2RlTmFtZTsKCQkJCWRvIHsKCQkJCQlpZiAoZWwubm9kZU5hbWUgIT0gbm9kZU5hbWUpIGNvbnRpbnVlOwoJCQkJCXRoaXNbcG9zaXRpb25zXVt0aGlzLmdldFVJRChlbCldID0gY291bnQrKzsKCQkJCX0gd2hpbGUgKChlbCA9IGVsW3NpYmxpbmddKSk7CgkJCX0gZWxzZSB7CgkJCQlkbyB7CgkJCQkJaWYgKGVsLm5vZGVUeXBlICE9IDEpIGNvbnRpbnVlOwoJCQkJCXRoaXNbcG9zaXRpb25zXVt0aGlzLmdldFVJRChlbCldID0gY291bnQrKzsKCQkJCX0gd2hpbGUgKChlbCA9IGVsW3NpYmxpbmddKSk7CgkJCX0KCQl9CgkJYXJndW1lbnQgPSBhcmd1bWVudCB8fCAnbic7CgkJdmFyIHBhcnNlZCA9IHRoaXMuY2FjaGVOVEhbYXJndW1lbnRdIHx8IHRoaXMucGFyc2VOVEhBcmd1bWVudChhcmd1bWVudCk7CgkJaWYgKCFwYXJzZWQpIHJldHVybiBmYWxzZTsKCQl2YXIgYSA9IHBhcnNlZC5hLCBiID0gcGFyc2VkLmIsIHBvcyA9IHRoaXNbcG9zaXRpb25zXVt1aWRdOwoJCWlmIChhID09IDApIHJldHVybiBiID09IHBvczsKCQlpZiAoYSA+IDApewoJCQlpZiAocG9zIDwgYikgcmV0dXJuIGZhbHNlOwoJCX0gZWxzZSB7CgkJCWlmIChiIDwgcG9zKSByZXR1cm4gZmFsc2U7CgkJfQoJCXJldHVybiAoKHBvcyAtIGIpICUgYSkgPT0gMDsKCX07Cn07CgovKjwvbnRoLXBzZXVkby1zZWxlY3RvcnM+Ki8vKjwvcHNldWRvLXNlbGVjdG9ycz4qLwoKbG9jYWwucHVzaEFycmF5ID0gZnVuY3Rpb24obm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyl7CglpZiAodGhpcy5tYXRjaFNlbGVjdG9yKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpKSB0aGlzLmZvdW5kLnB1c2gobm9kZSk7Cn07Cgpsb2NhbC5wdXNoVUlEID0gZnVuY3Rpb24obm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyl7Cgl2YXIgdWlkID0gdGhpcy5nZXRVSUQobm9kZSk7CglpZiAoIXRoaXMudW5pcXVlc1t1aWRdICYmIHRoaXMubWF0Y2hTZWxlY3Rvcihub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKSl7CgkJdGhpcy51bmlxdWVzW3VpZF0gPSB0cnVlOwoJCXRoaXMuZm91bmQucHVzaChub2RlKTsKCX0KfTsKCmxvY2FsLm1hdGNoTm9kZSA9IGZ1bmN0aW9uKG5vZGUsIHNlbGVjdG9yKXsKCWlmICh0aGlzLmlzSFRNTERvY3VtZW50ICYmIHRoaXMubmF0aXZlTWF0Y2hlc1NlbGVjdG9yKXsKCQl0cnkgewoJCQlyZXR1cm4gdGhpcy5uYXRpdmVNYXRjaGVzU2VsZWN0b3IuY2FsbChub2RlLCBzZWxlY3Rvci5yZXBsYWNlKC9cWyhbXj1dKyk9XHMqKFteJyJcXV0rPylccypcXS9nLCAnWyQxPSIkMiJdJykpOwoJCX0gY2F0Y2gobWF0Y2hFcnJvcikge30KCX0KCQoJdmFyIHBhcnNlZCA9IHRoaXMuU2xpY2sucGFyc2Uoc2VsZWN0b3IpOwoJaWYgKCFwYXJzZWQpIHJldHVybiB0cnVlOwoKCS8vIHNpbXBsZSAoc2luZ2xlKSBzZWxlY3RvcnMKCXZhciBleHByZXNzaW9ucyA9IHBhcnNlZC5leHByZXNzaW9ucywgcmV2ZXJzZWRFeHByZXNzaW9ucywgc2ltcGxlRXhwQ291bnRlciA9IDAsIGk7Cglmb3IgKGkgPSAwOyAoY3VycmVudEV4cHJlc3Npb24gPSBleHByZXNzaW9uc1tpXSk7IGkrKyl7CgkJaWYgKGN1cnJlbnRFeHByZXNzaW9uLmxlbmd0aCA9PSAxKXsKCQkJdmFyIGV4cCA9IGN1cnJlbnRFeHByZXNzaW9uWzBdOwoJCQlpZiAodGhpcy5tYXRjaFNlbGVjdG9yKG5vZGUsICh0aGlzLmlzWE1MRG9jdW1lbnQpID8gZXhwLnRhZyA6IGV4cC50YWcudG9VcHBlckNhc2UoKSwgZXhwLmlkLCBleHAuY2xhc3NlcywgZXhwLmF0dHJpYnV0ZXMsIGV4cC5wc2V1ZG9zKSkgcmV0dXJuIHRydWU7CgkJCXNpbXBsZUV4cENvdW50ZXIrKzsKCQl9Cgl9CgoJaWYgKHNpbXBsZUV4cENvdW50ZXIgPT0gcGFyc2VkLmxlbmd0aCkgcmV0dXJuIGZhbHNlOwoKCXZhciBub2RlcyA9IHRoaXMuc2VhcmNoKHRoaXMuZG9jdW1lbnQsIHBhcnNlZCksIGl0ZW07Cglmb3IgKGkgPSAwOyBpdGVtID0gbm9kZXNbaSsrXTspewoJCWlmIChpdGVtID09PSBub2RlKSByZXR1cm4gdHJ1ZTsKCX0KCXJldHVybiBmYWxzZTsKfTsKCmxvY2FsLm1hdGNoUHNldWRvID0gZnVuY3Rpb24obm9kZSwgbmFtZSwgYXJndW1lbnQpewoJdmFyIHBzZXVkb05hbWUgPSAncHNldWRvOicgKyBuYW1lOwoJaWYgKHRoaXNbcHNldWRvTmFtZV0pIHJldHVybiB0aGlzW3BzZXVkb05hbWVdKG5vZGUsIGFyZ3VtZW50KTsKCXZhciBhdHRyaWJ1dGUgPSB0aGlzLmdldEF0dHJpYnV0ZShub2RlLCBuYW1lKTsKCXJldHVybiAoYXJndW1lbnQpID8gYXJndW1lbnQgPT0gYXR0cmlidXRlIDogISFhdHRyaWJ1dGU7Cn07Cgpsb2NhbC5tYXRjaFNlbGVjdG9yID0gZnVuY3Rpb24obm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyl7CglpZiAodGFnKXsKCQl2YXIgbm9kZU5hbWUgPSAodGhpcy5pc1hNTERvY3VtZW50KSA/IG5vZGUubm9kZU5hbWUgOiBub2RlLm5vZGVOYW1lLnRvVXBwZXJDYXNlKCk7CgkJaWYgKHRhZyA9PSAnKicpewoJCQlpZiAobm9kZU5hbWUgPCAnQCcpIHJldHVybiBmYWxzZTsgLy8gRml4IGZvciBjb21tZW50IG5vZGVzIGFuZCBjbG9zZWQgbm9kZXMKCQl9IGVsc2UgewoJCQlpZiAobm9kZU5hbWUgIT0gdGFnKSByZXR1cm4gZmFsc2U7CgkJfQoJfQoKCWlmIChpZCAmJiBub2RlLmdldEF0dHJpYnV0ZSgnaWQnKSAhPSBpZCkgcmV0dXJuIGZhbHNlOwoKCXZhciBpLCBwYXJ0LCBjbHM7CglpZiAoY2xhc3NlcykgZm9yIChpID0gY2xhc3Nlcy5sZW5ndGg7IGktLTspewoJCWNscyA9IG5vZGUuZ2V0QXR0cmlidXRlKCdjbGFzcycpIHx8IG5vZGUuY2xhc3NOYW1lOwoJCWlmICghKGNscyAmJiBjbGFzc2VzW2ldLnJlZ2V4cC50ZXN0KGNscykpKSByZXR1cm4gZmFsc2U7Cgl9CglpZiAoYXR0cmlidXRlcykgZm9yIChpID0gYXR0cmlidXRlcy5sZW5ndGg7IGktLTspewoJCXBhcnQgPSBhdHRyaWJ1dGVzW2ldOwoJCWlmIChwYXJ0Lm9wZXJhdG9yID8gIXBhcnQudGVzdCh0aGlzLmdldEF0dHJpYnV0ZShub2RlLCBwYXJ0LmtleSkpIDogIXRoaXMuaGFzQXR0cmlidXRlKG5vZGUsIHBhcnQua2V5KSkgcmV0dXJuIGZhbHNlOwoJfQoJaWYgKHBzZXVkb3MpIGZvciAoaSA9IHBzZXVkb3MubGVuZ3RoOyBpLS07KXsKCQlwYXJ0ID0gcHNldWRvc1tpXTsKCQlpZiAoIXRoaXMubWF0Y2hQc2V1ZG8obm9kZSwgcGFydC5rZXksIHBhcnQudmFsdWUpKSByZXR1cm4gZmFsc2U7Cgl9CglyZXR1cm4gdHJ1ZTsKfTsKCnZhciBjb21iaW5hdG9ycyA9IHsKCgknICc6IGZ1bmN0aW9uKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MsIGNsYXNzTGlzdCl7IC8vIGFsbCBjaGlsZCBub2RlcywgYW55IGxldmVsCgoJCXZhciBpLCBpdGVtLCBjaGlsZHJlbjsKCgkJaWYgKHRoaXMuaXNIVE1MRG9jdW1lbnQpewoJCQlnZXRCeUlkOiBpZiAoaWQpewoJCQkJaXRlbSA9IHRoaXMuZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoaWQpOwoJCQkJaWYgKCghaXRlbSAmJiBub2RlLmFsbCkgfHwgKHRoaXMuaWRHZXRzTmFtZSAmJiBpdGVtICYmIGl0ZW0uZ2V0QXR0cmlidXRlTm9kZSgnaWQnKS5ub2RlVmFsdWUgIT0gaWQpKXsKCQkJCQkvLyBhbGxbaWRdIHJldHVybnMgYWxsIHRoZSBlbGVtZW50cyB3aXRoIHRoYXQgbmFtZSBvciBpZCBpbnNpZGUgbm9kZQoJCQkJCS8vIGlmIHRoZXJlcyBqdXN0IG9uZSBpdCB3aWxsIHJldHVybiB0aGUgZWxlbWVudCwgZWxzZSBpdCB3aWxsIGJlIGEgY29sbGVjdGlvbgoJCQkJCWNoaWxkcmVuID0gbm9kZS5hbGxbaWRdOwoJCQkJCWlmICghY2hpbGRyZW4pIHJldHVybjsKCQkJCQlpZiAoIWNoaWxkcmVuWzBdKSBjaGlsZHJlbiA9IFtjaGlsZHJlbl07CgkJCQkJZm9yIChpID0gMDsgaXRlbSA9IGNoaWxkcmVuW2krK107KXsKCQkJCQkJdmFyIGlkTm9kZSA9IGl0ZW0uZ2V0QXR0cmlidXRlTm9kZSgnaWQnKTsKCQkJCQkJaWYgKGlkTm9kZSAmJiBpZE5vZGUubm9kZVZhbHVlID09IGlkKXsKCQkJCQkJCXRoaXMucHVzaChpdGVtLCB0YWcsIG51bGwsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJCQkJCQkJYnJlYWs7CgkJCQkJCX0KCQkJCQl9IAoJCQkJCXJldHVybjsKCQkJCX0KCQkJCWlmICghaXRlbSl7CgkJCQkJLy8gaWYgdGhlIGNvbnRleHQgaXMgaW4gdGhlIGRvbSB3ZSByZXR1cm4sIGVsc2Ugd2Ugd2lsbCB0cnkgR0VCVE4sIGJyZWFraW5nIHRoZSBnZXRCeUlkIGxhYmVsCgkJCQkJaWYgKHRoaXMuY29udGFpbnModGhpcy5yb290LCBub2RlKSkgcmV0dXJuOwoJCQkJCWVsc2UgYnJlYWsgZ2V0QnlJZDsKCQkJCX0gZWxzZSBpZiAodGhpcy5kb2N1bWVudCAhPT0gbm9kZSAmJiAhdGhpcy5jb250YWlucyhub2RlLCBpdGVtKSkgcmV0dXJuOwoJCQkJdGhpcy5wdXNoKGl0ZW0sIHRhZywgbnVsbCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyk7CgkJCQlyZXR1cm47CgkJCX0KCQkJZ2V0QnlDbGFzczogaWYgKGNsYXNzZXMgJiYgbm9kZS5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lICYmICF0aGlzLmJyb2tlbkdFQkNOKXsKCQkJCWNoaWxkcmVuID0gbm9kZS5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKGNsYXNzTGlzdC5qb2luKCcgJykpOwoJCQkJaWYgKCEoY2hpbGRyZW4gJiYgY2hpbGRyZW4ubGVuZ3RoKSkgYnJlYWsgZ2V0QnlDbGFzczsKCQkJCWZvciAoaSA9IDA7IGl0ZW0gPSBjaGlsZHJlbltpKytdOykgdGhpcy5wdXNoKGl0ZW0sIHRhZywgaWQsIG51bGwsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJCQkJcmV0dXJuOwoJCQl9CgkJfQoJCWdldEJ5VGFnOiB7CgkJCWNoaWxkcmVuID0gbm9kZS5nZXRFbGVtZW50c0J5VGFnTmFtZSh0YWcpOwoJCQlpZiAoIShjaGlsZHJlbiAmJiBjaGlsZHJlbi5sZW5ndGgpKSBicmVhayBnZXRCeVRhZzsKCQkJaWYgKCF0aGlzLmJyb2tlblN0YXJHRUJUTikgdGFnID0gbnVsbDsKCQkJZm9yIChpID0gMDsgaXRlbSA9IGNoaWxkcmVuW2krK107KSB0aGlzLnB1c2goaXRlbSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyk7CgkJfQoJfSwKCgknPic6IGZ1bmN0aW9uKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpeyAvLyBkaXJlY3QgY2hpbGRyZW4KCQlpZiAoKG5vZGUgPSBub2RlLmZpcnN0Q2hpbGQpKSBkbyB7CgkJCWlmIChub2RlLm5vZGVUeXBlID09IDEpIHRoaXMucHVzaChub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKTsKCQl9IHdoaWxlICgobm9kZSA9IG5vZGUubmV4dFNpYmxpbmcpKTsKCX0sCgoJJysnOiBmdW5jdGlvbihub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKXsgLy8gbmV4dCBzaWJsaW5nCgkJd2hpbGUgKChub2RlID0gbm9kZS5uZXh0U2libGluZykpIGlmIChub2RlLm5vZGVUeXBlID09IDEpewoJCQl0aGlzLnB1c2gobm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyk7CgkJCWJyZWFrOwoJCX0KCX0sCgoJJ14nOiBmdW5jdGlvbihub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKXsgLy8gZmlyc3QgY2hpbGQKCQlub2RlID0gbm9kZS5maXJzdENoaWxkOwoJCWlmIChub2RlKXsKCQkJaWYgKG5vZGUubm9kZVR5cGUgPT0gMSkgdGhpcy5wdXNoKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJCQllbHNlIHRoaXNbJ2NvbWJpbmF0b3I6KyddKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJCX0KCX0sCgoJJ34nOiBmdW5jdGlvbihub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKXsgLy8gbmV4dCBzaWJsaW5ncwoJCXdoaWxlICgobm9kZSA9IG5vZGUubmV4dFNpYmxpbmcpKXsKCQkJaWYgKG5vZGUubm9kZVR5cGUgIT0gMSkgY29udGludWU7CgkJCXZhciB1aWQgPSB0aGlzLmdldFVJRChub2RlKTsKCQkJaWYgKHRoaXMuYml0VW5pcXVlc1t1aWRdKSBicmVhazsKCQkJdGhpcy5iaXRVbmlxdWVzW3VpZF0gPSB0cnVlOwoJCQl0aGlzLnB1c2gobm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyk7CgkJfQoJfSwKCgknKysnOiBmdW5jdGlvbihub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKXsgLy8gbmV4dCBzaWJsaW5nIGFuZCBwcmV2aW91cyBzaWJsaW5nCgkJdGhpc1snY29tYmluYXRvcjorJ10obm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyk7CgkJdGhpc1snY29tYmluYXRvcjohKyddKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJfSwKCgknfn4nOiBmdW5jdGlvbihub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKXsgLy8gbmV4dCBzaWJsaW5ncyBhbmQgcHJldmlvdXMgc2libGluZ3MKCQl0aGlzWydjb21iaW5hdG9yOn4nXShub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKTsKCQl0aGlzWydjb21iaW5hdG9yOiF+J10obm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyk7Cgl9LAoKCSchJzogZnVuY3Rpb24obm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyl7IC8vIGFsbCBwYXJlbnQgbm9kZXMgdXAgdG8gZG9jdW1lbnQKCQl3aGlsZSAoKG5vZGUgPSBub2RlLnBhcmVudE5vZGUpKSBpZiAobm9kZSAhPT0gdGhpcy5kb2N1bWVudCkgdGhpcy5wdXNoKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJfSwKCgknIT4nOiBmdW5jdGlvbihub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKXsgLy8gZGlyZWN0IHBhcmVudCAob25lIGxldmVsKQoJCW5vZGUgPSBub2RlLnBhcmVudE5vZGU7CgkJaWYgKG5vZGUgIT09IHRoaXMuZG9jdW1lbnQpIHRoaXMucHVzaChub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKTsKCX0sCgoJJyErJzogZnVuY3Rpb24obm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyl7IC8vIHByZXZpb3VzIHNpYmxpbmcKCQl3aGlsZSAoKG5vZGUgPSBub2RlLnByZXZpb3VzU2libGluZykpIGlmIChub2RlLm5vZGVUeXBlID09IDEpewoJCQl0aGlzLnB1c2gobm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyk7CgkJCWJyZWFrOwoJCX0KCX0sCgoJJyFeJzogZnVuY3Rpb24obm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyl7IC8vIGxhc3QgY2hpbGQKCQlub2RlID0gbm9kZS5sYXN0Q2hpbGQ7CgkJaWYgKG5vZGUpewoJCQlpZiAobm9kZS5ub2RlVHlwZSA9PSAxKSB0aGlzLnB1c2gobm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyk7CgkJCWVsc2UgdGhpc1snY29tYmluYXRvcjohKyddKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJCX0KCX0sCgoJJyF+JzogZnVuY3Rpb24obm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyl7IC8vIHByZXZpb3VzIHNpYmxpbmdzCgkJd2hpbGUgKChub2RlID0gbm9kZS5wcmV2aW91c1NpYmxpbmcpKXsKCQkJaWYgKG5vZGUubm9kZVR5cGUgIT0gMSkgY29udGludWU7CgkJCXZhciB1aWQgPSB0aGlzLmdldFVJRChub2RlKTsKCQkJaWYgKHRoaXMuYml0VW5pcXVlc1t1aWRdKSBicmVhazsKCQkJdGhpcy5iaXRVbmlxdWVzW3VpZF0gPSB0cnVlOwoJCQl0aGlzLnB1c2gobm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyk7CgkJfQoJfQoKfTsKCmZvciAodmFyIGMgaW4gY29tYmluYXRvcnMpIGxvY2FsWydjb21iaW5hdG9yOicgKyBjXSA9IGNvbWJpbmF0b3JzW2NdOwoKdmFyIHBzZXVkb3MgPSB7CgoJLyo8cHNldWRvLXNlbGVjdG9ycz4qLwoKCSdlbXB0eSc6IGZ1bmN0aW9uKG5vZGUpewoJCXZhciBjaGlsZCA9IG5vZGUuZmlyc3RDaGlsZDsKCQlyZXR1cm4gIShjaGlsZCAmJiBjaGlsZC5ub2RlVHlwZSA9PSAxKSAmJiAhKG5vZGUuaW5uZXJUZXh0IHx8IG5vZGUudGV4dENvbnRlbnQgfHwgJycpLmxlbmd0aDsKCX0sCgoJJ25vdCc6IGZ1bmN0aW9uKG5vZGUsIGV4cHJlc3Npb24pewoJCXJldHVybiAhdGhpcy5tYXRjaE5vZGUobm9kZSwgZXhwcmVzc2lvbik7Cgl9LAoKCSdjb250YWlucyc6IGZ1bmN0aW9uKG5vZGUsIHRleHQpewoJCXJldHVybiAobm9kZS5pbm5lclRleHQgfHwgbm9kZS50ZXh0Q29udGVudCB8fCAnJykuaW5kZXhPZih0ZXh0KSA+IC0xOwoJfSwKCgknZmlyc3QtY2hpbGQnOiBmdW5jdGlvbihub2RlKXsKCQl3aGlsZSAoKG5vZGUgPSBub2RlLnByZXZpb3VzU2libGluZykpIGlmIChub2RlLm5vZGVUeXBlID09IDEpIHJldHVybiBmYWxzZTsKCQlyZXR1cm4gdHJ1ZTsKCX0sCgoJJ2xhc3QtY2hpbGQnOiBmdW5jdGlvbihub2RlKXsKCQl3aGlsZSAoKG5vZGUgPSBub2RlLm5leHRTaWJsaW5nKSkgaWYgKG5vZGUubm9kZVR5cGUgPT0gMSkgcmV0dXJuIGZhbHNlOwoJCXJldHVybiB0cnVlOwoJfSwKCgknb25seS1jaGlsZCc6IGZ1bmN0aW9uKG5vZGUpewoJCXZhciBwcmV2ID0gbm9kZTsKCQl3aGlsZSAoKHByZXYgPSBwcmV2LnByZXZpb3VzU2libGluZykpIGlmIChwcmV2Lm5vZGVUeXBlID09IDEpIHJldHVybiBmYWxzZTsKCQl2YXIgbmV4dCA9IG5vZGU7CgkJd2hpbGUgKChuZXh0ID0gbmV4dC5uZXh0U2libGluZykpIGlmIChuZXh0Lm5vZGVUeXBlID09IDEpIHJldHVybiBmYWxzZTsKCQlyZXR1cm4gdHJ1ZTsKCX0sCgoJLyo8bnRoLXBzZXVkby1zZWxlY3RvcnM+Ki8KCgknbnRoLWNoaWxkJzogbG9jYWwuY3JlYXRlTlRIUHNldWRvKCdmaXJzdENoaWxkJywgJ25leHRTaWJsaW5nJywgJ3Bvc05USCcpLAoKCSdudGgtbGFzdC1jaGlsZCc6IGxvY2FsLmNyZWF0ZU5USFBzZXVkbygnbGFzdENoaWxkJywgJ3ByZXZpb3VzU2libGluZycsICdwb3NOVEhMYXN0JyksCgoJJ250aC1vZi10eXBlJzogbG9jYWwuY3JlYXRlTlRIUHNldWRvKCdmaXJzdENoaWxkJywgJ25leHRTaWJsaW5nJywgJ3Bvc05USFR5cGUnLCB0cnVlKSwKCgknbnRoLWxhc3Qtb2YtdHlwZSc6IGxvY2FsLmNyZWF0ZU5USFBzZXVkbygnbGFzdENoaWxkJywgJ3ByZXZpb3VzU2libGluZycsICdwb3NOVEhUeXBlTGFzdCcsIHRydWUpLAoKCSdpbmRleCc6IGZ1bmN0aW9uKG5vZGUsIGluZGV4KXsKCQlyZXR1cm4gdGhpc1sncHNldWRvOm50aC1jaGlsZCddKG5vZGUsICcnICsgaW5kZXggKyAxKTsKCX0sCgoJJ2V2ZW4nOiBmdW5jdGlvbihub2RlKXsKCQlyZXR1cm4gdGhpc1sncHNldWRvOm50aC1jaGlsZCddKG5vZGUsICcybicpOwoJfSwKCgknb2RkJzogZnVuY3Rpb24obm9kZSl7CgkJcmV0dXJuIHRoaXNbJ3BzZXVkbzpudGgtY2hpbGQnXShub2RlLCAnMm4rMScpOwoJfSwKCgkvKjwvbnRoLXBzZXVkby1zZWxlY3RvcnM+Ki8KCgkvKjxvZi10eXBlLXBzZXVkby1zZWxlY3RvcnM+Ki8KCgknZmlyc3Qtb2YtdHlwZSc6IGZ1bmN0aW9uKG5vZGUpewoJCXZhciBub2RlTmFtZSA9IG5vZGUubm9kZU5hbWU7CgkJd2hpbGUgKChub2RlID0gbm9kZS5wcmV2aW91c1NpYmxpbmcpKSBpZiAobm9kZS5ub2RlTmFtZSA9PSBub2RlTmFtZSkgcmV0dXJuIGZhbHNlOwoJCXJldHVybiB0cnVlOwoJfSwKCgknbGFzdC1vZi10eXBlJzogZnVuY3Rpb24obm9kZSl7CgkJdmFyIG5vZGVOYW1lID0gbm9kZS5ub2RlTmFtZTsKCQl3aGlsZSAoKG5vZGUgPSBub2RlLm5leHRTaWJsaW5nKSkgaWYgKG5vZGUubm9kZU5hbWUgPT0gbm9kZU5hbWUpIHJldHVybiBmYWxzZTsKCQlyZXR1cm4gdHJ1ZTsKCX0sCgoJJ29ubHktb2YtdHlwZSc6IGZ1bmN0aW9uKG5vZGUpewoJCXZhciBwcmV2ID0gbm9kZSwgbm9kZU5hbWUgPSBub2RlLm5vZGVOYW1lOwoJCXdoaWxlICgocHJldiA9IHByZXYucHJldmlvdXNTaWJsaW5nKSkgaWYgKHByZXYubm9kZU5hbWUgPT0gbm9kZU5hbWUpIHJldHVybiBmYWxzZTsKCQl2YXIgbmV4dCA9IG5vZGU7CgkJd2hpbGUgKChuZXh0ID0gbmV4dC5uZXh0U2libGluZykpIGlmIChuZXh0Lm5vZGVOYW1lID09IG5vZGVOYW1lKSByZXR1cm4gZmFsc2U7CgkJcmV0dXJuIHRydWU7Cgl9LAoKCS8qPC9vZi10eXBlLXBzZXVkby1zZWxlY3RvcnM+Ki8KCgkvLyBjdXN0b20gcHNldWRvcwoKCSdlbmFibGVkJzogZnVuY3Rpb24obm9kZSl7CgkJcmV0dXJuICFub2RlLmRpc2FibGVkOwoJfSwKCgknZGlzYWJsZWQnOiBmdW5jdGlvbihub2RlKXsKCQlyZXR1cm4gbm9kZS5kaXNhYmxlZDsKCX0sCgoJJ2NoZWNrZWQnOiBmdW5jdGlvbihub2RlKXsKCQlyZXR1cm4gbm9kZS5jaGVja2VkIHx8IG5vZGUuc2VsZWN0ZWQ7Cgl9LAoKCSdmb2N1cyc6IGZ1bmN0aW9uKG5vZGUpewoJCXJldHVybiB0aGlzLmlzSFRNTERvY3VtZW50ICYmIHRoaXMuZG9jdW1lbnQuYWN0aXZlRWxlbWVudCA9PT0gbm9kZSAmJiAobm9kZS5ocmVmIHx8IG5vZGUudHlwZSB8fCB0aGlzLmhhc0F0dHJpYnV0ZShub2RlLCAndGFiaW5kZXgnKSk7Cgl9LAoKCSdyb290JzogZnVuY3Rpb24obm9kZSl7CgkJcmV0dXJuIChub2RlID09PSB0aGlzLnJvb3QpOwoJfSwKCQoJJ3NlbGVjdGVkJzogZnVuY3Rpb24obm9kZSl7CgkJcmV0dXJuIG5vZGUuc2VsZWN0ZWQ7Cgl9CgoJLyo8L3BzZXVkby1zZWxlY3RvcnM+Ki8KfTsKCmZvciAodmFyIHAgaW4gcHNldWRvcykgbG9jYWxbJ3BzZXVkbzonICsgcF0gPSBwc2V1ZG9zW3BdOwoKLy8gYXR0cmlidXRlcyBtZXRob2RzCgpsb2NhbC5hdHRyaWJ1dGVHZXR0ZXJzID0gewoKCSdjbGFzcyc6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMuZ2V0QXR0cmlidXRlKCdjbGFzcycpIHx8IHRoaXMuY2xhc3NOYW1lOwoJfSwKCgknZm9yJzogZnVuY3Rpb24oKXsKCQlyZXR1cm4gKCdodG1sRm9yJyBpbiB0aGlzKSA/IHRoaXMuaHRtbEZvciA6IHRoaXMuZ2V0QXR0cmlidXRlKCdmb3InKTsKCX0sCgoJJ2hyZWYnOiBmdW5jdGlvbigpewoJCXJldHVybiAoJ2hyZWYnIGluIHRoaXMpID8gdGhpcy5nZXRBdHRyaWJ1dGUoJ2hyZWYnLCAyKSA6IHRoaXMuZ2V0QXR0cmlidXRlKCdocmVmJyk7Cgl9LAoKCSdzdHlsZSc6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuICh0aGlzLnN0eWxlKSA/IHRoaXMuc3R5bGUuY3NzVGV4dCA6IHRoaXMuZ2V0QXR0cmlidXRlKCdzdHlsZScpOwoJfSwKCQoJJ3RhYmluZGV4JzogZnVuY3Rpb24oKXsKCQl2YXIgYXR0cmlidXRlTm9kZSA9IHRoaXMuZ2V0QXR0cmlidXRlTm9kZSgndGFiaW5kZXgnKTsKCQlyZXR1cm4gKGF0dHJpYnV0ZU5vZGUgJiYgYXR0cmlidXRlTm9kZS5zcGVjaWZpZWQpID8gYXR0cmlidXRlTm9kZS5ub2RlVmFsdWUgOiBudWxsOwoJfSwKCgkndHlwZSc6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMuZ2V0QXR0cmlidXRlKCd0eXBlJyk7Cgl9Cgp9OwoKLy8gU2xpY2sKCnZhciBTbGljayA9IGxvY2FsLlNsaWNrID0gKHRoaXMuU2xpY2sgfHwge30pOwoKU2xpY2sudmVyc2lvbiA9ICcxLjEuNSc7CgovLyBTbGljayBmaW5kZXIKClNsaWNrLnNlYXJjaCA9IGZ1bmN0aW9uKGNvbnRleHQsIGV4cHJlc3Npb24sIGFwcGVuZCl7CglyZXR1cm4gbG9jYWwuc2VhcmNoKGNvbnRleHQsIGV4cHJlc3Npb24sIGFwcGVuZCk7Cn07CgpTbGljay5maW5kID0gZnVuY3Rpb24oY29udGV4dCwgZXhwcmVzc2lvbil7CglyZXR1cm4gbG9jYWwuc2VhcmNoKGNvbnRleHQsIGV4cHJlc3Npb24sIG51bGwsIHRydWUpOwp9OwoKLy8gU2xpY2sgY29udGFpbm1lbnQgY2hlY2tlcgoKU2xpY2suY29udGFpbnMgPSBmdW5jdGlvbihjb250YWluZXIsIG5vZGUpewoJbG9jYWwuc2V0RG9jdW1lbnQoY29udGFpbmVyKTsKCXJldHVybiBsb2NhbC5jb250YWlucyhjb250YWluZXIsIG5vZGUpOwp9OwoKLy8gU2xpY2sgYXR0cmlidXRlIGdldHRlcgoKU2xpY2suZ2V0QXR0cmlidXRlID0gZnVuY3Rpb24obm9kZSwgbmFtZSl7CglyZXR1cm4gbG9jYWwuZ2V0QXR0cmlidXRlKG5vZGUsIG5hbWUpOwp9OwoKLy8gU2xpY2sgbWF0Y2hlcgoKU2xpY2subWF0Y2ggPSBmdW5jdGlvbihub2RlLCBzZWxlY3Rvcil7CglpZiAoIShub2RlICYmIHNlbGVjdG9yKSkgcmV0dXJuIGZhbHNlOwoJaWYgKCFzZWxlY3RvciB8fCBzZWxlY3RvciA9PT0gbm9kZSkgcmV0dXJuIHRydWU7Cglsb2NhbC5zZXREb2N1bWVudChub2RlKTsKCXJldHVybiBsb2NhbC5tYXRjaE5vZGUobm9kZSwgc2VsZWN0b3IpOwp9OwoKLy8gU2xpY2sgYXR0cmlidXRlIGFjY2Vzc29yCgpTbGljay5kZWZpbmVBdHRyaWJ1dGVHZXR0ZXIgPSBmdW5jdGlvbihuYW1lLCBmbil7Cglsb2NhbC5hdHRyaWJ1dGVHZXR0ZXJzW25hbWVdID0gZm47CglyZXR1cm4gdGhpczsKfTsKClNsaWNrLmxvb2t1cEF0dHJpYnV0ZUdldHRlciA9IGZ1bmN0aW9uKG5hbWUpewoJcmV0dXJuIGxvY2FsLmF0dHJpYnV0ZUdldHRlcnNbbmFtZV07Cn07CgovLyBTbGljayBwc2V1ZG8gYWNjZXNzb3IKClNsaWNrLmRlZmluZVBzZXVkbyA9IGZ1bmN0aW9uKG5hbWUsIGZuKXsKCWxvY2FsWydwc2V1ZG86JyArIG5hbWVdID0gZnVuY3Rpb24obm9kZSwgYXJndW1lbnQpewoJCXJldHVybiBmbi5jYWxsKG5vZGUsIGFyZ3VtZW50KTsKCX07CglyZXR1cm4gdGhpczsKfTsKClNsaWNrLmxvb2t1cFBzZXVkbyA9IGZ1bmN0aW9uKG5hbWUpewoJdmFyIHBzZXVkbyA9IGxvY2FsWydwc2V1ZG86JyArIG5hbWVdOwoJaWYgKHBzZXVkbykgcmV0dXJuIGZ1bmN0aW9uKGFyZ3VtZW50KXsKCQlyZXR1cm4gcHNldWRvLmNhbGwodGhpcywgYXJndW1lbnQpOwoJfTsKCXJldHVybiBudWxsOwp9OwoKLy8gU2xpY2sgb3ZlcnJpZGVzIGFjY2Vzc29yCgpTbGljay5vdmVycmlkZSA9IGZ1bmN0aW9uKHJlZ2V4cCwgZm4pewoJbG9jYWwub3ZlcnJpZGUocmVnZXhwLCBmbik7CglyZXR1cm4gdGhpczsKfTsKClNsaWNrLmlzWE1MID0gbG9jYWwuaXNYTUw7CgpTbGljay51aWRPZiA9IGZ1bmN0aW9uKG5vZGUpewoJcmV0dXJuIGxvY2FsLmdldFVJREhUTUwobm9kZSk7Cn07CgppZiAoIXRoaXMuU2xpY2spIHRoaXMuU2xpY2sgPSBTbGljazsKCn0pLmFwcGx5KC8qPENvbW1vbkpTPiovKHR5cGVvZiBleHBvcnRzICE9ICd1bmRlZmluZWQnKSA/IGV4cG9ydHMgOiAvKjwvQ29tbW9uSlM+Ki90aGlzKTsKc25hY2sud3JhcC5kZWZpbmVFbmdpbmUoZnVuY3Rpb24gKHNlbGVjdG9yLCBjb250ZXh0KXsKICBpZiAodHlwZW9mIGNvbnRleHQgPT0gJ3N0cmluZycpCiAgICBjb250ZXh0ID0gU2xpY2suZmluZChkb2N1bWVudCwgY29udGV4dCkKICByZXR1cm4gU2xpY2suc2VhcmNoKGNvbnRleHQgfHwgZG9jdW1lbnQsIHNlbGVjdG9yKQp9KQo=",
                "body": "LyohCiAgKiBzbmFjay5qcyAoYykgUnlhbiBGbG9yZW5jZQogICogaHR0cHM6Ly9naXRodWIuY29tL3JwZmxvcmVuY2Uvc25hY2sKICAqIE1JVCBMaWNlbnNlCiAgKiBJbnNwaXJhdGlvbiBhbmQgY29kZSBhZGFwdGVkIGZyb20KICAqICBNb29Ub29scyAgICAgIChjKSBWYWxlcmlvIFByb2lldHRpICAgTUlUIGxpY2Vuc2UKICAqICBqUXVlcnkgICAgICAgIChjKSBKb2huIFJlc2lnICAgICAgICAgRHVhbCBsaWNlbnNlIE1JVCBvciBHUEwgVmVyc2lvbiAyCiAgKiAgY29udGVudExvYWRlZCAoYykgRGllZ28gUGVyaW5pICAgICAgIE1JVCBMaWNlbnNlCiAgKiAgWmVwdG8uanMgICAgICAoYykgVGhvbWFzIEZ1Y2hzICAgICAgIE1JVCBMaWNlbnNlCiovCgppZiAodHlwZW9mIE9iamVjdC5jcmVhdGUgIT0gJ2Z1bmN0aW9uJyl7CiAgLy8gRVM1IE9iZWplY3QuY3JlYXRlCiAgT2JqZWN0LmNyZWF0ZSA9IGZ1bmN0aW9uIChvKXsKICAgIGZ1bmN0aW9uIEYoKSB7fQogICAgRi5wcm90b3R5cGUgPSBvCiAgICByZXR1cm4gbmV3IEYKICB9Cn0KCiFmdW5jdGlvbih3aW5kb3cpewogIHZhciBzbmFjayA9IHdpbmRvdy5zbmFjayA9IHt9CiAgICAsIGd1aWQgPSAwCiAgICAsIHRvU3RyaW5nID0gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZwogICAgLCBpbmRleE9mID0gW10uaW5kZXhPZgogICAgLCBwdXNoID0gW10ucHVzaAoKICBzbmFjay5leHRlbmQgPSBmdW5jdGlvbiAoKXsKICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09IDEpCiAgICAgIHJldHVybiBzbmFjay5leHRlbmQoc25hY2ssIGFyZ3VtZW50c1swXSkKCiAgICB2YXIgdGFyZ2V0ID0gYXJndW1lbnRzWzBdCgogICAgZm9yICh2YXIga2V5LCBpID0gMSwgbCA9IGFyZ3VtZW50cy5sZW5ndGg7IGkgPCBsOyBpKyspCiAgICAgIGZvciAoa2V5IGluIGFyZ3VtZW50c1tpXSkKICAgICAgICB0YXJnZXRba2V5XSA9IGFyZ3VtZW50c1tpXVtrZXldCgogICAgcmV0dXJuIHRhcmdldAogIH0KCiAgc25hY2suZXh0ZW5kKHsKICAgIHY6ICcxLjIuMycsCgogICAgYmluZDogZnVuY3Rpb24gKGZuLCBjb250ZXh0LCBhcmdzKSB7CiAgICAgIGFyZ3MgPSBhcmdzIHx8IFtdOwogICAgICByZXR1cm4gZnVuY3Rpb24gKCl7CiAgICAgICAgcHVzaC5hcHBseShhcmdzLCBhcmd1bWVudHMpOwogICAgICAgIHJldHVybiBmbi5hcHBseShjb250ZXh0LCBhcmdzKQogICAgICB9CiAgICB9LAoKICAgIHB1bmNoOiBmdW5jdGlvbiAob2JqLCBtZXRob2QsIGZuLCBhdXRvKXsKICAgICAgdmFyIG9sZCA9IG9ialttZXRob2RdCiAgICAgIG9ialttZXRob2RdID0gYXV0byA/IGZ1bmN0aW9uICgpewogICAgICAgIG9sZC5hcHBseShvYmosIGFyZ3VtZW50cykKICAgICAgICByZXR1cm4gZm4uYXBwbHkob2JqLCBhcmd1bWVudHMpCiAgICAgIH0gOiBmdW5jdGlvbiAoKXsKICAgICAgICB2YXIgYXJncyA9IFtdLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAwKQogICAgICAgIGFyZ3MudW5zaGlmdChzbmFjay5iaW5kKG9sZCwgb2JqKSkKICAgICAgICByZXR1cm4gZm4uYXBwbHkob2JqLCBhcmdzKQogICAgICB9CiAgICB9LAoKICAgIGNyZWF0ZTogZnVuY3Rpb24gKHByb3RvLCBleHQpewogICAgICB2YXIgb2JqID0gT2JqZWN0LmNyZWF0ZShwcm90bykKICAgICAgaWYgKCFleHQpCiAgICAgICAgcmV0dXJuIG9iagoKICAgICAgZm9yICh2YXIgaSBpbiBleHQpIHsKICAgICAgICBpZiAoIWV4dC5oYXNPd25Qcm9wZXJ0eShpKSkKICAgICAgICAgIGNvbnRpbnVlCgogICAgICAgIGlmICghcHJvdG9baV0gfHwgdHlwZW9mIGV4dFtpXSAhPSAnZnVuY3Rpb24nKXsKICAgICAgICAgIG9ialtpXSA9IGV4dFtpXQogICAgICAgICAgY29udGludWUKICAgICAgICB9CgogICAgICAgIHNuYWNrLnB1bmNoKG9iaiwgaSwgZXh0W2ldKQogICAgICB9CgogICAgICByZXR1cm4gb2JqCiAgICB9LAoKICAgIGlkOiBmdW5jdGlvbiAoKXsKICAgICAgcmV0dXJuICsrZ3VpZAogICAgfSwKCiAgICBlYWNoOiBmdW5jdGlvbiAob2JqLCBmbiwgY29udGV4dCl7CiAgICAgIGlmIChvYmoubGVuZ3RoID09PSB2b2lkKzApeyAvLyBsb29zZSBjaGVjayBmb3Igb2JqZWN0LCB3ZSB3YW50IGFycmF5LWxpa2Ugb2JqZWN0cyB0byBiZSB0cmVhdGVkIGFzIGFycmF5cwogICAgICAgIGZvciAodmFyIGtleSBpbiBvYmopCiAgICAgICAgICBpZiAob2JqLmhhc093blByb3BlcnR5KGtleSkpCiAgICAgICAgICAgIGZuLmNhbGwoY29udGV4dCwgb2JqW2tleV0sIGtleSwgb2JqKTsKICAgICAgICByZXR1cm4gb2JqCiAgICAgIH0KCiAgICAgIGZvciAodmFyIGkgPSAwLCBsID0gb2JqLmxlbmd0aDsgaSA8IGw7IGkrKykKICAgICAgICBmbi5jYWxsKGNvbnRleHQsIG9ialtpXSwgaSwgb2JqKQogICAgICByZXR1cm4gb2JqCiAgICB9LAoKICAgIHBhcnNlSlNPTjogZnVuY3Rpb24oanNvbikgewogICAgICAvLyBhZGFwdGVkIGZyb20galF1ZXJ5CiAgICAgIGlmICh0eXBlb2YganNvbiAhPSAnc3RyaW5nJykKICAgICAgICByZXR1cm4KCiAgICAgIGpzb24gPSBqc29uLnJlcGxhY2UoL15ccyt8XHMrJC9nLCAnJykKCiAgICAgIHZhciBpc1ZhbGlkID0gL15bXF0sOnt9XHNdKiQvLnRlc3QoanNvbi5yZXBsYWNlKC9cXCg/OlsiXFxcL2JmbnJ0XXx1WzAtOWEtZkEtRl17NH0pL2csICJAIikKICAgICAgICAucmVwbGFjZSgvIlteIlxcXG5ccl0qInx0cnVlfGZhbHNlfG51bGx8LT9cZCsoPzpcLlxkKik/KD86W2VFXVsrXC1dP1xkKyk/L2csICJdIikKICAgICAgICAucmVwbGFjZSgvKD86Xnw6fCwpKD86XHMqXFspKy9nLCAiIikpCgogICAgICBpZiAoIWlzVmFsaWQpCiAgICAgICAgdGhyb3cgIkludmFsaWQgSlNPTiIKICAgICAgCiAgICAgIHZhciBKU09OID0gd2luZG93LkpTT04gLy8gc2F2ZXMgYSBjb3VwbGUgYnl0ZXMKICAgICAgcmV0dXJuIEpTT04gJiYgSlNPTi5wYXJzZSA/IEpTT04ucGFyc2UoanNvbikgOiAobmV3IEZ1bmN0aW9uKCJyZXR1cm4gIiArIGpzb24pKSgpCiAgICB9LAoKICAgIGlzQXJyYXk6IGZ1bmN0aW9uIChvYmopewogICAgICByZXR1cm4gb2JqIGluc3RhbmNlb2YgQXJyYXkgfHwgdG9TdHJpbmcuY2FsbChvYmopID09ICJbb2JqZWN0IEFycmF5XSIKICAgIH0sCgogICAgaW5kZXhPZjogaW5kZXhPZiA/IGZ1bmN0aW9uKGl0ZW0sIGFycmF5KXsKICAgICAgICByZXR1cm4gaW5kZXhPZi5jYWxsKGFycmF5LCBpdGVtKQogICAgICB9IDogZnVuY3Rpb24gKGl0ZW0sIGFycmF5KXsKICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSBhcnJheS5sZW5ndGg7IGkgPCBsOyBpKyspCiAgICAgICAgaWYgKGFycmF5W2ldID09PSBpdGVtKQogICAgICAgICAgcmV0dXJuIGkKCiAgICAgIHJldHVybiAtMQogICAgfQogIH0pCn0od2luZG93KTsKIWZ1bmN0aW9uIChzbmFjaywgZG9jdW1lbnQpewogIHZhciBwcm90byA9IHt9CiAgICAsIHF1ZXJ5CgogIHNuYWNrLndyYXAgPSBmdW5jdGlvbiAobm9kZXMsIGNvbnRleHQpewogICAgLy8gcGFzc2VkIGluIGEgQ1NTIHNlbGVjdG9yCiAgICBpZiAodHlwZW9mIG5vZGVzID09ICdzdHJpbmcnKQogICAgICBub2RlcyA9IHF1ZXJ5KG5vZGVzLCBjb250ZXh0KQoKICAgIC8vIHBhc3NlZCBpbiBzaW5nbGUgbm9kZQogICAgaWYgKCFub2Rlcy5sZW5ndGgpCiAgICAgIG5vZGVzID0gW25vZGVzXQoKICAgIHZhciB3cmFwcGVyID0gT2JqZWN0LmNyZWF0ZShwcm90bykKICAgICAgLCBpID0gMAogICAgICAsIGwgPSBub2Rlcy5sZW5ndGgKCiAgICBmb3IgKDsgaSA8IGw7IGkrKykKICAgICAgd3JhcHBlcltpXSA9IG5vZGVzW2ldCgogICAgd3JhcHBlci5sZW5ndGggPSBsCiAgICB3cmFwcGVyLmlkID0gc25hY2suaWQoKQogICAgcmV0dXJuIHdyYXBwZXIKICB9CgogIHNuYWNrLmV4dGVuZChzbmFjay53cmFwLCB7CiAgICBkZWZpbmU6IGZ1bmN0aW9uKG5hbWUsIGZuKXsKICAgICAgaWYgKHR5cGVvZiBuYW1lICE9ICdzdHJpbmcnKXsKICAgICAgICBmb3IgKHZhciBpIGluIG5hbWUpCiAgICAgICAgICBzbmFjay53cmFwLmRlZmluZShpLCBuYW1lW2ldKQogICAgICAgIHJldHVybgogICAgICB9CiAgICAgIHByb3RvW25hbWVdID0gZm4KICAgIH0sCgogICAgZGVmaW5lRW5naW5lOiBmdW5jdGlvbiAoZm4pewogICAgICBxdWVyeSA9IGZuCiAgICB9CiAgfSkKCiAgLy8gUVNBIGRlZmF1bHQgc2VsZWN0b3IgZW5naW5lLCBzdXBwb3J0cyByZWFsIGJyb3dzZXJzIGFuZCBJRTgrCiAgc25hY2sud3JhcC5kZWZpbmVFbmdpbmUoZnVuY3Rpb24gKHNlbGVjdG9yLCBjb250ZXh0KXsKICAgIGlmICh0eXBlb2YgY29udGV4dCA9PSAnc3RyaW5nJykKICAgICAgY29udGV4dCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoY29udGV4dCkKCiAgICByZXR1cm4gKGNvbnRleHQgfHwgZG9jdW1lbnQpLnF1ZXJ5U2VsZWN0b3JBbGwoc2VsZWN0b3IpCiAgfSkKfShzbmFjaywgZG9jdW1lbnQpCiFmdW5jdGlvbiAoc25hY2ssIHdpbmRvdywgZG9jdW1lbnQpewogIHZhciBhZGQgICAgICAgICAgICA9IGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIgPyAnYWRkRXZlbnRMaXN0ZW5lcicgOiAnYXR0YWNoRXZlbnQnCiAgICAsIHJlbW92ZSAgICAgICAgID0gZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lciA/ICdyZW1vdmVFdmVudExpc3RlbmVyJyA6ICdkZXRhY2hFdmVudCcKICAgICwgcHJlZml4ICAgICAgICAgPSBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyID8gJycgOiAnb24nCiAgICAsIHJlYWR5ICAgICAgICAgID0gZmFsc2UKICAgICwgdG9wICAgICAgICAgICAgPSB0cnVlCiAgICAsIHJvb3QgICAgICAgICAgID0gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50CiAgICAsIHJlYWR5SGFuZGxlcnMgID0gW10KCiAgc25hY2suZXh0ZW5kKHsKICAgIHN0b3BQcm9wYWdhdGlvbjogZnVuY3Rpb24gKGV2ZW50KXsKICAgICAgaWYgKGV2ZW50LnN0b3BQcm9wYWdhdGlvbikKICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKQogICAgICBlbHNlCiAgICAgICAgZXZlbnQuY2FuY2VsQnViYmxlID0gdHJ1ZQogICAgfSwKCiAgICBwcmV2ZW50RGVmYXVsdDogZnVuY3Rpb24gKGV2ZW50KXsKICAgICAgaWYgKGV2ZW50LnByZXZlbnREZWZhdWx0KQogICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCkKICAgICAgZWxzZQogICAgICAgIGV2ZW50LnJldHVyblZhbHVlID0gZmFsc2UKICAgIH0KICB9KQoKICBzbmFjay5saXN0ZW5lciA9IGZ1bmN0aW9uIChwYXJhbXMsIGhhbmRsZXIpewogICAgaWYgKHBhcmFtcy5kZWxlZ2F0ZSl7CiAgICAgIHBhcmFtcy5jYXB0dXJlID0gdHJ1ZQogICAgICBfaGFuZGxlciA9IGhhbmRsZXIKICAgICAgaGFuZGxlciA9IGZ1bmN0aW9uIChldmVudCl7CiAgICAgICAgLy8gYWRhcHRlZCBmcm9tIFplcHRvCiAgICAgICAgdmFyIHRhcmdldCA9IGV2ZW50LnRhcmdldCB8fCBldmVudC5zcmNFbGVtZW50CiAgICAgICAgICAsIG5vZGVzID0gdHlwZW9mIHBhcmFtcy5kZWxlZ2F0ZSA9PSAnc3RyaW5nJwogICAgICAgICAgICA/IHNuYWNrLndyYXAocGFyYW1zLmRlbGVnYXRlLCBwYXJhbXMubm9kZSkKICAgICAgICAgICAgOiBwYXJhbXMuZGVsZWdhdGUocGFyYW1zLm5vZGUpCgogICAgICAgIHdoaWxlICh0YXJnZXQgJiYgc25hY2suaW5kZXhPZih0YXJnZXQsIG5vZGVzKSA9PSAtMSApCiAgICAgICAgICB0YXJnZXQgPSB0YXJnZXQucGFyZW50Tm9kZQoKICAgICAgICBpZiAodGFyZ2V0ICYmICEodGFyZ2V0ID09PSB0aGlzKSAmJiAhKHRhcmdldCA9PT0gZG9jdW1lbnQpKQogICAgICAgICAgX2hhbmRsZXIuY2FsbCh0YXJnZXQsIGV2ZW50LCB0YXJnZXQpCiAgICAgIH0KICAgIH0KCiAgICBpZiAocGFyYW1zLmNvbnRleHQpCiAgICAgIGhhbmRsZXIgPSBzbmFjay5iaW5kKGhhbmRsZXIsIHBhcmFtcy5jb250ZXh0KQoKICAgIHZhciBtZXRob2RzID0gewogICAgICBhdHRhY2g6IGZ1bmN0aW9uICgpewogICAgICAgIHBhcmFtcy5ub2RlW2FkZF0oCiAgICAgICAgICBwcmVmaXggKyBwYXJhbXMuZXZlbnQsCiAgICAgICAgICBoYW5kbGVyLAogICAgICAgICAgcGFyYW1zLmNhcHR1cmUKICAgICAgICApCiAgICAgIH0sCgogICAgICBkZXRhY2g6IGZ1bmN0aW9uICgpewogICAgICAgIHBhcmFtcy5ub2RlW3JlbW92ZV0oCiAgICAgICAgICBwcmVmaXggKyBwYXJhbXMuZXZlbnQsCiAgICAgICAgICBoYW5kbGVyLAogICAgICAgICAgcGFyYW1zLmNhcHR1cmUKICAgICAgICApCiAgICAgIH0sCgogICAgICBmaXJlOiBmdW5jdGlvbiAoKXsKICAgICAgICBoYW5kbGVyLmFwcGx5KHBhcmFtcy5ub2RlLCBhcmd1bWVudHMpCiAgICAgIH0KICAgIH0KCiAgICBtZXRob2RzLmF0dGFjaCgpCgogICAgcmV0dXJuIG1ldGhvZHMKICB9CgoKCgogIHNuYWNrLnJlYWR5ID0gZnVuY3Rpb24gKGhhbmRsZXIpewogICAgaWYgKHJlYWR5KXsKICAgICAgaGFuZGxlci5hcHBseShkb2N1bWVudCkKICAgICAgcmV0dXJuCiAgICB9CiAgICByZWFkeUhhbmRsZXJzLnB1c2goaGFuZGxlcikKICB9CgogIC8vIGFkYXB0ZWQgZnJvbSBjb250ZW50bG9hZGVkCiAgZnVuY3Rpb24gaW5pdChlKSB7CiAgICBpZiAoZS50eXBlID09ICdyZWFkeXN0YXRlY2hhbmdlJyAmJiBkb2N1bWVudC5yZWFkeVN0YXRlICE9ICdjb21wbGV0ZScpCiAgICAgIHJldHVybgoKICAgIChlLnR5cGUgPT0gJ2xvYWQnID8gd2luZG93IDogZG9jdW1lbnQpW3JlbW92ZV0ocHJlZml4ICsgZS50eXBlLCBpbml0LCBmYWxzZSkKCiAgICBpZiAoIXJlYWR5ICYmIChyZWFkeSA9IHRydWUpKQogICAgICBzbmFjay5lYWNoKHJlYWR5SGFuZGxlcnMsIGZ1bmN0aW9uIChoYW5kbGVyKXsKICAgICAgICBoYW5kbGVyLmFwcGx5KGRvY3VtZW50KQogICAgICB9KQogIH0KCiAgZnVuY3Rpb24gcG9sbCgpIHsKICAgIHRyeSB7CiAgICAgIHJvb3QuZG9TY3JvbGwoJ2xlZnQnKQogICAgfSBjYXRjaChlKSB7IAogICAgICBzZXRUaW1lb3V0KHBvbGwsIDUwKQogICAgICByZXR1cm4KICAgIH0KICAgIGluaXQoJ3BvbGwnKQogIH0KCiAgaWYgKGRvY3VtZW50LmNyZWF0ZUV2ZW50T2JqZWN0ICYmIHJvb3QuZG9TY3JvbGwpIHsKICAgIHRyeSB7CiAgICAgIHRvcCA9ICF3aW5kb3cuZnJhbWVFbGVtZW50CiAgICB9IGNhdGNoKGUpIHt9CiAgICBpZiAodG9wKQogICAgICBwb2xsKCk7CiAgfQoKICBkb2N1bWVudFthZGRdKHByZWZpeCArICdET01Db250ZW50TG9hZGVkJywgaW5pdCwgZmFsc2UpCiAgZG9jdW1lbnRbYWRkXShwcmVmaXggKyAncmVhZHlzdGF0ZWNoYW5nZScsIGluaXQsIGZhbHNlKQogIHdpbmRvd1thZGRdKHByZWZpeCArICdsb2FkJywgaW5pdCwgZmFsc2UpCn0oc25hY2ssIHdpbmRvdywgZG9jdW1lbnQpOwohZnVuY3Rpb24gKHNuYWNrKXsKICBzbmFjay5wdWJsaXNoZXIgPSBmdW5jdGlvbiAob2JqKXsKICAgIHZhciBjaGFubmVscyA9IHt9CiAgICBvYmogPSBvYmogfHwge30KCiAgICBzbmFjay5leHRlbmQob2JqLCB7CiAgICAgIHN1YnNjcmliZTogZnVuY3Rpb24gKGNoYW5uZWwsIGhhbmRsZXIsIGNvbnRleHQpewogICAgICAgIHZhciBzdWJzY3JpcHRpb24gPSB7CiAgICAgICAgICBmbjogaGFuZGxlciwKICAgICAgICAgIGN0eHQ6IChjb250ZXh0IHx8IHt9KQogICAgICAgIH0KCiAgICAgICAgaWYgKCFjaGFubmVsc1tjaGFubmVsXSkKICAgICAgICAgIGNoYW5uZWxzW2NoYW5uZWxdID0gW10KCiAgICAgICAgdmFyIHB1YmxpayA9IHsKICAgICAgICAgIGF0dGFjaDogZnVuY3Rpb24gKCl7CiAgICAgICAgICAgIGNoYW5uZWxzW2NoYW5uZWxdLnB1c2goc3Vic2NyaXB0aW9uKQogICAgICAgICAgfSwKICAgICAgICAgIGRldGFjaDogZnVuY3Rpb24gKCl7CiAgICAgICAgICAgIGNoYW5uZWxzW2NoYW5uZWxdLnNwbGljZShzbmFjay5pbmRleE9mKGhhbmRsZXIsIGNoYW5uZWxzW2NoYW5uZWxdKSwgMSkKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcHVibGlrLmF0dGFjaCgpCiAgICAgICAgcmV0dXJuIHB1YmxpawogICAgICB9LAoKICAgICAgcHVibGlzaDogZnVuY3Rpb24gKGNoYW5uZWwsIGFyZ3NBcnJheSl7CiAgICAgICAgaWYgKCFjaGFubmVsc1tjaGFubmVsXSkKICAgICAgICAgIHJldHVybiBmYWxzZQoKICAgICAgICBzbmFjay5lYWNoKGNoYW5uZWxzW2NoYW5uZWxdLCBmdW5jdGlvbiAoc3Vic2NyaXB0aW9uKXsKICAgICAgICAgIHN1YnNjcmlwdGlvbi5mbi5hcHBseShzdWJzY3JpcHRpb24uY3R4dCwgYXJnc0FycmF5IHx8IFtdKQogICAgICAgIH0pCgogICAgICAgIHJldHVybiBjaGFubmVsc1tjaGFubmVsXS5sZW5ndGgKICAgICAgfQogICAgfSkKCiAgICByZXR1cm4gb2JqCiAgfQoKICBzbmFjay5wdWJsaXNoZXIoc25hY2spCn0oc25hY2spOwohZnVuY3Rpb24oc25hY2ssIHdpbmRvdywgZG9jdW1lbnQpewogIHNuYWNrLkpTT05QID0gZnVuY3Rpb24ocGFyYW1zLCBjYWxsYmFjayl7CiAgICAvLyBhZGFwdGVkIGZyb20gWmVwdG8KICAgIHZhciBqc29ucFN0cmluZyA9ICdqc29ucCcgKyBzbmFjay5pZCgpCiAgICAgICwgc2NyaXB0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc2NyaXB0JykKICAgICAgLCBydW5uaW5nID0gZmFsc2UKCiAgICAgIHNuYWNrLkpTT05QW2pzb25wU3RyaW5nXSA9IGZ1bmN0aW9uKGRhdGEpewogICAgICAgIHJ1bm5pbmcgPSBmYWxzZQogICAgICAgIGRlbGV0ZSBzbmFjay5KU09OUFtqc29ucFN0cmluZ10KICAgICAgICBjYWxsYmFjayhkYXRhKQogICAgICB9CgogICAgICBpZiAodHlwZW9mIHBhcmFtcy5kYXRhID09ICdvYmplY3QnKQogICAgICAgIHBhcmFtcy5kYXRhID0gc25hY2sudG9RdWVyeVN0cmluZyhwYXJhbXMuZGF0YSkKCiAgICB2YXIgcHVibGlrID0gewogICAgICBzZW5kOiBmdW5jdGlvbiAoKXsKICAgICAgICBydW5uaW5nID0gdHJ1ZQogICAgICAgIHNjcmlwdC5zcmMgPSBwYXJhbXMudXJsICsgJz8nICsgcGFyYW1zLmtleSArICc9c25hY2suSlNPTlAuJyArIGpzb25wU3RyaW5nICsgJyYnICsgcGFyYW1zLmRhdGEKICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgnaGVhZCcpWzBdLmFwcGVuZENoaWxkKHNjcmlwdCkKICAgICAgfSwKCiAgICAgIGNhbmNlbDogZnVuY3Rpb24gKCl7CiAgICAgICAgcnVubmluZyAmJiBzY3JpcHQucGFyZW50Tm9kZSAmJiBzY3JpcHQucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChzY3JpcHQpCiAgICAgICAgcnVubmluZyA9IGZhbHNlCiAgICAgICAgc25hY2suSlNPTlBbanNvbnBTdHJpbmddID0gZnVuY3Rpb24gKCl7CiAgICAgICAgICBkZWxldGUgc25hY2suSlNPTlBbanNvbnBTdHJpbmddCiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgaWYgKHBhcmFtcy5ub3cgIT09IGZhbHNlKQogICAgICBwdWJsaWsuc2VuZCgpCgogICAgcmV0dXJuIHB1YmxpawogIH0KCiAgc25hY2sudG9RdWVyeVN0cmluZyA9IGZ1bmN0aW9uKG9iamVjdCwgYmFzZSl7CiAgICAvLyBhZGFwdGVkIGZyb20gTW9vVG9vbHMKICAgIHZhciBxdWVyeVN0cmluZyA9IFtdCgogICAgc25hY2suZWFjaChvYmplY3QsIGZ1bmN0aW9uKHZhbHVlLCBrZXkpewogICAgICBpZiAoYmFzZSkKICAgICAgICBrZXkgPSBiYXNlICsgJ1snICsga2V5ICsgJ10nCgogICAgICB2YXIgcmVzdWx0CgogICAgICBpZiAoc25hY2suaXNBcnJheSh2YWx1ZSkpewogICAgICAgIHZhciBxcyA9IHt9CiAgICAgICAgc25hY2suZWFjaCh2YWx1ZSwgZnVuY3Rpb24odmFsLCBpKXsKICAgICAgICAgIHFzW2ldID0gdmFsCiAgICAgICAgfSkKICAgICAgICByZXN1bHQgPSBzbmFjay50b1F1ZXJ5U3RyaW5nKHFzLCBrZXkpCiAgICAgIH0KICAgICAgZWxzZSBpZiAodHlwZW9mIHZhbHVlID09ICdvYmplY3QnKQogICAgICAgIHJlc3VsdCA9IHNuYWNrLnRvUXVlcnlTdHJpbmcodmFsdWUsIGtleSkKICAgICAgZWxzZQogICAgICAgIHJlc3VsdCA9IGtleSArICc9JyArIGVuY29kZVVSSUNvbXBvbmVudCh2YWx1ZSkKCiAgICAgIGlmICh2YWx1ZSAhPT0gbnVsbCkKICAgICAgICBxdWVyeVN0cmluZy5wdXNoKHJlc3VsdCkKICAgIH0pCgogICAgcmV0dXJuIHF1ZXJ5U3RyaW5nLmpvaW4oJyYnKQogIH0KCiAgdmFyIHhock9iamVjdCA9IChmdW5jdGlvbigpewogICAgLy8gYWRhcHRlZCBmcm9tIE1vb1Rvb2xzCiAgICB2YXIgWE1MSFRUUCA9IGZ1bmN0aW9uKCl7CiAgICAgIHJldHVybiBuZXcgWE1MSHR0cFJlcXVlc3QoKTsKICAgIH0KCiAgICB2YXIgTVNYTUwyID0gZnVuY3Rpb24oKXsKICAgICAgcmV0dXJuIG5ldyBBY3RpdmVYT2JqZWN0KCdNU1hNTDIuWE1MSFRUUCcpOwogICAgfQoKICAgIHZhciBNU1hNTCA9IGZ1bmN0aW9uKCl7CiAgICAgIHJldHVybiBuZXcgQWN0aXZlWE9iamVjdCgnTWljcm9zb2Z0LlhNTEhUVFAnKTsKICAgIH0KCiAgICB0cnkgewogICAgICBYTUxIVFRQKCkKICAgICAgcmV0dXJuIFhNTEhUVFAKICAgIH0gY2F0Y2ggKGUpewogICAgICB0cnkgewogICAgICAgIE1TWE1MMigpCiAgICAgICAgcmV0dXJuIE1TWE1MMgogICAgICB9IGNhdGNoIChlKXsKICAgICAgICBNU1hNTCgpCiAgICAgICAgcmV0dXJuIE1TWE1MCiAgICAgIH0KICAgIH0KICB9KSgpOwoKICBmdW5jdGlvbiBlbXB0eSgpe30KCiAgc25hY2sucmVxdWVzdCA9IGZ1bmN0aW9uIChvcHRpb25zLCBjYWxsYmFjayl7CiAgICAvLyBhZGFwdGVkIGZyb20gTW9vVG9vbHMKICAgIGlmICghKHRoaXMgaW5zdGFuY2VvZiBzbmFjay5yZXF1ZXN0KSkKICAgICAgcmV0dXJuIG5ldyBzbmFjay5yZXF1ZXN0KG9wdGlvbnMsIGNhbGxiYWNrKQoKICAgIHZhciBzZWxmID0gdGhpcwogICAgc2VsZi5vcHRpb25zID0gc25hY2suZXh0ZW5kKHt9LCBzZWxmLm9wdGlvbnMsIG9wdGlvbnMpCiAgICBzZWxmLmNhbGxiYWNrID0gY2FsbGJhY2sKICAgIHNlbGYueGhyID0gbmV3IHhock9iamVjdAogICAgc2VsZi5oZWFkZXJzID0gc2VsZi5vcHRpb25zLmhlYWRlcnMKICAgIGlmIChzZWxmLm9wdGlvbnMubm93ICE9PSBmYWxzZSkKICAgICAgc2VsZi5zZW5kKCkKICB9CgogIHNuYWNrLnJlcXVlc3QucHJvdG90eXBlID0gewoKICAgIG9wdGlvbnM6IHsvKgogICAgICB1c2VyOiAnJywKICAgICAgcGFzc3dvcmQ6ICcnLCovCiAgICAgIGV4Y2VwdGlvbjogZW1wdHksCiAgICAgIHVybDogJycsCiAgICAgIGRhdGE6ICcnLAogICAgICBtZXRob2Q6ICdnZXQnLAogICAgICBub3c6IHRydWUsCiAgICAgIGhlYWRlcnM6IHsKICAgICAgICAnWC1SZXF1ZXN0ZWQtV2l0aCc6ICdYTUxIdHRwUmVxdWVzdCcsCiAgICAgICAgJ0FjY2VwdCc6ICd0ZXh0L2phdmFzY3JpcHQsIHRleHQvaHRtbCwgYXBwbGljYXRpb24veG1sLCB0ZXh0L3htbCwgKi8qJwogICAgICB9LAogICAgICBhc3luYzogdHJ1ZSwKICAgICAgZW11bGF0aW9uOiB0cnVlLAogICAgICB1cmxFbmNvZGVkOiB0cnVlLAogICAgICBlbmNvZGluZzogJ3V0Zi04JwogICAgfSwKCiAgICBvblN0YXRlQ2hhbmdlOiBmdW5jdGlvbigpewogICAgICB2YXIgc2VsZiA9IHRoaXMKICAgICAgICAsIHhociA9IHNlbGYueGhyCgogICAgICBpZiAoeGhyLnJlYWR5U3RhdGUgIT0gNCB8fCAhc2VsZi5ydW5uaW5nKSByZXR1cm4KICAgICAgc2VsZi5ydW5uaW5nID0gZmFsc2UKICAgICAgc2VsZi5zdGF0dXMgPSAwCgogICAgICB0cnl7CiAgICAgICAgdmFyIHN0YXR1cyA9IHhoci5zdGF0dXMKICAgICAgICBzZWxmLnN0YXR1cyA9IChzdGF0dXMgPT0gMTIyMykgPyAyMDQgOiBzdGF0dXMKICAgICAgfSBjYXRjaChlKSB7fQoKICAgICAgeGhyLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGVtcHR5OwoKICAgICAgdmFyIGFyZ3MgPSBzZWxmLnN0YXR1cyA+PSAyMDAgJiYgc2VsZi5zdGF0dXMgPCAzMDAKICAgICAgICA/IFtmYWxzZSwgc2VsZi54aHIucmVzcG9uc2VUZXh0IHx8ICcnLCBzZWxmLnhoci5yZXNwb25zZVhNTF0KICAgICAgICA6IFtzZWxmLnN0YXR1c10KCiAgICAgIHNlbGYuY2FsbGJhY2suYXBwbHkoc2VsZiwgYXJncykKICAgIH0sCiAgCiAgICBzZXRIZWFkZXI6IGZ1bmN0aW9uKG5hbWUsIHZhbHVlKXsKICAgICAgdGhpcy5oZWFkZXJzW25hbWVdID0gdmFsdWU7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICBnZXRIZWFkZXI6IGZ1bmN0aW9uKG5hbWUpewogICAgICB0cnkgewogICAgICAgIHJldHVybiB0aGlzLnhoci5nZXRSZXNwb25zZUhlYWRlcihuYW1lKQogICAgICB9IGNhdGNoKGUpIHsKICAgICAgICByZXR1cm4gbnVsbAogICAgICB9CiAgICB9LAogIAogICAgc2VuZDogZnVuY3Rpb24oKXsKICAgICAgdmFyIHNlbGYgPSB0aGlzCiAgICAgICAgLCBvcHRpb25zID0gc2VsZi5vcHRpb25zCgogICAgICBpZiAoc2VsZi5ydW5uaW5nKSByZXR1cm4gc2VsZjsKCiAgICAgIHNlbGYucnVubmluZyA9IHRydWU7CgogICAgICB2YXIgZGF0YSA9IG9wdGlvbnMuZGF0YSB8fCAnJwogICAgICAgICwgdXJsID0gU3RyaW5nKG9wdGlvbnMudXJsKQogICAgICAgICwgbWV0aG9kID0gb3B0aW9ucy5tZXRob2QudG9Mb3dlckNhc2UoKQoKICAgICAgaWYgKHR5cGVvZiBkYXRhICE9ICdzdHJpbmcnKQogICAgICAgIGRhdGEgPSBzbmFjay50b1F1ZXJ5U3RyaW5nKGRhdGEpCgogICAgICBpZiAob3B0aW9ucy5lbXVsYXRpb24gJiYgc25hY2suaW5kZXhPZihtZXRob2QsIFsnZ2V0JywgJ3Bvc3QnXSkgPCAwKXsKICAgICAgICB2YXIgX21ldGhvZCA9ICdfbWV0aG9kPScgKyBtZXRob2QKICAgICAgICBkYXRhID0gKGRhdGEpID8gX21ldGhvZCArICcmJyArIGRhdGEgOiBfbWV0aG9kCiAgICAgICAgbWV0aG9kID0gJ3Bvc3QnCiAgICAgIH0KCiAgICAgIGlmIChvcHRpb25zLnVybEVuY29kZWQgJiYgc25hY2suaW5kZXhPZihtZXRob2QsIFsncG9zdCcsICdwdXQnXSkgPiAtMSl7CiAgICAgICAgdmFyIGVuY29kaW5nID0gKG9wdGlvbnMuZW5jb2RpbmcpID8gJzsgY2hhcnNldD0nICsgb3B0aW9ucy5lbmNvZGluZyA6ICcnCiAgICAgICAgc2VsZi5oZWFkZXJzWydDb250ZW50LXR5cGUnXSA9ICdhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWQnICsgZW5jb2RpbmcKICAgICAgfQoKICAgICAgaWYgKCF1cmwpCiAgICAgICAgdXJsID0gZG9jdW1lbnQubG9jYXRpb24ucGF0aG5hbWUKCiAgICAgIHZhciB0cmltUG9zaXRpb24gPSB1cmwubGFzdEluZGV4T2YoJy8nKQogICAgICBpZiAodHJpbVBvc2l0aW9uID4gLTEgJiYgKHRyaW1Qb3NpdGlvbiA9IHVybC5pbmRleE9mKCcjJykpID4gLTEpCiAgICAgICAgdXJsID0gdXJsLnN1YnN0cigwLCB0cmltUG9zaXRpb24pCgogICAgICBpZiAoZGF0YSAmJiBtZXRob2QgPT0gJ2dldCcpewogICAgICAgIHVybCArPSAodXJsLmluZGV4T2YoJz8nKSA+IC0xID8gJyYnIDogJz8nKSArIGRhdGEKICAgICAgICBkYXRhID0gbnVsbAogICAgICB9CgogICAgICB2YXIgeGhyID0gc2VsZi54aHIKCiAgICAgIHhoci5vcGVuKG1ldGhvZC50b1VwcGVyQ2FzZSgpLCB1cmwsIG9wZW4uYXN5bmMsIG9wdGlvbnMudXNlciwgb3B0aW9ucy5wYXNzd29yZCkKICAgICAgaWYgKG9wdGlvbnMudXNlciAmJiAnd2l0aENyZWRlbnRpYWxzJyBpbiB4aHIpIHhoci53aXRoQ3JlZGVudGlhbHMgPSB0cnVlCiAgICAKICAgICAgeGhyLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IHNuYWNrLmJpbmQoc2VsZi5vblN0YXRlQ2hhbmdlLCBzZWxmKQoKICAgICAgZm9yICh2YXIgaSBpbiBzZWxmLmhlYWRlcnMpewogICAgICAgIHRyeSB7CiAgICAgICAgICB4aHIuc2V0UmVxdWVzdEhlYWRlcihpLCBzZWxmLmhlYWRlcnNbaV0pCiAgICAgICAgfSBjYXRjaCAoZSl7CiAgICAgICAgICBvcHRpb25zLmV4Y2VwdGlvbi5hcHBseShzZWxmLCBbaSwgc2VsZi5oZWFkZXJzW2ldXSkKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHhoci5zZW5kKGRhdGEpCiAgICAgIGlmICghb3B0aW9ucy5hc3luYykgc2VsZi5vblN0YXRlQ2hhbmdlKCkKICAgIAogICAgICByZXR1cm4gc2VsZgogICAgfSwKCiAgICBjYW5jZWw6IGZ1bmN0aW9uKCl7CiAgICAgIHZhciBzZWxmID0gdGhpcwoKICAgICAgaWYgKCFzZWxmLnJ1bm5pbmcpCiAgICAgICAgcmV0dXJuIHNlbGYKCiAgICAgIHNlbGYucnVubmluZyA9IGZhbHNlCgogICAgICB2YXIgeGhyID0gc2VsZi54aHIKICAgICAgeGhyLmFib3J0KCkKCiAgICAgIHhoci5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBlbXB0eQoKICAgICAgc2VsZi54aHIgPSBuZXcgeGhyT2JqZWN0KCkKICAgICAgcmV0dXJuIHNlbGYKICAgIH0KICB9Cn0oc25hY2ssIHdpbmRvdywgZG9jdW1lbnQpCiFmdW5jdGlvbihzbmFjaywgZG9jdW1lbnQpewogIHNuYWNrLndyYXAuZGVmaW5lKHsKICAgIGRhdGE6IGZ1bmN0aW9uICgpewogICAgICAvLyBBUEkgaW5zcGlyZWQgYnkgalF1ZXJ5CiAgICAgIHZhciBzdG9yYWdlID0ge30KCiAgICAgIHJldHVybiBmdW5jdGlvbiAoa2V5LCB2YWx1ZSl7CiAgICAgICAgdmFyIGRhdGEgPSBzdG9yYWdlW3RoaXMuaWRdCgogICAgICAgIGlmICghZGF0YSkKICAgICAgICAgIGRhdGEgPSBzdG9yYWdlW3RoaXMuaWRdID0ge30KCiAgICAgICAgaWYgKHZhbHVlID09PSB2b2lkKzEpCiAgICAgICAgICByZXR1cm4gZGF0YVtrZXldCgogICAgICAgIHJldHVybiBkYXRhW2tleV0gPSB2YWx1ZQogICAgICB9ICAKICAgIH0oKSwKCiAgICBlYWNoOiBmdW5jdGlvbiAoZm4sIGNvbnRleHQpewogICAgICByZXR1cm4gc25hY2suZWFjaCh0aGlzLCBmbiwgY29udGV4dCkKICAgIH0sCiAgCiAgICBhZGRDbGFzczogZnVuY3Rpb24gKGNsYXNzTmFtZSl7CiAgICAgIC8vIGFkYXB0ZWQgZnJvbSBNb29Ub29scwogICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uIChlbGVtZW50KXsKICAgICAgICBpZiAoY2xlYW4oZWxlbWVudC5jbGFzc05hbWUpLmluZGV4T2YoY2xhc3NOYW1lKSA+IC0xKQogICAgICAgICAgcmV0dXJuCiAgICAgICAgZWxlbWVudC5jbGFzc05hbWUgPSBjbGVhbihlbGVtZW50LmNsYXNzTmFtZSArICcgJyArIGNsYXNzTmFtZSkKICAgICAgfSkKICAgIH0sCgogICAgcmVtb3ZlQ2xhc3M6IGZ1bmN0aW9uIChjbGFzc05hbWUpewogICAgICAvLyBhZGFwdGVkIGZyb20gTW9vVG9vbHMKICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoZWxlbWVudCl7CiAgICAgICAgZWxlbWVudC5jbGFzc05hbWUgPSBlbGVtZW50LmNsYXNzTmFtZS5yZXBsYWNlKG5ldyBSZWdFeHAoJyhefFxccyknICsgY2xhc3NOYW1lICsgJyg/Olxcc3wkKScpLCAnJDEnKQogICAgICB9KQogICAgfSwKCiAgICBhdHRhY2g6IGZ1bmN0aW9uIChldmVudCwgaGFuZGxlciwgLyogaW50ZXJuYWwgKi8gZGVsZWdhdGlvbil7CiAgICAgIHZhciBzcGxpdCA9IGV2ZW50LnNwbGl0KCcuJykKICAgICAgICAsIGxpc3RlbmVycyA9IFtdCgogICAgICBpZiAoc3BsaXRbMV0pCiAgICAgICAgbGlzdGVuZXJzID0gdGhpcy5kYXRhKHNwbGl0WzFdKSB8fCBbXQoKICAgICAgdGhpcy5lYWNoKGZ1bmN0aW9uKG5vZGUpewogICAgICAgIHZhciBwYXJhbXMgPSB7CiAgICAgICAgICBub2RlOiBub2RlLAogICAgICAgICAgZXZlbnQ6IHNwbGl0WzBdCiAgICAgICAgfQoKICAgICAgICBpZiAoZGVsZWdhdGlvbikKICAgICAgICAgIHBhcmFtcy5kZWxlZ2F0ZSA9IGRlbGVnYXRpb24KCiAgICAgICAgbGlzdGVuZXJzLnB1c2goc25hY2subGlzdGVuZXIocGFyYW1zLCBoYW5kbGVyKSkKICAgICAgfSkKCiAgICAgIGlmIChzcGxpdFsxXSkKICAgICAgICB0aGlzLmRhdGEoc3BsaXRbMV0sIGxpc3RlbmVycykKCiAgICAgIHJldHVybiB0aGlzCiAgICB9LAoKICAgIGRldGFjaDogZnVuY3Rpb24gKG5hbWVzcGFjZSl7CiAgICAgIGxpc3RlbmVyTWV0aG9kKHRoaXMsICdkZXRhY2gnLCBuYW1lc3BhY2UsIG51bGwsIHRydWUpCiAgICAgIHRoaXMuZGF0YShuYW1lc3BhY2UsIG51bGwpCiAgICAgIHJldHVybiB0aGlzCiAgICB9LAoKICAgIGZpcmU6IGZ1bmN0aW9uIChuYW1lc3BhY2UsIGFyZ3MpewogICAgICByZXR1cm4gbGlzdGVuZXJNZXRob2QodGhpcywgJ2ZpcmUnLCBuYW1lc3BhY2UsIGFyZ3MpCiAgICB9LAoKICAgIGRlbGVnYXRlOiBmdW5jdGlvbiAoZXZlbnQsIGRlbGVnYXRpb24sIGhhbmRsZXIpewogICAgICByZXR1cm4gdGhpcy5hdHRhY2goZXZlbnQsIGhhbmRsZXIsIGRlbGVnYXRpb24pCiAgICB9CiAgfSkKCiAgZnVuY3Rpb24gY2xlYW4oc3RyKXsKICAgIHJldHVybiBzdHIucmVwbGFjZSgvXHMrL2csICcgJykucmVwbGFjZSgvXlxzK3xccyskL2csICcnKQogIH0KCiAgZnVuY3Rpb24gbGlzdGVuZXJNZXRob2Qod3JhcHBlciwgbWV0aG9kLCBuYW1lc3BhY2UsIGFyZ3MpewogICAgdmFyIGRhdGEgPSB3cmFwcGVyLmRhdGEobmFtZXNwYWNlKQoKICAgIGlmIChkYXRhKQogICAgICBzbmFjay5lYWNoKGRhdGEsIGZ1bmN0aW9uIChsaXN0ZW5lcil7CiAgICAgICAgbGlzdGVuZXJbbWV0aG9kXS5hcHBseSh3cmFwcGVyLCBhcmdzKQogICAgICB9KQoKICAgIHJldHVybiB3cmFwcGVyCiAgfQp9KHNuYWNrLCBkb2N1bWVudCk7Ci8qCi0tLQpuYW1lOiBTbGljay5QYXJzZXIKZGVzY3JpcHRpb246IFN0YW5kYWxvbmUgQ1NTMyBTZWxlY3RvciBwYXJzZXIKcHJvdmlkZXM6IFNsaWNrLlBhcnNlcgouLi4KKi8KCjsoZnVuY3Rpb24oKXsKCnZhciBwYXJzZWQsCglzZXBhcmF0b3JJbmRleCwKCWNvbWJpbmF0b3JJbmRleCwKCXJldmVyc2VkLAoJY2FjaGUgPSB7fSwKCXJldmVyc2VDYWNoZSA9IHt9LAoJcmVVbmVzY2FwZSA9IC9cXC9nOwoKdmFyIHBhcnNlID0gZnVuY3Rpb24oZXhwcmVzc2lvbiwgaXNSZXZlcnNlZCl7CglpZiAoZXhwcmVzc2lvbiA9PSBudWxsKSByZXR1cm4gbnVsbDsKCWlmIChleHByZXNzaW9uLlNsaWNrID09PSB0cnVlKSByZXR1cm4gZXhwcmVzc2lvbjsKCWV4cHJlc3Npb24gPSAoJycgKyBleHByZXNzaW9uKS5yZXBsYWNlKC9eXHMrfFxzKyQvZywgJycpOwoJcmV2ZXJzZWQgPSAhIWlzUmV2ZXJzZWQ7Cgl2YXIgY3VycmVudENhY2hlID0gKHJldmVyc2VkKSA/IHJldmVyc2VDYWNoZSA6IGNhY2hlOwoJaWYgKGN1cnJlbnRDYWNoZVtleHByZXNzaW9uXSkgcmV0dXJuIGN1cnJlbnRDYWNoZVtleHByZXNzaW9uXTsKCXBhcnNlZCA9IHsKCQlTbGljazogdHJ1ZSwKCQlleHByZXNzaW9uczogW10sCgkJcmF3OiBleHByZXNzaW9uLAoJCXJldmVyc2U6IGZ1bmN0aW9uKCl7CgkJCXJldHVybiBwYXJzZSh0aGlzLnJhdywgdHJ1ZSk7CgkJfQoJfTsKCXNlcGFyYXRvckluZGV4ID0gLTE7Cgl3aGlsZSAoZXhwcmVzc2lvbiAhPSAoZXhwcmVzc2lvbiA9IGV4cHJlc3Npb24ucmVwbGFjZShyZWdleHAsIHBhcnNlcikpKTsKCXBhcnNlZC5sZW5ndGggPSBwYXJzZWQuZXhwcmVzc2lvbnMubGVuZ3RoOwoJcmV0dXJuIGN1cnJlbnRDYWNoZVtwYXJzZWQucmF3XSA9IChyZXZlcnNlZCkgPyByZXZlcnNlKHBhcnNlZCkgOiBwYXJzZWQ7Cn07Cgp2YXIgcmV2ZXJzZUNvbWJpbmF0b3IgPSBmdW5jdGlvbihjb21iaW5hdG9yKXsKCWlmIChjb21iaW5hdG9yID09PSAnIScpIHJldHVybiAnICc7CgllbHNlIGlmIChjb21iaW5hdG9yID09PSAnICcpIHJldHVybiAnISc7CgllbHNlIGlmICgoL14hLykudGVzdChjb21iaW5hdG9yKSkgcmV0dXJuIGNvbWJpbmF0b3IucmVwbGFjZSgvXiEvLCAnJyk7CgllbHNlIHJldHVybiAnIScgKyBjb21iaW5hdG9yOwp9OwoKdmFyIHJldmVyc2UgPSBmdW5jdGlvbihleHByZXNzaW9uKXsKCXZhciBleHByZXNzaW9ucyA9IGV4cHJlc3Npb24uZXhwcmVzc2lvbnM7Cglmb3IgKHZhciBpID0gMDsgaSA8IGV4cHJlc3Npb25zLmxlbmd0aDsgaSsrKXsKCQl2YXIgZXhwID0gZXhwcmVzc2lvbnNbaV07CgkJdmFyIGxhc3QgPSB7cGFydHM6IFtdLCB0YWc6ICcqJywgY29tYmluYXRvcjogcmV2ZXJzZUNvbWJpbmF0b3IoZXhwWzBdLmNvbWJpbmF0b3IpfTsKCgkJZm9yICh2YXIgaiA9IDA7IGogPCBleHAubGVuZ3RoOyBqKyspewoJCQl2YXIgY2V4cCA9IGV4cFtqXTsKCQkJaWYgKCFjZXhwLnJldmVyc2VDb21iaW5hdG9yKSBjZXhwLnJldmVyc2VDb21iaW5hdG9yID0gJyAnOwoJCQljZXhwLmNvbWJpbmF0b3IgPSBjZXhwLnJldmVyc2VDb21iaW5hdG9yOwoJCQlkZWxldGUgY2V4cC5yZXZlcnNlQ29tYmluYXRvcjsKCQl9CgoJCWV4cC5yZXZlcnNlKCkucHVzaChsYXN0KTsKCX0KCXJldHVybiBleHByZXNzaW9uOwp9OwoKdmFyIGVzY2FwZVJlZ0V4cCA9IGZ1bmN0aW9uKHN0cmluZyl7Ly8gQ3JlZGl0OiBYUmVnRXhwIDAuNi4xIChjKSAyMDA3LTIwMDggU3RldmVuIExldml0aGFuIDxodHRwOi8vc3RldmVubGV2aXRoYW4uY29tL3JlZ2V4L3hyZWdleHAvPiBNSVQgTGljZW5zZQoJcmV0dXJuIHN0cmluZy5yZXBsYWNlKC9bLVtcXXt9KCkqKz8uXFxeJHwsI1xzXS9nLCBmdW5jdGlvbihtYXRjaCl7CgkJcmV0dXJuICdcXCcgKyBtYXRjaDsKCX0pOwp9OwoKdmFyIHJlZ2V4cCA9IG5ldyBSZWdFeHAoCi8qCiMhL3Vzci9iaW4vZW52IHJ1YnkKcHV0cyAiXHRcdCIgKyBEQVRBLnJlYWQuZ3N1YigvXChcP3hcKXxccysjLiokfFxzK3xcXCR8XFxuLywnJykKX19FTkRfXwoJIig/eCleKD86XAoJICBcXHMqICggLCApIFxccyogICAgICAgICAgICAgICAjIFNlcGFyYXRvciAgICAgICAgICBcblwKCXwgXFxzKiAoIDxjb21iaW5hdG9yPisgKSBcXHMqICAgIyBDb21iaW5hdG9yICAgICAgICAgXG5cCgl8ICAgICAgKCBcXHMrICkgICAgICAgICAgICAgICAgICMgQ29tYmluYXRvckNoaWxkcmVuIFxuXAoJfCAgICAgICggPHVuaWNvZGU+KyB8IFxcKiApICAgICAjIFRhZyAgICAgICAgICAgICAgICBcblwKCXwgXFwjICAoIDx1bmljb2RlPisgICAgICAgKSAgICAgIyBJRCAgICAgICAgICAgICAgICAgXG5cCgl8IFxcLiAgKCA8dW5pY29kZT4rICAgICAgICkgICAgICMgQ2xhc3NOYW1lICAgICAgICAgIFxuXAoJfCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAjIEF0dHJpYnV0ZSAgICAgICAgICBcblwKCVxcWyAgXAoJCVxccyogKDx1bmljb2RlMT4rKSAgKD86ICBcCgkJCVxccyogKFsqXiQhfnxdPz0pICAoPzogIFwKCQkJCVxccyogKD86XAoJCQkJCShbXCInXT8pKC4qPylcXDkgXAoJCQkJKVwKCQkJKSAgXAoJCSk/ICBcXHMqICBcCglcXF0oPyFcXF0pIFxuXAoJfCAgIDorICggPHVuaWNvZGU+KyApKD86XAoJXFwoICg/OlwKCQkoPzooW1wiJ10pKFteXFwxMl0qKVxcMTIpfCgoPzpcXChbXildK1xcKXxbXigpXSopKylcCgkpIFxcKVwKCSk/XAoJKSIKKi8KCSJeKD86XFxzKigsKVxccyp8XFxzKig8Y29tYmluYXRvcj4rKVxccyp8KFxccyspfCg8dW5pY29kZT4rfFxcKil8XFwjKDx1bmljb2RlPispfFxcLig8dW5pY29kZT4rKXxcXFtcXHMqKDx1bmljb2RlMT4rKSg/OlxccyooWypeJCF+fF0/PSkoPzpcXHMqKD86KFtcIiddPykoLio/KVxcOSkpKT9cXHMqXFxdKD8hXFxdKXwoOispKDx1bmljb2RlPispKD86XFwoKD86KD86KFtcIiddKShbXlxcMTNdKilcXDEzKXwoKD86XFwoW14pXStcXCl8W14oKV0qKSspKVxcKSk/KSIKCS5yZXBsYWNlKC88Y29tYmluYXRvcj4vLCAnWycgKyBlc2NhcGVSZWdFeHAoIj4rfmAhQCQlXiY9e31cXDs8LyIpICsgJ10nKQoJLnJlcGxhY2UoLzx1bmljb2RlPi9nLCAnKD86W1xcd1xcdTAwYTEtXFx1RkZGRi1dfFxcXFxbXlxcczAtOWEtZl0pJykKCS5yZXBsYWNlKC88dW5pY29kZTE+L2csICcoPzpbOlxcd1xcdTAwYTEtXFx1RkZGRi1dfFxcXFxbXlxcczAtOWEtZl0pJykKKTsKCmZ1bmN0aW9uIHBhcnNlcigKCXJhd01hdGNoLAoKCXNlcGFyYXRvciwKCWNvbWJpbmF0b3IsCgljb21iaW5hdG9yQ2hpbGRyZW4sCgoJdGFnTmFtZSwKCWlkLAoJY2xhc3NOYW1lLAoKCWF0dHJpYnV0ZUtleSwKCWF0dHJpYnV0ZU9wZXJhdG9yLAoJYXR0cmlidXRlUXVvdGUsCglhdHRyaWJ1dGVWYWx1ZSwKCglwc2V1ZG9NYXJrZXIsCglwc2V1ZG9DbGFzcywKCXBzZXVkb1F1b3RlLAoJcHNldWRvQ2xhc3NRdW90ZWRWYWx1ZSwKCXBzZXVkb0NsYXNzVmFsdWUKKXsKCWlmIChzZXBhcmF0b3IgfHwgc2VwYXJhdG9ySW5kZXggPT09IC0xKXsKCQlwYXJzZWQuZXhwcmVzc2lvbnNbKytzZXBhcmF0b3JJbmRleF0gPSBbXTsKCQljb21iaW5hdG9ySW5kZXggPSAtMTsKCQlpZiAoc2VwYXJhdG9yKSByZXR1cm4gJyc7Cgl9CgoJaWYgKGNvbWJpbmF0b3IgfHwgY29tYmluYXRvckNoaWxkcmVuIHx8IGNvbWJpbmF0b3JJbmRleCA9PT0gLTEpewoJCWNvbWJpbmF0b3IgPSBjb21iaW5hdG9yIHx8ICcgJzsKCQl2YXIgY3VycmVudFNlcGFyYXRvciA9IHBhcnNlZC5leHByZXNzaW9uc1tzZXBhcmF0b3JJbmRleF07CgkJaWYgKHJldmVyc2VkICYmIGN1cnJlbnRTZXBhcmF0b3JbY29tYmluYXRvckluZGV4XSkKCQkJY3VycmVudFNlcGFyYXRvcltjb21iaW5hdG9ySW5kZXhdLnJldmVyc2VDb21iaW5hdG9yID0gcmV2ZXJzZUNvbWJpbmF0b3IoY29tYmluYXRvcik7CgkJY3VycmVudFNlcGFyYXRvclsrK2NvbWJpbmF0b3JJbmRleF0gPSB7Y29tYmluYXRvcjogY29tYmluYXRvciwgdGFnOiAnKid9OwoJfQoKCXZhciBjdXJyZW50UGFyc2VkID0gcGFyc2VkLmV4cHJlc3Npb25zW3NlcGFyYXRvckluZGV4XVtjb21iaW5hdG9ySW5kZXhdOwoKCWlmICh0YWdOYW1lKXsKCQljdXJyZW50UGFyc2VkLnRhZyA9IHRhZ05hbWUucmVwbGFjZShyZVVuZXNjYXBlLCAnJyk7CgoJfSBlbHNlIGlmIChpZCl7CgkJY3VycmVudFBhcnNlZC5pZCA9IGlkLnJlcGxhY2UocmVVbmVzY2FwZSwgJycpOwoKCX0gZWxzZSBpZiAoY2xhc3NOYW1lKXsKCQljbGFzc05hbWUgPSBjbGFzc05hbWUucmVwbGFjZShyZVVuZXNjYXBlLCAnJyk7CgoJCWlmICghY3VycmVudFBhcnNlZC5jbGFzc0xpc3QpIGN1cnJlbnRQYXJzZWQuY2xhc3NMaXN0ID0gW107CgkJaWYgKCFjdXJyZW50UGFyc2VkLmNsYXNzZXMpIGN1cnJlbnRQYXJzZWQuY2xhc3NlcyA9IFtdOwoJCWN1cnJlbnRQYXJzZWQuY2xhc3NMaXN0LnB1c2goY2xhc3NOYW1lKTsKCQljdXJyZW50UGFyc2VkLmNsYXNzZXMucHVzaCh7CgkJCXZhbHVlOiBjbGFzc05hbWUsCgkJCXJlZ2V4cDogbmV3IFJlZ0V4cCgnKF58XFxzKScgKyBlc2NhcGVSZWdFeHAoY2xhc3NOYW1lKSArICcoXFxzfCQpJykKCQl9KTsKCgl9IGVsc2UgaWYgKHBzZXVkb0NsYXNzKXsKCQlwc2V1ZG9DbGFzc1ZhbHVlID0gcHNldWRvQ2xhc3NWYWx1ZSB8fCBwc2V1ZG9DbGFzc1F1b3RlZFZhbHVlOwoJCXBzZXVkb0NsYXNzVmFsdWUgPSBwc2V1ZG9DbGFzc1ZhbHVlID8gcHNldWRvQ2xhc3NWYWx1ZS5yZXBsYWNlKHJlVW5lc2NhcGUsICcnKSA6IG51bGw7CgoJCWlmICghY3VycmVudFBhcnNlZC5wc2V1ZG9zKSBjdXJyZW50UGFyc2VkLnBzZXVkb3MgPSBbXTsKCQljdXJyZW50UGFyc2VkLnBzZXVkb3MucHVzaCh7CgkJCWtleTogcHNldWRvQ2xhc3MucmVwbGFjZShyZVVuZXNjYXBlLCAnJyksCgkJCXZhbHVlOiBwc2V1ZG9DbGFzc1ZhbHVlLAoJCQl0eXBlOiBwc2V1ZG9NYXJrZXIubGVuZ3RoID09IDEgPyAnY2xhc3MnIDogJ2VsZW1lbnQnCgkJfSk7CgoJfSBlbHNlIGlmIChhdHRyaWJ1dGVLZXkpewoJCWF0dHJpYnV0ZUtleSA9IGF0dHJpYnV0ZUtleS5yZXBsYWNlKHJlVW5lc2NhcGUsICcnKTsKCQlhdHRyaWJ1dGVWYWx1ZSA9IChhdHRyaWJ1dGVWYWx1ZSB8fCAnJykucmVwbGFjZShyZVVuZXNjYXBlLCAnJyk7CgoJCXZhciB0ZXN0LCByZWdleHA7CgoJCXN3aXRjaCAoYXR0cmlidXRlT3BlcmF0b3IpewoJCQljYXNlICdePScgOiByZWdleHAgPSBuZXcgUmVnRXhwKCAgICAgICAnXicrIGVzY2FwZVJlZ0V4cChhdHRyaWJ1dGVWYWx1ZSkgICAgICAgICAgICApOyBicmVhazsKCQkJY2FzZSAnJD0nIDogcmVnZXhwID0gbmV3IFJlZ0V4cCggICAgICAgICAgICBlc2NhcGVSZWdFeHAoYXR0cmlidXRlVmFsdWUpICsnJCcgICAgICAgKTsgYnJlYWs7CgkJCWNhc2UgJ349JyA6IHJlZ2V4cCA9IG5ldyBSZWdFeHAoICcoXnxcXHMpJysgZXNjYXBlUmVnRXhwKGF0dHJpYnV0ZVZhbHVlKSArJyhcXHN8JCknICk7IGJyZWFrOwoJCQljYXNlICd8PScgOiByZWdleHAgPSBuZXcgUmVnRXhwKCAgICAgICAnXicrIGVzY2FwZVJlZ0V4cChhdHRyaWJ1dGVWYWx1ZSkgKycoLXwkKScgICApOyBicmVhazsKCQkJY2FzZSAgJz0nIDogdGVzdCA9IGZ1bmN0aW9uKHZhbHVlKXsKCQkJCXJldHVybiBhdHRyaWJ1dGVWYWx1ZSA9PSB2YWx1ZTsKCQkJfTsgYnJlYWs7CgkJCWNhc2UgJyo9JyA6IHRlc3QgPSBmdW5jdGlvbih2YWx1ZSl7CgkJCQlyZXR1cm4gdmFsdWUgJiYgdmFsdWUuaW5kZXhPZihhdHRyaWJ1dGVWYWx1ZSkgPiAtMTsKCQkJfTsgYnJlYWs7CgkJCWNhc2UgJyE9JyA6IHRlc3QgPSBmdW5jdGlvbih2YWx1ZSl7CgkJCQlyZXR1cm4gYXR0cmlidXRlVmFsdWUgIT0gdmFsdWU7CgkJCX07IGJyZWFrOwoJCQlkZWZhdWx0ICAgOiB0ZXN0ID0gZnVuY3Rpb24odmFsdWUpewoJCQkJcmV0dXJuICEhdmFsdWU7CgkJCX07CgkJfQoKCQlpZiAoYXR0cmlidXRlVmFsdWUgPT0gJycgJiYgKC9eWyokXl09JC8pLnRlc3QoYXR0cmlidXRlT3BlcmF0b3IpKSB0ZXN0ID0gZnVuY3Rpb24oKXsKCQkJcmV0dXJuIGZhbHNlOwoJCX07CgoJCWlmICghdGVzdCkgdGVzdCA9IGZ1bmN0aW9uKHZhbHVlKXsKCQkJcmV0dXJuIHZhbHVlICYmIHJlZ2V4cC50ZXN0KHZhbHVlKTsKCQl9OwoKCQlpZiAoIWN1cnJlbnRQYXJzZWQuYXR0cmlidXRlcykgY3VycmVudFBhcnNlZC5hdHRyaWJ1dGVzID0gW107CgkJY3VycmVudFBhcnNlZC5hdHRyaWJ1dGVzLnB1c2goewoJCQlrZXk6IGF0dHJpYnV0ZUtleSwKCQkJb3BlcmF0b3I6IGF0dHJpYnV0ZU9wZXJhdG9yLAoJCQl2YWx1ZTogYXR0cmlidXRlVmFsdWUsCgkJCXRlc3Q6IHRlc3QKCQl9KTsKCgl9CgoJcmV0dXJuICcnOwp9OwoKLy8gU2xpY2sgTlMKCnZhciBTbGljayA9ICh0aGlzLlNsaWNrIHx8IHt9KTsKClNsaWNrLnBhcnNlID0gZnVuY3Rpb24oZXhwcmVzc2lvbil7CglyZXR1cm4gcGFyc2UoZXhwcmVzc2lvbik7Cn07CgpTbGljay5lc2NhcGVSZWdFeHAgPSBlc2NhcGVSZWdFeHA7CgppZiAoIXRoaXMuU2xpY2spIHRoaXMuU2xpY2sgPSBTbGljazsKCn0pLmFwcGx5KC8qPENvbW1vbkpTPiovKHR5cGVvZiBleHBvcnRzICE9ICd1bmRlZmluZWQnKSA/IGV4cG9ydHMgOiAvKjwvQ29tbW9uSlM+Ki90aGlzKTsKLyoKLS0tCm5hbWU6IFNsaWNrLkZpbmRlcgpkZXNjcmlwdGlvbjogVGhlIG5ldywgc3VwZXJmYXN0IGNzcyBzZWxlY3RvciBlbmdpbmUuCnByb3ZpZGVzOiBTbGljay5GaW5kZXIKcmVxdWlyZXM6IFNsaWNrLlBhcnNlcgouLi4KKi8KCjsoZnVuY3Rpb24oKXsKCnZhciBsb2NhbCA9IHt9LAoJZmVhdHVyZXNDYWNoZSA9IHt9LAoJdG9TdHJpbmcgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nOwoKLy8gRmVhdHVyZSAvIEJ1ZyBkZXRlY3Rpb24KCmxvY2FsLmlzTmF0aXZlQ29kZSA9IGZ1bmN0aW9uKGZuKXsKCXJldHVybiAoL1x7XHMqXFtuYXRpdmUgY29kZVxdXHMqXH0vKS50ZXN0KCcnICsgZm4pOwp9OwoKbG9jYWwuaXNYTUwgPSBmdW5jdGlvbihkb2N1bWVudCl7CglyZXR1cm4gKCEhZG9jdW1lbnQueG1sVmVyc2lvbikgfHwgKCEhZG9jdW1lbnQueG1sKSB8fCAodG9TdHJpbmcuY2FsbChkb2N1bWVudCkgPT0gJ1tvYmplY3QgWE1MRG9jdW1lbnRdJykgfHwKCShkb2N1bWVudC5ub2RlVHlwZSA9PSA5ICYmIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5ub2RlTmFtZSAhPSAnSFRNTCcpOwp9OwoKbG9jYWwuc2V0RG9jdW1lbnQgPSBmdW5jdGlvbihkb2N1bWVudCl7CgoJLy8gY29udmVydCBlbGVtZW50cyAvIHdpbmRvdyBhcmd1bWVudHMgdG8gZG9jdW1lbnQuIGlmIGRvY3VtZW50IGNhbm5vdCBiZSBleHRyYXBvbGF0ZWQsIHRoZSBmdW5jdGlvbiByZXR1cm5zLgoJdmFyIG5vZGVUeXBlID0gZG9jdW1lbnQubm9kZVR5cGU7CglpZiAobm9kZVR5cGUgPT0gOSk7IC8vIGRvY3VtZW50CgllbHNlIGlmIChub2RlVHlwZSkgZG9jdW1lbnQgPSBkb2N1bWVudC5vd25lckRvY3VtZW50OyAvLyBub2RlCgllbHNlIGlmIChkb2N1bWVudC5uYXZpZ2F0b3IpIGRvY3VtZW50ID0gZG9jdW1lbnQuZG9jdW1lbnQ7IC8vIHdpbmRvdwoJZWxzZSByZXR1cm47CgoJLy8gY2hlY2sgaWYgaXQncyB0aGUgb2xkIGRvY3VtZW50CgoJaWYgKHRoaXMuZG9jdW1lbnQgPT09IGRvY3VtZW50KSByZXR1cm47Cgl0aGlzLmRvY3VtZW50ID0gZG9jdW1lbnQ7CgoJLy8gY2hlY2sgaWYgd2UgaGF2ZSBkb25lIGZlYXR1cmUgZGV0ZWN0aW9uIG9uIHRoaXMgZG9jdW1lbnQgYmVmb3JlCgoJdmFyIHJvb3QgPSBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQsCgkJcm9vdFVpZCA9IHRoaXMuZ2V0VUlEWE1MKHJvb3QpLAoJCWZlYXR1cmVzID0gZmVhdHVyZXNDYWNoZVtyb290VWlkXSwKCQlmZWF0dXJlOwoKCWlmIChmZWF0dXJlcyl7CgkJZm9yIChmZWF0dXJlIGluIGZlYXR1cmVzKXsKCQkJdGhpc1tmZWF0dXJlXSA9IGZlYXR1cmVzW2ZlYXR1cmVdOwoJCX0KCQlyZXR1cm47Cgl9CgoJZmVhdHVyZXMgPSBmZWF0dXJlc0NhY2hlW3Jvb3RVaWRdID0ge307CgoJZmVhdHVyZXMucm9vdCA9IHJvb3Q7CglmZWF0dXJlcy5pc1hNTERvY3VtZW50ID0gdGhpcy5pc1hNTChkb2N1bWVudCk7CgoJZmVhdHVyZXMuYnJva2VuU3RhckdFQlROCgk9IGZlYXR1cmVzLnN0YXJTZWxlY3RzQ2xvc2VkUVNBCgk9IGZlYXR1cmVzLmlkR2V0c05hbWUKCT0gZmVhdHVyZXMuYnJva2VuTWl4ZWRDYXNlUVNBCgk9IGZlYXR1cmVzLmJyb2tlbkdFQkNOCgk9IGZlYXR1cmVzLmJyb2tlbkNoZWNrZWRRU0EKCT0gZmVhdHVyZXMuYnJva2VuRW1wdHlBdHRyaWJ1dGVRU0EKCT0gZmVhdHVyZXMuaXNIVE1MRG9jdW1lbnQKCT0gZmVhdHVyZXMubmF0aXZlTWF0Y2hlc1NlbGVjdG9yCgk9IGZhbHNlOwoKCXZhciBzdGFyU2VsZWN0c0Nsb3NlZCwgc3RhclNlbGVjdHNDb21tZW50cywKCQlicm9rZW5TZWNvbmRDbGFzc05hbWVHRUJDTiwgY2FjaGVkR2V0RWxlbWVudHNCeUNsYXNzTmFtZSwKCQlicm9rZW5Gb3JtQXR0cmlidXRlR2V0dGVyOwoKCXZhciBzZWxlY3RlZCwgaWQgPSAnc2xpY2tfdW5pcXVlaWQnOwoJdmFyIHRlc3ROb2RlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CgkKCXZhciB0ZXN0Um9vdCA9IGRvY3VtZW50LmJvZHkgfHwgZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ2JvZHknKVswXSB8fCByb290OwoJdGVzdFJvb3QuYXBwZW5kQ2hpbGQodGVzdE5vZGUpOwoKCS8vIG9uIG5vbi1IVE1MIGRvY3VtZW50cyBpbm5lckhUTUwgYW5kIGdldEVsZW1lbnRzQnlJZCBkb2VzbnQgd29yayBwcm9wZXJseQoJdHJ5IHsKCQl0ZXN0Tm9kZS5pbm5lckhUTUwgPSAnPGEgaWQ9IicraWQrJyI+PC9hPic7CgkJZmVhdHVyZXMuaXNIVE1MRG9jdW1lbnQgPSAhIWRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGlkKTsKCX0gY2F0Y2goZSl7fTsKCglpZiAoZmVhdHVyZXMuaXNIVE1MRG9jdW1lbnQpewoKCQl0ZXN0Tm9kZS5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwoKCQkvLyBJRSByZXR1cm5zIGNvbW1lbnQgbm9kZXMgZm9yIGdldEVsZW1lbnRzQnlUYWdOYW1lKCcqJykgZm9yIHNvbWUgZG9jdW1lbnRzCgkJdGVzdE5vZGUuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlQ29tbWVudCgnJykpOwoJCXN0YXJTZWxlY3RzQ29tbWVudHMgPSAodGVzdE5vZGUuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJyonKS5sZW5ndGggPiAxKTsKCgkJLy8gSUUgcmV0dXJucyBjbG9zZWQgbm9kZXMgKEVHOiI8L2Zvbz4iKSBmb3IgZ2V0RWxlbWVudHNCeVRhZ05hbWUoJyonKSBmb3Igc29tZSBkb2N1bWVudHMKCQl0cnkgewoJCQl0ZXN0Tm9kZS5pbm5lckhUTUwgPSAnZm9vPC9mb28+JzsKCQkJc2VsZWN0ZWQgPSB0ZXN0Tm9kZS5nZXRFbGVtZW50c0J5VGFnTmFtZSgnKicpOwoJCQlzdGFyU2VsZWN0c0Nsb3NlZCA9IChzZWxlY3RlZCAmJiAhIXNlbGVjdGVkLmxlbmd0aCAmJiBzZWxlY3RlZFswXS5ub2RlTmFtZS5jaGFyQXQoMCkgPT0gJy8nKTsKCQl9IGNhdGNoKGUpe307CgoJCWZlYXR1cmVzLmJyb2tlblN0YXJHRUJUTiA9IHN0YXJTZWxlY3RzQ29tbWVudHMgfHwgc3RhclNlbGVjdHNDbG9zZWQ7CgoJCS8vIElFIHJldHVybnMgZWxlbWVudHMgd2l0aCB0aGUgbmFtZSBpbnN0ZWFkIG9mIGp1c3QgaWQgZm9yIGdldEVsZW1lbnRzQnlJZCBmb3Igc29tZSBkb2N1bWVudHMKCQl0cnkgewoJCQl0ZXN0Tm9kZS5pbm5lckhUTUwgPSAnPGEgbmFtZT0iJysgaWQgKyciPjwvYT48YiBpZD0iJysgaWQgKyciPjwvYj4nOwoJCQlmZWF0dXJlcy5pZEdldHNOYW1lID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoaWQpID09PSB0ZXN0Tm9kZS5maXJzdENoaWxkOwoJCX0gY2F0Y2goZSl7fTsKCgkJaWYgKHRlc3ROb2RlLmdldEVsZW1lbnRzQnlDbGFzc05hbWUpewoKCQkJLy8gU2FmYXJpIDMuMiBnZXRFbGVtZW50c0J5Q2xhc3NOYW1lIGNhY2hlcyByZXN1bHRzCgkJCXRyeSB7CgkJCQl0ZXN0Tm9kZS5pbm5lckhUTUwgPSAnPGEgY2xhc3M9ImYiPjwvYT48YSBjbGFzcz0iYiI+PC9hPic7CgkJCQl0ZXN0Tm9kZS5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKCdiJykubGVuZ3RoOwoJCQkJdGVzdE5vZGUuZmlyc3RDaGlsZC5jbGFzc05hbWUgPSAnYic7CgkJCQljYWNoZWRHZXRFbGVtZW50c0J5Q2xhc3NOYW1lID0gKHRlc3ROb2RlLmdldEVsZW1lbnRzQnlDbGFzc05hbWUoJ2InKS5sZW5ndGggIT0gMik7CgkJCX0gY2F0Y2goZSl7fTsKCgkJCS8vIE9wZXJhIDkuNiBnZXRFbGVtZW50c0J5Q2xhc3NOYW1lIGRvZXNudCBkZXRlY3RzIHRoZSBjbGFzcyBpZiBpdHMgbm90IHRoZSBmaXJzdCBvbmUKCQkJdHJ5IHsKCQkJCXRlc3ROb2RlLmlubmVySFRNTCA9ICc8YSBjbGFzcz0iYSI+PC9hPjxhIGNsYXNzPSJmIGIgYSI+PC9hPic7CgkJCQlicm9rZW5TZWNvbmRDbGFzc05hbWVHRUJDTiA9ICh0ZXN0Tm9kZS5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKCdhJykubGVuZ3RoICE9IDIpOwoJCQl9IGNhdGNoKGUpe307CgoJCQlmZWF0dXJlcy5icm9rZW5HRUJDTiA9IGNhY2hlZEdldEVsZW1lbnRzQnlDbGFzc05hbWUgfHwgYnJva2VuU2Vjb25kQ2xhc3NOYW1lR0VCQ047CgkJfQoJCQoJCWlmICh0ZXN0Tm9kZS5xdWVyeVNlbGVjdG9yQWxsKXsKCQkJLy8gSUUgOCByZXR1cm5zIGNsb3NlZCBub2RlcyAoRUc6IjwvZm9vPiIpIGZvciBxdWVyeVNlbGVjdG9yQWxsKCcqJykgZm9yIHNvbWUgZG9jdW1lbnRzCgkJCXRyeSB7CgkJCQl0ZXN0Tm9kZS5pbm5lckhUTUwgPSAnZm9vPC9mb28+JzsKCQkJCXNlbGVjdGVkID0gdGVzdE5vZGUucXVlcnlTZWxlY3RvckFsbCgnKicpOwoJCQkJZmVhdHVyZXMuc3RhclNlbGVjdHNDbG9zZWRRU0EgPSAoc2VsZWN0ZWQgJiYgISFzZWxlY3RlZC5sZW5ndGggJiYgc2VsZWN0ZWRbMF0ubm9kZU5hbWUuY2hhckF0KDApID09ICcvJyk7CgkJCX0gY2F0Y2goZSl7fTsKCgkJCS8vIFNhZmFyaSAzLjIgcXVlcnlTZWxlY3RvckFsbCBkb2VzbnQgd29yayB3aXRoIG1peGVkY2FzZSBvbiBxdWlya3Ntb2RlCgkJCXRyeSB7CgkJCQl0ZXN0Tm9kZS5pbm5lckhUTUwgPSAnPGEgY2xhc3M9Ik1pWCI+PC9hPic7CgkJCQlmZWF0dXJlcy5icm9rZW5NaXhlZENhc2VRU0EgPSAhdGVzdE5vZGUucXVlcnlTZWxlY3RvckFsbCgnLk1pWCcpLmxlbmd0aDsKCQkJfSBjYXRjaChlKXt9OwoKCQkJLy8gV2Via2l0IGFuZCBPcGVyYSBkb250IHJldHVybiBzZWxlY3RlZCBvcHRpb25zIG9uIHF1ZXJ5U2VsZWN0b3JBbGwKCQkJdHJ5IHsKCQkJCXRlc3ROb2RlLmlubmVySFRNTCA9ICc8c2VsZWN0PjxvcHRpb24gc2VsZWN0ZWQ9InNlbGVjdGVkIj5hPC9vcHRpb24+PC9zZWxlY3Q+JzsKCQkJCWZlYXR1cmVzLmJyb2tlbkNoZWNrZWRRU0EgPSAodGVzdE5vZGUucXVlcnlTZWxlY3RvckFsbCgnOmNoZWNrZWQnKS5sZW5ndGggPT0gMCk7CgkJCX0gY2F0Y2goZSl7fTsKCgkJCS8vIElFIHJldHVybnMgaW5jb3JyZWN0IHJlc3VsdHMgZm9yIGF0dHJbKl4kXT0iIiBzZWxlY3RvcnMgb24gcXVlcnlTZWxlY3RvckFsbAoJCQl0cnkgewoJCQkJdGVzdE5vZGUuaW5uZXJIVE1MID0gJzxhIGNsYXNzPSIiPjwvYT4nOwoJCQkJZmVhdHVyZXMuYnJva2VuRW1wdHlBdHRyaWJ1dGVRU0EgPSAodGVzdE5vZGUucXVlcnlTZWxlY3RvckFsbCgnW2NsYXNzKj0iIl0nKS5sZW5ndGggIT0gMCk7CgkJCX0gY2F0Y2goZSl7fTsKCgkJfQoKCQkvLyBJRTYtNywgaWYgYSBmb3JtIGhhcyBhbiBpbnB1dCBvZiBpZCB4LCBmb3JtLmdldEF0dHJpYnV0ZSh4KSByZXR1cm5zIGEgcmVmZXJlbmNlIHRvIHRoZSBpbnB1dAoJCXRyeSB7CgkJCXRlc3ROb2RlLmlubmVySFRNTCA9ICc8Zm9ybSBhY3Rpb249InMiPjxpbnB1dCBpZD0iYWN0aW9uIi8+PC9mb3JtPic7CgkJCWJyb2tlbkZvcm1BdHRyaWJ1dGVHZXR0ZXIgPSAodGVzdE5vZGUuZmlyc3RDaGlsZC5nZXRBdHRyaWJ1dGUoJ2FjdGlvbicpICE9ICdzJyk7CgkJfSBjYXRjaChlKXt9OwoKCQkvLyBuYXRpdmUgbWF0Y2hlc1NlbGVjdG9yIGZ1bmN0aW9uCgoJCWZlYXR1cmVzLm5hdGl2ZU1hdGNoZXNTZWxlY3RvciA9IHJvb3QubWF0Y2hlc1NlbGVjdG9yIHx8IC8qcm9vdC5tc01hdGNoZXNTZWxlY3RvciB8fCovIHJvb3QubW96TWF0Y2hlc1NlbGVjdG9yIHx8IHJvb3Qud2Via2l0TWF0Y2hlc1NlbGVjdG9yOwoJCWlmIChmZWF0dXJlcy5uYXRpdmVNYXRjaGVzU2VsZWN0b3IpIHRyeSB7CgkJCS8vIGlmIG1hdGNoZXNTZWxlY3RvciB0cm93cyBlcnJvcnMgb24gaW5jb3JyZWN0IHNpbnRheGVzIHdlIGNhbiB1c2UgaXQKCQkJZmVhdHVyZXMubmF0aXZlTWF0Y2hlc1NlbGVjdG9yLmNhbGwocm9vdCwgJzpzbGljaycpOwoJCQlmZWF0dXJlcy5uYXRpdmVNYXRjaGVzU2VsZWN0b3IgPSBudWxsOwoJCX0gY2F0Y2goZSl7fTsKCgl9CgoJdHJ5IHsKCQlyb290LnNsaWNrX2V4cGFuZG8gPSAxOwoJCWRlbGV0ZSByb290LnNsaWNrX2V4cGFuZG87CgkJZmVhdHVyZXMuZ2V0VUlEID0gdGhpcy5nZXRVSURIVE1MOwoJfSBjYXRjaChlKSB7CgkJZmVhdHVyZXMuZ2V0VUlEID0gdGhpcy5nZXRVSURYTUw7Cgl9CgoJdGVzdFJvb3QucmVtb3ZlQ2hpbGQodGVzdE5vZGUpOwoJdGVzdE5vZGUgPSBzZWxlY3RlZCA9IHRlc3RSb290ID0gbnVsbDsKCgkvLyBnZXRBdHRyaWJ1dGUKCglmZWF0dXJlcy5nZXRBdHRyaWJ1dGUgPSAoZmVhdHVyZXMuaXNIVE1MRG9jdW1lbnQgJiYgYnJva2VuRm9ybUF0dHJpYnV0ZUdldHRlcikgPyBmdW5jdGlvbihub2RlLCBuYW1lKXsKCQl2YXIgbWV0aG9kID0gdGhpcy5hdHRyaWJ1dGVHZXR0ZXJzW25hbWVdOwoJCWlmIChtZXRob2QpIHJldHVybiBtZXRob2QuY2FsbChub2RlKTsKCQl2YXIgYXR0cmlidXRlTm9kZSA9IG5vZGUuZ2V0QXR0cmlidXRlTm9kZShuYW1lKTsKCQlyZXR1cm4gKGF0dHJpYnV0ZU5vZGUpID8gYXR0cmlidXRlTm9kZS5ub2RlVmFsdWUgOiBudWxsOwoJfSA6IGZ1bmN0aW9uKG5vZGUsIG5hbWUpewoJCXZhciBtZXRob2QgPSB0aGlzLmF0dHJpYnV0ZUdldHRlcnNbbmFtZV07CgkJcmV0dXJuIChtZXRob2QpID8gbWV0aG9kLmNhbGwobm9kZSkgOiBub2RlLmdldEF0dHJpYnV0ZShuYW1lKTsKCX07CgoJLy8gaGFzQXR0cmlidXRlCgoJZmVhdHVyZXMuaGFzQXR0cmlidXRlID0gKHJvb3QgJiYgdGhpcy5pc05hdGl2ZUNvZGUocm9vdC5oYXNBdHRyaWJ1dGUpKSA/IGZ1bmN0aW9uKG5vZGUsIGF0dHJpYnV0ZSkgewoJCXJldHVybiBub2RlLmhhc0F0dHJpYnV0ZShhdHRyaWJ1dGUpOwoJfSA6IGZ1bmN0aW9uKG5vZGUsIGF0dHJpYnV0ZSkgewoJCW5vZGUgPSBub2RlLmdldEF0dHJpYnV0ZU5vZGUoYXR0cmlidXRlKTsKCQlyZXR1cm4gISEobm9kZSAmJiAobm9kZS5zcGVjaWZpZWQgfHwgbm9kZS5ub2RlVmFsdWUpKTsKCX07CgoJLy8gY29udGFpbnMKCS8vIEZJWE1FOiBBZGQgc3BlY3M6IGxvY2FsLmNvbnRhaW5zIHNob3VsZCBiZSBkaWZmZXJlbnQgZm9yIHhtbCBhbmQgaHRtbCBkb2N1bWVudHM/CglmZWF0dXJlcy5jb250YWlucyA9IChyb290ICYmIHRoaXMuaXNOYXRpdmVDb2RlKHJvb3QuY29udGFpbnMpKSA/IGZ1bmN0aW9uKGNvbnRleHQsIG5vZGUpewoJCXJldHVybiBjb250ZXh0LmNvbnRhaW5zKG5vZGUpOwoJfSA6IChyb290ICYmIHJvb3QuY29tcGFyZURvY3VtZW50UG9zaXRpb24pID8gZnVuY3Rpb24oY29udGV4dCwgbm9kZSl7CgkJcmV0dXJuIGNvbnRleHQgPT09IG5vZGUgfHwgISEoY29udGV4dC5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbihub2RlKSAmIDE2KTsKCX0gOiBmdW5jdGlvbihjb250ZXh0LCBub2RlKXsKCQlpZiAobm9kZSkgZG8gewoJCQlpZiAobm9kZSA9PT0gY29udGV4dCkgcmV0dXJuIHRydWU7CgkJfSB3aGlsZSAoKG5vZGUgPSBub2RlLnBhcmVudE5vZGUpKTsKCQlyZXR1cm4gZmFsc2U7Cgl9OwoKCS8vIGRvY3VtZW50IG9yZGVyIHNvcnRpbmcKCS8vIGNyZWRpdHMgdG8gU2l6emxlIChodHRwOi8vc2l6emxlanMuY29tLykKCglmZWF0dXJlcy5kb2N1bWVudFNvcnRlciA9IChyb290LmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uKSA/IGZ1bmN0aW9uKGEsIGIpewoJCWlmICghYS5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbiB8fCAhYi5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbikgcmV0dXJuIDA7CgkJcmV0dXJuIGEuY29tcGFyZURvY3VtZW50UG9zaXRpb24oYikgJiA0ID8gLTEgOiBhID09PSBiID8gMCA6IDE7Cgl9IDogKCdzb3VyY2VJbmRleCcgaW4gcm9vdCkgPyBmdW5jdGlvbihhLCBiKXsKCQlpZiAoIWEuc291cmNlSW5kZXggfHwgIWIuc291cmNlSW5kZXgpIHJldHVybiAwOwoJCXJldHVybiBhLnNvdXJjZUluZGV4IC0gYi5zb3VyY2VJbmRleDsKCX0gOiAoZG9jdW1lbnQuY3JlYXRlUmFuZ2UpID8gZnVuY3Rpb24oYSwgYil7CgkJaWYgKCFhLm93bmVyRG9jdW1lbnQgfHwgIWIub3duZXJEb2N1bWVudCkgcmV0dXJuIDA7CgkJdmFyIGFSYW5nZSA9IGEub3duZXJEb2N1bWVudC5jcmVhdGVSYW5nZSgpLCBiUmFuZ2UgPSBiLm93bmVyRG9jdW1lbnQuY3JlYXRlUmFuZ2UoKTsKCQlhUmFuZ2Uuc2V0U3RhcnQoYSwgMCk7CgkJYVJhbmdlLnNldEVuZChhLCAwKTsKCQliUmFuZ2Uuc2V0U3RhcnQoYiwgMCk7CgkJYlJhbmdlLnNldEVuZChiLCAwKTsKCQlyZXR1cm4gYVJhbmdlLmNvbXBhcmVCb3VuZGFyeVBvaW50cyhSYW5nZS5TVEFSVF9UT19FTkQsIGJSYW5nZSk7Cgl9IDogbnVsbCA7CgoJcm9vdCA9IG51bGw7CgoJZm9yIChmZWF0dXJlIGluIGZlYXR1cmVzKXsKCQl0aGlzW2ZlYXR1cmVdID0gZmVhdHVyZXNbZmVhdHVyZV07Cgl9Cn07CgovLyBNYWluIE1ldGhvZAoKdmFyIHJlU2ltcGxlU2VsZWN0b3IgPSAvXihbIy5dPykoKD86W1x3LV0rfFwqKSkkLywKCXJlRW1wdHlBdHRyaWJ1dGUgPSAvXFsuK1sqJF5dPSg/OiIifCcnKT9cXS8sCglxc2FGYWlsRXhwQ2FjaGUgPSB7fTsKCmxvY2FsLnNlYXJjaCA9IGZ1bmN0aW9uKGNvbnRleHQsIGV4cHJlc3Npb24sIGFwcGVuZCwgZmlyc3QpewoKCXZhciBmb3VuZCA9IHRoaXMuZm91bmQgPSAoZmlyc3QpID8gbnVsbCA6IChhcHBlbmQgfHwgW10pOwoJCglpZiAoIWNvbnRleHQpIHJldHVybiBmb3VuZDsKCWVsc2UgaWYgKGNvbnRleHQubmF2aWdhdG9yKSBjb250ZXh0ID0gY29udGV4dC5kb2N1bWVudDsgLy8gQ29udmVydCB0aGUgbm9kZSBmcm9tIGEgd2luZG93IHRvIGEgZG9jdW1lbnQKCWVsc2UgaWYgKCFjb250ZXh0Lm5vZGVUeXBlKSByZXR1cm4gZm91bmQ7CgoJLy8gc2V0dXAKCgl2YXIgcGFyc2VkLCBpLAoJCXVuaXF1ZXMgPSB0aGlzLnVuaXF1ZXMgPSB7fSwKCQloYXNPdGhlcnMgPSAhIShhcHBlbmQgJiYgYXBwZW5kLmxlbmd0aCksCgkJY29udGV4dElzRG9jdW1lbnQgPSAoY29udGV4dC5ub2RlVHlwZSA9PSA5KTsKCglpZiAodGhpcy5kb2N1bWVudCAhPT0gKGNvbnRleHRJc0RvY3VtZW50ID8gY29udGV4dCA6IGNvbnRleHQub3duZXJEb2N1bWVudCkpIHRoaXMuc2V0RG9jdW1lbnQoY29udGV4dCk7CgoJLy8gYXZvaWQgZHVwbGljYXRpbmcgaXRlbXMgYWxyZWFkeSBpbiB0aGUgYXBwZW5kIGFycmF5CglpZiAoaGFzT3RoZXJzKSBmb3IgKGkgPSBmb3VuZC5sZW5ndGg7IGktLTspIHVuaXF1ZXNbdGhpcy5nZXRVSUQoZm91bmRbaV0pXSA9IHRydWU7CgoJLy8gZXhwcmVzc2lvbiBjaGVja3MKCglpZiAodHlwZW9mIGV4cHJlc3Npb24gPT0gJ3N0cmluZycpeyAvLyBleHByZXNzaW9uIGlzIGEgc3RyaW5nCgoJCS8qPHNpbXBsZS1zZWxlY3RvcnMtb3ZlcnJpZGU+Ki8KCQl2YXIgc2ltcGxlU2VsZWN0b3IgPSBleHByZXNzaW9uLm1hdGNoKHJlU2ltcGxlU2VsZWN0b3IpOwoJCXNpbXBsZVNlbGVjdG9yczogaWYgKHNpbXBsZVNlbGVjdG9yKSB7CgoJCQl2YXIgc3ltYm9sID0gc2ltcGxlU2VsZWN0b3JbMV0sCgkJCQluYW1lID0gc2ltcGxlU2VsZWN0b3JbMl0sCgkJCQlub2RlLCBub2RlczsKCgkJCWlmICghc3ltYm9sKXsKCgkJCQlpZiAobmFtZSA9PSAnKicgJiYgdGhpcy5icm9rZW5TdGFyR0VCVE4pIGJyZWFrIHNpbXBsZVNlbGVjdG9yczsKCQkJCW5vZGVzID0gY29udGV4dC5nZXRFbGVtZW50c0J5VGFnTmFtZShuYW1lKTsKCQkJCWlmIChmaXJzdCkgcmV0dXJuIG5vZGVzWzBdIHx8IG51bGw7CgkJCQlmb3IgKGkgPSAwOyBub2RlID0gbm9kZXNbaSsrXTspewoJCQkJCWlmICghKGhhc090aGVycyAmJiB1bmlxdWVzW3RoaXMuZ2V0VUlEKG5vZGUpXSkpIGZvdW5kLnB1c2gobm9kZSk7CgkJCQl9CgoJCQl9IGVsc2UgaWYgKHN5bWJvbCA9PSAnIycpewoKCQkJCWlmICghdGhpcy5pc0hUTUxEb2N1bWVudCB8fCAhY29udGV4dElzRG9jdW1lbnQpIGJyZWFrIHNpbXBsZVNlbGVjdG9yczsKCQkJCW5vZGUgPSBjb250ZXh0LmdldEVsZW1lbnRCeUlkKG5hbWUpOwoJCQkJaWYgKCFub2RlKSByZXR1cm4gZm91bmQ7CgkJCQlpZiAodGhpcy5pZEdldHNOYW1lICYmIG5vZGUuZ2V0QXR0cmlidXRlTm9kZSgnaWQnKS5ub2RlVmFsdWUgIT0gbmFtZSkgYnJlYWsgc2ltcGxlU2VsZWN0b3JzOwoJCQkJaWYgKGZpcnN0KSByZXR1cm4gbm9kZSB8fCBudWxsOwoJCQkJaWYgKCEoaGFzT3RoZXJzICYmIHVuaXF1ZXNbdGhpcy5nZXRVSUQobm9kZSldKSkgZm91bmQucHVzaChub2RlKTsKCgkJCX0gZWxzZSBpZiAoc3ltYm9sID09ICcuJyl7CgoJCQkJaWYgKCF0aGlzLmlzSFRNTERvY3VtZW50IHx8ICgoIWNvbnRleHQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSB8fCB0aGlzLmJyb2tlbkdFQkNOKSAmJiBjb250ZXh0LnF1ZXJ5U2VsZWN0b3JBbGwpKSBicmVhayBzaW1wbGVTZWxlY3RvcnM7CgkJCQlpZiAoY29udGV4dC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lICYmICF0aGlzLmJyb2tlbkdFQkNOKXsKCQkJCQlub2RlcyA9IGNvbnRleHQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZShuYW1lKTsKCQkJCQlpZiAoZmlyc3QpIHJldHVybiBub2Rlc1swXSB8fCBudWxsOwoJCQkJCWZvciAoaSA9IDA7IG5vZGUgPSBub2Rlc1tpKytdOyl7CgkJCQkJCWlmICghKGhhc090aGVycyAmJiB1bmlxdWVzW3RoaXMuZ2V0VUlEKG5vZGUpXSkpIGZvdW5kLnB1c2gobm9kZSk7CgkJCQkJfQoJCQkJfSBlbHNlIHsKCQkJCQl2YXIgbWF0Y2hDbGFzcyA9IG5ldyBSZWdFeHAoJyhefFxccyknKyBTbGljay5lc2NhcGVSZWdFeHAobmFtZSkgKycoXFxzfCQpJyk7CgkJCQkJbm9kZXMgPSBjb250ZXh0LmdldEVsZW1lbnRzQnlUYWdOYW1lKCcqJyk7CgkJCQkJZm9yIChpID0gMDsgbm9kZSA9IG5vZGVzW2krK107KXsKCQkJCQkJY2xhc3NOYW1lID0gbm9kZS5jbGFzc05hbWU7CgkJCQkJCWlmICghKGNsYXNzTmFtZSAmJiBtYXRjaENsYXNzLnRlc3QoY2xhc3NOYW1lKSkpIGNvbnRpbnVlOwoJCQkJCQlpZiAoZmlyc3QpIHJldHVybiBub2RlOwoJCQkJCQlpZiAoIShoYXNPdGhlcnMgJiYgdW5pcXVlc1t0aGlzLmdldFVJRChub2RlKV0pKSBmb3VuZC5wdXNoKG5vZGUpOwoJCQkJCX0KCQkJCX0KCgkJCX0KCgkJCWlmIChoYXNPdGhlcnMpIHRoaXMuc29ydChmb3VuZCk7CgkJCXJldHVybiAoZmlyc3QpID8gbnVsbCA6IGZvdW5kOwoKCQl9CgkJLyo8L3NpbXBsZS1zZWxlY3RvcnMtb3ZlcnJpZGU+Ki8KCgkJLyo8cXVlcnktc2VsZWN0b3Itb3ZlcnJpZGU+Ki8KCQlxdWVyeVNlbGVjdG9yOiBpZiAoY29udGV4dC5xdWVyeVNlbGVjdG9yQWxsKSB7CgoJCQlpZiAoIXRoaXMuaXNIVE1MRG9jdW1lbnQKCQkJCXx8IHFzYUZhaWxFeHBDYWNoZVtleHByZXNzaW9uXQoJCQkJLy9UT0RPOiBvbmx5IHNraXAgd2hlbiBleHByZXNzaW9uIGlzIGFjdHVhbGx5IG1peGVkIGNhc2UKCQkJCXx8IHRoaXMuYnJva2VuTWl4ZWRDYXNlUVNBCgkJCQl8fCAodGhpcy5icm9rZW5DaGVja2VkUVNBICYmIGV4cHJlc3Npb24uaW5kZXhPZignOmNoZWNrZWQnKSA+IC0xKQoJCQkJfHwgKHRoaXMuYnJva2VuRW1wdHlBdHRyaWJ1dGVRU0EgJiYgcmVFbXB0eUF0dHJpYnV0ZS50ZXN0KGV4cHJlc3Npb24pKQoJCQkJfHwgKCFjb250ZXh0SXNEb2N1bWVudCAvL0Fib3J0IHdoZW4gIWNvbnRleHRJc0RvY3VtZW50IGFuZC4uLgoJCQkJCS8vICB0aGVyZSBhcmUgbXVsdGlwbGUgZXhwcmVzc2lvbnMgaW4gdGhlIHNlbGVjdG9yCgkJCQkJLy8gIHNpbmNlIHdlIGN1cnJlbnRseSBvbmx5IGZpeCBub24tZG9jdW1lbnQgcm9vdGVkIFFTQSBmb3Igc2luZ2xlIGV4cHJlc3Npb24gc2VsZWN0b3JzCgkJCQkJJiYgZXhwcmVzc2lvbi5pbmRleE9mKCcsJykgPiAtMQoJCQkJKQoJCQkJfHwgU2xpY2suZGlzYWJsZVFTQQoJCQkpIGJyZWFrIHF1ZXJ5U2VsZWN0b3I7CgoJCQl2YXIgX2V4cHJlc3Npb24gPSBleHByZXNzaW9uLCBfY29udGV4dCA9IGNvbnRleHQ7CgkJCWlmICghY29udGV4dElzRG9jdW1lbnQpewoJCQkJLy8gbm9uLWRvY3VtZW50IHJvb3RlZCBRU0EKCQkJCS8vIGNyZWRpdHMgdG8gQW5kcmV3IER1cG9udAoJCQkJdmFyIGN1cnJlbnRJZCA9IF9jb250ZXh0LmdldEF0dHJpYnV0ZSgnaWQnKSwgc2xpY2tpZCA9ICdzbGlja2lkX18nOwoJCQkJX2NvbnRleHQuc2V0QXR0cmlidXRlKCdpZCcsIHNsaWNraWQpOwoJCQkJX2V4cHJlc3Npb24gPSAnIycgKyBzbGlja2lkICsgJyAnICsgX2V4cHJlc3Npb247CgkJCQljb250ZXh0ID0gX2NvbnRleHQucGFyZW50Tm9kZTsKCQkJfQoKCQkJdHJ5IHsKCQkJCWlmIChmaXJzdCkgcmV0dXJuIGNvbnRleHQucXVlcnlTZWxlY3RvcihfZXhwcmVzc2lvbikgfHwgbnVsbDsKCQkJCWVsc2Ugbm9kZXMgPSBjb250ZXh0LnF1ZXJ5U2VsZWN0b3JBbGwoX2V4cHJlc3Npb24pOwoJCQl9IGNhdGNoKGUpIHsKCQkJCXFzYUZhaWxFeHBDYWNoZVtleHByZXNzaW9uXSA9IDE7CgkJCQlicmVhayBxdWVyeVNlbGVjdG9yOwoJCQl9IGZpbmFsbHkgewoJCQkJaWYgKCFjb250ZXh0SXNEb2N1bWVudCl7CgkJCQkJaWYgKGN1cnJlbnRJZCkgX2NvbnRleHQuc2V0QXR0cmlidXRlKCdpZCcsIGN1cnJlbnRJZCk7CgkJCQkJZWxzZSBfY29udGV4dC5yZW1vdmVBdHRyaWJ1dGUoJ2lkJyk7CgkJCQkJY29udGV4dCA9IF9jb250ZXh0OwoJCQkJfQoJCQl9CgoJCQlpZiAodGhpcy5zdGFyU2VsZWN0c0Nsb3NlZFFTQSkgZm9yIChpID0gMDsgbm9kZSA9IG5vZGVzW2krK107KXsKCQkJCWlmIChub2RlLm5vZGVOYW1lID4gJ0AnICYmICEoaGFzT3RoZXJzICYmIHVuaXF1ZXNbdGhpcy5nZXRVSUQobm9kZSldKSkgZm91bmQucHVzaChub2RlKTsKCQkJfSBlbHNlIGZvciAoaSA9IDA7IG5vZGUgPSBub2Rlc1tpKytdOyl7CgkJCQlpZiAoIShoYXNPdGhlcnMgJiYgdW5pcXVlc1t0aGlzLmdldFVJRChub2RlKV0pKSBmb3VuZC5wdXNoKG5vZGUpOwoJCQl9CgoJCQlpZiAoaGFzT3RoZXJzKSB0aGlzLnNvcnQoZm91bmQpOwoJCQlyZXR1cm4gZm91bmQ7CgoJCX0KCQkvKjwvcXVlcnktc2VsZWN0b3Itb3ZlcnJpZGU+Ki8KCgkJcGFyc2VkID0gdGhpcy5TbGljay5wYXJzZShleHByZXNzaW9uKTsKCQlpZiAoIXBhcnNlZC5sZW5ndGgpIHJldHVybiBmb3VuZDsKCX0gZWxzZSBpZiAoZXhwcmVzc2lvbiA9PSBudWxsKXsgLy8gdGhlcmUgaXMgbm8gZXhwcmVzc2lvbgoJCXJldHVybiBmb3VuZDsKCX0gZWxzZSBpZiAoZXhwcmVzc2lvbi5TbGljayl7IC8vIGV4cHJlc3Npb24gaXMgYSBwYXJzZWQgU2xpY2sgb2JqZWN0CgkJcGFyc2VkID0gZXhwcmVzc2lvbjsKCX0gZWxzZSBpZiAodGhpcy5jb250YWlucyhjb250ZXh0LmRvY3VtZW50RWxlbWVudCB8fCBjb250ZXh0LCBleHByZXNzaW9uKSl7IC8vIGV4cHJlc3Npb24gaXMgYSBub2RlCgkJKGZvdW5kKSA/IGZvdW5kLnB1c2goZXhwcmVzc2lvbikgOiBmb3VuZCA9IGV4cHJlc3Npb247CgkJcmV0dXJuIGZvdW5kOwoJfSBlbHNlIHsgLy8gb3RoZXIganVuawoJCXJldHVybiBmb3VuZDsKCX0KCgkvKjxwc2V1ZG8tc2VsZWN0b3JzPiovLyo8bnRoLXBzZXVkby1zZWxlY3RvcnM+Ki8KCgkvLyBjYWNoZSBlbGVtZW50cyBmb3IgdGhlIG50aCBzZWxlY3RvcnMKCgl0aGlzLnBvc05USCA9IHt9OwoJdGhpcy5wb3NOVEhMYXN0ID0ge307Cgl0aGlzLnBvc05USFR5cGUgPSB7fTsKCXRoaXMucG9zTlRIVHlwZUxhc3QgPSB7fTsKCgkvKjwvbnRoLXBzZXVkby1zZWxlY3RvcnM+Ki8vKjwvcHNldWRvLXNlbGVjdG9ycz4qLwoKCS8vIGlmIGFwcGVuZCBpcyBudWxsIGFuZCB0aGVyZSBpcyBvbmx5IGEgc2luZ2xlIHNlbGVjdG9yIHdpdGggb25lIGV4cHJlc3Npb24gdXNlIHB1c2hBcnJheSwgZWxzZSB1c2UgcHVzaFVJRAoJdGhpcy5wdXNoID0gKCFoYXNPdGhlcnMgJiYgKGZpcnN0IHx8IChwYXJzZWQubGVuZ3RoID09IDEgJiYgcGFyc2VkLmV4cHJlc3Npb25zWzBdLmxlbmd0aCA9PSAxKSkpID8gdGhpcy5wdXNoQXJyYXkgOiB0aGlzLnB1c2hVSUQ7CgoJaWYgKGZvdW5kID09IG51bGwpIGZvdW5kID0gW107CgoJLy8gZGVmYXVsdCBlbmdpbmUKCgl2YXIgaiwgbSwgbjsKCXZhciBjb21iaW5hdG9yLCB0YWcsIGlkLCBjbGFzc0xpc3QsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3M7Cgl2YXIgY3VycmVudEl0ZW1zLCBjdXJyZW50RXhwcmVzc2lvbiwgY3VycmVudEJpdCwgbGFzdEJpdCwgZXhwcmVzc2lvbnMgPSBwYXJzZWQuZXhwcmVzc2lvbnM7CgoJc2VhcmNoOiBmb3IgKGkgPSAwOyAoY3VycmVudEV4cHJlc3Npb24gPSBleHByZXNzaW9uc1tpXSk7IGkrKykgZm9yIChqID0gMDsgKGN1cnJlbnRCaXQgPSBjdXJyZW50RXhwcmVzc2lvbltqXSk7IGorKyl7CgoJCWNvbWJpbmF0b3IgPSAnY29tYmluYXRvcjonICsgY3VycmVudEJpdC5jb21iaW5hdG9yOwoJCWlmICghdGhpc1tjb21iaW5hdG9yXSkgY29udGludWUgc2VhcmNoOwoKCQl0YWcgICAgICAgID0gKHRoaXMuaXNYTUxEb2N1bWVudCkgPyBjdXJyZW50Qml0LnRhZyA6IGN1cnJlbnRCaXQudGFnLnRvVXBwZXJDYXNlKCk7CgkJaWQgICAgICAgICA9IGN1cnJlbnRCaXQuaWQ7CgkJY2xhc3NMaXN0ICA9IGN1cnJlbnRCaXQuY2xhc3NMaXN0OwoJCWNsYXNzZXMgICAgPSBjdXJyZW50Qml0LmNsYXNzZXM7CgkJYXR0cmlidXRlcyA9IGN1cnJlbnRCaXQuYXR0cmlidXRlczsKCQlwc2V1ZG9zICAgID0gY3VycmVudEJpdC5wc2V1ZG9zOwoJCWxhc3RCaXQgICAgPSAoaiA9PT0gKGN1cnJlbnRFeHByZXNzaW9uLmxlbmd0aCAtIDEpKTsKCgkJdGhpcy5iaXRVbmlxdWVzID0ge307CgoJCWlmIChsYXN0Qml0KXsKCQkJdGhpcy51bmlxdWVzID0gdW5pcXVlczsKCQkJdGhpcy5mb3VuZCA9IGZvdW5kOwoJCX0gZWxzZSB7CgkJCXRoaXMudW5pcXVlcyA9IHt9OwoJCQl0aGlzLmZvdW5kID0gW107CgkJfQoKCQlpZiAoaiA9PT0gMCl7CgkJCXRoaXNbY29tYmluYXRvcl0oY29udGV4dCwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcywgY2xhc3NMaXN0KTsKCQkJaWYgKGZpcnN0ICYmIGxhc3RCaXQgJiYgZm91bmQubGVuZ3RoKSBicmVhayBzZWFyY2g7CgkJfSBlbHNlIHsKCQkJaWYgKGZpcnN0ICYmIGxhc3RCaXQpIGZvciAobSA9IDAsIG4gPSBjdXJyZW50SXRlbXMubGVuZ3RoOyBtIDwgbjsgbSsrKXsKCQkJCXRoaXNbY29tYmluYXRvcl0oY3VycmVudEl0ZW1zW21dLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zLCBjbGFzc0xpc3QpOwoJCQkJaWYgKGZvdW5kLmxlbmd0aCkgYnJlYWsgc2VhcmNoOwoJCQl9IGVsc2UgZm9yIChtID0gMCwgbiA9IGN1cnJlbnRJdGVtcy5sZW5ndGg7IG0gPCBuOyBtKyspIHRoaXNbY29tYmluYXRvcl0oY3VycmVudEl0ZW1zW21dLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zLCBjbGFzc0xpc3QpOwoJCX0KCgkJY3VycmVudEl0ZW1zID0gdGhpcy5mb3VuZDsKCX0KCgkvLyBzaG91bGQgc29ydCBpZiB0aGVyZSBhcmUgbm9kZXMgaW4gYXBwZW5kIGFuZCBpZiB5b3UgcGFzcyBtdWx0aXBsZSBleHByZXNzaW9ucy4KCWlmIChoYXNPdGhlcnMgfHwgKHBhcnNlZC5leHByZXNzaW9ucy5sZW5ndGggPiAxKSkgdGhpcy5zb3J0KGZvdW5kKTsKCglyZXR1cm4gKGZpcnN0KSA/IChmb3VuZFswXSB8fCBudWxsKSA6IGZvdW5kOwp9OwoKLy8gVXRpbHMKCmxvY2FsLnVpZHggPSAxOwpsb2NhbC51aWRrID0gJ3NsaWNrLXVuaXF1ZWlkJzsKCmxvY2FsLmdldFVJRFhNTCA9IGZ1bmN0aW9uKG5vZGUpewoJdmFyIHVpZCA9IG5vZGUuZ2V0QXR0cmlidXRlKHRoaXMudWlkayk7CglpZiAoIXVpZCl7CgkJdWlkID0gdGhpcy51aWR4Kys7CgkJbm9kZS5zZXRBdHRyaWJ1dGUodGhpcy51aWRrLCB1aWQpOwoJfQoJcmV0dXJuIHVpZDsKfTsKCmxvY2FsLmdldFVJREhUTUwgPSBmdW5jdGlvbihub2RlKXsKCXJldHVybiBub2RlLnVuaXF1ZU51bWJlciB8fCAobm9kZS51bmlxdWVOdW1iZXIgPSB0aGlzLnVpZHgrKyk7Cn07CgovLyBzb3J0IGJhc2VkIG9uIHRoZSBzZXREb2N1bWVudCBkb2N1bWVudFNvcnRlciBtZXRob2QuCgpsb2NhbC5zb3J0ID0gZnVuY3Rpb24ocmVzdWx0cyl7CglpZiAoIXRoaXMuZG9jdW1lbnRTb3J0ZXIpIHJldHVybiByZXN1bHRzOwoJcmVzdWx0cy5zb3J0KHRoaXMuZG9jdW1lbnRTb3J0ZXIpOwoJcmV0dXJuIHJlc3VsdHM7Cn07CgovKjxwc2V1ZG8tc2VsZWN0b3JzPiovLyo8bnRoLXBzZXVkby1zZWxlY3RvcnM+Ki8KCmxvY2FsLmNhY2hlTlRIID0ge307Cgpsb2NhbC5tYXRjaE5USCA9IC9eKFsrLV0/XGQqKT8oW2Etel0rKT8oWystXVxkKyk/JC87Cgpsb2NhbC5wYXJzZU5USEFyZ3VtZW50ID0gZnVuY3Rpb24oYXJndW1lbnQpewoJdmFyIHBhcnNlZCA9IGFyZ3VtZW50Lm1hdGNoKHRoaXMubWF0Y2hOVEgpOwoJaWYgKCFwYXJzZWQpIHJldHVybiBmYWxzZTsKCXZhciBzcGVjaWFsID0gcGFyc2VkWzJdIHx8IGZhbHNlOwoJdmFyIGEgPSBwYXJzZWRbMV0gfHwgMTsKCWlmIChhID09ICctJykgYSA9IC0xOwoJdmFyIGIgPSArcGFyc2VkWzNdIHx8IDA7CglwYXJzZWQgPQoJCShzcGVjaWFsID09ICduJykJPyB7YTogYSwgYjogYn0gOgoJCShzcGVjaWFsID09ICdvZGQnKQk/IHthOiAyLCBiOiAxfSA6CgkJKHNwZWNpYWwgPT0gJ2V2ZW4nKQk/IHthOiAyLCBiOiAwfSA6IHthOiAwLCBiOiBhfTsKCglyZXR1cm4gKHRoaXMuY2FjaGVOVEhbYXJndW1lbnRdID0gcGFyc2VkKTsKfTsKCmxvY2FsLmNyZWF0ZU5USFBzZXVkbyA9IGZ1bmN0aW9uKGNoaWxkLCBzaWJsaW5nLCBwb3NpdGlvbnMsIG9mVHlwZSl7CglyZXR1cm4gZnVuY3Rpb24obm9kZSwgYXJndW1lbnQpewoJCXZhciB1aWQgPSB0aGlzLmdldFVJRChub2RlKTsKCQlpZiAoIXRoaXNbcG9zaXRpb25zXVt1aWRdKXsKCQkJdmFyIHBhcmVudCA9IG5vZGUucGFyZW50Tm9kZTsKCQkJaWYgKCFwYXJlbnQpIHJldHVybiBmYWxzZTsKCQkJdmFyIGVsID0gcGFyZW50W2NoaWxkXSwgY291bnQgPSAxOwoJCQlpZiAob2ZUeXBlKXsKCQkJCXZhciBub2RlTmFtZSA9IG5vZGUubm9kZU5hbWU7CgkJCQlkbyB7CgkJCQkJaWYgKGVsLm5vZGVOYW1lICE9IG5vZGVOYW1lKSBjb250aW51ZTsKCQkJCQl0aGlzW3Bvc2l0aW9uc11bdGhpcy5nZXRVSUQoZWwpXSA9IGNvdW50Kys7CgkJCQl9IHdoaWxlICgoZWwgPSBlbFtzaWJsaW5nXSkpOwoJCQl9IGVsc2UgewoJCQkJZG8gewoJCQkJCWlmIChlbC5ub2RlVHlwZSAhPSAxKSBjb250aW51ZTsKCQkJCQl0aGlzW3Bvc2l0aW9uc11bdGhpcy5nZXRVSUQoZWwpXSA9IGNvdW50Kys7CgkJCQl9IHdoaWxlICgoZWwgPSBlbFtzaWJsaW5nXSkpOwoJCQl9CgkJfQoJCWFyZ3VtZW50ID0gYXJndW1lbnQgfHwgJ24nOwoJCXZhciBwYXJzZWQgPSB0aGlzLmNhY2hlTlRIW2FyZ3VtZW50XSB8fCB0aGlzLnBhcnNlTlRIQXJndW1lbnQoYXJndW1lbnQpOwoJCWlmICghcGFyc2VkKSByZXR1cm4gZmFsc2U7CgkJdmFyIGEgPSBwYXJzZWQuYSwgYiA9IHBhcnNlZC5iLCBwb3MgPSB0aGlzW3Bvc2l0aW9uc11bdWlkXTsKCQlpZiAoYSA9PSAwKSByZXR1cm4gYiA9PSBwb3M7CgkJaWYgKGEgPiAwKXsKCQkJaWYgKHBvcyA8IGIpIHJldHVybiBmYWxzZTsKCQl9IGVsc2UgewoJCQlpZiAoYiA8IHBvcykgcmV0dXJuIGZhbHNlOwoJCX0KCQlyZXR1cm4gKChwb3MgLSBiKSAlIGEpID09IDA7Cgl9Owp9OwoKLyo8L250aC1wc2V1ZG8tc2VsZWN0b3JzPiovLyo8L3BzZXVkby1zZWxlY3RvcnM+Ki8KCmxvY2FsLnB1c2hBcnJheSA9IGZ1bmN0aW9uKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpewoJaWYgKHRoaXMubWF0Y2hTZWxlY3Rvcihub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKSkgdGhpcy5mb3VuZC5wdXNoKG5vZGUpOwp9OwoKbG9jYWwucHVzaFVJRCA9IGZ1bmN0aW9uKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpewoJdmFyIHVpZCA9IHRoaXMuZ2V0VUlEKG5vZGUpOwoJaWYgKCF0aGlzLnVuaXF1ZXNbdWlkXSAmJiB0aGlzLm1hdGNoU2VsZWN0b3Iobm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcykpewoJCXRoaXMudW5pcXVlc1t1aWRdID0gdHJ1ZTsKCQl0aGlzLmZvdW5kLnB1c2gobm9kZSk7Cgl9Cn07Cgpsb2NhbC5tYXRjaE5vZGUgPSBmdW5jdGlvbihub2RlLCBzZWxlY3Rvcil7CglpZiAodGhpcy5pc0hUTUxEb2N1bWVudCAmJiB0aGlzLm5hdGl2ZU1hdGNoZXNTZWxlY3Rvcil7CgkJdHJ5IHsKCQkJcmV0dXJuIHRoaXMubmF0aXZlTWF0Y2hlc1NlbGVjdG9yLmNhbGwobm9kZSwgc2VsZWN0b3IucmVwbGFjZSgvXFsoW149XSspPVxzKihbXiciXF1dKz8pXHMqXF0vZywgJ1skMT0iJDIiXScpKTsKCQl9IGNhdGNoKG1hdGNoRXJyb3IpIHt9Cgl9CgkKCXZhciBwYXJzZWQgPSB0aGlzLlNsaWNrLnBhcnNlKHNlbGVjdG9yKTsKCWlmICghcGFyc2VkKSByZXR1cm4gdHJ1ZTsKCgkvLyBzaW1wbGUgKHNpbmdsZSkgc2VsZWN0b3JzCgl2YXIgZXhwcmVzc2lvbnMgPSBwYXJzZWQuZXhwcmVzc2lvbnMsIHJldmVyc2VkRXhwcmVzc2lvbnMsIHNpbXBsZUV4cENvdW50ZXIgPSAwLCBpOwoJZm9yIChpID0gMDsgKGN1cnJlbnRFeHByZXNzaW9uID0gZXhwcmVzc2lvbnNbaV0pOyBpKyspewoJCWlmIChjdXJyZW50RXhwcmVzc2lvbi5sZW5ndGggPT0gMSl7CgkJCXZhciBleHAgPSBjdXJyZW50RXhwcmVzc2lvblswXTsKCQkJaWYgKHRoaXMubWF0Y2hTZWxlY3Rvcihub2RlLCAodGhpcy5pc1hNTERvY3VtZW50KSA/IGV4cC50YWcgOiBleHAudGFnLnRvVXBwZXJDYXNlKCksIGV4cC5pZCwgZXhwLmNsYXNzZXMsIGV4cC5hdHRyaWJ1dGVzLCBleHAucHNldWRvcykpIHJldHVybiB0cnVlOwoJCQlzaW1wbGVFeHBDb3VudGVyKys7CgkJfQoJfQoKCWlmIChzaW1wbGVFeHBDb3VudGVyID09IHBhcnNlZC5sZW5ndGgpIHJldHVybiBmYWxzZTsKCgl2YXIgbm9kZXMgPSB0aGlzLnNlYXJjaCh0aGlzLmRvY3VtZW50LCBwYXJzZWQpLCBpdGVtOwoJZm9yIChpID0gMDsgaXRlbSA9IG5vZGVzW2krK107KXsKCQlpZiAoaXRlbSA9PT0gbm9kZSkgcmV0dXJuIHRydWU7Cgl9CglyZXR1cm4gZmFsc2U7Cn07Cgpsb2NhbC5tYXRjaFBzZXVkbyA9IGZ1bmN0aW9uKG5vZGUsIG5hbWUsIGFyZ3VtZW50KXsKCXZhciBwc2V1ZG9OYW1lID0gJ3BzZXVkbzonICsgbmFtZTsKCWlmICh0aGlzW3BzZXVkb05hbWVdKSByZXR1cm4gdGhpc1twc2V1ZG9OYW1lXShub2RlLCBhcmd1bWVudCk7Cgl2YXIgYXR0cmlidXRlID0gdGhpcy5nZXRBdHRyaWJ1dGUobm9kZSwgbmFtZSk7CglyZXR1cm4gKGFyZ3VtZW50KSA/IGFyZ3VtZW50ID09IGF0dHJpYnV0ZSA6ICEhYXR0cmlidXRlOwp9OwoKbG9jYWwubWF0Y2hTZWxlY3RvciA9IGZ1bmN0aW9uKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpewoJaWYgKHRhZyl7CgkJdmFyIG5vZGVOYW1lID0gKHRoaXMuaXNYTUxEb2N1bWVudCkgPyBub2RlLm5vZGVOYW1lIDogbm9kZS5ub2RlTmFtZS50b1VwcGVyQ2FzZSgpOwoJCWlmICh0YWcgPT0gJyonKXsKCQkJaWYgKG5vZGVOYW1lIDwgJ0AnKSByZXR1cm4gZmFsc2U7IC8vIEZpeCBmb3IgY29tbWVudCBub2RlcyBhbmQgY2xvc2VkIG5vZGVzCgkJfSBlbHNlIHsKCQkJaWYgKG5vZGVOYW1lICE9IHRhZykgcmV0dXJuIGZhbHNlOwoJCX0KCX0KCglpZiAoaWQgJiYgbm9kZS5nZXRBdHRyaWJ1dGUoJ2lkJykgIT0gaWQpIHJldHVybiBmYWxzZTsKCgl2YXIgaSwgcGFydCwgY2xzOwoJaWYgKGNsYXNzZXMpIGZvciAoaSA9IGNsYXNzZXMubGVuZ3RoOyBpLS07KXsKCQljbHMgPSBub2RlLmdldEF0dHJpYnV0ZSgnY2xhc3MnKSB8fCBub2RlLmNsYXNzTmFtZTsKCQlpZiAoIShjbHMgJiYgY2xhc3Nlc1tpXS5yZWdleHAudGVzdChjbHMpKSkgcmV0dXJuIGZhbHNlOwoJfQoJaWYgKGF0dHJpYnV0ZXMpIGZvciAoaSA9IGF0dHJpYnV0ZXMubGVuZ3RoOyBpLS07KXsKCQlwYXJ0ID0gYXR0cmlidXRlc1tpXTsKCQlpZiAocGFydC5vcGVyYXRvciA/ICFwYXJ0LnRlc3QodGhpcy5nZXRBdHRyaWJ1dGUobm9kZSwgcGFydC5rZXkpKSA6ICF0aGlzLmhhc0F0dHJpYnV0ZShub2RlLCBwYXJ0LmtleSkpIHJldHVybiBmYWxzZTsKCX0KCWlmIChwc2V1ZG9zKSBmb3IgKGkgPSBwc2V1ZG9zLmxlbmd0aDsgaS0tOyl7CgkJcGFydCA9IHBzZXVkb3NbaV07CgkJaWYgKCF0aGlzLm1hdGNoUHNldWRvKG5vZGUsIHBhcnQua2V5LCBwYXJ0LnZhbHVlKSkgcmV0dXJuIGZhbHNlOwoJfQoJcmV0dXJuIHRydWU7Cn07Cgp2YXIgY29tYmluYXRvcnMgPSB7CgoJJyAnOiBmdW5jdGlvbihub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zLCBjbGFzc0xpc3QpeyAvLyBhbGwgY2hpbGQgbm9kZXMsIGFueSBsZXZlbAoKCQl2YXIgaSwgaXRlbSwgY2hpbGRyZW47CgoJCWlmICh0aGlzLmlzSFRNTERvY3VtZW50KXsKCQkJZ2V0QnlJZDogaWYgKGlkKXsKCQkJCWl0ZW0gPSB0aGlzLmRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGlkKTsKCQkJCWlmICgoIWl0ZW0gJiYgbm9kZS5hbGwpIHx8ICh0aGlzLmlkR2V0c05hbWUgJiYgaXRlbSAmJiBpdGVtLmdldEF0dHJpYnV0ZU5vZGUoJ2lkJykubm9kZVZhbHVlICE9IGlkKSl7CgkJCQkJLy8gYWxsW2lkXSByZXR1cm5zIGFsbCB0aGUgZWxlbWVudHMgd2l0aCB0aGF0IG5hbWUgb3IgaWQgaW5zaWRlIG5vZGUKCQkJCQkvLyBpZiB0aGVyZXMganVzdCBvbmUgaXQgd2lsbCByZXR1cm4gdGhlIGVsZW1lbnQsIGVsc2UgaXQgd2lsbCBiZSBhIGNvbGxlY3Rpb24KCQkJCQljaGlsZHJlbiA9IG5vZGUuYWxsW2lkXTsKCQkJCQlpZiAoIWNoaWxkcmVuKSByZXR1cm47CgkJCQkJaWYgKCFjaGlsZHJlblswXSkgY2hpbGRyZW4gPSBbY2hpbGRyZW5dOwoJCQkJCWZvciAoaSA9IDA7IGl0ZW0gPSBjaGlsZHJlbltpKytdOyl7CgkJCQkJCXZhciBpZE5vZGUgPSBpdGVtLmdldEF0dHJpYnV0ZU5vZGUoJ2lkJyk7CgkJCQkJCWlmIChpZE5vZGUgJiYgaWROb2RlLm5vZGVWYWx1ZSA9PSBpZCl7CgkJCQkJCQl0aGlzLnB1c2goaXRlbSwgdGFnLCBudWxsLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKTsKCQkJCQkJCWJyZWFrOwoJCQkJCQl9CgkJCQkJfSAKCQkJCQlyZXR1cm47CgkJCQl9CgkJCQlpZiAoIWl0ZW0pewoJCQkJCS8vIGlmIHRoZSBjb250ZXh0IGlzIGluIHRoZSBkb20gd2UgcmV0dXJuLCBlbHNlIHdlIHdpbGwgdHJ5IEdFQlROLCBicmVha2luZyB0aGUgZ2V0QnlJZCBsYWJlbAoJCQkJCWlmICh0aGlzLmNvbnRhaW5zKHRoaXMucm9vdCwgbm9kZSkpIHJldHVybjsKCQkJCQllbHNlIGJyZWFrIGdldEJ5SWQ7CgkJCQl9IGVsc2UgaWYgKHRoaXMuZG9jdW1lbnQgIT09IG5vZGUgJiYgIXRoaXMuY29udGFpbnMobm9kZSwgaXRlbSkpIHJldHVybjsKCQkJCXRoaXMucHVzaChpdGVtLCB0YWcsIG51bGwsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJCQkJcmV0dXJuOwoJCQl9CgkJCWdldEJ5Q2xhc3M6IGlmIChjbGFzc2VzICYmIG5vZGUuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSAmJiAhdGhpcy5icm9rZW5HRUJDTil7CgkJCQljaGlsZHJlbiA9IG5vZGUuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZShjbGFzc0xpc3Quam9pbignICcpKTsKCQkJCWlmICghKGNoaWxkcmVuICYmIGNoaWxkcmVuLmxlbmd0aCkpIGJyZWFrIGdldEJ5Q2xhc3M7CgkJCQlmb3IgKGkgPSAwOyBpdGVtID0gY2hpbGRyZW5baSsrXTspIHRoaXMucHVzaChpdGVtLCB0YWcsIGlkLCBudWxsLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKTsKCQkJCXJldHVybjsKCQkJfQoJCX0KCQlnZXRCeVRhZzogewoJCQljaGlsZHJlbiA9IG5vZGUuZ2V0RWxlbWVudHNCeVRhZ05hbWUodGFnKTsKCQkJaWYgKCEoY2hpbGRyZW4gJiYgY2hpbGRyZW4ubGVuZ3RoKSkgYnJlYWsgZ2V0QnlUYWc7CgkJCWlmICghdGhpcy5icm9rZW5TdGFyR0VCVE4pIHRhZyA9IG51bGw7CgkJCWZvciAoaSA9IDA7IGl0ZW0gPSBjaGlsZHJlbltpKytdOykgdGhpcy5wdXNoKGl0ZW0sIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJCX0KCX0sCgoJJz4nOiBmdW5jdGlvbihub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKXsgLy8gZGlyZWN0IGNoaWxkcmVuCgkJaWYgKChub2RlID0gbm9kZS5maXJzdENoaWxkKSkgZG8gewoJCQlpZiAobm9kZS5ub2RlVHlwZSA9PSAxKSB0aGlzLnB1c2gobm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyk7CgkJfSB3aGlsZSAoKG5vZGUgPSBub2RlLm5leHRTaWJsaW5nKSk7Cgl9LAoKCScrJzogZnVuY3Rpb24obm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyl7IC8vIG5leHQgc2libGluZwoJCXdoaWxlICgobm9kZSA9IG5vZGUubmV4dFNpYmxpbmcpKSBpZiAobm9kZS5ub2RlVHlwZSA9PSAxKXsKCQkJdGhpcy5wdXNoKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJCQlicmVhazsKCQl9Cgl9LAoKCSdeJzogZnVuY3Rpb24obm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyl7IC8vIGZpcnN0IGNoaWxkCgkJbm9kZSA9IG5vZGUuZmlyc3RDaGlsZDsKCQlpZiAobm9kZSl7CgkJCWlmIChub2RlLm5vZGVUeXBlID09IDEpIHRoaXMucHVzaChub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKTsKCQkJZWxzZSB0aGlzWydjb21iaW5hdG9yOisnXShub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKTsKCQl9Cgl9LAoKCSd+JzogZnVuY3Rpb24obm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyl7IC8vIG5leHQgc2libGluZ3MKCQl3aGlsZSAoKG5vZGUgPSBub2RlLm5leHRTaWJsaW5nKSl7CgkJCWlmIChub2RlLm5vZGVUeXBlICE9IDEpIGNvbnRpbnVlOwoJCQl2YXIgdWlkID0gdGhpcy5nZXRVSUQobm9kZSk7CgkJCWlmICh0aGlzLmJpdFVuaXF1ZXNbdWlkXSkgYnJlYWs7CgkJCXRoaXMuYml0VW5pcXVlc1t1aWRdID0gdHJ1ZTsKCQkJdGhpcy5wdXNoKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJCX0KCX0sCgoJJysrJzogZnVuY3Rpb24obm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyl7IC8vIG5leHQgc2libGluZyBhbmQgcHJldmlvdXMgc2libGluZwoJCXRoaXNbJ2NvbWJpbmF0b3I6KyddKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJCXRoaXNbJ2NvbWJpbmF0b3I6ISsnXShub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKTsKCX0sCgoJJ35+JzogZnVuY3Rpb24obm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyl7IC8vIG5leHQgc2libGluZ3MgYW5kIHByZXZpb3VzIHNpYmxpbmdzCgkJdGhpc1snY29tYmluYXRvcjp+J10obm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyk7CgkJdGhpc1snY29tYmluYXRvcjohfiddKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJfSwKCgknISc6IGZ1bmN0aW9uKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpeyAvLyBhbGwgcGFyZW50IG5vZGVzIHVwIHRvIGRvY3VtZW50CgkJd2hpbGUgKChub2RlID0gbm9kZS5wYXJlbnROb2RlKSkgaWYgKG5vZGUgIT09IHRoaXMuZG9jdW1lbnQpIHRoaXMucHVzaChub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKTsKCX0sCgoJJyE+JzogZnVuY3Rpb24obm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyl7IC8vIGRpcmVjdCBwYXJlbnQgKG9uZSBsZXZlbCkKCQlub2RlID0gbm9kZS5wYXJlbnROb2RlOwoJCWlmIChub2RlICE9PSB0aGlzLmRvY3VtZW50KSB0aGlzLnB1c2gobm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyk7Cgl9LAoKCSchKyc6IGZ1bmN0aW9uKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpeyAvLyBwcmV2aW91cyBzaWJsaW5nCgkJd2hpbGUgKChub2RlID0gbm9kZS5wcmV2aW91c1NpYmxpbmcpKSBpZiAobm9kZS5ub2RlVHlwZSA9PSAxKXsKCQkJdGhpcy5wdXNoKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJCQlicmVhazsKCQl9Cgl9LAoKCSchXic6IGZ1bmN0aW9uKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpeyAvLyBsYXN0IGNoaWxkCgkJbm9kZSA9IG5vZGUubGFzdENoaWxkOwoJCWlmIChub2RlKXsKCQkJaWYgKG5vZGUubm9kZVR5cGUgPT0gMSkgdGhpcy5wdXNoKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJCQllbHNlIHRoaXNbJ2NvbWJpbmF0b3I6ISsnXShub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKTsKCQl9Cgl9LAoKCSchfic6IGZ1bmN0aW9uKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpeyAvLyBwcmV2aW91cyBzaWJsaW5ncwoJCXdoaWxlICgobm9kZSA9IG5vZGUucHJldmlvdXNTaWJsaW5nKSl7CgkJCWlmIChub2RlLm5vZGVUeXBlICE9IDEpIGNvbnRpbnVlOwoJCQl2YXIgdWlkID0gdGhpcy5nZXRVSUQobm9kZSk7CgkJCWlmICh0aGlzLmJpdFVuaXF1ZXNbdWlkXSkgYnJlYWs7CgkJCXRoaXMuYml0VW5pcXVlc1t1aWRdID0gdHJ1ZTsKCQkJdGhpcy5wdXNoKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJCX0KCX0KCn07Cgpmb3IgKHZhciBjIGluIGNvbWJpbmF0b3JzKSBsb2NhbFsnY29tYmluYXRvcjonICsgY10gPSBjb21iaW5hdG9yc1tjXTsKCnZhciBwc2V1ZG9zID0gewoKCS8qPHBzZXVkby1zZWxlY3RvcnM+Ki8KCgknZW1wdHknOiBmdW5jdGlvbihub2RlKXsKCQl2YXIgY2hpbGQgPSBub2RlLmZpcnN0Q2hpbGQ7CgkJcmV0dXJuICEoY2hpbGQgJiYgY2hpbGQubm9kZVR5cGUgPT0gMSkgJiYgIShub2RlLmlubmVyVGV4dCB8fCBub2RlLnRleHRDb250ZW50IHx8ICcnKS5sZW5ndGg7Cgl9LAoKCSdub3QnOiBmdW5jdGlvbihub2RlLCBleHByZXNzaW9uKXsKCQlyZXR1cm4gIXRoaXMubWF0Y2hOb2RlKG5vZGUsIGV4cHJlc3Npb24pOwoJfSwKCgknY29udGFpbnMnOiBmdW5jdGlvbihub2RlLCB0ZXh0KXsKCQlyZXR1cm4gKG5vZGUuaW5uZXJUZXh0IHx8IG5vZGUudGV4dENvbnRlbnQgfHwgJycpLmluZGV4T2YodGV4dCkgPiAtMTsKCX0sCgoJJ2ZpcnN0LWNoaWxkJzogZnVuY3Rpb24obm9kZSl7CgkJd2hpbGUgKChub2RlID0gbm9kZS5wcmV2aW91c1NpYmxpbmcpKSBpZiAobm9kZS5ub2RlVHlwZSA9PSAxKSByZXR1cm4gZmFsc2U7CgkJcmV0dXJuIHRydWU7Cgl9LAoKCSdsYXN0LWNoaWxkJzogZnVuY3Rpb24obm9kZSl7CgkJd2hpbGUgKChub2RlID0gbm9kZS5uZXh0U2libGluZykpIGlmIChub2RlLm5vZGVUeXBlID09IDEpIHJldHVybiBmYWxzZTsKCQlyZXR1cm4gdHJ1ZTsKCX0sCgoJJ29ubHktY2hpbGQnOiBmdW5jdGlvbihub2RlKXsKCQl2YXIgcHJldiA9IG5vZGU7CgkJd2hpbGUgKChwcmV2ID0gcHJldi5wcmV2aW91c1NpYmxpbmcpKSBpZiAocHJldi5ub2RlVHlwZSA9PSAxKSByZXR1cm4gZmFsc2U7CgkJdmFyIG5leHQgPSBub2RlOwoJCXdoaWxlICgobmV4dCA9IG5leHQubmV4dFNpYmxpbmcpKSBpZiAobmV4dC5ub2RlVHlwZSA9PSAxKSByZXR1cm4gZmFsc2U7CgkJcmV0dXJuIHRydWU7Cgl9LAoKCS8qPG50aC1wc2V1ZG8tc2VsZWN0b3JzPiovCgoJJ250aC1jaGlsZCc6IGxvY2FsLmNyZWF0ZU5USFBzZXVkbygnZmlyc3RDaGlsZCcsICduZXh0U2libGluZycsICdwb3NOVEgnKSwKCgknbnRoLWxhc3QtY2hpbGQnOiBsb2NhbC5jcmVhdGVOVEhQc2V1ZG8oJ2xhc3RDaGlsZCcsICdwcmV2aW91c1NpYmxpbmcnLCAncG9zTlRITGFzdCcpLAoKCSdudGgtb2YtdHlwZSc6IGxvY2FsLmNyZWF0ZU5USFBzZXVkbygnZmlyc3RDaGlsZCcsICduZXh0U2libGluZycsICdwb3NOVEhUeXBlJywgdHJ1ZSksCgoJJ250aC1sYXN0LW9mLXR5cGUnOiBsb2NhbC5jcmVhdGVOVEhQc2V1ZG8oJ2xhc3RDaGlsZCcsICdwcmV2aW91c1NpYmxpbmcnLCAncG9zTlRIVHlwZUxhc3QnLCB0cnVlKSwKCgknaW5kZXgnOiBmdW5jdGlvbihub2RlLCBpbmRleCl7CgkJcmV0dXJuIHRoaXNbJ3BzZXVkbzpudGgtY2hpbGQnXShub2RlLCAnJyArIGluZGV4ICsgMSk7Cgl9LAoKCSdldmVuJzogZnVuY3Rpb24obm9kZSl7CgkJcmV0dXJuIHRoaXNbJ3BzZXVkbzpudGgtY2hpbGQnXShub2RlLCAnMm4nKTsKCX0sCgoJJ29kZCc6IGZ1bmN0aW9uKG5vZGUpewoJCXJldHVybiB0aGlzWydwc2V1ZG86bnRoLWNoaWxkJ10obm9kZSwgJzJuKzEnKTsKCX0sCgoJLyo8L250aC1wc2V1ZG8tc2VsZWN0b3JzPiovCgoJLyo8b2YtdHlwZS1wc2V1ZG8tc2VsZWN0b3JzPiovCgoJJ2ZpcnN0LW9mLXR5cGUnOiBmdW5jdGlvbihub2RlKXsKCQl2YXIgbm9kZU5hbWUgPSBub2RlLm5vZGVOYW1lOwoJCXdoaWxlICgobm9kZSA9IG5vZGUucHJldmlvdXNTaWJsaW5nKSkgaWYgKG5vZGUubm9kZU5hbWUgPT0gbm9kZU5hbWUpIHJldHVybiBmYWxzZTsKCQlyZXR1cm4gdHJ1ZTsKCX0sCgoJJ2xhc3Qtb2YtdHlwZSc6IGZ1bmN0aW9uKG5vZGUpewoJCXZhciBub2RlTmFtZSA9IG5vZGUubm9kZU5hbWU7CgkJd2hpbGUgKChub2RlID0gbm9kZS5uZXh0U2libGluZykpIGlmIChub2RlLm5vZGVOYW1lID09IG5vZGVOYW1lKSByZXR1cm4gZmFsc2U7CgkJcmV0dXJuIHRydWU7Cgl9LAoKCSdvbmx5LW9mLXR5cGUnOiBmdW5jdGlvbihub2RlKXsKCQl2YXIgcHJldiA9IG5vZGUsIG5vZGVOYW1lID0gbm9kZS5ub2RlTmFtZTsKCQl3aGlsZSAoKHByZXYgPSBwcmV2LnByZXZpb3VzU2libGluZykpIGlmIChwcmV2Lm5vZGVOYW1lID09IG5vZGVOYW1lKSByZXR1cm4gZmFsc2U7CgkJdmFyIG5leHQgPSBub2RlOwoJCXdoaWxlICgobmV4dCA9IG5leHQubmV4dFNpYmxpbmcpKSBpZiAobmV4dC5ub2RlTmFtZSA9PSBub2RlTmFtZSkgcmV0dXJuIGZhbHNlOwoJCXJldHVybiB0cnVlOwoJfSwKCgkvKjwvb2YtdHlwZS1wc2V1ZG8tc2VsZWN0b3JzPiovCgoJLy8gY3VzdG9tIHBzZXVkb3MKCgknZW5hYmxlZCc6IGZ1bmN0aW9uKG5vZGUpewoJCXJldHVybiAhbm9kZS5kaXNhYmxlZDsKCX0sCgoJJ2Rpc2FibGVkJzogZnVuY3Rpb24obm9kZSl7CgkJcmV0dXJuIG5vZGUuZGlzYWJsZWQ7Cgl9LAoKCSdjaGVja2VkJzogZnVuY3Rpb24obm9kZSl7CgkJcmV0dXJuIG5vZGUuY2hlY2tlZCB8fCBub2RlLnNlbGVjdGVkOwoJfSwKCgknZm9jdXMnOiBmdW5jdGlvbihub2RlKXsKCQlyZXR1cm4gdGhpcy5pc0hUTUxEb2N1bWVudCAmJiB0aGlzLmRvY3VtZW50LmFjdGl2ZUVsZW1lbnQgPT09IG5vZGUgJiYgKG5vZGUuaHJlZiB8fCBub2RlLnR5cGUgfHwgdGhpcy5oYXNBdHRyaWJ1dGUobm9kZSwgJ3RhYmluZGV4JykpOwoJfSwKCgkncm9vdCc6IGZ1bmN0aW9uKG5vZGUpewoJCXJldHVybiAobm9kZSA9PT0gdGhpcy5yb290KTsKCX0sCgkKCSdzZWxlY3RlZCc6IGZ1bmN0aW9uKG5vZGUpewoJCXJldHVybiBub2RlLnNlbGVjdGVkOwoJfQoKCS8qPC9wc2V1ZG8tc2VsZWN0b3JzPiovCn07Cgpmb3IgKHZhciBwIGluIHBzZXVkb3MpIGxvY2FsWydwc2V1ZG86JyArIHBdID0gcHNldWRvc1twXTsKCi8vIGF0dHJpYnV0ZXMgbWV0aG9kcwoKbG9jYWwuYXR0cmlidXRlR2V0dGVycyA9IHsKCgknY2xhc3MnOiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLmdldEF0dHJpYnV0ZSgnY2xhc3MnKSB8fCB0aGlzLmNsYXNzTmFtZTsKCX0sCgoJJ2Zvcic6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuICgnaHRtbEZvcicgaW4gdGhpcykgPyB0aGlzLmh0bWxGb3IgOiB0aGlzLmdldEF0dHJpYnV0ZSgnZm9yJyk7Cgl9LAoKCSdocmVmJzogZnVuY3Rpb24oKXsKCQlyZXR1cm4gKCdocmVmJyBpbiB0aGlzKSA/IHRoaXMuZ2V0QXR0cmlidXRlKCdocmVmJywgMikgOiB0aGlzLmdldEF0dHJpYnV0ZSgnaHJlZicpOwoJfSwKCgknc3R5bGUnOiBmdW5jdGlvbigpewoJCXJldHVybiAodGhpcy5zdHlsZSkgPyB0aGlzLnN0eWxlLmNzc1RleHQgOiB0aGlzLmdldEF0dHJpYnV0ZSgnc3R5bGUnKTsKCX0sCgkKCSd0YWJpbmRleCc6IGZ1bmN0aW9uKCl7CgkJdmFyIGF0dHJpYnV0ZU5vZGUgPSB0aGlzLmdldEF0dHJpYnV0ZU5vZGUoJ3RhYmluZGV4Jyk7CgkJcmV0dXJuIChhdHRyaWJ1dGVOb2RlICYmIGF0dHJpYnV0ZU5vZGUuc3BlY2lmaWVkKSA/IGF0dHJpYnV0ZU5vZGUubm9kZVZhbHVlIDogbnVsbDsKCX0sCgoJJ3R5cGUnOiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLmdldEF0dHJpYnV0ZSgndHlwZScpOwoJfQoKfTsKCi8vIFNsaWNrCgp2YXIgU2xpY2sgPSBsb2NhbC5TbGljayA9ICh0aGlzLlNsaWNrIHx8IHt9KTsKClNsaWNrLnZlcnNpb24gPSAnMS4xLjUnOwoKLy8gU2xpY2sgZmluZGVyCgpTbGljay5zZWFyY2ggPSBmdW5jdGlvbihjb250ZXh0LCBleHByZXNzaW9uLCBhcHBlbmQpewoJcmV0dXJuIGxvY2FsLnNlYXJjaChjb250ZXh0LCBleHByZXNzaW9uLCBhcHBlbmQpOwp9OwoKU2xpY2suZmluZCA9IGZ1bmN0aW9uKGNvbnRleHQsIGV4cHJlc3Npb24pewoJcmV0dXJuIGxvY2FsLnNlYXJjaChjb250ZXh0LCBleHByZXNzaW9uLCBudWxsLCB0cnVlKTsKfTsKCi8vIFNsaWNrIGNvbnRhaW5tZW50IGNoZWNrZXIKClNsaWNrLmNvbnRhaW5zID0gZnVuY3Rpb24oY29udGFpbmVyLCBub2RlKXsKCWxvY2FsLnNldERvY3VtZW50KGNvbnRhaW5lcik7CglyZXR1cm4gbG9jYWwuY29udGFpbnMoY29udGFpbmVyLCBub2RlKTsKfTsKCi8vIFNsaWNrIGF0dHJpYnV0ZSBnZXR0ZXIKClNsaWNrLmdldEF0dHJpYnV0ZSA9IGZ1bmN0aW9uKG5vZGUsIG5hbWUpewoJcmV0dXJuIGxvY2FsLmdldEF0dHJpYnV0ZShub2RlLCBuYW1lKTsKfTsKCi8vIFNsaWNrIG1hdGNoZXIKClNsaWNrLm1hdGNoID0gZnVuY3Rpb24obm9kZSwgc2VsZWN0b3IpewoJaWYgKCEobm9kZSAmJiBzZWxlY3RvcikpIHJldHVybiBmYWxzZTsKCWlmICghc2VsZWN0b3IgfHwgc2VsZWN0b3IgPT09IG5vZGUpIHJldHVybiB0cnVlOwoJbG9jYWwuc2V0RG9jdW1lbnQobm9kZSk7CglyZXR1cm4gbG9jYWwubWF0Y2hOb2RlKG5vZGUsIHNlbGVjdG9yKTsKfTsKCi8vIFNsaWNrIGF0dHJpYnV0ZSBhY2Nlc3NvcgoKU2xpY2suZGVmaW5lQXR0cmlidXRlR2V0dGVyID0gZnVuY3Rpb24obmFtZSwgZm4pewoJbG9jYWwuYXR0cmlidXRlR2V0dGVyc1tuYW1lXSA9IGZuOwoJcmV0dXJuIHRoaXM7Cn07CgpTbGljay5sb29rdXBBdHRyaWJ1dGVHZXR0ZXIgPSBmdW5jdGlvbihuYW1lKXsKCXJldHVybiBsb2NhbC5hdHRyaWJ1dGVHZXR0ZXJzW25hbWVdOwp9OwoKLy8gU2xpY2sgcHNldWRvIGFjY2Vzc29yCgpTbGljay5kZWZpbmVQc2V1ZG8gPSBmdW5jdGlvbihuYW1lLCBmbil7Cglsb2NhbFsncHNldWRvOicgKyBuYW1lXSA9IGZ1bmN0aW9uKG5vZGUsIGFyZ3VtZW50KXsKCQlyZXR1cm4gZm4uY2FsbChub2RlLCBhcmd1bWVudCk7Cgl9OwoJcmV0dXJuIHRoaXM7Cn07CgpTbGljay5sb29rdXBQc2V1ZG8gPSBmdW5jdGlvbihuYW1lKXsKCXZhciBwc2V1ZG8gPSBsb2NhbFsncHNldWRvOicgKyBuYW1lXTsKCWlmIChwc2V1ZG8pIHJldHVybiBmdW5jdGlvbihhcmd1bWVudCl7CgkJcmV0dXJuIHBzZXVkby5jYWxsKHRoaXMsIGFyZ3VtZW50KTsKCX07CglyZXR1cm4gbnVsbDsKfTsKCi8vIFNsaWNrIG92ZXJyaWRlcyBhY2Nlc3NvcgoKU2xpY2sub3ZlcnJpZGUgPSBmdW5jdGlvbihyZWdleHAsIGZuKXsKCWxvY2FsLm92ZXJyaWRlKHJlZ2V4cCwgZm4pOwoJcmV0dXJuIHRoaXM7Cn07CgpTbGljay5pc1hNTCA9IGxvY2FsLmlzWE1MOwoKU2xpY2sudWlkT2YgPSBmdW5jdGlvbihub2RlKXsKCXJldHVybiBsb2NhbC5nZXRVSURIVE1MKG5vZGUpOwp9OwoKaWYgKCF0aGlzLlNsaWNrKSB0aGlzLlNsaWNrID0gU2xpY2s7Cgp9KS5hcHBseSgvKjxDb21tb25KUz4qLyh0eXBlb2YgZXhwb3J0cyAhPSAndW5kZWZpbmVkJykgPyBleHBvcnRzIDogLyo8L0NvbW1vbkpTPiovdGhpcyk7CnNuYWNrLndyYXAuZGVmaW5lRW5naW5lKGZ1bmN0aW9uIChzZWxlY3RvciwgY29udGV4dCl7CiAgaWYgKHR5cGVvZiBjb250ZXh0ID09ICdzdHJpbmcnKQogICAgY29udGV4dCA9IFNsaWNrLmZpbmQoZG9jdW1lbnQsIGNvbnRleHQpCiAgcmV0dXJuIFNsaWNrLnNlYXJjaChjb250ZXh0IHx8IGRvY3VtZW50LCBzZWxlY3RvcikKfSkK",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Sat, 08 Nov 2014 04:56:39 GMT",
                    "Content-Length": "52872",
                    "Date": "Sat, 08 Nov 2014 04:56:39 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}