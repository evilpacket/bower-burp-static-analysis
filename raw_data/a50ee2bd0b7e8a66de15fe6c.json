{
    "url": "http://localhost:9999/EvanPalmer/Research/ServiceStack/TheService/packages/Microsoft.AspNet.ScriptManager.WebForms.4.5.6/content/Scripts/WebForms/WebForms.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Open redirection (DOM-based)",
    "issueType": 5243152,
    "severity": "Low",
    "confidence": "Firm",
    "issueBackground": "DOM-based open redirection vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this data into the target of a redirection in an unsafe way. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will cause a redirection to an arbitrary external domain. This behavior can be leveraged to facilitate phishing attacks against users of the application. The ability to use an authentic application URL, targeting the correct domain with a valid SSL certificate (if SSL is used) lends credibility to the phishing attack because many users, even if they verify these features, will not notice the subsequent redirection to a different domain.<br><br><b>Note:</b> If an attacker is able to control the start of the string that is passed to the redirection API, then it may be possible to escalate this vulnerability into a JavaScript injection attack, by using a URL with the javascript: pseudo-protocol to execute arbitrary script code when the URL is processed by the browser.",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based open redirection vulnerabilities is not to dynamically set redirection targets using data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing an arbitrary URL as a redirection target. In general, this is best achieved by using a whitelist of URLs that are permitted redirection targets, and strictly validating the target against this list before performing the redirection.",
    "issueDetail": "The application may be vulnerable to DOM-based open redirection. Data is read from <b>document.location.pathname</b> and written to <b>the 'open()' function of an XMLHttpRequest object</b> via the following statements:<ul><li>var action = theForm.action || document.location.pathname, fragmentIndex = action.indexOf('#');</li><li>action = action.substr(0, fragmentIndex);</li><li>action = encodeURI(path) + action.substr(queryIndex);</li><li>xmlRequest.open(\"POST\", action, true);</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/EvanPalmer/Research/ServiceStack/TheService/packages/Microsoft.AspNet.ScriptManager.WebForms.4.5.6/content/Scripts/WebForms/WebForms.js",
                "path": "/EvanPalmer/Research/ServiceStack/TheService/packages/Microsoft.AspNet.ScriptManager.WebForms.4.5.6/content/Scripts/WebForms/WebForms.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9FdmFuUGFsbWVyL1Jlc2VhcmNoL1NlcnZpY2VTdGFjay9UaGVTZXJ2aWNlL3BhY2thZ2VzL01pY3Jvc29mdC5Bc3BOZXQuU2NyaXB0TWFuYWdlci5XZWJGb3Jtcy40LjUuNi9jb250ZW50L1NjcmlwdHMvV2ViRm9ybXMvV2ViRm9ybXMuanMgSFRUUC8xLjENCkhvc3Q6IGxvY2FsaG9zdDo5OTk5DQoNCg==",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogMjE4NDANCkFjY2VwdC1SYW5nZXM6IGJ5dGVzDQpDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2phdmFzY3JpcHQNCkRhdGU6IFRodSwgMDYgTm92IDIwMTQgMTI6MDI6MDMgR01UDQpMYXN0LU1vZGlmaWVkOiBUaHUsIDA2IE5vdiAyMDE0IDEyOjAxOjU3IEdNVA0KDQovL0NkblBhdGg9aHR0cDovL2FqYXguYXNwbmV0Y2RuLmNvbS9hamF4LzQuNS82L1dlYkZvcm1zLmpzCmZ1bmN0aW9uIFdlYkZvcm1fUG9zdEJhY2tPcHRpb25zKGV2ZW50VGFyZ2V0LCBldmVudEFyZ3VtZW50LCB2YWxpZGF0aW9uLCB2YWxpZGF0aW9uR3JvdXAsIGFjdGlvblVybCwgdHJhY2tGb2N1cywgY2xpZW50U3VibWl0KSB7CiAgICB0aGlzLmV2ZW50VGFyZ2V0ID0gZXZlbnRUYXJnZXQ7CiAgICB0aGlzLmV2ZW50QXJndW1lbnQgPSBldmVudEFyZ3VtZW50OwogICAgdGhpcy52YWxpZGF0aW9uID0gdmFsaWRhdGlvbjsKICAgIHRoaXMudmFsaWRhdGlvbkdyb3VwID0gdmFsaWRhdGlvbkdyb3VwOwogICAgdGhpcy5hY3Rpb25VcmwgPSBhY3Rpb25Vcmw7CiAgICB0aGlzLnRyYWNrRm9jdXMgPSB0cmFja0ZvY3VzOwogICAgdGhpcy5jbGllbnRTdWJtaXQgPSBjbGllbnRTdWJtaXQ7Cn0KZnVuY3Rpb24gV2ViRm9ybV9Eb1Bvc3RCYWNrV2l0aE9wdGlvbnMob3B0aW9ucykgewogICAgdmFyIHZhbGlkYXRpb25SZXN1bHQgPSB0cnVlOwogICAgaWYgKG9wdGlvbnMudmFsaWRhdGlvbikgewogICAgICAgIGlmICh0eXBlb2YoUGFnZV9DbGllbnRWYWxpZGF0ZSkgPT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICB2YWxpZGF0aW9uUmVzdWx0ID0gUGFnZV9DbGllbnRWYWxpZGF0ZShvcHRpb25zLnZhbGlkYXRpb25Hcm91cCk7CiAgICAgICAgfQogICAgfQogICAgaWYgKHZhbGlkYXRpb25SZXN1bHQpIHsKICAgICAgICBpZiAoKHR5cGVvZihvcHRpb25zLmFjdGlvblVybCkgIT0gInVuZGVmaW5lZCIpICYmIChvcHRpb25zLmFjdGlvblVybCAhPSBudWxsKSAmJiAob3B0aW9ucy5hY3Rpb25VcmwubGVuZ3RoID4gMCkpIHsKICAgICAgICAgICAgdGhlRm9ybS5hY3Rpb24gPSBvcHRpb25zLmFjdGlvblVybDsKICAgICAgICB9CiAgICAgICAgaWYgKG9wdGlvbnMudHJhY2tGb2N1cykgewogICAgICAgICAgICB2YXIgbGFzdEZvY3VzID0gdGhlRm9ybS5lbGVtZW50c1siX19MQVNURk9DVVMiXTsKICAgICAgICAgICAgaWYgKCh0eXBlb2YobGFzdEZvY3VzKSAhPSAidW5kZWZpbmVkIikgJiYgKGxhc3RGb2N1cyAhPSBudWxsKSkgewogICAgICAgICAgICAgICAgaWYgKHR5cGVvZihkb2N1bWVudC5hY3RpdmVFbGVtZW50KSA9PSAidW5kZWZpbmVkIikgewogICAgICAgICAgICAgICAgICAgIGxhc3RGb2N1cy52YWx1ZSA9IG9wdGlvbnMuZXZlbnRUYXJnZXQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB2YXIgYWN0aXZlID0gZG9jdW1lbnQuYWN0aXZlRWxlbWVudDsKICAgICAgICAgICAgICAgICAgICBpZiAoKHR5cGVvZihhY3RpdmUpICE9ICJ1bmRlZmluZWQiKSAmJiAoYWN0aXZlICE9IG51bGwpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgodHlwZW9mKGFjdGl2ZS5pZCkgIT0gInVuZGVmaW5lZCIpICYmIChhY3RpdmUuaWQgIT0gbnVsbCkgJiYgKGFjdGl2ZS5pZC5sZW5ndGggPiAwKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFzdEZvY3VzLnZhbHVlID0gYWN0aXZlLmlkOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHR5cGVvZihhY3RpdmUubmFtZSkgIT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhc3RGb2N1cy52YWx1ZSA9IGFjdGl2ZS5uYW1lOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgaWYgKG9wdGlvbnMuY2xpZW50U3VibWl0KSB7CiAgICAgICAgX19kb1Bvc3RCYWNrKG9wdGlvbnMuZXZlbnRUYXJnZXQsIG9wdGlvbnMuZXZlbnRBcmd1bWVudCk7CiAgICB9Cn0KdmFyIF9fcGVuZGluZ0NhbGxiYWNrcyA9IG5ldyBBcnJheSgpOwp2YXIgX19zeW5jaHJvbm91c0NhbGxCYWNrSW5kZXggPSAtMTsKZnVuY3Rpb24gV2ViRm9ybV9Eb0NhbGxiYWNrKGV2ZW50VGFyZ2V0LCBldmVudEFyZ3VtZW50LCBldmVudENhbGxiYWNrLCBjb250ZXh0LCBlcnJvckNhbGxiYWNrLCB1c2VBc3luYykgewogICAgdmFyIHBvc3REYXRhID0gX190aGVGb3JtUG9zdERhdGEgKwogICAgICAgICAgICAgICAgIl9fQ0FMTEJBQ0tJRD0iICsgV2ViRm9ybV9FbmNvZGVDYWxsYmFjayhldmVudFRhcmdldCkgKwogICAgICAgICAgICAgICAgIiZfX0NBTExCQUNLUEFSQU09IiArIFdlYkZvcm1fRW5jb2RlQ2FsbGJhY2soZXZlbnRBcmd1bWVudCk7CiAgICBpZiAodGhlRm9ybVsiX19FVkVOVFZBTElEQVRJT04iXSkgewogICAgICAgIHBvc3REYXRhICs9ICImX19FVkVOVFZBTElEQVRJT049IiArIFdlYkZvcm1fRW5jb2RlQ2FsbGJhY2sodGhlRm9ybVsiX19FVkVOVFZBTElEQVRJT04iXS52YWx1ZSk7CiAgICB9CiAgICB2YXIgeG1sUmVxdWVzdCxlOwogICAgdHJ5IHsKICAgICAgICB4bWxSZXF1ZXN0ID0gbmV3IFhNTEh0dHBSZXF1ZXN0KCk7CiAgICB9CiAgICBjYXRjaChlKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgeG1sUmVxdWVzdCA9IG5ldyBBY3RpdmVYT2JqZWN0KCJNaWNyb3NvZnQuWE1MSFRUUCIpOwogICAgICAgIH0KICAgICAgICBjYXRjaChlKSB7CiAgICAgICAgfQogICAgfQogICAgdmFyIHNldFJlcXVlc3RIZWFkZXJNZXRob2RFeGlzdHMgPSB0cnVlOwogICAgdHJ5IHsKICAgICAgICBzZXRSZXF1ZXN0SGVhZGVyTWV0aG9kRXhpc3RzID0gKHhtbFJlcXVlc3QgJiYgeG1sUmVxdWVzdC5zZXRSZXF1ZXN0SGVhZGVyKTsKICAgIH0KICAgIGNhdGNoKGUpIHt9CiAgICB2YXIgY2FsbGJhY2sgPSBuZXcgT2JqZWN0KCk7CiAgICBjYWxsYmFjay5ldmVudENhbGxiYWNrID0gZXZlbnRDYWxsYmFjazsKICAgIGNhbGxiYWNrLmNvbnRleHQgPSBjb250ZXh0OwogICAgY2FsbGJhY2suZXJyb3JDYWxsYmFjayA9IGVycm9yQ2FsbGJhY2s7CiAgICBjYWxsYmFjay5hc3luYyA9IHVzZUFzeW5jOwogICAgdmFyIGNhbGxiYWNrSW5kZXggPSBXZWJGb3JtX0ZpbGxGaXJzdEF2YWlsYWJsZVNsb3QoX19wZW5kaW5nQ2FsbGJhY2tzLCBjYWxsYmFjayk7CiAgICBpZiAoIXVzZUFzeW5jKSB7CiAgICAgICAgaWYgKF9fc3luY2hyb25vdXNDYWxsQmFja0luZGV4ICE9IC0xKSB7CiAgICAgICAgICAgIF9fcGVuZGluZ0NhbGxiYWNrc1tfX3N5bmNocm9ub3VzQ2FsbEJhY2tJbmRleF0gPSBudWxsOwogICAgICAgIH0KICAgICAgICBfX3N5bmNocm9ub3VzQ2FsbEJhY2tJbmRleCA9IGNhbGxiYWNrSW5kZXg7CiAgICB9CiAgICBpZiAoc2V0UmVxdWVzdEhlYWRlck1ldGhvZEV4aXN0cykgewogICAgICAgIHhtbFJlcXVlc3Qub25yZWFkeXN0YXRlY2hhbmdlID0gV2ViRm9ybV9DYWxsYmFja0NvbXBsZXRlOwogICAgICAgIGNhbGxiYWNrLnhtbFJlcXVlc3QgPSB4bWxSZXF1ZXN0OwogICAgICAgIC8vIGUuZy4gaHR0cDoKICAgICAgICB2YXIgYWN0aW9uID0gdGhlRm9ybS5hY3Rpb24gfHwgZG9jdW1lbnQubG9jYXRpb24ucGF0aG5hbWUsIGZyYWdtZW50SW5kZXggPSBhY3Rpb24uaW5kZXhPZignIycpOwogICAgICAgIGlmIChmcmFnbWVudEluZGV4ICE9PSAtMSkgewogICAgICAgICAgICBhY3Rpb24gPSBhY3Rpb24uc3Vic3RyKDAsIGZyYWdtZW50SW5kZXgpOwogICAgICAgIH0KICAgICAgICBpZiAoIV9fbm9uTVNET01Ccm93c2VyKSB7CiAgICAgICAgICAgIHZhciBxdWVyeUluZGV4ID0gYWN0aW9uLmluZGV4T2YoJz8nKTsKICAgICAgICAgICAgaWYgKHF1ZXJ5SW5kZXggIT09IC0xKSB7CiAgICAgICAgICAgICAgICB2YXIgcGF0aCA9IGFjdGlvbi5zdWJzdHIoMCwgcXVlcnlJbmRleCk7CiAgICAgICAgICAgICAgICBpZiAocGF0aC5pbmRleE9mKCIlIikgPT09IC0xKSB7CiAgICAgICAgICAgICAgICAgICAgYWN0aW9uID0gZW5jb2RlVVJJKHBhdGgpICsgYWN0aW9uLnN1YnN0cihxdWVyeUluZGV4KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIGlmIChhY3Rpb24uaW5kZXhPZigiJSIpID09PSAtMSkgewogICAgICAgICAgICAgICAgYWN0aW9uID0gZW5jb2RlVVJJKGFjdGlvbik7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgeG1sUmVxdWVzdC5vcGVuKCJQT1NUIiwgYWN0aW9uLCB0cnVlKTsKICAgICAgICB4bWxSZXF1ZXN0LnNldFJlcXVlc3RIZWFkZXIoIkNvbnRlbnQtVHlwZSIsICJhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWQ7IGNoYXJzZXQ9dXRmLTgiKTsKICAgICAgICB4bWxSZXF1ZXN0LnNlbmQocG9zdERhdGEpOwogICAgICAgIHJldHVybjsKICAgIH0KICAgIGNhbGxiYWNrLnhtbFJlcXVlc3QgPSBuZXcgT2JqZWN0KCk7CiAgICB2YXIgY2FsbGJhY2tGcmFtZUlEID0gIl9fQ0FMTEJBQ0tGUkFNRSIgKyBjYWxsYmFja0luZGV4OwogICAgdmFyIHhtbFJlcXVlc3RGcmFtZSA9IGRvY3VtZW50LmZyYW1lc1tjYWxsYmFja0ZyYW1lSURdOwogICAgaWYgKCF4bWxSZXF1ZXN0RnJhbWUpIHsKICAgICAgICB4bWxSZXF1ZXN0RnJhbWUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJJRlJBTUUiKTsKICAgICAgICB4bWxSZXF1ZXN0RnJhbWUud2lkdGggPSAiMSI7CiAgICAgICAgeG1sUmVxdWVzdEZyYW1lLmhlaWdodCA9ICIxIjsKICAgICAgICB4bWxSZXF1ZXN0RnJhbWUuZnJhbWVCb3JkZXIgPSAiMCI7CiAgICAgICAgeG1sUmVxdWVzdEZyYW1lLmlkID0gY2FsbGJhY2tGcmFtZUlEOwogICAgICAgIHhtbFJlcXVlc3RGcmFtZS5uYW1lID0gY2FsbGJhY2tGcmFtZUlEOwogICAgICAgIHhtbFJlcXVlc3RGcmFtZS5zdHlsZS5wb3NpdGlvbiA9ICJhYnNvbHV0ZSI7CiAgICAgICAgeG1sUmVxdWVzdEZyYW1lLnN0eWxlLnRvcCA9ICItMTAwcHgiCiAgICAgICAgeG1sUmVxdWVzdEZyYW1lLnN0eWxlLmxlZnQgPSAiLTEwMHB4IjsKICAgICAgICB0cnkgewogICAgICAgICAgICBpZiAoY2FsbEJhY2tGcmFtZVVybCkgewogICAgICAgICAgICAgICAgeG1sUmVxdWVzdEZyYW1lLnNyYyA9IGNhbGxCYWNrRnJhbWVVcmw7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgY2F0Y2goZSkge30KICAgICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKHhtbFJlcXVlc3RGcmFtZSk7CiAgICB9CiAgICB2YXIgaW50ZXJ2YWwgPSB3aW5kb3cuc2V0SW50ZXJ2YWwoZnVuY3Rpb24oKSB7CiAgICAgICAgeG1sUmVxdWVzdEZyYW1lID0gZG9jdW1lbnQuZnJhbWVzW2NhbGxiYWNrRnJhbWVJRF07CiAgICAgICAgaWYgKHhtbFJlcXVlc3RGcmFtZSAmJiB4bWxSZXF1ZXN0RnJhbWUuZG9jdW1lbnQpIHsKICAgICAgICAgICAgd2luZG93LmNsZWFySW50ZXJ2YWwoaW50ZXJ2YWwpOwogICAgICAgICAgICB4bWxSZXF1ZXN0RnJhbWUuZG9jdW1lbnQud3JpdGUoIiIpOwogICAgICAgICAgICB4bWxSZXF1ZXN0RnJhbWUuZG9jdW1lbnQuY2xvc2UoKTsKICAgICAgICAgICAgeG1sUmVxdWVzdEZyYW1lLmRvY3VtZW50LndyaXRlKCc8aHRtbD48Ym9keT48Zm9ybSBtZXRob2Q9InBvc3QiPjxpbnB1dCB0eXBlPSJoaWRkZW4iIG5hbWU9Il9fQ0FMTEJBQ0tMT0FEU0NSSVBUIiB2YWx1ZT0idCI+PC9mb3JtPjwvYm9keT48L2h0bWw+Jyk7CiAgICAgICAgICAgIHhtbFJlcXVlc3RGcmFtZS5kb2N1bWVudC5jbG9zZSgpOwogICAgICAgICAgICB4bWxSZXF1ZXN0RnJhbWUuZG9jdW1lbnQuZm9ybXNbMF0uYWN0aW9uID0gdGhlRm9ybS5hY3Rpb247CiAgICAgICAgICAgIHZhciBjb3VudCA9IF9fdGhlRm9ybVBvc3RDb2xsZWN0aW9uLmxlbmd0aDsKICAgICAgICAgICAgdmFyIGVsZW1lbnQ7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgY291bnQ7IGkrKykgewogICAgICAgICAgICAgICAgZWxlbWVudCA9IF9fdGhlRm9ybVBvc3RDb2xsZWN0aW9uW2ldOwogICAgICAgICAgICAgICAgaWYgKGVsZW1lbnQpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgZmllbGRFbGVtZW50ID0geG1sUmVxdWVzdEZyYW1lLmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoIklOUFVUIik7CiAgICAgICAgICAgICAgICAgICAgZmllbGRFbGVtZW50LnR5cGUgPSAiaGlkZGVuIjsKICAgICAgICAgICAgICAgICAgICBmaWVsZEVsZW1lbnQubmFtZSA9IGVsZW1lbnQubmFtZTsKICAgICAgICAgICAgICAgICAgICBmaWVsZEVsZW1lbnQudmFsdWUgPSBlbGVtZW50LnZhbHVlOwogICAgICAgICAgICAgICAgICAgIHhtbFJlcXVlc3RGcmFtZS5kb2N1bWVudC5mb3Jtc1swXS5hcHBlbmRDaGlsZChmaWVsZEVsZW1lbnQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBjYWxsYmFja0lkRmllbGRFbGVtZW50ID0geG1sUmVxdWVzdEZyYW1lLmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoIklOUFVUIik7CiAgICAgICAgICAgIGNhbGxiYWNrSWRGaWVsZEVsZW1lbnQudHlwZSA9ICJoaWRkZW4iOwogICAgICAgICAgICBjYWxsYmFja0lkRmllbGRFbGVtZW50Lm5hbWUgPSAiX19DQUxMQkFDS0lEIjsKICAgICAgICAgICAgY2FsbGJhY2tJZEZpZWxkRWxlbWVudC52YWx1ZSA9IGV2ZW50VGFyZ2V0OwogICAgICAgICAgICB4bWxSZXF1ZXN0RnJhbWUuZG9jdW1lbnQuZm9ybXNbMF0uYXBwZW5kQ2hpbGQoY2FsbGJhY2tJZEZpZWxkRWxlbWVudCk7CiAgICAgICAgICAgIHZhciBjYWxsYmFja1BhcmFtRmllbGRFbGVtZW50ID0geG1sUmVxdWVzdEZyYW1lLmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoIklOUFVUIik7CiAgICAgICAgICAgIGNhbGxiYWNrUGFyYW1GaWVsZEVsZW1lbnQudHlwZSA9ICJoaWRkZW4iOwogICAgICAgICAgICBjYWxsYmFja1BhcmFtRmllbGRFbGVtZW50Lm5hbWUgPSAiX19DQUxMQkFDS1BBUkFNIjsKICAgICAgICAgICAgY2FsbGJhY2tQYXJhbUZpZWxkRWxlbWVudC52YWx1ZSA9IGV2ZW50QXJndW1lbnQ7CiAgICAgICAgICAgIHhtbFJlcXVlc3RGcmFtZS5kb2N1bWVudC5mb3Jtc1swXS5hcHBlbmRDaGlsZChjYWxsYmFja1BhcmFtRmllbGRFbGVtZW50KTsKICAgICAgICAgICAgaWYgKHRoZUZvcm1bIl9fRVZFTlRWQUxJREFUSU9OIl0pIHsKICAgICAgICAgICAgICAgIHZhciBjYWxsYmFja1ZhbGlkYXRpb25GaWVsZEVsZW1lbnQgPSB4bWxSZXF1ZXN0RnJhbWUuZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiSU5QVVQiKTsKICAgICAgICAgICAgICAgIGNhbGxiYWNrVmFsaWRhdGlvbkZpZWxkRWxlbWVudC50eXBlID0gImhpZGRlbiI7CiAgICAgICAgICAgICAgICBjYWxsYmFja1ZhbGlkYXRpb25GaWVsZEVsZW1lbnQubmFtZSA9ICJfX0VWRU5UVkFMSURBVElPTiI7CiAgICAgICAgICAgICAgICBjYWxsYmFja1ZhbGlkYXRpb25GaWVsZEVsZW1lbnQudmFsdWUgPSB0aGVGb3JtWyJfX0VWRU5UVkFMSURBVElPTiJdLnZhbHVlOwogICAgICAgICAgICAgICAgeG1sUmVxdWVzdEZyYW1lLmRvY3VtZW50LmZvcm1zWzBdLmFwcGVuZENoaWxkKGNhbGxiYWNrVmFsaWRhdGlvbkZpZWxkRWxlbWVudCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGNhbGxiYWNrSW5kZXhGaWVsZEVsZW1lbnQgPSB4bWxSZXF1ZXN0RnJhbWUuZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiSU5QVVQiKTsKICAgICAgICAgICAgY2FsbGJhY2tJbmRleEZpZWxkRWxlbWVudC50eXBlID0gImhpZGRlbiI7CiAgICAgICAgICAgIGNhbGxiYWNrSW5kZXhGaWVsZEVsZW1lbnQubmFtZSA9ICJfX0NBTExCQUNLSU5ERVgiOwogICAgICAgICAgICBjYWxsYmFja0luZGV4RmllbGRFbGVtZW50LnZhbHVlID0gY2FsbGJhY2tJbmRleDsKICAgICAgICAgICAgeG1sUmVxdWVzdEZyYW1lLmRvY3VtZW50LmZvcm1zWzBdLmFwcGVuZENoaWxkKGNhbGxiYWNrSW5kZXhGaWVsZEVsZW1lbnQpOwogICAgICAgICAgICB4bWxSZXF1ZXN0RnJhbWUuZG9jdW1lbnQuZm9ybXNbMF0uc3VibWl0KCk7CiAgICAgICAgfQogICAgfSwgMTApOwp9CmZ1bmN0aW9uIFdlYkZvcm1fQ2FsbGJhY2tDb21wbGV0ZSgpIHsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgX19wZW5kaW5nQ2FsbGJhY2tzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgY2FsbGJhY2tPYmplY3QgPSBfX3BlbmRpbmdDYWxsYmFja3NbaV07CiAgICAgICAgaWYgKGNhbGxiYWNrT2JqZWN0ICYmIGNhbGxiYWNrT2JqZWN0LnhtbFJlcXVlc3QgJiYgKGNhbGxiYWNrT2JqZWN0LnhtbFJlcXVlc3QucmVhZHlTdGF0ZSA9PSA0KSkgewogICAgICAgICAgICBpZiAoIV9fcGVuZGluZ0NhbGxiYWNrc1tpXS5hc3luYykgewogICAgICAgICAgICAgICAgX19zeW5jaHJvbm91c0NhbGxCYWNrSW5kZXggPSAtMTsKICAgICAgICAgICAgfQogICAgICAgICAgICBfX3BlbmRpbmdDYWxsYmFja3NbaV0gPSBudWxsOwogICAgICAgICAgICB2YXIgY2FsbGJhY2tGcmFtZUlEID0gIl9fQ0FMTEJBQ0tGUkFNRSIgKyBpOwogICAgICAgICAgICB2YXIgeG1sUmVxdWVzdEZyYW1lID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoY2FsbGJhY2tGcmFtZUlEKTsKICAgICAgICAgICAgaWYgKHhtbFJlcXVlc3RGcmFtZSkgewogICAgICAgICAgICAgICAgeG1sUmVxdWVzdEZyYW1lLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoeG1sUmVxdWVzdEZyYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBXZWJGb3JtX0V4ZWN1dGVDYWxsYmFjayhjYWxsYmFja09iamVjdCk7CiAgICAgICAgfQogICAgfQp9CmZ1bmN0aW9uIFdlYkZvcm1fRXhlY3V0ZUNhbGxiYWNrKGNhbGxiYWNrT2JqZWN0KSB7CiAgICB2YXIgcmVzcG9uc2UgPSBjYWxsYmFja09iamVjdC54bWxSZXF1ZXN0LnJlc3BvbnNlVGV4dDsKICAgIGlmIChyZXNwb25zZS5jaGFyQXQoMCkgPT0gInMiKSB7CiAgICAgICAgaWYgKCh0eXBlb2YoY2FsbGJhY2tPYmplY3QuZXZlbnRDYWxsYmFjaykgIT0gInVuZGVmaW5lZCIpICYmIChjYWxsYmFja09iamVjdC5ldmVudENhbGxiYWNrICE9IG51bGwpKSB7CiAgICAgICAgICAgIGNhbGxiYWNrT2JqZWN0LmV2ZW50Q2FsbGJhY2socmVzcG9uc2Uuc3Vic3RyaW5nKDEpLCBjYWxsYmFja09iamVjdC5jb250ZXh0KTsKICAgICAgICB9CiAgICB9CiAgICBlbHNlIGlmIChyZXNwb25zZS5jaGFyQXQoMCkgPT0gImUiKSB7CiAgICAgICAgaWYgKCh0eXBlb2YoY2FsbGJhY2tPYmplY3QuZXJyb3JDYWxsYmFjaykgIT0gInVuZGVmaW5lZCIpICYmIChjYWxsYmFja09iamVjdC5lcnJvckNhbGxiYWNrICE9IG51bGwpKSB7CiAgICAgICAgICAgIGNhbGxiYWNrT2JqZWN0LmVycm9yQ2FsbGJhY2socmVzcG9uc2Uuc3Vic3RyaW5nKDEpLCBjYWxsYmFja09iamVjdC5jb250ZXh0KTsKICAgICAgICB9CiAgICB9CiAgICBlbHNlIHsKICAgICAgICB2YXIgc2VwYXJhdG9ySW5kZXggPSByZXNwb25zZS5pbmRleE9mKCJ8Iik7CiAgICAgICAgaWYgKHNlcGFyYXRvckluZGV4ICE9IC0xKSB7CiAgICAgICAgICAgIHZhciB2YWxpZGF0aW9uRmllbGRMZW5ndGggPSBwYXJzZUludChyZXNwb25zZS5zdWJzdHJpbmcoMCwgc2VwYXJhdG9ySW5kZXgpKTsKICAgICAgICAgICAgaWYgKCFpc05hTih2YWxpZGF0aW9uRmllbGRMZW5ndGgpKSB7CiAgICAgICAgICAgICAgICB2YXIgdmFsaWRhdGlvbkZpZWxkID0gcmVzcG9uc2Uuc3Vic3RyaW5nKHNlcGFyYXRvckluZGV4ICsgMSwgc2VwYXJhdG9ySW5kZXggKyB2YWxpZGF0aW9uRmllbGRMZW5ndGggKyAxKTsKICAgICAgICAgICAgICAgIGlmICh2YWxpZGF0aW9uRmllbGQgIT0gIiIpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgdmFsaWRhdGlvbkZpZWxkRWxlbWVudCA9IHRoZUZvcm1bIl9fRVZFTlRWQUxJREFUSU9OIl07CiAgICAgICAgICAgICAgICAgICAgaWYgKCF2YWxpZGF0aW9uRmllbGRFbGVtZW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhbGlkYXRpb25GaWVsZEVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJJTlBVVCIpOwogICAgICAgICAgICAgICAgICAgICAgICB2YWxpZGF0aW9uRmllbGRFbGVtZW50LnR5cGUgPSAiaGlkZGVuIjsKICAgICAgICAgICAgICAgICAgICAgICAgdmFsaWRhdGlvbkZpZWxkRWxlbWVudC5uYW1lID0gIl9fRVZFTlRWQUxJREFUSU9OIjsKICAgICAgICAgICAgICAgICAgICAgICAgdGhlRm9ybS5hcHBlbmRDaGlsZCh2YWxpZGF0aW9uRmllbGRFbGVtZW50KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgdmFsaWRhdGlvbkZpZWxkRWxlbWVudC52YWx1ZSA9IHZhbGlkYXRpb25GaWVsZDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICgodHlwZW9mKGNhbGxiYWNrT2JqZWN0LmV2ZW50Q2FsbGJhY2spICE9ICJ1bmRlZmluZWQiKSAmJiAoY2FsbGJhY2tPYmplY3QuZXZlbnRDYWxsYmFjayAhPSBudWxsKSkgewogICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrT2JqZWN0LmV2ZW50Q2FsbGJhY2socmVzcG9uc2Uuc3Vic3RyaW5nKHNlcGFyYXRvckluZGV4ICsgdmFsaWRhdGlvbkZpZWxkTGVuZ3RoICsgMSksIGNhbGxiYWNrT2JqZWN0LmNvbnRleHQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQp9CmZ1bmN0aW9uIFdlYkZvcm1fRmlsbEZpcnN0QXZhaWxhYmxlU2xvdChhcnJheSwgZWxlbWVudCkgewogICAgdmFyIGk7CiAgICBmb3IgKGkgPSAwOyBpIDwgYXJyYXkubGVuZ3RoOyBpKyspIHsKICAgICAgICBpZiAoIWFycmF5W2ldKSBicmVhazsKICAgIH0KICAgIGFycmF5W2ldID0gZWxlbWVudDsKICAgIHJldHVybiBpOwp9CnZhciBfX25vbk1TRE9NQnJvd3NlciA9ICh3aW5kb3cubmF2aWdhdG9yLmFwcE5hbWUudG9Mb3dlckNhc2UoKS5pbmRleE9mKCdleHBsb3JlcicpID09IC0xKTsKdmFyIF9fdGhlRm9ybVBvc3REYXRhID0gIiI7CnZhciBfX3RoZUZvcm1Qb3N0Q29sbGVjdGlvbiA9IG5ldyBBcnJheSgpOwp2YXIgX19jYWxsYmFja1RleHRUeXBlcyA9IC9eKHRleHR8cGFzc3dvcmR8aGlkZGVufHNlYXJjaHx0ZWx8dXJsfGVtYWlsfG51bWJlcnxyYW5nZXxjb2xvcnxkYXRldGltZXxkYXRlfG1vbnRofHdlZWt8dGltZXxkYXRldGltZS1sb2NhbCkkL2k7CmZ1bmN0aW9uIFdlYkZvcm1fSW5pdENhbGxiYWNrKCkgewogICAgdmFyIGZvcm1FbGVtZW50cyA9IHRoZUZvcm0uZWxlbWVudHMsCiAgICAgICAgY291bnQgPSBmb3JtRWxlbWVudHMubGVuZ3RoLAogICAgICAgIGVsZW1lbnQ7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGNvdW50OyBpKyspIHsKICAgICAgICBlbGVtZW50ID0gZm9ybUVsZW1lbnRzW2ldOwogICAgICAgIHZhciB0YWdOYW1lID0gZWxlbWVudC50YWdOYW1lLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgaWYgKHRhZ05hbWUgPT0gImlucHV0IikgewogICAgICAgICAgICB2YXIgdHlwZSA9IGVsZW1lbnQudHlwZTsKICAgICAgICAgICAgaWYgKChfX2NhbGxiYWNrVGV4dFR5cGVzLnRlc3QodHlwZSkgfHwgKCh0eXBlID09ICJjaGVja2JveCIgfHwgdHlwZSA9PSAicmFkaW8iKSAmJiBlbGVtZW50LmNoZWNrZWQpKQogICAgICAgICAgICAgICAgJiYgKGVsZW1lbnQuaWQgIT0gIl9fRVZFTlRWQUxJREFUSU9OIikpIHsKICAgICAgICAgICAgICAgIFdlYkZvcm1fSW5pdENhbGxiYWNrQWRkRmllbGQoZWxlbWVudC5uYW1lLCBlbGVtZW50LnZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBlbHNlIGlmICh0YWdOYW1lID09ICJzZWxlY3QiKSB7CiAgICAgICAgICAgIHZhciBzZWxlY3RDb3VudCA9IGVsZW1lbnQub3B0aW9ucy5sZW5ndGg7CiAgICAgICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgc2VsZWN0Q291bnQ7IGorKykgewogICAgICAgICAgICAgICAgdmFyIHNlbGVjdENoaWxkID0gZWxlbWVudC5vcHRpb25zW2pdOwogICAgICAgICAgICAgICAgaWYgKHNlbGVjdENoaWxkLnNlbGVjdGVkID09IHRydWUpIHsKICAgICAgICAgICAgICAgICAgICBXZWJGb3JtX0luaXRDYWxsYmFja0FkZEZpZWxkKGVsZW1lbnQubmFtZSwgZWxlbWVudC52YWx1ZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAodGFnTmFtZSA9PSAidGV4dGFyZWEiKSB7CiAgICAgICAgICAgIFdlYkZvcm1fSW5pdENhbGxiYWNrQWRkRmllbGQoZWxlbWVudC5uYW1lLCBlbGVtZW50LnZhbHVlKTsKICAgICAgICB9CiAgICB9Cn0KZnVuY3Rpb24gV2ViRm9ybV9Jbml0Q2FsbGJhY2tBZGRGaWVsZChuYW1lLCB2YWx1ZSkgewogICAgdmFyIG5hbWVWYWx1ZSA9IG5ldyBPYmplY3QoKTsKICAgIG5hbWVWYWx1ZS5uYW1lID0gbmFtZTsKICAgIG5hbWVWYWx1ZS52YWx1ZSA9IHZhbHVlOwogICAgX190aGVGb3JtUG9zdENvbGxlY3Rpb25bX190aGVGb3JtUG9zdENvbGxlY3Rpb24ubGVuZ3RoXSA9IG5hbWVWYWx1ZTsKICAgIF9fdGhlRm9ybVBvc3REYXRhICs9IFdlYkZvcm1fRW5jb2RlQ2FsbGJhY2sobmFtZSkgKyAiPSIgKyBXZWJGb3JtX0VuY29kZUNhbGxiYWNrKHZhbHVlKSArICImIjsKfQpmdW5jdGlvbiBXZWJGb3JtX0VuY29kZUNhbGxiYWNrKHBhcmFtZXRlcikgewogICAgaWYgKGVuY29kZVVSSUNvbXBvbmVudCkgewogICAgICAgIHJldHVybiBlbmNvZGVVUklDb21wb25lbnQocGFyYW1ldGVyKTsKICAgIH0KICAgIGVsc2UgewogICAgICAgIHJldHVybiBlc2NhcGUocGFyYW1ldGVyKTsKICAgIH0KfQp2YXIgX19kaXNhYmxlZENvbnRyb2xBcnJheSA9IG5ldyBBcnJheSgpOwpmdW5jdGlvbiBXZWJGb3JtX1JlRW5hYmxlQ29udHJvbHMoKSB7CiAgICBpZiAodHlwZW9mKF9fZW5hYmxlZENvbnRyb2xBcnJheSkgPT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICB2YXIgZGlzYWJsZWRJbmRleCA9IDA7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IF9fZW5hYmxlZENvbnRyb2xBcnJheS5sZW5ndGg7IGkrKykgewogICAgICAgIHZhciBjOwogICAgICAgIGlmIChfX25vbk1TRE9NQnJvd3NlcikgewogICAgICAgICAgICBjID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoX19lbmFibGVkQ29udHJvbEFycmF5W2ldKTsKICAgICAgICB9CiAgICAgICAgZWxzZSB7CiAgICAgICAgICAgIGMgPSBkb2N1bWVudC5hbGxbX19lbmFibGVkQ29udHJvbEFycmF5W2ldXTsKICAgICAgICB9CiAgICAgICAgaWYgKCh0eXBlb2YoYykgIT0gInVuZGVmaW5lZCIpICYmIChjICE9IG51bGwpICYmIChjLmRpc2FibGVkID09IHRydWUpKSB7CiAgICAgICAgICAgIGMuZGlzYWJsZWQgPSBmYWxzZTsKICAgICAgICAgICAgX19kaXNhYmxlZENvbnRyb2xBcnJheVtkaXNhYmxlZEluZGV4KytdID0gYzsKICAgICAgICB9CiAgICB9CiAgICBzZXRUaW1lb3V0KCJXZWJGb3JtX1JlRGlzYWJsZUNvbnRyb2xzKCkiLCAwKTsKICAgIHJldHVybiB0cnVlOwp9CmZ1bmN0aW9uIFdlYkZvcm1fUmVEaXNhYmxlQ29udHJvbHMoKSB7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IF9fZGlzYWJsZWRDb250cm9sQXJyYXkubGVuZ3RoOyBpKyspIHsKICAgICAgICBfX2Rpc2FibGVkQ29udHJvbEFycmF5W2ldLmRpc2FibGVkID0gdHJ1ZTsKICAgIH0KfQpmdW5jdGlvbiBXZWJGb3JtX1NpbXVsYXRlQ2xpY2soZWxlbWVudCwgZXZlbnQpIHsKICAgIHZhciBjbGlja0V2ZW50OwogICAgaWYgKGVsZW1lbnQpIHsKICAgICAgICBpZiAoZWxlbWVudC5jbGljaykgewogICAgICAgICAgICBlbGVtZW50LmNsaWNrKCk7CiAgICAgICAgfSBlbHNlIHsgCiAgICAgICAgICAgIGNsaWNrRXZlbnQgPSBkb2N1bWVudC5jcmVhdGVFdmVudCgiTW91c2VFdmVudHMiKTsKICAgICAgICAgICAgY2xpY2tFdmVudC5pbml0TW91c2VFdmVudCgiY2xpY2siLCB0cnVlLCB0cnVlLCB3aW5kb3csIDAsIDAsIDAsIDAsIDAsIGZhbHNlLCBmYWxzZSwgZmFsc2UsIGZhbHNlLCAwLCBudWxsKTsKICAgICAgICAgICAgaWYgKCFlbGVtZW50LmRpc3BhdGNoRXZlbnQoY2xpY2tFdmVudCkpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGV2ZW50LmNhbmNlbEJ1YmJsZSA9IHRydWU7CiAgICAgICAgaWYgKGV2ZW50LnN0b3BQcm9wYWdhdGlvbikgewogICAgICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgcmV0dXJuIHRydWU7Cn0KZnVuY3Rpb24gV2ViRm9ybV9GaXJlRGVmYXVsdEJ1dHRvbihldmVudCwgdGFyZ2V0KSB7CiAgICBpZiAoZXZlbnQua2V5Q29kZSA9PSAxMykgewogICAgICAgIHZhciBzcmMgPSBldmVudC5zcmNFbGVtZW50IHx8IGV2ZW50LnRhcmdldDsKICAgICAgICBpZiAoc3JjICYmCiAgICAgICAgICAgICgoc3JjLnRhZ05hbWUudG9Mb3dlckNhc2UoKSA9PSAiaW5wdXQiKSAmJgogICAgICAgICAgICAgKHNyYy50eXBlLnRvTG93ZXJDYXNlKCkgPT0gInN1Ym1pdCIgfHwgc3JjLnR5cGUudG9Mb3dlckNhc2UoKSA9PSAiYnV0dG9uIikpIHx8CiAgICAgICAgICAgICgoc3JjLnRhZ05hbWUudG9Mb3dlckNhc2UoKSA9PSAiYSIpICYmCiAgICAgICAgICAgICAoc3JjLmhyZWYgIT0gbnVsbCkgJiYgKHNyYy5ocmVmICE9ICIiKSkgfHwKICAgICAgICAgICAgKHNyYy50YWdOYW1lLnRvTG93ZXJDYXNlKCkgPT0gInRleHRhcmVhIikpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIHZhciBkZWZhdWx0QnV0dG9uOwogICAgICAgIGlmIChfX25vbk1TRE9NQnJvd3NlcikgewogICAgICAgICAgICBkZWZhdWx0QnV0dG9uID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQodGFyZ2V0KTsKICAgICAgICB9CiAgICAgICAgZWxzZSB7CiAgICAgICAgICAgIGRlZmF1bHRCdXR0b24gPSBkb2N1bWVudC5hbGxbdGFyZ2V0XTsKICAgICAgICB9CiAgICAgICAgaWYgKGRlZmF1bHRCdXR0b24pIHsKICAgICAgICAgICAgcmV0dXJuIFdlYkZvcm1fU2ltdWxhdGVDbGljayhkZWZhdWx0QnV0dG9uLCBldmVudCk7CiAgICAgICAgfSAKICAgIH0KICAgIHJldHVybiB0cnVlOwp9CmZ1bmN0aW9uIFdlYkZvcm1fR2V0U2Nyb2xsWCgpIHsKICAgIGlmIChfX25vbk1TRE9NQnJvd3NlcikgewogICAgICAgIHJldHVybiB3aW5kb3cucGFnZVhPZmZzZXQ7CiAgICB9CiAgICBlbHNlIHsKICAgICAgICBpZiAoZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50ICYmIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5zY3JvbGxMZWZ0KSB7CiAgICAgICAgICAgIHJldHVybiBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuc2Nyb2xsTGVmdDsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAoZG9jdW1lbnQuYm9keSkgewogICAgICAgICAgICByZXR1cm4gZG9jdW1lbnQuYm9keS5zY3JvbGxMZWZ0OwogICAgICAgIH0KICAgIH0KICAgIHJldHVybiAwOwp9CmZ1bmN0aW9uIFdlYkZvcm1fR2V0U2Nyb2xsWSgpIHsKICAgIGlmIChfX25vbk1TRE9NQnJvd3NlcikgewogICAgICAgIHJldHVybiB3aW5kb3cucGFnZVlPZmZzZXQ7CiAgICB9CiAgICBlbHNlIHsKICAgICAgICBpZiAoZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50ICYmIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5zY3JvbGxUb3ApIHsKICAgICAgICAgICAgcmV0dXJuIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5zY3JvbGxUb3A7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKGRvY3VtZW50LmJvZHkpIHsKICAgICAgICAgICAgcmV0dXJuIGRvY3VtZW50LmJvZHkuc2Nyb2xsVG9wOwogICAgICAgIH0KICAgIH0KICAgIHJldHVybiAwOwp9CmZ1bmN0aW9uIFdlYkZvcm1fU2F2ZVNjcm9sbFBvc2l0aW9uU3VibWl0KCkgewogICAgaWYgKF9fbm9uTVNET01Ccm93c2VyKSB7CiAgICAgICAgdGhlRm9ybS5lbGVtZW50c1snX19TQ1JPTExQT1NJVElPTlknXS52YWx1ZSA9IHdpbmRvdy5wYWdlWU9mZnNldDsKICAgICAgICB0aGVGb3JtLmVsZW1lbnRzWydfX1NDUk9MTFBPU0lUSU9OWCddLnZhbHVlID0gd2luZG93LnBhZ2VYT2Zmc2V0OwogICAgfQogICAgZWxzZSB7CiAgICAgICAgdGhlRm9ybS5fX1NDUk9MTFBPU0lUSU9OWC52YWx1ZSA9IFdlYkZvcm1fR2V0U2Nyb2xsWCgpOwogICAgICAgIHRoZUZvcm0uX19TQ1JPTExQT1NJVElPTlkudmFsdWUgPSBXZWJGb3JtX0dldFNjcm9sbFkoKTsKICAgIH0KICAgIGlmICgodHlwZW9mKHRoaXMub2xkU3VibWl0KSAhPSAidW5kZWZpbmVkIikgJiYgKHRoaXMub2xkU3VibWl0ICE9IG51bGwpKSB7CiAgICAgICAgcmV0dXJuIHRoaXMub2xkU3VibWl0KCk7CiAgICB9CiAgICByZXR1cm4gdHJ1ZTsKfQpmdW5jdGlvbiBXZWJGb3JtX1NhdmVTY3JvbGxQb3NpdGlvbk9uU3VibWl0KCkgewogICAgdGhlRm9ybS5fX1NDUk9MTFBPU0lUSU9OWC52YWx1ZSA9IFdlYkZvcm1fR2V0U2Nyb2xsWCgpOwogICAgdGhlRm9ybS5fX1NDUk9MTFBPU0lUSU9OWS52YWx1ZSA9IFdlYkZvcm1fR2V0U2Nyb2xsWSgpOwogICAgaWYgKCh0eXBlb2YodGhpcy5vbGRPblN1Ym1pdCkgIT0gInVuZGVmaW5lZCIpICYmICh0aGlzLm9sZE9uU3VibWl0ICE9IG51bGwpKSB7CiAgICAgICAgcmV0dXJuIHRoaXMub2xkT25TdWJtaXQoKTsKICAgIH0KICAgIHJldHVybiB0cnVlOwp9CmZ1bmN0aW9uIFdlYkZvcm1fUmVzdG9yZVNjcm9sbFBvc2l0aW9uKCkgewogICAgaWYgKF9fbm9uTVNET01Ccm93c2VyKSB7CiAgICAgICAgd2luZG93LnNjcm9sbFRvKHRoZUZvcm0uZWxlbWVudHNbJ19fU0NST0xMUE9TSVRJT05YJ10udmFsdWUsIHRoZUZvcm0uZWxlbWVudHNbJ19fU0NST0xMUE9TSVRJT05ZJ10udmFsdWUpOwogICAgfQogICAgZWxzZSB7CiAgICAgICAgd2luZG93LnNjcm9sbFRvKHRoZUZvcm0uX19TQ1JPTExQT1NJVElPTlgudmFsdWUsIHRoZUZvcm0uX19TQ1JPTExQT1NJVElPTlkudmFsdWUpOwogICAgfQogICAgaWYgKCh0eXBlb2YodGhlRm9ybS5vbGRPbkxvYWQpICE9ICJ1bmRlZmluZWQiKSAmJiAodGhlRm9ybS5vbGRPbkxvYWQgIT0gbnVsbCkpIHsKICAgICAgICByZXR1cm4gdGhlRm9ybS5vbGRPbkxvYWQoKTsKICAgIH0KICAgIHJldHVybiB0cnVlOwp9CmZ1bmN0aW9uIFdlYkZvcm1fVGV4dEJveEtleUhhbmRsZXIoZXZlbnQpIHsKICAgIGlmIChldmVudC5rZXlDb2RlID09IDEzKSB7CiAgICAgICAgdmFyIHRhcmdldDsKICAgICAgICBpZiAoX19ub25NU0RPTUJyb3dzZXIpIHsKICAgICAgICAgICAgdGFyZ2V0ID0gZXZlbnQudGFyZ2V0OwogICAgICAgIH0KICAgICAgICBlbHNlIHsKICAgICAgICAgICAgdGFyZ2V0ID0gZXZlbnQuc3JjRWxlbWVudDsKICAgICAgICB9CiAgICAgICAgaWYgKCh0eXBlb2YodGFyZ2V0KSAhPSAidW5kZWZpbmVkIikgJiYgKHRhcmdldCAhPSBudWxsKSkgewogICAgICAgICAgICBpZiAodHlwZW9mKHRhcmdldC5vbmNoYW5nZSkgIT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgICAgIHRhcmdldC5vbmNoYW5nZSgpOwogICAgICAgICAgICAgICAgZXZlbnQuY2FuY2VsQnViYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGlmIChldmVudC5zdG9wUHJvcGFnYXRpb24pIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgcmV0dXJuIHRydWU7Cn0KZnVuY3Rpb24gV2ViRm9ybV9UcmltU3RyaW5nKHZhbHVlKSB7CiAgICByZXR1cm4gdmFsdWUucmVwbGFjZSgvXlxzK3xccyskL2csICcnKQp9CmZ1bmN0aW9uIFdlYkZvcm1fQXBwZW5kVG9DbGFzc05hbWUoZWxlbWVudCwgY2xhc3NOYW1lKSB7CiAgICB2YXIgY3VycmVudENsYXNzTmFtZSA9ICcgJyArIFdlYkZvcm1fVHJpbVN0cmluZyhlbGVtZW50LmNsYXNzTmFtZSkgKyAnICc7CiAgICBjbGFzc05hbWUgPSBXZWJGb3JtX1RyaW1TdHJpbmcoY2xhc3NOYW1lKTsKICAgIHZhciBpbmRleCA9IGN1cnJlbnRDbGFzc05hbWUuaW5kZXhPZignICcgKyBjbGFzc05hbWUgKyAnICcpOwogICAgaWYgKGluZGV4ID09PSAtMSkgewogICAgICAgIGVsZW1lbnQuY2xhc3NOYW1lID0gKGVsZW1lbnQuY2xhc3NOYW1lID09PSAnJykgPyBjbGFzc05hbWUgOiBlbGVtZW50LmNsYXNzTmFtZSArICcgJyArIGNsYXNzTmFtZTsKICAgIH0KfQpmdW5jdGlvbiBXZWJGb3JtX1JlbW92ZUNsYXNzTmFtZShlbGVtZW50LCBjbGFzc05hbWUpIHsKICAgIHZhciBjdXJyZW50Q2xhc3NOYW1lID0gJyAnICsgV2ViRm9ybV9UcmltU3RyaW5nKGVsZW1lbnQuY2xhc3NOYW1lKSArICcgJzsKICAgIGNsYXNzTmFtZSA9IFdlYkZvcm1fVHJpbVN0cmluZyhjbGFzc05hbWUpOwogICAgdmFyIGluZGV4ID0gY3VycmVudENsYXNzTmFtZS5pbmRleE9mKCcgJyArIGNsYXNzTmFtZSArICcgJyk7CiAgICBpZiAoaW5kZXggPj0gMCkgewogICAgICAgIGVsZW1lbnQuY2xhc3NOYW1lID0gV2ViRm9ybV9UcmltU3RyaW5nKGN1cnJlbnRDbGFzc05hbWUuc3Vic3RyaW5nKDAsIGluZGV4KSArICcgJyArCiAgICAgICAgICAgIGN1cnJlbnRDbGFzc05hbWUuc3Vic3RyaW5nKGluZGV4ICsgY2xhc3NOYW1lLmxlbmd0aCArIDEsIGN1cnJlbnRDbGFzc05hbWUubGVuZ3RoKSk7CiAgICB9Cn0KZnVuY3Rpb24gV2ViRm9ybV9HZXRFbGVtZW50QnlJZChlbGVtZW50SWQpIHsKICAgIGlmIChkb2N1bWVudC5nZXRFbGVtZW50QnlJZCkgewogICAgICAgIHJldHVybiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChlbGVtZW50SWQpOwogICAgfQogICAgZWxzZSBpZiAoZG9jdW1lbnQuYWxsKSB7CiAgICAgICAgcmV0dXJuIGRvY3VtZW50LmFsbFtlbGVtZW50SWRdOwogICAgfQogICAgZWxzZSByZXR1cm4gbnVsbDsKfQpmdW5jdGlvbiBXZWJGb3JtX0dldEVsZW1lbnRCeVRhZ05hbWUoZWxlbWVudCwgdGFnTmFtZSkgewogICAgdmFyIGVsZW1lbnRzID0gV2ViRm9ybV9HZXRFbGVtZW50c0J5VGFnTmFtZShlbGVtZW50LCB0YWdOYW1lKTsKICAgIGlmIChlbGVtZW50cyAmJiBlbGVtZW50cy5sZW5ndGggPiAwKSB7CiAgICAgICAgcmV0dXJuIGVsZW1lbnRzWzBdOwogICAgfQogICAgZWxzZSByZXR1cm4gbnVsbDsKfQpmdW5jdGlvbiBXZWJGb3JtX0dldEVsZW1lbnRzQnlUYWdOYW1lKGVsZW1lbnQsIHRhZ05hbWUpIHsKICAgIGlmIChlbGVtZW50ICYmIHRhZ05hbWUpIHsKICAgICAgICBpZiAoZWxlbWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSkgewogICAgICAgICAgICByZXR1cm4gZWxlbWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSh0YWdOYW1lKTsKICAgICAgICB9CiAgICAgICAgaWYgKGVsZW1lbnQuYWxsICYmIGVsZW1lbnQuYWxsLnRhZ3MpIHsKICAgICAgICAgICAgcmV0dXJuIGVsZW1lbnQuYWxsLnRhZ3ModGFnTmFtZSk7CiAgICAgICAgfQogICAgfQogICAgcmV0dXJuIG51bGw7Cn0KZnVuY3Rpb24gV2ViRm9ybV9HZXRFbGVtZW50RGlyKGVsZW1lbnQpIHsKICAgIGlmIChlbGVtZW50KSB7CiAgICAgICAgaWYgKGVsZW1lbnQuZGlyKSB7CiAgICAgICAgICAgIHJldHVybiBlbGVtZW50LmRpcjsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIFdlYkZvcm1fR2V0RWxlbWVudERpcihlbGVtZW50LnBhcmVudE5vZGUpOwogICAgfQogICAgcmV0dXJuICJsdHIiOwp9CmZ1bmN0aW9uIFdlYkZvcm1fR2V0RWxlbWVudFBvc2l0aW9uKGVsZW1lbnQpIHsKICAgIHZhciByZXN1bHQgPSBuZXcgT2JqZWN0KCk7CiAgICByZXN1bHQueCA9IDA7CiAgICByZXN1bHQueSA9IDA7CiAgICByZXN1bHQud2lkdGggPSAwOwogICAgcmVzdWx0LmhlaWdodCA9IDA7CiAgICBpZiAoZWxlbWVudC5vZmZzZXRQYXJlbnQpIHsKICAgICAgICByZXN1bHQueCA9IGVsZW1lbnQub2Zmc2V0TGVmdDsKICAgICAgICByZXN1bHQueSA9IGVsZW1lbnQub2Zmc2V0VG9wOwogICAgICAgIHZhciBwYXJlbnQgPSBlbGVtZW50Lm9mZnNldFBhcmVudDsKICAgICAgICB3aGlsZSAocGFyZW50KSB7CiAgICAgICAgICAgIHJlc3VsdC54ICs9IHBhcmVudC5vZmZzZXRMZWZ0OwogICAgICAgICAgICByZXN1bHQueSArPSBwYXJlbnQub2Zmc2V0VG9wOwogICAgICAgICAgICB2YXIgcGFyZW50VGFnTmFtZSA9IHBhcmVudC50YWdOYW1lLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgIGlmIChwYXJlbnRUYWdOYW1lICE9ICJ0YWJsZSIgJiYKICAgICAgICAgICAgICAgIHBhcmVudFRhZ05hbWUgIT0gImJvZHkiICYmIAogICAgICAgICAgICAgICAgcGFyZW50VGFnTmFtZSAhPSAiaHRtbCIgJiYgCiAgICAgICAgICAgICAgICBwYXJlbnRUYWdOYW1lICE9ICJkaXYiICYmIAogICAgICAgICAgICAgICAgcGFyZW50LmNsaWVudFRvcCAmJiAKICAgICAgICAgICAgICAgIHBhcmVudC5jbGllbnRMZWZ0KSB7CiAgICAgICAgICAgICAgICByZXN1bHQueCArPSBwYXJlbnQuY2xpZW50TGVmdDsKICAgICAgICAgICAgICAgIHJlc3VsdC55ICs9IHBhcmVudC5jbGllbnRUb3A7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcGFyZW50ID0gcGFyZW50Lm9mZnNldFBhcmVudDsKICAgICAgICB9CiAgICB9CiAgICBlbHNlIGlmIChlbGVtZW50LmxlZnQgJiYgZWxlbWVudC50b3ApIHsKICAgICAgICByZXN1bHQueCA9IGVsZW1lbnQubGVmdDsKICAgICAgICByZXN1bHQueSA9IGVsZW1lbnQudG9wOwogICAgfQogICAgZWxzZSB7CiAgICAgICAgaWYgKGVsZW1lbnQueCkgewogICAgICAgICAgICByZXN1bHQueCA9IGVsZW1lbnQueDsKICAgICAgICB9CiAgICAgICAgaWYgKGVsZW1lbnQueSkgewogICAgICAgICAgICByZXN1bHQueSA9IGVsZW1lbnQueTsKICAgICAgICB9CiAgICB9CiAgICBpZiAoZWxlbWVudC5vZmZzZXRXaWR0aCAmJiBlbGVtZW50Lm9mZnNldEhlaWdodCkgewogICAgICAgIHJlc3VsdC53aWR0aCA9IGVsZW1lbnQub2Zmc2V0V2lkdGg7CiAgICAgICAgcmVzdWx0LmhlaWdodCA9IGVsZW1lbnQub2Zmc2V0SGVpZ2h0OwogICAgfQogICAgZWxzZSBpZiAoZWxlbWVudC5zdHlsZSAmJiBlbGVtZW50LnN0eWxlLnBpeGVsV2lkdGggJiYgZWxlbWVudC5zdHlsZS5waXhlbEhlaWdodCkgewogICAgICAgIHJlc3VsdC53aWR0aCA9IGVsZW1lbnQuc3R5bGUucGl4ZWxXaWR0aDsKICAgICAgICByZXN1bHQuaGVpZ2h0ID0gZWxlbWVudC5zdHlsZS5waXhlbEhlaWdodDsKICAgIH0KICAgIHJldHVybiByZXN1bHQ7Cn0KZnVuY3Rpb24gV2ViRm9ybV9HZXRQYXJlbnRCeVRhZ05hbWUoZWxlbWVudCwgdGFnTmFtZSkgewogICAgdmFyIHBhcmVudCA9IGVsZW1lbnQucGFyZW50Tm9kZTsKICAgIHZhciB1cHBlclRhZ05hbWUgPSB0YWdOYW1lLnRvVXBwZXJDYXNlKCk7CiAgICB3aGlsZSAocGFyZW50ICYmIChwYXJlbnQudGFnTmFtZS50b1VwcGVyQ2FzZSgpICE9IHVwcGVyVGFnTmFtZSkpIHsKICAgICAgICBwYXJlbnQgPSBwYXJlbnQucGFyZW50Tm9kZSA/IHBhcmVudC5wYXJlbnROb2RlIDogcGFyZW50LnBhcmVudEVsZW1lbnQ7CiAgICB9CiAgICByZXR1cm4gcGFyZW50Owp9CmZ1bmN0aW9uIFdlYkZvcm1fU2V0RWxlbWVudEhlaWdodChlbGVtZW50LCBoZWlnaHQpIHsKICAgIGlmIChlbGVtZW50ICYmIGVsZW1lbnQuc3R5bGUpIHsKICAgICAgICBlbGVtZW50LnN0eWxlLmhlaWdodCA9IGhlaWdodCArICJweCI7CiAgICB9Cn0KZnVuY3Rpb24gV2ViRm9ybV9TZXRFbGVtZW50V2lkdGgoZWxlbWVudCwgd2lkdGgpIHsKICAgIGlmIChlbGVtZW50ICYmIGVsZW1lbnQuc3R5bGUpIHsKICAgICAgICBlbGVtZW50LnN0eWxlLndpZHRoID0gd2lkdGggKyAicHgiOwogICAgfQp9CmZ1bmN0aW9uIFdlYkZvcm1fU2V0RWxlbWVudFgoZWxlbWVudCwgeCkgewogICAgaWYgKGVsZW1lbnQgJiYgZWxlbWVudC5zdHlsZSkgewogICAgICAgIGVsZW1lbnQuc3R5bGUubGVmdCA9IHggKyAicHgiOwogICAgfQp9CmZ1bmN0aW9uIFdlYkZvcm1fU2V0RWxlbWVudFkoZWxlbWVudCwgeSkgewogICAgaWYgKGVsZW1lbnQgJiYgZWxlbWVudC5zdHlsZSkgewogICAgICAgIGVsZW1lbnQuc3R5bGUudG9wID0geSArICJweCI7CiAgICB9Cn0=",
                "body": "Ly9DZG5QYXRoPWh0dHA6Ly9hamF4LmFzcG5ldGNkbi5jb20vYWpheC80LjUvNi9XZWJGb3Jtcy5qcwpmdW5jdGlvbiBXZWJGb3JtX1Bvc3RCYWNrT3B0aW9ucyhldmVudFRhcmdldCwgZXZlbnRBcmd1bWVudCwgdmFsaWRhdGlvbiwgdmFsaWRhdGlvbkdyb3VwLCBhY3Rpb25VcmwsIHRyYWNrRm9jdXMsIGNsaWVudFN1Ym1pdCkgewogICAgdGhpcy5ldmVudFRhcmdldCA9IGV2ZW50VGFyZ2V0OwogICAgdGhpcy5ldmVudEFyZ3VtZW50ID0gZXZlbnRBcmd1bWVudDsKICAgIHRoaXMudmFsaWRhdGlvbiA9IHZhbGlkYXRpb247CiAgICB0aGlzLnZhbGlkYXRpb25Hcm91cCA9IHZhbGlkYXRpb25Hcm91cDsKICAgIHRoaXMuYWN0aW9uVXJsID0gYWN0aW9uVXJsOwogICAgdGhpcy50cmFja0ZvY3VzID0gdHJhY2tGb2N1czsKICAgIHRoaXMuY2xpZW50U3VibWl0ID0gY2xpZW50U3VibWl0Owp9CmZ1bmN0aW9uIFdlYkZvcm1fRG9Qb3N0QmFja1dpdGhPcHRpb25zKG9wdGlvbnMpIHsKICAgIHZhciB2YWxpZGF0aW9uUmVzdWx0ID0gdHJ1ZTsKICAgIGlmIChvcHRpb25zLnZhbGlkYXRpb24pIHsKICAgICAgICBpZiAodHlwZW9mKFBhZ2VfQ2xpZW50VmFsaWRhdGUpID09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgdmFsaWRhdGlvblJlc3VsdCA9IFBhZ2VfQ2xpZW50VmFsaWRhdGUob3B0aW9ucy52YWxpZGF0aW9uR3JvdXApOwogICAgICAgIH0KICAgIH0KICAgIGlmICh2YWxpZGF0aW9uUmVzdWx0KSB7CiAgICAgICAgaWYgKCh0eXBlb2Yob3B0aW9ucy5hY3Rpb25VcmwpICE9ICJ1bmRlZmluZWQiKSAmJiAob3B0aW9ucy5hY3Rpb25VcmwgIT0gbnVsbCkgJiYgKG9wdGlvbnMuYWN0aW9uVXJsLmxlbmd0aCA+IDApKSB7CiAgICAgICAgICAgIHRoZUZvcm0uYWN0aW9uID0gb3B0aW9ucy5hY3Rpb25Vcmw7CiAgICAgICAgfQogICAgICAgIGlmIChvcHRpb25zLnRyYWNrRm9jdXMpIHsKICAgICAgICAgICAgdmFyIGxhc3RGb2N1cyA9IHRoZUZvcm0uZWxlbWVudHNbIl9fTEFTVEZPQ1VTIl07CiAgICAgICAgICAgIGlmICgodHlwZW9mKGxhc3RGb2N1cykgIT0gInVuZGVmaW5lZCIpICYmIChsYXN0Rm9jdXMgIT0gbnVsbCkpIHsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YoZG9jdW1lbnQuYWN0aXZlRWxlbWVudCkgPT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgICAgICAgICBsYXN0Rm9jdXMudmFsdWUgPSBvcHRpb25zLmV2ZW50VGFyZ2V0OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGFjdGl2ZSA9IGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQ7CiAgICAgICAgICAgICAgICAgICAgaWYgKCh0eXBlb2YoYWN0aXZlKSAhPSAidW5kZWZpbmVkIikgJiYgKGFjdGl2ZSAhPSBudWxsKSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoKHR5cGVvZihhY3RpdmUuaWQpICE9ICJ1bmRlZmluZWQiKSAmJiAoYWN0aXZlLmlkICE9IG51bGwpICYmIChhY3RpdmUuaWQubGVuZ3RoID4gMCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhc3RGb2N1cy52YWx1ZSA9IGFjdGl2ZS5pZDsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICh0eXBlb2YoYWN0aXZlLm5hbWUpICE9ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYXN0Rm9jdXMudmFsdWUgPSBhY3RpdmUubmFtZTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgIGlmIChvcHRpb25zLmNsaWVudFN1Ym1pdCkgewogICAgICAgIF9fZG9Qb3N0QmFjayhvcHRpb25zLmV2ZW50VGFyZ2V0LCBvcHRpb25zLmV2ZW50QXJndW1lbnQpOwogICAgfQp9CnZhciBfX3BlbmRpbmdDYWxsYmFja3MgPSBuZXcgQXJyYXkoKTsKdmFyIF9fc3luY2hyb25vdXNDYWxsQmFja0luZGV4ID0gLTE7CmZ1bmN0aW9uIFdlYkZvcm1fRG9DYWxsYmFjayhldmVudFRhcmdldCwgZXZlbnRBcmd1bWVudCwgZXZlbnRDYWxsYmFjaywgY29udGV4dCwgZXJyb3JDYWxsYmFjaywgdXNlQXN5bmMpIHsKICAgIHZhciBwb3N0RGF0YSA9IF9fdGhlRm9ybVBvc3REYXRhICsKICAgICAgICAgICAgICAgICJfX0NBTExCQUNLSUQ9IiArIFdlYkZvcm1fRW5jb2RlQ2FsbGJhY2soZXZlbnRUYXJnZXQpICsKICAgICAgICAgICAgICAgICImX19DQUxMQkFDS1BBUkFNPSIgKyBXZWJGb3JtX0VuY29kZUNhbGxiYWNrKGV2ZW50QXJndW1lbnQpOwogICAgaWYgKHRoZUZvcm1bIl9fRVZFTlRWQUxJREFUSU9OIl0pIHsKICAgICAgICBwb3N0RGF0YSArPSAiJl9fRVZFTlRWQUxJREFUSU9OPSIgKyBXZWJGb3JtX0VuY29kZUNhbGxiYWNrKHRoZUZvcm1bIl9fRVZFTlRWQUxJREFUSU9OIl0udmFsdWUpOwogICAgfQogICAgdmFyIHhtbFJlcXVlc3QsZTsKICAgIHRyeSB7CiAgICAgICAgeG1sUmVxdWVzdCA9IG5ldyBYTUxIdHRwUmVxdWVzdCgpOwogICAgfQogICAgY2F0Y2goZSkgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIHhtbFJlcXVlc3QgPSBuZXcgQWN0aXZlWE9iamVjdCgiTWljcm9zb2Z0LlhNTEhUVFAiKTsKICAgICAgICB9CiAgICAgICAgY2F0Y2goZSkgewogICAgICAgIH0KICAgIH0KICAgIHZhciBzZXRSZXF1ZXN0SGVhZGVyTWV0aG9kRXhpc3RzID0gdHJ1ZTsKICAgIHRyeSB7CiAgICAgICAgc2V0UmVxdWVzdEhlYWRlck1ldGhvZEV4aXN0cyA9ICh4bWxSZXF1ZXN0ICYmIHhtbFJlcXVlc3Quc2V0UmVxdWVzdEhlYWRlcik7CiAgICB9CiAgICBjYXRjaChlKSB7fQogICAgdmFyIGNhbGxiYWNrID0gbmV3IE9iamVjdCgpOwogICAgY2FsbGJhY2suZXZlbnRDYWxsYmFjayA9IGV2ZW50Q2FsbGJhY2s7CiAgICBjYWxsYmFjay5jb250ZXh0ID0gY29udGV4dDsKICAgIGNhbGxiYWNrLmVycm9yQ2FsbGJhY2sgPSBlcnJvckNhbGxiYWNrOwogICAgY2FsbGJhY2suYXN5bmMgPSB1c2VBc3luYzsKICAgIHZhciBjYWxsYmFja0luZGV4ID0gV2ViRm9ybV9GaWxsRmlyc3RBdmFpbGFibGVTbG90KF9fcGVuZGluZ0NhbGxiYWNrcywgY2FsbGJhY2spOwogICAgaWYgKCF1c2VBc3luYykgewogICAgICAgIGlmIChfX3N5bmNocm9ub3VzQ2FsbEJhY2tJbmRleCAhPSAtMSkgewogICAgICAgICAgICBfX3BlbmRpbmdDYWxsYmFja3NbX19zeW5jaHJvbm91c0NhbGxCYWNrSW5kZXhdID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgX19zeW5jaHJvbm91c0NhbGxCYWNrSW5kZXggPSBjYWxsYmFja0luZGV4OwogICAgfQogICAgaWYgKHNldFJlcXVlc3RIZWFkZXJNZXRob2RFeGlzdHMpIHsKICAgICAgICB4bWxSZXF1ZXN0Lm9ucmVhZHlzdGF0ZWNoYW5nZSA9IFdlYkZvcm1fQ2FsbGJhY2tDb21wbGV0ZTsKICAgICAgICBjYWxsYmFjay54bWxSZXF1ZXN0ID0geG1sUmVxdWVzdDsKICAgICAgICAvLyBlLmcuIGh0dHA6CiAgICAgICAgdmFyIGFjdGlvbiA9IHRoZUZvcm0uYWN0aW9uIHx8IGRvY3VtZW50LmxvY2F0aW9uLnBhdGhuYW1lLCBmcmFnbWVudEluZGV4ID0gYWN0aW9uLmluZGV4T2YoJyMnKTsKICAgICAgICBpZiAoZnJhZ21lbnRJbmRleCAhPT0gLTEpIHsKICAgICAgICAgICAgYWN0aW9uID0gYWN0aW9uLnN1YnN0cigwLCBmcmFnbWVudEluZGV4KTsKICAgICAgICB9CiAgICAgICAgaWYgKCFfX25vbk1TRE9NQnJvd3NlcikgewogICAgICAgICAgICB2YXIgcXVlcnlJbmRleCA9IGFjdGlvbi5pbmRleE9mKCc/Jyk7CiAgICAgICAgICAgIGlmIChxdWVyeUluZGV4ICE9PSAtMSkgewogICAgICAgICAgICAgICAgdmFyIHBhdGggPSBhY3Rpb24uc3Vic3RyKDAsIHF1ZXJ5SW5kZXgpOwogICAgICAgICAgICAgICAgaWYgKHBhdGguaW5kZXhPZigiJSIpID09PSAtMSkgewogICAgICAgICAgICAgICAgICAgIGFjdGlvbiA9IGVuY29kZVVSSShwYXRoKSArIGFjdGlvbi5zdWJzdHIocXVlcnlJbmRleCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSBpZiAoYWN0aW9uLmluZGV4T2YoIiUiKSA9PT0gLTEpIHsKICAgICAgICAgICAgICAgIGFjdGlvbiA9IGVuY29kZVVSSShhY3Rpb24pOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHhtbFJlcXVlc3Qub3BlbigiUE9TVCIsIGFjdGlvbiwgdHJ1ZSk7CiAgICAgICAgeG1sUmVxdWVzdC5zZXRSZXF1ZXN0SGVhZGVyKCJDb250ZW50LVR5cGUiLCAiYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkOyBjaGFyc2V0PXV0Zi04Iik7CiAgICAgICAgeG1sUmVxdWVzdC5zZW5kKHBvc3REYXRhKTsKICAgICAgICByZXR1cm47CiAgICB9CiAgICBjYWxsYmFjay54bWxSZXF1ZXN0ID0gbmV3IE9iamVjdCgpOwogICAgdmFyIGNhbGxiYWNrRnJhbWVJRCA9ICJfX0NBTExCQUNLRlJBTUUiICsgY2FsbGJhY2tJbmRleDsKICAgIHZhciB4bWxSZXF1ZXN0RnJhbWUgPSBkb2N1bWVudC5mcmFtZXNbY2FsbGJhY2tGcmFtZUlEXTsKICAgIGlmICgheG1sUmVxdWVzdEZyYW1lKSB7CiAgICAgICAgeG1sUmVxdWVzdEZyYW1lID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiSUZSQU1FIik7CiAgICAgICAgeG1sUmVxdWVzdEZyYW1lLndpZHRoID0gIjEiOwogICAgICAgIHhtbFJlcXVlc3RGcmFtZS5oZWlnaHQgPSAiMSI7CiAgICAgICAgeG1sUmVxdWVzdEZyYW1lLmZyYW1lQm9yZGVyID0gIjAiOwogICAgICAgIHhtbFJlcXVlc3RGcmFtZS5pZCA9IGNhbGxiYWNrRnJhbWVJRDsKICAgICAgICB4bWxSZXF1ZXN0RnJhbWUubmFtZSA9IGNhbGxiYWNrRnJhbWVJRDsKICAgICAgICB4bWxSZXF1ZXN0RnJhbWUuc3R5bGUucG9zaXRpb24gPSAiYWJzb2x1dGUiOwogICAgICAgIHhtbFJlcXVlc3RGcmFtZS5zdHlsZS50b3AgPSAiLTEwMHB4IgogICAgICAgIHhtbFJlcXVlc3RGcmFtZS5zdHlsZS5sZWZ0ID0gIi0xMDBweCI7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgaWYgKGNhbGxCYWNrRnJhbWVVcmwpIHsKICAgICAgICAgICAgICAgIHhtbFJlcXVlc3RGcmFtZS5zcmMgPSBjYWxsQmFja0ZyYW1lVXJsOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGNhdGNoKGUpIHt9CiAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZCh4bWxSZXF1ZXN0RnJhbWUpOwogICAgfQogICAgdmFyIGludGVydmFsID0gd2luZG93LnNldEludGVydmFsKGZ1bmN0aW9uKCkgewogICAgICAgIHhtbFJlcXVlc3RGcmFtZSA9IGRvY3VtZW50LmZyYW1lc1tjYWxsYmFja0ZyYW1lSURdOwogICAgICAgIGlmICh4bWxSZXF1ZXN0RnJhbWUgJiYgeG1sUmVxdWVzdEZyYW1lLmRvY3VtZW50KSB7CiAgICAgICAgICAgIHdpbmRvdy5jbGVhckludGVydmFsKGludGVydmFsKTsKICAgICAgICAgICAgeG1sUmVxdWVzdEZyYW1lLmRvY3VtZW50LndyaXRlKCIiKTsKICAgICAgICAgICAgeG1sUmVxdWVzdEZyYW1lLmRvY3VtZW50LmNsb3NlKCk7CiAgICAgICAgICAgIHhtbFJlcXVlc3RGcmFtZS5kb2N1bWVudC53cml0ZSgnPGh0bWw+PGJvZHk+PGZvcm0gbWV0aG9kPSJwb3N0Ij48aW5wdXQgdHlwZT0iaGlkZGVuIiBuYW1lPSJfX0NBTExCQUNLTE9BRFNDUklQVCIgdmFsdWU9InQiPjwvZm9ybT48L2JvZHk+PC9odG1sPicpOwogICAgICAgICAgICB4bWxSZXF1ZXN0RnJhbWUuZG9jdW1lbnQuY2xvc2UoKTsKICAgICAgICAgICAgeG1sUmVxdWVzdEZyYW1lLmRvY3VtZW50LmZvcm1zWzBdLmFjdGlvbiA9IHRoZUZvcm0uYWN0aW9uOwogICAgICAgICAgICB2YXIgY291bnQgPSBfX3RoZUZvcm1Qb3N0Q29sbGVjdGlvbi5sZW5ndGg7CiAgICAgICAgICAgIHZhciBlbGVtZW50OwogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGNvdW50OyBpKyspIHsKICAgICAgICAgICAgICAgIGVsZW1lbnQgPSBfX3RoZUZvcm1Qb3N0Q29sbGVjdGlvbltpXTsKICAgICAgICAgICAgICAgIGlmIChlbGVtZW50KSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGZpZWxkRWxlbWVudCA9IHhtbFJlcXVlc3RGcmFtZS5kb2N1bWVudC5jcmVhdGVFbGVtZW50KCJJTlBVVCIpOwogICAgICAgICAgICAgICAgICAgIGZpZWxkRWxlbWVudC50eXBlID0gImhpZGRlbiI7CiAgICAgICAgICAgICAgICAgICAgZmllbGRFbGVtZW50Lm5hbWUgPSBlbGVtZW50Lm5hbWU7CiAgICAgICAgICAgICAgICAgICAgZmllbGRFbGVtZW50LnZhbHVlID0gZWxlbWVudC52YWx1ZTsKICAgICAgICAgICAgICAgICAgICB4bWxSZXF1ZXN0RnJhbWUuZG9jdW1lbnQuZm9ybXNbMF0uYXBwZW5kQ2hpbGQoZmllbGRFbGVtZW50KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgY2FsbGJhY2tJZEZpZWxkRWxlbWVudCA9IHhtbFJlcXVlc3RGcmFtZS5kb2N1bWVudC5jcmVhdGVFbGVtZW50KCJJTlBVVCIpOwogICAgICAgICAgICBjYWxsYmFja0lkRmllbGRFbGVtZW50LnR5cGUgPSAiaGlkZGVuIjsKICAgICAgICAgICAgY2FsbGJhY2tJZEZpZWxkRWxlbWVudC5uYW1lID0gIl9fQ0FMTEJBQ0tJRCI7CiAgICAgICAgICAgIGNhbGxiYWNrSWRGaWVsZEVsZW1lbnQudmFsdWUgPSBldmVudFRhcmdldDsKICAgICAgICAgICAgeG1sUmVxdWVzdEZyYW1lLmRvY3VtZW50LmZvcm1zWzBdLmFwcGVuZENoaWxkKGNhbGxiYWNrSWRGaWVsZEVsZW1lbnQpOwogICAgICAgICAgICB2YXIgY2FsbGJhY2tQYXJhbUZpZWxkRWxlbWVudCA9IHhtbFJlcXVlc3RGcmFtZS5kb2N1bWVudC5jcmVhdGVFbGVtZW50KCJJTlBVVCIpOwogICAgICAgICAgICBjYWxsYmFja1BhcmFtRmllbGRFbGVtZW50LnR5cGUgPSAiaGlkZGVuIjsKICAgICAgICAgICAgY2FsbGJhY2tQYXJhbUZpZWxkRWxlbWVudC5uYW1lID0gIl9fQ0FMTEJBQ0tQQVJBTSI7CiAgICAgICAgICAgIGNhbGxiYWNrUGFyYW1GaWVsZEVsZW1lbnQudmFsdWUgPSBldmVudEFyZ3VtZW50OwogICAgICAgICAgICB4bWxSZXF1ZXN0RnJhbWUuZG9jdW1lbnQuZm9ybXNbMF0uYXBwZW5kQ2hpbGQoY2FsbGJhY2tQYXJhbUZpZWxkRWxlbWVudCk7CiAgICAgICAgICAgIGlmICh0aGVGb3JtWyJfX0VWRU5UVkFMSURBVElPTiJdKSB7CiAgICAgICAgICAgICAgICB2YXIgY2FsbGJhY2tWYWxpZGF0aW9uRmllbGRFbGVtZW50ID0geG1sUmVxdWVzdEZyYW1lLmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoIklOUFVUIik7CiAgICAgICAgICAgICAgICBjYWxsYmFja1ZhbGlkYXRpb25GaWVsZEVsZW1lbnQudHlwZSA9ICJoaWRkZW4iOwogICAgICAgICAgICAgICAgY2FsbGJhY2tWYWxpZGF0aW9uRmllbGRFbGVtZW50Lm5hbWUgPSAiX19FVkVOVFZBTElEQVRJT04iOwogICAgICAgICAgICAgICAgY2FsbGJhY2tWYWxpZGF0aW9uRmllbGRFbGVtZW50LnZhbHVlID0gdGhlRm9ybVsiX19FVkVOVFZBTElEQVRJT04iXS52YWx1ZTsKICAgICAgICAgICAgICAgIHhtbFJlcXVlc3RGcmFtZS5kb2N1bWVudC5mb3Jtc1swXS5hcHBlbmRDaGlsZChjYWxsYmFja1ZhbGlkYXRpb25GaWVsZEVsZW1lbnQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBjYWxsYmFja0luZGV4RmllbGRFbGVtZW50ID0geG1sUmVxdWVzdEZyYW1lLmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoIklOUFVUIik7CiAgICAgICAgICAgIGNhbGxiYWNrSW5kZXhGaWVsZEVsZW1lbnQudHlwZSA9ICJoaWRkZW4iOwogICAgICAgICAgICBjYWxsYmFja0luZGV4RmllbGRFbGVtZW50Lm5hbWUgPSAiX19DQUxMQkFDS0lOREVYIjsKICAgICAgICAgICAgY2FsbGJhY2tJbmRleEZpZWxkRWxlbWVudC52YWx1ZSA9IGNhbGxiYWNrSW5kZXg7CiAgICAgICAgICAgIHhtbFJlcXVlc3RGcmFtZS5kb2N1bWVudC5mb3Jtc1swXS5hcHBlbmRDaGlsZChjYWxsYmFja0luZGV4RmllbGRFbGVtZW50KTsKICAgICAgICAgICAgeG1sUmVxdWVzdEZyYW1lLmRvY3VtZW50LmZvcm1zWzBdLnN1Ym1pdCgpOwogICAgICAgIH0KICAgIH0sIDEwKTsKfQpmdW5jdGlvbiBXZWJGb3JtX0NhbGxiYWNrQ29tcGxldGUoKSB7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IF9fcGVuZGluZ0NhbGxiYWNrcy5sZW5ndGg7IGkrKykgewogICAgICAgIGNhbGxiYWNrT2JqZWN0ID0gX19wZW5kaW5nQ2FsbGJhY2tzW2ldOwogICAgICAgIGlmIChjYWxsYmFja09iamVjdCAmJiBjYWxsYmFja09iamVjdC54bWxSZXF1ZXN0ICYmIChjYWxsYmFja09iamVjdC54bWxSZXF1ZXN0LnJlYWR5U3RhdGUgPT0gNCkpIHsKICAgICAgICAgICAgaWYgKCFfX3BlbmRpbmdDYWxsYmFja3NbaV0uYXN5bmMpIHsKICAgICAgICAgICAgICAgIF9fc3luY2hyb25vdXNDYWxsQmFja0luZGV4ID0gLTE7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgX19wZW5kaW5nQ2FsbGJhY2tzW2ldID0gbnVsbDsKICAgICAgICAgICAgdmFyIGNhbGxiYWNrRnJhbWVJRCA9ICJfX0NBTExCQUNLRlJBTUUiICsgaTsKICAgICAgICAgICAgdmFyIHhtbFJlcXVlc3RGcmFtZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGNhbGxiYWNrRnJhbWVJRCk7CiAgICAgICAgICAgIGlmICh4bWxSZXF1ZXN0RnJhbWUpIHsKICAgICAgICAgICAgICAgIHhtbFJlcXVlc3RGcmFtZS5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKHhtbFJlcXVlc3RGcmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgV2ViRm9ybV9FeGVjdXRlQ2FsbGJhY2soY2FsbGJhY2tPYmplY3QpOwogICAgICAgIH0KICAgIH0KfQpmdW5jdGlvbiBXZWJGb3JtX0V4ZWN1dGVDYWxsYmFjayhjYWxsYmFja09iamVjdCkgewogICAgdmFyIHJlc3BvbnNlID0gY2FsbGJhY2tPYmplY3QueG1sUmVxdWVzdC5yZXNwb25zZVRleHQ7CiAgICBpZiAocmVzcG9uc2UuY2hhckF0KDApID09ICJzIikgewogICAgICAgIGlmICgodHlwZW9mKGNhbGxiYWNrT2JqZWN0LmV2ZW50Q2FsbGJhY2spICE9ICJ1bmRlZmluZWQiKSAmJiAoY2FsbGJhY2tPYmplY3QuZXZlbnRDYWxsYmFjayAhPSBudWxsKSkgewogICAgICAgICAgICBjYWxsYmFja09iamVjdC5ldmVudENhbGxiYWNrKHJlc3BvbnNlLnN1YnN0cmluZygxKSwgY2FsbGJhY2tPYmplY3QuY29udGV4dCk7CiAgICAgICAgfQogICAgfQogICAgZWxzZSBpZiAocmVzcG9uc2UuY2hhckF0KDApID09ICJlIikgewogICAgICAgIGlmICgodHlwZW9mKGNhbGxiYWNrT2JqZWN0LmVycm9yQ2FsbGJhY2spICE9ICJ1bmRlZmluZWQiKSAmJiAoY2FsbGJhY2tPYmplY3QuZXJyb3JDYWxsYmFjayAhPSBudWxsKSkgewogICAgICAgICAgICBjYWxsYmFja09iamVjdC5lcnJvckNhbGxiYWNrKHJlc3BvbnNlLnN1YnN0cmluZygxKSwgY2FsbGJhY2tPYmplY3QuY29udGV4dCk7CiAgICAgICAgfQogICAgfQogICAgZWxzZSB7CiAgICAgICAgdmFyIHNlcGFyYXRvckluZGV4ID0gcmVzcG9uc2UuaW5kZXhPZigifCIpOwogICAgICAgIGlmIChzZXBhcmF0b3JJbmRleCAhPSAtMSkgewogICAgICAgICAgICB2YXIgdmFsaWRhdGlvbkZpZWxkTGVuZ3RoID0gcGFyc2VJbnQocmVzcG9uc2Uuc3Vic3RyaW5nKDAsIHNlcGFyYXRvckluZGV4KSk7CiAgICAgICAgICAgIGlmICghaXNOYU4odmFsaWRhdGlvbkZpZWxkTGVuZ3RoKSkgewogICAgICAgICAgICAgICAgdmFyIHZhbGlkYXRpb25GaWVsZCA9IHJlc3BvbnNlLnN1YnN0cmluZyhzZXBhcmF0b3JJbmRleCArIDEsIHNlcGFyYXRvckluZGV4ICsgdmFsaWRhdGlvbkZpZWxkTGVuZ3RoICsgMSk7CiAgICAgICAgICAgICAgICBpZiAodmFsaWRhdGlvbkZpZWxkICE9ICIiKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHZhbGlkYXRpb25GaWVsZEVsZW1lbnQgPSB0aGVGb3JtWyJfX0VWRU5UVkFMSURBVElPTiJdOwogICAgICAgICAgICAgICAgICAgIGlmICghdmFsaWRhdGlvbkZpZWxkRWxlbWVudCkgewogICAgICAgICAgICAgICAgICAgICAgICB2YWxpZGF0aW9uRmllbGRFbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiSU5QVVQiKTsKICAgICAgICAgICAgICAgICAgICAgICAgdmFsaWRhdGlvbkZpZWxkRWxlbWVudC50eXBlID0gImhpZGRlbiI7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhbGlkYXRpb25GaWVsZEVsZW1lbnQubmFtZSA9ICJfX0VWRU5UVkFMSURBVElPTiI7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoZUZvcm0uYXBwZW5kQ2hpbGQodmFsaWRhdGlvbkZpZWxkRWxlbWVudCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHZhbGlkYXRpb25GaWVsZEVsZW1lbnQudmFsdWUgPSB2YWxpZGF0aW9uRmllbGQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoKHR5cGVvZihjYWxsYmFja09iamVjdC5ldmVudENhbGxiYWNrKSAhPSAidW5kZWZpbmVkIikgJiYgKGNhbGxiYWNrT2JqZWN0LmV2ZW50Q2FsbGJhY2sgIT0gbnVsbCkpIHsKICAgICAgICAgICAgICAgICAgICBjYWxsYmFja09iamVjdC5ldmVudENhbGxiYWNrKHJlc3BvbnNlLnN1YnN0cmluZyhzZXBhcmF0b3JJbmRleCArIHZhbGlkYXRpb25GaWVsZExlbmd0aCArIDEpLCBjYWxsYmFja09iamVjdC5jb250ZXh0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KfQpmdW5jdGlvbiBXZWJGb3JtX0ZpbGxGaXJzdEF2YWlsYWJsZVNsb3QoYXJyYXksIGVsZW1lbnQpIHsKICAgIHZhciBpOwogICAgZm9yIChpID0gMDsgaSA8IGFycmF5Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgaWYgKCFhcnJheVtpXSkgYnJlYWs7CiAgICB9CiAgICBhcnJheVtpXSA9IGVsZW1lbnQ7CiAgICByZXR1cm4gaTsKfQp2YXIgX19ub25NU0RPTUJyb3dzZXIgPSAod2luZG93Lm5hdmlnYXRvci5hcHBOYW1lLnRvTG93ZXJDYXNlKCkuaW5kZXhPZignZXhwbG9yZXInKSA9PSAtMSk7CnZhciBfX3RoZUZvcm1Qb3N0RGF0YSA9ICIiOwp2YXIgX190aGVGb3JtUG9zdENvbGxlY3Rpb24gPSBuZXcgQXJyYXkoKTsKdmFyIF9fY2FsbGJhY2tUZXh0VHlwZXMgPSAvXih0ZXh0fHBhc3N3b3JkfGhpZGRlbnxzZWFyY2h8dGVsfHVybHxlbWFpbHxudW1iZXJ8cmFuZ2V8Y29sb3J8ZGF0ZXRpbWV8ZGF0ZXxtb250aHx3ZWVrfHRpbWV8ZGF0ZXRpbWUtbG9jYWwpJC9pOwpmdW5jdGlvbiBXZWJGb3JtX0luaXRDYWxsYmFjaygpIHsKICAgIHZhciBmb3JtRWxlbWVudHMgPSB0aGVGb3JtLmVsZW1lbnRzLAogICAgICAgIGNvdW50ID0gZm9ybUVsZW1lbnRzLmxlbmd0aCwKICAgICAgICBlbGVtZW50OwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjb3VudDsgaSsrKSB7CiAgICAgICAgZWxlbWVudCA9IGZvcm1FbGVtZW50c1tpXTsKICAgICAgICB2YXIgdGFnTmFtZSA9IGVsZW1lbnQudGFnTmFtZS50b0xvd2VyQ2FzZSgpOwogICAgICAgIGlmICh0YWdOYW1lID09ICJpbnB1dCIpIHsKICAgICAgICAgICAgdmFyIHR5cGUgPSBlbGVtZW50LnR5cGU7CiAgICAgICAgICAgIGlmICgoX19jYWxsYmFja1RleHRUeXBlcy50ZXN0KHR5cGUpIHx8ICgodHlwZSA9PSAiY2hlY2tib3giIHx8IHR5cGUgPT0gInJhZGlvIikgJiYgZWxlbWVudC5jaGVja2VkKSkKICAgICAgICAgICAgICAgICYmIChlbGVtZW50LmlkICE9ICJfX0VWRU5UVkFMSURBVElPTiIpKSB7CiAgICAgICAgICAgICAgICBXZWJGb3JtX0luaXRDYWxsYmFja0FkZEZpZWxkKGVsZW1lbnQubmFtZSwgZWxlbWVudC52YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAodGFnTmFtZSA9PSAic2VsZWN0IikgewogICAgICAgICAgICB2YXIgc2VsZWN0Q291bnQgPSBlbGVtZW50Lm9wdGlvbnMubGVuZ3RoOwogICAgICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IHNlbGVjdENvdW50OyBqKyspIHsKICAgICAgICAgICAgICAgIHZhciBzZWxlY3RDaGlsZCA9IGVsZW1lbnQub3B0aW9uc1tqXTsKICAgICAgICAgICAgICAgIGlmIChzZWxlY3RDaGlsZC5zZWxlY3RlZCA9PSB0cnVlKSB7CiAgICAgICAgICAgICAgICAgICAgV2ViRm9ybV9Jbml0Q2FsbGJhY2tBZGRGaWVsZChlbGVtZW50Lm5hbWUsIGVsZW1lbnQudmFsdWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKHRhZ05hbWUgPT0gInRleHRhcmVhIikgewogICAgICAgICAgICBXZWJGb3JtX0luaXRDYWxsYmFja0FkZEZpZWxkKGVsZW1lbnQubmFtZSwgZWxlbWVudC52YWx1ZSk7CiAgICAgICAgfQogICAgfQp9CmZ1bmN0aW9uIFdlYkZvcm1fSW5pdENhbGxiYWNrQWRkRmllbGQobmFtZSwgdmFsdWUpIHsKICAgIHZhciBuYW1lVmFsdWUgPSBuZXcgT2JqZWN0KCk7CiAgICBuYW1lVmFsdWUubmFtZSA9IG5hbWU7CiAgICBuYW1lVmFsdWUudmFsdWUgPSB2YWx1ZTsKICAgIF9fdGhlRm9ybVBvc3RDb2xsZWN0aW9uW19fdGhlRm9ybVBvc3RDb2xsZWN0aW9uLmxlbmd0aF0gPSBuYW1lVmFsdWU7CiAgICBfX3RoZUZvcm1Qb3N0RGF0YSArPSBXZWJGb3JtX0VuY29kZUNhbGxiYWNrKG5hbWUpICsgIj0iICsgV2ViRm9ybV9FbmNvZGVDYWxsYmFjayh2YWx1ZSkgKyAiJiI7Cn0KZnVuY3Rpb24gV2ViRm9ybV9FbmNvZGVDYWxsYmFjayhwYXJhbWV0ZXIpIHsKICAgIGlmIChlbmNvZGVVUklDb21wb25lbnQpIHsKICAgICAgICByZXR1cm4gZW5jb2RlVVJJQ29tcG9uZW50KHBhcmFtZXRlcik7CiAgICB9CiAgICBlbHNlIHsKICAgICAgICByZXR1cm4gZXNjYXBlKHBhcmFtZXRlcik7CiAgICB9Cn0KdmFyIF9fZGlzYWJsZWRDb250cm9sQXJyYXkgPSBuZXcgQXJyYXkoKTsKZnVuY3Rpb24gV2ViRm9ybV9SZUVuYWJsZUNvbnRyb2xzKCkgewogICAgaWYgKHR5cGVvZihfX2VuYWJsZWRDb250cm9sQXJyYXkpID09ICd1bmRlZmluZWQnKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgdmFyIGRpc2FibGVkSW5kZXggPSAwOwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBfX2VuYWJsZWRDb250cm9sQXJyYXkubGVuZ3RoOyBpKyspIHsKICAgICAgICB2YXIgYzsKICAgICAgICBpZiAoX19ub25NU0RPTUJyb3dzZXIpIHsKICAgICAgICAgICAgYyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKF9fZW5hYmxlZENvbnRyb2xBcnJheVtpXSk7CiAgICAgICAgfQogICAgICAgIGVsc2UgewogICAgICAgICAgICBjID0gZG9jdW1lbnQuYWxsW19fZW5hYmxlZENvbnRyb2xBcnJheVtpXV07CiAgICAgICAgfQogICAgICAgIGlmICgodHlwZW9mKGMpICE9ICJ1bmRlZmluZWQiKSAmJiAoYyAhPSBudWxsKSAmJiAoYy5kaXNhYmxlZCA9PSB0cnVlKSkgewogICAgICAgICAgICBjLmRpc2FibGVkID0gZmFsc2U7CiAgICAgICAgICAgIF9fZGlzYWJsZWRDb250cm9sQXJyYXlbZGlzYWJsZWRJbmRleCsrXSA9IGM7CiAgICAgICAgfQogICAgfQogICAgc2V0VGltZW91dCgiV2ViRm9ybV9SZURpc2FibGVDb250cm9scygpIiwgMCk7CiAgICByZXR1cm4gdHJ1ZTsKfQpmdW5jdGlvbiBXZWJGb3JtX1JlRGlzYWJsZUNvbnRyb2xzKCkgewogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBfX2Rpc2FibGVkQ29udHJvbEFycmF5Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgX19kaXNhYmxlZENvbnRyb2xBcnJheVtpXS5kaXNhYmxlZCA9IHRydWU7CiAgICB9Cn0KZnVuY3Rpb24gV2ViRm9ybV9TaW11bGF0ZUNsaWNrKGVsZW1lbnQsIGV2ZW50KSB7CiAgICB2YXIgY2xpY2tFdmVudDsKICAgIGlmIChlbGVtZW50KSB7CiAgICAgICAgaWYgKGVsZW1lbnQuY2xpY2spIHsKICAgICAgICAgICAgZWxlbWVudC5jbGljaygpOwogICAgICAgIH0gZWxzZSB7IAogICAgICAgICAgICBjbGlja0V2ZW50ID0gZG9jdW1lbnQuY3JlYXRlRXZlbnQoIk1vdXNlRXZlbnRzIik7CiAgICAgICAgICAgIGNsaWNrRXZlbnQuaW5pdE1vdXNlRXZlbnQoImNsaWNrIiwgdHJ1ZSwgdHJ1ZSwgd2luZG93LCAwLCAwLCAwLCAwLCAwLCBmYWxzZSwgZmFsc2UsIGZhbHNlLCBmYWxzZSwgMCwgbnVsbCk7CiAgICAgICAgICAgIGlmICghZWxlbWVudC5kaXNwYXRjaEV2ZW50KGNsaWNrRXZlbnQpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBldmVudC5jYW5jZWxCdWJibGUgPSB0cnVlOwogICAgICAgIGlmIChldmVudC5zdG9wUHJvcGFnYXRpb24pIHsKICAgICAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIHJldHVybiB0cnVlOwp9CmZ1bmN0aW9uIFdlYkZvcm1fRmlyZURlZmF1bHRCdXR0b24oZXZlbnQsIHRhcmdldCkgewogICAgaWYgKGV2ZW50LmtleUNvZGUgPT0gMTMpIHsKICAgICAgICB2YXIgc3JjID0gZXZlbnQuc3JjRWxlbWVudCB8fCBldmVudC50YXJnZXQ7CiAgICAgICAgaWYgKHNyYyAmJgogICAgICAgICAgICAoKHNyYy50YWdOYW1lLnRvTG93ZXJDYXNlKCkgPT0gImlucHV0IikgJiYKICAgICAgICAgICAgIChzcmMudHlwZS50b0xvd2VyQ2FzZSgpID09ICJzdWJtaXQiIHx8IHNyYy50eXBlLnRvTG93ZXJDYXNlKCkgPT0gImJ1dHRvbiIpKSB8fAogICAgICAgICAgICAoKHNyYy50YWdOYW1lLnRvTG93ZXJDYXNlKCkgPT0gImEiKSAmJgogICAgICAgICAgICAgKHNyYy5ocmVmICE9IG51bGwpICYmIChzcmMuaHJlZiAhPSAiIikpIHx8CiAgICAgICAgICAgIChzcmMudGFnTmFtZS50b0xvd2VyQ2FzZSgpID09ICJ0ZXh0YXJlYSIpKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICB2YXIgZGVmYXVsdEJ1dHRvbjsKICAgICAgICBpZiAoX19ub25NU0RPTUJyb3dzZXIpIHsKICAgICAgICAgICAgZGVmYXVsdEJ1dHRvbiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKHRhcmdldCk7CiAgICAgICAgfQogICAgICAgIGVsc2UgewogICAgICAgICAgICBkZWZhdWx0QnV0dG9uID0gZG9jdW1lbnQuYWxsW3RhcmdldF07CiAgICAgICAgfQogICAgICAgIGlmIChkZWZhdWx0QnV0dG9uKSB7CiAgICAgICAgICAgIHJldHVybiBXZWJGb3JtX1NpbXVsYXRlQ2xpY2soZGVmYXVsdEJ1dHRvbiwgZXZlbnQpOwogICAgICAgIH0gCiAgICB9CiAgICByZXR1cm4gdHJ1ZTsKfQpmdW5jdGlvbiBXZWJGb3JtX0dldFNjcm9sbFgoKSB7CiAgICBpZiAoX19ub25NU0RPTUJyb3dzZXIpIHsKICAgICAgICByZXR1cm4gd2luZG93LnBhZ2VYT2Zmc2V0OwogICAgfQogICAgZWxzZSB7CiAgICAgICAgaWYgKGRvY3VtZW50LmRvY3VtZW50RWxlbWVudCAmJiBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuc2Nyb2xsTGVmdCkgewogICAgICAgICAgICByZXR1cm4gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LnNjcm9sbExlZnQ7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKGRvY3VtZW50LmJvZHkpIHsKICAgICAgICAgICAgcmV0dXJuIGRvY3VtZW50LmJvZHkuc2Nyb2xsTGVmdDsKICAgICAgICB9CiAgICB9CiAgICByZXR1cm4gMDsKfQpmdW5jdGlvbiBXZWJGb3JtX0dldFNjcm9sbFkoKSB7CiAgICBpZiAoX19ub25NU0RPTUJyb3dzZXIpIHsKICAgICAgICByZXR1cm4gd2luZG93LnBhZ2VZT2Zmc2V0OwogICAgfQogICAgZWxzZSB7CiAgICAgICAgaWYgKGRvY3VtZW50LmRvY3VtZW50RWxlbWVudCAmJiBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuc2Nyb2xsVG9wKSB7CiAgICAgICAgICAgIHJldHVybiBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuc2Nyb2xsVG9wOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmIChkb2N1bWVudC5ib2R5KSB7CiAgICAgICAgICAgIHJldHVybiBkb2N1bWVudC5ib2R5LnNjcm9sbFRvcDsKICAgICAgICB9CiAgICB9CiAgICByZXR1cm4gMDsKfQpmdW5jdGlvbiBXZWJGb3JtX1NhdmVTY3JvbGxQb3NpdGlvblN1Ym1pdCgpIHsKICAgIGlmIChfX25vbk1TRE9NQnJvd3NlcikgewogICAgICAgIHRoZUZvcm0uZWxlbWVudHNbJ19fU0NST0xMUE9TSVRJT05ZJ10udmFsdWUgPSB3aW5kb3cucGFnZVlPZmZzZXQ7CiAgICAgICAgdGhlRm9ybS5lbGVtZW50c1snX19TQ1JPTExQT1NJVElPTlgnXS52YWx1ZSA9IHdpbmRvdy5wYWdlWE9mZnNldDsKICAgIH0KICAgIGVsc2UgewogICAgICAgIHRoZUZvcm0uX19TQ1JPTExQT1NJVElPTlgudmFsdWUgPSBXZWJGb3JtX0dldFNjcm9sbFgoKTsKICAgICAgICB0aGVGb3JtLl9fU0NST0xMUE9TSVRJT05ZLnZhbHVlID0gV2ViRm9ybV9HZXRTY3JvbGxZKCk7CiAgICB9CiAgICBpZiAoKHR5cGVvZih0aGlzLm9sZFN1Ym1pdCkgIT0gInVuZGVmaW5lZCIpICYmICh0aGlzLm9sZFN1Ym1pdCAhPSBudWxsKSkgewogICAgICAgIHJldHVybiB0aGlzLm9sZFN1Ym1pdCgpOwogICAgfQogICAgcmV0dXJuIHRydWU7Cn0KZnVuY3Rpb24gV2ViRm9ybV9TYXZlU2Nyb2xsUG9zaXRpb25PblN1Ym1pdCgpIHsKICAgIHRoZUZvcm0uX19TQ1JPTExQT1NJVElPTlgudmFsdWUgPSBXZWJGb3JtX0dldFNjcm9sbFgoKTsKICAgIHRoZUZvcm0uX19TQ1JPTExQT1NJVElPTlkudmFsdWUgPSBXZWJGb3JtX0dldFNjcm9sbFkoKTsKICAgIGlmICgodHlwZW9mKHRoaXMub2xkT25TdWJtaXQpICE9ICJ1bmRlZmluZWQiKSAmJiAodGhpcy5vbGRPblN1Ym1pdCAhPSBudWxsKSkgewogICAgICAgIHJldHVybiB0aGlzLm9sZE9uU3VibWl0KCk7CiAgICB9CiAgICByZXR1cm4gdHJ1ZTsKfQpmdW5jdGlvbiBXZWJGb3JtX1Jlc3RvcmVTY3JvbGxQb3NpdGlvbigpIHsKICAgIGlmIChfX25vbk1TRE9NQnJvd3NlcikgewogICAgICAgIHdpbmRvdy5zY3JvbGxUbyh0aGVGb3JtLmVsZW1lbnRzWydfX1NDUk9MTFBPU0lUSU9OWCddLnZhbHVlLCB0aGVGb3JtLmVsZW1lbnRzWydfX1NDUk9MTFBPU0lUSU9OWSddLnZhbHVlKTsKICAgIH0KICAgIGVsc2UgewogICAgICAgIHdpbmRvdy5zY3JvbGxUbyh0aGVGb3JtLl9fU0NST0xMUE9TSVRJT05YLnZhbHVlLCB0aGVGb3JtLl9fU0NST0xMUE9TSVRJT05ZLnZhbHVlKTsKICAgIH0KICAgIGlmICgodHlwZW9mKHRoZUZvcm0ub2xkT25Mb2FkKSAhPSAidW5kZWZpbmVkIikgJiYgKHRoZUZvcm0ub2xkT25Mb2FkICE9IG51bGwpKSB7CiAgICAgICAgcmV0dXJuIHRoZUZvcm0ub2xkT25Mb2FkKCk7CiAgICB9CiAgICByZXR1cm4gdHJ1ZTsKfQpmdW5jdGlvbiBXZWJGb3JtX1RleHRCb3hLZXlIYW5kbGVyKGV2ZW50KSB7CiAgICBpZiAoZXZlbnQua2V5Q29kZSA9PSAxMykgewogICAgICAgIHZhciB0YXJnZXQ7CiAgICAgICAgaWYgKF9fbm9uTVNET01Ccm93c2VyKSB7CiAgICAgICAgICAgIHRhcmdldCA9IGV2ZW50LnRhcmdldDsKICAgICAgICB9CiAgICAgICAgZWxzZSB7CiAgICAgICAgICAgIHRhcmdldCA9IGV2ZW50LnNyY0VsZW1lbnQ7CiAgICAgICAgfQogICAgICAgIGlmICgodHlwZW9mKHRhcmdldCkgIT0gInVuZGVmaW5lZCIpICYmICh0YXJnZXQgIT0gbnVsbCkpIHsKICAgICAgICAgICAgaWYgKHR5cGVvZih0YXJnZXQub25jaGFuZ2UpICE9ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgICAgICB0YXJnZXQub25jaGFuZ2UoKTsKICAgICAgICAgICAgICAgIGV2ZW50LmNhbmNlbEJ1YmJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICBpZiAoZXZlbnQuc3RvcFByb3BhZ2F0aW9uKSBldmVudC5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgIHJldHVybiB0cnVlOwp9CmZ1bmN0aW9uIFdlYkZvcm1fVHJpbVN0cmluZyh2YWx1ZSkgewogICAgcmV0dXJuIHZhbHVlLnJlcGxhY2UoL15ccyt8XHMrJC9nLCAnJykKfQpmdW5jdGlvbiBXZWJGb3JtX0FwcGVuZFRvQ2xhc3NOYW1lKGVsZW1lbnQsIGNsYXNzTmFtZSkgewogICAgdmFyIGN1cnJlbnRDbGFzc05hbWUgPSAnICcgKyBXZWJGb3JtX1RyaW1TdHJpbmcoZWxlbWVudC5jbGFzc05hbWUpICsgJyAnOwogICAgY2xhc3NOYW1lID0gV2ViRm9ybV9UcmltU3RyaW5nKGNsYXNzTmFtZSk7CiAgICB2YXIgaW5kZXggPSBjdXJyZW50Q2xhc3NOYW1lLmluZGV4T2YoJyAnICsgY2xhc3NOYW1lICsgJyAnKTsKICAgIGlmIChpbmRleCA9PT0gLTEpIHsKICAgICAgICBlbGVtZW50LmNsYXNzTmFtZSA9IChlbGVtZW50LmNsYXNzTmFtZSA9PT0gJycpID8gY2xhc3NOYW1lIDogZWxlbWVudC5jbGFzc05hbWUgKyAnICcgKyBjbGFzc05hbWU7CiAgICB9Cn0KZnVuY3Rpb24gV2ViRm9ybV9SZW1vdmVDbGFzc05hbWUoZWxlbWVudCwgY2xhc3NOYW1lKSB7CiAgICB2YXIgY3VycmVudENsYXNzTmFtZSA9ICcgJyArIFdlYkZvcm1fVHJpbVN0cmluZyhlbGVtZW50LmNsYXNzTmFtZSkgKyAnICc7CiAgICBjbGFzc05hbWUgPSBXZWJGb3JtX1RyaW1TdHJpbmcoY2xhc3NOYW1lKTsKICAgIHZhciBpbmRleCA9IGN1cnJlbnRDbGFzc05hbWUuaW5kZXhPZignICcgKyBjbGFzc05hbWUgKyAnICcpOwogICAgaWYgKGluZGV4ID49IDApIHsKICAgICAgICBlbGVtZW50LmNsYXNzTmFtZSA9IFdlYkZvcm1fVHJpbVN0cmluZyhjdXJyZW50Q2xhc3NOYW1lLnN1YnN0cmluZygwLCBpbmRleCkgKyAnICcgKwogICAgICAgICAgICBjdXJyZW50Q2xhc3NOYW1lLnN1YnN0cmluZyhpbmRleCArIGNsYXNzTmFtZS5sZW5ndGggKyAxLCBjdXJyZW50Q2xhc3NOYW1lLmxlbmd0aCkpOwogICAgfQp9CmZ1bmN0aW9uIFdlYkZvcm1fR2V0RWxlbWVudEJ5SWQoZWxlbWVudElkKSB7CiAgICBpZiAoZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQpIHsKICAgICAgICByZXR1cm4gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoZWxlbWVudElkKTsKICAgIH0KICAgIGVsc2UgaWYgKGRvY3VtZW50LmFsbCkgewogICAgICAgIHJldHVybiBkb2N1bWVudC5hbGxbZWxlbWVudElkXTsKICAgIH0KICAgIGVsc2UgcmV0dXJuIG51bGw7Cn0KZnVuY3Rpb24gV2ViRm9ybV9HZXRFbGVtZW50QnlUYWdOYW1lKGVsZW1lbnQsIHRhZ05hbWUpIHsKICAgIHZhciBlbGVtZW50cyA9IFdlYkZvcm1fR2V0RWxlbWVudHNCeVRhZ05hbWUoZWxlbWVudCwgdGFnTmFtZSk7CiAgICBpZiAoZWxlbWVudHMgJiYgZWxlbWVudHMubGVuZ3RoID4gMCkgewogICAgICAgIHJldHVybiBlbGVtZW50c1swXTsKICAgIH0KICAgIGVsc2UgcmV0dXJuIG51bGw7Cn0KZnVuY3Rpb24gV2ViRm9ybV9HZXRFbGVtZW50c0J5VGFnTmFtZShlbGVtZW50LCB0YWdOYW1lKSB7CiAgICBpZiAoZWxlbWVudCAmJiB0YWdOYW1lKSB7CiAgICAgICAgaWYgKGVsZW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUpIHsKICAgICAgICAgICAgcmV0dXJuIGVsZW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUodGFnTmFtZSk7CiAgICAgICAgfQogICAgICAgIGlmIChlbGVtZW50LmFsbCAmJiBlbGVtZW50LmFsbC50YWdzKSB7CiAgICAgICAgICAgIHJldHVybiBlbGVtZW50LmFsbC50YWdzKHRhZ05hbWUpOwogICAgICAgIH0KICAgIH0KICAgIHJldHVybiBudWxsOwp9CmZ1bmN0aW9uIFdlYkZvcm1fR2V0RWxlbWVudERpcihlbGVtZW50KSB7CiAgICBpZiAoZWxlbWVudCkgewogICAgICAgIGlmIChlbGVtZW50LmRpcikgewogICAgICAgICAgICByZXR1cm4gZWxlbWVudC5kaXI7CiAgICAgICAgfQogICAgICAgIHJldHVybiBXZWJGb3JtX0dldEVsZW1lbnREaXIoZWxlbWVudC5wYXJlbnROb2RlKTsKICAgIH0KICAgIHJldHVybiAibHRyIjsKfQpmdW5jdGlvbiBXZWJGb3JtX0dldEVsZW1lbnRQb3NpdGlvbihlbGVtZW50KSB7CiAgICB2YXIgcmVzdWx0ID0gbmV3IE9iamVjdCgpOwogICAgcmVzdWx0LnggPSAwOwogICAgcmVzdWx0LnkgPSAwOwogICAgcmVzdWx0LndpZHRoID0gMDsKICAgIHJlc3VsdC5oZWlnaHQgPSAwOwogICAgaWYgKGVsZW1lbnQub2Zmc2V0UGFyZW50KSB7CiAgICAgICAgcmVzdWx0LnggPSBlbGVtZW50Lm9mZnNldExlZnQ7CiAgICAgICAgcmVzdWx0LnkgPSBlbGVtZW50Lm9mZnNldFRvcDsKICAgICAgICB2YXIgcGFyZW50ID0gZWxlbWVudC5vZmZzZXRQYXJlbnQ7CiAgICAgICAgd2hpbGUgKHBhcmVudCkgewogICAgICAgICAgICByZXN1bHQueCArPSBwYXJlbnQub2Zmc2V0TGVmdDsKICAgICAgICAgICAgcmVzdWx0LnkgKz0gcGFyZW50Lm9mZnNldFRvcDsKICAgICAgICAgICAgdmFyIHBhcmVudFRhZ05hbWUgPSBwYXJlbnQudGFnTmFtZS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICBpZiAocGFyZW50VGFnTmFtZSAhPSAidGFibGUiICYmCiAgICAgICAgICAgICAgICBwYXJlbnRUYWdOYW1lICE9ICJib2R5IiAmJiAKICAgICAgICAgICAgICAgIHBhcmVudFRhZ05hbWUgIT0gImh0bWwiICYmIAogICAgICAgICAgICAgICAgcGFyZW50VGFnTmFtZSAhPSAiZGl2IiAmJiAKICAgICAgICAgICAgICAgIHBhcmVudC5jbGllbnRUb3AgJiYgCiAgICAgICAgICAgICAgICBwYXJlbnQuY2xpZW50TGVmdCkgewogICAgICAgICAgICAgICAgcmVzdWx0LnggKz0gcGFyZW50LmNsaWVudExlZnQ7CiAgICAgICAgICAgICAgICByZXN1bHQueSArPSBwYXJlbnQuY2xpZW50VG9wOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHBhcmVudCA9IHBhcmVudC5vZmZzZXRQYXJlbnQ7CiAgICAgICAgfQogICAgfQogICAgZWxzZSBpZiAoZWxlbWVudC5sZWZ0ICYmIGVsZW1lbnQudG9wKSB7CiAgICAgICAgcmVzdWx0LnggPSBlbGVtZW50LmxlZnQ7CiAgICAgICAgcmVzdWx0LnkgPSBlbGVtZW50LnRvcDsKICAgIH0KICAgIGVsc2UgewogICAgICAgIGlmIChlbGVtZW50LngpIHsKICAgICAgICAgICAgcmVzdWx0LnggPSBlbGVtZW50Lng7CiAgICAgICAgfQogICAgICAgIGlmIChlbGVtZW50LnkpIHsKICAgICAgICAgICAgcmVzdWx0LnkgPSBlbGVtZW50Lnk7CiAgICAgICAgfQogICAgfQogICAgaWYgKGVsZW1lbnQub2Zmc2V0V2lkdGggJiYgZWxlbWVudC5vZmZzZXRIZWlnaHQpIHsKICAgICAgICByZXN1bHQud2lkdGggPSBlbGVtZW50Lm9mZnNldFdpZHRoOwogICAgICAgIHJlc3VsdC5oZWlnaHQgPSBlbGVtZW50Lm9mZnNldEhlaWdodDsKICAgIH0KICAgIGVsc2UgaWYgKGVsZW1lbnQuc3R5bGUgJiYgZWxlbWVudC5zdHlsZS5waXhlbFdpZHRoICYmIGVsZW1lbnQuc3R5bGUucGl4ZWxIZWlnaHQpIHsKICAgICAgICByZXN1bHQud2lkdGggPSBlbGVtZW50LnN0eWxlLnBpeGVsV2lkdGg7CiAgICAgICAgcmVzdWx0LmhlaWdodCA9IGVsZW1lbnQuc3R5bGUucGl4ZWxIZWlnaHQ7CiAgICB9CiAgICByZXR1cm4gcmVzdWx0Owp9CmZ1bmN0aW9uIFdlYkZvcm1fR2V0UGFyZW50QnlUYWdOYW1lKGVsZW1lbnQsIHRhZ05hbWUpIHsKICAgIHZhciBwYXJlbnQgPSBlbGVtZW50LnBhcmVudE5vZGU7CiAgICB2YXIgdXBwZXJUYWdOYW1lID0gdGFnTmFtZS50b1VwcGVyQ2FzZSgpOwogICAgd2hpbGUgKHBhcmVudCAmJiAocGFyZW50LnRhZ05hbWUudG9VcHBlckNhc2UoKSAhPSB1cHBlclRhZ05hbWUpKSB7CiAgICAgICAgcGFyZW50ID0gcGFyZW50LnBhcmVudE5vZGUgPyBwYXJlbnQucGFyZW50Tm9kZSA6IHBhcmVudC5wYXJlbnRFbGVtZW50OwogICAgfQogICAgcmV0dXJuIHBhcmVudDsKfQpmdW5jdGlvbiBXZWJGb3JtX1NldEVsZW1lbnRIZWlnaHQoZWxlbWVudCwgaGVpZ2h0KSB7CiAgICBpZiAoZWxlbWVudCAmJiBlbGVtZW50LnN0eWxlKSB7CiAgICAgICAgZWxlbWVudC5zdHlsZS5oZWlnaHQgPSBoZWlnaHQgKyAicHgiOwogICAgfQp9CmZ1bmN0aW9uIFdlYkZvcm1fU2V0RWxlbWVudFdpZHRoKGVsZW1lbnQsIHdpZHRoKSB7CiAgICBpZiAoZWxlbWVudCAmJiBlbGVtZW50LnN0eWxlKSB7CiAgICAgICAgZWxlbWVudC5zdHlsZS53aWR0aCA9IHdpZHRoICsgInB4IjsKICAgIH0KfQpmdW5jdGlvbiBXZWJGb3JtX1NldEVsZW1lbnRYKGVsZW1lbnQsIHgpIHsKICAgIGlmIChlbGVtZW50ICYmIGVsZW1lbnQuc3R5bGUpIHsKICAgICAgICBlbGVtZW50LnN0eWxlLmxlZnQgPSB4ICsgInB4IjsKICAgIH0KfQpmdW5jdGlvbiBXZWJGb3JtX1NldEVsZW1lbnRZKGVsZW1lbnQsIHkpIHsKICAgIGlmIChlbGVtZW50ICYmIGVsZW1lbnQuc3R5bGUpIHsKICAgICAgICBlbGVtZW50LnN0eWxlLnRvcCA9IHkgKyAicHgiOwogICAgfQp9",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Thu, 06 Nov 2014 12:01:57 GMT",
                    "Content-Length": "21840",
                    "Date": "Thu, 06 Nov 2014 12:02:03 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}